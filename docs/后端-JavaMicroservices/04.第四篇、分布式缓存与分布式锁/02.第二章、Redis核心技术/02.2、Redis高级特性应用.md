---
title: 2ã€Redisé«˜çº§ç‰¹æ€§åº”ç”¨
---
## ğŸ“š ç›®å½•

1. [Redisé«˜çº§ç‰¹æ€§æ¦‚è¿°](#1-Redisé«˜çº§ç‰¹æ€§æ¦‚è¿°)
2. [Pipelineç®¡é“æŠ€æœ¯](#2-Pipelineç®¡é“æŠ€æœ¯)
3. [äº‹åŠ¡Transactionæœºåˆ¶](#3-äº‹åŠ¡Transactionæœºåˆ¶)
4. [Luaè„šæœ¬åŸå­æ“ä½œ](#4-Luaè„šæœ¬åŸå­æ“ä½œ)
5. [å‘å¸ƒè®¢é˜…æ¨¡å¼](#5-å‘å¸ƒè®¢é˜…æ¨¡å¼)
6. [Streamæµå¤„ç†](#6-Streamæµå¤„ç†)
7. [è¿‡æœŸç­–ç•¥ä¸å†…å­˜ç®¡ç†](#7-è¿‡æœŸç­–ç•¥ä¸å†…å­˜ç®¡ç†)
8. [æ€§èƒ½ç›‘æ§ä¸ä¼˜åŒ–](#8-æ€§èƒ½ç›‘æ§ä¸ä¼˜åŒ–)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸš€ Redisé«˜çº§ç‰¹æ€§æ¦‚è¿°


### 1.1 ä¸ºä»€ä¹ˆéœ€è¦é«˜çº§ç‰¹æ€§


**é€šä¿—ç†è§£**ï¼š
æƒ³è±¡Rediså°±åƒä¸€ä¸ªè¶…çº§å¿«é€’ä»“åº“ï¼ŒåŸºæœ¬æ“ä½œæ˜¯"å­˜å–åŒ…è£¹"ï¼Œè€Œé«˜çº§ç‰¹æ€§å°±åƒæ˜¯å„ç§"é«˜æ•ˆä½œä¸šæ–¹å¼"ï¼š
- **Pipeline**ï¼šæ‰¹é‡å¤„ç†åŒ…è£¹ï¼Œå‡å°‘æ¥å›è·‘è…¿
- **äº‹åŠ¡**ï¼šå¤šä¸ªæ“ä½œè¦ä¹ˆå…¨åšï¼Œè¦ä¹ˆå…¨ä¸åš
- **Luaè„šæœ¬**ï¼šå®šåˆ¶åŒ–çš„å¤æ‚æ“ä½œæµç¨‹
- **å‘å¸ƒè®¢é˜…**ï¼šå®æ—¶æ¶ˆæ¯é€šçŸ¥ç³»ç»Ÿ

### 1.2 é«˜çº§ç‰¹æ€§åº”ç”¨åœºæ™¯


```
ğŸ¯ å®é™…ä¸šåŠ¡åœºæ™¯æ˜ å°„ï¼š

åŸºç¡€æ“ä½œåœºæ™¯ï¼š
â€¢ ç¼“å­˜ç”¨æˆ·ä¿¡æ¯ï¼šç®€å•çš„GET/SET
â€¢ è®¡æ•°å™¨ï¼šINCRæ“ä½œ
â€¢ ä¼šè¯ç®¡ç†ï¼šStringç±»å‹å­˜å‚¨

é«˜çº§ç‰¹æ€§åœºæ™¯ï¼š
â€¢ ç§’æ€ç³»ç»Ÿï¼šéœ€è¦Luaè„šæœ¬ä¿è¯åŸå­æ€§
â€¢ å®æ—¶é€šçŸ¥ï¼šç”¨å‘å¸ƒè®¢é˜…æ¨é€æ¶ˆæ¯
â€¢ æ‰¹é‡æ•°æ®å¤„ç†ï¼šç”¨Pipelineæé«˜æ•ˆç‡
â€¢ å¤æ‚ä¸šåŠ¡é€»è¾‘ï¼šç”¨äº‹åŠ¡ä¿è¯ä¸€è‡´æ€§
```

**ğŸ“Š æ€§èƒ½æå‡å¯¹æ¯”**ï¼š
```
ä¼ ç»Ÿæ–¹å¼ vs é«˜çº§ç‰¹æ€§ï¼š

å•æ¡æ“ä½œï¼šSET key1 value1, SET key2 value2...
Pipelineï¼šæ‰¹é‡æ‰“åŒ… [SET key1 value1, SET key2 value2...]
æ€§èƒ½æå‡ï¼š5-10å€é€Ÿåº¦æå‡

æ™®é€šè„šæœ¬ï¼šå¤šæ¬¡ç½‘ç»œè¯·æ±‚
Luaè„šæœ¬ï¼šæœåŠ¡ç«¯ç›´æ¥æ‰§è¡Œ
ä¼˜åŠ¿ï¼šåŸå­æ€§ + å‡å°‘ç½‘ç»œå¼€é”€
```

---

## 2. âš¡ Pipelineç®¡é“æŠ€æœ¯


### 2.1 PipelineåŸºæœ¬æ¦‚å¿µ


**ç”Ÿæ´»åŒ–ç†è§£**ï¼š
Pipelineå°±åƒ"æ‰¹å‘é‡‡è´­"ï¼Œä¸æ˜¯éœ€è¦ä»€ä¹ˆå°±è·‘ä¸€è¶Ÿå•†åº—ï¼Œè€Œæ˜¯åˆ—ä¸ªæ¸…å•ä¸€æ¬¡æ€§ä¹°é½æ‰€æœ‰ä¸œè¥¿ã€‚

```
ğŸª ä¼ ç»Ÿæ¨¡å¼ï¼ˆé›¶å”®ï¼‰ï¼š
å®¢æˆ·ç«¯ â†’ Redis â†’ ç­‰å¾…å“åº” â†’ å†å‘é€ä¸‹ä¸€ä¸ªå‘½ä»¤
æ—¶é—´æ¶ˆè€—ï¼šå‘½ä»¤æ‰§è¡Œæ—¶é—´ + ç½‘ç»œå¾€è¿”æ—¶é—´ Ã— å‘½ä»¤æ•°é‡

ğŸ“¦ Pipelineæ¨¡å¼ï¼ˆæ‰¹å‘ï¼‰ï¼š
å®¢æˆ·ç«¯ â†’ æ‰“åŒ…å¤šä¸ªå‘½ä»¤ â†’ Redis â†’ æ‰¹é‡æ‰§è¡Œ â†’ æ‰¹é‡è¿”å›ç»“æœ
æ—¶é—´æ¶ˆè€—ï¼šå‘½ä»¤æ‰§è¡Œæ—¶é—´ + ç½‘ç»œå¾€è¿”æ—¶é—´ Ã— 1
```

### 2.2 Pipelineå®é™…åº”ç”¨


**ğŸ”§ Javaä¸­çš„Pipelineä½¿ç”¨**ï¼š
```java
// Jedisè¿æ¥æ± é…ç½®
JedisPool jedisPool = new JedisPool("localhost", 6379);

// Pipelineæ‰¹é‡æ“ä½œç¤ºä¾‹
try (Jedis jedis = jedisPool.getResource()) {
    Pipeline pipeline = jedis.pipelined();
    
    // æ‰¹é‡è®¾ç½®ç”¨æˆ·ä¿¡æ¯
    for (int i = 1; i <= 1000; i++) {
        pipeline.set("user:" + i, "userData" + i);
        pipeline.expire("user:" + i, 3600);
    }
    
    // æ‰¹é‡æ‰§è¡Œå¹¶è·å–ç»“æœ
    List<Object> results = pipeline.syncAndReturnAll();
    System.out.println("æ‰¹é‡æ“ä½œå®Œæˆï¼Œç»“æœæ•°é‡ï¼š" + results.size());
}
```

**ğŸ’¡ Pipelineä½¿ç”¨è¦ç‚¹**ï¼š
```
é€‚åˆåœºæ™¯ï¼š
âœ… æ‰¹é‡è®¾ç½®ç¼“å­˜æ•°æ®
âœ… æ‰¹é‡æŸ¥è¯¢å¤šä¸ªkey
âœ… æ‰¹é‡åˆ é™¤è¿‡æœŸæ•°æ®
âœ… åˆå§‹åŒ–å¤§é‡æ•°æ®

æ³¨æ„äº‹é¡¹ï¼š
âš ï¸ ä¸è¦ä¸€æ¬¡æ€§æ‰“åŒ…è¿‡å¤šå‘½ä»¤ï¼ˆå»ºè®®100-1000æ¡ï¼‰
âš ï¸ Pipelineä¸æ”¯æŒæ¡ä»¶åˆ¤æ–­
âš ï¸ å‘½ä»¤æ‰§è¡Œé¡ºåºæ˜¯å›ºå®šçš„
âš ï¸ æŸä¸ªå‘½ä»¤å‡ºé”™ä¸å½±å“å…¶ä»–å‘½ä»¤æ‰§è¡Œ
```

### 2.3 æ€§èƒ½å¯¹æ¯”åˆ†æ


**ğŸ“ˆ Pipelineæ€§èƒ½æµ‹è¯•**ï¼š
```java
// æ€§èƒ½æµ‹è¯•ä»£ç ç¤ºä¾‹
public class PipelinePerformanceTest {
    
    public void testNormalMode() {
        long start = System.currentTimeMillis();
        try (Jedis jedis = jedisPool.getResource()) {
            for (int i = 0; i < 1000; i++) {
                jedis.set("key" + i, "value" + i);
            }
        }
        long time = System.currentTimeMillis() - start;
        System.out.println("æ™®é€šæ¨¡å¼è€—æ—¶ï¼š" + time + "ms");
    }
    
    public void testPipelineMode() {
        long start = System.currentTimeMillis();
        try (Jedis jedis = jedisPool.getResource()) {
            Pipeline pipeline = jedis.pipelined();
            for (int i = 0; i < 1000; i++) {
                pipeline.set("key" + i, "value" + i);
            }
            pipeline.sync();
        }
        long time = System.currentTimeMillis() - start;
        System.out.println("Pipelineæ¨¡å¼è€—æ—¶ï¼š" + time + "ms");
    }
}
```

**ğŸ“Š æ€§èƒ½æå‡æ•°æ®**ï¼š
```
æµ‹è¯•ç»“æœå¯¹æ¯”ï¼š
æ™®é€šæ¨¡å¼ï¼š1000æ¬¡æ“ä½œ â‰ˆ 500-1000ms
Pipelineæ¨¡å¼ï¼š1000æ¬¡æ“ä½œ â‰ˆ 50-100ms
æ€§èƒ½æå‡ï¼š5-10å€

ç½‘ç»œå»¶è¿Ÿå½±å“ï¼š
æœ¬åœ°æµ‹è¯•ï¼šæå‡3-5å€
è·¨æœºæˆ¿ï¼šæå‡10-50å€
è·¨åœ°åŒºï¼šæå‡å¯è¾¾100å€
```

---

## 3. ğŸ”’ äº‹åŠ¡Transactionæœºåˆ¶


### 3.1 Redisäº‹åŠ¡åŸºæœ¬æ¦‚å¿µ


**é€šä¿—è§£é‡Š**ï¼š
Redisäº‹åŠ¡å°±åƒ"æ‰“åŒ…å¿«é€’"ï¼Œä½ æŠŠè¦å¯„çš„ä¸œè¥¿éƒ½æ”¾åœ¨ä¸€ä¸ªåŒ…è£¹é‡Œï¼Œå¿«é€’å‘˜è¦ä¹ˆæŠŠæ•´ä¸ªåŒ…è£¹é€åˆ°ï¼Œè¦ä¹ˆæ•´ä¸ªåŒ…è£¹éƒ½é€ä¸åˆ°ï¼Œä¸ä¼šå‡ºç°é€ä¸€åŠçš„æƒ…å†µã€‚

```
ğŸ¯ äº‹åŠ¡ç‰¹æ€§ï¼š
âœ… åŸå­æ€§ï¼šè¦ä¹ˆå…¨æ‰§è¡Œï¼Œè¦ä¹ˆå…¨ä¸æ‰§è¡Œ
âœ… éš”ç¦»æ€§ï¼šæ‰§è¡ŒæœŸé—´ä¸ä¼šè¢«å…¶ä»–å‘½ä»¤æ‰“æ–­  
âŒ ä¸€è‡´æ€§ï¼šRedisä¸ä¿è¯å¼ºä¸€è‡´æ€§
âŒ æŒä¹…æ€§ï¼šå–å†³äºæŒä¹…åŒ–é…ç½®

Redisäº‹åŠ¡ vs ä¼ ç»Ÿæ•°æ®åº“äº‹åŠ¡ï¼š
ç›¸åŒç‚¹ï¼šéƒ½æœ‰åŸå­æ€§
ä¸åŒç‚¹ï¼šRedisä¸æ”¯æŒå›æ»šï¼Œå‘½ä»¤é”™è¯¯ä¸ä¼šå½±å“å…¶ä»–å‘½ä»¤
```

### 3.2 äº‹åŠ¡åŸºæœ¬ä½¿ç”¨


**ğŸ”§ äº‹åŠ¡å‘½ä»¤æµç¨‹**ï¼š
```
Redisäº‹åŠ¡ä¸‰æ­¥æ›²ï¼š
1. MULTIï¼šå¼€å§‹äº‹åŠ¡ï¼ˆç›¸å½“äº"æ‰“å¼€åŒ…è£¹"ï¼‰
2. å‘½ä»¤é˜Ÿåˆ—ï¼šæ·»åŠ è¦æ‰§è¡Œçš„å‘½ä»¤ï¼ˆ"å¾€åŒ…è£¹é‡Œæ”¾ä¸œè¥¿"ï¼‰
3. EXECï¼šæ‰§è¡Œäº‹åŠ¡ï¼ˆ"å°è£…å‘é€åŒ…è£¹"ï¼‰
```

**ğŸ’» Javaäº‹åŠ¡ç¤ºä¾‹**ï¼š
```java
// è´¦æˆ·è½¬è´¦äº‹åŠ¡ç¤ºä¾‹
public boolean transferMoney(String fromUser, String toUser, int amount) {
    try (Jedis jedis = jedisPool.getResource()) {
        // å¼€å§‹äº‹åŠ¡
        Transaction transaction = jedis.multi();
        
        // æ·»åŠ äº‹åŠ¡å‘½ä»¤
        transaction.decrBy("account:" + fromUser, amount);  // æ‰£æ¬¾
        transaction.incrBy("account:" + toUser, amount);    // åŠ æ¬¾
        transaction.lpush("transfer:log", fromUser + "->" + toUser + ":" + amount);
        
        // æ‰§è¡Œäº‹åŠ¡
        List<Object> results = transaction.exec();
        
        return results != null; // nullè¡¨ç¤ºäº‹åŠ¡è¢«å–æ¶ˆ
    }
}
```

### 3.3 WATCHæœºåˆ¶å®ç°ä¹è§‚é”


**ğŸ” WATCHå·¥ä½œåŸç†**ï¼š
```
ä¹è§‚é”æ€æƒ³ï¼š
"æˆ‘è§‰å¾—ä¸ä¼šæœ‰äººå’Œæˆ‘æŠ¢ï¼Œä½†æˆ‘ä¼šæ£€æŸ¥ä¸€ä¸‹"

WATCHæœºåˆ¶ï¼š
1. WATCH keyï¼šç›‘æ§æŸä¸ªkey
2. æ‰§è¡Œä¸šåŠ¡é€»è¾‘
3. MULTIå¼€å§‹äº‹åŠ¡
4. å¦‚æœè¢«WATCHçš„keyå‘ç”Ÿå˜åŒ–ï¼Œæ•´ä¸ªäº‹åŠ¡å–æ¶ˆ
```

**ğŸ’° ä¹è§‚é”åº”ç”¨å®ä¾‹**ï¼š
```java
// å•†å“åº“å­˜æ‰£å‡ï¼ˆé˜²æ­¢è¶…å–ï¼‰
public boolean decreaseStock(String productId, int quantity) {
    try (Jedis jedis = jedisPool.getResource()) {
        String stockKey = "stock:" + productId;
        
        // å¼€å§‹ç›‘æ§åº“å­˜
        jedis.watch(stockKey);
        
        // æ£€æŸ¥åº“å­˜æ˜¯å¦è¶³å¤Ÿ
        String currentStock = jedis.get(stockKey);
        if (Integer.parseInt(currentStock) < quantity) {
            jedis.unwatch(); // å–æ¶ˆç›‘æ§
            return false;
        }
        
        // å¼€å§‹äº‹åŠ¡
        Transaction transaction = jedis.multi();
        transaction.decrBy(stockKey, quantity);
        
        // æ‰§è¡Œäº‹åŠ¡
        List<Object> results = transaction.exec();
        return results != null; // æˆåŠŸè¿”å›true
    }
}
```

### 3.4 äº‹åŠ¡ä½¿ç”¨åœºæ™¯å’Œé™åˆ¶


**âœ… é€‚ç”¨åœºæ™¯**ï¼š
```
ç”µå•†åœºæ™¯ï¼š
â€¢ ä¸‹å•æ‰£åº“å­˜ï¼šåº“å­˜å‡å°‘ + è®¢å•åˆ›å»º
â€¢ ç”¨æˆ·ç­¾åˆ°ï¼šç§¯åˆ†å¢åŠ  + ç­¾åˆ°è®°å½•
â€¢ è½¬è´¦æ“ä½œï¼šAè´¦æˆ·å‡é’± + Bè´¦æˆ·åŠ é’±

æ³¨æ„äº‹é¡¹ï¼š
âš ï¸ Redisäº‹åŠ¡ä¸æ”¯æŒåµŒå¥—
âš ï¸ å‘½ä»¤è¯­æ³•é”™è¯¯ä¼šå¯¼è‡´æ•´ä¸ªäº‹åŠ¡å–æ¶ˆ
âš ï¸ å‘½ä»¤æ‰§è¡Œé”™è¯¯ä¸ä¼šå›æ»šå…¶ä»–å‘½ä»¤
âš ï¸ WATCHåªèƒ½ç›‘æ§äº‹åŠ¡å¼€å§‹å‰çš„çŠ¶æ€
```

---

## 4. ğŸ§© Luaè„šæœ¬åŸå­æ“ä½œ


### 4.1 ä¸ºä»€ä¹ˆéœ€è¦Luaè„šæœ¬


**å®é™…é—®é¢˜åˆ†æ**ï¼š
```
ä¸šåŠ¡åœºæ™¯ï¼šåˆ†å¸ƒå¼é”é‡Šæ”¾
é—®é¢˜ï¼šéœ€è¦å…ˆæ£€æŸ¥é”æ˜¯å¦æ˜¯è‡ªå·±çš„ï¼Œå†åˆ é™¤é”

é”™è¯¯åšæ³•ï¼š
if (jedis.get("lock:key").equals(myValue)) {
    jedis.del("lock:key"); // è¿™é‡Œå¯èƒ½å…¶ä»–çº¿ç¨‹å·²ç»è·å¾—äº†é”ï¼
}

é—®é¢˜ï¼šä¸¤ä¸ªæ“ä½œä¹‹é—´ä¸æ˜¯åŸå­çš„ï¼Œå¯èƒ½è¯¯åˆ åˆ«äººçš„é”
```

**Luaè„šæœ¬è§£å†³æ–¹æ¡ˆ**ï¼š
```lua
-- å®‰å…¨é‡Šæ”¾é”çš„Luaè„šæœ¬
if redis.call("get", KEYS[1]) == ARGV[1] then
    return redis.call("del", KEYS[1])
else
    return 0
end
```

### 4.2 Luaè„šæœ¬åŸºç¡€è¯­æ³•


**ğŸ“ Luaè„šæœ¬æ ¸å¿ƒè¦ç´ **ï¼š
```
è„šæœ¬ç»“æ„ï¼š
â€¢ KEYS[1], KEYS[2]ï¼šè„šæœ¬å‚æ•°ä¸­çš„key
â€¢ ARGV[1], ARGV[2]ï¼šè„šæœ¬å‚æ•°ä¸­çš„å€¼
â€¢ redis.call()ï¼šè°ƒç”¨Rediså‘½ä»¤
â€¢ returnï¼šè¿”å›ç»“æœç»™å®¢æˆ·ç«¯

æ•°æ®ç±»å‹ï¼š
â€¢ å­—ç¬¦ä¸²ï¼š'hello' æˆ– "hello"
â€¢ æ•°å­—ï¼š123, 45.6
â€¢ å¸ƒå°”ï¼štrue, false
â€¢ è¡¨(æ•°ç»„)ï¼š{1, 2, 3}
```

### 4.3 å¸¸ç”¨Luaè„šæœ¬å®ä¾‹


**ğŸ” åˆ†å¸ƒå¼é”å®Œæ•´å®ç°**ï¼š
```java
public class DistributedLock {
    // åŠ é”è„šæœ¬ï¼šSET if Not eXists + è®¾ç½®è¿‡æœŸæ—¶é—´
    private static final String LOCK_SCRIPT = 
        "return redis.call('set', KEYS[1], ARGV[1], 'NX', 'PX', ARGV[2])";
    
    // é‡Šæ”¾é”è„šæœ¬ï¼šæ£€æŸ¥æ‰€æœ‰è€… + åˆ é™¤
    private static final String UNLOCK_SCRIPT = 
        "if redis.call('get', KEYS[1]) == ARGV[1] then " +
        "return redis.call('del', KEYS[1]) " +
        "else return 0 end";
    
    public boolean tryLock(String lockKey, String lockValue, long expireTime) {
        Object result = jedis.eval(LOCK_SCRIPT, 1, lockKey, lockValue, String.valueOf(expireTime));
        return "OK".equals(result);
    }
    
    public boolean releaseLock(String lockKey, String lockValue) {
        Object result = jedis.eval(UNLOCK_SCRIPT, 1, lockKey, lockValue);
        return Long.valueOf(1).equals(result);
    }
}
```

**ğŸ“Š é™æµç®—æ³•è„šæœ¬**ï¼š
```lua
-- æ»‘åŠ¨çª—å£é™æµ
local key = KEYS[1]
local window = tonumber(ARGV[1])  -- çª—å£å¤§å°ï¼ˆç§’ï¼‰
local limit = tonumber(ARGV[2])   -- é™åˆ¶æ¬¡æ•°
local now = tonumber(ARGV[3])     -- å½“å‰æ—¶é—´æˆ³

-- æ¸…ç†è¿‡æœŸæ•°æ®
redis.call('zremrangebyscore', key, 0, now - window * 1000)

-- è·å–å½“å‰çª—å£å†…çš„è¯·æ±‚æ•°
local current = redis.call('zcard', key)

if current < limit then
    -- å…è®¸è¯·æ±‚ï¼Œæ·»åŠ å½“å‰è¯·æ±‚è®°å½•
    redis.call('zadd', key, now, now)
    redis.call('expire', key, window + 1)
    return 1
else
    -- æ‹’ç»è¯·æ±‚
    return 0
end
```

### 4.4 è„šæœ¬æ€§èƒ½ä¼˜åŒ–


**âš¡ è„šæœ¬æœ€ä½³å®è·µ**ï¼š
```
æ€§èƒ½ä¼˜åŒ–è¦ç‚¹ï¼š
âœ… é¢„ç¼–è¯‘è„šæœ¬ï¼šä½¿ç”¨SCRIPT LOAD + EVALSHA
âœ… å‡å°‘è„šæœ¬å¤æ‚åº¦ï¼šé¿å…è¿‡å¤šå¾ªç¯å’Œè®¡ç®—
âœ… åˆç†ä½¿ç”¨KEYSå’ŒARGVï¼šä¾¿äºé›†ç¾¤æ¨¡å¼åˆ†ç‰‡
âœ… è„šæœ¬ç»“æœç¼“å­˜ï¼šç›¸åŒé€»è¾‘å¯ä»¥å¤ç”¨

Javaé¢„ç¼–è¯‘ç¤ºä¾‹ï¼š
// é¢„åŠ è½½è„šæœ¬
String scriptSha = jedis.scriptLoad(LOCK_SCRIPT);
// ä½¿ç”¨é¢„ç¼–è¯‘è„šæœ¬
Object result = jedis.evalsha(scriptSha, 1, lockKey, lockValue);
```

---

## 5. ğŸ“¡ å‘å¸ƒè®¢é˜…æ¨¡å¼


### 5.1 å‘å¸ƒè®¢é˜…åŸºæœ¬æ¦‚å¿µ


**ç”Ÿæ´»åŒ–ç†è§£**ï¼š
å‘å¸ƒè®¢é˜…å°±åƒ"å¾®ä¿¡ç¾¤èŠ"æˆ–"æ–°é—»è®¢é˜…"ï¼š
- **å‘å¸ƒè€…**ï¼šå‘æ¶ˆæ¯çš„äººï¼ˆè®°è€…å‘æ–°é—»ï¼‰
- **è®¢é˜…è€…**ï¼šæ”¶æ¶ˆæ¯çš„äººï¼ˆè¯»è€…çœ‹æ–°é—»ï¼‰  
- **é¢‘é“**ï¼šæ¶ˆæ¯åˆ†ç±»ï¼ˆä½“è‚²é¢‘é“ã€å¨±ä¹é¢‘é“ï¼‰

```
ğŸ“» å‘å¸ƒè®¢é˜…æ¶æ„ï¼š
å‘å¸ƒè€…A â”€â”€â”
å‘å¸ƒè€…B â”€â”€â”¼â”€â†’ Redisé¢‘é“ â”€â†’ è®¢é˜…è€…1
å‘å¸ƒè€…C â”€â”€â”˜              â””â”€â†’ è®¢é˜…è€…2
                         â””â”€â†’ è®¢é˜…è€…3

ç‰¹ç‚¹ï¼š
â€¢ å‘å¸ƒè€…ä¸çŸ¥é“è°åœ¨å¬
â€¢ è®¢é˜…è€…ä¸çŸ¥é“è°åœ¨è¯´
â€¢ æ¶ˆæ¯å®æ—¶æ¨é€
â€¢ æ¶ˆæ¯ä¸æŒä¹…åŒ–
```

### 5.2 åŸºæœ¬æ“ä½œå®ç°


**ğŸ’¬ Javaå‘å¸ƒè®¢é˜…ç¤ºä¾‹**ï¼š
```java
// å‘å¸ƒè€…
public class MessagePublisher {
    public void publishMessage(String channel, String message) {
        try (Jedis jedis = jedisPool.getResource()) {
            Long subscribers = jedis.publish(channel, message);
            System.out.println("æ¶ˆæ¯å‘é€ç»™" + subscribers + "ä¸ªè®¢é˜…è€…");
        }
    }
}

// è®¢é˜…è€…
public class MessageSubscriber extends JedisPubSub {
    @Override
    public void onMessage(String channel, String message) {
        System.out.println("æ”¶åˆ°æ¶ˆæ¯ - é¢‘é“:" + channel + ", å†…å®¹:" + message);
        // å¤„ç†ä¸šåŠ¡é€»è¾‘
        processMessage(channel, message);
    }
    
    @Override
    public void onSubscribe(String channel, int subscribedChannels) {
        System.out.println("æˆåŠŸè®¢é˜…é¢‘é“:" + channel);
    }
}

// ä½¿ç”¨ç¤ºä¾‹
MessageSubscriber subscriber = new MessageSubscriber();
new Thread(() -> {
    try (Jedis jedis = jedisPool.getResource()) {
        jedis.subscribe(subscriber, "news", "sports", "tech");
    }
}).start();
```

### 5.3 æ¨¡å¼åŒ¹é…è®¢é˜…


**ğŸ” é€šé…ç¬¦æ¨¡å¼è®¢é˜…**ï¼š
```java
// æ¨¡å¼è®¢é˜…ï¼šå¯ä»¥è®¢é˜…åŒ¹é…æŸç§æ¨¡å¼çš„æ‰€æœ‰é¢‘é“
public class PatternSubscriber extends JedisPubSub {
    @Override
    public void onPMessage(String pattern, String channel, String message) {
        System.out.println("æ¨¡å¼:" + pattern + ", é¢‘é“:" + channel + ", æ¶ˆæ¯:" + message);
    }
}

// ä½¿ç”¨æ¨¡å¼è®¢é˜…
PatternSubscriber subscriber = new PatternSubscriber();
new Thread(() -> {
    try (Jedis jedis = jedisPool.getResource()) {
        // è®¢é˜…æ‰€æœ‰user:*å¼€å¤´çš„é¢‘é“
        jedis.psubscribe(subscriber, "user:*", "order:*", "log:error:*");
    }
}).start();
```

**ğŸ¯ å®é™…åº”ç”¨åœºæ™¯**ï¼š
```
ä¸šåŠ¡åº”ç”¨å®ä¾‹ï¼š
â€¢ ç”¨æˆ·çŠ¶æ€å˜æ›´ï¼šuser:login:*, user:logout:*
â€¢ è®¢å•çŠ¶æ€æµè½¬ï¼šorder:created:*, order:paid:*
â€¢ ç³»ç»Ÿæ—¥å¿—ç›‘æ§ï¼šlog:error:*, log:warning:*
â€¢ ç¼“å­˜æ›´æ–°é€šçŸ¥ï¼šcache:update:*, cache:clear:*
```

### 5.4 å‘å¸ƒè®¢é˜…ä½¿ç”¨é™åˆ¶


**âš ï¸ ä½¿ç”¨æ³¨æ„äº‹é¡¹**ï¼š
```
ä¼˜åŠ¿ï¼š
âœ… å®æ—¶æ€§å¥½ï¼šæ¶ˆæ¯ç«‹å³æ¨é€
âœ… è§£è€¦åˆï¼šå‘å¸ƒè€…å’Œè®¢é˜…è€…ç‹¬ç«‹
âœ… æ”¯æŒæ¨¡å¼åŒ¹é…ï¼šçµæ´»çš„è®¢é˜…è§„åˆ™

é™åˆ¶ï¼š
âŒ æ¶ˆæ¯ä¸æŒä¹…åŒ–ï¼šRedisé‡å¯ä¸¢å¤±
âŒ è®¢é˜…è€…ç¦»çº¿ï¼šé”™è¿‡æ¶ˆæ¯æ— æ³•æ¢å¤
âŒ æ— æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼šä¸ä¿è¯æ¶ˆæ¯åˆ°è¾¾
âŒ å•ç‚¹æ•…éšœï¼šRediså®•æœºå…¨éƒ¨ä¸­æ–­

é€‚åˆåœºæ™¯ï¼š
â€¢ å®æ—¶é€šçŸ¥ï¼ˆä¸é‡è¦çš„æ¶ˆæ¯ï¼‰
â€¢ ç¼“å­˜æ›´æ–°é€šçŸ¥
â€¢ ç®€å•çš„äº‹ä»¶é©±åŠ¨
```

---

## 6. ğŸŒŠ Streamæµå¤„ç†


### 6.1 Streamè§£å†³çš„é—®é¢˜


**Stream vs å‘å¸ƒè®¢é˜…**ï¼š
```
å‘å¸ƒè®¢é˜…çš„é—®é¢˜ï¼š
â€¢ æ¶ˆæ¯ä¸æŒä¹…åŒ–ï¼ŒRedisé‡å¯å°±ä¸¢å¤±
â€¢ è®¢é˜…è€…ç¦»çº¿æœŸé—´çš„æ¶ˆæ¯æ”¶ä¸åˆ°
â€¢ æ²¡æœ‰æ¶ˆæ¯ç¡®è®¤æœºåˆ¶

Streamçš„ä¼˜åŠ¿ï¼š
âœ… æ¶ˆæ¯æŒä¹…åŒ–å­˜å‚¨
âœ… æ”¯æŒæ¶ˆæ¯å›æ”¾
âœ… æ¶ˆè´¹ç»„æœºåˆ¶
âœ… æ¶ˆæ¯ç¡®è®¤æœºåˆ¶
âœ… è‡ªåŠ¨ç”Ÿæˆæ¶ˆæ¯ID
```

### 6.2 StreamåŸºæœ¬æ“ä½œ


**ğŸ“ Streamæ ¸å¿ƒæ¦‚å¿µ**ï¼š
```
Streamç»“æ„ï¼š
æ¶ˆæ¯æµ = {
  æ¶ˆæ¯1: {id: 1627891200000-0, field1: value1, field2: value2},
  æ¶ˆæ¯2: {id: 1627891201000-0, field1: value3, field2: value4},
  ...
}

å…³é”®è¦ç´ ï¼š
â€¢ Streamåç§°ï¼šæ¶ˆæ¯æµçš„æ ‡è¯†
â€¢ æ¶ˆæ¯IDï¼šè‡ªåŠ¨ç”Ÿæˆçš„å”¯ä¸€æ ‡è¯†ï¼ˆæ—¶é—´æˆ³-åºå·ï¼‰
â€¢ æ¶ˆæ¯å†…å®¹ï¼šfield-valueé”®å€¼å¯¹
â€¢ æ¶ˆè´¹ç»„ï¼šå¤šä¸ªæ¶ˆè´¹è€…åä½œå¤„ç†æ¶ˆæ¯
```

**ğŸ’» Java Streamä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
// ç”Ÿäº§æ¶ˆæ¯
public String addMessage(String streamKey, Map<String, String> message) {
    try (Jedis jedis = jedisPool.getResource()) {
        // "*" è¡¨ç¤ºè‡ªåŠ¨ç”ŸæˆID
        StreamEntryID id = jedis.xadd(streamKey, StreamEntryID.NEW_ENTRY, message);
        return id.toString();
    }
}

// æ¶ˆè´¹æ¶ˆæ¯ï¼ˆç®€å•æ¶ˆè´¹ï¼‰
public List<StreamEntry> readMessages(String streamKey, String lastId) {
    try (Jedis jedis = jedisPool.getResource()) {
        // ä»æŒ‡å®šIDä¹‹åè¯»å–æ¶ˆæ¯
        Map<String, StreamEntryID> streams = new HashMap<>();
        streams.put(streamKey, new StreamEntryID(lastId));
        
        List<Entry<String, List<StreamEntry>>> result = 
            jedis.xread(XReadParams.xReadParams().count(10).block(1000), streams);
        
        return result.isEmpty() ? Collections.emptyList() : result.get(0).getValue();
    }
}
```

### 6.3 æ¶ˆè´¹ç»„æœºåˆ¶


**ğŸ‘¥ æ¶ˆè´¹ç»„å·¥ä½œåŸç†**ï¼š
```
æ¶ˆè´¹ç»„æ¨¡å¼ï¼š
æ¶ˆæ¯æµ â”€â”€â”¬â”€â†’ æ¶ˆè´¹ç»„A â”€â”€â”¬â”€â†’ æ¶ˆè´¹è€…A1
         â”‚           â””â”€â†’ æ¶ˆè´¹è€…A2
         â””â”€â†’ æ¶ˆè´¹ç»„B â”€â”€â”¬â”€â†’ æ¶ˆè´¹è€…B1
                      â””â”€â†’ æ¶ˆè´¹è€…B2

ç‰¹ç‚¹ï¼š
â€¢ åŒä¸€æ¶ˆè´¹ç»„å†…çš„æ¶ˆè´¹è€…ç«äº‰æ¶ˆè´¹ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
â€¢ ä¸åŒæ¶ˆè´¹ç»„å¯ä»¥é‡å¤æ¶ˆè´¹åŒä¸€æ¶ˆæ¯
â€¢ æ”¯æŒæ¶ˆæ¯ç¡®è®¤å’Œé‡è¯•æœºåˆ¶
```

**ğŸ”§ æ¶ˆè´¹ç»„ä½¿ç”¨å®ä¾‹**ï¼š
```java
// åˆ›å»ºæ¶ˆè´¹ç»„
public void createConsumerGroup(String streamKey, String groupName) {
    try (Jedis jedis = jedisPool.getResource()) {
        // ä»æœ€æ–°ä½ç½®å¼€å§‹æ¶ˆè´¹
        jedis.xgroupCreate(streamKey, groupName, StreamEntryID.LAST_ENTRY, false);
    } catch (Exception e) {
        // æ¶ˆè´¹ç»„å¯èƒ½å·²å­˜åœ¨ï¼Œå¿½ç•¥é”™è¯¯
    }
}

// æ¶ˆè´¹ç»„æ¶ˆè´¹æ¶ˆæ¯
public void consumeWithGroup(String streamKey, String groupName, String consumerName) {
    try (Jedis jedis = jedisPool.getResource()) {
        while (true) {
            Map<String, StreamEntryID> streams = new HashMap<>();
            streams.put(streamKey, StreamEntryID.UNRECEIVED_ENTRY);
            
            List<Entry<String, List<StreamEntry>>> result = jedis.xreadGroup(
                groupName, consumerName,
                XReadGroupParams.xReadGroupParams().count(5).block(1000),
                streams
            );
            
            for (Entry<String, List<StreamEntry>> stream : result) {
                for (StreamEntry entry : stream.getValue()) {
                    // å¤„ç†æ¶ˆæ¯
                    processMessage(entry);
                    // ç¡®è®¤æ¶ˆæ¯
                    jedis.xack(streamKey, groupName, entry.getID());
                }
            }
        }
    }
}
```

### 6.4 Streamåº”ç”¨åœºæ™¯


**ğŸ¯ å®é™…åº”ç”¨å®ä¾‹**ï¼š
```java
// è®¢å•å¤„ç†æµ
public class OrderProcessingStream {
    
    // å‘å¸ƒè®¢å•äº‹ä»¶
    public void publishOrderEvent(String orderId, String event, Map<String, String> data) {
        Map<String, String> message = new HashMap<>();
        message.put("orderId", orderId);
        message.put("event", event);
        message.put("timestamp", String.valueOf(System.currentTimeMillis()));
        message.putAll(data);
        
        addMessage("order:stream", message);
    }
    
    // åº“å­˜æœåŠ¡æ¶ˆè´¹
    public void inventoryServiceConsumer() {
        createConsumerGroup("order:stream", "inventory-group");
        consumeWithGroup("order:stream", "inventory-group", "inventory-worker-1");
    }
    
    // æ”¯ä»˜æœåŠ¡æ¶ˆè´¹
    public void paymentServiceConsumer() {
        createConsumerGroup("order:stream", "payment-group");
        consumeWithGroup("order:stream", "payment-group", "payment-worker-1");
    }
}
```

---

## 7. â° è¿‡æœŸç­–ç•¥ä¸å†…å­˜ç®¡ç†


### 7.1 è¿‡æœŸç­–ç•¥è¯¦è§£


**ğŸ—‘ï¸ Redisè¿‡æœŸåˆ é™¤ç­–ç•¥**ï¼š
```
ä¸‰ç§åˆ é™¤ç­–ç•¥ï¼š

1. å®šæ—¶åˆ é™¤ï¼š
   â€¢ ç»™æ¯ä¸ªkeyè®¾ç½®å®šæ—¶å™¨
   â€¢ ä¼˜ç‚¹ï¼šåŠæ—¶é‡Šæ”¾å†…å­˜
   â€¢ ç¼ºç‚¹ï¼šæ¶ˆè€—CPUèµ„æº

2. æƒ°æ€§åˆ é™¤ï¼š
   â€¢ è®¿é—®keyæ—¶æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
   â€¢ ä¼˜ç‚¹ï¼šèŠ‚çœCPU
   â€¢ ç¼ºç‚¹ï¼šè¿‡æœŸkeyå¯èƒ½é•¿æ—¶é—´å ç”¨å†…å­˜

3. å®šæœŸåˆ é™¤ï¼ˆRedisé‡‡ç”¨ï¼‰ï¼š
   â€¢ æ¯éš”ä¸€æ®µæ—¶é—´éšæœºæ£€æŸ¥ä¸€æ‰¹key
   â€¢ å¹³è¡¡CPUå’Œå†…å­˜çš„ä½¿ç”¨
```

**âš™ï¸ è¿‡æœŸç­–ç•¥é…ç½®**ï¼š
```bash
# redis.confé…ç½®
# å®šæœŸåˆ é™¤é¢‘ç‡ï¼ˆ1-10ï¼Œé»˜è®¤10ï¼‰
hz 10

# è¿‡æœŸåˆ é™¤æ—¶é—´é™åˆ¶ï¼ˆæ¯«ç§’ï¼‰
# é˜²æ­¢åˆ é™¤æ“ä½œé˜»å¡æœåŠ¡å™¨å¤ªä¹…
active-expire-effort 1
```

### 7.2 å†…å­˜æ·˜æ±°ç®—æ³•


**ğŸ§  å…«ç§æ·˜æ±°ç­–ç•¥å¯¹æ¯”**ï¼š

| ç­–ç•¥åç§° | **é€‚ç”¨åœºæ™¯** | **æ·˜æ±°èŒƒå›´** | **ç®—æ³•ç‰¹ç‚¹** |
|---------|-------------|-------------|-------------|
| `noeviction` | æµ‹è¯•ç¯å¢ƒ | ä¸æ·˜æ±° | å†…å­˜æ»¡æ—¶æŠ¥é”™ |
| `allkeys-lru` | é€šç”¨ç¼“å­˜ | æ‰€æœ‰key | æœ€è¿‘æœ€å°‘ä½¿ç”¨ |
| `allkeys-lfu` | çƒ­ç‚¹æ•°æ® | æ‰€æœ‰key | æœ€ä¸å¸¸ç”¨ |
| `allkeys-random` | æ— æ˜æ˜¾è§„å¾‹ | æ‰€æœ‰key | éšæœºæ·˜æ±° |
| `volatile-lru` | éƒ¨åˆ†è¿‡æœŸ | æœ‰è¿‡æœŸæ—¶é—´çš„key | è¿‡æœŸkeyä¸­LRU |
| `volatile-lfu` | çƒ­ç‚¹è¿‡æœŸæ•°æ® | æœ‰è¿‡æœŸæ—¶é—´çš„key | è¿‡æœŸkeyä¸­LFU |
| `volatile-random` | ç®€å•è¿‡æœŸç­–ç•¥ | æœ‰è¿‡æœŸæ—¶é—´çš„key | è¿‡æœŸkeyä¸­éšæœº |
| `volatile-ttl` | ä¼˜å…ˆæ¸…ç†ä¸´æœŸ | æœ‰è¿‡æœŸæ—¶é—´çš„key | ä¼˜å…ˆåˆ é™¤TTLå°çš„ |

**ğŸ’¡ æ·˜æ±°ç­–ç•¥é€‰æ‹©æŒ‡å—**ï¼š
```
ä¸šåŠ¡åœºæ™¯æ¨èï¼š

ç¼“å­˜åœºæ™¯ï¼ˆæ¨èallkeys-lruï¼‰ï¼š
â€¢ ç¼“å­˜çƒ­ç‚¹æ•°æ®ï¼Œè®¿é—®æœ‰æ˜æ˜¾è§„å¾‹
â€¢ è®©Redisè‡ªåŠ¨ç®¡ç†æ‰€æœ‰æ•°æ®

ä¼šè¯å­˜å‚¨ï¼ˆæ¨èvolatile-ttlï¼‰ï¼š
â€¢ ç”¨æˆ·ä¼šè¯éƒ½æœ‰è¿‡æœŸæ—¶é—´  
â€¢ ä¼˜å…ˆæ¸…ç†å³å°†è¿‡æœŸçš„ä¼šè¯

æ··åˆä½¿ç”¨ï¼ˆæ¨èvolatile-lruï¼‰ï¼š
â€¢ éƒ¨åˆ†æ•°æ®æ°¸ä¹…ï¼Œéƒ¨åˆ†æ•°æ®ä¸´æ—¶
â€¢ åªæ·˜æ±°ä¸´æ—¶æ•°æ®
```

### 7.3 å†…å­˜ä½¿ç”¨ç›‘æ§


**ğŸ“Š å†…å­˜ç›‘æ§å…³é”®æŒ‡æ ‡**ï¼š
```java
// Javaç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ
public class RedisMemoryMonitor {
    
    public void checkMemoryInfo() {
        try (Jedis jedis = jedisPool.getResource()) {
            String info = jedis.info("memory");
            
            // è§£æå…³é”®æŒ‡æ ‡
            Map<String, String> memoryInfo = parseInfo(info);
            
            long usedMemory = Long.parseLong(memoryInfo.get("used_memory"));
            long maxMemory = Long.parseLong(memoryInfo.get("maxmemory"));
            
            double usage = (double) usedMemory / maxMemory * 100;
            
            System.out.println("å†…å­˜ä½¿ç”¨ç‡: " + String.format("%.2f%%", usage));
            
            if (usage > 80) {
                System.out.println("âš ï¸ å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜ï¼Œå»ºè®®æ¸…ç†!");
            }
        }
    }
}
```

**ğŸš¨ å†…å­˜å‘Šè­¦è®¾ç½®**ï¼š
```bash
# è®¾ç½®æœ€å¤§å†…å­˜é™åˆ¶
redis-cli CONFIG SET maxmemory 2gb
redis-cli CONFIG SET maxmemory-policy allkeys-lru

# ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ
redis-cli --latency-history -i 5 # å»¶è¿Ÿç›‘æ§
redis-cli --stat # å®æ—¶ç»Ÿè®¡
```

---

## 8. ğŸ“ˆ æ€§èƒ½ç›‘æ§ä¸ä¼˜åŒ–


### 8.1 æ…¢æŸ¥è¯¢æ—¥å¿—


**ğŸŒ æ…¢æŸ¥è¯¢ç›‘æ§åŸç†**ï¼š
```
æ…¢æŸ¥è¯¢å®šä¹‰ï¼š
æ‰§è¡Œæ—¶é—´è¶…è¿‡æŒ‡å®šé˜ˆå€¼çš„å‘½ä»¤

ç›‘æ§æ„ä¹‰ï¼š
â€¢ å‘ç°æ€§èƒ½ç“¶é¢ˆå‘½ä»¤
â€¢ ä¼˜åŒ–æŸ¥è¯¢è¯­å¥  
â€¢ é¢„é˜²ç³»ç»Ÿé˜»å¡

é…ç½®å‚æ•°ï¼š
â€¢ slowlog-log-slower-thanï¼šæ…¢æŸ¥è¯¢é˜ˆå€¼ï¼ˆå¾®ç§’ï¼‰
â€¢ slowlog-max-lenï¼šæ…¢æŸ¥è¯¢æ—¥å¿—æœ€å¤§é•¿åº¦
```

**ğŸ”§ æ…¢æŸ¥è¯¢é…ç½®ä¸æŸ¥çœ‹**ï¼š
```bash
# é…ç½®æ…¢æŸ¥è¯¢ï¼ˆ10æ¯«ç§’=10000å¾®ç§’ï¼‰
redis-cli CONFIG SET slowlog-log-slower-than 10000
redis-cli CONFIG SET slowlog-max-len 128

# æŸ¥çœ‹æ…¢æŸ¥è¯¢æ—¥å¿—
redis-cli SLOWLOG GET 10

# Javaä»£ç æŸ¥çœ‹æ…¢æŸ¥è¯¢
List<Slowlog> slowlogs = jedis.slowlogGet(10);
for (Slowlog log : slowlogs) {
    System.out.println("æ‰§è¡Œæ—¶é—´: " + log.getExecutionTime() + "å¾®ç§’");
    System.out.println("å‘½ä»¤: " + log.getArgs());
    System.out.println("æ—¶é—´æˆ³: " + new Date(log.getTimeStamp() * 1000));
}
```

### 8.2 é”®ç©ºé—´é€šçŸ¥


**ğŸ“¢ é”®ç©ºé—´äº‹ä»¶ç›‘æ§**ï¼š
```
äº‹ä»¶é€šçŸ¥ç±»å‹ï¼š
â€¢ é”®ç©ºé—´é€šçŸ¥ï¼šç›‘æ§ç‰¹å®škeyçš„æ“ä½œ
â€¢ é”®äº‹ä»¶é€šçŸ¥ï¼šç›‘æ§ç‰¹å®šæ“ä½œç±»å‹

é€šçŸ¥äº‹ä»¶ï¼š
â€¢ è¿‡æœŸï¼šexpired
â€¢ åˆ é™¤ï¼šdel
â€¢ æ›´æ–°ï¼šset, hsetç­‰
â€¢ æ·˜æ±°ï¼ševicted
```

**âš™ï¸ å¯ç”¨é”®ç©ºé—´é€šçŸ¥**ï¼š
```bash
# å¯ç”¨æ‰€æœ‰é”®äº‹ä»¶é€šçŸ¥
redis-cli CONFIG SET notify-keyspace-events AKE

# å‚æ•°è¯´æ˜ï¼š
# A: æ‰€æœ‰äº‹ä»¶çš„åˆ«å
# K: é”®ç©ºé—´äº‹ä»¶  
# E: é”®äº‹ä»¶
# x: è¿‡æœŸäº‹ä»¶
# d: DELå‘½ä»¤äº‹ä»¶
```

**ğŸ’» Javaç›‘å¬é”®ç©ºé—´äº‹ä»¶**ï¼š
```java
public class KeyspaceEventListener extends JedisPubSub {
    
    @Override
    public void onMessage(String channel, String message) {
        if (channel.startsWith("__keyevent@0__:expired")) {
            System.out.println("Keyè¿‡æœŸ: " + message);
            handleExpiredKey(message);
        }
    }
    
    // å¯åŠ¨ç›‘å¬
    public void startListening() {
        new Thread(() -> {
            try (Jedis jedis = jedisPool.getResource()) {
                jedis.subscribe(this, "__keyevent@0__:expired", "__keyevent@0__:del");
            }
        }).start();
    }
    
    private void handleExpiredKey(String expiredKey) {
        // å¤„ç†è¿‡æœŸkeyçš„ä¸šåŠ¡é€»è¾‘
        if (expiredKey.startsWith("session:")) {
            cleanupUserSession(expiredKey);
        }
    }
}
```

### 8.3 æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ


**âš¡ Redisæ€§èƒ½ä¼˜åŒ–æ¸…å•**ï¼š
```
å‘½ä»¤å±‚é¢ä¼˜åŒ–ï¼š
âœ… ä½¿ç”¨Pipelineæ‰¹é‡æ“ä½œ
âœ… é¿å…ä½¿ç”¨KEYS *ç­‰å…¨é‡æ‰«æ
âœ… ç”¨SCANæ›¿ä»£KEYSè¿›è¡Œè¿­ä»£
âœ… åˆç†ä½¿ç”¨æ•°æ®ç»“æ„ï¼ˆHash vs Stringï¼‰

è¿æ¥å±‚é¢ä¼˜åŒ–ï¼š
âœ… ä½¿ç”¨è¿æ¥æ± ç®¡ç†è¿æ¥
âœ… è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
âœ… å¯ç”¨TCP keepalive

å†…å­˜å±‚é¢ä¼˜åŒ–ï¼š
âœ… è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´
âœ… é€‰æ‹©åˆé€‚çš„æ·˜æ±°ç­–ç•¥
âœ… å®šæœŸæ¸…ç†æ— ç”¨æ•°æ®
âœ… ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ

ç½‘ç»œå±‚é¢ä¼˜åŒ–ï¼š
âœ… Redisä¸åº”ç”¨éƒ¨ç½²åœ¨åŒä¸€æœºæˆ¿
âœ… ä½¿ç”¨SSDå­˜å‚¨
âœ… è°ƒæ•´ç½‘ç»œç¼“å†²åŒºå¤§å°
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Pipelineï¼šæ‰¹é‡æ“ä½œæå‡æ€§èƒ½ï¼Œå‡å°‘ç½‘ç»œå¾€è¿”
ğŸ”¸ äº‹åŠ¡ï¼šåŸå­æ€§æ“ä½œä¿è¯ï¼ŒWATCHå®ç°ä¹è§‚é”
ğŸ”¸ Luaè„šæœ¬ï¼šæœåŠ¡ç«¯åŸå­æ‰§è¡Œï¼Œè§£å†³å¤æ‚ä¸šåŠ¡é€»è¾‘
ğŸ”¸ å‘å¸ƒè®¢é˜…ï¼šå®æ—¶æ¶ˆæ¯é€šçŸ¥ï¼Œä½†æ¶ˆæ¯ä¸æŒä¹…åŒ–
ğŸ”¸ Streamï¼šæŒä¹…åŒ–æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ”¯æŒæ¶ˆè´¹ç»„å’Œç¡®è®¤æœºåˆ¶
ğŸ”¸ è¿‡æœŸç­–ç•¥ï¼šå®šæœŸåˆ é™¤å¹³è¡¡CPUå’Œå†…å­˜ä½¿ç”¨
ğŸ”¸ å†…å­˜æ·˜æ±°ï¼šå…«ç§ç­–ç•¥åº”å¯¹å†…å­˜ä¸è¶³æƒ…å†µ
ğŸ”¸ æ€§èƒ½ç›‘æ§ï¼šæ…¢æŸ¥è¯¢ã€é”®ç©ºé—´é€šçŸ¥ã€å†…å­˜ç›‘æ§
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä½•æ—¶ä½¿ç”¨å„ç§é«˜çº§ç‰¹æ€§**ï¼š
```
æ€§èƒ½ä¼˜åŒ–éœ€æ±‚ï¼š
â€¢ æ‰¹é‡æ“ä½œ â†’ Pipeline
â€¢ å¤æ‚åŸå­æ“ä½œ â†’ Luaè„šæœ¬
â€¢ å¤§é‡å°å¯¹è±¡ â†’ Hashä»£æ›¿String

ä¸šåŠ¡é€»è¾‘éœ€æ±‚ï¼š
â€¢ æ•°æ®ä¸€è‡´æ€§ â†’ äº‹åŠ¡+WATCH
â€¢ å®æ—¶é€šçŸ¥ â†’ å‘å¸ƒè®¢é˜…
â€¢ æ¶ˆæ¯é˜Ÿåˆ— â†’ Stream

è¿ç»´ç›‘æ§éœ€æ±‚ï¼š
â€¢ æ€§èƒ½è°ƒä¼˜ â†’ æ…¢æŸ¥è¯¢ç›‘æ§
â€¢ å®¹é‡è§„åˆ’ â†’ å†…å­˜ä½¿ç”¨ç›‘æ§
â€¢ æ•°æ®æ¸…ç† â†’ è¿‡æœŸç­–ç•¥é…ç½®
```

**ğŸ”¹ æ€§èƒ½ä¸åŠŸèƒ½çš„æƒè¡¡**ï¼š
```
é«˜æ€§èƒ½åœºæ™¯ï¼š
â€¢ ä¼˜å…ˆä½¿ç”¨Pipelineæ‰¹é‡æ“ä½œ
â€¢ ç®€å•ä¸šåŠ¡é€»è¾‘é¿å…Luaè„šæœ¬
â€¢ é€‰æ‹©é«˜æ•ˆçš„æ•°æ®ç»“æ„

é«˜å¯é åœºæ™¯ï¼š
â€¢ ä½¿ç”¨äº‹åŠ¡ä¿è¯æ“ä½œåŸå­æ€§
â€¢ Streamæ›¿ä»£å‘å¸ƒè®¢é˜…
â€¢ è®¾ç½®åˆç†çš„è¶…æ—¶å’Œé‡è¯•
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ’¼ å¾®æœåŠ¡åœºæ™¯åº”ç”¨**ï¼š
```
åˆ†å¸ƒå¼é”ï¼š
â€¢ åŠ é”ï¼šLuaè„šæœ¬å®ç°SET NX + è¿‡æœŸæ—¶é—´
â€¢ é‡Šæ”¾é”ï¼šLuaè„šæœ¬æ£€æŸ¥owner + DEL
â€¢ ç»­æœŸï¼šLuaè„šæœ¬æ£€æŸ¥owner + EXPIRE

é™æµæ§åˆ¶ï¼š
â€¢ æ»‘åŠ¨çª—å£ï¼šLuaè„šæœ¬ + ZSET
â€¢ ä»¤ç‰Œæ¡¶ï¼šLuaè„šæœ¬ + Stringè®¡æ•°
â€¢ å›ºå®šçª—å£ï¼šç®€å•çš„INCR + EXPIRE

æ¶ˆæ¯é€šä¿¡ï¼š
â€¢ å®æ—¶é€šçŸ¥ï¼šå‘å¸ƒè®¢é˜…æ¨¡å¼
â€¢ å¯é æ¶ˆæ¯ï¼šStreamæ¶ˆè´¹ç»„
â€¢ äº‹ä»¶é©±åŠ¨ï¼šé”®ç©ºé—´é€šçŸ¥
```

**ğŸ› ï¸ è¿ç»´æœ€ä½³å®è·µ**ï¼š
```
ç›‘æ§å‘Šè­¦ï¼š
â€¢ å†…å­˜ä½¿ç”¨ç‡ > 80% å‘Šè­¦
â€¢ æ…¢æŸ¥è¯¢å¢é•¿è¶‹åŠ¿ç›‘æ§
â€¢ è¿æ¥æ•°å’ŒQPSç›‘æ§

å®¹é‡è§„åˆ’ï¼š
â€¢ æ ¹æ®ä¸šåŠ¡å¢é•¿é¢„ä¼°å†…å­˜éœ€æ±‚
â€¢ é€‰æ‹©åˆé€‚çš„æ·˜æ±°ç­–ç•¥
â€¢ å®šæœŸæ¸…ç†æ— ç”¨æ•°æ®

æ€§èƒ½è°ƒä¼˜ï¼š
â€¢ ä½¿ç”¨Pipelineä¼˜åŒ–æ‰¹é‡æ“ä½œ
â€¢ ç”¨Hashä¼˜åŒ–å°å¯¹è±¡å­˜å‚¨
â€¢ é¿å…å¤§keyå’Œçƒ­keyé—®é¢˜
```

### 9.4 å­¦ä¹ å»ºè®®


**ğŸ“š å¾ªåºæ¸è¿›çš„å­¦ä¹ è·¯å¾„**ï¼š
```
åŸºç¡€é˜¶æ®µï¼š
â€¢ ç†Ÿç»ƒæŒæ¡Pipelineä½¿ç”¨
â€¢ ç†è§£äº‹åŠ¡çš„åŸå­æ€§ç‰¹ç‚¹
â€¢ ä¼šå†™ç®€å•çš„Luaè„šæœ¬

è¿›é˜¶é˜¶æ®µï¼š
â€¢ è®¾è®¡å¤æ‚çš„Luaè„šæœ¬ä¸šåŠ¡é€»è¾‘
â€¢ ä½¿ç”¨Streamæ„å»ºæ¶ˆæ¯ç³»ç»Ÿ
â€¢ é…ç½®åˆé€‚çš„è¿‡æœŸå’Œæ·˜æ±°ç­–ç•¥

é«˜çº§é˜¶æ®µï¼š
â€¢ æ€§èƒ½ç›‘æ§å’Œè°ƒä¼˜
â€¢ å¤§è§„æ¨¡é›†ç¾¤è¿ç»´
â€¢ æºç åˆ†æå’Œå®šåˆ¶å¼€å‘
```

**ğŸ¯ åŠ¨æ‰‹å®è·µå»ºè®®**ï¼š
```
å¿…åšç»ƒä¹ ï¼š
1. ç”¨Pipelineå®ç°æ‰¹é‡ç”¨æˆ·æ•°æ®å¯¼å…¥
2. ç”¨Luaè„šæœ¬å®ç°åˆ†å¸ƒå¼é”
3. ç”¨Streamæ„å»ºç®€å•çš„æ¶ˆæ¯é˜Ÿåˆ—
4. é…ç½®æ…¢æŸ¥è¯¢ç›‘æ§å’Œå†…å­˜å‘Šè­¦

è¿›é˜¶é¡¹ç›®ï¼š
1. åŸºäºRedisçš„é™æµç»„ä»¶
2. åˆ†å¸ƒå¼ä¼šè¯ç®¡ç†ç³»ç»Ÿ
3. å®æ—¶è®¡æ•°å’Œæ’è¡Œæ¦œç³»ç»Ÿ
4. æ¶ˆæ¯æ¨é€æœåŠ¡
```

**ğŸ§  è®°å¿†è¦ç‚¹**ï¼š
- Pipelineæ‰¹é‡æé€Ÿï¼Œäº‹åŠ¡åŸå­ä¿è¯
- Luaè„šæœ¬æœåŠ¡ç«¯æ‰§è¡Œï¼Œå‘å¸ƒè®¢é˜…å®æ—¶é€šçŸ¥  
- StreamæŒä¹…æ¶ˆæ¯ï¼Œè¿‡æœŸæ·˜æ±°å†…å­˜ç®¡ç†
- æ…¢æŸ¥è¯¢æ‰¾ç“¶é¢ˆï¼Œé”®ç©ºé—´ç›‘æ§å˜åŒ–
- æ ¹æ®åœºæ™¯é€‰å·¥å…·ï¼Œæ€§èƒ½åŠŸèƒ½éœ€å¹³è¡¡

**æ ¸å¿ƒç†å¿µ**ï¼šRedisé«˜çº§ç‰¹æ€§æ˜¯ä¸ºäº†è§£å†³å…·ä½“é—®é¢˜è€Œè®¾è®¡çš„ï¼Œä¸æ˜¯ä¸ºäº†ç‚«æŠ€ã€‚ç†è§£ä¸šåŠ¡éœ€æ±‚ï¼Œé€‰æ‹©åˆé€‚çš„å·¥å…·ï¼Œæ‰èƒ½å‘æŒ¥Redisçš„æœ€å¤§ä»·å€¼ï¼