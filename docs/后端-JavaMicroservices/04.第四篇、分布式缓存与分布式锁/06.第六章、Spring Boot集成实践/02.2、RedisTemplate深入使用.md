---
title: 2ã€RedisTemplateæ·±å…¥ä½¿ç”¨
---
## ğŸ“š ç›®å½•

1. [RedisTemplateåŸºç¡€è®¤çŸ¥](#1-redistemplateåŸºç¡€è®¤çŸ¥)
2. [StringRedisTemplateæ ¸å¿ƒåº”ç”¨](#2-stringredistemplateæ ¸å¿ƒåº”ç”¨)
3. [åºåˆ—åŒ–é…ç½®æ·±åº¦è§£æ](#3-åºåˆ—åŒ–é…ç½®æ·±åº¦è§£æ)
4. [è¿æ¥æ± å‚æ•°è°ƒä¼˜ç­–ç•¥](#4-è¿æ¥æ± å‚æ•°è°ƒä¼˜ç­–ç•¥)
5. [è¶…æ—¶è®¾ç½®ä¸ç­–ç•¥é…ç½®](#5-è¶…æ—¶è®¾ç½®ä¸ç­–ç•¥é…ç½®)
6. [å¼‚å¸¸å¤„ç†æœºåˆ¶è®¾è®¡](#6-å¼‚å¸¸å¤„ç†æœºåˆ¶è®¾è®¡)
7. [æ‰¹é‡æ“ä½œæ€§èƒ½ä¼˜åŒ–](#7-æ‰¹é‡æ“ä½œæ€§èƒ½ä¼˜åŒ–)
8. [ç®¡é“æ“ä½œé«˜æ•ˆåº”ç”¨](#8-ç®¡é“æ“ä½œé«˜æ•ˆåº”ç”¨)
9. [äº‹åŠ¡æ”¯æŒä¸ä¸€è‡´æ€§](#9-äº‹åŠ¡æ”¯æŒä¸ä¸€è‡´æ€§)
10. [é›†ç¾¤æ“ä½œä¸åˆ†ç‰‡ç­–ç•¥](#10-é›†ç¾¤æ“ä½œä¸åˆ†ç‰‡ç­–ç•¥)
11. [ç›‘æ§é›†æˆä¸è¿ç»´å®è·µ](#11-ç›‘æ§é›†æˆä¸è¿ç»´å®è·µ)
12. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#12-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ RedisTemplateåŸºç¡€è®¤çŸ¥


### 1.1 ä»€ä¹ˆæ˜¯RedisTemplate


**ğŸ”¸ æœ¬è´¨ç†è§£**
```
RedisTemplateå°±åƒæ˜¯ä½ å’ŒRedisæ•°æ®åº“ä¹‹é—´çš„"ç¿»è¯‘å®˜"ï¼š

æ—¥å¸¸ç±»æ¯”ï¼š
- ä½ æƒ³å’Œå¤–å›½æœ‹å‹äº¤æµï¼Œä½†è¯­è¨€ä¸é€š
- ç¿»è¯‘å®˜å¸®ä½ æŠŠä¸­æ–‡è½¬æˆè‹±æ–‡ï¼ŒæŠŠè‹±æ–‡è½¬æˆä¸­æ–‡
- RedisTemplateå°±æ˜¯è¿™ä¸ªç¿»è¯‘å®˜ï¼Œå¸®Javaå¯¹è±¡å’ŒRedisæ•°æ®äº’ç›¸è½¬æ¢

æŠ€æœ¯å±‚é¢ï¼š
- å°è£…äº†Redisçš„å„ç§æ“ä½œå‘½ä»¤
- å¤„ç†æ•°æ®çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–
- ç®¡ç†è¿æ¥æ± å’Œç½‘ç»œé€šä¿¡
- æä¾›ç»Ÿä¸€çš„ç¼–ç¨‹æ¥å£
```

### 1.2 RedisTemplate vs StringRedisTemplate


**ğŸ”„ ä¸¤å…„å¼Ÿçš„åŒºåˆ«**

| ç‰¹æ€§å¯¹æ¯” | **RedisTemplate** | **StringRedisTemplate** |
|---------|-------------------|------------------------|
| **æ•°æ®ç±»å‹** | `æ”¯æŒå„ç§Javaå¯¹è±¡` | `åªå¤„ç†å­—ç¬¦ä¸²ç±»å‹` |
| **åºåˆ—åŒ–æ–¹å¼** | `JDKé»˜è®¤åºåˆ—åŒ–ï¼ˆäºŒè¿›åˆ¶ï¼‰` | `UTF-8å­—ç¬¦ä¸²åºåˆ—åŒ–` |
| **å­˜å‚¨æ ¼å¼** | `äºŒè¿›åˆ¶æ•°æ®ï¼Œäººçœ¼ä¸å¯è¯»` | `çº¯æ–‡æœ¬ï¼Œç›´è§‚å¯è¯»` |
| **æ€§èƒ½ç‰¹ç‚¹** | `åºåˆ—åŒ–å¼€é”€è¾ƒå¤§` | `åºåˆ—åŒ–ç®€å•å¿«é€Ÿ` |
| **é€‚ç”¨åœºæ™¯** | `å¤æ‚å¯¹è±¡å­˜å‚¨` | `ç®€å•å­—ç¬¦ä¸²ç¼“å­˜` |

**ğŸ’¡ é€‰æ‹©å»ºè®®**
```
StringRedisTemplateé€‚åˆï¼š
âœ… ç¼“å­˜ç®€å•çš„å­—ç¬¦ä¸²æ•°æ®
âœ… éœ€è¦åœ¨Rediså®¢æˆ·ç«¯å·¥å…·ä¸­ç›´æ¥æŸ¥çœ‹æ•°æ®
âœ… ä¸å…¶ä»–è¯­è¨€çš„åº”ç”¨å…±äº«ç¼“å­˜
âœ… å¯¹æ€§èƒ½è¦æ±‚è¾ƒé«˜çš„åœºæ™¯

RedisTemplateé€‚åˆï¼š
âœ… éœ€è¦ç¼“å­˜å¤æ‚Javaå¯¹è±¡
âœ… å¸Œæœ›ä¿æŒå¯¹è±¡ç»“æ„å®Œæ•´æ€§
âœ… çº¯Javaåº”ç”¨å†…éƒ¨ä½¿ç”¨
âœ… å¯¹åºåˆ—åŒ–æ ¼å¼ä¸æ•æ„Ÿ
```

### 1.3 åŸºæœ¬é…ç½®å…¥é—¨


**âš™ï¸ æœ€ç®€å•çš„é…ç½®**
```java
@Configuration
public class RedisConfig {
    
    @Bean
    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory factory) {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(factory);
        
        // è®¾ç½®åºåˆ—åŒ–æ–¹å¼ï¼ˆåé¢è¯¦ç»†è®²è§£ï¼‰
        template.setKeySerializer(RedisSerializer.string());
        template.setValueSerializer(RedisSerializer.json());
        
        return template;
    }
}
```

---

## 2. ğŸ“ StringRedisTemplateæ ¸å¿ƒåº”ç”¨


### 2.1 åŸºç¡€æ“ä½œå®æˆ˜


**ğŸ”¸ å­—ç¬¦ä¸²æ“ä½œ**
```java
@Service
public class CacheService {
    
    @Autowired
    private StringRedisTemplate stringRedisTemplate;
    
    // åŸºæœ¬å­˜å–æ“ä½œ
    public void basicOperations() {
        // å­˜å‚¨æ•°æ®
        stringRedisTemplate.opsForValue().set("user:name", "å¼ ä¸‰");
        
        // è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆ30åˆ†é’Ÿï¼‰
        stringRedisTemplate.opsForValue().set("session:abc123", "user_data", 
                Duration.ofMinutes(30));
        
        // è·å–æ•°æ®
        String name = stringRedisTemplate.opsForValue().get("user:name");
        
        // æ£€æŸ¥é”®æ˜¯å¦å­˜åœ¨
        Boolean exists = stringRedisTemplate.hasKey("user:name");
    }
}
```

### 2.2 æ•°æ®ç±»å‹æ“ä½œè¯¦è§£


**ğŸ“Š Hashæ“ä½œï¼ˆæœ€å¸¸ç”¨ï¼‰**
```java
// Hashæ“ä½œ - å­˜å‚¨ç”¨æˆ·ä¿¡æ¯
public void hashOperations() {
    String userKey = "user:1001";
    
    // å­˜å‚¨ç”¨æˆ·ä¿¡æ¯
    stringRedisTemplate.opsForHash().put(userKey, "name", "æå››");
    stringRedisTemplate.opsForHash().put(userKey, "age", "25");
    stringRedisTemplate.opsForHash().put(userKey, "email", "lisi@example.com");
    
    // æ‰¹é‡å­˜å‚¨
    Map<String, String> userInfo = new HashMap<>();
    userInfo.put("phone", "13800138000");
    userInfo.put("address", "åŒ—äº¬å¸‚æœé˜³åŒº");
    stringRedisTemplate.opsForHash().putAll(userKey, userInfo);
    
    // è·å–å•ä¸ªå­—æ®µ
    String name = (String) stringRedisTemplate.opsForHash().get(userKey, "name");
    
    // è·å–æ‰€æœ‰å­—æ®µ
    Map<Object, Object> allInfo = stringRedisTemplate.opsForHash().entries(userKey);
}
```

**ğŸ“‹ Listæ“ä½œï¼ˆé˜Ÿåˆ—åœºæ™¯ï¼‰**
```java
// Listæ“ä½œ - æ¶ˆæ¯é˜Ÿåˆ—æˆ–æ—¥å¿—è®°å½•
public void listOperations() {
    String queueKey = "message:queue";
    
    // ä»å·¦ä¾§æ¨å…¥ï¼ˆç”Ÿäº§è€…ï¼‰
    stringRedisTemplate.opsForList().leftPush(queueKey, "æ¶ˆæ¯1");
    stringRedisTemplate.opsForList().leftPush(queueKey, "æ¶ˆæ¯2");
    
    // ä»å³ä¾§å–å‡ºï¼ˆæ¶ˆè´¹è€…ï¼‰
    String message = stringRedisTemplate.opsForList().rightPop(queueKey);
    
    // è·å–é˜Ÿåˆ—é•¿åº¦
    Long size = stringRedisTemplate.opsForList().size(queueKey);
}
```

### 2.3 å®é™…ä¸šåŠ¡åº”ç”¨æ¡ˆä¾‹


**ğŸª ç”¨æˆ·ä¼šè¯ç®¡ç†**
```java
@Component
public class SessionManager {
    
    @Autowired
    private StringRedisTemplate redisTemplate;
    
    // åˆ›å»ºç”¨æˆ·ä¼šè¯
    public String createSession(String userId) {
        String sessionId = UUID.randomUUID().toString();
        String sessionKey = "session:" + sessionId;
        
        // å­˜å‚¨ä¼šè¯ä¿¡æ¯ï¼Œ30åˆ†é’Ÿè¿‡æœŸ
        redisTemplate.opsForHash().put(sessionKey, "userId", userId);
        redisTemplate.opsForHash().put(sessionKey, "createTime", 
                String.valueOf(System.currentTimeMillis()));
        redisTemplate.expire(sessionKey, Duration.ofMinutes(30));
        
        return sessionId;
    }
    
    // éªŒè¯ä¼šè¯æœ‰æ•ˆæ€§
    public boolean isValidSession(String sessionId) {
        String sessionKey = "session:" + sessionId;
        return redisTemplate.hasKey(sessionKey);
    }
}
```

---

## 3. ğŸ”„ åºåˆ—åŒ–é…ç½®æ·±åº¦è§£æ


### 3.1 åºåˆ—åŒ–æ–¹å¼å¯¹æ¯”åˆ†æ


**ğŸ“Š å¸¸ç”¨åºåˆ—åŒ–æ–¹å¼ç‰¹ç‚¹**

| åºåˆ—åŒ–ç±»å‹ | **ä¼˜åŠ¿** | **åŠ£åŠ¿** | **é€‚ç”¨åœºæ™¯** |
|-----------|----------|----------|-------------|
| **JDKé»˜è®¤** | `å®Œæ•´ä¿æŒå¯¹è±¡ç»“æ„` | `ä½“ç§¯å¤§ï¼Œä¸å¯è¯»` | `çº¯Javaåº”ç”¨` |
| **JSON** | `è·¨è¯­è¨€ï¼Œå¯è¯»æ€§å¥½` | `ç±»å‹ä¿¡æ¯å¯èƒ½ä¸¢å¤±` | `å‰åç«¯åˆ†ç¦»é¡¹ç›®` |
| **String** | `ç®€å•å¿«é€Ÿï¼Œç›´è§‚` | `åªèƒ½å­˜å­—ç¬¦ä¸²` | `ç®€å•æ•°æ®ç¼“å­˜` |
| **Protobuf** | `ä½“ç§¯å°ï¼Œæ€§èƒ½é«˜` | `éœ€è¦å®šä¹‰åè®®æ–‡ä»¶` | `é«˜æ€§èƒ½å¾®æœåŠ¡` |

### 3.2 JSONåºåˆ—åŒ–é…ç½®å®è·µ


**âš™ï¸ æ¨èçš„JSONé…ç½®**
```java
@Configuration
public class RedisConfig {
    
    @Bean
    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory factory) {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(factory);
        
        // JSONåºåˆ—åŒ–é…ç½®
        GenericJackson2JsonRedisSerializer jsonSerializer = 
                new GenericJackson2JsonRedisSerializer();
        
        // Keyä½¿ç”¨Stringåºåˆ—åŒ–
        template.setKeySerializer(RedisSerializer.string());
        template.setHashKeySerializer(RedisSerializer.string());
        
        // Valueä½¿ç”¨JSONåºåˆ—åŒ–
        template.setValueSerializer(jsonSerializer);
        template.setHashValueSerializer(jsonSerializer);
        
        return template;
    }
}
```

### 3.3 è‡ªå®šä¹‰åºåˆ—åŒ–ç­–ç•¥


**ğŸ¯ å®é™…ä½¿ç”¨ç¤ºä¾‹**
```java
// ç”¨æˆ·ä¿¡æ¯ç¼“å­˜ç¤ºä¾‹
@Service
public class UserCacheService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // ç¼“å­˜ç”¨æˆ·ä¿¡æ¯
    public void cacheUser(User user) {
        String key = "user:info:" + user.getId();
        // ç›´æ¥å­˜å‚¨å¯¹è±¡ï¼Œè‡ªåŠ¨JSONåºåˆ—åŒ–
        redisTemplate.opsForValue().set(key, user, Duration.ofHours(1));
    }
    
    // è·å–ç”¨æˆ·ä¿¡æ¯
    public User getUser(Long userId) {
        String key = "user:info:" + userId;
        return (User) redisTemplate.opsForValue().get(key);
    }
}
```

---

## 4. ğŸŠ è¿æ¥æ± å‚æ•°è°ƒä¼˜ç­–ç•¥


### 4.1 è¿æ¥æ± å·¥ä½œåŸç†


**ğŸ”¸ è¿æ¥æ± å°±åƒåœè½¦åœº**
```
åœè½¦åœºç±»æ¯”ç†è§£è¿æ¥æ± ï¼š

åœè½¦åœºï¼ˆè¿æ¥æ± ï¼‰ï¼š
- æ€»å…±50ä¸ªè½¦ä½ï¼ˆæœ€å¤§è¿æ¥æ•°ï¼‰
- å¹³æ—¶ä¿æŒ10ä¸ªç©ºä½ï¼ˆæœ€å°ç©ºé—²è¿æ¥ï¼‰
- è½¦ä½ä¸å¤Ÿæ—¶ï¼Œè½¦ä¸»è¦æ’é˜Ÿç­‰å¾…ï¼ˆè¿æ¥ç­‰å¾…ï¼‰
- è½¦ä½ç©ºé—²å¤ªä¹…ï¼Œç®¡ç†å‘˜ä¼šå…³é—­éƒ¨åˆ†ï¼ˆè¿æ¥å›æ”¶ï¼‰

Redisè¿æ¥æ± ï¼š
- maxTotalï¼šåœè½¦åœºæ€»è½¦ä½æ•°
- maxIdleï¼šä¿æŒçš„æœ€å¤§ç©ºé—²è¿æ¥æ•°
- minIdleï¼šä¿æŒçš„æœ€å°ç©ºé—²è¿æ¥æ•°
- maxWaitMillisï¼šç­‰å¾…è¿æ¥çš„æœ€é•¿æ—¶é—´
```

### 4.2 å…³é”®å‚æ•°é…ç½®è¯´æ˜


**âš™ï¸ è¿æ¥æ± é…ç½®è¯¦è§£**
```yaml
# application.yml
spring:
  redis:
    host: localhost
    port: 6379
    jedis:
      pool:
        max-active: 50      # æœ€å¤§è¿æ¥æ•°
        max-idle: 20        # æœ€å¤§ç©ºé—²è¿æ¥æ•°
        min-idle: 5         # æœ€å°ç©ºé—²è¿æ¥æ•°
        max-wait: 3000      # è·å–è¿æ¥æœ€å¤§ç­‰å¾…æ—¶é—´(ms)
    timeout: 2000           # è¿æ¥è¶…æ—¶æ—¶é—´(ms)
```

**ğŸ’¡ å‚æ•°è°ƒä¼˜å»ºè®®**
```
é«˜å¹¶å‘åº”ç”¨å»ºè®®ï¼š
âœ… max-active: æ ¹æ®QPSä¼°ç®—ï¼Œä¸€èˆ¬50-200
âœ… max-idle: max-activeçš„40%å·¦å³
âœ… min-idle: å§‹ç»ˆä¿æŒ5-10ä¸ªè¿æ¥
âœ… max-wait: ä¸è¦è®¾ç½®å¤ªé•¿ï¼Œ3-5ç§’å³å¯

ä½å¹¶å‘åº”ç”¨å»ºè®®ï¼š
âœ… max-active: 10-20è¶³å¤Ÿ
âœ… max-idle: 5-10å³å¯
âœ… min-idle: 2-5ä¸ªè¿æ¥
âœ… max-wait: å¯ä»¥è®¾ç½®çŸ­ä¸€äº›ï¼Œ1-2ç§’
```

### 4.3 è¿æ¥æ± ç›‘æ§ä¸è¯Šæ–­


**ğŸ“Š è¿æ¥æ± çŠ¶æ€æ£€æŸ¥**
```java
@Component
public class RedisPoolMonitor {
    
    @Autowired
    private RedisConnectionFactory connectionFactory;
    
    // è·å–è¿æ¥æ± çŠ¶æ€ä¿¡æ¯
    public void checkPoolStatus() {
        if (connectionFactory instanceof JedisConnectionFactory) {
            JedisConnectionFactory jedisFactory = (JedisConnectionFactory) connectionFactory;
            
            // è¿™é‡Œå¯ä»¥è·å–æ± çš„çŠ¶æ€ä¿¡æ¯
            // å®é™…é¡¹ç›®ä¸­å»ºè®®é›†æˆåˆ°ç›‘æ§ç³»ç»Ÿ
            log.info("Redisè¿æ¥æ± çŠ¶æ€æ£€æŸ¥å®Œæˆ");
        }
    }
}
```

---

## 5. â° è¶…æ—¶è®¾ç½®ä¸ç­–ç•¥é…ç½®


### 5.1 è¶…æ—¶ç±»å‹ç†è§£


**ğŸ”¸ ä¸‰ç§è¶…æ—¶æ—¶é—´çš„åŒºåˆ«**
```
è¿æ¥è¶…æ—¶ï¼ˆConnection Timeoutï¼‰ï¼š
- å«ä¹‰ï¼šå»ºç«‹Redisè¿æ¥çš„æœ€é•¿ç­‰å¾…æ—¶é—´
- ç±»æ¯”ï¼šæ‹¨æ‰“ç”µè¯æ—¶ç­‰å¾…æ¥é€šçš„æ—¶é—´
- å½±å“ï¼šç½‘ç»œå»¶è¿Ÿé«˜æ—¶éœ€è¦é€‚å½“è°ƒå¤§

è¯»å–è¶…æ—¶ï¼ˆRead Timeoutï¼‰ï¼š
- å«ä¹‰ï¼šå‘é€å‘½ä»¤åç­‰å¾…å“åº”çš„æœ€é•¿æ—¶é—´
- ç±»æ¯”ï¼šé—®è¯åç­‰å¾…å¯¹æ–¹å›ç­”çš„æ—¶é—´
- å½±å“ï¼šRediså¤„ç†æ…¢æˆ–ç½‘ç»œå·®æ—¶è§¦å‘

å‘½ä»¤è¶…æ—¶ï¼ˆCommand Timeoutï¼‰ï¼š
- å«ä¹‰ï¼šå•ä¸ªRediså‘½ä»¤çš„æ‰§è¡Œè¶…æ—¶
- ç±»æ¯”ï¼šå®Œæˆä¸€ä»¶ä»»åŠ¡çš„æ—¶é—´é™åˆ¶
- å½±å“ï¼šå¤æ‚æ“ä½œï¼ˆå¦‚SORTï¼‰å¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´
```

### 5.2 è¶…æ—¶å‚æ•°é…ç½®ç­–ç•¥


**âš™ï¸ åˆ†åœºæ™¯è¶…æ—¶é…ç½®**
```yaml
spring:
  redis:
    # è¿æ¥è¶…æ—¶ï¼šç½‘ç»œå»ºç«‹è¿æ¥çš„æ—¶é—´
    connect-timeout: 2000ms
    
    # è¯»å–è¶…æ—¶ï¼šç­‰å¾…Rediså“åº”çš„æ—¶é—´
    timeout: 5000ms
    
    jedis:
      pool:
        # ä»è¿æ¥æ± è·å–è¿æ¥çš„ç­‰å¾…æ—¶é—´
        max-wait: 3000ms
```

**ğŸ’¡ è¶…æ—¶æ—¶é—´è®¾ç½®å»ºè®®**
```
å†…ç½‘ç¯å¢ƒï¼ˆæ¨èè®¾ç½®ï¼‰ï¼š
- connect-timeout: 1-2ç§’
- timeout: 2-5ç§’
- max-wait: 2-3ç§’

è·¨æœºæˆ¿/å…¬ç½‘ç¯å¢ƒï¼š
- connect-timeout: 3-5ç§’
- timeout: 5-10ç§’
- max-wait: 3-5ç§’

æ‰¹é‡æ“ä½œåœºæ™¯ï¼š
- timeout: é€‚å½“å»¶é•¿åˆ°10-30ç§’
- è€ƒè™‘ä½¿ç”¨Pipelineå‡å°‘ç½‘ç»œå¾€è¿”
```

### 5.3 è¶…æ—¶å¼‚å¸¸å¤„ç†å®è·µ


**ğŸ›¡ï¸ ä¼˜é›…çš„è¶…æ—¶å¤„ç†**
```java
@Service
public class RobustCacheService {
    
    @Autowired
    private StringRedisTemplate redisTemplate;
    
    // å¸¦è¶…æ—¶å¤„ç†çš„ç¼“å­˜è·å–
    public String getCacheWithTimeout(String key) {
        try {
            return redisTemplate.opsForValue().get(key);
        } catch (RedisCommandTimeoutException e) {
            log.warn("Redisè¯»å–è¶…æ—¶: key={}, é”™è¯¯={}", key, e.getMessage());
            // è¿”å›é»˜è®¤å€¼æˆ–ä»æ•°æ®åº“è·å–
            return getFromDatabase(key);
        } catch (RedisConnectionFailureException e) {
            log.error("Redisè¿æ¥å¤±è´¥: key={}, é”™è¯¯={}", key, e.getMessage());
            // é™çº§å¤„ç†
            return handleRedisUnavailable(key);
        }
    }
    
    private String getFromDatabase(String key) {
        // ä»æ•°æ®åº“è·å–æ•°æ®çš„å¤‡ç”¨é€»è¾‘
        return "default_value";
    }
    
    private String handleRedisUnavailable(String key) {
        // Redisä¸å¯ç”¨æ—¶çš„é™çº§å¤„ç†
        return "fallback_value";
    }
}
```

---

## 6. ğŸ›¡ï¸ å¼‚å¸¸å¤„ç†æœºåˆ¶è®¾è®¡


### 6.1 å¸¸è§Rediså¼‚å¸¸ç±»å‹


**âš ï¸ å¼‚å¸¸åˆ†ç±»ä¸å«ä¹‰**

| å¼‚å¸¸ç±»å‹ | **è§¦å‘åŸå› ** | **å¤„ç†ç­–ç•¥** | **é¢„é˜²æªæ–½** |
|---------|-------------|-------------|-------------|
| **è¿æ¥å¼‚å¸¸** | `ç½‘ç»œé—®é¢˜ã€Rediså®•æœº` | `é™çº§å¤„ç†ã€é‡è¯•æœºåˆ¶` | `è¿æ¥æ± é…ç½®ã€å¥åº·æ£€æŸ¥` |
| **è¶…æ—¶å¼‚å¸¸** | `å“åº”æ…¢ã€ç½‘ç»œå»¶è¿Ÿ` | `è®°å½•æ—¥å¿—ã€å¤‡ç”¨æ–¹æ¡ˆ` | `åˆç†è®¾ç½®è¶…æ—¶æ—¶é—´` |
| **å†…å­˜å¼‚å¸¸** | `Rediså†…å­˜ä¸è¶³` | `æ¸…ç†ç¼“å­˜ã€æ‰©å®¹` | `ç›‘æ§å†…å­˜ä½¿ç”¨ç‡` |
| **åºåˆ—åŒ–å¼‚å¸¸** | `å¯¹è±¡æ ¼å¼ä¸å…¼å®¹` | `å…¼å®¹æ€§å¤„ç†` | `ç‰ˆæœ¬å‡çº§è§„åˆ’` |

### 6.2 åˆ†çº§å¼‚å¸¸å¤„ç†ç­–ç•¥


**ğŸ¯ å¼‚å¸¸å¤„ç†æœ€ä½³å®è·µ**
```java
@Service
public class ReliableCacheService {
    
    private static final Logger log = LoggerFactory.getLogger(ReliableCacheService.class);
    
    @Autowired
    private StringRedisTemplate redisTemplate;
    
    // åˆ†çº§å¼‚å¸¸å¤„ç†
    public String getFromCache(String key) {
        try {
            return redisTemplate.opsForValue().get(key);
            
        } catch (RedisConnectionFailureException e) {
            // çº§åˆ«1ï¼šè¿æ¥å¤±è´¥ - ä¸¥é‡å¼‚å¸¸
            log.error("Redisè¿æ¥å¤±è´¥ï¼Œå¯ç”¨é™çº§æ¨¡å¼: key={}", key, e);
            return handleConnectionFailure(key);
            
        } catch (RedisCommandTimeoutException e) {
            // çº§åˆ«2ï¼šå‘½ä»¤è¶…æ—¶ - å¯æ¢å¤å¼‚å¸¸
            log.warn("Rediså‘½ä»¤è¶…æ—¶ï¼Œå°è¯•é‡è¯•: key={}", key);
            return retryWithBackoff(key, 1);
            
        } catch (RedisSystemException e) {
            // çº§åˆ«3ï¼šç³»ç»Ÿå¼‚å¸¸ - æ ¹æ®æƒ…å†µå¤„ç†
            log.warn("Redisç³»ç»Ÿå¼‚å¸¸: key={}, é”™è¯¯={}", key, e.getMessage());
            return handleSystemException(key, e);
            
        } catch (Exception e) {
            // çº§åˆ«4ï¼šæœªçŸ¥å¼‚å¸¸ - ä¿å®ˆå¤„ç†
            log.error("RedisæœªçŸ¥å¼‚å¸¸: key={}", key, e);
            return null;
        }
    }
    
    // è¿æ¥å¤±è´¥å¤„ç†ï¼šç›´æ¥é™çº§
    private String handleConnectionFailure(String key) {
        // æ ‡è®°Redisä¸å¯ç”¨ï¼ŒçŸ­æ—¶é—´å†…ä¸å†å°è¯•
        return getDatabaseValue(key);
    }
    
    // è¶…æ—¶é‡è¯•ï¼šæŒ‡æ•°é€€é¿
    private String retryWithBackoff(String key, int attempt) {
        if (attempt > 3) {
            return getDatabaseValue(key);
        }
        
        try {
            Thread.sleep(attempt * 100); // 100ms, 200ms, 300ms
            return redisTemplate.opsForValue().get(key);
        } catch (Exception e) {
            return retryWithBackoff(key, attempt + 1);
        }
    }
    
    private String getDatabaseValue(String key) {
        // ä»æ•°æ®åº“è·å–ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†
        return "db_value_for_" + key;
    }
    
    private String handleSystemException(String key, Exception e) {
        // æ ¹æ®å…·ä½“å¼‚å¸¸ç±»å‹å†³å®šå¤„ç†æ–¹å¼
        return null;
    }
}
```

### 6.3 å¼‚å¸¸ç›‘æ§ä¸å‘Šè­¦


**ğŸ“Š å¼‚å¸¸ç›‘æ§è®¾è®¡**
```java
@Component
public class RedisExceptionMonitor {
    
    private final AtomicLong connectionFailureCount = new AtomicLong(0);
    private final AtomicLong timeoutCount = new AtomicLong(0);
    
    // è®°å½•å¼‚å¸¸ç»Ÿè®¡
    public void recordException(Exception e) {
        if (e instanceof RedisConnectionFailureException) {
            connectionFailureCount.incrementAndGet();
            // è¿æ¥å¤±è´¥è¶…è¿‡é˜ˆå€¼æ—¶è§¦å‘å‘Šè­¦
            if (connectionFailureCount.get() % 10 == 0) {
                sendAlert("Redisè¿æ¥å¼‚å¸¸é¢‘å‘");
            }
        } else if (e instanceof RedisCommandTimeoutException) {
            timeoutCount.incrementAndGet();
        }
    }
    
    // å®šæœŸé‡ç½®ç»Ÿè®¡è®¡æ•°å™¨
    @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿé‡ç½®
    public void resetCounters() {
        connectionFailureCount.set(0);
        timeoutCount.set(0);
    }
    
    private void sendAlert(String message) {
        // å‘é€å‘Šè­¦é€šçŸ¥ï¼Œæ¯”å¦‚é’‰é’‰ã€é‚®ä»¶ç­‰
        log.error("Rediså‘Šè­¦: {}", message);
    }
}
```

---

## 7. ğŸš€ æ‰¹é‡æ“ä½œæ€§èƒ½ä¼˜åŒ–


### 7.1 æ‰¹é‡æ“ä½œçš„æ€§èƒ½ä»·å€¼


**ğŸ“ˆ æ€§èƒ½å¯¹æ¯”åˆ†æ**
```
å•ä¸ªæ“ä½œ vs æ‰¹é‡æ“ä½œæ€§èƒ½å·®å¼‚ï¼š

å•ä¸ªæ“ä½œï¼ˆé€ä¸ªæ‰§è¡Œï¼‰ï¼š
- 100æ¬¡setæ“ä½œ = 100æ¬¡ç½‘ç»œå¾€è¿”
- æ¯æ¬¡å¾€è¿”å»¶è¿Ÿ2msï¼Œæ€»è€—æ—¶ï¼š200ms
- ç½‘ç»œå¼€é”€å ä¸»è¦æ—¶é—´

æ‰¹é‡æ“ä½œï¼ˆä¸€æ¬¡æ€§æ‰§è¡Œï¼‰ï¼š
- 100æ¬¡setæ“ä½œ = 1æ¬¡ç½‘ç»œå¾€è¿”
- æ€»è€—æ—¶ï¼šçº¦10msï¼ˆå¤§éƒ¨åˆ†æ˜¯æ‰§è¡Œæ—¶é—´ï¼‰
- æ€§èƒ½æå‡ï¼š20å€ä»¥ä¸Šï¼
```

### 7.2 MultiSetå’ŒMultiGetæ“ä½œ


**âš¡ æ‰¹é‡å­—ç¬¦ä¸²æ“ä½œ**
```java
@Service
public class BatchCacheService {
    
    @Autowired
    private StringRedisTemplate redisTemplate;
    
    // æ‰¹é‡è®¾ç½®å¤šä¸ªé”®å€¼å¯¹
    public void batchSetValues(Map<String, String> keyValueMap) {
        // ä½¿ç”¨MultiSetä¸€æ¬¡æ€§è®¾ç½®å¤šä¸ªå€¼
        redisTemplate.opsForValue().multiSet(keyValueMap);
    }
    
    // æ‰¹é‡è·å–å¤šä¸ªé”®çš„å€¼
    public List<String> batchGetValues(List<String> keys) {
        // ä½¿ç”¨MultiGetä¸€æ¬¡æ€§è·å–å¤šä¸ªå€¼
        return redisTemplate.opsForValue().multiGet(keys);
    }
    
    // å®é™…åº”ç”¨ï¼šæ‰¹é‡ç¼“å­˜ç”¨æˆ·ä¿¡æ¯
    public void cacheMultipleUsers(List<User> users) {
        Map<String, String> userCacheMap = new HashMap<>();
        
        users.forEach(user -> {
            String key = "user:profile:" + user.getId();
            String value = JsonUtils.toJson(user); // å‡è®¾æœ‰JSONå·¥å…·ç±»
            userCacheMap.put(key, value);
        });
        
        // ä¸€æ¬¡æ€§ç¼“å­˜æ‰€æœ‰ç”¨æˆ·
        redisTemplate.opsForValue().multiSet(userCacheMap);
    }
}
```

### 7.3 Hashæ‰¹é‡æ“ä½œä¼˜åŒ–


**ğŸ”„ Hashæ‰¹é‡æ“ä½œå®è·µ**
```java
// æ‰¹é‡æ›´æ–°ç”¨æˆ·ä¿¡æ¯
public void batchUpdateUserInfo(Long userId, Map<String, String> updates) {
    String userKey = "user:info:" + userId;
    
    // ä½¿ç”¨putAllä¸€æ¬¡æ€§æ›´æ–°å¤šä¸ªå­—æ®µ
    redisTemplate.opsForHash().putAll(userKey, updates);
    
    // è®¾ç½®è¿‡æœŸæ—¶é—´
    redisTemplate.expire(userKey, Duration.ofHours(2));
}

// æ‰¹é‡è·å–ç”¨æˆ·å¤šä¸ªå­—æ®µ
public Map<Object, Object> batchGetUserFields(Long userId, String... fields) {
    String userKey = "user:info:" + userId;
    
    if (fields.length == 0) {
        // è·å–æ‰€æœ‰å­—æ®µ
        return redisTemplate.opsForHash().entries(userKey);
    } else {
        // è·å–æŒ‡å®šå­—æ®µ
        List<String> fieldList = Arrays.asList(fields);
        List<Object> values = redisTemplate.opsForHash().multiGet(userKey, fieldList);
        
        // ç»„è£…ç»“æœ
        Map<Object, Object> result = new HashMap<>();
        for (int i = 0; i < fieldList.size(); i++) {
            result.put(fieldList.get(i), values.get(i));
        }
        return result;
    }
}
```

### 7.4 æ‰¹é‡æ“ä½œæ³¨æ„äº‹é¡¹


**âš ï¸ æ‰¹é‡æ“ä½œçš„é™åˆ¶å’Œå»ºè®®**
```
æ‰¹é‡å¤§å°æ§åˆ¶ï¼š
âœ… å•æ¬¡æ‰¹é‡æ“ä½œå»ºè®®ä¸è¶…è¿‡1000ä¸ª
âœ… æ•°æ®é‡å¤§æ—¶åˆ†æ‰¹å¤„ç†ï¼Œé¿å…é˜»å¡Redis
âœ… ç›‘æ§å•æ¬¡æ“ä½œçš„æ‰§è¡Œæ—¶é—´

å†…å­˜è€ƒè™‘ï¼š
âœ… å¤§é‡æ•°æ®ä¼šæ¶ˆè€—æ›´å¤šå†…å­˜
âœ… é¿å…åœ¨é«˜å³°æœŸè¿›è¡Œå¤§æ‰¹é‡æ“ä½œ
âœ… è€ƒè™‘Redisçš„maxmemoryé™åˆ¶

é”™è¯¯å¤„ç†ï¼š
âœ… æ‰¹é‡æ“ä½œå¤±è´¥æ—¶ï¼Œè€ƒè™‘éƒ¨åˆ†é‡è¯•ç­–ç•¥
âœ… è®°å½•å¤±è´¥çš„keyï¼Œæ–¹ä¾¿æ’æŸ¥é—®é¢˜
âœ… è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
```

---

## 8. ğŸ”„ ç®¡é“æ“ä½œé«˜æ•ˆåº”ç”¨


### 8.1 Pipelineå·¥ä½œåŸç†


**ğŸ”¸ ç®¡é“æ“ä½œå°±åƒä¼ é€å¸¦**
```
ä¼ ç»Ÿæ–¹å¼ï¼ˆè¯·æ±‚-å“åº”æ¨¡å¼ï¼‰ï¼š
å®¢æˆ·ç«¯ â†’ Redisï¼šå‘½ä»¤1
Redis â†’ å®¢æˆ·ç«¯ï¼šç»“æœ1
å®¢æˆ·ç«¯ â†’ Redisï¼šå‘½ä»¤2  
Redis â†’ å®¢æˆ·ç«¯ï¼šç»“æœ2
... é‡å¤næ¬¡

ç®¡é“æ–¹å¼ï¼ˆæ‰¹é‡æµæ°´çº¿ï¼‰ï¼š
å®¢æˆ·ç«¯ â†’ Redisï¼šå‘½ä»¤1ã€å‘½ä»¤2ã€å‘½ä»¤3...å‘½ä»¤n
Redis â†’ å®¢æˆ·ç«¯ï¼šç»“æœ1ã€ç»“æœ2ã€ç»“æœ3...ç»“æœn

ä¼˜åŠ¿ï¼šå‡å°‘ç½‘ç»œå¾€è¿”æ¬¡æ•°ï¼Œå¤§å¹…æå‡æ€§èƒ½
```

### 8.2 PipelineåŸºç¡€ä½¿ç”¨


**âš¡ Pipelineæ“ä½œå®ç°**
```java
@Service
public class PipelineService {
    
    @Autowired
    private StringRedisTemplate redisTemplate;
    
    // ä½¿ç”¨Pipelineæ‰¹é‡æ“ä½œ
    public void pipelineOperations() {
        // æ‰§è¡ŒPipelineæ“ä½œ
        List<Object> results = redisTemplate.executePipelined(new RedisCallback<Object>() {
            @Override
            public Object doInRedis(RedisConnection connection) throws DataAccessException {
                StringRedisConnection stringConn = (StringRedisConnection) connection;
                
                // æ‰¹é‡æ‰§è¡Œå¤šä¸ªå‘½ä»¤
                stringConn.set("key1", "value1");
                stringConn.set("key2", "value2");
                stringConn.incr("counter");
                stringConn.get("key1");
                
                // æ³¨æ„ï¼šè¿™é‡Œä¸è¦è¿”å›å…·ä½“å€¼ï¼ŒPipelineä¼šç»Ÿä¸€è¿”å›ç»“æœ
                return null;
            }
        });
        
        // å¤„ç†Pipelineæ‰§è¡Œç»“æœ
        // resultsåŒ…å«æ‰€æœ‰å‘½ä»¤çš„æ‰§è¡Œç»“æœï¼ŒæŒ‰é¡ºåºæ’åˆ—
        log.info("Pipelineæ‰§è¡Œç»“æœ: {}", results);
    }
    
    // å®é™…ä¸šåŠ¡åœºæ™¯ï¼šç”¨æˆ·æ•°æ®åˆå§‹åŒ–
    public void initializeUserData(Long userId, UserProfile profile) {
        redisTemplate.executePipelined(new RedisCallback<Object>() {
            @Override
            public Object doInRedis(RedisConnection connection) throws DataAccessException {
                StringRedisConnection stringConn = (StringRedisConnection) connection;
                
                String userKey = "user:" + userId;
                
                // ä¸€æ¬¡æ€§è®¾ç½®ç”¨æˆ·çš„å¤šä¸ªä¿¡æ¯
                stringConn.hSet(userKey, "name", profile.getName());
                stringConn.hSet(userKey, "email", profile.getEmail());
                stringConn.hSet(userKey, "phone", profile.getPhone());
                
                // åˆå§‹åŒ–ç”¨æˆ·ç»Ÿè®¡æ•°æ®
                stringConn.set("user:login_count:" + userId, "0");
                stringConn.set("user:last_login:" + userId, 
                    String.valueOf(System.currentTimeMillis()));
                
                // è®¾ç½®è¿‡æœŸæ—¶é—´
                stringConn.expire(userKey, 3600); // 1å°æ—¶
                
                return null;
            }
        });
    }
}
```

### 8.3 Pipeline vs Batchçš„é€‰æ‹©


**ğŸ“Š Pipelineå’Œæ‰¹é‡æ“ä½œå¯¹æ¯”**

| ç‰¹æ€§ | **Pipeline** | **Multi/Batch** |
|------|-------------|-----------------|
| **ç½‘ç»œå¾€è¿”** | `1æ¬¡å¾€è¿”ï¼Œå¤šä¸ªå‘½ä»¤` | `1æ¬¡å¾€è¿”ï¼Œå¤šä¸ªå‘½ä»¤` |
| **æ“ä½œç±»å‹** | `ä»»æ„Rediså‘½ä»¤ç»„åˆ` | `ç‰¹å®šæ‰¹é‡æ“ä½œ` |
| **äº‹åŠ¡æ€§** | `éåŸå­æ€§ï¼Œç‹¬ç«‹æ‰§è¡Œ` | `åŸå­æ€§æ‰§è¡Œ` |
| **æ€§èƒ½** | `ç½‘ç»œä¼˜åŒ–æ˜¾è‘—` | `æ ¹æ®æ“ä½œç±»å‹è€Œå®š` |
| **å¤æ‚åº¦** | `ç¼–ç ç¨å¤æ‚` | `ä½¿ç”¨ç®€å•` |

**ğŸ’¡ é€‰æ‹©å»ºè®®**
```
ä½¿ç”¨Pipelineåœºæ™¯ï¼š
âœ… éœ€è¦æ‰§è¡Œå¤šç§ä¸åŒç±»å‹çš„Rediså‘½ä»¤
âœ… å‘½ä»¤ä¹‹é—´æ²¡æœ‰ä¾èµ–å…³ç³»
âœ… æ³¨é‡ç½‘ç»œæ€§èƒ½ä¼˜åŒ–
âœ… å¯ä»¥æ¥å—éåŸå­æ€§æ“ä½œ

ä½¿ç”¨æ‰¹é‡æ“ä½œåœºæ™¯ï¼š
âœ… åŒç±»å‹æ“ä½œï¼ˆå¦‚multiGetã€multiSetï¼‰
âœ… æ“ä½œç®€å•ï¼Œä»£ç å¯è¯»æ€§è¦æ±‚é«˜
âœ… éœ€è¦åŸå­æ€§ä¿è¯
âœ… æ“ä½œæ•°é‡ä¸æ˜¯ç‰¹åˆ«å¤š
```

---

## 9. ğŸ”’ äº‹åŠ¡æ”¯æŒä¸ä¸€è‡´æ€§


### 9.1 Redisäº‹åŠ¡åŸºç¡€ç†è§£


**ğŸ”¸ Redisäº‹åŠ¡çš„ç‰¹ç‚¹**
```
Redisäº‹åŠ¡å’Œæ•°æ®åº“äº‹åŠ¡çš„åŒºåˆ«ï¼š

æ•°æ®åº“äº‹åŠ¡ï¼ˆACIDï¼‰ï¼š
- åŸå­æ€§ï¼šå…¨éƒ¨æˆåŠŸæˆ–å…¨éƒ¨å¤±è´¥
- ä¸€è‡´æ€§ï¼šæ•°æ®ä¿æŒä¸€è‡´çŠ¶æ€
- éš”ç¦»æ€§ï¼šäº‹åŠ¡é—´ç›¸äº’éš”ç¦»
- æŒä¹…æ€§ï¼šæäº¤åæ°¸ä¹…ä¿å­˜

Redisäº‹åŠ¡ï¼ˆæœ‰é™æ”¯æŒï¼‰ï¼š
âœ… åŸå­æ€§ï¼šå‘½ä»¤è¦ä¹ˆå…¨éƒ¨æ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ¨ä¸æ‰§è¡Œ
âŒ ä¸€è‡´æ€§ï¼šä¸æ”¯æŒå›æ»šï¼Œå¤±è´¥å‘½ä»¤ä¼šè·³è¿‡
âŒ éš”ç¦»æ€§ï¼šæœ‰é™çš„éš”ç¦»æ”¯æŒ
âŒ æŒä¹…æ€§ï¼šä¾èµ–Redisçš„æŒä¹…åŒ–é…ç½®
```

### 9.2 Redisäº‹åŠ¡æ“ä½œå®ç°


**ğŸ”„ Multi/Execäº‹åŠ¡ä½¿ç”¨**
```java
@Service
public class TransactionService {
    
    @Autowired
    private StringRedisTemplate redisTemplate;
    
    // åŸºç¡€äº‹åŠ¡æ“ä½œ
    public void basicTransaction() {
        // å¼€å¯äº‹åŠ¡æ”¯æŒ
        redisTemplate.setEnableTransactionSupport(true);
        
        try {
            // å¼€å§‹äº‹åŠ¡
            redisTemplate.multi();
            
            // æ‰§è¡Œå¤šä¸ªå‘½ä»¤
            redisTemplate.opsForValue().set("account:A", "100");
            redisTemplate.opsForValue().set("account:B", "200");
            redisTemplate.opsForValue().increment("transaction:count");
            
            // æäº¤äº‹åŠ¡
            List<Object> results = redisTemplate.exec();
            log.info("äº‹åŠ¡æ‰§è¡Œç»“æœ: {}", results);
            
        } catch (Exception e) {
            // å‘ç”Ÿå¼‚å¸¸æ—¶ä¸¢å¼ƒäº‹åŠ¡
            redisTemplate.discard();
            log.error("äº‹åŠ¡æ‰§è¡Œå¤±è´¥", e);
        }
    }
    
    // å¸¦Watchçš„äº‹åŠ¡ï¼ˆä¹è§‚é”ï¼‰
    public boolean transferMoney(String fromAccount, String toAccount, int amount) {
        String fromKey = "account:" + fromAccount;
        String toKey = "account:" + toAccount;
        
        return redisTemplate.execute(new SessionCallback<Boolean>() {
            @Override
            public Boolean execute(RedisOperations operations) throws DataAccessException {
                // ç›‘æ§è´¦æˆ·ä½™é¢å˜åŒ–
                operations.watch(fromKey);
                
                // æ£€æŸ¥ä½™é¢æ˜¯å¦å……è¶³
                String balanceStr = (String) operations.opsForValue().get(fromKey);
                int balance = Integer.parseInt(balanceStr);
                
                if (balance < amount) {
                    operations.unwatch();
                    return false; // ä½™é¢ä¸è¶³
                }
                
                // å¼€å§‹äº‹åŠ¡
                operations.multi();
                
                // è½¬è´¦æ“ä½œ
                operations.opsForValue().decrement(fromKey, amount);
                operations.opsForValue().increment(toKey, amount);
                
                // æ‰§è¡Œäº‹åŠ¡
                List<Object> results = operations.exec();
                
                // å¦‚æœç»“æœä¸ºnullï¼Œè¯´æ˜watchçš„keyè¢«ä¿®æ”¹äº†ï¼Œäº‹åŠ¡å¤±è´¥
                return results != null;
            }
        });
    }
}
```

### 9.3 åˆ†å¸ƒå¼åœºæ™¯ä¸‹çš„ä¸€è‡´æ€§å¤„ç†


**ğŸŒ åˆ†å¸ƒå¼ä¸€è‡´æ€§ç­–ç•¥**
```java
@Service
public class DistributedConsistencyService {
    
    @Autowired
    private StringRedisTemplate redisTemplate;
    
    // ä½¿ç”¨åˆ†å¸ƒå¼é”ä¿è¯ä¸€è‡´æ€§
    public void updateUserProfile(Long userId, UserProfile profile) {
        String lockKey = "lock:user:" + userId;
        String lockValue = UUID.randomUUID().toString();
        
        try {
            // è·å–åˆ†å¸ƒå¼é”
            Boolean locked = redisTemplate.opsForValue()
                    .setIfAbsent(lockKey, lockValue, Duration.ofSeconds(10));
            
            if (!locked) {
                throw new RuntimeException("è·å–é”å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
            }
            
            // åœ¨é”ä¿æŠ¤ä¸‹æ‰§è¡Œä¸šåŠ¡æ“ä½œ
            String userKey = "user:profile:" + userId;
            
            Map<String, String> updates = new HashMap<>();
            updates.put("name", profile.getName());
            updates.put("email", profile.getEmail());
            updates.put("updateTime", String.valueOf(System.currentTimeMillis()));
            
            redisTemplate.opsForHash().putAll(userKey, updates);
            
        } finally {
            // é‡Šæ”¾é”ï¼ˆä½¿ç”¨Luaè„šæœ¬ä¿è¯åŸå­æ€§ï¼‰
            String luaScript = """
                if redis.call('get', KEYS[1]) == ARGV[1] then
                    return redis.call('del', KEYS[1])
                else
                    return 0
                end
                """;
            
            redisTemplate.execute(new DefaultRedisScript<>(luaScript, Long.class),
                    Collections.singletonList(lockKey), lockValue);
        }
    }
}
```

---

## 10. ğŸŒ é›†ç¾¤æ“ä½œä¸åˆ†ç‰‡ç­–ç•¥


### 10.1 Redisé›†ç¾¤æ¶æ„ç†è§£


**ğŸ”¸ é›†ç¾¤æ¨¡å¼çš„ä¼˜åŠ¿**
```
å•å®ä¾‹Redisçš„é™åˆ¶ï¼š
- å†…å­˜é™åˆ¶ï¼šå•æœºå†…å­˜æœ‰ä¸Šé™
- æ€§èƒ½ç“¶é¢ˆï¼šå•çº¿ç¨‹å¤„ç†è¯·æ±‚
- å¯ç”¨æ€§é£é™©ï¼šå•ç‚¹æ•…éšœå½±å“å…¨éƒ¨æœåŠ¡

Redisé›†ç¾¤è§£å†³æ–¹æ¡ˆï¼š
âœ… æ°´å¹³æ‰©å±•ï¼šæ•°æ®åˆ†æ•£åˆ°å¤šä¸ªèŠ‚ç‚¹
âœ… é«˜å¯ç”¨ï¼šä¸»ä»å¤åˆ¶ï¼Œè‡ªåŠ¨æ•…éšœè½¬ç§»
âœ… è´Ÿè½½åˆ†æ‹…ï¼šå¤šä¸ªèŠ‚ç‚¹åˆ†æ‹…è¯·æ±‚å‹åŠ›
âœ… æ•°æ®åˆ†ç‰‡ï¼šæ ¹æ®keyè‡ªåŠ¨åˆ†ç‰‡å­˜å‚¨
```

### 10.2 é›†ç¾¤é…ç½®ä¸è¿æ¥


**âš™ï¸ Spring Booté›†ç¾¤é…ç½®**
```yaml
spring:
  redis:
    cluster:
      nodes:
        - 192.168.1.10:7000
        - 192.168.1.10:7001
        - 192.168.1.11:7000
        - 192.168.1.11:7001
        - 192.168.1.12:7000
        - 192.168.1.12:7001
      max-redirects: 3        # æœ€å¤§é‡å®šå‘æ¬¡æ•°
    jedis:
      pool:
        max-active: 100       # é›†ç¾¤ç¯å¢ƒä¸‹é€‚å½“å¢åŠ è¿æ¥æ•°
        max-idle: 50
        min-idle: 10
    timeout: 5000
```

**ğŸ”§ é›†ç¾¤RedisTemplateé…ç½®**
```java
@Configuration
public class RedisClusterConfig {
    
    @Bean
    public RedisTemplate<String, Object> clusterRedisTemplate(
            RedisConnectionFactory connectionFactory) {
        
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(connectionFactory);
        
        // é›†ç¾¤ç¯å¢ƒä¸‹çš„åºåˆ—åŒ–é…ç½®
        template.setKeySerializer(RedisSerializer.string());
        template.setValueSerializer(new GenericJackson2JsonRedisSerializer());
        template.setHashKeySerializer(RedisSerializer.string());
        template.setHashValueSerializer(new GenericJackson2JsonRedisSerializer());
        
        return template;
    }
}
```

### 10.3 åˆ†ç‰‡é”®è®¾è®¡ç­–ç•¥


**ğŸ—ï¸ åˆç†çš„åˆ†ç‰‡é”®è®¾è®¡**
```java
@Service
public class ShardingKeyService {
    
    // ç”¨æˆ·ç›¸å…³æ•°æ®åˆ†ç‰‡ç­–ç•¥
    public String getUserShardingKey(Long userId) {
        // å°†åŒä¸€ç”¨æˆ·çš„æ‰€æœ‰æ•°æ®åˆ†åˆ°åŒä¸€ä¸ªslot
        return "user:" + userId;
    }
    
    // è®¢å•ç›¸å…³æ•°æ®åˆ†ç‰‡ç­–ç•¥
    public String getOrderShardingKey(String orderId) {
        // æå–ç”¨æˆ·IDä½œä¸ºåˆ†ç‰‡ä¾æ®ï¼Œä¿è¯ç”¨æˆ·æ•°æ®èšé›†æ€§
        String userId = extractUserIdFromOrder(orderId);
        return "user:" + userId + ":order:" + orderId;
    }
    
    // Hash TagæŠ€æœ¯ï¼šå¼ºåˆ¶ç›¸å…³æ•°æ®åœ¨åŒä¸€èŠ‚ç‚¹
    public void storeUserRelatedData(Long userId, UserData userData) {
        String hashTag = "{user:" + userId + "}";
        
        // ä½¿ç”¨ç›¸åŒçš„Hash Tagï¼Œç¡®ä¿è¿™äº›keyåœ¨åŒä¸€ä¸ªslot
        redisTemplate.opsForValue().set(hashTag + ":profile", userData.getProfile());
        redisTemplate.opsForValue().set(hashTag + ":settings", userData.getSettings());
        redisTemplate.opsForList().leftPushAll(hashTag + ":orders", userData.getOrderIds());
    }
    
    private String extractUserIdFromOrder(String orderId) {
        // ä»è®¢å•IDä¸­æå–ç”¨æˆ·IDçš„é€»è¾‘
        return orderId.substring(0, orderId.indexOf("_"));
    }
}
```

### 10.4 é›†ç¾¤æ“ä½œæ³¨æ„äº‹é¡¹


**âš ï¸ é›†ç¾¤ç¯å¢ƒä¸‹çš„é™åˆ¶**
```
æ“ä½œé™åˆ¶ï¼š
âŒ ä¸æ”¯æŒå¤škeyæ“ä½œï¼ˆé™¤ékeyåœ¨åŒä¸€slotï¼‰
âŒ äº‹åŠ¡æ“ä½œå—é™ï¼ˆåªèƒ½æ“ä½œåŒä¸€slotçš„keyï¼‰
âŒ Luaè„šæœ¬ä¸­çš„keyå¿…é¡»åœ¨åŒä¸€slot

è®¾è®¡å»ºè®®ï¼š
âœ… åˆç†è®¾è®¡keyçš„å‘½åè§„åˆ™
âœ… ç›¸å…³æ•°æ®ä½¿ç”¨Hash Tagèšé›†
âœ… é¿å…è·¨slotçš„æ‰¹é‡æ“ä½œ
âœ… ç›‘æ§å„èŠ‚ç‚¹çš„è´Ÿè½½å‡è¡¡æƒ…å†µ
```

---

## 11. ğŸ“Š ç›‘æ§é›†æˆä¸è¿ç»´å®è·µ


### 11.1 å…³é”®ç›‘æ§æŒ‡æ ‡


**ğŸ“ˆ Redisæ€§èƒ½ç›‘æ§æŒ‡æ ‡**

| æŒ‡æ ‡ç±»å‹ | **å…³é”®æŒ‡æ ‡** | **æ­£å¸¸èŒƒå›´** | **å‘Šè­¦é˜ˆå€¼** |
|---------|-------------|-------------|-------------|
| **è¿æ¥** | `å½“å‰è¿æ¥æ•°` | `< max-activeçš„70%` | `> max-activeçš„80%` |
| **å†…å­˜** | `å†…å­˜ä½¿ç”¨ç‡` | `< 80%` | `> 90%` |
| **æ€§èƒ½** | `å‘½ä»¤æ‰§è¡Œæ—¶é—´` | `< 1ms` | `> 10ms` |
| **ç½‘ç»œ** | `ç½‘ç»œIO` | `æ ¹æ®ä¸šåŠ¡è¯„ä¼°` | `æŒç»­é«˜ä½` |

### 11.2 Spring Boot Actuatoré›†æˆ


**ğŸ” å¥åº·æ£€æŸ¥å’Œç›‘æ§é…ç½®**
```yaml
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,redis
  endpoint:
    health:
      show-details: always
  metrics:
    export:
      prometheus:
        enabled: true
```

**ğŸ“Š è‡ªå®šä¹‰ç›‘æ§æŒ‡æ ‡**
```java
@Component
public class RedisMetricsCollector {
    
    private final MeterRegistry meterRegistry;
    private final StringRedisTemplate redisTemplate;
    private final Counter redisOperationCounter;
    private final Timer redisOperationTimer;
    
    public RedisMetricsCollector(MeterRegistry meterRegistry, 
                                StringRedisTemplate redisTemplate) {
        this.meterRegistry = meterRegistry;
        this.redisTemplate = redisTemplate;
        
        // åˆ›å»ºè‡ªå®šä¹‰ç›‘æ§æŒ‡æ ‡
        this.redisOperationCounter = Counter.builder("redis.operations")
                .description("Redisæ“ä½œè®¡æ•°")
                .register(meterRegistry);
                
        this.redisOperationTimer = Timer.builder("redis.operation.duration")
                .description("Redisæ“ä½œè€—æ—¶")
                .register(meterRegistry);
    }
    
    // ç›‘æ§Redisæ“ä½œ
    public <T> T monitoredOperation(String operation, Supplier<T> redisOperation) {
        return Timer.Sample.start(meterRegistry)
                .stop(redisOperationTimer.tag("operation", operation))
                .recordCallable(() -> {
                    redisOperationCounter.increment(Tags.of("operation", operation));
                    return redisOperation.get();
                });
    }
}
```

### 11.3 Redisè¿æ¥æ± ç›‘æ§


**ğŸ” è¿æ¥æ± çŠ¶æ€ç›‘æ§**
```java
@Component
public class RedisPoolHealthIndicator implements HealthIndicator {
    
    @Autowired
    private RedisConnectionFactory connectionFactory;
    
    @Override
    public Health health() {
        try {
            RedisConnection connection = connectionFactory.getConnection();
            
            if (connection instanceof JedisClusterConnection) {
                // é›†ç¾¤è¿æ¥å¥åº·æ£€æŸ¥
                return checkClusterHealth((JedisClusterConnection) connection);
            } else {
                // å•æœºè¿æ¥å¥åº·æ£€æŸ¥
                return checkSingleNodeHealth(connection);
            }
            
        } catch (Exception e) {
            return Health.down()
                    .withDetail("error", e.getMessage())
                    .build();
        }
    }
    
    private Health checkClusterHealth(JedisClusterConnection clusterConnection) {
        try {
            // æ‰§è¡Œç®€å•çš„pingå‘½ä»¤æ£€æŸ¥è¿é€šæ€§
            String pong = clusterConnection.ping();
            
            return Health.up()
                    .withDetail("type", "cluster")
                    .withDetail("ping", pong)
                    .withDetail("timestamp", System.currentTimeMillis())
                    .build();
                    
        } catch (Exception e) {
            return Health.down()
                    .withDetail("type", "cluster")
                    .withDetail("error", e.getMessage())
                    .build();
        }
    }
    
    private Health checkSingleNodeHealth(RedisConnection connection) {
        // å•æœºç‰ˆå¥åº·æ£€æŸ¥é€»è¾‘
        try {
            String pong = connection.ping();
            return Health.up()
                    .withDetail("type", "single")
                    .withDetail("ping", pong)
                    .build();
        } catch (Exception e) {
            return Health.down()
                    .withDetail("type", "single") 
                    .withDetail("error", e.getMessage())
                    .build();
        }
    }
}
```

### 11.4 å‘Šè­¦å’Œè¿ç»´è‡ªåŠ¨åŒ–


**ğŸš¨ å…³é”®å‘Šè­¦è§„åˆ™**
```java
@Component
public class RedisAlertService {
    
    private static final Logger log = LoggerFactory.getLogger(RedisAlertService.class);
    
    // è¿æ¥æ•°å‘Šè­¦
    @EventListener
    public void handleHighConnectionAlert(RedisConnectionEvent event) {
        if (event.getActiveConnections() > event.getMaxConnections() * 0.8) {
            sendAlert("Redisè¿æ¥æ•°è¿‡é«˜", 
                    String.format("å½“å‰è¿æ¥æ•°: %d, æœ€å¤§è¿æ¥æ•°: %d", 
                            event.getActiveConnections(), event.getMaxConnections()));
        }
    }
    
    // å†…å­˜ä½¿ç”¨å‘Šè­¦
    @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    public void checkMemoryUsage() {
        try {
            // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…é¡¹ç›®ä¸­åº”è¯¥é€šè¿‡Redis INFOå‘½ä»¤è·å–å†…å­˜ä¿¡æ¯
            long usedMemory = getRedisUsedMemory();
            long maxMemory = getRedisMaxMemory();
            
            double usageRatio = (double) usedMemory / maxMemory;
            
            if (usageRatio > 0.9) {
                sendAlert("Rediså†…å­˜ä½¿ç”¨ç‡è¿‡é«˜", 
                        String.format("å†…å­˜ä½¿ç”¨ç‡: %.2f%%", usageRatio * 100));
            }
        } catch (Exception e) {
            log.error("æ£€æŸ¥Rediså†…å­˜ä½¿ç”¨ç‡å¤±è´¥", e);
        }
    }
    
    private void sendAlert(String title, String message) {
        // å‘é€å‘Šè­¦é€šçŸ¥ï¼ˆé’‰é’‰ã€é‚®ä»¶ã€çŸ­ä¿¡ç­‰ï¼‰
        log.error("Rediså‘Šè­¦ - {}: {}", title, message);
        // å®é™…é¡¹ç›®ä¸­é›†æˆå…·ä½“çš„å‘Šè­¦é€šé“
    }
    
    private long getRedisUsedMemory() {
        // è·å–Rediså·²ä½¿ç”¨å†…å­˜
        return 0L; // ç®€åŒ–å¤„ç†
    }
    
    private long getRedisMaxMemory() {
        // è·å–Redisæœ€å¤§å†…å­˜é™åˆ¶
        return Long.MAX_VALUE; // ç®€åŒ–å¤„ç†
    }
}
```

---

## 12. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 12.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ”¸ RedisTemplateæœ¬è´¨ï¼šJavaåº”ç”¨ä¸Redisä¹‹é—´çš„æ¡¥æ¢
ğŸ”¸ åºåˆ—åŒ–é‡è¦æ€§ï¼šå†³å®šæ•°æ®å­˜å‚¨æ ¼å¼å’Œè·¨è¯­è¨€å…¼å®¹æ€§
ğŸ”¸ è¿æ¥æ± ä½œç”¨ï¼šç®¡ç†Redisè¿æ¥ï¼Œæå‡æ€§èƒ½å’Œç¨³å®šæ€§
ğŸ”¸ å¼‚å¸¸å¤„ç†ç­–ç•¥ï¼šä¿è¯æœåŠ¡å¯ç”¨æ€§çš„é‡è¦æ‰‹æ®µ
ğŸ”¸ æ‰¹é‡æ“ä½œä»·å€¼ï¼šå¤§å¹…æå‡ç½‘ç»œé€šä¿¡æ•ˆç‡
```

### 12.2 å…³é”®æŠ€æœ¯é€‰æ‹©æŒ‡å—


**ğŸ”¹ StringRedisTemplate vs RedisTemplate**
```
é€‰æ‹©StringRedisTemplateå¦‚æœï¼š
âœ… ä¸»è¦å­˜å‚¨å­—ç¬¦ä¸²ç±»å‹æ•°æ®
âœ… éœ€è¦åœ¨Rediså®¢æˆ·ç«¯ç›´æ¥æŸ¥çœ‹æ•°æ®
âœ… ä¸å…¶ä»–è¯­è¨€åº”ç”¨å…±äº«ç¼“å­˜
âœ… è¿½æ±‚æœ€ä½³æ€§èƒ½è¡¨ç°

é€‰æ‹©RedisTemplateå¦‚æœï¼š
âœ… éœ€è¦ç¼“å­˜å¤æ‚Javaå¯¹è±¡
âœ… çº¯Javaåº”ç”¨å†…éƒ¨ä½¿ç”¨
âœ… å¸Œæœ›ä¿æŒå¯¹è±¡ç»“æ„å®Œæ•´æ€§
```

**ğŸ”¹ æ‰¹é‡æ“ä½œ vs Pipelineé€‰æ‹©**
```
ä½¿ç”¨æ‰¹é‡æ“ä½œï¼ˆmultiGet/multiSetï¼‰ï¼š
âœ… åŒç±»å‹æ“ä½œï¼Œä½¿ç”¨ç®€å•
âœ… éœ€è¦åŸå­æ€§ä¿è¯
âœ… æ“ä½œæ•°é‡é€‚ä¸­ï¼ˆ< 1000ä¸ªï¼‰

ä½¿ç”¨Pipelineï¼š
âœ… å¤šç§ä¸åŒRediså‘½ä»¤ç»„åˆ
âœ… ä¸è¦æ±‚åŸå­æ€§
âœ… è¿½æ±‚ç½‘ç»œæ€§èƒ½æœ€ä¼˜åŒ–
```

### 12.3 ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ


**ğŸ’¡ é…ç½®è°ƒä¼˜å»ºè®®**
```
è¿æ¥æ± é…ç½®ï¼š
- æ ¹æ®QPSåˆç†è®¾ç½®max-active
- ä¿æŒé€‚å½“çš„ç©ºé—²è¿æ¥æ•°
- è®¾ç½®åˆç†çš„è¿æ¥è¶…æ—¶æ—¶é—´

å¼‚å¸¸å¤„ç†ï¼š
- å»ºç«‹åˆ†çº§å¼‚å¸¸å¤„ç†æœºåˆ¶
- å®ç°é™çº§å’Œé‡è¯•ç­–ç•¥
- å®Œå–„ç›‘æ§å’Œå‘Šè­¦ä½“ç³»

æ€§èƒ½ä¼˜åŒ–ï¼š
- åˆç†ä½¿ç”¨æ‰¹é‡æ“ä½œå’ŒPipeline
- ä¼˜åŒ–keyè®¾è®¡å’Œæ•°æ®ç»“æ„é€‰æ‹©
- å®šæœŸæ¸…ç†è¿‡æœŸå’Œæ— ç”¨æ•°æ®
```

### 12.4 å¸¸è§é—®é¢˜å¿«é€Ÿè§£å†³


```
é—®é¢˜æ’æŸ¥æ¸…å•ï¼š

è¿æ¥é—®é¢˜ï¼š
â–¡ æ£€æŸ¥RedisæœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ
â–¡ éªŒè¯ç½‘ç»œè¿é€šæ€§å’Œé˜²ç«å¢™è®¾ç½®
â–¡ ç¡®è®¤è¿æ¥æ± é…ç½®æ˜¯å¦åˆç†

æ€§èƒ½é—®é¢˜ï¼š
â–¡ ç›‘æ§Rediså“åº”æ—¶é—´å’ŒQPS
â–¡ æ£€æŸ¥æ˜¯å¦æœ‰æ…¢æŸ¥è¯¢
â–¡ è¯„ä¼°æ˜¯å¦éœ€è¦ä½¿ç”¨æ‰¹é‡æ“ä½œ

æ•°æ®é—®é¢˜ï¼š
â–¡ ç¡®è®¤åºåˆ—åŒ–é…ç½®æ˜¯å¦æ­£ç¡®
â–¡ æ£€æŸ¥keyå‘½åè§„åˆ™å’Œè¿‡æœŸæ—¶é—´è®¾ç½®
â–¡ éªŒè¯æ•°æ®ç±»å‹æ“ä½œæ˜¯å¦åŒ¹é…
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- RedisTemplateæ˜¯Springæ“ä½œRedisçš„æ ¸å¿ƒå·¥å…·
- åˆç†çš„é…ç½®æ˜¯ç¨³å®šè¿è¡Œçš„åŸºç¡€
- å¼‚å¸¸å¤„ç†å’Œç›‘æ§æ˜¯ç”Ÿäº§ç¯å¢ƒå¿…éœ€
- æ‰¹é‡æ“ä½œå’ŒPipelineèƒ½æ˜¾è‘—æå‡æ€§èƒ½
- é›†ç¾¤ç¯å¢ƒéœ€è¦ç‰¹åˆ«å…³æ³¨åˆ†ç‰‡é”®è®¾è®¡