---
title: 1ã€Spring Cacheæ³¨è§£ä½¿ç”¨
---
## ğŸ“š ç›®å½•


1. [Spring Cacheæ³¨è§£æ¦‚è¿°](#1-Spring-Cacheæ³¨è§£æ¦‚è¿°)
2. [@Cacheableæ³¨è§£è¯¦è§£](#2-Cacheableæ³¨è§£è¯¦è§£)
3. [@CacheEvictæ¸…é™¤ç¼“å­˜](#3-CacheEvictæ¸…é™¤ç¼“å­˜)
4. [@CachePutæ›´æ–°ç¼“å­˜](#4-CachePutæ›´æ–°ç¼“å­˜)
5. [@Cachingç»„åˆæ³¨è§£](#5-Cachingç»„åˆæ³¨è§£)
6. [ç¼“å­˜é…ç½®ä¸ç®¡ç†](#6-ç¼“å­˜é…ç½®ä¸ç®¡ç†)
7. [é«˜çº§åº”ç”¨æŠ€å·§](#7-é«˜çº§åº”ç”¨æŠ€å·§)
8. [æœ€ä½³å®è·µæŒ‡å—](#8-æœ€ä½³å®è·µæŒ‡å—)

---

## 1. ğŸš€ Spring Cacheæ³¨è§£æ¦‚è¿°



### 1.1 ä»€ä¹ˆæ˜¯Spring Cache



**ç®€å•ç†è§£**ï¼šSpring Cacheå°±åƒæ˜¯ç»™ä½ çš„åº”ç”¨è£…äº†ä¸€ä¸ª"è®°å¿†åº“"ï¼ŒæŠŠç»å¸¸ç”¨åˆ°çš„æ•°æ®æš‚å­˜èµ·æ¥ï¼Œä¸‹æ¬¡éœ€è¦æ—¶ç›´æ¥ä»"è®°å¿†åº“"æ‹¿ï¼Œä¸ç”¨é‡æ–°è®¡ç®—æˆ–æŸ¥æ•°æ®åº“ã€‚

```
æ²¡æœ‰ç¼“å­˜çš„æƒ…å†µï¼š
ç”¨æˆ·è¯·æ±‚ â†’ æŸ¥è¯¢æ•°æ®åº“ â†’ è¿”å›ç»“æœ (è€—æ—¶è¾ƒé•¿)
ç”¨æˆ·è¯·æ±‚ â†’ æŸ¥è¯¢æ•°æ®åº“ â†’ è¿”å›ç»“æœ (æ¯æ¬¡éƒ½è¦æŸ¥)

æœ‰äº†ç¼“å­˜çš„æƒ…å†µï¼š
ç”¨æˆ·è¯·æ±‚ â†’ å…ˆæŸ¥ç¼“å­˜ â†’ æœ‰æ•°æ®ç›´æ¥è¿”å› (è¶…å¿«!)
ç”¨æˆ·è¯·æ±‚ â†’ ç¼“å­˜æ²¡æœ‰ â†’ æŸ¥æ•°æ®åº“ â†’ å­˜å…¥ç¼“å­˜ â†’ è¿”å›ç»“æœ
```

### 1.2 ä¸ºä»€ä¹ˆè¦ç”¨ç¼“å­˜æ³¨è§£



**ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿**
- **æå‡æ€§èƒ½**ï¼šè®¿é—®å†…å­˜æ¯”è®¿é—®æ•°æ®åº“å¿«100-1000å€
- **å‡å°‘å‹åŠ›**ï¼šå‡å°‘æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°ï¼Œé™ä½æœåŠ¡å™¨è´Ÿè½½
- **ç”¨æˆ·ä½“éªŒ**ï¼šé¡µé¢åŠ è½½æ›´å¿«ï¼Œå“åº”æ—¶é—´æ›´çŸ­
- **ç®€å•æ˜“ç”¨**ï¼šåªéœ€è¦å‡ ä¸ªæ³¨è§£ï¼Œä»£ç ä¾µå…¥æ€§æå°

### 1.3 Spring Cacheæ³¨è§£å®¶æ—



| æ³¨è§£åç§° | **æ ¸å¿ƒä½œç”¨** | **ç®€å•ç†è§£** | **ä½¿ç”¨åœºæ™¯** |
|---------|------------|-------------|-------------|
| `@Cacheable` | `æŸ¥è¯¢æ—¶ç¼“å­˜` | `ç¬¬ä¸€æ¬¡æŸ¥æ•°æ®åº“ï¼Œåç»­ç›´æ¥æ‹¿ç¼“å­˜` | `å•†å“è¯¦æƒ…ã€ç”¨æˆ·ä¿¡æ¯` |
| `@CacheEvict` | `åˆ é™¤ç¼“å­˜` | `æ•°æ®å˜äº†ï¼ŒæŠŠæ—§ç¼“å­˜æ¸…æ‰` | `åˆ é™¤å•†å“ã€ä¿®æ”¹ç”¨æˆ·` |
| `@CachePut` | `æ›´æ–°ç¼“å­˜` | `æ¯æ¬¡éƒ½æŸ¥æ•°æ®åº“ï¼Œä½†ä¼šæ›´æ–°ç¼“å­˜` | `å®æ—¶æ•°æ®æ›´æ–°` |
| `@Caching` | `ç»„åˆä½¿ç”¨` | `ä¸€ä¸ªæ–¹æ³•è¦åšå¤šç§ç¼“å­˜æ“ä½œ` | `å¤æ‚çš„ä¸šåŠ¡åœºæ™¯` |

### 1.4 åŸºç¡€ç¯å¢ƒé…ç½®



**Mavenä¾èµ–**
```xml
<!-- Spring Boot Starter Cache -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-cache</artifactId>
</dependency>

<!-- Redisç¼“å­˜å®ç° -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>
```

**å¯ç”¨ç¼“å­˜åŠŸèƒ½**
```java
@SpringBootApplication
@EnableCaching  // å¼€å¯ç¼“å­˜åŠŸèƒ½
public class Application {
    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }
}
```

---

## 2. ğŸ“ @Cacheableæ³¨è§£è¯¦è§£



### 2.1 @CacheableåŸºæœ¬æ¦‚å¿µ



**æ ¸å¿ƒä½œç”¨**ï¼š`@Cacheable`å°±åƒç»™æ–¹æ³•è£…äº†ä¸€ä¸ª"æ™ºèƒ½åŠ©æ‰‹"ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶æ­£å¸¸æ‰§è¡Œå¹¶æŠŠç»“æœè®°ä½ï¼Œä»¥åå†è°ƒç”¨ç›¸åŒå‚æ•°çš„æ–¹æ³•æ—¶ï¼Œç›´æ¥è¿”å›è®°ä½çš„ç»“æœã€‚

```
æ–¹æ³•æ‰§è¡Œæµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è°ƒç”¨æ–¹æ³•       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚æ£€æŸ¥ç¼“å­˜  â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ç¼“å­˜å­˜åœ¨ï¼Ÿ â”‚â”€YESâ†’â”‚ ç›´æ¥è¿”å›ç¼“å­˜  â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ NO
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚æ‰§è¡Œæ–¹æ³•  â”‚â”€â”€â”€â”€â†’ â”‚ å­˜å…¥ç¼“å­˜å¹¶è¿”å› â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 åŸºæœ¬ä½¿ç”¨ç¤ºä¾‹



**ç®€å•ç”¨æ³•**
```java
@Service
public class UserService {
    
    @Cacheable(value = "users")  // ç¼“å­˜åç§°ä¸º"users"
    public User findById(Long userId) {
        System.out.println("ä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·: " + userId);
        // æ¨¡æ‹Ÿæ•°æ®åº“æŸ¥è¯¢
        return userRepository.findById(userId);
    }
}

// è°ƒç”¨æ•ˆæœæ¼”ç¤º:
// ç¬¬1æ¬¡è°ƒç”¨: findById(1) â†’ æ‰“å°æ—¥å¿— â†’ æŸ¥è¯¢æ•°æ®åº“ â†’ è¿”å›ç»“æœ â†’ å­˜å…¥ç¼“å­˜
// ç¬¬2æ¬¡è°ƒç”¨: findById(1) â†’ ä¸æ‰“å°æ—¥å¿— â†’ ç›´æ¥è¿”å›ç¼“å­˜ â†’ è¶…å¿«è¿”å›!
```

### 2.3 æ ¸å¿ƒå‚æ•°è¯¦è§£



#### ğŸ·ï¸ value/cacheNameså‚æ•°



**ä½œç”¨**ï¼šæŒ‡å®šç¼“å­˜çš„åç§°ï¼Œå°±åƒç»™ä¸åŒç±»å‹çš„æ•°æ®åˆ†é…ä¸åŒçš„"å‚¨ç‰©æŸœ"

```java
// å•ä¸ªç¼“å­˜åç§°
@Cacheable(value = "users")
@Cacheable(cacheNames = "users")  // ä¸ä¸Šé¢ç­‰ä»·

// å¤šä¸ªç¼“å­˜åç§°
@Cacheable(value = {"users", "userCache"})
public User findById(Long id) { ... }
```

#### ğŸ”‘ keyå‚æ•°



**ä½œç”¨**ï¼šæŒ‡å®šç¼“å­˜çš„é”®ï¼Œå°±åƒæ¯ä¸ªç¼“å­˜æ•°æ®çš„"é—¨ç‰Œå·"

```java
// ä½¿ç”¨å‚æ•°ä½œä¸ºkey
@Cacheable(value = "users", key = "#id")
public User findById(Long id) { ... }

// ä½¿ç”¨å¤šä¸ªå‚æ•°ç»„åˆ
@Cacheable(value = "orders", key = "#userId + '_' + #status")
public List<Order> findOrders(Long userId, String status) { ... }

// ä½¿ç”¨å¯¹è±¡å±æ€§
@Cacheable(value = "users", key = "#user.email")
public User findByUser(User user) { ... }
```

**ğŸ” ç¼“å­˜é”®çš„ç”Ÿæˆè§„åˆ™**
```
é»˜è®¤æƒ…å†µä¸‹ï¼š
- æ— å‚æ•°æ–¹æ³•ï¼šä½¿ç”¨SimpleKey.EMPTY
- å•ä¸ªå‚æ•°ï¼šç›´æ¥ä½¿ç”¨å‚æ•°å€¼
- å¤šä¸ªå‚æ•°ï¼šä½¿ç”¨SimpleKeyåŒ…è£…æ‰€æœ‰å‚æ•°

å®é™…å­˜å‚¨ç¤ºä¾‹ï¼š
æ–¹æ³•: findById(123L) â†’ ç¼“å­˜key: 123
æ–¹æ³•: findOrders(1L, "PAID") â†’ ç¼“å­˜key: 1_PAID
```

#### âš–ï¸ conditionæ¡ä»¶å‚æ•°



**ä½œç”¨**ï¼šåªæœ‰æ»¡è¶³æ¡ä»¶æ—¶æ‰ä½¿ç”¨ç¼“å­˜

```java
// åªæœ‰idå¤§äº0æ—¶æ‰ç¼“å­˜
@Cacheable(value = "users", condition = "#id > 0")
public User findById(Long id) { ... }

// åªæœ‰VIPç”¨æˆ·æ‰ç¼“å­˜
@Cacheable(value = "orders", condition = "#user.level == 'VIP'")
public List<Order> findUserOrders(User user) { ... }

// åªåœ¨å·¥ä½œæ—¶é—´ç¼“å­˜
@Cacheable(value = "reports", 
          condition = "T(java.time.LocalTime).now().getHour() >= 9 and T(java.time.LocalTime).now().getHour() <= 18")
public Report generateReport() { ... }
```

#### ğŸš« unlesså‚æ•°



**ä½œç”¨**ï¼šç»“æœæ»¡è¶³æ¡ä»¶æ—¶ä¸ç¼“å­˜ï¼ˆä¸conditionç›¸åï¼‰

```java
// ç»“æœä¸ºnullæ—¶ä¸ç¼“å­˜
@Cacheable(value = "users", unless = "#result == null")
public User findById(Long id) { ... }

// ç©ºåˆ—è¡¨ä¸ç¼“å­˜
@Cacheable(value = "products", unless = "#result.isEmpty()")
public List<Product> findProducts(String category) { ... }

// é”™è¯¯ç»“æœä¸ç¼“å­˜
@Cacheable(value = "data", unless = "#result.status == 'ERROR'")
public ApiResponse fetchData(String param) { ... }
```

### 2.4 SpELè¡¨è¾¾å¼è¯¦è§£



**Spring Expression Languageï¼ˆSpELï¼‰**æ˜¯Spring Cacheæ³¨è§£ä¸­ç”¨æ¥åŠ¨æ€æŒ‡å®šå‚æ•°çš„è¡¨è¾¾å¼è¯­è¨€ã€‚

#### ğŸ“‹ å¸¸ç”¨SpELè¡¨è¾¾å¼



| è¡¨è¾¾å¼ç±»å‹ | **è¯­æ³•ç¤ºä¾‹** | **å«ä¹‰è¯´æ˜** |
|-----------|-------------|-------------|
| **å‚æ•°å¼•ç”¨** | `#id`, `#user.name` | å¼•ç”¨æ–¹æ³•å‚æ•° |
| **æ–¹æ³•ç»“æœ** | `#result`, `#result.size()` | å¼•ç”¨æ–¹æ³•è¿”å›å€¼ |
| **é™æ€æ–¹æ³•** | `T(Math).random()` | è°ƒç”¨é™æ€æ–¹æ³• |
| **å­—ç¬¦ä¸²æ“ä½œ** | `#name.toUpperCase()` | å­—ç¬¦ä¸²æ–¹æ³•è°ƒç”¨ |
| **æ¡ä»¶åˆ¤æ–­** | `#id > 0 ? 'valid' : 'invalid'` | ä¸‰å…ƒè¿ç®—ç¬¦ |

#### ğŸ’¡ å®é™…åº”ç”¨ç¤ºä¾‹



```java
@Service
public class ProductService {
    
    // åŸºç¡€ç”¨æ³•ï¼šå‚æ•°ä½œä¸ºkey
    @Cacheable(value = "products", key = "#productId")
    public Product findById(Long productId) { ... }
    
    // å¤æ‚keyï¼šå¤šå‚æ•°ç»„åˆ
    @Cacheable(value = "products", 
               key = "#category + '_' + #priceRange + '_' + #page")
    public List<Product> findProducts(String category, String priceRange, int page) { ... }
    
    // æ¡ä»¶ç¼“å­˜ï¼šåªç¼“å­˜æœ‰æ•ˆæ•°æ®
    @Cacheable(value = "products", 
               key = "#id",
               condition = "#id > 0",
               unless = "#result == null or #result.status == 'DELETED'")
    public Product findValidProduct(Long id) { ... }
}
```

---

## 3. ğŸ—‘ï¸ @CacheEvictæ¸…é™¤ç¼“å­˜



### 3.1 åŸºæœ¬æ¦‚å¿µ



**æ ¸å¿ƒä½œç”¨**ï¼š`@CacheEvict`å°±åƒç¼“å­˜çš„"æ¸…æ´å·¥"ï¼Œå½“æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼ŒæŠŠæ—§çš„ç¼“å­˜æ•°æ®æ¸…é™¤æ‰ï¼Œç¡®ä¿ä¸‹æ¬¡æŸ¥è¯¢æ—¶èƒ½è·å–åˆ°æœ€æ–°æ•°æ®ã€‚

**ä¸ºä»€ä¹ˆéœ€è¦æ¸…é™¤ç¼“å­˜ï¼Ÿ**
```
é—®é¢˜åœºæ™¯ï¼š
1. ç”¨æˆ·ä¿®æ”¹äº†ä¸ªäººä¿¡æ¯
2. ç¼“å­˜ä¸­è¿˜ä¿å­˜ç€æ—§ä¿¡æ¯
3. å…¶ä»–åœ°æ–¹æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯æ—¶è¿”å›çš„è¿˜æ˜¯æ—§æ•°æ®
4. é€ æˆæ•°æ®ä¸ä¸€è‡´é—®é¢˜

è§£å†³æ–¹æ¡ˆï¼š
ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯ â†’ @CacheEvictæ¸…é™¤æ—§ç¼“å­˜ â†’ ä¸‹æ¬¡æŸ¥è¯¢é‡æ–°ä»æ•°æ®åº“è·å–
```

### 3.2 åŸºæœ¬ä½¿ç”¨æ–¹å¼



```java
@Service
public class UserService {
    
    // æŸ¥è¯¢æ—¶ç¼“å­˜
    @Cacheable(value = "users", key = "#id")
    public User findById(Long id) {
        return userRepository.findById(id);
    }
    
    // æ›´æ–°æ—¶æ¸…é™¤ç¼“å­˜
    @CacheEvict(value = "users", key = "#user.id")
    public User updateUser(User user) {
        return userRepository.save(user);
    }
    
    // åˆ é™¤æ—¶æ¸…é™¤ç¼“å­˜
    @CacheEvict(value = "users", key = "#id")
    public void deleteUser(Long id) {
        userRepository.deleteById(id);
    }
}
```

### 3.3 æ ¸å¿ƒå‚æ•°è¯¦è§£



#### ğŸ§¹ allEntrieså‚æ•°



**ä½œç”¨**ï¼šæ¸…é™¤æŒ‡å®šç¼“å­˜ä¸­çš„æ‰€æœ‰æ•°æ®

```java
@Service
public class ProductService {
    
    @Cacheable(value = "products", key = "#id")
    public Product findById(Long id) { ... }
    
    // æ¸…é™¤æŒ‡å®šäº§å“çš„ç¼“å­˜
    @CacheEvict(value = "products", key = "#product.id")
    public Product updateProduct(Product product) { ... }
    
    // æ¸…é™¤æ‰€æœ‰äº§å“ç¼“å­˜ï¼ˆæ¯”å¦‚æ‰¹é‡å¯¼å…¥æ–°äº§å“åï¼‰
    @CacheEvict(value = "products", allEntries = true)
    public void importProducts(List<Product> products) { ... }
}
```

**ä½¿ç”¨åœºæ™¯å¯¹æ¯”**
```
ç²¾ç¡®æ¸…é™¤ vs å…¨éƒ¨æ¸…é™¤ï¼š

ç²¾ç¡®æ¸…é™¤ï¼ˆæ¨èï¼‰ï¼š
- åªæ¸…é™¤ç‰¹å®škeyçš„ç¼“å­˜
- æ€§èƒ½å½±å“å°
- å…¶ä»–ç¼“å­˜æ•°æ®ä¸å—å½±å“

å…¨éƒ¨æ¸…é™¤ï¼š
- æ¸…ç©ºæ•´ä¸ªç¼“å­˜åŒºåŸŸ
- é€‚ç”¨äºæ‰¹é‡æ“ä½œ
- ä¼šå½±å“æ‰€æœ‰ç›¸å…³ç¼“å­˜
```

#### â° beforeInvocationå‚æ•°



**ä½œç”¨**ï¼šæ§åˆ¶ç¼“å­˜æ¸…é™¤çš„æ—¶æœº

```java
// é»˜è®¤ï¼šæ–¹æ³•æ‰§è¡ŒæˆåŠŸåæ¸…é™¤ç¼“å­˜
@CacheEvict(value = "users", key = "#id")
public void updateUser(Long id) {
    // å¦‚æœè¿™é‡ŒæŠ›å¼‚å¸¸ï¼Œç¼“å­˜ä¸ä¼šè¢«æ¸…é™¤
    userRepository.updateUser(id);
}

// æ–¹æ³•æ‰§è¡Œå‰å°±æ¸…é™¤ç¼“å­˜
@CacheEvict(value = "users", key = "#id", beforeInvocation = true)
public void updateUser(Long id) {
    // æ— è®ºæ–¹æ³•æ˜¯å¦æˆåŠŸï¼Œç¼“å­˜éƒ½ä¼šè¢«æ¸…é™¤
    userRepository.updateUser(id);
}
```

**ä¸¤ç§æ¨¡å¼å¯¹æ¯”**
```
beforeInvocation = falseï¼ˆé»˜è®¤ï¼‰ï¼š
æ–¹æ³•æ‰§è¡Œ â†’ æ‰§è¡ŒæˆåŠŸ â†’ æ¸…é™¤ç¼“å­˜
æ–¹æ³•æ‰§è¡Œ â†’ æ‰§è¡Œå¤±è´¥ â†’ ä¸æ¸…é™¤ç¼“å­˜ï¼ˆä¿æŒæ•°æ®ä¸€è‡´æ€§ï¼‰

beforeInvocation = trueï¼š
æ¸…é™¤ç¼“å­˜ â†’ æ–¹æ³•æ‰§è¡Œ â†’ æ— è®ºæˆè´¥ï¼Œç¼“å­˜éƒ½å·²æ¸…é™¤
é€‚ç”¨åœºæ™¯ï¼šæ–¹æ³•æ‰§è¡Œæ—¶é—´é•¿ï¼Œå¸Œæœ›ç«‹å³é‡Šæ”¾ç¼“å­˜ç©ºé—´
```

### 3.4 å®é™…åº”ç”¨ç¤ºä¾‹



```java
@Service
public class OrderService {
    
    @Cacheable(value = "orders", key = "#orderId")
    public Order findById(Long orderId) { ... }
    
    @Cacheable(value = "userOrders", key = "#userId")
    public List<Order> findByUserId(Long userId) { ... }
    
    // æ›´æ–°è®¢å•çŠ¶æ€ï¼šéœ€è¦æ¸…é™¤å•ä¸ªè®¢å•ç¼“å­˜
    @CacheEvict(value = "orders", key = "#orderId")
    public Order updateOrderStatus(Long orderId, String status) {
        Order order = orderRepository.findById(orderId);
        order.setStatus(status);
        return orderRepository.save(order);
    }
    
    // ç”¨æˆ·ä¸‹æ–°è®¢å•ï¼šéœ€è¦æ¸…é™¤ç”¨æˆ·è®¢å•åˆ—è¡¨ç¼“å­˜
    @CacheEvict(value = "userOrders", key = "#order.userId")
    public Order createOrder(Order order) {
        return orderRepository.save(order);
    }
    
    // ç³»ç»Ÿç»´æŠ¤ï¼šæ¸…é™¤æ‰€æœ‰è®¢å•ç¼“å­˜
    @CacheEvict(value = {"orders", "userOrders"}, allEntries = true)
    public void systemMaintenance() {
        // æ‰§è¡Œç³»ç»Ÿç»´æŠ¤æ“ä½œ
    }
}
```

---

## 4. ğŸ”„ @CachePutæ›´æ–°ç¼“å­˜



### 4.1 åŸºæœ¬æ¦‚å¿µ



**æ ¸å¿ƒä½œç”¨**ï¼š`@CachePut`åƒæ˜¯ä¸€ä¸ª"å‹¤åŠ³çš„è®°å½•å‘˜"ï¼Œæ¯æ¬¡éƒ½ä¼šæ‰§è¡Œæ–¹æ³•ï¼Œä½†åŒæ—¶ä¼šæŠŠæœ€æ–°çš„ç»“æœæ›´æ–°åˆ°ç¼“å­˜ä¸­ã€‚

**@CachePut vs @Cacheable å¯¹æ¯”**
```
@Cacheableçš„è¡Œä¸ºï¼š
ç¬¬1æ¬¡è°ƒç”¨ â†’ æ‰§è¡Œæ–¹æ³• â†’ å­˜å…¥ç¼“å­˜ â†’ è¿”å›ç»“æœ
ç¬¬2æ¬¡è°ƒç”¨ â†’ è·³è¿‡æ–¹æ³• â†’ ç›´æ¥è¿”å›ç¼“å­˜
ç¬¬3æ¬¡è°ƒç”¨ â†’ è·³è¿‡æ–¹æ³• â†’ ç›´æ¥è¿”å›ç¼“å­˜

@CachePutçš„è¡Œä¸ºï¼š
ç¬¬1æ¬¡è°ƒç”¨ â†’ æ‰§è¡Œæ–¹æ³• â†’ å­˜å…¥ç¼“å­˜ â†’ è¿”å›ç»“æœ
ç¬¬2æ¬¡è°ƒç”¨ â†’ æ‰§è¡Œæ–¹æ³• â†’ æ›´æ–°ç¼“å­˜ â†’ è¿”å›ç»“æœ
ç¬¬3æ¬¡è°ƒç”¨ â†’ æ‰§è¡Œæ–¹æ³• â†’ æ›´æ–°ç¼“å­˜ â†’ è¿”å›ç»“æœ
```

### 4.2 å…¸å‹ä½¿ç”¨åœºæ™¯



#### ğŸ“Š å®æ—¶æ•°æ®æ›´æ–°



```java
@Service
public class StockService {
    
    // æŸ¥è¯¢åº“å­˜ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰
    @Cacheable(value = "stocks", key = "#productId")
    public Stock getStock(Long productId) {
        return stockRepository.findByProductId(productId);
    }
    
    // æ›´æ–°åº“å­˜ï¼ˆæ¯æ¬¡éƒ½æ‰§è¡Œï¼ŒåŒæ—¶æ›´æ–°ç¼“å­˜ï¼‰
    @CachePut(value = "stocks", key = "#productId")
    public Stock updateStock(Long productId, Integer quantity) {
        Stock stock = stockRepository.findByProductId(productId);
        stock.setQuantity(quantity);
        stock.setUpdateTime(LocalDateTime.now());
        return stockRepository.save(stock);
    }
}
```

#### ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯åŒæ­¥



```java
@Service
public class UserService {
    
    @Cacheable(value = "users", key = "#id")
    public User findById(Long id) { ... }
    
    // æ›´æ–°ç”¨æˆ·ä¿¡æ¯ï¼šæ—¢è¦ä¿å­˜åˆ°æ•°æ®åº“ï¼Œåˆè¦åŒæ­¥ç¼“å­˜
    @CachePut(value = "users", key = "#user.id")
    public User updateUserProfile(User user) {
        // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
        user.setUpdateTime(LocalDateTime.now());
        User savedUser = userRepository.save(user);
        
        // è¿”å›çš„ç»“æœä¼šè‡ªåŠ¨æ›´æ–°åˆ°ç¼“å­˜
        return savedUser;
    }
    
    // ç”¨æˆ·ç™»å½•ï¼šæ›´æ–°æœ€åç™»å½•æ—¶é—´
    @CachePut(value = "users", key = "#userId")
    public User updateLastLoginTime(Long userId) {
        User user = userRepository.findById(userId);
        user.setLastLoginTime(LocalDateTime.now());
        return userRepository.save(user);
    }
}
```

### 4.3 å‚æ•°é…ç½®



```java
@Service
public class ConfigService {
    
    // åŸºæœ¬ç”¨æ³•
    @CachePut(value = "configs", key = "#config.key")
    public Config updateConfig(Config config) { ... }
    
    // æ¡ä»¶æ›´æ–°ï¼šåªæœ‰é‡è¦é…ç½®æ‰ç¼“å­˜
    @CachePut(value = "configs", 
              key = "#config.key",
              condition = "#config.important == true")
    public Config updateImportantConfig(Config config) { ... }
    
    // ç»“æœè¿‡æ»¤ï¼šé”™è¯¯ç»“æœä¸ç¼“å­˜
    @CachePut(value = "configs", 
              key = "#config.key",
              unless = "#result.status == 'ERROR'")
    public Config updateConfigSafely(Config config) { ... }
}
```

### 4.4 æ³¨æ„äº‹é¡¹



#### âš ï¸ è¿”å›å€¼è¦æ±‚



**é‡è¦æé†’**ï¼š`@CachePut`è¦æ±‚æ–¹æ³•å¿…é¡»æœ‰è¿”å›å€¼ï¼Œå› ä¸ºè¿”å›å€¼å°±æ˜¯è¦ç¼“å­˜çš„å†…å®¹ã€‚

```java
// âœ… æ­£ç¡®ç”¨æ³•ï¼šæœ‰è¿”å›å€¼
@CachePut(value = "users", key = "#user.id")
public User updateUser(User user) {
    return userRepository.save(user);
}

// âŒ é”™è¯¯ç”¨æ³•ï¼švoidæ–¹æ³•æ— æ³•ç¼“å­˜
@CachePut(value = "users", key = "#userId")
public void updateUser(Long userId, String name) {
    // æ²¡æœ‰è¿”å›å€¼ï¼Œæ— æ³•æ›´æ–°ç¼“å­˜
}
```

#### ğŸ”„ ç¼“å­˜ä¸€è‡´æ€§



```java
@Service
public class UserService {
    
    @Cacheable(value = "users", key = "#id")
    public User findById(Long id) { ... }
    
    @Cacheable(value = "userProfiles", key = "#id") 
    public UserProfile findProfileById(Long id) { ... }
    
    // æ›´æ–°ç”¨æˆ·æ—¶ï¼Œéœ€è¦è€ƒè™‘ç›¸å…³ç¼“å­˜çš„ä¸€è‡´æ€§
    @CachePut(value = "users", key = "#user.id")
    @CacheEvict(value = "userProfiles", key = "#user.id")  // æ¸…é™¤ç›¸å…³ç¼“å­˜
    public User updateUser(User user) {
        return userRepository.save(user);
    }
}
```

---

## 5. ğŸ­ @Cachingç»„åˆæ³¨è§£



### 5.1 åŸºæœ¬æ¦‚å¿µ



**æ ¸å¿ƒä½œç”¨**ï¼š`@Caching`å°±åƒä¸€ä¸ª"å¤šåŠŸèƒ½å·¥å…·ç®±"ï¼Œå…è®¸ä½ åœ¨ä¸€ä¸ªæ–¹æ³•ä¸ŠåŒæ—¶ä½¿ç”¨å¤šä¸ªç¼“å­˜æ“ä½œã€‚

**ä¸ºä»€ä¹ˆéœ€è¦ç»„åˆæ³¨è§£ï¼Ÿ**
```
å¤æ‚ä¸šåŠ¡åœºæ™¯ï¼š
1. ç”¨æˆ·è´­ä¹°å•†å“å
2. éœ€è¦æ›´æ–°ç”¨æˆ·çš„è®¢å•åˆ—è¡¨ç¼“å­˜ (@CachePut)
3. éœ€è¦æ¸…é™¤å•†å“åº“å­˜ç¼“å­˜ (@CacheEvict)
4. éœ€è¦æ¸…é™¤è´­ç‰©è½¦ç¼“å­˜ (@CacheEvict)

ä¸€ä¸ªæ–¹æ³•éœ€è¦å¤šç§ç¼“å­˜æ“ä½œ â†’ ä½¿ç”¨@Cachingç»„åˆ
```

### 5.2 åŸºæœ¬è¯­æ³•



```java
@Caching(
    cacheable = { @Cacheable(...) },  // æŸ¥è¯¢ç¼“å­˜æ“ä½œ
    put = { @CachePut(...) },         // æ›´æ–°ç¼“å­˜æ“ä½œ  
    evict = { @CacheEvict(...) }      // æ¸…é™¤ç¼“å­˜æ“ä½œ
)
public ReturnType methodName(params) { ... }
```

### 5.3 å®é™…åº”ç”¨ç¤ºä¾‹



#### ğŸ›’ ç”µå•†è®¢å•å¤„ç†



```java
@Service
public class OrderService {
    
    // å¤æ‚ä¸šåŠ¡ï¼šç”¨æˆ·ä¸‹å•
    @Caching(
        put = {
            // æ›´æ–°ç”¨æˆ·è®¢å•ç¼“å­˜
            @CachePut(value = "userOrders", key = "#order.userId")
        },
        evict = {
            // æ¸…é™¤è´­ç‰©è½¦ç¼“å­˜
            @CacheEvict(value = "carts", key = "#order.userId"),
            // æ¸…é™¤å•†å“åº“å­˜ç¼“å­˜
            @CacheEvict(value = "productStock", key = "#order.productId")
        }
    )
    public Order createOrder(Order order) {
        // 1. ä¿å­˜è®¢å•
        Order savedOrder = orderRepository.save(order);
        
        // 2. æ‰£å‡åº“å­˜
        stockService.decreaseStock(order.getProductId(), order.getQuantity());
        
        // 3. æ¸…ç©ºè´­ç‰©è½¦
        cartService.clearCart(order.getUserId());
        
        return savedOrder;
    }
}
```

#### ğŸ“Š ç”¨æˆ·ç§¯åˆ†ç³»ç»Ÿ



```java
@Service  
public class PointService {
    
    // ç”¨æˆ·æ¶ˆè´¹ç§¯åˆ†
    @Caching(
        put = {
            // æ›´æ–°ç”¨æˆ·ç§¯åˆ†ç¼“å­˜
            @CachePut(value = "userPoints", key = "#userId")
        },
        evict = {
            // æ¸…é™¤ç§¯åˆ†å†å²ç¼“å­˜
            @CacheEvict(value = "pointHistory", key = "#userId"),
            // æ¸…é™¤ç”¨æˆ·ç­‰çº§ç¼“å­˜ï¼ˆç§¯åˆ†å˜åŒ–å¯èƒ½å½±å“ç­‰çº§ï¼‰
            @CacheEvict(value = "userLevel", key = "#userId")
        }
    )
    public UserPoints consumePoints(Long userId, Integer points) {
        UserPoints userPoints = pointRepository.findByUserId(userId);
        userPoints.setCurrentPoints(userPoints.getCurrentPoints() - points);
        userPoints.setUpdateTime(LocalDateTime.now());
        
        return pointRepository.save(userPoints);
    }
}
```

#### ğŸ¢ ä¼ä¸šç”¨æˆ·ç®¡ç†



```java
@Service
public class EmployeeService {
    
    // å‘˜å·¥ç¦»èŒå¤„ç†
    @Caching(
        evict = {
            @CacheEvict(value = "employees", key = "#employeeId"),
            @CacheEvict(value = "departmentEmployees", key = "#departmentId"), 
            @CacheEvict(value = "employeePermissions", key = "#employeeId"),
            @CacheEvict(value = "orgChart", allEntries = true)  // ç»„ç»‡æ¶æ„ç¼“å­˜å…¨æ¸…
        }
    )
    public void terminateEmployee(Long employeeId, Long departmentId) {
        // 1. æ›´æ–°å‘˜å·¥çŠ¶æ€
        Employee employee = employeeRepository.findById(employeeId);
        employee.setStatus("TERMINATED");
        employeeRepository.save(employee);
        
        // 2. æ¸…é™¤æƒé™
        permissionService.revokeAllPermissions(employeeId);
        
        // 3. æ›´æ–°éƒ¨é—¨ä¿¡æ¯
        departmentService.removeEmployee(departmentId, employeeId);
    }
}
```

### 5.4 é«˜çº§ç”¨æ³•



#### ğŸ”„ æ¡ä»¶ç»„åˆç¼“å­˜



```java
@Service
public class ReportService {
    
    @Caching(
        cacheable = {
            // åªæœ‰VIPç”¨æˆ·çš„æŠ¥å‘Šæ‰ç¼“å­˜
            @Cacheable(value = "reports", 
                      key = "#userId + '_' + #reportType",
                      condition = "#userLevel == 'VIP'")
        },
        evict = {
            // æ¸…é™¤ç›¸å…³çš„æ±‡æ€»æ•°æ®
            @CacheEvict(value = "reportSummary", 
                       key = "#reportType",
                       condition = "#updateSummary == true")
        }
    )
    public Report generateUserReport(Long userId, String reportType, 
                                   String userLevel, boolean updateSummary) {
        return reportGenerator.generate(userId, reportType);
    }
}
```

#### ğŸ“ å¤šç¼“å­˜åŒºåŸŸæ“ä½œ



```java
@Service
public class ContentService {
    
    @Caching(
        put = {
            // æ›´æ–°ä¸»ç¼“å­˜
            @CachePut(value = "articles", key = "#article.id"),
            // æ›´æ–°æœç´¢ç¼“å­˜
            @CachePut(value = "searchResults", 
                     key = "#article.category + '_latest'")
        },
        evict = {
            // æ¸…é™¤æ ‡ç­¾ç›¸å…³ç¼“å­˜
            @CacheEvict(value = "taggedArticles", key = "#article.tag"),
            // æ¸…é™¤ä½œè€…æ–‡ç« åˆ—è¡¨
            @CacheEvict(value = "authorArticles", key = "#article.authorId")
        }
    )
    public Article publishArticle(Article article) {
        article.setPublishTime(LocalDateTime.now());
        article.setStatus("PUBLISHED");
        return articleRepository.save(article);
    }
}
```

---

## 6. âš™ï¸ ç¼“å­˜é…ç½®ä¸ç®¡ç†



### 6.1 ç¼“å­˜ç®¡ç†å™¨é…ç½®



**ç¼“å­˜ç®¡ç†å™¨**å°±åƒæ˜¯ç¼“å­˜çš„"æ€»ç®¡å®¶"ï¼Œè´Ÿè´£åˆ›å»ºã€ç®¡ç†å’Œé…ç½®ä¸åŒçš„ç¼“å­˜åŒºåŸŸã€‚

#### ğŸ”§ åŸºç¡€é…ç½®



```java
@Configuration
@EnableCaching
public class CacheConfig {
    
    // ç®€å•å†…å­˜ç¼“å­˜ç®¡ç†å™¨
    @Bean
    @Primary
    public CacheManager cacheManager() {
        ConcurrentMapCacheManager cacheManager = new ConcurrentMapCacheManager();
        // é¢„å…ˆåˆ›å»ºç¼“å­˜åŒºåŸŸ
        cacheManager.setCacheNames(Arrays.asList(
            "users", "products", "orders", "configs"
        ));
        return cacheManager;
    }
}
```

#### ğŸš€ Redisç¼“å­˜é…ç½®



```java
@Configuration
@EnableCaching
public class RedisCacheConfig {
    
    @Bean
    public CacheManager redisCacheManager(RedisConnectionFactory factory) {
        RedisCacheConfiguration config = RedisCacheConfiguration.defaultCacheConfig()
                .entryTtl(Duration.ofHours(1))  // é»˜è®¤1å°æ—¶è¿‡æœŸ
                .disableCachingNullValues()     // ä¸ç¼“å­˜nullå€¼
                .serializeKeysWith(RedisSerializationContext.SerializationPair
                    .fromSerializer(new StringRedisSerializer()))
                .serializeValuesWith(RedisSerializationContext.SerializationPair
                    .fromSerializer(new GenericJackson2JsonRedisSerializer()));
        
        return RedisCacheManager.builder(factory)
                .cacheDefaults(config)
                .build();
    }
}
```

#### ğŸ¯ å¤šçº§ç¼“å­˜é…ç½®



```java
@Configuration
public class MultiLevelCacheConfig {
    
    // L1ç¼“å­˜ï¼šæœ¬åœ°å†…å­˜ç¼“å­˜ï¼ˆå¿«é€Ÿï¼‰
    @Bean("l1Cache")
    public CacheManager localCacheManager() {
        CaffeineCacheManager manager = new CaffeineCacheManager();
        manager.setCaffeine(Caffeine.newBuilder()
                .maximumSize(1000)          // æœ€å¤§1000ä¸ªæ¡ç›®
                .expireAfterWrite(10, TimeUnit.MINUTES));  // 10åˆ†é’Ÿè¿‡æœŸ
        return manager;
    }
    
    // L2ç¼“å­˜ï¼šRedisåˆ†å¸ƒå¼ç¼“å­˜ï¼ˆå®¹é‡å¤§ï¼‰
    @Bean("l2Cache")  
    @Primary
    public CacheManager redisCacheManager(RedisConnectionFactory factory) {
        // Redisé…ç½®...
        return RedisCacheManager.builder(factory).build();
    }
}
```

### 6.2 è‡ªå®šä¹‰KeyGenerator



**Keyç”Ÿæˆå™¨**è´Ÿè´£ä¸ºç¼“å­˜æ•°æ®ç”Ÿæˆå”¯ä¸€æ ‡è¯†ï¼Œå°±åƒç»™æ¯ä¸ªç¼“å­˜æ•°æ®åˆ†é…"èº«ä»½è¯å·"ã€‚

#### ğŸ”‘ é»˜è®¤Keyç”Ÿæˆè§„åˆ™



```java
// Springé»˜è®¤keyç”Ÿæˆè§„åˆ™ï¼š
æ— å‚æ•°ï¼šSimpleKey.EMPTY
å•å‚æ•°ï¼šå‚æ•°å€¼æœ¬èº«
å¤šå‚æ•°ï¼šSimpleKey(param1, param2, ...)

// å®é™…ç¤ºä¾‹ï¼š
findById(123)           â†’ key: 123
findUser()              â†’ key: SimpleKey []  
findOrders(1, "PAID")   â†’ key: SimpleKey [1, PAID]
```

#### ğŸ¨ è‡ªå®šä¹‰Keyç”Ÿæˆå™¨



```java
@Component
public class CustomKeyGenerator implements KeyGenerator {
    
    @Override
    public Object generate(Object target, Method method, Object... params) {
        StringBuilder key = new StringBuilder();
        
        // æ·»åŠ ç±»å
        key.append(target.getClass().getSimpleName()).append(".");
        // æ·»åŠ æ–¹æ³•å  
        key.append(method.getName()).append("(");
        
        // æ·»åŠ å‚æ•°
        for (int i = 0; i < params.length; i++) {
            if (i > 0) key.append(",");
            if (params[i] != null) {
                key.append(params[i].toString());
            } else {
                key.append("null");
            }
        }
        key.append(")");
        
        return key.toString();
    }
}

// ä½¿ç”¨è‡ªå®šä¹‰Keyç”Ÿæˆå™¨
@Service
public class UserService {
    
    @Cacheable(value = "users", keyGenerator = "customKeyGenerator")
    public User findById(Long id) { ... }
    // ç”Ÿæˆçš„key: UserService.findById(123)
}
```

#### ğŸ·ï¸ ä¸šåŠ¡ç›¸å…³çš„Keyç”Ÿæˆå™¨



```java
@Component  
public class BusinessKeyGenerator implements KeyGenerator {
    
    @Override
    public Object generate(Object target, Method method, Object... params) {
        // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼ˆç”¨äºå¤šç§Ÿæˆ·ç¼“å­˜éš”ç¦»ï¼‰
        String tenantId = SecurityContext.getCurrentTenant();
        String userId = SecurityContext.getCurrentUser();
        
        StringBuilder key = new StringBuilder();
        key.append(tenantId).append(":");
        key.append(userId).append(":");
        key.append(method.getName());
        
        // æ·»åŠ æ–¹æ³•å‚æ•°
        for (Object param : params) {
            key.append(":").append(param);
        }
        
        return key.toString();
    }
}
```

### 6.3 ç¼“å­˜é…ç½®è¯¦ç»†åŒ–



#### â° ä¸åŒç¼“å­˜çš„TTLé…ç½®



```java
@Configuration
public class DetailedCacheConfig {
    
    @Bean
    public CacheManager customCacheManager(RedisConnectionFactory factory) {
        Map<String, RedisCacheConfiguration> configs = new HashMap<>();
        
        // ç”¨æˆ·ä¿¡æ¯ç¼“å­˜ï¼š2å°æ—¶è¿‡æœŸ
        configs.put("users", RedisCacheConfiguration.defaultCacheConfig()
                .entryTtl(Duration.ofHours(2)));
        
        // å•†å“ä¿¡æ¯ç¼“å­˜ï¼š1å¤©è¿‡æœŸ
        configs.put("products", RedisCacheConfiguration.defaultCacheConfig()
                .entryTtl(Duration.ofDays(1)));
        
        // é…ç½®ä¿¡æ¯ç¼“å­˜ï¼šæ°¸ä¸è¿‡æœŸ
        configs.put("configs", RedisCacheConfiguration.defaultCacheConfig()
                .entryTtl(Duration.ZERO));
        
        // ä¸´æ—¶æ•°æ®ç¼“å­˜ï¼š5åˆ†é’Ÿè¿‡æœŸ
        configs.put("temporary", RedisCacheConfiguration.defaultCacheConfig()
                .entryTtl(Duration.ofMinutes(5)));
        
        return RedisCacheManager.builder(factory)
                .withInitialCacheConfigurations(configs)
                .build();
    }
}
```

---

## 7. ğŸ¯ é«˜çº§åº”ç”¨æŠ€å·§



### 7.1 æ¡ä»¶ç¼“å­˜æ§åˆ¶



#### ğŸ® åŠ¨æ€æ¡ä»¶æ§åˆ¶



```java
@Service
public class SmartCacheService {
    
    // æ ¹æ®ç³»ç»Ÿè´Ÿè½½å†³å®šæ˜¯å¦ä½¿ç”¨ç¼“å­˜
    @Cacheable(value = "reports", 
               condition = "@systemMonitor.isHighLoad() == false")
    public Report generateReport(String reportType) {
        // ç³»ç»Ÿè´Ÿè½½é«˜æ—¶ä¸ä½¿ç”¨ç¼“å­˜ï¼Œé¿å…å†…å­˜å‹åŠ›
        return reportGenerator.generate(reportType);
    }
    
    // åªåœ¨å·¥ä½œæ—¶é—´ç¼“å­˜
    @Cacheable(value = "businessData",
               condition = "@timeUtil.isBusinessHour()")
    public BusinessData getBusinessData() {
        // éå·¥ä½œæ—¶é—´æ•°æ®å˜åŒ–å°‘ï¼Œä¸éœ€è¦ç¼“å­˜
        return businessRepository.getCurrentData();
    }
    
    // VIPç”¨æˆ·ä¸“äº«ç¼“å­˜
    @Cacheable(value = "vipData",
               condition = "@userService.isVipUser(#userId)")
    public VipData getVipData(Long userId) {
        return vipRepository.findByUserId(userId);
    }
}

@Component
public class SystemMonitor {
    public boolean isHighLoad() {
        // æ£€æŸ¥CPUã€å†…å­˜ä½¿ç”¨ç‡
        return Runtime.getRuntime().freeMemory() < 1024 * 1024 * 100; // å°‘äº100MB
    }
}
```

#### ğŸ” å¤æ‚æ¡ä»¶ç»„åˆ



```java
@Service
public class ConditionalCacheService {
    
    @Cacheable(value = "userData",
               key = "#userId",
               // å¤æ‚æ¡ä»¶ï¼šç”¨æˆ·æ´»è·ƒä¸”éæµ‹è¯•ç¯å¢ƒ
               condition = "#userId > 0 and @userService.isActiveUser(#userId) and !@env.isTest()",
               // ç»“æœè¿‡æ»¤ï¼šæœ‰æ•ˆæ•°æ®æ‰ç¼“å­˜
               unless = "#result == null or #result.status == 'INVALID'")
    public UserData getUserData(Long userId) {
        return userRepository.findUserData(userId);
    }
}
```

### 7.2 å¼‚å¸¸å¤„ç†æœºåˆ¶



#### âš ï¸ ç¼“å­˜æ“ä½œå¼‚å¸¸å¤„ç†



```java
@Service
public class SafeCacheService {
    
    // ç¼“å­˜å¤±è´¥ä¸å½±å“ä¸šåŠ¡
    @Cacheable(value = "products", key = "#id")
    public Product findProduct(Long id) {
        try {
            return productRepository.findById(id);
        } catch (Exception e) {
            log.warn("æŸ¥è¯¢å•†å“å¤±è´¥: {}", e.getMessage());
            // è¿”å›é»˜è®¤å€¼æˆ–æŠ›å‡ºä¸šåŠ¡å¼‚å¸¸
            return Product.getDefault();
        }
    }
}

// å…¨å±€ç¼“å­˜å¼‚å¸¸å¤„ç†å™¨
@Configuration
public class CacheErrorHandler implements CacheErrorHandler {
    
    private static final Logger log = LoggerFactory.getLogger(CacheErrorHandler.class);
    
    @Override
    public void handleCacheGetError(RuntimeException exception, Cache cache, Object key) {
        log.error("ç¼“å­˜è·å–å¤±è´¥ - cache: {}, key: {}", cache.getName(), key, exception);
        // ç¼“å­˜è·å–å¤±è´¥æ—¶ï¼Œç»§ç»­æ‰§è¡ŒåŸæ–¹æ³•
    }
    
    @Override
    public void handleCachePutError(RuntimeException exception, Cache cache, Object key, Object value) {
        log.error("ç¼“å­˜å­˜å‚¨å¤±è´¥ - cache: {}, key: {}", cache.getName(), key, exception);
        // ç¼“å­˜å­˜å‚¨å¤±è´¥æ—¶ï¼Œä¸å½±å“ä¸šåŠ¡æµç¨‹
    }
    
    @Override
    public void handleCacheEvictError(RuntimeException exception, Cache cache, Object key) {
        log.error("ç¼“å­˜æ¸…é™¤å¤±è´¥ - cache: {}, key: {}", cache.getName(), key, exception);
    }
    
    @Override
    public void handleCacheClearError(RuntimeException exception, Cache cache) {
        log.error("ç¼“å­˜æ¸…ç©ºå¤±è´¥ - cache: {}", cache.getName(), exception);
    }
}
```

### 7.3 ç¼“å­˜é¢„çƒ­ä¸åˆ·æ–°



#### ğŸ”¥ ç³»ç»Ÿå¯åŠ¨æ—¶é¢„çƒ­ç¼“å­˜



```java
@Component
public class CacheWarmUp implements ApplicationRunner {
    
    @Autowired
    private UserService userService;
    @Autowired  
    private ProductService productService;
    
    @Override
    public void run(ApplicationArguments args) {
        log.info("å¼€å§‹ç¼“å­˜é¢„çƒ­...");
        
        // é¢„çƒ­çƒ­é—¨ç”¨æˆ·æ•°æ®
        List<Long> hotUserIds = userService.getHotUserIds();
        for (Long userId : hotUserIds) {
            userService.findById(userId);
        }
        
        // é¢„çƒ­çƒ­é—¨å•†å“æ•°æ®
        List<Long> hotProductIds = productService.getHotProductIds();  
        for (Long productId : hotProductIds) {
            productService.findById(productId);
        }
        
        log.info("ç¼“å­˜é¢„çƒ­å®Œæˆ");
    }
}
```

#### ğŸ”„ å®šæ—¶åˆ·æ–°ç¼“å­˜



```java
@Component
public class CacheRefreshScheduler {
    
    @Autowired
    private CacheManager cacheManager;
    
    // æ¯å°æ—¶åˆ·æ–°é…ç½®ç¼“å­˜
    @Scheduled(fixedRate = 3600000)
    public void refreshConfigCache() {
        Cache configCache = cacheManager.getCache("configs");
        if (configCache != null) {
            configCache.clear();
            log.info("é…ç½®ç¼“å­˜å·²åˆ·æ–°");
        }
    }
    
    // æ¯å¤©å‡Œæ™¨2ç‚¹æ¸…ç†è¿‡æœŸç¼“å­˜
    @Scheduled(cron = "0 0 2 * * ?")
    public void cleanExpiredCache() {
        // æ¸…ç†ä¸´æ—¶ç¼“å­˜
        Cache tempCache = cacheManager.getCache("temporary");
        if (tempCache != null) {
            tempCache.clear();
            log.info("ä¸´æ—¶ç¼“å­˜å·²æ¸…ç†");
        }
    }
}
```

---

## 8. ğŸ“‹ æœ€ä½³å®è·µæŒ‡å—



### 8.1 ç¼“å­˜è®¾è®¡åŸåˆ™



#### ğŸ¯ ç¼“å­˜ä»€ä¹ˆæ•°æ®



```
âœ… é€‚åˆç¼“å­˜çš„æ•°æ®ï¼š
- æŸ¥è¯¢é¢‘ç¹çš„æ•°æ®ï¼ˆç”¨æˆ·ä¿¡æ¯ã€å•†å“è¯¦æƒ…ï¼‰
- è®¡ç®—å¤æ‚çš„ç»“æœï¼ˆç»Ÿè®¡æŠ¥è¡¨ã€å¤æ‚æŸ¥è¯¢ï¼‰
- ç›¸å¯¹ç¨³å®šçš„æ•°æ®ï¼ˆé…ç½®ä¿¡æ¯ã€å­—å…¸æ•°æ®ï¼‰
- ç½‘ç»œè¯·æ±‚ç»“æœï¼ˆç¬¬ä¸‰æ–¹APIå“åº”ï¼‰

âŒ ä¸é€‚åˆç¼“å­˜çš„æ•°æ®ï¼š
- å®æ—¶æ€§è¦æ±‚æé«˜çš„æ•°æ®ï¼ˆè‚¡ç¥¨ä»·æ ¼ã€ç§’æ€åº“å­˜ï¼‰
- å˜åŒ–é¢‘ç¹çš„æ•°æ®ï¼ˆç”¨æˆ·çŠ¶æ€ã€å®æ—¶ä½ç½®ï¼‰
- å¤§é‡æ•°æ®ï¼ˆå¤§æ–‡ä»¶ã€å¤§åˆ—è¡¨ï¼‰
- æ•æ„Ÿæ•°æ®ï¼ˆå¯†ç ã€æ”¯ä»˜ä¿¡æ¯ï¼‰
```

#### ğŸ”‘ ç¼“å­˜Keyè®¾è®¡è§„èŒƒ



```java
// âœ… å¥½çš„Keyè®¾è®¡
@Cacheable(value = "users", key = "'user:profile:' + #userId")
@Cacheable(value = "products", key = "'product:' + #id + ':' + #version")
@Cacheable(value = "orders", key = "'user:' + #userId + ':orders:' + #status")

// âŒ ä¸å¥½çš„Keyè®¾è®¡  
@Cacheable(value = "data", key = "#param")  // Keyå¤ªç®€å•ï¼Œå®¹æ˜“å†²çª
@Cacheable(value = "cache", key = "#obj.toString()")  // ä¾èµ–toStringï¼Œä¸ç¨³å®š
```

#### â° ç¼“å­˜è¿‡æœŸæ—¶é—´ç­–ç•¥



```java
@Configuration
public class CacheTimeConfig {
    
    // ä¸åŒä¸šåŠ¡æ•°æ®çš„ç¼“å­˜æ—¶é—´å»ºè®®ï¼š
    public static final Duration USER_CACHE_TTL = Duration.ofHours(2);      // ç”¨æˆ·ä¿¡æ¯
    public static final Duration PRODUCT_CACHE_TTL = Duration.ofDays(1);     // å•†å“ä¿¡æ¯  
    public static final Duration CONFIG_CACHE_TTL = Duration.ofDays(7);      // é…ç½®ä¿¡æ¯
    public static final Duration TEMP_CACHE_TTL = Duration.ofMinutes(10);    // ä¸´æ—¶æ•°æ®
    public static final Duration HOT_DATA_TTL = Duration.ofHours(1);         // çƒ­ç‚¹æ•°æ®
}
```

### 8.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®



#### ğŸš€ é¿å…ç¼“å­˜ç©¿é€



```java
@Service
public class AntiPenetrationService {
    
    // æ–¹æ³•1ï¼šç¼“å­˜nullå€¼
    @Cacheable(value = "users", key = "#id", unless = "false")  // æ€»æ˜¯ç¼“å­˜
    public User findById(Long id) {
        User user = userRepository.findById(id);
        // å³ä½¿è¿”å›nullä¹Ÿä¼šè¢«ç¼“å­˜ï¼Œé¿å…é‡å¤æŸ¥è¯¢
        return user;
    }
    
    // æ–¹æ³•2ï¼šå‚æ•°æ ¡éªŒ
    @Cacheable(value = "products", 
               key = "#id", 
               condition = "#id != null and #id > 0")  // æ— æ•ˆå‚æ•°ä¸æŸ¥è¯¢
    public Product findProduct(Long id) {
        return productRepository.findById(id);
    }
}
```

#### ğŸ”’ é¿å…ç¼“å­˜é›ªå´©



```java
@Configuration
public class AntiAvalancheConfig {
    
    @Bean
    public CacheManager randomTtlCacheManager(RedisConnectionFactory factory) {
        return RedisCacheManager.builder(factory)
                .cacheDefaults(RedisCacheConfiguration.defaultCacheConfig()
                    .entryTtl(Duration.ofMinutes(30 + new Random().nextInt(30))))  // 30-60åˆ†é’Ÿéšæœº
                .build();
    }
}
```

### 8.3 ç›‘æ§ä¸è¿ç»´



#### ğŸ“Š ç¼“å­˜ç›‘æ§æŒ‡æ ‡



```java
@Component
public class CacheMetrics {
    
    @Autowired
    private MeterRegistry meterRegistry;
    
    @EventListener
    public void handleCacheHit(CacheHitEvent event) {
        Counter.builder("cache.hit")
                .tag("cache", event.getCacheName())
                .register(meterRegistry)
                .increment();
    }
    
    @EventListener  
    public void handleCacheMiss(CacheMissEvent event) {
        Counter.builder("cache.miss")
                .tag("cache", event.getCacheName())
                .register(meterRegistry)
                .increment();
    }
}
```

#### ğŸ› ï¸ ç¼“å­˜ç®¡ç†å·¥å…·



```java
@RestController
@RequestMapping("/admin/cache")
public class CacheAdminController {
    
    @Autowired
    private CacheManager cacheManager;
    
    // æŸ¥çœ‹ç¼“å­˜çŠ¶æ€
    @GetMapping("/status")
    public Map<String, Object> getCacheStatus() {
        Map<String, Object> status = new HashMap<>();
        for (String cacheName : cacheManager.getCacheNames()) {
            Cache cache = cacheManager.getCache(cacheName);
            // æ”¶é›†ç¼“å­˜ç»Ÿè®¡ä¿¡æ¯
            status.put(cacheName, getCacheInfo(cache));
        }
        return status;
    }
    
    // æ¸…é™¤æŒ‡å®šç¼“å­˜
    @DeleteMapping("/{cacheName}")
    public String clearCache(@PathVariable String cacheName) {
        Cache cache = cacheManager.getCache(cacheName);
        if (cache != null) {
            cache.clear();
            return "ç¼“å­˜ " + cacheName + " å·²æ¸…é™¤";
        }
        return "ç¼“å­˜ä¸å­˜åœ¨";
    }
    
    // æ¸…é™¤æ‰€æœ‰ç¼“å­˜
    @DeleteMapping("/all")
    public String clearAllCache() {
        for (String cacheName : cacheManager.getCacheNames()) {
            cacheManager.getCache(cacheName).clear();
        }
        return "æ‰€æœ‰ç¼“å­˜å·²æ¸…é™¤";
    }
}
```

### 8.4 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ



#### â“ ç¼“å­˜ä¸ç”Ÿæ•ˆæ’æŸ¥



```java
// æ£€æŸ¥æ¸…å•ï¼š
1. â­ @EnableCachingæ³¨è§£æ˜¯å¦æ·»åŠ ï¼Ÿ
2. â­ æ–¹æ³•æ˜¯å¦è¢«Springç®¡ç†ï¼ˆ@Serviceç­‰ï¼‰ï¼Ÿ
3. â­ æ–¹æ³•æ˜¯å¦è¢«ä»£ç†è°ƒç”¨ï¼ˆå†…éƒ¨è°ƒç”¨æ— æ•ˆï¼‰ï¼Ÿ
4. â­ ç¼“å­˜ç®¡ç†å™¨é…ç½®æ˜¯å¦æ­£ç¡®ï¼Ÿ
5. â­ Keyè¡¨è¾¾å¼æ˜¯å¦æ­£ç¡®ï¼Ÿ

// è°ƒè¯•æ–¹æ³•ï¼š
@Cacheable(value = "debug")
public String debugMethod(String param) {
    System.out.println("æ–¹æ³•è¢«æ‰§è¡Œäº†ï¼š" + param);  // ç¬¬äºŒæ¬¡è°ƒç”¨ä¸åº”è¯¥æ‰“å°
    return "result: " + param;
}
```

#### ğŸ”„ å†…éƒ¨æ–¹æ³•è°ƒç”¨é—®é¢˜



```java
@Service
public class UserService {
    
    @Autowired
    private UserService self;  // æ³¨å…¥è‡ªå·±
    
    // âŒ é”™è¯¯ï¼šå†…éƒ¨è°ƒç”¨ï¼Œç¼“å­˜ä¸ç”Ÿæ•ˆ
    public User getUser(Long id) {
        return findById(id);  // ç›´æ¥è°ƒç”¨ï¼Œæ²¡æœ‰ç»è¿‡Springä»£ç†
    }
    
    // âœ… æ­£ç¡®ï¼šé€šè¿‡ä»£ç†è°ƒç”¨
    public User getUserCorrect(Long id) {
        return self.findById(id);  // é€šè¿‡Springä»£ç†è°ƒç”¨
    }
    
    @Cacheable(value = "users", key = "#id")
    public User findById(Long id) {
        return userRepository.findById(id);
    }
}
```

---

# ğŸ“ æ ¸å¿ƒè¦ç‚¹æ€»ç»“



## ğŸ¯ å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ



```
ğŸ”¸ @Cacheableï¼šæŸ¥è¯¢æ—¶ç¼“å­˜ï¼Œæœ‰å°±ç›´æ¥è¿”å›ï¼Œæ²¡æœ‰å°±æ‰§è¡Œæ–¹æ³•å¹¶ç¼“å­˜
ğŸ”¸ @CacheEvictï¼šæ¸…é™¤ç¼“å­˜ï¼Œæ•°æ®å˜åŒ–æ—¶åŠæ—¶æ¸…ç†æ—§ç¼“å­˜
ğŸ”¸ @CachePutï¼šæ›´æ–°ç¼“å­˜ï¼Œæ¯æ¬¡éƒ½æ‰§è¡Œæ–¹æ³•å¹¶æ›´æ–°ç¼“å­˜ç»“æœ
ğŸ”¸ @Cachingï¼šç»„åˆæ³¨è§£ï¼Œä¸€ä¸ªæ–¹æ³•æ‰§è¡Œå¤šç§ç¼“å­˜æ“ä½œ
ğŸ”¸ SpELè¡¨è¾¾å¼ï¼šåŠ¨æ€æŒ‡å®šç¼“å­˜keyã€æ¡ä»¶ç­‰å‚æ•°
```

## ğŸ”¹ å…³é”®ç†è§£è¦ç‚¹



**ç¼“å­˜çš„æœ¬è´¨**ï¼šç”¨ç©ºé—´æ¢æ—¶é—´ï¼ŒæŠŠå¸¸ç”¨æ•°æ®æ”¾åœ¨å¿«é€Ÿè®¿é—®çš„åœ°æ–¹

**æ³¨è§£é€‰æ‹©åŸåˆ™**ï¼š
- æŸ¥è¯¢å¤šã€æ›´æ–°å°‘ â†’ `@Cacheable`
- éœ€è¦å®æ—¶æ›´æ–° â†’ `@CachePut`  
- æ•°æ®å˜åŒ–æ—¶ â†’ `@CacheEvict`
- å¤æ‚åœºæ™¯ â†’ `@Caching`

**Keyè®¾è®¡åŸåˆ™**ï¼šå”¯ä¸€ã€ç®€æ´ã€æœ‰æ„ä¹‰ã€ä¸å†²çª

## ğŸ› ï¸ å®é™…åº”ç”¨ä»·å€¼



- **æå‡æ€§èƒ½**ï¼šå‡å°‘æ•°æ®åº“æŸ¥è¯¢ï¼Œæé«˜å“åº”é€Ÿåº¦
- **é™ä½æˆæœ¬**ï¼šå‡å°‘æœåŠ¡å™¨å‹åŠ›ï¼ŒèŠ‚çº¦èµ„æº
- **æ”¹å–„ä½“éªŒ**ï¼šé¡µé¢åŠ è½½æ›´å¿«ï¼Œç”¨æˆ·ä½“éªŒæ›´å¥½
- **ç®€åŒ–å¼€å‘**ï¼šå£°æ˜å¼ç¼“å­˜ï¼Œä»£ç ç®€æ´æ¸…æ™°

## âš ï¸ æ³¨æ„äº‹é¡¹



- å†…éƒ¨æ–¹æ³•è°ƒç”¨ä¸ä¼šè§¦å‘ç¼“å­˜
- ç¼“å­˜æ•°æ®è¦è€ƒè™‘ä¸€è‡´æ€§é—®é¢˜
- åˆç†è®¾ç½®è¿‡æœŸæ—¶é—´é¿å…å†…å­˜æº¢å‡º
- é‡è¦ä¸šåŠ¡æ•°æ®ç¼“å­˜å¤±è´¥ä¸åº”å½±å“ä¸»æµç¨‹

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
> æŸ¥è¯¢ç¼“å­˜ç”¨Cacheableï¼Œæ¸…é™¤ç¼“å­˜ç”¨Evict  
> æ›´æ–°ç¼“å­˜ç”¨CachePutï¼Œå¤æ‚åœºæ™¯ç”¨Caching  
> Keyè®¾è®¡è¦å”¯ä¸€ï¼Œæ¡ä»¶æ§åˆ¶è¦åˆç†  
> å¼‚å¸¸å¤„ç†è¦å®Œå–„ï¼Œç›‘æ§è¿ç»´ä¸å¯å°‘