---
title: 4ã€åˆ†å¸ƒå¼é”æ–¹æ¡ˆå¯¹æ¯”
---
## ğŸ“š ç›®å½•

1. [åˆ†å¸ƒå¼é”åŸºç¡€æ¦‚å¿µ](#1-åˆ†å¸ƒå¼é”åŸºç¡€æ¦‚å¿µ)
2. [Rediså®ç°åˆ†å¸ƒå¼é”](#2-Rediså®ç°åˆ†å¸ƒå¼é”)
3. [Zookeeperå®ç°åˆ†å¸ƒå¼é”](#3-Zookeeperå®ç°åˆ†å¸ƒå¼é”)
4. [æ•°æ®åº“å®ç°åˆ†å¸ƒå¼é”](#4-æ•°æ®åº“å®ç°åˆ†å¸ƒå¼é”)
5. [æ–¹æ¡ˆå…¨é¢å¯¹æ¯”åˆ†æ](#5-æ–¹æ¡ˆå…¨é¢å¯¹æ¯”åˆ†æ)
6. [é€‰å‹å†³ç­–æŒ‡å—](#6-é€‰å‹å†³ç­–æŒ‡å—)
7. [æœ€ä½³å®è·µä¸æ€»ç»“](#7-æœ€ä½³å®è·µä¸æ€»ç»“)

---

## 1. ğŸ” åˆ†å¸ƒå¼é”åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼é”


**ç®€å•ç†è§£**ï¼šåˆ†å¸ƒå¼é”å°±åƒæ˜¯ç»™å¤šä¸ªä¸åœ¨åŒä¸€å°æœºå™¨ä¸Šçš„ç¨‹åºå‡†å¤‡çš„"æ’é˜Ÿå«å·æœº"

```
ä¼ ç»Ÿå•æœºé”ï¼š          åˆ†å¸ƒå¼é”ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ çº¿ç¨‹A   â”‚          â”‚ æœåŠ¡A   â”‚   â”‚ æœåŠ¡B   â”‚   â”‚ æœåŠ¡C   â”‚
â”‚ çº¿ç¨‹B   â”‚   VS     â”‚(æœºå™¨1)  â”‚   â”‚(æœºå™¨2)  â”‚   â”‚(æœºå™¨3)  â”‚
â”‚ çº¿ç¨‹C   â”‚          â”‚         â”‚   â”‚         â”‚   â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
åŒä¸€è¿›ç¨‹å†…               ä¸åŒæœºå™¨ä¸Šçš„ä¸åŒæœåŠ¡
```

> ğŸ’¡ **æ ¸å¿ƒä½œç”¨**ï¼šç¡®ä¿åˆ†å¸ƒå¼ç³»ç»Ÿä¸­åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªæœåŠ¡èƒ½æ“ä½œå…±äº«èµ„æº

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”


**å®é™…åœºæ™¯ä¸¾ä¾‹**ï¼š

**åœºæ™¯1ï¼šåº“å­˜æ‰£å‡**
```
ç”µå•†ç§’æ€åœºæ™¯ï¼š
ç”¨æˆ·Aåœ¨æœåŠ¡å™¨1ä¸‹å•  \
ç”¨æˆ·Båœ¨æœåŠ¡å™¨2ä¸‹å•   }-- åŒæ—¶è´­ä¹°æœ€å1ä»¶å•†å“
ç”¨æˆ·Cåœ¨æœåŠ¡å™¨3ä¸‹å•  /

æ²¡æœ‰åˆ†å¸ƒå¼é”ï¼šå¯èƒ½3ä¸ªç”¨æˆ·éƒ½æ‰£åº“å­˜æˆåŠŸï¼ˆè¶…å–ï¼‰
æœ‰åˆ†å¸ƒå¼é”ï¼šåªæœ‰1ä¸ªç”¨æˆ·èƒ½æˆåŠŸæ‰£åº“å­˜
```

**åœºæ™¯2ï¼šå®šæ—¶ä»»åŠ¡**
```
è®¢å•è¶…æ—¶å–æ¶ˆä»»åŠ¡ï¼š
æœåŠ¡å™¨Aï¼šæ¯åˆ†é’Ÿæ£€æŸ¥è¶…æ—¶è®¢å•  \
æœåŠ¡å™¨Bï¼šæ¯åˆ†é’Ÿæ£€æŸ¥è¶…æ—¶è®¢å•   }-- é˜²æ­¢é‡å¤å¤„ç†
æœåŠ¡å™¨Cï¼šæ¯åˆ†é’Ÿæ£€æŸ¥è¶…æ—¶è®¢å•  /
```

### 1.3 åˆ†å¸ƒå¼é”å¿…å¤‡ç‰¹æ€§


**ğŸ”¸ äº’æ–¥æ€§**ï¼šåŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯èƒ½æŒæœ‰é”
**ğŸ”¸ é˜²æ­»é”**ï¼šå³ä½¿æŒæœ‰é”çš„è¿›ç¨‹å´©æºƒï¼Œé”ä¹Ÿèƒ½è¢«é‡Šæ”¾
**ğŸ”¸ å®¹é”™æ€§**ï¼šå°‘æ•°èŠ‚ç‚¹å®•æœºï¼Œé”æœåŠ¡ä»å¯ç”¨
**ğŸ”¸ ä¸€è‡´æ€§**ï¼šæ‰€æœ‰èŠ‚ç‚¹çœ‹åˆ°çš„é”çŠ¶æ€ä¸€è‡´

---

## 2. ğŸ”´ Rediså®ç°åˆ†å¸ƒå¼é”


### 2.1 Redisé”åŸºæœ¬åŸç†


**æ ¸å¿ƒæ€æƒ³**ï¼šåˆ©ç”¨Redisçš„åŸå­æ€§æ“ä½œå’Œè¿‡æœŸæ—¶é—´æœºåˆ¶

```
åŠ é”è¿‡ç¨‹ï¼š                    é‡Šæ”¾é”è¿‡ç¨‹ï¼š
å®¢æˆ·ç«¯                       å®¢æˆ·ç«¯
  |                            |
  |-- SET key value EX 30 NX   |-- DEL key (æ¡ä»¶åˆ é™¤)
  |                            |
RedisæœåŠ¡å™¨                   RedisæœåŠ¡å™¨
```

> ğŸ“ **å…³é”®å‘½ä»¤è§£é‡Š**ï¼š
> - `SET key value EX seconds NX`ï¼šè®¾ç½®keyï¼Œè¿‡æœŸæ—¶é—´secondsç§’ï¼Œä»…å½“keyä¸å­˜åœ¨æ—¶è®¾ç½®
> - `NX`ï¼šNOT EXISTSï¼Œåªæœ‰keyä¸å­˜åœ¨æ‰è®¾ç½®æˆåŠŸ
> - `EX`ï¼šè¿‡æœŸæ—¶é—´ï¼Œé˜²æ­¢æ­»é”

### 2.2 Redisåˆ†å¸ƒå¼é”å®ç°


**ğŸ”¸ åŸºç¡€ç‰ˆæœ¬å®ç°**

```java
@Component
public class RedisDistributedLock {
    
    @Autowired
    private StringRedisTemplate redisTemplate;
    
    /**
     * åŠ é” - ç®€å•ç‰ˆæœ¬
     */
    public boolean tryLock(String key, String clientId, long expireTime) {
        // ä½¿ç”¨SETå‘½ä»¤çš„NXå’ŒEXé€‰é¡¹å®ç°åŸå­æ“ä½œ
        Boolean result = redisTemplate.opsForValue()
            .setIfAbsent(key, clientId, Duration.ofSeconds(expireTime));
        return Boolean.TRUE.equals(result);
    }
    
    /**
     * é‡Šæ”¾é” - ç®€å•ç‰ˆæœ¬ï¼ˆæœ‰é—®é¢˜ï¼‰
     */
    public void releaseLock(String key) {
        redisTemplate.delete(key);  // âŒ å¯èƒ½åˆ é™¤åˆ«äººçš„é”
    }
}
```

**âš ï¸ ä¸Šè¿°ä»£ç çš„é—®é¢˜**ï¼šå¯èƒ½ä¼šåˆ é™¤åˆ«äººçš„é”ï¼

**ğŸ”¸ æ”¹è¿›ç‰ˆæœ¬ï¼šå®‰å…¨é‡Šæ”¾é”**

```java
/**
 * å®‰å…¨é‡Šæ”¾é” - ä½¿ç”¨Luaè„šæœ¬ä¿è¯åŸå­æ€§
 */
public boolean releaseLock(String key, String clientId) {
    String luaScript = 
        "if redis.call('get', KEYS[1]) == ARGV[1] then " +
        "    return redis.call('del', KEYS[1]) " +
        "else " +
        "    return 0 " +
        "end";
    
    Long result = redisTemplate.execute(
        new DefaultRedisScript<>(luaScript, Long.class),
        Collections.singletonList(key),
        clientId
    );
    
    return result != null && result == 1;
}
```

> ğŸ’¡ **ä¸ºä»€ä¹ˆç”¨Luaè„šæœ¬**ï¼šç¡®ä¿"æ£€æŸ¥é”çš„æ‹¥æœ‰è€…"å’Œ"åˆ é™¤é”"è¿™ä¸¤ä¸ªæ“ä½œçš„åŸå­æ€§

### 2.3 Redisé”çš„ä¼˜åŒ–æ–¹æ¡ˆ


**ğŸ”¸ é”ç»­æœŸæœºåˆ¶ï¼ˆçœ‹é—¨ç‹—ï¼‰**

```java
@Component
public class RedisLockWithWatchdog {
    
    private final ScheduledExecutorService scheduler = 
        Executors.newScheduledThreadPool(1);
    
    public boolean lockWithWatchdog(String key, String clientId) {
        boolean locked = tryLock(key, clientId, 30); // 30ç§’è¿‡æœŸ
        
        if (locked) {
            // æ¯10ç§’ç»­æœŸä¸€æ¬¡
            ScheduledFuture<?> renewTask = scheduler.scheduleAtFixedRate(
                () -> renewLock(key, clientId), 10, 10, TimeUnit.SECONDS);
            
            // å­˜å‚¨ç»­æœŸä»»åŠ¡ï¼Œé‡Šæ”¾é”æ—¶å–æ¶ˆ
            renewTasks.put(key, renewTask);
        }
        
        return locked;
    }
    
    private void renewLock(String key, String clientId) {
        String luaScript = 
            "if redis.call('get', KEYS[1]) == ARGV[1] then " +
            "    return redis.call('expire', KEYS[1], ARGV[2]) " +
            "else " +
            "    return 0 " +
            "end";
        
        redisTemplate.execute(
            new DefaultRedisScript<>(luaScript, Long.class),
            Collections.singletonList(key),
            clientId, "30"  // ç»­æœŸ30ç§’
        );
    }
}
```

### 2.4 Redisé”çš„ç‰¹ç‚¹åˆ†æ


**âœ… ä¼˜ç‚¹**ï¼š
- **æ€§èƒ½é«˜**ï¼šRediså†…å­˜æ“ä½œï¼Œå“åº”å¿«
- **å®ç°ç®€å•**ï¼šå‡ è¡Œä»£ç å°±èƒ½å®ç°åŸºæœ¬åŠŸèƒ½
- **æ”¯æŒè¿‡æœŸ**ï¼šè‡ªåŠ¨é˜²æ­»é”
- **æˆæœ¬ä½**ï¼šå¤§éƒ¨åˆ†é¡¹ç›®éƒ½æœ‰Redis

**âš ï¸ ç¼ºç‚¹**ï¼š
- **å¯é æ€§ç›¸å¯¹è¾ƒä½**ï¼šRediså®•æœºé”å°±å¤±æ•ˆ
- **æ—¶é’Ÿä¾èµ–**ï¼šè¿‡æœŸæ—¶é—´ä¾èµ–ç³»ç»Ÿæ—¶é’Ÿ
- **è„‘è£‚é—®é¢˜**ï¼šä¸»ä»åˆ‡æ¢æ—¶å¯èƒ½å‡ºç°åŒä¸»

---

## 3. ğŸŸ¢ Zookeeperå®ç°åˆ†å¸ƒå¼é”


### 3.1 Zookeeperé”åŸºæœ¬åŸç†


**æ ¸å¿ƒæ€æƒ³**ï¼šåˆ©ç”¨ZooKeeperçš„é¡ºåºä¸´æ—¶èŠ‚ç‚¹ç‰¹æ€§

```
ZKåˆ†å¸ƒå¼é”æµç¨‹ï¼š
                ZooKeeperé›†ç¾¤
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
å®¢æˆ·ç«¯A          â”‚ /locks      â”‚
  |             â”‚   â”œâ”€ 001    â”‚ â† å®¢æˆ·ç«¯Aåˆ›å»º
  |-- åˆ›å»ºèŠ‚ç‚¹   â”‚   â”œâ”€ 002    â”‚ â† å®¢æˆ·ç«¯Båˆ›å»º  
  |             â”‚   â””â”€ 003    â”‚ â† å®¢æˆ·ç«¯Cåˆ›å»º
å®¢æˆ·ç«¯B          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  |             æœ€å°åºå·001è·å¾—é”
å®¢æˆ·ç«¯C          å…¶ä»–èŠ‚ç‚¹ç›‘å¬å‰ä¸€ä¸ªèŠ‚ç‚¹
```

> ğŸ“ **å…³é”®ç‰¹æ€§**ï¼š
> - **é¡ºåºèŠ‚ç‚¹**ï¼šZKè‡ªåŠ¨ä¸ºèŠ‚ç‚¹åˆ†é…é€’å¢åºå·
> - **ä¸´æ—¶èŠ‚ç‚¹**ï¼šå®¢æˆ·ç«¯æ–­å¼€è¿æ¥ï¼ŒèŠ‚ç‚¹è‡ªåŠ¨åˆ é™¤
> - **ç›‘å¬æœºåˆ¶**ï¼šå¯ä»¥ç›‘å¬èŠ‚ç‚¹å˜åŒ–äº‹ä»¶

### 3.2 Zookeeperåˆ†å¸ƒå¼é”å®ç°


**ğŸ”¸ åŸºäºCuratoræ¡†æ¶çš„å®ç°**

```java
@Component
public class ZookeeperDistributedLock {
    
    private CuratorFramework client;
    
    @PostConstruct
    public void init() {
        client = CuratorFrameworkFactory.builder()
            .connectString("localhost:2181")
            .retryPolicy(new ExponentialBackoffRetry(1000, 3))
            .build();
        client.start();
    }
    
    /**
     * è·å–åˆ†å¸ƒå¼é”
     */
    public InterProcessMutex getLock(String lockPath) {
        return new InterProcessMutex(client, lockPath);
    }
    
    /**
     * ä½¿ç”¨é”çš„ç¤ºä¾‹
     */
    public void doSomethingWithLock(String lockPath) {
        InterProcessMutex lock = getLock(lockPath);
        try {
            // å°è¯•è·å–é”ï¼Œæœ€å¤šç­‰å¾…10ç§’
            if (lock.acquire(10, TimeUnit.SECONDS)) {
                try {
                    // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
                    System.out.println("è·å¾—é”ï¼Œæ‰§è¡Œä¸šåŠ¡é€»è¾‘...");
                    Thread.sleep(5000); // æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç†
                } finally {
                    // é‡Šæ”¾é”
                    lock.release();
                }
            } else {
                System.out.println("è·å–é”è¶…æ—¶");
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

### 3.3 æ‰‹åŠ¨å®ç°ZKåˆ†å¸ƒå¼é”


```java
public class ZKDistributedLock {
    
    private ZooKeeper zk;
    private String lockPath = "/distributed-locks";
    
    public boolean acquireLock(String lockName, long timeoutMs) {
        try {
            String fullPath = lockPath + "/" + lockName + "-";
            
            // 1. åˆ›å»ºé¡ºåºä¸´æ—¶èŠ‚ç‚¹
            String currentPath = zk.create(
                fullPath, 
                new byte[0], 
                ZooDefs.Ids.OPEN_ACL_UNSAFE,
                CreateMode.EPHEMERAL_SEQUENTIAL
            );
            
            // 2. è·å–æ‰€æœ‰å­èŠ‚ç‚¹å¹¶æ’åº
            List<String> children = zk.getChildren(lockPath, false);
            Collections.sort(children);
            
            // 3. åˆ¤æ–­æ˜¯å¦æ˜¯æœ€å°èŠ‚ç‚¹
            String currentNodeName = currentPath.substring(
                (lockPath + "/").length()
            );
            
            if (children.get(0).equals(currentNodeName)) {
                return true; // è·å¾—é”
            }
            
            // 4. ç›‘å¬å‰ä¸€ä¸ªèŠ‚ç‚¹
            String previousNode = null;
            for (int i = 0; i < children.size(); i++) {
                if (children.get(i).equals(currentNodeName)) {
                    previousNode = children.get(i - 1);
                    break;
                }
            }
            
            if (previousNode != null) {
                CountDownLatch latch = new CountDownLatch(1);
                
                // ç›‘å¬å‰ä¸€ä¸ªèŠ‚ç‚¹çš„åˆ é™¤äº‹ä»¶
                Stat stat = zk.exists(lockPath + "/" + previousNode, event -> {
                    if (event.getType() == Watcher.Event.EventType.NodeDeleted) {
                        latch.countDown();
                    }
                });
                
                if (stat == null) {
                    return acquireLock(lockName, timeoutMs); // é€’å½’é‡è¯•
                }
                
                // ç­‰å¾…å‰ä¸€ä¸ªèŠ‚ç‚¹é‡Šæ”¾é”
                return latch.await(timeoutMs, TimeUnit.MILLISECONDS);
            }
            
            return false;
        } catch (Exception e) {
            return false;
        }
    }
}
```

### 3.4 Zookeeperé”ç‰¹ç‚¹åˆ†æ


**âœ… ä¼˜ç‚¹**ï¼š
- **å¯é æ€§é«˜**ï¼šåŸºäºä¸€è‡´æ€§åè®®ï¼Œå¼ºä¸€è‡´æ€§ä¿è¯
- **è‡ªåŠ¨å®¹é”™**ï¼šèŠ‚ç‚¹æ•…éšœè‡ªåŠ¨æ¢å¤
- **å…¬å¹³é”**ï¼šä¸¥æ ¼æŒ‰ç…§è¯·æ±‚é¡ºåºåˆ†é…é”
- **æ— æ­»é”**ï¼šå®¢æˆ·ç«¯æ–­å¼€è¿æ¥è‡ªåŠ¨é‡Šæ”¾é”

**âš ï¸ ç¼ºç‚¹**ï¼š
- **æ€§èƒ½è¾ƒä½**ï¼šç½‘ç»œé€šä¿¡å¼€é”€å¤§
- **å¤æ‚åº¦é«˜**ï¼šéœ€è¦ç»´æŠ¤ZKé›†ç¾¤
- **å»¶è¿Ÿè¾ƒé«˜**ï¼šéœ€è¦å¤šæ¬¡ç½‘ç»œå¾€è¿”

---

## 4. ğŸ”µ æ•°æ®åº“å®ç°åˆ†å¸ƒå¼é”


### 4.1 æ•°æ®åº“é”åŸºæœ¬åŸç†


**æ ¸å¿ƒæ€æƒ³**ï¼šåˆ©ç”¨æ•°æ®åº“çš„å”¯ä¸€ç´¢å¼•å’Œè¡Œé”æœºåˆ¶

```
æ•°æ®åº“é”è¡¨è®¾è®¡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id (ä¸»é”®)    â”‚ lock_name   â”‚ client_id   â”‚ expire_time â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1            â”‚ order_lock  â”‚ server_001  â”‚ 1632123456  â”‚
â”‚ 2            â”‚ user_lock   â”‚ server_002  â”‚ 1632123789  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å”¯ä¸€ç´¢å¼•ï¼šuk_lock_name (lock_name)
```

### 4.2 æ•°æ®åº“åˆ†å¸ƒå¼é”å®ç°


**ğŸ”¸ åŸºäºå”¯ä¸€ç´¢å¼•çš„å®ç°**

```sql
-- åˆ›å»ºåˆ†å¸ƒå¼é”è¡¨
CREATE TABLE distributed_lock (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    lock_name VARCHAR(255) NOT NULL COMMENT 'é”åç§°',
    client_id VARCHAR(255) NOT NULL COMMENT 'å®¢æˆ·ç«¯æ ‡è¯†',
    expire_time BIGINT NOT NULL COMMENT 'è¿‡æœŸæ—¶é—´æˆ³',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY uk_lock_name (lock_name)
) ENGINE=InnoDB;
```

```java
@Service
public class DatabaseDistributedLock {
    
    @Autowired
    private JdbcTemplate jdbcTemplate;
    
    /**
     * å°è¯•è·å–é”
     */
    public boolean tryLock(String lockName, String clientId, long timeoutSeconds) {
        long expireTime = System.currentTimeMillis() + timeoutSeconds * 1000;
        
        try {
            // å…ˆæ¸…ç†è¿‡æœŸé”
            cleanExpiredLock(lockName);
            
            // å°è¯•æ’å…¥é”è®°å½•
            String sql = "INSERT INTO distributed_lock (lock_name, client_id, expire_time) VALUES (?, ?, ?)";
            int rows = jdbcTemplate.update(sql, lockName, clientId, expireTime);
            
            return rows > 0;
        } catch (DuplicateKeyException e) {
            // é”å·²è¢«å…¶ä»–å®¢æˆ·ç«¯æŒæœ‰
            return false;
        }
    }
    
    /**
     * é‡Šæ”¾é”
     */
    public boolean releaseLock(String lockName, String clientId) {
        String sql = "DELETE FROM distributed_lock WHERE lock_name = ? AND client_id = ?";
        int rows = jdbcTemplate.update(sql, lockName, clientId);
        return rows > 0;
    }
    
    /**
     * æ¸…ç†è¿‡æœŸé”
     */
    private void cleanExpiredLock(String lockName) {
        String sql = "DELETE FROM distributed_lock WHERE lock_name = ? AND expire_time < ?";
        jdbcTemplate.update(sql, lockName, System.currentTimeMillis());
    }
}
```

**ğŸ”¸ åŸºäºSELECT FOR UPDATEçš„å®ç°**

```java
@Transactional
public void doWithLock(String lockName, Runnable task) {
    try {
        // ä½¿ç”¨SELECT FOR UPDATEåŠ è¡Œé”
        String sql = "SELECT * FROM lock_table WHERE lock_name = ? FOR UPDATE";
        jdbcTemplate.queryForMap(sql, lockName);
        
        // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
        task.run();
        
        // äº‹åŠ¡ç»“æŸè‡ªåŠ¨é‡Šæ”¾é”
    } catch (Exception e) {
        throw new RuntimeException("æ‰§è¡ŒåŠ é”ä»»åŠ¡å¤±è´¥", e);
    }
}
```

### 4.3 æ•°æ®åº“é”ç‰¹ç‚¹åˆ†æ


**âœ… ä¼˜ç‚¹**ï¼š
- **å®ç°ç®€å•**ï¼šä¸éœ€è¦é¢å¤–ç»„ä»¶ï¼Œåˆ©ç”¨ç°æœ‰æ•°æ®åº“
- **å¼ºä¸€è‡´æ€§**ï¼šä¾èµ–æ•°æ®åº“äº‹åŠ¡ä¿è¯
- **ç†è§£å®¹æ˜“**ï¼šå¼€å‘äººå‘˜éƒ½ç†Ÿæ‚‰æ•°æ®åº“æ“ä½œ

**âš ï¸ ç¼ºç‚¹**ï¼š
- **æ€§èƒ½è¾ƒå·®**ï¼šæ•°æ®åº“IOæ“ä½œï¼Œå“åº”æ…¢
- **å•ç‚¹é£é™©**ï¼šæ•°æ®åº“æ•…éšœå¯¼è‡´é”æœåŠ¡ä¸å¯ç”¨
- **æ­»é”é£é™©**ï¼šå¯èƒ½å‡ºç°æ•°æ®åº“æ­»é”
- **æ‰©å±•æ€§å·®**ï¼šæ•°æ®åº“è¿æ¥æ•°é™åˆ¶

---

## 5. âš–ï¸ æ–¹æ¡ˆå…¨é¢å¯¹æ¯”åˆ†æ


### 5.1 æ€§èƒ½å¯¹æ¯”åˆ†æ


| æ–¹æ¡ˆ | **å»¶è¿Ÿ** | **ååé‡** | **ç½‘ç»œå¼€é”€** | **æ€§èƒ½è¯„çº§** |
|------|---------|-----------|-------------|-------------|
| ğŸ”´ **Redis** | `1-5ms` | `æé«˜` | `æœ€å°` | â˜…â˜…â˜…â˜…â˜… |
| ğŸŸ¢ **Zookeeper** | `10-50ms` | `ä¸­ç­‰` | `è¾ƒå¤§` | â˜…â˜…â˜…â˜†â˜† |
| ğŸ”µ **æ•°æ®åº“** | `50-200ms` | `è¾ƒä½` | `ä¸­ç­‰` | â˜…â˜…â˜†â˜†â˜† |

```
æ€§èƒ½æµ‹è¯•å¯¹æ¯”ï¼ˆQPSï¼‰ï¼š
Redisé”ï¼š      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 20000+ QPS
Zookeeperé”ï¼š  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 8000 QPS  
æ•°æ®åº“é”ï¼š     â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 4000 QPS
```

### 5.2 å¯é æ€§å¯¹æ¯”åˆ†æ


| ç»´åº¦ | **Redis** | **Zookeeper** | **æ•°æ®åº“** |
|------|----------|---------------|-----------|
| **ä¸€è‡´æ€§ä¿è¯** | `æœ€ç»ˆä¸€è‡´` | `å¼ºä¸€è‡´` | `å¼ºä¸€è‡´` |
| **å•ç‚¹æ•…éšœ** | `å­˜åœ¨é£é™©` | `è‡ªåŠ¨æ¢å¤` | `å­˜åœ¨é£é™©` |
| **è„‘è£‚é—®é¢˜** | `å¯èƒ½å‘ç”Ÿ` | `æœ‰æ•ˆé˜²æ­¢` | `å–å†³äºå®ç°` |
| **æ•°æ®æŒä¹…åŒ–** | `å¯é…ç½®` | `å¼ºæŒä¹…åŒ–` | `å¼ºæŒä¹…åŒ–` |
| **å¯é æ€§è¯„çº§** | â˜…â˜…â˜…â˜†â˜† | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜…â˜…â˜† |

> ğŸ’¡ **å¯é æ€§è¯´æ˜**ï¼š
> - **Redis**ï¼šä¸»ä»åˆ‡æ¢æ—¶å­˜åœ¨çŸ­æš‚ä¸ä¸€è‡´çª—å£
> - **Zookeeper**ï¼šåŸºäºRaftåè®®ï¼Œå¼ºä¸€è‡´æ€§ä¿è¯
> - **æ•°æ®åº“**ï¼šä¾èµ–æ•°æ®åº“è‡ªèº«çš„ä¸€è‡´æ€§æœºåˆ¶

### 5.3 è¿ç»´å¤æ‚åº¦å¯¹æ¯”


**ğŸ”¸ éƒ¨ç½²éš¾åº¦æ’åº**ï¼š
```
Redisé”    < æ•°æ®åº“é”    < Zookeeperé”
 (ç®€å•)       (ä¸­ç­‰)        (å¤æ‚)
```

**ğŸ”¸ ç›‘æ§æŒ‡æ ‡å¯¹æ¯”**ï¼š

| æ–¹æ¡ˆ | **éœ€è¦ç›‘æ§çš„æŒ‡æ ‡** |
|------|------------------|
| **Redis** | â€¢ è¿æ¥æ•°ã€å†…å­˜ä½¿ç”¨ç‡<br>â€¢ ä¸»ä»å»¶è¿Ÿã€æ•…éšœè½¬ç§» |
| **Zookeeper** | â€¢ é›†ç¾¤çŠ¶æ€ã€é€‰ä¸¾çŠ¶æ€<br>â€¢ ä¼šè¯æ•°ã€ç£ç›˜ç©ºé—´<br>â€¢ ç½‘ç»œåˆ†åŒºæ£€æµ‹ |
| **æ•°æ®åº“** | â€¢ è¿æ¥æ± ã€é”ç­‰å¾…æ—¶é—´<br>â€¢ æ­»é”æ£€æµ‹ã€æ…¢æŸ¥è¯¢ |

### 5.4 æˆæœ¬è€ƒè™‘å¯¹æ¯”


**ğŸ”¸ èµ„æºæ¶ˆè€—åˆ†æ**ï¼š

```
å†…å­˜æ¶ˆè€—ï¼š
Redis     â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘ 40% (çº¯å†…å­˜æ“ä½œ)
Zookeeper â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘ 60% (å†…å­˜+ç£ç›˜)  
Database  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 80% (è¿æ¥æ± +å­˜å‚¨)

è¿ç»´æˆæœ¬ï¼š
Redis     â–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 20% (ç›¸å¯¹ç®€å•)
Database  â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘ 40% (ç°æœ‰åŸºç¡€è®¾æ–½)
Zookeeper â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 80% (ä¸“é—¨é›†ç¾¤ç»´æŠ¤)
```

---

## 6. ğŸ¯ é€‰å‹å†³ç­–æŒ‡å—


### 6.1 åœºæ™¯é©±åŠ¨çš„é€‰å‹ç­–ç•¥


**ğŸ”¸ é«˜æ€§èƒ½åœºæ™¯ â†’ Redisé”**
```
é€‚ç”¨åœºæ™¯ï¼š
âœ… ç”µå•†ç§’æ€ã€é«˜å¹¶å‘æ‰£åº“å­˜
âœ… æ¥å£é™æµã€é˜²é‡å¤æäº¤  
âœ… ç¼“å­˜æ›´æ–°åŒæ­¥
âœ… å¯¹æ€§èƒ½è¦æ±‚æé«˜çš„åœºæ™¯

å…¸å‹QPSï¼š> 10000
å»¶è¿Ÿè¦æ±‚ï¼š< 10ms
```

**ğŸ”¸ é«˜å¯é åœºæ™¯ â†’ Zookeeperé”**
```
é€‚ç”¨åœºæ™¯ï¼š
âœ… é‡‘èäº¤æ˜“ã€èµ„é‡‘æ“ä½œ
âœ… åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦
âœ… é…ç½®ç®¡ç†ã€ä¸»ä»é€‰ä¸¾
âœ… å¯¹ä¸€è‡´æ€§è¦æ±‚æé«˜çš„åœºæ™¯

å¯é æ€§è¦æ±‚ï¼š99.99%+
ä¸€è‡´æ€§è¦æ±‚ï¼šå¼ºä¸€è‡´æ€§
```

**ğŸ”¸ æˆæœ¬ä¼˜å…ˆåœºæ™¯ â†’ æ•°æ®åº“é”**
```
é€‚ç”¨åœºæ™¯ï¼š
âœ… å°å‹é¡¹ç›®ã€åˆæœŸå¿«é€Ÿä¸Šçº¿
âœ… å·²æœ‰æ•°æ®åº“åŸºç¡€è®¾æ–½
âœ… å¯¹æ€§èƒ½è¦æ±‚ä¸é«˜
âœ… é”ä½¿ç”¨é¢‘ç‡è¾ƒä½çš„åœºæ™¯

é¢„ç®—é™åˆ¶ï¼šç´§å¼ 
å›¢é˜ŸæŠ€æœ¯æ ˆï¼šä¼ ç»ŸJavaWeb
```

### 6.2 é€‰å‹å†³ç­–æµç¨‹å›¾


```
å¼€å§‹é€‰å‹
    |
    â–¼
å¹¶å‘é‡ > 10000 QPSï¼Ÿ
    |          |
   æ˜¯          å¦
    |          |
    â–¼          â–¼
Redisé”    å¯¹ä¸€è‡´æ€§è¦æ±‚æé«˜ï¼Ÿ
    |          |          |
    |         æ˜¯          å¦  
    |          |          |
    |          â–¼          â–¼
    |    Zookeeperé”   æ•°æ®åº“é”
    |          |          |
    â–¼          â–¼          â–¼
æ€§èƒ½æœ€ä¼˜   å¯é æ€§æœ€ä¼˜   æˆæœ¬æœ€ä¼˜
```

### 6.3 æ··åˆæ–¹æ¡ˆå»ºè®®


**ğŸ”¸ åˆ†å±‚é”ç­–ç•¥**

```java
@Service
public class HybridLockService {
    
    @Autowired
    private RedisDistributedLock redisLock;
    
    @Autowired  
    private ZookeeperDistributedLock zkLock;
    
    /**
     * åˆ†å±‚é”ï¼šRedisåšå¿«é€Ÿè¿‡æ»¤ï¼ŒZKä¿è¯æœ€ç»ˆä¸€è‡´æ€§
     */
    public boolean acquireHybridLock(String key, String clientId) {
        // ç¬¬ä¸€å±‚ï¼šRediså¿«é€Ÿè¿‡æ»¤
        if (!redisLock.tryLock(key, clientId, 30)) {
            return false;  // Rediså±‚é¢å°±è·å–ä¸åˆ°ï¼Œå¿«é€Ÿå¤±è´¥
        }
        
        try {
            // ç¬¬äºŒå±‚ï¼šZookeeperç¡®ä¿å¼ºä¸€è‡´æ€§
            return zkLock.tryLock(key, clientId, 30);
        } finally {
            // æ— è®ºZKæ˜¯å¦æˆåŠŸï¼Œéƒ½è¦é‡Šæ”¾Redisé”
            if (!zkLock.isLocked(key, clientId)) {
                redisLock.releaseLock(key, clientId);
            }
        }
    }
}
```

---

## 7. ğŸ› ï¸ æœ€ä½³å®è·µä¸æ€»ç»“


### 7.1 åˆ†å¸ƒå¼é”ä½¿ç”¨æœ€ä½³å®è·µ


**ğŸ”¸ é”ç²’åº¦æ§åˆ¶**
```java
// âŒ é”™è¯¯ï¼šé”ç²’åº¦è¿‡å¤§
public void updateUser(User user) {
    lock("global_user_lock");  // æ‰€æœ‰ç”¨æˆ·æ›´æ–°éƒ½è¢«é˜»å¡
    // ...
}

// âœ… æ­£ç¡®ï¼šé”ç²’åº¦åˆé€‚
public void updateUser(User user) {
    lock("user_lock_" + user.getId());  // åªé”å®šç‰¹å®šç”¨æˆ·
    // ...
}
```

**ğŸ”¸ é¿å…é•¿æ—¶é—´æŒé”**
```java
// âŒ é”™è¯¯ï¼šæŒé”æ—¶é—´å¤ªé•¿
public void processOrder(String orderId) {
    if (lock("order_" + orderId)) {
        try {
            // å¤æ‚ä¸šåŠ¡å¤„ç†ï¼Œå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿ
            complexBusinessLogic();
            
            // è¿œç¨‹è°ƒç”¨ï¼Œå¯èƒ½è¶…æ—¶
            remoteService.call();
        } finally {
            unlock("order_" + orderId);
        }
    }
}

// âœ… æ­£ç¡®ï¼šå‡å°‘æŒé”æ—¶é—´
public void processOrder(String orderId) {
    // å‡†å¤‡å·¥ä½œ
    prepareData();
    
    // åªåœ¨å¿…è¦æ—¶æŒé”
    if (lock("order_" + orderId)) {
        try {
            // ä»…åšæ ¸å¿ƒåŸå­æ“ä½œ
            atomicOperation();
        } finally {
            unlock("order_" + orderId);
        }
    }
    
    // åç»­å¤„ç†
    postProcess();
}
```

**ğŸ”¸ é”è¶…æ—¶å’Œé‡è¯•ç­–ç•¥**
```java
@Component
public class LockRetryTemplate {
    
    /**
     * å¸¦é‡è¯•çš„é”è·å–
     */
    public <T> T executeWithLock(String lockKey, String clientId, 
                                 int maxRetry, long timeoutMs,
                                 Supplier<T> task) {
        
        int retryCount = 0;
        while (retryCount < maxRetry) {
            try {
                if (tryLock(lockKey, clientId, timeoutMs)) {
                    try {
                        return task.get();
                    } finally {
                        releaseLock(lockKey, clientId);
                    }
                }
            } catch (Exception e) {
                log.warn("é”æ“ä½œå¼‚å¸¸ï¼Œé‡è¯•ä¸­... retry={}", retryCount, e);
            }
            
            retryCount++;
            try {
                Thread.sleep(100 * retryCount);  // é€€é¿é‡è¯•
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
                throw new RuntimeException("çº¿ç¨‹è¢«ä¸­æ–­", e);
            }
        }
        
        throw new RuntimeException("è·å–åˆ†å¸ƒå¼é”å¤±è´¥ï¼Œå·²é‡è¯•" + maxRetry + "æ¬¡");
    }
}
```

### 7.2 æ–¹æ¡ˆé€‰å‹å†³ç­–è¡¨


| è¯„ä¼°ç»´åº¦ | **æƒé‡** | **Redis** | **Zookeeper** | **æ•°æ®åº“** |
|---------|---------|----------|--------------|-----------|
| ğŸš€ æ€§èƒ½è¡¨ç° | 30% | ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ | ğŸŒŸğŸŒŸğŸŒŸâ­â­ | ğŸŒŸğŸŒŸâ­â­â­ |
| ğŸ”’ å¯é æ€§ | 25% | ğŸŒŸğŸŒŸğŸŒŸâ­â­ | ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ | ğŸŒŸğŸŒŸğŸŒŸğŸŒŸâ­ |
| ğŸ’° æˆæœ¬æ§åˆ¶ | 20% | ğŸŒŸğŸŒŸğŸŒŸğŸŒŸâ­ | ğŸŒŸğŸŒŸâ­â­â­ | ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ |
| ğŸ› ï¸ è¿ç»´å¤æ‚åº¦ | 15% | ğŸŒŸğŸŒŸğŸŒŸğŸŒŸâ­ | ğŸŒŸğŸŒŸâ­â­â­ | ğŸŒŸğŸŒŸğŸŒŸâ­â­ |
| ğŸ“ˆ æ‰©å±•æ€§ | 10% | ğŸŒŸğŸŒŸğŸŒŸğŸŒŸâ­ | ğŸŒŸğŸŒŸğŸŒŸğŸŒŸâ­ | ğŸŒŸğŸŒŸâ­â­â­ |

> ğŸ¯ **æ¨èæŒ‡æ•°è®¡ç®—**ï¼š
> - **Redisé”**ï¼š4.1/5 â­â­â­â­â­ `é«˜æ€§èƒ½åœºæ™¯é¦–é€‰`
> - **Zookeeperé”**ï¼š3.6/5 â­â­â­â­â­ `é«˜å¯é æ€§åœºæ™¯é¦–é€‰`  
> - **æ•°æ®åº“é”**ï¼š3.4/5 â­â­â­â­â­ `å¿«é€Ÿä¸Šçº¿æ–¹æ¡ˆ`

### 7.3 æ ¸å¿ƒè¦ç‚¹æ€»ç»“


**ğŸ”¸ æ ¸å¿ƒç†è§£**ï¼š
```
åˆ†å¸ƒå¼é”çš„æœ¬è´¨ = åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­å®ç°äº’æ–¥è®¿é—®
å…³é”®æ˜¯è¦ç†è§£æ¯ç§æ–¹æ¡ˆçš„é€‚ç”¨åœºæ™¯å’Œæƒè¡¡å–èˆ
æ²¡æœ‰é“¶å¼¹ï¼Œåªæœ‰æœ€åˆé€‚çš„æ–¹æ¡ˆ
```

**ğŸ”¸ é€‰å‹ä¸‰è¦ç´ **ï¼š
1. **æ€§èƒ½éœ€æ±‚**ï¼šé«˜å¹¶å‘é€‰Redisï¼Œå¯é æ€§é€‰ZKï¼Œå¿«é€Ÿä¸Šçº¿é€‰DB
2. **å›¢é˜ŸæŠ€æœ¯æ ˆ**ï¼šé€‰æ‹©å›¢é˜Ÿæœ€ç†Ÿæ‚‰çš„æŠ€æœ¯
3. **è¿ç»´æˆæœ¬**ï¼šè€ƒè™‘é•¿æœŸç»´æŠ¤æˆæœ¬

**ğŸ”¸ å®æ–½å»ºè®®**ï¼š
- **ä»ç®€å•å¼€å§‹**ï¼šå…ˆç”¨æ•°æ®åº“é”éªŒè¯ä¸šåŠ¡é€»è¾‘
- **é€æ­¥æ¼”è¿›**ï¼šæ ¹æ®æ€§èƒ½ç“¶é¢ˆé€‰æ‹©åˆé€‚æ–¹æ¡ˆ
- **ç›‘æ§å®Œå–„**ï¼šå»ºç«‹å®Œå–„çš„é”ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶
- **å®¹é”™å¤„ç†**ï¼šåšå¥½å¼‚å¸¸æƒ…å†µçš„å…œåº•æ–¹æ¡ˆ

> ğŸ’¡ **è®°å¿†å£è¯€**ï¼š
> Rediså¿«å¦‚é—ªç”µï¼ŒZKç¨³å¦‚æ³°å±±ï¼Œæ•°æ®åº“çœé’±çœå¿ƒ
> æ€§èƒ½è¦æ±‚é€‰Redisï¼Œå¯é è¦æ±‚é€‰ZKï¼Œé¢„ç®—ç´§å¼ é€‰æ•°æ®åº“