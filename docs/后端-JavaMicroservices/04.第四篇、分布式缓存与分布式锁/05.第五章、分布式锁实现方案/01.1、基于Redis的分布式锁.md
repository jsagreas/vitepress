---
title: 1ã€åŸºäºRedisçš„åˆ†å¸ƒå¼é”
---
## ğŸ“š ç›®å½•

1. [åˆ†å¸ƒå¼é”çš„åŸºæœ¬æ¦‚å¿µ](#1-åˆ†å¸ƒå¼é”çš„åŸºæœ¬æ¦‚å¿µ)
2. [Redisåˆ†å¸ƒå¼é”çš„å®ç°åŸç†](#2-redisåˆ†å¸ƒå¼é”çš„å®ç°åŸç†)
3. [åŸºç¡€å®ç°ï¼šSETNXå‘½ä»¤](#3-åŸºç¡€å®ç°setnxå‘½ä»¤)
4. [è¿›é˜¶å®ç°ï¼šSETå‘½ä»¤å‚æ•°](#4-è¿›é˜¶å®ç°setå‘½ä»¤å‚æ•°)
5. [Luaè„šæœ¬ä¿è¯åŸå­æ€§](#5-luaè„šæœ¬ä¿è¯åŸå­æ€§)
6. [é”ç»­æœŸä¸è‡ªåŠ¨å»¶æœŸ](#6-é”ç»­æœŸä¸è‡ªåŠ¨å»¶æœŸ)
7. [ä¸»ä»ä¸€è‡´æ€§é—®é¢˜å¤„ç†](#7-ä¸»ä»ä¸€è‡´æ€§é—®é¢˜å¤„ç†)
8. [RedLockç®—æ³•è¯¦è§£](#8-redlockç®—æ³•è¯¦è§£)
9. [é”é‡è¯•ä¸ç«äº‰å¤„ç†](#9-é”é‡è¯•ä¸ç«äº‰å¤„ç†)
10. [æ€§èƒ½ä¼˜åŒ–ä¸å¼‚å¸¸å¤„ç†](#10-æ€§èƒ½ä¼˜åŒ–ä¸å¼‚å¸¸å¤„ç†)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”’ åˆ†å¸ƒå¼é”çš„åŸºæœ¬æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼é”


**ğŸ’¡ ç”Ÿæ´»ç±»æ¯”**
> æƒ³è±¡ä¸€ä¸‹å…¬å¸çš„ä¼šè®®å®¤é¢„è®¢ç³»ç»Ÿï¼š
> - å•ä½“åº”ç”¨ï¼šå°±åƒå°å…¬å¸åªæœ‰ä¸€ä¸ªä¼šè®®å®¤ï¼Œå¤§å®¶æ’é˜Ÿä½¿ç”¨
> - åˆ†å¸ƒå¼ç³»ç»Ÿï¼šåƒå¤§å…¬å¸æœ‰å¤šä¸ªåˆ†éƒ¨ï¼Œéƒ½è¦äº‰æŠ¢åŒä¸€ä¸ªä¼šè®®å®¤

**ğŸ¯ æ ¸å¿ƒå®šä¹‰**
```
åˆ†å¸ƒå¼é”ï¼šåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¤šä¸ªèŠ‚ç‚¹éœ€è¦è®¿é—®å…±äº«èµ„æºæ—¶ï¼Œ
ç”¨æ¥ç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹èƒ½è·å¾—è®¿é—®æƒé™çš„æœºåˆ¶
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”


**ğŸ”¸ å•æœºé”çš„å±€é™**
```
å•æœºç¯å¢ƒï¼š
åº”ç”¨A â”€â”€â†’ synchronized â”€â”€â†’ å…±äº«èµ„æº
âœ… å¯ä»¥æ­£å¸¸å·¥ä½œ

åˆ†å¸ƒå¼ç¯å¢ƒï¼š
åº”ç”¨A â”€â”€â†’ synchronized â”€â”€â†’ âŒ æ— æ³•æ§åˆ¶
åº”ç”¨B â”€â”€â†’ synchronized â”€â”€â†’ âŒ å„è‡ªä¸ºæ”¿  â”€â”€â†’ å…±äº«èµ„æº
åº”ç”¨C â”€â”€â†’ synchronized â”€â”€â†’ âŒ å‡ºç°å†²çª
```

**âš ï¸ å…¸å‹é—®é¢˜åœºæ™¯**
- **åº“å­˜æ‰£å‡**ï¼šå¤šä¸ªæœåŠ¡åŒæ—¶å‡åº“å­˜ï¼Œå‡ºç°è´Ÿæ•°
- **è®¢å•å·ç”Ÿæˆ**ï¼šå¤šä¸ªå®ä¾‹ç”Ÿæˆç›¸åŒè®¢å•å·
- **å®šæ—¶ä»»åŠ¡**ï¼šå¤šä¸ªèŠ‚ç‚¹é‡å¤æ‰§è¡ŒåŒä¸€ä»»åŠ¡

### 1.3 åˆ†å¸ƒå¼é”çš„æ ¸å¿ƒç‰¹å¾


**ğŸ“‹ å¿…é¡»å…·å¤‡çš„ç‰¹æ€§**
```
ğŸ”¸ äº’æ–¥æ€§ï¼šåŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯èƒ½è·å¾—é”
ğŸ”¸ å®‰å…¨æ€§ï¼šåªæœ‰åŠ é”çš„å®¢æˆ·ç«¯æ‰èƒ½é‡Šæ”¾é”
ğŸ”¸ æ´»æ€§ï¼šé¿å…æ­»é”ï¼Œå³ä½¿å®¢æˆ·ç«¯å´©æºƒä¹Ÿèƒ½é‡Šæ”¾é”
ğŸ”¸ å®¹é”™æ€§ï¼šéƒ¨åˆ†èŠ‚ç‚¹æ•…éšœä¸å½±å“é”çš„æ­£å¸¸å·¥ä½œ
ğŸ”¸ é«˜æ€§èƒ½ï¼šè·å–å’Œé‡Šæ”¾é”çš„å¼€é”€è¦å°
```

---

## 2. âš™ï¸ Redisåˆ†å¸ƒå¼é”çš„å®ç°åŸç†


### 2.1 ä¸ºä»€ä¹ˆé€‰æ‹©Redis


**ğŸ¯ Redisçš„ä¼˜åŠ¿**
```
âœ… å•çº¿ç¨‹æ¨¡å‹ï¼šå¤©ç„¶ä¿è¯å‘½ä»¤æ‰§è¡Œçš„åŸå­æ€§
âœ… é«˜æ€§èƒ½ï¼šå†…å­˜æ“ä½œï¼Œå“åº”é€Ÿåº¦å¿«
âœ… æ”¯æŒè¿‡æœŸæ—¶é—´ï¼šè‡ªåŠ¨é‡Šæ”¾é”ï¼Œé˜²æ­¢æ­»é”
âœ… ä¸°å¯Œçš„æ•°æ®ç»“æ„å’Œå‘½ä»¤
âœ… é›†ç¾¤æ”¯æŒï¼šå¯æ‰©å±•æ€§å¥½
```

### 2.2 åŸºæœ¬å®ç°æ€è·¯


**ğŸ”§ æ ¸å¿ƒæ€è·¯**
```
åŠ é”è¿‡ç¨‹ï¼š
1. å°è¯•è®¾ç½®ä¸€ä¸ªkey-value
2. å¦‚æœkeyä¸å­˜åœ¨ï¼Œè®¾ç½®æˆåŠŸ â†’ è·å¾—é”
3. å¦‚æœkeyå·²å­˜åœ¨ï¼Œè®¾ç½®å¤±è´¥ â†’ è·å–é”å¤±è´¥

é‡Šæ”¾é”è¿‡ç¨‹ï¼š
1. éªŒè¯é”çš„æŒæœ‰è€…
2. åˆ é™¤key â†’ é‡Šæ”¾é”
```

**ğŸ—ï¸ æ¶æ„ç¤ºæ„å›¾**
```
å®¢æˆ·ç«¯A     å®¢æˆ·ç«¯B     å®¢æˆ·ç«¯C
   |           |           |
   |     Redis Server      |
   |    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    |
   â””â”€â”€â”€â†’â”‚ key: lock   â”‚â†â”€â”€â”€â”˜
        â”‚ value: A    â”‚
        â”‚ ttl: 30s    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. ğŸ¯ åŸºç¡€å®ç°ï¼šSETNXå‘½ä»¤


### 3.1 SETNXå‘½ä»¤è¯¦è§£


**ğŸ“– å‘½ä»¤å«ä¹‰**
```
SETNX key value
SET if Not eXists - å½“keyä¸å­˜åœ¨æ—¶æ‰è®¾ç½®value

è¿”å›å€¼ï¼š
1 - è®¾ç½®æˆåŠŸï¼ˆè·å¾—é”ï¼‰
0 - keyå·²å­˜åœ¨ï¼ˆè·å–é”å¤±è´¥ï¼‰
```

### 3.2 ç®€å•å®ç°ç¤ºä¾‹


```java
public class SimpleRedisLock {
    private Jedis jedis;
    private String lockKey;
    private String lockValue;
    
    public SimpleRedisLock(Jedis jedis, String lockKey) {
        this.jedis = jedis;
        this.lockKey = lockKey;
        this.lockValue = UUID.randomUUID().toString(); // å”¯ä¸€æ ‡è¯†
    }
    
    // å°è¯•è·å–é”
    public boolean tryLock() {
        // ä½¿ç”¨SETNXè®¾ç½®é”
        Long result = jedis.setnx(lockKey, lockValue);
        return result == 1;
    }
    
    // é‡Šæ”¾é”
    public void unlock() {
        // éªŒè¯æ˜¯å¦æ˜¯è‡ªå·±çš„é”
        String currentValue = jedis.get(lockKey);
        if (lockValue.equals(currentValue)) {
            jedis.del(lockKey);
        }
    }
}
```

### 3.3 SETNXçš„é—®é¢˜


**âš ï¸ è‡´å‘½ç¼ºé™·**
```
é—®é¢˜1ï¼šæ­»é”é£é™©
å¦‚æœå®¢æˆ·ç«¯è·å–é”åå´©æºƒï¼Œé”æ°¸è¿œä¸ä¼šè¢«é‡Šæ”¾

é—®é¢˜2ï¼šé‡Šæ”¾é”çš„åŸå­æ€§
getå’Œdelæ˜¯ä¸¤ä¸ªå‘½ä»¤ï¼Œä¸­é—´å¯èƒ½è¢«å…¶ä»–å®¢æˆ·ç«¯æ’å…¥
```

**ğŸ’­ ç”Ÿæ´»ç±»æ¯”**
> å°±åƒæœ‰äººå€Ÿäº†ä¼šè®®å®¤é’¥åŒ™åå¤±è¸ªäº†ï¼Œä¼šè®®å®¤æ°¸è¿œè¢«é”ä½ï¼Œ
> æˆ–è€…æœ‰äººå†’å……å€Ÿé’¥åŒ™çš„äººæ¥è¿˜é’¥åŒ™

---

## 4. ğŸš€ è¿›é˜¶å®ç°ï¼šSETå‘½ä»¤å‚æ•°


### 4.1 SETå‘½ä»¤çš„å¼ºå¤§å‚æ•°


**ğŸ“ å®Œæ•´è¯­æ³•**
```
SET key value [EX seconds] [PX milliseconds] [NX|XX]

å‚æ•°è¯´æ˜ï¼š
EX seconds    - è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
PX milliseconds - è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
NX           - åªåœ¨keyä¸å­˜åœ¨æ—¶è®¾ç½®ï¼ˆç±»ä¼¼SETNXï¼‰
XX           - åªåœ¨keyå­˜åœ¨æ—¶è®¾ç½®
```

### 4.2 åŸå­æ€§åŠ é”


```java
public class RedisDistributedLock {
    private Jedis jedis;
    private String lockKey;
    private String lockValue;
    private int expireTime = 30; // é»˜è®¤30ç§’è¿‡æœŸ
    
    public RedisDistributedLock(Jedis jedis, String lockKey) {
        this.jedis = jedis;
        this.lockKey = lockKey;
        this.lockValue = UUID.randomUUID().toString();
    }
    
    /**
     * å°è¯•è·å–é”
     * @param expireTime é”çš„è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
     * @return true-è·å–æˆåŠŸï¼Œfalse-è·å–å¤±è´¥
     */
    public boolean tryLock(int expireTime) {
        // åŸå­æ€§æ“ä½œï¼šè®¾ç½®keyå¹¶è®¾ç½®è¿‡æœŸæ—¶é—´
        String result = jedis.set(lockKey, lockValue, 
            SetParams.setParams().nx().ex(expireTime));
        return "OK".equals(result);
    }
    
    /**
     * é˜»å¡å¼è·å–é”
     * @param expireTime é”çš„è¿‡æœŸæ—¶é—´
     * @param timeout è·å–é”çš„æœ€å¤§ç­‰å¾…æ—¶é—´
     */
    public boolean lock(int expireTime, long timeout) {
        long startTime = System.currentTimeMillis();
        
        while (System.currentTimeMillis() - startTime < timeout) {
            if (tryLock(expireTime)) {
                return true;
            }
            
            try {
                Thread.sleep(100); // ç­‰å¾…100msåé‡è¯•
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
                return false;
            }
        }
        return false;
    }
}
```

### 4.3 è§£å†³çš„é—®é¢˜


**âœ… æ”¹è¿›æ•ˆæœ**
```
âœ… è§£å†³æ­»é”ï¼šé€šè¿‡EXå‚æ•°è®¾ç½®è¿‡æœŸæ—¶é—´
âœ… åŸå­æ€§ï¼šSETå‘½ä»¤ä¸€æ¬¡æ€§å®Œæˆè®¾ç½®å’Œè¿‡æœŸæ—¶é—´
âœ… äº’æ–¥æ€§ï¼šé€šè¿‡NXå‚æ•°ä¿è¯åªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯èƒ½è®¾ç½®æˆåŠŸ
```

---

## 5. ğŸ”„ Luaè„šæœ¬ä¿è¯åŸå­æ€§


### 5.1 ä¸ºä»€ä¹ˆéœ€è¦Luaè„šæœ¬


**âŒ é‡Šæ”¾é”çš„é—®é¢˜**
```java
// è¿™ç§æ–¹å¼æœ‰é—®é¢˜ï¼
public void unlock() {
    String currentValue = jedis.get(lockKey);  // å‘½ä»¤1
    if (lockValue.equals(currentValue)) {
        jedis.del(lockKey);                    // å‘½ä»¤2
    }
}
```

**âš ï¸ é—®é¢˜åˆ†æ**
```
æ—¶é—´çº¿é—®é¢˜ï¼š
T1: å®¢æˆ·ç«¯Aæ‰§è¡Œgetï¼Œè·å¾—è‡ªå·±çš„lockValue
T2: å®¢æˆ·ç«¯Açš„é”åˆšå¥½è¿‡æœŸï¼Œè¢«Redisè‡ªåŠ¨åˆ é™¤
T3: å®¢æˆ·ç«¯Bè·å¾—äº†é”ï¼Œè®¾ç½®äº†è‡ªå·±çš„lockValue  
T4: å®¢æˆ·ç«¯Aæ‰§è¡Œdelï¼Œé”™è¯¯åˆ é™¤äº†å®¢æˆ·ç«¯Bçš„é”ï¼
```

### 5.2 Luaè„šæœ¬è§£å†³æ–¹æ¡ˆ


**ğŸ’¡ Luaè„šæœ¬çš„ä¼˜åŠ¿**
```
ğŸ”¸ åŸå­æ€§ï¼šRedisä¿è¯Luaè„šæœ¬æ‰§è¡Œçš„åŸå­æ€§
ğŸ”¸ æœåŠ¡ç«¯æ‰§è¡Œï¼šå‡å°‘ç½‘ç»œé€šä¿¡
ğŸ”¸ é€»è¾‘å®Œæ•´ï¼šå¯ä»¥ç¼–å†™å¤æ‚çš„æ¡ä»¶åˆ¤æ–­
```

**ğŸ”§ é‡Šæ”¾é”çš„Luaè„šæœ¬**
```lua
-- unlock.lua
if redis.call("get", KEYS[1]) == ARGV[1] then
    return redis.call("del", KEYS[1])
else
    return 0
end
```

```java
public class LuaRedisLock {
    private Jedis jedis;
    private String lockKey;
    private String lockValue;
    
    // é‡Šæ”¾é”çš„Luaè„šæœ¬
    private static final String UNLOCK_SCRIPT = 
        "if redis.call('get', KEYS[1]) == ARGV[1] then " +
        "return redis.call('del', KEYS[1]) " +
        "else return 0 end";
    
    public boolean tryLock(int expireTime) {
        String result = jedis.set(lockKey, lockValue, 
            SetParams.setParams().nx().ex(expireTime));
        return "OK".equals(result);
    }
    
    /**
     * å®‰å…¨é‡Šæ”¾é”
     * @return true-é‡Šæ”¾æˆåŠŸï¼Œfalse-ä¸æ˜¯è‡ªå·±çš„é”
     */
    public boolean unlock() {
        // æ‰§è¡ŒLuaè„šæœ¬
        Object result = jedis.eval(UNLOCK_SCRIPT, 
            Collections.singletonList(lockKey), 
            Collections.singletonList(lockValue));
        return Long.valueOf(1).equals(result);
    }
}
```

### 5.3 ç»­æœŸçš„Luaè„šæœ¬


```lua
-- renew.lua  
-- ç»­æœŸè„šæœ¬ï¼šå¦‚æœé”è¿˜æ˜¯è‡ªå·±çš„ï¼Œå°±å»¶é•¿è¿‡æœŸæ—¶é—´
if redis.call("get", KEYS[1]) == ARGV[1] then
    return redis.call("expire", KEYS[1], ARGV[2])
else
    return 0
end
```

```java
/**
 * ç»­æœŸæ“ä½œ
 * @param expireTime æ–°çš„è¿‡æœŸæ—¶é—´
 * @return true-ç»­æœŸæˆåŠŸï¼Œfalse-ä¸æ˜¯è‡ªå·±çš„é”
 */
public boolean renew(int expireTime) {
    String renewScript = 
        "if redis.call('get', KEYS[1]) == ARGV[1] then " +
        "return redis.call('expire', KEYS[1], ARGV[2]) " +
        "else return 0 end";
    
    Object result = jedis.eval(renewScript,
        Collections.singletonList(lockKey),
        Arrays.asList(lockValue, String.valueOf(expireTime)));
    
    return Long.valueOf(1).equals(result);
}
```

---

## 6. ğŸ”„ é”ç»­æœŸä¸è‡ªåŠ¨å»¶æœŸ


### 6.1 ç»­æœŸæœºåˆ¶çš„å¿…è¦æ€§


**ğŸ’­ é—®é¢˜åœºæ™¯**
```
å‡è®¾ä¸šåŠ¡æ‰§è¡Œéœ€è¦60ç§’ï¼Œä½†é”åªè®¾ç½®äº†30ç§’è¿‡æœŸï¼š
T0: è·å¾—é”ï¼Œå¼€å§‹æ‰§è¡Œä¸šåŠ¡
T30: é”è¿‡æœŸè¢«é‡Šæ”¾
T31: å…¶ä»–å®¢æˆ·ç«¯è·å¾—é”  â† å†²çªï¼
T60: åŸå®¢æˆ·ç«¯ä¸šåŠ¡æ‰§è¡Œå®Œæ¯•
```

**ğŸ¯ è§£å†³æ€è·¯**
```
è‡ªåŠ¨ç»­æœŸï¼šåœ¨ä¸šåŠ¡æ‰§è¡ŒæœŸé—´ï¼Œå®šæœŸå»¶é•¿é”çš„è¿‡æœŸæ—¶é—´
ç±»ä¼¼ï¼šä¸šåŠ¡è¿˜æ²¡å®Œæˆæ—¶ï¼Œè‡ªåŠ¨ç»­å€Ÿä¼šè®®å®¤
```

### 6.2 çœ‹é—¨ç‹—æœºåˆ¶å®ç°


```java
public class WatchdogRedisLock {
    private Jedis jedis;
    private String lockKey;
    private String lockValue;
    private volatile boolean locked = false;
    private ScheduledExecutorService scheduler;
    
    public WatchdogRedisLock(Jedis jedis, String lockKey) {
        this.jedis = jedis;
        this.lockKey = lockKey;
        this.lockValue = UUID.randomUUID().toString();
        this.scheduler = Executors.newScheduledThreadPool(1);
    }
    
    public boolean tryLock(int expireTime) {
        String result = jedis.set(lockKey, lockValue, 
            SetParams.setParams().nx().ex(expireTime));
        
        if ("OK".equals(result)) {
            locked = true;
            startWatchdog(expireTime); // å¯åŠ¨çœ‹é—¨ç‹—
            return true;
        }
        return false;
    }
    
    /**
     * å¯åŠ¨çœ‹é—¨ç‹—çº¿ç¨‹
     */
    private void startWatchdog(int expireTime) {
        scheduler.scheduleAtFixedRate(() -> {
            if (locked && renew(expireTime)) {
                System.out.println("é”ç»­æœŸæˆåŠŸ");
            }
        }, expireTime / 3, expireTime / 3, TimeUnit.SECONDS);
    }
    
    private boolean renew(int expireTime) {
        String renewScript = 
            "if redis.call('get', KEYS[1]) == ARGV[1] then " +
            "return redis.call('expire', KEYS[1], ARGV[2]) " +
            "else return 0 end";
        
        Object result = jedis.eval(renewScript,
            Collections.singletonList(lockKey),
            Arrays.asList(lockValue, String.valueOf(expireTime)));
        
        return Long.valueOf(1).equals(result);
    }
    
    public boolean unlock() {
        locked = false; // åœæ­¢ç»­æœŸ
        scheduler.shutdown(); // å…³é—­çœ‹é—¨ç‹—
        
        String unlockScript = 
            "if redis.call('get', KEYS[1]) == ARGV[1] then " +
            "return redis.call('del', KEYS[1]) " +
            "else return 0 end";
        
        Object result = jedis.eval(unlockScript,
            Collections.singletonList(lockKey),
            Collections.singletonList(lockValue));
        
        return Long.valueOf(1).equals(result);
    }
}
```

### 6.3 ç»­æœŸç­–ç•¥é…ç½®


**ğŸ“Š ç»­æœŸæ—¶æœºé€‰æ‹©**
```
è¿‡æœŸæ—¶é—´30ç§’çš„ç»­æœŸç­–ç•¥ï¼š
â”œâ”€ ä¿å®ˆç­–ç•¥ï¼šæ¯10ç§’ç»­æœŸä¸€æ¬¡ (1/3æ—¶é—´)
â”œâ”€ å¹³è¡¡ç­–ç•¥ï¼šæ¯15ç§’ç»­æœŸä¸€æ¬¡ (1/2æ—¶é—´) 
â””â”€ æ¿€è¿›ç­–ç•¥ï¼šæ¯20ç§’ç»­æœŸä¸€æ¬¡ (2/3æ—¶é—´)

æ¨èï¼š1/3æ—¶é—´ç»­æœŸï¼Œå®‰å…¨æ€§æœ€é«˜
```

---

## 7. âš–ï¸ ä¸»ä»ä¸€è‡´æ€§é—®é¢˜å¤„ç†


### 7.1 Redisä¸»ä»å¤åˆ¶çš„é—®é¢˜


**ğŸ—ï¸ Redisä¸»ä»æ¶æ„**
```
        å†™æ“ä½œ
å®¢æˆ·ç«¯ â”€â”€â”€â”€â”€â”€â”€â”€â†’ MasterèŠ‚ç‚¹
                   â”‚
                   â”‚ å¼‚æ­¥å¤åˆ¶
                   â–¼
                SlaveèŠ‚ç‚¹
                   â”‚
                   â”‚ è¯»æ“ä½œ
                å®¢æˆ·ç«¯ â†â”€â”€â”€â”€â”€â”€â”€â”€
```

**âš ï¸ ä¸€è‡´æ€§é—®é¢˜**
```
T1: å®¢æˆ·ç«¯Aå‘Masterè·å–é”æˆåŠŸ
T2: MasterèŠ‚ç‚¹çªç„¶å®•æœºï¼ˆæ•°æ®è¿˜æœªåŒæ­¥åˆ°Slaveï¼‰
T3: Slaveè¢«æå‡ä¸ºæ–°çš„Master
T4: å®¢æˆ·ç«¯Bå‘æ–°Masterè·å–ç›¸åŒçš„é”ï¼Œä¹ŸæˆåŠŸäº†ï¼
    
ç»“æœï¼šä¸¤ä¸ªå®¢æˆ·ç«¯åŒæ—¶æŒæœ‰é” â†’ åˆ†å¸ƒå¼é”å¤±æ•ˆ
```

### 7.2 é—®é¢˜çš„æ ¹æœ¬åŸå› 


**ğŸ’¡ æ·±å±‚åˆ†æ**
```
é—®é¢˜æœ¬è´¨ï¼šRedisçš„ä¸»ä»å¤åˆ¶æ˜¯å¼‚æ­¥çš„
- å†™å…¥Masteråç«‹å³è¿”å›æˆåŠŸ
- æ•°æ®å¼‚æ­¥å¤åˆ¶åˆ°Slaveéœ€è¦æ—¶é—´
- å¦‚æœMasterå®•æœºï¼Œæœªå¤åˆ¶çš„æ•°æ®ä¸¢å¤±
```

### 7.3 ç¼“è§£æ–¹æ¡ˆ


**ğŸ”§ æ–¹æ¡ˆ1ï¼šç­‰å¾…å¤åˆ¶ç¡®è®¤**
```java
// ä½¿ç”¨WAITå‘½ä»¤ç­‰å¾…è‡³å°‘1ä¸ªslaveç¡®è®¤
public boolean tryLockWithWait(int expireTime) {
    String result = jedis.set(lockKey, lockValue, 
        SetParams.setParams().nx().ex(expireTime));
    
    if ("OK".equals(result)) {
        // ç­‰å¾…è‡³å°‘1ä¸ªslaveç¡®è®¤å¤åˆ¶
        long replicas = jedis.waitReplicas(1, 1000); // ç­‰å¾…1ç§’
        return replicas >= 1;
    }
    return false;
}
```

**ğŸ“Š æ–¹æ¡ˆæ•ˆæœè¯„ä¼°**
```
ä¼˜ç‚¹ï¼š
âœ… æé«˜ä¸€è‡´æ€§ä¿è¯
âœ… å®ç°ç›¸å¯¹ç®€å•

ç¼ºç‚¹ï¼š
âŒ å¢åŠ å»¶è¿Ÿ
âŒ ä»ä¸èƒ½å®Œå…¨é¿å…é—®é¢˜ï¼ˆç½‘ç»œåˆ†åŒºåœºæ™¯ï¼‰
âŒ å½±å“æ€§èƒ½
```

---

## 8. ğŸ›¡ï¸ RedLockç®—æ³•è¯¦è§£


### 8.1 RedLockç®—æ³•åŸç†


**ğŸ¯ æ ¸å¿ƒæ€æƒ³**
```
ä¸ä¾èµ–å•ä¸ªRediså®ä¾‹ï¼Œè€Œæ˜¯ä½¿ç”¨å¤šä¸ªç‹¬ç«‹çš„Rediså®ä¾‹
åªæœ‰åœ¨å¤§å¤šæ•°å®ä¾‹ä¸Šéƒ½è·å–åˆ°é”ï¼Œæ‰è®¤ä¸ºè·å–é”æˆåŠŸ
```

**ğŸ—ï¸ RedLockæ¶æ„**
```
å®¢æˆ·ç«¯åŒæ—¶å‘å¤šä¸ªRediså®ä¾‹è¯·æ±‚é”ï¼š

å®¢æˆ·ç«¯     Redis1    Redis2    Redis3    Redis4    Redis5
  â”‚          â”‚         â”‚         â”‚         â”‚         â”‚
  â”œâ”€ è¯·æ±‚é” â”€â†’ âœ…       âœ…        âŒ        âœ…        âœ…
  â”‚
  â””â”€ ç»“æœï¼š5ä¸ªå®ä¾‹ä¸­4ä¸ªæˆåŠŸ > 3(è¿‡åŠ) â†’ è·å–é”æˆåŠŸ
```

### 8.2 RedLockç®—æ³•æ­¥éª¤


**ğŸ“‹ è¯¦ç»†æ­¥éª¤**
```
æ­¥éª¤1: è·å–å½“å‰æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
æ­¥éª¤2: ä¾æ¬¡å‘Nä¸ªRediså®ä¾‹å°è¯•è·å–é”
       - æ¯ä¸ªå®ä¾‹éƒ½è®¾ç½®è¾ƒçŸ­çš„è¶…æ—¶æ—¶é—´
       - é¿å…å› ä¸ºæŸä¸ªå®ä¾‹æ•…éšœè€Œé•¿æ—¶é—´é˜»å¡
æ­¥éª¤3: è®¡ç®—è·å–é”æ¶ˆè€—çš„æ—¶é—´
æ­¥éª¤4: åˆ¤æ–­æ˜¯å¦è·å–é”æˆåŠŸï¼š
       - è·å–é”çš„å®ä¾‹æ•° > N/2
       - æ€»æ¶ˆè€—æ—¶é—´ < é”çš„è¿‡æœŸæ—¶é—´
æ­¥éª¤5: å¦‚æœæˆåŠŸï¼Œåˆ™é”çš„æœ‰æ•ˆæ—¶é—´ = è¿‡æœŸæ—¶é—´ - æ¶ˆè€—æ—¶é—´
æ­¥éª¤6: å¦‚æœå¤±è´¥ï¼Œå‘æ‰€æœ‰å®ä¾‹å‘é€é‡Šæ”¾é”å‘½ä»¤
```

### 8.3 RedLockå®ç°ç¤ºä¾‹


```java
public class RedLockAlgorithm {
    private List<Jedis> redisInstances;
    private String lockKey;
    private String lockValue;
    private int expireTime;
    private int retryDelay = 200; // é‡è¯•é—´éš”
    
    public RedLockAlgorithm(List<Jedis> redisInstances, String lockKey, int expireTime) {
        this.redisInstances = redisInstances;
        this.lockKey = lockKey;
        this.lockValue = UUID.randomUUID().toString();
        this.expireTime = expireTime;
    }
    
    /**
     * å°è¯•è·å–RedLock
     * @return true-æˆåŠŸï¼Œfalse-å¤±è´¥
     */
    public boolean tryLock() {
        long startTime = System.currentTimeMillis();
        int successCount = 0;
        
        // ä¾æ¬¡å‘æ‰€æœ‰Rediså®ä¾‹è¯·æ±‚é”
        for (Jedis jedis : redisInstances) {
            if (tryLockSingle(jedis)) {
                successCount++;
            }
        }
        
        long costTime = System.currentTimeMillis() - startTime;
        
        // åˆ¤æ–­æ˜¯å¦è·å–é”æˆåŠŸ
        boolean isLocked = successCount > redisInstances.size() / 2 && 
                          costTime < expireTime * 1000;
        
        if (!isLocked) {
            // å¤±è´¥åˆ™é‡Šæ”¾æ‰€æœ‰å·²è·å–çš„é”
            unlockAll();
        }
        
        return isLocked;
    }
    
    /**
     * å‘å•ä¸ªRediså®ä¾‹è·å–é”
     */
    private boolean tryLockSingle(Jedis jedis) {
        try {
            String result = jedis.set(lockKey, lockValue,
                SetParams.setParams().nx().ex(expireTime));
            return "OK".equals(result);
        } catch (Exception e) {
            // ç½‘ç»œå¼‚å¸¸ç­‰æƒ…å†µè¿”å›false
            return false;
        }
    }
    
    /**
     * é‡Šæ”¾æ‰€æœ‰Rediså®ä¾‹ä¸Šçš„é”
     */
    public void unlockAll() {
        String unlockScript = 
            "if redis.call('get', KEYS[1]) == ARGV[1] then " +
            "return redis.call('del', KEYS[1]) " +
            "else return 0 end";
        
        for (Jedis jedis : redisInstances) {
            try {
                jedis.eval(unlockScript,
                    Collections.singletonList(lockKey),
                    Collections.singletonList(lockValue));
            } catch (Exception e) {
                // å¿½ç•¥é‡Šæ”¾è¿‡ç¨‹ä¸­çš„å¼‚å¸¸
            }
        }
    }
}
```

### 8.4 RedLockçš„äº‰è®®


**âš ï¸ å­¦æœ¯ç•Œäº‰è®®**
```
æ”¯æŒè§‚ç‚¹ï¼š
âœ… æä¾›æ›´å¼ºçš„å®‰å…¨æ€§ä¿è¯
âœ… ä¸ä¾èµ–å•ä¸ªRediså®ä¾‹

è´¨ç–‘è§‚ç‚¹ï¼š
âŒ å¤æ‚æ€§å¢åŠ 
âŒ æ€§èƒ½å¼€é”€å¤§
âŒ ä»ç„¶æ— æ³•è§£å†³æ‰€æœ‰ä¸€è‡´æ€§é—®é¢˜
âŒ å·¥ç¨‹å®è·µä¸­ç®€å•æ–¹æ¡ˆå¾€å¾€æ›´å¥½
```

**ğŸ¯ å®é™…åº”ç”¨å»ºè®®**
> å¯¹äºå¤§å¤šæ•°ä¸šåŠ¡åœºæ™¯ï¼Œå•Rediså®ä¾‹+åˆç†çš„è¿‡æœŸæ—¶é—´å·²ç»å¤Ÿç”¨ã€‚
> åªæœ‰åœ¨å®‰å…¨æ€§è¦æ±‚æé«˜çš„åœºæ™¯ä¸‹æ‰è€ƒè™‘RedLockã€‚

---

## 9. ğŸ”„ é”é‡è¯•ä¸ç«äº‰å¤„ç†


### 9.1 é”ç«äº‰åœºæ™¯åˆ†æ


**ğŸ“Š ç«äº‰æ¿€çƒˆç¨‹åº¦**
```
ä½ç«äº‰ï¼šå¶å°”æœ‰å†²çªï¼Œé‡è¯•å‡ æ¬¡å°±èƒ½æˆåŠŸ
ä¸­ç«äº‰ï¼šç»å¸¸å†²çªï¼Œéœ€è¦åˆç†çš„é‡è¯•ç­–ç•¥
é«˜ç«äº‰ï¼šç«äº‰æ¿€çƒˆï¼Œéœ€è¦ä¼˜åŒ–é”ç²’åº¦æˆ–ä¸šåŠ¡é€»è¾‘
```

### 9.2 é‡è¯•ç­–ç•¥å®ç°


**ğŸ”§ å›ºå®šé—´éš”é‡è¯•**
```java
public class RetryRedisLock {
    
    /**
     * å›ºå®šé—´éš”é‡è¯•
     * @param maxRetries æœ€å¤§é‡è¯•æ¬¡æ•°
     * @param retryInterval é‡è¯•é—´éš”(æ¯«ç§’)
     */
    public boolean lockWithFixedRetry(int maxRetries, long retryInterval) {
        for (int i = 0; i < maxRetries; i++) {
            if (tryLock(30)) {
                return true;
            }
            
            if (i < maxRetries - 1) {
                try {
                    Thread.sleep(retryInterval);
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                    return false;
                }
            }
        }
        return false;
    }
    
    /**
     * æŒ‡æ•°é€€é¿é‡è¯•
     * @param maxRetries æœ€å¤§é‡è¯•æ¬¡æ•°
     * @param baseInterval åŸºç¡€é—´éš”
     */
    public boolean lockWithBackoff(int maxRetries, long baseInterval) {
        long interval = baseInterval;
        
        for (int i = 0; i < maxRetries; i++) {
            if (tryLock(30)) {
                return true;
            }
            
            if (i < maxRetries - 1) {
                try {
                    // æŒ‡æ•°é€’å¢ï¼š100ms -> 200ms -> 400ms -> 800ms
                    Thread.sleep(interval);
                    interval = Math.min(interval * 2, 5000); // æœ€å¤§5ç§’
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                    return false;
                }
            }
        }
        return false;
    }
}
```

### 9.3 éšæœºåŒ–é¿å…æƒŠç¾¤æ•ˆåº”


```java
/**
 * éšæœºé€€é¿é‡è¯•ï¼Œé¿å…æƒŠç¾¤æ•ˆåº”
 */
public boolean lockWithRandomBackoff(int maxRetries, long baseInterval) {
    Random random = new Random();
    
    for (int i = 0; i < maxRetries; i++) {
        if (tryLock(30)) {
            return true;
        }
        
        if (i < maxRetries - 1) {
            try {
                // åœ¨åŸºç¡€é—´éš”åŸºç¡€ä¸ŠåŠ ä¸Šéšæœºæ—¶é—´
                long jitter = random.nextInt((int) baseInterval);
                Thread.sleep(baseInterval + jitter);
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
                return false;
            }
        }
    }
    return false;
}
```

### 9.4 ç«äº‰ä¼˜åŒ–ç­–ç•¥


**ğŸ“ˆ å‡å°‘é”ç«äº‰çš„æ–¹æ³•**
```
ğŸ”¸ é”åˆ†æ®µï¼šå°†å¤§é”æ‹†åˆ†æˆå¤šä¸ªå°é”
  ä¾‹ï¼šå…¨å±€è®¡æ•°å™¨ â†’ æŒ‰ç”¨æˆ·IDåˆ†æ®µè®¡æ•°

ğŸ”¸ é”ç²’åº¦ç»†åŒ–ï¼šç¼©å°é”çš„èŒƒå›´
  ä¾‹ï¼šé”æ•´ä¸ªæ–¹æ³• â†’ åªé”å…³é”®ä»£ç æ®µ

ğŸ”¸ ä¹è§‚é”æ›¿ä»£ï¼šæŸäº›åœºæ™¯ä½¿ç”¨ç‰ˆæœ¬å·æœºåˆ¶
  ä¾‹ï¼šç”¨æ•°æ®åº“ç‰ˆæœ¬å­—æ®µä»£æ›¿åˆ†å¸ƒå¼é”

ğŸ”¸ å¼‚æ­¥å¤„ç†ï¼šå°†åŒæ­¥æ“ä½œæ”¹ä¸ºå¼‚æ­¥
  ä¾‹ï¼šå®æ—¶æ‰£åº“å­˜ â†’ æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å¤„ç†
```

---

## 10. ğŸš€ æ€§èƒ½ä¼˜åŒ–ä¸å¼‚å¸¸å¤„ç†


### 10.1 è¿æ¥æ± ä¼˜åŒ–


```java
public class OptimizedRedisLock {
    private JedisPool jedisPool; // ä½¿ç”¨è¿æ¥æ± 
    private String lockKey;
    private String lockValue;
    
    public OptimizedRedisLock(JedisPool jedisPool, String lockKey) {
        this.jedisPool = jedisPool;
        this.lockKey = lockKey;
        this.lockValue = UUID.randomUUID().toString();
    }
    
    public boolean tryLock(int expireTime) {
        try (Jedis jedis = jedisPool.getResource()) {
            String result = jedis.set(lockKey, lockValue,
                SetParams.setParams().nx().ex(expireTime));
            return "OK".equals(result);
        } catch (Exception e) {
            // è®°å½•æ—¥å¿—ä½†ä¸æŠ›å‡ºå¼‚å¸¸
            log.error("Redisé”æ“ä½œå¼‚å¸¸", e);
            return false;
        }
    }
}
```

### 10.2 å¼‚å¸¸å¤„ç†æœ€ä½³å®è·µ


**ğŸ›¡ï¸ å¼‚å¸¸å¤„ç†ç­–ç•¥**
```
ğŸ”¸ ç½‘ç»œå¼‚å¸¸ï¼šé‡è¯•æœºåˆ¶ï¼Œé™çº§å¤„ç†
ğŸ”¸ Rediså®•æœºï¼šå¿«é€Ÿå¤±è´¥ï¼Œé¿å…é•¿æ—¶é—´ç­‰å¾…
ğŸ”¸ ä¸šåŠ¡å¼‚å¸¸ï¼šç¡®ä¿é”èƒ½æ­£ç¡®é‡Šæ”¾
ğŸ”¸ çº¿ç¨‹ä¸­æ–­ï¼šä¼˜é›…å…³é—­ï¼Œæ¸…ç†èµ„æº
```

```java
public class RobustRedisLock {
    
    public void doWithLock(Runnable task, int lockExpire, int maxWaitTime) {
        boolean locked = false;
        try {
            // å°è¯•è·å–é”
            locked = lock(lockExpire, maxWaitTime);
            if (!locked) {
                throw new LockAcquisitionException("æ— æ³•è·å–é”");
            }
            
            // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
            task.run();
            
        } catch (Exception e) {
            log.error("ä¸šåŠ¡æ‰§è¡Œå¼‚å¸¸", e);
            throw e;
        } finally {
            // ç¡®ä¿é”è¢«é‡Šæ”¾
            if (locked) {
                try {
                    unlock();
                } catch (Exception e) {
                    log.error("é‡Šæ”¾é”å¼‚å¸¸", e);
                }
            }
        }
    }
}
```

### 10.3 ç›‘æ§æŒ‡æ ‡


**ğŸ“Š å…³é”®ç›‘æ§æŒ‡æ ‡**
```
ğŸ”¸ é”è·å–æˆåŠŸç‡ï¼šæˆåŠŸè·å–é”çš„æ¯”ä¾‹
ğŸ”¸ é”è·å–è€—æ—¶ï¼šä»è¯·æ±‚åˆ°è·å–æˆåŠŸçš„æ—¶é—´
ğŸ”¸ é”æŒæœ‰æ—¶é•¿ï¼šä¸šåŠ¡æ‰§è¡Œçš„å®é™…æ—¶é—´
ğŸ”¸ é”ç«äº‰æ¬¡æ•°ï¼šé‡è¯•æ¬¡æ•°çš„ç»Ÿè®¡
ğŸ”¸ é”é‡Šæ”¾å¤±è´¥ç‡ï¼šunlockå¤±è´¥çš„æ¯”ä¾‹
```

```java
public class MonitoredRedisLock {
    private MeterRegistry meterRegistry; // Micrometerç›‘æ§
    
    public boolean tryLock(int expireTime) {
        Timer.Sample sample = Timer.start(meterRegistry);
        
        try {
            boolean success = doTryLock(expireTime);
            
            // è®°å½•æŒ‡æ ‡
            meterRegistry.counter("redis.lock.attempts", 
                "result", success ? "success" : "failure").increment();
            
            return success;
        } finally {
            sample.stop(Timer.builder("redis.lock.duration")
                .register(meterRegistry));
        }
    }
}
```

---

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ åˆ†å¸ƒå¼é”æœ¬è´¨ï¼šè·¨èŠ‚ç‚¹çš„äº’æ–¥è®¿é—®æ§åˆ¶æœºåˆ¶
ğŸ”¸ Redisä¼˜åŠ¿ï¼šå•çº¿ç¨‹+åŸå­æ“ä½œ+è¿‡æœŸæ—¶é—´
ğŸ”¸ åŸºæœ¬å®ç°ï¼šSET key value NX EX seconds
ğŸ”¸ Luaè„šæœ¬ï¼šä¿è¯å¤æ‚æ“ä½œçš„åŸå­æ€§
ğŸ”¸ ç»­æœŸæœºåˆ¶ï¼šé˜²æ­¢ä¸šåŠ¡æ‰§è¡Œæ—¶é—´è¶…è¿‡é”è¿‡æœŸæ—¶é—´
ğŸ”¸ å¼‚å¸¸å¤„ç†ï¼šç¡®ä¿åœ¨å„ç§å¼‚å¸¸æƒ…å†µä¸‹é”èƒ½è¢«æ­£ç¡®å¤„ç†
```

### 11.2 å…³é”®æŠ€æœ¯è¦ç‚¹


**ğŸ”¹ å‘½ä»¤é€‰æ‹©**
```
âŒ é¿å…ä½¿ç”¨ï¼šSETNX + EXPIREï¼ˆéåŸå­æ€§ï¼‰
âœ… æ¨èä½¿ç”¨ï¼šSET key value NX EX secondsï¼ˆåŸå­æ€§ï¼‰
âœ… Luaè„šæœ¬ï¼šå¤æ‚é€»è¾‘çš„åŸå­æ€§æ‰§è¡Œ
```

**ğŸ”¹ å®‰å…¨æ€§ä¿éšœ**
```
âœ… é”æ ‡è¯†ï¼šä½¿ç”¨UUIDç­‰å”¯ä¸€å€¼ä½œä¸ºé”çš„value
âœ… è¿‡æœŸæ—¶é—´ï¼šé˜²æ­¢æ­»é”ï¼Œå»ºè®®20-30ç§’
âœ… æ‰€æœ‰æƒæ£€æŸ¥ï¼šé‡Šæ”¾é”å‰éªŒè¯æ˜¯å¦æ˜¯è‡ªå·±çš„é”
âœ… åŸå­æ€§é‡Šæ”¾ï¼šä½¿ç”¨Luaè„šæœ¬è¿›è¡Œcheck-and-delete
```

**ğŸ”¹ é«˜å¯ç”¨è€ƒè™‘**
```
âœ… é‡è¯•æœºåˆ¶ï¼šåˆç†çš„é‡è¯•ç­–ç•¥å’Œé€€é¿ç®—æ³•
âœ… è¶…æ—¶è®¾ç½®ï¼šé¿å…æ— é™ç­‰å¾…
âœ… å¼‚å¸¸å¤„ç†ï¼šç½‘ç»œå¼‚å¸¸ã€Rediså®•æœºçš„å¤„ç†
âœ… ç›‘æ§å‘Šè­¦ï¼šå…³é”®æŒ‡æ ‡çš„ç›‘æ§å’Œå‘Šè­¦
```

### 11.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ ä½¿ç”¨åœºæ™¯é€‰æ‹©**
```
âœ… é€‚åˆåœºæ™¯ï¼š
- é˜²æ­¢é‡å¤æ“ä½œï¼ˆè®¢å•é‡å¤æäº¤ï¼‰
- èµ„æºäº‰æŠ¢ï¼ˆåº“å­˜æ‰£å‡ã€ä¼˜æƒ åˆ¸å‘æ”¾ï¼‰
- å®šæ—¶ä»»åŠ¡é˜²é‡ï¼ˆé¿å…å¤šå®ä¾‹é‡å¤æ‰§è¡Œï¼‰
- ç¼“å­˜é‡å»ºï¼ˆé˜²æ­¢ç¼“å­˜é›ªå´©ï¼‰

âŒ ä¸é€‚åˆåœºæ™¯ï¼š
- é«˜é¢‘çŸ­æ—¶æ“ä½œï¼ˆæ€§èƒ½è¦æ±‚æé«˜ï¼‰
- å¯¹ä¸€è‡´æ€§è¦æ±‚ä¸é«˜çš„åœºæ™¯
- å·²æœ‰æ•°æ®åº“é”èƒ½è§£å†³çš„é—®é¢˜
```

**ğŸ”§ æœ€ä½³å®è·µ**
```
ğŸ”¸ é”ç²’åº¦ï¼šå°½é‡ç»†åŒ–ï¼Œå‡å°‘ç«äº‰
ğŸ”¸ è¿‡æœŸæ—¶é—´ï¼šæ ¹æ®ä¸šåŠ¡æ‰§è¡Œæ—¶é—´åˆç†è®¾ç½®
ğŸ”¸ é‡è¯•ç­–ç•¥ï¼šæŒ‡æ•°é€€é¿ + éšæœºåŒ–
ğŸ”¸ ç›‘æ§å®Œå–„ï¼šå…³é”®æŒ‡æ ‡ç›‘æ§å’Œå‘Šè­¦
ğŸ”¸ é™çº§æ–¹æ¡ˆï¼šRedisä¸å¯ç”¨æ—¶çš„å¤‡ç”¨æ–¹æ¡ˆ
```

### 11.4 æŠ€æœ¯é€‰å‹å»ºè®®


**ğŸ“Š æ–¹æ¡ˆå¯¹æ¯”**
| ç‰¹æ€§ | **å•Redis** | **ä¸»ä»Redis** | **RedLock** | **æ•°æ®åº“é”** |
|------|-------------|---------------|-------------|-------------|
| **å®ç°å¤æ‚åº¦** | ç®€å• | ä¸­ç­‰ | å¤æ‚ | ç®€å• |
| **æ€§èƒ½** | é«˜ | é«˜ | ä¸­ç­‰ | ä½ |
| **å¯ç”¨æ€§** | ä½ | ä¸­ç­‰ | é«˜ | ä¸­ç­‰ |
| **ä¸€è‡´æ€§** | ä¸­ç­‰ | ä¸­ç­‰ | é«˜ | é«˜ |
| **è¿ç»´æˆæœ¬** | ä½ | ä¸­ç­‰ | é«˜ | ä½ |

**ğŸ¯ é€‰æ‹©å»ºè®®**
```
æ™®é€šä¸šåŠ¡åœºæ™¯ï¼šå•Rediså®ä¾‹ + åˆç†è¿‡æœŸæ—¶é—´
é«˜å¯ç”¨è¦æ±‚ï¼šRedisä¸»ä» + é€‚å½“é™çº§
æé«˜å®‰å…¨æ€§ï¼šè€ƒè™‘RedLockæˆ–æ•°æ®åº“é”
```

**ğŸ’¡ æ ¸å¿ƒè®°å¿†**
> åˆ†å¸ƒå¼é”ä¸æ˜¯ä¸‡èƒ½çš„ï¼Œè¦æ ¹æ®å…·ä½“ä¸šåŠ¡åœºæ™¯é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆã€‚
> å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œç®€å•å¯é çš„æ–¹æ¡ˆæ¯”å¤æ‚çš„æ–¹æ¡ˆæ›´å¥½ã€‚
> ç›‘æ§å’Œå¼‚å¸¸å¤„ç†å¾€å¾€æ¯”ç®—æ³•æœ¬èº«æ›´é‡è¦ã€‚