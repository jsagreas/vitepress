---
title: 4ã€ç¼“å­˜ä¸€è‡´æ€§ä¿éšœ
---
## ğŸ“š ç›®å½•

1. [ç¼“å­˜ä¸€è‡´æ€§åŸºæœ¬æ¦‚å¿µ](#1-ç¼“å­˜ä¸€è‡´æ€§åŸºæœ¬æ¦‚å¿µ)
2. [å¼ºä¸€è‡´æ€§è¦æ±‚ä¸å®ç°](#2-å¼ºä¸€è‡´æ€§è¦æ±‚ä¸å®ç°)
3. [æœ€ç»ˆä¸€è‡´æ€§å®ç°ç­–ç•¥](#3-æœ€ç»ˆä¸€è‡´æ€§å®ç°ç­–ç•¥)
4. [åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†æ–¹æ¡ˆ](#4-åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†æ–¹æ¡ˆ)
5. [è¡¥å¿æœºåˆ¶è®¾è®¡](#5-è¡¥å¿æœºåˆ¶è®¾è®¡)
6. [æ•°æ®æ ¡éªŒä¸ä¿®å¤ç­–ç•¥](#6-æ•°æ®æ ¡éªŒä¸ä¿®å¤ç­–ç•¥)
7. [ç›‘æ§å‘Šè­¦æœºåˆ¶](#7-ç›‘æ§å‘Šè­¦æœºåˆ¶)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ ç¼“å­˜ä¸€è‡´æ€§åŸºæœ¬æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯ç¼“å­˜ä¸€è‡´æ€§


**ç®€å•ç†è§£**ï¼šå°±åƒä½ çš„ç¬”è®°æœ¬å’Œæ•™ç§‘ä¹¦è¦ä¿æŒå†…å®¹ä¸€è‡´ä¸€æ ·ï¼Œç¼“å­˜å’Œæ•°æ®åº“çš„æ•°æ®ä¹Ÿéœ€è¦ä¿æŒä¸€è‡´ã€‚

```
ç”Ÿæ´»åœºæ™¯ç±»æ¯”ï¼š
æ•™ç§‘ä¹¦ï¼ˆæ•°æ®åº“ï¼‰ï¼šæƒå¨çš„ã€å®Œæ•´çš„çŸ¥è¯†æ¥æº
ç¬”è®°æœ¬ï¼ˆç¼“å­˜ï¼‰ï¼šä¸ºäº†å¿«é€ŸæŸ¥é˜…è€ŒæŠ„å½•çš„è¦ç‚¹

é—®é¢˜ï¼šå½“æ•™ç§‘ä¹¦æ›´æ–°äº†ï¼Œç¬”è®°æœ¬æ²¡æœ‰åŠæ—¶æ›´æ–°
ç»“æœï¼šçœ‹ç¬”è®°æœ¬çš„äººä¼šå¾—åˆ°è¿‡æœŸçš„ä¿¡æ¯
```

**æŠ€æœ¯å®šä¹‰**ï¼š
- **ç¼“å­˜ä¸€è‡´æ€§**ï¼šç¡®ä¿ç¼“å­˜ä¸­çš„æ•°æ®ä¸æ•°æ®åº“ä¸­çš„æ•°æ®ä¿æŒåŒæ­¥çš„æœºåˆ¶
- **æ ¸å¿ƒæŒ‘æˆ˜**ï¼šç¼“å­˜çš„ç›®çš„æ˜¯æå‡æ€§èƒ½ï¼Œä½†åŒæ­¥ä¼šå½±å“æ€§èƒ½
- **å¹³è¡¡è‰ºæœ¯**ï¼šåœ¨æ€§èƒ½å’Œä¸€è‡´æ€§ä¹‹é—´æ‰¾åˆ°æœ€ä½³å¹³è¡¡ç‚¹

### 1.2 ä¸€è‡´æ€§çº§åˆ«åˆ†ç±»


> ğŸ“Œ **æ ¸å¿ƒç†è§£**  
> ä¸åŒä¸šåŠ¡åœºæ™¯å¯¹ä¸€è‡´æ€§çš„è¦æ±‚ä¸åŒï¼Œå°±åƒä¸åŒè€ƒè¯•å¯¹ç­”æ¡ˆå‡†ç¡®æ€§çš„è¦æ±‚ä¸åŒ

**å¼ºä¸€è‡´æ€§**ï¼š
```
ç‰¹ç‚¹ï¼šç¼“å­˜å’Œæ•°æ®åº“å¿…é¡»æ—¶åˆ»ä¿æŒå®Œå…¨ä¸€è‡´
åœºæ™¯ï¼šé“¶è¡Œè½¬è´¦ã€åº“å­˜æ‰£å‡
ä»£ä»·ï¼šæ€§èƒ½è¾ƒä½ï¼Œå¤æ‚åº¦é«˜

å°±åƒè€ƒè¯•ç­”æ¡ˆï¼šé”™ä¸€ä¸ªå­—éƒ½ä¸è¡Œï¼Œå¿…é¡»100%æ­£ç¡®
```

**æœ€ç»ˆä¸€è‡´æ€§**ï¼š
```
ç‰¹ç‚¹ï¼šå…è®¸çŸ­æ—¶é—´å†…ä¸ä¸€è‡´ï¼Œä½†æœ€ç»ˆä¼šè¾¾åˆ°ä¸€è‡´çŠ¶æ€
åœºæ™¯ï¼šç”¨æˆ·å¤´åƒã€å•†å“è¯„è®ºã€ç¤¾äº¤åŠ¨æ€
ä»£ä»·ï¼šå¯èƒ½å‡ºç°çŸ­æš‚çš„æ•°æ®ä¸ä¸€è‡´

å°±åƒæ–°é—»æŠ¥é“ï¼šå¯ä»¥å…ˆå‘å¿«è®¯ï¼Œåç»­å†è¡¥å……è¯¦ç»†ä¿¡æ¯
```

**å¼±ä¸€è‡´æ€§**ï¼š
```
ç‰¹ç‚¹ï¼šä¸ä¿è¯ä½•æ—¶è¾¾åˆ°ä¸€è‡´ï¼Œç”šè‡³å¯èƒ½æ°¸è¿œä¸ä¸€è‡´
åœºæ™¯ï¼šè®¿é—®è®¡æ•°ã€ç‚¹èµæ•°ï¼ˆå…è®¸ä¸€å®šè¯¯å·®ï¼‰
ä»£ä»·ï¼šæœ€é«˜æ€§èƒ½ï¼Œä½†æ•°æ®å¯èƒ½é•¿æœŸä¸å‡†ç¡®

å°±åƒç½‘ç«™è®¿é—®é‡ï¼šå·®å‡ ä¸ªæ•°å­—å½±å“ä¸å¤§
```

### 1.3 å¸¸è§ä¸ä¸€è‡´é—®é¢˜


**æ•°æ®æ›´æ–°ä¸¢å¤±**ï¼š
```
é—®é¢˜åœºæ™¯ï¼š
1. ç”¨æˆ·Aæ›´æ–°æ•°æ®åº“ï¼šprice = 100
2. ç”¨æˆ·Bä»ç¼“å­˜è¯»å–ï¼šprice = 80ï¼ˆæ—§å€¼ï¼‰
3. ç¼“å­˜æ²¡æœ‰åŠæ—¶æ›´æ–°ï¼Œç”¨æˆ·Bå¾—åˆ°é”™è¯¯ä¿¡æ¯

å®é™…å½±å“ï¼š
- ç”µå•†ï¼šç”¨æˆ·çœ‹åˆ°é”™è¯¯ä»·æ ¼
- åº“å­˜ï¼šæ˜¾ç¤ºæœ‰è´§å®é™…ç¼ºè´§
- ç”¨æˆ·ä¿¡æ¯ï¼šæ˜¾ç¤ºè¿‡æœŸçš„ä¸ªäººèµ„æ–™
```

**å¹¶å‘æ›´æ–°å†²çª**ï¼š
```
æ—¶é—´çº¿é—®é¢˜ï¼š
T1: çº¿ç¨‹Aæ›´æ–°æ•°æ®åº“ user_name = "å¼ ä¸‰"
T2: çº¿ç¨‹Bæ›´æ–°ç¼“å­˜ user_name = "æå››"ï¼ˆåŸºäºæ—§æ•°æ®ï¼‰
T3: çº¿ç¨‹Aæ›´æ–°ç¼“å­˜ user_name = "å¼ ä¸‰"

ç»“æœï¼šæ•°æ®åº“æ˜¯"å¼ ä¸‰"ï¼Œç¼“å­˜å¯èƒ½æ˜¯"æå››"
```

---

## 2. ğŸ”’ å¼ºä¸€è‡´æ€§è¦æ±‚ä¸å®ç°


### 2.1 å¼ºä¸€è‡´æ€§åº”ç”¨åœºæ™¯


> âš ï¸ **é‡è¦æé†’**  
> å¼ºä¸€è‡´æ€§è™½ç„¶å®‰å…¨ï¼Œä½†ä¼šæ˜¾è‘—å½±å“æ€§èƒ½ï¼Œåªåœ¨å…³é”®ä¸šåŠ¡ä¸­ä½¿ç”¨

**é‡‘èäº¤æ˜“åœºæ™¯**ï¼š
```java
// é“¶è¡Œè½¬è´¦ï¼šä½™é¢å¿…é¡»å‡†ç¡®
@Service
public class TransferService {
    
    @Transactional
    public void transfer(String fromAccount, String toAccount, BigDecimal amount) {
        // 1. æ£€æŸ¥ä½™é¢ï¼ˆå¿…é¡»æ˜¯æœ€æ–°çš„ï¼‰
        BigDecimal balance = getBalanceFromDB(fromAccount);
        
        // 2. ä½™é¢ä¸è¶³ç›´æ¥æ‹’ç»
        if (balance.compareTo(amount) < 0) {
            throw new InsufficientBalanceException();
        }
        
        // 3. æ‰£æ¬¾å’Œå…¥è´¦ï¼ˆåŸå­æ“ä½œï¼‰
        deductBalance(fromAccount, amount);
        addBalance(toAccount, amount);
        
        // 4. ç«‹å³æ¸…é™¤ç›¸å…³ç¼“å­˜
        clearAccountCache(fromAccount);
        clearAccountCache(toAccount);
    }
}
```

**åº“å­˜ç®¡ç†åœºæ™¯**ï¼š
```java
// å•†å“åº“å­˜ï¼šè¶…å–ä¼šé€ æˆä¸¥é‡åæœ
@Service
public class InventoryService {
    
    @Transactional
    public boolean reserveStock(Long productId, Integer quantity) {
        // 1. åŠ åˆ†å¸ƒå¼é”ï¼Œç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªæ“ä½œ
        String lockKey = "stock_" + productId;
        try (DistributedLock lock = distributedLockService.acquire(lockKey)) {
            
            // 2. ä»æ•°æ®åº“è·å–æœ€æ–°åº“å­˜
            Integer currentStock = stockMapper.selectStockByProductId(productId);
            
            // 3. æ£€æŸ¥åº“å­˜æ˜¯å¦å……è¶³
            if (currentStock < quantity) {
                return false; // åº“å­˜ä¸è¶³
            }
            
            // 4. æ‰£å‡åº“å­˜
            int affected = stockMapper.decreaseStock(productId, quantity);
            if (affected > 0) {
                // 5. æ¸…é™¤ç¼“å­˜ï¼Œå¼ºåˆ¶ä¸‹æ¬¡ä»æ•°æ®åº“è¯»å–
                cacheService.delete("stock_" + productId);
                return true;
            }
            
            return false;
        }
    }
}
```

### 2.2 å¼ºä¸€è‡´æ€§å®ç°æ¨¡å¼


**è¯»å†™åˆ†ç¦» + ä¸»åº“è¯»**ï¼š
```java
// å…³é”®æ•°æ®å¼ºåˆ¶ä»ä¸»åº“è¯»å–
@Service
public class CriticalDataService {
    
    @Autowired
    private MasterDataSource masterDB;
    
    @Autowired
    private SlaveDataSource slaveDB;
    
    public UserBalance getBalance(String userId) {
        // ä½™é¢ç­‰å…³é”®ä¿¡æ¯å¿…é¡»ä»ä¸»åº“è¯»å–
        return masterDB.selectBalance(userId);
    }
    
    public UserProfile getProfile(String userId) {
        // æ™®é€šä¿¡æ¯å¯ä»¥ä»ä»åº“è¯»å–
        return slaveDB.selectProfile(userId);
    }
}
```

**ç¼“å­˜ç©¿é€æ¨¡å¼**ï¼š
```java
// å¯¹äºå¼ºä¸€è‡´æ€§è¦æ±‚çš„æ•°æ®ï¼Œç›´æ¥è·³è¿‡ç¼“å­˜
@Service
public class ConsistentDataService {
    
    public OrderInfo getOrderInfo(String orderId) {
        // è®¢å•çŠ¶æ€å˜åŒ–é¢‘ç¹ï¼Œç›´æ¥æŸ¥æ•°æ®åº“
        return orderMapper.selectByOrderId(orderId);
    }
    
    public ProductInfo getProductInfo(String productId) {
        // å•†å“ä¿¡æ¯ç›¸å¯¹ç¨³å®šï¼Œå¯ä»¥ä½¿ç”¨ç¼“å­˜
        String cacheKey = "product_" + productId;
        ProductInfo cached = cacheService.get(cacheKey);
        
        if (cached == null) {
            cached = productMapper.selectByProductId(productId);
            cacheService.set(cacheKey, cached, 3600); // ç¼“å­˜1å°æ—¶
        }
        
        return cached;
    }
}
```

### 2.3 åˆ†å¸ƒå¼é”ä¿éšœä¸€è‡´æ€§


**Redisåˆ†å¸ƒå¼é”å®ç°**ï¼š
```java
@Component
public class RedisDistributedLock {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    /**
     * è·å–åˆ†å¸ƒå¼é”
     * @param lockKey é”çš„é”®
     * @param expireTime è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
     * @return æ˜¯å¦è·å–æˆåŠŸ
     */
    public boolean tryLock(String lockKey, int expireTime) {
        String requestId = UUID.randomUUID().toString();
        
        // ä½¿ç”¨SETå‘½ä»¤çš„NXå’ŒEXå‚æ•°ï¼ŒåŸå­æ€§åœ°è®¾ç½®é”®å€¼å’Œè¿‡æœŸæ—¶é—´
        Boolean result = redisTemplate.opsForValue()
            .setIfAbsent(lockKey, requestId, Duration.ofSeconds(expireTime));
        
        return Boolean.TRUE.equals(result);
    }
    
    /**
     * é‡Šæ”¾åˆ†å¸ƒå¼é”
     */
    public void releaseLock(String lockKey, String requestId) {
        String luaScript = 
            "if redis.call('GET', KEYS[1]) == ARGV[1] then " +
            "    return redis.call('DEL', KEYS[1]) " +
            "else " +
            "    return 0 " +
            "end";
        
        redisTemplate.execute(
            RedisScript.of(luaScript, Long.class),
            Collections.singletonList(lockKey),
            requestId
        );
    }
}
```

---

## 3. ğŸ”„ æœ€ç»ˆä¸€è‡´æ€§å®ç°ç­–ç•¥


### 3.1 æœ€ç»ˆä¸€è‡´æ€§çš„æ ¸å¿ƒæ€æƒ³


> ğŸ’¡ **é€šä¿—ç†è§£**  
> å°±åƒç¾¤èŠæ¶ˆæ¯ä¸€æ ·ï¼Œä¸è¦æ±‚æ‰€æœ‰äººåŒæ—¶çœ‹åˆ°ï¼Œä½†æœ€ç»ˆå¤§å®¶éƒ½ä¼šæ”¶åˆ°å®Œæ•´æ¶ˆæ¯

**é€‚ç”¨åœºæ™¯åˆ†æ**ï¼š
```
âœ… é€‚åˆæœ€ç»ˆä¸€è‡´æ€§çš„åœºæ™¯ï¼š
- ç”¨æˆ·å¤´åƒæ›´æ–°ï¼šæ™šå‡ ç§’çœ‹åˆ°æ–°å¤´åƒæ— å…³ç´§è¦
- å•†å“è¯„è®ºï¼šæ–°è¯„è®ºå¯ä»¥ç¨åæ˜¾ç¤º
- æ–‡ç« ç‚¹èµæ•°ï¼šå®æ—¶æ€§è¦æ±‚ä¸é«˜
- ç”¨æˆ·åŠ¨æ€ï¼šç¤¾äº¤å†…å®¹å¯ä»¥å®¹å¿çŸ­æš‚å»¶è¿Ÿ

âŒ ä¸é€‚åˆçš„åœºæ™¯ï¼š
- é“¶è¡Œä½™é¢ï¼šå¿…é¡»å®æ—¶å‡†ç¡®
- åº“å­˜æ•°é‡ï¼šé˜²æ­¢è¶…å–
- è®¢å•çŠ¶æ€ï¼šå½±å“ä¸šåŠ¡æµç¨‹
- æƒé™éªŒè¯ï¼šå®‰å…¨ç›¸å…³æ•°æ®
```

### 3.2 ç¼“å­˜æ›´æ–°ç­–ç•¥æ¨¡å¼


**Cache Aside æ¨¡å¼**ï¼ˆæ—è·¯ç¼“å­˜ï¼‰ï¼š

```
å·¥ä½œæµç¨‹ï¼š
1. åº”ç”¨ç¨‹åºå…ˆæŸ¥ç¼“å­˜
2. ç¼“å­˜æ²¡æœ‰åˆ™æŸ¥æ•°æ®åº“
3. å°†æ•°æ®åº“ç»“æœå†™å…¥ç¼“å­˜
4. æ›´æ–°æ—¶å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜

ä¼˜ç‚¹ï¼šé€»è¾‘ç®€å•ï¼Œå®¹æ˜“ç†è§£
ç¼ºç‚¹ï¼šå¯èƒ½å‡ºç°çŸ­æš‚ä¸ä¸€è‡´
```

```java
@Service
public class CacheAsideService {
    
    @Autowired
    private RedisTemplate redisTemplate;
    
    @Autowired
    private UserMapper userMapper;
    
    /**
     * è¯»å–ç”¨æˆ·ä¿¡æ¯ï¼ˆCache Asideæ¨¡å¼ï¼‰
     */
    public User getUserInfo(Long userId) {
        String cacheKey = "user_" + userId;
        
        // 1. å…ˆæŸ¥ç¼“å­˜
        User cachedUser = (User) redisTemplate.opsForValue().get(cacheKey);
        if (cachedUser != null) {
            return cachedUser;
        }
        
        // 2. ç¼“å­˜æ²¡æœ‰ï¼ŒæŸ¥æ•°æ®åº“
        User dbUser = userMapper.selectById(userId);
        if (dbUser != null) {
            // 3. å†™å…¥ç¼“å­˜
            redisTemplate.opsForValue().set(cacheKey, dbUser, 30, TimeUnit.MINUTES);
        }
        
        return dbUser;
    }
    
    /**
     * æ›´æ–°ç”¨æˆ·ä¿¡æ¯
     */
    @Transactional
    public void updateUser(User user) {
        // 1. å…ˆæ›´æ–°æ•°æ®åº“
        userMapper.updateById(user);
        
        // 2. åˆ é™¤ç¼“å­˜ï¼ˆè®©ä¸‹æ¬¡è¯»å–æ—¶é‡æ–°åŠ è½½ï¼‰
        String cacheKey = "user_" + user.getId();
        redisTemplate.delete(cacheKey);
    }
}
```

**Write Through æ¨¡å¼**ï¼ˆå†™ç©¿é€ï¼‰ï¼š

```
å·¥ä½œæµç¨‹ï¼š
1. åº”ç”¨ç¨‹åºå†™æ•°æ®åˆ°ç¼“å­˜
2. ç¼“å­˜è´Ÿè´£åŒæ­¥å†™å…¥æ•°æ®åº“
3. ä¸¤ä¸ªæ“ä½œéƒ½æˆåŠŸæ‰ç®—å†™å…¥æˆåŠŸ

ä¼˜ç‚¹ï¼šæ•°æ®åº“å’Œç¼“å­˜ä¿æŒåŒæ­¥
ç¼ºç‚¹ï¼šå†™å…¥æ€§èƒ½è¾ƒä½ï¼Œå®ç°å¤æ‚
```

```java
@Service
public class WriteThroughService {
    
    /**
     * å†™ç©¿é€æ¨¡å¼çš„ç¼“å­˜æœåŠ¡
     */
    public void saveUserInfo(User user) {
        String cacheKey = "user_" + user.getId();
        
        try {
            // 1. åŒæ—¶å†™å…¥æ•°æ®åº“å’Œç¼“å­˜
            userMapper.insertOrUpdate(user);
            redisTemplate.opsForValue().set(cacheKey, user, 30, TimeUnit.MINUTES);
            
            log.info("ç”¨æˆ·ä¿¡æ¯ä¿å­˜æˆåŠŸ: {}", user.getId());
        } catch (Exception e) {
            // 2. ä»»ä½•ä¸€ä¸ªå¤±è´¥éƒ½è¦å›æ»š
            log.error("ä¿å­˜ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œè¿›è¡Œå›æ»š", e);
            throw new BusinessException("ç”¨æˆ·ä¿¡æ¯ä¿å­˜å¤±è´¥");
        }
    }
}
```

**Write Behind æ¨¡å¼**ï¼ˆå†™å›ï¼‰ï¼š

```
å·¥ä½œæµç¨‹ï¼š
1. åº”ç”¨ç¨‹åºåªå†™ç¼“å­˜
2. ç¼“å­˜å¼‚æ­¥æ‰¹é‡å†™å…¥æ•°æ®åº“
3. æå‡å†™å…¥æ€§èƒ½ï¼Œä½†å¯èƒ½ä¸¢å¤±æ•°æ®

ä¼˜ç‚¹ï¼šå†™å…¥æ€§èƒ½æœ€å¥½
ç¼ºç‚¹ï¼šå­˜åœ¨æ•°æ®ä¸¢å¤±é£é™©
```

### 3.3 äº‹ä»¶é©±åŠ¨çš„ä¸€è‡´æ€§


**åŸºäºæ¶ˆæ¯é˜Ÿåˆ—çš„å¼‚æ­¥æ›´æ–°**ï¼š

```java
@Service
public class EventDrivenConsistencyService {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    /**
     * æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ—¶å‘é€äº‹ä»¶
     */
    @Transactional
    public void updateUserProfile(User user) {
        // 1. æ›´æ–°æ•°æ®åº“
        userMapper.updateById(user);
        
        // 2. å‘é€ç¼“å­˜æ›´æ–°äº‹ä»¶
        UserUpdateEvent event = new UserUpdateEvent(user.getId(), user);
        rabbitTemplate.convertAndSend("user.update.exchange", "user.cache.update", event);
        
        log.info("ç”¨æˆ·ä¿¡æ¯æ›´æ–°å®Œæˆï¼Œå·²å‘é€ç¼“å­˜æ›´æ–°äº‹ä»¶: {}", user.getId());
    }
    
    /**
     * ç›‘å¬ç”¨æˆ·æ›´æ–°äº‹ä»¶ï¼Œå¼‚æ­¥æ›´æ–°ç¼“å­˜
     */
    @RabbitListener(queues = "user.cache.update.queue")
    public void handleUserUpdateEvent(UserUpdateEvent event) {
        try {
            String cacheKey = "user_" + event.getUserId();
            
            // æ›´æ–°ç¼“å­˜
            redisTemplate.opsForValue().set(cacheKey, event.getUser(), 30, TimeUnit.MINUTES);
            
            log.info("ç¼“å­˜æ›´æ–°æˆåŠŸ: {}", event.getUserId());
        } catch (Exception e) {
            log.error("ç¼“å­˜æ›´æ–°å¤±è´¥: {}", event.getUserId(), e);
            // å¯ä»¥è€ƒè™‘é‡è¯•æˆ–è€…è®°å½•å¤±è´¥æ—¥å¿—
        }
    }
}
```

---

## 4. ğŸ”— åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†æ–¹æ¡ˆ


### 4.1 åˆ†å¸ƒå¼äº‹åŠ¡çš„æŒ‘æˆ˜


> ğŸ“Œ **æ ¸å¿ƒé—®é¢˜**  
> åœ¨å¾®æœåŠ¡ç¯å¢ƒä¸­ï¼Œä¸€ä¸ªæ“ä½œå¯èƒ½æ¶‰åŠå¤šä¸ªæœåŠ¡ï¼Œå¦‚ä½•ä¿è¯è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»šï¼Ÿ

**åˆ†å¸ƒå¼äº‹åŠ¡åœºæ™¯**ï¼š
```
ç”µå•†ä¸‹å•æµç¨‹ï¼š
1. ç”¨æˆ·æœåŠ¡ï¼šæ‰£å‡ç”¨æˆ·ç§¯åˆ†
2. åº“å­˜æœåŠ¡ï¼šæ‰£å‡å•†å“åº“å­˜  
3. è®¢å•æœåŠ¡ï¼šåˆ›å»ºè®¢å•è®°å½•
4. æ”¯ä»˜æœåŠ¡ï¼šå¤„ç†æ”¯ä»˜
5. ç¼“å­˜æœåŠ¡ï¼šæ›´æ–°ç›¸å…³ç¼“å­˜

æŒ‘æˆ˜ï¼šä»»ä½•ä¸€ä¸ªæ­¥éª¤å¤±è´¥ï¼Œéƒ½è¦å›æ»šæ‰€æœ‰æ“ä½œ
```

### 4.2 ä¸¤é˜¶æ®µæäº¤åè®®ï¼ˆ2PCï¼‰


**åŸºæœ¬åŸç†**ï¼š
```
é˜¶æ®µä¸€ï¼ˆå‡†å¤‡é˜¶æ®µï¼‰ï¼š
åè°ƒè€…è¯¢é—®æ‰€æœ‰å‚ä¸è€…æ˜¯å¦å¯ä»¥æäº¤
å‚ä¸è€…æ‰§è¡Œäº‹åŠ¡æ“ä½œä½†ä¸æäº¤ï¼Œè¿”å›å‡†å¤‡ç»“æœ

é˜¶æ®µäºŒï¼ˆæäº¤é˜¶æ®µï¼‰ï¼š
å¦‚æœæ‰€æœ‰å‚ä¸è€…éƒ½å‡†å¤‡å¥½ï¼Œåè°ƒè€…å‘é€æäº¤æŒ‡ä»¤
å¦‚æœä»»ä½•å‚ä¸è€…æœªå‡†å¤‡å¥½ï¼Œåè°ƒè€…å‘é€å›æ»šæŒ‡ä»¤
```

```java
@Service
public class TwoPhaseCommitService {
    
    @Autowired
    private List<TransactionParticipant> participants;
    
    /**
     * åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†
     */
    public boolean executeDistributedTransaction(TransactionContext context) {
        List<String> preparedParticipants = new ArrayList<>();
        
        try {
            // ç¬¬ä¸€é˜¶æ®µï¼šå‡†å¤‡
            for (TransactionParticipant participant : participants) {
                boolean prepared = participant.prepare(context);
                if (prepared) {
                    preparedParticipants.add(participant.getName());
                } else {
                    // æœ‰å‚ä¸è€…å‡†å¤‡å¤±è´¥ï¼Œå›æ»šå·²å‡†å¤‡çš„å‚ä¸è€…
                    rollbackPreparedParticipants(preparedParticipants, context);
                    return false;
                }
            }
            
            // ç¬¬äºŒé˜¶æ®µï¼šæäº¤
            for (TransactionParticipant participant : participants) {
                participant.commit(context);
            }
            
            return true;
            
        } catch (Exception e) {
            // å‡ºç°å¼‚å¸¸ï¼Œå›æ»šæ‰€æœ‰å‚ä¸è€…
            rollbackPreparedParticipants(preparedParticipants, context);
            log.error("åˆ†å¸ƒå¼äº‹åŠ¡æ‰§è¡Œå¤±è´¥", e);
            return false;
        }
    }
    
    private void rollbackPreparedParticipants(List<String> preparedParticipants, 
                                            TransactionContext context) {
        for (String participantName : preparedParticipants) {
            try {
                getParticipantByName(participantName).rollback(context);
            } catch (Exception e) {
                log.error("å›æ»šå‚ä¸è€… {} å¤±è´¥", participantName, e);
            }
        }
    }
}
```

### 4.3 Sagaåˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å¼


**Sagaæ¨¡å¼æ€æƒ³**ï¼š
```
å°†é•¿äº‹åŠ¡åˆ†è§£ä¸ºå¤šä¸ªå°çš„æœ¬åœ°äº‹åŠ¡
æ¯ä¸ªæœ¬åœ°äº‹åŠ¡æœ‰å¯¹åº”çš„è¡¥å¿æ“ä½œ
å¦‚æœæŸæ­¥å¤±è´¥ï¼Œæ‰§è¡Œä¹‹å‰æ­¥éª¤çš„è¡¥å¿æ“ä½œ

ä¼˜ç‚¹ï¼š
- ä¸éœ€è¦é”å®šèµ„æº
- æ€§èƒ½è¾ƒå¥½
- é€‚åˆé•¿æ—¶é—´è¿è¡Œçš„äº‹åŠ¡

ç¼ºç‚¹ï¼š
- æ•°æ®ä¸€è‡´æ€§è¾ƒå¼±
- éœ€è¦è®¾è®¡è¡¥å¿æ“ä½œ
```

```java
@Component
public class OrderSagaOrchestrator {
    
    @Autowired
    private PaymentService paymentService;
    
    @Autowired
    private InventoryService inventoryService;
    
    @Autowired
    private OrderService orderService;
    
    /**
     * è®¢å•å¤„ç†Saga
     */
    public void processOrder(OrderRequest request) {
        SagaTransaction saga = new SagaTransaction();
        
        try {
            // æ­¥éª¤1ï¼šåˆ›å»ºè®¢å•
            Long orderId = orderService.createOrder(request);
            saga.addCompensation(() -> orderService.cancelOrder(orderId));
            
            // æ­¥éª¤2ï¼šæ‰£å‡åº“å­˜
            inventoryService.reserveStock(request.getProductId(), request.getQuantity());
            saga.addCompensation(() -> inventoryService.releaseStock(request.getProductId(), request.getQuantity()));
            
            // æ­¥éª¤3ï¼šå¤„ç†æ”¯ä»˜
            String paymentId = paymentService.processPayment(request.getPaymentInfo());
            saga.addCompensation(() -> paymentService.refund(paymentId));
            
            // æ­¥éª¤4ï¼šæ›´æ–°ç¼“å­˜
            updateOrderCache(orderId, "PAID");
            saga.addCompensation(() -> updateOrderCache(orderId, "CANCELLED"));
            
            log.info("è®¢å•å¤„ç†æˆåŠŸ: {}", orderId);
            
        } catch (Exception e) {
            log.error("è®¢å•å¤„ç†å¤±è´¥ï¼Œå¼€å§‹è¡¥å¿", e);
            saga.compensate(); // æ‰§è¡Œæ‰€æœ‰è¡¥å¿æ“ä½œ
        }
    }
}
```

---

## 5. âš¡ è¡¥å¿æœºåˆ¶è®¾è®¡


### 5.1 è¡¥å¿æœºåˆ¶æ ¸å¿ƒæ€æƒ³


> ğŸ’¡ **ç”Ÿæ´»ç±»æ¯”**  
> å°±åƒç½‘è´­é€€è´§ä¸€æ ·ï¼Œå¦‚æœå•†å“æœ‰é—®é¢˜ï¼Œè¦æœ‰é€€è´§æµç¨‹æŠŠé’±é€€å›æ¥ï¼ŒæŠŠå•†å“æ”¶å›å»

**è¡¥å¿æ“ä½œçš„ç‰¹ç‚¹**ï¼š
```
å¹‚ç­‰æ€§ï¼šå¤šæ¬¡æ‰§è¡Œç»“æœç›¸åŒ
å¯é æ€§ï¼šå¿…é¡»èƒ½å¤ŸæˆåŠŸæ‰§è¡Œ
å¯è§‚æµ‹ï¼šèƒ½å¤Ÿè·Ÿè¸ªè¡¥å¿æ‰§è¡ŒçŠ¶æ€
æ—¶æ•ˆæ€§ï¼šåœ¨åˆç†æ—¶é—´å†…å®Œæˆè¡¥å¿
```

### 5.2 è‡ªåŠ¨è¡¥å¿æœºåˆ¶


**åŸºäºå®šæ—¶ä»»åŠ¡çš„è¡¥å¿**ï¼š

```java
@Component
public class CompensationService {
    
    @Autowired
    private CompensationTaskMapper compensationTaskMapper;
    
    /**
     * è®°å½•éœ€è¦è¡¥å¿çš„ä»»åŠ¡
     */
    public void recordCompensationTask(String taskType, String businessId, 
                                     String compensationData, int retryTimes) {
        CompensationTask task = new CompensationTask();
        task.setTaskType(taskType);
        task.setBusinessId(businessId);
        task.setCompensationData(compensationData);
        task.setRetryTimes(retryTimes);
        task.setStatus("PENDING");
        task.setCreateTime(LocalDateTime.now());
        
        compensationTaskMapper.insert(task);
        log.info("è¡¥å¿ä»»åŠ¡è®°å½•æˆåŠŸ: {} - {}", taskType, businessId);
    }
    
    /**
     * å®šæ—¶æ‰§è¡Œè¡¥å¿ä»»åŠ¡
     */
    @Scheduled(fixedDelay = 30000) // æ¯30ç§’æ‰§è¡Œä¸€æ¬¡
    public void executeCompensationTasks() {
        List<CompensationTask> pendingTasks = compensationTaskMapper.findPendingTasks();
        
        for (CompensationTask task : pendingTasks) {
            try {
                executeCompensationTask(task);
                
                // æ ‡è®°ä¸ºæˆåŠŸ
                task.setStatus("SUCCESS");
                task.setUpdateTime(LocalDateTime.now());
                compensationTaskMapper.updateById(task);
                
            } catch (Exception e) {
                log.error("è¡¥å¿ä»»åŠ¡æ‰§è¡Œå¤±è´¥: {}", task.getId(), e);
                
                // å‡å°‘é‡è¯•æ¬¡æ•°
                task.setRetryTimes(task.getRetryTimes() - 1);
                if (task.getRetryTimes() <= 0) {
                    task.setStatus("FAILED");
                }
                task.setUpdateTime(LocalDateTime.now());
                compensationTaskMapper.updateById(task);
            }
        }
    }
    
    private void executeCompensationTask(CompensationTask task) {
        switch (task.getTaskType()) {
            case "CANCEL_ORDER":
                orderService.cancelOrder(task.getBusinessId());
                break;
            case "RELEASE_STOCK":
                inventoryService.releaseStock(task.getBusinessId(), 
                    JSON.parseObject(task.getCompensationData(), Integer.class));
                break;
            case "REFUND_PAYMENT":
                paymentService.refund(task.getBusinessId());
                break;
            case "CLEAR_CACHE":
                cacheService.delete(task.getBusinessId());
                break;
            default:
                throw new UnsupportedOperationException("æœªæ”¯æŒçš„è¡¥å¿ä»»åŠ¡ç±»å‹: " + task.getTaskType());
        }
    }
}
```

### 5.3 äººå·¥å¹²é¢„è¡¥å¿


**è¡¥å¿ä»»åŠ¡ç›‘æ§é¢æ¿**ï¼š

```java
@RestController
@RequestMapping("/admin/compensation")
public class CompensationController {
    
    @Autowired
    private CompensationService compensationService;
    
    /**
     * æŸ¥çœ‹å¤±è´¥çš„è¡¥å¿ä»»åŠ¡
     */
    @GetMapping("/failed-tasks")
    public Result<List<CompensationTask>> getFailedTasks() {
        List<CompensationTask> failedTasks = compensationService.getFailedTasks();
        return Result.success(failedTasks);
    }
    
    /**
     * æ‰‹åŠ¨é‡è¯•è¡¥å¿ä»»åŠ¡
     */
    @PostMapping("/retry/{taskId}")
    public Result<Void> retryCompensationTask(@PathVariable Long taskId) {
        try {
            compensationService.retryCompensationTask(taskId);
            return Result.success();
        } catch (Exception e) {
            return Result.error("é‡è¯•å¤±è´¥: " + e.getMessage());
        }
    }
    
    /**
     * æ ‡è®°ä»»åŠ¡ä¸ºå·²æ‰‹åŠ¨å¤„ç†
     */
    @PostMapping("/mark-resolved/{taskId}")
    public Result<Void> markTaskResolved(@PathVariable Long taskId, 
                                       @RequestParam String resolveReason) {
        compensationService.markTaskResolved(taskId, resolveReason);
        return Result.success();
    }
}
```

---

## 6. ğŸ” æ•°æ®æ ¡éªŒä¸ä¿®å¤ç­–ç•¥


### 6.1 ä¸€è‡´æ€§æ£€æŸ¥æ–¹æ³•


> ğŸ“Œ **æ ¸å¿ƒæ€è·¯**  
> å®šæœŸå¯¹æ¯”ç¼“å­˜å’Œæ•°æ®åº“çš„æ•°æ®ï¼Œå‘ç°ä¸ä¸€è‡´åŠæ—¶ä¿®å¤

**æ•°æ®å¯¹æ¯”æ£€æŸ¥**ï¼š

```java
@Service
public class ConsistencyCheckService {
    
    @Autowired
    private RedisTemplate redisTemplate;
    
    @Autowired
    private UserMapper userMapper;
    
    /**
     * æ‰¹é‡æ£€æŸ¥ç”¨æˆ·æ•°æ®ä¸€è‡´æ€§
     */
    @Scheduled(cron = "0 0 2 * * ?") // æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
    public void checkUserDataConsistency() {
        log.info("å¼€å§‹æ£€æŸ¥ç”¨æˆ·æ•°æ®ä¸€è‡´æ€§");
        
        int pageSize = 1000;
        int pageNum = 1;
        int inconsistentCount = 0;
        
        while (true) {
            // åˆ†é¡µæŸ¥è¯¢ç”¨æˆ·æ•°æ®
            List<User> users = userMapper.selectByPage(pageNum, pageSize);
            if (users.isEmpty()) {
                break;
            }
            
            for (User dbUser : users) {
                String cacheKey = "user_" + dbUser.getId();
                User cachedUser = (User) redisTemplate.opsForValue().get(cacheKey);
                
                if (cachedUser != null && !isDataConsistent(dbUser, cachedUser)) {
                    // å‘ç°ä¸ä¸€è‡´ï¼Œè®°å½•å¹¶ä¿®å¤
                    inconsistentCount++;
                    recordInconsistency(dbUser.getId(), dbUser, cachedUser);
                    
                    // ä¿®å¤ï¼šç”¨æ•°æ®åº“æ•°æ®æ›´æ–°ç¼“å­˜
                    redisTemplate.opsForValue().set(cacheKey, dbUser, 30, TimeUnit.MINUTES);
                    log.warn("å‘ç°æ•°æ®ä¸ä¸€è‡´ï¼Œå·²ä¿®å¤: userId={}", dbUser.getId());
                }
            }
            
            pageNum++;
        }
        
        log.info("ç”¨æˆ·æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥å®Œæˆï¼Œå‘ç°ä¸ä¸€è‡´è®°å½•: {}", inconsistentCount);
    }
    
    /**
     * æ¯”è¾ƒä¸¤ä¸ªç”¨æˆ·å¯¹è±¡æ˜¯å¦ä¸€è‡´
     */
    private boolean isDataConsistent(User dbUser, User cachedUser) {
        return Objects.equals(dbUser.getName(), cachedUser.getName()) &&
               Objects.equals(dbUser.getEmail(), cachedUser.getEmail()) &&
               Objects.equals(dbUser.getPhone(), cachedUser.getPhone()) &&
               Objects.equals(dbUser.getUpdateTime(), cachedUser.getUpdateTime());
    }
    
    /**
     * è®°å½•æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µ
     */
    private void recordInconsistency(Long userId, User dbUser, User cachedUser) {
        InconsistencyRecord record = new InconsistencyRecord();
        record.setUserId(userId);
        record.setDbData(JSON.toJSONString(dbUser));
        record.setCacheData(JSON.toJSONString(cachedUser));
        record.setCheckTime(LocalDateTime.now());
        
        inconsistencyRecordMapper.insert(record);
    }
}
```

### 6.2 å®æ—¶æ ¡éªŒæœºåˆ¶


**è¯»å–æ—¶æ ¡éªŒ**ï¼š

```java
@Service
public class ValidatingCacheService {
    
    /**
     * å¸¦æ ¡éªŒçš„ç¼“å­˜è¯»å–
     */
    public User getUserWithValidation(Long userId) {
        String cacheKey = "user_" + userId;
        User cachedUser = (User) redisTemplate.opsForValue().get(cacheKey);
        
        if (cachedUser != null) {
            // æœ‰ä¸€å®šæ¦‚ç‡æ ¡éªŒç¼“å­˜æ•°æ®ï¼ˆæ¯”å¦‚5%ï¼‰
            if (shouldValidate()) {
                User dbUser = userMapper.selectById(userId);
                if (dbUser != null && !isDataConsistent(dbUser, cachedUser)) {
                    // å‘ç°ä¸ä¸€è‡´ï¼Œç«‹å³æ›´æ–°ç¼“å­˜
                    redisTemplate.opsForValue().set(cacheKey, dbUser, 30, TimeUnit.MINUTES);
                    log.warn("è¯»å–æ—¶å‘ç°ç¼“å­˜æ•°æ®ä¸ä¸€è‡´ï¼Œå·²æ›´æ–°: userId={}", userId);
                    return dbUser;
                }
            }
            return cachedUser;
        }
        
        // ç¼“å­˜ä¸ºç©ºï¼Œä»æ•°æ®åº“åŠ è½½
        User dbUser = userMapper.selectById(userId);
        if (dbUser != null) {
            redisTemplate.opsForValue().set(cacheKey, dbUser, 30, TimeUnit.MINUTES);
        }
        
        return dbUser;
    }
    
    /**
     * å†³å®šæ˜¯å¦è¿›è¡Œæ ¡éªŒï¼ˆ5%æ¦‚ç‡ï¼‰
     */
    private boolean shouldValidate() {
        return Math.random() < 0.05;
    }
}
```

### 6.3 è‡ªåŠ¨ä¿®å¤ç­–ç•¥


**ä¿®å¤ç­–ç•¥é€‰æ‹©**ï¼š

```
ç­–ç•¥1ï¼šç¼“å­˜ä¼˜å…ˆ
é€‚ç”¨åœºæ™¯ï¼šç¼“å­˜æ•°æ®æ›´æ–°é¢‘ç¹ï¼Œæ•°æ®åº“å¯èƒ½æœ‰å»¶è¿Ÿ
ä¿®å¤æ–¹æ³•ï¼šç”¨ç¼“å­˜æ•°æ®æ›´æ–°æ•°æ®åº“

ç­–ç•¥2ï¼šæ•°æ®åº“ä¼˜å…ˆï¼ˆæ¨èï¼‰
é€‚ç”¨åœºæ™¯ï¼šæ•°æ®åº“æ˜¯æƒå¨æ•°æ®æº
ä¿®å¤æ–¹æ³•ï¼šç”¨æ•°æ®åº“æ•°æ®æ›´æ–°ç¼“å­˜

ç­–ç•¥3ï¼šæ—¶é—´æˆ³ä¼˜å…ˆ
é€‚ç”¨åœºæ™¯ï¼šä¸¤è¾¹éƒ½æœ‰æ—¶é—´æˆ³ä¿¡æ¯
ä¿®å¤æ–¹æ³•ï¼šç”¨è¾ƒæ–°çš„æ•°æ®æ›´æ–°è¾ƒæ—§çš„æ•°æ®

ç­–ç•¥4ï¼šäººå·¥å¹²é¢„
é€‚ç”¨åœºæ™¯ï¼šå…³é”®æ•°æ®ï¼Œè‡ªåŠ¨ä¿®å¤é£é™©å¤§
ä¿®å¤æ–¹æ³•ï¼šè®°å½•å†²çªï¼Œäººå·¥å†³å®šä¿®å¤ç­–ç•¥
```

```java
@Service
public class AutoRepairService {
    
    /**
     * æ ¹æ®é…ç½®çš„ä¿®å¤ç­–ç•¥è‡ªåŠ¨ä¿®å¤æ•°æ®
     */
    public void autoRepairInconsistency(Long userId, User dbUser, User cachedUser, 
                                      RepairStrategy strategy) {
        String cacheKey = "user_" + userId;
        
        switch (strategy) {
            case DATABASE_FIRST:
                // ç”¨æ•°æ®åº“æ•°æ®æ›´æ–°ç¼“å­˜
                redisTemplate.opsForValue().set(cacheKey, dbUser, 30, TimeUnit.MINUTES);
                log.info("æ•°æ®åº“ä¼˜å…ˆä¿®å¤å®Œæˆ: userId={}", userId);
                break;
                
            case CACHE_FIRST:
                // ç”¨ç¼“å­˜æ•°æ®æ›´æ–°æ•°æ®åº“
                userMapper.updateById(cachedUser);
                log.info("ç¼“å­˜ä¼˜å…ˆä¿®å¤å®Œæˆ: userId={}", userId);
                break;
                
            case TIMESTAMP_FIRST:
                // æ¯”è¾ƒæ—¶é—´æˆ³ï¼Œç”¨è¾ƒæ–°çš„æ•°æ®æ›´æ–°è¾ƒæ—§çš„æ•°æ®
                if (dbUser.getUpdateTime().isAfter(cachedUser.getUpdateTime())) {
                    redisTemplate.opsForValue().set(cacheKey, dbUser, 30, TimeUnit.MINUTES);
                } else {
                    userMapper.updateById(cachedUser);
                }
                log.info("æ—¶é—´æˆ³ä¼˜å…ˆä¿®å¤å®Œæˆ: userId={}", userId);
                break;
                
            case MANUAL_INTERVENTION:
                // è®°å½•å†²çªï¼Œç­‰å¾…äººå·¥å¤„ç†
                recordConflictForManualResolution(userId, dbUser, cachedUser);
                log.info("å·²è®°å½•å†²çªï¼Œç­‰å¾…äººå·¥å¹²é¢„: userId={}", userId);
                break;
                
            default:
                throw new UnsupportedOperationException("ä¸æ”¯æŒçš„ä¿®å¤ç­–ç•¥: " + strategy);
        }
    }
}
```

---

## 7. ğŸ“Š ç›‘æ§å‘Šè­¦æœºåˆ¶


### 7.1 å…³é”®æŒ‡æ ‡ç›‘æ§


> ğŸ’¡ **ç›‘æ§æ€è·¯**  
> å°±åƒä½“æ£€ä¸€æ ·ï¼Œå®šæœŸæ£€æŸ¥å„é¡¹æŒ‡æ ‡ï¼Œæœ‰å¼‚å¸¸åŠæ—¶å¤„ç†

**æ ¸å¿ƒç›‘æ§æŒ‡æ ‡**ï¼š

```
ä¸€è‡´æ€§ç›¸å…³æŒ‡æ ‡ï¼š
- ç¼“å­˜å‘½ä¸­ç‡ï¼šåæ˜ ç¼“å­˜æ•ˆæœ
- æ•°æ®ä¸ä¸€è‡´æ¬¡æ•°ï¼šä¸€è‡´æ€§é—®é¢˜é¢‘ç‡  
- ä¿®å¤æˆåŠŸç‡ï¼šè‡ªåŠ¨ä¿®å¤èƒ½åŠ›
- è¡¥å¿ä»»åŠ¡æˆåŠŸç‡ï¼šå®¹é”™èƒ½åŠ›

æ€§èƒ½ç›¸å…³æŒ‡æ ‡ï¼š
- ç¼“å­˜å“åº”æ—¶é—´ï¼šç¼“å­˜æ€§èƒ½
- æ•°æ®åº“æŸ¥è¯¢æ—¶é—´ï¼šæ•°æ®åº“è´Ÿè½½
- åˆ†å¸ƒå¼é”ç­‰å¾…æ—¶é—´ï¼šå¹¶å‘å¤„ç†èƒ½åŠ›
- äº‹åŠ¡å¤„ç†æ—¶é—´ï¼šäº‹åŠ¡æ€§èƒ½
```

**ç›‘æ§æ•°æ®æ”¶é›†**ï¼š

```java
@Component
public class ConsistencyMetricsCollector {
    
    private final MeterRegistry meterRegistry;
    
    // è®¡æ•°å™¨ï¼šè®°å½•å„ç§äº‹ä»¶æ¬¡æ•°
    private final Counter cacheHitCounter;
    private final Counter cacheMissCounter;
    private final Counter inconsistencyCounter;
    private final Counter repairSuccessCounter;
    private final Counter repairFailCounter;
    
    // è®¡æ—¶å™¨ï¼šè®°å½•æ“ä½œè€—æ—¶
    private final Timer cacheQueryTimer;
    private final Timer dbQueryTimer;
    private final Timer lockWaitTimer;
    
    public ConsistencyMetricsCollector(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        
        // åˆå§‹åŒ–è®¡æ•°å™¨
        this.cacheHitCounter = Counter.builder("cache.hit")
            .description("ç¼“å­˜å‘½ä¸­æ¬¡æ•°")
            .register(meterRegistry);
        
        this.cacheMissCounter = Counter.builder("cache.miss")
            .description("ç¼“å­˜æœªå‘½ä¸­æ¬¡æ•°")
            .register(meterRegistry);
        
        this.inconsistencyCounter = Counter.builder("data.inconsistency")
            .description("æ•°æ®ä¸ä¸€è‡´æ¬¡æ•°")
            .register(meterRegistry);
        
        // åˆå§‹åŒ–è®¡æ—¶å™¨
        this.cacheQueryTimer = Timer.builder("cache.query.time")
            .description("ç¼“å­˜æŸ¥è¯¢æ—¶é—´")
            .register(meterRegistry);
        
        this.dbQueryTimer = Timer.builder("db.query.time")
            .description("æ•°æ®åº“æŸ¥è¯¢æ—¶é—´")
            .register(meterRegistry);
    }
    
    /**
     * è®°å½•ç¼“å­˜å‘½ä¸­
     */
    public void recordCacheHit() {
        cacheHitCounter.increment();
    }
    
    /**
     * è®°å½•ç¼“å­˜æœªå‘½ä¸­
     */
    public void recordCacheMiss() {
        cacheMissCounter.increment();
    }
    
    /**
     * è®°å½•æ•°æ®ä¸ä¸€è‡´
     */
    public void recordInconsistency(String type) {
        inconsistencyCounter.increment(Tags.of("type", type));
    }
    
    /**
     * è®°å½•æ“ä½œè€—æ—¶
     */
    public <T> T recordTime(Timer timer, Supplier<T> operation) {
        return timer.recordCallable(operation::get);
    }
}
```

### 7.2 å®æ—¶å‘Šè­¦é…ç½®


**å‘Šè­¦è§„åˆ™å®šä¹‰**ï¼š

```yaml
# å‘Šè­¦é…ç½®ç¤ºä¾‹
alerts:
  - name: "ç¼“å­˜å‘½ä¸­ç‡è¿‡ä½"
    condition: "cache_hit_rate < 0.8"  # å‘½ä¸­ç‡ä½äº80%
    duration: "5m"                     # æŒç»­5åˆ†é’Ÿ
    severity: "warning"
    message: "ç¼“å­˜å‘½ä¸­ç‡è¿‡ä½ï¼Œå¯èƒ½å­˜åœ¨ç¼“å­˜å¤±æ•ˆé—®é¢˜"
    
  - name: "æ•°æ®ä¸ä¸€è‡´é¢‘ç‡è¿‡é«˜"  
    condition: "inconsistency_rate > 0.01"  # ä¸ä¸€è‡´ç‡è¶…è¿‡1%
    duration: "1m"                           # æŒç»­1åˆ†é’Ÿ
    severity: "critical"
    message: "æ•°æ®ä¸ä¸€è‡´é¢‘ç‡å¼‚å¸¸ï¼Œéœ€è¦ç«‹å³æ£€æŸ¥"
    
  - name: "è¡¥å¿ä»»åŠ¡å¤±è´¥ç‡è¿‡é«˜"
    condition: "compensation_fail_rate > 0.1"  # å¤±è´¥ç‡è¶…è¿‡10%
    duration: "3m"                             # æŒç»­3åˆ†é’Ÿ  
    severity: "error"
    message: "è¡¥å¿ä»»åŠ¡å¤±è´¥ç‡è¿‡é«˜ï¼Œè¯·æ£€æŸ¥è¡¥å¿é€»è¾‘"
```

**å‘Šè­¦å¤„ç†æœåŠ¡**ï¼š

```java
@Service
public class AlertService {
    
    @Autowired
    private NotificationService notificationService;
    
    /**
     * å¤„ç†ä¸€è‡´æ€§ç›¸å…³å‘Šè­¦
     */
    public void handleConsistencyAlert(AlertEvent alertEvent) {
        switch (alertEvent.getAlertType()) {
            case CACHE_HIT_RATE_LOW:
                handleCacheHitRateLow(alertEvent);
                break;
                
            case INCONSISTENCY_RATE_HIGH:
                handleInconsistencyRateHigh(alertEvent);
                break;
                
            case COMPENSATION_FAIL_RATE_HIGH:
                handleCompensationFailRateHigh(alertEvent);
                break;
                
            default:
                log.warn("æœªçŸ¥çš„å‘Šè­¦ç±»å‹: {}", alertEvent.getAlertType());
        }
    }
    
    private void handleCacheHitRateLowoAlertEvent alertEvent) {
        // å‘é€å‘Šè­¦é€šçŸ¥
        String message = String.format(
            "ç¼“å­˜å‘½ä¸­ç‡è¿‡ä½å‘Šè­¦\n" +
            "å½“å‰å‘½ä¸­ç‡: %.2f%%\n" +
            "å‘Šè­¦æ—¶é—´: %s\n" +
            "å»ºè®®: æ£€æŸ¥ç¼“å­˜é…ç½®å’Œæ•°æ®çƒ­åº¦",
            alertEvent.getCurrentValue() * 100,
            alertEvent.getAlertTime()
        );
        
        notificationService.sendAlert(message, AlertLevel.WARNING);
        
        // è‡ªåŠ¨å¤„ç†ï¼šå¢åŠ ç¼“å­˜é¢„çƒ­
        cacheWarmUpService.preloadHotData();
    }
    
    private void handleInconsistencyRateHigh(AlertEvent alertEvent) {
        String message = String.format(
            "æ•°æ®ä¸ä¸€è‡´ç‡è¿‡é«˜å‘Šè­¦\n" +
            "å½“å‰ä¸ä¸€è‡´ç‡: %.2f%%\n" +
            "å‘Šè­¦æ—¶é—´: %s\n" +
            "å»ºè®®: ç«‹å³æ£€æŸ¥æ•°æ®åŒæ­¥é€»è¾‘",
            alertEvent.getCurrentValue() * 100,
            alertEvent.getAlertTime()
        );
        
        notificationService.sendAlert(message, AlertLevel.CRITICAL);
        
        // è‡ªåŠ¨å¤„ç†ï¼šè§¦å‘å…¨é‡æ•°æ®æ ¡éªŒ
        consistencyCheckService.triggerFullDataCheck();
    }
}
```

### 7.3 ç›‘æ§å¤§ç›˜å±•ç¤º


**å…³é”®æŒ‡æ ‡å¤§ç›˜**ï¼š

```
å®æ—¶ç›‘æ§å¤§ç›˜å±•ç¤ºå†…å®¹ï¼š

ğŸ“Š æ€§èƒ½æŒ‡æ ‡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¼“å­˜å‘½ä¸­ç‡    â”‚ 92.5% â†‘    â”‚
â”‚ å¹³å‡å“åº”æ—¶é—´  â”‚ 15ms â†“     â”‚  
â”‚ QPS          â”‚ 5,240 â†’    â”‚
â”‚ é”™è¯¯ç‡       â”‚ 0.02% â†“    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ” ä¸€è‡´æ€§æŒ‡æ ‡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ•°æ®ä¸ä¸€è‡´æ¬¡æ•° â”‚ 12 æ¬¡/å°æ—¶  â”‚
â”‚ è‡ªåŠ¨ä¿®å¤æˆåŠŸç‡ â”‚ 98.5%      â”‚
â”‚ è¡¥å¿ä»»åŠ¡ç§¯å‹   â”‚ 3 ä¸ª       â”‚
â”‚ äººå·¥å¹²é¢„éœ€æ±‚   â”‚ 0 ä¸ª       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âš ï¸ å‘Šè­¦çŠ¶æ€ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ´»è·ƒå‘Šè­¦     â”‚ 0 ä¸ª        â”‚
â”‚ ä»Šæ—¥å‘Šè­¦æ€»æ•°  â”‚ 5 ä¸ª        â”‚
â”‚ å·²å¤„ç†å‘Šè­¦   â”‚ 5 ä¸ª        â”‚
â”‚ å¾…å¤„ç†å‘Šè­¦   â”‚ 0 ä¸ª        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ ä¸€è‡´æ€§çº§åˆ«ï¼šå¼ºä¸€è‡´æ€§ã€æœ€ç»ˆä¸€è‡´æ€§ã€å¼±ä¸€è‡´æ€§çš„åŒºåˆ«å’Œé€‚ç”¨åœºæ™¯
ğŸ”¸ ç¼“å­˜æ¨¡å¼ï¼šCache Asideã€Write Throughã€Write Behindçš„å·¥ä½œåŸç†
ğŸ”¸ åˆ†å¸ƒå¼äº‹åŠ¡ï¼š2PCã€Sagaæ¨¡å¼çš„å®ç°æ–¹å¼å’Œä¼˜ç¼ºç‚¹
ğŸ”¸ è¡¥å¿æœºåˆ¶ï¼šè‡ªåŠ¨è¡¥å¿å’Œäººå·¥å¹²é¢„çš„è®¾è®¡æ€è·¯
ğŸ”¸ æ•°æ®æ ¡éªŒï¼šå®šæ—¶æ ¡éªŒã€å®æ—¶æ ¡éªŒã€è‡ªåŠ¨ä¿®å¤çš„å®ç°æ–¹æ³•
ğŸ”¸ ç›‘æ§å‘Šè­¦ï¼šå…³é”®æŒ‡æ ‡ç›‘æ§å’Œå¼‚å¸¸å¤„ç†æµç¨‹
```

### 8.2 å…³é”®å®è·µè¦ç‚¹


> ğŸ“Œ **è®°å¿†è¦ç‚¹**  
> ç¼“å­˜ä¸€è‡´æ€§ä¸æ˜¯æŠ€æœ¯é—®é¢˜ï¼Œè€Œæ˜¯ä¸šåŠ¡é—®é¢˜ - å…³é”®æ˜¯æ‰¾åˆ°æ€§èƒ½å’Œä¸€è‡´æ€§çš„å¹³è¡¡ç‚¹

**ä¸šåŠ¡åœºæ™¯ä¼˜å…ˆ**ï¼š
```
âœ… æ­£ç¡®çš„é€‰æ‹©æ€è·¯ï¼š
1. å…ˆåˆ†æä¸šåŠ¡å¯¹ä¸€è‡´æ€§çš„çœŸå®è¦æ±‚
2. å†é€‰æ‹©å¯¹åº”çš„æŠ€æœ¯æ–¹æ¡ˆ
3. æœ€åè®¾è®¡ç›‘æ§å’Œå…œåº•æ–¹æ¡ˆ

âŒ é”™è¯¯çš„é€‰æ‹©æ€è·¯ï¼š
1. æ‰€æœ‰æ•°æ®éƒ½è¦æ±‚å¼ºä¸€è‡´æ€§
2. åªå…³æ³¨æŠ€æœ¯å®ç°ï¼Œå¿½è§†ä¸šåŠ¡éœ€æ±‚
3. æ²¡æœ‰ç›‘æ§å’Œå¼‚å¸¸å¤„ç†æœºåˆ¶
```

**åˆ†å±‚è®¾è®¡ç­–ç•¥**ï¼š
```
åº”ç”¨å±‚ï¼šä¸šåŠ¡é€»è¾‘ï¼Œå†³å®šä¸€è‡´æ€§è¦æ±‚
ç¼“å­˜å±‚ï¼šç¼“å­˜ç­–ç•¥ï¼Œæä¾›æ€§èƒ½ä¼˜åŒ–
æ•°æ®å±‚ï¼šæƒå¨æ•°æ®æºï¼Œä¿è¯æ•°æ®å®‰å…¨
ç›‘æ§å±‚ï¼šå®æ—¶ç›‘æ§ï¼ŒåŠæ—¶å‘ç°é—®é¢˜
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


**å¼ºä¸€è‡´æ€§åœºæ™¯**ï¼š
- é‡‘èäº¤æ˜“ï¼šä½™é¢ã€è½¬è´¦è®°å½•
- åº“å­˜ç®¡ç†ï¼šå•†å“åº“å­˜æ•°é‡
- æƒé™æ§åˆ¶ï¼šç”¨æˆ·æƒé™ä¿¡æ¯
- è®¢å•çŠ¶æ€ï¼šæ”¯ä»˜çŠ¶æ€å˜æ›´

**æœ€ç»ˆä¸€è‡´æ€§åœºæ™¯**ï¼š
- ç”¨æˆ·èµ„æ–™ï¼šå¤´åƒã€æ˜µç§°æ›´æ–°
- ç¤¾äº¤åŠŸèƒ½ï¼šç‚¹èµã€è¯„è®ºæ•°é‡
- å†…å®¹æ¨èï¼šç”¨æˆ·åå¥½æ•°æ®
- ç»Ÿè®¡æ•°æ®ï¼šè®¿é—®é‡ã€çƒ­åº¦æ’è¡Œ

**æ€§èƒ½ä¼˜åŒ–å»ºè®®**ï¼š
```
1. åˆç†è®¾ç½®ç¼“å­˜è¿‡æœŸæ—¶é—´
2. ä½¿ç”¨å¼‚æ­¥æ›´æ–°å‡å°‘é˜»å¡
3. æ‰¹é‡å¤„ç†æé«˜æ•ˆç‡
4. è®¾è®¡åˆç†çš„é™çº§ç­–ç•¥
5. å»ºç«‹å®Œå–„çš„ç›‘æ§ä½“ç³»
```

### 8.4 å¸¸è§é—®é¢˜ä¸è§£å†³


**Q: ç¼“å­˜æ›´æ–°å¤±è´¥æ€ä¹ˆåŠï¼Ÿ**
```
A: è®¾è®¡é‡è¯•æœºåˆ¶å’Œè¡¥å¿æµç¨‹
- ç«‹å³é‡è¯•ï¼ˆé€‚ç”¨äºä¸´æ—¶ç½‘ç»œé—®é¢˜ï¼‰
- å»¶æ—¶é‡è¯•ï¼ˆé€‚ç”¨äºæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼‰
- è¡¥å¿å¤„ç†ï¼ˆé€‚ç”¨äºæŒç»­å¤±è´¥çš„æƒ…å†µï¼‰
- äººå·¥å¹²é¢„ï¼ˆé€‚ç”¨äºå¤æ‚çš„ä¸šåŠ¡åœºæ™¯ï¼‰
```

**Q: å¦‚ä½•å¤„ç†ç¼“å­˜é›ªå´©ï¼Ÿ**
```
A: å¤šå±‚é˜²æŠ¤ç­–ç•¥
- ç¼“å­˜é¢„çƒ­ï¼šæå‰åŠ è½½çƒ­ç‚¹æ•°æ®
- è¿‡æœŸæ—¶é—´éšæœºåŒ–ï¼šé¿å…åŒæ—¶è¿‡æœŸ
- é™æµé™çº§ï¼šæ§åˆ¶æ•°æ®åº“è®¿é—®é‡
- å¤šçº§ç¼“å­˜ï¼šæœ¬åœ°ç¼“å­˜+åˆ†å¸ƒå¼ç¼“å­˜
```

**Q: åˆ†å¸ƒå¼é”æ€§èƒ½å½±å“å¤§æ€ä¹ˆåŠï¼Ÿ**
```
A: ä¼˜åŒ–é”çš„ä½¿ç”¨æ–¹å¼
- å‡å°é”çš„ç²’åº¦ï¼šæŒ‰ä¸šåŠ¡ç»´åº¦åˆ†é”
- ç¼©çŸ­é”çš„æ—¶é—´ï¼šå¿«é€Ÿå¤„ç†ï¼ŒåŠæ—¶é‡Šæ”¾
- ä½¿ç”¨ä¹è§‚é”ï¼šé€‚ç”¨äºå†²çªè¾ƒå°‘çš„åœºæ™¯
- å¼‚æ­¥å¤„ç†ï¼šå°†åŒæ­¥æ“ä½œæ”¹ä¸ºå¼‚æ­¥
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- ä¸€è‡´æ€§éœ€æ±‚ä¸šåŠ¡å®šï¼ŒæŠ€æœ¯æ–¹æ¡ˆè·Ÿç€èµ°
- å¼ºå¼±ä¸€è‡´è¦åˆ†æ¸…ï¼Œæ€§èƒ½å®‰å…¨éœ€å¹³è¡¡  
- ç›‘æ§å‘Šè­¦ä¸å¯å°‘ï¼Œé—®é¢˜å‘ç°è¦è¶æ—©
- è¡¥å¿æœºåˆ¶åšå…œåº•ï¼Œå¼‚å¸¸å¤„ç†è¦å®Œæ•´