---
title: 4ã€æ•°æ®ä¸€è‡´æ€§ç»¼åˆä¿éšœ
---
## ğŸ“š ç›®å½•

1. [æ•°æ®ä¸€è‡´æ€§åŸºæœ¬æ¦‚å¿µ](#1-æ•°æ®ä¸€è‡´æ€§åŸºæœ¬æ¦‚å¿µ)
2. [æœ€ç»ˆä¸€è‡´æ€§å®ç°ç­–ç•¥](#2-æœ€ç»ˆä¸€è‡´æ€§å®ç°ç­–ç•¥)
3. [å¼ºä¸€è‡´æ€§åœºæ™¯å¤„ç†](#3-å¼ºä¸€è‡´æ€§åœºæ™¯å¤„ç†)
4. [åˆ†å¸ƒå¼äº‹åŠ¡é›†æˆæ–¹æ¡ˆ](#4-åˆ†å¸ƒå¼äº‹åŠ¡é›†æˆæ–¹æ¡ˆ)
5. [è¡¥å¿æœºåˆ¶è®¾è®¡](#5-è¡¥å¿æœºåˆ¶è®¾è®¡)
6. [æ•°æ®æ ¡éªŒä¸ç›‘æ§](#6-æ•°æ®æ ¡éªŒä¸ç›‘æ§)
7. [æ•…éšœæ¢å¤é¢„æ¡ˆ](#7-æ•…éšœæ¢å¤é¢„æ¡ˆ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ æ•°æ®ä¸€è‡´æ€§åŸºæœ¬æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯æ•°æ®ä¸€è‡´æ€§


**ğŸ”¸ ç®€å•ç†è§£**
æƒ³è±¡ä½ åœ¨é“¶è¡Œè½¬è´¦ï¼Œä»Aè´¦æˆ·è½¬100å…ƒåˆ°Bè´¦æˆ·ã€‚æ•°æ®ä¸€è‡´æ€§å°±æ˜¯ç¡®ä¿ï¼š
- Aè´¦æˆ·ç¡®å®å‡å°‘äº†100å…ƒ
- Bè´¦æˆ·ç¡®å®å¢åŠ äº†100å…ƒ
- ä¸ä¼šå‡ºç°é’±å‡­ç©ºæ¶ˆå¤±æˆ–å‡­ç©ºäº§ç”Ÿçš„æƒ…å†µ

```
è½¬è´¦å‰ï¼šA=1000, B=500
è½¬è´¦åï¼šA=900,  B=600  âœ… ä¸€è‡´
è½¬è´¦å¼‚å¸¸ï¼šA=900,  B=500  âŒ ä¸ä¸€è‡´ï¼ˆé’±ä¸¢äº†ï¼‰
```

**ğŸ’¡ å¾®æœåŠ¡ä¸­çš„æŒ‘æˆ˜**
åœ¨å•ä½“åº”ç”¨ä¸­ï¼Œè¿™å¾ˆç®€å•ï¼Œç”¨æ•°æ®åº“äº‹åŠ¡å°±è¡Œã€‚ä½†å¾®æœåŠ¡æ¶æ„ä¸‹ï¼š
- ç”¨æˆ·æœåŠ¡ç®¡ç†è´¦æˆ·ä¿¡æ¯
- è®¢å•æœåŠ¡å¤„ç†è®¢å•
- åº“å­˜æœåŠ¡ç®¡ç†å•†å“åº“å­˜
- æ”¯ä»˜æœåŠ¡å¤„ç†ä»˜æ¬¾

è¿™äº›æœåŠ¡åˆ†å¸ƒåœ¨ä¸åŒçš„æœºå™¨ä¸Šï¼Œä½¿ç”¨ä¸åŒçš„æ•°æ®åº“ï¼Œå¦‚ä½•ä¿è¯å®ƒä»¬çš„æ•°æ®ä¿æŒä¸€è‡´ï¼Ÿ

### 1.2 ä¸€è‡´æ€§çš„åˆ†ç±»


**ğŸ”¹ å¼ºä¸€è‡´æ€§ï¼ˆStrong Consistencyï¼‰**
```
ç‰¹ç‚¹ï¼šä»»ä½•æ—¶å€™è¯»å–æ•°æ®éƒ½æ˜¯æœ€æ–°çš„
åœºæ™¯ï¼šé“¶è¡Œè½¬è´¦ã€åº“å­˜æ‰£å‡
ä»£ä»·ï¼šæ€§èƒ½è¾ƒä½ï¼Œå¯ç”¨æ€§è¾ƒå·®

å®é™…ä¾‹å­ï¼š
ä½ åˆšåˆšæ”¯ä»˜å®Œè®¢å•ï¼Œç«‹å³æŸ¥è¯¢ä½™é¢ï¼Œå¿…é¡»çœ‹åˆ°æ‰£æ¬¾åçš„é‡‘é¢
```

**ğŸ”¹ æœ€ç»ˆä¸€è‡´æ€§ï¼ˆEventual Consistencyï¼‰**
```
ç‰¹ç‚¹ï¼šæ•°æ®ä¼šåœ¨ä¸€æ®µæ—¶é—´åå˜æˆä¸€è‡´çŠ¶æ€
åœºæ™¯ï¼šç”¨æˆ·ä¿¡æ¯åŒæ­¥ã€å•†å“è¯„ä»·
ä¼˜åŠ¿ï¼šæ€§èƒ½å¥½ï¼Œå¯ç”¨æ€§é«˜

å®é™…ä¾‹å­ï¼š
ä½ ä¿®æ”¹äº†ä¸ªäººèµ„æ–™ï¼Œå¯èƒ½å‡ åˆ†é’Ÿåå…¶ä»–é¡µé¢æ‰æ˜¾ç¤ºæ›´æ–°åçš„ä¿¡æ¯
```

**ğŸ”¹ å¼±ä¸€è‡´æ€§ï¼ˆWeak Consistencyï¼‰**
```
ç‰¹ç‚¹ï¼šä¸ä¿è¯ä»€ä¹ˆæ—¶å€™æ•°æ®ä¼šä¸€è‡´
åœºæ™¯ï¼šç¼“å­˜æ›´æ–°ã€ç»Ÿè®¡æ•°æ®
é€‚ç”¨ï¼šå¯¹ä¸€è‡´æ€§è¦æ±‚ä¸é«˜çš„åœºæ™¯
```

### 1.3 CAPç†è®ºç®€å•ç†è§£


> **ğŸ“‹ CAPå®šç†**
> åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ã€å¯ç”¨æ€§ï¼ˆAvailabilityï¼‰ã€åˆ†åŒºå®¹é”™æ€§ï¼ˆPartition toleranceï¼‰ä¸‰è€…ä¸èƒ½åŒæ—¶æ»¡è¶³

```
ç”Ÿæ´»ç±»æ¯”ï¼š
ä½ å¼€äº†3å®¶è¿é”åº—ï¼ˆåˆ†å¸ƒå¼ï¼‰ï¼Œçªç„¶ç½‘ç»œæ–­äº†ï¼ˆåˆ†åŒºæ•…éšœï¼‰

é€‰æ‹©1ï¼šä¿è¯ä¸€è‡´æ€§ + åˆ†åŒºå®¹é”™
â†’ æ–­ç½‘çš„åº—åœæ­¢è¥ä¸šï¼Œç¡®ä¿æ‰€æœ‰åº—ä¿¡æ¯åŒæ­¥
â†’ ç‰ºç‰²äº†å¯ç”¨æ€§

é€‰æ‹©2ï¼šä¿è¯å¯ç”¨æ€§ + åˆ†åŒºå®¹é”™  
â†’ æ–­ç½‘çš„åº—ç»§ç»­è¥ä¸šï¼Œä½†å¯èƒ½ä¿¡æ¯ä¸åŒæ­¥
â†’ ç‰ºç‰²äº†ä¸€è‡´æ€§
```

---

## 2. âš¡ æœ€ç»ˆä¸€è‡´æ€§å®ç°ç­–ç•¥


### 2.1 åŸºäºæ¶ˆæ¯é˜Ÿåˆ—çš„å¼‚æ­¥åŒæ­¥


**ğŸ¯ æ ¸å¿ƒæ€è·¯**
å½“ä¸€ä¸ªæœåŠ¡çš„æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå‘é€æ¶ˆæ¯é€šçŸ¥å…¶ä»–ç›¸å…³æœåŠ¡æ›´æ–°æ•°æ®ã€‚

```java
// ç”¨æˆ·æœåŠ¡ï¼šç”¨æˆ·ä¿¡æ¯æ›´æ–°åå‘é€æ¶ˆæ¯
@Service
public class UserService {
    
    @Autowired
    private MessageProducer messageProducer;
    
    public void updateUserInfo(User user) {
        // 1. æ›´æ–°æœ¬åœ°æ•°æ®åº“
        userRepository.save(user);
        
        // 2. å‘é€æ¶ˆæ¯é€šçŸ¥å…¶ä»–æœåŠ¡
        UserUpdateEvent event = new UserUpdateEvent(user.getId(), user.getName());
        messageProducer.send("user-update-topic", event);
    }
}
```

**ğŸ”§ å…¶ä»–æœåŠ¡ç›‘å¬æ¶ˆæ¯**
```java
// è®¢å•æœåŠ¡ï¼šç›‘å¬ç”¨æˆ·æ›´æ–°æ¶ˆæ¯
@Component
public class UserUpdateListener {
    
    @RabbitListener(queues = "order-service-user-update")
    public void handleUserUpdate(UserUpdateEvent event) {
        // æ›´æ–°è®¢å•ä¸­çš„ç”¨æˆ·ä¿¡æ¯
        orderService.updateUserInfo(event.getUserId(), event.getUserName());
    }
}
```

**ğŸ’­ é€šä¿—è§£é‡Š**
å°±åƒä½ æ¬å®¶åè¦é€šçŸ¥æœ‹å‹ä»¬æ–°åœ°å€ä¸€æ ·ï¼š
- ä½ æ›´æ–°äº†è‡ªå·±çš„åœ°å€æœ¬ï¼ˆæœ¬åœ°æ•°æ®åº“ï¼‰
- ç„¶åç»™æœ‹å‹ä»¬å‘å¾®ä¿¡ï¼ˆå‘é€æ¶ˆæ¯ï¼‰
- æœ‹å‹ä»¬æ”¶åˆ°æ¶ˆæ¯åæ›´æ–°ä»–ä»¬çš„é€šè®¯å½•ï¼ˆå…¶ä»–æœåŠ¡æ›´æ–°æ•°æ®ï¼‰

### 2.2 äº‹ä»¶é©±åŠ¨æ¶æ„æ¨¡å¼


**ğŸ“‹ äº‹ä»¶å‘å¸ƒè®¢é˜…**
```
äº‹ä»¶æµç¨‹ï¼š
ç”¨æˆ·æ³¨å†Œ â†’ å‘å¸ƒ"ç”¨æˆ·æ³¨å†Œäº‹ä»¶" â†’ å¤šä¸ªæœåŠ¡ç›‘å¬å¤„ç†

ç›‘å¬æœåŠ¡ï¼š
â€¢ é‚®ä»¶æœåŠ¡ï¼šå‘é€æ¬¢è¿é‚®ä»¶
â€¢ ç§¯åˆ†æœåŠ¡ï¼šèµ é€æ–°ç”¨æˆ·ç§¯åˆ†  
â€¢ ç»Ÿè®¡æœåŠ¡ï¼šæ›´æ–°æ³¨å†Œç”¨æˆ·æ•°
```

```java
// äº‹ä»¶å®šä¹‰
public class UserRegisteredEvent {
    private String userId;
    private String email;
    private Date registTime;
    // æ„é€ æ–¹æ³•å’Œgetter/setter
}

// äº‹ä»¶å‘å¸ƒ
@EventListener
public void publishUserRegisteredEvent(User user) {
    UserRegisteredEvent event = new UserRegisteredEvent(
        user.getId(), user.getEmail(), new Date()
    );
    eventPublisher.publishEvent(event);
}
```

**â­ ä¼˜åŠ¿åˆ†æ**
- **è§£è€¦æ€§å¼º**ï¼šæœåŠ¡ä¹‹é—´ä¸éœ€è¦ç›´æ¥è°ƒç”¨
- **æ‰©å±•æ€§å¥½**ï¼šæ–°å¢æœåŠ¡åªéœ€è¦ç›‘å¬ç›¸å…³äº‹ä»¶
- **å¯é æ€§é«˜**ï¼šæ¶ˆæ¯é˜Ÿåˆ—ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±

### 2.3 æ•°æ®åº“å˜æ›´æ—¥å¿—åŒæ­¥


**ğŸ”¸ åŸºäºBinlogçš„æ•°æ®åŒæ­¥**
```
åŸç†ï¼šç›‘å¬æ•°æ®åº“çš„å˜æ›´æ—¥å¿—ï¼Œå°†å˜æ›´åŒæ­¥åˆ°å…¶ä»–ç³»ç»Ÿ

å·¥å…·ï¼šCanalã€Maxwellã€Debezium

æµç¨‹ï¼š
MySQL Binlog â†’ Canalç›‘å¬ â†’ å‘é€MQæ¶ˆæ¯ â†’ å…¶ä»–æœåŠ¡æ¶ˆè´¹
```

**ğŸ“Š åŒæ­¥ç­–ç•¥å¯¹æ¯”**

| åŒæ­¥æ–¹å¼ | **å®æ—¶æ€§** | **å¤æ‚åº¦** | **å¯é æ€§** | **é€‚ç”¨åœºæ™¯** |
|---------|-----------|-----------|-----------|-------------|
| æ¶ˆæ¯é˜Ÿåˆ— | `ç§’çº§` | `ä¸­ç­‰` | `é«˜` | `ä¸šåŠ¡æ•°æ®åŒæ­¥` |
| å®šæ—¶ä»»åŠ¡ | `åˆ†é’Ÿçº§` | `ç®€å•` | `ä¸­ç­‰` | `ç»Ÿè®¡æ•°æ®åŒæ­¥` |
| Binlogç›‘å¬ | `æ¯«ç§’çº§` | `é«˜` | `å¾ˆé«˜` | `å®æ—¶æ•°æ®åŒæ­¥` |

---

## 3. ğŸ”’ å¼ºä¸€è‡´æ€§åœºæ™¯å¤„ç†


### 3.1 åˆ†å¸ƒå¼é”ä¿è¯å¼ºä¸€è‡´


**ğŸ¯ å…¸å‹åœºæ™¯ï¼šç§’æ€å•†å“åº“å­˜æ‰£å‡**

> **â“ ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”ï¼Ÿ**
> å‡è®¾å•†å“åªæœ‰1ä»¶ï¼Œä½†åŒæ—¶æœ‰100ä¸ªç”¨æˆ·ä¸‹å•ï¼Œå¦‚æœä¸åŠ é”ï¼Œå¯èƒ½ä¼šè¶…å–

```java
@Service
public class SeckillService {
    
    @Autowired
    private RedisTemplate redisTemplate;
    
    public boolean seckillProduct(String productId, String userId) {
        String lockKey = "seckill:lock:" + productId;
        String lockValue = UUID.randomUUID().toString();
        
        try {
            // 1. è·å–åˆ†å¸ƒå¼é”
            Boolean locked = redisTemplate.opsForValue()
                .setIfAbsent(lockKey, lockValue, Duration.ofSeconds(10));
            
            if (!locked) {
                return false; // è·å–é”å¤±è´¥
            }
            
            // 2. æ£€æŸ¥åº“å­˜
            Integer stock = getStock(productId);
            if (stock <= 0) {
                return false; // åº“å­˜ä¸è¶³
            }
            
            // 3. æ‰£å‡åº“å­˜
            reduceStock(productId, 1);
            
            // 4. åˆ›å»ºè®¢å•
            createOrder(productId, userId);
            
            return true;
            
        } finally {
            // 5. é‡Šæ”¾é”
            releaseLock(lockKey, lockValue);
        }
    }
}
```

**ğŸ”§ é”çš„å®‰å…¨é‡Šæ”¾**
```java
// Luaè„šæœ¬ä¿è¯åŸå­æ€§é‡Šæ”¾é”
private void releaseLock(String lockKey, String lockValue) {
    String script = "if redis.call('get', KEYS[1]) == ARGV[1] then " +
                   "return redis.call('del', KEYS[1]) else return 0 end";
    redisTemplate.execute(new DefaultRedisScript<>(script, Long.class), 
                         Arrays.asList(lockKey), lockValue);
}
```

### 3.2 æ•°æ®åº“äº‹åŠ¡ä¸åˆ†å¸ƒå¼äº‹åŠ¡


**ğŸ”¸ æœ¬åœ°äº‹åŠ¡ vs åˆ†å¸ƒå¼äº‹åŠ¡**
```
æœ¬åœ°äº‹åŠ¡ï¼š
ä¸€ä¸ªæ•°æ®åº“å†…çš„å¤šä¸ªæ“ä½œè¦ä¹ˆå…¨æˆåŠŸï¼Œè¦ä¹ˆå…¨å¤±è´¥

åˆ†å¸ƒå¼äº‹åŠ¡ï¼š
å¤šä¸ªæœåŠ¡ã€å¤šä¸ªæ•°æ®åº“çš„æ“ä½œè¦ä¹ˆå…¨æˆåŠŸï¼Œè¦ä¹ˆå…¨å¤±è´¥
```

**ğŸ’¡ ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰ç®€åŒ–ç†è§£**
```
å‡†å¤‡é˜¶æ®µï¼š
åè°ƒè€…ï¼š"å¤§å®¶èƒ½å¦å®Œæˆè¿™ä¸ªäº‹åŠ¡ï¼Ÿ"
å‚ä¸è€…Aï¼š"æˆ‘å¯ä»¥"
å‚ä¸è€…Bï¼š"æˆ‘å¯ä»¥"
å‚ä¸è€…Cï¼š"æˆ‘ä¸è¡Œ"

æäº¤é˜¶æ®µï¼š
åè°ƒè€…ï¼š"æœ‰äººè¯´ä¸è¡Œï¼Œå¤§å®¶éƒ½å›æ»š"
æ‰€æœ‰å‚ä¸è€…ï¼š"å¥½çš„ï¼Œå›æ»šå®Œæˆ"
```

---

## 4. ğŸ”„ åˆ†å¸ƒå¼äº‹åŠ¡é›†æˆæ–¹æ¡ˆ


### 4.1 Seata ATæ¨¡å¼é›†æˆ


**ğŸ”¸ Seataç®€å•ä»‹ç»**
Seataæ˜¯é˜¿é‡Œå¼€æºçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œè®©ä½ åƒä½¿ç”¨æœ¬åœ°äº‹åŠ¡ä¸€æ ·ä½¿ç”¨åˆ†å¸ƒå¼äº‹åŠ¡ã€‚

```java
// åªéœ€è¦åŠ ä¸€ä¸ªæ³¨è§£ï¼Œå°±èƒ½å®ç°åˆ†å¸ƒå¼äº‹åŠ¡
@GlobalTransactional
public void createOrder(OrderRequest request) {
    // 1. æ‰£å‡åº“å­˜ï¼ˆè°ƒç”¨åº“å­˜æœåŠ¡ï¼‰
    inventoryService.reduceStock(request.getProductId(), request.getQuantity());
    
    // 2. æ‰£å‡ä½™é¢ï¼ˆè°ƒç”¨è´¦æˆ·æœåŠ¡ï¼‰  
    accountService.deductBalance(request.getUserId(), request.getAmount());
    
    // 3. åˆ›å»ºè®¢å•ï¼ˆæœ¬åœ°æœåŠ¡ï¼‰
    orderService.createOrder(request);
    
    // å¦‚æœä»»ä½•ä¸€æ­¥å¤±è´¥ï¼Œæ‰€æœ‰æ“ä½œéƒ½ä¼šå›æ»š
}
```

**ğŸ“‹ ATæ¨¡å¼å·¥ä½œåŸç†**
```
æ‰§è¡Œé˜¶æ®µï¼š
1. æ¯ä¸ªæœåŠ¡æ­£å¸¸æ‰§è¡Œä¸šåŠ¡é€»è¾‘
2. Seataè‡ªåŠ¨è®°å½•SQLçš„å‰åé•œåƒ
3. å‘TCæ³¨å†Œåˆ†æ”¯äº‹åŠ¡

æäº¤é˜¶æ®µï¼š
â€¢ æˆåŠŸï¼šåˆ é™¤undo logï¼Œé‡Šæ”¾é”
â€¢ å¤±è´¥ï¼šæ ¹æ®undo logå›æ»šæ•°æ®
```

### 4.2 TCCæ¨¡å¼çš„åº”ç”¨


**ğŸ¯ TCCä¸‰ä¸ªé˜¶æ®µ**
- **Try**ï¼šå°è¯•æ‰§è¡Œï¼Œé¢„ç•™èµ„æº
- **Confirm**ï¼šç¡®è®¤æ‰§è¡Œï¼ŒçœŸæ­£æäº¤
- **Cancel**ï¼šå–æ¶ˆæ‰§è¡Œï¼Œé‡Šæ”¾èµ„æº

```java
// è´¦æˆ·æœåŠ¡çš„TCCå®ç°
@LocalTCC
public interface AccountTccService {
    
    @TwoPhaseBusinessAction(name = "deductBalance")
    boolean tryDeduct(String userId, BigDecimal amount);
    
    boolean confirmDeduct(BusinessActionContext context);
    
    boolean cancelDeduct(BusinessActionContext context);
}

@Service
public class AccountTccServiceImpl implements AccountTccService {
    
    public boolean tryDeduct(String userId, BigDecimal amount) {
        // å†»ç»“èµ„é‡‘ï¼Œä¸çœŸæ­£æ‰£å‡
        return accountService.freezeBalance(userId, amount);
    }
    
    public boolean confirmDeduct(BusinessActionContext context) {
        // çœŸæ­£æ‰£å‡å†»ç»“çš„èµ„é‡‘
        return accountService.deductFrozenBalance(userId, amount);
    }
    
    public boolean cancelDeduct(BusinessActionContext context) {
        // è§£å†»èµ„é‡‘
        return accountService.unfreezeBalance(userId, amount);
    }
}
```

**ğŸ”¹ TCC vs ATæ¨¡å¼å¯¹æ¯”**

| ç‰¹æ€§ | **ATæ¨¡å¼** | **TCCæ¨¡å¼** | **é€‰æ‹©å»ºè®®** |
|------|-----------|------------|-------------|
| ä»£ç ä¾µå…¥ | `ä½` | `é«˜` | `å¿«é€Ÿå¼€å‘é€‰AT` |
| æ•°æ®ä¸€è‡´æ€§ | `æœ€ç»ˆä¸€è‡´` | `å¼ºä¸€è‡´` | `é‡‘èåœºæ™¯é€‰TCC` |
| æ€§èƒ½ | `è¾ƒå¥½` | `æ›´å¥½` | `é«˜æ€§èƒ½é€‰TCC` |
| å¼€å‘å¤æ‚åº¦ | `ç®€å•` | `å¤æ‚` | `å›¢é˜ŸæŠ€æœ¯èƒ½åŠ›è€ƒè™‘` |

---

## 5. ğŸ› ï¸ è¡¥å¿æœºåˆ¶è®¾è®¡


### 5.1 è¡¥å¿äº‹åŠ¡æ¨¡å¼


**ğŸ’¡ ä»€ä¹ˆæ˜¯è¡¥å¿**
å½“åˆ†å¸ƒå¼äº‹åŠ¡å¤±è´¥æ—¶ï¼Œå¯¹å·²ç»æˆåŠŸçš„æ“ä½œè¿›è¡Œåå‘æ“ä½œï¼Œæ¢å¤åˆ°äº‹åŠ¡å¼€å§‹å‰çš„çŠ¶æ€ã€‚

```
æ­£å‘æ“ä½œï¼šåˆ›å»ºè®¢å• â†’ æ‰£å‡åº“å­˜ â†’ æ‰£æ¬¾
å¤±è´¥è¡¥å¿ï¼šæ¢å¤åº“å­˜ â† é€€æ¬¾ â† å–æ¶ˆè®¢å•
```

**ğŸ”§ è¡¥å¿æ“ä½œè®¾è®¡åŸåˆ™**
```java
public class OrderCompensationService {
    
    // è¡¥å¿æ“ä½œå¿…é¡»æ˜¯å¹‚ç­‰çš„
    public void compensateOrder(String orderId) {
        // 1. æ£€æŸ¥è®¢å•çŠ¶æ€ï¼Œé¿å…é‡å¤è¡¥å¿
        Order order = orderService.getOrder(orderId);
        if (order.getStatus() == OrderStatus.COMPENSATED) {
            return; // å·²ç»è¡¥å¿è¿‡äº†
        }
        
        // 2. æ‰§è¡Œè¡¥å¿æ“ä½œ
        try {
            // æ¢å¤åº“å­˜
            inventoryService.restoreStock(order.getProductId(), order.getQuantity());
            
            // é€€æ¬¾
            paymentService.refund(order.getPaymentId());
            
            // æ ‡è®°è®¢å•ä¸ºå·²è¡¥å¿
            orderService.markAsCompensated(orderId);
            
        } catch (Exception e) {
            // è¡¥å¿å¤±è´¥ï¼Œè®°å½•æ—¥å¿—ï¼Œäººå·¥å¤„ç†
            log.error("è¡¥å¿å¤±è´¥ï¼Œè®¢å•ID: {}", orderId, e);
        }
    }
}
```

### 5.2 Sagaæ¨¡å¼å®ç°


**ğŸ”¸ Sagaæ¨¡å¼ç†è§£**
å°†ä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡åˆ†è§£ä¸ºå¤šä¸ªæœ¬åœ°äº‹åŠ¡ï¼Œæ¯ä¸ªæœ¬åœ°äº‹åŠ¡éƒ½æœ‰å¯¹åº”çš„è¡¥å¿æ“ä½œã€‚

```
è®¢å•æµç¨‹ Sagaï¼š
æ­¥éª¤1ï¼šåˆ›å»ºè®¢å• (è¡¥å¿ï¼šå–æ¶ˆè®¢å•)
æ­¥éª¤2ï¼šæ‰£å‡åº“å­˜ (è¡¥å¿ï¼šæ¢å¤åº“å­˜)  
æ­¥éª¤3ï¼šæ‰£æ¬¾æ”¯ä»˜ (è¡¥å¿ï¼šé€€æ¬¾)
æ­¥éª¤4ï¼šå‘è´§å¤„ç† (è¡¥å¿ï¼šå–æ¶ˆå‘è´§)
```

**ğŸ“‹ ç¼–æ’å¼ vs åè°ƒå¼**

```java
// ç¼–æ’å¼ï¼šæ¯ä¸ªæœåŠ¡çŸ¥é“ä¸‹ä¸€æ­¥è¯¥è°ƒç”¨è°
@Service
public class OrderOrchestrator {
    
    @SagaOrchestrationStart
    public void processOrder(OrderRequest request) {
        // æ­¥éª¤å®šä¹‰
        SagaDefinition saga = SagaDefinition.create()
            .step("createOrder")
                .invokeLocal(this::createOrder)
                .withCompensation(this::cancelOrder)
            .step("reduceInventory")
                .invokeRemote(inventoryService::reduceStock)
                .withCompensation(inventoryService::restoreStock)
            .step("processPayment")
                .invokeRemote(paymentService::pay)
                .withCompensation(paymentService::refund);
                
        sagaManager.execute(saga, request);
    }
}
```

---

## 6. ğŸ“Š æ•°æ®æ ¡éªŒä¸ç›‘æ§


### 6.1 æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥ç­–ç•¥


**ğŸ”¸ å®æ—¶æ ¡éªŒ vs å®šæ—¶æ ¡éªŒ**

```java
// å®æ—¶æ ¡éªŒï¼šå…³é”®æ“ä½œåç«‹å³æ£€æŸ¥
@Service
public class ConsistencyChecker {
    
    @Async
    public void checkOrderConsistency(String orderId) {
        // è·å–è®¢å•ä¿¡æ¯
        Order order = orderService.getOrder(orderId);
        
        // æ£€æŸ¥åº“å­˜æ‰£å‡æ˜¯å¦æ­£ç¡®
        boolean stockConsistent = inventoryService
            .checkStockReduction(order.getProductId(), order.getQuantity());
            
        // æ£€æŸ¥æ”¯ä»˜æ˜¯å¦æ­£ç¡®
        boolean paymentConsistent = paymentService
            .checkPaymentAmount(order.getPaymentId(), order.getAmount());
            
        if (!stockConsistent || !paymentConsistent) {
            // å‘é€å‘Šè­¦
            alertService.sendInconsistencyAlert(orderId);
        }
    }
}
```

**ğŸ“‹ å®šæ—¶æ‰¹é‡æ ¡éªŒ**
```java
@Scheduled(fixedRate = 300000) // æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
public void batchConsistencyCheck() {
    // è·å–æœ€è¿‘15åˆ†é’Ÿçš„è®¢å•
    List<Order> recentOrders = orderService.getRecentOrders(15);
    
    for (Order order : recentOrders) {
        CompletableFuture.runAsync(() -> {
            checkOrderConsistency(order.getId());
        });
    }
}
```

### 6.2 ç›‘æ§å‘Šè­¦è®¾ç½®


**ğŸš¨ å…³é”®æŒ‡æ ‡ç›‘æ§**

| ç›‘æ§é¡¹ | **é˜ˆå€¼** | **å‘Šè­¦çº§åˆ«** | **å¤„ç†æ–¹å¼** |
|--------|---------|-------------|-------------|
| æ•°æ®ä¸ä¸€è‡´ç‡ | `>0.1%` | `è­¦å‘Š` | `è‡ªåŠ¨é‡è¯•` |
| äº‹åŠ¡è¶…æ—¶ç‡ | `>5%` | `ä¸¥é‡` | `äººå·¥ä»‹å…¥` |
| è¡¥å¿å¤±è´¥ç‡ | `>1%` | `ç´§æ€¥` | `ç«‹å³å¤„ç†` |
| æ¶ˆæ¯ç§¯å‹é‡ | `>1000` | `è­¦å‘Š` | `æ‰©å®¹å¤„ç†` |

```java
// ç›‘æ§æŒ‡æ ‡æ”¶é›†
@Component
public class ConsistencyMetrics {
    
    private final MeterRegistry meterRegistry;
    private final Counter inconsistencyCounter;
    private final Timer transactionTimer;
    
    public ConsistencyMetrics(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.inconsistencyCounter = Counter.builder("consistency.errors")
            .description("æ•°æ®ä¸ä¸€è‡´é”™è¯¯è®¡æ•°")
            .register(meterRegistry);
        this.transactionTimer = Timer.builder("transaction.duration")
            .description("åˆ†å¸ƒå¼äº‹åŠ¡æ‰§è¡Œæ—¶é—´")
            .register(meterRegistry);
    }
    
    public void recordInconsistency(String type) {
        inconsistencyCounter.increment(Tags.of("type", type));
    }
    
    public void recordTransactionTime(long duration) {
        transactionTimer.record(duration, TimeUnit.MILLISECONDS);
    }
}
```

### 6.3 è‡ªåŠ¨ä¿®å¤æœºåˆ¶


**ğŸ”§ åˆ†å±‚ä¿®å¤ç­–ç•¥**
```
Level 1ï¼šè‡ªåŠ¨é‡è¯•
â€¢ ç½‘ç»œè¶…æ—¶ã€ä¸´æ—¶æ€§é”™è¯¯
â€¢ æŒ‡æ•°é€€é¿é‡è¯•ç­–ç•¥
â€¢ æœ€å¤§é‡è¯•3æ¬¡

Level 2ï¼šè¡¥å¿ä¿®å¤  
â€¢ ä¸šåŠ¡é€»è¾‘é”™è¯¯ã€éƒ¨åˆ†å¤±è´¥
â€¢ æ‰§è¡Œé¢„å®šä¹‰çš„è¡¥å¿æ“ä½œ
â€¢ è®°å½•ä¿®å¤æ—¥å¿—

Level 3ï¼šäººå·¥ä»‹å…¥
â€¢ å¤æ‚çš„æ•°æ®ä¸ä¸€è‡´
â€¢ è‡ªåŠ¨ä¿®å¤å¤±è´¥çš„æƒ…å†µ
â€¢ ç”Ÿæˆå·¥å•ï¼Œäººå·¥å¤„ç†
```

```java
@Service
public class AutoRepairService {
    
    @RetryableTopic(attempts = "3", backoff = @Backoff(delay = 1000, multiplier = 2))
    public void repairInconsistency(InconsistencyEvent event) {
        try {
            switch (event.getType()) {
                case STOCK_MISMATCH:
                    repairStockMismatch(event);
                    break;
                case PAYMENT_MISMATCH:
                    repairPaymentMismatch(event);
                    break;
                default:
                    createManualTicket(event);
            }
        } catch (Exception e) {
            // è‡ªåŠ¨ä¿®å¤å¤±è´¥ï¼Œè½¬äººå·¥å¤„ç†
            createManualTicket(event);
        }
    }
}
```

---

## 7. ğŸš‘ æ•…éšœæ¢å¤é¢„æ¡ˆ


### 7.1 æœåŠ¡é™çº§ç­–ç•¥


**ğŸ”¸ é™çº§åœºæ™¯ä¸ç­–ç•¥**

```java
@Component
public class OrderFallbackService {
    
    // å½“åº“å­˜æœåŠ¡ä¸å¯ç”¨æ—¶çš„é™çº§ç­–ç•¥
    @HystrixCommand(fallbackMethod = "reduceStockFallback")
    public boolean reduceStock(String productId, int quantity) {
        return inventoryService.reduceStock(productId, quantity);
    }
    
    public boolean reduceStockFallback(String productId, int quantity) {
        // é™çº§ç­–ç•¥ï¼š
        // 1. è®°å½•åˆ°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç¨åå¤„ç†
        stockReductionQueue.send(new StockReductionMessage(productId, quantity));
        
        // 2. è¿”å›trueï¼Œå…è®¸ä¸‹å•ï¼Œä½†æ ‡è®°ä¸ºå¾…ç¡®è®¤
        return true;
    }
}
```

> **ğŸ’­ é™çº§ç­–ç•¥çš„æ€è€ƒ**
> å°±åƒåŒ»é™¢æŒ‚å·ç³»ç»Ÿæ•…éšœæ—¶ï¼Œå¯ä»¥å…ˆè®©ç—…äººç™»è®°æ’é˜Ÿï¼Œç³»ç»Ÿæ¢å¤åå†ç»Ÿä¸€å¤„ç†ã€‚ä¿è¯ä¸šåŠ¡continuityæ¯”æ•°æ®å®æ—¶ä¸€è‡´æ€§æ›´é‡è¦ã€‚

### 7.2 æ•°æ®æ¢å¤æœºåˆ¶


**ğŸ“‹ æ¢å¤ç­–ç•¥åˆ†ç±»**

```
å®æ—¶æ¢å¤ï¼š
â€¢ åŸºäºæ¶ˆæ¯é˜Ÿåˆ—çš„é‡æ”¾æœºåˆ¶
â€¢ é€‚ç”¨äºçŸ­æ—¶é—´æ•…éšœ

æ‰¹é‡æ¢å¤ï¼š
â€¢ åŸºäºæ•°æ®å¿«ç…§çš„å¯¹æ¯”ä¿®å¤
â€¢ é€‚ç”¨äºé•¿æ—¶é—´æ•…éšœæˆ–æ•°æ®å¤§é¢ç§¯ä¸ä¸€è‡´

å¢é‡æ¢å¤ï¼š
â€¢ åŸºäºå˜æ›´æ—¥å¿—çš„å·®å¼‚åŒæ­¥
â€¢ é€‚ç”¨äºéƒ¨åˆ†æ•°æ®ä¸ä¸€è‡´
```

```java
@Service
public class DataRecoveryService {
    
    // æ¶ˆæ¯é‡æ”¾æ¢å¤
    public void replayMessages(Date fromTime, Date toTime) {
        List<MessageRecord> messages = messageStore.getMessages(fromTime, toTime);
        
        for (MessageRecord message : messages) {
            try {
                // é‡æ–°å¤„ç†æ¶ˆæ¯
                messageProcessor.process(message.getContent());
                
                // æ ‡è®°ä¸ºå·²é‡æ”¾
                messageStore.markAsReplayed(message.getId());
                
            } catch (Exception e) {
                log.error("æ¶ˆæ¯é‡æ”¾å¤±è´¥: {}", message.getId(), e);
                // è®°å½•å¤±è´¥çš„æ¶ˆæ¯ï¼Œäººå·¥å¤„ç†
                failedMessageStore.save(message);
            }
        }
    }
    
    // æ•°æ®å¿«ç…§å¯¹æ¯”ä¿®å¤
    public void repairBySnapshot(String snapshotId) {
        DataSnapshot snapshot = snapshotService.getSnapshot(snapshotId);
        DataSnapshot currentData = snapshotService.createCurrentSnapshot();
        
        List<DataDifference> differences = compareSnapshots(snapshot, currentData);
        
        for (DataDifference diff : differences) {
            applyDataFix(diff);
        }
    }
}
```

### 7.3 åº”æ€¥å¤„ç†æµç¨‹


**ğŸš¨ æ•…éšœå“åº”SOP**

```
æ•…éšœå‘ç° (0-5åˆ†é’Ÿ)ï¼š
1. ç›‘æ§å‘Šè­¦è§¦å‘
2. å€¼ç­äººå‘˜æ”¶åˆ°é€šçŸ¥
3. åˆæ­¥åˆ¤æ–­æ•…éšœå½±å“èŒƒå›´

æ•…éšœå¤„ç† (5-30åˆ†é’Ÿ)ï¼š
1. å¯åŠ¨åº”æ€¥å“åº”å›¢é˜Ÿ
2. æ‰§è¡Œé¢„å®šä¹‰çš„ä¿®å¤è„šæœ¬
3. å¿…è¦æ—¶å¯ç”¨é™çº§ç­–ç•¥

æ•…éšœæ¢å¤ (30åˆ†é’Ÿå)ï¼š
1. æœåŠ¡æ¢å¤æ­£å¸¸
2. æ•°æ®ä¸€è‡´æ€§æ ¡éªŒ
3. æ‰§è¡Œæ•°æ®ä¿®å¤ç¨‹åº
```

**ğŸ”§ åº”æ€¥å·¥å…·ç®±**
```java
// åº”æ€¥ä¿®å¤å·¥å…·ç±»
@RestController
@RequestMapping("/emergency")
public class EmergencyController {
    
    // ç´§æ€¥åœæ­¢æŸä¸ªæœåŠ¡çš„äº‹åŠ¡å¤„ç†
    @PostMapping("/stop-transaction/{serviceId}")
    public ResponseEntity stopTransactionProcessing(@PathVariable String serviceId) {
        emergencyService.stopTransactionProcessing(serviceId);
        return ResponseEntity.ok("äº‹åŠ¡å¤„ç†å·²åœæ­¢");
    }
    
    // æ‰‹åŠ¨è§¦å‘æ•°æ®ä¿®å¤
    @PostMapping("/repair-data/{orderId}")
    public ResponseEntity repairOrderData(@PathVariable String orderId) {
        repairService.repairOrderData(orderId);
        return ResponseEntity.ok("æ•°æ®ä¿®å¤å·²è§¦å‘");
    }
    
    // æŸ¥çœ‹ç³»ç»Ÿå¥åº·çŠ¶æ€
    @GetMapping("/health-check")
    public ResponseEntity healthCheck() {
        HealthStatus status = healthService.checkSystemHealth();
        return ResponseEntity.ok(status);
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ•°æ®ä¸€è‡´æ€§åˆ†ç±»ï¼šå¼ºä¸€è‡´ã€æœ€ç»ˆä¸€è‡´ã€å¼±ä¸€è‡´çš„é€‚ç”¨åœºæ™¯
ğŸ”¸ åˆ†å¸ƒå¼äº‹åŠ¡ï¼š2PCã€TCCã€Sagaæ¨¡å¼çš„ä½¿ç”¨é€‰æ‹©  
ğŸ”¸ è¡¥å¿æœºåˆ¶ï¼šæ­£å‘æ“ä½œå¿…é¡»æœ‰å¯¹åº”çš„è¡¥å¿æ“ä½œ
ğŸ”¸ ç›‘æ§å‘Šè­¦ï¼šå®æ—¶ç›‘æ§å…³é”®æŒ‡æ ‡ï¼ŒåŠæ—¶å‘ç°é—®é¢˜
ğŸ”¸ æ•…éšœæ¢å¤ï¼šåˆ†å±‚æ¢å¤ç­–ç•¥ï¼Œä¿è¯ä¸šåŠ¡è¿ç»­æ€§
```

### 8.2 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ æŠ€æœ¯é€‰æ‹©å†³ç­–æ ‘**
```
æ•°æ®ä¸€è‡´æ€§è¦æ±‚é«˜ï¼Ÿ
â”œâ”€ æ˜¯ â†’ ä½¿ç”¨TCCæˆ–2PC
â””â”€ å¦ â†’ ä½¿ç”¨æœ€ç»ˆä¸€è‡´æ€§

ä¸šåŠ¡å¤æ‚åº¦é«˜ï¼Ÿ  
â”œâ”€ æ˜¯ â†’ ä½¿ç”¨Sagaæ¨¡å¼
â””â”€ å¦ â†’ ä½¿ç”¨ç®€å•çš„æ¶ˆæ¯é˜Ÿåˆ—

å›¢é˜ŸæŠ€æœ¯èƒ½åŠ›ï¼Ÿ
â”œâ”€ å¼º â†’ å¯ä»¥è€ƒè™‘è‡ªç ”æ–¹æ¡ˆ
â””â”€ å¼± â†’ ä½¿ç”¨æˆç†Ÿçš„å¼€æºæ–¹æ¡ˆ(Seata)
```

**ğŸ’¡ æœ€ä½³å®è·µå»ºè®®**
- **è®¾è®¡é˜¶æ®µ**ï¼šæ˜ç¡®æ¯ä¸ªä¸šåŠ¡æ“ä½œçš„ä¸€è‡´æ€§è¦æ±‚
- **å¼€å‘é˜¶æ®µ**ï¼šä¸ºæ¯ä¸ªæ“ä½œè®¾è®¡å¯¹åº”çš„è¡¥å¿æœºåˆ¶  
- **æµ‹è¯•é˜¶æ®µ**ï¼šæ¨¡æ‹Ÿå„ç§æ•…éšœåœºæ™¯è¿›è¡Œæµ‹è¯•
- **è¿ç»´é˜¶æ®µ**ï¼šå»ºç«‹å®Œå–„çš„ç›‘æ§å’Œåº”æ€¥å“åº”æœºåˆ¶

### 8.3 é¿å‘æŒ‡å—


> **âš ï¸ å¸¸è§é”™è¯¯**
> - æ‰€æœ‰æ“ä½œéƒ½è¿½æ±‚å¼ºä¸€è‡´æ€§ï¼ˆæ€§èƒ½å·®ï¼‰
> - è¡¥å¿æ“ä½œä¸å¹‚ç­‰ï¼ˆé‡å¤æ‰§è¡Œå‡ºé”™ï¼‰
> - ç¼ºä¹ç›‘æ§æœºåˆ¶ï¼ˆé—®é¢˜å‘ç°å¤ªæ™šï¼‰
> - æ²¡æœ‰åº”æ€¥é¢„æ¡ˆï¼ˆæ•…éšœæ—¶æ‰‹å¿™è„šä¹±ï¼‰

**âœ… æ¨èåšæ³•**
- æ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰æ‹©åˆé€‚çš„ä¸€è‡´æ€§çº§åˆ«
- è¡¥å¿æ“ä½œè®¾è®¡è¦è€ƒè™‘å¹‚ç­‰æ€§å’Œå¯é‡è¯•æ€§
- å»ºç«‹å®Œå–„çš„ç›‘æ§æŒ‡æ ‡å’Œå‘Šè­¦æœºåˆ¶
- åˆ¶å®šè¯¦ç»†çš„æ•…éšœåº”æ€¥å¤„ç†æµç¨‹

### 8.4 æ ¸å¿ƒè®°å¿†è¦ç‚¹


**ğŸ§  ä¸€å¥è¯æ€»ç»“**
> åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„æ•°æ®ä¸€è‡´æ€§å°±åƒåè°ƒä¸€ä¸ªå¤§å‹å›¢é˜Ÿå·¥ä½œï¼Œéœ€è¦æœ‰æ˜ç¡®çš„åè°ƒæœºåˆ¶ã€å®¹é”™ç­–ç•¥å’Œåº”æ€¥é¢„æ¡ˆã€‚

**ğŸ”‘ å…³é”®è¯è®°å¿†**
- **CAPå®šç†**ï¼šä¸€è‡´æ€§ã€å¯ç”¨æ€§ã€åˆ†åŒºå®¹é”™æ€§ä¸‰é€‰äºŒ
- **æœ€ç»ˆä¸€è‡´**ï¼šä¸è¦æ±‚å®æ—¶ï¼Œä½†æœ€ç»ˆä¼šä¸€è‡´
- **è¡¥å¿æœºåˆ¶**ï¼šæ­£å‘æ“ä½œå¤±è´¥æ—¶çš„é€†å‘æ¢å¤
- **ç›‘æ§å‘Šè­¦**ï¼šåŠæ—¶å‘ç°å’Œå¤„ç†ä¸ä¸€è‡´é—®é¢˜

**ğŸ“Œ å®æˆ˜å¿ƒå¾—**
åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œ**90%çš„åœºæ™¯ä½¿ç”¨æœ€ç»ˆä¸€è‡´æ€§å°±å¤Ÿäº†**ï¼Œåªæœ‰æ¶‰åŠé‡‘é’±ã€åº“å­˜ç­‰å…³é”®ä¸šåŠ¡æ‰éœ€è¦å¼ºä¸€è‡´æ€§ã€‚é€‰æ‹©æŠ€æœ¯æ–¹æ¡ˆæ—¶ï¼Œ**ç®€å•å¯é æ¯”å¤æ‚å®Œç¾æ›´é‡è¦**ã€‚