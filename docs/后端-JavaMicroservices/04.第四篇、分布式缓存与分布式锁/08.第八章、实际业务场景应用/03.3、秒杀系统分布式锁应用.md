---
title: 3ã€ç§’æ€ç³»ç»Ÿåˆ†å¸ƒå¼é”åº”ç”¨
---
## ğŸ“š ç›®å½•

1. [ç§’æ€ç³»ç»Ÿæ ¸å¿ƒæŒ‘æˆ˜](#1-ç§’æ€ç³»ç»Ÿæ ¸å¿ƒæŒ‘æˆ˜)
2. [åˆ†å¸ƒå¼é”åœ¨ç§’æ€ä¸­çš„ä½œç”¨](#2-åˆ†å¸ƒå¼é”åœ¨ç§’æ€ä¸­çš„ä½œç”¨)
3. [åº“å­˜æ‰£å‡æ§åˆ¶æœºåˆ¶](#3-åº“å­˜æ‰£å‡æ§åˆ¶æœºåˆ¶)
4. [é˜²æ­¢è¶…å–çš„æŠ€æœ¯æ–¹æ¡ˆ](#4-é˜²æ­¢è¶…å–çš„æŠ€æœ¯æ–¹æ¡ˆ)
5. [å¹‚ç­‰æ€§ä¿è¯è®¾è®¡](#5-å¹‚ç­‰æ€§ä¿è¯è®¾è®¡)
6. [é”ç²’åº¦ä¼˜åŒ–ç­–ç•¥](#6-é”ç²’åº¦ä¼˜åŒ–ç­–ç•¥)
7. [æ€§èƒ½ä¼˜åŒ–ä¸é™çº§æ–¹æ¡ˆ](#7-æ€§èƒ½ä¼˜åŒ–ä¸é™çº§æ–¹æ¡ˆ)
8. [ç›‘æ§ä¸è¿ç»´å®è·µ](#8-ç›‘æ§ä¸è¿ç»´å®è·µ)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ ç§’æ€ç³»ç»Ÿæ ¸å¿ƒæŒ‘æˆ˜


### 1.1 ä»€ä¹ˆæ˜¯ç§’æ€ç³»ç»Ÿ

**ç”Ÿæ´»åŒ–ç†è§£**ï¼šå°±åƒæŠ¢æ¼”å”±ä¼šé—¨ç¥¨ä¸€æ ·ï¼Œåœ¨å¾ˆçŸ­æ—¶é—´å†…æœ‰å¤§é‡ç”¨æˆ·åŒæ—¶æŠ¢è´­å°‘é‡å•†å“

```
ç°å®åœºæ™¯ç±»æ¯”ï¼š
å•†åœºé™é‡å•†å“å‘å”®
â€¢ 100ä»¶å•†å“ï¼Œ10000äººæŠ¢è´­
â€¢ å¼€æŠ¢ç¬é—´äººæµæ¶Œå…¥
â€¢ å¿…é¡»ä¿è¯ä¸èƒ½å¤šå–ï¼Œä¹Ÿä¸èƒ½å°‘å–

æŠ€æœ¯æŒ‘æˆ˜å¯¹åº”ï¼š
â€¢ é«˜å¹¶å‘ï¼šç¬é—´å¤§é‡è¯·æ±‚
â€¢ æ•°æ®ä¸€è‡´æ€§ï¼šåº“å­˜å‡†ç¡®æ‰£å‡
â€¢ ç³»ç»Ÿç¨³å®šæ€§ï¼šä¸èƒ½å› æŠ¢è´­è€Œå´©æºƒ
```

### 1.2 ç§’æ€ç³»ç»Ÿé¢ä¸´çš„æ ¸å¿ƒé—®é¢˜


**ğŸ”¸ è¶…å–é—®é¢˜**
```
é—®é¢˜æè¿°ï¼š
åº“å­˜åªæœ‰10ä»¶ï¼Œä½†å–å‡ºäº†15ä»¶

å‘ç”ŸåŸå› ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·AæŸ¥åº“å­˜ï¼š10  â”‚    â”‚  ç”¨æˆ·BæŸ¥åº“å­˜ï¼š10  â”‚
â”‚  å‡†å¤‡è´­ä¹°1ä»¶     â”‚    â”‚  å‡†å¤‡è´­ä¹°1ä»¶     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“                      â†“
    åŒæ—¶æ‰£å‡åº“å­˜ï¼Œéƒ½æˆåŠŸäº†ï¼
         â†“
    å®é™…åº“å­˜å˜æˆ8ï¼Œä½†åº”è¯¥æ˜¯9
```

**ğŸ”¸ å¹¶å‘ç«äº‰é—®é¢˜**
```
é«˜å¹¶å‘åœºæ™¯ï¼š
æ—¶é—´ç‚¹    ç”¨æˆ·è¯·æ±‚é‡    ç³»ç»Ÿå‹åŠ›
12:00:00  100/ç§’      æ­£å¸¸
12:00:01  50000/ç§’    ç¬é—´å³°å€¼
12:00:02  1000/ç§’     é€æ¸æ¢å¤

æŠ€æœ¯éš¾ç‚¹ï¼š
â€¢ æ•°æ®åº“è¿æ¥æ± ç¬é—´è€—å°½
â€¢ CPU/å†…å­˜èµ„æºäº‰æŠ¢æ¿€çƒˆ  
â€¢ ç½‘ç»œå¸¦å®½å¯èƒ½æˆä¸ºç“¶é¢ˆ
```

### 1.3 ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”


**å•æœºåœºæ™¯ vs åˆ†å¸ƒå¼åœºæ™¯**

```
å•æœºç¯å¢ƒï¼ˆä¼ ç»Ÿæ–¹å¼ï¼‰ï¼š
    åº”ç”¨æœåŠ¡å™¨
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ synchronizedâ”‚ â† Javaå†…ç½®é”å°±å¤Ÿç”¨
    â”‚    æ–¹æ³•     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    æ•°æ®åº“æ“ä½œ

åˆ†å¸ƒå¼ç¯å¢ƒï¼ˆå¾®æœåŠ¡ï¼‰ï¼š
æœåŠ¡å™¨A          æœåŠ¡å™¨B          æœåŠ¡å™¨C
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚synchronizedâ”‚  â”‚synchronizedâ”‚  â”‚synchronizedâ”‚ â† å„è‡ªçš„é”äº’ä¸ç›¸å…³
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“               â†“               â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚        å…±äº«æ•°æ®åº“            â”‚ â† ä»ç„¶ä¼šå‘ç”Ÿå¹¶å‘é—®é¢˜
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. âš™ï¸ åˆ†å¸ƒå¼é”åœ¨ç§’æ€ä¸­çš„ä½œç”¨


### 2.1 åˆ†å¸ƒå¼é”çš„åŸºæœ¬ç†å¿µ


**ğŸ”¸ æ ¸å¿ƒæ€æƒ³**
> åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼Œé€šè¿‡å¤–éƒ¨å­˜å‚¨ï¼ˆå¦‚Redisï¼‰æ¥åè°ƒå¤šä¸ªæœåŠ¡å®ä¾‹ï¼Œç¡®ä¿åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªæœåŠ¡èƒ½æ‰§è¡Œå…³é”®æ“ä½œ

**ç”Ÿæ´»åŒ–ç±»æ¯”**ï¼š
```
æƒ³è±¡ä¸€ä¸ªå…¬å…±å•æ‰€çš„é—¨é”ï¼š
â€¢ é—¨é”ï¼šåˆ†å¸ƒå¼é”
â€¢ å•æ‰€ï¼šå…±äº«èµ„æºï¼ˆåº“å­˜ï¼‰
â€¢ ä½¿ç”¨è€…ï¼šä¸åŒçš„æœåŠ¡å®ä¾‹

è§„åˆ™ï¼š
1. è¿›å…¥å‰å¿…é¡»å…ˆé”é—¨
2. ä½¿ç”¨å®Œæ¯•å¿…é¡»å¼€é”
3. å…¶ä»–äººåªèƒ½ç­‰å¾…é”é‡Šæ”¾
```

### 2.2 åœ¨ç§’æ€ä¸­çš„å…·ä½“ä½œç”¨


**ğŸ”¸ ä¿è¯åŸå­æ€§æ“ä½œ**
```
ç§’æ€æ‰£åº“å­˜çš„å®Œæ•´æµç¨‹ï¼š
1. è·å–åˆ†å¸ƒå¼é”
   â†“
2. æŸ¥è¯¢å½“å‰åº“å­˜
   â†“  
3. åˆ¤æ–­åº“å­˜æ˜¯å¦è¶³å¤Ÿ
   â†“
4. æ‰£å‡åº“å­˜æ•°é‡
   â†“
5. é‡Šæ”¾åˆ†å¸ƒå¼é”

å…³é”®ç‚¹ï¼šæ­¥éª¤1-5å¿…é¡»æ˜¯åŸå­æ“ä½œï¼Œä¸èƒ½è¢«å…¶ä»–è¯·æ±‚æ‰“æ–­
```

### 2.3 é”çš„å®ç°é€‰æ‹©


| å®ç°æ–¹å¼ | **ä¼˜åŠ¿** | **åŠ£åŠ¿** | **é€‚ç”¨åœºæ™¯** |
|---------|---------|---------|-------------|
| **Redisåˆ†å¸ƒå¼é”** | `æ€§èƒ½é«˜ï¼Œå®ç°ç®€å•` | `å¯èƒ½ä¸¢å¤±é”` | `é«˜æ€§èƒ½è¦æ±‚` |
| **Zookeeperé”** | `å¼ºä¸€è‡´æ€§ä¿è¯` | `æ€§èƒ½ç›¸å¯¹è¾ƒä½` | `ä¸€è‡´æ€§è¦æ±‚é«˜` |
| **æ•°æ®åº“é”** | `ç®€å•å¯é ` | `æ€§èƒ½ç“¶é¢ˆæ˜æ˜¾` | `ç®€å•åœºæ™¯` |

---

## 3. ğŸ”’ åº“å­˜æ‰£å‡æ§åˆ¶æœºåˆ¶


### 3.1 ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜


**æ— é”æ–¹å¼çš„æ¼æ´**ï¼š
```java
// âŒ é”™è¯¯ç¤ºä¾‹ï¼šå­˜åœ¨å¹¶å‘é—®é¢˜
public boolean buyProduct(Long productId, Integer quantity) {
    // æŸ¥è¯¢åº“å­˜
    Integer stock = stockMapper.getStock(productId);
    
    // åˆ¤æ–­åº“å­˜
    if (stock >= quantity) {
        // æ‰£å‡åº“å­˜ - è¿™é‡Œæœ‰å¹¶å‘é—®é¢˜ï¼
        stockMapper.updateStock(productId, stock - quantity);
        return true;
    }
    return false;
}
```

**é—®é¢˜åˆ†æ**ï¼š
```
æ—¶é—´è½´åˆ†æå¹¶å‘é—®é¢˜ï¼š
T1: ç”¨æˆ·AæŸ¥è¯¢åº“å­˜ = 10
T2: ç”¨æˆ·BæŸ¥è¯¢åº“å­˜ = 10  â† ä¸¤äººçœ‹åˆ°ç›¸åŒåº“å­˜
T3: ç”¨æˆ·Aæ‰£å‡ï¼š10-1=9
T4: ç”¨æˆ·Bæ‰£å‡ï¼š10-1=9   â† åº“å­˜é”™è¯¯ï¼åº”è¯¥æ˜¯8
```

### 3.2 åŸºäºRedisçš„åˆ†å¸ƒå¼é”æ–¹æ¡ˆ


**ğŸ”¸ Redisé”çš„æ ¸å¿ƒå‘½ä»¤**
```java
// åŠ é”ï¼šSET key value NX PX milliseconds
// NXï¼šåªæœ‰keyä¸å­˜åœ¨æ—¶æ‰è®¾ç½®
// PXï¼šè®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆé˜²æ­¢æ­»é”ï¼‰
SET stock:product:123 uuid12345 NX PX 30000
```

**å®Œæ•´çš„åº“å­˜æ‰£å‡å®ç°**ï¼š
```java
@Service
public class SecKillService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    public boolean secKillProduct(Long productId, Integer quantity) {
        String lockKey = "stock:lock:" + productId;
        String lockValue = UUID.randomUUID().toString();
        
        try {
            // 1. å°è¯•è·å–é”ï¼ˆ30ç§’è¶…æ—¶ï¼‰
            Boolean locked = redisTemplate.opsForValue()
                .setIfAbsent(lockKey, lockValue, 30, TimeUnit.SECONDS);
            
            if (!locked) {
                return false; // è·å–é”å¤±è´¥
            }
            
            // 2. æ‰§è¡Œä¸šåŠ¡é€»è¾‘
            return doSecKill(productId, quantity);
            
        } finally {
            // 3. é‡Šæ”¾é”ï¼ˆé‡è¦ï¼šåªé‡Šæ”¾è‡ªå·±åŠ çš„é”ï¼‰
            releaseLock(lockKey, lockValue);
        }
    }
    
    private boolean doSecKill(Long productId, Integer quantity) {
        // æŸ¥è¯¢åº“å­˜
        Integer stock = stockMapper.getStock(productId);
        
        if (stock >= quantity) {
            // æ‰£å‡åº“å­˜
            stockMapper.updateStock(productId, stock - quantity);
            // åˆ›å»ºè®¢å•ç­‰å…¶ä»–æ“ä½œ...
            return true;
        }
        return false;
    }
}
```

### 3.3 é”é‡Šæ”¾çš„å®‰å…¨æ€§


**ğŸ”¸ ä¸ºä»€ä¹ˆè¦éªŒè¯é”çš„æ‹¥æœ‰è€…**
```java
// âŒ é”™è¯¯çš„é‡Šæ”¾æ–¹å¼
redisTemplate.delete(lockKey); // å¯èƒ½é‡Šæ”¾äº†åˆ«äººçš„é”

// âœ… æ­£ç¡®çš„é‡Šæ”¾æ–¹å¼
private void releaseLock(String lockKey, String lockValue) {
    String luaScript = 
        "if redis.call('get', KEYS[1]) == ARGV[1] then " +
        "  return redis.call('del', KEYS[1]) " +
        "else " +
        "  return 0 " +
        "end";
    
    redisTemplate.execute(new DefaultRedisScript<>(luaScript, Long.class),
                         Arrays.asList(lockKey), lockValue);
}
```

**å®‰å…¨é‡Šæ”¾çš„å¿…è¦æ€§**ï¼š
```
åœºæ™¯è¯´æ˜ï¼š
T1: æœåŠ¡Aè·å–é”ï¼Œå¼€å§‹å¤„ç†ä¸šåŠ¡
T2: æœåŠ¡Aå› ä¸ºç½‘ç»œå»¶è¿Ÿï¼Œå¤„ç†è¶…æ—¶
T3: Redisé”è‡ªåŠ¨è¿‡æœŸé‡Šæ”¾
T4: æœåŠ¡Bè·å–åˆ°é”ï¼Œå¼€å§‹å¤„ç†
T5: æœåŠ¡Aå¤„ç†å®Œæˆï¼Œå¦‚æœç›´æ¥deleteé”
     â†’ ä¼šé”™è¯¯é‡Šæ”¾æœåŠ¡Bçš„é”ï¼
```

---

## 4. ğŸ›¡ï¸ é˜²æ­¢è¶…å–çš„æŠ€æœ¯æ–¹æ¡ˆ


### 4.1 å¤šå±‚é˜²æŠ¤ç­–ç•¥


**ğŸ”¸ åˆ†å±‚é˜²æŠ¤æ€è·¯**
```
è¯·æ±‚æµé‡æ§åˆ¶å±‚ï¼š
    é™æµ â†’ ç†”æ–­ â†’ é™çº§
         â†“
ä¸šåŠ¡é€»è¾‘ä¿æŠ¤å±‚ï¼š
    åˆ†å¸ƒå¼é” â†’ åº“å­˜æ ¡éªŒ
         â†“  
æ•°æ®å­˜å‚¨ä¿æŠ¤å±‚ï¼š
    æ•°æ®åº“çº¦æŸ â†’ ä¹è§‚é”
```

### 4.2 Redis + æ•°æ®åº“åŒé‡ä¿é™©


**ğŸ”¸ Redisé¢„åº“å­˜æœºåˆ¶**
```java
@Component
public class StockService {
    
    // æ´»åŠ¨å¼€å§‹å‰ï¼Œå°†åº“å­˜é¢„åŠ è½½åˆ°Redis
    public void preloadStock(Long productId, Integer totalStock) {
        String stockKey = "stock:count:" + productId;
        redisTemplate.opsForValue().set(stockKey, totalStock);
    }
    
    // å¿«é€Ÿåº“å­˜æ ¡éªŒ
    public boolean checkStockInRedis(Long productId, Integer quantity) {
        String stockKey = "stock:count:" + productId;
        
        // ä½¿ç”¨Luaè„šæœ¬ä¿è¯åŸå­æ€§
        String luaScript = 
            "local stock = redis.call('get', KEYS[1]) " +
            "if tonumber(stock) >= tonumber(ARGV[1]) then " +
            "  redis.call('decrby', KEYS[1], ARGV[1]) " +
            "  return 1 " +
            "else " +
            "  return 0 " +
            "end";
        
        Long result = redisTemplate.execute(
            new DefaultRedisScript<>(luaScript, Long.class),
            Arrays.asList(stockKey), 
            quantity.toString()
        );
        
        return result != null && result == 1;
    }
}
```

### 4.3 æ•°æ®åº“å±‚é¢çš„æœ€ç»ˆä¿éšœ


**ğŸ”¸ æ•°æ®åº“çº¦æŸé˜²æŠ¤**
```sql
-- åœ¨æ•°æ®åº“å±‚é¢ä¹Ÿè¦åŠ çº¦æŸ
ALTER TABLE t_product_stock 
ADD CONSTRAINT check_stock_positive 
CHECK (stock_count >= 0);

-- åº“å­˜æ‰£å‡æ—¶çš„å®‰å…¨SQL
UPDATE t_product_stock 
SET stock_count = stock_count - #{quantity}
WHERE product_id = #{productId} 
  AND stock_count >= #{quantity};  -- å…³é”®æ¡ä»¶
```

**åŒé‡éªŒè¯æµç¨‹**ï¼š
```
Rediså±‚éªŒè¯ â†’ æ•°æ®åº“å±‚éªŒè¯ â†’ æœ€ç»ˆç¡®è®¤

ç”¨æˆ·è¯·æ±‚
    â†“
Rediså¿«é€Ÿæ ¡éªŒåº“å­˜ â”€â”€â”€â”
    â†“               â”‚ ä»»ä¸€å±‚éªŒè¯å¤±è´¥
è·å–åˆ†å¸ƒå¼é”        â”‚ éƒ½ä¼šæ‹’ç»è¯·æ±‚
    â†“               â”‚
æ•°æ®åº“æœ€ç»ˆæ‰£å‡ â”€â”€â”€â”€â”€â”˜
    â†“
è¿”å›ç»“æœ
```

---

## 5. ğŸ”„ å¹‚ç­‰æ€§ä¿è¯è®¾è®¡


### 5.1 ä»€ä¹ˆæ˜¯å¹‚ç­‰æ€§


**ğŸ”¸ é€šä¿—ç†è§£**
> åŒæ ·çš„æ“ä½œæ‰§è¡Œå¤šæ¬¡ï¼Œç»“æœåº”è¯¥æ˜¯ä¸€æ ·çš„ã€‚å°±åƒç”µè§†é¥æ§å™¨çš„å¼€å…³æŒ‰é’®ï¼ŒæŒ‰1æ¬¡æ˜¯å¼€ï¼Œè¿ç»­æŒ‰å¤šæ¬¡è¿˜æ˜¯å¼€çš„çŠ¶æ€ã€‚

**ç§’æ€åœºæ™¯ä¸­çš„å¹‚ç­‰æ€§éœ€æ±‚**ï¼š
```
ç”¨æˆ·é‡å¤ç‚¹å‡»è´­ä¹°æŒ‰é’®ï¼š
ç¬¬1æ¬¡ç‚¹å‡» â†’ æˆåŠŸè´­ä¹°1ä»¶
ç¬¬2æ¬¡ç‚¹å‡» â†’ ä¸åº”è¯¥å†è´­ä¹°1ä»¶ï¼ˆé‡å¤è¯·æ±‚ï¼‰
ç¬¬3æ¬¡ç‚¹å‡» â†’ ä»ç„¶ä¸åº”è¯¥è´­ä¹°ï¼ˆä»ç„¶æ˜¯é‡å¤ï¼‰

æœŸæœ›ç»“æœï¼šæ— è®ºç‚¹å‡»å¤šå°‘æ¬¡ï¼Œåªè´­ä¹°1ä»¶
```

### 5.2 åŸºäºè®¢å•å·çš„å¹‚ç­‰æ€§è®¾è®¡


**ğŸ”¸ å®ç°æ€è·¯**
```java
@Service
public class IdempotentSecKillService {
    
    public SecKillResult secKill(Long userId, Long productId, String requestId) {
        // 1. æ„é€ å¹‚ç­‰æ€§é”®
        String idempotentKey = "seckill:idempotent:" + userId + ":" + productId + ":" + requestId;
        
        // 2. æ£€æŸ¥æ˜¯å¦å·²ç»å¤„ç†è¿‡
        String existResult = redisTemplate.opsForValue().get(idempotentKey);
        if (existResult != null) {
            return JSON.parseObject(existResult, SecKillResult.class);
        }
        
        // 3. æ‰§è¡Œç§’æ€é€»è¾‘
        SecKillResult result = doSecKillWithLock(userId, productId);
        
        // 4. ä¿å­˜ç»“æœï¼ˆè®¾ç½®è¿‡æœŸæ—¶é—´ï¼‰
        redisTemplate.opsForValue().set(idempotentKey, 
                                       JSON.toJSONString(result), 
                                       1, TimeUnit.HOURS);
        
        return result;
    }
}
```

### 5.3 ç”¨æˆ·çº§åˆ«çš„é‡å¤è´­ä¹°æ§åˆ¶


**ğŸ”¸ é˜²æ­¢åŒä¸€ç”¨æˆ·é‡å¤ç§’æ€**
```java
public boolean checkUserPurchaseLimit(Long userId, Long productId) {
    String userLimitKey = "seckill:user:limit:" + userId + ":" + productId;
    
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç»è´­ä¹°è¿‡
    Boolean alreadyPurchased = redisTemplate.hasKey(userLimitKey);
    if (alreadyPurchased) {
        throw new BusinessException("æ‚¨å·²ç»è´­ä¹°è¿‡è¯¥å•†å“äº†");
    }
    
    // æ ‡è®°ç”¨æˆ·å·²è´­ä¹°ï¼ˆæ´»åŠ¨ç»“æŸåè¿‡æœŸï¼‰
    redisTemplate.opsForValue().set(userLimitKey, "purchased", 
                                   24, TimeUnit.HOURS);
    return true;
}
```

---

## 6. âš–ï¸ é”ç²’åº¦ä¼˜åŒ–ç­–ç•¥


### 6.1 é”ç²’åº¦çš„æ¦‚å¿µ


**ğŸ”¸ ç”Ÿæ´»åŒ–ç†è§£**
```
ç²—ç²’åº¦é”ï¼šæ•´ä¸ªå•†åœºåªæœ‰ä¸€æŠŠé’¥åŒ™
â€¢ å®‰å…¨æ€§é«˜ï¼šåŒæ—¶åªèƒ½æœ‰1ä¸ªäººè´­ç‰©
â€¢ æ•ˆç‡ä½ï¼šå…¶ä»–äººéƒ½è¦æ’é˜Ÿç­‰å¾…

ç»†ç²’åº¦é”ï¼šæ¯ä¸ªå•†å“æŸœå°éƒ½æœ‰ç‹¬ç«‹çš„é”
â€¢ æ•ˆç‡é«˜ï¼šä¸åŒå•†å“å¯ä»¥åŒæ—¶è´­ä¹°
â€¢ å¤æ‚æ€§ï¼šéœ€è¦ç®¡ç†æ›´å¤šçš„é”
```

### 6.2 å•†å“çº§åˆ«çš„é”è®¾è®¡


**ğŸ”¸ æŒ‰å•†å“IDåˆ†é”**
```java
public class OptimizedSecKillService {
    
    // âœ… ç»†ç²’åº¦é”ï¼šæ¯ä¸ªå•†å“ä¸€æŠŠé”
    public boolean secKillByProduct(Long productId, Integer quantity) {
        String lockKey = "stock:lock:product:" + productId;
        
        // åªé”å®šå½“å‰å•†å“ï¼Œä¸å½±å“å…¶ä»–å•†å“çš„ç§’æ€
        return executeWithLock(lockKey, () -> {
            return doSecKillBusiness(productId, quantity);
        });
    }
    
    // âŒ ç²—ç²’åº¦é”ï¼šæ‰€æœ‰å•†å“å…±ç”¨ä¸€æŠŠé”
    public boolean secKillGlobal(Long productId, Integer quantity) {
        String lockKey = "stock:lock:global"; // å…¨å±€é”
        
        // ä¼šå¯¼è‡´æ‰€æœ‰å•†å“çš„ç§’æ€éƒ½ä¸²è¡ŒåŒ–
        return executeWithLock(lockKey, () -> {
            return doSecKillBusiness(productId, quantity);
        });
    }
}
```

### 6.3 åˆ†æ®µé”ä¼˜åŒ–


**ğŸ”¸ åº“å­˜åˆ†æ®µç®¡ç†**
```java
// å°†å¤§åº“å­˜åˆ†æˆå¤šä¸ªå°æ®µï¼Œæ¯æ®µç‹¬ç«‹åŠ é”
public class SegmentedStockService {
    
    private static final int SEGMENT_COUNT = 10; // åˆ†10æ®µ
    
    public boolean secKillWithSegment(Long productId, Integer quantity) {
        // éšæœºé€‰æ‹©ä¸€ä¸ªåˆ†æ®µ
        int segmentIndex = ThreadLocalRandom.current().nextInt(SEGMENT_COUNT);
        String segmentLockKey = "stock:lock:" + productId + ":segment:" + segmentIndex;
        
        return executeWithLock(segmentLockKey, () -> {
            return processSegmentStock(productId, segmentIndex, quantity);
        });
    }
    
    private boolean processSegmentStock(Long productId, Integer segmentIndex, Integer quantity) {
        String segmentStockKey = "stock:segment:" + productId + ":" + segmentIndex;
        
        // æ£€æŸ¥åˆ†æ®µåº“å­˜
        Integer segmentStock = (Integer) redisTemplate.opsForValue().get(segmentStockKey);
        if (segmentStock >= quantity) {
            // æ‰£å‡åˆ†æ®µåº“å­˜
            redisTemplate.opsForValue().decrement(segmentStockKey, quantity);
            return true;
        }
        
        return false;
    }
}
```

**åˆ†æ®µé”çš„ä¼˜åŠ¿**ï¼š
```
æ€§èƒ½å¯¹æ¯”åˆ†æï¼š
å•ä¸ªé”çš„æƒ…å†µï¼š
    1000ä¸ªç”¨æˆ· â†’ 1æŠŠé” â†’ å®Œå…¨ä¸²è¡Œ â†’ ä½æ•ˆ

åˆ†æ®µé”çš„æƒ…å†µï¼š
    1000ä¸ªç”¨æˆ· â†’ 10æŠŠé” â†’ 10ä¸ªå¹¶è¡Œé€šé“ â†’ é«˜æ•ˆ

ç†æƒ³æƒ…å†µä¸‹æ€§èƒ½æå‡ï¼š10å€
å®é™…æƒ…å†µä¸‹æ€§èƒ½æå‡ï¼š5-8å€ï¼ˆè€ƒè™‘é”ç«äº‰ï¼‰
```

---

## 7. ğŸš€ æ€§èƒ½ä¼˜åŒ–ä¸é™çº§æ–¹æ¡ˆ


### 7.1 é¢„çƒ­ç­–ç•¥


**ğŸ”¸ ç³»ç»Ÿé¢„çƒ­çš„é‡è¦æ€§**
```
å†·å¯åŠ¨é—®é¢˜ï¼š
JVMåˆšå¯åŠ¨ â†’ ç±»åŠ è½½ã€å†…å­˜åˆ†é…éƒ½å¾ˆæ…¢ â†’ ç¬¬ä¸€æ‰¹è¯·æ±‚å“åº”æ…¢

é¢„çƒ­è§£å†³æ–¹æ¡ˆï¼š
æ´»åŠ¨å¼€å§‹å‰10åˆ†é’Ÿ â†’ å‘é€å°‘é‡é¢„çƒ­è¯·æ±‚ â†’ JVMã€æ•°æ®åº“ã€ç¼“å­˜éƒ½å‡†å¤‡å°±ç»ª
```

```java
@Component
public class SecKillWarmUpService {
    
    @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿæ‰§è¡Œ
    public void warmUpCache() {
        // 1. é¢„åŠ è½½çƒ­ç‚¹å•†å“åº“å­˜åˆ°Redis
        List<Long> hotProducts = getHotProducts();
        for (Long productId : hotProducts) {
            preloadProductStock(productId);
        }
        
        // 2. é¢„çƒ­æ•°æ®åº“è¿æ¥æ± 
        warmUpDatabase();
    }
    
    private void preloadProductStock(Long productId) {
        String stockKey = "stock:count:" + productId;
        if (!redisTemplate.hasKey(stockKey)) {
            Integer dbStock = stockMapper.getStock(productId);
            redisTemplate.opsForValue().set(stockKey, dbStock, 1, TimeUnit.HOURS);
        }
    }
}
```

### 7.2 é™æµä¿æŠ¤æœºåˆ¶


**ğŸ”¸ å¤šå±‚é™æµç­–ç•¥**
```java
@RestController
public class SecKillController {
    
    // 1. æ¥å£çº§åˆ«é™æµ
    @RateLimiter(rate = 1000) // æ¯ç§’æœ€å¤š1000ä¸ªè¯·æ±‚
    public Result secKill(@RequestParam Long productId) {
        return secKillService.secKill(productId);
    }
    
    // 2. ç”¨æˆ·çº§åˆ«é™æµ  
    @UserRateLimit(rate = 10) // æ¯ä¸ªç”¨æˆ·æ¯ç§’æœ€å¤š10æ¬¡
    public Result secKillWithUserLimit(@RequestParam Long productId) {
        return secKillService.secKill(productId);
    }
}
```

### 7.3 é™çº§æ–¹æ¡ˆè®¾è®¡


**ğŸ”¸ ç†”æ–­é™çº§ç­–ç•¥**
```java
@Component
public class SecKillFallbackService {
    
    @HystrixCommand(fallbackMethod = "secKillFallback")
    public SecKillResult secKill(Long productId) {
        // æ­£å¸¸çš„ç§’æ€é€»è¾‘
        return normalSecKillProcess(productId);
    }
    
    // é™çº§æ–¹æ³•
    public SecKillResult secKillFallback(Long productId) {
        // 1. è®°å½•é™çº§æ—¥å¿—
        log.warn("ç§’æ€æœåŠ¡é™çº§ï¼Œå•†å“ID: {}", productId);
        
        // 2. è¿”å›å‹å¥½æç¤º
        return SecKillResult.builder()
                .success(false)
                .message("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•")
                .build();
    }
}
```

**é™çº§çš„å±‚æ¬¡è®¾è®¡**ï¼š
```
é™çº§å±‚æ¬¡       è§¦å‘æ¡ä»¶              é™çº§ç­–ç•¥
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Level 1    å¹¶å‘é‡è¾¾åˆ°80%         â†’ å¢åŠ é”ç­‰å¾…æ—¶é—´
Level 2    å¹¶å‘é‡è¾¾åˆ°90%         â†’ éƒ¨åˆ†è¯·æ±‚æ’é˜Ÿ
Level 3    å¹¶å‘é‡è¾¾åˆ°95%         â†’ è¿”å›"è¯·ç¨åå†è¯•"  
Level 4    ç³»ç»Ÿå¼‚å¸¸/æ•°æ®åº“å®•æœº    â†’ å…¨é¢åœæ­¢ç§’æ€
```

---

## 8. ğŸ“Š ç›‘æ§ä¸è¿ç»´å®è·µ


### 8.1 å…³é”®ç›‘æ§æŒ‡æ ‡


**ğŸ”¸ ä¸šåŠ¡å±‚é¢ç›‘æ§**
```java
@Component
public class SecKillMonitor {
    
    private MeterRegistry meterRegistry;
    
    public void recordSecKillAttempt(Long productId, boolean success) {
        // è®°å½•ç§’æ€å°è¯•æ¬¡æ•°
        meterRegistry.counter("seckill.attempt", 
                             "product", productId.toString(),
                             "result", success ? "success" : "failed")
                     .increment();
    }
    
    public void recordLockWaitTime(long waitTimeMs) {
        // è®°å½•é”ç­‰å¾…æ—¶é—´
        meterRegistry.timer("seckill.lock.wait.time")
                     .record(waitTimeMs, TimeUnit.MILLISECONDS);
    }
    
    public void recordStockLevel(Long productId, Integer currentStock) {
        // è®°å½•å½“å‰åº“å­˜æ°´ä½
        meterRegistry.gauge("seckill.stock.level", 
                           Tags.of("product", productId.toString()), 
                           currentStock);
    }
}
```

### 8.2 å¼‚å¸¸å¤„ç†ä¸å‘Šè­¦


**ğŸ”¸ å¼‚å¸¸åˆ†ç±»å¤„ç†**
```java
@ControllerAdvice
public class SecKillExceptionHandler {
    
    // é”è·å–è¶…æ—¶å¼‚å¸¸
    @ExceptionHandler(LockTimeoutException.class)
    public Result handleLockTimeout(LockTimeoutException e) {
        // å‘Šè­¦ï¼šå¯èƒ½å‡ºç°é”ç«äº‰æ¿€çƒˆ
        alertService.sendAlert("åˆ†å¸ƒå¼é”ç«äº‰æ¿€çƒˆ", e.getMessage());
        
        return Result.failure("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•");
    }
    
    // åº“å­˜ä¸è¶³å¼‚å¸¸
    @ExceptionHandler(InsufficientStockException.class)
    public Result handleInsufficientStock(InsufficientStockException e) {
        return Result.failure("å•†å“å·²å”®ç½„");
    }
    
    // ç³»ç»Ÿå¼‚å¸¸
    @ExceptionHandler(Exception.class)  
    public Result handleSystemError(Exception e) {
        // ç³»ç»Ÿå¼‚å¸¸éœ€è¦ç«‹å³å‘Šè­¦
        alertService.sendUrgentAlert("ç§’æ€ç³»ç»Ÿå¼‚å¸¸", e);
        
        return Result.failure("ç³»ç»Ÿæš‚æ—¶ä¸å¯ç”¨");
    }
}
```

### 8.3 å‹æµ‹éªŒè¯æ–¹æ³•


**ğŸ”¸ å‹æµ‹åœºæ™¯è®¾è®¡**
```bash
# ä½¿ç”¨JMeterè¿›è¡Œå‹åŠ›æµ‹è¯•
# æµ‹è¯•åœºæ™¯1: æ­£å¸¸è´Ÿè½½æµ‹è¯•
./jmeter -n -t seckill-normal.jmx \
  -Jusers=100 \              # 100ä¸ªå¹¶å‘ç”¨æˆ·
  -Jrampup=10 \              # 10ç§’å†…å¯åŠ¨å®Œæˆ
  -Jduration=300 \           # æŒç»­5åˆ†é’Ÿ
  -Jproduct.id=12345

# æµ‹è¯•åœºæ™¯2: å³°å€¼å‹åŠ›æµ‹è¯•  
./jmeter -n -t seckill-peak.jmx \
  -Jusers=5000 \             # 5000ä¸ªå¹¶å‘ç”¨æˆ·
  -Jrampup=1 \               # 1ç§’å†…å¯åŠ¨ï¼ˆæ¨¡æ‹Ÿç§’æ€å¼€å§‹ï¼‰
  -Jduration=60              # æŒç»­1åˆ†é’Ÿ
```

**å…³é”®æ€§èƒ½æŒ‡æ ‡éªŒè¯**ï¼š
```
æ€§èƒ½ç›®æ ‡è®¾å®šï¼š
â€¢ å“åº”æ—¶é—´ï¼šP99 < 500ms
â€¢ ååé‡ï¼š>= 10000 TPS  
â€¢ é”™è¯¯ç‡ï¼š< 1%
â€¢ åº“å­˜ä¸€è‡´æ€§ï¼š100%ï¼ˆç»ä¸è¶…å–ï¼‰

éªŒè¯æ–¹æ³•ï¼š
1. å‹æµ‹å‰ï¼šåº“å­˜1000ä»¶
2. å‹æµ‹ä¸­ï¼š5000ç”¨æˆ·æŠ¢è´­
3. å‹æµ‹åï¼šæ£€æŸ¥å®é™…é”€å”®é‡ <= 1000
4. æ•°æ®æ ¡éªŒï¼šRedisåº“å­˜ = æ•°æ®åº“åº“å­˜
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ ç§’æ€ç³»ç»Ÿæœ¬è´¨ï¼šé«˜å¹¶å‘ä¸‹çš„èµ„æºç«äº‰é—®é¢˜
ğŸ”¸ åˆ†å¸ƒå¼é”ä½œç”¨ï¼šåè°ƒå¤šä¸ªæœåŠ¡å®ä¾‹ï¼Œä¿è¯æ“ä½œåŸå­æ€§
ğŸ”¸ é˜²è¶…å–ç­–ç•¥ï¼šRedisé¢„æ ¡éªŒ + æ•°æ®åº“æœ€ç»ˆä¿éšœ
ğŸ”¸ å¹‚ç­‰æ€§è®¾è®¡ï¼šé˜²æ­¢é‡å¤æ“ä½œï¼Œä¿è¯ä¸šåŠ¡æ­£ç¡®æ€§
ğŸ”¸ æ€§èƒ½ä¼˜åŒ–ï¼šé”ç²’åº¦ã€é¢„çƒ­ã€é™æµã€é™çº§å¤šç»´åº¦ä¼˜åŒ–
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆåˆ†å¸ƒå¼é”æ˜¯å¿…éœ€çš„**
```
å¾®æœåŠ¡ç¯å¢ƒä¸‹çš„æŒ‘æˆ˜ï¼š
â€¢ å¤šä¸ªæœåŠ¡å®ä¾‹åŒæ—¶å¤„ç†è¯·æ±‚
â€¢ Javaçš„synchronizedåªèƒ½é”å®šå•ä¸ªJVM
â€¢ å…±äº«èµ„æºï¼ˆæ•°æ®åº“ï¼‰éœ€è¦è·¨JVMçš„åè°ƒæœºåˆ¶
â€¢ åˆ†å¸ƒå¼é”æä¾›äº†è¿™ç§åè°ƒèƒ½åŠ›
```

**ğŸ”¹ å¦‚ä½•é€‰æ‹©é”çš„å®ç°æ–¹å¼**
```
é€‰æ‹©ä¾æ®ï¼š
â€¢ æ€§èƒ½è¦æ±‚é«˜ â†’ Redisåˆ†å¸ƒå¼é”
â€¢ ä¸€è‡´æ€§è¦æ±‚å¼º â†’ Zookeeperé”  
â€¢ åœºæ™¯ç®€å• â†’ æ•°æ®åº“é”

å®é™…åº”ç”¨ï¼š
â€¢ ç§’æ€ç³»ç»Ÿé€šå¸¸é€‰æ‹©Redisï¼ˆæ€§èƒ½ä¼˜å…ˆï¼‰
â€¢ é‡‘èç³»ç»Ÿå¯èƒ½é€‰æ‹©Zookeeperï¼ˆä¸€è‡´æ€§ä¼˜å…ˆï¼‰
```

**ğŸ”¹ é”ç²’åº¦ä¼˜åŒ–çš„å¹³è¡¡**
```
ç²’åº¦æƒè¡¡ï¼š
â€¢ é”ç²’åº¦å¤ªç²— â†’ æ€§èƒ½ä½ä¸‹ï¼Œç”¨æˆ·ä½“éªŒå·®
â€¢ é”ç²’åº¦å¤ªç»† â†’ å¤æ‚åº¦é«˜ï¼Œç»´æŠ¤å›°éš¾
â€¢ æœ€ä½³å®è·µï¼šæŒ‰å•†å“åˆ†é” + åˆ†æ®µä¼˜åŒ–
```

### 9.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¸šåŠ¡åœºæ™¯åº”ç”¨**
- **ç”µå•†ç§’æ€**ï¼šé˜²æ­¢è¶…å–ï¼Œä¿è¯ç”¨æˆ·ä½“éªŒ
- **æŠ¢çº¢åŒ…ç³»ç»Ÿ**ï¼šç¡®ä¿é‡‘é¢åˆ†é…å‡†ç¡®
- **é™é‡æ´»åŠ¨**ï¼šæ§åˆ¶å‚ä¸äººæ•°å’Œèµ„æºåˆ†é…
- **ç¥¨åŠ¡ç³»ç»Ÿ**ï¼šé˜²æ­¢åº§ä½é‡å¤å”®å–

**ğŸ”§ æŠ€æœ¯å®è·µè¦ç‚¹**
- **ç³»ç»Ÿè®¾è®¡**ï¼šå¤šå±‚é˜²æŠ¤ï¼Œæ•…éšœéš”ç¦»
- **æ€§èƒ½è°ƒä¼˜**ï¼šé¢„çƒ­ã€é™æµã€é™çº§ç»“åˆä½¿ç”¨  
- **ç›‘æ§è¿ç»´**ï¼šå…³é”®æŒ‡æ ‡ç›‘æ§ï¼Œå¼‚å¸¸å¿«é€Ÿå“åº”
- **æµ‹è¯•éªŒè¯**ï¼šå……åˆ†å‹æµ‹ï¼ŒéªŒè¯æé™åœºæ™¯

### 9.4 ç”Ÿäº§ç¯å¢ƒç»éªŒæ€»ç»“


**ğŸ’¡ æœ€ä½³å®è·µ**
```
è®¾è®¡åŸåˆ™ï¼š
â€¢ é˜²è¶…å–æ˜¯åº•çº¿ï¼Œæ€§èƒ½æ˜¯ç›®æ ‡
â€¢ å¤šå±‚ä¿æŠ¤ï¼Œå•ç‚¹æ•…éšœä¸å½±å“æ•´ä½“
â€¢ ç›‘æ§å…ˆè¡Œï¼Œé—®é¢˜æ—©å‘ç°æ—©å¤„ç†

å¸¸è§é™·é˜±ï¼š
â€¢ å¿˜è®°è®¾ç½®é”è¶…æ—¶æ—¶é—´ï¼ˆå¯¼è‡´æ­»é”ï¼‰
â€¢ é‡Šæ”¾é”æ—¶ä¸éªŒè¯æ‰€æœ‰è€…ï¼ˆè¯¯åˆ åˆ«äººçš„é”ï¼‰
â€¢ é”ç²’åº¦è®¾è®¡ä¸å½“ï¼ˆæ€§èƒ½ç“¶é¢ˆæˆ–èµ„æºæµªè´¹ï¼‰
â€¢ ç¼ºä¹é™çº§æ–¹æ¡ˆï¼ˆç³»ç»Ÿé›ªå´©ï¼‰
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- åˆ†å¸ƒå¼é”ä¿åŸå­ï¼Œé˜²è¶…å–æ¥å®ˆåº•çº¿
- ç²’åº¦ä¼˜åŒ–ææ€§èƒ½ï¼Œé™çº§æ–¹æ¡ˆä¿ç¨³å®š
- ç›‘æ§å‘Šè­¦ä¸èƒ½å°‘ï¼Œå‹æµ‹éªŒè¯è¦å……åˆ†
- å¹‚ç­‰è®¾è®¡é˜²é‡å¤ï¼Œå¼‚å¸¸å¤„ç†è¦å‘¨å…¨