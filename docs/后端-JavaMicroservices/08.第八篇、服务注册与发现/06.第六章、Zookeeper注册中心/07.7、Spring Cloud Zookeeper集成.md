---
title: 7ã€Spring Cloud Zookeeperé›†æˆ
---
## ğŸ“š ç›®å½•

1. [Spring Cloud Zookeeperæ¦‚è¿°](#1-spring-cloud-zookeeperæ¦‚è¿°)
2. [Mavenä¾èµ–é…ç½®](#2-mavenä¾èµ–é…ç½®)
3. [æœåŠ¡æ³¨å†Œé…ç½®](#3-æœåŠ¡æ³¨å†Œé…ç½®)
4. [æœåŠ¡å‘ç°å®ç°](#4-æœåŠ¡å‘ç°å®ç°)
5. [é…ç½®ç®¡ç†åŠŸèƒ½](#5-é…ç½®ç®¡ç†åŠŸèƒ½)
6. [åˆ†å¸ƒå¼é”å®ç°](#6-åˆ†å¸ƒå¼é”å®ç°)
7. [äº‹ä»¶ç›‘å¬æœºåˆ¶](#7-äº‹ä»¶ç›‘å¬æœºåˆ¶)
8. [ä¸å…¶ä»–ç»„ä»¶é›†æˆ](#8-ä¸å…¶ä»–ç»„ä»¶é›†æˆ)
9. [æœ€ä½³å®è·µå»ºè®®](#9-æœ€ä½³å®è·µå»ºè®®)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ Spring Cloud Zookeeperæ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯Spring Cloud Zookeeper


**é€šä¿—ç†è§£**ï¼š
æƒ³è±¡ä½ å¼€äº†ä¸€å®¶è¿é”é¤å…ï¼Œæ¯å®¶åˆ†åº—éƒ½éœ€è¦çŸ¥é“å…¶ä»–åˆ†åº—çš„ä½ç½®å’Œè¥ä¸šçŠ¶æ€ã€‚Spring Cloud Zookeeperå°±åƒæ˜¯ä¸€ä¸ª**æ€»éƒ¨è°ƒåº¦ç³»ç»Ÿ**ï¼Œå¸®åŠ©å„ä¸ªåˆ†åº—ï¼ˆå¾®æœåŠ¡ï¼‰äº’ç›¸æ‰¾åˆ°å¯¹æ–¹ã€‚

**æ ¸å¿ƒä½œç”¨**ï¼š
- ğŸ” **æœåŠ¡æ³¨å†Œ**ï¼šæ–°å¼€çš„åˆ†åº—è‡ªåŠ¨å‘æ€»éƒ¨æŠ¥åˆ°
- ğŸ“¡ **æœåŠ¡å‘ç°**ï¼šå…¶ä»–åˆ†åº—èƒ½å¿«é€Ÿæ‰¾åˆ°å®ƒ
- ğŸ“‹ **é…ç½®ç®¡ç†**ï¼šç»Ÿä¸€ç®¡ç†æ‰€æœ‰åˆ†åº—çš„è§„åˆ™
- ğŸ”’ **åˆ†å¸ƒå¼åè°ƒ**ï¼šé˜²æ­¢å¤šä¸ªåˆ†åº—åŒæ—¶åšåŒä¸€ä»¶äº‹

> ğŸ’¡ **æ–°æ‰‹æç¤º**  
> Spring Cloud Zookeeperæ˜¯Spring Cloudå®¶æ—ä¸­ä½¿ç”¨Zookeeperä½œä¸ºæ³¨å†Œä¸­å¿ƒçš„ç»„ä»¶ï¼Œå®ƒæŠŠå¤æ‚çš„Zookeeperæ“ä½œå°è£…æˆäº†ç®€å•æ˜“ç”¨çš„æ³¨è§£å’Œé…ç½®ã€‚

### 1.2 ä¸ºä»€ä¹ˆé€‰æ‹©Spring Cloud Zookeeper


**é€‚ç”¨åœºæ™¯å¯¹æ¯”**ï¼š

| ç‰¹æ€§ | **Spring Cloud Zookeeper** | **Spring Cloud Eureka** | **é€‚ç”¨åœºæ™¯** |
|------|---------------------------|------------------------|------------|
| ğŸ¯ **ä¸€è‡´æ€§** | `å¼ºä¸€è‡´æ€§(CPæ¨¡å‹)` | `é«˜å¯ç”¨æ€§(APæ¨¡å‹)` | `é‡‘èã€æ”¯ä»˜ç­‰ä¸¥æ ¼åœºæ™¯` |
| âš¡ **æ€§èƒ½** | `è¯»å†™æ€§èƒ½ä¼˜ç§€` | `è¯»æ€§èƒ½æ›´å¥½` | `é«˜å¹¶å‘è¯»å–åœºæ™¯` |
| ğŸ”§ **åŠŸèƒ½** | `æ³¨å†Œ+é…ç½®+åè°ƒ` | `ä»…æœåŠ¡æ³¨å†Œ` | `éœ€è¦å¤šåŠŸèƒ½é›†æˆ` |
| ğŸ“Š **è¿ç»´** | `éœ€è¦ç‹¬ç«‹éƒ¨ç½²ZKé›†ç¾¤` | `ä¸åº”ç”¨é›†æˆç®€å•` | `æœ‰è¿ç»´å›¢é˜Ÿæ”¯æ’‘` |

> âš ï¸ **é€‰æ‹©å»ºè®®**  
> å¦‚æœä½ çš„ç³»ç»Ÿå¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚é«˜ï¼Œæˆ–è€…å·²ç»åœ¨ç”¨Zookeeperåšå…¶ä»–äº‹æƒ…ï¼Œé‚£ä¹ˆé€‰æ‹©Spring Cloud Zookeeperä¼šæ›´åˆé€‚ã€‚

### 1.3 æ ¸å¿ƒæ¦‚å¿µè§£é‡Š


**æœåŠ¡æ³¨å†Œæµç¨‹å›¾**ï¼š
```
å¾®æœåŠ¡å¯åŠ¨
    |
    v
è¯»å–é…ç½®(application.yml)
    |
    v
è¿æ¥åˆ°Zookeeperé›†ç¾¤
    |
    v
åœ¨ZKåˆ›å»ºä¸´æ—¶èŠ‚ç‚¹(/services/user-service/instance1)
    |
    v
å†™å…¥æœåŠ¡å…ƒæ•°æ®(IPã€ç«¯å£ã€å¥åº·çŠ¶æ€)
    |
    v
ä¿æŒå¿ƒè·³è¿æ¥
    |
    v
æœåŠ¡å¯è¢«å‘ç° âœ“
```

**å…³é”®æœ¯è¯­è¯´æ˜**ï¼š

| æœ¯è¯­ | **é€šä¿—è§£é‡Š** | **æŠ€æœ¯å«ä¹‰** |
|-----|------------|------------|
| **ä¸´æ—¶èŠ‚ç‚¹** | `åˆ†åº—è¥ä¸šä¸­çš„æ ‡è¯†ï¼Œå…³é—¨åè‡ªåŠ¨æ¶ˆå¤±` | `Sessionæœ‰æ•ˆæœŸå†…å­˜åœ¨çš„ZNode` |
| **æŒä¹…èŠ‚ç‚¹** | `åˆ†åº—çš„æ°¸ä¹…æ¡£æ¡ˆï¼Œå³ä½¿å…³é—¨ä¹Ÿä¿ç•™` | `æ‰‹åŠ¨åˆ é™¤å‰ä¸€ç›´å­˜åœ¨çš„ZNode` |
| **æœåŠ¡å®ä¾‹** | `å…·ä½“çš„ä¸€å®¶åˆ†åº—` | `è¿è¡Œä¸­çš„å¾®æœåŠ¡è¿›ç¨‹` |
| **å…ƒæ•°æ®** | `åˆ†åº—çš„è¯¦ç»†ä¿¡æ¯(åœ°å€ã€ç”µè¯ã€è¥ä¸šæ—¶é—´)` | `æœåŠ¡çš„IPã€ç«¯å£ã€ç‰ˆæœ¬ç­‰ä¿¡æ¯` |

---

## 2. ğŸ“¦ Mavenä¾èµ–é…ç½®


### 2.1 åŸºç¡€ä¾èµ–å¼•å…¥


**ä¾èµ–è¯´æ˜**ï¼š
```xml
<dependencies>
    <!-- Spring Cloud Zookeeperæ ¸å¿ƒä¾èµ– -->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-zookeeper-discovery</artifactId>
    </dependency>
    
    <!-- æœåŠ¡å‘ç°å®¢æˆ·ç«¯ -->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-zookeeper-config</artifactId>
    </dependency>
</dependencies>
```

> ğŸ’¡ **ä¾èµ–è§£è¯»**  
> - `zookeeper-discovery`ï¼šè´Ÿè´£æœåŠ¡æ³¨å†Œå’Œå‘ç°
> - `zookeeper-config`ï¼šè´Ÿè´£é…ç½®ç®¡ç†åŠŸèƒ½
> - ä¸¤è€…å¯ä»¥ç‹¬ç«‹ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥ç»„åˆä½¿ç”¨

### 2.2 ç‰ˆæœ¬å…¼å®¹æ€§ç®¡ç†


**ç‰ˆæœ¬å¯¹åº”å…³ç³»**ï¼š

| Spring Bootç‰ˆæœ¬ | **Spring Cloudç‰ˆæœ¬** | **Zookeeperç‰ˆæœ¬** |
|----------------|---------------------|------------------|
| `2.6.x` | `2021.0.x (Jubilee)` | `3.6.x - 3.8.x` |
| `2.7.x` | `2021.0.x (Jubilee)` | `3.6.x - 3.8.x` |
| `3.0.x` | `2022.0.x (Kilburn)` | `3.8.x` |

**å®Œæ•´pom.xmlç¤ºä¾‹**ï¼š
```xml
<properties>
    <spring-boot.version>2.7.14</spring-boot.version>
    <spring-cloud.version>2021.0.8</spring-cloud.version>
</properties>

<dependencyManagement>
    <dependencies>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-dependencies</artifactId>
            <version>${spring-cloud.version}</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
    </dependencies>
</dependencyManagement>
```

> âš ï¸ **ç‰ˆæœ¬å†²çªè­¦å‘Š**  
> Zookeeperå®¢æˆ·ç«¯ç‰ˆæœ¬å¿…é¡»ä¸æœåŠ¡ç«¯å…¼å®¹ï¼Œå¦åˆ™ä¼šå‡ºç°è¿æ¥å¤±è´¥ã€‚å»ºè®®ä½¿ç”¨Spring Cloudç»Ÿä¸€ç®¡ç†ç‰ˆæœ¬ï¼Œé¿å…æ‰‹åŠ¨æŒ‡å®šã€‚

### 2.3 å¯é€‰ä¾èµ–è¯´æ˜


**æ ¹æ®éœ€æ±‚é€‰æ‹©**ï¼š

```xml
<!-- ä½¿ç”¨Curatorå®¢æˆ·ç«¯(æ¨èï¼ŒåŠŸèƒ½æ›´å¼ºå¤§) -->
<dependency>
    <groupId>org.apache.curator</groupId>
    <artifactId>curator-x-discovery</artifactId>
</dependency>

<!-- å¥åº·æ£€æŸ¥æ”¯æŒ -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>

<!-- è´Ÿè½½å‡è¡¡(å¦‚æœéœ€è¦RestTemplateè°ƒç”¨) -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-loadbalancer</artifactId>
</dependency>
```

**ä¾èµ–é€‰æ‹©æŒ‡å—**ï¼š
- âœ… **å¿…éœ€**ï¼š`zookeeper-discovery`ï¼ˆæœåŠ¡æ³¨å†Œå‘ç°ï¼‰
- ğŸ”§ **æ¨è**ï¼š`curator-x-discovery`ï¼ˆæ›´å¥½çš„å®¢æˆ·ç«¯ï¼‰
- ğŸ“Š **å¯é€‰**ï¼š`actuator`ï¼ˆå¥åº·æ£€æŸ¥ï¼‰
- âš–ï¸ **æŒ‰éœ€**ï¼š`loadbalancer`ï¼ˆå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ï¼‰

---

## 3. âš™ï¸ æœåŠ¡æ³¨å†Œé…ç½®


### 3.1 åŸºç¡€é…ç½®æ–‡ä»¶


**application.ymlå®Œæ•´é…ç½®**ï¼š
```yaml
spring:
  application:
    name: user-service  # æœåŠ¡åç§°ï¼Œç›¸å½“äºåˆ†åº—çš„å“ç‰Œå
  cloud:
    zookeeper:
      connect-string: localhost:2181  # ZKæœåŠ¡å™¨åœ°å€
      discovery:
        enabled: true  # å¼€å¯æœåŠ¡å‘ç°
        register: true  # å¼€å¯æœåŠ¡æ³¨å†Œ
        instance-id: ${spring.application.name}:${server.port}  # å®ä¾‹ID
        
server:
  port: 8080  # æœåŠ¡ç«¯å£
```

> ğŸ’¡ **é…ç½®è§£è¯»**  
> - `application.name`ï¼šæœåŠ¡çš„åå­—ï¼Œå…¶ä»–æœåŠ¡é€šè¿‡è¿™ä¸ªåå­—æ‰¾åˆ°ä½ 
> - `connect-string`ï¼šZookeeperçš„åœ°å€ï¼Œå¯ä»¥é…ç½®å¤šä¸ªç”¨é€—å·åˆ†éš”
> - `instance-id`ï¼šæ¯ä¸ªå®ä¾‹çš„å”¯ä¸€æ ‡è¯†ï¼Œé»˜è®¤æ˜¯æœåŠ¡å+ç«¯å£

### 3.2 è¯¦ç»†é…ç½®é¡¹è¯´æ˜


**é«˜çº§é…ç½®é€‰é¡¹**ï¼š

```yaml
spring:
  cloud:
    zookeeper:
      # è¿æ¥é…ç½®
      max-retries: 3  # è¿æ¥é‡è¯•æ¬¡æ•°
      max-sleep-ms: 1000  # é‡è¯•é—´éš”(æ¯«ç§’)
      base-sleep-time-ms: 50  # åŸºç¡€ä¼‘çœ æ—¶é—´
      
      discovery:
        # æœåŠ¡æ³¨å†Œé…ç½®
        root: /services  # æœåŠ¡æ³¨å†Œæ ¹è·¯å¾„
        instance-host: localhost  # æœåŠ¡å®ä¾‹ä¸»æœºå
        instance-port: ${server.port}  # æœåŠ¡ç«¯å£
        instance-ssl-port: 443  # HTTPSç«¯å£
        
        # å…ƒæ•°æ®é…ç½®
        metadata:
          version: 1.0.0  # æœåŠ¡ç‰ˆæœ¬
          zone: zone1  # å¯ç”¨åŒº
          group: default  # æœåŠ¡åˆ†ç»„
```

**é…ç½®é¡¹ç”¨é€”å¯¹æ¯”**ï¼š

| é…ç½®é¡¹ | **é»˜è®¤å€¼** | **ä½œç”¨è¯´æ˜** | **ä½•æ—¶ä¿®æ”¹** |
|-------|-----------|------------|------------|
| `root` | `/services` | `ZKä¸­æœåŠ¡æ³¨å†Œçš„æ ¹è·¯å¾„` | `å¤šç¯å¢ƒéš”ç¦»æ—¶` |
| `max-retries` | `10` | `è¿æ¥å¤±è´¥é‡è¯•æ¬¡æ•°` | `ç½‘ç»œä¸ç¨³å®šæ—¶å¢å¤§` |
| `metadata` | `ç©º` | `æœåŠ¡çš„é™„åŠ ä¿¡æ¯` | `éœ€è¦ç‰ˆæœ¬æ§åˆ¶æˆ–åˆ†ç»„` |

### 3.3 å¯åŠ¨ç±»æ³¨è§£é…ç½®


**å¯åŠ¨ç±»ç¤ºä¾‹**ï¼š
```java
@SpringBootApplication
@EnableDiscoveryClient  // å¼€å¯æœåŠ¡å‘ç°å®¢æˆ·ç«¯
public class UserServiceApplication {
    public static void main(String[] args) {
        SpringApplication.run(UserServiceApplication.class, args);
    }
}
```

> âš ï¸ **æ³¨è§£è¯´æ˜**  
> `@EnableDiscoveryClient`æ˜¯é€šç”¨æ³¨è§£ï¼Œé€‚ç”¨äºæ‰€æœ‰æ³¨å†Œä¸­å¿ƒã€‚Spring Cloudä¼šæ ¹æ®ä½ å¼•å…¥çš„ä¾èµ–è‡ªåŠ¨é€‰æ‹©ä½¿ç”¨Zookeeperã€‚

**æ³¨å†ŒæˆåŠŸéªŒè¯**ï¼š
```
å¯åŠ¨æ—¥å¿—åº”è¯¥çœ‹åˆ°ï¼š
âœ“ Started ZookeeperDiscoveryClient
âœ“ Registered service in Zookeeper: user-service
âœ“ InstanceInfo: user-service:8080
```

**ZKèŠ‚ç‚¹ç»“æ„**ï¼š
```
/services
    â””â”€â”€ user-service        # æœåŠ¡åç§°èŠ‚ç‚¹(æŒä¹…)
        â””â”€â”€ instance1       # å®ä¾‹èŠ‚ç‚¹(ä¸´æ—¶)
            â”œâ”€â”€ ä¸»æœº: localhost
            â”œâ”€â”€ ç«¯å£: 8080
            â”œâ”€â”€ çŠ¶æ€: UP
            â””â”€â”€ å…ƒæ•°æ®: {...}
```

---

## 4. ğŸ” æœåŠ¡å‘ç°å®ç°


### 4.1 ä½¿ç”¨DiscoveryClientå‘ç°æœåŠ¡


**é€šä¿—è§£é‡Š**ï¼š
`DiscoveryClient`å°±åƒä¸€ä¸ª**ç”µè¯ç°¿æŸ¥è¯¢ç³»ç»Ÿ**ï¼Œä½ å‘Šè¯‰å®ƒä½ è¦æ‰¾å“ªå®¶åˆ†åº—ï¼ˆæœåŠ¡åï¼‰ï¼Œå®ƒå°±å‘Šè¯‰ä½ æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„åˆ†åº—åœ°å€ï¼ˆå®ä¾‹åˆ—è¡¨ï¼‰ã€‚

**åŸºç¡€ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
@RestController
@RequestMapping("/api")
public class OrderController {
    
    @Autowired
    private DiscoveryClient discoveryClient;
    
    @GetMapping("/find-user-service")
    public List<String> findUserService() {
        // è·å–user-serviceçš„æ‰€æœ‰å®ä¾‹
        List<ServiceInstance> instances = 
            discoveryClient.getInstances("user-service");
        
        // æå–å®ä¾‹åœ°å€
        return instances.stream()
            .map(instance -> instance.getHost() + ":" + instance.getPort())
            .collect(Collectors.toList());
    }
}
```

**è¿”å›ç»“æœç¤ºä¾‹**ï¼š
```json
[
    "localhost:8080",
    "localhost:8081",
    "localhost:8082"
]
```

> ğŸ’¡ **å®æˆ˜æŠ€å·§**  
> `getInstances()`è¿”å›çš„æ˜¯æ‰€æœ‰å¥åº·çš„å®ä¾‹ï¼ŒZookeeperä¼šè‡ªåŠ¨è¿‡æ»¤æ‰å·²ç»ä¸‹çº¿çš„æœåŠ¡ã€‚

### 4.2 ä½¿ç”¨RestTemplateå®ç°æœåŠ¡è°ƒç”¨


**è´Ÿè½½å‡è¡¡è°ƒç”¨**ï¼š
```java
@Configuration
public class RestTemplateConfig {
    
    @Bean
    @LoadBalanced  // å¼€å¯å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡
    public RestTemplate restTemplate() {
        return new RestTemplate();
    }
}
```

**è°ƒç”¨å…¶ä»–æœåŠ¡**ï¼š
```java
@Service
public class OrderService {
    
    @Autowired
    private RestTemplate restTemplate;
    
    public UserInfo getUserInfo(Long userId) {
        // ç›´æ¥ç”¨æœåŠ¡åè°ƒç”¨ï¼Œä¸éœ€è¦å†™IPå’Œç«¯å£
        String url = "http://user-service/api/users/" + userId;
        return restTemplate.getForObject(url, UserInfo.class);
    }
}
```

**è°ƒç”¨æµç¨‹å›¾**ï¼š
```
OrderService
    |
    | è°ƒç”¨: http://user-service/api/users/123
    v
RestTemplate(@LoadBalanced)
    |
    | 1. è§£ææœåŠ¡å: user-service
    v
DiscoveryClient
    |
    | 2. æŸ¥è¯¢ZKè·å–å®ä¾‹åˆ—è¡¨
    v
è´Ÿè½½å‡è¡¡å™¨(é»˜è®¤è½®è¯¢)
    |
    | 3. é€‰æ‹©ä¸€ä¸ªå®ä¾‹: localhost:8080
    v
å®é™…è¯·æ±‚: http://localhost:8080/api/users/123
```

> âš ï¸ **å¸¸è§é”™è¯¯**  
> å¦‚æœå¿˜è®°åŠ `@LoadBalanced`æ³¨è§£ï¼Œä¼šæŠ¥é”™ï¼š"No instances available for user-service"

### 4.3 ä½¿ç”¨OpenFeignå£°æ˜å¼è°ƒç”¨


**ä¾èµ–é…ç½®**ï¼š
```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-openfeign</artifactId>
</dependency>
```

**å®šä¹‰Feignå®¢æˆ·ç«¯**ï¼š
```java
@FeignClient(name = "user-service")  // æœåŠ¡å
public interface UserServiceClient {
    
    @GetMapping("/api/users/{id}")
    UserInfo getUserById(@PathVariable("id") Long id);
    
    @PostMapping("/api/users")
    UserInfo createUser(@RequestBody UserInfo user);
}
```

**ä½¿ç”¨Feignå®¢æˆ·ç«¯**ï¼š
```java
@Service
public class OrderService {
    
    @Autowired
    private UserServiceClient userServiceClient;
    
    public void processOrder(Long userId) {
        // åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·è°ƒç”¨è¿œç¨‹æœåŠ¡
        UserInfo user = userServiceClient.getUserById(userId);
        System.out.println("ç”¨æˆ·ä¿¡æ¯ï¼š" + user.getName());
    }
}
```

**æ–¹å¼å¯¹æ¯”**ï¼š

| è°ƒç”¨æ–¹å¼ | **ä¼˜ç‚¹** | **ç¼ºç‚¹** | **é€‚ç”¨åœºæ™¯** |
|---------|---------|---------|------------|
| **DiscoveryClient** | `çµæ´»ï¼Œå¯è‡ªå®šä¹‰é€»è¾‘` | `ä»£ç é‡å¤šï¼Œæ‰‹åŠ¨å¤„ç†` | `å¤æ‚çš„æœåŠ¡å‘ç°é€»è¾‘` |
| **RestTemplate** | `ç®€å•ï¼Œç›´æ¥ä½¿ç”¨` | `å­—ç¬¦ä¸²æ‹¼æ¥URLå®¹æ˜“å‡ºé”™` | `å¿«é€Ÿå¼€å‘ï¼Œç®€å•è°ƒç”¨` |
| **OpenFeign** | `å£°æ˜å¼ï¼Œä¼˜é›…ç®€æ´` | `éœ€è¦é¢å¤–ä¾èµ–` | `æ¨èæ–¹å¼ï¼Œç”Ÿäº§ä½¿ç”¨` |

---

## 5. ğŸ“‹ é…ç½®ç®¡ç†åŠŸèƒ½


### 5.1 é…ç½®ä¸­å¿ƒåŸºæœ¬æ¦‚å¿µ


**é€šä¿—ç†è§£**ï¼š
ä¼ ç»Ÿæ–¹å¼æ¯ä¸ªåˆ†åº—çš„è§„åˆ™å†™åœ¨è‡ªå·±çš„æœ¬å­ä¸Šï¼Œè¦æ”¹è§„åˆ™å¾—ä¸€å®¶å®¶å»æ”¹ã€‚é…ç½®ä¸­å¿ƒå°±åƒæ˜¯**æ€»éƒ¨çš„è§„ç« åˆ¶åº¦æ‰‹å†Œ**ï¼Œæ‰€æœ‰åˆ†åº—éƒ½ä»è¿™é‡Œè¯»å–ï¼Œæ”¹ä¸€æ¬¡å…¨éƒ¨ç”Ÿæ•ˆã€‚

**Zookeeperé…ç½®ç»“æ„**ï¼š
```
/config
    â””â”€â”€ user-service       # åº”ç”¨å
        â”œâ”€â”€ application    # å…¬å…±é…ç½®(æ‰€æœ‰ç¯å¢ƒå…±äº«)
        â”œâ”€â”€ dev           # å¼€å‘ç¯å¢ƒé…ç½®
        â”œâ”€â”€ test          # æµ‹è¯•ç¯å¢ƒé…ç½®
        â””â”€â”€ prod          # ç”Ÿäº§ç¯å¢ƒé…ç½®
```

### 5.2 é…ç½®è¯»å–å®ç°


**å¯ç”¨é…ç½®ç®¡ç†**ï¼š
```yaml
# bootstrap.yml (ä¼˜å…ˆçº§é«˜äºapplication.yml)
spring:
  application:
    name: user-service
  cloud:
    zookeeper:
      connect-string: localhost:2181
      config:
        enabled: true  # å¼€å¯é…ç½®ç®¡ç†
        root: /config  # é…ç½®æ ¹è·¯å¾„
        default-context: application  # é»˜è®¤ä¸Šä¸‹æ–‡
        profile-separator: '-'  # ç¯å¢ƒåˆ†éš”ç¬¦
```

**é…ç½®åŠ è½½é¡ºåº**ï¼š
```
1. /config/application (æ‰€æœ‰åº”ç”¨å…±äº«)
      â†“
2. /config/user-service (å½“å‰åº”ç”¨)
      â†“
3. /config/user-service-dev (å½“å‰åº”ç”¨+ç¯å¢ƒ)
      â†“
ä¼˜å…ˆçº§: 3 > 2 > 1 (åé¢çš„ä¼šè¦†ç›–å‰é¢çš„)
```

### 5.3 åŠ¨æ€é…ç½®åˆ·æ–°


**åœ¨ZKä¸­åˆ›å»ºé…ç½®**ï¼š
```bash
# ä½¿ç”¨ZKå‘½ä»¤è¡Œå·¥å…·
zkCli.sh

# åˆ›å»ºé…ç½®èŠ‚ç‚¹
create /config/user-service/maxUsers "100"
create /config/user-service/timeout "5000"
```

**è¯»å–é…ç½®**ï¼š
```java
@RestController
@RefreshScope  // æ”¯æŒåŠ¨æ€åˆ·æ–°
public class ConfigController {
    
    @Value("${maxUsers:50}")  // é»˜è®¤å€¼50
    private int maxUsers;
    
    @Value("${timeout:3000}")
    private int timeout;
    
    @GetMapping("/config")
    public Map<String, Object> getConfig() {
        Map<String, Object> config = new HashMap<>();
        config.put("maxUsers", maxUsers);
        config.put("timeout", timeout);
        return config;
    }
}
```

**åŠ¨æ€æ›´æ–°æµç¨‹**ï¼š
```
ä¿®æ”¹ZKé…ç½®
    |
    v
ZKè§¦å‘Watcheräº‹ä»¶
    |
    v
Spring Cloudæ¥æ”¶åˆ°é€šçŸ¥
    |
    v
åˆ·æ–°@RefreshScopeçš„Bean
    |
    v
æ–°é…ç½®ç”Ÿæ•ˆ(æ— éœ€é‡å¯) âœ“
```

> ğŸ’¡ **åˆ·æ–°æœºåˆ¶**  
> `@RefreshScope`è®©Beanå¯ä»¥é‡æ–°åŠ è½½é…ç½®ï¼Œä½†è¦æ³¨æ„ï¼šå•ä¾‹Beanéœ€è¦é‡æ–°æ³¨å…¥ï¼Œå¦åˆ™å¯èƒ½ä¸ç”Ÿæ•ˆã€‚

### 5.4 é…ç½®æœ€ä½³å®è·µ


**é…ç½®åˆ†å±‚ç­–ç•¥**ï¼š

| é…ç½®å±‚çº§ | **å­˜æ”¾ä½ç½®** | **é€‚ç”¨å†…å®¹** | **ç¤ºä¾‹** |
|---------|------------|------------|---------|
| **å…¨å±€é…ç½®** | `/config/application` | `æ‰€æœ‰æœåŠ¡é€šç”¨çš„é…ç½®` | `æ—¥å¿—çº§åˆ«ã€å…¬å…±å‚æ•°` |
| **åº”ç”¨é…ç½®** | `/config/user-service` | `å½“å‰åº”ç”¨çš„é…ç½®` | `æ•°æ®åº“è¿æ¥ã€ä¸šåŠ¡å‚æ•°` |
| **ç¯å¢ƒé…ç½®** | `/config/user-service-prod` | `ç‰¹å®šç¯å¢ƒçš„é…ç½®` | `ç”Ÿäº§ç¯å¢ƒçš„ç‰¹æ®Šè®¾ç½®` |

> âš ï¸ **æ•æ„Ÿä¿¡æ¯å¤„ç†**  
> å¯†ç ã€å¯†é’¥ç­‰æ•æ„Ÿä¿¡æ¯ä¸å»ºè®®ç›´æ¥å­˜ZKï¼Œåº”è¯¥ä½¿ç”¨åŠ å¯†æˆ–ä¸“é—¨çš„å¯†é’¥ç®¡ç†æœåŠ¡ã€‚

---

## 6. ğŸ”’ åˆ†å¸ƒå¼é”å®ç°


### 6.1 ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”


**é—®é¢˜åœºæ™¯**ï¼š
æƒ³è±¡ä¸‰å®¶åˆ†åº—åŒæ—¶æ¥åˆ°ä¸€ä¸ªåªæœ‰ä¸€ä»¶åº“å­˜çš„å•†å“è®¢å•ï¼Œå¦‚æœä¸åè°ƒï¼Œå¯èƒ½ä¸‰å®¶éƒ½è®¤ä¸ºè‡ªå·±èƒ½å–ï¼Œå°±è¶…å–äº†ã€‚

**åˆ†å¸ƒå¼é”ä½œç”¨**ï¼š
- ğŸš« **é˜²æ­¢é‡å¤æ‰§è¡Œ**ï¼šç¡®ä¿åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªæœåŠ¡åœ¨å¤„ç†
- ğŸ“¦ **åº“å­˜æ‰£å‡**ï¼šé˜²æ­¢è¶…å–
- ğŸ’° **è®¢å•æ”¯ä»˜**ï¼šé¿å…é‡å¤æ”¯ä»˜
- ğŸ”„ **å®šæ—¶ä»»åŠ¡**ï¼šé›†ç¾¤ä¸­åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹æ‰§è¡Œ

### 6.2 ä½¿ç”¨Curatorå®ç°åˆ†å¸ƒå¼é”


**ä¾èµ–å¼•å…¥**ï¼š
```xml
<dependency>
    <groupId>org.apache.curator</groupId>
    <artifactId>curator-recipes</artifactId>
    <version>5.5.0</version>
</dependency>
```

**åŸºç¡€é”å®ç°**ï¼š
```java
@Component
public class DistributedLockService {
    
    @Autowired
    private CuratorFramework curatorFramework;
    
    /**
     * è·å–åˆ†å¸ƒå¼é”
     * @param lockPath é”çš„è·¯å¾„ï¼Œæ¯”å¦‚ /locks/order-123
     */
    public void executeWithLock(String lockPath, Runnable task) {
        // åˆ›å»ºå¯é‡å…¥é”
        InterProcessMutex lock = new InterProcessMutex(
            curatorFramework, lockPath
        );
        
        try {
            // å°è¯•è·å–é”ï¼Œæœ€å¤šç­‰å¾…10ç§’
            if (lock.acquire(10, TimeUnit.SECONDS)) {
                try {
                    // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
                    task.run();
                } finally {
                    // é‡Šæ”¾é”
                    lock.release();
                }
            } else {
                throw new RuntimeException("è·å–é”è¶…æ—¶");
            }
        } catch (Exception e) {
            throw new RuntimeException("åˆ†å¸ƒå¼é”å¼‚å¸¸", e);
        }
    }
}
```

**å®é™…ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
@Service
public class OrderService {
    
    @Autowired
    private DistributedLockService lockService;
    
    public void createOrder(Long productId) {
        String lockPath = "/locks/product-" + productId;
        
        lockService.executeWithLock(lockPath, () -> {
            // è¿™æ®µä»£ç åœ¨æ•´ä¸ªé›†ç¾¤ä¸­åŒä¸€æ—¶åˆ»åªä¼šæœ‰ä¸€ä¸ªå®ä¾‹æ‰§è¡Œ
            
            // 1. æ£€æŸ¥åº“å­˜
            int stock = getStock(productId);
            if (stock <= 0) {
                throw new RuntimeException("åº“å­˜ä¸è¶³");
            }
            
            // 2. æ‰£å‡åº“å­˜
            decreaseStock(productId);
            
            // 3. åˆ›å»ºè®¢å•
            saveOrder(productId);
        });
    }
}
```

**é”çš„å·¥ä½œåŸç†**ï¼š
```
å®ä¾‹1å°è¯•è·å–é”
    |
    v
åœ¨ZKåˆ›å»ºä¸´æ—¶é¡ºåºèŠ‚ç‚¹: /locks/product-1/0001
    |
    v
æ£€æŸ¥è‡ªå·±æ˜¯å¦æ˜¯æœ€å°èŠ‚ç‚¹
    |
    +-- æ˜¯ --> è·å–é”æˆåŠŸï¼Œæ‰§è¡Œä¸šåŠ¡
    |
    +-- å¦ --> ç›‘å¬å‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç­‰å¾…é€šçŸ¥
                    |
                    v
                å‰ä¸€ä¸ªèŠ‚ç‚¹é‡Šæ”¾
                    |
                    v
                æ”¶åˆ°é€šçŸ¥ï¼Œé‡æ–°æ£€æŸ¥
```

### 6.3 é”çš„é«˜çº§ç”¨æ³•


**è¯»å†™é”**ï¼š
```java
// è¯»å†™åˆ†ç¦»çš„åœºæ™¯
InterProcessReadWriteLock rwLock = 
    new InterProcessReadWriteLock(curatorFramework, "/locks/data");

// è¯»é”(å¯ä»¥å¤šä¸ªåŒæ—¶æŒæœ‰)
InterProcessMutex readLock = rwLock.readLock();

// å†™é”(ç‹¬å )
InterProcessMutex writeLock = rwLock.writeLock();
```

**ä¿¡å·é‡(é™æµ)**ï¼š
```java
// é™åˆ¶æœ€å¤š3ä¸ªå¹¶å‘
InterProcessSemaphoreV2 semaphore = 
    new InterProcessSemaphoreV2(curatorFramework, "/locks/semaphore", 3);

Lease lease = semaphore.acquire();  // è·å–ä¸€ä¸ªè®¸å¯
try {
    // ä¸šåŠ¡é€»è¾‘
} finally {
    semaphore.returnLease(lease);  // å½’è¿˜è®¸å¯
}
```

**é”ç±»å‹å¯¹æ¯”**ï¼š

| é”ç±»å‹ | **é€‚ç”¨åœºæ™¯** | **å¹¶å‘åº¦** | **å®ç°å¤æ‚åº¦** |
|-------|------------|-----------|--------------|
| **äº’æ–¥é”** | `ç‹¬å æ“ä½œï¼Œå¦‚æ‰£åº“å­˜` | `1` | `â­ç®€å•` |
| **è¯»å†™é”** | `è¯»å¤šå†™å°‘ï¼Œå¦‚é…ç½®` | `è¯»N/å†™1` | `â­â­ä¸­ç­‰` |
| **ä¿¡å·é‡** | `é™æµæ§åˆ¶` | `å¯é…ç½®` | `â­â­ä¸­ç­‰` |

> âš ï¸ **é”ä½¿ç”¨æ³¨æ„**  
> 1. ä¸€å®šè¦åœ¨finallyä¸­é‡Šæ”¾é”
> 2. è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
> 3. é¿å…é”ç²’åº¦è¿‡å¤§å¯¼è‡´æ€§èƒ½ä¸‹é™

---

## 7. ğŸ“¡ äº‹ä»¶ç›‘å¬æœºåˆ¶


### 7.1 ç›‘å¬å™¨åŸºæœ¬æ¦‚å¿µ


**é€šä¿—è§£é‡Š**ï¼š
ç›‘å¬å™¨å°±åƒæ˜¯ä¸€ä¸ª**å€¼ç­å‘˜**ï¼Œå½“Zookeeperä¸­çš„æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼ˆæ¯”å¦‚æœåŠ¡ä¸Šçº¿ã€ä¸‹çº¿ã€é…ç½®æ›´æ–°ï¼‰ï¼Œå®ƒä¼šç«‹å³é€šçŸ¥ä½ çš„åº”ç”¨ã€‚

**å¸¸è§ç›‘å¬åœºæ™¯**ï¼š
- ğŸ”” **æœåŠ¡ä¸Šä¸‹çº¿**ï¼šåŠæ—¶æ„ŸçŸ¥å…¶ä»–æœåŠ¡çš„çŠ¶æ€å˜åŒ–
- ğŸ“ **é…ç½®å˜æ›´**ï¼šé…ç½®ä¿®æ”¹åç«‹å³ç”Ÿæ•ˆ
- ğŸ‘¥ **é›†ç¾¤æˆå‘˜**ï¼šç›‘æ§é›†ç¾¤èŠ‚ç‚¹å˜åŒ–
- ğŸ” **é”çŠ¶æ€**ï¼šç›‘å¬é”çš„é‡Šæ”¾

### 7.2 å®ç°æœåŠ¡çŠ¶æ€ç›‘å¬


**ç›‘å¬æœåŠ¡å˜åŒ–**ï¼š
```java
@Component
public class ServiceChangeListener implements ApplicationListener<InstanceRegisteredEvent<?>> {
    
    @Autowired
    private DiscoveryClient discoveryClient;
    
    @Override
    public void onApplicationEvent(InstanceRegisteredEvent<?> event) {
        System.out.println("æ–°æœåŠ¡æ³¨å†ŒæˆåŠŸ: " + event.getInstanceInfo());
        
        // è·å–æ‰€æœ‰æœåŠ¡åˆ—è¡¨
        List<String> services = discoveryClient.getServices();
        System.out.println("å½“å‰æ‰€æœ‰æœåŠ¡: " + services);
    }
}
```

**è‡ªå®šä¹‰ç›‘å¬å™¨**ï¼š
```java
@Component
public class ZookeeperWatcherService {
    
    @Autowired
    private CuratorFramework curatorFramework;
    
    @PostConstruct
    public void watchServices() throws Exception {
        String servicePath = "/services/user-service";
        
        // ç›‘å¬å­èŠ‚ç‚¹å˜åŒ–(æœåŠ¡å®ä¾‹çš„å¢å‡)
        PathChildrenCache cache = new PathChildrenCache(
            curatorFramework, servicePath, true
        );
        
        cache.getListenable().addListener((client, event) -> {
            switch (event.getType()) {
                case CHILD_ADDED:
                    System.out.println("æ–°å®ä¾‹ä¸Šçº¿: " + event.getData().getPath());
                    break;
                case CHILD_REMOVED:
                    System.out.println("å®ä¾‹ä¸‹çº¿: " + event.getData().getPath());
                    break;
                case CHILD_UPDATED:
                    System.out.println("å®ä¾‹æ›´æ–°: " + event.getData().getPath());
                    break;
            }
        });
        
        cache.start();
    }
}
```

**äº‹ä»¶æµç¨‹**ï¼š
```
æœåŠ¡å®ä¾‹ä¸Šçº¿
    |
    v
ZKåˆ›å»ºä¸´æ—¶èŠ‚ç‚¹
    |
    v
è§¦å‘CHILD_ADDEDäº‹ä»¶
    |
    v
PathChildrenCacheæ¥æ”¶äº‹ä»¶
    |
    v
è°ƒç”¨ç›‘å¬å™¨å›è°ƒæ–¹æ³•
    |
    v
åº”ç”¨æ‰§è¡Œè‡ªå®šä¹‰é€»è¾‘(å¦‚æ›´æ–°æœ¬åœ°ç¼“å­˜)
```

### 7.3 ç›‘å¬é…ç½®å˜åŒ–


**é…ç½®ç›‘å¬å®ç°**ï¼š
```java
@Component
public class ConfigWatcherService {
    
    @Autowired
    private CuratorFramework curatorFramework;
    
    @PostConstruct
    public void watchConfig() throws Exception {
        String configPath = "/config/user-service/maxUsers";
        
        // ç›‘å¬èŠ‚ç‚¹æ•°æ®å˜åŒ–
        NodeCache cache = new NodeCache(curatorFramework, configPath);
        
        cache.getListenable().addListener(() -> {
            ChildData data = cache.getCurrentData();
            if (data != null) {
                String newValue = new String(data.getData());
                System.out.println("é…ç½®æ›´æ–°: " + configPath + " = " + newValue);
                
                // è¿™é‡Œå¯ä»¥åšä¸€äº›ä¸šåŠ¡å¤„ç†
                handleConfigChange(newValue);
            }
        });
        
        cache.start();
    }
    
    private void handleConfigChange(String newValue) {
        // æ¯”å¦‚æ›´æ–°é™æµé˜ˆå€¼ã€åˆ·æ–°ç¼“å­˜ç­‰
        System.out.println("åº”ç”¨æ–°é…ç½®: " + newValue);
    }
}
```

> ğŸ’¡ **ç›‘å¬å™¨é€‰æ‹©**  
> - `PathChildrenCache`ï¼šç›‘å¬å­èŠ‚ç‚¹å˜åŒ–ï¼ˆæœåŠ¡å®ä¾‹åˆ—è¡¨ï¼‰
> - `NodeCache`ï¼šç›‘å¬èŠ‚ç‚¹æ•°æ®å˜åŒ–ï¼ˆé…ç½®å€¼ï¼‰
> - `TreeCache`ï¼šç›‘å¬æ•´ä¸ªæ ‘çš„å˜åŒ–ï¼ˆå…¨é‡ç›‘æ§ï¼‰

### 7.4 äº‹ä»¶ç›‘å¬æœ€ä½³å®è·µ


**æ€§èƒ½ä¼˜åŒ–å»ºè®®**ï¼š

| å®è·µ | **è¯´æ˜** | **é¿å…çš„é—®é¢˜** |
|------|---------|--------------|
| **å¼‚æ­¥å¤„ç†** | `å›è°ƒä¸­ä½¿ç”¨çº¿ç¨‹æ± å¤„ç†` | `é˜»å¡ZKå®¢æˆ·ç«¯çº¿ç¨‹` |
| **å¼‚å¸¸æ•è·** | `å›è°ƒä¸­æ•è·æ‰€æœ‰å¼‚å¸¸` | `ä¸€ä¸ªå¼‚å¸¸å¯¼è‡´æ•´ä¸ªç›‘å¬å¤±æ•ˆ` |
| **èµ„æºé‡Šæ”¾** | `åº”ç”¨å…³é—­æ—¶åœæ­¢ç›‘å¬` | `å†…å­˜æ³„æ¼` |
| **é¿å…é€’å½’** | `ç›‘å¬å›è°ƒä¸­ä¸è¦ä¿®æ”¹ç›‘å¬çš„èŠ‚ç‚¹` | `æ— é™å¾ªç¯é€šçŸ¥` |

**ä¼˜é›…å…³é—­ç¤ºä¾‹**ï¼š
```java
@Component
public class ZookeeperListenerManager {
    
    private List<Closeable> caches = new ArrayList<>();
    
    public void addCache(Closeable cache) {
        caches.add(cache);
    }
    
    @PreDestroy
    public void cleanup() {
        caches.forEach(cache -> {
            try {
                cache.close();
            } catch (Exception e) {
                // è®°å½•æ—¥å¿—
            }
        });
    }
}
```

---

## 8. ğŸ”— ä¸å…¶ä»–ç»„ä»¶é›†æˆ


### 8.1 ä¸Spring Cloud Gatewayé›†æˆ


**ç½‘å…³é…ç½®**ï¼š
```yaml
spring:
  cloud:
    gateway:
      discovery:
        locator:
          enabled: true  # å¼€å¯æœåŠ¡å‘ç°è·¯ç”±
          lower-case-service-id: true  # æœåŠ¡åå°å†™
      routes:
        - id: user-service-route
          uri: lb://user-service  # lbè¡¨ç¤ºè´Ÿè½½å‡è¡¡
          predicates:
            - Path=/user/**
```

**è®¿é—®æµç¨‹**ï¼š
```
å®¢æˆ·ç«¯è¯·æ±‚: http://gateway:8080/user/api/users/1
    |
    v
Gatewayè§£æè·¯å¾„: /user/**
    |
    v
åŒ¹é…è·¯ç”±è§„åˆ™: user-service-route
    |
    v
ä»ZKæŸ¥è¯¢user-serviceå®ä¾‹
    |
    v
è´Ÿè½½å‡è¡¡é€‰æ‹©å®ä¾‹: localhost:8081
    |
    v
è½¬å‘è¯·æ±‚: http://localhost:8081/api/users/1
```

> ğŸ’¡ **è·¯ç”±é…ç½®æŠ€å·§**  
> `lb://`åè®®è®©Gatewayè‡ªåŠ¨ä»æ³¨å†Œä¸­å¿ƒè·å–æœåŠ¡å®ä¾‹ï¼Œæ— éœ€ç¡¬ç¼–ç IPåœ°å€ã€‚

### 8.2 ä¸Spring Cloud Sleuthé›†æˆ


**é“¾è·¯è¿½è¸ªé…ç½®**ï¼š
```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-sleuth</artifactId>
</dependency>
```

```yaml
spring:
  sleuth:
    sampler:
      probability: 1.0  # é‡‡æ ·ç‡100%
```

**è¿½è¸ªæ•ˆæœ**ï¼š
```
[user-service,a1b2c3d4,a1b2c3d4,true] æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
[order-service,a1b2c3d4,e5f6g7h8,true] åˆ›å»ºè®¢å•
[payment-service,a1b2c3d4,i9j0k1l2,true] æ‰§è¡Œæ”¯ä»˜

traceId: a1b2c3d4 (è´¯ç©¿æ•´ä¸ªè°ƒç”¨é“¾)
spanId: å„è‡ªä¸åŒ (æ ‡è¯†æ¯ä¸ªæœåŠ¡)
```

### 8.3 ä¸é…ç½®ä¸­å¿ƒApolloå¯¹æ¯”


**åŠŸèƒ½å¯¹æ¯”**ï¼š

| ç‰¹æ€§ | **Zookeeper** | **Apollo** | **é€‰æ‹©å»ºè®®** |
|------|--------------|-----------|------------|
| **ç•Œé¢ç®¡ç†** | `éœ€è¦ç¬¬ä¸‰æ–¹å·¥å…·` | `âœ“ è‡ªå¸¦Webç•Œé¢` | `é‡UIæ“ä½œé€‰Apollo` |
| **é…ç½®å†å²** | `éœ€è¦è‡ªå·±å®ç°` | `âœ“ å®Œæ•´çš„ç‰ˆæœ¬ç®¡ç†` | `éœ€è¦å®¡è®¡é€‰Apollo` |
| **é…ç½®æ ¼å¼** | `ä»»æ„æ ¼å¼` | `properties/yml/json` | `éƒ½æ”¯æŒ` |
| **å®æ—¶æ¨é€** | `âœ“ Watcheræœºåˆ¶` | `âœ“ é•¿è½®è¯¢` | `éƒ½æ”¯æŒ` |
| **è¿ç»´æˆæœ¬** | `ä¸­ç­‰` | `è¾ƒé«˜(ç‹¬ç«‹éƒ¨ç½²)` | `å›¢é˜Ÿè§„æ¨¡å†³å®š` |

**æ··åˆä½¿ç”¨æ–¹æ¡ˆ**ï¼š
```
æœåŠ¡æ³¨å†Œå‘ç° â†’ Zookeeper (é«˜å¯ç”¨ã€å¼ºä¸€è‡´)
       +
é…ç½®ç®¡ç† â†’ Apollo (ç‰ˆæœ¬ç®¡ç†ã€ç•Œé¢å‹å¥½)
```

### 8.4 é›†æˆæ€»ç»“


**æ¨èç»„åˆæ–¹æ¡ˆ**ï¼š

```
å¾®æœåŠ¡åŸºç¡€è®¾æ–½æŠ€æœ¯æ ˆ
â”œâ”€â”€ æœåŠ¡æ³¨å†Œå‘ç°: Spring Cloud Zookeeper
â”œâ”€â”€ é…ç½®ç®¡ç†: Zookeeper / Apollo (æŒ‰éœ€é€‰æ‹©)
â”œâ”€â”€ APIç½‘å…³: Spring Cloud Gateway
â”œâ”€â”€ è´Ÿè½½å‡è¡¡: Spring Cloud LoadBalancer
â”œâ”€â”€ é“¾è·¯è¿½è¸ª: Sleuth + Zipkin
â”œâ”€â”€ ç†”æ–­é™çº§: Resilience4j
â””â”€â”€ åˆ†å¸ƒå¼é”: Curator
```

---

## 9. ğŸ’¡ æœ€ä½³å®è·µå»ºè®®


### 9.1 é«˜å¯ç”¨éƒ¨ç½²æ–¹æ¡ˆ


**Zookeeperé›†ç¾¤é…ç½®**ï¼š
```
ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®ï¼š
â”œâ”€â”€ èŠ‚ç‚¹æ•°é‡: è‡³å°‘3ä¸ª(å¥‡æ•°)
â”œâ”€â”€ æœºå™¨é…ç½®: 4æ ¸8Gèµ·æ­¥
â”œâ”€â”€ ç£ç›˜: SSD(äº‹åŠ¡æ—¥å¿—)
â””â”€â”€ ç½‘ç»œ: ä½å»¶è¿Ÿå†…ç½‘

é›†ç¾¤éƒ¨ç½²ç¤ºä¾‹ï¼š
zk1: 192.168.1.101:2181
zk2: 192.168.1.102:2181  
zk3: 192.168.1.103:2181
```

**æœåŠ¡ç«¯é…ç½®**ï¼š
```yaml
spring:
  cloud:
    zookeeper:
      # é›†ç¾¤åœ°å€
      connect-string: 192.168.1.101:2181,192.168.1.102:2181,192.168.1.103:2181
      # ä¼šè¯è¶…æ—¶
      session-timeout: 30000
      # è¿æ¥è¶…æ—¶  
      connection-timeout: 15000
```

**é«˜å¯ç”¨è¦ç‚¹**ï¼š

| å®è·µ | **é…ç½®** | **ä½œç”¨** |
|------|---------|---------|
| **å¤šèŠ‚ç‚¹éƒ¨ç½²** | `3/5/7ä¸ªZKèŠ‚ç‚¹` | `å®¹å¿(n-1)/2ä¸ªèŠ‚ç‚¹æ•…éšœ` |
| **åˆç†è¶…æ—¶** | `session-timeout: 30s` | `é¿å…ç½‘ç»œæŠ–åŠ¨å¯¼è‡´è¯¯åˆ¤` |
| **å¥åº·æ£€æŸ¥** | `å¯ç”¨Actuator` | `åŠæ—¶å‘ç°æœåŠ¡å¼‚å¸¸` |
| **ä¼˜é›…ä¸‹çº¿** | `æ³¨å†Œshutdown hook` | `ä¸»åŠ¨æ³¨é”€æœåŠ¡` |

### 9.2 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


**å®¢æˆ·ç«¯ä¼˜åŒ–**ï¼š
```java
@Configuration
public class ZookeeperConfig {
    
    @Bean
    public CuratorFramework curatorFramework() {
        RetryPolicy retryPolicy = new ExponentialBackoffRetry(
            1000,  // åˆå§‹é‡è¯•é—´éš”
            3      // æœ€å¤§é‡è¯•æ¬¡æ•°
        );
        
        return CuratorFrameworkFactory.builder()
            .connectString("localhost:2181")
            .sessionTimeoutMs(30000)
            .connectionTimeoutMs(15000)
            .retryPolicy(retryPolicy)
            // å‘½åç©ºé—´éš”ç¦»
            .namespace("myapp")
            .build();
    }
}
```

**æ€§èƒ½ä¼˜åŒ–æ¸…å•**ï¼š
- âœ… ä½¿ç”¨è¿æ¥æ± å¤ç”¨è¿æ¥
- âœ… æ‰¹é‡æ“ä½œå‡å°‘ç½‘ç»œå¾€è¿”
- âœ… åˆç†è®¾ç½®ç¼“å­˜é¿å…é¢‘ç¹æŸ¥è¯¢ZK
- âœ… å¼‚æ­¥å¤„ç†ç›‘å¬å™¨å›è°ƒ
- âœ… å‹ç¼©å¤§æ•°æ®èŠ‚ç‚¹

> âš ï¸ **æ€§èƒ½ç“¶é¢ˆè­¦å‘Š**  
> Zookeeperä¸é€‚åˆå­˜å‚¨å¤§é‡æ•°æ®ï¼Œå•ä¸ªèŠ‚ç‚¹å»ºè®®ä¸è¶…è¿‡1MBã€‚

### 9.3 å®‰å…¨é…ç½®å»ºè®®


**ACLæƒé™æ§åˆ¶**ï¼š
```java
// è®¾ç½®èŠ‚ç‚¹æƒé™
List<ACL> acls = new ArrayList<>();
acls.add(new ACL(ZooDefs.Perms.ALL, 
    new Id("digest", DigestAuthenticationProvider.generateDigest("admin:password"))));

curatorFramework.create()
    .withACL(acls)
    .forPath("/secure-config", data);
```

**å®‰å…¨æ£€æŸ¥æ¸…å•**ï¼š
- ğŸ” å¯ç”¨ZKçš„SASLè®¤è¯
- ğŸš« é™åˆ¶ç½‘ç»œè®¿é—®(é˜²ç«å¢™è§„åˆ™)
- ğŸ“ å®šæœŸå®¡è®¡æ“ä½œæ—¥å¿—
- ğŸ”‘ å¯†ç ä½¿ç”¨å¼ºåŠ å¯†å­˜å‚¨
- âœ… ç”Ÿäº§ç¯å¢ƒç¦ç”¨åŒ¿åè®¿é—®

### 9.4 ç›‘æ§å‘Šè­¦æ–¹æ¡ˆ


**å…³é”®ç›‘æ§æŒ‡æ ‡**ï¼š

| æŒ‡æ ‡ç±»å‹ | **ç›‘æ§é¡¹** | **å‘Šè­¦é˜ˆå€¼** |
|---------|-----------|------------|
| **æœåŠ¡å¥åº·** | `æ³¨å†ŒæœåŠ¡æ•°é‡` | `ä½äºé¢„æœŸå€¼` |
| **ZKæ€§èƒ½** | `å¹³å‡å“åº”æ—¶é—´` | `>100ms` |
| **è¿æ¥çŠ¶æ€** | `ä¼šè¯è¶…æ—¶æ¬¡æ•°` | `>10æ¬¡/å°æ—¶` |
| **èŠ‚ç‚¹æ•°é‡** | `ä¸´æ—¶èŠ‚ç‚¹æ•°` | `å¼‚å¸¸å¢é•¿` |

**ç›‘æ§å®ç°**ï¼š
```java
@Component
public class ZookeeperMetrics {
    
    @Autowired
    private CuratorFramework curatorFramework;
    
    @Scheduled(fixedRate = 60000)  // æ¯åˆ†é’Ÿæ£€æŸ¥
    public void checkHealth() {
        try {
            // æ£€æŸ¥è¿æ¥çŠ¶æ€
            CuratorFrameworkState state = curatorFramework.getState();
            
            // è·å–æœåŠ¡æ•°é‡
            int serviceCount = curatorFramework
                .getChildren()
                .forPath("/services")
                .size();
            
            // ä¸ŠæŠ¥æŒ‡æ ‡(å¦‚Prometheus)
            Metrics.gauge("zk.service.count", serviceCount);
            
        } catch (Exception e) {
            // å‘Šè­¦å¤„ç†
        }
    }
}
```

### 9.5 å¼€å‘è°ƒè¯•æŠ€å·§


**æœ¬åœ°å¼€å‘é…ç½®**ï¼š
```yaml
spring:
  profiles:
    active: dev
  
---
spring:
  config:
    activate:
      on-profile: dev
  cloud:
    zookeeper:
      enabled: true
      connect-string: localhost:2181  # æœ¬åœ°ZK
      
---
spring:
  config:
    activate:
      on-profile: prod
  cloud:
    zookeeper:
      enabled: true
      connect-string: zk-cluster.prod:2181  # ç”Ÿäº§é›†ç¾¤
```

**è°ƒè¯•å·¥å…·æ¨è**ï¼š
- ğŸ› ï¸ **ZooInspector**ï¼šå¯è§†åŒ–ZKæ ‘ç»“æ„
- ğŸ“Š **zkCli**ï¼šå‘½ä»¤è¡Œå®¢æˆ·ç«¯
- ğŸ” **PrettyZoo**ï¼šç°ä»£åŒ–çš„ZKç®¡ç†å·¥å…·

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å…³é”®çŸ¥è¯†ç‚¹å›é¡¾


> ğŸ¯ **Spring Cloud Zookeeperæ ¸å¿ƒæ¦‚å¿µ**  
> 
> 1. **æœåŠ¡æ³¨å†Œ**ï¼šæœåŠ¡å¯åŠ¨æ—¶è‡ªåŠ¨åœ¨ZKåˆ›å»ºä¸´æ—¶èŠ‚ç‚¹
> 2. **æœåŠ¡å‘ç°**ï¼šé€šè¿‡æœåŠ¡åä»ZKæŸ¥è¯¢å¯ç”¨å®ä¾‹åˆ—è¡¨
> 3. **é…ç½®ç®¡ç†**ï¼šé›†ä¸­å­˜å‚¨é…ç½®ï¼Œæ”¯æŒåŠ¨æ€åˆ·æ–°
> 4. **åˆ†å¸ƒå¼åè°ƒ**ï¼šæä¾›åˆ†å¸ƒå¼é”ã€é€‰ä¸¾ç­‰åŠŸèƒ½

### 10.2 æŠ€æœ¯é€‰å‹å¯¹æ¯”


**ä¸å…¶ä»–æ³¨å†Œä¸­å¿ƒå¯¹æ¯”**ï¼š

| å¯¹æ¯”é¡¹ | **Zookeeper** | **Eureka** | **Consul** | **Nacos** |
|-------|--------------|-----------|-----------|----------|
| **ä¸€è‡´æ€§æ¨¡å‹** | `CP(å¼ºä¸€è‡´)` | `AP(é«˜å¯ç”¨)` | `CP` | `CP+APå¯é€‰` |
| **å¥åº·æ£€æŸ¥** | `å¿ƒè·³+ä¸´æ—¶èŠ‚ç‚¹` | `å¿ƒè·³` | `å¤šç§æ–¹å¼` | `å¤šç§æ–¹å¼` |
| **é…ç½®ç®¡ç†** | `âœ“æ”¯æŒ` | `âœ—ä¸æ”¯æŒ` | `âœ“æ”¯æŒ` | `âœ“æ”¯æŒ` |
| **å¤šæ•°æ®ä¸­å¿ƒ** | `âœ—ä¸æ”¯æŒ` | `âœ—ä¸æ”¯æŒ` | `âœ“æ”¯æŒ` | `âœ“æ”¯æŒ` |
| **å­¦ä¹ æˆæœ¬** | `â­â­â­ä¸­` | `â­â­ä½` | `â­â­â­ä¸­` | `â­â­ä½` |

### 10.3 é€‚ç”¨åœºæ™¯å»ºè®®


**é€‰æ‹©Zookeeperçš„åœºæ™¯**ï¼š
- âœ… å¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚ä¸¥æ ¼
- âœ… å·²æœ‰ZKåŸºç¡€è®¾æ–½
- âœ… éœ€è¦åˆ†å¸ƒå¼åè°ƒåŠŸèƒ½
- âœ… å›¢é˜Ÿç†Ÿæ‚‰ZKè¿ç»´

**ä¸å»ºè®®ä½¿ç”¨çš„åœºæ™¯**ï¼š
- âŒ æœåŠ¡æ•°é‡è¶…å¤§(>10000)
- âŒ å¯¹å¯ç”¨æ€§è¦æ±‚æé«˜
- âŒ å›¢é˜Ÿç¼ºä¹ZKè¿ç»´ç»éªŒ
- âŒ éœ€è¦é¢‘ç¹å¤§é‡è¯»å–

### 10.4 å­¦ä¹ è·¯å¾„å»ºè®®


**æ–°æ‰‹å­¦ä¹ é¡ºåº**ï¼š
```
ç¬¬ä¸€æ­¥: ç†è§£æœåŠ¡æ³¨å†Œå‘ç°æ¦‚å¿µ
    â†“
ç¬¬äºŒæ­¥: æ­å»ºå•æœºZKç¯å¢ƒ
    â†“
ç¬¬ä¸‰æ­¥: å®ç°ç®€å•çš„æœåŠ¡æ³¨å†Œ
    â†“
ç¬¬å››æ­¥: æŒæ¡æœåŠ¡å‘ç°è°ƒç”¨
    â†“
ç¬¬äº”æ­¥: å­¦ä¹ é…ç½®ç®¡ç†
    â†“
ç¬¬å…­æ­¥: äº†è§£åˆ†å¸ƒå¼é”
    â†“
ç¬¬ä¸ƒæ­¥: ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
```

### 10.5 å®æˆ˜ç»éªŒæ€»ç»“


**å¸¸è§é—®é¢˜ä¸è§£å†³**ï¼š

| é—®é¢˜ | **åŸå› ** | **è§£å†³æ–¹æ¡ˆ** |
|------|---------|------------|
| `æœåŠ¡æ³¨å†Œå¤±è´¥` | `ZKè¿æ¥ä¸ä¸Š` | `æ£€æŸ¥ç½‘ç»œå’ŒZKçŠ¶æ€` |
| `æœåŠ¡è°ƒç”¨404` | `æœåŠ¡åå†™é”™` | `ç¡®è®¤@FeignClientçš„name` |
| `é…ç½®ä¸ç”Ÿæ•ˆ` | `æœªåŠ @RefreshScope` | `æ·»åŠ æ³¨è§£å¹¶é‡å¯` |
| `é”è·å–è¶…æ—¶` | `ä¸šåŠ¡æ‰§è¡Œå¤ªæ…¢` | `ä¼˜åŒ–ä¸šåŠ¡æˆ–å¢å¤§è¶…æ—¶` |

> ğŸ’¡ **å­¦ä¹ å»ºè®®**  
> 
> 1. å…ˆåœ¨æœ¬åœ°æ­å»ºç¯å¢ƒå®è·µ
> 2. å¤šçœ‹æ—¥å¿—ç†è§£è¿è¡Œæµç¨‹
> 3. å¯¹æ¯”ä¸åŒæ³¨å†Œä¸­å¿ƒçš„å·®å¼‚
> 4. å…³æ³¨ç¤¾åŒºæœ€ä½³å®è·µ

### 10.6 è¿›é˜¶å­¦ä¹ æ–¹å‘


**æ·±å…¥å­¦ä¹ ä¸»é¢˜**ï¼š
- ğŸ”¬ ZKçš„ZABåè®®åŸç†
- ğŸ—ï¸ å¤§è§„æ¨¡é›†ç¾¤ä¼˜åŒ–æ–¹æ¡ˆ
- ğŸ” ä¼ä¸šçº§å®‰å…¨åŠ å›º
- ğŸ“Š ç›‘æ§å‘Šè­¦ä½“ç³»å»ºè®¾
- ğŸš€ äº‘åŸç”Ÿç¯å¢ƒä¸‹çš„å®è·µ

**æ¨èèµ„æº**ï¼š
- ğŸ“– å®˜æ–¹æ–‡æ¡£ï¼š[Spring Cloud Zookeeper Reference](https://docs.spring.io/spring-cloud-zookeeper/docs/current/reference/html/)
- ğŸ¥ è§†é¢‘æ•™ç¨‹ï¼šæœç´¢"Spring Cloudå¾®æœåŠ¡å®æˆ˜"
- ğŸ’¬ ç¤¾åŒºäº¤æµï¼šSpring Cloudä¸­æ–‡ç¤¾åŒº

---

**ğŸ“ å­¦ä¹ è¦ç‚¹è®°å¿†**ï¼š
- Zookeeperæ˜¯CPæ¨¡å‹ï¼Œå¼ºè°ƒä¸€è‡´æ€§
- æœåŠ¡æ³¨å†Œç”¨ä¸´æ—¶èŠ‚ç‚¹ï¼Œè‡ªåŠ¨æ„ŸçŸ¥ä¸‹çº¿
- é…ç½®ä¸­å¿ƒéœ€è¦@RefreshScopeæ‰èƒ½åŠ¨æ€åˆ·æ–°
- åˆ†å¸ƒå¼é”åŠ¡å¿…åœ¨finallyä¸­é‡Šæ”¾
- ç”Ÿäº§ç¯å¢ƒè‡³å°‘3ä¸ªZKèŠ‚ç‚¹ä¿è¯é«˜å¯ç”¨