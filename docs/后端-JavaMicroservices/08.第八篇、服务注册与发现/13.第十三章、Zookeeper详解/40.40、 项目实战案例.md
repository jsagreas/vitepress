---
title: 40ã€ é¡¹ç›®å®æˆ˜æ¡ˆä¾‹
---
## ğŸ“š ç›®å½•

1. [åˆ†å¸ƒå¼é”å®æˆ˜æ¡ˆä¾‹](#1-åˆ†å¸ƒå¼é”å®æˆ˜æ¡ˆä¾‹)
2. [æœåŠ¡æ³¨å†Œä¸­å¿ƒå®ç°](#2-æœåŠ¡æ³¨å†Œä¸­å¿ƒå®ç°)
3. [é…ç½®ä¸­å¿ƒå®ç°](#3-é…ç½®ä¸­å¿ƒå®ç°)
4. [å¾®æœåŠ¡æ³¨å†Œä¸­å¿ƒæ–¹æ¡ˆ](#4-å¾®æœåŠ¡æ³¨å†Œä¸­å¿ƒæ–¹æ¡ˆ)
5. [å®é™…é¡¹ç›®åº”ç”¨åœºæ™¯](#5-å®é™…é¡¹ç›®åº”ç”¨åœºæ™¯)
6. [æ¶æ„è®¾è®¡æœ€ä½³å®è·µ](#6-æ¶æ„è®¾è®¡æœ€ä½³å®è·µ)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”’ åˆ†å¸ƒå¼é”å®æˆ˜æ¡ˆä¾‹


### 1.1 ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼é”


> ğŸ’¡ **é€šä¿—ç†è§£**ï¼šæƒ³è±¡ä¸€ä¸ªå…±äº«çš„å•æ‰€ï¼ŒåŒä¸€æ—¶é—´åªèƒ½ä¸€ä¸ªäººä½¿ç”¨ã€‚åˆ†å¸ƒå¼é”å°±åƒè¿™ä¸ªé—¨é”ï¼Œç¡®ä¿å¤šä¸ªæœåŠ¡å™¨ä¸­åªæœ‰ä¸€ä¸ªèƒ½æ‰§è¡ŒæŸä¸ªæ“ä½œã€‚

**ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”**ï¼š
- å•æœºç¯å¢ƒï¼šç”¨Javaçš„`synchronized`æˆ–`ReentrantLock`å°±å¤Ÿäº†
- åˆ†å¸ƒå¼ç¯å¢ƒï¼šå¤šå°æœåŠ¡å™¨ï¼Œè¿™äº›é”å°±ä¸ç®¡ç”¨äº†
- å…¸å‹åœºæ™¯ï¼šç§’æ€æ´»åŠ¨ã€åº“å­˜æ‰£å‡ã€è®¢å•å·ç”Ÿæˆ

### 1.2 Zookeeperå®ç°åˆ†å¸ƒå¼é”åŸç†


**æ ¸å¿ƒæ€æƒ³**ï¼šåˆ©ç”¨Zookeeperçš„**ä¸´æ—¶é¡ºåºèŠ‚ç‚¹**ç‰¹æ€§

```
åˆ†å¸ƒå¼é”åŸç†å›¾ç¤ºï¼š

æœåŠ¡å™¨A          æœåŠ¡å™¨B          æœåŠ¡å™¨C
   |                |                |
   |----åˆ›å»ºèŠ‚ç‚¹---->|                |
   |  /lock/0001    |                |
   |                |----åˆ›å»ºèŠ‚ç‚¹---->|
   |                |  /lock/0002    |
   |                |                |----åˆ›å»ºèŠ‚ç‚¹---->
   |                |                |  /lock/0003
   |                |                |
   â–¼                â–¼                â–¼
åºå·æœ€å°è·å¾—é”    ç›‘å¬å‰ä¸€ä¸ªèŠ‚ç‚¹    ç›‘å¬å‰ä¸€ä¸ªèŠ‚ç‚¹
```

**å·¥ä½œæµç¨‹ï¼ˆè¯´äººè¯ç‰ˆï¼‰**ï¼š
1. **æŠ¢é”**ï¼šæ¯ä¸ªæœåŠ¡å™¨åˆ°`/locks`ç›®å½•ä¸‹åˆ›å»ºä¸´æ—¶é¡ºåºèŠ‚ç‚¹
2. **åˆ¤æ–­**ï¼šçœ‹çœ‹è‡ªå·±çš„åºå·æ˜¯ä¸æ˜¯æœ€å°çš„
3. **è·å¾—é”**ï¼šåºå·æœ€å°çš„è·å¾—é”ï¼Œå¼€å§‹å¹²æ´»
4. **ç­‰å¾…**ï¼šåºå·ä¸æ˜¯æœ€å°çš„ï¼Œç›‘å¬æ¯”è‡ªå·±å°ä¸€å·çš„èŠ‚ç‚¹
5. **é‡Šæ”¾é”**ï¼šå¹²å®Œæ´»åˆ é™¤è‡ªå·±çš„èŠ‚ç‚¹ï¼Œä¸‹ä¸€ä¸ªè‡ªåŠ¨è·å¾—é”

### 1.3 åˆ†å¸ƒå¼é”Demoå®ç°


**åœºæ™¯ï¼šåº“å­˜æ‰£å‡**ï¼ˆç”µå•†ç§’æ€æœ€å¸¸è§ï¼‰

```java
public class DistributedLock {
    private ZooKeeper zk;
    private String lockPath = "/distributed-lock";
    private String currentNode; // å½“å‰åˆ›å»ºçš„èŠ‚ç‚¹
    
    // åŠ é”æ“ä½œ
    public boolean lock() throws Exception {
        // 1. åˆ›å»ºä¸´æ—¶é¡ºåºèŠ‚ç‚¹
        currentNode = zk.create(
            lockPath + "/lock-", 
            null, 
            ZooDefs.Ids.OPEN_ACL_UNSAFE,
            CreateMode.EPHEMERAL_SEQUENTIAL
        );
        
        // 2. è·å–æ‰€æœ‰å­èŠ‚ç‚¹å¹¶æ’åº
        List<String> children = zk.getChildren(lockPath, false);
        Collections.sort(children);
        
        // 3. åˆ¤æ–­æ˜¯å¦æ˜¯æœ€å°èŠ‚ç‚¹
        String smallest = children.get(0);
        if (currentNode.endsWith(smallest)) {
            return true; // è·å¾—é”
        }
        
        // 4. ç›‘å¬å‰ä¸€ä¸ªèŠ‚ç‚¹
        String prevNode = null;
        for (int i = 0; i < children.size(); i++) {
            if (currentNode.endsWith(children.get(i))) {
                prevNode = children.get(i - 1);
                break;
            }
        }
        
        // ç­‰å¾…å‰ä¸€ä¸ªèŠ‚ç‚¹åˆ é™¤
        CountDownLatch latch = new CountDownLatch(1);
        zk.exists(lockPath + "/" + prevNode, event -> {
            if (event.getType() == Watcher.Event.EventType.NodeDeleted) {
                latch.countDown();
            }
        });
        latch.await();
        return true;
    }
    
    // è§£é”æ“ä½œ
    public void unlock() throws Exception {
        zk.delete(currentNode, -1);
    }
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
// åº“å­˜æ‰£å‡ä¸šåŠ¡
public void reduceStock(String productId) {
    DistributedLock lock = new DistributedLock(zk);
    try {
        lock.lock(); // åŠ é”
        
        // æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
        int stock = getStock(productId);
        if (stock > 0) {
            stock--;
            updateStock(productId, stock);
            System.out.println("åº“å­˜æ‰£å‡æˆåŠŸï¼Œå‰©ä½™ï¼š" + stock);
        }
        
    } finally {
        lock.unlock(); // é‡Šæ”¾é”
    }
}
```

### 1.4 åˆ†å¸ƒå¼é”çš„å…³é”®é—®é¢˜


> âš ï¸ **æ³¨æ„äº‹é¡¹**ï¼šå®é™…ä½¿ç”¨æ—¶è¦è€ƒè™‘è¿™äº›é—®é¢˜

| é—®é¢˜ç±»å‹ | è¯´æ˜ | è§£å†³æ–¹æ¡ˆ |
|---------|------|---------|
| **æ­»é”é—®é¢˜** | å®¢æˆ·ç«¯å®•æœºï¼Œé”æ°¸ä¸é‡Šæ”¾ | ä½¿ç”¨ä¸´æ—¶èŠ‚ç‚¹ï¼Œè¿æ¥æ–­å¼€è‡ªåŠ¨åˆ é™¤ |
| **æƒŠç¾¤æ•ˆåº”** | å¤§é‡å®¢æˆ·ç«¯åŒæ—¶ç›‘å¬åŒä¸€èŠ‚ç‚¹ | åªç›‘å¬å‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œé“¾å¼å”¤é†’ |
| **é”è¶…æ—¶** | ä¸šåŠ¡æ‰§è¡Œæ—¶é—´è¿‡é•¿ | è®¾ç½®åˆç†çš„Sessionè¶…æ—¶æ—¶é—´ |
| **å¯é‡å…¥æ€§** | åŒä¸€çº¿ç¨‹é‡å¤è·å–é” | è®°å½•é”æŒæœ‰è€…ä¿¡æ¯åˆ°èŠ‚ç‚¹æ•°æ® |

---

## 2. ğŸ“¡ æœåŠ¡æ³¨å†Œä¸­å¿ƒå®ç°


### 2.1 ä»€ä¹ˆæ˜¯æœåŠ¡æ³¨å†Œä¸­å¿ƒ


> ğŸ’¡ **ç”Ÿæ´»ç±»æ¯”**ï¼šå°±åƒç”µè¯ç°¿ï¼Œæ¯ä¸ªæœåŠ¡å¯åŠ¨æ—¶æŠŠè‡ªå·±çš„"ç”µè¯å·ç "ï¼ˆIP+ç«¯å£ï¼‰ç™»è®°ä¸Šå»ï¼Œå…¶ä»–æœåŠ¡è¦è°ƒç”¨æ—¶æ¥æŸ¥è¯¢ã€‚

**æ ¸å¿ƒä½œç”¨**ï¼š
- **æœåŠ¡æ³¨å†Œ**ï¼šæœåŠ¡å¯åŠ¨æ—¶ä¸»åŠ¨æŠ¥å‘Šè‡ªå·±çš„åœ°å€
- **æœåŠ¡å‘ç°**ï¼šå®¢æˆ·ç«¯æŸ¥è¯¢å¯ç”¨çš„æœåŠ¡å®ä¾‹
- **å¥åº·æ£€æŸ¥**ï¼šè‡ªåŠ¨å‰”é™¤å®•æœºçš„æœåŠ¡

### 2.2 Zookeeperå®ç°æœåŠ¡æ³¨å†ŒåŸç†


**èŠ‚ç‚¹ç»“æ„è®¾è®¡**ï¼š
```
/servicesï¼ˆæŒä¹…èŠ‚ç‚¹ï¼‰
  â”œâ”€â”€ /user-serviceï¼ˆæŒä¹…èŠ‚ç‚¹ - æœåŠ¡åï¼‰
  â”‚   â”œâ”€â”€ /192.168.1.10:8080ï¼ˆä¸´æ—¶èŠ‚ç‚¹ - å®ä¾‹1ï¼‰
  â”‚   â”œâ”€â”€ /192.168.1.11:8080ï¼ˆä¸´æ—¶èŠ‚ç‚¹ - å®ä¾‹2ï¼‰
  â”‚   â””â”€â”€ /192.168.1.12:8080ï¼ˆä¸´æ—¶èŠ‚ç‚¹ - å®ä¾‹3ï¼‰
  â”‚
  â””â”€â”€ /order-serviceï¼ˆæŒä¹…èŠ‚ç‚¹ï¼‰
      â”œâ”€â”€ /192.168.1.20:9090ï¼ˆä¸´æ—¶èŠ‚ç‚¹ï¼‰
      â””â”€â”€ /192.168.1.21:9090ï¼ˆä¸´æ—¶èŠ‚ç‚¹ï¼‰
```

**ä¸ºä»€ä¹ˆç”¨ä¸´æ—¶èŠ‚ç‚¹**ï¼š
- æœåŠ¡å®•æœº â†’ ZKè¿æ¥æ–­å¼€ â†’ ä¸´æ—¶èŠ‚ç‚¹è‡ªåŠ¨åˆ é™¤
- å…¶ä»–æœåŠ¡ç›‘å¬åˆ°å˜åŒ– â†’ è‡ªåŠ¨æ›´æ–°æœåŠ¡åˆ—è¡¨

### 2.3 æœåŠ¡æ³¨å†Œä¸­å¿ƒDemo


**æœåŠ¡æ³¨å†Œä»£ç **ï¼š
```java
public class ServiceRegistry {
    private ZooKeeper zk;
    private String serviceName;
    private String serviceAddress;
    
    // æ³¨å†ŒæœåŠ¡
    public void register() throws Exception {
        // 1. ç¡®ä¿æœåŠ¡æ ¹èŠ‚ç‚¹å­˜åœ¨
        String servicePath = "/services/" + serviceName;
        if (zk.exists(servicePath, false) == null) {
            zk.create(servicePath, null, 
                ZooDefs.Ids.OPEN_ACL_UNSAFE, 
                CreateMode.PERSISTENT);
        }
        
        // 2. åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹è¡¨ç¤ºæœåŠ¡å®ä¾‹
        String instancePath = servicePath + "/" + serviceAddress;
        zk.create(instancePath, 
            serviceAddress.getBytes(),
            ZooDefs.Ids.OPEN_ACL_UNSAFE,
            CreateMode.EPHEMERAL);
        
        System.out.println("æœåŠ¡æ³¨å†ŒæˆåŠŸï¼š" + serviceAddress);
    }
}
```

**æœåŠ¡å‘ç°ä»£ç **ï¼š
```java
public class ServiceDiscovery {
    private ZooKeeper zk;
    private Map<String, List<String>> serviceCache = new HashMap<>();
    
    // å‘ç°æœåŠ¡å®ä¾‹
    public List<String> discover(String serviceName) throws Exception {
        String servicePath = "/services/" + serviceName;
        
        // è·å–æ‰€æœ‰æœåŠ¡å®ä¾‹ï¼Œå¹¶è®¾ç½®ç›‘å¬
        List<String> instances = zk.getChildren(servicePath, event -> {
            if (event.getType() == Watcher.Event.EventType.NodeChildrenChanged) {
                // æœåŠ¡åˆ—è¡¨å˜åŒ–ï¼Œé‡æ–°è·å–
                updateServiceCache(serviceName);
            }
        });
        
        return instances;
    }
    
    // è´Ÿè½½å‡è¡¡é€‰æ‹©å®ä¾‹
    public String selectInstance(String serviceName) {
        List<String> instances = serviceCache.get(serviceName);
        if (instances == null || instances.isEmpty()) {
            return null;
        }
        // ç®€å•è½®è¯¢
        return instances.get(new Random().nextInt(instances.size()));
    }
}
```

### 2.4 å®Œæ•´çš„è°ƒç”¨æµç¨‹


```
æœåŠ¡æä¾›è€…                ZooKeeper               æœåŠ¡æ¶ˆè´¹è€…
     |                        |                        |
     |---[1]æ³¨å†ŒæœåŠ¡--------->|                        |
     | /services/user/ip:port |                        |
     |                        |<---[2]å‘ç°æœåŠ¡---------|
     |                        |   æŸ¥è¯¢user-service     |
     |                        |---[3]è¿”å›å®ä¾‹åˆ—è¡¨----->|
     |                        |   [ip1:port, ip2:port] |
     |<----------[4]å‘èµ·RPCè°ƒç”¨------------------------|
     |                        |                        |
     |---[5]è¿”å›ç»“æœ--------------------------------->|
```

---

## 3. âš™ï¸ é…ç½®ä¸­å¿ƒå®ç°


### 3.1 é…ç½®ä¸­å¿ƒè§£å†³ä»€ä¹ˆé—®é¢˜


> ğŸ“– **é—®é¢˜åœºæ™¯**ï¼š100å°æœåŠ¡å™¨éƒ½ç”¨åŒä¸€ä¸ªæ•°æ®åº“é…ç½®ï¼Œè¦æ”¹é…ç½®æ€ä¹ˆåŠï¼Ÿä¸€å°å°æ”¹ï¼Ÿé‡å¯ï¼Ÿ

**ä¼ ç»Ÿæ–¹å¼çš„ç—›ç‚¹**ï¼š
- âŒ é…ç½®åˆ†æ•£åœ¨å„ä¸ªåº”ç”¨çš„é…ç½®æ–‡ä»¶ä¸­
- âŒ ä¿®æ”¹é…ç½®éœ€è¦é‡å¯åº”ç”¨
- âŒ ä¸åŒç¯å¢ƒé…ç½®ç®¡ç†æ··ä¹±
- âŒ é…ç½®å˜æ›´æ— æ³•è¿½æº¯

**é…ç½®ä¸­å¿ƒçš„ä¼˜åŠ¿**ï¼š
- âœ… é›†ä¸­ç®¡ç†æ‰€æœ‰é…ç½®
- âœ… åŠ¨æ€æ›´æ–°ï¼Œæ— éœ€é‡å¯
- âœ… ç¯å¢ƒéš”ç¦»ï¼ˆå¼€å‘/æµ‹è¯•/ç”Ÿäº§ï¼‰
- âœ… é…ç½®ç‰ˆæœ¬ç®¡ç†

### 3.2 Zookeeperå®ç°é…ç½®ä¸­å¿ƒ


**èŠ‚ç‚¹è®¾è®¡**ï¼š
```
/configï¼ˆé…ç½®æ ¹èŠ‚ç‚¹ï¼‰
  â”œâ”€â”€ /devï¼ˆå¼€å‘ç¯å¢ƒï¼‰
  â”‚   â”œâ”€â”€ /database
  â”‚   â”‚   â””â”€â”€ url=jdbc:mysql://dev-db:3306/test
  â”‚   â””â”€â”€ /redis
  â”‚       â””â”€â”€ host=dev-redis:6379
  â”‚
  â”œâ”€â”€ /testï¼ˆæµ‹è¯•ç¯å¢ƒï¼‰
  â”‚   â””â”€â”€ /database
  â”‚       â””â”€â”€ url=jdbc:mysql://test-db:3306/test
  â”‚
  â””â”€â”€ /prodï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
      â””â”€â”€ /database
          â””â”€â”€ url=jdbc:mysql://prod-db:3306/prod
```

### 3.3 é…ç½®ä¸­å¿ƒDemoå®ç°


**é…ç½®ç®¡ç†å™¨**ï¼š
```java
public class ConfigManager {
    private ZooKeeper zk;
    private Map<String, String> configCache = new ConcurrentHashMap<>();
    
    // è¯»å–é…ç½®
    public String getConfig(String env, String key) throws Exception {
        String path = "/config/" + env + "/" + key;
        
        // è·å–é…ç½®å¹¶è®¾ç½®ç›‘å¬
        byte[] data = zk.getData(path, event -> {
            if (event.getType() == Watcher.Event.EventType.NodeDataChanged) {
                // é…ç½®å˜åŒ–ï¼Œé‡æ–°åŠ è½½
                reloadConfig(env, key);
            }
        }, null);
        
        String value = new String(data);
        configCache.put(key, value);
        return value;
    }
    
    // æ›´æ–°é…ç½®
    public void updateConfig(String env, String key, String value) 
        throws Exception {
        String path = "/config/" + env + "/" + key;
        zk.setData(path, value.getBytes(), -1);
        System.out.println("é…ç½®æ›´æ–°æˆåŠŸï¼š" + key + "=" + value);
    }
    
    // é…ç½®å˜åŒ–å›è°ƒ
    private void reloadConfig(String env, String key) {
        try {
            String newValue = getConfig(env, key);
            System.out.println("é…ç½®å·²æ›´æ–°ï¼š" + key + " -> " + newValue);
            // è§¦å‘åº”ç”¨é…ç½®åˆ·æ–°
            notifyConfigChange(key, newValue);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

**åº”ç”¨ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
public class Application {
    private ConfigManager configManager;
    private DataSource dataSource;
    
    public void start() throws Exception {
        // 1. åŠ è½½é…ç½®
        String dbUrl = configManager.getConfig("prod", "database/url");
        String redisHost = configManager.getConfig("prod", "redis/host");
        
        // 2. åˆå§‹åŒ–æ•°æ®æº
        dataSource = createDataSource(dbUrl);
        
        // 3. é…ç½®å˜åŒ–æ—¶è‡ªåŠ¨é‡å»ºè¿æ¥
        configManager.addListener("database/url", newUrl -> {
            dataSource.close();
            dataSource = createDataSource(newUrl);
            System.out.println("æ•°æ®åº“è¿æ¥å·²æ›´æ–°");
        });
    }
}
```

### 3.4 é…ç½®ä¸­å¿ƒæœ€ä½³å®è·µ


> ğŸš€ **å®è·µå»ºè®®**

**é…ç½®åˆ†ç±»ç®¡ç†**ï¼š
- **å…¬å…±é…ç½®**ï¼šæ‰€æœ‰ç¯å¢ƒå…±äº«ï¼ˆå¦‚æœåŠ¡ç«¯å£ï¼‰
- **ç¯å¢ƒé…ç½®**ï¼šåŒºåˆ†dev/test/prod
- **åº”ç”¨é…ç½®**ï¼šç‰¹å®šåº”ç”¨ä¸“ç”¨é…ç½®

**é…ç½®çƒ­æ›´æ–°ç­–ç•¥**ï¼š
```
é…ç½®ç±»å‹         æ˜¯å¦éœ€è¦é‡å¯
æ•°æ®åº“è¿æ¥æ± å¤§å°    å¦ï¼ˆåŠ¨æ€è°ƒæ•´ï¼‰
æ•°æ®åº“åœ°å€          éœ€è¦ï¼ˆé‡å»ºè¿æ¥ï¼‰
æ—¥å¿—çº§åˆ«           å¦ï¼ˆå³æ—¶ç”Ÿæ•ˆï¼‰
çº¿ç¨‹æ± é…ç½®         å¦ï¼ˆåŠ¨æ€è°ƒæ•´ï¼‰
```

---

## 4. ğŸ”„ å¾®æœåŠ¡æ³¨å†Œä¸­å¿ƒæ–¹æ¡ˆ


### 4.1 Zookeeper vs å…¶ä»–æ³¨å†Œä¸­å¿ƒ


**å¸¸è§æ³¨å†Œä¸­å¿ƒå¯¹æ¯”**ï¼š

| ç‰¹æ€§ | **Zookeeper** | **Eureka** | **Consul** | **Nacos** |
|-----|--------------|-----------|-----------|----------|
| **ä¸€è‡´æ€§** | `å¼ºä¸€è‡´æ€§ï¼ˆCPï¼‰` | `æœ€ç»ˆä¸€è‡´æ€§ï¼ˆAPï¼‰` | `å¼ºä¸€è‡´æ€§ï¼ˆCPï¼‰` | `æ”¯æŒCP/APåˆ‡æ¢` |
| **å¥åº·æ£€æŸ¥** | `è¿æ¥æ–­å¼€æ£€æµ‹` | `å¿ƒè·³æ£€æµ‹` | `ä¸»åŠ¨å¥åº·æ£€æŸ¥` | `å¤šç§æ£€æŸ¥æ–¹å¼` |
| **ä½¿ç”¨åœºæ™¯** | `é…ç½®ã€åè°ƒ` | `Spring Cloud` | `æœåŠ¡ç½‘æ ¼` | `é˜¿é‡Œäº‘ç”Ÿæ€` |
| **æ€§èƒ½** | `è¯»å¤šå†™å°‘` | `é«˜å¯ç”¨ä¼˜å…ˆ` | `å‡è¡¡` | `é«˜æ€§èƒ½` |

> ğŸ’¡ **CP vs AP é€šä¿—ç†è§£**ï¼š
> - **CPï¼ˆä¸€è‡´æ€§ä¼˜å…ˆï¼‰**ï¼šå®å¯æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œä¹Ÿè¦ä¿è¯æ•°æ®ä¸€è‡´ã€‚å°±åƒé“¶è¡Œè½¬è´¦ï¼Œå¿…é¡»å‡†ç¡®æ— è¯¯ã€‚
> - **APï¼ˆå¯ç”¨æ€§ä¼˜å…ˆï¼‰**ï¼šå®å¯æ•°æ®æš‚æ—¶ä¸ä¸€è‡´ï¼Œä¹Ÿè¦ä¿è¯æœåŠ¡å¯ç”¨ã€‚å°±åƒç¤¾äº¤è½¯ä»¶ï¼Œæ™šç‚¹åŒæ­¥ä¹Ÿæ²¡å…³ç³»ã€‚

### 4.2 æ›¿ä»£Eurekaçš„å®ç°æ–¹æ¡ˆ


**ä¸ºä»€ä¹ˆè€ƒè™‘æ›¿ä»£Eureka**ï¼š
- Eureka 2.x å·²åœæ­¢ç»´æŠ¤
- Netflix OSS æ•´ä½“è¿›å…¥ç»´æŠ¤æ¨¡å¼
- éœ€è¦æ›´å¼ºçš„ä¸€è‡´æ€§ä¿è¯

**Zookeeperæ›¿ä»£æ–¹æ¡ˆæ¶æ„**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Spring Cloud Gateway         â”‚
â”‚        (APIç½‘å…³ - è·¯ç”±è½¬å‘)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
    â”‚  Zookeeper  â”‚ â† æœåŠ¡æ³¨å†Œä¸­å¿ƒ
    â”‚   Cluster   â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                         â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·æœåŠ¡ â”‚  â”‚ è®¢å•æœåŠ¡ â”‚  â”‚ å•†å“æœåŠ¡ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é›†æˆSpring Cloud**ï¼š
```java
@Configuration
public class ZookeeperServiceRegistry {
    
    @Bean
    public ServiceRegistry serviceRegistry() {
        return new ZookeeperServiceRegistry(
            zookeeperClient(),
            registrationProperties()
        );
    }
    
    // æœåŠ¡æ³¨å†Œ
    @EventListener(ApplicationReadyEvent.class)
    public void registerService() {
        String serviceName = "user-service";
        String instanceId = getLocalIp() + ":" + serverPort;
        
        serviceRegistry.register(serviceName, instanceId);
    }
    
    // æœåŠ¡å‘ç°
    @Bean
    public LoadBalancerClient loadBalancerClient() {
        return new ZookeeperLoadBalancerClient(
            serviceDiscovery()
        );
    }
}
```

### 4.3 Dubbo + Zookeeperç»å…¸ç»„åˆ


**DubboæœåŠ¡è°ƒç”¨æµç¨‹**ï¼š
```
1. æœåŠ¡æä¾›è€…å¯åŠ¨
   Provider â†’ Zookeeper: æ³¨å†ŒæœåŠ¡
   
2. æ¶ˆè´¹è€…å¯åŠ¨
   Consumer â†’ Zookeeper: è®¢é˜…æœåŠ¡
   Zookeeper â†’ Consumer: æ¨é€æœåŠ¡åˆ—è¡¨
   
3. æœåŠ¡è°ƒç”¨
   Consumer â†’ Provider: ç›´è¿è°ƒç”¨(RPC)
   
4. æœåŠ¡å˜æ›´
   Providerå®•æœº â†’ Zookeeper: èŠ‚ç‚¹åˆ é™¤
   Zookeeper â†’ Consumer: é€šçŸ¥æ›´æ–°åˆ—è¡¨
```

**Dubboé…ç½®ç¤ºä¾‹**ï¼š
```xml
<!-- æœåŠ¡æä¾›è€…é…ç½® -->
<dubbo:registry address="zookeeper://127.0.0.1:2181"/>
<dubbo:service interface="com.example.UserService" 
               ref="userService"/>

<!-- æœåŠ¡æ¶ˆè´¹è€…é…ç½® -->
<dubbo:registry address="zookeeper://127.0.0.1:2181"/>
<dubbo:reference id="userService" 
                 interface="com.example.UserService"/>
```

---

## 5. ğŸ—ï¸ å®é™…é¡¹ç›®åº”ç”¨åœºæ™¯


### 5.1 ç”µå•†ç³»ç»Ÿä¸­çš„åº”ç”¨


**åœºæ™¯1ï¼šç§’æ€åº“å­˜æ§åˆ¶**

éš¾ç‚¹ï¼šé«˜å¹¶å‘ä¸‹é˜²æ­¢è¶…å–

```java
public class SeckillService {
    
    // ä½¿ç”¨Zookeeperåˆ†å¸ƒå¼é”æ§åˆ¶åº“å­˜
    public boolean seckill(Long productId, Long userId) {
        DistributedLock lock = new DistributedLock(
            zk, "/seckill/product-" + productId
        );
        
        try {
            lock.lock();
            
            // æ£€æŸ¥åº“å­˜
            int stock = getStockFromRedis(productId);
            if (stock <= 0) {
                return false;
            }
            
            // æ‰£å‡åº“å­˜
            decrStock(productId);
            
            // åˆ›å»ºè®¢å•
            createOrder(productId, userId);
            
            return true;
        } finally {
            lock.unlock();
        }
    }
}
```

**åœºæ™¯2ï¼šåˆ†å¸ƒå¼è®¢å•å·ç”Ÿæˆ**

```
ä½¿ç”¨Zookeeperé¡ºåºèŠ‚ç‚¹ç”Ÿæˆå…¨å±€å”¯ä¸€è®¢å•å·ï¼š

/orders
  â”œâ”€â”€ /2024092300000001
  â”œâ”€â”€ /2024092300000002
  â””â”€â”€ /2024092300000003

è§„åˆ™ï¼šæ—¥æœŸ + è‡ªå¢åºåˆ—å·
```

### 5.2 é‡‘èç³»ç»Ÿä¸­çš„åº”ç”¨


**åœºæ™¯ï¼šåˆ†å¸ƒå¼äº‹åŠ¡åè°ƒ**

> ğŸ“– **ä¸šåŠ¡åœºæ™¯**ï¼šç”¨æˆ·è½¬è´¦ï¼Œéœ€è¦åŒæ—¶æ“ä½œä¸¤ä¸ªè´¦æˆ·

```
äº‹åŠ¡åè°ƒæµç¨‹ï¼š

åè°ƒè€…(Zookeeper)          å‚ä¸è€…A              å‚ä¸è€…B
     |                      |                    |
     |---[1]åˆ›å»ºäº‹åŠ¡èŠ‚ç‚¹---->|                    |
     | /tx/tx-001           |                    |
     |                      |                    |
     |---[2]å‘èµ·å‡†å¤‡-------->|                    |
     |                      |---æ£€æŸ¥ä½™é¢------    |
     |                      |   é”å®šé‡‘é¢         |
     |<--[3]è¿”å›å°±ç»ª---------|                    |
     |                      |                    |
     |---[4]å‘èµ·å‡†å¤‡------------------------>|   |
     |                      |                |---æ£€æŸ¥è´¦æˆ·
     |                      |                    é”å®šé‡‘é¢
     |<--[5]è¿”å›å°±ç»ª-------------------------|   |
     |                      |                    |
     |---[6]æäº¤äº‹åŠ¡-------->|                    |
     |                      |---æ‰£æ¬¾æˆåŠŸ------    |
     |---[7]æäº¤äº‹åŠ¡------------------------>|   |
     |                      |                |---å…¥è´¦æˆåŠŸ
     |                      |                    |
     |---[8]åˆ é™¤äº‹åŠ¡èŠ‚ç‚¹---->|                    |
```

### 5.3 å¤§æ•°æ®å¹³å°åº”ç”¨


**Kafka + Zookeeperæ¶æ„**ï¼š

```
Zookeeperåœ¨Kafkaä¸­çš„ä½œç”¨ï¼š

1. Brokeræ³¨å†Œ
   /brokers/ids/0 â†’ {"host":"kafka1", "port":9092}
   /brokers/ids/1 â†’ {"host":"kafka2", "port":9092}

2. Topicé…ç½®
   /config/topics/order â†’ {"partitions":3, "replicas":2}

3. Controlleré€‰ä¸¾
   /controller â†’ {"brokerId":0, "timestamp":1695456789}

4. æ¶ˆè´¹è€…ç»„åè°ƒ
   /consumers/group1/offsets/topic/partition-0 â†’ 12345
```

---

## 6. ğŸ¯ æ¶æ„è®¾è®¡æœ€ä½³å®è·µ


### 6.1 é«˜å¯ç”¨æ¶æ„è®¾è®¡


**Zookeeperé›†ç¾¤éƒ¨ç½²**ï¼š

```
æ¨èé…ç½®ï¼š

æµ‹è¯•ç¯å¢ƒï¼š   3èŠ‚ç‚¹ï¼ˆå®¹å¿1ä¸ªæ•…éšœï¼‰
ç”Ÿäº§ç¯å¢ƒï¼š   5èŠ‚ç‚¹ï¼ˆå®¹å¿2ä¸ªæ•…éšœï¼‰
å¤§å‹ç³»ç»Ÿï¼š   7èŠ‚ç‚¹ï¼ˆå®¹å¿3ä¸ªæ•…éšœï¼‰

éƒ¨ç½²æ‹“æ‰‘ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ZK-1   â”‚â†â†’  â”‚  ZK-2   â”‚â†â†’  â”‚  ZK-3   â”‚
â”‚ Leader  â”‚    â”‚ Followerâ”‚    â”‚ Followerâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†‘              â†‘              â†‘
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              æ•°æ®åŒæ­¥
```

**è¿æ¥ç®¡ç†æœ€ä½³å®è·µ**ï¼š
```java
public class ZKClientManager {
    private static final int SESSION_TIMEOUT = 30000;
    private static final int CONNECT_TIMEOUT = 5000;
    
    // è¿æ¥å­—ç¬¦ä¸²é…ç½®ï¼ˆå¤šåœ°å€ï¼‰
    private String connectString = 
        "zk1:2181,zk2:2181,zk3:2181";
    
    // åˆ›å»ºè¿æ¥
    public ZooKeeper createConnection() {
        return new ZooKeeper(
            connectString,
            SESSION_TIMEOUT,
            new DefaultWatcher(),
            true // å¼€å¯chrootéš”ç¦»
        );
    }
    
    // é‡è¿ç­–ç•¥
    public void reconnect() {
        RetryPolicy retryPolicy = new ExponentialBackoffRetry(
            1000, // åˆå§‹ç­‰å¾…æ—¶é—´
            3     // æœ€å¤§é‡è¯•æ¬¡æ•°
        );
        // ... é‡è¿é€»è¾‘
    }
}
```

### 6.2 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


> ğŸš€ **ä¼˜åŒ–é‡ç‚¹**

**æ‰¹é‡æ“ä½œä¼˜åŒ–**ï¼š
```java
// âŒ ä¸æ¨èï¼šé€ä¸ªåˆ›å»ºèŠ‚ç‚¹
for (String data : dataList) {
    zk.create("/data/" + data, ...);
}

// âœ… æ¨èï¼šä½¿ç”¨äº‹åŠ¡æ‰¹é‡åˆ›å»º
List<Op> ops = new ArrayList<>();
for (String data : dataList) {
    ops.add(Op.create("/data/" + data, ...));
}
zk.multi(ops); // åŸå­æ€§æ‰¹é‡æ“ä½œ
```

**ç›‘å¬å™¨ä¼˜åŒ–**ï¼š
```java
// âŒ é¿å…ï¼šè¿‡å¤šçš„ç›‘å¬å™¨
zk.getChildren("/services", true); // æ¯æ¬¡éƒ½åˆ›å»ºæ–°ç›‘å¬

// âœ… æ¨èï¼šä½¿ç”¨æŒä¹…ç›‘å¬å™¨ï¼ˆZK 3.6+ï¼‰
zk.addWatch("/services", 
    event -> handleEvent(event),
    AddWatchMode.PERSISTENT_RECURSIVE);
```

### 6.3 ç›‘æ§ä¸è¿ç»´


**å…³é”®ç›‘æ§æŒ‡æ ‡**ï¼š

| æŒ‡æ ‡ç±»å‹ | ç›‘æ§é¡¹ | å‘Šè­¦é˜ˆå€¼ |
|---------|-------|---------|
| **æ€§èƒ½** | å¹³å‡å»¶è¿Ÿ | `> 100ms` |
| **æ€§èƒ½** | QPS | `> 10000` |
| **ç¨³å®šæ€§** | èŠ‚ç‚¹å­˜æ´»æ•° | `< (N+1)/2` |
| **å­˜å‚¨** | æ•°æ®ç›®å½•å¤§å° | `> 80%` |
| **ç½‘ç»œ** | è¿æ¥æ•° | `> 1000` |

**å¥åº·æ£€æŸ¥è„šæœ¬**ï¼š
```bash
#!/bin/bash
# æ£€æŸ¥ZKçŠ¶æ€
echo "ruok" | nc localhost 2181

# æŸ¥çœ‹æœåŠ¡å™¨æ¨¡å¼
echo "srvr" | nc localhost 2181 | grep Mode

# æ£€æŸ¥è¿æ¥æ•°
echo "cons" | nc localhost 2181 | wc -l
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…çŸ¥å¿…ä¼šçš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ åˆ†å¸ƒå¼é”ï¼šåˆ©ç”¨ä¸´æ—¶é¡ºåºèŠ‚ç‚¹ï¼Œé¿å…æƒŠç¾¤æ•ˆåº”
ğŸ”¸ æœåŠ¡æ³¨å†Œï¼šä¸´æ—¶èŠ‚ç‚¹è‡ªåŠ¨æ‘˜é™¤æ•…éšœå®ä¾‹
ğŸ”¸ é…ç½®ä¸­å¿ƒï¼šWatchæœºåˆ¶å®ç°é…ç½®çƒ­æ›´æ–°
ğŸ”¸ é›†ç¾¤éƒ¨ç½²ï¼šå¥‡æ•°èŠ‚ç‚¹ï¼Œè¿‡åŠå­˜æ´»å¯ç”¨
ğŸ”¸ æ€§èƒ½ä¼˜åŒ–ï¼šæ‰¹é‡æ“ä½œã€æŒä¹…ç›‘å¬ã€è¿æ¥å¤ç”¨
```

### 7.2 é€‰å‹å†³ç­–å»ºè®®


**ä»€ä¹ˆæ—¶å€™é€‰æ‹©Zookeeper**ï¼š
- âœ… éœ€è¦å¼ºä¸€è‡´æ€§ä¿è¯
- âœ… é…ç½®ç®¡ç†ã€åè°ƒæœåŠ¡
- âœ… å·²æœ‰Dubbo/Kafkaç­‰æŠ€æœ¯æ ˆ
- âœ… é›†ç¾¤è§„æ¨¡å¯æ§ï¼ˆ< 1000èŠ‚ç‚¹ï¼‰

**ä»€ä¹ˆæ—¶å€™è€ƒè™‘å…¶ä»–æ–¹æ¡ˆ**ï¼š
- âŒ è¶…å¤§è§„æ¨¡é›†ç¾¤ï¼ˆé€‰Consul/Nacosï¼‰
- âŒ è¦æ±‚æè‡´é«˜å¯ç”¨ï¼ˆé€‰Eurekaï¼‰
- âŒ äº‘åŸç”Ÿåœºæ™¯ï¼ˆé€‰KubernetesåŸç”Ÿæ–¹æ¡ˆï¼‰

### 7.3 å®è·µç»éªŒæ€»ç»“


> ğŸ’¡ **é¿å‘æŒ‡å—**

**å¸¸è§é”™è¯¯**ï¼š
1. **ä¼šè¯è¶…æ—¶è®¾ç½®è¿‡çŸ­**ï¼šé¢‘ç¹é‡è¿å½±å“æ€§èƒ½
2. **ç›‘å¬å™¨æ»¥ç”¨**ï¼šå¯¼è‡´å¤§é‡æ— æ•ˆé€šçŸ¥
3. **å•ç‚¹ä¾èµ–**ï¼šæœªåšé›†ç¾¤éƒ¨ç½²
4. **æ•°æ®é‡è¿‡å¤§**ï¼šZKä¸é€‚åˆå­˜å‚¨å¤§é‡æ•°æ®

**æœ€ä½³å®è·µ**ï¼š
- èŠ‚ç‚¹æ•°æ® < 1MB
- å­èŠ‚ç‚¹æ•°é‡ < 10000
- Watchæ•°é‡åˆç†æ§åˆ¶
- å®šæœŸæ¸…ç†ä¸´æ—¶æ•°æ®
- åšå¥½ç›‘æ§å’Œå¤‡ä»½

### 7.4 å­¦ä¹ è·¯å¾„å»ºè®®


```
å…¥é—¨é˜¶æ®µï¼š
â””â”€ åŸºç¡€æ¦‚å¿µ â†’ å•æœºæ­å»º â†’ APIä½¿ç”¨

è¿›é˜¶é˜¶æ®µï¼š
â””â”€ é›†ç¾¤éƒ¨ç½² â†’ å…¸å‹æ¡ˆä¾‹ â†’ æ€§èƒ½ä¼˜åŒ–

é«˜çº§é˜¶æ®µï¼š
â””â”€ æºç åˆ†æ â†’ æ¶æ„è®¾è®¡ â†’ é—®é¢˜æ’æŸ¥

å®æˆ˜é˜¶æ®µï¼š
â””â”€ é¡¹ç›®åº”ç”¨ â†’ äºŒæ¬¡å¼€å‘ â†’ è¿ç»´ç»éªŒ
```

---

**æ ¸å¿ƒè®°å¿†**ï¼š
- Zookeeperæ˜¯åˆ†å¸ƒå¼åè°ƒåˆ©å™¨ï¼Œä¸æ˜¯ä¸‡èƒ½æ•°æ®åº“
- ä¸´æ—¶èŠ‚ç‚¹+ç›‘å¬æœºåˆ¶æ˜¯æ ¸å¿ƒèƒ½åŠ›
- å¼ºä¸€è‡´æ€§ä¿è¯æ•°æ®å‡†ç¡®ï¼Œä½†ç‰ºç‰²éƒ¨åˆ†å¯ç”¨æ€§
- åˆç†ä½¿ç”¨æ‰èƒ½å‘æŒ¥æœ€å¤§ä»·å€¼