---
title: 7ã€Watcherç›‘å¬æœºåˆ¶
---
## ğŸ“š ç›®å½•

1. [Watcherç›‘å¬æœºåˆ¶æ¦‚è¿°](#1-watcherç›‘å¬æœºåˆ¶æ¦‚è¿°)
2. [Watcherå·¥ä½œåŸç†](#2-watcherå·¥ä½œåŸç†)
3. [äº‹ä»¶é€šçŸ¥æœºåˆ¶](#3-äº‹ä»¶é€šçŸ¥æœºåˆ¶)
4. [ä¸€æ¬¡æ€§è§¦å‘ç‰¹æ€§](#4-ä¸€æ¬¡æ€§è§¦å‘ç‰¹æ€§)
5. [å®¢æˆ·ç«¯å›è°ƒæœºåˆ¶](#5-å®¢æˆ·ç«¯å›è°ƒæœºåˆ¶)
6. [ç›‘å¬ç±»å‹è¯¦è§£](#6-ç›‘å¬ç±»å‹è¯¦è§£)
7. [å®é™…åº”ç”¨åœºæ™¯](#7-å®é™…åº”ç”¨åœºæ™¯)
8. [ä½¿ç”¨æ³¨æ„äº‹é¡¹](#8-ä½¿ç”¨æ³¨æ„äº‹é¡¹)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ Watcherç›‘å¬æœºåˆ¶æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯Watcher


**é€šä¿—ç†è§£**ï¼šWatcherå°±åƒæ˜¯ç»™ZookeeperèŠ‚ç‚¹è£…äº†ä¸€ä¸ª"ç›‘æ§æ‘„åƒå¤´"ï¼Œå½“èŠ‚ç‚¹å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå®ƒä¼šç«‹å³é€šçŸ¥ä½ ã€‚

```
ç”Ÿæ´»ä¸­çš„ç±»æ¯”ï¼š
å°±åƒä½ ç½‘è´­çš„å¿«é€’è·Ÿè¸ª ğŸ“¦
- ä½ ä¸ç”¨ä¸€ç›´ç›¯ç€çœ‹
- åŒ…è£¹çŠ¶æ€å˜åŒ–ä¼šè‡ªåŠ¨æ¨é€é€šçŸ¥
- æ”¶åˆ°é€šçŸ¥åä½ å†å»æŸ¥çœ‹è¯¦æƒ…

Zookeeperçš„Watcherï¼š
- ä½ ä¸ç”¨ä¸€ç›´è½®è¯¢æŸ¥è¯¢èŠ‚ç‚¹
- èŠ‚ç‚¹å˜åŒ–ä¼šè‡ªåŠ¨é€šçŸ¥å®¢æˆ·ç«¯
- æ”¶åˆ°é€šçŸ¥åå†è·å–æœ€æ–°æ•°æ®
```

**æ ¸å¿ƒä½œç”¨**ï¼š
```
ğŸ”¸ å®æ—¶æ„ŸçŸ¥ï¼šèŠ‚ç‚¹æ•°æ®å˜åŒ–ã€å­èŠ‚ç‚¹å˜åŒ–
ğŸ”¸ è¢«åŠ¨é€šçŸ¥ï¼šæ— éœ€ä¸»åŠ¨è½®è¯¢ï¼ŒèŠ‚çœèµ„æº
ğŸ”¸ äº‹ä»¶é©±åŠ¨ï¼šåŸºäºäº‹ä»¶è§¦å‘çš„ç¼–ç¨‹æ¨¡å‹
ğŸ”¸ åˆ†å¸ƒå¼åè°ƒï¼šå®ç°é…ç½®åŒæ­¥ã€é›†ç¾¤ç›‘æ§ç­‰åŠŸèƒ½
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦Watcher


**è§£å†³çš„é—®é¢˜**ï¼š

```
ä¼ ç»Ÿè½®è¯¢æ–¹å¼çš„ç¼ºç‚¹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®¢æˆ·ç«¯æ¯éš”1ç§’æŸ¥è¯¢ä¸€æ¬¡é…ç½®          â”‚
â”‚ â”œâ”€ æµªè´¹ç½‘ç»œèµ„æº                   â”‚
â”‚ â”œâ”€ å»¶è¿Ÿé«˜ï¼ˆæœ€å¤š1ç§’æ‰èƒ½å‘ç°å˜åŒ–ï¼‰   â”‚
â”‚ â”œâ”€ æœåŠ¡å™¨å‹åŠ›å¤§                   â”‚
â”‚ â””â”€ ä»£ç å¤æ‚ï¼ˆéœ€è¦å¾ªç¯+å®šæ—¶å™¨ï¼‰     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä½¿ç”¨Watcherçš„ä¼˜åŠ¿ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç›‘å¬ä¸€æ¬¡ï¼Œå˜åŒ–æ—¶è‡ªåŠ¨é€šçŸ¥           â”‚
â”‚ â”œâ”€ èŠ‚çœèµ„æºï¼ˆæŒ‰éœ€é€šçŸ¥ï¼‰            â”‚
â”‚ â”œâ”€ å»¶è¿Ÿä½ï¼ˆå®æ—¶æ¨é€ï¼‰              â”‚
â”‚ â”œâ”€ æœåŠ¡å™¨å‹å¥½ï¼ˆäº‹ä»¶é©±åŠ¨ï¼‰          â”‚
â”‚ â””â”€ ä»£ç ç®€æ´ï¼ˆå›è°ƒå‡½æ•°å¤„ç†ï¼‰        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> ğŸ’¡ **æ ¸å¿ƒæ€æƒ³**ï¼šä»"ä¸»åŠ¨è½®è¯¢"å˜ä¸º"è¢«åŠ¨é€šçŸ¥"ï¼Œè¿™æ˜¯Watcheræœ€å¤§çš„ä»·å€¼æ‰€åœ¨ã€‚

### 1.3 Watcherçš„åŸºæœ¬ç‰¹å¾


```
æ ¸å¿ƒç‰¹æ€§ä¸€è§ˆï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… ä¸€æ¬¡æ€§è§¦å‘ï¼šè§¦å‘ä¸€æ¬¡åè‡ªåŠ¨å¤±æ•ˆ    â”‚
â”‚ âœ… äº‹ä»¶æ¨é€ï¼šæœåŠ¡ç«¯ä¸»åŠ¨æ¨é€é€šçŸ¥      â”‚
â”‚ âœ… è½»é‡é€šçŸ¥ï¼šåªé€šçŸ¥å˜åŒ–ï¼Œä¸å«æ–°æ•°æ®  â”‚
â”‚ âœ… é¡ºåºä¿è¯ï¼šäº‹ä»¶æŒ‰é¡ºåºæŠ•é€’          â”‚
â”‚ âœ… å®¢æˆ·ç«¯æœ¬åœ°ï¼šå›è°ƒåœ¨å®¢æˆ·ç«¯æ‰§è¡Œ      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. âš™ï¸ Watcherå·¥ä½œåŸç†


### 2.1 æ•´ä½“å·¥ä½œæµç¨‹


**ä¸‰æ­¥å·¥ä½œæœºåˆ¶**ï¼š

```
æ­¥éª¤1ï¸âƒ£ æ³¨å†Œç›‘å¬
    â†“
æ­¥éª¤2ï¸âƒ£ è§¦å‘äº‹ä»¶
    â†“
æ­¥éª¤3ï¸âƒ£ æ‰§è¡Œå›è°ƒ

è¯¦ç»†æµç¨‹ï¼š
å®¢æˆ·ç«¯                           ZookeeperæœåŠ¡ç«¯
   |                                    |
   |--[1] æ³¨å†ŒWatcher----------------->|
   |    getData("/config", watcher)    |
   |                                    |
   |<--[2] è¿”å›æ•°æ®+æ³¨å†ŒæˆåŠŸ------------|
   |                                    |
   |                                    | [èŠ‚ç‚¹æ•°æ®å˜åŒ–]
   |                                    |
   |<--[3] æ¨é€äº‹ä»¶é€šçŸ¥----------------|
   |    WatchedEvent                   |
   |                                    |
   |--[4] æ‰§è¡Œå›è°ƒå‡½æ•°---------------->|
   |    process(event)                 |
   |                                    |
   |--[5] é‡æ–°æ³¨å†Œï¼ˆå¦‚éœ€æŒç»­ç›‘å¬ï¼‰----->|
```

### 2.2 æ³¨å†ŒWatcherçš„æ–¹å¼


**ä¸‰ç§æ³¨å†Œæ–¹æ³•**ï¼š

```java
// æ–¹å¼1ï¼šgetDataæ—¶æ³¨å†Œï¼ˆç›‘å¬æ•°æ®å˜åŒ–ï¼‰
byte[] data = zk.getData("/config", new Watcher() {
    @Override
    public void process(WatchedEvent event) {
        System.out.println("æ•°æ®å˜åŒ–äº†ï¼š" + event);
    }
}, null);

// æ–¹å¼2ï¼šexistsæ—¶æ³¨å†Œï¼ˆç›‘å¬èŠ‚ç‚¹å­˜åœ¨æ€§ï¼‰
Stat stat = zk.exists("/config", new Watcher() {
    @Override
    public void process(WatchedEvent event) {
        System.out.println("èŠ‚ç‚¹çŠ¶æ€å˜åŒ–ï¼š" + event);
    }
});

// æ–¹å¼3ï¼šgetChildrenæ—¶æ³¨å†Œï¼ˆç›‘å¬å­èŠ‚ç‚¹å˜åŒ–ï¼‰
List<String> children = zk.getChildren("/servers", new Watcher() {
    @Override
    public void process(WatchedEvent event) {
        System.out.println("å­èŠ‚ç‚¹å˜åŒ–ï¼š" + event);
    }
});
```

> âš ï¸ **é‡è¦æç¤º**ï¼šæ¯ç§æ³¨å†Œæ–¹å¼ç›‘å¬çš„äº‹ä»¶ç±»å‹ä¸åŒï¼Œè¦æ ¹æ®éœ€æ±‚é€‰æ‹©ï¼

### 2.3 å†…éƒ¨å®ç°æœºåˆ¶


**å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„åä½œ**ï¼š

```
å®¢æˆ·ç«¯ä¾§ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. å‘é€è¯·æ±‚æ—¶æºå¸¦watch=true   â”‚
â”‚ 2. æœ¬åœ°ä¿å­˜Watcherå¯¹è±¡        â”‚
â”‚ 3. æ”¶åˆ°é€šçŸ¥åæŸ¥æ‰¾å¯¹åº”Watcher  â”‚
â”‚ 4. æ‰§è¡Œå›è°ƒå‡½æ•°               â”‚
â”‚ 5. ç§»é™¤å·²è§¦å‘çš„Watcher        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æœåŠ¡ç«¯ä¾§ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ”¶åˆ°è¯·æ±‚ï¼Œè®°å½•ç›‘å¬å…³ç³»     â”‚
â”‚ 2. æ•°æ®å˜åŒ–æ—¶æŸ¥æ‰¾ç›‘å¬å®¢æˆ·ç«¯   â”‚
â”‚ 3. å°è£…äº‹ä»¶ï¼Œæ¨é€é€šçŸ¥         â”‚
â”‚ 4. æ¸…ç†å·²è§¦å‘çš„ç›‘å¬è®°å½•       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é€šä¿¡è¿‡ç¨‹ï¼š
è¯·æ±‚ï¼šSetDataRequest { path="/config", data=xxx, watch=true }
é€šçŸ¥ï¼šWatcherEvent { type=NodeDataChanged, path="/config" }
```

---

## 3. ğŸ“¢ äº‹ä»¶é€šçŸ¥æœºåˆ¶


### 3.1 äº‹ä»¶é€šçŸ¥çš„å†…å®¹


**äº‹ä»¶åŒ…å«çš„ä¿¡æ¯**ï¼š

```
WatchedEventäº‹ä»¶å¯¹è±¡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”¸ äº‹ä»¶ç±»å‹ï¼ˆEventTypeï¼‰         â”‚
â”‚    - NodeCreatedï¼ˆèŠ‚ç‚¹åˆ›å»ºï¼‰     â”‚
â”‚    - NodeDeletedï¼ˆèŠ‚ç‚¹åˆ é™¤ï¼‰     â”‚
â”‚    - NodeDataChangedï¼ˆæ•°æ®å˜åŒ–ï¼‰ â”‚
â”‚    - NodeChildrenChangedï¼ˆå­èŠ‚ç‚¹å˜åŒ–ï¼‰ â”‚
â”‚                                 â”‚
â”‚ ğŸ”¸ èŠ‚ç‚¹è·¯å¾„ï¼ˆPathï¼‰              â”‚
â”‚    - å‘ç”Ÿå˜åŒ–çš„èŠ‚ç‚¹è·¯å¾„          â”‚
â”‚                                 â”‚
â”‚ ğŸ”¸ è¿æ¥çŠ¶æ€ï¼ˆKeeperStateï¼‰       â”‚
â”‚    - å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„è¿æ¥çŠ¶æ€    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç¤ºä¾‹äº‹ä»¶**ï¼š

```java
// æ”¶åˆ°çš„äº‹ä»¶å¯¹è±¡
WatchedEvent{
    eventType = NodeDataChanged,    // æ•°æ®å˜åŒ–äº‹ä»¶
    path = "/config/database",      // å˜åŒ–çš„èŠ‚ç‚¹è·¯å¾„
    state = SyncConnected           // è¿æ¥çŠ¶æ€æ­£å¸¸
}
```

> ğŸ’¡ **æ³¨æ„**ï¼šäº‹ä»¶é€šçŸ¥åªå‘Šè¯‰ä½ "ä»€ä¹ˆå˜äº†"ï¼Œä¸ä¼šå‘Šè¯‰ä½ "å˜æˆä»€ä¹ˆäº†"ï¼Œéœ€è¦è‡ªå·±å†æ¬¡è·å–æ•°æ®ã€‚

### 3.2 äº‹ä»¶ç±»å‹è¯¦è§£


**ä¸åŒæ“ä½œè§¦å‘çš„äº‹ä»¶**ï¼š

| æ“ä½œç±»å‹ | è§¦å‘äº‹ä»¶ | è¯´æ˜ |
|---------|---------|------|
| `create("/node")` | **NodeCreated** | èŠ‚ç‚¹è¢«åˆ›å»º |
| `delete("/node")` | **NodeDeleted** | èŠ‚ç‚¹è¢«åˆ é™¤ |
| `setData("/node")` | **NodeDataChanged** | èŠ‚ç‚¹æ•°æ®æ”¹å˜ |
| `create("/parent/child")` | **NodeChildrenChanged** | çˆ¶èŠ‚ç‚¹çš„å­èŠ‚ç‚¹å˜åŒ– |
| `delete("/parent/child")` | **NodeChildrenChanged** | çˆ¶èŠ‚ç‚¹çš„å­èŠ‚ç‚¹å˜åŒ– |

**äº‹ä»¶è§¦å‘ç¤ºä¾‹**ï¼š

```
åˆå§‹çŠ¶æ€ï¼š
/config
â”œâ”€â”€ database (å€¼: mysql)
â””â”€â”€ cache (å€¼: redis)

æ“ä½œ1ï¼šsetData("/config/database", "postgres")
è§¦å‘äº‹ä»¶ï¼šNodeDataChanged on "/config/database"

æ“ä½œ2ï¼šcreate("/config/mq", "rabbitmq")
è§¦å‘äº‹ä»¶ï¼šNodeChildrenChanged on "/config"

æ“ä½œ3ï¼šdelete("/config/cache")
è§¦å‘äº‹ä»¶ï¼šNodeDeleted on "/config/cache"
        NodeChildrenChanged on "/config"
```

### 3.3 é€šçŸ¥çš„å¯é æ€§ä¿è¯


**é¡ºåºæ€§ä¿è¯**ï¼š

```
Zookeeperä¿è¯ï¼š
âœ… åŒä¸€ä¸ªå®¢æˆ·ç«¯çš„äº‹ä»¶æŒ‰é¡ºåºæŠ•é€’
âœ… å…ˆçœ‹åˆ°çš„å˜åŒ–ï¼Œå…ˆæ”¶åˆ°é€šçŸ¥
âœ… ä¸ä¼šä¹±åº

ç¤ºä¾‹ï¼š
æ—¶é—´çº¿ï¼š
T1: setData("/config", "v1")  â†’ å®¢æˆ·ç«¯æ”¶åˆ°äº‹ä»¶1
T2: setData("/config", "v2")  â†’ å®¢æˆ·ç«¯æ”¶åˆ°äº‹ä»¶2
T3: setData("/config", "v3")  â†’ å®¢æˆ·ç«¯æ”¶åˆ°äº‹ä»¶3

å®¢æˆ·ç«¯æ”¶åˆ°é¡ºåºï¼šäº‹ä»¶1 â†’ äº‹ä»¶2 â†’ äº‹ä»¶3 âœ“
```

> âš ï¸ **æ³¨æ„**ï¼šä¸åŒå®¢æˆ·ç«¯ä¹‹é—´çš„äº‹ä»¶é¡ºåºä¸ä¿è¯ï¼Œåªä¿è¯å•ä¸ªå®¢æˆ·ç«¯å†…éƒ¨çš„é¡ºåºã€‚

---

## 4. ğŸ”„ ä¸€æ¬¡æ€§è§¦å‘ç‰¹æ€§


### 4.1 ä»€ä¹ˆæ˜¯ä¸€æ¬¡æ€§è§¦å‘


**æ ¸å¿ƒç‰¹æ€§**ï¼šWatcherè§¦å‘ä¸€æ¬¡åè‡ªåŠ¨å¤±æ•ˆï¼Œä¸ä¼šé‡å¤è§¦å‘ã€‚

```
ç›‘å¬ç”Ÿå‘½å‘¨æœŸï¼š
æ³¨å†Œç›‘å¬ â†’ è§¦å‘ä¸€æ¬¡ â†’ è‡ªåŠ¨å¤±æ•ˆ âŒ

ç¤ºä¾‹æµç¨‹ï¼š
æ—¶åˆ»1: æ³¨å†Œç›‘å¬ getData("/config", watcher) âœ…
æ—¶åˆ»2: ä¿®æ”¹æ•°æ® setData("/config", "v1")    â†’ è§¦å‘watcher âœ“
æ—¶åˆ»3: å†æ¬¡ä¿®æ”¹ setData("/config", "v2")    â†’ ä¸è§¦å‘ âœ—ï¼ˆå·²å¤±æ•ˆï¼‰
```

**ä¸ºä»€ä¹ˆè®¾è®¡æˆä¸€æ¬¡æ€§**ï¼š

```
è®¾è®¡åŸå› ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1ï¸âƒ£ é¿å…å®¢æˆ·ç«¯é€šçŸ¥é£æš´             â”‚
â”‚    - é¢‘ç¹å˜åŒ–ä¼šå¯¼è‡´å¤§é‡é€šçŸ¥       â”‚
â”‚    - å®¢æˆ·ç«¯å¯èƒ½å¤„ç†ä¸è¿‡æ¥         â”‚
â”‚                                  â”‚
â”‚ 2ï¸âƒ£ å‡è½»æœåŠ¡ç«¯å‹åŠ›                â”‚
â”‚    - ä¸éœ€è¦ç»´æŠ¤æ°¸ä¹…ç›‘å¬å…³ç³»       â”‚
â”‚    - å†…å­˜å ç”¨æ›´å°                 â”‚
â”‚                                  â”‚
â”‚ 3ï¸âƒ£ å¼ºåˆ¶å®¢æˆ·ç«¯é‡æ–°è·å–æœ€æ–°æ•°æ®     â”‚
â”‚    - ä¿è¯æ•°æ®ä¸€è‡´æ€§               â”‚
â”‚    - é¿å…ä½¿ç”¨è¿‡æœŸä¿¡æ¯             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 æŒç»­ç›‘å¬çš„å®ç°æ–¹å¼


**æ–¹å¼1ï¼šåœ¨å›è°ƒä¸­é‡æ–°æ³¨å†Œ**

```java
public class ConfigWatcher implements Watcher {
    private ZooKeeper zk;
    
    @Override
    public void process(WatchedEvent event) {
        if (event.getType() == Event.EventType.NodeDataChanged) {
            try {
                // å¤„ç†å˜åŒ–
                byte[] data = zk.getData(event.getPath(), this, null);
                System.out.println("æ–°æ•°æ®ï¼š" + new String(data));
                
                // å…³é”®ï¼šé‡æ–°æ³¨å†Œç›‘å¬ï¼ˆä¼ å…¥thisï¼‰
                // è¿™æ ·ä¸‹æ¬¡å˜åŒ–è¿˜èƒ½æ”¶åˆ°é€šçŸ¥
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }
}

// ä½¿ç”¨
ConfigWatcher watcher = new ConfigWatcher(zk);
zk.getData("/config", watcher, null); // é¦–æ¬¡æ³¨å†Œ
```

**æ–¹å¼2ï¼šä½¿ç”¨å¾ªç¯æ³¨å†Œ**

```java
// æŒç»­ç›‘å¬é…ç½®å˜åŒ–
public void watchConfig() {
    Watcher watcher = new Watcher() {
        @Override
        public void process(WatchedEvent event) {
            // å¤„ç†äº‹ä»¶
            System.out.println("é…ç½®å˜åŒ–ï¼š" + event);
            
            // é‡æ–°ç›‘å¬
            try {
                zk.getData("/config", this, null);
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    };
    
    // é¦–æ¬¡æ³¨å†Œ
    zk.getData("/config", watcher, null);
}
```

> ğŸ’¡ **æœ€ä½³å®è·µ**ï¼šåœ¨æ”¶åˆ°é€šçŸ¥åç«‹å³é‡æ–°æ³¨å†Œï¼Œé¿å…é”™è¿‡ä¸­é—´çš„å˜åŒ–ã€‚

### 4.3 ä¸€æ¬¡æ€§è§¦å‘çš„å¸¸è§é™·é˜±


**é™·é˜±1ï¼šå¿˜è®°é‡æ–°æ³¨å†Œ**

```java
// âŒ é”™è¯¯åšæ³•
zk.getData("/config", event -> {
    System.out.println("æ•°æ®å˜äº†");
    // å¿˜è®°é‡æ–°æ³¨å†Œï¼Œåªèƒ½æ”¶åˆ°ä¸€æ¬¡é€šçŸ¥
}, null);

// âœ… æ­£ç¡®åšæ³•
zk.getData("/config", new Watcher() {
    @Override
    public void process(WatchedEvent event) {
        System.out.println("æ•°æ®å˜äº†");
        // é‡æ–°æ³¨å†Œ
        zk.getData("/config", this, null);
    }
}, null);
```

**é™·é˜±2ï¼šé‡æ–°æ³¨å†Œæ—¶æœºé”™è¯¯**

```java
// âŒ å¯èƒ½æ¼æ‰äº‹ä»¶
getData("/config", watcher);  // è·å–æ•°æ®
Thread.sleep(1000);           // å»¶è¿Ÿ
getData("/config", watcher);  // é‡æ–°æ³¨å†Œï¼ˆæœŸé—´å¯èƒ½æœ‰å˜åŒ–ï¼‰

// âœ… æ­£ç¡®ï¼šç«‹å³é‡æ–°æ³¨å†Œ
getData("/config", new Watcher() {
    public void process(WatchedEvent event) {
        getData("/config", this, null); // é©¬ä¸Šé‡æ–°æ³¨å†Œ
    }
});
```

---

## 5. ğŸ¯ å®¢æˆ·ç«¯å›è°ƒæœºåˆ¶


### 5.1 å›è°ƒæ‰§è¡Œæµç¨‹


**å®Œæ•´çš„å›è°ƒæµç¨‹**ï¼š

```
äº‹ä»¶è§¦å‘ â†’ å®¢æˆ·ç«¯æ¥æ”¶ â†’ æŸ¥æ‰¾Watcher â†’ æ‰§è¡Œå›è°ƒ

è¯¦ç»†æ­¥éª¤ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ZookeeperæœåŠ¡ç«¯æ£€æµ‹åˆ°å˜åŒ–         â”‚
â”‚    â†“                                â”‚
â”‚ 2. å°è£…WatchedEventäº‹ä»¶              â”‚
â”‚    â†“                                â”‚
â”‚ 3. æ¨é€ç»™æ³¨å†Œçš„å®¢æˆ·ç«¯                â”‚
â”‚    â†“                                â”‚
â”‚ 4. å®¢æˆ·ç«¯EventThreadæ¥æ”¶äº‹ä»¶         â”‚
â”‚    â†“                                â”‚
â”‚ 5. ä»æœ¬åœ°Mapä¸­æŸ¥æ‰¾å¯¹åº”Watcher        â”‚
â”‚    â†“                                â”‚
â”‚ 6. è°ƒç”¨process(event)æ–¹æ³•           â”‚
â”‚    â†“                                â”‚
â”‚ 7. ç§»é™¤å·²è§¦å‘çš„Watcher               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 å›è°ƒå‡½æ•°çš„å®ç°æ–¹å¼


**æ–¹å¼1ï¼šåŒ¿åå†…éƒ¨ç±»**

```java
zk.getData("/config", new Watcher() {
    @Override
    public void process(WatchedEvent event) {
        // å¤„ç†äº‹ä»¶
        System.out.println("æ”¶åˆ°äº‹ä»¶ï¼š" + event.getType());
    }
}, null);
```

**æ–¹å¼2ï¼šLambdaè¡¨è¾¾å¼ï¼ˆæ¨èï¼‰**

```java
zk.getData("/config", event -> {
    System.out.println("é…ç½®å˜åŒ–ï¼š" + event.getPath());
    // å¤„ç†é€»è¾‘
}, null);
```

**æ–¹å¼3ï¼šç‹¬ç«‹çš„Watcherç±»**

```java
public class MyWatcher implements Watcher {
    @Override
    public void process(WatchedEvent event) {
        switch (event.getType()) {
            case NodeDataChanged:
                handleDataChange(event);
                break;
            case NodeDeleted:
                handleNodeDelete(event);
                break;
        }
    }
    
    private void handleDataChange(WatchedEvent event) {
        // å¤„ç†æ•°æ®å˜åŒ–
    }
}

// ä½¿ç”¨
MyWatcher watcher = new MyWatcher();
zk.getData("/config", watcher, null);
```

### 5.3 å›è°ƒæ‰§è¡Œçš„çº¿ç¨‹æ¨¡å‹


**EventThreadå·¥ä½œæœºåˆ¶**ï¼š

```
å®¢æˆ·ç«¯çº¿ç¨‹æ¨¡å‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SendThreadï¼š                       â”‚
â”‚ - å‘é€è¯·æ±‚                         â”‚
â”‚ - æ¥æ”¶å“åº”                         â”‚
â”‚                                    â”‚
â”‚ EventThreadï¼š                      â”‚
â”‚ - ä¸“é—¨å¤„ç†äº‹ä»¶                     â”‚
â”‚ - æ‰§è¡ŒWatcherå›è°ƒ                  â”‚
â”‚ - å•çº¿ç¨‹ä¸²è¡Œå¤„ç†                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

äº‹ä»¶é˜Ÿåˆ—ï¼š
[äº‹ä»¶1] â†’ [äº‹ä»¶2] â†’ [äº‹ä»¶3] â†’ EventThreadå¤„ç†
          â†“
      æŒ‰é¡ºåºæ‰§è¡Œå›è°ƒ
```

> âš ï¸ **é‡è¦**ï¼šå›è°ƒæ˜¯å•çº¿ç¨‹ä¸²è¡Œæ‰§è¡Œçš„ï¼Œä¸è¦åœ¨å›è°ƒä¸­åšè€—æ—¶æ“ä½œï¼Œä¼šé˜»å¡åç»­äº‹ä»¶å¤„ç†ï¼

**æ­£ç¡®çš„å›è°ƒå¤„ç†æ–¹å¼**ï¼š

```java
// âŒ é”™è¯¯ï¼šé˜»å¡EventThread
zk.getData("/config", event -> {
    // è€—æ—¶æ“ä½œï¼Œé˜»å¡äº‹ä»¶çº¿ç¨‹
    Thread.sleep(5000);
    updateConfig(event);
}, null);

// âœ… æ­£ç¡®ï¼šå¼‚æ­¥å¤„ç†
ExecutorService executor = Executors.newFixedThreadPool(10);

zk.getData("/config", event -> {
    // æäº¤åˆ°çº¿ç¨‹æ± å¼‚æ­¥å¤„ç†
    executor.submit(() -> {
        updateConfig(event);
    });
}, null);
```

---

## 6. ğŸ” ç›‘å¬ç±»å‹è¯¦è§£


### 6.1 æ•°æ®å˜åŒ–ç›‘å¬


**ä½¿ç”¨getDataæ³¨å†Œ**ï¼š

```java
// ç›‘å¬èŠ‚ç‚¹æ•°æ®å˜åŒ–
byte[] data = zk.getData("/config", event -> {
    if (event.getType() == Event.EventType.NodeDataChanged) {
        System.out.println("æ•°æ®å˜äº†");
        // é‡æ–°è·å–æœ€æ–°æ•°æ®
        byte[] newData = zk.getData("/config", this, null);
    }
}, null);
```

**è§¦å‘åœºæ™¯**ï¼š

```
âœ… è§¦å‘äº‹ä»¶çš„æ“ä½œï¼š
- setData("/config", newData)  â†’ NodeDataChanged

âŒ ä¸è§¦å‘çš„æ“ä½œï¼š
- create("/config")            â†’ ä¸è§¦å‘ï¼ˆç”¨existsç›‘å¬ï¼‰
- delete("/config")            â†’ ä¸è§¦å‘ï¼ˆç”¨existsç›‘å¬ï¼‰
- create("/config/child")      â†’ ä¸è§¦å‘ï¼ˆå­èŠ‚ç‚¹å˜åŒ–ï¼‰
```

### 6.2 èŠ‚ç‚¹å­˜åœ¨æ€§ç›‘å¬


**ä½¿ç”¨existsæ³¨å†Œ**ï¼š

```java
// ç›‘å¬èŠ‚ç‚¹åˆ›å»ºå’Œåˆ é™¤
Stat stat = zk.exists("/temp", event -> {
    switch (event.getType()) {
        case NodeCreated:
            System.out.println("èŠ‚ç‚¹è¢«åˆ›å»ºäº†");
            break;
        case NodeDeleted:
            System.out.println("èŠ‚ç‚¹è¢«åˆ é™¤äº†");
            break;
        case NodeDataChanged:
            System.out.println("èŠ‚ç‚¹æ•°æ®å˜äº†");
            break;
    }
    // é‡æ–°ç›‘å¬
    zk.exists("/temp", this);
}, null);
```

**è§¦å‘åœºæ™¯**ï¼š

```
âœ… existså¯ä»¥ç›‘å¬ï¼š
- create("/temp")      â†’ NodeCreated
- delete("/temp")      â†’ NodeDeleted  
- setData("/temp")     â†’ NodeDataChanged

ç‰¹ç‚¹ï¼šexistså¯ä»¥ç›‘å¬ä¸å­˜åœ¨çš„èŠ‚ç‚¹ï¼
```

**å®ç”¨åœºæ™¯ï¼šç­‰å¾…èŠ‚ç‚¹åˆ›å»º**

```java
// ç­‰å¾…æŸä¸ªèŠ‚ç‚¹è¢«åˆ›å»º
CountDownLatch latch = new CountDownLatch(1);

zk.exists("/task/ready", event -> {
    if (event.getType() == Event.EventType.NodeCreated) {
        System.out.println("ä»»åŠ¡å‡†å¤‡å°±ç»ª");
        latch.countDown();
    }
}, null);

// é˜»å¡ç­‰å¾…
latch.await();
```

### 6.3 å­èŠ‚ç‚¹å˜åŒ–ç›‘å¬


**ä½¿ç”¨getChildrenæ³¨å†Œ**ï¼š

```java
// ç›‘å¬å­èŠ‚ç‚¹åˆ—è¡¨å˜åŒ–
List<String> children = zk.getChildren("/servers", event -> {
    if (event.getType() == Event.EventType.NodeChildrenChanged) {
        System.out.println("æœåŠ¡å™¨åˆ—è¡¨å˜åŒ–");
        // é‡æ–°è·å–å­èŠ‚ç‚¹åˆ—è¡¨
        List<String> newChildren = zk.getChildren("/servers", this);
        System.out.println("å½“å‰æœåŠ¡å™¨ï¼š" + newChildren);
    }
}, null);
```

**è§¦å‘åœºæ™¯**ï¼š

```
âœ… è§¦å‘äº‹ä»¶çš„æ“ä½œï¼š
- create("/servers/s1")    â†’ NodeChildrenChanged on /servers
- delete("/servers/s1")    â†’ NodeChildrenChanged on /servers

âŒ ä¸è§¦å‘çš„æ“ä½œï¼š
- setData("/servers/s1")   â†’ ä¸è§¦å‘ï¼ˆå­èŠ‚ç‚¹æ•°æ®å˜åŒ–ä¸å½±å“åˆ—è¡¨ï¼‰
- delete("/servers")       â†’ ä¸è§¦å‘ï¼ˆçˆ¶èŠ‚ç‚¹è¢«åˆ é™¤ï¼‰
```

**ç›‘å¬ç±»å‹å¯¹æ¯”è¡¨**ï¼š

| æ³¨å†Œæ–¹æ³• | å¯ç›‘å¬äº‹ä»¶ | æ˜¯å¦ç›‘å¬ä¸å­˜åœ¨èŠ‚ç‚¹ | å…¸å‹åœºæ™¯ |
|---------|-----------|------------------|---------|
| **getData** | NodeDataChanged | âŒ å¦ | é…ç½®ç›‘å¬ |
| **exists** | NodeCreated<br/>NodeDeleted<br/>NodeDataChanged | âœ… æ˜¯ | çŠ¶æ€ç›‘å¬ |
| **getChildren** | NodeChildrenChanged | âŒ å¦ | æœåŠ¡å‘ç° |

---

## 7. ğŸš€ å®é™…åº”ç”¨åœºæ™¯


### 7.1 é…ç½®ä¸­å¿ƒå®ç°


**åœºæ™¯**ï¼šæ‰€æœ‰æœåŠ¡ç›‘å¬é…ç½®èŠ‚ç‚¹ï¼Œé…ç½®å˜åŒ–æ—¶è‡ªåŠ¨æ›´æ–°

```java
public class ConfigCenter {
    private ZooKeeper zk;
    private Properties config = new Properties();
    
    public void start() throws Exception {
        zk = new ZooKeeper("localhost:2181", 3000, null);
        
        // åˆå§‹åŠ è½½é…ç½®
        loadConfig();
        
        // ç›‘å¬é…ç½®å˜åŒ–
        watchConfig();
    }
    
    private void loadConfig() throws Exception {
        byte[] data = zk.getData("/config", false, null);
        // è§£æé…ç½®
        config.load(new ByteArrayInputStream(data));
    }
    
    private void watchConfig() throws Exception {
        zk.getData("/config", event -> {
            if (event.getType() == Event.EventType.NodeDataChanged) {
                try {
                    System.out.println("é…ç½®æ›´æ–°ï¼Œé‡æ–°åŠ è½½...");
                    loadConfig();
                    // é‡æ–°ç›‘å¬
                    watchConfig();
                } catch (Exception e) {
                    e.printStackTrace();
                }
            }
        }, null);
    }
    
    public String getConfig(String key) {
        return config.getProperty(key);
    }
}
```

**å·¥ä½œæµç¨‹**ï¼š

```
é…ç½®å˜åŒ–æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç®¡ç†å‘˜ä¿®æ”¹é…ç½®                        â”‚
â”‚   â†“                                  â”‚
â”‚ Zookeeperä¿å­˜æ–°é…ç½®                   â”‚
â”‚   â†“                                  â”‚
â”‚ æ¨é€å˜åŒ–é€šçŸ¥ç»™æ‰€æœ‰ç›‘å¬çš„æœåŠ¡           â”‚
â”‚   â†“                                  â”‚
â”‚ å„æœåŠ¡æ”¶åˆ°é€šçŸ¥ï¼Œé‡æ–°åŠ è½½é…ç½®           â”‚
â”‚   â†“                                  â”‚
â”‚ æœåŠ¡ä½¿ç”¨æ–°é…ç½®è¿è¡Œ                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 æœåŠ¡å‘ç°ä¸æ³¨å†Œ


**åœºæ™¯**ï¼šåŠ¨æ€æ„ŸçŸ¥æœåŠ¡ä¸Šä¸‹çº¿

```java
public class ServiceDiscovery {
    private ZooKeeper zk;
    private List<String> serverList = new ArrayList<>();
    
    public void start() throws Exception {
        zk = new ZooKeeper("localhost:2181", 3000, null);
        
        // è·å–å¹¶ç›‘å¬æœåŠ¡åˆ—è¡¨
        discoverServers();
    }
    
    private void discoverServers() throws Exception {
        List<String> children = zk.getChildren("/servers", event -> {
            if (event.getType() == Event.EventType.NodeChildrenChanged) {
                try {
                    System.out.println("æœåŠ¡åˆ—è¡¨å˜åŒ–ï¼Œæ›´æ–°æœ¬åœ°ç¼“å­˜");
                    discoverServers(); // é‡æ–°è·å–å¹¶ç›‘å¬
                } catch (Exception e) {
                    e.printStackTrace();
                }
            }
        });
        
        // æ›´æ–°æœ¬åœ°æœåŠ¡åˆ—è¡¨
        serverList.clear();
        for (String child : children) {
            byte[] data = zk.getData("/servers/" + child, false, null);
            serverList.add(new String(data)); // æœåŠ¡åœ°å€
        }
        
        System.out.println("å½“å‰å¯ç”¨æœåŠ¡ï¼š" + serverList);
    }
    
    public String getServer() {
        // è´Ÿè½½å‡è¡¡é€‰æ‹©ä¸€ä¸ªæœåŠ¡
        return serverList.get(new Random().nextInt(serverList.size()));
    }
}
```

**åŠ¨æ€æ•ˆæœ**ï¼š

```
åˆå§‹çŠ¶æ€ï¼š
/servers
â”œâ”€â”€ server1 (192.168.1.100:8080)
â””â”€â”€ server2 (192.168.1.101:8080)
â†’ å®¢æˆ·ç«¯ç¼“å­˜ï¼š[192.168.1.100:8080, 192.168.1.101:8080]

æ–°æœåŠ¡ä¸Šçº¿ï¼š
create /servers/server3 (192.168.1.102:8080)
â†’ è§¦å‘NodeChildrenChangedäº‹ä»¶
â†’ å®¢æˆ·ç«¯è‡ªåŠ¨æ›´æ–°ï¼š[..., 192.168.1.102:8080]

æœåŠ¡ä¸‹çº¿ï¼š
delete /servers/server1
â†’ è§¦å‘NodeChildrenChangedäº‹ä»¶  
â†’ å®¢æˆ·ç«¯è‡ªåŠ¨æ›´æ–°ï¼š[192.168.1.101:8080, 192.168.1.102:8080]
```

### 7.3 åˆ†å¸ƒå¼é”çŠ¶æ€ç›‘å¬


**åœºæ™¯**ï¼šç›‘å¬é”é‡Šæ”¾ï¼Œè‡ªåŠ¨è·å–é”

```java
public class DistributedLock {
    private ZooKeeper zk;
    private String lockPath;
    private String currentNode;
    
    public void lock() throws Exception {
        // åˆ›å»ºä¸´æ—¶é¡ºåºèŠ‚ç‚¹
        currentNode = zk.create("/lock/seq-", new byte[0], 
            ZooDefs.Ids.OPEN_ACL_UNSAFE, 
            CreateMode.EPHEMERAL_SEQUENTIAL);
        
        tryLock();
    }
    
    private void tryLock() throws Exception {
        List<String> children = zk.getChildren("/lock", false);
        Collections.sort(children);
        
        // åˆ¤æ–­æ˜¯å¦æ˜¯æœ€å°èŠ‚ç‚¹
        if (currentNode.endsWith(children.get(0))) {
            System.out.println("è·å¾—é”");
            return;
        }
        
        // æ‰¾åˆ°å‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç›‘å¬å®ƒ
        String prevNode = null;
        for (int i = 0; i < children.size(); i++) {
            if (currentNode.endsWith(children.get(i))) {
                prevNode = children.get(i - 1);
                break;
            }
        }
        
        // ç›‘å¬å‰ä¸€ä¸ªèŠ‚ç‚¹çš„åˆ é™¤äº‹ä»¶
        CountDownLatch latch = new CountDownLatch(1);
        zk.exists("/lock/" + prevNode, event -> {
            if (event.getType() == Event.EventType.NodeDeleted) {
                latch.countDown();
            }
        });
        
        System.out.println("ç­‰å¾…å‰é¢çš„é”é‡Šæ”¾...");
        latch.await();
        
        // å‰é¢çš„é”é‡Šæ”¾äº†ï¼Œå°è¯•è·å–
        tryLock();
    }
    
    public void unlock() throws Exception {
        zk.delete(currentNode, -1);
        System.out.println("é‡Šæ”¾é”");
    }
}
```

**å·¥ä½œæœºåˆ¶**ï¼š

```
é”ç«äº‰æµç¨‹ï¼š
å®¢æˆ·ç«¯A â†’ seq-0000000001 (æœ€å°ï¼Œè·å¾—é”) âœ…
å®¢æˆ·ç«¯B â†’ seq-0000000002 (ç›‘å¬èŠ‚ç‚¹1) â³
å®¢æˆ·ç«¯C â†’ seq-0000000003 (ç›‘å¬èŠ‚ç‚¹2) â³

å®¢æˆ·ç«¯Aé‡Šæ”¾é” â†’ åˆ é™¤èŠ‚ç‚¹1
    â†“
è§¦å‘å®¢æˆ·ç«¯Bçš„ç›‘å¬ â†’ å®¢æˆ·ç«¯Bè·å¾—é” âœ…
    â†“
å®¢æˆ·ç«¯Bé‡Šæ”¾é” â†’ åˆ é™¤èŠ‚ç‚¹2
    â†“  
è§¦å‘å®¢æˆ·ç«¯Cçš„ç›‘å¬ â†’ å®¢æˆ·ç«¯Cè·å¾—é” âœ…
```

---

## 8. âš ï¸ ä½¿ç”¨æ³¨æ„äº‹é¡¹


### 8.1 å›è°ƒä¸­çš„å¼‚å¸¸å¤„ç†


**é—®é¢˜**ï¼šå›è°ƒæŠ›å¼‚å¸¸ä¼šå½±å“EventThread

```java
// âŒ å±é™©ï¼šå¼‚å¸¸æœªæ•è·
zk.getData("/config", event -> {
    String value = new String(zk.getData(event.getPath(), false, null));
    int number = Integer.parseInt(value); // å¯èƒ½æŠ›NumberFormatException
    // å¼‚å¸¸ä¼šå¯¼è‡´EventThreadåœæ­¢å·¥ä½œ
}, null);

// âœ… å®‰å…¨ï¼šæ•è·æ‰€æœ‰å¼‚å¸¸
zk.getData("/config", event -> {
    try {
        String value = new String(zk.getData(event.getPath(), false, null));
        int number = Integer.parseInt(value);
    } catch (Exception e) {
        System.err.println("å¤„ç†äº‹ä»¶å¼‚å¸¸ï¼š" + e.getMessage());
        // è®°å½•æ—¥å¿—ï¼Œä½†ä¸å½±å“å…¶ä»–äº‹ä»¶
    }
}, null);
```

> ğŸ”´ **ä¸¥é‡è­¦å‘Š**ï¼šå›è°ƒä¸­çš„æœªæ•è·å¼‚å¸¸ä¼šå¯¼è‡´EventThreadå´©æºƒï¼Œåç»­æ‰€æœ‰äº‹ä»¶éƒ½æ— æ³•å¤„ç†ï¼

### 8.2 é¿å…å›è°ƒä¸­çš„è€—æ—¶æ“ä½œ


**é—®é¢˜**ï¼šEventThreadæ˜¯å•çº¿ç¨‹ï¼Œé˜»å¡ä¼šå½±å“æ‰€æœ‰äº‹ä»¶

```java
// âŒ é”™è¯¯ï¼šé˜»å¡EventThread
zk.getData("/config", event -> {
    // è€—æ—¶çš„æ•°æ®åº“æ“ä½œ
    updateDatabase(event); // å‡è®¾éœ€è¦3ç§’
    // è¿™3ç§’å†…ï¼Œæ‰€æœ‰å…¶ä»–äº‹ä»¶éƒ½æ— æ³•å¤„ç†
}, null);

// âœ… æ­£ç¡®ï¼šä½¿ç”¨çº¿ç¨‹æ± 
ExecutorService executor = Executors.newFixedThreadPool(10);

zk.getData("/config", event -> {
    // æäº¤åˆ°çº¿ç¨‹æ± ï¼Œä¸é˜»å¡EventThread
    executor.submit(() -> {
        try {
            updateDatabase(event);
        } catch (Exception e) {
            // å¤„ç†å¼‚å¸¸
        }
    });
}, null);
```

**æ€§èƒ½å¯¹æ¯”**ï¼š

```
é˜»å¡æ–¹å¼ï¼š
äº‹ä»¶1(3ç§’) â†’ äº‹ä»¶2(3ç§’) â†’ äº‹ä»¶3(3ç§’)
æ€»è€—æ—¶ï¼š9ç§’ âŒ

å¼‚æ­¥æ–¹å¼ï¼š
äº‹ä»¶1ã€2ã€3åŒæ—¶æäº¤åˆ°çº¿ç¨‹æ± 
æ€»è€—æ—¶ï¼šçº¦3ç§’ âœ…
```

### 8.3 é‡æ–°æ³¨å†Œçš„æ—¶æœº


**æ—¶æœºå¾ˆé‡è¦**ï¼š

```java
// âŒ é”™è¯¯ï¼šå¤„ç†å®Œå†æ³¨å†Œï¼ˆå¯èƒ½ä¸¢äº‹ä»¶ï¼‰
zk.getData("/config", event -> {
    byte[] data = zk.getData(event.getPath(), false, null);
    processData(data); // å¤„ç†æ•°æ®ï¼Œå‡è®¾1ç§’
    // è¿™1ç§’å†…å¦‚æœæ•°æ®åˆå˜äº†ï¼Œä¼šé”™è¿‡äº‹ä»¶
    zk.getData(event.getPath(), this, null); // é‡æ–°æ³¨å†Œ
}, null);

// âœ… æ­£ç¡®ï¼šå…ˆæ³¨å†Œå†å¤„ç†
zk.getData("/config", event -> {
    // ç«‹å³é‡æ–°æ³¨å†Œ
    byte[] data = zk.getData(event.getPath(), this, null);
    // ç„¶åå¤„ç†æ•°æ®
    processData(data);
}, null);
```

### 8.4 ç›‘å¬æ•°é‡çš„æ§åˆ¶


**é—®é¢˜**ï¼šè¿‡å¤šç›‘å¬å½±å“æ€§èƒ½

```
ç›‘å¬å¼€é”€ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®¢æˆ·ç«¯ï¼š                          â”‚
â”‚ - æ¯ä¸ªWatcherå ç”¨å†…å­˜             â”‚
â”‚ - äº‹ä»¶å¤„ç†æœ‰åºåˆ—åŒ–å¼€é”€            â”‚
â”‚                                  â”‚
â”‚ æœåŠ¡ç«¯ï¼š                          â”‚
â”‚ - ç»´æŠ¤ç›‘å¬å…³ç³»æ¶ˆè€—å†…å­˜            â”‚
â”‚ - äº‹ä»¶æ¨é€æ¶ˆè€—ç½‘ç»œå’ŒCPU           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å»ºè®®ï¼š
- é¿å…å¯¹å¤§é‡èŠ‚ç‚¹æ³¨å†Œç›‘å¬
- ä½¿ç”¨çˆ¶èŠ‚ç‚¹ç›‘å¬ä»£æ›¿å­èŠ‚ç‚¹é€ä¸ªç›‘å¬
- åŠæ—¶ç§»é™¤ä¸éœ€è¦çš„ç›‘å¬
```

**ä¼˜åŒ–ç¤ºä¾‹**ï¼š

```java
// âŒ ä½æ•ˆï¼šç›‘å¬æ¯ä¸ªå­èŠ‚ç‚¹
for (String child : children) {
    zk.getData("/servers/" + child, watcher, null);
}
// å¯èƒ½æœ‰æˆç™¾ä¸Šåƒä¸ªå­èŠ‚ç‚¹ï¼Œç›‘å¬å¼€é”€å¤§

// âœ… é«˜æ•ˆï¼šåªç›‘å¬çˆ¶èŠ‚ç‚¹
zk.getChildren("/servers", event -> {
    // å­èŠ‚ç‚¹å˜åŒ–æ—¶ç»Ÿä¸€å¤„ç†
    List<String> newChildren = zk.getChildren("/servers", this);
    updateServerList(newChildren);
}, null);
```

### 8.5 ç½‘ç»œåˆ†åŒºçš„å¤„ç†


**é—®é¢˜**ï¼šç½‘ç»œæ–­å¼€åçš„ç›‘å¬æ¢å¤

```java
// ç›‘æ§è¿æ¥çŠ¶æ€
zk = new ZooKeeper("localhost:2181", 3000, event -> {
    if (event.getState() == Event.KeeperState.Disconnected) {
        System.out.println("è¿æ¥æ–­å¼€");
    } else if (event.getState() == Event.KeeperState.SyncConnected) {
        System.out.println("è¿æ¥æ¢å¤");
        // é‡æ–°æ³¨å†Œæ‰€æœ‰ç›‘å¬
        reRegisterWatchers();
    }
});

private void reRegisterWatchers() {
    try {
        // é‡æ–°æ³¨å†Œé…ç½®ç›‘å¬
        watchConfig();
        // é‡æ–°æ³¨å†ŒæœåŠ¡å‘ç°
        discoverServers();
    } catch (Exception e) {
        e.printStackTrace();
    }
}
```

> ğŸ’¡ **æœ€ä½³å®è·µ**ï¼šè¿æ¥æ¢å¤åï¼Œéœ€è¦é‡æ–°æ³¨å†Œæ‰€æœ‰ç›‘å¬ï¼Œå› ä¸ºæ–­å¼€æœŸé—´çš„ç›‘å¬å…³ç³»å·²å¤±æ•ˆã€‚

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Watcheræœ¬è´¨ï¼šåŸºäºäº‹ä»¶é©±åŠ¨çš„é€šçŸ¥æœºåˆ¶ï¼Œå®ç°è¢«åŠ¨æ„ŸçŸ¥
ğŸ”¸ ä¸€æ¬¡æ€§è§¦å‘ï¼šè§¦å‘ä¸€æ¬¡è‡ªåŠ¨å¤±æ•ˆï¼Œéœ€è¦é‡æ–°æ³¨å†ŒæŒç»­ç›‘å¬
ğŸ”¸ è½»é‡é€šçŸ¥ï¼šåªé€šçŸ¥å˜åŒ–ç±»å‹å’Œè·¯å¾„ï¼Œä¸åŒ…å«å˜åŒ–åçš„æ•°æ®
ğŸ”¸ å®¢æˆ·ç«¯å›è°ƒï¼šäº‹ä»¶å›è°ƒåœ¨å®¢æˆ·ç«¯EventThreadä¸­ä¸²è¡Œæ‰§è¡Œ
ğŸ”¸ ä¸‰ç§ç›‘å¬ï¼šgetDataç›‘å¬æ•°æ®ã€existsç›‘å¬å­˜åœ¨ã€getChildrenç›‘å¬å­èŠ‚ç‚¹
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆæ˜¯ä¸€æ¬¡æ€§è§¦å‘**

```
è®¾è®¡è€ƒè™‘ï¼š
âœ… é¿å…é€šçŸ¥é£æš´ï¼šé¢‘ç¹å˜åŒ–ä¸ä¼šäº§ç”Ÿå¤§é‡é€šçŸ¥
âœ… å‡è½»æœåŠ¡ç«¯å‹åŠ›ï¼šä¸éœ€è¦ç»´æŠ¤æ°¸ä¹…ç›‘å¬å…³ç³»
âœ… ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼šå¼ºåˆ¶å®¢æˆ·ç«¯é‡æ–°è·å–æœ€æ–°æ•°æ®

å®ç°æ–¹å¼ï¼š
åœ¨å›è°ƒä¸­é‡æ–°æ³¨å†Œ â†’ å®ç°æŒç»­ç›‘å¬æ•ˆæœ
```

**ğŸ”¹ äº‹ä»¶é€šçŸ¥çš„å†…å®¹**

```
åŒ…å«ä¿¡æ¯ï¼š
- äº‹ä»¶ç±»å‹ï¼ˆNodeCreated/NodeDeleted/NodeDataChangedç­‰ï¼‰
- èŠ‚ç‚¹è·¯å¾„ï¼ˆå“ªä¸ªèŠ‚ç‚¹å˜åŒ–äº†ï¼‰
- è¿æ¥çŠ¶æ€ï¼ˆå®¢æˆ·ç«¯è¿æ¥çŠ¶æ€ï¼‰

ä¸åŒ…å«ï¼š
âŒ å˜åŒ–åçš„æ–°æ•°æ®ï¼ˆéœ€è¦è‡ªå·±getDataï¼‰
âŒ å˜åŒ–å‰çš„æ—§æ•°æ®
âŒ è°ä¿®æ”¹çš„ï¼ˆå“ªä¸ªå®¢æˆ·ç«¯ï¼‰
```

**ğŸ”¹ å›è°ƒæ‰§è¡Œçš„æ³¨æ„äº‹é¡¹**

```
ä¸¥é‡é—®é¢˜ï¼š
ğŸ”´ å›è°ƒæŠ›å¼‚å¸¸ â†’ EventThreadå´©æºƒ â†’ æ‰€æœ‰äº‹ä»¶æ— æ³•å¤„ç†
ğŸ”´ å›è°ƒé˜»å¡ â†’ åç»­äº‹ä»¶å †ç§¯ â†’ ç³»ç»Ÿå“åº”å˜æ…¢

è§£å†³æ–¹æ¡ˆï¼š
âœ… ä½¿ç”¨try-catchæ•è·æ‰€æœ‰å¼‚å¸¸
âœ… è€—æ—¶æ“ä½œæäº¤åˆ°çº¿ç¨‹æ± å¼‚æ­¥å¤„ç†
âœ… å…ˆé‡æ–°æ³¨å†Œå†å¤„ç†ä¸šåŠ¡é€»è¾‘
```

### 9.3 å®é™…åº”ç”¨ä»·å€¼


**å…¸å‹åº”ç”¨åœºæ™¯**ï¼š

```
ğŸ“Œ é…ç½®ä¸­å¿ƒï¼š
- é…ç½®å˜åŒ–å®æ—¶æ¨é€
- æ‰€æœ‰æœåŠ¡è‡ªåŠ¨æ›´æ–°
- æ— éœ€é‡å¯åº”ç”¨

ğŸ“Œ æœåŠ¡å‘ç°ï¼š
- æœåŠ¡ä¸Šä¸‹çº¿å®æ—¶æ„ŸçŸ¥
- åŠ¨æ€æ›´æ–°æœåŠ¡åˆ—è¡¨
- å®ç°è´Ÿè½½å‡è¡¡

ğŸ“Œ åˆ†å¸ƒå¼é”ï¼š
- ç›‘å¬é”é‡Šæ”¾äº‹ä»¶
- æœ‰åºç«äº‰é”èµ„æº
- é¿å…æƒŠç¾¤æ•ˆåº”

ğŸ“Œ é›†ç¾¤ç›‘æ§ï¼š
- èŠ‚ç‚¹çŠ¶æ€å˜åŒ–é€šçŸ¥
- Masteré€‰ä¸¾æ„ŸçŸ¥
- æ•…éšœè‡ªåŠ¨åˆ‡æ¢
```

**å®ç°æ¨¡å¼**ï¼š

```
æ ¸å¿ƒæ¨¡å¼ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ³¨å†Œç›‘å¬                     â”‚
â”‚ 2. æ”¶åˆ°é€šçŸ¥                     â”‚
â”‚ 3. é‡æ–°æ³¨å†Œï¼ˆæŒç»­ç›‘å¬ï¼‰          â”‚
â”‚ 4. è·å–æœ€æ–°æ•°æ®                 â”‚
â”‚ 5. å¼‚æ­¥å¤„ç†ä¸šåŠ¡é€»è¾‘              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.4 æœ€ä½³å®è·µæ€»ç»“


```
âœ… DOï¼ˆåº”è¯¥åšçš„ï¼‰ï¼š
- ä½¿ç”¨try-catchä¿æŠ¤å›è°ƒå‡½æ•°
- è€—æ—¶æ“ä½œæäº¤åˆ°çº¿ç¨‹æ± 
- æ”¶åˆ°é€šçŸ¥åç«‹å³é‡æ–°æ³¨å†Œ
- ç›‘æ§è¿æ¥çŠ¶æ€ï¼Œæ–­çº¿é‡è¿åé‡æ–°æ³¨å†Œ
- åˆç†æ§åˆ¶ç›‘å¬æ•°é‡

âŒ DON'Tï¼ˆä¸è¯¥åšçš„ï¼‰ï¼š
- å›è°ƒä¸­æ‰§è¡Œé˜»å¡æ“ä½œ
- å¿˜è®°é‡æ–°æ³¨å†Œç›‘å¬
- å»¶è¿Ÿé‡æ–°æ³¨å†Œï¼ˆä¼šä¸¢äº‹ä»¶ï¼‰
- ç›‘å¬å¤§é‡èŠ‚ç‚¹
- å›è°ƒä¸­æŠ›æœªæ•è·å¼‚å¸¸
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
Watcherç›‘å¬æœ‰ä¸‰å®ï¼šä¸€æ¬¡è§¦å‘ã€å›è°ƒæ‰§è¡Œã€è½»é‡é€šçŸ¥
æŒç»­ç›‘å¬éœ€æŠ€å·§ï¼šæ”¶åˆ°é€šçŸ¥ç«‹å³æ³¨å†Œã€å¼‚æ­¥å¤„ç†ä¸é˜»å¡
ä¸‰ç§ç›‘å¬è¦è®°ç‰¢ï¼šgetDataæ•°æ®ã€existså­˜åœ¨ã€getChildrenå­èŠ‚ç‚¹
å®æˆ˜åº”ç”¨åœºæ™¯å¤šï¼šé…ç½®ä¸­å¿ƒã€æœåŠ¡å‘ç°ã€åˆ†å¸ƒå¼é”æ ·æ ·è¡Œ
```