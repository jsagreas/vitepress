---
title: 37ã€ç¼–ç¨‹æœ€ä½³å®è·µ
---
## ğŸ“š ç›®å½•

1. [è¿æ¥ç®¡ç†æœ€ä½³å®è·µ](#1-è¿æ¥ç®¡ç†æœ€ä½³å®è·µ)
2. [å¼‚å¸¸å¤„ç†ä¸é‡è¯•æœºåˆ¶](#2-å¼‚å¸¸å¤„ç†ä¸é‡è¯•æœºåˆ¶)
3. [Watcherç›‘å¬å™¨ç®¡ç†](#3-watcherç›‘å¬å™¨ç®¡ç†)
4. [èŠ‚ç‚¹è®¾è®¡è§„èŒƒ](#4-èŠ‚ç‚¹è®¾è®¡è§„èŒƒ)
5. [æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#5-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)
6. [èµ„æºç®¡ç†ä¸é‡Šæ”¾](#6-èµ„æºç®¡ç†ä¸é‡Šæ”¾)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”Œ è¿æ¥ç®¡ç†æœ€ä½³å®è·µ


### 1.1 ä¸ºä»€ä¹ˆéœ€è¦è¿æ¥æ± 


**ğŸŒ° ç”Ÿæ´»ç±»æ¯”**: 
æƒ³è±¡ä½ å»é“¶è¡ŒåŠä¸šåŠ¡ï¼Œå¦‚æœæ¯æ¬¡éƒ½è¦é‡æ–°æ’é˜Ÿå–å·ï¼Œæ•ˆç‡å¾ˆä½ã€‚ä½†å¦‚æœæœ‰VIPé€šé“ï¼ˆè¿æ¥æ± ï¼‰ï¼Œä½ å¯ä»¥ç›´æ¥ä½¿ç”¨é¢„å…ˆå‡†å¤‡å¥½çš„çª—å£ï¼Œæ•ˆç‡å°±é«˜å¤šäº†ã€‚

**æ ¸å¿ƒé—®é¢˜**: 
- æ¯æ¬¡åˆ›å»ºZookeeperè¿æ¥éƒ½å¾ˆè€—æ—¶ï¼ˆéœ€è¦å»ºç«‹TCPè¿æ¥ã€ä¼šè¯æ¡æ‰‹ç­‰ï¼‰
- é¢‘ç¹åˆ›å»º/é”€æ¯è¿æ¥ä¼šæµªè´¹ç³»ç»Ÿèµ„æº
- è¿æ¥æ•°è¿‡å¤šä¼šè¶…è¿‡ZookeeperæœåŠ¡å™¨çš„æ‰¿è½½èƒ½åŠ›

### 1.2 è¿æ¥æ± å®ç°æ–¹æ¡ˆ


#### åŸºç¡€è¿æ¥æ± è®¾è®¡


```
è¿æ¥æ± ç»“æ„ç¤ºæ„å›¾ï¼š

åº”ç”¨ç¨‹åº              è¿æ¥æ±                     Zookeeperé›†ç¾¤
   â”‚                   â”‚                           â”‚
   â”‚â”€â”€è¯·æ±‚è¿æ¥â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                           â”‚
   â”‚                   â”‚â”€â”€æ£€æŸ¥å¯ç”¨è¿æ¥              â”‚
   â”‚                   â”‚  â”œâ”€æœ‰ç©ºé—² â†’ ç›´æ¥è¿”å›       â”‚
   â”‚                   â”‚  â””â”€æ— ç©ºé—² â†’ åˆ›å»ºæ–°è¿æ¥â”€â”€â”€â”€â–¶â”‚
   â”‚â—€â”€è¿”å›è¿æ¥â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                           â”‚
   â”‚                   â”‚                           â”‚
   â”‚â”€â”€ä½¿ç”¨å®Œæ¯•â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                           â”‚
   â”‚                   â”‚â”€â”€æ”¾å›æ± ä¸­ï¼ˆä¸å…³é—­ï¼‰         â”‚
```

#### ç®€åŒ–ç‰ˆè¿æ¥æ± å®ç°


```java
// ç®€å•çš„Zookeeperè¿æ¥æ± 
public class ZKConnectionPool {
    
    // å­˜æ”¾ç©ºé—²è¿æ¥çš„é˜Ÿåˆ—
    private BlockingQueue<ZooKeeper> pool;
    
    // è¿æ¥é…ç½®
    private String connectString;  // Zookeeperåœ°å€
    private int sessionTimeout;    // ä¼šè¯è¶…æ—¶æ—¶é—´
    private int maxConnections;    // æœ€å¤§è¿æ¥æ•°
    
    public ZKConnectionPool(String connectString, int maxConnections) {
        this.connectString = connectString;
        this.sessionTimeout = 5000;  // 5ç§’è¶…æ—¶
        this.maxConnections = maxConnections;
        this.pool = new LinkedBlockingQueue<>(maxConnections);
        
        // é¢„åˆ›å»ºä¸€äº›è¿æ¥
        initPool();
    }
    
    // åˆå§‹åŒ–è¿æ¥æ± 
    private void initPool() {
        for (int i = 0; i < 3; i++) {  // å…ˆåˆ›å»º3ä¸ªè¿æ¥
            try {
                ZooKeeper zk = createConnection();
                pool.offer(zk);
            } catch (Exception e) {
                System.err.println("åˆå§‹åŒ–è¿æ¥å¤±è´¥: " + e.getMessage());
            }
        }
    }
    
    // åˆ›å»ºæ–°è¿æ¥
    private ZooKeeper createConnection() throws Exception {
        CountDownLatch latch = new CountDownLatch(1);
        
        ZooKeeper zk = new ZooKeeper(connectString, sessionTimeout, event -> {
            if (event.getState() == Watcher.Event.KeeperState.SyncConnected) {
                latch.countDown();  // è¿æ¥æˆåŠŸ
            }
        });
        
        latch.await(10, TimeUnit.SECONDS);  // ç­‰å¾…è¿æ¥å®Œæˆ
        return zk;
    }
    
    // è·å–è¿æ¥
    public ZooKeeper getConnection() throws Exception {
        ZooKeeper zk = pool.poll();  // å°è¯•ä»æ± ä¸­å–
        
        if (zk == null || !zk.getState().isAlive()) {
            // æ± ä¸­æ²¡æœ‰æˆ–è¿æ¥å¤±æ•ˆï¼Œåˆ›å»ºæ–°çš„
            zk = createConnection();
        }
        
        return zk;
    }
    
    // å½’è¿˜è¿æ¥
    public void returnConnection(ZooKeeper zk) {
        if (zk != null && zk.getState().isAlive()) {
            pool.offer(zk);  // æ”¾å›æ± ä¸­ï¼Œä¸å…³é—­
        }
    }
    
    // å…³é—­è¿æ¥æ± 
    public void close() {
        for (ZooKeeper zk : pool) {
            try {
                zk.close();
            } catch (Exception e) {
                // å¿½ç•¥å…³é—­å¼‚å¸¸
            }
        }
    }
}
```

**ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹**:
```java
// åˆ›å»ºè¿æ¥æ± 
ZKConnectionPool pool = new ZKConnectionPool("localhost:2181", 10);

// ä½¿ç”¨è¿æ¥
ZooKeeper zk = pool.getConnection();
try {
    // æ‰§è¡Œä¸šåŠ¡æ“ä½œ
    zk.create("/test", "data".getBytes(), ZooDefs.Ids.OPEN_ACL_UNSAFE, 
              CreateMode.PERSISTENT);
} finally {
    pool.returnConnection(zk);  // å½’è¿˜è¿æ¥
}
```

### 1.3 è¿æ¥æ± ä½¿ç”¨æ³¨æ„äº‹é¡¹


| æ³¨æ„ç‚¹ | **è¯´æ˜** | **å»ºè®®åšæ³•** |
|-------|---------|------------|
| ğŸ”¸ **è¿æ¥æ•°æ§åˆ¶** | `é¿å…åˆ›å»ºè¿‡å¤šè¿æ¥` | `æ ¹æ®ä¸šåŠ¡é‡è®¾ç½®åˆç†ä¸Šé™ï¼Œé€šå¸¸10-50ä¸ª` |
| ğŸ”¸ **è¿æ¥æ£€æµ‹** | `å®šæœŸæ£€æŸ¥è¿æ¥æ˜¯å¦å­˜æ´»` | `ä½¿ç”¨å¿ƒè·³æœºåˆ¶ï¼Œå‘ç°å¤±æ•ˆè¿æ¥åŠæ—¶æ¸…ç†` |
| ğŸ”¸ **è¶…æ—¶è®¾ç½®** | `è·å–è¿æ¥å¯èƒ½ç­‰å¾…` | `è®¾ç½®è·å–è¶…æ—¶æ—¶é—´ï¼Œé¿å…æ— é™ç­‰å¾…` |
| ğŸ”¸ **å¼‚å¸¸å¤„ç†** | `è¿æ¥å¯èƒ½å¤±æ•ˆ` | `æ•è·å¼‚å¸¸ï¼Œåˆ›å»ºæ–°è¿æ¥æˆ–é‡è¯•` |

---

## 2. ğŸ”„ å¼‚å¸¸å¤„ç†ä¸é‡è¯•æœºåˆ¶


### 2.1 å¸¸è§å¼‚å¸¸ç±»å‹


**Zookeeperæ“ä½œä¸­çš„å…¸å‹å¼‚å¸¸**:

```
å¼‚å¸¸åˆ†ç±»å›¾ï¼š

Zookeeperå¼‚å¸¸
    â”‚
    â”œâ”€ ç½‘ç»œç›¸å…³
    â”‚   â”œâ”€ ConnectionLossExceptionï¼ˆè¿æ¥ä¸¢å¤±ï¼‰
    â”‚   â”œâ”€ SessionExpiredExceptionï¼ˆä¼šè¯è¿‡æœŸï¼‰
    â”‚   â””â”€ OperationTimeoutExceptionï¼ˆæ“ä½œè¶…æ—¶ï¼‰
    â”‚
    â”œâ”€ èŠ‚ç‚¹ç›¸å…³  
    â”‚   â”œâ”€ NodeExistsExceptionï¼ˆèŠ‚ç‚¹å·²å­˜åœ¨ï¼‰
    â”‚   â”œâ”€ NoNodeExceptionï¼ˆèŠ‚ç‚¹ä¸å­˜åœ¨ï¼‰
    â”‚   â””â”€ NotEmptyExceptionï¼ˆèŠ‚ç‚¹éç©ºï¼Œæœ‰å­èŠ‚ç‚¹ï¼‰
    â”‚
    â””â”€ æƒé™ç›¸å…³
        â””â”€ NoAuthExceptionï¼ˆæ— æƒé™æ“ä½œï¼‰
```

**ğŸŒ° å¼‚å¸¸åœºæ™¯ä¸¾ä¾‹**:

```java
// åœºæ™¯1: åˆ›å»ºèŠ‚ç‚¹æ—¶ï¼ŒèŠ‚ç‚¹å¯èƒ½å·²å­˜åœ¨
try {
    zk.create("/config", data, ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);
} catch (NodeExistsException e) {
    // èŠ‚ç‚¹å·²å­˜åœ¨ï¼Œå¯ä»¥é€‰æ‹©æ›´æ–°æˆ–å¿½ç•¥
    System.out.println("èŠ‚ç‚¹å·²å­˜åœ¨ï¼Œè¿›è¡Œæ›´æ–°æ“ä½œ");
    zk.setData("/config", data, -1);
}

// åœºæ™¯2: ç½‘ç»œæŠ–åŠ¨å¯¼è‡´è¿æ¥ä¸¢å¤±
try {
    zk.getData("/config", false, null);
} catch (ConnectionLossException e) {
    // è¿æ¥ä¸¢å¤±ï¼Œéœ€è¦é‡è¯•
    System.out.println("è¿æ¥ä¸¢å¤±ï¼Œç­‰å¾…é‡æ–°è¿æ¥");
}
```

### 2.2 é‡è¯•æœºåˆ¶è®¾è®¡


#### æŒ‡æ•°é€€é¿é‡è¯•ç­–ç•¥


```
é‡è¯•æµç¨‹ç¤ºæ„ï¼š

ç¬¬1æ¬¡å°è¯• â”€å¤±è´¥â”€â–¶ ç­‰å¾…1ç§’ â”€â–¶ ç¬¬2æ¬¡å°è¯• â”€å¤±è´¥â”€â–¶ ç­‰å¾…2ç§’ â”€â–¶ ç¬¬3æ¬¡å°è¯•
                                                                â”‚
                                                            â”€å¤±è´¥â”€â–¶ ç­‰å¾…4ç§’
                                                                â”‚
                                                            â”€â–¶ ç¬¬4æ¬¡å°è¯•...
```

**ğŸ’¡ é‡è¯•å·¥å…·ç±»å®ç°**:

```java
public class RetryHelper {
    
    // é‡è¯•é…ç½®
    private int maxRetries = 3;           // æœ€å¤šé‡è¯•3æ¬¡
    private long initialDelay = 1000;     // åˆå§‹å»¶è¿Ÿ1ç§’
    private double multiplier = 2.0;      // æ¯æ¬¡ç¿»å€
    
    // æ‰§è¡Œå¸¦é‡è¯•çš„æ“ä½œ
    public <T> T execute(RetryableTask<T> task) throws Exception {
        long delay = initialDelay;
        Exception lastException = null;
        
        for (int i = 0; i <= maxRetries; i++) {
            try {
                return task.execute();  // æ‰§è¡Œä»»åŠ¡
            } catch (ConnectionLossException | SessionExpiredException e) {
                // å¯é‡è¯•çš„å¼‚å¸¸
                lastException = e;
                
                if (i < maxRetries) {
                    System.out.println("æ“ä½œå¤±è´¥ï¼Œ" + delay + "msåé‡è¯•...");
                    Thread.sleep(delay);
                    delay = (long) (delay * multiplier);  // æŒ‡æ•°å¢é•¿
                }
            } catch (Exception e) {
                // ä¸å¯é‡è¯•çš„å¼‚å¸¸ï¼Œç›´æ¥æŠ›å‡º
                throw e;
            }
        }
        
        throw new Exception("é‡è¯•" + maxRetries + "æ¬¡åä»ç„¶å¤±è´¥", lastException);
    }
    
    // å¯é‡è¯•çš„ä»»åŠ¡æ¥å£
    @FunctionalInterface
    public interface RetryableTask<T> {
        T execute() throws Exception;
    }
}
```

**ğŸš€ ä½¿ç”¨ç¤ºä¾‹**:
```java
RetryHelper retry = new RetryHelper();

// åˆ›å»ºèŠ‚ç‚¹ï¼Œå¸¦é‡è¯•
String path = retry.execute(() -> {
    return zk.create("/config", data, ZooDefs.Ids.OPEN_ACL_UNSAFE, 
                     CreateMode.PERSISTENT);
});

System.out.println("èŠ‚ç‚¹åˆ›å»ºæˆåŠŸ: " + path);
```

### 2.3 å¼‚å¸¸å¤„ç†æœ€ä½³å®è·µ


> âš ï¸ **é‡è¦åŸåˆ™**  
> 1. **åŒºåˆ†å¼‚å¸¸ç±»å‹**: ç½‘ç»œå¼‚å¸¸å¯é‡è¯•ï¼Œä¸šåŠ¡å¼‚å¸¸ä¸è¦é‡è¯•
> 2. **è®¾ç½®é‡è¯•ä¸Šé™**: é¿å…æ— é™é‡è¯•å¯¼è‡´é›ªå´©
> 3. **è®°å½•å¼‚å¸¸æ—¥å¿—**: ä¾¿äºæ’æŸ¥é—®é¢˜

---

## 3. ğŸ‘€ Watcherç›‘å¬å™¨ç®¡ç†


### 3.1 Watcherçš„æœ¬è´¨ç†è§£


**ğŸŒ° ç”Ÿæ´»ç±»æ¯”**:
Watcherå°±åƒä½ è®¢é˜…çš„æ–°é—»æ¨é€ï¼Œå½“æœ‰æ–°é—»æ—¶ä¼šé€šçŸ¥ä½ ï¼Œä½†åªé€šçŸ¥ä¸€æ¬¡ã€‚å¦‚æœä½ æƒ³ç»§ç»­æ”¶åˆ°é€šçŸ¥ï¼Œéœ€è¦é‡æ–°è®¢é˜…ã€‚

**æ ¸å¿ƒç‰¹ç‚¹**:
- **ä¸€æ¬¡æ€§è§¦å‘**: è§¦å‘ä¸€æ¬¡åå°±å¤±æ•ˆ
- **å¼‚æ­¥é€šçŸ¥**: ä¸ä¼šç«‹å³è¿”å›ç»“æœ
- **è½»é‡çº§**: ä¸ä¿å­˜æ•°æ®å˜åŒ–å†…å®¹ï¼Œåªé€šçŸ¥äº‹ä»¶ç±»å‹

### 3.2 Watcherçš„å‘ä¸è§£å†³æ–¹æ¡ˆ


#### å‘1: å¿˜è®°é‡æ–°æ³¨å†Œ


```java
// âŒ é”™è¯¯åšæ³•ï¼šåªèƒ½æ”¶åˆ°ä¸€æ¬¡é€šçŸ¥
zk.getData("/config", event -> {
    System.out.println("é…ç½®å˜åŒ–äº†ï¼");
    // å¿˜è®°é‡æ–°æ³¨å†Œï¼Œåç»­å˜åŒ–æ”¶ä¸åˆ°é€šçŸ¥
}, null);

// âœ… æ­£ç¡®åšæ³•ï¼šæ”¶åˆ°é€šçŸ¥åé‡æ–°æ³¨å†Œ
Watcher watcher = new Watcher() {
    @Override
    public void process(WatchedEvent event) {
        System.out.println("é…ç½®å˜åŒ–äº†ï¼");
        
        try {
            // é‡æ–°æ³¨å†Œç›‘å¬
            zk.getData("/config", this, null);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
};

zk.getData("/config", watcher, null);
```

#### å‘2: Watcherè¿‡å¤šå¯¼è‡´æ€§èƒ½é—®é¢˜


```
Watcheræ•°é‡æ§åˆ¶ï¼š

æ¯ä¸ªèŠ‚ç‚¹ç›‘å¬æ•°        å½±å“
1-10ä¸ª           â”€â–¶  æ­£å¸¸ï¼Œæ— å‹åŠ›
10-100ä¸ª         â”€â–¶  éœ€è¦æ³¨æ„
100+ä¸ª           â”€â–¶  è€ƒè™‘ä¼˜åŒ–è®¾è®¡
1000+ä¸ª          â”€â–¶  ä¸¥é‡æ€§èƒ½é—®é¢˜
```

**ğŸ’¡ ä¼˜åŒ–æ–¹æ¡ˆ**: ä½¿ç”¨ç»Ÿä¸€çš„Watcherç®¡ç†å™¨

```java
public class WatcherManager {
    
    // æ‰€æœ‰ç›‘å¬å™¨å…±äº«ä¸€ä¸ªWatcher
    private Map<String, List<Consumer<WatchedEvent>>> listeners = new ConcurrentHashMap<>();
    
    // ç»Ÿä¸€çš„Watcherå®ä¾‹
    private Watcher unifiedWatcher = event -> {
        String path = event.getPath();
        List<Consumer<WatchedEvent>> callbacks = listeners.get(path);
        
        if (callbacks != null) {
            callbacks.forEach(callback -> callback.accept(event));
            
            // é‡æ–°æ³¨å†Œ
            try {
                zk.exists(path, this.unifiedWatcher);
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    };
    
    // æ·»åŠ ç›‘å¬å™¨
    public void addListener(String path, Consumer<WatchedEvent> listener) {
        listeners.computeIfAbsent(path, k -> new ArrayList<>()).add(listener);
        
        try {
            zk.exists(path, unifiedWatcher);  // ä½¿ç”¨ç»Ÿä¸€çš„Watcher
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

### 3.3 Watcherä½¿ç”¨å»ºè®®


| åœºæ™¯ | **å»ºè®®åšæ³•** | **é¿å…åšæ³•** |
|-----|------------|------------|
| ğŸ”¸ **é…ç½®ç›‘å¬** | `ç›‘å¬çˆ¶èŠ‚ç‚¹ï¼Œæ‰¹é‡å¤„ç†` | `æ¯ä¸ªé…ç½®é¡¹å•ç‹¬ç›‘å¬` |
| ğŸ”¸ **æœåŠ¡å‘ç°** | `ä½¿ç”¨ä¸´æ—¶èŠ‚ç‚¹+ç›‘å¬` | `è½®è¯¢æŸ¥è¯¢èŠ‚ç‚¹` |
| ğŸ”¸ **é‡æ–°æ³¨å†Œ** | `åœ¨å›è°ƒä¸­ç«‹å³æ³¨å†Œ` | `å»¶è¿Ÿæ³¨å†Œæˆ–å¿˜è®°æ³¨å†Œ` |

---

## 4. ğŸ“‚ èŠ‚ç‚¹è®¾è®¡è§„èŒƒ


### 4.1 èŠ‚ç‚¹å‘½åè§„èŒƒ


**ğŸŒ° å¥½çš„å‘½åç¤ºä¾‹**:
```
/services                    # æœåŠ¡æ ¹èŠ‚ç‚¹
  /user-service             # ç”¨æˆ·æœåŠ¡
    /instance-001           # å®ä¾‹1
    /instance-002           # å®ä¾‹2
  /order-service            # è®¢å•æœåŠ¡
    /instance-001

/config                      # é…ç½®æ ¹èŠ‚ç‚¹
  /database                 # æ•°æ®åº“é…ç½®
    /mysql
    /redis
  /application              # åº”ç”¨é…ç½®
```

**âŒ ä¸å¥½çš„å‘½å**:
```
/a                          # åç§°æ— æ„ä¹‰
/user_service_config_v1     # å¤ªé•¿å¤ªå¤æ‚
/æœåŠ¡èŠ‚ç‚¹                    # ä¸­æ–‡å¯èƒ½ä¹±ç 
```

**ğŸ’¡ å‘½ååŸåˆ™**:
- âœ… ä½¿ç”¨è‹±æ–‡å’Œæ•°å­—
- âœ… ç”¨`/`åˆ†éš”å±‚çº§ï¼Œç”¨`-`è¿æ¥å•è¯
- âœ… ç®€æ´æœ‰æ„ä¹‰
- âŒ é¿å…ä¸­æ–‡ã€ç‰¹æ®Šå­—ç¬¦
- âŒ ä¸è¦å¤ªé•¿ï¼ˆå»ºè®®50å­—ç¬¦å†…ï¼‰

### 4.2 èŠ‚ç‚¹æ•°é‡æ§åˆ¶


```
èŠ‚ç‚¹è§„æ¨¡å‚è€ƒï¼š

èŠ‚ç‚¹æ€»æ•°          æ€§èƒ½è¡¨ç°           å»ºè®®
< 1ä¸‡           â”€â–¶  ä¼˜ç§€          æ­£å¸¸ä½¿ç”¨
1ä¸‡ - 10ä¸‡      â”€â–¶  è‰¯å¥½          æ³¨æ„ç›‘æ§
10ä¸‡ - 50ä¸‡     â”€â–¶  ä¸€èˆ¬          è€ƒè™‘åˆ†ç‰‡
> 50ä¸‡          â”€â–¶  æ€§èƒ½ä¸‹é™       å¿…é¡»ä¼˜åŒ–
```

**âš ï¸ å¸¸è§é—®é¢˜**: æ¯ä¸ªå®¢æˆ·ç«¯åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹

```java
// âŒ ä¸å¥½çš„è®¾è®¡ï¼š100ä¸ªå®¢æˆ·ç«¯å°±100ä¸ªèŠ‚ç‚¹
/locks
  /lock-client-192.168.1.1
  /lock-client-192.168.1.2
  /lock-client-192.168.1.3
  ... (å¤ªå¤šäº†ï¼)

// âœ… å¥½çš„è®¾è®¡ï¼šä½¿ç”¨é¡ºåºèŠ‚ç‚¹
/locks
  /lock-0000000001
  /lock-0000000002
  /lock-0000000003
  ... (Zookeeperè‡ªåŠ¨ç®¡ç†)
```

### 4.3 èŠ‚ç‚¹æ•°æ®å¤§å°é™åˆ¶


> ğŸš¨ **ç¡¬æ€§é™åˆ¶**  
> ZookeeperèŠ‚ç‚¹æ•°æ®ä¸èƒ½è¶…è¿‡ **1MB**ï¼Œä½†å®é™…å»ºè®®æ§åˆ¶åœ¨ **1KB** ä»¥å†…

**ğŸŒ° æ•°æ®å­˜å‚¨å»ºè®®**:

```java
// âŒ ä¸è¦å­˜å¤§æ•°æ®
String bigData = "å¾ˆé•¿å¾ˆé•¿çš„JSONæ•°æ®..."; // å‡ ç™¾KB
zk.create("/config", bigData.getBytes(), ...);

// âœ… åªå­˜å…³é”®ä¿¡æ¯ï¼Œå¤§æ•°æ®å­˜æ•°æ®åº“
String reference = "mysql:config_table:id=123";  // åªå­˜å¼•ç”¨
zk.create("/config", reference.getBytes(), ...);

// âœ… é…ç½®ä¸­å¿ƒåœºæ™¯
String config = "{\"port\":8080,\"timeout\":30}";  // å°é…ç½®ç›´æ¥å­˜
zk.create("/app-config", config.getBytes(), ...);
```

---

## 5. âš¡ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


### 5.1 æ‰¹é‡æ“ä½œä¼˜åŒ–


**é—®é¢˜åœºæ™¯**: éœ€è¦åˆ›å»º100ä¸ªèŠ‚ç‚¹

```java
// âŒ ä½æ•ˆåšæ³•ï¼šé€ä¸ªåˆ›å»º
for (int i = 0; i < 100; i++) {
    zk.create("/node-" + i, data, ...);  // 100æ¬¡ç½‘ç»œè¯·æ±‚
}

// âœ… é«˜æ•ˆåšæ³•ï¼šä½¿ç”¨multiäº‹åŠ¡
List<Op> ops = new ArrayList<>();
for (int i = 0; i < 100; i++) {
    ops.add(Op.create("/node-" + i, data, ...));
}
zk.multi(ops);  // ä¸€æ¬¡ç½‘ç»œè¯·æ±‚å®Œæˆ
```

**æ€§èƒ½å¯¹æ¯”**:
```
åˆ›å»º100ä¸ªèŠ‚ç‚¹çš„è€—æ—¶ï¼š
- å•æ¬¡åˆ›å»º: ~2000ms
- æ‰¹é‡äº‹åŠ¡: ~100ms
æ€§èƒ½æå‡: 20å€ï¼
```

### 5.2 è¯»å†™åˆ†ç¦»ç­–ç•¥


```
è¯»å†™åˆ†ç¦»æ¶æ„ï¼š

åº”ç”¨ç¨‹åº
    â”‚
    â”œâ”€å†™æ“ä½œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ LeaderèŠ‚ç‚¹
    â”‚                    â”‚
    â”‚                 åŒæ­¥æ•°æ®
    â”‚                    â”‚
    â””â”€è¯»æ“ä½œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ FollowerèŠ‚ç‚¹
                         (å°±è¿‘è¯»å–)
```

**ğŸ’¡ ä»£ç å®ç°**:
```java
// å†™æ“ä½œå¿…é¡»èµ°Leader
public void writeData(String path, byte[] data) throws Exception {
    zk.setData(path, data, -1);  // è‡ªåŠ¨è·¯ç”±åˆ°Leader
}

// è¯»æ“ä½œå¯ä»¥ä»ä»»æ„èŠ‚ç‚¹è¯»
public byte[] readData(String path) throws Exception {
    return zk.getData(path, false, null);  // å¯èƒ½ä»Followerè¯»
}
```

### 5.3 å‡å°‘ä¸å¿…è¦çš„Watcher


> âš ï¸ **æ€§èƒ½æ€æ‰‹**  
> å¤§é‡Watcherä¼šæ¶ˆè€—æœåŠ¡å™¨èµ„æºï¼Œä¸”é‡æ–°æ³¨å†Œä¼šå¢åŠ ç½‘ç»œå¼€é”€

**ä¼˜åŒ–ç­–ç•¥**:

1ï¸âƒ£ **åˆå¹¶ç›‘å¬**: ç›‘å¬çˆ¶èŠ‚ç‚¹ä»£æ›¿å¤šä¸ªå­èŠ‚ç‚¹
2ï¸âƒ£ **æŒ‰éœ€ç›‘å¬**: åªç›‘å¬çœŸæ­£éœ€è¦çš„èŠ‚ç‚¹
3ï¸âƒ£ **åŠæ—¶å–æ¶ˆ**: ä¸éœ€è¦æ—¶ä¸»åŠ¨ç§»é™¤ç›‘å¬

---

## 6. ğŸ§¹ èµ„æºç®¡ç†ä¸é‡Šæ”¾


### 6.1 è¿æ¥èµ„æºé‡Šæ”¾


**ğŸŒ° ç”Ÿæ´»ç±»æ¯”**: 
ç”¨å®Œæ°´é¾™å¤´è¦è®°å¾—å…³ï¼Œå¦åˆ™ä¸€ç›´æµæ°´æµªè´¹èµ„æºã€‚Zookeeperè¿æ¥ä¹Ÿæ˜¯ä¸€æ ·ï¼Œä¸ç”¨äº†å¿…é¡»å…³é—­ã€‚

```java
public class ZKClient {
    
    private ZooKeeper zk;
    
    // åˆå§‹åŒ–è¿æ¥
    public void init() throws Exception {
        zk = new ZooKeeper("localhost:2181", 5000, event -> {});
    }
    
    // âœ… ä½¿ç”¨try-with-resourcesè‡ªåŠ¨å…³é—­
    public void doWork() throws Exception {
        try (ZooKeeper zk = new ZooKeeper(...)) {
            // ä¸šåŠ¡æ“ä½œ
            zk.create("/test", ...);
        } // è‡ªåŠ¨è°ƒç”¨close()
    }
    
    // âœ… åœ¨finallyä¸­ç¡®ä¿å…³é—­
    public void doWorkManual() {
        ZooKeeper zk = null;
        try {
            zk = new ZooKeeper(...);
            // ä¸šåŠ¡æ“ä½œ
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            if (zk != null) {
                try {
                    zk.close();  // ç¡®ä¿å…³é—­
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                }
            }
        }
    }
}
```

### 6.2 çº¿ç¨‹èµ„æºç®¡ç†


**âš ï¸ å¸¸è§é—®é¢˜**: Watcherå›è°ƒåœ¨Zookeeperçš„EventThreadä¸­æ‰§è¡Œ

```java
// âŒ å±é™©åšæ³•ï¼šåœ¨Watcherä¸­æ‰§è¡Œè€—æ—¶æ“ä½œ
zk.getData("/config", event -> {
    // è¿™æ˜¯åœ¨EventThreadä¸­æ‰§è¡Œï¼
    doSlowOperation();  // è€—æ—¶æ“ä½œä¼šé˜»å¡å…¶ä»–äº‹ä»¶
}, null);

// âœ… æ­£ç¡®åšæ³•ï¼šå¼‚æ­¥å¤„ç†
private ExecutorService executor = Executors.newFixedThreadPool(5);

zk.getData("/config", event -> {
    // æäº¤åˆ°çº¿ç¨‹æ± å¼‚æ­¥å¤„ç†
    executor.submit(() -> {
        doSlowOperation();
    });
}, null);

// åº”ç”¨å…³é—­æ—¶ï¼Œé‡Šæ”¾çº¿ç¨‹æ± 
public void shutdown() {
    executor.shutdown();
    try {
        executor.awaitTermination(10, TimeUnit.SECONDS);
    } catch (InterruptedException e) {
        executor.shutdownNow();
    }
}
```

### 6.3 å†…å­˜æ³„æ¼é¢„é˜²


**å…¸å‹å†…å­˜æ³„æ¼åœºæ™¯**:

```java
// âŒ å®¹æ˜“å†…å­˜æ³„æ¼çš„ä»£ç 
public class LeakyWatcher {
    
    private Map<String, Watcher> watchers = new HashMap<>();
    
    public void watch(String path) {
        Watcher watcher = event -> {
            // å¤„ç†äº‹ä»¶
            watchers.put(path, this);  // å¾ªç¯å¼•ç”¨ï¼
        };
        
        watchers.put(path, watcher);
        zk.exists(path, watcher);
    }
    
    // å¿˜è®°æä¾›ç§»é™¤æ–¹æ³•ï¼Œå¯¼è‡´watchersä¸æ–­å¢é•¿
}

// âœ… æ­£ç¡®çš„åšæ³•
public class ProperWatcher {
    
    private Map<String, Watcher> watchers = new ConcurrentHashMap<>();
    
    public void watch(String path) {
        Watcher watcher = event -> {
            // å¤„ç†äº‹ä»¶
        };
        
        watchers.put(path, watcher);
        zk.exists(path, watcher);
    }
    
    // æä¾›æ¸…ç†æ–¹æ³•
    public void unwatch(String path) {
        watchers.remove(path);
    }
    
    // æ¸…ç†æ‰€æœ‰
    public void clear() {
        watchers.clear();
    }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æœ€ä½³å®è·µ


**ğŸ”¸ è¿æ¥ç®¡ç†**
```
âœ… ä½¿ç”¨è¿æ¥æ± å¤ç”¨è¿æ¥ï¼Œé¿å…é¢‘ç¹åˆ›å»º
âœ… è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
âœ… å®šæœŸæ£€æŸ¥è¿æ¥å¥åº·çŠ¶æ€
âŒ ä¸è¦æ¯æ¬¡æ“ä½œéƒ½åˆ›å»ºæ–°è¿æ¥
```

**ğŸ”¸ å¼‚å¸¸å¤„ç†**
```
âœ… åŒºåˆ†å¯é‡è¯•å’Œä¸å¯é‡è¯•çš„å¼‚å¸¸
âœ… å®ç°æŒ‡æ•°é€€é¿é‡è¯•ç­–ç•¥
âœ… è®¾ç½®é‡è¯•ä¸Šé™ï¼Œé¿å…æ— é™é‡è¯•
âŒ ä¸è¦å¿½ç•¥å¼‚å¸¸æˆ–æ— é™é‡è¯•
```

**ğŸ”¸ Watcherä½¿ç”¨**
```
âœ… æ”¶åˆ°é€šçŸ¥åç«‹å³é‡æ–°æ³¨å†Œ
âœ… ä½¿ç”¨ç»Ÿä¸€çš„Watcherç®¡ç†å™¨
âœ… é¿å…åœ¨Watcherä¸­æ‰§è¡Œè€—æ—¶æ“ä½œ
âŒ ä¸è¦åˆ›å»ºå¤§é‡Watcher
```

**ğŸ”¸ èŠ‚ç‚¹è®¾è®¡**
```
âœ… ä½¿ç”¨æ¸…æ™°çš„å‘½åè§„èŒƒ
âœ… æ§åˆ¶èŠ‚ç‚¹æ•°é‡å’Œæ•°æ®å¤§å°
âœ… åˆç†è®¾è®¡èŠ‚ç‚¹å±‚çº§ç»“æ„
âŒ ä¸è¦å­˜å‚¨å¤§æ•°æ®åœ¨èŠ‚ç‚¹ä¸­
```

### 7.2 æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥æ¸…å•


- [ ] **è¿æ¥å¤ç”¨**: æ˜¯å¦ä½¿ç”¨äº†è¿æ¥æ± 
- [ ] **æ‰¹é‡æ“ä½œ**: æ˜¯å¦ä½¿ç”¨multiäº‹åŠ¡å¤„ç†æ‰¹é‡ä»»åŠ¡
- [ ] **è¯»å†™åˆ†ç¦»**: è¯»æ“ä½œæ˜¯å¦å¯ä»¥ä»Followerè¯»å–
- [ ] **Watcherä¼˜åŒ–**: æ˜¯å¦å‡å°‘äº†ä¸å¿…è¦çš„ç›‘å¬
- [ ] **èµ„æºé‡Šæ”¾**: æ˜¯å¦æ­£ç¡®å…³é—­äº†è¿æ¥å’Œçº¿ç¨‹

### 7.3 å¸¸è§é—®é¢˜é€ŸæŸ¥


| é—®é¢˜ | **åŸå› ** | **è§£å†³æ–¹æ¡ˆ** |
|-----|---------|------------|
| ğŸ”¸ **è¿æ¥é¢‘ç¹æ–­å¼€** | `ç½‘ç»œä¸ç¨³å®šæˆ–ä¼šè¯è¶…æ—¶` | `å¢åŠ è¶…æ—¶æ—¶é—´ï¼Œä½¿ç”¨å¿ƒè·³æ£€æµ‹` |
| ğŸ”¸ **æ€§èƒ½å˜æ…¢** | `èŠ‚ç‚¹è¿‡å¤šæˆ–Watcherè¿‡å¤š` | `å‡å°‘èŠ‚ç‚¹æ•°ï¼Œåˆå¹¶Watcher` |
| ğŸ”¸ **å†…å­˜æ³„æ¼** | `Watcheræœªé‡Šæ”¾` | `åŠæ—¶ç§»é™¤ä¸éœ€è¦çš„ç›‘å¬å™¨` |
| ğŸ”¸ **æ•°æ®ä¸¢å¤±** | `èŠ‚ç‚¹è¢«è¯¯åˆ æˆ–ä¼šè¯è¿‡æœŸ` | `ä½¿ç”¨æŒä¹…èŠ‚ç‚¹ï¼Œè®¾ç½®ACLæƒé™` |

### 7.4 å­¦ä¹ è·¯å¾„å»ºè®®


```
å­¦ä¹ è¿›åº¦å›¾ï¼š

åŸºç¡€ä½¿ç”¨          æœ€ä½³å®è·µ          æ€§èƒ½ä¼˜åŒ–          ç”Ÿäº§éƒ¨ç½²
   â”‚                â”‚                â”‚                â”‚
   â–¼                â–¼                â–¼                â–¼
è¿æ¥ä¸æ“ä½œ â”€â”€â–¶ å¼‚å¸¸å¤„ç† â”€â”€â–¶ æ‰¹é‡ä¼˜åŒ– â”€â”€â–¶ é›†ç¾¤è§„åˆ’
   â”‚                â”‚                â”‚                â”‚
èŠ‚ç‚¹å¢åˆ æ”¹ â”€â”€â–¶ Watcher â”€â”€â–¶ è¿æ¥æ±  â”€â”€â–¶ ç›‘æ§å‘Šè­¦
   â”‚            ç®¡ç†           â”‚                â”‚
Watcher â”€â”€â–¶ èµ„æºé‡Šæ”¾ â”€â”€â–¶ è¯»å†™åˆ†ç¦» â”€â”€â–¶ å®¹ç¾å¤‡ä»½
```

> ğŸ’¡ **å­¦ä¹ å»ºè®®**  
> 1. **å…ˆæŒæ¡åŸºç¡€æ“ä½œ**ï¼Œå†å­¦ä¹ æœ€ä½³å®è·µ
> 2. **å¤šåŠ¨æ‰‹å®è·µ**ï¼Œé€šè¿‡é”™è¯¯å­¦ä¹ ç»éªŒ
> 3. **é˜…è¯»æºç **ï¼Œç†è§£åº•å±‚å®ç°åŸç†
> 4. **å…³æ³¨ç›‘æ§æŒ‡æ ‡**ï¼ŒåŠæ—¶å‘ç°æ€§èƒ½é—®é¢˜

**ğŸ§  è®°å¿†å£è¯€**:
```
è¿æ¥è¦å¤ç”¨ï¼Œå¼‚å¸¸è¦é‡è¯•
Watcheréœ€è°¨æ…ï¼ŒèŠ‚ç‚¹è¦è§„èŒƒ
æ‰¹é‡ææ€§èƒ½ï¼Œèµ„æºè¦é‡Šæ”¾
ç›‘æ§ä¸èƒ½å°‘ï¼Œä¼˜åŒ–æ— æ­¢å¢ƒ
```