---
title: 5、Apollo服务端部署配置
---
## 📚 目录

1. [Apollo服务端架构理解](#1-Apollo服务端架构理解)
2. [数据库初始化配置](#2-数据库初始化配置)
3. [Portal管理服务部署](#3-Portal管理服务部署)
4. [Config-Service配置服务部署](#4-Config-Service配置服务部署)
5. [Admin-Service管理服务部署](#5-Admin-Service管理服务部署)
6. [Meta-Service元数据服务](#6-Meta-Service元数据服务)
7. [环境配置管理](#7-环境配置管理)
8. [集群部署方案](#8-集群部署方案)
9. [负载均衡配置](#9-负载均衡配置)
10. [核心要点总结](#10-核心要点总结)

---

## 1. 🏗️ Apollo服务端架构理解


### 1.1 Apollo是什么


**通俗理解**：
> Apollo就像一个"配置文件管家"。你的微服务项目可能有几十上百个配置项（数据库地址、Redis密码、开关参数等），如果每次修改都要改代码、重启服务，那太麻烦了！Apollo让你可以在网页上统一管理这些配置，改完立即生效，不用重启服务。

**专业定义**：
- Apollo是携程开源的**分布式配置中心**
- 提供**配置统一管理、实时推送、版本管理、权限控制**等功能
- 支持多环境、多集群的配置管理

### 1.2 服务端核心组件


Apollo服务端由4个核心服务组成，它们各司其职：

```
Apollo服务端架构：
┌─────────────────────────────────────────────┐
│              Portal (管理界面)               │
│         你在网页上操作的那个界面              │
└──────────────────┬──────────────────────────┘
                   │
        ┌──────────┴──────────┐
        ▼                     ▼
┌──────────────┐      ┌──────────────┐
│ Admin Service│      │Config Service│
│  配置管理服务 │      │  配置服务    │
│  (后台接口)  │      │ (客户端用)   │
└──────┬───────┘      └──────┬───────┘
       │                     │
       └─────────┬───────────┘
                 ▼
        ┌─────────────────┐
        │  Meta Service   │
        │ (服务发现注册)   │
        └─────────────────┘
                 │
                 ▼
        ┌─────────────────┐
        │  MySQL数据库     │
        │  (存储配置数据)  │
        └─────────────────┘
```

**组件分工理解**：

| 组件 | 作用 | 通俗比喻 |
|------|------|----------|
| **Portal** | 网页管理界面 | 就像商场前台，你在这里操作 |
| **Admin Service** | 管理配置的后台服务 | 就像仓库管理员，负责存取配置 |
| **Config Service** | 提供配置给客户端 | 就像快递员，把配置送到应用手上 |
| **Meta Service** | 服务注册发现 | 就像导航系统，告诉客户端服务在哪 |

💡 **新手提示**
> Admin和Config为什么要分开？因为管理配置（改配置）和读取配置（应用获取）是两个不同的职责，分开后可以独立扩展，互不影响。

---

## 2. 🗄️ 数据库初始化配置


### 2.1 为什么需要两个数据库


Apollo需要准备**两个MySQL数据库**：

```
数据库职责划分：
┌─────────────────┐
│  ApolloPortalDB │  ← Portal使用，存管理数据
└─────────────────┘
        
┌─────────────────┐
│  ApolloConfigDB │  ← Config/Admin使用，存配置数据
└─────────────────┘
```

**为什么要两个？**
- `ApolloPortalDB`：存储用户、权限、项目等**管理信息**
- `ApolloConfigDB`：存储实际的**配置内容**
- 分离后，管理界面可以管理多个环境（开发/测试/生产），每个环境一套ConfigDB

### 2.2 数据库初始化步骤


**步骤1：创建数据库**
```sql
-- 创建Portal数据库
CREATE DATABASE ApolloPortalDB CHARACTER SET utf8mb4;

-- 创建Config数据库
CREATE DATABASE ApolloConfigDB CHARACTER SET utf8mb4;
```

**步骤2：导入初始化SQL**

从Apollo官方下载SQL脚本，执行导入：

```bash
# 导入Portal库
mysql -u root -p ApolloPortalDB < apolloportaldb.sql

# 导入Config库
mysql -u root -p ApolloConfigDB < apolloconfigdb.sql
```

**步骤3：配置数据库连接信息**

这些连接信息后续会配置到各个服务中：

| 数据库 | 连接地址示例 | 用户名 | 密码 |
|--------|-------------|--------|------|
| PortalDB | `jdbc:mysql://localhost:3306/ApolloPortalDB` | apollo | apollo123 |
| ConfigDB | `jdbc:mysql://localhost:3306/ApolloConfigDB` | apollo | apollo123 |

⚠️ **注意事项**
> - MySQL版本建议5.7+
> - 字符集必须是`utf8mb4`（支持emoji等特殊字符）
> - 生产环境记得修改默认密码！

---

## 3. 🎨 Portal管理服务部署


### 3.1 Portal是什么


**通俗理解**：
> Portal就是你用浏览器打开的那个管理网页，你在上面创建项目、编辑配置、发布配置，全靠它。它是Apollo的"门面"。

### 3.2 Portal部署配置


**配置文件位置**：`application-github.properties`

```properties
# ===== 数据库配置 =====
spring.datasource.url = jdbc:mysql://localhost:3306/ApolloPortalDB?characterEncoding=utf8
spring.datasource.username = apollo
spring.datasource.password = apollo123

# ===== Portal端口 =====
server.port = 8070

# ===== 支持的环境列表 =====
# 逗号分隔，按需添加环境
apollo.portal.envs = dev,fat,uat,pro

# ===== Meta Server地址配置 =====
# 告诉Portal各环境的Config Service在哪
dev.meta = http://localhost:8080
fat.meta = http://fat-config.example.com:8080
uat.meta = http://uat-config.example.com:8080
pro.meta = http://pro-config.example.com:8080
```

**配置项解释**：

| 配置项 | 含义 | 新手理解 |
|--------|------|----------|
| `apollo.portal.envs` | 支持的环境列表 | 你公司有几个环境就配几个 |
| `dev.meta` | 开发环境Meta地址 | Portal要找Config Service，通过这个地址找 |
| `server.port` | Portal服务端口 | 访问地址就是 `http://ip:8070` |

**启动Portal**：
```bash
# 方式1：直接运行jar包
java -Xms256m -Xmx256m -jar apollo-portal-1.9.0.jar

# 方式2：使用启动脚本（推荐）
./scripts/startup.sh
```

**验证部署**：
```
访问：http://localhost:8070
默认账号：apollo
默认密码：admin
```

📚 **学习提示**
> Portal是整个Apollo的入口，部署好后就可以通过网页管理所有配置了。建议先部署Portal，再部署其他服务。

---

## 4. ⚙️ Config-Service配置服务部署


### 4.1 Config Service是什么


**通俗理解**：
> Config Service是给你的应用程序提供配置的服务。你的Java应用启动时，会找Config Service要配置，Config Service就把配置发给它。就像"配送员"，负责把配置送到应用手上。

### 4.2 Config Service部署配置


**配置文件**：`application-github.properties`

```properties
# ===== 数据库配置 =====
spring.datasource.url = jdbc:mysql://localhost:3306/ApolloConfigDB?characterEncoding=utf8
spring.datasource.username = apollo
spring.datasource.password = apollo123

# ===== 服务端口 =====
server.port = 8080

# ===== Eureka注册中心配置 =====
# Config Service内置了Eureka做服务注册
eureka.service.url = http://localhost:8080/eureka/
```

**核心职责**：
- 🔸 提供配置查询接口给客户端
- 🔸 配置变更时**实时推送**给客户端
- 🔸 内置Eureka，支持服务注册发现

**启动Config Service**：
```bash
java -Xms256m -Xmx256m -jar apollo-configservice-1.9.0.jar
```

**验证部署**：
```
访问：http://localhost:8080
返回：Eureka注册中心界面
```

💡 **重点理解**
> Config Service既是配置服务，又是Eureka注册中心。Admin Service和客户端都会注册到它这里。

---

## 5. 🔧 Admin-Service管理服务部署


### 5.1 Admin Service是什么


**通俗理解**：
> Admin Service是给Portal用的后台服务。你在Portal界面上点"发布配置"，实际上是Portal调用Admin Service的接口，Admin Service再把配置存到数据库。它是"仓库管理员"，负责管理配置的增删改查。

### 5.2 Admin Service部署配置


**配置文件**：`application-github.properties`

```properties
# ===== 数据库配置 =====
# 和Config Service用同一个ConfigDB
spring.datasource.url = jdbc:mysql://localhost:3306/ApolloConfigDB?characterEncoding=utf8
spring.datasource.username = apollo
spring.datasource.password = apollo123

# ===== 服务端口 =====
server.port = 8090

# ===== Eureka注册地址 =====
# 注册到Config Service的Eureka
eureka.service.url = http://localhost:8080/eureka/
```

**核心职责**：
- 🔸 提供配置管理接口（增删改查）
- 🔸 处理Portal的管理请求
- 🔸 注册到Config Service的Eureka

**启动Admin Service**：
```bash
java -Xms256m -Xmx256m -jar apollo-adminservice-1.9.0.jar
```

**服务调用关系**：
```
Portal界面操作
    ↓ (HTTP调用)
Admin Service处理
    ↓ (写入数据库)
MySQL存储配置
    ↓ (Config Service读取)
客户端获取配置
```

---

## 6. 🔍 Meta-Service元数据服务


### 6.1 Meta Service是什么


**通俗理解**：
> Meta Service不是一个独立的服务，它是"藏"在Config Service里的。它的作用是告诉客户端和Portal："你要找的Config Service在哪里，Admin Service在哪里"。就像导航系统。

### 6.2 Meta Service工作原理


```
客户端启动流程：
┌──────────────┐
│ 1. 应用启动  │
└──────┬───────┘
       ↓
┌────────────────────────────┐
│ 2. 读取配置：meta地址在哪？ │
│    -Dapollo.meta=http://... │
└──────┬─────────────────────┘
       ↓
┌────────────────────────────┐
│ 3. 访问Meta Service        │
│    获取：Config Service地址 │
└──────┬─────────────────────┘
       ↓
┌────────────────────────────┐
│ 4. 连接Config Service      │
│    获取：实际配置内容       │
└────────────────────────────┘
```

**Meta地址配置方式**：

客户端需要知道Meta Service地址，有3种配置方式：

| 方式 | 配置示例 | 说明 |
|------|---------|------|
| JVM参数 | `-Dapollo.meta=http://localhost:8080` | 启动时指定 |
| 配置文件 | `apollo.meta=http://localhost:8080` | 写在application.properties |
| 系统变量 | `export APOLLO_META=http://localhost:8080` | Linux环境变量 |

💡 **新手理解**
> Meta Service = Config Service的地址。客户端先找Meta，Meta告诉它Config在哪，然后再去Config拿配置。多一层是为了灵活：Config地址变了，只需要改Meta地址就行。

---

## 7. 🌍 环境配置管理


### 7.1 多环境是什么概念


**通俗理解**：
> 你的项目会部署在不同环境：开发环境、测试环境、生产环境。每个环境的配置不一样（比如数据库地址不同），Apollo支持为每个环境单独管理配置。

### 7.2 环境类型定义


Apollo预定义了4种环境：

| 环境代码 | 环境名称 | 用途 | 配置示例 |
|---------|---------|------|----------|
| `DEV` | 开发环境 | 开发人员使用 | 数据库：dev-db.com |
| `FAT` | 测试环境 | 功能测试使用 | 数据库：test-db.com |
| `UAT` | 预发布环境 | 上线前验证 | 数据库：uat-db.com |
| `PRO` | 生产环境 | 正式环境 | 数据库：prod-db.com |

**环境配置方式**：

在Portal的配置文件中：
```properties
# 声明支持的环境
apollo.portal.envs = dev,fat,uat,pro

# 配置各环境的Meta地址
dev.meta = http://dev-apollo:8080
fat.meta = http://fat-apollo:8080
uat.meta = http://uat-apollo:8080
pro.meta = http://pro-apollo:8080
```

**客户端指定环境**：
```bash
# 启动应用时指定环境
java -Denv=dev -jar myapp.jar
```

### 7.3 环境隔离原理


```
环境隔离架构：
┌────────────────┐
│  Portal (统一) │
└───────┬────────┘
        │
    ┌───┴────┬─────────┬─────────┐
    ▼        ▼         ▼         ▼
┌────────┐┌────────┐┌────────┐┌────────┐
│ DEV环境││ FAT环境││ UAT环境││ PRO环境│
│Config  ││Config  ││Config  ││Config  │
│Admin   ││Admin   ││Admin   ││Admin   │
│ConfigDB││ConfigDB││ConfigDB││ConfigDB│
└────────┘└────────┘└────────┘└────────┘
```

⚠️ **重点理解**
> - Portal只有一套，但可以管理多个环境
> - 每个环境有独立的Config、Admin、数据库
> - 配置互不影响，改DEV环境不会影响PRO环境

---

## 8. 🏢 集群部署方案


### 8.1 为什么需要集群


**单机部署问题**：
- ❌ 单点故障：一台挂了整个配置中心不可用
- ❌ 性能瓶颈：访问量大时单机扛不住
- ❌ 无法扩展：流量增长无法水平扩展

**集群部署优势**：
- ✅ 高可用：一台挂了其他继续服务
- ✅ 高性能：多台分担压力
- ✅ 可扩展：流量增长加机器即可

### 8.2 集群部署架构


**标准集群架构**：

```
生产环境集群部署：
                ┌──────────────┐
                │ Portal (独立) │
                └───────┬────────┘
                        │
            ┌───────────┴───────────┐
            ▼                       ▼
    ┌──────────────┐        ┌──────────────┐
    │ Config集群    │        │ Admin集群     │
    ├──────────────┤        ├──────────────┤
    │ Config-1     │        │ Admin-1      │
    │ Config-2     │        │ Admin-2      │
    │ Config-3     │        │ Admin-3      │
    └──────┬───────┘        └──────┬───────┘
           │                       │
           └───────────┬───────────┘
                       ▼
              ┌─────────────────┐
              │ MySQL主从集群   │
              └─────────────────┘
```

### 8.3 集群部署步骤


**步骤1：准备服务器**

假设有3台服务器：

| 服务器IP | 部署服务 | 说明 |
|---------|---------|------|
| 192.168.1.11 | Config + Admin | 节点1 |
| 192.168.1.12 | Config + Admin | 节点2 |
| 192.168.1.13 | Config + Admin | 节点3 |

**步骤2：配置Eureka集群**

每个Config Service的配置：

```properties
# 192.168.1.11的配置
eureka.service.url = http://192.168.1.11:8080/eureka/,http://192.168.1.12:8080/eureka/,http://192.168.1.13:8080/eureka/

# 192.168.1.12的配置
eureka.service.url = http://192.168.1.11:8080/eureka/,http://192.168.1.12:8080/eureka/,http://192.168.1.13:8080/eureka/

# 192.168.1.13的配置
eureka.service.url = http://192.168.1.11:8080/eureka/,http://192.168.1.12:8080/eureka/,http://192.168.1.13:8080/eureka/
```

💡 **理解要点**
> Eureka集群配置：每个节点的`eureka.service.url`都要包含所有节点地址，这样它们才能互相发现、互相备份。

**步骤3：数据库使用主从**

```
MySQL主从架构：
┌──────────┐     同步      ┌──────────┐
│ Master   │ ─────────────→│ Slave    │
│ 写操作   │               │ 读操作   │
└──────────┘               └──────────┘
```

---

## 9. ⚖️ 负载均衡配置


### 9.1 为什么需要负载均衡


**问题场景**：
> 你部署了3台Config Service，客户端应该连哪一台？如果写死IP，那台挂了怎么办？所以需要负载均衡，把请求均匀分配到各台服务器。

### 9.2 负载均衡方案


**方案1：使用Nginx**

```nginx
# Nginx配置
upstream apollo-config {
    # 轮询策略
    server 192.168.1.11:8080 weight=1;
    server 192.168.1.12:8080 weight=1;
    server 192.168.1.13:8080 weight=1;
}

server {
    listen 80;
    server_name apollo-config.example.com;
    
    location / {
        proxy_pass http://apollo-config;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

**方案2：使用SLB（云负载均衡）**

阿里云SLB配置示例：

| 配置项 | 值 | 说明 |
|--------|---|------|
| 监听端口 | 80 | 对外暴露端口 |
| 后端服务器 | 192.168.1.11:8080<br>192.168.1.12:8080<br>192.168.1.13:8080 | 实际服务地址 |
| 负载均衡算法 | 轮询 | 平均分配请求 |
| 健康检查 | HTTP /health | 检测服务是否正常 |

### 9.3 客户端配置负载均衡地址


**配置Meta地址为负载均衡地址**：

```properties
# 生产环境配置
apollo.meta = http://apollo-config.example.com
```

**负载均衡流程**：
```
客户端请求流程：
┌──────────┐
│ 应用启动  │
└─────┬────┘
      ↓
┌──────────────────────────┐
│ 请求：apollo-config.com  │
└─────┬────────────────────┘
      ↓
┌──────────────────────────┐
│ Nginx/SLB负载均衡        │
│ 分配到某个Config节点     │
└─────┬────────────────────┘
      ↓
┌──────────────────────────┐
│ Config Service返回配置   │
└──────────────────────────┘
```

📚 **学习提示**
> - Nginx适合自建机房
> - SLB适合云环境
> - 两者原理一样，都是把请求分发到多台服务器

---

## 10. 📋 核心要点总结


### 10.1 服务端组件关系图


```
完整部署架构：
                  ┌─────────────┐
                  │   Portal    │ ← 你操作的网页
                  └──────┬──────┘
                         │
              ┌──────────┴──────────┐
              ▼                     ▼
        ┌──────────┐          ┌──────────┐
        │  Admin   │          │  Config  │
        │  集群    │          │  集群    │
        └─────┬────┘          └─────┬────┘
              │                     │
              └──────────┬──────────┘
                         ▼
                  ┌─────────────┐
                  │   MySQL     │
                  │   集群      │
                  └─────────────┘
```

### 10.2 部署步骤总结


**部署顺序**（推荐）：

✅ **步骤1：准备数据库**
- 创建`ApolloPortalDB`和`ApolloConfigDB`
- 导入初始化SQL脚本
- 配置数据库连接信息

✅ **步骤2：部署Config Service**
- 配置数据库连接
- 配置Eureka地址（集群环境）
- 启动服务，验证Eureka界面

✅ **步骤3：部署Admin Service**
- 配置数据库连接
- 注册到Config Service的Eureka
- 启动服务，验证注册成功

✅ **步骤4：部署Portal**
- 配置PortalDB连接
- 配置各环境Meta地址
- 启动服务，登录验证

✅ **步骤5：配置负载均衡**（生产环境）
- 部署Nginx或使用SLB
- 配置健康检查
- 客户端使用LB地址

### 10.3 关键配置速查


| 服务 | 关键配置项 | 配置值示例 |
|------|-----------|-----------|
| Portal | `apollo.portal.envs` | dev,fat,uat,pro |
| Portal | `dev.meta` | http://dev-config:8080 |
| Config | `server.port` | 8080 |
| Config | `eureka.service.url` | http://localhost:8080/eureka/ |
| Admin | `server.port` | 8090 |
| Admin | `eureka.service.url` | http://localhost:8080/eureka/ |

### 10.4 常见问题检查清单


**部署验证清单**：

- [ ] 数据库是否正确初始化？
- [ ] Config Service的Eureka界面能否访问？
- [ ] Admin Service是否注册到Eureka？
- [ ] Portal是否能正常登录？
- [ ] Portal能否连接到各环境的Config？
- [ ] 客户端能否通过Meta地址获取配置？

**集群部署检查**：

- [ ] 所有Config节点是否互相注册？
- [ ] Admin节点是否全部注册成功？
- [ ] 负载均衡健康检查是否通过？
- [ ] 数据库主从同步是否正常？

🎯 **核心记忆**
> **Portal管界面，Config发配置，Admin做管理，Meta做导航**
> 
> 部署顺序：**数据库 → Config → Admin → Portal → 负载均衡**
> 
> 集群部署：**Eureka互联，MySQL主从，Nginx/SLB分发**

---

## 📖 延伸学习


**掌握检查**：
- [ ] 能说出Apollo四大组件的作用
- [ ] 理解为什么需要两个数据库
- [ ] 掌握单机和集群部署的区别
- [ ] 了解负载均衡的作用和配置

**下一步学习**：
- Apollo客户端接入配置
- 配置发布和灰度发布
- 配置的权限管理
- 配置的版本管理

**实践建议**：
1. 先在本地部署单机版，熟悉流程
2. 理解各组件之间的调用关系
3. 再尝试集群部署，理解高可用原理
4. 最后配置负载均衡，完成生产级部署