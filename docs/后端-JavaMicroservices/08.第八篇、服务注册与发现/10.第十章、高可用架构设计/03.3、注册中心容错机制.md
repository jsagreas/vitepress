---
title: 3ã€æ³¨å†Œä¸­å¿ƒå®¹é”™æœºåˆ¶
---
## ğŸ“š ç›®å½•

1. [å®¹é”™æœºåˆ¶åŸºç¡€æ¦‚å¿µ](#1-å®¹é”™æœºåˆ¶åŸºç¡€æ¦‚å¿µ)
2. [å¿ƒè·³æ£€æµ‹æœºåˆ¶](#2-å¿ƒè·³æ£€æµ‹æœºåˆ¶)
3. [è¶…æ—¶é‡è¯•ç­–ç•¥](#3-è¶…æ—¶é‡è¯•ç­–ç•¥)
4. [ç†”æ–­å™¨æ¨¡å¼](#4-ç†”æ–­å™¨æ¨¡å¼)
5. [æœåŠ¡é™çº§æ–¹æ¡ˆ](#5-æœåŠ¡é™çº§æ–¹æ¡ˆ)
6. [æ•…éšœéš”ç¦»æŠ€æœ¯](#6-æ•…éšœéš”ç¦»æŠ€æœ¯)
7. [å¿«é€Ÿå¤±è´¥æœºåˆ¶](#7-å¿«é€Ÿå¤±è´¥æœºåˆ¶)
8. [å¼‚å¸¸æ¢å¤ç­–ç•¥](#8-å¼‚å¸¸æ¢å¤ç­–ç•¥)
9. [å®¹é”™æµ‹è¯•éªŒè¯](#9-å®¹é”™æµ‹è¯•éªŒè¯)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ›¡ï¸ å®¹é”™æœºåˆ¶åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯å®¹é”™æœºåˆ¶


**é€šä¿—ç†è§£**ï¼šå°±åƒå¼€è½¦æ—¶ç³»å®‰å…¨å¸¦ã€è£…å®‰å…¨æ°”å›Šä¸€æ ·ï¼Œå®¹é”™æœºåˆ¶æ˜¯å¾®æœåŠ¡ç³»ç»Ÿçš„"å®‰å…¨è£…ç½®"ã€‚

```
æ—¥å¸¸ç”Ÿæ´»ç±»æ¯”ï¼š
åé£æœº â†’ æœ‰å¤‡ç”¨å¼•æ“ã€ç´§æ€¥é™è½ç³»ç»Ÿ
å¼€è½¦ â†’ æœ‰å¤‡èƒã€å®‰å…¨æ°”å›Š
å¾®æœåŠ¡ â†’ æœ‰å®¹é”™æœºåˆ¶ã€é™çº§æ–¹æ¡ˆ

æ ¸å¿ƒæ€æƒ³ï¼šå‡ºé—®é¢˜æ—¶ä¸è®©æ•´ä¸ªç³»ç»Ÿå´©æºƒ
```

**å®¹é”™æœºåˆ¶çš„æœ¬è´¨**ï¼š
- **é¢„é˜²æ•…éšœæ‰©æ•£**ï¼šä¸€ä¸ªæœåŠ¡æŒ‚äº†ï¼Œä¸å½±å“å…¶ä»–æœåŠ¡
- **ä¿è¯å¯ç”¨æ€§**ï¼šå³ä½¿éƒ¨åˆ†åŠŸèƒ½å¤±æ•ˆï¼Œæ ¸å¿ƒåŠŸèƒ½ä»å¯ç”¨
- **å¿«é€Ÿæ¢å¤**ï¼šå‘ç°é—®é¢˜åèƒ½è‡ªåŠ¨æˆ–å¿«é€Ÿæ¢å¤

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦å®¹é”™æœºåˆ¶


**ç°å®åœºæ™¯é—®é¢˜**ï¼š

```
åœºæ™¯1ï¼šé›ªå´©æ•ˆåº”
ç”¨æˆ·æœåŠ¡æŒ‚äº† â†’ è®¢å•æœåŠ¡è°ƒç”¨å¤±è´¥ â†’ è®¢å•æœåŠ¡ä¹ŸæŒ‚äº†
â†’ æ”¯ä»˜æœåŠ¡è°ƒç”¨å¤±è´¥ â†’ æ”¯ä»˜æœåŠ¡ä¹ŸæŒ‚äº†
â†’ æ•´ä¸ªç³»ç»Ÿç˜«ç—ªï¼

åœºæ™¯2ï¼šç½‘ç»œæŠ–åŠ¨
ç½‘ç»œå»¶è¿Ÿçªç„¶å˜é«˜ â†’ è°ƒç”¨è¶…æ—¶ â†’ å¤§é‡è¯·æ±‚å †ç§¯
â†’ æœåŠ¡å™¨èµ„æºè€—å°½ â†’ æœåŠ¡å´©æºƒ

å®¹é”™æœºåˆ¶å°±æ˜¯è§£å†³è¿™äº›é—®é¢˜çš„ï¼
```

### 1.3 å®¹é”™æœºåˆ¶çš„åˆ†ç±»


| æœºåˆ¶ç±»å‹ | **ä½œç”¨** | **æ¯”å–»** | **éš¾åº¦** |
|---------|---------|---------|---------|
| ğŸ” **å¿ƒè·³æ£€æµ‹** | `å®šæœŸæ£€æŸ¥æœåŠ¡æ˜¯å¦æ´»ç€` | `åƒä½“æ£€ï¼Œå®šæœŸæ£€æŸ¥èº«ä½“` | â­åŸºç¡€ |
| ğŸ”„ **è¶…æ—¶é‡è¯•** | `å¤±è´¥äº†å†è¯•å‡ æ¬¡` | `æ‰“ç”µè¯æ²¡æ¥é€šï¼Œå†æ‹¨ä¸€æ¬¡` | â­åŸºç¡€ |
| âš¡ **ç†”æ–­å™¨** | `é—®é¢˜ä¸¥é‡æ—¶ç›´æ¥æ–­å¼€` | `ç”µè·¯è·³é—¸ä¿æŠ¤` | â­â­ä¸­çº§ |
| ğŸ“‰ **æœåŠ¡é™çº§** | `æ ¸å¿ƒåŠŸèƒ½ä¼˜å…ˆï¼Œæ¬¡è¦åŠŸèƒ½æš‚åœ` | `æ´ªæ°´æ¥äº†å…ˆä¿ä¸»åŸ` | â­â­ä¸­çº§ |
| ğŸï¸ **æ•…éšœéš”ç¦»** | `éš”ç¦»æ•…éšœä¸è®©ä¼ æ’­` | `é˜²ç«å¢™éš”ç¦»ç«ç¾` | â­â­é«˜çº§ |

---

## 2. ğŸ’“ å¿ƒè·³æ£€æµ‹æœºåˆ¶


### 2.1 å¿ƒè·³æ£€æµ‹æ˜¯ä»€ä¹ˆ


**é€šä¿—è§£é‡Š**ï¼šå°±åƒåŒ»ç”Ÿå®šæœŸæ£€æŸ¥ç—…äººå¿ƒè·³ï¼Œæ³¨å†Œä¸­å¿ƒå®šæœŸæ£€æŸ¥æœåŠ¡æ˜¯å¦è¿˜æ´»ç€ã€‚

```
å·¥ä½œåŸç†å›¾ç¤ºï¼š

æœåŠ¡æä¾›è€…                    æ³¨å†Œä¸­å¿ƒ
    |                           |
    |----[å‘é€å¿ƒè·³]------------->|  æ¯éš”15ç§’å‘ä¸€æ¬¡
    |<---[ç¡®è®¤æ”¶åˆ°]--------------|
    |                           |
    |----[å‘é€å¿ƒè·³]------------->|  åˆè¿‡äº†15ç§’
    |<---[ç¡®è®¤æ”¶åˆ°]--------------|
    
å¦‚æœè¿ç»­3æ¬¡æ²¡æ”¶åˆ°å¿ƒè·³ï¼ˆ45ç§’ï¼‰â†’ åˆ¤å®šæœåŠ¡å·²æŒ‚
```

**å¿ƒè·³çš„ä½œç”¨**ï¼š
- âœ… **å¥åº·æ£€æŸ¥**ï¼šç¡®è®¤æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ
- âœ… **åŠæ—¶å‘ç°**ï¼šæœåŠ¡æŒ‚äº†èƒ½å¿«é€Ÿå‘ç°
- âœ… **è‡ªåŠ¨å‰”é™¤**ï¼šå°†æŒ‚æ‰çš„æœåŠ¡ä»åˆ—è¡¨ä¸­ç§»é™¤

### 2.2 Nacoså¿ƒè·³é…ç½®


**é…ç½®ç¤ºä¾‹**ï¼š

```yaml
spring:
  cloud:
    nacos:
      discovery:
        # å¿ƒè·³é—´éš”æ—¶é—´ï¼ˆé»˜è®¤5ç§’ï¼‰
        heart-beat-interval: 5000
        # å¿ƒè·³è¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤15ç§’ï¼‰
        heart-beat-timeout: 15000
        # IPåˆ é™¤è¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤30ç§’ï¼‰
        ip-delete-timeout: 30000
```

**å‚æ•°å«ä¹‰è§£é‡Š**ï¼š
- `heart-beat-interval`ï¼šå¤šä¹…å‘é€ä¸€æ¬¡å¿ƒè·³ï¼ˆåƒæ¯5ç§’æŠ¥å‘Šä¸€æ¬¡"æˆ‘è¿˜æ´»ç€"ï¼‰
- `heart-beat-timeout`ï¼šå¤šä¹…æ²¡æ”¶åˆ°å¿ƒè·³ç®—è¶…æ—¶ï¼ˆ15ç§’æ²¡æ¶ˆæ¯å°±å¯èƒ½æœ‰é—®é¢˜ï¼‰
- `ip-delete-timeout`ï¼šè¶…æ—¶åå¤šä¹…åˆ é™¤æœåŠ¡ï¼ˆ30ç§’åå½»åº•ç§»é™¤ï¼‰

### 2.3 å¿ƒè·³æ£€æµ‹çš„å®ç°æ–¹å¼


**ä¸´æ—¶å®ä¾‹ vs æŒä¹…åŒ–å®ä¾‹**ï¼š

```
ä¸´æ—¶å®ä¾‹ï¼ˆé»˜è®¤ï¼‰ï¼š
æœåŠ¡å¯åŠ¨ â†’ å‘é€å¿ƒè·³ â†’ æŒç»­å¿ƒè·³ â†’ åœæ­¢å¿ƒè·³åè¢«åˆ é™¤
ç‰¹ç‚¹ï¼šå¿ƒè·³åœäº†å°±è‡ªåŠ¨åˆ é™¤ï¼Œé€‚åˆåŠ¨æ€æ‰©ç¼©å®¹

æŒä¹…åŒ–å®ä¾‹ï¼š
æœåŠ¡å¯åŠ¨ â†’ æ³¨å†Œåˆ°Nacos â†’ å³ä½¿å¿ƒè·³åœäº†ä¹Ÿä¸åˆ é™¤
ç‰¹ç‚¹ï¼šéœ€è¦æ‰‹åŠ¨åˆ é™¤ï¼Œé€‚åˆå›ºå®šçš„æ ¸å¿ƒæœåŠ¡
```

**é…ç½®æŒä¹…åŒ–å®ä¾‹**ï¼š

```yaml
spring:
  cloud:
    nacos:
      discovery:
        ephemeral: false  # falseè¡¨ç¤ºæŒä¹…åŒ–å®ä¾‹
```

### 2.4 å¿ƒè·³æ£€æµ‹æœ€ä½³å®è·µ


> ğŸ’¡ **å®è·µå»ºè®®**ï¼š
> - å¿ƒè·³é—´éš”ä¸è¦å¤ªçŸ­ï¼ˆä¼šå¢åŠ ç½‘ç»œè´Ÿæ‹…ï¼‰
> - å¿ƒè·³é—´éš”ä¸è¦å¤ªé•¿ï¼ˆå‘ç°æ•…éšœä¼šå»¶è¿Ÿï¼‰
> - å»ºè®®é…ç½®ï¼š5-10ç§’å¿ƒè·³é—´éš”

> âš ï¸ **æ³¨æ„äº‹é¡¹**ï¼š
> - ç½‘ç»œæŠ–åŠ¨å¯èƒ½å¯¼è‡´è¯¯åˆ¤
> - éœ€è¦é…åˆé‡è¯•æœºåˆ¶ä½¿ç”¨
> - è€ƒè™‘æœåŠ¡å¯åŠ¨æ—¶é—´ï¼Œé¿å…åˆšå¯åŠ¨å°±è¢«å‰”é™¤

---

## 3. ğŸ”„ è¶…æ—¶é‡è¯•ç­–ç•¥


### 3.1 ä¸ºä»€ä¹ˆéœ€è¦é‡è¯•


**æ—¥å¸¸ç”Ÿæ´»ä¾‹å­**ï¼š
```
æ‰“ç”µè¯æ²¡æ¥é€š â†’ å¯èƒ½å¯¹æ–¹æ­£å¿™ â†’ è¿‡ä¸€ä¼šå†æ‰“
è®¿é—®ç½‘é¡µå¤±è´¥ â†’ å¯èƒ½ç½‘ç»œæ³¢åŠ¨ â†’ åˆ·æ–°é‡è¯•
å¾®æœåŠ¡è°ƒç”¨å¤±è´¥ â†’ å¯èƒ½ä¸´æ—¶æ•…éšœ â†’ è‡ªåŠ¨é‡è¯•
```

**é‡è¯•è§£å†³çš„é—®é¢˜**ï¼š
- **ç½‘ç»œæŠ–åŠ¨**ï¼šä¸´æ—¶çš„ç½‘ç»œæ³¢åŠ¨å¯¼è‡´è°ƒç”¨å¤±è´¥
- **æœåŠ¡å¿™ç¢Œ**ï¼šæœåŠ¡æš‚æ—¶å¤„ç†ä¸è¿‡æ¥
- **å¶å‘å¼‚å¸¸**ï¼šéšæœºå‡ºç°çš„ä¸´æ—¶æ€§é”™è¯¯

### 3.2 é‡è¯•ç­–ç•¥é…ç½®


**Ribboné‡è¯•é…ç½®**ï¼ˆé€‚ç”¨äºæ—§ç‰ˆSpring Cloudï¼‰ï¼š

```yaml
# æœåŠ¡åç§°
user-service:
  ribbon:
    # è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
    ConnectTimeout: 1000
    # è¯»å–è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
    ReadTimeout: 3000
    # æ˜¯å¦å¯¹æ‰€æœ‰è¯·æ±‚é‡è¯•
    OkToRetryOnAllOperations: false
    # åŒä¸€å®ä¾‹é‡è¯•æ¬¡æ•°ï¼ˆä¸å«ç¬¬ä¸€æ¬¡ï¼‰
    MaxAutoRetries: 1
    # åˆ‡æ¢å®ä¾‹çš„é‡è¯•æ¬¡æ•°
    MaxAutoRetriesNextServer: 2
```

**å‚æ•°é€šä¿—è§£é‡Š**ï¼š
- `ConnectTimeout`ï¼šå»ºç«‹è¿æ¥ç­‰å¤šä¹…ï¼ˆåƒæ‹¨å·ç­‰å¾…æ¥é€šçš„æ—¶é—´ï¼‰
- `ReadTimeout`ï¼šç­‰å¾…å“åº”å¤šä¹…ï¼ˆåƒç­‰å¯¹æ–¹è¯´è¯çš„æ—¶é—´ï¼‰
- `MaxAutoRetries`ï¼šåœ¨åŒä¸€å°æœºå™¨ä¸Šé‡è¯•å‡ æ¬¡
- `MaxAutoRetriesNextServer`ï¼šæ¢å‡ å°æœºå™¨é‡è¯•

### 3.3 é‡è¯•æ¬¡æ•°è®¡ç®—


**é‡è¯•æ¬¡æ•°å…¬å¼**ï¼š
```
æ€»è¯·æ±‚æ¬¡æ•° = 1 + MaxAutoRetries + 
            (1 + MaxAutoRetries) Ã— MaxAutoRetriesNextServer

ç¤ºä¾‹è®¡ç®—ï¼š
MaxAutoRetries = 1ï¼ˆåŒä¸€å®ä¾‹é‡è¯•1æ¬¡ï¼‰
MaxAutoRetriesNextServer = 2ï¼ˆæ¢2ä¸ªå®ä¾‹ï¼‰

æ€»è¯·æ±‚æ¬¡æ•° = 1 + 1 + (1 + 1) Ã— 2 = 6æ¬¡

è¯·æ±‚æµç¨‹ï¼š
å®ä¾‹Aå°è¯•2æ¬¡ â†’ å®ä¾‹Bå°è¯•2æ¬¡ â†’ å®ä¾‹Cå°è¯•2æ¬¡
```

### 3.4 é‡è¯•çš„æ³¨æ„äº‹é¡¹


> âš ï¸ **é‡è¦è­¦å‘Š**ï¼š
> 
> **ä¸æ˜¯æ‰€æœ‰è¯·æ±‚éƒ½èƒ½é‡è¯•ï¼**
> - âœ… **æŸ¥è¯¢è¯·æ±‚**ï¼šå¯ä»¥é‡è¯•ï¼ˆGETè¯·æ±‚ï¼‰
> - âŒ **ä¿®æ”¹è¯·æ±‚**ï¼šæ…é‡é‡è¯•ï¼ˆPOST/PUT/DELETEï¼‰
> 
> **ä¸ºä»€ä¹ˆä¿®æ”¹è¯·æ±‚ä¸èƒ½éšä¾¿é‡è¯•ï¼Ÿ**
> ```
> åœºæ™¯ï¼šç”¨æˆ·ä¸‹å•
> ç¬¬1æ¬¡è¯·æ±‚ â†’ è¶…æ—¶äº†ï¼ˆä½†å…¶å®è®¢å•å·²åˆ›å»ºï¼‰
> è‡ªåŠ¨é‡è¯• â†’ åˆåˆ›å»ºäº†ä¸€ä¸ªè®¢å•
> ç»“æœï¼šç”¨æˆ·ä¹°äº†2ä»½ï¼
> ```

**å®‰å…¨çš„é‡è¯•é…ç½®**ï¼š

```yaml
user-service:
  ribbon:
    # å…³é”®ï¼šåªå¯¹GETè¯·æ±‚é‡è¯•
    OkToRetryOnAllOperations: false
    MaxAutoRetries: 1
    MaxAutoRetriesNextServer: 1
```

### 3.5 è¶…æ—¶ä¸é‡è¯•çš„é…åˆ


**åˆç†çš„è¶…æ—¶é…ç½®**ï¼š

```
è¶…æ—¶æ—¶é—´è®¡ç®—ï¼š
ä¸šåŠ¡å¤„ç†æ—¶é—´ï¼šå¹³å‡500msï¼Œæœ€æ…¢1000ms
ç½‘ç»œä¼ è¾“æ—¶é—´ï¼š100ms
å®‰å…¨ä½™é‡ï¼š50%

ReadTimeout = (1000 + 100) Ã— 1.5 = 1650ms
å»ºè®®è®¾ç½®ï¼š2000ms

é‡è¯•ç­–ç•¥ï¼š
ç¬¬1æ¬¡ï¼š2000msè¶…æ—¶
ç¬¬2æ¬¡ï¼š2000msè¶…æ—¶ï¼ˆæ¢å®ä¾‹ï¼‰
ç¬¬3æ¬¡ï¼š2000msè¶…æ—¶ï¼ˆå†æ¢å®ä¾‹ï¼‰
æ€»è€—æ—¶æœ€å¤šï¼š6000ms
```

---

## 4. âš¡ ç†”æ–­å™¨æ¨¡å¼


### 4.1 ç†”æ–­å™¨æ˜¯ä»€ä¹ˆ


**ç”Ÿæ´»ç±»æ¯”**ï¼š
```
å®¶é‡Œçš„ç”µè·¯æ–­è·¯å™¨ï¼š
æ­£å¸¸ç”¨ç”µ â†’ ç”µè·¯æ­£å¸¸å·¥ä½œ
ç”¨ç”µè¿‡è½½ â†’ æ–­è·¯å™¨è·³é—¸ï¼ˆç†”æ–­ï¼‰
ä¿æŠ¤ç”µè·¯ â†’ é˜²æ­¢ç”µçº¿çƒ§æ¯

å¾®æœåŠ¡ç†”æ–­å™¨ï¼š
æ­£å¸¸è°ƒç”¨ â†’ ç†”æ–­å™¨å…³é—­ï¼ˆCLOSEDï¼‰
è°ƒç”¨é¢‘ç¹å¤±è´¥ â†’ ç†”æ–­å™¨æ‰“å¼€ï¼ˆOPENï¼‰
ä¿æŠ¤ç³»ç»Ÿ â†’ é˜²æ­¢é›ªå´©æ•ˆåº”
```

### 4.2 ç†”æ–­å™¨çš„ä¸‰ç§çŠ¶æ€


**çŠ¶æ€è½¬æ¢å›¾**ï¼š

```
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    å¯åŠ¨   â”‚   CLOSED    â”‚  æ­£å¸¸çŠ¶æ€
    â”€â”€â”€â”€â”€â”€>â”‚  (å…³é—­çŠ¶æ€)  â”‚  æ‰€æœ‰è¯·æ±‚é€šè¿‡
           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ å¤±è´¥ç‡è¾¾åˆ°é˜ˆå€¼
                  â†“
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚    OPEN     â”‚  ç†”æ–­çŠ¶æ€
           â”‚  (æ‰“å¼€çŠ¶æ€)  â”‚  æ‰€æœ‰è¯·æ±‚ç›´æ¥æ‹’ç»
           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ ç­‰å¾…ä¸€æ®µæ—¶é—´
                  â†“
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ HALF_OPEN   â”‚  åŠå¼€çŠ¶æ€
           â”‚  (åŠå¼€çŠ¶æ€)  â”‚  å…è®¸å°‘é‡è¯·æ±‚å°è¯•
           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                   â”‚
    æˆåŠŸç‡é«˜            å¤±è´¥ç‡é«˜
        â”‚                   â”‚
        â†“                   â†“
     CLOSED               OPEN
```

**çŠ¶æ€è¯¦è§£**ï¼š

â‘  **CLOSEDï¼ˆå…³é—­çŠ¶æ€ï¼‰**ï¼š
- æ­£å¸¸å·¥ä½œï¼Œæ‰€æœ‰è¯·æ±‚éƒ½èƒ½é€šè¿‡
- ç»Ÿè®¡å¤±è´¥ç‡
- å¤±è´¥ç‡è¶…è¿‡é˜ˆå€¼â†’è½¬ä¸ºOPEN

â‘¡ **OPENï¼ˆæ‰“å¼€çŠ¶æ€ï¼‰**ï¼š
- ç†”æ–­å™¨æ‰“å¼€ï¼Œç›´æ¥æ‹’ç»è¯·æ±‚
- å¿«é€Ÿå¤±è´¥ï¼Œä¸å†è°ƒç”¨è¿œç¨‹æœåŠ¡
- ç­‰å¾…ä¸€æ®µæ—¶é—´â†’è½¬ä¸ºHALF_OPEN

â‘¢ **HALF_OPENï¼ˆåŠå¼€çŠ¶æ€ï¼‰**ï¼š
- å…è®¸å°‘é‡è¯·æ±‚å°è¯•
- å¦‚æœæˆåŠŸâ†’è½¬ä¸ºCLOSED
- å¦‚æœå¤±è´¥â†’è½¬å›OPEN

### 4.3 Sentinelç†”æ–­å™¨é…ç½®


**æ·»åŠ ä¾èµ–**ï¼š

```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>
</dependency>
```

**ç†”æ–­è§„åˆ™é…ç½®**ï¼š

```java
@Configuration
public class SentinelConfig {
    
    @PostConstruct
    public void initDegradeRule() {
        List<DegradeRule> rules = new ArrayList<>();
        
        DegradeRule rule = new DegradeRule();
        // èµ„æºåç§°ï¼ˆæ¥å£è·¯å¾„æˆ–æœåŠ¡åï¼‰
        rule.setResource("user-service");
        // ç†”æ–­ç­–ç•¥ï¼šæ…¢è°ƒç”¨æ¯”ä¾‹
        rule.setGrade(RuleConstant.DEGRADE_GRADE_RT);
        // å“åº”æ—¶é—´é˜ˆå€¼ï¼š500ms
        rule.setCount(500);
        // è§¦å‘ç†”æ–­çš„æœ€å°è¯·æ±‚æ•°ï¼š10ä¸ª
        rule.setMinRequestAmount(10);
        // æ…¢è°ƒç”¨æ¯”ä¾‹é˜ˆå€¼ï¼š50%
        rule.setSlowRatioThreshold(0.5);
        // ç†”æ–­æ—¶é•¿ï¼š10ç§’
        rule.setTimeWindow(10);
        
        rules.add(rule);
        DegradeRuleManager.loadRules(rules);
    }
}
```

**å‚æ•°é€šä¿—è§£é‡Š**ï¼š
```
è¿™ä¸ªé…ç½®çš„å«ä¹‰ï¼š
- å¦‚æœ10ä¸ªè¯·æ±‚ä¸­ï¼Œæœ‰5ä¸ªï¼ˆ50%ï¼‰å“åº”æ—¶é—´è¶…è¿‡500ms
- å°±è§¦å‘ç†”æ–­ï¼ŒæŒç»­10ç§’
- 10ç§’åå°è¯•æ¢å¤ï¼ˆè¿›å…¥åŠå¼€çŠ¶æ€ï¼‰
```

### 4.4 ç†”æ–­ç­–ç•¥å¯¹æ¯”


| ç†”æ–­ç­–ç•¥ | **è§¦å‘æ¡ä»¶** | **é€‚ç”¨åœºæ™¯** | **é…ç½®ç¤ºä¾‹** |
|---------|------------|------------|------------|
| ğŸŒ **æ…¢è°ƒç”¨æ¯”ä¾‹** | `å“åº”æ—¶é—´è¶…è¿‡é˜ˆå€¼çš„æ¯”ä¾‹` | `æœåŠ¡å“åº”æ…¢` | `RT>500ms,æ¯”ä¾‹>50%` |
| âŒ **å¼‚å¸¸æ¯”ä¾‹** | `å¼‚å¸¸è¯·æ±‚çš„æ¯”ä¾‹` | `æœåŠ¡å‡ºé”™å¤š` | `å¼‚å¸¸æ¯”ä¾‹>50%` |
| ğŸ”¢ **å¼‚å¸¸æ•°** | `å¼‚å¸¸è¯·æ±‚çš„æ•°é‡` | `è¯·æ±‚é‡å°çš„æœåŠ¡` | `å¼‚å¸¸æ•°>10ä¸ª` |

**é€‰æ‹©å»ºè®®**ï¼š
- é«˜å¹¶å‘æœåŠ¡ â†’ ç”¨**æ…¢è°ƒç”¨æ¯”ä¾‹**æˆ–**å¼‚å¸¸æ¯”ä¾‹**
- ä½å¹¶å‘æœåŠ¡ â†’ ç”¨**å¼‚å¸¸æ•°**
- å“åº”æ—¶é—´æ•æ„Ÿ â†’ ç”¨**æ…¢è°ƒç”¨æ¯”ä¾‹**

### 4.5 ç†”æ–­é™çº§å¤„ç†


**å®šä¹‰é™çº§æ–¹æ³•**ï¼š

```java
@Service
public class UserService {
    
    @SentinelResource(
        value = "getUserInfo",
        blockHandler = "handleBlock",  // ç†”æ–­æ—¶è°ƒç”¨
        fallback = "handleFallback"    // å¼‚å¸¸æ—¶è°ƒç”¨
    )
    public User getUserInfo(Long id) {
        // æ­£å¸¸ä¸šåŠ¡é€»è¾‘
        return userClient.getUser(id);
    }
    
    // ç†”æ–­é™çº§æ–¹æ³•
    public User handleBlock(Long id, BlockException ex) {
        return User.builder()
            .id(id)
            .name("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•")
            .build();
    }
    
    // å¼‚å¸¸å…œåº•æ–¹æ³•
    public User handleFallback(Long id, Throwable ex) {
        return User.builder()
            .id(id)
            .name("æœåŠ¡å¼‚å¸¸")
            .build();
    }
}
```

---

## 5. ğŸ“‰ æœåŠ¡é™çº§æ–¹æ¡ˆ


### 5.1 æœåŠ¡é™çº§æ˜¯ä»€ä¹ˆ


**é€šä¿—ç†è§£**ï¼šå°±åƒæ´ªæ°´æ¥äº†ï¼Œå…ˆä¿ä½ä¸»åŸåŒºï¼Œæ¬¡è¦åŒºåŸŸæš‚æ—¶æ”¾å¼ƒã€‚

```
åŒ11åœºæ™¯ï¼š
æ­£å¸¸æ—¶æœŸï¼š
- å•†å“æœç´¢ âœ…
- æ¨èç³»ç»Ÿ âœ…
- è¯„è®ºå±•ç¤º âœ…
- ç§¯åˆ†ç³»ç»Ÿ âœ…

æµé‡é«˜å³°æ—¶ï¼ˆé™çº§ï¼‰ï¼š
- å•†å“æœç´¢ âœ…ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼Œå¿…é¡»ä¿è¯ï¼‰
- æ¨èç³»ç»Ÿ âŒï¼ˆæš‚åœï¼Œè¿”å›å›ºå®šå†…å®¹ï¼‰
- è¯„è®ºå±•ç¤º âŒï¼ˆåªæ˜¾ç¤ºçƒ­é—¨è¯„è®ºï¼‰
- ç§¯åˆ†ç³»ç»Ÿ âŒï¼ˆæš‚åœç§¯åˆ†ç´¯åŠ ï¼‰
```

### 5.2 é™çº§çš„åˆ†ç±»


**â‘  è‡ªåŠ¨é™çº§ï¼ˆç†”æ–­é™çº§ï¼‰**ï¼š
- ç³»ç»Ÿè‡ªåŠ¨æ£€æµ‹é—®é¢˜
- è‡ªåŠ¨è§¦å‘é™çº§
- é—®é¢˜è§£å†³åè‡ªåŠ¨æ¢å¤

**â‘¡ æ‰‹åŠ¨é™çº§**ï¼š
- äººå·¥åˆ¤æ–­éœ€è¦é™çº§
- æ‰‹åŠ¨å¼€å…³æ§åˆ¶
- å¸¸ç”¨äºå¤§ä¿ƒæ´»åŠ¨

### 5.3 é™çº§ç­–ç•¥è®¾è®¡


**é™çº§çº§åˆ«åˆ’åˆ†**ï¼š

```
æ ¸å¿ƒæœåŠ¡ï¼ˆä¸å¯é™çº§ï¼‰ï¼š
- ç”¨æˆ·ç™»å½•
- å•†å“ä¸‹å•
- æ”¯ä»˜æœåŠ¡

é‡è¦æœåŠ¡ï¼ˆéƒ¨åˆ†é™çº§ï¼‰ï¼š
- å•†å“è¯¦æƒ…ï¼ˆç®€åŒ–å±•ç¤ºï¼‰
- è´­ç‰©è½¦ï¼ˆåŸºç¡€åŠŸèƒ½ï¼‰
- è®¢å•æŸ¥è¯¢ï¼ˆé™åˆ¶æŸ¥è¯¢èŒƒå›´ï¼‰

æ¬¡è¦æœåŠ¡ï¼ˆå®Œå…¨é™çº§ï¼‰ï¼š
- æ¨èç³»ç»Ÿï¼ˆè¿”å›ç¼“å­˜ï¼‰
- è¯„è®ºç³»ç»Ÿï¼ˆæš‚åœå±•ç¤ºï¼‰
- ç§¯åˆ†ç³»ç»Ÿï¼ˆå»¶è¿Ÿè®¡ç®—ï¼‰

å¯å…³é—­æœåŠ¡ï¼š
- è¥é”€æ´»åŠ¨
- ä¼˜æƒ åˆ¸å‘æ”¾
- å®æ—¶ç»Ÿè®¡
```

### 5.4 é™çº§å¼€å…³å®ç°


**ä½¿ç”¨Nacosé…ç½®ä¸­å¿ƒ**ï¼š

```yaml
# Nacosé…ç½®æ–‡ä»¶ï¼šdegradation-config.yaml
degradation:
  # æ¨èæœåŠ¡é™çº§å¼€å…³
  recommendation:
    enabled: true
    defaultContent: "ä¸ºæ‚¨æ¨èçƒ­é—¨å•†å“"
  
  # è¯„è®ºæœåŠ¡é™çº§å¼€å…³  
  comment:
    enabled: true
    maxShowCount: 5
  
  # ç§¯åˆ†æœåŠ¡é™çº§å¼€å…³
  points:
    enabled: false
```

**ä»£ç å®ç°**ï¼š

```java
@RefreshScope  // æ”¯æŒåŠ¨æ€åˆ·æ–°
@Service
public class RecommendationService {
    
    @Value("${degradation.recommendation.enabled:false}")
    private boolean degradationEnabled;
    
    @Value("${degradation.recommendation.defaultContent}")
    private String defaultContent;
    
    public List<Product> getRecommendations(Long userId) {
        // æ£€æŸ¥é™çº§å¼€å…³
        if (degradationEnabled) {
            return getDefaultRecommendations();
        }
        
        // æ­£å¸¸æ¨èé€»è¾‘
        return aiRecommendationService.recommend(userId);
    }
    
    private List<Product> getDefaultRecommendations() {
        // è¿”å›é™çº§æ•°æ®ï¼ˆå¦‚çƒ­é—¨å•†å“ï¼‰
        return productService.getHotProducts();
    }
}
```

### 5.5 é™çº§ç›‘æ§ä¸æ¢å¤


**é™çº§çŠ¶æ€ç›‘æ§**ï¼š

```java
@Component
public class DegradationMonitor {
    
    @Scheduled(fixedRate = 30000)  // æ¯30ç§’æ£€æŸ¥
    public void checkDegradationStatus() {
        Map<String, Boolean> status = new HashMap<>();
        status.put("recommendation", recommendationDegraded);
        status.put("comment", commentDegraded);
        status.put("points", pointsDegraded);
        
        // ä¸ŠæŠ¥ç›‘æ§ç³»ç»Ÿ
        monitoringService.report("degradation.status", status);
    }
}
```

> ğŸ’¡ **é™çº§æ¢å¤åŸåˆ™**ï¼š
> - å…ˆæ¢å¤æ ¸å¿ƒåŠŸèƒ½
> - é€æ­¥æ¢å¤æ¬¡è¦åŠŸèƒ½
> - è§‚å¯Ÿç³»ç»ŸæŒ‡æ ‡å†å†³å®š
> - é¿å…ä¸€æ¬¡æ€§å…¨éƒ¨æ¢å¤

---

## 6. ğŸï¸ æ•…éšœéš”ç¦»æŠ€æœ¯


### 6.1 ä»€ä¹ˆæ˜¯æ•…éšœéš”ç¦»


**å½¢è±¡æ¯”å–»**ï¼š
```
æ³°å¦å°¼å…‹å·çš„éš”èˆ±è®¾è®¡ï¼š
ä¸€ä¸ªèˆ±è¿›æ°´ â†’ å…³é—­éš”èˆ±é—¨ â†’ å…¶ä»–èˆ±ä¸å—å½±å“
å¾®æœåŠ¡çš„æ•…éšœéš”ç¦»ï¼š
ä¸€ä¸ªæœåŠ¡æ•…éšœ â†’ éš”ç¦»è¯¥æœåŠ¡ â†’ å…¶ä»–æœåŠ¡æ­£å¸¸è¿è¡Œ
```

### 6.2 çº¿ç¨‹æ± éš”ç¦»


**é—®é¢˜åœºæ™¯**ï¼š
```
æ²¡æœ‰éš”ç¦»æ—¶ï¼š
ç”¨æˆ·æœåŠ¡è°ƒç”¨ç¬¬ä¸‰æ–¹æœåŠ¡ï¼ˆå¾ˆæ…¢ï¼‰â†’ å ç”¨å¤§é‡çº¿ç¨‹
â†’ ç”¨æˆ·æœåŠ¡è‡ªå·±çš„çº¿ç¨‹ä¹Ÿè¢«å æ»¡
â†’ æ­£å¸¸è¯·æ±‚ä¹Ÿæ— æ³•å¤„ç†
â†’ ç”¨æˆ·æœåŠ¡å´©æºƒ

ä½¿ç”¨çº¿ç¨‹æ± éš”ç¦»åï¼š
ä¸ºç¬¬ä¸‰æ–¹è°ƒç”¨åˆ†é…ç‹¬ç«‹çº¿ç¨‹æ± ï¼ˆå¦‚10ä¸ªçº¿ç¨‹ï¼‰
â†’ ç¬¬ä¸‰æ–¹å†æ…¢ä¹Ÿåªå ç”¨è¿™10ä¸ªçº¿ç¨‹
â†’ ä¸å½±å“å…¶ä»–ä¸šåŠ¡çš„çº¿ç¨‹
â†’ ç³»ç»Ÿä¾ç„¶å¯ç”¨
```

**Hystrixçº¿ç¨‹æ± é…ç½®**ï¼š

```java
@HystrixCommand(
    commandKey = "getUserInfo",
    threadPoolKey = "userServicePool",
    threadPoolProperties = {
        // æ ¸å¿ƒçº¿ç¨‹æ•°
        @HystrixProperty(name="coreSize", value="10"),
        // æœ€å¤§çº¿ç¨‹æ•°
        @HystrixProperty(name="maximumSize", value="20"),
        // é˜Ÿåˆ—å¤§å°
        @HystrixProperty(name="maxQueueSize", value="50")
    }
)
public User getUserInfo(Long id) {
    return userClient.getUser(id);
}
```

### 6.3 ä¿¡å·é‡éš”ç¦»


**ä¿¡å·é‡ vs çº¿ç¨‹æ± **ï¼š

```
çº¿ç¨‹æ± éš”ç¦»ï¼ˆé‡é‡çº§ï¼‰ï¼š
- æ¯ä¸ªè¯·æ±‚ä½¿ç”¨ç‹¬ç«‹çº¿ç¨‹
- å¼€é”€å¤§ï¼Œä½†éš”ç¦»æ€§å¥½
- é€‚åˆï¼šè€—æ—¶çš„è¿œç¨‹è°ƒç”¨

ä¿¡å·é‡éš”ç¦»ï¼ˆè½»é‡çº§ï¼‰ï¼š
- æ§åˆ¶å¹¶å‘æ•°é‡ï¼Œä¸åˆ›å»ºçº¿ç¨‹
- å¼€é”€å°ï¼Œä½†éš”ç¦»æ€§å¼±
- é€‚åˆï¼šå¿«é€Ÿçš„æœ¬åœ°è°ƒç”¨
```

**ä¿¡å·é‡é…ç½®**ï¼š

```java
@HystrixCommand(
    commandKey = "getLocalCache",
    commandProperties = {
        // ä½¿ç”¨ä¿¡å·é‡éš”ç¦»
        @HystrixProperty(
            name="execution.isolation.strategy",
            value="SEMAPHORE"
        ),
        // æœ€å¤§å¹¶å‘æ•°
        @HystrixProperty(
            name="execution.isolation.semaphore.maxConcurrentRequests",
            value="100"
        )
    }
)
public String getFromCache(String key) {
    return redisTemplate.opsForValue().get(key);
}
```

### 6.4 èˆ±å£æ¨¡å¼


**èˆ±å£æ¨¡å¼åŸç†**ï¼š
```
æŠŠèµ„æºåˆ†éš”æˆå¤šä¸ªç‹¬ç«‹çš„æ± ï¼š

            ç³»ç»Ÿæ€»èµ„æº
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ç”¨æˆ·æœåŠ¡ â”‚ è®¢å•æœåŠ¡ â”‚ æ”¯ä»˜æœåŠ¡ â”‚
    â”‚  çº¿ç¨‹æ±   â”‚  çº¿ç¨‹æ±   â”‚  çº¿ç¨‹æ±   â”‚
    â”‚  20çº¿ç¨‹  â”‚  30çº¿ç¨‹  â”‚  50çº¿ç¨‹  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜åŠ¿ï¼š
- è®¢å•æœåŠ¡æŒ‚äº†ï¼Œåªå½±å“30ä¸ªçº¿ç¨‹
- ç”¨æˆ·æœåŠ¡å’Œæ”¯ä»˜æœåŠ¡ä¸å—å½±å“
- ç³»ç»Ÿæ•´ä½“ä¾ç„¶å¯ç”¨
```

---

## 7. âš¡ å¿«é€Ÿå¤±è´¥æœºåˆ¶


### 7.1 å¿«é€Ÿå¤±è´¥çš„ç†å¿µ


**å¯¹æ¯”ç†è§£**ï¼š
```
æ…¢å¤±è´¥ï¼ˆä¸å¥½çš„æ–¹å¼ï¼‰ï¼š
è¯·æ±‚ â†’ ç­‰å¾…è¶…æ—¶(30s) â†’ é‡è¯• â†’ å†è¶…æ—¶(30s) â†’ å¤±è´¥
æ€»è€—æ—¶ï¼š60ç§’ï¼Œç”¨æˆ·ä½“éªŒæå·®

å¿«é€Ÿå¤±è´¥ï¼ˆå¥½çš„æ–¹å¼ï¼‰ï¼š
è¯·æ±‚ â†’ æ£€æµ‹åˆ°é—®é¢˜ â†’ ç«‹å³è¿”å›å¤±è´¥(0.1s)
æ€»è€—æ—¶ï¼š0.1ç§’ï¼Œç”¨æˆ·ä½“éªŒå¥½
```

### 7.2 å¿«é€Ÿå¤±è´¥çš„å®ç°


**â‘  ç†”æ–­å™¨å¿«é€Ÿå¤±è´¥**ï¼š
```java
// ç†”æ–­å™¨æ‰“å¼€æ—¶ï¼Œç›´æ¥å¿«é€Ÿå¤±è´¥
if (circuitBreakerOpen) {
    throw new CircuitBreakerException("æœåŠ¡å·²ç†”æ–­");
}
```

**â‘¡ è¶…æ—¶å¿«é€Ÿå¤±è´¥**ï¼š
```java
@HystrixCommand(
    commandProperties = {
        // è®¾ç½®è¾ƒçŸ­çš„è¶…æ—¶æ—¶é—´
        @HystrixProperty(
            name="execution.isolation.thread.timeoutInMilliseconds",
            value="2000"  // 2ç§’è¶…æ—¶
        )
    }
)
```

**â‘¢ é™æµå¿«é€Ÿå¤±è´¥**ï¼š
```java
// è¯·æ±‚æ•°è¶…è¿‡é™åˆ¶ï¼Œç›´æ¥æ‹’ç»
if (currentRequests > maxRequests) {
    throw new RateLimitException("è¯·æ±‚è¿‡å¤šï¼Œè¯·ç¨åé‡è¯•");
}
```

### 7.3 å‹å¥½çš„å¤±è´¥æç¤º


**ç”¨æˆ·å‹å¥½çš„é”™è¯¯å¤„ç†**ï¼š

```java
@RestControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(CircuitBreakerException.class)
    public Result handleCircuitBreaker(CircuitBreakerException e) {
        return Result.error("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
    }
    
    @ExceptionHandler(TimeoutException.class)
    public Result handleTimeout(TimeoutException e) {
        return Result.error("è¯·æ±‚è¶…æ—¶ï¼Œè¯·åˆ·æ–°é‡è¯•");
    }
    
    @ExceptionHandler(RateLimitException.class)
    public Result handleRateLimit(RateLimitException e) {
        return Result.error("è®¿é—®è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•");
    }
}
```

---

## 8. ğŸ”§ å¼‚å¸¸æ¢å¤ç­–ç•¥


### 8.1 è‡ªåŠ¨æ¢å¤æœºåˆ¶


**å¥åº·æ£€æŸ¥æ¢å¤**ï¼š
```
ç†”æ–­å™¨åŠå¼€çŠ¶æ€ï¼š
â†’ å…è®¸å°‘é‡è¯·æ±‚é€šè¿‡
â†’ å¦‚æœæˆåŠŸç‡è¾¾æ ‡
â†’ è‡ªåŠ¨æ¢å¤åˆ°æ­£å¸¸çŠ¶æ€

æ¢å¤æ¡ä»¶ï¼š
- è¿ç»­3æ¬¡æˆåŠŸ â†’ æ¢å¤
- æœ‰1æ¬¡å¤±è´¥ â†’ ç»§ç»­ç†”æ–­
```

**å®ç°ç¤ºä¾‹**ï¼š
```java
// Sentinelè‡ªåŠ¨æ¢å¤é…ç½®
DegradeRule rule = new DegradeRule();
rule.setTimeWindow(10);  // ç†”æ–­10ç§’åè‡ªåŠ¨å°è¯•æ¢å¤
```

### 8.2 æ‰‹åŠ¨æ¢å¤æœºåˆ¶


**ç›‘æ§å¤§ç›˜è§¦å‘æ¢å¤**ï¼š
```java
@RestController
@RequestMapping("/admin")
public class RecoveryController {
    
    // æ‰‹åŠ¨æ¢å¤ç†”æ–­
    @PostMapping("/recover/circuit-breaker")
    public Result recoverCircuitBreaker(@RequestParam String serviceName) {
        // é‡ç½®ç†”æ–­å™¨çŠ¶æ€
        CircuitBreakerRegistry.getInstance()
            .getCircuitBreaker(serviceName)
            .reset();
        
        return Result.success("ç†”æ–­å™¨å·²æ¢å¤");
    }
    
    // æ‰‹åŠ¨å…³é—­é™çº§
    @PostMapping("/recover/degradation")
    public Result recoverDegradation(@RequestParam String feature) {
        // æ›´æ–°Nacosé…ç½®ï¼Œå…³é—­é™çº§å¼€å…³
        nacosConfigService.publishConfig(
            "degradation-config",
            feature + ".enabled",
            "false"
        );
        
        return Result.success("é™çº§å·²å…³é—­");
    }
}
```

### 8.3 æ¸è¿›å¼æ¢å¤


**æ¢å¤æµç¨‹è®¾è®¡**ï¼š
```
æ¢å¤é˜¶æ®µ1ï¼šå°æµé‡éªŒè¯ï¼ˆ5%æµé‡ï¼‰
â†’ è§‚å¯Ÿ5åˆ†é’Ÿï¼Œæ— é—®é¢˜
â†’ è¿›å…¥é˜¶æ®µ2

æ¢å¤é˜¶æ®µ2ï¼šä¸­æµé‡éªŒè¯ï¼ˆ30%æµé‡ï¼‰
â†’ è§‚å¯Ÿ10åˆ†é’Ÿï¼Œæ— é—®é¢˜
â†’ è¿›å…¥é˜¶æ®µ3

æ¢å¤é˜¶æ®µ3ï¼šå…¨æµé‡æ¢å¤ï¼ˆ100%æµé‡ï¼‰
â†’ æŒç»­ç›‘æ§1å°æ—¶
â†’ å®Œå…¨æ¢å¤
```

**ç°åº¦æ¢å¤å®ç°**ï¼š
```java
@Service
public class GrayRecoveryService {
    
    public boolean shouldUseRecoveredService(String userId) {
        int grayPercent = getGrayPercent();  // ä»é…ç½®ä¸­å¿ƒè·å–
        int hash = userId.hashCode() % 100;
        return hash < grayPercent;
    }
}
```

---

## 9. ğŸ§ª å®¹é”™æµ‹è¯•éªŒè¯


### 9.1 æ•…éšœæ³¨å…¥æµ‹è¯•


**Chaos Engineeringï¼ˆæ··æ²Œå·¥ç¨‹ï¼‰**ï¼š
```
ç›®çš„ï¼šä¸»åŠ¨åˆ¶é€ æ•…éšœï¼ŒéªŒè¯ç³»ç»Ÿå®¹é”™èƒ½åŠ›

å¸¸è§æ•…éšœæ³¨å…¥ï¼š
- å»¶è¿Ÿæ³¨å…¥ï¼šæ¨¡æ‹Ÿç½‘ç»œæ…¢
- å¼‚å¸¸æ³¨å…¥ï¼šæ¨¡æ‹ŸæœåŠ¡å‡ºé”™  
- æ–­ç½‘æ³¨å…¥ï¼šæ¨¡æ‹Ÿç½‘ç»œä¸­æ–­
- èµ„æºé™åˆ¶ï¼šæ¨¡æ‹ŸCPU/å†…å­˜ä¸è¶³
```

**ä½¿ç”¨Sentinelè¿›è¡Œæ•…éšœæ³¨å…¥**ï¼š
```java
// æ¨¡æ‹Ÿæ…¢è°ƒç”¨
@SentinelResource(
    value = "testSlowCall",
    blockHandler = "handleBlock"
)
public String testSlowCall() {
    // æ³¨å…¥å»¶è¿Ÿ
    Thread.sleep(2000);
    return "success";
}

// æ¨¡æ‹Ÿå¼‚å¸¸
@SentinelResource(
    value = "testException",
    fallback = "handleFallback"
)
public String testException() {
    if (Math.random() > 0.5) {
        throw new RuntimeException("æ¨¡æ‹Ÿå¼‚å¸¸");
    }
    return "success";
}
```

### 9.2 å‹åŠ›æµ‹è¯•éªŒè¯


**å®¹é”™èƒ½åŠ›å‹æµ‹**ï¼š
```
æµ‹è¯•åœºæ™¯1ï¼šæ­£å¸¸å‹åŠ›
- 1000 QPSï¼ŒæŒç»­10åˆ†é’Ÿ
- è§‚å¯Ÿï¼šæ‰€æœ‰è¯·æ±‚æˆåŠŸ

æµ‹è¯•åœºæ™¯2ï¼šè¶…è´Ÿè·å‹åŠ›  
- 5000 QPSï¼ŒæŒç»­5åˆ†é’Ÿ
- è§‚å¯Ÿï¼šé™æµã€é™çº§æ˜¯å¦ç”Ÿæ•ˆ

æµ‹è¯•åœºæ™¯3ï¼šæ•…éšœå‹åŠ›
- ä¾èµ–æœåŠ¡æ•…éšœ
- è§‚å¯Ÿï¼šç†”æ–­ã€é™çº§æ˜¯å¦ç”Ÿæ•ˆ
```

**JMeterå‹æµ‹è„šæœ¬ç¤ºä¾‹**ï¼š
```xml
<ThreadGroup>
  <stringProp name="ThreadGroup.num_threads">100</stringProp>
  <stringProp name="ThreadGroup.ramp_time">10</stringProp>
  <stringProp name="ThreadGroup.duration">300</stringProp>
  
  <HTTPSamplerProxy>
    <stringProp name="HTTPSampler.path">/api/test</stringProp>
    <stringProp name="HTTPSampler.method">GET</stringProp>
  </HTTPSamplerProxy>
</ThreadGroup>
```

### 9.3 å®¹é”™æŒ‡æ ‡ç›‘æ§


**å…³é”®æŒ‡æ ‡**ï¼š

| æŒ‡æ ‡ç±»å‹ | **ç›‘æ§å†…å®¹** | **å¥åº·æ ‡å‡†** |
|---------|------------|------------|
| ğŸ¯ **æˆåŠŸç‡** | `è¯·æ±‚æˆåŠŸæ¯”ä¾‹` | `>99.9%` |
| â±ï¸ **å“åº”æ—¶é—´** | `P99å“åº”æ—¶é—´` | `<500ms` |
| ğŸ”„ **é‡è¯•ç‡** | `é‡è¯•è¯·æ±‚å æ¯”` | `<5%` |
| âš¡ **ç†”æ–­æ¬¡æ•°** | `ç†”æ–­è§¦å‘é¢‘ç‡` | `<10æ¬¡/å°æ—¶` |
| ğŸ“‰ **é™çº§çŠ¶æ€** | `é™çº§åŠŸèƒ½æ•°é‡` | `åŠæ—¶æ¢å¤` |

**Grafanaç›‘æ§å¤§ç›˜é…ç½®**ï¼š
```yaml
dashboard:
  panels:
    - title: "æœåŠ¡æˆåŠŸç‡"
      metric: "http_requests_success_rate"
      threshold: 99.9
    
    - title: "ç†”æ–­å™¨çŠ¶æ€"  
      metric: "circuit_breaker_status"
      alert: "open"
    
    - title: "é™çº§å¼€å…³çŠ¶æ€"
      metric: "degradation_enabled"
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å®¹é”™æœºåˆ¶æ ¸å¿ƒç†å¿µ


```
ğŸ”¸ å®¹é”™â‰ æ¶ˆé™¤æ•…éšœï¼šè€Œæ˜¯æ•…éšœå‘ç”Ÿæ—¶ç³»ç»Ÿä¾ç„¶å¯ç”¨
ğŸ”¸ å¿«é€Ÿå¤±è´¥ï¼šä¸è¦è®©ç”¨æˆ·ç­‰å¾…ï¼Œå¿«é€Ÿåé¦ˆ
ğŸ”¸ è‡ªåŠ¨æ¢å¤ï¼šé—®é¢˜è§£å†³åè‡ªåŠ¨æ¢å¤ï¼Œå‡å°‘äººå·¥ä»‹å…¥
ğŸ”¸ åˆ†çº§é™çº§ï¼šä¿è¯æ ¸å¿ƒåŠŸèƒ½ï¼Œç‰ºç‰²æ¬¡è¦åŠŸèƒ½
ğŸ”¸ æ•…éšœéš”ç¦»ï¼šä¸€ä¸ªæœåŠ¡çš„é—®é¢˜ä¸å½±å“å…¶ä»–æœåŠ¡
```

### 10.2 å®¹é”™æœºåˆ¶é€‰æ‹©æŒ‡å—


**é€‰æ‹©å†³ç­–æ ‘**ï¼š
```
Q1: éœ€è¦æ£€æµ‹æœåŠ¡å­˜æ´»ï¼Ÿ
â†’ æ˜¯ï¼šé…ç½®å¿ƒè·³æ£€æµ‹

Q2: ç½‘ç»œä¸ç¨³å®šï¼Œå¶å°”å¤±è´¥ï¼Ÿ
â†’ æ˜¯ï¼šé…ç½®è¶…æ—¶é‡è¯•

Q3: æœåŠ¡é¢‘ç¹è¶…æ—¶æˆ–å¼‚å¸¸ï¼Ÿ
â†’ æ˜¯ï¼šé…ç½®ç†”æ–­å™¨

Q4: éœ€è¦åº”å¯¹æµé‡é«˜å³°ï¼Ÿ
â†’ æ˜¯ï¼šé…ç½®æœåŠ¡é™çº§

Q5: æ‹…å¿ƒæ•…éšœä¼ æ’­ï¼Ÿ
â†’ æ˜¯ï¼šé…ç½®æ•…éšœéš”ç¦»
```

### 10.3 å®è·µå»ºè®®


> ğŸ’¡ **æ–°æ‰‹å…¥é—¨å»ºè®®**ï¼š
> 
> â‘  **ä»ç®€å•å¼€å§‹**ï¼š
> - å…ˆé…ç½®å¿ƒè·³æ£€æµ‹
> - å†åŠ è¶…æ—¶é‡è¯•
> - æœ€ååŠ ç†”æ–­é™çº§
> 
> â‘¡ **é€æ­¥å®Œå–„**ï¼š
> - è§‚å¯Ÿç³»ç»Ÿè¡¨ç°
> - æ ¹æ®é—®é¢˜è°ƒæ•´
> - ä¸è¦ä¸€æ¬¡é…å¤ªå¤š
> 
> â‘¢ **æµ‹è¯•éªŒè¯**ï¼š
> - æ¯åŠ ä¸€ä¸ªæœºåˆ¶éƒ½è¦æµ‹è¯•
> - ç¡®ä¿é™çº§æ–¹æ¡ˆå¯ç”¨
> - æ¼”ç»ƒæ•…éšœæ¢å¤æµç¨‹

### 10.4 å¸¸è§é—®é¢˜ä¸è§£å†³


**Q1: ç†”æ–­å™¨ä¸€ç›´æ‰“å¼€æ€ä¹ˆåŠï¼Ÿ**
```
æ£€æŸ¥ï¼š
1. æ˜¯å¦çœŸçš„æœ‰é—®é¢˜ï¼ˆæŸ¥æ—¥å¿—ï¼‰
2. é˜ˆå€¼æ˜¯å¦è®¾ç½®å¤ªä¸¥æ ¼
3. æ¢å¤æ—¶é—´æ˜¯å¦å¤ªçŸ­

è§£å†³ï¼š
- ä¿®å¤æ ¹æœ¬é—®é¢˜
- è°ƒæ•´ç†”æ–­é˜ˆå€¼
- å»¶é•¿æ¢å¤æ—¶é—´
```

**Q2: é™çº§åæ€ä¹ˆæ¢å¤ï¼Ÿ**
```
æ­¥éª¤ï¼š
1. ç¡®è®¤é—®é¢˜å·²è§£å†³
2. å°æµé‡è¯•æ¢ï¼ˆ5%-10%ï¼‰
3. è§‚å¯Ÿæ— é—®é¢˜åé€æ­¥æ”¾é‡
4. è¾¾åˆ°100%å®Œå…¨æ¢å¤
```

**Q3: é‡è¯•å¯¼è‡´é‡å¤æäº¤ï¼Ÿ**
```
è§£å†³æ–¹æ¡ˆï¼š
1. åªå¯¹GETè¯·æ±‚é‡è¯•
2. ä½¿ç”¨å¹‚ç­‰æ€§è®¾è®¡
3. æ·»åŠ é˜²é‡å¤æäº¤æœºåˆ¶
```

### 10.5 å®¹é”™æœºåˆ¶é…ç½®æ¨¡æ¿


**æ¨èçš„åŸºç¡€é…ç½®**ï¼š

```yaml
# é€‚åˆå¤§å¤šæ•°åœºæ™¯çš„é…ç½®æ¨¡æ¿
spring:
  cloud:
    # Nacoså¿ƒè·³é…ç½®
    nacos:
      discovery:
        heart-beat-interval: 5000
        heart-beat-timeout: 15000
    
    # Sentinelç†”æ–­é…ç½®
    sentinel:
      transport:
        dashboard: localhost:8080
      # ç†”æ–­è§„åˆ™
      datasource:
        ds:
          nacos:
            data-id: sentinel-rules
            rule-type: flow

# Ribboné‡è¯•é…ç½®
ribbon:
  ConnectTimeout: 2000
  ReadTimeout: 5000
  OkToRetryOnAllOperations: false
  MaxAutoRetries: 1
  MaxAutoRetriesNextServer: 1
```

> âš ï¸ **é‡è¦æé†’**ï¼š
> - é…ç½®è¦æ ¹æ®å®é™…ä¸šåŠ¡è°ƒæ•´
> - å®šæœŸreviewå’Œä¼˜åŒ–é…ç½®
- åšå¥½ç›‘æ§å’Œå‘Šè­¦
> - å»ºç«‹æ•…éšœæ¼”ç»ƒæœºåˆ¶