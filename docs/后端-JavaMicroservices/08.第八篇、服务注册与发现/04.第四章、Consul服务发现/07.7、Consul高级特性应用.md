---
title: 7ã€Consulé«˜çº§ç‰¹æ€§åº”ç”¨
---
## ğŸ“š ç›®å½•

1. [KVå­˜å‚¨åº”ç”¨](#1-KVå­˜å‚¨åº”ç”¨)
2. [DNSæ¥å£ä½¿ç”¨](#2-DNSæ¥å£ä½¿ç”¨)
3. [HTTP APIè°ƒç”¨](#3-HTTP-APIè°ƒç”¨)
4. [åˆ†å¸ƒå¼é”å®ç°](#4-åˆ†å¸ƒå¼é”å®ç°)
5. [Sessionä¼šè¯ç®¡ç†](#5-Sessionä¼šè¯ç®¡ç†)
6. [Watchç›‘å¬æœºåˆ¶](#6-Watchç›‘å¬æœºåˆ¶)
7. [Consul ConnectæœåŠ¡ç½‘æ ¼](#7-Consul-ConnectæœåŠ¡ç½‘æ ¼)
8. [å¤–éƒ¨æœåŠ¡é›†æˆ](#8-å¤–éƒ¨æœåŠ¡é›†æˆ)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ—„ï¸ KVå­˜å‚¨åº”ç”¨


### 1.1 ä»€ä¹ˆæ˜¯KVå­˜å‚¨


**é€šä¿—ç†è§£**ï¼š
æƒ³è±¡ä½ æœ‰ä¸€ä¸ªè¶…å¤§çš„è®°äº‹æœ¬ï¼Œæ¯ä¸€é¡µéƒ½æœ‰ä¸€ä¸ªæ ‡é¢˜ï¼ˆKeyé”®ï¼‰ï¼Œæ ‡é¢˜ä¸‹é¢å†™ç€å…·ä½“å†…å®¹ï¼ˆValueå€¼ï¼‰ã€‚ä½ å¯ä»¥æ ¹æ®æ ‡é¢˜å¿«é€Ÿç¿»åˆ°å¯¹åº”çš„é‚£ä¸€é¡µï¼ŒæŸ¥çœ‹æˆ–ä¿®æ”¹å†…å®¹ã€‚Consulçš„KVå­˜å‚¨å°±æ˜¯è¿™æ ·ä¸€ä¸ªåˆ†å¸ƒå¼çš„"è®°äº‹æœ¬"ã€‚

```
ç®€å•ç±»æ¯”ï¼š
æ™®é€šè®°äº‹æœ¬ï¼ˆæœ¬åœ°ï¼‰        Consul KVå­˜å‚¨ï¼ˆåˆ†å¸ƒå¼ï¼‰
æ ‡é¢˜ï¼šæ•°æ®åº“å¯†ç            Key: /config/db/password
å†…å®¹ï¼š123456              Value: mySecretPass123
                          
ç‰¹ç‚¹ï¼šåªæœ‰ä½ èƒ½çœ‹          ç‰¹ç‚¹ï¼šæ•´ä¸ªé›†ç¾¤éƒ½èƒ½è®¿é—®
```

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- **Keyé”®**ï¼šç”¨æ¥æ ‡è¯†æ•°æ®çš„å”¯ä¸€è·¯å¾„ï¼Œç±»ä¼¼æ–‡ä»¶ç³»ç»Ÿçš„è·¯å¾„
- **Valueå€¼**ï¼šå­˜å‚¨çš„å®é™…å†…å®¹ï¼Œå¯ä»¥æ˜¯é…ç½®ã€å‚æ•°ã€çŠ¶æ€ç­‰
- **åˆ†å¸ƒå¼**ï¼šæ•°æ®è‡ªåŠ¨åœ¨å¤šä¸ªConsulèŠ‚ç‚¹ä¹‹é—´åŒæ­¥

### 1.2 KVå­˜å‚¨çš„å®é™…ç”¨é€”


**åœºæ™¯ä¸€ï¼šåŠ¨æ€é…ç½®ç®¡ç†**
```
ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜ï¼š
åº”ç”¨Açš„é…ç½® â†’ application.ymlæ–‡ä»¶
åº”ç”¨Bçš„é…ç½® â†’ application.ymlæ–‡ä»¶
ä¿®æ”¹é…ç½® â†’ éœ€è¦é‡å¯æ‰€æœ‰åº”ç”¨ âŒ

ä½¿ç”¨Consul KVçš„æ–¹å¼ï¼š
åº”ç”¨A â†’ ä»Consulè¯»å– /app-a/config
åº”ç”¨B â†’ ä»Consulè¯»å– /app-b/config  
ä¿®æ”¹é…ç½® â†’ åœ¨Consulæ›´æ–°ï¼Œåº”ç”¨è‡ªåŠ¨æ„ŸçŸ¥ âœ…
```

**åœºæ™¯äºŒï¼šåŠŸèƒ½å¼€å…³**
```
è¿è¥éœ€æ±‚ï¼šåŒåä¸€æ´»åŠ¨ï¼Œä¸´æ—¶å¼€å¯ç§’æ€åŠŸèƒ½

ä¼ ç»Ÿæ–¹å¼ï¼š
1. ä¿®æ”¹ä»£ç  if(ç§’æ€å¼€å…³)
2. é‡æ–°å‘å¸ƒ
3. æ´»åŠ¨ç»“æŸå†æ”¹å›å»

Consulæ–¹å¼ï¼š
1. ä»Consulè¯»å– /feature/seckill = true
2. æ´»åŠ¨æ—¶æ”¹æˆtrueï¼Œç»“æŸæ”¹æˆfalse
3. æ— éœ€é‡å¯ï¼Œå®æ—¶ç”Ÿæ•ˆ
```

### 1.3 Javaä»£ç å®ç°


**åŸºç¡€æ“ä½œç¤ºä¾‹**ï¼š
```java
@Service
public class ConsulConfigService {
    
    @Autowired
    private ConsulClient consulClient;
    
    // å­˜å‚¨é…ç½®
    public void saveConfig(String key, String value) {
        consulClient.setKVValue(key, value);
    }
    
    // è¯»å–é…ç½®
    public String getConfig(String key) {
        Response<GetValue> response = consulClient.getKVValue(key);
        if (response.getValue() != null) {
            return response.getValue().getDecodedValue();
        }
        return null;
    }
    
    // åˆ é™¤é…ç½®
    public void deleteConfig(String key) {
        consulClient.deleteKVValue(key);
    }
}
```

**å®é™…åº”ç”¨æ¡ˆä¾‹**ï¼š
```java
@Component
public class DynamicConfig {
    
    @Autowired
    private ConsulConfigService configService;
    
    // è·å–æ•°æ®åº“è¿æ¥æ•°é…ç½®
    public int getDbPoolSize() {
        String value = configService.getConfig("/db/pool-size");
        return value != null ? Integer.parseInt(value) : 10; // é»˜è®¤10
    }
    
    // åˆ¤æ–­åŠŸèƒ½æ˜¯å¦å¼€å¯
    public boolean isFeatureEnabled(String featureName) {
        String value = configService.getConfig("/feature/" + featureName);
        return "true".equals(value);
    }
}
```

### 1.4 KVå­˜å‚¨æœ€ä½³å®è·µ


**Keyå‘½åè§„èŒƒ**ï¼š
```
æ¨èçš„å±‚çº§ç»“æ„ï¼š
/åº”ç”¨å/ç¯å¢ƒ/é…ç½®é¡¹

ç¤ºä¾‹ï¼š
âœ… /order-service/prod/db-url          æ¸…æ™°æ˜äº†
âœ… /order-service/dev/cache-timeout     
âŒ orderservice_prod_db                 ä¸å¤Ÿç›´è§‚
âŒ config123                            æ— æ³•ç†è§£å«ä¹‰
```

**ä½¿ç”¨æŠ€å·§**ï¼š

| åœºæ™¯ | åšæ³• | åŸå›  |
|------|------|------|
| ğŸ”§ **æ•æ„Ÿä¿¡æ¯** | `åŠ å¯†åå­˜å‚¨` | å¯†ç ä¸èƒ½æ˜æ–‡ä¿å­˜ |
| ğŸ”„ **é¢‘ç¹å˜åŒ–** | `è®¾ç½®ç›‘å¬å™¨` | è‡ªåŠ¨æ„ŸçŸ¥é…ç½®å˜åŒ– |
| ğŸ“¦ **æ‰¹é‡é…ç½®** | `ç”¨JSONæ ¼å¼` | ä¸€æ¬¡å­˜å‚¨å¤šä¸ªå€¼ |
| ğŸ¯ **é»˜è®¤å€¼** | `ä»£ç é‡Œè®¾ç½®` | KVä¸å­˜åœ¨æ—¶æœ‰ä¿åº• |

---

## 2. ğŸŒ DNSæ¥å£ä½¿ç”¨


### 2.1 DNSæ¥å£æ˜¯ä»€ä¹ˆ


**é€šä¿—è§£é‡Š**ï¼š
ä½ åœ¨æµè§ˆå™¨è¾“å…¥ `www.baidu.com`ï¼Œç”µè„‘ä¼šå…ˆé—®DNSæœåŠ¡å™¨"è¿™ä¸ªç½‘å€å¯¹åº”çš„IPæ˜¯å¤šå°‘"ï¼Œç„¶åæ‰èƒ½è®¿é—®ã€‚Consulçš„DNSæ¥å£å°±æ˜¯è®©ä½ å¯ä»¥ç”¨æœåŠ¡åï¼ˆæ¯”å¦‚`order-service`ï¼‰æ¥è®¿é—®æœåŠ¡ï¼Œè€Œä¸ç”¨è®°IPåœ°å€ã€‚

```
ä¼ ç»Ÿæ–¹å¼ï¼š
ä½ çš„åº”ç”¨ â†’ é…ç½®æ–‡ä»¶å†™æ­»IP: 192.168.1.100:8080
é—®é¢˜ï¼šIPå˜äº†æ€ä¹ˆåŠï¼Ÿæ¯ä¸ªåº”ç”¨éƒ½è¦æ”¹é…ç½®ï¼

Consul DNSæ–¹å¼ï¼š
ä½ çš„åº”ç”¨ â†’ è®¿é—® order-service.service.consul
Consul â†’ è‡ªåŠ¨è¿”å›å¥åº·çš„æœåŠ¡å®ä¾‹IP
å¥½å¤„ï¼šIPå˜äº†ä¸ç”¨ç®¡ï¼ŒConsulè‡ªåŠ¨å¤„ç†
```

### 2.2 DNSæŸ¥è¯¢æ ¼å¼


**æœåŠ¡æŸ¥è¯¢æ ¼å¼**ï¼š
```
æ ‡å‡†æ ¼å¼ï¼š<æœåŠ¡å>.service.<æ•°æ®ä¸­å¿ƒ>.consul

ç¤ºä¾‹ï¼š
order-service.service.dc1.consul
         â†“         â†“      â†“
      æœåŠ¡å    å›ºå®šè¯  æ•°æ®ä¸­å¿ƒå

ç®€åŒ–æ ¼å¼ï¼ˆé»˜è®¤æ•°æ®ä¸­å¿ƒï¼‰ï¼š
order-service.service.consul
```

**å®é™…ä½¿ç”¨ç¤ºä¾‹**ï¼š
```bash
# 1. ç›´æ¥ç”¨å‘½ä»¤è¡ŒæŸ¥è¯¢
$ dig @127.0.0.1 -p 8600 order-service.service.consul

# è¿”å›ç»“æœï¼š
;; ANSWER SECTION:
order-service.service.consul. 0  IN  A  192.168.1.10
order-service.service.consul. 0  IN  A  192.168.1.11

# 2. åœ¨Javaä¸­ä½¿ç”¨ï¼ˆé€šè¿‡RestTemplateï¼‰
String url = "http://order-service.service.consul/api/orders";
// ç³»ç»Ÿä¼šè‡ªåŠ¨è§£æåŸŸåæ‰¾åˆ°å®é™…IP
```

### 2.3 é…ç½®DNSè§£æ


**æ–¹æ³•ä¸€ï¼šä¿®æ”¹ç³»ç»ŸDNSï¼ˆLinuxï¼‰**
```bash
# ç¼–è¾‘ /etc/resolv.conf
nameserver 127.0.0.1  # Consul DNSç›‘å¬åœ°å€
nameserver 8.8.8.8    # å¤‡ç”¨DNS

# è¿™æ ·ç³»ç»Ÿä¼šä¼˜å…ˆé—®Consulï¼Œæ‰¾ä¸åˆ°å†é—®å…¬ç½‘DNS
```

**æ–¹æ³•äºŒï¼šSpring Cloudé…ç½®ï¼ˆæ¨èï¼‰**
```yaml
spring:
  cloud:
    consul:
      discovery:
        # ä½¿ç”¨DNSè¿›è¡ŒæœåŠ¡å‘ç°
        scheme: http
        hostname: order-service.service.consul
        # å®ä¾‹åŒ–æ—¶ä½¿ç”¨DNSåç§°
        prefer-ip-address: false
        instance-id: ${spring.application.name}:${random.value}
```

### 2.4 DNSæ¥å£çš„ä¼˜åŠ¿


```
é€‚ç”¨åœºæ™¯å¯¹æ¯”ï¼š

åœºæ™¯1ï¼šè€ç³»ç»Ÿæ”¹é€ 
- è€ç³»ç»Ÿä¸æ”¯æŒConsul SDK
- ä½†æ”¯æŒDNSè§£æ
â†’ ç”¨DNSæ¥å£ï¼Œé›¶ä»£ç ä¿®æ”¹ âœ…

åœºæ™¯2ï¼šéJavaåº”ç”¨
- Pythonã€Goã€Node.jsåº”ç”¨
- ä¸æƒ³å¼•å…¥Consulå®¢æˆ·ç«¯åº“
â†’ ç”¨DNSæ¥å£ï¼Œè¯­è¨€æ— å…³ âœ…

åœºæ™¯3ï¼šå®¹å™¨ç¯å¢ƒ
- Dockerã€K8sç¯å¢ƒ
- å®¹å™¨é—´é€šä¿¡éœ€è¦æœåŠ¡å‘ç°
â†’ ç”¨DNSæ¥å£ï¼Œé…åˆDocker DNS âœ…
```

---

## 3. ğŸ”Œ HTTP APIè°ƒç”¨


### 3.1 ä¸ºä»€ä¹ˆéœ€è¦HTTP API


**åœºæ™¯ç†è§£**ï¼š
å‡è®¾ä½ æ˜¯è¿ç»´äººå‘˜ï¼Œéœ€è¦æŸ¥çœ‹æ‰€æœ‰æœåŠ¡çš„å¥åº·çŠ¶æ€ã€‚ç”¨Consul UIç½‘é¡µæ“ä½œå¾ˆéº»çƒ¦ï¼Œå¦‚æœæœ‰100ä¸ªæœåŠ¡è¦ä¸€ä¸ªä¸ªç‚¹å¼€çœ‹ã€‚è¿™æ—¶å€™HTTP APIå°±æ´¾ä¸Šç”¨åœºäº†ï¼Œå†™ä¸ªè„šæœ¬ä¸€æ¬¡æ€§è·å–æ‰€æœ‰ä¿¡æ¯ã€‚

```
ä¸‰ç§è®¿é—®Consulçš„æ–¹å¼ï¼š

æ–¹å¼1ï¼šConsul UIç•Œé¢
ç”¨é€”ï¼šäººå·¥æŸ¥çœ‹ã€ä¸´æ—¶æ“ä½œ
ç¼ºç‚¹ï¼šä¸é€‚åˆè‡ªåŠ¨åŒ–

æ–¹å¼2ï¼šConsul SDKï¼ˆJavaå®¢æˆ·ç«¯ï¼‰
ç”¨é€”ï¼šåº”ç”¨ç¨‹åºå†…éƒ¨ä½¿ç”¨
ç¼ºç‚¹ï¼šéœ€è¦å¼•å…¥ä¾èµ–

æ–¹å¼3ï¼šHTTP APIï¼ˆæ¨èï¼‰
ç”¨é€”ï¼šè„šæœ¬ã€ç›‘æ§ã€ç¬¬ä¸‰æ–¹é›†æˆ
ä¼˜ç‚¹ï¼šè¯­è¨€æ— å…³ã€çµæ´»å¼ºå¤§
```

### 3.2 å¸¸ç”¨APIæ¥å£


**æœåŠ¡æ³¨å†Œæ¥å£**ï¼š
```bash
# æ³¨å†Œä¸€ä¸ªæœåŠ¡
curl -X PUT http://localhost:8500/v1/agent/service/register \
  -d '{
    "ID": "order-service-01",
    "Name": "order-service",
    "Address": "192.168.1.10",
    "Port": 8080,
    "Check": {
      "HTTP": "http://192.168.1.10:8080/health",
      "Interval": "10s"
    }
  }'
```

**æœåŠ¡æŸ¥è¯¢æ¥å£**ï¼š
```bash
# æŸ¥è¯¢æ‰€æœ‰å¥åº·çš„order-serviceå®ä¾‹
curl http://localhost:8500/v1/health/service/order-service?passing

# è¿”å›JSONï¼ˆç®€åŒ–ç‰ˆï¼‰ï¼š
[
  {
    "Service": {
      "ID": "order-service-01",
      "Address": "192.168.1.10",
      "Port": 8080
    }
  }
]
```

**KVå­˜å‚¨æ¥å£**ï¼š
```bash
# å­˜å‚¨é…ç½®
curl -X PUT http://localhost:8500/v1/kv/config/db-url \
  -d 'jdbc:mysql://localhost:3306/order'

# è¯»å–é…ç½®
curl http://localhost:8500/v1/kv/config/db-url

# åˆ é™¤é…ç½®
curl -X DELETE http://localhost:8500/v1/kv/config/db-url
```

### 3.3 Javaä»£ç è°ƒç”¨API


**ä½¿ç”¨RestTemplateç¤ºä¾‹**ï¼š
```java
@Service
public class ConsulApiService {
    
    @Autowired
    private RestTemplate restTemplate;
    
    private static final String CONSUL_URL = "http://localhost:8500";
    
    // è·å–æœåŠ¡å®ä¾‹åˆ—è¡¨
    public List<ServiceInstance> getServiceInstances(String serviceName) {
        String url = CONSUL_URL + "/v1/health/service/" + serviceName + "?passing";
        
        // è°ƒç”¨API
        ServiceInfo[] services = restTemplate.getForObject(url, ServiceInfo[].class);
        
        // è½¬æ¢ä¸ºåº”ç”¨éœ€è¦çš„æ ¼å¼
        return Arrays.stream(services)
            .map(s -> new ServiceInstance(
                s.getService().getAddress(),
                s.getService().getPort()
            ))
            .collect(Collectors.toList());
    }
}
```

**å®é™…åº”ç”¨ï¼šè‡ªå®šä¹‰è´Ÿè½½å‡è¡¡**
```java
@Component
public class CustomLoadBalancer {
    
    @Autowired
    private ConsulApiService consulApi;
    
    private AtomicInteger counter = new AtomicInteger(0);
    
    // è½®è¯¢é€‰æ‹©æœåŠ¡å®ä¾‹
    public String chooseServer(String serviceName) {
        List<ServiceInstance> instances = consulApi.getServiceInstances(serviceName);
        
        if (instances.isEmpty()) {
            throw new RuntimeException("æ²¡æœ‰å¯ç”¨çš„æœåŠ¡å®ä¾‹");
        }
        
        // ç®€å•è½®è¯¢ç®—æ³•
        int index = counter.getAndIncrement() % instances.size();
        ServiceInstance instance = instances.get(index);
        
        return "http://" + instance.getAddress() + ":" + instance.getPort();
    }
}
```

### 3.4 APIä½¿ç”¨åœºæ™¯


| åœºæ™¯ | ä½¿ç”¨çš„API | è¯´æ˜ |
|------|-----------|------|
| ğŸ“Š **ç›‘æ§å¤§å±** | `/v1/health/state/critical` | è·å–æ‰€æœ‰å¼‚å¸¸æœåŠ¡ |
| ğŸ”§ **è¿ç»´è„šæœ¬** | `/v1/agent/service/register` | æ‰¹é‡æ³¨å†ŒæœåŠ¡ |
| ğŸ¯ **ç°åº¦å‘å¸ƒ** | `/v1/catalog/service/{name}` | æŸ¥è¯¢ç‰¹å®šç‰ˆæœ¬å®ä¾‹ |
| ğŸ”„ **é…ç½®åŒæ­¥** | `/v1/kv/?recurse` | æ‰¹é‡å¯¼å‡ºé…ç½® |

---

## 4. ğŸ”’ åˆ†å¸ƒå¼é”å®ç°


### 4.1 ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼é”


**ç”Ÿæ´»åœºæ™¯ç±»æ¯”**ï¼š
```
å•æœºç¯å¢ƒï¼ˆä¸€ä¸ªå•æ‰€ï¼‰ï¼š
- ä½ è¿›å»é”é—¨ï¼Œåˆ«äººè¿›ä¸æ¥
- Javaçš„synchronizedå°±å¤Ÿäº†

åˆ†å¸ƒå¼ç¯å¢ƒï¼ˆå¤šä¸ªå•æ‰€ï¼‰ï¼š
- æœåŠ¡Aåœ¨åŒ—äº¬æœºæˆ¿
- æœåŠ¡Båœ¨ä¸Šæµ·æœºæˆ¿  
- éƒ½æƒ³ä¿®æ”¹åŒä¸€ä¸ªè®¢å•
â†’ éœ€è¦ä¸€ä¸ª"æ€»ç®¡"æ¥åè°ƒè°å…ˆè°å
â†’ Consulå°±æ˜¯è¿™ä¸ªæ€»ç®¡
```

**ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”**ï¼š
```
åœºæ™¯ï¼šç§’æ€å•†å“ï¼Œåº“å­˜åªæœ‰1ä»¶

æ²¡æœ‰åˆ†å¸ƒå¼é”ï¼š
æ—¶åˆ»1: æœåŠ¡AæŸ¥è¯¢åº“å­˜=1 âœ“
æ—¶åˆ»2: æœåŠ¡BæŸ¥è¯¢åº“å­˜=1 âœ“  
æ—¶åˆ»3: æœåŠ¡Aæ‰£å‡åº“å­˜=0
æ—¶åˆ»4: æœåŠ¡Bæ‰£å‡åº“å­˜=-1 âŒ è¶…å–äº†ï¼

æœ‰åˆ†å¸ƒå¼é”ï¼š
æ—¶åˆ»1: æœåŠ¡Aè·å–é” â†’ æŸ¥è¯¢åº“å­˜=1 â†’ æ‰£å‡=0 â†’ é‡Šæ”¾é”
æ—¶åˆ»2: æœåŠ¡Bè·å–é” â†’ æŸ¥è¯¢åº“å­˜=0 â†’ ä¸èƒ½è´­ä¹° âœ“
```

### 4.2 Consulåˆ†å¸ƒå¼é”åŸç†


**å·¥ä½œæµç¨‹**ï¼š
```
æ­¥éª¤1: åˆ›å»ºSessionä¼šè¯
åº”ç”¨ â†’ Consul: "ç»™æˆ‘åˆ›å»ºä¸€ä¸ªä¼šè¯ï¼Œ15ç§’è¿‡æœŸ"
Consul â†’ åº”ç”¨: "å¥½çš„ï¼Œä¼šè¯IDæ˜¯abc123"

æ­¥éª¤2: å°è¯•è·å–é”
åº”ç”¨ â†’ Consul: "ç”¨abc123é”å®š/lock/order-123"
Consul â†’ åº”ç”¨: "æˆåŠŸï¼Œä½ è·å¾—äº†é”"

æ­¥éª¤3: æ‰§è¡Œä¸šåŠ¡é€»è¾‘
åº”ç”¨æ‰§è¡Œï¼šæŸ¥åº“å­˜ã€æ‰£å‡ã€ç”Ÿæˆè®¢å•...

æ­¥éª¤4: é‡Šæ”¾é”
åº”ç”¨ â†’ Consul: "é‡Šæ”¾/lock/order-123"
Consul: åˆ é™¤é”ï¼Œå…¶ä»–åº”ç”¨å¯ä»¥è·å–äº†
```

**å…³é”®æœºåˆ¶**ï¼š
- **Sessionä¼šè¯**ï¼šé”çš„æŒæœ‰è€…æ ‡è¯†ï¼Œè‡ªå¸¦è¿‡æœŸæ—¶é—´
- **Check-and-Set**ï¼šåŸå­æ“ä½œï¼Œç¡®ä¿åªæœ‰ä¸€ä¸ªèƒ½è·å–é”
- **è‡ªåŠ¨é‡Šæ”¾**ï¼šå¦‚æœåº”ç”¨æŒ‚äº†ï¼ŒSessionè¿‡æœŸä¼šè‡ªåŠ¨é‡Šæ”¾é”

### 4.3 Javaå®ç°ä»£ç 


**åŸºç¡€ç‰ˆæœ¬**ï¼š
```java
@Service
public class ConsulDistributedLock {
    
    @Autowired
    private ConsulClient consulClient;
    
    // è·å–é”
    public boolean acquireLock(String lockKey, String sessionId) {
        // å°è¯•è·å–é”ï¼Œå‚æ•°0è¡¨ç¤ºåˆ›å»ºæ–°çš„ï¼ŒsessionIdè¡¨ç¤ºæŒæœ‰è€…
        Response<Boolean> response = consulClient.setKVValue(
            lockKey,           // é”çš„è·¯å¾„
            "locked",          // é”çš„å€¼ï¼ˆå¯ä»¥å­˜æŒæœ‰è€…ä¿¡æ¯ï¼‰
            0,                 // flags
            PutParams.builder()
                .acquire(sessionId)  // å…³é”®ï¼šç”¨sessionè·å–é”
                .build()
        );
        
        return response.getValue(); // trueè¡¨ç¤ºè·å–æˆåŠŸ
    }
    
    // é‡Šæ”¾é”  
    public void releaseLock(String lockKey, String sessionId) {
        consulClient.setKVValue(
            lockKey,
            "",
            0,
            PutParams.builder()
                .release(sessionId)  // é‡Šæ”¾sessionæŒæœ‰çš„é”
                .build()
        );
    }
}
```

**å®Œæ•´ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
@Service
public class OrderService {
    
    @Autowired
    private ConsulDistributedLock distributedLock;
    
    @Autowired
    private ConsulClient consulClient;
    
    public void processOrder(String orderId) {
        String lockKey = "/lock/order/" + orderId;
        String sessionId = null;
        
        try {
            // 1. åˆ›å»ºä¼šè¯ï¼ˆ15ç§’TTLï¼‰
            NewSession session = new NewSession();
            session.setTtl("15s");
            sessionId = consulClient.sessionCreate(session, null).getValue();
            
            // 2. å°è¯•è·å–é”ï¼ˆæœ€å¤šç­‰å¾…5ç§’ï¼‰
            int retries = 0;
            while (!distributedLock.acquireLock(lockKey, sessionId)) {
                if (retries++ > 50) {
                    throw new RuntimeException("è·å–é”è¶…æ—¶");
                }
                Thread.sleep(100); // ç­‰å¾…100msé‡è¯•
            }
            
            // 3. æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼ˆå·²è·å¾—é”ï¼‰
            System.out.println("å¼€å§‹å¤„ç†è®¢å•: " + orderId);
            // ... æŸ¥åº“å­˜ã€æ‰£å‡ã€ç”Ÿæˆè®¢å•ç­‰æ“ä½œ
            
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            // 4. é‡Šæ”¾é”å’Œä¼šè¯
            if (sessionId != null) {
                distributedLock.releaseLock(lockKey, sessionId);
                consulClient.sessionDestroy(sessionId, null);
            }
        }
    }
}
```

### 4.4 ä½¿ç”¨æ³¨æ„äº‹é¡¹


> âš ï¸ **é”è¶…æ—¶é—®é¢˜**
> å¦‚æœä¸šåŠ¡å¤„ç†æ—¶é—´è¶…è¿‡Session TTLï¼Œé”ä¼šè‡ªåŠ¨é‡Šæ”¾ï¼Œå¯¼è‡´å…¶ä»–æœåŠ¡ä¹Ÿèƒ½è·å–é”ã€‚è§£å†³æ–¹æ³•ï¼š
> - åˆç†è®¾ç½®TTLæ—¶é—´ï¼ˆç•¥å¤§äºä¸šåŠ¡å¤„ç†æ—¶é—´ï¼‰
> - æˆ–è€…å®šæœŸç»­çº¦Sessionï¼ˆå‘é€å¿ƒè·³ï¼‰

> ğŸ’¡ **é”ç²’åº¦é€‰æ‹©**
> - ç²—ç²’åº¦ï¼š`/lock/order` - æ‰€æœ‰è®¢å•å…±ç”¨ä¸€æŠŠé”ï¼ˆæ€§èƒ½å·®ï¼‰
> - ç»†ç²’åº¦ï¼š`/lock/order/{orderId}` - æ¯ä¸ªè®¢å•ä¸€æŠŠé”ï¼ˆæ¨èï¼‰

---

## 5. ğŸ« Sessionä¼šè¯ç®¡ç†


### 5.1 Sessionä¼šè¯æ˜¯ä»€ä¹ˆ


**å½¢è±¡æ¯”å–»**ï¼š
```
Sessionå°±åƒæ˜¯åŠå›¾ä¹¦é¦†çš„å€Ÿä¹¦è¯ï¼š

1. åŠè¯ï¼ˆåˆ›å»ºSessionï¼‰
   ä½  â†’ å›¾ä¹¦é¦†: "æˆ‘è¦åŠè¯"
   å›¾ä¹¦é¦† â†’ ä½ : "ç»™ä½ è¯ä»¶ï¼Œæœ‰æ•ˆæœŸ1å¹´"

2. å€Ÿä¹¦ï¼ˆä½¿ç”¨Sessionï¼‰
   ä½ æ‹¿ç€è¯ä»¶ â†’ å€Ÿä¹¦ âœ“
   è¯ä»¶è¿‡æœŸäº† â†’ ä¸èƒ½å€Ÿä¹¦ âŒ

3. é€€è¯ï¼ˆé”€æ¯Sessionï¼‰
   ä½  â†’ å›¾ä¹¦é¦†: "æˆ‘ä¸ç”¨äº†ï¼Œé€€è¯"
   å›¾ä¹¦é¦†: å›æ”¶è¯ä»¶
```

**Sessionåœ¨Consulä¸­çš„ä½œç”¨**ï¼š
- **æ ‡è¯†å®¢æˆ·ç«¯**ï¼šæ¯ä¸ªåº”ç”¨å®ä¾‹åˆ›å»ºè‡ªå·±çš„Session
- **ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼šè‡ªåŠ¨ç»­çº¦æˆ–è¿‡æœŸé”€æ¯
- **é…åˆå…¶ä»–åŠŸèƒ½**ï¼šåˆ†å¸ƒå¼é”ã€Leaderé€‰ä¸¾éƒ½ä¾èµ–Session

### 5.2 Sessionçš„ç”Ÿå‘½å‘¨æœŸ


**åˆ›å»ºåˆ°é”€æ¯æµç¨‹**ï¼š
```
é˜¶æ®µ1: åˆ›å»ºSession
åº”ç”¨ â†’ POST /v1/session/create
     {
       "Name": "order-service-session",
       "TTL": "15s",              # è¶…æ—¶æ—¶é—´
       "Behavior": "delete"       # è¿‡æœŸåçš„è¡Œä¸º
     }
Consul â†’ è¿”å›SessionID: "abc-123-xyz"

é˜¶æ®µ2: ç»´æŒSessionï¼ˆå®šæœŸç»­çº¦ï¼‰
åº”ç”¨ â†’ PUT /v1/session/renew/abc-123-xyz
Consul â†’ é‡ç½®TTLè®¡æ—¶å™¨

é˜¶æ®µ3: é”€æ¯Session
æ–¹å¼1ï¼šä¸»åŠ¨é”€æ¯
  åº”ç”¨ â†’ PUT /v1/session/destroy/abc-123-xyz

æ–¹å¼2ï¼šè‡ªåŠ¨è¿‡æœŸ  
  15ç§’å†…æ²¡æœ‰ç»­çº¦ â†’ Consulè‡ªåŠ¨é”€æ¯
```

### 5.3 Javaä»£ç å®ç°


**åˆ›å»ºå’Œç®¡ç†Session**ï¼š
```java
@Component
public class ConsulSessionManager {
    
    @Autowired
    private ConsulClient consulClient;
    
    private String sessionId;
    private ScheduledExecutorService executor = Executors.newScheduledThreadPool(1);
    
    @PostConstruct
    public void init() {
        // åº”ç”¨å¯åŠ¨æ—¶åˆ›å»ºSession
        createSession();
        // å¯åŠ¨å®šæ—¶ç»­çº¦ä»»åŠ¡
        startRenewTask();
    }
    
    // åˆ›å»ºSession
    private void createSession() {
        NewSession session = new NewSession();
        session.setName("my-service-session");
        session.setTtl("15s");  // 15ç§’è¿‡æœŸ
        session.setBehavior(Session.Behavior.DELETE); // è¿‡æœŸæ—¶åˆ é™¤å…³è”çš„KV
        
        Response<String> response = consulClient.sessionCreate(session, null);
        this.sessionId = response.getValue();
        System.out.println("Sessionåˆ›å»ºæˆåŠŸ: " + sessionId);
    }
    
    // å®šæœŸç»­çº¦ï¼ˆæ¯10ç§’æ‰§è¡Œä¸€æ¬¡ï¼‰
    private void startRenewTask() {
        executor.scheduleAtFixedRate(() -> {
            try {
                consulClient.renewSession(sessionId, null);
                System.out.println("Sessionç»­çº¦æˆåŠŸ");
            } catch (Exception e) {
                System.err.println("Sessionç»­çº¦å¤±è´¥ï¼Œé‡æ–°åˆ›å»º");
                createSession();
            }
        }, 10, 10, TimeUnit.SECONDS);
    }
    
    @PreDestroy
    public void destroy() {
        // åº”ç”¨å…³é—­æ—¶é”€æ¯Session
        consulClient.sessionDestroy(sessionId, null);
        executor.shutdown();
    }
    
    public String getSessionId() {
        return sessionId;
    }
}
```

### 5.4 Sessioné…ç½®å‚æ•°


| å‚æ•° | è¯´æ˜ | å–å€¼ | ä½¿ç”¨å»ºè®® |
|------|------|------|----------|
| **TTL** | è¶…æ—¶æ—¶é—´ | `10s` ~ `24h` | æ ¹æ®ä¸šåŠ¡è®¾ç½®ï¼Œä¸€èˆ¬10-30ç§’ |
| **Behavior** | è¿‡æœŸè¡Œä¸º | `release`/`delete` | é”ç”¨deleteï¼ŒKVç”¨release |
| **Checks** | å¥åº·æ£€æŸ¥ | æ£€æŸ¥IDåˆ—è¡¨ | ç»‘å®šæœåŠ¡å¥åº·æ£€æŸ¥ |
| **LockDelay** | é”å»¶è¿Ÿ | æ—¶é—´å€¼ | é˜²æ­¢è„‘è£‚ï¼Œä¸€èˆ¬15s |

**å®é™…é…ç½®ç¤ºä¾‹**ï¼š
```java
NewSession session = new NewSession();
session.setName("order-lock-session");
session.setTtl("20s");                    // 20ç§’è¿‡æœŸ
session.setBehavior(Session.Behavior.DELETE);  // è¿‡æœŸåˆ é™¤é”
session.setChecks(Arrays.asList("service:order-service"));  // ç»‘å®šå¥åº·æ£€æŸ¥
session.setLockDelay("15s");              // é”å»¶è¿Ÿ15ç§’
```

---

## 6. ğŸ‘ï¸ Watchç›‘å¬æœºåˆ¶


### 6.1 ä»€ä¹ˆæ˜¯Watchç›‘å¬


**ç”Ÿæ´»åœºæ™¯**ï¼š
```
å¿«é€’åœºæ™¯ï¼š
ä¼ ç»Ÿæ–¹å¼ï¼šä½ æ¯éš”1å°æ—¶æ‰“ç”µè¯é—®"å¿«é€’åˆ°äº†å—ï¼Ÿ"ï¼ˆè½®è¯¢ï¼‰
Watchæ–¹å¼ï¼šä½ å‘Šè¯‰å¿«é€’å‘˜"åˆ°äº†ç»™æˆ‘æ‰“ç”µè¯"ï¼ˆäº‹ä»¶é€šçŸ¥ï¼‰

Consul Watchï¼š
è½®è¯¢æ–¹å¼ï¼šåº”ç”¨æ¯éš”5ç§’æŸ¥è¯¢é…ç½®æœ‰æ²¡æœ‰å˜åŒ–
Watchæ–¹å¼ï¼šé…ç½®å˜åŒ–æ—¶Consulä¸»åŠ¨é€šçŸ¥åº”ç”¨
```

**Watchèƒ½ç›‘å¬ä»€ä¹ˆ**ï¼š
- **KVå˜åŒ–**ï¼šé…ç½®é¡¹è¢«ä¿®æ”¹
- **æœåŠ¡å˜åŒ–**ï¼šæœåŠ¡å®ä¾‹ä¸Šä¸‹çº¿
- **å¥åº·æ£€æŸ¥**ï¼šæœåŠ¡å¥åº·çŠ¶æ€å˜åŒ–
- **äº‹ä»¶è§¦å‘**ï¼šè‡ªå®šä¹‰äº‹ä»¶å‘ç”Ÿ

### 6.2 Watchçš„å·¥ä½œåŸç†


**ç›‘å¬æµç¨‹å›¾**ï¼š
```
åº”ç”¨å¯åŠ¨
   â†“
æ³¨å†ŒWatchç›‘å¬å™¨
   â†“
æŒ‡å®šç›‘å¬ç›®æ ‡ï¼ˆå¦‚KV: /config/db-urlï¼‰
   â†“
Consulè®°å½•ï¼šåº”ç”¨Aå…³æ³¨è¿™ä¸ªé…ç½®
   â†“
[ç­‰å¾…å˜åŒ–...]
   â†“
ç®¡ç†å‘˜ä¿®æ”¹ /config/db-url
   â†“
Consulæ£€æµ‹åˆ°å˜åŒ–
   â†“
è§¦å‘Watchå›è°ƒ â†’ åº”ç”¨æ”¶åˆ°é€šçŸ¥
   â†“
åº”ç”¨æ‰§è¡Œï¼šé‡æ–°åŠ è½½é…ç½®
```

### 6.3 Javaå®ç°Watch


**ç›‘å¬KVé…ç½®å˜åŒ–**ï¼š
```java
@Component
public class ConfigWatcher {
    
    @Autowired
    private ConsulClient consulClient;
    
    private ExecutorService executor = Executors.newSingleThreadExecutor();
    private volatile boolean running = true;
    
    @PostConstruct
    public void startWatch() {
        executor.submit(() -> {
            long lastIndex = 0;
            
            while (running) {
                try {
                    // é•¿è½®è¯¢æ–¹å¼ç›‘å¬KVå˜åŒ–
                    QueryParams params = QueryParams.builder()
                        .setIndex(lastIndex)        // ä¸Šæ¬¡çš„ç´¢å¼•
                        .setWaitTime(30)            // æœ€å¤šç­‰30ç§’
                        .build();
                    
                    Response<GetValue> response = consulClient.getKVValue(
                        "/config/db-url", 
                        params
                    );
                    
                    // æœ‰æ–°å˜åŒ–
                    if (response.getConsulIndex() > lastIndex) {
                        lastIndex = response.getConsulIndex();
                        
                        String newValue = response.getValue().getDecodedValue();
                        System.out.println("é…ç½®å·²æ›´æ–°: " + newValue);
                        
                        // æ‰§è¡Œé…ç½®æ›´æ–°é€»è¾‘
                        updateDatabaseUrl(newValue);
                    }
                    
                } catch (Exception e) {
                    e.printStackTrace();
                    try {
                        Thread.sleep(5000); // å‡ºé”™ç­‰5ç§’é‡è¯•
                    } catch (InterruptedException ie) {
                        break;
                    }
                }
            }
        });
    }
    
    private void updateDatabaseUrl(String newUrl) {
        // è¿™é‡Œå¯ä»¥é‡æ–°åˆå§‹åŒ–æ•°æ®æºç­‰æ“ä½œ
        System.out.println("é‡æ–°é…ç½®æ•°æ®åº“è¿æ¥: " + newUrl);
    }
    
    @PreDestroy
    public void stopWatch() {
        running = false;
        executor.shutdown();
    }
}
```

**ç›‘å¬æœåŠ¡å®ä¾‹å˜åŒ–**ï¼š
```java
@Component
public class ServiceWatcher {
    
    @Autowired
    private ConsulClient consulClient;
    
    public void watchService(String serviceName) {
        new Thread(() -> {
            long lastIndex = 0;
            
            while (true) {
                QueryParams params = QueryParams.builder()
                    .setIndex(lastIndex)
                    .setWaitTime(30)
                    .build();
                
                Response<List<HealthService>> response = 
                    consulClient.getHealthServices(serviceName, true, params);
                
                if (response.getConsulIndex() > lastIndex) {
                    lastIndex = response.getConsulIndex();
                    
                    List<HealthService> services = response.getValue();
                    System.out.println(serviceName + " å®ä¾‹æ•°é‡: " + services.size());
                    
                    // å¯ä»¥åœ¨è¿™é‡Œæ›´æ–°æœ¬åœ°çš„æœåŠ¡å®ä¾‹ç¼“å­˜
                    updateServiceCache(serviceName, services);
                }
            }
        }).start();
    }
    
    private void updateServiceCache(String name, List<HealthService> services) {
        // æ›´æ–°æœ¬åœ°ç¼“å­˜ï¼Œä¾›è´Ÿè½½å‡è¡¡ä½¿ç”¨
    }
}
```

### 6.4 Watchä½¿ç”¨åœºæ™¯


| åœºæ™¯ | ç›‘å¬å¯¹è±¡ | è§¦å‘åŠ¨ä½œ |
|------|----------|----------|
| ğŸ”„ **é…ç½®çƒ­æ›´æ–°** | `KV: /config/*` | é‡è½½é…ç½®ï¼Œæ— éœ€é‡å¯ |
| ğŸ“Š **æœåŠ¡ç›‘æ§** | `Health: order-service` | å®ä¾‹å˜åŒ–å‘Šè­¦ |
| âš–ï¸ **è´Ÿè½½å‡è¡¡** | `Service: payment-service` | æ›´æ–°å¯ç”¨å®ä¾‹åˆ—è¡¨ |
| ğŸ¯ **ç°åº¦å‘å¸ƒ** | `KV: /feature/new-version` | åˆ‡æ¢æµé‡åˆ°æ–°ç‰ˆæœ¬ |

> ğŸ’¡ **æ€§èƒ½æç¤º**
> Watché‡‡ç”¨é•¿è½®è¯¢ï¼Œä¸ä¼šé¢‘ç¹è¯·æ±‚Consulï¼Œæ€§èƒ½å¼€é”€å¾ˆå°ã€‚ç›¸æ¯”å®šæ—¶è½®è¯¢ï¼Œæ—¢çœèµ„æºåˆå®æ—¶ã€‚

---

## 7. ğŸ•¸ï¸ Consul ConnectæœåŠ¡ç½‘æ ¼


### 7.1 ä»€ä¹ˆæ˜¯æœåŠ¡ç½‘æ ¼


**é€šä¿—ç†è§£**ï¼š
```
ä¼ ç»Ÿå¾®æœåŠ¡ï¼š
æœåŠ¡A â†’ ç›´æ¥è°ƒç”¨ â†’ æœåŠ¡B
é—®é¢˜ï¼š
- æœåŠ¡Bçš„IPè¦ç¡¬ç¼–ç å—ï¼Ÿ
- è°ƒç”¨å¤±è´¥æ€ä¹ˆé‡è¯•ï¼Ÿ
- æ€ä¹ˆä¿è¯è°ƒç”¨å®‰å…¨ï¼Ÿ
- å¦‚ä½•ç›‘æ§è°ƒç”¨æƒ…å†µï¼Ÿ

æœåŠ¡ç½‘æ ¼ï¼ˆService Meshï¼‰ï¼š
æœåŠ¡A â†’ ä»£ç†A â†’ ä»£ç†B â†’ æœåŠ¡B
         â†“              â†“
    å¤„ç†è·¯ç”±ã€å®‰å…¨ã€ç›‘æ§ç­‰

å¥½å¤„ï¼š
- åº”ç”¨æ— éœ€å…³å¿ƒé€šä¿¡ç»†èŠ‚
- ç»Ÿä¸€ç®¡ç†æµé‡ã€å®‰å…¨ã€å¯è§‚æµ‹
```

**Consul Connectçš„å®šä½**ï¼š
```
å¯¹æ¯”å…¶ä»–æœåŠ¡ç½‘æ ¼ï¼š

Istioï¼ˆæœ€å¼ºå¤§ï¼‰ï¼š
âœ… åŠŸèƒ½å…¨é¢
âŒ å¤æ‚ï¼Œå­¦ä¹ æˆæœ¬é«˜

Linkerdï¼ˆè½»é‡çº§ï¼‰ï¼š
âœ… ç®€å•æ˜“ç”¨  
âŒ åŠŸèƒ½ç›¸å¯¹å°‘

Consul Connectï¼ˆä¸­åº¸ä¹‹é“ï¼‰ï¼š
âœ… ä¸ConsulæœåŠ¡å‘ç°å¤©ç„¶é›†æˆ
âœ… å­¦ä¹ æˆæœ¬é€‚ä¸­
âœ… åŠŸèƒ½å¤Ÿç”¨
â†’ å·²ç»ç”¨Consulçš„å›¢é˜Ÿé¦–é€‰
```

### 7.2 Consul Connectæ ¸å¿ƒåŠŸèƒ½


**1. æœåŠ¡é—´åŠ å¯†é€šä¿¡**ï¼š
```
æ²¡æœ‰Connectï¼š
æœåŠ¡A â†’ HTTPæ˜æ–‡ â†’ æœåŠ¡B
         â†“
    ç½‘ç»œæŠ“åŒ…å¯è§ âŒ

æœ‰Connectï¼š  
æœåŠ¡A â†’ mTLSåŠ å¯† â†’ æœåŠ¡B
         â†“
    åŒå‘è®¤è¯+åŠ å¯† âœ“
```

**2. æµé‡æ§åˆ¶**ï¼š
```
åœºæ™¯ï¼šæœåŠ¡Aè°ƒç”¨æœåŠ¡B

é™æµè§„åˆ™ï¼š
- æ¯ç§’æœ€å¤š100æ¬¡è°ƒç”¨
- è¶…è¿‡é™åˆ¶è¿”å›429é”™è¯¯

è¶…æ—¶è§„åˆ™ï¼š
- è°ƒç”¨è¶…è¿‡3ç§’è‡ªåŠ¨è¶…æ—¶
- é¿å…é•¿æ—¶é—´ç­‰å¾…

é‡è¯•è§„åˆ™ï¼š
- å¤±è´¥è‡ªåŠ¨é‡è¯•3æ¬¡
- æŒ‡æ•°é€€é¿é—´éš”
```

**3. è®¿é—®æ§åˆ¶**ï¼š
```
Intentionsï¼ˆæ„å›¾è§„åˆ™ï¼‰ï¼š

è§„åˆ™1ï¼šå…è®¸è®¢å•æœåŠ¡è®¿é—®æ”¯ä»˜æœåŠ¡
source: order-service
destination: payment-service  
action: allow

è§„åˆ™2ï¼šæ‹’ç»åŒ¿åæœåŠ¡è®¿é—®ç”¨æˆ·æœåŠ¡
source: *
destination: user-service
action: deny
```

### 7.3 å¯ç”¨Connect


**é…ç½®Consulå¯ç”¨Connect**ï¼š
```json
// consul-config.json
{
  "connect": {
    "enabled": true
  },
  "ports": {
    "grpc": 8502  // Connectéœ€è¦gRPCç«¯å£
  }
}
```

**Javaåº”ç”¨æ¥å…¥Connect**ï¼š
```yaml
# application.yml
spring:
  cloud:
    consul:
      discovery:
        # å¯ç”¨Connect
        register-health-check: true
        health-check-interval: 10s
        
      # Connecté…ç½®
      config:
        enabled: true
        format: yaml
        data-key: data
        
# Connectä»£ç†é…ç½®      
consul:
  connect:
    enabled: true
    service-name: ${spring.application.name}
    # ä»£ç†ç›‘å¬ç«¯å£ï¼ˆåº”ç”¨é€šè¿‡è¿™ä¸ªç«¯å£è°ƒç”¨å…¶ä»–æœåŠ¡ï¼‰
    proxy-port: 20000
```

**å¯åŠ¨Connectä»£ç†**ï¼š
```bash
# ä¸ºorder-serviceå¯åŠ¨ä»£ç†
consul connect proxy \
  -service order-service \
  -service-addr 127.0.0.1:8080 \    # æœåŠ¡å®é™…åœ°å€
  -listen 127.0.0.1:20000 \         # ä»£ç†ç›‘å¬åœ°å€
  -register                          # è‡ªåŠ¨æ³¨å†Œåˆ°Consul

# ç°åœ¨å…¶ä»–æœåŠ¡é€šè¿‡ localhost:20000 è°ƒç”¨order-service
# æµé‡ä¼šç»è¿‡Connectä»£ç†ï¼Œè‡ªåŠ¨åŠ å¯†å’Œé‰´æƒ
```

### 7.4 è®¾ç½®è®¿é—®è§„åˆ™


**é€šè¿‡Consul CLIè®¾ç½®**ï¼š
```bash
# å…è®¸order-serviceè®¿é—®payment-service
consul intention create -allow order-service payment-service

# æ‹’ç»æ‰€æœ‰æœåŠ¡è®¿é—®admin-serviceï¼ˆåªå…è®¸ç™½åå•ï¼‰
consul intention create -deny '*' admin-service

# æŸ¥çœ‹æ‰€æœ‰è§„åˆ™
consul intention list

# åˆ é™¤è§„åˆ™
consul intention delete order-service payment-service
```

**é€šè¿‡HTTP APIè®¾ç½®**ï¼š
```bash
# åˆ›å»ºå…è®¸è§„åˆ™
curl -X PUT http://localhost:8500/v1/connect/intentions/exact \
  -d '{
    "SourceName": "order-service",
    "DestinationName": "payment-service",
    "Action": "allow",
    "Description": "è®¢å•æœåŠ¡éœ€è¦è°ƒç”¨æ”¯ä»˜æœåŠ¡"
  }'
```

### 7.5 Connectä½¿ç”¨åœºæ™¯


| åœºæ™¯ | ä¸ç”¨Connect | ç”¨Connect |
|------|-------------|-----------|
| ğŸ” **å®‰å…¨éœ€æ±‚é«˜** | éœ€è¦è‡ªå·±å®ç°HTTPS | è‡ªåŠ¨mTLSåŠ å¯† |
| ğŸ¯ **é›¶ä¿¡ä»»ç½‘ç»œ** | éš¾ä»¥å®ç° | é»˜è®¤æ‹’ç»+ç™½åå• |
| ğŸ“Š **è°ƒç”¨ç›‘æ§** | éœ€è¦åŸ‹ç‚¹ | è‡ªåŠ¨é‡‡é›†æŒ‡æ ‡ |
| ğŸ”„ **ç°åº¦å‘å¸ƒ** | ä¿®æ”¹ä»£ç  | é…ç½®æµé‡æ¯”ä¾‹ |

> âš ï¸ **æ€§èƒ½è€ƒè™‘**
> Connectä»£ç†ä¼šå¸¦æ¥é¢å¤–çš„ç½‘ç»œè·³è½¬ï¼Œå»¶è¿Ÿå¢åŠ çº¦1-5msã€‚å¦‚æœå¯¹æ€§èƒ½è¦æ±‚æé«˜ï¼ˆå¦‚é«˜é¢‘äº¤æ˜“ï¼‰ï¼Œéœ€è¦æƒè¡¡å®‰å…¨å’Œæ€§èƒ½ã€‚

---

## 8. ğŸ”— å¤–éƒ¨æœåŠ¡é›†æˆ


### 8.1 ä»€ä¹ˆæ˜¯å¤–éƒ¨æœåŠ¡


**åœºæ™¯ç†è§£**ï¼š
```
ä½ çš„å¾®æœåŠ¡æ¶æ„ï¼š
âœ… order-serviceï¼ˆè®¢å•ï¼‰â†’ æ³¨å†Œåˆ°Consul
âœ… payment-serviceï¼ˆæ”¯ä»˜ï¼‰â†’ æ³¨å†Œåˆ°Consul
âŒ MySQLæ•°æ®åº“ â†’ æ²¡æ³¨å†Œåˆ°Consul
âŒ Redisç¼“å­˜ â†’ æ²¡æ³¨å†Œåˆ°Consul
âŒ ç¬¬ä¸‰æ–¹çŸ­ä¿¡API â†’ æ²¡æ³¨å†Œåˆ°Consul

é—®é¢˜ï¼š
- æœåŠ¡éœ€è¦è°ƒç”¨MySQLï¼ŒIPå†™åœ¨é…ç½®é‡Œ
- MySQLæ¢äº†IPï¼Œæ‰€æœ‰æœåŠ¡è¦æ”¹é…ç½®
- æƒ³ç”¨Consulç»Ÿä¸€ç®¡ç†æ‰€æœ‰ä¾èµ–æ€ä¹ˆåŠï¼Ÿ

è§£å†³ï¼šæŠŠå¤–éƒ¨æœåŠ¡ä¹Ÿæ³¨å†Œåˆ°Consul
```

**å¤–éƒ¨æœåŠ¡æ³¨å†Œçš„å¥½å¤„**ï¼š
- **ç»Ÿä¸€æœåŠ¡å‘ç°**ï¼šæ‰€æœ‰æœåŠ¡ï¼ˆå†…éƒ¨+å¤–éƒ¨ï¼‰éƒ½ä»ConsulæŸ¥
- **å¥åº·æ£€æŸ¥**ï¼šè‡ªåŠ¨æ£€æµ‹å¤–éƒ¨æœåŠ¡å¯ç”¨æ€§
- **æ•…éšœåˆ‡æ¢**ï¼šä¸»MySQLæŒ‚äº†ï¼Œè‡ªåŠ¨åˆ‡åˆ°å¤‡åº“

### 8.2 æ³¨å†Œå¤–éƒ¨æœåŠ¡


**æ–¹å¼ä¸€ï¼šæ‰‹åŠ¨æ³¨å†ŒMySQL**
```bash
# æ³¨å†ŒMySQLä¸»åº“
curl -X PUT http://localhost:8500/v1/agent/service/register \
  -d '{
    "ID": "mysql-master",
    "Name": "mysql",
    "Tags": ["master", "primary"],
    "Address": "192.168.1.100",
    "Port": 3306,
    "Meta": {
      "database": "orderdb",
      "version": "8.0"
    },
    "Check": {
      "TCP": "192.168.1.100:3306",
      "Interval": "10s",
      "Timeout": "3s"
    }
  }'

# æ³¨å†ŒMySQLä»åº“
curl -X PUT http://localhost:8500/v1/agent/service/register \
  -d '{
    "ID": "mysql-slave",
    "Name": "mysql",
    "Tags": ["slave", "readonly"],
    "Address": "192.168.1.101",
    "Port": 3306,
    "Check": {
      "TCP": "192.168.1.101:3306",
      "Interval": "10s"
    }
  }'
```

**æ–¹å¼äºŒï¼šé…ç½®æ–‡ä»¶æ³¨å†Œ**
```json
// /etc/consul.d/external-mysql.json
{
  "service": {
    "id": "mysql-master",
    "name": "mysql",
    "tags": ["master"],
    "address": "192.168.1.100",
    "port": 3306,
    "check": {
      "tcp": "192.168.1.100:3306",
      "interval": "10s"
    }
  }
}
```

### 8.3 åº”ç”¨ä¸­ä½¿ç”¨å¤–éƒ¨æœåŠ¡


**Javaä»£ç ç¤ºä¾‹**ï¼š
```java
@Configuration
public class DataSourceConfig {
    
    @Autowired
    private ConsulClient consulClient;
    
    @Bean
    public DataSource dataSource() {
        // ä»Consulè·å–MySQLä¸»åº“åœ°å€
        List<HealthService> services = consulClient
            .getHealthServices("mysql", true, QueryParams.DEFAULT)
            .getValue();
        
        // è¿‡æ»¤å‡ºmasterèŠ‚ç‚¹
        HealthService masterDb = services.stream()
            .filter(s -> s.getService().getTags().contains("master"))
            .findFirst()
            .orElseThrow(() -> new RuntimeException("æ‰¾ä¸åˆ°MySQLä¸»åº“"));
        
        // åˆ›å»ºæ•°æ®æº
        HikariDataSource ds = new HikariDataSource();
        ds.setJdbcUrl("jdbc:mysql://" + 
            masterDb.getService().getAddress() + ":" +
            masterDb.getService().getPort() + "/orderdb");
        ds.setUsername("root");
        ds.setPassword("password");
        
        return ds;
    }
}
```

**å®ç°è¯»å†™åˆ†ç¦»**ï¼š
```java
@Service
public class DatabaseRouter {
    
    @Autowired
    private ConsulClient consulClient;
    
    // è·å–å†™åº“ï¼ˆmasterï¼‰
    public String getMasterDbUrl() {
        return getDbUrl("master");
    }
    
    // è·å–è¯»åº“ï¼ˆslaveï¼‰
    public String getSlaveDbUrl() {
        return getDbUrl("slave");
    }
    
    private String getDbUrl(String tag) {
        List<HealthService> services = consulClient
            .getHealthServices("mysql", true, QueryParams.DEFAULT)
            .getValue();
        
        HealthService db = services.stream()
            .filter(s -> s.getService().getTags().contains(tag))
            .findFirst()
            .orElseThrow(() -> new RuntimeException("æ‰¾ä¸åˆ°æ•°æ®åº“: " + tag));
        
        return "jdbc:mysql://" + 
            db.getService().getAddress() + ":" + 
            db.getService().getPort();
    }
}
```

### 8.4 å¸¸è§å¤–éƒ¨æœåŠ¡é›†æˆ


**Redisé›†æˆ**ï¼š
```bash
# æ³¨å†ŒRedisä¸»èŠ‚ç‚¹
curl -X PUT http://localhost:8500/v1/agent/service/register \
  -d '{
    "Name": "redis",
    "Tags": ["master"],
    "Address": "192.168.1.200",
    "Port": 6379,
    "Check": {
      "TCP": "192.168.1.200:6379",
      "Interval": "10s"
    }
  }'
```

**ç¬¬ä¸‰æ–¹APIé›†æˆ**ï¼š
```bash
# æ³¨å†ŒçŸ­ä¿¡æœåŠ¡API
curl -X PUT http://localhost:8500/v1/agent/service/register \
  -d '{
    "Name": "sms-api",
    "Address": "api.sms-provider.com",
    "Port": 443,
    "Meta": {
      "protocol": "https",
      "api-key": "your-api-key"
    },
    "Check": {
      "HTTP": "https://api.sms-provider.com/health",
      "Interval": "30s"
    }
  }'
```

### 8.5 å¤–éƒ¨æœåŠ¡å¥åº·æ£€æŸ¥


**é…ç½®ä¸åŒç±»å‹çš„æ£€æŸ¥**ï¼š

| æ£€æŸ¥ç±»å‹ | é€‚ç”¨åœºæ™¯ | é…ç½®ç¤ºä¾‹ |
|----------|----------|----------|
| **TCP** | æ•°æ®åº“ã€Redis | `"TCP": "192.168.1.100:3306"` |
| **HTTP** | REST API | `"HTTP": "http://api.example.com/health"` |
| **Script** | è‡ªå®šä¹‰æ£€æŸ¥ | `"Script": "/check.sh", "Interval": "10s"` |

**é«˜çº§å¥åº·æ£€æŸ¥ç¤ºä¾‹**ï¼š
```json
{
  "service": {
    "name": "mysql",
    "checks": [
      {
        "id": "mysql-tcp",
        "name": "MySQL TCPæ£€æŸ¥",
        "tcp": "192.168.1.100:3306",
        "interval": "10s",
        "timeout": "3s"
      },
      {
        "id": "mysql-query",
        "name": "MySQLæŸ¥è¯¢æ£€æŸ¥",
        "script": "/usr/local/bin/check-mysql.sh",
        "interval": "30s"
      }
    ]
  }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ”¸ KVå­˜å‚¨**ï¼š
- åˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒï¼Œæ”¯æŒåŠ¨æ€é…ç½®çƒ­æ›´æ–°
- é€‚åˆå­˜å‚¨é…ç½®å‚æ•°ã€åŠŸèƒ½å¼€å…³ã€ä¸šåŠ¡è§„åˆ™
- å»ºè®®ï¼šåˆç†å‘½åã€åŠ å¯†æ•æ„Ÿä¿¡æ¯ã€è®¾ç½®ç›‘å¬

**ğŸ”¸ DNSæ¥å£**ï¼š
- ç”¨æœåŠ¡åè®¿é—®ï¼Œæ— éœ€å…³å¿ƒIP
- è¯­è¨€æ— å…³ï¼Œé€‚åˆè€ç³»ç»Ÿæ”¹é€ 
- å»ºè®®ï¼šé…ç½®æœ¬åœ°DNSæˆ–Docker DNS

**ğŸ”¸ HTTP API**ï¼š
- å¼ºå¤§çµæ´»çš„è®¿é—®æ–¹å¼
- é€‚åˆè¿ç»´è„šæœ¬ã€ç›‘æ§ç³»ç»Ÿã€ç¬¬ä¸‰æ–¹é›†æˆ
- å»ºè®®ï¼šå°è£…å¸¸ç”¨æ“ä½œï¼Œå¤„ç†å¼‚å¸¸æƒ…å†µ

**ğŸ”¸ åˆ†å¸ƒå¼é”**ï¼š
- åŸºäºSessionå®ç°ï¼Œè‡ªåŠ¨è¿‡æœŸé˜²æ­»é”
- é€‚åˆç§’æ€ã€åº“å­˜æ‰£å‡ç­‰å¹¶å‘åœºæ™¯
- å»ºè®®ï¼šåˆç†è®¾ç½®TTLï¼Œç»†ç²’åº¦é”è®¾è®¡

**ğŸ”¸ Sessionç®¡ç†**ï¼š
- æ ‡è¯†å®¢æˆ·ç«¯èº«ä»½ï¼Œæ”¯æŒè‡ªåŠ¨ç»­çº¦
- æ˜¯åˆ†å¸ƒå¼é”å’ŒLeaderé€‰ä¸¾çš„åŸºç¡€
- å»ºè®®ï¼šå®šæœŸç»­çº¦ï¼Œå¼‚å¸¸æ—¶é‡å»º

**ğŸ”¸ Watchç›‘å¬**ï¼š
- å®æ—¶æ„ŸçŸ¥é…ç½®å’ŒæœåŠ¡å˜åŒ–
- æ¯”å®šæ—¶è½®è¯¢æ›´é«˜æ•ˆ
- å»ºè®®ï¼šå¤„ç†å¥½å¼‚å¸¸é‡è¿ï¼Œé¿å…é‡å¤é€šçŸ¥

**ğŸ”¸ Consul Connect**ï¼š
- æœåŠ¡ç½‘æ ¼ï¼Œæä¾›å®‰å…¨é€šä¿¡å’Œæµé‡æ§åˆ¶
- é€‚åˆå®‰å…¨è¦æ±‚é«˜çš„åœºæ™¯
- å»ºè®®ï¼šè¯„ä¼°æ€§èƒ½å½±å“ï¼Œåˆç†è®¾ç½®è§„åˆ™

**ğŸ”¸ å¤–éƒ¨æœåŠ¡é›†æˆ**ï¼š
- ç»Ÿä¸€ç®¡ç†å†…å¤–éƒ¨æœåŠ¡
- å®ç°æœåŠ¡å‘ç°å’Œå¥åº·æ£€æŸ¥
- å»ºè®®ï¼šé…ç½®åˆé€‚çš„å¥åº·æ£€æŸ¥ï¼Œåšå¥½æ•…éšœåˆ‡æ¢

### 9.2 ä½¿ç”¨å»ºè®®é€ŸæŸ¥


| åœºæ™¯ | æ¨èæ–¹æ¡ˆ | å…³é”®ç‚¹ |
|------|----------|--------|
| ğŸ”§ **é…ç½®ç®¡ç†** | KVå­˜å‚¨ + Watch | å±‚çº§å‘½åï¼Œå®æ—¶æ›´æ–° |
| ğŸŒ **è€ç³»ç»Ÿæ”¹é€ ** | DNSæ¥å£ | é›¶ä»£ç ä¿®æ”¹ |
| ğŸ“Š **è¿ç»´è‡ªåŠ¨åŒ–** | HTTP API | RESTfulè°ƒç”¨ |
| ğŸ”’ **å¹¶å‘æ§åˆ¶** | åˆ†å¸ƒå¼é” | Session TTLè®¾ç½® |
| ğŸ” **å®‰å…¨é€šä¿¡** | Consul Connect | mTLSåŠ å¯† |
| ğŸ—„ï¸ **å¤–éƒ¨ä¾èµ–** | å¤–éƒ¨æœåŠ¡æ³¨å†Œ | å¥åº·æ£€æŸ¥é…ç½® |

### 9.3 æœ€ä½³å®è·µæ¸…å•


> âœ… **DO - æ¨èåšæ³•**
> - KVå­˜å‚¨ï¼šæŒ‰ç¯å¢ƒåˆ†ç¦»ï¼Œ/prodã€/dev
> - åˆ†å¸ƒå¼é”ï¼šä½¿ç”¨ç»†ç²’åº¦é”ï¼Œé¿å…å¤§é”
> - Sessionï¼šè®¾ç½®åˆç†TTLï¼Œå®šæœŸç»­çº¦
> - Watchï¼šå¤„ç†å¼‚å¸¸ï¼Œé¿å…æ­»å¾ªç¯
> - Connectï¼šå…ˆæµ‹è¯•æ€§èƒ½ï¼Œå†ç”Ÿäº§ä½¿ç”¨

> âŒ **DON'T - é¿å…åšæ³•**  
> - KVå­˜å‚¨ï¼šä¸è¦å­˜å‚¨å¤§æ–‡ä»¶ï¼ˆ>512KBï¼‰
> - åˆ†å¸ƒå¼é”ï¼šä¸è¦é•¿æ—¶é—´æŒæœ‰é”
> - APIè°ƒç”¨ï¼šä¸è¦é¢‘ç¹è°ƒç”¨ï¼Œè€ƒè™‘ç¼“å­˜
> - Connectï¼šä¸è¦æ‰€æœ‰æœåŠ¡éƒ½å¯ç”¨ï¼ŒæŒ‰éœ€ä½¿ç”¨

### 9.4 å­¦ä¹ è·¯çº¿å»ºè®®


```
é˜¶æ®µ1ï¼šåŸºç¡€åº”ç”¨ï¼ˆ1-2å‘¨ï¼‰
â””â”€ KVå­˜å‚¨ã€DNSæ¥å£ã€HTTP APIåŸºæœ¬ä½¿ç”¨

é˜¶æ®µ2ï¼šè¿›é˜¶ç‰¹æ€§ï¼ˆ2-3å‘¨ï¼‰  
â””â”€ åˆ†å¸ƒå¼é”ã€Sessionç®¡ç†ã€Watchç›‘å¬

é˜¶æ®µ3ï¼šé«˜çº§åº”ç”¨ï¼ˆ3-4å‘¨ï¼‰
â””â”€ Consul Connectã€å¤–éƒ¨æœåŠ¡é›†æˆã€æ€§èƒ½ä¼˜åŒ–

é˜¶æ®µ4ï¼šç”Ÿäº§å®è·µï¼ˆæŒç»­ï¼‰
â””â”€ ç›‘æ§å‘Šè­¦ã€æ•…éšœæ¼”ç»ƒã€æ¶æ„ä¼˜åŒ–
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
KVå­˜é…ç½®ï¼ŒDNSæ‰¾æœåŠ¡
APIåšè¿ç»´ï¼Œé”æ§å¹¶å‘
Sessionç®¡ç”Ÿå‘½ï¼ŒWatchå¬å˜åŒ–
Connectä¿å®‰å…¨ï¼Œå¤–éƒ¨ä¹Ÿç»Ÿä¸€
```