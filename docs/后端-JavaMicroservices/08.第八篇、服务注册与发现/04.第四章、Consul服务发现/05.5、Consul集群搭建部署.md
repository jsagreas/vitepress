---
title: 5ã€Consulé›†ç¾¤æ­å»ºéƒ¨ç½²
---
## ğŸ“š ç›®å½•

1. [Consulé›†ç¾¤æ¶æ„æ¦‚è¿°](#1-Consulé›†ç¾¤æ¶æ„æ¦‚è¿°)
2. [å•èŠ‚ç‚¹éƒ¨ç½²é…ç½®](#2-å•èŠ‚ç‚¹éƒ¨ç½²é…ç½®)
3. [å¤šèŠ‚ç‚¹é›†ç¾¤æ­å»º](#3-å¤šèŠ‚ç‚¹é›†ç¾¤æ­å»º)
4. [Serveré›†ç¾¤é…ç½®](#4-Serveré›†ç¾¤é…ç½®)
5. [ClientèŠ‚ç‚¹é…ç½®](#5-ClientèŠ‚ç‚¹é…ç½®)
6. [ACLæƒé™æ§åˆ¶](#6-ACLæƒé™æ§åˆ¶)
7. [TLSåŠ å¯†é…ç½®](#7-TLSåŠ å¯†é…ç½®)
8. [ç›‘æ§å‘Šè­¦é…ç½®](#8-ç›‘æ§å‘Šè­¦é…ç½®)
9. [æ—¥å¿—ç®¡ç†é…ç½®](#9-æ—¥å¿—ç®¡ç†é…ç½®)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ—ï¸ Consulé›†ç¾¤æ¶æ„æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯Consulé›†ç¾¤


**é€šä¿—ç†è§£**ï¼šæƒ³è±¡ä¸€ä¸ªå…¬å¸çš„ç»„ç»‡æ¶æ„ï¼Œæœ‰å‡ ä¸ªæ ¸å¿ƒç®¡ç†å±‚ï¼ˆServerï¼‰ï¼Œè¿˜æœ‰å¾ˆå¤šæ‰§è¡Œå±‚å‘˜å·¥ï¼ˆClientï¼‰ã€‚Consulé›†ç¾¤ä¹Ÿæ˜¯ç±»ä¼¼çš„ç»“æ„ã€‚

```
ä¼ ç»Ÿå•ç‚¹æœåŠ¡æ³¨å†Œï¼š               Consulé›†ç¾¤æ¶æ„ï¼š
     
   æœåŠ¡A â†’ æ³¨å†Œä¸­å¿ƒ â† æœåŠ¡B          æœåŠ¡A â†’ Client â†’ Serveré›†ç¾¤ â† Client â† æœåŠ¡B
           â†“                                    â†“   â†“   â†“
      å•ç‚¹æ•…éšœé£é™©                          Leader  Follower  Follower
                                          (ä¸»ç®¡ç†)  (å¤‡ä»½)   (å¤‡ä»½)
                                          
                                    ä¼˜åŠ¿ï¼šé«˜å¯ç”¨ã€æ— å•ç‚¹æ•…éšœ
```

**æ ¸å¿ƒæ¦‚å¿µè§£é‡Š**ï¼š
- **ServerèŠ‚ç‚¹**ï¼šç›¸å½“äº"ç®¡ç†è€…"ï¼Œè´Ÿè´£å­˜å‚¨æ•°æ®ã€é€‰ä¸¾Leaderã€å¤„ç†é‡è¦å†³ç­–
- **ClientèŠ‚ç‚¹**ï¼šç›¸å½“äº"ä»£ç†äºº"ï¼Œå¸®æœåŠ¡æ³¨å†Œå’Œå‘ç°ï¼ŒæŠŠè¯·æ±‚è½¬å‘ç»™Server
- **é›†ç¾¤**ï¼šå¤šä¸ªServerç»„æˆçš„å›¢é˜Ÿï¼Œäº’ç›¸å¤‡ä»½ï¼Œä¸€ä¸ªæŒ‚äº†å…¶ä»–é¡¶ä¸Š

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦é›†ç¾¤éƒ¨ç½²


**å•èŠ‚ç‚¹çš„é—®é¢˜**ï¼š
```
å•ä¸ªConsulèŠ‚ç‚¹ï¼š
- âŒ å®•æœºåæœåŠ¡æ³¨å†Œä¸­å¿ƒä¸å¯ç”¨
- âŒ æ•°æ®ä¸¢å¤±æ— æ³•æ¢å¤
- âŒ æ€§èƒ½å—é™äºå•æœºé…ç½®
```

**é›†ç¾¤çš„ä¼˜åŠ¿**ï¼š
```
âœ… é«˜å¯ç”¨æ€§ï¼šä¸€ä¸ªèŠ‚ç‚¹æŒ‚äº†ï¼Œå…¶ä»–èŠ‚ç‚¹ç»§ç»­å·¥ä½œ
âœ… æ•°æ®å†—ä½™ï¼šå¤šä¸ªå‰¯æœ¬ä¿è¯æ•°æ®å®‰å…¨
âœ… è´Ÿè½½å‡è¡¡ï¼šè¯·æ±‚åˆ†æ•£åˆ°å¤šä¸ªèŠ‚ç‚¹
âœ… æ¨ªå‘æ‰©å±•ï¼šå¯ä»¥éšæ—¶å¢åŠ èŠ‚ç‚¹æå‡æ€§èƒ½
```

### 1.3 Consulé›†ç¾¤è§’è‰²è¯´æ˜


**è§’è‰²å¯¹æ¯”è¡¨æ ¼**ï¼š

| è§’è‰²ç±»å‹ | **ä½œç”¨** | **æ•°æ®å­˜å‚¨** | **æŠ•ç¥¨æƒ** | **æ¨èæ•°é‡** | **é€‚ç”¨åœºæ™¯** |
|---------|---------|-------------|-----------|------------|------------|
| ğŸ›ï¸ **Server** | `å­˜å‚¨æ•°æ®ã€é€‰ä¸¾Leader` | `æŒä¹…åŒ–å­˜å‚¨` | `æœ‰` | `3-5ä¸ª` | `æ ¸å¿ƒç®¡ç†èŠ‚ç‚¹` |
| ğŸ’¼ **Client** | `è½¬å‘è¯·æ±‚ã€æœ¬åœ°ç¼“å­˜` | `ä¸å­˜å‚¨` | `æ— ` | `æŒ‰éœ€éƒ¨ç½²` | `æœåŠ¡æ‰€åœ¨æœºå™¨` |
| ğŸ‘‘ **Leader** | `å¤„ç†å†™è¯·æ±‚ã€åŒæ­¥æ•°æ®` | `ä¸»å­˜å‚¨èŠ‚ç‚¹` | `æœ‰` | `1ä¸ª(è‡ªåŠ¨é€‰ä¸¾)` | `é›†ç¾¤ä¸»èŠ‚ç‚¹` |
| ğŸ“‹ **Follower** | `å¤‡ä»½æ•°æ®ã€å‚ä¸é€‰ä¸¾` | `åŒæ­¥å­˜å‚¨` | `æœ‰` | `2-4ä¸ª` | `å¤‡ä»½èŠ‚ç‚¹` |

**é€šä¿—ç±»æ¯”**ï¼š
- **Server** = å…¬å¸ç®¡ç†å±‚ï¼ŒæŒæ¡æ ¸å¿ƒæ•°æ®å’Œå†³ç­–æƒ
- **Client** = å„éƒ¨é—¨è”ç»œå‘˜ï¼Œå¸®å‘˜å·¥ä¸ç®¡ç†å±‚æ²Ÿé€š
- **Leader** = æ€»ç»ç†ï¼Œè´Ÿè´£æœ€ç»ˆå†³ç­–
- **Follower** = å‰¯æ€»ç»ç†ï¼Œéšæ—¶å‡†å¤‡æ¥æ›¿æ€»ç»ç†

### 1.4 é›†ç¾¤æ¶æ„å›¾ç¤º


```
                    Consulé›†ç¾¤æ¶æ„ç¤ºæ„å›¾

              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚      Serveré›†ç¾¤(ç®¡ç†å±‚)      â”‚
              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
              â”‚  â”‚  Server1 (Leader) ğŸ‘‘   â”‚ â”‚ â† é€‰ä¸¾äº§ç”Ÿçš„ä¸»èŠ‚ç‚¹
              â”‚  â”‚  - å¤„ç†å†™è¯·æ±‚          â”‚ â”‚
              â”‚  â”‚  - æ•°æ®åŒæ­¥            â”‚ â”‚
              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
              â”‚           â†“â†‘ æ•°æ®åŒæ­¥          â”‚
              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
              â”‚  â”‚ Server2  â”‚  â”‚ Server3  â”‚ â”‚ â† å¤‡ä»½èŠ‚ç‚¹
              â”‚  â”‚(Follower)â”‚  â”‚(Follower)â”‚ â”‚
              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†‘         â†‘
                    RPCé€šä¿¡    æ•°æ®æŸ¥è¯¢
                       â†“         â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚          ClientèŠ‚ç‚¹(ä»£ç†å±‚)           â”‚
         â”‚  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â” â”‚
         â”‚  â”‚Cli-1â”‚  â”‚Cli-2â”‚  â”‚Cli-3â”‚  â”‚Cli-4â”‚ â”‚
         â”‚  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜ â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†‘       â†‘       â†‘       â†‘
            æœ¬åœ°æ³¨å†Œ  æœåŠ¡å‘ç°  å¥åº·æ£€æŸ¥  é…ç½®è¯»å–
                â†“       â†“       â†“       â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
         â”‚           å¾®æœåŠ¡åº”ç”¨å±‚               â”‚
         â”‚  [è®¢å•æœåŠ¡] [ç”¨æˆ·æœåŠ¡] [æ”¯ä»˜æœåŠ¡]... â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ•°æ®æµè½¬è¿‡ç¨‹**ï¼š
```
æœåŠ¡æ³¨å†Œæµç¨‹ï¼š
å¾®æœåŠ¡ â†’ ClientèŠ‚ç‚¹ â†’ è½¬å‘ç»™Leader â†’ Leaderå­˜å‚¨ â†’ åŒæ­¥åˆ°Follower
       (æœ¬åœ°ä»£ç†)   (RPCé€šä¿¡)     (æŒä¹…åŒ–)    (æ•°æ®å¤‡ä»½)

æœåŠ¡å‘ç°æµç¨‹ï¼š
å¾®æœåŠ¡ â†’ ClientèŠ‚ç‚¹ â†’ è¯»å–æœ¬åœ°ç¼“å­˜/æŸ¥è¯¢Server â†’ è¿”å›æœåŠ¡åˆ—è¡¨
       (å‘èµ·æŸ¥è¯¢)   (ä¼˜å…ˆæœ¬åœ°)            (æœåŠ¡ä¿¡æ¯)
```

---

## 2. ğŸš€ å•èŠ‚ç‚¹éƒ¨ç½²é…ç½®


### 2.1 ç¯å¢ƒå‡†å¤‡


**ç³»ç»Ÿè¦æ±‚**ï¼š
```
æ“ä½œç³»ç»Ÿï¼šLinux (æ¨èCentOS 7+/Ubuntu 18.04+)
å†…å­˜ï¼šæœ€ä½2GBï¼Œæ¨è4GB+
CPUï¼šæœ€ä½1æ ¸ï¼Œæ¨è2æ ¸+
ç£ç›˜ï¼šæœ€ä½10GBï¼Œæ¨è20GB+
ç½‘ç»œï¼šç¨³å®šçš„å†…ç½‘ç¯å¢ƒ
```

**å®‰è£…å‰å‡†å¤‡**ï¼š
```bash
# 1. æ£€æŸ¥ç³»ç»Ÿç‰ˆæœ¬
cat /etc/os-release

# 2. æ£€æŸ¥å†…å­˜
free -h

# 3. æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h

# 4. å…³é—­é˜²ç«å¢™(æˆ–å¼€æ”¾ç«¯å£)
systemctl stop firewalld
systemctl disable firewalld
```

### 2.2 ä¸‹è½½å®‰è£…Consul


**æ–¹å¼ä¸€ï¼šå®˜ç½‘ä¸‹è½½ï¼ˆæ¨èï¼‰**ï¼š
```bash
# 1. ä¸‹è½½ConsuläºŒè¿›åˆ¶åŒ…
cd /opt
wget https://releases.hashicorp.com/consul/1.16.0/consul_1.16.0_linux_amd64.zip

# 2. è§£å‹
unzip consul_1.16.0_linux_amd64.zip

# 3. ç§»åŠ¨åˆ°ç³»ç»Ÿè·¯å¾„
mv consul /usr/local/bin/

# 4. éªŒè¯å®‰è£…
consul version
# è¾“å‡º: Consul v1.16.0
```

**æ–¹å¼äºŒï¼šyumå®‰è£…ï¼ˆç®€å•ä½†ç‰ˆæœ¬å¯èƒ½æ—§ï¼‰**ï¼š
```bash
# æ·»åŠ HashiCorpä»“åº“
yum install -y yum-utils
yum-config-manager --add-repo https://rpm.releases.hashicorp.com/RHEL/hashicorp.repo

# å®‰è£…Consul
yum install -y consul

# éªŒè¯
consul version
```

### 2.3 å•èŠ‚ç‚¹é…ç½®æ–‡ä»¶


**åˆ›å»ºé…ç½®ç›®å½•**ï¼š
```bash
# åˆ›å»ºConsulå·¥ä½œç›®å½•
mkdir -p /etc/consul.d
mkdir -p /opt/consul/data
```

**ç¼–å†™é…ç½®æ–‡ä»¶**ï¼ˆ`/etc/consul.d/consul.json`ï¼‰ï¼š
```json
{
  "datacenter": "dc1",
  "data_dir": "/opt/consul/data",
  "log_level": "INFO",
  "node_name": "consul-dev",
  "server": true,
  "bootstrap_expect": 1,
  "ui": true,
  "client_addr": "0.0.0.0",
  "bind_addr": "192.168.1.100",
  "ports": {
    "http": 8500,
    "dns": 8600
  }
}
```

**é…ç½®é¡¹è¯¦è§£**ï¼š

| é…ç½®é¡¹ | **å«ä¹‰** | **å€¼è¯´æ˜** |
|-------|---------|-----------|
| `datacenter` | `æ•°æ®ä¸­å¿ƒåç§°` | `é€»è¾‘åˆ†ç»„ï¼ŒåŒä¸€æ•°æ®ä¸­å¿ƒçš„èŠ‚ç‚¹äº’ç›¸é€šä¿¡` |
| `data_dir` | `æ•°æ®å­˜å‚¨ç›®å½•` | `å­˜æ”¾Consulçš„æŒä¹…åŒ–æ•°æ®` |
| `log_level` | `æ—¥å¿—çº§åˆ«` | `INFO/DEBUG/WARN/ERROR` |
| `node_name` | `èŠ‚ç‚¹åç§°` | `é›†ç¾¤ä¸­çš„å”¯ä¸€æ ‡è¯†` |
| `server` | `æ˜¯å¦ä¸ºServer` | `true=ServerèŠ‚ç‚¹ï¼Œfalse=ClientèŠ‚ç‚¹` |
| `bootstrap_expect` | `é¢„æœŸServeræ•°é‡` | `å•èŠ‚ç‚¹è®¾ä¸º1ï¼Œé›†ç¾¤è®¾ä¸ºServeræ€»æ•°` |
| `ui` | `å¯ç”¨Webç•Œé¢` | `trueåˆ™å¯è®¿é—®http://IP:8500` |
| `client_addr` | `å®¢æˆ·ç«¯ç›‘å¬åœ°å€` | `0.0.0.0è¡¨ç¤ºæ‰€æœ‰ç½‘å¡éƒ½å¯è®¿é—®` |
| `bind_addr` | `é›†ç¾¤é€šä¿¡åœ°å€` | `æœ¬æœºIPï¼Œç”¨äºèŠ‚ç‚¹é—´é€šä¿¡` |

### 2.4 å¯åŠ¨å•èŠ‚ç‚¹Consul


**å‰å°å¯åŠ¨ï¼ˆæµ‹è¯•ç”¨ï¼‰**ï¼š
```bash
# ç›´æ¥å¯åŠ¨ï¼ŒæŸ¥çœ‹æ—¥å¿—
consul agent -config-dir=/etc/consul.d/

# çœ‹åˆ°å¦‚ä¸‹ä¿¡æ¯è¯´æ˜å¯åŠ¨æˆåŠŸï¼š
# ==> Consul agent running!
# ==> Log data will now stream in as it occurs
```

**åå°å¯åŠ¨ï¼ˆç”Ÿäº§ç”¨ï¼‰**ï¼š
```bash
# ä½¿ç”¨nohupåå°è¿è¡Œ
nohup consul agent -config-dir=/etc/consul.d/ > /var/log/consul.log 2>&1 &

# æˆ–ä½¿ç”¨systemdç®¡ç†(æ¨è)
# åˆ›å»ºsystemdæœåŠ¡æ–‡ä»¶
cat > /etc/systemd/system/consul.service <<EOF
[Unit]
Description=Consul Service
After=network.target

[Service]
Type=simple
ExecStart=/usr/local/bin/consul agent -config-dir=/etc/consul.d/
ExecReload=/bin/kill -HUP \$MAINPID
KillMode=process
Restart=on-failure
RestartSec=5s

[Install]
WantedBy=multi-user.target
EOF

# å¯åŠ¨å¹¶è®¾ç½®å¼€æœºè‡ªå¯
systemctl daemon-reload
systemctl start consul
systemctl enable consul
systemctl status consul
```

### 2.5 éªŒè¯éƒ¨ç½²æˆåŠŸ


**æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€**ï¼š
```bash
# æŸ¥çœ‹é›†ç¾¤æˆå‘˜
consul members
# è¾“å‡ºç¤ºä¾‹ï¼š
# Node        Address            Status  Type    Build   Protocol  DC   Segment
# consul-dev  192.168.1.100:8301 alive   server  1.16.0  2         dc1  <all>

# æ£€æŸ¥Leader
consul operator raft list-peers
# è¾“å‡ºç¤ºä¾‹ï¼š
# Node        ID                                    Address            State   Voter  RaftProtocol
# consul-dev  b6c27a92-xxxx-xxxx-xxxx-xxxxxxxxxxxx  192.168.1.100:8300 leader  true   3
```

**è®¿é—®Webç•Œé¢**ï¼š
```
æµè§ˆå™¨æ‰“å¼€ï¼šhttp://192.168.1.100:8500

å¯ä»¥çœ‹åˆ°ï¼š
- Servicesï¼šæœåŠ¡åˆ—è¡¨
- Nodesï¼šèŠ‚ç‚¹ä¿¡æ¯
- Key/Valueï¼šé”®å€¼å­˜å‚¨
- Intentionsï¼šæœåŠ¡è®¿é—®æ§åˆ¶
```

---

## 3. ğŸŒ å¤šèŠ‚ç‚¹é›†ç¾¤æ­å»º


### 3.1 é›†ç¾¤è§„åˆ’è®¾è®¡


**ç”Ÿäº§ç¯å¢ƒæ¨èæ¶æ„**ï¼š
```
3ä¸ªServerèŠ‚ç‚¹ï¼ˆé«˜å¯ç”¨æœ€å°é…ç½®ï¼‰ï¼š
- Server1: 192.168.1.101 (è‡ªåŠ¨é€‰ä¸¾ä¸ºLeader)
- Server2: 192.168.1.102 (Followerå¤‡ä»½)
- Server3: 192.168.1.103 (Followerå¤‡ä»½)

Nä¸ªClientèŠ‚ç‚¹ï¼ˆæŒ‰éœ€éƒ¨ç½²ï¼‰ï¼š
- Client1: 192.168.1.201 (åº”ç”¨æœåŠ¡å™¨1)
- Client2: 192.168.1.202 (åº”ç”¨æœåŠ¡å™¨2)
- ...
```

**ä¸ºä»€ä¹ˆServerå»ºè®®3-5ä¸ª**ï¼Ÿ
```
å¥‡æ•°åŸåˆ™ï¼šé¿å…è„‘è£‚é—®é¢˜
- 1ä¸ªServerï¼šæ— é«˜å¯ç”¨ âŒ
- 2ä¸ªServerï¼šä¸€ä¸ªæŒ‚äº†æ— æ³•é€‰ä¸¾ âŒ
- 3ä¸ªServerï¼šä¸€ä¸ªæŒ‚äº†ï¼Œå‰©ä½™2ä¸ªå¯é€‰ä¸¾ âœ…
- 5ä¸ªServerï¼šä¸¤ä¸ªæŒ‚äº†ï¼Œå‰©ä½™3ä¸ªå¯é€‰ä¸¾ âœ…
- 7ä¸ªServerï¼šæ€§èƒ½ä¸‹é™ï¼ŒåŒæ­¥å¼€é”€å¤§ âš ï¸

ç»“è®ºï¼š3ä¸ªServeré€‚åˆä¸­å°é›†ç¾¤ï¼Œ5ä¸ªé€‚åˆå¤§é›†ç¾¤
```

### 3.2 Serveré›†ç¾¤æ­å»ºæ­¥éª¤


**æ­¥éª¤â‘ ï¼šåœ¨3å°æœºå™¨ä¸Šå®‰è£…Consul**ï¼ˆå‚è€ƒ2.2èŠ‚ï¼‰

**æ­¥éª¤â‘¡ï¼šé…ç½®Server1èŠ‚ç‚¹**ï¼ˆ192.168.1.101ï¼‰ï¼š
```json
{
  "datacenter": "dc1",
  "data_dir": "/opt/consul/data",
  "log_level": "INFO",
  "node_name": "consul-server-1",
  "server": true,
  "bootstrap_expect": 3,
  "ui": true,
  "client_addr": "0.0.0.0",
  "bind_addr": "192.168.1.101",
  "retry_join": ["192.168.1.102", "192.168.1.103"]
}
```

**æ­¥éª¤â‘¢ï¼šé…ç½®Server2èŠ‚ç‚¹**ï¼ˆ192.168.1.102ï¼‰ï¼š
```json
{
  "datacenter": "dc1",
  "data_dir": "/opt/consul/data",
  "log_level": "INFO",
  "node_name": "consul-server-2",
  "server": true,
  "bootstrap_expect": 3,
  "ui": true,
  "client_addr": "0.0.0.0",
  "bind_addr": "192.168.1.102",
  "retry_join": ["192.168.1.101", "192.168.1.103"]
}
```

**æ­¥éª¤â‘£ï¼šé…ç½®Server3èŠ‚ç‚¹**ï¼ˆ192.168.1.103ï¼‰ï¼š
```json
{
  "datacenter": "dc1",
  "data_dir": "/opt/consul/data",
  "log_level": "INFO",
  "node_name": "consul-server-3",
  "server": true,
  "bootstrap_expect": 3,
  "ui": true,
  "client_addr": "0.0.0.0",
  "bind_addr": "192.168.1.103",
  "retry_join": ["192.168.1.101", "192.168.1.102"]
}
```

**å…³é”®é…ç½®è§£é‡Š**ï¼š
- `bootstrap_expect: 3`ï¼šå‘Šè¯‰Consulé›†ç¾¤æœ‰3ä¸ªServerï¼Œå‡‘é½3ä¸ªæ‰å¼€å§‹é€‰ä¸¾
- `retry_join: [...]`ï¼šå¯åŠ¨æ—¶è‡ªåŠ¨è¿æ¥å…¶ä»–èŠ‚ç‚¹ï¼Œå¤±è´¥ä¼šé‡è¯•

### 3.3 å¯åŠ¨é›†ç¾¤å¹¶éªŒè¯


**å¯åŠ¨é¡ºåº**ï¼ˆå…ˆåé¡ºåºä¸é‡è¦ï¼‰ï¼š
```bash
# åœ¨Server1ä¸Š
systemctl start consul

# åœ¨Server2ä¸Š
systemctl start consul

# åœ¨Server3ä¸Š
systemctl start consul
```

**éªŒè¯é›†ç¾¤çŠ¶æ€**ï¼š
```bash
# åœ¨ä»»ä¸€Serverä¸Šæ‰§è¡Œ
consul members
# è¾“å‡ºç¤ºä¾‹ï¼š
# Node             Address            Status  Type    Build   Protocol  DC   Segment
# consul-server-1  192.168.1.101:8301 alive   server  1.16.0  2         dc1  <all>
# consul-server-2  192.168.1.102:8301 alive   server  1.16.0  2         dc1  <all>
# consul-server-3  192.168.1.103:8301 alive   server  1.16.0  2         dc1  <all>

# æŸ¥çœ‹Leaderä¿¡æ¯
consul operator raft list-peers
# è¾“å‡ºç¤ºä¾‹ï¼š
# Node             ID                                    Address            State     Voter
# consul-server-1  b6c27a92-xxxx-xxxx-xxxx-xxxxxxxxxxxx  192.168.1.101:8300 leader    true
# consul-server-2  c7d38b03-xxxx-xxxx-xxxx-xxxxxxxxxxxx  192.168.1.102:8300 follower  true
# consul-server-3  d8e49c14-xxxx-xxxx-xxxx-xxxxxxxxxxxx  192.168.1.103:8300 follower  true
```

**é›†ç¾¤é€šä¿¡æµç¨‹**ï¼š
```
å¯åŠ¨è¿‡ç¨‹ï¼š
Server1å¯åŠ¨ â†’ ç­‰å¾…å…¶ä»–èŠ‚ç‚¹
Server2å¯åŠ¨ â†’ é€šè¿‡retry_joinè¿æ¥Server1
Server3å¯åŠ¨ â†’ è¿æ¥Server1å’ŒServer2
è¾¾åˆ°3ä¸ªèŠ‚ç‚¹ â†’ è§¦å‘Leaderé€‰ä¸¾ â†’ Server1å½“é€‰Leader

æ•°æ®åŒæ­¥è¿‡ç¨‹ï¼š
æœåŠ¡æ³¨å†Œ â†’ Leaderæ¥æ”¶ â†’ å†™å…¥æœ¬åœ° â†’ åŒæ­¥åˆ°Follower1 â†’ åŒæ­¥åˆ°Follower2
                         â†“
                    è¿‡åŠç¡®è®¤(2/3) â†’ è¿”å›æˆåŠŸ
```

---

## 4. ğŸ›ï¸ Serveré›†ç¾¤é…ç½®


### 4.1 Serveré…ç½®æœ€ä½³å®è·µ


**å®Œæ•´é…ç½®ç¤ºä¾‹**ï¼ˆç”Ÿäº§çº§ï¼‰ï¼š
```json
{
  "datacenter": "dc1",
  "data_dir": "/opt/consul/data",
  "log_level": "INFO",
  "log_file": "/var/log/consul/",
  "log_rotate_duration": "24h",
  "log_rotate_max_files": 7,
  
  "node_name": "consul-server-1",
  "server": true,
  "bootstrap_expect": 3,
  
  "bind_addr": "192.168.1.101",
  "client_addr": "0.0.0.0",
  "advertise_addr": "192.168.1.101",
  
  "retry_join": ["192.168.1.102", "192.168.1.103"],
  "retry_interval": "30s",
  "retry_max": 0,
  
  "ui": true,
  "ui_config": {
    "enabled": true
  },
  
  "performance": {
    "raft_multiplier": 1
  },
  
  "autopilot": {
    "cleanup_dead_servers": true,
    "last_contact_threshold": "200ms",
    "max_trailing_logs": 250,
    "server_stabilization_time": "10s"
  }
}
```

**é…ç½®é¡¹æ·±åº¦è§£æ**ï¼š

| é…ç½®é¡¹ | **ä½œç”¨** | **ç”Ÿäº§å»ºè®®å€¼** | **è¯´æ˜** |
|-------|---------|--------------|---------|
| `log_file` | `æ—¥å¿—æ–‡ä»¶è·¯å¾„` | `/var/log/consul/` | `æ»šåŠ¨æ—¥å¿—ï¼Œä¾¿äºæ’æŸ¥é—®é¢˜` |
| `log_rotate_duration` | `æ—¥å¿—è½®è½¬å‘¨æœŸ` | `24h` | `æ¯å¤©ç”Ÿæˆæ–°æ—¥å¿—æ–‡ä»¶` |
| `advertise_addr` | `å¯¹å¤–é€šå‘Šåœ°å€` | `æœ¬æœºå…¬ç½‘IP` | `å¤šç½‘å¡ç¯å¢ƒå¿…é¡»æŒ‡å®š` |
| `retry_interval` | `é‡è¿é—´éš”` | `30s` | `èŠ‚ç‚¹å¤±è”åé‡è¯•è¿æ¥çš„é—´éš”` |
| `retry_max` | `æœ€å¤§é‡è¯•æ¬¡æ•°` | `0(æ— é™)` | `0è¡¨ç¤ºä¸€ç›´é‡è¯•ï¼Œé˜²æ­¢ç½‘ç»œæŠ–åŠ¨` |
| `raft_multiplier` | `Raftæ€§èƒ½å€æ•°` | `1(é»˜è®¤)` | `å€¼è¶Šå¤§å®¹å¿åº¦è¶Šé«˜ï¼Œä½†é€‰ä¸¾æ…¢` |
| `cleanup_dead_servers` | `è‡ªåŠ¨æ¸…ç†æ­»èŠ‚ç‚¹` | `true` | `7å¤©åè‡ªåŠ¨ç§»é™¤å¤±è”èŠ‚ç‚¹` |

### 4.2 Raftå…±è¯†ç®—æ³•é…ç½®


**ä»€ä¹ˆæ˜¯Raft**ï¼Ÿ
```
é€šä¿—è§£é‡Šï¼š
Raftæ˜¯Consulç”¨æ¥é€‰ä¸¾Leaderå’Œä¿è¯æ•°æ®ä¸€è‡´æ€§çš„ç®—æ³•

å°±åƒå…¬å¸é€‰æ€»ç»ç†ï¼š
1. å€™é€‰äººæ‹‰ç¥¨ (RequestVote)
2. è·å¾—å¤šæ•°ç¥¨å½“é€‰ (è¿‡åŠåŸåˆ™)
3. å½“é€‰åå‘å·æ–½ä»¤ (AppendEntries)
4. ä¸‹å±æ‰§è¡Œå¹¶åé¦ˆ (æ—¥å¿—å¤åˆ¶)
```

**Raftå…³é”®å‚æ•°è°ƒä¼˜**ï¼š
```json
{
  "performance": {
    "raft_multiplier": 1
  },
  "raft_protocol": 3,
  "raft_snapshot_threshold": 8192,
  "raft_snapshot_interval": "120s"
}
```

**å‚æ•°è¯´æ˜**ï¼š
- `raft_multiplier`ï¼šè¶…æ—¶å€æ•°ï¼Œ1=é»˜è®¤(200ms)ï¼Œ5=å®½æ¾(1s)
- `raft_protocol`ï¼šåè®®ç‰ˆæœ¬ï¼Œ3=æœ€æ–°ç‰ˆæœ¬
- `raft_snapshot_threshold`ï¼šæ—¥å¿—æ¡ç›®è¾¾åˆ°8192æ—¶åˆ›å»ºå¿«ç…§
- `raft_snapshot_interval`ï¼šæ¯2åˆ†é’Ÿæ£€æŸ¥æ˜¯å¦éœ€è¦å¿«ç…§

**åœºæ™¯è°ƒä¼˜å»ºè®®**ï¼š
```
ä½å»¶è¿Ÿç½‘ç»œï¼ˆåŒæœºæˆ¿ï¼‰ï¼š
raft_multiplier = 1  â† å¿«é€Ÿé€‰ä¸¾ï¼Œæ€§èƒ½æœ€ä¼˜

é«˜å»¶è¿Ÿç½‘ç»œï¼ˆè·¨æœºæˆ¿ï¼‰ï¼š
raft_multiplier = 3-5  â† å®¹å¿ç½‘ç»œæŠ–åŠ¨

å¤§è§„æ¨¡é›†ç¾¤ï¼ˆæ•°æ®é‡å¤§ï¼‰ï¼š
raft_snapshot_threshold = 16384  â† å‡å°‘å¿«ç…§é¢‘ç‡
```

### 4.3 Serveræ€§èƒ½è°ƒä¼˜


**èµ„æºé…ç½®å»ºè®®**ï¼š
```
å°è§„æ¨¡é›†ç¾¤ï¼ˆ<50æœåŠ¡ï¼‰ï¼š
CPU: 2æ ¸
å†…å­˜: 4GB
ç£ç›˜: SSD 50GB

ä¸­ç­‰è§„æ¨¡ï¼ˆ50-500æœåŠ¡ï¼‰ï¼š
CPU: 4æ ¸
å†…å­˜: 8GB
ç£ç›˜: SSD 100GB

å¤§è§„æ¨¡é›†ç¾¤ï¼ˆ>500æœåŠ¡ï¼‰ï¼š
CPU: 8æ ¸+
å†…å­˜: 16GB+
ç£ç›˜: SSD 200GB+
```

**JVMå‚æ•°ä¼˜åŒ–**ï¼ˆå¦‚æœä½¿ç”¨Javaå®¢æˆ·ç«¯ï¼‰ï¼š
```bash
# Consulæœ¬èº«æ˜¯Goå†™çš„ä¸éœ€è¦JVM
# ä½†Javaå¾®æœåŠ¡è¿æ¥Consulæ—¶å¯ä¼˜åŒ–ï¼š
-Xms2g -Xmx2g  # å †å†…å­˜
-XX:+UseG1GC   # ä½¿ç”¨G1åƒåœ¾å›æ”¶å™¨
```

---

## 5. ğŸ’¼ ClientèŠ‚ç‚¹é…ç½®


### 5.1 ClientèŠ‚ç‚¹ä½œç”¨


**ä¸ºä»€ä¹ˆéœ€è¦ClientèŠ‚ç‚¹**ï¼Ÿ
```
åœºæ™¯ï¼šä½ æœ‰100å°åº”ç”¨æœåŠ¡å™¨è¦è¿æ¥Consul

æ–¹æ¡ˆA - ç›´æ¥è¿Serverï¼š
åº”ç”¨æœåŠ¡å™¨1 â”€â”
åº”ç”¨æœåŠ¡å™¨2 â”€â”¤
  ...       â”œâ†’ Serveré›†ç¾¤(3ä¸ªèŠ‚ç‚¹) â† å‹åŠ›å·¨å¤§ï¼
åº”ç”¨æœåŠ¡å™¨99â”€â”¤
åº”ç”¨æœåŠ¡å™¨100â”˜

é—®é¢˜ï¼šServerå‹åŠ›å¤§ï¼Œç½‘ç»œå¼€é”€å¤§

æ–¹æ¡ˆB - é€šè¿‡Clientä»£ç†ï¼š
åº”ç”¨æœåŠ¡å™¨1 â†’ Client1 â”€â”
åº”ç”¨æœåŠ¡å™¨2 â†’ Client2 â”€â”¤
  ...                   â”œâ†’ Serveré›†ç¾¤ â† å‹åŠ›åˆ†æ•£
åº”ç”¨æœåŠ¡å™¨99 â†’ Client99â”€â”¤
åº”ç”¨æœåŠ¡å™¨100â†’ Client100â”˜

ä¼˜åŠ¿ï¼š
âœ… Serveråªå¤„ç†å°‘é‡Clientè¯·æ±‚
âœ… Clientæœ¬åœ°ç¼“å­˜ï¼Œå‡å°‘ç½‘ç»œè¯·æ±‚
âœ… åº”ç”¨åªéœ€è¿æ¥æœ¬åœ°Client(127.0.0.1)
```

### 5.2 Clienté…ç½®ç¤ºä¾‹


**åŸºç¡€é…ç½®**ï¼ˆ`/etc/consul.d/client.json`ï¼‰ï¼š
```json
{
  "datacenter": "dc1",
  "data_dir": "/opt/consul/data",
  "log_level": "INFO",
  "node_name": "consul-client-1",
  "server": false,
  "bind_addr": "192.168.1.201",
  "client_addr": "127.0.0.1",
  "retry_join": ["192.168.1.101", "192.168.1.102", "192.168.1.103"],
  "enable_local_script_checks": true
}
```

**é…ç½®å·®å¼‚å¯¹æ¯”**ï¼š

| é…ç½®é¡¹ | **Server** | **Client** | **åŸå› ** |
|-------|-----------|-----------|---------|
| `server` | `true` | `false` | `Clientä¸å‚ä¸é€‰ä¸¾` |
| `bootstrap_expect` | `3` | `ä¸éœ€è¦` | `Clientä¸å‚ä¸é›†ç¾¤é€‰ä¸¾` |
| `client_addr` | `0.0.0.0` | `127.0.0.1` | `Clientåªå…è®¸æœ¬åœ°è®¿é—®` |
| `ui` | `true` | `false` | `UIåªåœ¨Serverä¸Šå¼€å¯` |

### 5.3 Clientéƒ¨ç½²å®æˆ˜


**åœºæ™¯ï¼šåœ¨åº”ç”¨æœåŠ¡å™¨ä¸Šéƒ¨ç½²Client**
```bash
# 1. å®‰è£…Consul(åŒServer)
wget https://releases.hashicorp.com/consul/1.16.0/consul_1.16.0_linux_amd64.zip
unzip consul_1.16.0_linux_amd64.zip
mv consul /usr/local/bin/

# 2. åˆ›å»ºé…ç½®
mkdir -p /etc/consul.d
cat > /etc/consul.d/client.json <<EOF
{
  "datacenter": "dc1",
  "data_dir": "/opt/consul/data",
  "node_name": "app-server-1",
  "server": false,
  "bind_addr": "192.168.1.201",
  "client_addr": "127.0.0.1",
  "retry_join": ["192.168.1.101", "192.168.1.102", "192.168.1.103"]
}
EOF

# 3. å¯åŠ¨Client
consul agent -config-dir=/etc/consul.d/
```

**éªŒè¯Clientè¿æ¥**ï¼š
```bash
# åœ¨ClientèŠ‚ç‚¹æŸ¥çœ‹é›†ç¾¤
consul members
# è¾“å‡ºï¼š
# Node             Address            Status  Type    Build   Protocol  DC   Segment
# consul-server-1  192.168.1.101:8301 alive   server  1.16.0  2         dc1  <all>
# consul-server-2  192.168.1.102:8301 alive   server  1.16.0  2         dc1  <all>
# consul-server-3  192.168.1.103:8301 alive   server  1.16.0  2         dc1  <all>
# app-server-1     192.168.1.201:8301 alive   client  1.16.0  2         dc1  <default>
```

### 5.4 å¾®æœåŠ¡è¿æ¥Client


**Spring Bootåº”ç”¨é…ç½®**ï¼š
```yaml
spring:
  cloud:
    consul:
      host: 127.0.0.1    # è¿æ¥æœ¬åœ°Client
      port: 8500
      discovery:
        service-name: order-service
        health-check-interval: 10s
```

**è¿æ¥æµç¨‹**ï¼š
```
è®¢å•æœåŠ¡ â†’ æ³¨å†Œåˆ°æœ¬åœ°Client(127.0.0.1:8500)
           â†“
Clientè½¬å‘æ³¨å†Œè¯·æ±‚ â†’ Server Leader
           â†“
Leaderå­˜å‚¨æœåŠ¡ä¿¡æ¯ â†’ åŒæ­¥åˆ°Follower
           â†“
Clientå®šæœŸä»Serveræ‹‰å–æœ€æ–°æœåŠ¡åˆ—è¡¨ â†’ æœ¬åœ°ç¼“å­˜
           â†“
è®¢å•æœåŠ¡æŸ¥è¯¢ç”¨æˆ·æœåŠ¡ â†’ ç›´æ¥ä»Clientæœ¬åœ°ç¼“å­˜è·å– (ç§’çº§å“åº”)
```

---

## 6. ğŸ” ACLæƒé™æ§åˆ¶


### 6.1 ä»€ä¹ˆæ˜¯ACLæƒé™æ§åˆ¶


**é€šä¿—ç†è§£**ï¼š
```
æ²¡æœ‰ACLï¼š
ä»»ä½•äººéƒ½èƒ½è®¿é—®Consul â†’ åˆ é™¤æœåŠ¡ã€ä¿®æ”¹é…ç½® â†’ ç¾éš¾ï¼

æœ‰äº†ACLï¼š
- å¼€å‘äººå‘˜ï¼šåªèƒ½è¯»å–æœåŠ¡ä¿¡æ¯ï¼Œä¸èƒ½åˆ é™¤
- è¿ç»´äººå‘˜ï¼šå¯ä»¥æ³¨å†ŒæœåŠ¡ï¼Œä½†ä¸èƒ½åˆ é™¤é…ç½®
- ç®¡ç†å‘˜ï¼šæ‹¥æœ‰æ‰€æœ‰æƒé™

å°±åƒå…¬å¸é—¨ç¦å¡ï¼š
- æ™®é€šå‘˜å·¥ï¼šåªèƒ½è¿›åŠå…¬åŒº
- éƒ¨é—¨ä¸»ç®¡ï¼šå¯ä»¥è¿›ä¼šè®®å®¤
- æ€»ç»ç†ï¼šæ‰€æœ‰åŒºåŸŸéƒ½èƒ½è¿›
```

### 6.2 å¯ç”¨ACLåŠŸèƒ½


**æ­¥éª¤â‘ ï¼šä¿®æ”¹Serveré…ç½®å¯ç”¨ACL**ï¼š
```json
{
  "datacenter": "dc1",
  "data_dir": "/opt/consul/data",
  "node_name": "consul-server-1",
  "server": true,
  
  "acl": {
    "enabled": true,
    "default_policy": "deny",
    "enable_token_persistence": true,
    "tokens": {
      "initial_management": "bootstrap-token-secret"
    }
  }
}
```

**é…ç½®è¯´æ˜**ï¼š
- `enabled: true`ï¼šå¯ç”¨ACL
- `default_policy: deny`ï¼šé»˜è®¤æ‹’ç»æ‰€æœ‰è¯·æ±‚ï¼ˆç™½åå•æ¨¡å¼ï¼‰
- `enable_token_persistence`ï¼štokenæŒä¹…åŒ–ï¼Œé‡å¯ä¸ä¸¢å¤±
- `initial_management`ï¼šåˆå§‹ç®¡ç†å‘˜tokenï¼ˆé¦–æ¬¡å¯åŠ¨åç”Ÿæˆï¼‰

**æ­¥éª¤â‘¡ï¼šé‡å¯Consulå¹¶åˆå§‹åŒ–ACL**ï¼š
```bash
# é‡å¯Server
systemctl restart consul

# åˆå§‹åŒ–ACL(åªåœ¨ä¸€ä¸ªServerä¸Šæ‰§è¡Œä¸€æ¬¡)
consul acl bootstrap
# è¾“å‡ºç¤ºä¾‹ï¼š
# AccessorID:       e6a8e64c-xxxx-xxxx-xxxx-xxxxxxxxxxxx
# SecretID:         a1b2c3d4-xxxx-xxxx-xxxx-xxxxxxxxxxxx  â† ç®¡ç†å‘˜Token
# Description:      Bootstrap Token (Global Management)
# Local:            false
# Create Time:      2024-01-01 10:00:00
# Policies:
#    00000000-0000-0000-0000-000000000001 - global-management
```

> âš ï¸ **é‡è¦**ï¼šSecretIDå°±æ˜¯ç®¡ç†å‘˜Tokenï¼ŒåŠ¡å¿…å¦¥å–„ä¿å­˜ï¼

### 6.3 åˆ›å»ºç­–ç•¥å’ŒToken


**ACLç­–ç•¥è¯­æ³•**ï¼ˆHCLæ ¼å¼ï¼‰ï¼š
```hcl
# policy.hcl - åªè¯»ç­–ç•¥ç¤ºä¾‹
service_prefix "" {
  policy = "read"     # å¯è¯»å–æ‰€æœ‰æœåŠ¡
}

key_prefix "" {
  policy = "deny"     # ç¦æ­¢è®¿é—®KVå­˜å‚¨
}

node_prefix "" {
  policy = "read"     # å¯æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯
}
```

**åˆ›å»ºç­–ç•¥**ï¼š
```bash
# ä½¿ç”¨ç®¡ç†å‘˜Tokenåˆ›å»ºç­–ç•¥
export CONSUL_HTTP_TOKEN=a1b2c3d4-xxxx-xxxx-xxxx-xxxxxxxxxxxx

consul acl policy create \
  -name "service-read-only" \
  -description "åªè¯»æœåŠ¡ç­–ç•¥" \
  -rules @policy.hcl
```

**åˆ›å»ºTokenå¹¶ç»‘å®šç­–ç•¥**ï¼š
```bash
consul acl token create \
  -description "å¼€å‘ç¯å¢ƒåªè¯»Token" \
  -policy-name "service-read-only"

# è¾“å‡ºï¼š
# AccessorID:   f7b8c9d0-xxxx-xxxx-xxxx-xxxxxxxxxxxx
# SecretID:     dev-readonly-token-xxx  â† ç»™å¼€å‘äººå‘˜ä½¿ç”¨
# Description:  å¼€å‘ç¯å¢ƒåªè¯»Token
# Local:        false
# Policies:
#    service-read-only
```

### 6.4 åº”ç”¨ä½¿ç”¨ACL Token


**Spring Booté…ç½®**ï¼š
```yaml
spring:
  cloud:
    consul:
      host: 127.0.0.1
      port: 8500
      discovery:
        acl-token: dev-readonly-token-xxx  # é…ç½®Token
        service-name: order-service
```

**APIè¯·æ±‚æºå¸¦Token**ï¼š
```bash
# ä¸å¸¦Token - è¢«æ‹’ç»
curl http://127.0.0.1:8500/v1/catalog/services
# è¾“å‡º: Permission denied

# å¸¦Token - æˆåŠŸ
curl -H "X-Consul-Token: dev-readonly-token-xxx" \
  http://127.0.0.1:8500/v1/catalog/services
# è¾“å‡º: {"order-service":[], "user-service":[]}
```

**å¸¸ç”¨æƒé™ç­–ç•¥æ¨¡æ¿**ï¼š

| è§’è‰² | **ç­–ç•¥å†…å®¹** | **ä½¿ç”¨åœºæ™¯** |
|-----|-------------|------------|
| ğŸ”§ **è¿ç»´ç®¡ç†å‘˜** | `service/node/key: write` | `å¯æ³¨å†ŒæœåŠ¡ã€ä¿®æ”¹é…ç½®` |
| ğŸ‘¨â€ğŸ’» **å¼€å‘äººå‘˜** | `service/node: read, key: deny` | `åªèƒ½æŸ¥è¯¢æœåŠ¡ï¼Œä¸èƒ½æ”¹é…ç½®` |
| ğŸ“Š **ç›‘æ§ç³»ç»Ÿ** | `node/service: read, key: deny` | `é‡‡é›†æŒ‡æ ‡ï¼Œä¸èƒ½ä¿®æ”¹æ•°æ®` |
| ğŸ¤– **åº”ç”¨æœåŠ¡** | `service: write (ä»…è‡ªå·±)` | `åªèƒ½æ³¨å†Œ/æ³¨é”€è‡ªå·±çš„æœåŠ¡` |

---

## 7. ğŸ”’ TLSåŠ å¯†é…ç½®


### 7.1 ä¸ºä»€ä¹ˆéœ€è¦TLSåŠ å¯†


**å®‰å…¨é£é™©**ï¼š
```
æœªåŠ å¯†é€šä¿¡ï¼š
Client â†’ [æ˜æ–‡æ•°æ®] â†’ Server
              â†‘
         é»‘å®¢å¯ç›‘å¬/ç¯¡æ”¹

åŠ å¯†åï¼š
Client â†’ [åŠ å¯†æ•°æ®] â†’ Server
              â†‘
         æ— æ³•è§£å¯†ï¼Œå®‰å…¨ï¼
```

**TLSä¿æŠ¤çš„é€šä¿¡**ï¼š
- âœ… RPCé€šä¿¡ï¼šServerä¹‹é—´ã€Clientä¸Serverä¹‹é—´
- âœ… HTTP APIï¼šWebç•Œé¢ã€REST APIè°ƒç”¨
- âœ… Gossipåè®®ï¼šèŠ‚ç‚¹é—´çš„é›†ç¾¤é€šä¿¡

### 7.2 ç”ŸæˆTLSè¯ä¹¦


**ä½¿ç”¨Consulå†…ç½®å·¥å…·ç”Ÿæˆ**ï¼š
```bash
# 1. åˆ›å»ºCAè¯ä¹¦(æ ¹è¯ä¹¦)
consul tls ca create
# ç”Ÿæˆæ–‡ä»¶ï¼š
# consul-agent-ca.pem     â† CAå…¬é’¥
# consul-agent-ca-key.pem â† CAç§é’¥

# 2. ä¸ºServerç”Ÿæˆè¯ä¹¦
consul tls cert create -server -dc dc1
# ç”Ÿæˆæ–‡ä»¶ï¼š
# dc1-server-consul-0.pem      â† Serverè¯ä¹¦
# dc1-server-consul-0-key.pem  â† Serverç§é’¥

# 3. ä¸ºClientç”Ÿæˆè¯ä¹¦
consul tls cert create -client -dc dc1
# ç”Ÿæˆæ–‡ä»¶ï¼š
# dc1-client-consul-0.pem      â† Clientè¯ä¹¦
# dc1-client-consul-0-key.pem  â† Clientç§é’¥
```

**åˆ†å‘è¯ä¹¦**ï¼š
```bash
# å¤åˆ¶åˆ°å„èŠ‚ç‚¹
# ServerèŠ‚ç‚¹éœ€è¦ï¼š
- consul-agent-ca.pem          (CAè¯ä¹¦)
- dc1-server-consul-0.pem      (Serverè¯ä¹¦)
- dc1-server-consul-0-key.pem  (Serverç§é’¥)

# ClientèŠ‚ç‚¹éœ€è¦ï¼š
- consul-agent-ca.pem          (CAè¯ä¹¦)
- dc1-client-consul-0.pem      (Clientè¯ä¹¦)
- dc1-client-consul-0-key.pem  (Clientç§é’¥)
```

### 7.3 é…ç½®TLSåŠ å¯†


**Serveré…ç½®**ï¼ˆ`/etc/consul.d/tls-server.json`ï¼‰ï¼š
```json
{
  "datacenter": "dc1",
  "node_name": "consul-server-1",
  "server": true,
  
  "verify_incoming": true,
  "verify_outgoing": true,
  "verify_server_hostname": true,
  
  "ca_file": "/etc/consul.d/certs/consul-agent-ca.pem",
  "cert_file": "/etc/consul.d/certs/dc1-server-consul-0.pem",
  "key_file": "/etc/consul.d/certs/dc1-server-consul-0-key.pem",
  
  "ports": {
    "https": 8501,
    "http": -1
  }
}
```

**é…ç½®é¡¹è§£é‡Š**ï¼š
- `verify_incoming: true`ï¼šéªŒè¯è¿›å…¥è¿æ¥çš„è¯ä¹¦ï¼ˆServeréªŒè¯Clientï¼‰
- `verify_outgoing: true`ï¼šéªŒè¯å¤–å‡ºè¿æ¥çš„è¯ä¹¦ï¼ˆClientéªŒè¯Serverï¼‰
- `verify_server_hostname: true`ï¼šéªŒè¯Serverä¸»æœºåï¼Œé˜²æ­¢ä¸­é—´äººæ”»å‡»
- `http: -1`ï¼šç¦ç”¨HTTPç«¯å£ï¼Œå¼ºåˆ¶ä½¿ç”¨HTTPS

**Clienté…ç½®**ï¼ˆ`/etc/consul.d/tls-client.json`ï¼‰ï¼š
```json
{
  "datacenter": "dc1",
  "node_name": "consul-client-1",
  "server": false,
  
  "verify_incoming": false,
  "verify_outgoing": true,
  "verify_server_hostname": true,
  
  "ca_file": "/etc/consul.d/certs/consul-agent-ca.pem",
  "cert_file": "/etc/consul.d/certs/dc1-client-consul-0.pem",
  "key_file": "/etc/consul.d/certs/dc1-client-consul-0-key.pem"
}
```

### 7.4 å¯ç”¨TLSåçš„è®¿é—®


**å‘½ä»¤è¡Œè®¿é—®**ï¼š
```bash
# æŒ‡å®šè¯ä¹¦è®¿é—®
consul members \
  -ca-file=/etc/consul.d/certs/consul-agent-ca.pem \
  -client-cert=/etc/consul.d/certs/dc1-client-consul-0.pem \
  -client-key=/etc/consul.d/certs/dc1-client-consul-0-key.pem \
  -http-addr=https://127.0.0.1:8501

# æˆ–é…ç½®ç¯å¢ƒå˜é‡
export CONSUL_HTTP_ADDR=https://127.0.0.1:8501
export CONSUL_CACERT=/etc/consul.d/certs/consul-agent-ca.pem
export CONSUL_CLIENT_CERT=/etc/consul.d/certs/dc1-client-consul-0.pem
export CONSUL_CLIENT_KEY=/etc/consul.d/certs/dc1-client-consul-0-key.pem

consul members  # ç›´æ¥ä½¿ç”¨
```

**å¾®æœåŠ¡é…ç½®**ï¼š
```yaml
spring:
  cloud:
    consul:
      host: 127.0.0.1
      port: 8501
      scheme: https
      tls:
        enabled: true
        key-store-path: /path/to/keystore.p12
        key-store-password: secret
```

---

## 8. ğŸ“Š ç›‘æ§å‘Šè­¦é…ç½®


### 8.1 ç›‘æ§æŒ‡æ ‡æ¦‚è§ˆ


**Consulæ ¸å¿ƒç›‘æ§æŒ‡æ ‡**ï¼š

| æŒ‡æ ‡ç±»å‹ | **å…³é”®æŒ‡æ ‡** | **æ­£å¸¸èŒƒå›´** | **å‘Šè­¦é˜ˆå€¼** |
|---------|------------|------------|------------|
| ğŸ›ï¸ **é›†ç¾¤å¥åº·** | `Leaderé€‰ä¸¾æ¬¡æ•°` | `0æ¬¡/å¤©` | `>3æ¬¡/å¤©` |
| ğŸ’¾ **æ•°æ®å­˜å‚¨** | `KVå­˜å‚¨å¤§å°` | `<1GB` | `>5GB` |
| ğŸŒ **RPCè°ƒç”¨** | `RPCè¯·æ±‚å»¶è¿Ÿ` | `<50ms` | `>200ms` |
| ğŸ“¡ **Gossipåè®®** | `èŠ‚ç‚¹å¥åº·æ£€æŸ¥å¤±è´¥` | `0æ¬¡` | `>10æ¬¡/å°æ—¶` |
| ğŸ”„ **Raftå…±è¯†** | `æ—¥å¿—å¤åˆ¶å»¶è¿Ÿ` | `<100ms` | `>500ms` |

### 8.2 Prometheusç›‘æ§é›†æˆ


**å¯ç”¨ConsulæŒ‡æ ‡å¯¼å‡º**ï¼š
```json
{
  "telemetry": {
    "prometheus_retention_time": "60s",
    "disable_hostname": false
  }
}
```

**PrometheusæŠ“å–é…ç½®**ï¼ˆ`prometheus.yml`ï¼‰ï¼š
```yaml
scrape_configs:
  - job_name: 'consul'
    static_configs:
      - targets: 
          - '192.168.1.101:8500'
          - '192.168.1.102:8500'
          - '192.168.1.103:8500'
    metrics_path: '/v1/agent/metrics'
    params:
      format: ['prometheus']
```

### 8.3 å‘Šè­¦è§„åˆ™é…ç½®


**Prometheuså‘Šè­¦è§„åˆ™**ï¼ˆ`consul-alerts.yml`ï¼‰ï¼š
```yaml
groups:
  - name: consul_alerts
    interval: 30s
    rules:
      # Leaderé¢‘ç¹åˆ‡æ¢å‘Šè­¦
      - alert: ConsulLeaderChange
        expr: changes(consul_raft_leader[10m]) > 2
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Consul Leaderé¢‘ç¹åˆ‡æ¢"
          description: "10åˆ†é’Ÿå†…Leaderåˆ‡æ¢è¶…è¿‡2æ¬¡"
      
      # èŠ‚ç‚¹ä¸‹çº¿å‘Šè­¦
      - alert: ConsulNodeDown
        expr: consul_serf_lan_members{status="alive"} < 3
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "ConsulèŠ‚ç‚¹æ•°é‡ä¸è¶³"
          description: "å½“å‰å­˜æ´»èŠ‚ç‚¹: {{ $value }}"
      
      # RPCå»¶è¿Ÿå‘Šè­¦
      - alert: ConsulHighRPCLatency
        expr: consul_rpc_request_duration_seconds{quantile="0.99"} > 0.2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Consul RPCå»¶è¿Ÿè¿‡é«˜"
          description: "99åˆ†ä½å»¶è¿Ÿ: {{ $value }}s"
```

### 8.4 Grafanaå¯è§†åŒ–


**å¯¼å…¥Consul Dashboard**ï¼š
```
1. æ‰“å¼€Grafana â†’ Dashboards â†’ Import
2. è¾“å…¥Dashboard ID: 13396
3. é€‰æ‹©Prometheusæ•°æ®æº
4. ç‚¹å‡»Import
```

**å…³é”®ç›‘æ§é¢æ¿**ï¼š
```
ğŸ“Š é›†ç¾¤æ¦‚è§ˆé¢æ¿ï¼š
- ServerèŠ‚ç‚¹æ•°é‡
- LeaderçŠ¶æ€
- æ³¨å†ŒæœåŠ¡æ€»æ•°

ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡é¢æ¿ï¼š
- RPCè¯·æ±‚QPS
- è¯·æ±‚å»¶è¿ŸP99
- å†…å­˜ä½¿ç”¨ç‡

ğŸš¨ å¥åº·æ£€æŸ¥é¢æ¿ï¼š
- å¥åº·æ£€æŸ¥å¤±è´¥æ¬¡æ•°
- æœåŠ¡å®ä¾‹å¥åº·åº¦
- èŠ‚ç‚¹çŠ¶æ€åˆ†å¸ƒ
```

---

## 9. ğŸ“ æ—¥å¿—ç®¡ç†é…ç½®


### 9.1 æ—¥å¿—çº§åˆ«è¯´æ˜


**æ—¥å¿—çº§åˆ«å¯¹æ¯”**ï¼š

| çº§åˆ« | **åŒ…å«å†…å®¹** | **é€‚ç”¨åœºæ™¯** | **æ—¥å¿—é‡** |
|-----|------------|------------|----------|
| `TRACE` | `æœ€è¯¦ç»†è°ƒè¯•ä¿¡æ¯` | `å¼€å‘è°ƒè¯•` | `æå¤§` |
| `DEBUG` | `è¯¦ç»†è°ƒè¯•ä¿¡æ¯` | `é—®é¢˜æ’æŸ¥` | `å¤§` |
| `INFO` | `å¸¸è§„è¿è¡Œä¿¡æ¯` | `ç”Ÿäº§ç¯å¢ƒ` | `ä¸­` |
| `WARN` | `è­¦å‘Šä¿¡æ¯` | `å…³æ³¨å¼‚å¸¸` | `å°‘` |
| `ERROR` | `é”™è¯¯ä¿¡æ¯` | `æ•…éšœæ’æŸ¥` | `æå°‘` |

**ç”Ÿäº§ç¯å¢ƒæ¨è**ï¼š
```json
{
  "log_level": "INFO",
  "log_json": true,
  "enable_syslog": false
}
```

### 9.2 æ—¥å¿—è½®è½¬é…ç½®


**è‡ªåŠ¨è½®è½¬é…ç½®**ï¼š
```json
{
  "log_file": "/var/log/consul/consul.log",
  "log_rotate_duration": "24h",
  "log_rotate_bytes": 104857600,
  "log_rotate_max_files": 7
}
```

**é…ç½®è¯´æ˜**ï¼š
- `log_rotate_duration: "24h"`ï¼šæ¯24å°æ—¶è½®è½¬ä¸€æ¬¡
- `log_rotate_bytes: 104857600`ï¼šæ–‡ä»¶å¤§å°è¶…è¿‡100MBè½®è½¬
- `log_rotate_max_files: 7`ï¼šä¿ç•™æœ€è¿‘7ä¸ªæ—¥å¿—æ–‡ä»¶

**æ—¥å¿—æ–‡ä»¶ç¤ºä¾‹**ï¼š
```
/var/log/consul/
â”œâ”€â”€ consul.log              â† å½“å‰æ—¥å¿—
â”œâ”€â”€ consul.log.2024-01-01   â† æ˜¨å¤©æ—¥å¿—
â”œâ”€â”€ consul.log.2024-01-02
â”œâ”€â”€ consul.log.2024-01-03
â””â”€â”€ ...
```

### 9.3 æ—¥å¿—é‡‡é›†æ–¹æ¡ˆ


**æ–¹æ¡ˆä¸€ï¼šELK Stack**ï¼š
```yaml
# Filebeaté…ç½®
filebeat.inputs:
  - type: log
    enabled: true
    paths:
      - /var/log/consul/*.log
    fields:
      service: consul
      env: production
    json.keys_under_root: true

output.elasticsearch:
  hosts: ["http://es-cluster:9200"]
  index: "consul-logs-%{+yyyy.MM.dd}"
```

**æ–¹æ¡ˆäºŒï¼šLoki + Promtail**ï¼š
```yaml
# Promtailé…ç½®
scrape_configs:
  - job_name: consul
    static_configs:
      - targets:
          - localhost
        labels:
          job: consul
          __path__: /var/log/consul/*.log
    pipeline_stages:
      - json:
          expressions:
            level: level
            timestamp: timestamp
            msg: msg
```

### 9.4 æ—¥å¿—æŸ¥è¯¢æŠ€å·§


**æŸ¥çœ‹å®æ—¶æ—¥å¿—**ï¼š
```bash
# å®æ—¶æŸ¥çœ‹
tail -f /var/log/consul/consul.log

# æŸ¥çœ‹æœ€è¿‘100è¡Œ
tail -n 100 /var/log/consul/consul.log

# æŒ‰å…³é”®è¯è¿‡æ»¤
grep "ERROR" /var/log/consul/consul.log
grep "raft" /var/log/consul/consul.log | tail -20
```

**å¸¸è§é—®é¢˜æ’æŸ¥**ï¼š
```bash
# 1. Leaderé€‰ä¸¾é—®é¢˜
grep "leader" /var/log/consul/consul.log

# 2. èŠ‚ç‚¹è¿æ¥é—®é¢˜
grep "memberlist" /var/log/consul/consul.log

# 3. RPCè°ƒç”¨é”™è¯¯
grep "rpc error" /var/log/consul/consul.log

# 4. æœåŠ¡æ³¨å†Œå¤±è´¥
grep "catalog" /var/log/consul/consul.log
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ é›†ç¾¤æ¶æ„ï¼šServer(ç®¡ç†) + Client(ä»£ç†) çš„ä¸¤å±‚ç»“æ„
ğŸ”¸ é«˜å¯ç”¨åŸç†ï¼š3-5ä¸ªServerï¼Œé€šè¿‡Rafté€‰ä¸¾Leader
ğŸ”¸ éƒ¨ç½²è¦ç‚¹ï¼šå¥‡æ•°Serverã€retry_joinè‡ªåŠ¨åŠ å…¥
ğŸ”¸ æƒé™æ§åˆ¶ï¼šACLç­–ç•¥ + Token å®ç°ç»†ç²’åº¦æƒé™
ğŸ”¸ å®‰å…¨åŠ å›ºï¼šTLSåŠ å¯† + è¯ä¹¦éªŒè¯
ğŸ”¸ ç›‘æ§è¿ç»´ï¼šPrometheusæŒ‡æ ‡ + Grafanaå¯è§†åŒ–
```

### 10.2 å…³é”®é…ç½®é€ŸæŸ¥


**Serveræ ¸å¿ƒé…ç½®**ï¼š
```json
{
  "server": true,
  "bootstrap_expect": 3,
  "retry_join": ["ip1", "ip2", "ip3"],
  "acl": {"enabled": true},
  "verify_outgoing": true
}
```

**Clientæ ¸å¿ƒé…ç½®**ï¼š
```json
{
  "server": false,
  "client_addr": "127.0.0.1",
  "retry_join": ["server1", "server2", "server3"]
}
```

### 10.3 å¸¸è§é—®é¢˜æ’æŸ¥


| é—®é¢˜ | **åŸå› ** | **è§£å†³æ–¹æ¡ˆ** |
|-----|---------|------------|
| âŒ **èŠ‚ç‚¹æ— æ³•åŠ å…¥é›†ç¾¤** | `ç½‘ç»œä¸é€š/é…ç½®é”™è¯¯` | `æ£€æŸ¥bind_addrå’Œretry_join` |
| âŒ **é¢‘ç¹é€‰ä¸¾Leader** | `ç½‘ç»œå»¶è¿Ÿé«˜` | `è°ƒå¤§raft_multiplier` |
| âŒ **æœåŠ¡æ³¨å†Œå¤±è´¥** | `ACLæƒé™ä¸è¶³` | `æ£€æŸ¥Tokenæƒé™ç­–ç•¥` |
| âŒ **Clientè¿æ¥è¶…æ—¶** | `Serverå‹åŠ›å¤§` | `å¢åŠ ClientèŠ‚ç‚¹åˆ†æ•£å‹åŠ›` |

### 10.4 ç”Ÿäº§ç¯å¢ƒæ£€æŸ¥æ¸…å•


**éƒ¨ç½²å‰æ£€æŸ¥**ï¼š
```
âœ… æœåŠ¡å™¨æ—¶é—´åŒæ­¥(NTP)
âœ… ç½‘ç»œç«¯å£å¼€æ”¾(8300/8301/8500)
âœ… ç£ç›˜ç©ºé—´å……è¶³(>50GB)
âœ… é…ç½®æ–‡ä»¶å¤‡ä»½
âœ… TLSè¯ä¹¦æœ‰æ•ˆæœŸ
âœ… ACLç­–ç•¥æµ‹è¯•
âœ… ç›‘æ§å‘Šè­¦é…ç½®
âœ… æ—¥å¿—è½®è½¬è®¾ç½®
```

**ä¸Šçº¿åéªŒè¯**ï¼š
```bash
# 1. é›†ç¾¤çŠ¶æ€
consul members

# 2. LeaderçŠ¶æ€
consul operator raft list-peers

# 3. æœåŠ¡æ³¨å†Œæµ‹è¯•
consul services register test-service.json

# 4. å¥åº·æ£€æŸ¥
consul catalog services

# 5. æ€§èƒ½æŒ‡æ ‡
curl http://localhost:8500/v1/agent/metrics
```

### 10.5 æœ€ä½³å®è·µå»ºè®®


**æ¶æ„è®¾è®¡**ï¼š
- ğŸ¯ ServerèŠ‚ç‚¹è·¨æœºæˆ¿éƒ¨ç½²ï¼Œé¿å…å•ç‚¹æ•…éšœ
- ğŸ¯ ClientèŠ‚ç‚¹ä¸åº”ç”¨æœåŠ¡åŒæœºå™¨éƒ¨ç½²
- ğŸ¯ ä½¿ç”¨ä¸“ç”¨ç½‘ç»œï¼Œéš”ç¦»ä¸šåŠ¡æµé‡

**å®‰å…¨åŠ å›º**ï¼š
- ğŸ”’ ç”Ÿäº§ç¯å¢ƒå¿…é¡»å¯ç”¨ACLå’ŒTLS
- ğŸ”’ å®šæœŸè½®æ¢Tokenå’Œè¯ä¹¦
- ğŸ”’ æœ€å°æƒé™åŸåˆ™åˆ†é…ç­–ç•¥

**æ€§èƒ½ä¼˜åŒ–**ï¼š
- âš¡ ServerèŠ‚ç‚¹ä½¿ç”¨SSDç£ç›˜
- âš¡ åˆç†è®¾ç½®å¥åº·æ£€æŸ¥é—´éš”
- âš¡ Clientæœ¬åœ°ç¼“å­˜å‡å°‘Serverå‹åŠ›

**è¿ç»´ç›‘æ§**ï¼š
- ğŸ“Š å®æ—¶ç›‘æ§é›†ç¾¤çŠ¶æ€å’Œæ€§èƒ½æŒ‡æ ‡
- ğŸ“Š è®¾ç½®å¤šçº§å‘Šè­¦è§„åˆ™
- ğŸ“Š æ—¥å¿—é›†ä¸­ç®¡ç†ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥

---

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
Consulé›†ç¾¤é«˜å¯ç”¨ï¼ŒServerå¥‡æ•°Leaderé€‰
Clientä»£ç†åˆ†å‹åŠ›,æœ¬åœ°ç¼“å­˜å“åº”å¿«
ACLæƒé™ç»†æ§åˆ¶,TLSåŠ å¯†ä¿å®‰å…¨
ç›‘æ§æ—¥å¿—è¦å®Œå–„,ç”Ÿäº§è¿ç»´ä¿å¹³å®‰
```