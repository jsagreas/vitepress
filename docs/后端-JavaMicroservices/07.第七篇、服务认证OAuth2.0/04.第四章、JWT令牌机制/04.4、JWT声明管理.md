---
title: 4ã€JWTå£°æ˜ç®¡ç†
---
## ğŸ“š ç›®å½•

1. [ä»€ä¹ˆæ˜¯JWTå£°æ˜ï¼ˆClaimsï¼‰](#1-ä»€ä¹ˆæ˜¯jwtå£°æ˜claims)
2. [æ ‡å‡†å£°æ˜è¯¦è§£](#2-æ ‡å‡†å£°æ˜è¯¦è§£)
3. [è‡ªå®šä¹‰å£°æ˜è®¾è®¡](#3-è‡ªå®šä¹‰å£°æ˜è®¾è®¡)
4. [æ ¸å¿ƒæ—¶é—´å£°æ˜](#4-æ ¸å¿ƒæ—¶é—´å£°æ˜)
5. [ä½œç”¨åŸŸScopeå£°æ˜](#5-ä½œç”¨åŸŸscopeå£°æ˜)
6. [å®‰å…¨æœ€ä½³å®è·µ](#6-å®‰å…¨æœ€ä½³å®è·µ)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ ä»€ä¹ˆæ˜¯JWTå£°æ˜ï¼ˆClaimsï¼‰


### 1.1 å£°æ˜çš„æœ¬è´¨ç†è§£


**Claimså°±åƒæ˜¯èº«ä»½è¯ä¸Šçš„ä¿¡æ¯**ï¼š
```
èº«ä»½è¯ä¸Šæœ‰ï¼š                    JWTçš„Claimsæœ‰ï¼š
- å§“å                         - ç”¨æˆ·åï¼ˆsubï¼‰
- èº«ä»½è¯å·                     - ç”¨æˆ·ID
- å‡ºç”Ÿæ—¥æœŸ                     - ç­¾å‘æ—¶é—´ï¼ˆiatï¼‰
- æœ‰æ•ˆæœŸ                       - è¿‡æœŸæ—¶é—´ï¼ˆexpï¼‰
- ç­¾å‘æœºå…³                     - ç­¾å‘è€…ï¼ˆissï¼‰
```

**é€šä¿—ç†è§£**ï¼š
- Claimså°±æ˜¯**JWTä»¤ç‰Œä¸­æºå¸¦çš„ä¿¡æ¯**ï¼Œå‘Šè¯‰ç³»ç»Ÿ"è¿™ä¸ªç”¨æˆ·æ˜¯è°ã€èƒ½åšä»€ä¹ˆã€æœ‰æ•ˆæœŸå¤šä¹…"
- è¿™äº›ä¿¡æ¯ä¼šè¢«**ç¼–ç åˆ°JWTä¸­**ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½ä¼šå¸¦ç€å®ƒ
- æœåŠ¡å™¨é€šè¿‡è¯»å–è¿™äº›Claimså°±çŸ¥é“ç”¨æˆ·çš„èº«ä»½å’Œæƒé™

### 1.2 Claimsåœ¨JWTä¸­çš„ä½ç½®


**JWTçš„ä¸‰æ®µå¼ç»“æ„**ï¼š
```
å®Œæ•´JWTä»¤ç‰Œï¼š
eyJhbGc...å¤´éƒ¨.eyJzdWI...è½½è·.SflKxwRJ...ç­¾å

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Header â”‚ . â”‚   Payload    â”‚ . â”‚ Signatureâ”‚
â”‚  ï¼ˆå¤´éƒ¨ï¼‰  â”‚    â”‚  ï¼ˆè½½è·ï¼‰     â”‚    â”‚  ï¼ˆç­¾åï¼‰ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†‘
                 Claimså°±åœ¨è¿™é‡Œï¼
```

**Payloadè½½è·éƒ¨åˆ†åŒ…å«**ï¼š
- **æ ‡å‡†å£°æ˜**ï¼šJWTè§„èŒƒå®šä¹‰çš„å­—æ®µï¼ˆå¦‚expã€iatã€subç­‰ï¼‰
- **è‡ªå®šä¹‰å£°æ˜**ï¼šæˆ‘ä»¬è‡ªå·±æ·»åŠ çš„ä¸šåŠ¡ä¿¡æ¯ï¼ˆå¦‚userIdã€usernameã€rolesç­‰ï¼‰

### 1.3 ä¸ºä»€ä¹ˆéœ€è¦Claims


**æ ¸å¿ƒä½œç”¨**ï¼š
- ğŸ”¸ **èº«ä»½è¯†åˆ«**ï¼šå‘Šè¯‰ç³»ç»Ÿ"æˆ‘æ˜¯è°"ï¼ˆç”¨æˆ·IDã€ç”¨æˆ·åï¼‰
- ğŸ”¸ **æƒé™æ§åˆ¶**ï¼šå‘Šè¯‰ç³»ç»Ÿ"æˆ‘èƒ½åšä»€ä¹ˆ"ï¼ˆè§’è‰²ã€æƒé™åˆ—è¡¨ï¼‰
- ğŸ”¸ **æœ‰æ•ˆæœŸç®¡ç†**ï¼šå‘Šè¯‰ç³»ç»Ÿ"æˆ‘è¿˜æœ‰æ•ˆå—"ï¼ˆè¿‡æœŸæ—¶é—´ã€ç­¾å‘æ—¶é—´ï¼‰
- ğŸ”¸ **ä¸šåŠ¡ä¿¡æ¯**ï¼šæºå¸¦å¿…è¦çš„ä¸šåŠ¡æ•°æ®ï¼ˆéƒ¨é—¨ã€é‚®ç®±ç­‰ï¼‰

**å®é™…åº”ç”¨åœºæ™¯**ï¼š
```
ç”¨æˆ·ç™»å½•å â†’ ç”ŸæˆJWT â†’ åŒ…å«Claimsä¿¡æ¯ï¼š
{
  "sub": "user123",           â† ç”¨æˆ·æ ‡è¯†
  "username": "å¼ ä¸‰",         â† ç”¨æˆ·å
  "roles": ["ADMIN"],        â† è§’è‰²
  "exp": 1727136000,         â† è¿‡æœŸæ—¶é—´
  "iat": 1727132400          â† ç­¾å‘æ—¶é—´
}

åç»­æ¯æ¬¡è¯·æ±‚ â†’ æºå¸¦è¿™ä¸ªJWT â†’ æœåŠ¡å™¨è§£æClaims â†’ çŸ¥é“ç”¨æˆ·èº«ä»½å’Œæƒé™
```

---

## 2. ğŸ“‹ æ ‡å‡†å£°æ˜è¯¦è§£


### 2.1 ä»€ä¹ˆæ˜¯æ ‡å‡†å£°æ˜


**æ ‡å‡†å£°æ˜ï¼ˆRegistered Claimsï¼‰**æ˜¯JWTè§„èŒƒé¢„å®šä¹‰çš„å­—æ®µï¼Œæ‰€æœ‰JWTå®ç°éƒ½è®¤è¯†å®ƒä»¬ã€‚

**å°±åƒèº«ä»½è¯çš„æ ‡å‡†æ ¼å¼**ï¼š
- å…¨å›½èº«ä»½è¯éƒ½æœ‰å§“åã€è¯ä»¶å·ã€æœ‰æ•ˆæœŸç­‰å›ºå®šå­—æ®µ
- JWTçš„æ ‡å‡†å£°æ˜ä¹Ÿæ˜¯è¿™æ ·ï¼Œå¤§å®¶éƒ½æŒ‰ç»Ÿä¸€è§„åˆ™ä½¿ç”¨

### 2.2 æ ¸å¿ƒæ ‡å‡†å£°æ˜è¯´æ˜


| å£°æ˜å­—æ®µ | è‹±æ–‡å…¨ç§° | ä¸­æ–‡å«ä¹‰ | ä½œç”¨è¯´æ˜ |
|---------|---------|---------|---------|
| **iss** | `Issuer` | ç­¾å‘è€… | `è°é¢å‘çš„è¿™ä¸ªä»¤ç‰Œï¼ˆå¦‚ï¼šauth-serviceï¼‰` |
| **sub** | `Subject` | ä¸»é¢˜/ç”¨æˆ·æ ‡è¯† | `ä»¤ç‰Œæ˜¯å…³äºè°çš„ï¼ˆé€šå¸¸æ˜¯ç”¨æˆ·IDï¼‰` |
| **aud** | `Audience` | å—ä¼— | `ä»¤ç‰Œæ˜¯ç»™è°ç”¨çš„ï¼ˆå¦‚ï¼šapi-gatewayï¼‰` |
| **exp** | `Expiration Time` | è¿‡æœŸæ—¶é—´ | `ä»¤ç‰Œä»€ä¹ˆæ—¶å€™å¤±æ•ˆï¼ˆUnixæ—¶é—´æˆ³ï¼‰` |
| **nbf** | `Not Before` | ç”Ÿæ•ˆæ—¶é—´ | `ä»¤ç‰Œä»ä»€ä¹ˆæ—¶å€™å¼€å§‹æœ‰æ•ˆ` |
| **iat** | `Issued At` | ç­¾å‘æ—¶é—´ | `ä»¤ç‰Œä»€ä¹ˆæ—¶å€™è¢«åˆ›å»ºçš„` |
| **jti** | `JWT ID` | ä»¤ç‰Œå”¯ä¸€æ ‡è¯† | `ä»¤ç‰Œçš„å”¯ä¸€ç¼–å·ï¼ˆé˜²é‡æ”¾æ”»å‡»ï¼‰` |

### 2.3 æ ‡å‡†å£°æ˜å®é™…åº”ç”¨


**ç¤ºä¾‹1ï¼šç”¨æˆ·ç™»å½•åç”ŸæˆJWT**
```java
// åˆ›å»ºJWTæ—¶è®¾ç½®æ ‡å‡†å£°æ˜
String jwt = Jwts.builder()
    .setIssuer("auth-service")           // issï¼šè°ç­¾å‘çš„
    .setSubject("user_12345")            // subï¼šç”¨æˆ·æ ‡è¯†
    .setAudience("api-gateway")          // audï¼šç»™è°ç”¨çš„
    .setIssuedAt(new Date())             // iatï¼šç°åœ¨ç­¾å‘
    .setExpiration(                      // expï¼š2å°æ—¶åè¿‡æœŸ
        new Date(System.currentTimeMillis() + 7200000)
    )
    .setId(UUID.randomUUID().toString()) // jtiï¼šå”¯ä¸€ID
    .signWith(secretKey)
    .compact();
```

**ç”Ÿæˆçš„Claimså†…å®¹**ï¼š
```json
{
  "iss": "auth-service",        â† è®¤è¯æœåŠ¡ç­¾å‘çš„
  "sub": "user_12345",          â† ç”¨æˆ·IDæ˜¯12345
  "aud": "api-gateway",         â† ç»™ç½‘å…³æœåŠ¡ç”¨çš„
  "iat": 1727132400,            â† 2024-09-23 18:00:00ç­¾å‘
  "exp": 1727139600,            â† 2024-09-23 20:00:00è¿‡æœŸ
  "jti": "a1b2c3d4-e5f6-..."    â† å”¯ä¸€ä»¤ç‰ŒID
}
```

**ç¤ºä¾‹2ï¼šéªŒè¯JWTæ—¶æ£€æŸ¥æ ‡å‡†å£°æ˜**
```java
try {
    Claims claims = Jwts.parserBuilder()
        .setSigningKey(secretKey)
        .requireIssuer("auth-service")    // å¿…é¡»æ˜¯è¿™ä¸ªç­¾å‘è€…
        .requireAudience("api-gateway")   // å¿…é¡»æ˜¯ç»™ç½‘å…³ç”¨çš„
        .build()
        .parseClaimsJws(jwt)
        .getBody();
    
    // è‡ªåŠ¨æ£€æŸ¥expè¿‡æœŸæ—¶é—´ï¼Œè¿‡æœŸä¼šæŠ›å¼‚å¸¸
    String userId = claims.getSubject();  // è·å–ç”¨æˆ·ID
    
} catch (ExpiredJwtException e) {
    // ä»¤ç‰Œè¿‡æœŸ
} catch (JwtException e) {
    // å…¶ä»–éªŒè¯å¤±è´¥
}
```

### 2.4 æ ‡å‡†å£°æ˜ä½¿ç”¨å»ºè®®


**å¿…é¡»è®¾ç½®çš„å£°æ˜**ï¼š
- âœ… **expï¼ˆè¿‡æœŸæ—¶é—´ï¼‰**ï¼šé˜²æ­¢ä»¤ç‰Œæ°¸ä¹…æœ‰æ•ˆ
- âœ… **iatï¼ˆç­¾å‘æ—¶é—´ï¼‰**ï¼šè®°å½•ä»¤ç‰Œåˆ›å»ºæ—¶é—´
- âœ… **subï¼ˆç”¨æˆ·æ ‡è¯†ï¼‰**ï¼šæ ‡è¯†ä»¤ç‰Œå±äºå“ªä¸ªç”¨æˆ·

**å¯é€‰ä½†æ¨èçš„å£°æ˜**ï¼š
- ğŸ”¸ **issï¼ˆç­¾å‘è€…ï¼‰**ï¼šå¤šæœåŠ¡ç¯å¢ƒä¸‹æ˜ç¡®æ¥æº
- ğŸ”¸ **jtiï¼ˆå”¯ä¸€IDï¼‰**ï¼šéœ€è¦ä»¤ç‰Œæ’¤é”€åŠŸèƒ½æ—¶ä½¿ç”¨

**ä¸€èˆ¬ä¸ç”¨çš„å£°æ˜**ï¼š
- audï¼ˆå—ä¼—ï¼‰ï¼šå•ä¸€æœåŠ¡ç¯å¢ƒä¸‹ä¸éœ€è¦
- nbfï¼ˆç”Ÿæ•ˆæ—¶é—´ï¼‰ï¼šå¤§å¤šæ•°åœºæ™¯ç«‹å³ç”Ÿæ•ˆå³å¯

---

## 3. ğŸ› ï¸ è‡ªå®šä¹‰å£°æ˜è®¾è®¡


### 3.1 ä»€ä¹ˆæ˜¯è‡ªå®šä¹‰å£°æ˜


**è‡ªå®šä¹‰å£°æ˜ï¼ˆPrivate Claimsï¼‰**æ˜¯æˆ‘ä»¬æ ¹æ®ä¸šåŠ¡éœ€è¦è‡ªå·±æ·»åŠ çš„ä¿¡æ¯ã€‚

**é€šä¿—ç†è§£**ï¼š
- æ ‡å‡†å£°æ˜å°±åƒèº«ä»½è¯çš„å›ºå®šå­—æ®µï¼ˆå§“åã€è¯ä»¶å·ï¼‰
- è‡ªå®šä¹‰å£°æ˜å°±åƒæˆ‘ä»¬åœ¨èº«ä»½è¯ä¸Šé¢å¤–æ·»åŠ çš„å¤‡æ³¨ä¿¡æ¯ï¼ˆèŒä¸šã€éƒ¨é—¨ï¼‰

**ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰å£°æ˜**ï¼š
- JWTä¸ä»…è¦æ ‡è¯†ç”¨æˆ·èº«ä»½ï¼Œè¿˜è¦æºå¸¦ä¸šåŠ¡ä¿¡æ¯
- é¿å…æ¯æ¬¡éƒ½å»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·çš„è§’è‰²ã€æƒé™ç­‰ä¿¡æ¯
- è®©æœåŠ¡èƒ½å¿«é€Ÿåšæƒé™åˆ¤æ–­

### 3.2 å¸¸è§è‡ªå®šä¹‰å£°æ˜è®¾è®¡


**ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ç±»**ï¼š
```
å£°æ˜åç§°         ç”¨é€”è¯´æ˜                    ç¤ºä¾‹å€¼
username      ç”¨æˆ·åï¼ˆæ˜¾ç¤ºç”¨ï¼‰              "zhangsan"
email         ç”¨æˆ·é‚®ç®±                     "user@example.com"
phone         æ‰‹æœºå·                       "13800138000"
nickname      æ˜µç§°                         "å¼ ä¸‰"
```

**æƒé™æ§åˆ¶ç±»**ï¼š
```
å£°æ˜åç§°         ç”¨é€”è¯´æ˜                    ç¤ºä¾‹å€¼
roles         ç”¨æˆ·è§’è‰²åˆ—è¡¨                  ["ADMIN", "USER"]
permissions   æƒé™åˆ—è¡¨                     ["user:read", "order:write"]
departmentId  éƒ¨é—¨ID                       "dept_001"
organizationId ç»„ç»‡ID                      "org_100"
```

**ä¸šåŠ¡çŠ¶æ€ç±»**ï¼š
```
å£°æ˜åç§°         ç”¨é€”è¯´æ˜                    ç¤ºä¾‹å€¼
accountStatus è´¦å·çŠ¶æ€                     "ACTIVE"
vipLevel      ä¼šå‘˜ç­‰çº§                     "VIP3"
loginType     ç™»å½•æ–¹å¼                     "PASSWORD"
```

### 3.3 è‡ªå®šä¹‰å£°æ˜å®æˆ˜ç¤ºä¾‹


**åœºæ™¯ï¼šç”µå•†ç³»ç»Ÿç”¨æˆ·ç™»å½•**

éœ€è¦åœ¨JWTä¸­åŒ…å«çš„ä¿¡æ¯ï¼š
- ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ï¼ˆIDã€ç”¨æˆ·åã€æ‰‹æœºå·ï¼‰
- æƒé™ä¿¡æ¯ï¼ˆè§’è‰²ã€æƒé™åˆ—è¡¨ï¼‰
- ä¸šåŠ¡ä¿¡æ¯ï¼ˆä¼šå‘˜ç­‰çº§ã€æ‰€å±éƒ¨é—¨ï¼‰

**åˆ›å»ºJWTçš„ä»£ç **ï¼š
```java
@Service
public class JwtService {
    
    public String generateToken(User user) {
        // æ„å»ºè‡ªå®šä¹‰å£°æ˜
        Map<String, Object> claims = new HashMap<>();
        
        // ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
        claims.put("userId", user.getId());
        claims.put("username", user.getUsername());
        claims.put("phone", user.getPhone());
        
        // æƒé™ä¿¡æ¯
        claims.put("roles", user.getRoles());              // ["ADMIN", "USER"]
        claims.put("permissions", user.getPermissions());   // ["user:*", "order:read"]
        
        // ä¸šåŠ¡ä¿¡æ¯
        claims.put("vipLevel", user.getVipLevel());        // "VIP3"
        claims.put("departmentId", user.getDepartmentId()); // "dept_001"
        
        // åˆ›å»ºJWT
        return Jwts.builder()
            .setClaims(claims)                    // è®¾ç½®è‡ªå®šä¹‰å£°æ˜
            .setSubject(user.getId().toString())  // è®¾ç½®æ ‡å‡†å£°æ˜
            .setIssuedAt(new Date())
            .setExpiration(new Date(System.currentTimeMillis() + 3600000))
            .signWith(secretKey, SignatureAlgorithm.HS256)
            .compact();
    }
}
```

**ç”Ÿæˆçš„JWTä¸­çš„Claims**ï¼š
```json
{
  // æ ‡å‡†å£°æ˜
  "sub": "12345",
  "iat": 1727132400,
  "exp": 1727136000,
  
  // è‡ªå®šä¹‰å£°æ˜
  "userId": 12345,
  "username": "zhangsan",
  "phone": "13800138000",
  "roles": ["ADMIN", "USER"],
  "permissions": ["user:*", "order:read"],
  "vipLevel": "VIP3",
  "departmentId": "dept_001"
}
```

**è§£æå’Œä½¿ç”¨Claims**ï¼š
```java
@Component
public class JwtAuthFilter extends OncePerRequestFilter {
    
    @Override
    protected void doFilterInternal(HttpServletRequest request, 
                                    HttpServletResponse response, 
                                    FilterChain chain) {
        String jwt = extractToken(request);
        
        Claims claims = Jwts.parserBuilder()
            .setSigningKey(secretKey)
            .build()
            .parseClaimsJws(jwt)
            .getBody();
        
        // è·å–ç”¨æˆ·ä¿¡æ¯
        String userId = claims.get("userId", String.class);
        String username = claims.get("username", String.class);
        
        // è·å–è§’è‰²æƒé™
        List<String> roles = claims.get("roles", List.class);
        List<String> permissions = claims.get("permissions", List.class);
        
        // æ„å»ºè®¤è¯å¯¹è±¡
        UserDetails userDetails = User.builder()
            .username(username)
            .authorities(roles.stream()
                .map(SimpleGrantedAuthority::new)
                .collect(Collectors.toList()))
            .build();
        
        // æ”¾å…¥å®‰å…¨ä¸Šä¸‹æ–‡
        SecurityContextHolder.getContext().setAuthentication(
            new UsernamePasswordAuthenticationToken(userDetails, null, 
                userDetails.getAuthorities())
        );
        
        chain.doFilter(request, response);
    }
}
```

### 3.4 è‡ªå®šä¹‰å£°æ˜è®¾è®¡åŸåˆ™


**åŸåˆ™1ï¼šç²¾ç®€åŸåˆ™ - åªæ”¾å¿…è¦ä¿¡æ¯**
```
âŒ ä¸å¥½çš„åšæ³•ï¼šä»€ä¹ˆéƒ½å¾€JWTé‡Œå¡
{
  "userId": 12345,
  "username": "zhangsan",
  "email": "user@example.com",
  "phone": "13800138000",
  "address": "åŒ—äº¬å¸‚æœé˜³åŒº...",      â† ä¸å¸¸ç”¨çš„ä¿¡æ¯
  "avatar": "https://...",          â† å¤§æ–‡æœ¬æ•°æ®
  "preferences": { /* å¤§å¯¹è±¡ */ },   â† å¤æ‚å¯¹è±¡
  "loginHistory": [ /* æ•°ç»„ */ ]    â† å†å²æ•°æ®
}

âœ… å¥½çš„åšæ³•ï¼šåªæ”¾å¿…éœ€çš„ä¿¡æ¯
{
  "userId": 12345,
  "username": "zhangsan",
  "roles": ["ADMIN"],
  "departmentId": "dept_001"
}
```

**åŸåˆ™2ï¼šå®‰å…¨åŸåˆ™ - ä¸æ”¾æ•æ„Ÿä¿¡æ¯**
```
âŒ ç»å¯¹ä¸èƒ½æ”¾çš„ä¿¡æ¯ï¼š
- å¯†ç ï¼ˆå³ä½¿æ˜¯åŠ å¯†çš„ï¼‰
- é“¶è¡Œå¡å·
- èº«ä»½è¯å·
- ç§é’¥

âš ï¸ è°¨æ…æ”¾ç½®çš„ä¿¡æ¯ï¼š
- æ‰‹æœºå·ï¼ˆå¦‚æœä¸æ˜¯å¿…éœ€ï¼Œä¸è¦æ”¾ï¼‰
- é‚®ç®±ï¼ˆåŒä¸Šï¼‰
- è¯¦ç»†åœ°å€
```

**åŸåˆ™3ï¼šä¸€è‡´æ€§åŸåˆ™ - å‘½åè§„èŒƒ**
```
âœ… æ¨èçš„å‘½åæ–¹å¼ï¼š
- é©¼å³°å‘½åï¼šuserIdã€userNameã€departmentId
- å…¨å°å†™+ä¸‹åˆ’çº¿ï¼šuser_idã€user_nameã€department_id
- é€‰æ‹©ä¸€ç§ï¼Œå…¨å±€ç»Ÿä¸€

âŒ ä¸æ¨èçš„å‘½åï¼š
- æ··ç”¨ï¼šuserIdã€user_nameï¼ˆä¸ä¸€è‡´ï¼‰
- è¿‡é•¿ï¼šuserDepartmentOrganizationId
- è¿‡çŸ­ï¼šuidã€unï¼ˆä¸æ¸…æ™°ï¼‰
```

---

## 4. â° æ ¸å¿ƒæ—¶é—´å£°æ˜


### 4.1 è¿‡æœŸæ—¶é—´ï¼ˆexpï¼‰æ·±å…¥ç†è§£


**expæ˜¯ä»€ä¹ˆ**ï¼š
- Expiration Timeçš„ç¼©å†™ï¼Œè¡¨ç¤ºJWTçš„**è¿‡æœŸæ—¶é—´**
- ç”¨**Unixæ—¶é—´æˆ³**è¡¨ç¤ºï¼ˆä»1970å¹´1æœˆ1æ—¥åˆ°ç°åœ¨çš„ç§’æ•°ï¼‰
- æ˜¯JWTå®‰å…¨æ€§çš„é‡è¦ä¿éšœ

**é€šä¿—ç†è§£**ï¼š
```
å°±åƒè¶…å¸‚çš„é£Ÿå“ä¿è´¨æœŸï¼š
- ç”Ÿäº§æ—¥æœŸï¼šiatï¼ˆç­¾å‘æ—¶é—´ï¼‰
- ä¿è´¨æœŸåˆ°ï¼šexpï¼ˆè¿‡æœŸæ—¶é—´ï¼‰
- è¿‡æœŸäº†å°±ä¸èƒ½ç”¨äº†

JWTä¹Ÿæ˜¯ä¸€æ ·ï¼š
- åˆ›å»ºæ—¶é—´ï¼šiat = 1727132400ï¼ˆ2024-09-23 18:00:00ï¼‰
- è¿‡æœŸæ—¶é—´ï¼šexp = 1727136000ï¼ˆ2024-09-23 20:00:00ï¼‰
- è¶…è¿‡è¿‡æœŸæ—¶é—´ï¼Œä»¤ç‰Œè‡ªåŠ¨å¤±æ•ˆ
```

### 4.2 expè¿‡æœŸæ—¶é—´çš„è®¾ç½®


**ä¸åŒåœºæ™¯çš„è¿‡æœŸæ—¶é—´è®¾ç½®**ï¼š

| åº”ç”¨åœºæ™¯ | æ¨èè¿‡æœŸæ—¶é—´ | åŸå› è¯´æ˜ |
|---------|------------|---------|
| **Webç½‘ç«™** | `2-24å°æ—¶` | `å¹³è¡¡å®‰å…¨æ€§å’Œç”¨æˆ·ä½“éªŒ` |
| **ç§»åŠ¨APP** | `7-30å¤©` | `å‡å°‘é¢‘ç¹ç™»å½•ï¼Œæå‡ä½“éªŒ` |
| **APIè°ƒç”¨** | `15åˆ†é’Ÿ-1å°æ—¶` | `é«˜å®‰å…¨è¦æ±‚ï¼ŒçŸ­æœŸæœ‰æ•ˆ` |
| **å†…éƒ¨ç³»ç»Ÿ** | `8-12å°æ—¶` | `å·¥ä½œæ—¶é—´å†…æœ‰æ•ˆ` |

**è®¾ç½®è¿‡æœŸæ—¶é—´çš„ä»£ç ç¤ºä¾‹**ï¼š
```java
// æ–¹å¼1ï¼šè®¾ç½®å›ºå®šæ—¶é•¿ï¼ˆæ¨èï¼‰
long expirationMillis = 2 * 60 * 60 * 1000; // 2å°æ—¶
Date expiration = new Date(System.currentTimeMillis() + expirationMillis);

String jwt = Jwts.builder()
    .setExpiration(expiration)  // è®¾ç½®è¿‡æœŸæ—¶é—´
    .signWith(secretKey)
    .compact();

// æ–¹å¼2ï¼šä½¿ç”¨é…ç½®æ–‡ä»¶
@Value("${jwt.expiration:7200000}") // é»˜è®¤2å°æ—¶
private long jwtExpiration;

Date expiration = new Date(System.currentTimeMillis() + jwtExpiration);
```

**éªŒè¯è¿‡æœŸæ—¶é—´**ï¼š
```java
try {
    Claims claims = Jwts.parserBuilder()
        .setSigningKey(secretKey)
        .build()
        .parseClaimsJws(jwt)  // è‡ªåŠ¨æ£€æŸ¥exp
        .getBody();
    
    // å¦‚æœæ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜ä»¤ç‰Œæœªè¿‡æœŸ
    
} catch (ExpiredJwtException e) {
    // ä»¤ç‰Œå·²è¿‡æœŸ
    throw new UnauthorizedException("ä»¤ç‰Œå·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•");
}
```

### 4.3 ç­¾å‘æ—¶é—´ï¼ˆiatï¼‰çš„ä½œç”¨


**iatæ˜¯ä»€ä¹ˆ**ï¼š
- Issued Atçš„ç¼©å†™ï¼Œè¡¨ç¤ºJWTçš„**ç­¾å‘æ—¶é—´**
- è®°å½•ä»¤ç‰Œæ˜¯ä»€ä¹ˆæ—¶å€™è¢«åˆ›å»ºçš„
- ç”¨äºè®¡ç®—ä»¤ç‰Œå¹´é¾„ã€æ£€æµ‹å¼‚å¸¸ç­‰

**iatçš„å®é™…ç”¨é€”**ï¼š

**ç”¨é€”1ï¼šè®¡ç®—ä»¤ç‰Œå¹´é¾„**
```java
Claims claims = parseJwt(jwt);
Date issuedAt = claims.getIssuedAt();
long tokenAge = System.currentTimeMillis() - issuedAt.getTime();

if (tokenAge > 24 * 60 * 60 * 1000) {
    // ä»¤ç‰Œè¶…è¿‡24å°æ—¶ï¼Œå»ºè®®åˆ·æ–°
    return "TOKEN_TOO_OLD";
}
```

**ç”¨é€”2ï¼šæ£€æµ‹æ—¶é’Ÿå¼‚å¸¸**
```java
Date issuedAt = claims.getIssuedAt();
if (issuedAt.after(new Date())) {
    // ç­¾å‘æ—¶é—´åœ¨æœªæ¥ï¼Ÿæ—¶é’Ÿä¸åŒæ­¥æˆ–ä»¤ç‰Œè¢«ç¯¡æ”¹
    throw new JwtException("ä»¤ç‰Œç­¾å‘æ—¶é—´å¼‚å¸¸");
}
```

**ç”¨é€”3ï¼šé…åˆå¯†é’¥è½®æ¢**
```java
// è®°å½•å¯†é’¥æ›´æ¢æ—¶é—´
private static final long KEY_ROTATION_TIME = 1727136000000L;

Claims claims = parseJwt(jwt);
if (claims.getIssuedAt().getTime() < KEY_ROTATION_TIME) {
    // è¿™æ˜¯ç”¨æ—§å¯†é’¥ç­¾å‘çš„ä»¤ç‰Œï¼Œè¦æ±‚é‡æ–°ç™»å½•
    throw new JwtException("è¯·é‡æ–°ç™»å½•");
}
```

### 4.4 æ—¶é—´å£°æ˜çš„æœ€ä½³å®è·µ


**å®è·µ1ï¼šè¿‡æœŸæ—¶é—´è¦åˆç†**
```
è¿‡æœŸæ—¶é—´å¤ªçŸ­çš„é—®é¢˜ï¼š
- ç”¨æˆ·é¢‘ç¹éœ€è¦é‡æ–°ç™»å½•
- å½±å“ç”¨æˆ·ä½“éªŒ
- å¢åŠ æœåŠ¡å™¨è´Ÿæ‹…

è¿‡æœŸæ—¶é—´å¤ªé•¿çš„é—®é¢˜ï¼š
- ä»¤ç‰Œè¢«ç›—åï¼Œæ”»å‡»çª—å£æœŸé•¿
- ç”¨æˆ·æƒé™å˜æ›´åï¼Œæ—§ä»¤ç‰Œä»ç„¶æœ‰æ•ˆ
- å®‰å…¨é£é™©å¢åŠ 

å¹³è¡¡æ–¹æ¡ˆï¼š
- Access Tokenï¼ˆè®¿é—®ä»¤ç‰Œï¼‰ï¼š15åˆ†é’Ÿ-2å°æ—¶ï¼ˆçŸ­æœŸï¼‰
- Refresh Tokenï¼ˆåˆ·æ–°ä»¤ç‰Œï¼‰ï¼š7-30å¤©ï¼ˆé•¿æœŸï¼‰
- ç”¨Refresh Tokenæ¢å–æ–°çš„Access Token
```

**å®è·µ2ï¼šä½¿ç”¨åˆ·æ–°ä»¤ç‰Œæœºåˆ¶**
```
å·¥ä½œæµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¢æˆ·ç«¯   â”‚                    â”‚  æœåŠ¡å™¨   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                â”‚
     â”‚ 1.ç™»å½•è¯·æ±‚                      â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                                â”‚
     â”‚ 2.è¿”å›Access Token(2å°æ—¶)      â”‚
     â”‚   å’ŒRefresh Token(30å¤©)        â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                                â”‚
     â”‚ 3.ä½¿ç”¨Access Tokenè®¿é—®         â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                                â”‚
     â”‚ 4.Access Tokenè¿‡æœŸ             â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€X (401)               â”‚
     â”‚                                â”‚
     â”‚ 5.ç”¨Refresh Tokenæ¢æ–°Token     â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                                â”‚
     â”‚ 6.è¿”å›æ–°çš„Access Token         â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
```

**åˆ·æ–°ä»¤ç‰Œä»£ç ç¤ºä¾‹**ï¼š
```java
@RestController
public class TokenController {
    
    // ç™»å½•æ—¶è¿”å›ä¸¤ä¸ªä»¤ç‰Œ
    @PostMapping("/login")
    public TokenResponse login(@RequestBody LoginRequest request) {
        // éªŒè¯ç”¨æˆ·åå¯†ç ...
        
        // ç”ŸæˆAccess Tokenï¼ˆ2å°æ—¶ï¼‰
        String accessToken = Jwts.builder()
            .setSubject(userId)
            .setExpiration(new Date(System.currentTimeMillis() + 7200000))
            .signWith(secretKey)
            .compact();
        
        // ç”ŸæˆRefresh Tokenï¼ˆ30å¤©ï¼‰
        String refreshToken = Jwts.builder()
            .setSubject(userId)
            .setExpiration(new Date(System.currentTimeMillis() + 2592000000L))
            .signWith(refreshSecretKey)
            .compact();
        
        return new TokenResponse(accessToken, refreshToken);
    }
    
    // åˆ·æ–°ä»¤ç‰Œæ¥å£
    @PostMapping("/refresh")
    public TokenResponse refresh(@RequestBody String refreshToken) {
        try {
            // éªŒè¯Refresh Token
            Claims claims = Jwts.parserBuilder()
                .setSigningKey(refreshSecretKey)
                .build()
                .parseClaimsJws(refreshToken)
                .getBody();
            
            String userId = claims.getSubject();
            
            // ç”Ÿæˆæ–°çš„Access Token
            String newAccessToken = Jwts.builder()
                .setSubject(userId)
                .setExpiration(new Date(System.currentTimeMillis() + 7200000))
                .signWith(secretKey)
                .compact();
            
            return new TokenResponse(newAccessToken, refreshToken);
            
        } catch (JwtException e) {
            throw new UnauthorizedException("Refresh Tokenæ— æ•ˆæˆ–å·²è¿‡æœŸ");
        }
    }
}
```

---

## 5. ğŸ¯ ä½œç”¨åŸŸScopeå£°æ˜


### 5.1 ä»€ä¹ˆæ˜¯Scopeä½œç”¨åŸŸ


**Scopeçš„æ¦‚å¿µ**ï¼š
- Scopeè¡¨ç¤ºJWTä»¤ç‰Œçš„**ä½¿ç”¨èŒƒå›´å’Œæƒé™è¾¹ç•Œ**
- å‘Šè¯‰ç³»ç»Ÿ"è¿™ä¸ªä»¤ç‰Œå¯ä»¥è®¿é—®å“ªäº›èµ„æºã€æ‰§è¡Œå“ªäº›æ“ä½œ"
- æ˜¯OAuth2.0ä¸­çš„æ ¸å¿ƒæ¦‚å¿µï¼Œåœ¨JWTä¸­ä¹Ÿå¹¿æ³›ä½¿ç”¨

**é€šä¿—ç†è§£**ï¼š
```
å°±åƒé—¨ç¦å¡çš„æƒé™ï¼š
- å‘˜å·¥å¡ï¼šå¯ä»¥è¿›åŠå…¬åŒºï¼Œä¸èƒ½è¿›æœºæˆ¿
- è®¿å®¢å¡ï¼šåªèƒ½è¿›å¤§å…ï¼Œä¸èƒ½è¿›åŠå…¬åŒº
- ç®¡ç†å‘˜å¡ï¼šå“ªé‡Œéƒ½èƒ½è¿›

JWTçš„Scopeä¹Ÿæ˜¯è¿™æ ·ï¼š
- readï¼šåªèƒ½è¯»å–æ•°æ®
- writeï¼šå¯ä»¥ä¿®æ”¹æ•°æ®
- adminï¼šæ‹¥æœ‰æ‰€æœ‰æƒé™
```

### 5.2 Scopeçš„è®¾è®¡æ–¹å¼


**æ–¹å¼1ï¼šç²—ç²’åº¦Scopeï¼ˆæ¨èå…¥é—¨ï¼‰**
```
ç®€å•ç›´è§‚çš„æƒé™åˆ’åˆ†ï¼š
- read      â† åªè¯»æƒé™
- write     â† è¯»å†™æƒé™
- admin     â† ç®¡ç†å‘˜æƒé™
- all       â† æ‰€æœ‰æƒé™

JWTä¸­çš„ä½“ç°ï¼š
{
  "sub": "user123",
  "scope": "read write",      â† ç©ºæ ¼åˆ†éš”
  "exp": 1727136000
}
```

**æ–¹å¼2ï¼šç»†ç²’åº¦Scopeï¼ˆæ¨èç”Ÿäº§ï¼‰**
```
æŒ‰èµ„æºå’Œæ“ä½œåˆ’åˆ†ï¼š
- user:read         â† è¯»å–ç”¨æˆ·ä¿¡æ¯
- user:write        â† ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯
- order:read        â† è¯»å–è®¢å•
- order:write       â† ä¿®æ”¹è®¢å•
- product:*         â† äº§å“çš„æ‰€æœ‰æƒé™

JWTä¸­çš„ä½“ç°ï¼š
{
  "sub": "user123",
  "scope": "user:read user:write order:read",
  "exp": 1727136000
}
```

**æ–¹å¼3ï¼šå±‚çº§åŒ–Scopeï¼ˆä¼ä¸šçº§ï¼‰**
```
å¤šå±‚çº§çš„æƒé™ä½“ç³»ï¼š
- system.user.read        â† ç³»ç»Ÿ-ç”¨æˆ·-è¯»
- system.user.write       â† ç³»ç»Ÿ-ç”¨æˆ·-å†™
- business.order.approve  â† ä¸šåŠ¡-è®¢å•-å®¡æ‰¹
- business.finance.audit  â† ä¸šåŠ¡-è´¢åŠ¡-å®¡è®¡

JWTä¸­çš„ä½“ç°ï¼š
{
  "sub": "user123",
  "scope": "system.user.* business.order.approve",
  "exp": 1727136000
}
```

### 5.3 Scopeåœ¨ä»£ç ä¸­çš„ä½¿ç”¨


**ç”ŸæˆåŒ…å«Scopeçš„JWT**ï¼š
```java
@Service
public class JwtService {
    
    public String generateToken(User user) {
        // æ ¹æ®ç”¨æˆ·è§’è‰²ç¡®å®šScope
        String scope = determineScope(user.getRoles());
        
        return Jwts.builder()
            .setSubject(user.getId().toString())
            .claim("scope", scope)           // æ·»åŠ scopeå£°æ˜
            .claim("username", user.getUsername())
            .setIssuedAt(new Date())
            .setExpiration(new Date(System.currentTimeMillis() + 7200000))
            .signWith(secretKey)
            .compact();
    }
    
    private String determineScope(List<String> roles) {
        // æ ¹æ®è§’è‰²æ˜ å°„scope
        if (roles.contains("ADMIN")) {
            return "user:* order:* product:*";  // ç®¡ç†å‘˜å…¨æƒé™
        } else if (roles.contains("MANAGER")) {
            return "user:read order:* product:read";  // ç»ç†éƒ¨åˆ†æƒé™
        } else {
            return "user:read order:read";  // æ™®é€šç”¨æˆ·åªè¯»
        }
    }
}
```

**éªŒè¯Scopeæƒé™**ï¼š
```java
@Component
public class ScopeValidator {
    
    public boolean hasScope(String jwt, String requiredScope) {
        Claims claims = Jwts.parserBuilder()
            .setSigningKey(secretKey)
            .build()
            .parseClaimsJws(jwt)
            .getBody();
        
        String scope = claims.get("scope", String.class);
        
        // æ£€æŸ¥æ˜¯å¦åŒ…å«æ‰€éœ€æƒé™
        return Arrays.asList(scope.split(" ")).contains(requiredScope);
    }
    
    public boolean hasAnyScope(String jwt, String... requiredScopes) {
        Claims claims = parseJwt(jwt);
        String scope = claims.get("scope", String.class);
        List<String> scopes = Arrays.asList(scope.split(" "));
        
        // æ£€æŸ¥æ˜¯å¦åŒ…å«ä»»æ„ä¸€ä¸ªæƒé™
        return Arrays.stream(requiredScopes)
            .anyMatch(scopes::contains);
    }
}
```

**åœ¨æ¥å£ä¸­ä½¿ç”¨Scopeæ§åˆ¶**ï¼š
```java
@RestController
@RequestMapping("/api/orders")
public class OrderController {
    
    @Autowired
    private ScopeValidator scopeValidator;
    
    @GetMapping("/{id}")
    public Order getOrder(@PathVariable Long id, 
                          @RequestHeader("Authorization") String token) {
        String jwt = token.replace("Bearer ", "");
        
        // æ£€æŸ¥æ˜¯å¦æœ‰è¯»å–è®¢å•çš„æƒé™
        if (!scopeValidator.hasScope(jwt, "order:read")) {
            throw new ForbiddenException("æ— æƒé™æŸ¥çœ‹è®¢å•");
        }
        
        return orderService.getById(id);
    }
    
    @PostMapping
    public Order createOrder(@RequestBody Order order,
                            @RequestHeader("Authorization") String token) {
        String jwt = token.replace("Bearer ", "");
        
        // æ£€æŸ¥æ˜¯å¦æœ‰åˆ›å»ºè®¢å•çš„æƒé™
        if (!scopeValidator.hasScope(jwt, "order:write")) {
            throw new ForbiddenException("æ— æƒé™åˆ›å»ºè®¢å•");
        }
        
        return orderService.create(order);
    }
}
```

### 5.4 Scopeä¸Rolesçš„åŒºåˆ«


**æ¦‚å¿µå¯¹æ¯”**ï¼š
```
Rolesï¼ˆè§’è‰²ï¼‰ï¼š
- å«ä¹‰ï¼šç”¨æˆ·æ˜¯ä»€ä¹ˆèº«ä»½
- ç¤ºä¾‹ï¼šADMINã€MANAGERã€USER
- ç‰¹ç‚¹ï¼šç²—ç²’åº¦ï¼Œä¸€ä¸ªäººå¯èƒ½æœ‰å¤šä¸ªè§’è‰²

Scopeï¼ˆä½œç”¨åŸŸï¼‰ï¼š
- å«ä¹‰ï¼šä»¤ç‰Œèƒ½åšä»€ä¹ˆæ“ä½œ
- ç¤ºä¾‹ï¼šuser:readã€order:write
- ç‰¹ç‚¹ï¼šç»†ç²’åº¦ï¼Œç²¾ç¡®åˆ°å…·ä½“æƒé™

å®é™…åº”ç”¨ï¼š
- Rolesï¼šç”¨äºç”¨æˆ·ç®¡ç†å’Œåˆ†ç»„
- Scopeï¼šç”¨äºAPIæƒé™æ§åˆ¶
```

**ä¸¤è€…ç»“åˆä½¿ç”¨**ï¼š
```java
{
  "sub": "user123",
  "username": "zhangsan",
  "roles": ["MANAGER"],              â† è§’è‰²ï¼šæˆ‘æ˜¯ç»ç†
  "scope": "user:read order:*",      â† æƒé™ï¼šæˆ‘èƒ½åšä»€ä¹ˆ
  "exp": 1727136000
}

éªŒè¯æ—¶çš„é€»è¾‘ï¼š
1. å…ˆæ£€æŸ¥rolesï¼šç¡®è®¤ç”¨æˆ·èº«ä»½
2. å†æ£€æŸ¥scopeï¼šç¡®è®¤å…·ä½“æƒé™
3. ä¸¤è€…éƒ½æ»¡è¶³æ‰å…è®¸æ“ä½œ
```

---

## 6. ğŸ”’ å®‰å…¨æœ€ä½³å®è·µ


### 6.1 Claimsè®¾è®¡çš„å®‰å…¨åŸåˆ™


**åŸåˆ™1ï¼šæœ€å°åŒ–åŸåˆ™**
```
åªæ”¾å¿…è¦çš„ä¿¡æ¯ï¼Œè¶Šå°‘è¶Šå®‰å…¨ï¼š

âŒ ä¸å®‰å…¨çš„åšæ³•ï¼š
{
  "userId": 12345,
  "username": "zhangsan",
  "password": "encrypted...",      â† ç»ä¸èƒ½æ”¾å¯†ç ï¼
  "bankCard": "6222...",           â† æ•æ„Ÿä¿¡æ¯
  "idCard": "110101...",           â† èº«ä»½è¯å·
  "secretKey": "abc123",           â† å¯†é’¥
  "å…¨éƒ¨ç”¨æˆ·æ•°æ®": { ... }            â† è¿‡å¤šä¿¡æ¯
}

âœ… å®‰å…¨çš„åšæ³•ï¼š
{
  "userId": 12345,
  "username": "zhangsan",
  "roles": ["USER"],
  "scope": "user:read",
  "exp": 1727136000
}
```

**åŸåˆ™2ï¼šä¸æ”¾æ•æ„Ÿæ•°æ®**
```
ç»å¯¹ä¸èƒ½æ”¾å…¥JWTçš„ä¿¡æ¯ï¼š
ğŸš« å¯†ç ï¼ˆå³ä½¿åŠ å¯†ä¹Ÿä¸è¡Œï¼‰
ğŸš« æ”¯ä»˜å¯†é’¥
ğŸš« ç§é’¥è¯ä¹¦
ğŸš« é“¶è¡Œå¡å·
ğŸš« èº«ä»½è¯å·
ğŸš« è¯¦ç»†åœ°å€

å¯ä»¥è°¨æ…æ”¾ç½®çš„ä¿¡æ¯ï¼š
âš ï¸ ç”¨æˆ·IDï¼ˆå¿…éœ€ï¼‰
âš ï¸ ç”¨æˆ·åï¼ˆæ˜¾ç¤ºç”¨ï¼‰
âš ï¸ è§’è‰²æƒé™ï¼ˆåŠŸèƒ½éœ€è¦ï¼‰
âš ï¸ æ‰‹æœºå·ï¼ˆå¦‚æœä¸šåŠ¡éœ€è¦ï¼‰
```

**åŸåˆ™3ï¼šè®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´**
```
è¿‡æœŸæ—¶é—´è®¾ç½®æŒ‡å—ï¼š
- å…¬ç½‘APIï¼š15-30åˆ†é’Ÿ
- å†…éƒ¨ç³»ç»Ÿï¼š2-8å°æ—¶
- ç§»åŠ¨APPï¼š7-30å¤©ï¼ˆé…åˆåˆ·æ–°ä»¤ç‰Œï¼‰

ç¤ºä¾‹é…ç½®ï¼š
@Configuration
public class JwtConfig {
    // Access Tokenï¼šçŸ­æœŸæœ‰æ•ˆ
    @Value("${jwt.access-token.expiration:900000}")  // 15åˆ†é’Ÿ
    private long accessTokenExpiration;
    
    // Refresh Tokenï¼šé•¿æœŸæœ‰æ•ˆ
    @Value("${jwt.refresh-token.expiration:2592000000}")  // 30å¤©
    private long refreshTokenExpiration;
}
```

### 6.2 é˜²æ­¢JWTè¢«æ»¥ç”¨


**æªæ–½1ï¼šä½¿ç”¨JTIé˜²æ­¢é‡æ”¾æ”»å‡»**
```java
@Service
public class JwtService {
    
    @Autowired
    private RedisTemplate<String, String> redis;
    
    // ç”ŸæˆJWTæ—¶æ·»åŠ å”¯ä¸€ID
    public String generateToken(User user) {
        String jti = UUID.randomUUID().toString();
        
        String jwt = Jwts.builder()
            .setId(jti)  // è®¾ç½®å”¯ä¸€ID
            .setSubject(user.getId().toString())
            .setExpiration(new Date(System.currentTimeMillis() + 7200000))
            .signWith(secretKey)
            .compact();
        
        // å°†JTIå­˜å…¥Redisï¼Œè®¾ç½®ä¸JWTç›¸åŒçš„è¿‡æœŸæ—¶é—´
        redis.opsForValue().set("jwt:jti:" + jti, "valid", 2, TimeUnit.HOURS);
        
        return jwt;
    }
    
    // éªŒè¯JWTæ—¶æ£€æŸ¥JTI
    public boolean validateToken(String jwt) {
        Claims claims = parseJwt(jwt);
        String jti = claims.getId();
        
        // æ£€æŸ¥JTIæ˜¯å¦å­˜åœ¨ä¸”æœ‰æ•ˆ
        String status = redis.opsForValue().get("jwt:jti:" + jti);
        if (status == null) {
            throw new JwtException("ä»¤ç‰Œæ— æ•ˆæˆ–å·²è¢«æ’¤é”€");
        }
        
        return true;
    }
    
    // ä¸»åŠ¨æ’¤é”€ä»¤ç‰Œ
    public void revokeToken(String jwt) {
        Claims claims = parseJwt(jwt);
        String jti = claims.getId();
        
        // ä»Redisåˆ é™¤JTIï¼Œä»¤ç‰Œç«‹å³å¤±æ•ˆ
        redis.delete("jwt:jti:" + jti);
    }
}
```

**æªæ–½2ï¼šé™åˆ¶ä»¤ç‰Œä½¿ç”¨èŒƒå›´ï¼ˆaudï¼‰**
```java
// ä¸ºä¸åŒæœåŠ¡ç”Ÿæˆä¸åŒçš„ä»¤ç‰Œ
public String generateTokenForService(User user, String serviceName) {
    return Jwts.builder()
        .setSubject(user.getId().toString())
        .setAudience(serviceName)  // æŒ‡å®šå—ä¼—
        .setExpiration(new Date(System.currentTimeMillis() + 3600000))
        .signWith(secretKey)
        .compact();
}

// éªŒè¯æ—¶æ£€æŸ¥å—ä¼—
public void validateAudience(String jwt, String expectedAudience) {
    Claims claims = parseJwt(jwt);
    String audience = claims.getAudience();
    
    if (!expectedAudience.equals(audience)) {
        throw new JwtException("ä»¤ç‰Œä¸é€‚ç”¨äºå½“å‰æœåŠ¡");
    }
}

// åœ¨è¿‡æ»¤å™¨ä¸­ä½¿ç”¨
@Override
protected void doFilterInternal(HttpServletRequest request, ...) {
    String jwt = extractToken(request);
    
    // æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦æ˜¯ç»™å½“å‰æœåŠ¡ç”¨çš„
    validateAudience(jwt, "order-service");
    
    // ç»§ç»­å¤„ç†...
}
```

### 6.3 Claimså¤§å°æ§åˆ¶


**ä¸ºä»€ä¹ˆè¦æ§åˆ¶Claimså¤§å°**ï¼š
```
JWTçš„ä¼ è¾“ç‰¹ç‚¹ï¼š
- æ¯æ¬¡è¯·æ±‚éƒ½è¦æºå¸¦JWT
- JWTæ”¾åœ¨HTTP Headerä¸­
- å¤ªå¤§çš„JWTä¼šå½±å“æ€§èƒ½

é—®é¢˜ç¤ºä¾‹ï¼š
1KBçš„JWT Ã— 1000æ¬¡è¯·æ±‚ = 1MBç½‘ç»œä¼ è¾“
10KBçš„JWT Ã— 1000æ¬¡è¯·æ±‚ = 10MBç½‘ç»œä¼ è¾“

å»ºè®®å¤§å°ï¼š
âœ… ç†æƒ³å¤§å°ï¼š< 1KB
âš ï¸ å¯æ¥å—ï¼š1-2KB
âŒ è¿‡å¤§ï¼š> 5KB
```

**æ§åˆ¶Claimså¤§å°çš„æ–¹æ³•**ï¼š
```java
// âŒ ä¸å¥½çš„åšæ³•ï¼šä»€ä¹ˆéƒ½æ”¾
{
  "userId": 12345,
  "username": "zhangsan",
  "email": "user@example.com",
  "phone": "13800138000",
  "address": "åŒ—äº¬å¸‚æœé˜³åŒº...",
  "avatar": "https://cdn.example.com/avatar/12345.jpg",
  "roles": ["ADMIN", "USER", "MANAGER"],
  "permissions": ["user:read", "user:write", "order:*", ...],  // 30ä¸ªæƒé™
  "departmentName": "æŠ€æœ¯ç ”å‘éƒ¨",
  "organizationName": "XXç§‘æŠ€æœ‰é™å…¬å¸",
  ...  // æ€»å…±5KB
}

// âœ… å¥½çš„åšæ³•ï¼šåªæ”¾æ ¸å¿ƒä¿¡æ¯
{
  "userId": 12345,
  "username": "zhangsan",
  "roles": ["ADMIN"],
  "exp": 1727136000
}  // åªæœ‰200å­—èŠ‚

// å…¶ä»–ä¿¡æ¯éœ€è¦æ—¶å†æŸ¥è¯¢ï¼š
@GetMapping("/user/profile")
public UserProfile getProfile(@AuthenticationPrincipal User user) {
    // ä»JWTè·å–userId
    // ä»æ•°æ®åº“æˆ–ç¼“å­˜è·å–å®Œæ•´ä¿¡æ¯
    return userService.getFullProfile(user.getId());
}
```

**ä½¿ç”¨å¼•ç”¨è€Œéå®Œæ•´æ•°æ®**ï¼š
```java
// âŒ ä¸å¥½ï¼šæ”¾å®Œæ•´çš„æƒé™åˆ—è¡¨
{
  "permissions": [
    "user:read", "user:write", "user:delete",
    "order:read", "order:write", "order:delete",
    "product:read", "product:write", "product:delete",
    ...  // 50ä¸ªæƒé™
  ]
}

// âœ… å¥½ï¼šåªæ”¾è§’è‰²IDï¼Œæƒé™ä»ç¼“å­˜è·å–
{
  "roleIds": [1, 3, 5],  // è§’è‰²ID
  "exp": 1727136000
}

// ä½¿ç”¨æ—¶ï¼š
@Component
public class PermissionChecker {
    @Autowired
    private RedisTemplate redis;
    
    public boolean hasPermission(List<Integer> roleIds, String permission) {
        // ä»Redisè·å–è§’è‰²å¯¹åº”çš„å®Œæ•´æƒé™åˆ—è¡¨
        for (Integer roleId : roleIds) {
            Set<String> permissions = redis.opsForSet()
                .members("role:permissions:" + roleId);
            if (permissions.contains(permission)) {
                return true;
            }
        }
        return false;
    }
}
```

### 6.4 ClaimséªŒè¯æ¸…å•


**å®Œæ•´çš„JWTéªŒè¯æµç¨‹**ï¼š
```java
@Component
public class JwtValidator {
    
    public void fullValidate(String jwt, HttpServletRequest request) {
        try {
            Claims claims = Jwts.parserBuilder()
                .setSigningKey(secretKey)
                .build()
                .parseClaimsJws(jwt)
                .getBody();
            
            // 1. æ£€æŸ¥è¿‡æœŸæ—¶é—´ï¼ˆè‡ªåŠ¨å®Œæˆï¼‰
            // parseClaimsJwsä¼šè‡ªåŠ¨æ£€æŸ¥exp
            
            // 2. æ£€æŸ¥ç­¾å‘æ—¶é—´
            Date issuedAt = claims.getIssuedAt();
            if (issuedAt.after(new Date())) {
                throw new JwtException("ä»¤ç‰Œç­¾å‘æ—¶é—´å¼‚å¸¸");
            }
            
            // 3. æ£€æŸ¥ç­¾å‘è€…
            String issuer = claims.getIssuer();
            if (!"auth-service".equals(issuer)) {
                throw new JwtException("ä»¤ç‰Œç­¾å‘è€…ä¸æ­£ç¡®");
            }
            
            // 4. æ£€æŸ¥å—ä¼—
            String audience = claims.getAudience();
            if (!getCurrentServiceName().equals(audience)) {
                throw new JwtException("ä»¤ç‰Œä¸é€‚ç”¨äºå½“å‰æœåŠ¡");
            }
            
            // 5. æ£€æŸ¥JTIï¼ˆé˜²é‡æ”¾ï¼‰
            String jti = claims.getId();
            if (!isJtiValid(jti)) {
                throw new JwtException("ä»¤ç‰Œå·²è¢«æ’¤é”€");
            }
            
            // 6. æ£€æŸ¥IPï¼ˆå¯é€‰ï¼Œå¢å¼ºå®‰å…¨æ€§ï¼‰
            String tokenIp = claims.get("ip", String.class);
            String requestIp = getClientIp(request);
            if (!requestIp.equals(tokenIp)) {
                log.warn("ä»¤ç‰ŒIPä¸è¯·æ±‚IPä¸åŒ¹é…ï¼š{} vs {}", tokenIp, requestIp);
                // å¯ä»¥é€‰æ‹©æ‹’ç»æˆ–è®°å½•æ—¥å¿—
            }
            
            // 7. æ£€æŸ¥å¿…éœ€çš„Claims
            if (claims.getSubject() == null) {
                throw new JwtException("ç¼ºå°‘ç”¨æˆ·æ ‡è¯†");
            }
            
        } catch (ExpiredJwtException e) {
            throw new UnauthorizedException("ä»¤ç‰Œå·²è¿‡æœŸ");
        } catch (JwtException e) {
            throw new UnauthorizedException("ä»¤ç‰ŒéªŒè¯å¤±è´¥ï¼š" + e.getMessage());
        }
    }
}
```

**å®‰å…¨æ£€æŸ¥æ¸…å•**ï¼š
```
JWT Claimså®‰å…¨æ£€æŸ¥æ¸…å•ï¼š

ğŸ“‹ å¿…é¡»æ£€æŸ¥çš„é¡¹ç›®ï¼š
âœ… expè¿‡æœŸæ—¶é—´ï¼ˆé˜²æ­¢è¿‡æœŸä»¤ç‰Œï¼‰
âœ… ç­¾åéªŒè¯ï¼ˆé˜²æ­¢ç¯¡æ”¹ï¼‰
âœ… å¿…éœ€Claimså­˜åœ¨æ€§ï¼ˆå¦‚subï¼‰

ğŸ“‹ å»ºè®®æ£€æŸ¥çš„é¡¹ç›®ï¼š
ğŸ”¸ iatç­¾å‘æ—¶é—´ï¼ˆé˜²æ­¢æ—¶é’Ÿé—®é¢˜ï¼‰
ğŸ”¸ issç­¾å‘è€…ï¼ˆå¤šæœåŠ¡ç¯å¢ƒï¼‰
ğŸ”¸ audå—ä¼—ï¼ˆé™åˆ¶ä½¿ç”¨èŒƒå›´ï¼‰
ğŸ”¸ jtiå”¯ä¸€IDï¼ˆä»¤ç‰Œæ’¤é”€ï¼‰

ğŸ“‹ å¯é€‰æ£€æŸ¥çš„é¡¹ç›®ï¼š
âšª IPåœ°å€ï¼ˆå¢å¼ºå®‰å…¨ï¼‰
âšª è®¾å¤‡æŒ‡çº¹ï¼ˆé˜²è®¾å¤‡ç›—ç”¨ï¼‰
âšª åœ°ç†ä½ç½®ï¼ˆå¼‚å¸¸ç™»å½•æ£€æµ‹ï¼‰
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


**Claimsçš„æœ¬è´¨**ï¼š
```
ğŸ”¸ Claimså°±æ˜¯JWTä¸­æºå¸¦çš„ä¿¡æ¯
ğŸ”¸ åˆ†ä¸ºæ ‡å‡†å£°æ˜å’Œè‡ªå®šä¹‰å£°æ˜ä¸¤å¤§ç±»
ğŸ”¸ æ˜¯JWTå®ç°èº«ä»½è®¤è¯å’Œæƒé™æ§åˆ¶çš„åŸºç¡€
ğŸ”¸ ä½äºJWTçš„Payloadéƒ¨åˆ†ï¼Œä¼šè¢«Base64ç¼–ç 
```

**æ ‡å‡†å£°æ˜ï¼ˆ7ä¸ªæ ¸å¿ƒï¼‰**ï¼š
```
iss  â† ç­¾å‘è€…ï¼šè°é¢å‘çš„ä»¤ç‰Œ
sub  â† ä¸»é¢˜ï¼šä»¤ç‰Œæ˜¯å…³äºè°çš„ï¼ˆç”¨æˆ·IDï¼‰
aud  â† å—ä¼—ï¼šä»¤ç‰Œç»™è°ç”¨çš„
exp  â† è¿‡æœŸæ—¶é—´ï¼šä»€ä¹ˆæ—¶å€™å¤±æ•ˆï¼ˆå¿…é¡»è®¾ç½®ï¼‰
iat  â† ç­¾å‘æ—¶é—´ï¼šä»€ä¹ˆæ—¶å€™åˆ›å»ºçš„
nbf  â† ç”Ÿæ•ˆæ—¶é—´ï¼šä»ä»€ä¹ˆæ—¶å€™å¼€å§‹æœ‰æ•ˆ
jti  â† å”¯ä¸€IDï¼šä»¤ç‰Œçš„å”¯ä¸€æ ‡è¯†
```

**è‡ªå®šä¹‰å£°æ˜è®¾è®¡**ï¼š
```
ğŸ”¹ ç”¨æˆ·ä¿¡æ¯ï¼šuserIdã€usernameã€email
ğŸ”¹ æƒé™ä¿¡æ¯ï¼šrolesã€permissionsã€scope
ğŸ”¹ ä¸šåŠ¡ä¿¡æ¯ï¼šdepartmentIdã€vipLevel
ğŸ”¹ è®¾è®¡åŸåˆ™ï¼šç²¾ç®€ã€å®‰å…¨ã€ä¸€è‡´
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**è¿‡æœŸæ—¶é—´ï¼ˆexpï¼‰çš„é‡è¦æ€§**ï¼š
```
ä¸ºä»€ä¹ˆå¿…é¡»è®¾ç½®expï¼š
- é˜²æ­¢ä»¤ç‰Œæ°¸ä¹…æœ‰æ•ˆ
- é™åˆ¶è¢«ç›—ä»¤ç‰Œçš„å½±å“èŒƒå›´
- é…åˆåˆ·æ–°ä»¤ç‰Œå®ç°å®‰å…¨å¹³è¡¡

æ¨èè®¾ç½®ï¼š
- Access Tokenï¼š15åˆ†é’Ÿ-2å°æ—¶ï¼ˆçŸ­æœŸï¼‰
- Refresh Tokenï¼š7-30å¤©ï¼ˆé•¿æœŸï¼‰
- æ ¹æ®ä¸šåŠ¡å®‰å…¨è¦æ±‚è°ƒæ•´
```

**Scopeä½œç”¨åŸŸçš„åº”ç”¨**ï¼š
```
Scopeæ˜¯ä»€ä¹ˆï¼š
- å®šä¹‰ä»¤ç‰Œçš„ä½¿ç”¨èŒƒå›´å’Œæƒé™è¾¹ç•Œ
- ç²¾ç¡®æ§åˆ¶èƒ½è®¿é—®ä»€ä¹ˆèµ„æºã€æ‰§è¡Œä»€ä¹ˆæ“ä½œ
- OAuth2.0çš„æ ¸å¿ƒæ¦‚å¿µ

è®¾è®¡æ–¹å¼ï¼š
- ç²—ç²’åº¦ï¼šreadã€writeã€admin
- ç»†ç²’åº¦ï¼šuser:readã€order:write
- å±‚çº§åŒ–ï¼šsystem.user.read
```

**å®‰å…¨æœ€ä½³å®è·µ**ï¼š
```
å¿…é¡»éµå®ˆçš„åŸåˆ™ï¼š
âœ… ä¸æ”¾æ•æ„Ÿä¿¡æ¯ï¼ˆå¯†ç ã€å¯†é’¥ã€èº«ä»½è¯ï¼‰
âœ… æ§åˆ¶Claimså¤§å°ï¼ˆ< 1-2KBï¼‰
âœ… è®¾ç½®åˆç†è¿‡æœŸæ—¶é—´
âœ… ä½¿ç”¨JTIå®ç°ä»¤ç‰Œæ’¤é”€
âœ… å®Œæ•´çš„éªŒè¯æµç¨‹

å¸¸è§å®‰å…¨æªæ–½ï¼š
- JTI + Rediså®ç°ä»¤ç‰Œé»‘åå•
- audé™åˆ¶ä»¤ç‰Œä½¿ç”¨èŒƒå›´
- IPç»‘å®šå¢å¼ºå®‰å…¨æ€§
- åˆ·æ–°ä»¤ç‰Œæœºåˆ¶
```

### 7.3 å®é™…åº”ç”¨æŒ‡å—


**Claimsè®¾è®¡æµç¨‹**ï¼š
```
1. ç¡®å®šå¿…éœ€çš„æ ‡å‡†å£°æ˜ï¼š
   - expï¼ˆè¿‡æœŸæ—¶é—´ï¼‰ï¼šå¿…é¡»
   - iatï¼ˆç­¾å‘æ—¶é—´ï¼‰ï¼šæ¨è
   - subï¼ˆç”¨æˆ·æ ‡è¯†ï¼‰ï¼šå¿…é¡»

2. è®¾è®¡è‡ªå®šä¹‰å£°æ˜ï¼š
   - åˆ—å‡ºä¸šåŠ¡å¿…éœ€çš„ä¿¡æ¯
   - è¿‡æ»¤æ‰æ•æ„Ÿå’Œä¸å¸¸ç”¨çš„ä¿¡æ¯
   - ä¿æŒClaimsç²¾ç®€

3. è®¾ç½®å®‰å…¨æ§åˆ¶ï¼š
   - æ·»åŠ jtiå®ç°æ’¤é”€åŠŸèƒ½
   - æ·»åŠ scopeæ§åˆ¶æƒé™èŒƒå›´
   - è€ƒè™‘æ·»åŠ audé™åˆ¶ä½¿ç”¨èŒƒå›´

4. éªŒè¯å’Œä¼˜åŒ–ï¼š
   - æ£€æŸ¥JWTå¤§å°æ˜¯å¦åˆç†
   - éªŒè¯å®‰å…¨æªæ–½æ˜¯å¦åˆ°ä½
   - æµ‹è¯•æ€§èƒ½å½±å“
```

**å¼€å‘æ£€æŸ¥æ¸…å•**ï¼š
```
JWT Claimså¼€å‘è‡ªæŸ¥è¡¨ï¼š

â–¡ æ˜¯å¦è®¾ç½®äº†expè¿‡æœŸæ—¶é—´
â–¡ æ˜¯å¦è®¾ç½®äº†iatç­¾å‘æ—¶é—´
â–¡ æ˜¯å¦è®¾ç½®äº†subç”¨æˆ·æ ‡è¯†
â–¡ è‡ªå®šä¹‰Claimsæ˜¯å¦ç²¾ç®€
â–¡ æ˜¯å¦åŒ…å«æ•æ„Ÿä¿¡æ¯
â–¡ JWTå¤§å°æ˜¯å¦è¶…è¿‡2KB
â–¡ æ˜¯å¦å®ç°äº†ä»¤ç‰Œæ’¤é”€æœºåˆ¶
â–¡ æ˜¯å¦æœ‰å®Œæ•´çš„éªŒè¯æµç¨‹
â–¡ æ˜¯å¦è€ƒè™‘äº†åˆ·æ–°ä»¤ç‰Œæœºåˆ¶
â–¡ æ˜¯å¦è®°å½•äº†å®‰å…¨æ—¥å¿—
```

**å¸¸è§é—®é¢˜è§£å†³**ï¼š
```
é—®é¢˜1ï¼šJWTå¤ªå¤§æ€ä¹ˆåŠï¼Ÿ
- ç§»é™¤ä¸å¿…è¦çš„Claims
- ä½¿ç”¨IDå¼•ç”¨ä»£æ›¿å®Œæ•´æ•°æ®
- æƒé™ä¿¡æ¯æ”¾ç¼“å­˜ï¼ŒJWTåªæ”¾è§’è‰²ID

é—®é¢˜2ï¼šéœ€è¦ç«‹å³æ’¤é”€ä»¤ç‰Œæ€ä¹ˆåŠï¼Ÿ
- ä½¿ç”¨JTI + Rediså®ç°é»‘åå•
- æˆ–è€…ä½¿ç”¨JTI + Rediså®ç°ç™½åå•

é—®é¢˜3ï¼šç”¨æˆ·æƒé™å˜æ›´åï¼Œæ—§ä»¤ç‰Œä»æœ‰æ•ˆæ€ä¹ˆåŠï¼Ÿ
- ç¼©çŸ­ä»¤ç‰Œè¿‡æœŸæ—¶é—´
- é…åˆåˆ·æ–°ä»¤ç‰Œæœºåˆ¶
- æ•æ„Ÿæ“ä½œè¦æ±‚é‡æ–°è®¤è¯
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
Claimsä¿¡æ¯è¦ç²¾ç®€ï¼Œæ•æ„Ÿæ•°æ®ç»ä¸ä¼ 
expè¿‡æœŸå¿…é¡»è®¾ï¼Œiatç­¾å‘ä¹Ÿè¦å¡«
subæ ‡è¯†ç”¨æˆ·èº«ï¼Œscopeæƒé™æœ‰è¾¹é™
JTIé˜²æ­¢è¢«é‡æ”¾ï¼Œå®‰å…¨éªŒè¯è¦å‘¨å…¨
```