---
title: 4ã€è®¾å¤‡æµç¨‹å®ç°
---
## ğŸ“š ç›®å½•

1. [ä»€ä¹ˆæ˜¯è®¾å¤‡æµç¨‹](#1-ä»€ä¹ˆæ˜¯è®¾å¤‡æµç¨‹)
2. [ä¸ºä»€ä¹ˆéœ€è¦è®¾å¤‡æµç¨‹](#2-ä¸ºä»€ä¹ˆéœ€è¦è®¾å¤‡æµç¨‹)
3. [è®¾å¤‡æµç¨‹å·¥ä½œåŸç†](#3-è®¾å¤‡æµç¨‹å·¥ä½œåŸç†)
4. [è®¾å¤‡æµç¨‹å®Œæ•´å®ç°](#4-è®¾å¤‡æµç¨‹å®Œæ•´å®ç°)
5. [å®‰å…¨æ€§è€ƒè™‘](#5-å®‰å…¨æ€§è€ƒè™‘)
6. [æœ€ä½³å®è·µä¸ä¼˜åŒ–](#6-æœ€ä½³å®è·µä¸ä¼˜åŒ–)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ ä»€ä¹ˆæ˜¯è®¾å¤‡æµç¨‹


### 1.1 è®¾å¤‡æµç¨‹çš„æ¦‚å¿µ


**ğŸ“‹ é€šä¿—ç†è§£**
æƒ³è±¡ä¸€ä¸‹ä½ åœ¨æ™ºèƒ½ç”µè§†ä¸Šçœ‹Netflixï¼Œç”µè§†æ²¡æœ‰é”®ç›˜ï¼Œè¾“å…¥è´¦å·å¯†ç å¾ˆéº»çƒ¦ã€‚è¿™æ—¶å€™ç”µè§†ä¼šæ˜¾ç¤ºä¸€ä¸ªéªŒè¯ç ï¼Œè®©ä½ ç”¨æ‰‹æœºè®¿é—®ä¸€ä¸ªç½‘å€è¾“å…¥è¿™ä¸ªç å°±èƒ½ç™»å½•ã€‚è¿™å°±æ˜¯è®¾å¤‡æµç¨‹ï¼

**æ ¸å¿ƒå®šä¹‰**
```
è®¾å¤‡æµç¨‹(Device Authorization Grant Flow)ï¼š
ä¸“é—¨ä¸ºè¾“å…¥å—é™è®¾å¤‡è®¾è®¡çš„OAuth2.0æˆæƒæ–¹å¼

é€‚ç”¨è®¾å¤‡ï¼š
â€¢ æ™ºèƒ½ç”µè§† â†’ æ²¡æœ‰é”®ç›˜ï¼Œè¾“å…¥å›°éš¾
â€¢ æ¸¸æˆæœº   â†’ æ‰‹æŸ„è¾“å…¥è´¦å·å¯†ç å¤ªæ…¢
â€¢ ç‰©è”ç½‘è®¾å¤‡ â†’ å¯èƒ½æ ¹æœ¬æ²¡æœ‰å±å¹•
â€¢ æ‰“å°æœº   â†’ åªæœ‰ç®€å•æŒ‰é’®
```

### 1.2 è®¾å¤‡æµç¨‹ vs ä¼ ç»Ÿæµç¨‹


**ğŸ†š å¯¹æ¯”ç†è§£**
```
ä¼ ç»Ÿæˆæƒç æµç¨‹ï¼š
ç”¨æˆ·è®¾å¤‡ â†’ æµè§ˆå™¨è·³è½¬ â†’ ç™»å½• â†’ æˆæƒ â†’ å›è°ƒ
å‰æï¼šè®¾å¤‡æœ‰å®Œæ•´æµè§ˆå™¨å’Œè¾“å…¥èƒ½åŠ›

è®¾å¤‡æµç¨‹ï¼š
å—é™è®¾å¤‡ â†’ æ˜¾ç¤ºè®¾å¤‡ç  â†’ ç”¨æˆ·ç”¨å…¶ä»–è®¾å¤‡è¾“å…¥ç  â†’ æˆæƒ
å‰æï¼šç”¨æˆ·æœ‰å¦ä¸€å°å¯ä¸Šç½‘çš„è®¾å¤‡(æ‰‹æœº/ç”µè„‘)
```

**å®é™…åœºæ™¯å¯¹æ¯”**
| åœºæ™¯ | ä¼ ç»Ÿæµç¨‹ | è®¾å¤‡æµç¨‹ |
|------|---------|---------|
| **ç”µè„‘ç½‘ç«™ç™»å½•** | âœ… ç›´æ¥è¾“å…¥è´¦å·å¯†ç  | âŒ ä¸éœ€è¦ |
| **æ™ºèƒ½ç”µè§†ç™»å½•** | âŒ æ‰‹æŸ„è¾“å…¥å¤ªæ…¢ | âœ… æ‰‹æœºæ‰«ç è¾“å…¥ |
| **APPç™»å½•** | âœ… é”®ç›˜è¾“å…¥æ–¹ä¾¿ | âŒ ä¸éœ€è¦ |
| **ç‰©è”ç½‘è®¾å¤‡** | âŒ æ²¡æœ‰å±å¹•é”®ç›˜ | âœ… é…å¥—APPæˆæƒ |

---

## 2. ğŸ¤” ä¸ºä»€ä¹ˆéœ€è¦è®¾å¤‡æµç¨‹


### 2.1 è¾“å…¥å—é™é—®é¢˜


**ğŸ® æ¸¸æˆæœºç™»å½•çš„å›°å¢ƒ**
```
é—®é¢˜åœºæ™¯ï¼šåœ¨Xboxä¸Šç™»å½•Netflix

ä¼ ç»Ÿæ–¹å¼çš„ç—›è‹¦ï¼š
1. ç”¨æ‰‹æŸ„ç§»åŠ¨è™šæ‹Ÿé”®ç›˜ â† å¤ªæ…¢äº†
2. è¾“å…¥é‚®ç®±ï¼šuser@example.com â† æ¥å›é€‰å­—æ¯
3. è¾“å…¥å¯†ç ï¼šMyP@ssw0rd! â† ç¬¦å·æ›´éš¾æ‰¾
4. è¾“å…¥éªŒè¯ç  â† å´©æºƒäº†

ç”¨æˆ·ä½“éªŒï¼šğŸ˜«ğŸ˜«ğŸ˜« â†’ å¤ªæŠ˜ç£¨äº†ï¼
```

**ğŸ’¡ è®¾å¤‡æµç¨‹çš„è§£å†³**
```
ä¼˜é›…çš„è§£å†³æ–¹æ¡ˆï¼š

æ­¥éª¤1ï¸âƒ£ ç”µè§†æ˜¾ç¤ºï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¯·è®¿é—®ï¼štv.netflix.com  â”‚
â”‚  è¾“å…¥ä»£ç ï¼šABCD-EFGH      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ­¥éª¤2ï¸âƒ£ ç”¨æˆ·ç”¨æ‰‹æœºè®¿é—®ç½‘å€ï¼Œè¾“å…¥8ä½ç 

æ­¥éª¤3ï¸âƒ£ æ‰‹æœºå®Œæˆç™»å½•æˆæƒ

æ­¥éª¤4ï¸âƒ£ ç”µè§†è‡ªåŠ¨ç™»å½•æˆåŠŸ

ç”¨æˆ·ä½“éªŒï¼šğŸ˜ŠğŸ˜ŠğŸ˜Š â†’ å¤ªæ–¹ä¾¿äº†ï¼
```

### 2.2 å…¸å‹åº”ç”¨åœºæ™¯


**ğŸ“º æ™ºèƒ½ç”µè§†åº”ç”¨**
```
åœºæ™¯ï¼šåœ¨ä¸‰æ˜Ÿç”µè§†ä¸Šç™»å½•YouTube

è®¾å¤‡ç‰¹ç‚¹ï¼š
â€¢ æœ‰ç½‘ç»œè¿æ¥ âœ…
â€¢ æœ‰å¤§å±å¹•æ˜¾ç¤º âœ…
â€¢ åªæœ‰é¥æ§å™¨è¾“å…¥ âŒ
â€¢ æ²¡æœ‰å®Œæ•´é”®ç›˜ âŒ

è§£å†³æ–¹æ¡ˆï¼š
ç”µè§†ç”Ÿæˆè®¾å¤‡ç  â†’ æ‰‹æœºæµè§ˆå™¨è¾“å…¥ â†’ æˆæƒå®Œæˆ
```

**ğŸ  ç‰©è”ç½‘è®¾å¤‡**
```
åœºæ™¯ï¼šæ™ºèƒ½éŸ³ç®±ç»‘å®šè´¦å·

è®¾å¤‡ç‰¹ç‚¹ï¼š
â€¢ æœ‰WiFiè¿æ¥ âœ…
â€¢ åªèƒ½è¯­éŸ³äº¤äº’ âœ…
â€¢ æ²¡æœ‰å±å¹•æ˜¾ç¤º âŒ
â€¢ æ²¡æœ‰ä»»ä½•è¾“å…¥ âŒ

è§£å†³æ–¹æ¡ˆï¼š
éŸ³ç®±è¯­éŸ³æ’­æŠ¥è®¾å¤‡ç  â†’ æ‰‹æœºAPPè¾“å…¥ â†’ ç»‘å®šæˆåŠŸ
```

---

## 3. âš™ï¸ è®¾å¤‡æµç¨‹å·¥ä½œåŸç†


### 3.1 æ ¸å¿ƒæµç¨‹å›¾è§£


**ğŸ“Š å®Œæ•´äº¤äº’æµç¨‹**
```
æ™ºèƒ½ç”µè§†              æˆæƒæœåŠ¡å™¨              ç”¨æˆ·æ‰‹æœº
   |                      |                      |
   |--[1]è¯·æ±‚è®¾å¤‡ç ------->|                      |
   |   POST /device/code   |                      |
   |                      |                      |
   |<-[2]è¿”å›è®¾å¤‡ä¿¡æ¯------|                      |
   |   device_code: xxx   |                      |
   |   user_code: ABCD    |                      |
   |   verify_url: xxx    |                      |
   |                      |                      |
   |--[3]æ˜¾ç¤ºç”¨æˆ·ç ---------------------------------------->|
   |   "è¯·è®¿é—® xxx.com"   |                      |
   |   "è¾“å…¥ç ï¼šABCD"     |                      |
   |                      |                      |
   |                      |<--[4]ç”¨æˆ·è®¿é—®ç½‘å€-----|
   |                      |   è¾“å…¥ç ï¼šABCD       |
   |                      |                      |
   |                      |<--[5]ç™»å½•æˆæƒ--------|
   |                      |   è¾“å…¥è´¦å·å¯†ç        |
   |                      |   åŒæ„æˆæƒ           |
   |                      |                      |
   |--[6]è½®è¯¢æ£€æŸ¥æˆæƒ----->|                      |
   |   æ¯5ç§’è¯·æ±‚ä¸€æ¬¡       |                      |
   |                      |                      |
   |<-[7]è¿”å›è®¿é—®ä»¤ç‰Œ------|                      |
   |   access_token: xxx  |                      |
   |                      |                      |
   |--[8]ç™»å½•æˆåŠŸ--------->|                      |
```

### 3.2 å…³é”®æ¦‚å¿µè¯¦è§£


**ğŸ”‘ è®¾å¤‡ç  (Device Code)**
```
å®šä¹‰ï¼šæˆæƒæœåŠ¡å™¨ç”Ÿæˆçš„å”¯ä¸€æ ‡è¯†ç¬¦

ç‰¹ç‚¹ï¼š
â€¢ é•¿åº¦ï¼šé€šå¸¸32-128å­—ç¬¦
â€¢ æ ¼å¼ï¼šéšæœºå­—ç¬¦ä¸²ï¼Œä¸å±•ç¤ºç»™ç”¨æˆ·
â€¢ æœ‰æ•ˆæœŸï¼š5-15åˆ†é’Ÿ
â€¢ ç”¨é€”ï¼šè®¾å¤‡è½®è¯¢æ—¶ä½¿ç”¨

ç¤ºä¾‹ï¼š
device_code: "GmRhmhcxhwAzkoEqiMEg_DnyEysNkuNhszIySk9eS"
```

**ğŸ‘¤ ç”¨æˆ·ç  (User Code)**
```
å®šä¹‰ï¼šå±•ç¤ºç»™ç”¨æˆ·çš„çŸ­ç ï¼Œç”¨äºéªŒè¯

ç‰¹ç‚¹ï¼š
â€¢ é•¿åº¦ï¼š6-8ä½
â€¢ æ ¼å¼ï¼šå­—æ¯æ•°å­—ç»„åˆï¼Œæ˜“äºè¾“å…¥
â€¢ è§„åˆ™ï¼šé€šå¸¸å¤§å†™ï¼Œé¿å…æ··æ·†å­—ç¬¦(0/O, 1/I)
â€¢ åˆ†ç»„ï¼šå¸¸ç”¨è¿å­—ç¬¦åˆ†éš”ï¼Œä¾¿äºé˜…è¯»

ç¤ºä¾‹ï¼š
WDJB-MJHT  â† ç”¨æˆ·çœ‹åˆ°å¹¶è¾“å…¥çš„ç 
```

**ğŸ”— éªŒè¯URL (Verification URI)**
```
å®šä¹‰ï¼šç”¨æˆ·è®¿é—®çš„æˆæƒç½‘å€

æ ¼å¼ç¤ºä¾‹ï¼š
https://device.example.com/activate
https://example.com/device

ä¼˜åŒ–æ–¹æ¡ˆï¼š
https://example.com/device?code=WDJB-MJHT
â†‘ ç›´æ¥å¸¦ç ï¼Œç”¨æˆ·æ— éœ€æ‰‹åŠ¨è¾“å…¥
```

### 3.3 è½®è¯¢æœºåˆ¶è¯¦è§£


**ğŸ”„ è½®è¯¢ç­–ç•¥**
```
è®¾å¤‡ç«¯è½®è¯¢é€»è¾‘ï¼š

while (æœªæˆæƒ && æœªè¶…æ—¶) {
    ç­‰å¾… 5ç§’
    è¯·æ±‚æˆæƒæœåŠ¡å™¨
    
    if (æˆæƒæˆåŠŸ) {
        è·å–access_token
        break
    }
    else if (ç”¨æˆ·æ‹’ç») {
        æ˜¾ç¤ºæ‹’ç»ä¿¡æ¯
        break
    }
    else if (è®¾å¤‡ç è¿‡æœŸ) {
        é‡æ–°ç”³è¯·è®¾å¤‡ç 
        break
    }
    else {
        ç»§ç»­ç­‰å¾…
    }
}
```

**â±ï¸ è½®è¯¢é—´éš”æ§åˆ¶**
```
æ ‡å‡†é—´éš”ï¼š5ç§’

åŸå› ï¼š
â€¢ å¤ªå¿«(1ç§’) â†’ æœåŠ¡å™¨å‹åŠ›å¤§ï¼Œæµªè´¹èµ„æº
â€¢ å¤ªæ…¢(30ç§’) â†’ ç”¨æˆ·ç­‰å¾…ä½“éªŒå·®
â€¢ 5ç§’ â†’ å¹³è¡¡æ€§èƒ½ä¸ä½“éªŒ

åŠ¨æ€è°ƒæ•´ï¼š
â€¢ å‰30ç§’ï¼šæ¯5ç§’è½®è¯¢ â† ç”¨æˆ·å¯èƒ½æ­£åœ¨æ“ä½œ
â€¢ 30ç§’åï¼šæ¯10ç§’è½®è¯¢ â† ç”¨æˆ·å¯èƒ½èµ°å¼€äº†
â€¢ 2åˆ†é’Ÿåï¼šæ¯30ç§’è½®è¯¢ â† é¿å…æ— è°“æ¶ˆè€—
```

---

## 4. ğŸ’» è®¾å¤‡æµç¨‹å®Œæ•´å®ç°


### 4.1 æ­¥éª¤ä¸€ï¼šè¯·æ±‚è®¾å¤‡ç 


**ğŸ”¸ è®¾å¤‡ç«¯å‘èµ·è¯·æ±‚**
```java
@Service
public class DeviceAuthService {
    
    @Autowired
    private RestTemplate restTemplate;
    
    // æ­¥éª¤1ï¼šè¯·æ±‚è®¾å¤‡ç 
    public DeviceCodeResponse requestDeviceCode(String clientId) {
        String url = "https://auth.example.com/oauth/device/code";
        
        // æ„é€ è¯·æ±‚å‚æ•°
        MultiValueMap<String, String> params = new LinkedMultiValueMap<>();
        params.add("client_id", clientId);
        params.add("scope", "read write");
        
        // å‘é€POSTè¯·æ±‚
        DeviceCodeResponse response = restTemplate.postForObject(
            url, params, DeviceCodeResponse.class
        );
        
        return response;
    }
}
```

**ğŸ“¦ å“åº”æ•°æ®ç»“æ„**
```java
@Data
public class DeviceCodeResponse {
    private String deviceCode;       // è®¾å¤‡ç (ç”¨äºè½®è¯¢)
    private String userCode;          // ç”¨æˆ·ç (å±•ç¤ºç»™ç”¨æˆ·)
    private String verificationUri;   // éªŒè¯ç½‘å€
    private String verificationUriComplete;  // å¸¦ç çš„å®Œæ•´ç½‘å€
    private Integer expiresIn;        // æœ‰æ•ˆæœŸ(ç§’)
    private Integer interval;         // å»ºè®®è½®è¯¢é—´éš”(ç§’)
}

// ç¤ºä¾‹å“åº”
{
    "device_code": "GmRhmhcxhwAzkoEqiMEg",
    "user_code": "WDJB-MJHT",
    "verification_uri": "https://example.com/device",
    "verification_uri_complete": "https://example.com/device?code=WDJB-MJHT",
    "expires_in": 900,        // 15åˆ†é’Ÿ
    "interval": 5             // æ¯5ç§’è½®è¯¢ä¸€æ¬¡
}
```

### 4.2 æ­¥éª¤äºŒï¼šå±•ç¤ºç”¨æˆ·ç 


**ğŸ“º ç”µè§†ç«¯æ˜¾ç¤ºç•Œé¢**
```java
public void displayUserCode(DeviceCodeResponse response) {
    // æ˜¾ç¤ºæç¤ºä¿¡æ¯
    System.out.println("========================================");
    System.out.println("è¯·ä½¿ç”¨æ‰‹æœºæˆ–ç”µè„‘è®¿é—®ä»¥ä¸‹ç½‘å€è¿›è¡Œæˆæƒï¼š");
    System.out.println();
    System.out.println("  ç½‘å€ï¼š" + response.getVerificationUri());
    System.out.println("  éªŒè¯ç ï¼š" + response.getUserCode());
    System.out.println();
    System.out.println("æˆ–è€…æ‰«æäºŒç»´ç ï¼š");
    displayQRCode(response.getVerificationUriComplete());
    System.out.println("========================================");
}
```

**ğŸ“± ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ**
```
æ–¹æ¡ˆä¸€ï¼šçº¯æ–‡å­—å±•ç¤º
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¯·è®¿é—®ï¼štv.app.com      â”‚
â”‚  è¾“å…¥éªŒè¯ç ï¼šWDJB-MJHT   â”‚
â”‚  æœ‰æ•ˆæœŸï¼š15åˆ†é’Ÿ          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ–¹æ¡ˆäºŒï¼šäºŒç»´ç å±•ç¤º
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â–ˆâ–€â–€â–€â–€â–€â–ˆ â–€ â–ˆâ–ˆ â–ˆâ–€â–€â–€â–€â–€â–ˆ   â”‚
â”‚  â–ˆ â–ˆâ–ˆâ–ˆ â–ˆ â–„â–€ â–ˆ â–ˆ â–ˆâ–ˆâ–ˆ â–ˆ   â”‚
â”‚  â–ˆ â–€â–€â–€ â–ˆ â–ˆâ–„â–„â–„ â–ˆ â–€â–€â–€ â–ˆ   â”‚
â”‚                          â”‚
â”‚  æ‰«ç å³å¯æˆæƒ             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ–¹æ¡ˆä¸‰ï¼šçŸ­é“¾æ¥ + è‡ªåŠ¨å¡«å……
tv.app.com/WDJB â† è®¿é—®å³è‡ªåŠ¨å¡«å……éªŒè¯ç 
```

### 4.3 æ­¥éª¤ä¸‰ï¼šç”¨æˆ·æˆæƒæµç¨‹


**ğŸŒ æˆæƒæœåŠ¡å™¨ç«¯ç‚¹**
```java
@RestController
@RequestMapping("/device")
public class DeviceAuthController {
    
    @Autowired
    private DeviceAuthService deviceAuthService;
    
    // ç”¨æˆ·è®¿é—®éªŒè¯é¡µé¢
    @GetMapping("/activate")
    public String showActivationPage(
        @RequestParam(required = false) String code,
        Model model
    ) {
        if (code != null) {
            model.addAttribute("userCode", code);
        }
        return "device-activation";  // è¿”å›HTMLé¡µé¢
    }
    
    // éªŒè¯ç”¨æˆ·ç 
    @PostMapping("/activate")
    public ResponseEntity<?> verifyUserCode(
        @RequestParam String userCode,
        HttpSession session
    ) {
        // 1. éªŒè¯ç”¨æˆ·ç æ˜¯å¦å­˜åœ¨ä¸”æœ‰æ•ˆ
        DeviceAuth auth = deviceAuthService.findByUserCode(userCode);
        
        if (auth == null || auth.isExpired()) {
            return ResponseEntity.badRequest()
                .body("éªŒè¯ç æ— æ•ˆæˆ–å·²è¿‡æœŸ");
        }
        
        // 2. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
        if (!session.getAttribute("user")) {
            // è·³è½¬åˆ°ç™»å½•é¡µï¼Œç™»å½•åè¿”å›
            return ResponseEntity.ok()
                .body("redirect:/login?returnUrl=/device/authorize");
        }
        
        // 3. æ˜¾ç¤ºæˆæƒç¡®è®¤é¡µé¢
        return ResponseEntity.ok()
            .body("redirect:/device/authorize?user_code=" + userCode);
    }
}
```

**âœ… æˆæƒç¡®è®¤é¡µé¢**
```html
<!-- device-authorize.html -->
<div class="authorization-page">
    <h2>æˆæƒè¯·æ±‚</h2>
    <p>è®¾å¤‡æ­£åœ¨è¯·æ±‚è®¿é—®æ‚¨çš„è´¦æˆ·</p>
    
    <div class="device-info">
        <p>è®¾å¤‡ç±»å‹ï¼šæ™ºèƒ½ç”µè§†</p>
        <p>è¯·æ±‚æƒé™ï¼šè¯»å–ä¸ªäººä¿¡æ¯ã€è®¿é—®è§‚çœ‹è®°å½•</p>
    </div>
    
    <div class="actions">
        <button onclick="approve()">åŒæ„æˆæƒ</button>
        <button onclick="deny()">æ‹’ç»</button>
    </div>
</div>

<script>
function approve() {
    fetch('/device/approve', {
        method: 'POST',
        body: JSON.stringify({ userCode: '${userCode}' })
    }).then(() => {
        showSuccess('æˆæƒæˆåŠŸï¼æ‚¨å¯ä»¥å…³é—­æ­¤é¡µé¢');
    });
}
</script>
```

### 4.4 æ­¥éª¤å››ï¼šè®¾å¤‡ç«¯è½®è¯¢


**ğŸ”„ è½®è¯¢å®ç°**
```java
public class DevicePollingService {
    
    @Autowired
    private RestTemplate restTemplate;
    
    // è½®è¯¢è·å–ä»¤ç‰Œ
    public TokenResponse pollForToken(
        String deviceCode, 
        int interval
    ) throws InterruptedException {
        
        String tokenUrl = "https://auth.example.com/oauth/token";
        int maxAttempts = 180;  // æœ€å¤šè½®è¯¢15åˆ†é’Ÿ(180æ¬¡*5ç§’)
        
        for (int i = 0; i < maxAttempts; i++) {
            // ç­‰å¾…æŒ‡å®šé—´éš”
            Thread.sleep(interval * 1000);
            
            // æ„é€ è¯·æ±‚
            MultiValueMap<String, String> params = new LinkedMultiValueMap<>();
            params.add("grant_type", "urn:ietf:params:oauth:grant-type:device_code");
            params.add("device_code", deviceCode);
            params.add("client_id", CLIENT_ID);
            
            try {
                // è¯·æ±‚ä»¤ç‰Œ
                TokenResponse response = restTemplate.postForObject(
                    tokenUrl, params, TokenResponse.class
                );
                
                // æˆåŠŸè·å–ä»¤ç‰Œ
                return response;
                
            } catch (HttpClientErrorException e) {
                // å¤„ç†é”™è¯¯å“åº”
                String error = parseError(e.getResponseBodyAsString());
                
                switch (error) {
                    case "authorization_pending":
                        // ç”¨æˆ·è¿˜æœªæˆæƒï¼Œç»§ç»­è½®è¯¢
                        continue;
                        
                    case "slow_down":
                        // æœåŠ¡å™¨è¦æ±‚é™ä½è½®è¯¢é¢‘ç‡
                        interval += 5;
                        continue;
                        
                    case "access_denied":
                        // ç”¨æˆ·æ‹’ç»æˆæƒ
                        throw new AuthorizationDeniedException();
                        
                    case "expired_token":
                        // è®¾å¤‡ç å·²è¿‡æœŸ
                        throw new DeviceCodeExpiredException();
                        
                    default:
                        throw new AuthorizationException(error);
                }
            }
        }
        
        throw new TimeoutException("æˆæƒè¶…æ—¶");
    }
}
```

**ğŸ“Š è½®è¯¢çŠ¶æ€å¤„ç†**
```
è½®è¯¢å¯èƒ½çš„å“åº”ï¼š

âœ… æˆåŠŸå“åº”ï¼š
{
    "access_token": "eyJhbGciOiJSUzI1NiIs...",
    "token_type": "Bearer",
    "expires_in": 3600,
    "refresh_token": "tGzv3JOkF0XG5Qx2TlKWIA"
}

â³ ç­‰å¾…å“åº”ï¼š
{
    "error": "authorization_pending",
    "error_description": "ç”¨æˆ·è¿˜æœªå®Œæˆæˆæƒ"
}
â†’ ç»§ç»­è½®è¯¢

ğŸŒ é™é€Ÿå“åº”ï¼š
{
    "error": "slow_down",
    "error_description": "è¯·é™ä½è½®è¯¢é¢‘ç‡"
}
â†’ å¢åŠ é—´éš”æ—¶é—´

âŒ æ‹’ç»å“åº”ï¼š
{
    "error": "access_denied",
    "error_description": "ç”¨æˆ·æ‹’ç»æˆæƒ"
}
â†’ åœæ­¢è½®è¯¢ï¼Œæ˜¾ç¤ºé”™è¯¯

âŒ› è¿‡æœŸå“åº”ï¼š
{
    "error": "expired_token",
    "error_description": "è®¾å¤‡ç å·²è¿‡æœŸ"
}
â†’ é‡æ–°ç”³è¯·è®¾å¤‡ç 
```

---

## 5. ğŸ”’ å®‰å…¨æ€§è€ƒè™‘


### 5.1 è®¾å¤‡ç å®‰å…¨


**ğŸ” ç”Ÿæˆè§„åˆ™**
```java
public class DeviceCodeGenerator {
    
    // ç”Ÿæˆå®‰å…¨çš„è®¾å¤‡ç 
    public String generateDeviceCode() {
        // ä½¿ç”¨å®‰å…¨éšæœºæ•°ç”Ÿæˆå™¨
        SecureRandom random = new SecureRandom();
        byte[] bytes = new byte[32];
        random.nextBytes(bytes);
        
        // Base64ç¼–ç ï¼Œå»é™¤ç‰¹æ®Šå­—ç¬¦
        return Base64.getUrlEncoder()
            .withoutPadding()
            .encodeToString(bytes);
    }
    
    // ç”Ÿæˆç”¨æˆ·å‹å¥½çš„ç”¨æˆ·ç 
    public String generateUserCode() {
        SecureRandom random = new SecureRandom();
        
        // ä½¿ç”¨æ˜“äºè¾“å…¥çš„å­—ç¬¦é›†
        String chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";  // æ’é™¤æ˜“æ··æ·†å­—ç¬¦
        StringBuilder code = new StringBuilder();
        
        for (int i = 0; i < 8; i++) {
            if (i == 4) code.append("-");  // ä¸­é—´åŠ è¿å­—ç¬¦
            code.append(chars.charAt(random.nextInt(chars.length())));
        }
        
        return code.toString();  // æ ¼å¼ï¼šABCD-1234
    }
}
```

**â° æœ‰æ•ˆæœŸæ§åˆ¶**
```java
@Entity
public class DeviceAuth {
    
    @Id
    private String deviceCode;
    private String userCode;
    private LocalDateTime createdAt;
    private Integer expiresIn = 900;  // 15åˆ†é’Ÿ
    
    // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
    public boolean isExpired() {
        return LocalDateTime.now()
            .isAfter(createdAt.plusSeconds(expiresIn));
    }
    
    // æ£€æŸ¥æ˜¯å¦å¯ä»¥è½®è¯¢
    public boolean canPoll(LocalDateTime lastPollTime) {
        return Duration.between(lastPollTime, LocalDateTime.now())
            .getSeconds() >= 5;  // è‡³å°‘é—´éš”5ç§’
    }
}
```

### 5.2 é˜²æ­¢æ»¥ç”¨æ”»å‡»


**ğŸš« é˜²æš´åŠ›ç ´è§£**
```java
@Service
public class DeviceAuthSecurityService {
    
    @Autowired
    private RedisTemplate<String, Integer> redisTemplate;
    
    // é™åˆ¶ç”¨æˆ·ç å°è¯•æ¬¡æ•°
    public void checkUserCodeAttempts(String ipAddress) {
        String key = "device_auth_attempts:" + ipAddress;
        Integer attempts = redisTemplate.opsForValue().get(key);
        
        if (attempts == null) {
            attempts = 0;
        }
        
        // æ¯å°æ—¶æœ€å¤šå°è¯•10æ¬¡
        if (attempts >= 10) {
            throw new TooManyAttemptsException(
                "å°è¯•æ¬¡æ•°è¿‡å¤šï¼Œè¯·1å°æ—¶åå†è¯•"
            );
        }
        
        // å¢åŠ è®¡æ•°
        redisTemplate.opsForValue().increment(key);
        redisTemplate.expire(key, 1, TimeUnit.HOURS);
    }
    
    // é™åˆ¶è®¾å¤‡ç ç”³è¯·é¢‘ç‡
    public void checkDeviceCodeRequest(String clientId, String ipAddress) {
        String key = "device_code_requests:" + clientId + ":" + ipAddress;
        
        Boolean exists = redisTemplate.hasKey(key);
        if (Boolean.TRUE.equals(exists)) {
            throw new RateLimitException(
                "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•"
            );
        }
        
        // 1åˆ†é’Ÿå†…åªèƒ½ç”³è¯·1æ¬¡
        redisTemplate.opsForValue().set(key, 1, 60, TimeUnit.SECONDS);
    }
}
```

**ğŸ”„ è½®è¯¢é¢‘ç‡é™åˆ¶**
```java
// æ£€æŸ¥è½®è¯¢é¢‘ç‡
public void validatePollingInterval(
    String deviceCode, 
    LocalDateTime lastPollTime
) {
    long secondsSinceLastPoll = Duration
        .between(lastPollTime, LocalDateTime.now())
        .getSeconds();
    
    if (secondsSinceLastPoll < 5) {
        // è¿”å›slow_downé”™è¯¯
        throw new SlowDownException(
            "è¯·é™ä½è½®è¯¢é¢‘ç‡ï¼Œå»ºè®®é—´éš”" + (secondsSinceLastPoll + 5) + "ç§’"
        );
    }
}
```

### 5.3 ç”¨æˆ·ç ç¢°æ’å¤„ç†


**ğŸ² é¿å…é‡å¤**
```java
public String generateUniqueUserCode() {
    int maxAttempts = 10;
    
    for (int i = 0; i < maxAttempts; i++) {
        String userCode = generateUserCode();
        
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        if (!deviceAuthRepository.existsByUserCode(userCode)) {
            return userCode;
        }
    }
    
    // æå°æ¦‚ç‡ä¼šèµ°åˆ°è¿™é‡Œï¼Œä½¿ç”¨æ›´é•¿çš„ç”¨æˆ·ç 
    return generateUserCode() + "-" + System.currentTimeMillis() % 10000;
}
```

---

## 6. âœ¨ æœ€ä½³å®è·µä¸ä¼˜åŒ–


### 6.1 ç”¨æˆ·ä½“éªŒä¼˜åŒ–


**ğŸ“± å¤šç§å±•ç¤ºæ–¹å¼**
```
ä¼˜å…ˆçº§æ¨èï¼š

1. äºŒç»´ç  + çŸ­é“¾æ¥ï¼ˆæœ€ä½³ï¼‰
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ â”‚  â† æ‰«ç ç›´æ¥è·³è½¬å¸¦ç é¡µé¢
   â”‚  â–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆ   â”‚
   â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ â”‚
   â”‚                 â”‚
   â”‚  tv.app.com/A1B2â”‚  â† ä¹Ÿå¯æ‰‹åŠ¨è®¿é—®çŸ­é“¾æ¥
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

2. å®Œæ•´URL + ç”¨æˆ·ç 
   è®¿é—®ï¼šhttps://device.example.com
   è¾“å…¥ç ï¼šWDJB-MJHT

3. çŸ­é“¾æ¥è‡ªåŠ¨å¡«å……
   tv.app.com/WDJB  â† è®¿é—®å³è‡ªåŠ¨å¡«å……
```

**â±ï¸ å®æ—¶çŠ¶æ€åé¦ˆ**
```java
// WebSocketå®æ—¶é€šçŸ¥
@Service
public class DeviceAuthNotificationService {
    
    @Autowired
    private SimpMessagingTemplate messagingTemplate;
    
    // æˆæƒæˆåŠŸåå®æ—¶é€šçŸ¥è®¾å¤‡
    public void notifyDeviceAuthorized(String deviceCode) {
        messagingTemplate.convertAndSend(
            "/topic/device/" + deviceCode,
            new AuthStatusMessage("authorized")
        );
    }
}

// è®¾å¤‡ç«¯ç›‘å¬
stompClient.subscribe('/topic/device/' + deviceCode, (message) => {
    if (message.body === 'authorized') {
        // ç«‹å³è¯·æ±‚ä»¤ç‰Œï¼Œæ— éœ€ç­‰å¾…è½®è¯¢é—´éš”
        requestToken();
    }
});
```

### 6.2 é”™è¯¯å¤„ç†ä¼˜åŒ–


**ğŸ’¬ å‹å¥½çš„é”™è¯¯æç¤º**
```java
public class DeviceAuthErrorHandler {
    
    public String getErrorMessage(String errorCode) {
        switch (errorCode) {
            case "authorization_pending":
                return "æ­£åœ¨ç­‰å¾…æˆæƒï¼Œè¯·åœ¨å…¶ä»–è®¾å¤‡ä¸Šå®Œæˆç™»å½•";
                
            case "slow_down":
                return "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œæ­£åœ¨é™ä½æ£€æŸ¥é€Ÿåº¦";
                
            case "access_denied":
                return "æˆæƒè¢«æ‹’ç»ï¼Œè¯·é‡æ–°å°è¯•";
                
            case "expired_token":
                return "éªŒè¯ç å·²è¿‡æœŸï¼Œè¯·é‡æ–°è·å–æ–°çš„éªŒè¯ç ";
                
            default:
                return "æˆæƒè¿‡ç¨‹å‡ºç°é—®é¢˜ï¼š" + errorCode;
        }
    }
}
```

### 6.3 æ€§èƒ½ä¼˜åŒ–


**ğŸš€ ç¼“å­˜ä¼˜åŒ–**
```java
@Service
public class DeviceAuthCacheService {
    
    @Autowired
    private RedisTemplate<String, DeviceAuth> redisTemplate;
    
    // è®¾å¤‡ç å­˜å‚¨åœ¨Redisï¼Œå¿«é€ŸæŸ¥è¯¢
    public void saveDeviceAuth(DeviceAuth auth) {
        String deviceKey = "device_code:" + auth.getDeviceCode();
        String userKey = "user_code:" + auth.getUserCode();
        
        // æŒ‰è®¾å¤‡ç å­˜å‚¨
        redisTemplate.opsForValue().set(
            deviceKey, auth, auth.getExpiresIn(), TimeUnit.SECONDS
        );
        
        // æŒ‰ç”¨æˆ·ç ç´¢å¼•
        redisTemplate.opsForValue().set(
            userKey, auth, auth.getExpiresIn(), TimeUnit.SECONDS
        );
    }
    
    // å¿«é€ŸæŸ¥è¯¢
    public DeviceAuth findByUserCode(String userCode) {
        return redisTemplate.opsForValue()
            .get("user_code:" + userCode);
    }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ è®¾å¤‡æµç¨‹æœ¬è´¨ï¼šä¸ºè¾“å…¥å—é™è®¾å¤‡è®¾è®¡çš„OAuth2.0æˆæƒæ–¹å¼
ğŸ”¸ æ ¸å¿ƒç»„ä»¶ï¼šè®¾å¤‡ç ã€ç”¨æˆ·ç ã€éªŒè¯URLã€è½®è¯¢æœºåˆ¶
ğŸ”¸ é€‚ç”¨åœºæ™¯ï¼šæ™ºèƒ½ç”µè§†ã€æ¸¸æˆæœºã€ç‰©è”ç½‘è®¾å¤‡ç­‰
ğŸ”¸ å·¥ä½œåŸç†ï¼šè®¾å¤‡æ˜¾ç¤ºç  â†’ ç”¨æˆ·å…¶ä»–è®¾å¤‡è¾“å…¥ â†’ è®¾å¤‡è½®è¯¢è·å–ä»¤ç‰Œ
ğŸ”¸ å®‰å…¨è¦ç‚¹ï¼šè®¾å¤‡ç éšæœºæ€§ã€æœ‰æ•ˆæœŸæ§åˆ¶ã€é˜²æš´åŠ›ç ´è§£ã€è½®è¯¢é™æµ
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆéœ€è¦ä¸¤ä¸ªç **
```
è®¾å¤‡ç (Device Code)ï¼š
â€¢ ç”¨é€”ï¼šè®¾å¤‡è½®è¯¢æ—¶ä½¿ç”¨
â€¢ ç‰¹ç‚¹ï¼šé•¿ä¸”å¤æ‚ï¼Œä¸å±•ç¤ºç»™ç”¨æˆ·
â€¢ åŸå› ï¼šéœ€è¦è¶³å¤Ÿéšæœºä¿è¯å®‰å…¨æ€§

ç”¨æˆ·ç (User Code)ï¼š
â€¢ ç”¨é€”ï¼šç”¨æˆ·æ‰‹åŠ¨è¾“å…¥éªŒè¯
â€¢ ç‰¹ç‚¹ï¼šçŸ­ä¸”æ˜“è¯»ï¼Œ6-8ä½
â€¢ åŸå› ï¼šæ–¹ä¾¿ç”¨æˆ·è¾“å…¥ï¼Œæå‡ä½“éªŒ
```

**ğŸ”¹ è½®è¯¢æœºåˆ¶çš„è®¾è®¡è€ƒé‡**
```
é—´éš”æ—¶é—´é€‰æ‹©ï¼š
â€¢ å¤ªå¿« â†’ æœåŠ¡å™¨å‹åŠ›å¤§ï¼Œæµªè´¹èµ„æº
â€¢ å¤ªæ…¢ â†’ ç”¨æˆ·ç­‰å¾…æ—¶é—´é•¿ï¼Œä½“éªŒå·®
â€¢ 5ç§’ â†’ å¹³è¡¡æ€§èƒ½å’Œä½“éªŒçš„æœ€ä½³å®è·µ

ä¼˜åŒ–æ–¹æ¡ˆï¼š
â€¢ WebSocketå®æ—¶é€šçŸ¥ â†’ æˆæƒæˆåŠŸç«‹å³å“åº”
â€¢ åŠ¨æ€è°ƒæ•´é—´éš” â†’ æ ¹æ®ç­‰å¾…æ—¶é•¿è°ƒæ•´é¢‘ç‡
â€¢ æœ¬åœ°çŠ¶æ€ç¼“å­˜ â†’ å‡å°‘é‡å¤è¯·æ±‚
```

### 7.3 å®é™…åº”ç”¨è¦ç‚¹


**ğŸ¯ æœ€ä½³å®è·µæ¸…å•**
- âœ… **ç”¨æˆ·ç è®¾è®¡**ï¼šå¤§å†™å­—æ¯+æ•°å­—ï¼Œé¿å…æ˜“æ··æ·†å­—ç¬¦(0/O, 1/I)
- âœ… **å¤šç§å±•ç¤ºæ–¹å¼**ï¼šäºŒç»´ç  + çŸ­é“¾æ¥ + å®Œæ•´URL
- âœ… **å®‰å…¨é˜²æŠ¤**ï¼šè®¾å¤‡ç éšæœºç”Ÿæˆã€æœ‰æ•ˆæœŸ15åˆ†é’Ÿã€é˜²æš´åŠ›ç ´è§£
- âœ… **è½®è¯¢ä¼˜åŒ–**ï¼š5ç§’é—´éš”ã€åŠ¨æ€è°ƒæ•´ã€å®æ—¶é€šçŸ¥
- âœ… **é”™è¯¯å¤„ç†**ï¼šå‹å¥½æç¤ºã€è‡ªåŠ¨é‡è¯•ã€è¶…æ—¶å¤„ç†
- âœ… **æ€§èƒ½ä¼˜åŒ–**ï¼šRedisç¼“å­˜ã€å¼‚æ­¥å¤„ç†ã€è¿æ¥å¤ç”¨

**ğŸ§  è®°å¿†è¦ç‚¹**
```
è®¾å¤‡æµç¨‹å››æ­¥èµ°ï¼š
1. è®¾å¤‡ç”³è¯·ç  â†’ è·å¾—è®¾å¤‡ç å’Œç”¨æˆ·ç 
2. æ˜¾ç¤ºç»™ç”¨æˆ· â†’ äºŒç»´ç æˆ–çŸ­é“¾æ¥
3. ç”¨æˆ·å»æˆæƒ â†’ æ‰‹æœºæˆ–ç”µè„‘å®Œæˆ
4. è®¾å¤‡è½®è¯¢è·ä»¤ç‰Œ â†’ æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡

å®‰å…¨ä¸‰è¦ç´ ï¼š
â€¢ è®¾å¤‡ç è¦è¶³å¤Ÿéšæœº
â€¢ ç”¨æˆ·ç è¦æ˜“äºè¾“å…¥
â€¢ è½®è¯¢è¦é™åˆ¶é¢‘ç‡
```