---
title: 2ã€OIDCå®ç°æ–¹æ¡ˆ
---
## ğŸ“š ç›®å½•

1. [OIDCæ˜¯ä»€ä¹ˆ](#1-OIDCæ˜¯ä»€ä¹ˆ)
2. [èº«ä»½æä¾›å•†IdP](#2-èº«ä»½æä¾›å•†IdP)
3. [ID Tokenæ ¸å¿ƒæœºåˆ¶](#3-ID-Tokenæ ¸å¿ƒæœºåˆ¶)
4. [ç”¨æˆ·ä¿¡æ¯ç«¯ç‚¹](#4-ç”¨æˆ·ä¿¡æ¯ç«¯ç‚¹)
5. [æ ‡å‡†å£°æ˜ä½“ç³»](#5-æ ‡å‡†å£°æ˜ä½“ç³»)
6. [OIDCå®Œæ•´å®ç°](#6-OIDCå®Œæ•´å®ç°)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” OIDCæ˜¯ä»€ä¹ˆ


### 1.1 é€šä¿—ç†è§£OIDC


**ğŸ¤” å…ˆè¯´è¯´OAuth2.0çš„ä¸è¶³**

ä½ å¯èƒ½å·²ç»å­¦è¿‡OAuth2.0äº†ï¼Œå®ƒä¸»è¦è§£å†³çš„æ˜¯"æˆæƒ"é—®é¢˜ï¼š
- ç”¨æˆ·å…è®¸ç¬¬ä¸‰æ–¹åº”ç”¨è®¿é—®ä»–çš„èµ„æºï¼ˆæ¯”å¦‚è·å–ä»–çš„æœ‹å‹åˆ—è¡¨ï¼‰
- ä½†OAuth2.0**ä¸å‘Šè¯‰ä½ è¿™ä¸ªç”¨æˆ·æ˜¯è°**

```
ç°å®åœºæ™¯å¯¹æ¯”ï¼š

OAuth2.0å°±åƒï¼š
ä½ æ‹¿ç€ä¸€å¼ é—¨ç¦å¡è¿›å…¥äº†å¥èº«æˆ¿
âœ… é—¨å¡è¯æ˜ä½ æœ‰æƒé™è¿›å…¥
âŒ ä½†å¥èº«æˆ¿ä¸çŸ¥é“ä½ æ˜¯è°

OIDCå°±åƒï¼š
ä½ æ‹¿ç€èº«ä»½è¯+é—¨ç¦å¡è¿›å…¥å¥èº«æˆ¿  
âœ… é—¨å¡è¯æ˜ä½ æœ‰æƒé™è¿›å…¥
âœ… èº«ä»½è¯å‘Šè¯‰å¥èº«æˆ¿ä½ æ˜¯è°
```

**ğŸ“– OIDCçš„å®˜æ–¹å®šä¹‰**
```
OIDC (OpenID Connect)ï¼š
åŸºäºOAuth2.0çš„èº«ä»½è®¤è¯å±‚
= OAuth2.0æˆæƒ + èº«ä»½è®¤è¯

æ ¸å¿ƒä½œç”¨ï¼š
ä¸ä»…çŸ¥é“"å…è®¸è®¿é—®"ï¼Œè¿˜çŸ¥é“"è°åœ¨è®¿é—®"
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦OIDC


**ğŸ¯ å®é™…éœ€æ±‚ä¸¾ä¾‹**

```
åœºæ™¯1ï¼šå•ç‚¹ç™»å½•(SSO)
ç”¨æˆ·åœ¨ä¼ä¸šå†…ç½‘ç™»å½•ä¸€æ¬¡
â†’ æ‰€æœ‰ç³»ç»Ÿéƒ½çŸ¥é“ä»–æ˜¯è°
â†’ ä¸éœ€è¦é‡å¤ç™»å½•

åœºæ™¯2ï¼šç¬¬ä¸‰æ–¹ç™»å½•
ç”¨å¾®ä¿¡ç™»å½•æŸä¸ªç½‘ç«™
â†’ ç½‘ç«™éœ€è¦çŸ¥é“ä½ çš„å¾®ä¿¡æ˜µç§°ã€å¤´åƒ
â†’ å…‰æœ‰access_tokenä¸å¤Ÿ

åœºæ™¯3ï¼šç§»åŠ¨åº”ç”¨
Appéœ€è¦æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
â†’ å§“åã€é‚®ç®±ã€å¤´åƒç­‰
â†’ OAuth2.0åªç»™æƒé™ï¼Œä¸ç»™èº«ä»½
```

**ğŸ”¸ æŠ€æœ¯å±‚é¢çš„å·®å¼‚**

| å¯¹æ¯”ç»´åº¦ | **OAuth2.0** | **OIDC** |
|---------|-------------|----------|
| ä¸»è¦ç›®çš„ | `æˆæƒ(Authorization)` | `è®¤è¯(Authentication) + æˆæƒ` |
| è§£å†³é—®é¢˜ | `"èƒ½ä¸èƒ½è®¿é—®èµ„æº?"` | `"ä½ æ˜¯è°?" + "èƒ½è®¿é—®ä»€ä¹ˆ?"` |
| è¿”å›å†…å®¹ | `access_token` | `access_token + id_token` |
| ç”¨æˆ·ä¿¡æ¯ | `éœ€è¦é¢å¤–è¯·æ±‚` | `ç›´æ¥åŒ…å«åœ¨id_tokenä¸­` |
| åº”ç”¨åœºæ™¯ | `ç¬¬ä¸‰æ–¹æˆæƒè®¿é—®` | `ç™»å½•è®¤è¯ + æˆæƒ` |

### 1.3 OIDCçš„æ ¸å¿ƒç»„æˆ


**ğŸ—ï¸ OIDC = OAuth2.0 + ä¸‰ä¸ªæ‰©å±•**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         OIDCåè®®æ ˆ              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â‘  ID Token (èº«ä»½ä»¤ç‰Œ)          â”‚ â† æ–°å¢
â”‚  â‘¡ UserInfoç«¯ç‚¹ (ç”¨æˆ·ä¿¡æ¯)      â”‚ â† æ–°å¢  
â”‚  â‘¢ æ ‡å‡†Scope (openidå¿…éœ€)       â”‚ â† æ–°å¢
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      OAuth2.0æˆæƒæ¡†æ¶           â”‚ â† åŸºç¡€
â”‚  (æˆæƒç ã€ä»¤ç‰Œã€åˆ·æ–°ç­‰æœºåˆ¶)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ’¡ å…³é”®ç†è§£**
- OIDCä¸æ˜¯æ›¿ä»£OAuth2.0ï¼Œè€Œæ˜¯**æ‰©å±•**å®ƒ
- å®Œå…¨å…¼å®¹OAuth2.0çš„æ‰€æœ‰æµç¨‹
- åªæ˜¯åœ¨å…³é”®ç¯èŠ‚å¢åŠ äº†èº«ä»½ä¿¡æ¯

---

## 2. ğŸ¢ èº«ä»½æä¾›å•†IdP


### 2.1 ä»€ä¹ˆæ˜¯èº«ä»½æä¾›å•†


**ğŸ”¸ é€šä¿—è§£é‡Š**

```
èº«ä»½æä¾›å•†(IdP - Identity Provider)ï¼š
å°±åƒç°å®ç”Ÿæ´»ä¸­çš„"èº«ä»½è¯åŠç†ä¸­å¿ƒ"

èŒè´£ï¼š
â€¢ éªŒè¯ç”¨æˆ·èº«ä»½ï¼ˆä½ çœŸçš„æ˜¯å¼ ä¸‰å—ï¼Ÿï¼‰
â€¢ é¢å‘èº«ä»½è¯æ˜ï¼ˆç»™ä½ ä¸€ä¸ªID Tokenï¼‰
â€¢ æä¾›èº«ä»½ä¿¡æ¯ï¼ˆæŸ¥è¯¢ä½ çš„ä¸ªäººèµ„æ–™ï¼‰
```

**ğŸŒ å¸¸è§çš„èº«ä»½æä¾›å•†**

```
å…¬å…±IdPæœåŠ¡ï¼š
â€¢ Google        â†’ accounts.google.com
â€¢ å¾®ä¿¡å¼€æ”¾å¹³å°   â†’ open.weixin.qq.com
â€¢ GitHub        â†’ github.com/login/oauth
â€¢ Facebook      â†’ facebook.com/login

ä¼ä¸šçº§IdPï¼š
â€¢ Keycloak      â†’ å¼€æºèº«ä»½ç®¡ç†ç³»ç»Ÿ
â€¢ Okta          â†’ å•†ä¸šèº«ä»½æœåŠ¡
â€¢ Azure AD      â†’ å¾®è½¯ä¼ä¸šèº«ä»½
â€¢ è‡ªå»ºIdP        â†’ å…¬å¸å†…éƒ¨è®¤è¯ä¸­å¿ƒ
```

### 2.2 IdPçš„æ ¸å¿ƒåŠŸèƒ½


**âš™ï¸ åŠŸèƒ½æ¶æ„å›¾**

```
                    èº«ä»½æä¾›å•†(IdP)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                      â”‚
    â”‚  â‘  ç”¨æˆ·è®¤è¯æœåŠ¡                      â”‚
    â”‚     - ç™»å½•é¡µé¢                       â”‚
    â”‚     - å¯†ç éªŒè¯/å¤šå› ç´ è®¤è¯            â”‚
    â”‚     - ç¤¾äº¤è´¦å·ç™»å½•                   â”‚
    â”‚                                      â”‚
    â”‚  â‘¡ Tokené¢å‘æœåŠ¡                     â”‚
    â”‚     - ç”ŸæˆID Token                   â”‚
    â”‚     - ç”ŸæˆAccess Token               â”‚
    â”‚     - Tokenç­¾åå’ŒåŠ å¯†                â”‚
    â”‚                                      â”‚
    â”‚  â‘¢ ç”¨æˆ·ä¿¡æ¯æœåŠ¡                      â”‚
    â”‚     - UserInfoç«¯ç‚¹                   â”‚
    â”‚     - ç”¨æˆ·å±æ€§ç®¡ç†                   â”‚
    â”‚     - æƒé™å’Œè§’è‰²ç®¡ç†                 â”‚
    â”‚                                      â”‚
    â”‚  â‘£ å®‰å…¨ç®¡ç†                          â”‚
    â”‚     - ä¼šè¯ç®¡ç†                       â”‚
    â”‚     - Tokenæ’¤é”€                      â”‚
    â”‚     - å®¡è®¡æ—¥å¿—                       â”‚
    â”‚                                      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”§ IdPçš„å…³é”®ç«¯ç‚¹**

| ç«¯ç‚¹ç±»å‹ | **è·¯å¾„ç¤ºä¾‹** | **ä½œç”¨è¯´æ˜** |
|---------|-------------|-------------|
| æˆæƒç«¯ç‚¹ | `/oauth/authorize` | `ç”¨æˆ·ç™»å½•å’Œæˆæƒçš„å…¥å£` |
| Tokenç«¯ç‚¹ | `/oauth/token` | `ç”¨codeæ¢å–token` |
| UserInfoç«¯ç‚¹ | `/userinfo` | `è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯` â­æ–°å¢ |
| JWKSç«¯ç‚¹ | `/.well-known/jwks.json` | `å…¬é’¥ä¿¡æ¯ï¼Œç”¨äºéªŒè¯ç­¾å` â­æ–°å¢ |
| é…ç½®ç«¯ç‚¹ | `/.well-known/openid-configuration` | `IdPçš„é…ç½®ä¿¡æ¯` â­æ–°å¢ |

### 2.3 å¦‚ä½•é€‰æ‹©IdP


**ğŸ“‹ é€‰å‹è€ƒè™‘å› ç´ **

```
ä¼ä¸šå†…éƒ¨åº”ç”¨ï¼š
âœ… è‡ªå»ºIdP (Keycloak/è‡ªç ”)
   - æ•°æ®å®Œå…¨æŒæ§
   - å¯å®šåˆ¶åŒ–ç¨‹åº¦é«˜
   - é€‚åˆæ•æ„Ÿæ•°æ®åœºæ™¯

é¢å‘å…¬ä¼—çš„åº”ç”¨ï¼š
âœ… å…¬å…±IdPé›†æˆ (Google/å¾®ä¿¡)
   - ç”¨æˆ·æ— éœ€æ³¨å†Œ
   - é™ä½ä½¿ç”¨é—¨æ§›
   - å¿«é€Ÿä¸Šçº¿

æ··åˆåœºæ™¯ï¼š
âœ… å¤šIdPæ”¯æŒ
   - ä¼ä¸šå‘˜å·¥ç”¨å†…éƒ¨IdP
   - å¤–éƒ¨ç”¨æˆ·ç”¨ç¤¾äº¤IdP
   - çµæ´»æ€§æœ€é«˜
```

**âš ï¸ é‡è¦æé†’**

> **å®‰å…¨è€ƒè™‘**ï¼šIdPæŒæ¡ç€æ‰€æœ‰ç”¨æˆ·çš„èº«ä»½ä¿¡æ¯ï¼Œå¿…é¡»ç¡®ä¿å…¶å®‰å…¨æ€§å’Œå¯é æ€§ã€‚å¦‚æœIdPè¢«æ”»å‡»ï¼Œæ‰€æœ‰ä¾èµ–å®ƒçš„åº”ç”¨éƒ½ä¼šå—å½±å“ã€‚

---

## 3. ğŸ« ID Tokenæ ¸å¿ƒæœºåˆ¶


### 3.1 ID Tokenæ˜¯ä»€ä¹ˆ


**ğŸ”¸ æœ¬è´¨ç†è§£**

```
ID Tokenï¼š
ä¸€ä¸ªåŒ…å«ç”¨æˆ·èº«ä»½ä¿¡æ¯çš„JWTä»¤ç‰Œ
å°±åƒä¸€å¼ "ç”µå­èº«ä»½è¯"

ä¸Access Tokençš„åŒºåˆ«ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Access Token â”‚  ç”¨äºè®¿é—®èµ„æºAPI    â”‚
â”‚             â”‚  "ä½ èƒ½å¹²ä»€ä¹ˆ"       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ID Token    â”‚  è¡¨ç¤ºç”¨æˆ·èº«ä»½       â”‚
â”‚             â”‚  "ä½ æ˜¯è°"           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ“¦ ID Tokençš„ç»“æ„**

```
ID Token = JWTæ ¼å¼çš„ä¸‰æ®µå¼ç»“æ„

eyJhbGc...header  (å¤´éƒ¨ï¼šç­¾åç®—æ³•)
.
eyJzdWI...payload (è½½è·ï¼šç”¨æˆ·ä¿¡æ¯)
.
SflKxwR...signature (ç­¾åï¼šé˜²ç¯¡æ”¹)

å®Œæ•´ç¤ºä¾‹ï¼š
eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.
eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IuW8oOS4iSIsImlhdCI6MTUxNjIzOTAyMn0.
SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c
```

### 3.2 ID Tokençš„å†…å®¹


**ğŸ“‹ æ ‡å‡†å­—æ®µè¯¦è§£**

```json
{
  // æ ¸å¿ƒèº«ä»½å­—æ®µ â­å¿…éœ€
  "iss": "https://idp.example.com",        // é¢å‘è€…ï¼šå“ªä¸ªIdPå‘çš„
  "sub": "248289761001",                    // ä¸»ä½“ï¼šç”¨æˆ·çš„å”¯ä¸€æ ‡è¯†
  "aud": "client123",                       // æ¥æ”¶è€…ï¼šå“ªä¸ªåº”ç”¨ç”¨çš„
  "exp": 1672531200,                        // è¿‡æœŸæ—¶é—´ï¼šä»€ä¹ˆæ—¶å€™å¤±æ•ˆ
  "iat": 1672527600,                        // ç­¾å‘æ—¶é—´ï¼šä»€ä¹ˆæ—¶å€™å‘çš„
  
  // èº«ä»½è®¤è¯å­—æ®µ â­é‡è¦
  "auth_time": 1672527500,                  // è®¤è¯æ—¶é—´ï¼šç”¨æˆ·ä»€ä¹ˆæ—¶å€™ç™»å½•çš„
  "nonce": "n-0S6_WzA2Mj",                  // éšæœºæ•°ï¼šé˜²é‡æ”¾æ”»å‡»
  "acr": "urn:mfa:level2",                  // è®¤è¯ç­‰çº§ï¼šç”¨äº†ä»€ä¹ˆè®¤è¯æ–¹å¼
  "amr": ["pwd", "otp"],                    // è®¤è¯æ–¹æ³•ï¼šå¯†ç +çŸ­ä¿¡éªŒè¯ç 
  
  // ç”¨æˆ·ä¿¡æ¯å­—æ®µ (å¯é€‰)
  "name": "å¼ ä¸‰",                           // å§“å
  "email": "zhangsan@example.com",         // é‚®ç®±
  "email_verified": true,                   // é‚®ç®±æ˜¯å¦éªŒè¯
  "picture": "https://example.com/avatar"   // å¤´åƒ
}
```

**ğŸ’¡ å­—æ®µå«ä¹‰é€šä¿—è§£é‡Š**

| å­—æ®µ | **é€šä¿—å«ä¹‰** | **å®é™…ä½œç”¨** |
|-----|-------------|-------------|
| `iss` | `è¿™ä¸ªè¯ä»¶æ˜¯è°å‘çš„` | `éªŒè¯Tokenæ¥æºæ˜¯å¦å¯ä¿¡` |
| `sub` | `è¿™æ˜¯è°çš„è¯ä»¶` | `ç”¨æˆ·çš„å”¯ä¸€ID` |
| `aud` | `è¿™ä¸ªè¯ä»¶ç»™è°ç”¨çš„` | `é˜²æ­¢Tokenè¢«å…¶ä»–åº”ç”¨ç›—ç”¨` |
| `exp` | `è¯ä»¶ä»€ä¹ˆæ—¶å€™è¿‡æœŸ` | `è¶…è¿‡æ—¶é—´å°±æ— æ•ˆäº†` |
| `nonce` | `é˜²ä¼ªæ ‡è®°` | `ç¡®ä¿Tokenæ˜¯åˆšå‘çš„ï¼Œä¸æ˜¯é‡æ”¾çš„` |

### 3.3 ID TokenéªŒè¯æµç¨‹


**ğŸ” éªŒè¯æ­¥éª¤è¯¦è§£**

```
å®¢æˆ·ç«¯æ”¶åˆ°ID Tokenåå¿…é¡»éªŒè¯ï¼š

æ­¥éª¤1ï¸âƒ£ï¼šéªŒè¯ç­¾å
â”œâ”€ ä»IdPè·å–å…¬é’¥(JWKS)
â”œâ”€ ä½¿ç”¨å…¬é’¥éªŒè¯ç­¾å
â””â”€ ç¡®ä¿Tokenæ²¡è¢«ç¯¡æ”¹

æ­¥éª¤2ï¸âƒ£ï¼šéªŒè¯é¢å‘è€…(iss)
â””â”€ æ£€æŸ¥issæ˜¯å¦æ˜¯é¢„æœŸçš„IdPåœ°å€

æ­¥éª¤3ï¸âƒ£ï¼šéªŒè¯æ¥æ”¶è€…(aud)
â””â”€ æ£€æŸ¥audæ˜¯å¦æ˜¯è‡ªå·±çš„client_id

æ­¥éª¤4ï¸âƒ£ï¼šéªŒè¯æ—¶é—´
â”œâ”€ exp: ç¡®ä¿æ²¡è¿‡æœŸ
â”œâ”€ iat: ç¡®ä¿ä¸æ˜¯æœªæ¥çš„Token
â””â”€ auth_time: éªŒè¯ç™»å½•æ—¶æ•ˆæ€§

æ­¥éª¤5ï¸âƒ£ï¼šéªŒè¯nonce(å¦‚æœæœ‰)
â””â”€ ä¸è¯·æ±‚æ—¶å‘é€çš„nonceå¯¹æ¯”
```

**ğŸ”§ éªŒè¯ä»£ç ç¤ºä¾‹**

```java
// Spring Security OIDCè‡ªåŠ¨éªŒè¯
@Configuration
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) {
        http.oauth2Login()
            .userInfoEndpoint()
            .oidcUserService(this.oidcUserService());
        return http.build();
    }
    
    private OAuth2UserService oidcUserService() {
        // Spring Securityä¼šè‡ªåŠ¨ï¼š
        // 1. éªŒè¯ID Tokenç­¾å
        // 2. æ£€æŸ¥issã€audã€expç­‰å­—æ®µ
        // 3. è§£æç”¨æˆ·ä¿¡æ¯
        return new OidcUserService();
    }
}
```

**âš ï¸ å®‰å…¨æé†’**

> **æ°¸è¿œä¸è¦è·³è¿‡éªŒè¯ï¼** å³ä½¿ID Tokençœ‹èµ·æ¥æ­£å¸¸ï¼Œä¹Ÿå¿…é¡»å®Œæ•´éªŒè¯æ‰€æœ‰å­—æ®µã€‚æ”»å‡»è€…å¯èƒ½ä¼ªé€ æˆ–ç¯¡æ”¹Tokenã€‚

---

## 4. ğŸ“¡ ç”¨æˆ·ä¿¡æ¯ç«¯ç‚¹


### 4.1 UserInfoç«¯ç‚¹çš„ä½œç”¨


**ğŸ¤” ä¸ºä»€ä¹ˆéœ€è¦UserInfoç«¯ç‚¹ï¼Ÿ**

```
å·²ç»æœ‰ID Tokenäº†ï¼Œä¸ºä»€ä¹ˆè¿˜è¦UserInfoï¼Ÿ

åŸå› 1ï¼šID Tokenä½“ç§¯é™åˆ¶
â”œâ”€ ID Tokenè¦åœ¨URLä¼ è¾“ï¼Œä¸èƒ½å¤ªå¤§
â”œâ”€ åªåŒ…å«åŸºç¡€èº«ä»½ä¿¡æ¯
â””â”€ è¯¦ç»†èµ„æ–™é€šè¿‡UserInfoè·å–

åŸå› 2ï¼šåŠ¨æ€ä¿¡æ¯æ›´æ–°
â”œâ”€ ID Tokenç­¾å‘åå†…å®¹å›ºå®š
â”œâ”€ UserInfoå¯ä»¥è¿”å›æœ€æ–°æ•°æ®
â””â”€ æ¯”å¦‚ç”¨æˆ·åˆšæ”¹äº†å¤´åƒ

åŸå› 3ï¼šéšç§ä¿æŠ¤
â”œâ”€ æ•æ„Ÿä¿¡æ¯ä¸æ”¾åœ¨ID Tokené‡Œ
â”œâ”€ éœ€è¦æ—¶æ‰ä»UserInfoè·å–
â””â”€ å‡å°‘ä¿¡æ¯æ³„éœ²é£é™©
```

**ğŸ“Š ä¸¤è€…å¯¹æ¯”**

```
ID Tokenï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åŸºç¡€èº«ä»½ä¿¡æ¯        â”‚
â”‚  âœ“ ç”¨æˆ·ID           â”‚
â”‚  âœ“ å§“å             â”‚
â”‚  âœ“ é‚®ç®±             â”‚
â”‚  âœ— è¯¦ç»†èµ„æ–™          â”‚
â”‚  âœ— åŠ¨æ€æ›´æ–°          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

UserInfoï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®Œæ•´ç”¨æˆ·ä¿¡æ¯        â”‚
â”‚  âœ“ æ‰€æœ‰ID Tokenå­—æ®µ  â”‚
â”‚  âœ“ ç”µè¯å·ç           â”‚
â”‚  âœ“ åœ°å€ä¿¡æ¯          â”‚
â”‚  âœ“ å‡ºç”Ÿæ—¥æœŸ          â”‚
â”‚  âœ“ è‡ªå®šä¹‰å±æ€§        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 UserInfoè¯·æ±‚æ–¹å¼


**ğŸ”— è¯·æ±‚æµç¨‹**

```
æ­¥éª¤1ï¸âƒ£ï¼šè·å–Access Token
å®¢æˆ·ç«¯ â†’ IdPæˆæƒç«¯ç‚¹
      â† è¿”å›access_token + id_token

æ­¥éª¤2ï¸âƒ£ï¼šè¯·æ±‚ç”¨æˆ·ä¿¡æ¯
å®¢æˆ·ç«¯ â†’ UserInfoç«¯ç‚¹(å¸¦access_token)
      â† è¿”å›ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
```

**ğŸ“ å®é™…è¯·æ±‚ç¤ºä¾‹**

```http
GET /userinfo HTTP/1.1
Host: idp.example.com
Authorization: Bearer eyJhbGci...access_token

å“åº”ï¼š
{
  "sub": "248289761001",
  "name": "å¼ ä¸‰",
  "given_name": "ä¸‰",
  "family_name": "å¼ ",
  "email": "zhangsan@example.com",
  "email_verified": true,
  "phone_number": "+86 138-1234-5678",
  "phone_number_verified": true,
  "picture": "https://example.com/avatar/zhangsan.jpg",
  "address": {
    "country": "CN",
    "region": "åŒ—äº¬å¸‚",
    "locality": "æœé˜³åŒº"
  },
  "birthdate": "1990-01-15",
  "updated_at": 1672527600
}
```

### 4.3 Spring Booté›†æˆUserInfo


**ğŸ”§ å®Œæ•´å®ç°**

```java
@Service
public class UserInfoService {
    
    @Autowired
    private OAuth2AuthorizedClientService clientService;
    
    /**
     * è·å–ç”¨æˆ·å®Œæ•´ä¿¡æ¯
     */
    public Map<String, Object> getUserInfo(String username) {
        // 1. è·å–OAuth2å®¢æˆ·ç«¯å’ŒToken
        OAuth2AuthorizedClient client = clientService
            .loadAuthorizedClient("oidc-client", username);
        
        String accessToken = client.getAccessToken().getTokenValue();
        
        // 2. è°ƒç”¨UserInfoç«¯ç‚¹
        RestTemplate restTemplate = new RestTemplate();
        HttpHeaders headers = new HttpHeaders();
        headers.setBearerAuth(accessToken);
        
        HttpEntity<?> entity = new HttpEntity<>(headers);
        
        ResponseEntity<Map> response = restTemplate.exchange(
            "https://idp.example.com/userinfo",
            HttpMethod.GET,
            entity,
            Map.class
        );
        
        return response.getBody();
    }
    
    /**
     * ä½¿ç”¨Spring Security OIDCè‡ªåŠ¨è·å–
     */
    @GetMapping("/user-profile")
    public Map<String, Object> getUserProfile(
        @AuthenticationPrincipal OidcUser oidcUser) {
        
        // Spring Securityå·²ç»è‡ªåŠ¨è°ƒç”¨äº†UserInfoç«¯ç‚¹
        return Map.of(
            "username", oidcUser.getName(),
            "email", oidcUser.getEmail(),
            "claims", oidcUser.getClaims()  // æ‰€æœ‰å£°æ˜
        );
    }
}
```

**ğŸ’¡ è‡ªåŠ¨åŒ–å¤„ç†**

Spring Security OIDCä¼šè‡ªåŠ¨ï¼š
- âœ… åœ¨ç™»å½•æˆåŠŸåè°ƒç”¨UserInfoç«¯ç‚¹
- âœ… å°†ä¿¡æ¯åˆå¹¶åˆ°`OidcUser`å¯¹è±¡ä¸­
- âœ… å¤„ç†Tokenåˆ·æ–°å’Œé‡æ–°è·å–

---

## 5. ğŸ“œ æ ‡å‡†å£°æ˜ä½“ç³»


### 5.1 ä»€ä¹ˆæ˜¯å£°æ˜(Claims)


**ğŸ”¸ é€šä¿—ç†è§£**

```
å£°æ˜(Claims)ï¼š
å°±æ˜¯å…³äºç”¨æˆ·çš„"å±æ€§ä¿¡æ¯"
ç±»æ¯”æˆä¸ªäººæ¡£æ¡ˆä¸­çš„å„ä¸ªå­—æ®µ

ä¾‹å¦‚ï¼š
â€¢ å§“å(name)         â†’ "å¼ ä¸‰"
â€¢ é‚®ç®±(email)        â†’ "zhangsan@example.com"
â€¢ ç”Ÿæ—¥(birthdate)    â†’ "1990-01-15"
```

**ğŸ“š å£°æ˜çš„åˆ†ç±»**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        OIDCæ ‡å‡†å£°æ˜            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                â”‚
â”‚  â‘  æ ¸å¿ƒå£°æ˜                    â”‚
â”‚     sub, iss, aud, exp...      â”‚
â”‚                                â”‚
â”‚  â‘¡ ç”¨æˆ·èµ„æ–™å£°æ˜                â”‚
â”‚     name, email, picture...    â”‚
â”‚                                â”‚
â”‚  â‘¢ åœ°å€å£°æ˜                    â”‚
â”‚     address (ç»“æ„åŒ–å¯¹è±¡)        â”‚
â”‚                                â”‚
â”‚  â‘£ è‡ªå®šä¹‰å£°æ˜                  â”‚
â”‚     roles, department...       â”‚
â”‚                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 æ ‡å‡†Scopeä¸å£°æ˜æ˜ å°„


**ğŸ¯ Scopeçš„ä½œç”¨**

```
Scopeï¼šæ§åˆ¶è¿”å›å“ªäº›å£°æ˜
å°±åƒç‚¹èœï¼š
â€¢ ç‚¹äº†"å¥—é¤A"(profile) â†’ è¿”å›åŸºæœ¬èµ„æ–™
â€¢ ç‚¹äº†"å¥—é¤B"(email)   â†’ è¿”å›é‚®ç®±ä¿¡æ¯
â€¢ ç‚¹äº†"å¥—é¤C"(address) â†’ è¿”å›åœ°å€ä¿¡æ¯
```

**ğŸ“‹ æ ‡å‡†Scopeæ˜ å°„è¡¨**

| Scope | **åŒ…å«çš„å£°æ˜** | **è¯´æ˜** |
|-------|---------------|---------|
| `openid` â­å¿…éœ€ | `sub` | `æœ€åŸºæœ¬çš„ç”¨æˆ·ID` |
| `profile` | `name, family_name, given_name, middle_name, nickname, picture, website, gender, birthdate, locale, updated_at` | `ç”¨æˆ·åŸºæœ¬èµ„æ–™` |
| `email` | `email, email_verified` | `é‚®ç®±ä¿¡æ¯` |
| `address` | `address (å¯¹è±¡)` | `åœ°å€ä¿¡æ¯` |
| `phone` | `phone_number, phone_number_verified` | `ç”µè¯ä¿¡æ¯` |

**ğŸ”§ è¯·æ±‚ç¤ºä¾‹**

```http
GET /authorize?
  response_type=code
  &client_id=client123
  &redirect_uri=https://app.com/callback
  &scope=openid profile email    â† è¯·æ±‚è¿™äº›Scope
  &state=xyz
  &nonce=abc

è¿”å›çš„ID Tokenå’ŒUserInfoå°†åŒ…å«ï¼š
{
  "sub": "248289761001",           // openid
  "name": "å¼ ä¸‰",                   // profile
  "picture": "https://...",        // profile
  "email": "zhangsan@example.com", // email
  "email_verified": true           // email
}
```

### 5.3 è‡ªå®šä¹‰å£°æ˜


**ğŸ¨ ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰å£°æ˜**

```
æ ‡å‡†å£°æ˜ä¸å¤Ÿç”¨çš„åœºæ™¯ï¼š
â€¢ ä¼ä¸šè§’è‰²ï¼šdepartment, position, employee_id
â€¢ æƒé™ä¿¡æ¯ï¼šroles, permissions, groups
â€¢ ä¸šåŠ¡æ•°æ®ï¼švip_level, member_type, credits
```

**ğŸ”§ å®ç°è‡ªå®šä¹‰å£°æ˜**

```java
// Keycloaké…ç½®è‡ªå®šä¹‰å£°æ˜
@Component
public class CustomClaimsMapper implements ProtocolMapper {
    
    @Override
    public void transformAccessToken(AccessToken token, 
                                     UserSessionModel session) {
        UserModel user = session.getUser();
        
        // æ·»åŠ è‡ªå®šä¹‰å£°æ˜
        token.getOtherClaims().put("department", 
            user.getAttribute("department"));
        token.getOtherClaims().put("employee_id", 
            user.getAttribute("employee_id"));
        token.getOtherClaims().put("roles", 
            user.getRoleMappings().stream()
                .map(RoleModel::getName)
                .collect(Collectors.toList()));
    }
}
```

**ğŸ“¦ è¿”å›ç»“æœ**

```json
{
  // æ ‡å‡†å£°æ˜
  "sub": "248289761001",
  "name": "å¼ ä¸‰",
  "email": "zhangsan@example.com",
  
  // è‡ªå®šä¹‰å£°æ˜ â­
  "department": "æŠ€æœ¯éƒ¨",
  "employee_id": "EMP2024001",
  "roles": ["developer", "team_lead"],
  "vip_level": 3
}
```

---

## 6. ğŸš€ OIDCå®Œæ•´å®ç°


### 6.1 æ•´ä½“æ¶æ„æµç¨‹


**ğŸ—ï¸ ç³»ç»Ÿæ¶æ„å›¾**

```
                   OIDCè®¤è¯æµç¨‹
                   
ç”¨æˆ·æµè§ˆå™¨              åº”ç”¨ç³»ç»Ÿ           èº«ä»½æä¾›å•†(IdP)
    |                    |                      |
    |--1.è®¿é—®å—ä¿æŠ¤èµ„æº-->|                      |
    |                    |                      |
    |<--2.é‡å®šå‘åˆ°IdP-----|                      |
    |   (å¸¦scope=openid profile email)          |
    |                    |                      |
    |------------3.ç”¨æˆ·ç™»å½•---------------------->|
    |                    |   (è¾“å…¥è´¦å·å¯†ç )      |
    |                    |                      |
    |<-----------4.æˆæƒç¡®è®¤----------------------|
    |                    |   (åŒæ„æˆæƒ)          |
    |                    |                      |
    |--5.å›è°ƒå¸¦code----->|                      |
    |                    |                      |
    |                    |---6.codeæ¢token----->|
    |                    |                      |
    |                    |<--7.è¿”å›tokens-------|
    |                    |  (id_token + access_token)
    |                    |                      |
    |                    |---8.éªŒè¯id_token---->|
    |                    |  (éªŒè¯ç­¾åã€issã€aud) |
    |                    |                      |
    |                    |---9.è·å–UserInfo---->|
    |                    |  (å¸¦access_token)    |
    |                    |                      |
    |                    |<--10.è¿”å›ç”¨æˆ·ä¿¡æ¯----|
    |                    |                      |
    |<--11.ç™»å½•æˆåŠŸ------|                      |
    |   (åˆ›å»ºæœ¬åœ°ä¼šè¯)    |                      |
```

### 6.2 Spring Bootå®Œæ•´é…ç½®


**ğŸ“ ä¾èµ–é…ç½®**

```xml
<dependencies>
    <!-- Spring Security OIDC -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-oauth2-client</artifactId>
    </dependency>
</dependencies>
```

**âš™ï¸ application.ymlé…ç½®**

```yaml
spring:
  security:
    oauth2:
      client:
        registration:
          keycloak:
            # å®¢æˆ·ç«¯åŸºæœ¬ä¿¡æ¯
            client-id: my-app
            client-secret: secret-key
            scope:
              - openid           # å¿…éœ€ï¼šè·å–ID Token
              - profile          # è·å–ç”¨æˆ·èµ„æ–™
              - email            # è·å–é‚®ç®±ä¿¡æ¯
            
            # æˆæƒæ–¹å¼
            authorization-grant-type: authorization_code
            redirect-uri: "{baseUrl}/login/oauth2/code/{registrationId}"
            
        provider:
          keycloak:
            # IdPç«¯ç‚¹é…ç½®
            issuer-uri: https://idp.example.com/realms/my-realm
            # Springä¼šè‡ªåŠ¨ä»issuer-uriå‘ç°ä»¥ä¸‹ç«¯ç‚¹ï¼š
            # - authorization-uri: /protocol/openid-connect/auth
            # - token-uri: /protocol/openid-connect/token
            # - user-info-uri: /protocol/openid-connect/userinfo
            # - jwk-set-uri: /protocol/openid-connect/certs
```

**ğŸ” Securityé…ç½®ç±»**

```java
@Configuration
@EnableWebSecurity
public class OidcSecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/", "/public/**").permitAll()
                .anyRequest().authenticated()
            )
            .oauth2Login(oauth2 -> oauth2
                .userInfoEndpoint(userInfo -> userInfo
                    .oidcUserService(this.oidcUserService())
                )
            )
            .logout(logout -> logout
                .logoutSuccessUrl("/")
            );
        
        return http.build();
    }
    
    /**
     * è‡ªå®šä¹‰OIDCç”¨æˆ·æœåŠ¡
     */
    @Bean
    public OAuth2UserService<OidcUserRequest, OidcUser> oidcUserService() {
        OidcUserService delegate = new OidcUserService();
        
        return (userRequest) -> {
            // 1. è·å–ç”¨æˆ·ä¿¡æ¯
            OidcUser oidcUser = delegate.loadUser(userRequest);
            
            // 2. æå–å’Œå¤„ç†å£°æ˜
            Map<String, Object> claims = oidcUser.getClaims();
            String email = (String) claims.get("email");
            List<String> roles = (List<String>) claims.get("roles");
            
            // 3. æ„å»ºæƒé™
            Set<GrantedAuthority> authorities = new HashSet<>();
            authorities.add(new SimpleGrantedAuthority("ROLE_USER"));
            if (roles != null) {
                roles.forEach(role -> 
                    authorities.add(new SimpleGrantedAuthority("ROLE_" + role))
                );
            }
            
            // 4. è¿”å›å¢å¼ºçš„ç”¨æˆ·å¯¹è±¡
            return new DefaultOidcUser(authorities, oidcUser.getIdToken(), 
                                      oidcUser.getUserInfo());
        };
    }
}
```

### 6.3 ä½¿ç”¨OIDCç”¨æˆ·ä¿¡æ¯


**ğŸ¯ Controllerä¸­è·å–ç”¨æˆ·**

```java
@RestController
@RequestMapping("/api")
public class UserController {
    
    /**
     * æ–¹å¼1ï¼šé€šè¿‡@AuthenticationPrincipalæ³¨è§£
     */
    @GetMapping("/user-info")
    public Map<String, Object> getUserInfo(
        @AuthenticationPrincipal OidcUser oidcUser) {
        
        return Map.of(
            // ID Tokenä¸­çš„å£°æ˜
            "userId", oidcUser.getSubject(),
            "username", oidcUser.getFullName(),
            "email", oidcUser.getEmail(),
            
            // è‡ªå®šä¹‰å£°æ˜
            "department", oidcUser.getClaim("department"),
            "roles", oidcUser.getClaim("roles"),
            
            // æ‰€æœ‰å£°æ˜
            "allClaims", oidcUser.getClaims()
        );
    }
    
    /**
     * æ–¹å¼2ï¼šé€šè¿‡Security Context
     */
    @GetMapping("/current-user")
    public String getCurrentUser() {
        Authentication auth = SecurityContextHolder.getContext()
                                .getAuthentication();
        OidcUser user = (OidcUser) auth.getPrincipal();
        return user.getFullName();
    }
    
    /**
     * è·å–ID Token
     */
    @GetMapping("/id-token")
    public Map<String, Object> getIdToken(
        @AuthenticationPrincipal OidcUser oidcUser) {
        
        OidcIdToken idToken = oidcUser.getIdToken();
        
        return Map.of(
            "tokenValue", idToken.getTokenValue(),
            "issuedAt", idToken.getIssuedAt(),
            "expiresAt", idToken.getExpiresAt(),
            "claims", idToken.getClaims()
        );
    }
}
```

### 6.4 TokenéªŒè¯æœ€ä½³å®è·µ


**âœ… éªŒè¯æ£€æŸ¥æ¸…å•**

```java
@Component
public class IdTokenValidator {
    
    @Value("${spring.security.oauth2.client.provider.keycloak.issuer-uri}")
    private String expectedIssuer;
    
    @Value("${spring.security.oauth2.client.registration.keycloak.client-id}")
    private String expectedClientId;
    
    /**
     * æ‰‹åŠ¨éªŒè¯ID Tokenï¼ˆSpring Securityå·²è‡ªåŠ¨å¤„ç†ï¼‰
     */
    public boolean validateIdToken(OidcIdToken idToken) {
        
        // 1ï¸âƒ£ éªŒè¯ç­¾åï¼ˆSpring Securityè‡ªåŠ¨å®Œæˆï¼‰
        // å·²é€šè¿‡JWK SetéªŒè¯
        
        // 2ï¸âƒ£ éªŒè¯é¢å‘è€…
        if (!expectedIssuer.equals(idToken.getIssuer().toString())) {
            log.error("Invalid issuer: {}", idToken.getIssuer());
            return false;
        }
        
        // 3ï¸âƒ£ éªŒè¯æ¥æ”¶è€…
        if (!idToken.getAudience().contains(expectedClientId)) {
            log.error("Invalid audience: {}", idToken.getAudience());
            return false;
        }
        
        // 4ï¸âƒ£ éªŒè¯è¿‡æœŸæ—¶é—´
        if (idToken.getExpiresAt().isBefore(Instant.now())) {
            log.error("Token expired at: {}", idToken.getExpiresAt());
            return false;
        }
        
        // 5ï¸âƒ£ éªŒè¯ç­¾å‘æ—¶é—´
        if (idToken.getIssuedAt().isAfter(Instant.now())) {
            log.error("Token issued in future: {}", idToken.getIssuedAt());
            return false;
        }
        
        // 6ï¸âƒ£ éªŒè¯nonceï¼ˆé˜²é‡æ”¾ï¼‰
        String nonce = idToken.getNonce();
        if (nonce != null && !isValidNonce(nonce)) {
            log.error("Invalid nonce: {}", nonce);
            return false;
        }
        
        return true;
    }
    
    private boolean isValidNonce(String nonce) {
        // ä»ä¼šè¯æˆ–ç¼“å­˜ä¸­éªŒè¯nonce
        // ç¡®ä¿è¿™ä¸ªnonceæ˜¯ä¹‹å‰è¯·æ±‚æ—¶ç”Ÿæˆçš„
        return true; // å®é™…å®ç°éœ€è¦éªŒè¯é€»è¾‘
    }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„å…³é”®æ¦‚å¿µ


**ğŸ¯ æ ¸å¿ƒç†è§£**

```
OIDC = OAuth2.0 + èº«ä»½è®¤è¯
â”œâ”€ ä¸ä»…çŸ¥é“"æˆæƒ"ï¼Œè¿˜çŸ¥é“"æ˜¯è°"
â”œâ”€ é€šè¿‡ID Tokenä¼ é€’èº«ä»½ä¿¡æ¯
â””â”€ å®Œå…¨å…¼å®¹OAuth2.0æµç¨‹
```

**ğŸ”‘ äº”å¤§æ ¸å¿ƒè¦ç´ **

| è¦ç´  | **ä½œç”¨** | **å…³é”®ç‚¹** |
|-----|---------|-----------|
| `èº«ä»½æä¾›å•†(IdP)` | `éªŒè¯èº«ä»½ã€é¢å‘Token` | `ç±»æ¯”èº«ä»½è¯åŠç†ä¸­å¿ƒ` |
| `ID Token` | `åŒ…å«ç”¨æˆ·èº«ä»½ä¿¡æ¯çš„JWT` | `å¿…é¡»éªŒè¯ç­¾åå’Œå£°æ˜` |
| `UserInfoç«¯ç‚¹` | `è·å–è¯¦ç»†ç”¨æˆ·ä¿¡æ¯` | `ç”¨access_tokenè®¿é—®` |
| `æ ‡å‡†å£°æ˜` | `ç”¨æˆ·å±æ€§ä¿¡æ¯` | `é€šè¿‡scopeæ§åˆ¶è¿”å›` |
| `TokenéªŒè¯` | `ç¡®ä¿TokençœŸå®æœ‰æ•ˆ` | `éªŒè¯issã€audã€expç­‰` |

### 7.2 å®è·µè¦ç‚¹


**âœ… å¼€å‘æ£€æŸ¥æ¸…å•**

```
é…ç½®é˜¶æ®µï¼š
â˜‘ï¸ åœ¨IdPæ³¨å†Œåº”ç”¨ï¼Œè·å–client_id/secret
â˜‘ï¸ é…ç½®redirect_uriå›è°ƒåœ°å€
â˜‘ï¸ è®¾ç½®æ­£ç¡®çš„scope (å¿…å«openid)

å®ç°é˜¶æ®µï¼š
â˜‘ï¸ ä½¿ç”¨Spring Security OIDCç®€åŒ–å¼€å‘
â˜‘ï¸ è‡ªå®šä¹‰OidcUserServiceå¤„ç†ç”¨æˆ·ä¿¡æ¯
â˜‘ï¸ æå–claimsæ„å»ºåº”ç”¨æƒé™

å®‰å…¨é˜¶æ®µï¼š
â˜‘ï¸ å§‹ç»ˆéªŒè¯ID Tokenç­¾å
â˜‘ï¸ æ£€æŸ¥issã€audã€expç­‰å…³é”®å­—æ®µ
â˜‘ï¸ ä½¿ç”¨HTTPSä¿æŠ¤é€šä¿¡
â˜‘ï¸ å®‰å…¨å­˜å‚¨client_secret
```

**âš ï¸ å¸¸è§é™·é˜±**

```
âŒ è·³è¿‡TokenéªŒè¯ï¼šè®¤ä¸ºIdPè¿”å›çš„å°±æ˜¯å®‰å…¨çš„
   âœ… å¿…é¡»éªŒè¯ç­¾åå’Œæ‰€æœ‰å…³é”®å­—æ®µ

âŒ æ··æ·†ID Tokenå’ŒAccess Tokenï¼š
   âœ… ID Tokenç”¨äºèº«ä»½è¯†åˆ«
   âœ… Access Tokenç”¨äºè®¿é—®èµ„æº

âŒ åœ¨å‰ç«¯å­˜å‚¨ID Tokenï¼š
   âœ… æ•æ„Ÿä¿¡æ¯åº”åœ¨åç«¯å¤„ç†
   âœ… å‰ç«¯åªå­˜å‚¨ä¼šè¯æ ‡è¯†

âŒ å¿½ç•¥Tokenè¿‡æœŸï¼š
   âœ… å®ç°Tokenåˆ·æ–°æœºåˆ¶
   âœ… è¿‡æœŸåå¼•å¯¼ç”¨æˆ·é‡æ–°ç™»å½•
```

### 7.3 åœºæ™¯åº”ç”¨æ€»ç»“


**ğŸ“Š é€‚ç”¨åœºæ™¯**

```
âœ… å•ç‚¹ç™»å½•(SSO)
   â†’ ä¸€æ¬¡ç™»å½•ï¼Œå¤šç³»ç»Ÿè®¿é—®
   
âœ… ç¬¬ä¸‰æ–¹ç™»å½•
   â†’ ç”¨Google/å¾®ä¿¡è´¦å·ç™»å½•åº”ç”¨
   
âœ… å¾®æœåŠ¡è®¤è¯
   â†’ ç½‘å…³éªŒè¯èº«ä»½ï¼ŒæœåŠ¡é—´ä¼ é€’ç”¨æˆ·ä¿¡æ¯
   
âœ… ç§»åŠ¨åº”ç”¨
   â†’ Appé€šè¿‡OIDCè·å–ç”¨æˆ·èº«ä»½
```

**ğŸ”„ ä¸OAuth2.0çš„é€‰æ‹©**

```
é€‰æ‹©OIDCå½“ï¼š
â€¢ éœ€è¦çŸ¥é“ç”¨æˆ·æ˜¯è°
â€¢ éœ€è¦ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ï¼ˆå§“åã€é‚®ç®±ç­‰ï¼‰
â€¢ å®ç°å•ç‚¹ç™»å½•
â€¢ éœ€è¦æ ‡å‡†åŒ–çš„èº«ä»½è®¤è¯

é€‰æ‹©OAuth2.0å½“ï¼š
â€¢ åªéœ€è¦è®¿é—®èµ„æºæƒé™
â€¢ ä¸å…³å¿ƒç”¨æˆ·èº«ä»½
â€¢ ç¬¬ä¸‰æ–¹æˆæƒåœºæ™¯ï¼ˆå¦‚æˆæƒè®¿é—®ç…§ç‰‡ï¼‰
```

### 7.4 è®°å¿†å£è¯€


```
ğŸ¯ OIDCå­¦ä¹ è¦ç‚¹ï¼š

OAuthåŠ èº«ä»½ï¼ŒOIDCæ¥å®ç°
ID Tokenæ ¸å¿ƒï¼ŒJWTæ ¼å¼è§
èº«ä»½æä¾›å•†ï¼ŒIdPæ˜¯å…³é”®
UserInfoç«¯ç‚¹ï¼Œè¯¦ç»†ä¿¡æ¯å…¨

å¿…éœ€openidï¼Œscopeè¦è®°ç‰¢
iss aud expï¼ŒéªŒè¯ä¸èƒ½å°‘
æ ‡å‡†å£°æ˜å¤šï¼Œè‡ªå®šä¹‰ä¹Ÿå¥½
Spring Securityï¼Œé›†æˆçœŸé«˜æ•ˆ

Tokenè¦éªŒè¯ï¼Œç­¾åç¬¬ä¸€æ¡
è¿‡æœŸæ—¶é—´æŸ¥ï¼Œå®‰å…¨æœ€é‡è¦
å‰ç«¯åˆ«å­˜å‚¨ï¼Œåç«¯æ¥å¤„ç†
å•ç‚¹ç™»å½•å¼ºï¼Œç”¨æˆ·ä½“éªŒå¥½
```

---

**ğŸ“ å­¦ä¹ å»ºè®®**

1. **å¾ªåºæ¸è¿›**ï¼šå…ˆæŒæ¡OAuth2.0åŸºç¡€ï¼Œå†å­¦OIDCæ‰©å±•
2. **åŠ¨æ‰‹å®è·µ**ï¼šæ­å»ºKeycloakæµ‹è¯•ç¯å¢ƒï¼Œå®é™…æ“ä½œ
3. **é‡è§†å®‰å…¨**ï¼šTokenéªŒè¯æ˜¯æ ¸å¿ƒï¼Œä¸å¯çœç•¥
4. **ç†è§£åŸç†**ï¼šçŸ¥é“ä¸ºä»€ä¹ˆéœ€è¦OIDCï¼Œè€Œä¸ä»…æ˜¯å¦‚ä½•ç”¨

**ğŸ“š æ‰©å±•å­¦ä¹ **

- OIDC Discoveryï¼šè‡ªåŠ¨å‘ç°IdPé…ç½®ç«¯ç‚¹
- OIDC Session Managementï¼šä¼šè¯ç®¡ç†å’Œå•ç‚¹ç™»å‡º
- OIDC Dynamic Registrationï¼šåŠ¨æ€å®¢æˆ·ç«¯æ³¨å†Œ
- PKCEå¢å¼ºï¼šç§»åŠ¨åº”ç”¨å®‰å…¨å¢å¼º