---
title: 4ã€Tokenä¼ æ’­æ¨¡å¼
---
## ğŸ“š ç›®å½•

1. [ä»€ä¹ˆæ˜¯Tokenä¼ æ’­](#1-ä»€ä¹ˆæ˜¯Tokenä¼ æ’­)
2. [Tokenä¼ æ’­çš„æ ¸å¿ƒé—®é¢˜](#2-Tokenä¼ æ’­çš„æ ¸å¿ƒé—®é¢˜)
3. [è¯·æ±‚å¤´ä¼ é€’æ¨¡å¼](#3-è¯·æ±‚å¤´ä¼ é€’æ¨¡å¼)
4. [çº¿ç¨‹ä¸Šä¸‹æ–‡ä¼ é€’](#4-çº¿ç¨‹ä¸Šä¸‹æ–‡ä¼ é€’)
5. [ä¸Šä¸‹æ–‡ä¼ æ’­æœºåˆ¶](#5-ä¸Šä¸‹æ–‡ä¼ æ’­æœºåˆ¶)
6. [ä¼ æ’­æ¨¡å¼å¯¹æ¯”](#6-ä¼ æ’­æ¨¡å¼å¯¹æ¯”)
7. [å®æˆ˜åœºæ™¯åº”ç”¨](#7-å®æˆ˜åœºæ™¯åº”ç”¨)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ ä»€ä¹ˆæ˜¯Tokenä¼ æ’­


### 1.1 é€šä¿—ç†è§£Tokenä¼ æ’­


æŠŠTokenä¼ æ’­æƒ³è±¡æˆä¸€ä¸ª**æ¥åŠ›èµ›**çš„è¿‡ç¨‹ï¼š

```
ç°å®åœºæ™¯ï¼šç½‘è´­ä¸‹å•

ç”¨æˆ·ä¸‹å• â†’ è®¢å•æœåŠ¡ â†’ åº“å­˜æœåŠ¡ â†’ æ”¯ä»˜æœåŠ¡ â†’ ç‰©æµæœåŠ¡
   ğŸ«         ğŸ«          ğŸ«         ğŸ«         ğŸ«
 (å¸¦Token)  (éœ€è¦Token) (éœ€è¦Token)(éœ€è¦Token)(éœ€è¦Token)

æ ¸å¿ƒé—®é¢˜ï¼š
- ç”¨æˆ·åªç™»å½•ä¸€æ¬¡ï¼Œè·å¾—ä¸€ä¸ªTokenï¼ˆå…¥åœºåˆ¸ï¼‰
- ä½†åç»­æ¯ä¸ªæœåŠ¡éƒ½éœ€è¦è¿™ä¸ªTokenæ¥éªŒè¯èº«ä»½
- Tokenå¦‚ä½•åœ¨è¿™æ¡æœåŠ¡é“¾ä¸­"ä¼ æ’­"ä¸‹å»ï¼Ÿ

è¿™å°±æ˜¯Tokenä¼ æ’­è¦è§£å†³çš„é—®é¢˜ï¼
```

### 1.2 Tokenä¼ æ’­çš„æœ¬è´¨


**Tokenä¼ æ’­çš„æ ¸å¿ƒå«ä¹‰**ï¼š

```
ğŸ”¸ æ˜¯ä»€ä¹ˆï¼š
Tokenä»ä¸€ä¸ªæœåŠ¡ä¼ é€’åˆ°å¦ä¸€ä¸ªæœåŠ¡çš„è¿‡ç¨‹å’Œæœºåˆ¶

ğŸ”¸ åšä»€ä¹ˆï¼š
ä¿è¯ç”¨æˆ·èº«ä»½ä¿¡æ¯åœ¨æ•´ä¸ªè°ƒç”¨é“¾è·¯ä¸­éƒ½æœ‰æ•ˆ

ğŸ”¸ ä¸ºä»€ä¹ˆé‡è¦ï¼š
- é¿å…ç”¨æˆ·é‡å¤ç™»å½•
- ä¿æŒæƒé™çš„ä¸€è‡´æ€§
- å®ç°å®Œæ•´çš„è°ƒç”¨é“¾è¿½è¸ª
```

### 1.3 Tokenä¼ æ’­çš„ç”Ÿæ´»ç±»æ¯”


```
ğŸ“® Tokenä¼ æ’­ = å¯„å¿«é€’çš„è¿‡ç¨‹

åœºæ™¯ï¼šä½ è¦ä»åŒ—äº¬å¯„åŒ…è£¹åˆ°ä¸Šæµ·

åŒ—äº¬(å‘ä»¶) â†’ åˆ†æ‹£ä¸­å¿ƒ â†’ ä¸­è½¬ç«™ â†’ æ´¾é€ç«™ â†’ ä¸Šæµ·(æ”¶ä»¶)
   ğŸ“¦          ğŸ“¦        ğŸ“¦       ğŸ“¦        ğŸ“¦
(åŸå§‹åŒ…è£¹)  (è½¬è¿)    (è½¬è¿)   (è½¬è¿)   (é€è¾¾)

å…³é”®ç‚¹ï¼š
1. åŒ…è£¹ä¿¡æ¯ä¸€ç›´è·Ÿéšï¼ˆTokenæ•°æ®ï¼‰
2. æ¯ä¸ªç¯èŠ‚éƒ½è¦éªŒè¯ï¼ˆTokenéªŒè¯ï¼‰
3. ä¸èƒ½ä¸­é€”ä¸¢å¤±ï¼ˆä¼ æ’­æœºåˆ¶ï¼‰
4. æœ€ç»ˆé€è¾¾ç›®çš„åœ°ï¼ˆå®Œæˆä¸šåŠ¡ï¼‰

Tokenä¼ æ’­ä¹Ÿæ˜¯åŒæ ·çš„é“ç†ï¼
```

---

## 2. âš ï¸ Tokenä¼ æ’­çš„æ ¸å¿ƒé—®é¢˜


### 2.1 å®é™…åœºæ™¯ä¸­çš„é—®é¢˜


**åœºæ™¯1ï¼šåŒæ­¥è°ƒç”¨é—®é¢˜**

```
é—®é¢˜æè¿°ï¼š
è®¢å•æœåŠ¡ --è°ƒç”¨--> åº“å­˜æœåŠ¡

è®¢å•æœåŠ¡ä»£ç ï¼š
String token = request.getHeader("Authorization");
// è°ƒç”¨åº“å­˜æœåŠ¡æ—¶ï¼ŒTokenæ€ä¹ˆä¼ è¿‡å»ï¼Ÿ
inventoryService.checkStock(productId);

åº“å­˜æœåŠ¡æ”¶åˆ°è¯·æ±‚ï¼š
// Tokenåœ¨å“ªé‡Œï¼Ÿæ€ä¹ˆæ‹¿åˆ°ï¼Ÿ
String token = ??? 
```

**åœºæ™¯2ï¼šå¼‚æ­¥è°ƒç”¨é—®é¢˜**

```
é—®é¢˜æè¿°ï¼š
è®¢å•æœåŠ¡ --å¼‚æ­¥--> é€šçŸ¥æœåŠ¡

@Async
public void sendNotification() {
    // å¼‚æ­¥çº¿ç¨‹ä¸­ï¼ŒTokenè¿˜åœ¨å—ï¼Ÿ
    String token = ???
    notificationService.send(token, message);
}

æ ¸å¿ƒé—®é¢˜ï¼šä¸»çº¿ç¨‹çš„Tokenï¼Œå¼‚æ­¥çº¿ç¨‹æ‹¿ä¸åˆ°ï¼
```

**åœºæ™¯3ï¼šå¤šå±‚è°ƒç”¨é—®é¢˜**

```
è°ƒç”¨é“¾è·¯ï¼š
ç”¨æˆ· â†’ è®¢å•æœåŠ¡ â†’ åº“å­˜æœåŠ¡ â†’ ä»“å‚¨æœåŠ¡ â†’ ç‰©æµæœåŠ¡

é—®é¢˜ï¼š
- Tokenåœ¨ç¬¬ä¸€å±‚ä¼ é€’æˆåŠŸ
- ç¬¬äºŒå±‚å¯èƒ½ä¸¢å¤±
- ç¬¬ä¸‰å±‚å®Œå…¨æ²¡æœ‰
- å¯¼è‡´è°ƒç”¨å¤±è´¥

åŸå› ï¼šæ¯ä¸€å±‚éƒ½éœ€è¦æ‰‹åŠ¨ä¼ é€’Tokenï¼Œå®¹æ˜“é—æ¼
```

### 2.2 Tokenä¼ æ’­è¦è§£å†³çš„ä¸‰å¤§éš¾é¢˜


| éš¾é¢˜ç±»å‹ | **å…·ä½“é—®é¢˜** | **å½±å“** | **è§£å†³æ€è·¯** |
|---------|------------|---------|------------|
| ğŸ”¸ **åŒæ­¥ä¼ æ’­** | `æœåŠ¡é—´è°ƒç”¨Tokenä¸¢å¤±` | `è®¤è¯å¤±è´¥ï¼Œè°ƒç”¨ä¸­æ–­` | `è¯·æ±‚å¤´è‡ªåŠ¨ä¼ é€’` |
| ğŸ”¸ **å¼‚æ­¥ä¼ æ’­** | `å¼‚æ­¥çº¿ç¨‹æ— æ³•è·å–Token` | `åå°ä»»åŠ¡æ— æƒé™æ‰§è¡Œ` | `çº¿ç¨‹ä¸Šä¸‹æ–‡ä¼ é€’` |
| ğŸ”¸ **é“¾è·¯ä¼ æ’­** | `å¤šå±‚è°ƒç”¨Tokené€å±‚ä¸¢å¤±` | `è°ƒç”¨é“¾æ–­è£‚ï¼Œä¸šåŠ¡å¤±è´¥` | `ä¸Šä¸‹æ–‡è‡ªåŠ¨ä¼ æ’­` |

---

## 3. ğŸ“¡ è¯·æ±‚å¤´ä¼ é€’æ¨¡å¼


### 3.1 ä»€ä¹ˆæ˜¯è¯·æ±‚å¤´ä¼ é€’


**é€šä¿—è§£é‡Š**ï¼šæŠŠTokenæ”¾åœ¨HTTPè¯·æ±‚çš„"ä¿¡å°"ä¸Š

```
HTTPè¯·æ±‚ = ä¸€å°ä¿¡

ä¿¡å°(è¯·æ±‚å¤´)ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ To: http://inventory-serviceâ”‚
â”‚ From: order-service         â”‚
â”‚ Authorization: Bearer xxx   â”‚ â† Tokenåœ¨è¿™é‡Œï¼
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¿¡ä»¶å†…å®¹(è¯·æ±‚ä½“)ï¼š
{
  "productId": "12345",
  "quantity": 2
}

æ ¸å¿ƒï¼šTokenåƒ"å¯„ä»¶äººä¿¡æ¯"ä¸€æ ·ï¼Œè´´åœ¨ä¿¡å°ä¸Š
```

### 3.2 è¯·æ±‚å¤´ä¼ é€’çš„å®ç°æ–¹å¼


**æ–¹å¼1ï¼šæ‰‹åŠ¨ä¼ é€’ï¼ˆä¸æ¨èï¼‰**

```java
@Service
public class OrderService {
    
    @Autowired
    private RestTemplate restTemplate;
    
    public void createOrder(OrderDTO order) {
        // ğŸ”¸ Step1: è·å–å½“å‰è¯·æ±‚çš„Token
        ServletRequestAttributes attrs = 
            (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        String token = attrs.getRequest().getHeader("Authorization");
        
        // ğŸ”¸ Step2: æ‰‹åŠ¨è®¾ç½®è¯·æ±‚å¤´
        HttpHeaders headers = new HttpHeaders();
        headers.set("Authorization", token);
        
        // ğŸ”¸ Step3: åˆ›å»ºè¯·æ±‚å®ä½“
        HttpEntity<OrderDTO> request = new HttpEntity<>(order, headers);
        
        // ğŸ”¸ Step4: å‘é€è¯·æ±‚
        restTemplate.postForObject(
            "http://inventory-service/api/check",
            request,
            String.class
        );
    }
}
```

**æ–¹å¼2ï¼šæ‹¦æˆªå™¨è‡ªåŠ¨ä¼ é€’ï¼ˆæ¨èï¼‰**

```java
/**
 * Tokenè‡ªåŠ¨ä¼ é€’æ‹¦æˆªå™¨
 * 
 * ä½œç”¨ï¼šè‡ªåŠ¨ä»å½“å‰è¯·æ±‚ä¸­æå–Tokenï¼Œæ·»åŠ åˆ°ä¸‹æ¸¸è¯·æ±‚
 */
@Component
public class TokenPropagationInterceptor implements ClientHttpRequestInterceptor {
    
    @Override
    public ClientHttpResponse intercept(
            HttpRequest request, 
            byte[] body, 
            ClientHttpRequestExecution execution) throws IOException {
        
        // ğŸ”¸ è‡ªåŠ¨è·å–å½“å‰Token
        String token = getCurrentToken();
        
        // ğŸ”¸ è‡ªåŠ¨æ·»åŠ åˆ°è¯·æ±‚å¤´
        if (token != null) {
            request.getHeaders().set("Authorization", token);
        }
        
        return execution.execute(request, body);
    }
    
    private String getCurrentToken() {
        ServletRequestAttributes attrs = 
            (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        
        if (attrs != null) {
            return attrs.getRequest().getHeader("Authorization");
        }
        return null;
    }
}
```

### 3.3 è¯·æ±‚å¤´ä¼ é€’çš„å·¥ä½œæµç¨‹


```
è¯·æ±‚å¤´ä¼ é€’å·¥ä½œæµç¨‹ï¼š

ç”¨æˆ·è¯·æ±‚
   â†“
[è®¢å•æœåŠ¡]
   â”œâ”€ æ”¶åˆ°è¯·æ±‚ï¼šAuthorization: Bearer token123
   â”œâ”€ æ‹¦æˆªå™¨æå–ï¼štoken123
   â”œâ”€ å‡†å¤‡è°ƒç”¨åº“å­˜æœåŠ¡
   â”‚
   â†“ è°ƒç”¨
[åº“å­˜æœåŠ¡]
   â”œâ”€ è¯·æ±‚å¤´è‡ªåŠ¨æºå¸¦ï¼šAuthorization: Bearer token123
   â”œâ”€ éªŒè¯Tokenï¼štoken123 âœ“
   â”œâ”€ å¤„ç†ä¸šåŠ¡
   â”œâ”€ å‡†å¤‡è°ƒç”¨ä»“å‚¨æœåŠ¡
   â”‚
   â†“ è°ƒç”¨  
[ä»“å‚¨æœåŠ¡]
   â”œâ”€ è¯·æ±‚å¤´è‡ªåŠ¨æºå¸¦ï¼šAuthorization: Bearer token123
   â”œâ”€ éªŒè¯Tokenï¼štoken123 âœ“
   â””â”€ è¿”å›ç»“æœ

æ ¸å¿ƒï¼šæ‹¦æˆªå™¨åœ¨æ¯æ¬¡è°ƒç”¨æ—¶ï¼Œè‡ªåŠ¨æŠŠTokenåŠ åˆ°è¯·æ±‚å¤´
```

### 3.4 è¯·æ±‚å¤´ä¼ é€’çš„ä¼˜ç¼ºç‚¹


```
âœ… ä¼˜ç‚¹ï¼š
- å®ç°ç®€å•ï¼Œç¬¦åˆHTTPæ ‡å‡†
- æ— éœ€é¢å¤–é…ç½®ï¼Œç›´æ¥ç”¨è¯·æ±‚å¤´
- æ€§èƒ½å¼€é”€å°ï¼Œä¸å ç”¨é¢å¤–èµ„æº

âŒ ç¼ºç‚¹ï¼š
- åªé€‚ç”¨äºHTTPè°ƒç”¨
- å¼‚æ­¥åœºæ™¯æ— æ³•ä½¿ç”¨
- éœ€è¦æ‹¦æˆªå™¨æ”¯æŒ
```

---

## 4. ğŸ§µ çº¿ç¨‹ä¸Šä¸‹æ–‡ä¼ é€’


### 4.1 ä»€ä¹ˆæ˜¯çº¿ç¨‹ä¸Šä¸‹æ–‡


**çº¿ç¨‹ä¸Šä¸‹æ–‡ç†è§£**ï¼šæ¯ä¸ªçº¿ç¨‹çš„"ç§æœ‰ç¬”è®°æœ¬"

```
æƒ³è±¡ä¸€ä¸ªåŠå…¬å®¤åœºæ™¯ï¼š

ä¸»çº¿ç¨‹(ä¸»åŠå…¬å®¤)ï¼š
- å‘˜å·¥Açš„ç¬”è®°æœ¬ï¼šè®°å½•äº†Tokenã€ç”¨æˆ·ä¿¡æ¯
- è¿™äº›ä¿¡æ¯åªæœ‰å‘˜å·¥Aèƒ½çœ‹åˆ°

å¼‚æ­¥çº¿ç¨‹(åˆ†åŠå…¬å®¤)ï¼š  
- å‘˜å·¥Bçš„ç¬”è®°æœ¬ï¼šç©ºçš„ï¼Œæ²¡æœ‰Tokenä¿¡æ¯
- å‘˜å·¥Bçœ‹ä¸åˆ°å‘˜å·¥Açš„ç¬”è®°æœ¬

é—®é¢˜ï¼š
å‘˜å·¥Béœ€è¦Tokenæ‰èƒ½å·¥ä½œï¼Œä½†ä»–çš„ç¬”è®°æœ¬æ˜¯ç©ºçš„ï¼

è§£å†³ï¼š
æŠŠå‘˜å·¥Açš„ç¬”è®°æœ¬å†…å®¹å¤åˆ¶ç»™å‘˜å·¥B
â†’ è¿™å°±æ˜¯çº¿ç¨‹ä¸Šä¸‹æ–‡ä¼ é€’
```

### 4.2 ThreadLocalçš„ä½œç”¨


**ThreadLocalåŸç†**ï¼šçº¿ç¨‹çš„ç§æœ‰å˜é‡å­˜å‚¨

```java
/**
 * ThreadLocalï¼šä¸ºæ¯ä¸ªçº¿ç¨‹å­˜å‚¨ç‹¬ç«‹çš„æ•°æ®
 */
public class TokenHolder {
    
    // ğŸ”¸ æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„Tokenå‰¯æœ¬
    private static final ThreadLocal<String> tokenHolder = new ThreadLocal<>();
    
    // è®¾ç½®Tokenåˆ°å½“å‰çº¿ç¨‹
    public static void setToken(String token) {
        tokenHolder.set(token);
    }
    
    // ä»å½“å‰çº¿ç¨‹è·å–Token
    public static String getToken() {
        return tokenHolder.get();
    }
    
    // æ¸…é™¤å½“å‰çº¿ç¨‹çš„Token
    public static void clear() {
        tokenHolder.remove();
    }
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```java
@Component
public class TokenFilter extends OncePerRequestFilter {
    
    @Override
    protected void doFilterInternal(
            HttpServletRequest request,
            HttpServletResponse response,
            FilterChain filterChain) throws ServletException, IOException {
        
        try {
            // ğŸ”¸ Step1: ä»è¯·æ±‚å¤´æå–Token
            String token = request.getHeader("Authorization");
            
            // ğŸ”¸ Step2: å­˜å‚¨åˆ°å½“å‰çº¿ç¨‹ä¸Šä¸‹æ–‡
            TokenHolder.setToken(token);
            
            // ğŸ”¸ Step3: ç»§ç»­å¤„ç†è¯·æ±‚
            filterChain.doFilter(request, response);
            
        } finally {
            // ğŸ”¸ Step4: æ¸…ç†çº¿ç¨‹ä¸Šä¸‹æ–‡ï¼ˆé˜²æ­¢å†…å­˜æ³„æ¼ï¼‰
            TokenHolder.clear();
        }
    }
}
```

### 4.3 å¼‚æ­¥åœºæ™¯çš„ä¸Šä¸‹æ–‡ä¼ é€’


**é—®é¢˜åœºæ™¯**ï¼š

```java
@Service
public class OrderService {
    
    public void createOrder(OrderDTO order) {
        // ä¸»çº¿ç¨‹æœ‰Token
        String token = TokenHolder.getToken(); // âœ“ å¯ä»¥æ‹¿åˆ°
        
        // å¼‚æ­¥ä»»åŠ¡
        CompletableFuture.runAsync(() -> {
            // å¼‚æ­¥çº¿ç¨‹æ²¡æœ‰Token
            String asyncToken = TokenHolder.getToken(); // âœ— æ‹¿ä¸åˆ°ï¼
            sendNotification(asyncToken, order);
        });
    }
}
```

**è§£å†³æ–¹æ¡ˆï¼šæ‰‹åŠ¨ä¼ é€’ä¸Šä¸‹æ–‡**

```java
@Service
public class OrderService {
    
    public void createOrder(OrderDTO order) {
        // ğŸ”¸ Step1: åœ¨ä¸»çº¿ç¨‹è·å–Token
        String token = TokenHolder.getToken();
        
        // ğŸ”¸ Step2: ä¼ é€’åˆ°å¼‚æ­¥çº¿ç¨‹
        CompletableFuture.runAsync(() -> {
            try {
                // ğŸ”¸ Step3: åœ¨å¼‚æ­¥çº¿ç¨‹è®¾ç½®Token
                TokenHolder.setToken(token);
                
                // ğŸ”¸ Step4: æ‰§è¡Œä¸šåŠ¡é€»è¾‘
                sendNotification(token, order);
                
            } finally {
                // ğŸ”¸ Step5: æ¸…ç†ä¸Šä¸‹æ–‡
                TokenHolder.clear();
            }
        });
    }
}
```

### 4.4 çº¿ç¨‹æ± åœºæ™¯çš„ä¸Šä¸‹æ–‡ä¼ é€’


**ä½¿ç”¨è£…é¥°å™¨æ¨¡å¼**ï¼š

```java
/**
 * ä¸Šä¸‹æ–‡ä¼ é€’çš„RunnableåŒ…è£…å™¨
 */
public class ContextPropagatingRunnable implements Runnable {
    
    private final Runnable delegate;
    private final String token;
    
    public ContextPropagatingRunnable(Runnable delegate) {
        this.delegate = delegate;
        // ğŸ”¸ æ„é€ æ—¶æ•è·å½“å‰çº¿ç¨‹çš„Token
        this.token = TokenHolder.getToken();
    }
    
    @Override
    public void run() {
        try {
            // ğŸ”¸ æ‰§è¡Œå‰è®¾ç½®Tokenåˆ°æ–°çº¿ç¨‹
            TokenHolder.setToken(token);
            // ğŸ”¸ æ‰§è¡Œå®é™…ä»»åŠ¡
            delegate.run();
        } finally {
            // ğŸ”¸ æ‰§è¡Œåæ¸…ç†Token
            TokenHolder.clear();
        }
    }
}
```

**é…ç½®çº¿ç¨‹æ± **ï¼š

```java
@Configuration
public class AsyncConfig {
    
    @Bean
    public Executor taskExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(10);
        executor.setMaxPoolSize(20);
        
        // ğŸ”¸ è®¾ç½®ä»»åŠ¡è£…é¥°å™¨ï¼Œè‡ªåŠ¨ä¼ é€’ä¸Šä¸‹æ–‡
        executor.setTaskDecorator(runnable -> 
            new ContextPropagatingRunnable(runnable)
        );
        
        executor.initialize();
        return executor;
    }
}
```

---

## 5. ğŸ”„ ä¸Šä¸‹æ–‡ä¼ æ’­æœºåˆ¶


### 5.1 ä»€ä¹ˆæ˜¯ä¸Šä¸‹æ–‡ä¼ æ’­


**ä¸Šä¸‹æ–‡ä¼ æ’­çš„å«ä¹‰**ï¼š

```
ä¸Šä¸‹æ–‡ = è¯·æ±‚ç›¸å…³çš„æ‰€æœ‰ä¿¡æ¯

åŒ…å«å†…å®¹ï¼š
ğŸ“‹ Tokenï¼ˆç”¨æˆ·èº«ä»½ï¼‰
ğŸ“‹ TraceIdï¼ˆè°ƒç”¨é“¾è¿½è¸ªï¼‰
ğŸ“‹ ç”¨æˆ·ä¿¡æ¯ï¼ˆuserIdã€usernameç­‰ï¼‰
ğŸ“‹ ç§Ÿæˆ·IDï¼ˆå¤šç§Ÿæˆ·åœºæ™¯ï¼‰
ğŸ“‹ è¯­è¨€è®¾ç½®ï¼ˆå›½é™…åŒ–ï¼‰

ä¼ æ’­ = è¿™äº›ä¿¡æ¯åœ¨æœåŠ¡è°ƒç”¨é“¾ä¸­è‡ªåŠ¨æµè½¬
```

**ç”Ÿæ´»ç±»æ¯”**ï¼š

```
ä¸Šä¸‹æ–‡ä¼ æ’­ = ä¼ è¯æ¸¸æˆ

AåŒå­¦ â†’ BåŒå­¦ â†’ CåŒå­¦ â†’ DåŒå­¦
  |       |       |       |
 å®Œæ•´    å®Œæ•´    å®Œæ•´    å®Œæ•´
 ä¿¡æ¯    ä¿¡æ¯    ä¿¡æ¯    ä¿¡æ¯

è¦æ±‚ï¼š
- æ¯ä¸ªäººéƒ½è¦æŠŠå®Œæ•´ä¿¡æ¯ä¼ ç»™ä¸‹ä¸€ä¸ªäºº
- ä¸èƒ½é—æ¼ä»»ä½•ç»†èŠ‚
- ç¡®ä¿æœ€åä¸€ä¸ªäººæ”¶åˆ°çš„å’Œç¬¬ä¸€ä¸ªäººè¯´çš„ä¸€æ ·

ä¸Šä¸‹æ–‡ä¼ æ’­ä¹Ÿæ˜¯è¿™æ ·ï¼
```

### 5.2 ä¸Šä¸‹æ–‡å¯¹è±¡è®¾è®¡


```java
/**
 * è¯·æ±‚ä¸Šä¸‹æ–‡ - åŒ…å«æ‰€æœ‰éœ€è¦ä¼ æ’­çš„ä¿¡æ¯
 */
public class RequestContext {
    
    private String token;          // Tokenä¿¡æ¯
    private String traceId;        // è¿½è¸ªID
    private String userId;         // ç”¨æˆ·ID
    private String username;       // ç”¨æˆ·å
    private String tenantId;       // ç§Ÿæˆ·ID
    private String language;       // è¯­è¨€è®¾ç½®
    
    // ThreadLocalå­˜å‚¨
    private static final ThreadLocal<RequestContext> contextHolder = 
        new ThreadLocal<>();
    
    // è®¾ç½®ä¸Šä¸‹æ–‡
    public static void set(RequestContext context) {
        contextHolder.set(context);
    }
    
    // è·å–ä¸Šä¸‹æ–‡
    public static RequestContext get() {
        return contextHolder.get();
    }
    
    // æ¸…ç†ä¸Šä¸‹æ–‡
    public static void clear() {
        contextHolder.remove();
    }
}
```

### 5.3 ä¸Šä¸‹æ–‡ä¼ æ’­å®ç°


**Filterå±‚æå–ä¸Šä¸‹æ–‡**ï¼š

```java
@Component
public class ContextPropagationFilter extends OncePerRequestFilter {
    
    @Override
    protected void doFilterInternal(
            HttpServletRequest request,
            HttpServletResponse response,
            FilterChain filterChain) throws ServletException, IOException {
        
        try {
            // ğŸ”¸ Step1: æ„å»ºè¯·æ±‚ä¸Šä¸‹æ–‡
            RequestContext context = buildContext(request);
            
            // ğŸ”¸ Step2: è®¾ç½®åˆ°çº¿ç¨‹ä¸Šä¸‹æ–‡
            RequestContext.set(context);
            
            // ğŸ”¸ Step3: ç»§ç»­å¤„ç†è¯·æ±‚
            filterChain.doFilter(request, response);
            
        } finally {
            // ğŸ”¸ Step4: æ¸…ç†ä¸Šä¸‹æ–‡
            RequestContext.clear();
        }
    }
    
    private RequestContext buildContext(HttpServletRequest request) {
        RequestContext context = new RequestContext();
        
        // æå–å„ç§ä¿¡æ¯
        context.setToken(request.getHeader("Authorization"));
        context.setTraceId(request.getHeader("X-Trace-Id"));
        context.setUserId(request.getHeader("X-User-Id"));
        context.setTenantId(request.getHeader("X-Tenant-Id"));
        context.setLanguage(request.getHeader("Accept-Language"));
        
        return context;
    }
}
```

**æ‹¦æˆªå™¨å±‚ä¼ æ’­ä¸Šä¸‹æ–‡**ï¼š

```java
@Component
public class ContextPropagationInterceptor implements ClientHttpRequestInterceptor {
    
    @Override
    public ClientHttpResponse intercept(
            HttpRequest request, 
            byte[] body, 
            ClientHttpRequestExecution execution) throws IOException {
        
        // ğŸ”¸ è·å–å½“å‰ä¸Šä¸‹æ–‡
        RequestContext context = RequestContext.get();
        
        if (context != null) {
            HttpHeaders headers = request.getHeaders();
            
            // ğŸ”¸ ä¼ æ’­æ‰€æœ‰ä¸Šä¸‹æ–‡ä¿¡æ¯
            if (context.getToken() != null) {
                headers.set("Authorization", context.getToken());
            }
            if (context.getTraceId() != null) {
                headers.set("X-Trace-Id", context.getTraceId());
            }
            if (context.getUserId() != null) {
                headers.set("X-User-Id", context.getUserId());
            }
            if (context.getTenantId() != null) {
                headers.set("X-Tenant-Id", context.getTenantId());
            }
            if (context.getLanguage() != null) {
                headers.set("Accept-Language", context.getLanguage());
            }
        }
        
        return execution.execute(request, body);
    }
}
```

### 5.4 ä¸Šä¸‹æ–‡ä¼ æ’­æµç¨‹å›¾


```
å®Œæ•´çš„ä¸Šä¸‹æ–‡ä¼ æ’­æµç¨‹ï¼š

ç”¨æˆ·è¯·æ±‚
   â†“
[Filterå±‚]
   â”œâ”€ æå–è¯·æ±‚å¤´ä¿¡æ¯
   â”œâ”€ æ„å»ºRequestContextå¯¹è±¡
   â””â”€ å­˜å‚¨åˆ°ThreadLocal
   
[Serviceå±‚]
   â”œâ”€ å¤„ç†ä¸šåŠ¡é€»è¾‘
   â”œâ”€ è°ƒç”¨ä¸‹æ¸¸æœåŠ¡
   â””â”€ ä»ThreadLocalè·å–ä¸Šä¸‹æ–‡
   
[æ‹¦æˆªå™¨å±‚]
   â”œâ”€ æ‹¦æˆªHTTPè¯·æ±‚
   â”œâ”€ è·å–RequestContext
   â”œâ”€ å°†ä¸Šä¸‹æ–‡ä¿¡æ¯æ·»åŠ åˆ°è¯·æ±‚å¤´
   â””â”€ å‘é€è¯·æ±‚
   
[ä¸‹æ¸¸æœåŠ¡]
   â”œâ”€ æ¥æ”¶è¯·æ±‚ï¼ˆåŒ…å«å®Œæ•´ä¸Šä¸‹æ–‡ï¼‰
   â”œâ”€ Filteræå–ä¸Šä¸‹æ–‡
   â”œâ”€ å­˜å‚¨åˆ°è‡ªå·±çš„ThreadLocal
   â””â”€ ç»§ç»­å‘æ›´ä¸‹æ¸¸ä¼ æ’­

æ ¸å¿ƒï¼šæ¯ä¸ªæœåŠ¡éƒ½é‡å¤"æå–â†’å­˜å‚¨â†’ä½¿ç”¨â†’ä¼ æ’­"çš„å¾ªç¯
```

---

## 6. âš–ï¸ ä¼ æ’­æ¨¡å¼å¯¹æ¯”


### 6.1 ä¸‰ç§ä¼ æ’­æ¨¡å¼å¯¹æ¯”


| ä¼ æ’­æ¨¡å¼ | **å®ç°åŸç†** | **é€‚ç”¨åœºæ™¯** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** |
|---------|------------|------------|---------|---------|
| ğŸ”¸ **è¯·æ±‚å¤´ä¼ é€’** | `é€šè¿‡HTTP Headerä¼ é€’` | `HTTPåŒæ­¥è°ƒç”¨` | `âœ…æ ‡å‡†è§„èŒƒ` `âœ…å®ç°ç®€å•` | `âŒä»…é™HTTP` `âŒå¼‚æ­¥ä¸å¯ç”¨` |
| ğŸ”¸ **çº¿ç¨‹ä¸Šä¸‹æ–‡** | `ThreadLocalå­˜å‚¨` | `åŒä¸€çº¿ç¨‹å†…è°ƒç”¨` | `âœ…çº¿ç¨‹éš”ç¦»` `âœ…æ— ä¾µå…¥æ€§` | `âŒå¼‚æ­¥ä¸¢å¤±` `âŒéœ€è¦æ¸…ç†` |
| ğŸ”¸ **ä¸Šä¸‹æ–‡ä¼ æ’­** | `Filter+æ‹¦æˆªå™¨ç»„åˆ` | `å®Œæ•´è°ƒç”¨é“¾` | `âœ…è‡ªåŠ¨ä¼ æ’­` `âœ…ä¿¡æ¯å®Œæ•´` | `âŒé…ç½®å¤æ‚` `âŒæœ‰å¼€é”€` |

### 6.2 é€‰æ‹©å»ºè®®


```
ğŸ¯ åœºæ™¯1ï¼šç®€å•çš„HTTPè°ƒç”¨
é€‰æ‹©ï¼šè¯·æ±‚å¤´ä¼ é€’
åŸå› ï¼šå®ç°ç®€å•ï¼Œæ€§èƒ½å¥½

ç¤ºä¾‹ä»£ç ï¼š
@Component
public class SimpleTokenInterceptor implements ClientHttpRequestInterceptor {
    public ClientHttpResponse intercept(...) {
        String token = getCurrentToken();
        request.getHeaders().set("Authorization", token);
        return execution.execute(request, body);
    }
}

---

ğŸ¯ åœºæ™¯2ï¼šéœ€è¦åœ¨Serviceå±‚è·å–Token
é€‰æ‹©ï¼šçº¿ç¨‹ä¸Šä¸‹æ–‡
åŸå› ï¼šServiceå±‚æ²¡æœ‰Requestå¯¹è±¡ï¼Œåªèƒ½ç”¨ThreadLocal

ç¤ºä¾‹ä»£ç ï¼š
@Service
public class OrderService {
    public void process() {
        String token = TokenHolder.getToken(); // ä»ThreadLocalè·å–
    }
}

---

ğŸ¯ åœºæ™¯3ï¼šå¤æ‚çš„å¾®æœåŠ¡è°ƒç”¨é“¾
é€‰æ‹©ï¼šä¸Šä¸‹æ–‡ä¼ æ’­æœºåˆ¶
åŸå› ï¼šéœ€è¦ä¼ é€’å¤šç§ä¿¡æ¯ï¼Œä¿è¯å®Œæ•´æ€§

ç¤ºä¾‹ä»£ç ï¼š
RequestContext context = RequestContext.get();
String token = context.getToken();
String traceId = context.getTraceId();
```

### 6.3 ç»„åˆä½¿ç”¨æ–¹æ¡ˆ


**æœ€ä½³å®è·µï¼šä¸‰ç§æ¨¡å¼ç»“åˆ**

```
å®Œæ•´çš„ä¼ æ’­æ¶æ„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            ç”¨æˆ·è¯·æ±‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
        [Filter - æå–ä¿¡æ¯]
                 â†“
        [ThreadLocal - å­˜å‚¨ä¸Šä¸‹æ–‡]
                 â†“
        [Service - ä¸šåŠ¡å¤„ç†]
                 â†“
        [æ‹¦æˆªå™¨ - è¯·æ±‚å¤´ä¼ æ’­]
                 â†“
           [ä¸‹æ¸¸æœåŠ¡]

æ¯ä¸€å±‚å„å¸å…¶èŒï¼š
- Filterï¼šæå–å’Œåˆå§‹åŒ–ä¸Šä¸‹æ–‡
- ThreadLocalï¼šçº¿ç¨‹å†…å…±äº«æ•°æ®
- æ‹¦æˆªå™¨ï¼šHTTPè¯·æ±‚ä¼ æ’­
- Serviceï¼šä½¿ç”¨ä¸Šä¸‹æ–‡æ•°æ®
```

---

## 7. ğŸ› ï¸ å®æˆ˜åœºæ™¯åº”ç”¨


### 7.1 åœºæ™¯1ï¼šè®¢å•æœåŠ¡è°ƒç”¨é“¾


```
ä¸šåŠ¡æµç¨‹ï¼š
ç”¨æˆ·ä¸‹å• â†’ è®¢å•æœåŠ¡ â†’ åº“å­˜æœåŠ¡ â†’ æ”¯ä»˜æœåŠ¡

è¦æ±‚ï¼š
1. Tokenåœ¨æ•´ä¸ªé“¾è·¯ä¸­ä¼ é€’
2. TraceIdç”¨äºè°ƒç”¨é“¾è¿½è¸ª
3. ç”¨æˆ·ä¿¡æ¯ç”¨äºä¸šåŠ¡å¤„ç†
```

**å®ç°ä»£ç **ï¼š

```java
// è®¢å•æœåŠ¡
@Service
public class OrderService {
    
    @Autowired
    private InventoryClient inventoryClient;
    
    @Autowired
    private PaymentClient paymentClient;
    
    public OrderResult createOrder(OrderDTO order) {
        // ğŸ”¸ ä»ä¸Šä¸‹æ–‡è·å–ç”¨æˆ·ä¿¡æ¯
        RequestContext ctx = RequestContext.get();
        String userId = ctx.getUserId();
        
        // ğŸ”¸ è°ƒç”¨åº“å­˜æœåŠ¡ï¼ˆè‡ªåŠ¨ä¼ æ’­Tokenï¼‰
        InventoryResult inventory = inventoryClient.checkStock(order);
        
        if (inventory.isAvailable()) {
            // ğŸ”¸ è°ƒç”¨æ”¯ä»˜æœåŠ¡ï¼ˆè‡ªåŠ¨ä¼ æ’­Tokenï¼‰
            PaymentResult payment = paymentClient.pay(order, userId);
            return new OrderResult(order, payment);
        }
        
        throw new BusinessException("åº“å­˜ä¸è¶³");
    }
}
```

### 7.2 åœºæ™¯2ï¼šå¼‚æ­¥æ¶ˆæ¯å¤„ç†


```
ä¸šåŠ¡æµç¨‹ï¼š
è®¢å•åˆ›å»º â†’ å¼‚æ­¥å‘é€é€šçŸ¥ â†’ è°ƒç”¨é€šçŸ¥æœåŠ¡

é—®é¢˜ï¼šå¼‚æ­¥çº¿ç¨‹ä¸­Tokenä¸¢å¤±
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```java
@Service
public class OrderService {
    
    @Autowired
    private AsyncNotificationService notificationService;
    
    public void createOrder(OrderDTO order) {
        // ä¿å­˜è®¢å•...
        
        // ğŸ”¸ Step1: æ•è·å½“å‰ä¸Šä¸‹æ–‡
        RequestContext context = RequestContext.get();
        
        // ğŸ”¸ Step2: å¼‚æ­¥å‘é€é€šçŸ¥
        CompletableFuture.runAsync(() -> {
            try {
                // ğŸ”¸ Step3: åœ¨å¼‚æ­¥çº¿ç¨‹è®¾ç½®ä¸Šä¸‹æ–‡
                RequestContext.set(context);
                
                // ğŸ”¸ Step4: è°ƒç”¨é€šçŸ¥æœåŠ¡
                notificationService.sendOrderNotification(order);
                
            } finally {
                // ğŸ”¸ Step5: æ¸…ç†ä¸Šä¸‹æ–‡
                RequestContext.clear();
            }
        });
    }
}
```

### 7.3 åœºæ™¯3ï¼šå¤šç§Ÿæˆ·åœºæ™¯


```
ä¸šåŠ¡èƒŒæ™¯ï¼š
- SaaSå¹³å°ï¼Œå¤šä¸ªç§Ÿæˆ·å…±ç”¨ç³»ç»Ÿ
- æ¯ä¸ªç§Ÿæˆ·æ•°æ®éš”ç¦»
- éœ€è¦ä¼ é€’ç§Ÿæˆ·ID

æ•°æ®æµï¼š
ç”¨æˆ·è¯·æ±‚(ç§Ÿæˆ·A) â†’ è®¢å•æœåŠ¡ â†’ åº“å­˜æœåŠ¡ â†’ ä»“å‚¨æœåŠ¡
                  (ç§Ÿæˆ·A)    (ç§Ÿæˆ·A)    (ç§Ÿæˆ·A)
```

**å®ç°ä»£ç **ï¼š

```java
// ç§Ÿæˆ·ä¸Šä¸‹æ–‡
public class TenantContext {
    private static final ThreadLocal<String> tenantHolder = new ThreadLocal<>();
    
    public static void setTenantId(String tenantId) {
        tenantHolder.set(tenantId);
    }
    
    public static String getTenantId() {
        return tenantHolder.get();
    }
}

// Filteræå–ç§Ÿæˆ·ID
@Component
public class TenantFilter extends OncePerRequestFilter {
    
    @Override
    protected void doFilterInternal(...) {
        String tenantId = request.getHeader("X-Tenant-Id");
        TenantContext.setTenantId(tenantId);
        
        try {
            filterChain.doFilter(request, response);
        } finally {
            TenantContext.clear();
        }
    }
}

// æ‹¦æˆªå™¨ä¼ æ’­ç§Ÿæˆ·ID
@Component
public class TenantPropagationInterceptor implements ClientHttpRequestInterceptor {
    
    @Override
    public ClientHttpResponse intercept(...) {
        String tenantId = TenantContext.getTenantId();
        if (tenantId != null) {
            request.getHeaders().set("X-Tenant-Id", tenantId);
        }
        return execution.execute(request, body);
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Tokenä¼ æ’­æœ¬è´¨ï¼š
Tokenåœ¨å¾®æœåŠ¡è°ƒç”¨é“¾ä¸­çš„æµè½¬å’Œä¼ é€’è¿‡ç¨‹

ğŸ”¸ ä¸‰ç§ä¼ æ’­æ¨¡å¼ï¼š
â€¢ è¯·æ±‚å¤´ä¼ é€’ï¼šHTTP Headeræºå¸¦ï¼Œé€‚åˆåŒæ­¥è°ƒç”¨
â€¢ çº¿ç¨‹ä¸Šä¸‹æ–‡ï¼šThreadLocalå­˜å‚¨ï¼Œé€‚åˆçº¿ç¨‹å†…å…±äº«
â€¢ ä¸Šä¸‹æ–‡ä¼ æ’­ï¼šå®Œæ•´ä¿¡æ¯ä¼ æ’­ï¼Œé€‚åˆå¤æ‚åœºæ™¯

ğŸ”¸ æ ¸å¿ƒç»„ä»¶ï¼š
â€¢ Filterï¼šæå–ä¸Šä¸‹æ–‡ä¿¡æ¯
â€¢ ThreadLocalï¼šçº¿ç¨‹å†…å­˜å‚¨
â€¢ æ‹¦æˆªå™¨ï¼šè‡ªåŠ¨æ·»åŠ è¯·æ±‚å¤´
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆéœ€è¦Tokenä¼ æ’­**

```
åœºæ™¯ï¼šç”¨æˆ·ç™»å½•ä¸€æ¬¡ï¼Œè®¿é—®å¤šä¸ªæœåŠ¡

ä¸ç”¨ä¼ æ’­ï¼š
- æ¯ä¸ªæœåŠ¡éƒ½è¦æ±‚ç”¨æˆ·ç™»å½•
- ç”¨æˆ·ä½“éªŒå·®
- å®ç°å¤æ‚

ä½¿ç”¨ä¼ æ’­ï¼š
- ç”¨æˆ·åªç™»å½•ä¸€æ¬¡
- Tokenè‡ªåŠ¨åœ¨æœåŠ¡é—´æµè½¬
- ä½“éªŒå¥½ï¼Œå®ç°ç®€å•
```

**ğŸ”¹ å¦‚ä½•é€‰æ‹©ä¼ æ’­æ¨¡å¼**

```
åˆ¤æ–­æ ‡å‡†ï¼š

è°ƒç”¨ç±»å‹ï¼š
- HTTPåŒæ­¥è°ƒç”¨ â†’ è¯·æ±‚å¤´ä¼ é€’
- å¼‚æ­¥è°ƒç”¨ â†’ çº¿ç¨‹ä¸Šä¸‹æ–‡ä¼ é€’
- å¤æ‚è°ƒç”¨é“¾ â†’ ä¸Šä¸‹æ–‡ä¼ æ’­æœºåˆ¶

ä¿¡æ¯ç±»å‹ï¼š
- åªä¼ Token â†’ è¯·æ±‚å¤´ä¼ é€’
- ä¼ å¤šç§ä¿¡æ¯ â†’ ä¸Šä¸‹æ–‡ä¼ æ’­

å®ç°éš¾åº¦ï¼š
- å¿«é€Ÿå®ç° â†’ è¯·æ±‚å¤´ä¼ é€’
- å¥å£®æ–¹æ¡ˆ â†’ ä¸Šä¸‹æ–‡ä¼ æ’­æœºåˆ¶
```

**ğŸ”¹ å¸¸è§é—®é¢˜è§£å†³**

```
â“ é—®é¢˜1ï¼šå¼‚æ­¥çº¿ç¨‹Tokenä¸¢å¤±
ğŸ’¡ è§£å†³ï¼šæ‰‹åŠ¨ä¼ é€’æˆ–ä½¿ç”¨TaskDecorator

â“ é—®é¢˜2ï¼šè°ƒç”¨é“¾Tokenä¸­æ–­
ğŸ’¡ è§£å†³ï¼šæ£€æŸ¥æ‹¦æˆªå™¨é…ç½®ï¼Œç¡®ä¿æ¯ä¸ªæœåŠ¡éƒ½æœ‰

â“ é—®é¢˜3ï¼šThreadLocalå†…å­˜æ³„æ¼
ğŸ’¡ è§£å†³ï¼šfinallyå—ä¸­è°ƒç”¨clear()æ–¹æ³•

â“ é—®é¢˜4ï¼šTokenè¿‡æœŸå¦‚ä½•å¤„ç†
ğŸ’¡ è§£å†³ï¼šæ‹¦æˆªå™¨ä¸­æ£€æŸ¥æœ‰æ•ˆæœŸï¼Œè‡ªåŠ¨åˆ·æ–°
```

### 8.3 æœ€ä½³å®è·µå»ºè®®


```
âœ… æ¨èåšæ³•ï¼š

1. ç»Ÿä¸€ä½¿ç”¨ä¸Šä¸‹æ–‡ä¼ æ’­
   - ä¸€æ¬¡é…ç½®ï¼Œå…¨å±€ç”Ÿæ•ˆ
   - ä¿¡æ¯å®Œæ•´ï¼Œä¸æ˜“é—æ¼

2. Filterå±‚ç»Ÿä¸€æå–
   - é›†ä¸­ç®¡ç†ä¸Šä¸‹æ–‡
   - é¿å…é‡å¤ä»£ç 

3. æ‹¦æˆªå™¨è‡ªåŠ¨ä¼ æ’­
   - å‡å°‘æ‰‹åŠ¨æ“ä½œ
   - é™ä½å‡ºé”™æ¦‚ç‡

4. å¼‚æ­¥åœºæ™¯ç‰¹æ®Šå¤„ç†
   - ä½¿ç”¨TaskDecorator
   - æˆ–æ‰‹åŠ¨ä¼ é€’ä¸Šä¸‹æ–‡

âŒ é¿å…åšæ³•ï¼š

1. æ¯ä¸ªåœ°æ–¹æ‰‹åŠ¨ä¼ é€’
   - ä»£ç é‡å¤
   - å®¹æ˜“é—æ¼

2. ç›´æ¥ä½¿ç”¨Requestå¯¹è±¡
   - ä¾èµ–HTTPç¯å¢ƒ
   - å¼‚æ­¥åœºæ™¯ä¸å¯ç”¨

3. å¿˜è®°æ¸…ç†ThreadLocal
   - å†…å­˜æ³„æ¼é£é™©
   - çº¿ç¨‹æ± å¤ç”¨é—®é¢˜
```

### 8.4 å¿«é€Ÿæ£€æŸ¥æ¸…å•


```
ğŸ“‹ Tokenä¼ æ’­æ£€æŸ¥ç‚¹ï¼š

â–¡ æ˜¯å¦é…ç½®äº†ä¸Šä¸‹æ–‡Filterï¼Ÿ
â–¡ æ˜¯å¦é…ç½®äº†ä¼ æ’­æ‹¦æˆªå™¨ï¼Ÿ
â–¡ æ˜¯å¦å¤„ç†äº†å¼‚æ­¥åœºæ™¯ï¼Ÿ
â–¡ ThreadLocalæ˜¯å¦æ­£ç¡®æ¸…ç†ï¼Ÿ
â–¡ æ˜¯å¦æ”¯æŒå¤šç§ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Ÿ
â–¡ å¼‚å¸¸æƒ…å†µæ˜¯å¦æ­£ç¡®å¤„ç†ï¼Ÿ
â–¡ æ˜¯å¦æ·»åŠ äº†è°ƒç”¨é“¾è¿½è¸ªï¼Ÿ
```

**ğŸ¯ æ ¸å¿ƒè®°å¿†**ï¼š
- Tokenä¼ æ’­æ˜¯å¾®æœåŠ¡è°ƒç”¨çš„åŸºç¡€
- è¯·æ±‚å¤´ä¼ é€’æœ€ç®€å•ï¼Œä¸Šä¸‹æ–‡ä¼ æ’­æœ€å®Œæ•´
- ThreadLocalè¦è®°å¾—æ¸…ç†
- å¼‚æ­¥åœºæ™¯éœ€è¦ç‰¹æ®Šå¤„ç†
- ç»„åˆä½¿ç”¨ä¸‰ç§æ¨¡å¼æ•ˆæœæœ€å¥½