---
title: 5ã€ç½‘å…³OAuth2é›†æˆ
---
## ğŸ“š ç›®å½•

1. [ä¸ºä»€ä¹ˆéœ€è¦ç½‘å…³OAuth2é›†æˆ](#1-ä¸ºä»€ä¹ˆéœ€è¦ç½‘å…³OAuth2é›†æˆ)
2. [ç½‘å…³OAuth2é›†æˆæ ¸å¿ƒæ¦‚å¿µ](#2-ç½‘å…³OAuth2é›†æˆæ ¸å¿ƒæ¦‚å¿µ)
3. [Spring Cloud Gateway OAuth2é…ç½®](#3-Spring-Cloud-Gateway-OAuth2é…ç½®)
4. [ç»Ÿä¸€é‰´æƒä¸è·¯ç”±è®¤è¯](#4-ç»Ÿä¸€é‰´æƒä¸è·¯ç”±è®¤è¯)
5. [å…¨å±€è¿‡æ»¤å™¨å®ç°](#5-å…¨å±€è¿‡æ»¤å™¨å®ç°)
6. [Tokenè½¬å‘æœºåˆ¶](#6-Tokenè½¬å‘æœºåˆ¶)
7. [æƒé™æ‹¦æˆªç­–ç•¥](#7-æƒé™æ‹¦æˆªç­–ç•¥)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸšª ä¸ºä»€ä¹ˆéœ€è¦ç½‘å…³OAuth2é›†æˆ


### 1.1 å¾®æœåŠ¡å®‰å…¨çš„ç—›ç‚¹


æƒ³è±¡ä¸€ä¸‹ï¼Œä½ ç»è¥ä¸€å®¶å¤§å‹å•†åœºï¼š

```
ä¼ ç»Ÿæ–¹å¼ï¼ˆæ¯ä¸ªåº—é“ºç‹¬ç«‹éªŒè¯ï¼‰ï¼š
å®¢æˆ·è¿›åº—A â†’ éªŒè¯ä¼šå‘˜å¡
å®¢æˆ·è¿›åº—B â†’ å†æ¬¡éªŒè¯ä¼šå‘˜å¡  
å®¢æˆ·è¿›åº—C â†’ åˆè¦éªŒè¯ä¼šå‘˜å¡
âŒ é‡å¤éªŒè¯ï¼Œæ•ˆç‡ä½ä¸‹

ç½‘å…³æ–¹å¼ï¼ˆå•†åœºå…¥å£ç»Ÿä¸€éªŒè¯ï¼‰ï¼š
å®¢æˆ·è¿›å•†åœºå¤§é—¨ â†’ ä¸€æ¬¡éªŒè¯ä¼šå‘˜å¡ â†’ è·å¾—é€šè¡Œè¯
è¿›åº—Aã€Bã€C â†’ ç›´æ¥å‡ºç¤ºé€šè¡Œè¯
âœ… ä¸€æ¬¡éªŒè¯ï¼Œå…¨åœºé€šè¡Œ
```

**å¾®æœåŠ¡ç¯å¢ƒçš„ç°å®é—®é¢˜**ï¼š

| é—®é¢˜åœºæ™¯ | æ²¡æœ‰ç½‘å…³é›†æˆ | æœ‰ç½‘å…³OAuth2é›†æˆ |
|---------|-------------|-----------------|
| ğŸ” **è®¤è¯æ–¹å¼** | æ¯ä¸ªæœåŠ¡ç‹¬ç«‹è®¤è¯ | ç½‘å…³ç»Ÿä¸€è®¤è¯ |
| ğŸ”„ **TokenéªŒè¯** | æœåŠ¡é‡å¤éªŒè¯Token | ç½‘å…³éªŒè¯ä¸€æ¬¡ |
| ğŸ¯ **æƒé™æ§åˆ¶** | åˆ†æ•£åœ¨å„æœåŠ¡ | ç½‘å…³é›†ä¸­æ§åˆ¶ |
| ğŸ“Š **å®‰å…¨ç­–ç•¥** | éš¾ä»¥ç»Ÿä¸€ç®¡ç† | ç»Ÿä¸€ç­–ç•¥é…ç½® |
| âš¡ **æ€§èƒ½å½±å“** | é‡å¤éªŒè¯è€—æ—¶ | å‡å°‘éªŒè¯æ¬¡æ•° |

### 1.2 ç½‘å…³OAuth2é›†æˆçš„ä»·å€¼


ğŸ¯ **æ ¸å¿ƒä»·å€¼**ï¼š

```
å®¢æˆ·ç«¯                  APIç½‘å…³                  åç«¯å¾®æœåŠ¡
   |                      |                         |
   |--[1]æºå¸¦Token------->|                         |
   |                      |--éªŒè¯Tokenæœ‰æ•ˆæ€§         |
   |                      |--æ£€æŸ¥æƒé™               |
   |                      |                         |
   |                      |--[2]è½¬å‘è¯·æ±‚+Token----->| è®¢å•æœåŠ¡
   |                      |                         | (ä¿¡ä»»ç½‘å…³)
   |<--[3]è¿”å›ç»“æœ--------|<-----------------------|
   |                      |                         |
```

**ä¸‰å¤§æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- ğŸ›¡ï¸ **ç»Ÿä¸€å®‰å…¨å…¥å£**ï¼šæ‰€æœ‰è¯·æ±‚å¿…ç»ç½‘å…³è®¤è¯
- ğŸ”§ **ç®€åŒ–æœåŠ¡å¼€å‘**ï¼šåç«¯æœåŠ¡æ— éœ€å…³å¿ƒè®¤è¯é€»è¾‘
- ğŸ“ˆ **æ€§èƒ½ä¼˜åŒ–**ï¼šTokenéªŒè¯åªåœ¨ç½‘å…³è¿›è¡Œä¸€æ¬¡

---

## 2. ğŸ”‘ ç½‘å…³OAuth2é›†æˆæ ¸å¿ƒæ¦‚å¿µ


### 2.1 ç»Ÿä¸€é‰´æƒæœºåˆ¶


**ä»€ä¹ˆæ˜¯ç»Ÿä¸€é‰´æƒï¼Ÿ**

> ğŸ’¡ **é€šä¿—ç†è§£**
> å°±åƒé…’åº—çš„é—¨ç¦ç³»ç»Ÿï¼š
> - å‰å°éªŒè¯ä½ çš„èº«ä»½ï¼ˆç½‘å…³OAuth2éªŒè¯ï¼‰
> - ç»™ä½ æˆ¿å¡ï¼ˆTokenï¼‰
> - åç»­è¿›å‡ºæˆ¿é—´åªéœ€åˆ·å¡ï¼ˆæœåŠ¡é—´ä¼ é€’Tokenï¼‰
> - æˆ¿é—´ä¸å†éªŒè¯ä½ æ˜¯è°ï¼ˆåç«¯æœåŠ¡ä¿¡ä»»ç½‘å…³ï¼‰

**æŠ€æœ¯å®ç°åŸç†**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            API Gateway                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   OAuth2 è®¤è¯è¿‡æ»¤å™¨              â”‚   â”‚
â”‚  â”‚   1. æå–Token                   â”‚   â”‚
â”‚  â”‚   2. éªŒè¯Tokenæœ‰æ•ˆæ€§             â”‚   â”‚
â”‚  â”‚   3. è§£æç”¨æˆ·ä¿¡æ¯                â”‚   â”‚
â”‚  â”‚   4. æ£€æŸ¥æƒé™                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚              â†“                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   è·¯ç”±è½¬å‘                       â”‚   â”‚
â”‚  â”‚   - æ·»åŠ ç”¨æˆ·ä¸Šä¸‹æ–‡               â”‚   â”‚
â”‚  â”‚   - è½¬å‘Tokenåˆ°åç«¯              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“           â†“           â†“
    è®¢å•æœåŠ¡      ç”¨æˆ·æœåŠ¡    æ”¯ä»˜æœåŠ¡
   (æ— éœ€è®¤è¯)    (æ— éœ€è®¤è¯)   (æ— éœ€è®¤è¯)
```

### 2.2 è·¯ç”±è®¤è¯ç­–ç•¥


**ä¸åŒè·¯ç”±çš„è®¤è¯éœ€æ±‚**ï¼š

| è·¯ç”±ç±»å‹ | è®¤è¯è¦æ±‚ | å…¸å‹åœºæ™¯ | é…ç½®ç­–ç•¥ |
|---------|---------|---------|---------|
| ğŸŒ **å…¬å¼€è·¯ç”±** | æ— éœ€è®¤è¯ | é¦–é¡µã€å•†å“åˆ—è¡¨ | `permitAll()` |
| ğŸ”“ **åŠå¼€æ”¾è·¯ç”±** | å¯é€‰è®¤è¯ | ä¸ªæ€§åŒ–æ¨è | å…è®¸åŒ¿åè®¿é—® |
| ğŸ”’ **ç§æœ‰è·¯ç”±** | å¿…é¡»è®¤è¯ | ä¸ªäººä¸­å¿ƒã€ä¸‹å• | `authenticated()` |
| ğŸ›¡ï¸ **é«˜æƒé™è·¯ç”±** | ç‰¹å®šè§’è‰² | åå°ç®¡ç† | `hasRole('ADMIN')` |

**è·¯ç”±è®¤è¯ç¤ºä¾‹**ï¼š

```
ç”¨æˆ·è¯·æ±‚ï¼šGET /api/products          â†’ å…¬å¼€è·¯ç”±ï¼Œç›´æ¥æ”¾è¡Œ
ç”¨æˆ·è¯·æ±‚ï¼šGET /api/orders            â†’ ç§æœ‰è·¯ç”±ï¼Œæ£€æŸ¥Token
ç®¡ç†å‘˜è¯·æ±‚ï¼šDELETE /api/users/{id}   â†’ é«˜æƒé™è·¯ç”±ï¼Œæ£€æŸ¥è§’è‰²
```

### 2.3 Tokenè½¬å‘æœºåˆ¶


**Tokenåœ¨å¾®æœåŠ¡é—´çš„ä¼ é€’**ï¼š

```
åœºæ™¯ï¼šç”¨æˆ·ä¸‹å•ï¼Œéœ€è¦è°ƒç”¨å¤šä¸ªæœåŠ¡

å®¢æˆ·ç«¯ --[Token: abc123]--> ç½‘å…³
                              |
                              |--éªŒè¯Tokenæœ‰æ•ˆ
                              |
          +-------------------+-------------------+
          |                   |                   |
    [Tokenè½¬å‘]         [Tokenè½¬å‘]         [Tokenè½¬å‘]
          â†“                   â†“                   â†“
      è®¢å•æœåŠ¡             åº“å­˜æœåŠ¡            ç§¯åˆ†æœåŠ¡
   (ä½¿ç”¨Tokenä¸­         (ä½¿ç”¨Tokenä¸­        (ä½¿ç”¨Tokenä¸­
    çš„ç”¨æˆ·ä¿¡æ¯)          çš„ç”¨æˆ·ä¿¡æ¯)         çš„ç”¨æˆ·ä¿¡æ¯)
```

ğŸ”‘ **å…³é”®ç‚¹**ï¼š
- ç½‘å…³éªŒè¯Token â†’ ç¡®ä¿å®‰å…¨
- è½¬å‘Tokenç»™åç«¯ â†’ ä¼ é€’ç”¨æˆ·èº«ä»½
- åç«¯ç›´æ¥ä½¿ç”¨ â†’ æ— éœ€å†æ¬¡éªŒè¯

---

## 3. âš™ï¸ Spring Cloud Gateway OAuth2é…ç½®


### 3.1 æ ¸å¿ƒä¾èµ–å¼•å…¥


**å¿…éœ€çš„ä¾èµ–**ï¼š

```xml
<!-- Spring Cloud Gateway -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-gateway</artifactId>
</dependency>

<!-- OAuth2 èµ„æºæœåŠ¡å™¨æ”¯æŒ -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-oauth2-resource-server</artifactId>
</dependency>

<!-- JWT è§£æ -->
<dependency>
    <groupId>org.springframework.security</groupId>
    <artifactId>spring-security-oauth2-jose</artifactId>
</dependency>
```

> ğŸ“– **ä¾èµ–è¯´æ˜**
> - `gateway`ï¼šæä¾›ç½‘å…³è·¯ç”±åŠŸèƒ½
> - `oauth2-resource-server`ï¼šå°†ç½‘å…³ä½œä¸ºèµ„æºæœåŠ¡å™¨ï¼ŒéªŒè¯Token
> - `oauth2-jose`ï¼šè§£æJWTæ ¼å¼çš„Token

### 3.2 åŸºç¡€é…ç½®æ–‡ä»¶


**application.yml æ ¸å¿ƒé…ç½®**ï¼š

```yaml
spring:
  cloud:
    gateway:
      routes:
        # å…¬å¼€è·¯ç”± - æ— éœ€è®¤è¯
        - id: public-route
          uri: lb://product-service
          predicates:
            - Path=/api/products/**
          
        # ç§æœ‰è·¯ç”± - éœ€è¦è®¤è¯
        - id: private-route
          uri: lb://order-service
          predicates:
            - Path=/api/orders/**
          filters:
            - TokenRelay=  # è½¬å‘Tokenåˆ°åç«¯

  # OAuth2 èµ„æºæœåŠ¡å™¨é…ç½®
  security:
    oauth2:
      resourceserver:
        jwt:
          # JWTç­¾å‘è€…åœ°å€
          issuer-uri: http://auth-server:9000
          # æˆ–ç›´æ¥æŒ‡å®šå…¬é’¥åœ°å€
          jwk-set-uri: http://auth-server:9000/.well-known/jwks.json
```

> ğŸ’¡ **é…ç½®è¦ç‚¹**
> - `issuer-uri`ï¼šè®¤è¯æœåŠ¡å™¨åœ°å€ï¼Œç½‘å…³ä¼šè‡ªåŠ¨è·å–å…¬é’¥éªŒè¯Token
> - `TokenRelay`ï¼šè‡ªåŠ¨å°†Tokenè½¬å‘ç»™ä¸‹æ¸¸æœåŠ¡
> - `lb://`ï¼šè´Ÿè½½å‡è¡¡æ–¹å¼è°ƒç”¨æœåŠ¡

### 3.3 å®‰å…¨é…ç½®ç±»


**åˆ›å»ºSecurityConfigé…ç½®**ï¼š

```java
@Configuration
@EnableWebFluxSecurity  // æ³¨æ„ï¼šGatewayä½¿ç”¨WebFlux
public class SecurityConfig {

    @Bean
    public SecurityWebFilterChain securityWebFilterChain(
            ServerHttpSecurity http) {
        
        http
            // 1. è·¯ç”±è®¿é—®æ§åˆ¶
            .authorizeExchange(exchanges -> exchanges
                // å…¬å¼€è·¯å¾„
                .pathMatchers("/api/products/**").permitAll()
                .pathMatchers("/api/public/**").permitAll()
                
                // éœ€è¦è®¤è¯çš„è·¯å¾„
                .pathMatchers("/api/orders/**").authenticated()
                
                // éœ€è¦ç®¡ç†å‘˜æƒé™
                .pathMatchers("/api/admin/**").hasRole("ADMIN")
                
                // å…¶ä»–è¯·æ±‚éƒ½éœ€è¦è®¤è¯
                .anyExchange().authenticated()
            )
            
            // 2. é…ç½®OAuth2èµ„æºæœåŠ¡å™¨
            .oauth2ResourceServer(oauth2 -> oauth2
                .jwt(jwt -> jwt
                    // è‡ªå®šä¹‰JWTè§£æ
                    .jwtAuthenticationConverter(jwtAuthenticationConverter())
                )
            )
            
            // 3. ç¦ç”¨CSRF(å‰åç«¯åˆ†ç¦»é¡¹ç›®)
            .csrf(ServerHttpSecurity.CsrfSpec::disable);
        
        return http.build();
    }
    
    // JWTè½¬æ¢å™¨ï¼šæå–æƒé™ä¿¡æ¯
    @Bean
    public Converter<Jwt, Mono<AbstractAuthenticationToken>> 
            jwtAuthenticationConverter() {
        
        JwtAuthenticationConverter converter = 
            new JwtAuthenticationConverter();
        
        // ä»Tokenä¸­æå–è§’è‰²
        converter.setJwtGrantedAuthoritiesConverter(jwt -> {
            List<String> authorities = jwt.getClaimAsStringList("authorities");
            return authorities.stream()
                .map(SimpleGrantedAuthority::new)
                .collect(Collectors.toList());
        });
        
        return new ReactiveJwtAuthenticationConverterAdapter(converter);
    }
}
```

ğŸ” **é…ç½®è¯¦è§£**ï¼š

| é…ç½®é¡¹ | ä½œç”¨ | è¯´æ˜ |
|-------|-----|------|
| `permitAll()` | æ”¾è¡Œè·¯å¾„ | æ— éœ€è®¤è¯ï¼Œä»»ä½•äººå¯è®¿é—® |
| `authenticated()` | éœ€è¦è®¤è¯ | å¿…é¡»æºå¸¦æœ‰æ•ˆToken |
| `hasRole()` | è§’è‰²æ£€æŸ¥ | æ£€æŸ¥Tokenä¸­çš„è§’è‰²ä¿¡æ¯ |
| `oauth2ResourceServer()` | OAuth2éªŒè¯ | å¯ç”¨TokenéªŒè¯åŠŸèƒ½ |

---

## 4. ğŸ¯ ç»Ÿä¸€é‰´æƒä¸è·¯ç”±è®¤è¯


### 4.1 ç»Ÿä¸€é‰´æƒæµç¨‹


**å®Œæ•´çš„è¯·æ±‚é‰´æƒæµç¨‹**ï¼š

```
æ­¥éª¤1: è¯·æ±‚åˆ°è¾¾ç½‘å…³
   GET /api/orders/123
   Authorization: Bearer eyJhbGc...

æ­¥éª¤2: æå–Token
   ç½‘å…³ä»Headerä¸­æå–Token
   Token: eyJhbGc...

æ­¥éª¤3: éªŒè¯Token
   â†’ è§£æJWT
   â†’ éªŒè¯ç­¾åï¼ˆä½¿ç”¨è®¤è¯æœåŠ¡å™¨å…¬é’¥ï¼‰
   â†’ æ£€æŸ¥è¿‡æœŸæ—¶é—´
   â†’ æå–ç”¨æˆ·ä¿¡æ¯å’Œæƒé™

æ­¥éª¤4: æƒé™æ£€æŸ¥
   è·¯å¾„: /api/orders/123
   è¦æ±‚: authenticated()
   ç”¨æˆ·: å·²è®¤è¯ âœ“
   
æ­¥éª¤5: è·¯ç”±è½¬å‘
   â†’ æ·»åŠ ç”¨æˆ·ä¸Šä¸‹æ–‡
   â†’ è½¬å‘Tokenåˆ°åç«¯
   â†’ è°ƒç”¨ order-service
```

### 4.2 è·¯ç”±çº§åˆ«çš„è®¤è¯é…ç½®


**çµæ´»çš„è·¯ç”±è®¤è¯ç­–ç•¥**ï¼š

```yaml
spring:
  cloud:
    gateway:
      routes:
        # åœºæ™¯1: å®Œå…¨å…¬å¼€çš„API
        - id: product-list
          uri: lb://product-service
          predicates:
            - Path=/api/products/list
          metadata:
            auth: none  # æ ‡è®°ï¼šæ— éœ€è®¤è¯

        # åœºæ™¯2: éœ€è¦ç™»å½•çš„ç”¨æˆ·API  
        - id: user-orders
          uri: lb://order-service
          predicates:
            - Path=/api/orders/**
          metadata:
            auth: required  # æ ‡è®°ï¼šå¿…é¡»è®¤è¯
            
        # åœºæ™¯3: ç‰¹å®šæƒé™çš„ç®¡ç†API
        - id: admin-api
          uri: lb://admin-service
          predicates:
            - Path=/api/admin/**
          metadata:
            auth: required
            roles: ADMIN,SUPER_ADMIN  # å¤šä¸ªè§’è‰²
```

**åŠ¨æ€æƒé™æ£€æŸ¥**ï¼š

```java
// è‡ªå®šä¹‰è·¯ç”±è¿‡æ»¤å™¨ï¼Œæ”¯æŒåŠ¨æ€æƒé™
@Component
public class DynamicAuthFilter implements GlobalFilter, Ordered {

    @Override
    public Mono<Void> filter(ServerWebExchange exchange, 
                             GatewayFilterChain chain) {
        
        // è·å–è·¯ç”±å…ƒæ•°æ®
        Route route = exchange.getAttribute(GATEWAY_ROUTE_ATTR);
        Map<String, Object> metadata = route.getMetadata();
        
        String authType = (String) metadata.get("auth");
        
        // æ— éœ€è®¤è¯ï¼Œç›´æ¥æ”¾è¡Œ
        if ("none".equals(authType)) {
            return chain.filter(exchange);
        }
        
        // éœ€è¦è®¤è¯ï¼Œæ£€æŸ¥Token
        return exchange.getPrincipal()
            .switchIfEmpty(Mono.error(
                new AccessDeniedException("æœªç™»å½•")))
            .flatMap(principal -> {
                // æ£€æŸ¥è§’è‰²ï¼ˆå¦‚æœéœ€è¦ï¼‰
                String roles = (String) metadata.get("roles");
                if (roles != null) {
                    return checkRoles(principal, roles)
                        .then(chain.filter(exchange));
                }
                return chain.filter(exchange);
            });
    }
    
    @Override
    public int getOrder() {
        return -100;  // ä¼˜å…ˆçº§é«˜ï¼Œæ—©æ‰§è¡Œ
    }
}
```

---

## 5. ğŸ”„ å…¨å±€è¿‡æ»¤å™¨å®ç°


### 5.1 å…¨å±€OAuth2è¿‡æ»¤å™¨


**ç»Ÿä¸€çš„TokenéªŒè¯è¿‡æ»¤å™¨**ï¼š

```java
@Component
@Slf4j
public class GlobalOAuth2Filter implements GlobalFilter, Ordered {

    @Autowired
    private ReactiveJwtDecoder jwtDecoder;

    @Override
    public Mono<Void> filter(ServerWebExchange exchange, 
                             GatewayFilterChain chain) {
        
        ServerHttpRequest request = exchange.getRequest();
        
        // 1. æå–Token
        String token = extractToken(request);
        
        if (token == null) {
            // æ— Tokenï¼Œç»§ç»­æ‰§è¡Œï¼ˆç”±å®‰å…¨é…ç½®å†³å®šæ˜¯å¦æ”¾è¡Œï¼‰
            return chain.filter(exchange);
        }
        
        // 2. éªŒè¯å¹¶è§£æToken
        return jwtDecoder.decode(token)
            .flatMap(jwt -> {
                // 3. æå–ç”¨æˆ·ä¿¡æ¯
                String userId = jwt.getClaimAsString("user_id");
                String username = jwt.getClaimAsString("user_name");
                
                // 4. æ·»åŠ åˆ°è¯·æ±‚å¤´ï¼Œä¼ é€’ç»™ä¸‹æ¸¸æœåŠ¡
                ServerHttpRequest mutatedRequest = request.mutate()
                    .header("X-User-Id", userId)
                    .header("X-Username", username)
                    .build();
                
                log.info("ç”¨æˆ· {} è®¿é—® {}", username, 
                    request.getURI().getPath());
                
                return chain.filter(
                    exchange.mutate().request(mutatedRequest).build()
                );
            })
            .onErrorResume(e -> {
                // Tokenæ— æ•ˆæˆ–è¿‡æœŸ
                log.error("TokenéªŒè¯å¤±è´¥: {}", e.getMessage());
                return unauthorized(exchange);
            });
    }
    
    // æå–Token
    private String extractToken(ServerHttpRequest request) {
        String bearerToken = request.getHeaders()
            .getFirst(HttpHeaders.AUTHORIZATION);
        
        if (bearerToken != null && bearerToken.startsWith("Bearer ")) {
            return bearerToken.substring(7);
        }
        return null;
    }
    
    // è¿”å›401æœªæˆæƒ
    private Mono<Void> unauthorized(ServerWebExchange exchange) {
        exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);
        return exchange.getResponse().setComplete();
    }

    @Override
    public int getOrder() {
        return -200;  // æœ€é«˜ä¼˜å…ˆçº§
    }
}
```

### 5.2 è¿‡æ»¤å™¨é“¾æ‰§è¡Œé¡ºåº


```
è¯·æ±‚å¤„ç†é¡ºåºï¼ˆOrderå€¼ä»å°åˆ°å¤§ï¼‰ï¼š

-200: GlobalOAuth2Filter      â† æœ€å…ˆæ‰§è¡Œï¼ŒéªŒè¯Token
  â†“
-100: DynamicAuthFilter        â† æ£€æŸ¥è·¯ç”±æƒé™
  â†“
  0 : é»˜è®¤è·¯ç”±è¿‡æ»¤å™¨           â† Spring Cloud Gatewayé»˜è®¤è¿‡æ»¤
  â†“
100 : æ—¥å¿—è¿‡æ»¤å™¨               â† è®°å½•è¯·æ±‚æ—¥å¿—
  â†“
â†’ è½¬å‘åˆ°åç«¯æœåŠ¡
```

> âš ï¸ **é‡è¦æé†’**
> Orderå€¼è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼è®¤è¯è¿‡æ»¤å™¨å¿…é¡»æœ€å…ˆæ‰§è¡Œã€‚

---

## 6. ğŸ“¤ Tokenè½¬å‘æœºåˆ¶


### 6.1 è‡ªåŠ¨Tokenè½¬å‘


**ä½¿ç”¨TokenRelayè¿‡æ»¤å™¨**ï¼š

```yaml
spring:
  cloud:
    gateway:
      routes:
        - id: order-service
          uri: lb://order-service
          predicates:
            - Path=/api/orders/**
          filters:
            - TokenRelay=  # è‡ªåŠ¨è½¬å‘Token
```

**è½¬å‘æ•ˆæœ**ï¼š

```
å®¢æˆ·ç«¯è¯·æ±‚ï¼š
GET /api/orders/123
Authorization: Bearer eyJhbGc...

ç½‘å…³è½¬å‘åˆ°åç«¯ï¼š
GET http://order-service/api/orders/123
Authorization: Bearer eyJhbGc...  â† Tokenè‡ªåŠ¨è½¬å‘
X-User-Id: 10001                  â† é™„åŠ ç”¨æˆ·ä¿¡æ¯
X-Username: zhangsan
```

### 6.2 æ‰‹åŠ¨Tokenå¤„ç†


**è‡ªå®šä¹‰Tokenè½¬å‘é€»è¾‘**ï¼š

```java
@Component
public class CustomTokenRelayFilter implements GlobalFilter, Ordered {

    @Override
    public Mono<Void> filter(ServerWebExchange exchange, 
                             GatewayFilterChain chain) {
        
        return exchange.getPrincipal()
            .filter(principal -> principal instanceof JwtAuthenticationToken)
            .cast(JwtAuthenticationToken.class)
            .map(authentication -> {
                // è·å–åŸå§‹Token
                Jwt jwt = authentication.getToken();
                String tokenValue = jwt.getTokenValue();
                
                // æ·»åŠ åˆ°è¯·æ±‚å¤´
                ServerHttpRequest request = exchange.getRequest().mutate()
                    .header(HttpHeaders.AUTHORIZATION, 
                           "Bearer " + tokenValue)
                    .build();
                
                return exchange.mutate().request(request).build();
            })
            .defaultIfEmpty(exchange)
            .flatMap(chain::filter);
    }

    @Override
    public int getOrder() {
        return -150;
    }
}
```

### 6.3 Tokenåˆ·æ–°è½¬å‘


**å¤„ç†Tokenåˆ·æ–°åœºæ™¯**ï¼š

```java
@Component
public class TokenRefreshFilter implements GlobalFilter, Ordered {

    @Autowired
    private WebClient.Builder webClientBuilder;

    @Override
    public Mono<Void> filter(ServerWebExchange exchange, 
                             GatewayFilterChain chain) {
        
        return exchange.getPrincipal()
            .cast(JwtAuthenticationToken.class)
            .flatMap(auth -> {
                Jwt jwt = auth.getToken();
                
                // æ£€æŸ¥Tokenå³å°†è¿‡æœŸï¼ˆ10åˆ†é’Ÿå†…ï¼‰
                Instant expiresAt = jwt.getExpiresAt();
                if (isTokenExpiringSoon(expiresAt)) {
                    // åˆ·æ–°Token
                    return refreshToken(jwt)
                        .flatMap(newToken -> {
                            // ä½¿ç”¨æ–°Tokenè½¬å‘
                            return forwardWithNewToken(exchange, 
                                                      chain, newToken);
                        });
                }
                
                return chain.filter(exchange);
            })
            .switchIfEmpty(chain.filter(exchange));
    }
    
    private boolean isTokenExpiringSoon(Instant expiresAt) {
        return expiresAt.isBefore(
            Instant.now().plusSeconds(600)  // 10åˆ†é’Ÿ
        );
    }

    @Override
    public int getOrder() {
        return -180;
    }
}
```

---

## 7. ğŸ›¡ï¸ æƒé™æ‹¦æˆªç­–ç•¥


### 7.1 åŸºäºè§’è‰²çš„æ‹¦æˆª


**å¤šçº§æƒé™æ§åˆ¶**ï¼š

```java
@Configuration
public class RoleBasedSecurityConfig {

    @Bean
    public SecurityWebFilterChain roleBasedFilterChain(
            ServerHttpSecurity http) {
        
        http.authorizeExchange(exchanges -> exchanges
            // æ™®é€šç”¨æˆ·æƒé™
            .pathMatchers("/api/orders/**")
                .hasAnyRole("USER", "VIP", "ADMIN")
            
            // VIPç”¨æˆ·æƒé™
            .pathMatchers("/api/vip/**")
                .hasAnyRole("VIP", "ADMIN")
            
            // ç®¡ç†å‘˜æƒé™
            .pathMatchers("/api/admin/**")
                .hasRole("ADMIN")
            
            // è¶…çº§ç®¡ç†å‘˜æƒé™
            .pathMatchers("/api/system/**")
                .hasRole("SUPER_ADMIN")
        );
        
        return http.build();
    }
}
```

### 7.2 åŸºäºèµ„æºçš„æ‹¦æˆª


**åŠ¨æ€èµ„æºæƒé™æ£€æŸ¥**ï¼š

```java
@Component
public class ResourceAuthFilter implements GlobalFilter, Ordered {

    @Autowired
    private PermissionService permissionService;

    @Override
    public Mono<Void> filter(ServerWebExchange exchange, 
                             GatewayFilterChain chain) {
        
        String path = exchange.getRequest().getURI().getPath();
        String method = exchange.getRequest().getMethod().name();
        
        return exchange.getPrincipal()
            .cast(JwtAuthenticationToken.class)
            .flatMap(auth -> {
                String userId = auth.getToken()
                    .getClaimAsString("user_id");
                
                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®è¯¥èµ„æº
                return permissionService
                    .hasPermission(userId, path, method)
                    .flatMap(hasPermission -> {
                        if (hasPermission) {
                            return chain.filter(exchange);
                        } else {
                            return forbidden(exchange);
                        }
                    });
            });
    }
    
    private Mono<Void> forbidden(ServerWebExchange exchange) {
        exchange.getResponse().setStatusCode(HttpStatus.FORBIDDEN);
        return exchange.getResponse().setComplete();
    }

    @Override
    public int getOrder() {
        return -90;
    }
}
```

### 7.3 IPç™½åå•æ‹¦æˆª


**åŸºäºIPçš„å®‰å…¨æ§åˆ¶**ï¼š

```java
@Component
public class IpWhitelistFilter implements GlobalFilter, Ordered {

    // IPç™½åå•ï¼ˆå®é™…åº”ä»é…ç½®ä¸­å¿ƒè¯»å–ï¼‰
    private final Set<String> whitelist = Set.of(
        "192.168.1.0/24",  // å†…ç½‘æ®µ
        "10.0.0.0/8"       // VPNç½‘æ®µ
    );

    @Override
    public Mono<Void> filter(ServerWebExchange exchange, 
                             GatewayFilterChain chain) {
        
        // è·å–å®¢æˆ·ç«¯IP
        String clientIp = exchange.getRequest()
            .getRemoteAddress().getAddress().getHostAddress();
        
        // æ£€æŸ¥ç‰¹å®šè·¯å¾„æ˜¯å¦éœ€è¦IPç™½åå•
        String path = exchange.getRequest().getURI().getPath();
        if (path.startsWith("/api/admin/")) {
            if (!isIpAllowed(clientIp)) {
                log.warn("IP {} å°è¯•è®¿é—®å—é™èµ„æº", clientIp);
                return forbidden(exchange);
            }
        }
        
        return chain.filter(exchange);
    }
    
    private boolean isIpAllowed(String ip) {
        // å®é™…åº”ä½¿ç”¨IPæ®µåŒ¹é…ç®—æ³•
        return whitelist.stream()
            .anyMatch(range -> isIpInRange(ip, range));
    }

    @Override
    public int getOrder() {
        return -250;  // æœ€å…ˆæ£€æŸ¥IP
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å…³é”®æ¦‚å¿µå›é¡¾


ğŸ¯ **å¿…çŸ¥å¿…ä¼šçš„æ ¸å¿ƒæ¦‚å¿µ**ï¼š

```
1. ç»Ÿä¸€é‰´æƒ
   â†’ ç½‘å…³ä½œä¸ºå”¯ä¸€å®‰å…¨å…¥å£
   â†’ æ‰€æœ‰è¯·æ±‚å…ˆç»è¿‡ç½‘å…³è®¤è¯
   â†’ åç«¯æœåŠ¡ä¿¡ä»»ç½‘å…³ï¼Œæ— éœ€å†è®¤è¯

2. è·¯ç”±è®¤è¯
   â†’ ä¸åŒè·¯ç”±é…ç½®ä¸åŒçš„è®¤è¯ç­–ç•¥
   â†’ æ”¯æŒå…¬å¼€ã€ç§æœ‰ã€è§’è‰²é™åˆ¶ç­‰å¤šç§ç­–ç•¥
   â†’ çµæ´»çš„æƒé™æ§åˆ¶

3. Tokenè½¬å‘
   â†’ ç½‘å…³éªŒè¯Tokenåè½¬å‘ç»™åç«¯
   â†’ åç«¯é€šè¿‡Tokenè·å–ç”¨æˆ·ä¿¡æ¯
   â†’ é¿å…é‡å¤éªŒè¯ï¼Œæå‡æ€§èƒ½

4. å…¨å±€è¿‡æ»¤å™¨
   â†’ ç»Ÿä¸€å¤„ç†TokenéªŒè¯é€»è¾‘
   â†’ æŒ‰Orderå€¼æ§åˆ¶æ‰§è¡Œé¡ºåº
   â†’ æ”¯æŒè‡ªå®šä¹‰æ‰©å±•

5. æƒé™æ‹¦æˆª
   â†’ åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰
   â†’ åŸºäºèµ„æºçš„åŠ¨æ€æƒé™
   â†’ IPç™½åå•ç­‰å®‰å…¨ç­–ç•¥
```

### 8.2 å®æ–½æ­¥éª¤æ¸…å•


âœ… **é…ç½®ç½‘å…³OAuth2çš„å®Œæ•´æ­¥éª¤**ï¼š

- [ ] **æ­¥éª¤1**ï¼šæ·»åŠ å¿…éœ€ä¾èµ–ï¼ˆgatewayã€oauth2-resource-serverï¼‰
- [ ] **æ­¥éª¤2**ï¼šé…ç½®OAuth2èµ„æºæœåŠ¡å™¨ï¼ˆissuer-uriï¼‰
- [ ] **æ­¥éª¤3**ï¼šåˆ›å»ºSecurityConfigç±»ï¼Œé…ç½®è·¯ç”±æƒé™
- [ ] **æ­¥éª¤4**ï¼šå®ç°å…¨å±€è¿‡æ»¤å™¨ï¼Œå¤„ç†TokenéªŒè¯
- [ ] **æ­¥éª¤5**ï¼šé…ç½®TokenRelayï¼Œè½¬å‘Tokenåˆ°åç«¯
- [ ] **æ­¥éª¤6**ï¼šå®ç°è‡ªå®šä¹‰æƒé™æ‹¦æˆªï¼ˆå¯é€‰ï¼‰
- [ ] **æ­¥éª¤7**ï¼šæµ‹è¯•å„ç§è®¤è¯åœºæ™¯

### 8.3 å¸¸è§é—®é¢˜ä¸è§£å†³


â“ **FAQå¿«é€ŸæŸ¥æ‰¾**ï¼š

| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|---------|
| TokenéªŒè¯å¤±è´¥ | å…¬é’¥é…ç½®é”™è¯¯ | æ£€æŸ¥`jwk-set-uri`æ˜¯å¦æ­£ç¡® |
| Tokenæ— æ³•è½¬å‘ | ç¼ºå°‘TokenRelay | æ·»åŠ `TokenRelay=`è¿‡æ»¤å™¨ |
| æƒé™æ£€æŸ¥ä¸ç”Ÿæ•ˆ | è¿‡æ»¤å™¨é¡ºåºé”™è¯¯ | è°ƒæ•´Orderå€¼ï¼Œè®¤è¯è¿‡æ»¤å™¨ä¼˜å…ˆ |
| åç«¯æ”¶ä¸åˆ°ç”¨æˆ·ä¿¡æ¯ | æœªæ·»åŠ è‡ªå®šä¹‰Header | åœ¨è¿‡æ»¤å™¨ä¸­æ·»åŠ X-User-Idç­‰ |

### 8.4 æœ€ä½³å®è·µå»ºè®®


ğŸ’¡ **ç”Ÿäº§ç¯å¢ƒå»ºè®®**ï¼š

1. **å®‰å…¨é…ç½®**
   - ä½¿ç”¨HTTPSä¿æŠ¤Tokenä¼ è¾“
   - å®šæœŸæ›´æ–°è®¤è¯æœåŠ¡å™¨å¯†é’¥
   - æ•æ„Ÿè·¯ç”±é…ç½®IPç™½åå•

2. **æ€§èƒ½ä¼˜åŒ–**
   - TokenéªŒè¯ç»“æœç¼“å­˜ï¼ˆRedisï¼‰
   - ä½¿ç”¨æœ¬åœ°å…¬é’¥éªŒè¯ï¼Œå‡å°‘ç½‘ç»œè¯·æ±‚
   - åˆç†è®¾ç½®Tokenè¿‡æœŸæ—¶é—´

3. **ç›‘æ§å‘Šè­¦**
   - è®°å½•TokenéªŒè¯å¤±è´¥æ—¥å¿—
   - ç›‘æ§å¼‚å¸¸IPè®¿é—®
   - ç»Ÿè®¡å„è·¯ç”±çš„è®¤è¯é€šè¿‡ç‡

### 8.5 å­¦ä¹ è·¯å¾„æŒ‡å¼•


ğŸ“š **è¿›é˜¶å­¦ä¹ å»ºè®®**ï¼š

```
åŸºç¡€é˜¶æ®µï¼ˆå½“å‰ï¼‰ï¼š
âœ“ ç†è§£ç»Ÿä¸€é‰´æƒæ¦‚å¿µ
âœ“ æŒæ¡åŸºæœ¬é…ç½®æ–¹æ³•
âœ“ å®ç°ç®€å•çš„Tokenè½¬å‘

è¿›é˜¶é˜¶æ®µï¼š
â†’ è‡ªå®šä¹‰JWTè§£æé€»è¾‘
â†’ å®ç°åŠ¨æ€æƒé™æ§åˆ¶
â†’ Tokenåˆ·æ–°æœºåˆ¶

é«˜çº§é˜¶æ®µï¼š
â†’ å¤šç§Ÿæˆ·è®¤è¯
â†’ ç»†ç²’åº¦æƒé™æ§åˆ¶
â†’ æ€§èƒ½è°ƒä¼˜ä¸ç›‘æ§
```

---

ğŸ”‘ **æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
ç½‘å…³OAuthé›†æˆï¼Œå®‰å…¨ç¬¬ä¸€é“é—¨
ç»Ÿä¸€é‰´æƒTokenéªŒï¼Œåç«¯ä¿¡ä»»ä¸é‡éªŒ
è·¯ç”±è®¤è¯çµæ´»é…ï¼Œè§’è‰²æƒé™åŠ¨æ€ç®¡
è¿‡æ»¤å™¨é“¾æœ‰é¡ºåºï¼ŒTokenè½¬å‘è¦å®Œæ•´
```