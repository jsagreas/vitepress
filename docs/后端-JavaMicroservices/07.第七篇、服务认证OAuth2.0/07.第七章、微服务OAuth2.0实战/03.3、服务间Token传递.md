---
title: 3ã€æœåŠ¡é—´Tokenä¼ é€’
---
## ğŸ“š ç›®å½•

1. [ä¸ºä»€ä¹ˆéœ€è¦æœåŠ¡é—´Tokenä¼ é€’](#1-ä¸ºä»€ä¹ˆéœ€è¦æœåŠ¡é—´Tokenä¼ é€’)
2. [Tokenä¼ é€’çš„æ ¸å¿ƒæ¦‚å¿µ](#2-Tokenä¼ é€’çš„æ ¸å¿ƒæ¦‚å¿µ)
3. [Feignå®¢æˆ·ç«¯Tokenä¼ é€’](#3-Feignå®¢æˆ·ç«¯Tokenä¼ é€’)
4. [RestTemplate Tokenä¼ é€’](#4-RestTemplate-Tokenä¼ é€’)
5. [WebClient Tokenä¼ é€’](#5-WebClient-Tokenä¼ é€’)
6. [Token Relayä¸­ç»§æœºåˆ¶](#6-Token-Relayä¸­ç»§æœºåˆ¶)
7. [æœåŠ¡é“¾è°ƒç”¨å®‰å…¨](#7-æœåŠ¡é“¾è°ƒç”¨å®‰å…¨)
8. [æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#8-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¤” ä¸ºä»€ä¹ˆéœ€è¦æœåŠ¡é—´Tokenä¼ é€’


### 1.1 å®é™…åœºæ™¯ç†è§£


æƒ³è±¡ä¸€ä¸ªç”µå•†ç³»ç»Ÿçš„çœŸå®åœºæ™¯ï¼š

```
ç”¨æˆ·ä¸‹å•æµç¨‹ï¼š
ç”¨æˆ· â†’ è®¢å•æœåŠ¡ â†’ åº“å­˜æœåŠ¡ â†’ æ”¯ä»˜æœåŠ¡
     (å¸¦Token)   (éœ€è¦Token) (éœ€è¦Token)

é—®é¢˜ï¼š
- è®¢å•æœåŠ¡æ”¶åˆ°äº†ç”¨æˆ·çš„Token
- ä½†åº“å­˜æœåŠ¡æ€ä¹ˆçŸ¥é“æ˜¯è°åœ¨è°ƒç”¨ï¼Ÿ
- æ”¯ä»˜æœåŠ¡æ€ä¹ˆçŸ¥é“è¿™ä¸ªè®¢å•æ˜¯åˆæ³•çš„ï¼Ÿ
```

**æ ¸å¿ƒé—®é¢˜**ï¼šç”¨æˆ·åªç™»å½•ä¸€æ¬¡ï¼Œä½†è¯·æ±‚éœ€è¦ç»è¿‡å¤šä¸ªæœåŠ¡ï¼Œæ¯ä¸ªæœåŠ¡éƒ½éœ€è¦éªŒè¯èº«ä»½ã€‚

### 1.2 æ²¡æœ‰Tokenä¼ é€’ä¼šæ€æ ·


```
âŒ ç³Ÿç³•çš„æƒ…å†µï¼š

åœºæ™¯1ï¼šè®¢å•æœåŠ¡è°ƒç”¨åº“å­˜æœåŠ¡
è®¢å•æœåŠ¡ --[æ²¡æœ‰Token]--> åº“å­˜æœåŠ¡ 
ç»“æœï¼šåº“å­˜æœåŠ¡æ‹’ç»è®¿é—®ï¼ˆ401æœªæˆæƒï¼‰

åœºæ™¯2ï¼šæ¶æ„è°ƒç”¨
é»‘å®¢ --[ä¼ªé€ è¯·æ±‚]--> åº“å­˜æœåŠ¡
ç»“æœï¼šå¦‚æœä¸éªŒè¯Tokenï¼Œæ•°æ®å¯èƒ½è¢«ç¯¡æ”¹

åœºæ™¯3ï¼šæƒé™æ··ä¹±
æ™®é€šç”¨æˆ·Token â†’ è®¢å•æœåŠ¡ â†’ åº“å­˜æœåŠ¡ï¼ˆç®¡ç†å‘˜æ“ä½œï¼‰
ç»“æœï¼šæ™®é€šç”¨æˆ·å¯èƒ½æ‰§è¡Œäº†ä¸è¯¥æœ‰çš„æƒé™
```

**ğŸ¯ Tokenä¼ é€’è§£å†³çš„æ ¸å¿ƒé—®é¢˜**ï¼š
- âœ… **èº«ä»½å»¶ç»­**ï¼šè®©ä¸‹æ¸¸æœåŠ¡çŸ¥é“"æ˜¯è°"åœ¨è®¿é—®
- âœ… **æƒé™ä¼ é€’**ï¼šä¿æŒç”¨æˆ·çš„æƒé™èŒƒå›´ä¸å˜
- âœ… **å®¡è®¡è¿½è¸ª**ï¼šè®°å½•å®Œæ•´çš„è°ƒç”¨é“¾è·¯
- âœ… **å®‰å…¨é˜²æŠ¤**ï¼šé˜²æ­¢æœåŠ¡è¢«éæ³•è°ƒç”¨

---

## 2. ğŸ”‘ Tokenä¼ é€’çš„æ ¸å¿ƒæ¦‚å¿µ


### 2.1 ä»€ä¹ˆæ˜¯Tokenä¼ é€’


**é€šä¿—è§£é‡Š**ï¼šå°±åƒæ¥åŠ›èµ›ä¼ é€’æ¥åŠ›æ£’

```
ç”¨æˆ·è¯·æ±‚æµç¨‹ï¼ˆæ¥åŠ›èµ›ï¼‰ï¼š

èµ·ç‚¹ï¼šç”¨æˆ·ç™»å½•è·å¾—Tokenï¼ˆæ¥åŠ›æ£’ï¼‰
ç¬¬1æ£’ï¼šç½‘å…³æ‹¿ç€Tokenä¼ ç»™è®¢å•æœåŠ¡
ç¬¬2æ£’ï¼šè®¢å•æœåŠ¡æ‹¿ç€Tokenä¼ ç»™åº“å­˜æœåŠ¡  
ç¬¬3æ£’ï¼šåº“å­˜æœåŠ¡æ‹¿ç€Tokenä¼ ç»™æ”¯ä»˜æœåŠ¡
ç»ˆç‚¹ï¼šæ”¯ä»˜æœåŠ¡å®Œæˆæ“ä½œ

æ ¸å¿ƒï¼šTokenåƒæ¥åŠ›æ£’ä¸€æ ·ï¼Œä¸€ç›´å¾€ä¸‹ä¼ ï¼Œä¸èƒ½ä¸¢å¤±ï¼
```

### 2.2 Tokenä¼ é€’çš„ä¸¤ç§æ–¹å¼


**æ–¹å¼å¯¹æ¯”**ï¼š

| ä¼ é€’æ–¹å¼ | **å®ç°åŸç†** | **é€‚ç”¨åœºæ™¯** | **ä¼˜ç¼ºç‚¹** |
|---------|------------|------------|-----------|
| ğŸ”¸ **æ‰‹åŠ¨ä¼ é€’** | `ä»£ç ä¸­æ˜¾å¼è·å–å’Œè®¾ç½®Token` | `ç®€å•åœºæ™¯ï¼Œè°ƒç”¨é“¾çŸ­` | `âœ…ç®€å•ç›´æ¥ âŒå®¹æ˜“é—æ¼` |
| ğŸ”¸ **è‡ªåŠ¨ä¼ é€’** | `é€šè¿‡æ‹¦æˆªå™¨è‡ªåŠ¨æ·»åŠ Token` | `å¤æ‚å¾®æœåŠ¡ï¼Œè°ƒç”¨é“¾é•¿` | `âœ…ä¸€æ¬¡é…ç½®æ°¸ä¹…ç”Ÿæ•ˆ âŒé…ç½®ç¨å¤æ‚` |

### 2.3 Tokenåœ¨HTTPä¸­çš„ä½ç½®


```
HTTPè¯·æ±‚å¤´ä¸­çš„Tokenï¼š

GET /api/inventory/check HTTP/1.1
Host: inventory-service
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                      â†‘
                    è¿™å°±æ˜¯Tokenï¼

æ ¸å¿ƒçŸ¥è¯†ï¼š
- Tokenæ”¾åœ¨HTTPè¯·æ±‚å¤´çš„ Authorization å­—æ®µ
- æ ¼å¼é€šå¸¸æ˜¯ï¼šBearer + ç©ºæ ¼ + Tokenå­—ç¬¦ä¸²
- Bearer æ˜¯ä¸€ä¸ªå›ºå®šå‰ç¼€ï¼Œè¡¨ç¤º"æŒæœ‰è€…ä»¤ç‰Œ"
```

---

## 3. ğŸ”§ Feignå®¢æˆ·ç«¯Tokenä¼ é€’


### 3.1 ä»€ä¹ˆæ˜¯Feign


**Feignç®€å•ç†è§£**ï¼šæŠŠHTTPè°ƒç”¨å†™å¾—åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·ç®€å•

```java
// ä¸ç”¨Feignï¼šå¤æ‚çš„HTTPè°ƒç”¨
RestTemplate restTemplate = new RestTemplate();
HttpHeaders headers = new HttpHeaders();
headers.set("Authorization", "Bearer " + token);
HttpEntity entity = new HttpEntity(headers);
ResponseEntity<String> response = restTemplate.exchange(
    "http://inventory-service/api/check",
    HttpMethod.GET,
    entity,
    String.class
);

// ä½¿ç”¨Feignï¼šåƒè°ƒæœ¬åœ°æ–¹æ³•
@FeignClient("inventory-service")
interface InventoryClient {
    @GetMapping("/api/check")
    String checkInventory();
}
// è°ƒç”¨ï¼šinventoryClient.checkInventory();
```

### 3.2 Feignè‡ªåŠ¨ä¼ é€’Tokenï¼ˆæ¨èæ–¹å¼ï¼‰


**ğŸ¯ æ ¸å¿ƒæ€è·¯**ï¼šå†™ä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œè‡ªåŠ¨ç»™æ¯ä¸ªFeignè¯·æ±‚åŠ ä¸ŠToken

**æ­¥éª¤1ï¼šåˆ›å»ºTokenæ‹¦æˆªå™¨**

```java
/**
 * Feignè¯·æ±‚æ‹¦æˆªå™¨ - è‡ªåŠ¨ä¼ é€’Token
 * 
 * å·¥ä½œåŸç†ï¼š
 * 1. ä»å½“å‰è¯·æ±‚ä¸­è·å–Token
 * 2. æŠŠTokenæ·»åŠ åˆ°Feignè¯·æ±‚å¤´ä¸­
 * 3. è‡ªåŠ¨ç”Ÿæ•ˆï¼Œä¸éœ€è¦æ‰‹åŠ¨å¤„ç†
 */
@Component
public class FeignTokenInterceptor implements RequestInterceptor {
    
    @Override
    public void apply(RequestTemplate template) {
        // ğŸ”¸ Step1: ä»å½“å‰HTTPè¯·æ±‚ä¸­è·å–Token
        ServletRequestAttributes attributes = 
            (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        
        if (attributes != null) {
            HttpServletRequest request = attributes.getRequest();
            String token = request.getHeader("Authorization");
            
            // ğŸ”¸ Step2: å¦‚æœTokenå­˜åœ¨ï¼Œæ·»åŠ åˆ°Feignè¯·æ±‚ä¸­
            if (token != null && !token.isEmpty()) {
                template.header("Authorization", token);
            }
        }
    }
}
```

**æ­¥éª¤2ï¼šå¯ç”¨æ‹¦æˆªå™¨**

```java
// æ–¹å¼1ï¼šå…¨å±€é…ç½®ï¼ˆæ‰€æœ‰Feignå®¢æˆ·ç«¯éƒ½ç”Ÿæ•ˆï¼‰
@Configuration
public class FeignConfig {
    @Bean
    public RequestInterceptor tokenInterceptor() {
        return new FeignTokenInterceptor();
    }
}

// æ–¹å¼2ï¼šæŒ‡å®šå®¢æˆ·ç«¯é…ç½®ï¼ˆåªå¯¹ç‰¹å®šå®¢æˆ·ç«¯ç”Ÿæ•ˆï¼‰
@FeignClient(name = "inventory-service", 
             configuration = FeignTokenConfig.class)
interface InventoryClient {
    @GetMapping("/api/check")
    String checkInventory();
}
```

### 3.3 å®é™…ä½¿ç”¨ç¤ºä¾‹


```java
@Service
public class OrderService {
    
    @Autowired
    private InventoryClient inventoryClient;
    
    public void createOrder(OrderDTO order) {
        // âœ… è°ƒç”¨æ—¶ä¸éœ€è¦æ‰‹åŠ¨ä¼ Tokenï¼Œæ‹¦æˆªå™¨è‡ªåŠ¨å¤„ç†
        String result = inventoryClient.checkInventory();
        
        // ç»§ç»­ä¸šåŠ¡é€»è¾‘...
    }
}
```

**ğŸ¯ å…³é”®ç†è§£**ï¼š
- é…ç½®ä¸€æ¬¡æ‹¦æˆªå™¨ï¼Œæ‰€æœ‰Feignè°ƒç”¨è‡ªåŠ¨å¸¦Token
- ä¸éœ€è¦æ¯æ¬¡è°ƒç”¨éƒ½å†™Tokenä¼ é€’ä»£ç 
- Tokenä»"å½“å‰è¯·æ±‚"è‡ªåŠ¨ä¼ é€’åˆ°"Feignè¯·æ±‚"

### 3.4 å¸¸è§é—®é¢˜å¤„ç†


```
âš ï¸ é—®é¢˜1ï¼šå¼‚æ­¥è°ƒç”¨æ—¶Tokenä¸¢å¤±

åŸå› ï¼šå¼‚æ­¥çº¿ç¨‹ä¸­è·å–ä¸åˆ°å½“å‰è¯·æ±‚çš„Token

è§£å†³æ–¹æ¡ˆï¼š
@Component
public class AsyncFeignInterceptor implements RequestInterceptor {
    
    @Override
    public void apply(RequestTemplate template) {
        // ä»ThreadLocalæˆ–å…¶ä»–åœ°æ–¹è·å–Token
        String token = TokenHolder.getToken();
        if (token != null) {
            template.header("Authorization", token);
        }
    }
}

âš ï¸ é—®é¢˜2ï¼šTokenè¿‡æœŸå¦‚ä½•å¤„ç†

æ–¹æ¡ˆ1ï¼šåœ¨æ‹¦æˆªå™¨ä¸­æ£€æŸ¥Tokenæœ‰æ•ˆæœŸï¼Œè‡ªåŠ¨åˆ·æ–°
æ–¹æ¡ˆ2ï¼šæ•è·401é”™è¯¯ï¼Œåˆ·æ–°Tokenåé‡è¯•
```

---

## 4. ğŸŒ RestTemplate Tokenä¼ é€’


### 4.1 ä»€ä¹ˆæ˜¯RestTemplate


**RestTemplateç†è§£**ï¼šSpringæä¾›çš„HTTPå®¢æˆ·ç«¯å·¥å…·ï¼Œæ¯”åŸç”ŸHttpClientå¥½ç”¨

```java
// åŸºæœ¬ç”¨æ³•
RestTemplate restTemplate = new RestTemplate();
String result = restTemplate.getForObject(
    "http://inventory-service/api/check",
    String.class
);
```

### 4.2 RestTemplateè‡ªåŠ¨ä¼ é€’Token


**æ–¹å¼1ï¼šä½¿ç”¨æ‹¦æˆªå™¨ï¼ˆæ¨èï¼‰**

```java
/**
 * RestTemplateæ‹¦æˆªå™¨ - è‡ªåŠ¨æ·»åŠ Token
 */
@Component
public class RestTemplateTokenInterceptor implements ClientHttpRequestInterceptor {
    
    @Override
    public ClientHttpResponse intercept(
            HttpRequest request, 
            byte[] body, 
            ClientHttpRequestExecution execution) throws IOException {
        
        // ğŸ”¸ è·å–å½“å‰è¯·æ±‚çš„Token
        ServletRequestAttributes attributes = 
            (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        
        if (attributes != null) {
            String token = attributes.getRequest().getHeader("Authorization");
            
            // ğŸ”¸ æ·»åŠ åˆ°RestTemplateè¯·æ±‚ä¸­
            if (token != null) {
                request.getHeaders().set("Authorization", token);
            }
        }
        
        // ç»§ç»­æ‰§è¡Œè¯·æ±‚
        return execution.execute(request, body);
    }
}
```

**é…ç½®RestTemplate**ï¼š

```java
@Configuration
public class RestTemplateConfig {
    
    @Bean
    public RestTemplate restTemplate(RestTemplateTokenInterceptor tokenInterceptor) {
        RestTemplate restTemplate = new RestTemplate();
        
        // ğŸ”¸ æ·»åŠ Tokenä¼ é€’æ‹¦æˆªå™¨
        List<ClientHttpRequestInterceptor> interceptors = new ArrayList<>();
        interceptors.add(tokenInterceptor);
        restTemplate.setInterceptors(interceptors);
        
        return restTemplate;
    }
}
```

**æ–¹å¼2ï¼šæ‰‹åŠ¨ä¼ é€’Token**

```java
@Service
public class OrderService {
    
    @Autowired
    private RestTemplate restTemplate;
    
    public String callInventory() {
        // ğŸ”¸ æ‰‹åŠ¨è·å–Token
        String token = getCurrentToken();
        
        // ğŸ”¸ åˆ›å»ºè¯·æ±‚å¤´
        HttpHeaders headers = new HttpHeaders();
        headers.set("Authorization", token);
        
        // ğŸ”¸ åˆ›å»ºè¯·æ±‚å®ä½“
        HttpEntity<String> entity = new HttpEntity<>(headers);
        
        // ğŸ”¸ å‘é€è¯·æ±‚
        ResponseEntity<String> response = restTemplate.exchange(
            "http://inventory-service/api/check",
            HttpMethod.GET,
            entity,
            String.class
        );
        
        return response.getBody();
    }
    
    private String getCurrentToken() {
        HttpServletRequest request = 
            ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes())
            .getRequest();
        return request.getHeader("Authorization");
    }
}
```

### 4.3 å¯¹æ¯”ï¼šæ‹¦æˆªå™¨ vs æ‰‹åŠ¨ä¼ é€’


```
ğŸ”¸ ä½¿ç”¨æ‹¦æˆªå™¨ï¼ˆæ¨èï¼‰ï¼š
ä¼˜ç‚¹ï¼šâœ… é…ç½®ä¸€æ¬¡ï¼Œæ°¸ä¹…ç”Ÿæ•ˆ
     âœ… ä»£ç ç®€æ´ï¼Œä¸æ˜“å‡ºé”™
     âœ… ç»Ÿä¸€ç®¡ç†Tokenä¼ é€’é€»è¾‘
ç¼ºç‚¹ï¼šâŒ éœ€è¦ç†è§£æ‹¦æˆªå™¨æœºåˆ¶

ğŸ”¸ æ‰‹åŠ¨ä¼ é€’ï¼š
ä¼˜ç‚¹ï¼šâœ… çµæ´»æ§åˆ¶ï¼Œæ¸…æ™°æ˜äº†
     âœ… ä¸éœ€è¦é¢å¤–é…ç½®
ç¼ºç‚¹ï¼šâŒ æ¯æ¬¡è°ƒç”¨éƒ½è¦å†™
     âŒ å®¹æ˜“é—æ¼ï¼Œç»´æŠ¤å›°éš¾
```

---

## 5. ğŸš€ WebClient Tokenä¼ é€’


### 5.1 ä»€ä¹ˆæ˜¯WebClient


**WebClientç†è§£**ï¼šSpring WebFluxæä¾›çš„å“åº”å¼HTTPå®¢æˆ·ç«¯ï¼Œæ”¯æŒå¼‚æ­¥éé˜»å¡è°ƒç”¨

```
RestTemplate vs WebClientï¼š

RestTemplateï¼ˆä¼ ç»Ÿï¼‰ï¼š
- åŒæ­¥é˜»å¡è°ƒç”¨
- é€‚åˆä¼ ç»ŸSpring MVCé¡¹ç›®
- ä½¿ç”¨ç®€å•ï¼Œæ€§èƒ½ä¸€èˆ¬

WebClientï¼ˆç°ä»£ï¼‰ï¼š
- å¼‚æ­¥éé˜»å¡è°ƒç”¨
- é€‚åˆé«˜å¹¶å‘åœºæ™¯
- ä½¿ç”¨ç¨å¤æ‚ï¼Œæ€§èƒ½æ›´å¥½
```

### 5.2 WebClientè‡ªåŠ¨ä¼ é€’Token


**é…ç½®æ–¹å¼1ï¼šä½¿ç”¨ExchangeFilterFunction**

```java
@Configuration
public class WebClientConfig {
    
    @Bean
    public WebClient webClient() {
        return WebClient.builder()
            // ğŸ”¸ æ·»åŠ Tokenä¼ é€’è¿‡æ»¤å™¨
            .filter(tokenRelayFilter())
            .build();
    }
    
    /**
     * Tokenä¼ é€’è¿‡æ»¤å™¨
     */
    private ExchangeFilterFunction tokenRelayFilter() {
        return (request, next) -> {
            // ğŸ”¸ è·å–å½“å‰Token
            String token = getCurrentToken();
            
            if (token != null) {
                // ğŸ”¸ æ·»åŠ åˆ°WebClientè¯·æ±‚ä¸­
                ClientRequest newRequest = ClientRequest.from(request)
                    .header("Authorization", token)
                    .build();
                return next.exchange(newRequest);
            }
            
            return next.exchange(request);
        };
    }
    
    private String getCurrentToken() {
        // ä»ä¸Šä¸‹æ–‡è·å–Token
        return ReactiveSecurityContextHolder.getContext()
            .map(SecurityContext::getAuthentication)
            .map(auth -> "Bearer " + auth.getCredentials())
            .block();
    }
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```java
@Service
public class OrderService {
    
    @Autowired
    private WebClient webClient;
    
    public Mono<String> callInventory() {
        // âœ… ç›´æ¥è°ƒç”¨ï¼ŒTokenè‡ªåŠ¨ä¼ é€’
        return webClient.get()
            .uri("http://inventory-service/api/check")
            .retrieve()
            .bodyToMono(String.class);
    }
}
```

### 5.3 å“åº”å¼Tokenä¼ é€’çš„ç‰¹æ®Šå¤„ç†


```java
/**
 * å“åº”å¼ç¯å¢ƒä¸‹çš„Tokenä¼ é€’
 */
@Component
public class ReactiveTokenRelay implements ExchangeFilterFunction {
    
    @Override
    public Mono<ClientResponse> filter(ClientRequest request, ExchangeFunction next) {
        // ğŸ”¸ ä»å“åº”å¼ä¸Šä¸‹æ–‡è·å–Token
        return ReactiveSecurityContextHolder.getContext()
            .map(ctx -> {
                Authentication auth = ctx.getAuthentication();
                String token = extractToken(auth);
                
                // ğŸ”¸ åˆ›å»ºå¸¦Tokençš„æ–°è¯·æ±‚
                ClientRequest newRequest = ClientRequest.from(request)
                    .header("Authorization", token)
                    .build();
                
                return newRequest;
            })
            .defaultIfEmpty(request)
            .flatMap(next::exchange);
    }
    
    private String extractToken(Authentication auth) {
        if (auth instanceof OAuth2AuthenticationToken) {
            OAuth2AuthenticationToken oauth = (OAuth2AuthenticationToken) auth;
            return "Bearer " + oauth.getAccessToken().getTokenValue();
        }
        return null;
    }
}
```

---

## 6. ğŸ”„ Token Relayä¸­ç»§æœºåˆ¶


### 6.1 ä»€ä¹ˆæ˜¯Token Relay


**Token Relayç†è§£**ï¼šå°±åƒå¿«é€’æ¥åŠ›ç«™ï¼ŒTokenåœ¨æœåŠ¡é—´è‡ªåŠ¨è½¬å‘

```
ä¼ ç»Ÿæ–¹å¼ï¼ˆæ‰‹åŠ¨ä¼ é€’ï¼‰ï¼š
ç”¨æˆ· --Token--> æœåŠ¡A --æ‰‹åŠ¨ä¼ Token--> æœåŠ¡B --æ‰‹åŠ¨ä¼ Token--> æœåŠ¡C
              (éœ€è¦å†™ä»£ç )            (éœ€è¦å†™ä»£ç )

Token Relayï¼ˆè‡ªåŠ¨ä¸­ç»§ï¼‰ï¼š
ç”¨æˆ· --Token--> æœåŠ¡A ==è‡ªåŠ¨ä¼ é€’==> æœåŠ¡B ==è‡ªåŠ¨ä¼ é€’==> æœåŠ¡C
              (é…ç½®ä¸€æ¬¡)            (è‡ªåŠ¨ç”Ÿæ•ˆ)
```

### 6.2 Spring Cloud Gateway Token Relay


**é…ç½®Tokenä¸­ç»§**ï¼š

```yaml
# application.yml
spring:
  cloud:
    gateway:
      routes:
        - id: order-service
          uri: lb://order-service
          filters:
            # ğŸ”¸ å¯ç”¨Tokenä¸­ç»§ï¼Œè‡ªåŠ¨ä¼ é€’Token
            - TokenRelay=
```

**å·¥ä½œæµç¨‹**ï¼š

```
Token Relayå·¥ä½œåŸç†ï¼š

Step 1: ç½‘å…³æ”¶åˆ°ç”¨æˆ·è¯·æ±‚ï¼ˆå¸¦Tokenï¼‰
   â†“
Step 2: TokenRelayè¿‡æ»¤å™¨æå–Token
   â†“  
Step 3: å°†Tokenæ·»åŠ åˆ°ä¸‹æ¸¸æœåŠ¡è¯·æ±‚å¤´
   â†“
Step 4: ä¸‹æ¸¸æœåŠ¡æ”¶åˆ°è¯·æ±‚ï¼ˆè‡ªåŠ¨å¸¦Tokenï¼‰

æ ¸å¿ƒï¼šç½‘å…³è‡ªåŠ¨å¸®ä½ å®ŒæˆTokenä¼ é€’
```

### 6.3 è‡ªå®šä¹‰Token Relay


```java
/**
 * è‡ªå®šä¹‰Tokenä¸­ç»§è¿‡æ»¤å™¨
 * 
 * åŠŸèƒ½ï¼š
 * 1. æå–ä¸Šæ¸¸Token
 * 2. éªŒè¯Tokenæœ‰æ•ˆæ€§
 * 3. ä¼ é€’ç»™ä¸‹æ¸¸æœåŠ¡
 */
@Component
public class CustomTokenRelayFilter implements GlobalFilter, Ordered {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        // ğŸ”¸ Step1: è·å–è¯·æ±‚ä¸­çš„Token
        String token = exchange.getRequest()
            .getHeaders()
            .getFirst("Authorization");
        
        if (token != null) {
            // ğŸ”¸ Step2: éªŒè¯Tokenï¼ˆå¯é€‰ï¼‰
            if (validateToken(token)) {
                // ğŸ”¸ Step3: æ·»åŠ åˆ°ä¸‹æ¸¸è¯·æ±‚
                ServerHttpRequest newRequest = exchange.getRequest()
                    .mutate()
                    .header("Authorization", token)
                    .build();
                
                return chain.filter(
                    exchange.mutate().request(newRequest).build()
                );
            }
        }
        
        // Tokenæ— æ•ˆï¼Œæ‹’ç»è¯·æ±‚
        exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);
        return exchange.getResponse().setComplete();
    }
    
    private boolean validateToken(String token) {
        // TokenéªŒè¯é€»è¾‘
        return true;
    }
    
    @Override
    public int getOrder() {
        return -100; // ä¼˜å…ˆçº§ï¼šè¶Šå°è¶Šå…ˆæ‰§è¡Œ
    }
}
```

---

## 7. ğŸ”— æœåŠ¡é“¾è°ƒç”¨å®‰å…¨


### 7.1 è°ƒç”¨é“¾çš„å®‰å…¨é£é™©


```
è°ƒç”¨é“¾åœºæ™¯ï¼š
ç”¨æˆ· â†’ ç½‘å…³ â†’ è®¢å•æœåŠ¡ â†’ åº“å­˜æœåŠ¡ â†’ æ”¯ä»˜æœåŠ¡

ğŸš¨ æ½œåœ¨é£é™©ï¼š

é£é™©1ï¼šTokenè¢«æˆªè·
æ”»å‡»è€…æˆªè·ä¸­é—´æœåŠ¡çš„Tokenï¼Œä¼ªé€ è¯·æ±‚

é£é™©2ï¼šTokenæƒé™æ”¾å¤§
æ™®é€šç”¨æˆ·Tokenè¢«æŸä¸ªæœåŠ¡è¯¯ç”¨ä¸ºç®¡ç†å‘˜æƒé™

é£é™©3ï¼šè°ƒç”¨é“¾è¿‡é•¿
Tokenåœ¨é“¾è·¯ä¸­ä¼ é€’æ—¶å¯èƒ½ä¸¢å¤±æˆ–è¿‡æœŸ

é£é™©4ï¼šå†…éƒ¨æœåŠ¡æš´éœ²
å¦‚æœTokenæ³„éœ²ï¼Œå†…éƒ¨æœåŠ¡å¯èƒ½è¢«ç›´æ¥è®¿é—®
```

### 7.2 è°ƒç”¨é“¾å®‰å…¨æœ€ä½³å®è·µ


**ğŸ”¸ å®è·µ1ï¼šæœåŠ¡é—´ä½¿ç”¨å†…éƒ¨Token**

```java
/**
 * åŒTokenæœºåˆ¶
 * - ç”¨æˆ·Tokenï¼šç”¨äºç”¨æˆ·èº«ä»½éªŒè¯
 * - æœåŠ¡Tokenï¼šç”¨äºæœåŠ¡é—´é€šä¿¡
 */
@Service
public class SecureServiceCaller {
    
    public void callDownstreamService() {
        // ğŸ”¸ è·å–ç”¨æˆ·Token
        String userToken = getCurrentUserToken();
        
        // ğŸ”¸ ç”ŸæˆæœåŠ¡é—´é€šä¿¡Token
        String serviceToken = generateServiceToken();
        
        // ğŸ”¸ åŒæ—¶ä¼ é€’ä¸¤ä¸ªToken
        Map<String, String> headers = new HashMap<>();
        headers.put("User-Token", userToken);      // ç”¨æˆ·èº«ä»½
        headers.put("Service-Token", serviceToken); // æœåŠ¡èº«ä»½
        
        callService(headers);
    }
    
    private String generateServiceToken() {
        // åŸºäºæœåŠ¡èº«ä»½ç”ŸæˆTokenï¼Œæœ‰æ•ˆæœŸçŸ­
        return jwtService.createServiceToken(
            "order-service",  // å½“å‰æœåŠ¡
            "inventory-service", // ç›®æ ‡æœåŠ¡
            Duration.ofMinutes(1) // 1åˆ†é’Ÿæœ‰æ•ˆ
        );
    }
}
```

**ğŸ”¸ å®è·µ2ï¼šTokenä¼ é€’é“¾è·¯è¿½è¸ª**

```java
/**
 * è°ƒç”¨é“¾è¿½è¸ª
 */
@Component
public class TokenTraceInterceptor implements RequestInterceptor {
    
    @Override
    public void apply(RequestTemplate template) {
        // ğŸ”¸ æ·»åŠ è°ƒç”¨é“¾ID
        String traceId = MDC.get("traceId");
        if (traceId == null) {
            traceId = UUID.randomUUID().toString();
        }
        template.header("X-Trace-Id", traceId);
        
        // ğŸ”¸ è®°å½•è°ƒç”¨é“¾è·¯
        String callChain = MDC.get("call-chain");
        String currentService = "order-service";
        String newChain = (callChain == null) 
            ? currentService 
            : callChain + " -> " + currentService;
        
        template.header("X-Call-Chain", newChain);
        
        // ğŸ”¸ ä¼ é€’Token
        String token = getCurrentToken();
        template.header("Authorization", token);
    }
}
```

**ğŸ”¸ å®è·µ3ï¼šTokenæœ‰æ•ˆæœŸç®¡ç†**

```java
/**
 * Tokenæœ‰æ•ˆæœŸæ£€æŸ¥å’Œåˆ·æ–°
 */
@Component
public class TokenRefreshInterceptor implements RequestInterceptor {
    
    @Autowired
    private TokenService tokenService;
    
    @Override
    public void apply(RequestTemplate template) {
        String token = getCurrentToken();
        
        // ğŸ”¸ æ£€æŸ¥Tokenæœ‰æ•ˆæœŸ
        if (isTokenExpiringSoon(token)) {
            // ğŸ”¸ Tokenå¿«è¿‡æœŸï¼Œåˆ·æ–°Token
            token = tokenService.refreshToken(token);
        }
        
        template.header("Authorization", token);
    }
    
    private boolean isTokenExpiringSoon(String token) {
        JwtParser parser = Jwts.parserBuilder().build();
        Claims claims = parser.parseClaimsJws(token).getBody();
        Date expiration = claims.getExpiration();
        
        // å‰©ä½™æ—¶é—´å°‘äº5åˆ†é’Ÿï¼Œéœ€è¦åˆ·æ–°
        long remainingTime = expiration.getTime() - System.currentTimeMillis();
        return remainingTime < 5 * 60 * 1000;
    }
}
```

### 7.3 è°ƒç”¨é“¾å®‰å…¨æ¶æ„å›¾


```
å®‰å…¨è°ƒç”¨é“¾æ¶æ„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  ç”¨æˆ·Token    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚  ç½‘å…³   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚ éªŒè¯&ä¸­ç»§Token
                               â†“
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚è®¢å•æœåŠ¡ â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                  â”‚                  â”‚
    æœåŠ¡Token+ç”¨æˆ·Token   æœåŠ¡Token+ç”¨æˆ·Token  æœåŠ¡Token+ç”¨æˆ·Token
            â†“                  â†“                  â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚åº“å­˜æœåŠ¡ â”‚       â”‚æ”¯ä»˜æœåŠ¡ â”‚       â”‚é€šçŸ¥æœåŠ¡ â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        
æ ¸å¿ƒï¼šæ¯ä¸ªæœåŠ¡æ—¢éªŒè¯ç”¨æˆ·Tokenï¼ŒåˆéªŒè¯æœåŠ¡Token
```

---

## 8. âš¡ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


### 8.1 Tokenä¼ é€’æ€§èƒ½é—®é¢˜


```
æ€§èƒ½ç“¶é¢ˆåˆ†æï¼š

é—®é¢˜1ï¼šé‡å¤éªŒè¯Token
æ¯ä¸ªæœåŠ¡éƒ½è¦éªŒè¯Token â†’ å¢åŠ å»¶è¿Ÿ

é—®é¢˜2ï¼šTokenä½“ç§¯å¤§
JWT Tokenå¯èƒ½å¾ˆå¤§ â†’ å¢åŠ ç½‘ç»œä¼ è¾“å¼€é”€

é—®é¢˜3ï¼šTokenåˆ·æ–°é¢‘ç¹
çŸ­æœŸTokenéœ€è¦é¢‘ç¹åˆ·æ–° â†’ å¢åŠ è®¤è¯æœåŠ¡å‹åŠ›
```

### 8.2 ä¼˜åŒ–æ–¹æ¡ˆ


**ğŸ”¸ æ–¹æ¡ˆ1ï¼šTokenæœ¬åœ°ç¼“å­˜**

```java
/**
 * TokenéªŒè¯ç»“æœç¼“å­˜
 */
@Component
public class TokenCacheValidator {
    
    private final Cache<String, ValidationResult> tokenCache = 
        CacheBuilder.newBuilder()
            .maximumSize(10000)
            .expireAfterWrite(5, TimeUnit.MINUTES)
            .build();
    
    public boolean validateToken(String token) {
        // ğŸ”¸ å…ˆæŸ¥ç¼“å­˜
        ValidationResult cached = tokenCache.getIfPresent(token);
        if (cached != null) {
            return cached.isValid();
        }
        
        // ğŸ”¸ ç¼“å­˜æœªå‘½ä¸­ï¼Œæ‰§è¡ŒéªŒè¯
        boolean isValid = performTokenValidation(token);
        tokenCache.put(token, new ValidationResult(isValid));
        
        return isValid;
    }
}
```

**ğŸ”¸ æ–¹æ¡ˆ2ï¼šTokenå‹ç¼©ä¼ è¾“**

```java
/**
 * Tokenå‹ç¼©æ‹¦æˆªå™¨
 */
@Component
public class TokenCompressionInterceptor implements RequestInterceptor {
    
    @Override
    public void apply(RequestTemplate template) {
        String token = getCurrentToken();
        
        // ğŸ”¸ å‹ç¼©Tokenï¼ˆå¦‚æœTokenå¾ˆå¤§ï¼‰
        if (token.length() > 1000) {
            String compressedToken = compressToken(token);
            template.header("Authorization-Compressed", compressedToken);
            template.header("X-Token-Encoding", "gzip");
        } else {
            template.header("Authorization", token);
        }
    }
    
    private String compressToken(String token) {
        // ä½¿ç”¨gzipå‹ç¼©
        try (ByteArrayOutputStream out = new ByteArrayOutputStream();
             GZIPOutputStream gzip = new GZIPOutputStream(out)) {
            gzip.write(token.getBytes());
            gzip.finish();
            return Base64.getEncoder().encodeToString(out.toByteArray());
        } catch (IOException e) {
            return token;
        }
    }
}
```

**ğŸ”¸ æ–¹æ¡ˆ3ï¼šå¼‚æ­¥Tokenåˆ·æ–°**

```java
/**
 * å¼‚æ­¥Tokenåˆ·æ–°
 */
@Service
public class AsyncTokenRefreshService {
    
    @Async
    public void refreshTokenInBackground(String token) {
        // ğŸ”¸ åå°å¼‚æ­¥åˆ·æ–°Token
        if (shouldRefresh(token)) {
            String newToken = tokenService.refreshToken(token);
            // æ›´æ–°åˆ°ä¸Šä¸‹æ–‡
            updateTokenInContext(newToken);
        }
    }
    
    private boolean shouldRefresh(String token) {
        // å‰©ä½™æ—¶é—´å°‘äº10åˆ†é’Ÿï¼Œè§¦å‘åˆ·æ–°
        long remainingTime = getTokenRemainingTime(token);
        return remainingTime < 10 * 60 * 1000;
    }
}
```

### 8.3 æ€§èƒ½ç›‘æ§æŒ‡æ ‡


```
ğŸ“Š å…³é”®ç›‘æ§æŒ‡æ ‡ï¼š

æŒ‡æ ‡1ï¼šTokenä¼ é€’å»¶è¿Ÿ
- ç›®æ ‡ï¼š< 10ms
- ç›‘æ§ï¼šæ¯æ¬¡Tokenä¼ é€’çš„æ—¶é—´

æŒ‡æ ‡2ï¼šTokenéªŒè¯æˆåŠŸç‡
- ç›®æ ‡ï¼š> 99.9%
- ç›‘æ§ï¼šéªŒè¯å¤±è´¥æ¬¡æ•°/æ€»éªŒè¯æ¬¡æ•°

æŒ‡æ ‡3ï¼šTokenç¼“å­˜å‘½ä¸­ç‡
- ç›®æ ‡ï¼š> 80%
- ç›‘æ§ï¼šç¼“å­˜å‘½ä¸­æ¬¡æ•°/æ€»æŸ¥è¯¢æ¬¡æ•°

æŒ‡æ ‡4ï¼šTokenåˆ·æ–°é¢‘ç‡
- ç›®æ ‡ï¼š< 100æ¬¡/åˆ†é’Ÿ
- ç›‘æ§ï¼šTokenåˆ·æ–°æ¬¡æ•°ç»Ÿè®¡
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Tokenä¼ é€’æœ¬è´¨ï¼š
ç”¨æˆ·Tokenåœ¨æœåŠ¡é—´çš„æ¥åŠ›ä¼ é€’ï¼Œä¿æŒèº«ä»½å’Œæƒé™çš„å»¶ç»­

ğŸ”¸ ä¸‰ç§å®ç°æ–¹å¼ï¼š
â€¢ Feignï¼šé€‚åˆSpring Cloudå¾®æœåŠ¡
â€¢ RestTemplateï¼šé€‚åˆä¼ ç»ŸSpringé¡¹ç›®
â€¢ WebClientï¼šé€‚åˆå“åº”å¼å¼‚æ­¥è°ƒç”¨

ğŸ”¸ Token Relayï¼š
ç½‘å…³å±‚é¢çš„Tokenè‡ªåŠ¨ä¸­ç»§æœºåˆ¶ï¼Œé…ç½®ä¸€æ¬¡å…¨å±€ç”Ÿæ•ˆ

ğŸ”¸ è°ƒç”¨é“¾å®‰å…¨ï¼š
åŒTokenæœºåˆ¶ã€é“¾è·¯è¿½è¸ªã€æœ‰æ•ˆæœŸç®¡ç†ä¿éšœå®‰å…¨
```

### 9.2 å®é™…åº”ç”¨å»ºè®®


```
âœ… æ¨èåšæ³•ï¼š

1. ä½¿ç”¨æ‹¦æˆªå™¨è‡ªåŠ¨ä¼ é€’Token
   - é…ç½®ä¸€æ¬¡ï¼Œæ°¸ä¹…ç”Ÿæ•ˆ
   - å‡å°‘ä»£ç é‡å¤å’Œå‡ºé”™

2. å¯ç”¨Token Relay
   - åœ¨ç½‘å…³å±‚ç»Ÿä¸€å¤„ç†
   - ç®€åŒ–ä¸‹æ¸¸æœåŠ¡é…ç½®

3. å®æ–½åŒTokenæœºåˆ¶
   - ç”¨æˆ·Tokenï¼šèº«ä»½éªŒè¯
   - æœåŠ¡Tokenï¼šæœåŠ¡é€šä¿¡

4. æ·»åŠ Tokenç¼“å­˜
   - å‡å°‘é‡å¤éªŒè¯å¼€é”€
   - æå‡ç³»ç»Ÿæ€§èƒ½

âŒ é¿å…åšæ³•ï¼š

1. æ‰‹åŠ¨ä¼ é€’Token
   - å®¹æ˜“é—æ¼ï¼Œç»´æŠ¤å›°éš¾
   - ä»£ç é‡å¤åº¦é«˜

2. Tokenæ˜æ–‡ä¼ è¾“
   - å®‰å…¨é£é™©é«˜
   - å®¹æ˜“è¢«æˆªè·

3. ä¸éªŒè¯Tokenæœ‰æ•ˆæœŸ
   - è¿‡æœŸTokenä»åœ¨ä½¿ç”¨
   - å®‰å…¨éšæ‚£ä¸¥é‡
```

### 9.3 å¿«é€Ÿæ£€æŸ¥æ¸…å•


```
ğŸ“‹ Tokenä¼ é€’æ£€æŸ¥ç‚¹ï¼š

â–¡ æ˜¯å¦é…ç½®äº†Tokenä¼ é€’æ‹¦æˆªå™¨ï¼Ÿ
â–¡ æ˜¯å¦å¯ç”¨äº†Token Relayï¼Ÿ
â–¡ æ˜¯å¦å¤„ç†äº†å¼‚æ­¥è°ƒç”¨åœºæ™¯ï¼Ÿ
â–¡ æ˜¯å¦éªŒè¯Tokenæœ‰æ•ˆæœŸï¼Ÿ
â–¡ æ˜¯å¦å®æ–½äº†è°ƒç”¨é“¾è¿½è¸ªï¼Ÿ
â–¡ æ˜¯å¦æ·»åŠ äº†Tokenç¼“å­˜ï¼Ÿ
â–¡ æ˜¯å¦ç›‘æ§Tokenä¼ é€’æ€§èƒ½ï¼Ÿ
â–¡ æ˜¯å¦æœ‰Tokenåˆ·æ–°æœºåˆ¶ï¼Ÿ
```

### 9.4 å¸¸è§é—®é¢˜é€ŸæŸ¥


```
â“ Q1: Tokenä¼ é€’å¤±è´¥æ€ä¹ˆåŠï¼Ÿ
ğŸ’¡ A: æ£€æŸ¥æ‹¦æˆªå™¨é…ç½®ã€RequestContextHolderæ˜¯å¦å¯ç”¨

â“ Q2: å¼‚æ­¥è°ƒç”¨Tokenä¸¢å¤±ï¼Ÿ  
ğŸ’¡ A: ä½¿ç”¨ThreadLocalæˆ–åœ¨å¼‚æ­¥ä»»åŠ¡ä¸­æ‰‹åŠ¨ä¼ é€’Token

â“ Q3: Tokenè¿‡æœŸå¦‚ä½•è‡ªåŠ¨åˆ·æ–°ï¼Ÿ
ğŸ’¡ A: é…ç½®Tokenåˆ·æ–°æ‹¦æˆªå™¨ï¼Œæ£€æŸ¥æœ‰æ•ˆæœŸè‡ªåŠ¨åˆ·æ–°

â“ Q4: å¦‚ä½•æå‡Tokenä¼ é€’æ€§èƒ½ï¼Ÿ
ğŸ’¡ A: å¯ç”¨Tokenç¼“å­˜ã€å¼‚æ­¥åˆ·æ–°ã€å‹ç¼©ä¼ è¾“

â“ Q5: å¦‚ä½•ä¿è¯è°ƒç”¨é“¾å®‰å…¨ï¼Ÿ
ğŸ’¡ A: å®æ–½åŒTokenæœºåˆ¶ã€æ·»åŠ é“¾è·¯è¿½è¸ªã€éªŒè¯æœ‰æ•ˆæœŸ
```

**ğŸ¯ æ ¸å¿ƒè®°å¿†**ï¼š
- Tokenä¼ é€’æ˜¯å¾®æœåŠ¡å®‰å…¨çš„åŸºç¡€
- è‡ªåŠ¨ä¼ é€’æ¯”æ‰‹åŠ¨ä¼ é€’æ›´å¯é 
- Token Relayç®€åŒ–é…ç½®ï¼Œæå‡æ•ˆç‡
- åŒTokenæœºåˆ¶ä¿éšœè°ƒç”¨é“¾å®‰å…¨
- æ€§èƒ½ä¼˜åŒ–ä»ç¼“å­˜å’Œå¼‚æ­¥å…¥æ‰‹