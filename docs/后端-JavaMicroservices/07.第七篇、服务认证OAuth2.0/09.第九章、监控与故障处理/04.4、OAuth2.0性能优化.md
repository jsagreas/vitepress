---
title: 4ã€OAuth2.0æ€§èƒ½ä¼˜åŒ–
---
## ğŸ“š ç›®å½•

1. [æ€§èƒ½ç“¶é¢ˆè¯†åˆ«](#1-æ€§èƒ½ç“¶é¢ˆè¯†åˆ«)
2. [Tokenç¼“å­˜ç­–ç•¥](#2-Tokenç¼“å­˜ç­–ç•¥)
3. [è¿æ¥æ± ä¼˜åŒ–](#3-è¿æ¥æ± ä¼˜åŒ–)
4. [æ‰¹é‡éªŒè¯æœºåˆ¶](#4-æ‰¹é‡éªŒè¯æœºåˆ¶)
5. [è´Ÿè½½å‡è¡¡è®¾è®¡](#5-è´Ÿè½½å‡è¡¡è®¾è®¡)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” æ€§èƒ½ç“¶é¢ˆè¯†åˆ«


### 1.1 ä»€ä¹ˆæ˜¯æ€§èƒ½ç“¶é¢ˆ


**ç®€å•ç†è§£**ï¼šå°±åƒé«˜é€Ÿå…¬è·¯ä¸Šçš„æ”¶è´¹ç«™ï¼Œè½¦æµé‡å¤§çš„æ—¶å€™ï¼Œæ”¶è´¹ç«™å°±æˆäº†"å¡è„–å­"çš„åœ°æ–¹ï¼Œè®©æ•´æ¡è·¯éƒ½å µèµ·æ¥ã€‚OAuth2.0ç³»ç»Ÿä¸­ï¼ŒæŸäº›ç¯èŠ‚å¤„ç†æ…¢äº†ï¼Œå°±ä¼šæ‹–ç´¯æ•´ä¸ªè®¤è¯æµç¨‹ã€‚

**OAuth2.0å¸¸è§çš„æ€§èƒ½ç“¶é¢ˆç‚¹**ï¼š
```
ç”¨æˆ·è¯·æ±‚ â†’ éªŒè¯Token â†’ æ•°æ®åº“æŸ¥è¯¢ â†’ è¿”å›ç»“æœ
           â†‘ ç“¶é¢ˆ1      â†‘ ç“¶é¢ˆ2
           
ç“¶é¢ˆ1ï¼šæ¯æ¬¡éƒ½è¦éªŒè¯Tokenï¼ŒéªŒè¯é€»è¾‘å¤æ‚
ç“¶é¢ˆ2ï¼šé¢‘ç¹æŸ¥è¯¢æ•°æ®åº“ï¼Œæ•°æ®åº“å‹åŠ›å¤§
```

### 1.2 å¦‚ä½•æ‰¾å‡ºæ€§èƒ½ç“¶é¢ˆ


**ğŸ”¸ ç›‘æ§å…³é”®æŒ‡æ ‡**

| æŒ‡æ ‡åç§° | å«ä¹‰ | æ­£å¸¸å€¼ | é—®é¢˜å€¼ |
|---------|------|--------|--------|
| **å“åº”æ—¶é—´** | å¤„ç†ä¸€ä¸ªè¯·æ±‚éœ€è¦å¤šä¹… | < 100ms | > 500ms |
| **ååé‡** | æ¯ç§’èƒ½å¤„ç†å¤šå°‘è¯·æ±‚ | > 1000 QPS | < 100 QPS |
| **é”™è¯¯ç‡** | è¯·æ±‚å¤±è´¥çš„æ¯”ä¾‹ | < 0.1% | > 5% |
| **CPUä½¿ç”¨ç‡** | æœåŠ¡å™¨CPUå ç”¨ | < 70% | > 90% |

**ğŸ”¸ å®šä½ç“¶é¢ˆçš„æ–¹æ³•**

```
æ­¥éª¤1ï¼šçœ‹æ—¥å¿—
- å“ªä¸ªç¯èŠ‚è€—æ—¶æœ€é•¿ï¼Ÿ
- æ˜¯TokenéªŒè¯æ…¢ï¼Œè¿˜æ˜¯æ•°æ®åº“æŸ¥è¯¢æ…¢ï¼Ÿ

æ­¥éª¤2ï¼šå‹åŠ›æµ‹è¯•
- æ¨¡æ‹Ÿå¤§é‡ç”¨æˆ·åŒæ—¶è®¿é—®
- è§‚å¯Ÿå“ªé‡Œå…ˆæ’‘ä¸ä½

æ­¥éª¤3ï¼šåˆ†æ®µè®¡æ—¶
GET /api/user/info
  â”œâ”€ TokenéªŒè¯ï¼š50ms     â† è¿™é‡Œæ…¢äº†
  â”œâ”€ æ•°æ®åº“æŸ¥è¯¢ï¼š20ms
  â””â”€ ç»„è£…è¿”å›ï¼š10ms
```

### 1.3 å¸¸è§æ€§èƒ½é—®é¢˜


**âŒ é—®é¢˜1ï¼šTokenæ¯æ¬¡éƒ½è¦è§£å¯†éªŒè¯**
```
ä¼ ç»Ÿåšæ³•ï¼ˆæ…¢ï¼‰ï¼š
è¯·æ±‚1 â†’ è§£å¯†Token â†’ éªŒè¯ç­¾å â†’ æŸ¥æ•°æ®åº“ â†’ è¿”å›
è¯·æ±‚2 â†’ è§£å¯†Token â†’ éªŒè¯ç­¾å â†’ æŸ¥æ•°æ®åº“ â†’ è¿”å›
è¯·æ±‚3 â†’ è§£å¯†Token â†’ éªŒè¯ç­¾å â†’ æŸ¥æ•°æ®åº“ â†’ è¿”å›

é—®é¢˜ï¼šåŒä¸€ä¸ªTokené‡å¤éªŒè¯ï¼Œæµªè´¹èµ„æº
```

**âŒ é—®é¢˜2ï¼šæ•°æ®åº“è¿æ¥ä¸å¤Ÿç”¨**
```
åœºæ™¯ï¼š100ä¸ªè¯·æ±‚åŒæ—¶æ¥äº†
- æ•°æ®åº“è¿æ¥æ± åªæœ‰10ä¸ªè¿æ¥
- 90ä¸ªè¯·æ±‚åœ¨æ’é˜Ÿç­‰è¿æ¥
- ç”¨æˆ·æ„Ÿè§‰ç³»ç»Ÿå¾ˆå¡
```

**âŒ é—®é¢˜3ï¼šå•ç‚¹è®¤è¯æœåŠ¡å™¨å‹åŠ›å¤§**
```
æ‰€æœ‰è¯·æ±‚éƒ½æ‰“åˆ°ä¸€å°è®¤è¯æœåŠ¡å™¨ï¼š
è®¤è¯æœåŠ¡å™¨ â† 1000ä¸ªè¯·æ±‚/ç§’
     â†“
   æ‰›ä¸ä½ï¼Œå´©æºƒï¼
```

---

## 2. ğŸ’¾ Tokenç¼“å­˜ç­–ç•¥


### 2.1 ä¸ºä»€ä¹ˆè¦ç¼“å­˜Token


**é€šä¿—è§£é‡Š**ï¼šå°±åƒä½ åŠäº†ä¸€å¼ ä¼šå‘˜å¡ï¼Œæ¯æ¬¡å»å•†åœºä¸ç”¨é‡æ–°ç™»è®°èº«ä»½ï¼Œç›´æ¥åˆ·å¡å°±è¡Œã€‚Tokenç¼“å­˜ä¹Ÿæ˜¯è¿™æ ·ï¼ŒéªŒè¯è¿‡ä¸€æ¬¡çš„Tokenï¼Œè®°ä¸‹æ¥ï¼Œä¸‹æ¬¡ç›´æ¥ç”¨ç»“æœï¼Œä¸ç”¨é‡å¤éªŒè¯ã€‚

**ç¼“å­˜çš„å¥½å¤„**ï¼š
- âš¡ **é€Ÿåº¦å¿«**ï¼šä»å†…å­˜è¯»å–ï¼Œæ¯”æ•°æ®åº“å¿«100å€
- ğŸ”„ **å‡è½»å‹åŠ›**ï¼šæ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°å¤§å¹…å‡å°‘
- ğŸ’° **èŠ‚çœèµ„æº**ï¼šCPUå’Œç½‘ç»œå¼€é”€é™ä½

### 2.2 ç¼“å­˜ä»€ä¹ˆå†…å®¹


**ğŸ”¸ ç¼“å­˜TokenéªŒè¯ç»“æœ**

```java
// ç¬¬ä¸€æ¬¡éªŒè¯Token
TokenéªŒè¯ â†’ æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ â†’ å­˜å…¥ç¼“å­˜
{
  "token": "abc123...",
  "userId": "10001",
  "username": "å¼ ä¸‰",
  "permissions": ["read", "write"],
  "expireTime": "2025-01-20 18:00:00"
}

// ç¬¬äºŒæ¬¡åŒæ ·çš„Tokenæ¥äº†
ç›´æ¥ä»ç¼“å­˜è¯»å– â†’ ç«‹å³è¿”å›ç»“æœï¼ˆçœå»éªŒè¯å’Œæ•°æ®åº“æŸ¥è¯¢ï¼‰
```

**ğŸ”¸ ç¼“å­˜ç”¨æˆ·æƒé™ä¿¡æ¯**

```java
// ç”¨æˆ·æƒé™ä¹Ÿå¯ä»¥ç¼“å­˜
key: "user:10001:permissions"
value: ["user:read", "user:write", "admin:read"]

// æ£€æŸ¥æƒé™æ—¶
if (ç¼“å­˜ä¸­æœ‰æƒé™) {
    ç›´æ¥åˆ¤æ–­  // è¶…å¿«
} else {
    æŸ¥æ•°æ®åº“ â†’ å­˜ç¼“å­˜
}
```

### 2.3 å®ç°Tokenç¼“å­˜


**ğŸ”¸ ä½¿ç”¨Redisç¼“å­˜**

```java
@Service
public class TokenCacheService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    /**
     * éªŒè¯Tokenå¹¶ç¼“å­˜ç»“æœ
     */
    public UserInfo validateToken(String token) {
        // 1. å…ˆæŸ¥ç¼“å­˜
        String cacheKey = "token:" + token;
        UserInfo userInfo = (UserInfo) redisTemplate.opsForValue().get(cacheKey);
        
        if (userInfo != null) {
            return userInfo;  // ç¼“å­˜å‘½ä¸­ï¼Œç›´æ¥è¿”å›
        }
        
        // 2. ç¼“å­˜æ²¡æœ‰ï¼ŒéªŒè¯Token
        userInfo = parseAndValidateToken(token);
        
        // 3. å­˜å…¥ç¼“å­˜ï¼ˆè®¾ç½®è¿‡æœŸæ—¶é—´ï¼‰
        long remainTime = userInfo.getExpireTime() - System.currentTimeMillis();
        redisTemplate.opsForValue().set(cacheKey, userInfo, remainTime, TimeUnit.MILLISECONDS);
        
        return userInfo;
    }
}
```

**ğŸ”¸ ç¼“å­˜è¿‡æœŸç­–ç•¥**

```
ç­–ç•¥1ï¼šè·ŸéšTokenè¿‡æœŸ
- Tokenæœ‰æ•ˆæœŸ2å°æ—¶ï¼Œç¼“å­˜ä¹Ÿ2å°æ—¶
- Tokenè¿‡æœŸäº†ï¼Œç¼“å­˜è‡ªåŠ¨å¤±æ•ˆ

ç­–ç•¥2ï¼šæå‰è¿‡æœŸï¼ˆæ›´å®‰å…¨ï¼‰
- Tokenæœ‰æ•ˆæœŸ2å°æ—¶ï¼Œç¼“å­˜åªä¿ç•™1å°æ—¶50åˆ†é’Ÿ
- é˜²æ­¢Tokenåˆšè¿‡æœŸï¼Œç¼“å­˜è¿˜åœ¨ç”¨

ç­–ç•¥3ï¼šä¸»åŠ¨å¤±æ•ˆ
ç”¨æˆ·ç™»å‡º â†’ ç«‹å³åˆ é™¤ç¼“å­˜
å¯†ç ä¿®æ”¹ â†’ æ¸…ç©ºè¯¥ç”¨æˆ·æ‰€æœ‰Tokenç¼“å­˜
```

### 2.4 ç¼“å­˜ä¼˜åŒ–æŠ€å·§


**âœ… æŠ€å·§1ï¼šæ‰¹é‡é¢„çƒ­**
```java
// ç³»ç»Ÿå¯åŠ¨æ—¶ï¼Œé¢„å…ˆåŠ è½½çƒ­ç‚¹æ•°æ®
@PostConstruct
public void warmUpCache() {
    // åŠ è½½æ´»è·ƒç”¨æˆ·çš„æƒé™ä¿¡æ¯
    List<User> activeUsers = userService.getActiveUsers();
    for (User user : activeUsers) {
        cacheUserPermissions(user.getId());
    }
}
```

**âœ… æŠ€å·§2ï¼šé™çº§æ–¹æ¡ˆ**
```java
public UserInfo getUser(String userId) {
    try {
        // ä¼˜å…ˆä»ç¼“å­˜è·å–
        return cacheService.getUser(userId);
    } catch (Exception e) {
        // ç¼“å­˜æŒ‚äº†ï¼Œç›´æ¥æŸ¥æ•°æ®åº“
        log.warn("ç¼“å­˜å¼‚å¸¸ï¼Œé™çº§åˆ°æ•°æ®åº“æŸ¥è¯¢");
        return userService.getUserFromDB(userId);
    }
}
```

**âœ… æŠ€å·§3ï¼šç¼“å­˜ç©¿é€ä¿æŠ¤**
```java
// é˜²æ­¢æ¶æ„è¯·æ±‚ä¸å­˜åœ¨çš„Token
public UserInfo validateToken(String token) {
    // æ£€æŸ¥æ˜¯å¦æ˜¯æ— æ•ˆTokençš„æ”»å‡»
    String blackKey = "invalid:token:" + token;
    if (redisTemplate.hasKey(blackKey)) {
        throw new InvalidTokenException("Tokenæ— æ•ˆ");
    }
    
    UserInfo userInfo = parseToken(token);
    if (userInfo == null) {
        // æ ‡è®°ä¸ºæ— æ•ˆTokenï¼Œé˜²æ­¢é‡å¤æ”»å‡»
        redisTemplate.opsForValue().set(blackKey, "1", 5, TimeUnit.MINUTES);
        throw new InvalidTokenException("Tokenæ— æ•ˆ");
    }
    
    return userInfo;
}
```

---

## 3. ğŸ”Œ è¿æ¥æ± ä¼˜åŒ–


### 3.1 ä»€ä¹ˆæ˜¯è¿æ¥æ± 


**ç”Ÿæ´»åŒ–ç†è§£**ï¼šå°±åƒé“¶è¡Œçš„çª—å£ï¼Œå¼€10ä¸ªçª—å£ï¼Œ10ä¸ªäººå¯ä»¥åŒæ—¶åŠä¸šåŠ¡ã€‚å¦‚æœåªå¼€1ä¸ªçª—å£ï¼Œ100ä¸ªäººå°±å¾—æ’é•¿é˜Ÿã€‚è¿æ¥æ± å°±æ˜¯é¢„å…ˆå‡†å¤‡å¥½çš„"æ•°æ®åº“è¿æ¥çª—å£"ã€‚

**è¿æ¥æ± çš„å·¥ä½œæ–¹å¼**ï¼š
```
æ²¡æœ‰è¿æ¥æ± ï¼ˆæ…¢ï¼‰ï¼š
è¯·æ±‚æ¥äº† â†’ å»ºç«‹æ•°æ®åº“è¿æ¥ï¼ˆè€—æ—¶200msï¼‰ â†’ æŸ¥è¯¢ â†’ å…³é—­è¿æ¥
è¯·æ±‚æ¥äº† â†’ å»ºç«‹æ•°æ®åº“è¿æ¥ï¼ˆè€—æ—¶200msï¼‰ â†’ æŸ¥è¯¢ â†’ å…³é—­è¿æ¥

æœ‰è¿æ¥æ± ï¼ˆå¿«ï¼‰ï¼š
å¯åŠ¨æ—¶ï¼šåˆ›å»º10ä¸ªè¿æ¥æ”¾åœ¨æ± å­é‡Œ
è¯·æ±‚æ¥äº† â†’ ä»æ± å­å–ä¸€ä¸ªè¿æ¥ï¼ˆè€—æ—¶1msï¼‰ â†’ æŸ¥è¯¢ â†’ è¿˜å›æ± å­
è¯·æ±‚æ¥äº† â†’ ä»æ± å­å–ä¸€ä¸ªè¿æ¥ï¼ˆè€—æ—¶1msï¼‰ â†’ æŸ¥è¯¢ â†’ è¿˜å›æ± å­
```

### 3.2 è¿æ¥æ± é…ç½®


**ğŸ”¸ æ ¸å¿ƒå‚æ•°è§£é‡Š**

| å‚æ•° | å«ä¹‰ | æ¨èå€¼ | è¯´æ˜ |
|------|------|--------|------|
| **æœ€å°è¿æ¥æ•°** | æ± å­é‡Œæœ€å°‘ä¿æŒå‡ ä¸ªè¿æ¥ | 10 | å¤ªå°‘ä¼šä¸å¤Ÿç”¨ |
| **æœ€å¤§è¿æ¥æ•°** | æ± å­é‡Œæœ€å¤šåˆ›å»ºå‡ ä¸ªè¿æ¥ | 50 | å¤ªå¤šå ç”¨èµ„æº |
| **è¿æ¥è¶…æ—¶** | ç­‰å¾…è¿æ¥çš„æœ€é•¿æ—¶é—´ | 30ç§’ | è¶…è¿‡å°±æŠ¥é”™ |
| **ç©ºé—²æ—¶é—´** | è¿æ¥å¤šä¹…ä¸ç”¨å°±å…³é—­ | 10åˆ†é’Ÿ | é¿å…å ç”¨èµ„æº |

**ğŸ”¸ é…ç½®ç¤ºä¾‹**

```yaml
spring:
  datasource:
    hikari:  # HikariCPè¿æ¥æ± ï¼ˆç›®å‰æœ€å¿«çš„è¿æ¥æ± ï¼‰
      minimum-idle: 10          # æœ€å°ç©ºé—²è¿æ¥
      maximum-pool-size: 50     # æœ€å¤§è¿æ¥æ•°
      connection-timeout: 30000 # è¿æ¥è¶…æ—¶30ç§’
      idle-timeout: 600000      # ç©ºé—²10åˆ†é’Ÿå…³é—­
      max-lifetime: 1800000     # è¿æ¥æœ€é•¿å­˜æ´»30åˆ†é’Ÿ
```

### 3.3 å¦‚ä½•è®¾ç½®åˆé€‚çš„è¿æ¥æ•°


**ğŸ”¸ è®¡ç®—å…¬å¼**

```
æœ€å¤§è¿æ¥æ•° = ((æ ¸å¿ƒæ•° * 2) + æœ‰æ•ˆç£ç›˜æ•°)

ä¾‹å­ï¼š
- æœåŠ¡å™¨4æ ¸CPU
- 1ä¸ªSSDç¡¬ç›˜
- æœ€å¤§è¿æ¥æ•° = (4 * 2) + 1 = 9 â‰ˆ 10ä¸ª

å®é™…å»ºè®®ï¼š
- å¼€å‘ç¯å¢ƒï¼š10-20ä¸ª
- æµ‹è¯•ç¯å¢ƒï¼š20-50ä¸ª  
- ç”Ÿäº§ç¯å¢ƒï¼š50-100ä¸ªï¼ˆæ ¹æ®å‹æµ‹ç»“æœè°ƒæ•´ï¼‰
```

**ğŸ”¸ ç›‘æ§è¿æ¥æ± çŠ¶æ€**

```java
@Component
public class ConnectionPoolMonitor {
    
    @Autowired
    private HikariDataSource dataSource;
    
    @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    public void monitorPool() {
        HikariPoolMXBean poolMXBean = dataSource.getHikariPoolMXBean();
        
        int active = poolMXBean.getActiveConnections();
        int idle = poolMXBean.getIdleConnections();
        int total = poolMXBean.getTotalConnections();
        
        log.info("è¿æ¥æ± çŠ¶æ€ - æ´»è·ƒ:{}, ç©ºé—²:{}, æ€»æ•°:{}", active, idle, total);
        
        // å‘Šè­¦ï¼šæ´»è·ƒè¿æ¥æ•°è¿‡é«˜
        if (active > total * 0.8) {
            log.warn("è¿æ¥æ± ä½¿ç”¨ç‡è¶…è¿‡80%ï¼Œè€ƒè™‘å¢åŠ è¿æ¥æ•°");
        }
    }
}
```

### 3.4 HTTPè¿æ¥æ± ä¼˜åŒ–


**OAuth2.0ä¸­è®¿é—®è®¤è¯æœåŠ¡å™¨ä¹Ÿéœ€è¦è¿æ¥æ± **

```java
@Configuration
public class RestTemplateConfig {
    
    @Bean
    public RestTemplate restTemplate() {
        // é…ç½®HTTPè¿æ¥æ± 
        PoolingHttpClientConnectionManager connectionManager = 
            new PoolingHttpClientConnectionManager();
        
        connectionManager.setMaxTotal(200);        // æœ€å¤§è¿æ¥æ•°
        connectionManager.setDefaultMaxPerRoute(50); // æ¯ä¸ªæœåŠ¡æœ€å¤š50ä¸ªè¿æ¥
        
        HttpClient httpClient = HttpClients.custom()
            .setConnectionManager(connectionManager)
            .setConnectionTimeToLive(30, TimeUnit.SECONDS)
            .build();
        
        HttpComponentsClientHttpRequestFactory factory = 
            new HttpComponentsClientHttpRequestFactory(httpClient);
        factory.setConnectTimeout(5000);   // è¿æ¥è¶…æ—¶5ç§’
        factory.setReadTimeout(10000);     // è¯»å–è¶…æ—¶10ç§’
        
        return new RestTemplate(factory);
    }
}
```

---

## 4. ğŸ“¦ æ‰¹é‡éªŒè¯æœºåˆ¶


### 4.1 ä¸ºä»€ä¹ˆéœ€è¦æ‰¹é‡éªŒè¯


**åœºæ™¯é—®é¢˜**ï¼š
```
å‰ç«¯ä¸€æ¬¡è¯·æ±‚éœ€è¦è°ƒç”¨5ä¸ªå¾®æœåŠ¡ï¼š
ç”¨æˆ·æœåŠ¡ â†’ éªŒè¯Tokenï¼ˆ50msï¼‰
è®¢å•æœåŠ¡ â†’ éªŒè¯Tokenï¼ˆ50msï¼‰
å•†å“æœåŠ¡ â†’ éªŒè¯Tokenï¼ˆ50msï¼‰
æ”¯ä»˜æœåŠ¡ â†’ éªŒè¯Tokenï¼ˆ50msï¼‰
ç‰©æµæœåŠ¡ â†’ éªŒè¯Tokenï¼ˆ50msï¼‰
æ€»è€—æ—¶ï¼š250ms

ä¼˜åŒ–åæ‰¹é‡éªŒè¯ï¼š
ä¸€æ¬¡éªŒè¯ â†’ ç»“æœå…±äº«ç»™5ä¸ªæœåŠ¡
æ€»è€—æ—¶ï¼š50msï¼ˆèŠ‚çœäº†200msï¼‰
```

### 4.2 æ‰¹é‡éªŒè¯å®ç°


**ğŸ”¸ æ–¹æ¡ˆ1ï¼šç½‘å…³ç»Ÿä¸€éªŒè¯**

```java
@Component
public class GatewayTokenFilter implements GlobalFilter {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        String token = extractToken(exchange);
        
        // åœ¨ç½‘å…³éªŒè¯ä¸€æ¬¡
        UserInfo userInfo = tokenService.validate(token);
        
        // éªŒè¯ç»“æœæ”¾åˆ°è¯·æ±‚å¤´ï¼Œä¼ ç»™ä¸‹æ¸¸æœåŠ¡
        ServerHttpRequest request = exchange.getRequest().mutate()
            .header("X-User-Id", userInfo.getUserId())
            .header("X-Username", userInfo.getUsername())
            .header("X-Permissions", String.join(",", userInfo.getPermissions()))
            .build();
        
        // ä¸‹æ¸¸æœåŠ¡ç›´æ¥ä»è¯·æ±‚å¤´è¯»å–ï¼Œä¸ç”¨å†éªŒè¯
        return chain.filter(exchange.mutate().request(request).build());
    }
}
```

**ğŸ”¸ æ–¹æ¡ˆ2ï¼šéªŒè¯ç»“æœä¼ é€’**

```java
// æœåŠ¡AéªŒè¯åï¼ŒæŠŠç»“æœä¼ ç»™æœåŠ¡B
@Service
public class UserService {
    
    @Autowired
    private RestTemplate restTemplate;
    
    public OrderInfo getOrderInfo(String token) {
        // éªŒè¯Token
        UserInfo userInfo = tokenService.validate(token);
        
        // è°ƒç”¨è®¢å•æœåŠ¡æ—¶ï¼Œæºå¸¦éªŒè¯ç»“æœ
        HttpHeaders headers = new HttpHeaders();
        headers.set("X-User-Info", JSON.toJSONString(userInfo));
        
        HttpEntity<String> entity = new HttpEntity<>(headers);
        return restTemplate.exchange(
            "http://order-service/api/orders",
            HttpMethod.GET,
            entity,
            OrderInfo.class
        ).getBody();
    }
}

// è®¢å•æœåŠ¡ç›´æ¥ä½¿ç”¨éªŒè¯ç»“æœï¼Œä¸é‡å¤éªŒè¯
@RestController
public class OrderController {
    
    @GetMapping("/api/orders")
    public OrderInfo getOrders(@RequestHeader("X-User-Info") String userInfoJson) {
        UserInfo userInfo = JSON.parseObject(userInfoJson, UserInfo.class);
        // ç›´æ¥ä½¿ç”¨ç”¨æˆ·ä¿¡æ¯ï¼Œæ— éœ€éªŒè¯Token
        return orderService.getOrders(userInfo.getUserId());
    }
}
```

### 4.3 æ‰¹é‡åˆ·æ–°Token


**åœºæ™¯**ï¼š100ä¸ªç”¨æˆ·çš„Tokenå¿«è¿‡æœŸäº†ï¼Œéœ€è¦åˆ·æ–°

```java
@Service
public class BatchTokenRefreshService {
    
    /**
     * æ‰¹é‡åˆ·æ–°Token
     */
    public void batchRefreshTokens(List<String> refreshTokens) {
        // åˆ†æ‰¹å¤„ç†ï¼Œæ¯æ‰¹20ä¸ª
        List<List<String>> batches = Lists.partition(refreshTokens, 20);
        
        batches.forEach(batch -> {
            CompletableFuture.runAsync(() -> {
                batch.forEach(refreshToken -> {
                    try {
                        // åˆ·æ–°Token
                        String newAccessToken = authService.refreshToken(refreshToken);
                        // é€šçŸ¥ç”¨æˆ·æ›´æ–°Token
                        notifyService.sendTokenUpdate(refreshToken, newAccessToken);
                    } catch (Exception e) {
                        log.error("åˆ·æ–°Tokenå¤±è´¥: {}", refreshToken, e);
                    }
                });
            });
        });
    }
}
```

---

## 5. âš–ï¸ è´Ÿè½½å‡è¡¡è®¾è®¡


### 5.1 ä»€ä¹ˆæ˜¯è´Ÿè½½å‡è¡¡


**ç®€å•ç†è§£**ï¼šå°±åƒæ”¶è´¹ç«™æœ‰å¤šä¸ªé€šé“ï¼Œè½¦æ¥äº†è‡ªåŠ¨åˆ†é…åˆ°ä¸åŒé€šé“ï¼Œé¿å…æŸä¸ªé€šé“å¤ªå¿™ï¼Œå…¶ä»–é€šé“é—²ç€ã€‚

**OAuth2.0ä¸­çš„è´Ÿè½½å‡è¡¡**ï¼š
```
ç”¨æˆ·è¯·æ±‚
    â†“
è´Ÿè½½å‡è¡¡å™¨
    â†“
  â”Œâ”€â”´â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”
è®¤è¯æœåŠ¡1  è®¤è¯æœåŠ¡2  è®¤è¯æœåŠ¡3
  â†“      â†“      â†“
 æ•°æ®åº“  æ•°æ®åº“  æ•°æ®åº“
```

### 5.2 è´Ÿè½½å‡è¡¡ç­–ç•¥


**ğŸ”¸ è½®è¯¢ç­–ç•¥ï¼ˆæœ€ç®€å•ï¼‰**

```
è¯·æ±‚1 â†’ æœåŠ¡å™¨1
è¯·æ±‚2 â†’ æœåŠ¡å™¨2
è¯·æ±‚3 â†’ æœåŠ¡å™¨3
è¯·æ±‚4 â†’ æœåŠ¡å™¨1  â† å¾ªç¯å¼€å§‹
è¯·æ±‚5 â†’ æœåŠ¡å™¨2
```

**ğŸ”¸ æƒé‡ç­–ç•¥ï¼ˆè€ƒè™‘æœåŠ¡å™¨æ€§èƒ½ï¼‰**

```
æœåŠ¡å™¨1ï¼ˆ4æ ¸8Gï¼‰æƒé‡=4
æœåŠ¡å™¨2ï¼ˆ2æ ¸4Gï¼‰æƒé‡=2
æœåŠ¡å™¨3ï¼ˆ2æ ¸4Gï¼‰æƒé‡=2

åˆ†é…ç»“æœï¼š
æœåŠ¡å™¨1å¤„ç† 50%çš„è¯·æ±‚
æœåŠ¡å™¨2å¤„ç† 25%çš„è¯·æ±‚
æœåŠ¡å™¨3å¤„ç† 25%çš„è¯·æ±‚
```

**ğŸ”¸ æœ€å°‘è¿æ¥ç­–ç•¥ï¼ˆæ™ºèƒ½åˆ†é…ï¼‰**

```
å½“å‰çŠ¶æ€ï¼š
æœåŠ¡å™¨1ï¼š50ä¸ªè¿æ¥
æœåŠ¡å™¨2ï¼š30ä¸ªè¿æ¥  â† è¿æ¥æœ€å°‘
æœåŠ¡å™¨3ï¼š40ä¸ªè¿æ¥

æ–°è¯·æ±‚æ¥äº† â†’ åˆ†é…ç»™æœåŠ¡å™¨2
```

### 5.3 Nginxé…ç½®è´Ÿè½½å‡è¡¡


```nginx
# OAuth2.0è®¤è¯æœåŠ¡è´Ÿè½½å‡è¡¡é…ç½®
upstream auth_servers {
    # æœ€å°‘è¿æ¥ç­–ç•¥
    least_conn;
    
    # è®¤è¯æœåŠ¡å™¨åˆ—è¡¨
    server 192.168.1.10:8080 weight=4 max_fails=3 fail_timeout=30s;
    server 192.168.1.11:8080 weight=2 max_fails=3 fail_timeout=30s;
    server 192.168.1.12:8080 weight=2 max_fails=3 fail_timeout=30s;
    
    # å¤‡ç”¨æœåŠ¡å™¨
    server 192.168.1.13:8080 backup;
}

server {
    listen 443 ssl;
    server_name auth.example.com;
    
    location /oauth/ {
        proxy_pass http://auth_servers;
        
        # ä¿æŒä¼šè¯ï¼ˆåŒä¸€ç”¨æˆ·æ‰“åˆ°åŒä¸€å°æœåŠ¡å™¨ï¼‰
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 10s;
        proxy_read_timeout 30s;
    }
}
```

### 5.4 SpringCloudè´Ÿè½½å‡è¡¡


```java
@Configuration
public class LoadBalancerConfig {
    
    /**
     * è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡è§„åˆ™
     */
    @Bean
    public IRule ribbonRule() {
        // æ ¹æ®å“åº”æ—¶é—´é€‰æ‹©æœåŠ¡å™¨ï¼ˆå“åº”å¿«çš„å¤šåˆ†é…ï¼‰
        return new WeightedResponseTimeRule();
    }
}

@Service
public class AuthService {
    
    @Autowired
    @LoadBalanced  // è‡ªåŠ¨è´Ÿè½½å‡è¡¡
    private RestTemplate restTemplate;
    
    public String getToken(String code) {
        // ä¼šè‡ªåŠ¨è´Ÿè½½åˆ°ä¸åŒçš„è®¤è¯æœåŠ¡å™¨
        return restTemplate.postForObject(
            "http://auth-service/oauth/token",
            buildRequest(code),
            String.class
        );
    }
}
```

### 5.5 å¥åº·æ£€æŸ¥


**é˜²æ­¢è¯·æ±‚æ‰“åˆ°æŒ‚æ‰çš„æœåŠ¡å™¨**

```java
@Component
public class AuthServerHealthCheck {
    
    @Scheduled(fixedRate = 10000) // æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡
    public void checkHealth() {
        List<String> servers = getAuthServers();
        
        servers.forEach(server -> {
            try {
                // å‘é€å¥åº·æ£€æŸ¥è¯·æ±‚
                String response = restTemplate.getForObject(
                    server + "/actuator/health", 
                    String.class
                );
                
                if (!"UP".equals(response)) {
                    // æœåŠ¡ä¸å¥åº·ï¼Œæ ‡è®°ä¸ºä¸‹çº¿
                    markServerDown(server);
                    log.warn("è®¤è¯æœåŠ¡å™¨ä¸å¥åº·: {}", server);
                }
            } catch (Exception e) {
                markServerDown(server);
                log.error("è®¤è¯æœåŠ¡å™¨æ— æ³•è®¿é—®: {}", server, e);
            }
        });
    }
}
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 æ€§èƒ½ä¼˜åŒ–æ ¸å¿ƒæ€è·¯


```
è¯†åˆ«ç“¶é¢ˆ â†’ é’ˆå¯¹æ€§ä¼˜åŒ– â†’ ç›‘æ§éªŒè¯ â†’ æŒç»­æ”¹è¿›

å¸¸è§ç“¶é¢ˆï¼š
ğŸ”¸ Tokené‡å¤éªŒè¯ â†’ ç¼“å­˜ä¼˜åŒ–
ğŸ”¸ æ•°æ®åº“è¿æ¥ä¸è¶³ â†’ è¿æ¥æ± ä¼˜åŒ–
ğŸ”¸ é‡å¤éªŒè¯è¯·æ±‚ â†’ æ‰¹é‡éªŒè¯
ğŸ”¸ å•ç‚¹å‹åŠ›å¤§ â†’ è´Ÿè½½å‡è¡¡
```

### 6.2 ä¼˜åŒ–æ•ˆæœå¯¹æ¯”


| ä¼˜åŒ–é¡¹ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|--------|--------|--------|------|
| **TokenéªŒè¯** | æ¯æ¬¡50ms | ç¼“å­˜å5ms | 10å€ |
| **æ•°æ®åº“è¿æ¥** | ç­‰å¾…200ms | æ± åŒ–å5ms | 40å€ |
| **æ‰¹é‡éªŒè¯** | 5æ¬¡éªŒè¯250ms | 1æ¬¡50ms | 5å€ |
| **ç³»ç»Ÿååé‡** | 100 QPS | 1000+ QPS | 10å€+ |

### 6.3 å®æ–½å»ºè®®


**âœ… ä¼˜å…ˆçº§æ’åº**
```
ä¼˜å…ˆçº§1ï¼šTokenç¼“å­˜ï¼ˆè§æ•ˆå¿«ï¼Œæˆæœ¬ä½ï¼‰
ä¼˜å…ˆçº§2ï¼šè¿æ¥æ± ä¼˜åŒ–ï¼ˆå¿…å¤‡åŸºç¡€è®¾æ–½ï¼‰
ä¼˜å…ˆçº§3ï¼šè´Ÿè½½å‡è¡¡ï¼ˆæå‡ç³»ç»Ÿå®¹é‡ï¼‰
ä¼˜å…ˆçº§4ï¼šæ‰¹é‡éªŒè¯ï¼ˆç‰¹å®šåœºæ™¯ï¼‰
```

**âœ… æ³¨æ„äº‹é¡¹**
- âš ï¸ ç¼“å­˜è¦è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´
- âš ï¸ è¿æ¥æ± å¤§å°è¦æ ¹æ®å®é™…å‹æµ‹è°ƒæ•´
- âš ï¸ è´Ÿè½½å‡è¡¡è¦é…åˆå¥åº·æ£€æŸ¥
- âš ï¸ ä¼˜åŒ–åè¦æŒç»­ç›‘æ§æ•ˆæœ

**âœ… ç›‘æ§æŒ‡æ ‡**
```
å¿…é¡»ç›‘æ§ï¼š
- å“åº”æ—¶é—´è¶‹åŠ¿
- ç³»ç»Ÿååé‡
- é”™è¯¯ç‡å˜åŒ–
- ç¼“å­˜å‘½ä¸­ç‡
- è¿æ¥æ± ä½¿ç”¨ç‡
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- æ€§èƒ½ä¼˜åŒ–æ‰¾ç“¶é¢ˆï¼Œç¼“å­˜è¿æ¥æ˜¯å…³é”®
- æ‰¹é‡éªŒè¯å‡é‡å¤ï¼Œè´Ÿè½½å‡è¡¡ä¿ç¨³å®š
- ç›‘æ§æŒ‡æ ‡è¦è·Ÿä¸Šï¼ŒæŒç»­ä¼˜åŒ–ä¸èƒ½åœ