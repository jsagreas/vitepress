---
title: 2ã€OAuth2.0æ—¥å¿—å®¡è®¡
---
## ğŸ“š ç›®å½•

1. [å®¡è®¡æ—¥å¿—åŸºæœ¬æ¦‚å¿µ](#1-å®¡è®¡æ—¥å¿—åŸºæœ¬æ¦‚å¿µ)
2. [å®‰å…¨æ—¥å¿—ä½“ç³»](#2-å®‰å…¨æ—¥å¿—ä½“ç³»)
3. [æ•æ„Ÿä¿¡æ¯ä¿æŠ¤](#3-æ•æ„Ÿä¿¡æ¯ä¿æŠ¤)
4. [æ—¥å¿—åˆ†æä¸ç›‘æ§](#4-æ—¥å¿—åˆ†æä¸ç›‘æ§)
5. [åˆè§„æ€§è¦æ±‚](#5-åˆè§„æ€§è¦æ±‚)
6. [å®æˆ˜æœ€ä½³å®è·µ](#6-å®æˆ˜æœ€ä½³å®è·µ)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ“ å®¡è®¡æ—¥å¿—åŸºæœ¬æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯å®¡è®¡æ—¥å¿—


**é€šä¿—ç†è§£**ï¼šå®¡è®¡æ—¥å¿—å°±åƒä¸€æœ¬"å®‰å…¨è´¦æœ¬"ï¼Œè®°å½•ç³»ç»Ÿé‡Œè°ã€ä»€ä¹ˆæ—¶å€™ã€åšäº†ä»€ä¹ˆäº‹ã€‚

ğŸŒ° **ç”Ÿæ´»ç±»æ¯”**ï¼š
- å°±åƒé“¶è¡Œçš„æµæ°´è´¦ï¼Œè®°å½•æ¯ç¬”é’±çš„è¿›å‡º
- å°±åƒå•†åœºçš„ç›‘æ§å½•åƒï¼Œè®°å½•æ¯ä¸ªäººçš„è¡Œä¸º
- å‡ºé—®é¢˜æ—¶å¯ä»¥"å›æ”¾"ï¼Œè¿½æŸ¥æ˜¯è°çš„è´£ä»»

**æ ¸å¿ƒä½œç”¨**ï¼š
```
äº‹å‰ â†’ å¨æ…‘ä½œç”¨ï¼ˆçŸ¥é“ä¼šè¢«è®°å½•ï¼Œä¸æ•¢ä¹±æ¥ï¼‰
äº‹ä¸­ â†’ å®æ—¶ç›‘æ§ï¼ˆå‘ç°å¼‚å¸¸ç«‹å³æŠ¥è­¦ï¼‰
äº‹å â†’ è¿½æº¯åˆ†æï¼ˆå‡ºé—®é¢˜äº†å¯ä»¥æŸ¥æ¸…æ¥šï¼‰
```

### 1.2 OAuth2.0åœºæ™¯ä¸‹çš„å®¡è®¡é‡ç‚¹


**å¿…é¡»è®°å½•çš„å…³é”®äº‹ä»¶**ï¼š

1ï¸âƒ£ **ç”¨æˆ·ç™»å½•è¡Œä¸º**
- è°ç™»å½•äº†ï¼ˆç”¨æˆ·IDã€ç”¨æˆ·åï¼‰
- ä»å“ªç™»å½•ï¼ˆIPåœ°å€ã€è®¾å¤‡ä¿¡æ¯ï¼‰
- ä»€ä¹ˆæ—¶å€™ç™»å½•ï¼ˆç²¾ç¡®æ—¶é—´ï¼‰
- ç™»å½•ç»“æœï¼ˆæˆåŠŸ/å¤±è´¥/å¼‚å¸¸ï¼‰

2ï¸âƒ£ **ä»¤ç‰Œæ“ä½œ**
- ä»¤ç‰Œçš„åˆ›å»ºã€åˆ·æ–°ã€æ’¤é”€
- ä»¤ç‰Œè¢«è°ä½¿ç”¨è®¿é—®äº†ä»€ä¹ˆèµ„æº
- ä»¤ç‰Œçš„æœ‰æ•ˆæœŸå’Œæƒé™èŒƒå›´

3ï¸âƒ£ **æƒé™å˜æ›´**
- ç”¨æˆ·æƒé™çš„æˆäºˆå’Œå›æ”¶
- è§’è‰²çš„åˆ†é…å’Œè°ƒæ•´
- æ•æ„Ÿæ“ä½œçš„å®¡æ‰¹è®°å½•

**æ¶æ„ç¤ºæ„**ï¼š
```
ç”¨æˆ·è¡Œä¸º â”€â”€â–¶ è®¤è¯æœåŠ¡ â”€â”€â–¶ å®¡è®¡æ—¥å¿—ç³»ç»Ÿ â”€â”€â–¶ æ—¥å¿—å­˜å‚¨
   â”‚           â”‚              â”‚              â”‚
   â–¼           â–¼              â–¼              â–¼
ç™»å½•è¯·æ±‚    è®°å½•è®¤è¯      æ ¼å¼åŒ–å¤„ç†      æŒä¹…åŒ–ä¿å­˜
           ç”Ÿæˆä»¤ç‰Œ      æ•æ„Ÿä¿¡æ¯è„±æ•    å»ºç«‹ç´¢å¼•
```

### 1.3 å®¡è®¡æ—¥å¿—çš„æ ¸å¿ƒè¦ç´ 


**ğŸ”¸ å®Œæ•´æ€§è¦ç´ ï¼ˆ5W1HåŸåˆ™ï¼‰**

| è¦ç´  | **å«ä¹‰** | **ç¤ºä¾‹** | **é‡è¦æ€§** |
|------|---------|---------|-----------|
| Who | `è°æ“ä½œçš„` | `ç”¨æˆ·ID: user123` | `è¿½è´£å¿…å¤‡` |
| What | `åšäº†ä»€ä¹ˆ` | `åˆ·æ–°è®¿é—®ä»¤ç‰Œ` | `è¡Œä¸ºå®šæ€§` |
| When | `ä»€ä¹ˆæ—¶é—´` | `2025-09-23 10:30:15` | `æ—¶åºåˆ†æ` |
| Where | `ä»å“ªé‡Œæ¥` | `IP: 192.168.1.100` | `é£é™©å®šä½` |
| Why | `ä¸ºä»€ä¹ˆåš` | `è®¿é—®ä»¤ç‰Œè¿‡æœŸ` | `åŸå› åˆ†æ` |
| How | `å¦‚ä½•æ‰§è¡Œ` | `ä½¿ç”¨refresh_token` | `æŠ€æœ¯ç»†èŠ‚` |

---

## 2. ğŸ”’ å®‰å…¨æ—¥å¿—ä½“ç³»


### 2.1 æ—¥å¿—åˆ†çº§æ ‡å‡†


**ğŸ”¸ æŒ‰å®‰å…¨çº§åˆ«åˆ†ç±»**

```
ğŸ”´ CRITICALï¼ˆä¸¥é‡ï¼‰
   â””â”€ ç³»ç»Ÿå®‰å…¨å¨èƒã€æ•°æ®æ³„éœ²ã€æš´åŠ›ç ´è§£æˆåŠŸ

ğŸŸ  ERRORï¼ˆé”™è¯¯ï¼‰  
   â””â”€ è®¤è¯å¤±è´¥ã€æƒé™æ‹’ç»ã€ä»¤ç‰ŒéªŒè¯å¤±è´¥

ğŸŸ¡ WARNï¼ˆè­¦å‘Šï¼‰
   â””â”€ å¼‚å¸¸ç™»å½•åœ°ç‚¹ã€é¢‘ç¹åˆ·æ–°ä»¤ç‰Œã€å¯ç–‘è¡Œä¸º

ğŸŸ¢ INFOï¼ˆä¿¡æ¯ï¼‰
   â””â”€ æ­£å¸¸ç™»å½•ã€ä»¤ç‰Œç”Ÿæˆã€èµ„æºè®¿é—®

ğŸ”µ DEBUGï¼ˆè°ƒè¯•ï¼‰
   â””â”€ è¯¦ç»†æµç¨‹è·Ÿè¸ªï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰
```

**å®é™…åº”ç”¨ç¤ºä¾‹**ï¼š

```java
// ä¸åŒçº§åˆ«çš„æ—¥å¿—è®°å½•
@Service
public class OAuth2AuditService {
    
    private static final Logger securityLogger = 
        LoggerFactory.getLogger("SECURITY_AUDIT");
    
    // ğŸ”´ ä¸¥é‡çº§åˆ«ï¼šæ£€æµ‹åˆ°æš´åŠ›ç ´è§£
    public void logBruteForceAttempt(String username, String ip) {
        securityLogger.error(
            "[CRITICAL] æš´åŠ›ç ´è§£æ£€æµ‹ | ç”¨æˆ·: {} | IP: {} | å¤±è´¥æ¬¡æ•°: 10æ¬¡/5åˆ†é’Ÿ",
            username, ip
        );
        // è§¦å‘å‘Šè­¦é€šçŸ¥
        alertService.sendCriticalAlert("æ£€æµ‹åˆ°æš´åŠ›ç ´è§£æ”»å‡»");
    }
    
    // ğŸŸ  é”™è¯¯çº§åˆ«ï¼šä»¤ç‰ŒéªŒè¯å¤±è´¥
    public void logTokenValidationError(String token, String reason) {
        securityLogger.error(
            "[ERROR] ä»¤ç‰ŒéªŒè¯å¤±è´¥ | ä»¤ç‰ŒID: {} | åŸå› : {}",
            hashToken(token), reason  // æ³¨æ„ï¼šä»¤ç‰Œè¦è„±æ•
        );
    }
    
    // ğŸŸ¡ è­¦å‘Šçº§åˆ«ï¼šå¼‚åœ°ç™»å½•
    public void logAbnormalLocation(String userId, String ip, String location) {
        securityLogger.warn(
            "[WARN] å¼‚å¸¸ç™»å½•åœ°ç‚¹ | ç”¨æˆ·: {} | IP: {} | åœ°ç‚¹: {}",
            userId, ip, location
        );
    }
    
    // ğŸŸ¢ ä¿¡æ¯çº§åˆ«ï¼šæ­£å¸¸ç™»å½•
    public void logSuccessfulLogin(String userId, String ip) {
        securityLogger.info(
            "[INFO] ç™»å½•æˆåŠŸ | ç”¨æˆ·: {} | IP: {}",
            userId, ip
        );
    }
}
```

### 2.2 æ—¥å¿—å†…å®¹è§„èŒƒ


**ğŸ”¸ æ ‡å‡†æ—¥å¿—æ ¼å¼**

```json
{
  "timestamp": "2025-09-23T10:30:15.123Z",
  "level": "WARN",
  "eventType": "TOKEN_REFRESH",
  "userId": "user123",
  "username": "zhang***",
  "clientId": "web-app",
  "ip": "192.168.1.100",
  "location": "åŒ—äº¬å¸‚",
  "userAgent": "Mozilla/5.0...",
  "action": "åˆ·æ–°è®¿é—®ä»¤ç‰Œ",
  "result": "SUCCESS",
  "duration": 125,
  "traceId": "abc123def456"
}
```

**å­—æ®µè¯´æ˜**ï¼š

| å­—æ®µ | **è¯´æ˜** | **ä¸ºä»€ä¹ˆéœ€è¦** |
|------|---------|---------------|
| `timestamp` | `ç²¾ç¡®æ—¶é—´æˆ³ï¼ˆæ¯«ç§’çº§ï¼‰` | `æ—¶åºåˆ†æã€æ€§èƒ½ç»Ÿè®¡` |
| `traceId` | `é“¾è·¯è¿½è¸ªID` | `å…³è”å‰åè¯·æ±‚ï¼Œè¿½è¸ªå®Œæ•´æµç¨‹` |
| `userId` | `ç”¨æˆ·å”¯ä¸€æ ‡è¯†` | `å¿«é€Ÿå®šä½å…·ä½“ç”¨æˆ·` |
| `ip` | `å®¢æˆ·ç«¯IPåœ°å€` | `åœ°åŸŸåˆ†æã€é£é™©è¯†åˆ«` |
| `result` | `æ“ä½œç»“æœ` | `æˆåŠŸç‡ç»Ÿè®¡ã€å¼‚å¸¸å‘ç°` |

### 2.3 æ—¥å¿—å­˜å‚¨ç­–ç•¥


**ğŸ”¸ åˆ†å±‚å­˜å‚¨æ–¹æ¡ˆ**

```
å®æ—¶æ—¥å¿—ï¼ˆçƒ­æ•°æ®ï¼‰
   â†“ 7å¤©å†…
ElasticSearch å¿«é€Ÿæ£€ç´¢

å½’æ¡£æ—¥å¿—ï¼ˆæ¸©æ•°æ®ï¼‰
   â†“ 7-90å¤©  
å¯¹è±¡å­˜å‚¨ æˆæœ¬ä¼˜åŒ–

åˆè§„å¤‡ä»½ï¼ˆå†·æ•°æ®ï¼‰
   â†“ 90å¤©ä»¥ä¸Š
ç£å¸¦/å†·å­˜å‚¨ é•¿æœŸä¿å­˜
```

**å­˜å‚¨å®ç°**ï¼š

```java
@Component
public class AuditLogStorage {
    
    @Autowired
    private ElasticsearchTemplate esTemplate;
    
    @Autowired
    private MinioClient minioClient;
    
    // å®æ—¶å†™å…¥ESï¼Œç”¨äºå¿«é€ŸæŸ¥è¯¢
    public void saveToElasticsearch(AuditLog log) {
        IndexQuery query = new IndexQueryBuilder()
            .withId(log.getId())
            .withObject(log)
            .build();
        esTemplate.index(query);
    }
    
    // å®šæ—¶å½’æ¡£åˆ°å¯¹è±¡å­˜å‚¨
    @Scheduled(cron = "0 0 2 * * ?") // æ¯å¤©å‡Œæ™¨2ç‚¹
    public void archiveOldLogs() {
        // æŸ¥è¯¢7å¤©å‰çš„æ—¥å¿—
        LocalDate sevenDaysAgo = LocalDate.now().minusDays(7);
        List<AuditLog> oldLogs = findLogsBefore(sevenDaysAgo);
        
        // å‹ç¼©åä¸Šä¼ åˆ°Minio
        byte[] compressed = compress(oldLogs);
        minioClient.putObject(
            "audit-archive",
            sevenDaysAgo + ".log.gz",
            new ByteArrayInputStream(compressed)
        );
        
        // ä»ESåˆ é™¤å·²å½’æ¡£æ•°æ®
        deleteFromElasticsearch(oldLogs);
    }
}
```

---

## 3. ğŸ›¡ï¸ æ•æ„Ÿä¿¡æ¯ä¿æŠ¤


### 3.1 ä»€ä¹ˆæ˜¯æ•æ„Ÿä¿¡æ¯


**é€šä¿—è§£é‡Š**ï¼šæ•æ„Ÿä¿¡æ¯å°±æ˜¯"ä¸èƒ½æ˜æ–‡è®°å½•"çš„æ•°æ®ï¼Œä¸€æ—¦æ³„éœ²ä¼šé€ æˆå®‰å…¨é£é™©ã€‚

**OAuth2.0ä¸­çš„æ•æ„Ÿä¿¡æ¯**ï¼š

ğŸ”´ **ç»å¯¹ä¸èƒ½è®°å½•çš„**
- ç”¨æˆ·å¯†ç ï¼ˆæ˜æ–‡ï¼‰
- è®¿é—®ä»¤ç‰Œï¼ˆaccess_tokenï¼‰å®Œæ•´å†…å®¹
- åˆ·æ–°ä»¤ç‰Œï¼ˆrefresh_tokenï¼‰å®Œæ•´å†…å®¹
- å®¢æˆ·ç«¯å¯†é’¥ï¼ˆclient_secretï¼‰

ğŸŸ¡ **éœ€è¦è„±æ•å¤„ç†çš„**
- ç”¨æˆ·æ‰‹æœºå·ï¼š138****5678
- é‚®ç®±åœ°å€ï¼šabc***@example.com
- çœŸå®å§“åï¼šå¼ ä¸‰ â†’ å¼ **
- èº«ä»½è¯å·ï¼šå‰6å4ï¼Œä¸­é—´æ˜Ÿå·

ğŸŸ¢ **å¯ä»¥è®°å½•çš„**
- ç”¨æˆ·IDï¼ˆç³»ç»Ÿå†…éƒ¨æ ‡è¯†ï¼‰
- ä»¤ç‰ŒIDï¼ˆtokençš„å“ˆå¸Œå€¼ï¼‰
- æ“ä½œç±»å‹å’Œç»“æœ
- IPåœ°å€å’Œæ—¶é—´æˆ³

### 3.2 è„±æ•å¤„ç†å®ç°


**ğŸ”¸ å¸¸ç”¨è„±æ•ç­–ç•¥**

```java
@Component
public class SensitiveDataMasker {
    
    // æ‰‹æœºå·è„±æ•ï¼š138****5678
    public String maskPhone(String phone) {
        if (phone == null || phone.length() != 11) {
            return "***";
        }
        return phone.substring(0, 3) + "****" + phone.substring(7);
    }
    
    // é‚®ç®±è„±æ•ï¼šabc***@example.com
    public String maskEmail(String email) {
        if (email == null || !email.contains("@")) {
            return "***";
        }
        String[] parts = email.split("@");
        String prefix = parts[0];
        int visibleLength = Math.min(3, prefix.length());
        return prefix.substring(0, visibleLength) + "***@" + parts[1];
    }
    
    // ä»¤ç‰Œè„±æ•ï¼šåªè®°å½•SHA256å“ˆå¸Œå€¼
    public String maskToken(String token) {
        try {
            MessageDigest digest = MessageDigest.getInstance("SHA-256");
            byte[] hash = digest.digest(token.getBytes(StandardCharsets.UTF_8));
            return "token_" + bytesToHex(hash).substring(0, 16);
        } catch (Exception e) {
            return "token_***";
        }
    }
    
    // å§“åè„±æ•ï¼šå¼ ä¸‰ â†’ å¼ **
    public String maskName(String name) {
        if (name == null || name.length() == 0) {
            return "***";
        }
        return name.charAt(0) + "**";
    }
}
```

**åº”ç”¨ç¤ºä¾‹**ï¼š

```java
// âŒ é”™è¯¯åšæ³•ï¼šè®°å½•æ˜æ–‡ä»¤ç‰Œ
securityLogger.info("ç”Ÿæˆä»¤ç‰Œ: {}", accessToken);

// âœ… æ­£ç¡®åšæ³•ï¼šè®°å½•ä»¤ç‰Œå“ˆå¸Œ
securityLogger.info("ç”Ÿæˆä»¤ç‰Œ: {}", masker.maskToken(accessToken));

// âŒ é”™è¯¯åšæ³•ï¼šè®°å½•å®Œæ•´æ‰‹æœºå·  
securityLogger.info("ç”¨æˆ· {} ç™»å½•", user.getPhone());

// âœ… æ­£ç¡®åšæ³•ï¼šæ‰‹æœºå·è„±æ•
securityLogger.info("ç”¨æˆ· {} ç™»å½•", masker.maskPhone(user.getPhone()));
```

### 3.3 æ—¥å¿—åŠ å¯†å­˜å‚¨


**ğŸ”¸ ä¼ è¾“åŠ å¯†**

```
å®¡è®¡æ—¥å¿— â”€â”€TLS/SSLåŠ å¯†â”€â”€â–¶ æ—¥å¿—æœåŠ¡å™¨
    â”‚
    â””â”€ é˜²æ­¢ä¸­é—´äººçªƒå¬
       ä¿éšœä¼ è¾“å®‰å…¨
```

**ğŸ”¸ å­˜å‚¨åŠ å¯†**

```java
@Configuration
public class LogEncryptionConfig {
    
    // é…ç½®æ—¥å¿—æ–‡ä»¶åŠ å¯†
    @Bean
    public RollingFileAppender encryptedAppender() {
        RollingFileAppender appender = new RollingFileAppender();
        
        // ä½¿ç”¨AES-256åŠ å¯†
        EncryptionFilter filter = new EncryptionFilter();
        filter.setAlgorithm("AES/CBC/PKCS5Padding");
        filter.setKey(getEncryptionKey()); // ä»å¯†é’¥ç®¡ç†æœåŠ¡è·å–
        
        appender.addFilter(filter);
        return appender;
    }
    
    // å¯†é’¥ä»ç‹¬ç«‹çš„å¯†é’¥ç®¡ç†æœåŠ¡è·å–
    private SecretKey getEncryptionKey() {
        return keyManagementService.getKey("audit-log-encryption");
    }
}
```

---

## 4. ğŸ“Š æ—¥å¿—åˆ†æä¸ç›‘æ§


### 4.1 å®æ—¶ç›‘æ§æŒ‡æ ‡


**ğŸ”¸ å…³é”®ç›‘æ§ç»´åº¦**

```
ç™»å½•å®‰å…¨ç›‘æ§
â”œâ”€ ç™»å½•æˆåŠŸç‡ï¼šä½äº95%å‘Šè­¦
â”œâ”€ å¤±è´¥æ¬¡æ•°ï¼šå•ç”¨æˆ·5æ¬¡/5åˆ†é’Ÿå‘Šè­¦
â”œâ”€ å¼‚åœ°ç™»å½•ï¼šä¸å†å²åœ°ç‚¹ä¸ç¬¦å‘Šè­¦
â””â”€ å¼‚å¸¸æ—¶æ®µï¼šéå·¥ä½œæ—¶é—´ç™»å½•å‘Šè­¦

ä»¤ç‰Œå®‰å…¨ç›‘æ§  
â”œâ”€ ä»¤ç‰Œåˆ·æ–°é¢‘ç‡ï¼šå¼‚å¸¸é¢‘ç¹å‘Šè­¦
â”œâ”€ ä»¤ç‰ŒéªŒè¯å¤±è´¥ç‡ï¼šè¶…è¿‡5%å‘Šè­¦
â”œâ”€ ä»¤ç‰Œè¿‡æœŸæ¯”ä¾‹ï¼šæå‰é¢„è­¦
â””â”€ åŒä¸€ä»¤ç‰Œå¤šåœ°ä½¿ç”¨ï¼šç–‘ä¼¼æ³„éœ²å‘Šè­¦

ç³»ç»Ÿæ€§èƒ½ç›‘æ§
â”œâ”€ è®¤è¯å“åº”æ—¶é—´ï¼šè¶…è¿‡2ç§’å‘Šè­¦
â”œâ”€ æ—¥å¿—å†™å…¥å»¶è¿Ÿï¼šè¶…è¿‡100mså‘Šè­¦
â”œâ”€ å­˜å‚¨å®¹é‡ï¼šç£ç›˜ä½¿ç”¨è¶…80%å‘Šè­¦
â””â”€ æŸ¥è¯¢æ€§èƒ½ï¼šP99å»¶è¿Ÿè¶…500mså‘Šè­¦
```

### 4.2 å¼‚å¸¸æ£€æµ‹è§„åˆ™


**ğŸ”¸ åŸºäºè§„åˆ™çš„æ£€æµ‹**

```java
@Component
public class AnomalyDetector {
    
    private static final int MAX_FAILED_ATTEMPTS = 5;
    private static final Duration TIME_WINDOW = Duration.ofMinutes(5);
    
    @Autowired
    private RedisTemplate<String, Integer> redisTemplate;
    
    // æ£€æµ‹æš´åŠ›ç ´è§£
    public boolean detectBruteForce(String username, String ip) {
        String key = "failed_login:" + username + ":" + ip;
        
        Integer failedCount = redisTemplate.opsForValue().get(key);
        if (failedCount == null) {
            failedCount = 0;
        }
        
        failedCount++;
        redisTemplate.opsForValue().set(key, failedCount, TIME_WINDOW);
        
        if (failedCount >= MAX_FAILED_ATTEMPTS) {
            // ğŸš¨ è§¦å‘å‘Šè­¦
            alertService.sendAlert(
                "æ£€æµ‹åˆ°æš´åŠ›ç ´è§£",
                "ç”¨æˆ·: " + username + ", IP: " + ip
            );
            return true;
        }
        return false;
    }
    
    // æ£€æµ‹å¼‚åœ°ç™»å½•
    public boolean detectAbnormalLocation(String userId, String currentIp) {
        String lastIp = getUserLastLoginIp(userId);
        if (lastIp == null) {
            return false;
        }
        
        String currentLocation = ipLocationService.getLocation(currentIp);
        String lastLocation = ipLocationService.getLocation(lastIp);
        
        // å¦‚æœè·ç¦»è¶…è¿‡500å…¬é‡Œ
        if (calculateDistance(currentLocation, lastLocation) > 500) {
            alertService.sendAlert(
                "æ£€æµ‹åˆ°å¼‚åœ°ç™»å½•",
                "ç”¨æˆ·: " + userId + ", ä» " + lastLocation + " åˆ° " + currentLocation
            );
            return true;
        }
        return false;
    }
}
```

### 4.3 æ—¥å¿—åˆ†æå®æˆ˜


**ğŸ”¸ ä½¿ç”¨ELKåˆ†æç™»å½•è¶‹åŠ¿**

```
Kibanaå¯è§†åŒ–æŸ¥è¯¢ç¤ºä¾‹ï¼š

// æŸ¥è¯¢è¿‡å»24å°æ—¶çš„ç™»å½•å¤±è´¥ç‡
GET /audit-logs/_search
{
  "query": {
    "bool": {
      "must": [
        { "match": { "eventType": "LOGIN" }},
        { "range": { "timestamp": { "gte": "now-24h" }}}
      ]
    }
  },
  "aggs": {
    "login_results": {
      "terms": { "field": "result" }
    }
  }
}

// åˆ†æç»“æœå±•ç¤ºï¼š
æˆåŠŸï¼š8500æ¬¡ (94.4%)
å¤±è´¥ï¼š500æ¬¡ (5.6%)  âš ï¸ å¤±è´¥ç‡åé«˜ï¼Œéœ€è¦è°ƒæŸ¥
```

**ğŸ”¸ è¯†åˆ«é«˜é£é™©ç”¨æˆ·**

```sql
-- æŸ¥è¯¢è¿‘7å¤©å¤šæ¬¡ç™»å½•å¤±è´¥çš„ç”¨æˆ·
SELECT 
    userId,
    COUNT(*) as failed_count,
    COUNT(DISTINCT ip) as ip_count
FROM audit_logs
WHERE 
    eventType = 'LOGIN'
    AND result = 'FAILED'
    AND timestamp >= NOW() - INTERVAL 7 DAY
GROUP BY userId
HAVING failed_count > 10
ORDER BY failed_count DESC;
```

---

## 5. ğŸ“œ åˆè§„æ€§è¦æ±‚


### 5.1 å¸¸è§å®‰å…¨åˆè§„æ ‡å‡†


**ğŸ”¸ ç­‰ä¿2.0è¦æ±‚**

| è¦æ±‚é¡¹ | **å…·ä½“è§„å®š** | **å®æ–½è¦ç‚¹** |
|--------|-------------|-------------|
| **æ—¥å¿—ç•™å­˜** | `è‡³å°‘ä¿å­˜6ä¸ªæœˆ` | `å»ºç«‹è‡ªåŠ¨å½’æ¡£æœºåˆ¶` |
| **å®‰å…¨å®¡è®¡** | `è®°å½•é‡è¦æ“ä½œ` | `ç™»å½•ã€æˆæƒã€é…ç½®å˜æ›´` |
| **æ—¥å¿—ä¿æŠ¤** | `é˜²ç¯¡æ”¹ã€é˜²åˆ é™¤` | `ä½¿ç”¨åªè¯»å­˜å‚¨æˆ–åŒºå—é“¾` |
| **åº”æ€¥å“åº”** | `å¼‚å¸¸äº‹ä»¶å‘Šè­¦` | `å»ºç«‹7Ã—24å°æ—¶ç›‘æ§` |

**ğŸ”¸ GDPRï¼ˆæ¬§ç›Ÿæ•°æ®ä¿æŠ¤æ¡ä¾‹ï¼‰**

```
ä¸ªäººæ•°æ®ä¿æŠ¤è¦æ±‚ï¼š

1ï¸âƒ£ æœ€å°åŒ–åŸåˆ™
   â””â”€ åªè®°å½•å¿…è¦çš„ä¸ªäººä¿¡æ¯
   
2ï¸âƒ£ ç›®çš„é™åˆ¶
   â””â”€ æ—¥å¿—ä»…ç”¨äºå®‰å…¨å®¡è®¡ï¼Œä¸å¾—æŒªä½œä»–ç”¨
   
3ï¸âƒ£ å­˜å‚¨æœŸé™
   â””â”€ è¶…è¿‡åˆç†æœŸé™åå¿…é¡»åˆ é™¤
   
4ï¸âƒ£ ç”¨æˆ·æƒåˆ©
   â””â”€ ç”¨æˆ·æœ‰æƒæŸ¥è¯¢å’Œåˆ é™¤è‡ªå·±çš„æ—¥å¿—
```

### 5.2 åˆè§„æ—¥å¿—å®ç°


**ğŸ”¸ é˜²ç¯¡æ”¹æ—¥å¿—**

```java
@Service
public class TamperProofLogging {
    
    // ä½¿ç”¨åŒºå—é“¾æ€æƒ³ï¼šæ¯æ¡æ—¥å¿—åŒ…å«å‰ä¸€æ¡çš„å“ˆå¸Œ
    public AuditLog createTamperProofLog(String content, String previousHash) {
        AuditLog log = new AuditLog();
        log.setContent(content);
        log.setPreviousHash(previousHash);
        
        // è®¡ç®—å½“å‰æ—¥å¿—çš„å“ˆå¸Œï¼ˆåŒ…å«å‰ä¸€æ¡çš„å“ˆå¸Œï¼‰
        String currentHash = calculateHash(
            content + previousHash + System.currentTimeMillis()
        );
        log.setCurrentHash(currentHash);
        
        return log;
    }
    
    // éªŒè¯æ—¥å¿—é“¾å®Œæ•´æ€§
    public boolean verifyLogChain(List<AuditLog> logs) {
        for (int i = 1; i < logs.size(); i++) {
            AuditLog current = logs.get(i);
            AuditLog previous = logs.get(i - 1);
            
            // éªŒè¯å“ˆå¸Œé“¾
            if (!current.getPreviousHash().equals(previous.getCurrentHash())) {
                return false; // å‘ç°ç¯¡æ”¹
            }
        }
        return true;
    }
}
```

### 5.3 åˆè§„æ£€æŸ¥æ¸…å•


**ğŸ“‹ ä¸Šçº¿å‰è‡ªæŸ¥**

- [ ] **æ—¥å¿—å®Œæ•´æ€§**
  - [ ] æ˜¯å¦è®°å½•äº†æ‰€æœ‰å…³é”®å®‰å…¨äº‹ä»¶
  - [ ] æ—¥å¿—æ ¼å¼æ˜¯å¦ç¬¦åˆæ ‡å‡†
  - [ ] æ˜¯å¦æœ‰é—æ¼çš„å®¡è®¡ç‚¹

- [ ] **æ•æ„Ÿä¿¡æ¯ä¿æŠ¤**
  - [ ] å¯†ç ã€ä»¤ç‰Œæ˜¯å¦å·²è„±æ•
  - [ ] ä¸ªäººä¿¡æ¯æ˜¯å¦å·²è„±æ•
  - [ ] æ—¥å¿—ä¼ è¾“æ˜¯å¦åŠ å¯†

- [ ] **å­˜å‚¨ä¸ç•™å­˜**
  - [ ] æ—¥å¿—ä¿ç•™æœŸé™æ˜¯å¦ç¬¦åˆè¦æ±‚
  - [ ] æ˜¯å¦æœ‰è‡ªåŠ¨å½’æ¡£æœºåˆ¶
  - [ ] å­˜å‚¨å®¹é‡æ˜¯å¦å……è¶³

- [ ] **ç›‘æ§ä¸å‘Šè­¦**
  - [ ] å¼‚å¸¸æ£€æµ‹è§„åˆ™æ˜¯å¦ç”Ÿæ•ˆ
  - [ ] å‘Šè­¦é€šçŸ¥æ˜¯å¦åŠæ—¶
  - [ ] æ˜¯å¦æœ‰åº”æ€¥å“åº”é¢„æ¡ˆ

---

## 6. ğŸš€ å®æˆ˜æœ€ä½³å®è·µ


### 6.1 å®¡è®¡æ—¥å¿—å®Œæ•´å®ç°


**ğŸ”¸ å®Œæ•´çš„å®¡è®¡æœåŠ¡**

```java
@Service
@Slf4j
public class OAuth2AuditService {
    
    @Autowired
    private AuditLogRepository logRepository;
    
    @Autowired
    private SensitiveDataMasker masker;
    
    @Autowired
    private AnomalyDetector anomalyDetector;
    
    // è®°å½•ç™»å½•äº‹ä»¶
    public void auditLogin(LoginEvent event) {
        AuditLog log = AuditLog.builder()
            .timestamp(LocalDateTime.now())
            .eventType("LOGIN")
            .userId(event.getUserId())
            .username(masker.maskName(event.getUsername()))
            .ip(event.getIp())
            .userAgent(event.getUserAgent())
            .result(event.isSuccess() ? "SUCCESS" : "FAILED")
            .build();
        
        // å¼‚æ­¥å†™å…¥æ•°æ®åº“
        asyncSave(log);
        
        // å¦‚æœç™»å½•å¤±è´¥ï¼Œæ£€æµ‹æš´åŠ›ç ´è§£
        if (!event.isSuccess()) {
            anomalyDetector.detectBruteForce(
                event.getUsername(), 
                event.getIp()
            );
        }
    }
    
    // è®°å½•ä»¤ç‰Œæ“ä½œ
    public void auditTokenOperation(TokenEvent event) {
        AuditLog log = AuditLog.builder()
            .timestamp(LocalDateTime.now())
            .eventType(event.getType()) // CREATE/REFRESH/REVOKE
            .userId(event.getUserId())
            .tokenId(masker.maskToken(event.getToken())) // ä»¤ç‰Œè„±æ•
            .clientId(event.getClientId())
            .scope(event.getScope())
            .result(event.getResult())
            .build();
        
        asyncSave(log);
    }
    
    // å¼‚æ­¥ä¿å­˜ï¼Œä¸å½±å“ä¸»æµç¨‹æ€§èƒ½
    @Async
    private void asyncSave(AuditLog log) {
        try {
            logRepository.save(log);
        } catch (Exception e) {
            log.error("å®¡è®¡æ—¥å¿—å†™å…¥å¤±è´¥", e);
            // é™çº§ï¼šå†™å…¥æœ¬åœ°æ–‡ä»¶
            writeToLocalFile(log);
        }
    }
}
```

### 6.2 æ—¥å¿—æŸ¥è¯¢æ¥å£


**ğŸ”¸ æä¾›ç®¡ç†å‘˜æŸ¥è¯¢èƒ½åŠ›**

```java
@RestController
@RequestMapping("/api/audit")
public class AuditLogController {
    
    @Autowired
    private AuditLogService auditLogService;
    
    // æŸ¥è¯¢ç”¨æˆ·æ“ä½œè®°å½•
    @GetMapping("/user/{userId}")
    @PreAuthorize("hasRole('ADMIN')")
    public Page<AuditLog> getUserLogs(
        @PathVariable String userId,
        @RequestParam(defaultValue = "0") int page,
        @RequestParam(defaultValue = "20") int size
    ) {
        return auditLogService.findByUserId(
            userId, 
            PageRequest.of(page, size)
        );
    }
    
    // æŸ¥è¯¢å¼‚å¸¸äº‹ä»¶
    @GetMapping("/anomalies")
    @PreAuthorize("hasRole('SECURITY_ADMIN')")
    public List<AuditLog> getAnomalies(
        @RequestParam LocalDateTime startTime,
        @RequestParam LocalDateTime endTime
    ) {
        return auditLogService.findAnomalies(startTime, endTime);
    }
}
```

### 6.3 æ€§èƒ½ä¼˜åŒ–å»ºè®®


**ğŸ”¸ æ—¥å¿—å†™å…¥ä¼˜åŒ–**

```
æ‰¹é‡å†™å…¥ç­–ç•¥ï¼š

å•æ¡å†™å…¥
   â†“ æ€§èƒ½å·®ï¼Œæ•°æ®åº“å‹åŠ›å¤§
   
æ‰¹é‡ç¼“å†²
   â†“ æ¯500æ¡æˆ–5ç§’å†™å…¥ä¸€æ¬¡
   
å¼‚æ­¥å†™å…¥
   â†“ ä¸é˜»å¡ä¸»ä¸šåŠ¡æµç¨‹
   
é™çº§å¤„ç†
   â””â”€ æ•°æ®åº“æ•…éšœæ—¶å†™æœ¬åœ°æ–‡ä»¶
```

**å®ç°ä»£ç **ï¼š

```java
@Component
public class BatchAuditLogger {
    
    private final Queue<AuditLog> buffer = new ConcurrentLinkedQueue<>();
    private static final int BATCH_SIZE = 500;
    
    @Autowired
    private AuditLogRepository repository;
    
    // æ·»åŠ åˆ°ç¼“å†²åŒº
    public void add(AuditLog log) {
        buffer.offer(log);
        
        // è¾¾åˆ°æ‰¹é‡å¤§å°ï¼Œç«‹å³å†™å…¥
        if (buffer.size() >= BATCH_SIZE) {
            flush();
        }
    }
    
    // å®šæ—¶åˆ·æ–°ï¼ˆæ¯5ç§’ï¼‰
    @Scheduled(fixedDelay = 5000)
    public void scheduledFlush() {
        if (!buffer.isEmpty()) {
            flush();
        }
    }
    
    // æ‰¹é‡å†™å…¥æ•°æ®åº“
    private void flush() {
        List<AuditLog> batch = new ArrayList<>();
        AuditLog log;
        
        while ((log = buffer.poll()) != null) {
            batch.add(log);
        }
        
        if (!batch.isEmpty()) {
            repository.saveAll(batch); // æ‰¹é‡ä¿å­˜
        }
    }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ¯ å®¡è®¡æ—¥å¿—ä¸‰å¤§ç›®æ ‡**
```
ğŸ”¸ å¯è¿½æº¯ï¼šä»»ä½•æ“ä½œéƒ½èƒ½è¿½æŸ¥åˆ°è´£ä»»äºº
ğŸ”¸ å¯åˆ†æï¼šé€šè¿‡æ—¥å¿—å‘ç°å¼‚å¸¸å’Œè¶‹åŠ¿
ğŸ”¸ å¯åˆè§„ï¼šæ»¡è¶³å®‰å…¨æ ‡å‡†å’Œæ³•è§„è¦æ±‚
```

**ğŸ¯ æ—¥å¿—è®°å½•5W1HåŸåˆ™**
- âœ… è°ï¼ˆWhoï¼‰æ“ä½œçš„
- âœ… åšäº†ä»€ä¹ˆï¼ˆWhatï¼‰
- âœ… ä»€ä¹ˆæ—¶é—´ï¼ˆWhenï¼‰
- âœ… ä»å“ªé‡Œï¼ˆWhereï¼‰
- âœ… ä¸ºä»€ä¹ˆï¼ˆWhyï¼‰åš
- âœ… å¦‚ä½•ï¼ˆHowï¼‰æ‰§è¡Œ

**ğŸ¯ æ•æ„Ÿä¿¡æ¯ä¿æŠ¤åŸåˆ™**
- ğŸ”´ å¯†ç ã€ä»¤ç‰Œï¼šç»ä¸æ˜æ–‡è®°å½•
- ğŸŸ¡ ä¸ªäººä¿¡æ¯ï¼šå¿…é¡»è„±æ•å¤„ç†
- ğŸ”’ æ—¥å¿—æ–‡ä»¶ï¼šä¼ è¾“å’Œå­˜å‚¨åŠ å¯†

### 7.2 å…³é”®å®æ–½è¦ç‚¹


**ğŸ“Š ç›‘æ§å››ä¸ªå±‚é¢**

| å±‚é¢ | **ç›‘æ§å†…å®¹** | **å‘Šè­¦æ¡ä»¶** |
|------|------------|-------------|
| ğŸ”¸ **å®‰å…¨** | `æš´åŠ›ç ´è§£ã€å¼‚åœ°ç™»å½•` | `ç«‹å³å‘Šè­¦` |
| ğŸ”¸ **æ€§èƒ½** | `å“åº”æ—¶é—´ã€ååé‡` | `è¶…é˜ˆå€¼å‘Šè­¦` |
| ğŸ”¸ **å®¹é‡** | `å­˜å‚¨ç©ºé—´ã€æ—¥å¿—é‡` | `æå‰é¢„è­¦` |
| ğŸ”¸ **åˆè§„** | `ç•™å­˜æœŸé™ã€å®Œæ•´æ€§` | `å®šæœŸæ£€æŸ¥` |

**ğŸ› ï¸ å®æˆ˜æ³¨æ„äº‹é¡¹**

> ğŸ’¡ **æ€§èƒ½ä¼˜åŒ–**  
> æ—¥å¿—å†™å…¥é‡‡ç”¨å¼‚æ­¥+æ‰¹é‡ï¼Œé¿å…å½±å“ä¸»ä¸šåŠ¡æ€§èƒ½

> âš ï¸ **é™çº§å¤„ç†**  
> æ•°æ®åº“æ•…éšœæ—¶ï¼Œé™çº§å†™å…¥æœ¬åœ°æ–‡ä»¶ï¼Œç¡®ä¿æ—¥å¿—ä¸ä¸¢å¤±

> ğŸ”’ **è®¿é—®æ§åˆ¶**  
> åªæœ‰å®‰å…¨ç®¡ç†å‘˜èƒ½æŸ¥è¯¢å®¡è®¡æ—¥å¿—ï¼Œé˜²æ­¢éšç§æ³„éœ²

> ğŸ“… **å®šæœŸå·¡æ£€**  
> æ¯å‘¨æ£€æŸ¥æ—¥å¿—ç³»ç»Ÿè¿è¡ŒçŠ¶æ€ï¼Œæ¯æœˆéªŒè¯åˆè§„æ€§

### 7.3 å­¦ä¹ è·¯å¾„å»ºè®®


**ğŸ—ºï¸ ä»åŸºç¡€åˆ°è¿›é˜¶**

```
ç¬¬ä¸€æ­¥ï¼šç†è§£å®¡è®¡æ—¥å¿—çš„ä½œç”¨å’Œæ„ä¹‰
   â†“
ç¬¬äºŒæ­¥ï¼šæŒæ¡æ—¥å¿—åˆ†çº§å’Œæ ¼å¼è§„èŒƒ
   â†“  
ç¬¬ä¸‰æ­¥ï¼šå­¦ä¼šæ•æ„Ÿä¿¡æ¯è„±æ•å¤„ç†
   â†“
ç¬¬å››æ­¥ï¼šæ­å»ºæ—¥å¿—åˆ†æå’Œç›‘æ§ä½“ç³»
   â†“
ç¬¬äº”æ­¥ï¼šæ»¡è¶³å®‰å…¨åˆè§„è¦æ±‚
```

**ğŸ¯ å®æˆ˜ç»ƒä¹ å»ºè®®**

1ï¸âƒ£ **åŸºç¡€ç»ƒä¹ **ï¼šæ­å»ºä¸€ä¸ªç®€å•çš„æ—¥å¿—è®°å½•ç³»ç»Ÿ
2ï¸âƒ£ **è¿›é˜¶ç»ƒä¹ **ï¼šå®ç°æ•æ„Ÿä¿¡æ¯è„±æ•å’ŒåŠ å¯†å­˜å‚¨
3ï¸âƒ£ **é«˜çº§ç»ƒä¹ **ï¼šé›†æˆELKå®ç°æ—¥å¿—åˆ†æå’Œå¯è§†åŒ–
4ï¸âƒ£ **ç»¼åˆç»ƒä¹ **ï¼šè®¾è®¡ä¸€å¥—å®Œæ•´çš„å®¡è®¡ç›‘æ§æ–¹æ¡ˆ

---

**ğŸ§  è®°å¿†å£è¯€**

```
å®¡è®¡æ—¥å¿—è¦è®°ç‰¢ï¼Œäº”Wä¸€Hä¸èƒ½å°‘
æ•æ„Ÿä¿¡æ¯è¦è„±æ•ï¼Œå¯†ç ä»¤ç‰Œä¸å¤–æ³„  
åˆ†çº§å­˜å‚¨æœ‰ç­–ç•¥ï¼Œçƒ­æ¸©å†·æ•°å„å®‰å¥½
å®æ—¶ç›‘æ§åŠ å‘Šè­¦ï¼Œå¼‚å¸¸äº‹ä»¶æ—©çŸ¥é“
åˆè§„æ ‡å‡†è¦éµå®ˆï¼Œç•™å­˜æœŸé™è¦è®°å¥½
```