---
title: 1ã€OAuth2.0æŒ‡æ ‡ç›‘æ§
---
## ğŸ“š ç›®å½•

1. [OAuth2.0ç›‘æ§æ¦‚è¿°](#1-OAuth2-0ç›‘æ§æ¦‚è¿°)
2. [å…³é”®æ€§èƒ½æŒ‡æ ‡](#2-å…³é”®æ€§èƒ½æŒ‡æ ‡)
3. [Tokenä½¿ç”¨ç»Ÿè®¡](#3-Tokenä½¿ç”¨ç»Ÿè®¡)
4. [é”™è¯¯ç‡ç›‘æ§](#4-é”™è¯¯ç‡ç›‘æ§)
5. [å“åº”æ—¶é—´åˆ†æ](#5-å“åº”æ—¶é—´åˆ†æ)
6. [å¹¶å‘é‡ç›‘æ§](#6-å¹¶å‘é‡ç›‘æ§)
7. [ç›‘æ§å·¥å…·é›†æˆ](#7-ç›‘æ§å·¥å…·é›†æˆ)
8. [å‘Šè­¦æœºåˆ¶è®¾ç½®](#8-å‘Šè­¦æœºåˆ¶è®¾ç½®)
9. [æ•…éšœå¤„ç†å®è·µ](#9-æ•…éšœå¤„ç†å®è·µ)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” OAuth2.0ç›‘æ§æ¦‚è¿°


### 1.1 ä¸ºä»€ä¹ˆéœ€è¦ç›‘æ§OAuth2.0


**ç†è§£ç›‘æ§çš„æœ¬è´¨**ï¼šæƒ³è±¡OAuth2.0å°±åƒä½ å®¶çš„é—¨é”ç³»ç»Ÿï¼Œä½ éœ€è¦çŸ¥é“ï¼š
```
ğŸ  é—¨é”ç³»ç»Ÿç±»æ¯”ï¼š
â€¢ æœ‰å¤šå°‘äººåœ¨ä½¿ç”¨é’¥åŒ™ï¼Ÿ        â†’ Tokenä½¿ç”¨é‡
â€¢ æœ‰äººè¯•å›¾æ’¬é”å—ï¼Ÿ            â†’ é”™è¯¯ç‡
â€¢ å¼€é—¨é€Ÿåº¦å¿«ä¸å¿«ï¼Ÿ            â†’ å“åº”æ—¶é—´
â€¢ é«˜å³°æœŸä¼šä¸ä¼šå¡ä½ï¼Ÿ          â†’ å¹¶å‘å¤„ç†èƒ½åŠ›
â€¢ é’¥åŒ™æœ‰æ²¡æœ‰è¢«æ»¥ç”¨ï¼Ÿ          â†’ å¼‚å¸¸è¡Œä¸ºæ£€æµ‹
```

**ç›‘æ§çš„æ ¸å¿ƒä»·å€¼**ï¼š
- ğŸ¯ **åŠæ—¶å‘ç°é—®é¢˜**ï¼šåœ¨ç”¨æˆ·æŠ•è¯‰å‰å°±å‘ç°å¼‚å¸¸
- ğŸ›¡ï¸ **ä¿éšœç³»ç»Ÿå®‰å…¨**ï¼šè¯†åˆ«æ¶æ„æ”»å‡»å’Œå¼‚å¸¸è¡Œä¸º
- ğŸ“ˆ **ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½**ï¼šåŸºäºæ•°æ®åšæ€§èƒ½è°ƒä¼˜
- ğŸ’° **é™ä½è¿ç»´æˆæœ¬**ï¼šè‡ªåŠ¨åŒ–ç›‘æ§å‡å°‘äººå·¥å·¡æ£€

### 1.2 OAuth2.0ç›‘æ§çš„ç‰¹æ®Šæ€§


**ä¸æ™®é€šä¸šåŠ¡ç›‘æ§çš„åŒºåˆ«**ï¼š
```
æ™®é€šä¸šåŠ¡ç³»ç»Ÿç›‘æ§ï¼š              OAuth2.0è®¤è¯ç›‘æ§ï¼š
å…³æ³¨ä¸šåŠ¡æ•°æ®å¤„ç†               å…³æ³¨è®¤è¯æˆæƒæµç¨‹
ç›‘æ§ç”¨æˆ·æ“ä½œè¡Œä¸º               ç›‘æ§Tokenç”Ÿå‘½å‘¨æœŸ
é”™è¯¯å½±å“å•ä¸ªåŠŸèƒ½               é”™è¯¯å½±å“æ•´ä¸ªç³»ç»Ÿè®¿é—®
```

**éœ€è¦é‡ç‚¹å…³æ³¨çš„æ–¹é¢**ï¼š
- ğŸ” **è®¤è¯æˆæƒæµç¨‹**ï¼šå„ä¸ªæˆæƒæ¨¡å¼çš„æˆåŠŸç‡
- ğŸ« **Tokenç®¡ç†**ï¼šTokençš„ç­¾å‘ã€åˆ·æ–°ã€è¿‡æœŸæƒ…å†µ
- ğŸš¨ **å®‰å…¨äº‹ä»¶**ï¼šæš´åŠ›ç ´è§£ã€Tokenæ³„éœ²ã€å¼‚å¸¸è®¿é—®
- âš¡ **æ€§èƒ½ç“¶é¢ˆ**ï¼šé«˜å¹¶å‘ä¸‹çš„å“åº”èƒ½åŠ›

---

## 2. ğŸ“Š å…³é”®æ€§èƒ½æŒ‡æ ‡


### 2.1 æ ¸å¿ƒæŒ‡æ ‡ä½“ç³»


**OAuth2.0çš„å…³é”®æŒ‡æ ‡é‡‘å­—å¡”**ï¼š
```
                  ğŸ¯ ä¸šåŠ¡æŒ‡æ ‡
                 /          \
            è®¤è¯æˆåŠŸç‡      æˆæƒæˆåŠŸç‡
           /      |      \
      æ€§èƒ½æŒ‡æ ‡  å®‰å…¨æŒ‡æ ‡  ç¨³å®šæ€§æŒ‡æ ‡
     /    |    \   |   /    |    \
  QPS  å“åº”  å¹¶å‘ å¤±è´¥ å¼‚å¸¸  å¯ç”¨  å®¹é”™
       æ—¶é—´      ç‡   è®¿é—®  æ€§    èƒ½åŠ›
```

### 2.2 å¿…é¡»ç›‘æ§çš„æ ¸å¿ƒæŒ‡æ ‡


**ğŸ”¸ å¯ç”¨æ€§æŒ‡æ ‡**

| æŒ‡æ ‡åç§° | å«ä¹‰è¯´æ˜ | æ­£å¸¸èŒƒå›´ | å‘Šè­¦é˜ˆå€¼ |
|---------|---------|---------|---------|
| `è®¤è¯æœåŠ¡å¯ç”¨ç‡` | è®¤è¯æœåŠ¡æ­£å¸¸è¿è¡Œæ—¶é—´å æ¯” | `>99.9%` | `<99%` |
| `æˆæƒæˆåŠŸç‡` | æˆåŠŸè·å–Tokençš„è¯·æ±‚å æ¯” | `>95%` | `<90%` |
| `TokenéªŒè¯æˆåŠŸç‡` | TokenéªŒè¯é€šè¿‡çš„æ¯”ä¾‹ | `>98%` | `<95%` |

**ç†è§£å¯ç”¨æ€§**ï¼šå°±åƒé“¶è¡Œçš„è¥ä¸šæ—¶é—´ï¼Œ99.9%å¯ç”¨ç‡æ„å‘³ç€ä¸€ä¸ªæœˆåªèƒ½åœæœº43åˆ†é’Ÿã€‚

**ğŸ”¸ æ€§èƒ½æŒ‡æ ‡**

| æŒ‡æ ‡åç§° | å«ä¹‰è¯´æ˜ | æ­£å¸¸èŒƒå›´ | å‘Šè­¦é˜ˆå€¼ |
|---------|---------|---------|---------|
| `å¹³å‡å“åº”æ—¶é—´` | å¤„ç†è¯·æ±‚çš„å¹³å‡è€—æ—¶ | `<100ms` | `>200ms` |
| `P95å“åº”æ—¶é—´` | 95%çš„è¯·æ±‚å“åº”æ—¶é—´ | `<200ms` | `>500ms` |
| `P99å“åº”æ—¶é—´` | 99%çš„è¯·æ±‚å“åº”æ—¶é—´ | `<500ms` | `>1000ms` |
| `QPSï¼ˆæ¯ç§’è¯·æ±‚æ•°ï¼‰` | ç³»ç»Ÿå¤„ç†èƒ½åŠ› | `æ ¹æ®å®¹é‡è§„åˆ’` | `>80%å®¹é‡` |

**æ€§èƒ½æŒ‡æ ‡è§£è¯»**ï¼š
```
ğŸ¯ P95å“åº”æ—¶é—´çš„å«ä¹‰ï¼š
å‡è®¾å¤„ç†äº†100ä¸ªè¯·æ±‚ï¼ŒæŒ‰å“åº”æ—¶é—´ä»å°åˆ°å¤§æ’åº
P95 = 200ms è¡¨ç¤ºï¼š
â€¢ 95ä¸ªè¯·æ±‚åœ¨200mså†…å®Œæˆ
â€¢ åªæœ‰5ä¸ªè¯·æ±‚è¶…è¿‡200ms
â€¢ å¤§éƒ¨åˆ†ç”¨æˆ·ä½“éªŒè‰¯å¥½
```

**ğŸ”¸ å®‰å…¨æŒ‡æ ‡**

| æŒ‡æ ‡åç§° | å«ä¹‰è¯´æ˜ | æ­£å¸¸èŒƒå›´ | å‘Šè­¦é˜ˆå€¼ |
|---------|---------|---------|---------|
| `è®¤è¯å¤±è´¥ç‡` | è®¤è¯å¤±è´¥çš„è¯·æ±‚å æ¯” | `<5%` | `>10%` |
| `Tokenæ³„éœ²äº‹ä»¶` | æ£€æµ‹åˆ°çš„Tokenæ»¥ç”¨æ¬¡æ•° | `0æ¬¡/å¤©` | `>5æ¬¡/å¤©` |
| `å¼‚å¸¸IPè®¿é—®` | æ¥è‡ªå¯ç–‘IPçš„è®¿é—®æ¬¡æ•° | `<10æ¬¡/å°æ—¶` | `>50æ¬¡/å°æ—¶` |
| `æš´åŠ›ç ´è§£å°è¯•` | çŸ­æ—¶é—´å†…å¤§é‡å¤±è´¥å°è¯• | `<3æ¬¡/åˆ†é’Ÿ` | `>10æ¬¡/åˆ†é’Ÿ` |

### 2.3 æŒ‡æ ‡ç›‘æ§å®ç°


**ç®€å•çš„æŒ‡æ ‡é‡‡é›†ç¤ºä¾‹**ï¼š

```java
@Component
public class OAuth2MetricsCollector {
    
    @Autowired
    private MeterRegistry meterRegistry;
    
    // è®°å½•Tokenç­¾å‘
    public void recordTokenIssued(String grantType) {
        meterRegistry.counter("oauth2.token.issued", 
            "grant_type", grantType).increment();
    }
    
    // è®°å½•è®¤è¯å¤±è´¥
    public void recordAuthFailure(String reason) {
        meterRegistry.counter("oauth2.auth.failure",
            "reason", reason).increment();
    }
    
    // è®°å½•å“åº”æ—¶é—´
    public void recordResponseTime(long milliseconds) {
        meterRegistry.timer("oauth2.response.time")
            .record(milliseconds, TimeUnit.MILLISECONDS);
    }
}
```

**åœ¨è®¤è¯æœåŠ¡ä¸­ä½¿ç”¨**ï¼š

```java
@Service
public class AuthenticationService {
    
    @Autowired
    private OAuth2MetricsCollector metrics;
    
    public TokenResponse authenticate(LoginRequest request) {
        long startTime = System.currentTimeMillis();
        
        try {
            // æ‰§è¡Œè®¤è¯é€»è¾‘
            TokenResponse response = doAuthenticate(request);
            
            // è®°å½•æˆåŠŸæŒ‡æ ‡
            metrics.recordTokenIssued(request.getGrantType());
            
            return response;
            
        } catch (AuthenticationException e) {
            // è®°å½•å¤±è´¥æŒ‡æ ‡
            metrics.recordAuthFailure(e.getReason());
            throw e;
            
        } finally {
            // è®°å½•å“åº”æ—¶é—´
            long duration = System.currentTimeMillis() - startTime;
            metrics.recordResponseTime(duration);
        }
    }
}
```

---

## 3. ğŸ« Tokenä½¿ç”¨ç»Ÿè®¡


### 3.1 Tokenç”Ÿå‘½å‘¨æœŸç›‘æ§


**Tokençš„ä¸€ç”Ÿ**ï¼š
```
ğŸ“ Tokenç”Ÿå‘½å‘¨æœŸè¿½è¸ª

ç­¾å‘é˜¶æ®µ                ä½¿ç”¨é˜¶æ®µ                å¤±æ•ˆé˜¶æ®µ
   â†“                      â†“                      â†“
[åˆ›å»ºToken]  â†’  [é¦–æ¬¡ä½¿ç”¨]  â†’  [æ­£å¸¸ä½¿ç”¨]  â†’  [è¿‡æœŸ/æ’¤é”€]
   |              |              |              |
 è®°å½•åˆ›å»ºæ—¶é—´    è®°å½•æ¿€æ´»æ—¶é—´   ç»Ÿè®¡ä½¿ç”¨æ¬¡æ•°   è®°å½•å¤±æ•ˆåŸå› 
 è®°å½•æˆæƒèŒƒå›´    è®°å½•ä½¿ç”¨IP    ç›‘æ§è®¿é—®é¢‘ç‡   åˆ†æTokenå¯¿å‘½
```

### 3.2 éœ€è¦ç»Ÿè®¡çš„Tokenæ•°æ®


**ğŸ”¸ Tokenç­¾å‘ç»Ÿè®¡**

```java
@Component
public class TokenStatistics {
    
    // Tokenç­¾å‘æŒ‰æˆæƒç±»å‹ç»Ÿè®¡
    public Map<String, Long> getTokenIssuedByGrantType() {
        /*
         * è¿”å›ç¤ºä¾‹ï¼š
         * {
         *   "authorization_code": 1500,  // æˆæƒç æ¨¡å¼æœ€å¤š
         *   "client_credentials": 800,   // å®¢æˆ·ç«¯æ¨¡å¼æ¬¡ä¹‹
         *   "password": 200,             // å¯†ç æ¨¡å¼è¾ƒå°‘
         *   "refresh_token": 500         // åˆ·æ–°Tokenä½¿ç”¨
         * }
         */
    }
    
    // Tokenç­¾å‘æŒ‰æ—¶é—´åˆ†å¸ƒ
    public Map<String, Long> getTokenIssuedByHour() {
        /*
         * å‘ç°ä½¿ç”¨è§„å¾‹ï¼š
         * 09:00-11:00  é«˜å³°æœŸï¼ˆä¸Šç­æ—¶é—´ï¼‰
         * 14:00-16:00  é«˜å³°æœŸï¼ˆä¸‹åˆåŠå…¬ï¼‰
         * 02:00-06:00  ä½è°·æœŸï¼ˆå‡Œæ™¨æ—¶æ®µï¼‰
         */
    }
}
```

**ğŸ”¸ Tokenä½¿ç”¨è¡Œä¸ºåˆ†æ**

| ç›‘æ§ç»´åº¦ | è¯´æ˜ | å¼‚å¸¸åˆ¤æ–­æ ‡å‡† |
|---------|------|------------|
| `ä½¿ç”¨é¢‘ç‡` | Tokenè¢«ä½¿ç”¨çš„æ¬¡æ•°/æ—¶é—´ | æé«˜é¢‘ï¼ˆ>100æ¬¡/åˆ†é’Ÿï¼‰æˆ–é•¿æœŸä¸ç”¨ |
| `ä½¿ç”¨IP` | Tokenä½¿ç”¨çš„æ¥æºIP | IPåœ°å€é¢‘ç¹å˜åŒ–æˆ–æ¥è‡ªå¼‚å¸¸åœ°åŒº |
| `è®¿é—®èµ„æº` | Tokenè®¿é—®çš„APIç«¯ç‚¹ | è®¿é—®æœªæˆæƒçš„èµ„æº |
| `Tokenå¯¿å‘½` | ä»ç­¾å‘åˆ°å¤±æ•ˆçš„æ—¶é•¿ | è¿œè¶…é¢„æœŸå¯¿å‘½ï¼ˆå¯èƒ½æ³„éœ²ï¼‰ |

**æ£€æµ‹Tokenå¼‚å¸¸ä½¿ç”¨**ï¼š

```java
@Service
public class TokenAnomalyDetector {
    
    // æ£€æµ‹Tokenä½¿ç”¨å¼‚å¸¸
    public boolean detectAnomalous(String token, String currentIp) {
        TokenUsageRecord record = getTokenRecord(token);
        
        // ğŸš¨ å¼‚å¸¸1ï¼šIPåœ°å€çªå˜
        if (!currentIp.equals(record.getLastUsedIp())) {
            String lastIpLocation = getIpLocation(record.getLastUsedIp());
            String currentIpLocation = getIpLocation(currentIp);
            
            // å¦‚æœIPåœ°ç†ä½ç½®ç›¸å·®å¤ªè¿œï¼ˆæ¯”å¦‚ä»åŒ—äº¬å˜åˆ°ç¾å›½ï¼‰
            if (isFarAway(lastIpLocation, currentIpLocation)) {
                alertTokenIpAnomaly(token);
                return true;
            }
        }
        
        // ğŸš¨ å¼‚å¸¸2ï¼šä½¿ç”¨é¢‘ç‡çªå¢
        long recentUsage = record.getUsageInLastMinute();
        if (recentUsage > 100) {  // 1åˆ†é’Ÿè¶…è¿‡100æ¬¡
            alertHighFrequency(token);
            return true;
        }
        
        // ğŸš¨ å¼‚å¸¸3ï¼šè®¿é—®æœªæˆæƒèµ„æº
        if (!record.getScopes().contains(getCurrentScope())) {
            alertUnauthorizedAccess(token);
            return true;
        }
        
        return false;
    }
}
```

### 3.3 Tokenä½¿ç”¨å¯è§†åŒ–


**Tokenä½¿ç”¨çƒ­åŠ›å›¾**ï¼š
```
ğŸ“Š 24å°æ—¶Tokenä½¿ç”¨çƒ­åŠ›å›¾ï¼ˆé¢œè‰²æ·±æµ…è¡¨ç¤ºä½¿ç”¨é‡ï¼‰

æ—¶æ®µ    00-04  04-08  08-12  12-16  16-20  20-24
å‘¨ä¸€    â–‘â–‘â–‘â–‘   â–‘â–‘â–‘â–‘   â–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–‘   â–ˆâ–ˆâ–ˆâ–ˆ   â–‘â–‘â–‘â–‘
å‘¨äºŒ    â–‘â–‘â–‘â–‘   â–‘â–‘â–‘â–‘   â–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–‘   â–ˆâ–ˆâ–ˆâ–ˆ   â–‘â–‘â–‘â–‘
å‘¨ä¸‰    â–‘â–‘â–‘â–‘   â–‘â–‘â–‘â–‘   â–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–‘   â–ˆâ–ˆâ–ˆâ–ˆ   â–‘â–‘â–‘â–‘
å‘¨å››    â–‘â–‘â–‘â–‘   â–‘â–‘â–‘â–‘   â–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–‘   â–ˆâ–ˆâ–ˆâ–ˆ   â–‘â–‘â–‘â–‘
å‘¨äº”    â–‘â–‘â–‘â–‘   â–‘â–‘â–‘â–‘   â–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–‘   â–ˆâ–ˆâ–‘â–‘   â–‘â–‘â–‘â–‘
å‘¨å…­    â–‘â–‘â–‘â–‘   â–‘â–‘â–‘â–‘   â–‘â–‘â–‘â–‘   â–‘â–‘â–‘â–‘   â–‘â–‘â–‘â–‘   â–‘â–‘â–‘â–‘
å‘¨æ—¥    â–‘â–‘â–‘â–‘   â–‘â–‘â–‘â–‘   â–‘â–‘â–‘â–‘   â–‘â–‘â–‘â–‘   â–‘â–‘â–‘â–‘   â–‘â–‘â–‘â–‘

å‘ç°è§„å¾‹ï¼šå·¥ä½œæ—¥9-18ç‚¹æ˜¯é«˜å³°æœŸï¼Œå‘¨æœ«ä½¿ç”¨é‡å¾ˆä½
```

---

## 4. âš ï¸ é”™è¯¯ç‡ç›‘æ§


### 4.1 é”™è¯¯åˆ†ç±»ä¸ç»Ÿè®¡


**OAuth2.0å¸¸è§é”™è¯¯ç±»å‹**ï¼š

```
ğŸ”´ è®¤è¯æˆæƒé”™è¯¯åˆ†ç±»

å®¢æˆ·ç«¯é”™è¯¯ï¼ˆ4xxï¼‰               æœåŠ¡ç«¯é”™è¯¯ï¼ˆ5xxï¼‰
     |                              |
  â”Œâ”€â”€â”´â”€â”€â”                        â”Œâ”€â”€â”´â”€â”€â”
  |     |                        |     |
è®¤è¯å¤±è´¥ æˆæƒå¤±è´¥              ç³»ç»Ÿæ•…éšœ ä¾èµ–å¼‚å¸¸
  |     |                        |     |
å¯†ç é”™è¯¯ æƒé™ä¸è¶³              æ•°æ®åº“è¿æ¥å¤±è´¥ Rediså¼‚å¸¸
Tokenè¿‡æœŸ éæ³•scope            TokenæœåŠ¡å®•æœº  ç½‘ç»œè¶…æ—¶
```

**é”™è¯¯ç ç»Ÿè®¡è¡¨**ï¼š

| é”™è¯¯ç  | é”™è¯¯å«ä¹‰ | å¸¸è§åŸå›  | æ­£å¸¸å æ¯” | å‘Šè­¦é˜ˆå€¼ |
|-------|---------|---------|---------|---------|
| `invalid_grant` | æˆæƒæ— æ•ˆ | å¯†ç é”™è¯¯ã€æˆæƒç è¿‡æœŸ | `<2%` | `>5%` |
| `invalid_token` | Tokenæ— æ•ˆ | Tokenè¿‡æœŸã€è¢«æ’¤é”€ | `<3%` | `>8%` |
| `insufficient_scope` | æƒé™ä¸è¶³ | è®¿é—®æœªæˆæƒèµ„æº | `<1%` | `>3%` |
| `server_error` | æœåŠ¡å™¨é”™è¯¯ | ç³»ç»Ÿæ•…éšœ | `<0.1%` | `>1%` |

### 4.2 é”™è¯¯ç‡ç›‘æ§å®ç°


**é”™è¯¯ç»Ÿè®¡æ”¶é›†å™¨**ï¼š

```java
@Component
public class OAuth2ErrorCollector {
    
    @Autowired
    private MeterRegistry registry;
    
    // è®°å½•é”™è¯¯
    public void recordError(OAuth2Error error) {
        // æŒ‰é”™è¯¯ç ç»Ÿè®¡
        registry.counter("oauth2.error", 
            "code", error.getErrorCode(),
            "type", error.getType()).increment();
    }
    
    // è®¡ç®—é”™è¯¯ç‡
    public double calculateErrorRate(String errorCode) {
        double totalRequests = getTotalRequests();
        double errorCount = getErrorCount(errorCode);
        
        return (errorCount / totalRequests) * 100;
    }
    
    // è·å–é”™è¯¯è¶‹åŠ¿
    public List<ErrorTrend> getErrorTrend(String errorCode, int hours) {
        /*
         * è¿”å›æœ€è¿‘Nå°æ—¶çš„é”™è¯¯è¶‹åŠ¿
         * å¸®åŠ©è¯†åˆ«é”™è¯¯ç‡æ˜¯å¦åœ¨ä¸Šå‡
         */
    }
}
```

**é”™è¯¯ç‡å‘Šè­¦åˆ¤æ–­**ï¼š

```java
@Service
public class ErrorRateAlertService {
    
    // æ£€æŸ¥é”™è¯¯ç‡æ˜¯å¦å¼‚å¸¸
    public void checkErrorRate() {
        Map<String, Double> errorRates = calculateAllErrorRates();
        
        for (Map.Entry<String, Double> entry : errorRates.entrySet()) {
            String errorCode = entry.getKey();
            Double rate = entry.getValue();
            
            // æ ¹æ®ä¸åŒé”™è¯¯ç è®¾ç½®ä¸åŒé˜ˆå€¼
            if (isAbnormal(errorCode, rate)) {
                sendAlert(errorCode, rate);
            }
        }
    }
    
    private boolean isAbnormal(String errorCode, double rate) {
        // invalid_grantï¼ˆè®¤è¯å¤±è´¥ï¼‰æ­£å¸¸<2%ï¼Œè¶…è¿‡5%å‘Šè­¦
        if ("invalid_grant".equals(errorCode)) {
            return rate > 5.0;
        }
        
        // server_errorï¼ˆç³»ç»Ÿé”™è¯¯ï¼‰æ­£å¸¸<0.1%ï¼Œè¶…è¿‡1%å‘Šè­¦
        if ("server_error".equals(errorCode)) {
            return rate > 1.0;
        }
        
        return false;
    }
}
```

### 4.3 é”™è¯¯æ ¹å› åˆ†æ


**é”™è¯¯å…³è”åˆ†æ**ï¼š
```
ğŸ” é”™è¯¯æ ¹å› è¿½è¸ªé“¾è·¯

ç”¨æˆ·è®¤è¯å¤±è´¥
    â†“
æŸ¥çœ‹é”™è¯¯è¯¦æƒ…ï¼šinvalid_grant
    â†“
æ£€æŸ¥æœ€è¿‘1å°æ—¶è¶‹åŠ¿ï¼šé”™è¯¯ç‡ä»2%å‡åˆ°15%
    â†“
æŒ‰IPåœ°å€åˆ†ç»„ï¼šå‘ç°90%æ¥è‡ªåŒä¸€IP
    â†“
ç»“è®ºï¼šå¯èƒ½æ˜¯æš´åŠ›ç ´è§£æ”»å‡»
    â†“
å¤„ç†ï¼šå°ç¦è¯¥IPï¼Œå¢å¼ºé˜²æŠ¤
```

---

## 5. âš¡ å“åº”æ—¶é—´åˆ†æ


### 5.1 å“åº”æ—¶é—´çš„é‡è¦æ€§


**å“åº”æ—¶é—´å½±å“ç”¨æˆ·ä½“éªŒ**ï¼š
```
ğŸ¯ å“åº”æ—¶é—´æ„ŸçŸ¥æ ‡å‡†

< 100ms    ç”¨æˆ·æ„Ÿè§‰å³æ—¶å“åº”ï¼Œä½“éªŒä¼˜ç§€
100-300ms  ç¨æœ‰å»¶è¿Ÿï¼Œä½†å¯æ¥å—
300-1000ms æ˜æ˜¾å»¶è¿Ÿï¼Œç”¨æˆ·å¼€å§‹ä¸è€çƒ¦  
> 1000ms   ä¸¥é‡å»¶è¿Ÿï¼Œç”¨æˆ·å¯èƒ½æ”¾å¼ƒæ“ä½œ
> 3000ms   è¶…æ—¶ï¼Œç”¨æˆ·ä½“éªŒæå·®
```

### 5.2 å“åº”æ—¶é—´ç›‘æ§ç»´åº¦


**ğŸ”¸ æŒ‰æ¥å£ç±»å‹åˆ†ç±»**

| æ¥å£ç±»å‹ | æ­£å¸¸å“åº”æ—¶é—´ | è¯´æ˜ |
|---------|------------|------|
| `è·å–Tokenæ¥å£` | `<200ms` | æœ€å¸¸ç”¨ï¼Œå¿…é¡»å¿«é€Ÿå“åº” |
| `TokenéªŒè¯æ¥å£` | `<50ms` | æ¯æ¬¡APIè°ƒç”¨éƒ½è¦éªŒè¯ï¼Œè¦æå¿« |
| `Tokenåˆ·æ–°æ¥å£` | `<100ms` | ç”¨æˆ·æ„ŸçŸ¥æ˜æ˜¾ï¼Œéœ€è¦ä¼˜åŒ– |
| `æˆæƒé¡µé¢æ¸²æŸ“` | `<500ms` | æ¶‰åŠé¡µé¢æ¸²æŸ“ï¼Œå¯ç¨æ…¢ |

**ğŸ”¸ æŒ‰æ—¶é—´æ®µåˆ†æ**

```
ğŸ“ˆ ä¸åŒæ—¶æ®µçš„å“åº”æ—¶é—´å¯¹æ¯”

å‡Œæ™¨ï¼ˆ00:00-06:00ï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å¹³å‡50ms   âœ… ç³»ç»Ÿç©ºé—²ï¼Œå“åº”å¿«

ä¸Šåˆé«˜å³°ï¼ˆ09:00-11:00ï¼‰  
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ å¹³å‡180ms  âš ï¸  è´Ÿè½½å¢åŠ ï¼Œéœ€å…³æ³¨

åˆé—´ï¼ˆ12:00-14:00ï¼‰
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”€â”€â”€â”€â”€â”€ å¹³å‡120ms  âœ… è´Ÿè½½é™ä½

ä¸‹åˆé«˜å³°ï¼ˆ14:00-18:00ï¼‰
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ å¹³å‡200ms âš ï¸  æ¥è¿‘å‘Šè­¦é˜ˆå€¼

æ™šé—´ï¼ˆ18:00-24:00ï¼‰
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”€â”€â”€â”€â”€â”€ å¹³å‡100ms  âœ… é€æ­¥æ¢å¤æ­£å¸¸
```

### 5.3 å“åº”æ—¶é—´ä¼˜åŒ–


**æ€§èƒ½ç“¶é¢ˆå®šä½**ï¼š

```java
@Aspect
@Component
public class ResponseTimeAnalyzer {
    
    @Around("@annotation(OAuth2Endpoint)")
    public Object analyzeResponseTime(ProceedingJoinPoint pjp) {
        long startTime = System.currentTimeMillis();
        
        // è®°å½•å„é˜¶æ®µè€—æ—¶
        Map<String, Long> stages = new LinkedHashMap<>();
        
        try {
            // 1. å‚æ•°éªŒè¯é˜¶æ®µ
            long validateStart = System.currentTimeMillis();
            validateParameters(pjp.getArgs());
            stages.put("å‚æ•°éªŒè¯", System.currentTimeMillis() - validateStart);
            
            // 2. æ•°æ®åº“æŸ¥è¯¢é˜¶æ®µ
            long dbStart = System.currentTimeMillis();
            Object result = pjp.proceed();
            stages.put("æ•°æ®åº“æŸ¥è¯¢", System.currentTimeMillis() - dbStart);
            
            // 3. Tokenç”Ÿæˆé˜¶æ®µ
            long tokenStart = System.currentTimeMillis();
            // Tokenç”Ÿæˆé€»è¾‘
            stages.put("Tokenç”Ÿæˆ", System.currentTimeMillis() - tokenStart);
            
            return result;
            
        } finally {
            long totalTime = System.currentTimeMillis() - startTime;
            
            // åˆ†æå“ªä¸ªé˜¶æ®µæœ€è€—æ—¶
            analyzeBottleneck(stages, totalTime);
        }
    }
    
    private void analyzeBottleneck(Map<String, Long> stages, long total) {
        /*
         * è¾“å‡ºç¤ºä¾‹ï¼š
         * æ€»è€—æ—¶ï¼š250ms
         * - å‚æ•°éªŒè¯ï¼š5ms (2%)
         * - æ•°æ®åº“æŸ¥è¯¢ï¼š180ms (72%)  â† ç“¶é¢ˆåœ¨è¿™é‡Œï¼
         * - Tokenç”Ÿæˆï¼š65ms (26%)
         * 
         * ä¼˜åŒ–å»ºè®®ï¼šæ·»åŠ æ•°æ®åº“æŸ¥è¯¢ç¼“å­˜
         */
    }
}
```

---

## 6. ğŸš€ å¹¶å‘é‡ç›‘æ§


### 6.1 å¹¶å‘é‡çš„å«ä¹‰


**ä»€ä¹ˆæ˜¯å¹¶å‘é‡**ï¼š
```
ğŸ¯ é€šä¿—ç†è§£å¹¶å‘

æƒ³è±¡ä¸€ä¸ªå¥¶èŒ¶åº—ï¼š
â€¢ QPS = æ¯ç§’èƒ½åšå¤šå°‘æ¯å¥¶èŒ¶
â€¢ å¹¶å‘é‡ = åŒæ—¶æœ‰å¤šå°‘äººåœ¨æ’é˜Ÿç‚¹å•
â€¢ å“åº”æ—¶é—´ = åšä¸€æ¯å¥¶èŒ¶éœ€è¦å¤šé•¿æ—¶é—´

OAuth2.0ç³»ç»Ÿï¼š
â€¢ QPS = æ¯ç§’å¤„ç†å¤šå°‘ä¸ªTokenè¯·æ±‚
â€¢ å¹¶å‘é‡ = åŒæ—¶æœ‰å¤šå°‘ä¸ªè¯·æ±‚åœ¨å¤„ç†
â€¢ å“åº”æ—¶é—´ = å¤„ç†ä¸€ä¸ªè¯·æ±‚éœ€è¦å¤šé•¿æ—¶é—´
```

### 6.2 å¹¶å‘é‡ç›‘æ§æŒ‡æ ‡


**ğŸ”¸ å…³é”®å¹¶å‘æŒ‡æ ‡**

| æŒ‡æ ‡ | å«ä¹‰ | ç›‘æ§ç›®çš„ |
|-----|------|---------|
| `å½“å‰å¹¶å‘æ•°` | æ­£åœ¨å¤„ç†çš„è¯·æ±‚æ•°é‡ | äº†è§£å®æ—¶è´Ÿè½½ |
| `æœ€å¤§å¹¶å‘æ•°` | å†å²æœ€é«˜å¹¶å‘è®°å½• | å®¹é‡è§„åˆ’å‚è€ƒ |
| `å¹³å‡å¹¶å‘æ•°` | ä¸€æ®µæ—¶é—´å†…çš„å¹³å‡å¹¶å‘ | è¯„ä¼°ç³»ç»Ÿè´Ÿè½½ |
| `å¹¶å‘å³°å€¼æ—¶æ®µ` | å¹¶å‘é‡æœ€é«˜çš„æ—¶é—´æ®µ | ä¼˜åŒ–èµ„æºè°ƒåº¦ |

**å¹¶å‘é‡ä¸ç³»ç»Ÿå®¹é‡å…³ç³»**ï¼š
```
ğŸ“Š ç³»ç»Ÿå®¹é‡è¯„ä¼°

è®¾è®¡å®¹é‡ï¼š1000å¹¶å‘
     â†“
å½“å‰å¹¶å‘ï¼š800å¹¶å‘  (80%è´Ÿè½½) âš ï¸  æ¥è¿‘ä¸Šé™
     â†“
å»ºè®®ï¼šæ‰©å®¹æˆ–ä¼˜åŒ–ï¼Œä¿æŒå®‰å…¨è¾¹é™…
```

### 6.3 å¹¶å‘æ§åˆ¶å®ç°


**é™æµä¿æŠ¤æœºåˆ¶**ï¼š

```java
@Component
public class ConcurrentLimiter {
    
    // ä½¿ç”¨ä¿¡å·é‡æ§åˆ¶å¹¶å‘
    private final Semaphore semaphore;
    
    public ConcurrentLimiter() {
        // æœ€å¤šå…è®¸1000ä¸ªå¹¶å‘è¯·æ±‚
        this.semaphore = new Semaphore(1000);
    }
    
    @Around("@annotation(OAuth2Endpoint)")
    public Object limitConcurrent(ProceedingJoinPoint pjp) throws Throwable {
        
        // å°è¯•è·å–è®¸å¯
        boolean acquired = semaphore.tryAcquire(100, TimeUnit.MILLISECONDS);
        
        if (!acquired) {
            // å¹¶å‘é‡å·²æ»¡ï¼Œæ‹’ç»è¯·æ±‚
            throw new TooManyConcurrentRequestsException(
                "ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•"
            );
        }
        
        try {
            // è®°å½•å½“å‰å¹¶å‘æ•°
            int currentConcurrent = 1000 - semaphore.availablePermits();
            recordConcurrent(currentConcurrent);
            
            // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
            return pjp.proceed();
            
        } finally {
            // é‡Šæ”¾è®¸å¯
            semaphore.release();
        }
    }
}
```

---

## 7. ğŸ”§ ç›‘æ§å·¥å…·é›†æˆ


### 7.1 ä¸»æµç›‘æ§å·¥å…·å¯¹æ¯”


**å·¥å…·é€‰å‹å‚è€ƒ**ï¼š

| å·¥å…· | ä¼˜åŠ¿ | é€‚ç”¨åœºæ™¯ | å­¦ä¹ æˆæœ¬ |
|-----|------|---------|---------|
| **Prometheus + Grafana** | å¼€æºå…è´¹ï¼ŒåŠŸèƒ½å¼ºå¤§ | ä¸­å¤§å‹é¡¹ç›® | ä¸­ç­‰ |
| **Spring Boot Actuator** | ä¸Springæ— ç¼é›†æˆ | Springé¡¹ç›® | ä½ |
| **ELK Stack** | æ—¥å¿—åˆ†æèƒ½åŠ›å¼º | éœ€è¦è¯¦ç»†æ—¥å¿—åˆ†æ | è¾ƒé«˜ |
| **Zipkin/Skywalking** | é“¾è·¯è¿½è¸ªèƒ½åŠ›å¼º | å¾®æœåŠ¡æ¶æ„ | ä¸­ç­‰ |

### 7.2 Prometheusé›†æˆç¤ºä¾‹


**ç¬¬ä¸€æ­¥ï¼šæ·»åŠ ä¾èµ–**

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
<dependency>
    <groupId>io.micrometer</groupId>
    <artifactId>micrometer-registry-prometheus</artifactId>
</dependency>
```

**ç¬¬äºŒæ­¥ï¼šé…ç½®æš´éœ²æŒ‡æ ‡**

```yaml
# application.yml
management:
  endpoints:
    web:
      exposure:
        include: prometheus,health,metrics
  metrics:
    tags:
      application: oauth2-server  # ç»™æ‰€æœ‰æŒ‡æ ‡æ‰“æ ‡ç­¾
```

**ç¬¬ä¸‰æ­¥ï¼šè‡ªå®šä¹‰OAuth2æŒ‡æ ‡**

```java
@Component
public class OAuth2PrometheusMetrics {
    
    private final Counter tokenIssuedCounter;
    private final Counter authFailureCounter;
    private final Timer responseTimeTimer;
    
    public OAuth2PrometheusMetrics(MeterRegistry registry) {
        // Tokenç­¾å‘è®¡æ•°å™¨
        this.tokenIssuedCounter = Counter.builder("oauth2_token_issued_total")
            .description("OAuth2 tokenç­¾å‘æ€»æ•°")
            .tag("grant_type", "all")
            .register(registry);
            
        // è®¤è¯å¤±è´¥è®¡æ•°å™¨
        this.authFailureCounter = Counter.builder("oauth2_auth_failure_total")
            .description("è®¤è¯å¤±è´¥æ€»æ•°")
            .register(registry);
            
        // å“åº”æ—¶é—´è®¡æ—¶å™¨
        this.responseTimeTimer = Timer.builder("oauth2_response_time")
            .description("OAuth2è¯·æ±‚å“åº”æ—¶é—´")
            .register(registry);
    }
}
```

**PrometheusæŸ¥è¯¢ç¤ºä¾‹**ï¼š
```promql
# æŸ¥è¯¢æœ€è¿‘5åˆ†é’Ÿçš„Tokenç­¾å‘é€Ÿç‡
rate(oauth2_token_issued_total[5m])

# æŸ¥è¯¢P99å“åº”æ—¶é—´
histogram_quantile(0.99, oauth2_response_time_bucket)

# æŸ¥è¯¢é”™è¯¯ç‡
rate(oauth2_auth_failure_total[5m]) / rate(oauth2_request_total[5m])
```

### 7.3 Grafanaä»ªè¡¨ç›˜é…ç½®


**OAuth2.0ç›‘æ§å¤§å±å¸ƒå±€**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          OAuth2.0 è®¤è¯æœåŠ¡ç›‘æ§å¤§å±           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚  ğŸ“Š å®æ—¶æ¦‚è§ˆ                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚QPS  â”‚  â”‚é”™è¯¯ç‡â”‚  â”‚P99  â”‚  â”‚å¹¶å‘ â”‚       â”‚
â”‚  â”‚1,234â”‚  â”‚0.5% â”‚  â”‚180msâ”‚  â”‚ 456 â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                             â”‚
â”‚  ğŸ“ˆ Tokenç­¾å‘è¶‹åŠ¿ï¼ˆæœ€è¿‘24å°æ—¶ï¼‰              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚      /\     /\          /\          â”‚   â”‚
â”‚  â”‚     /  \   /  \    /\  /  \         â”‚   â”‚
â”‚  â”‚____/____\_/____\__/  \/____\_______â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                             â”‚
â”‚  âš ï¸  é”™è¯¯ç‡åˆ†æ                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ invalid_grantâ”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘  3.2%    â”‚   â”‚
â”‚  â”‚ invalid_tokenâ”‚ â–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  1.5%    â”‚   â”‚
â”‚  â”‚ server_error â”‚ â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  0.1%    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                             â”‚
â”‚  ğŸŒ åœ°ç†åˆ†å¸ƒï¼ˆTokenä½¿ç”¨æ¥æºï¼‰                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   [å…¨çƒåœ°å›¾ï¼Œæ ‡æ³¨è®¿é—®çƒ­ç‚¹åŒºåŸŸ]       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. ğŸš¨ å‘Šè­¦æœºåˆ¶è®¾ç½®


### 8.1 å‘Šè­¦ç­–ç•¥è®¾è®¡


**å‘Šè­¦çº§åˆ«å®šä¹‰**ï¼š

```
ğŸ”´ P0çº§å‘Šè­¦ï¼ˆç´§æ€¥ï¼‰         ç«‹å³å¤„ç†ï¼Œ5åˆ†é’Ÿå“åº”
â€¢ è®¤è¯æœåŠ¡å®Œå…¨ä¸å¯ç”¨
â€¢ é”™è¯¯ç‡è¶…è¿‡50%
â€¢ ç³»ç»Ÿå®•æœº

ğŸŸ  P1çº§å‘Šè­¦ï¼ˆé‡è¦ï¼‰         30åˆ†é’Ÿå†…å¤„ç†
â€¢ é”™è¯¯ç‡è¶…è¿‡10%
â€¢ P99å“åº”æ—¶é—´>1ç§’
â€¢ å¹¶å‘è¾¾åˆ°90%å®¹é‡

ğŸŸ¡ P2çº§å‘Šè­¦ï¼ˆä¸€èˆ¬ï¼‰         2å°æ—¶å†…å¤„ç†
â€¢ é”™è¯¯ç‡è¶…è¿‡5%
â€¢ P99å“åº”æ—¶é—´>500ms
â€¢ å‘ç°å¯ç–‘æ”»å‡»è¡Œä¸º

ğŸŸ¢ P3çº§å‘Šè­¦ï¼ˆæç¤ºï¼‰         å·¥ä½œæ—¶é—´å¤„ç†
â€¢ æ€§èƒ½è½»å¾®ä¸‹é™
â€¢ éå…³é”®åŠŸèƒ½å¼‚å¸¸
```

### 8.2 å‘Šè­¦è§„åˆ™é…ç½®


**Prometheuså‘Šè­¦è§„åˆ™ç¤ºä¾‹**ï¼š

```yaml
groups:
  - name: oauth2_alerts
    interval: 30s
    rules:
      # P0ï¼šè®¤è¯æœåŠ¡ä¸å¯ç”¨
      - alert: OAuth2ServiceDown
        expr: up{job="oauth2-server"} == 0
        for: 1m
        labels:
          severity: critical
          priority: P0
        annotations:
          summary: "OAuth2è®¤è¯æœåŠ¡å®•æœº"
          description: "è®¤è¯æœåŠ¡å·²å®•æœºè¶…è¿‡1åˆ†é’Ÿ"
      
      # P1ï¼šé”™è¯¯ç‡è¿‡é«˜
      - alert: HighErrorRate
        expr: |
          rate(oauth2_auth_failure_total[5m]) 
          / rate(oauth2_request_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          priority: P1
        annotations:
          summary: "OAuth2é”™è¯¯ç‡è¿‡é«˜"
          description: "æœ€è¿‘5åˆ†é’Ÿé”™è¯¯ç‡è¶…è¿‡10%"
      
      # P1ï¼šå“åº”æ—¶é—´è¿‡é•¿
      - alert: SlowResponse
        expr: |
          histogram_quantile(0.99, 
            oauth2_response_time_bucket) > 1
        for: 5m
        labels:
          severity: warning
          priority: P1
        annotations:
          summary: "OAuth2å“åº”æ—¶é—´è¿‡é•¿"
          description: "P99å“åº”æ—¶é—´è¶…è¿‡1ç§’"
```

### 8.3 å‘Šè­¦é€šçŸ¥é…ç½®


**å¤šæ¸ é“å‘Šè­¦é€šçŸ¥**ï¼š

```java
@Service
public class AlertNotificationService {
    
    // å‘é€å‘Šè­¦
    public void sendAlert(Alert alert) {
        // æ ¹æ®å‘Šè­¦çº§åˆ«é€‰æ‹©é€šçŸ¥æ–¹å¼
        switch (alert.getPriority()) {
            case "P0":
                // ç´§æ€¥ï¼šçŸ­ä¿¡ + ç”µè¯ + ä¼ä¸šå¾®ä¿¡
                sendSMS(alert);
                makePhoneCall(alert);
                sendToWeChat(alert);
                break;
                
            case "P1":
                // é‡è¦ï¼šä¼ä¸šå¾®ä¿¡ + é‚®ä»¶
                sendToWeChat(alert);
                sendEmail(alert);
                break;
                
            case "P2":
                // ä¸€èˆ¬ï¼šä¼ä¸šå¾®ä¿¡
                sendToWeChat(alert);
                break;
                
            case "P3":
                // æç¤ºï¼šåªè®°å½•æ—¥å¿—
                logAlert(alert);
                break;
        }
    }
    
    // å‘Šè­¦é™å™ªï¼šé¿å…å‘Šè­¦è½°ç‚¸
    public boolean shouldSendAlert(Alert alert) {
        // ç›¸åŒå‘Šè­¦5åˆ†é’Ÿå†…åªå‘é€ä¸€æ¬¡
        String key = alert.getType() + ":" + alert.getTarget();
        Long lastTime = alertCache.get(key);
        
        if (lastTime != null && 
            System.currentTimeMillis() - lastTime < 5 * 60 * 1000) {
            return false;  // 5åˆ†é’Ÿå†…å·²å‘é€ï¼Œè·³è¿‡
        }
        
        alertCache.put(key, System.currentTimeMillis());
        return true;
    }
}
```

**å‘Šè­¦æ¶ˆæ¯æ¨¡æ¿**ï¼š
```
ğŸš¨ OAuth2å‘Šè­¦é€šçŸ¥

å‘Šè­¦çº§åˆ«ï¼šP1ï¼ˆé‡è¦ï¼‰
å‘Šè­¦é¡¹ç›®ï¼šOAuth2è®¤è¯æœåŠ¡
å‘Šè­¦å†…å®¹ï¼šé”™è¯¯ç‡è¿‡é«˜

è¯¦ç»†ä¿¡æ¯ï¼š
â€¢ å½“å‰é”™è¯¯ç‡ï¼š12.5%ï¼ˆæ­£å¸¸<5%ï¼‰
â€¢ å½±å“èŒƒå›´ï¼šæ‰€æœ‰ç”¨æˆ·ç™»å½•
â€¢ æŒç»­æ—¶é—´ï¼šæœ€è¿‘5åˆ†é’Ÿ
â€¢ ä¸»è¦é”™è¯¯ï¼šinvalid_grant (89%)

å»ºè®®æªæ–½ï¼š
1. æ£€æŸ¥æ•°æ®åº“è¿æ¥
2. æŸ¥çœ‹è¿‘æœŸä»£ç å˜æ›´
3. æ£€æŸ¥æ˜¯å¦æœ‰æ”»å‡»è¡Œä¸º

æŸ¥çœ‹è¯¦æƒ…ï¼šhttp://monitor.example.com/oauth2
```

---

## 9. ğŸ› ï¸ æ•…éšœå¤„ç†å®è·µ


### 9.1 å¸¸è§æ•…éšœåœºæ™¯


**ğŸ”¸ åœºæ™¯1ï¼šTokenç­¾å‘çªç„¶å¤±è´¥**

```
æ•…éšœç°è±¡ï¼š
[12:30] Tokenç­¾å‘æˆåŠŸç‡ä»99%éª¤é™åˆ°20%
[12:31] é”™è¯¯ç ï¼šserver_error
[12:32] å‘Šè­¦ï¼šæ•°æ®åº“è¿æ¥è¶…æ—¶

æ’æŸ¥æ­¥éª¤ï¼š
1. æŸ¥çœ‹ç›‘æ§ â†’ å‘ç°æ•°æ®åº“è¿æ¥æ± è€—å°½
2. æ£€æŸ¥æ…¢SQL â†’ å‘ç°ä¸€ä¸ªæœªåŠ ç´¢å¼•çš„æŸ¥è¯¢
3. æŸ¥çœ‹æ—¥å¿— â†’ æŸä¸ªå®šæ—¶ä»»åŠ¡åœ¨æ‰§è¡Œå¤§é‡æŸ¥è¯¢
4. ä¸´æ—¶æ–¹æ¡ˆ â†’ åœæ­¢è¯¥å®šæ—¶ä»»åŠ¡
5. é•¿æœŸæ–¹æ¡ˆ â†’ ä¼˜åŒ–SQLï¼Œæ·»åŠ ç´¢å¼•

å¤„ç†æ—¶é—´ï¼š8åˆ†é’Ÿæ¢å¤
```

**ğŸ”¸ åœºæ™¯2ï¼šå“åº”æ—¶é—´çªç„¶å˜æ…¢**

```
æ•…éšœç°è±¡ï¼š
[14:00] P99å“åº”æ—¶é—´ä»100mså‡åˆ°2ç§’
[14:05] ç”¨æˆ·æŠ•è¯‰ç™»å½•ç¼“æ…¢
[14:08] å¹¶å‘é‡æ­£å¸¸ï¼Œæ— æ˜æ˜¾æµé‡å¢é•¿

æ’æŸ¥æ­¥éª¤ï¼š
1. æŸ¥çœ‹å“åº”æ—¶é—´åˆ†å¸ƒ â†’ Tokenç”Ÿæˆé˜¶æ®µæœ€æ…¢
2. æ£€æŸ¥Tokenç”Ÿæˆé€»è¾‘ â†’ è°ƒç”¨å¤–éƒ¨ç­¾åæœåŠ¡
3. æµ‹è¯•å¤–éƒ¨æœåŠ¡ â†’ å‘ç°è¯¥æœåŠ¡å“åº”æ…¢
4. ä¸´æ—¶æ–¹æ¡ˆ â†’ åˆ‡æ¢åˆ°å¤‡ç”¨ç­¾åæœåŠ¡
5. é•¿æœŸæ–¹æ¡ˆ â†’ å®ç°æœ¬åœ°ç­¾åï¼Œä¸ä¾èµ–å¤–éƒ¨

å¤„ç†æ—¶é—´ï¼š15åˆ†é’Ÿæ¢å¤
```

### 9.2 æ•…éšœå¤„ç†æµç¨‹


**æ ‡å‡†å¤„ç†æµç¨‹å›¾**ï¼š
```
å‘ç°æ•…éšœ
    â†“
[1åˆ†é’Ÿ] ç¡®è®¤å½±å“èŒƒå›´
    â†“
[3åˆ†é’Ÿ] å®šä½æ ¹æœ¬åŸå› 
    â†“
[5åˆ†é’Ÿ] å®æ–½ä¸´æ—¶æ–¹æ¡ˆï¼ˆæ¢å¤æœåŠ¡ï¼‰
    â†“
[10åˆ†é’Ÿ] éªŒè¯æ¢å¤æ•ˆæœ
    â†“
[30åˆ†é’Ÿ] åˆ¶å®šé•¿æœŸæ–¹æ¡ˆ
    â†“
[1å¤©] å¤ç›˜æ€»ç»“ï¼Œæ›´æ–°è¿ç»´æ–‡æ¡£
```

### 9.3 æ•…éšœé¢„æ¡ˆ


**æå‰å‡†å¤‡åº”æ€¥é¢„æ¡ˆ**ï¼š

| æ•…éšœç±»å‹ | ä¸´æ—¶å¤„ç†æ–¹æ¡ˆ | é•¿æœŸä¼˜åŒ–æ–¹æ¡ˆ |
|---------|------------|------------|
| `æ•°æ®åº“æ•…éšœ` | åˆ‡æ¢åˆ°ä»åº“/ç¼“å­˜é™çº§ | å®ç°è¯»å†™åˆ†ç¦»ã€ä¸»ä»åˆ‡æ¢ |
| `Redisæ•…éšœ` | é™çº§åˆ°æ•°æ®åº“ | Redisé›†ç¾¤éƒ¨ç½² |
| `æµé‡æ¿€å¢` | å¯åŠ¨é™æµã€ç†”æ–­ | æ‰©å®¹ã€CDNåŠ é€Ÿ |
| `ä»£ç BUG` | å¿«é€Ÿå›æ»šåˆ°ä¸Šä¸ªç‰ˆæœ¬ | åŠ å¼ºæµ‹è¯•ã€ç°åº¦å‘å¸ƒ |
| `å¤–éƒ¨ä¾èµ–æ•…éšœ` | ä½¿ç”¨æœ¬åœ°ç¼“å­˜/é™çº§ | å¤šæ´»å®¹ç¾ã€å¤‡ç”¨æ–¹æ¡ˆ |

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„ç›‘æ§æŒ‡æ ‡


```
ğŸ¯ æ ¸å¿ƒç›‘æ§æŒ‡æ ‡é€ŸæŸ¥è¡¨

å¯ç”¨æ€§å±‚é¢ï¼š
âœ… è®¤è¯æœåŠ¡å¯ç”¨ç‡ >99.9%
âœ… æˆæƒæˆåŠŸç‡ >95%

æ€§èƒ½å±‚é¢ï¼š
âš¡ å¹³å‡å“åº”æ—¶é—´ <100ms
âš¡ P99å“åº”æ—¶é—´ <500ms
âš¡ QPSï¼ˆæ ¹æ®ä¸šåŠ¡ï¼‰

å®‰å…¨å±‚é¢ï¼š
ğŸ”’ è®¤è¯å¤±è´¥ç‡ <5%
ğŸ”’ å¼‚å¸¸IPè®¿é—®ç›‘æ§
ğŸ”’ Tokenæ³„éœ²æ£€æµ‹

å®¹é‡å±‚é¢ï¼š
ğŸ“Š å½“å‰å¹¶å‘æ•°
ğŸ“Š ç³»ç»Ÿå®¹é‡ä½¿ç”¨ç‡ <80%
```

### 10.2 ç›‘æ§ä½“ç³»å»ºè®¾æ­¥éª¤


```
ğŸ“ Step 1ï¼šæŒ‡æ ‡é‡‡é›†ï¼ˆç¬¬1å‘¨ï¼‰
â€¢ é›†æˆPrometheus/Actuator
â€¢ å®šä¹‰æ ¸å¿ƒä¸šåŠ¡æŒ‡æ ‡
â€¢ å®ç°æŒ‡æ ‡é‡‡é›†ä»£ç 

ğŸ“ Step 2ï¼šå¯è§†åŒ–å±•ç¤ºï¼ˆç¬¬2å‘¨ï¼‰
â€¢ æ­å»ºGrafanaç›‘æ§å¤§å±
â€¢ é…ç½®å…³é”®æŒ‡æ ‡å›¾è¡¨
â€¢ è®¾ç½®å®æ—¶åˆ·æ–°

ğŸ“ Step 3ï¼šå‘Šè­¦é…ç½®ï¼ˆç¬¬3å‘¨ï¼‰
â€¢ å®šä¹‰å‘Šè­¦è§„åˆ™
â€¢ é…ç½®å‘Šè­¦çº§åˆ«
â€¢ æ¥å…¥é€šçŸ¥æ¸ é“

ğŸ“ Step 4ï¼šä¼˜åŒ–è¿­ä»£ï¼ˆæŒç»­ï¼‰
â€¢ æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´é˜ˆå€¼
â€¢ ä¼˜åŒ–å‘Šè­¦é™å™ª
â€¢ å®Œå–„æ•…éšœé¢„æ¡ˆ
```

### 10.3 æœ€ä½³å®è·µå»ºè®®


**âœ… åšä»€ä¹ˆ**ï¼š
- ç›‘æ§è¦**å…¨é¢**ï¼šè¦†ç›–æ€§èƒ½ã€å®‰å…¨ã€ä¸šåŠ¡å„ç»´åº¦
- å‘Šè­¦è¦**ç²¾å‡†**ï¼šå‡å°‘è¯¯æŠ¥ï¼Œç¡®ä¿æ¯ä¸ªå‘Šè­¦éƒ½æœ‰æ„ä¹‰
- å“åº”è¦**å¿«é€Ÿ**ï¼šP0å‘Šè­¦5åˆ†é’Ÿå“åº”ï¼ŒP1å‘Šè­¦30åˆ†é’Ÿå“åº”
- é¢„æ¡ˆè¦**å……åˆ†**ï¼šæå‰å‡†å¤‡å¸¸è§æ•…éšœçš„å¤„ç†æ–¹æ¡ˆ

**âŒ ä¸è¦ä»€ä¹ˆ**ï¼š
- ä¸è¦åªçœ‹è¡¨é¢æŒ‡æ ‡ï¼Œè¦å…³æ³¨ä¸šåŠ¡å½±å“
- ä¸è¦å‘Šè­¦ç–²åŠ³ï¼Œé¿å…å‘Šè­¦è½°ç‚¸
- ä¸è¦ä¸´æ—¶æŠ±ä½›è„šï¼Œè¦æå‰åšå¥½å®¹é‡è§„åˆ’
- ä¸è¦å¿½è§†å°é—®é¢˜ï¼Œå°é—®é¢˜å¯èƒ½é…¿æˆå¤§æ•…éšœ

### 10.4 è®°å¿†å£è¯€


```
ğŸ“ OAuth2ç›‘æ§è®°å¿†å£è¯€

æŒ‡æ ‡å…¨é¢ä¸‰ç»´åº¦ï¼šæ€§èƒ½å®‰å…¨åŠ å¯ç”¨
Tokenç»Ÿè®¡è¦è¯¦ç»†ï¼šç­¾å‘ä½¿ç”¨å’Œå¤±æ•ˆ
é”™è¯¯åˆ†ç±»è¦æ¸…æ¥šï¼šå®¢æˆ·æœåŠ¡åˆ†ä¸¤ç±»
å“åº”æ—¶é—´å®šç›®æ ‡ï¼šç™¾æ¯«ç§’å†…ç”¨æˆ·æ»¡æ„
å¹¶å‘æ§åˆ¶æœ‰ä¸Šé™ï¼šè¶…è¿‡å®¹é‡è¦é™æµ
ç›‘æ§å·¥å…·é€‰åˆé€‚ï¼šPrometheusåŠ Grafana
å‘Šè­¦åˆ†çº§è¦æ˜ç¡®ï¼šP0ç´§æ€¥P3æç¤º
æ•…éšœå¤„ç†æœ‰æµç¨‹ï¼šå¿«é€Ÿå®šä½å¿«æ¢å¤
```

**ğŸ¯ å­¦ä¹ æ£€æŸ¥æ¸…å•**ï¼š
- â˜‘ ç†è§£OAuth2.0æ ¸å¿ƒç›‘æ§æŒ‡æ ‡
- â˜‘ æŒæ¡Tokenä½¿ç”¨ç»Ÿè®¡æ–¹æ³•
- â˜‘ ä¼šé…ç½®é”™è¯¯ç‡ç›‘æ§å’Œå‘Šè­¦
- â˜‘ èƒ½åˆ†æå“åº”æ—¶é—´ç“¶é¢ˆ
- â˜‘ æ‡‚å¾—è®¾ç½®å¹¶å‘æ§åˆ¶
- â˜‘ ä¼šé›†æˆPrometheusç›‘æ§
- â˜‘ èƒ½è®¾è®¡åˆç†çš„å‘Šè­¦ç­–ç•¥
- â˜‘ æŒæ¡å¸¸è§æ•…éšœå¤„ç†æ–¹æ³•