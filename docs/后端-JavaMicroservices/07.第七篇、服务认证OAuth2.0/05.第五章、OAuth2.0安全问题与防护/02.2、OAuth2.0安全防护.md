---
title: 2ã€OAuth2.0å®‰å…¨é˜²æŠ¤
---
## ğŸ“š ç›®å½•

1. [OAuth2.0å®‰å…¨é—®é¢˜æ¦‚è¿°](#1-oauth20å®‰å…¨é—®é¢˜æ¦‚è¿°)
2. [HTTPSå¼ºåˆ¶ä¼ è¾“](#2-httpså¼ºåˆ¶ä¼ è¾“)
3. [PKCEé˜²æŠ¤æœºåˆ¶](#3-pkceé˜²æŠ¤æœºåˆ¶)
4. [Stateå‚æ•°é˜²æŠ¤](#4-stateå‚æ•°é˜²æŠ¤)
5. [Tokenæ—¶æ•ˆä¸åˆ·æ–°ç­–ç•¥](#5-tokenæ—¶æ•ˆä¸åˆ·æ–°ç­–ç•¥)
6. [CORSè·¨åŸŸå®‰å…¨æ§åˆ¶](#6-corsè·¨åŸŸå®‰å…¨æ§åˆ¶)
7. [å®‰å…¨å­˜å‚¨ç­–ç•¥](#7-å®‰å…¨å­˜å‚¨ç­–ç•¥)
8. [ç»¼åˆé˜²æŠ¤æœ€ä½³å®è·µ](#8-ç»¼åˆé˜²æŠ¤æœ€ä½³å®è·µ)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” OAuth2.0å®‰å…¨é—®é¢˜æ¦‚è¿°


### 1.1 ä¸ºä»€ä¹ˆéœ€è¦å®‰å…¨é˜²æŠ¤


**ç°å®åœºæ™¯ç†è§£**ï¼š
```
æƒ³è±¡ä½ å»é“¶è¡Œå–é’±ï¼š
æ™®é€šæ–¹å¼ï¼šç›´æ¥å‘Šè¯‰æŸœå‘˜"æˆ‘æ˜¯å¼ ä¸‰ï¼Œç»™æˆ‘å–é’±"
å®‰å…¨æ–¹å¼ï¼šå‡ºç¤ºèº«ä»½è¯ + å¯†ç  + äººè„¸è¯†åˆ«

OAuth2.0ä¹Ÿæ˜¯ä¸€æ ·ï¼š
ä¸å®‰å…¨ï¼šç›´æ¥ä¼ è¾“tokenï¼Œä»»ä½•äººéƒ½èƒ½ç”¨
å®‰å…¨ï¼šåŠ å¯†ä¼ è¾“ + é˜²ç¯¡æ”¹ + æ—¶æ•ˆæ§åˆ¶
```

**OAuth2.0é¢ä¸´çš„ä¸»è¦å¨èƒ**ï¼š

| å¨èƒç±»å‹ | ç®€å•è§£é‡Š | å®é™…å½±å“ |
|---------|---------|---------|
| **tokenåŠ«æŒ** | åˆ«äººå·èµ°äº†ä½ çš„ä»¤ç‰Œ | å†’å……ä½ çš„èº«ä»½è®¿é—®èµ„æº |
| **é‡æ”¾æ”»å‡»** | åˆ«äººå½•ä¸‹ä½ çš„è¯·æ±‚é‡å¤ä½¿ç”¨ | å¤šæ¬¡æ‰§è¡ŒåŒä¸€æ“ä½œ |
| **CSRFæ”»å‡»** | è¯±å¯¼ä½ ç‚¹å‡»æ¶æ„é“¾æ¥ | åœ¨ä½ ä¸çŸ¥æƒ…æ—¶æˆæƒ |
| **ä¸­é—´äººæ”»å‡»** | ç½‘ç»œä¼ è¾“è¢«ç›‘å¬ | æ•æ„Ÿä¿¡æ¯æ³„éœ² |
| **å®¢æˆ·ç«¯æ³„éœ²** | å‰ç«¯ä»£ç æš´éœ²ç§˜é’¥ | ä»»ä½•äººéƒ½èƒ½ä¼ªé€ è¯·æ±‚ |

### 1.2 å®‰å…¨é˜²æŠ¤çš„æ ¸å¿ƒæ€è·¯


```
é˜²æŠ¤ä¸‰åŸåˆ™ï¼š

1ï¸âƒ£ ä¼ è¾“å®‰å…¨ï¼šæ•°æ®åœ¨ç½‘ç»œä¸Šä¼ è¾“æ—¶ä¸è¢«çªƒå–
   â””â”€ è§£å†³æ–¹æ¡ˆï¼šHTTPSåŠ å¯†

2ï¸âƒ£ èº«ä»½éªŒè¯ï¼šç¡®è®¤è¯·æ±‚è€…æ˜¯åˆæ³•çš„
   â””â”€ è§£å†³æ–¹æ¡ˆï¼šStateå‚æ•°ã€PKCE

3ï¸âƒ£ æƒé™é™åˆ¶ï¼šå³ä½¿è¢«ç›—ç”¨ï¼ŒæŸå¤±ä¹Ÿæœ€å°
   â””â”€ è§£å†³æ–¹æ¡ˆï¼šçŸ­æ—¶æ•ˆtokenã€æƒé™èŒƒå›´æ§åˆ¶
```

---

## 2. ğŸ”’ HTTPSå¼ºåˆ¶ä¼ è¾“


### 2.1 ä»€ä¹ˆæ˜¯HTTPSå¼ºåˆ¶ä¼ è¾“


**é€šä¿—ç†è§£**ï¼š
```
HTTPä¼ è¾“ï¼š
ä½  â”€[æ˜æ–‡:å¯†ç 123]â”€> æœåŠ¡å™¨
     â†‘
   é»‘å®¢èƒ½çœ‹åˆ°

HTTPSä¼ è¾“ï¼š
ä½  â”€[åŠ å¯†:@#$%^&]â”€> æœåŠ¡å™¨
     â†‘
   é»‘å®¢çœ‹ä¸æ‡‚
```

**HTTPSçš„ä½œç”¨**ï¼š
- ğŸ”¸ **åŠ å¯†ä¼ è¾“**ï¼šæ‰€æœ‰æ•°æ®éƒ½è¢«åŠ å¯†ï¼Œåˆ«äººæˆªè·ä¹Ÿçœ‹ä¸æ‡‚
- ğŸ”¸ **èº«ä»½éªŒè¯**ï¼šç¡®è®¤æœåŠ¡å™¨æ˜¯çœŸçš„ï¼Œä¸æ˜¯å‡å†’çš„
- ğŸ”¸ **é˜²ç¯¡æ”¹**ï¼šæ•°æ®åœ¨ä¼ è¾“ä¸­è¢«ä¿®æ”¹ä¼šè¢«å‘ç°

### 2.2 ä¸ºä»€ä¹ˆOAuth2å¿…é¡»ç”¨HTTPS


**å±é™©ç¤ºä¾‹ï¼ˆä½¿ç”¨HTTPï¼‰**ï¼š
```
1. ä½ è®¿é—®ï¼šhttp://auth.com/oauth/authorize?client_id=xxx
2. é»‘å®¢æˆªè·ç½‘ç»œæ•°æ®ï¼Œçœ‹åˆ°ï¼š
   - client_idï¼ˆåº”ç”¨æ ‡è¯†ï¼‰
   - redirect_uriï¼ˆå›è°ƒåœ°å€ï¼‰
   - response_typeï¼ˆæˆæƒç±»å‹ï¼‰
3. æˆæƒåè¿”å›ï¼šhttp://yourapp.com?code=abc123
4. é»‘å®¢çœ‹åˆ°äº†codeï¼Œé©¬ä¸Šå»æ¢token
5. ä½ çš„è´¦å·è¢«ç›—äº†ï¼
```

**å®‰å…¨ç¤ºä¾‹ï¼ˆä½¿ç”¨HTTPSï¼‰**ï¼š
```
1. ä½ è®¿é—®ï¼šhttps://auth.com/oauth/authorize?client_id=xxx
2. é»‘å®¢æˆªè·ç½‘ç»œæ•°æ®ï¼Œçœ‹åˆ°çš„æ˜¯ï¼š
   - TLSåŠ å¯†æ•°æ®åŒ…ï¼š%E2%9C%93%$#@...
   - å®Œå…¨çœ‹ä¸æ‡‚å†…å®¹
3. å³ä½¿æˆªè·ä¹Ÿæ— æ³•ä½¿ç”¨
```

### 2.3 å®æ–½HTTPSçš„æ–¹æ³•


**Spring Booté…ç½®ç¤ºä¾‹**ï¼š
```java
@Configuration
public class SecurityConfig {
    
    // å¼ºåˆ¶ä½¿ç”¨HTTPS
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) {
        http
            // è¦æ±‚æ‰€æœ‰è¯·æ±‚ä½¿ç”¨HTTPS
            .requiresChannel()
            .anyRequest()
            .requiresSecure()
            
            // OAuth2ç›¸å…³ç«¯ç‚¹å¿…é¡»HTTPS
            .and()
            .oauth2Login()
            .authorizationEndpoint()
            .baseUri("https://auth.example.com/oauth2/authorize");
        
        return http.build();
    }
}
```

**é…ç½®æ–‡ä»¶è®¾ç½®**ï¼š
```yaml
server:
  port: 8443
  ssl:
    enabled: true
    key-store: classpath:keystore.p12
    key-store-password: yourpassword
    key-store-type: PKCS12

# OAuth2ç«¯ç‚¹å¿…é¡»HTTPS
spring:
  security:
    oauth2:
      client:
        provider:
          my-provider:
            authorization-uri: https://auth.example.com/authorize
            token-uri: https://auth.example.com/token
```

### 2.4 å¼€å‘ç¯å¢ƒçš„HTTPSé…ç½®


ğŸ’¡ **å®ç”¨æŠ€å·§**ï¼š
```
å¼€å‘ç¯å¢ƒHTTPSæ–¹æ¡ˆï¼š

æ–¹æ¡ˆ1ï¼šè‡ªç­¾åè¯ä¹¦ï¼ˆæµ‹è¯•ç”¨ï¼‰
keytool -genkeypair -alias myapp \
  -keyalg RSA -keysize 2048 \
  -storetype PKCS12 -keystore keystore.p12

æ–¹æ¡ˆ2ï¼šLet's Encryptå…è´¹è¯ä¹¦ï¼ˆç”Ÿäº§ç”¨ï¼‰
certbot certonly --standalone -d yourdomain.com

æ–¹æ¡ˆ3ï¼šä½¿ç”¨Nginxåå‘ä»£ç†
å‰ç«¯è®¿é—®ï¼šhttps://localhost
Nginxè½¬å‘ï¼šhttp://backend:8080
```

---

## 3. ğŸ›¡ï¸ PKCEé˜²æŠ¤æœºåˆ¶


### 3.1 ä»€ä¹ˆæ˜¯PKCE


**PKCEå…¨ç§°**ï¼šProof Key for Code Exchangeï¼ˆæˆæƒç äº¤æ¢çš„è¯æ˜å¯†é’¥ï¼‰

**é€šä¿—ç†è§£**ï¼š
```
æ²¡æœ‰PKCEçš„æƒ…å†µï¼š
ä½ å»é“¶è¡Œå–é’±ï¼ŒæŸœå‘˜è¯´ï¼š"å‘Šè¯‰æˆ‘ä½ çš„è´¦å·ï¼Œæˆ‘ç»™ä½ é’±"
é—®é¢˜ï¼šä»»ä½•äººçŸ¥é“è´¦å·éƒ½èƒ½å–é’±

æœ‰PKCEçš„æƒ…å†µï¼š
ä½ å»é“¶è¡Œå–é’±ï¼ŒæŸœå‘˜è¯´ï¼š"å…ˆç»™æˆ‘ä¸€ä¸ªæš—å·ï¼Œå–é’±æ—¶å¯¹ä¸Šæš—å·æ‰ç»™"
ä¼˜åŠ¿ï¼šåªæœ‰ä½ è‡ªå·±çŸ¥é“æš—å·ï¼Œåˆ«äººæ‹¿åˆ°è´¦å·ä¹Ÿå–ä¸äº†é’±
```

### 3.2 PKCEè§£å†³ä»€ä¹ˆé—®é¢˜


**æ”»å‡»åœºæ™¯ï¼ˆæ— PKCEï¼‰**ï¼š
```
æ­£å¸¸æµç¨‹ï¼š
1. Appè¯·æ±‚æˆæƒ â†’ è·å¾—code=abc123
2. Appç”¨codeæ¢token â†’ è·å¾—è®¿é—®æƒé™

è¢«æ”»å‡»æ—¶ï¼š
1. æ¶æ„Appæ‹¦æˆªåˆ°code=abc123
2. æ¶æ„AppæŠ¢å…ˆç”¨codeæ¢token
3. çœŸæ­£çš„Appå†ç”¨codeæ—¶å·²å¤±æ•ˆ
4. ç”¨æˆ·è´¦å·è¢«ç›—ï¼
```

**PKCEé˜²æŠ¤æµç¨‹**ï¼š
```
Appç”Ÿæˆéšæœºå¯†é’¥ï¼š
code_verifier = "éšæœºå­—ç¬¦ä¸²dK0mL3pQ..."

è®¡ç®—æŒ‘æˆ˜ç ï¼š
code_challenge = SHA256(code_verifier)
              = "åŠ å¯†åçš„å€¼rR5tY..."

è¯·æ±‚æˆæƒæ—¶ï¼š
/authorize?code_challenge=rR5tY&code_challenge_method=S256

æ¢tokenæ—¶ï¼š
/token?code=abc123&code_verifier=dK0mL3pQ...

æœåŠ¡å™¨éªŒè¯ï¼š
SHA256(æ”¶åˆ°çš„code_verifier) == ä¹‹å‰çš„code_challenge ?
å¯¹ä¸Šäº†æ‰ç»™tokenï¼
```

### 3.3 PKCEå®ç°ä»£ç 


**å®¢æˆ·ç«¯ç”ŸæˆPKCEå‚æ•°**ï¼š
```java
public class PKCEGenerator {
    
    // ç”ŸæˆéšæœºéªŒè¯ç 
    public static String generateCodeVerifier() {
        SecureRandom random = new SecureRandom();
        byte[] bytes = new byte[32];
        random.nextBytes(bytes);
        // Base64 URLç¼–ç ï¼ˆä¸å«+/=ç­‰ç‰¹æ®Šå­—ç¬¦ï¼‰
        return Base64.getUrlEncoder()
            .withoutPadding()
            .encodeToString(bytes);
    }
    
    // ç”ŸæˆæŒ‘æˆ˜ç 
    public static String generateCodeChallenge(String verifier) {
        try {
            MessageDigest digest = MessageDigest.getInstance("SHA-256");
            byte[] hash = digest.digest(verifier.getBytes());
            return Base64.getUrlEncoder()
                .withoutPadding()
                .encodeToString(hash);
        } catch (Exception e) {
            throw new RuntimeException("ç”ŸæˆæŒ‘æˆ˜ç å¤±è´¥", e);
        }
    }
}
```

**ä½¿ç”¨PKCEè¯·æ±‚æˆæƒ**ï¼š
```java
// 1. ç”Ÿæˆå¹¶ä¿å­˜verifier
String verifier = PKCEGenerator.generateCodeVerifier();
session.setAttribute("code_verifier", verifier);

// 2. ç”Ÿæˆchallenge
String challenge = PKCEGenerator.generateCodeChallenge(verifier);

// 3. æ„å»ºæˆæƒURL
String authUrl = "https://auth.example.com/authorize?" +
    "client_id=myapp&" +
    "redirect_uri=https://myapp.com/callback&" +
    "response_type=code&" +
    "code_challenge=" + challenge + "&" +
    "code_challenge_method=S256";

// 4. æ¢tokenæ—¶å¸¦ä¸Šverifier
String verifier = session.getAttribute("code_verifier");
String tokenRequest = "grant_type=authorization_code&" +
    "code=" + code + "&" +
    "code_verifier=" + verifier;
```

### 3.4 PKCEæœ€ä½³å®è·µ


âš ï¸ **é‡è¦æ³¨æ„äº‹é¡¹**ï¼š

```
âœ… æ¨èåšæ³•ï¼š
- code_verifieré•¿åº¦ï¼š43-128ä¸ªå­—ç¬¦
- ä½¿ç”¨SHA-256ç®—æ³•ç”Ÿæˆchallenge
- verifierç”¨å®Œç«‹å³é”€æ¯
- æ¯æ¬¡æˆæƒéƒ½ç”Ÿæˆæ–°çš„verifier

âŒ é”™è¯¯åšæ³•ï¼š
- ä½¿ç”¨å›ºå®šçš„verifier
- verifierå¤ªçŸ­ï¼ˆå®¹æ˜“è¢«çŒœæµ‹ï¼‰
- æ˜æ–‡ä¼ è¾“verifier
- challengeå’Œverifieræ··ç”¨
```

---

## 4. ğŸ¯ Stateå‚æ•°é˜²æŠ¤


### 4.1 ä»€ä¹ˆæ˜¯Stateå‚æ•°


**Stateå‚æ•°**ï¼šä¸€ä¸ªéšæœºå­—ç¬¦ä¸²ï¼Œç”¨äºé˜²æ­¢CSRFæ”»å‡»

**é€šä¿—ç†è§£**ï¼š
```
æ²¡æœ‰Stateçš„æƒ…å†µï¼š
é»‘å®¢å‘ç»™ä½ ä¸€ä¸ªé“¾æ¥ï¼š"ç‚¹è¿™é‡Œé¢†çº¢åŒ…"
ä½ ç‚¹äº† â†’ å®é™…æ˜¯æˆæƒç»™äº†é»‘å®¢çš„åº”ç”¨
ä½ çš„è´¦å·è¢«ç›—äº†ï¼

æœ‰Stateçš„æƒ…å†µï¼š
ä½ çš„åº”ç”¨ç”Ÿæˆéšæœºç ï¼šstate=xyz789
æˆæƒæ—¶å¸¦ä¸Šï¼š/authorize?state=xyz789
å›è°ƒæ—¶æ£€æŸ¥ï¼šè¿”å›çš„stateè¿˜æ˜¯xyz789å—ï¼Ÿ
å¯¹ä¸ä¸Šè¯´æ˜è¢«ç¯¡æ”¹äº†ï¼
```

### 4.2 CSRFæ”»å‡»åŸç†


**æ”»å‡»åœºæ™¯æ¼”ç¤º**ï¼š
```
1. é»‘å®¢å‡†å¤‡æ¶æ„é“¾æ¥ï¼š
   https://auth.com/authorize?
   client_id=é»‘å®¢çš„åº”ç”¨&
   redirect_uri=https://hacker.com/callback

2. è¯±å¯¼ä½ ç‚¹å‡»è¿™ä¸ªé“¾æ¥

3. ä½ åœ¨ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹æˆæƒäº†é»‘å®¢çš„åº”ç”¨

4. é»‘å®¢è·å¾—äº†è®¿é—®ä½ èµ„æºçš„æƒé™

æµç¨‹å›¾ï¼š
ä½ çš„æµè§ˆå™¨              æˆæƒæœåŠ¡å™¨              é»‘å®¢æœåŠ¡å™¨
    |                      |                      |
    |â†â”€[è¯±å¯¼é“¾æ¥]â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€|                      |é»‘å®¢
    |                      |                      |
    |â”€[ç‚¹å‡»æˆæƒ]â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’|                      |
    |                      |                      |
    |                      |â†[æˆæƒæˆåŠŸcode]â”€â”€â”€â”€â”€â”€â”€|
    |                      |                      |
    X ä½ è¢«ç›—å·äº†ï¼          |                    ğŸ˜ˆ é»‘å®¢å¾—æ‰‹
```

### 4.3 Stateå‚æ•°é˜²æŠ¤å®ç°


**ç”Ÿæˆå’ŒéªŒè¯State**ï¼š
```java
public class StateValidator {
    
    // ç”ŸæˆStateå‚æ•°
    public static String generateState() {
        return UUID.randomUUID().toString();
    }
    
    // è¯·æ±‚æˆæƒæ—¶
    public String authorize(HttpSession session) {
        // 1. ç”Ÿæˆstateå¹¶ä¿å­˜
        String state = generateState();
        session.setAttribute("oauth_state", state);
        
        // 2. æ„å»ºæˆæƒURL
        return "https://auth.example.com/authorize?" +
            "client_id=myapp&" +
            "redirect_uri=https://myapp.com/callback&" +
            "response_type=code&" +
            "state=" + state;  // å¸¦ä¸Šstate
    }
    
    // å›è°ƒæ—¶éªŒè¯
    public boolean validateCallback(
        String returnedState, 
        HttpSession session
    ) {
        // å–å‡ºä¹‹å‰ä¿å­˜çš„state
        String savedState = session.getAttribute("oauth_state");
        
        // éªŒè¯æ˜¯å¦ä¸€è‡´
        if (savedState == null || !savedState.equals(returnedState)) {
            throw new SecurityException("Stateå‚æ•°éªŒè¯å¤±è´¥ï¼Œå¯èƒ½é­å—CSRFæ”»å‡»ï¼");
        }
        
        // éªŒè¯é€šè¿‡åç«‹å³åˆ é™¤ï¼Œé˜²æ­¢é‡å¤ä½¿ç”¨
        session.removeAttribute("oauth_state");
        return true;
    }
}
```

**å®Œæ•´é˜²æŠ¤æµç¨‹**ï¼š
```java
@RestController
public class OAuth2Controller {
    
    // å‘èµ·æˆæƒ
    @GetMapping("/oauth/login")
    public void login(HttpServletResponse response, HttpSession session) {
        // 1. ç”Ÿæˆstate
        String state = UUID.randomUUID().toString();
        session.setAttribute("oauth_state", state);
        
        // 2. é‡å®šå‘åˆ°æˆæƒé¡µé¢
        String authUrl = buildAuthUrl(state);
        response.sendRedirect(authUrl);
    }
    
    // å¤„ç†å›è°ƒ
    @GetMapping("/oauth/callback")
    public String callback(
        @RequestParam String code,
        @RequestParam String state,
        HttpSession session
    ) {
        // 1. éªŒè¯state
        String savedState = session.getAttribute("oauth_state");
        if (!state.equals(savedState)) {
            return "error: CSRFæ”»å‡»æ£€æµ‹";
        }
        
        // 2. stateç”¨å®Œåˆ é™¤
        session.removeAttribute("oauth_state");
        
        // 3. ç”¨codeæ¢token
        String token = exchangeToken(code);
        return "success: " + token;
    }
}
```

### 4.4 Stateå‚æ•°å¢å¼ºç‰ˆ


ğŸ’¡ **é«˜çº§æŠ€å·§**ï¼š
```java
// æºå¸¦é¢å¤–ä¿¡æ¯çš„State
public class EnhancedState {
    
    public static String generateState(String userId, String deviceId) {
        // ç»„åˆä¿¡æ¯
        String data = userId + "|" + deviceId + "|" + 
                      System.currentTimeMillis();
        
        // åŠ å¯†ï¼ˆé˜²æ­¢è¢«ç¯¡æ”¹ï¼‰
        String encrypted = AES.encrypt(data, SECRET_KEY);
        
        // Base64ç¼–ç 
        return Base64.getUrlEncoder().encodeToString(encrypted);
    }
    
    public static StateInfo parseState(String state) {
        // è§£å¯†å’Œè§£æ
        String decrypted = AES.decrypt(
            Base64.getUrlDecoder().decode(state), 
            SECRET_KEY
        );
        
        String[] parts = decrypted.split("\\|");
        
        // éªŒè¯æ—¶æ•ˆï¼ˆ10åˆ†é’Ÿå†…æœ‰æ•ˆï¼‰
        long timestamp = Long.parseLong(parts[2]);
        if (System.currentTimeMillis() - timestamp > 600000) {
            throw new SecurityException("Stateå·²è¿‡æœŸ");
        }
        
        return new StateInfo(parts[0], parts[1]);
    }
}
```

---

## 5. â±ï¸ Tokenæ—¶æ•ˆä¸åˆ·æ–°ç­–ç•¥


### 5.1 ä¸ºä»€ä¹ˆéœ€è¦çŸ­æ—¶æ•ˆToken


**å®‰å…¨åŸç†**ï¼š
```
é•¿æœŸæœ‰æ•ˆTokençš„é—®é¢˜ï¼š
- Tokenè¢«ç›—åï¼Œé»‘å®¢å¯ä»¥é•¿æœŸä½¿ç”¨
- ç”¨æˆ·æ— æ³•åŠæ—¶æ’¤é”€æƒé™
- ä¸€æ¬¡æ³„éœ²ï¼Œæ°¸ä¹…é£é™©

çŸ­æ—¶æ•ˆTokençš„ä¼˜åŠ¿ï¼š
- Tokenè¿‡æœŸåè‡ªåŠ¨å¤±æ•ˆ
- å³ä½¿è¢«ç›—ï¼Œå½±å“æ—¶é—´æœ‰é™
- é…åˆåˆ·æ–°æœºåˆ¶ï¼Œæ—¢å®‰å…¨åˆæ–¹ä¾¿
```

**å®é™…ç±»æ¯”**ï¼š
```
é•¿æœŸToken = èº«ä»½è¯
  - æœ‰æ•ˆæœŸ10å¹´ï¼Œä¸¢äº†å¾ˆéº»çƒ¦
  - è¡¥åŠéœ€è¦å¾ˆå¤šæ‰‹ç»­

çŸ­æœŸToken = ä¸´æ—¶é€šè¡Œè¯
  - åªèƒ½ç”¨1å°æ—¶ï¼Œä¸¢äº†å½±å“å°
  - å¯ä»¥éšæ—¶ç”³è¯·æ–°çš„
```

### 5.2 Access Tokenä¸Refresh Token


**åŒTokenæœºåˆ¶**ï¼š

```
Access Tokenï¼ˆè®¿é—®ä»¤ç‰Œï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨é€”ï¼šè®¿é—®èµ„æº      â”‚
â”‚ æ—¶æ•ˆï¼š15åˆ†é’Ÿ-1å°æ—¶  â”‚
â”‚ ç‰¹ç‚¹ï¼šé¢‘ç¹ä½¿ç”¨      â”‚
â”‚ é£é™©ï¼šæš´éœ²æ¦‚ç‡é«˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Refresh Tokenï¼ˆåˆ·æ–°ä»¤ç‰Œï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨é€”ï¼šè·å–æ–°access  â”‚
â”‚ æ—¶æ•ˆï¼š7å¤©-30å¤©      â”‚
â”‚ ç‰¹ç‚¹ï¼šå¶å°”ä½¿ç”¨      â”‚
â”‚ é£é™©ï¼šæš´éœ²æ¦‚ç‡ä½    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å·¥ä½œæµç¨‹ï¼š
1. ç”¨æˆ·ç™»å½• â†’ åŒæ—¶è·å¾—ä¸¤ç§token
2. ç”¨access_tokenè®¿é—®API
3. access_tokenè¿‡æœŸ â†’ ç”¨refresh_tokenæ¢æ–°çš„
4. ç»§ç»­ä½¿ç”¨æ–°çš„access_token
5. refresh_tokenä¹Ÿè¿‡æœŸ â†’ é‡æ–°ç™»å½•
```

### 5.3 Tokenæ—¶æ•ˆé…ç½®


**Spring Securityé…ç½®**ï¼š
```java
@Configuration
public class TokenConfig {
    
    @Bean
    public TokenEnhancer tokenEnhancer() {
        return (accessToken, authentication) -> {
            Map<String, Object> info = new HashMap<>();
            
            // Access Tokenè®¾ç½®
            DefaultOAuth2AccessToken token = 
                (DefaultOAuth2AccessToken) accessToken;
            
            // 30åˆ†é’Ÿè¿‡æœŸ
            token.setExpiration(
                Date.from(Instant.now().plusSeconds(1800))
            );
            
            // Refresh Tokenè®¾ç½®ï¼ˆ7å¤©ï¼‰
            DefaultOAuth2RefreshToken refreshToken = 
                new DefaultOAuth2RefreshToken("refresh_" + UUID.randomUUID());
            refreshToken.setExpiration(
                Date.from(Instant.now().plusSeconds(604800))
            );
            token.setRefreshToken(refreshToken);
            
            return token;
        };
    }
}
```

**é…ç½®æ–‡ä»¶è®¾ç½®**ï¼š
```yaml
spring:
  security:
    oauth2:
      resourceserver:
        jwt:
          # Access Tokenæ—¶æ•ˆ
          access-token-validity-seconds: 1800  # 30åˆ†é’Ÿ
          # Refresh Tokenæ—¶æ•ˆ
          refresh-token-validity-seconds: 604800  # 7å¤©
```

### 5.4 Tokenåˆ·æ–°å®ç°


**å®¢æˆ·ç«¯åˆ·æ–°é€»è¾‘**ï¼š
```java
public class TokenRefresher {
    
    private String accessToken;
    private String refreshToken;
    private long expiresAt;
    
    // è·å–å¯ç”¨çš„token
    public String getValidToken() {
        // æ£€æŸ¥æ˜¯å¦å³å°†è¿‡æœŸï¼ˆæå‰5åˆ†é’Ÿåˆ·æ–°ï¼‰
        if (System.currentTimeMillis() > expiresAt - 300000) {
            refreshAccessToken();
        }
        return accessToken;
    }
    
    // åˆ·æ–°token
    private void refreshAccessToken() {
        RestTemplate rest = new RestTemplate();
        
        // æ„å»ºåˆ·æ–°è¯·æ±‚
        MultiValueMap<String, String> params = new LinkedMultiValueMap<>();
        params.add("grant_type", "refresh_token");
        params.add("refresh_token", refreshToken);
        params.add("client_id", "myapp");
        params.add("client_secret", "secret");
        
        // å‘é€è¯·æ±‚
        TokenResponse response = rest.postForObject(
            "https://auth.example.com/token",
            params,
            TokenResponse.class
        );
        
        // æ›´æ–°token
        this.accessToken = response.getAccessToken();
        this.expiresAt = System.currentTimeMillis() + 
                         response.getExpiresIn() * 1000;
        
        // å¦‚æœè¿”å›äº†æ–°çš„refresh_tokenä¹Ÿè¦æ›´æ–°
        if (response.getRefreshToken() != null) {
            this.refreshToken = response.getRefreshToken();
        }
    }
}
```

**è‡ªåŠ¨åˆ·æ–°æ‹¦æˆªå™¨**ï¼š
```java
@Component
public class TokenRefreshInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(
        HttpServletRequest request,
        HttpServletResponse response,
        Object handler
    ) {
        String token = request.getHeader("Authorization");
        
        // æ£€æŸ¥tokenæ˜¯å¦å¿«è¿‡æœŸ
        if (isTokenExpiringSoon(token)) {
            // è‡ªåŠ¨åˆ·æ–°
            String newToken = refreshToken(token);
            // è®¾ç½®æ–°tokenåˆ°å“åº”å¤´
            response.setHeader("X-New-Token", newToken);
        }
        
        return true;
    }
}
```

### 5.5 æ—¶æ•ˆç­–ç•¥æœ€ä½³å®è·µ


ğŸ“Š **æ¨èé…ç½®è¡¨**ï¼š

| åœºæ™¯ç±»å‹ | Access Token | Refresh Token | è¯´æ˜ |
|---------|--------------|---------------|------|
| **é«˜å®‰å…¨åº”ç”¨** | 5-15åˆ†é’Ÿ | 1-7å¤© | é“¶è¡Œã€æ”¯ä»˜ç±» |
| **æ™®é€šWebåº”ç”¨** | 30åˆ†é’Ÿ-1å°æ—¶ | 7-30å¤© | ç¤¾äº¤ã€ç”µå•† |
| **ç§»åŠ¨App** | 1-2å°æ—¶ | 30-90å¤© | ç”¨æˆ·ä½“éªŒä¼˜å…ˆ |
| **å†…éƒ¨ç³»ç»Ÿ** | 2-4å°æ—¶ | ä¸ä½¿ç”¨ | å…¬å¸å†…ç½‘ |

âš ï¸ **æ³¨æ„äº‹é¡¹**ï¼š
```
âœ… å»ºè®®ï¼š
- Access tokenå°½é‡çŸ­ï¼ˆâ‰¤1å°æ—¶ï¼‰
- Refresh tokené€‚ä¸­ï¼ˆ7-30å¤©ï¼‰
- æå‰5åˆ†é’Ÿåˆ·æ–°token
- åˆ·æ–°å¤±è´¥è¦é‡æ–°ç™»å½•

âŒ é¿å…ï¼š
- Access tokenå¤ªé•¿ï¼ˆ>4å°æ—¶ï¼‰
- Refresh tokenæ°¸ä¸è¿‡æœŸ
- è¿‡æœŸåæ‰åˆ·æ–°ï¼ˆä½“éªŒå·®ï¼‰
- æ— é™æ¬¡æ•°åˆ·æ–°refresh token
```

---

## 6. ğŸŒ CORSè·¨åŸŸå®‰å…¨æ§åˆ¶


### 6.1 ä»€ä¹ˆæ˜¯CORS


**CORSå…¨ç§°**ï¼šCross-Origin Resource Sharingï¼ˆè·¨åŸŸèµ„æºå…±äº«ï¼‰

**é€šä¿—ç†è§£**ï¼š
```
æƒ³è±¡ä½ å®¶çš„é—¨ï¼š
åŒæºè®¿é—® = å®¶äººè¿›å‡ºï¼Œéšä¾¿å¼€é—¨
è·¨åŸŸè®¿é—® = é™Œç”Ÿäººæ¥è®¿ï¼Œè¦å…ˆé—®"ä½ æ˜¯è°ï¼Ÿå¹²ä»€ä¹ˆï¼Ÿ"

æµè§ˆå™¨åŒæºç­–ç•¥ï¼š
https://myapp.com çš„é¡µé¢
åªèƒ½è®¿é—® https://myapp.com çš„æ¥å£
ä¸èƒ½è®¿é—® https://api.example.com âŒ

CORSè§£å†³æ–¹æ¡ˆï¼š
https://api.example.com æ˜ç¡®è¯´ï¼š
"å…è®¸ https://myapp.com è®¿é—®æˆ‘" âœ…
```

### 6.2 ä¸ºä»€ä¹ˆOAuth2éœ€è¦CORSæ§åˆ¶


**å®‰å…¨é—®é¢˜**ï¼š
```
æ²¡æœ‰CORSé™åˆ¶çš„å±é™©ï¼š

1. æ¶æ„ç½‘ç«™ https://evil.com
2. åµŒå…¥ä»£ç è°ƒç”¨ä½ çš„OAuth2æ¥å£
3. ç”¨æˆ·åœ¨æ¶æ„ç½‘ç«™ä¸Šç‚¹å‡»"ç™»å½•"
4. å®é™…æ˜¯æˆæƒç»™äº†æ¶æ„ç½‘ç«™
5. ç”¨æˆ·ä¿¡æ¯è¢«çªƒå–ï¼

CORSç™½åå•ä¿æŠ¤ï¼š
åªå…è®¸ä¿¡ä»»çš„åŸŸåè®¿é—®OAuth2æ¥å£
å…¶ä»–åŸŸåçš„è¯·æ±‚ç›´æ¥æ‹’ç»
```

### 6.3 CORSé…ç½®å®ç°


**Spring Bootå…¨å±€CORSé…ç½®**ï¼š
```java
@Configuration
public class CorsConfig {
    
    @Bean
    public CorsFilter corsFilter() {
        CorsConfiguration config = new CorsConfiguration();
        
        // å…è®¸çš„æºï¼ˆç™½åå•ï¼‰
        config.addAllowedOrigin("https://myapp.com");
        config.addAllowedOrigin("https://admin.myapp.com");
        
        // å…è®¸çš„HTTPæ–¹æ³•
        config.addAllowedMethod("GET");
        config.addAllowedMethod("POST");
        config.addAllowedMethod("PUT");
        config.addAllowedMethod("DELETE");
        
        // å…è®¸çš„è¯·æ±‚å¤´
        config.addAllowedHeader("Authorization");
        config.addAllowedHeader("Content-Type");
        
        // æ˜¯å¦å…è®¸æºå¸¦Cookie
        config.setAllowCredentials(true);
        
        // é¢„æ£€è¯·æ±‚ç¼“å­˜æ—¶é—´ï¼ˆç§’ï¼‰
        config.setMaxAge(3600L);
        
        UrlBasedCorsConfigurationSource source = 
            new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", config);
        
        return new CorsFilter(source);
    }
}
```

**OAuth2ç«¯ç‚¹ä¸“ç”¨CORS**ï¼š
```java
@Configuration
public class OAuth2SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) {
        http
            .cors(cors -> cors.configurationSource(request -> {
                CorsConfiguration config = new CorsConfiguration();
                
                // OAuth2ç«¯ç‚¹åªå…è®¸ç‰¹å®šåŸŸå
                if (request.getRequestURI().startsWith("/oauth2/")) {
                    config.setAllowedOrigins(Arrays.asList(
                        "https://myapp.com",
                        "https://partner.com"
                    ));
                    config.setAllowedMethods(Arrays.asList("GET", "POST"));
                }
                
                return config;
            }));
        
        return http.build();
    }
}
```

### 6.4 CORSé¢„æ£€è¯·æ±‚


**é¢„æ£€è¯·æ±‚åŸç†**ï¼š
```
æµè§ˆå™¨çš„ä¿æŠ¤æœºåˆ¶ï¼š

1. å‘é€å®é™…è¯·æ±‚å‰ï¼Œå…ˆå‘OPTIONSè¯·æ±‚è¯¢é—®
2. æœåŠ¡å™¨è¿”å›å…è®¸çš„åŸŸåã€æ–¹æ³•ã€å¤´éƒ¨
3. æµè§ˆå™¨æ£€æŸ¥æ˜¯å¦æ»¡è¶³æ¡ä»¶
4. æ»¡è¶³æ‰å‘é€çœŸæ­£çš„è¯·æ±‚

é¢„æ£€æµç¨‹ï¼š
æµè§ˆå™¨                        æœåŠ¡å™¨
   |                            |
   |â”€â”€OPTIONS /oauth/tokenâ”€â”€â†’   |
   |   Origin: https://myapp.com|
   |                            |
   |â†â”€200 OKâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  |
   |   Access-Control-Allow-Origin: https://myapp.com
   |   Access-Control-Allow-Methods: POST
   |                            |
   |â”€â”€POST /oauth/tokenâ”€â”€â”€â”€â”€â”€â†’  |ï¼ˆçœŸæ­£çš„è¯·æ±‚ï¼‰
   |                            |
```

**å¤„ç†é¢„æ£€è¯·æ±‚**ï¼š
```java
@RestController
public class OAuth2Controller {
    
    // å¤„ç†é¢„æ£€è¯·æ±‚
    @RequestMapping(
        value = "/oauth/token",
        method = RequestMethod.OPTIONS
    )
    public ResponseEntity<?> handlePreflight() {
        HttpHeaders headers = new HttpHeaders();
        headers.add("Access-Control-Allow-Origin", "https://myapp.com");
        headers.add("Access-Control-Allow-Methods", "POST");
        headers.add("Access-Control-Allow-Headers", "Authorization, Content-Type");
        headers.add("Access-Control-Max-Age", "3600");
        
        return ResponseEntity.ok().headers(headers).build();
    }
}
```

### 6.5 CORSå®‰å…¨æœ€ä½³å®è·µ


âš ï¸ **å®‰å…¨å»ºè®®**ï¼š

```
âœ… æ¨èé…ç½®ï¼š
- æ˜ç¡®åˆ—å‡ºå…è®¸çš„åŸŸåï¼ˆç™½åå•ï¼‰
- ä¸è¦ä½¿ç”¨ * é€šé…ç¬¦
- OAuth2ç«¯ç‚¹è¦å•ç‹¬é…ç½®CORS
- é™åˆ¶å…è®¸çš„HTTPæ–¹æ³•
- æ•æ„Ÿæ¥å£è¦éªŒè¯Originå¤´

âŒ å±é™©é…ç½®ï¼š
config.addAllowedOrigin("*");  // å…è®¸æ‰€æœ‰åŸŸåâŒ
config.setAllowCredentials(true);  // åŒæ—¶å…è®¸å‡­è¯âŒ
// è¿™ä¸¤ä¸ªä¸èƒ½åŒæ—¶ä½¿ç”¨ï¼

æ­£ç¡®åšæ³•ï¼š
å¦‚æœéœ€è¦æºå¸¦å‡­è¯ï¼Œå¿…é¡»æŒ‡å®šå…·ä½“åŸŸåï¼š
config.setAllowedOrigins(List.of("https://myapp.com"));
config.setAllowCredentials(true);  // âœ…
```

**åŠ¨æ€CORSé…ç½®**ï¼š
```java
@Component
public class DynamicCorsConfig {
    
    // ä»æ•°æ®åº“åŠ è½½ç™½åå•
    @Cacheable("cors-whitelist")
    public List<String> getAllowedOrigins() {
        return corsWhitelistRepository.findAll()
            .stream()
            .map(CorsWhitelist::getOrigin)
            .collect(Collectors.toList());
    }
    
    // éªŒè¯è¯·æ±‚æ¥æº
    public boolean isOriginAllowed(String origin) {
        return getAllowedOrigins().contains(origin);
    }
}
```

---

## 7. ğŸ” å®‰å…¨å­˜å‚¨ç­–ç•¥


### 7.1 Tokenå­˜å‚¨çš„å®‰å…¨é—®é¢˜


**å­˜å‚¨ä½ç½®å¯¹æ¯”**ï¼š

| å­˜å‚¨æ–¹å¼ | å®‰å…¨æ€§ | ä¾¿åˆ©æ€§ | é€‚ç”¨åœºæ™¯ |
|---------|--------|--------|---------|
| **LocalStorage** | â­â­ | â­â­â­â­â­ | ä¸æ¨è |
| **SessionStorage** | â­â­â­ | â­â­â­â­ | å•é¡µåº”ç”¨ |
| **Cookie(HttpOnly)** | â­â­â­â­ | â­â­â­ | Webåº”ç”¨ |
| **å†…å­˜å˜é‡** | â­â­â­â­â­ | â­â­ | é«˜å®‰å…¨åœºæ™¯ |

**å„æ–¹å¼è¯¦è§£**ï¼š
```
âŒ LocalStorageçš„é—®é¢˜ï¼š
- å®¹æ˜“è¢«XSSæ”»å‡»çªƒå–
- æ‰€æœ‰JSéƒ½èƒ½è®¿é—®
- æ•°æ®æ°¸ä¹…ä¿å­˜

ç¤ºä¾‹ï¼š
localStorage.setItem('token', 'xxx');
// ä»»ä½•ç¬¬ä¸‰æ–¹è„šæœ¬éƒ½èƒ½è¯»å–ï¼š
console.log(localStorage.getItem('token'));

âš ï¸ SessionStorageç¨å¥½ï¼š
- XSSä»èƒ½çªƒå–
- ä½†å…³é—­æ ‡ç­¾é¡µä¼šæ¸…é™¤

âœ… HttpOnly Cookieæœ€ä½³ï¼š
- JSæ— æ³•è®¿é—®ï¼ˆé˜²XSSï¼‰
- ä»…åœ¨HTTPè¯·æ±‚ä¸­å‘é€
- å¯è®¾ç½®Secureæ ‡å¿—ï¼ˆä»…HTTPSï¼‰

ğŸ”’ å†…å­˜å­˜å‚¨æœ€å®‰å…¨ï¼š
- ä¸æŒä¹…åŒ–ï¼Œåˆ·æ–°é¡µé¢å°±ä¸¢å¤±
- XSSæ— æ³•çªƒå–
- ä½†ç”¨æˆ·ä½“éªŒè¾ƒå·®
```

### 7.2 Cookieå­˜å‚¨å®ç°


**è®¾ç½®HttpOnly Cookie**ï¼š
```java
@RestController
public class TokenController {
    
    @PostMapping("/oauth/token")
    public ResponseEntity<?> getToken(
        @RequestBody TokenRequest request,
        HttpServletResponse response
    ) {
        // è·å–token
        String accessToken = oauthService.getToken(request);
        
        // è®¾ç½®HttpOnly Cookie
        Cookie cookie = new Cookie("access_token", accessToken);
        cookie.setHttpOnly(true);  // JSæ— æ³•è®¿é—®
        cookie.setSecure(true);    // ä»…HTTPSä¼ è¾“
        cookie.setPath("/");       // å…¨ç«™å¯ç”¨
        cookie.setMaxAge(1800);    // 30åˆ†é’Ÿè¿‡æœŸ
        cookie.setSameSite("Strict");  // é˜²CSRF
        
        response.addCookie(cookie);
        
        return ResponseEntity.ok("Tokenå·²è®¾ç½®");
    }
}
```

**Cookieé…ç½®è¯¦è§£**ï¼š
```java
public class SecureCookieBuilder {
    
    public static Cookie buildSecureToken(String token) {
        Cookie cookie = new Cookie("access_token", token);
        
        // æ ¸å¿ƒå®‰å…¨å±æ€§
        cookie.setHttpOnly(true);   // é˜²æ­¢XSSè¯»å–
        cookie.setSecure(true);     // ä»…HTTPSä¼ è¾“
        
        // SameSiteç­–ç•¥
        cookie.setSameSite("Strict");  // æœ€ä¸¥æ ¼ï¼šåªåœ¨åŒç«™è¯·æ±‚ä¸­å‘é€
        // cookie.setSameSite("Lax");  // å®½æ¾ï¼šéƒ¨åˆ†è·¨ç«™è¯·æ±‚å¯å‘é€
        // cookie.setSameSite("None"); // æ— é™åˆ¶ï¼ˆéœ€é…åˆSecureï¼‰
        
        // åŸŸå’Œè·¯å¾„
        cookie.setDomain(".myapp.com");  // æ‰€æœ‰å­åŸŸåå…±äº«
        cookie.setPath("/api");          // ä»…/apiè·¯å¾„å¯ç”¨
        
        // è¿‡æœŸæ—¶é—´
        cookie.setMaxAge(1800);  // 30åˆ†é’Ÿåè¿‡æœŸ
        
        return cookie;
    }
}
```

### 7.3 åŠ å¯†å­˜å‚¨å®ç°


**TokenåŠ å¯†å­˜å‚¨**ï¼š
```java
public class TokenEncryption {
    
    private static final String ALGORITHM = "AES/GCM/NoPadding";
    private static final SecretKey SECRET_KEY = generateKey();
    
    // åŠ å¯†tokenåå­˜å‚¨
    public static String encryptToken(String token) {
        try {
            Cipher cipher = Cipher.getInstance(ALGORITHM);
            byte[] iv = new byte[12];
            new SecureRandom().nextBytes(iv);
            
            GCMParameterSpec spec = new GCMParameterSpec(128, iv);
            cipher.init(Cipher.ENCRYPT_MODE, SECRET_KEY, spec);
            
            byte[] encrypted = cipher.doFinal(token.getBytes());
            
            // IV + å¯†æ–‡ï¼Œä¸€èµ·Base64ç¼–ç 
            byte[] combined = new byte[iv.length + encrypted.length];
            System.arraycopy(iv, 0, combined, 0, iv.length);
            System.arraycopy(encrypted, 0, combined, iv.length, encrypted.length);
            
            return Base64.getEncoder().encodeToString(combined);
        } catch (Exception e) {
            throw new RuntimeException("åŠ å¯†å¤±è´¥", e);
        }
    }
    
    // è§£å¯†token
    public static String decryptToken(String encryptedToken) {
        try {
            byte[] combined = Base64.getDecoder().decode(encryptedToken);
            
            // æå–IVå’Œå¯†æ–‡
            byte[] iv = Arrays.copyOfRange(combined, 0, 12);
            byte[] encrypted = Arrays.copyOfRange(combined, 12, combined.length);
            
            Cipher cipher = Cipher.getInstance(ALGORITHM);
            GCMParameterSpec spec = new GCMParameterSpec(128, iv);
            cipher.init(Cipher.DECRYPT_MODE, SECRET_KEY, spec);
            
            byte[] decrypted = cipher.doFinal(encrypted);
            return new String(decrypted);
        } catch (Exception e) {
            throw new RuntimeException("è§£å¯†å¤±è´¥", e);
        }
    }
}
```

### 7.4 Refresh Tokenç‰¹æ®Šä¿æŠ¤


**Refresh Tokençš„å®‰å…¨å­˜å‚¨**ï¼š
```java
@Service
public class RefreshTokenService {
    
    // å­˜å‚¨åœ¨æ•°æ®åº“ï¼Œä¸è¿”å›ç»™å®¢æˆ·ç«¯
    public void saveRefreshToken(String userId, String refreshToken) {
        RefreshTokenEntity entity = new RefreshTokenEntity();
        entity.setUserId(userId);
        
        // åŠ å¯†åå­˜å‚¨
        entity.setToken(encrypt(refreshToken));
        
        // è®¾ç½®è¿‡æœŸæ—¶é—´
        entity.setExpiresAt(LocalDateTime.now().plusDays(7));
        
        // ç»‘å®šè®¾å¤‡ä¿¡æ¯
        entity.setDeviceId(getDeviceId());
        entity.setIpAddress(getCurrentIp());
        
        repository.save(entity);
    }
    
    // ä½¿ç”¨æ—¶éªŒè¯è®¾å¤‡
    public boolean validateRefreshToken(String token, String deviceId) {
        RefreshTokenEntity entity = repository.findByToken(encrypt(token));
        
        if (entity == null || entity.isExpired()) {
            return false;
        }
        
        // éªŒè¯è®¾å¤‡ID
        if (!entity.getDeviceId().equals(deviceId)) {
            // å¯èƒ½è¢«ç›—ç”¨ï¼Œç«‹å³æ’¤é”€
            repository.delete(entity);
            return false;
        }
        
        return true;
    }
}
```

### 7.5 å­˜å‚¨å®‰å…¨æœ€ä½³å®è·µ


ğŸ’¡ **æ¨èæ–¹æ¡ˆ**ï¼š

```
å‰ç«¯å­˜å‚¨æ–¹æ¡ˆï¼š

é«˜å®‰å…¨åœºæ™¯ï¼ˆé“¶è¡Œã€æ”¯ä»˜ï¼‰ï¼š
â””â”€ Access Token: HttpOnly Cookie + Secure + SameSite=Strict
â””â”€ Refresh Token: ä¸ç»™å‰ç«¯ï¼Œæ”¾æœåŠ¡ç«¯

æ™®é€šWebåº”ç”¨ï¼š
â””â”€ Access Token: HttpOnly Cookie
â””â”€ Refresh Token: HttpOnly Cookieï¼ˆå•ç‹¬åŸŸï¼‰

å•é¡µåº”ç”¨(SPA)ï¼š
â””â”€ Access Token: å†…å­˜å˜é‡ï¼ˆåˆ·æ–°ä¸¢å¤±ï¼‰
â””â”€ Refresh Token: HttpOnly Cookie

ç§»åŠ¨Appï¼š
â””â”€ Access Token: å†…å­˜ + åŠ å¯†ç¼“å­˜
â””â”€ Refresh Token: ç³»ç»ŸKeychain/KeyStore
```

âš ï¸ **å®‰å…¨æ£€æŸ¥æ¸…å•**ï¼š
```
âœ… TokenåŠ å¯†å­˜å‚¨
âœ… ä½¿ç”¨HttpOnly Cookie
âœ… å¯ç”¨Secureæ ‡å¿—ï¼ˆHTTPSï¼‰
âœ… è®¾ç½®SameSiteé˜²CSRF
âœ… å®šæœŸæ›´æ¢åŠ å¯†å¯†é’¥
âœ… æ•æ„Ÿtokenä¸è®°å½•æ—¥å¿—
âœ… Tokenç”¨å®Œç«‹å³é”€æ¯

âŒ ä¸è¦åœ¨URLä¸­ä¼ token
âŒ ä¸è¦åœ¨LocalStorageå­˜æ•æ„Ÿtoken
âŒ ä¸è¦åœ¨å‰ç«¯æ˜æ–‡å­˜å‚¨
âŒ ä¸è¦åœ¨æ—¥å¿—ä¸­æ‰“å°token
```

---

## 8. ğŸ›¡ï¸ ç»¼åˆé˜²æŠ¤æœ€ä½³å®è·µ


### 8.1 å¤šå±‚é˜²æŠ¤ä½“ç³»


**é˜²æŠ¤é‡‘å­—å¡”**ï¼š
```
              ç”¨æˆ·å®‰å…¨æ„è¯†
            â•±              â•²
          åº”ç”¨å±‚å®‰å…¨
        â•±              â•²
      ä¼ è¾“å±‚å®‰å…¨ï¼ˆHTTPSï¼‰
    â•±                      â•²
  å­˜å‚¨å®‰å…¨ï¼ˆåŠ å¯†ï¼‰
â•±                              â•²
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        åŸºç¡€è®¾æ–½å®‰å…¨
```

**å„å±‚é˜²æŠ¤æªæ–½**ï¼š
```
ğŸ” ä¼ è¾“å±‚ï¼š
  â””â”€ HTTPSå¼ºåˆ¶ä¼ è¾“
  â””â”€ TLS 1.2+
  â””â”€ å¼ºåŠ å¯†å¥—ä»¶

ğŸ›¡ï¸ åè®®å±‚ï¼š
  â””â”€ PKCEé˜²æŠ¤
  â””â”€ Stateå‚æ•°
  â””â”€ çŸ­æ—¶æ•ˆToken
  
ğŸ”’ å­˜å‚¨å±‚ï¼š
  â””â”€ HttpOnly Cookie
  â””â”€ TokenåŠ å¯†
  â””â”€ å®‰å…¨å¯†é’¥ç®¡ç†
  
âš™ï¸ åº”ç”¨å±‚ï¼š
  â””â”€ CORSç™½åå•
  â””â”€ å‚æ•°éªŒè¯
  â””â”€ è®¿é—®é¢‘ç‡é™åˆ¶
```

### 8.2 å®Œæ•´é˜²æŠ¤å®ç°


**ç»¼åˆé˜²æŠ¤é…ç½®ç±»**ï¼š
```java
@Configuration
@EnableWebSecurity
public class OAuth2SecurityConfig {
    
    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) {
        http
            // 1. å¼ºåˆ¶HTTPS
            .requiresChannel()
                .anyRequest().requiresSecure()
            
            // 2. CORSé…ç½®
            .and()
            .cors().configurationSource(corsConfigurationSource())
            
            // 3. CSRFä¿æŠ¤
            .and()
            .csrf()
                .csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse())
            
            // 4. OAuth2é…ç½®
            .and()
            .oauth2Login()
                .authorizationEndpoint()
                    .authorizationRequestResolver(pkceResolver())  // PKCE
                .and()
                .tokenEndpoint()
                    .accessTokenResponseClient(tokenResponseClient())
            
            // 5. å®‰å…¨å“åº”å¤´
            .and()
            .headers()
                .contentSecurityPolicy("default-src 'self'")
                .and()
                .frameOptions().deny()
                .and()
                .xssProtection().block(true);
        
        return http.build();
    }
    
    // PKCEè§£æå™¨
    private OAuth2AuthorizationRequestResolver pkceResolver() {
        DefaultOAuth2AuthorizationRequestResolver resolver = 
            new DefaultOAuth2AuthorizationRequestResolver(...);
        
        resolver.setAuthorizationRequestCustomizer(customizer -> 
            customizer.attributes(attrs -> {
                // ç”ŸæˆPKCEå‚æ•°
                String verifier = PKCEGenerator.generateCodeVerifier();
                String challenge = PKCEGenerator.generateCodeChallenge(verifier);
                
                attrs.put("code_verifier", verifier);
                customizer
                    .additionalParameters(params -> {
                        params.put("code_challenge", challenge);
                        params.put("code_challenge_method", "S256");
                    })
                    .state(UUID.randomUUID().toString());  // Stateå‚æ•°
            })
        );
        
        return resolver;
    }
}
```

### 8.3 å®‰å…¨ç›‘æ§ä¸å®¡è®¡


**å®‰å…¨äº‹ä»¶è®°å½•**ï¼š
```java
@Aspect
@Component
public class SecurityAuditAspect {
    
    // è®°å½•æˆæƒè¯·æ±‚
    @Before("@annotation(org.springframework.web.bind.annotation.GetMapping) && " +
            "execution(* *..OAuth2Controller.authorize(..))")
    public void logAuthorization(JoinPoint joinPoint) {
        HttpServletRequest request = getCurrentRequest();
        
        SecurityEvent event = SecurityEvent.builder()
            .type("OAUTH_AUTHORIZE")
            .clientId(request.getParameter("client_id"))
            .state(request.getParameter("state"))
            .ip(request.getRemoteAddr())
            .userAgent(request.getHeader("User-Agent"))
            .timestamp(LocalDateTime.now())
            .build();
        
        auditService.log(event);
        
        // æ£€æµ‹å¼‚å¸¸
        if (isAnomalous(event)) {
            alertService.sendAlert("å¯ç–‘çš„OAuth2æˆæƒè¯·æ±‚", event);
        }
    }
    
    // æ£€æµ‹å¼‚å¸¸è¡Œä¸º
    private boolean isAnomalous(SecurityEvent event) {
        // çŸ­æ—¶é—´å†…å¤šæ¬¡è¯·æ±‚
        long recentRequests = auditService.countRecentRequests(
            event.getIp(), 
            Duration.ofMinutes(5)
        );
        if (recentRequests > 10) {
            return true;
        }
        
        // é™Œç”Ÿè®¾å¤‡ç™»å½•
        if (!deviceService.isKnownDevice(event.getUserAgent())) {
            return true;
        }
        
        return false;
    }
}
```

**Tokenä½¿ç”¨ç›‘æ§**ï¼š
```java
@Component
public class TokenUsageMonitor {
    
    @Scheduled(fixedRate = 60000)  // æ¯åˆ†é’Ÿæ£€æŸ¥
    public void monitorTokenUsage() {
        // æ£€æŸ¥å¼‚å¸¸tokenä½¿ç”¨
        List<TokenUsage> suspiciousUsages = tokenRepository
            .findSuspiciousUsages(Duration.ofMinutes(10));
        
        for (TokenUsage usage : suspiciousUsages) {
            // åŒä¸€tokenåœ¨å¤šä¸ªIPä½¿ç”¨
            if (usage.getDistinctIpCount() > 3) {
                revokeToken(usage.getToken());
                alertService.sendAlert("Tokenå¯èƒ½è¢«ç›—ç”¨", usage);
            }
            
            // å¼‚å¸¸é¢‘ç‡è®¿é—®
            if (usage.getRequestCount() > 1000) {
                rateLimiter.blockIp(usage.getIp());
            }
        }
    }
}
```

### 8.4 åº”æ€¥å“åº”æœºåˆ¶


**Tokenç´§æ€¥æ’¤é”€**ï¼š
```java
@Service
public class TokenRevocationService {
    
    // æ’¤é”€å•ä¸ªtoken
    public void revokeToken(String token) {
        // 1. åŠ å…¥é»‘åå•
        redisTemplate.opsForSet().add("revoked_tokens", token);
        redisTemplate.expire("revoked_tokens", 24, TimeUnit.HOURS);
        
        // 2. è®°å½•æ’¤é”€åŸå› 
        RevocationRecord record = new RevocationRecord();
        record.setToken(hashToken(token));  // ä¸è®°å½•æ˜æ–‡
        record.setReason("SECURITY_BREACH");
        record.setTimestamp(LocalDateTime.now());
        repository.save(record);
        
        // 3. é€šçŸ¥ç›¸å…³æœåŠ¡
        messagingService.publish("token.revoked", token);
    }
    
    // æ’¤é”€ç”¨æˆ·æ‰€æœ‰token
    public void revokeAllUserTokens(String userId) {
        List<String> userTokens = tokenRepository.findByUserId(userId);
        userTokens.forEach(this::revokeToken);
        
        // å¼ºåˆ¶ç”¨æˆ·é‡æ–°ç™»å½•
        sessionService.invalidateAllSessions(userId);
    }
    
    // éªŒè¯tokenæ˜¯å¦è¢«æ’¤é”€
    public boolean isTokenRevoked(String token) {
        return redisTemplate.opsForSet().isMember("revoked_tokens", token);
    }
}
```

**æ‹¦æˆªå™¨éªŒè¯æ’¤é”€çŠ¶æ€**ï¼š
```java
@Component
public class TokenRevocationInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(
        HttpServletRequest request,
        HttpServletResponse response,
        Object handler
    ) {
        String token = extractToken(request);
        
        if (token != null && revocationService.isTokenRevoked(token)) {
            response.setStatus(HttpStatus.UNAUTHORIZED.value());
            response.getWriter().write("Tokenå·²è¢«æ’¤é”€");
            return false;
        }
        
        return true;
    }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„å®‰å…¨æªæ–½


```
ğŸ” äº”å¤§æ ¸å¿ƒé˜²æŠ¤ï¼š

1ï¸âƒ£ HTTPSä¼ è¾“
   â””â”€ æ‰€æœ‰OAuth2é€šä¿¡å¿…é¡»åŠ å¯†
   â””â”€ é˜²æ­¢ä¸­é—´äººæ”»å‡»

2ï¸âƒ£ PKCEæœºåˆ¶
   â””â”€ é˜²æ­¢æˆæƒç æ‹¦æˆª
   â””â”€ ç§»åŠ¨åº”ç”¨å¿…å¤‡

3ï¸âƒ£ Stateå‚æ•°
   â””â”€ é˜²æ­¢CSRFæ”»å‡»
   â””â”€ æ¯æ¬¡è¯·æ±‚éƒ½éªŒè¯

4ï¸âƒ£ çŸ­æ—¶æ•ˆToken
   â””â”€ Access Token: 15-60åˆ†é’Ÿ
   â””â”€ Refresh Token: 7-30å¤©

5ï¸âƒ£ å®‰å…¨å­˜å‚¨
   â””â”€ HttpOnly Cookie
   â””â”€ åŠ å¯†æ•æ„Ÿæ•°æ®
```

### 9.2 å®‰å…¨æ£€æŸ¥æ¸…å•


**éƒ¨ç½²å‰å¿…æŸ¥**ï¼š
```
ä¼ è¾“å®‰å…¨ï¼š
â–¡ å·²å¯ç”¨HTTPS
â–¡ TLSç‰ˆæœ¬â‰¥1.2
â–¡ è¯ä¹¦æœ‰æ•ˆä¸”æœªè¿‡æœŸ
â–¡ å¼ºåˆ¶HTTPè·³è½¬HTTPS

åè®®å®‰å…¨ï¼š
â–¡ å·²å®ç°PKCE
â–¡ Stateå‚æ•°éªŒè¯
â–¡ Redirect URIä¸¥æ ¼åŒ¹é…
â–¡ Tokenæ—¶æ•ˆåˆç†è®¾ç½®

å­˜å‚¨å®‰å…¨ï¼š
â–¡ TokenåŠ å¯†å­˜å‚¨
â–¡ Cookieè®¾ç½®HttpOnly
â–¡ Cookieè®¾ç½®Secure
â–¡ Cookieè®¾ç½®SameSite

è®¿é—®æ§åˆ¶ï¼š
â–¡ CORSç™½åå•é…ç½®
â–¡ APIé¢‘ç‡é™åˆ¶
â–¡ å¼‚å¸¸æ£€æµ‹æœºåˆ¶
â–¡ Tokenæ’¤é”€åŠŸèƒ½
```

### 9.3 å¸¸è§å®‰å…¨è¯¯åŒº


âš ï¸ **å®¹æ˜“çŠ¯çš„é”™è¯¯**ï¼š
```
âŒ é”™è¯¯1ï¼šTokenå­˜LocalStorage
   åŸå› ï¼šå®¹æ˜“è¢«XSSæ”»å‡»çªƒå–
   æ­£ç¡®ï¼šä½¿ç”¨HttpOnly Cookie

âŒ é”™è¯¯2ï¼šä¸éªŒè¯Stateå‚æ•°
   åŸå› ï¼šCSRFæ”»å‡»é£é™©
   æ­£ç¡®ï¼šæ¯æ¬¡éƒ½ç”Ÿæˆå¹¶éªŒè¯State

âŒ é”™è¯¯3ï¼šTokenæ°¸ä¸è¿‡æœŸ
   åŸå› ï¼šè¢«ç›—åæ°¸ä¹…é£é™©
   æ­£ç¡®ï¼šè®¾ç½®åˆç†è¿‡æœŸæ—¶é—´

âŒ é”™è¯¯4ï¼šCORSå…è®¸æ‰€æœ‰åŸŸå
   åŸå› ï¼šä»»ä½•ç½‘ç«™éƒ½èƒ½è®¿é—®
   æ­£ç¡®ï¼šæ˜ç¡®æŒ‡å®šç™½åå•

âŒ é”™è¯¯5ï¼šæ˜æ–‡ä¼ è¾“æ•æ„Ÿæ•°æ®
   åŸå› ï¼šç½‘ç»œç›‘å¬é£é™©
   æ­£ç¡®ï¼šå…¨ç¨‹HTTPSåŠ å¯†
```

### 9.4 å®‰å…¨é…ç½®é€ŸæŸ¥


**å¿«é€Ÿé…ç½®å‚è€ƒ**ï¼š
```java
// 1. HTTPSå¼ºåˆ¶
server.ssl.enabled=true
server.require-ssl=true

// 2. Tokenæ—¶æ•ˆ
access-token-validity-seconds=1800
refresh-token-validity-seconds=604800

// 3. Cookieå®‰å…¨
server.servlet.session.cookie.http-only=true
server.servlet.session.cookie.secure=true
server.servlet.session.cookie.same-site=strict

// 4. CORSé™åˆ¶
cors.allowed-origins=https://myapp.com
cors.allowed-methods=GET,POST
cors.allow-credentials=true

// 5. å®‰å…¨å“åº”å¤´
security.headers.content-security-policy=default-src 'self'
security.headers.x-frame-options=DENY
security.headers.x-content-type-options=nosniff
```

### 9.5 å­¦ä¹ è·¯å¾„å»ºè®®


**ä»æ–°æ‰‹åˆ°ç²¾é€š**ï¼š
```
ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€é˜²æŠ¤
â”œâ”€ ç†è§£HTTPSåŸç†
â”œâ”€ é…ç½®SSLè¯ä¹¦
â”œâ”€ å®ç°Stateå‚æ•°
â””â”€ è®¾ç½®Tokenè¿‡æœŸ

ç¬¬äºŒé˜¶æ®µï¼šè¿›é˜¶é˜²æŠ¤
â”œâ”€ å®ç°PKCEæœºåˆ¶
â”œâ”€ é…ç½®CORSç­–ç•¥
â”œâ”€ HttpOnly Cookie
â””â”€ TokenåŠ å¯†å­˜å‚¨

ç¬¬ä¸‰é˜¶æ®µï¼šé«˜çº§é˜²æŠ¤
â”œâ”€ å®‰å…¨ç›‘æ§å®¡è®¡
â”œâ”€ å¼‚å¸¸æ£€æµ‹å‘Šè­¦
â”œâ”€ Tokenæ’¤é”€æœºåˆ¶
â””â”€ åº”æ€¥å“åº”é¢„æ¡ˆ

æŒç»­æå‡ï¼š
â””â”€ å…³æ³¨å®‰å…¨æ¼æ´å…¬å‘Š
â””â”€ å®šæœŸå®‰å…¨å®¡è®¡
â””â”€ æ›´æ–°é˜²æŠ¤ç­–ç•¥
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
ä¼ è¾“å¿…é¡»HTTPSåŠ å¯†
æˆæƒå¸¦ä¸ŠPKCEå’ŒState
ä»¤ç‰Œæ—¶æ•ˆä¸è¦å¤ªé•¿
å­˜å‚¨å®‰å…¨Cookieä¸ºä¸Š
è·¨åŸŸé™åˆ¶ç™½åå•é˜²
ç›‘æ§å®¡è®¡ä¸èƒ½å¿˜
```

---

## ğŸ’¡ å®æˆ˜å»ºè®®


**å¼€å‘é˜¶æ®µ**ï¼š
- ä»ä¸€å¼€å§‹å°±é…ç½®HTTPS
- ä½¿ç”¨æˆç†Ÿçš„OAuth2åº“
- ä¸è¦è‡ªå·±å®ç°åŠ å¯†ç®—æ³•
- æ‰€æœ‰é…ç½®éƒ½è¦æµ‹è¯•

**æµ‹è¯•é˜¶æ®µ**ï¼š
- æ¨¡æ‹Ÿå„ç§æ”»å‡»åœºæ™¯
- éªŒè¯æ‰€æœ‰å®‰å…¨æªæ–½
- æ£€æŸ¥æ—¥å¿—è®°å½•
- å‹åŠ›æµ‹è¯•Tokenåˆ·æ–°

**ä¸Šçº¿é˜¶æ®µ**ï¼š
- å†æ¬¡æ£€æŸ¥å®‰å…¨æ¸…å•
- å‡†å¤‡åº”æ€¥å“åº”é¢„æ¡ˆ
- é…ç½®ç›‘æ§å‘Šè­¦
- å®šæœŸå®‰å…¨å®¡è®¡

**è¿ç»´é˜¶æ®µ**ï¼š
- ç›‘æ§å¼‚å¸¸è®¿é—®
- å®šæœŸæ›´æ–°è¯ä¹¦
- å…³æ³¨å®‰å…¨å…¬å‘Š
- ä¼˜åŒ–é˜²æŠ¤ç­–ç•¥