---
title: 3ã€OAuth2.0æœ€ä½³å®è·µ
---
## ğŸ“š ç›®å½•

1. [ä¼ä¸šçº§å®‰å…¨åˆè§„æ¦‚è¿°](#1-ä¼ä¸šçº§å®‰å…¨åˆè§„æ¦‚è¿°)
2. [æœ€å°æƒé™åŸåˆ™](#2-æœ€å°æƒé™åŸåˆ™)
3. [HTTPSå…¨è¦†ç›–](#3-httpså…¨è¦†ç›–)
4. [å¤šå› å­è®¤è¯MFA](#4-å¤šå› å­è®¤è¯mfa)
5. [ç›‘æ§å‘Šè­¦ä½“ç³»](#5-ç›‘æ§å‘Šè­¦ä½“ç³»)
6. [å®‰å…¨åˆè§„è¦æ±‚](#6-å®‰å…¨åˆè§„è¦æ±‚)
7. [æ•°æ®ä¿æŠ¤ç­–ç•¥](#7-æ•°æ®ä¿æŠ¤ç­–ç•¥)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ›¡ï¸ ä¼ä¸šçº§å®‰å…¨åˆè§„æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯OAuth2.0å®‰å…¨åˆè§„


**é€šä¿—ç†è§£**ï¼š
```
å°±åƒé“¶è¡Œçš„å®‰å…¨è§„èŒƒä¸€æ ·ï¼ŒOAuth2.0ä¹Ÿæœ‰ä¸€å¥—"å®‰å…¨å®ˆåˆ™"

é“¶è¡Œå®‰å…¨å®ˆåˆ™ï¼š
â€¢ é‡‘åº“è¦åŠ å¯†ç é”
â€¢ è½¬è´¦è¦å¤šé‡éªŒè¯
â€¢ 24å°æ—¶ç›‘æ§å½•åƒ
â€¢ å®šæœŸå®‰å…¨æ£€æŸ¥

OAuth2.0å®‰å…¨å®ˆåˆ™ï¼š
â€¢ æ•°æ®ä¼ è¾“è¦åŠ å¯†ï¼ˆHTTPSï¼‰
â€¢ ç™»å½•è¦å¤šé‡éªŒè¯ï¼ˆMFAï¼‰
â€¢ æƒé™è¦æœ€å°åŒ–åˆ†é…
â€¢ å…¨ç¨‹ç›‘æ§æ—¥å¿—è®°å½•
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦å®‰å…¨åˆè§„


**æ ¸å¿ƒåŸå› **ï¼š
```
ğŸ”¸ ä¿æŠ¤ç”¨æˆ·æ•°æ®
é—®é¢˜ï¼šç”¨æˆ·ä¿¡æ¯æ³„éœ²ä¼šé€ æˆå·¨å¤§æŸå¤±
è§£å†³ï¼šé€šè¿‡åˆè§„æªæ–½ç¡®ä¿æ•°æ®å®‰å…¨

ğŸ”¸ æ»¡è¶³æ³•å¾‹è¦æ±‚
é—®é¢˜ï¼šä¸åˆè§„ä¼šé¢ä¸´æ³•å¾‹å¤„ç½š
è§£å†³ï¼šéµå¾ªGDPRã€ç­‰ä¿ç­‰è¡Œä¸šæ ‡å‡†

ğŸ”¸ æå‡ä¼ä¸šä¿¡èª‰
é—®é¢˜ï¼šå®‰å…¨äº‹æ•…ä¼šæŸå®³å“ç‰Œå½¢è±¡
è§£å†³ï¼šé€šè¿‡è®¤è¯å±•ç¤ºå®‰å…¨èƒ½åŠ›

ğŸ”¸ é™ä½å®‰å…¨é£é™©
é—®é¢˜ï¼šé»‘å®¢æ”»å‡»æ‰‹æ®µå±‚å‡ºä¸ç©·
è§£å†³ï¼šæŒç»­æ”¹è¿›å®‰å…¨é˜²æŠ¤æªæ–½
```

### 1.3 å®‰å…¨åˆè§„çš„æ ¸å¿ƒå†…å®¹


| åˆè§„é¢†åŸŸ | **æ ¸å¿ƒè¦æ±‚** | **å®æ–½éš¾åº¦** | **é‡è¦ç¨‹åº¦** |
|---------|------------|-------------|------------|
| ğŸ” **æ•°æ®åŠ å¯†** | `ä¼ è¾“å’Œå­˜å‚¨éƒ½è¦åŠ å¯†` | `ä¸­ç­‰` | `â­â­â­â­â­` |
| ğŸ¯ **æƒé™æ§åˆ¶** | `æœ€å°æƒé™åˆ†é…åŸåˆ™` | `è¾ƒé«˜` | `â­â­â­â­â­` |
| ğŸ”‘ **èº«ä»½è®¤è¯** | `å¤šå› å­è®¤è¯MFA` | `ä¸­ç­‰` | `â­â­â­â­` |
| ğŸ“Š **å®¡è®¡æ—¥å¿—** | `å…¨ç¨‹æ“ä½œå¯è¿½æº¯` | `è¾ƒé«˜` | `â­â­â­â­` |
| ğŸš¨ **ç›‘æ§å‘Šè­¦** | `å®æ—¶å®‰å…¨ç›‘æ§` | `ä¸­ç­‰` | `â­â­â­â­` |

---

## 2. ğŸ¯ æœ€å°æƒé™åŸåˆ™


### 2.1 ä»€ä¹ˆæ˜¯æœ€å°æƒé™åŸåˆ™


**é€šä¿—è§£é‡Š**ï¼š
```
æœ€å°æƒé™åŸåˆ™ = "ç”¨å¤šå°‘ç»™å¤šå°‘ï¼Œä¸å¤šç»™ä¸€ç‚¹"

ç”Ÿæ´»ä¾‹å­ï¼š
âŒ é”™è¯¯åšæ³•ï¼šè¯·äººå¸®å¿™å–å¿«é€’ï¼ŒæŠŠå®¶é‡Œæ‰€æœ‰é’¥åŒ™éƒ½ç»™ä»–
âœ… æ­£ç¡®åšæ³•ï¼šåªç»™å¿«é€’æŸœçš„å¯†ç ï¼Œå…¶ä»–ä»€ä¹ˆéƒ½ä¸ç»™

ç³»ç»Ÿä¾‹å­ï¼š
âŒ é”™è¯¯åšæ³•ï¼šæŸ¥çœ‹è®¢å•çš„åŠŸèƒ½ï¼Œç»™äº†åˆ é™¤è®¢å•çš„æƒé™
âœ… æ­£ç¡®åšæ³•ï¼šåªç»™æŸ¥çœ‹æƒé™ï¼Œä¸ç»™ä¿®æ”¹å’Œåˆ é™¤æƒé™
```

### 2.2 æƒé™åˆ†é…çš„å®è·µæ–¹æ³•


**ğŸ”¸ åŸºäºè§’è‰²çš„æƒé™åˆ†é…**
```
è§’è‰²å±‚æ¬¡è®¾è®¡ï¼š
     è¶…çº§ç®¡ç†å‘˜
          |
    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
  ç®¡ç†å‘˜      è¿è¥äººå‘˜
    |           |
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
     æ™®é€šç”¨æˆ·

æƒé™èŒƒå›´ï¼š
è¶…çº§ç®¡ç†å‘˜ï¼šæ‰€æœ‰æƒé™ï¼ˆè°¨æ…åˆ†é…ï¼‰
ç®¡ç†å‘˜ï¼šä¸šåŠ¡ç®¡ç†æƒé™
è¿è¥äººå‘˜ï¼šæ•°æ®æŸ¥çœ‹å’ŒåŸºç¡€æ“ä½œ
æ™®é€šç”¨æˆ·ï¼šè‡ªå·±æ•°æ®çš„æŸ¥çœ‹å’Œä¿®æ”¹
```

**ğŸ”¸ OAuth2.0 ScopeèŒƒå›´æ§åˆ¶**
```java
// âŒ é”™è¯¯ç¤ºä¾‹ï¼šæƒé™èŒƒå›´å¤ªå¤§
@PreAuthorize("hasAuthority('SCOPE_all')")  // ç»™äº†æ‰€æœ‰æƒé™
public User getUserInfo() {
    return userService.getFullUserInfo();
}

// âœ… æ­£ç¡®ç¤ºä¾‹ï¼šç²¾ç¡®çš„æƒé™èŒƒå›´
@PreAuthorize("hasAuthority('SCOPE_user:read')")  // åªç»™è¯»å–æƒé™
public UserBasicInfo getUserBasicInfo() {
    return userService.getBasicInfo();  // åªè¿”å›åŸºç¡€ä¿¡æ¯
}

// âœ… æ›´ç»†ç²’åº¦çš„æƒé™æ§åˆ¶
@PreAutorize("hasAuthority('SCOPE_user:profile:read')")  // åªè¯»ä¸ªäººèµ„æ–™
public UserProfile getUserProfile() {
    return userService.getUserProfile();
}
```

### 2.3 æƒé™åˆ†çº§ç­–ç•¥


**ğŸ“‹ æƒé™åˆ†çº§è¡¨**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æƒé™çº§åˆ« â”‚   ScopeèŒƒå›´    â”‚    å…è®¸æ“ä½œ      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Level 1  â”‚ user:read     â”‚ æŸ¥çœ‹åŸºæœ¬ä¿¡æ¯      â”‚
â”‚ Level 2  â”‚ user:write    â”‚ ä¿®æ”¹ä¸ªäººèµ„æ–™      â”‚
â”‚ Level 3  â”‚ user:delete   â”‚ åˆ é™¤è´¦æˆ·         â”‚
â”‚ Level 4  â”‚ admin:read    â”‚ æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·      â”‚
â”‚ Level 5  â”‚ admin:write   â”‚ ç®¡ç†æ‰€æœ‰ç”¨æˆ·      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åŸåˆ™ï¼šæƒé™åªå‡ä¸é™ï¼Œç”¨å®Œå³å›æ”¶
```

### 2.4 å®æˆ˜é…ç½®ç¤ºä¾‹


**Spring Securityæƒé™é…ç½®**
```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http.authorizeHttpRequests(auth -> auth
            // å…¬å¼€æ¥å£ï¼šæ— éœ€è®¤è¯
            .requestMatchers("/public/**").permitAll()
            
            // åŸºç¡€æ¥å£ï¼šåªéœ€ç™»å½•
            .requestMatchers("/api/user/profile").hasAuthority("SCOPE_user:read")
            
            // ä¿®æ”¹æ¥å£ï¼šéœ€è¦å†™æƒé™
            .requestMatchers("/api/user/update").hasAuthority("SCOPE_user:write")
            
            // ç®¡ç†æ¥å£ï¼šéœ€è¦ç®¡ç†å‘˜æƒé™
            .requestMatchers("/api/admin/**").hasAuthority("SCOPE_admin:read")
            
            // å…¶ä»–è¯·æ±‚ï¼šéƒ½éœ€è¦è®¤è¯
            .anyRequest().authenticated()
        );
        return http.build();
    }
}
```

> ğŸ’¡ **å®è·µæŠ€å·§**ï¼š
> - é»˜è®¤æ‹’ç»ï¼Œæ˜ç¡®æˆæƒ
> - å®šæœŸå®¡æŸ¥æƒé™åˆ†é…
> - æƒé™å˜æ›´å¿…é¡»å®¡æ‰¹
> - ç¦»èŒå‘˜å·¥ç«‹å³å›æ”¶æƒé™

---

## 3. ğŸ”’ HTTPSå…¨è¦†ç›–


### 3.1 ä¸ºä»€ä¹ˆå¿…é¡»ä½¿ç”¨HTTPS


**é€šä¿—ç†è§£**ï¼š
```
HTTP vs HTTPS å°±åƒï¼š

HTTPï¼ˆæ˜æ–‡ä¼ è¾“ï¼‰:
ä½ ï¼šæˆ‘è¦è½¬è´¦1000å…ƒç»™å¼ ä¸‰ï¼Œå¯†ç æ˜¯123456
è·¯äººï¼šæˆ‘å¬åˆ°äº†ï¼æˆ‘ä¹ŸçŸ¥é“å¯†ç äº†ï¼

HTTPSï¼ˆåŠ å¯†ä¼ è¾“ï¼‰:
ä½ ï¼š#@$%^&*ï¼ˆåŠ å¯†å†…å®¹ï¼‰
è·¯äººï¼šå¬ä¸æ‡‚ï¼Œæˆªè·ä¹Ÿæ²¡ç”¨
```

**å®‰å…¨å¯¹æ¯”**ï¼š
```
åœºæ™¯ï¼šç™»å½•æ¥å£ä¼ è¾“ç”¨æˆ·åå¯†ç 

HTTPä¼ è¾“ï¼ˆâŒå±é™©ï¼‰:
POST /login HTTP/1.1
username=admin&password=123456

â†“ é»‘å®¢å¯ä»¥ç›´æ¥çœ‹åˆ° â†“

HTTPSä¼ è¾“ï¼ˆâœ…å®‰å…¨ï¼‰:
åŠ å¯†åçš„æ•°æ®ï¼šaGVsbG8gd29ybGQ...

â†“ é»‘å®¢çœ‹åˆ°çš„æ˜¯ä¹±ç  â†“
```

### 3.2 HTTPSé…ç½®å®è·µ


**ğŸ”¸ ç”³è¯·SSLè¯ä¹¦**
```bash
# å…è´¹è¯ä¹¦é€‰æ‹©ï¼ˆé€‚åˆä¸ªäººå’Œæµ‹è¯•ï¼‰
Let's Encryptï¼šå…è´¹ã€è‡ªåŠ¨ç»­æœŸã€æ”¯æŒé€šé…ç¬¦

# å•†ä¸šè¯ä¹¦é€‰æ‹©ï¼ˆé€‚åˆä¼ä¸šï¼‰
DigiCertã€Symantecï¼šæ”¶è´¹ã€é«˜ä¿¡èª‰åº¦ã€å¸¦æ‹…ä¿
```

**ğŸ”¸ Spring Booté…ç½®HTTPS**
```yaml
# application.yml é…ç½®
server:
  port: 8443                                    # HTTPSç«¯å£
  ssl:
    enabled: true                               # å¯ç”¨SSL
    key-store: classpath:keystore.p12           # è¯ä¹¦æ–‡ä»¶è·¯å¾„
    key-store-password: your-password           # è¯ä¹¦å¯†ç 
    key-store-type: PKCS12                      # è¯ä¹¦ç±»å‹
    key-alias: tomcat                           # è¯ä¹¦åˆ«å

# HTTPè‡ªåŠ¨è·³è½¬HTTPS
server:
  http:
    port: 8080                                  # HTTPç«¯å£
  # è‡ªåŠ¨é‡å®šå‘åˆ°HTTPS
```

**ğŸ”¸ å¼ºåˆ¶HTTPSé…ç½®**
```java
@Configuration
public class HttpsConfig {
    
    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
            // å¼ºåˆ¶ä½¿ç”¨HTTPS
            .requiresChannel(channel -> channel
                .anyRequest().requiresSecure()  // æ‰€æœ‰è¯·æ±‚éƒ½è¦æ±‚HTTPS
            );
        return http.build();
    }
}
```

### 3.3 HTTPSæœ€ä½³å®è·µ


**ğŸ”¹ å®Œæ•´è¦†ç›–æ¸…å•**
```
âœ… å¿…é¡»HTTPSçš„åœºæ™¯ï¼š
â”œâ”€ ç”¨æˆ·ç™»å½•æ¥å£
â”œâ”€ è·å–Tokenæ¥å£
â”œâ”€ åˆ·æ–°Tokenæ¥å£
â”œâ”€ ç”¨æˆ·ä¿¡æ¯æ¥å£
â”œâ”€ æ”¯ä»˜ç›¸å…³æ¥å£
â”œâ”€ æ•æ„Ÿæ•°æ®ä¼ è¾“
â””â”€ æ‰€æœ‰ç”Ÿäº§ç¯å¢ƒæ¥å£

âš ï¸ æ³¨æ„äº‹é¡¹ï¼š
â€¢ æµ‹è¯•ç¯å¢ƒä¹Ÿå»ºè®®ç”¨HTTPS
â€¢ å†…ç½‘æ¥å£å»ºè®®ç”¨è‡ªç­¾åè¯ä¹¦
â€¢ å®šæœŸæ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæœŸ
â€¢ é…ç½®HSTSå“åº”å¤´
```

**ğŸ”¹ å®‰å…¨å“åº”å¤´é…ç½®**
```java
@Configuration
public class SecurityHeadersConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http.headers(headers -> headers
            // å¼ºåˆ¶HTTPS
            .httpStrictTransportSecurity(hsts -> hsts
                .includeSubDomains(true)           // åŒ…å«å­åŸŸå
                .maxAgeInSeconds(31536000)         // ä¸€å¹´æœ‰æ•ˆæœŸ
            )
            // é˜²æ­¢ç‚¹å‡»åŠ«æŒ
            .frameOptions(frame -> frame.deny())
            // é˜²æ­¢XSSæ”»å‡»
            .xssProtection(xss -> xss.enable())
            // å†…å®¹ç±»å‹æ£€æµ‹
            .contentTypeOptions(content -> content.disable())
        );
        return http.build();
    }
}
```

---

## 4. ğŸ”‘ å¤šå› å­è®¤è¯MFA


### 4.1 ä»€ä¹ˆæ˜¯å¤šå› å­è®¤è¯


**é€šä¿—è§£é‡Š**ï¼š
```
ä¼ ç»Ÿç™»å½•ï¼ˆå•å› å­ï¼‰= åªç”¨ä¸€æŠŠé’¥åŒ™å¼€é—¨
ä½ çš„å¯†ç  â†’ ç™»å½•æˆåŠŸ

å¤šå› å­è®¤è¯ï¼ˆMFAï¼‰= ç”¨å¤šæŠŠä¸åŒç±»å‹çš„é’¥åŒ™å¼€é—¨
ä½ çš„å¯†ç ï¼ˆä½ çŸ¥é“çš„ï¼‰ â†’ ç¬¬ä¸€å…³
æ‰‹æœºéªŒè¯ç ï¼ˆä½ æ‹¥æœ‰çš„ï¼‰ â†’ ç¬¬äºŒå…³
æŒ‡çº¹è¯†åˆ«ï¼ˆä½ æ˜¯è°ï¼‰ â†’ ç¬¬ä¸‰å…³
```

**ä¸‰ç§è®¤è¯å› å­**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®¤è¯å› å­ç±»å‹ â”‚     ä¸¾ä¾‹è¯´æ˜          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä½ çŸ¥é“çš„     â”‚ å¯†ç ã€PINç ã€ç­”æ¡ˆ     â”‚
â”‚ ä½ æ‹¥æœ‰çš„     â”‚ æ‰‹æœºã€ä»¤ç‰Œã€Uç›¾       â”‚
â”‚ ä½ æ˜¯è°       â”‚ æŒ‡çº¹ã€äººè„¸ã€è™¹è†œ      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å®‰å…¨ç­‰çº§ï¼š
å•å› å­ < åŒå› å­ < ä¸‰å› å­
```

### 4.2 å¸¸è§MFAå®ç°æ–¹å¼


**ğŸ”¸ çŸ­ä¿¡éªŒè¯ç ï¼ˆSMS OTPï¼‰**
```java
// ç®€åŒ–çš„çŸ­ä¿¡éªŒè¯æµç¨‹
@Service
public class SmsAuthService {
    
    // æ­¥éª¤1ï¼šå‘é€éªŒè¯ç 
    public void sendVerificationCode(String phone) {
        // ç”Ÿæˆ6ä½éšæœºéªŒè¯ç 
        String code = generateRandomCode(6);
        
        // å­˜å‚¨åˆ°Redisï¼ˆ5åˆ†é’Ÿæœ‰æ•ˆï¼‰
        redisTemplate.opsForValue().set(
            "sms:code:" + phone, 
            code, 
            5, TimeUnit.MINUTES
        );
        
        // å‘é€çŸ­ä¿¡
        smsClient.send(phone, "éªŒè¯ç ï¼š" + code);
    }
    
    // æ­¥éª¤2ï¼šéªŒè¯ç æ ¡éªŒ
    public boolean verifyCode(String phone, String code) {
        String storedCode = redisTemplate.opsForValue()
            .get("sms:code:" + phone);
        
        // éªŒè¯ç åŒ¹é…ä¸”æœªè¿‡æœŸ
        return code.equals(storedCode);
    }
}
```

**ğŸ”¸ Google Authenticatorï¼ˆTOTPï¼‰**
```
æ—¶é—´å‹ä¸€æ¬¡æ€§å¯†ç åŸç†ï¼š

æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯å…±äº«å¯†é’¥
â†“
åŸºäºå½“å‰æ—¶é—´ç”Ÿæˆ6ä½æ•°å­—
â†“
æ¯30ç§’è‡ªåŠ¨æ›´æ–°
â†“
æœåŠ¡å™¨éªŒè¯æ—¶é—´çª—å£å†…çš„å¯†ç 

ä¼˜ç‚¹ï¼š
â€¢ ç¦»çº¿ç”Ÿæˆï¼Œæ— éœ€ç½‘ç»œ
â€¢ å®‰å…¨æ€§é«˜
â€¢ æ ‡å‡†åŒ–åè®®
```

**ğŸ”¸ é›†æˆGoogle Authenticator**
```java
@Service
public class TotpAuthService {
    
    // ç”Ÿæˆå¯†é’¥ï¼ˆç”¨æˆ·ç»‘å®šæ—¶ï¼‰
    public String generateSecretKey(String username) {
        String secret = Base32.random();
        
        // ä¿å­˜åˆ°æ•°æ®åº“
        userRepository.updateMfaSecret(username, secret);
        
        // è¿”å›äºŒç»´ç URL
        return "otpauth://totp/" + username + "?secret=" + secret;
    }
    
    // éªŒè¯TOTPç 
    public boolean verifyTotp(String username, String code) {
        User user = userRepository.findByUsername(username);
        String secret = user.getMfaSecret();
        
        // éªŒè¯å½“å‰æ—¶é—´çª—å£çš„å¯†ç 
        TimeBasedOneTimePasswordUtil totp = new TimeBasedOneTimePasswordUtil();
        return totp.validate(secret, code);
    }
}
```

### 4.3 MFAå®æ–½ç­–ç•¥


**ğŸ”¹ åˆ†çº§MFAç­–ç•¥**
```
ä½é£é™©æ“ä½œï¼š
â””â”€ æŸ¥çœ‹ä¸ªäººä¿¡æ¯ï¼šå¯†ç å³å¯

ä¸­é£é™©æ“ä½œï¼š
â””â”€ ä¿®æ”¹ä¸ªäººä¿¡æ¯ï¼šå¯†ç  + çŸ­ä¿¡éªŒè¯ç 

é«˜é£é™©æ“ä½œï¼š
â””â”€ ä¿®æ”¹å¯†ç ã€ç»‘å®šè®¾å¤‡ï¼šå¯†ç  + TOTP + çŸ­ä¿¡
â””â”€ å¤§é¢è½¬è´¦ï¼šå¯†ç  + TOTP + äººè„¸è¯†åˆ«

ç®¡ç†å‘˜æ“ä½œï¼š
â””â”€ æ‰€æœ‰æ“ä½œï¼šå¼ºåˆ¶MFA + å®¡æ‰¹æµç¨‹
```

**ğŸ”¹ ç”¨æˆ·ä½“éªŒä¼˜åŒ–**
```java
@Service
public class MfaService {
    
    // ä¿¡ä»»è®¾å¤‡åŠŸèƒ½
    public void trustDevice(String userId, String deviceId) {
        // 30å¤©å†…ä¿¡ä»»æ­¤è®¾å¤‡ï¼Œæ— éœ€MFA
        redisTemplate.opsForValue().set(
            "trusted:device:" + userId + ":" + deviceId,
            "trusted",
            30, TimeUnit.DAYS
        );
    }
    
    // æ£€æŸ¥æ˜¯å¦éœ€è¦MFA
    public boolean needMfa(String userId, String deviceId) {
        // æ£€æŸ¥è®¾å¤‡æ˜¯å¦å—ä¿¡ä»»
        String trusted = redisTemplate.opsForValue()
            .get("trusted:device:" + userId + ":" + deviceId);
        
        return trusted == null;  // ä¸å—ä¿¡ä»»åˆ™éœ€è¦MFA
    }
}
```

> âš ï¸ **æ³¨æ„äº‹é¡¹**ï¼š
> - æä¾›å¤‡ç”¨éªŒè¯æ–¹å¼ï¼ˆé˜²æ­¢æ‰‹æœºä¸¢å¤±ï¼‰
> - MFAä¸èƒ½å®Œå…¨æ›¿ä»£å¼ºå¯†ç ç­–ç•¥
> - è®°å½•æ‰€æœ‰MFAéªŒè¯æ—¥å¿—
> - å®šæœŸæé†’ç”¨æˆ·æ£€æŸ¥MFAè®¾ç½®

---

## 5. ğŸ“Š ç›‘æ§å‘Šè­¦ä½“ç³»


### 5.1 ä¸ºä»€ä¹ˆéœ€è¦ç›‘æ§å‘Šè­¦


**é€šä¿—ç†è§£**ï¼š
```
ç›‘æ§å‘Šè­¦ = ä¿å®‰çš„ç›‘æ§å®¤

æ²¡æœ‰ç›‘æ§ï¼š
å°å·è¿›æ¥äº†éƒ½ä¸çŸ¥é“ âŒ

æœ‰ç›‘æ§ä½†æ²¡äººçœ‹ï¼š
å½•ä¸‹æ¥äº†ä½†æ²¡åŠæ—¶å‘ç° âŒ

ç›‘æ§+å®æ—¶å‘Šè­¦ï¼š
å¼‚å¸¸ç«‹å³é€šçŸ¥ï¼Œå¿«é€Ÿå¤„ç† âœ…
```

### 5.2 ç›‘æ§æŒ‡æ ‡ä½“ç³»


**ğŸ”¸ å®‰å…¨ç›‘æ§æŒ‡æ ‡**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç›‘æ§ç»´åº¦ â”‚   å…³é”®æŒ‡æ ‡    â”‚   å‘Šè­¦é˜ˆå€¼      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç™»å½•å®‰å…¨ â”‚ å¤±è´¥æ¬¡æ•°      â”‚ 5æ¬¡/5åˆ†é’Ÿ       â”‚
â”‚          â”‚ å¼‚åœ°ç™»å½•      â”‚ ç«‹å³å‘Šè­¦        â”‚
â”‚          â”‚ æ–°è®¾å¤‡ç™»å½•    â”‚ ç«‹å³é€šçŸ¥        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Tokenå®‰å…¨â”‚ åˆ·æ–°é¢‘ç‡      â”‚ 10æ¬¡/åˆ†é’Ÿ       â”‚
â”‚          â”‚ è¿‡æœŸTokenä½¿ç”¨ â”‚ ç´¯è®¡5æ¬¡å‘Šè­¦     â”‚
â”‚          â”‚ Tokenæ³„éœ²æ£€æµ‹ â”‚ ç«‹å³å‘Šè­¦        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ¥å£å®‰å…¨ â”‚ è¯·æ±‚é¢‘ç‡      â”‚ 1000æ¬¡/åˆ†é’Ÿ     â”‚
â”‚          â”‚ é”™è¯¯ç‡        â”‚ è¶…è¿‡5%å‘Šè­¦      â”‚
â”‚          â”‚ å“åº”æ—¶é—´      â”‚ è¶…è¿‡3ç§’å‘Šè­¦     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”¸ ç›‘æ§å®ç°ç¤ºä¾‹**
```java
@Aspect
@Component
public class SecurityMonitorAspect {
    
    @Autowired
    private MetricsService metricsService;
    
    // ç™»å½•ç›‘æ§
    @Around("@annotation(LoginMonitor)")
    public Object monitorLogin(ProceedingJoinPoint pjp) throws Throwable {
        String username = getUsername(pjp);
        String ip = getClientIp();
        
        try {
            Object result = pjp.proceed();
            
            // è®°å½•æˆåŠŸç™»å½•
            metricsService.recordLoginSuccess(username, ip);
            return result;
            
        } catch (Exception e) {
            // è®°å½•å¤±è´¥ç™»å½•
            metricsService.recordLoginFailure(username, ip);
            
            // æ£€æŸ¥æ˜¯å¦è§¦å‘å‘Šè­¦
            checkLoginFailureAlert(username, ip);
            throw e;
        }
    }
    
    // æ£€æŸ¥ç™»å½•å¤±è´¥å‘Šè­¦
    private void checkLoginFailureAlert(String username, String ip) {
        // 5åˆ†é’Ÿå†…å¤±è´¥5æ¬¡è§¦å‘å‘Šè­¦
        long failures = redisTemplate.opsForValue()
            .increment("login:fail:" + username + ":" + ip);
        
        if (failures == 1) {
            // é¦–æ¬¡å¤±è´¥ï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´
            redisTemplate.expire("login:fail:" + username + ":" + ip, 
                5, TimeUnit.MINUTES);
        }
        
        if (failures >= 5) {
            // è§¦å‘å‘Šè­¦
            alertService.sendAlert("ç™»å½•å¼‚å¸¸", 
                String.format("ç”¨æˆ·%sä»IP%sè¿ç»­ç™»å½•å¤±è´¥5æ¬¡", username, ip));
        }
    }
}
```

### 5.3 æ—¥å¿—å®¡è®¡


**ğŸ”¹ å®¡è®¡æ—¥å¿—è®°å½•å†…å®¹**
```
å®Œæ•´çš„å®¡è®¡æ—¥å¿—åº”åŒ…å«ï¼š

Who - è°æ“ä½œçš„
â”œâ”€ ç”¨æˆ·ID
â”œâ”€ ç”¨æˆ·å
â””â”€ è§’è‰²æƒé™

When - ä»€ä¹ˆæ—¶å€™
â”œâ”€ æ“ä½œæ—¶é—´
â””â”€ æ—¶åŒºä¿¡æ¯

Where - åœ¨å“ªé‡Œ
â”œâ”€ IPåœ°å€
â”œâ”€ åœ°ç†ä½ç½®
â””â”€ è®¾å¤‡ä¿¡æ¯

What - åšäº†ä»€ä¹ˆ
â”œâ”€ æ“ä½œç±»å‹ï¼ˆç™»å½•ã€ä¿®æ”¹ã€åˆ é™¤ç­‰ï¼‰
â”œâ”€ æ¥å£è·¯å¾„
â”œâ”€ è¯·æ±‚å‚æ•°ï¼ˆè„±æ•ï¼‰
â””â”€ å“åº”ç»“æœ

How - æ€ä¹ˆåšçš„
â”œâ”€ æ“ä½œæ˜¯å¦æˆåŠŸ
â”œâ”€ å¤±è´¥åŸå› 
â””â”€ å½±å“èŒƒå›´
```

**ğŸ”¹ å®¡è®¡æ—¥å¿—å®ç°**
```java
@Aspect
@Component
public class AuditLogAspect {
    
    @Around("@annotation(AuditLog)")
    public Object logAudit(ProceedingJoinPoint pjp, AuditLog auditLog) throws Throwable {
        AuditLogEntity log = new AuditLogEntity();
        
        // Who - æ“ä½œäººä¿¡æ¯
        Authentication auth = SecurityContextHolder.getContext().getAuthentication();
        log.setUsername(auth.getName());
        log.setUserId(getUserId(auth));
        
        // When - æ—¶é—´ä¿¡æ¯
        log.setOperationTime(LocalDateTime.now());
        
        // Where - ä½ç½®ä¿¡æ¯
        HttpServletRequest request = getRequest();
        log.setIpAddress(request.getRemoteAddr());
        log.setUserAgent(request.getHeader("User-Agent"));
        
        // What - æ“ä½œä¿¡æ¯
        log.setOperation(auditLog.operation());
        log.setResource(auditLog.resource());
        log.setMethod(pjp.getSignature().getName());
        
        try {
            // æ‰§è¡Œæ–¹æ³•
            Object result = pjp.proceed();
            
            // è®°å½•æˆåŠŸ
            log.setSuccess(true);
            log.setResult("æ“ä½œæˆåŠŸ");
            
            return result;
        } catch (Exception e) {
            // è®°å½•å¤±è´¥
            log.setSuccess(false);
            log.setResult("æ“ä½œå¤±è´¥ï¼š" + e.getMessage());
            throw e;
        } finally {
            // ä¿å­˜å®¡è®¡æ—¥å¿—
            auditLogRepository.save(log);
        }
    }
}
```

### 5.4 å‘Šè­¦é€šçŸ¥æœºåˆ¶


**ğŸ”¹ å‘Šè­¦æ¸ é“é…ç½®**
```yaml
# å‘Šè­¦é…ç½®
alert:
  channels:
    # é‚®ä»¶å‘Šè­¦
    email:
      enabled: true
      recipients: 
        - security@company.com
        - admin@company.com
    
    # çŸ­ä¿¡å‘Šè­¦ï¼ˆç´§æ€¥æƒ…å†µï¼‰
    sms:
      enabled: true
      recipients:
        - "+86138****1234"
    
    # é’‰é’‰å‘Šè­¦
    dingtalk:
      enabled: true
      webhook: https://oapi.dingtalk.com/robot/send?access_token=xxx
    
    # ä¼ä¸šå¾®ä¿¡å‘Šè­¦
    wechat:
      enabled: true
      webhook: https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxx

  # å‘Šè­¦çº§åˆ«
  levels:
    critical: [sms, email, dingtalk, wechat]  # ä¸¥é‡ï¼šå…¨æ¸ é“é€šçŸ¥
    high: [email, dingtalk]                    # é«˜ï¼šé‚®ä»¶+é’‰é’‰
    medium: [dingtalk]                         # ä¸­ï¼šé’‰é’‰é€šçŸ¥
    low: [email]                               # ä½ï¼šä»…é‚®ä»¶
```

---

## 6. âš–ï¸ å®‰å…¨åˆè§„è¦æ±‚


### 6.1 ä¸»æµåˆè§„æ ‡å‡†


**ğŸ”¸ GDPRï¼ˆæ¬§ç›Ÿé€šç”¨æ•°æ®ä¿æŠ¤æ¡ä¾‹ï¼‰**
```
æ ¸å¿ƒè¦æ±‚ï¼š

âœ… æ•°æ®æœ€å°åŒ–åŸåˆ™
åªæ”¶é›†å¿…è¦çš„ç”¨æˆ·æ•°æ®

âœ… ç”¨æˆ·æƒåˆ©ä¿æŠ¤
â€¢ è®¿é—®æƒï¼šç”¨æˆ·å¯æŸ¥çœ‹è‡ªå·±çš„æ•°æ®
â€¢ åˆ é™¤æƒï¼šç”¨æˆ·å¯è¦æ±‚åˆ é™¤æ•°æ®
â€¢ ä¿®æ”¹æƒï¼šç”¨æˆ·å¯æ›´æ­£é”™è¯¯æ•°æ®
â€¢ æºå¸¦æƒï¼šç”¨æˆ·å¯å¯¼å‡ºæ•°æ®

âœ… å®‰å…¨ä¿éšœæªæ–½
â€¢ åŠ å¯†å­˜å‚¨æ•æ„Ÿæ•°æ®
â€¢ å®šæœŸå®‰å…¨å®¡è®¡
â€¢ æ•°æ®æ³„éœ²72å°æ—¶å†…é€šçŸ¥
```

**ğŸ”¸ ç­‰ä¿2.0ï¼ˆä¸­å›½ç½‘ç»œå®‰å…¨ç­‰çº§ä¿æŠ¤ï¼‰**
```
ç­‰çº§åˆ’åˆ†ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç­‰çº§ â”‚   ç³»ç»Ÿç±»å‹    â”‚    é˜²æŠ¤è¦æ±‚       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä¸€çº§ â”‚ ä¸€èˆ¬ç³»ç»Ÿ      â”‚ åŸºç¡€é˜²æŠ¤          â”‚
â”‚ äºŒçº§ â”‚ çœçº§ç³»ç»Ÿ      â”‚ åŸºæœ¬é˜²æŠ¤+å®¡è®¡     â”‚
â”‚ ä¸‰çº§ â”‚ é‡è¦ç³»ç»Ÿ      â”‚ å¼ºåŒ–é˜²æŠ¤+å¤‡ä»½     â”‚
â”‚ å››çº§ â”‚ ç‰¹åˆ«é‡è¦ç³»ç»Ÿ  â”‚ ä¸¥æ ¼é˜²æŠ¤+å®¹ç¾     â”‚
â”‚ äº”çº§ â”‚ æç«¯é‡è¦ç³»ç»Ÿ  â”‚ ä¸“ç”¨é˜²æŠ¤+éš”ç¦»     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¸‰çº§ç³»ç»Ÿè¦æ±‚ï¼š
â€¢ èº«ä»½é‰´åˆ«ï¼šåŒå› å­è®¤è¯
â€¢ è®¿é—®æ§åˆ¶ï¼šæœ€å°æƒé™åŸåˆ™
â€¢ å®‰å…¨å®¡è®¡ï¼šæ—¥å¿—ä¿å­˜6ä¸ªæœˆä»¥ä¸Š
â€¢ æ•°æ®å®Œæ•´æ€§ï¼šé˜²ç¯¡æ”¹æªæ–½
â€¢ æ•°æ®ä¿å¯†æ€§ï¼šåŠ å¯†å­˜å‚¨å’Œä¼ è¾“
```

### 6.2 åˆè§„å®æ–½æ¸…å•


**ğŸ“‹ OAuth2.0åˆè§„æ£€æŸ¥è¡¨**
```
â–¡ æ•°æ®ä¿æŠ¤
  â”œâ”€ â–¡ æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
  â”œâ”€ â–¡ ä¼ è¾“å±‚TLS/SSLåŠ å¯†
  â”œâ”€ â–¡ æ•°æ®åº“è®¿é—®æ§åˆ¶
  â””â”€ â–¡ å®šæœŸæ•°æ®å¤‡ä»½

â–¡ èº«ä»½è®¤è¯
  â”œâ”€ â–¡ å¼ºå¯†ç ç­–ç•¥
  â”œâ”€ â–¡ å¤šå› å­è®¤è¯MFA
  â”œâ”€ â–¡ è´¦å·é”å®šæœºåˆ¶
  â””â”€ â–¡ Sessionè¶…æ—¶æ§åˆ¶

â–¡ æˆæƒç®¡ç†
  â”œâ”€ â–¡ æœ€å°æƒé™åˆ†é…
  â”œâ”€ â–¡ Tokenæœ‰æ•ˆæœŸæ§åˆ¶
  â”œâ”€ â–¡ ScopeèŒƒå›´é™åˆ¶
  â””â”€ â–¡ å®šæœŸæƒé™å®¡æŸ¥

â–¡ å®¡è®¡è¿½æº¯
  â”œâ”€ â–¡ æ“ä½œæ—¥å¿—è®°å½•
  â”œâ”€ â–¡ ç™»å½•æ—¥å¿—è®°å½•
  â”œâ”€ â–¡ å¼‚å¸¸è¡Œä¸ºæ£€æµ‹
  â””â”€ â–¡ æ—¥å¿—é•¿æœŸå­˜å‚¨

â–¡ åº”æ€¥å“åº”
  â”œâ”€ â–¡ å®‰å…¨äº‹ä»¶é¢„æ¡ˆ
  â”œâ”€ â–¡ åº”æ€¥è”ç³»æœºåˆ¶
  â”œâ”€ â–¡ å®šæœŸæ¼”ç»ƒ
  â””â”€ â–¡ äº‹åå¤ç›˜æœºåˆ¶
```

### 6.3 åˆè§„è®¤è¯æµç¨‹


**ğŸ”¹ ç­‰ä¿ä¸‰çº§è®¤è¯æ­¥éª¤**
```
æ­¥éª¤1ï¼šå®šçº§å¤‡æ¡ˆ
â”œâ”€ ç¡®å®šç³»ç»Ÿç­‰çº§
â”œâ”€ ç¼–å†™å®šçº§æŠ¥å‘Š
â””â”€ å‘å…¬å®‰æœºå…³å¤‡æ¡ˆ

æ­¥éª¤2ï¼šå·®è·è¯„ä¼°
â”œâ”€ å¯¹ç…§æ ‡å‡†è‡ªæŸ¥
â”œâ”€ è¯†åˆ«å·®è·é¡¹
â””â”€ åˆ¶å®šæ•´æ”¹è®¡åˆ’

æ­¥éª¤3ï¼šæ•´æ”¹åŠ å›º
â”œâ”€ æŠ€æœ¯æªæ–½æ•´æ”¹
â”œâ”€ ç®¡ç†åˆ¶åº¦å®Œå–„
â””â”€ äººå‘˜åŸ¹è®­

æ­¥éª¤4ï¼šç­‰çº§æµ‹è¯„
â”œâ”€ é€‰æ‹©æµ‹è¯„æœºæ„
â”œâ”€ é…åˆç°åœºæµ‹è¯„
â””â”€ ä¿®å¤å‘ç°é—®é¢˜

æ­¥éª¤5ï¼šæŒç»­è¿è¥
â”œâ”€ å®šæœŸå¤è¯„
â”œâ”€ æŒç»­æ”¹è¿›
â””â”€ å¹´åº¦è‡ªæŸ¥
```

---

## 7. ğŸ›¡ï¸ æ•°æ®ä¿æŠ¤ç­–ç•¥


### 7.1 æ•æ„Ÿæ•°æ®è¯†åˆ«


**ğŸ”¸ æ•°æ®åˆ†ç±»åˆ†çº§**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ çº§åˆ« â”‚   æ•°æ®ç±»å‹      â”‚    ä¿æŠ¤æªæ–½       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å…¬å¼€ â”‚ ç”¨æˆ·æ˜µç§°        â”‚ æ— éœ€åŠ å¯†          â”‚
â”‚      â”‚ å¤´åƒ            â”‚                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å†…éƒ¨ â”‚ ç”¨æˆ·ID          â”‚ è®¿é—®æ§åˆ¶          â”‚
â”‚      â”‚ è®¢å•ç¼–å·        â”‚                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ•æ„Ÿ â”‚ æ‰‹æœºå·          â”‚ åŠ å¯†+è„±æ•         â”‚
â”‚      â”‚ é‚®ç®±            â”‚                   â”‚
â”‚      â”‚ èº«ä»½è¯          â”‚                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ ¸å¿ƒ â”‚ å¯†ç             â”‚ å“ˆå¸Œ+ç›å€¼         â”‚
â”‚      â”‚ æ”¯ä»˜å¯†ç         â”‚                   â”‚
â”‚      â”‚ é“¶è¡Œå¡å·        â”‚ å¼ºåŠ å¯†+éš”ç¦»å­˜å‚¨   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 åŠ å¯†ä¿æŠ¤å®è·µ


**ğŸ”¹ å¯†ç åŠ å¯†ï¼ˆBCryptï¼‰**
```java
@Service
public class PasswordService {
    
    private final BCryptPasswordEncoder encoder = new BCryptPasswordEncoder();
    
    // åŠ å¯†å¯†ç 
    public String encryptPassword(String rawPassword) {
        // BCryptè‡ªåŠ¨åŠ ç›ï¼Œæ¯æ¬¡ç»“æœéƒ½ä¸åŒ
        return encoder.encode(rawPassword);
    }
    
    // éªŒè¯å¯†ç 
    public boolean matches(String rawPassword, String encodedPassword) {
        return encoder.matches(rawPassword, encodedPassword);
    }
}

// å­˜å‚¨ç¤ºä¾‹ï¼š
åŸå§‹å¯†ç ï¼š123456
åŠ å¯†ç»“æœï¼š$2a$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcfl7p92ldGxad68LJZdL17lhWy
```

**ğŸ”¹ æ•æ„Ÿå­—æ®µåŠ å¯†ï¼ˆAESï¼‰**
```java
@Service
public class EncryptionService {
    
    private static final String ALGORITHM = "AES";
    private static final String KEY = "YourSecretKey123"; // å®é™…åº”ä»é…ç½®ä¸­å¿ƒè·å–
    
    // åŠ å¯†æ‰‹æœºå·
    public String encryptPhone(String phone) {
        try {
            Cipher cipher = Cipher.getInstance(ALGORITHM);
            SecretKeySpec keySpec = new SecretKeySpec(KEY.getBytes(), ALGORITHM);
            cipher.init(Cipher.ENCRYPT_MODE, keySpec);
            byte[] encrypted = cipher.doFinal(phone.getBytes());
            return Base64.getEncoder().encodeToString(encrypted);
        } catch (Exception e) {
            throw new RuntimeException("åŠ å¯†å¤±è´¥", e);
        }
    }
    
    // è§£å¯†æ‰‹æœºå·
    public String decryptPhone(String encryptedPhone) {
        try {
            Cipher cipher = Cipher.getInstance(ALGORITHM);
            SecretKeySpec keySpec = new SecretKeySpec(KEY.getBytes(), ALGORITHM);
            cipher.init(Cipher.DECRYPT_MODE, keySpec);
            byte[] decrypted = cipher.doFinal(Base64.getDecoder().decode(encryptedPhone));
            return new String(decrypted);
        } catch (Exception e) {
            throw new RuntimeException("è§£å¯†å¤±è´¥", e);
        }
    }
}
```

### 7.3 æ•°æ®è„±æ•ç­–ç•¥


**ğŸ”¹ è„±æ•è§„åˆ™**
```java
@Service
public class DataMaskingService {
    
    // æ‰‹æœºå·è„±æ•ï¼š138****5678
    public String maskPhone(String phone) {
        if (phone == null || phone.length() != 11) {
            return phone;
        }
        return phone.substring(0, 3) + "****" + phone.substring(7);
    }
    
    // èº«ä»½è¯è„±æ•ï¼š110101********1234
    public String maskIdCard(String idCard) {
        if (idCard == null || idCard.length() < 8) {
            return idCard;
        }
        return idCard.substring(0, 6) + "********" + idCard.substring(idCard.length() - 4);
    }
    
    // é‚®ç®±è„±æ•ï¼šus***@example.com
    public String maskEmail(String email) {
        if (email == null || !email.contains("@")) {
            return email;
        }
        String[] parts = email.split("@");
        String name = parts[0];
        if (name.length() <= 2) {
            return email;
        }
        return name.substring(0, 2) + "***@" + parts[1];
    }
    
    // é“¶è¡Œå¡è„±æ•ï¼š6222 **** **** 1234
    public String maskBankCard(String bankCard) {
        if (bankCard == null || bankCard.length() < 8) {
            return bankCard;
        }
        return bankCard.substring(0, 4) + " **** **** " + 
               bankCard.substring(bankCard.length() - 4);
    }
}
```

**ğŸ”¹ æ—¥å¿—è„±æ•**
```java
@Aspect
@Component
public class LogMaskingAspect {
    
    @Autowired
    private DataMaskingService maskingService;
    
    @Around("@annotation(LogMasking)")
    public Object maskLog(ProceedingJoinPoint pjp) throws Throwable {
        Object result = pjp.proceed();
        
        // å¯¹è¿”å›ç»“æœè„±æ•
        if (result instanceof UserDTO) {
            UserDTO user = (UserDTO) result;
            // è„±æ•å¤„ç†
            user.setPhone(maskingService.maskPhone(user.getPhone()));
            user.setEmail(maskingService.maskEmail(user.getEmail()));
            user.setIdCard(maskingService.maskIdCard(user.getIdCard()));
        }
        
        return result;
    }
}
```

### 7.4 æ•°æ®ç”Ÿå‘½å‘¨æœŸç®¡ç†


**ğŸ”¹ æ•°æ®ä¿ç•™ç­–ç•¥**
```
æ•°æ®ç±»å‹          ä¿ç•™æœŸé™        å¤„ç†æ–¹å¼
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ç”¨æˆ·æ•°æ®          è´¦å·æ³¨é”€å30å¤©  è‡ªåŠ¨åˆ é™¤
è®¢å•æ•°æ®          7å¹´            å½’æ¡£å­˜å‚¨
æ—¥å¿—æ•°æ®          6ä¸ªæœˆ          è‡ªåŠ¨æ¸…ç†
Tokenæ•°æ®         è¿‡æœŸåç«‹å³      è‡ªåŠ¨æ¸…ç†
å®¡è®¡æ—¥å¿—          10å¹´           é•¿æœŸå­˜å‚¨
```

**ğŸ”¹ è‡ªåŠ¨æ¸…ç†ä»»åŠ¡**
```java
@Component
public class DataCleanupScheduler {
    
    // æ¯å¤©å‡Œæ™¨3ç‚¹æ¸…ç†è¿‡æœŸToken
    @Scheduled(cron = "0 0 3 * * ?")
    public void cleanExpiredTokens() {
        tokenRepository.deleteExpiredTokens(LocalDateTime.now());
        log.info("æ¸…ç†è¿‡æœŸTokenå®Œæˆ");
    }
    
    // æ¯æœˆ1å·æ¸…ç†6ä¸ªæœˆå‰çš„æ—¥å¿—
    @Scheduled(cron = "0 0 0 1 * ?")
    public void cleanOldLogs() {
        LocalDateTime cutoffDate = LocalDateTime.now().minusMonths(6);
        logRepository.deleteLogsBefore(cutoffDate);
        log.info("æ¸…ç†å†å²æ—¥å¿—å®Œæˆ");
    }
    
    // æ¯å¤©æ£€æŸ¥å¾…åˆ é™¤è´¦å·
    @Scheduled(cron = "0 0 2 * * ?")
    public void cleanDeletedAccounts() {
        // æ³¨é”€30å¤©åçš„è´¦å·
        LocalDateTime cutoffDate = LocalDateTime.now().minusDays(30);
        List<User> deletedUsers = userRepository.findDeletedBefore(cutoffDate);
        
        for (User user : deletedUsers) {
            // æ°¸ä¹…åˆ é™¤ç”¨æˆ·æ•°æ®
            userRepository.permanentDelete(user.getId());
            log.info("æ°¸ä¹…åˆ é™¤ç”¨æˆ·ï¼š{}", user.getUsername());
        }
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å®‰å…¨åˆè§„çš„äº”å¤§æ”¯æŸ±


```
ğŸ” æœ€å°æƒé™åŸåˆ™
â”œâ”€ åªç»™å¿…è¦æƒé™ï¼Œä¸å¤šç»™ä¸€ç‚¹
â”œâ”€ åŸºäºè§’è‰²ç»†åŒ–æƒé™åˆ†é…
â”œâ”€ å®šæœŸå®¡æŸ¥å›æ”¶æƒé™
â””â”€ æƒé™å˜æ›´å¿…é¡»å®¡æ‰¹

ğŸ”’ HTTPSå…¨è¦†ç›–
â”œâ”€ æ‰€æœ‰æ¥å£å¼ºåˆ¶HTTPS
â”œâ”€ é…ç½®å®‰å…¨å“åº”å¤´
â”œâ”€ å®šæœŸæ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæœŸ
â””â”€ æµ‹è¯•ç¯å¢ƒä¹Ÿè¦HTTPS

ğŸ”‘ å¤šå› å­è®¤è¯MFA
â”œâ”€ é«˜é£é™©æ“ä½œå¼ºåˆ¶MFA
â”œâ”€ æ”¯æŒå¤šç§MFAæ–¹å¼
â”œâ”€ ä¿¡ä»»è®¾å¤‡ä¼˜åŒ–ä½“éªŒ
â””â”€ æä¾›å¤‡ç”¨éªŒè¯æ–¹å¼

ğŸ“Š ç›‘æ§å‘Šè­¦ä½“ç³»
â”œâ”€ å…¨æ–¹ä½å®‰å…¨ç›‘æ§
â”œâ”€ å®æ—¶å¼‚å¸¸å‘Šè­¦
â”œâ”€ å®Œæ•´å®¡è®¡æ—¥å¿—
â””â”€ å¤šæ¸ é“å‘Šè­¦é€šçŸ¥

ğŸ›¡ï¸ æ•°æ®ä¿æŠ¤ç­–ç•¥
â”œâ”€ æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
â”œâ”€ ä¼ è¾“è¿‡ç¨‹åŠ å¯†
â”œâ”€ æ—¥å¿—å’Œæ¥å£è„±æ•
â””â”€ æ•°æ®ç”Ÿå‘½å‘¨æœŸç®¡ç†
```

### 8.2 å®æ–½è·¯çº¿å›¾


**ğŸ”¹ é˜¶æ®µ1ï¼šåŸºç¡€é˜²æŠ¤ï¼ˆ1-2å‘¨ï¼‰**
```
âœ… é…ç½®HTTPSè¯ä¹¦
âœ… å®ç°å¯†ç åŠ å¯†å­˜å‚¨
âœ… æ·»åŠ åŸºæœ¬è®¿é—®æ§åˆ¶
âœ… é…ç½®æ—¥å¿—è®°å½•
```

**ğŸ”¹ é˜¶æ®µ2ï¼šå¢å¼ºå®‰å…¨ï¼ˆ2-4å‘¨ï¼‰**
```
âœ… å®æ–½æœ€å°æƒé™åŸåˆ™
âœ… é›†æˆMFAè®¤è¯
âœ… å®Œå–„å®¡è®¡æ—¥å¿—
âœ… æ•æ„Ÿæ•°æ®åŠ å¯†
```

**ğŸ”¹ é˜¶æ®µ3ï¼šå…¨é¢åˆè§„ï¼ˆ1-2æœˆï¼‰**
```
âœ… å»ºç«‹ç›‘æ§å‘Šè­¦ä½“ç³»
âœ… æ•°æ®åˆ†ç±»åˆ†çº§
âœ… åˆè§„æ£€æŸ¥è‡ªæŸ¥
âœ… ç­‰ä¿è®¤è¯å‡†å¤‡
```

**ğŸ”¹ é˜¶æ®µ4ï¼šæŒç»­ä¼˜åŒ–ï¼ˆé•¿æœŸï¼‰**
```
âœ… å®šæœŸå®‰å…¨å®¡è®¡
âœ… åº”æ€¥æ¼”ç»ƒ
âœ… äººå‘˜åŸ¹è®­
âœ… æŠ€æœ¯æ›´æ–°è¿­ä»£
```

### 8.3 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ


**â“ MFAä¼šä¸ä¼šå½±å“ç”¨æˆ·ä½“éªŒï¼Ÿ**
```
è§£å†³æ–¹æ¡ˆï¼š
â€¢ ä¿¡ä»»è®¾å¤‡æœºåˆ¶ï¼šå¸¸ç”¨è®¾å¤‡30å¤©å…éªŒè¯
â€¢ é£é™©è¯„ä¼°ï¼šä½é£é™©æ“ä½œä¸å¼ºåˆ¶MFA
â€¢ å¤šç§æ–¹å¼ï¼šæä¾›çŸ­ä¿¡ã€TOTPç­‰å¤šç§é€‰æ‹©
â€¢ å¤‡ç”¨æ–¹æ¡ˆï¼šæ‰‹æœºä¸¢å¤±æ—¶çš„å¤‡ç”¨éªŒè¯æ–¹å¼
```

**â“ å¦‚ä½•å¹³è¡¡å®‰å…¨å’Œæ€§èƒ½ï¼Ÿ**
```
è§£å†³æ–¹æ¡ˆï¼š
â€¢ ç¼“å­˜ä¼˜åŒ–ï¼šæƒé™ä¿¡æ¯ç¼“å­˜åˆ°Redis
â€¢ å¼‚æ­¥å¤„ç†ï¼šæ—¥å¿—è®°å½•å¼‚æ­¥å†™å…¥
â€¢ åˆ†çº§ç­–ç•¥ï¼šæ ¹æ®é£é™©ç­‰çº§åŒºåˆ«å¯¹å¾…
â€¢ åˆç†é…ç½®ï¼šç›‘æ§æŒ‡æ ‡ä¸è¦è¿‡äºé¢‘ç¹
```

**â“ å°å›¢é˜Ÿå¦‚ä½•å®æ–½å®‰å…¨åˆè§„ï¼Ÿ**
```
è§£å†³æ–¹æ¡ˆï¼š
â€¢ ä¼˜å…ˆçº§ï¼šå…ˆåšæ ¸å¿ƒå®‰å…¨æªæ–½
â€¢ å¼€æºå·¥å…·ï¼šä½¿ç”¨æˆç†Ÿçš„å¼€æºæ–¹æ¡ˆ
â€¢ äº‘æœåŠ¡ï¼šåˆ©ç”¨äº‘å‚å•†çš„å®‰å…¨èƒ½åŠ›
â€¢ åˆ†æ­¥å®æ–½ï¼šæŒ‰é˜¶æ®µé€æ­¥å®Œå–„
```

### 8.4 æ ¸å¿ƒè®°å¿†è¦ç‚¹


> ğŸ’¡ **å®‰å…¨åˆè§„ä¸‰åŸåˆ™**ï¼š
> - **é˜²æ‚£äºæœªç„¶**ï¼šäº‹å‰é¢„é˜²èƒœäºäº‹åè¡¥æ•‘
> - **æœ€å°åŒ–åŸåˆ™**ï¼šæƒé™æœ€å°ã€æ•°æ®æœ€å°‘ã€æš´éœ²æœ€å°
> - **å…¨ç¨‹å¯è¿½æº¯**ï¼šæ‰€æœ‰æ“ä½œéƒ½æœ‰æ—¥å¿—å¯æŸ¥

> ğŸ”¥ **é‡ç‚¹è®°å¿†**ï¼š
> - HTTPSä¸æ˜¯å¯é€‰é¡¹ï¼Œæ˜¯å¿…é€‰é¡¹
> - å¯†ç å¿…é¡»åŠ å¯†å­˜å‚¨ï¼Œç»ä¸æ˜æ–‡
> - æ•æ„Ÿæ•°æ®åŠ å¯†+è„±æ•åŒé‡ä¿æŠ¤
> - æ—¥å¿—è¦è®°å½•ï¼Œä½†è¦ä¿æŠ¤éšç§
> - ç›‘æ§å‘Šè­¦æ˜¯å®‰å…¨çš„çœ¼ç›å’Œè€³æœµ

> âš ï¸ **å¸¸è§è¯¯åŒº**ï¼š
> - âŒ æµ‹è¯•ç¯å¢ƒä¸éœ€è¦å®‰å…¨æªæ–½
> - âŒ å°é¡¹ç›®ä¸éœ€è¦è€ƒè™‘åˆè§„
> - âŒ æœ‰äº†MFAå°±ä¸‡æ— ä¸€å¤±
> - âŒ åŠ å¯†å°±ä¸€å®šå®‰å…¨
> - âŒ åˆè§„æ˜¯ä¸€æ¬¡æ€§å·¥ä½œ

**å®‰å…¨æ˜¯æŒç»­çš„è¿‡ç¨‹ï¼Œä¸æ˜¯ä¸€æ¬¡æ€§çš„ä»»åŠ¡ã€‚ä¿æŒè­¦æƒ•ï¼ŒæŒç»­æ”¹è¿›ï¼** ğŸ›¡ï¸