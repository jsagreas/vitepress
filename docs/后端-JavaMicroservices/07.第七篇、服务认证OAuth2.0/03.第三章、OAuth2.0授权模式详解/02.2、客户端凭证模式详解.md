---
title: 2ã€å®¢æˆ·ç«¯å‡­è¯æ¨¡å¼è¯¦è§£
---
## ğŸ“š ç›®å½•

1. [å®¢æˆ·ç«¯å‡­è¯æ¨¡å¼æ¦‚è¿°](#1-å®¢æˆ·ç«¯å‡­è¯æ¨¡å¼æ¦‚è¿°)
2. [æ ¸å¿ƒæ¦‚å¿µè§£æ](#2-æ ¸å¿ƒæ¦‚å¿µè§£æ)
3. [å·¥ä½œæµç¨‹è¯¦è§£](#3-å·¥ä½œæµç¨‹è¯¦è§£)
4. [å¾®æœåŠ¡åœºæ™¯åº”ç”¨](#4-å¾®æœåŠ¡åœºæ™¯åº”ç”¨)
5. [å‡­è¯ç®¡ç†ä¸å®‰å…¨](#5-å‡­è¯ç®¡ç†ä¸å®‰å…¨)
6. [å®æˆ˜é…ç½®æŒ‡å—](#6-å®æˆ˜é…ç½®æŒ‡å—)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ å®¢æˆ·ç«¯å‡­è¯æ¨¡å¼æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯å®¢æˆ·ç«¯å‡­è¯æ¨¡å¼


**é€šä¿—ç†è§£**ï¼šå°±åƒå…¬å¸å†…éƒ¨ç³»ç»Ÿä¹‹é—´æ‰“ç”µè¯ï¼Œä¸éœ€è¦å…·ä½“æ˜¯å“ªä¸ªå‘˜å·¥ï¼Œåªè¦ç¡®è®¤æ˜¯æœ¬å…¬å¸çš„ç³»ç»Ÿå°±è¡Œã€‚

```
æ—¥å¸¸åœºæ™¯ç±»æ¯”ï¼š
é“¶è¡ŒATMæœº â†â†’ é“¶è¡Œåå°ç³»ç»Ÿ
- ATMä¸ä»£è¡¨æŸä¸ªå…·ä½“ç”¨æˆ·
- å®ƒä»£è¡¨é“¶è¡Œè‡ªå·±çš„è®¾å¤‡
- ç”¨è®¾å¤‡ä¸“å±å¯†ç éªŒè¯èº«ä»½
- éªŒè¯é€šè¿‡åå¯ä»¥è®¿é—®ç³»ç»Ÿæ•°æ®

å¾®æœåŠ¡åœºæ™¯ï¼š
è®¢å•æœåŠ¡ â†â†’ åº“å­˜æœåŠ¡
- ä¸æ˜¯æŸä¸ªç”¨æˆ·åœ¨è°ƒç”¨
- æ˜¯è®¢å•ç³»ç»Ÿæœ¬èº«éœ€è¦æŸ¥è¯¢åº“å­˜
- ç”¨æœåŠ¡ä¸“å±å‡­è¯éªŒè¯èº«ä»½
- éªŒè¯é€šè¿‡åå¯ä»¥æ“ä½œåº“å­˜æ•°æ®
```

**æ ¸å¿ƒå®šä¹‰**ï¼š
```
Client Credentialsï¼ˆå®¢æˆ·ç«¯å‡­è¯æ¨¡å¼ï¼‰
= æœåŠ¡ä¸æœåŠ¡ä¹‹é—´çš„èº«ä»½è®¤è¯æ–¹å¼
= ä¸æ¶‰åŠç”¨æˆ·çš„åå°ç³»ç»Ÿé€šä¿¡
= æœºå™¨å¯¹æœºå™¨çš„æˆæƒæ¨¡å¼
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦è¿™ç§æ¨¡å¼


**è§£å†³çš„æ ¸å¿ƒé—®é¢˜**ï¼š
```
é—®é¢˜åœºæ™¯ï¼š
è®¢å•æœåŠ¡éœ€è¦è°ƒç”¨åº“å­˜æœåŠ¡æŸ¥è¯¢å•†å“æ•°é‡

âŒ é”™è¯¯åšæ³•ï¼š
- ç›´æ¥è°ƒç”¨ï¼Œæ— ä»»ä½•éªŒè¯
- é£é™©ï¼šä»»ä½•äººéƒ½èƒ½è°ƒç”¨åº“å­˜æ¥å£

âŒ ä¸åˆé€‚çš„åšæ³•ï¼š
- ç”¨ç”¨æˆ·çš„èº«ä»½å»è°ƒç”¨
- é—®é¢˜ï¼šåå°ä»»åŠ¡æ²¡æœ‰ç”¨æˆ·ï¼Œæ€ä¹ˆåŠï¼Ÿ

âœ… æ­£ç¡®åšæ³•ï¼ˆå®¢æˆ·ç«¯å‡­è¯æ¨¡å¼ï¼‰ï¼š
- è®¢å•æœåŠ¡æœ‰è‡ªå·±çš„èº«ä»½å‡­è¯
- è°ƒç”¨å‰å…ˆç”¨å‡­è¯è·å–è®¿é—®ä»¤ç‰Œ
- ç”¨ä»¤ç‰Œè°ƒç”¨åº“å­˜æœåŠ¡
- åº“å­˜æœåŠ¡éªŒè¯ä»¤ç‰Œçš„åˆæ³•æ€§
```

**é€‚ç”¨åœºæ™¯ç‰¹å¾**ï¼š
```
âœ“ æœåŠ¡é—´åå°è°ƒç”¨
âœ“ å®šæ—¶ä»»åŠ¡æ‰§è¡Œ
âœ“ æ‰¹é‡æ•°æ®å¤„ç†
âœ“ ç³»ç»Ÿç›‘æ§å‘Šè­¦
âœ“ æ—¥å¿—æ•°æ®ä¸ŠæŠ¥

å…³é”®ç‰¹ç‚¹ï¼šæ²¡æœ‰ç”¨æˆ·å‚ä¸ï¼
```

### 1.3 ä¸å…¶ä»–æ¨¡å¼çš„åŒºåˆ«


| å¯¹æ¯”ç»´åº¦ | **å®¢æˆ·ç«¯å‡­è¯æ¨¡å¼** | **æˆæƒç æ¨¡å¼** | **å¯†ç æ¨¡å¼** |
|---------|------------------|---------------|-------------|
| **ä½¿ç”¨åœºæ™¯** | æœåŠ¡é—´è°ƒç”¨ | ç”¨æˆ·æˆæƒç¬¬ä¸‰æ–¹ | ç”¨æˆ·ç™»å½•è‡ªå®¶ç³»ç»Ÿ |
| **æœ‰æ— ç”¨æˆ·** | âŒ æ— ç”¨æˆ·å‚ä¸ | âœ… éœ€è¦ç”¨æˆ·æˆæƒ | âœ… éœ€è¦ç”¨æˆ·å‡­è¯ |
| **èº«ä»½ä¸»ä½“** | åº”ç”¨æœ¬èº« | ç”¨æˆ· | ç”¨æˆ· |
| **å…¸å‹åœºæ™¯** | å¾®æœåŠ¡é€šä¿¡ | å¾®ä¿¡ç™»å½• | APPç™»å½• |
| **å®‰å…¨çº§åˆ«** | é«˜ï¼ˆåå°é€šä¿¡ï¼‰ | æœ€é«˜ï¼ˆå¤šæ¬¡éªŒè¯ï¼‰ | ä¸­ï¼ˆéœ€ä¿æŠ¤å¯†ç ï¼‰ |

---

## 2. ğŸ”‘ æ ¸å¿ƒæ¦‚å¿µè§£æ


### 2.1 Client IDï¼ˆå®¢æˆ·ç«¯æ ‡è¯†ï¼‰


**æ˜¯ä»€ä¹ˆ**ï¼šåº”ç”¨çš„å”¯ä¸€èº«ä»½è¯å·

```
ç°å®ç±»æ¯”ï¼š
å°±åƒä½ çš„èº«ä»½è¯å·ç 
- å…¨å›½å”¯ä¸€ï¼Œæ ‡è¯†ä½ çš„èº«ä»½
- å…¬å¼€ä¿¡æ¯ï¼Œåˆ«äººå¯ä»¥çœ‹åˆ°
- ä½†å…‰æœ‰å·ç ä¸èƒ½è¯æ˜ä½ æ˜¯ä½ 

å¾®æœåŠ¡ä¸­çš„Client IDï¼š
è®¢å•æœåŠ¡çš„IDï¼šorder-service
åº“å­˜æœåŠ¡çš„IDï¼šinventory-service
æ”¯ä»˜æœåŠ¡çš„IDï¼špayment-service

ä½œç”¨ï¼š
âœ“ æ ‡è¯†æ˜¯å“ªä¸ªæœåŠ¡åœ¨è¯·æ±‚
âœ“ åŒºåˆ†ä¸åŒçš„åº”ç”¨ç³»ç»Ÿ
âœ“ å¯ä»¥å…¬å¼€ï¼Œä¸æ˜¯ç§˜å¯†
```

**é…ç½®ç¤ºä¾‹**ï¼š
```yaml
# è®¢å•æœåŠ¡çš„é…ç½®
spring:
  security:
    oauth2:
      client:
        registration:
          order-client:
            client-id: order-service-client    # æœåŠ¡çš„èº«ä»½æ ‡è¯†
            client-name: è®¢å•æœåŠ¡å®¢æˆ·ç«¯
```

### 2.2 Client Secretï¼ˆå®¢æˆ·ç«¯å¯†é’¥ï¼‰


**æ˜¯ä»€ä¹ˆ**ï¼šåº”ç”¨çš„ä¸“å±å¯†ç ï¼Œè¯æ˜ä½ çœŸçš„æ˜¯è¿™ä¸ªåº”ç”¨

```
ç°å®ç±»æ¯”ï¼š
å°±åƒä½ çš„èº«ä»½è¯å¯†ç æˆ–æŒ‡çº¹
- åªæœ‰ä½ çŸ¥é“ï¼Œç»å¯¹ä¿å¯†
- ç»“åˆèº«ä»½è¯å·æ‰èƒ½è¯æ˜èº«ä»½
- æ³„éœ²äº†å°±å±é™©äº†

å¾®æœåŠ¡ä¸­çš„Client Secretï¼š
è®¢å•æœåŠ¡çš„Secretï¼ša8f3c2e9b7d4...ï¼ˆéšæœºç”Ÿæˆçš„å¯†æ–‡ï¼‰

å…³é”®ç‰¹æ€§ï¼š
âš ï¸ ç»å¯¹ä¿å¯†ï¼Œä¸èƒ½æ³„éœ²
âš ï¸ ä¸èƒ½å†™åœ¨å‰ç«¯ä»£ç é‡Œ
âš ï¸ ä¸èƒ½æäº¤åˆ°Gitä»“åº“
âœ“ åº”è¯¥ç”¨ç¯å¢ƒå˜é‡æˆ–é…ç½®ä¸­å¿ƒç®¡ç†
```

**å®‰å…¨é…ç½®**ï¼š
```yaml
# âŒ é”™è¯¯ï¼šç›´æ¥å†™æ­»åœ¨é…ç½®æ–‡ä»¶
client-secret: my-secret-123

# âœ… æ­£ç¡®ï¼šä½¿ç”¨ç¯å¢ƒå˜é‡
client-secret: ${CLIENT_SECRET}

# âœ… æ›´å¥½ï¼šä½¿ç”¨é…ç½®ä¸­å¿ƒåŠ å¯†å­˜å‚¨
client-secret: {cipher}AQABC...åŠ å¯†åçš„å¯†æ–‡
```

### 2.3 Client Credentials Grantï¼ˆå®¢æˆ·ç«¯å‡­è¯æˆæƒï¼‰


**å®Œæ•´ç†è§£**ï¼š
```
Client Credentials = Client ID + Client Secret
å°±åƒ èº«ä»½è¯å· + å¯†ç /æŒ‡çº¹ = å®Œæ•´èº«ä»½è®¤è¯

æˆæƒæµç¨‹ï¼š
1. æˆ‘æ˜¯è®¢å•æœåŠ¡ï¼ˆClient IDï¼‰
2. è¿™æ˜¯æˆ‘çš„å¯†é’¥ï¼ˆClient Secretï¼‰
3. è¯·ç»™æˆ‘è®¿é—®ä»¤ç‰Œï¼ˆAccess Tokenï¼‰
4. æˆ‘è¦è°ƒç”¨åº“å­˜æœåŠ¡ï¼ˆä½¿ç”¨Tokenè®¿é—®ï¼‰
```

**æ ¸å¿ƒæµç¨‹å›¾**ï¼š
```
è®¢å•æœåŠ¡                    è®¤è¯æœåŠ¡å™¨                  åº“å­˜æœåŠ¡
   |                           |                          |
   |--[1]æˆ‘æ˜¯order-service---->|                          |
   |   å¯†é’¥ï¼šxxx123            |                          |
   |                           |                          |
   |                      [2]éªŒè¯èº«ä»½                      |
   |                       Client IDæ­£ç¡®?                  |
   |                       SecretåŒ¹é…?                     |
   |                           |                          |
   |<--[3]ç»™ä½ è®¿é—®ä»¤ç‰Œ---------|                          |
   |   Token: abc.def.ghi      |                          |
   |                           |                          |
   |--[4]è°ƒç”¨æ¥å£--------------|------------------------>|
   |   æºå¸¦Token               |                          |
   |                           |                     [5]éªŒè¯Token
   |                           |                          |
   |<--[6]è¿”å›åº“å­˜æ•°æ®---------|--------------------------|
   |   {stock: 100}            |                          |
```

### 2.4 Access Tokenï¼ˆè®¿é—®ä»¤ç‰Œï¼‰


**æ˜¯ä»€ä¹ˆ**ï¼šä¸´æ—¶é€šè¡Œè¯

```
ç°å®ç±»æ¯”ï¼š
å°±åƒæ¸¸ä¹åœºçš„æ‰‹ç¯
- ä¹°ç¥¨åæˆ´ä¸Šæ‰‹ç¯
- å‡­æ‰‹ç¯å¯ä»¥ç©æ‰€æœ‰é¡¹ç›®
- æ‰‹ç¯æœ‰æœ‰æ•ˆæœŸï¼Œè¿‡æœŸéœ€é‡æ–°è´­ä¹°

å¾®æœåŠ¡ä¸­çš„Tokenï¼š
eyJhbGc...ï¼ˆä¸€ä¸²åŠ å¯†å­—ç¬¦ä¸²ï¼‰

Tokenç‰¹æ€§ï¼š
âœ“ æœ‰æ•ˆæœŸé™åˆ¶ï¼ˆå¦‚1å°æ—¶ï¼‰
âœ“ åŒ…å«æƒé™ä¿¡æ¯ï¼ˆèƒ½è®¿é—®å“ªäº›æ¥å£ï¼‰
âœ“ æ— éœ€å†æ¬¡è¾“å…¥å¯†ç 
âœ“ è¿‡æœŸåéœ€é‡æ–°è·å–
```

**Tokenå†…å®¹è§£æ**ï¼š
```json
// Tokenè§£å¯†åçš„å†…å®¹ï¼ˆJWTæ ¼å¼ï¼‰
{
  "client_id": "order-service",      // å“ªä¸ªæœåŠ¡
  "scope": ["inventory.read"],       // æœ‰ä»€ä¹ˆæƒé™
  "exp": 1695456789,                 // ä»€ä¹ˆæ—¶å€™è¿‡æœŸ
  "authorities": ["ROLE_SERVICE"]    // è§’è‰²ä¿¡æ¯
}
```

---

## 3. ğŸ”„ å·¥ä½œæµç¨‹è¯¦è§£


### 3.1 å®Œæ•´äº¤äº’æµç¨‹


**æ­¥éª¤åˆ†è§£**ï¼š

```
ç¬¬ä¸€æ­¥ï¼šæœåŠ¡å¯åŠ¨æ—¶å‡†å¤‡å‡­è¯
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®¢å•æœåŠ¡é…ç½®ï¼š                   â”‚
â”‚ â€¢ Client ID: order-service      â”‚
â”‚ â€¢ Client Secret: xxx123         â”‚
â”‚ â€¢ Tokenç«¯ç‚¹: /oauth/token       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¬¬äºŒæ­¥ï¼šéœ€è¦è°ƒç”¨å…¶ä»–æœåŠ¡æ—¶
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®¢å•æœåŠ¡ â†’ è®¤è¯æœåŠ¡å™¨            â”‚
â”‚                                 â”‚
â”‚ POST /oauth/token               â”‚
â”‚ grant_type=client_credentials   â”‚
â”‚ client_id=order-service         â”‚
â”‚ client_secret=xxx123            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¬¬ä¸‰æ­¥ï¼šè®¤è¯æœåŠ¡å™¨éªŒè¯å‡­è¯
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ éªŒè¯é¡¹ï¼š                         â”‚
â”‚ âœ“ Client IDæ˜¯å¦å­˜åœ¨              â”‚
â”‚ âœ“ Client Secretæ˜¯å¦åŒ¹é…          â”‚
â”‚ âœ“ è¯¥æœåŠ¡æ˜¯å¦æœ‰è¯·æ±‚çš„æƒé™          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¬¬å››æ­¥ï¼šè¿”å›è®¿é—®ä»¤ç‰Œ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ {                               â”‚
â”‚   "access_token": "abc.def.ghi",â”‚
â”‚   "token_type": "Bearer",       â”‚
â”‚   "expires_in": 3600,           â”‚
â”‚   "scope": "inventory.read"     â”‚
â”‚ }                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¬¬äº”æ­¥ï¼šä½¿ç”¨ä»¤ç‰Œè°ƒç”¨ç›®æ ‡æœåŠ¡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®¢å•æœåŠ¡ â†’ åº“å­˜æœåŠ¡              â”‚
â”‚                                 â”‚
â”‚ GET /api/inventory/product/123  â”‚
â”‚ Authorization: Bearer abc.def..â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¬¬å…­æ­¥ï¼šç›®æ ‡æœåŠ¡éªŒè¯ä»¤ç‰Œ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åº“å­˜æœåŠ¡éªŒè¯ï¼š                   â”‚
â”‚ âœ“ Tokenæ˜¯å¦æœ‰æ•ˆ                 â”‚
â”‚ âœ“ Tokenæ˜¯å¦è¿‡æœŸ                 â”‚
â”‚ âœ“ Tokenæ˜¯å¦æœ‰è®¿é—®æƒé™            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ—¶åºå›¾è¯¦è§£


```
æ—¶é—´è½´    è®¢å•æœåŠ¡          è®¤è¯ä¸­å¿ƒ          åº“å­˜æœåŠ¡
  |          |                |                |
  |    [ä¸šåŠ¡è§¦å‘]              |                |
  |    éœ€è¦æŸ¥è¯¢åº“å­˜            |                |
  |          |                |                |
  â†“    [æ­¥éª¤1ï¼šè·å–Token]      |                |
  |          |--------------->|                |
  |          | POST /token    |                |
  |          | client_id      |                |
  |          | client_secret  |                |
  |          |                |                |
  â†“          |          [éªŒè¯å‡­è¯]             |
  |          |           èº«ä»½ç¡®è®¤              |
  |          |                |                |
  â†“          |<---------------|                |
  |          | 200 OK         |                |
  |          | access_token   |                |
  |          |                |                |
  â†“    [æ­¥éª¤2ï¼šè°ƒç”¨API]        |                |
  |          |----------------|--------------->|
  |          |                | GET /inventory |
  |          |                | Bearer Token   |
  |          |                |                |
  â†“          |                |         [éªŒè¯Token]
  |          |                |          æ£€æŸ¥æƒé™
  |          |                |                |
  â†“          |<---------------|----------------|
  |          |                |    200 OK      |
  |          |                |  {stock: 100}  |
  |          |                |                |
  â†“    [å®Œæˆä¸šåŠ¡å¤„ç†]          |                |
```

### 3.3 Tokençš„ç”Ÿå‘½å‘¨æœŸ


**ä»åˆ›å»ºåˆ°å¤±æ•ˆçš„å®Œæ•´è¿‡ç¨‹**ï¼š

```
Tokenç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼š

T0æ—¶åˆ»ï¼šTokenåˆ›å»º
â”œâ”€ è®¢å•æœåŠ¡è¯·æ±‚Token
â”œâ”€ è®¤è¯æœåŠ¡å™¨é¢å‘Token
â””â”€ Tokenæœ‰æ•ˆæœŸï¼š3600ç§’ï¼ˆ1å°æ—¶ï¼‰

T0 â†’ T3600ï¼šTokenä½¿ç”¨æœŸ
â”œâ”€ è®¢å•æœåŠ¡ç¼“å­˜Token
â”œâ”€ é‡å¤ä½¿ç”¨åŒä¸€Token
â”œâ”€ é¿å…é¢‘ç¹è¯·æ±‚æ–°Token
â””â”€ æå‡ç³»ç»Ÿæ€§èƒ½

T3600æ—¶åˆ»ï¼šTokenå³å°†è¿‡æœŸ
â”œâ”€ æ–¹æ¡ˆ1ï¼šç­‰è¿‡æœŸäº†å†ç”³è¯·
â”œâ”€ æ–¹æ¡ˆ2ï¼šæå‰5åˆ†é’Ÿåˆ·æ–°
â””â”€ æ–¹æ¡ˆ3ï¼šå¹¶å‘è¯·æ±‚æ—¶åŠ é”

T3600+ï¼šTokenå·²è¿‡æœŸ
â”œâ”€ ä½¿ç”¨è¿‡æœŸToken â†’ 401é”™è¯¯
â”œâ”€ æ•è·401 â†’ é‡æ–°è·å–Token
â””â”€ ç”¨æ–°Tokené‡è¯•è¯·æ±‚
```

**å®é™…å¤„ç†ç­–ç•¥**ï¼š

```java
// Tokenç®¡ç†å™¨ï¼ˆä¼ªä»£ç ç¤ºä¾‹ï¼‰
class TokenManager {
    private String currentToken;
    private long expireTime;
    
    // è·å–å¯ç”¨çš„Token
    String getValidToken() {
        // æ£€æŸ¥Tokenæ˜¯å¦å³å°†è¿‡æœŸï¼ˆæå‰5åˆ†é’Ÿï¼‰
        if (currentToken == null || 
            System.currentTimeMillis() > expireTime - 300000) {
            // é‡æ–°è·å–Token
            refreshToken();
        }
        return currentToken;
    }
    
    // åˆ·æ–°Token
    void refreshToken() {
        // è¯·æ±‚æ–°Token
        TokenResponse response = authClient.getToken();
        currentToken = response.getAccessToken();
        expireTime = System.currentTimeMillis() + response.getExpiresIn() * 1000;
    }
}
```

---

## 4. ğŸ—ï¸ å¾®æœåŠ¡åœºæ™¯åº”ç”¨


### 4.1 å…¸å‹åº”ç”¨åœºæ™¯


**åœºæ™¯ä¸€ï¼šæœåŠ¡é—´APIè°ƒç”¨**

```
ä¸šåŠ¡æµç¨‹ï¼šç”¨æˆ·ä¸‹å•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·ç«¯  â”‚ â”€â”€â”€â†’ â”‚ è®¢å•æœåŠ¡â”‚ â”€â”€â”€â†’ â”‚ åº“å­˜æœåŠ¡â”‚ â”€â”€â”€â†’ â”‚ æ”¯ä»˜æœåŠ¡â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“                â†“                â†“
                 éœ€è¦Token        éœ€è¦Token        éœ€è¦Token
                      â†“                â†“                â†“
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚        è®¤è¯æœåŠ¡å™¨ï¼ˆé¢å‘Tokenï¼‰        â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å®é™…è°ƒç”¨é“¾ï¼š
1. ç”¨æˆ·æäº¤è®¢å• â†’ è®¢å•æœåŠ¡
2. è®¢å•æœåŠ¡è·å–Token â†’ è°ƒç”¨åº“å­˜æœåŠ¡ï¼ˆæ£€æŸ¥åº“å­˜ï¼‰
3. è®¢å•æœåŠ¡è·å–Token â†’ è°ƒç”¨æ”¯ä»˜æœåŠ¡ï¼ˆåˆ›å»ºæ”¯ä»˜ï¼‰
4. å„æœåŠ¡ç‹¬ç«‹è®¤è¯ï¼Œäº’ä¸å¹²æ‰°
```

**åœºæ™¯äºŒï¼šå®šæ—¶ä»»åŠ¡æ‰§è¡Œ**

```
éœ€æ±‚ï¼šæ¯å¤©å‡Œæ™¨åŒæ­¥æ•°æ®

å®šæ—¶ä»»åŠ¡æœåŠ¡ï¼ˆJob Serviceï¼‰
â”œâ”€ å‡Œæ™¨2ç‚¹è§¦å‘
â”œâ”€ éœ€è¦è®¿é—®å¤šä¸ªæœåŠ¡çš„æ•°æ®
â”œâ”€ æ²¡æœ‰ç”¨æˆ·ç™»å½•çŠ¶æ€
â””â”€ ä½¿ç”¨Client Credentialsæ¨¡å¼

æ‰§è¡Œæµç¨‹ï¼š
02:00:00 ä»»åŠ¡å¯åŠ¨
02:00:01 â”‚ è·å–Tokenï¼ˆç”¨æœåŠ¡å‡­è¯ï¼‰
02:00:02 â”‚ è°ƒç”¨è®¢å•æœåŠ¡APIï¼ˆæŸ¥è¯¢æ˜¨æ—¥è®¢å•ï¼‰
02:00:05 â”‚ è°ƒç”¨ç”¨æˆ·æœåŠ¡APIï¼ˆæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼‰
02:00:08 â”‚ è°ƒç”¨æ•°æ®æœåŠ¡APIï¼ˆå†™å…¥æŠ¥è¡¨æ•°æ®ï¼‰
02:00:10 â”” ä»»åŠ¡å®Œæˆ

å…³é”®ç‚¹ï¼šå…¨ç¨‹æ— ç”¨æˆ·å‚ä¸ï¼Œçº¯æœåŠ¡é—´é€šä¿¡
```

**åœºæ™¯ä¸‰ï¼šç›‘æ§å‘Šè­¦ç³»ç»Ÿ**

```
ç›‘æ§æœåŠ¡èŒè´£ï¼š
â”œâ”€ å®æ—¶æ£€æµ‹å„æœåŠ¡å¥åº·çŠ¶æ€
â”œâ”€ æ”¶é›†æ€§èƒ½æŒ‡æ ‡æ•°æ®
â”œâ”€ å¼‚å¸¸æ—¶å‘é€å‘Šè­¦é€šçŸ¥
â””â”€ 24å°æ—¶æŒç»­è¿è¡Œ

è®¤è¯éœ€æ±‚ï¼š
âœ“ éœ€è¦è®¿é—®æ‰€æœ‰æœåŠ¡çš„ç›‘æ§æ¥å£
âœ“ ä¸å¯èƒ½ç”¨æŸä¸ªç”¨æˆ·çš„èº«ä»½
âœ“ å¿…é¡»æœ‰ç‹¬ç«‹çš„æœåŠ¡å‡­è¯
âœ“ Tokenéœ€è¦åŒ…å«ç›‘æ§æƒé™

æƒé™é…ç½®ï¼š
scope: ["monitor.read", "metrics.read", "health.check"]
```

### 4.2 å¾®æœåŠ¡æ¶æ„ä¸­çš„æœ€ä½³å®è·µ


**å®è·µä¸€ï¼šç»Ÿä¸€è®¤è¯ä¸­å¿ƒ**

```
æ¶æ„è®¾è®¡ï¼š
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  è®¤è¯æˆæƒä¸­å¿ƒ    â”‚
                    â”‚  (Auth Server)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†‘ â†‘ â†‘
                            â”‚ â”‚ â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                     â”‚                     â”‚
  [è·å–Token]            [è·å–Token]           [è·å–Token]
        â”‚                     â”‚                     â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚è®¢å•æœåŠ¡  â”‚          â”‚åº“å­˜æœåŠ¡  â”‚           â”‚æ”¯ä»˜æœåŠ¡  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜åŠ¿ï¼š
âœ“ é›†ä¸­ç®¡ç†æ‰€æœ‰æœåŠ¡çš„å‡­è¯
âœ“ ç»Ÿä¸€çš„Tokené¢å‘å’ŒéªŒè¯
âœ“ ä¾¿äºæƒé™æ§åˆ¶å’Œå®¡è®¡
âœ“ ç®€åŒ–æœåŠ¡é—´çš„ä¿¡ä»»å…³ç³»
```

**å®è·µäºŒï¼šæƒé™æœ€å°åŒ–åŸåˆ™**

```
æƒé™é…ç½®ç¤ºä¾‹ï¼š

è®¢å•æœåŠ¡çš„æƒé™ï¼š
scope: [
  "inventory.read",      // åªèƒ½è¯»åº“å­˜
  "payment.create",      // åªèƒ½åˆ›å»ºæ”¯ä»˜
  "user.read"           // åªèƒ½è¯»ç”¨æˆ·ä¿¡æ¯
]
âŒ ä¸ç»™ï¼šinventory.writeï¼ˆä¸èƒ½ä¿®æ”¹åº“å­˜ï¼‰
âŒ ä¸ç»™ï¼špayment.refundï¼ˆä¸èƒ½é€€æ¬¾ï¼‰

åº“å­˜æœåŠ¡çš„æƒé™ï¼š
scope: [
  "product.read",       // è¯»å•†å“ä¿¡æ¯
  "warehouse.read"      // è¯»ä»“åº“æ•°æ®
]
âŒ ä¸ç»™ï¼šorder.*ï¼ˆåº“å­˜æœåŠ¡ä¸è¯¥è®¿é—®è®¢å•ï¼‰

åŸåˆ™ï¼šåªç»™å¿…éœ€çš„æœ€å°æƒé™
```

**å®è·µä¸‰ï¼šTokenç¼“å­˜ç­–ç•¥**

```
é—®é¢˜ï¼šæ¯æ¬¡è°ƒç”¨éƒ½è·å–Token â†’ æ€§èƒ½å·®ã€æœåŠ¡å™¨å‹åŠ›å¤§

è§£å†³æ–¹æ¡ˆï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Tokenç¼“å­˜ç®¡ç†              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. é¦–æ¬¡è·å–Token â†’ å­˜å…¥ç¼“å­˜         â”‚
â”‚ 2. åç»­è°ƒç”¨ â†’ å…ˆæŸ¥ç¼“å­˜              â”‚
â”‚ 3. Tokenå¿«è¿‡æœŸ â†’ æå‰åˆ·æ–°           â”‚
â”‚ 4. Tokenå¤±æ•ˆ â†’ è‡ªåŠ¨é‡æ–°è·å–         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¼“å­˜æ–¹æ¡ˆï¼š
â€¢ æœ¬åœ°ç¼“å­˜ï¼ˆå•æœºï¼‰
  â”œâ”€ ä½¿ç”¨ï¼šConcurrentHashMap
  â”œâ”€ ä¼˜ç‚¹ï¼šå¿«é€Ÿã€æ— ç½‘ç»œå¼€é”€
  â””â”€ ç¼ºç‚¹ï¼šå¤šå®ä¾‹ä¸å…±äº«

â€¢ åˆ†å¸ƒå¼ç¼“å­˜ï¼ˆæ¨èï¼‰
  â”œâ”€ ä½¿ç”¨ï¼šRedis
  â”œâ”€ ä¼˜ç‚¹ï¼šå¤šå®ä¾‹å…±äº«ã€å®¹é‡å¤§
  â””â”€ æ³¨æ„ï¼šè®¾ç½®åˆç†è¿‡æœŸæ—¶é—´
```

---

## 5. ğŸ” å‡­è¯ç®¡ç†ä¸å®‰å…¨


### 5.1 Client Secretçš„å®‰å…¨å­˜å‚¨


> âš ï¸ **å®‰å…¨è­¦å‘Š**ï¼šClient Secretæ³„éœ² = é»‘å®¢å¯ä»¥å†’å……ä½ çš„æœåŠ¡ï¼

**å­˜å‚¨æ–¹æ¡ˆå¯¹æ¯”**ï¼š

| æ–¹æ¡ˆ | **å®‰å…¨æ€§** | **ä¾¿åˆ©æ€§** | **é€‚ç”¨åœºæ™¯** |
|------|----------|----------|------------|
| ç¡¬ç¼–ç åœ¨ä»£ç  | âŒ æä½ | âœ… ç®€å• | âŒ ç»ä¸å¯ç”¨ |
| é…ç½®æ–‡ä»¶æ˜æ–‡ | âŒ ä½ | âœ… æ–¹ä¾¿ | âŒ ä¸æ¨è |
| ç¯å¢ƒå˜é‡ | â­â­ ä¸­ | â­â­ ä¸€èˆ¬ | âœ… å¼€å‘ç¯å¢ƒå¯ç”¨ |
| é…ç½®ä¸­å¿ƒåŠ å¯† | â­â­â­ é«˜ | â­â­ ä¸€èˆ¬ | âœ… ç”Ÿäº§ç¯å¢ƒæ¨è |
| å¯†é’¥ç®¡ç†æœåŠ¡ | â­â­â­â­ æé«˜ | â­ å¤æ‚ | âœ… ä¼ä¸šçº§åº”ç”¨ |

**æ¨èåšæ³•**ï¼š

```yaml
# âŒ é”™è¯¯ç¤ºä¾‹1ï¼šç¡¬ç¼–ç 
@Value("my-secret-123")
private String clientSecret;

# âŒ é”™è¯¯ç¤ºä¾‹2ï¼šé…ç½®æ–‡ä»¶æ˜æ–‡
spring:
  security:
    oauth2:
      client:
        registration:
          my-client:
            client-secret: my-secret-123

# âœ… æ­£ç¡®ç¤ºä¾‹1ï¼šç¯å¢ƒå˜é‡
spring:
  security:
    oauth2:
      client:
        registration:
          my-client:
            client-secret: ${CLIENT_SECRET}

# å¯åŠ¨æ—¶æ³¨å…¥
java -jar app.jar --CLIENT_SECRET=xxx123

# âœ… æ­£ç¡®ç¤ºä¾‹2ï¼šé…ç½®ä¸­å¿ƒåŠ å¯†
spring:
  cloud:
    config:
      server:
        encrypt:
          enabled: true

# é…ç½®æ–‡ä»¶ä¸­å­˜å‚¨åŠ å¯†åçš„å€¼
client-secret: '{cipher}AQA8K3sOEK...'
```

### 5.2 Tokenå®‰å…¨ä¼ è¾“


**ä¼ è¾“å®‰å…¨ä¸‰è¦ç´ **ï¼š

```
1ï¸âƒ£ ä½¿ç”¨HTTPS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ HTTP  â†’ æ˜æ–‡ä¼ è¾“ â†’ âŒ å±é™©      â”‚
â”‚ HTTPS â†’ åŠ å¯†ä¼ è¾“ â†’ âœ… å®‰å…¨      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

2ï¸âƒ£ æ­£ç¡®çš„Headeræ ¼å¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âŒ é”™è¯¯ï¼šåœ¨URLä¸­ä¼ è¾“            â”‚
â”‚ GET /api/data?token=abc123     â”‚
â”‚                                â”‚
â”‚ âœ… æ­£ç¡®ï¼šåœ¨Headerä¸­ä¼ è¾“         â”‚
â”‚ GET /api/data                  â”‚
â”‚ Authorization: Bearer abc123   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

3ï¸âƒ£ Tokenä¸è¦è®°å½•åˆ°æ—¥å¿—
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âŒ å±é™©ï¼š                       â”‚
â”‚ log.info("Token: " + token);   â”‚
â”‚                                â”‚
â”‚ âœ… å®‰å…¨ï¼š                       â”‚
â”‚ log.info("Token: ***masked***");â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 å¼‚å¸¸åœºæ™¯å¤„ç†


**åœºæ™¯ä¸€ï¼šTokenè¿‡æœŸ**

```
é—®é¢˜æµç¨‹ï¼š
è®¢å•æœåŠ¡ â†’ åº“å­˜æœåŠ¡ï¼ˆæºå¸¦è¿‡æœŸTokenï¼‰
åº“å­˜æœåŠ¡ â†’ è¿”å›401 Unauthorized

å¤„ç†æ–¹æ¡ˆï¼š
try {
    // è°ƒç”¨åº“å­˜æœåŠ¡
    response = inventoryClient.query(token);
} catch (UnauthorizedException e) {
    // Tokenå¯èƒ½è¿‡æœŸ
    // 1. é‡æ–°è·å–Token
    String newToken = tokenManager.refreshToken();
    // 2. é‡è¯•è¯·æ±‚
    response = inventoryClient.query(newToken);
}
```

**åœºæ™¯äºŒï¼šå‡­è¯é”™è¯¯**

```
å¯èƒ½åŸå› ï¼š
â”œâ”€ Client IDé…ç½®é”™è¯¯
â”œâ”€ Client Secreté…ç½®é”™è¯¯
â”œâ”€ è®¤è¯æœåŠ¡å™¨åœ°å€é”™è¯¯
â””â”€ ç½‘ç»œè¿æ¥é—®é¢˜

é”™è¯¯ä¿¡æ¯ç¤ºä¾‹ï¼š
{
  "error": "invalid_client",
  "error_description": "Client authentication failed"
}

æ’æŸ¥æ­¥éª¤ï¼š
1ï¸âƒ£ æ£€æŸ¥Client IDæ˜¯å¦æ­£ç¡®
2ï¸âƒ£ æ£€æŸ¥Client Secretæ˜¯å¦åŒ¹é…
3ï¸âƒ£ ç¡®è®¤è®¤è¯æœåŠ¡å™¨æ˜¯å¦å¯è®¿é—®
4ï¸âƒ£ æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—
```

**åœºæ™¯ä¸‰ï¼šæƒé™ä¸è¶³**

```
é”™è¯¯åœºæ™¯ï¼š
è®¢å•æœåŠ¡å°è¯•åˆ é™¤åº“å­˜ï¼ˆä½†åªæœ‰è¯»æƒé™ï¼‰

è¿”å›é”™è¯¯ï¼š
{
  "error": "insufficient_scope",
  "error_description": "The request requires higher privileges"
}

è§£å†³æ–¹æ¡ˆï¼š
1. ç¡®è®¤è¯¥æœåŠ¡æ˜¯å¦çœŸçš„éœ€è¦æ­¤æƒé™
2. å¦‚éœ€è¦ â†’ å‘ç®¡ç†å‘˜ç”³è¯·æƒé™
3. å¦‚ä¸éœ€è¦ â†’ ä¿®æ”¹ä¸šåŠ¡é€»è¾‘
```

---

## 6. ğŸ’» å®æˆ˜é…ç½®æŒ‡å—


### 6.1 Spring Booté…ç½®ç¤ºä¾‹


**å®Œæ•´é…ç½®æ–‡ä»¶**ï¼š

```yaml
# application.yml
spring:
  application:
    name: order-service
  
  security:
    oauth2:
      client:
        # å®¢æˆ·ç«¯é…ç½®
        registration:
          order-client:
            # æœåŠ¡æ ‡è¯†ï¼ˆå…¬å¼€ï¼‰
            client-id: order-service-client
            # æœåŠ¡å¯†é’¥ï¼ˆä¿å¯†ï¼‰
            client-secret: ${CLIENT_SECRET}
            # æˆæƒç±»å‹
            authorization-grant-type: client_credentials
            # è¯·æ±‚çš„æƒé™èŒƒå›´
            scope: 
              - inventory.read
              - payment.create
        
        # è®¤è¯æœåŠ¡å™¨é…ç½®
        provider:
          auth-server:
            # Tokenè·å–åœ°å€
            token-uri: https://auth-server.com/oauth/token
            # TokenéªŒè¯åœ°å€ï¼ˆå¯é€‰ï¼‰
            user-info-uri: https://auth-server.com/oauth/check_token

# æ—¥å¿—é…ç½®ï¼ˆè°ƒè¯•ç”¨ï¼‰
logging:
  level:
    org.springframework.security: DEBUG
    org.springframework.web.client: DEBUG
```

### 6.2 è°ƒç”¨ä»£ç å®ç°


**æ–¹å¼ä¸€ï¼šä½¿ç”¨RestTemplate**

```java
@Service
public class InventoryClient {
    
    @Autowired
    private OAuth2AuthorizedClientService clientService;
    
    @Autowired
    private RestTemplate restTemplate;
    
    // æŸ¥è¯¢åº“å­˜
    public Integer queryStock(String productId) {
        // 1. è·å–Token
        String token = getAccessToken();
        
        // 2. æ„å»ºè¯·æ±‚å¤´
        HttpHeaders headers = new HttpHeaders();
        headers.setBearerAuth(token);
        
        // 3. å‘èµ·è¯·æ±‚
        HttpEntity<Void> entity = new HttpEntity<>(headers);
        String url = "http://inventory-service/api/stock/" + productId;
        
        ResponseEntity<Integer> response = restTemplate.exchange(
            url, HttpMethod.GET, entity, Integer.class
        );
        
        return response.getBody();
    }
    
    // è·å–è®¿é—®ä»¤ç‰Œ
    private String getAccessToken() {
        OAuth2AuthorizedClient client = clientService
            .loadAuthorizedClient("order-client", "order-service");
        return client.getAccessToken().getTokenValue();
    }
}
```

**æ–¹å¼äºŒï¼šä½¿ç”¨Feignï¼ˆæ¨èï¼‰**

```java
// Feigné…ç½®
@Configuration
public class FeignConfig {
    
    @Bean
    public RequestInterceptor oauth2FeignRequestInterceptor(
            OAuth2AuthorizedClientService clientService) {
        
        return template -> {
            // è‡ªåŠ¨æ·»åŠ Tokenåˆ°è¯·æ±‚å¤´
            OAuth2AuthorizedClient client = clientService
                .loadAuthorizedClient("order-client", "order-service");
            
            String token = client.getAccessToken().getTokenValue();
            template.header("Authorization", "Bearer " + token);
        };
    }
}

// Feignå®¢æˆ·ç«¯
@FeignClient(name = "inventory-service")
public interface InventoryClient {
    
    @GetMapping("/api/stock/{productId}")
    Integer queryStock(@PathVariable String productId);
}

// ä½¿ç”¨ï¼ˆç®€å•ï¼ï¼‰
@Service
public class OrderService {
    
    @Autowired
    private InventoryClient inventoryClient;
    
    public void createOrder(String productId) {
        // ç›´æ¥è°ƒç”¨ï¼ŒTokenè‡ªåŠ¨å¤„ç†
        Integer stock = inventoryClient.queryStock(productId);
        
        if (stock > 0) {
            // åˆ›å»ºè®¢å•...
        }
    }
}
```

### 6.3 è®¤è¯æœåŠ¡å™¨é…ç½®


**ç®€åŒ–ç‰ˆè®¤è¯æœåŠ¡å™¨ï¼ˆä½¿ç”¨Spring Authorization Serverï¼‰**ï¼š

```java
@Configuration
@EnableAuthorizationServer
public class AuthServerConfig {
    
    // é…ç½®å®¢æˆ·ç«¯ä¿¡æ¯
    @Bean
    public RegisteredClientRepository registeredClientRepository() {
        // è®¢å•æœåŠ¡å®¢æˆ·ç«¯
        RegisteredClient orderClient = RegisteredClient.withId("order-service")
            .clientId("order-service-client")
            .clientSecret("{noop}order-secret-123")  // å®é™…åº”åŠ å¯†
            .authorizationGrantType(AuthorizationGrantType.CLIENT_CREDENTIALS)
            .scope("inventory.read")
            .scope("payment.create")
            .build();
        
        // åº“å­˜æœåŠ¡å®¢æˆ·ç«¯
        RegisteredClient inventoryClient = RegisteredClient.withId("inventory-service")
            .clientId("inventory-service-client")
            .clientSecret("{noop}inventory-secret-456")
            .authorizationGrantType(AuthorizationGrantType.CLIENT_CREDENTIALS)
            .scope("product.read")
            .scope("warehouse.read")
            .build();
        
        return new InMemoryRegisteredClientRepository(orderClient, inventoryClient);
    }
}
```

### 6.4 èµ„æºæœåŠ¡å™¨é…ç½®


**åº“å­˜æœåŠ¡ï¼ˆèµ„æºæœåŠ¡å™¨ï¼‰é…ç½®**ï¼š

```java
@Configuration
@EnableResourceServer
public class ResourceServerConfig extends ResourceServerConfigurerAdapter {
    
    @Override
    public void configure(HttpSecurity http) throws Exception {
        http
            .authorizeRequests()
                // åº“å­˜æŸ¥è¯¢éœ€è¦readæƒé™
                .antMatchers(HttpMethod.GET, "/api/stock/**")
                    .hasAuthority("SCOPE_inventory.read")
                // åº“å­˜ä¿®æ”¹éœ€è¦writeæƒé™
                .antMatchers(HttpMethod.PUT, "/api/stock/**")
                    .hasAuthority("SCOPE_inventory.write")
                .anyRequest().authenticated();
    }
    
    @Override
    public void configure(ResourceServerSecurityConfigurer resources) {
        resources
            .resourceId("inventory-service")
            // TokenéªŒè¯é…ç½®
            .tokenServices(tokenServices());
    }
    
    @Bean
    public TokenStore tokenStore() {
        return new JwtTokenStore(jwtAccessTokenConverter());
    }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å…³é”®æ¦‚å¿µå›é¡¾


```
ğŸ“Œ å®¢æˆ·ç«¯å‡­è¯æ¨¡å¼ = æœåŠ¡è‡ªå·±çš„èº«ä»½è®¤è¯
   â€¢ ä¸éœ€è¦ç”¨æˆ·å‚ä¸
   â€¢ æœåŠ¡é—´åå°é€šä¿¡ä¸“ç”¨
   â€¢ æœºå™¨å¯¹æœºå™¨çš„æˆæƒæ–¹å¼

ğŸ”‘ æ ¸å¿ƒç»„ä»¶ï¼š
   Client ID      â†’ æœåŠ¡çš„èº«ä»½è¯å·ï¼ˆå…¬å¼€ï¼‰
   Client Secret  â†’ æœåŠ¡çš„å¯†ç ï¼ˆä¿å¯†ï¼‰
   Access Token   â†’ è®¿é—®é€šè¡Œè¯ï¼ˆä¸´æ—¶ï¼‰

ğŸ”„ å®Œæ•´æµç¨‹ï¼š
   1. æœåŠ¡ç”¨å‡­è¯è¯·æ±‚Token
   2. è®¤è¯æœåŠ¡å™¨éªŒè¯å¹¶é¢å‘Token
   3. æœåŠ¡ç”¨Tokenè°ƒç”¨å…¶ä»–æœåŠ¡
   4. ç›®æ ‡æœåŠ¡éªŒè¯Tokenå¹¶å“åº”
```

### 7.2 é€‚ç”¨åœºæ™¯æ€»ç»“


| åœºæ™¯ç±»å‹ | **æ˜¯å¦é€‚ç”¨** | **è¯´æ˜** |
|---------|------------|---------|
| å¾®æœåŠ¡é—´APIè°ƒç”¨ | âœ… æœ€é€‚åˆ | æ ¸å¿ƒä½¿ç”¨åœºæ™¯ |
| å®šæ—¶ä»»åŠ¡æ‰§è¡Œ | âœ… é€‚åˆ | æ— ç”¨æˆ·å‚ä¸çš„åå°ä»»åŠ¡ |
| æ‰¹é‡æ•°æ®å¤„ç† | âœ… é€‚åˆ | åå°æ•°æ®åŒæ­¥ |
| ç›‘æ§å‘Šè­¦ç³»ç»Ÿ | âœ… é€‚åˆ | ç³»ç»Ÿçº§æœåŠ¡è°ƒç”¨ |
| ç”¨æˆ·ç™»å½• | âŒ ä¸é€‚åˆ | åº”ç”¨æˆæƒç æˆ–å¯†ç æ¨¡å¼ |
| ç¬¬ä¸‰æ–¹åº”ç”¨æˆæƒ | âŒ ä¸é€‚åˆ | åº”ç”¨æˆæƒç æ¨¡å¼ |

### 7.3 å®‰å…¨è¦ç‚¹æ¸…å•


> ğŸ” **å®‰å…¨æ£€æŸ¥æ¸…å•**

```
âœ… Client Secretå­˜å‚¨
   â–¡ ä¸ç¡¬ç¼–ç åœ¨ä»£ç ä¸­
   â–¡ ä¸æ˜æ–‡å­˜å‚¨åœ¨é…ç½®æ–‡ä»¶
   â–¡ ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é…ç½®ä¸­å¿ƒ
   â–¡ ç”Ÿäº§ç¯å¢ƒä½¿ç”¨åŠ å¯†å­˜å‚¨

âœ… Tokenä¼ è¾“
   â–¡ ä½¿ç”¨HTTPSåŠ å¯†ä¼ è¾“
   â–¡ Tokenæ”¾åœ¨Headerè€ŒéURL
   â–¡ ä¸åœ¨æ—¥å¿—ä¸­è®°å½•å®Œæ•´Token
   â–¡ è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´

âœ… æƒé™æ§åˆ¶
   â–¡ éµå¾ªæœ€å°æƒé™åŸåˆ™
   â–¡ å®šæœŸå®¡æŸ¥æœåŠ¡æƒé™
   â–¡ åŒºåˆ†è¯»å†™æƒé™
   â–¡ æ•æ„Ÿæ“ä½œé¢å¤–éªŒè¯

âœ… å¼‚å¸¸å¤„ç†
   â–¡ æ•è·Tokenè¿‡æœŸå¼‚å¸¸
   â–¡ è‡ªåŠ¨é‡è¯•æœºåˆ¶
   â–¡ è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
   â–¡ ç›‘æ§å‘Šè­¦é…ç½®
```

### 7.4 æœ€ä½³å®è·µå»ºè®®


```
ğŸ’¡ å¼€å‘å»ºè®®ï¼š

1ï¸âƒ£ ç»Ÿä¸€Tokenç®¡ç†
   â€¢ ä½¿ç”¨TokenManagerç»Ÿä¸€ç®¡ç†
   â€¢ å®ç°Tokenè‡ªåŠ¨åˆ·æ–°
   â€¢ å¤šå®ä¾‹å…±äº«Tokenï¼ˆRedisï¼‰

2ï¸âƒ£ åˆç†ç¼“å­˜ç­–ç•¥
   â€¢ Tokenæœªè¿‡æœŸä¸é‡å¤è·å–
   â€¢ æå‰5åˆ†é’Ÿåˆ·æ–°Token
   â€¢ å¹¶å‘åœºæ™¯åŠ é”é˜²æ­¢é‡å¤è¯·æ±‚

3ï¸âƒ£ å®Œå–„ç›‘æ§å‘Šè­¦
   â€¢ ç›‘æ§Tokenè·å–å¤±è´¥ç‡
   â€¢ ç›‘æ§APIè°ƒç”¨401é”™è¯¯
   â€¢ ç›‘æ§æœåŠ¡è°ƒç”¨é“¾è·¯

4ï¸âƒ£ è§„èŒƒåŒ–é…ç½®
   â€¢ ç»Ÿä¸€é…ç½®ä¸­å¿ƒç®¡ç†å‡­è¯
   â€¢ ç¯å¢ƒéš”ç¦»ï¼ˆdev/test/prodï¼‰
   â€¢ æ•æ„Ÿä¿¡æ¯åŠ å¯†å­˜å‚¨
```

### 7.5 å¸¸è§é—®é¢˜FAQ


**Q1: å¤šä¹…è·å–ä¸€æ¬¡Tokenï¼Ÿ**
```
A: ä¸è¦æ¯æ¬¡è°ƒç”¨éƒ½è·å–ï¼
   âœ… æ¨èï¼šTokenç¼“å­˜ + æå‰åˆ·æ–°
   â€¢ é¦–æ¬¡è·å–åç¼“å­˜
   â€¢ Tokenæœ‰æ•ˆæœŸ70%æ—¶åˆ·æ–°
   â€¢ è¿‡æœŸåè‡ªåŠ¨é‡æ–°è·å–
```

**Q2: Tokenè¿‡æœŸäº†æ€ä¹ˆåŠï¼Ÿ**
```
A: æ•è·401é”™è¯¯ï¼Œè‡ªåŠ¨é‡è¯•
   try {
       è°ƒç”¨æœåŠ¡(oldToken);
   } catch (401é”™è¯¯) {
       newToken = é‡æ–°è·å–Token();
       è°ƒç”¨æœåŠ¡(newToken);  // é‡è¯•
   }
```

**Q3: å¦‚ä½•é˜²æ­¢Client Secretæ³„éœ²ï¼Ÿ**
```
A: å¤šå±‚é˜²æŠ¤
   â€¢ ä¸æäº¤åˆ°Gitï¼ˆ.gitignoreï¼‰
   â€¢ ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é…ç½®ä¸­å¿ƒ
   â€¢ å®šæœŸè½®æ¢Secret
   â€¢ é™åˆ¶è®¿é—®æƒé™
```

**Q4: ä¸€ä¸ªæœåŠ¡å¯ä»¥æœ‰å¤šä¸ªClient IDå—ï¼Ÿ**
```
A: å¯ä»¥ï¼Œä½†é€šå¸¸ä¸éœ€è¦
   â€¢ åŒä¸€æœåŠ¡é€šå¸¸ä¸€ä¸ªClient ID
   â€¢ ä¸åŒç¯å¢ƒå¯ä»¥ç”¨ä¸åŒID
   â€¢ ç‰¹æ®Šåœºæ™¯å¯é…ç½®å¤šä¸ª
```

---

## ğŸ¯ å­¦ä¹ æ£€æŸ¥ç‚¹


**è‡ªæˆ‘æ£€æµ‹ï¼š**
- [ ] èƒ½è¯´æ¸…æ¥šå®¢æˆ·ç«¯å‡­è¯æ¨¡å¼çš„ä½¿ç”¨åœºæ™¯
- [ ] ç†è§£Client IDå’ŒClient Secretçš„åŒºåˆ«
- [ ] æŒæ¡Tokenè·å–å’Œä½¿ç”¨çš„å®Œæ•´æµç¨‹
- [ ] çŸ¥é“å¦‚ä½•å®‰å…¨å­˜å‚¨Client Secret
- [ ] ä¼šé…ç½®Spring Bootçš„OAuth2å®¢æˆ·ç«¯
- [ ] äº†è§£å¾®æœåŠ¡é—´è°ƒç”¨çš„è®¤è¯æµç¨‹

**å®æˆ˜ä»»åŠ¡ï¼š**
1. æ­å»ºä¸€ä¸ªç®€å•çš„è®¤è¯æœåŠ¡å™¨
2. é…ç½®ä¸¤ä¸ªå¾®æœåŠ¡ä½¿ç”¨å®¢æˆ·ç«¯å‡­è¯æ¨¡å¼
3. å®ç°æœåŠ¡é—´çš„å®‰å…¨è°ƒç”¨
4. é…ç½®Tokenç¼“å­˜å’Œè‡ªåŠ¨åˆ·æ–°
5. å¤„ç†Tokenè¿‡æœŸçš„å¼‚å¸¸åœºæ™¯

---

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
> ğŸµ å®¢æˆ·ç«¯å‡­è¯æœåŠ¡ç”¨ï¼Œæ— éœ€ç”¨æˆ·è‡ªå·±è®¤ã€‚  
> IDæ ‡è¯†Secretå¯†ï¼ŒTokené€šè¡Œæƒé™åˆ†ã€‚  
> åå°è°ƒç”¨æœ€é€‚åˆï¼Œå®‰å…¨å­˜å‚¨æ˜¯å…³é”®ã€‚  
> ç¼“å­˜åˆ·æ–°ææ€§èƒ½ï¼Œå¼‚å¸¸å¤„ç†ä¿ç¨³å®šã€‚