---
title: 8ã€èµ„æºè®¿é—®æ§åˆ¶
---
## ğŸ“š ç›®å½•

1. [èµ„æºè®¿é—®æ§åˆ¶æ¦‚è¿°](#1-èµ„æºè®¿é—®æ§åˆ¶æ¦‚è¿°)
2. [URLæƒé™é…ç½®](#2-URLæƒé™é…ç½®)
3. [è§’è‰²æ§åˆ¶æœºåˆ¶](#3-è§’è‰²æ§åˆ¶æœºåˆ¶)
4. [ScopeéªŒè¯](#4-ScopeéªŒè¯)
5. [èµ„æºä¿æŠ¤ç­–ç•¥](#5-èµ„æºä¿æŠ¤ç­–ç•¥)
6. [åŠ¨æ€æƒé™å®ç°](#6-åŠ¨æ€æƒé™å®ç°)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” èµ„æºè®¿é—®æ§åˆ¶æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯èµ„æºè®¿é—®æ§åˆ¶


**é€šä¿—ç†è§£ï¼šå°±åƒå…¬å¸é—¨ç¦ç³»ç»Ÿ**
```
ç°å®åœºæ™¯ï¼š                     OAuth2èµ„æºè®¿é—®ï¼š
å…¬å¸å¤§æ¥¼                        å¾®æœåŠ¡ç³»ç»Ÿ
  â”‚                              â”‚
  â”œâ”€ å‰å°(ä»»ä½•äººå¯è¿›)  â†’         â”œâ”€ å…¬å¼€æ¥å£(æ— éœ€è®¤è¯)
  â”œâ”€ åŠå…¬åŒº(å‘˜å·¥å¡)    â†’         â”œâ”€ å—ä¿æŠ¤èµ„æº(éœ€Token)
  â”œâ”€ è´¢åŠ¡å®¤(è´¢åŠ¡æƒé™)  â†’         â”œâ”€ ç‰¹å®šè§’è‰²èµ„æº(éœ€è§’è‰²)
  â””â”€ æœºæˆ¿(ç®¡ç†å‘˜æƒé™)  â†’         â””â”€ æ•æ„Ÿèµ„æº(é«˜çº§æƒé™)

æ ¸å¿ƒæ€æƒ³ï¼šä¸åŒçš„é—¨éœ€è¦ä¸åŒçš„é’¥åŒ™(æƒé™)
```

**ğŸ”¸ æ ¸å¿ƒæ¦‚å¿µè§£é‡Š**
```
èµ„æº(Resource)ï¼š
- ç®€å•è¯´ï¼šå°±æ˜¯ç”¨æˆ·æƒ³è®¿é—®çš„APIæ¥å£
- ä¾‹å¦‚ï¼šæŸ¥è¯¢è®¢å•æ¥å£ã€åˆ é™¤ç”¨æˆ·æ¥å£
- å½¢å¼ï¼š/api/ordersã€/api/users/{id}

è®¿é—®æ§åˆ¶ï¼š
- ç®€å•è¯´ï¼šå†³å®šè°èƒ½è®¿é—®ä»€ä¹ˆèµ„æº
- åŒ…å«ï¼šèº«ä»½éªŒè¯(ä½ æ˜¯è°) + æƒé™éªŒè¯(èƒ½åšä»€ä¹ˆ)
- ç›®çš„ï¼šä¿æŠ¤æ•æ„Ÿæ•°æ®å’Œæ“ä½œ
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦èµ„æºè®¿é—®æ§åˆ¶


**ğŸ¯ ä¸‰ä¸ªæ ¸å¿ƒç›®çš„**

| ç›®çš„ | **è¯´æ˜** | **ç°å®ä¾‹å­** |
|------|---------|-------------|
| ğŸ›¡ï¸ **å®‰å…¨ä¿æŠ¤** | é˜²æ­¢æœªæˆæƒè®¿é—® | é“¶è¡Œå¡éœ€è¦å¯†ç æ‰èƒ½å–é’± |
| ğŸ”’ **æƒé™éš”ç¦»** | ä¸åŒè§’è‰²çœ‹åˆ°ä¸åŒå†…å®¹ | å‘˜å·¥çœ‹ä¸åˆ°è€æ¿çš„å·¥èµ„ |
| ğŸ“Š **æ“ä½œå®¡è®¡** | è®°å½•è°åšäº†ä»€ä¹ˆ | ç›‘æ§å½•åƒè®°å½•è¿›å‡ºè®°å½• |

**ğŸ’¡ å®é™…é—®é¢˜åœºæ™¯**
```
é—®é¢˜1ï¼šæ²¡æœ‰è®¿é—®æ§åˆ¶ä¼šæ€æ ·ï¼Ÿ
âŒ ä»»ä½•äººéƒ½èƒ½åˆ é™¤ç”¨æˆ·æ•°æ®
âŒ æ™®é€šç”¨æˆ·èƒ½çœ‹åˆ°ç®¡ç†å‘˜åŠŸèƒ½
âŒ æ— æ³•è¿½è¸ªè°è¿›è¡Œäº†æ•æ„Ÿæ“ä½œ

é—®é¢˜2ï¼šè®¿é—®æ§åˆ¶è§£å†³ä»€ä¹ˆï¼Ÿ
âœ… ç¡®ä¿åªæœ‰æˆæƒç”¨æˆ·æ‰èƒ½æ“ä½œ
âœ… ä¸åŒè§’è‰²çœ‹åˆ°ä¸åŒç•Œé¢å’ŒåŠŸèƒ½
âœ… æ‰€æœ‰æ“ä½œéƒ½æœ‰è®°å½•å¯è¿½æº¯
```

### 1.3 è®¿é—®æ§åˆ¶çš„ä¸‰é“é˜²çº¿


```
è¯·æ±‚æµç¨‹ï¼šç”¨æˆ· â†’ ä¸‰é“æ£€æŸ¥ â†’ èµ„æº

ç¬¬ä¸€é“ï¼šèº«ä»½è®¤è¯(Authentication)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é—®é¢˜ï¼šä½ æ˜¯è°ï¼Ÿ              â”‚
â”‚ æ£€æŸ¥ï¼šTokenæ˜¯å¦æœ‰æ•ˆ          â”‚
â”‚ ç»“æœï¼šç¡®è®¤ç”¨æˆ·èº«ä»½           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
ç¬¬äºŒé“ï¼šæƒé™æˆæƒ(Authorization)  
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é—®é¢˜ï¼šä½ èƒ½åšä»€ä¹ˆï¼Ÿ           â”‚
â”‚ æ£€æŸ¥ï¼šè§’è‰²å’ŒScope             â”‚
â”‚ ç»“æœï¼šç¡®è®¤è®¿é—®æƒé™           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
ç¬¬ä¸‰é“ï¼šèµ„æºè¿‡æ»¤(Filtering)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é—®é¢˜ï¼šèƒ½çœ‹åˆ°å“ªäº›æ•°æ®ï¼Ÿ       â”‚
â”‚ æ£€æŸ¥ï¼šæ•°æ®æƒé™               â”‚
â”‚ ç»“æœï¼šè¿”å›å…è®¸çš„æ•°æ®         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸšª URLæƒé™é…ç½®


### 2.1 URLæƒé™é…ç½®åŸºç¡€


**ğŸ”¸ æ ¸å¿ƒæ¦‚å¿µ**
```
URLæƒé™ï¼šæ ¹æ®è®¿é—®çš„ç½‘å€(URL)å†³å®šæ˜¯å¦å…è®¸è®¿é—®

å°±åƒå•†åœºä¸åŒæ¥¼å±‚çš„è§„åˆ™ï¼š
â€¢ 1æ¥¼å¤§å…ï¼šä»»ä½•äººéƒ½èƒ½è¿›å…¥ â†’ å…¬å¼€æ¥å£
â€¢ 2æ¥¼ä¼šå‘˜åŒºï¼šéœ€è¦ä¼šå‘˜å¡ â†’ éœ€è¦ç™»å½•
â€¢ 3æ¥¼VIPåŒºï¼šéœ€è¦VIPå¡ â†’ éœ€è¦ç‰¹å®šæƒé™
```

**ğŸ“‹ åŸºæœ¬é…ç½®æ–¹å¼**

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) {
        http
            .authorizeHttpRequests(auth -> auth
                // å…¬å¼€æ¥å£ï¼šä»»ä½•äººéƒ½èƒ½è®¿é—®
                .requestMatchers("/public/**").permitAll()
                
                // éœ€è¦ç™»å½•ï¼šæœ‰Tokenå°±èƒ½è®¿é—®
                .requestMatchers("/api/**").authenticated()
                
                // éœ€è¦è§’è‰²ï¼šå¿…é¡»æ˜¯ADMINè§’è‰²
                .requestMatchers("/admin/**").hasRole("ADMIN")
                
                // å…¶ä»–è¯·æ±‚ï¼šé»˜è®¤éœ€è¦è®¤è¯
                .anyRequest().authenticated()
            );
        
        return http.build();
    }
}
```

**ğŸ’¡ é…ç½®è§„åˆ™è¯´æ˜**
```
1. permitAll()
   â†’ å®Œå…¨å¼€æ”¾ï¼Œä¸éœ€è¦ä»»ä½•éªŒè¯
   â†’ é€‚ç”¨ï¼šç™»å½•é¡µã€æ³¨å†Œé¡µã€å…¬å¼€æ–‡æ¡£

2. authenticated()  
   â†’ éœ€è¦ç™»å½•(æœ‰æœ‰æ•ˆTokenå³å¯)
   â†’ é€‚ç”¨ï¼šç”¨æˆ·ä¸ªäººä¿¡æ¯ã€æ™®é€šä¸šåŠ¡æ¥å£

3. hasRole("ADMIN")
   â†’ éœ€è¦ç‰¹å®šè§’è‰²
   â†’ é€‚ç”¨ï¼šç®¡ç†åŠŸèƒ½ã€æ•æ„Ÿæ“ä½œ

4. hasAuthority("READ")
   â†’ éœ€è¦ç‰¹å®šæƒé™
   â†’ é€‚ç”¨ï¼šç»†ç²’åº¦çš„åŠŸèƒ½æ§åˆ¶
```

### 2.2 å¸¸ç”¨URLåŒ¹é…æ¨¡å¼


**ğŸ¯ é€šé…ç¬¦è§„åˆ™**

| æ¨¡å¼ | **åŒ¹é…èŒƒå›´** | **ç¤ºä¾‹** |
|------|-------------|---------|
| `/api/users` | ç²¾ç¡®åŒ¹é… | åªåŒ¹é…è¿™ä¸€ä¸ªURL |
| `/api/*` | å•å±‚é€šé… | `/api/users` âœ…  `/api/orders` âœ…<br>`/api/users/1` âŒ |
| `/api/**` | å¤šå±‚é€šé… | `/api/users` âœ…  `/api/users/1` âœ…<br>`/api/orders/123/items` âœ… |

**ğŸ“ å®é™…é…ç½®ç¤ºä¾‹**

```java
// å…¸å‹çš„æƒé™é…ç½®é¡ºåº
.authorizeHttpRequests(auth -> auth
    // 1. æœ€å…·ä½“çš„è§„åˆ™å†™åœ¨å‰é¢
    .requestMatchers("/api/users/admin/**").hasRole("ADMIN")
    .requestMatchers("/api/users/**").authenticated()
    
    // 2. å…¬å¼€çš„é™æ€èµ„æº
    .requestMatchers("/css/**", "/js/**", "/images/**").permitAll()
    
    // 3. ç™»å½•ç›¸å…³æ¥å£
    .requestMatchers("/login", "/register").permitAll()
    
    // 4. å…¶ä»–æ‰€æœ‰æ¥å£éœ€è¦è®¤è¯
    .anyRequest().authenticated()
)
```

> **âš ï¸ é‡è¦æé†’**
> é…ç½®é¡ºåºå¾ˆå…³é”®ï¼Spring Securityä»ä¸Šåˆ°ä¸‹åŒ¹é…ï¼Œç¬¬ä¸€ä¸ªåŒ¹é…çš„è§„åˆ™ç”Ÿæ•ˆã€‚
> 
> æ‰€ä»¥è¦æŠŠ**æ›´å…·ä½“çš„è§„åˆ™**å†™åœ¨å‰é¢ï¼Œ**é€šç”¨è§„åˆ™**å†™åœ¨åé¢ã€‚

### 2.3 HTTPæ–¹æ³•çº§åˆ«çš„æ§åˆ¶


**ğŸ”§ æ ¹æ®è¯·æ±‚æ–¹æ³•æ§åˆ¶æƒé™**

```java
.authorizeHttpRequests(auth -> auth
    // GETè¯·æ±‚ï¼šæ™®é€šç”¨æˆ·å¯ä»¥æŸ¥çœ‹
    .requestMatchers(HttpMethod.GET, "/api/users/**")
        .authenticated()
    
    // POST/PUTï¼šéœ€è¦ADMINè§’è‰²æ‰èƒ½åˆ›å»º/ä¿®æ”¹
    .requestMatchers(HttpMethod.POST, "/api/users/**")
        .hasRole("ADMIN")
    .requestMatchers(HttpMethod.PUT, "/api/users/**")
        .hasRole("ADMIN")
    
    // DELETEï¼šéœ€è¦SUPER_ADMINè§’è‰²æ‰èƒ½åˆ é™¤
    .requestMatchers(HttpMethod.DELETE, "/api/users/**")
        .hasRole("SUPER_ADMIN")
)
```

**ğŸ’¡ å®é™…åº”ç”¨åœºæ™¯**
```
ç”¨æˆ·ç®¡ç†æ¥å£ï¼š/api/users

æƒé™è®¾è®¡ï¼š
â€¢ GET    /api/users     â†’ æ™®é€šç”¨æˆ·å¯æŸ¥çœ‹åˆ—è¡¨
â€¢ GET    /api/users/1   â†’ æ™®é€šç”¨æˆ·å¯æŸ¥çœ‹è¯¦æƒ…
â€¢ POST   /api/users     â†’ ç®¡ç†å‘˜æ‰èƒ½åˆ›å»ºç”¨æˆ·
â€¢ PUT    /api/users/1   â†’ ç®¡ç†å‘˜æ‰èƒ½ä¿®æ”¹ç”¨æˆ·
â€¢ DELETE /api/users/1   â†’ è¶…çº§ç®¡ç†å‘˜æ‰èƒ½åˆ é™¤

è¿™æ ·è®¾è®¡çš„å¥½å¤„ï¼š
âœ… æŸ¥è¯¢æ“ä½œå¼€æ”¾ç»™æ™®é€šç”¨æˆ·
âœ… ä¿®æ”¹æ“ä½œåªæœ‰ç®¡ç†å‘˜èƒ½åš
âœ… åˆ é™¤æ“ä½œæœ‰æœ€é«˜çº§åˆ«ä¿æŠ¤
```

---

## 3. ğŸ‘¥ è§’è‰²æ§åˆ¶æœºåˆ¶


### 3.1 ä»€ä¹ˆæ˜¯è§’è‰²(Role)


**é€šä¿—ç†è§£ï¼šè§’è‰²å°±åƒèŒä½**
```
å…¬å¸èŒä½ä½“ç³»ï¼š              Spring Securityè§’è‰²ï¼š
CEO                  â†’      ROLE_SUPER_ADMIN
éƒ¨é—¨ç»ç†              â†’      ROLE_ADMIN  
æ™®é€šå‘˜å·¥              â†’      ROLE_USER
è®¿å®¢                 â†’      ROLE_GUEST

æ¯ä¸ªèŒä½æœ‰ä¸åŒçš„æƒé™ï¼Œå°±åƒæ¯ä¸ªè§’è‰²èƒ½åšä¸åŒçš„äº‹
```

**ğŸ”¸ è§’è‰²çš„æœ¬è´¨**
```
è§’è‰²(Role)ï¼š
- æ˜¯ä¸€ç»„æƒé™çš„é›†åˆ
- ç”¨æ¥ç®€åŒ–æƒé™ç®¡ç†
- ä¸€ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªè§’è‰²

ä¾‹å¦‚ï¼š
ROLE_ADMIN = {
    è¯»å–ç”¨æˆ·ä¿¡æ¯,
    ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯,
    åˆ é™¤ç”¨æˆ·,
    æŸ¥çœ‹æ—¥å¿—
}
```

### 3.2 è§’è‰²é…ç½®æ–¹å¼


**ğŸ“‹ æ–¹å¼ä¸€ï¼šåŸºäºé…ç½®çš„è§’è‰²æ§åˆ¶**

```java
@Configuration
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) {
        http.authorizeHttpRequests(auth -> auth
            // å•ä¸ªè§’è‰²
            .requestMatchers("/admin/**").hasRole("ADMIN")
            
            // å¤šä¸ªè§’è‰²(æ»¡è¶³ä»»ä¸€å³å¯)
            .requestMatchers("/manage/**").hasAnyRole("ADMIN", "MANAGER")
            
            // éœ€è¦æ‰€æœ‰è§’è‰²
            .requestMatchers("/super/**").access(
                "hasRole('ADMIN') and hasRole('AUDITOR')"
            )
        );
        
        return http.build();
    }
}
```

**ğŸ“‹ æ–¹å¼äºŒï¼šåŸºäºæ³¨è§£çš„è§’è‰²æ§åˆ¶**

```java
@RestController
@RequestMapping("/api/users")
public class UserController {
    
    // åªæœ‰ADMINè§’è‰²èƒ½è®¿é—®
    @PreAuthorize("hasRole('ADMIN')")
    @PostMapping
    public User createUser(@RequestBody User user) {
        return userService.create(user);
    }
    
    // ADMINæˆ–MANAGERè§’è‰²éƒ½èƒ½è®¿é—®
    @PreAuthorize("hasAnyRole('ADMIN', 'MANAGER')")
    @GetMapping
    public List<User> listUsers() {
        return userService.findAll();
    }
    
    // éœ€è¦åŒæ—¶æ‹¥æœ‰ä¸¤ä¸ªè§’è‰²
    @PreAuthorize("hasRole('ADMIN') and hasRole('AUDITOR')")
    @DeleteMapping("/{id}")
    public void deleteUser(@PathVariable Long id) {
        userService.delete(id);
    }
}
```

> **ğŸ’¡ é…ç½® vs æ³¨è§£**
> 
> | æ–¹å¼ | **ä¼˜ç‚¹** | **ç¼ºç‚¹** |
> |------|---------|---------|
> | é…ç½®ç±» | é›†ä¸­ç®¡ç†ï¼Œä¸€ç›®äº†ç„¶ | ç²’åº¦è¾ƒç²—ï¼ŒURLçº§åˆ« |
> | æ³¨è§£ | ç²¾ç¡®åˆ°æ–¹æ³•ï¼Œçµæ´» | åˆ†æ•£åœ¨ä»£ç ä¸­ï¼Œä¸æ˜“ç»´æŠ¤ |
> 
> **å»ºè®®**ï¼šå…¨å±€è§„åˆ™ç”¨é…ç½®ï¼Œç‰¹æ®Šä¸šåŠ¡é€»è¾‘ç”¨æ³¨è§£

### 3.3 è§’è‰²ç»§æ‰¿è®¾è®¡


**ğŸ¯ è§’è‰²å±‚çº§å…³ç³»**

```java
@Configuration
public class RoleHierarchyConfig {
    
    @Bean
    public RoleHierarchy roleHierarchy() {
        RoleHierarchyImpl hierarchy = new RoleHierarchyImpl();
        
        // å®šä¹‰è§’è‰²ç»§æ‰¿å…³ç³»(é«˜çº§åˆ«è§’è‰²è‡ªåŠ¨æ‹¥æœ‰ä½çº§åˆ«æƒé™)
        hierarchy.setHierarchy(
            "ROLE_SUPER_ADMIN > ROLE_ADMIN " +
            "ROLE_ADMIN > ROLE_MANAGER " +
            "ROLE_MANAGER > ROLE_USER"
        );
        
        return hierarchy;
    }
}
```

**ğŸ’¡ ç»§æ‰¿çš„å¥½å¤„**
```
é…ç½®ç»§æ‰¿åï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ROLE_SUPER_ADMIN                    â”‚
â”‚  â†“ è‡ªåŠ¨æ‹¥æœ‰ä¸‹é¢æ‰€æœ‰è§’è‰²çš„æƒé™        â”‚
â”‚ ROLE_ADMIN                          â”‚
â”‚  â†“ è‡ªåŠ¨æ‹¥æœ‰ä¸‹é¢æ‰€æœ‰è§’è‰²çš„æƒé™        â”‚
â”‚ ROLE_MANAGER                        â”‚
â”‚  â†“ è‡ªåŠ¨æ‹¥æœ‰ä¸‹é¢æ‰€æœ‰è§’è‰²çš„æƒé™        â”‚
â”‚ ROLE_USER                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å®é™…æ•ˆæœï¼š
â€¢ SUPER_ADMINèƒ½è®¿é—®æ‰€æœ‰æ¥å£
â€¢ ADMINèƒ½è®¿é—®é™¤SUPER_ADMINå¤–çš„æ¥å£
â€¢ MANAGERèƒ½è®¿é—®USERçº§åˆ«çš„æ¥å£
â€¢ USERåªèƒ½è®¿é—®USERçº§åˆ«çš„æ¥å£

ç®€åŒ–é…ç½®ï¼š
// ä¸éœ€è¦å†™æˆï¼šhasAnyRole("USER", "MANAGER", "ADMIN", "SUPER_ADMIN")
// åªéœ€è¦å†™ï¼šhasRole("USER")  
// é«˜çº§è§’è‰²è‡ªåŠ¨æ»¡è¶³æ¡ä»¶ï¼
```

---

## 4. ğŸ« ScopeéªŒè¯


### 4.1 ä»€ä¹ˆæ˜¯Scope


**é€šä¿—ç†è§£ï¼šScopeå°±åƒæˆæƒä¹¦çš„æƒé™èŒƒå›´**
```
ç°å®åœºæ™¯ï¼š                    OAuth2 Scopeï¼š
é“¶è¡Œå§”æ‰˜ä¹¦                     Access Token
  â”‚                            â”‚
  â”œâ”€ åªèƒ½æŸ¥è¯¢ä½™é¢        â†’      read æƒé™
  â”œâ”€ å¯ä»¥è½¬è´¦          â†’      write æƒé™  
  â””â”€ å¯ä»¥åŠç†ä¸šåŠ¡       â†’      admin æƒé™

Scopeå®šä¹‰ï¼šTokenèƒ½åšä»€ä¹ˆï¼Œä¸èƒ½åšä»€ä¹ˆ
```

**ğŸ”¸ Scope vs Role çš„åŒºåˆ«**

| å¯¹æ¯”é¡¹ | **Role(è§’è‰²)** | **Scope(ä½œç”¨åŸŸ)** |
|-------|---------------|------------------|
| **å«ä¹‰** | ç”¨æˆ·æ˜¯ä»€ä¹ˆèº«ä»½ | Tokenæœ‰ä»€ä¹ˆæƒé™ |
| **ç²’åº¦** | ç²—ç²’åº¦(äººçš„èº«ä»½) | ç»†ç²’åº¦(æ“ä½œæƒé™) |
| **æ¥æº** | ç”¨æˆ·æ³¨å†Œæ—¶åˆ†é… | OAuth2æˆæƒæ—¶å†³å®š |
| **ç¤ºä¾‹** | ADMINã€USER | readã€writeã€delete |
| **é€‚ç”¨** | å†…éƒ¨ç³»ç»Ÿ | ç¬¬ä¸‰æ–¹æˆæƒ |

**ğŸ’¡ å®é™…åœºæ™¯å¯¹æ¯”**
```
åœºæ™¯1ï¼šå†…éƒ¨ç®¡ç†ç³»ç»Ÿ
â†’ ä½¿ç”¨Roleï¼šADMINèƒ½çœ‹æ‰€æœ‰ï¼ŒUSERåªèƒ½çœ‹è‡ªå·±çš„

åœºæ™¯2ï¼šç¬¬ä¸‰æ–¹APPæ¥å…¥
â†’ ä½¿ç”¨Scopeï¼š
  â€¢ å¾®ä¿¡ç™»å½•ï¼šåªç»™äº†readæƒé™(è¯»å–åŸºæœ¬ä¿¡æ¯)
  â€¢ æ”¯ä»˜å®æˆæƒï¼šç»™äº†read+writeæƒé™(è¯»å–+ä¿®æ”¹ä¿¡æ¯)
```

### 4.2 ScopeéªŒè¯é…ç½®


**ğŸ“‹ åŸºç¡€ScopeéªŒè¯**

```java
@Configuration
public class ResourceServerConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) {
        http
            .authorizeHttpRequests(auth -> auth
                // éœ€è¦readæƒé™
                .requestMatchers(HttpMethod.GET, "/api/**")
                    .hasAuthority("SCOPE_read")
                
                // éœ€è¦writeæƒé™
                .requestMatchers(HttpMethod.POST, "/api/**")
                    .hasAuthority("SCOPE_write")
                
                // éœ€è¦deleteæƒé™
                .requestMatchers(HttpMethod.DELETE, "/api/**")
                    .hasAuthority("SCOPE_delete")
            )
            .oauth2ResourceServer(oauth2 -> 
                oauth2.jwt()
            );
        
        return http.build();
    }
}
```

> **âš ï¸ æ³¨æ„ç»†èŠ‚**
> Spring Securityä¸­Scopeä¼šè‡ªåŠ¨åŠ ä¸Š`SCOPE_`å‰ç¼€
> - Tokenä¸­çš„scope: `read`
> - éªŒè¯æ—¶è¦å†™: `SCOPE_read`

**ğŸ“‹ æ³¨è§£æ–¹å¼çš„ScopeéªŒè¯**

```java
@RestController
@RequestMapping("/api/orders")
public class OrderController {
    
    // éœ€è¦readæƒé™æ‰èƒ½æŸ¥è¯¢
    @PreAuthorize("hasAuthority('SCOPE_read')")
    @GetMapping("/{id}")
    public Order getOrder(@PathVariable Long id) {
        return orderService.findById(id);
    }
    
    // éœ€è¦writeæƒé™æ‰èƒ½åˆ›å»º
    @PreAuthorize("hasAuthority('SCOPE_write')")
    @PostMapping
    public Order createOrder(@RequestBody Order order) {
        return orderService.create(order);
    }
    
    // åŒæ—¶éœ€è¦å¤šä¸ªScope
    @PreAuthorize("hasAuthority('SCOPE_read') and hasAuthority('SCOPE_admin')")
    @GetMapping("/sensitive")
    public List<Order> getSensitiveOrders() {
        return orderService.findSensitive();
    }
}
```

### 4.3 Scopeçš„å®é™…åº”ç”¨


**ğŸ¯ ç¬¬ä¸‰æ–¹åº”ç”¨æˆæƒåœºæ™¯**

```
å¾®ä¿¡ç¬¬ä¸‰æ–¹ç™»å½•æµç¨‹ï¼š

1. ç”¨æˆ·æˆæƒæ—¶é€‰æ‹©æƒé™èŒƒå›´
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ æˆæƒç»™XXåº”ç”¨ï¼š        â”‚
   â”‚ â˜‘ï¸ è¯»å–åŸºæœ¬ä¿¡æ¯(read) â”‚
   â”‚ â˜‘ï¸ è·å–ç”¨æˆ·åˆ—è¡¨(read) â”‚
   â”‚ â˜ ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯(write)â”‚  â† ç”¨æˆ·å¯ä»¥ä¸å‹¾é€‰
   â”‚ â˜ åˆ é™¤ç”¨æˆ·(delete)   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

2. ç”ŸæˆTokenæ—¶åªåŒ…å«ç”¨æˆ·å‹¾é€‰çš„Scope
   {
     "access_token": "xxx",
     "scope": "read"  // åªæœ‰readæƒé™
   }

3. åº”ç”¨ä½¿ç”¨Tokenè®¿é—®æ—¶
   â†’ æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼šâœ… æˆåŠŸ(æœ‰readæƒé™)
   â†’ ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯ï¼šâŒ å¤±è´¥(æ²¡æœ‰writeæƒé™)
```

**ğŸ’¡ å®æˆ˜å»ºè®®**
```
Scopeè®¾è®¡åŸåˆ™ï¼š
1. æœ€å°æƒé™åŸåˆ™
   â†’ åªæˆäºˆå¿…éœ€çš„æƒé™
   â†’ ä¾‹å¦‚ï¼šåªè¯»APIåªç»™readï¼Œä¸ç»™write

2. åˆ†çº§æƒé™è®¾è®¡  
   â†’ read < write < admin
   â†’ ä¸Šçº§æƒé™åŒ…å«ä¸‹çº§æƒé™

3. ä¸šåŠ¡åœºæ™¯åˆ’åˆ†
   â†’ user:readã€order:writeã€product:admin
   â†’ æŒ‰ä¸šåŠ¡æ¨¡å—ç»†åˆ†æƒé™
```

---

## 5. ğŸ›¡ï¸ èµ„æºä¿æŠ¤ç­–ç•¥


### 5.1 å¤šå±‚é˜²æŠ¤æœºåˆ¶


**ğŸ” ä¸‰å±‚é˜²æŠ¤ä½“ç³»**

```
å®Œæ•´çš„èµ„æºä¿æŠ¤æµç¨‹ï¼š

ç¬¬1å±‚ï¼šç½‘å…³å±‚è¿‡æ»¤
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ é»‘åå•/ç™½åå•          â”‚
â”‚ â€¢ é™æµé˜²åˆ·               â”‚
â”‚ â€¢ åŸºç¡€TokenéªŒè¯          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
ç¬¬2å±‚ï¼šèµ„æºæœåŠ¡å™¨éªŒè¯
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ Tokenæœ‰æ•ˆæ€§            â”‚
â”‚ â€¢ æƒé™å’Œè§’è‰²æ£€æŸ¥         â”‚
â”‚ â€¢ ScopeéªŒè¯              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
ç¬¬3å±‚ï¼šä¸šåŠ¡é€»è¾‘éªŒè¯
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ æ•°æ®æƒé™               â”‚
â”‚ â€¢ ä¸šåŠ¡è§„åˆ™æ£€æŸ¥           â”‚
â”‚ â€¢ æ“ä½œå®¡è®¡æ—¥å¿—           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 é…ç½®èµ„æºæœåŠ¡å™¨


**ğŸ“‹ èµ„æºæœåŠ¡å™¨åŸºç¡€é…ç½®**

```java
@Configuration
@EnableResourceServer
public class ResourceServerConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            // é…ç½®OAuth2èµ„æºæœåŠ¡å™¨
            .oauth2ResourceServer(oauth2 -> oauth2
                .jwt(jwt -> jwt
                    // JWTéªŒè¯å™¨é…ç½®
                    .decoder(jwtDecoder())
                )
            )
            // æƒé™é…ç½®
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/public/**").permitAll()
                .anyRequest().authenticated()
            )
            // å¼‚å¸¸å¤„ç†
            .exceptionHandling(ex -> ex
                .authenticationEntryPoint(authenticationEntryPoint())
                .accessDeniedHandler(accessDeniedHandler())
            );
        
        return http.build();
    }
    
    // JWTè§£ç å™¨
    @Bean
    public JwtDecoder jwtDecoder() {
        // ä»æˆæƒæœåŠ¡å™¨è·å–å…¬é’¥éªŒè¯JWT
        return NimbusJwtDecoder.withJwkSetUri(
            "http://auth-server/oauth2/jwks"
        ).build();
    }
}
```

**ğŸ’¡ é…ç½®è¯´æ˜**
```
jwtDecoder()ï¼š
â†’ ä½œç”¨ï¼šéªŒè¯Tokençš„ç­¾åæ˜¯å¦æ­£ç¡®
â†’ åŸç†ï¼šç”¨å…¬é’¥éªŒè¯æˆæƒæœåŠ¡å™¨çš„ç­¾å
â†’ é˜²æ­¢ï¼šTokenè¢«ç¯¡æ”¹

authenticationEntryPoint()ï¼š
â†’ ä½œç”¨ï¼šå¤„ç†è®¤è¯å¤±è´¥(Tokenæ— æ•ˆ/è¿‡æœŸ)
â†’ è¿”å›ï¼š401 Unauthorized

accessDeniedHandler()ï¼š  
â†’ ä½œç”¨ï¼šå¤„ç†æˆæƒå¤±è´¥(æƒé™ä¸è¶³)
â†’ è¿”å›ï¼š403 Forbidden
```

### 5.3 TokenéªŒè¯æµç¨‹


**ğŸ” è¯¦ç»†éªŒè¯æ­¥éª¤**

```
å®¢æˆ·ç«¯è¯·æ±‚ â†’ èµ„æºæœåŠ¡å™¨éªŒè¯æµç¨‹ï¼š

æ­¥éª¤1ï¼šæå–Token
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä»è¯·æ±‚å¤´è·å–ï¼š                â”‚
â”‚ Authorization: Bearer xxx     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
æ­¥éª¤2ï¼šéªŒè¯Tokenç­¾å
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ ç”¨å…¬é’¥éªŒè¯ç­¾å              â”‚
â”‚ â€¢ æ£€æŸ¥æ˜¯å¦è¢«ç¯¡æ”¹              â”‚
â”‚ å¤±è´¥ â†’ è¿”å›401                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
æ­¥éª¤3ï¼šæ£€æŸ¥Tokenæœ‰æ•ˆæœŸ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ æ£€æŸ¥exp(è¿‡æœŸæ—¶é—´)           â”‚
â”‚ â€¢ æ£€æŸ¥iat(ç­¾å‘æ—¶é—´)           â”‚
â”‚ è¿‡æœŸ â†’ è¿”å›401                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
æ­¥éª¤4ï¼šæå–ç”¨æˆ·ä¿¡æ¯å’Œæƒé™
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ è§£æç”¨æˆ·IDã€ç”¨æˆ·å          â”‚
â”‚ â€¢ è§£æè§’è‰²(roles)            â”‚
â”‚ â€¢ è§£ææƒé™(scope)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
æ­¥éª¤5ï¼šæƒé™éªŒè¯
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ URLæƒé™åŒ¹é…                 â”‚
â”‚ â€¢ è§’è‰²éªŒè¯                    â”‚
â”‚ â€¢ ScopeéªŒè¯                   â”‚
â”‚ ä¸è¶³ â†’ è¿”å›403                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
æ­¥éª¤6ï¼šæ”¾è¡Œè¯·æ±‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ è®¾ç½®SecurityContext         â”‚
â”‚ â€¢ ä¼ é€’ç»™ä¸šåŠ¡Controller        â”‚
â”‚ æˆåŠŸ â†’ è¿”å›200                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.4 å¼‚å¸¸å¤„ç†é…ç½®


**ğŸ“‹ è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†**

```java
// è®¤è¯å¤±è´¥å¤„ç†(Tokenæ— æ•ˆ)
@Component
public class CustomAuthenticationEntryPoint 
    implements AuthenticationEntryPoint {
    
    @Override
    public void commence(HttpServletRequest request,
                        HttpServletResponse response,
                        AuthenticationException authException) {
        
        response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
        response.setContentType("application/json;charset=UTF-8");
        
        Map<String, Object> result = new HashMap<>();
        result.put("code", 401);
        result.put("message", "Tokenæ— æ•ˆæˆ–å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•");
        
        response.getWriter().write(
            new ObjectMapper().writeValueAsString(result)
        );
    }
}

// æˆæƒå¤±è´¥å¤„ç†(æƒé™ä¸è¶³)
@Component
public class CustomAccessDeniedHandler 
    implements AccessDeniedHandler {
    
    @Override
    public void handle(HttpServletRequest request,
                      HttpServletResponse response,
                      AccessDeniedException accessDeniedException) {
        
        response.setStatus(HttpServletResponse.SC_FORBIDDEN);
        response.setContentType("application/json;charset=UTF-8");
        
        Map<String, Object> result = new HashMap<>();
        result.put("code", 403);
        result.put("message", "æƒé™ä¸è¶³ï¼Œæ— æ³•è®¿é—®è¯¥èµ„æº");
        
        response.getWriter().write(
            new ObjectMapper().writeValueAsString(result)
        );
    }
}
```

**ğŸ’¡ å‰ç«¯å¯¹æ¥å»ºè®®**
```
é”™è¯¯ç å¤„ç†ï¼š
401 Unauthorized â†’ è·³è½¬ç™»å½•é¡µ
403 Forbidden    â†’ æç¤º"æƒé™ä¸è¶³"
500 Server Error â†’ æç¤º"ç³»ç»Ÿå¼‚å¸¸"

Tokenåˆ·æ–°ç­–ç•¥ï¼š
â€¢ æ”¶åˆ°401åï¼Œå°è¯•ç”¨Refresh Tokenè·å–æ–°Token
â€¢ æ–°Tokenè·å–æˆåŠŸ â†’ é‡è¯•åŸè¯·æ±‚
â€¢ è·å–å¤±è´¥ â†’ è·³è½¬ç™»å½•é¡µ
```

---

## 6. âš™ï¸ åŠ¨æ€æƒé™å®ç°


### 6.1 ä»€ä¹ˆæ˜¯åŠ¨æ€æƒé™


**é€šä¿—ç†è§£ï¼šå¯ä»¥éšæ—¶è°ƒæ•´çš„æƒé™è§„åˆ™**
```
é™æ€æƒé™(å†™æ­»åœ¨ä»£ç é‡Œ)ï¼š
@PreAuthorize("hasRole('ADMIN')")  â† æ”¹æƒé™è¦é‡æ–°å‘å¸ƒä»£ç 

åŠ¨æ€æƒé™(å­˜å‚¨åœ¨æ•°æ®åº“)ï¼š
æ•°æ®åº“é…ç½®ï¼š
/api/users  â†’ ROLE_ADMIN    â† åœ¨ç®¡ç†ç•Œé¢å°±èƒ½ä¿®æ”¹
/api/orders â†’ ROLE_USER     â† ä¸éœ€è¦æ”¹ä»£ç 
```

**ğŸ¯ åŠ¨æ€æƒé™çš„ä¼˜åŠ¿**

| å¯¹æ¯”é¡¹ | **é™æ€æƒé™** | **åŠ¨æ€æƒé™** |
|-------|-------------|-------------|
| **ä¿®æ”¹æ–¹å¼** | æ”¹ä»£ç é‡æ–°å‘å¸ƒ | æ•°æ®åº“é…ç½®å³æ—¶ç”Ÿæ•ˆ |
| **çµæ´»æ€§** | ä½ï¼Œç¡¬ç¼–ç  | é«˜ï¼Œå¯è§†åŒ–é…ç½® |
| **ç»´æŠ¤æˆæœ¬** | é«˜ | ä½ |
| **é€‚ç”¨åœºæ™¯** | å›ºå®šä¸å˜çš„æƒé™ | éœ€è¦ç»å¸¸è°ƒæ•´çš„æƒé™ |

### 6.2 åŠ¨æ€æƒé™æ•°æ®æ¨¡å‹


**ğŸ“Š æ•°æ®åº“è®¾è®¡**

```sql
-- èµ„æºè¡¨(URLå’Œæ¥å£)
CREATE TABLE sys_resource (
    id BIGINT PRIMARY KEY,
    url VARCHAR(200),           -- èµ„æºURL
    method VARCHAR(10),          -- HTTPæ–¹æ³•
    description VARCHAR(500),    -- èµ„æºæè¿°
    resource_type VARCHAR(50)    -- èµ„æºç±»å‹
);

-- è§’è‰²è¡¨
CREATE TABLE sys_role (
    id BIGINT PRIMARY KEY,
    role_code VARCHAR(50),      -- è§’è‰²ç¼–ç  ROLE_ADMIN
    role_name VARCHAR(100),     -- è§’è‰²åç§° ç®¡ç†å‘˜
    description VARCHAR(500)    -- è§’è‰²æè¿°
);

-- è§’è‰²-èµ„æºå…³è”è¡¨
CREATE TABLE sys_role_resource (
    id BIGINT PRIMARY KEY,
    role_id BIGINT,             -- è§’è‰²ID
    resource_id BIGINT,         -- èµ„æºID
    FOREIGN KEY (role_id) REFERENCES sys_role(id),
    FOREIGN KEY (resource_id) REFERENCES sys_resource(id)
);
```

**ğŸ’¡ ç¤ºä¾‹æ•°æ®**
```sql
-- èµ„æºæ•°æ®
INSERT INTO sys_resource VALUES 
(1, '/api/users/**', 'GET', 'æŸ¥è¯¢ç”¨æˆ·', 'API'),
(2, '/api/users/**', 'POST', 'åˆ›å»ºç”¨æˆ·', 'API'),
(3, '/api/orders/**', 'GET', 'æŸ¥è¯¢è®¢å•', 'API');

-- è§’è‰²æ•°æ®  
INSERT INTO sys_role VALUES
(1, 'ROLE_USER', 'æ™®é€šç”¨æˆ·', 'ç³»ç»Ÿæ™®é€šç”¨æˆ·'),
(2, 'ROLE_ADMIN', 'ç®¡ç†å‘˜', 'ç³»ç»Ÿç®¡ç†å‘˜');

-- æƒé™å…³è”
INSERT INTO sys_role_resource VALUES
(1, 1, 1),  -- USERè§’è‰²å¯ä»¥æŸ¥è¯¢ç”¨æˆ·
(2, 1, 3),  -- USERè§’è‰²å¯ä»¥æŸ¥è¯¢è®¢å•
(3, 2, 1),  -- ADMINè§’è‰²å¯ä»¥æŸ¥è¯¢ç”¨æˆ·
(4, 2, 2),  -- ADMINè§’è‰²å¯ä»¥åˆ›å»ºç”¨æˆ·
(5, 2, 3);  -- ADMINè§’è‰²å¯ä»¥æŸ¥è¯¢è®¢å•
```

### 6.3 åŠ¨æ€æƒé™åŠ è½½å®ç°


**ğŸ“‹ ä»æ•°æ®åº“åŠ è½½æƒé™é…ç½®**

```java
@Component
public class DynamicSecurityMetadataSource 
    implements FilterInvocationSecurityMetadataSource {
    
    @Autowired
    private ResourceService resourceService;
    
    // ç¼“å­˜æƒé™é…ç½®(é¿å…é¢‘ç¹æŸ¥æ•°æ®åº“)
    private Map<String, Collection<ConfigAttribute>> resourceMap = null;
    
    // åŠ è½½æ‰€æœ‰æƒé™é…ç½®
    public void loadResourceDefine() {
        resourceMap = new ConcurrentHashMap<>();
        
        // ä»æ•°æ®åº“æŸ¥è¯¢æ‰€æœ‰èµ„æºåŠå…¶éœ€è¦çš„è§’è‰²
        List<Resource> resources = resourceService.findAllWithRoles();
        
        for (Resource resource : resources) {
            String url = resource.getUrl();
            List<String> roles = resource.getRoles();
            
            // è½¬æ¢ä¸ºConfigAttribute
            Collection<ConfigAttribute> attributes = roles.stream()
                .map(role -> new SecurityConfig(role))
                .collect(Collectors.toList());
            
            resourceMap.put(url, attributes);
        }
    }
    
    // è·å–è®¿é—®è¯¥URLéœ€è¦çš„æƒé™
    @Override
    public Collection<ConfigAttribute> getAttributes(Object object) {
        String requestUrl = ((FilterInvocation) object).getRequestUrl();
        
        // éå†é…ç½®ï¼Œæ‰¾åˆ°åŒ¹é…çš„URL
        for (Map.Entry<String, Collection<ConfigAttribute>> entry 
            : resourceMap.entrySet()) {
            
            String pattern = entry.getKey();
            
            // ä½¿ç”¨AntPathMatcheråŒ¹é…URL
            if (pathMatcher.match(pattern, requestUrl)) {
                return entry.getValue();
            }
        }
        
        return null;
    }
    
    // åˆ·æ–°æƒé™é…ç½®(æƒé™å˜æ›´æ—¶è°ƒç”¨)
    public void refreshResource() {
        resourceMap.clear();
        loadResourceDefine();
    }
}
```

**ğŸ’¡ å·¥ä½œåŸç†**
```
è¯·æ±‚æµç¨‹ï¼š
1. ç”¨æˆ·è®¿é—® /api/users (GET)
   â†“
2. DynamicSecurityMetadataSourceæŸ¥æ‰¾é…ç½®
   â†’ åœ¨resourceMapä¸­æ‰¾åˆ°åŒ¹é…çš„URL
   â†’ è¿”å›è¯¥URLéœ€è¦çš„è§’è‰²: [ROLE_USER, ROLE_ADMIN]
   â†“
3. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰è¿™äº›è§’è‰²ä¹‹ä¸€
   â†’ æœ‰ â†’ æ”¾è¡Œ
   â†’ æ²¡æœ‰ â†’ è¿”å›403
```

### 6.4 åŠ¨æ€æƒé™å†³ç­–


**ğŸ“‹ è‡ªå®šä¹‰è®¿é—®å†³ç­–å™¨**

```java
@Component
public class DynamicAccessDecisionManager 
    implements AccessDecisionManager {
    
    @Override
    public void decide(Authentication authentication,
                      Object object,
                      Collection<ConfigAttribute> configAttributes) 
        throws AccessDeniedException {
        
        // å¦‚æœèµ„æºæ— éœ€æƒé™ï¼Œç›´æ¥æ”¾è¡Œ
        if (configAttributes == null || configAttributes.isEmpty()) {
            return;
        }
        
        // è·å–ç”¨æˆ·çš„æ‰€æœ‰è§’è‰²
        Collection<? extends GrantedAuthority> authorities = 
            authentication.getAuthorities();
        
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰æ‰€éœ€è§’è‰²ä¹‹ä¸€
        for (ConfigAttribute configAttribute : configAttributes) {
            String needRole = configAttribute.getAttribute();
            
            for (GrantedAuthority authority : authorities) {
                if (needRole.equals(authority.getAuthority())) {
                    // æ‰¾åˆ°åŒ¹é…è§’è‰²ï¼Œå…è®¸è®¿é—®
                    return;
                }
            }
        }
        
        // æ²¡æœ‰åŒ¹é…çš„è§’è‰²ï¼Œæ‹’ç»è®¿é—®
        throw new AccessDeniedException("æƒé™ä¸è¶³");
    }
}
```

### 6.5 æƒé™å®æ—¶æ›´æ–°


**ğŸ”„ æƒé™å˜æ›´å®æ—¶ç”Ÿæ•ˆ**

```java
@RestController
@RequestMapping("/api/permissions")
public class PermissionController {
    
    @Autowired
    private DynamicSecurityMetadataSource securityMetadataSource;
    
    // æ›´æ–°è§’è‰²æƒé™ååˆ·æ–°é…ç½®
    @PostMapping("/refresh")
    @PreAuthorize("hasRole('SUPER_ADMIN')")
    public Result refreshPermissions() {
        
        // åˆ·æ–°æƒé™é…ç½®ç¼“å­˜
        securityMetadataSource.refreshResource();
        
        return Result.success("æƒé™é…ç½®å·²æ›´æ–°");
    }
    
    // ç»™è§’è‰²åˆ†é…æ–°æƒé™
    @PostMapping("/assign")
    @PreAuthorize("hasRole('SUPER_ADMIN')")
    public Result assignPermission(@RequestBody AssignDTO dto) {
        
        // 1. ä¿å­˜åˆ°æ•°æ®åº“
        roleResourceService.assign(dto.getRoleId(), dto.getResourceId());
        
        // 2. åˆ·æ–°æƒé™é…ç½®
        securityMetadataSource.refreshResource();
        
        return Result.success("æƒé™åˆ†é…æˆåŠŸ");
    }
}
```

**ğŸ’¡ å®é™…åº”ç”¨æµç¨‹**
```
ç®¡ç†å‘˜åœ¨åå°æ“ä½œï¼š
1. è¿›å…¥æƒé™ç®¡ç†é¡µé¢
   â†“
2. é€‰æ‹©è§’è‰²"ROLE_USER"
   â†“
3. å‹¾é€‰æ–°çš„æƒé™"/api/reports/view"
   â†“
4. ç‚¹å‡»ä¿å­˜
   â†’ åç«¯ä¿å­˜åˆ°æ•°æ®åº“
   â†’ è°ƒç”¨refreshPermissions()åˆ·æ–°é…ç½®
   â†“
5. ç«‹å³ç”Ÿæ•ˆï¼
   â†’ æ™®é€šç”¨æˆ·é©¬ä¸Šå¯ä»¥è®¿é—®æŠ¥è¡¨æ¥å£
   â†’ ä¸éœ€è¦é‡å¯æœåŠ¡å™¨
```

> **âš ï¸ æ³¨æ„äº‹é¡¹**
> 
> åŠ¨æ€æƒé™è™½ç„¶çµæ´»ï¼Œä½†ä¹Ÿè¦æ³¨æ„ï¼š
> 
> 1. **æ€§èƒ½è€ƒè™‘**ï¼šæ¯æ¬¡è¯·æ±‚éƒ½æŸ¥æ•°æ®åº“ä¼šå¾ˆæ…¢
>    â†’ è§£å†³ï¼šä½¿ç”¨ç¼“å­˜ï¼Œå®šæœŸåˆ·æ–°
> 
> 2. **æ•°æ®ä¸€è‡´æ€§**ï¼šå¤šä¸ªæœåŠ¡å™¨çš„ç¼“å­˜å¯èƒ½ä¸åŒæ­¥
>    â†’ è§£å†³ï¼šä½¿ç”¨Redisç­‰åˆ†å¸ƒå¼ç¼“å­˜
> 
> 3. **æƒé™ç²’åº¦**ï¼šä¸è¦è®¾è®¡å¾—è¿‡äºå¤æ‚
>    â†’ å»ºè®®ï¼šä¿æŒç®€å•æ¸…æ™°çš„æƒé™æ¨¡å‹

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ èµ„æºè®¿é—®æ§åˆ¶ï¼šä¿æŠ¤APIæ¥å£ï¼Œé˜²æ­¢æœªæˆæƒè®¿é—®
ğŸ”¸ URLæƒé™é…ç½®ï¼šæ ¹æ®è®¿é—®è·¯å¾„å†³å®šæ˜¯å¦å…è®¸è®¿é—®
ğŸ”¸ è§’è‰²æ§åˆ¶ï¼šé€šè¿‡è§’è‰²(ROLE)ç®¡ç†ç”¨æˆ·æƒé™
ğŸ”¸ ScopeéªŒè¯ï¼šTokençº§åˆ«çš„ç»†ç²’åº¦æƒé™æ§åˆ¶
ğŸ”¸ èµ„æºä¿æŠ¤ï¼šå¤šå±‚é˜²æŠ¤ä¿éšœç³»ç»Ÿå®‰å…¨
ğŸ”¸ åŠ¨æ€æƒé™ï¼šå¯å®æ—¶è°ƒæ•´çš„çµæ´»æƒé™ç®¡ç†
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸‰ç§æƒé™æ§åˆ¶çš„åŒºåˆ«**
```
URLæƒé™ï¼š
â†’ ç²—ç²’åº¦ï¼ŒæŒ‰è·¯å¾„æ§åˆ¶
â†’ é€‚åˆï¼šå…¨å±€ç»Ÿä¸€çš„è®¿é—®è§„åˆ™

Roleè§’è‰²ï¼š
â†’ ä¸­ç²’åº¦ï¼ŒæŒ‰èº«ä»½æ§åˆ¶  
â†’ é€‚åˆï¼šå†…éƒ¨ç³»ç»Ÿçš„æƒé™ç®¡ç†

Scopeä½œç”¨åŸŸï¼š
â†’ ç»†ç²’åº¦ï¼ŒæŒ‰Tokenæ§åˆ¶
â†’ é€‚åˆï¼šç¬¬ä¸‰æ–¹æˆæƒåœºæ™¯
```

**ğŸ”¹ é™æ€æƒé™ vs åŠ¨æ€æƒé™**
```
é™æ€æƒé™ï¼š
âœ… ç®€å•ç›´æ¥ï¼Œæ€§èƒ½å¥½
âŒ ä¿®æ”¹éº»çƒ¦ï¼Œéœ€è¦é‡æ–°å‘å¸ƒ

åŠ¨æ€æƒé™ï¼š
âœ… çµæ´»å¯é…ï¼Œå®æ—¶ç”Ÿæ•ˆ
âŒ å¤æ‚åº¦é«˜ï¼Œéœ€è¦ç¼“å­˜ä¼˜åŒ–

é€‰æ‹©å»ºè®®ï¼š
â€¢ æ ¸å¿ƒåŠŸèƒ½ â†’ é™æ€æƒé™(å®‰å…¨ç¨³å®š)
â€¢ ä¸šåŠ¡æƒé™ â†’ åŠ¨æ€æƒé™(çµæ´»è°ƒæ•´)
```

**ğŸ”¹ æƒé™éªŒè¯çš„æ‰§è¡Œé¡ºåº**
```
1. TokenéªŒè¯ â†’ ç¡®è®¤èº«ä»½
2. URLåŒ¹é…  â†’ æ‰¾åˆ°éœ€è¦çš„æƒé™  
3. è§’è‰²æ£€æŸ¥ â†’ éªŒè¯ç”¨æˆ·è§’è‰²
4. Scopeæ£€æŸ¥ â†’ éªŒè¯Tokenæƒé™
5. ä¸šåŠ¡éªŒè¯ â†’ æ•°æ®æƒé™ç­‰

ä»»ä½•ä¸€æ­¥å¤±è´¥éƒ½ä¼šè¢«æ‹’ç»ï¼
```

### 7.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ æƒé™è®¾è®¡æœ€ä½³å®è·µ**
```
1. æœ€å°æƒé™åŸåˆ™
   â†’ åªç»™å¿…éœ€çš„æƒé™ï¼Œä¸è¦è¿‡åº¦æˆæƒ
   
2. èŒè´£åˆ†ç¦»åŸåˆ™  
   â†’ è¯»å†™åˆ†ç¦»ï¼ŒæŸ¥è¯¢å’Œä¿®æ”¹åˆ†å¼€æ§åˆ¶
   
3. é»˜è®¤æ‹’ç»åŸåˆ™
   â†’ æ²¡æœ‰æ˜ç¡®å…è®¸çš„ä¸€å¾‹æ‹’ç»

4. åˆ†å±‚é˜²æŠ¤åŸåˆ™
   â†’ ç½‘å…³ã€æœåŠ¡ã€æ•°æ®å¤šå±‚éªŒè¯
```

**âš¡ å¸¸è§é—®é¢˜ä¸è§£å†³**
```
é—®é¢˜1ï¼šæƒé™é…ç½®ä¸ç”Ÿæ•ˆï¼Ÿ
â†’ æ£€æŸ¥é¡ºåºï¼šå…·ä½“è§„åˆ™è¦åœ¨é€šç”¨è§„åˆ™å‰é¢
â†’ æ£€æŸ¥å‰ç¼€ï¼šScopeè¦åŠ SCOPE_å‰ç¼€

é—®é¢˜2ï¼šæ€§èƒ½é—®é¢˜ï¼Ÿ
â†’ ä½¿ç”¨ç¼“å­˜å‡å°‘æ•°æ®åº“æŸ¥è¯¢
â†’ åˆç†è®¾è®¡ç¼“å­˜åˆ·æ–°ç­–ç•¥

é—®é¢˜3ï¼šæƒé™è¿‡äºå¤æ‚ï¼Ÿ
â†’ ç®€åŒ–è§’è‰²å±‚çº§ï¼Œé¿å…è¿‡åº¦è®¾è®¡
â†’ ä½¿ç”¨è§’è‰²ç»§æ‰¿å‡å°‘é‡å¤é…ç½®
```

**ğŸ“š çŸ¥è¯†ç‚¹å›é¡¾**
- **URLæƒé™**ï¼š`requestMatchers("/api/**").authenticated()`
- **è§’è‰²éªŒè¯**ï¼š`hasRole("ADMIN")` æˆ– `@PreAuthorize`
- **ScopeéªŒè¯**ï¼š`hasAuthority("SCOPE_read")`
- **åŠ¨æ€æƒé™**ï¼šæ•°æ®åº“é…ç½® + ç¼“å­˜åˆ·æ–°
- **å¼‚å¸¸å¤„ç†**ï¼š401è®¤è¯å¤±è´¥ã€403æƒé™ä¸è¶³

**æ ¸å¿ƒè®°å¿†ï¼š**
- è®¿é—®æ§åˆ¶åˆ†ä¸‰å±‚ï¼šèº«ä»½ã€æƒé™ã€æ•°æ®
- é™æ€é…ç½®æ€§èƒ½å¥½ï¼ŒåŠ¨æ€é…ç½®æ›´çµæ´»
- URLç²—ã€Roleä¸­ã€Scopeç»†ï¼ŒæŒ‰éœ€é€‰æ‹©
- æœ€å°æƒé™ã€é»˜è®¤æ‹’ç»ã€åˆ†å±‚é˜²æŠ¤æ˜¯å…³é”®