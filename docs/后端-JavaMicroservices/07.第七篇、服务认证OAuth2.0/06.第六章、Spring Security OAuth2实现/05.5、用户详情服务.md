---
title: 5ã€ç”¨æˆ·è¯¦æƒ…æœåŠ¡
---
## ğŸ“š ç›®å½•

1. [UserDetailsServiceæ ¸å¿ƒæ¦‚å¿µ](#1-UserDetailsServiceæ ¸å¿ƒæ¦‚å¿µ)
2. [ç”¨æˆ·ä¿¡æ¯åŠ è½½æœºåˆ¶](#2-ç”¨æˆ·ä¿¡æ¯åŠ è½½æœºåˆ¶)
3. [å¯†ç ç¼–ç ä¸å®‰å…¨](#3-å¯†ç ç¼–ç ä¸å®‰å…¨)
4. [ç”¨æˆ·æƒé™ç®¡ç†](#4-ç”¨æˆ·æƒé™ç®¡ç†)
5. [æ•°æ®åº“é›†æˆå®æˆ˜](#5-æ•°æ®åº“é›†æˆå®æˆ˜)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” UserDetailsServiceæ ¸å¿ƒæ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯UserDetailsService


**é€šä¿—ç†è§£**ï¼šæƒ³è±¡ä½ å»é“¶è¡ŒåŠä¸šåŠ¡ï¼ŒæŸœå°å·¥ä½œäººå‘˜éœ€è¦æŸ¥è¯¢ä½ çš„è´¦æˆ·ä¿¡æ¯æ‰èƒ½ä¸ºä½ æœåŠ¡ã€‚UserDetailsServiceå°±åƒè¿™ä¸ª**æŸ¥è¯¢ç³»ç»Ÿ**ï¼Œå®ƒè´Ÿè´£æ ¹æ®ç”¨æˆ·åå»"æ•°æ®åº“"é‡ŒæŸ¥æ‰¾ç”¨æˆ·çš„å®Œæ•´ä¿¡æ¯ã€‚

**ğŸ¯ æ ¸å¿ƒå®šä¹‰**
```
UserDetailsService = ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢æ¥å£

ä½œç”¨ï¼šSpring Securityéœ€è¦éªŒè¯ç”¨æˆ·æ—¶ï¼Œé€šè¿‡è¿™ä¸ªæ¥å£è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
è¾“å…¥ï¼šç”¨æˆ·åï¼ˆusernameï¼‰
è¾“å‡ºï¼šç”¨æˆ·è¯¦æƒ…å¯¹è±¡ï¼ˆUserDetailsï¼‰ï¼ŒåŒ…å«å¯†ç ã€æƒé™ç­‰
```

**ä¸ºä»€ä¹ˆéœ€è¦å®ƒ**ï¼Ÿ
```
ç™»å½•æµç¨‹çš„å…³é”®ç¯èŠ‚ï¼š

ç”¨æˆ·è¾“å…¥è´¦å·å¯†ç 
      â†“
Spring Securityæ‹¿åˆ°ç”¨æˆ·å
      â†“
è°ƒç”¨UserDetailsServiceæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯  â† è¿™ä¸€æ­¥ï¼
      â†“
æ¯”å¯¹å¯†ç æ˜¯å¦æ­£ç¡®
      â†“
æ£€æŸ¥ç”¨æˆ·æƒé™
      â†“
ç™»å½•æˆåŠŸ/å¤±è´¥
```

### 1.2 UserDetailsServiceæ¥å£ç»“æ„


**ğŸ”¸ æ¥å£å®šä¹‰**ï¼ˆè¶…çº§ç®€å•ï¼‰
```java
public interface UserDetailsService {
    // åªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼æ ¹æ®ç”¨æˆ·ååŠ è½½ç”¨æˆ·ä¿¡æ¯
    UserDetails loadUserByUsername(String username) 
        throws UsernameNotFoundException;
}
```

**ğŸ”¹ æ ¸å¿ƒæ–¹æ³•è§£æ**

| æ–¹æ³• | **ä½œç”¨** | **å‚æ•°** | **è¿”å›å€¼** |
|------|---------|---------|-----------|
| `loadUserByUsername` | æ ¹æ®ç”¨æˆ·åæŸ¥æ‰¾ç”¨æˆ· | `username`ï¼šç”¨æˆ·ç™»å½•å | `UserDetails`ï¼šç”¨æˆ·è¯¦æƒ…å¯¹è±¡ |

**ğŸ”¸ UserDetailså¯¹è±¡æ˜¯ä»€ä¹ˆ**ï¼Ÿ
```
UserDetails = ç”¨æˆ·çš„"èº«ä»½è¯"

åŒ…å«ä¿¡æ¯ï¼š
â”œâ”€ ç”¨æˆ·åï¼ˆgetUsernameï¼‰
â”œâ”€ å¯†ç ï¼ˆgetPasswordï¼‰  
â”œâ”€ æƒé™åˆ—è¡¨ï¼ˆgetAuthoritiesï¼‰
â”œâ”€ è´¦å·çŠ¶æ€ï¼ˆæ˜¯å¦è¿‡æœŸã€æ˜¯å¦é”å®šç­‰ï¼‰
â””â”€ å…¶ä»–è‡ªå®šä¹‰ä¿¡æ¯
```

### 1.3 å·¥ä½œæµç¨‹å…¨æ™¯


**ğŸ“Š å®Œæ•´è®¤è¯æµç¨‹**
```
1. ç”¨æˆ·æäº¤ç™»å½•è¡¨å•
   POST /login
   {username: "zhangsan", password: "123456"}
         â†“
2. Spring Securityæ‹¦æˆªè¯·æ±‚
   UsernamePasswordAuthenticationFilter
         â†“
3. è°ƒç”¨AuthenticationManagerè¿›è¡Œè®¤è¯
         â†“
4. AuthenticationManagerå§”æ‰˜ç»™UserDetailsService
   è°ƒç”¨ï¼šloadUserByUsername("zhangsan")
         â†“
5. UserDetailsServiceä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·
   SELECT * FROM users WHERE username = 'zhangsan'
         â†“
6. è¿”å›UserDetailså¯¹è±¡
   {username: "zhangsan", password: "$2a$10...", authorities: ["ROLE_USER"]}
         â†“
7. PasswordEncoderæ¯”å¯¹å¯†ç 
   è¾“å…¥å¯†ç  vs æ•°æ®åº“å¯†ç 
         â†“
8. è®¤è¯æˆåŠŸï¼Œåˆ›å»ºAuthenticationå¯¹è±¡
   å­˜å…¥SecurityContext
```

> ğŸ’¡ **æ–°æ‰‹æç¤º**ï¼šUserDetailsServiceåªè´Ÿè´£"æŸ¥äºº"ï¼Œä¸è´Ÿè´£"éªŒå¯†ç "ã€‚å¯†ç éªŒè¯ç”±PasswordEncoderå®Œæˆã€‚

---

## 2. ğŸ“– ç”¨æˆ·ä¿¡æ¯åŠ è½½æœºåˆ¶


### 2.1 è‡ªå®šä¹‰UserDetailsServiceå®ç°


**ğŸ”§ æœ€ç®€å•çš„å®ç°æ–¹å¼**
```java
@Service
public class MyUserDetailsService implements UserDetailsService {
    
    @Autowired
    private UserRepository userRepository;  // æ•°æ®åº“æ“ä½œ
    
    @Override
    public UserDetails loadUserByUsername(String username) 
            throws UsernameNotFoundException {
        
        // æ­¥éª¤1ï¼šä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·
        User user = userRepository.findByUsername(username);
        
        // æ­¥éª¤2ï¼šç”¨æˆ·ä¸å­˜åœ¨åˆ™æŠ›å¼‚å¸¸
        if (user == null) {
            throw new UsernameNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨ï¼š" + username);
        }
        
        // æ­¥éª¤3ï¼šæ„å»ºUserDetailså¯¹è±¡å¹¶è¿”å›
        return org.springframework.security.core.userdetails.User
                .withUsername(user.getUsername())
                .password(user.getPassword())      // åŠ å¯†åçš„å¯†ç 
                .authorities(user.getRoles())      // ç”¨æˆ·è§’è‰²
                .accountExpired(false)             // è´¦å·æ˜¯å¦è¿‡æœŸ
                .accountLocked(false)              // è´¦å·æ˜¯å¦é”å®š
                .credentialsExpired(false)         // å¯†ç æ˜¯å¦è¿‡æœŸ
                .disabled(false)                   // è´¦å·æ˜¯å¦ç¦ç”¨
                .build();
    }
}
```

**ğŸ” ä»£ç è¯¦è§£**

**æ­¥éª¤1 - æŸ¥è¯¢ç”¨æˆ·**
- é€šè¿‡Repositoryä»æ•°æ®åº“æŸ¥è¯¢
- ä½¿ç”¨ç”¨æˆ·åä½œä¸ºæŸ¥è¯¢æ¡ä»¶
- è¿”å›çš„Useræ˜¯ä½ è‡ªå·±å®šä¹‰çš„å®ä½“ç±»

**æ­¥éª¤2 - å¼‚å¸¸å¤„ç†**
- ç”¨æˆ·ä¸å­˜åœ¨å¿…é¡»æŠ›`UsernameNotFoundException`
- Spring Securityä¼šæ•è·è¿™ä¸ªå¼‚å¸¸ï¼Œæ˜¾ç¤º"ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"

**æ­¥éª¤3 - æ„å»ºUserDetails**
- ä½¿ç”¨Builderæ¨¡å¼æ„å»ºå¯¹è±¡
- è®¾ç½®è´¦å·çš„å„ç§çŠ¶æ€
- æœ€ç»ˆè¿”å›ç»™Spring Securityä½¿ç”¨

### 2.2 ç”¨æˆ·å®ä½“ç±»è®¾è®¡


**ğŸ—‚ï¸ æ•°æ®åº“Userè¡¨ç»“æ„**
```
users è¡¨
â”œâ”€ id (ä¸»é”®)
â”œâ”€ username (ç”¨æˆ·åï¼Œå”¯ä¸€ç´¢å¼•)
â”œâ”€ password (åŠ å¯†å¯†ç )
â”œâ”€ email (é‚®ç®±)
â”œâ”€ enabled (æ˜¯å¦å¯ç”¨)
â”œâ”€ account_locked (æ˜¯å¦é”å®š)
â”œâ”€ created_at (åˆ›å»ºæ—¶é—´)
â””â”€ updated_at (æ›´æ–°æ—¶é—´)
```

**ğŸ”¸ å¯¹åº”çš„Javaå®ä½“ç±»**
```java
@Entity
@Table(name = "users")
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(unique = true, nullable = false)
    private String username;
    
    @Column(nullable = false)
    private String password;
    
    private String email;
    
    @Column(name = "enabled")
    private Boolean enabled = true;
    
    @Column(name = "account_locked")
    private Boolean accountLocked = false;
    
    // ç”¨æˆ·æ‹¥æœ‰çš„è§’è‰²ï¼ˆä¸€å¯¹å¤šå…³ç³»ï¼‰
    @ManyToMany(fetch = FetchType.EAGER)
    @JoinTable(name = "user_roles",
        joinColumns = @JoinColumn(name = "user_id"),
        inverseJoinColumns = @JoinColumn(name = "role_id"))
    private Set<Role> roles = new HashSet<>();
    
    // getter/setter...
}
```

> âš ï¸ **é‡è¦æé†’**ï¼š
> - `password`å­—æ®µå­˜å‚¨çš„æ˜¯**åŠ å¯†å**çš„å¯†ç ï¼Œç»ä¸èƒ½å­˜æ˜æ–‡
> - `username`è¦è®¾ç½®å”¯ä¸€ç´¢å¼•ï¼Œé˜²æ­¢é‡å¤æ³¨å†Œ
> - è§’è‰²å…³ç³»ç”¨`EAGER`åŠ è½½ï¼Œç™»å½•æ—¶éœ€è¦ç«‹å³è·å–æƒé™

### 2.3 è‡ªå®šä¹‰UserDetailså®ç°


**ğŸ¯ ä¸ºä»€ä¹ˆè¦è‡ªå®šä¹‰**ï¼Ÿ

å†…ç½®çš„`User`ç±»åŠŸèƒ½æœ‰é™ï¼Œå®é™…é¡¹ç›®ä¸­æˆ‘ä»¬éœ€è¦ï¼š
- æ·»åŠ æ›´å¤šç”¨æˆ·å­—æ®µï¼ˆé‚®ç®±ã€æ‰‹æœºå·ç­‰ï¼‰
- è‡ªå®šä¹‰æƒé™é€»è¾‘
- æ›´çµæ´»çš„è´¦å·çŠ¶æ€æ§åˆ¶

**ğŸ”§ è‡ªå®šä¹‰UserDetailså®ç°**
```java
public class CustomUserDetails implements UserDetails {
    
    private final User user;  // ç»„åˆæˆ‘ä»¬çš„Userå®ä½“
    
    public CustomUserDetails(User user) {
        this.user = user;
    }
    
    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() {
        // å°†è§’è‰²è½¬æ¢ä¸ºæƒé™
        return user.getRoles().stream()
                .map(role -> new SimpleGrantedAuthority(role.getName()))
                .collect(Collectors.toList());
    }
    
    @Override
    public String getPassword() {
        return user.getPassword();
    }
    
    @Override
    public String getUsername() {
        return user.getUsername();
    }
    
    @Override
    public boolean isAccountNonExpired() {
        return true;  // è´¦å·æœªè¿‡æœŸ
    }
    
    @Override
    public boolean isAccountNonLocked() {
        return !user.getAccountLocked();  // æ ¹æ®æ•°æ®åº“å­—æ®µåˆ¤æ–­
    }
    
    @Override
    public boolean isCredentialsNonExpired() {
        return true;  // å¯†ç æœªè¿‡æœŸ
    }
    
    @Override
    public boolean isEnabled() {
        return user.getEnabled();  // æ ¹æ®æ•°æ®åº“å­—æ®µåˆ¤æ–­
    }
    
    // é¢å¤–æä¾›è·å–åŸå§‹Userå¯¹è±¡çš„æ–¹æ³•
    public User getUser() {
        return user;
    }
}
```

**ğŸ”¹ ä½¿ç”¨è‡ªå®šä¹‰UserDetails**
```java
@Service
public class CustomUserDetailsService implements UserDetailsService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Override
    public UserDetails loadUserByUsername(String username) {
        User user = userRepository.findByUsername(username);
        
        if (user == null) {
            throw new UsernameNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨");
        }
        
        // è¿”å›æˆ‘ä»¬è‡ªå®šä¹‰çš„UserDetails
        return new CustomUserDetails(user);
    }
}
```

---

## 3. ğŸ”’ å¯†ç ç¼–ç ä¸å®‰å…¨


### 3.1 å¯†ç ç¼–ç å™¨PasswordEncoder


**ğŸ”¸ ä¸ºä»€ä¹ˆè¦åŠ å¯†å¯†ç **ï¼Ÿ

| å­˜å‚¨æ–¹å¼ | **é£é™©** | **åæœ** |
|---------|---------|---------|
| æ˜æ–‡å­˜å‚¨ `password="123456"` | æ•°æ®åº“æ³„éœ²ç«‹å³æš´éœ²æ‰€æœ‰å¯†ç  | âŒ æåº¦å±é™© |
| MD5åŠ å¯† `password="e10adc..."` | å½©è™¹è¡¨å¯ç ´è§£ | âŒ ä¸å®‰å…¨ |
| BCryptåŠ å¯† `password="$2a$10..."` | åŠ ç›å“ˆå¸Œï¼Œæ¯æ¬¡ç»“æœä¸åŒ | âœ… å®‰å…¨ |

**ğŸ¯ BCryptåŠ å¯†åŸç†**
```
ç”¨æˆ·æ³¨å†Œå¯†ç ï¼š"123456"
         â†“
BCryptåŠ å¯†ï¼ˆè‡ªåŠ¨åŠ ç›ï¼‰
         â†“
å­˜å‚¨åˆ°æ•°æ®åº“ï¼š"$2a$10$N9qo8uLOickgx2ZMRZoMye..."
         â†“
ä¸‹æ¬¡ç”¨æˆ·ç™»å½•
è¾“å…¥ï¼š"123456"
         â†“
BCryptéªŒè¯ï¼ˆè‡ªåŠ¨æå–ç›å€¼ï¼‰
         â†“
éªŒè¯æˆåŠŸ âœ…
```

> ğŸ’¡ **BCryptç‰¹ç‚¹**ï¼š
> - åŒæ ·çš„å¯†ç ï¼Œæ¯æ¬¡åŠ å¯†ç»“æœéƒ½ä¸åŒï¼ˆå› ä¸ºç›å€¼éšæœºï¼‰
> - ä½†éªŒè¯æ—¶èƒ½æ­£ç¡®è¯†åˆ«ï¼ˆç›å€¼ä¿å­˜åœ¨å¯†æ–‡ä¸­ï¼‰
> - è®¡ç®—å¤æ‚åº¦å¯è°ƒï¼Œé˜²æ­¢æš´åŠ›ç ´è§£

### 3.2 é…ç½®å¯†ç ç¼–ç å™¨


**ğŸ”§ åœ¨é…ç½®ç±»ä¸­æ³¨å†Œ**
```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Bean
    public PasswordEncoder passwordEncoder() {
        // ä½¿ç”¨BCryptå¼ºåŠ å¯†
        return new BCryptPasswordEncoder();
    }
    
    @Bean
    public AuthenticationManager authenticationManager(
            AuthenticationConfiguration config) throws Exception {
        return config.getAuthenticationManager();
    }
}
```

**ğŸ”¸ ç”¨æˆ·æ³¨å†Œæ—¶åŠ å¯†å¯†ç **
```java
@Service
public class UserService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Autowired
    private PasswordEncoder passwordEncoder;
    
    public void registerUser(String username, String rawPassword) {
        User user = new User();
        user.setUsername(username);
        
        // åŠ å¯†å¯†ç åå†ä¿å­˜
        String encodedPassword = passwordEncoder.encode(rawPassword);
        user.setPassword(encodedPassword);
        
        userRepository.save(user);
    }
}
```

**ç™»å½•æ—¶çš„å¯†ç éªŒè¯æµç¨‹**
```
ç”¨æˆ·è¾“å…¥å¯†ç ï¼š"123456"
      â†“
Spring Securityè·å–æ•°æ®åº“ä¸­çš„å¯†ç ï¼š
"$2a$10$N9qo8uLOickgx2ZMRZoMye..."
      â†“
è°ƒç”¨ passwordEncoder.matches("123456", "$2a$10$...")
      â†“
BCryptæå–ç›å€¼ï¼Œé‡æ–°è®¡ç®—å“ˆå¸Œ
      â†“
å¯¹æ¯”ç»“æœï¼šåŒ¹é… â†’ ç™»å½•æˆåŠŸ âœ…
```

### 3.3 å¯†ç å¼ºåº¦ç­–ç•¥


**ğŸ›¡ï¸ å¯†ç éªŒè¯è§„åˆ™**
```java
@Component
public class PasswordValidator {
    
    public boolean isValid(String password) {
        if (password == null || password.length() < 8) {
            return false;  // è‡³å°‘8ä½
        }
        
        // å¿…é¡»åŒ…å«ï¼šå¤§å†™å­—æ¯ã€å°å†™å­—æ¯ã€æ•°å­—
        boolean hasUpper = password.chars().anyMatch(Character::isUpperCase);
        boolean hasLower = password.chars().anyMatch(Character::isLowerCase);
        boolean hasDigit = password.chars().anyMatch(Character::isDigit);
        
        return hasUpper && hasLower && hasDigit;
    }
}
```

**å¯†ç å¼ºåº¦ç­‰çº§**
```
å¼±å¯†ç ï¼ˆä¸æ¨èï¼‰ï¼š
âŒ "123456"
âŒ "password"
âŒ "qwerty"

ä¸­ç­‰å¯†ç ï¼š
âš ï¸  "Pass1234"    // ç¼ºå°‘ç‰¹æ®Šå­—ç¬¦
âš ï¸  "MyPassword"  // ç¼ºå°‘æ•°å­—

å¼ºå¯†ç ï¼ˆæ¨èï¼‰ï¼š
âœ… "MyP@ssw0rd!"  // å¤§å°å†™+æ•°å­—+ç‰¹æ®Šå­—ç¬¦
âœ… "Secure#2024"
```

---

## 4. ğŸ‘¥ ç”¨æˆ·æƒé™ç®¡ç†


### 4.1 æƒé™ä¸è§’è‰²çš„åŒºåˆ«


**ğŸ” æ¦‚å¿µç†è§£**

**è§’è‰²ï¼ˆRoleï¼‰**ï¼šç”¨æˆ·çš„èº«ä»½æ ‡ç­¾
```
ä¾‹å­ï¼š
â”œâ”€ ROLE_ADMIN    â†’ ç®¡ç†å‘˜
â”œâ”€ ROLE_USER     â†’ æ™®é€šç”¨æˆ·
â””â”€ ROLE_VIP      â†’ VIPç”¨æˆ·
```

**æƒé™ï¼ˆAuthorityï¼‰**ï¼šå…·ä½“çš„æ“ä½œæƒé™
```
ä¾‹å­ï¼š
â”œâ”€ USER_READ     â†’ æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯
â”œâ”€ USER_WRITE    â†’ ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯
â”œâ”€ USER_DELETE   â†’ åˆ é™¤ç”¨æˆ·
â””â”€ ORDER_CREATE  â†’ åˆ›å»ºè®¢å•
```

**å…³ç³»å¯¹æ¯”**
```
ä¼ ç»Ÿæ–¹å¼ï¼ˆåŸºäºè§’è‰²ï¼‰ï¼š
ç”¨æˆ· â†’ è§’è‰² â†’ æƒé™æ£€æŸ¥

RBACæ–¹å¼ï¼ˆåŸºäºæƒé™ï¼‰ï¼š
ç”¨æˆ· â†’ è§’è‰² â†’ æƒé™åˆ—è¡¨ â†’ æƒé™æ£€æŸ¥

å®é™…é¡¹ç›®ä¸­ï¼š
é€šå¸¸æ··åˆä½¿ç”¨ï¼Œè§’è‰²åŒ…å«ä¸€ç»„æƒé™
```

### 4.2 è§’è‰²è¡¨è®¾è®¡


**ğŸ—‚ï¸ æ•°æ®åº“è¡¨ç»“æ„**
```
roles è¡¨ï¼ˆè§’è‰²è¡¨ï¼‰
â”œâ”€ id
â”œâ”€ nameï¼ˆè§’è‰²åï¼Œå¦‚ROLE_ADMINï¼‰
â””â”€ descriptionï¼ˆè§’è‰²æè¿°ï¼‰

user_roles è¡¨ï¼ˆç”¨æˆ·-è§’è‰²å…³è”è¡¨ï¼‰
â”œâ”€ user_idï¼ˆå¤–é”® â†’ users.idï¼‰
â””â”€ role_idï¼ˆå¤–é”® â†’ roles.idï¼‰

æƒé™ç¤ºä¾‹æ•°æ®ï¼š
INSERT INTO roles VALUES 
(1, 'ROLE_ADMIN', 'ç®¡ç†å‘˜'),
(2, 'ROLE_USER', 'æ™®é€šç”¨æˆ·'),
(3, 'ROLE_VIP', 'VIPç”¨æˆ·');
```

**ğŸ”¸ è§’è‰²å®ä½“ç±»**
```java
@Entity
@Table(name = "roles")
public class Role {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(unique = true, nullable = false)
    private String name;  // ROLE_ADMIN
    
    private String description;
    
    // å¤šå¯¹å¤šå…³ç³»ï¼šå¤šä¸ªè§’è‰²å¯ä»¥åˆ†é…ç»™å¤šä¸ªç”¨æˆ·
    @ManyToMany(mappedBy = "roles")
    private Set<User> users = new HashSet<>();
    
    // getter/setter...
}
```

### 4.3 æƒé™åŠ è½½å®ç°


**ğŸ”§ ä»æ•°æ®åº“åŠ è½½ç”¨æˆ·æƒé™**
```java
@Service
public class CustomUserDetailsService implements UserDetailsService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Override
    public UserDetails loadUserByUsername(String username) {
        User user = userRepository.findByUsername(username);
        
        if (user == null) {
            throw new UsernameNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨");
        }
        
        // æ„å»ºæƒé™åˆ—è¡¨
        List<GrantedAuthority> authorities = user.getRoles().stream()
                .map(role -> new SimpleGrantedAuthority(role.getName()))
                .collect(Collectors.toList());
        
        return new org.springframework.security.core.userdetails.User(
                user.getUsername(),
                user.getPassword(),
                user.getEnabled(),
                true, true, true,
                authorities  // æƒé™åˆ—è¡¨
        );
    }
}
```

**ğŸ”¹ æƒé™æ£€æŸ¥ç¤ºä¾‹**
```java
@RestController
@RequestMapping("/api/users")
public class UserController {
    
    // åªæœ‰ADMINè§’è‰²å¯ä»¥è®¿é—®
    @PreAuthorize("hasRole('ADMIN')")
    @GetMapping("/all")
    public List<User> getAllUsers() {
        return userService.findAll();
    }
    
    // åªæœ‰ADMINæˆ–VIPå¯ä»¥è®¿é—®
    @PreAuthorize("hasAnyRole('ADMIN', 'VIP')")
    @GetMapping("/vip-content")
    public String getVipContent() {
        return "VIPä¸“å±å†…å®¹";
    }
    
    // éœ€è¦ç‰¹å®šæƒé™
    @PreAuthorize("hasAuthority('USER_DELETE')")
    @DeleteMapping("/{id}")
    public void deleteUser(@PathVariable Long id) {
        userService.delete(id);
    }
}
```

> ğŸ’¡ **æ³¨æ„**ï¼š
> - `hasRole('ADMIN')` ä¼šè‡ªåŠ¨æ·»åŠ  `ROLE_` å‰ç¼€
> - æ•°æ®åº“ä¸­å­˜å‚¨ä¸º `ROLE_ADMIN`
> - `hasAuthority('USER_DELETE')` ä¸æ·»åŠ å‰ç¼€ï¼Œéœ€å®Œå…¨åŒ¹é…

### 4.4 åŠ¨æ€æƒé™é…ç½®


**ğŸ”§ åŸºäºæ•°æ®åº“çš„æƒé™é…ç½®**
```java
@Configuration
@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class SecurityConfig {
    
    @Autowired
    private CustomUserDetailsService userDetailsService;
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/api/public/**").permitAll()
                .requestMatchers("/api/admin/**").hasRole("ADMIN")
                .requestMatchers("/api/user/**").hasAnyRole("USER", "ADMIN")
                .anyRequest().authenticated()
            )
            .userDetailsService(userDetailsService);  // æ³¨å…¥è‡ªå®šä¹‰æœåŠ¡
        
        return http.build();
    }
}
```

**æƒé™å±‚çº§ç¤ºä¾‹**
```
æƒé™å±‚çº§æ ‘ï¼š
ROLE_ADMINï¼ˆæœ€é«˜æƒé™ï¼‰
    â”œâ”€ å¯ä»¥è®¿é—®æ‰€æœ‰/api/admin/**æ¥å£
    â”œâ”€ å¯ä»¥è®¿é—®æ‰€æœ‰/api/user/**æ¥å£
    â””â”€ å¯ä»¥è®¿é—®æ‰€æœ‰/api/public/**æ¥å£

ROLE_USERï¼ˆæ™®é€šæƒé™ï¼‰
    â”œâ”€ å¯ä»¥è®¿é—®/api/user/**æ¥å£
    â””â”€ å¯ä»¥è®¿é—®/api/public/**æ¥å£

åŒ¿åç”¨æˆ·ï¼ˆæ— æƒé™ï¼‰
    â””â”€ åªèƒ½è®¿é—®/api/public/**æ¥å£
```

---

## 5. ğŸ’¾ æ•°æ®åº“é›†æˆå®æˆ˜


### 5.1 å®Œæ•´é›†æˆæ¶æ„


**ğŸ“Š ç³»ç»Ÿæ¶æ„å›¾**
```
ç”¨æˆ·è¯·æ±‚
    â†“
Controllerå±‚ï¼ˆæ¥æ”¶è¯·æ±‚ï¼‰
    â†“
Spring Securityæ‹¦æˆª
    â†“
UserDetailsServiceï¼ˆæŸ¥è¯¢ç”¨æˆ·ï¼‰
    â†“
Repositoryå±‚ï¼ˆæ•°æ®åº“æ“ä½œï¼‰
    â†“
MySQLæ•°æ®åº“
    â”œâ”€ usersè¡¨
    â”œâ”€ rolesè¡¨
    â””â”€ user_rolesè¡¨
```

**ğŸ”§ å®Œæ•´é…ç½®æ­¥éª¤**

**æ­¥éª¤1ï¼šæ·»åŠ ä¾èµ–**
```xml
<dependencies>
    <!-- Spring Security -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-security</artifactId>
    </dependency>
    
    <!-- JPAæ•°æ®åº“æ“ä½œ -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-data-jpa</artifactId>
    </dependency>
    
    <!-- MySQLé©±åŠ¨ -->
    <dependency>
        <groupId>mysql</groupId>
        <artifactId>mysql-connector-java</artifactId>
    </dependency>
</dependencies>
```

**æ­¥éª¤2ï¼šé…ç½®æ•°æ®æº**
```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/auth_db?useSSL=false
    username: root
    password: 123456
    driver-class-name: com.mysql.cj.jdbc.Driver
  
  jpa:
    hibernate:
      ddl-auto: update  # è‡ªåŠ¨åˆ›å»º/æ›´æ–°è¡¨ç»“æ„
    show-sql: true      # æ˜¾ç¤ºSQLè¯­å¥
```

### 5.2 Repositoryå±‚å®ç°


**ğŸ”¸ ç”¨æˆ·æ•°æ®è®¿é—®å±‚**
```java
@Repository
public interface UserRepository extends JpaRepository<User, Long> {
    
    // æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ï¼ˆç™»å½•ç”¨ï¼‰
    Optional<User> findByUsername(String username);
    
    // æ ¹æ®é‚®ç®±æŸ¥è¯¢
    Optional<User> findByEmail(String email);
    
    // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å­˜åœ¨
    boolean existsByUsername(String username);
}
```

**ğŸ”¸ è§’è‰²æ•°æ®è®¿é—®å±‚**
```java
@Repository
public interface RoleRepository extends JpaRepository<Role, Long> {
    
    // æ ¹æ®è§’è‰²åæŸ¥è¯¢
    Optional<Role> findByName(String name);
}
```

### 5.3 Serviceä¸šåŠ¡å±‚


**ğŸ”§ ç”¨æˆ·æœåŠ¡å®ç°**
```java
@Service
public class UserService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Autowired
    private RoleRepository roleRepository;
    
    @Autowired
    private PasswordEncoder passwordEncoder;
    
    /**
     * ç”¨æˆ·æ³¨å†Œ
     */
    public User registerUser(String username, String password, String email) {
        // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å­˜åœ¨
        if (userRepository.existsByUsername(username)) {
            throw new RuntimeException("ç”¨æˆ·åå·²å­˜åœ¨");
        }
        
        User user = new User();
        user.setUsername(username);
        user.setPassword(passwordEncoder.encode(password));  // åŠ å¯†
        user.setEmail(email);
        user.setEnabled(true);
        
        // åˆ†é…é»˜è®¤è§’è‰²
        Role userRole = roleRepository.findByName("ROLE_USER")
                .orElseThrow(() -> new RuntimeException("è§’è‰²ä¸å­˜åœ¨"));
        user.getRoles().add(userRole);
        
        return userRepository.save(user);
    }
    
    /**
     * åˆ†é…è§’è‰²
     */
    public void assignRole(Long userId, String roleName) {
        User user = userRepository.findById(userId)
                .orElseThrow(() -> new RuntimeException("ç”¨æˆ·ä¸å­˜åœ¨"));
        
        Role role = roleRepository.findByName(roleName)
                .orElseThrow(() -> new RuntimeException("è§’è‰²ä¸å­˜åœ¨"));
        
        user.getRoles().add(role);
        userRepository.save(user);
    }
}
```

### 5.4 å®Œæ•´çš„UserDetailsService


**ğŸ”§ æœ€ç»ˆå®ç°ç‰ˆæœ¬**
```java
@Service
public class DatabaseUserDetailsService implements UserDetailsService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Override
    public UserDetails loadUserByUsername(String username) 
            throws UsernameNotFoundException {
        
        // ä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·ï¼ˆåŒ…å«è§’è‰²ä¿¡æ¯ï¼‰
        User user = userRepository.findByUsername(username)
                .orElseThrow(() -> 
                    new UsernameNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨ï¼š" + username));
        
        // è½¬æ¢è§’è‰²ä¸ºæƒé™
        List<GrantedAuthority> authorities = user.getRoles().stream()
                .map(role -> new SimpleGrantedAuthority(role.getName()))
                .collect(Collectors.toList());
        
        // æ„å»ºUserDetailså¯¹è±¡
        return org.springframework.security.core.userdetails.User.builder()
                .username(user.getUsername())
                .password(user.getPassword())
                .authorities(authorities)
                .accountExpired(false)
                .accountLocked(user.getAccountLocked())
                .credentialsExpired(false)
                .disabled(!user.getEnabled())
                .build();
    }
}
```

### 5.5 æµ‹è¯•æ•°æ®åˆå§‹åŒ–


**ğŸ”¸ åˆå§‹åŒ–è„šæœ¬**
```java
@Component
public class DataInitializer implements CommandLineRunner {
    
    @Autowired
    private UserService userService;
    
    @Autowired
    private RoleRepository roleRepository;
    
    @Override
    public void run(String... args) {
        // åˆ›å»ºè§’è‰²
        if (roleRepository.count() == 0) {
            roleRepository.save(new Role("ROLE_ADMIN", "ç®¡ç†å‘˜"));
            roleRepository.save(new Role("ROLE_USER", "æ™®é€šç”¨æˆ·"));
            roleRepository.save(new Role("ROLE_VIP", "VIPç”¨æˆ·"));
        }
        
        // åˆ›å»ºæµ‹è¯•ç”¨æˆ·
        if (!userService.existsByUsername("admin")) {
            userService.registerUser("admin", "admin123", "admin@example.com");
            userService.assignRole(1L, "ROLE_ADMIN");
        }
    }
}
```

**ğŸ”¹ éªŒè¯æµç¨‹**
```
1. å¯åŠ¨åº”ç”¨
   â†“
2. æ•°æ®åº“è‡ªåŠ¨åˆ›å»ºè¡¨ï¼ˆJPAï¼‰
   â†“
3. åˆå§‹åŒ–è„šæœ¬æ‰§è¡Œï¼ˆåˆ›å»ºè§’è‰²å’Œç”¨æˆ·ï¼‰
   â†“
4. è®¿é—®ç™»å½•é¡µé¢
   è¾“å…¥ï¼šadmin / admin123
   â†“
5. UserDetailsServiceæŸ¥è¯¢æ•°æ®åº“
   â†“
6. éªŒè¯å¯†ç ï¼ˆBCryptï¼‰
   â†“
7. ç™»å½•æˆåŠŸ âœ…
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ UserDetailsServiceï¼šç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢æ¥å£ï¼ŒSecurityæ ¸å¿ƒç»„ä»¶
ğŸ”¸ UserDetailsï¼šç”¨æˆ·è¯¦æƒ…å¯¹è±¡ï¼ŒåŒ…å«è´¦å·ã€å¯†ç ã€æƒé™
ğŸ”¸ PasswordEncoderï¼šå¯†ç åŠ å¯†å™¨ï¼Œä¿éšœå¯†ç å®‰å…¨
ğŸ”¸ GrantedAuthorityï¼šæƒé™å¯¹è±¡ï¼Œè¡¨ç¤ºç”¨æˆ·çš„æƒé™
ğŸ”¸ æ•°æ®åº“é›†æˆï¼šé€šè¿‡JPAå®ç°ç”¨æˆ·ä¿¡æ¯çš„æŒä¹…åŒ–
```

### 6.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ UserDetailsServiceçš„èŒè´£**
```
âœ… åªè´Ÿè´£æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
âŒ ä¸è´Ÿè´£å¯†ç éªŒè¯ï¼ˆç”±PasswordEncoderå®Œæˆï¼‰
âŒ ä¸è´Ÿè´£æƒé™æ£€æŸ¥ï¼ˆç”±Securityæ¡†æ¶å®Œæˆï¼‰

æ ¸å¿ƒæ–¹æ³•ï¼š
loadUserByUsername(String username) â†’ UserDetails
```

**ğŸ”¹ å¯†ç å®‰å…¨æœ€ä½³å®è·µ**
```
æ³¨å†Œæ—¶ï¼š
ç”¨æˆ·è¾“å…¥æ˜æ–‡å¯†ç  â†’ BCryptåŠ å¯† â†’ å­˜å…¥æ•°æ®åº“

ç™»å½•æ—¶ï¼š
ç”¨æˆ·è¾“å…¥æ˜æ–‡å¯†ç  â†’ BCryptéªŒè¯æ•°æ®åº“å¯†æ–‡ â†’ è¿”å›true/false

æ°¸è¿œä¸è¦ï¼š
âŒ å­˜å‚¨æ˜æ–‡å¯†ç 
âŒ ä½¿ç”¨MD5ç­‰å¼±åŠ å¯†
âŒ è‡ªå·±å®ç°åŠ å¯†ç®—æ³•
```

**ğŸ”¹ æƒé™ç®¡ç†ç­–ç•¥**
```
è§’è‰²ï¼ˆRoleï¼‰ï¼šç”¨æˆ·çš„èº«ä»½
â”œâ”€ ROLE_ADMIN
â”œâ”€ ROLE_USER
â””â”€ ROLE_VIP

æƒé™ï¼ˆAuthorityï¼‰ï¼šå…·ä½“æ“ä½œæƒé™
â”œâ”€ USER_READ
â”œâ”€ USER_WRITE
â””â”€ ORDER_CREATE

æ¨èåšæ³•ï¼š
è§’è‰² â†’ åŒ…å«å¤šä¸ªæƒé™ â†’ é€šè¿‡è§’è‰²åˆ†é…æƒé™
```

### 6.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¸šåŠ¡åœºæ™¯åº”ç”¨**
- **ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ**ï¼šå®Œæ•´çš„æ³¨å†Œã€ç™»å½•ã€æƒé™æ§åˆ¶
- **ç”µå•†å¹³å°**ï¼šä¹°å®¶ã€å–å®¶ã€ç®¡ç†å‘˜ä¸åŒæƒé™
- **ä¼ä¸šOAç³»ç»Ÿ**ï¼šåŸºäºè§’è‰²çš„å¤æ‚æƒé™ç®¡ç†
- **SaaSåº”ç”¨**ï¼šå¤šç§Ÿæˆ·æƒé™éš”ç¦»

**ğŸ”§ å¼€å‘å®è·µè¦ç‚¹**
- **å®‰å…¨ä¼˜å…ˆ**ï¼šå¯†ç åŠ å¯†ã€é˜²SQLæ³¨å…¥ã€å¼‚å¸¸å¤„ç†
- **çµæ´»æ‰©å±•**ï¼šè‡ªå®šä¹‰UserDetailsæ”¯æŒæ›´å¤šå­—æ®µ
- **æ€§èƒ½ä¼˜åŒ–**ï¼šåˆç†ä½¿ç”¨ç¼“å­˜ã€æ‡’åŠ è½½ç­–ç•¥
- **æµ‹è¯•å®Œå–„**ï¼šå•å…ƒæµ‹è¯•è¦†ç›–æ‰€æœ‰æƒé™åœºæ™¯

**ğŸš€ è¿›é˜¶æ–¹å‘**
- **OAuth2é›†æˆ**ï¼šæ”¯æŒç¬¬ä¸‰æ–¹ç™»å½•ï¼ˆå¾®ä¿¡ã€QQï¼‰
- **JWTä»¤ç‰Œ**ï¼šæ— çŠ¶æ€è®¤è¯ï¼Œé€‚åˆå¾®æœåŠ¡
- **åŠ¨æ€æƒé™**ï¼šåŸºäºæ•°æ®åº“çš„æƒé™é…ç½®
- **å¤šå› ç´ è®¤è¯**ï¼šçŸ­ä¿¡éªŒè¯ç ã€Google Authenticator

### 6.4 å¸¸è§é—®é¢˜ä¸è§£å†³


**â“ ç”¨æˆ·ç™»å½•å¤±è´¥**
```
é—®é¢˜æ£€æŸ¥æ¸…å•ï¼š
â–¡ ç”¨æˆ·åæ˜¯å¦æ­£ç¡®ï¼Ÿ
â–¡ å¯†ç åŠ å¯†æ–¹å¼æ˜¯å¦ä¸€è‡´ï¼Ÿ
â–¡ UserDetailsServiceæ˜¯å¦æ­£ç¡®æ³¨å…¥ï¼Ÿ
â–¡ æ•°æ®åº“è¿æ¥æ˜¯å¦æ­£å¸¸ï¼Ÿ
â–¡ ç”¨æˆ·è´¦å·æ˜¯å¦è¢«ç¦ç”¨/é”å®šï¼Ÿ
```

**â“ æƒé™æ£€æŸ¥ä¸ç”Ÿæ•ˆ**
```
è§£å†³æ­¥éª¤ï¼š
1. æ£€æŸ¥@EnableGlobalMethodSecurityæ˜¯å¦å¼€å¯
2. ç¡®è®¤è§’è‰²åæ˜¯å¦æœ‰ROLE_å‰ç¼€
3. éªŒè¯UserDetailsæ˜¯å¦æ­£ç¡®åŠ è½½äº†æƒé™
4. æŸ¥çœ‹Securityé…ç½®æ˜¯å¦æ­£ç¡®
```

**â“ å¯†ç éªŒè¯å¤±è´¥**
```
å¸¸è§åŸå› ï¼š
âœ— æ³¨å†Œæ—¶æ²¡åŠ å¯†ï¼Œç™»å½•æ—¶å´è¦éªŒè¯åŠ å¯†å¯†ç 
âœ— ä½¿ç”¨äº†ä¸åŒçš„PasswordEncoder
âœ— æ•°æ®åº“å¯†ç å­—æ®µé•¿åº¦ä¸å¤Ÿï¼ˆBCryptéœ€è¦60+å­—ç¬¦ï¼‰

è§£å†³æ–¹æ¡ˆï¼š
âœ“ ç»Ÿä¸€ä½¿ç”¨BCryptPasswordEncoder
âœ“ ç¡®ä¿å¯†ç å­—æ®µVARCHAR(255)
âœ“ æ³¨å†Œå’Œç™»å½•ä½¿ç”¨åŒä¸€ä¸ªPasswordEncoder Bean
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
æŸ¥ç”¨æˆ·æ‰¾UserDetailsService
åŠ å¯†ç ç”¨PasswordEncoder
å­˜è§’è‰²å»ºå…³è”è¡¨
éªŒæƒé™çœ‹GrantedAuthority
æ•°æ®åº“é›†æˆé JPA
å®‰å…¨ç¬¬ä¸€æœ€é‡è¦
```