---
title: 6ã€èµ„æºæœåŠ¡å™¨é…ç½®
---
## ğŸ“š ç›®å½•

1. [èµ„æºæœåŠ¡å™¨æ˜¯ä»€ä¹ˆ](#1-èµ„æºæœåŠ¡å™¨æ˜¯ä»€ä¹ˆ)
2. [EnableResourceServeræ³¨è§£è¯¦è§£](#2-EnableResourceServeræ³¨è§£è¯¦è§£)
3. [ResourceServerConfigé…ç½®](#3-ResourceServerConfigé…ç½®)
4. [Bearer Tokenå·¥ä½œæœºåˆ¶](#4-Bearer-Tokenå·¥ä½œæœºåˆ¶)
5. [JwtDecoderä»¤ç‰Œè§£ç ](#5-JwtDecoderä»¤ç‰Œè§£ç )
6. [TokenéªŒè¯æœºåˆ¶](#6-TokenéªŒè¯æœºåˆ¶)
7. [è®¿é—®æ§åˆ¶å®ç°](#7-è®¿é—®æ§åˆ¶å®ç°)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¢ èµ„æºæœåŠ¡å™¨æ˜¯ä»€ä¹ˆ


### 1.1 é€šä¿—ç†è§£èµ„æºæœåŠ¡å™¨


**ç”Ÿæ´»ä¸­çš„ä¾‹å­**ï¼š
```
å°±åƒä½ å»é“¶è¡Œå–é’±ï¼š
- ä½ å¸¦ç€é“¶è¡Œå¡ï¼ˆTokenï¼‰
- é“¶è¡ŒæŸœå°ï¼ˆèµ„æºæœåŠ¡å™¨ï¼‰è¦éªŒè¯ä½ çš„å¡
- éªŒè¯é€šè¿‡åï¼Œé“¶è¡Œæ‰ç»™ä½ é’±ï¼ˆèµ„æºï¼‰

èµ„æºæœåŠ¡å™¨å°±æ˜¯"ä¿ç®¡èµ„æº"çš„æœåŠ¡å™¨ï¼Œ
å®ƒä¼šæ£€æŸ¥ä½ å¸¦æ¥çš„"é€šè¡Œè¯"ï¼ˆTokenï¼‰æ˜¯å¦åˆæ³•
```

> **ğŸ’¡ æ ¸å¿ƒç†è§£**  
> èµ„æºæœåŠ¡å™¨ = å­˜æ”¾ç”¨æˆ·æ•°æ®çš„æœåŠ¡å™¨ + TokenéªŒè¯åŠŸèƒ½  
> å®ƒçš„èŒè´£ï¼šéªŒè¯Token â†’ æ£€æŸ¥æƒé™ â†’ è¿”å›æ•°æ®

### 1.2 OAuth2æ¶æ„ä¸­çš„ä½ç½®


```
å®Œæ•´çš„OAuth2æµç¨‹ï¼š

ç”¨æˆ·              æˆæƒæœåŠ¡å™¨         èµ„æºæœåŠ¡å™¨
 |                   |                  |
 |--[1]è¯·æ±‚æˆæƒ----->|                  |
 |<--[2]è¿”å›Token----|                  |
 |                   |                  |
 |--[3]å¸¦Tokenè®¿é—®------------------>|
 |                   |                  |
 |                   |<--[4]éªŒè¯Token---|
 |                   |                  |
 |<--[5]è¿”å›èµ„æºæ•°æ®------------------|

èµ„æºæœåŠ¡å™¨è´Ÿè´£ç¬¬3ã€4ã€5æ­¥
```

**ä¸‰å¤§è§’è‰²å…³ç³»**ï¼š
- **æˆæƒæœåŠ¡å™¨**ï¼šè´Ÿè´£é¢å‘Tokenï¼ˆå‘é€šè¡Œè¯ï¼‰
- **èµ„æºæœåŠ¡å™¨**ï¼šè´Ÿè´£éªŒè¯Tokenå¹¶æä¾›æ•°æ®ï¼ˆå®ˆé—¨å‘˜ï¼‰
- **å®¢æˆ·ç«¯**ï¼šæ‹¿ç€Tokenè®¿é—®èµ„æºï¼ˆæŒè¯è®¿é—®è€…ï¼‰

### 1.3 èµ„æºæœåŠ¡å™¨çš„æ ¸å¿ƒèŒè´£


| èŒè´£ | è¯´æ˜ | ä¸¾ä¾‹ |
|------|------|------|
| **TokenéªŒè¯** | æ£€æŸ¥Tokenæ˜¯å¦åˆæ³• | æ£€æŸ¥JWTç­¾åã€è¿‡æœŸæ—¶é—´ |
| **æƒé™æ£€æŸ¥** | éªŒè¯Tokenä¸­çš„æƒé™èŒƒå›´ | æ£€æŸ¥æ˜¯å¦æœ‰è¯»å†™æƒé™ |
| **èµ„æºä¿æŠ¤** | åªç»™æœ‰æƒé™çš„è¯·æ±‚è¿”å›æ•°æ® | æ™®é€šç”¨æˆ·çœ‹ä¸åˆ°ç®¡ç†å‘˜æ•°æ® |
| **æ‹’ç»æ— æ•ˆè¯·æ±‚** | æ‹¦æˆªæ²¡æœ‰Tokenæˆ–Tokenæ— æ•ˆçš„è¯·æ±‚ | è¿”å›401æœªæˆæƒé”™è¯¯ |

---

## 2. ğŸ”§ @EnableResourceServeræ³¨è§£è¯¦è§£


### 2.1 æ³¨è§£çš„ä½œç”¨


**ç®€å•ç†è§£**ï¼š
```
@EnableResourceServer = å¼€å¯èµ„æºæœåŠ¡å™¨åŠŸèƒ½

å°±åƒç»™ä½ çš„æœåŠ¡å™¨è£…ä¸Šä¸€ä¸ª"å®‰æ£€é—¨"ï¼š
- æ¯ä¸ªè¯·æ±‚è¿›æ¥éƒ½è¦æ£€æŸ¥Token
- Tokenåˆæ³•æ‰èƒ½ç»§ç»­è®¿é—®
- Tokenä¸åˆæ³•ç›´æ¥æ‹¦æˆª
```

### 2.2 åŸºæœ¬ä½¿ç”¨æ–¹å¼


```java
@Configuration
@EnableResourceServer  // å¼€å¯èµ„æºæœåŠ¡å™¨åŠŸèƒ½
public class ResourceServerConfig {
    // è¿™ä¸ªæ³¨è§£ä¼šè‡ªåŠ¨é…ç½®å¾ˆå¤šå®‰å…¨ç›¸å…³çš„åŠŸèƒ½
}
```

> **âš ï¸ æ³¨æ„äº‹é¡¹**  
> Spring Boot 2.x ä¹‹åä¸æ¨èä½¿ç”¨ @EnableResourceServer  
> å»ºè®®ä½¿ç”¨æ–°çš„ Spring Security é…ç½®æ–¹å¼ï¼ˆåé¢ä¼šè®²ï¼‰

### 2.3 æ³¨è§£èƒŒååšäº†ä»€ä¹ˆ


**è‡ªåŠ¨é…ç½®çš„åŠŸèƒ½**ï¼š

ğŸ”¸ **è‡ªåŠ¨é…ç½®TokenéªŒè¯**
- ä»è¯·æ±‚å¤´ä¸­æå–Bearer Token
- éªŒè¯Tokençš„ç­¾åå’Œæœ‰æ•ˆæœŸ
- è§£æTokenä¸­çš„ç”¨æˆ·ä¿¡æ¯

ğŸ”¸ **è‡ªåŠ¨é…ç½®å®‰å…¨è¿‡æ»¤å™¨**
- æ·»åŠ OAuth2è®¤è¯è¿‡æ»¤å™¨
- è®¾ç½®TokenéªŒè¯è§„åˆ™
- é…ç½®å¼‚å¸¸å¤„ç†

ğŸ”¸ **è‡ªåŠ¨é…ç½®ç«¯ç‚¹ä¿æŠ¤**
- æ‰€æœ‰æ¥å£é»˜è®¤éœ€è¦Token
- å¯ä»¥è‡ªå®šä¹‰å“ªäº›æ¥å£éœ€è¦ä¿æŠ¤

```
è¯·æ±‚æµç¨‹ï¼š

HTTPè¯·æ±‚ 
   â†“
OAuth2è¿‡æ»¤å™¨ï¼ˆè‡ªåŠ¨é…ç½®ï¼‰
   â†“
æå–Token â†’ éªŒè¯Token â†’ è§£æç”¨æˆ·ä¿¡æ¯
   â†“
é€šè¿‡éªŒè¯ â†’ ç»§ç»­è®¿é—®
   â†“
éªŒè¯å¤±è´¥ â†’ è¿”å›401é”™è¯¯
```

---

## 3. âš™ï¸ ResourceServerConfigé…ç½®


### 3.1 ä¸ºä»€ä¹ˆéœ€è¦é…ç½®ç±»


**é€šä¿—è§£é‡Š**ï¼š
```
@EnableResourceServeråªæ˜¯"å¼€å¯"äº†åŠŸèƒ½
ResourceServerConfigæ˜¯"å®šåˆ¶åŒ–é…ç½®"

å°±åƒä¹°äº†ä¸€å°ç©ºè°ƒï¼š
- @EnableResourceServerï¼šå¼€æœº
- ResourceServerConfigï¼šè®¾ç½®æ¸©åº¦ã€é£é€Ÿã€æ¨¡å¼ç­‰
```

### 3.2 ä¼ ç»Ÿé…ç½®æ–¹å¼ï¼ˆSpring Boot 2.xä¹‹å‰ï¼‰


```java
@Configuration
@EnableResourceServer
public class ResourceServerConfig extends ResourceServerConfigurerAdapter {
    
    @Override
    public void configure(HttpSecurity http) throws Exception {
        http
            .authorizeRequests()
                .antMatchers("/public/**").permitAll()  // å…¬å¼€æ¥å£
                .antMatchers("/admin/**").hasRole("ADMIN")  // ç®¡ç†å‘˜æ¥å£
                .anyRequest().authenticated();  // å…¶ä»–æ¥å£éœ€è¦è®¤è¯
    }
    
    @Override
    public void configure(ResourceServerSecurityConfigurer resources) {
        resources.resourceId("api");  // èµ„æºID
    }
}
```

**é…ç½®è§£é‡Š**ï¼š
- `permitAll()`ï¼šä¸éœ€è¦Tokenå°±èƒ½è®¿é—®
- `hasRole()`ï¼šéœ€è¦ç‰¹å®šè§’è‰²æ‰èƒ½è®¿é—®
- `authenticated()`ï¼šéœ€è¦æœ‰æ•ˆTokenæ‰èƒ½è®¿é—®

### 3.3 ç°ä»£é…ç½®æ–¹å¼ï¼ˆSpring Boot 2.7+æ¨èï¼‰


```java
@Configuration
public class ResourceServerConfig {
    
    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/public/**").permitAll()
                .requestMatchers("/admin/**").hasAuthority("SCOPE_admin")
                .anyRequest().authenticated()
            )
            .oauth2ResourceServer(oauth2 -> oauth2
                .jwt(jwt -> jwt.decoder(jwtDecoder()))  // é…ç½®JWTè§£ç å™¨
            );
        
        return http.build();
    }
    
    @Bean
    public JwtDecoder jwtDecoder() {
        // JWTè§£ç å™¨é…ç½®
        return JwtDecoders.fromIssuerLocation("http://auth-server:8080");
    }
}
```

> **ğŸ’¡ ç°ä»£é…ç½®çš„ä¼˜åŠ¿**  
> - æ›´æ¸…æ™°çš„APIè®¾è®¡
> - æ›´å¥½çš„ç±»å‹å®‰å…¨
> - æ›´çµæ´»çš„é…ç½®æ–¹å¼

### 3.4 é…ç½®å¯¹æ¯”è¡¨æ ¼


| é…ç½®é¡¹ | ä¼ ç»Ÿæ–¹å¼ | ç°ä»£æ–¹å¼ | æ¨èä½¿ç”¨ |
|--------|----------|----------|----------|
| **é…ç½®ç±»** | `ResourceServerConfigurerAdapter` | `SecurityFilterChain` | ç°ä»£æ–¹å¼ âœ… |
| **URLåŒ¹é…** | `antMatchers()` | `requestMatchers()` | ç°ä»£æ–¹å¼ âœ… |
| **JWTé…ç½®** | éœ€è¦æ‰‹åŠ¨é…ç½® | `oauth2ResourceServer().jwt()` | ç°ä»£æ–¹å¼ âœ… |
| **å¯è¯»æ€§** | è¾ƒå¤æ‚ | æ›´æ¸…æ™° | ç°ä»£æ–¹å¼ âœ… |

---

## 4. ğŸ« Bearer Tokenå·¥ä½œæœºåˆ¶


### 4.1 ä»€ä¹ˆæ˜¯Bearer Token


**é€šä¿—ç†è§£**ï¼š
```
Bearer = æŒæœ‰äººã€æºå¸¦è€…

Bearer Token = è°æ‹¿ç€è¿™ä¸ªTokenï¼Œè°å°±èƒ½ç”¨

å°±åƒç”µå½±ç¥¨ï¼š
- ä¸è®°åç¥¨ï¼ˆBearer Tokenï¼‰ï¼šè°æ‹¿ç€è°èƒ½è¿›
- å®åç¥¨ï¼šå¿…é¡»æœ¬äººæ‰èƒ½ç”¨

Bearer Tokenå°±æ˜¯"ä¸è®°åçš„é€šè¡Œè¯"
```

### 4.2 Bearer Tokençš„ä¼ é€’æ–¹å¼


**æ ‡å‡†HTTPè¯·æ±‚æ ¼å¼**ï¼š
```http
GET /api/user/profile HTTP/1.1
Host: api.example.com
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

â†‘ å…³é”®ï¼šBearer + ç©ºæ ¼ + Token
```

**ä¸‰ç§ä¼ é€’æ–¹å¼å¯¹æ¯”**ï¼š

| æ–¹å¼ | ç¤ºä¾‹ | å®‰å…¨æ€§ | æ¨èåº¦ |
|------|------|--------|--------|
| **è¯·æ±‚å¤´** | `Authorization: Bearer xxx` | â­â­â­â­â­ | æ¨è âœ… |
| **URLå‚æ•°** | `/api?access_token=xxx` | â­â­â˜†â˜†â˜† | ä¸æ¨è |
| **è¯·æ±‚ä½“** | `{access_token: 'xxx'}` | â­â­â­â˜†â˜† | ç‰¹æ®Šåœºæ™¯ |

> **âš ï¸ å®‰å…¨å»ºè®®**  
> å§‹ç»ˆä½¿ç”¨è¯·æ±‚å¤´æ–¹å¼ä¼ é€’Token  
> URLå‚æ•°ä¼šè¢«è®°å½•åœ¨æ—¥å¿—ä¸­ï¼Œå®¹æ˜“æ³„éœ²

### 4.3 Bearer Tokençš„éªŒè¯æµç¨‹


```
å®¢æˆ·ç«¯å‘é€è¯·æ±‚ï¼š
Authorization: Bearer eyJhbGciOi...
        â†“
èµ„æºæœåŠ¡å™¨æå–Tokenï¼š
1. æ£€æŸ¥è¯·æ±‚å¤´æ˜¯å¦å­˜åœ¨
2. æå–"Bearer "åé¢çš„éƒ¨åˆ†
3. å»æ‰å‰åç©ºæ ¼
        â†“
éªŒè¯Tokenï¼š
1. æ£€æŸ¥æ ¼å¼æ˜¯å¦æ­£ç¡®
2. éªŒè¯ç­¾åæ˜¯å¦æœ‰æ•ˆ
3. æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
4. è§£æç”¨æˆ·ä¿¡æ¯
        â†“
éªŒè¯ç»“æœï¼š
âœ… é€šè¿‡ â†’ ç»§ç»­å¤„ç†è¯·æ±‚
âŒ å¤±è´¥ â†’ è¿”å›401é”™è¯¯
```

### 4.4 Spring Securityè‡ªåŠ¨å¤„ç†


```java
// Spring Securityä¼šè‡ªåŠ¨å¤„ç†Bearer Token
// ä½ ä¸éœ€è¦æ‰‹åŠ¨å†™ä»£ç æå–Token

// é…ç½®åï¼Œæ¡†æ¶ä¼šè‡ªåŠ¨ï¼š
// 1. ä»è¯·æ±‚å¤´æå–Token
// 2. éªŒè¯Tokenæœ‰æ•ˆæ€§
// 3. å°†ç”¨æˆ·ä¿¡æ¯å­˜å…¥SecurityContext

// ä½ åªéœ€è¦åœ¨Controllerä¸­è·å–ç”¨æˆ·ä¿¡æ¯ï¼š
@GetMapping("/user/info")
public UserInfo getUserInfo(@AuthenticationPrincipal Jwt jwt) {
    String username = jwt.getSubject();
    List<String> scopes = jwt.getClaimAsStringList("scope");
    // ä½¿ç”¨ç”¨æˆ·ä¿¡æ¯
}
```

---

## 5. ğŸ” JwtDecoderä»¤ç‰Œè§£ç 


### 5.1 JWTè§£ç å™¨çš„ä½œç”¨


**å½¢è±¡ç†è§£**ï¼š
```
JWT = åŠ å¯†çš„ä¿¡å°
JwtDecoder = æ‹†ä¿¡å·¥å…·

æ”¶åˆ°JWTï¼ˆåŠ å¯†ä¿¡å°ï¼‰
      â†“
ç”¨JwtDecoderæ‰“å¼€ï¼ˆè§£å¯†éªŒè¯ï¼‰
      â†“
è¯»å–é‡Œé¢çš„å†…å®¹ï¼ˆç”¨æˆ·ä¿¡æ¯ï¼‰
```

> **ğŸ’¡ æ ¸å¿ƒä½œç”¨**  
> JwtDecoder = éªŒè¯JWTç­¾å + è§£æJWTå†…å®¹  
> ç¡®ä¿Tokenæ²¡è¢«ç¯¡æ”¹ï¼Œå¹¶æå–å‡ºç”¨æˆ·ä¿¡æ¯

### 5.2 JWTçš„ç»“æ„


```
ä¸€ä¸ªå®Œæ•´çš„JWTç”±3éƒ¨åˆ†ç»„æˆï¼š

eyJhbGciOi.eyJzdWIi.SflKxwRJ
    â†“         â†“        â†“
  Header   Payload  Signature
  å¤´éƒ¨      è½½è·      ç­¾å
```

**ä¸‰éƒ¨åˆ†è¯¦è§£**ï¼š

ğŸ”¸ **Headerï¼ˆå¤´éƒ¨ï¼‰**
```json
{
  "alg": "HS256",      // åŠ å¯†ç®—æ³•
  "typ": "JWT"         // Tokenç±»å‹
}
```

ğŸ”¸ **Payloadï¼ˆè½½è·ï¼‰**
```json
{
  "sub": "user123",           // ç”¨æˆ·ID
  "name": "å¼ ä¸‰",             // ç”¨æˆ·å
  "scope": ["read", "write"], // æƒé™èŒƒå›´
  "exp": 1735033200          // è¿‡æœŸæ—¶é—´
}
```

ğŸ”¸ **Signatureï¼ˆç­¾åï¼‰**
```
ç­¾å = åŠ å¯†ç®—æ³•(
  base64(header) + "." + base64(payload),
  secret_key
)
```

### 5.3 JwtDecoderçš„é…ç½®æ–¹å¼


**æ–¹å¼ä¸€ï¼šä½¿ç”¨å…¬é’¥éªŒè¯ï¼ˆæ¨èï¼‰**

```java
@Bean
public JwtDecoder jwtDecoder() {
    // ä½¿ç”¨æˆæƒæœåŠ¡å™¨çš„å…¬é’¥éªŒè¯JWT
    String publicKeyLocation = "classpath:public.key";
    return NimbusJwtDecoder.withPublicKey(publicKey()).build();
}

@Bean
public RSAPublicKey publicKey() throws Exception {
    // è¯»å–å…¬é’¥æ–‡ä»¶
    Resource resource = new ClassPathResource("public.key");
    String publicKeyPEM = new String(Files.readAllBytes(resource.getFile().toPath()));
    
    // è§£æå…¬é’¥
    PublicKey key = KeyFactory.getInstance("RSA")
        .generatePublic(new X509EncodedKeySpec(/* ... */));
    return (RSAPublicKey) key;
}
```

**æ–¹å¼äºŒï¼šä»æˆæƒæœåŠ¡å™¨è·å–ï¼ˆæ›´çµæ´»ï¼‰**

```java
@Bean
public JwtDecoder jwtDecoder() {
    // ä»æˆæƒæœåŠ¡å™¨çš„/.well-known/jwks.jsonè·å–å…¬é’¥
    String issuerUri = "http://localhost:8080/auth";
    return JwtDecoders.fromIssuerLocation(issuerUri);
}
```

**ä¸¤ç§æ–¹å¼å¯¹æ¯”**ï¼š

| æ–¹å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| **æœ¬åœ°å…¬é’¥** | éªŒè¯é€Ÿåº¦å¿«ã€ä¸ä¾èµ–ç½‘ç»œ | å…¬é’¥æ›´æ–°éœ€è¦é‡æ–°éƒ¨ç½² | ç”Ÿäº§ç¯å¢ƒç¨³å®šæ–¹æ¡ˆ |
| **è¿œç¨‹è·å–** | å…¬é’¥è‡ªåŠ¨æ›´æ–°ã€é…ç½®ç®€å• | ä¾èµ–ç½‘ç»œã€é¦–æ¬¡éªŒè¯æ…¢ | å¼€å‘æµ‹è¯•ç¯å¢ƒ |

### 5.4 è§£ç å’ŒéªŒè¯è¿‡ç¨‹


```
JWTè¿›å…¥ â†’ JwtDecoderå¤„ç†æµç¨‹ï¼š

Step 1: åˆ†å‰²Token
eyJhbGci.eyJzdWI.SflKxw
   â†“        â†“       â†“
Header  Payload  Signature

Step 2: éªŒè¯ç­¾å
ç”¨å…¬é’¥éªŒè¯Signatureæ˜¯å¦æ­£ç¡®
   â†“
ç­¾åæ­£ç¡® â†’ ç»§ç»­
ç­¾åé”™è¯¯ â†’ æŠ›å‡ºå¼‚å¸¸

Step 3: éªŒè¯æ—¶é—´
æ£€æŸ¥expï¼ˆè¿‡æœŸæ—¶é—´ï¼‰
   â†“
æœªè¿‡æœŸ â†’ ç»§ç»­
å·²è¿‡æœŸ â†’ æŠ›å‡ºå¼‚å¸¸

Step 4: è§£æè½½è·
å°†Payloadè½¬æ¢ä¸ºJavaå¯¹è±¡
   â†“
è¿”å›Jwtå¯¹è±¡ä¾›ç¨‹åºä½¿ç”¨
```

---

## 6. âœ… TokenéªŒè¯æœºåˆ¶


### 6.1 å®Œæ•´çš„éªŒè¯æµç¨‹


```
HTTPè¯·æ±‚åˆ°è¾¾
      â†“
[1] æå–Token
ä»Authorizationå¤´æå–Bearer Token
      â†“
[2] æ ¼å¼éªŒè¯
æ£€æŸ¥Tokenæ ¼å¼æ˜¯å¦ç¬¦åˆJWTæ ‡å‡†
      â†“
[3] ç­¾åéªŒè¯
ç”¨å…¬é’¥éªŒè¯Tokenç­¾åæ˜¯å¦æœ‰æ•ˆ
      â†“
[4] æ—¶é—´éªŒè¯
æ£€æŸ¥Tokenæ˜¯å¦è¿‡æœŸ(exp)å’Œç”Ÿæ•ˆæ—¶é—´(nbf)
      â†“
[5] å‘è¡Œè€…éªŒè¯
æ£€æŸ¥iss(issuer)æ˜¯å¦æ˜¯å¯ä¿¡çš„æˆæƒæœåŠ¡å™¨
      â†“
[6] å—ä¼—éªŒè¯
æ£€æŸ¥aud(audience)æ˜¯å¦åŒ…å«æœ¬æœåŠ¡
      â†“
[7] æƒé™æå–
ä»scope/authoritiesä¸­æå–æƒé™ä¿¡æ¯
      â†“
éªŒè¯é€šè¿‡ â†’ å…è®¸è®¿é—®
éªŒè¯å¤±è´¥ â†’ è¿”å›401/403é”™è¯¯
```

### 6.2 å„é¡¹éªŒè¯è¯¦è§£


**ğŸ”¸ ç­¾åéªŒè¯**
```
ä½œç”¨ï¼šç¡®ä¿Tokenæ²¡æœ‰è¢«ç¯¡æ”¹

åŸç†ï¼š
1. ç”¨å…¬é’¥è§£å¯†ç­¾å
2. å¯¹æ¯”è§£å¯†ç»“æœå’ŒåŸå§‹æ•°æ®
3. ä¸€è‡´åˆ™è¯æ˜æœªè¢«ç¯¡æ”¹

é‡è¦æ€§ï¼šâ­â­â­â­â­ï¼ˆæœ€æ ¸å¿ƒï¼‰
```

**ğŸ”¸ æ—¶é—´éªŒè¯**
```json
// Tokenä¸­çš„æ—¶é—´å­—æ®µ
{
  "exp": 1735033200,  // è¿‡æœŸæ—¶é—´ï¼ˆå¿…é¡»ï¼‰
  "nbf": 1735029600,  // ç”Ÿæ•ˆæ—¶é—´ï¼ˆå¯é€‰ï¼‰
  "iat": 1735026000   // ç­¾å‘æ—¶é—´ï¼ˆå¯é€‰ï¼‰
}
```

**éªŒè¯é€»è¾‘**ï¼š
- å½“å‰æ—¶é—´ < `nbf` â†’ Tokenè¿˜æœªç”Ÿæ•ˆ
- å½“å‰æ—¶é—´ > `exp` â†’ Tokenå·²è¿‡æœŸ
- åªæœ‰åœ¨ `nbf` å’Œ `exp` ä¹‹é—´æ‰æœ‰æ•ˆ

**ğŸ”¸ å‘è¡Œè€…éªŒè¯**
```java
@Bean
public JwtDecoder jwtDecoder() {
    NimbusJwtDecoder decoder = /* ... */;
    
    // è®¾ç½®å¿…é¡»éªŒè¯çš„issuer
    decoder.setJwtValidator(
        JwtValidators.createDefaultWithIssuer("http://auth-server:8080")
    );
    
    return decoder;
}
```

### 6.3 éªŒè¯å¤±è´¥çš„å¤„ç†


**å¸¸è§é”™è¯¯ç±»å‹**ï¼š

| é”™è¯¯ç±»å‹ | HTTPçŠ¶æ€ç  | åŸå›  | è§£å†³æ–¹æ³• |
|----------|-----------|------|----------|
| **ç­¾åæ— æ•ˆ** | 401 | Tokenè¢«ç¯¡æ”¹æˆ–å…¬é’¥ä¸åŒ¹é… | æ£€æŸ¥å…¬é’¥é…ç½® |
| **Tokenè¿‡æœŸ** | 401 | è¶…è¿‡æœ‰æ•ˆæœŸ | é‡æ–°è·å–Token |
| **æ ¼å¼é”™è¯¯** | 401 | JWTæ ¼å¼ä¸æ­£ç¡® | æ£€æŸ¥Tokenå®Œæ•´æ€§ |
| **æƒé™ä¸è¶³** | 403 | æ²¡æœ‰è®¿é—®è¯¥èµ„æºçš„æƒé™ | ç”³è¯·æ›´é«˜æƒé™ |

**è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†**ï¼š

```java
@Bean
public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
    http
        .oauth2ResourceServer(oauth2 -> oauth2
            .jwt(jwt -> jwt.decoder(jwtDecoder()))
            .authenticationEntryPoint(authenticationEntryPoint())  // è®¤è¯å¤±è´¥å¤„ç†
            .accessDeniedHandler(accessDeniedHandler())  // æƒé™ä¸è¶³å¤„ç†
        );
    
    return http.build();
}

// è®¤è¯å¤±è´¥å¤„ç†å™¨
@Bean
public AuthenticationEntryPoint authenticationEntryPoint() {
    return (request, response, authException) -> {
        response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
        response.setContentType("application/json;charset=UTF-8");
        
        Map<String, String> error = new HashMap<>();
        error.put("error", "unauthorized");
        error.put("message", "Tokenæ— æ•ˆæˆ–å·²è¿‡æœŸ");
        
        response.getWriter().write(new ObjectMapper().writeValueAsString(error));
    };
}
```

---

## 7. ğŸ›¡ï¸ è®¿é—®æ§åˆ¶å®ç°


### 7.1 åŸºäºURLçš„è®¿é—®æ§åˆ¶


**ç®€å•ç†è§£**ï¼š
```
å°±åƒå°åŒºé—¨ç¦ç³»ç»Ÿï¼š
- å…¬å…±åŒºåŸŸï¼šè°éƒ½èƒ½è¿›ï¼ˆpermitAllï¼‰
- ä½æˆ·åŒºåŸŸï¼šéœ€è¦é—¨ç¦å¡ï¼ˆauthenticatedï¼‰
- ç®¡ç†åŒºåŸŸï¼šéœ€è¦ç®¡ç†å‘˜æƒé™ï¼ˆhasAuthorityï¼‰
```

**é…ç½®ç¤ºä¾‹**ï¼š

```java
@Bean
public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
    http
        .authorizeHttpRequests(auth -> auth
            // å…¬å¼€æ¥å£ï¼šä¸éœ€è¦è®¤è¯
            .requestMatchers("/public/**", "/health").permitAll()
            
            // éœ€è¦è®¤è¯ä½†ä¸é™åˆ¶æƒé™
            .requestMatchers("/user/**").authenticated()
            
            // éœ€è¦ç‰¹å®šæƒé™
            .requestMatchers("/admin/**").hasAuthority("SCOPE_admin")
            .requestMatchers("/api/write/**").hasAuthority("SCOPE_write")
            
            // éœ€è¦ä»»æ„ä¸€ä¸ªæƒé™
            .requestMatchers("/api/data/**").hasAnyAuthority("SCOPE_read", "SCOPE_write")
            
            // å…¶ä»–æ‰€æœ‰è¯·æ±‚éƒ½éœ€è¦è®¤è¯
            .anyRequest().authenticated()
        )
        .oauth2ResourceServer(oauth2 -> oauth2.jwt());
    
    return http.build();
}
```

**åŒ¹é…è§„åˆ™è¯´æ˜**ï¼š

| åŒ¹é…å™¨ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|
| `/public/**` | åŒ¹é…æ‰€æœ‰ä»¥/publicå¼€å¤´çš„è·¯å¾„ | `/public/login`, `/public/register` |
| `/admin/*` | åªåŒ¹é…ä¸€çº§è·¯å¾„ | `/admin/users` âœ… `/admin/users/1` âŒ |
| `/api/**/*.json` | åŒ¹é…ç‰¹å®šåç¼€ | `/api/users/list.json` |

### 7.2 åŸºäºæƒé™çš„è®¿é—®æ§åˆ¶


**æƒé™çš„æ¥æº**ï¼š
```
JWTä¸­çš„æƒé™ä¿¡æ¯ï¼š

{
  "sub": "user123",
  "scope": ["read", "write", "admin"],  â† æƒé™èŒƒå›´
  "authorities": ["ROLE_USER", "ROLE_ADMIN"]  â† è§’è‰²æƒé™
}
```

**æƒé™éªŒè¯æ–¹å¼**ï¼š

ğŸ”¸ **ä½¿ç”¨hasAuthorityï¼ˆå•ä¸ªæƒé™ï¼‰**
```java
.requestMatchers("/api/delete/**")
    .hasAuthority("SCOPE_admin")  // å¿…é¡»æœ‰adminæƒé™
```

ğŸ”¸ **ä½¿ç”¨hasAnyAuthorityï¼ˆå¤šä¸ªæƒé™ä»»ä¸€ï¼‰**
```java
.requestMatchers("/api/view/**")
    .hasAnyAuthority("SCOPE_read", "SCOPE_write")  // readæˆ–writeéƒ½è¡Œ
```

ğŸ”¸ **ä½¿ç”¨accessï¼ˆè‡ªå®šä¹‰è¡¨è¾¾å¼ï¼‰**
```java
.requestMatchers("/api/sensitive/**")
    .access((authentication, context) -> {
        // è‡ªå®šä¹‰å¤æ‚çš„æƒé™åˆ¤æ–­é€»è¾‘
        Jwt jwt = (Jwt) authentication.getPrincipal();
        boolean hasScope = jwt.getClaimAsStringList("scope").contains("admin");
        boolean isNotExpired = jwt.getExpiresAt().isAfter(Instant.now());
        return new AuthorizationDecision(hasScope && isNotExpired);
    })
```

### 7.3 æ–¹æ³•çº§åˆ«çš„è®¿é—®æ§åˆ¶


**åœ¨Controlleræ–¹æ³•ä¸Šç›´æ¥æ§åˆ¶**ï¼š

```java
@RestController
@RequestMapping("/api")
public class UserController {
    
    // éœ€è¦readæƒé™
    @GetMapping("/users")
    @PreAuthorize("hasAuthority('SCOPE_read')")
    public List<User> getUsers() {
        return userService.findAll();
    }
    
    // éœ€è¦writeæƒé™
    @PostMapping("/users")
    @PreAuthorize("hasAuthority('SCOPE_write')")
    public User createUser(@RequestBody User user) {
        return userService.save(user);
    }
    
    // éœ€è¦adminæƒé™
    @DeleteMapping("/users/{id}")
    @PreAuthorize("hasAuthority('SCOPE_admin')")
    public void deleteUser(@PathVariable Long id) {
        userService.delete(id);
    }
    
    // åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
    @GetMapping("/users/{id}/profile")
    @PreAuthorize("#id == authentication.principal.claims['user_id']")
    public UserProfile getProfile(@PathVariable Long id) {
        return userService.getProfile(id);
    }
}

// å¯ç”¨æ–¹æ³•å®‰å…¨æ³¨è§£
@Configuration
@EnableMethodSecurity  // Spring Security 6+
public class MethodSecurityConfig {
}
```

> **ğŸ’¡ æ–¹æ³•çº§æ§åˆ¶çš„ä¼˜åŠ¿**  
> - æ›´ç»†ç²’åº¦çš„æƒé™æ§åˆ¶
> - ä»£ç æ›´æ¸…æ™°ï¼Œæƒé™è¦æ±‚ä¸€ç›®äº†ç„¶
> - å¯ä»¥ä½¿ç”¨SpELè¡¨è¾¾å¼åšå¤æ‚åˆ¤æ–­

### 7.4 è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯


**ä¸‰ç§è·å–æ–¹å¼**ï¼š

**æ–¹å¼ä¸€ï¼šé€šè¿‡æ–¹æ³•å‚æ•°æ³¨å…¥**
```java
@GetMapping("/me")
public UserInfo getCurrentUser(@AuthenticationPrincipal Jwt jwt) {
    String userId = jwt.getSubject();
    String username = jwt.getClaimAsString("name");
    List<String> scopes = jwt.getClaimAsStringList("scope");
    
    return new UserInfo(userId, username, scopes);
}
```

**æ–¹å¼äºŒï¼šé€šè¿‡SecurityContextè·å–**
```java
@GetMapping("/profile")
public UserProfile getProfile() {
    Authentication auth = SecurityContextHolder.getContext().getAuthentication();
    Jwt jwt = (Jwt) auth.getPrincipal();
    
    String userId = jwt.getSubject();
    return userService.getProfile(userId);
}
```

**æ–¹å¼ä¸‰ï¼šè‡ªå®šä¹‰è½¬æ¢å™¨**
```java
// 1. å®šä¹‰ç”¨æˆ·ä¿¡æ¯ç±»
public class CustomUserDetails {
    private String userId;
    private String username;
    private List<String> roles;
    // getters...
}

// 2. é…ç½®JWTè½¬æ¢å™¨
@Bean
public JwtAuthenticationConverter jwtAuthenticationConverter() {
    JwtAuthenticationConverter converter = new JwtAuthenticationConverter();
    converter.setPrincipalClaimName("user_id");  // è®¾ç½®ç”¨æˆ·IDå­—æ®µ
    
    // è‡ªå®šä¹‰æƒé™è½¬æ¢
    converter.setJwtGrantedAuthoritiesConverter(jwt -> {
        List<String> scopes = jwt.getClaimAsStringList("scope");
        return scopes.stream()
            .map(scope -> new SimpleGrantedAuthority("SCOPE_" + scope))
            .collect(Collectors.toList());
    });
    
    return converter;
}

// 3. åœ¨Controllerä¸­ä½¿ç”¨
@GetMapping("/info")
public UserInfo getInfo(@AuthenticationPrincipal CustomUserDetails user) {
    return new UserInfo(user.getUserId(), user.getUsername());
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ èµ„æºæœåŠ¡å™¨ï¼šä¿æŠ¤èµ„æºçš„æœåŠ¡å™¨ï¼Œè´Ÿè´£éªŒè¯Tokenå’Œæƒé™æ£€æŸ¥
ğŸ”¸ @EnableResourceServerï¼šå¼€å¯èµ„æºæœåŠ¡å™¨åŠŸèƒ½ï¼ˆæ—§ç‰ˆAPIï¼‰
ğŸ”¸ ResourceServerConfigï¼šèµ„æºæœåŠ¡å™¨çš„è¯¦ç»†é…ç½®ç±»
ğŸ”¸ Bearer Tokenï¼šHTTPè¯·æ±‚å¤´ä¸­æºå¸¦çš„è®¿é—®å‡­è¯
ğŸ”¸ JwtDecoderï¼šJWTè§£ç å™¨ï¼Œè´Ÿè´£éªŒè¯å’Œè§£æToken
ğŸ”¸ TokenéªŒè¯ï¼šç­¾åã€æ—¶é—´ã€å‘è¡Œè€…ç­‰å¤šç»´åº¦éªŒè¯
ğŸ”¸ è®¿é—®æ§åˆ¶ï¼šåŸºäºURLã€æƒé™ã€æ–¹æ³•çš„å¤šçº§è®¿é—®æ§åˆ¶
```

### 8.2 é…ç½®æµç¨‹æ€»ç»“


```
èµ„æºæœåŠ¡å™¨é…ç½®å®Œæ•´æµç¨‹ï¼š

[1] æ·»åŠ ä¾èµ–
spring-boot-starter-oauth2-resource-server

[2] é…ç½®JwtDecoder
æŒ‡å®šå¦‚ä½•éªŒè¯JWTï¼ˆå…¬é’¥/è¿œç¨‹è·å–ï¼‰

[3] é…ç½®SecurityFilterChain
è®¾ç½®å“ªäº›URLéœ€è¦ä¿æŠ¤ã€éœ€è¦ä»€ä¹ˆæƒé™

[4] é…ç½®å¼‚å¸¸å¤„ç†
å¤„ç†è®¤è¯å¤±è´¥å’Œæƒé™ä¸è¶³çš„æƒ…å†µ

[5] ï¼ˆå¯é€‰ï¼‰æ–¹æ³•çº§å®‰å…¨
åœ¨Controlleræ–¹æ³•ä¸Šæ·»åŠ @PreAuthorizeæ³¨è§£
```

### 8.3 å…³é”®ç†è§£è¦ç‚¹


> **ğŸ”¹ TokenéªŒè¯çš„æœ¬è´¨**  
> éªŒè¯Token = éªŒè¯è¿™ä¸ª"é€šè¡Œè¯"æ˜¯ä¸æ˜¯çœŸçš„ã€æ˜¯ä¸æ˜¯è¿‡æœŸäº†ã€æ˜¯ä¸æ˜¯æœ‰æƒé™

> **ğŸ”¹ Bearerçš„å«ä¹‰**  
> Bearer = æŒæœ‰è€…ï¼Œè°æ‹¿ç€Tokenè°å°±èƒ½ç”¨ï¼Œæ‰€ä»¥Tokenä¸€å®šè¦ä¿å¯†

> **ğŸ”¹ JWTçš„ä¼˜åŠ¿**  
> ä¸éœ€è¦æŸ¥æ•°æ®åº“ï¼Œè§£æTokenå°±èƒ½çŸ¥é“ç”¨æˆ·ä¿¡æ¯å’Œæƒé™

> **ğŸ”¹ æƒé™æ§åˆ¶çš„å±‚æ¬¡**  
> URLçº§åˆ«ï¼ˆç²—ç²’åº¦ï¼‰â†’ æ–¹æ³•çº§åˆ«ï¼ˆç»†ç²’åº¦ï¼‰â†’ æ•°æ®çº§åˆ«ï¼ˆæœ€ç»†ï¼‰

### 8.4 å®æˆ˜å»ºè®®


**ğŸ¯ å¼€å‘é˜¶æ®µ**ï¼š
- âœ… ä½¿ç”¨è¿œç¨‹è·å–å…¬é’¥ï¼Œæ–¹ä¾¿è°ƒè¯•
- âœ… å¯ç”¨è¯¦ç»†çš„æ—¥å¿—è¾“å‡º
- âœ… å…ˆé…ç½®ç®€å•çš„URLæƒé™è§„åˆ™

**ğŸ¯ æµ‹è¯•é˜¶æ®µ**ï¼š
- âœ… æµ‹è¯•Tokenè¿‡æœŸçš„æƒ…å†µ
- âœ… æµ‹è¯•æƒé™ä¸è¶³çš„æƒ…å†µ
- âœ… æµ‹è¯•æ— æ•ˆTokençš„å¤„ç†

**ğŸ¯ ç”Ÿäº§é˜¶æ®µ**ï¼š
- âœ… ä½¿ç”¨æœ¬åœ°å…¬é’¥æé«˜æ€§èƒ½
- âœ… é…ç½®åˆç†çš„Tokenè¿‡æœŸæ—¶é—´
- âœ… å®ç°å®Œå–„çš„å¼‚å¸¸å¤„ç†

### 8.5 å¸¸è§é—®é¢˜é€ŸæŸ¥


| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| **401 Unauthorized** | Tokenæ— æ•ˆæˆ–è¿‡æœŸ | é‡æ–°è·å–Token |
| **403 Forbidden** | æƒé™ä¸è¶³ | æ£€æŸ¥Tokenä¸­çš„æƒé™èŒƒå›´ |
| **å…¬é’¥éªŒè¯å¤±è´¥** | å…¬é’¥ä¸åŒ¹é… | ç¡®è®¤ä½¿ç”¨æ­£ç¡®çš„å…¬é’¥ |
| **JWTè§£æå¼‚å¸¸** | Tokenæ ¼å¼é”™è¯¯ | æ£€æŸ¥Tokenå®Œæ•´æ€§ |

### 8.6 è¿›é˜¶å­¦ä¹ æ–¹å‘


**ğŸš€ ä¸‹ä¸€æ­¥å¯ä»¥å­¦ä¹ **ï¼š
- Tokenåˆ·æ–°æœºåˆ¶
- è‡ªå®šä¹‰Tokenå¢å¼º
- å¤šç§Ÿæˆ·æƒé™éš”ç¦»
- ç½‘å…³å±‚ç»Ÿä¸€è®¤è¯

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
èµ„æºæœåŠ¡å™¨å®ˆå¤§é—¨ï¼ŒBearer Tokenæ˜¯é€šè¡Œè¯
JwtDecoderæ¥éªŒçœŸä¼ªï¼Œæƒé™æ£€æŸ¥åˆ†å±‚çº§
URLç²—æ§æ–¹æ³•ç»†ï¼ŒSecurityä¿å¹³å®‰
```