---
title: 7ã€æ–¹æ³•çº§åˆ«å®‰å…¨
---
## ğŸ“š ç›®å½•

1. [ä»€ä¹ˆæ˜¯æ–¹æ³•çº§åˆ«å®‰å…¨](#1-ä»€ä¹ˆæ˜¯æ–¹æ³•çº§åˆ«å®‰å…¨)
2. [@PreAuthorizeæ³¨è§£è¯¦è§£](#2-preauthorizeæ³¨è§£è¯¦è§£)
3. [@PostAuthorizeæ³¨è§£è¯¦è§£](#3-postauthorizeæ³¨è§£è¯¦è§£)
4. [SpELè¡¨è¾¾å¼è¯­æ³•](#4-spelè¡¨è¾¾å¼è¯­æ³•)
5. [ç»†ç²’åº¦æƒé™æ§åˆ¶å®è·µ](#5-ç»†ç²’åº¦æƒé™æ§åˆ¶å®è·µ)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ ä»€ä¹ˆæ˜¯æ–¹æ³•çº§åˆ«å®‰å…¨


### 1.1 é€šä¿—ç†è§£


**ç”¨ç”Ÿæ´»åœºæ™¯æ¥ç†è§£**ï¼š
```
æƒ³è±¡ä¸€ä¸ªå…¬å¸çš„æ–‡ä»¶æŸœç³»ç»Ÿï¼š
- URLçº§å®‰å…¨ = é—¨ç¦å¡æ§åˆ¶ï¼ˆæ§åˆ¶è°èƒ½è¿›å“ªä¸ªæˆ¿é—´ï¼‰
- æ–¹æ³•çº§å®‰å…¨ = æ–‡ä»¶æŸœé’¥åŒ™ï¼ˆæ§åˆ¶è°èƒ½æ‰“å¼€å“ªä¸ªæŠ½å±‰ï¼‰

è¿›äº†åŠå…¬å®¤â‰ èƒ½æ‰“å¼€æ‰€æœ‰æ–‡ä»¶æŸœ
æœ‰äº†è®¿é—®æƒé™â‰ èƒ½æ‰§è¡Œæ‰€æœ‰æ“ä½œ
```

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- æ–¹æ³•çº§åˆ«å®‰å…¨æ˜¯åœ¨**æ–¹æ³•æ‰§è¡Œå‰æˆ–æ‰§è¡Œå**è¿›è¡Œæƒé™æ£€æŸ¥
- æ¯”URLçº§åˆ«çš„å®‰å…¨æ§åˆ¶æ›´**ç»†è‡´ã€æ›´çµæ´»**
- å¯ä»¥æ ¹æ®**æ–¹æ³•å‚æ•°ã€è¿”å›å€¼ã€ç”¨æˆ·è§’è‰²**ç­‰æ¡ä»¶åŠ¨æ€åˆ¤æ–­

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦æ–¹æ³•çº§å®‰å…¨


**è§£å†³çš„é—®é¢˜**ï¼š
```
âŒ åªæœ‰URLå®‰å…¨çš„é—®é¢˜ï¼š
/api/users/** â†’ åªèƒ½æ§åˆ¶æ•´ä¸ªæ¥å£çš„è®¿é—®
ä½†æ— æ³•æ§åˆ¶ï¼š
- æ™®é€šç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„ä¿¡æ¯
- ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯
- VIPç”¨æˆ·å¯ä»¥ä¿®æ”¹ç‰¹å®šå­—æ®µ

âœ… æ–¹æ³•çº§å®‰å…¨çš„ä¼˜åŠ¿ï¼š
@PreAuthorize("hasRole('ADMIN') or #userId == authentication.principal.id")
public User getUser(Long userId) { }

è¿™æ ·å°±èƒ½å®ç°ï¼šç®¡ç†å‘˜èƒ½æŸ¥æ‰€æœ‰äººï¼Œæ™®é€šç”¨æˆ·åªèƒ½æŸ¥è‡ªå·±
```

**åº”ç”¨åœºæ™¯å¯¹æ¯”**ï¼š

| åœºæ™¯ | URLçº§å®‰å…¨ | æ–¹æ³•çº§å®‰å…¨ | è¯´æ˜ |
|------|----------|-----------|------|
| **æ§åˆ¶è®¿é—®é¡µé¢** | âœ… é€‚ç”¨ | âŒ ä¸é€‚ç”¨ | ç›´æ¥æ‹¦æˆªURLå³å¯ |
| **æŸ¥çœ‹è‡ªå·±æ•°æ®** | âŒ æ— æ³•å®ç° | âœ… é€‚ç”¨ | éœ€è¦åˆ¤æ–­æ•°æ®å½’å± |
| **æ ¹æ®è§’è‰²æ‰§è¡Œä¸åŒé€»è¾‘** | âŒ å¤æ‚ | âœ… ç®€å• | æ–¹æ³•å†…çµæ´»æ§åˆ¶ |
| **æ•°æ®è„±æ•** | âŒ æ— æ³•å®ç° | âœ… é€‚ç”¨ | æ‰§è¡Œåå¤„ç†è¿”å›å€¼ |

### 1.3 æ–¹æ³•å®‰å…¨çš„å·¥ä½œæµç¨‹


```
è¯·æ±‚æµç¨‹å›¾ï¼š

ç”¨æˆ·è¯·æ±‚ â†’ URLæ‹¦æˆªå™¨(ç¬¬ä¸€é“é˜²çº¿) â†’ é€šè¿‡ â†’ æ–¹æ³•è°ƒç”¨
                  â†“                              â†“
            æƒé™ä¸è¶³ï¼Œè¿”å›403              @PreAuthorizeæ£€æŸ¥
                                                 â†“
                                           æƒé™æ£€æŸ¥é€šè¿‡
                                                 â†“
                                           æ‰§è¡Œä¸šåŠ¡é€»è¾‘
                                                 â†“
                                           @PostAuthorizeæ£€æŸ¥
                                                 â†“
                                           è¿”å›ç»“æœç»™ç”¨æˆ·

åŒé‡ä¿æŠ¤ï¼šURLçº§ + æ–¹æ³•çº§ = æ›´å®‰å…¨
```

---

## 2. âš¡ @PreAuthorizeæ³¨è§£è¯¦è§£


### 2.1 åŸºæœ¬æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯@PreAuthorize**ï¼š
- **Pre = å‰**ï¼ŒAuthorize = æˆæƒ
- åœ¨**æ–¹æ³•æ‰§è¡Œä¹‹å‰**æ£€æŸ¥æƒé™
- å°±åƒ**é—¨å«æ£€æŸ¥é€šè¡Œè¯**ï¼Œä¸åˆæ ¼å°±ä¸è®©è¿›

**åŸºæœ¬ç”¨æ³•**ï¼š
```java
@PreAuthorize("hasRole('ADMIN')")
public void deleteUser(Long id) {
    // åªæœ‰ADMINè§’è‰²æ‰èƒ½æ‰§è¡Œåˆ é™¤
}
```

### 2.2 å¸¸ç”¨è¡¨è¾¾å¼æ¨¡å¼


**ğŸ”¸ åŸºäºè§’è‰²çš„æ§åˆ¶**ï¼š
```java
// å•ä¸€è§’è‰²
@PreAuthorize("hasRole('ADMIN')")
public void adminOnly() { }

// å¤šä¸ªè§’è‰²ï¼ˆæ»¡è¶³ä»»ä¸€å³å¯ï¼‰
@PreAuthorize("hasAnyRole('ADMIN', 'MANAGER')")
public void managerLevel() { }

// å¿…é¡»åŒæ—¶æ‹¥æœ‰å¤šä¸ªè§’è‰²
@PreAuthorize("hasRole('ADMIN') and hasRole('SUPER_ADMIN')")
public void superAdminOnly() { }
```

**ğŸ”¸ åŸºäºæƒé™çš„æ§åˆ¶**ï¼š
```java
// å•ä¸€æƒé™
@PreAuthorize("hasAuthority('user:delete')")
public void deleteUser() { }

// å¤šä¸ªæƒé™ï¼ˆæ»¡è¶³ä»»ä¸€ï¼‰
@PreAuthorize("hasAnyAuthority('user:read', 'user:write')")
public void userOperation() { }
```

**ğŸ”¸ åŸºäºå‚æ•°çš„åŠ¨æ€æ§åˆ¶**ï¼š
```java
// åªèƒ½æ“ä½œè‡ªå·±çš„æ•°æ®
@PreAuthorize("#userId == authentication.principal.id")
public User updateUser(Long userId, User user) {
    // ç”¨æˆ·åªèƒ½æ›´æ–°è‡ªå·±çš„ä¿¡æ¯
}

// ç®¡ç†å‘˜æˆ–è€…æœ¬äºº
@PreAuthorize("hasRole('ADMIN') or #userId == principal.id")
public User getUser(Long userId) { }
```

### 2.3 å®æˆ˜ç¤ºä¾‹


**åœºæ™¯1ï¼šè®¢å•ç®¡ç†ç³»ç»Ÿ**
```java
@Service
public class OrderService {
    
    // ä»»ä½•ç™»å½•ç”¨æˆ·éƒ½èƒ½åˆ›å»ºè®¢å•
    @PreAuthorize("isAuthenticated()")
    public Order createOrder(Order order) {
        return orderRepository.save(order);
    }
    
    // åªèƒ½æŸ¥çœ‹è‡ªå·±çš„è®¢å•ï¼Œç®¡ç†å‘˜é™¤å¤–
    @PreAuthorize("hasRole('ADMIN') or #order.userId == principal.id")
    public Order getOrder(Order order) {
        return order;
    }
    
    // åªæœ‰ç®¡ç†å‘˜èƒ½åˆ é™¤è®¢å•
    @PreAuthorize("hasRole('ADMIN')")
    public void deleteOrder(Long orderId) {
        orderRepository.deleteById(orderId);
    }
}
```

**åœºæ™¯2ï¼šæ–‡ç« å‘å¸ƒç³»ç»Ÿ**
```java
@Service
public class ArticleService {
    
    // ä½œè€…æœ¬äººæˆ–ç¼–è¾‘å¯ä»¥ä¿®æ”¹æ–‡ç« 
    @PreAuthorize("#article.authorId == principal.id or hasRole('EDITOR')")
    public Article updateArticle(Article article) {
        return articleRepository.save(article);
    }
    
    // VIPç”¨æˆ·æˆ–ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹è‰ç¨¿
    @PreAuthorize("hasAnyRole('VIP', 'ADMIN') or #articleId == principal.id")
    public Article viewDraft(Long articleId) {
        return articleRepository.findById(articleId).orElse(null);
    }
}
```

### 2.4 é…ç½®å¯ç”¨æ–¹æ³•å®‰å…¨


```java
@Configuration
@EnableGlobalMethodSecurity(prePostEnabled = true)  // å¯ç”¨@Preå’Œ@Postæ³¨è§£
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
            .authorizeRequests()
            .anyRequest().authenticated()
            .and()
            .oauth2ResourceServer().jwt();
    }
}
```

> ğŸ’¡ **é‡ç‚¹æç¤º**ï¼šå¿…é¡»æ·»åŠ `@EnableGlobalMethodSecurity(prePostEnabled = true)`æ‰èƒ½ä½¿ç”¨æ–¹æ³•çº§å®‰å…¨æ³¨è§£

---

## 3. ğŸ”’ @PostAuthorizeæ³¨è§£è¯¦è§£


### 3.1 åŸºæœ¬æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯@PostAuthorize**ï¼š
- **Post = å**ï¼Œåœ¨**æ–¹æ³•æ‰§è¡Œä¹‹å**æ£€æŸ¥æƒé™
- å¯ä»¥è®¿é—®**æ–¹æ³•çš„è¿”å›å€¼**è¿›è¡Œåˆ¤æ–­
- å°±åƒ**å¿«é€’éªŒè´§**ï¼Œæ‰“å¼€åŒ…è£¹åå‘ç°ä¸å¯¹å¯ä»¥æ‹’æ”¶

**ä¸@PreAuthorizeçš„åŒºåˆ«**ï¼š
```
@PreAuthorizeï¼šæ–¹æ³•æ‰§è¡Œå‰æ£€æŸ¥
- ä¼˜ç‚¹ï¼šæ€§èƒ½å¥½ï¼Œä¸åˆæ ¼ç›´æ¥æ‹¦æˆª
- ç¼ºç‚¹ï¼šæ— æ³•è®¿é—®è¿”å›å€¼

@PostAuthorizeï¼šæ–¹æ³•æ‰§è¡Œåæ£€æŸ¥  
- ä¼˜ç‚¹ï¼šèƒ½åŸºäºè¿”å›å€¼åˆ¤æ–­
- ç¼ºç‚¹ï¼šæ–¹æ³•å·²æ‰§è¡Œï¼Œæ€§èƒ½ç¨å·®

ä½¿ç”¨åœºæ™¯ï¼š
@PreAuthorize â†’ å¤§éƒ¨åˆ†æƒ…å†µï¼ˆæ¨èï¼‰
@PostAuthorize â†’ éœ€è¦æ ¹æ®æŸ¥è¯¢ç»“æœåˆ¤æ–­æƒé™æ—¶
```

### 3.2 å¸¸ç”¨åœºæ™¯


**ğŸ”¸ åŸºäºè¿”å›å€¼çš„æƒé™æ§åˆ¶**ï¼š
```java
// åªèƒ½è·å–è‡ªå·±çš„ç”¨æˆ·ä¿¡æ¯
@PostAuthorize("returnObject.username == authentication.name")
public User getUserById(Long id) {
    return userRepository.findById(id).orElse(null);
}

// returnObject = æ–¹æ³•è¿”å›çš„Userå¯¹è±¡
// å¦‚æœè¿”å›çš„ç”¨æˆ·åâ‰ å½“å‰ç™»å½•ç”¨æˆ·ï¼ŒæŠ›å‡ºå¼‚å¸¸
```

**ğŸ”¸ æ•°æ®æ‰€æœ‰æƒéªŒè¯**ï¼š
```java
@PostAuthorize("returnObject.ownerId == principal.id")
public Document getDocument(Long docId) {
    return documentRepository.findById(docId).orElse(null);
}

// æŸ¥è¯¢æ–‡æ¡£åï¼Œæ£€æŸ¥æ–‡æ¡£æ‰€æœ‰è€…æ˜¯å¦æ˜¯å½“å‰ç”¨æˆ·
```

### 3.3 å®æˆ˜ç¤ºä¾‹


**åœºæ™¯ï¼šé“¶è¡Œè´¦æˆ·æŸ¥è¯¢**
```java
@Service
public class AccountService {
    
    // æŸ¥è¯¢è´¦æˆ·ä¿¡æ¯ï¼Œä½†åªèƒ½è¿”å›å±äºè‡ªå·±çš„è´¦æˆ·
    @PostAuthorize("returnObject.userId == principal.id or hasRole('ADMIN')")
    public Account getAccount(String accountNumber) {
        return accountRepository.findByAccountNumber(accountNumber);
    }
    
    // æŸ¥è¯¢äº¤æ˜“è®°å½•ï¼Œåªèƒ½çœ‹è‡ªå·±çš„
    @PostAuthorize("returnObject.accountId == principal.accountId")
    public Transaction getTransaction(Long transactionId) {
        return transactionRepository.findById(transactionId).orElse(null);
    }
}
```

**åœºæ™¯ï¼šå¤šç§Ÿæˆ·ç³»ç»Ÿ**
```java
@Service
public class TenantDataService {
    
    // ç¡®ä¿è¿”å›çš„æ•°æ®å±äºå½“å‰ç§Ÿæˆ·
    @PostAuthorize("returnObject.tenantId == principal.tenantId")
    public TenantData getData(Long dataId) {
        return dataRepository.findById(dataId).orElse(null);
    }
}
```

### 3.4 æ³¨æ„äº‹é¡¹


âš ï¸ **é‡è¦è­¦å‘Š**ï¼š
```
@PostAuthorizeçš„æ€§èƒ½é—®é¢˜ï¼š
1. æ–¹æ³•ä¼šå®Œæ•´æ‰§è¡Œï¼ˆåŒ…æ‹¬æ•°æ®åº“æŸ¥è¯¢ï¼‰
2. æƒé™æ£€æŸ¥å¤±è´¥æ—¶ï¼Œç»“æœä¼šè¢«ä¸¢å¼ƒ
3. å¯èƒ½å­˜åœ¨å®‰å…¨é£é™©ï¼ˆæ–¹æ³•å‰¯ä½œç”¨å·²å‘ç”Ÿï¼‰

å»ºè®®ï¼š
âœ… ä¼˜å…ˆä½¿ç”¨@PreAuthorize
âœ… @PostAuthorizeåªç”¨äºå¿…é¡»åŸºäºè¿”å›å€¼åˆ¤æ–­çš„åœºæ™¯
âœ… å¯¹äºæœ‰å‰¯ä½œç”¨çš„æ“ä½œï¼ˆå†™æ“ä½œï¼‰ï¼Œé¿å…ä½¿ç”¨@PostAuthorize
```

---

## 4. ğŸ“– SpELè¡¨è¾¾å¼è¯­æ³•


### 4.1 ä»€ä¹ˆæ˜¯SpEL


**é€šä¿—ç†è§£**ï¼š
- SpEL = Spring Expression Languageï¼ˆSpringè¡¨è¾¾å¼è¯­è¨€ï¼‰
- å°±åƒä¸€ä¸ª**è¿·ä½ ç¼–ç¨‹è¯­è¨€**ï¼Œç”¨æ¥å†™æƒé™åˆ¤æ–­æ¡ä»¶
- å¯ä»¥è®¿é—®å¯¹è±¡å±æ€§ã€è°ƒç”¨æ–¹æ³•ã€è¿›è¡Œé€»è¾‘è¿ç®—

**åŸºæœ¬è¯­æ³•è§„åˆ™**ï¼š
```
è®¿é—®å¯¹è±¡å±æ€§ï¼š  å¯¹è±¡.å±æ€§å
è°ƒç”¨æ–¹æ³•ï¼š      å¯¹è±¡.æ–¹æ³•å()
é€»è¾‘è¿ç®—ï¼š      and, or, not
æ¯”è¾ƒè¿ç®—ï¼š      ==, !=, <, >, <=, >=
ä¸‰å…ƒè¿ç®—ï¼š      æ¡ä»¶ ? çœŸå€¼ : å‡å€¼
```

### 4.2 å†…ç½®å¯¹è±¡


**å¸¸ç”¨çš„å†…ç½®å¯¹è±¡**ï¼š

| å¯¹è±¡ | è¯´æ˜ | ä½¿ç”¨ç¤ºä¾‹ |
|------|------|---------|
| `authentication` | å½“å‰è®¤è¯ä¿¡æ¯ | `authentication.name` |
| `principal` | å½“å‰ç”¨æˆ·ä¸»ä½“ | `principal.id` |
| `returnObject` | æ–¹æ³•è¿”å›å€¼ | `returnObject.ownerId` |
| `#å‚æ•°å` | æ–¹æ³•å‚æ•° | `#userId`, `#user.name` |

**ç¤ºä¾‹è¯´æ˜**ï¼š
```java
// authenticationï¼šå®Œæ•´çš„è®¤è¯å¯¹è±¡
@PreAuthorize("authentication.name == 'admin'")

// principalï¼šç®€åŒ–è®¿é—®ç”¨æˆ·ä¿¡æ¯ï¼ˆauthentication.principalçš„ç®€å†™ï¼‰
@PreAuthorize("principal.username == #username")

// returnObjectï¼šåªèƒ½åœ¨@PostAuthorizeä¸­ä½¿ç”¨
@PostAuthorize("returnObject.status == 'APPROVED'")

// #å‚æ•°åï¼šè®¿é—®æ–¹æ³•å‚æ•°
@PreAuthorize("#user.age >= 18")
public void register(User user) { }
```

### 4.3 å¸¸ç”¨è¡¨è¾¾å¼


**ğŸ”¸ è§’è‰²å’Œæƒé™æ£€æŸ¥**ï¼š
```java
// æ£€æŸ¥è§’è‰²
hasRole('ADMIN')                    // æœ‰ADMINè§’è‰²
hasAnyRole('USER', 'ADMIN')        // æœ‰USERæˆ–ADMINè§’è‰²ä¹‹ä¸€
hasRole('ADMIN') and hasRole('VIP') // åŒæ—¶æœ‰ADMINå’ŒVIPè§’è‰²

// æ£€æŸ¥æƒé™
hasAuthority('user:read')           // æœ‰user:readæƒé™
hasAnyAuthority('user:read', 'user:write') // æœ‰ä»»ä¸€æƒé™

// æ£€æŸ¥è®¤è¯çŠ¶æ€
isAuthenticated()                   // å·²ç™»å½•
isAnonymous()                      // æœªç™»å½•
permitAll()                        // å…è®¸æ‰€æœ‰äºº
denyAll()                          // æ‹’ç»æ‰€æœ‰äºº
```

**ğŸ”¸ æ¡ä»¶åˆ¤æ–­**ï¼š
```java
// åŸºæœ¬æ¯”è¾ƒ
#userId == principal.id             // å‚æ•°userIdç­‰äºå½“å‰ç”¨æˆ·ID
#age >= 18                         // å¹´é¾„å¤§äºç­‰äº18
#status == 'ACTIVE'                // çŠ¶æ€ä¸ºACTIVE

// é€»è¾‘ç»„åˆ
hasRole('ADMIN') or #userId == principal.id
// æ˜¯ç®¡ç†å‘˜ æˆ–è€… æ˜¯æœ¬äºº

hasRole('VIP') and #amount <= 10000
// æ˜¯VIP ä¸” é‡‘é¢ä¸è¶…è¿‡10000

not hasRole('BANNED')
// ä¸æ˜¯è¢«å°ç¦ç”¨æˆ·
```

**ğŸ”¸ å¤æ‚è¡¨è¾¾å¼**ï¼š
```java
// è®¿é—®åµŒå¥—å±æ€§
@PreAuthorize("#order.user.id == principal.id")
public void processOrder(Order order) { }

// ä½¿ç”¨ä¸‰å…ƒè¿ç®—ç¬¦
@PreAuthorize("hasRole('ADMIN') ? true : #userId == principal.id")
public User getUser(Long userId) { }
// ç®¡ç†å‘˜æ— æ¡ä»¶é€šè¿‡ï¼Œæ™®é€šç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±

// è°ƒç”¨æ–¹æ³•
@PreAuthorize("@permissionService.hasPermission(principal, #resourceId)")
public void accessResource(Long resourceId) { }
```

### 4.4 è‡ªå®šä¹‰æƒé™éªŒè¯æ–¹æ³•


**åˆ›å»ºè‡ªå®šä¹‰æƒé™æ£€æŸ¥ç±»**ï¼š
```java
@Component("customSecurity")
public class CustomSecurityExpression {
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯èµ„æºæ‰€æœ‰è€…
    public boolean isOwner(Long userId) {
        Authentication auth = SecurityContextHolder.getContext().getAuthentication();
        Long currentUserId = ((CustomUserDetails) auth.getPrincipal()).getId();
        return userId.equals(currentUserId);
    }
    
    // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®è®¿é—®æƒé™
    public boolean canAccessData(String dataType, Long dataId) {
        // è‡ªå®šä¹‰å¤æ‚çš„æƒé™é€»è¾‘
        return true; // å®é™…å®ç°æ ¹æ®ä¸šåŠ¡éœ€æ±‚
    }
}
```

**åœ¨æ³¨è§£ä¸­ä½¿ç”¨**ï¼š
```java
// @customSecurity å¼•ç”¨Beanåç§°
@PreAuthorize("@customSecurity.isOwner(#userId)")
public void updateUserProfile(Long userId, UserProfile profile) { }

@PreAuthorize("@customSecurity.canAccessData('ORDER', #orderId)")
public Order getOrder(Long orderId) { }
```

---

## 5. ğŸ¯ ç»†ç²’åº¦æƒé™æ§åˆ¶å®è·µ


### 5.1 å¤šå±‚æ¬¡æƒé™è®¾è®¡


**æƒé™å±‚æ¬¡ç»“æ„**ï¼š
```
ç³»ç»Ÿæƒé™å±‚æ¬¡è®¾è®¡ï¼š

è§’è‰²(Role)
   â†“
æƒé™(Authority/Permission)
   â†“  
æ“ä½œ(Action)
   â†“
èµ„æº(Resource)

ç¤ºä¾‹ï¼š
ADMINè§’è‰² â†’ user:manageæƒé™ â†’ deleteæ“ä½œ â†’ Userèµ„æº
```

**å®ç°ç¤ºä¾‹**ï¼š
```java
@Service
public class UserService {
    
    // ç¬¬1å±‚ï¼šåŸºäºè§’è‰²
    @PreAuthorize("hasRole('ADMIN')")
    public void deleteUser(Long userId) { }
    
    // ç¬¬2å±‚ï¼šåŸºäºæƒé™
    @PreAuthorize("hasAuthority('user:delete')")
    public void removeUser(Long userId) { }
    
    // ç¬¬3å±‚ï¼šåŸºäºæ“ä½œ+èµ„æº
    @PreAuthorize("@permissionEvaluator.hasPermission(authentication, #userId, 'User', 'DELETE')")
    public void eraseUser(Long userId) { }
    
    // ç¬¬4å±‚ï¼šå¤åˆæ¡ä»¶
    @PreAuthorize("hasRole('ADMIN') and hasAuthority('user:delete') and @customSecurity.canDelete(#userId)")
    public void permanentDelete(Long userId) { }
}
```

### 5.2 æ•°æ®éš”ç¦»æ–¹æ¡ˆ


**åœºæ™¯ï¼šå¤šç§Ÿæˆ·æ•°æ®éš”ç¦»**
```java
@Service
public class TenantAwareService {
    
    // æ–¹æ¡ˆ1ï¼šå‚æ•°æ ¡éªŒ
    @PreAuthorize("#tenantId == principal.tenantId")
    public List<Order> getOrders(Long tenantId) {
        return orderRepository.findByTenantId(tenantId);
    }
    
    // æ–¹æ¡ˆ2ï¼šè¿”å›å€¼æ ¡éªŒ
    @PostAuthorize("returnObject.tenantId == principal.tenantId")
    public Order getOrder(Long orderId) {
        return orderRepository.findById(orderId).orElse(null);
    }
    
    // æ–¹æ¡ˆ3ï¼šé›†åˆè¿‡æ»¤
    @PostFilter("filterObject.tenantId == principal.tenantId")
    public List<Order> getAllOrders() {
        return orderRepository.findAll();
    }
    // @PostFilterä¼šè¿‡æ»¤æ‰ä¸ç¬¦åˆæ¡ä»¶çš„å…ƒç´ 
}
```

**åœºæ™¯ï¼šéƒ¨é—¨æ•°æ®æƒé™**
```java
@Service
public class DepartmentDataService {
    
    // åªèƒ½è®¿é—®æœ¬éƒ¨é—¨åŠå­éƒ¨é—¨æ•°æ®
    @PreAuthorize("@departmentService.canAccess(principal.deptId, #deptId)")
    public List<Employee> getEmployees(Long deptId) {
        return employeeRepository.findByDeptId(deptId);
    }
}

@Service
public class DepartmentService {
    
    public boolean canAccess(Long userDeptId, Long targetDeptId) {
        // æ£€æŸ¥æ˜¯å¦æ˜¯åŒä¸€éƒ¨é—¨æˆ–çˆ¶å­éƒ¨é—¨å…³ç³»
        return userDeptId.equals(targetDeptId) || 
               isParentDept(userDeptId, targetDeptId);
    }
}
```

### 5.3 å­—æ®µçº§æƒé™æ§åˆ¶


**åœºæ™¯ï¼šæ•æ„Ÿå­—æ®µè„±æ•**
```java
@Service
public class UserProfileService {
    
    // æ™®é€šç”¨æˆ·çœ‹åˆ°çš„ä¸ªäººèµ„æ–™ï¼ˆè„±æ•ï¼‰
    @PostAuthorize("returnObject != null")
    public UserProfileDTO getProfile(Long userId) {
        User user = userRepository.findById(userId).orElse(null);
        if (user == null) return null;
        
        UserProfileDTO dto = new UserProfileDTO();
        dto.setUsername(user.getUsername());
        
        // æ ¹æ®æƒé™å†³å®šæ˜¯å¦æ˜¾ç¤ºæ•æ„Ÿä¿¡æ¯
        if (hasAuthority("user:view:phone")) {
            dto.setPhone(user.getPhone());
        } else {
            dto.setPhone(maskPhone(user.getPhone())); // è„±æ•
        }
        
        if (hasAuthority("user:view:email")) {
            dto.setEmail(user.getEmail());
        } else {
            dto.setEmail(maskEmail(user.getEmail()));
        }
        
        return dto;
    }
    
    private String maskPhone(String phone) {
        return phone.replaceAll("(\\d{3})\\d{4}(\\d{4})", "$1****$2");
    }
}
```

### 5.4 åŠ¨æ€æƒé™é…ç½®


**åœºæ™¯ï¼šå¯é…ç½®çš„æƒé™è§„åˆ™**
```java
@Service
public class DynamicPermissionService {
    
    @Autowired
    private PermissionRuleRepository ruleRepository;
    
    public boolean checkPermission(String resource, String action) {
        // ä»æ•°æ®åº“åŠ è½½æƒé™è§„åˆ™
        PermissionRule rule = ruleRepository.findByResourceAndAction(resource, action);
        
        if (rule == null) return false;
        
        Authentication auth = SecurityContextHolder.getContext().getAuthentication();
        
        // åŠ¨æ€è¯„ä¼°SpELè¡¨è¾¾å¼
        ExpressionParser parser = new SpelExpressionParser();
        StandardEvaluationContext context = new StandardEvaluationContext();
        context.setVariable("auth", auth);
        
        Expression exp = parser.parseExpression(rule.getExpression());
        return exp.getValue(context, Boolean.class);
    }
}

// ä½¿ç”¨ç¤ºä¾‹
@PreAuthorize("@dynamicPermissionService.checkPermission('USER', 'DELETE')")
public void deleteUser(Long userId) { }
```

### 5.5 å®¡è®¡æ—¥å¿—é›†æˆ


**æƒé™æ£€æŸ¥ä¸å®¡è®¡ç»“åˆ**ï¼š
```java
@Aspect
@Component
public class SecurityAuditAspect {
    
    @Autowired
    private AuditLogService auditLogService;
    
    // æ‹¦æˆªæ‰€æœ‰å¸¦æƒé™æ³¨è§£çš„æ–¹æ³•
    @Around("@annotation(preAuthorize)")
    public Object auditSecurityCheck(ProceedingJoinPoint joinPoint, 
                                     PreAuthorize preAuthorize) throws Throwable {
        
        Authentication auth = SecurityContextHolder.getContext().getAuthentication();
        String method = joinPoint.getSignature().getName();
        String expression = preAuthorize.value();
        
        try {
            Object result = joinPoint.proceed();
            
            // è®°å½•æˆåŠŸçš„è®¿é—®
            auditLogService.log(
                auth.getName(), 
                method, 
                "SUCCESS", 
                expression
            );
            
            return result;
        } catch (AccessDeniedException e) {
            // è®°å½•å¤±è´¥çš„è®¿é—®å°è¯•
            auditLogService.log(
                auth.getName(), 
                method, 
                "DENIED", 
                expression
            );
            throw e;
        }
    }
}
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ–¹æ³•çº§å®‰å…¨ï¼šåœ¨æ–¹æ³•å±‚é¢è¿›è¡Œç»†ç²’åº¦æƒé™æ§åˆ¶
ğŸ”¸ @PreAuthorizeï¼šæ–¹æ³•æ‰§è¡Œå‰æ£€æŸ¥ï¼Œæ€§èƒ½å¥½ï¼Œä½¿ç”¨æœ€å¤š
ğŸ”¸ @PostAuthorizeï¼šæ–¹æ³•æ‰§è¡Œåæ£€æŸ¥ï¼Œå¯è®¿é—®è¿”å›å€¼
ğŸ”¸ SpELè¡¨è¾¾å¼ï¼šçµæ´»çš„æƒé™åˆ¤æ–­è¯­è¨€
ğŸ”¸ ç»†ç²’åº¦æ§åˆ¶ï¼šè§’è‰²ã€æƒé™ã€å‚æ•°ã€è¿”å›å€¼å¤šç»´åº¦æ§åˆ¶
```

### 6.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ æ³¨è§£é€‰æ‹©åŸåˆ™**
```
ä¼˜å…ˆä½¿ç”¨@PreAuthorizeï¼š
âœ… æ€§èƒ½å¥½ï¼Œæå‰æ‹¦æˆª
âœ… è¦†ç›–90%çš„åœºæ™¯
âœ… é¿å…æ–¹æ³•å‰¯ä½œç”¨

ä»…åœ¨å¿…è¦æ—¶ç”¨@PostAuthorizeï¼š
ğŸ”¸ å¿…é¡»åŸºäºè¿”å›å€¼åˆ¤æ–­
ğŸ”¸ åªè¯»æ“ä½œï¼ˆæŸ¥è¯¢ï¼‰
ğŸ”¸ é…åˆ@PostFilterè¿‡æ»¤é›†åˆ
```

**ğŸ”¹ SpELè¡¨è¾¾å¼å®ç”¨æŠ€å·§**
```
åŸºç¡€è¡¨è¾¾å¼ï¼š
hasRole('ADMIN')                    â†’ è§’è‰²æ£€æŸ¥
hasAuthority('user:read')          â†’ æƒé™æ£€æŸ¥
#userId == principal.id            â†’ å‚æ•°æ£€æŸ¥

ç»„åˆè¡¨è¾¾å¼ï¼š
hasRole('ADMIN') or #userId == principal.id
â†’ ç®¡ç†å‘˜æˆ–æœ¬äººå¯è®¿é—®

è‡ªå®šä¹‰æ–¹æ³•ï¼š
@customSecurity.checkPermission(#id)
â†’ å°è£…å¤æ‚é€»è¾‘
```

**ğŸ”¹ æƒé™è®¾è®¡æœ€ä½³å®è·µ**
```
1. åˆ†å±‚è®¾è®¡ï¼šè§’è‰² â†’ æƒé™ â†’ æ“ä½œ â†’ èµ„æº
2. æœ€å°æƒé™åŸåˆ™ï¼šé»˜è®¤æ‹’ç»ï¼ŒæŒ‰éœ€å¼€æ”¾
3. æ•°æ®éš”ç¦»ï¼šç§Ÿæˆ·ã€éƒ¨é—¨ã€ç”¨æˆ·çº§åˆ«éš”ç¦»
4. å®¡è®¡æ—¥å¿—ï¼šè®°å½•æ‰€æœ‰æƒé™æ£€æŸ¥ç»“æœ
5. åŠ¨æ€é…ç½®ï¼šæ”¯æŒè¿è¡Œæ—¶è°ƒæ•´æƒé™è§„åˆ™
```

### 6.3 å®é™…åº”ç”¨ä»·å€¼


**å…¸å‹åº”ç”¨åœºæ™¯**ï¼š
- **SaaSå¤šç§Ÿæˆ·ç³»ç»Ÿ**ï¼šæ•°æ®éš”ç¦»ï¼Œé˜²æ­¢è¶Šæƒè®¿é—®
- **ä¼ä¸šOAç³»ç»Ÿ**ï¼šéƒ¨é—¨æ•°æ®æƒé™ï¼Œæµç¨‹å®¡æ‰¹æƒé™
- **ç”µå•†å¹³å°**ï¼šå•†å®¶åªèƒ½ç®¡ç†è‡ªå·±çš„å•†å“å’Œè®¢å•
- **é‡‘èç³»ç»Ÿ**ï¼šæ•æ„Ÿæ•°æ®å­—æ®µçº§æƒé™æ§åˆ¶
- **åŒ»ç–—ç³»ç»Ÿ**ï¼šæ‚£è€…éšç§ä¿æŠ¤ï¼Œè§’è‰²æƒé™æ§åˆ¶

**ğŸ¯ å¼€å‘æ£€æŸ¥æ¸…å•**

âœ… **è®¾è®¡é˜¶æ®µ**
- [ ] æ˜ç¡®è§’è‰²å’Œæƒé™ä½“ç³»
- [ ] è§„åˆ’æƒé™ç²’åº¦ï¼ˆURLçº§ã€æ–¹æ³•çº§ã€å­—æ®µçº§ï¼‰
- [ ] è®¾è®¡æ•°æ®éš”ç¦»æ–¹æ¡ˆ

âœ… **å¼€å‘é˜¶æ®µ**
- [ ] å¯ç”¨æ–¹æ³•å®‰å…¨é…ç½®
- [ ] åˆç†é€‰æ‹©@Pre/@Postæ³¨è§£
- [ ] ç¼–å†™æ¸…æ™°çš„SpELè¡¨è¾¾å¼
- [ ] å°è£…å¤æ‚æƒé™é€»è¾‘

âœ… **æµ‹è¯•é˜¶æ®µ**
- [ ] æµ‹è¯•å„ç§è§’è‰²çš„è®¿é—®æƒé™
- [ ] éªŒè¯æ•°æ®éš”ç¦»æ•ˆæœ
- [ ] æµ‹è¯•è¾¹ç•Œæ¡ä»¶å’Œå¼‚å¸¸æƒ…å†µ

âœ… **è¿ç»´é˜¶æ®µ**
- [ ] é…ç½®å®¡è®¡æ—¥å¿—
- [ ] ç›‘æ§æƒé™æ‹’ç»æƒ…å†µ
- [ ] å®šæœŸå®¡æŸ¥æƒé™é…ç½®

### 6.4 å¸¸è§é—®é¢˜ä¸è§£å†³


**â“ Q1: @PreAuthorizeä¸ç”Ÿæ•ˆï¼Ÿ**
```
A: æ£€æŸ¥ä»¥ä¸‹é…ç½®ï¼š
1. æ˜¯å¦æ·»åŠ @EnableGlobalMethodSecurity(prePostEnabled = true)
2. æ³¨è§£æ˜¯å¦åŠ åœ¨publicæ–¹æ³•ä¸Š
3. æ˜¯å¦é€šè¿‡Springå®¹å™¨è°ƒç”¨ï¼ˆselfè°ƒç”¨æ— æ•ˆï¼‰
```

**â“ Q2: å¦‚ä½•å¤„ç†å¤æ‚æƒé™é€»è¾‘ï¼Ÿ**
```
A: å°è£…åˆ°è‡ªå®šä¹‰Beanä¸­ï¼š
@Component("authService")
public class AuthService {
    public boolean canAccess(...) {
        // å¤æ‚é€»è¾‘
    }
}

ä½¿ç”¨ï¼š@PreAuthorize("@authService.canAccess(#id)")
```

**â“ Q3: æ€§èƒ½é—®é¢˜å¦‚ä½•ä¼˜åŒ–ï¼Ÿ**
```
A: ä¼˜åŒ–ç­–ç•¥ï¼š
1. ä¼˜å…ˆä½¿ç”¨@PreAuthorizeï¼ˆé¿å…æ–¹æ³•æ‰§è¡Œå¼€é”€ï¼‰
2. ç¼“å­˜æƒé™åˆ¤æ–­ç»“æœ
3. å‡å°‘æ•°æ®åº“æŸ¥è¯¢
4. ä½¿ç”¨@PostFilteræ›¿ä»£åœ¨ä»£ç ä¸­è¿‡æ»¤
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
æ–¹æ³•å®‰å…¨ç»†ç²’åº¦ï¼ŒPreå’ŒPostè¦åˆ†æ¸…
SpELè¡¨è¾¾å¼æ˜¯å…³é”®ï¼Œè§’è‰²æƒé™å‚æ•°éªŒ
è‡ªå®šä¹‰Beanå°è£…å¥½ï¼Œå¤æ‚é€»è¾‘ä¸ç”¨æ…Œ
å®¡è®¡æ—¥å¿—è¦è®°å½•ï¼Œå®‰å…¨åˆè§„ä¸¤ä¸è¯¯
```