---
title: 3、授权服务器配置
---
## 📚 目录


1. [授权服务器基础概念](#1-授权服务器基础概念)
2. [授权服务器搭建准备](#2-授权服务器搭建准备)
3. [EnableAuthorizationServer注解详解](#3-enableauthorizationserver注解详解)
4. [AuthorizationServerConfig核心配置](#4-authorizationserverconfig核心配置)
5. [客户端配置与注册](#5-客户端配置与注册)
6. [认证端点配置](#6-认证端点配置)
7. [令牌端点配置](#7-令牌端点配置)
8. [核心要点总结](#8-核心要点总结)

---

# 🎯 **学习导航**


**前置知识**：需要掌握Spring Security基础、OAuth2.0协议原理 → **当前内容**：授权服务器实现 → **后续学习**：资源服务器配置、JWT令牌

⏱️ **预计学习时间**：本章预计45分钟 | 实践配置30分钟

---

## 1. 🏛️ 授权服务器基础概念



### 1.1 什么是授权服务器



**🔸 通俗理解**
```
授权服务器就像一个"身份证办理中心"：

🎫 真实场景类比：
你去政务中心办理身份证：
1. 你提交材料(账号密码)
2. 工作人员核实身份(认证)
3. 给你发放身份证(令牌)
4. 凭身份证办理各种业务(访问资源)

🔐 授权服务器同理：
1. 用户提交凭证
2. 验证用户身份
3. 颁发访问令牌
4. 令牌可访问资源
```

**💡 核心定义**
```
授权服务器(Authorization Server)：
• 作用：负责用户认证和颁发令牌
• 职责：管理客户端、用户、令牌
• 核心：验证身份、授权访问、发放凭证
```

### 1.2 授权服务器的核心功能



**🎯 四大核心职责**

| 功能模块 | 说明 | 通俗理解 |
|---------|------|---------|
| **用户认证** | 验证用户名密码是否正确 | 就像门卫验证你的工作证 |
| **客户端管理** | 管理哪些应用可以接入 | 就像管理哪些公司可以入驻 |
| **授权处理** | 决定给什么权限 | 就像决定给你哪些楼层的门禁 |
| **令牌颁发** | 生成和管理访问令牌 | 就像发放临时通行证 |

### 1.3 授权服务器工作流程



**🔄 完整认证流程图示**
```
用户端                授权服务器              资源服务器
  |                       |                      |
  |--[1]请求授权--------->|                      |
  |  (用户名+密码)         |                      |
  |                       |                      |
  |                   [验证身份]                 |
  |                       |                      |
  |<--[2]返回令牌---------|                      |
  |  (access_token)       |                      |
  |                       |                      |
  |--[3]携带令牌-------------------------------->|
  |                       |                      |
  |                       |<--[4]验证令牌--------|
  |                       |                      |
  |                       |--[5]令牌有效-------->|
  |                       |                      |
  |<--[6]返回资源------------------------------ |
```

---

## 2. 🛠️ 授权服务器搭建准备



### 2.1 Maven依赖配置



**📦 必需依赖清单**
```xml
<dependencies>
    <!-- Spring Security OAuth2 核心依赖 -->
    <dependency>
        <groupId>org.springframework.security.oauth</groupId>
        <artifactId>spring-security-oauth2</artifactId>
        <version>2.3.8.RELEASE</version>
    </dependency>
    
    <!-- Spring Security 基础依赖 -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-security</artifactId>
    </dependency>
    
    <!-- Web支持 -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
</dependencies>
```

> 💡 **依赖说明**：
> - `spring-security-oauth2`：提供OAuth2核心功能
> - `spring-boot-starter-security`：提供安全认证基础
> - `spring-boot-starter-web`：提供Web接口能力

### 2.2 项目结构规划



**📁 推荐项目结构**
```
oauth2-auth-server/
├── src/main/java/
│   └── com/example/oauth/
│       ├── config/
│       │   ├── AuthorizationServerConfig.java   ← 授权服务器配置
│       │   └── SecurityConfig.java              ← 安全配置
│       ├── service/
│       │   └── UserDetailsServiceImpl.java      ← 用户服务
│       └── OAuth2Application.java               ← 启动类
└── src/main/resources/
    └── application.yml                          ← 配置文件
```

### 2.3 基础配置文件



**⚙️ application.yml 配置**
```yaml
server:
  port: 8080  # 授权服务器端口

spring:
  application:
    name: oauth2-auth-server  # 服务名称
    
# 日志配置（方便调试）

logging:
  level:
    org.springframework.security: DEBUG
```

---

## 3. 🔑 EnableAuthorizationServer注解详解



### 3.1 注解作用说明



**🎯 @EnableAuthorizationServer 核心功能**
```java
@Configuration
@EnableAuthorizationServer  // 👈 这个注解开启授权服务器
public class AuthorizationServerConfig {
    // 配置内容...
}
```

**💡 注解功能解析**
```
@EnableAuthorizationServer 做了什么？

✅ 启用OAuth2授权服务器功能
✅ 自动配置必要的Bean组件
✅ 注册默认的端点路径：
   • /oauth/authorize - 授权端点
   • /oauth/token     - 令牌端点
   • /oauth/check_token - 令牌验证
   • /oauth/confirm_access - 授权确认
```

### 3.2 注解使用示例



**📝 完整配置示例**
```java
@Configuration
@EnableAuthorizationServer
public class AuthorizationServerConfig 
    extends AuthorizationServerConfigurerAdapter {
    
    // 这个类继承了适配器，可以自定义配置
    // 主要重写三个方法：
    // 1. configure(ClientDetailsServiceConfigurer) - 客户端配置
    // 2. configure(AuthorizationServerEndpointsConfigurer) - 端点配置  
    // 3. configure(AuthorizationServerSecurityConfigurer) - 安全配置
}
```

> ⚠️ **注意事项**：
> - 必须配合`@Configuration`使用
> - 通常继承`AuthorizationServerConfigurerAdapter`
> - 一个项目只需要一个授权服务器配置类

---

## 4. ⚙️ AuthorizationServerConfig核心配置



### 4.1 配置类基本结构



**🏗️ 配置类完整框架**
```java
@Configuration
@EnableAuthorizationServer
public class AuthorizationServerConfig 
    extends AuthorizationServerConfigurerAdapter {
    
    // 注入必要的组件
    @Autowired
    private AuthenticationManager authenticationManager;
    
    @Autowired
    private UserDetailsService userDetailsService;
    
    // 配置客户端
    @Override
    public void configure(ClientDetailsServiceConfigurer clients) {
        // 客户端配置代码
    }
    
    // 配置端点
    @Override
    public void configure(AuthorizationServerEndpointsConfigurer endpoints) {
        // 端点配置代码
    }
    
    // 配置安全策略
    @Override
    public void configure(AuthorizationServerSecurityConfigurer security) {
        // 安全配置代码
    }
}
```

### 4.2 三大配置方法说明



**📋 配置方法对比**

| 配置方法 | 作用 | 配置内容 |
|---------|------|---------|
| **ClientDetailsServiceConfigurer** | 客户端配置 | 哪些应用可以接入、权限范围 |
| **AuthorizationServerEndpointsConfigurer** | 端点配置 | 认证方式、令牌存储 |
| **AuthorizationServerSecurityConfigurer** | 安全配置 | 端点访问权限控制 |

**💡 记忆技巧**
```
三大配置记忆法：

🔹 ClientDetails：管"谁能来"
   → 配置客户端信息

🔹 Endpoints：管"怎么做"  
   → 配置认证流程

🔹 Security：管"谁能访问"
   → 配置访问权限
```

---

## 5. 👥 客户端配置与注册



### 5.1 客户端概念理解



**🔸 什么是客户端**
```
客户端(Client)不是指用户，而是指应用程序：

🌟 生活场景类比：
银行系统中：
• 用户：你(张三)
• 客户端：手机银行APP、网上银行、ATM机
• 资源：你的账户余额

OAuth2系统中：
• 用户：实际使用的人
• 客户端：前端应用、移动APP、第三方系统
• 资源：用户数据、API接口
```

### 5.2 内存方式配置客户端



**📝 基础配置示例**
```java
@Override
public void configure(ClientDetailsServiceConfigurer clients) 
    throws Exception {
    
    clients.inMemory()  // 使用内存存储（适合学习测试）
        .withClient("client-app")           // 客户端ID
        .secret("123456")                   // 客户端密钥
        .authorizedGrantTypes(              // 支持的授权模式
            "authorization_code",           // 授权码模式
            "password",                     // 密码模式
            "refresh_token"                 // 刷新令牌
        )
        .scopes("read", "write")            // 权限范围
        .accessTokenValiditySeconds(3600)   // 令牌有效期1小时
        .refreshTokenValiditySeconds(86400);// 刷新令牌24小时
}
```

**🔍 配置项详解**

| 配置项 | 说明 | 示例值 |
|-------|------|-------|
| **clientId** | 客户端唯一标识 | "client-app" |
| **secret** | 客户端密钥 | "123456" |
| **authorizedGrantTypes** | 授权模式 | password、authorization_code |
| **scopes** | 权限范围 | read、write、admin |
| **accessTokenValiditySeconds** | 访问令牌有效期(秒) | 3600 |
| **refreshTokenValiditySeconds** | 刷新令牌有效期(秒) | 86400 |

### 5.3 多客户端配置



**🔄 注册多个客户端**
```java
@Override
public void configure(ClientDetailsServiceConfigurer clients) 
    throws Exception {
    
    clients.inMemory()
        // 前端Web应用
        .withClient("web-client")
        .secret("{noop}web123")  // {noop}表示不加密
        .authorizedGrantTypes("authorization_code", "refresh_token")
        .scopes("read")
        .redirectUris("http://localhost:8081/callback")
        
        .and()  // 👈 连接下一个客户端配置
        
        // 移动APP
        .withClient("mobile-app")
        .secret("{noop}mobile123")
        .authorizedGrantTypes("password", "refresh_token")
        .scopes("read", "write")
        
        .and()
        
        // 管理后台
        .withClient("admin-client")
        .secret("{noop}admin123")
        .authorizedGrantTypes("client_credentials")
        .scopes("admin");
}
```

> 💡 **密码加密说明**：
> - `{noop}`：明文存储（仅用于测试）
> - `{bcrypt}`：使用BCrypt加密（生产环境推荐）
> - 实际项目应该从数据库读取客户端信息

### 5.4 数据库方式配置客户端



**💾 生产环境推荐方式**
```java
@Autowired
private DataSource dataSource;

@Override
public void configure(ClientDetailsServiceConfigurer clients) 
    throws Exception {
    
    clients.jdbc(dataSource);  // 从数据库读取客户端信息
}
```

**📊 客户端表结构（oauth_client_details）**
```sql
CREATE TABLE oauth_client_details (
    client_id VARCHAR(256) PRIMARY KEY,        -- 客户端ID
    client_secret VARCHAR(256),                -- 密钥
    scope VARCHAR(256),                        -- 权限范围
    authorized_grant_types VARCHAR(256),       -- 授权类型
    web_server_redirect_uri VARCHAR(256),      -- 回调地址
    access_token_validity INTEGER,             -- 令牌有效期
    refresh_token_validity INTEGER             -- 刷新令牌有效期
);
```

---

## 6. 🔐 认证端点配置



### 6.1 认证端点概念



**🔸 /oauth/authorize 端点作用**
```
认证端点(Authorization Endpoint)：用户授权的入口

🌟 工作流程：
1. 用户访问这个地址
2. 跳转到登录页面
3. 输入用户名密码
4. 确认授权权限
5. 返回授权码或令牌
```

### 6.2 端点配置详解



**⚙️ 端点配置代码**
```java
@Override
public void configure(AuthorizationServerEndpointsConfigurer endpoints) {
    
    endpoints
        // 配置认证管理器（必需）
        .authenticationManager(authenticationManager)
        
        // 配置用户服务（刷新令牌需要）
        .userDetailsService(userDetailsService)
        
        // 配置令牌存储方式
        .tokenStore(tokenStore())
        
        // 配置授权码服务
        .authorizationCodeServices(authorizationCodeServices());
}
```

**🔍 配置项说明**

```
authenticationManager：
• 作用：处理用户名密码认证
• 来源：从SecurityConfig中获取
• 必需性：密码模式必须配置

userDetailsService：
• 作用：加载用户信息
• 用途：刷新令牌时验证用户
• 必需性：使用refresh_token时需要

tokenStore：
• 作用：令牌的存储位置
• 选项：内存、Redis、数据库、JWT
• 推荐：生产环境用Redis或JWT
```

### 6.3 认证端点访问示例



**🌐 授权码模式访问流程**
```
步骤1：浏览器访问授权端点
GET http://localhost:8080/oauth/authorize?
    client_id=web-client&          # 客户端ID
    response_type=code&            # 返回授权码
    redirect_uri=http://xxx/callback&  # 回调地址
    scope=read                     # 权限范围

步骤2：用户登录并授权
→ 输入用户名密码
→ 确认授权范围

步骤3：重定向返回授权码
http://xxx/callback?code=AbCd123  # 授权码
```

---

## 7. 🎫 令牌端点配置



### 7.1 令牌端点概念



**🔸 /oauth/token 端点作用**
```
令牌端点(Token Endpoint)：获取访问令牌的地方

🎫 就像自动售票机：
1. 你投入钱币(提交凭证)
2. 机器验证金额(验证身份)
3. 吐出车票(发放令牌)
4. 凭票进站(访问资源)
```

### 7.2 令牌端点配置



**⚙️ 安全配置代码**
```java
@Override
public void configure(AuthorizationServerSecurityConfigurer security) {
    
    security
        // 允许客户端访问 /oauth/token_key（JWT密钥）
        .tokenKeyAccess("permitAll()")
        
        // 允许已认证客户端访问 /oauth/check_token
        .checkTokenAccess("isAuthenticated()")
        
        // 允许表单认证（客户端ID和密钥）
        .allowFormAuthenticationForClients();
}
```

**📋 配置说明表**

| 配置方法 | 作用 | 访问权限 |
|---------|------|---------|
| **tokenKeyAccess** | JWT公钥访问控制 | permitAll()全部开放 |
| **checkTokenAccess** | 令牌验证端点控制 | isAuthenticated()需认证 |
| **allowFormAuthenticationForClients** | 允许表单提交认证 | 客户端ID+密钥 |

### 7.3 令牌获取示例



**🔑 密码模式获取令牌**
```bash
# POST请求到令牌端点

POST http://localhost:8080/oauth/token

# 请求参数

grant_type=password          # 授权模式
username=admin              # 用户名
password=123456             # 密码
client_id=mobile-app        # 客户端ID
client_secret=mobile123     # 客户端密钥
scope=read                  # 权限范围
```

**📦 返回结果示例**
```json
{
    "access_token": "eyJhbGci...",     // 访问令牌
    "token_type": "bearer",            // 令牌类型
    "refresh_token": "eyJhbGci...",    // 刷新令牌
    "expires_in": 3599,                // 有效期(秒)
    "scope": "read"                    // 权限范围
}
```

### 7.4 刷新令牌使用



**🔄 令牌刷新流程**
```bash
# 使用refresh_token获取新令牌

POST http://localhost:8080/oauth/token

grant_type=refresh_token          # 刷新模式
refresh_token=eyJhbGci...        # 刷新令牌
client_id=mobile-app             # 客户端ID
client_secret=mobile123          # 客户端密钥
```

> 💡 **刷新令牌使用场景**：
> - 访问令牌过期但不想用户重新登录
> - 刷新令牌有效期通常比访问令牌长
> - 刷新后会得到新的访问令牌

---

## 8. 📋 核心要点总结



### 8.1 必须掌握的核心概念



```
🔸 授权服务器：负责认证用户、管理客户端、颁发令牌
🔸 @EnableAuthorizationServer：开启授权服务器功能的关键注解
🔸 客户端：不是用户，是接入的应用系统
🔸 认证端点：/oauth/authorize，用户登录授权的地方
🔸 令牌端点：/oauth/token，获取访问令牌的接口
```

### 8.2 关键理解要点



**🔹 授权服务器 vs 资源服务器**
```
授权服务器(Authorization Server)：
• 职责：验证身份、颁发令牌
• 类比：身份证办理中心
• 端点：/oauth/authorize、/oauth/token

资源服务器(Resource Server)：
• 职责：保护资源、验证令牌
• 类比：需要身份证才能办事的窗口
• 验证：检查令牌是否有效
```

**🔹 三大配置的作用**
```
ClientDetailsService：
→ 配置哪些客户端可以接入
→ 设置客户端权限和令牌有效期

Endpoints：
→ 配置认证流程和令牌存储
→ 连接认证管理器和用户服务

Security：
→ 配置端点的访问权限
→ 控制谁能访问哪些端点
```

### 8.3 实际应用价值



**🎯 应用场景**

**场景1：单点登录(SSO)**
```
一次登录，多处使用：
• 登录后台管理系统
• 自动登录其他子系统
• 统一的授权中心
```

**场景2：第三方接入**
```
让外部系统安全接入：
• 提供API给合作伙伴
• 控制访问权限范围
• 追踪接口调用情况
```

**场景3：移动APP认证**
```
安全的移动端认证：
• 用户名密码登录
• 获取访问令牌
• 令牌自动刷新
```

### 8.4 配置最佳实践



**✅ 生产环境建议**
```
客户端存储：
❌ 不要用内存存储
✅ 使用数据库存储客户端信息

密钥管理：
❌ 不要用明文密码({noop})
✅ 使用BCrypt加密({bcrypt})

令牌存储：
❌ 不要用内存TokenStore
✅ 使用Redis或JWT

令牌有效期：
• 访问令牌：30分钟 - 2小时
• 刷新令牌：1天 - 7天
• 根据安全要求调整
```

### 8.5 学习检查清单



- [ ] 理解授权服务器的作用
- [ ] 能配置@EnableAuthorizationServer
- [ ] 掌握客户端注册方法
- [ ] 了解认证端点的作用
- [ ] 会使用令牌端点获取token
- [ ] 理解刷新令牌的使用场景

**🔑 核心记忆**
```
授权服务器三件事：
1. 管理客户端 - 谁能来
2. 认证用户 - 验身份  
3. 颁发令牌 - 发凭证

两个关键端点：
• /oauth/authorize - 授权入口
• /oauth/token - 令牌获取
```

**💡 下一步学习**
- 深入了解JWT令牌
- 学习资源服务器配置
- 掌握令牌存储方案
- 研究安全加固策略