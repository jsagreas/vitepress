---
title: 1ã€ç”µå•†ç³»ç»Ÿå®‰å…¨æ¶æ„æ¡ˆä¾‹
---
## ğŸ“š ç›®å½•

1. [ç”µå•†ç³»ç»Ÿå®‰å…¨æ¶æ„æ¦‚è¿°](#1-ç”µå•†ç³»ç»Ÿå®‰å…¨æ¶æ„æ¦‚è¿°)
2. [ç”¨æˆ·æ³¨å†Œç™»å½•æµç¨‹](#2-ç”¨æˆ·æ³¨å†Œç™»å½•æµç¨‹)
3. [è´­ç‰©è½¦æƒé™éªŒè¯](#3-è´­ç‰©è½¦æƒé™éªŒè¯)
4. [è®¢å•æƒé™æ ¡éªŒ](#4-è®¢å•æƒé™æ ¡éªŒ)
5. [æ”¯ä»˜å®‰å…¨é˜²æŠ¤](#5-æ”¯ä»˜å®‰å…¨é˜²æŠ¤)
6. [å•†å“ç®¡ç†æƒé™](#6-å•†å“ç®¡ç†æƒé™)
7. [æ•°æ®æƒé™éš”ç¦»](#7-æ•°æ®æƒé™éš”ç¦»)
8. [å¤šè§’è‰²æƒé™è®¾è®¡](#8-å¤šè§’è‰²æƒé™è®¾è®¡)
9. [å®‰å…¨æ¶æ„è®¾è®¡](#9-å®‰å…¨æ¶æ„è®¾è®¡)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ—ï¸ ç”µå•†ç³»ç»Ÿå®‰å…¨æ¶æ„æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯ç”µå•†ç³»ç»Ÿå®‰å…¨æ¶æ„


**é€šä¿—ç†è§£**ï¼šå°±åƒå•†åœºéœ€è¦ä¿å®‰ã€æ”¶é“¶ã€ä»“åº“ç®¡ç†ç­‰å²—ä½æ¥ä¿éšœå®‰å…¨ä¸€æ ·ï¼Œç”µå•†ç³»ç»Ÿä¹Ÿéœ€è¦ä¸€å¥—å®Œæ•´çš„"å®‰å…¨ç®¡ç†ä½“ç³»"ã€‚

```
ç°å®å•†åœºçš„å®‰å…¨ç®¡ç†ï¼š                ç”µå•†ç³»ç»Ÿçš„å®‰å…¨ç®¡ç†ï¼š
         
é¡¾å®¢å…¥å£ â†’ ä¼šå‘˜å¡éªŒè¯             ç”¨æˆ· â†’ ç™»å½•è®¤è¯
è´­ç‰©åŒº â†’ æµè§ˆå•†å“                  å•†å“æµè§ˆ â†’ å…¬å¼€è®¿é—®
æ”¶é“¶å° â†’ æ”¯ä»˜éªŒè¯                  ä¸‹å•æ”¯ä»˜ â†’ æƒé™æ ¡éªŒ
ä»“åº“åŒº â†’ å‘˜å·¥ä¸“å±                  åå°ç®¡ç† â†’ è§’è‰²æƒé™
```

**æ ¸å¿ƒç›®æ ‡**ï¼š
- ğŸ” **ä¿æŠ¤ç”¨æˆ·æ•°æ®**ï¼šç”¨æˆ·ä¿¡æ¯ã€è®¢å•è®°å½•ä¸è¢«æ³„éœ²
- ğŸ’° **ä¿éšœäº¤æ˜“å®‰å…¨**ï¼šæ”¯ä»˜æµç¨‹å®‰å…¨å¯é 
- ğŸ›¡ï¸ **é˜²æ­¢æ¶æ„æ”»å‡»**ï¼šé˜²æ­¢åˆ·å•ã€ç›—å·ç­‰è¡Œä¸º
- ğŸ‘¥ **æƒé™ç²¾å‡†æ§åˆ¶**ï¼šä¸åŒç”¨æˆ·çœ‹åˆ°ä¸åŒåŠŸèƒ½

### 1.2 ç”µå•†ç³»ç»Ÿçš„å®‰å…¨æŒ‘æˆ˜


**ä¸ºä»€ä¹ˆç”µå•†ç³»ç»Ÿå®‰å…¨ç‰¹åˆ«é‡è¦ï¼Ÿ**

```
æ™®é€šç³»ç»Ÿ vs ç”µå•†ç³»ç»Ÿçš„åŒºåˆ«ï¼š

åšå®¢ç³»ç»Ÿï¼š
- æ•°æ®æ•æ„Ÿåº¦ï¼šä½ï¼ˆæ–‡ç« ã€è¯„è®ºï¼‰
- èµ„é‡‘é£é™©ï¼šæ— 
- ç”¨æˆ·éšç§ï¼šä¸€èˆ¬

ç”µå•†ç³»ç»Ÿï¼š
- æ•°æ®æ•æ„Ÿåº¦ï¼šé«˜ï¼ˆè®¢å•ã€åœ°å€ã€æ”¯ä»˜ä¿¡æ¯ï¼‰
- èµ„é‡‘é£é™©ï¼šé«˜ï¼ˆæ¶‰åŠçœŸå®äº¤æ˜“ï¼‰
- ç”¨æˆ·éšç§ï¼šæé«˜ï¼ˆä¸ªäººä¿¡æ¯ã€è´­ä¹°è®°å½•ï¼‰
```

**å¸¸è§å®‰å…¨é£é™©**ï¼š
- âš ï¸ è´¦å·è¢«ç›—åˆ·
- âš ï¸ è®¢å•ä¿¡æ¯æ³„éœ²
- âš ï¸ æ¶æ„åˆ·å•
- âš ï¸ æ”¯ä»˜æ¼æ´
- âš ï¸ è¶Šæƒè®¿é—®ä»–äººæ•°æ®

### 1.3 æ•´ä½“æ¶æ„å›¾


```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·ç«¯åº”ç”¨                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚   â”‚ å•†åŸAPP  â”‚  â”‚  ç½‘é¡µç‰ˆ  â”‚  â”‚ å°ç¨‹åº  â”‚             â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  APIç½‘å…³å±‚                            â”‚
â”‚   - JWTä»¤ç‰ŒéªŒè¯                                       â”‚
â”‚   - è¯·æ±‚é™æµ                                          â”‚
â”‚   - é»‘åå•è¿‡æ»¤                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  å¾®æœåŠ¡å±‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ç”¨æˆ·æœåŠ¡   â”‚  â”‚è®¢å•æœåŠ¡   â”‚  â”‚æ”¯ä»˜æœåŠ¡   â”‚          â”‚
â”‚  â”‚(Security)â”‚  â”‚(Security)â”‚  â”‚(Security)â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚å•†å“æœåŠ¡   â”‚  â”‚è´­ç‰©è½¦    â”‚  â”‚åå°ç®¡ç†   â”‚          â”‚
â”‚  â”‚(Security)â”‚  â”‚(Security)â”‚  â”‚(Security)â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  æ•°æ®å±‚                               â”‚
â”‚   - ç”¨æˆ·è¡¨ï¼ˆåŠ å¯†å­˜å‚¨ï¼‰                                â”‚
â”‚   - æƒé™è¡¨ï¼ˆè§’è‰²+æƒé™ï¼‰                               â”‚
â”‚   - è®¢å•è¡¨ï¼ˆæ•°æ®éš”ç¦»ï¼‰                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸ‘¤ ç”¨æˆ·æ³¨å†Œç™»å½•æµç¨‹


### 2.1 æ³¨å†Œæµç¨‹è®¾è®¡


**æ³¨å†Œæµç¨‹å°±åƒåŠä¼šå‘˜å¡**ï¼šéœ€è¦å¡«å†™ä¿¡æ¯ã€éªŒè¯èº«ä»½ã€è·å¾—å‡­è¯ã€‚

```
ç”¨æˆ·æ³¨å†Œæµç¨‹ï¼š

ç”¨æˆ·å¡«å†™ä¿¡æ¯ â†’ åç«¯éªŒè¯ â†’ å¯†ç åŠ å¯† â†’ å­˜å…¥æ•°æ®åº“ â†’ è¿”å›æˆåŠŸ
    â†“            â†“          â†“           â†“           â†“
  æ‰‹æœºå·      æ ¼å¼æ ¡éªŒ    BCrypt      ç”¨æˆ·è®°å½•    è‡ªåŠ¨ç™»å½•
  å¯†ç         é‡å¤æ£€æµ‹    åŠ å¯†å­˜å‚¨    æƒé™åˆå§‹åŒ–   å‘æ”¾ä»¤ç‰Œ
  éªŒè¯ç       éªŒè¯ç éªŒè¯
```

**æ ¸å¿ƒå®‰å…¨æªæ–½**ï¼š

| å®‰å…¨ç‚¹ | **å®ç°æ–¹å¼** | **ä½œç”¨** |
|--------|------------|----------|
| ğŸ” **å¯†ç åŠ å¯†** | `BCryptç®—æ³•` | å³ä½¿æ•°æ®åº“æ³„éœ²ï¼Œå¯†ç ä¹Ÿæ— æ³•ç ´è§£ |
| ğŸ“± **æ‰‹æœºéªŒè¯** | `çŸ­ä¿¡éªŒè¯ç ` | ç¡®ä¿æ‰‹æœºå·çœŸå®æœ‰æ•ˆ |
| ğŸš« **é˜²æ­¢é‡å¤** | `å”¯ä¸€ç´¢å¼•` | åŒä¸€æ‰‹æœºå·ä¸èƒ½é‡å¤æ³¨å†Œ |
| ğŸ”’ **å¯†ç å¼ºåº¦** | `æ­£åˆ™æ ¡éªŒ` | è‡³å°‘8ä½ï¼ŒåŒ…å«å­—æ¯æ•°å­— |

**æ³¨å†Œæ¥å£å®ç°**ï¼š

```java
@RestController
@RequestMapping("/api/auth")
public class AuthController {
    
    @Autowired
    private UserService userService;
    
    // ç”¨æˆ·æ³¨å†Œæ¥å£
    @PostMapping("/register")
    public Result register(@RequestBody RegisterDTO dto) {
        // 1. éªŒè¯ç æ ¡éªŒ
        if (!smsService.verify(dto.getPhone(), dto.getCode())) {
            return Result.error("éªŒè¯ç é”™è¯¯");
        }
        
        // 2. æ£€æŸ¥æ‰‹æœºå·æ˜¯å¦å·²æ³¨å†Œ
        if (userService.existsByPhone(dto.getPhone())) {
            return Result.error("æ‰‹æœºå·å·²æ³¨å†Œ");
        }
        
        // 3. å¯†ç åŠ å¯†å­˜å‚¨
        String encodedPassword = passwordEncoder.encode(dto.getPassword());
        
        // 4. åˆ›å»ºç”¨æˆ·
        User user = new User();
        user.setPhone(dto.getPhone());
        user.setPassword(encodedPassword);
        user.setRole("USER"); // é»˜è®¤æ™®é€šç”¨æˆ·è§’è‰²
        userService.save(user);
        
        return Result.success("æ³¨å†ŒæˆåŠŸ");
    }
}
```

### 2.2 ç™»å½•æµç¨‹è®¾è®¡


**ç™»å½•æµç¨‹å°±åƒåˆ·ä¼šå‘˜å¡**ï¼šéªŒè¯èº«ä»½åè·å¾—é€šè¡Œè¯ã€‚

```
ç”¨æˆ·ç™»å½•æµç¨‹ï¼š

è¾“å…¥è´¦å·å¯†ç  â†’ æ•°æ®åº“æŸ¥è¯¢ â†’ å¯†ç æ¯”å¯¹ â†’ ç”ŸæˆJWTä»¤ç‰Œ â†’ è¿”å›å®¢æˆ·ç«¯
    â†“            â†“           â†“           â†“            â†“
  æ‰‹æœº/é‚®ç®±    æ ¹æ®è´¦å·     BCrypt      åŒ…å«ç”¨æˆ·ä¿¡æ¯   å­˜å‚¨åˆ°æœ¬åœ°
  å¯†ç          æŸ¥ç”¨æˆ·       éªŒè¯å¯†ç     å’Œæƒé™ä¿¡æ¯     åç»­æºå¸¦è®¿é—®
```

**JWTä»¤ç‰Œå†…å®¹**ï¼š

```json
{
  "userId": "10001",
  "username": "å¼ ä¸‰",
  "roles": ["USER"],
  "permissions": ["order:view", "cart:manage"],
  "exp": 1698765432  // è¿‡æœŸæ—¶é—´
}
```

**ç™»å½•æ¥å£å®ç°**ï¼š

```java
@PostMapping("/login")
public Result login(@RequestBody LoginDTO dto) {
    // 1. æ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ·
    User user = userService.findByPhone(dto.getPhone());
    if (user == null) {
        return Result.error("ç”¨æˆ·ä¸å­˜åœ¨");
    }
    
    // 2. éªŒè¯å¯†ç 
    if (!passwordEncoder.matches(dto.getPassword(), user.getPassword())) {
        return Result.error("å¯†ç é”™è¯¯");
    }
    
    // 3. ç”ŸæˆJWTä»¤ç‰Œ
    String token = jwtUtils.generateToken(user);
    
    // 4. è¿”å›ä»¤ç‰Œå’Œç”¨æˆ·ä¿¡æ¯
    Map<String, Object> data = new HashMap<>();
    data.put("token", token);
    data.put("userInfo", user.toVO()); // ä¸åŒ…å«æ•æ„Ÿä¿¡æ¯
    
    return Result.success(data);
}
```

### 2.3 å¯†ç å®‰å…¨å¤„ç†


**ä¸ºä»€ä¹ˆä¸èƒ½æ˜æ–‡å­˜å‚¨å¯†ç ï¼Ÿ**

```
âŒ æ˜æ–‡å­˜å‚¨çš„é£é™©ï¼š
æ•°æ®åº“ï¼š123456
åæœï¼šæ•°æ®åº“ä¸€æ—¦æ³„éœ²ï¼Œæ‰€æœ‰ç”¨æˆ·å¯†ç æš´éœ²

âœ… åŠ å¯†å­˜å‚¨çš„å®‰å…¨ï¼š
æ•°æ®åº“ï¼š$2a$10$XYZ...ï¼ˆBCryptåŠ å¯†åï¼‰
åæœï¼šå³ä½¿æ³„éœ²ä¹Ÿæ— æ³•è¿˜åŸåŸå§‹å¯†ç 
```

**BCryptåŠ å¯†é…ç½®**ï¼š

```java
@Configuration
public class SecurityConfig {
    
    @Bean
    public PasswordEncoder passwordEncoder() {
        // BCryptæ˜¯å•å‘åŠ å¯†ï¼Œæ— æ³•è§£å¯†
        // æ¯æ¬¡åŠ å¯†ç»“æœéƒ½ä¸åŒï¼Œä½†éªŒè¯ç»“æœä¸€è‡´
        return new BCryptPasswordEncoder();
    }
}
```

---

## 3. ğŸ›’ è´­ç‰©è½¦æƒé™éªŒè¯


### 3.1 è´­ç‰©è½¦çš„æƒé™ç‰¹ç‚¹


**è´­ç‰©è½¦æ˜¯ç”¨æˆ·çš„ç§æœ‰ç©ºé—´**ï¼šå°±åƒè¶…å¸‚é‡Œæ¯ä¸ªäººéƒ½æœ‰è‡ªå·±çš„è´­ç‰©ç¯®ï¼Œä¸èƒ½çœ‹åˆ°åˆ«äººçš„ã€‚

```
è´­ç‰©è½¦æƒé™è§„åˆ™ï¼š

âœ… ç”¨æˆ·Aç™»å½• â†’ åªèƒ½çœ‹åˆ°Açš„è´­ç‰©è½¦
âœ… ç”¨æˆ·Bç™»å½• â†’ åªèƒ½çœ‹åˆ°Bçš„è´­ç‰©è½¦
âŒ æœªç™»å½•ç”¨æˆ· â†’ æ— æ³•è®¿é—®è´­ç‰©è½¦
âŒ æ¶æ„ä¿®æ”¹ID â†’ æ— æ³•è®¿é—®ä»–äººè´­ç‰©è½¦
```

### 3.2 è´­ç‰©è½¦æ¥å£æƒé™æ§åˆ¶


**å¦‚ä½•ä¿è¯ç”¨æˆ·åªèƒ½æ“ä½œè‡ªå·±çš„è´­ç‰©è½¦ï¼Ÿ**

```java
@RestController
@RequestMapping("/api/cart")
public class CartController {
    
    @Autowired
    private CartService cartService;
    
    // æŸ¥çœ‹è´­ç‰©è½¦ - å¿…é¡»ç™»å½•
    @GetMapping("/list")
    public Result getCartList() {
        // 1. ä»ä»¤ç‰Œä¸­è·å–å½“å‰ç”¨æˆ·IDï¼ˆSpring Securityè‡ªåŠ¨æ³¨å…¥ï¼‰
        Long userId = SecurityUtils.getCurrentUserId();
        
        // 2. åªæŸ¥è¯¢å½“å‰ç”¨æˆ·çš„è´­ç‰©è½¦
        List<CartItem> items = cartService.findByUserId(userId);
        
        return Result.success(items);
    }
    
    // æ·»åŠ åˆ°è´­ç‰©è½¦
    @PostMapping("/add")
    public Result addToCart(@RequestBody AddCartDTO dto) {
        Long userId = SecurityUtils.getCurrentUserId();
        
        // è‡ªåŠ¨å…³è”å½“å‰ç”¨æˆ·ID
        CartItem item = new CartItem();
        item.setUserId(userId);
        item.setProductId(dto.getProductId());
        item.setQuantity(dto.getQuantity());
        
        cartService.save(item);
        return Result.success("æ·»åŠ æˆåŠŸ");
    }
    
    // åˆ é™¤è´­ç‰©è½¦å•†å“
    @DeleteMapping("/{itemId}")
    public Result removeItem(@PathVariable Long itemId) {
        Long userId = SecurityUtils.getCurrentUserId();
        
        // å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿è¯¥å•†å“å±äºå½“å‰ç”¨æˆ·
        CartItem item = cartService.findById(itemId);
        if (item == null || !item.getUserId().equals(userId)) {
            return Result.error("æ— æƒæ“ä½œ");
        }
        
        cartService.deleteById(itemId);
        return Result.success("åˆ é™¤æˆåŠŸ");
    }
}
```

### 3.3 é˜²æ­¢è¶Šæƒè®¿é—®


**ä»€ä¹ˆæ˜¯è¶Šæƒè®¿é—®ï¼Ÿ**

> ğŸ’¡ **ä¸¾ä¾‹è¯´æ˜**ï¼šç”¨æˆ·Aé€šè¿‡ä¿®æ”¹è¯·æ±‚å‚æ•°ï¼Œè¯•å›¾è®¿é—®ç”¨æˆ·Bçš„è´­ç‰©è½¦æ•°æ®ã€‚

**é˜²æŠ¤æªæ–½**ï¼š

```java
@Service
public class CartService {
    
    // âŒ ä¸å®‰å…¨çš„å†™æ³• - ç›´æ¥ä½¿ç”¨å‰ç«¯ä¼ æ¥çš„userId
    public List<CartItem> findByUserId(Long userId) {
        return cartMapper.selectByUserId(userId);
    }
    
    // âœ… å®‰å…¨çš„å†™æ³• - ä»JWTä»¤ç‰Œä¸­è·å–çœŸå®userId
    public List<CartItem> getMyCart() {
        Long realUserId = SecurityUtils.getCurrentUserId();
        return cartMapper.selectByUserId(realUserId);
    }
}
```

**æ•°æ®åº“å±‚é¢çš„ä¿éšœ**ï¼š

```sql
-- è´­ç‰©è½¦è¡¨è®¾è®¡
CREATE TABLE cart (
    id BIGINT PRIMARY KEY,
    user_id BIGINT NOT NULL,  -- ç”¨æˆ·IDï¼Œå…³é”®å­—æ®µ
    product_id BIGINT NOT NULL,
    quantity INT NOT NULL,
    create_time DATETIME,
    INDEX idx_user_id (user_id)  -- ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
);

-- æŸ¥è¯¢æ—¶å¿…é¡»å¸¦ä¸Šuser_idæ¡ä»¶
SELECT * FROM cart WHERE user_id = #{currentUserId};
```

---

## 4. ğŸ“‹ è®¢å•æƒé™æ ¡éªŒ


### 4.1 è®¢å•çš„æ•æ„Ÿæ€§


**è®¢å•æ•°æ®æ˜¯ç”µå•†ç³»ç»Ÿçš„æ ¸å¿ƒèµ„äº§**ï¼š

```
è®¢å•åŒ…å«çš„æ•æ„Ÿä¿¡æ¯ï¼š
â”œâ”€â”€ ä¸ªäººä¿¡æ¯ï¼ˆå§“åã€ç”µè¯ã€åœ°å€ï¼‰
â”œâ”€â”€ è´­ä¹°è®°å½•ï¼ˆè´­ä¹°ä»€ä¹ˆã€èŠ±äº†å¤šå°‘é’±ï¼‰
â”œâ”€â”€ æ”¯ä»˜ä¿¡æ¯ï¼ˆæ”¯ä»˜æ–¹å¼ã€äº¤æ˜“æµæ°´ï¼‰
â””â”€â”€ ç‰©æµä¿¡æ¯ï¼ˆé…é€çŠ¶æ€ã€ç‰©æµè½¨è¿¹ï¼‰

å®‰å…¨è¦æ±‚ï¼š
âœ… ç”¨æˆ·åªèƒ½çœ‹è‡ªå·±çš„è®¢å•
âœ… å•†å®¶åªèƒ½çœ‹è‡ªå·±åº—é“ºçš„è®¢å•
âœ… å®¢æœå¯ä»¥çœ‹æ‰€æœ‰è®¢å•ï¼ˆä½†éœ€å®¡è®¡ï¼‰
âœ… ç®¡ç†å‘˜å¯ä»¥çœ‹æ‰€æœ‰è®¢å•ï¼ˆæœ‰æƒé™æ§åˆ¶ï¼‰
```

### 4.2 è®¢å•æƒé™æ§åˆ¶å®ç°


**æ ¸å¿ƒåŸåˆ™**ï¼šæ‰€æœ‰è®¢å•æ“ä½œéƒ½è¦éªŒè¯"è¿™ä¸ªè®¢å•æ˜¯å¦å±äºå½“å‰ç”¨æˆ·"ã€‚

```java
@RestController
@RequestMapping("/api/order")
public class OrderController {
    
    @Autowired
    private OrderService orderService;
    
    // æŸ¥çœ‹æˆ‘çš„è®¢å•åˆ—è¡¨
    @GetMapping("/my-orders")
    public Result getMyOrders() {
        Long userId = SecurityUtils.getCurrentUserId();
        List<Order> orders = orderService.findByUserId(userId);
        return Result.success(orders);
    }
    
    // æŸ¥çœ‹è®¢å•è¯¦æƒ… - é‡ç‚¹ï¼šæƒé™æ ¡éªŒ
    @GetMapping("/{orderId}")
    public Result getOrderDetail(@PathVariable Long orderId) {
        Long userId = SecurityUtils.getCurrentUserId();
        
        // 1. æŸ¥è¯¢è®¢å•
        Order order = orderService.findById(orderId);
        if (order == null) {
            return Result.error("è®¢å•ä¸å­˜åœ¨");
        }
        
        // 2. æƒé™æ ¡éªŒï¼šè®¢å•å¿…é¡»å±äºå½“å‰ç”¨æˆ·
        if (!order.getUserId().equals(userId)) {
            return Result.error("æ— æƒæŸ¥çœ‹è¯¥è®¢å•");
        }
        
        return Result.success(order);
    }
    
    // å–æ¶ˆè®¢å•
    @PutMapping("/{orderId}/cancel")
    public Result cancelOrder(@PathVariable Long orderId) {
        Long userId = SecurityUtils.getCurrentUserId();
        
        // æƒé™+ä¸šåŠ¡åŒé‡æ ¡éªŒ
        Order order = orderService.findById(orderId);
        
        // æ ¡éªŒ1ï¼šè®¢å•å½’å±
        if (!order.getUserId().equals(userId)) {
            return Result.error("æ— æƒæ“ä½œ");
        }
        
        // æ ¡éªŒ2ï¼šè®¢å•çŠ¶æ€ï¼ˆåªæœ‰å¾…æ”¯ä»˜çš„è®¢å•å¯ä»¥å–æ¶ˆï¼‰
        if (!"PENDING".equals(order.getStatus())) {
            return Result.error("è¯¥çŠ¶æ€è®¢å•ä¸å¯å–æ¶ˆ");
        }
        
        orderService.cancel(orderId);
        return Result.success("å–æ¶ˆæˆåŠŸ");
    }
}
```

### 4.3 è®¢å•çŠ¶æ€æµè½¬æ§åˆ¶


**è®¢å•çŠ¶æ€å°±åƒå¿«é€’çš„ä¸åŒé˜¶æ®µ**ï¼š

```
è®¢å•çŠ¶æ€æµè½¬å›¾ï¼š

å¾…æ”¯ä»˜(PENDING) â†’ å·²æ”¯ä»˜(PAID) â†’ å·²å‘è´§(SHIPPED) â†’ å·²å®Œæˆ(COMPLETED)
     â†“                                                        
   å·²å–æ¶ˆ(CANCELLED)

æƒé™æ§åˆ¶è§„åˆ™ï¼š
- å¾…æ”¯ä»˜ï¼šç”¨æˆ·å¯å–æ¶ˆ
- å·²æ”¯ä»˜ï¼šç”¨æˆ·ä¸å¯å–æ¶ˆï¼Œå•†å®¶å¯å‘è´§
- å·²å‘è´§ï¼šç”¨æˆ·å¯ç¡®è®¤æ”¶è´§
- å·²å®Œæˆï¼šç”¨æˆ·å¯è¯„ä»·
```

**çŠ¶æ€æ§åˆ¶å®ç°**ï¼š

```java
@Service
public class OrderService {
    
    // å–æ¶ˆè®¢å• - çŠ¶æ€æ ¡éªŒ
    public void cancel(Long orderId) {
        Order order = orderMapper.selectById(orderId);
        
        // åªæœ‰å¾…æ”¯ä»˜çŠ¶æ€å¯ä»¥å–æ¶ˆ
        if (!"PENDING".equals(order.getStatus())) {
            throw new BusinessException("å½“å‰çŠ¶æ€ä¸å¯å–æ¶ˆ");
        }
        
        order.setStatus("CANCELLED");
        orderMapper.updateById(order);
    }
    
    // å•†å®¶å‘è´§ - è§’è‰²+çŠ¶æ€æ ¡éªŒ
    @PreAuthorize("hasRole('SELLER')")
    public void ship(Long orderId) {
        Order order = orderMapper.selectById(orderId);
        
        // åªæœ‰å·²æ”¯ä»˜çŠ¶æ€å¯ä»¥å‘è´§
        if (!"PAID".equals(order.getStatus())) {
            throw new BusinessException("è®¢å•æœªæ”¯ä»˜");
        }
        
        order.setStatus("SHIPPED");
        orderMapper.updateById(order);
    }
}
```

---

## 5. ğŸ’³ æ”¯ä»˜å®‰å…¨é˜²æŠ¤


### 5.1 æ”¯ä»˜æµç¨‹çš„å®‰å…¨è¦ç‚¹


**æ”¯ä»˜æ˜¯ç”µå•†ç³»ç»Ÿæœ€æ•æ„Ÿçš„ç¯èŠ‚**ï¼š

```
æ”¯ä»˜å®‰å…¨ä¸‰è¦ç´ ï¼š

1. é‡‘é¢æ ¡éªŒ     2. é˜²é‡å¤æ”¯ä»˜    3. æ”¯ä»˜éªŒè¯
   â†“               â†“               â†“
è®¢å•é‡‘é¢      è®¢å•çŠ¶æ€é”å®š      ç¬¬ä¸‰æ–¹å›è°ƒ
å¿…é¡»ä¸€è‡´      é˜²æ­¢å¹¶å‘é‡å¤      ç­¾åéªŒè¯
```

**æ”¯ä»˜æµç¨‹å›¾**ï¼š

```
ç”¨æˆ·ç«¯                 åç«¯ç³»ç»Ÿ              æ”¯ä»˜å¹³å°
  |                      |                     |
  |--[1]å‘èµ·æ”¯ä»˜-------->|                     |
  |   (è®¢å•ID)           |--[2]åˆ›å»ºæ”¯ä»˜å•----->|
  |                      |   (è®¢å•å·+é‡‘é¢)     |
  |                      |                     |
  |<-[3]æ”¯ä»˜é¡µé¢URL------|<--[4]è¿”å›æ”¯ä»˜é“¾æ¥---|
  |                      |                     |
  |--[5]å®Œæˆæ”¯ä»˜-------->|                     |
  |                      |                     |
  |                      |<--[6]æ”¯ä»˜å›è°ƒ-------|
  |                      |   (ç­¾åéªŒè¯)        |
  |                      |--[7]æ›´æ–°è®¢å•çŠ¶æ€    |
  |                      |                     |
  |<-[8]æ”¯ä»˜æˆåŠŸé€šçŸ¥-----|                     |
```

### 5.2 æ”¯ä»˜æ¥å£å®‰å…¨å®ç°


**æ ¸å¿ƒï¼šéªŒè¯é‡‘é¢ã€é˜²æ­¢ç¯¡æ”¹ã€é˜²é‡å¤æ”¯ä»˜**

```java
@RestController
@RequestMapping("/api/payment")
public class PaymentController {
    
    @Autowired
    private OrderService orderService;
    @Autowired
    private PaymentService paymentService;
    
    // åˆ›å»ºæ”¯ä»˜è®¢å•
    @PostMapping("/create")
    public Result createPayment(@RequestBody PaymentDTO dto) {
        Long userId = SecurityUtils.getCurrentUserId();
        
        // 1. æŸ¥è¯¢è®¢å•
        Order order = orderService.findById(dto.getOrderId());
        if (order == null) {
            return Result.error("è®¢å•ä¸å­˜åœ¨");
        }
        
        // 2. æƒé™æ ¡éªŒ
        if (!order.getUserId().equals(userId)) {
            return Result.error("æ— æƒæ“ä½œ");
        }
        
        // 3. çŠ¶æ€æ ¡éªŒï¼ˆé˜²æ­¢é‡å¤æ”¯ä»˜ï¼‰
        if (!"PENDING".equals(order.getStatus())) {
            return Result.error("è®¢å•çŠ¶æ€å¼‚å¸¸");
        }
        
        // 4. é‡‘é¢æ ¡éªŒï¼ˆå…³é”®ï¼ï¼‰
        if (!order.getTotalAmount().equals(dto.getAmount())) {
            return Result.error("é‡‘é¢å¼‚å¸¸");
        }
        
        // 5. è°ƒç”¨ç¬¬ä¸‰æ–¹æ”¯ä»˜
        String payUrl = paymentService.createPayment(order);
        
        return Result.success(payUrl);
    }
    
    // æ”¯ä»˜å›è°ƒæ¥å£ï¼ˆç¬¬ä¸‰æ–¹è°ƒç”¨ï¼‰
    @PostMapping("/callback")
    public String paymentCallback(@RequestBody Map<String, String> params) {
        // 1. éªŒè¯ç­¾åï¼ˆé˜²æ­¢ä¼ªé€ å›è°ƒï¼‰
        if (!paymentService.verifySign(params)) {
            return "FAIL";
        }
        
        String orderNo = params.get("orderNo");
        String amount = params.get("amount");
        
        // 2. æŸ¥è¯¢è®¢å•
        Order order = orderService.findByOrderNo(orderNo);
        
        // 3. é‡‘é¢äºŒæ¬¡æ ¡éªŒ
        if (!order.getTotalAmount().toString().equals(amount)) {
            return "FAIL";
        }
        
        // 4. å¹‚ç­‰æ€§å¤„ç†ï¼ˆé˜²æ­¢é‡å¤å›è°ƒï¼‰
        if ("PAID".equals(order.getStatus())) {
            return "SUCCESS"; // å·²å¤„ç†è¿‡ï¼Œç›´æ¥è¿”å›æˆåŠŸ
        }
        
        // 5. æ›´æ–°è®¢å•çŠ¶æ€
        orderService.updateStatus(order.getId(), "PAID");
        
        return "SUCCESS";
    }
}
```

### 5.3 æ”¯ä»˜å®‰å…¨é˜²æŠ¤æªæ–½


**äº”å±‚é˜²æŠ¤ä½“ç³»**ï¼š

| é˜²æŠ¤å±‚ | **æªæ–½** | **ä½œç”¨** |
|--------|---------|---------|
| 1ï¸âƒ£ **é‡‘é¢æ ¡éªŒ** | `å‰ç«¯é‡‘é¢ == åç«¯é‡‘é¢ == æ”¯ä»˜é‡‘é¢` | é˜²æ­¢é‡‘é¢ç¯¡æ”¹ |
| 2ï¸âƒ£ **ç­¾åéªŒè¯** | `éªŒè¯ç¬¬ä¸‰æ–¹å›è°ƒç­¾å` | é˜²æ­¢ä¼ªé€ å›è°ƒ |
| 3ï¸âƒ£ **çŠ¶æ€é”å®š** | `æ”¯ä»˜ä¸­é”å®šè®¢å•çŠ¶æ€` | é˜²æ­¢é‡å¤æ”¯ä»˜ |
| 4ï¸âƒ£ **å¹‚ç­‰å¤„ç†** | `åŒä¸€è®¢å•å¤šæ¬¡å›è°ƒåªå¤„ç†ä¸€æ¬¡` | é˜²æ­¢é‡å¤æ‰£æ¬¾ |
| 5ï¸âƒ£ **æ—¥å¿—è®°å½•** | `è®°å½•æ‰€æœ‰æ”¯ä»˜æ“ä½œ` | ä¾¿äºè¿½æº¯é—®é¢˜ |

**å…³é”®ä»£ç ç¤ºä¾‹**ï¼š

```java
@Service
public class PaymentService {
    
    // ç­¾åéªŒè¯
    public boolean verifySign(Map<String, String> params) {
        String sign = params.get("sign");
        String calculatedSign = calculateSign(params);
        return sign.equals(calculatedSign);
    }
    
    // å¹‚ç­‰æ€§å¤„ç†
    @Transactional
    public void processPayment(String orderNo) {
        // ä½¿ç”¨æ•°æ®åº“é”é˜²æ­¢å¹¶å‘
        Order order = orderMapper.selectForUpdate(orderNo);
        
        if ("PAID".equals(order.getStatus())) {
            return; // å·²å¤„ç†ï¼Œç›´æ¥è¿”å›
        }
        
        // æ›´æ–°çŠ¶æ€
        order.setStatus("PAID");
        order.setPayTime(new Date());
        orderMapper.updateById(order);
    }
}
```

---

## 6. ğŸ“¦ å•†å“ç®¡ç†æƒé™


### 6.1 å•†å“ç®¡ç†çš„è§’è‰²åˆ’åˆ†


**ä¸åŒè§’è‰²å¯¹å•†å“çš„æƒé™ä¸åŒ**ï¼š

```
è§’è‰²æƒé™çŸ©é˜µï¼š

          æŸ¥çœ‹å•†å“    æ·»åŠ å•†å“    ç¼–è¾‘å•†å“    åˆ é™¤å•†å“    ä¸Šä¸‹æ¶
æ™®é€šç”¨æˆ·    âœ…         âŒ         âŒ         âŒ        âŒ
å•†å®¶       âœ…         âœ…         âœ…         âœ…        âœ…
ç®¡ç†å‘˜     âœ…         âœ…         âœ…         âœ…        âœ…
```

### 6.2 å•†å“æ¥å£æƒé™æ§åˆ¶


**ä½¿ç”¨æ³¨è§£å£°æ˜å¼æƒé™æ§åˆ¶**ï¼š

```java
@RestController
@RequestMapping("/api/product")
public class ProductController {
    
    // æŸ¥çœ‹å•†å“ - æ‰€æœ‰äººå¯è®¿é—®
    @GetMapping("/{id}")
    public Result getProduct(@PathVariable Long id) {
        Product product = productService.findById(id);
        return Result.success(product);
    }
    
    // æ·»åŠ å•†å“ - éœ€è¦SELLERæˆ–ADMINè§’è‰²
    @PostMapping("/add")
    @PreAuthorize("hasAnyRole('SELLER', 'ADMIN')")
    public Result addProduct(@RequestBody ProductDTO dto) {
        Long sellerId = SecurityUtils.getCurrentUserId();
        
        Product product = new Product();
        product.setSellerId(sellerId); // å…³è”å•†å®¶
        product.setName(dto.getName());
        product.setPrice(dto.getPrice());
        
        productService.save(product);
        return Result.success("æ·»åŠ æˆåŠŸ");
    }
    
    // ç¼–è¾‘å•†å“ - åªèƒ½ç¼–è¾‘è‡ªå·±çš„å•†å“
    @PutMapping("/{id}")
    @PreAuthorize("hasAnyRole('SELLER', 'ADMIN')")
    public Result updateProduct(@PathVariable Long id, 
                                @RequestBody ProductDTO dto) {
        Long userId = SecurityUtils.getCurrentUserId();
        Product product = productService.findById(id);
        
        // æƒé™æ ¡éªŒï¼šå•†å®¶åªèƒ½ç¼–è¾‘è‡ªå·±çš„å•†å“
        if (!product.getSellerId().equals(userId) 
            && !SecurityUtils.hasRole("ADMIN")) {
            return Result.error("æ— æƒæ“ä½œ");
        }
        
        product.setName(dto.getName());
        product.setPrice(dto.getPrice());
        productService.update(product);
        
        return Result.success("æ›´æ–°æˆåŠŸ");
    }
    
    // åˆ é™¤å•†å“ - ç®¡ç†å‘˜æˆ–å•†å“æ‰€æœ‰è€…
    @DeleteMapping("/{id}")
    @PreAuthorize("hasAnyRole('SELLER', 'ADMIN')")
    public Result deleteProduct(@PathVariable Long id) {
        Long userId = SecurityUtils.getCurrentUserId();
        Product product = productService.findById(id);
        
        // å•†å®¶åªèƒ½åˆ é™¤è‡ªå·±çš„å•†å“ï¼Œç®¡ç†å‘˜å¯ä»¥åˆ é™¤ä»»ä½•å•†å“
        if (!product.getSellerId().equals(userId) 
            && !SecurityUtils.hasRole("ADMIN")) {
            return Result.error("æ— æƒæ“ä½œ");
        }
        
        productService.deleteById(id);
        return Result.success("åˆ é™¤æˆåŠŸ");
    }
}
```

### 6.3 å•†å“ä¸Šä¸‹æ¶æ§åˆ¶


**ä¸Šä¸‹æ¶æ˜¯å•†å“çŠ¶æ€ç®¡ç†çš„é‡è¦åŠŸèƒ½**ï¼š

```java
@Service
public class ProductService {
    
    // å•†å“ä¸Šæ¶
    @PreAuthorize("hasAnyRole('SELLER', 'ADMIN')")
    public void onSale(Long productId) {
        Product product = productMapper.selectById(productId);
        
        // å•†å“ä¿¡æ¯å®Œæ•´æ€§æ ¡éªŒ
        if (product.getPrice() == null || product.getStock() <= 0) {
            throw new BusinessException("å•†å“ä¿¡æ¯ä¸å®Œæ•´");
        }
        
        product.setStatus("ON_SALE");
        productMapper.updateById(product);
    }
    
    // å•†å“ä¸‹æ¶
    @PreAuthorize("hasAnyRole('SELLER', 'ADMIN')")
    public void offSale(Long productId) {
        Product product = productMapper.selectById(productId);
        product.setStatus("OFF_SALE");
        productMapper.updateById(product);
    }
}
```

---

## 7. ğŸ”’ æ•°æ®æƒé™éš”ç¦»


### 7.1 ä»€ä¹ˆæ˜¯æ•°æ®æƒé™éš”ç¦»


**é€šä¿—ç†è§£**ï¼šå°±åƒå…¬å¯“æ¥¼é‡Œæ¯å®¶æœ‰è‡ªå·±çš„é’¥åŒ™ï¼Œåªèƒ½è¿›è‡ªå·±å®¶é—¨ã€‚

```
æ•°æ®éš”ç¦»ç¤ºä¾‹ï¼š

å•†å®¶Aç™»å½•ï¼š
  â”œâ”€â”€ åªèƒ½çœ‹åˆ°è‡ªå·±åº—é“ºçš„å•†å“
  â”œâ”€â”€ åªèƒ½çœ‹åˆ°è‡ªå·±åº—é“ºçš„è®¢å•
  â””â”€â”€ ä¸èƒ½çœ‹åˆ°å•†å®¶Bçš„ä»»ä½•æ•°æ®

å•†å®¶Bç™»å½•ï¼š
  â”œâ”€â”€ åªèƒ½çœ‹åˆ°è‡ªå·±åº—é“ºçš„å•†å“
  â”œâ”€â”€ åªèƒ½çœ‹åˆ°è‡ªå·±åº—é“ºçš„è®¢å•
  â””â”€â”€ ä¸èƒ½çœ‹åˆ°å•†å®¶Açš„ä»»ä½•æ•°æ®
```

### 7.2 åŸºäºç”¨æˆ·IDçš„æ•°æ®éš”ç¦»


**æ ¸å¿ƒæ€è·¯**ï¼šæ‰€æœ‰æ•°æ®æŸ¥è¯¢éƒ½å¸¦ä¸Šå½“å‰ç”¨æˆ·IDæ¡ä»¶ã€‚

```java
@Service
public class OrderService {
    
    // æ™®é€šç”¨æˆ·æŸ¥è¯¢è‡ªå·±çš„è®¢å•
    public List<Order> getMyOrders() {
        Long userId = SecurityUtils.getCurrentUserId();
        return orderMapper.selectByUserId(userId);
    }
    
    // å•†å®¶æŸ¥è¯¢è‡ªå·±åº—é“ºçš„è®¢å•
    @PreAuthorize("hasRole('SELLER')")
    public List<Order> getShopOrders() {
        Long sellerId = SecurityUtils.getCurrentUserId();
        return orderMapper.selectBySellerId(sellerId);
    }
}
```

**æ•°æ®åº“æŸ¥è¯¢SQL**ï¼š

```sql
-- ç”¨æˆ·æŸ¥è¯¢è‡ªå·±çš„è®¢å•ï¼ˆè‡ªåŠ¨æ·»åŠ user_idæ¡ä»¶ï¼‰
SELECT * FROM `order` 
WHERE user_id = #{currentUserId}
ORDER BY create_time DESC;

-- å•†å®¶æŸ¥è¯¢è‡ªå·±åº—é“ºçš„è®¢å•ï¼ˆè‡ªåŠ¨æ·»åŠ seller_idæ¡ä»¶ï¼‰
SELECT * FROM `order` 
WHERE seller_id = #{currentSellerId}
ORDER BY create_time DESC;
```

### 7.3 ä½¿ç”¨MyBatisæ‹¦æˆªå™¨å®ç°è‡ªåŠ¨æ•°æ®éš”ç¦»


**è‡ªåŠ¨æ‹¦æˆªSQLï¼Œæ³¨å…¥æƒé™æ¡ä»¶**ï¼š

```java
@Component
public class DataPermissionInterceptor implements Interceptor {
    
    @Override
    public Object intercept(Invocation invocation) throws Throwable {
        // 1. è·å–å½“å‰ç”¨æˆ·
        Long userId = SecurityUtils.getCurrentUserId();
        String role = SecurityUtils.getCurrentRole();
        
        // 2. è·å–SQLè¯­å¥
        MappedStatement ms = (MappedStatement) invocation.getArgs()[0];
        BoundSql boundSql = ms.getBoundSql(invocation.getArgs()[1]);
        String sql = boundSql.getSql();
        
        // 3. æ ¹æ®è§’è‰²è‡ªåŠ¨æ·»åŠ WHEREæ¡ä»¶
        if ("USER".equals(role)) {
            sql += " AND user_id = " + userId;
        } else if ("SELLER".equals(role)) {
            sql += " AND seller_id = " + userId;
        }
        // ADMINè§’è‰²ä¸æ·»åŠ é™åˆ¶
        
        // 4. æ‰§è¡Œä¿®æ”¹åçš„SQL
        return invocation.proceed();
    }
}
```

---

## 8. ğŸ‘¥ å¤šè§’è‰²æƒé™è®¾è®¡


### 8.1 ç”µå•†ç³»ç»Ÿçš„è§’è‰²ä½“ç³»


**ç”µå•†ç³»ç»Ÿå…¸å‹çš„è§’è‰²è®¾è®¡**ï¼š

```
è§’è‰²å±‚æ¬¡ç»“æ„ï¼š

                    è¶…çº§ç®¡ç†å‘˜(SUPER_ADMIN)
                           |
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        |                  |                  |
    å¹³å°ç®¡ç†å‘˜(ADMIN)    å•†å®¶(SELLER)     æ™®é€šç”¨æˆ·(USER)
        |                  |                  |
    â”œâ”€ å•†å“å®¡æ ¸         â”œâ”€ å•†å“ç®¡ç†        â”œâ”€ æµè§ˆå•†å“
    â”œâ”€ è®¢å•ç®¡ç†         â”œâ”€ è®¢å•å¤„ç†        â”œâ”€ ä¸‹å•è´­ä¹°
    â”œâ”€ ç”¨æˆ·ç®¡ç†         â”œâ”€ æ•°æ®ç»Ÿè®¡        â”œâ”€ æŸ¥çœ‹è®¢å•
    â””â”€ ç³»ç»Ÿé…ç½®         â””â”€ åº—é“ºè®¾ç½®        â””â”€ è¯„ä»·å•†å“
```

### 8.2 è§’è‰²æƒé™é…ç½®


**æ•°æ®åº“è®¾è®¡**ï¼š

```sql
-- è§’è‰²è¡¨
CREATE TABLE role (
    id BIGINT PRIMARY KEY,
    name VARCHAR(50) NOT NULL,      -- è§’è‰²åç§°ï¼šADMIN, SELLER, USER
    description VARCHAR(200)
);

-- æƒé™è¡¨
CREATE TABLE permission (
    id BIGINT PRIMARY KEY,
    code VARCHAR(100) NOT NULL,     -- æƒé™ä»£ç ï¼šproduct:add
    name VARCHAR(100),              -- æƒé™åç§°ï¼šæ·»åŠ å•†å“
    resource VARCHAR(200)           -- èµ„æºè·¯å¾„ï¼š/api/product/add
);

-- è§’è‰²æƒé™å…³è”è¡¨
CREATE TABLE role_permission (
    role_id BIGINT,
    permission_id BIGINT,
    PRIMARY KEY (role_id, permission_id)
);

-- ç”¨æˆ·è§’è‰²å…³è”è¡¨
CREATE TABLE user_role (
    user_id BIGINT,
    role_id BIGINT,
    PRIMARY KEY (user_id, role_id)
);
```

**è§’è‰²æƒé™é…ç½®ç¤ºä¾‹**ï¼š

```java
@Configuration
public class RolePermissionConfig {
    
    // ç”¨æˆ·è§’è‰²æƒé™
    public static final Map<String, List<String>> USER_PERMISSIONS = Map.of(
        "USER", List.of(
            "product:view",      // æŸ¥çœ‹å•†å“
            "cart:manage",       // ç®¡ç†è´­ç‰©è½¦
            "order:create",      // åˆ›å»ºè®¢å•
            "order:view"         // æŸ¥çœ‹è®¢å•
        ),
        
        "SELLER", List.of(
            "product:view",
            "product:add",       // æ·»åŠ å•†å“
            "product:edit",      // ç¼–è¾‘å•†å“
            "product:delete",    // åˆ é™¤å•†å“
            "order:manage",      // ç®¡ç†è®¢å•
            "shop:manage"        // åº—é“ºç®¡ç†
        ),
        
        "ADMIN", List.of(
            "*:*"                // æ‰€æœ‰æƒé™
        )
    );
}
```

### 8.3 åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶(RBAC)


**æ–¹æ³•çº§æƒé™æ§åˆ¶**ï¼š

```java
@RestController
@RequestMapping("/api/admin")
public class AdminController {
    
    // åªæœ‰ç®¡ç†å‘˜å¯ä»¥è®¿é—®
    @GetMapping("/users")
    @PreAuthorize("hasRole('ADMIN')")
    public Result getAllUsers() {
        List<User> users = userService.findAll();
        return Result.success(users);
    }
    
    // ç®¡ç†å‘˜æˆ–å•†å®¶å¯ä»¥è®¿é—®
    @GetMapping("/orders")
    @PreAuthorize("hasAnyRole('ADMIN', 'SELLER')")
    public Result getOrders() {
        String role = SecurityUtils.getCurrentRole();
        
        if ("ADMIN".equals(role)) {
            // ç®¡ç†å‘˜çœ‹æ‰€æœ‰è®¢å•
            return Result.success(orderService.findAll());
        } else {
            // å•†å®¶åªçœ‹è‡ªå·±çš„è®¢å•
            Long sellerId = SecurityUtils.getCurrentUserId();
            return Result.success(orderService.findBySeller(sellerId));
        }
    }
    
    // éœ€è¦ç‰¹å®šæƒé™
    @PostMapping("/product/audit")
    @PreAuthorize("hasAuthority('product:audit')")
    public Result auditProduct(@RequestParam Long productId) {
        productService.audit(productId);
        return Result.success("å®¡æ ¸æˆåŠŸ");
    }
}
```

---

## 9. ğŸ›ï¸ å®‰å…¨æ¶æ„è®¾è®¡


### 9.1 æ•´ä½“å®‰å…¨æ¶æ„


**ç”µå•†ç³»ç»Ÿçš„å®‰å…¨é˜²æŠ¤ä½“ç³»**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ç¬¬ä¸€å±‚ï¼šç½‘ç»œé˜²æŠ¤å±‚                    â”‚
â”‚  - é˜²ç«å¢™                                        â”‚
â”‚  - DDoSé˜²æŠ¤                                      â”‚
â”‚  - IPé»‘ç™½åå•                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ç¬¬äºŒå±‚ï¼šç½‘å…³å®‰å…¨å±‚                    â”‚
â”‚  - JWTä»¤ç‰ŒéªŒè¯                                    â”‚
â”‚  - è¯·æ±‚ç­¾åæ ¡éªŒ                                   â”‚
â”‚  - é™æµç†”æ–­                                       â”‚
â”‚  - é»‘åå•è¿‡æ»¤                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             ç¬¬ä¸‰å±‚ï¼šåº”ç”¨å®‰å…¨å±‚                     â”‚
â”‚  - Spring Securityæƒé™æ§åˆ¶                        â”‚
â”‚  - æ–¹æ³•çº§æƒé™æ ¡éªŒ                                 â”‚
â”‚  - æ•°æ®æƒé™è¿‡æ»¤                                   â”‚
â”‚  - æ•æ„Ÿæ“ä½œå®¡è®¡                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             ç¬¬å››å±‚ï¼šæ•°æ®å®‰å…¨å±‚                     â”‚
â”‚  - æ•°æ®åŠ å¯†å­˜å‚¨                                   â”‚
â”‚  - æ•æ„Ÿå­—æ®µè„±æ•                                   â”‚
â”‚  - æ•°æ®è®¿é—®å®¡è®¡                                   â”‚
â”‚  - å¤‡ä»½ä¸æ¢å¤                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.2 æ ¸å¿ƒå®‰å…¨ç»„ä»¶é…ç½®


**Spring Securityå®Œæ•´é…ç½®**ï¼š

```java
@Configuration
@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    
    @Autowired
    private JwtAuthenticationFilter jwtFilter;
    
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
            // ç¦ç”¨CSRFï¼ˆå‰åç«¯åˆ†ç¦»é¡¹ç›®ï¼‰
            .csrf().disable()
            
            // é…ç½®URLæƒé™
            .authorizeRequests()
                // å…¬å¼€æ¥å£
                .antMatchers("/api/auth/**").permitAll()
                .antMatchers("/api/product/list").permitAll()
                // éœ€è¦ç™»å½•
                .antMatchers("/api/cart/**").authenticated()
                .antMatchers("/api/order/**").authenticated()
                // éœ€è¦ç‰¹å®šè§’è‰²
                .antMatchers("/api/admin/**").hasRole("ADMIN")
                .antMatchers("/api/seller/**").hasAnyRole("SELLER", "ADMIN")
                // å…¶ä»–è¯·æ±‚éƒ½éœ€è¦è®¤è¯
                .anyRequest().authenticated()
            
            // æ·»åŠ JWTè¿‡æ»¤å™¨
            .and()
            .addFilterBefore(jwtFilter, UsernamePasswordAuthenticationFilter.class)
            
            // å¼‚å¸¸å¤„ç†
            .exceptionHandling()
                .authenticationEntryPoint((req, resp, ex) -> {
                    resp.setContentType("application/json;charset=UTF-8");
                    resp.getWriter().write("{\"code\":401,\"msg\":\"æœªç™»å½•\"}");
                })
                .accessDeniedHandler((req, resp, ex) -> {
                    resp.setContentType("application/json;charset=UTF-8");
                    resp.getWriter().write("{\"code\":403,\"msg\":\"æ— æƒé™\"}");
                });
    }
}
```

### 9.3 å®‰å…¨å®¡è®¡æ—¥å¿—


**è®°å½•æ‰€æœ‰æ•æ„Ÿæ“ä½œ**ï¼š

```java
@Aspect
@Component
public class SecurityAuditAspect {
    
    @Autowired
    private AuditLogService auditLogService;
    
    // æ‹¦æˆªæ‰€æœ‰éœ€è¦æƒé™çš„æ–¹æ³•
    @Around("@annotation(preAuthorize)")
    public Object audit(ProceedingJoinPoint pjp, PreAuthorize preAuthorize) {
        // è®°å½•æ“ä½œä¿¡æ¯
        AuditLog log = new AuditLog();
        log.setUserId(SecurityUtils.getCurrentUserId());
        log.setUsername(SecurityUtils.getCurrentUsername());
        log.setOperation(pjp.getSignature().getName());
        log.setParams(Arrays.toString(pjp.getArgs()));
        log.setIp(RequestUtils.getClientIp());
        log.setTime(new Date());
        
        try {
            Object result = pjp.proceed();
            log.setStatus("SUCCESS");
            return result;
        } catch (Throwable e) {
            log.setStatus("FAIL");
            log.setError(e.getMessage());
            throw new RuntimeException(e);
        } finally {
            auditLogService.save(log);
        }
    }
}
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ” è®¤è¯ä¸æˆæƒï¼š
â”œâ”€â”€ è®¤è¯(Authentication)ï¼šéªŒè¯"ä½ æ˜¯è°"(ç™»å½•)
â””â”€â”€ æˆæƒ(Authorization)ï¼šéªŒè¯"ä½ èƒ½åšä»€ä¹ˆ"(æƒé™)

ğŸ›¡ï¸ æƒé™æ§åˆ¶ä¸‰è¦ç´ ï¼š
â”œâ”€â”€ ä¸»ä½“(Subject)ï¼šæ“ä½œè€…æ˜¯è°
â”œâ”€â”€ èµ„æº(Resource)ï¼šè¦è®¿é—®ä»€ä¹ˆ
â””â”€â”€ æƒé™(Permission)ï¼šæ˜¯å¦æœ‰æƒé™

ğŸ”’ æ•°æ®å®‰å…¨ä¸‰åŸåˆ™ï¼š
â”œâ”€â”€ æœ€å°æƒé™ï¼šåªç»™å¿…éœ€çš„æƒé™
â”œâ”€â”€ æ•°æ®éš”ç¦»ï¼šä¸åŒç”¨æˆ·çœ‹ä¸åˆ°å½¼æ­¤æ•°æ®
â””â”€â”€ æ“ä½œå®¡è®¡ï¼šè®°å½•æ‰€æœ‰æ•æ„Ÿæ“ä½œ
```

### 10.2 å…³é”®å®ç°è¦ç‚¹


> âœ… **ç”¨æˆ·æ•°æ®å®‰å…¨**ï¼šå¯†ç BCryptåŠ å¯†ï¼ŒJWTä»¤ç‰Œè®¤è¯

> âœ… **è´­ç‰©è½¦éš”ç¦»**ï¼šè‡ªåŠ¨ä»ä»¤ç‰Œè·å–userIdï¼Œä¸ä¿¡ä»»å‰ç«¯å‚æ•°

> âœ… **è®¢å•æƒé™**ï¼šåŒé‡æ ¡éªŒ(å½’å±+çŠ¶æ€)ï¼Œé˜²æ­¢è¶Šæƒ

> âœ… **æ”¯ä»˜å®‰å…¨**ï¼šé‡‘é¢æ ¡éªŒã€ç­¾åéªŒè¯ã€å¹‚ç­‰å¤„ç†

> âœ… **å•†å“æƒé™**ï¼šåŸºäºè§’è‰²æ§åˆ¶ï¼Œå•†å®¶åªèƒ½ç®¡ç†è‡ªå·±çš„å•†å“

> âœ… **æ•°æ®éš”ç¦»**ï¼šSQLè‡ªåŠ¨æ³¨å…¥æƒé™æ¡ä»¶ï¼Œé˜²æ­¢æ•°æ®æ³„éœ²

> âœ… **å¤šè§’è‰²è®¾è®¡**ï¼šRBACæ¨¡å‹ï¼Œçµæ´»çš„è§’è‰²æƒé™é…ç½®

### 10.3 å®æˆ˜ç»éªŒæ€»ç»“


**ğŸ¯ å®‰å…¨å¼€å‘è§„èŒƒ**ï¼š

| è§„èŒƒ | **è¯´æ˜** | **ç¤ºä¾‹** |
|------|---------|---------|
| **æ°¸è¿œä¸ä¿¡ä»»å‰ç«¯** | æ‰€æœ‰æƒé™æ ¡éªŒåœ¨åç«¯ | ç”¨æˆ·IDä»JWTè·å–ï¼Œä¸ä»å‚æ•°è·å– |
| **æœ€å°æƒé™åŸåˆ™** | é»˜è®¤æ‹’ç»ï¼ŒæŒ‰éœ€å¼€æ”¾ | æ–°æ¥å£é»˜è®¤éœ€è¦è®¤è¯ |
| **æ•°æ®å¼ºéš”ç¦»** | ç”¨æˆ·åªèƒ½çœ‹è‡ªå·±çš„æ•°æ® | SQLè‡ªåŠ¨æ·»åŠ user_idæ¡ä»¶ |
| **æ•æ„Ÿæ“ä½œå®¡è®¡** | è®°å½•æ‰€æœ‰å…³é”®æ“ä½œ | è®¢å•ã€æ”¯ä»˜æ“ä½œè®°å½•æ—¥å¿— |
| **å¤šå±‚é˜²æŠ¤** | ç½‘å…³+åº”ç”¨+æ•°æ®å¤šå±‚é˜²æŠ¤ | JWTéªŒè¯+æƒé™æ³¨è§£+SQLè¿‡æ»¤ |

**âš ï¸ å¸¸è§å®‰å…¨é™·é˜±**ï¼š

```
âŒ é”™è¯¯å†™æ³•ï¼š
// ç›´æ¥ä½¿ç”¨å‰ç«¯ä¼ æ¥çš„userId
public Order getOrder(Long userId, Long orderId) {
    return orderMapper.select(userId, orderId);
}

âœ… æ­£ç¡®å†™æ³•ï¼š
// ä»ä»¤ç‰Œä¸­è·å–çœŸå®userId
public Order getOrder(Long orderId) {
    Long realUserId = SecurityUtils.getCurrentUserId();
    return orderMapper.select(realUserId, orderId);
}
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
ç”µå•†å®‰å…¨å¾ˆé‡è¦ï¼Œå››å±‚é˜²æŠ¤ä¸èƒ½å°‘
è®¤è¯æˆæƒè¦åˆ†æ¸…ï¼Œç”¨æˆ·æ•°æ®å¼ºéš”ç¦»
è®¢å•æ”¯ä»˜åŒæ ¡éªŒï¼Œè§’è‰²æƒé™ç»†åˆ’åˆ†
æ“ä½œå®¡è®¡å…¨è®°å½•ï¼Œå®‰å…¨æ„è¯†è¦ç‰¢è®°
```