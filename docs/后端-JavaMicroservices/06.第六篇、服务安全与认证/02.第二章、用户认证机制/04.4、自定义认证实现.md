---
title: 4ã€è‡ªå®šä¹‰è®¤è¯å®ç°
---
## ğŸ“š ç›®å½•

1. [ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰è®¤è¯](#1-ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰è®¤è¯)
2. [æ ¸å¿ƒæ¥å£è®¤è¯†](#2-æ ¸å¿ƒæ¥å£è®¤è¯†)
3. [è‡ªå®šä¹‰UserDetailsServiceå®ç°](#3-è‡ªå®šä¹‰UserDetailsServiceå®ç°)
4. [è‡ªå®šä¹‰AuthenticationProvider](#4-è‡ªå®šä¹‰AuthenticationProvider)
5. [ä¸šåŠ¡ç”¨æˆ·å¯¹è±¡è½¬æ¢](#5-ä¸šåŠ¡ç”¨æˆ·å¯¹è±¡è½¬æ¢)
6. [æƒé™åŠ¨æ€åŠ è½½æœºåˆ¶](#6-æƒé™åŠ¨æ€åŠ è½½æœºåˆ¶)
7. [ç”¨æˆ·ç¼“å­˜ä¼˜åŒ–ç­–ç•¥](#7-ç”¨æˆ·ç¼“å­˜ä¼˜åŒ–ç­–ç•¥)
8. [è®¤è¯é€»è¾‘æ‰©å±•å®è·µ](#8-è®¤è¯é€»è¾‘æ‰©å±•å®è·µ)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¤” ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰è®¤è¯


### 1.1 é»˜è®¤è®¤è¯çš„å±€é™æ€§


Spring Securityé»˜è®¤çš„è®¤è¯æ–¹å¼å°±åƒ**ç®€æ˜“ç‰ˆçš„é—¨ç¦ç³»ç»Ÿ**ï¼Œåªèƒ½è¯†åˆ«å›ºå®šçš„å‡ ä¸ªç”¨æˆ·ï¼Œæ— æ³•åº”å¯¹å®é™…ä¸šåŠ¡éœ€æ±‚ã€‚

**é»˜è®¤è®¤è¯çš„é—®é¢˜ï¼š**
```
âŒ ç”¨æˆ·ä¿¡æ¯å†™æ­»åœ¨é…ç½®æ–‡ä»¶ä¸­
âŒ æ— æ³•ä»æ•°æ®åº“åŠ¨æ€åŠ è½½ç”¨æˆ·
âŒ ä¸æ”¯æŒå¤æ‚çš„æƒé™è®¾è®¡
âŒ æ— æ³•é›†æˆç°æœ‰ä¸šåŠ¡é€»è¾‘
```

**å®é™…ä¸šåŠ¡éœ€æ±‚ï¼š**
```
âœ… ç”¨æˆ·æ•°æ®å­˜å‚¨åœ¨MySQL/MongoDBç­‰æ•°æ®åº“
âœ… ç”¨æˆ·è§’è‰²æƒé™éœ€è¦åŠ¨æ€å˜åŒ–
âœ… éœ€è¦æ”¯æŒå¤šç§ç™»å½•æ–¹å¼ï¼ˆæ‰‹æœºå·ã€é‚®ç®±ã€ç”¨æˆ·åï¼‰
âœ… éœ€è¦è®°å½•ç™»å½•æ—¥å¿—ã€å¼‚å¸¸ç™»å½•æ£€æµ‹
âœ… éœ€è¦é›†æˆç¬¬ä¸‰æ–¹ç™»å½•ï¼ˆå¾®ä¿¡ã€æ”¯ä»˜å®ï¼‰
```

### 1.2 è‡ªå®šä¹‰è®¤è¯çš„æ ¸å¿ƒä»·å€¼


ğŸ’¡ **é€šä¿—ç†è§£**
> è‡ªå®šä¹‰è®¤è¯å°±åƒæŠŠç®€æ˜“é—¨ç¦å‡çº§æˆæ™ºèƒ½é—¨ç¦ç³»ç»Ÿï¼š
> - å¯ä»¥è¿æ¥æ•°æ®åº“ï¼Œç®¡ç†æµ·é‡ç”¨æˆ·
> - å¯ä»¥è®¾ç½®ä¸åŒçš„æƒé™çº§åˆ«ï¼ˆæ™®é€šç”¨æˆ·ã€VIPã€ç®¡ç†å‘˜ï¼‰
> - å¯ä»¥è®°å½•è°ä»€ä¹ˆæ—¶å€™è¿›å‡º
> - å¯ä»¥æ”¯æŒå¤šç§å¼€é—¨æ–¹å¼ï¼ˆåˆ·å¡ã€å¯†ç ã€æŒ‡çº¹ï¼‰

---

## 2. ğŸ”‘ æ ¸å¿ƒæ¥å£è®¤è¯†


### 2.1 è®¤è¯ä½“ç³»æ ¸å¿ƒæ¥å£


```
è®¤è¯æµç¨‹ä¸­çš„å…³é”®è§’è‰²ï¼š

ç”¨æˆ·è¯·æ±‚
   â†“
UserDetailsService â† è´Ÿè´£åŠ è½½ç”¨æˆ·ä¿¡æ¯ï¼ˆä»æ•°æ®åº“ï¼‰
   â†“
UserDetails â† å°è£…ç”¨æˆ·ä¿¡æ¯ï¼ˆç”¨æˆ·åã€å¯†ç ã€æƒé™ï¼‰
   â†“
AuthenticationProvider â† è´Ÿè´£éªŒè¯é€»è¾‘ï¼ˆå¯†ç æ ¡éªŒï¼‰
   â†“
Authentication â† è®¤è¯ç»“æœï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰
```

### 2.2 æ¥å£èŒè´£è¯´æ˜


| æ¥å£/ç±» | **ä½œç”¨** | **é€šä¿—ç†è§£** |
|---------|----------|-------------|
| `UserDetailsService` | åŠ è½½ç”¨æˆ·ä¿¡æ¯ | åƒæ˜¯**æŸ¥è¯¢å‘˜å·¥æ¡£æ¡ˆçš„HRç³»ç»Ÿ** |
| `UserDetails` | ç”¨æˆ·ä¿¡æ¯æ¨¡å‹ | åƒæ˜¯**å‘˜å·¥æ¡£æ¡ˆå¡** |
| `AuthenticationProvider` | è®¤è¯é€»è¾‘å¤„ç† | åƒæ˜¯**é—¨ç¦éªŒè¯ç³»ç»Ÿ** |
| `PasswordEncoder` | å¯†ç åŠ å¯† | åƒæ˜¯**å¯†ç ä¿é™©ç®±** |

---

## 3. ğŸ‘¤ è‡ªå®šä¹‰UserDetailsServiceå®ç°


### 3.1 UserDetailsServiceæ˜¯ä»€ä¹ˆ


**æ ¸å¿ƒä½œç”¨ï¼š** æ ¹æ®ç”¨æˆ·åä»æ•°æ®åº“åŠ è½½ç”¨æˆ·ä¿¡æ¯

ğŸ’¡ **ç”Ÿæ´»åŒ–ç±»æ¯”**
> UserDetailsServiceå°±åƒå›¾ä¹¦é¦†çš„æŸ¥è¯¢ç³»ç»Ÿï¼š
> - ä½ æŠ¥ä¸€ä¸ªå€Ÿä¹¦è¯å·ï¼ˆç”¨æˆ·åï¼‰
> - ç³»ç»Ÿä»æ•°æ®åº“æŸ¥å‡ºä½ çš„å€Ÿé˜…è®°å½•ï¼ˆç”¨æˆ·ä¿¡æ¯ï¼‰
> - è¿”å›ä½ çš„ä¿¡æ¯å¡ç‰‡ï¼ˆUserDetailså¯¹è±¡ï¼‰

### 3.2 å®ç°æ­¥éª¤è¯¦è§£


**ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºç”¨æˆ·å®ä½“ç±»**

```java
// æ•°æ®åº“ç”¨æˆ·å®ä½“
@Entity
@Table(name = "sys_user")
public class SysUser {
    @Id
    private Long id;
    private String username;      // ç”¨æˆ·å
    private String password;      // åŠ å¯†åçš„å¯†ç 
    private String phone;         // æ‰‹æœºå·
    private Integer status;       // çŠ¶æ€ï¼š0-ç¦ç”¨ 1-å¯ç”¨
    
    // å…³è”è§’è‰²è¡¨ï¼ˆä¸€ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªè§’è‰²ï¼‰
    @ManyToMany
    private Set<SysRole> roles;
}
```

**ç¬¬äºŒæ­¥ï¼šå®ç°UserDetailsServiceæ¥å£**

```java
@Service
public class CustomUserDetailsService implements UserDetailsService {
    
    @Autowired
    private UserMapper userMapper;  // ç”¨æˆ·æ•°æ®è®¿é—®å±‚
    
    @Override
    public UserDetails loadUserByUsername(String username) {
        // 1. ä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·
        SysUser user = userMapper.findByUsername(username);
        
        // 2. ç”¨æˆ·ä¸å­˜åœ¨ï¼ŒæŠ›å‡ºå¼‚å¸¸
        if (user == null) {
            throw new UsernameNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨ï¼š" + username);
        }
        
        // 3. æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
        if (user.getStatus() == 0) {
            throw new DisabledException("è´¦å·å·²è¢«ç¦ç”¨");
        }
        
        // 4. åŠ è½½ç”¨æˆ·æƒé™ï¼ˆä»è§’è‰²è¡¨ï¼‰
        List<GrantedAuthority> authorities = new ArrayList<>();
        for (SysRole role : user.getRoles()) {
            authorities.add(new SimpleGrantedAuthority(role.getRoleName()));
        }
        
        // 5. è¿”å›Spring Securityçš„Userå¯¹è±¡
        return new User(
            user.getUsername(),
            user.getPassword(),
            authorities
        );
    }
}
```

**ä»£ç å…³é”®ç‚¹è§£æï¼š**

ğŸ”¸ **loadUserByUsernameæ–¹æ³•** - è¿™æ˜¯æ•´ä¸ªè®¤è¯çš„å…¥å£
```
ä½œç”¨ï¼šæ ¹æ®ç”¨æˆ·ååŠ è½½ç”¨æˆ·ä¿¡æ¯
è¾“å…¥ï¼šç”¨æˆ·åï¼ˆStringï¼‰
è¾“å‡ºï¼šUserDetailså¯¹è±¡ï¼ˆåŒ…å«å¯†ç å’Œæƒé™ï¼‰
```

ğŸ”¸ **å¼‚å¸¸å¤„ç†**
- `UsernameNotFoundException` - ç”¨æˆ·ä¸å­˜åœ¨æ—¶æŠ›å‡º
- `DisabledException` - ç”¨æˆ·è¢«ç¦ç”¨æ—¶æŠ›å‡º
- Spring Securityä¼šè‡ªåŠ¨æ•è·è¿™äº›å¼‚å¸¸å¹¶è¿”å›å‹å¥½æç¤º

### 3.3 é…ç½®ä½¿ç”¨


```java
@Configuration
public class SecurityConfig {
    
    @Autowired
    private CustomUserDetailsService userDetailsService;
    
    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) {
        return http
            .userDetailsService(userDetailsService)  // æ³¨å†Œè‡ªå®šä¹‰æœåŠ¡
            .authorizeHttpRequests(auth -> auth
                .anyRequest().authenticated()
            )
            .build();
    }
}
```

---

## 4. ğŸ” è‡ªå®šä¹‰AuthenticationProvider


### 4.1 ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰Provider


**UserDetailsServiceçš„å±€é™ï¼š**
```
åªèƒ½æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ â†’ æ— æ³•æ”¯æŒæ‰‹æœºå·ç™»å½•
åªåšæŸ¥è¯¢ä¸åšéªŒè¯ â†’ æ— æ³•å®ç°å›¾å½¢éªŒè¯ç æ ¡éªŒ
æµç¨‹å›ºå®š â†’ æ— æ³•æ·»åŠ è‡ªå®šä¹‰è®¤è¯é€»è¾‘
```

**AuthenticationProviderçš„å¼ºå¤§ï¼š**
```
âœ… å®Œå…¨æ§åˆ¶è®¤è¯æµç¨‹
âœ… æ”¯æŒå¤šç§ç™»å½•æ–¹å¼
âœ… å¯ä»¥æ·»åŠ é¢å¤–éªŒè¯ï¼ˆéªŒè¯ç ã€è®¾å¤‡æŒ‡çº¹ï¼‰
âœ… å¯ä»¥å®ç°å¤šå› ç´ è®¤è¯ï¼ˆMFAï¼‰
```

### 4.2 å®ç°è‡ªå®šä¹‰Provider


```java
@Component
public class CustomAuthenticationProvider implements AuthenticationProvider {
    
    @Autowired
    private UserDetailsService userDetailsService;
    
    @Autowired
    private PasswordEncoder passwordEncoder;
    
    @Override
    public Authentication authenticate(Authentication auth) {
        String username = auth.getName();           // ç”¨æˆ·å
        String password = auth.getCredentials().toString();  // å¯†ç 
        
        // 1. åŠ è½½ç”¨æˆ·ä¿¡æ¯
        UserDetails user = userDetailsService.loadUserByUsername(username);
        
        // 2. éªŒè¯å¯†ç 
        if (!passwordEncoder.matches(password, user.getPassword())) {
            throw new BadCredentialsException("å¯†ç é”™è¯¯");
        }
        
        // 3. è¿™é‡Œå¯ä»¥æ·»åŠ é¢å¤–éªŒè¯é€»è¾‘
        // æ¯”å¦‚ï¼šéªŒè¯ç æ ¡éªŒã€ç™»å½•æ¬¡æ•°æ£€æŸ¥ã€å¼‚åœ°ç™»å½•æ£€æµ‹ç­‰
        
        // 4. è®¤è¯æˆåŠŸï¼Œè¿”å›è®¤è¯ä»¤ç‰Œ
        return new UsernamePasswordAuthenticationToken(
            user, 
            password, 
            user.getAuthorities()
        );
    }
    
    @Override
    public boolean supports(Class<?> authentication) {
        // æŒ‡å®šæ”¯æŒçš„è®¤è¯ç±»å‹
        return UsernamePasswordAuthenticationToken.class.isAssignableFrom(authentication);
    }
}
```

**æµç¨‹å¯¹æ¯”ï¼š**

```
é»˜è®¤æµç¨‹ï¼š
ç”¨æˆ·ç™»å½• â†’ UserDetailsServiceæŸ¥è¯¢ â†’ å¯†ç æ ¡éªŒ â†’ è¿”å›ç»“æœ

è‡ªå®šä¹‰Provideræµç¨‹ï¼š
ç”¨æˆ·ç™»å½• â†’ ä½ çš„è‡ªå®šä¹‰é€»è¾‘ â†’ éªŒè¯ç æ ¡éªŒ â†’ å¯†ç æ ¡éªŒ 
â†’ ç™»å½•æ¬¡æ•°æ£€æŸ¥ â†’ å¼‚åœ°ç™»å½•æ£€æµ‹ â†’ è¿”å›ç»“æœ
```

---

## 5. ğŸ”„ ä¸šåŠ¡ç”¨æˆ·å¯¹è±¡è½¬æ¢


### 5.1 ä¸ºä»€ä¹ˆéœ€è¦è½¬æ¢


**é—®é¢˜åœºæ™¯ï¼š**
```
æ•°æ®åº“å®ä½“ï¼šSysUserï¼ˆåŒ…å«ä¸šåŠ¡å­—æ®µï¼šæ˜µç§°ã€å¤´åƒã€éƒ¨é—¨ç­‰ï¼‰
   â†•ï¸  éœ€è¦è½¬æ¢
Securityå¯¹è±¡ï¼šUserDetailsï¼ˆåªåŒ…å«ï¼šç”¨æˆ·åã€å¯†ç ã€æƒé™ï¼‰
```

**è½¬æ¢çš„ç›®çš„ï¼š**
- Spring Securityéœ€è¦æ ‡å‡†çš„UserDetailså¯¹è±¡
- ä¸šåŠ¡ä»£ç éœ€è¦å®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯
- éœ€è¦ä¸€åº§æ¡¥æ¢è¿æ¥ä¸¤è€…

### 5.2 åˆ›å»ºè‡ªå®šä¹‰UserDetails


```java
// è‡ªå®šä¹‰UserDetailsï¼ŒåŒ…å«ä¸šåŠ¡å­—æ®µ
public class CustomUserDetails implements UserDetails {
    
    private final SysUser sysUser;  // åŒ…å«å®Œæ•´çš„ä¸šåŠ¡ç”¨æˆ·å¯¹è±¡
    private final List<GrantedAuthority> authorities;
    
    public CustomUserDetails(SysUser sysUser, List<GrantedAuthority> authorities) {
        this.sysUser = sysUser;
        this.authorities = authorities;
    }
    
    // å®ç°UserDetailsæ¥å£æ–¹æ³•
    @Override
    public String getUsername() {
        return sysUser.getUsername();
    }
    
    @Override
    public String getPassword() {
        return sysUser.getPassword();
    }
    
    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() {
        return authorities;
    }
    
    @Override
    public boolean isEnabled() {
        return sysUser.getStatus() == 1;  // 1-å¯ç”¨ 0-ç¦ç”¨
    }
    
    // ä¸šåŠ¡æ–¹æ³•ï¼šè·å–å®Œæ•´ç”¨æˆ·å¯¹è±¡
    public SysUser getSysUser() {
        return sysUser;
    }
    
    // ä¸šåŠ¡æ–¹æ³•ï¼šè·å–ç”¨æˆ·æ˜µç§°
    public String getNickname() {
        return sysUser.getNickname();
    }
}
```

**ä¿®æ”¹UserDetailsServiceè¿”å›è‡ªå®šä¹‰å¯¹è±¡ï¼š**

```java
@Override
public UserDetails loadUserByUsername(String username) {
    SysUser user = userMapper.findByUsername(username);
    
    if (user == null) {
        throw new UsernameNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨");
    }
    
    // åŠ è½½æƒé™
    List<GrantedAuthority> authorities = loadAuthorities(user);
    
    // è¿”å›è‡ªå®šä¹‰UserDetails
    return new CustomUserDetails(user, authorities);
}
```

### 5.3 åœ¨ä¸šåŠ¡ä¸­ä½¿ç”¨


```java
@RestController
public class UserController {
    
    @GetMapping("/user/info")
    public SysUser getCurrentUser() {
        // ä»Securityä¸Šä¸‹æ–‡è·å–å½“å‰ç”¨æˆ·
        Authentication auth = SecurityContextHolder.getContext().getAuthentication();
        CustomUserDetails userDetails = (CustomUserDetails) auth.getPrincipal();
        
        // è·å–å®Œæ•´çš„ä¸šåŠ¡ç”¨æˆ·å¯¹è±¡
        return userDetails.getSysUser();
    }
}
```

---

## 6. âš¡ æƒé™åŠ¨æ€åŠ è½½æœºåˆ¶


### 6.1 æƒé™è®¾è®¡æ€è·¯


**å…¸å‹çš„RBACæ¨¡å‹ï¼ˆåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼‰ï¼š**

```
ç”¨æˆ·è¡¨         è§’è‰²è¡¨         æƒé™è¡¨
â”Œâ”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ å¼ ä¸‰ â”‚â”€â”€â”€â”€â”€â†’â”‚ ç®¡ç†å‘˜ â”‚â”€â”€â”€â”€â”€â†’â”‚ ç”¨æˆ·ç®¡ç† â”‚
â””â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â””â”€â”€â”€â”€â”€â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚ è®¢å•æŸ¥çœ‹  â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ•°æ®åº“è¡¨è®¾è®¡ï¼š**

```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE sys_user (
    id BIGINT PRIMARY KEY,
    username VARCHAR(50),
    password VARCHAR(200)
);

-- è§’è‰²è¡¨
CREATE TABLE sys_role (
    id BIGINT PRIMARY KEY,
    role_name VARCHAR(50),      -- è§’è‰²åï¼šROLE_ADMIN
    role_desc VARCHAR(200)      -- è§’è‰²æè¿°
);

-- æƒé™è¡¨
CREATE TABLE sys_permission (
    id BIGINT PRIMARY KEY,
    permission_code VARCHAR(50), -- æƒé™ç ï¼šuser:add
    permission_name VARCHAR(100) -- æƒé™åï¼šæ–°å¢ç”¨æˆ·
);

-- ç”¨æˆ·-è§’è‰²å…³è”è¡¨
CREATE TABLE user_role (
    user_id BIGINT,
    role_id BIGINT
);

-- è§’è‰²-æƒé™å…³è”è¡¨
CREATE TABLE role_permission (
    role_id BIGINT,
    permission_id BIGINT
);
```

### 6.2 åŠ¨æ€åŠ è½½æƒé™å®ç°


```java
@Service
public class CustomUserDetailsService implements UserDetailsService {
    
    @Autowired
    private UserMapper userMapper;
    @Autowired
    private RoleMapper roleMapper;
    @Autowired
    private PermissionMapper permissionMapper;
    
    @Override
    public UserDetails loadUserByUsername(String username) {
        // 1. æŸ¥è¯¢ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
        SysUser user = userMapper.findByUsername(username);
        
        // 2. æŸ¥è¯¢ç”¨æˆ·çš„æ‰€æœ‰è§’è‰²
        List<SysRole> roles = roleMapper.findByUserId(user.getId());
        
        // 3. æŸ¥è¯¢è§’è‰²å¯¹åº”çš„æ‰€æœ‰æƒé™
        Set<GrantedAuthority> authorities = new HashSet<>();
        
        for (SysRole role : roles) {
            // æ·»åŠ è§’è‰²ï¼ˆæ³¨æ„ï¼šSpring Securityè§’è‰²éœ€è¦ROLE_å‰ç¼€ï¼‰
            authorities.add(new SimpleGrantedAuthority("ROLE_" + role.getRoleName()));
            
            // æŸ¥è¯¢è¯¥è§’è‰²çš„æƒé™
            List<SysPermission> permissions = permissionMapper.findByRoleId(role.getId());
            
            // æ·»åŠ æƒé™
            for (SysPermission perm : permissions) {
                authorities.add(new SimpleGrantedAuthority(perm.getPermissionCode()));
            }
        }
        
        // 4. è¿”å›åŒ…å«è§’è‰²å’Œæƒé™çš„UserDetails
        return new CustomUserDetails(user, new ArrayList<>(authorities));
    }
}
```

**æƒé™ç»“æœç¤ºä¾‹ï¼š**

```
ç”¨æˆ·ï¼šå¼ ä¸‰
è§’è‰²ï¼šROLE_ADMIN, ROLE_MANAGER
æƒé™ï¼š
  - ROLE_ADMIN          ï¼ˆè§’è‰²ï¼‰
  - ROLE_MANAGER        ï¼ˆè§’è‰²ï¼‰
  - user:add            ï¼ˆæƒé™ï¼‰
  - user:delete         ï¼ˆæƒé™ï¼‰
  - order:view          ï¼ˆæƒé™ï¼‰
```

### 6.3 åœ¨æ¥å£ä¸­ä½¿ç”¨æƒé™


```java
@RestController
@RequestMapping("/user")
public class UserController {
    
    // è¦æ±‚æœ‰ç®¡ç†å‘˜è§’è‰²
    @PreAuthorize("hasRole('ADMIN')")
    @GetMapping("/list")
    public List<User> list() {
        return userService.list();
    }
    
    // è¦æ±‚æœ‰ç‰¹å®šæƒé™
    @PreAuthorize("hasAuthority('user:delete')")
    @DeleteMapping("/{id}")
    public void delete(@PathVariable Long id) {
        userService.delete(id);
    }
    
    // è¦æ±‚æœ‰ä»»ä¸€è§’è‰²
    @PreAuthorize("hasAnyRole('ADMIN', 'MANAGER')")
    @PostMapping("/export")
    public void export() {
        // å¯¼å‡ºç”¨æˆ·
    }
}
```

---

## 7. ğŸš€ ç”¨æˆ·ç¼“å­˜ä¼˜åŒ–ç­–ç•¥


### 7.1 ä¸ºä»€ä¹ˆéœ€è¦ç¼“å­˜


**æ€§èƒ½é—®é¢˜ï¼š**
```
æ¯æ¬¡è¯·æ±‚éƒ½æŸ¥æ•°æ®åº“ â†’ æ€§èƒ½ç“¶é¢ˆ
 â†“
ç”¨æˆ·ä¿¡æ¯å¾ˆå°‘å˜åŒ– â†’ é€‚åˆç¼“å­˜
 â†“
ä½¿ç”¨ç¼“å­˜å‡å°‘æ•°æ®åº“å‹åŠ› â†’ æ€§èƒ½æå‡
```

**ç¼“å­˜æ”¶ç›Šï¼š**
- å‡å°‘æ•°æ®åº“æŸ¥è¯¢ï¼šä»å‡ åmsé™åˆ°å‡ ms
- æå‡å¹¶å‘èƒ½åŠ›ï¼šæ”¯æŒæ›´å¤šç”¨æˆ·åŒæ—¶ç™»å½•
- é™ä½æ•°æ®åº“å‹åŠ›ï¼šé‡Šæ”¾æ•°æ®åº“èµ„æº

### 7.2 Spring Securityå†…ç½®ç¼“å­˜


```java
@Configuration
public class SecurityConfig {
    
    @Autowired
    private UserDetailsService userDetailsService;
    
    @Bean
    public UserDetailsService cachedUserDetailsService() {
        // åˆ›å»ºç¼“å­˜UserDetailsService
        UserDetailsServiceDelegator delegator = 
            new UserDetailsServiceDelegator(userDetailsService);
        
        // ä½¿ç”¨Springçš„ç¼“å­˜UserDetailsServiceåŒ…è£…å™¨
        return new UserDetailsByNameServiceWrapper<>(
            new CachingUserDetailsService(delegator)
        );
    }
}
```

### 7.3 ä½¿ç”¨Redisç¼“å­˜ç”¨æˆ·ä¿¡æ¯


```java
@Service
public class CachedUserDetailsService implements UserDetailsService {
    
    @Autowired
    private UserDetailsService delegateService;  // å®é™…çš„UserDetailsService
    
    @Autowired
    private RedisTemplate<String, UserDetails> redisTemplate;
    
    @Override
    public UserDetails loadUserByUsername(String username) {
        String cacheKey = "user:details:" + username;
        
        // 1. å…ˆä»Redisç¼“å­˜æŸ¥è¯¢
        UserDetails cached = redisTemplate.opsForValue().get(cacheKey);
        if (cached != null) {
            return cached;
        }
        
        // 2. ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“
        UserDetails user = delegateService.loadUserByUsername(username);
        
        // 3. å­˜å…¥ç¼“å­˜ï¼ˆè®¾ç½®30åˆ†é’Ÿè¿‡æœŸï¼‰
        redisTemplate.opsForValue().set(cacheKey, user, 30, TimeUnit.MINUTES);
        
        return user;
    }
}
```

**ç¼“å­˜ç­–ç•¥è¯´æ˜ï¼š**

| ç­–ç•¥ | **è¯´æ˜** | **é€‚ç”¨åœºæ™¯** |
|------|----------|-------------|
| `æ— ç¼“å­˜` | æ¯æ¬¡éƒ½æŸ¥æ•°æ®åº“ | ç”¨æˆ·ä¿¡æ¯å®æ—¶æ€§è¦æ±‚æé«˜ |
| `å†…å­˜ç¼“å­˜` | ä½¿ç”¨æœ¬åœ°å†…å­˜ | å•æœºåº”ç”¨ |
| `Redisç¼“å­˜` | ä½¿ç”¨Redis | åˆ†å¸ƒå¼åº”ç”¨ã€é›†ç¾¤ç¯å¢ƒ |

**ç¼“å­˜å¤±æ•ˆæ—¶æœºï¼š**
```
âœ… ç”¨æˆ·ä¿¡æ¯ä¿®æ”¹æ—¶ä¸»åŠ¨æ¸…é™¤ç¼“å­˜
âœ… æƒé™å˜æ›´æ—¶ä¸»åŠ¨æ¸…é™¤ç¼“å­˜
âœ… è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´ï¼ˆå¦‚30åˆ†é’Ÿï¼‰
âœ… ç”¨æˆ·é€€å‡ºç™»å½•æ—¶æ¸…é™¤ç¼“å­˜
```

---

## 8. ğŸ›  è®¤è¯é€»è¾‘æ‰©å±•å®è·µ


### 8.1 å¤šç™»å½•æ–¹å¼æ”¯æŒ


**åœºæ™¯ï¼š** æ”¯æŒç”¨æˆ·åã€æ‰‹æœºå·ã€é‚®ç®±ç™»å½•

```java
@Service
public class MultiLoginUserDetailsService implements UserDetailsService {
    
    @Autowired
    private UserMapper userMapper;
    
    @Override
    public UserDetails loadUserByUsername(String loginId) {
        SysUser user = null;
        
        // 1. åˆ¤æ–­ç™»å½•æ–¹å¼
        if (loginId.contains("@")) {
            // é‚®ç®±ç™»å½•
            user = userMapper.findByEmail(loginId);
        } else if (loginId.matches("^1[3-9]\\d{9}$")) {
            // æ‰‹æœºå·ç™»å½•ï¼ˆä¸­å›½æ‰‹æœºå·æ ¼å¼ï¼‰
            user = userMapper.findByPhone(loginId);
        } else {
            // ç”¨æˆ·åç™»å½•
            user = userMapper.findByUsername(loginId);
        }
        
        if (user == null) {
            throw new UsernameNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨");
        }
        
        return buildUserDetails(user);
    }
}
```

### 8.2 ç™»å½•æ—¥å¿—è®°å½•


```java
@Component
public class LoginAuditProvider implements AuthenticationProvider {
    
    @Autowired
    private UserDetailsService userDetailsService;
    
    @Autowired
    private LoginLogService loginLogService;
    
    @Autowired
    private HttpServletRequest request;
    
    @Override
    public Authentication authenticate(Authentication auth) {
        String username = auth.getName();
        
        try {
            // åŠ è½½ç”¨æˆ·
            UserDetails user = userDetailsService.loadUserByUsername(username);
            
            // éªŒè¯å¯†ç ...
            
            // è®°å½•æˆåŠŸæ—¥å¿—
            loginLogService.recordSuccess(username, getClientIp());
            
            return new UsernamePasswordAuthenticationToken(user, null, user.getAuthorities());
            
        } catch (Exception e) {
            // è®°å½•å¤±è´¥æ—¥å¿—
            loginLogService.recordFailure(username, getClientIp(), e.getMessage());
            throw e;
        }
    }
    
    private String getClientIp() {
        String ip = request.getHeader("X-Forwarded-For");
        return ip != null ? ip : request.getRemoteAddr();
    }
}
```

### 8.3 å¼‚å¸¸ç™»å½•æ£€æµ‹


```java
@Component
public class LoginSecurityProvider implements AuthenticationProvider {
    
    @Autowired
    private RedisTemplate<String, Integer> redisTemplate;
    
    @Override
    public Authentication authenticate(Authentication auth) {
        String username = auth.getName();
        String ip = getClientIp();
        
        // 1. æ£€æŸ¥ç™»å½•å¤±è´¥æ¬¡æ•°
        String failKey = "login:fail:" + username;
        Integer failCount = redisTemplate.opsForValue().get(failKey);
        
        if (failCount != null && failCount >= 5) {
            throw new LockedException("ç™»å½•å¤±è´¥æ¬¡æ•°è¿‡å¤šï¼Œè´¦å·å·²é”å®š30åˆ†é’Ÿ");
        }
        
        // 2. æ£€æŸ¥å¼‚åœ°ç™»å½•
        String lastIpKey = "login:lastip:" + username;
        String lastIp = redisTemplate.opsForValue().get(lastIpKey);
        
        if (lastIp != null && !lastIp.equals(ip)) {
            // å‘é€å¼‚åœ°ç™»å½•é€šçŸ¥
            sendLoginAlert(username, ip);
        }
        
        try {
            // æ‰§è¡Œæ­£å¸¸è®¤è¯æµç¨‹...
            UserDetails user = userDetailsService.loadUserByUsername(username);
            
            // è®¤è¯æˆåŠŸï¼Œæ¸…é™¤å¤±è´¥æ¬¡æ•°ï¼Œæ›´æ–°ç™»å½•IP
            redisTemplate.delete(failKey);
            redisTemplate.opsForValue().set(lastIpKey, ip, 7, TimeUnit.DAYS);
            
            return new UsernamePasswordAuthenticationToken(user, null, user.getAuthorities());
            
        } catch (BadCredentialsException e) {
            // ç™»å½•å¤±è´¥ï¼Œå¢åŠ å¤±è´¥æ¬¡æ•°
            redisTemplate.opsForValue().increment(failKey);
            redisTemplate.expire(failKey, 30, TimeUnit.MINUTES);
            throw e;
        }
    }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ UserDetailsServiceï¼šè´Ÿè´£ä»æ•°æ®åº“åŠ è½½ç”¨æˆ·ä¿¡æ¯
ğŸ”¸ UserDetailsï¼šå°è£…ç”¨æˆ·ä¿¡æ¯çš„æ ‡å‡†å¯¹è±¡
ğŸ”¸ AuthenticationProviderï¼šè´Ÿè´£æ‰§è¡Œè®¤è¯é€»è¾‘
ğŸ”¸ PasswordEncoderï¼šå¯†ç åŠ å¯†å·¥å…·
ğŸ”¸ GrantedAuthorityï¼šæƒé™å¯¹è±¡ï¼ˆè§’è‰²å’Œæƒé™ï¼‰
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ è®¤è¯æµç¨‹æœ¬è´¨**
```
1. ç”¨æˆ·æäº¤ç”¨æˆ·åå¯†ç 
2. UserDetailsServiceæ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ·
3. è·å–åˆ°UserDetailså¯¹è±¡ï¼ˆåŒ…å«åŠ å¯†å¯†ç ï¼‰
4. AuthenticationProvideræ¯”å¯¹å¯†ç 
5. å¯†ç æ­£ç¡®è¿”å›è®¤è¯æˆåŠŸçš„Authenticationå¯¹è±¡
6. å¯†ç é”™è¯¯æŠ›å‡ºå¼‚å¸¸
```

**ğŸ”¹ è‡ªå®šä¹‰çš„æ ¸å¿ƒä»·å€¼**
- UserDetailsServiceï¼šè®©è®¤è¯æ•°æ®æ¥è‡ªæ•°æ®åº“è€Œéé…ç½®æ–‡ä»¶
- AuthenticationProviderï¼šå¯ä»¥æ·»åŠ é¢å¤–çš„è®¤è¯é€»è¾‘
- è‡ªå®šä¹‰UserDetailsï¼šå¯ä»¥æºå¸¦ä¸šåŠ¡å­—æ®µæ–¹ä¾¿ä½¿ç”¨

**ğŸ”¹ æƒé™è®¾è®¡è¦ç‚¹**
- è§’è‰²åŠ `ROLE_`å‰ç¼€ï¼š`ROLE_ADMIN`
- æƒé™ç”¨å†’å·åˆ†éš”ï¼š`user:add`ã€`order:view`
- ä¸€ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªè§’è‰²ï¼Œä¸€ä¸ªè§’è‰²å¯ä»¥æœ‰å¤šä¸ªæƒé™

### 9.3 å®é™…åº”ç”¨ä»·å€¼


**å…¸å‹åº”ç”¨åœºæ™¯ï¼š**
- âœ… ç”¨æˆ·æ•°æ®å­˜å‚¨åœ¨MySQLæ•°æ®åº“
- âœ… æ”¯æŒç”¨æˆ·å/æ‰‹æœºå·/é‚®ç®±å¤šç§ç™»å½•æ–¹å¼
- âœ… å®ç°RBACæƒé™æ¨¡å‹
- âœ… è®°å½•ç™»å½•æ—¥å¿—ã€æ£€æµ‹å¼‚å¸¸ç™»å½•
- âœ… ä½¿ç”¨Redisç¼“å­˜æå‡æ€§èƒ½

**æœ€ä½³å®è·µå»ºè®®ï¼š**
```
1. ä½¿ç”¨è‡ªå®šä¹‰UserDetailsæºå¸¦ä¸šåŠ¡å­—æ®µ
2. æƒé™æ•°æ®åŠ¨æ€ä»æ•°æ®åº“åŠ è½½
3. ä½¿ç”¨Redisç¼“å­˜ç”¨æˆ·ä¿¡æ¯
4. åœ¨AuthenticationProviderä¸­æ·»åŠ ä¸šåŠ¡é€»è¾‘
5. è®°å½•ç™»å½•æ—¥å¿—ä¾¿äºå®¡è®¡
6. å®ç°ç™»å½•å¤±è´¥é”å®šæœºåˆ¶
```

### 9.4 æ ¸å¿ƒè®°å¿†


**ç†è§£è¦ç‚¹ï¼š**
- UserDetailsServiceæ˜¯**æ•°æ®åŠ è½½å™¨**ï¼ˆæŸ¥è¯¢ç”¨æˆ·ï¼‰
- AuthenticationProvideræ˜¯**éªŒè¯å™¨**ï¼ˆæ ¡éªŒå¯†ç ï¼‰
- UserDetailsæ˜¯**ç”¨æˆ·ä¿¡æ¯å¡ç‰‡**ï¼ˆåŒ…å«ç”¨æˆ·æ•°æ®ï¼‰
- GrantedAuthorityæ˜¯**æƒé™æ ‡ç­¾**ï¼ˆè§’è‰²å’Œæƒé™ï¼‰

**å®è·µå£è¯€ï¼š**
```
åŠ è½½ç”¨æˆ·é Serviceï¼ŒéªŒè¯é€»è¾‘ç”¨Provider
æƒé™è®¾è®¡è¦çµæ´»ï¼Œç¼“å­˜ä¼˜åŒ–ä¸èƒ½å°‘
æ—¥å¿—å®¡è®¡è¦å®Œå–„ï¼Œå¼‚å¸¸æ£€æµ‹ä¿å®‰å…¨
```