---
title: 1ã€è®¤è¯æµç¨‹è¯¦è§£
---
## ğŸ“š ç›®å½•

1. [è®¤è¯æµç¨‹æ¦‚è¿°](#1-è®¤è¯æµç¨‹æ¦‚è¿°)
2. [æ ¸å¿ƒè®¤è¯ç»„ä»¶è¯¦è§£](#2-æ ¸å¿ƒè®¤è¯ç»„ä»¶è¯¦è§£)
3. [è®¤è¯æµç¨‹å®Œæ•´è§£æ](#3-è®¤è¯æµç¨‹å®Œæ•´è§£æ)
4. [è®¤è¯æˆåŠŸä¸å¤±è´¥å¤„ç†](#4-è®¤è¯æˆåŠŸä¸å¤±è´¥å¤„ç†)
5. [å®æˆ˜åº”ç”¨ç¤ºä¾‹](#5-å®æˆ˜åº”ç”¨ç¤ºä¾‹)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” è®¤è¯æµç¨‹æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯è®¤è¯æµç¨‹


**ğŸ”¸ é€šä¿—ç†è§£**
```
è®¤è¯å°±åƒè¿›å…¥å…¬å¸å¤§æ¥¼ï¼š
1. ä½ åœ¨é—¨å£åˆ·å·¥å¡ï¼ˆæä¾›ç”¨æˆ·åå¯†ç ï¼‰
2. é—¨ç¦ç³»ç»ŸéªŒè¯ä½ çš„èº«ä»½ï¼ˆSpring SecurityéªŒè¯ï¼‰
3. éªŒè¯é€šè¿‡åç»™ä½ å‘è®¿å®¢ç‰Œï¼ˆç”Ÿæˆè®¤è¯å‡­è¯ï¼‰
4. ä½ æ‹¿ç€è®¿å®¢ç‰Œå°±å¯ä»¥åœ¨å…¬å¸é‡Œæ´»åŠ¨äº†ï¼ˆè®¿é—®ç³»ç»Ÿèµ„æºï¼‰

Spring Securityçš„è®¤è¯æµç¨‹ä¹Ÿæ˜¯è¿™ä¸ªé“ç†ï¼
```

**ğŸ”¸ ä¸“ä¸šå®šä¹‰**
> è®¤è¯ï¼ˆAuthenticationï¼‰æ˜¯æŒ‡éªŒè¯ç”¨æˆ·èº«ä»½çš„è¿‡ç¨‹ï¼Œç¡®è®¤"ä½ æ˜¯è°"ã€‚Spring Securityé€šè¿‡ä¸€ç³»åˆ—ç»„ä»¶åä½œï¼Œå®Œæˆä»æ¥æ”¶ç”¨æˆ·å‡­è¯åˆ°ç”Ÿæˆè®¤è¯ä»¤ç‰Œçš„å®Œæ•´æµç¨‹ã€‚

### 1.2 è®¤è¯æµç¨‹çš„æ ¸å¿ƒç›®æ ‡


| ç›®æ ‡ | è¯´æ˜ | ç±»æ¯”ç†è§£ |
|------|------|----------|
| **èº«ä»½éªŒè¯** | ç¡®è®¤ç”¨æˆ·æ˜¯å¦æ˜¯ä»–æ‰€å£°ç§°çš„é‚£ä¸ªäºº | åˆ·è„¸è¿›é—¨ï¼Œç¡®è®¤æ˜¯æœ¬äºº |
| **ç”Ÿæˆå‡­è¯** | ä¸ºéªŒè¯é€šè¿‡çš„ç”¨æˆ·ç”Ÿæˆè®¤è¯ä»¤ç‰Œ | å‘æ”¾é—¨ç¦å¡ |
| **ä¿å­˜çŠ¶æ€** | å°†è®¤è¯ä¿¡æ¯å­˜å‚¨åˆ°ä¸Šä¸‹æ–‡ä¸­ | ç³»ç»Ÿè®°å½•ä½ å·²ç™»å½• |
| **æƒé™å‡†å¤‡** | ä¸ºåç»­çš„æƒé™éªŒè¯åšå‡†å¤‡ | è®°å½•ä½ çš„è®¿é—®æƒé™ç­‰çº§ |

### 1.3 è®¤è¯æµç¨‹æ¶æ„å›¾


```
ç”¨æˆ·ç™»å½•è¯·æ±‚
    â†“
[1] UsernamePasswordAuthenticationFilter æ‹¦æˆª
    â†“
[2] å°è£…æˆ UsernamePasswordAuthenticationToken
    â†“
[3] AuthenticationManager å¼€å§‹è®¤è¯
    â†“
[4] è°ƒç”¨ UserDetailsService æŸ¥è¯¢ç”¨æˆ·
    â†“
[5] PasswordEncoder éªŒè¯å¯†ç 
    â†“
    â”œâ”€â†’ éªŒè¯æˆåŠŸ â†’ AuthenticationSuccessHandler
    â”‚                  â†“
    â”‚            SecurityContext ä¿å­˜è®¤è¯ä¿¡æ¯
    â”‚                  â†“
    â”‚              è¿”å›æˆåŠŸå“åº”
    â”‚
    â””â”€â†’ éªŒè¯å¤±è´¥ â†’ AuthenticationFailureHandler
                       â†“
                   è¿”å›å¤±è´¥å“åº”
```

---

## 2. ğŸ§© æ ¸å¿ƒè®¤è¯ç»„ä»¶è¯¦è§£


### 2.1 Authentication æ¥å£ - è®¤è¯ä¿¡æ¯çš„è½½ä½“


**ğŸ”¸ æ ¸å¿ƒæ¦‚å¿µ**
```
Authenticationå°±åƒä½ çš„"èº«ä»½è¯æ˜æ–‡ä»¶"ï¼ŒåŒ…å«äº†ï¼š
- ä½ æ˜¯è°ï¼ˆPrincipalï¼‰
- ä½ çš„å¯†ç ï¼ˆCredentialsï¼‰
- ä½ æœ‰ä»€ä¹ˆæƒé™ï¼ˆAuthoritiesï¼‰
- å…¶ä»–èº«ä»½ç›¸å…³ä¿¡æ¯ï¼ˆDetailsï¼‰
```

**ğŸ”¸ æ¥å£ç»“æ„**
```java
public interface Authentication {
    // è·å–ç”¨æˆ·æƒé™åˆ—è¡¨
    Collection<? extends GrantedAuthority> getAuthorities();
    
    // è·å–å‡­è¯ï¼ˆé€šå¸¸æ˜¯å¯†ç ï¼‰
    Object getCredentials();
    
    // è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
    Object getDetails();
    
    // è·å–ä¸»ä½“ï¼ˆé€šå¸¸æ˜¯ç”¨æˆ·åæˆ–ç”¨æˆ·å¯¹è±¡ï¼‰
    Object getPrincipal();
    
    // æ˜¯å¦å·²è®¤è¯
    boolean isAuthenticated();
    
    // è®¾ç½®è®¤è¯çŠ¶æ€
    void setAuthenticated(boolean isAuthenticated);
}
```

**ğŸ’¡ å…³é”®å­—æ®µç†è§£**

| å­—æ®µ | ä½œç”¨ | ä¸¾ä¾‹è¯´æ˜ |
|------|------|----------|
| **Principal** | ä¸»ä½“ï¼Œä»£è¡¨ç”¨æˆ·èº«ä»½ | ç”¨æˆ·å"zhangsan"æˆ–å®Œæ•´Userå¯¹è±¡ |
| **Credentials** | å‡­è¯ï¼Œé€šå¸¸æ˜¯å¯†ç  | "123456"ï¼ˆè®¤è¯åä¼šè¢«æ¸…é™¤ï¼‰ |
| **Authorities** | æƒé™åˆ—è¡¨ | [ROLE_USER, ROLE_ADMIN] |
| **Details** | é¢å¤–ä¿¡æ¯ | ç™»å½•IPã€Session IDç­‰ |

### 2.2 UsernamePasswordAuthenticationToken - ç”¨æˆ·åå¯†ç è®¤è¯ä»¤ç‰Œ


**ğŸ”¸ åŒæ€è®¾è®¡ç†å¿µ**

```
è®¤è¯å‰çš„Tokenï¼ˆæœªè®¤è¯çŠ¶æ€ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Principal: "zhangsan"       â”‚  â†’ ç”¨æˆ·è¾“å…¥çš„ç”¨æˆ·å
â”‚ Credentials: "123456"       â”‚  â†’ ç”¨æˆ·è¾“å…¥çš„å¯†ç 
â”‚ Authenticated: false        â”‚  â†’ æ ‡è®°ä¸ºæœªè®¤è¯
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è®¤è¯åçš„Tokenï¼ˆå·²è®¤è¯çŠ¶æ€ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Principal: Userå¯¹è±¡         â”‚  â†’ å®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯
â”‚ Credentials: null           â”‚  â†’ å¯†ç å·²æ¸…é™¤
â”‚ Authorities: [æƒé™åˆ—è¡¨]      â”‚  â†’ ç”¨æˆ·çš„æ‰€æœ‰æƒé™
â”‚ Authenticated: true         â”‚  â†’ æ ‡è®°ä¸ºå·²è®¤è¯
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”¸ åˆ›å»ºæ–¹å¼**

```java
// æ–¹å¼1ï¼šåˆ›å»ºæœªè®¤è¯çš„Tokenï¼ˆç”¨äºè®¤è¯å‰ï¼‰
UsernamePasswordAuthenticationToken unauthenticated = 
    new UsernamePasswordAuthenticationToken(
        "zhangsan",  // ç”¨æˆ·å
        "123456"     // å¯†ç 
    );

// æ–¹å¼2ï¼šåˆ›å»ºå·²è®¤è¯çš„Tokenï¼ˆç”¨äºè®¤è¯æˆåŠŸåï¼‰
UsernamePasswordAuthenticationToken authenticated = 
    new UsernamePasswordAuthenticationToken(
        userDetails,      // ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
        null,            // å¯†ç æ¸…ç©º
        authorities      // æƒé™åˆ—è¡¨
    );
```

> âš ï¸ **é‡è¦æç¤º**ï¼šè®¤è¯æˆåŠŸåï¼Œå¯†ç ä¼šè¢«æ¸…é™¤ï¼Œé¿å…åœ¨å†…å­˜ä¸­é•¿æœŸä¿å­˜æ•æ„Ÿä¿¡æ¯

### 2.3 Principal å’Œ Credentials è¯¦è§£


**ğŸ”¸ Principalï¼ˆä¸»ä½“ï¼‰- ä½ æ˜¯è°**

```
Principalå°±åƒä½ çš„"åç‰‡"ï¼š

è®¤è¯å‰ï¼š
Principal = "zhangsan"ï¼ˆåªæ˜¯ä¸ªå­—ç¬¦ä¸²ç”¨æˆ·åï¼‰

è®¤è¯åï¼š
Principal = UserDetailså¯¹è±¡ {
    username: "zhangsan",
    password: "åŠ å¯†åçš„å¯†ç ",
    authorities: [æƒé™åˆ—è¡¨],
    enabled: true,
    accountNonExpired: true,
    ...
}
```

**ğŸ”¸ Credentialsï¼ˆå‡­è¯ï¼‰- ä½ çš„è¯æ˜**

```
Credentialså°±åƒä½ çš„"å¯†ç æœ¬"ï¼š

è®¤è¯è¿‡ç¨‹ï¼š
è¾“å…¥å¯†ç  â†’ ç¼–ç å™¨åŠ å¯† â†’ ä¸æ•°æ®åº“å¯¹æ¯” â†’ éªŒè¯æˆåŠŸ â†’ æ¸…é™¤å¯†ç 

å®‰å…¨è®¾è®¡ï¼š
è®¤è¯å‰ï¼šcredentials = "123456"
è®¤è¯åï¼šcredentials = nullï¼ˆé˜²æ­¢æ³„éœ²ï¼‰
```

**ğŸ§  è®°å¿†æŠ€å·§**
```
Principal = ä¸»è§’ï¼ˆä½ æ˜¯è°ï¼‰
Credentials = è¯ä»¶ï¼ˆæ€ä¹ˆè¯æ˜ï¼‰

å°±åƒï¼š
Principal = "èº«ä»½è¯ä¸Šçš„åå­—"
Credentials = "ä½ çš„æŒ‡çº¹æˆ–å¯†ç "
```

---

## 3. ğŸ”„ è®¤è¯æµç¨‹å®Œæ•´è§£æ


### 3.1 è®¤è¯è¯·æ±‚å¤„ç†æµç¨‹


**ğŸ”¸ ç¬¬ä¸€æ­¥ï¼šè¿‡æ»¤å™¨æ‹¦æˆªè¯·æ±‚**

```
ç”¨æˆ·æäº¤ç™»å½•è¡¨å•
    â†“
POST /login
{
    "username": "zhangsan",
    "password": "123456"
}
    â†“
UsernamePasswordAuthenticationFilter æ‹¦æˆª
```

**æ ¸å¿ƒä»£ç è§£æï¼š**
```java
public class UsernamePasswordAuthenticationFilter extends AbstractAuthenticationProcessingFilter {
    
    @Override
    public Authentication attemptAuthentication(HttpServletRequest request, 
                                               HttpServletResponse response) {
        // 1. ä»è¯·æ±‚ä¸­æå–ç”¨æˆ·åå’Œå¯†ç 
        String username = request.getParameter("username");
        String password = request.getParameter("password");
        
        // 2. åˆ›å»ºæœªè®¤è¯çš„Token
        UsernamePasswordAuthenticationToken authRequest = 
            new UsernamePasswordAuthenticationToken(username, password);
        
        // 3. è®¾ç½®é¢å¤–ä¿¡æ¯ï¼ˆIPåœ°å€ç­‰ï¼‰
        setDetails(request, authRequest);
        
        // 4. äº¤ç»™è®¤è¯ç®¡ç†å™¨å¤„ç†
        return this.getAuthenticationManager().authenticate(authRequest);
    }
}
```

**ğŸ”¸ ç¬¬äºŒæ­¥ï¼šè®¤è¯ç®¡ç†å™¨åè°ƒè®¤è¯**

```
AuthenticationManager çš„å·¥ä½œæµç¨‹ï¼š
    â†“
1. æ¥æ”¶ UsernamePasswordAuthenticationToken
    â†“
2. éå†æ‰€æœ‰ AuthenticationProvider
    â†“
3. æ‰¾åˆ°æ”¯æŒè¯¥Tokenç±»å‹çš„Provider
    â†“
4. è°ƒç”¨ Provider æ‰§è¡Œè®¤è¯
```

**ğŸ”¸ ç¬¬ä¸‰æ­¥ï¼šæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯**

```java
// UserDetailsService è´Ÿè´£åŠ è½½ç”¨æˆ·
public interface UserDetailsService {
    UserDetails loadUserByUsername(String username) 
        throws UsernameNotFoundException;
}

// å®ç°ç¤ºä¾‹
@Service
public class CustomUserDetailsService implements UserDetailsService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Override
    public UserDetails loadUserByUsername(String username) {
        // ä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·
        User user = userRepository.findByUsername(username)
            .orElseThrow(() -> new UsernameNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨"));
        
        // è½¬æ¢ä¸º UserDetails
        return new org.springframework.security.core.userdetails.User(
            user.getUsername(),
            user.getPassword(),
            user.getAuthorities()
        );
    }
}
```

**ğŸ”¸ ç¬¬å››æ­¥ï¼šå¯†ç éªŒè¯**

```
å¯†ç éªŒè¯æµç¨‹ï¼š
    â†“
ç”¨æˆ·è¾“å…¥å¯†ç ï¼š"123456"
    â†“
PasswordEncoder åŠ å¯†ï¼š"{bcrypt}$2a$10$..."
    â†“
ä¸æ•°æ®åº“å­˜å‚¨çš„å¯†ç å¯¹æ¯”
    â†“
åŒ¹é…æˆåŠŸ â†’ è®¤è¯é€šè¿‡
åŒ¹é…å¤±è´¥ â†’ æŠ›å‡ºå¼‚å¸¸
```

### 3.2 è®¤è¯æµç¨‹æ—¶åºå›¾


```
ç”¨æˆ·          Filter          Manager         Provider        UserDetailsService
 |              |                |                |                    |
 |--ç™»å½•è¯·æ±‚--â†’ |                |                |                    |
 |              |                |                |                    |
 |              |--åˆ›å»ºToken--â†’ |                |                    |
 |              |                |                |                    |
 |              |                |--å¼€å§‹è®¤è¯--â†’  |                    |
 |              |                |                |                    |
 |              |                |                |--æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯--â†’  |
 |              |                |                |                    |
 |              |                |                |â†--è¿”å›UserDetails--|
 |              |                |                |                    |
 |              |                |                |--éªŒè¯å¯†ç           |
 |              |                |                |                    |
 |              |                |â†--è®¤è¯ç»“æœ-----|                    |
 |              |                |                |                    |
 |              |â†--è¿”å›Token----|                |                    |
 |              |                |                |                    |
 |â†--ç™»å½•æˆåŠŸ---|                |                |                    |
```

### 3.3 è®¤è¯è¿‡ç¨‹ä¸­çš„æ•°æ®è½¬æ¢


```
æ•°æ®æµè½¬è¿‡ç¨‹ï¼š

[1] ç”¨æˆ·è¾“å…¥
    username: "zhangsan"
    password: "123456"
    â†“
[2] å°è£…ä¸ºTokenï¼ˆæœªè®¤è¯ï¼‰
    UsernamePasswordAuthenticationToken {
        principal: "zhangsan",
        credentials: "123456",
        authenticated: false
    }
    â†“
[3] åŠ è½½ç”¨æˆ·ä¿¡æ¯
    UserDetails {
        username: "zhangsan",
        password: "{bcrypt}$2a$10$...",
        authorities: [...],
        enabled: true
    }
    â†“
[4] å¯†ç éªŒè¯é€šè¿‡åç”ŸæˆTokenï¼ˆå·²è®¤è¯ï¼‰
    UsernamePasswordAuthenticationToken {
        principal: UserDetailså¯¹è±¡,
        credentials: null,
        authorities: [ROLE_USER, ROLE_ADMIN],
        authenticated: true
    }
```

---

## 4. âœ… è®¤è¯æˆåŠŸä¸å¤±è´¥å¤„ç†


### 4.1 è®¤è¯æˆåŠŸå¤„ç†å™¨


**ğŸ”¸ æ ¸å¿ƒæ¥å£**
```java
public interface AuthenticationSuccessHandler {
    void onAuthenticationSuccess(HttpServletRequest request,
                                HttpServletResponse response,
                                Authentication authentication) 
                                throws IOException, ServletException;
}
```

**ğŸ”¸ å¸¸è§å¤„ç†æ–¹å¼**

| å¤„ç†æ–¹å¼ | é€‚ç”¨åœºæ™¯ | å®ç°è¯´æ˜ |
|----------|----------|----------|
| **è·³è½¬é¡µé¢** | ä¼ ç»ŸWebåº”ç”¨ | é‡å®šå‘åˆ°é¦–é¡µæˆ–æŒ‡å®šé¡µé¢ |
| **è¿”å›JSON** | å‰åç«¯åˆ†ç¦» | è¿”å›åŒ…å«tokençš„JSONå“åº” |
| **ç”ŸæˆJWT** | æ— çŠ¶æ€è®¤è¯ | ç”ŸæˆJWTä»¤ç‰Œè¿”å›ç»™å®¢æˆ·ç«¯ |
| **è®°å½•æ—¥å¿—** | å®‰å…¨å®¡è®¡ | è®°å½•ç™»å½•æ—¶é—´ã€IPç­‰ä¿¡æ¯ |

**ğŸ”¸ è‡ªå®šä¹‰æˆåŠŸå¤„ç†å™¨**
```java
@Component
public class CustomAuthenticationSuccessHandler 
    implements AuthenticationSuccessHandler {
    
    @Override
    public void onAuthenticationSuccess(HttpServletRequest request,
                                       HttpServletResponse response,
                                       Authentication authentication) {
        // 1. è·å–è®¤è¯ç”¨æˆ·ä¿¡æ¯
        UserDetails user = (UserDetails) authentication.getPrincipal();
        
        // 2. ç”ŸæˆJWT Tokenï¼ˆç¤ºä¾‹ï¼‰
        String token = jwtUtil.generateToken(user.getUsername());
        
        // 3. æ„é€ è¿”å›æ•°æ®
        Map<String, Object> result = new HashMap<>();
        result.put("code", 200);
        result.put("message", "ç™»å½•æˆåŠŸ");
        result.put("token", token);
        result.put("username", user.getUsername());
        
        // 4. è¿”å›JSONå“åº”
        response.setContentType("application/json;charset=UTF-8");
        response.getWriter().write(JSON.toJSONString(result));
    }
}
```

**ğŸ’¡ æˆåŠŸå¤„ç†æµç¨‹å›¾**
```
è®¤è¯æˆåŠŸ
    â†“
è°ƒç”¨ SuccessHandler
    â†“
    â”œâ”€â†’ ç”ŸæˆToken/Session
    â”‚
    â”œâ”€â†’ è®°å½•ç™»å½•æ—¥å¿—
    â”‚
    â”œâ”€â†’ ä¿å­˜åˆ°SecurityContext
    â”‚
    â””â”€â†’ è¿”å›å“åº”ç»™ç”¨æˆ·
```

### 4.2 è®¤è¯å¤±è´¥å¤„ç†å™¨


**ğŸ”¸ æ ¸å¿ƒæ¥å£**
```java
public interface AuthenticationFailureHandler {
    void onAuthenticationFailure(HttpServletRequest request,
                                HttpServletResponse response,
                                AuthenticationException exception) 
                                throws IOException, ServletException;
}
```

**ğŸ”¸ å¸¸è§å¤±è´¥åœºæ™¯**

```
è®¤è¯å¤±è´¥çš„å‡ ç§æƒ…å†µï¼š

ğŸ”´ ç”¨æˆ·åä¸å­˜åœ¨
   â†’ UsernameNotFoundException
   â†’ æç¤º"ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"

ğŸ”´ å¯†ç é”™è¯¯
   â†’ BadCredentialsException  
   â†’ æç¤º"ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"

ğŸ”´ è´¦æˆ·è¢«é”å®š
   â†’ LockedException
   â†’ æç¤º"è´¦æˆ·å·²è¢«é”å®šï¼Œè¯·è”ç³»ç®¡ç†å‘˜"

ğŸ”´ è´¦æˆ·å·²è¿‡æœŸ
   â†’ AccountExpiredException
   â†’ æç¤º"è´¦æˆ·å·²è¿‡æœŸ"

ğŸ”´ å‡­è¯è¿‡æœŸ
   â†’ CredentialsExpiredException
   â†’ æç¤º"å¯†ç å·²è¿‡æœŸï¼Œè¯·ä¿®æ”¹å¯†ç "
```

**ğŸ”¸ è‡ªå®šä¹‰å¤±è´¥å¤„ç†å™¨**
```java
@Component
public class CustomAuthenticationFailureHandler 
    implements AuthenticationFailureHandler {
    
    @Override
    public void onAuthenticationFailure(HttpServletRequest request,
                                       HttpServletResponse response,
                                       AuthenticationException exception) {
        
        // æ ¹æ®å¼‚å¸¸ç±»å‹è¿”å›ä¸åŒçš„é”™è¯¯ä¿¡æ¯
        String message;
        if (exception instanceof UsernameNotFoundException) {
            message = "ç”¨æˆ·åä¸å­˜åœ¨";
        } else if (exception instanceof BadCredentialsException) {
            message = "å¯†ç é”™è¯¯";
        } else if (exception instanceof LockedException) {
            message = "è´¦æˆ·å·²è¢«é”å®š";
        } else {
            message = "è®¤è¯å¤±è´¥ï¼š" + exception.getMessage();
        }
        
        // æ„é€ é”™è¯¯å“åº”
        Map<String, Object> result = new HashMap<>();
        result.put("code", 401);
        result.put("message", message);
        
        response.setContentType("application/json;charset=UTF-8");
        response.getWriter().write(JSON.toJSONString(result));
    }
}
```

> âš ï¸ **å®‰å…¨æç¤º**ï¼šä¸ºäº†é˜²æ­¢ç”¨æˆ·åæšä¸¾æ”»å‡»ï¼Œé€šå¸¸ç”¨æˆ·åä¸å­˜åœ¨å’Œå¯†ç é”™è¯¯è¿”å›ç›¸åŒçš„æç¤ºä¿¡æ¯

### 4.3 å¤„ç†å™¨é…ç½®æ–¹å¼


```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Autowired
    private CustomAuthenticationSuccessHandler successHandler;
    
    @Autowired
    private CustomAuthenticationFailureHandler failureHandler;
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .formLogin(form -> form
                .loginProcessingUrl("/login")
                .successHandler(successHandler)    // é…ç½®æˆåŠŸå¤„ç†å™¨
                .failureHandler(failureHandler)    // é…ç½®å¤±è´¥å¤„ç†å™¨
            );
        
        return http.build();
    }
}
```

---

## 5. ğŸ’¼ å®æˆ˜åº”ç”¨ç¤ºä¾‹


### 5.1 å®Œæ•´è®¤è¯æµç¨‹å®ç°


**åœºæ™¯ï¼šå‰åç«¯åˆ†ç¦»é¡¹ç›®çš„ç”¨æˆ·ç™»å½•**

**æ­¥éª¤1ï¼šè‡ªå®šä¹‰UserDetailsService**
```java
@Service
public class UserService implements UserDetailsService {
    
    @Autowired
    private UserMapper userMapper;
    
    @Override
    public UserDetails loadUserByUsername(String username) {
        // æŸ¥è¯¢æ•°æ®åº“
        User user = userMapper.findByUsername(username);
        if (user == null) {
            throw new UsernameNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨");
        }
        
        // æŸ¥è¯¢ç”¨æˆ·æƒé™
        List<String> permissions = userMapper.findPermissionsByUserId(user.getId());
        List<GrantedAuthority> authorities = permissions.stream()
            .map(SimpleGrantedAuthority::new)
            .collect(Collectors.toList());
        
        // è¿”å›UserDetails
        return new org.springframework.security.core.userdetails.User(
            user.getUsername(),
            user.getPassword(),
            authorities
        );
    }
}
```

**æ­¥éª¤2ï¼šé…ç½®å¯†ç ç¼–ç å™¨**
```java
@Configuration
public class SecurityConfig {
    
    @Bean
    public PasswordEncoder passwordEncoder() {
        // ä½¿ç”¨BCryptåŠ å¯†
        return new BCryptPasswordEncoder();
    }
}
```

**æ­¥éª¤3ï¼šé…ç½®è®¤è¯ç®¡ç†å™¨**
```java
@Configuration
public class SecurityConfig {
    
    @Bean
    public AuthenticationManager authenticationManager(
            AuthenticationConfiguration config) throws Exception {
        return config.getAuthenticationManager();
    }
}
```

### 5.2 æ‰‹åŠ¨è§¦å‘è®¤è¯


**åº”ç”¨åœºæ™¯ï¼šè‡ªå®šä¹‰ç™»å½•æ¥å£ï¼ˆä¸ä½¿ç”¨Spring Securityé»˜è®¤ç™»å½•ï¼‰**

```java
@RestController
@RequestMapping("/auth")
public class AuthController {
    
    @Autowired
    private AuthenticationManager authenticationManager;
    
    @PostMapping("/login")
    public Result login(@RequestBody LoginRequest request) {
        try {
            // 1. åˆ›å»ºæœªè®¤è¯çš„Token
            UsernamePasswordAuthenticationToken authToken = 
                new UsernamePasswordAuthenticationToken(
                    request.getUsername(),
                    request.getPassword()
                );
            
            // 2. æ‰§è¡Œè®¤è¯
            Authentication authentication = 
                authenticationManager.authenticate(authToken);
            
            // 3. è®¤è¯æˆåŠŸï¼Œä¿å­˜åˆ°ä¸Šä¸‹æ–‡
            SecurityContextHolder.getContext()
                .setAuthentication(authentication);
            
            // 4. ç”ŸæˆJWT Token
            String token = jwtUtil.generateToken(request.getUsername());
            
            // 5. è¿”å›æˆåŠŸç»“æœ
            return Result.success()
                .data("token", token)
                .data("username", request.getUsername());
                
        } catch (AuthenticationException e) {
            return Result.error("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
        }
    }
}
```

### 5.3 è®¤è¯æµç¨‹è°ƒè¯•æŠ€å·§


**ğŸ” è°ƒè¯•æ£€æŸ¥ç‚¹**

```
è°ƒè¯•æµç¨‹å»ºè®®ï¼š

1ï¸âƒ£ è¿‡æ»¤å™¨å…¥å£
   æ–­ç‚¹ä½ç½®ï¼šUsernamePasswordAuthenticationFilter.attemptAuthentication()
   æ£€æŸ¥å†…å®¹ï¼šç”¨æˆ·åã€å¯†ç æ˜¯å¦æ­£ç¡®æ¥æ”¶

2ï¸âƒ£ Tokenåˆ›å»º
   æ–­ç‚¹ä½ç½®ï¼šnew UsernamePasswordAuthenticationToken(...)
   æ£€æŸ¥å†…å®¹ï¼šprincipalå’Œcredentialsæ˜¯å¦æ­£ç¡®å°è£…

3ï¸âƒ£ ç”¨æˆ·æŸ¥è¯¢
   æ–­ç‚¹ä½ç½®ï¼šUserDetailsService.loadUserByUsername()
   æ£€æŸ¥å†…å®¹ï¼šæ•°æ®åº“æŸ¥è¯¢æ˜¯å¦æˆåŠŸï¼Œè¿”å›çš„UserDetailsæ˜¯å¦æ­£ç¡®

4ï¸âƒ£ å¯†ç éªŒè¯
   æ–­ç‚¹ä½ç½®ï¼šPasswordEncoder.matches()
   æ£€æŸ¥å†…å®¹ï¼šå¯†ç åŠ å¯†ç»“æœæ˜¯å¦åŒ¹é…

5ï¸âƒ£ è®¤è¯ç»“æœ
   æ–­ç‚¹ä½ç½®ï¼šAuthenticationSuccessHandler/FailureHandler
   æ£€æŸ¥å†…å®¹ï¼šæœ€ç»ˆçš„Authenticationå¯¹è±¡å†…å®¹
```

**ğŸ“ æ—¥å¿—é…ç½®**
```yaml
# application.yml
logging:
  level:
    org.springframework.security: DEBUG
    # å¯ä»¥çœ‹åˆ°å®Œæ•´çš„è®¤è¯æµç¨‹æ—¥å¿—
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ”¸ äº”å¤§æ ¸å¿ƒç»„ä»¶**
```
1. Authentication
   â†’ è®¤è¯ä¿¡æ¯çš„è½½ä½“ï¼ŒåŒ…å«ç”¨æˆ·èº«ä»½ã€å‡­è¯ã€æƒé™

2. UsernamePasswordAuthenticationToken  
   â†’ ç”¨æˆ·åå¯†ç è®¤è¯çš„å…·ä½“å®ç°ï¼ŒåŒæ€è®¾è®¡ï¼ˆè®¤è¯å‰/åï¼‰

3. Principal
   â†’ ä¸»ä½“ï¼Œä»£è¡¨ç”¨æˆ·èº«ä»½ï¼ˆè®¤è¯å‰æ˜¯ç”¨æˆ·åï¼Œè®¤è¯åæ˜¯UserDetailsï¼‰

4. Credentials
   â†’ å‡­è¯ï¼Œé€šå¸¸æ˜¯å¯†ç ï¼ˆè®¤è¯æˆåŠŸåä¼šæ¸…é™¤ï¼‰

5. AuthenticationManager
   â†’ è®¤è¯ç®¡ç†å™¨ï¼Œåè°ƒæ•´ä¸ªè®¤è¯æµç¨‹
```

**ğŸ”¸ è®¤è¯æµç¨‹å…³é”®æ­¥éª¤**
```
ç”¨æˆ·ç™»å½• 
  â†’ è¿‡æ»¤å™¨æ‹¦æˆª 
  â†’ åˆ›å»ºToken 
  â†’ æŸ¥è¯¢ç”¨æˆ· 
  â†’ éªŒè¯å¯†ç  
  â†’ ç”Ÿæˆè®¤è¯ä¿¡æ¯ 
  â†’ ä¿å­˜ä¸Šä¸‹æ–‡ 
  â†’ è¿”å›ç»“æœ
```

### 6.2 å®è·µè¦ç‚¹


**âœ… å¼€å‘æ£€æŸ¥æ¸…å•**
- [ ] UserDetailsServiceå·²å®ç°ï¼Œèƒ½æ­£ç¡®æŸ¥è¯¢ç”¨æˆ·
- [ ] PasswordEncoderå·²é…ç½®ï¼Œå¯†ç åŠ å¯†æ–¹å¼æ­£ç¡®
- [ ] AuthenticationManagerå·²æ³¨å…¥ï¼Œå¯ä»¥æ‰‹åŠ¨è®¤è¯
- [ ] æˆåŠŸ/å¤±è´¥å¤„ç†å™¨å·²è‡ªå®šä¹‰ï¼Œè¿”å›ç¬¦åˆéœ€æ±‚
- [ ] SecurityContextå·²ä¿å­˜è®¤è¯ä¿¡æ¯

**ğŸ¯ å¸¸è§é—®é¢˜è§£å†³**

| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| å¯†ç æ€»æ˜¯éªŒè¯å¤±è´¥ | åŠ å¯†æ–¹å¼ä¸åŒ¹é… | æ£€æŸ¥PasswordEncoderé…ç½® |
| ç”¨æˆ·ä¿¡æ¯ä¸¢å¤± | æœªä¿å­˜åˆ°Context | è°ƒç”¨SecurityContextHolder.setAuthentication() |
| æƒé™ä¸ç”Ÿæ•ˆ | Authoritiesæœªè®¾ç½® | åœ¨UserDetailsä¸­æ·»åŠ æƒé™åˆ—è¡¨ |
| è‡ªå®šä¹‰ç™»å½•æ¥å£ä¸ç”Ÿæ•ˆ | è¿‡æ»¤å™¨é…ç½®é”™è¯¯ | æ£€æŸ¥loginProcessingUrlé…ç½® |

### 6.3 ä¸€å¥è¯ç²¾å


**ğŸ§  æ ¸å¿ƒè®°å¿†**
```
è®¤è¯æµç¨‹ = æ‹¦æˆªè¯·æ±‚ â†’ å°è£…Token â†’ æŸ¥ç”¨æˆ· â†’ éªŒå¯†ç  â†’ ç”Ÿæˆå‡­è¯
Principal = ä½ æ˜¯è°ï¼ŒCredentials = è¯æ˜ä½ æ˜¯è°
Tokenæœªè®¤è¯æ—¶å­˜å¯†ç ï¼Œè®¤è¯åå­˜ç”¨æˆ·ä¿¡æ¯å¹¶æ¸…ç©ºå¯†ç 
```

**ğŸ“ å­¦ä¹ å»ºè®®**
- å…ˆç†è§£è®¤è¯å’Œæˆæƒçš„åŒºåˆ«ï¼ˆè®¤è¯æ˜¯"ä½ æ˜¯è°"ï¼Œæˆæƒæ˜¯"ä½ èƒ½å¹²ä»€ä¹ˆ"ï¼‰
- é‡ç‚¹æŒæ¡Authenticationå¯¹è±¡çš„çŠ¶æ€å˜åŒ–
- å¤šè°ƒè¯•å‡ æ¬¡å®Œæ•´æµç¨‹ï¼Œè§‚å¯Ÿæ•°æ®æµè½¬
- ç»“åˆå®é™…é¡¹ç›®éœ€æ±‚é€‰æ‹©åˆé€‚çš„å¤„ç†å™¨å®ç°

---

## ğŸ“š ç›¸å…³é˜…è¯»

- ä¸‹ä¸€èŠ‚ï¼š[æˆæƒæœºåˆ¶è¯¦è§£](#)
- ç›¸å…³ç¬”è®°ï¼š[JWTä»¤ç‰Œè®¤è¯](#)
- æ¨èé˜…è¯»ï¼šã€ŠSpring Securityå®æˆ˜ã€‹ç¬¬3ç« 