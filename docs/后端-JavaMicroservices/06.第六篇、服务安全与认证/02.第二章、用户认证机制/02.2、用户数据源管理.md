---
title: 2ã€ç”¨æˆ·æ•°æ®æºç®¡ç†
---
## ğŸ“š ç›®å½•

1. [ç”¨æˆ·æ•°æ®æºç®¡ç†æ¦‚è¿°](#1-ç”¨æˆ·æ•°æ®æºç®¡ç†æ¦‚è¿°)
2. [UserDetailsç”¨æˆ·è¯¦æƒ…æ¥å£](#2-UserDetailsç”¨æˆ·è¯¦æƒ…æ¥å£)
3. [UserDetailsServiceç”¨æˆ·è¯¦æƒ…æœåŠ¡](#3-UserDetailsServiceç”¨æˆ·è¯¦æƒ…æœåŠ¡)
4. [å†…å­˜ç”¨æˆ·ç®¡ç†](#4-å†…å­˜ç”¨æˆ·ç®¡ç†)
5. [JDBCç”¨æˆ·ç®¡ç†](#5-JDBCç”¨æˆ·ç®¡ç†)
6. [ç”¨æˆ·è¡¨è®¾è®¡å®è·µ](#6-ç”¨æˆ·è¡¨è®¾è®¡å®è·µ)
7. [ç”¨æˆ·çŠ¶æ€ç®¡ç†](#7-ç”¨æˆ·çŠ¶æ€ç®¡ç†)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” ç”¨æˆ·æ•°æ®æºç®¡ç†æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯ç”¨æˆ·æ•°æ®æºç®¡ç†


**é€šä¿—ç†è§£**ï¼š
```
å°±åƒé…’åº—å‰å°éœ€è¦æŸ¥è¯¢å®¢äººä¿¡æ¯ä¸€æ ·ï¼š

å‰å°ï¼ˆSpring Securityï¼‰é—®ï¼š"è¿™ä½å®¢äººçš„æˆ¿å¡å¯†ç æ˜¯å¤šå°‘ï¼Ÿæœ‰æ²¡æœ‰VIPæƒé™ï¼Ÿ"
å®¢æˆ¿ç®¡ç†ç³»ç»Ÿï¼ˆç”¨æˆ·æ•°æ®æºï¼‰ç­”ï¼š"å¯†ç æ˜¯1234ï¼Œæ˜¯æ™®é€šå®¢äººï¼Œå¯ä»¥ç”¨å¥èº«æˆ¿"

ç”¨æˆ·æ•°æ®æº = å­˜æ”¾ç”¨æˆ·ä¿¡æ¯çš„åœ°æ–¹
ç®¡ç† = æ€ä¹ˆæŸ¥è¯¢ã€æ€ä¹ˆéªŒè¯ç”¨æˆ·ä¿¡æ¯
```

**æ ¸å¿ƒä½œç”¨**ï¼š
- ğŸ“‚ **å­˜å‚¨ç”¨æˆ·ä¿¡æ¯**ï¼šç”¨æˆ·åã€å¯†ç ã€æƒé™ç­‰
- ğŸ” **æä¾›æŸ¥è¯¢æ¥å£**ï¼šæ ¹æ®ç”¨æˆ·åæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯
- âœ… **æ”¯æŒèº«ä»½éªŒè¯**ï¼šè®©Spring Securityèƒ½éªŒè¯ç”¨æˆ·èº«ä»½

### 1.2 ç”¨æˆ·æ•°æ®æºçš„åˆ†ç±»


```
ç”¨æˆ·ä¿¡æ¯å¯ä»¥å­˜åœ¨ä¸åŒåœ°æ–¹ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ç”¨æˆ·æ•°æ®æºç±»å‹              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“ å†…å­˜å­˜å‚¨ (InMemoryUserDetails)  â”‚ â† é€‚åˆæµ‹è¯•ã€å°å‹åº”ç”¨
â”‚  ğŸ—„ï¸ æ•°æ®åº“å­˜å‚¨ (JdbcUserDetails)     â”‚ â† é€‚åˆç”Ÿäº§ç¯å¢ƒ
â”‚  ğŸ”— LDAP/ADå­˜å‚¨                      â”‚ â† é€‚åˆä¼ä¸šé›†æˆ
â”‚  â˜ï¸ ç¬¬ä¸‰æ–¹è®¤è¯ (OAuth2/SSO)         â”‚ â† é€‚åˆå¤šç³»ç»Ÿé›†æˆ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> ğŸ’¡ **æ–°æ‰‹å»ºè®®**ï¼šå…ˆä»å†…å­˜å­˜å‚¨å­¦èµ·ï¼Œç†è§£åŸç†åå†ç”¨æ•°æ®åº“å­˜å‚¨

---

## 2. ğŸ‘¤ UserDetailsç”¨æˆ·è¯¦æƒ…æ¥å£


### 2.1 UserDetailsæ˜¯ä»€ä¹ˆ


**æœ¬è´¨ç†è§£**ï¼š
```
UserDetails = ä¸€å¼ "ç”¨æˆ·ä¿¡æ¯å¡ç‰‡"

å°±åƒèº«ä»½è¯åŒ…å«ï¼šå§“åã€æ€§åˆ«ã€å‡ºç”Ÿæ—¥æœŸ
UserDetailsåŒ…å«ï¼šç”¨æˆ·åã€å¯†ç ã€æƒé™ã€è´¦æˆ·çŠ¶æ€

Spring Securityè¯´ï¼š"ç»™æˆ‘ä¸€å¼ ç”¨æˆ·å¡ç‰‡ï¼Œæˆ‘å°±çŸ¥é“è¿™ä¸ªäººèƒ½ä¸èƒ½ç™»å½•"
```

### 2.2 UserDetailsåŒ…å«å“ªäº›ä¿¡æ¯


```java
// UserDetailsæ¥å£å®šä¹‰äº†è¿™äº›æ–¹æ³•
public interface UserDetails {
    String getUsername();        // ç”¨æˆ·å
    String getPassword();        // å¯†ç 
    Collection<? extends GrantedAuthority> getAuthorities();  // æƒé™åˆ—è¡¨
    
    boolean isAccountNonExpired();     // è´¦æˆ·æ²¡è¿‡æœŸ?
    boolean isAccountNonLocked();      // è´¦æˆ·æ²¡é”å®š?
    boolean isCredentialsNonExpired(); // å¯†ç æ²¡è¿‡æœŸ?
    boolean isEnabled();               // è´¦æˆ·å¯ç”¨?
}
```

**å­—æ®µå«ä¹‰è¯¦è§£**ï¼š

| å­—æ®µ | é€šä¿—è§£é‡Š | è¿”å›falseä¼šæ€æ · |
|------|---------|----------------|
| `getUsername()` | ç”¨æˆ·ç™»å½•å | - |
| `getPassword()` | ç”¨æˆ·å¯†ç ï¼ˆåŠ å¯†åçš„ï¼‰ | - |
| `getAuthorities()` | è¿™ä¸ªç”¨æˆ·æœ‰å“ªäº›æƒé™ | - |
| `isEnabled()` | è´¦æˆ·æ˜¯å¦å¯ç”¨ | âŒ ç¦æ­¢ç™»å½•ï¼š"è´¦æˆ·å·²ç¦ç”¨" |
| `isAccountNonLocked()` | è´¦æˆ·æ˜¯å¦æœªé”å®š | âŒ ç¦æ­¢ç™»å½•ï¼š"è´¦æˆ·å·²é”å®š" |
| `isAccountNonExpired()` | è´¦æˆ·æ˜¯å¦æœªè¿‡æœŸ | âŒ ç¦æ­¢ç™»å½•ï¼š"è´¦æˆ·å·²è¿‡æœŸ" |
| `isCredentialsNonExpired()` | å¯†ç æ˜¯å¦æœªè¿‡æœŸ | âŒ ç¦æ­¢ç™»å½•ï¼š"å¯†ç å·²è¿‡æœŸ" |

> âš ï¸ **æ³¨æ„**ï¼šè¿™4ä¸ªiså¼€å¤´çš„æ–¹æ³•ï¼Œè¿”å›`true`æ‰è¡¨ç¤ºæ­£å¸¸ï¼Œè¿”å›`false`å°±ä¼šé˜»æ­¢ç™»å½•

### 2.3 è‡ªå®šä¹‰UserDetailså®ç°


**æ–¹å¼ä¸€ï¼šä½¿ç”¨Springæä¾›çš„Userç±»**
```java
// Springæä¾›çš„ç°æˆå®ç°ï¼Œæœ€ç®€å•
import org.springframework.security.core.userdetails.User;

UserDetails user = User.builder()
    .username("zhangsan")
    .password("{noop}123456")  // {noop}è¡¨ç¤ºæ˜æ–‡å¯†ç 
    .roles("USER")              // è§’è‰²ï¼šæ™®é€šç”¨æˆ·
    .build();
```

**æ–¹å¼äºŒï¼šè‡ªå·±å®ç°UserDetailsæ¥å£**
```java
// é€‚åˆéœ€è¦è‡ªå®šä¹‰å­—æ®µçš„åœºæ™¯
public class MyUser implements UserDetails {
    
    private String username;
    private String password;
    private String email;        // é¢å¤–å­—æ®µï¼šé‚®ç®±
    private String phone;        // é¢å¤–å­—æ®µï¼šæ‰‹æœºå·
    private boolean enabled;
    private List<GrantedAuthority> authorities;
    
    @Override
    public String getUsername() {
        return this.username;
    }
    
    @Override
    public String getPassword() {
        return this.password;
    }
    
    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() {
        return this.authorities;
    }
    
    @Override
    public boolean isEnabled() {
        return this.enabled;  // æ ¹æ®æ•°æ®åº“å­—æ®µè¿”å›
    }
    
    @Override
    public boolean isAccountNonLocked() {
        return true;  // æš‚æ—¶ä¸è€ƒè™‘é”å®šåŠŸèƒ½
    }
    
    @Override
    public boolean isAccountNonExpired() {
        return true;  // æš‚æ—¶ä¸è€ƒè™‘è¿‡æœŸåŠŸèƒ½
    }
    
    @Override
    public boolean isCredentialsNonExpired() {
        return true;  // æš‚æ—¶ä¸è€ƒè™‘å¯†ç è¿‡æœŸ
    }
}
```

---

## 3. ğŸ” UserDetailsServiceç”¨æˆ·è¯¦æƒ…æœåŠ¡


### 3.1 UserDetailsServiceæ˜¯ä»€ä¹ˆ


**é€šä¿—ç†è§£**ï¼š
```
è®¤è¯æµç¨‹ï¼š

1. ç”¨æˆ·è¾“å…¥ï¼šç”¨æˆ·å=zhangsanï¼Œå¯†ç =123456
2. Spring Securityé—®ï¼š"zhangsanè¿™ä¸ªç”¨æˆ·çš„ä¿¡æ¯æ˜¯ä»€ä¹ˆï¼Ÿ"
3. UserDetailsServiceç­”ï¼š"è¿™æ˜¯zhangsançš„è¯¦ç»†ä¿¡æ¯ï¼ˆUserDetailså¯¹è±¡ï¼‰"
4. Spring Securityæ‹¿ç€ä¿¡æ¯å»éªŒè¯å¯†ç 

UserDetailsService = "ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢å‘˜"
å®ƒçš„å·¥ä½œå°±æ˜¯ï¼šç»™æˆ‘ç”¨æˆ·åï¼Œæˆ‘ç»™ä½ ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
```

### 3.2 UserDetailsServiceæ¥å£å®šä¹‰


```java
public interface UserDetailsService {
    // æ ¹æ®ç”¨æˆ·ååŠ è½½ç”¨æˆ·ä¿¡æ¯
    UserDetails loadUserByUsername(String username) 
        throws UsernameNotFoundException;
}
```

> ğŸ¯ **æ ¸å¿ƒæ–¹æ³•**ï¼š`loadUserByUsername` - è¿™æ˜¯å”¯ä¸€è¦å®ç°çš„æ–¹æ³•

### 3.3 å·¥ä½œæµç¨‹å›¾ç¤º


```
ç™»å½•è¯·æ±‚æµç¨‹ï¼š

ç”¨æˆ·æäº¤ç™»å½•è¡¨å•
    â”‚
    â”œâ”€ username: zhangsan
    â””â”€ password: 123456
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Spring Security        â”‚
â”‚  è°ƒç”¨ loadUserByUsernameâ”‚
â”‚  ä¼ å…¥: "zhangsan"       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  UserDetailsService     â”‚
â”‚  æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯            â”‚
â”‚  è¿”å›: UserDetailså¯¹è±¡  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Spring Security        â”‚
â”‚  æ¯”å¯¹å¯†ç                 â”‚
â”‚  å¯†ç æ­£ç¡®â†’ç™»å½•æˆåŠŸ      â”‚
â”‚  å¯†ç é”™è¯¯â†’ç™»å½•å¤±è´¥      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.4 è‡ªå®šä¹‰UserDetailsService


```java
@Service
public class MyUserDetailsService implements UserDetailsService {
    
    @Autowired
    private UserMapper userMapper;  // å‡è®¾æœ‰ä¸ªæŸ¥è¯¢ç”¨æˆ·çš„Mapper
    
    @Override
    public UserDetails loadUserByUsername(String username) 
        throws UsernameNotFoundException {
        
        // 1. ä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·
        User dbUser = userMapper.findByUsername(username);
        
        // 2. ç”¨æˆ·ä¸å­˜åœ¨ï¼ŒæŠ›å‡ºå¼‚å¸¸
        if (dbUser == null) {
            throw new UsernameNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨: " + username);
        }
        
        // 3. æŸ¥è¯¢ç”¨æˆ·çš„æƒé™
        List<String> permissions = userMapper.findPermissionsByUserId(dbUser.getId());
        
        // 4. å°†æƒé™è½¬æ¢ä¸ºGrantedAuthority
        List<GrantedAuthority> authorities = permissions.stream()
            .map(SimpleGrantedAuthority::new)
            .collect(Collectors.toList());
        
        // 5. æ„å»ºUserDetailså¯¹è±¡è¿”å›
        return User.builder()
            .username(dbUser.getUsername())
            .password(dbUser.getPassword())
            .authorities(authorities)
            .disabled(!dbUser.isEnabled())  // æ˜¯å¦ç¦ç”¨
            .build();
    }
}
```

> ğŸ’¡ **å…³é”®ç‚¹**ï¼šè¿™ä¸ªæ–¹æ³•åªè´Ÿè´£æŸ¥è¯¢å’Œè¿”å›ç”¨æˆ·ä¿¡æ¯ï¼Œå¯†ç éªŒè¯æ˜¯Spring Securityè‡ªåŠ¨å®Œæˆçš„

---

## 4. ğŸ’¾ å†…å­˜ç”¨æˆ·ç®¡ç†


### 4.1 ä»€ä¹ˆæ˜¯å†…å­˜ç”¨æˆ·ç®¡ç†


**é€šä¿—ç†è§£**ï¼š
```
å†…å­˜ç”¨æˆ·ç®¡ç† = æŠŠç”¨æˆ·ä¿¡æ¯å†™æ­»åœ¨ä»£ç é‡Œ

ä¼˜ç‚¹ï¼šç®€å•ã€å¿«é€Ÿï¼Œé€‚åˆå­¦ä¹ å’Œæµ‹è¯•
ç¼ºç‚¹ï¼šé‡å¯å°±ä¸¢å¤±ï¼Œæ— æ³•åŠ¨æ€æ·»åŠ ç”¨æˆ·

é€‚ç”¨åœºæ™¯ï¼š
âœ… å¼€å‘æµ‹è¯•ç¯å¢ƒ
âœ… æ¼”ç¤ºé¡¹ç›®
âœ… ç”¨æˆ·æ•°é‡å›ºå®šä¸”å¾ˆå°‘ï¼ˆå¦‚ç®¡ç†å‘˜è´¦å·ï¼‰

ä¸é€‚ç”¨åœºæ™¯ï¼š
âŒ ç”Ÿäº§ç¯å¢ƒ
âŒ éœ€è¦æ³¨å†ŒåŠŸèƒ½çš„ç³»ç»Ÿ
âŒ ç”¨æˆ·æ•°é‡å¤šçš„ç³»ç»Ÿ
```

### 4.2 InMemoryUserDetailsManagerä½¿ç”¨


**åŸºç¡€é…ç½®ç¤ºä¾‹**ï¼š
```java
@Configuration
public class SecurityConfig {
    
    @Bean
    public UserDetailsService userDetailsService() {
        // åˆ›å»ºå†…å­˜ç”¨æˆ·ç®¡ç†å™¨
        InMemoryUserDetailsManager manager = new InMemoryUserDetailsManager();
        
        // æ·»åŠ ç”¨æˆ·1ï¼šæ™®é€šç”¨æˆ·
        manager.createUser(
            User.builder()
                .username("zhangsan")
                .password("{noop}123456")  // {noop}è¡¨ç¤ºä¸åŠ å¯†
                .roles("USER")             // è§’è‰²ï¼šUSER
                .build()
        );
        
        // æ·»åŠ ç”¨æˆ·2ï¼šç®¡ç†å‘˜
        manager.createUser(
            User.builder()
                .username("admin")
                .password("{noop}admin123")
                .roles("ADMIN", "USER")    // å¤šä¸ªè§’è‰²
                .build()
        );
        
        return manager;
    }
}
```

### 4.3 å¯†ç ç¼–ç å™¨è¯´æ˜


```
å¯†ç å‰ç¼€è¯´æ˜ï¼š

{noop}123456     â†’ æ˜æ–‡å¯†ç ï¼ˆä¸æ¨èï¼Œä»…æµ‹è¯•ç”¨ï¼‰
{bcrypt}$2a$...  â†’ BCryptåŠ å¯†
{sha256}...      â†’ SHA-256åŠ å¯†

æ¨èç”Ÿäº§ç¯å¢ƒé…ç½®ï¼š
```

```java
@Bean
public PasswordEncoder passwordEncoder() {
    return new BCryptPasswordEncoder();
}

@Bean
public UserDetailsService userDetailsService(PasswordEncoder encoder) {
    InMemoryUserDetailsManager manager = new InMemoryUserDetailsManager();
    
    manager.createUser(
        User.builder()
            .username("zhangsan")
            .password(encoder.encode("123456"))  // åŠ å¯†åå­˜å‚¨
            .roles("USER")
            .build()
    );
    
    return manager;
}
```

### 4.4 å†…å­˜ç”¨æˆ·ç®¡ç†çš„å±€é™æ€§


| é™åˆ¶ | è¯´æ˜ | è§£å†³æ–¹æ¡ˆ |
|------|------|---------|
| ğŸ”„ é‡å¯ä¸¢å¤± | æœåŠ¡é‡å¯åç”¨æˆ·æ•°æ®æ¶ˆå¤± | ä½¿ç”¨æ•°æ®åº“å­˜å‚¨ |
| âŒ æ— æ³•åŠ¨æ€æ·»åŠ  | ä¸æ”¯æŒç”¨æˆ·æ³¨å†ŒåŠŸèƒ½ | ä½¿ç”¨JdbcUserDetailsManager |
| ğŸ“ˆ ä¸æ”¯æŒå¤§é‡ç”¨æˆ· | æ‰€æœ‰ç”¨æˆ·åŠ è½½åˆ°å†…å­˜ | ä½¿ç”¨æ•°æ®åº“+ç¼“å­˜ |
| ğŸ”’ å®‰å…¨æ€§ä½ | å¯†ç å†™åœ¨ä»£ç é‡Œ | ä½¿ç”¨é…ç½®ä¸­å¿ƒæˆ–æ•°æ®åº“ |

---

## 5. ğŸ—„ï¸ JDBCç”¨æˆ·ç®¡ç†


### 5.1 ä»€ä¹ˆæ˜¯JDBCç”¨æˆ·ç®¡ç†


**é€šä¿—ç†è§£**ï¼š
```
JDBCç”¨æˆ·ç®¡ç† = æŠŠç”¨æˆ·ä¿¡æ¯å­˜åˆ°æ•°æ®åº“

ä¼˜ç‚¹ï¼š
âœ… æ•°æ®æŒä¹…åŒ–ï¼Œé‡å¯ä¸ä¸¢å¤±
âœ… æ”¯æŒåŠ¨æ€æ·»åŠ /ä¿®æ”¹/åˆ é™¤ç”¨æˆ·
âœ… æ”¯æŒå¤§é‡ç”¨æˆ·
âœ… ç¬¦åˆç”Ÿäº§ç¯å¢ƒè¦æ±‚

å·¥ä½œæµç¨‹ï¼š
ç”¨æˆ·ç™»å½• â†’ Spring Security â†’ JdbcUserDetailsManager â†’ æŸ¥è¯¢æ•°æ®åº“ â†’ è¿”å›ç”¨æˆ·ä¿¡æ¯
```

### 5.2 JdbcUserDetailsManageråŸºç¡€ä½¿ç”¨


**æ­¥éª¤1ï¼šæ·»åŠ ä¾èµ–**
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-jdbc</artifactId>
</dependency>
<dependency>
    <groupId>mysql</groupId>
    <artifactId>mysql-connector-java</artifactId>
</dependency>
```

**æ­¥éª¤2ï¼šé…ç½®æ•°æ®æº**
```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/security_db
    username: root
    password: 123456
    driver-class-name: com.mysql.cj.jdbc.Driver
```

**æ­¥éª¤3ï¼šåˆ›å»ºJdbcUserDetailsManager**
```java
@Configuration
public class SecurityConfig {
    
    @Autowired
    private DataSource dataSource;
    
    @Bean
    public UserDetailsService userDetailsService() {
        // åˆ›å»ºJDBCç”¨æˆ·ç®¡ç†å™¨
        JdbcUserDetailsManager manager = new JdbcUserDetailsManager(dataSource);
        
        // å¦‚æœæ•°æ®åº“ä¸ºç©ºï¼Œåˆå§‹åŒ–ä¸€ä¸ªç®¡ç†å‘˜ç”¨æˆ·
        if (!manager.userExists("admin")) {
            manager.createUser(
                User.builder()
                    .username("admin")
                    .password(passwordEncoder().encode("admin123"))
                    .roles("ADMIN")
                    .build()
            );
        }
        
        return manager;
    }
    
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
}
```

### 5.3 Spring Securityé»˜è®¤è¡¨ç»“æ„


**JdbcUserDetailsManageréœ€è¦çš„è¡¨**ï¼š

```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE users (
    username VARCHAR(50) NOT NULL PRIMARY KEY,
    password VARCHAR(500) NOT NULL,
    enabled BOOLEAN NOT NULL
);

-- æƒé™è¡¨
CREATE TABLE authorities (
    username VARCHAR(50) NOT NULL,
    authority VARCHAR(50) NOT NULL,
    CONSTRAINT fk_authorities_users 
        FOREIGN KEY(username) REFERENCES users(username)
);

-- ç»„è¡¨ï¼ˆå¯é€‰ï¼‰
CREATE TABLE groups (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    group_name VARCHAR(50) NOT NULL
);

-- ç»„æƒé™è¡¨ï¼ˆå¯é€‰ï¼‰
CREATE TABLE group_authorities (
    group_id BIGINT NOT NULL,
    authority VARCHAR(50) NOT NULL,
    CONSTRAINT fk_group_authorities_group 
        FOREIGN KEY(group_id) REFERENCES groups(id)
);

-- ç»„æˆå‘˜è¡¨ï¼ˆå¯é€‰ï¼‰
CREATE TABLE group_members (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) NOT NULL,
    group_id BIGINT NOT NULL,
    CONSTRAINT fk_group_members_group 
        FOREIGN KEY(group_id) REFERENCES groups(id)
);
```

> âš ï¸ **é‡è¦**ï¼šè¡¨åå’Œå­—æ®µåå¿…é¡»ä¸¥æ ¼æŒ‰ç…§Spring Securityçš„è¦æ±‚ï¼Œå¦åˆ™éœ€è¦è‡ªå®šä¹‰SQL

### 5.4 è‡ªå®šä¹‰SQLæŸ¥è¯¢


```java
@Bean
public UserDetailsService userDetailsService() {
    JdbcUserDetailsManager manager = new JdbcUserDetailsManager(dataSource);
    
    // è‡ªå®šä¹‰æŸ¥è¯¢ç”¨æˆ·SQL
    manager.setUsersByUsernameQuery(
        "SELECT username, password, enabled FROM my_users WHERE username = ?"
    );
    
    // è‡ªå®šä¹‰æŸ¥è¯¢æƒé™SQL
    manager.setAuthoritiesByUsernameQuery(
        "SELECT username, authority FROM my_authorities WHERE username = ?"
    );
    
    return manager;
}
```

---

## 6. ğŸ—ï¸ ç”¨æˆ·è¡¨è®¾è®¡å®è·µ


### 6.1 å®é™…ç”Ÿäº§ç¯å¢ƒè¡¨è®¾è®¡


**ç”¨æˆ·è¡¨ï¼ˆsys_userï¼‰**ï¼š
```sql
CREATE TABLE sys_user (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
    username VARCHAR(50) NOT NULL UNIQUE COMMENT 'ç”¨æˆ·å',
    password VARCHAR(500) NOT NULL COMMENT 'å¯†ç ï¼ˆBCryptåŠ å¯†ï¼‰',
    nickname VARCHAR(50) COMMENT 'æ˜µç§°',
    email VARCHAR(100) COMMENT 'é‚®ç®±',
    phone VARCHAR(20) COMMENT 'æ‰‹æœºå·',
    avatar VARCHAR(500) COMMENT 'å¤´åƒURL',
    enabled TINYINT(1) DEFAULT 1 COMMENT 'æ˜¯å¦å¯ç”¨ï¼š1-å¯ç”¨ 0-ç¦ç”¨',
    locked TINYINT(1) DEFAULT 0 COMMENT 'æ˜¯å¦é”å®šï¼š1-é”å®š 0-æœªé”å®š',
    account_expired TINYINT(1) DEFAULT 0 COMMENT 'æ˜¯å¦è¿‡æœŸï¼š1-è¿‡æœŸ 0-æœªè¿‡æœŸ',
    credentials_expired TINYINT(1) DEFAULT 0 COMMENT 'å¯†ç æ˜¯å¦è¿‡æœŸï¼š1-è¿‡æœŸ 0-æœªè¿‡æœŸ',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    last_login_time DATETIME COMMENT 'æœ€åç™»å½•æ—¶é—´',
    INDEX idx_username (username),
    INDEX idx_email (email)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç”¨æˆ·è¡¨';
```

**è§’è‰²è¡¨ï¼ˆsys_roleï¼‰**ï¼š
```sql
CREATE TABLE sys_role (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
    role_name VARCHAR(50) NOT NULL UNIQUE COMMENT 'è§’è‰²åç§°',
    role_code VARCHAR(50) NOT NULL UNIQUE COMMENT 'è§’è‰²ç¼–ç ',
    description VARCHAR(200) COMMENT 'è§’è‰²æè¿°',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    INDEX idx_role_code (role_code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è§’è‰²è¡¨';
```

**æƒé™è¡¨ï¼ˆsys_permissionï¼‰**ï¼š
```sql
CREATE TABLE sys_permission (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
    permission_name VARCHAR(50) NOT NULL COMMENT 'æƒé™åç§°',
    permission_code VARCHAR(100) NOT NULL UNIQUE COMMENT 'æƒé™ç¼–ç ',
    resource_type VARCHAR(20) COMMENT 'èµ„æºç±»å‹ï¼šmenu/button/api',
    url VARCHAR(200) COMMENT 'èµ„æºè·¯å¾„',
    method VARCHAR(10) COMMENT 'è¯·æ±‚æ–¹æ³•ï¼šGET/POST/PUT/DELETE',
    description VARCHAR(200) COMMENT 'æƒé™æè¿°',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    INDEX idx_permission_code (permission_code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æƒé™è¡¨';
```

**ç”¨æˆ·è§’è‰²å…³è”è¡¨ï¼ˆsys_user_roleï¼‰**ï¼š
```sql
CREATE TABLE sys_user_role (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
    role_id BIGINT NOT NULL COMMENT 'è§’è‰²ID',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    UNIQUE KEY uk_user_role (user_id, role_id),
    INDEX idx_user_id (user_id),
    INDEX idx_role_id (role_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç”¨æˆ·è§’è‰²å…³è”è¡¨';
```

**è§’è‰²æƒé™å…³è”è¡¨ï¼ˆsys_role_permissionï¼‰**ï¼š
```sql
CREATE TABLE sys_role_permission (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    role_id BIGINT NOT NULL COMMENT 'è§’è‰²ID',
    permission_id BIGINT NOT NULL COMMENT 'æƒé™ID',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    UNIQUE KEY uk_role_permission (role_id, permission_id),
    INDEX idx_role_id (role_id),
    INDEX idx_permission_id (permission_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è§’è‰²æƒé™å…³è”è¡¨';
```

### 6.2 è¡¨å…³ç³»å›¾ç¤º


```
è¡¨å…³ç³»ç»“æ„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  sys_user    â”‚ 1     n â”‚  sys_user_role   â”‚ n     1 â”‚  sys_role    â”‚
â”‚              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”¤                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚              â”‚
â”‚ id           â”‚         â”‚ user_id          â”‚         â”‚ id           â”‚
â”‚ username     â”‚         â”‚ role_id          â”‚         â”‚ role_name    â”‚
â”‚ password     â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ role_code    â”‚
â”‚ enabled      â”‚                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ locked       â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚ 1
                                                             â”‚
                                                             â”‚ n
                                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                               â”‚ sys_role_permission  â”‚
                                               â”‚                      â”‚
                                               â”‚ role_id              â”‚
                                               â”‚ permission_id        â”‚
                                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                             â”‚ n
                                                             â”‚
                                                             â”‚ 1
                                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                      â”‚sys_permissionâ”‚
                                                      â”‚              â”‚
                                                      â”‚ id           â”‚
                                                      â”‚ permission   â”‚
                                                      â”‚ _code        â”‚
                                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å…³ç³»è¯´æ˜ï¼š
â€¢ ä¸€ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªè§’è‰²ï¼ˆå¤šå¯¹å¤šï¼‰
â€¢ ä¸€ä¸ªè§’è‰²å¯ä»¥æœ‰å¤šä¸ªæƒé™ï¼ˆå¤šå¯¹å¤šï¼‰
â€¢ é€šè¿‡ä¸­é—´è¡¨å®ç°å¤šå¯¹å¤šå…³è”
```

### 6.3 è‡ªå®šä¹‰UserDetailsServiceå®ç°


```java
@Service
public class CustomUserDetailsService implements UserDetailsService {
    
    @Autowired
    private UserMapper userMapper;
    
    @Override
    public UserDetails loadUserByUsername(String username) 
        throws UsernameNotFoundException {
        
        // 1. æŸ¥è¯¢ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
        SysUser user = userMapper.findByUsername(username);
        if (user == null) {
            throw new UsernameNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨");
        }
        
        // 2. æŸ¥è¯¢ç”¨æˆ·çš„è§’è‰²å’Œæƒé™
        List<String> authorities = userMapper.findAuthoritiesByUserId(user.getId());
        
        // 3. æ„å»ºUserDetailså¯¹è±¡
        return new CustomUserDetails(
            user.getUsername(),
            user.getPassword(),
            user.getEnabled() == 1,
            user.getAccountExpired() == 0,
            user.getCredentialsExpired() == 0,
            user.getLocked() == 0,
            authorities.stream()
                .map(SimpleGrantedAuthority::new)
                .collect(Collectors.toList())
        );
    }
}
```

**å¯¹åº”çš„Mapper SQL**ï¼š
```xml
<!-- æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ -->
<select id="findByUsername" resultType="SysUser">
    SELECT * FROM sys_user WHERE username = #{username}
</select>

<!-- æŸ¥è¯¢ç”¨æˆ·çš„æ‰€æœ‰æƒé™ï¼ˆåŒ…æ‹¬è§’è‰²ï¼‰ -->
<select id="findAuthoritiesByUserId" resultType="String">
    SELECT DISTINCT p.permission_code
    FROM sys_permission p
    INNER JOIN sys_role_permission rp ON p.id = rp.permission_id
    INNER JOIN sys_user_role ur ON rp.role_id = ur.role_id
    WHERE ur.user_id = #{userId}
    
    UNION
    
    SELECT CONCAT('ROLE_', r.role_code)
    FROM sys_role r
    INNER JOIN sys_user_role ur ON r.id = ur.role_id
    WHERE ur.user_id = #{userId}
</select>
```

---

## 7. âš™ï¸ ç”¨æˆ·çŠ¶æ€ç®¡ç†


### 7.1 å››ç§ç”¨æˆ·çŠ¶æ€è¯¦è§£


**çŠ¶æ€ç®¡ç†å…¨æ™¯**ï¼š

| çŠ¶æ€å­—æ®µ | æ•°æ®åº“å­—æ®µ | å«ä¹‰ | ä½¿ç”¨åœºæ™¯ |
|---------|-----------|------|----------|
| **enabled** | `enabled` | è´¦æˆ·æ˜¯å¦å¯ç”¨ | ğŸ’¡ å°ç¦ç”¨æˆ·ã€æ‰¹é‡ç¦ç”¨ |
| **accountNonLocked** | `locked` | è´¦æˆ·æ˜¯å¦æœªé”å®š | ğŸ”’ ç™»å½•å¤±è´¥æ¬¡æ•°è¿‡å¤šè‡ªåŠ¨é”å®š |
| **accountNonExpired** | `account_expired` | è´¦æˆ·æ˜¯å¦æœªè¿‡æœŸ | â° ä¸´æ—¶è´¦æˆ·ã€è¯•ç”¨æœŸè´¦æˆ· |
| **credentialsNonExpired** | `credentials_expired` | å¯†ç æ˜¯å¦æœªè¿‡æœŸ | ğŸ” å¼ºåˆ¶å®šæœŸä¿®æ”¹å¯†ç  |

### 7.2 enabled - è´¦æˆ·å¯ç”¨çŠ¶æ€


**ä½¿ç”¨åœºæ™¯**ï¼š
```
åœºæ™¯1ï¼šç®¡ç†å‘˜ç¦ç”¨è¿è§„ç”¨æˆ·
åœºæ™¯2ï¼šç”¨æˆ·æ³¨é”€è´¦å·
åœºæ™¯3ï¼šæ‰¹é‡ç¦ç”¨æµ‹è¯•è´¦å·

å®ç°æ–¹å¼ï¼š
```

```java
// ç¦ç”¨ç”¨æˆ·
public void disableUser(Long userId) {
    userMapper.updateEnabled(userId, 0);
}

// å¯ç”¨ç”¨æˆ·
public void enableUser(Long userId) {
    userMapper.updateEnabled(userId, 1);
}
```

```sql
UPDATE sys_user SET enabled = 0 WHERE id = ?;
```

> ğŸ’¡ **æ•ˆæœ**ï¼š`enabled=0` æ—¶ï¼Œç”¨æˆ·ç™»å½•ä¼šæç¤º"è´¦æˆ·å·²ç¦ç”¨"

### 7.3 accountNonLocked - è´¦æˆ·é”å®šçŠ¶æ€


**ä½¿ç”¨åœºæ™¯**ï¼šç™»å½•å¤±è´¥æ¬¡æ•°è¿‡å¤šè‡ªåŠ¨é”å®š

**å®ç°ç¤ºä¾‹**ï¼š
```java
@Service
public class LoginAttemptService {
    
    // è®°å½•ç™»å½•å¤±è´¥æ¬¡æ•°ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰
    private Cache<String, Integer> attemptsCache = 
        CacheBuilder.newBuilder()
            .expireAfterWrite(1, TimeUnit.DAYS)
            .build();
    
    private static final int MAX_ATTEMPTS = 5;  // æœ€å¤§å°è¯•æ¬¡æ•°
    
    // ç™»å½•æˆåŠŸï¼Œæ¸…é™¤å¤±è´¥è®°å½•
    public void loginSucceeded(String username) {
        attemptsCache.invalidate(username);
    }
    
    // ç™»å½•å¤±è´¥ï¼Œå¢åŠ å¤±è´¥æ¬¡æ•°
    public void loginFailed(String username) {
        int attempts = attemptsCache.getIfPresent(username);
        attempts = (attempts == null) ? 1 : attempts + 1;
        attemptsCache.put(username, attempts);
        
        // è¶…è¿‡5æ¬¡ï¼Œé”å®šè´¦æˆ·
        if (attempts >= MAX_ATTEMPTS) {
            userMapper.lockAccount(username);
        }
    }
    
    // æ£€æŸ¥æ˜¯å¦è¢«é”å®š
    public boolean isBlocked(String username) {
        Integer attempts = attemptsCache.getIfPresent(username);
        return attempts != null && attempts >= MAX_ATTEMPTS;
    }
}
```

**è§£é”ç”¨æˆ·**ï¼š
```java
// ç®¡ç†å‘˜æ‰‹åŠ¨è§£é”
public void unlockUser(Long userId) {
    userMapper.updateLocked(userId, 0);
}
```

### 7.4 accountNonExpired - è´¦æˆ·è¿‡æœŸçŠ¶æ€


**ä½¿ç”¨åœºæ™¯**ï¼š
```
åœºæ™¯1ï¼šè¯•ç”¨è´¦å·ï¼Œ30å¤©åè¿‡æœŸ
åœºæ™¯2ï¼šä¸´æ—¶è®¿å®¢è´¦å·
åœºæ™¯3ï¼šæŒ‰å¹´ä»˜è´¹çš„ä¼šå‘˜è´¦å·

å®ç°æ–¹å¼ï¼š
```

```java
// åˆ›å»ºè¯•ç”¨è´¦å·ï¼ˆ30å¤©è¿‡æœŸï¼‰
public void createTrialUser(String username) {
    SysUser user = new SysUser();
    user.setUsername(username);
    user.setAccountExpireTime(LocalDateTime.now().plusDays(30));
    userMapper.insert(user);
}

// UserDetailsServiceä¸­åˆ¤æ–­è¿‡æœŸ
@Override
public UserDetails loadUserByUsername(String username) {
    SysUser user = userMapper.findByUsername(username);
    
    // åˆ¤æ–­æ˜¯å¦è¿‡æœŸ
    boolean accountNonExpired = true;
    if (user.getAccountExpireTime() != null) {
        accountNonExpired = LocalDateTime.now().isBefore(user.getAccountExpireTime());
    }
    
    return User.builder()
        .username(user.getUsername())
        .password(user.getPassword())
        .accountExpired(!accountNonExpired)  // æ³¨æ„å–å
        .build();
}
```

### 7.5 credentialsNonExpired - å¯†ç è¿‡æœŸçŠ¶æ€


**ä½¿ç”¨åœºæ™¯**ï¼šå¼ºåˆ¶å®šæœŸä¿®æ”¹å¯†ç ï¼ˆå¦‚90å¤©ï¼‰

**å®ç°ç¤ºä¾‹**ï¼š
```java
@Service
public class PasswordExpirationService {
    
    private static final int PASSWORD_EXPIRATION_DAYS = 90;
    
    // æ£€æŸ¥å¯†ç æ˜¯å¦è¿‡æœŸ
    public boolean isPasswordExpired(LocalDateTime lastPasswordChange) {
        if (lastPasswordChange == null) {
            return false;  // ä»æœªä¿®æ”¹è¿‡å¯†ç ï¼Œä¸ç®—è¿‡æœŸ
        }
        
        LocalDateTime expirationDate = lastPasswordChange.plusDays(PASSWORD_EXPIRATION_DAYS);
        return LocalDateTime.now().isAfter(expirationDate);
    }
    
    // ä¿®æ”¹å¯†ç æ—¶æ›´æ–°æ—¶é—´
    public void updatePassword(Long userId, String newPassword) {
        userMapper.updatePassword(userId, newPassword, LocalDateTime.now());
    }
}
```

```sql
-- ç”¨æˆ·è¡¨å¢åŠ å¯†ç ä¿®æ”¹æ—¶é—´å­—æ®µ
ALTER TABLE sys_user ADD COLUMN last_password_change DATETIME;

-- æ›´æ–°å¯†ç æ—¶åŒæ—¶æ›´æ–°æ—¶é—´
UPDATE sys_user 
SET password = ?, last_password_change = NOW() 
WHERE id = ?;
```

### 7.6 çŠ¶æ€ç»„åˆåœºæ™¯


**åœºæ™¯1ï¼šé¦–æ¬¡ç™»å½•å¼ºåˆ¶ä¿®æ”¹å¯†ç **
```java
@Override
public UserDetails loadUserByUsername(String username) {
    SysUser user = userMapper.findByUsername(username);
    
    // é¦–æ¬¡ç™»å½•ï¼ˆå¯†ç æœªä¿®æ”¹è¿‡ï¼‰ï¼Œæ ‡è®°å¯†ç è¿‡æœŸ
    boolean credentialsNonExpired = 
        user.getLastPasswordChange() != null;
    
    return User.builder()
        .username(user.getUsername())
        .password(user.getPassword())
        .credentialsExpired(!credentialsNonExpired)
        .build();
}
```

**åœºæ™¯2ï¼šä¼šå‘˜åˆ°æœŸè‡ªåŠ¨ç¦ç”¨**
```java
// å®šæ—¶ä»»åŠ¡ï¼šæ¯å¤©æ£€æŸ¥ä¼šå‘˜åˆ°æœŸ
@Scheduled(cron = "0 0 2 * * ?")  // æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
public void checkMembershipExpiration() {
    List<SysUser> expiredUsers = userMapper.findExpiredMembers();
    
    for (SysUser user : expiredUsers) {
        userMapper.updateEnabled(user.getId(), 0);  // ç¦ç”¨è´¦æˆ·
        // å‘é€åˆ°æœŸé€šçŸ¥é‚®ä»¶...
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ UserDetailsï¼šç”¨æˆ·ä¿¡æ¯çš„æ ‡å‡†æ ¼å¼
   â”œâ”€ åŒ…å«ï¼šç”¨æˆ·åã€å¯†ç ã€æƒé™ã€è´¦æˆ·çŠ¶æ€
   â””â”€ ä½œç”¨ï¼šSpring SecurityéªŒè¯çš„ä¾æ®

ğŸ”¸ UserDetailsServiceï¼šç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢æœåŠ¡
   â”œâ”€ æ ¸å¿ƒæ–¹æ³•ï¼šloadUserByUsername
   â””â”€ ä½œç”¨ï¼šæ ¹æ®ç”¨æˆ·ååŠ è½½ç”¨æˆ·è¯¦æƒ…

ğŸ”¸ InMemoryUserDetailsManagerï¼šå†…å­˜ç”¨æˆ·ç®¡ç†
   â”œâ”€ ä¼˜ç‚¹ï¼šç®€å•å¿«é€Ÿ
   â””â”€ ç¼ºç‚¹ï¼šä¸æŒä¹…åŒ–ï¼Œä¸é€‚åˆç”Ÿäº§ç¯å¢ƒ

ğŸ”¸ JdbcUserDetailsManagerï¼šæ•°æ®åº“ç”¨æˆ·ç®¡ç†
   â”œâ”€ ä¼˜ç‚¹ï¼šæŒä¹…åŒ–ã€æ”¯æŒåŠ¨æ€ç®¡ç†
   â””â”€ ç¼ºç‚¹ï¼šéœ€è¦é…ç½®æ•°æ®åº“å’Œè¡¨ç»“æ„
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ è®¤è¯æµç¨‹ç†è§£**
```
1. ç”¨æˆ·æäº¤ç”¨æˆ·åå’Œå¯†ç 
2. Spring Securityè°ƒç”¨ loadUserByUsername(username)
3. UserDetailsService è¿”å› UserDetails å¯¹è±¡
4. Spring Security è‡ªåŠ¨éªŒè¯å¯†ç 
5. éªŒè¯æˆåŠŸâ†’ç™»å½•æˆåŠŸï¼ŒéªŒè¯å¤±è´¥â†’ç™»å½•å¤±è´¥

å…³é”®ï¼šUserDetailsService åªè´Ÿè´£æŸ¥è¯¢ï¼Œä¸è´Ÿè´£éªŒè¯
```

**ğŸ”¹ ç”¨æˆ·çŠ¶æ€ç®¡ç†ç†è§£**
```
4ä¸ªiså¼€å¤´çš„æ–¹æ³•ï¼Œè¿”å›trueæ‰æ­£å¸¸ï¼š

isEnabled()                â†’ true=å¯ç”¨, false=ç¦ç”¨
isAccountNonLocked()       â†’ true=æœªé”å®š, false=é”å®š
isAccountNonExpired()      â†’ true=æœªè¿‡æœŸ, false=è¿‡æœŸ
isCredentialsNonExpired()  â†’ true=å¯†ç æœªè¿‡æœŸ, false=å¯†ç è¿‡æœŸ

è®°å¿†æŠ€å·§ï¼š"Non"è¡¨ç¤º"ä¸"ï¼Œè¿”å›trueè¡¨ç¤º"ä¸ç¦ç”¨ã€ä¸é”å®šã€ä¸è¿‡æœŸ"
```

**ğŸ”¹ è¡¨è®¾è®¡åŸåˆ™**
```
ç”¨æˆ·è¡¨ï¼šå­˜å‚¨ç”¨æˆ·åŸºæœ¬ä¿¡æ¯å’ŒçŠ¶æ€
è§’è‰²è¡¨ï¼šå®šä¹‰ç³»ç»Ÿä¸­çš„è§’è‰²
æƒé™è¡¨ï¼šå®šä¹‰å…·ä½“çš„æ“ä½œæƒé™
å…³è”è¡¨ï¼šç”¨æˆ·-è§’è‰²ã€è§’è‰²-æƒé™ï¼ˆå¤šå¯¹å¤šå…³ç³»ï¼‰

è®¾è®¡è¦ç‚¹ï¼š
â€¢ å­—æ®µå®Œæ•´ï¼šåŒ…å«æ‰€æœ‰å¿…è¦çš„çŠ¶æ€å­—æ®µ
â€¢ ç´¢å¼•ä¼˜åŒ–ï¼šç”¨æˆ·åã€é‚®ç®±ç­‰å¸¸æŸ¥å­—æ®µåŠ ç´¢å¼•
â€¢ æ‰©å±•æ€§å¥½ï¼šé¢„ç•™è‡ªå®šä¹‰å­—æ®µçš„ç©ºé—´
```

### 8.3 å®é™…åº”ç”¨ä»·å€¼


**å­¦ä¹ è·¯å¾„å»ºè®®**ï¼š
```
ç¬¬1æ­¥ï¼šä½¿ç”¨ InMemoryUserDetailsManager
      â””â”€ ç›®çš„ï¼šç†è§£UserDetailså’ŒUserDetailsService

ç¬¬2æ­¥ï¼šä½¿ç”¨ JdbcUserDetailsManager + é»˜è®¤è¡¨ç»“æ„
      â””â”€ ç›®çš„ï¼šç†è§£æ•°æ®åº“ç”¨æˆ·ç®¡ç†åŸç†

ç¬¬3æ­¥ï¼šè‡ªå®šä¹‰ UserDetailsService + è‡ªå·±çš„è¡¨ç»“æ„
      â””â”€ ç›®çš„ï¼šå®ç°ç”Ÿäº§ç¯å¢ƒçš„ç”¨æˆ·ç®¡ç†

ç¬¬4æ­¥ï¼šæ·»åŠ ç”¨æˆ·çŠ¶æ€ç®¡ç†
      â””â”€ ç›®çš„ï¼šå®ç°è´¦æˆ·é”å®šã€è¿‡æœŸç­‰åŠŸèƒ½
```

**ç”Ÿäº§ç¯å¢ƒæ£€æŸ¥æ¸…å•**ï¼š
```
âœ… å¯†ç å¿…é¡»åŠ å¯†å­˜å‚¨ï¼ˆBCryptï¼‰
âœ… æ•æ„Ÿæ“ä½œéœ€è¦æ—¥å¿—è®°å½•
âœ… å®ç°ç™»å½•å¤±è´¥é”å®šæœºåˆ¶
âœ… å®šæœŸæ£€æŸ¥è´¦æˆ·å’Œå¯†ç è¿‡æœŸ
âœ… æƒé™è®¾è®¡éµå¾ªæœ€å°æƒé™åŸåˆ™
âœ… ç”¨æˆ·è¡¨è®¾è®¡è€ƒè™‘æ‰©å±•æ€§
```

### 8.4 å¸¸è§é—®é¢˜è§£ç­”


**Q1ï¼šä¸ºä»€ä¹ˆè¦ç”¨UserDetailsServiceï¼Ÿ**
```
Aï¼šç»Ÿä¸€ç”¨æˆ·æŸ¥è¯¢æ¥å£ï¼ŒSpring Securityåªéœ€è°ƒç”¨è¿™ä¸€ä¸ªæ¥å£
   å°±èƒ½è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œæ— è®ºç”¨æˆ·å­˜åœ¨å“ªé‡Œï¼ˆå†…å­˜ã€æ•°æ®åº“ã€LDAPï¼‰
```

**Q2ï¼šå¯ä»¥ä¸ç”¨Spring Securityæä¾›çš„è¡¨ç»“æ„å—ï¼Ÿ**
```
Aï¼šå®Œå…¨å¯ä»¥ï¼è‡ªå®šä¹‰UserDetailsServiceï¼Œå®ç°loadUserByUsername
   æ–¹æ³•ï¼Œä»ä½ è‡ªå·±çš„è¡¨æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯å³å¯
```

**Q3ï¼šç”¨æˆ·çŠ¶æ€ç®¡ç†æ˜¯å¿…é¡»çš„å—ï¼Ÿ**
```
Aï¼šä¸æ˜¯å¿…é¡»çš„ï¼Œä½†å¼ºçƒˆæ¨è
   è‡³å°‘è¦å®ç° enabledï¼ˆå¯ç”¨/ç¦ç”¨ï¼‰åŠŸèƒ½
   ç”Ÿäº§ç¯å¢ƒå»ºè®®å®ç° lockedï¼ˆé”å®šï¼‰åŠŸèƒ½
```

**Q4ï¼šå¯†ç è¿‡æœŸåæ€ä¹ˆå¤„ç†ï¼Ÿ**
```
Aï¼šSpring Securityä¼šæŠ›å‡ºCredentialsExpiredException
   å‰ç«¯æ•è·åè·³è½¬åˆ°ä¿®æ”¹å¯†ç é¡µé¢
   ä¿®æ”¹æˆåŠŸåæ›´æ–° last_password_change æ—¶é—´
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- UserDetailsæ˜¯ç”¨æˆ·ä¿¡æ¯çš„è½½ä½“
- UserDetailsServiceæ˜¯æŸ¥è¯¢ç”¨æˆ·çš„æœåŠ¡
- å†…å­˜ç®¡ç†é€‚åˆæµ‹è¯•ï¼Œæ•°æ®åº“ç®¡ç†é€‚åˆç”Ÿäº§
- ç”¨æˆ·çŠ¶æ€ç®¡ç†è®©ç³»ç»Ÿæ›´å®‰å…¨å¯æ§