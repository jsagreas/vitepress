---
title: 3ã€æ•°æ®åº“è®¤è¯æ‰©å±•
---
## ğŸ“š ç›®å½•

1. [æ•°æ®åº“è®¤è¯åŸºç¡€æ¦‚å¿µ](#1-æ•°æ®åº“è®¤è¯åŸºç¡€æ¦‚å¿µ)
2. [ç”¨æˆ·æ•°æ®æ¨¡å‹è®¾è®¡](#2-ç”¨æˆ·æ•°æ®æ¨¡å‹è®¾è®¡)
3. [å®ç°æ•°æ®åº“ç”¨æˆ·è®¤è¯](#3-å®ç°æ•°æ®åº“ç”¨æˆ·è®¤è¯)
4. [å¤šæ•°æ®æºç”¨æˆ·ç®¡ç†](#4-å¤šæ•°æ®æºç”¨æˆ·ç®¡ç†)
5. [ç”¨æˆ·æƒé™ç¼“å­˜ç­–ç•¥](#5-ç”¨æˆ·æƒé™ç¼“å­˜ç­–ç•¥)
6. [æ•°æ®åº“å®‰å…¨é˜²æŠ¤](#6-æ•°æ®åº“å®‰å…¨é˜²æŠ¤)
7. [ç”¨æˆ·å¯†ç å®‰å…¨ç­–ç•¥](#7-ç”¨æˆ·å¯†ç å®‰å…¨ç­–ç•¥)
8. [å®¡è®¡æ—¥å¿—ä¸ç›‘æ§](#8-å®¡è®¡æ—¥å¿—ä¸ç›‘æ§)
9. [æ€§èƒ½ä¼˜åŒ–å®è·µ](#9-æ€§èƒ½ä¼˜åŒ–å®è·µ)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” æ•°æ®åº“è®¤è¯åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯æ•°æ®åº“è®¤è¯


**é€šä¿—ç†è§£**ï¼šå°±åƒä½ å»é“¶è¡ŒåŠä¸šåŠ¡éœ€è¦åˆ·èº«ä»½è¯éªŒè¯èº«ä»½ä¸€æ ·ï¼Œåº”ç”¨ç³»ç»Ÿä¹Ÿéœ€è¦éªŒè¯ç”¨æˆ·èº«ä»½ã€‚æ•°æ®åº“è®¤è¯å°±æ˜¯æŠŠç”¨æˆ·çš„è´¦å·å¯†ç ç­‰ä¿¡æ¯å­˜åœ¨æ•°æ®åº“é‡Œï¼Œç”¨æˆ·ç™»å½•æ—¶å»æ•°æ®åº“é‡ŒæŸ¥è¯¢æ¯”å¯¹ï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯æœ¬äººã€‚

```
ä¼ ç»Ÿå†…å­˜è®¤è¯ vs æ•°æ®åº“è®¤è¯ï¼š

å†…å­˜è®¤è¯ï¼ˆå†™æ­»åœ¨ä»£ç é‡Œï¼‰ï¼š
ç”¨æˆ·ç™»å½• â†’ æ£€æŸ¥ä»£ç ä¸­é¢„è®¾çš„è´¦å·å¯†ç  â†’ éªŒè¯é€šè¿‡/å¤±è´¥
ä¼˜ç‚¹ï¼šé€Ÿåº¦å¿«
ç¼ºç‚¹ï¼šæ”¹å¯†ç è¦é‡å¯æœåŠ¡ï¼Œç”¨æˆ·ä¿¡æ¯æ— æ³•åŠ¨æ€ç®¡ç†

æ•°æ®åº“è®¤è¯ï¼ˆå­˜å‚¨åœ¨æ•°æ®åº“ï¼‰ï¼š
ç”¨æˆ·ç™»å½• â†’ æŸ¥è¯¢æ•°æ®åº“ç”¨æˆ·è¡¨ â†’ æ¯”å¯¹å¯†ç  â†’ éªŒè¯é€šè¿‡/å¤±è´¥
ä¼˜ç‚¹ï¼šç”¨æˆ·ä¿¡æ¯å¯åŠ¨æ€ç®¡ç†ï¼Œæ”¯æŒå¤§é‡ç”¨æˆ·
ç¼ºç‚¹ï¼šéœ€è¦ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®åº“è®¤è¯


**å®é™…åº”ç”¨åœºæ™¯**ï¼š

| åœºæ™¯ | è¯´æ˜ | ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®åº“è®¤è¯ |
|------|------|---------------------|
| **ç”¨æˆ·æ³¨å†ŒåŠŸèƒ½** | æ–°ç”¨æˆ·è‡ªå·±æ³¨å†Œè´¦å· | éœ€è¦æŠŠæ–°ç”¨æˆ·ä¿¡æ¯å­˜åˆ°æ•°æ®åº“ |
| **åŠ¨æ€æƒé™ç®¡ç†** | ç®¡ç†å‘˜å¯ä»¥éšæ—¶è°ƒæ•´ç”¨æˆ·æƒé™ | æƒé™ä¿¡æ¯è¦èƒ½å®æ—¶ä¿®æ”¹å’ŒæŸ¥è¯¢ |
| **å¤šç³»ç»Ÿå…±äº«ç”¨æˆ·** | å¤šä¸ªç³»ç»Ÿä½¿ç”¨åŒä¸€å¥—ç”¨æˆ·ä½“ç³» | ç»Ÿä¸€ä»æ•°æ®åº“è¯»å–ç”¨æˆ·ä¿¡æ¯ |
| **ç”¨æˆ·ä¿¡æ¯å˜æ›´** | ä¿®æ”¹å¯†ç ã€æ›´æ–°èµ„æ–™ç­‰ | éœ€è¦æŒä¹…åŒ–å­˜å‚¨ç”¨æˆ·æ•°æ® |

### 1.3 è®¤è¯æµç¨‹è§£æ


**å®Œæ•´çš„ç™»å½•éªŒè¯è¿‡ç¨‹**ï¼š

```
ç”¨æˆ·ç™»å½•è¯·æ±‚
    â†“
[1] æ¥æ”¶ç”¨æˆ·åå’Œå¯†ç 
    â†“
[2] ä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
    â†“
[3] éªŒè¯å¯†ç æ˜¯å¦åŒ¹é…ï¼ˆåŠ å¯†å¯¹æ¯”ï¼‰
    â†“
[4] æ£€æŸ¥è´¦å·çŠ¶æ€ï¼ˆæ˜¯å¦é”å®šã€è¿‡æœŸç­‰ï¼‰
    â†“
[5] åŠ è½½ç”¨æˆ·æƒé™ä¿¡æ¯
    â†“
[6] åˆ›å»ºè®¤è¯ä»¤ç‰Œï¼ˆTokenï¼‰
    â†“
ç™»å½•æˆåŠŸ/å¤±è´¥å“åº”
```

**æ ¸å¿ƒç†è§£**ï¼šè®¤è¯å°±æ˜¯"éªŒæ˜æ­£èº«"çš„è¿‡ç¨‹ï¼Œæ•°æ®åº“è®¤è¯æŠŠè¿™ä¸ªéªŒè¯è¿‡ç¨‹çš„æ•°æ®æ¥æºä»ä»£ç è½¬ç§»åˆ°äº†æ•°æ®åº“ã€‚

---

## 2. ğŸ“Š ç”¨æˆ·æ•°æ®æ¨¡å‹è®¾è®¡


### 2.1 åŸºç¡€ç”¨æˆ·è¡¨è®¾è®¡


**ç”¨æˆ·è¡¨ï¼ˆsys_userï¼‰**ï¼š

```sql
-- ç”¨æˆ·åŸºç¡€ä¿¡æ¯è¡¨
CREATE TABLE sys_user (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) NOT NULL UNIQUE COMMENT 'ç™»å½•è´¦å·',
    password VARCHAR(200) NOT NULL COMMENT 'åŠ å¯†åçš„å¯†ç ',
    nickname VARCHAR(50) COMMENT 'ç”¨æˆ·æ˜µç§°',
    email VARCHAR(100) COMMENT 'é‚®ç®±',
    phone VARCHAR(20) COMMENT 'æ‰‹æœºå·',
    
    -- è´¦å·çŠ¶æ€å­—æ®µ
    enabled TINYINT DEFAULT 1 COMMENT 'æ˜¯å¦å¯ç”¨ï¼š1-å¯ç”¨ 0-ç¦ç”¨',
    account_locked TINYINT DEFAULT 0 COMMENT 'æ˜¯å¦é”å®šï¼š1-é”å®š 0-æ­£å¸¸',
    
    -- æ—¶é—´å­—æ®µ
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    last_login_time DATETIME COMMENT 'æœ€åç™»å½•æ—¶é—´',
    
    INDEX idx_username (username)
) COMMENT 'ç”¨æˆ·è¡¨';
```

**å­—æ®µè¯´æ˜**ï¼š
- `username`ï¼šç™»å½•è´¦å·ï¼Œå¿…é¡»å”¯ä¸€
- `password`ï¼šå­˜å‚¨åŠ å¯†åçš„å¯†ç ï¼Œ**ç»å¯¹ä¸èƒ½æ˜æ–‡å­˜å‚¨**
- `enabled`ï¼šæ§åˆ¶è´¦å·æ˜¯å¦å¯ç”¨ï¼Œ0è¡¨ç¤ºç¦ç”¨ï¼Œ1è¡¨ç¤ºå¯ç”¨
- `account_locked`ï¼šè´¦å·æ˜¯å¦è¢«é”å®šï¼ˆæ¯”å¦‚å¤šæ¬¡å¯†ç é”™è¯¯åï¼‰

### 2.2 è§’è‰²ä¸æƒé™è¡¨è®¾è®¡


**è§’è‰²è¡¨ï¼ˆsys_roleï¼‰**ï¼š

```sql
-- è§’è‰²è¡¨
CREATE TABLE sys_role (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    role_name VARCHAR(50) NOT NULL UNIQUE COMMENT 'è§’è‰²åç§°ï¼Œå¦‚ï¼šROLE_ADMIN',
    role_desc VARCHAR(200) COMMENT 'è§’è‰²æè¿°',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP
) COMMENT 'è§’è‰²è¡¨';
```

**ç”¨æˆ·è§’è‰²å…³è”è¡¨ï¼ˆsys_user_roleï¼‰**ï¼š

```sql
-- ç”¨æˆ·è§’è‰²å…³è”è¡¨ï¼ˆå¤šå¯¹å¤šå…³ç³»ï¼‰
CREATE TABLE sys_user_role (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
    role_id BIGINT NOT NULL COMMENT 'è§’è‰²ID',
    UNIQUE KEY uk_user_role (user_id, role_id)
) COMMENT 'ç”¨æˆ·è§’è‰²å…³è”è¡¨';
```

**å…³ç³»è¯´æ˜**ï¼š
```
ä¸€ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªè§’è‰²ï¼š
ç”¨æˆ·å¼ ä¸‰ â†’ [æ™®é€šç”¨æˆ·, VIPç”¨æˆ·]

ä¸€ä¸ªè§’è‰²å¯ä»¥åˆ†é…ç»™å¤šä¸ªç”¨æˆ·ï¼š
è§’è‰²"ç®¡ç†å‘˜" â†’ [ç”¨æˆ·A, ç”¨æˆ·B, ç”¨æˆ·C]

è¿™å°±æ˜¯"å¤šå¯¹å¤šå…³ç³»"ï¼Œéœ€è¦ä¸­é—´è¡¨æ¥å…³è”
```

### 2.3 å®ä½“ç±»å®šä¹‰


**ç”¨æˆ·å®ä½“ç±»**ï¼š

```java
@Entity
@Table(name = "sys_user")
public class SysUser {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String username;
    private String password;
    private String nickname;
    private String email;
    
    private Boolean enabled;        // æ˜¯å¦å¯ç”¨
    private Boolean accountLocked;  // æ˜¯å¦é”å®š
    
    private LocalDateTime lastLoginTime;
    
    // ä¸€ä¸ªç”¨æˆ·å¯¹åº”å¤šä¸ªè§’è‰²
    @ManyToMany(fetch = FetchType.EAGER)
    @JoinTable(
        name = "sys_user_role",
        joinColumns = @JoinColumn(name = "user_id"),
        inverseJoinColumns = @JoinColumn(name = "role_id")
    )
    private Set<SysRole> roles;
    
    // getter/setterçœç•¥...
}
```

**å…³é”®ç†è§£**ï¼š
- `@ManyToMany`ï¼šè¡¨ç¤ºå¤šå¯¹å¤šå…³ç³»
- `FetchType.EAGER`ï¼šç«‹å³åŠ è½½è§’è‰²ä¿¡æ¯ï¼ˆç™»å½•æ—¶éœ€è¦ç”¨åˆ°ï¼‰
- `@JoinTable`ï¼šæŒ‡å®šä¸­é—´å…³è”è¡¨

---

## 3. ğŸ”§ å®ç°æ•°æ®åº“ç”¨æˆ·è®¤è¯


### 3.1 UserDetailsService å®ç°


**æ ¸å¿ƒæ¥å£ç†è§£**ï¼šSpring Securityé€šè¿‡`UserDetailsService`æ¥å£æ¥åŠ è½½ç”¨æˆ·ä¿¡æ¯ï¼Œæˆ‘ä»¬åªéœ€è¦å®ç°è¿™ä¸ªæ¥å£ï¼Œå‘Šè¯‰å®ƒ"å¦‚ä½•ä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·"ã€‚

```java
@Service
public class CustomUserDetailsService implements UserDetailsService {
    
    @Autowired
    private SysUserRepository userRepository;
    
    @Override
    public UserDetails loadUserByUsername(String username) 
            throws UsernameNotFoundException {
        
        // æ­¥éª¤1ï¼šä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·
        SysUser user = userRepository.findByUsername(username)
            .orElseThrow(() -> new UsernameNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨"));
        
        // æ­¥éª¤2ï¼šæ£€æŸ¥è´¦å·çŠ¶æ€
        if (!user.getEnabled()) {
            throw new DisabledException("è´¦å·å·²è¢«ç¦ç”¨");
        }
        if (user.getAccountLocked()) {
            throw new LockedException("è´¦å·å·²è¢«é”å®š");
        }
        
        // æ­¥éª¤3ï¼šæ„å»ºæƒé™åˆ—è¡¨
        List<GrantedAuthority> authorities = new ArrayList<>();
        for (SysRole role : user.getRoles()) {
            authorities.add(new SimpleGrantedAuthority(role.getRoleName()));
        }
        
        // æ­¥éª¤4ï¼šè¿”å›Spring Securityéœ€è¦çš„ç”¨æˆ·å¯¹è±¡
        return new User(
            user.getUsername(),
            user.getPassword(),
            user.getEnabled(),
            true,  // è´¦å·æœªè¿‡æœŸ
            true,  // å¯†ç æœªè¿‡æœŸ
            !user.getAccountLocked(),  // è´¦å·æœªé”å®š
            authorities
        );
    }
}
```

**ä»£ç è§£è¯»**ï¼š
1. **æŸ¥è¯¢ç”¨æˆ·**ï¼šæ ¹æ®ç”¨æˆ·åä»æ•°æ®åº“æŸ¥è¯¢
2. **çŠ¶æ€æ£€æŸ¥**ï¼šéªŒè¯è´¦å·æ˜¯å¦å¯ç”¨
3. **æƒé™åŠ è½½**ï¼šæŠŠç”¨æˆ·çš„è§’è‰²è½¬æ¢æˆSpring Securityèƒ½è¯†åˆ«çš„æƒé™
4. **è¿”å›å¯¹è±¡**ï¼šæ„é€ `UserDetails`å¯¹è±¡è¿”å›ç»™æ¡†æ¶

### 3.2 é…ç½®ä½¿ç”¨æ•°æ®åº“è®¤è¯


```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Autowired
    private CustomUserDetailsService userDetailsService;
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            // é…ç½®ä½¿ç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„UserDetailsService
            .userDetailsService(userDetailsService)
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/public/**").permitAll()
                .anyRequest().authenticated()
            )
            .formLogin(form -> form
                .loginPage("/login")
                .permitAll()
            );
        
        return http.build();
    }
    
    @Bean
    public PasswordEncoder passwordEncoder() {
        // ä½¿ç”¨BCryptåŠ å¯†ç®—æ³•
        return new BCryptPasswordEncoder();
    }
}
```

**é…ç½®è¯´æ˜**ï¼š
- `.userDetailsService(userDetailsService)`ï¼šå‘Šè¯‰Spring Securityä½¿ç”¨æˆ‘ä»¬çš„æ•°æ®åº“æŸ¥è¯¢æœåŠ¡
- `PasswordEncoder`ï¼šé…ç½®å¯†ç åŠ å¯†æ–¹å¼ï¼Œ**å¿…é¡»é…ç½®**

### 3.3 ç”¨æˆ·æ³¨å†Œç¤ºä¾‹


**ç”¨æˆ·æ³¨å†ŒæœåŠ¡**ï¼š

```java
@Service
public class UserService {
    
    @Autowired
    private SysUserRepository userRepository;
    
    @Autowired
    private PasswordEncoder passwordEncoder;
    
    public void registerUser(String username, String rawPassword) {
        // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
        if (userRepository.existsByUsername(username)) {
            throw new RuntimeException("ç”¨æˆ·åå·²å­˜åœ¨");
        }
        
        // åˆ›å»ºæ–°ç”¨æˆ·
        SysUser user = new SysUser();
        user.setUsername(username);
        // å¯†ç å¿…é¡»åŠ å¯†åå­˜å‚¨
        user.setPassword(passwordEncoder.encode(rawPassword));
        user.setEnabled(true);
        user.setAccountLocked(false);
        
        userRepository.save(user);
    }
}
```

**é‡è¦æé†’**ï¼š
> âš ï¸ **ç»å¯¹ä¸èƒ½æ˜æ–‡å­˜å‚¨å¯†ç ï¼** å¿…é¡»ä½¿ç”¨`passwordEncoder.encode()`åŠ å¯†åå†ä¿å­˜

---

## 4. ğŸ—„ï¸ å¤šæ•°æ®æºç”¨æˆ·ç®¡ç†


### 4.1 ä»€ä¹ˆæ˜¯å¤šæ•°æ®æº


**åœºæ™¯è¯´æ˜**ï¼šæœ‰æ—¶å€™æˆ‘ä»¬çš„åº”ç”¨éœ€è¦ä»å¤šä¸ªæ•°æ®åº“è¯»å–ç”¨æˆ·ä¿¡æ¯ã€‚

```
å®é™…æ¡ˆä¾‹ï¼š

ä¼ä¸šå†…éƒ¨ç³»ç»Ÿï¼š
â”œâ”€â”€ ä¸»æ•°æ®åº“ï¼ˆMySQLï¼‰â†’ å­˜å‚¨å†…éƒ¨å‘˜å·¥è´¦å·
â””â”€â”€ å®¢æˆ·æ•°æ®åº“ï¼ˆPostgreSQLï¼‰â†’ å­˜å‚¨å®¢æˆ·è´¦å·

ç™»å½•æ—¶çš„åˆ¤æ–­é€»è¾‘ï¼š
å¦‚æœç”¨æˆ·åä»¥ "EMP_" å¼€å¤´ â†’ æŸ¥è¯¢ä¸»æ•°æ®åº“
å¦‚æœç”¨æˆ·åä»¥ "CUS_" å¼€å¤´ â†’ æŸ¥è¯¢å®¢æˆ·æ•°æ®åº“
```

### 4.2 å¤šæ•°æ®æºé…ç½®


**æ•°æ®æºé…ç½®ç±»**ï¼š

```java
@Configuration
public class DataSourceConfig {
    
    // ä¸»æ•°æ®æº
    @Bean
    @Primary
    @ConfigurationProperties(prefix = "spring.datasource.primary")
    public DataSource primaryDataSource() {
        return DataSourceBuilder.create().build();
    }
    
    // å®¢æˆ·æ•°æ®æº
    @Bean
    @ConfigurationProperties(prefix = "spring.datasource.customer")
    public DataSource customerDataSource() {
        return DataSourceBuilder.create().build();
    }
}
```

**é…ç½®æ–‡ä»¶ï¼ˆapplication.ymlï¼‰**ï¼š

```yaml
spring:
  datasource:
    primary:
      jdbc-url: jdbc:mysql://localhost:3306/main_db
      username: root
      password: 123456
      driver-class-name: com.mysql.cj.jdbc.Driver
    
    customer:
      jdbc-url: jdbc:postgresql://localhost:5432/customer_db
      username: postgres
      password: 123456
      driver-class-name: org.postgresql.Driver
```

### 4.3 å¤šæ•°æ®æºç”¨æˆ·è®¤è¯å®ç°


```java
@Service
public class MultiSourceUserDetailsService implements UserDetailsService {
    
    @Autowired
    @Qualifier("primaryUserRepository")
    private UserRepository primaryUserRepo;
    
    @Autowired
    @Qualifier("customerUserRepository")
    private UserRepository customerUserRepo;
    
    @Override
    public UserDetails loadUserByUsername(String username) {
        SysUser user = null;
        
        // æ ¹æ®ç”¨æˆ·åå‰ç¼€åˆ¤æ–­æŸ¥è¯¢å“ªä¸ªæ•°æ®æº
        if (username.startsWith("EMP_")) {
            user = primaryUserRepo.findByUsername(username)
                .orElse(null);
        } else if (username.startsWith("CUS_")) {
            user = customerUserRepo.findByUsername(username)
                .orElse(null);
        }
        
        if (user == null) {
            throw new UsernameNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨");
        }
        
        return buildUserDetails(user);
    }
    
    private UserDetails buildUserDetails(SysUser user) {
        // æ„å»ºUserDetailså¯¹è±¡ï¼ˆä¸ä¹‹å‰ç›¸åŒï¼‰
        // ...çœç•¥
    }
}
```

**æ ¸å¿ƒæ€è·¯**ï¼šæ ¹æ®ä¸šåŠ¡è§„åˆ™åˆ¤æ–­åº”è¯¥æŸ¥è¯¢å“ªä¸ªæ•°æ®æºï¼Œç„¶åæ‰§è¡Œç›¸åº”çš„æŸ¥è¯¢é€»è¾‘ã€‚

---

## 5. ğŸ’¾ ç”¨æˆ·æƒé™ç¼“å­˜ç­–ç•¥


### 5.1 ä¸ºä»€ä¹ˆéœ€è¦ç¼“å­˜


**æ€§èƒ½é—®é¢˜**ï¼š

```
æ²¡æœ‰ç¼“å­˜çš„æƒ…å†µï¼š
æ¯æ¬¡è¯·æ±‚ â†’ æŸ¥è¯¢æ•°æ®åº“è·å–ç”¨æˆ·æƒé™ â†’ éªŒè¯æƒé™ â†’ è¿”å›ç»“æœ
â”œâ”€â”€ æ•°æ®åº“å‹åŠ›å¤§
â”œâ”€â”€ å“åº”é€Ÿåº¦æ…¢
â””â”€â”€ èµ„æºæµªè´¹

ä½¿ç”¨ç¼“å­˜åï¼š
é¦–æ¬¡è¯·æ±‚ â†’ æŸ¥è¯¢æ•°æ®åº“ â†’ å­˜å…¥ç¼“å­˜ â†’ è¿”å›ç»“æœ
åç»­è¯·æ±‚ â†’ ç›´æ¥ä»ç¼“å­˜è·å– â†’ è¿”å›ç»“æœï¼ˆå¿«ï¼ï¼‰
```

### 5.2 ä½¿ç”¨ Redis ç¼“å­˜ç”¨æˆ·ä¿¡æ¯


**å¼•å…¥ä¾èµ–**ï¼š

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-cache</artifactId>
</dependency>
```

**å¯ç”¨ç¼“å­˜é…ç½®**ï¼š

```java
@Configuration
@EnableCaching
public class CacheConfig {
    
    @Bean
    public RedisCacheManager cacheManager(RedisConnectionFactory factory) {
        RedisCacheConfiguration config = RedisCacheConfiguration.defaultCacheConfig()
            .entryTtl(Duration.ofMinutes(30))  // ç¼“å­˜30åˆ†é’Ÿ
            .serializeValuesWith(
                RedisSerializationContext.SerializationPair
                    .fromSerializer(new GenericJackson2JsonRedisSerializer())
            );
        
        return RedisCacheManager.builder(factory)
            .cacheDefaults(config)
            .build();
    }
}
```

### 5.3 ç¼“å­˜ç”¨æˆ·è®¤è¯ä¿¡æ¯


```java
@Service
public class CachedUserDetailsService implements UserDetailsService {
    
    @Autowired
    private SysUserRepository userRepository;
    
    // @Cacheableï¼šæŸ¥è¯¢ç»“æœä¼šè‡ªåŠ¨ç¼“å­˜
    @Cacheable(value = "userCache", key = "#username")
    @Override
    public UserDetails loadUserByUsername(String username) {
        // ä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·ï¼ˆé¦–æ¬¡ä¼šæ‰§è¡Œï¼Œåç»­ç›´æ¥è¿”å›ç¼“å­˜ï¼‰
        SysUser user = userRepository.findByUsername(username)
            .orElseThrow(() -> new UsernameNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨"));
        
        return buildUserDetails(user);
    }
    
    // ç”¨æˆ·ä¿¡æ¯æ›´æ–°æ—¶æ¸…é™¤ç¼“å­˜
    @CacheEvict(value = "userCache", key = "#username")
    public void clearUserCache(String username) {
        // æ–¹æ³•ä½“å¯ä»¥ä¸ºç©ºï¼Œæ³¨è§£ä¼šè‡ªåŠ¨æ¸…é™¤ç¼“å­˜
    }
}
```

**ç¼“å­˜æ³¨è§£è¯´æ˜**ï¼š
- `@Cacheable`ï¼šæŸ¥è¯¢æ—¶å…ˆæŸ¥ç¼“å­˜ï¼Œæ²¡æœ‰å†æŸ¥æ•°æ®åº“å¹¶ç¼“å­˜ç»“æœ
- `@CacheEvict`ï¼šæ¸…é™¤æŒ‡å®šçš„ç¼“å­˜æ•°æ®
- `value = "userCache"`ï¼šç¼“å­˜çš„å‘½åç©ºé—´
- `key = "#username"`ï¼šç¼“å­˜çš„é”®ï¼ˆç”¨æˆ·åï¼‰

### 5.4 ç¼“å­˜æ›´æ–°ç­–ç•¥


```java
@Service
public class UserManagementService {
    
    @Autowired
    private SysUserRepository userRepository;
    
    @Autowired
    private CachedUserDetailsService userDetailsService;
    
    public void updateUserRole(String username, Set<SysRole> newRoles) {
        SysUser user = userRepository.findByUsername(username)
            .orElseThrow(() -> new RuntimeException("ç”¨æˆ·ä¸å­˜åœ¨"));
        
        // æ›´æ–°ç”¨æˆ·è§’è‰²
        user.setRoles(newRoles);
        userRepository.save(user);
        
        // æ¸…é™¤è¯¥ç”¨æˆ·çš„ç¼“å­˜ï¼Œä¸‹æ¬¡ç™»å½•æ—¶é‡æ–°åŠ è½½
        userDetailsService.clearUserCache(username);
    }
}
```

**æ ¸å¿ƒç†è§£**ï¼šå½“ç”¨æˆ·æƒé™å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå¿…é¡»æ¸…é™¤ç¼“å­˜ï¼Œå¦åˆ™ç”¨æˆ·ä¼šä¸€ç›´ä½¿ç”¨æ—§çš„æƒé™ä¿¡æ¯ã€‚

---

## 6. ğŸ›¡ï¸ æ•°æ®åº“å®‰å…¨é˜²æŠ¤


### 6.1 SQLæ³¨å…¥é˜²æŠ¤


**ä»€ä¹ˆæ˜¯SQLæ³¨å…¥**ï¼š

```
æ­£å¸¸æŸ¥è¯¢ï¼š
username = "admin"
SQL: SELECT * FROM user WHERE username = 'admin'

SQLæ³¨å…¥æ”»å‡»ï¼š
username = "admin' OR '1'='1"
SQL: SELECT * FROM user WHERE username = 'admin' OR '1'='1'
ç»“æœï¼šè¿”å›æ‰€æœ‰ç”¨æˆ·ï¼ï¼ˆ'1'='1' æ°¸è¿œä¸ºçœŸï¼‰
```

**é˜²æŠ¤æªæ–½ - ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢**ï¼š

```java
// âŒ é”™è¯¯åšæ³• - å­—ç¬¦ä¸²æ‹¼æ¥ï¼ˆå±é™©ï¼ï¼‰
@Query(value = "SELECT * FROM sys_user WHERE username = '" + username + "'", 
       nativeQuery = true)
SysUser findByUsernameDangerous(String username);

// âœ… æ­£ç¡®åšæ³• - å‚æ•°åŒ–æŸ¥è¯¢
@Query("SELECT u FROM SysUser u WHERE u.username = :username")
Optional<SysUser> findByUsername(@Param("username") String username);

// âœ… ä½¿ç”¨JPAæ–¹æ³•å‘½åï¼ˆæœ€å®‰å…¨ï¼‰
Optional<SysUser> findByUsername(String username);
```

**é˜²æŠ¤åŸç†**ï¼šå‚æ•°åŒ–æŸ¥è¯¢ä¼šæŠŠç”¨æˆ·è¾“å…¥å½“ä½œ"æ•°æ®"è€Œä¸æ˜¯"SQLä»£ç "ï¼Œä»æ ¹æœ¬ä¸Šé˜²æ­¢SQLæ³¨å…¥ã€‚

### 6.2 æ•°æ®åº“è¿æ¥å®‰å…¨


**è¿æ¥æ± é…ç½®**ï¼š

```yaml
spring:
  datasource:
    hikari:
      maximum-pool-size: 10          # æœ€å¤§è¿æ¥æ•°
      minimum-idle: 5                # æœ€å°ç©ºé—²è¿æ¥
      connection-timeout: 30000      # è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆ30ç§’ï¼‰
      idle-timeout: 600000           # ç©ºé—²è¿æ¥è¶…æ—¶ï¼ˆ10åˆ†é’Ÿï¼‰
      max-lifetime: 1800000          # è¿æ¥æœ€å¤§ç”Ÿå‘½å‘¨æœŸï¼ˆ30åˆ†é’Ÿï¼‰
      
      # è¿æ¥æµ‹è¯•
      connection-test-query: SELECT 1
      validation-timeout: 3000
```

**å®‰å…¨é…ç½®è¯´æ˜**ï¼š
- **é™åˆ¶è¿æ¥æ•°**ï¼šé˜²æ­¢è¿æ¥è€—å°½
- **è¿æ¥è¶…æ—¶**ï¼šé¿å…é•¿æ—¶é—´å ç”¨è¿æ¥
- **å®šæœŸæµ‹è¯•**ï¼šæ£€æµ‹å¹¶ç§»é™¤å¤±æ•ˆè¿æ¥

### 6.3 æ•æ„Ÿä¿¡æ¯åŠ å¯†å­˜å‚¨


**æ•°æ®åº“å¯†ç åŠ å¯†**ï¼š

```yaml
# ä½¿ç”¨JasyptåŠ å¯†æ•°æ®åº“å¯†ç 
spring:
  datasource:
    # ENC()åŒ…è£¹çš„æ˜¯åŠ å¯†åçš„å¯†ç 
    password: ENC(G6fZ8qJ9kL2mN4pR5sT7vW8xY0zA1bC3)

jasypt:
  encryptor:
    password: ${JASYPT_PASSWORD}  # ä»ç¯å¢ƒå˜é‡è·å–è§£å¯†å¯†é’¥
    algorithm: PBEWithMD5AndDES
```

**åŠ å¯†å·¥å…·ä½¿ç”¨**ï¼š

```java
// ç”ŸæˆåŠ å¯†å¯†ç 
public class PasswordEncryptor {
    public static void main(String[] args) {
        StandardPBEStringEncryptor encryptor = new StandardPBEStringEncryptor();
        encryptor.setPassword("mySecretKey");
        
        String encrypted = encryptor.encrypt("databasePassword123");
        System.out.println("åŠ å¯†å: " + encrypted);
    }
}
```

---

## 7. ğŸ”‘ ç”¨æˆ·å¯†ç å®‰å…¨ç­–ç•¥


### 7.1 å¯†ç å¼ºåº¦éªŒè¯


**å¯†ç ç­–ç•¥è§„åˆ™**ï¼š

```java
@Component
public class PasswordValidator {
    
    // å¯†ç å¿…é¡»åŒ…å«ï¼šå¤§å†™å­—æ¯ã€å°å†™å­—æ¯ã€æ•°å­—ã€ç‰¹æ®Šå­—ç¬¦ï¼Œé•¿åº¦8-20ä½
    private static final String PASSWORD_PATTERN = 
        "^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[@$!%*?&])[A-Za-z\\d@$!%*?&]{8,20}$";
    
    public boolean isValidPassword(String password) {
        if (password == null || password.isEmpty()) {
            return false;
        }
        return password.matches(PASSWORD_PATTERN);
    }
    
    public String getPasswordRequirement() {
        return "å¯†ç å¿…é¡»åŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦ï¼Œé•¿åº¦8-20ä½";
    }
}
```

**æ³¨å†Œæ—¶éªŒè¯**ï¼š

```java
@Service
public class UserRegistrationService {
    
    @Autowired
    private PasswordValidator passwordValidator;
    
    public void register(String username, String password) {
        // éªŒè¯å¯†ç å¼ºåº¦
        if (!passwordValidator.isValidPassword(password)) {
            throw new WeakPasswordException(
                passwordValidator.getPasswordRequirement()
            );
        }
        
        // ç»§ç»­æ³¨å†Œæµç¨‹...
    }
}
```

### 7.2 å¯†ç åŠ å¯†å­˜å‚¨


**BCrypt åŠ å¯†ç®—æ³•**ï¼š

```java
@Service
public class PasswordService {
    
    @Autowired
    private PasswordEncoder passwordEncoder;  // BCryptPasswordEncoder
    
    // åŠ å¯†å¯†ç 
    public String encodePassword(String rawPassword) {
        return passwordEncoder.encode(rawPassword);
    }
    
    // éªŒè¯å¯†ç 
    public boolean matches(String rawPassword, String encodedPassword) {
        return passwordEncoder.matches(rawPassword, encodedPassword);
    }
}
```

**åŠ å¯†ç‰¹ç‚¹**ï¼š
```
ç›¸åŒçš„æ˜æ–‡å¯†ç ï¼Œæ¯æ¬¡åŠ å¯†ç»“æœéƒ½ä¸åŒï¼

æ˜æ–‡ï¼š123456
ç¬¬ä¸€æ¬¡åŠ å¯†ï¼š$2a$10$N9qo8uLOickgx2ZMRZoMye...
ç¬¬äºŒæ¬¡åŠ å¯†ï¼š$2a$10$XptAqGxFqAr8yfz9fN3LX...

ä½†éªŒè¯æ—¶éƒ½èƒ½åŒ¹é…æˆåŠŸï¼Œè¿™å°±æ˜¯BCryptçš„"ç›å€¼"æœºåˆ¶
```

### 7.3 å¯†ç è¿‡æœŸä¸å®šæœŸæ›´æ¢


**å¯†ç è¿‡æœŸæ£€æŸ¥**ï¼š

```java
@Entity
@Table(name = "sys_user")
public class SysUser {
    // ...å…¶ä»–å­—æ®µ
    
    private LocalDateTime passwordUpdateTime;  // å¯†ç æœ€åæ›´æ–°æ—¶é—´
    
    // æ£€æŸ¥å¯†ç æ˜¯å¦è¿‡æœŸï¼ˆ90å¤©ï¼‰
    public boolean isPasswordExpired() {
        if (passwordUpdateTime == null) {
            return true;
        }
        return LocalDateTime.now()
            .isAfter(passwordUpdateTime.plusDays(90));
    }
}
```

**å¼ºåˆ¶ä¿®æ”¹å¯†ç **ï¼š

```java
@Override
public UserDetails loadUserByUsername(String username) {
    SysUser user = userRepository.findByUsername(username)
        .orElseThrow(() -> new UsernameNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨"));
    
    // æ£€æŸ¥å¯†ç æ˜¯å¦è¿‡æœŸ
    boolean credentialsNonExpired = !user.isPasswordExpired();
    
    return new User(
        user.getUsername(),
        user.getPassword(),
        user.getEnabled(),
        true,  // accountNonExpired
        credentialsNonExpired,  // å¯†ç æ˜¯å¦æœªè¿‡æœŸ
        !user.getAccountLocked(),
        getAuthorities(user)
    );
}
```

### 7.4 é˜²æš´åŠ›ç ´è§£


**ç™»å½•å¤±è´¥è®¡æ•°**ï¼š

```java
@Service
public class LoginAttemptService {
    
    private final int MAX_ATTEMPT = 5;
    private LoadingCache<String, Integer> attemptsCache;
    
    public LoginAttemptService() {
        attemptsCache = CacheBuilder.newBuilder()
            .expireAfterWrite(1, TimeUnit.DAYS)
            .build(new CacheLoader<String, Integer>() {
                @Override
                public Integer load(String key) {
                    return 0;
                }
            });
    }
    
    // ç™»å½•æˆåŠŸï¼Œæ¸…é™¤è®¡æ•°
    public void loginSucceeded(String username) {
        attemptsCache.invalidate(username);
    }
    
    // ç™»å½•å¤±è´¥ï¼Œå¢åŠ è®¡æ•°
    public void loginFailed(String username) {
        int attempts = attemptsCache.getUnchecked(username);
        attemptsCache.put(username, attempts + 1);
    }
    
    // æ£€æŸ¥æ˜¯å¦è¢«å°ç¦
    public boolean isBlocked(String username) {
        return attemptsCache.getUnchecked(username) >= MAX_ATTEMPT;
    }
}
```

---

## 8. ğŸ“ å®¡è®¡æ—¥å¿—ä¸ç›‘æ§


### 8.1 ç™»å½•å®¡è®¡æ—¥å¿—


**æ—¥å¿—è¡¨è®¾è®¡**ï¼š

```sql
CREATE TABLE sys_login_log (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) COMMENT 'ç™»å½•ç”¨æˆ·å',
    ip_address VARCHAR(50) COMMENT 'ç™»å½•IPåœ°å€',
    login_time DATETIME COMMENT 'ç™»å½•æ—¶é—´',
    login_status VARCHAR(20) COMMENT 'ç™»å½•çŠ¶æ€ï¼šSUCCESS/FAILURE',
    user_agent VARCHAR(500) COMMENT 'æµè§ˆå™¨ä¿¡æ¯',
    failure_reason VARCHAR(200) COMMENT 'å¤±è´¥åŸå› '
) COMMENT 'ç™»å½•æ—¥å¿—è¡¨';
```

**è®°å½•ç™»å½•æ—¥å¿—**ï¼š

```java
@Component
public class AuthenticationEventListener {
    
    @Autowired
    private LoginLogRepository logRepository;
    
    // ç›‘å¬ç™»å½•æˆåŠŸäº‹ä»¶
    @EventListener
    public void onAuthenticationSuccess(
            AuthenticationSuccessEvent event) {
        
        String username = event.getAuthentication().getName();
        
        LoginLog log = new LoginLog();
        log.setUsername(username);
        log.setLoginTime(LocalDateTime.now());
        log.setLoginStatus("SUCCESS");
        log.setIpAddress(getClientIp());
        
        logRepository.save(log);
    }
    
    // ç›‘å¬ç™»å½•å¤±è´¥äº‹ä»¶
    @EventListener
    public void onAuthenticationFailure(
            AbstractAuthenticationFailureEvent event) {
        
        String username = event.getAuthentication().getName();
        
        LoginLog log = new LoginLog();
        log.setUsername(username);
        log.setLoginTime(LocalDateTime.now());
        log.setLoginStatus("FAILURE");
        log.setFailureReason(event.getException().getMessage());
        
        logRepository.save(log);
    }
}
```

### 8.2 æ“ä½œå®¡è®¡è®°å½•


**æ“ä½œæ—¥å¿—ï¼ˆAOPåˆ‡é¢ï¼‰**ï¼š

```java
@Aspect
@Component
public class OperationLogAspect {
    
    @Autowired
    private OperationLogRepository logRepository;
    
    // æ‹¦æˆªæ‰€æœ‰Serviceå±‚çš„ä¿®æ”¹æ“ä½œ
    @AfterReturning("@annotation(operationLog)")
    public void recordOperation(JoinPoint joinPoint, OperationLog operationLog) {
        
        // è·å–å½“å‰ç™»å½•ç”¨æˆ·
        Authentication auth = SecurityContextHolder.getContext()
            .getAuthentication();
        String username = auth.getName();
        
        // è®°å½•æ“ä½œæ—¥å¿—
        SysOperationLog log = new SysOperationLog();
        log.setUsername(username);
        log.setOperation(operationLog.value());
        log.setMethod(joinPoint.getSignature().toString());
        log.setOperationTime(LocalDateTime.now());
        
        logRepository.save(log);
    }
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```java
@Service
public class UserService {
    
    @OperationLog("ä¿®æ”¹ç”¨æˆ·è§’è‰²")
    public void updateUserRole(Long userId, Set<Long> roleIds) {
        // ä¸šåŠ¡é€»è¾‘...
    }
}
```

### 8.3 å¼‚å¸¸è¡Œä¸ºç›‘æ§


**å¼‚å¸¸è¡Œä¸ºæ£€æµ‹**ï¼š

```java
@Service
public class SecurityMonitorService {
    
    // æ£€æµ‹å¼‚åœ°ç™»å½•
    public void checkUnusualLogin(String username, String currentIp) {
        String lastIp = getLastLoginIp(username);
        
        if (!currentIp.equals(lastIp)) {
            // å‘é€å¼‚åœ°ç™»å½•é¢„è­¦
            sendAlert("å¼‚åœ°ç™»å½•", username, currentIp);
        }
    }
    
    // æ£€æµ‹é¢‘ç¹æƒé™å˜æ›´
    public void checkFrequentRoleChange(String username) {
        long changeCount = countRoleChangesInLast24Hours(username);
        
        if (changeCount > 5) {
            // å¯èƒ½å­˜åœ¨æƒé™æ»¥ç”¨
            sendAlert("é¢‘ç¹æƒé™å˜æ›´", username);
        }
    }
}
```

---

## 9. âš¡ æ€§èƒ½ä¼˜åŒ–å®è·µ


### 9.1 æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–


**ç´¢å¼•ä¼˜åŒ–**ï¼š

```sql
-- ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µæ·»åŠ ç´¢å¼•
CREATE INDEX idx_username ON sys_user(username);
CREATE INDEX idx_email ON sys_user(email);
CREATE INDEX idx_enabled_locked ON sys_user(enabled, account_locked);

-- è”åˆæŸ¥è¯¢ç´¢å¼•
CREATE INDEX idx_user_role ON sys_user_role(user_id, role_id);
```

**æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§**ï¼š

```java
// âŒ N+1æŸ¥è¯¢é—®é¢˜
public List<SysUser> getAllUsers() {
    List<SysUser> users = userRepository.findAll();
    for (SysUser user : users) {
        user.getRoles().size();  // æ¯ä¸ªç”¨æˆ·éƒ½ä¼šæ‰§è¡Œä¸€æ¬¡æŸ¥è¯¢è§’è‰²çš„SQL
    }
    return users;
}

// âœ… ä½¿ç”¨JOIN FETCHä¸€æ¬¡æ€§è·å–
@Query("SELECT u FROM SysUser u LEFT JOIN FETCH u.roles")
List<SysUser> findAllWithRoles();
```

### 9.2 æ‰¹é‡æ“ä½œä¼˜åŒ–


**æ‰¹é‡æ›´æ–°ç”¨æˆ·**ï¼š

```java
@Service
public class BatchUserService {
    
    @Autowired
    private JdbcTemplate jdbcTemplate;
    
    @Transactional
    public void batchUpdateUserStatus(List<Long> userIds, boolean enabled) {
        String sql = "UPDATE sys_user SET enabled = ? WHERE id = ?";
        
        jdbcTemplate.batchUpdate(sql, new BatchPreparedStatementSetter() {
            @Override
            public void setValues(PreparedStatement ps, int i) throws SQLException {
                ps.setBoolean(1, enabled);
                ps.setLong(2, userIds.get(i));
            }
            
            @Override
            public int getBatchSize() {
                return userIds.size();
            }
        });
    }
}
```

### 9.3 ç¼“å­˜å‘½ä¸­ç‡ä¼˜åŒ–


**ç¼“å­˜é¢„çƒ­**ï¼š

```java
@Component
public class CacheWarmupService {
    
    @Autowired
    private SysUserRepository userRepository;
    
    @Autowired
    private CacheManager cacheManager;
    
    // åº”ç”¨å¯åŠ¨æ—¶é¢„çƒ­ç¼“å­˜
    @PostConstruct
    public void warmupCache() {
        List<SysUser> activeUsers = userRepository
            .findTop100ByEnabledOrderByLastLoginTimeDesc(true);
        
        Cache userCache = cacheManager.getCache("userCache");
        
        for (SysUser user : activeUsers) {
            UserDetails userDetails = buildUserDetails(user);
            userCache.put(user.getUsername(), userDetails);
        }
    }
}
```

**ç¼“å­˜ç­–ç•¥ä¼˜åŒ–**ï¼š

| æ•°æ®ç±»å‹ | ç¼“å­˜æ—¶é•¿ | æ›´æ–°ç­–ç•¥ | è¯´æ˜ |
|---------|---------|---------|------|
| **ç”¨æˆ·åŸºæœ¬ä¿¡æ¯** | 30åˆ†é’Ÿ | ä¿®æ”¹æ—¶æ¸…é™¤ | å˜æ›´é¢‘ç‡ä½ |
| **ç”¨æˆ·æƒé™** | 15åˆ†é’Ÿ | ä¿®æ”¹æ—¶æ¸…é™¤ | æƒé™å˜æ›´éœ€åŠæ—¶ç”Ÿæ•ˆ |
| **ç™»å½•Token** | Tokenæœ‰æ•ˆæœŸ | è¿‡æœŸè‡ªåŠ¨æ¸…é™¤ | è·ŸéšTokenç”Ÿå‘½å‘¨æœŸ |
| **éªŒè¯ç ** | 5åˆ†é’Ÿ | ä½¿ç”¨åæ¸…é™¤ | çŸ­æœŸæœ‰æ•ˆ |

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 æ•°æ®åº“è®¤è¯æ ¸å¿ƒæµç¨‹


```
ç”¨æˆ·ç™»å½•æµç¨‹ï¼š
[1] ç”¨æˆ·æäº¤ç”¨æˆ·åå¯†ç 
     â†“
[2] UserDetailsServiceä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·
     â†“
[3] éªŒè¯å¯†ç ï¼ˆBCryptå¯¹æ¯”ï¼‰
     â†“
[4] æ£€æŸ¥è´¦å·çŠ¶æ€ï¼ˆå¯ç”¨/é”å®šï¼‰
     â†“
[5] åŠ è½½ç”¨æˆ·æƒé™ï¼ˆè§’è‰²å’Œæƒé™ï¼‰
     â†“
[6] åˆ›å»ºè®¤è¯å¯¹è±¡è¿”å›
```

### 10.2 å¿…çŸ¥å¿…ä¼šçš„å®‰å…¨è¦ç‚¹


**å¯†ç å®‰å…¨ â­â­â­**ï¼š
- âœ… å¿…é¡»ä½¿ç”¨BCryptç­‰å¼ºåŠ å¯†ç®—æ³•
- âœ… ç»ä¸æ˜æ–‡å­˜å‚¨å¯†ç 
- âœ… å®æ–½å¯†ç å¼ºåº¦ç­–ç•¥
- âœ… å®šæœŸå¼ºåˆ¶ä¿®æ”¹å¯†ç 

**SQLæ³¨å…¥é˜²æŠ¤ â­â­â­**ï¼š
- âœ… ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
- âœ… é¿å…å­—ç¬¦ä¸²æ‹¼æ¥SQL
- âœ… ä½¿ç”¨ORMæ¡†æ¶ï¼ˆJPA/MyBatisï¼‰

**æ€§èƒ½ä¼˜åŒ– â­â­**ï¼š
- âœ… åˆç†ä½¿ç”¨ç¼“å­˜ï¼ˆRedisï¼‰
- âœ… æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–
- âœ… é¿å…N+1æŸ¥è¯¢é—®é¢˜

**å®¡è®¡ç›‘æ§ â­â­**ï¼š
- âœ… è®°å½•ç™»å½•æ—¥å¿—
- âœ… è®°å½•æ“ä½œå®¡è®¡
- âœ… å¼‚å¸¸è¡Œä¸ºå‘Šè­¦

### 10.3 å®è·µå»ºè®®æ¸…å•


**å¼€å‘é˜¶æ®µ**ï¼š
- â˜‘ï¸ è®¾è®¡åˆç†çš„ç”¨æˆ·æƒé™è¡¨ç»“æ„
- â˜‘ï¸ å®ç°UserDetailsServiceæ¥å£
- â˜‘ï¸ é…ç½®å¯†ç åŠ å¯†å™¨
- â˜‘ï¸ æ·»åŠ å¿…è¦çš„ç´¢å¼•

**æµ‹è¯•é˜¶æ®µ**ï¼š
- â˜‘ï¸ æµ‹è¯•SQLæ³¨å…¥é˜²æŠ¤
- â˜‘ï¸ éªŒè¯å¯†ç åŠ å¯†æ­£ç¡®æ€§
- â˜‘ï¸ æ£€æŸ¥ç¼“å­˜å‘½ä¸­ç‡
- â˜‘ï¸ å‹åŠ›æµ‹è¯•æ•°æ®åº“è¿æ¥

**ä¸Šçº¿å‰**ï¼š
- â˜‘ï¸ é…ç½®æ•°æ®åº“è¿æ¥æ± 
- â˜‘ï¸ å¯ç”¨å®¡è®¡æ—¥å¿—
- â˜‘ï¸ é…ç½®ç›‘æ§å‘Šè­¦
- â˜‘ï¸ æ•°æ®åº“å¯†ç åŠ å¯†

### 10.4 å¸¸è§é—®é¢˜é€ŸæŸ¥


**é—®é¢˜1ï¼šå¯†ç éªŒè¯æ€»æ˜¯å¤±è´¥**
- æ£€æŸ¥æ˜¯å¦é…ç½®äº†`PasswordEncoder`
- ç¡®è®¤å­˜å‚¨çš„å¯†ç æ˜¯åŠ å¯†åçš„
- éªŒè¯åŠ å¯†ç®—æ³•æ˜¯å¦ä¸€è‡´

**é—®é¢˜2ï¼šæƒé™ä¿®æ”¹åä¸ç”Ÿæ•ˆ**
- æ¸…é™¤ç”¨æˆ·ç¼“å­˜
- æ£€æŸ¥ç¼“å­˜è¿‡æœŸæ—¶é—´
- ç¡®è®¤æƒé™åŠ è½½é€»è¾‘

**é—®é¢˜3ï¼šæ•°æ®åº“è¿æ¥è€—å°½**
- æ£€æŸ¥è¿æ¥æ± é…ç½®
- æ’æŸ¥è¿æ¥æ³„éœ²
- ä¼˜åŒ–æ…¢æŸ¥è¯¢

**é—®é¢˜4ï¼šç™»å½•å“åº”æ…¢**
- å¯ç”¨æŸ¥è¯¢ç¼“å­˜
- ä¼˜åŒ–æ•°æ®åº“ç´¢å¼•
- å‡å°‘JOINæŸ¥è¯¢

---

## ğŸ¯ å­¦ä¹ æ£€æŸ¥ç‚¹


**åŸºç¡€çŸ¥è¯†æŒæ¡**ï¼š
- [ ] ç†è§£æ•°æ®åº“è®¤è¯çš„å·¥ä½œåŸç†
- [ ] èƒ½å¤Ÿè®¾è®¡ç”¨æˆ·æƒé™è¡¨ç»“æ„
- [ ] æŒæ¡UserDetailsServiceçš„å®ç°
- [ ] äº†è§£å¯†ç åŠ å¯†çš„é‡è¦æ€§

**å®è·µèƒ½åŠ›**ï¼š
- [ ] èƒ½å¤Ÿå®ç°æ•°æ®åº“ç”¨æˆ·è®¤è¯
- [ ] èƒ½å¤Ÿé…ç½®Redisç¼“å­˜
- [ ] èƒ½å¤Ÿå®ç°ç™»å½•å®¡è®¡æ—¥å¿—
- [ ] èƒ½å¤Ÿè¿›è¡ŒSQLæ³¨å…¥é˜²æŠ¤

**è¿›é˜¶æŠ€èƒ½**ï¼š
- [ ] æŒæ¡å¤šæ•°æ®æºç”¨æˆ·ç®¡ç†
- [ ] èƒ½å¤Ÿä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
- [ ] èƒ½å¤Ÿå®ç°å¼‚å¸¸è¡Œä¸ºç›‘æ§
- [ ] ç†è§£ç¼“å­˜æ›´æ–°ç­–ç•¥

---

> ğŸ’¡ **å­¦ä¹ å»ºè®®**ï¼šæ•°æ®åº“è®¤è¯æ˜¯Spring Securityçš„æ ¸å¿ƒåº”ç”¨åœºæ™¯ï¼Œå»ºè®®ä»ç®€å•çš„å•è¡¨è®¤è¯å¼€å§‹ï¼Œé€æ­¥æŒæ¡å¤šè¡¨å…³è”ã€ç¼“å­˜ä¼˜åŒ–ç­‰é«˜çº§ç‰¹æ€§ã€‚é‡ç‚¹ç†è§£"å®‰å…¨æ€§"å’Œ"æ€§èƒ½"çš„å¹³è¡¡ï¼Œåœ¨ä¿è¯å®‰å…¨çš„å‰æä¸‹æå‡ç³»ç»Ÿæ€§èƒ½ã€‚