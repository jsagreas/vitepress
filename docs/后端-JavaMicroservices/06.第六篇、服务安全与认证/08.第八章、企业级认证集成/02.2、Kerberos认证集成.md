---
title: 2ã€Kerberosè®¤è¯é›†æˆ
---
## ğŸ“š ç›®å½•

1. [Kerberosè®¤è¯åŸºç¡€](#1-Kerberosè®¤è¯åŸºç¡€)
2. [Spring Securityé›†æˆå®ç°](#2-Spring-Securityé›†æˆå®ç°)
3. [SPNEGOåè®®åº”ç”¨](#3-SPNEGOåè®®åº”ç”¨)
4. [WindowsåŸŸç¯å¢ƒé›†æˆ](#4-WindowsåŸŸç¯å¢ƒé›†æˆ)
5. [è·¨åŸŸä¿¡ä»»é…ç½®](#5-è·¨åŸŸä¿¡ä»»é…ç½®)
6. [ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ](#6-ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” Kerberosè®¤è¯åŸºç¡€


### 1.1 ä»€ä¹ˆæ˜¯Kerberosè®¤è¯


> **ç®€å•ç†è§£**ï¼šKerberoså°±åƒä¸€ä¸ª"ä¿¡ä»»ä¸­ä»‹"ç³»ç»Ÿï¼Œç±»ä¼¼äºæœºåœºå®‰æ£€ã€‚ä½ å…ˆåœ¨å®‰æ£€å¤„ï¼ˆè®¤è¯ä¸­å¿ƒï¼‰éªŒè¯èº«ä»½å¹¶è·å¾—"ç™»æœºç‰Œ"ï¼ˆç¥¨æ®ï¼‰ï¼Œç„¶åå‡­è¿™å¼ ç™»æœºç‰Œå°±å¯ä»¥åœ¨æœºåœºå†…è‡ªç”±é€šè¡Œï¼Œä¸éœ€è¦æ¯æ¬¡éƒ½é‡æ–°éªŒè¯èº«ä»½ã€‚

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- **è®¤è¯ä¸­å¿ƒ(KDC)**ï¼šå°±åƒæœºåœºçš„å®‰æ£€ä¸­å¿ƒï¼Œè´Ÿè´£éªŒè¯ä½ çš„èº«ä»½
- **ç¥¨æ®(Ticket)**ï¼šå°±åƒç™»æœºç‰Œï¼Œè¯æ˜ä½ å·²ç»é€šè¿‡äº†èº«ä»½éªŒè¯
- **æœåŠ¡ç«¯**ï¼šå°±åƒæœºåœºå†…çš„å„ä¸ªè®¾æ–½ï¼Œå‡­ç¥¨æ®å°±èƒ½ä½¿ç”¨

### 1.2 Kerberoså·¥ä½œåŸç†


```
Kerberosè®¤è¯æµç¨‹ï¼ˆç®€åŒ–ç‰ˆï¼‰ï¼š

ç”¨æˆ·           è®¤è¯ä¸­å¿ƒ(KDC)        åº”ç”¨æœåŠ¡å™¨
 |                 |                    |
 |--[1]è¯·æ±‚ç™»å½•---->|                    |
 |  (ç”¨æˆ·å+å¯†ç )   |                    |
 |                 |                    |
 |<--[2]è¿”å›ç¥¨æ®----|                    |
 |   (TGTç¥¨æ®)     |                    |
 |                 |                    |
 |--[3]è¯·æ±‚è®¿é—®------------------>|      |
 |  (æºå¸¦TGTç¥¨æ®)                  |      |
 |                                |      |
 |<--[4]è¿”å›æœåŠ¡ç¥¨æ®---------------|      |
 |   (Service Ticket)             |      |
 |                                       |
 |--[5]è®¿é—®æœåŠ¡------------------------->|
 |  (æºå¸¦Service Ticket)                |
 |                                       |
 |<--[6]è¿”å›ç»“æœ-------------------------|
```

**ğŸ” è¯¦ç»†æµç¨‹è¯´æ˜**ï¼š

**æ­¥éª¤1-2ï¼šè·å–ç¥¨æ®æˆäºˆç¥¨æ®(TGT)**
- ç”¨æˆ·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç 
- è®¤è¯ä¸­å¿ƒéªŒè¯åï¼Œé¢å‘ä¸€ä¸ª"é€šè¡Œè¯"(TGT)
- è¿™ä¸ªé€šè¡Œè¯æœ‰æ—¶æ•ˆæ€§ï¼Œé€šå¸¸æ˜¯8-10å°æ—¶

**æ­¥éª¤3-4ï¼šè·å–æœåŠ¡ç¥¨æ®**
- ç”¨æˆ·æ‹¿ç€TGTå‘è®¤è¯ä¸­å¿ƒè¯´ï¼š"æˆ‘è¦è®¿é—®æŸä¸ªæœåŠ¡"
- è®¤è¯ä¸­å¿ƒå†ç»™ä½ ä¸€å¼ "ä¸“ç”¨ç¥¨æ®"(Service Ticket)

**æ­¥éª¤5-6ï¼šè®¿é—®æœåŠ¡**
- ç”¨æˆ·æ‹¿ç€ä¸“ç”¨ç¥¨æ®è®¿é—®å…·ä½“æœåŠ¡
- æœåŠ¡å™¨éªŒè¯ç¥¨æ®æœ‰æ•ˆæ€§åæä¾›æœåŠ¡

### 1.3 ä¸ºä»€ä¹ˆè¦ç”¨Kerberos


| **åœºæ™¯** | **ä¼ ç»Ÿæ–¹å¼** | **Kerberosæ–¹å¼** | **ä¼˜åŠ¿** |
|---------|-------------|-----------------|---------|
| **ä¼ä¸šå†…ç½‘** | `æ¯ä¸ªç³»ç»Ÿå•ç‹¬ç™»å½•` | `ä¸€æ¬¡ç™»å½•ï¼Œå…¨ç½‘é€šè¡Œ` | `å•ç‚¹ç™»å½•ï¼Œæå‡æ•ˆç‡` |
| **å®‰å…¨æ€§** | `å¯†ç åœ¨ç½‘ç»œä¼ è¾“` | `åªä¼ è¾“åŠ å¯†ç¥¨æ®` | `å¯†ç ä¸æš´éœ²ç½‘ç»œ` |
| **å¤šç³»ç»Ÿåä½œ** | `ç»´æŠ¤å¤šå¥—è´¦å·` | `ç»Ÿä¸€è®¤è¯ä¸­å¿ƒ` | `é™ä½ç®¡ç†æˆæœ¬` |
| **WindowsåŸŸ** | `å•æœºè´¦å·ç®¡ç†` | `åŸŸæ§åˆ¶å™¨ç»Ÿä¸€ç®¡ç†` | `é›†ä¸­åŒ–æƒé™æ§åˆ¶` |

**ğŸ¯ å…¸å‹åº”ç”¨åœºæ™¯**ï¼š
- å¤§å‹ä¼ä¸šå†…éƒ¨åŠå…¬ç³»ç»Ÿï¼ˆOAã€ERPã€é‚®ä»¶ç³»ç»Ÿç­‰ï¼‰
- Windows Active DirectoryåŸŸç¯å¢ƒ
- é“¶è¡Œã€æ”¿åºœç­‰é«˜å®‰å…¨è¦æ±‚åœºæ™¯
- éœ€è¦å•ç‚¹ç™»å½•(SSO)çš„ä¼ä¸šåº”ç”¨

---

## 2. âš™ï¸ Spring Securityé›†æˆå®ç°


### 2.1 æ ¸å¿ƒç»„ä»¶ï¼šKerberosAuthenticationProvider


**æ¦‚å¿µè§£é‡Š**ï¼š
`KerberosAuthenticationProvider`æ˜¯Spring Securityæä¾›çš„Kerberosè®¤è¯å¤„ç†å™¨ï¼Œå®ƒçš„ä½œç”¨å°±åƒä¸€ä¸ª"ç¿»è¯‘å®˜"ï¼ŒæŠŠKerberosçš„ç¥¨æ®ç¿»è¯‘æˆSpring Securityèƒ½ç†è§£çš„ç”¨æˆ·èº«ä»½ä¿¡æ¯ã€‚

**ğŸ”§ åŸºç¡€é…ç½®ç»“æ„**ï¼š

```
Spring Security + Kerberosæ¶æ„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Spring Security è¿‡æ»¤å™¨é“¾                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   SpnegoAuthenticationProcessingFilter      â”‚   â”‚
â”‚  â”‚   (å¤„ç†SPNEGOåè®®çš„HTTPè¯·æ±‚)                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                       â†“                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   KerberosAuthenticationProvider            â”‚   â”‚
â”‚  â”‚   (éªŒè¯Kerberosç¥¨æ®)                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                       â†“                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   KerberosServiceAuthenticationProvider     â”‚   â”‚
â”‚  â”‚   (ä¸KDCé€šä¿¡éªŒè¯)                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 å®æˆ˜é…ç½®ç¤ºä¾‹


**æ­¥éª¤1ï¼šæ·»åŠ ä¾èµ–**

```xml
<dependency>
    <groupId>org.springframework.security.kerberos</groupId>
    <artifactId>spring-security-kerberos-web</artifactId>
    <version>1.0.1.RELEASE</version>
</dependency>
```

**æ­¥éª¤2ï¼šåˆ›å»ºKerberosé…ç½®ç±»**

```java
@Configuration
@EnableWebSecurity
public class KerberosSecurityConfig {
    
    @Value("${kerberos.service-principal}")
    private String servicePrincipal;  // æœåŠ¡ä¸»ä½“åç§°
    
    @Value("${kerberos.keytab-location}")
    private String keytabLocation;    // å¯†é’¥æ–‡ä»¶ä½ç½®
    
    // é…ç½®Kerberosè®¤è¯æä¾›è€…
    @Bean
    public KerberosAuthenticationProvider kerberosAuthenticationProvider() {
        KerberosAuthenticationProvider provider = 
            new KerberosAuthenticationProvider();
        
        // è®¾ç½®ç”¨æˆ·è¯¦æƒ…æœåŠ¡ï¼ˆåŠ è½½ç”¨æˆ·æƒé™ç­‰ä¿¡æ¯ï¼‰
        provider.setUserDetailsService(userDetailsService());
        
        // è®¾ç½®Kerberoså®¢æˆ·ç«¯
        provider.setKerberosClient(kerberosClient());
        
        return provider;
    }
    
    // Kerberoså®¢æˆ·ç«¯é…ç½®
    @Bean
    public SunJaasKerberosClient kerberosClient() {
        SunJaasKerberosClient client = new SunJaasKerberosClient();
        client.setDebug(true);  // å¼€å‘æ—¶å¼€å¯è°ƒè¯•
        return client;
    }
}
```

**é…ç½®è¯´æ˜**ï¼š
- `servicePrincipal`ï¼šæœåŠ¡çš„èº«ä»½æ ‡è¯†ï¼Œæ ¼å¼é€šå¸¸æ˜¯ `HTTP/hostname@REALM`
- `keytabLocation`ï¼šå¯†é’¥æ–‡ä»¶è·¯å¾„ï¼ŒåŒ…å«æœåŠ¡çš„å‡­è¯ä¿¡æ¯
- `userDetailsService`ï¼šç”¨äºåŠ è½½ç”¨æˆ·çš„è§’è‰²å’Œæƒé™ä¿¡æ¯

### 2.3 ç¥¨æ®è®¤è¯æœºåˆ¶è¯¦è§£


**ç¥¨æ®çš„æ„æˆ**ï¼š

```
Kerberosç¥¨æ®ç»“æ„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ç¥¨æ®å¤´éƒ¨                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ç‰ˆæœ¬å·: 5                    â”‚   â”‚
â”‚  â”‚ ç¥¨æ®ç±»å‹: TGT/Service Ticket â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          åŠ å¯†æ•°æ®éƒ¨åˆ†                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ç”¨æˆ·èº«ä»½ä¿¡æ¯(Principal)      â”‚   â”‚
â”‚  â”‚ æœ‰æ•ˆæœŸ(èµ·å§‹-ç»“æŸæ—¶é—´)        â”‚   â”‚
â”‚  â”‚ ä¼šè¯å¯†é’¥                     â”‚   â”‚
â”‚  â”‚ æœåŠ¡åç§°                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**éªŒè¯æµç¨‹**ï¼š

```java
// Spring Securityå†…éƒ¨çš„éªŒè¯é€»è¾‘ï¼ˆç®€åŒ–è¯´æ˜ï¼‰
public Authentication authenticate(Authentication auth) {
    // 1. ä»è¯·æ±‚ä¸­æå–ç¥¨æ®
    KerberosServiceRequestToken token = 
        (KerberosServiceRequestToken) auth;
    
    // 2. è§£å¯†å¹¶éªŒè¯ç¥¨æ®
    String username = kerberosClient.login(
        token.getToken(),
        servicePrincipal,
        keytabLocation
    );
    
    // 3. åŠ è½½ç”¨æˆ·è¯¦ç»†ä¿¡æ¯ï¼ˆè§’è‰²ã€æƒé™ç­‰ï¼‰
    UserDetails user = userDetailsService.loadUserByUsername(username);
    
    // 4. åˆ›å»ºè®¤è¯æˆåŠŸçš„å‡­è¯
    return new UsernamePasswordAuthenticationToken(
        user, 
        token.getCredentials(), 
        user.getAuthorities()
    );
}
```

---

## 3. ğŸŒ SPNEGOåè®®åº”ç”¨


### 3.1 SPNEGOæ˜¯ä»€ä¹ˆ


> **ç®€å•ç†è§£**ï¼šSPNEGOå°±åƒä¸€ä¸ª"è¯­è¨€è½¬æ¢å™¨"ï¼Œå®ƒæŠŠKerberosçš„ç¥¨æ®åŒ…è£…æˆHTTPåè®®èƒ½ä¼ è¾“çš„æ ¼å¼ã€‚å°±åƒæŠŠå®ä½“ç¥¨æ®è½¬æ¢æˆäºŒç»´ç ä¸€æ ·ã€‚

**å…¨ç§°**ï¼šSimple and Protected GSSAPI Negotiation Mechanismï¼ˆç®€å•ä¿æŠ¤GSS-APIåå•†æœºåˆ¶ï¼‰

**ä½œç”¨**ï¼šåœ¨Webæµè§ˆå™¨å’ŒæœåŠ¡å™¨ä¹‹é—´ä¼ é€’Kerberosè®¤è¯ä¿¡æ¯

### 3.2 SPNEGOå·¥ä½œæµç¨‹


```
æµè§ˆå™¨ä¸æœåŠ¡å™¨çš„SPNEGOäº¤äº’ï¼š

æµè§ˆå™¨                  WebæœåŠ¡å™¨                 KDC
  |                        |                      |
  |--[1]è®¿é—®ç½‘é¡µ----------->|                      |
  |                        |                      |
  |<--[2]è¿”å›401æœªæˆæƒ------|                      |
  |  WWW-Authenticate:     |                      |
  |  Negotiate             |                      |
  |                        |                      |
  |--[3]è¯·æ±‚ç¥¨æ®---------------------------->|     |
  |                                          |     |
  |<--[4]è¿”å›ç¥¨æ®----------------------------|     |
  |                                                |
  |--[5]æºå¸¦ç¥¨æ®è®¿é—®----->|                        |
  |  Authorization:       |                        |
  |  Negotiate <ç¥¨æ®>     |                        |
  |                       |                        |
  |<--[6]éªŒè¯æˆåŠŸè¿”å›-----|                        |
  |  200 OK               |                        |
```

**è¯¦ç»†æ­¥éª¤è¯´æ˜**ï¼š

**â‘  åˆæ¬¡è®¿é—®**ï¼š
- ç”¨æˆ·æµè§ˆå™¨è®¿é—®å—ä¿æŠ¤çš„ç½‘é¡µ
- æœåŠ¡å™¨å‘ç°æ²¡æœ‰è®¤è¯ä¿¡æ¯

**â‘¡ è¦æ±‚è®¤è¯**ï¼š
- æœåŠ¡å™¨è¿”å›401çŠ¶æ€ç 
- å“åº”å¤´åŒ…å« `WWW-Authenticate: Negotiate`
- è¿™å‘Šè¯‰æµè§ˆå™¨ï¼š"æˆ‘éœ€è¦Kerberosè®¤è¯"

**â‘¢ è·å–ç¥¨æ®**ï¼š
- æµè§ˆå™¨è‡ªåŠ¨å‘KDCè¯·æ±‚æœåŠ¡ç¥¨æ®
- ç”¨æˆ·æ— æ„ŸçŸ¥ï¼Œæµè§ˆå™¨è‡ªåŠ¨å®Œæˆ

**â‘£ æäº¤ç¥¨æ®**ï¼š
- æµè§ˆå™¨åœ¨è¯·æ±‚å¤´ä¸­åŠ å…¥ç¥¨æ®
- æ ¼å¼ï¼š`Authorization: Negotiate <Base64ç¼–ç çš„ç¥¨æ®>`

**â‘¤ éªŒè¯è®¿é—®**ï¼š
- æœåŠ¡å™¨éªŒè¯ç¥¨æ®æœ‰æ•ˆæ€§
- éªŒè¯é€šè¿‡åˆ™è¿”å›è¯·æ±‚çš„èµ„æº

### 3.3 Spring Security SPNEGOé…ç½®


```java
@Configuration
public class SpnegoConfig {
    
    // SPNEGOè®¤è¯è¿‡æ»¤å™¨é…ç½®
    @Bean
    public SpnegoAuthenticationProcessingFilter spnegoFilter() {
        SpnegoAuthenticationProcessingFilter filter = 
            new SpnegoAuthenticationProcessingFilter();
        
        // è®¾ç½®è®¤è¯ç®¡ç†å™¨
        filter.setAuthenticationManager(authenticationManager());
        
        // è®¤è¯æˆåŠŸåçš„å¤„ç†
        filter.setSuccessHandler((request, response, auth) -> {
            response.setStatus(HttpServletResponse.SC_OK);
        });
        
        // è®¤è¯å¤±è´¥çš„å¤„ç†
        filter.setFailureHandler((request, response, exception) -> {
            response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
            response.setHeader("WWW-Authenticate", "Negotiate");
        });
        
        return filter;
    }
    
    // KerberosæœåŠ¡è®¤è¯æä¾›è€…
    @Bean
    public KerberosServiceAuthenticationProvider kerberosServiceProvider() {
        KerberosServiceAuthenticationProvider provider = 
            new KerberosServiceAuthenticationProvider();
        
        provider.setTicketValidator(sunJaasKerberosTicketValidator());
        provider.setUserDetailsService(userDetailsService());
        
        return provider;
    }
    
    // ç¥¨æ®éªŒè¯å™¨
    @Bean
    public SunJaasKerberosTicketValidator sunJaasKerberosTicketValidator() {
        SunJaasKerberosTicketValidator validator = 
            new SunJaasKerberosTicketValidator();
        
        validator.setServicePrincipal("HTTP/myapp.example.com@EXAMPLE.COM");
        validator.setKeyTabLocation(new FileSystemResource("/etc/krb5.keytab"));
        validator.setDebug(true);
        
        return validator;
    }
}
```

**é…ç½®æ–‡ä»¶ç¤ºä¾‹**ï¼š

```properties
# application.properties
kerberos.service-principal=HTTP/myapp.example.com@EXAMPLE.COM
kerberos.keytab-location=/etc/security/http.keytab
kerberos.realm=EXAMPLE.COM
kerberos.kdc-address=kdc.example.com
```

---

## 4. ğŸ–¥ï¸ WindowsåŸŸç¯å¢ƒé›†æˆ


### 4.1 åŸŸæ§åˆ¶å™¨(DC)åŸºç¡€æ¦‚å¿µ


> **ç”Ÿæ´»åŒ–æ¯”å–»**ï¼šåŸŸæ§åˆ¶å™¨å°±åƒå°åŒºçš„ç‰©ä¸šç®¡ç†ä¸­å¿ƒï¼Œå®ƒç®¡ç†ç€æ•´ä¸ªå°åŒºï¼ˆä¼ä¸šç½‘ç»œï¼‰çš„æ‰€æœ‰ä½æˆ·ï¼ˆç”¨æˆ·å’Œè®¡ç®—æœºï¼‰ï¼Œç»Ÿä¸€å‘æ”¾é—¨ç¦å¡ï¼ˆè´¦å·ï¼‰ï¼Œæ§åˆ¶è°èƒ½è¿›å…¥å“ªäº›åŒºåŸŸï¼ˆæƒé™ï¼‰ã€‚

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š

**Active Directory (AD)**ï¼š
- å°±æ˜¯Windowsçš„"ç”¨æˆ·æ•°æ®åº“"
- å­˜å‚¨æ‰€æœ‰ç”¨æˆ·è´¦å·ã€å¯†ç ã€æƒé™ä¿¡æ¯
- ç±»ä¼¼äºä¼ä¸šçš„"èŠ±åå†Œ"å’Œ"é€šè®¯å½•"

**åŸŸ(Domain)**ï¼š
- ä¸€ä¸ªç®¡ç†è¾¹ç•Œï¼Œæ¯”å¦‚ `company.com`
- åŸŸå†…çš„æ‰€æœ‰è®¡ç®—æœºå’Œç”¨æˆ·ç»Ÿä¸€ç®¡ç†
- ç±»ä¼¼äºä¸€ä¸ªç‹¬ç«‹çš„"ç®¡ç†åŒº"

**åŸŸæ§åˆ¶å™¨(DC)**ï¼š
- ç®¡ç†åŸŸçš„æœåŠ¡å™¨
- è´Ÿè´£ç”¨æˆ·è®¤è¯å’Œæƒé™æ§åˆ¶
- å°±åƒ"æ€»ç®¡å®¶"

### 4.2 Javaåº”ç”¨æ¥å…¥WindowsåŸŸ


**åœºæ™¯è¯´æ˜**ï¼š
å‡è®¾ä½ çš„Javaåº”ç”¨éƒ¨ç½²åœ¨WindowsæœåŠ¡å™¨ä¸Šï¼Œç”¨æˆ·é€šè¿‡æµè§ˆå™¨è®¿é—®æ—¶ï¼Œéœ€è¦è‡ªåŠ¨ä½¿ç”¨WindowsåŸŸè´¦å·ç™»å½•ï¼Œæ— éœ€å†æ¬¡è¾“å…¥å¯†ç ã€‚

**é›†æˆæ¶æ„**ï¼š

```
WindowsåŸŸé›†æˆæ¶æ„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å®¢æˆ·ç«¯(æµè§ˆå™¨)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  IE/Chrome (å·²åŠ å…¥åŸŸ)                      â”‚  â”‚
â”‚  â”‚  ç™»å½•ç”¨æˆ·: alice@COMPANY.COM               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“ (è‡ªåŠ¨è·å–åŸŸå‡­è¯)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Javaåº”ç”¨æœåŠ¡å™¨                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Spring Security + SPNEGO                  â”‚  â”‚
â”‚  â”‚  â†“                                         â”‚  â”‚
â”‚  â”‚  éªŒè¯Kerberosç¥¨æ®                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“ (ç¥¨æ®éªŒè¯)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         WindowsåŸŸæ§åˆ¶å™¨(AD/KDC)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Active Directory                          â”‚  â”‚
â”‚  â”‚  Kerberos KDC                              â”‚  â”‚
â”‚  â”‚  ç”¨æˆ·æ•°æ®åº“                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 å®æˆ˜é…ç½®æ­¥éª¤


**æ­¥éª¤1ï¼šåœ¨åŸŸæ§åˆ¶å™¨åˆ›å»ºæœåŠ¡è´¦å·**

```powershell
# åœ¨åŸŸæ§åˆ¶å™¨ä¸Šæ‰§è¡Œï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰

# åˆ›å»ºæœåŠ¡è´¦å·
New-ADUser -Name "webapp-service" -UserPrincipalName "HTTP/webapp.company.com@COMPANY.COM"

# ç”Ÿæˆkeytabæ–‡ä»¶
ktpass -princ HTTP/webapp.company.com@COMPANY.COM `
       -mapuser webapp-service@COMPANY.COM `
       -pass MySecurePassword123 `
       -out webapp.keytab
```

**æ­¥éª¤2ï¼šé…ç½®Javaåº”ç”¨çš„krb5.conf**

```ini
# /etc/krb5.conf (Linux) æˆ– C:\Windows\krb5.ini (Windows)

[libdefaults]
    default_realm = COMPANY.COM
    dns_lookup_realm = false
    dns_lookup_kdc = true
    ticket_lifetime = 24h
    renew_lifetime = 7d
    forwardable = true

[realms]
    COMPANY.COM = {
        kdc = dc1.company.com
        kdc = dc2.company.com
        admin_server = dc1.company.com
    }

[domain_realm]
    .company.com = COMPANY.COM
    company.com = COMPANY.COM
```

**é…ç½®è¯´æ˜**ï¼š
- `default_realm`ï¼šé»˜è®¤åŸŸåï¼ˆå¿…é¡»å¤§å†™ï¼‰
- `kdc`ï¼šåŸŸæ§åˆ¶å™¨åœ°å€ï¼ˆå¯é…ç½®å¤šä¸ªå®ç°é«˜å¯ç”¨ï¼‰
- `admin_server`ï¼šç®¡ç†æœåŠ¡å™¨åœ°å€
- `ticket_lifetime`ï¼šç¥¨æ®æœ‰æ•ˆæœŸ

**æ­¥éª¤3ï¼šSpring Securityå®Œæ•´é…ç½®**

```java
@Configuration
@EnableWebSecurity
public class WindowsAuthConfig extends WebSecurityConfigurerAdapter {
    
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
            .authorizeRequests()
                .antMatchers("/public/**").permitAll()
                .anyRequest().authenticated()
                .and()
            .addFilterBefore(
                spnegoAuthenticationProcessingFilter(),
                BasicAuthenticationFilter.class
            );
    }
    
    @Bean
    public SpnegoAuthenticationProcessingFilter spnegoAuthenticationProcessingFilter() {
        SpnegoAuthenticationProcessingFilter filter = 
            new SpnegoAuthenticationProcessingFilter();
        filter.setAuthenticationManager(authenticationManagerBean());
        return filter;
    }
    
    @Bean
    public KerberosServiceAuthenticationProvider kerberosServiceAuthenticationProvider() {
        KerberosServiceAuthenticationProvider provider = 
            new KerberosServiceAuthenticationProvider();
        
        provider.setTicketValidator(sunJaasKerberosTicketValidator());
        provider.setUserDetailsService(activeDirectoryUserDetailsService());
        
        return provider;
    }
    
    // è¿æ¥Active Directoryè·å–ç”¨æˆ·ä¿¡æ¯
    @Bean
    public UserDetailsService activeDirectoryUserDetailsService() {
        ActiveDirectoryLdapAuthenticationProvider adProvider = 
            new ActiveDirectoryLdapAuthenticationProvider(
                "company.com",              // åŸŸå
                "ldap://dc1.company.com/"   // LDAPæœåŠ¡å™¨åœ°å€
            );
        
        return adProvider.getUserDetailsService();
    }
    
    @Bean
    public SunJaasKerberosTicketValidator sunJaasKerberosTicketValidator() {
        SunJaasKerberosTicketValidator validator = 
            new SunJaasKerberosTicketValidator();
        
        validator.setServicePrincipal("HTTP/webapp.company.com@COMPANY.COM");
        validator.setKeyTabLocation(new FileSystemResource("/etc/webapp.keytab"));
        
        return validator;
    }
}
```

### 4.4 å®¢æˆ·ç«¯æµè§ˆå™¨é…ç½®


**IE/Edgeæµè§ˆå™¨é…ç½®**ï¼š

```
æ­¥éª¤ï¼š
â‘  æ‰“å¼€"Interneté€‰é¡¹"
â‘¡ é€‰æ‹©"å®‰å…¨"é€‰é¡¹å¡
â‘¢ ç‚¹å‡»"æœ¬åœ°Intranet" â†’ "ç«™ç‚¹" â†’ "é«˜çº§"
â‘£ æ·»åŠ ï¼šhttp://webapp.company.com
â‘¤ ç¡®å®šä¿å­˜

è¿™æ ·æµè§ˆå™¨å°±ä¼šè‡ªåŠ¨ä½¿ç”¨WindowsåŸŸå‡­è¯è¿›è¡Œè®¤è¯
```

**Chromeæµè§ˆå™¨é…ç½®**ï¼š

```
Windowsç³»ç»Ÿï¼š
â‘  å¯åŠ¨å‚æ•°æ·»åŠ ï¼š--auth-server-whitelist="*.company.com"
â‘¡ æˆ–è€…ä½¿ç”¨ç»„ç­–ç•¥é…ç½®

ç¤ºä¾‹ï¼š
chrome.exe --auth-server-whitelist="*.company.com"
```

---

## 5. ğŸŒ è·¨åŸŸä¿¡ä»»é…ç½®


### 5.1 ä»€ä¹ˆæ˜¯è·¨åŸŸä¿¡ä»»


> **ç”Ÿæ´»åŒ–æ¯”å–»**ï¼šå°±åƒä¸¤ä¸ªåŸå¸‚ä¹‹é—´ç­¾è®¢äº†"å‹å¥½åŸå¸‚åè®®"ï¼ŒAå¸‚çš„å¸‚æ°‘å¯ä»¥å‡­æœ¬å¸‚èº«ä»½è¯åœ¨Bå¸‚äº«å—æŸäº›æœåŠ¡ï¼Œä¸éœ€è¦é‡æ–°åŠç†Bå¸‚çš„èº«ä»½è¯ã€‚

**åº”ç”¨åœºæ™¯**ï¼š
- å…¬å¸æœ‰å¤šä¸ªåŸŸï¼šé”€å”®éƒ¨åŸŸã€ç ”å‘éƒ¨åŸŸã€è´¢åŠ¡éƒ¨åŸŸ
- è·¨å›½ä¼ä¸šï¼šä¸­å›½åŒºåŸŸã€ç¾å›½åŒºåŸŸå„æœ‰ç‹¬ç«‹åŸŸ
- åˆå¹¶åçš„å…¬å¸ï¼šåŸAå…¬å¸åŸŸã€åŸBå…¬å¸åŸŸéœ€è¦äº’é€š

### 5.2 ä¿¡ä»»å…³ç³»ç±»å‹


| **ä¿¡ä»»ç±»å‹** | **è¯´æ˜** | **åº”ç”¨åœºæ™¯** |
|-------------|---------|-------------|
| **å•å‘ä¿¡ä»»** | `AåŸŸä¿¡ä»»BåŸŸï¼ŒBåŸŸç”¨æˆ·å¯è®¿é—®AåŸŸèµ„æº` | `å­å…¬å¸è®¿é—®æ€»éƒ¨èµ„æº` |
| **åŒå‘ä¿¡ä»»** | `AåŸŸå’ŒBåŸŸäº’ç›¸ä¿¡ä»»` | `éƒ¨é—¨é—´èµ„æºå…±äº«` |
| **ä¼ é€’ä¿¡ä»»** | `Aä¿¡ä»»Bï¼ŒBä¿¡ä»»Cï¼Œåˆ™Aä¹Ÿä¿¡ä»»C` | `å¤šå±‚ç»„ç»‡ç»“æ„` |
| **æ—ä¿¡ä»»** | `ä¸¤ä¸ªADæ—ä¹‹é—´çš„ä¿¡ä»»` | `è·¨å…¬å¸åˆä½œ` |

### 5.3 è·¨åŸŸè®¤è¯æµç¨‹


```
è·¨åŸŸKerberosè®¤è¯æµç¨‹ï¼š

ç”¨æˆ·@åŸŸA          åŸŸAçš„KDC        åŸŸBçš„KDC        åŸŸBçš„æœåŠ¡
  |                 |               |                |
  |--[1]è¯·æ±‚TGT---->|               |                |
  |                 |               |                |
  |<--[2]è¿”å›TGT----|               |                |
  |                 |               |                |
  |--[3]è¯·æ±‚è·¨åŸŸç¥¨æ®->|              |                |
  |                 |               |                |
  |                 |--[4]è½¬å‘è¯·æ±‚-->|                |
  |                 |               |                |
  |                 |<--[5]è¿”å›ç¥¨æ®--|                |
  |                 |               |                |
  |<--[6]è¿”å›ç¥¨æ®---|               |                |
  |                 |                                |
  |--[7]æºå¸¦ç¥¨æ®è®¿é—®----------------------------->|  |
  |                                                |  |
  |<--[8]éªŒè¯æˆåŠŸè¿”å›-----------------------------|  |
```

**å…³é”®ç‚¹è¯´æ˜**ï¼š
- ç”¨æˆ·é¦–å…ˆåœ¨è‡ªå·±çš„åŸŸï¼ˆåŸŸAï¼‰è·å–TGT
- è®¿é—®å…¶ä»–åŸŸï¼ˆåŸŸBï¼‰çš„æœåŠ¡æ—¶ï¼ŒåŸŸAçš„KDCä¼šå¼•å¯¼ç”¨æˆ·å»åŸŸBçš„KDC
- åŸŸBçš„KDCéªŒè¯ä¿¡ä»»å…³ç³»åï¼Œé¢å‘è·¨åŸŸæœåŠ¡ç¥¨æ®
- ç”¨æˆ·ä½¿ç”¨è·¨åŸŸç¥¨æ®è®¿é—®åŸŸBçš„æœåŠ¡

### 5.4 Spring Securityè·¨åŸŸé…ç½®


```java
@Configuration
public class CrossRealmKerberosConfig {
    
    @Bean
    public KerberosServiceAuthenticationProvider crossRealmKerberosProvider() {
        KerberosServiceAuthenticationProvider provider = 
            new KerberosServiceAuthenticationProvider();
        
        // é…ç½®æ”¯æŒå¤šä¸ªåŸŸ
        provider.setTicketValidator(multiRealmTicketValidator());
        provider.setUserDetailsService(crossRealmUserDetailsService());
        
        return provider;
    }
    
    @Bean
    public SunJaasKerberosTicketValidator multiRealmTicketValidator() {
        SunJaasKerberosTicketValidator validator = 
            new SunJaasKerberosTicketValidator();
        
        // é…ç½®æœåŠ¡ä¸»ä½“ï¼ˆæ”¯æŒå¤šåŸŸï¼‰
        validator.setServicePrincipal("HTTP/app.domainA.com@DOMAINA.COM");
        
        // è®¾ç½®keytabæ–‡ä»¶
        validator.setKeyTabLocation(new FileSystemResource("/etc/multi-realm.keytab"));
        
        return validator;
    }
    
    // æ”¯æŒå¤šåŸŸçš„ç”¨æˆ·è¯¦æƒ…æœåŠ¡
    @Bean
    public UserDetailsService crossRealmUserDetailsService() {
        return username -> {
            // è§£æç”¨æˆ·åä¸­çš„åŸŸä¿¡æ¯
            // æ ¼å¼: alice@DOMAINA.COM æˆ– bob@DOMAINB.COM
            String[] parts = username.split("@");
            String user = parts[0];
            String realm = parts.length > 1 ? parts[1] : "DOMAINA.COM";
            
            // æ ¹æ®åŸŸé€‰æ‹©ä¸åŒçš„ç”¨æˆ·æ•°æ®æº
            if ("DOMAINA.COM".equals(realm)) {
                return loadFromDomainA(user);
            } else if ("DOMAINB.COM".equals(realm)) {
                return loadFromDomainB(user);
            }
            
            throw new UsernameNotFoundException("User not found: " + username);
        };
    }
    
    private UserDetails loadFromDomainA(String username) {
        // ä»åŸŸAçš„ADåŠ è½½ç”¨æˆ·ä¿¡æ¯
        // å®ç°ç»†èŠ‚...
        return User.withUsername(username)
                .password("N/A")
                .authorities("ROLE_DOMAIN_A_USER")
                .build();
    }
    
    private UserDetails loadFromDomainB(String username) {
        // ä»åŸŸBçš„ADåŠ è½½ç”¨æˆ·ä¿¡æ¯
        // å®ç°ç»†èŠ‚...
        return User.withUsername(username)
                .password("N/A")
                .authorities("ROLE_DOMAIN_B_USER")
                .build();
    }
}
```

**å¤šåŸŸkrb5.confé…ç½®**ï¼š

```ini
[libdefaults]
    default_realm = DOMAINA.COM
    dns_lookup_realm = false
    dns_lookup_kdc = true

[realms]
    DOMAINA.COM = {
        kdc = kdc1.domainA.com
        admin_server = kdc1.domainA.com
    }
    
    DOMAINB.COM = {
        kdc = kdc1.domainB.com
        admin_server = kdc1.domainB.com
    }

[domain_realm]
    .domainA.com = DOMAINA.COM
    .domainB.com = DOMAINB.COM

[capaths]
    DOMAINA.COM = {
        DOMAINB.COM = .
    }
    DOMAINB.COM = {
        DOMAINA.COM = .
    }
```

**é…ç½®è¯´æ˜**ï¼š
- `[capaths]`ï¼šå®šä¹‰è·¨åŸŸè®¤è¯è·¯å¾„
- `.` è¡¨ç¤ºç›´æ¥ä¿¡ä»»å…³ç³»
- é…ç½®åŒå‘è·¯å¾„å®ç°åŒå‘ä¿¡ä»»

---

## 6. ğŸ”’ ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ


### 6.1 å®‰å…¨é…ç½®æ£€æŸ¥æ¸…å•


**âœ… åŸºç¡€å®‰å…¨**

| **æ£€æŸ¥é¡¹** | **é…ç½®å»ºè®®** | **é£é™©ç­‰çº§** |
|-----------|-------------|-------------|
| **å¯†é’¥æ–‡ä»¶æƒé™** | `chmod 400 keytab` ä»…æ‰€æœ‰è€…å¯è¯» | `ğŸ”´ é«˜` |
| **æœåŠ¡ä¸»ä½“å¯†ç ** | `ä½¿ç”¨å¼ºå¯†ç ï¼Œå®šæœŸè½®æ¢` | `ğŸ”´ é«˜` |
| **ç¥¨æ®æœ‰æ•ˆæœŸ** | `ä¸è¶…è¿‡24å°æ—¶ï¼Œæ•æ„Ÿç³»ç»Ÿ8å°æ—¶` | `ğŸŸ¡ ä¸­` |
| **ä¼ è¾“åŠ å¯†** | `å¿…é¡»ä½¿ç”¨HTTPS` | `ğŸ”´ é«˜` |
| **è°ƒè¯•æ¨¡å¼** | `ç”Ÿäº§ç¯å¢ƒå…³é—­debug` | `ğŸŸ¡ ä¸­` |

**é…ç½®ç¤ºä¾‹**ï¼š

```properties
# ç”Ÿäº§ç¯å¢ƒé…ç½®
kerberos.debug=false
kerberos.ticket.max-lifetime=8h
kerberos.ticket.renewable=true
kerberos.require-https=true

# å¯†é’¥æ–‡ä»¶æƒé™ï¼ˆLinuxï¼‰
# chmod 400 /etc/security/*.keytab
# chown appuser:appgroup /etc/security/*.keytab
```

### 6.2 é«˜å¯ç”¨æ¶æ„è®¾è®¡


**å¤šKDCéƒ¨ç½²**ï¼š

```
é«˜å¯ç”¨Kerberosæ¶æ„ï¼š

                      è´Ÿè½½å‡è¡¡å™¨
                          |
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            |                           |
        ä¸»KDC                        å¤‡KDC
   (kdc1.example.com)          (kdc2.example.com)
            |                           |
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       |
                   ADæ•°æ®åº“
              (ä¸»ä»å¤åˆ¶åŒæ­¥)
```

**Springé…ç½®æ”¯æŒå¤šKDC**ï¼š

```java
@Bean
public SunJaasKerberosTicketValidator kerberosTicketValidator() {
    SunJaasKerberosTicketValidator validator = 
        new SunJaasKerberosTicketValidator();
    
    validator.setServicePrincipal(servicePrincipal);
    validator.setKeyTabLocation(new FileSystemResource(keytabPath));
    
    // é…ç½®å¤šä¸ªKDCï¼Œè‡ªåŠ¨æ•…éšœè½¬ç§»
    validator.setKdcTimeout(5000);  // 5ç§’è¶…æ—¶
    validator.setRetryCount(3);     // é‡è¯•3æ¬¡
    
    return validator;
}
```

**krb5.confå¤šKDCé…ç½®**ï¼š

```ini
[realms]
    EXAMPLE.COM = {
        kdc = kdc1.example.com
        kdc = kdc2.example.com      # å¤‡ç”¨KDC
        kdc = kdc3.example.com      # å¤‡ç”¨KDC
        admin_server = kdc1.example.com
        default_domain = example.com
    }
```

### 6.3 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


**ç¥¨æ®ç¼“å­˜ä¼˜åŒ–**ï¼š

```java
@Configuration
public class KerberosPerformanceConfig {
    
    @Bean
    public CacheManager ticketCacheManager() {
        // ä½¿ç”¨Caffeineç¼“å­˜ç¥¨æ®éªŒè¯ç»“æœ
        CaffeineCacheManager cacheManager = new CaffeineCacheManager("kerberos-tickets");
        cacheManager.setCaffeine(
            Caffeine.newBuilder()
                .expireAfterWrite(10, TimeUnit.MINUTES)  // 10åˆ†é’Ÿè¿‡æœŸ
                .maximumSize(10000)                      // æœ€å¤šç¼“å­˜1ä¸‡ä¸ª
                .recordStats()                           // è®°å½•ç»Ÿè®¡ä¿¡æ¯
        );
        return cacheManager;
    }
    
    // ç¼“å­˜ç”¨æˆ·è¯¦æƒ…ï¼Œå‡å°‘LDAPæŸ¥è¯¢
    @Cacheable(value = "user-details", key = "#username")
    public UserDetails loadUserByUsername(String username) {
        // ä»ADåŠ è½½ç”¨æˆ·ä¿¡æ¯
        return activeDirectoryLdapAuthenticationProvider
                .loadUserByUsername(username);
    }
}
```

**è¿æ¥æ± é…ç½®**ï¼š

```java
@Bean
public LdapContextSource ldapContextSource() {
    LdapContextSource contextSource = new LdapContextSource();
    contextSource.setUrl("ldap://dc.example.com:389");
    contextSource.setBase("dc=example,dc=com");
    
    // è¿æ¥æ± é…ç½®
    contextSource.setPooled(true);
    contextSource.setPoolMinSize(5);
    contextSource.setPoolMaxSize(50);
    contextSource.setPoolValidationEnabled(true);
    
    return contextSource;
}
```

### 6.4 æ•…éšœæ’æŸ¥æŠ€å·§


**å¸¸è§é—®é¢˜è¯Šæ–­è¡¨**ï¼š

| **é—®é¢˜ç°è±¡** | **å¯èƒ½åŸå› ** | **è§£å†³æ–¹æ¡ˆ** |
|-------------|-------------|-------------|
| **401 Unauthorized** | `æµè§ˆå™¨æœªé…ç½®/ç¥¨æ®è¿‡æœŸ` | `æ£€æŸ¥æµè§ˆå™¨ç™½åå•ï¼ŒéªŒè¯ç¥¨æ®æœ‰æ•ˆæœŸ` |
| **Clock skew too great** | `æ—¶é’Ÿåå·®è¶…è¿‡5åˆ†é’Ÿ` | `åŒæ­¥æœåŠ¡å™¨æ—¶é—´ï¼Œé…ç½®NTP` |
| **Principal not found** | `æœåŠ¡ä¸»ä½“ä¸å­˜åœ¨` | `æ£€æŸ¥keytabæ–‡ä»¶ï¼ŒéªŒè¯ADè´¦å·` |
| **Cannot contact KDC** | `ç½‘ç»œä¸é€š/KDCå®•æœº` | `æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼ŒéªŒè¯KDCçŠ¶æ€` |
| **Checksum failed** | `å¯†é’¥ä¸åŒ¹é…` | `é‡æ–°ç”Ÿæˆkeytabæ–‡ä»¶` |

**è°ƒè¯•æ—¥å¿—é…ç½®**ï¼š

```properties
# application.properties (å¼€å‘/æµ‹è¯•ç¯å¢ƒ)
logging.level.org.springframework.security.kerberos=DEBUG
logging.level.org.springframework.security.web=DEBUG

# è¾“å‡ºKerberosè¯¦ç»†æ—¥å¿—
sun.security.krb5.debug=true
```

**æ‰‹åŠ¨éªŒè¯å·¥å…·**ï¼š

```bash
# Linuxä¸‹éªŒè¯Kerberosé…ç½®

# 1. è·å–ç¥¨æ®
kinit -kt /etc/webapp.keytab HTTP/webapp.example.com@EXAMPLE.COM

# 2. æŸ¥çœ‹ç¥¨æ®
klist -e

# 3. éªŒè¯æœåŠ¡ä¸»ä½“
kvno HTTP/webapp.example.com@EXAMPLE.COM

# 4. æµ‹è¯•LDAPè¿æ¥
ldapsearch -H ldap://dc.example.com -x -b "dc=example,dc=com" "(sAMAccountName=alice)"
```

### 6.5 ç›‘æ§å‘Šè­¦é…ç½®


```java
@Component
public class KerberosHealthIndicator implements HealthIndicator {
    
    @Autowired
    private SunJaasKerberosTicketValidator ticketValidator;
    
    @Override
    public Health health() {
        try {
            // éªŒè¯KDCè¿æ¥
            validateKdcConnection();
            
            // æ£€æŸ¥keytabæ–‡ä»¶
            validateKeytabFile();
            
            // æ£€æŸ¥ç¥¨æ®ç¼“å­˜å‘½ä¸­ç‡
            double hitRate = getCacheHitRate();
            
            if (hitRate < 0.7) {
                return Health.up()
                    .withDetail("cache-hit-rate", hitRate)
                    .withDetail("warning", "ç¼“å­˜å‘½ä¸­ç‡åä½")
                    .build();
            }
            
            return Health.up()
                .withDetail("status", "Kerberosè®¤è¯æ­£å¸¸")
                .withDetail("cache-hit-rate", hitRate)
                .build();
                
        } catch (Exception e) {
            return Health.down()
                .withDetail("error", e.getMessage())
                .build();
        }
    }
    
    private void validateKdcConnection() throws Exception {
        // éªŒè¯KDCè¿æ¥é€»è¾‘
        // å¯ä»¥å°è¯•è·å–ä¸€ä¸ªæµ‹è¯•ç¥¨æ®
    }
    
    private void validateKeytabFile() throws Exception {
        // éªŒè¯keytabæ–‡ä»¶å­˜åœ¨ä¸”å¯è¯»
        File keytab = new File(keytabPath);
        if (!keytab.exists() || !keytab.canRead()) {
            throw new RuntimeException("Keytabæ–‡ä»¶ä¸å¯ç”¨");
        }
    }
    
    private double getCacheHitRate() {
        // è·å–ç¼“å­˜å‘½ä¸­ç‡
        Cache cache = cacheManager.getCache("kerberos-tickets");
        // å®ç°ç»Ÿè®¡é€»è¾‘
        return 0.85;  // ç¤ºä¾‹è¿”å›å€¼
    }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Kerberosæœ¬è´¨ï¼šåŸºäºç¥¨æ®çš„å¯ä¿¡ç¬¬ä¸‰æ–¹è®¤è¯åè®®
ğŸ”¸ æ ¸å¿ƒç»„ä»¶ï¼šKDC(è®¤è¯ä¸­å¿ƒ)ã€TGT(ç¥¨æ®æˆäºˆç¥¨æ®)ã€Service Ticket(æœåŠ¡ç¥¨æ®)
ğŸ”¸ SPNEGOä½œç”¨ï¼šåœ¨HTTPåè®®ä¸Šä¼ è¾“Kerberosè®¤è¯ä¿¡æ¯
ğŸ”¸ WindowsåŸŸé›†æˆï¼šé€šè¿‡ADå’ŒKerberoså®ç°ä¼ä¸šçº§å•ç‚¹ç™»å½•
ğŸ”¸ è·¨åŸŸä¿¡ä»»ï¼šæ”¯æŒå¤šåŸŸç¯å¢ƒä¸‹çš„ç»Ÿä¸€è®¤è¯
ğŸ”¸ å®‰å…¨è¦ç‚¹ï¼šå¯†é’¥ä¿æŠ¤ã€ç¥¨æ®æœ‰æ•ˆæœŸã€æ—¶é’ŸåŒæ­¥
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ è®¤è¯æµç¨‹çš„æ ¸å¿ƒé€»è¾‘**
```
ä¸‰æ­¥éªŒè¯æœºåˆ¶ï¼š
â‘  ç”¨æˆ·å‘KDCè¯æ˜èº«ä»½ â†’ è·å¾—TGT
â‘¡ ç”¨æˆ·å‡­TGTå‘KDCç”³è¯·æœåŠ¡ç¥¨æ® â†’ è·å¾—Service Ticket  
â‘¢ ç”¨æˆ·å‡­Service Ticketè®¿é—®æœåŠ¡ â†’ å®Œæˆè®¤è¯

æ ¸å¿ƒä¼˜åŠ¿ï¼šå¯†ç ä¸åœ¨ç½‘ç»œä¼ è¾“ï¼Œç¥¨æ®æœ‰æ—¶æ•ˆæ€§
```

**ğŸ”¹ Spring Securityé›†æˆè¦ç‚¹**
```
ä¸‰ä¸ªå…³é”®ç»„ä»¶ï¼š
â‘  SpnegoAuthenticationProcessingFilter - å¤„ç†HTTPè¯·æ±‚
â‘¡ KerberosAuthenticationProvider - éªŒè¯ç¥¨æ®
â‘¢ UserDetailsService - åŠ è½½ç”¨æˆ·æƒé™

é…ç½®æ ¸å¿ƒï¼šæœåŠ¡ä¸»ä½“ã€keytabæ–‡ä»¶ã€krb5.conf
```

**ğŸ”¹ ç”Ÿäº§ç¯å¢ƒå…³æ³¨ç‚¹**
```
å®‰å…¨ï¼šå¯†é’¥æ–‡ä»¶æƒé™ã€ç¥¨æ®æœ‰æ•ˆæœŸã€HTTPSä¼ è¾“
æ€§èƒ½ï¼šç¥¨æ®ç¼“å­˜ã€è¿æ¥æ± ã€å¤šKDCè´Ÿè½½å‡è¡¡
å¯é æ€§ï¼šå¥åº·æ£€æŸ¥ã€æ•…éšœè½¬ç§»ã€ç›‘æ§å‘Šè­¦
```

### 7.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ’¼ ä¼ä¸šåº”ç”¨åœºæ™¯**
- **åŠå…¬ç³»ç»ŸSSO**ï¼šå‘˜å·¥ä¸€æ¬¡ç™»å½•ï¼Œè®¿é—®OAã€é‚®ä»¶ã€æ–‡æ¡£ç³»ç»Ÿæ— éœ€é‡å¤ç™»å½•
- **WindowsåŸŸç¯å¢ƒ**ï¼šJavaåº”ç”¨æ— ç¼é›†æˆä¼ä¸šADåŸŸè®¤è¯
- **è·¨éƒ¨é—¨åä½œ**ï¼šé€šè¿‡è·¨åŸŸä¿¡ä»»å®ç°ä¸åŒéƒ¨é—¨ç³»ç»Ÿçš„ç»Ÿä¸€è®¤è¯
- **åˆè§„å®‰å…¨**ï¼šæ»¡è¶³ä¼ä¸šå®‰å…¨è§„èŒƒï¼Œå¯†ç ä¸åœ¨ç½‘ç»œä¼ è¾“

**ğŸ¯ æŠ€æœ¯é€‰å‹å»ºè®®**
- **é€‚ç”¨åœºæ™¯**ï¼šWindowsåŸŸç¯å¢ƒã€ä¼ä¸šå†…ç½‘ã€éœ€è¦SSOçš„åœºæ™¯
- **ä¸é€‚ç”¨åœºæ™¯**ï¼šäº’è”ç½‘åº”ç”¨ã€ç§»åŠ¨APPã€å¾®æœåŠ¡å¤–éƒ¨è®¤è¯
- **æ›¿ä»£æ–¹æ¡ˆ**ï¼šOAuth2.0ã€SAMLã€OpenID Connectæ›´é€‚åˆäº’è”ç½‘åœºæ™¯

**ğŸ”§ å®æ–½å…³é”®ç‚¹**
- **å‰æœŸå‡†å¤‡**ï¼šç¡®è®¤åŸŸç¯å¢ƒã€ç”³è¯·æœåŠ¡è´¦å·ã€è§„åˆ’æœåŠ¡ä¸»ä½“
- **å¼€å‘é…ç½®**ï¼šæ­£ç¡®é…ç½®Spring Securityã€krb5.confã€keytabæ–‡ä»¶
- **æµ‹è¯•éªŒè¯**ï¼šæœ¬åœ°æµ‹è¯•ã€åŸŸç¯å¢ƒæµ‹è¯•ã€è·¨åŸŸæµ‹è¯•
- **ä¸Šçº¿å‡†å¤‡**ï¼šé«˜å¯ç”¨éƒ¨ç½²ã€ç›‘æ§é…ç½®ã€åº”æ€¥é¢„æ¡ˆ

### 7.4 å­¦ä¹ è¿›é˜¶è·¯å¾„


```
å­¦ä¹ è·¯çº¿å›¾ï¼š

åŸºç¡€é˜¶æ®µ â†’ ç†è§£KerberosåŸç†å’Œç¥¨æ®æœºåˆ¶
         â†“
å®è·µé˜¶æ®µ â†’ å®ŒæˆSpring SecurityåŸºç¡€é›†æˆ
         â†“
è¿›é˜¶é˜¶æ®µ â†’ WindowsåŸŸé›†æˆã€è·¨åŸŸé…ç½®
         â†“
ä¼˜åŒ–é˜¶æ®µ â†’ æ€§èƒ½ä¼˜åŒ–ã€é«˜å¯ç”¨æ¶æ„
         â†“
ä¸“å®¶é˜¶æ®µ â†’ æ•…éšœæ’æŸ¥ã€å®‰å…¨åŠ å›º
```

**ğŸ“š æ‰©å±•çŸ¥è¯†ç‚¹**
- æ·±å…¥å­¦ä¹ GSS-APIæœºåˆ¶
- ç ”ç©¶KerberosåŠ å¯†ç®—æ³•
- æŒæ¡Active Directoryç®¡ç†
- äº†è§£å…¶ä»–SSOæ–¹æ¡ˆï¼ˆCASã€SAMLï¼‰

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
Kerberosç¥¨æ®å¦‚é€šè¡Œè¯ï¼Œä¸‰æ–¹è®¤è¯ä¿å®‰å…¨
SPNEGOåè®®ä¼ ç¥¨æ®ï¼ŒHTTPå¤´ä¸­è—å¥¥ç§˜
WindowsåŸŸä¸­è§çœŸç« ï¼ŒADé›†æˆå•ç‚¹ç™»
è·¨åŸŸä¿¡ä»»éœ€é…ç½®ï¼Œç”Ÿäº§ç¯å¢ƒé‡å®‰å…¨
å¯†é’¥ä¿æŠ¤æ˜¯å…³é”®ï¼Œæ—¶é’ŸåŒæ­¥è«å°çœ‹
```