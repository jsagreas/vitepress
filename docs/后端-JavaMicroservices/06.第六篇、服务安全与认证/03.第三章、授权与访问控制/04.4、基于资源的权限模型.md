---
title: 4ã€åŸºäºèµ„æºçš„æƒé™æ¨¡å‹
---
## ğŸ“š ç›®å½•

1. [æƒé™æ¨¡å‹åŸºç¡€æ¦‚å¿µ](#1-æƒé™æ¨¡å‹åŸºç¡€æ¦‚å¿µ)
2. [RBACåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶](#2-RBACåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶)
3. [ACLè®¿é—®æ§åˆ¶åˆ—è¡¨](#3-ACLè®¿é—®æ§åˆ¶åˆ—è¡¨)
4. [ç»†ç²’åº¦æˆæƒå®ç°](#4-ç»†ç²’åº¦æˆæƒå®ç°)
5. [åŠ¨æ€æƒé™åŠ è½½](#5-åŠ¨æ€æƒé™åŠ è½½)
6. [èµ„æºæƒé™æ˜ å°„](#6-èµ„æºæƒé™æ˜ å°„)
7. [æ•°æ®æƒé™æ§åˆ¶](#7-æ•°æ®æƒé™æ§åˆ¶)
8. [å¤šç§Ÿæˆ·æƒé™éš”ç¦»](#8-å¤šç§Ÿæˆ·æƒé™éš”ç¦»)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ æƒé™æ¨¡å‹åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯åŸºäºèµ„æºçš„æƒé™æ¨¡å‹


**é€šä¿—ç†è§£**ï¼š
æƒ³è±¡ä½ åœ¨å…¬å¸ä¸Šç­ï¼Œä¸åŒçš„äººèƒ½è®¿é—®ä¸åŒçš„èµ„æºï¼š
- æ™®é€šå‘˜å·¥ï¼šåªèƒ½çœ‹è‡ªå·±çš„å·¥èµ„å•
- éƒ¨é—¨ç»ç†ï¼šèƒ½çœ‹æœ¬éƒ¨é—¨æ‰€æœ‰äººçš„å·¥èµ„å•
- è´¢åŠ¡æ€»ç›‘ï¼šèƒ½çœ‹å…¨å…¬å¸æ‰€æœ‰å·¥èµ„å•

è¿™å°±æ˜¯**åŸºäºèµ„æºçš„æƒé™æ§åˆ¶**â€”â€”æ ¹æ®"ä½ æ˜¯è°"å’Œ"èµ„æºæ˜¯ä»€ä¹ˆ"æ¥å†³å®š"ä½ èƒ½ä¸èƒ½è®¿é—®"ã€‚

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
```
æƒé™æ§åˆ¶ä¸‰è¦ç´ ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸»ä½“    â”‚â”€â”€â”€â–¶â”‚  åŠ¨ä½œ    â”‚â”€â”€â”€â–¶â”‚  èµ„æº    â”‚
â”‚ (Who)   â”‚    â”‚ (What)  â”‚    â”‚ (Which) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   ç”¨æˆ·          è¯»/å†™/åˆ        å…·ä½“æ•°æ®

ç¤ºä¾‹ï¼šå¼ ä¸‰(ä¸»ä½“) è¯»å–(åŠ¨ä½œ) è®¢å•123(èµ„æº)
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦èµ„æºçº§æƒé™


**ä¼ ç»Ÿè§’è‰²æƒé™çš„å±€é™æ€§**ï¼š
```
âŒ ä¼ ç»Ÿæ–¹å¼ï¼šåªåŸºäºè§’è‰²
- ç®¡ç†å‘˜ï¼šèƒ½è®¿é—®æ‰€æœ‰è®¢å•
- æ™®é€šç”¨æˆ·ï¼šä¸èƒ½è®¿é—®ä»»ä½•è®¢å•

é—®é¢˜ï¼šä¸å¤Ÿçµæ´»ï¼
ç”¨æˆ·Aåº”è¯¥èƒ½çœ‹è‡ªå·±çš„è®¢å•ï¼Œä½†çœ‹ä¸åˆ°åˆ«äººçš„
```

**èµ„æºçº§æƒé™çš„ä¼˜åŠ¿**ï¼š
```
âœ… èµ„æºçº§æ§åˆ¶ï¼šç»“åˆèµ„æºå±æ€§
- å¼ ä¸‰ï¼šåªèƒ½è®¿é—®è‡ªå·±åˆ›å»ºçš„è®¢å•
- éƒ¨é—¨ç»ç†ï¼šèƒ½è®¿é—®æœ¬éƒ¨é—¨æ‰€æœ‰è®¢å•
- ç³»ç»Ÿç®¡ç†å‘˜ï¼šèƒ½è®¿é—®æ‰€æœ‰è®¢å•

å¥½å¤„ï¼šç²¾ç¡®æ§åˆ¶ï¼Œç¬¦åˆå®é™…ä¸šåŠ¡éœ€æ±‚
```

### 1.3 å¸¸è§æƒé™æ¨¡å‹å¯¹æ¯”


| æƒé™æ¨¡å‹ | **é€‚ç”¨åœºæ™¯** | **çµæ´»æ€§** | **å¤æ‚åº¦** | **å…¸å‹åº”ç”¨** |
|---------|------------|----------|----------|------------|
| **DAC** è‡ªä¸»è®¿é—®æ§åˆ¶ | `å°å‹ç³»ç»Ÿ` | â­â­ | â­ | `ä¸ªäººæ–‡ä»¶ç³»ç»Ÿ` |
| **MAC** å¼ºåˆ¶è®¿é—®æ§åˆ¶ | `é«˜å®‰å…¨è¦æ±‚` | â­ | â­â­â­â­ | `å†›äº‹ç³»ç»Ÿ` |
| **RBAC** åŸºäºè§’è‰² | `ä¼ä¸šåº”ç”¨` | â­â­â­ | â­â­ | `ç®¡ç†ç³»ç»Ÿ` |
| **ABAC** åŸºäºå±æ€§ | `å¤æ‚ä¸šåŠ¡` | â­â­â­â­â­ | â­â­â­â­ | `äº‘æœåŠ¡å¹³å°` |

---

## 2. ğŸ‘¥ RBACåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶


### 2.1 RBACæ ¸å¿ƒæ€æƒ³


**ç”Ÿæ´»åŒ–ç†è§£**ï¼š
```
å…¬å¸ç»„ç»‡æ¶æ„ç±»æ¯”ï¼š

èŒä½(è§’è‰²)        æƒé™
   â”‚              â”‚
CEO â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º æ‰€æœ‰æƒé™
   â”‚              â”‚
ç»ç† â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º éƒ¨é—¨æƒé™
   â”‚              â”‚
å‘˜å·¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º åŸºç¡€æƒé™

å‘˜å·¥å¼ ä¸‰ â†’ è¢«åˆ†é…"é”€å”®ç»ç†"è§’è‰² â†’ è‡ªåŠ¨è·å¾—é”€å”®ç»ç†çš„æ‰€æœ‰æƒé™
```

**RBACæ¨¡å‹ç»“æ„**ï¼š
```
ç”¨æˆ·(User) â†â†’ è§’è‰²(Role) â†â†’ æƒé™(Permission)

å¼ ä¸‰ â”€â”€â”€â”
        â”œâ”€â”€â†’ é”€å”®ç»ç† â”€â”€â”€â”
æå›› â”€â”€â”€â”˜                â”œâ”€â”€â†’ æŸ¥çœ‹è®¢å•
                         â”œâ”€â”€â†’ ä¿®æ”¹è®¢å•
        â”Œâ”€â”€â†’ è´¢åŠ¡äººå‘˜ â”€â”€â”€â”¤
ç‹äº” â”€â”€â”€â”˜                â””â”€â”€â†’ æŸ¥çœ‹è´¢åŠ¡æŠ¥è¡¨
```

### 2.2 Spring Securityä¸­çš„RBACå®ç°


**æ•°æ®åº“è¡¨è®¾è®¡**ï¼š
```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE user (
    id BIGINT PRIMARY KEY,
    username VARCHAR(50),
    password VARCHAR(100)
);

-- è§’è‰²è¡¨
CREATE TABLE role (
    id BIGINT PRIMARY KEY,
    role_name VARCHAR(50),
    description VARCHAR(200)
);

-- æƒé™è¡¨
CREATE TABLE permission (
    id BIGINT PRIMARY KEY,
    permission_code VARCHAR(50),  -- å¦‚: order:read
    resource_type VARCHAR(50)     -- èµ„æºç±»å‹
);

-- ç”¨æˆ·-è§’è‰²å…³è”è¡¨
CREATE TABLE user_role (
    user_id BIGINT,
    role_id BIGINT
);

-- è§’è‰²-æƒé™å…³è”è¡¨
CREATE TABLE role_permission (
    role_id BIGINT,
    permission_id BIGINT
);
```

**åŸºç¡€é…ç½®ä»£ç **ï¼š
```java
@Configuration
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) {
        http.authorizeRequests()
            // åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶
            .antMatchers("/admin/**").hasRole("ADMIN")
            .antMatchers("/manager/**").hasAnyRole("ADMIN", "MANAGER")
            .antMatchers("/user/**").hasRole("USER")
            .anyRequest().authenticated();
        return http.build();
    }
}
```

### 2.3 æ–¹æ³•çº§åˆ«çš„RBAC


**ä½¿ç”¨æ³¨è§£æ§åˆ¶è®¿é—®**ï¼š
```java
@RestController
@RequestMapping("/order")
public class OrderController {
    
    // åªæœ‰ADMINè§’è‰²å¯ä»¥åˆ é™¤è®¢å•
    @PreAuthorize("hasRole('ADMIN')")
    @DeleteMapping("/{id}")
    public void deleteOrder(@PathVariable Long id) {
        orderService.delete(id);
    }
    
    // ADMINæˆ–MANAGERéƒ½å¯ä»¥æŸ¥çœ‹
    @PreAuthorize("hasAnyRole('ADMIN', 'MANAGER')")
    @GetMapping("/list")
    public List<Order> getOrders() {
        return orderService.findAll();
    }
}
```

> **ğŸ’¡ å…³é”®ç†è§£**ï¼šRBACçš„æ ¸å¿ƒæ˜¯"ç”¨æˆ·â†’è§’è‰²â†’æƒé™"çš„ä¸‰å±‚æ˜ å°„å…³ç³»ï¼Œç”¨æˆ·é€šè¿‡è§’è‰²é—´æ¥è·å¾—æƒé™ï¼Œä¾¿äºç»Ÿä¸€ç®¡ç†ã€‚

---

## 3. ğŸ“‹ ACLè®¿é—®æ§åˆ¶åˆ—è¡¨


### 3.1 ä»€ä¹ˆæ˜¯ACL


**é€šä¿—è§£é‡Š**ï¼š
ACLå°±åƒæ˜¯ç»™æ¯ä¸ªèµ„æºé…ä¸€ä¸ª"è®¿å®¢åå•"ï¼š
```
æ–‡ä»¶Açš„è®¿å®¢åå•(ACL)ï¼š
- å¼ ä¸‰ï¼šå¯ä»¥è¯»ã€å†™
- æå››ï¼šåªèƒ½è¯»
- ç‹äº”ï¼šä¸èƒ½è®¿é—®

æ–‡ä»¶Bçš„è®¿å®¢åå•(ACL)ï¼š
- å¼ ä¸‰ï¼šåªèƒ½è¯»
- èµµå…­ï¼šå¯ä»¥è¯»ã€å†™ã€åˆ é™¤
```

**ACL vs RBACå¯¹æ¯”**ï¼š
```
RBACï¼šæŒ‰èŒä½åˆ†é…æƒé™
â””â”€ æ‰€æœ‰"ç»ç†"éƒ½æœ‰ç›¸åŒæƒé™

ACLï¼šæŒ‰å…·ä½“èµ„æºåˆ†é…æƒé™
â””â”€ æ¯ä¸ªæ–‡æ¡£å¯ä»¥å•ç‹¬è®¾ç½®è°èƒ½è®¿é—®
```

### 3.2 Spring Security ACLæ¶æ„


**æ ¸å¿ƒç»„ä»¶å…³ç³»**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Spring Security ACL          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ObjectIdentity (èµ„æºæ ‡è¯†)        â”‚
â”‚       â†“                          â”‚
â”‚  Acl (è®¿é—®æ§åˆ¶åˆ—è¡¨)                â”‚
â”‚       â†“                          â”‚
â”‚  AccessControlEntry (è®¿é—®æ¡ç›®)    â”‚
â”‚       â”œâ”€ Principal (ä¸»ä½“)         â”‚
â”‚       â””â”€ Permission (æƒé™)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 ACLæ•°æ®åº“è¡¨ç»“æ„


```sql
-- ACLå¯¹è±¡æ ‡è¯†è¡¨
CREATE TABLE acl_object_identity (
    id BIGINT PRIMARY KEY,
    object_id_class BIGINT,     -- å¯¹è±¡ç±»å‹ID
    object_id_identity BIGINT,  -- å¯¹è±¡å®ä¾‹ID(å¦‚è®¢å•ID)
    owner_sid BIGINT,           -- æ‰€æœ‰è€…
    entries_inheriting BOOLEAN  -- æ˜¯å¦ç»§æ‰¿æƒé™
);

-- ACLæ¡ç›®è¡¨
CREATE TABLE acl_entry (
    id BIGINT PRIMARY KEY,
    acl_object_identity BIGINT,  -- å…³è”çš„å¯¹è±¡
    ace_order INT,               -- æ¡ç›®é¡ºåº
    sid BIGINT,                  -- ä¸»ä½“ID(ç”¨æˆ·æˆ–è§’è‰²)
    mask INT,                    -- æƒé™æ©ç (è¯»1,å†™2,åˆ 4)
    granting BOOLEAN             -- æ˜¯å¦æˆäºˆ(å¦åˆ™ä¸ºæ‹’ç»)
);
```

**æƒé™æ©ç è¯´æ˜**ï¼š
```
æƒé™æ©ç (Mask)ç”¨ä½è¿ç®—è¡¨ç¤ºæƒé™ï¼š

READ    = 1   (äºŒè¿›åˆ¶: 001)
WRITE   = 2   (äºŒè¿›åˆ¶: 010)
DELETE  = 4   (äºŒè¿›åˆ¶: 100)

ç»„åˆæƒé™ï¼š
READ + WRITE = 3 (äºŒè¿›åˆ¶: 011)
æ‰€æœ‰æƒé™     = 7 (äºŒè¿›åˆ¶: 111)
```

### 3.4 ACLå®é™…åº”ç”¨ç¤ºä¾‹


```java
@Service
public class DocumentService {
    
    @Autowired
    private MutableAclService aclService;
    
    // åˆ›å»ºæ–‡æ¡£å¹¶è®¾ç½®ACL
    public void createDocument(Document doc, String owner) {
        // 1. ä¿å­˜æ–‡æ¡£
        documentRepo.save(doc);
        
        // 2. åˆ›å»ºACL
        ObjectIdentity oi = new ObjectIdentityImpl(
            Document.class, doc.getId()
        );
        MutableAcl acl = aclService.createAcl(oi);
        
        // 3. è®¾ç½®æ‰€æœ‰è€…æœ‰å…¨éƒ¨æƒé™
        acl.setOwner(new PrincipalSid(owner));
        acl.insertAce(0, BasePermission.READ, 
            new PrincipalSid(owner), true);
        acl.insertAce(1, BasePermission.WRITE, 
            new PrincipalSid(owner), true);
        
        aclService.updateAcl(acl);
    }
    
    // æ£€æŸ¥è®¿é—®æƒé™
    @PreAuthorize("hasPermission(#docId, 'com.example.Document', 'READ')")
    public Document getDocument(Long docId) {
        return documentRepo.findById(docId).orElseThrow();
    }
}
```

> **âš ï¸ é‡è¦æé†’**ï¼šACLé€‚åˆéœ€è¦å¯¹æ¯ä¸ªèµ„æºå®ä¾‹å•ç‹¬è®¾ç½®æƒé™çš„åœºæ™¯ï¼Œä½†ä¼šå¢åŠ æ•°æ®åº“å¤æ‚åº¦ï¼Œè¦æ ¹æ®å®é™…ä¸šåŠ¡éœ€æ±‚é€‰æ‹©ã€‚

---

## 4. ğŸ” ç»†ç²’åº¦æˆæƒå®ç°


### 4.1 ä»€ä¹ˆæ˜¯ç»†ç²’åº¦æˆæƒ


**é€šä¿—å¯¹æ¯”**ï¼š
```
ç²—ç²’åº¦æˆæƒï¼š
âœ… ä½ å¯ä»¥è®¿é—®"è®¢å•æ¨¡å—"

ç»†ç²’åº¦æˆæƒï¼š
âœ… ä½ å¯ä»¥æŸ¥çœ‹è®¢å•
âœ… ä½ å¯ä»¥ä¿®æ”¹è‡ªå·±åˆ›å»ºçš„è®¢å•
âŒ ä½ ä¸èƒ½åˆ é™¤è®¢å•
âŒ ä½ ä¸èƒ½ä¿®æ”¹åˆ«äººçš„è®¢å•
```

**ç»†ç²’åº¦æˆæƒçš„å±‚æ¬¡**ï¼š
```
ä»ç²—åˆ°ç»†çš„æˆæƒç²’åº¦ï¼š

æ¨¡å—çº§  â”€â”€â†’  åŠŸèƒ½çº§  â”€â”€â†’  æ“ä½œçº§  â”€â”€â†’  æ•°æ®çº§
 â”‚           â”‚           â”‚           â”‚
è®¢å•æ¨¡å—    è®¢å•æŸ¥è¯¢    æŸ¥çœ‹/ä¿®æ”¹   åªçœ‹è‡ªå·±çš„
```

### 4.2 åŸºäºSpELçš„ç»†ç²’åº¦æ§åˆ¶


**SpELè¡¨è¾¾å¼æƒé™åˆ¤æ–­**ï¼š
```java
@RestController
@RequestMapping("/order")
public class OrderController {
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯è®¢å•åˆ›å»ºè€…
    @PreAuthorize("#order.creatorId == authentication.principal.id")
    @PutMapping
    public void updateOrder(@RequestBody Order order) {
        orderService.update(order);
    }
    
    // æ£€æŸ¥ç”¨æˆ·éƒ¨é—¨
    @PreAuthorize("@permissionChecker.checkDepartment(#orderId)")
    @GetMapping("/{orderId}")
    public Order getOrder(@PathVariable Long orderId) {
        return orderService.findById(orderId);
    }
    
    // ç»„åˆæ¡ä»¶åˆ¤æ–­
    @PreAuthorize("hasRole('ADMIN') or " +
                  "(hasRole('MANAGER') and #order.amount < 10000)")
    @PostMapping
    public void createOrder(@RequestBody Order order) {
        orderService.create(order);
    }
}
```

### 4.3 è‡ªå®šä¹‰æƒé™æ£€æŸ¥å™¨


```java
@Component("permissionChecker")
public class PermissionChecker {
    
    @Autowired
    private OrderService orderService;
    
    // æ£€æŸ¥æ˜¯å¦æœ‰æƒè®¿é—®è¯¥è®¢å•
    public boolean checkOrderAccess(Long orderId) {
        // è·å–å½“å‰ç”¨æˆ·
        Authentication auth = SecurityContextHolder
            .getContext().getAuthentication();
        User currentUser = (User) auth.getPrincipal();
        
        // è·å–è®¢å•ä¿¡æ¯
        Order order = orderService.findById(orderId);
        
        // æƒé™åˆ¤æ–­é€»è¾‘
        if (currentUser.hasRole("ADMIN")) {
            return true;  // ç®¡ç†å‘˜å…¨éƒ¨å¯è§
        }
        if (currentUser.getDeptId().equals(order.getDeptId())) {
            return true;  // åŒéƒ¨é—¨å¯è§
        }
        if (order.getCreatorId().equals(currentUser.getId())) {
            return true;  // åˆ›å»ºè€…å¯è§
        }
        
        return false;
    }
    
    // æ£€æŸ¥éƒ¨é—¨æƒé™
    public boolean checkDepartment(Long orderId) {
        User user = getCurrentUser();
        Order order = orderService.findById(orderId);
        return user.getDeptId().equals(order.getDeptId());
    }
}
```

### 4.4 å­—æ®µçº§æƒé™æ§åˆ¶


**æ•æ„Ÿå­—æ®µè¿‡æ»¤**ï¼š
```java
@Service
public class UserService {
    
    public UserDTO getUserInfo(Long userId) {
        User user = userRepo.findById(userId).orElseThrow();
        UserDTO dto = new UserDTO();
        
        // åŸºç¡€ä¿¡æ¯éƒ½å¯è§
        dto.setUsername(user.getUsername());
        dto.setEmail(user.getEmail());
        
        // æ•æ„Ÿä¿¡æ¯æŒ‰æƒé™æ˜¾ç¤º
        if (hasPermission("user:view:phone")) {
            dto.setPhone(user.getPhone());
        }
        if (hasPermission("user:view:salary")) {
            dto.setSalary(user.getSalary());
        }
        
        return dto;
    }
    
    private boolean hasPermission(String permission) {
        return SecurityContextHolder.getContext()
            .getAuthentication()
            .getAuthorities()
            .stream()
            .anyMatch(auth -> auth.getAuthority().equals(permission));
    }
}
```

---

## 5. ğŸ”„ åŠ¨æ€æƒé™åŠ è½½


### 5.1 ä¸ºä»€ä¹ˆéœ€è¦åŠ¨æ€æƒé™


**é™æ€æƒé™çš„é—®é¢˜**ï¼š
```
âŒ é™æ€é…ç½®ï¼šæƒé™å†™æ­»åœ¨ä»£ç é‡Œ
@PreAuthorize("hasRole('ADMIN')")

é—®é¢˜ï¼š
- æ–°å¢è§’è‰²éœ€è¦æ”¹ä»£ç 
- è°ƒæ•´æƒé™éœ€è¦é‡æ–°å‘å¸ƒ
- ä¸èƒ½çµæ´»åº”å¯¹ä¸šåŠ¡å˜åŒ–
```

**åŠ¨æ€æƒé™çš„ä¼˜åŠ¿**ï¼š
```
âœ… åŠ¨æ€åŠ è½½ï¼šæƒé™å­˜åœ¨æ•°æ®åº“ä¸­
- ç®¡ç†å‘˜å¯ä»¥é€šè¿‡ç•Œé¢é…ç½®
- ä¿®æ”¹ç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯
- é€‚åº”å¿«é€Ÿå˜åŒ–çš„ä¸šåŠ¡éœ€æ±‚
```

### 5.2 åŠ¨æ€æƒé™åŠ è½½æµç¨‹


```
ç”¨æˆ·ç™»å½•æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·  â”‚â”€â”€â”€â–¶â”‚ è®¤è¯æˆåŠŸ  â”‚â”€â”€â”€â–¶â”‚ åŠ è½½æƒé™  â”‚
â””â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â–¼                             â–¼
              æŸ¥è¯¢ç”¨æˆ·è§’è‰²                   æŸ¥è¯¢è§’è‰²æƒé™
                    â”‚                             â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â–¼
                         æ„å»ºæƒé™åˆ—è¡¨
                               â”‚
                               â–¼
                        å­˜å…¥Securityä¸Šä¸‹æ–‡
```

### 5.3 å®ç°åŠ¨æ€æƒé™åŠ è½½


**æƒé™æ•°æ®æœåŠ¡**ï¼š
```java
@Service
public class DynamicPermissionService {
    
    @Autowired
    private UserRoleMapper userRoleMapper;
    
    @Autowired
    private RolePermissionMapper rolePermissionMapper;
    
    // åŠ è½½ç”¨æˆ·çš„æ‰€æœ‰æƒé™
    public List<GrantedAuthority> loadUserPermissions(String username) {
        List<GrantedAuthority> authorities = new ArrayList<>();
        
        // 1. æŸ¥è¯¢ç”¨æˆ·çš„è§’è‰²
        List<Role> roles = userRoleMapper.findRolesByUsername(username);
        
        // 2. æŸ¥è¯¢æ¯ä¸ªè§’è‰²çš„æƒé™
        for (Role role : roles) {
            // æ·»åŠ è§’è‰²æƒé™
            authorities.add(new SimpleGrantedAuthority("ROLE_" + role.getName()));
            
            // æ·»åŠ å…·ä½“æƒé™
            List<Permission> permissions = 
                rolePermissionMapper.findPermissionsByRoleId(role.getId());
            
            for (Permission perm : permissions) {
                authorities.add(new SimpleGrantedAuthority(perm.getCode()));
            }
        }
        
        return authorities;
    }
}
```

**è‡ªå®šä¹‰UserDetailsService**ï¼š
```java
@Service
public class CustomUserDetailsService implements UserDetailsService {
    
    @Autowired
    private UserRepository userRepo;
    
    @Autowired
    private DynamicPermissionService permissionService;
    
    @Override
    public UserDetails loadUserByUsername(String username) {
        // 1. æŸ¥è¯¢ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
        User user = userRepo.findByUsername(username)
            .orElseThrow(() -> new UsernameNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨"));
        
        // 2. åŠ¨æ€åŠ è½½æƒé™
        List<GrantedAuthority> authorities = 
            permissionService.loadUserPermissions(username);
        
        // 3. æ„å»ºUserDetails
        return org.springframework.security.core.userdetails.User
            .withUsername(user.getUsername())
            .password(user.getPassword())
            .authorities(authorities)
            .build();
    }
}
```

### 5.4 æƒé™ç¼“å­˜ä¼˜åŒ–


**ä½¿ç”¨Redisç¼“å­˜æƒé™**ï¼š
```java
@Service
public class CachedPermissionService {
    
    @Autowired
    private RedisTemplate<String, List<String>> redisTemplate;
    
    @Autowired
    private DynamicPermissionService permissionService;
    
    private static final String PERMISSION_KEY = "user:permissions:";
    
    // è·å–æƒé™(å¸¦ç¼“å­˜)
    public List<String> getPermissions(String username) {
        String key = PERMISSION_KEY + username;
        
        // å…ˆä»ç¼“å­˜è·å–
        List<String> permissions = redisTemplate.opsForValue().get(key);
        
        if (permissions == null) {
            // ç¼“å­˜æ²¡æœ‰,ä»æ•°æ®åº“åŠ è½½
            permissions = permissionService.loadPermissionCodes(username);
            
            // å­˜å…¥ç¼“å­˜(15åˆ†é’Ÿè¿‡æœŸ)
            redisTemplate.opsForValue().set(key, permissions, 
                Duration.ofMinutes(15));
        }
        
        return permissions;
    }
    
    // æ¸…é™¤æƒé™ç¼“å­˜(ç”¨æˆ·æƒé™å˜æ›´æ—¶è°ƒç”¨)
    public void clearPermissionCache(String username) {
        redisTemplate.delete(PERMISSION_KEY + username);
    }
}
```

> **ğŸ’¡ æ€§èƒ½æç¤º**ï¼šæƒé™ä¿¡æ¯è®¿é—®é¢‘ç¹ï¼Œå»ºè®®ä½¿ç”¨ç¼“å­˜ã€‚æƒé™å˜æ›´æ—¶è®°å¾—æ¸…é™¤å¯¹åº”ç¼“å­˜ï¼Œé¿å…æ—§æƒé™ä»ç„¶ç”Ÿæ•ˆã€‚

---

## 6. ğŸ—‚ï¸ èµ„æºæƒé™æ˜ å°„


### 6.1 ä»€ä¹ˆæ˜¯èµ„æºæƒé™æ˜ å°„


**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
æŠŠ"URLè·¯å¾„"ã€"æ–¹æ³•"ã€"æŒ‰é’®"ç­‰èµ„æºä¸æ‰€éœ€æƒé™å»ºç«‹å¯¹åº”å…³ç³»ã€‚

**æ˜ å°„å…³ç³»ç¤ºä¾‹**ï¼š
```
èµ„æº                    æ‰€éœ€æƒé™
â”œâ”€ /order/list    â”€â”€â†’  order:view
â”œâ”€ /order/create  â”€â”€â†’  order:create
â”œâ”€ /order/delete  â”€â”€â†’  order:delete
â””â”€ /user/resetPwd â”€â”€â†’  user:manage
```

### 6.2 URLæƒé™æ˜ å°„é…ç½®


**æ•°æ®åº“å­˜å‚¨æ˜ å°„å…³ç³»**ï¼š
```sql
CREATE TABLE resource_permission (
    id BIGINT PRIMARY KEY,
    resource_url VARCHAR(200),    -- èµ„æºè·¯å¾„
    http_method VARCHAR(10),      -- è¯·æ±‚æ–¹æ³•
    permission_code VARCHAR(50),  -- æ‰€éœ€æƒé™ç 
    description VARCHAR(200)
);

-- ç¤ºä¾‹æ•°æ®
INSERT INTO resource_permission VALUES 
(1, '/order/**', 'GET', 'order:view', 'æŸ¥çœ‹è®¢å•'),
(2, '/order/**', 'POST', 'order:create', 'åˆ›å»ºè®¢å•'),
(3, '/order/**', 'DELETE', 'order:delete', 'åˆ é™¤è®¢å•');
```

**åŠ¨æ€åŠ è½½URLæƒé™**ï¼š
```java
@Component
public class DynamicSecurityMetadataSource 
    implements FilterInvocationSecurityMetadataSource {
    
    @Autowired
    private ResourcePermissionMapper resourceMapper;
    
    // ç¼“å­˜æƒé™é…ç½®
    private Map<RequestMatcher, Collection<ConfigAttribute>> resourceMap;
    
    @PostConstruct
    public void loadResourcePermissions() {
        resourceMap = new HashMap<>();
        
        // ä»æ•°æ®åº“åŠ è½½æ‰€æœ‰èµ„æºæƒé™æ˜ å°„
        List<ResourcePermission> resources = 
            resourceMapper.findAll();
        
        for (ResourcePermission res : resources) {
            // åˆ›å»ºè¯·æ±‚åŒ¹é…å™¨
            RequestMatcher matcher = new AntPathRequestMatcher(
                res.getResourceUrl(), res.getHttpMethod()
            );
            
            // åˆ›å»ºæƒé™å±æ€§
            Collection<ConfigAttribute> attributes = 
                SecurityConfig.createList(res.getPermissionCode());
            
            resourceMap.put(matcher, attributes);
        }
    }
    
    @Override
    public Collection<ConfigAttribute> getAttributes(Object object) {
        HttpServletRequest request = 
            ((FilterInvocation) object).getRequest();
        
        // åŒ¹é…è¯·æ±‚å¯¹åº”çš„æƒé™
        for (Map.Entry<RequestMatcher, Collection<ConfigAttribute>> entry 
            : resourceMap.entrySet()) {
            if (entry.getKey().matches(request)) {
                return entry.getValue();
            }
        }
        
        return null;
    }
    
    // åˆ·æ–°æƒé™é…ç½®(æƒé™å˜æ›´æ—¶è°ƒç”¨)
    public void refresh() {
        loadResourcePermissions();
    }
}
```

### 6.3 æ–¹æ³•æƒé™æ˜ å°„


**æ³¨è§£ä¸æƒé™ç æ˜ å°„**ï¼š
```java
@Service
public class OrderService {
    
    // æ–¹æ³•1ï¼šç›´æ¥ä½¿ç”¨æƒé™ç 
    @PreAuthorize("hasAuthority('order:view')")
    public List<Order> listOrders() {
        return orderRepo.findAll();
    }
    
    // æ–¹æ³•2ï¼šä½¿ç”¨è‡ªå®šä¹‰æƒé™æ£€æŸ¥
    @PreAuthorize("@permissionEvaluator.hasPermission('order:delete')")
    public void deleteOrder(Long id) {
        orderRepo.deleteById(id);
    }
}

// è‡ªå®šä¹‰æƒé™è¯„ä¼°å™¨
@Component("permissionEvaluator")
public class CustomPermissionEvaluator {
    
    public boolean hasPermission(String permissionCode) {
        Authentication auth = SecurityContextHolder
            .getContext().getAuthentication();
        
        return auth.getAuthorities().stream()
            .anyMatch(a -> a.getAuthority().equals(permissionCode));
    }
}
```

### 6.4 å‰ç«¯æŒ‰é’®æƒé™æ§åˆ¶


**åç«¯æä¾›æƒé™æŸ¥è¯¢æ¥å£**ï¼š
```java
@RestController
@RequestMapping("/api/permissions")
public class PermissionController {
    
    // è·å–å½“å‰ç”¨æˆ·çš„æ‰€æœ‰æƒé™ç 
    @GetMapping("/current")
    public List<String> getCurrentUserPermissions() {
        Authentication auth = SecurityContextHolder
            .getContext().getAuthentication();
        
        return auth.getAuthorities().stream()
            .map(GrantedAuthority::getAuthority)
            .collect(Collectors.toList());
    }
    
    // æ£€æŸ¥æ˜¯å¦æœ‰æŒ‡å®šæƒé™
    @GetMapping("/check/{permissionCode}")
    public boolean checkPermission(@PathVariable String permissionCode) {
        Authentication auth = SecurityContextHolder
            .getContext().getAuthentication();
        
        return auth.getAuthorities().stream()
            .anyMatch(a -> a.getAuthority().equals(permissionCode));
    }
}
```

**å‰ç«¯æŒ‰é’®æ˜¾ç¤ºæ§åˆ¶**ï¼š
```javascript
// Vueç¤ºä¾‹
<template>
  <div>
    <!-- æœ‰åˆ é™¤æƒé™æ‰æ˜¾ç¤ºæŒ‰é’® -->
    <button v-if="hasPermission('order:delete')" 
            @click="deleteOrder">
      åˆ é™¤è®¢å•
    </button>
  </div>
</template>

<script>
export default {
  data() {
    return {
      userPermissions: []
    }
  },
  mounted() {
    // è·å–ç”¨æˆ·æƒé™åˆ—è¡¨
    this.loadPermissions();
  },
  methods: {
    async loadPermissions() {
      const res = await this.$http.get('/api/permissions/current');
      this.userPermissions = res.data;
    },
    hasPermission(code) {
      return this.userPermissions.includes(code);
    }
  }
}
</script>
```

---

## 7. ğŸ” æ•°æ®æƒé™æ§åˆ¶


### 7.1 ä»€ä¹ˆæ˜¯æ•°æ®æƒé™


**é€šä¿—ç†è§£**ï¼š
```
åŠŸèƒ½æƒé™ï¼šä½ èƒ½ä¸èƒ½"æŸ¥çœ‹è®¢å•"è¿™ä¸ªåŠŸèƒ½
æ•°æ®æƒé™ï¼šä½ èƒ½æŸ¥çœ‹"å“ªäº›è®¢å•"çš„æ•°æ®

ç¤ºä¾‹ï¼š
- é”€å”®å‘˜Aï¼šåªèƒ½çœ‹è‡ªå·±çš„å®¢æˆ·è®¢å•
- é”€å”®ç»ç†ï¼šèƒ½çœ‹æ•´ä¸ªé”€å”®éƒ¨çš„è®¢å•
- æ€»ç»ç†ï¼šèƒ½çœ‹å…¨å…¬å¸æ‰€æœ‰è®¢å•
```

**æ•°æ®æƒé™çš„ç»´åº¦**ï¼š
```
å¸¸è§çš„æ•°æ®æƒé™ç»´åº¦ï¼š
â”œâ”€ ä¸ªäººç»´åº¦ï¼šåªçœ‹è‡ªå·±åˆ›å»ºçš„æ•°æ®
â”œâ”€ éƒ¨é—¨ç»´åº¦ï¼šçœ‹æœ¬éƒ¨é—¨çš„æ•°æ®
â”œâ”€ åŒºåŸŸç»´åº¦ï¼šçœ‹æ‰€ç®¡è¾–åŒºåŸŸçš„æ•°æ®
â””â”€ è‡ªå®šä¹‰ç»´åº¦ï¼šæ ¹æ®ä¸šåŠ¡è§„åˆ™è¿‡æ»¤
```

### 7.2 æ•°æ®æƒé™è§„åˆ™é…ç½®


**æƒé™è§„åˆ™è¡¨è®¾è®¡**ï¼š
```sql
CREATE TABLE data_permission_rule (
    id BIGINT PRIMARY KEY,
    role_id BIGINT,              -- è§’è‰²ID
    resource_type VARCHAR(50),   -- èµ„æºç±»å‹(å¦‚Order)
    scope_type VARCHAR(20),      -- èŒƒå›´ç±»å‹(SELF/DEPT/ALL)
    scope_field VARCHAR(50),     -- èŒƒå›´å­—æ®µ(å¦‚dept_id)
    custom_sql VARCHAR(500)      -- è‡ªå®šä¹‰SQLæ¡ä»¶
);

-- ç¤ºä¾‹ï¼šé”€å”®ç»ç†åªèƒ½çœ‹æœ¬éƒ¨é—¨è®¢å•
INSERT INTO data_permission_rule VALUES
(1, 2, 'Order', 'DEPT', 'dept_id', NULL);

-- ç¤ºä¾‹ï¼šåŒºåŸŸç»ç†çœ‹æŒ‡å®šåŒºåŸŸè®¢å•
INSERT INTO data_permission_rule VALUES  
(2, 3, 'Order', 'CUSTOM', NULL, 'region_id IN (1,2,3)');
```

### 7.3 åŸºäºMyBatisçš„æ•°æ®æƒé™å®ç°


**è‡ªå®šä¹‰MyBatisæ‹¦æˆªå™¨**ï¼š
```java
@Intercepts({
    @Signature(type = Executor.class, method = "query", 
               args = {MappedStatement.class, Object.class, 
                      RowBounds.class, ResultHandler.class})
})
public class DataPermissionInterceptor implements Interceptor {
    
    @Override
    public Object intercept(Invocation invocation) throws Throwable {
        Object[] args = invocation.getArgs();
        MappedStatement ms = (MappedStatement) args[0];
        Object parameter = args[1];
        
        // è·å–å½“å‰ç”¨æˆ·
        User currentUser = getCurrentUser();
        if (currentUser == null) {
            return invocation.proceed();
        }
        
        // è·å–SQL
        BoundSql boundSql = ms.getBoundSql(parameter);
        String originalSql = boundSql.getSql();
        
        // æ„å»ºæ•°æ®æƒé™SQLæ¡ä»¶
        String permissionSql = buildPermissionSql(currentUser, ms);
        
        if (StringUtils.isNotBlank(permissionSql)) {
            // ä¿®æ”¹SQLæ·»åŠ æƒé™æ¡ä»¶
            String newSql = originalSql + " AND " + permissionSql;
            
            // é‡æ–°è®¾ç½®SQL
            Field field = boundSql.getClass()
                .getDeclaredField("sql");
            field.setAccessible(true);
            field.set(boundSql, newSql);
        }
        
        return invocation.proceed();
    }
    
    // æ„å»ºæƒé™SQL
    private String buildPermissionSql(User user, MappedStatement ms) {
        // æŸ¥è¯¢ç”¨æˆ·çš„æ•°æ®æƒé™è§„åˆ™
        List<DataPermissionRule> rules = 
            getPermissionRules(user.getRoleId());
        
        StringBuilder sql = new StringBuilder();
        for (DataPermissionRule rule : rules) {
            switch (rule.getScopeType()) {
                case "SELF":
                    sql.append("creator_id = ").append(user.getId());
                    break;
                case "DEPT":
                    sql.append("dept_id = ").append(user.getDeptId());
                    break;
                case "CUSTOM":
                    sql.append(rule.getCustomSql());
                    break;
            }
        }
        
        return sql.toString();
    }
}
```

### 7.4 åŸºäºAOPçš„æ•°æ®è¿‡æ»¤


**è‡ªå®šä¹‰æ•°æ®æƒé™æ³¨è§£**ï¼š
```java
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface DataScope {
    // éƒ¨é—¨å­—æ®µå
    String deptField() default "dept_id";
    // ç”¨æˆ·å­—æ®µå  
    String userField() default "user_id";
    // æƒé™ç±»å‹
    ScopeType type() default ScopeType.DEPT;
}

enum ScopeType {
    SELF,    // ä»…æœ¬äºº
    DEPT,    // æœ¬éƒ¨é—¨
    DEPT_AND_SUB,  // æœ¬éƒ¨é—¨åŠå­éƒ¨é—¨
    ALL      // å…¨éƒ¨
}
```

**AOPåˆ‡é¢å®ç°**ï¼š
```java
@Aspect
@Component
public class DataScopeAspect {
    
    @Around("@annotation(dataScope)")
    public Object around(ProceedingJoinPoint point, DataScope dataScope) 
        throws Throwable {
        
        User user = getCurrentUser();
        
        // ç®¡ç†å‘˜ä¸åšæ•°æ®è¿‡æ»¤
        if (user.isAdmin()) {
            return point.proceed();
        }
        
        // è·å–æŸ¥è¯¢å‚æ•°
        Object[] args = point.getArgs();
        for (Object arg : args) {
            if (arg instanceof BaseQuery) {
                BaseQuery query = (BaseQuery) arg;
                
                // æ ¹æ®æƒé™ç±»å‹è®¾ç½®è¿‡æ»¤æ¡ä»¶
                switch (dataScope.type()) {
                    case SELF:
                        query.setUserId(user.getId());
                        break;
                    case DEPT:
                        query.setDeptId(user.getDeptId());
                        break;
                    case DEPT_AND_SUB:
                        List<Long> deptIds = getDeptAndSubIds(user.getDeptId());
                        query.setDeptIds(deptIds);
                        break;
                }
            }
        }
        
        return point.proceed(args);
    }
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
@Service
public class OrderService {
    
    // æŸ¥è¯¢è®¢å•æ—¶è‡ªåŠ¨è¿‡æ»¤æ•°æ®
    @DataScope(type = ScopeType.DEPT)
    public List<Order> findOrders(OrderQuery query) {
        return orderMapper.selectList(query);
    }
    
    // æŸ¥è¯¢è‡ªå·±çš„è®¢å•
    @DataScope(type = ScopeType.SELF)
    public List<Order> findMyOrders(OrderQuery query) {
        return orderMapper.selectList(query);
    }
}
```

> **ğŸ” æ·±å…¥ç†è§£**ï¼šæ•°æ®æƒé™æœ¬è´¨æ˜¯åœ¨SQLä¸­åŠ¨æ€æ·»åŠ WHEREæ¡ä»¶ï¼Œç¡®ä¿ç”¨æˆ·åªèƒ½æŸ¥è¯¢åˆ°æœ‰æƒé™çš„æ•°æ®ã€‚å¯ä»¥é€šè¿‡æ‹¦æˆªå™¨æˆ–AOPåœ¨æŸ¥è¯¢æ—¶è‡ªåŠ¨æ³¨å…¥æƒé™æ¡ä»¶ã€‚

---

## 8. ğŸ¢ å¤šç§Ÿæˆ·æƒé™éš”ç¦»


### 8.1 ä»€ä¹ˆæ˜¯å¤šç§Ÿæˆ·


**ç”Ÿæ´»åŒ–ç†è§£**ï¼š
```
å¤šç§Ÿæˆ·å°±åƒå…¬å¯“æ¥¼ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å…¬å¯“æ¥¼(ç³»ç»Ÿ)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç§Ÿæˆ·A(å…¬å¸A)    â”‚  â† æœ‰è‡ªå·±çš„æ•°æ®å’Œç”¨æˆ·
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç§Ÿæˆ·B(å…¬å¸B)    â”‚  â† æœ‰è‡ªå·±çš„æ•°æ®å’Œç”¨æˆ·
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç§Ÿæˆ·C(å…¬å¸C)    â”‚  â† æœ‰è‡ªå·±çš„æ•°æ®å’Œç”¨æˆ·
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ¯ä¸ªç§Ÿæˆ·ï¼š
- æ•°æ®å®Œå…¨éš”ç¦»
- ç”¨æˆ·ç‹¬ç«‹ç®¡ç†
- çœ‹ä¸åˆ°å…¶ä»–ç§Ÿæˆ·çš„ä¿¡æ¯
```

### 8.2 å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»æ–¹æ¡ˆ


**ä¸‰ç§å¸¸è§æ–¹æ¡ˆå¯¹æ¯”**ï¼š

| æ–¹æ¡ˆ | **å®ç°æ–¹å¼** | **éš”ç¦»æ€§** | **æˆæœ¬** | **é€‚ç”¨åœºæ™¯** |
|-----|------------|----------|---------|------------|
| **ç‹¬ç«‹æ•°æ®åº“** | `æ¯ä¸ªç§Ÿæˆ·ç‹¬ç«‹DB` | â­â­â­â­â­ | é«˜ | `å¤§å®¢æˆ·,é«˜å®‰å…¨è¦æ±‚` |
| **å…±äº«æ•°æ®åº“ç‹¬ç«‹Schema** | `åŒDBä¸åŒSchema` | â­â­â­â­ | ä¸­ | `ä¸­ç­‰è§„æ¨¡ç§Ÿæˆ·` |
| **å…±äº«æ•°æ®åº“å…±äº«è¡¨** | `è¡¨ä¸­åŠ ç§Ÿæˆ·IDå­—æ®µ` | â­â­â­ | ä½ | `å¤§é‡å°ç§Ÿæˆ·` |

**å…±äº«è¡¨æ–¹æ¡ˆæ•°æ®ç»“æ„**ï¼š
```sql
-- æ‰€æœ‰è¡¨éƒ½åŠ tenant_idå­—æ®µ
CREATE TABLE user (
    id BIGINT PRIMARY KEY,
    tenant_id BIGINT NOT NULL,  -- ç§Ÿæˆ·ID
    username VARCHAR(50),
    password VARCHAR(100),
    INDEX idx_tenant (tenant_id)
);

CREATE TABLE order (
    id BIGINT PRIMARY KEY,
    tenant_id BIGINT NOT NULL,  -- ç§Ÿæˆ·ID
    order_no VARCHAR(50),
    amount DECIMAL(10,2),
    INDEX idx_tenant (tenant_id)
);
```

### 8.3 åŸºäºè¿‡æ»¤å™¨çš„ç§Ÿæˆ·éš”ç¦»


**ç§Ÿæˆ·ä¸Šä¸‹æ–‡ç®¡ç†**ï¼š
```java
// ç§Ÿæˆ·ä¸Šä¸‹æ–‡(å­˜å‚¨å½“å‰ç§Ÿæˆ·ID)
public class TenantContext {
    
    private static final ThreadLocal<Long> tenantId = new ThreadLocal<>();
    
    public static void setTenantId(Long id) {
        tenantId.set(id);
    }
    
    public static Long getTenantId() {
        return tenantId.get();
    }
    
    public static void clear() {
        tenantId.remove();
    }
}
```

**ç§Ÿæˆ·è¯†åˆ«è¿‡æ»¤å™¨**ï¼š
```java
@Component
public class TenantFilter extends OncePerRequestFilter {
    
    @Override
    protected void doFilterInternal(HttpServletRequest request,
                                    HttpServletResponse response,
                                    FilterChain filterChain) 
        throws ServletException, IOException {
        
        try {
            // ä»è¯·æ±‚å¤´è·å–ç§Ÿæˆ·ID
            String tenantId = request.getHeader("X-Tenant-Id");
            
            if (StringUtils.isBlank(tenantId)) {
                // æˆ–è€…ä»tokenä¸­è§£æç§Ÿæˆ·ID
                tenantId = extractTenantFromToken(request);
            }
            
            // è®¾ç½®åˆ°ä¸Šä¸‹æ–‡
            TenantContext.setTenantId(Long.valueOf(tenantId));
            
            filterChain.doFilter(request, response);
            
        } finally {
            // æ¸…ç†ä¸Šä¸‹æ–‡
            TenantContext.clear();
        }
    }
}
```

### 8.4 MyBatisç§Ÿæˆ·æ•°æ®éš”ç¦»


**è‡ªåŠ¨æ·»åŠ ç§Ÿæˆ·æ¡ä»¶**ï¼š
```java
@Intercepts({
    @Signature(type = Executor.class, method = "query",
               args = {MappedStatement.class, Object.class, 
                      RowBounds.class, ResultHandler.class}),
    @Signature(type = Executor.class, method = "update",
               args = {MappedStatement.class, Object.class})
})
public class TenantInterceptor implements Interceptor {
    
    @Override
    public Object intercept(Invocation invocation) throws Throwable {
        Object[] args = invocation.getArgs();
        MappedStatement ms = (MappedStatement) args[0];
        Object parameter = args[1];
        
        // è·å–ç§Ÿæˆ·ID
        Long tenantId = TenantContext.getTenantId();
        if (tenantId == null) {
            throw new SecurityException("ç§Ÿæˆ·IDä¸èƒ½ä¸ºç©º");
        }
        
        // è·å–SQL
        BoundSql boundSql = ms.getBoundSql(parameter);
        String sql = boundSql.getSql();
        
        // æ·»åŠ ç§Ÿæˆ·è¿‡æ»¤æ¡ä»¶
        String newSql = addTenantCondition(sql, tenantId);
        
        // æ›´æ–°SQL
        Field field = boundSql.getClass()
            .getDeclaredField("sql");
        field.setAccessible(true);
        field.set(boundSql, newSql);
        
        return invocation.proceed();
    }
    
    private String addTenantCondition(String sql, Long tenantId) {
        // ç®€åŒ–å®ç°,å®é™…éœ€è¦SQLè§£æ
        if (sql.toLowerCase().contains("where")) {
            return sql + " AND tenant_id = " + tenantId;
        } else {
            return sql + " WHERE tenant_id = " + tenantId;
        }
    }
}
```

### 8.5 ç§Ÿæˆ·æƒé™ç®¡ç†


**ç§Ÿæˆ·ç®¡ç†å‘˜é…ç½®**ï¼š
```java
@Service
public class TenantSecurityService {
    
    // åˆ›å»ºç§Ÿæˆ·æ—¶åˆå§‹åŒ–ç®¡ç†å‘˜
    @Transactional
    public void createTenant(Tenant tenant, User admin) {
        // 1. åˆ›å»ºç§Ÿæˆ·
        tenant.setStatus("ACTIVE");
        tenantRepo.save(tenant);
        
        // 2. åˆ›å»ºç§Ÿæˆ·ç®¡ç†å‘˜
        admin.setTenantId(tenant.getId());
        admin.setUsername(tenant.getCode() + "_admin");
        userRepo.save(admin);
        
        // 3. åˆ†é…ç®¡ç†å‘˜è§’è‰²
        Role adminRole = createTenantAdminRole(tenant.getId());
        userRoleService.assignRole(admin.getId(), adminRole.getId());
        
        // 4. åˆå§‹åŒ–é»˜è®¤æƒé™
        initDefaultPermissions(tenant.getId());
    }
    
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å±äºå½“å‰ç§Ÿæˆ·
    public boolean checkTenantAccess(Long userId) {
        Long currentTenantId = TenantContext.getTenantId();
        User user = userRepo.findById(userId).orElseThrow();
        
        return user.getTenantId().equals(currentTenantId);
    }
}
```

**ç§Ÿæˆ·çº§åˆ«çš„æƒé™éš”ç¦»**ï¼š
```java
@RestController
@RequestMapping("/tenant/users")
public class TenantUserController {
    
    @Autowired
    private UserService userService;
    
    // åªèƒ½æŸ¥è¯¢æœ¬ç§Ÿæˆ·çš„ç”¨æˆ·
    @GetMapping
    public List<User> getUsers() {
        Long tenantId = TenantContext.getTenantId();
        return userService.findByTenantId(tenantId);
    }
    
    // åˆ›å»ºç”¨æˆ·æ—¶è‡ªåŠ¨è®¾ç½®ç§Ÿæˆ·ID
    @PostMapping
    public User createUser(@RequestBody User user) {
        Long tenantId = TenantContext.getTenantId();
        user.setTenantId(tenantId);
        return userService.create(user);
    }
}
```

> **âš ï¸ å®‰å…¨æé†’**ï¼šå¤šç§Ÿæˆ·ç³»ç»Ÿä¸­,æ•°æ®éš”ç¦»è‡³å…³é‡è¦ã€‚å¿…é¡»ç¡®ä¿æ¯ä¸ªSQLæŸ¥è¯¢éƒ½åŒ…å«ç§Ÿæˆ·æ¡ä»¶,é˜²æ­¢æ•°æ®æ³„éœ²ã€‚å»ºè®®ä½¿ç”¨æ‹¦æˆªå™¨è‡ªåŠ¨æ·»åŠ ç§Ÿæˆ·è¿‡æ»¤,é¿å…äººå·¥é—æ¼ã€‚

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ¯ **æƒé™æ¨¡å‹å¯¹æ¯”**
â”œâ”€ RBACï¼šåŸºäºè§’è‰²ï¼Œé€‚åˆä¼ä¸šåº”ç”¨
â”œâ”€ ACLï¼šåŸºäºèµ„æºï¼Œé€‚åˆæ–‡æ¡£ç®¡ç†
â”œâ”€ ABACï¼šåŸºäºå±æ€§ï¼Œé€‚åˆå¤æ‚åœºæ™¯
â””â”€ é€‰æ‹©åŸåˆ™ï¼šæ ¹æ®ä¸šåŠ¡å¤æ‚åº¦é€‰æ‹©

ğŸ” **æˆæƒç²’åº¦å±‚æ¬¡**
â”œâ”€ æ¨¡å—çº§ï¼šæœ€ç²—ç²’åº¦ï¼ŒæŒ‰æ¨¡å—æ§åˆ¶
â”œâ”€ åŠŸèƒ½çº§ï¼šæŒ‰å…·ä½“åŠŸèƒ½æ§åˆ¶
â”œâ”€ æ“ä½œçº§ï¼šæŒ‰å¢åˆ æ”¹æŸ¥æ§åˆ¶
â”œâ”€ æ•°æ®çº§ï¼šæŒ‰æ•°æ®èŒƒå›´æ§åˆ¶
â””â”€ å­—æ®µçº§ï¼šæœ€ç»†ç²’åº¦ï¼ŒæŒ‰å­—æ®µæ§åˆ¶

ğŸ”„ **æƒé™åŠ è½½æ–¹å¼**
â”œâ”€ é™æ€æƒé™ï¼šå†™æ­»åœ¨ä»£ç ä¸­
â”œâ”€ åŠ¨æ€æƒé™ï¼šä»æ•°æ®åº“åŠ è½½
â””â”€ ä¼˜å…ˆé€‰æ‹©ï¼šåŠ¨æ€åŠ è½½(çµæ´»å¯é…)
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ RBACçš„æœ¬è´¨ç†è§£**
```
ç”¨æˆ· â†â†’ è§’è‰² â†â†’ æƒé™
     å¤šå¯¹å¤š     å¤šå¯¹å¤š

æ ¸å¿ƒä¼˜åŠ¿ï¼š
â€¢ æƒé™ç»Ÿä¸€ç®¡ç†ï¼Œåˆ†é…è§’è‰²å³å¯
â€¢ èŒä½å˜åŠ¨æ—¶åªéœ€è°ƒæ•´è§’è‰²
â€¢ å‡å°‘ç›´æ¥ç»™ç”¨æˆ·åˆ†é…æƒé™çš„å¤æ‚åº¦
```

**ğŸ”¹ æ•°æ®æƒé™çš„å®ç°åŸç†**
```
æœ¬è´¨ï¼šåœ¨SQLä¸­åŠ¨æ€æ·»åŠ WHEREæ¡ä»¶

å®ç°æ–¹å¼ï¼š
1. MyBatisæ‹¦æˆªå™¨ï¼šæ‹¦æˆªSQLè‡ªåŠ¨æ·»åŠ æ¡ä»¶
2. AOPåˆ‡é¢ï¼šåœ¨æ–¹æ³•æ‰§è¡Œå‰è®¾ç½®è¿‡æ»¤æ¡ä»¶
3. æ‰‹åŠ¨è¿‡æ»¤ï¼šåœ¨ä¸šåŠ¡ä»£ç ä¸­æ·»åŠ æ¡ä»¶

é€‰æ‹©å»ºè®®ï¼šä¼˜å…ˆä½¿ç”¨æ‹¦æˆªå™¨(è‡ªåŠ¨åŒ–ç¨‹åº¦é«˜)
```

**ğŸ”¹ å¤šç§Ÿæˆ·éš”ç¦»çš„å…³é”®**
```
æ•°æ®éš”ç¦»æ–¹æ¡ˆï¼š
â€¢ ç‹¬ç«‹æ•°æ®åº“ï¼šæœ€å®‰å…¨ä½†æˆæœ¬é«˜
â€¢ å…±äº«è¡¨+ç§Ÿæˆ·IDï¼šæˆæœ¬ä½ä½†éœ€ä¸¥æ ¼æ§åˆ¶

æŠ€æœ¯è¦ç‚¹ï¼š
1. ç§Ÿæˆ·ä¸Šä¸‹æ–‡ç®¡ç†(ThreadLocal)
2. æ‰€æœ‰SQLè‡ªåŠ¨æ·»åŠ ç§Ÿæˆ·æ¡ä»¶
3. ç§Ÿæˆ·è¯†åˆ«(ä»tokenæˆ–è¯·æ±‚å¤´)
4. é˜²æ­¢ç§Ÿæˆ·è¶Šæƒè®¿é—®
```

### 9.3 å®é™…åº”ç”¨å»ºè®®


**ğŸ“Œ æƒé™è®¾è®¡åŸåˆ™**
```
1. æœ€å°æƒé™åŸåˆ™ï¼šé»˜è®¤æ— æƒé™ï¼ŒæŒ‰éœ€æˆæƒ
2. èŒè´£åˆ†ç¦»åŸåˆ™ï¼šæ•æ„Ÿæ“ä½œéœ€è¦å¤šä¸ªè§’è‰²é…åˆ
3. æƒé™å¯å®¡è®¡ï¼šè®°å½•æƒé™å˜æ›´å’Œè®¿é—®æ—¥å¿—
4. æ˜“äºç»´æŠ¤ï¼šæƒé™è®¾è®¡è¦æ¸…æ™°æ˜“æ‡‚
```

**ğŸ“Œ æ€§èƒ½ä¼˜åŒ–å»ºè®®**
```
1. æƒé™ä¿¡æ¯ç¼“å­˜ï¼š
   - ç”¨æˆ·ç™»å½•æ—¶åŠ è½½æƒé™
   - ä½¿ç”¨Redisç¼“å­˜æƒé™åˆ—è¡¨
   - æƒé™å˜æ›´æ—¶åŠæ—¶æ¸…é™¤ç¼“å­˜

2. SQLä¼˜åŒ–ï¼š
   - æƒé™è¿‡æ»¤æ¡ä»¶åŠ ç´¢å¼•
   - é¿å…å¤æ‚çš„æƒé™åˆ¤æ–­é€»è¾‘
   - ä½¿ç”¨è§†å›¾ç®€åŒ–æƒé™SQL

3. æ‰¹é‡æ“ä½œï¼š
   - æ‰¹é‡åŠ è½½ç”¨æˆ·æƒé™
   - æ‰¹é‡æ£€æŸ¥èµ„æºæƒé™
```

**ğŸ“Œ å®‰å…¨æ³¨æ„äº‹é¡¹**
```
1. é˜²æ­¢è¶Šæƒè®¿é—®ï¼š
   âœ… åç«¯å¿…é¡»éªŒè¯æƒé™,ä¸èƒ½åªé å‰ç«¯
   âœ… APIæ¥å£éƒ½è¦åšæƒé™æ£€æŸ¥
   âœ… æ•°æ®æŸ¥è¯¢å¿…é¡»åŒ…å«æƒé™è¿‡æ»¤

2. æ•æ„Ÿæ“ä½œä¿æŠ¤ï¼š
   âœ… å…³é”®æ“ä½œäºŒæ¬¡éªŒè¯
   âœ… æ•æ„Ÿæ•°æ®è„±æ•æ˜¾ç¤º
   âœ… æ“ä½œæ—¥å¿—å®Œæ•´è®°å½•

3. å¤šç§Ÿæˆ·å®‰å…¨ï¼š
   âœ… ç§Ÿæˆ·IDå¼ºåˆ¶éªŒè¯
   âœ… é˜²æ­¢SQLæ³¨å…¥ç»•è¿‡ç§Ÿæˆ·è¿‡æ»¤
   âœ… å®šæœŸå®¡è®¡æ•°æ®éš”ç¦»æ€§
```

### 9.4 å¸¸è§é—®é¢˜è§£å†³


**ğŸ”§ é—®é¢˜1ï¼šæƒé™é…ç½®åä¸ç”Ÿæ•ˆ**
```
å¯èƒ½åŸå› ï¼š
1. ç¼“å­˜æœªæ¸…é™¤ â†’ æ¸…é™¤ç”¨æˆ·æƒé™ç¼“å­˜
2. æƒé™ç ä¸åŒ¹é… â†’ æ£€æŸ¥æƒé™ç æ˜¯å¦ä¸€è‡´
3. è§’è‰²æœªå…³è” â†’ ç¡®è®¤ç”¨æˆ·å·²åˆ†é…è§’è‰²
```

**ğŸ”§ é—®é¢˜2ï¼šæ•°æ®æƒé™å¤±æ•ˆ**
```
å¯èƒ½åŸå› ï¼š
1. SQLæ‹¦æˆªå™¨æœªç”Ÿæ•ˆ â†’ æ£€æŸ¥æ‹¦æˆªå™¨é…ç½®
2. ç§Ÿæˆ·ä¸Šä¸‹æ–‡ä¸ºç©º â†’ æ£€æŸ¥è¿‡æ»¤å™¨è®¾ç½®
3. ç®¡ç†å‘˜ç»•è¿‡è¿‡æ»¤ â†’ ç¡®è®¤è§’è‰²åˆ¤æ–­é€»è¾‘
```

**ğŸ”§ é—®é¢˜3ï¼šæ€§èƒ½ä¸‹é™**
```
ä¼˜åŒ–æ–¹æ¡ˆï¼š
1. æ·»åŠ æƒé™æŸ¥è¯¢ç´¢å¼•
2. ä½¿ç”¨æƒé™ç¼“å­˜
3. ç®€åŒ–æƒé™åˆ¤æ–­é€»è¾‘
4. è€ƒè™‘åˆ†è¡¨æˆ–åˆ†åº“
```

### 9.5 å­¦ä¹ è·¯å¾„å»ºè®®


```
å­¦ä¹ é¡ºåºï¼š
1ï¸âƒ£ æŒæ¡RBACåŸºç¡€ â†’ ç†è§£è§’è‰²æƒé™æ¨¡å‹
2ï¸âƒ£ å­¦ä¹ åŠ¨æ€æƒé™ â†’ å®ç°çµæ´»çš„æƒé™é…ç½®  
3ï¸âƒ£ å®è·µæ•°æ®æƒé™ â†’ æŒæ¡æ•°æ®çº§åˆ«æ§åˆ¶
4ï¸âƒ£ ç ”ç©¶å¤šç§Ÿæˆ· â†’ ç†è§£ç§Ÿæˆ·éš”ç¦»æœºåˆ¶
5ï¸âƒ£ æ€§èƒ½ä¼˜åŒ– â†’ ç¼“å­˜å’ŒSQLä¼˜åŒ–

å®æˆ˜å»ºè®®ï¼š
â€¢ å…ˆä»ç®€å•çš„RBACå¼€å§‹
â€¢ é€æ­¥å¢åŠ æƒé™ç²’åº¦
â€¢ æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©æ–¹æ¡ˆ
â€¢ æ³¨é‡å®‰å…¨æ€§å’Œæ€§èƒ½å¹³è¡¡
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
ğŸ¯ æƒé™ä¸‰è¦ç´ ï¼šè°(ä¸»ä½“)ã€åšä»€ä¹ˆ(åŠ¨ä½œ)ã€å¯¹ä»€ä¹ˆ(èµ„æº)
ğŸ” RBACä¸‰å±‚ï¼šç”¨æˆ·â†’è§’è‰²â†’æƒé™ï¼Œé—´æ¥æˆæƒå¥½ç®¡ç†
ğŸ“Š æ•°æ®æƒé™ï¼šSQLåŠ æ¡ä»¶ï¼Œè‡ªåŠ¨è¿‡æ»¤ä¿å®‰å…¨  
ğŸ¢ å¤šç§Ÿæˆ·ï¼šIDéš”ç¦»ä¸¥ï¼Œé˜²æ­¢è¶Šæƒæ˜¯å…³é”®
âš¡ æ€§èƒ½ä¼˜åŒ–ï¼šç¼“å­˜æƒé™å¿«ï¼Œç´¢å¼•è¿‡æ»¤ä¸èƒ½å°‘
```