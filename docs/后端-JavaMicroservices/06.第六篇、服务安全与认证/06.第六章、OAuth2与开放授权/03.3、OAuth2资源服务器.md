---
title: 3ã€OAuth2èµ„æºæœåŠ¡å™¨
---
## ğŸ“š ç›®å½•

1. [èµ„æºæœåŠ¡å™¨åŸºæœ¬æ¦‚å¿µ](#1-èµ„æºæœåŠ¡å™¨åŸºæœ¬æ¦‚å¿µ)
2. [èµ„æºæœåŠ¡å™¨å¯ç”¨é…ç½®](#2-èµ„æºæœåŠ¡å™¨å¯ç”¨é…ç½®)
3. [ä»¤ç‰ŒéªŒè¯æœºåˆ¶](#3-ä»¤ç‰ŒéªŒè¯æœºåˆ¶)
4. [ä½œç”¨åŸŸä¸æƒé™æ§åˆ¶](#4-ä½œç”¨åŸŸä¸æƒé™æ§åˆ¶)
5. [èµ„æºä¿æŠ¤é…ç½®](#5-èµ„æºä¿æŠ¤é…ç½®)
6. [ä»¤ç‰Œå†…çœæœºåˆ¶](#6-ä»¤ç‰Œå†…çœæœºåˆ¶)
7. [JWTèµ„æºæœåŠ¡å™¨](#7-JWTèµ„æºæœåŠ¡å™¨)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ èµ„æºæœåŠ¡å™¨åŸºæœ¬æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯èµ„æºæœåŠ¡å™¨


> **ğŸ’¡ é€šä¿—ç†è§£**  
> èµ„æºæœåŠ¡å™¨å°±åƒæ˜¯ä¸€ä¸ª"**ä¿é™©ç®±ç®¡ç†å‘˜**"ï¼š
> - ä½ çš„æ•°æ®ï¼ˆç”¨æˆ·ä¿¡æ¯ã€è®¢å•ã€ç…§ç‰‡ï¼‰å°±æ˜¯ä¿é™©ç®±é‡Œçš„è´µé‡ç‰©å“
> - å®¢æˆ·ç«¯æƒ³è¦è®¿é—®è¿™äº›æ•°æ®ï¼Œå¿…é¡»å‡ºç¤º"**è®¿é—®ä»¤ç‰Œ**"ï¼ˆå°±åƒé’¥åŒ™ï¼‰
> - èµ„æºæœåŠ¡å™¨éªŒè¯ä»¤ç‰Œæ˜¯å¦æœ‰æ•ˆï¼Œæ‰å†³å®šæ˜¯å¦ç»™æ•°æ®

**ğŸ”¸ æ ¸å¿ƒå®šä¹‰**
```
èµ„æºæœåŠ¡å™¨ï¼ˆResource Serverï¼‰ï¼š
â€¢ å­˜å‚¨å—ä¿æŠ¤èµ„æºçš„æœåŠ¡å™¨
â€¢ éªŒè¯è®¿é—®ä»¤ç‰Œçš„æœ‰æ•ˆæ€§
â€¢ æ ¹æ®ä»¤ç‰Œæƒé™å†³å®šæ˜¯å¦æä¾›èµ„æº
â€¢ åœ¨OAuth2ä¸­è´Ÿè´£"å®ˆé—¨"çš„è§’è‰²
```

### 1.2 OAuth2è§’è‰²å…³ç³»å›¾


```
å®Œæ•´çš„OAuth2æµç¨‹ï¼š

[ç”¨æˆ·]              [å®¢æˆ·ç«¯åº”ç”¨]          [æˆæƒæœåŠ¡å™¨]        [èµ„æºæœåŠ¡å™¨]
  |                     |                    |                   |
  |--â‘ è®¿é—®åº”ç”¨--------->|                    |                   |
  |                     |                    |                   |
  |                     |--â‘¡è¯·æ±‚æˆæƒ-------->|                   |
  |<--â‘¢è·³è½¬æˆæƒé¡µé¢-----|                    |                   |
  |                     |                    |                   |
  |--â‘£ç”¨æˆ·æˆæƒ----------|------------------>|                   |
  |                     |                    |                   |
  |                     |<--â‘¤è¿”å›ä»¤ç‰Œ--------|                   |
  |                     |                                        |
  |                     |--â‘¥æºå¸¦ä»¤ç‰Œè®¿é—®èµ„æº-------------------->|
  |                     |                                        |
  |                     |                    (â‘¦éªŒè¯ä»¤ç‰Œ)         |
  |                     |                                        |
  |                     |<--â‘§è¿”å›å—ä¿æŠ¤èµ„æº----------------------|
  |<--â‘¨å±•ç¤ºæ•°æ®---------|                                        |

å…³é”®ç†è§£ï¼šèµ„æºæœåŠ¡å™¨åªè´Ÿè´£ç¬¬â‘¥â‘¦â‘§æ­¥ï¼
```

### 1.3 ä¸ºä»€ä¹ˆéœ€è¦èµ„æºæœåŠ¡å™¨


**ğŸ”¹ ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜**
```
ä¼ ç»Ÿèº«ä»½éªŒè¯ï¼ˆç”¨æˆ·åå¯†ç ï¼‰ï¼š
âŒ å®¢æˆ·ç«¯éœ€è¦ä¿å­˜ç”¨æˆ·å¯†ç ï¼ˆä¸å®‰å…¨ï¼‰
âŒ ç¬¬ä¸‰æ–¹åº”ç”¨è·å¾—å®Œå…¨æƒé™ï¼ˆæƒé™è¿‡å¤§ï¼‰
âŒ ç”¨æˆ·æ— æ³•çµæ´»æ§åˆ¶æˆæƒèŒƒå›´
âŒ å¯†ç æ³„éœ²å½±å“æ‰€æœ‰åº”ç”¨

OAuth2èµ„æºæœåŠ¡å™¨æ–¹å¼ï¼š
âœ… å®¢æˆ·ç«¯åªè·å¾—ä»¤ç‰Œï¼Œä¸æ¥è§¦å¯†ç 
âœ… å¯ä»¥é™å®šè®¿é—®èŒƒå›´ï¼ˆScopeï¼‰
âœ… ä»¤ç‰Œå¯ä»¥éšæ—¶æ’¤é”€
âœ… ä¸åŒåº”ç”¨ä½¿ç”¨ä¸åŒä»¤ç‰Œï¼Œäº’ä¸å½±å“
```

> **âš ï¸ å¸¸è§è¯¯åŒº**  
> èµ„æºæœåŠ¡å™¨ â‰  æˆæƒæœåŠ¡å™¨
> - **æˆæƒæœåŠ¡å™¨**ï¼šè´Ÿè´£å‘æ”¾ä»¤ç‰Œï¼ˆåƒé“¶è¡Œå‘å¡ï¼‰
> - **èµ„æºæœåŠ¡å™¨**ï¼šè´Ÿè´£éªŒè¯ä»¤ç‰Œå’Œæä¾›æ•°æ®ï¼ˆåƒå•†åœºéªŒå¡æ¶ˆè´¹ï¼‰
> - å®ƒä»¬å¯ä»¥æ˜¯åŒä¸€ä¸ªåº”ç”¨ï¼Œä¹Ÿå¯ä»¥åˆ†å¼€éƒ¨ç½²

---

## 2. ğŸ”§ èµ„æºæœåŠ¡å™¨å¯ç”¨é…ç½®


### 2.1 @EnableResourceServeræ³¨è§£æ–¹å¼ï¼ˆä¼ ç»Ÿï¼‰


**ğŸ”¸ ä»€ä¹ˆæ˜¯@EnableResourceServer**
```
@EnableResourceServerçš„ä½œç”¨ï¼š
â€¢ å°†Spring Bootåº”ç”¨æ ‡è®°ä¸ºOAuth2èµ„æºæœåŠ¡å™¨
â€¢ è‡ªåŠ¨é…ç½®ä»¤ç‰ŒéªŒè¯é€»è¾‘
â€¢ æ‹¦æˆªæ‰€æœ‰è¯·æ±‚ï¼Œæ£€æŸ¥è®¿é—®ä»¤ç‰Œ
â€¢ æ³¨æ„ï¼šSpring Security 5.xåæ¨èä½¿ç”¨æ–°æ–¹å¼
```

**ğŸ“ ä¼ ç»Ÿé…ç½®ç¤ºä¾‹**ï¼ˆäº†è§£å³å¯ï¼‰
```java
// è¿™æ˜¯æ—§ç‰ˆæœ¬çš„é…ç½®æ–¹å¼
@Configuration
@EnableResourceServer  // å¯ç”¨èµ„æºæœåŠ¡å™¨
public class ResourceServerConfig extends ResourceServerConfigurerAdapter {
    
    @Override
    public void configure(HttpSecurity http) throws Exception {
        http
            .authorizeRequests()
            .antMatchers("/api/public/**").permitAll()  // å…¬å¼€æ¥å£
            .anyRequest().authenticated();              // å…¶ä»–éœ€è¦è®¤è¯
    }
}
```

> **ğŸ’¡ å­¦ä¹ å»ºè®®**  
> å¦‚æœä½ æ˜¯æ–°æ‰‹å­¦ä¹ ï¼Œ**é‡ç‚¹æŒæ¡ä¸‹é¢çš„æ–°ç‰ˆæœ¬é…ç½®æ–¹å¼**ï¼ˆoauth2ResourceServer()ï¼‰ï¼Œä¸Šé¢çš„@EnableResourceServeräº†è§£å³å¯ï¼Œå› ä¸ºå·²ç»é€æ­¥è¢«æ·˜æ±°ã€‚

### 2.2 oauth2ResourceServer()é…ç½®ï¼ˆæ¨èï¼‰


**ğŸ”¸ æ–°ç‰ˆæœ¬é…ç½®æ–¹å¼**
```
oauth2ResourceServer()æ˜¯ä»€ä¹ˆï¼š
â€¢ Spring Security 5.xæ¨å‡ºçš„æ–°é…ç½®æ–¹å¼
â€¢ æ›´åŠ çµæ´»å’Œå¼ºå¤§
â€¢ æ”¯æŒJWTå’Œä¸é€æ˜ä»¤ç‰Œï¼ˆOpaque Tokenï¼‰
â€¢ é…ç½®æ›´åŠ ç›´è§‚æ˜“æ‡‚
```

**ğŸ“ åŸºç¡€é…ç½®ç¤ºä¾‹**
```java
@Configuration
@EnableWebSecurity
public class ResourceServerConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            // OAuth2èµ„æºæœåŠ¡å™¨é…ç½®
            .oauth2ResourceServer(oauth2 -> oauth2
                .jwt()  // ä½¿ç”¨JWTä»¤ç‰Œ
            )
            // è¯·æ±‚æˆæƒé…ç½®
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/api/public/**").permitAll()
                .anyRequest().authenticated()
            );
        
        return http.build();
    }
}
```

**ğŸ”„ é…ç½®å¯¹æ¯”ç†è§£**
```
ä¼ ç»Ÿæ–¹å¼ vs æ–°æ–¹å¼ï¼š

ä¼ ç»Ÿ@EnableResourceServerï¼š
â€¢ ä½¿ç”¨ç»§æ‰¿ResourceServerConfigurerAdapter
â€¢ é…ç½®ç›¸å¯¹å›ºå®š
â€¢ åŠŸèƒ½æ‰©å±•ä¸å¤Ÿçµæ´»

æ–°oauth2ResourceServer()ï¼š
â€¢ ä½¿ç”¨Lambdaè¡¨è¾¾å¼é…ç½®
â€¢ é“¾å¼è°ƒç”¨ï¼Œæ¸…æ™°ç›´è§‚
â€¢ æ”¯æŒæ›´å¤šå®šåˆ¶åŒ–éœ€æ±‚
â€¢ è¿™æ˜¯æœªæ¥çš„è¶‹åŠ¿ï¼
```

### 2.3 å®Œæ•´é…ç½®ç¤ºä¾‹


**ğŸ“‹ å®é™…é¡¹ç›®é…ç½®**
```java
@Configuration
@EnableWebSecurity
public class ResourceServerConfig {
    
    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
            // CSRFä¿æŠ¤ï¼ˆæ ¹æ®éœ€è¦å¼€å¯ï¼‰
            .csrf(csrf -> csrf.disable())
            
            // OAuth2èµ„æºæœåŠ¡å™¨
            .oauth2ResourceServer(oauth2 -> oauth2
                .jwt(jwt -> jwt
                    .decoder(jwtDecoder())  // è‡ªå®šä¹‰JWTè§£ç å™¨
                )
            )
            
            // æˆæƒè§„åˆ™
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/api/public/**").permitAll()       // å…¬å¼€API
                .requestMatchers("/api/admin/**").hasRole("ADMIN")   // ç®¡ç†å‘˜API
                .anyRequest().authenticated()                        // å…¶ä»–éœ€è®¤è¯
            );
        
        return http.build();
    }
    
    // JWTè§£ç å™¨é…ç½®
    @Bean
    public JwtDecoder jwtDecoder() {
        // é…ç½®JWTè§£æè§„åˆ™ï¼ˆåé¢è¯¦ç»†è®²ï¼‰
        return NimbusJwtDecoder.withJwkSetUri(
            "http://authorization-server/oauth2/jwks"
        ).build();
    }
}
```

---

## 3. ğŸ” ä»¤ç‰ŒéªŒè¯æœºåˆ¶


### 3.1 ä»¤ç‰ŒéªŒè¯æµç¨‹


**ğŸ”¸ éªŒè¯æµç¨‹å›¾**
```
å®¢æˆ·ç«¯è¯·æ±‚æµç¨‹ï¼š

1. å®¢æˆ·ç«¯å‘é€è¯·æ±‚
   â†“
   GET /api/user/profile
   Header: Authorization: Bearer eyJhbGc...ï¼ˆä»¤ç‰Œï¼‰

2. èµ„æºæœåŠ¡å™¨æ‹¦æˆªè¯·æ±‚
   â†“
   [Spring Securityè¿‡æ»¤å™¨é“¾]

3. æå–ä»¤ç‰Œ
   â†“
   ä»Authorization Headerä¸­æå–Bearer Token

4. éªŒè¯ä»¤ç‰Œ
   â†“
   â”Œâ”€ JWTä»¤ç‰Œ â†’ æœ¬åœ°éªŒè¯ç­¾å
   â””â”€ ä¸é€æ˜ä»¤ç‰Œ â†’ è°ƒç”¨æˆæƒæœåŠ¡å™¨éªŒè¯

5. è§£æä»¤ç‰Œå†…å®¹
   â†“
   æå–ç”¨æˆ·ä¿¡æ¯ã€æƒé™ã€ä½œç”¨åŸŸç­‰

6. æƒé™åˆ¤æ–­
   â†“
   æ£€æŸ¥æ˜¯å¦æœ‰è®¿é—®è¯¥èµ„æºçš„æƒé™

7. è¿”å›ç»“æœ
   â†“
   â”Œâ”€ éªŒè¯æˆåŠŸ â†’ æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼Œè¿”å›æ•°æ®
   â””â”€ éªŒè¯å¤±è´¥ â†’ è¿”å›401/403é”™è¯¯
```

### 3.2 JWTä»¤ç‰ŒéªŒè¯


> **ğŸ’¡ ä»€ä¹ˆæ˜¯JWT**  
> JWTï¼ˆJSON Web Tokenï¼‰å°±åƒä¸€ä¸ª"**åŠ å¯†çš„èº«ä»½è¯**"ï¼š
> - åŒ…å«ç”¨æˆ·ä¿¡æ¯ã€æƒé™ç­‰ï¼ˆæ˜æ–‡å¯è¯»ï¼Œä½†ä¸èƒ½ç¯¡æ”¹ï¼‰
> - ä½¿ç”¨æ•°å­—ç­¾åé˜²æ­¢ä¼ªé€ 
> - èµ„æºæœåŠ¡å™¨å¯ä»¥**æœ¬åœ°éªŒè¯**ï¼Œæ— éœ€æ¯æ¬¡éƒ½é—®æˆæƒæœåŠ¡å™¨

**ğŸ”¸ JWTç»“æ„è§£æ**
```
JWTä»¤ç‰Œæ ¼å¼ï¼ˆç”¨.åˆ†éš”ä¸‰éƒ¨åˆ†ï¼‰ï¼š
eyJhbGc.eyJzdWI.SflKxwRJ
   â†“       â†“       â†“
 Header  Payload Signature
 å¤´éƒ¨     è½½è·     ç­¾å

Headerï¼ˆå¤´éƒ¨ï¼‰ï¼š
{
  "alg": "RS256",        // åŠ å¯†ç®—æ³•
  "typ": "JWT"           // ä»¤ç‰Œç±»å‹
}

Payloadï¼ˆè½½è·ï¼‰ï¼š
{
  "sub": "user123",           // ç”¨æˆ·ID
  "scope": ["read", "write"], // æƒé™èŒƒå›´
  "exp": 1640995200           // è¿‡æœŸæ—¶é—´
}

Signatureï¼ˆç­¾åï¼‰ï¼š
ç”¨ç§é’¥åŠ å¯†å‰ä¸¤éƒ¨åˆ†ï¼Œé˜²æ­¢ç¯¡æ”¹
```

**ğŸ“ JWTéªŒè¯é…ç½®**
```java
@Configuration
public class JwtConfig {
    
    @Bean
    public JwtDecoder jwtDecoder() {
        // æ–¹å¼1ï¼šä½¿ç”¨å…¬é’¥éªŒè¯ï¼ˆå¸¸ç”¨ï¼‰
        return NimbusJwtDecoder
            .withPublicKey(rsaPublicKey())  // RSAå…¬é’¥
            .build();
    }
    
    // é…ç½®RSAå…¬é’¥
    @Bean
    public RSAPublicKey rsaPublicKey() {
        // ä»é…ç½®æ–‡ä»¶æˆ–å¯†é’¥æœåŠ¡å™¨åŠ è½½å…¬é’¥
        return ...;
    }
}
```

**ğŸ”„ JWTéªŒè¯æµç¨‹**
```
JWTæœ¬åœ°éªŒè¯è¿‡ç¨‹ï¼š

1. æ¥æ”¶JWTä»¤ç‰Œ
   â†“
2. åˆ†è§£æˆHeader.Payload.Signature
   â†“
3. ä½¿ç”¨å…¬é’¥éªŒè¯Signature
   â†“
   â”Œâ”€ éªŒè¯é€šè¿‡ â†’ è¯´æ˜ä»¤ç‰Œæœªè¢«ç¯¡æ”¹
   â””â”€ éªŒè¯å¤±è´¥ â†’ æ‹’ç»è®¿é—®
   â†“
4. æ£€æŸ¥è¿‡æœŸæ—¶é—´ï¼ˆexpï¼‰
   â†“
5. æå–ç”¨æˆ·ä¿¡æ¯å’Œæƒé™
   â†“
6. ç»§ç»­åç»­çš„æƒé™éªŒè¯
```

### 3.3 ä¸é€æ˜ä»¤ç‰ŒéªŒè¯


> **ğŸ’¡ ä»€ä¹ˆæ˜¯ä¸é€æ˜ä»¤ç‰Œ**  
> ä¸é€æ˜ä»¤ç‰Œï¼ˆOpaque Tokenï¼‰å°±åƒ"**é“¶è¡Œå¡å·**"ï¼š
> - æœ¬èº«ä¸åŒ…å«ä»»ä½•ä¿¡æ¯ï¼ˆåªæ˜¯ä¸€ä¸²éšæœºå­—ç¬¦ï¼‰
> - å¿…é¡»å»"é“¶è¡Œ"ï¼ˆæˆæƒæœåŠ¡å™¨ï¼‰æŸ¥è¯¢æ‰çŸ¥é“æœ‰æ•ˆæ€§
> - æ›´å®‰å…¨ï¼Œä½†éœ€è¦ç½‘ç»œè°ƒç”¨

**ğŸ”¸ ä¸é€æ˜ä»¤ç‰Œç‰¹ç‚¹**
```
JWT vs ä¸é€æ˜ä»¤ç‰Œï¼š

JWTä»¤ç‰Œï¼š
âœ… æœ¬åœ°éªŒè¯ï¼Œé€Ÿåº¦å¿«
âœ… å‡è½»æˆæƒæœåŠ¡å™¨å‹åŠ›
âŒ ä»¤ç‰Œè¾ƒå¤§ï¼ˆåŒ…å«ä¿¡æ¯ï¼‰
âŒ æ— æ³•ä¸»åŠ¨æ’¤é”€ï¼ˆéœ€ç­‰åˆ°è¿‡æœŸï¼‰

ä¸é€æ˜ä»¤ç‰Œï¼š
âœ… ä»¤ç‰ŒçŸ­å°
âœ… å¯ä»¥éšæ—¶æ’¤é”€
âŒ æ¯æ¬¡éƒ½è¦è¯·æ±‚æˆæƒæœåŠ¡å™¨
âŒ å¢åŠ ç½‘ç»œå»¶è¿Ÿ
```

**ğŸ“ ä¸é€æ˜ä»¤ç‰Œé…ç½®**
```java
@Configuration
public class OpaqueTokenConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .oauth2ResourceServer(oauth2 -> oauth2
                .opaqueToken(opaque -> opaque
                    .introspectionUri("http://auth-server/oauth2/introspect")  // éªŒè¯åœ°å€
                    .introspectionClientCredentials("client-id", "client-secret") // å®¢æˆ·ç«¯å‡­è¯
                )
            );
        
        return http.build();
    }
}
```

---

## 4. ğŸ¯ ä½œç”¨åŸŸä¸æƒé™æ§åˆ¶


### 4.1 Scopeä½œç”¨åŸŸæ¦‚å¿µ


> **ğŸ’¡ é€šä¿—ç†è§£Scope**  
> Scopeå°±åƒæ˜¯"**æƒé™å¡ç‰‡**"ï¼š
> - ç”¨æˆ·æˆæƒæ—¶é€‰æ‹©ç»™å®¢æˆ·ç«¯å“ªäº›æƒé™
> - æ¯”å¦‚ï¼šreadï¼ˆåªè¯»ï¼‰ã€writeï¼ˆå¯å†™ï¼‰ã€deleteï¼ˆå¯åˆ é™¤ï¼‰
> - å°±åƒä½ å…è®¸æŸä¸ªAPP"æŸ¥çœ‹ä½ çš„ç…§ç‰‡"ï¼Œä½†ä¸å…è®¸"åˆ é™¤ç…§ç‰‡"

**ğŸ”¸ Scopeçš„ä½œç”¨**
```
ä¸ºä»€ä¹ˆéœ€è¦Scopeï¼š

åœºæ™¯ä¸¾ä¾‹ï¼š
ä½ ç”¨ç¬¬ä¸‰æ–¹åº”ç”¨ç™»å½•GitHub
â”Œâ”€ ä¸ç”¨Scopeï¼š
â”‚  ç¬¬ä¸‰æ–¹è·å¾—ä½ è´¦å·çš„æ‰€æœ‰æƒé™ï¼ˆå¤ªå±é™©ï¼ï¼‰
â”‚  å¯ä»¥åˆ ä»£ç ã€æ”¹è®¾ç½®ã€è½¬è´¦ç­‰
â”‚
â””â”€ ä½¿ç”¨Scopeï¼š
   ä½ åªæˆæƒ"è¯»å–ä»“åº“ä¿¡æ¯"
   ç¬¬ä¸‰æ–¹åªèƒ½çœ‹ï¼Œä¸èƒ½æ”¹
   å®‰å…¨å¯æ§ï¼
```

**ğŸ”¹ å¸¸è§Scopeç¤ºä¾‹**
```
å®é™…åº”ç”¨ä¸­çš„Scopeï¼š

ç¤¾äº¤åº”ç”¨ï¼š
â€¢ read:profile    - è¯»å–ä¸ªäººèµ„æ–™
â€¢ read:friends    - æŸ¥çœ‹å¥½å‹åˆ—è¡¨
â€¢ write:post      - å‘å¸ƒåŠ¨æ€
â€¢ delete:post     - åˆ é™¤åŠ¨æ€

ç”µå•†åº”ç”¨ï¼š
â€¢ read:orders     - æŸ¥çœ‹è®¢å•
â€¢ write:cart      - ä¿®æ”¹è´­ç‰©è½¦
â€¢ payment         - æ‰§è¡Œæ”¯ä»˜

ä¼ä¸šåº”ç”¨ï¼š
â€¢ admin           - ç®¡ç†å‘˜æƒé™
â€¢ user.read       - è¯»å–ç”¨æˆ·ä¿¡æ¯
â€¢ user.write      - ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯
```

### 4.2 Scopeä½œç”¨åŸŸéªŒè¯


**ğŸ“ åŸºäºScopeçš„è®¿é—®æ§åˆ¶**
```java
@RestController
@RequestMapping("/api")
public class UserController {
    
    // æ–¹å¼1ï¼šä½¿ç”¨@PreAuthorizeæ³¨è§£
    @GetMapping("/user/profile")
    @PreAuthorize("hasAuthority('SCOPE_read:profile')")  // éœ€è¦read:profileæƒé™
    public UserProfile getProfile() {
        return userService.getCurrentUserProfile();
    }
    
    // æ–¹å¼2ï¼šä½¿ç”¨@PreAuthorizeæ£€æŸ¥å¤šä¸ªScope
    @PostMapping("/user/profile")
    @PreAuthorize("hasAuthority('SCOPE_write:profile')")  // éœ€è¦writeæƒé™
    public UserProfile updateProfile(@RequestBody UserProfile profile) {
        return userService.updateProfile(profile);
    }
    
    // æ–¹å¼3ï¼šæ£€æŸ¥å¤šä¸ªScopeï¼ˆæ»¡è¶³å…¶ä¸€å³å¯ï¼‰
    @GetMapping("/admin/users")
    @PreAuthorize("hasAnyAuthority('SCOPE_admin', 'SCOPE_user.read')")
    public List<User> getAllUsers() {
        return userService.getAllUsers();
    }
}
```

> **âš ï¸ æ³¨æ„**  
> Spring Securityä¼šè‡ªåŠ¨åœ¨Scopeå‰åŠ `SCOPE_`å‰ç¼€ï¼Œæ‰€ä»¥ï¼š
> - ä»¤ç‰Œä¸­çš„scopeæ˜¯ï¼š`read:profile`
> - éªŒè¯æ—¶è¦å†™æˆï¼š`SCOPE_read:profile`

**ğŸ”§ é…ç½®çº§åˆ«çš„ScopeéªŒè¯**
```java
@Configuration
public class ResourceServerConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .oauth2ResourceServer(oauth2 -> oauth2.jwt())
            .authorizeHttpRequests(auth -> auth
                // åŸºäºScopeçš„è·¯å¾„ä¿æŠ¤
                .requestMatchers("/api/admin/**")
                    .hasAuthority("SCOPE_admin")
                    
                .requestMatchers(HttpMethod.GET, "/api/user/**")
                    .hasAuthority("SCOPE_read:user")
                    
                .requestMatchers(HttpMethod.POST, "/api/user/**")
                    .hasAuthority("SCOPE_write:user")
                    
                .anyRequest().authenticated()
            );
        
        return http.build();
    }
}
```

### 4.3 OAuth2AuthenticationToken


**ğŸ”¸ ä»€ä¹ˆæ˜¯OAuth2AuthenticationToken**
```
OAuth2AuthenticationTokenï¼š
â€¢ Spring Securityä¸­è¡¨ç¤ºOAuth2è®¤è¯çš„å¯¹è±¡
â€¢ åŒ…å«äº†ç”¨æˆ·ä¿¡æ¯ã€æƒé™ã€ä»¤ç‰Œå±æ€§ç­‰
â€¢ å¯ä»¥åœ¨Controllerä¸­ç›´æ¥æ³¨å…¥ä½¿ç”¨
â€¢ å°±åƒæ˜¯ä¸€ä¸ª"ä¿¡æ¯åŒ…"ï¼Œè£…ç€æ‰€æœ‰è®¤è¯ç›¸å…³æ•°æ®
```

**ğŸ“ ä½¿ç”¨OAuth2AuthenticationToken**
```java
@RestController
public class UserInfoController {
    
    // æ–¹å¼1ï¼šç›´æ¥æ³¨å…¥OAuth2AuthenticationToken
    @GetMapping("/api/userinfo")
    public Map<String, Object> getUserInfo(OAuth2AuthenticationToken authentication) {
        
        Map<String, Object> result = new HashMap<>();
        
        // è·å–ç”¨æˆ·å
        result.put("username", authentication.getName());
        
        // è·å–æ‰€æœ‰å±æ€§ï¼ˆç”¨æˆ·ä¿¡æ¯ï¼‰
        Map<String, Object> attributes = authentication.getPrincipal().getAttributes();
        result.put("email", attributes.get("email"));
        result.put("name", attributes.get("name"));
        
        // è·å–æƒé™ï¼ˆScopeï¼‰
        Collection<GrantedAuthority> authorities = authentication.getAuthorities();
        result.put("scopes", authorities.stream()
            .map(GrantedAuthority::getAuthority)
            .collect(Collectors.toList())
        );
        
        return result;
    }
    
    // æ–¹å¼2ï¼šä½¿ç”¨@AuthenticationPrincipalæ³¨è§£
    @GetMapping("/api/me")
    public String getCurrentUser(
        @AuthenticationPrincipal OAuth2User oauth2User
    ) {
        return "Hello, " + oauth2User.getAttribute("name");
    }
}
```

**ğŸ”„ OAuth2AuthenticationTokenç»“æ„**
```
OAuth2AuthenticationTokenåŒ…å«ï¼š

â”œâ”€ Principalï¼ˆä¸»ä½“ï¼‰
â”‚  â”œâ”€ name: "user123"              // ç”¨æˆ·æ ‡è¯†
â”‚  â””â”€ attributes: {                // ç”¨æˆ·å±æ€§
â”‚       "sub": "user123",
â”‚       "email": "user@example.com",
â”‚       "name": "å¼ ä¸‰"
â”‚     }
â”‚
â”œâ”€ Authoritiesï¼ˆæƒé™é›†åˆï¼‰
â”‚  â”œâ”€ SCOPE_read
â”‚  â”œâ”€ SCOPE_write
â”‚  â””â”€ SCOPE_admin
â”‚
â””â”€ Credentialsï¼ˆå‡­è¯ï¼‰
   â””â”€ JWTä»¤ç‰Œå­—ç¬¦ä¸²
```

---

## 5. ğŸ›¡ï¸ èµ„æºä¿æŠ¤é…ç½®


### 5.1 åˆ†å±‚ä¿æŠ¤ç­–ç•¥


**ğŸ”¸ ä¿æŠ¤å±‚æ¬¡ç†è§£**
```
èµ„æºä¿æŠ¤çš„ä¸‰ä¸ªå±‚æ¬¡ï¼š

ç¬¬1å±‚ï¼šè·¯å¾„çº§ä¿æŠ¤
â”œâ”€ /api/public/**     â†’ å®Œå…¨å…¬å¼€
â”œâ”€ /api/user/**       â†’ éœ€è¦è®¤è¯
â””â”€ /api/admin/**      â†’ éœ€è¦ç®¡ç†å‘˜æƒé™

ç¬¬2å±‚ï¼šæ–¹æ³•çº§ä¿æŠ¤
â””â”€ @PreAuthorize      â†’ ç»†ç²’åº¦æ§åˆ¶æ¯ä¸ªæ¥å£

ç¬¬3å±‚ï¼šæ•°æ®çº§ä¿æŠ¤
â””â”€ åœ¨ä¸šåŠ¡é€»è¾‘ä¸­åˆ¤æ–­  â†’ åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
```

**ğŸ“ è·¯å¾„çº§ä¿æŠ¤é…ç½®**
```java
@Bean
public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
    http
        .oauth2ResourceServer(oauth2 -> oauth2.jwt())
        .authorizeHttpRequests(auth -> auth
            // å…¬å¼€èµ„æºï¼ˆæ— éœ€è®¤è¯ï¼‰
            .requestMatchers("/api/public/**").permitAll()
            .requestMatchers("/health", "/info").permitAll()
            
            // éœ€è¦ç‰¹å®šScope
            .requestMatchers("/api/admin/**")
                .hasAuthority("SCOPE_admin")
            
            // åŸºäºHTTPæ–¹æ³•çš„ä¿æŠ¤
            .requestMatchers(HttpMethod.GET, "/api/orders/**")
                .hasAuthority("SCOPE_read:orders")
            .requestMatchers(HttpMethod.POST, "/api/orders/**")
                .hasAuthority("SCOPE_write:orders")
            
            // å…¶ä»–è¯·æ±‚éœ€è¦è®¤è¯
            .anyRequest().authenticated()
        );
    
    return http.build();
}
```

### 5.2 æ–¹æ³•çº§å®‰å…¨é…ç½®


**ğŸ“ å¯ç”¨æ–¹æ³•çº§å®‰å…¨**
```java
@Configuration
@EnableMethodSecurity(prePostEnabled = true)  // å¯ç”¨æ–¹æ³•çº§å®‰å…¨
public class MethodSecurityConfig {
    // é…ç½®ç±»
}
```

**ğŸ”§ å¸¸ç”¨æ³¨è§£å¯¹æ¯”**

| æ³¨è§£ | ä½œç”¨ | ä½¿ç”¨åœºæ™¯ | ç¤ºä¾‹ |
|-----|------|---------|------|
| **@PreAuthorize** | `æ–¹æ³•æ‰§è¡Œå‰éªŒè¯` | `æœ€å¸¸ç”¨ï¼Œçµæ´»` | `@PreAuthorize("hasRole('ADMIN')")` |
| **@PostAuthorize** | `æ–¹æ³•æ‰§è¡ŒåéªŒè¯` | `éªŒè¯è¿”å›ç»“æœ` | `@PostAuthorize("returnObject.owner == authentication.name")` |
| **@Secured** | `è§’è‰²éªŒè¯` | `ç®€å•è§’è‰²æ£€æŸ¥` | `@Secured("ROLE_ADMIN")` |
| **@RolesAllowed** | `JSR-250æ ‡å‡†` | `æ ‡å‡†åŒ–è§’è‰²` | `@RolesAllowed("ADMIN")` |

**ğŸ“ å®é™…åº”ç”¨ç¤ºä¾‹**
```java
@RestController
@RequestMapping("/api/orders")
public class OrderController {
    
    // åŸºæœ¬ScopeéªŒè¯
    @GetMapping
    @PreAuthorize("hasAuthority('SCOPE_read:orders')")
    public List<Order> getOrders() {
        return orderService.findAll();
    }
    
    // ç»„åˆæ¡ä»¶éªŒè¯ï¼ˆScope + è§’è‰²ï¼‰
    @DeleteMapping("/{id}")
    @PreAuthorize("hasAuthority('SCOPE_delete:orders') and hasRole('ADMIN')")
    public void deleteOrder(@PathVariable Long id) {
        orderService.delete(id);
    }
    
    // å¤æ‚è¡¨è¾¾å¼éªŒè¯
    @PutMapping("/{id}")
    @PreAuthorize("""
        hasAuthority('SCOPE_write:orders') and 
        (#order.userId == authentication.name or hasRole('ADMIN'))
    """)
    public Order updateOrder(@PathVariable Long id, @RequestBody Order order) {
        return orderService.update(id, order);
    }
    
    // éªŒè¯è¿”å›ç»“æœ
    @GetMapping("/{id}")
    @PostAuthorize("returnObject.userId == authentication.name or hasRole('ADMIN')")
    public Order getOrderById(@PathVariable Long id) {
        return orderService.findById(id);
    }
}
```

### 5.3 è‡ªå®šä¹‰æƒé™éªŒè¯


**ğŸ“ è‡ªå®šä¹‰éªŒè¯é€»è¾‘**
```java
// è‡ªå®šä¹‰æƒé™éªŒè¯æœåŠ¡
@Service("orderSecurity")
public class OrderSecurityService {
    
    @Autowired
    private OrderRepository orderRepository;
    
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å¯ä»¥è®¿é—®è®¢å•
    public boolean canAccessOrder(Authentication authentication, Long orderId) {
        Order order = orderRepository.findById(orderId).orElse(null);
        if (order == null) {
            return false;
        }
        
        String username = authentication.getName();
        
        // æ˜¯è®¢å•æ‰€æœ‰è€… æˆ– æ˜¯ç®¡ç†å‘˜
        return order.getUserId().equals(username) || 
               authentication.getAuthorities().stream()
                   .anyMatch(a -> a.getAuthority().equals("ROLE_ADMIN"));
    }
}

// åœ¨Controllerä¸­ä½¿ç”¨
@RestController
public class OrderController {
    
    @GetMapping("/api/orders/{id}")
    @PreAuthorize("@orderSecurity.canAccessOrder(authentication, #orderId)")
    public Order getOrder(@PathVariable("id") Long orderId) {
        return orderService.findById(orderId);
    }
}
```

---

## 6. ğŸ” ä»¤ç‰Œå†…çœæœºåˆ¶


### 6.1 ä»€ä¹ˆæ˜¯ä»¤ç‰Œå†…çœ


> **ğŸ’¡ é€šä¿—ç†è§£**  
> ä»¤ç‰Œå†…çœï¼ˆToken Introspectionï¼‰å°±åƒ"**æ‰“ç”µè¯ç¡®è®¤èº«ä»½**"ï¼š
> - èµ„æºæœåŠ¡å™¨æ‹¿åˆ°ä»¤ç‰Œåï¼Œæ‰“ç”µè¯ç»™æˆæƒæœåŠ¡å™¨
> - é—®ï¼š"è¿™ä¸ªä»¤ç‰Œæ˜¯çœŸçš„å—ï¼Ÿæœ‰å“ªäº›æƒé™ï¼Ÿ"
> - æˆæƒæœåŠ¡å™¨å›ç­”ï¼š"æ˜¯çœŸçš„ï¼Œæœ‰readå’Œwriteæƒé™"

**ğŸ”¸ å†…çœæœºåˆ¶å·¥ä½œæµç¨‹**
```
Token Introspectionæµç¨‹ï¼š

å®¢æˆ·ç«¯                  èµ„æºæœåŠ¡å™¨              æˆæƒæœåŠ¡å™¨
  |                        |                       |
  |--â‘ æºå¸¦ä»¤ç‰Œè¯·æ±‚-------->|                       |
  |  Bearer abc123         |                       |
  |                        |                       |
  |                        |--â‘¡å†…çœè¯·æ±‚----------->|
  |                        |  POST /introspect     |
  |                        |  token=abc123         |
  |                        |                       |
  |                        |<--â‘¢è¿”å›ä»¤ç‰Œä¿¡æ¯-------|
  |                        |  {                    |
  |                        |    "active": true,    |
  |                        |    "scope": "read",   |
  |                        |    "exp": 1640995200  |
  |                        |  }                    |
  |                        |                       |
  |                        |(â‘£éªŒè¯å¹¶å¤„ç†)          |
  |                        |                       |
  |<--â‘¤è¿”å›èµ„æº------------|                       |
```

### 6.2 å†…çœé…ç½®


**ğŸ“ èµ„æºæœåŠ¡å™¨é…ç½®å†…çœ**
```java
@Configuration
public class IntrospectionConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .oauth2ResourceServer(oauth2 -> oauth2
                .opaqueToken(opaque -> opaque
                    // å†…çœç«¯ç‚¹URL
                    .introspectionUri("http://auth-server:9000/oauth2/introspect")
                    // å®¢æˆ·ç«¯è®¤è¯ä¿¡æ¯
                    .introspectionClientCredentials("resource-server", "secret")
                )
            )
            .authorizeHttpRequests(auth -> auth
                .anyRequest().authenticated()
            );
        
        return http.build();
    }
}
```

**ğŸ”§ é…ç½®æ–‡ä»¶æ–¹å¼**
```yaml
spring:
  security:
    oauth2:
      resourceserver:
        opaquetoken:
          # å†…çœç«¯ç‚¹
          introspection-uri: http://localhost:9000/oauth2/introspect
          # å®¢æˆ·ç«¯ID
          client-id: resource-server
          # å®¢æˆ·ç«¯å¯†é’¥
          client-secret: secret
```

### 6.3 å†…çœå“åº”å¤„ç†


**ğŸ“‹ å†…çœå“åº”ç¤ºä¾‹**
```json
// æˆæƒæœåŠ¡å™¨è¿”å›çš„å†…çœå“åº”
{
  "active": true,                    // ä»¤ç‰Œæ˜¯å¦æœ‰æ•ˆ
  "scope": "read write",             // æƒé™èŒƒå›´
  "client_id": "client-app",         // å®¢æˆ·ç«¯ID
  "username": "user123",             // ç”¨æˆ·å
  "token_type": "Bearer",            // ä»¤ç‰Œç±»å‹
  "exp": 1640995200,                 // è¿‡æœŸæ—¶é—´æˆ³
  "iat": 1640991600,                 // ç­¾å‘æ—¶é—´æˆ³
  "sub": "user123",                  // ä¸»ä½“ï¼ˆç”¨æˆ·æ ‡è¯†ï¼‰
  "aud": ["resource-server"]         // å—ä¼—ï¼ˆç›®æ ‡èµ„æºæœåŠ¡å™¨ï¼‰
}
```

**ğŸ”„ å†…çœ vs JWTå¯¹æ¯”**

| ç‰¹æ€§ | **JWTä»¤ç‰Œ** | **å†…çœï¼ˆä¸é€æ˜ä»¤ç‰Œï¼‰** |
|-----|------------|-------------------|
| **éªŒè¯æ–¹å¼** | `æœ¬åœ°éªŒè¯ç­¾å` | `è°ƒç”¨æˆæƒæœåŠ¡å™¨API` |
| **æ€§èƒ½** | `å¿«é€Ÿï¼ˆæ— ç½‘ç»œè°ƒç”¨ï¼‰` | `è¾ƒæ…¢ï¼ˆéœ€ç½‘ç»œè¯·æ±‚ï¼‰` |
| **ä»¤ç‰Œæ’¤é”€** | `æ— æ³•ä¸»åŠ¨æ’¤é”€` | `å¯å®æ—¶æ’¤é”€` |
| **ä»¤ç‰Œå¤§å°** | `è¾ƒå¤§ï¼ˆåŒ…å«ä¿¡æ¯ï¼‰` | `å°ï¼ˆéšæœºå­—ç¬¦ä¸²ï¼‰` |
| **å®‰å…¨æ€§** | `ä¿¡æ¯å¯è§ï¼ˆéœ€åŠ å¯†ï¼‰` | `ä¿¡æ¯å®Œå…¨éšè—` |
| **é€‚ç”¨åœºæ™¯** | `é«˜æ€§èƒ½éœ€æ±‚` | `é«˜å®‰å…¨éœ€æ±‚` |

---

## 7. ğŸ” JWTèµ„æºæœåŠ¡å™¨


### 7.1 JWTèµ„æºæœåŠ¡å™¨é…ç½®


**ğŸ”¸ å®Œæ•´JWTé…ç½®**
```java
@Configuration
@EnableWebSecurity
public class JwtResourceServerConfig {
    
    @Value("${spring.security.oauth2.resourceserver.jwt.issuer-uri}")
    private String issuerUri;
    
    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
            .oauth2ResourceServer(oauth2 -> oauth2
                .jwt(jwt -> jwt
                    .decoder(jwtDecoder())              // JWTè§£ç å™¨
                    .jwtAuthenticationConverter(
                        jwtAuthenticationConverter()    // æƒé™è½¬æ¢å™¨
                    )
                )
            )
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/api/public/**").permitAll()
                .anyRequest().authenticated()
            );
        
        return http.build();
    }
    
    // JWTè§£ç å™¨
    @Bean
    public JwtDecoder jwtDecoder() {
        // ä»issuer-uriè‡ªåŠ¨é…ç½®
        return JwtDecoders.fromIssuerLocation(issuerUri);
    }
    
    // JWTæƒé™è½¬æ¢å™¨
    @Bean
    public JwtAuthenticationConverter jwtAuthenticationConverter() {
        JwtGrantedAuthoritiesConverter grantedAuthoritiesConverter = 
            new JwtGrantedAuthoritiesConverter();
        
        // è®¾ç½®æƒé™å‰ç¼€ï¼ˆé»˜è®¤æ˜¯SCOPE_ï¼‰
        grantedAuthoritiesConverter.setAuthorityPrefix("SCOPE_");
        
        // è®¾ç½®ä»å“ªä¸ªclaimè¯»å–æƒé™ï¼ˆé»˜è®¤æ˜¯scopeï¼‰
        grantedAuthoritiesConverter.setAuthoritiesClaimName("scope");
        
        JwtAuthenticationConverter jwtAuthenticationConverter = 
            new JwtAuthenticationConverter();
        jwtAuthenticationConverter.setJwtGrantedAuthoritiesConverter(
            grantedAuthoritiesConverter
        );
        
        return jwtAuthenticationConverter;
    }
}
```

### 7.2 JWTé…ç½®é€‰é¡¹


**ğŸ”§ é…ç½®æ–‡ä»¶æ–¹å¼**
```yaml
spring:
  security:
    oauth2:
      resourceserver:
        jwt:
          # æ–¹å¼1ï¼šä½¿ç”¨issuer-uriï¼ˆæ¨èï¼‰
          issuer-uri: http://localhost:9000
          
          # æ–¹å¼2ï¼šä½¿ç”¨jwk-set-uri
          # jwk-set-uri: http://localhost:9000/oauth2/jwks
          
          # æ–¹å¼3ï¼šä½¿ç”¨å…¬é’¥æ–‡ä»¶
          # public-key-location: classpath:public-key.pem
```

**ğŸ“‹ é…ç½®æ–¹å¼å¯¹æ¯”**

```
ä¸‰ç§JWTé…ç½®æ–¹å¼ï¼š

1. issuer-uriï¼ˆæœ€ç®€å•ï¼‰
   âœ… è‡ªåŠ¨å‘ç°ç«¯ç‚¹
   âœ… è‡ªåŠ¨è·å–å…¬é’¥
   âœ… æœ€ä½³å®è·µ
   
2. jwk-set-uriï¼ˆæ‰‹åŠ¨æŒ‡å®šï¼‰
   âœ… æ˜ç¡®æŒ‡å®šJWKç«¯ç‚¹
   âš ï¸ éœ€è¦æ‰‹åŠ¨ç»´æŠ¤URL
   
3. public-key-locationï¼ˆæœ¬åœ°å…¬é’¥ï¼‰
   âœ… ç¦»çº¿éªŒè¯
   âš ï¸ å…¬é’¥æ›´æ–°éœ€è¦é‡å¯
   âŒ ä¸æ¨èç”Ÿäº§ç¯å¢ƒ
```

### 7.3 è‡ªå®šä¹‰JWTå¤„ç†


**ğŸ“ è‡ªå®šä¹‰JWTå£°æ˜æå–**
```java
@Configuration
public class CustomJwtConfig {
    
    @Bean
    public JwtAuthenticationConverter jwtAuthenticationConverter() {
        JwtAuthenticationConverter converter = new JwtAuthenticationConverter();
        
        // è‡ªå®šä¹‰æƒé™æå–
        converter.setJwtGrantedAuthoritiesConverter(jwt -> {
            Collection<GrantedAuthority> authorities = new ArrayList<>();
            
            // ä»scopeæå–
            List<String> scopes = jwt.getClaimAsStringList("scope");
            if (scopes != null) {
                scopes.forEach(scope -> 
                    authorities.add(new SimpleGrantedAuthority("SCOPE_" + scope))
                );
            }
            
            // ä»rolesæå–
            List<String> roles = jwt.getClaimAsStringList("roles");
            if (roles != null) {
                roles.forEach(role -> 
                    authorities.add(new SimpleGrantedAuthority("ROLE_" + role))
                );
            }
            
            return authorities;
        });
        
        return converter;
    }
}
```

**ğŸ”§ JWTéªŒè¯è‡ªå®šä¹‰**
```java
@Bean
public JwtDecoder jwtDecoder() {
    NimbusJwtDecoder jwtDecoder = NimbusJwtDecoder
        .withJwkSetUri("http://auth-server/oauth2/jwks")
        .build();
    
    // æ·»åŠ è‡ªå®šä¹‰éªŒè¯å™¨
    jwtDecoder.setJwtValidator(new DelegatingOAuth2TokenValidator<>(
        // éªŒè¯issuer
        new JwtIssuerValidator("http://auth-server"),
        // éªŒè¯è¿‡æœŸæ—¶é—´
        new JwtTimestampValidator(),
        // è‡ªå®šä¹‰éªŒè¯å™¨
        new CustomJwtValidator()
    ));
    
    return jwtDecoder;
}

// è‡ªå®šä¹‰éªŒè¯å™¨
public class CustomJwtValidator implements OAuth2TokenValidator<Jwt> {
    
    @Override
    public OAuth2TokenValidatorResult validate(Jwt jwt) {
        // è‡ªå®šä¹‰éªŒè¯é€»è¾‘
        if (jwt.getClaimAsString("custom_claim") == null) {
            return OAuth2TokenValidatorResult.failure(
                new OAuth2Error("invalid_token", "Missing custom claim", null)
            );
        }
        
        return OAuth2TokenValidatorResult.success();
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


> **ğŸ¯ èµ„æºæœåŠ¡å™¨æ ¸å¿ƒç†è§£**
> 
> **æ˜¯ä»€ä¹ˆ**ï¼šå­˜å‚¨å’Œä¿æŠ¤ç”¨æˆ·æ•°æ®çš„æœåŠ¡å™¨ï¼Œé€šè¿‡éªŒè¯ä»¤ç‰Œå†³å®šæ˜¯å¦æä¾›èµ„æº
> 
> **åšä»€ä¹ˆ**ï¼š
> 1. æ¥æ”¶å¹¶éªŒè¯è®¿é—®ä»¤ç‰Œ
> 2. æ£€æŸ¥ä»¤ç‰Œæƒé™èŒƒå›´ï¼ˆScopeï¼‰
> 3. æ ¹æ®æƒé™å†³å®šè¿”å›æ•°æ®
> 
> **ä¸ºä»€ä¹ˆ**ï¼šå®ç°å®‰å…¨çš„èµ„æºè®¿é—®æ§åˆ¶ï¼Œä¿æŠ¤ç”¨æˆ·æ•°æ®

### 8.2 å…³é”®é…ç½®å¯¹æ¯”


**ğŸ”¸ ä¸¤ç§é…ç½®æ–¹å¼é€‰æ‹©**
```
@EnableResourceServerï¼ˆæ—§ï¼‰:
â€¢ Spring Security 5.xä¹‹å‰
â€¢ åŠŸèƒ½ç›¸å¯¹å›ºå®š
â€¢ ä¸æ¨èæ–°é¡¹ç›®ä½¿ç”¨

oauth2ResourceServer()ï¼ˆæ–°ï¼‰:
â€¢ Spring Security 5.xä¹‹å
â€¢ åŠŸèƒ½å¼ºå¤§çµæ´»
â€¢ æ¨èä½¿ç”¨
```

**ğŸ”¸ ä¸¤ç§ä»¤ç‰Œæ–¹å¼é€‰æ‹©**
```
JWTä»¤ç‰Œï¼š
âœ… é«˜æ€§èƒ½åœºæ™¯
âœ… å‡å°‘æˆæƒæœåŠ¡å™¨å‹åŠ›
âœ… åˆ†å¸ƒå¼ç³»ç»Ÿ

ä¸é€æ˜ä»¤ç‰Œ+å†…çœï¼š
âœ… é«˜å®‰å…¨è¦æ±‚
âœ… éœ€è¦å®æ—¶æ’¤é”€
âœ… æ•æ„Ÿæ•°æ®ä¿æŠ¤
```

### 8.3 å®è·µè¦ç‚¹


**ğŸ“Œ é…ç½®æ£€æŸ¥æ¸…å•**
- [ ] ç¡®å®šä½¿ç”¨JWTè¿˜æ˜¯ä¸é€æ˜ä»¤ç‰Œ
- [ ] é…ç½®ä»¤ç‰ŒéªŒè¯æ–¹å¼ï¼ˆissuer-uriæˆ–å…¬é’¥ï¼‰
- [ ] è®¾ç½®è·¯å¾„çº§ä¿æŠ¤è§„åˆ™
- [ ] å¯ç”¨æ–¹æ³•çº§å®‰å…¨æ³¨è§£
- [ ] é…ç½®Scopeæƒé™æ˜ å°„
- [ ] å¤„ç†è®¤è¯å¤±è´¥åœºæ™¯

**ğŸ”§ å¸¸è§é—®é¢˜è§£å†³**
```
é—®é¢˜1ï¼š401 Unauthorized
â†’ æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦æ­£ç¡®ä¼ é€’
â†’ æ£€æŸ¥Authorization Headeræ ¼å¼
â†’ æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦è¿‡æœŸ

é—®é¢˜2ï¼š403 Forbidden  
â†’ æ£€æŸ¥Scopeæ˜¯å¦è¶³å¤Ÿ
â†’ æ£€æŸ¥@PreAuthorizeè¡¨è¾¾å¼
â†’ æ£€æŸ¥SCOPE_å‰ç¼€

é—®é¢˜3ï¼šJWTéªŒè¯å¤±è´¥
â†’ æ£€æŸ¥å…¬é’¥é…ç½®
â†’ æ£€æŸ¥issuer-uriæ˜¯å¦æ­£ç¡®
â†’ æ£€æŸ¥æ—¶é’ŸåŒæ­¥
```

### 8.4 å­¦ä¹ è·¯çº¿å»ºè®®


```
å­¦ä¹ è¿›åº¦å»ºè®®ï¼š

ç¬¬1æ­¥ï¼šç†è§£OAuth2åŸºæœ¬æ¦‚å¿µï¼ˆ1å¤©ï¼‰
   â†“
ç¬¬2æ­¥ï¼šæŒæ¡èµ„æºæœåŠ¡å™¨é…ç½®ï¼ˆ2å¤©ï¼‰
   â†“  
ç¬¬3æ­¥ï¼šå®è·µJWTä»¤ç‰ŒéªŒè¯ï¼ˆ2å¤©ï¼‰
   â†“
ç¬¬4æ­¥ï¼šæŒæ¡Scopeæƒé™æ§åˆ¶ï¼ˆ2å¤©ï¼‰
   â†“
ç¬¬5æ­¥ï¼šäº†è§£ä»¤ç‰Œå†…çœæœºåˆ¶ï¼ˆ1å¤©ï¼‰
   â†“
ç¬¬6æ­¥ï¼šç»¼åˆé¡¹ç›®å®æˆ˜ï¼ˆ2å¤©ï¼‰

æ€»è®¡ï¼š10å¤©æŒæ¡OAuth2èµ„æºæœåŠ¡å™¨
```

**ğŸ“š å»¶ä¼¸å­¦ä¹ **
- ğŸ”— ç›¸å…³ä¸»é¢˜ï¼š[OAuth2æˆæƒæœåŠ¡å™¨é…ç½®](#)
- ğŸ”— è¿›é˜¶å†…å®¹ï¼š[å¤šç§Ÿæˆ·èµ„æºä¿æŠ¤](#)
- ğŸ”— æœ€ä½³å®è·µï¼š[å¾®æœåŠ¡å®‰å…¨æ¶æ„](#)

---

**ğŸ“ å­¦ä¹ å°è´´å£«**

> **ğŸ’¡ è®°ä½è¿™ä¸ªç±»æ¯”**  
> èµ„æºæœåŠ¡å™¨ = é“¶è¡Œé‡‘åº“ç®¡ç†å‘˜  
> - JWT = æŒ‡çº¹è¯†åˆ«ï¼ˆæœ¬åœ°éªŒè¯ï¼Œå¿«é€Ÿï¼‰
> - å†…çœ = æ‰“ç”µè¯ç¡®è®¤ï¼ˆè¿œç¨‹éªŒè¯ï¼Œå®‰å…¨ï¼‰
> - Scope = æƒé™å¡ï¼ˆæ§åˆ¶èƒ½åšä»€ä¹ˆï¼‰

> **âš¡ æ ¸å¿ƒè®°å¿†**  
> **ä¸‰æ­¥èµ°**ï¼šæ”¶ä»¤ç‰Œ â†’ éªŒæœ‰æ•ˆ â†’ æŸ¥æƒé™ â†’ è¿”èµ„æº  
> **ä¸¤ç§ç‰Œ**ï¼šJWTæœ¬åœ°éªŒï¼Œå†…çœè¿œç¨‹æŸ¥  
> **ä¸€ä¸ªæ ¸å¿ƒ**ï¼šä¿æŠ¤èµ„æºï¼Œæ§åˆ¶è®¿é—®