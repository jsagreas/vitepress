---
title: 2ã€OAuth2å®¢æˆ·ç«¯é…ç½®
---
## ğŸ“š ç›®å½•

1. [OAuth2å®¢æˆ·ç«¯åŸºç¡€æ¦‚å¿µ](#1-OAuth2å®¢æˆ·ç«¯åŸºç¡€æ¦‚å¿µ)
2. [å®¢æˆ·ç«¯é…ç½®å…¥é—¨](#2-å®¢æˆ·ç«¯é…ç½®å…¥é—¨)
3. [ç¬¬ä¸‰æ–¹ç™»å½•é›†æˆå®æˆ˜](#3-ç¬¬ä¸‰æ–¹ç™»å½•é›†æˆå®æˆ˜)
4. [ä½œç”¨åŸŸä¸æƒé™ç®¡ç†](#4-ä½œç”¨åŸŸä¸æƒé™ç®¡ç†)
5. [å›è°ƒå¤„ç†ä¸å®‰å…¨é…ç½®](#5-å›è°ƒå¤„ç†ä¸å®‰å…¨é…ç½®)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ OAuth2å®¢æˆ·ç«¯åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯OAuth2å®¢æˆ·ç«¯


**ğŸ”¸ é€šä¿—ç†è§£**
```
æƒ³è±¡ä½ è¦ç”¨QQè´¦å·ç™»å½•æŸä¸ªç½‘ç«™ï¼š

ä¼ ç»Ÿæ–¹å¼ï¼ˆä¸å®‰å…¨ï¼‰ï¼š
ä½ æŠŠQQè´¦å·å¯†ç å‘Šè¯‰ç½‘ç«™ âŒ 
â†’ ç½‘ç«™å¯ä»¥éšæ„æ“ä½œä½ çš„QQ

OAuth2æ–¹å¼ï¼ˆå®‰å…¨ï¼‰ï¼š
ç½‘ç«™è®©ä½ è·³è½¬åˆ°QQç™»å½•é¡µé¢ âœ…
â†’ QQç¡®è®¤åç»™ç½‘ç«™ä¸€ä¸ª"ä¸´æ—¶é€šè¡Œè¯"
â†’ ç½‘ç«™ç”¨é€šè¡Œè¯è·å–ä½ çš„æ˜µç§°ã€å¤´åƒç­‰ä¿¡æ¯
â†’ ç½‘ç«™æ°¸è¿œæ‹¿ä¸åˆ°ä½ çš„QQå¯†ç 

è¿™ä¸ª"ç½‘ç«™"å°±æ˜¯OAuth2å®¢æˆ·ç«¯ï¼
```

**ğŸ“‹ æ ¸å¿ƒæ¦‚å¿µ**
- **å®¢æˆ·ç«¯ï¼ˆClientï¼‰**ï¼šä½ çš„åº”ç”¨ç³»ç»Ÿï¼Œéœ€è¦æ¥å…¥ç¬¬ä¸‰æ–¹ç™»å½•
- **æˆæƒæœåŠ¡å™¨**ï¼šå¦‚QQã€å¾®ä¿¡ã€GitHubç­‰æä¾›ç™»å½•çš„å¹³å°
- **èµ„æºæœåŠ¡å™¨**ï¼šå­˜å‚¨ç”¨æˆ·ä¿¡æ¯çš„æœåŠ¡å™¨
- **ç”¨æˆ·**ï¼šä½¿ç”¨ç¬¬ä¸‰æ–¹è´¦å·ç™»å½•çš„äºº

### 1.2 OAuth2å®¢æˆ·ç«¯çš„ä½œç”¨


**ğŸ’¡ è§£å†³ä»€ä¹ˆé—®é¢˜**
```
â“ é—®é¢˜åœºæ™¯ï¼š
ç½‘ç«™Aæƒ³è®©ç”¨æˆ·ç”¨å¾®ä¿¡ç™»å½•ï¼Œä½†ï¼š
â€¢ ä¸èƒ½è¦æ±‚ç”¨æˆ·è¾“å…¥å¾®ä¿¡å¯†ç 
â€¢ éœ€è¦è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ï¼ˆæ˜µç§°ã€å¤´åƒï¼‰
â€¢ è¦ä¿è¯æ•´ä¸ªè¿‡ç¨‹å®‰å…¨å¯é 

âœ… OAuth2å®¢æˆ·ç«¯è§£å†³æ–¹æ¡ˆï¼š
1. ç”¨æˆ·ç‚¹å‡»"å¾®ä¿¡ç™»å½•"
2. è·³è½¬åˆ°å¾®ä¿¡æˆæƒé¡µé¢
3. ç”¨æˆ·åŒæ„æˆæƒ
4. å¾®ä¿¡è¿”å›æˆæƒç 
5. ç½‘ç«™ç”¨æˆæƒç æ¢å–Token
6. ç”¨Tokenè·å–ç”¨æˆ·ä¿¡æ¯
7. å®Œæˆç™»å½•
```

**ğŸ¯ æ ¸å¿ƒä»·å€¼**
- **å®‰å…¨æ€§é«˜**ï¼šä¸éœ€è¦ç”¨æˆ·å¯†ç ï¼Œåªç”¨ä¸´æ—¶Token
- **ç”¨æˆ·ä½“éªŒå¥½**ï¼šä¸€é”®ç™»å½•ï¼Œå…å»æ³¨å†Œæµç¨‹
- **æƒé™å¯æ§**ï¼šç”¨æˆ·å¯ä»¥é€‰æ‹©æˆæƒå“ªäº›ä¿¡æ¯
- **é™ä½æˆæœ¬**ï¼šä¸ç”¨è‡ªå»ºè´¦å·ä½“ç³»

---

## 2. ğŸ”§ å®¢æˆ·ç«¯é…ç½®å…¥é—¨


### 2.1 å¯ç”¨OAuth2å®¢æˆ·ç«¯


**ğŸŸ¢ åŸºç¡€éš¾åº¦ï¼šâ­â­**

**ğŸ“ æ·»åŠ ä¾èµ–**
```xml
<!-- Spring Security OAuth2å®¢æˆ·ç«¯ -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-oauth2-client</artifactId>
</dependency>
```

**ğŸ”¸ å¯ç”¨æ³¨è§£ï¼ˆå¯é€‰ï¼‰**
```java
@Configuration
@EnableOAuth2Client  // å¯ç”¨OAuth2å®¢æˆ·ç«¯åŠŸèƒ½
public class SecurityConfig {
    // é…ç½®å†…å®¹
}
```

> ğŸ’¡ **å°è´´å£«**ï¼šåœ¨Spring Boot 2.xä»¥åï¼Œ`@EnableOAuth2Client`é€šå¸¸ä¸æ˜¯å¿…éœ€çš„ï¼Œæ¡†æ¶ä¼šè‡ªåŠ¨é…ç½®ã€‚åªæœ‰åœ¨éœ€è¦è‡ªå®šä¹‰é…ç½®æ—¶æ‰éœ€è¦æ˜¾å¼æ·»åŠ ã€‚

### 2.2 å®¢æˆ·ç«¯æ³¨å†Œé…ç½®


**ğŸ”¸ æ ¸å¿ƒé…ç½®ç±»ï¼šClientRegistration**

```
ClientRegistration æ˜¯ä»€ä¹ˆï¼Ÿ
å°±åƒä½ å»åŠç†ä¼šå‘˜å¡ï¼Œéœ€è¦å¡«å†™çš„ä¿¡æ¯ï¼š
â€¢ å¡å·ï¼ˆClient IDï¼‰
â€¢ å¯†ç ï¼ˆClient Secretï¼‰
â€¢ ä½¿ç”¨èŒƒå›´ï¼ˆScopeï¼‰
â€¢ å›è°ƒåœ°å€ï¼ˆRedirect URIï¼‰

è¿™äº›ä¿¡æ¯å‘Šè¯‰ç¬¬ä¸‰æ–¹å¹³å°ï¼š"è¿™æ˜¯æˆ‘çš„åº”ç”¨ï¼Œè¯·è®¤å‡†æˆ‘ï¼"
```

**ğŸ“‹ é…ç½®æ–‡ä»¶ç¤ºä¾‹ï¼ˆapplication.ymlï¼‰**
```yaml
spring:
  security:
    oauth2:
      client:
        registration:
          # GitHubç™»å½•é…ç½®
          github:
            client-id: your-github-client-id
            client-secret: your-github-secret
            scope: 
              - read:user
              - user:email
            
          # Googleç™»å½•é…ç½®  
          google:
            client-id: your-google-client-id
            client-secret: your-google-secret
            scope:
              - profile
              - email
```

**ğŸ” é…ç½®é¡¹è¯¦è§£**

| é…ç½®é¡¹ | è¯´æ˜ | ç¤ºä¾‹å€¼ |
|--------|------|--------|
| **client-id** | å®¢æˆ·ç«¯IDï¼Œåº”ç”¨çš„å”¯ä¸€æ ‡è¯† | `abc123def456` |
| **client-secret** | å®¢æˆ·ç«¯å¯†é’¥ï¼Œç”¨äºéªŒè¯èº«ä»½ | `xyz789uvw012` |
| **scope** | æƒé™èŒƒå›´ï¼Œè¦è·å–çš„ç”¨æˆ·ä¿¡æ¯ | `profile, email` |
| **redirect-uri** | æˆæƒåçš„å›è°ƒåœ°å€ | `{baseUrl}/login/oauth2/code/github` |

### 2.3 Javaä»£ç é…ç½®æ–¹å¼


**ğŸ”¸ ä»£ç é…ç½®ClientRegistration**
```java
@Configuration
public class OAuth2ClientConfig {
    
    @Bean
    public ClientRegistrationRepository clientRegistrationRepository() {
        return new InMemoryClientRegistrationRepository(
            githubClientRegistration(),
            googleClientRegistration()
        );
    }
    
    // GitHubå®¢æˆ·ç«¯æ³¨å†Œ
    private ClientRegistration githubClientRegistration() {
        return ClientRegistration.withRegistrationId("github")
            .clientId("your-client-id")
            .clientSecret("your-client-secret")
            .scope("read:user", "user:email")
            .authorizationUri("https://github.com/login/oauth/authorize")
            .tokenUri("https://github.com/login/oauth/access_token")
            .userInfoUri("https://api.github.com/user")
            .userNameAttributeName("id")
            .clientName("GitHub")
            .redirectUri("{baseUrl}/login/oauth2/code/github")
            .authorizationGrantType(AuthorizationGrantType.AUTHORIZATION_CODE)
            .build();
    }
}
```

**ğŸ“Š å…³é”®å±æ€§è¯´æ˜**
```
authorizationUri - æˆæƒåœ°å€
  â†“ ç”¨æˆ·ç‚¹å‡»ç™»å½•æ—¶è·³è½¬çš„åœ°å€

tokenUri - Tokenè·å–åœ°å€
  â†“ ç”¨æˆæƒç æ¢Tokençš„åœ°å€

userInfoUri - ç”¨æˆ·ä¿¡æ¯åœ°å€
  â†“ ç”¨Tokenè·å–ç”¨æˆ·ä¿¡æ¯çš„åœ°å€

redirectUri - å›è°ƒåœ°å€
  â†“ æˆæƒæˆåŠŸåè¿”å›çš„åœ°å€
```

---

## 3. ğŸš€ ç¬¬ä¸‰æ–¹ç™»å½•é›†æˆå®æˆ˜


### 3.1 GitHubç™»å½•é›†æˆ


**ğŸŸ¡ è¿›é˜¶éš¾åº¦ï¼šâ­â­â­**

**æ­¥éª¤1ï¼šåœ¨GitHubåˆ›å»ºOAuthåº”ç”¨**
```
è®¿é—®æµç¨‹ï¼š
GitHub â†’ Settings â†’ Developer settings 
â†’ OAuth Apps â†’ New OAuth App

å¡«å†™ä¿¡æ¯ï¼š
Application name: æˆ‘çš„åº”ç”¨
Homepage URL: http://localhost:8080
Authorization callback URL: 
  http://localhost:8080/login/oauth2/code/github

è·å–ï¼š
Client ID: abc123...
Client Secret: xyz789...
```

**æ­¥éª¤2ï¼šé…ç½®Spring Security**
```java
@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
            .authorizeRequests(authorize -> authorize
                .antMatchers("/", "/login**").permitAll()
                .anyRequest().authenticated()
            )
            .oauth2Login(oauth2 -> oauth2
                .loginPage("/login")
                .defaultSuccessUrl("/home")
                .failureUrl("/login?error=true")
            );
    }
}
```

**æ­¥éª¤3ï¼šåˆ›å»ºç™»å½•é¡µé¢**
```html
<!-- login.html -->
<a href="/oauth2/authorization/github">
    <img src="/images/github-logo.png"/>
    ä½¿ç”¨GitHubç™»å½•
</a>
```

### 3.2 å¾®ä¿¡ç™»å½•é›†æˆ


**ğŸ”¸ å¾®ä¿¡ç™»å½•ç‰¹ç‚¹**
```
å¾®ä¿¡ä¸GitHubçš„åŒºåˆ«ï¼š
â€¢ éœ€è¦å…ˆç”³è¯·å¾®ä¿¡å¼€æ”¾å¹³å°è´¦å·
â€¢ éœ€è¦ç½‘ç«™å¤‡æ¡ˆï¼ˆä¸ªäººå¼€å‘å¯ç”¨æµ‹è¯•å·ï¼‰
â€¢ å›è°ƒåœ°å€å¿…é¡»æ˜¯å·²éªŒè¯çš„åŸŸå
```

**é…ç½®ç¤ºä¾‹**
```yaml
spring:
  security:
    oauth2:
      client:
        registration:
          wechat:
            client-id: ${wechat.appid}
            client-secret: ${wechat.secret}
            scope: snsapi_login
            authorization-grant-type: authorization_code
            redirect-uri: "{baseUrl}/login/oauth2/code/wechat"
            client-name: å¾®ä¿¡ç™»å½•
        
        provider:
          wechat:
            authorization-uri: https://open.weixin.qq.com/connect/qrconnect
            token-uri: https://api.weixin.qq.com/sns/oauth2/access_token
            user-info-uri: https://api.weixin.qq.com/sns/userinfo
            user-name-attribute: openid
```

**ğŸ” å¾®ä¿¡å“åº”å¤„ç†**
```java
@Component
public class WechatUserInfoHandler {
    
    // å¾®ä¿¡è¿”å›çš„ç”¨æˆ·ä¿¡æ¯æ ¼å¼ç‰¹æ®Šï¼Œéœ€è¦è‡ªå®šä¹‰å¤„ç†
    public OAuth2User loadUser(OAuth2UserRequest userRequest) {
        // è·å–Token
        String accessToken = userRequest.getAccessToken().getTokenValue();
        
        // è°ƒç”¨å¾®ä¿¡APIè·å–ç”¨æˆ·ä¿¡æ¯
        String userInfoUrl = String.format(
            "https://api.weixin.qq.com/sns/userinfo?access_token=%s&openid=%s",
            accessToken, openid
        );
        
        // è¿”å›æ ‡å‡†OAuth2Userå¯¹è±¡
        return new DefaultOAuth2User(...);
    }
}
```

### 3.3 å¤šå¹³å°ç»Ÿä¸€ç™»å½•é…ç½®


**ğŸ¯ ç™»å½•é¡µé¢ç»Ÿä¸€è®¾è®¡**
```html
<!-- æ”¯æŒå¤šä¸ªç¬¬ä¸‰æ–¹ç™»å½• -->
<div class="login-options">
    <a href="/oauth2/authorization/github">
        <button class="github-btn">GitHubç™»å½•</button>
    </a>
    
    <a href="/oauth2/authorization/google">
        <button class="google-btn">Googleç™»å½•</button>
    </a>
    
    <a href="/oauth2/authorization/wechat">
        <button class="wechat-btn">å¾®ä¿¡ç™»å½•</button>
    </a>
</div>
```

**ğŸ“‹ ç™»å½•æˆåŠŸå¤„ç†å™¨**
```java
@Component
public class OAuth2LoginSuccessHandler 
    extends SimpleUrlAuthenticationSuccessHandler {
    
    @Override
    public void onAuthenticationSuccess(
        HttpServletRequest request,
        HttpServletResponse response,
        Authentication authentication) {
        
        OAuth2User user = (OAuth2User) authentication.getPrincipal();
        
        // æ ¹æ®ä¸åŒå¹³å°å¤„ç†ç”¨æˆ·ä¿¡æ¯
        String registrationId = getRegistrationId(authentication);
        
        switch (registrationId) {
            case "github":
                handleGithubUser(user);
                break;
            case "google":
                handleGoogleUser(user);
                break;
            case "wechat":
                handleWechatUser(user);
                break;
        }
        
        super.onAuthenticationSuccess(request, response, authentication);
    }
}
```

---

## 4. ğŸ” ä½œç”¨åŸŸä¸æƒé™ç®¡ç†


### 4.1 Scopeä½œç”¨åŸŸè¯¦è§£


**ğŸ”¸ ä»€ä¹ˆæ˜¯Scope**
```
Scopeå°±åƒä½ æˆæƒåˆ«äººä»£åŠäº‹æƒ…æ—¶çš„æƒé™æ¸…å•ï¼š

æˆæƒèŒƒå›´å°ï¼š
åªèƒ½æŸ¥çœ‹æˆ‘çš„åŸºæœ¬ä¿¡æ¯ï¼ˆå§“åã€å¤´åƒï¼‰

æˆæƒèŒƒå›´ä¸­ï¼š
å¯ä»¥æŸ¥çœ‹æˆ‘çš„å¥½å‹åˆ—è¡¨ã€ç›¸å†Œ

æˆæƒèŒƒå›´å¤§ï¼š
å¯ä»¥å‘å¸ƒåŠ¨æ€ã€ä¿®æ”¹èµ„æ–™

Scopeå°±æ˜¯æ§åˆ¶"èƒ½åšä»€ä¹ˆ"çš„æƒé™åˆ—è¡¨
```

**ğŸ“‹ å¸¸è§Scopeæƒé™è¡¨**

| å¹³å° | Scopeå€¼ | è·å–çš„æƒé™ |
|------|---------|------------|
| **GitHub** | `read:user` | è¯»å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ |
| | `user:email` | è¯»å–ç”¨æˆ·é‚®ç®± |
| | `repo` | è®¿é—®ä»“åº“ä¿¡æ¯ |
| **Google** | `profile` | åŸºæœ¬èµ„æ–™ï¼ˆå§“åã€å¤´åƒï¼‰ |
| | `email` | é‚®ç®±åœ°å€ |
| | `openid` | å”¯ä¸€æ ‡è¯†ç¬¦ |
| **å¾®ä¿¡** | `snsapi_base` | é™é»˜æˆæƒï¼Œè·å–openid |
| | `snsapi_userinfo` | éœ€ç”¨æˆ·ç¡®è®¤ï¼Œè·å–è¯¦ç»†ä¿¡æ¯ |

### 4.2 Scopeé…ç½®ç­–ç•¥


**âš¡ æœ€å°æƒé™åŸåˆ™**
```java
// âŒ ä¸æ¨èï¼šç”³è¯·è¿‡å¤šæƒé™
.scope("read:user", "user:email", "repo", "delete_repo", "admin:org")

// âœ… æ¨èï¼šåªç”³è¯·å¿…éœ€æƒé™
.scope("read:user", "user:email")  // ä»…éœ€è¦åŸºæœ¬ä¿¡æ¯å’Œé‚®ç®±
```

**ğŸ”¸ åŠ¨æ€Scopeé…ç½®**
```java
@Configuration
public class DynamicScopeConfig {
    
    public List<String> determineScopes(String registrationId, String userRole) {
        List<String> scopes = new ArrayList<>();
        
        // åŸºç¡€æƒé™ï¼šæ‰€æœ‰ç”¨æˆ·éƒ½éœ€è¦
        scopes.add("profile");
        scopes.add("email");
        
        // æ ¹æ®ç”¨æˆ·è§’è‰²æ·»åŠ é¢å¤–æƒé™
        if ("ADMIN".equals(userRole)) {
            scopes.add("repo");
            scopes.add("admin:org");
        }
        
        return scopes;
    }
}
```

### 4.3 æƒé™éªŒè¯ä¸é™åˆ¶


**ğŸ” æ£€æŸ¥ç”¨æˆ·æˆæƒçš„Scope**
```java
@RestController
public class UserController {
    
    @GetMapping("/user/repos")
    public ResponseEntity<?> getUserRepos(
        @AuthenticationPrincipal OAuth2User user) {
        
        // è·å–ç”¨æˆ·æˆæƒçš„Scope
        OAuth2AuthenticatedPrincipal principal = 
            (OAuth2AuthenticatedPrincipal) user;
        Collection<GrantedAuthority> authorities = 
            principal.getAuthorities();
        
        // æ£€æŸ¥æ˜¯å¦æœ‰repoæƒé™
        boolean hasRepoScope = authorities.stream()
            .anyMatch(auth -> auth.getAuthority().equals("SCOPE_repo"));
        
        if (!hasRepoScope) {
            return ResponseEntity.status(403)
                .body("éœ€è¦repoæƒé™æ‰èƒ½è®¿é—®");
        }
        
        // è°ƒç”¨GitHub APIè·å–ä»“åº“
        return ResponseEntity.ok(getRepositories());
    }
}
```

---

## 5. ğŸ”„ å›è°ƒå¤„ç†ä¸å®‰å…¨é…ç½®


### 5.1 å›è°ƒURLé…ç½®è¯¦è§£


**ğŸ”¸ å›è°ƒURLçš„ä½œç”¨**
```
æˆæƒæµç¨‹ä¸­çš„å›è°ƒï¼š

ç¬¬1æ­¥ï¼šç”¨æˆ·ç‚¹å‡»"GitHubç™»å½•"
  â†’ è·³è½¬åˆ° https://github.com/login/oauth/authorize

ç¬¬2æ­¥ï¼šç”¨æˆ·åŒæ„æˆæƒ
  â†’ GitHubé‡å®šå‘åˆ°ä½ çš„å›è°ƒURL
  â†’ http://localhost:8080/login/oauth2/code/github?code=abc123

ç¬¬3æ­¥ï¼šä½ çš„åº”ç”¨æ”¶åˆ°codeå‚æ•°
  â†’ ç”¨codeæ¢å–access_token
  â†’ å®Œæˆç™»å½•
```

**ğŸ“‹ å›è°ƒURLé…ç½®è§„èŒƒ**
```yaml
spring:
  security:
    oauth2:
      client:
        registration:
          github:
            # æ ‡å‡†æ ¼å¼ï¼š{baseUrl}/login/oauth2/code/{registrationId}
            redirect-uri: "{baseUrl}/login/oauth2/code/github"
            
          custom-provider:
            # è‡ªå®šä¹‰å›è°ƒè·¯å¾„
            redirect-uri: "http://myapp.com/oauth/callback"
```

**âš ï¸ å¸¸è§é…ç½®é”™è¯¯**
```
âŒ é”™è¯¯1ï¼šå›è°ƒURLä¸åŒ¹é…
é…ç½®çš„ï¼šhttp://localhost:8080/callback
GitHubä¸Šå¡«å†™çš„ï¼šhttp://localhost:8080/login/oauth2/code/github
â†’ æˆæƒå¤±è´¥ï¼

âŒ é”™è¯¯2ï¼šåè®®ä¸ä¸€è‡´
é…ç½®çš„ï¼šhttp://myapp.com/callback
å®é™…è®¿é—®ï¼šhttps://myapp.com/callback
â†’ é‡å®šå‘å¤±è´¥ï¼

âœ… æ­£ç¡®åšæ³•ï¼š
1. ä½¿ç”¨{baseUrl}å ä½ç¬¦è‡ªåŠ¨åŒ¹é…
2. ç¡®ä¿GitHubåå°é…ç½®å®Œå…¨ä¸€è‡´
3. ç”Ÿäº§ç¯å¢ƒä½¿ç”¨HTTPS
```

### 5.2 AuthorizationCodeGrantConfigureré…ç½®


**ğŸ”¸ æˆæƒç æ¨¡å¼é…ç½®å™¨**
```java
@Configuration
public class OAuth2SecurityConfig extends WebSecurityConfigurerAdapter {
    
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http.oauth2Login(oauth2 -> oauth2
            .authorizationEndpoint(authorization -> authorization
                // è‡ªå®šä¹‰æˆæƒè¯·æ±‚å­˜å‚¨
                .authorizationRequestRepository(cookieRepository())
                // è‡ªå®šä¹‰æˆæƒè¯·æ±‚è§£æå™¨
                .authorizationRequestResolver(customResolver())
            )
            .tokenEndpoint(token -> token
                // è‡ªå®šä¹‰Tokenå“åº”å¤„ç†
                .accessTokenResponseClient(customTokenClient())
            )
            .userInfoEndpoint(userInfo -> userInfo
                // è‡ªå®šä¹‰ç”¨æˆ·ä¿¡æ¯åŠ è½½
                .userService(customUserService())
            )
        );
    }
    
    // ä½¿ç”¨Cookieå­˜å‚¨æˆæƒè¯·æ±‚ï¼ˆé˜²æ­¢CSRFï¼‰
    @Bean
    public AuthorizationRequestRepository<OAuth2AuthorizationRequest> 
        cookieRepository() {
        return new HttpCookieOAuth2AuthorizationRequestRepository();
    }
}
```

**ğŸ” é…ç½®é¡¹è¯´æ˜**
```
authorizationEndpoint - æˆæƒç«¯ç‚¹é…ç½®
  â†“ æ§åˆ¶å¦‚ä½•å‘èµ·æˆæƒè¯·æ±‚

tokenEndpoint - Tokenç«¯ç‚¹é…ç½®  
  â†“ æ§åˆ¶å¦‚ä½•è·å–å’Œå¤„ç†Token

userInfoEndpoint - ç”¨æˆ·ä¿¡æ¯ç«¯ç‚¹é…ç½®
  â†“ æ§åˆ¶å¦‚ä½•è·å–ç”¨æˆ·ä¿¡æ¯
```

### 5.3 å®¢æˆ·ç«¯å‡­è¯å®‰å…¨é…ç½®


**ğŸ”’ ä¿æŠ¤å®¢æˆ·ç«¯å¯†é’¥**
```yaml
# âŒ ä¸æ¨èï¼šæ˜æ–‡å†™åœ¨é…ç½®æ–‡ä»¶
spring:
  security:
    oauth2:
      client:
        registration:
          github:
            client-secret: abc123def456xyz789  # å±é™©ï¼

# âœ… æ¨èï¼šä½¿ç”¨ç¯å¢ƒå˜é‡
spring:
  security:
    oauth2:
      client:
        registration:
          github:
            client-secret: ${GITHUB_CLIENT_SECRET}
```

**ğŸ›¡ï¸ ä½¿ç”¨Spring Cloud ConfigåŠ å¯†**
```yaml
# åŠ å¯†åçš„é…ç½®
spring:
  security:
    oauth2:
      client:
        registration:
          github:
            client-secret: '{cipher}AQB7zK3...'  # åŠ å¯†åçš„å¯†é’¥
```

**ğŸ” å¯†é’¥è½®æ¢ç­–ç•¥**
```java
@Component
public class ClientSecretRotationService {
    
    private final ClientRegistrationRepository repository;
    
    // å®šæœŸè½®æ¢å¯†é’¥ï¼ˆå¦‚æ¯90å¤©ï¼‰
    @Scheduled(cron = "0 0 0 */90 * *")
    public void rotateClientSecret() {
        // 1. ç”Ÿæˆæ–°å¯†é’¥
        String newSecret = generateNewSecret();
        
        // 2. æ›´æ–°åˆ°OAuthå¹³å°
        updateOAuthProvider(newSecret);
        
        // 3. æ›´æ–°æœ¬åœ°é…ç½®
        updateLocalConfig(newSecret);
        
        // 4. è®°å½•å˜æ›´æ—¥å¿—
        logSecretRotation();
    }
}
```

### 5.4 é˜²æ­¢CSRFæ”»å‡»


**ğŸ”¸ Stateå‚æ•°éªŒè¯**
```
OAuth2çš„å®‰å…¨æœºåˆ¶ï¼š

ç¬¬1æ­¥ï¼šå‘èµ·æˆæƒè¯·æ±‚æ—¶ç”Ÿæˆéšæœºstate
  â†’ https://github.com/login/oauth/authorize?state=xyz123

ç¬¬2æ­¥ï¼šGitHubå›è°ƒæ—¶æºå¸¦state
  â†’ http://yourapp.com/callback?code=abc&state=xyz123

ç¬¬3æ­¥ï¼šéªŒè¯stateæ˜¯å¦åŒ¹é…
  â†’ åŒ¹é…ï¼šç»§ç»­æˆæƒæµç¨‹
  â†’ ä¸åŒ¹é…ï¼šæ‹’ç»ï¼ˆå¯èƒ½æ˜¯CSRFæ”»å‡»ï¼‰
```

**âœ… Spring Securityè‡ªåŠ¨å¤„ç†**
```java
// Spring Security OAuth2é»˜è®¤å·²å¯ç”¨StateéªŒè¯
// æ— éœ€é¢å¤–é…ç½®ï¼Œä½†å¯ä»¥è‡ªå®šä¹‰

@Bean
public AuthorizationRequestRepository<OAuth2AuthorizationRequest> 
    authorizationRequestRepository() {
    
    return new HttpSessionOAuth2AuthorizationRequestRepository() {
        @Override
        public OAuth2AuthorizationRequest removeAuthorizationRequest(
            HttpServletRequest request) {
            
            // éªŒè¯Stateå‚æ•°
            String state = request.getParameter("state");
            OAuth2AuthorizationRequest authRequest = 
                super.removeAuthorizationRequest(request);
            
            if (authRequest == null || 
                !authRequest.getState().equals(state)) {
                throw new OAuth2AuthenticationException("Invalid state");
            }
            
            return authRequest;
        }
    };
}
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ OAuth2å®¢æˆ·ç«¯ï¼šä½ çš„åº”ç”¨ï¼Œæ¥å…¥ç¬¬ä¸‰æ–¹ç™»å½•çš„ä¸€æ–¹
ğŸ”¸ ClientRegistrationï¼šå®¢æˆ·ç«¯æ³¨å†Œä¿¡æ¯ï¼ˆIDã€å¯†é’¥ã€Scopeç­‰ï¼‰
ğŸ”¸ Scopeä½œç”¨åŸŸï¼šæ§åˆ¶è·å–ç”¨æˆ·ä¿¡æ¯çš„æƒé™èŒƒå›´
ğŸ”¸ å›è°ƒURLï¼šæˆæƒæˆåŠŸåè¿”å›çš„åœ°å€ï¼Œå¿…é¡»ç²¾ç¡®åŒ¹é…
ğŸ”¸ @EnableOAuth2Clientï¼šå¯ç”¨OAuth2å®¢æˆ·ç«¯åŠŸèƒ½çš„æ³¨è§£
ğŸ”¸ æˆæƒç æ¨¡å¼ï¼šæœ€å®‰å…¨çš„OAuth2æˆæƒæ–¹å¼
```

### 6.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å®¢æˆ·ç«¯é…ç½®çš„æœ¬è´¨**
```
é…ç½®OAuth2å®¢æˆ·ç«¯ = å‘Šè¯‰Spring Securityï¼š
â€¢ æˆ‘è¦æ¥å…¥å“ªä¸ªå¹³å°ï¼ˆGitHub/Google/å¾®ä¿¡ï¼‰
â€¢ æˆ‘çš„èº«ä»½å‡­è¯æ˜¯ä»€ä¹ˆï¼ˆClient ID/Secretï¼‰
â€¢ æˆ‘éœ€è¦å“ªäº›æƒé™ï¼ˆScopeï¼‰
â€¢ æˆæƒæˆåŠŸåå›è°ƒåˆ°å“ªï¼ˆRedirect URIï¼‰
```

**ğŸ”¹ ç¬¬ä¸‰æ–¹ç™»å½•çš„æµç¨‹**
```
ç”¨æˆ·ç‚¹å‡»ç™»å½•
  â†“
è·³è½¬åˆ°ç¬¬ä¸‰æ–¹æˆæƒé¡µé¢ï¼ˆå¸¦ä¸Šä½ çš„Client IDï¼‰
  â†“
ç”¨æˆ·åŒæ„æˆæƒ
  â†“
ç¬¬ä¸‰æ–¹å›è°ƒä½ çš„åº”ç”¨ï¼ˆå¸¦ä¸Šæˆæƒç codeï¼‰
  â†“
ä½ çš„åº”ç”¨ç”¨codeæ¢å–Token
  â†“
ç”¨Tokenè·å–ç”¨æˆ·ä¿¡æ¯
  â†“
ç™»å½•æˆåŠŸ
```

**ğŸ”¹ å®‰å…¨é…ç½®è¦ç‚¹**
```
âœ… å¿…åšå®‰å…¨æªæ–½ï¼š
1. å®¢æˆ·ç«¯å¯†é’¥åŠ å¯†å­˜å‚¨ï¼Œä¸è¦æ˜æ–‡
2. ä½¿ç”¨HTTPSï¼Œé˜²æ­¢ä¸­é—´äººæ”»å‡»
3. éªŒè¯Stateå‚æ•°ï¼Œé˜²æ­¢CSRF
4. æœ€å°æƒé™åŸåˆ™ï¼Œä¸ç”³è¯·å¤šä½™Scope
5. å®šæœŸè½®æ¢å¯†é’¥

âŒ å¸¸è§å®‰å…¨éšæ‚£ï¼š
1. å¯†é’¥æ³„éœ²åˆ°Gitä»“åº“
2. å›è°ƒURLé…ç½®é”™è¯¯
3. è¿‡åº¦ç”³è¯·æƒé™
4. ä¸éªŒè¯Stateå‚æ•°
```

### 6.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ é€‰æ‹©åˆé€‚çš„ç¬¬ä¸‰æ–¹ç™»å½•**
```
ä¸ªäººé¡¹ç›®ï¼š
â†’ GitHubï¼ˆå¼€å‘è€…å‹å¥½ï¼Œæ³¨å†Œç®€å•ï¼‰
â†’ Googleï¼ˆç”¨æˆ·åŸºæ•°å¤§ï¼‰

ä¼ä¸šé¡¹ç›®ï¼š
â†’ å¾®ä¿¡ï¼ˆå›½å†…ç”¨æˆ·å¤šï¼‰
â†’ ä¼ä¸šå¾®ä¿¡ï¼ˆä¼ä¸šå†…éƒ¨ï¼‰
â†’ é’‰é’‰ï¼ˆä¼ä¸šåŠå…¬ï¼‰

å›½é™…åŒ–é¡¹ç›®ï¼š
â†’ Google + Facebookï¼ˆè¦†ç›–é¢å¹¿ï¼‰
â†’ GitHubï¼ˆæŠ€æœ¯ç¤¾åŒºï¼‰
```

**ğŸ’ª å¼€å‘è°ƒè¯•æŠ€å·§**
```
1. æœ¬åœ°æµ‹è¯•å›è°ƒURLé—®é¢˜ï¼š
   â€¢ ä½¿ç”¨ http://localhost:8080 å¼€å‘
   â€¢ é…ç½®å†…ç½‘ç©¿é€ï¼ˆngrokï¼‰æµ‹è¯•å¾®ä¿¡ç™»å½•

2. è°ƒè¯•OAuth2æµç¨‹ï¼š
   â€¢ å¼€å¯Spring Securityæ—¥å¿—
   â€¢ æŸ¥çœ‹Networkè¯·æ±‚å“åº”
   â€¢ æ£€æŸ¥Tokenå’Œç”¨æˆ·ä¿¡æ¯

3. é”™è¯¯æ’æŸ¥ï¼š
   â€¢ redirect_uri_mismatch â†’ æ£€æŸ¥å›è°ƒURLé…ç½®
   â€¢ invalid_client â†’ æ£€æŸ¥Client ID/Secret
   â€¢ access_denied â†’ ç”¨æˆ·æ‹’ç»æˆæƒ
```

**ğŸš€ æ€§èƒ½ä¼˜åŒ–å»ºè®®**
```
1. Tokenç¼“å­˜ï¼š
   â€¢ é¿å…é¢‘ç¹è°ƒç”¨ç”¨æˆ·ä¿¡æ¯æ¥å£
   â€¢ ä½¿ç”¨Redisç¼“å­˜Token

2. æ‰¹é‡æˆæƒï¼š
   â€¢ ä¸€æ¬¡æ€§ç”³è¯·æ‰€éœ€çš„æ‰€æœ‰Scope
   â€¢ é¿å…å¤šæ¬¡æˆæƒæµç¨‹

3. å¼‚æ­¥å¤„ç†ï¼š
   â€¢ ç”¨æˆ·ä¿¡æ¯è·å–å¼‚æ­¥åŒ–
   â€¢ ä¸é˜»å¡ç™»å½•æµç¨‹
```

### 6.4 å­¦ä¹ æ£€æŸ¥æ¸…å•


**ğŸ“ åŸºç¡€æŒæ¡**
- [ ] ç†è§£OAuth2å®¢æˆ·ç«¯çš„æ¦‚å¿µå’Œä½œç”¨
- [ ] ä¼šé…ç½®ClientRegistration
- [ ] ç†è§£Scopeä½œç”¨åŸŸçš„å«ä¹‰
- [ ] çŸ¥é“å›è°ƒURLçš„ä½œç”¨å’Œé…ç½®

**ğŸ“ è¿›é˜¶åº”ç”¨**  
- [ ] èƒ½é›†æˆGitHub/Googleç™»å½•
- [ ] ä¼šå¤„ç†å¤šå¹³å°ç™»å½•
- [ ] ç†è§£æˆæƒç æ¨¡å¼çš„æµç¨‹
- [ ] èƒ½è‡ªå®šä¹‰ç™»å½•æˆåŠŸå¤„ç†

**ğŸ“ å®‰å…¨å®è·µ**
- [ ] çŸ¥é“å¦‚ä½•ä¿æŠ¤å®¢æˆ·ç«¯å¯†é’¥
- [ ] ç†è§£Stateå‚æ•°çš„ä½œç”¨
- [ ] ä¼šé…ç½®HTTPSå’ŒCSRFé˜²æŠ¤
- [ ] æŒæ¡æœ€å°æƒé™åŸåˆ™

---

**ğŸ¯ æ ¸å¿ƒè®°å¿†å£è¯€**

```
OAuthå®¢æˆ·ç«¯æ¥ç¬¬ä¸‰æ–¹ï¼Œ
IDå¯†é’¥ä½œç”¨åŸŸåˆ«å¿˜ã€‚
å›è°ƒåœ°å€è¦åŒ¹é…å‡†ï¼Œ
å®‰å…¨é…ç½®æ”¾å¿ƒä¸Šã€‚

GitHubå¾®ä¿¡å„ä¸åŒï¼Œ
ç»Ÿä¸€å¤„ç†æµç¨‹é€šã€‚
Tokenæ¢å®Œæ‹¿ä¿¡æ¯ï¼Œ
ç™»å½•æˆåŠŸç”¨æˆ·çˆ½ï¼
```

**â­ é‡ç‚¹æé†’**
- OAuth2å®¢æˆ·ç«¯é…ç½®çœ‹ä¼¼å¤æ‚ï¼Œå®åˆ™æµç¨‹æ¸…æ™°
- æŒæ¡æ ¸å¿ƒæ¦‚å¿µåï¼Œå„å¹³å°æ¥å…¥å¤§åŒå°å¼‚
- å®‰å…¨é…ç½®æ°¸è¿œæ˜¯ç¬¬ä¸€ä½çš„
- å¤šåŠ¨æ‰‹å®è·µï¼Œdebugä¸€éå°±å…¨æ‡‚äº†ï¼