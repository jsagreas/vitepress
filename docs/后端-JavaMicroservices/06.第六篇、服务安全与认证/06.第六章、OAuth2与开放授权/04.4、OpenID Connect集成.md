---
title: 4ã€OpenID Connecté›†æˆ
---
## ğŸ“š ç›®å½•

1. [OpenID Connectæ˜¯ä»€ä¹ˆ](#1-OpenID-Connectæ˜¯ä»€ä¹ˆ)
2. [æ ¸å¿ƒæ¦‚å¿µç†è§£](#2-æ ¸å¿ƒæ¦‚å¿µç†è§£)
3. [ID Tokenè¯¦è§£](#3-ID-Tokenè¯¦è§£)
4. [UserInfoç«¯ç‚¹è·å–ç”¨æˆ·ä¿¡æ¯](#4-UserInfoç«¯ç‚¹è·å–ç”¨æˆ·ä¿¡æ¯)
5. [Spring Securityä¸­çš„OIDCé…ç½®](#5-Spring-Securityä¸­çš„OIDCé…ç½®)
6. [å®ç°å•ç‚¹ç™»å½•SSO](#6-å®ç°å•ç‚¹ç™»å½•SSO)
7. [è”åˆèº«ä»½è®¤è¯å®è·µ](#7-è”åˆèº«ä»½è®¤è¯å®è·µ)
8. [PKCEå®‰å…¨å¢å¼º](#8-PKCEå®‰å…¨å¢å¼º)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ OpenID Connectæ˜¯ä»€ä¹ˆ


### 1.1 å…ˆç†è§£ä¸€ä¸ªç”Ÿæ´»åœºæ™¯


**ä¼ ç»Ÿç™»å½•çš„éº»çƒ¦**ï¼š
```
åœºæ™¯ï¼šä½ è¦ä½¿ç”¨10ä¸ªä¸åŒçš„ç½‘ç«™
é—®é¢˜ï¼šéœ€è¦æ³¨å†Œ10ä¸ªè´¦å·ï¼Œè®°ä½10ä¸ªå¯†ç 
     - è´­ç‰©ç½‘ç«™ä¸€ä¸ªè´¦å·
     - éŸ³ä¹ç½‘ç«™ä¸€ä¸ªè´¦å·
     - è§†é¢‘ç½‘ç«™ä¸€ä¸ªè´¦å·
     - ç¤¾äº¤ç½‘ç«™ä¸€ä¸ªè´¦å·
     ...å¤ªéº»çƒ¦äº†ï¼
```

**OpenID Connectçš„è§£å†³æ–¹æ¡ˆ**ï¼š
```
ç°å®ç±»æ¯”ï¼šå°±åƒç”¨èº«ä»½è¯åŠå„ç§äº‹

ä½ çš„å¾®ä¿¡/Googleè´¦å· = ä½ çš„"æ•°å­—èº«ä»½è¯"
                    â†“
     å¯ä»¥å‡­è¿™ä¸ª"èº«ä»½è¯"ç™»å½•å„ç§ç½‘ç«™
                    â†“
ä¸ç”¨è®°é‚£ä¹ˆå¤šè´¦å·å¯†ç ï¼Œä¸€ä¸ªè´¦å·èµ°å¤©ä¸‹ï¼
```

### 1.2 ä¸“ä¸šå®šä¹‰ï¼ˆçœ‹æ‡‚äº†ä¸Šé¢å†çœ‹è¿™ä¸ªï¼‰


**ğŸ“– OpenID Connect (OIDC)**ï¼š
- **æœ¬è´¨**ï¼šåœ¨OAuth 2.0åŸºç¡€ä¸Šå¢åŠ äº†**èº«ä»½è®¤è¯**åŠŸèƒ½çš„åè®®
- **ä½œç”¨**ï¼šè®©ç”¨æˆ·ç”¨ä¸€ä¸ªè´¦å·ç™»å½•å¤šä¸ªç½‘ç«™/åº”ç”¨
- **å…³ç³»**ï¼šOAuth 2.0ç®¡æˆæƒï¼ˆç»™ä¸ç»™æƒé™ï¼‰ï¼ŒOIDCç®¡è®¤è¯ï¼ˆä½ æ˜¯è°ï¼‰

```
å…³ç³»ç†è§£ï¼š
OAuth 2.0ï¼šè§£å†³"æˆæƒ"é—®é¢˜
   â†“ åŠ ä¸Šèº«ä»½ä¿¡æ¯
OpenID Connectï¼šè§£å†³"è®¤è¯+æˆæƒ"é—®é¢˜

æ¯”å–»ï¼š
OAuth 2.0 = é—¨ç¦å¡ï¼ˆåªç®¡èƒ½ä¸èƒ½è¿›é—¨ï¼‰
OIDC = å·¥ä½œè¯ï¼ˆæ—¢èƒ½è¿›é—¨ï¼Œè¿˜çŸ¥é“ä½ æ˜¯è°ï¼‰
```

### 1.3 ä¸ºä»€ä¹ˆéœ€è¦OIDC


| å¯¹æ¯”é¡¹ | **çº¯OAuth 2.0** | **OpenID Connect** |
|--------|----------------|-------------------|
| **ä¸»è¦ç›®çš„** | æˆæƒï¼ˆè®¿é—®èµ„æºï¼‰ | è®¤è¯ï¼ˆç¡®è®¤èº«ä»½ï¼‰+ æˆæƒ |
| **èƒ½çŸ¥é“ç”¨æˆ·æ˜¯è°å—** | âŒ ä¸èƒ½ç›´æ¥çŸ¥é“ | âœ… å¯ä»¥è·å–ç”¨æˆ·ä¿¡æ¯ |
| **ä½¿ç”¨åœºæ™¯** | ç¬¬ä¸‰æ–¹è®¿é—®ä½ çš„èµ„æº | ç¬¬ä¸‰æ–¹ç™»å½•ã€å•ç‚¹ç™»å½• |
| **è·å¾—ä»€ä¹ˆ** | Access Tokenï¼ˆè®¿é—®ä»¤ç‰Œï¼‰ | ID Token + Access Token |
| **å…¸å‹åº”ç”¨** | æˆæƒè®¿é—®ç›¸å†Œ | ä½¿ç”¨å¾®ä¿¡/Googleç™»å½• |

---

## 2. ğŸ”‘ æ ¸å¿ƒæ¦‚å¿µç†è§£


### 2.1 OIDCçš„ä¸‰ä¸ªæ ¸å¿ƒè§’è‰²


```
ç™»å½•æµç¨‹ä¸­çš„è§’è‰²ï¼š

ğŸ‘¤ æœ€ç»ˆç”¨æˆ·(End User)
    â†“ æˆ‘è¦ç™»å½•
    
ğŸ–¥ï¸ å®¢æˆ·ç«¯åº”ç”¨(Client/RP)
    â†“ å¸®ä½ å»è®¤è¯
    
ğŸ¢ è®¤è¯æœåŠ¡å™¨(OpenID Provider/OP)
    â†“ éªŒè¯èº«ä»½å¹¶è¿”å›ä¿¡æ¯
```

**é€šä¿—ç†è§£**ï¼š
```
ç°å®åœºæ™¯ï¼šä½ å»é“¶è¡ŒåŠä¸šåŠ¡

ä½  = æœ€ç»ˆç”¨æˆ·
é“¶è¡ŒæŸœå° = å®¢æˆ·ç«¯åº”ç”¨  
èº«ä»½éªŒè¯ç³»ç»Ÿ = è®¤è¯æœåŠ¡å™¨

æµç¨‹ï¼š
1. ä½ å»æŸœå°åŠä¸šåŠ¡ï¼ˆè®¿é—®åº”ç”¨ï¼‰
2. æŸœå°è¦æ±‚éªŒè¯èº«ä»½ï¼ˆè·³è½¬åˆ°è®¤è¯ï¼‰
3. ä½ å‡ºç¤ºèº«ä»½è¯ï¼ˆè¾“å…¥è´¦å·å¯†ç ï¼‰
4. éªŒè¯ç³»ç»Ÿç¡®è®¤èº«ä»½ï¼ˆè®¤è¯æˆåŠŸï¼‰
5. æŸœå°è·å¾—ä½ çš„èº«ä»½ä¿¡æ¯ï¼ˆæ”¶åˆ°ID Tokenï¼‰
6. å¼€å§‹åŠç†ä¸šåŠ¡ï¼ˆç™»å½•æˆåŠŸï¼‰
```

### 2.2 OIDC vs OAuth 2.0 å…³é”®åŒºåˆ«


**ğŸ”¸ OAuth 2.0 çš„å±€é™**ï¼š
```java
// OAuth 2.0 åªèƒ½æ‹¿åˆ°è®¿é—®ä»¤ç‰Œ
String accessToken = "eyJhbGc...";

// ä½†è¿™ä¸ªä»¤ç‰Œä¸åŒ…å«ç”¨æˆ·ä¿¡æ¯ï¼
// åº”ç”¨ä¸çŸ¥é“ç™»å½•çš„æ˜¯è°
// åªçŸ¥é“"æœ‰æƒé™è®¿é—®æŸäº›èµ„æº"
```

**ğŸ”¸ OpenID Connect çš„å¢å¼º**ï¼š
```java
// OIDC åŒæ—¶ç»™ä½ ä¸¤ä¸ªä»¤ç‰Œ
String accessToken = "eyJhbGc...";  // è®¿é—®ä»¤ç‰Œï¼ˆå’ŒOAuthä¸€æ ·ï¼‰
String idToken = "eyJhbGc...";      // IDä»¤ç‰Œï¼ˆæ–°å¢ï¼åŒ…å«ç”¨æˆ·èº«ä»½ï¼‰

// ID Token åŒ…å«ç”¨æˆ·ä¿¡æ¯ï¼š
{
  "sub": "user123",           // ç”¨æˆ·å”¯ä¸€æ ‡è¯†
  "name": "å¼ ä¸‰",             // ç”¨æˆ·å§“å
  "email": "zhangsan@qq.com", // é‚®ç®±
  "picture": "http://..."     // å¤´åƒ
}
```

### 2.3 OIDCçš„ä¸‰ç§è®¤è¯æµç¨‹


| æµç¨‹ç±»å‹ | **é€‚ç”¨åœºæ™¯** | **å®‰å…¨æ€§** | **å¤æ‚åº¦** |
|---------|------------|----------|----------|
| **æˆæƒç æµç¨‹** | ä¼ ç»ŸWebåº”ç”¨ | â­â­â­ æœ€é«˜ | ä¸­ç­‰ |
| **éšå¼æµç¨‹** | çº¯å‰ç«¯SPAåº”ç”¨ | â­â­ è¾ƒä½ï¼ˆå·²ä¸æ¨èï¼‰ | ç®€å• |
| **æ··åˆæµç¨‹** | éœ€è¦ç«‹å³è·å–ID Tokençš„åœºæ™¯ | â­â­â­ é«˜ | å¤æ‚ |

**ğŸ’¡ æ–°æ‰‹å»ºè®®**ï¼š
- åç«¯åº”ç”¨ï¼šä¼˜å…ˆç”¨**æˆæƒç æµç¨‹**ï¼ˆæœ€å®‰å…¨ï¼‰
- å‰ç«¯åº”ç”¨ï¼šç”¨**æˆæƒç æµç¨‹ + PKCE**ï¼ˆå®‰å…¨å¢å¼ºç‰ˆï¼‰
- é¿å…ä½¿ç”¨éšå¼æµç¨‹ï¼ˆå·²è¿‡æ—¶ï¼‰

---

## 3. ğŸ« ID Tokenè¯¦è§£


### 3.1 ID Tokenæ˜¯ä»€ä¹ˆ


**ç”Ÿæ´»ç±»æ¯”**ï¼š
```
ID Token = ç”µå­ç‰ˆçš„èº«ä»½è¯æ˜

æ™®é€šèº«ä»½è¯åŒ…å«ï¼š
- å§“å
- ç…§ç‰‡  
- èº«ä»½è¯å·
- æœ‰æ•ˆæœŸ

ID TokenåŒ…å«ï¼š
- ç”¨æˆ·å”¯ä¸€ID (sub)
- ç”¨æˆ·å (name)
- é‚®ç®± (email)
- ç­¾å‘è€… (iss)
- è¿‡æœŸæ—¶é—´ (exp)
```

### 3.2 ID Tokençš„ç»“æ„


**ğŸ“Š JWTæ ¼å¼ï¼ˆä¸‰éƒ¨åˆ†ç»„æˆï¼‰**ï¼š
```
ID Token = Header.Payload.Signature

ç¤ºä¾‹ï¼š
eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.    â† Headerï¼ˆå¤´éƒ¨ï¼‰
eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6...  â† Payloadï¼ˆè½½è·ï¼Œç”¨æˆ·ä¿¡æ¯ï¼‰
SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_a... â† Signatureï¼ˆç­¾åï¼‰
```

**è§£æåçš„å†…å®¹**ï¼š
```json
// Header - ä»¤ç‰Œç±»å‹å’ŒåŠ å¯†ç®—æ³•
{
  "alg": "RS256",    // ä½¿ç”¨RSA SHA-256åŠ å¯†
  "typ": "JWT"       // ç±»å‹æ˜¯JWT
}

// Payload - ç”¨æˆ·èº«ä»½ä¿¡æ¯ï¼ˆè¿™æ˜¯æ ¸å¿ƒï¼ï¼‰
{
  "iss": "https://accounts.google.com",  // ç­¾å‘è€…ï¼ˆè°å‘çš„ï¼‰
  "sub": "110169484474386276334",        // ç”¨æˆ·å”¯ä¸€ID
  "aud": "your-client-id",               // æ¥æ”¶è€…ï¼ˆç»™è°çš„ï¼‰
  "exp": 1516239022,                     // è¿‡æœŸæ—¶é—´ï¼ˆUnixæ—¶é—´æˆ³ï¼‰
  "iat": 1516235422,                     // ç­¾å‘æ—¶é—´
  "name": "å¼ ä¸‰",                        // ç”¨æˆ·å§“å
  "email": "zhangsan@example.com",       // é‚®ç®±
  "picture": "https://..."               // å¤´åƒURL
}

// Signature - é˜²æ­¢ç¯¡æ”¹çš„ç­¾å
```

### 3.3 ID Tokençš„å…³é”®å­—æ®µ


**ğŸ”¸ å¿…é¡»åŒ…å«çš„å­—æ®µï¼ˆæ ‡å‡†å£°æ˜ï¼‰**ï¼š

| å­—æ®µ | **å«ä¹‰** | **ä½œç”¨** | **ç¤ºä¾‹** |
|------|---------|---------|----------|
| `iss` | ç­¾å‘è€… | æ ‡è¯†ä»¤ç‰Œæ¥è‡ªå“ªä¸ªè®¤è¯æœåŠ¡å™¨ | `https://accounts.google.com` |
| `sub` | ä¸»é¢˜/ç”¨æˆ·ID | ç”¨æˆ·çš„å”¯ä¸€æ ‡è¯†ç¬¦ | `110169484474386276334` |
| `aud` | æ¥æ”¶è€… | è¯´æ˜è¿™ä¸ªä»¤ç‰Œæ˜¯ç»™è°ç”¨çš„ | `your-app-client-id` |
| `exp` | è¿‡æœŸæ—¶é—´ | ä»¤ç‰Œä»€ä¹ˆæ—¶å€™å¤±æ•ˆ | `1516239022` |
| `iat` | ç­¾å‘æ—¶é—´ | ä»¤ç‰Œä»€ä¹ˆæ—¶å€™åˆ›å»ºçš„ | `1516235422` |

**ğŸ”¸ å¯é€‰çš„ç”¨æˆ·ä¿¡æ¯å­—æ®µ**ï¼š
- `name`: å…¨å
- `given_name`: åå­—
- `family_name`: å§“æ°
- `email`: é‚®ç®±
- `email_verified`: é‚®ç®±æ˜¯å¦éªŒè¯
- `picture`: å¤´åƒURL
- `locale`: è¯­è¨€åå¥½

### 3.4 å¦‚ä½•éªŒè¯ID Token


**éªŒè¯æ­¥éª¤ï¼ˆå¿…é¡»å…¨éƒ¨é€šè¿‡ï¼‰**ï¼š
```
æ­¥éª¤1ï¼šéªŒè¯ç­¾å â†’ ç¡®ä¿ä»¤ç‰Œæœªè¢«ç¯¡æ”¹
   â†“
æ­¥éª¤2ï¼šæ£€æŸ¥ç­¾å‘è€…(iss) â†’ ç¡®è®¤æ¥æºå¯ä¿¡
   â†“
æ­¥éª¤3ï¼šæ£€æŸ¥æ¥æ”¶è€…(aud) â†’ ç¡®è®¤æ˜¯å‘ç»™è‡ªå·±çš„
   â†“
æ­¥éª¤4ï¼šæ£€æŸ¥è¿‡æœŸæ—¶é—´(exp) â†’ ç¡®è®¤æœªè¿‡æœŸ
   â†“
æ­¥éª¤5ï¼šæå–ç”¨æˆ·ä¿¡æ¯ â†’ è·å–ç”¨æˆ·èº«ä»½
```

**Spring Securityè‡ªåŠ¨å¸®ä½ éªŒè¯**ï¼š
```java
// ä¸ç”¨æ‰‹åŠ¨éªŒè¯ï¼æ¡†æ¶ä¼šè‡ªåŠ¨å¤„ç†
// ä½ åªéœ€è¦è·å–éªŒè¯åçš„ç”¨æˆ·ä¿¡æ¯
@GetMapping("/user")
public String getUserInfo(@AuthenticationPrincipal OidcUser user) {
    // æ¡†æ¶å·²ç»éªŒè¯è¿‡ID Tokenäº†
    String userId = user.getSubject();        // ç”¨æˆ·ID
    String name = user.getFullName();         // å…¨å
    String email = user.getEmail();           // é‚®ç®±
    
    return "æ¬¢è¿ï¼Œ" + name;
}
```

---

## 4. ğŸ‘¤ UserInfoç«¯ç‚¹è·å–ç”¨æˆ·ä¿¡æ¯


### 4.1 ä¸ºä»€ä¹ˆéœ€è¦UserInfoç«¯ç‚¹


**ä¸¤ç§è·å–ç”¨æˆ·ä¿¡æ¯çš„æ–¹å¼**ï¼š

```
æ–¹å¼1ï¼šä»ID Tokenè·å–
ä¼˜ç‚¹ï¼šâœ… å¿«é€Ÿï¼Œä¸éœ€è¦é¢å¤–è¯·æ±‚
ç¼ºç‚¹ï¼šâŒ ä¿¡æ¯æœ‰é™ï¼Œæ”¾ä¸ä¸‹å¤ªå¤šå†…å®¹

æ–¹å¼2ï¼šè°ƒç”¨UserInfoç«¯ç‚¹
ä¼˜ç‚¹ï¼šâœ… ä¿¡æ¯å®Œæ•´ï¼Œå¯ä»¥è·å–æ›´å¤šè¯¦ç»†ä¿¡æ¯
ç¼ºç‚¹ï¼šâŒ éœ€è¦é¢å¤–çš„HTTPè¯·æ±‚
```

**ä»€ä¹ˆæ—¶å€™ç”¨UserInfoç«¯ç‚¹**ï¼š
- ID Tokenä¸­çš„ä¿¡æ¯ä¸å¤Ÿç”¨
- éœ€è¦å®æ—¶çš„æœ€æ–°ç”¨æˆ·ä¿¡æ¯
- éœ€è¦è·å–æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚æ‰‹æœºå·ï¼‰

### 4.2 UserInfoç«¯ç‚¹çš„å·¥ä½œæµç¨‹


```
å®¢æˆ·ç«¯åº”ç”¨                           è®¤è¯æœåŠ¡å™¨
    |                                    |
    |--[1]æºå¸¦Access Tokenè¯·æ±‚--------->|
    |   GET /userinfo                    |
    |   Authorization: Bearer xxx        |
    |                                    |
    |<--[2]è¿”å›ç”¨æˆ·è¯¦ç»†ä¿¡æ¯--------------|
    |   {                                |
    |     "sub": "user123",              |
    |     "name": "å¼ ä¸‰",                |
    |     "email": "xxx@qq.com",         |
    |     "phone": "138****1234",        |
    |     "address": {...}               |
    |   }                                |
```

**å…³é”®ç†è§£**ï¼š
- å¿…é¡»ç”¨**Access Token**ï¼ˆä¸æ˜¯ID Tokenï¼‰
- è¿”å›çš„ä¿¡æ¯æ¯”ID Tokenæ›´è¯¦ç»†
- å¯ä»¥å¤šæ¬¡è°ƒç”¨è·å–æœ€æ–°ä¿¡æ¯

### 4.3 Spring Securityä¸­è·å–UserInfo


**é…ç½®è‡ªåŠ¨è·å–**ï¼š
```yaml
spring:
  security:
    oauth2:
      client:
        registration:
          google:
            client-id: your-client-id
            client-secret: your-client-secret
            scope:
              - openid      # å¿…é¡»ï¼Œå¯ç”¨OIDC
              - profile     # è·å–åŸºæœ¬ä¿¡æ¯
              - email       # è·å–é‚®ç®±
        provider:
          google:
            # UserInfoç«¯ç‚¹åœ°å€ï¼ˆæ¡†æ¶è‡ªåŠ¨å‘ç°ï¼‰
            user-info-uri: https://openidconnect.googleapis.com/v1/userinfo
            user-name-attribute: sub  # ç”¨æˆ·æ ‡è¯†å­—æ®µ
```

**ä½¿ç”¨UserInfoæ•°æ®**ï¼š
```java
@Controller
public class UserController {
    
    @GetMapping("/profile")
    public String userProfile(@AuthenticationPrincipal OidcUser oidcUser, 
                              Model model) {
        // ä»ID Tokenè·å–åŸºæœ¬ä¿¡æ¯
        String userId = oidcUser.getSubject();
        String name = oidcUser.getFullName();
        
        // ä»UserInfoç«¯ç‚¹è·å–çš„é¢å¤–ä¿¡æ¯
        Map<String, Object> attributes = oidcUser.getAttributes();
        String phone = (String) attributes.get("phone_number");
        String address = (String) attributes.get("address");
        
        model.addAttribute("name", name);
        model.addAttribute("phone", phone);
        model.addAttribute("address", address);
        
        return "profile";
    }
}
```

### 4.4 æ‰‹åŠ¨è°ƒç”¨UserInfoç«¯ç‚¹


**åœºæ™¯**ï¼šéœ€è¦å®æ—¶åˆ·æ–°ç”¨æˆ·ä¿¡æ¯
```java
@Service
public class UserInfoService {
    
    @Autowired
    private OAuth2AuthorizedClientService clientService;
    
    public Map<String, Object> fetchUserInfo(String username) {
        // è·å–Access Token
        OAuth2AuthorizedClient client = clientService
            .loadAuthorizedClient("google", username);
        
        String accessToken = client.getAccessToken().getTokenValue();
        
        // æ‰‹åŠ¨è°ƒç”¨UserInfoç«¯ç‚¹
        RestTemplate restTemplate = new RestTemplate();
        HttpHeaders headers = new HttpHeaders();
        headers.setBearerAuth(accessToken);
        
        HttpEntity<String> entity = new HttpEntity<>(headers);
        
        ResponseEntity<Map> response = restTemplate.exchange(
            "https://openidconnect.googleapis.com/v1/userinfo",
            HttpMethod.GET,
            entity,
            Map.class
        );
        
        return response.getBody();
    }
}
```

---

## 5. âš™ï¸ Spring Securityä¸­çš„OIDCé…ç½®


### 5.1 åŸºç¡€é…ç½®ï¼ˆä»¥Googleä¸ºä¾‹ï¼‰


**ç¬¬ä¸€æ­¥ï¼šå¼•å…¥ä¾èµ–**
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-oauth2-client</artifactId>
</dependency>
```

**ç¬¬äºŒæ­¥ï¼šé…ç½®è®¤è¯æä¾›å•†**
```yaml
spring:
  security:
    oauth2:
      client:
        registration:
          google:  # æä¾›å•†åç§°ï¼ˆå¯è‡ªå®šä¹‰ï¼‰
            client-id: ${GOOGLE_CLIENT_ID}
            client-secret: ${GOOGLE_CLIENT_SECRET}
            scope:
              - openid       # å¿…é¡»ï¼å¯ç”¨OIDC
              - profile      # è·å–ç”¨æˆ·èµ„æ–™
              - email        # è·å–é‚®ç®±
            redirect-uri: "{baseUrl}/login/oauth2/code/{registrationId}"
            
        provider:
          google:
            issuer-uri: https://accounts.google.com
            # æ¡†æ¶ä¼šè‡ªåŠ¨å‘ç°ä»¥ä¸‹ç«¯ç‚¹ï¼š
            # - authorization-uriï¼ˆæˆæƒç«¯ç‚¹ï¼‰
            # - token-uriï¼ˆä»¤ç‰Œç«¯ç‚¹ï¼‰
            # - user-info-uriï¼ˆç”¨æˆ·ä¿¡æ¯ç«¯ç‚¹ï¼‰
            # - jwk-set-uriï¼ˆå…¬é’¥ç«¯ç‚¹ï¼‰
```

**é…ç½®è§£é‡Š**ï¼š
```
å…³é”®é…ç½®é¡¹è¯´æ˜ï¼š

scope: openid
  â†“
å‘Šè¯‰è®¤è¯æœåŠ¡å™¨ï¼šæˆ‘è¦ç”¨OIDCåè®®
ï¼ˆå¦‚æœæ²¡æœ‰è¿™ä¸ªï¼Œå°±åªæ˜¯æ™®é€šOAuth 2.0ï¼‰

issuer-uri
  â†“
è®¤è¯æœåŠ¡å™¨çš„æ ¹åœ°å€
æ¡†æ¶ä¼šè‡ªåŠ¨å‘ç°æ‰€æœ‰éœ€è¦çš„ç«¯ç‚¹

redirect-uri
  â†“
ç™»å½•æˆåŠŸåè·³è½¬å›æ¥çš„åœ°å€
{registrationId}ä¼šè‡ªåŠ¨æ›¿æ¢ä¸ºgoogle
```

### 5.2 Securityé…ç½®ç±»


```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            // é…ç½®è¯·æ±‚æˆæƒ
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/", "/login/**").permitAll()  // å…¬å¼€é¡µé¢
                .anyRequest().authenticated()                    // å…¶ä»–éœ€è¦ç™»å½•
            )
            // é…ç½®OAuth2ç™»å½•
            .oauth2Login(oauth2 -> oauth2
                .loginPage("/login")              // è‡ªå®šä¹‰ç™»å½•é¡µ
                .defaultSuccessUrl("/home", true) // ç™»å½•æˆåŠŸè·³è½¬
                .failureUrl("/login?error=true")  // ç™»å½•å¤±è´¥è·³è½¬
            )
            // é…ç½®ç™»å‡º
            .logout(logout -> logout
                .logoutSuccessUrl("/")
                .invalidateHttpSession(true)
                .clearAuthentication(true)
                // OIDCç™»å‡ºï¼ˆåŒæ—¶ç™»å‡ºè®¤è¯æœåŠ¡å™¨ï¼‰
                .addLogoutHandler(oidcLogoutSuccessHandler())
            );

        return http.build();
    }
    
    // OIDCç™»å‡ºå¤„ç†å™¨
    @Bean
    public OidcClientInitiatedLogoutSuccessHandler oidcLogoutSuccessHandler() {
        OidcClientInitiatedLogoutSuccessHandler handler = 
            new OidcClientInitiatedLogoutSuccessHandler(clientRegistrationRepository);
        handler.setPostLogoutRedirectUri("{baseUrl}");
        return handler;
    }
}
```

### 5.3 å¤šä¸ªOIDCæä¾›å•†é…ç½®


**æ”¯æŒå¤šç§ç™»å½•æ–¹å¼**ï¼š
```yaml
spring:
  security:
    oauth2:
      client:
        registration:
          # Googleç™»å½•
          google:
            client-id: ${GOOGLE_CLIENT_ID}
            client-secret: ${GOOGLE_CLIENT_SECRET}
            scope: openid, profile, email
            
          # GitHubç™»å½•  
          github:
            client-id: ${GITHUB_CLIENT_ID}
            client-secret: ${GITHUB_CLIENT_SECRET}
            scope: openid, user:email
            
          # è‡ªå»ºè®¤è¯æœåŠ¡å™¨
          custom-oidc:
            client-id: my-app
            client-secret: my-secret
            scope: openid, profile, email
            authorization-grant-type: authorization_code
            redirect-uri: "{baseUrl}/login/oauth2/code/custom"
            
        provider:
          google:
            issuer-uri: https://accounts.google.com
            
          github:
            issuer-uri: https://github.com
            
          custom-oidc:
            issuer-uri: https://my-auth-server.com
```

**ç™»å½•é¡µé¢å±•ç¤ºå¤šä¸ªé€‰é¡¹**ï¼š
```html
<!-- login.html -->
<div class="login-options">
    <h2>é€‰æ‹©ç™»å½•æ–¹å¼</h2>
    
    <!-- Googleç™»å½• -->
    <a href="/oauth2/authorization/google" class="btn btn-google">
        <img src="/images/google-icon.png"> ä½¿ç”¨Googleç™»å½•
    </a>
    
    <!-- GitHubç™»å½• -->
    <a href="/oauth2/authorization/github" class="btn btn-github">
        <img src="/images/github-icon.png"> ä½¿ç”¨GitHubç™»å½•
    </a>
    
    <!-- è‡ªå»ºç™»å½• -->
    <a href="/oauth2/authorization/custom-oidc" class="btn btn-custom">
        ä½¿ç”¨ä¼ä¸šè´¦å·ç™»å½•
    </a>
</div>
```

---

## 6. ğŸ” å®ç°å•ç‚¹ç™»å½•(SSO)


### 6.1 ä»€ä¹ˆæ˜¯å•ç‚¹ç™»å½•


**ç”Ÿæ´»åœºæ™¯ç†è§£**ï¼š
```
ä¼ ç»Ÿæ–¹å¼ï¼ˆæ²¡æœ‰SSOï¼‰ï¼š
å…¬å¸å†…éƒ¨æœ‰5ä¸ªç³»ç»Ÿï¼Œéœ€è¦ç™»å½•5æ¬¡
- é‚®ä»¶ç³»ç»Ÿï¼šç™»å½•ä¸€æ¬¡
- OAç³»ç»Ÿï¼šç™»å½•ä¸€æ¬¡
- HRç³»ç»Ÿï¼šç™»å½•ä¸€æ¬¡  
- è´¢åŠ¡ç³»ç»Ÿï¼šç™»å½•ä¸€æ¬¡
- æ–‡æ¡£ç³»ç»Ÿï¼šç™»å½•ä¸€æ¬¡
å¤ªéº»çƒ¦äº†ï¼

å•ç‚¹ç™»å½•ï¼ˆSSOï¼‰ï¼š
ç™»å½•ä¸€æ¬¡ï¼Œè®¿é—®æ‰€æœ‰ç³»ç»Ÿ
- æ—©ä¸Šç™»å½•é‚®ä»¶ç³»ç»Ÿ
- æ‰“å¼€OAç³»ç»Ÿï¼šè‡ªåŠ¨ç™»å½•
- æ‰“å¼€HRç³»ç»Ÿï¼šè‡ªåŠ¨ç™»å½•
- ...æ‰€æœ‰ç³»ç»Ÿéƒ½ä¸ç”¨å†ç™»å½•
```

**æŠ€æœ¯åŸç†**ï¼š
```
æ ¸å¿ƒæ€æƒ³ï¼šå¤šä¸ªåº”ç”¨å…±äº«åŒä¸€ä¸ªè®¤è¯æœåŠ¡å™¨

         è®¤è¯æœåŠ¡å™¨(OP)
         /      |      \
        /       |       \
   åº”ç”¨A      åº”ç”¨B     åº”ç”¨C
   
æµç¨‹ï¼š
1. ç”¨æˆ·è®¿é—®åº”ç”¨A â†’ è·³è½¬åˆ°è®¤è¯æœåŠ¡å™¨ç™»å½•
2. ç™»å½•æˆåŠŸ â†’ è®¤è¯æœåŠ¡å™¨è®°ä½ç”¨æˆ·å·²ç™»å½•
3. ç”¨æˆ·è®¿é—®åº”ç”¨B â†’ è®¤è¯æœåŠ¡å™¨å‘ç°å·²ç™»å½• â†’ ç›´æ¥æ”¾è¡Œ
4. ç”¨æˆ·è®¿é—®åº”ç”¨C â†’ åŒæ ·ç›´æ¥æ”¾è¡Œ
```

### 6.2 SSOé…ç½®ç¤ºä¾‹


**åº”ç”¨Aé…ç½®**ï¼ˆCRMç³»ç»Ÿï¼‰ï¼š
```yaml
spring:
  application:
    name: crm-system
  security:
    oauth2:
      client:
        registration:
          sso:
            client-id: crm-client
            client-secret: crm-secret
            scope: openid, profile, email
            authorization-grant-type: authorization_code
            redirect-uri: "http://crm.company.com/login/oauth2/code/sso"
        provider:
          sso:
            issuer-uri: https://sso.company.com  # ç»Ÿä¸€è®¤è¯æœåŠ¡å™¨
```

**åº”ç”¨Bé…ç½®**ï¼ˆOAç³»ç»Ÿï¼‰ï¼š
```yaml
spring:
  application:
    name: oa-system
  security:
    oauth2:
      client:
        registration:
          sso:
            client-id: oa-client
            client-secret: oa-secret
            scope: openid, profile, email
            authorization-grant-type: authorization_code
            redirect-uri: "http://oa.company.com/login/oauth2/code/sso"
        provider:
          sso:
            issuer-uri: https://sso.company.com  # ç›¸åŒçš„è®¤è¯æœåŠ¡å™¨ï¼
```

**å…³é”®ç‚¹**ï¼š
- âœ… å¤šä¸ªåº”ç”¨ä½¿ç”¨**åŒä¸€ä¸ªè®¤è¯æœåŠ¡å™¨**
- âœ… æ¯ä¸ªåº”ç”¨æœ‰**ç‹¬ç«‹çš„client-id**
- âœ… Scopeç›¸åŒæˆ–ç›¸ä¼¼
- âœ… è®¤è¯æœåŠ¡å™¨ç»´æŠ¤**å…±äº«çš„Session**

### 6.3 SSOå®Œæ•´æµç¨‹æ¼”ç¤º


```
ç”¨æˆ·æ“ä½œæµç¨‹ï¼š

1ï¸âƒ£ é¦–æ¬¡è®¿é—®CRMç³»ç»Ÿ
ç”¨æˆ· â†’ CRMåº”ç”¨ â†’ è®¤è¯æœåŠ¡å™¨ç™»å½•é¡µ
        â†“
   è¾“å…¥è´¦å·å¯†ç 
        â†“
   è®¤è¯æˆåŠŸï¼Œåˆ›å»ºSession
        â†“
   è¿”å›CRMï¼Œç™»å½•æˆåŠŸ

2ï¸âƒ£ è®¿é—®OAç³»ç»Ÿï¼ˆç¥å¥‡çš„åœ°æ–¹ï¼‰
ç”¨æˆ· â†’ OAåº”ç”¨ â†’ è®¤è¯æœåŠ¡å™¨
        â†“
   æ£€æµ‹åˆ°å·²ç™»å½•Session
        â†“
   ç›´æ¥è¿”å›ä»¤ç‰Œï¼Œæ— éœ€å†ç™»å½•
        â†“
   OAç³»ç»Ÿè‡ªåŠ¨ç™»å½•æˆåŠŸ

3ï¸âƒ£ è®¿é—®HRç³»ç»Ÿ
ç”¨æˆ· â†’ HRåº”ç”¨ â†’ è®¤è¯æœåŠ¡å™¨
        â†“
   ä»ç„¶æ£€æµ‹åˆ°Session
        â†“
   ç›´æ¥ç™»å½•æˆåŠŸ
```

**æŠ€æœ¯å®ç°ç»†èŠ‚**ï¼š
```java
// è®¤è¯æœåŠ¡å™¨ç«¯ï¼ˆç®€åŒ–ç¤ºä¾‹ï¼‰
@Controller
public class SSOAuthController {
    
    @GetMapping("/authorize")
    public String authorize(HttpSession session,
                           @RequestParam String client_id,
                           @RequestParam String redirect_uri) {
        
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
        User user = (User) session.getAttribute("user");
        
        if (user == null) {
            // æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
            return "redirect:/login?client_id=" + client_id;
        }
        
        // å·²ç™»å½•ï¼Œç›´æ¥è¿”å›æˆæƒç 
        String code = generateAuthCode(user, client_id);
        return "redirect:" + redirect_uri + "?code=" + code;
    }
}
```

### 6.4 å•ç‚¹ç™»å‡º(Single Logout)


**å®Œæ•´ç™»å‡ºæµç¨‹**ï¼š
```java
@Configuration
public class SSOLogoutConfig {
    
    @Bean
    public LogoutSuccessHandler ssoLogoutHandler(
            ClientRegistrationRepository repository) {
        
        OidcClientInitiatedLogoutSuccessHandler handler = 
            new OidcClientInitiatedLogoutSuccessHandler(repository);
        
        // ç™»å‡ºåé‡å®šå‘åœ°å€
        handler.setPostLogoutRedirectUri("{baseUrl}");
        
        return handler;
    }
}
```

**ç™»å‡ºæŒ‰é’®**ï¼š
```html
<!-- ç™»å‡ºé“¾æ¥ -->
<form method="post" action="/logout">
    <input type="hidden" name="${_csrf.parameterName}" value="${_csrf.token}"/>
    <button type="submit">é€€å‡ºç™»å½•</button>
</form>
```

**ç™»å‡ºæ•ˆæœ**ï¼š
- åº”ç”¨æœ¬åœ°Sessionæ¸…é™¤
- è®¤è¯æœåŠ¡å™¨Sessionæ¸…é™¤
- æ‰€æœ‰SSOåº”ç”¨éƒ½ä¼šç™»å‡º

---

## 7. ğŸŒ è”åˆèº«ä»½è®¤è¯å®è·µ


### 7.1 ä»€ä¹ˆæ˜¯è”åˆèº«ä»½è®¤è¯


**æ¦‚å¿µç†è§£**ï¼š
```
è”åˆèº«ä»½ = è·¨ç»„ç»‡çš„èº«ä»½å…±äº«

åœºæ™¯ï¼š
- å…¬å¸Açš„å‘˜å·¥è¦è®¿é—®åˆä½œå…¬å¸Bçš„ç³»ç»Ÿ
- å¤§å­¦ç”Ÿç”¨å­¦æ ¡è´¦å·è®¿é—®å›¾ä¹¦é¦†ã€é€‰è¯¾ç³»ç»Ÿ
- æ”¿åºœéƒ¨é—¨é—´çš„ç³»ç»Ÿäº’è®¿

æ ¸å¿ƒï¼š
ä¸åŒç»„ç»‡çš„è®¤è¯ç³»ç»Ÿäº’ç›¸ä¿¡ä»»
ç”¨æˆ·åœ¨Aç™»å½•åï¼Œå¯ä»¥ç›´æ¥è®¿é—®B
```

**ä¸SSOçš„åŒºåˆ«**ï¼š
```
SSOï¼š
- åŒä¸€ç»„ç»‡å†…éƒ¨çš„å¤šä¸ªåº”ç”¨
- å…±äº«åŒä¸€ä¸ªè®¤è¯æœåŠ¡å™¨
- å®Œå…¨ä¿¡ä»»

è”åˆèº«ä»½ï¼š
- ä¸åŒç»„ç»‡é—´çš„åº”ç”¨
- å„è‡ªæœ‰ç‹¬ç«‹çš„è®¤è¯æœåŠ¡å™¨
- é€šè¿‡åè®®å»ºç«‹ä¿¡ä»»å…³ç³»
```

### 7.2 è”åˆèº«ä»½çš„ä¿¡ä»»é“¾


```
ç»„ç»‡A                              ç»„ç»‡B
     
è®¤è¯æœåŠ¡å™¨A                     è®¤è¯æœåŠ¡å™¨B
     â†“                              â†“
  ä¿¡ä»»å…³ç³»ï¼ˆé€šè¿‡OIDC/SAMLåè®®ï¼‰
     â†“                              â†“
ç»„ç»‡Açš„å‘˜å·¥ â†’ ç™»å½•A â†’ è‡ªåŠ¨åœ¨Bä¹Ÿèƒ½è®¿é—®
```

**é…ç½®ç¤ºä¾‹**ï¼š
```yaml
# ç»„ç»‡Bçš„åº”ç”¨é…ç½®
spring:
  security:
    oauth2:
      client:
        registration:
          partner-company:  # åˆä½œä¼™ä¼´å…¬å¸
            client-id: our-app-id
            client-secret: shared-secret
            scope: openid, profile, email
            authorization-grant-type: authorization_code
        provider:
          partner-company:
            # æŒ‡å‘åˆä½œä¼™ä¼´çš„è®¤è¯æœåŠ¡å™¨
            issuer-uri: https://auth.partner-company.com
```

### 7.3 å¤šç§Ÿæˆ·èº«ä»½è®¤è¯


**åœºæ™¯**ï¼šSaaSåº”ç”¨æ”¯æŒå¤šä¸ªä¼ä¸šå®¢æˆ·

```java
@Configuration
public class MultiTenantOIDCConfig {
    
    // åŠ¨æ€åŠ è½½ä¸åŒç§Ÿæˆ·çš„OIDCé…ç½®
    @Bean
    public ClientRegistrationRepository clientRegistrations(
            TenantService tenantService) {
        
        List<ClientRegistration> registrations = new ArrayList<>();
        
        // éå†æ‰€æœ‰ç§Ÿæˆ·
        for (Tenant tenant : tenantService.getAllTenants()) {
            ClientRegistration registration = ClientRegistration
                .withRegistrationId(tenant.getId())
                .clientId(tenant.getClientId())
                .clientSecret(tenant.getClientSecret())
                .scope("openid", "profile", "email")
                .authorizationUri(tenant.getAuthUri())
                .tokenUri(tenant.getTokenUri())
                .userInfoUri(tenant.getUserInfoUri())
                .redirectUri("{baseUrl}/login/oauth2/code/" + tenant.getId())
                .build();
                
            registrations.add(registration);
        }
        
        return new InMemoryClientRegistrationRepository(registrations);
    }
}
```

**ç§Ÿæˆ·é€‰æ‹©é¡µé¢**ï¼š
```java
@Controller
public class TenantLoginController {
    
    @GetMapping("/login")
    public String selectTenant(Model model) {
        List<Tenant> tenants = tenantService.getAllTenants();
        model.addAttribute("tenants", tenants);
        return "tenant-select";
    }
}
```

```html
<!-- tenant-select.html -->
<div class="tenant-selection">
    <h2>é€‰æ‹©æ‚¨çš„ç»„ç»‡</h2>
    
    <div th:each="tenant : ${tenants}">
        <a th:href="@{'/oauth2/authorization/' + ${tenant.id}}" 
           class="tenant-card">
            <img th:src="${tenant.logo}" />
            <h3 th:text="${tenant.name}">å…¬å¸åç§°</h3>
        </a>
    </div>
</div>
```

---

## 8. ğŸ”’ PKCEå®‰å…¨å¢å¼º


### 8.1 ä¸ºä»€ä¹ˆéœ€è¦PKCE


**ä¼ ç»Ÿæˆæƒç æµç¨‹çš„å®‰å…¨é—®é¢˜**ï¼š
```
åœºæ™¯ï¼šç§»åŠ¨Appæˆ–å•é¡µåº”ç”¨

é—®é¢˜ï¼š
1. æ— æ³•å®‰å…¨å­˜å‚¨Client Secret
   - ç§»åŠ¨Appå¯ä»¥è¢«åç¼–è¯‘
   - æµè§ˆå™¨JSä»£ç å¯ä»¥è¢«æŸ¥çœ‹
   - Secretä¼šè¢«æ³„éœ²

2. æˆæƒç å¯èƒ½è¢«æ‹¦æˆª
   - é€šè¿‡URLä¼ é€’æˆæƒç 
   - å¯èƒ½è¢«æ¶æ„åº”ç”¨æˆªè·
```

**PKCEçš„è§£å†³æ–¹æ¡ˆ**ï¼š
```
æ ¸å¿ƒæ€æƒ³ï¼šç”¨åŠ¨æ€ç”Ÿæˆçš„ä¸´æ—¶å¯†é’¥ä»£æ›¿å›ºå®šçš„Secret

ä¼ ç»Ÿæ–¹å¼ï¼š
Client Secretæ˜¯å›ºå®šçš„ï¼Œå®¹æ˜“æ³„éœ²

PKCEæ–¹å¼ï¼š
æ¯æ¬¡ç™»å½•ç”Ÿæˆæ–°çš„Code Verifierå’ŒCode Challenge
å³ä½¿è¢«æ‹¦æˆªä¹Ÿæ— æ³•é‡ç”¨
```

### 8.2 PKCEå·¥ä½œåŸç†


**å®Œæ•´æµç¨‹å›¾è§£**ï¼š
```
å®¢æˆ·ç«¯                           è®¤è¯æœåŠ¡å™¨
   |                                 |
   |--[1]ç”ŸæˆCode Verifier-----------|
   |    éšæœºå­—ç¬¦ä¸²ï¼Œå¦‚ï¼š              |
   |    dBjftJeZ4CVP-mB92K27uhbUJU1p1r |
   |                                 |
   |--[2]è®¡ç®—Code Challenge----------|
   |    SHA256(Code Verifier)çš„Base64 |
   |    = E9Melhoa2OwvFr...          |
   |                                 |
   |--[3]å‘é€æˆæƒè¯·æ±‚--------------->|
   |    å¸¦ä¸ŠCode Challenge           |
   |    code_challenge=E9Mel...      |
   |    code_challenge_method=S256   |
   |                                 |
   |<--[4]è¿”å›æˆæƒç -----------------|
   |    code=abc123                  |
   |                                 |
   |--[5]æ¢å–ä»¤ç‰Œ------------------->|
   |    å¸¦ä¸ŠåŸå§‹Code Verifier        |
   |    code=abc123                  |
   |    code_verifier=dBjft...       |
   |                                 |
   |    éªŒè¯ï¼šSHA256(code_verifier)  |
   |          = code_challenge?      |
   |                                 |
   |<--[6]è¿”å›ä»¤ç‰Œ-------------------|
   |    éªŒè¯é€šè¿‡ï¼Œè¿”å›Token          |
```

**å…³é”®ç†è§£**ï¼š
```
Code Verifierï¼ˆä»£ç éªŒè¯å™¨ï¼‰ï¼š
- éšæœºç”Ÿæˆçš„é•¿å­—ç¬¦ä¸²ï¼ˆ43-128å­—ç¬¦ï¼‰
- åªæœ‰å®¢æˆ·ç«¯çŸ¥é“
- ç›¸å½“äºä¸€æ¬¡æ€§å¯†ç 

Code Challengeï¼ˆä»£ç æŒ‘æˆ˜ï¼‰ï¼š
- å¯¹Code VerifieråšSHA256å“ˆå¸Œ
- å‘é€ç»™è®¤è¯æœåŠ¡å™¨
- è®¤è¯æœåŠ¡å™¨ä¿å­˜èµ·æ¥

éªŒè¯è¿‡ç¨‹ï¼š
- å®¢æˆ·ç«¯æ¢Tokenæ—¶æä¾›åŸå§‹Code Verifier
- æœåŠ¡å™¨è®¡ç®—å…¶SHA256
- ä¸ä¹‹å‰çš„Code Challengeå¯¹æ¯”
- åŒ¹é…æ‰ç»™Token
```

### 8.3 Spring Securityä¸­å¯ç”¨PKCE


**è‡ªåŠ¨å¯ç”¨ï¼ˆæ¨èï¼‰**ï¼š
```java
@Configuration
@EnableWebSecurity
public class PKCESecurityConfig {

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .oauth2Login(oauth2 -> oauth2
                // Spring Security è‡ªåŠ¨ä¸ºå…¬å…±å®¢æˆ·ç«¯å¯ç”¨PKCE
                .authorizationEndpoint(authorization -> authorization
                    .authorizationRequestResolver(
                        pkceAuthorizationRequestResolver()
                    )
                )
            );
        return http.build();
    }
    
    private OAuth2AuthorizationRequestResolver pkceAuthorizationRequestResolver() {
        DefaultOAuth2AuthorizationRequestResolver resolver = 
            new DefaultOAuth2AuthorizationRequestResolver(
                clientRegistrationRepository,
                "/oauth2/authorization"
            );
        
        // è‡ªå®šä¹‰è¯·æ±‚ï¼Œç¡®ä¿æ·»åŠ PKCEå‚æ•°
        resolver.setAuthorizationRequestCustomizer(customizer -> {
            customizer
                .additionalParameters(params -> {
                    // æ¡†æ¶ä¼šè‡ªåŠ¨ç”Ÿæˆå¹¶æ·»åŠ PKCEå‚æ•°
                })
                .build();
        });
        
        return resolver;
    }
}
```

**é…ç½®PKCEæ–¹æ³•**ï¼š
```yaml
spring:
  security:
    oauth2:
      client:
        registration:
          mobile-app:
            client-id: mobile-client
            # å…¬å…±å®¢æˆ·ç«¯ä¸è®¾ç½®secret
            # client-secret: (ç•™ç©º)
            scope: openid, profile
            authorization-grant-type: authorization_code
            # PKCEä¼šè‡ªåŠ¨å¯ç”¨
            
        provider:
          mobile-app:
            issuer-uri: https://auth-server.com
```

### 8.4 PKCEæœ€ä½³å®è·µ


**ğŸ”¸ é€‚ç”¨åœºæ™¯**ï¼š
```
âœ… å¿…é¡»ä½¿ç”¨PKCEçš„åœºæ™¯ï¼š
- ç§»åŠ¨åº”ç”¨ï¼ˆiOS/Androidï¼‰
- å•é¡µåº”ç”¨ï¼ˆVue/React/Angularï¼‰
- æ¡Œé¢åº”ç”¨
- ä»»ä½•æ— æ³•å®‰å…¨å­˜å‚¨Secretçš„å®¢æˆ·ç«¯

âš ï¸ å¯é€‰ä½¿ç”¨PKCEçš„åœºæ™¯ï¼š
- ä¼ ç»ŸæœåŠ¡ç«¯Webåº”ç”¨
- æœ‰å®‰å…¨å­˜å‚¨æœºåˆ¶çš„åç«¯æœåŠ¡
```

**ğŸ”¸ å®‰å…¨å»ºè®®**ï¼š
```java
// 1. ä½¿ç”¨è¶³å¤Ÿé•¿çš„Code Verifier
String codeVerifier = generateRandomString(64); // è‡³å°‘43å­—ç¬¦

// 2. ä½¿ç”¨S256æ–¹æ³•ï¼ˆè€Œéplainï¼‰
String codeChallenge = Base64.encodeURL(
    SHA256.digest(codeVerifier)
);

// 3. éªŒè¯å™¨åªç”¨ä¸€æ¬¡
// æ¯æ¬¡æˆæƒæµç¨‹éƒ½ç”Ÿæˆæ–°çš„verifier

// 4. å®‰å…¨å­˜å‚¨Code Verifier
// åœ¨åº”ç”¨å†…å­˜ä¸­ä¸´æ—¶ä¿å­˜ï¼Œä½¿ç”¨åç«‹å³é”€æ¯
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ”¸ OpenID Connectæœ¬è´¨**ï¼š
```
âœ… OIDC = OAuth 2.0 + èº«ä»½è®¤è¯å±‚
âœ… è§£å†³"ç”¨æˆ·æ˜¯è°"çš„é—®é¢˜ï¼ˆä¸åªæ˜¯æˆæƒï¼‰
âœ… é€šè¿‡ID Tokenä¼ é€’ç”¨æˆ·èº«ä»½ä¿¡æ¯
âœ… å®ç°"ä¸€ä¸ªè´¦å·ï¼Œç™»å½•å¤šå¤„"çš„ä½“éªŒ
```

**ğŸ”¸ æ ¸å¿ƒä»¤ç‰Œç†è§£**ï¼š
```
ID Tokenï¼š
- JWTæ ¼å¼çš„ç”¨æˆ·èº«ä»½è¯æ˜
- åŒ…å«ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
- ç”¨äºå®¢æˆ·ç«¯éªŒè¯ç”¨æˆ·èº«ä»½

Access Tokenï¼š
- è®¿é—®å—ä¿æŠ¤èµ„æºçš„å‡­è¯
- ç”¨äºè°ƒç”¨UserInfoç«¯ç‚¹
- ç”¨äºè®¿é—®API

Refresh Tokenï¼š
- åˆ·æ–°Access Token
- å»¶é•¿ç™»å½•çŠ¶æ€
```

**ğŸ”¸ å…³é”®ç«¯ç‚¹**ï¼š
```
/authorize     â†’ æˆæƒç«¯ç‚¹ï¼ˆè·å–æˆæƒç ï¼‰
/token         â†’ ä»¤ç‰Œç«¯ç‚¹ï¼ˆæ¢å–ä»¤ç‰Œï¼‰
/userinfo      â†’ ç”¨æˆ·ä¿¡æ¯ç«¯ç‚¹
/.well-known/  â†’ è‡ªåŠ¨å‘ç°ç«¯ç‚¹
/jwks          â†’ å…¬é’¥ç«¯ç‚¹ï¼ˆéªŒè¯ç­¾åï¼‰
```

### 9.2 å®è·µåº”ç”¨è¦ç‚¹


**ğŸ¯ é…ç½®æ£€æŸ¥æ¸…å•**ï¼š
```
âœ… scopeå¿…é¡»åŒ…å«"openid"
âœ… é…ç½®æ­£ç¡®çš„redirect-uri
âœ… éªŒè¯issuer-uriå¯è®¿é—®
âœ… ç”Ÿäº§ç¯å¢ƒä½¿ç”¨HTTPS
âœ… å¦¥å–„ä¿ç®¡client-secret
âœ… å¯ç”¨PKCEï¼ˆç§»åŠ¨/å‰ç«¯åº”ç”¨ï¼‰
```

**ğŸ¯ å®‰å…¨æœ€ä½³å®è·µ**ï¼š
```
âœ… éªŒè¯ID Tokençš„ç­¾å
âœ… æ£€æŸ¥audï¼ˆæ¥æ”¶è€…ï¼‰å­—æ®µ
âœ… éªŒè¯expï¼ˆè¿‡æœŸæ—¶é—´ï¼‰
âœ… ä½¿ç”¨stateå‚æ•°é˜²CSRF
âœ… HTTPSåŠ å¯†ä¼ è¾“
âœ… æ•æ„Ÿä¿¡æ¯ä¸æ”¾åœ¨ID Token
```

**ğŸ¯ å¸¸è§åœºæ™¯é€‰æ‹©**ï¼š
```
å•ç‚¹ç™»å½•(SSO)ï¼š
- ä¼ä¸šå†…éƒ¨å¤šä¸ªç³»ç»Ÿ
- å…±äº«è®¤è¯æœåŠ¡å™¨
- ç»Ÿä¸€ç”¨æˆ·ä½“éªŒ

è”åˆèº«ä»½ï¼š
- è·¨ç»„ç»‡è®¿é—®
- åˆä½œä¼™ä¼´é›†æˆ
- å¤šç§Ÿæˆ·SaaSåº”ç”¨

ç¤¾äº¤ç™»å½•ï¼š
- ä½¿ç”¨Google/GitHubç­‰ç™»å½•
- é™ä½æ³¨å†Œé—¨æ§›
- æå‡ç”¨æˆ·ä½“éªŒ
```

### 9.3 å­¦ä¹ è·¯å¾„å»ºè®®


**ğŸš€ å­¦ä¹ æ­¥éª¤**ï¼š
```
ç¬¬1æ­¥ï¼šç†è§£OAuth 2.0åŸºç¡€
    â†“
ç¬¬2æ­¥ï¼šæŒæ¡OIDCæ ¸å¿ƒæ¦‚å¿µ
    â†“  
ç¬¬3æ­¥ï¼šå®è·µSpring Securityé…ç½®
    â†“
ç¬¬4æ­¥ï¼šå®ç°å•ç‚¹ç™»å½•
    â†“
ç¬¬5æ­¥ï¼šæŒæ¡PKCEå¢å¼ºå®‰å…¨
```

**ğŸ“š è¿›é˜¶æ–¹å‘**ï¼š
- è‡ªå»ºè®¤è¯æœåŠ¡å™¨ï¼ˆKeycloak/Oktaï¼‰
- å¤šç§Ÿæˆ·æ¶æ„è®¾è®¡
- ç§»åŠ¨ç«¯OIDCå®ç°
- å¾®æœåŠ¡å®‰å…¨æ¶æ„

**ğŸ§  è®°å¿†å£è¯€**ï¼š
```
OIDCèº«ä»½è®¤ï¼ŒOAuthæˆæƒåˆ†
ID Tokenæ˜¯èº«ä»½ï¼ŒAccessè®¿é—®èµ„æº
UserInfoè¯¦ç»†æŸ¥ï¼ŒPKCEç§»åŠ¨å®‰å…¨å¢
SSOå•ç‚¹ç™»å½•çˆ½ï¼Œè”åˆèº«ä»½è·¨ç»„ç»‡é€š
```

---

**ğŸ’¡ æ–°æ‰‹æ€»ç»“**ï¼š
- OpenID Connectè®©"ä¸€ä¸ªè´¦å·èµ°å¤©ä¸‹"æˆä¸ºå¯èƒ½
- ID Tokenæ˜¯æ ¸å¿ƒï¼ŒåŒ…å«ç”¨æˆ·èº«ä»½ä¿¡æ¯
- Spring Securityè®©OIDCé›†æˆå˜å¾—ç®€å•
- è®°ä½é…ç½®ä¸­å¿…é¡»æœ‰`openid` scope
- ç§»åŠ¨/å‰ç«¯åº”ç”¨åŠ¡å¿…å¯ç”¨PKCE
- ç†è§£æµç¨‹æ¯”è®°ä½ç»†èŠ‚æ›´é‡è¦ï¼