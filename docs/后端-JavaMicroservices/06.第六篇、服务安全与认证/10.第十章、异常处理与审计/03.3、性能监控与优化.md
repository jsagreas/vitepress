---
title: 3ã€æ€§èƒ½ç›‘æ§ä¸ä¼˜åŒ–
---
## ğŸ“š ç›®å½•

1. [æ€§èƒ½ç›‘æ§åŸºç¡€](#1-æ€§èƒ½ç›‘æ§åŸºç¡€)
2. [è®¤è¯æ€§èƒ½ä¼˜åŒ–](#2-è®¤è¯æ€§èƒ½ä¼˜åŒ–)
3. [æƒé™æ£€æŸ¥ä¼˜åŒ–](#3-æƒé™æ£€æŸ¥ä¼˜åŒ–)
4. [ç¼“å­˜ç­–ç•¥åº”ç”¨](#4-ç¼“å­˜ç­–ç•¥åº”ç”¨)
5. [æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–](#5-æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–)
6. [å¹¶å‘æ€§èƒ½è°ƒä¼˜](#6-å¹¶å‘æ€§èƒ½è°ƒä¼˜)
7. [å®æˆ˜ç›‘æ§æ–¹æ¡ˆ](#7-å®æˆ˜ç›‘æ§æ–¹æ¡ˆ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” æ€§èƒ½ç›‘æ§åŸºç¡€


### 1.1 ä¸ºä»€ä¹ˆè¦ç›‘æ§æ€§èƒ½


**ç†è§£æ€§èƒ½ç›‘æ§çš„æ„ä¹‰**

æƒ³è±¡ä½ å¼€äº†ä¸€å®¶é¤å…ï¼Œéœ€è¦çŸ¥é“ï¼š
- é¡¾å®¢æ’é˜Ÿç­‰äº†å¤šä¹…ï¼Ÿï¼ˆå“åº”æ—¶é—´ï¼‰
- å¨æˆ¿èƒ½åŒæ—¶åšå‡ é“èœï¼Ÿï¼ˆå¹¶å‘èƒ½åŠ›ï¼‰
- å“ªä¸ªç¯èŠ‚æœ€æ…¢ï¼Ÿï¼ˆæ€§èƒ½ç“¶é¢ˆï¼‰

Spring Securityä¹Ÿæ˜¯ä¸€æ ·ï¼Œæˆ‘ä»¬éœ€è¦ç›‘æ§ï¼š

```
ç”¨æˆ·ç™»å½•æµç¨‹ï¼š
å®¢æˆ·ç«¯ â†’ è®¤è¯è¿‡æ»¤å™¨ â†’ æ•°æ®åº“æŸ¥è¯¢ â†’ å¯†ç éªŒè¯ â†’ ç”ŸæˆToken â†’ è¿”å›ç»“æœ
   â†“         â†“           â†“          â†“         â†“          â†“
  è€—æ—¶?     è€—æ—¶?       è€—æ—¶?      è€—æ—¶?     è€—æ—¶?      æ€»è€—æ—¶?
```

> ğŸ’¡ **æ ¸å¿ƒç›®æ ‡**ï¼šæ‰¾å‡ºæ…¢çš„ç¯èŠ‚ï¼Œé’ˆå¯¹æ€§ä¼˜åŒ–ï¼Œæå‡ç”¨æˆ·ä½“éªŒ

### 1.2 å…³é”®æ€§èƒ½æŒ‡æ ‡


**éœ€è¦å…³æ³¨çš„æ ¸å¿ƒæŒ‡æ ‡**

| æŒ‡æ ‡ç±»å‹ | å«ä¹‰è¯´æ˜ | å¥åº·æ ‡å‡† | é—®é¢˜è¡¨ç° |
|---------|---------|---------|---------|
| **å“åº”æ—¶é—´** | ä»è¯·æ±‚åˆ°å“åº”çš„æ€»è€—æ—¶ | `< 200ms` | ç”¨æˆ·æ„Ÿè§‰å¡é¡¿ |
| **ååé‡** | æ¯ç§’å¤„ç†çš„è¯·æ±‚æ•° | `> 1000 QPS` | ç³»ç»Ÿå¤„ç†èƒ½åŠ›ä¸è¶³ |
| **å¹¶å‘æ•°** | åŒæ—¶å¤„ç†çš„è¯·æ±‚æ•° | `æ ¹æ®ä¸šåŠ¡` | çº¿ç¨‹æ± è€—å°½ |
| **é”™è¯¯ç‡** | å¤±è´¥è¯·æ±‚çš„æ¯”ä¾‹ | `< 1%` | å¤§é‡è®¤è¯å¤±è´¥ |
| **å†…å­˜ä½¿ç”¨** | ç¼“å­˜å’Œä¼šè¯å ç”¨å†…å­˜ | `< 70%` | å†…å­˜æ³„æ¼é£é™© |

### 1.3 ç›‘æ§æ¶æ„è®¾è®¡


```
æ€§èƒ½ç›‘æ§ä½“ç³»æ¶æ„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           åº”ç”¨å±‚ (Spring Boot)           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ è®¤è¯è¿‡æ»¤å™¨â”‚  â”‚ æƒé™æ§åˆ¶ â”‚  â”‚ ä¸šåŠ¡å±‚ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â”‚
â”‚        â”‚            â”‚            â”‚      â”‚
â”‚   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â” â”‚
â”‚   â”‚        Micrometer æŒ‡æ ‡æ”¶é›†         â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Prometheus (å­˜å‚¨)     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Grafana (å¯è§†åŒ–)      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> ğŸ“– **è§£é‡Š**ï¼š
> - **Micrometer**ï¼šåƒä½“æ£€è®¾å¤‡ï¼Œæ”¶é›†å„é¡¹æŒ‡æ ‡
> - **Prometheus**ï¼šåƒç—…å†ç³»ç»Ÿï¼Œå­˜å‚¨å†å²æ•°æ®
> - **Grafana**ï¼šåƒä½“æ£€æŠ¥å‘Šï¼Œç›´è§‚å±•ç¤ºå¥åº·çŠ¶å†µ

---

## 2. âš¡ è®¤è¯æ€§èƒ½ä¼˜åŒ–


### 2.1 è®¤è¯æµç¨‹æ€§èƒ½åˆ†æ


**è®¤è¯è¿‡ç¨‹çš„æ—¶é—´æ¶ˆè€—**

```
å…¸å‹è®¤è¯æµç¨‹è€—æ—¶åˆ†æï¼š

ç”¨æˆ·ç™»å½•è¯·æ±‚ (æ€»è€—æ—¶: 350ms)
    â”‚
    â”œâ”€ æ¥æ”¶è¯·æ±‚å¹¶è§£æ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 10ms
    â”‚
    â”œâ”€ æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 150ms  â† ç“¶é¢ˆ1
    â”‚   â””â”€ æ•°æ®åº“æŸ¥è¯¢æ…¢
    â”‚
    â”œâ”€ å¯†ç åŠ å¯†å¯¹æ¯” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 120ms  â† ç“¶é¢ˆ2
    â”‚   â””â”€ BCryptç®—æ³•è®¡ç®—å¯†é›†
    â”‚
    â”œâ”€ ç”ŸæˆJWT Token â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 50ms
    â”‚
    â””â”€ è¿”å›è®¤è¯ç»“æœ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 20ms
```

### 2.2 å¯†ç éªŒè¯ä¼˜åŒ–


**é—®é¢˜ï¼šBCryptå¤ªæ…¢æ€ä¹ˆåŠï¼Ÿ**

BCryptå®‰å…¨ä½†æ…¢ï¼Œä¸€æ¬¡éªŒè¯éœ€è¦100-200msï¼Œè¿™æ˜¯ä¸ºäº†é˜²æ­¢æš´åŠ›ç ´è§£ã€‚ä½†æˆ‘ä»¬å¯ä»¥ä¼˜åŒ–ï¼š

**ä¼˜åŒ–ç­–ç•¥ä¸€ï¼šè°ƒæ•´åŠ å¯†å¼ºåº¦**

```java
@Configuration
public class PasswordConfig {
    
    @Bean
    public PasswordEncoder passwordEncoder() {
        // strengthè¶Šå¤§è¶Šå®‰å…¨ï¼Œä½†ä¹Ÿè¶Šæ…¢
        // 10æ˜¯é»˜è®¤å€¼ï¼Œå¯ä»¥é™åˆ°8ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
        return new BCryptPasswordEncoder(10); // ç”Ÿäº§ç¯å¢ƒæ¨èå€¼
    }
}
```

> âš ï¸ **æ³¨æ„**ï¼šå®‰å…¨æ€§å’Œæ€§èƒ½éœ€è¦å¹³è¡¡
> - `strength=8`ï¼šçº¦50msï¼Œé€‚åˆå¼€å‘ç¯å¢ƒ
> - `strength=10`ï¼šçº¦120msï¼Œé€‚åˆç”Ÿäº§ç¯å¢ƒï¼ˆæ¨èï¼‰
> - `strength=12`ï¼šçº¦500msï¼Œè¿‡åº¦å®‰å…¨å½±å“ä½“éªŒ

**ä¼˜åŒ–ç­–ç•¥äºŒï¼šå¤±è´¥å¿«é€Ÿè¿”å›**

```java
@Service
public class AuthService {
    
    // å…ˆæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨ï¼Œé¿å…æ— æ•ˆåŠ å¯†è®¡ç®—
    public UserDetails authenticate(String username, String password) {
        // 1. å¿«é€Ÿæ£€æŸ¥ç”¨æˆ·å­˜åœ¨æ€§
        User user = userRepository.findByUsername(username);
        if (user == null) {
            // ç«‹å³è¿”å›ï¼Œä¸åšå¯†ç éªŒè¯ï¼ˆèŠ‚çœ100ms+ï¼‰
            throw new UsernameNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨");
        }
        
        // 2. ç”¨æˆ·å­˜åœ¨æ‰åšå¯†ç éªŒè¯
        if (!passwordEncoder.matches(password, user.getPassword())) {
            throw new BadCredentialsException("å¯†ç é”™è¯¯");
        }
        
        return user;
    }
}
```

### 2.3 Tokenç”Ÿæˆä¼˜åŒ–


**JWT Tokenç”Ÿæˆæ€§èƒ½æå‡**

```java
@Component
public class JwtTokenProvider {
    
    // ä½¿ç”¨æ›´å¿«çš„ç­¾åç®—æ³•
    private static final SignatureAlgorithm ALGORITHM = SignatureAlgorithm.HS256; // å¯¹ç§°åŠ å¯†ï¼Œå¿«
    // é¿å…ä½¿ç”¨ RS256ï¼ˆéå¯¹ç§°åŠ å¯†ï¼Œæ…¢10å€ï¼‰
    
    public String generateToken(Authentication auth) {
        // å‡å°‘Tokenä¸­çš„æ•°æ®é‡
        Map<String, Object> claims = new HashMap<>();
        claims.put("userId", auth.getPrincipal()); // åªå­˜å¿…è¦ä¿¡æ¯
        // ä¸è¦å­˜ claims.put("permissions", xxx); // æƒé™ä¿¡æ¯å¯ä»¥æŸ¥ç¼“å­˜
        
        return Jwts.builder()
            .setClaims(claims)
            .setExpiration(new Date(System.currentTimeMillis() + 86400000))
            .signWith(ALGORITHM, secretKey)
            .compact();
    }
}
```

> ğŸ’¡ **æ€§èƒ½å¯¹æ¯”**ï¼š
> - **HS256ï¼ˆå¯¹ç§°ï¼‰**ï¼šç”ŸæˆTokençº¦5-10ms
> - **RS256ï¼ˆéå¯¹ç§°ï¼‰**ï¼šç”ŸæˆTokençº¦50-100ms

---

## 3. ğŸ” æƒé™æ£€æŸ¥ä¼˜åŒ–


### 3.1 æƒé™æ£€æŸ¥æ€§èƒ½é—®é¢˜


**ä¸ºä»€ä¹ˆæƒé™æ£€æŸ¥ä¼šæ…¢ï¼Ÿ**

æ¯æ¬¡è¯·æ±‚éƒ½è¦æ£€æŸ¥æƒé™ï¼Œå¦‚æœå¤„ç†ä¸å½“ä¼šå˜æˆæ€§èƒ½æ€æ‰‹ï¼š

```
è¯·æ±‚æµç¨‹ï¼ˆæœªä¼˜åŒ–ï¼‰ï¼š
å®¢æˆ·ç«¯è¯·æ±‚ â†’ è§£æToken â†’ æŸ¥æ•°æ®åº“è·å–æƒé™ â†’ æ£€æŸ¥æƒé™ â†’ æ‰§è¡Œä¸šåŠ¡
                              â†‘
                         æ¯æ¬¡éƒ½æŸ¥è¯¢ï¼ˆæ…¢ï¼ï¼‰
```

å‡è®¾æ¯ç§’1000ä¸ªè¯·æ±‚ï¼Œæ¯æ¬¡æŸ¥æƒé™50msï¼Œæ•°æ®åº“å‹åŠ›å·¨å¤§ï¼

### 3.2 æƒé™ä¿¡æ¯ç¼“å­˜


**ä¼˜åŒ–æ–¹æ¡ˆï¼šç¼“å­˜ç”¨æˆ·æƒé™**

```java
@Service
public class CachedPermissionService {
    
    @Autowired
    private RedisTemplate<String, Set<String>> redisTemplate;
    
    // ä»ç¼“å­˜è·å–æƒé™ï¼Œç¼“å­˜æœªå‘½ä¸­æ‰æŸ¥æ•°æ®åº“
    public Set<String> getUserPermissions(Long userId) {
        String cacheKey = "user:permissions:" + userId;
        
        // 1. å…ˆæŸ¥ç¼“å­˜ï¼ˆ1-2msï¼‰
        Set<String> permissions = redisTemplate.opsForValue().get(cacheKey);
        
        if (permissions != null) {
            return permissions; // ç¼“å­˜å‘½ä¸­ï¼Œå¿«é€Ÿè¿”å›
        }
        
        // 2. ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥æ•°æ®åº“ï¼ˆ50msï¼‰
        permissions = permissionRepository.findByUserId(userId);
        
        // 3. å­˜å…¥ç¼“å­˜ï¼Œæœ‰æ•ˆæœŸ30åˆ†é’Ÿ
        redisTemplate.opsForValue().set(cacheKey, permissions, 30, TimeUnit.MINUTES);
        
        return permissions;
    }
}
```

**æ€§èƒ½æå‡æ•ˆæœ**

| æ–¹æ¡ˆ | å“åº”æ—¶é—´ | QPS | è¯´æ˜ |
|-----|---------|-----|------|
| **æ— ç¼“å­˜** | 50ms | 200 | æ¯æ¬¡æŸ¥æ•°æ®åº“ |
| **Redisç¼“å­˜** | 2ms | 5000+ | ç¼“å­˜å‘½ä¸­ç‡95%+ |
| **æœ¬åœ°ç¼“å­˜** | <1ms | 10000+ | JVMå†…å­˜ç¼“å­˜ |

### 3.3 æƒé™è¡¨è¾¾å¼ä¼˜åŒ–


**ç®€åŒ–æƒé™æ£€æŸ¥é€»è¾‘**

```java
// âŒ ä¸æ¨èï¼šå¤æ‚çš„æƒé™è¡¨è¾¾å¼ï¼ˆæ¯æ¬¡éƒ½è¦è®¡ç®—ï¼‰
@PreAuthorize("hasRole('ADMIN') and hasPermission(#order, 'write') and #order.userId == principal.id")
public void updateOrder(Order order) { }

// âœ… æ¨èï¼šé¢„å…ˆè®¡ç®—æƒé™ï¼Œä½¿ç”¨ç®€å•åˆ¤æ–­
@PreAuthorize("@permissionChecker.canUpdateOrder(#order)")
public void updateOrder(Order order) { }

@Component("permissionChecker")
public class PermissionChecker {
    public boolean canUpdateOrder(Order order) {
        // é€»è¾‘é›†ä¸­å¤„ç†ï¼Œå¯ä»¥ä¼˜åŒ–å’Œç¼“å­˜
        UserDetails user = getCurrentUser();
        return user.isAdmin() || order.getUserId().equals(user.getId());
    }
}
```

---

## 4. ğŸš€ ç¼“å­˜ç­–ç•¥åº”ç”¨


### 4.1 å¤šçº§ç¼“å­˜æ¶æ„


**æ„å»ºé«˜æ•ˆçš„ç¼“å­˜ä½“ç³»**

```
å¤šçº§ç¼“å­˜è®¾è®¡ï¼š

è¯·æ±‚ â†’ æœ¬åœ°ç¼“å­˜(Caffeine) â†’ Redisç¼“å­˜ â†’ æ•°æ®åº“
         â†“ å‘½ä¸­ç‡70%        â†“ å‘½ä¸­ç‡25%   â†“ 5%
        <1ms               2ms          50ms
```

**å®ç°å¤šçº§ç¼“å­˜**

```java
@Service
public class MultiLevelCacheService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // æœ¬åœ°ç¼“å­˜ï¼šJVMå†…å­˜ï¼Œæœ€å¿«ä½†å®¹é‡å°
    private LoadingCache<String, UserDetails> localCache = Caffeine.newBuilder()
        .maximumSize(1000) // æœ€å¤š1000ä¸ªç”¨æˆ·
        .expireAfterWrite(5, TimeUnit.MINUTES) // 5åˆ†é’Ÿè¿‡æœŸ
        .build(key -> loadFromRedis(key));
    
    public UserDetails getUserDetails(String username) {
        try {
            // ä¼˜å…ˆæœ¬åœ°ç¼“å­˜ï¼ˆ<1msï¼‰
            return localCache.get(username);
        } catch (Exception e) {
            // é™çº§åˆ°æ•°æ®åº“æŸ¥è¯¢
            return loadFromDatabase(username);
        }
    }
    
    private UserDetails loadFromRedis(String username) {
        // äºŒçº§ç¼“å­˜ï¼šRedisï¼ˆ2msï¼‰
        UserDetails user = (UserDetails) redisTemplate.opsForValue()
            .get("user:" + username);
        
        if (user == null) {
            // ä¸‰çº§ï¼šæ•°æ®åº“ï¼ˆ50msï¼‰
            user = loadFromDatabase(username);
            redisTemplate.opsForValue().set("user:" + username, user, 30, TimeUnit.MINUTES);
        }
        
        return user;
    }
}
```

> ğŸ“Š **æ€§èƒ½æ•°æ®**ï¼š
> - æ— ç¼“å­˜ï¼šå¹³å‡50msï¼ŒQPSçº¦200
> - Redisç¼“å­˜ï¼šå¹³å‡3msï¼ŒQPSçº¦3000
> - å¤šçº§ç¼“å­˜ï¼šå¹³å‡<1msï¼ŒQPSçº¦8000+

### 4.2 ç¼“å­˜å¤±æ•ˆç­–ç•¥


**ä½•æ—¶æ›´æ–°ç¼“å­˜ï¼Ÿ**

```java
@Service
public class UserCacheManager {
    
    // ç”¨æˆ·ä¿¡æ¯å˜æ›´æ—¶ï¼Œæ¸…é™¤ç¼“å­˜
    @CacheEvict(value = "users", key = "#user.id")
    public void updateUser(User user) {
        userRepository.save(user);
        
        // åŒæ—¶æ¸…é™¤ç›¸å…³ç¼“å­˜
        redisTemplate.delete("user:permissions:" + user.getId());
        redisTemplate.delete("user:roles:" + user.getId());
    }
    
    // å®šæ—¶åˆ·æ–°çƒ­ç‚¹æ•°æ®
    @Scheduled(fixedRate = 300000) // æ¯5åˆ†é’Ÿ
    public void refreshHotUsers() {
        List<Long> hotUserIds = getHotUserIds(); // æ´»è·ƒç”¨æˆ·
        hotUserIds.forEach(this::preloadUserCache);
    }
}
```

---

## 5. ğŸ’¾ æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–


### 5.1 æŸ¥è¯¢æ€§èƒ½é—®é¢˜è¯Šæ–­


**è¯†åˆ«æ…¢æŸ¥è¯¢**

```sql
-- æŸ¥æ‰¾æ…¢æŸ¥è¯¢ï¼ˆè€—æ—¶>100msï¼‰
SELECT 
    user_id,
    COUNT(*) as query_count,
    AVG(query_time) as avg_time
FROM slow_query_log
WHERE query_time > 100
GROUP BY user_id
ORDER BY avg_time DESC;
```

**å¸¸è§çš„æ…¢æŸ¥è¯¢åœºæ™¯**

```
âŒ é—®é¢˜1ï¼šå…¨è¡¨æ‰«æ
SELECT * FROM users WHERE username = 'admin';
                                      â†‘
                              æ²¡æœ‰ç´¢å¼•ï¼Œå…¨è¡¨æ‰«æ

âœ… è§£å†³ï¼šæ·»åŠ ç´¢å¼•
CREATE INDEX idx_username ON users(username);
```

### 5.2 ç´¢å¼•ä¼˜åŒ–å®æˆ˜


**ä¸ºè®¤è¯æŸ¥è¯¢æ·»åŠ ç´¢å¼•**

```java
@Entity
@Table(name = "users", indexes = {
    @Index(name = "idx_username", columnList = "username"), // ç™»å½•æŸ¥è¯¢
    @Index(name = "idx_email", columnList = "email"),       // é‚®ç®±ç™»å½•
    @Index(name = "idx_phone", columnList = "phone")        // æ‰‹æœºç™»å½•
})
public class User {
    @Id
    private Long id;
    
    @Column(unique = true, nullable = false)
    private String username; // æœ‰ç´¢å¼•ï¼ŒæŸ¥è¯¢å¿«
    
    private String email;
    private String phone;
}
```

**ç´¢å¼•æ•ˆæœå¯¹æ¯”**

| åœºæ™¯ | æ— ç´¢å¼• | æœ‰ç´¢å¼• | æå‡å€æ•° |
|-----|-------|-------|---------|
| æŸ¥è¯¢å•ä¸ªç”¨æˆ· | 150ms | 5ms | **30å€** |
| 10ä¸‡ç”¨æˆ·æ•°æ® | 500ms | 8ms | **62å€** |
| 100ä¸‡ç”¨æˆ· | 3000ms | 12ms | **250å€** |

### 5.3 æ‡’åŠ è½½ä¸æ‰¹é‡æŸ¥è¯¢


**é¿å…N+1æŸ¥è¯¢é—®é¢˜**

```java
// âŒ é—®é¢˜ï¼šN+1æŸ¥è¯¢
public List<UserDTO> getUsers() {
    List<User> users = userRepository.findAll(); // 1æ¬¡æŸ¥è¯¢
    
    return users.stream().map(user -> {
        Set<Role> roles = roleRepository.findByUserId(user.getId()); // Næ¬¡æŸ¥è¯¢ï¼
        return new UserDTO(user, roles);
    }).collect(Collectors.toList());
}

// âœ… ä¼˜åŒ–ï¼šæ‰¹é‡æŸ¥è¯¢
public List<UserDTO> getUsersOptimized() {
    List<User> users = userRepository.findAll();
    
    // ä¸€æ¬¡æ€§æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·çš„è§’è‰²
    Set<Long> userIds = users.stream().map(User::getId).collect(Collectors.toSet());
    Map<Long, Set<Role>> rolesMap = roleRepository.findByUserIdIn(userIds)
        .stream()
        .collect(Collectors.groupingBy(
            UserRole::getUserId,
            Collectors.mapping(UserRole::getRole, Collectors.toSet())
        ));
    
    return users.stream().map(user -> 
        new UserDTO(user, rolesMap.get(user.getId()))
    ).collect(Collectors.toList());
}
```

---

## 6. âš™ï¸ å¹¶å‘æ€§èƒ½è°ƒä¼˜


### 6.1 çº¿ç¨‹æ± é…ç½®ä¼˜åŒ–


**Spring Securityçš„çº¿ç¨‹æ¨¡å‹**

```
è¯·æ±‚å¤„ç†æµç¨‹ï¼š
å®¢æˆ·ç«¯è¯·æ±‚ â†’ Tomcatçº¿ç¨‹æ±  â†’ Securityè¿‡æ»¤å™¨ â†’ ä¸šåŠ¡é€»è¾‘
              â†“
         é»˜è®¤200ä¸ªçº¿ç¨‹
```

**ä¼˜åŒ–çº¿ç¨‹æ± é…ç½®**

```yaml
# application.yml
server:
  tomcat:
    threads:
      max: 500              # æœ€å¤§çº¿ç¨‹æ•°ï¼ˆæ ¹æ®CPUæ ¸æ•°è°ƒæ•´ï¼‰
      min-spare: 50         # æœ€å°ç©ºé—²çº¿ç¨‹
    max-connections: 10000  # æœ€å¤§è¿æ¥æ•°
    accept-count: 200       # ç­‰å¾…é˜Ÿåˆ—é•¿åº¦
```

> ğŸ’¡ **è®¡ç®—å…¬å¼**ï¼š
> - **CPUå¯†é›†å‹**ï¼šçº¿ç¨‹æ•° = CPUæ ¸æ•° + 1
> - **IOå¯†é›†å‹**ï¼ˆæ•°æ®åº“æŸ¥è¯¢ï¼‰ï¼šçº¿ç¨‹æ•° = CPUæ ¸æ•° Ã— 2
> - **æ··åˆå‹**ï¼šçº¿ç¨‹æ•° = CPUæ ¸æ•° Ã— (1 + ç­‰å¾…æ—¶é—´/è®¡ç®—æ—¶é—´)

### 6.2 è¿æ¥æ± ä¼˜åŒ–


**æ•°æ®åº“è¿æ¥æ± é…ç½®**

```yaml
spring:
  datasource:
    hikari:
      maximum-pool-size: 50    # æœ€å¤§è¿æ¥æ•°
      minimum-idle: 10         # æœ€å°ç©ºé—²è¿æ¥
      connection-timeout: 30000 # è¿æ¥è¶…æ—¶30s
      idle-timeout: 600000     # ç©ºé—²è¶…æ—¶10åˆ†é’Ÿ
      max-lifetime: 1800000    # è¿æ¥æœ€å¤§å­˜æ´»30åˆ†é’Ÿ
```

**ç›‘æ§è¿æ¥æ± çŠ¶æ€**

```java
@Component
public class DataSourceMonitor {
    
    @Autowired
    private HikariDataSource dataSource;
    
    @Scheduled(fixedRate = 10000) // æ¯10ç§’
    public void logPoolStats() {
        HikariPoolMXBean poolMXBean = dataSource.getHikariPoolMXBean();
        
        log.info("è¿æ¥æ± çŠ¶æ€ - æ´»è·ƒ:{} ç©ºé—²:{} ç­‰å¾…:{} æ€»æ•°:{}",
            poolMXBean.getActiveConnections(),
            poolMXBean.getIdleConnections(),
            poolMXBean.getThreadsAwaitingConnection(),
            poolMXBean.getTotalConnections()
        );
        
        // å‘Šè­¦ï¼šè¿æ¥æ± è€—å°½
        if (poolMXBean.getActiveConnections() > 45) {
            log.warn("âš ï¸ è¿æ¥æ± æ¥è¿‘é¥±å’Œï¼");
        }
    }
}
```

### 6.3 å¹¶å‘é”ä¼˜åŒ–


**å‡å°‘é”ç«äº‰**

```java
// âŒ é—®é¢˜ï¼šå…¨å±€é”ï¼Œå¹¶å‘ä½
private synchronized String generateToken(User user) {
    return jwtProvider.create(user);
}

// âœ… ä¼˜åŒ–ï¼šç»†ç²’åº¦é”
private ConcurrentHashMap<Long, ReentrantLock> userLocks = new ConcurrentHashMap<>();

public String generateToken(User user) {
    Lock lock = userLocks.computeIfAbsent(user.getId(), k -> new ReentrantLock());
    
    lock.lock();
    try {
        return jwtProvider.create(user);
    } finally {
        lock.unlock();
    }
}
```

---

## 7. ğŸ“Š å®æˆ˜ç›‘æ§æ–¹æ¡ˆ


### 7.1 é›†æˆç›‘æ§å·¥å…·


**æ·»åŠ ç›‘æ§ä¾èµ–**

```xml
<dependencies>
    <!-- Micrometeræ ¸å¿ƒ -->
    <dependency>
        <groupId>io.micrometer</groupId>
        <artifactId>micrometer-core</artifactId>
    </dependency>
    
    <!-- Prometheusæ”¯æŒ -->
    <dependency>
        <groupId>io.micrometer</groupId>
        <artifactId>micrometer-registry-prometheus</artifactId>
    </dependency>
    
    <!-- Spring Boot Actuator -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-actuator</artifactId>
    </dependency>
</dependencies>
```

**é…ç½®ç›‘æ§ç«¯ç‚¹**

```yaml
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  metrics:
    export:
      prometheus:
        enabled: true
    tags:
      application: ${spring.application.name}
```

### 7.2 è‡ªå®šä¹‰æ€§èƒ½æŒ‡æ ‡


**ç›‘æ§è®¤è¯æ€§èƒ½**

```java
@Component
public class SecurityMetrics {
    
    private final Counter loginAttempts;
    private final Counter loginFailures;
    private final Timer authenticationTimer;
    
    public SecurityMetrics(MeterRegistry registry) {
        this.loginAttempts = Counter.builder("security.login.attempts")
            .description("ç™»å½•å°è¯•æ¬¡æ•°")
            .register(registry);
            
        this.loginFailures = Counter.builder("security.login.failures")
            .description("ç™»å½•å¤±è´¥æ¬¡æ•°")
            .register(registry);
            
        this.authenticationTimer = Timer.builder("security.authentication.time")
            .description("è®¤è¯è€—æ—¶")
            .register(registry);
    }
    
    public void recordLoginAttempt() {
        loginAttempts.increment();
    }
    
    public void recordLoginFailure() {
        loginFailures.increment();
    }
    
    public Timer.Sample startAuthTimer() {
        return Timer.start();
    }
    
    public void recordAuthTime(Timer.Sample sample) {
        sample.stop(authenticationTimer);
    }
}
```

**åœ¨è®¤è¯æµç¨‹ä¸­ä½¿ç”¨**

```java
@Service
public class AuthenticationService {
    
    @Autowired
    private SecurityMetrics metrics;
    
    public Authentication authenticate(String username, String password) {
        metrics.recordLoginAttempt();
        Timer.Sample sample = metrics.startAuthTimer();
        
        try {
            // è®¤è¯é€»è¾‘
            Authentication auth = doAuthenticate(username, password);
            return auth;
        } catch (AuthenticationException e) {
            metrics.recordLoginFailure();
            throw e;
        } finally {
            metrics.recordAuthTime(sample);
        }
    }
}
```

### 7.3 Grafanaç›‘æ§é¢æ¿


**å…³é”®ç›‘æ§æŒ‡æ ‡å¯è§†åŒ–**

```
ç›‘æ§é¢æ¿å¸ƒå±€ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è®¤è¯æ€§èƒ½æ€»è§ˆ                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚QPS: 1200â”‚ â”‚æˆåŠŸç‡98%â”‚ â”‚å¹³å‡è€—æ—¶50msâ”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å“åº”æ—¶é—´åˆ†å¸ƒ (æœ€è¿‘1å°æ—¶)                     â”‚
â”‚  â”‚                    â”Œâ”€â”€â”                  â”‚
â”‚  â”‚              â”Œâ”€â”€â”  â”‚  â”‚                  â”‚
â”‚  â”‚        â”Œâ”€â”€â”  â”‚  â”‚  â”‚  â”‚  â”Œâ”€â”€â”           â”‚
â”‚  â”‚  â”Œâ”€â”€â”  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚  â”‚           â”‚
â”‚  â””â”€â”€â”´â”€â”€â”´â”€â”€â”´â”€â”€â”´â”€â”€â”´â”€â”€â”´â”€â”€â”´â”€â”€â”´â”€â”€â”´â”€â”€â”´â”€â”€â”€â”€â”€â”€     â”‚
â”‚     <50  50   100  150  200  250  >300ms    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç¼“å­˜å‘½ä¸­ç‡ & æ•°æ®åº“æŸ¥è¯¢                      â”‚
â”‚  ç¼“å­˜: 95% â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘               â”‚
â”‚  æŸ¥è¯¢: 200/s â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å‘Šè­¦è§„åˆ™é…ç½®**

```yaml
# prometheus-alerts.yml
groups:
  - name: security_alerts
    rules:
      # è®¤è¯å¤±è´¥ç‡è¿‡é«˜
      - alert: HighAuthFailureRate
        expr: rate(security_login_failures_total[5m]) / rate(security_login_attempts_total[5m]) > 0.1
        for: 5m
        annotations:
          summary: "è®¤è¯å¤±è´¥ç‡è¶…è¿‡10%"
          
      # å“åº”æ—¶é—´è¿‡é•¿  
      - alert: SlowAuthentication
        expr: histogram_quantile(0.95, security_authentication_time_bucket) > 0.5
        for: 5m
        annotations:
          summary: "95%è®¤è¯è¯·æ±‚è¶…è¿‡500ms"
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 æ€§èƒ½ä¼˜åŒ–å…³é”®ç‚¹


```
ğŸ”¸ è®¤è¯ä¼˜åŒ–ï¼šå¯†ç å¼ºåº¦å¹³è¡¡ã€ç¼“å­˜ç”¨æˆ·ä¿¡æ¯ã€Tokenè½»é‡åŒ–
ğŸ”¸ æƒé™æ£€æŸ¥ï¼šå¤šçº§ç¼“å­˜ã€ç®€åŒ–è¡¨è¾¾å¼ã€é¢„åŠ è½½æƒé™
ğŸ”¸ æ•°æ®åº“ï¼šç´¢å¼•ä¼˜åŒ–ã€æ‰¹é‡æŸ¥è¯¢ã€è¿æ¥æ± è°ƒä¼˜
ğŸ”¸ å¹¶å‘æ§åˆ¶ï¼šçº¿ç¨‹æ± é…ç½®ã€ç»†ç²’åº¦é”ã€å¼‚æ­¥å¤„ç†
ğŸ”¸ ç›‘æ§ä½“ç³»ï¼šæŒ‡æ ‡é‡‡é›†ã€å¯è§†åŒ–é¢æ¿ã€æ™ºèƒ½å‘Šè­¦
```

### 8.2 æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥æ¸…å•


**ä¸Šçº¿å‰æ£€æŸ¥**

- [ ] **ç´¢å¼•æ£€æŸ¥**ï¼šæ‰€æœ‰æŸ¥è¯¢å­—æ®µéƒ½æœ‰ç´¢å¼•
- [ ] **ç¼“å­˜é…ç½®**ï¼šçƒ­ç‚¹æ•°æ®å·²ç¼“å­˜ï¼Œè¿‡æœŸç­–ç•¥åˆç†
- [ ] **çº¿ç¨‹æ± **ï¼šæ ¹æ®å‹æµ‹ç»“æœè°ƒæ•´å¤§å°
- [ ] **è¿æ¥æ± **ï¼šæ•°æ®åº“è¿æ¥æ•°å……è¶³ä½†ä¸æµªè´¹
- [ ] **ç›‘æ§å‘Šè­¦**ï¼šå…³é”®æŒ‡æ ‡å·²é…ç½®å‘Šè­¦è§„åˆ™

**ä¼˜åŒ–ä¼˜å…ˆçº§**

```
é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³ä¼˜åŒ–ï¼‰ï¼š
1. æ•°æ®åº“ç´¢å¼• â†’ æ•ˆæœæœ€æ˜æ˜¾ï¼ˆ10-100å€æå‡ï¼‰
2. æ·»åŠ ç¼“å­˜ â†’ å‡å°‘é‡å¤æŸ¥è¯¢ï¼ˆ5-50å€æå‡ï¼‰
3. æ‰¹é‡æŸ¥è¯¢ â†’ è§£å†³N+1é—®é¢˜ï¼ˆNå€æå‡ï¼‰

ä¸­ä¼˜å…ˆçº§ï¼ˆé‡ç‚¹å…³æ³¨ï¼‰ï¼š
4. å¯†ç ç®—æ³• â†’ å¹³è¡¡å®‰å…¨ä¸æ€§èƒ½
5. Tokenä¼˜åŒ– â†’ å‡å°‘ç”Ÿæˆè€—æ—¶
6. çº¿ç¨‹æ± è°ƒä¼˜ â†’ æå‡å¹¶å‘èƒ½åŠ›

ä½ä¼˜å…ˆçº§ï¼ˆé”¦ä¸Šæ·»èŠ±ï¼‰ï¼š
7. æœ¬åœ°ç¼“å­˜ â†’ è¿›ä¸€æ­¥æå‡é€Ÿåº¦
8. å¼‚æ­¥å¤„ç† â†’ æå‡ç”¨æˆ·ä½“éªŒ
```

### 8.3 å¸¸è§æ€§èƒ½é—®é¢˜é€ŸæŸ¥


| é—®é¢˜ç°è±¡ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ¡ˆ |
|---------|---------|---------|
| **ç™»å½•æ…¢(>500ms)** | å¯†ç éªŒè¯è€—æ—¶ | é™ä½BCryptå¼ºåº¦ã€æ£€æŸ¥æ•°æ®åº“ç´¢å¼• |
| **æ¥å£æ…¢(>200ms)** | æƒé™æŸ¥è¯¢è€—æ—¶ | æ·»åŠ Redisç¼“å­˜ã€ä¼˜åŒ–SQL |
| **å¹¶å‘ä½(<1000)** | çº¿ç¨‹æ± è¿‡å° | å¢å¤§çº¿ç¨‹æ•°ã€ä½¿ç”¨å¼‚æ­¥å¤„ç† |
| **å†…å­˜æš´æ¶¨** | ç¼“å­˜æœªè®¾ç½®è¿‡æœŸ | é…ç½®TTLã€é™åˆ¶ç¼“å­˜å¤§å° |
| **æ•°æ®åº“å‹åŠ›å¤§** | ç¼“å­˜æœªå‘½ä¸­ | é¢„çƒ­ç¼“å­˜ã€å¢åŠ ç¼“å­˜æ—¶é—´ |

### 8.4 å®ç”¨æ€§èƒ½ä¼˜åŒ–å»ºè®®


> ğŸ’¡ **ä¼˜åŒ–ç»éªŒ**ï¼š
> 1. **å…ˆæµ‹é‡å†ä¼˜åŒ–**ï¼šç”¨æ•°æ®è¯´è¯ï¼Œä¸è¦ç›²ç›®ä¼˜åŒ–
> 2. **æŠ“å¤§æ”¾å°**ï¼šä¼˜å…ˆè§£å†³æ€§èƒ½ç“¶é¢ˆï¼Œä¸çº ç»“ç»†èŠ‚
> 3. **æ¸è¿›å¼ä¼˜åŒ–**ï¼šä¸€æ¬¡æ”¹ä¸€ä¸ªï¼Œè§‚å¯Ÿæ•ˆæœ
> 4. **ä¿æŒç®€å•**ï¼šå¤æ‚çš„ä¼˜åŒ–éš¾ç»´æŠ¤ï¼Œç®€å•æœ‰æ•ˆæœ€å¥½

> âš ï¸ **é¿å…è¿‡åº¦ä¼˜åŒ–**ï¼š
> - QPSè¾¾åˆ°éœ€æ±‚å°±å¥½ï¼Œä¸å¿…è¿½æ±‚æè‡´
> - æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§éœ€è¦å¹³è¡¡
> - ç¼“å­˜ä¸æ˜¯ä¸‡èƒ½çš„ï¼Œè¦æ§åˆ¶å¤æ‚åº¦

**è®°å¿†å£è¯€**ï¼š
```
ç´¢å¼•ç¼“å­˜æ˜¯åŸºç¡€ï¼Œè¿æ¥æ± å¤§å°è¦è°ƒåº¦
çƒ­ç‚¹æ•°æ®æå‰ç¼“ï¼Œå†·æ•°æ®æ‡’åŠ è½½
ç›‘æ§å‘Šè­¦ä¸èƒ½å°‘ï¼Œæ€§èƒ½ç“¶é¢ˆæ—©å‘ç°
```