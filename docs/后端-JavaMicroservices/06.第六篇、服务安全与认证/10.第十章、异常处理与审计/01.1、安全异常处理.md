---
title: 1ã€å®‰å…¨å¼‚å¸¸å¤„ç†
---
## ğŸ“š ç›®å½•

1. [å®‰å…¨å¼‚å¸¸å¤„ç†æ¦‚è¿°](#1-å®‰å…¨å¼‚å¸¸å¤„ç†æ¦‚è¿°)
2. [è®¤è¯å…¥å£ç‚¹-AuthenticationEntryPoint](#2-è®¤è¯å…¥å£ç‚¹-AuthenticationEntryPoint)
3. [è®¿é—®æ‹’ç»å¤„ç†å™¨-AccessDeniedHandler](#3-è®¿é—®æ‹’ç»å¤„ç†å™¨-AccessDeniedHandler)
4. [è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†](#4-è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†)
5. [å®‰å…¨å¼‚å¸¸å“åº”æ ¼å¼](#5-å®‰å…¨å¼‚å¸¸å“åº”æ ¼å¼)
6. [é”™è¯¯ä¿¡æ¯è„±æ•](#6-é”™è¯¯ä¿¡æ¯è„±æ•)
7. [å¼‚å¸¸æ—¥å¿—è®°å½•](#7-å¼‚å¸¸æ—¥å¿—è®°å½•)
8. [ç»Ÿä¸€å¼‚å¸¸å“åº”](#8-ç»Ÿä¸€å¼‚å¸¸å“åº”)
9. [å®‰å…¨äº‹ä»¶é€šçŸ¥](#9-å®‰å…¨äº‹ä»¶é€šçŸ¥)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ›¡ï¸ å®‰å…¨å¼‚å¸¸å¤„ç†æ¦‚è¿°


### 1.1 ä¸ºä»€ä¹ˆéœ€è¦å®‰å…¨å¼‚å¸¸å¤„ç†


**æ—¥å¸¸åœºæ™¯ç±»æ¯”ï¼š**
```
å°±åƒå•†åœºçš„å®‰ä¿ç³»ç»Ÿï¼š
- æ²¡å¸¦ä¼šå‘˜å¡æƒ³è¿›VIPåŒº â†’ éœ€è¦å¼•å¯¼å»åŠå¡ï¼ˆè®¤è¯å¼‚å¸¸ï¼‰
- å¸¦äº†æ™®é€šå¡æƒ³è¿›è´µå®¾åŒº â†’ å‘ŠçŸ¥æƒé™ä¸è¶³ï¼ˆæˆæƒå¼‚å¸¸ï¼‰
- ç³»ç»Ÿè¯†åˆ«åˆ°å¯ç–‘è¡Œä¸º â†’ è®°å½•å¹¶é€šçŸ¥å®‰ä¿ï¼ˆå®¡è®¡æ—¥å¿—ï¼‰

Spring Securityä¹Ÿä¸€æ ·ï¼Œéœ€è¦å¦¥å–„å¤„ç†å„ç§å®‰å…¨é—®é¢˜
```

### 1.2 Spring Securityçš„å¼‚å¸¸ä½“ç³»


**å¼‚å¸¸åˆ†ç±»ç»“æ„ï¼š**
```
å®‰å…¨å¼‚å¸¸
â”œâ”€â”€ è®¤è¯å¼‚å¸¸ï¼ˆAuthenticationï¼‰
â”‚   â”œâ”€â”€ ç”¨æˆ·æœªç™»å½•
â”‚   â”œâ”€â”€ ç™»å½•è¿‡æœŸ
â”‚   â””â”€â”€ å‡­è¯æ— æ•ˆ
â”‚
â””â”€â”€ æˆæƒå¼‚å¸¸ï¼ˆAuthorizationï¼‰
    â”œâ”€â”€ æƒé™ä¸è¶³
    â”œâ”€â”€ è§’è‰²ä¸åŒ¹é…
    â””â”€â”€ è®¿é—®è¢«æ‹’ç»
```

**æ ¸å¿ƒæ¦‚å¿µï¼š**
- **è®¤è¯å¼‚å¸¸**ï¼šèº«ä»½éªŒè¯å¤±è´¥æ—¶å‘ç”Ÿï¼Œæ¯”å¦‚æ²¡ç™»å½•ã€tokenè¿‡æœŸ
- **æˆæƒå¼‚å¸¸**ï¼šæƒé™éªŒè¯å¤±è´¥æ—¶å‘ç”Ÿï¼Œæ¯”å¦‚æ™®é€šç”¨æˆ·è®¿é—®ç®¡ç†å‘˜åŠŸèƒ½

---

## 2. ğŸšª è®¤è¯å…¥å£ç‚¹-AuthenticationEntryPoint


### 2.1 ä»€ä¹ˆæ˜¯AuthenticationEntryPoint


**é€šä¿—ç†è§£ï¼š**
> AuthenticationEntryPointå°±åƒé—¨å«ï¼Œå½“æœ‰äººæƒ³è¿›é—¨ä½†æ²¡è¯ä»¶æ—¶ï¼Œé—¨å«è¦å†³å®šæ€ä¹ˆå¤„ç†è¿™ä¸ªäºº

**ä½œç”¨è¯´æ˜ï¼š**
- å½“ç”¨æˆ·**æœªç™»å½•**å°±è®¿é—®éœ€è¦è®¤è¯çš„èµ„æºæ—¶è§¦å‘
- å†³å®šå¦‚ä½•**å“åº”**è¿™ä¸ªè®¤è¯å¤±è´¥çš„è¯·æ±‚
- æ¯”å¦‚ï¼šè¿”å›401é”™è¯¯ã€è·³è½¬ç™»å½•é¡µã€è¿”å›JSONæç¤ºç­‰

### 2.2 é»˜è®¤è¡Œä¸ºvsè‡ªå®šä¹‰è¡Œä¸º


**é»˜è®¤è¡Œä¸ºï¼š**
```
ä¼ ç»ŸWebåº”ç”¨ï¼šé‡å®šå‘åˆ°ç™»å½•é¡µ
å‰åç«¯åˆ†ç¦»ï¼šè¿”å›403é”™è¯¯ï¼ˆä¸å¤ªå‹å¥½ï¼‰
```

**ä¸ºä»€ä¹ˆè¦è‡ªå®šä¹‰ï¼š**
| åœºæ™¯ | é»˜è®¤è¡Œä¸ºé—®é¢˜ | è‡ªå®šä¹‰æ–¹æ¡ˆ |
|------|-------------|-----------|
| **å‰åç«¯åˆ†ç¦»** | è¿”å›HTMLç™»å½•é¡µ | è¿”å›JSONæ ¼å¼é”™è¯¯ä¿¡æ¯ |
| **ç§»åŠ¨ç«¯API** | æ— æ³•å¤„ç†é‡å®šå‘ | è¿”å›ç»Ÿä¸€é”™è¯¯ç  |
| **å¾®æœåŠ¡** | é”™è¯¯ä¿¡æ¯ä¸ç»Ÿä¸€ | ç»Ÿä¸€å¼‚å¸¸å“åº”æ ¼å¼ |

### 2.3 è‡ªå®šä¹‰è®¤è¯å…¥å£ç‚¹å®ç°


**å®ç°æ­¥éª¤ï¼š**

```java
@Component
public class CustomAuthenticationEntryPoint implements AuthenticationEntryPoint {
    
    @Override
    public void commence(HttpServletRequest request, 
                        HttpServletResponse response,
                        AuthenticationException authException) throws IOException {
        
        // è®¾ç½®å“åº”ç±»å‹ä¸ºJSON
        response.setContentType("application/json;charset=UTF-8");
        response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
        
        // æ„å»ºç»Ÿä¸€é”™è¯¯å“åº”
        Map<String, Object> result = new HashMap<>();
        result.put("code", 401);
        result.put("message", "è¯·å…ˆç™»å½•");
        result.put("timestamp", System.currentTimeMillis());
        
        // å†™å…¥å“åº”
        response.getWriter().write(new ObjectMapper().writeValueAsString(result));
    }
}
```

**ä»£ç è¯´æ˜ï¼š**
- `commenceæ–¹æ³•`ï¼šè®¤è¯å¤±è´¥æ—¶è‡ªåŠ¨è°ƒç”¨
- `HttpServletResponse`ï¼šç”¨æ¥æ„å»ºHTTPå“åº”
- `AuthenticationException`ï¼šåŒ…å«è®¤è¯å¤±è´¥çš„å…·ä½“åŸå› 

**é…ç½®ä½¿ç”¨ï¼š**
```java
@Configuration
public class SecurityConfig {
    
    @Autowired
    private CustomAuthenticationEntryPoint authenticationEntryPoint;
    
    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
            .exceptionHandling(exception -> exception
                .authenticationEntryPoint(authenticationEntryPoint)
            );
        return http.build();
    }
}
```

---

## 3. ğŸš« è®¿é—®æ‹’ç»å¤„ç†å™¨-AccessDeniedHandler


### 3.1 ä»€ä¹ˆæ˜¯AccessDeniedHandler


**é€šä¿—ç†è§£ï¼š**
> AccessDeniedHandlerå°±åƒæƒé™ç®¡ç†å‘˜ï¼Œå½“ä½ æœ‰èº«ä»½è¯æ˜ï¼ˆå·²ç™»å½•ï¼‰ä½†æƒ³å»ä¸è¯¥å»çš„åœ°æ–¹æ—¶ï¼Œç®¡ç†å‘˜è¦å†³å®šå¦‚ä½•æ‹’ç»ä½ 

**ä¸AuthenticationEntryPointçš„åŒºåˆ«ï¼š**
```
AuthenticationEntryPointï¼š
ç”¨æˆ·ï¼šæˆ‘æƒ³è¿›å»
ç³»ç»Ÿï¼šä½ æ˜¯è°ï¼Ÿï¼ˆæ²¡ç™»å½•ï¼‰â†’ è§¦å‘è®¤è¯å…¥å£ç‚¹

AccessDeniedHandlerï¼š
ç”¨æˆ·ï¼šæˆ‘æ˜¯å¼ ä¸‰ï¼Œæˆ‘è¦è¿›å»
ç³»ç»Ÿï¼šçŸ¥é“ä½ æ˜¯å¼ ä¸‰ï¼Œä½†ä½ æƒé™ä¸å¤Ÿï¼â†’ è§¦å‘è®¿é—®æ‹’ç»å¤„ç†å™¨
```

### 3.2 è®¿é—®æ‹’ç»çš„å¸¸è§åœºæ™¯


**åœºæ™¯ä¸¾ä¾‹ï¼š**

| åœºæ™¯ | è¯´æ˜ | ç”¨æˆ·è§’è‰² | è®¿é—®èµ„æº |
|------|------|---------|---------|
| åœºæ™¯1 | æ™®é€šç”¨æˆ·è®¿é—®ç®¡ç†åŠŸèƒ½ | `USER` | `/admin/**` |
| åœºæ™¯2 | æ™®é€šä¼šå‘˜è®¿é—®VIPå†…å®¹ | `MEMBER` | `/vip/**` |
| åœºæ™¯3 | åªè¯»ç”¨æˆ·å°è¯•åˆ é™¤æ“ä½œ | `READER` | `DELETE /api/data` |

### 3.3 è‡ªå®šä¹‰è®¿é—®æ‹’ç»å¤„ç†å™¨


**å®ç°ä»£ç ï¼š**

```java
@Component
public class CustomAccessDeniedHandler implements AccessDeniedHandler {
    
    @Override
    public void handle(HttpServletRequest request,
                      HttpServletResponse response,
                      AccessDeniedException accessDeniedException) throws IOException {
        
        response.setContentType("application/json;charset=UTF-8");
        response.setStatus(HttpServletResponse.SC_FORBIDDEN);
        
        Map<String, Object> result = new HashMap<>();
        result.put("code", 403);
        result.put("message", "æƒé™ä¸è¶³ï¼Œæ— æ³•è®¿é—®");
        result.put("path", request.getRequestURI());
        
        response.getWriter().write(new ObjectMapper().writeValueAsString(result));
    }
}
```

**é…ç½®ä½¿ç”¨ï¼š**
```java
http.exceptionHandling(exception -> exception
    .authenticationEntryPoint(authenticationEntryPoint)  // è®¤è¯å¼‚å¸¸
    .accessDeniedHandler(accessDeniedHandler)            // æˆæƒå¼‚å¸¸
);
```

---

## 4. ğŸ”§ è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†


### 4.1 ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†


**å®é™…é—®é¢˜ï¼š**
```
é»˜è®¤å¼‚å¸¸å¤„ç†çš„é—®é¢˜ï¼š
âŒ é”™è¯¯ä¿¡æ¯æ ¼å¼ä¸ç»Ÿä¸€
âŒ æ•æ„Ÿä¿¡æ¯å¯èƒ½æ³„éœ²
âŒ å‰ç«¯éš¾ä»¥ç»Ÿä¸€å¤„ç†
âŒ ç¼ºå°‘è¯¦ç»†çš„é”™è¯¯è¿½è¸ªä¿¡æ¯
```

**è‡ªå®šä¹‰çš„å¥½å¤„ï¼š**
```
âœ… ç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼
âœ… å®‰å…¨çš„é”™è¯¯ä¿¡æ¯å±•ç¤º
âœ… ä¾¿äºå‰ç«¯ç»Ÿä¸€å¤„ç†
âœ… å®Œæ•´çš„é”™è¯¯è¿½è¸ªæ—¥å¿—
```

### 4.2 å…¨å±€å®‰å…¨å¼‚å¸¸å¤„ç†å™¨


**å®ç°å®Œæ•´çš„å¼‚å¸¸å¤„ç†å™¨ï¼š**

```java
@RestControllerAdvice
public class SecurityExceptionHandler {
    
    private static final Logger log = LoggerFactory.getLogger(SecurityExceptionHandler.class);
    
    // å¤„ç†è®¤è¯å¼‚å¸¸
    @ExceptionHandler(AuthenticationException.class)
    public ResponseEntity<ErrorResponse> handleAuthenticationException(
            AuthenticationException ex, HttpServletRequest request) {
        
        log.warn("è®¤è¯å¤±è´¥: URI={}, åŸå› ={}", request.getRequestURI(), ex.getMessage());
        
        ErrorResponse error = ErrorResponse.builder()
            .code(401)
            .message("è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•")
            .path(request.getRequestURI())
            .timestamp(LocalDateTime.now())
            .build();
            
        return ResponseEntity.status(401).body(error);
    }
    
    // å¤„ç†æˆæƒå¼‚å¸¸
    @ExceptionHandler(AccessDeniedException.class)
    public ResponseEntity<ErrorResponse> handleAccessDeniedException(
            AccessDeniedException ex, HttpServletRequest request) {
        
        log.warn("è®¿é—®è¢«æ‹’ç»: URI={}, ç”¨æˆ·={}", 
            request.getRequestURI(), 
            SecurityContextHolder.getContext().getAuthentication().getName());
        
        ErrorResponse error = ErrorResponse.builder()
            .code(403)
            .message("æƒé™ä¸è¶³")
            .path(request.getRequestURI())
            .timestamp(LocalDateTime.now())
            .build();
            
        return ResponseEntity.status(403).body(error);
    }
}
```

**å“åº”å¯¹è±¡å®šä¹‰ï¼š**
```java
@Data
@Builder
public class ErrorResponse {
    private Integer code;           // é”™è¯¯ç 
    private String message;         // é”™è¯¯ä¿¡æ¯
    private String path;           // è¯·æ±‚è·¯å¾„
    private LocalDateTime timestamp; // æ—¶é—´æˆ³
    private String traceId;        // è¿½è¸ªIDï¼ˆå¯é€‰ï¼‰
}
```

---

## 5. ğŸ“‹ å®‰å…¨å¼‚å¸¸å“åº”æ ¼å¼


### 5.1 ç»Ÿä¸€å“åº”æ ¼å¼è®¾è®¡


**ä¸ºä»€ä¹ˆéœ€è¦ç»Ÿä¸€æ ¼å¼ï¼š**
> å°±åƒå¿«é€’å•éƒ½æœ‰ç»Ÿä¸€æ ¼å¼ï¼Œå‰ç«¯æ”¶åˆ°é”™è¯¯å“åº”ä¹Ÿéœ€è¦ç»Ÿä¸€æ ¼å¼ï¼Œè¿™æ ·æ‰èƒ½ç»Ÿä¸€å¤„ç†

**æ ‡å‡†å“åº”æ ¼å¼ï¼š**
```json
{
  "code": 401,
  "message": "è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•",
  "data": null,
  "timestamp": "2025-09-23T10:30:00",
  "path": "/api/user/profile",
  "traceId": "abc-123-def"
}
```

### 5.2 ä¸åŒå¼‚å¸¸çš„å“åº”ç¤ºä¾‹


**è®¤è¯å¼‚å¸¸å“åº”ï¼š**
```json
{
  "code": 401,
  "message": "Tokenå·²è¿‡æœŸ",
  "data": {
    "errorType": "TOKEN_EXPIRED",
    "expireTime": "2025-09-23T09:00:00"
  },
  "timestamp": "2025-09-23T10:30:00"
}
```

**æˆæƒå¼‚å¸¸å“åº”ï¼š**
```json
{
  "code": 403,
  "message": "æƒé™ä¸è¶³",
  "data": {
    "errorType": "INSUFFICIENT_PERMISSION",
    "requiredRole": "ADMIN",
    "currentRole": "USER"
  },
  "timestamp": "2025-09-23T10:30:00"
}
```

### 5.3 å“åº”æ ¼å¼æœ€ä½³å®è·µ


**è®¾è®¡åŸåˆ™ï¼š**

| åŸåˆ™ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| **ä¸€è‡´æ€§** | æ‰€æœ‰é”™è¯¯ä½¿ç”¨ç›¸åŒç»“æ„ | éƒ½åŒ…å«codeã€messageã€timestamp |
| **ä¿¡æ¯æ€§** | æä¾›è¶³å¤Ÿçš„è°ƒè¯•ä¿¡æ¯ | åŒ…å«è¯·æ±‚è·¯å¾„ã€é”™è¯¯ç±»å‹ |
| **å®‰å…¨æ€§** | ä¸æš´éœ²æ•æ„Ÿä¿¡æ¯ | ä¸è¿”å›å †æ ˆä¿¡æ¯ç»™å‰ç«¯ |
| **å¯è¿½è¸ª** | åŒ…å«è¿½è¸ªæ ‡è¯† | traceIdç”¨äºæ—¥å¿—å…³è” |

---

## 6. ğŸ”’ é”™è¯¯ä¿¡æ¯è„±æ•


### 6.1 ä»€ä¹ˆæ˜¯é”™è¯¯ä¿¡æ¯è„±æ•


**é€šä¿—ç†è§£ï¼š**
> å°±åƒåŒ»ç”Ÿä¸ä¼šæŠŠç—…å†ç»†èŠ‚å‘Šè¯‰ç—…äººå®¶å±ï¼Œç³»ç»Ÿä¹Ÿä¸è¯¥æŠŠå†…éƒ¨é”™è¯¯ç»†èŠ‚æš´éœ²ç»™ç”¨æˆ·

**ä¸ºä»€ä¹ˆè¦è„±æ•ï¼š**
```
âŒ ä¸è„±æ•çš„é£é™©ï¼š
"ç”¨æˆ·åadminä¸å­˜åœ¨" â†’ æ³„éœ²äº†ç³»ç»Ÿç”¨æˆ·åä¿¡æ¯
"SQLæŸ¥è¯¢å¤±è´¥ï¼šSELECT * FROM user WHERE..." â†’ æ³„éœ²æ•°æ®åº“ç»“æ„
"æ–‡ä»¶è·¯å¾„/opt/app/config/secret.ymlä¸å­˜åœ¨" â†’ æ³„éœ²æœåŠ¡å™¨è·¯å¾„

âœ… è„±æ•åï¼š
"ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯" â†’ ç»Ÿä¸€æç¤º
"ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•" â†’ ä¸æš´éœ²å†…éƒ¨ç»†èŠ‚
"é…ç½®æ–‡ä»¶è¯»å–å¤±è´¥" â†’ åªè¯´ç»“æœä¸è¯´è·¯å¾„
```

### 6.2 è„±æ•ç­–ç•¥å®ç°


**é”™è¯¯ä¿¡æ¯æ˜ å°„ï¼š**

```java
@Component
public class ErrorMessageSanitizer {
    
    // æ•æ„Ÿé”™è¯¯ä¿¡æ¯æ˜ å°„è¡¨
    private static final Map<String, String> ERROR_MESSAGE_MAP = Map.of(
        "Bad credentials", "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯",
        "User is disabled", "è´¦æˆ·å·²è¢«ç¦ç”¨",
        "User account is locked", "è´¦æˆ·å·²è¢«é”å®š",
        "Token has expired", "ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•"
    );
    
    /**
     * å¯¹é”™è¯¯ä¿¡æ¯è¿›è¡Œè„±æ•å¤„ç†
     */
    public String sanitize(String originalMessage) {
        // æŸ¥æ‰¾æ˜ å°„è¡¨
        for (Map.Entry<String, String> entry : ERROR_MESSAGE_MAP.entrySet()) {
            if (originalMessage.contains(entry.getKey())) {
                return entry.getValue();
            }
        }
        
        // é»˜è®¤é€šç”¨æç¤º
        return "æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•";
    }
    
    /**
     * è„±æ•å¼‚å¸¸å¯¹è±¡
     */
    public ErrorResponse sanitizeException(Exception ex, HttpServletRequest request) {
        String safeMessage = sanitize(ex.getMessage());
        
        return ErrorResponse.builder()
            .code(getErrorCode(ex))
            .message(safeMessage)
            .path(request.getRequestURI())
            .timestamp(LocalDateTime.now())
            .build();
    }
}
```

### 6.3 å¼€å‘ç¯å¢ƒvsç”Ÿäº§ç¯å¢ƒ


**åŒºåˆ«å¯¹å¾…ï¼š**

```java
@Component
public class EnvironmentAwareErrorHandler {
    
    @Value("${spring.profiles.active}")
    private String profile;
    
    public ErrorResponse buildErrorResponse(Exception ex, HttpServletRequest request) {
        ErrorResponse.ErrorResponseBuilder builder = ErrorResponse.builder()
            .code(getErrorCode(ex))
            .path(request.getRequestURI())
            .timestamp(LocalDateTime.now());
        
        // å¼€å‘ç¯å¢ƒï¼šæ˜¾ç¤ºè¯¦ç»†é”™è¯¯
        if ("dev".equals(profile)) {
            builder.message(ex.getMessage())
                   .detail(ex.getClass().getName())
                   .stackTrace(getStackTraceString(ex));
        } 
        // ç”Ÿäº§ç¯å¢ƒï¼šä½¿ç”¨è„±æ•ä¿¡æ¯
        else {
            builder.message(sanitize(ex.getMessage()));
        }
        
        return builder.build();
    }
}
```

---

## 7. ğŸ“ å¼‚å¸¸æ—¥å¿—è®°å½•


### 7.1 ä¸ºä»€ä¹ˆè¦è®°å½•å®‰å…¨å¼‚å¸¸æ—¥å¿—


**æ—¥å¿—çš„ä½œç”¨ï¼š**
```
å°±åƒé“¶è¡Œçš„ç›‘æ§å½•åƒï¼š
âœ… äº‹åè¿½æº¯ï¼šè°åœ¨ä»€ä¹ˆæ—¶å€™å°è¯•åšä»€ä¹ˆ
âœ… å®‰å…¨å®¡è®¡ï¼šå‘ç°å¼‚å¸¸è®¿é—®æ¨¡å¼
âœ… é—®é¢˜æ’æŸ¥ï¼šå¿«é€Ÿå®šä½ç³»ç»Ÿé—®é¢˜
âœ… è¡Œä¸ºåˆ†æï¼šç»Ÿè®¡æ”»å‡»è¶‹åŠ¿
```

### 7.2 æ—¥å¿—è®°å½•çš„å…³é”®ä¿¡æ¯


**å¿…é¡»è®°å½•çš„ä¿¡æ¯ï¼š**

| ä¿¡æ¯ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|---------|------|------|
| **æ—¶é—´** | å¼‚å¸¸å‘ç”Ÿæ—¶é—´ | 2025-09-23 10:30:15 |
| **ç”¨æˆ·** | è°è§¦å‘çš„å¼‚å¸¸ | ç”¨æˆ·ID: 10086 |
| **æ“ä½œ** | å°è¯•åšä»€ä¹ˆ | è®¿é—® /admin/users |
| **å¼‚å¸¸ç±»å‹** | ä»€ä¹ˆå¼‚å¸¸ | AccessDeniedException |
| **IPåœ°å€** | æ¥æºIP | 192.168.1.100 |
| **è®¾å¤‡ä¿¡æ¯** | å®¢æˆ·ç«¯ä¿¡æ¯ | Chrome 118.0 / Windows |

### 7.3 æ—¥å¿—è®°å½•å®ç°


**å®Œæ•´çš„æ—¥å¿—è®°å½•ï¼š**

```java
@Component
public class SecurityAuditLogger {
    
    private static final Logger log = LoggerFactory.getLogger(SecurityAuditLogger.class);
    
    /**
     * è®°å½•è®¤è¯å¤±è´¥
     */
    public void logAuthenticationFailure(HttpServletRequest request, 
                                        AuthenticationException ex) {
        String username = request.getParameter("username");
        String ip = getClientIP(request);
        String userAgent = request.getHeader("User-Agent");
        
        log.warn("è®¤è¯å¤±è´¥ | ç”¨æˆ·={} | IP={} | è·¯å¾„={} | åŸå› ={} | UA={}", 
            username, ip, request.getRequestURI(), 
            ex.getMessage(), userAgent);
    }
    
    /**
     * è®°å½•è®¿é—®æ‹’ç»
     */
    public void logAccessDenied(HttpServletRequest request, 
                               AccessDeniedException ex) {
        Authentication auth = SecurityContextHolder.getContext().getAuthentication();
        String username = auth != null ? auth.getName() : "åŒ¿å";
        String ip = getClientIP(request);
        
        log.warn("è®¿é—®è¢«æ‹’ç» | ç”¨æˆ·={} | IP={} | è·¯å¾„={} | æ–¹æ³•={} | åŸå› ={}", 
            username, ip, request.getRequestURI(), 
            request.getMethod(), ex.getMessage());
    }
    
    /**
     * è·å–å®¢æˆ·ç«¯çœŸå®IP
     */
    private String getClientIP(HttpServletRequest request) {
        String ip = request.getHeader("X-Forwarded-For");
        if (ip == null || ip.isEmpty()) {
            ip = request.getRemoteAddr();
        }
        return ip;
    }
}
```

### 7.4 æ—¥å¿—çº§åˆ«ä½¿ç”¨


**æ—¥å¿—çº§åˆ«å»ºè®®ï¼š**

```
ERRORçº§åˆ«ï¼š
- ç³»ç»Ÿçº§å®‰å…¨å¼‚å¸¸ï¼ˆå¦‚é…ç½®é”™è¯¯ï¼‰
- å¯èƒ½çš„å®‰å…¨æ”»å‡»ï¼ˆå¦‚SQLæ³¨å…¥å°è¯•ï¼‰

WARNçº§åˆ«ï¼š
- è®¤è¯å¤±è´¥ï¼ˆæ­£å¸¸çš„é”™è¯¯å°è¯•ï¼‰
- è®¿é—®æ‹’ç»ï¼ˆæƒé™ä¸è¶³ï¼‰
- å¯ç–‘è¡Œä¸ºï¼ˆé¢‘ç¹å¤±è´¥ï¼‰

INFOçº§åˆ«ï¼š
- æˆåŠŸçš„å®‰å…¨æ“ä½œï¼ˆç™»å½•æˆåŠŸï¼‰
- æƒé™å˜æ›´è®°å½•
```

---

## 8. ğŸ¯ ç»Ÿä¸€å¼‚å¸¸å“åº”


### 8.1 ç»Ÿä¸€å¼‚å¸¸å“åº”çš„å¿…è¦æ€§


**å®é™…åœºæ™¯ï¼š**
```
æ²¡æœ‰ç»Ÿä¸€å¤„ç†ï¼š
æ¥å£Aè¿”å›ï¼š{"error": "è®¤è¯å¤±è´¥"}
æ¥å£Bè¿”å›ï¼š{"msg": "auth failed", "status": 401}
æ¥å£Cè¿”å›ï¼š{"code": -1, "message": "æœªç™»å½•"}

å‰ç«¯å¼€å‘ï¼šæˆ‘è¦æ€ä¹ˆå¤„ç†è¿™äº›ä¸åŒæ ¼å¼ï¼ŸğŸ˜­
```

**ç»Ÿä¸€å¤„ç†åï¼š**
```
æ‰€æœ‰æ¥å£éƒ½è¿”å›ï¼š
{
  "code": 401,
  "message": "è®¤è¯å¤±è´¥",
  "data": null,
  "timestamp": "2025-09-23T10:30:00"
}

å‰ç«¯å¼€å‘ï¼šå¤ªæ£’äº†ï¼Œç»Ÿä¸€å¤„ç†ï¼ğŸ˜Š
```

### 8.2 å…¨å±€å¼‚å¸¸å¤„ç†æ¶æ„


**å¤„ç†æµç¨‹ï¼š**
```
è¯·æ±‚ â†’ è¿‡æ»¤å™¨ â†’ Controller â†’ ä¸šåŠ¡é€»è¾‘
                    â†“ (å¼‚å¸¸)
              å…¨å±€å¼‚å¸¸å¤„ç†å™¨
                    â†“
           ç»Ÿä¸€æ ¼å¼å“åº” â†’ å‰ç«¯
```

### 8.3 å®Œæ•´çš„ç»Ÿä¸€å¼‚å¸¸å¤„ç†å®ç°


**å…¨å±€å¼‚å¸¸å¤„ç†å™¨ï¼š**

```java
@RestControllerAdvice
@Order(Ordered.HIGHEST_PRECEDENCE)
public class GlobalSecurityExceptionHandler {
    
    @Autowired
    private ErrorMessageSanitizer sanitizer;
    
    @Autowired
    private SecurityAuditLogger auditLogger;
    
    /**
     * è®¤è¯å¼‚å¸¸ç»Ÿä¸€å¤„ç†
     */
    @ExceptionHandler(AuthenticationException.class)
    public ResponseEntity<ApiResponse<Void>> handleAuthException(
            AuthenticationException ex, HttpServletRequest request) {
        
        // è®°å½•æ—¥å¿—
        auditLogger.logAuthenticationFailure(request, ex);
        
        // æ„å»ºå“åº”
        ApiResponse<Void> response = ApiResponse.<Void>builder()
            .code(401)
            .message(sanitizer.sanitize(ex.getMessage()))
            .success(false)
            .timestamp(LocalDateTime.now())
            .path(request.getRequestURI())
            .build();
        
        return ResponseEntity.status(401).body(response);
    }
    
    /**
     * æˆæƒå¼‚å¸¸ç»Ÿä¸€å¤„ç†
     */
    @ExceptionHandler(AccessDeniedException.class)
    public ResponseEntity<ApiResponse<Void>> handleAccessDenied(
            AccessDeniedException ex, HttpServletRequest request) {
        
        auditLogger.logAccessDenied(request, ex);
        
        ApiResponse<Void> response = ApiResponse.<Void>builder()
            .code(403)
            .message("æƒé™ä¸è¶³ï¼Œæ— æ³•è®¿é—®è¯¥èµ„æº")
            .success(false)
            .timestamp(LocalDateTime.now())
            .path(request.getRequestURI())
            .build();
        
        return ResponseEntity.status(403).body(response);
    }
    
    /**
     * å…¶ä»–å®‰å…¨å¼‚å¸¸
     */
    @ExceptionHandler(SecurityException.class)
    public ResponseEntity<ApiResponse<Void>> handleSecurityException(
            SecurityException ex, HttpServletRequest request) {
        
        ApiResponse<Void> response = ApiResponse.<Void>builder()
            .code(500)
            .message(sanitizer.sanitize(ex.getMessage()))
            .success(false)
            .timestamp(LocalDateTime.now())
            .build();
        
        return ResponseEntity.status(500).body(response);
    }
}
```

**ç»Ÿä¸€å“åº”å¯¹è±¡ï¼š**
```java
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class ApiResponse<T> {
    private Integer code;        // çŠ¶æ€ç 
    private String message;      // æç¤ºä¿¡æ¯
    private Boolean success;     // æ˜¯å¦æˆåŠŸ
    private T data;             // æ•°æ®
    private LocalDateTime timestamp; // æ—¶é—´æˆ³
    private String path;        // è¯·æ±‚è·¯å¾„
    private String traceId;     // è¿½è¸ªID
}
```

---

## 9. ğŸ“¢ å®‰å…¨äº‹ä»¶é€šçŸ¥


### 9.1 ä»€ä¹ˆæ˜¯å®‰å…¨äº‹ä»¶é€šçŸ¥


**é€šä¿—ç†è§£ï¼š**
> å°±åƒå®¶é‡Œçš„æŠ¥è­¦å™¨ï¼Œå‘ç°å¼‚å¸¸æƒ…å†µè¦åŠæ—¶é€šçŸ¥ä¸»äºº

**éœ€è¦é€šçŸ¥çš„å®‰å…¨äº‹ä»¶ï¼š**
```
ğŸš¨ é«˜å±äº‹ä»¶ï¼š
- å¤šæ¬¡ç™»å½•å¤±è´¥ï¼ˆå¯èƒ½çš„æš´åŠ›ç ´è§£ï¼‰
- éæ³•è®¿é—®å°è¯•ï¼ˆæƒé™æå‡æ”»å‡»ï¼‰
- å¼‚å¸¸IPç™»å½•ï¼ˆè´¦æˆ·å¯èƒ½è¢«ç›—ï¼‰

âš ï¸ é‡è¦äº‹ä»¶ï¼š
- ç®¡ç†å‘˜æƒé™å˜æ›´
- æ•æ„Ÿæ•°æ®è®¿é—®
- å¤§é‡å¹¶å‘è¯·æ±‚ï¼ˆå¯èƒ½çš„DDoSï¼‰
```

### 9.2 äº‹ä»¶é€šçŸ¥æœºåˆ¶


**é€šçŸ¥æµç¨‹ï¼š**
```
å®‰å…¨å¼‚å¸¸å‘ç”Ÿ
       â†“
  åˆ¤æ–­äº‹ä»¶ç­‰çº§
       â†“
  è§¦å‘é€šçŸ¥ç­–ç•¥
       â†“
   å‘é€é€šçŸ¥
  (é‚®ä»¶/çŸ­ä¿¡/é’‰é’‰/ä¼ä¸šå¾®ä¿¡)
```

### 9.3 å®‰å…¨äº‹ä»¶ç›‘å¬å™¨


**äº‹ä»¶å®šä¹‰ï¼š**

```java
// å®‰å…¨äº‹ä»¶åŸºç±»
@Getter
public abstract class SecurityEvent extends ApplicationEvent {
    private final String username;
    private final String ip;
    private final LocalDateTime occurTime;
    
    public SecurityEvent(Object source, String username, String ip) {
        super(source);
        this.username = username;
        this.ip = ip;
        this.occurTime = LocalDateTime.now();
    }
}

// è®¤è¯å¤±è´¥äº‹ä»¶
public class AuthenticationFailureEvent extends SecurityEvent {
    private final String reason;
    
    public AuthenticationFailureEvent(Object source, String username, 
                                     String ip, String reason) {
        super(source, username, ip);
        this.reason = reason;
    }
}

// è®¿é—®æ‹’ç»äº‹ä»¶
public class AccessDeniedEvent extends SecurityEvent {
    private final String resource;
    
    public AccessDeniedEvent(Object source, String username, 
                            String ip, String resource) {
        super(source, username, ip);
        this.resource = resource;
    }
}
```

**äº‹ä»¶å‘å¸ƒï¼š**

```java
@Component
public class SecurityEventPublisher {
    
    @Autowired
    private ApplicationEventPublisher eventPublisher;
    
    /**
     * å‘å¸ƒè®¤è¯å¤±è´¥äº‹ä»¶
     */
    public void publishAuthFailure(String username, String ip, String reason) {
        AuthenticationFailureEvent event = new AuthenticationFailureEvent(
            this, username, ip, reason
        );
        eventPublisher.publishEvent(event);
    }
    
    /**
     * å‘å¸ƒè®¿é—®æ‹’ç»äº‹ä»¶
     */
    public void publishAccessDenied(String username, String ip, String resource) {
        AccessDeniedEvent event = new AccessDeniedEvent(
            this, username, ip, resource
        );
        eventPublisher.publishEvent(event);
    }
}
```

### 9.4 äº‹ä»¶ç›‘å¬ä¸å¤„ç†


**ç›‘å¬å™¨å®ç°ï¼š**

```java
@Component
public class SecurityEventListener {
    
    @Autowired
    private NotificationService notificationService;
    
    private static final int MAX_FAILED_ATTEMPTS = 5;
    private final Map<String, Integer> failedAttempts = new ConcurrentHashMap<>();
    
    /**
     * ç›‘å¬è®¤è¯å¤±è´¥äº‹ä»¶
     */
    @EventListener
    public void handleAuthenticationFailure(AuthenticationFailureEvent event) {
        String key = event.getUsername() + ":" + event.getIp();
        
        // ç»Ÿè®¡å¤±è´¥æ¬¡æ•°
        int attempts = failedAttempts.getOrDefault(key, 0) + 1;
        failedAttempts.put(key, attempts);
        
        // è¾¾åˆ°é˜ˆå€¼ï¼Œå‘é€å‘Šè­¦
        if (attempts >= MAX_FAILED_ATTEMPTS) {
            String message = String.format(
                "ç”¨æˆ· %s ä»IP %s è¿ç»­ç™»å½•å¤±è´¥ %d æ¬¡ï¼Œç–‘ä¼¼æš´åŠ›ç ´è§£",
                event.getUsername(), event.getIp(), attempts
            );
            
            notificationService.sendAlert("å®‰å…¨å‘Šè­¦", message);
            
            // é‡ç½®è®¡æ•°
            failedAttempts.remove(key);
        }
    }
    
    /**
     * ç›‘å¬è®¿é—®æ‹’ç»äº‹ä»¶
     */
    @EventListener
    public void handleAccessDenied(AccessDeniedEvent event) {
        // è®°å½•æ•æ„Ÿèµ„æºè®¿é—®å°è¯•
        if (isSensitiveResource(event.getResource())) {
            String message = String.format(
                "ç”¨æˆ· %s ä»IP %s å°è¯•è®¿é—®æ•æ„Ÿèµ„æº: %s",
                event.getUsername(), event.getIp(), event.getResource()
            );
            
            notificationService.sendWarning("å®‰å…¨è­¦å‘Š", message);
        }
    }
    
    private boolean isSensitiveResource(String resource) {
        return resource.contains("/admin") || 
               resource.contains("/system") ||
               resource.contains("/delete");
    }
}
```

### 9.5 é€šçŸ¥æœåŠ¡å®ç°


**å¤šæ¸ é“é€šçŸ¥ï¼š**

```java
@Service
public class NotificationService {
    
    @Autowired
    private JavaMailSender mailSender;
    
    /**
     * å‘é€å‘Šè­¦é€šçŸ¥ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
     */
    public void sendAlert(String title, String content) {
        // å‘é€é‚®ä»¶
        sendEmail(title, content);
        
        // å‘é€çŸ­ä¿¡
        sendSms(content);
        
        // å‘é€é’‰é’‰æ¶ˆæ¯
        sendDingTalk(title, content);
    }
    
    /**
     * å‘é€è­¦å‘Šé€šçŸ¥ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰
     */
    public void sendWarning(String title, String content) {
        // åªå‘é€é‚®ä»¶å’Œé’‰é’‰
        sendEmail(title, content);
        sendDingTalk(title, content);
    }
    
    private void sendEmail(String title, String content) {
        // é‚®ä»¶å‘é€å®ç°
    }
    
    private void sendSms(String content) {
        // çŸ­ä¿¡å‘é€å®ç°
    }
    
    private void sendDingTalk(String title, String content) {
        // é’‰é’‰æœºå™¨äººå‘é€å®ç°
    }
}
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ AuthenticationEntryPointï¼šå¤„ç†"æœªç™»å½•"çš„æƒ…å†µ
ğŸ”¸ AccessDeniedHandlerï¼šå¤„ç†"æƒé™ä¸è¶³"çš„æƒ…å†µ
ğŸ”¸ å¼‚å¸¸è„±æ•ï¼šç”Ÿäº§ç¯å¢ƒä¸æš´éœ²æ•æ„Ÿä¿¡æ¯
ğŸ”¸ ç»Ÿä¸€å“åº”ï¼šæ‰€æœ‰å¼‚å¸¸è¿”å›ç›¸åŒæ ¼å¼
ğŸ”¸ æ—¥å¿—å®¡è®¡ï¼šè®°å½•æ‰€æœ‰å®‰å…¨ç›¸å…³æ“ä½œ
ğŸ”¸ äº‹ä»¶é€šçŸ¥ï¼šé‡è¦å®‰å…¨äº‹ä»¶åŠæ—¶å‘Šè­¦
```

### 10.2 å¼‚å¸¸å¤„ç†æµç¨‹æ€»è§ˆ


```
1. å¼‚å¸¸å‘ç”Ÿ
   â†“
2. å…¨å±€å¼‚å¸¸å¤„ç†å™¨æ•è·
   â†“
3. è®°å½•å®¡è®¡æ—¥å¿—
   â†“
4. é”™è¯¯ä¿¡æ¯è„±æ•
   â†“
5. æ„å»ºç»Ÿä¸€å“åº”æ ¼å¼
   â†“
6. å‘å¸ƒå®‰å…¨äº‹ä»¶
   â†“
7. è§¦å‘é€šçŸ¥ï¼ˆå¦‚éœ€è¦ï¼‰
   â†“
8. è¿”å›ç»™å‰ç«¯
```

### 10.3 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸¤ä¸ªå¤„ç†å™¨çš„åŒºåˆ«**
```
AuthenticationEntryPointï¼š
- è§¦å‘æ—¶æœºï¼šæœªç™»å½•è®¿é—®éœ€è¦è®¤è¯çš„èµ„æº
- è¿”å›ç ï¼š401 Unauthorized
- å¸¸è§æç¤ºï¼š"è¯·å…ˆç™»å½•"

AccessDeniedHandlerï¼š
- è§¦å‘æ—¶æœºï¼šå·²ç™»å½•ä½†æƒé™ä¸è¶³
- è¿”å›ç ï¼š403 Forbidden  
- å¸¸è§æç¤ºï¼š"æƒé™ä¸è¶³"
```

**ğŸ”¹ æ—¥å¿—è®°å½•çš„é‡è¦æ€§**
```
ä¸è®°å½•æ—¥å¿—çš„é—®é¢˜ï¼š
âŒ æ— æ³•è¿½æº¯å®‰å…¨äº‹ä»¶
âŒ éš¾ä»¥å‘ç°æ”»å‡»æ¨¡å¼
âŒ é—®é¢˜æ’æŸ¥å›°éš¾

è®°å½•æ—¥å¿—çš„å¥½å¤„ï¼š
âœ… å®Œæ•´çš„æ“ä½œå®¡è®¡
âœ… åŠæ—¶å‘ç°å¼‚å¸¸
âœ… å¿«é€Ÿå®šä½é—®é¢˜
âœ… æ»¡è¶³åˆè§„è¦æ±‚
```

**ğŸ”¹ é”™è¯¯ä¿¡æ¯è„±æ•åŸåˆ™**
```
å¼€å‘ç¯å¢ƒï¼š
- æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
- åŒ…å«å †æ ˆè·Ÿè¸ª
- ä¾¿äºè°ƒè¯•

ç”Ÿäº§ç¯å¢ƒï¼š
- åªè¿”å›é€šç”¨æç¤º
- ä¸æš´éœ²ç³»ç»Ÿç»†èŠ‚
- è¯¦ç»†ä¿¡æ¯åªè®°å½•åœ¨æœåŠ¡ç«¯æ—¥å¿—
```

### 10.4 å®é™…åº”ç”¨å»ºè®®


**é…ç½®æ¸…å•ï¼š**

âœ… **å¿…é¡»é…ç½®é¡¹**
- [ ] è‡ªå®šä¹‰AuthenticationEntryPoint
- [ ] è‡ªå®šä¹‰AccessDeniedHandler
- [ ] å…¨å±€å¼‚å¸¸å¤„ç†å™¨
- [ ] ç»Ÿä¸€å“åº”æ ¼å¼

âœ… **æ¨èé…ç½®é¡¹**  
- [ ] é”™è¯¯ä¿¡æ¯è„±æ•
- [ ] å®‰å…¨å®¡è®¡æ—¥å¿—
- [ ] æ•æ„Ÿæ“ä½œäº‹ä»¶é€šçŸ¥

âœ… **å¯é€‰é…ç½®é¡¹**
- [ ] å¤±è´¥æ¬¡æ•°é™åˆ¶
- [ ] IPé»‘åå•
- [ ] å¼‚å¸¸ç»Ÿè®¡åˆ†æ

### 10.5 å¸¸è§é—®é¢˜è§£ç­”


**Q1ï¼šä¸¤ä¸ªå¤„ç†å™¨éƒ½è¦é…ç½®å—ï¼Ÿ**
> æ˜¯çš„ï¼Œå»ºè®®éƒ½é…ç½®ã€‚AuthenticationEntryPointå¤„ç†æœªç™»å½•ï¼ŒAccessDeniedHandlerå¤„ç†æƒé™ä¸è¶³ï¼Œè¦†ç›–ä¸åŒåœºæ™¯ã€‚

**Q2ï¼šç”Ÿäº§ç¯å¢ƒçš„é”™è¯¯ä¿¡æ¯åº”è¯¥è¿”å›ä»€ä¹ˆï¼Ÿ**
> åªè¿”å›é€šç”¨æç¤ºå¦‚"è®¤è¯å¤±è´¥"ã€"æƒé™ä¸è¶³"ï¼Œè¯¦ç»†é”™è¯¯åªè®°å½•åœ¨æœåŠ¡ç«¯æ—¥å¿—ä¸­ã€‚

**Q3ï¼šå®‰å…¨æ—¥å¿—åº”è¯¥è®°å½•å“ªäº›å†…å®¹ï¼Ÿ**
> æ—¶é—´ã€ç”¨æˆ·ã€IPã€æ“ä½œã€ç»“æœã€å¼‚å¸¸åŸå› ï¼Œä¾¿äºå®¡è®¡å’Œé—®é¢˜æ’æŸ¥ã€‚

**Q4ï¼šä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦å‘é€é€šçŸ¥ï¼Ÿ**
> å¤šæ¬¡ç™»å½•å¤±è´¥ã€å¼‚å¸¸IPç™»å½•ã€æ•æ„Ÿæ“ä½œã€æƒé™å˜æ›´ç­‰é«˜å±äº‹ä»¶ã€‚

**æ ¸å¿ƒè®°å¿†å£è¯€ï¼š**
```
è®¤è¯å¼‚å¸¸ç”¨EntryPointï¼Œæˆæƒå¤±è´¥Handlerå¸®
ç»Ÿä¸€æ ¼å¼è„±æ•å¤„ç†ï¼Œæ—¥å¿—å®¡è®¡ä¸èƒ½å¿˜  
é‡è¦äº‹ä»¶åŠæ—¶é€šçŸ¥ï¼Œå®‰å…¨é˜²æŠ¤æœ‰ä¿éšœ
```