---
title: 4ã€åˆ†å¸ƒå¼ä¼šè¯ç®¡ç†
---
## ğŸ“š ç›®å½•

1. [åˆ†å¸ƒå¼ä¼šè¯ç®¡ç†åŸºç¡€](#1-åˆ†å¸ƒå¼ä¼šè¯ç®¡ç†åŸºç¡€)
2. [Spring Sessionæ ¸å¿ƒåŸç†](#2-Spring-Sessionæ ¸å¿ƒåŸç†)
3. [Redis Sessionå­˜å‚¨æ–¹æ¡ˆ](#3-Redis-Sessionå­˜å‚¨æ–¹æ¡ˆ)
4. [é›†ç¾¤ä¼šè¯åŒæ­¥ç­–ç•¥](#4-é›†ç¾¤ä¼šè¯åŒæ­¥ç­–ç•¥)
5. [ä¼šè¯å®‰å…¨ä¸æœ€ä½³å®è·µ](#5-ä¼šè¯å®‰å…¨ä¸æœ€ä½³å®è·µ)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ åˆ†å¸ƒå¼ä¼šè¯ç®¡ç†åŸºç¡€


### 1.1 ä»€ä¹ˆæ˜¯ä¼šè¯(Session)


**ğŸ”¸ é€šä¿—ç†è§£**
```
ç”Ÿæ´»åœºæ™¯ç±»æ¯”ï¼š
åŒ»é™¢å°±è¯Š = Webåº”ç”¨è®¿é—®
ç—…å†æœ¬   = Sessionä¼šè¯
æŒ‚å·     = ç™»å½•
çœ‹ç—…     = ä½¿ç”¨æœåŠ¡
ç—…å†è®°å½• = ä¼šè¯æ•°æ®

æ¯æ¬¡çœ‹ç—…éƒ½å¸¦ç€ç—…å†æœ¬ï¼ŒåŒ»ç”Ÿå°±çŸ¥é“ä½ çš„å†å²æƒ…å†µ
æ¯æ¬¡è¯·æ±‚éƒ½å¸¦ç€Sessionï¼ŒæœåŠ¡å™¨å°±çŸ¥é“ä½ æ˜¯è°
```

**ğŸ”¸ æŠ€æœ¯æ¦‚å¿µ**
```
Sessionæ˜¯ä»€ä¹ˆï¼Ÿ
â†’ æœåŠ¡å™¨ä¸ºæ¯ä¸ªç”¨æˆ·åˆ›å»ºçš„"ä¸´æ—¶æ¡£æ¡ˆ"
â†’ è®°å½•ç”¨æˆ·çš„ç™»å½•çŠ¶æ€ã€è´­ç‰©è½¦ã€åå¥½è®¾ç½®ç­‰
â†’ æœ‰ç”Ÿå‘½å‘¨æœŸï¼Œè¿‡æœŸä¼šè‡ªåŠ¨é”€æ¯

Sessionçš„ä½œç”¨ï¼š
âœ… ä¿æŒç”¨æˆ·ç™»å½•çŠ¶æ€
âœ… å­˜å‚¨ç”¨æˆ·ä¸´æ—¶æ•°æ®
âœ… è·Ÿè¸ªç”¨æˆ·è¡Œä¸º
âœ… å®ç°è´­ç‰©è½¦ç­‰åŠŸèƒ½
```

### 1.2 å•ä½“åº”ç”¨çš„Sessioné—®é¢˜


**ğŸ“Š å•ä½“æ¶æ„Sessionæµç¨‹**
```
ç”¨æˆ·è¯·æ±‚æµç¨‹ï¼š
æµè§ˆå™¨                    æœåŠ¡å™¨
  |                        |
  |--[1] ç™»å½•è¯·æ±‚--------->| 
  |                        |--åˆ›å»ºSession
  |<--[2] è¿”å›SessionID----|   å­˜å‚¨åœ¨å†…å­˜
  |    (Cookie)            |
  |                        |
  |--[3] æºå¸¦SessionID---->|
  |                        |--æŸ¥æ‰¾Session
  |<--[4] è¿”å›ç”¨æˆ·æ•°æ®-----|   è·å–ç”¨æˆ·ä¿¡æ¯
```

**âš ï¸ å•ä½“æ¶æ„çš„å±€é™**
```
é—®é¢˜1ï¼šæœåŠ¡å™¨é‡å¯ â†’ Sessionä¸¢å¤± â†’ ç”¨æˆ·è¢«è¿«é‡æ–°ç™»å½•
é—®é¢˜2ï¼šå•ç‚¹æ•…éšœ   â†’ æœåŠ¡å™¨å®•æœº â†’ æ‰€æœ‰ç”¨æˆ·æ— æ³•è®¿é—®
é—®é¢˜3ï¼šæ‰©å±•å›°éš¾   â†’ æ— æ³•æ¨ªå‘æ‰©å±• â†’ æ€§èƒ½ç“¶é¢ˆ
```

### 1.3 å¾®æœåŠ¡æ¶æ„çš„SessionæŒ‘æˆ˜


**ğŸš¨ åˆ†å¸ƒå¼ç¯å¢ƒçš„æ ¸å¿ƒé—®é¢˜**

| ğŸ†š **å¯¹æ¯”é¡¹** | **å•ä½“åº”ç”¨** | **å¾®æœåŠ¡é›†ç¾¤** |
|--------------|-------------|---------------|
| ğŸ–¥ï¸ **æœåŠ¡å™¨æ•°é‡** | 1å° | å¤šå°(3å°+) |
| ğŸ“¦ **Sessionå­˜å‚¨** | æœåŠ¡å™¨å†…å­˜ | å„è‡ªç‹¬ç«‹å†…å­˜ |
| ğŸ”„ **è´Ÿè½½å‡è¡¡** | ä¸éœ€è¦ | å¿…éœ€ |
| âš ï¸ **æ ¸å¿ƒé—®é¢˜** | æ—  | Sessionä¸å…±äº« |

**ğŸ’¡ é—®é¢˜åœºæ™¯ç¤ºä¾‹**
```
ç”¨æˆ·å°æ˜çš„è®¿é—®æµç¨‹ï¼š

ç¬¬1æ¬¡è¯·æ±‚ â†’ è´Ÿè½½å‡è¡¡ â†’ æœåŠ¡å™¨A
                      â†“
                   åˆ›å»ºSession(ID=abc123)
                   å­˜å‚¨ç”¨æˆ·ä¿¡æ¯

ç¬¬2æ¬¡è¯·æ±‚ â†’ è´Ÿè½½å‡è¡¡ â†’ æœåŠ¡å™¨B
                      â†“
                   æŸ¥æ‰¾Session(ID=abc123)
                   âŒ æ‰¾ä¸åˆ°ï¼(Sessionåœ¨æœåŠ¡å™¨A)
                   â†“
                   è®¤ä¸ºç”¨æˆ·æœªç™»å½•
```

**ğŸ”‘ é—®é¢˜æœ¬è´¨**
- Sessionå­˜å‚¨åœ¨å„æœåŠ¡å™¨çš„å†…å­˜ä¸­
- æœåŠ¡å™¨ä¹‹é—´ä¸å…±äº«å†…å­˜
- è´Ÿè½½å‡è¡¡éšæœºåˆ†é…è¯·æ±‚
- å¯¼è‡´Session"å¤±è”"

---

## 2. ğŸ”§ Spring Sessionæ ¸å¿ƒåŸç†


### 2.1 Spring Sessionæ˜¯ä»€ä¹ˆ


**ğŸ¯ æ ¸å¿ƒå®šä¹‰**
```
Spring Session = Sessionå¤–éƒ¨åŒ–è§£å†³æ–¹æ¡ˆ

ä¼ ç»Ÿæ–¹å¼ï¼šSessionå­˜åœ¨Tomcatå†…å­˜
    âŒ æœåŠ¡å™¨é‡å¯ä¸¢å¤±
    âŒ é›†ç¾¤ä¸å…±äº«

Spring Sessionæ–¹å¼ï¼šSessionå­˜åœ¨å¤–éƒ¨å­˜å‚¨
    âœ… Redisã€MongoDBã€æ•°æ®åº“ç­‰
    âœ… å¤šæœåŠ¡å™¨å…±äº«
    âœ… æŒä¹…åŒ–ä¿å­˜
```

**ğŸ“ éš¾åº¦ç­‰çº§**ï¼šğŸŸ¢ åŸºç¡€ç†è§£ â†’ ğŸŸ¡ é›†æˆé…ç½®

### 2.2 å·¥ä½œåŸç†è§£æ


**ğŸ”„ Spring Sessionè¿ä½œæµç¨‹**
```
ç”¨æˆ·è¯·æ±‚                Spring Session Filter               å¤–éƒ¨å­˜å‚¨(Redis)
   |                           |                                |
   |--[1] å¸¦SessionID--------->|                                |
   |                           |--[2] æ‹¦æˆªè¯·æ±‚                  |
   |                           |                                |
   |                           |--[3] ä»Redisè·å–Session------->|
   |                           |<--[4] è¿”å›Sessionæ•°æ®----------|
   |                           |                                |
   |                           |--[5] åŒ…è£…ä¸ºHttpSession         |
   |<--[6] è¿”å›å“åº”------------|                                |
```

**ğŸ’¡ æ ¸å¿ƒæœºåˆ¶**
```
å…³é”®ç»„ä»¶ï¼š
ğŸ”¸ SessionRepositoryFilter
   â†’ æ‹¦æˆªæ‰€æœ‰HTTPè¯·æ±‚
   â†’ æ›¿æ¢åŸç”ŸHttpSession

ğŸ”¸ SessionRepository
   â†’ å®šä¹‰Sessionå­˜å‚¨æ¥å£
   â†’ æ”¯æŒå¤šç§å­˜å‚¨å®ç°

ğŸ”¸ RedisOperationsSessionRepository
   â†’ Rediså…·ä½“å®ç°
   â†’ è´Ÿè´£CRUDæ“ä½œ
```

### 2.3 å¿«é€Ÿé›†æˆæ­¥éª¤


**ğŸ“¦ Mavenä¾èµ–**
```xml
<!-- Spring Session + Redis -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.session</groupId>
    <artifactId>spring-session-data-redis</artifactId>
</dependency>
```

**âš™ï¸ é…ç½®æ–‡ä»¶**
```yaml
spring:
  # Redisè¿æ¥é…ç½®
  redis:
    host: localhost
    port: 6379
    password: your_password
    
  # Sessioné…ç½®
  session:
    store-type: redis              # ä½¿ç”¨Rediså­˜å‚¨
    timeout: 30m                   # è¿‡æœŸæ—¶é—´30åˆ†é’Ÿ
    redis:
      namespace: spring:session    # Redis keyå‰ç¼€
```

**ğŸ”§ å¯ç”¨é…ç½®**
```java
@Configuration
@EnableRedisHttpSession(maxInactiveIntervalInSeconds = 1800)
public class SessionConfig {
    // æ— éœ€é¢å¤–ä»£ç ï¼Œæ³¨è§£è‡ªåŠ¨é…ç½®
}
```

**âœ… ä½¿ç”¨æ–¹å¼(æ— éœ€æ”¹åŠ¨ä»£ç )**
```java
@RestController
public class UserController {
    
    @PostMapping("/login")
    public String login(HttpSession session, @RequestBody LoginDTO dto) {
        // ä½¿ç”¨æ–¹å¼å®Œå…¨ä¸å˜ï¼Spring Sessionè‡ªåŠ¨æ¥ç®¡
        session.setAttribute("user", userInfo);
        return "ç™»å½•æˆåŠŸ";
    }
    
    @GetMapping("/userInfo")
    public User getUserInfo(HttpSession session) {
        // ä»ä»»ä½•æœåŠ¡å™¨éƒ½èƒ½è·å–åˆ°Session
        return (User) session.getAttribute("user");
    }
}
```

---

## 3. ğŸ’¾ Redis Sessionå­˜å‚¨æ–¹æ¡ˆ


### 3.1 ä¸ºä»€ä¹ˆé€‰æ‹©Redis


**ğŸ†š å­˜å‚¨æ–¹æ¡ˆå¯¹æ¯”**

| ğŸ”§ **å­˜å‚¨æ–¹æ¡ˆ** | **æ€§èƒ½** | **æŒä¹…åŒ–** | **é›†ç¾¤æ”¯æŒ** | **é€‚ç”¨åœºæ™¯** |
|----------------|---------|-----------|-------------|-------------|
| ğŸ—ƒï¸ **å†…å­˜(é»˜è®¤)** | âš¡ æå¿« | âŒ ä¸æ”¯æŒ | âŒ ä¸å…±äº« | å•æœºå¼€å‘ |
| ğŸ—„ï¸ **MySQLæ•°æ®åº“** | ğŸ¢ è¾ƒæ…¢ | âœ… æ”¯æŒ | âœ… å…±äº« | å°è§„æ¨¡ |
| ğŸ“¦ **Redis** | âš¡ å¿« | âœ… æ”¯æŒ | âœ… å…±äº« | **ç”Ÿäº§æ¨è** |
| ğŸƒ **MongoDB** | ğŸš€ å¿« | âœ… æ”¯æŒ | âœ… å…±äº« | å¤§æ•°æ®é‡ |

**â­â­â­ Redisä¼˜åŠ¿**
```
âœ… é«˜æ€§èƒ½ï¼šå†…å­˜å­˜å‚¨ï¼Œè¯»å†™æå¿«
âœ… æ•°æ®ç»“æ„ä¸°å¯Œï¼šæ”¯æŒHashã€Stringã€Setç­‰
âœ… æŒä¹…åŒ–ï¼šæ”¯æŒRDBå’ŒAOFæŒä¹…åŒ–
âœ… åˆ†å¸ƒå¼ï¼šå¤©ç„¶æ”¯æŒé›†ç¾¤å’Œä¸»ä»
âœ… è¿‡æœŸç­–ç•¥ï¼šè‡ªåŠ¨æ¸…ç†è¿‡æœŸSession
```

### 3.2 Rediså­˜å‚¨ç»“æ„


**ğŸ”‘ Keyçš„å‘½åè§„åˆ™**
```
Redisä¸­Sessionçš„å­˜å‚¨ç»“æ„ï¼š

Keyæ ¼å¼ï¼š
spring:session:sessions:{sessionId}

ç¤ºä¾‹ï¼š
spring:session:sessions:a1b2c3d4-e5f6-7890-abcd-ef1234567890
```

**ğŸ“Š æ•°æ®ç»“æ„è¯¦è§£**
```
Redis Hashç»“æ„å­˜å‚¨Sessionï¼š

127.0.0.1:6379> HGETALL spring:session:sessions:abc123

å­—æ®µè¯´æ˜ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Field              â”‚ Value           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ creationTime       â”‚ 1695456789000   â”‚  åˆ›å»ºæ—¶é—´
â”‚ lastAccessedTime   â”‚ 1695456889000   â”‚  æœ€åè®¿é—®æ—¶é—´
â”‚ maxInactiveIntervalâ”‚ 1800            â”‚  è¿‡æœŸæ—¶é—´(ç§’)
â”‚ sessionAttr:user   â”‚ {åºåˆ—åŒ–çš„å¯¹è±¡}   â”‚  ç”¨æˆ·æ•°æ®
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ• è¿‡æœŸæœºåˆ¶**
```
Redisçš„Sessionè¿‡æœŸç­–ç•¥ï¼š

æ–¹å¼1ï¼šè®¾ç½®Keyçš„TTL
   â†’ Redisè‡ªåŠ¨åˆ é™¤è¿‡æœŸkey
   â†’ EXPIREå‘½ä»¤è®¾ç½®

æ–¹å¼2ï¼šSpring Sessionç›‘å¬
   â†’ å®šæ—¶ä»»åŠ¡æ£€æŸ¥è¿‡æœŸ
   â†’ è§¦å‘SessionDestroyedEventäº‹ä»¶
```

### 3.3 åºåˆ—åŒ–é…ç½®


**âš™ï¸ è‡ªå®šä¹‰åºåˆ—åŒ–å™¨**
```java
@Configuration
public class RedisSessionConfig {
    
    @Bean
    public RedisSerializer<Object> springSessionDefaultRedisSerializer() {
        // ä½¿ç”¨JSONåºåˆ—åŒ–ï¼Œä¾¿äºæŸ¥çœ‹å’Œè°ƒè¯•
        return new GenericJackson2JsonRedisSerializer();
    }
}
```

**ğŸ’¡ åºåˆ—åŒ–æ–¹æ¡ˆå¯¹æ¯”**

| åºåˆ—åŒ–æ–¹å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|-----------|------|------|---------|
| **JDKåºåˆ—åŒ–** | å…¼å®¹æ€§å¥½ | ä½“ç§¯å¤§ã€ä¸å¯è¯» | é»˜è®¤æ–¹å¼ |
| **JSONåºåˆ—åŒ–** | å¯è¯»ã€è·¨è¯­è¨€ | æ€§èƒ½ç•¥ä½ | **æ¨èä½¿ç”¨** |
| **Protobuf** | ä½“ç§¯å°ã€å¿« | éœ€è¦å®šä¹‰åè®® | é«˜æ€§èƒ½åœºæ™¯ |

---

## 4. ğŸ”„ é›†ç¾¤ä¼šè¯åŒæ­¥ç­–ç•¥


### 4.1 ä¼šè¯ç²˜æ€§(Session Affinity)


**ğŸ”¸ ä»€ä¹ˆæ˜¯ä¼šè¯ç²˜æ€§**
```
é€šä¿—ç†è§£ï¼š
å°±åƒä½ å»é“¶è¡ŒåŠä¸šåŠ¡ï¼Œæ¯æ¬¡éƒ½æ‰¾åŒä¸€ä¸ªæŸœå‘˜
è¿™æ ·æŸœå‘˜å°±è®¤è¯†ä½ ï¼Œä¸ç”¨æ¯æ¬¡é‡æ–°ä»‹ç»

æŠ€æœ¯å®ç°ï¼š
è´Ÿè½½å‡è¡¡å™¨è®°ä½"ç”¨æˆ·-æœåŠ¡å™¨"çš„å¯¹åº”å…³ç³»
åŒä¸€ç”¨æˆ·çš„è¯·æ±‚å§‹ç»ˆå‘å¾€åŒä¸€å°æœåŠ¡å™¨
```

**ğŸ”§ Nginxé…ç½®ç¤ºä¾‹**
```nginx
upstream backend {
    # ip_hashç­–ç•¥ï¼šæ ¹æ®IPå“ˆå¸Œåˆ†é…
    ip_hash;
    
    server 192.168.1.101:8080;
    server 192.168.1.102:8080;
    server 192.168.1.103:8080;
}

server {
    listen 80;
    location / {
        proxy_pass http://backend;
    }
}
```

**âš–ï¸ ä¼šè¯ç²˜æ€§çš„åˆ©å¼Š**

âœ… **ä¼˜ç‚¹**ï¼š
- å®ç°ç®€å•ï¼Œæ— éœ€é¢å¤–å­˜å‚¨
- Sessionå­˜åœ¨æœåŠ¡å™¨å†…å­˜ï¼Œè®¿é—®å¿«

âŒ **ç¼ºç‚¹**ï¼š
- æœåŠ¡å™¨å®•æœº â†’ ç”¨æˆ·Sessionä¸¢å¤±
- è´Ÿè½½ä¸å‡è¡¡ â†’ æŸå°æœåŠ¡å™¨å‹åŠ›å¤§
- æ‰©ç¼©å®¹å›°éš¾ â†’ å½±å“å·²æœ‰è¿æ¥

**ğŸ’¡ é€‚ç”¨åœºæ™¯**ï¼šå°è§„æ¨¡åº”ç”¨ã€çŸ­æœŸè§£å†³æ–¹æ¡ˆ

### 4.2 Sessionå¤åˆ¶æ–¹æ¡ˆ


**ğŸ”„ å·¥ä½œåŸç†**
```
æœåŠ¡å™¨é›†ç¾¤ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    åŒæ­¥    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    åŒæ­¥    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æœåŠ¡å™¨A   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ æœåŠ¡å™¨B   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ æœåŠ¡å™¨C   â”‚
â”‚ Session1 â”‚           â”‚ Session1 â”‚           â”‚ Session1 â”‚
â”‚ Session2 â”‚           â”‚ Session2 â”‚           â”‚ Session2 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç‰¹ç‚¹ï¼šæ¯å°æœåŠ¡å™¨éƒ½æœ‰å…¨éƒ¨Sessionçš„å‰¯æœ¬
```

**âš ï¸ Sessionå¤åˆ¶çš„é—®é¢˜**
- ç½‘ç»œå¼€é”€å¤§ï¼šé¢‘ç¹åŒæ­¥æ¶ˆè€—å¸¦å®½
- å†…å­˜å ç”¨é«˜ï¼šæ¯å°æœåŠ¡å™¨å­˜å‚¨å…¨éƒ¨Session
- å»¶è¿Ÿé—®é¢˜ï¼šåŒæ­¥æœ‰æ—¶é—´å·®
- æ‰©å±•æ€§å·®ï¼šæœåŠ¡å™¨è¶Šå¤šï¼ŒåŒæ­¥è¶Šæ…¢

**ğŸ¯ Tomcaté›†ç¾¤é…ç½®(äº†è§£å³å¯)**
```xml
<!-- server.xmlé…ç½® -->
<Cluster className="org.apache.catalina.ha.tcp.SimpleTcpCluster">
    <Channel className="org.apache.catalina.tribes.group.GroupChannel">
        <Membership className="org.apache.catalina.tribes.membership.McastService"
                    address="228.0.0.4"
                    port="45564"/>
    </Channel>
    <Valve className="org.apache.catalina.ha.tcp.ReplicationValve"/>
</Cluster>
```

### 4.3 é›†ä¸­å¼Sessionå­˜å‚¨(æ¨èæ–¹æ¡ˆ)


**ğŸ† æœ€ä½³å®è·µæ¶æ„**
```
ç”¨æˆ·è¯·æ±‚æµç¨‹ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·A   â”‚â”€â”€â”€â”€â”€â”€>â”‚ è´Ÿè½½å‡è¡¡å™¨     â”‚â”€â”€â”€â”€â”€â”€>â”‚ æœåŠ¡å™¨A  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â†‘   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â†‘   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                         â”‚        â†“
              â”‚                         â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚                         â””â”€â”€â”€â”‚ æœåŠ¡å™¨B  â”‚
â”‚ ç”¨æˆ·B   â”‚â”€â”€â”€â”˜                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â†“
                                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                            â”‚ æœåŠ¡å™¨C  â”‚
                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â†“
                                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                            â”‚  Redis   â”‚
                                            â”‚ Session  â”‚
                                            â”‚  å­˜å‚¨    â”‚
                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**âœ¨ æ ¸å¿ƒä¼˜åŠ¿**
```
âœ… æ— çŠ¶æ€æœåŠ¡ï¼šæœåŠ¡å™¨é‡å¯ä¸å½±å“Session
âœ… è´Ÿè½½å‡è¡¡ï¼šè¯·æ±‚å¯å‘å¾€ä»»æ„æœåŠ¡å™¨
âœ… é«˜å¯ç”¨ï¼šRedisä¸»ä»ä¿è¯å¯é æ€§
âœ… æ˜“æ‰©å±•ï¼šå¢å‡æœåŠ¡å™¨ä¸å½±å“Session
âœ… æ€§èƒ½å¥½ï¼šRediså†…å­˜å­˜å‚¨ï¼Œè®¿é—®å¿«
```

### 4.4 é«˜å¯ç”¨æ¶æ„è®¾è®¡


**ğŸ”§ Rediså“¨å…µæ¨¡å¼**
```
Sessioné«˜å¯ç”¨æ–¹æ¡ˆï¼š

            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ å“¨å…µ1     â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“ ç›‘æ§
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Redisä¸»èŠ‚ç‚¹â”‚â†’ â”‚Redisä»èŠ‚ç‚¹â”‚â†’â”‚Redisä»èŠ‚ç‚¹â”‚
â”‚ (Master) â”‚  â”‚ (Slave)  â”‚  â”‚ (Slave)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    ä¸»å†™            ä»è¯»           ä»è¯»

ä¸»èŠ‚ç‚¹å®•æœºï¼š
1. å“¨å…µæ£€æµ‹åˆ°æ•…éšœ
2. è‡ªåŠ¨é€‰ä¸¾æ–°ä¸»èŠ‚ç‚¹
3. åº”ç”¨è‡ªåŠ¨åˆ‡æ¢è¿æ¥
```

**âš™ï¸ Springé…ç½®å“¨å…µ**
```yaml
spring:
  redis:
    sentinel:
      master: mymaster               # ä¸»èŠ‚ç‚¹åç§°
      nodes:                         # å“¨å…µèŠ‚ç‚¹
        - 192.168.1.101:26379
        - 192.168.1.102:26379
        - 192.168.1.103:26379
```

---

## 5. ğŸ” ä¼šè¯å®‰å…¨ä¸æœ€ä½³å®è·µ


### 5.1 è·¨åŸŸä¼šè¯ç®¡ç†


**ğŸŒ è·¨åŸŸSessionå…±äº«åœºæ™¯**
```
ä¼ä¸šå¤šåŸŸååœºæ™¯ï¼š
www.shop.com     â†’ å•†åŸä¸»ç«™
m.shop.com       â†’ ç§»åŠ¨ç«¯
admin.shop.com   â†’ ç®¡ç†åå°

éœ€æ±‚ï¼šç”¨æˆ·ç™»å½•ä¸€æ¬¡ï¼Œæ‰€æœ‰å­åŸŸåéƒ½èƒ½è®¿é—®
```

**ğŸ”§ Cookie Domainé…ç½®**
```java
@Configuration
public class SessionConfig {
    
    @Bean
    public CookieSerializer cookieSerializer() {
        DefaultCookieSerializer serializer = new DefaultCookieSerializer();
        
        // è®¾ç½®CookieåŸŸåï¼Œæ”¯æŒå­åŸŸåå…±äº«
        serializer.setDomainName(".shop.com");
        
        // Cookieåç§°
        serializer.setCookieName("JSESSIONID");
        
        // è·¯å¾„
        serializer.setCookiePath("/");
        
        // ä»…HTTPSä¼ è¾“
        serializer.setUseSecureCookie(true);
        
        // é˜²æ­¢JSè®¿é—®
        serializer.setUseHttpOnlyCookie(true);
        
        return serializer;
    }
}
```

**ğŸ”„ è·¨åŸŸè¯·æ±‚å¤„ç†**
```java
@Configuration
public class CorsConfig implements WebMvcConfigurer {
    
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/**")
                .allowedOrigins("http://www.shop.com", "http://m.shop.com")
                .allowCredentials(true)  // å…è®¸æºå¸¦Cookie
                .allowedMethods("GET", "POST", "PUT", "DELETE");
    }
}
```

### 5.2 Sessionå®‰å…¨ç­–ç•¥


**ğŸ›¡ï¸ å®‰å…¨é…ç½®æ¸…å•**

| ğŸ”’ **å®‰å…¨æªæ–½** | **é…ç½®æ–¹å¼** | **é˜²æŠ¤å†…å®¹** |
|----------------|-------------|-------------|
| **HttpOnly** | `setUseHttpOnlyCookie(true)` | é˜²æ­¢XSSæ”»å‡»è¯»å–Cookie |
| **Secure** | `setUseSecureCookie(true)` | ä»…HTTPSä¼ è¾“ |
| **SameSite** | `setSameSite("Strict")` | é˜²æ­¢CSRFæ”»å‡» |
| **å›ºå®šSessionID** | `changeSessionId()` | é˜²æ­¢ä¼šè¯å›ºå®šæ”»å‡» |

**ğŸ”‘ ç™»å½•åæ›´æ¢SessionID**
```java
@PostMapping("/login")
public String login(HttpServletRequest request, @RequestBody LoginDTO dto) {
    // éªŒè¯ç”¨æˆ·åå¯†ç 
    User user = userService.authenticate(dto);
    
    if (user != null) {
        // ç™»å½•æˆåŠŸåæ›´æ¢SessionIDï¼Œé˜²æ­¢ä¼šè¯å›ºå®šæ”»å‡»
        request.changeSessionId();
        
        HttpSession session = request.getSession();
        session.setAttribute("user", user);
        
        return "ç™»å½•æˆåŠŸ";
    }
    return "ç™»å½•å¤±è´¥";
}
```

### 5.3 Sessionè¶…æ—¶ç®¡ç†


**â° è¶…æ—¶ç­–ç•¥é…ç½®**
```yaml
spring:
  session:
    timeout: 30m                    # å…¨å±€è¶…æ—¶æ—¶é—´
    
server:
  servlet:
    session:
      timeout: 30m                  # Servletè¶…æ—¶æ—¶é—´
      cookie:
        max-age: 1800               # Cookieå­˜æ´»æ—¶é—´
```

**ğŸ”§ åŠ¨æ€è®¾ç½®è¶…æ—¶**
```java
@Service
public class SessionService {
    
    // å»¶é•¿æ´»è·ƒç”¨æˆ·çš„Session
    public void extendSession(HttpSession session) {
        // è®¾ç½®ä¸º2å°æ—¶
        session.setMaxInactiveInterval(7200);
    }
    
    // ç›‘å¬Sessioné”€æ¯äº‹ä»¶
    @EventListener
    public void handleSessionDestroyed(SessionDestroyedEvent event) {
        String sessionId = event.getSessionId();
        log.info("Sessioné”€æ¯: {}", sessionId);
        
        // æ¸…ç†ç›¸å…³èµ„æº
        cleanupUserResources(sessionId);
    }
}
```

### 5.4 æ€§èƒ½ä¼˜åŒ–å»ºè®®


**ğŸ“ˆ ä¼˜åŒ–ç­–ç•¥**

âœ… **å‡å°‘Sessionå­˜å‚¨**
```java
// âŒ ä¸å¥½çš„åšæ³•ï¼šå­˜å‚¨å¤§å¯¹è±¡
session.setAttribute("orderList", largeOrderList);

// âœ… å¥½çš„åšæ³•ï¼šåªå­˜å¿…è¦ä¿¡æ¯
session.setAttribute("userId", user.getId());
// éœ€è¦æ—¶ä»æ•°æ®åº“æŸ¥è¯¢
```

âœ… **ä½¿ç”¨Redis Pipeline**
```java
@Configuration
public class RedisConfig {
    
    @Bean
    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory factory) {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(factory);
        
        // å¼€å¯äº‹åŠ¡æ”¯æŒï¼Œæ‰¹é‡æ“ä½œ
        template.setEnableTransactionSupport(true);
        
        return template;
    }
}
```

âœ… **Sessionæ•°æ®å‹ç¼©**
```java
@Bean
public RedisSerializer<Object> springSessionDefaultRedisSerializer() {
    // ä½¿ç”¨å‹ç¼©çš„JSONåºåˆ—åŒ–
    ObjectMapper mapper = new ObjectMapper();
    mapper.activateDefaultTyping(
        mapper.getPolymorphicTypeValidator(),
        ObjectMapper.DefaultTyping.NON_FINAL
    );
    
    return new GenericJackson2JsonRedisSerializer(mapper);
}
```

**ğŸ¯ ç›‘æ§æŒ‡æ ‡**
```
å…³é”®ç›‘æ§é¡¹ï¼š
ğŸ“Š Sessionåˆ›å»ºé€Ÿç‡
ğŸ“Š Sessionæ´»è·ƒæ•°é‡  
ğŸ“Š Rediså‘½ä¸­ç‡
ğŸ“Š å¹³å‡å“åº”æ—¶é—´
ğŸ“Š å¼‚å¸¸Sessionæ•°é‡
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ åˆ†å¸ƒå¼Sessioné—®é¢˜ï¼šé›†ç¾¤ç¯å¢ƒSessionä¸å…±äº«
ğŸ”¸ Spring SessionåŸç†ï¼šå¤–éƒ¨åŒ–å­˜å‚¨ï¼Œé€æ˜æ›¿æ¢
ğŸ”¸ Rediså­˜å‚¨æ–¹æ¡ˆï¼šé«˜æ€§èƒ½ã€æŒä¹…åŒ–ã€æ˜“æ‰©å±•
ğŸ”¸ é›†ç¾¤åŒæ­¥ç­–ç•¥ï¼šç²˜æ€§ã€å¤åˆ¶ã€é›†ä¸­å­˜å‚¨ä¸‰ç§æ–¹æ¡ˆ
ğŸ”¸ å®‰å…¨é…ç½®ï¼šHttpOnlyã€Secureã€è¶…æ—¶ç®¡ç†
```

### 6.2 ä¸‰ç§æ–¹æ¡ˆå¯¹æ¯”æ€»ç»“


| ğŸ†š **æ–¹æ¡ˆ** | **å®ç°éš¾åº¦** | **å¯é æ€§** | **æ€§èƒ½** | **æ¨èæŒ‡æ•°** |
|------------|-------------|-----------|---------|-------------|
| ğŸ”— **ä¼šè¯ç²˜æ€§** | ğŸŸ¢ ç®€å• | ğŸŸ¡ ä¸€èˆ¬ | âš¡ å¿« | â­â­ |
| ğŸ”„ **Sessionå¤åˆ¶** | ğŸŸ¡ ä¸­ç­‰ | ğŸŸ¡ ä¸€èˆ¬ | ğŸ¢ æ…¢ | â­ |
| ğŸ’¾ **Rediså­˜å‚¨** | ğŸŸ¢ ç®€å• | ğŸŸ¢ é«˜ | âš¡ å¿« | â­â­â­ |

### 6.3 å¿«é€Ÿé…ç½®æ£€æŸ¥æ¸…å•


âœ… **é…ç½®æ¸…å•**
- [ ] æ·»åŠ Spring Sessionä¾èµ–
- [ ] é…ç½®Redisè¿æ¥ä¿¡æ¯
- [ ] å¯ç”¨@EnableRedisHttpSession
- [ ] é…ç½®Cookieåºåˆ—åŒ–å™¨
- [ ] è®¾ç½®Sessionè¶…æ—¶æ—¶é—´
- [ ] é…ç½®å®‰å…¨ç­–ç•¥(HttpOnly/Secure)
- [ ] è·¨åŸŸåœºæ™¯è®¾ç½®Domain
- [ ] é…ç½®Redisé«˜å¯ç”¨(å“¨å…µ/é›†ç¾¤)

### 6.4 å®æˆ˜åº”ç”¨è¦ç‚¹


**ğŸ’¡ å¼€å‘å»ºè®®**
```
1. æœ¬åœ°å¼€å‘ï¼šä½¿ç”¨é»˜è®¤å†…å­˜Sessionå³å¯
2. æµ‹è¯•ç¯å¢ƒï¼šé…ç½®å•èŠ‚ç‚¹Redis
3. ç”Ÿäº§ç¯å¢ƒï¼šé…ç½®Rediså“¨å…µ/é›†ç¾¤
4. æ•æ„Ÿæ•°æ®ï¼šé¿å…å­˜å…¥Session
5. å¤§å¯¹è±¡ï¼šä½¿ç”¨ç¼“å­˜æ›¿ä»£Sessionå­˜å‚¨
6. ç›‘æ§ï¼šé…ç½®Sessionç›¸å…³æŒ‡æ ‡ç›‘æ§
```

**ğŸš¨ å¸¸è§é—®é¢˜æ’æŸ¥**
```
é—®é¢˜1ï¼šSessionæ€»æ˜¯å¤±æ•ˆ
   â†’ æ£€æŸ¥Redisè¿æ¥æ˜¯å¦æ­£å¸¸
   â†’ æ£€æŸ¥Cookie Domainé…ç½®
   â†’ æ£€æŸ¥è¶…æ—¶æ—¶é—´è®¾ç½®

é—®é¢˜2ï¼šè·¨åŸŸSessionå…±äº«å¤±è´¥
   â†’ æ£€æŸ¥Cookie Domainæ˜¯å¦æ­£ç¡®
   â†’ æ£€æŸ¥CORSé…ç½®allowCredentials
   â†’ æ£€æŸ¥Cookie SameSiteç­–ç•¥

é—®é¢˜3ï¼šæ€§èƒ½é—®é¢˜
   â†’ æ£€æŸ¥Sessionå­˜å‚¨æ•°æ®å¤§å°
   â†’ æ£€æŸ¥Redisç½‘ç»œå»¶è¿Ÿ
   â†’ è€ƒè™‘ä½¿ç”¨Redis Pipeline
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- åˆ†å¸ƒå¼Sessionæ ¸å¿ƒæ˜¯"å¤–éƒ¨åŒ–å­˜å‚¨"
- Spring Sessionè®©Sessionå…±äº«å˜ç®€å•
- Redisæ˜¯ç”Ÿäº§ç¯å¢ƒæœ€ä½³é€‰æ‹©
- å®‰å…¨é…ç½®ä¸å¯å¿½è§†
- æ€§èƒ½ä¼˜åŒ–ä»å‡å°‘å­˜å‚¨å¼€å§‹