---
title: 1ã€ç½‘å…³å±‚å®‰å…¨è®¾è®¡
---
## ğŸ“š ç›®å½•

1. [ç½‘å…³å±‚å®‰å…¨æ¦‚è¿°](#1-ç½‘å…³å±‚å®‰å…¨æ¦‚è¿°)
2. [Spring Cloud Gatewayæ ¸å¿ƒæ¦‚å¿µ](#2-spring-cloud-gatewayæ ¸å¿ƒæ¦‚å¿µ)
3. [å…¨å±€è¿‡æ»¤å™¨å®ç°è®¤è¯](#3-å…¨å±€è¿‡æ»¤å™¨å®ç°è®¤è¯)
4. [è·¯ç”±çº§åˆ«å®‰å…¨æ§åˆ¶](#4-è·¯ç”±çº§åˆ«å®‰å…¨æ§åˆ¶)
5. [ä»¤ç‰ŒéªŒè¯ä¸è½¬å‘](#5-ä»¤ç‰ŒéªŒè¯ä¸è½¬å‘)
6. [ç»Ÿä¸€è®¤è¯å…¥å£è®¾è®¡](#6-ç»Ÿä¸€è®¤è¯å…¥å£è®¾è®¡)
7. [é™æµä¸ç†”æ–­ä¿æŠ¤](#7-é™æµä¸ç†”æ–­ä¿æŠ¤)
8. [å®‰å…¨ç­–ç•¥ç»Ÿä¸€ç®¡ç†](#8-å®‰å…¨ç­–ç•¥ç»Ÿä¸€ç®¡ç†)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ›¡ï¸ ç½‘å…³å±‚å®‰å…¨æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯ç½‘å…³å±‚å®‰å…¨


> **ğŸ’¡ æ ¸å¿ƒç†è§£**
> ç½‘å…³å±‚å®‰å…¨å°±åƒå°åŒºçš„é—¨å«ï¼Œæ‰€æœ‰è¿›å…¥å¾®æœåŠ¡ç³»ç»Ÿçš„è¯·æ±‚éƒ½å¿…é¡»å…ˆç»è¿‡ç½‘å…³è¿™é“"å®‰å…¨æ£€æŸ¥ç«™"ï¼Œç¡®è®¤èº«ä»½åˆæ³•åæ‰èƒ½æ”¾è¡Œã€‚

**ğŸ”¸ ä¸ºä»€ä¹ˆéœ€è¦ç½‘å…³å®‰å…¨ï¼Ÿ**

æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœæ¯ä¸ªå¾®æœåŠ¡éƒ½è¦è‡ªå·±éªŒè¯ç”¨æˆ·èº«ä»½ï¼š
```
ä¼ ç»Ÿæ–¹å¼ï¼ˆåˆ†æ•£éªŒè¯ï¼‰ï¼š
ç”¨æˆ· â†’ è®¢å•æœåŠ¡ï¼ˆéªŒè¯ï¼‰ â†’ å¤„ç†è¯·æ±‚
ç”¨æˆ· â†’ å•†å“æœåŠ¡ï¼ˆéªŒè¯ï¼‰ â†’ å¤„ç†è¯·æ±‚  
ç”¨æˆ· â†’ ç”¨æˆ·æœåŠ¡ï¼ˆéªŒè¯ï¼‰ â†’ å¤„ç†è¯·æ±‚

é—®é¢˜ï¼š
â€¢ æ¯ä¸ªæœåŠ¡éƒ½è¦å†™ä¸€ééªŒè¯é€»è¾‘ âŒ
â€¢ å®‰å…¨ç­–ç•¥ä¸ç»Ÿä¸€ï¼Œå®¹æ˜“å‡ºæ¼æ´ âŒ
â€¢ ç»´æŠ¤æˆæœ¬é«˜ï¼Œæ”¹ä¸€ä¸ªåœ°æ–¹è¦æ”¹Nä¸ªæœåŠ¡ âŒ
```

ä½¿ç”¨ç½‘å…³å®‰å…¨åï¼š
```
ç½‘å…³ç»Ÿä¸€éªŒè¯ï¼š
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   ç½‘å…³   â”‚ â† ç»Ÿä¸€éªŒè¯å…¥å£
                    â”‚  (å®ˆé—¨å‘˜) â”‚
                    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                          â”‚ éªŒè¯é€šè¿‡
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â†“           â†“           â†“
          è®¢å•æœåŠ¡     å•†å“æœåŠ¡     ç”¨æˆ·æœåŠ¡
         ï¼ˆæ”¾å¿ƒå¤„ç†ï¼‰ ï¼ˆæ”¾å¿ƒå¤„ç†ï¼‰ ï¼ˆæ”¾å¿ƒå¤„ç†ï¼‰

ä¼˜åŠ¿ï¼š
â€¢ ä¸€å¤„éªŒè¯ï¼Œåˆ°å¤„ç”Ÿæ•ˆ âœ…
â€¢ å®‰å…¨ç­–ç•¥ç»Ÿä¸€ç®¡ç† âœ…  
â€¢ åç«¯æœåŠ¡ä¸“æ³¨ä¸šåŠ¡é€»è¾‘ âœ…
```

### 1.2 ç½‘å…³å®‰å…¨çš„æ ¸å¿ƒèŒè´£


**ğŸ¯ ç½‘å…³è¦åšä»€ä¹ˆï¼Ÿ**

| èŒè´£ | **è¯´æ˜** | **ç°å®ç±»æ¯”** |
|------|---------|-------------|
| **èº«ä»½è®¤è¯** | éªŒè¯ç”¨æˆ·æ˜¯è° | é—¨å«æŸ¥èº«ä»½è¯ |
| **æƒé™æ ¡éªŒ** | æ£€æŸ¥èƒ½å¦è®¿é—®æŸèµ„æº | æŸ¥çœ‹é—¨ç¦å¡æƒé™ |
| **ä»¤ç‰Œç®¡ç†** | éªŒè¯å’Œè½¬å‘ä»¤ç‰Œ | æ£€æŸ¥é€šè¡Œè¯æœ‰æ•ˆæœŸ |
| **å®‰å…¨é˜²æŠ¤** | é™æµã€ç†”æ–­ã€é˜²æ”»å‡» | æ§åˆ¶è¿›å‡ºäººæ•° |
| **æ—¥å¿—å®¡è®¡** | è®°å½•è®¿é—®æƒ…å†µ | ç™»è®°å‡ºå…¥è®°å½• |

**ğŸ“‹ å®‰å…¨æ£€æŸ¥æµç¨‹ï¼š**
```
è¯·æ±‚è¿›å…¥ â†’ â‘  æ£€æŸ¥ä»¤ç‰Œ â†’ â‘¡ éªŒè¯èº«ä»½ â†’ â‘¢ æ ¡éªŒæƒé™ â†’ â‘£ æ”¾è¡Œ/æ‹’ç»
           (æœ‰è¯å—)   (è¯æ˜¯çœŸçš„å—)  (è¯èƒ½ç”¨å—)  (é€šè¿‡/æ‹¦æˆª)
```

---

## 2. ğŸŒ Spring Cloud Gatewayæ ¸å¿ƒæ¦‚å¿µ


### 2.1 Gatewayæ˜¯ä»€ä¹ˆ


**Spring Cloud Gateway** æ˜¯Springå®˜æ–¹æä¾›çš„å¾®æœåŠ¡ç½‘å…³ï¼ŒåŸºäºSpring 5ã€Spring Boot 2å’ŒProject Reactoræ„å»ºã€‚

> **ğŸ”§ ç®€å•ç†è§£**
> Gatewayå°±æ˜¯ä¸€ä¸ªæ™ºèƒ½çš„"æµé‡è°ƒåº¦å‘˜"ï¼Œæ—¢èƒ½è½¬å‘è¯·æ±‚åˆ°æ­£ç¡®çš„æœåŠ¡ï¼Œåˆèƒ½åœ¨è½¬å‘å‰ååšå„ç§å®‰å…¨æ£€æŸ¥ã€‚

**åŸºç¡€æ¶æ„ï¼š**
```
å®¢æˆ·ç«¯è¯·æ±‚
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Spring Cloud Gateway   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   è·¯ç”±è§„åˆ™       â”‚  â”‚ â† å†³å®šè¯·æ±‚å»å“ªé‡Œ
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   æ–­è¨€(Predicate)â”‚  â”‚ â† åˆ¤æ–­æ˜¯å¦åŒ¹é…
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   è¿‡æ»¤å™¨(Filter) â”‚  â”‚ â† å¤„ç†è¯·æ±‚/å“åº”
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
åç«¯å¾®æœåŠ¡
```

### 2.2 æ ¸å¿ƒç»„ä»¶è¯¦è§£


**ğŸ”¹ è·¯ç”±(Route)**
```yaml
# ä»€ä¹ˆæ˜¯è·¯ç”±ï¼Ÿå°±æ˜¯"è¯·æ±‚åœ°å€"å’Œ"ç›®æ ‡æœåŠ¡"çš„æ˜ å°„å…³ç³»

spring:
  cloud:
    gateway:
      routes:
        - id: order-service           # è·¯ç”±IDï¼ˆåå­—ï¼‰
          uri: lb://order-service     # ç›®æ ‡æœåŠ¡åœ°å€ï¼ˆlbè¡¨ç¤ºè´Ÿè½½å‡è¡¡ï¼‰
          predicates:
            - Path=/api/order/**      # åŒ¹é…è§„åˆ™ï¼šè·¯å¾„ä»¥/api/order/å¼€å¤´
```

**é€šä¿—ç†è§£ï¼š** 
- ç”¨æˆ·è®¿é—® `/api/order/123`
- Gatewayçœ‹åˆ°è¿™ä¸ªè·¯å¾„ï¼Œè¯´ï¼š"å“¦ï¼Œè¿™æ˜¯è®¢å•ç›¸å…³çš„ï¼Œè½¬å‘ç»™order-service"

**ğŸ”¹ æ–­è¨€(Predicate)**

æ–­è¨€å°±æ˜¯"åˆ¤æ–­æ¡ä»¶"ï¼Œå†³å®šè¿™ä¸ªè¯·æ±‚æ˜¯å¦ç¬¦åˆè·¯ç”±è§„åˆ™ã€‚

```yaml
predicates:
  - Path=/api/**           # è·¯å¾„åŒ¹é…
  - Method=GET,POST        # è¯·æ±‚æ–¹æ³•åŒ¹é…
  - Header=X-Request-Id    # è¯·æ±‚å¤´åŒ¹é…
  - After=2024-01-01T00:00:00+08:00  # æ—¶é—´åŒ¹é…
```

**ğŸ”¹ è¿‡æ»¤å™¨(Filter)**

è¿‡æ»¤å™¨æ˜¯"è¯·æ±‚/å“åº”çš„å¤„ç†å™¨"ï¼Œå¯ä»¥ä¿®æ”¹è¯·æ±‚ã€éªŒè¯èº«ä»½ã€è®°å½•æ—¥å¿—ç­‰ã€‚

```
è¯·æ±‚å¤„ç†é“¾ï¼š
è¯·æ±‚è¿›å…¥ â†’ å‰ç½®è¿‡æ»¤å™¨ â†’ è·¯ç”±è½¬å‘ â†’ åç«¯æœåŠ¡ â†’ åç½®è¿‡æ»¤å™¨ â†’ è¿”å›å“åº”
         (å¯ä»¥ä¿®æ”¹è¯·æ±‚)              (å¯ä»¥ä¿®æ”¹å“åº”)
```

---

## 3. ğŸ” å…¨å±€è¿‡æ»¤å™¨å®ç°è®¤è¯


### 3.1 å…¨å±€è¿‡æ»¤å™¨æ˜¯ä»€ä¹ˆ


> **ğŸ’¡ æ ¸å¿ƒæ¦‚å¿µ**
> å…¨å±€è¿‡æ»¤å™¨(GlobalFilter)å°±åƒæœºåœºå®‰æ£€ï¼Œ**æ‰€æœ‰ä¹˜å®¢**ï¼ˆè¯·æ±‚ï¼‰éƒ½å¿…é¡»ç»è¿‡ï¼Œä¸ç®¡ä½ å»å“ªä¸ªèˆªç«™æ¥¼ï¼ˆæœåŠ¡ï¼‰ã€‚

**å…¨å±€è¿‡æ»¤å™¨ vs å±€éƒ¨è¿‡æ»¤å™¨ï¼š**

| ç±»å‹ | **ä½œç”¨èŒƒå›´** | **ä½¿ç”¨åœºæ™¯** |
|------|------------|-------------|
| **å…¨å±€è¿‡æ»¤å™¨** | æ‰€æœ‰è·¯ç”± | ç»Ÿä¸€è®¤è¯ã€æ—¥å¿—è®°å½• |
| **å±€éƒ¨è¿‡æ»¤å™¨** | ç‰¹å®šè·¯ç”± | ç‰¹æ®Šå¤„ç†ã€ä¸ªæ€§åŒ–é€»è¾‘ |

### 3.2 ç¼–å†™è®¤è¯å…¨å±€è¿‡æ»¤å™¨


**ğŸ“ å®æˆ˜æ¡ˆä¾‹ï¼šJWTä»¤ç‰ŒéªŒè¯**

```java
@Component
public class AuthGlobalFilter implements GlobalFilter, Ordered {
    
    @Autowired
    private JwtTokenUtil jwtTokenUtil;
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        // 1. è·å–è¯·æ±‚å¯¹è±¡
        ServerHttpRequest request = exchange.getRequest();
        
        // 2. æ”¾è¡Œç™½åå•ï¼ˆç™»å½•ã€æ³¨å†Œç­‰ä¸éœ€è¦è®¤è¯çš„æ¥å£ï¼‰
        if (isWhiteList(request.getPath().value())) {
            return chain.filter(exchange);
        }
        
        // 3. ä»è¯·æ±‚å¤´è·å–Token
        String token = request.getHeaders().getFirst("Authorization");
        
        // 4. éªŒè¯Token
        if (token == null || !token.startsWith("Bearer ")) {
            return unauthorized(exchange, "æœªæä¾›è®¤è¯ä»¤ç‰Œ");
        }
        
        // 5. è§£æTokenè·å–ç”¨æˆ·ä¿¡æ¯
        try {
            String actualToken = token.substring(7); // å»æ‰"Bearer "å‰ç¼€
            String userId = jwtTokenUtil.getUserIdFromToken(actualToken);
            
            // 6. å°†ç”¨æˆ·ä¿¡æ¯ä¼ é€’ç»™åç«¯æœåŠ¡
            ServerHttpRequest newRequest = request.mutate()
                .header("X-User-Id", userId)
                .build();
            
            return chain.filter(exchange.mutate().request(newRequest).build());
            
        } catch (Exception e) {
            return unauthorized(exchange, "ä»¤ç‰ŒéªŒè¯å¤±è´¥");
        }
    }
    
    // ç™½åå•åˆ¤æ–­
    private boolean isWhiteList(String path) {
        List<String> whiteList = Arrays.asList("/api/login", "/api/register");
        return whiteList.stream().anyMatch(path::startsWith);
    }
    
    // è¿”å›æœªè®¤è¯å“åº”
    private Mono<Void> unauthorized(ServerWebExchange exchange, String message) {
        exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);
        exchange.getResponse().getHeaders().setContentType(MediaType.APPLICATION_JSON);
        
        String result = "{\"code\":401,\"message\":\"" + message + "\"}";
        DataBuffer buffer = exchange.getResponse()
            .bufferFactory()
            .wrap(result.getBytes());
        
        return exchange.getResponse().writeWith(Mono.just(buffer));
    }
    
    @Override
    public int getOrder() {
        return -100; // ä¼˜å…ˆçº§ï¼Œæ•°å­—è¶Šå°è¶Šå…ˆæ‰§è¡Œ
    }
}
```

**ğŸ” ä»£ç è§£è¯»ï¼š**

**æ­¥éª¤1-2ï¼š** æ£€æŸ¥æ˜¯å¦æ˜¯ç™½åå•è·¯å¾„
- ç™»å½•ã€æ³¨å†Œç­‰æ¥å£ä¸éœ€è¦è®¤è¯ï¼Œç›´æ¥æ”¾è¡Œ
- å°±åƒæœºåœºå‘˜å·¥é€šé“ï¼Œä¸ç”¨å®‰æ£€

**æ­¥éª¤3-4ï¼š** è·å–å¹¶æ£€æŸ¥Token
- ä»è¯·æ±‚å¤´çš„`Authorization`å­—æ®µå–Token
- æ ¼å¼å¿…é¡»æ˜¯ï¼š`Bearer eyJhbGc...`ï¼ˆBeareræ˜¯å›ºå®šå‰ç¼€ï¼‰

**æ­¥éª¤5ï¼š** è§£æToken
- éªŒè¯Tokenæ˜¯å¦è¿‡æœŸã€æ˜¯å¦è¢«ç¯¡æ”¹
- æå–ç”¨æˆ·IDç­‰ä¿¡æ¯

**æ­¥éª¤6ï¼š** ä¼ é€’ç”¨æˆ·ä¿¡æ¯
- æŠŠç”¨æˆ·IDæ”¾åˆ°è¯·æ±‚å¤´`X-User-Id`ä¸­
- åç«¯æœåŠ¡å°±çŸ¥é“æ˜¯è°åœ¨è®¿é—®äº†

### 3.3 è¿‡æ»¤å™¨æ‰§è¡Œé¡ºåº


**å¤šä¸ªè¿‡æ»¤å™¨çš„æ‰§è¡Œé¡ºåºï¼š**
```
â”Œâ”€â”€â”€ Order=-100 â”€â”€â”€â”€â”
â”‚  è®¤è¯è¿‡æ»¤å™¨       â”‚ â† æœ€å…ˆæ‰§è¡Œï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€ Order=0 â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ—¥å¿—è¿‡æ»¤å™¨       â”‚ â† ç¬¬äºŒæ‰§è¡Œ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€ Order=100 â”€â”€â”€â”€â”€â”
â”‚  ä¸šåŠ¡è¿‡æ»¤å™¨       â”‚ â† æœ€åæ‰§è¡Œ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**âš¡ è®°å¿†è¦ç‚¹ï¼š**
- Orderå€¼**è¶Šå°**ï¼Œä¼˜å…ˆçº§**è¶Šé«˜**
- è´Ÿæ•° > 0 > æ­£æ•°
- è®¤è¯è¿‡æ»¤å™¨é€šå¸¸è®¾ç½®ä¸ºè´Ÿæ•°ï¼Œç¡®ä¿æœ€å…ˆæ‰§è¡Œ

---

## 4. ğŸ”’ è·¯ç”±çº§åˆ«å®‰å…¨æ§åˆ¶


### 4.1 ä¸ºä»€ä¹ˆéœ€è¦è·¯ç”±çº§åˆ«æ§åˆ¶


> **ğŸ¯ å®é™…åœºæ™¯**
> ä¸æ˜¯æ‰€æœ‰æ¥å£éƒ½éœ€è¦åŒæ ·çš„å®‰å…¨çº§åˆ«ã€‚æ¯”å¦‚ï¼š
> - æ™®é€šç”¨æˆ·èƒ½çœ‹å•†å“åˆ—è¡¨ï¼Œä½†ä¸èƒ½åˆ é™¤å•†å“
> - ç®¡ç†å‘˜èƒ½è®¿é—®æ‰€æœ‰æ¥å£
> - VIPç”¨æˆ·è®¿é—®æœ‰ä¼˜å…ˆçº§

**è·¯ç”±çº§åˆ«å®‰å…¨ = ç»†ç²’åº¦æƒé™æ§åˆ¶**

### 4.2 åŸºäºè§’è‰²çš„è·¯ç”±æ§åˆ¶


**é…ç½®ç¤ºä¾‹ï¼š**
```yaml
spring:
  cloud:
    gateway:
      routes:
        # æ™®é€šç”¨æˆ·è·¯ç”±
        - id: user-api
          uri: lb://user-service
          predicates:
            - Path=/api/user/**
          filters:
            - name: RequireRole
              args:
                roles: USER,VIP        # å…è®¸USERå’ŒVIPè§’è‰²è®¿é—®
        
        # ç®¡ç†å‘˜è·¯ç”±
        - id: admin-api
          uri: lb://admin-service
          predicates:
            - Path=/api/admin/**
          filters:
            - name: RequireRole
              args:
                roles: ADMIN           # åªå…è®¸ADMINè§’è‰²è®¿é—®
```

**è‡ªå®šä¹‰è§’è‰²éªŒè¯è¿‡æ»¤å™¨ï¼š**
```java
@Component
public class RequireRoleGatewayFilterFactory 
    extends AbstractGatewayFilterFactory<RequireRoleGatewayFilterFactory.Config> {
    
    public RequireRoleGatewayFilterFactory() {
        super(Config.class);
    }
    
    @Override
    public GatewayFilter apply(Config config) {
        return (exchange, chain) -> {
            // ä»è¯·æ±‚å¤´è·å–ç”¨æˆ·è§’è‰²ï¼ˆç”±è®¤è¯è¿‡æ»¤å™¨æ”¾å…¥ï¼‰
            String userRoles = exchange.getRequest()
                .getHeaders()
                .getFirst("X-User-Roles");
            
            if (userRoles == null) {
                return forbidden(exchange, "æœªæ£€æµ‹åˆ°ç”¨æˆ·è§’è‰²");
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æƒé™
            boolean hasRole = Arrays.stream(config.getRoles().split(","))
                .anyMatch(userRoles::contains);
            
            if (!hasRole) {
                return forbidden(exchange, "æƒé™ä¸è¶³");
            }
            
            return chain.filter(exchange);
        };
    }
    
    // é…ç½®ç±»
    public static class Config {
        private String roles;
        
        public String getRoles() {
            return roles;
        }
        
        public void setRoles(String roles) {
            this.roles = roles;
        }
    }
    
    private Mono<Void> forbidden(ServerWebExchange exchange, String message) {
        exchange.getResponse().setStatusCode(HttpStatus.FORBIDDEN);
        // ... è¿”å›403å“åº”
    }
}
```

**ğŸ§  ç†è§£è¦ç‚¹ï¼š**
- æ¯ä¸ªè·¯ç”±å¯ä»¥é…ç½®ä¸åŒçš„è®¿é—®è§’è‰²
- è¿‡æ»¤å™¨è¯»å–ç”¨æˆ·è§’è‰²è¿›è¡Œå¯¹æ¯”
- ä¸åŒ¹é…ç›´æ¥è¿”å›403 Forbidden

---

## 5. ğŸ« ä»¤ç‰ŒéªŒè¯ä¸è½¬å‘


### 5.1 ä»¤ç‰ŒéªŒè¯æµç¨‹


**å®Œæ•´çš„ä»¤ç‰Œå¤„ç†é“¾ï¼š**
```
â‘  å®¢æˆ·ç«¯æºå¸¦Token
    â†“
â‘¡ ç½‘å…³éªŒè¯Token
    â†“
â‘¢ è§£æè·å–ç”¨æˆ·ä¿¡æ¯
    â†“
â‘£ å°†ä¿¡æ¯æ·»åŠ åˆ°è¯·æ±‚å¤´
    â†“
â‘¤ è½¬å‘ç»™åç«¯æœåŠ¡
    â†“
â‘¥ åç«¯ä»è¯·æ±‚å¤´è¯»å–ç”¨æˆ·ä¿¡æ¯
```

### 5.2 ä»¤ç‰Œè½¬å‘ç­–ç•¥


**ğŸ”¸ æ•æ„Ÿä¿¡æ¯å¤„ç†ï¼š**

```java
@Component
public class TokenTransformFilter implements GlobalFilter {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        ServerHttpRequest request = exchange.getRequest();
        
        // 1. ä»Authorizationå¤´è·å–åŸå§‹Token
        String originalToken = request.getHeaders().getFirst("Authorization");
        
        if (originalToken != null && originalToken.startsWith("Bearer ")) {
            String token = originalToken.substring(7);
            
            // 2. éªŒè¯Token
            Claims claims = jwtUtil.parseToken(token);
            
            // 3. æå–å…³é”®ä¿¡æ¯
            String userId = claims.get("userId", String.class);
            String userName = claims.get("userName", String.class);
            String roles = claims.get("roles", String.class);
            
            // 4. æ„å»ºæ–°çš„è¯·æ±‚ï¼ˆæ·»åŠ ç”¨æˆ·ä¿¡æ¯å¤´ï¼‰
            ServerHttpRequest newRequest = request.mutate()
                .header("X-User-Id", userId)
                .header("X-User-Name", userName)
                .header("X-User-Roles", roles)
                // å¯é€‰ï¼šç§»é™¤åŸå§‹Tokenï¼ˆé˜²æ­¢æ³„éœ²ï¼‰
                // .headers(headers -> headers.remove("Authorization"))
                .build();
            
            return chain.filter(exchange.mutate().request(newRequest).build());
        }
        
        return chain.filter(exchange);
    }
}
```

**âš ï¸ å®‰å…¨å»ºè®®ï¼š**

| åšæ³• | **å®‰å…¨æ€§** | **è¯´æ˜** |
|------|----------|---------|
| è½¬å‘åŸå§‹Token | â­â­â˜† | åç«¯æœåŠ¡ä¹Ÿèƒ½éªŒè¯Tokenï¼Œä½†æœ‰æ³„éœ²é£é™© |
| åªä¼ ç”¨æˆ·ä¿¡æ¯ | â­â­â­ | æ¨èæ–¹å¼ï¼Œåç«¯æ— éœ€çŸ¥é“Token |
| å†…éƒ¨Tokenæ›¿æ¢ | â­â­â­â­ | ç½‘å…³éªŒè¯åç”Ÿæˆå†…éƒ¨Tokenï¼Œæ›´å®‰å…¨ |

---

## 6. ğŸšª ç»Ÿä¸€è®¤è¯å…¥å£è®¾è®¡


### 6.1 è®¤è¯å…¥å£æ¶æ„


**é›†ä¸­å¼è®¤è¯æµç¨‹ï¼š**
```
ç”¨æˆ·ç™»å½•
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è®¤è¯æœåŠ¡    â”‚
â”‚ (Auth Service)â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ é¢å‘Token
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   APIç½‘å…³    â”‚ â† æ‰€æœ‰è¯·æ±‚ç»Ÿä¸€å…¥å£
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ éªŒè¯Token
   â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”
   â†“        â†“     â†“     â†“
 è®¢å•æœåŠ¡  å•†å“  ç”¨æˆ·  æ”¯ä»˜
```

### 6.2 ç»Ÿä¸€ç™»å½•å¤„ç†


**ç½‘å…³ç™»å½•è·¯ç”±é…ç½®ï¼š**
```yaml
spring:
  cloud:
    gateway:
      routes:
        # ç™»å½•è·¯ç”±
        - id: auth-login
          uri: lb://auth-service
          predicates:
            - Path=/api/login
          filters:
            - StripPrefix=1       # å»æ‰/apiå‰ç¼€
        
        # ç™»å‡ºè·¯ç”±  
        - id: auth-logout
          uri: lb://auth-service
          predicates:
            - Path=/api/logout
          filters:
            - name: TokenBlacklist  # å°†TokenåŠ å…¥é»‘åå•
```

**ç™»å½•å“åº”å¤„ç†ï¼š**
```java
@Component
public class LoginResponseFilter implements GlobalFilter {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        return chain.filter(exchange).then(Mono.fromRunnable(() -> {
            // åªå¤„ç†ç™»å½•æ¥å£çš„å“åº”
            if (exchange.getRequest().getPath().value().equals("/api/login")) {
                ServerHttpResponse response = exchange.getResponse();
                
                // å¯ä»¥æ·»åŠ é¢å¤–çš„å“åº”å¤´
                response.getHeaders().add("X-Auth-Server", "Gateway");
                
                // è®°å½•ç™»å½•æ—¥å¿—
                logLoginEvent(exchange);
            }
        }));
    }
    
    private void logLoginEvent(ServerWebExchange exchange) {
        // è®°å½•ç™»å½•ä¿¡æ¯ï¼šIPã€æ—¶é—´ã€User-Agentç­‰
    }
}
```

---

## 7. ğŸ›¡ï¸ é™æµä¸ç†”æ–­ä¿æŠ¤


### 7.1 ä¸ºä»€ä¹ˆéœ€è¦é™æµç†”æ–­


> **ğŸ’¡ ç”Ÿæ´»ç±»æ¯”**
> - **é™æµ**ï¼šå°±åƒæ™¯åŒºé™åˆ¶æ¯å°æ—¶è¿›å…¥äººæ•°ï¼Œé˜²æ­¢æ‹¥æŒ¤è¸©è¸
> - **ç†”æ–­**ï¼šå°±åƒç”µè·¯ä¿é™©ä¸ï¼Œè´Ÿè½½è¿‡å¤§è‡ªåŠ¨æ–­å¼€ä¿æŠ¤ç³»ç»Ÿ

**ğŸ”¸ é™æµ(Rate Limiting)**

é˜²æ­¢æ¶æ„è¯·æ±‚æˆ–çªå‘æµé‡å‹å®ç³»ç»Ÿã€‚

**å†…ç½®é™æµé…ç½®ï¼š**
```yaml
spring:
  cloud:
    gateway:
      routes:
        - id: limited-api
          uri: lb://backend-service
          predicates:
            - Path=/api/**
          filters:
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 10  # æ¯ç§’å…è®¸10ä¸ªè¯·æ±‚
                redis-rate-limiter.burstCapacity: 20  # çªå‘å®¹é‡20
                key-resolver: "#{@userKeyResolver}"   # é™æµKeyç”Ÿæˆå™¨
```

**è‡ªå®šä¹‰é™æµKeyç”Ÿæˆå™¨ï¼š**
```java
@Bean
public KeyResolver userKeyResolver() {
    return exchange -> {
        // æ ¹æ®ç”¨æˆ·IDé™æµ
        String userId = exchange.getRequest()
            .getHeaders()
            .getFirst("X-User-Id");
        
        return Mono.just(userId != null ? userId : "anonymous");
    };
}

// ä¹Ÿå¯ä»¥æ ¹æ®IPé™æµ
@Bean
public KeyResolver ipKeyResolver() {
    return exchange -> {
        String ip = exchange.getRequest()
            .getRemoteAddress()
            .getAddress()
            .getHostAddress();
        
        return Mono.just(ip);
    };
}
```

### 7.2 ç†”æ–­ä¿æŠ¤


**ğŸ”¸ ç†”æ–­(Circuit Breaker)**

å½“åç«¯æœåŠ¡å¼‚å¸¸æ—¶ï¼Œå¿«é€Ÿå¤±è´¥è€Œä¸æ˜¯ä¸€ç›´ç­‰å¾…ã€‚

**é›†æˆHystrixç†”æ–­ï¼š**
```yaml
spring:
  cloud:
    gateway:
      routes:
        - id: resilient-api
          uri: lb://backend-service
          predicates:
            - Path=/api/**
          filters:
            - name: Hystrix
              args:
                name: fallbackCmd
                fallbackUri: forward:/fallback  # ç†”æ–­åçš„é™çº§å¤„ç†
```

**é™çº§å¤„ç†Controllerï¼š**
```java
@RestController
public class FallbackController {
    
    @RequestMapping("/fallback")
    public ResponseEntity<Map<String, Object>> fallback() {
        Map<String, Object> result = new HashMap<>();
        result.put("code", 503);
        result.put("message", "æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•");
        result.put("data", null);
        
        return ResponseEntity
            .status(HttpStatus.SERVICE_UNAVAILABLE)
            .body(result);
    }
}
```

**ğŸ§  ç†”æ–­çŠ¶æ€æœºï¼š**
```
æ­£å¸¸çŠ¶æ€ â”€â”€å¤±è´¥æ¬¡æ•°è¿‡å¤šâ”€â”€> ç†”æ–­çŠ¶æ€
    â†‘                         â†“
    â””â”€â”€â”€â”€ç­‰å¾…æ¢å¤æ—¶é—´â”€â”€â”€â”€ åŠå¼€çŠ¶æ€
```

---

## 8. âš™ï¸ å®‰å…¨ç­–ç•¥ç»Ÿä¸€ç®¡ç†


### 8.1 é›†ä¸­é…ç½®ç®¡ç†


**ä½¿ç”¨é…ç½®ä¸­å¿ƒç»Ÿä¸€ç®¡ç†å®‰å…¨ç­–ç•¥ï¼š**

```yaml
# application.yml (é…ç½®ä¸­å¿ƒ)
gateway:
  security:
    # ç™½åå•é…ç½®
    whitelist:
      - /api/login
      - /api/register
      - /api/public/**
    
    # Tokené…ç½®
    jwt:
      secret: ${JWT_SECRET:defaultSecret}
      expiration: 7200  # 2å°æ—¶
    
    # é™æµé…ç½®
    rate-limit:
      default-limit: 100    # é»˜è®¤æ¯ç§’100æ¬¡
      vip-limit: 500        # VIPç”¨æˆ·æ¯ç§’500æ¬¡
    
    # é»‘åå•IP
    blacklist-ips:
      - 192.168.1.100
      - 10.0.0.50
```

### 8.2 åŠ¨æ€å®‰å…¨ç­–ç•¥


**å®æ—¶æ›´æ–°å®‰å…¨è§„åˆ™ï¼š**

```java
@Component
@RefreshScope  // æ”¯æŒé…ç½®åŠ¨æ€åˆ·æ–°
public class SecurityConfigProperties {
    
    @Value("${gateway.security.whitelist}")
    private List<String> whitelist;
    
    @Value("${gateway.security.blacklist-ips}")
    private List<String> blacklistIps;
    
    public boolean isWhitelisted(String path) {
        return whitelist.stream()
            .anyMatch(pattern -> pathMatcher.match(pattern, path));
    }
    
    public boolean isBlacklisted(String ip) {
        return blacklistIps.contains(ip);
    }
}
```

**ğŸ”§ å®è·µå»ºè®®ï¼š**

| é…ç½®é¡¹ | **ç®¡ç†æ–¹å¼** | **æ›´æ–°æ–¹å¼** |
|--------|------------|------------|
| ç™½åå•è·¯å¾„ | é…ç½®ä¸­å¿ƒ | å®æ—¶åˆ·æ–° |
| JWTå¯†é’¥ | ç¯å¢ƒå˜é‡ | é‡å¯æ›´æ–° |
| é™æµè§„åˆ™ | Redis | å®æ—¶è°ƒæ•´ |
| é»‘åå•IP | æ•°æ®åº“ | å®šæ—¶åŒæ­¥ |

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ ç½‘å…³å®‰å…¨æ¶æ„ï¼šç»Ÿä¸€å…¥å£ã€é›†ä¸­éªŒè¯ã€ç­–ç•¥ç®¡ç†
ğŸ”¸ å…¨å±€è¿‡æ»¤å™¨ï¼šæ‰€æœ‰è¯·æ±‚å¿…ç»ä¹‹è·¯ï¼Œå®ç°TokenéªŒè¯
ğŸ”¸ è·¯ç”±çº§å®‰å…¨ï¼šç»†ç²’åº¦æƒé™æ§åˆ¶ï¼Œä¸åŒè·¯ç”±ä¸åŒç­–ç•¥
ğŸ”¸ ä»¤ç‰ŒéªŒè¯è½¬å‘ï¼šéªŒè¯Tokenã€æå–ä¿¡æ¯ã€ä¼ é€’ç»™åç«¯
ğŸ”¸ é™æµç†”æ–­ï¼šä¿æŠ¤ç³»ç»Ÿç¨³å®šæ€§ï¼Œé˜²æ­¢é›ªå´©æ•ˆåº”
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ç½‘å…³å®‰å…¨ä¸‰å¤§èŒè´£**
```
â‘  å®ˆé—¨å‘˜ï¼šéªŒè¯èº«ä»½ï¼Œæ‹¦æˆªéæ³•è¯·æ±‚
â‘¡ ç¿»è¯‘å®˜ï¼šè§£æTokenï¼Œä¼ é€’ç”¨æˆ·ä¿¡æ¯
â‘¢ ä¿æŠ¤ä¼ï¼šé™æµç†”æ–­ï¼Œä¿æŠ¤åç«¯æœåŠ¡
```

**ğŸ”¹ è¿‡æ»¤å™¨æ‰§è¡Œé“¾**
```
è¯·æ±‚è¿›å…¥
  â†“
è®¤è¯è¿‡æ»¤å™¨(Order=-100)  â† æœ€å…ˆæ‰§è¡Œ
  â†“
è·¯ç”±è¿‡æ»¤å™¨(Order=0)      â† ä¸­é—´æ‰§è¡Œ
  â†“
ä¸šåŠ¡è¿‡æ»¤å™¨(Order=100)    â† æœ€åæ‰§è¡Œ
  â†“
è½¬å‘åˆ°åç«¯
```

**ğŸ”¹ å®‰å…¨ç­–ç•¥åˆ†å±‚**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç½‘å…³å±‚å®‰å…¨  â”‚ â† ç»Ÿä¸€è®¤è¯ã€é™æµç†”æ–­
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æœåŠ¡å±‚å®‰å…¨  â”‚ â† ä¸šåŠ¡æƒé™ã€æ•°æ®æ ¡éªŒ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ•°æ®å±‚å®‰å…¨  â”‚ â† æ•°æ®åŠ å¯†ã€è®¿é—®æ§åˆ¶
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.3 å®æˆ˜å¼€å‘å»ºè®®


**âœ… æœ€ä½³å®è·µï¼š**
- è®¤è¯è¿‡æ»¤å™¨ä¼˜å…ˆçº§è®¾ç½®ä¸ºè´Ÿæ•°ï¼Œç¡®ä¿æœ€å…ˆæ‰§è¡Œ
- æ•æ„Ÿä¿¡æ¯ä¸è¦åœ¨ç½‘å…³å’ŒæœåŠ¡é—´ä¼ é€’åŸå§‹Token
- ç™½åå•é…ç½®é›†ä¸­ç®¡ç†ï¼Œé¿å…ç¡¬ç¼–ç 
- é™æµè§„åˆ™æ ¹æ®ç”¨æˆ·ç­‰çº§å·®å¼‚åŒ–é…ç½®
- æ‰€æœ‰å®‰å…¨æ—¥å¿—ç»Ÿä¸€è®°å½•ä¾¿äºå®¡è®¡

**âš ï¸ å¸¸è§é™·é˜±ï¼š**
- å¿˜è®°é…ç½®ç™½åå•ï¼Œå¯¼è‡´ç™»å½•æ¥å£ä¹Ÿè¢«æ‹¦æˆª
- è¿‡æ»¤å™¨Orderå€¼è®¾ç½®é”™è¯¯ï¼Œè®¤è¯ä¸ç”Ÿæ•ˆ
- Tokenè¿‡æœŸæ—¶é—´è¿‡é•¿ï¼Œå­˜åœ¨å®‰å…¨éšæ‚£
- é™æµç²’åº¦è¿‡ç²—ï¼Œå½±å“æ­£å¸¸ç”¨æˆ·ä½“éªŒ
- ç†”æ–­é˜ˆå€¼è®¾ç½®ä¸åˆç†ï¼Œè¯¯ç†”æ–­æˆ–ä¸ç†”æ–­

### 9.4 å¿«é€Ÿè®°å¿†å£è¯€


```
ç½‘å…³å®ˆæŠ¤ç¬¬ä¸€å…³ï¼ŒTokenéªŒè¯æ˜¯å…³é”®
å…¨å±€è¿‡æ»¤åšè®¤è¯ï¼Œè·¯ç”±æ§åˆ¶ç»†ç²’åº¦
ä»¤ç‰Œè½¬å‘ä¼ ä¿¡æ¯ï¼Œé™æµç†”æ–­ä¿ç¨³å®š
ç­–ç•¥é›†ä¸­å¥½ç®¡ç†ï¼Œå®‰å…¨æ—¥å¿—è¦å®¡è®¡
```

**ğŸ”— ç›¸å…³çŸ¥è¯†ç‚¹ï¼š**
- ğŸ“– å‚è€ƒï¼š[JWTä»¤ç‰ŒåŸç†](#) | [Spring Securityé›†æˆ](#)
- ğŸ“ å‰ç½®çŸ¥è¯†ï¼šéœ€æŒæ¡Spring Bootã€JWTåŸºç¡€
- ğŸš€ åç»­å­¦ä¹ ï¼šæœåŠ¡é—´è®¤è¯ã€OAuth2.0é›†æˆ

---

**ğŸ’¡ å­¦ä¹ å»ºè®®**

å¯¹äºæ–°æ‰‹æ¥è¯´ï¼Œå»ºè®®æŒ‰ä»¥ä¸‹é¡ºåºå­¦ä¹ ï¼š
1. å…ˆç†è§£ç½‘å…³çš„ä½œç”¨å’Œå¿…è¦æ€§
2. æŒæ¡å…¨å±€è¿‡æ»¤å™¨çš„ç¼–å†™æ–¹æ³•
3. å­¦ä¹ ä»¤ç‰ŒéªŒè¯çš„å®Œæ•´æµç¨‹  
4. å®è·µé™æµç†”æ–­é…ç½®
5. æœ€åæ•´åˆåˆ°å®é™…é¡¹ç›®ä¸­

è®°ä½ï¼š**ç½‘å…³å®‰å…¨ä¸æ˜¯å¯é€‰é¡¹ï¼Œè€Œæ˜¯å¾®æœåŠ¡æ¶æ„çš„å¿…éœ€å“**ï¼