---
title: 2ã€æœåŠ¡é—´é€šä¿¡å®‰å…¨
---
## ğŸ“š ç›®å½•

1. [ä¸ºä»€ä¹ˆéœ€è¦æœåŠ¡é—´é€šä¿¡å®‰å…¨](#1-ä¸ºä»€ä¹ˆéœ€è¦æœåŠ¡é—´é€šä¿¡å®‰å…¨)
2. [æœåŠ¡é—´è®¤è¯ç­–ç•¥æ¦‚è§ˆ](#2-æœåŠ¡é—´è®¤è¯ç­–ç•¥æ¦‚è§ˆ)
3. [API Keyè®¤è¯æœºåˆ¶](#3-api-keyè®¤è¯æœºåˆ¶)
4. [mTLSåŒå‘TLSè®¤è¯](#4-mtlsåŒå‘tlsè®¤è¯)
5. [Service AccountæœåŠ¡è´¦æˆ·](#5-service-accountæœåŠ¡è´¦æˆ·)
6. [é›¶ä¿¡ä»»ç½‘ç»œæ¶æ„](#6-é›¶ä¿¡ä»»ç½‘ç»œæ¶æ„)
7. [æœåŠ¡ç½‘æ ¼å®‰å…¨æ–¹æ¡ˆ](#7-æœåŠ¡ç½‘æ ¼å®‰å…¨æ–¹æ¡ˆ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” ä¸ºä»€ä¹ˆéœ€è¦æœåŠ¡é—´é€šä¿¡å®‰å…¨


### 1.1 å¾®æœåŠ¡é€šä¿¡çš„å®‰å…¨æŒ‘æˆ˜


**ä¼ ç»Ÿå•ä½“åº”ç”¨ vs å¾®æœåŠ¡æ¶æ„çš„å®‰å…¨å·®å¼‚**

```
å•ä½“åº”ç”¨ï¼š                       å¾®æœåŠ¡æ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”
â”‚             â”‚                 â”‚æœåŠ¡Aâ”œâ”€â†’â”‚æœåŠ¡Bâ”œâ”€â†’â”‚æœåŠ¡Câ”‚
â”‚  æ‰€æœ‰åŠŸèƒ½   â”‚                 â””â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜
â”‚  åœ¨ä¸€ä¸ªè¿›ç¨‹  â”‚                    â†“       â†“       â†“
â”‚             â”‚                 â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚æœåŠ¡Dâ”‚  â”‚æœåŠ¡Eâ”‚  â”‚æœåŠ¡Fâ”‚
                                â””â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”˜
å†…éƒ¨è°ƒç”¨ï¼šæ–¹æ³•è°ƒç”¨               å†…éƒ¨è°ƒç”¨ï¼šç½‘ç»œé€šä¿¡ï¼ˆHTTP/RPCï¼‰
å®‰å…¨è¾¹ç•Œï¼šå¤–éƒ¨é˜²ç«å¢™             å®‰å…¨è¾¹ç•Œï¼šæ¯ä¸ªæœåŠ¡éƒ½æ˜¯è¾¹ç•Œï¼
```

**å¾®æœåŠ¡é¢ä¸´çš„å®‰å…¨é—®é¢˜**

ğŸ”¸ **æœåŠ¡èº«ä»½éªŒè¯é—®é¢˜**
- æ€ä¹ˆç¡®è®¤è°ƒç”¨æ–¹æ˜¯åˆæ³•çš„æœåŠ¡ï¼Ÿ
- å¦‚ä½•é˜²æ­¢æ¶æ„æœåŠ¡ä¼ªè£…æˆåˆæ³•æœåŠ¡ï¼Ÿ
- ä¾‹ï¼šè®¢å•æœåŠ¡è°ƒç”¨æ”¯ä»˜æœåŠ¡ï¼Œæ€ä¹ˆè¯æ˜è‡ªå·±æ˜¯çœŸçš„è®¢å•æœåŠ¡ï¼Ÿ

ğŸ”¸ **æ•°æ®ä¼ è¾“å®‰å…¨é—®é¢˜**
- æœåŠ¡é—´æ•°æ®åœ¨ç½‘ç»œä¼ è¾“ï¼Œå¯èƒ½è¢«çªƒå¬
- æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚ç”¨æˆ·ä¿¡æ¯ã€è®¢å•æ•°æ®ï¼‰éœ€è¦åŠ å¯†
- ä¾‹ï¼šç”¨æˆ·æœåŠ¡ä¼ é€’ç”¨æˆ·éšç§æ•°æ®ç»™æ¨èæœåŠ¡

ğŸ”¸ **æƒé™æ§åˆ¶é—®é¢˜**
- ä¸æ˜¯æ‰€æœ‰æœåŠ¡éƒ½èƒ½è°ƒç”¨æ‰€æœ‰æ¥å£
- éœ€è¦ç»†ç²’åº¦çš„è®¿é—®æ§åˆ¶
- ä¾‹ï¼šæ—¥å¿—æœåŠ¡ä¸åº”è¯¥èƒ½è°ƒç”¨æ”¯ä»˜æœåŠ¡çš„æ‰£æ¬¾æ¥å£

### 1.2 å†…ç½‘å°±å®‰å…¨å—ï¼Ÿè¯¯åŒºæ¾„æ¸…


**å¸¸è§é”™è¯¯è®¤çŸ¥** âŒ

> "æœåŠ¡éƒ½åœ¨å†…ç½‘ï¼Œä¸éœ€è¦å®‰å…¨æªæ–½"

**çœŸå®æƒ…å†µ** âš ï¸

å†…ç½‘ç¯å¢ƒåŒæ ·å­˜åœ¨é£é™©ï¼š
- **å†…éƒ¨å¨èƒ**ï¼šæ¶æ„å‘˜å·¥ã€è¢«å…¥ä¾µçš„å¼€å‘æœº
- **æ¨ªå‘ç§»åŠ¨**ï¼šæ”»å‡»è€…çªç ´ä¸€ä¸ªæœåŠ¡åï¼Œå¯ä»¥æ”»å‡»å…¶ä»–æœåŠ¡
- **é…ç½®é”™è¯¯**ï¼šé”™è¯¯çš„ç½‘ç»œé…ç½®å¯èƒ½æš´éœ²å†…éƒ¨æœåŠ¡
- **ä¾›åº”é“¾æ”»å‡»**ï¼šç¬¬ä¸‰æ–¹ä¾èµ–åº“å¯èƒ½åŒ…å«æ¶æ„ä»£ç 

**é›¶ä¿¡ä»»åŸåˆ™** âœ…

> "æ°¸è¿œä¸ä¿¡ä»»ï¼Œå§‹ç»ˆéªŒè¯" - Never Trust, Always Verify

---

## 2. ğŸ›¡ï¸ æœåŠ¡é—´è®¤è¯ç­–ç•¥æ¦‚è§ˆ


### 2.1 å¸¸è§è®¤è¯æ–¹å¼å¯¹æ¯”


| è®¤è¯æ–¹å¼ | **å·¥ä½œåŸç†** | **å®‰å…¨ç­‰çº§** | **å®æ–½éš¾åº¦** | **é€‚ç”¨åœºæ™¯** |
|---------|------------|------------|------------|------------|
| **API Key** | `æœåŠ¡æŒæœ‰å¯†é’¥è¿›è¡Œèº«ä»½éªŒè¯` | â­â­ | â­ | `ç®€å•çš„å†…éƒ¨æœåŠ¡è°ƒç”¨` |
| **JWT Token** | `æœåŠ¡é—´ä¼ é€’ç­¾åçš„ä»¤ç‰Œ` | â­â­â­ | â­â­ | `æœ‰çŠ¶æ€ä¼ é€’çš„æœåŠ¡è°ƒç”¨` |
| **mTLS** | `åŒå‘è¯ä¹¦éªŒè¯` | â­â­â­â­ | â­â­â­ | `é«˜å®‰å…¨è¦æ±‚åœºæ™¯` |
| **Service Account** | `æœåŠ¡ä¸“ç”¨è´¦æˆ·ä½“ç³»` | â­â­â­ | â­â­ | `äº‘åŸç”Ÿç¯å¢ƒ` |
| **æœåŠ¡ç½‘æ ¼** | `åŸºç¡€è®¾æ–½å±‚è‡ªåŠ¨åŠ å¯†è®¤è¯` | â­â­â­â­â­ | â­â­â­â­ | `å¤§è§„æ¨¡å¾®æœåŠ¡é›†ç¾¤` |

### 2.2 è®¤è¯ç­–ç•¥é€‰æ‹©å†³ç­–æ ‘


```
å¼€å§‹é€‰æ‹©è®¤è¯ç­–ç•¥
    â†“
æ˜¯å¦æœ‰æœåŠ¡ç½‘æ ¼(Istio/Linkerd)ï¼Ÿ
    â”œâ”€æ˜¯ â†’ ä¼˜å…ˆä½¿ç”¨æœåŠ¡ç½‘æ ¼çš„ mTLS
    â””â”€å¦ â†’ ç»§ç»­åˆ¤æ–­
           â†“
    å®‰å…¨è¦æ±‚æ˜¯å¦éå¸¸é«˜ï¼Ÿ
        â”œâ”€æ˜¯ â†’ æ‰‹åŠ¨é…ç½® mTLS
        â””â”€å¦ â†’ ç»§ç»­åˆ¤æ–­
               â†“
        æ˜¯å¦åœ¨ Kubernetes ç¯å¢ƒï¼Ÿ
            â”œâ”€æ˜¯ â†’ ä½¿ç”¨ Service Account
            â””â”€å¦ â†’ ç»§ç»­åˆ¤æ–­
                   â†“
            æ˜¯å¦éœ€è¦ä¼ é€’ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼Ÿ
                â”œâ”€æ˜¯ â†’ ä½¿ç”¨ JWT Token
                â””â”€å¦ â†’ ä½¿ç”¨ API Key
```

---

## 3. ğŸ”‘ API Keyè®¤è¯æœºåˆ¶


### 3.1 ä»€ä¹ˆæ˜¯API Keyè®¤è¯


**æ ¸å¿ƒæ¦‚å¿µ**

API Key å°±åƒæ˜¯ä¸€æŠŠ"é’¥åŒ™"ï¼ŒæœåŠ¡è°ƒç”¨æ—¶å‡ºç¤ºè¿™æŠŠé’¥åŒ™ï¼Œè¯æ˜è‡ªå·±çš„èº«ä»½ã€‚

**ç”Ÿæ´»ä¸­çš„ç±»æ¯”** ğŸ’¡

```
å°±åƒå°åŒºé—¨ç¦å¡ï¼š
- æ¯ä¸ªä½æˆ·æœ‰å”¯ä¸€çš„é—¨ç¦å¡ï¼ˆAPI Keyï¼‰
- åˆ·å¡è¿›å…¥å°åŒºï¼ˆæœåŠ¡è°ƒç”¨æ—¶æºå¸¦API Keyï¼‰
- é—¨ç¦ç³»ç»ŸéªŒè¯å¡çš„æœ‰æ•ˆæ€§ï¼ˆæœåŠ¡ç«¯éªŒè¯API Keyï¼‰
- æ— æ•ˆçš„å¡æ— æ³•å¼€é—¨ï¼ˆæ— æ•ˆçš„Keyè¢«æ‹’ç»ï¼‰
```

### 3.2 API Keyå·¥ä½œæµç¨‹


**è®¤è¯æµç¨‹å›¾ç¤º**

```
æœåŠ¡A                           æœåŠ¡B
  |                              |
  |--[1]å‘èµ·è¯·æ±‚---------------->|
  |   Header: X-API-Key: abc123  |
  |                              |
  |                              |--[2]ä»è¯·æ±‚å¤´æå–Key
  |                              |
  |                              |--[3]æŸ¥è¯¢Keyæ˜¯å¦æœ‰æ•ˆ
  |                              |   (æ•°æ®åº“/ç¼“å­˜/é…ç½®)
  |                              |
  |<--[4]è¿”å›è®¤è¯ç»“æœ------------|
      âœ…å…è®¸è®¿é—® or âŒæ‹’ç»è®¿é—®
```

### 3.3 Spring Bootå®ç°API Keyè®¤è¯


**æ­¥éª¤ä¸€ï¼šé…ç½®API Key** ğŸ“‹

```yaml
# application.yml
api:
  keys:
    order-service: "ord_key_a1b2c3d4e5"
    user-service: "usr_key_f6g7h8i9j0"
    payment-service: "pay_key_k1l2m3n4o5"
```

**æ­¥éª¤äºŒï¼šåˆ›å»ºè®¤è¯è¿‡æ»¤å™¨** ğŸ”§

```java
@Component
public class ApiKeyAuthFilter extends OncePerRequestFilter {
    
    @Value("#{${api.keys}}")
    private Map<String, String> apiKeys;
    
    @Override
    protected void doFilterInternal(HttpServletRequest request, 
                                   HttpServletResponse response,
                                   FilterChain filterChain) {
        // 1. è·å–è¯·æ±‚å¤´ä¸­çš„API Key
        String apiKey = request.getHeader("X-API-Key");
        
        // 2. éªŒè¯API Key
        if (apiKey == null || !apiKeys.containsValue(apiKey)) {
            response.setStatus(HttpStatus.UNAUTHORIZED.value());
            response.getWriter().write("æ— æ•ˆçš„API Key");
            return;
        }
        
        // 3. éªŒè¯é€šè¿‡ï¼Œç»§ç»­è¯·æ±‚
        filterChain.doFilter(request, response);
    }
}
```

**æ­¥éª¤ä¸‰ï¼šå®¢æˆ·ç«¯è°ƒç”¨ç¤ºä¾‹** ğŸ“

```java
@Service
public class OrderServiceClient {
    
    @Value("${api.keys.order-service}")
    private String apiKey;
    
    private final RestTemplate restTemplate;
    
    public PaymentResult callPaymentService(PaymentRequest request) {
        HttpHeaders headers = new HttpHeaders();
        headers.set("X-API-Key", apiKey);  // æºå¸¦API Key
        
        HttpEntity<PaymentRequest> entity = new HttpEntity<>(request, headers);
        
        return restTemplate.postForObject(
            "http://payment-service/api/pay",
            entity,
            PaymentResult.class
        );
    }
}
```

### 3.4 API Keyçš„ä¼˜ç¼ºç‚¹åˆ†æ


**ä¼˜ç‚¹** âœ…
- å®ç°ç®€å•ï¼Œå®¹æ˜“ç†è§£
- æ€§èƒ½å¼€é”€å°ï¼ŒéªŒè¯é€Ÿåº¦å¿«
- é€‚åˆç®€å•çš„å†…éƒ¨æœåŠ¡è°ƒç”¨

**ç¼ºç‚¹** âš ï¸
- **å®‰å…¨æ€§è¾ƒä½**ï¼šKeyæ³„éœ²åå®¹æ˜“è¢«æ»¥ç”¨
- **å¯†é’¥ç®¡ç†å›°éš¾**ï¼šéœ€è¦å®‰å…¨å­˜å‚¨å’Œå®šæœŸè½®æ¢
- **ç¼ºå°‘ç»†ç²’åº¦æ§åˆ¶**ï¼šéš¾ä»¥å®ç°å¤æ‚çš„æƒé™æ§åˆ¶
- **æ— æ³•ä¼ é€’ä¸Šä¸‹æ–‡**ï¼šä¸èƒ½æºå¸¦ç”¨æˆ·æˆ–è¯·æ±‚çš„é¢å¤–ä¿¡æ¯

**é€‚ç”¨åœºæ™¯** ğŸ¯
- ä½å®‰å…¨è¦æ±‚çš„å†…éƒ¨æœåŠ¡
- ç®¡ç†åå°çš„æœåŠ¡è°ƒç”¨
- æµ‹è¯•å’Œå¼€å‘ç¯å¢ƒ

---

## 4. ğŸ”’ mTLSåŒå‘TLSè®¤è¯


### 4.1 ä»€ä¹ˆæ˜¯mTLS


**TLS vs mTLS çš„åŒºåˆ«**

```
æ™®é€šTLS (å•å‘è®¤è¯)ï¼š              mTLS (åŒå‘è®¤è¯)ï¼š
å®¢æˆ·ç«¯ â†’ æœåŠ¡ç«¯                   å®¢æˆ·ç«¯ â†” æœåŠ¡ç«¯
       
åªéªŒè¯æœåŠ¡ç«¯èº«ä»½                  åŒæ–¹äº’ç›¸éªŒè¯èº«ä»½
ä¾‹ï¼šæµè§ˆå™¨è®¿é—®HTTPSç½‘ç«™           ä¾‹ï¼šæœåŠ¡Aè°ƒç”¨æœåŠ¡B
```

**mTLSè®¤è¯åŸç†** ğŸ”

mTLS = Mutual TLS (ç›¸äº’TLSè®¤è¯)

- **æ™®é€šTLS**ï¼šåªæœ‰å®¢æˆ·ç«¯éªŒè¯æœåŠ¡ç«¯çš„è¯ä¹¦ï¼ˆå°±åƒä½ éªŒè¯é“¶è¡Œç½‘ç«™æ˜¯çœŸçš„ï¼‰
- **mTLS**ï¼šå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯äº’ç›¸éªŒè¯å¯¹æ–¹çš„è¯ä¹¦ï¼ˆå°±åƒä½ å’Œé“¶è¡Œäº’ç›¸éªŒè¯èº«ä»½ï¼‰

**ç”Ÿæ´»ä¸­çš„ç±»æ¯”** ğŸ’¡

```
æ™®é€šTLS å°±åƒï¼š
ä½ å»é“¶è¡ŒåŠä¸šåŠ¡ â†’ ä½ éªŒè¯è¿™æ˜¯çœŸçš„é“¶è¡Œ â†’ é“¶è¡Œç›¸ä¿¡ä½ è¯´çš„è¯

mTLS å°±åƒï¼š
ä½ å»é“¶è¡ŒåŠä¸šåŠ¡ â†’ ä½ éªŒè¯é“¶è¡Œæ˜¯çœŸçš„ â†’ é“¶è¡ŒéªŒè¯ä½ çš„èº«ä»½è¯ â†’ åŒæ–¹éƒ½ç¡®è®¤èº«ä»½
```

### 4.2 mTLSå·¥ä½œæµç¨‹è¯¦è§£


**å®Œæ•´æ¡æ‰‹è¿‡ç¨‹**

```
å®¢æˆ·ç«¯(æœåŠ¡A)                                  æœåŠ¡ç«¯(æœåŠ¡B)
     |                                              |
     |----[1]Client Hello (å‘èµ·è¿æ¥)--------------->|
     |                                              |
     |<---[2]Server Hello + æœåŠ¡ç«¯è¯ä¹¦--------------|
     |                                              |
     |----[3]éªŒè¯æœåŠ¡ç«¯è¯ä¹¦------------------------>|
     |    âœ…è¯ä¹¦æœ‰æ•ˆï¼Ÿç”±è°ç­¾å‘ï¼Ÿæ˜¯å¦è¿‡æœŸï¼Ÿ            |
     |                                              |
     |<---[4]è¯·æ±‚å®¢æˆ·ç«¯è¯ä¹¦-------------------------|
     |                                              |
     |----[5]å‘é€å®¢æˆ·ç«¯è¯ä¹¦------------------------>|
     |                                              |
     |                                              |----[6]éªŒè¯å®¢æˆ·ç«¯è¯ä¹¦
     |                                              |    âœ…è¯ä¹¦æœ‰æ•ˆï¼Ÿ
     |                                              |
     |<---[7]æ¡æ‰‹å®Œæˆï¼Œå»ºç«‹åŠ å¯†é€šé“------------------|
     |                                              |
     |=====[8]åŠ å¯†çš„æ•°æ®ä¼ è¾“]========================|
```

### 4.3 è¯ä¹¦ä½“ç³»ç»“æ„


**è¯ä¹¦ä¿¡ä»»é“¾**

```
æ ¹è¯ä¹¦é¢å‘æœºæ„ (Root CA)
        â†“ ç­¾å‘
ä¸­é—´è¯ä¹¦é¢å‘æœºæ„ (Intermediate CA)
        â†“ ç­¾å‘
æœåŠ¡è¯ä¹¦ (Service Certificate)
        â†“ ç”¨äº
    æœåŠ¡Aã€æœåŠ¡Bã€æœåŠ¡C...
```

**è¯ä¹¦å…³é”®ä¿¡æ¯**
- **Subjectï¼ˆä¸»ä½“ï¼‰**ï¼šè¯ä¹¦å±äºè°ï¼ˆå¦‚ï¼šCN=order-serviceï¼‰
- **Issuerï¼ˆé¢å‘è€…ï¼‰**ï¼šè°ç­¾å‘çš„è¯ä¹¦
- **æœ‰æ•ˆæœŸ**ï¼šè¯ä¹¦çš„ç”Ÿæ•ˆå’Œè¿‡æœŸæ—¶é—´
- **å…¬é’¥**ï¼šç”¨äºåŠ å¯†é€šä¿¡
- **ç­¾å**ï¼šè¯æ˜è¯ä¹¦æœªè¢«ç¯¡æ”¹

### 4.4 Spring Booté…ç½®mTLS


**æ­¥éª¤ä¸€ï¼šç”Ÿæˆè¯ä¹¦** ğŸ”

```bash
# 1. ç”ŸæˆCAæ ¹è¯ä¹¦
keytool -genkeypair -alias ca-root \
  -keyalg RSA -keysize 2048 \
  -validity 3650 \
  -keystore ca-keystore.jks

# 2. ä¸ºæœåŠ¡Aç”Ÿæˆè¯ä¹¦
keytool -genkeypair -alias service-a \
  -keyalg RSA -keysize 2048 \
  -validity 365 \
  -keystore service-a.jks

# 3. ç”¨CAç­¾å‘æœåŠ¡Açš„è¯ä¹¦
keytool -certreq -alias service-a \
  -keystore service-a.jks \
  -file service-a.csr

keytool -gencert -alias ca-root \
  -keystore ca-keystore.jks \
  -infile service-a.csr \
  -outfile service-a.crt
```

**æ­¥éª¤äºŒï¼šé…ç½®æœåŠ¡ç«¯** âš™ï¸

```yaml
# æœåŠ¡Bçš„é…ç½® (application.yml)
server:
  port: 8443
  ssl:
    enabled: true
    # æœåŠ¡ç«¯è¯ä¹¦
    key-store: classpath:service-b.jks
    key-store-password: password123
    key-alias: service-b
    
    # è¦æ±‚å®¢æˆ·ç«¯è¯ä¹¦
    client-auth: need
    
    # ä¿¡ä»»çš„å®¢æˆ·ç«¯CAè¯ä¹¦
    trust-store: classpath:ca-truststore.jks
    trust-store-password: password123
```

**æ­¥éª¤ä¸‰ï¼šé…ç½®å®¢æˆ·ç«¯** ğŸ“¡

```java
@Configuration
public class MtlsClientConfig {
    
    @Bean
    public RestTemplate mtlsRestTemplate() throws Exception {
        // åŠ è½½å®¢æˆ·ç«¯è¯ä¹¦
        KeyStore keyStore = KeyStore.getInstance("JKS");
        keyStore.load(
            new FileInputStream("service-a.jks"),
            "password123".toCharArray()
        );
        
        // åŠ è½½ä¿¡ä»»çš„æœåŠ¡ç«¯CA
        KeyStore trustStore = KeyStore.getInstance("JKS");
        trustStore.load(
            new FileInputStream("ca-truststore.jks"),
            "password123".toCharArray()
        );
        
        // é…ç½®SSLä¸Šä¸‹æ–‡
        SSLContext sslContext = SSLContextBuilder.create()
            .loadKeyMaterial(keyStore, "password123".toCharArray())
            .loadTrustMaterial(trustStore, null)
            .build();
        
        // åˆ›å»ºRestTemplate
        CloseableHttpClient httpClient = HttpClients.custom()
            .setSSLContext(sslContext)
            .build();
            
        HttpComponentsClientHttpRequestFactory factory = 
            new HttpComponentsClientHttpRequestFactory(httpClient);
            
        return new RestTemplate(factory);
    }
}
```

### 4.5 mTLSçš„ä¼˜ç¼ºç‚¹


**ä¼˜ç‚¹** âœ…
- **å®‰å…¨æ€§æé«˜**ï¼šåŒå‘éªŒè¯ï¼Œéš¾ä»¥ä¼ªé€ 
- **åŠ å¯†ä¼ è¾“**ï¼šæ•°æ®åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­è¢«åŠ å¯†
- **æ— éœ€é¢å¤–è®¤è¯æœºåˆ¶**ï¼šè¯ä¹¦æœ¬èº«å°±æ˜¯èº«ä»½å‡­è¯
- **æŠ—ä¸­é—´äººæ”»å‡»**ï¼šæœ‰æ•ˆé˜²æ­¢æ•°æ®è¢«çªƒå¬å’Œç¯¡æ”¹

**ç¼ºç‚¹** âš ï¸
- **é…ç½®å¤æ‚**ï¼šè¯ä¹¦ç”Ÿæˆã€åˆ†å‘ã€ç®¡ç†éƒ½å¾ˆå¤æ‚
- **æ€§èƒ½å¼€é”€**ï¼šSSLæ¡æ‰‹å¢åŠ å»¶è¿Ÿ
- **è¯ä¹¦ç®¡ç†å›°éš¾**ï¼šéœ€è¦å®šæœŸè½®æ¢è¯ä¹¦
- **è°ƒè¯•å›°éš¾**ï¼šè¯ä¹¦é—®é¢˜æ’æŸ¥å¤æ‚

**é€‚ç”¨åœºæ™¯** ğŸ¯
- é‡‘èã€åŒ»ç–—ç­‰é«˜å®‰å…¨è¦æ±‚è¡Œä¸š
- è·¨æ•°æ®ä¸­å¿ƒçš„æœåŠ¡è°ƒç”¨
- æš´éœ²åœ¨å…¬ç½‘çš„æœåŠ¡
- åˆè§„æ€§è¦æ±‚ä¸¥æ ¼çš„åœºæ™¯

---

## 5. ğŸ‘¤ Service AccountæœåŠ¡è´¦æˆ·


### 5.1 ä»€ä¹ˆæ˜¯Service Account


**æ ¸å¿ƒæ¦‚å¿µ**

Service Accountï¼ˆæœåŠ¡è´¦æˆ·ï¼‰æ˜¯ä¸“é—¨ä¸ºæœåŠ¡è®¾è®¡çš„èº«ä»½æ ‡è¯†ï¼Œä¸åŒäºç”¨æˆ·è´¦æˆ·ã€‚

**ç”¨æˆ·è´¦æˆ· vs æœåŠ¡è´¦æˆ·**

```
ç”¨æˆ·è´¦æˆ· (User Account)ï¼š         æœåŠ¡è´¦æˆ· (Service Account)ï¼š
- ä»£è¡¨çœŸå®çš„äºº                    - ä»£è¡¨è¿è¡Œçš„æœåŠ¡/åº”ç”¨
- æœ‰ç™»å½•å¯†ç                       - ä½¿ç”¨Token/è¯ä¹¦
- å¯ä»¥äº¤äº’å¼ç™»å½•                  - æ— éœ€äº¤äº’
- ä¾‹ï¼šå¼ ä¸‰çš„è´¦æˆ·                  - ä¾‹ï¼šè®¢å•æœåŠ¡çš„è´¦æˆ·
```

**ä¸ºä»€ä¹ˆéœ€è¦æœåŠ¡è´¦æˆ·ï¼Ÿ** ğŸ¤”

âŒ **ä¸å¥½çš„åšæ³•**ï¼šè®©æœåŠ¡å…±ç”¨ä¸€ä¸ªç®¡ç†å‘˜è´¦æˆ·
- æ— æ³•åŒºåˆ†æ˜¯å“ªä¸ªæœåŠ¡çš„æ“ä½œ
- ä¸€ä¸ªæœåŠ¡çš„å‡­è¯æ³„éœ²ï¼Œæ‰€æœ‰æœåŠ¡éƒ½å—å½±å“
- æƒé™éš¾ä»¥ç²¾ç»†æ§åˆ¶

âœ… **å¥½çš„åšæ³•**ï¼šæ¯ä¸ªæœåŠ¡æœ‰ç‹¬ç«‹çš„æœåŠ¡è´¦æˆ·
- å¯ä»¥è¿½è¸ªæ¯ä¸ªæœåŠ¡çš„è¡Œä¸º
- å•ä¸ªæœåŠ¡å‡­è¯æ³„éœ²ä¸å½±å“å…¶ä»–æœåŠ¡
- å¯ä»¥ä¸ºæ¯ä¸ªæœåŠ¡è®¾ç½®ä¸åŒçš„æƒé™

### 5.2 Kubernetesä¸­çš„Service Account


**Kubernetes Service Accountå·¥ä½œåŸç†**

```
Podåˆ›å»ºæµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Podå¯åŠ¨    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Kubernetesè‡ªåŠ¨æŒ‚è½½       â”‚
â”‚ Service Account Token    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Tokenè·¯å¾„ï¼š              â”‚
â”‚ /var/run/secrets/        â”‚
â”‚ kubernetes.io/           â”‚
â”‚ serviceaccount/token     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æœåŠ¡ä½¿ç”¨Tokenè°ƒç”¨API     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åˆ›å»ºå’Œä½¿ç”¨Service Account**

```yaml
# 1. åˆ›å»ºService Account
apiVersion: v1
kind: ServiceAccount
metadata:
  name: order-service-account
  namespace: production

---
# 2. ä¸ºService Accountåˆ†é…æƒé™
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: order-service-role
rules:
- apiGroups: [""]
  resources: ["configmaps", "secrets"]
  verbs: ["get", "list"]

---
# 3. ç»‘å®šè§’è‰²åˆ°Service Account
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: order-service-binding
subjects:
- kind: ServiceAccount
  name: order-service-account
roleRef:
  kind: Role
  name: order-service-role
  apiGroup: rbac.authorization.k8s.io

---
# 4. Podä½¿ç”¨Service Account
apiVersion: v1
kind: Pod
metadata:
  name: order-service
spec:
  serviceAccountName: order-service-account  # ä½¿ç”¨ä¸“ç”¨è´¦æˆ·
  containers:
  - name: order-service
    image: order-service:v1.0
```

### 5.3 åœ¨Spring Bootä¸­ä½¿ç”¨Service Account


**è¯»å–Kubernetes Service Account Token**

```java
@Service
public class KubernetesServiceAccountClient {
    
    // Tokenæ–‡ä»¶è·¯å¾„ï¼ˆKubernetesè‡ªåŠ¨æŒ‚è½½ï¼‰
    private static final String TOKEN_PATH = 
        "/var/run/secrets/kubernetes.io/serviceaccount/token";
    
    // è¯»å–Service Account Token
    private String getServiceAccountToken() throws IOException {
        return Files.readString(Paths.get(TOKEN_PATH));
    }
    
    // ä½¿ç”¨Tokenè°ƒç”¨å…¶ä»–æœåŠ¡
    public PaymentResponse callPaymentService(PaymentRequest request) 
            throws IOException {
        String token = getServiceAccountToken();
        
        HttpHeaders headers = new HttpHeaders();
        headers.setBearerAuth(token);  // ä½¿ç”¨Bearer Token
        
        HttpEntity<PaymentRequest> entity = 
            new HttpEntity<>(request, headers);
        
        return restTemplate.postForObject(
            "http://payment-service/api/pay",
            entity,
            PaymentResponse.class
        );
    }
}
```

**éªŒè¯Service Account Tokençš„æœåŠ¡ç«¯**

```java
@Component
public class ServiceAccountAuthFilter extends OncePerRequestFilter {
    
    @Value("${kubernetes.api-server}")
    private String kubernetesApiServer;
    
    @Override
    protected void doFilterInternal(HttpServletRequest request,
                                   HttpServletResponse response,
                                   FilterChain filterChain) {
        // 1. è·å–Token
        String token = extractToken(request);
        if (token == null) {
            response.setStatus(HttpStatus.UNAUTHORIZED.value());
            return;
        }
        
        // 2. å‘Kubernetes APIéªŒè¯Token
        boolean isValid = validateTokenWithK8s(token);
        
        if (!isValid) {
            response.setStatus(HttpStatus.UNAUTHORIZED.value());
            return;
        }
        
        // 3. éªŒè¯é€šè¿‡
        filterChain.doFilter(request, response);
    }
    
    private String extractToken(HttpServletRequest request) {
        String authHeader = request.getHeader("Authorization");
        if (authHeader != null && authHeader.startsWith("Bearer ")) {
            return authHeader.substring(7);
        }
        return null;
    }
    
    // è°ƒç”¨Kubernetes APIéªŒè¯Token
    private boolean validateTokenWithK8s(String token) {
        // å®é™…ä¼šè°ƒç”¨ Kubernetes TokenReview API
        // è¿™é‡Œç®€åŒ–å±•ç¤º
        return true;
    }
}
```

### 5.4 Service Accountçš„ä¼˜ç¼ºç‚¹


**ä¼˜ç‚¹** âœ…
- **è‡ªåŠ¨ç®¡ç†**ï¼šKubernetesè‡ªåŠ¨åˆ›å»ºå’Œæ³¨å…¥Token
- **ç»†ç²’åº¦æƒé™**ï¼šå¯ä»¥ä¸ºæ¯ä¸ªæœåŠ¡è®¾ç½®ä¸åŒæƒé™
- **å®‰å…¨æ€§å¥½**ï¼šTokenè‡ªåŠ¨è½®æ¢ï¼Œéš¾ä»¥ä¼ªé€ 
- **äº‘åŸç”Ÿå‹å¥½**ï¼šä¸Kubernetesç”Ÿæ€æ— ç¼é›†æˆ

**ç¼ºç‚¹** âš ï¸
- **ä¾èµ–å¹³å°**ï¼šåªèƒ½åœ¨Kubernetesç­‰æ”¯æŒçš„å¹³å°ä½¿ç”¨
- **å­¦ä¹ æˆæœ¬**ï¼šéœ€è¦ç†è§£RBACæƒé™æ¨¡å‹
- **è°ƒè¯•å¤æ‚**ï¼šæƒé™é—®é¢˜æ’æŸ¥ç›¸å¯¹å›°éš¾

**é€‚ç”¨åœºæ™¯** ğŸ¯
- Kubernetesç¯å¢ƒä¸‹çš„å¾®æœåŠ¡
- éœ€è¦ç»†ç²’åº¦æƒé™æ§åˆ¶çš„åœºæ™¯
- äº‘åŸç”Ÿåº”ç”¨

---

## 6. ğŸ›¡ï¸ é›¶ä¿¡ä»»ç½‘ç»œæ¶æ„


### 6.1 ä»€ä¹ˆæ˜¯é›¶ä¿¡ä»»


**ä¼ ç»Ÿå®‰å…¨æ¨¡å‹ vs é›¶ä¿¡ä»»æ¨¡å‹**

```
ä¼ ç»Ÿ"åŸå ¡æŠ¤åŸæ²³"æ¨¡å‹ï¼š           é›¶ä¿¡ä»»"æ°¸ä¸ä¿¡ä»»"æ¨¡å‹ï¼š

    å¤–ç½‘ï¼ˆä¸ä¿¡ä»»ï¼‰                    æ‰€æœ‰ç½‘ç»œï¼ˆéƒ½ä¸ä¿¡ä»»ï¼‰
        â†“                                  â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ é˜²ç«å¢™   â”‚                      â”‚æ¯æ¬¡è®¿é—®éƒ½éªŒè¯â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“                                  â†“
    å†…ç½‘ï¼ˆä¿¡ä»»ï¼‰                    â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚éªŒè¯  â”‚éªŒè¯  â”‚éªŒè¯  â”‚
    â”‚æ‰€æœ‰æœåŠ¡äº’ä¿¡  â”‚                â”‚æœåŠ¡A â”‚æœåŠ¡B â”‚æœåŠ¡C â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜
    
é—®é¢˜ï¼šä¸€æ—¦æ”»å‡»è€…è¿›å…¥å†…ç½‘ï¼Œ       ä¼˜åŠ¿ï¼šå³ä½¿çªç ´æŸä¸ªæœåŠ¡ï¼Œ
     å¯ä»¥æ¨ªå‘ç§»åŠ¨æ”»å‡»æ‰€æœ‰æœåŠ¡          ä»éœ€éªŒè¯æ‰èƒ½è®¿é—®å…¶ä»–æœåŠ¡
```

**é›¶ä¿¡ä»»ä¸‰å¤§æ ¸å¿ƒåŸåˆ™** ğŸ¯

1. **æ°¸ä¸ä¿¡ä»»ï¼Œå§‹ç»ˆéªŒè¯**
   - ä¸ç®¡è¯·æ±‚æ¥è‡ªå“ªé‡Œï¼Œéƒ½è¦éªŒè¯èº«ä»½
   - å†…ç½‘çš„æœåŠ¡ä¹Ÿè¦äº’ç›¸éªŒè¯

2. **æœ€å°æƒé™åŸåˆ™**
   - åªç»™æœåŠ¡å¿…éœ€çš„æœ€å°æƒé™
   - ä¾‹ï¼šè®¢å•æœåŠ¡åªèƒ½æŸ¥è¯¢å•†å“ï¼Œä¸èƒ½ä¿®æ”¹å•†å“

3. **æŒç»­ç›‘æ§å’ŒéªŒè¯**
   - ä¸ä»…éªŒè¯èº«ä»½ï¼Œè¿˜è¦ç›‘æ§è¡Œä¸º
   - å‘ç°å¼‚å¸¸ç«‹å³é˜»æ–­

### 6.2 é›¶ä¿¡ä»»æ¶æ„å®ç°è¦ç´ 


**æ ¸å¿ƒç»„ä»¶**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ç­–ç•¥å†³ç­–ç‚¹ (PDP)             â”‚
â”‚    å†³å®šæ˜¯å¦å…è®¸è®¿é—®                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ç­–ç•¥æ‰§è¡Œç‚¹ (PEP)             â”‚
â”‚    æ‰§è¡Œè®¿é—®æ§åˆ¶å†³ç­–                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
      â†“                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ èº«ä»½éªŒè¯  â”‚      â”‚ æˆæƒæ£€æŸ¥  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®ç°æ­¥éª¤**

**æ­¥éª¤1ï¼šæœåŠ¡èº«ä»½è¯†åˆ«** ğŸ†”

æ¯ä¸ªæœåŠ¡éƒ½éœ€è¦å”¯ä¸€çš„èº«ä»½æ ‡è¯†ï¼ˆService Identityï¼‰

```java
@Component
public class ServiceIdentityProvider {
    
    // ä»ç¯å¢ƒå˜é‡æˆ–é…ç½®è·å–æœåŠ¡èº«ä»½
    @Value("${service.identity}")
    private String serviceId;  // ä¾‹ï¼š"order-service-prod-v1"
    
    public String getServiceIdentity() {
        return serviceId;
    }
}
```

**æ­¥éª¤2ï¼šæ¯æ¬¡è¯·æ±‚éƒ½éªŒè¯** âœ…

```java
@Component
public class ZeroTrustAuthFilter extends OncePerRequestFilter {
    
    @Override
    protected void doFilterInternal(HttpServletRequest request,
                                   HttpServletResponse response,
                                   FilterChain filterChain) {
        // 1. æå–è°ƒç”¨æ–¹èº«ä»½
        String callerIdentity = extractCallerIdentity(request);
        
        // 2. éªŒè¯èº«ä»½çœŸå®æ€§
        if (!verifyIdentity(callerIdentity)) {
            response.setStatus(HttpStatus.UNAUTHORIZED.value());
            return;
        }
        
        // 3. æ£€æŸ¥æ˜¯å¦æœ‰æƒé™è®¿é—®æ­¤èµ„æº
        String resource = request.getRequestURI();
        if (!hasPermission(callerIdentity, resource)) {
            response.setStatus(HttpStatus.FORBIDDEN.value());
            return;
        }
        
        // 4. è®°å½•è®¿é—®æ—¥å¿—ï¼ˆç”¨äºå®¡è®¡ï¼‰
        logAccess(callerIdentity, resource);
        
        // 5. å…è®¸è®¿é—®
        filterChain.doFilter(request, response);
    }
}
```

**æ­¥éª¤3ï¼šåŠ¨æ€æƒé™æ§åˆ¶** ğŸ”

```java
@Service
public class DynamicAuthorizationService {
    
    // æƒé™è§„åˆ™å­˜å‚¨ï¼ˆå¯ä»¥æ˜¯æ•°æ®åº“æˆ–é…ç½®ä¸­å¿ƒï¼‰
    private final Map<String, Set<String>> servicePermissions = Map.of(
        "order-service", Set.of("/api/products/query", "/api/payment/create"),
        "user-service", Set.of("/api/users/profile", "/api/orders/my-orders"),
        "admin-service", Set.of("/api/**")  // ç®¡ç†æœåŠ¡æœ‰æ‰€æœ‰æƒé™
    );
    
    public boolean hasPermission(String serviceId, String resource) {
        Set<String> allowedPaths = servicePermissions.get(serviceId);
        
        if (allowedPaths == null) {
            return false;
        }
        
        // æ£€æŸ¥ç²¾ç¡®åŒ¹é…æˆ–æ¨¡å¼åŒ¹é…
        return allowedPaths.contains(resource) || 
               allowedPaths.stream().anyMatch(pattern -> 
                   matchesPattern(resource, pattern));
    }
    
    private boolean matchesPattern(String path, String pattern) {
        // æ”¯æŒé€šé…ç¬¦åŒ¹é…ï¼Œå¦‚ /api/** åŒ¹é…æ‰€æœ‰/api/å¼€å¤´çš„è·¯å¾„
        return path.matches(pattern.replace("**", ".*"));
    }
}
```

### 6.3 é›¶ä¿¡ä»»çš„ä¼˜ç¼ºç‚¹


**ä¼˜ç‚¹** âœ…
- **å®‰å…¨æ€§æœ€é«˜**ï¼šå‡è®¾æ‰€æœ‰ç½‘ç»œéƒ½ä¸å¯ä¿¡
- **é˜²æ­¢æ¨ªå‘ç§»åŠ¨**ï¼šå³ä½¿ä¸€ä¸ªæœåŠ¡è¢«æ”»ç ´ï¼Œä¹Ÿéš¾ä»¥æ”»å‡»å…¶ä»–æœåŠ¡
- **ç²¾ç»†åŒ–æ§åˆ¶**ï¼šå¯ä»¥å®ç°ç»†ç²’åº¦çš„è®¿é—®æ§åˆ¶

**ç¼ºç‚¹** âš ï¸
- **å¤æ‚åº¦é«˜**ï¼šéœ€è¦ç®¡ç†å¤§é‡çš„è®¤è¯å’Œæˆæƒè§„åˆ™
- **æ€§èƒ½å¼€é”€**ï¼šæ¯æ¬¡è¯·æ±‚éƒ½è¦éªŒè¯
- **å®æ–½å›°éš¾**ï¼šéœ€è¦æ”¹é€ ç°æœ‰ç³»ç»Ÿ

**é€‚ç”¨åœºæ™¯** ğŸ¯
- é«˜å®‰å…¨è¦æ±‚çš„ä¼ä¸š
- æ··åˆäº‘ç¯å¢ƒ
- å¤šç§Ÿæˆ·SaaSå¹³å°

---

## 7. ğŸŒ æœåŠ¡ç½‘æ ¼å®‰å…¨æ–¹æ¡ˆ


### 7.1 ä»€ä¹ˆæ˜¯æœåŠ¡ç½‘æ ¼


**ä¼ ç»Ÿå¾®æœåŠ¡ vs æœåŠ¡ç½‘æ ¼**

```
ä¼ ç»Ÿå¾®æœåŠ¡æ¶æ„ï¼š                  æœåŠ¡ç½‘æ ¼æ¶æ„ï¼š

æœåŠ¡A â”€â”€â†’ æœåŠ¡B                  æœåŠ¡A â”€â”€â†’ Sidecar A
 â†“                                         â†“
æ‰‹åŠ¨é…ç½®è®¤è¯ã€åŠ å¯†ã€é‡è¯•            è‡ªåŠ¨å¤„ç†  â†“
                                          â†“
                                    Sidecar A â”€â”€â†’ Sidecar B
                                    (è‡ªåŠ¨mTLS)      â†“
                                                   â†“
                                             Sidecar B â”€â”€â†’ æœåŠ¡B
```

**æœåŠ¡ç½‘æ ¼æ ¸å¿ƒæ¦‚å¿µ**

æœåŠ¡ç½‘æ ¼ï¼ˆService Meshï¼‰æ˜¯ä¸€ä¸ªä¸“é—¨å¤„ç†æœåŠ¡é—´é€šä¿¡çš„åŸºç¡€è®¾æ–½å±‚ã€‚

- **æ•°æ®å¹³é¢ï¼ˆData Planeï¼‰**ï¼šSidecarä»£ç†ï¼Œè´Ÿè´£å®é™…çš„æµé‡è½¬å‘
- **æ§åˆ¶å¹³é¢ï¼ˆControl Planeï¼‰**ï¼šç®¡ç†å’Œé…ç½®æ‰€æœ‰Sidecarä»£ç†

**ä¸ºä»€ä¹ˆéœ€è¦æœåŠ¡ç½‘æ ¼ï¼Ÿ** ğŸ¤”

âŒ **ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜**ï¼š
- æ¯ä¸ªæœåŠ¡éƒ½è¦è‡ªå·±å®ç°è®¤è¯ã€åŠ å¯†ã€é‡è¯•ç­‰é€»è¾‘
- ä¸åŒè¯­è¨€çš„æœåŠ¡å®ç°æ–¹å¼ä¸ä¸€è‡´
- å‡çº§å®‰å…¨ç­–ç•¥éœ€è¦ä¿®æ”¹æ‰€æœ‰æœåŠ¡ä»£ç 

âœ… **æœåŠ¡ç½‘æ ¼çš„è§£å†³æ–¹æ¡ˆ**ï¼š
- æŠŠé€šä¿¡é€»è¾‘ä¸‹æ²‰åˆ°åŸºç¡€è®¾æ–½å±‚
- å¯¹åº”ç”¨ä»£ç å®Œå…¨é€æ˜
- ç»Ÿä¸€ç®¡ç†æ‰€æœ‰æœåŠ¡çš„é€šä¿¡ç­–ç•¥

### 7.2 IstioæœåŠ¡ç½‘æ ¼å®‰å…¨


**Istioæ¶æ„å›¾**

```
                    æ§åˆ¶å¹³é¢ (Control Plane)
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Istiod             â”‚
                    â”‚ - è¯ä¹¦ç®¡ç†            â”‚
                    â”‚ - ç­–ç•¥é…ç½®            â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â†“ (é…ç½®ä¸‹å‘)
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“                                     â†“
    æ•°æ®å¹³é¢                              æ•°æ®å¹³é¢
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Pod A      â”‚                      â”‚  Pod B      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                      â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ æœåŠ¡A   â”‚ â”‚                      â”‚ â”‚ æœåŠ¡B   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â”‚                      â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â”‚
â”‚      â†“      â”‚                      â”‚      â†‘      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   mTLSåŠ å¯†é€šä¿¡        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Envoy   â”‚ â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ â”‚ Envoy   â”‚ â”‚
â”‚ â”‚ Proxy   â”‚ â”‚                      â”‚ â”‚ Proxy   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                      â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.3 Istioè‡ªåŠ¨mTLSé…ç½®


**å¯ç”¨å…¨å±€mTLS**

```yaml
# PeerAuthentication: é…ç½®æœåŠ¡é—´å¦‚ä½•è®¤è¯
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default
  namespace: production
spec:
  mtls:
    mode: STRICT  # å¼ºåˆ¶mTLSï¼Œæ‹’ç»æ˜æ–‡é€šä¿¡
```

**å«ä¹‰è§£é‡Š**ï¼š
- `STRICT`ï¼šä¸¥æ ¼æ¨¡å¼ï¼Œæ‰€æœ‰é€šä¿¡å¿…é¡»ä½¿ç”¨mTLS
- `PERMISSIVE`ï¼šå®½å®¹æ¨¡å¼ï¼Œå…è®¸mTLSå’Œæ˜æ–‡å…±å­˜ï¼ˆç”¨äºè¿ç§»æœŸï¼‰
- `DISABLE`ï¼šç¦ç”¨mTLS

**é…ç½®ç»†ç²’åº¦çš„è®¿é—®æ§åˆ¶**

```yaml
# AuthorizationPolicy: æ§åˆ¶è°å¯ä»¥è®¿é—®è°
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: payment-service-authz
  namespace: production
spec:
  selector:
    matchLabels:
      app: payment-service  # å¯¹payment-serviceç”Ÿæ•ˆ
  
  action: ALLOW  # å…è®¸è®¿é—®
  
  rules:
  - from:
    - source:
        principals: 
        - "cluster.local/ns/production/sa/order-service"  # åªå…è®¸order-service
    to:
    - operation:
        methods: ["POST"]  # åªå…è®¸POSTæ–¹æ³•
        paths: ["/api/payment/create"]  # åªå…è®¸è®¿é—®è¿™ä¸ªè·¯å¾„
```

**å«ä¹‰è§£é‡Š**ï¼š
- åªæœ‰`order-service`å¯ä»¥è°ƒç”¨`payment-service`çš„`/api/payment/create`æ¥å£
- å…¶ä»–æœåŠ¡çš„è°ƒç”¨ä¼šè¢«æ‹’ç»
- è¿™ä¸ªè§„åˆ™åœ¨Sidecarå±‚é¢è‡ªåŠ¨æ‰§è¡Œï¼Œåº”ç”¨ä»£ç æ— éœ€æ”¹åŠ¨

### 7.4 è¯ä¹¦è‡ªåŠ¨è½®æ¢


**Istioè¯ä¹¦ç®¡ç†æµç¨‹**

```
Istioæ§åˆ¶å¹³é¢                    Sidecarä»£ç†
      â”‚                              â”‚
      â”‚â”€â”€â”€[1]å¯åŠ¨æ—¶è¯·æ±‚è¯ä¹¦â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
      â”‚                              â”‚
      â”‚â†â”€â”€[2]é¢å‘çŸ­æœŸè¯ä¹¦(24å°æ—¶)â”€â”€â”€â”€â”€â”‚
      â”‚                              â”‚
      â”‚                          [3]ä½¿ç”¨è¯ä¹¦
      â”‚                          è¿›è¡ŒmTLSé€šä¿¡
      â”‚                              â”‚
      â”‚â†â”€â”€[4]è¯ä¹¦å³å°†è¿‡æœŸå‰è¯·æ±‚æ–°è¯ä¹¦â”€â”€â”‚
      â”‚                              â”‚
      â”‚â”€â”€â”€[5]é¢å‘æ–°è¯ä¹¦â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
      â”‚                              â”‚
      â”‚                          [6]è‡ªåŠ¨åˆ‡æ¢
      â”‚                          åˆ°æ–°è¯ä¹¦
```

**å¯¹æ¯”æ‰‹åŠ¨ç®¡ç†è¯ä¹¦**

| ç»´åº¦ | **æ‰‹åŠ¨ç®¡ç†è¯ä¹¦** | **Istioè‡ªåŠ¨ç®¡ç†** |
|-----|----------------|-----------------|
| **è¯ä¹¦ç”Ÿæˆ** | `éœ€è¦æ‰‹åŠ¨æ‰§è¡Œå‘½ä»¤` | `è‡ªåŠ¨ç”Ÿæˆ` |
| **è¯ä¹¦åˆ†å‘** | `æ‰‹åŠ¨æ‹·è´åˆ°å„ä¸ªæœåŠ¡` | `è‡ªåŠ¨ä¸‹å‘` |
| **è¯ä¹¦è½®æ¢** | `éœ€è¦é‡å¯æœåŠ¡` | `è‡ªåŠ¨è½®æ¢ï¼Œæ— éœ€é‡å¯` |
| **è¿‡æœŸç›‘æ§** | `éœ€è¦äººå·¥ç›‘æ§` | `è‡ªåŠ¨ç›‘æ§å’Œç»­æœŸ` |
| **è¿ç»´æˆæœ¬** | â­â­â­â­â­ | â­ |

### 7.5 æœåŠ¡ç½‘æ ¼çš„ä¼˜ç¼ºç‚¹


**ä¼˜ç‚¹** âœ…
- **é›¶ä»£ç æ”¹åŠ¨**ï¼šå¯¹åº”ç”¨å®Œå…¨é€æ˜
- **ç»Ÿä¸€ç®¡ç†**ï¼šæ‰€æœ‰æœåŠ¡çš„å®‰å…¨ç­–ç•¥é›†ä¸­ç®¡ç†
- **è‡ªåŠ¨åŒ–**ï¼šè¯ä¹¦è½®æ¢ã€åŠ å¯†ç­‰è‡ªåŠ¨å¤„ç†
- **å¯è§‚æµ‹æ€§**ï¼šè‡ªåŠ¨æ”¶é›†æµé‡æŒ‡æ ‡å’Œæ—¥å¿—
- **è¯­è¨€æ— å…³**ï¼šæ”¯æŒä»»ä½•ç¼–ç¨‹è¯­è¨€çš„æœåŠ¡

**ç¼ºç‚¹** âš ï¸
- **å­¦ä¹ æ›²çº¿é™¡å³­**ï¼šæ¦‚å¿µå¤šï¼Œå­¦ä¹ æˆæœ¬é«˜
- **èµ„æºå¼€é”€**ï¼šæ¯ä¸ªPodéœ€è¦é¢å¤–çš„Sidecarå®¹å™¨
- **å»¶è¿Ÿå¢åŠ **ï¼šè¯·æ±‚è¦ç»è¿‡Sidecarè½¬å‘
- **ä¾èµ–å¹³å°**ï¼šé€šå¸¸éœ€è¦Kubernetesç¯å¢ƒ
- **æ’æŸ¥å›°éš¾**ï¼šé—®é¢˜å¯èƒ½å‡ºåœ¨åº”ç”¨å±‚æˆ–ç½‘æ ¼å±‚

**é€‚ç”¨åœºæ™¯** ğŸ¯
- å¤§è§„æ¨¡å¾®æœåŠ¡é›†ç¾¤ï¼ˆ100+æœåŠ¡ï¼‰
- å¤šè¯­è¨€æ··åˆçš„å¾®æœåŠ¡ç¯å¢ƒ
- éœ€è¦ç»Ÿä¸€å®‰å…¨ç­–ç•¥çš„ä¼ä¸š
- Kubernetesäº‘åŸç”Ÿç¯å¢ƒ

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ”¸ æœåŠ¡é—´é€šä¿¡çš„å®‰å…¨å¨èƒ**
```
å†…ç½‘â‰ å®‰å…¨ï¼éœ€è¦é˜²èŒƒï¼š
â€¢ å†…éƒ¨å¨èƒï¼ˆæ¶æ„å‘˜å·¥ï¼‰
â€¢ æ¨ªå‘ç§»åŠ¨æ”»å‡»
â€¢ é…ç½®é”™è¯¯å¯¼è‡´çš„æš´éœ²
â€¢ ä¾›åº”é“¾æ”»å‡»
```

**ğŸ”¸ å››ç§ä¸»æµè®¤è¯æ–¹æ¡ˆ**

| æ–¹æ¡ˆ | **æ ¸å¿ƒåŸç†** | **é€‚ç”¨åœºæ™¯** |
|-----|------------|------------|
| **API Key** | `å¯†é’¥éªŒè¯èº«ä»½` | `ç®€å•å†…éƒ¨æœåŠ¡` |
| **mTLS** | `åŒå‘è¯ä¹¦è®¤è¯` | `é«˜å®‰å…¨è¦æ±‚` |
| **Service Account** | `å¹³å°çº§èº«ä»½ç®¡ç†` | `Kubernetesç¯å¢ƒ` |
| **æœåŠ¡ç½‘æ ¼** | `åŸºç¡€è®¾æ–½å±‚è‡ªåŠ¨åŒ–` | `å¤§è§„æ¨¡å¾®æœåŠ¡` |

**ğŸ”¸ é›¶ä¿¡ä»»æ ¸å¿ƒåŸåˆ™**
```
1. æ°¸ä¸ä¿¡ä»»ï¼Œå§‹ç»ˆéªŒè¯
2. æœ€å°æƒé™åŸåˆ™
3. æŒç»­ç›‘æ§å’Œå®¡è®¡
```

### 8.2 æ–¹æ¡ˆé€‰æ‹©å†³ç­–æŒ‡å—


**ğŸ”¹ æŒ‰å®‰å…¨ç­‰çº§é€‰æ‹©**
```
ä½å®‰å…¨è¦æ±‚ï¼ˆå†…éƒ¨ç®¡ç†åå°ï¼‰ï¼š
â†’ API Keyè®¤è¯å³å¯

ä¸­ç­‰å®‰å…¨è¦æ±‚ï¼ˆä¸€èˆ¬ä¸šåŠ¡æœåŠ¡ï¼‰ï¼š
â†’ Service Account + JWT Token

é«˜å®‰å…¨è¦æ±‚ï¼ˆé‡‘èã€åŒ»ç–—ï¼‰ï¼š
â†’ mTLSåŒå‘è®¤è¯

è¶…å¤§è§„æ¨¡é›†ç¾¤ï¼ˆ100+æœåŠ¡ï¼‰ï¼š
â†’ æœåŠ¡ç½‘æ ¼ï¼ˆIstio/Linkerdï¼‰
```

**ğŸ”¹ æŒ‰ç¯å¢ƒé€‰æ‹©**
```
Kubernetesç¯å¢ƒï¼š
â†’ ä¼˜å…ˆService Account
â†’ æœ‰æ¡ä»¶éƒ¨ç½²æœåŠ¡ç½‘æ ¼

ä¼ ç»Ÿè™šæ‹Ÿæœºç¯å¢ƒï¼š
â†’ mTLSæˆ–API Key
â†’ è€ƒè™‘é›¶ä¿¡ä»»æ¶æ„

æ··åˆäº‘ç¯å¢ƒï¼š
â†’ é›¶ä¿¡ä»»æ¶æ„
â†’ ç»Ÿä¸€èº«ä»½è®¤è¯å¹³å°
```

### 8.3 å®æ–½å»ºè®®ä¸æœ€ä½³å®è·µ


**ğŸ”§ å®æ–½è·¯çº¿å›¾**

```
ç¬¬1é˜¶æ®µï¼šåŸºç¡€é˜²æŠ¤
- éƒ¨ç½²API Keyè®¤è¯
- å¯ç”¨HTTPSåŠ å¯†
- å®æ–½åŸºæœ¬çš„è®¿é—®æ§åˆ¶

ç¬¬2é˜¶æ®µï¼šå¼ºåŒ–å®‰å…¨
- å¼•å…¥mTLSæˆ–Service Account
- å®æ–½æœ€å°æƒé™åŸåˆ™
- å»ºç«‹å®¡è®¡æ—¥å¿—

ç¬¬3é˜¶æ®µï¼šé›¶ä¿¡ä»»æ¼”è¿›
- éƒ¨ç½²æœåŠ¡ç½‘æ ¼ï¼ˆå¯é€‰ï¼‰
- å®æ–½åŠ¨æ€è®¿é—®æ§åˆ¶
- æŒç»­ç›‘æ§å’Œè‡ªåŠ¨å“åº”
```

**ğŸ¯ å…³é”®å®è·µè¦ç‚¹**

âœ… **è¯ä¹¦ç®¡ç†**
- ä½¿ç”¨è‡ªåŠ¨åŒ–å·¥å…·ç®¡ç†è¯ä¹¦ç”Ÿå‘½å‘¨æœŸ
- è®¾ç½®è¯ä¹¦å³å°†è¿‡æœŸçš„å‘Šè­¦
- å®šæœŸè½®æ¢å¯†é’¥å’Œè¯ä¹¦

âœ… **æƒé™æ§åˆ¶**
- éµå¾ªæœ€å°æƒé™åŸåˆ™
- å®šæœŸå®¡æŸ¥å’Œå›æ”¶æƒé™
- å®æ–½ç»†ç²’åº¦çš„RBAC

âœ… **ç›‘æ§å®¡è®¡**
- è®°å½•æ‰€æœ‰æœåŠ¡é—´è°ƒç”¨
- è®¾ç½®å¼‚å¸¸è¡Œä¸ºå‘Šè­¦
- å®šæœŸåˆ†æå®‰å…¨æ—¥å¿—

âœ… **å¯†é’¥å®‰å…¨**
- æ°¸è¿œä¸è¦ç¡¬ç¼–ç å¯†é’¥
- ä½¿ç”¨å¯†é’¥ç®¡ç†ç³»ç»Ÿï¼ˆå¦‚Vaultï¼‰
- å®æ–½å¯†é’¥å®šæœŸè½®æ¢

### 8.4 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ


**â“ Q1: mTLSæ€§èƒ½å¼€é”€å¤§å—ï¼Ÿ**
```
A: æœ‰ä¸€å®šå¼€é”€ï¼Œä½†å¯ä»¥æ¥å—
â€¢ SSLæ¡æ‰‹ï¼šé¦–æ¬¡è¿æ¥10-50mså»¶è¿Ÿ
â€¢ æ•°æ®åŠ å¯†ï¼šCPUå¼€é”€<5%
â€¢ ä¼˜åŒ–æ–¹æ¡ˆï¼š
  - å¯ç”¨è¿æ¥å¤ç”¨
  - ä½¿ç”¨ç¡¬ä»¶åŠ é€Ÿ
  - åˆç†è®¾ç½®keepalive
```

**â“ Q2: æœåŠ¡ç½‘æ ¼é€‚åˆå°å›¢é˜Ÿå—ï¼Ÿ**
```
A: å–å†³äºå…·ä½“æƒ…å†µ
é€‚åˆï¼š
â€¢ æœåŠ¡æ•°é‡>50ä¸ª
â€¢ å¤šè¯­è¨€æ··åˆç¯å¢ƒ
â€¢ æœ‰ä¸“é—¨çš„å¹³å°å›¢é˜Ÿ

ä¸é€‚åˆï¼š
â€¢ æœåŠ¡æ•°é‡<20ä¸ª
â€¢ å›¢é˜Ÿè§„æ¨¡<10äºº
â€¢ æ²¡æœ‰K8sè¿ç»´ç»éªŒ
```

**â“ Q3: å¦‚ä½•ä»API Keyè¿ç§»åˆ°mTLSï¼Ÿ**
```
A: åˆ†é˜¶æ®µå¹³æ»‘è¿ç§»
æ­¥éª¤1ï¼šéƒ¨ç½²åŒæ¨¡å¼æ”¯æŒ
      åŒæ—¶æ¥å—API Keyå’ŒmTLS

æ­¥éª¤2ï¼šé€æ­¥è¿ç§»å®¢æˆ·ç«¯
      å…ˆè¿ç§»æµ‹è¯•ç¯å¢ƒ
      å†è¿ç§»ç”Ÿäº§ç¯å¢ƒ

æ­¥éª¤3ï¼šå®Œå…¨åˆ‡æ¢
      å…³é—­API Keyè®¤è¯
      åªä¿ç•™mTLS
```

### 8.5 å­¦ä¹ èµ„æºä¸å»¶ä¼¸é˜…è¯»


**ğŸ“š æ¨èå­¦ä¹ è·¯å¾„**
1. å…ˆç†è§£TLS/SSLåŸºç¡€åŸç†
2. å®è·µAPI Keyå’ŒJWTè®¤è¯
3. å­¦ä¹ Kubernetes RBAC
4. æ·±å…¥mTLSåŒå‘è®¤è¯
5. æ¢ç´¢æœåŠ¡ç½‘æ ¼ï¼ˆIstioï¼‰

**ğŸ”— å®˜æ–¹æ–‡æ¡£**
- Spring Security: https://spring.io/projects/spring-security
- Istio Security: https://istio.io/latest/docs/concepts/security/
- Kubernetes Service Account: https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/

**æ ¸å¿ƒè®°å¿†å£è¯€** ğŸ’¡
```
å†…ç½‘ä¸ç­‰äºå®‰å…¨ï¼ŒæœåŠ¡è®¤è¯å¾ˆå…³é”®
API Keyç®€å•å¿«ï¼ŒmTLSå®‰å…¨å…¨
æœåŠ¡è´¦æˆ·äº‘åŸç”Ÿï¼Œç½‘æ ¼è‡ªåŠ¨åŒ–æœ€å…ˆè¿›
é›¶ä¿¡ä»»æ˜¯è¶‹åŠ¿ï¼Œæ°¸ä¸ä¿¡ä»»è¦éªŒè¯
é€‰æ–¹æ¡ˆçœ‹åœºæ™¯ï¼Œå®‰å…¨ä¸æˆæœ¬éœ€å¹³è¡¡
```