---
title: 3ã€Feignå®‰å…¨é›†æˆ
---
## ğŸ“š ç›®å½•

1. [Feignå®‰å…¨é›†æˆæ¦‚è¿°](#1-feignå®‰å…¨é›†æˆæ¦‚è¿°)
2. [RequestInterceptorè¯·æ±‚æ‹¦æˆªå™¨](#2-requestinterceptorè¯·æ±‚æ‹¦æˆªå™¨)
3. [OAuth2ä»¤ç‰Œä¼ é€’æœºåˆ¶](#3-oauth2ä»¤ç‰Œä¼ é€’æœºåˆ¶)
4. [è‡ªåŠ¨ä»¤ç‰Œåˆ·æ–°ç­–ç•¥](#4-è‡ªåŠ¨ä»¤ç‰Œåˆ·æ–°ç­–ç•¥)
5. [Hystrixç†”æ–­å®‰å…¨é…ç½®](#5-hystrixç†”æ–­å®‰å…¨é…ç½®)
6. [è´Ÿè½½å‡è¡¡å®‰å…¨å¤„ç†](#6-è´Ÿè½½å‡è¡¡å®‰å…¨å¤„ç†)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” Feignå®‰å…¨é›†æˆæ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯Feignå®‰å…¨é›†æˆ


**ğŸ¯ æ ¸å¿ƒç†è§£**
```
é€šä¿—æ¯”å–»ï¼š
ä½ åœ¨å…¬å¸å†…éƒ¨æ‰“ç”µè¯ï¼Œä¸éœ€è¦éªŒè¯èº«ä»½
ä½†ç»™å¤–éƒ¨å®¢æˆ·æ‰“ç”µè¯ï¼Œå¿…é¡»å…ˆæŠ¥å…¬å¸åå’Œå·¥å·

Feignè°ƒç”¨å°±åƒæœåŠ¡ä¹‹é—´"æ‰“ç”µè¯"ï¼š
â€¢ æœåŠ¡Aè°ƒç”¨æœåŠ¡Bæ—¶ï¼Œè¦å¸¦ä¸Š"èº«ä»½è¯æ˜"ï¼ˆTokenï¼‰
â€¢ Feignå®‰å…¨é›†æˆå°±æ˜¯è‡ªåŠ¨å¸®ä½ å¸¦ä¸Šè¿™ä¸ª"èº«ä»½è¯æ˜"
â€¢ è®©æœåŠ¡é—´è°ƒç”¨æ—¢æ–¹ä¾¿åˆå®‰å…¨
```

**ğŸ“‹ ä¸ºä»€ä¹ˆéœ€è¦Feignå®‰å…¨é›†æˆ**

```
é—®é¢˜åœºæ™¯ï¼š
ç”¨æˆ·è¯·æ±‚ â†’ ç½‘å…³ï¼ˆæºå¸¦Tokenï¼‰â†’ æœåŠ¡A
                                  â†“
                            æœåŠ¡Aè°ƒç”¨æœåŠ¡Bï¼ˆTokenä¸¢å¤±ï¼Ÿï¼‰
                                  â†“
                            æœåŠ¡Bæ‹’ç»è®¿é—® âŒ

è§£å†³æ–¹æ¡ˆï¼š
ç”¨æˆ·è¯·æ±‚ â†’ ç½‘å…³ï¼ˆTokenï¼‰â†’ æœåŠ¡A
                            â†“ï¼ˆè‡ªåŠ¨ä¼ é€’Tokenï¼‰
                      æœåŠ¡Aè°ƒç”¨æœåŠ¡Bï¼ˆæºå¸¦Tokenï¼‰
                            â†“
                      æœåŠ¡BéªŒè¯é€šè¿‡ âœ…
```

### 1.2 Feignå®‰å…¨é›†æˆæ ¸å¿ƒç»„æˆ


**ğŸ”¹ æ ¸å¿ƒç»„ä»¶å…³ç³»**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Feign Client                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   RequestInterceptor         â”‚  â”‚ â† æ‹¦æˆªæ¯ä¸ªè¯·æ±‚
â”‚  â”‚   (è¯·æ±‚æ‹¦æˆªå™¨)                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚              â†“                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   æ·»åŠ è®¤è¯ä¿¡æ¯                â”‚  â”‚ â† è‡ªåŠ¨æ·»åŠ Token
â”‚  â”‚   (Header/Token)              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚              â†“                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   å‘é€HTTPè¯·æ±‚                â”‚  â”‚ â† è°ƒç”¨ç›®æ ‡æœåŠ¡
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸ›¡ï¸ RequestInterceptorè¯·æ±‚æ‹¦æˆªå™¨


### 2.1 RequestInterceptorå·¥ä½œåŸç†


**ğŸ”¸ æ ¸å¿ƒæ¦‚å¿µ**
```
ä»€ä¹ˆæ˜¯RequestInterceptorï¼Ÿ
å°±åƒæœºåœºå®‰æ£€ï¼š
â€¢ æ¯ä¸ªä¹˜å®¢ï¼ˆè¯·æ±‚ï¼‰éƒ½è¦è¿‡å®‰æ£€
â€¢ å®‰æ£€å‘˜ï¼ˆæ‹¦æˆªå™¨ï¼‰æ£€æŸ¥å¹¶æ·»åŠ å¿…è¦ä¿¡æ¯
â€¢ ç¡®ä¿ç¬¦åˆè¦æ±‚æ‰èƒ½ç™»æœºï¼ˆå‘é€è¯·æ±‚ï¼‰

RequestInterceptoråšä»€ä¹ˆï¼Ÿ
â€¢ åœ¨Feignå‘é€è¯·æ±‚å‰æ‹¦æˆª
â€¢ è‡ªåŠ¨æ·»åŠ è®¤è¯ä¿¡æ¯ï¼ˆTokenã€Headerç­‰ï¼‰
â€¢ ç»Ÿä¸€å¤„ç†å®‰å…¨é€»è¾‘
```

### 2.2 åŸºç¡€æ‹¦æˆªå™¨å®ç°


**ğŸ’» ç®€å•ç¤ºä¾‹**

```java
@Component
public class FeignAuthInterceptor implements RequestInterceptor {
    
    @Override
    public void apply(RequestTemplate template) {
        // è·å–å½“å‰è¯·æ±‚çš„Token
        String token = getCurrentToken();
        
        // æ·»åŠ åˆ°Feignè¯·æ±‚å¤´
        if (token != null) {
            template.header("Authorization", "Bearer " + token);
        }
    }
    
    private String getCurrentToken() {
        // ä»è¯·æ±‚ä¸Šä¸‹æ–‡è·å–Token
        ServletRequestAttributes attributes = 
            (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        
        if (attributes != null) {
            HttpServletRequest request = attributes.getRequest();
            return request.getHeader("Authorization");
        }
        return null;
    }
}
```

**ğŸ“Š å·¥ä½œæµç¨‹**
```
ç”¨æˆ·è¯·æ±‚æºå¸¦Token â†’ æœåŠ¡Aæ¥æ”¶
                      â†“
                Feignè°ƒç”¨æœåŠ¡Bå‰
                      â†“
        FeignAuthInterceptoræ‹¦æˆª
                      â†“
              è·å–åŸå§‹è¯·æ±‚Token
                      â†“
        æ·»åŠ åˆ°Feignè¯·æ±‚Header
                      â†“
          å‘é€è¯·æ±‚åˆ°æœåŠ¡Bï¼ˆå¸¦Tokenï¼‰
```

### 2.3 å¤šç§Ÿæˆ·åœºæ™¯æ‹¦æˆªå™¨


**ğŸ¢ å®é™…åº”ç”¨åœºæ™¯**

```java
@Component
public class MultiTenantFeignInterceptor implements RequestInterceptor {
    
    @Override
    public void apply(RequestTemplate template) {
        // 1ï¸âƒ£ ä¼ é€’Token
        String token = getAuthToken();
        if (token != null) {
            template.header("Authorization", "Bearer " + token);
        }
        
        // 2ï¸âƒ£ ä¼ é€’ç§Ÿæˆ·ID
        String tenantId = getCurrentTenantId();
        if (tenantId != null) {
            template.header("X-Tenant-Id", tenantId);
        }
        
        // 3ï¸âƒ£ ä¼ é€’ç”¨æˆ·ä¿¡æ¯
        String userId = getCurrentUserId();
        if (userId != null) {
            template.header("X-User-Id", userId);
        }
    }
}
```

**ğŸ” åœºæ™¯è¯´æ˜**
```
â”Œâ”€ å¤šç§Ÿæˆ·è°ƒç”¨åœºæ™¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç§Ÿæˆ·Aç”¨æˆ· â†’ æœåŠ¡A â†’ æœåŠ¡B        â”‚
â”‚                                  â”‚
â”‚ éœ€è¦ä¼ é€’ä¿¡æ¯ï¼š                   â”‚
â”‚ âœ“ Tokenï¼ˆèº«ä»½è®¤è¯ï¼‰              â”‚
â”‚ âœ“ Tenant-Idï¼ˆç§Ÿæˆ·éš”ç¦»ï¼‰          â”‚
â”‚ âœ“ User-Idï¼ˆç”¨æˆ·è¿½è¸ªï¼‰            â”‚
â”‚                                  â”‚
â”‚ ç¡®ä¿ï¼š                           â”‚
â”‚ â€¢ æœåŠ¡BçŸ¥é“æ˜¯å“ªä¸ªç§Ÿæˆ·            â”‚
â”‚ â€¢ æ•°æ®éš”ç¦»ä¸ä¼šæ··ä¹±               â”‚
â”‚ â€¢ å¯ä»¥è¿½è¸ªå®Œæ•´è°ƒç”¨é“¾             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. ğŸ« OAuth2ä»¤ç‰Œä¼ é€’æœºåˆ¶


### 3.1 OAuth2FeignRequestInterceptor


**ğŸ”¸ ä»€ä¹ˆæ˜¯OAuth2ä»¤ç‰Œä¼ é€’**

```
ç”Ÿæ´»åœºæ™¯ç±»æ¯”ï¼š
ä½ å»é“¶è¡ŒåŠä¸šåŠ¡ï¼š
â€¢ å…ˆåœ¨å‰å°éªŒè¯èº«ä»½ï¼ˆè·å–Tokenï¼‰
â€¢ æ‹¿ç€å‡­è¯å»ä¸åŒçª—å£åŠç†ï¼ˆæœåŠ¡è°ƒç”¨ï¼‰
â€¢ æ¯ä¸ªçª—å£éƒ½è®¤è¿™ä¸ªå‡­è¯ï¼ˆTokenä¼ é€’ï¼‰

å¾®æœåŠ¡ä¸­ï¼š
ç”¨æˆ·ç™»å½• â†’ è·å–OAuth2 Token
         â†“
      æœåŠ¡Aä½¿ç”¨Token
         â†“
   æœåŠ¡Aè°ƒç”¨æœåŠ¡Bï¼ˆéœ€è¦ä¼ é€’Tokenï¼‰
         â†“
      æœåŠ¡BéªŒè¯Token
```

### 3.2 OAuth2é…ç½®å®ç°


**ğŸ’» åŸºç¡€é…ç½®**

```java
@Configuration
public class FeignOAuth2Configuration {
    
    @Bean
    public RequestInterceptor oauth2FeignRequestInterceptor(
            OAuth2AuthorizedClientManager clientManager) {
        
        return new OAuth2FeignRequestInterceptor(clientManager);
    }
}

// OAuth2æ‹¦æˆªå™¨å®ç°
public class OAuth2FeignRequestInterceptor implements RequestInterceptor {
    
    private OAuth2AuthorizedClientManager clientManager;
    
    @Override
    public void apply(RequestTemplate template) {
        // 1. è·å–å½“å‰OAuth2è®¤è¯ä¿¡æ¯
        Authentication authentication = 
            SecurityContextHolder.getContext().getAuthentication();
        
        if (authentication != null) {
            // 2. è·å–è®¿é—®ä»¤ç‰Œ
            String accessToken = getAccessToken(authentication);
            
            // 3. æ·»åŠ åˆ°è¯·æ±‚å¤´
            template.header("Authorization", "Bearer " + accessToken);
        }
    }
}
```

**ğŸ“Š Tokenä¼ é€’æµç¨‹**
```
â”Œâ”€ OAuth2ä»¤ç‰Œä¼ é€’é“¾è·¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                  â”‚
â”‚ ç”¨æˆ·ç™»å½•                         â”‚
â”‚   â†“                              â”‚
â”‚ è·å–Access Token                 â”‚
â”‚   â†“                              â”‚
â”‚ è°ƒç”¨æœåŠ¡Aï¼ˆæºå¸¦Tokenï¼‰           â”‚
â”‚   â†“                              â”‚
â”‚ æœåŠ¡AéªŒè¯Token âœ“                 â”‚
â”‚   â†“                              â”‚
â”‚ æœåŠ¡Aè°ƒç”¨æœåŠ¡B                   â”‚
â”‚   â†“                              â”‚
â”‚ æ‹¦æˆªå™¨è‡ªåŠ¨æ·»åŠ Token              â”‚
â”‚   â†“                              â”‚
â”‚ æœåŠ¡Bæ¥æ”¶å¹¶éªŒè¯Token âœ“           â”‚
â”‚                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 Tokenä¸Šä¸‹æ–‡ä¼ é€’


**ğŸ”¹ çº¿ç¨‹ä¸Šä¸‹æ–‡é—®é¢˜**

```
é—®é¢˜åœºæ™¯ï¼š
ä¸»çº¿ç¨‹ï¼ˆæœ‰Tokenï¼‰â†’ Feignè°ƒç”¨ â†’ å¼‚æ­¥çº¿ç¨‹ï¼ˆTokenä¸¢å¤±ï¼‰

åŸå› ï¼š
â€¢ Tokenå­˜åœ¨ThreadLocalä¸­
â€¢ å¼‚æ­¥çº¿ç¨‹æ— æ³•è·å–ä¸»çº¿ç¨‹çš„ThreadLocal
â€¢ å¯¼è‡´Feignè°ƒç”¨æ—¶æ‰¾ä¸åˆ°Token
```

**ğŸ’¡ è§£å†³æ–¹æ¡ˆ**

```java
@Component
public class ContextAwareFeignInterceptor implements RequestInterceptor {
    
    @Override
    public void apply(RequestTemplate template) {
        // ä½¿ç”¨å¯ç»§æ‰¿çš„ThreadLocal
        String token = InheritableThreadLocalHolder.getToken();
        
        if (token != null) {
            template.header("Authorization", "Bearer " + token);
        }
    }
}

// å¯ç»§æ‰¿çš„TokenæŒæœ‰è€…
public class InheritableThreadLocalHolder {
    
    private static final InheritableThreadLocal<String> tokenHolder = 
        new InheritableThreadLocal<>();
    
    public static void setToken(String token) {
        tokenHolder.set(token);
    }
    
    public static String getToken() {
        return tokenHolder.get();
    }
    
    public static void clear() {
        tokenHolder.remove();
    }
}
```

---

## 4. ğŸ”„ è‡ªåŠ¨ä»¤ç‰Œåˆ·æ–°ç­–ç•¥


### 4.1 ä¸ºä»€ä¹ˆéœ€è¦ä»¤ç‰Œåˆ·æ–°


**ğŸ¯ æ ¸å¿ƒé—®é¢˜**

```
Tokenè¿‡æœŸåœºæ™¯ï¼š
æ—¶é—´ 0åˆ†é’Ÿï¼šç”¨æˆ·ç™»å½•ï¼Œè·å¾—Tokenï¼ˆæœ‰æ•ˆæœŸ30åˆ†é’Ÿï¼‰
æ—¶é—´25åˆ†é’Ÿï¼šæœåŠ¡Aè°ƒç”¨æœåŠ¡Bï¼ˆTokenè¿˜æœ‰æ•ˆï¼‰âœ“
æ—¶é—´35åˆ†é’Ÿï¼šæœåŠ¡Aè°ƒç”¨æœåŠ¡Bï¼ˆTokenå·²è¿‡æœŸï¼‰âŒ

é—®é¢˜ï¼š
â€¢ Tokenè¿‡æœŸå¯¼è‡´è°ƒç”¨å¤±è´¥
â€¢ ç”¨æˆ·ä½“éªŒå·®ï¼ˆéœ€è¦é‡æ–°ç™»å½•ï¼‰
â€¢ æœåŠ¡é—´è°ƒç”¨ä¸­æ–­

è§£å†³ï¼š
è‡ªåŠ¨åˆ·æ–°Tokenï¼Œæ— æ„ŸçŸ¥ç»­æœŸ
```

### 4.2 ä»¤ç‰Œåˆ·æ–°å®ç°


**ğŸ’» è‡ªåŠ¨åˆ·æ–°é…ç½®**

```java
@Component
public class TokenRefreshInterceptor implements RequestInterceptor {
    
    @Autowired
    private OAuth2RestTemplate restTemplate;
    
    @Override
    public void apply(RequestTemplate template) {
        // 1. è·å–å½“å‰Token
        OAuth2AccessToken accessToken = restTemplate.getAccessToken();
        
        // 2. æ£€æŸ¥æ˜¯å¦å³å°†è¿‡æœŸï¼ˆæå‰5åˆ†é’Ÿåˆ·æ–°ï¼‰
        if (isTokenExpiringSoon(accessToken)) {
            // 3. åˆ·æ–°Token
            accessToken = refreshToken();
        }
        
        // 4. ä½¿ç”¨æœ€æ–°Token
        template.header("Authorization", "Bearer " + accessToken.getValue());
    }
    
    private boolean isTokenExpiringSoon(OAuth2AccessToken token) {
        if (token.getExpiration() == null) {
            return false;
        }
        
        // è·ç¦»è¿‡æœŸæ—¶é—´å°äº5åˆ†é’Ÿ
        Date expiration = token.getExpiration();
        long timeToExpire = expiration.getTime() - System.currentTimeMillis();
        return timeToExpire < 5 * 60 * 1000; // 5åˆ†é’Ÿ
    }
}
```

**ğŸ”„ åˆ·æ–°æ—¶æœºå¯¹æ¯”**

| åˆ·æ–°ç­–ç•¥ | åˆ·æ–°æ—¶æœº | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|---------|---------|------|------|
| **è¢«åŠ¨åˆ·æ–°** | Tokenè¿‡æœŸååˆ·æ–° | ç®€å•ç›´æ¥ | å¯èƒ½å¯¼è‡´è¯·æ±‚å¤±è´¥ |
| **æå‰åˆ·æ–°** | è¿‡æœŸå‰5åˆ†é’Ÿåˆ·æ–° | æ— ç¼è¡”æ¥ | éœ€è¦é¢å¤–åˆ¤æ–­é€»è¾‘ |
| **å®šæ—¶åˆ·æ–°** | å›ºå®šæ—¶é—´é—´éš”åˆ·æ–° | å¯é¢„æµ‹ | å¯èƒ½è¿‡äºé¢‘ç¹ |

**ğŸ¯ æ¨èæ–¹æ¡ˆ**ï¼šæå‰åˆ·æ–°ç­–ç•¥

---

## 5. âš¡ Hystrixç†”æ–­å®‰å…¨é…ç½®


### 5.1 ç†”æ–­ä¸å®‰å…¨çš„å…³ç³»


**ğŸ”¸ æ ¸å¿ƒé—®é¢˜**

```
åœºæ™¯ï¼š
æœåŠ¡Aè°ƒç”¨æœåŠ¡Bï¼ˆéœ€è¦Tokenï¼‰
           â†“
      æœåŠ¡Bå“åº”æ…¢/æ•…éšœ
           â†“
    Hystrixè§¦å‘ç†”æ–­é™çº§
           â†“
    æ‰§è¡ŒFallbacké€»è¾‘
           â†“
    é—®é¢˜ï¼šFallbackä¸­è¿˜éœ€è¦Tokenå—ï¼Ÿ
```

**ğŸ’¡ ä¸¤ç§å¤„ç†æ–¹å¼**

```
æ–¹å¼1ï¼šFallbackä¸éœ€è¦è®¤è¯
â€¢ è¿”å›é»˜è®¤æ•°æ®
â€¢ è¿”å›ç¼“å­˜æ•°æ®
â€¢ ä¸æ¶‰åŠæ•æ„Ÿæ“ä½œ

æ–¹å¼2ï¼šFallbackéœ€è¦è®¤è¯
â€¢ è°ƒç”¨å¤‡ç”¨æœåŠ¡
â€¢ è®¿é—®é™çº§æ•°æ®åº“
â€¢ éœ€è¦ä¼ é€’è®¤è¯ä¿¡æ¯
```

### 5.2 Hystrixå®‰å…¨ä¸Šä¸‹æ–‡é…ç½®


**ğŸ’» é…ç½®ç¤ºä¾‹**

```java
@Configuration
public class HystrixSecurityConfiguration {
    
    @Bean
    public HystrixConcurrencyStrategy securityStrategy() {
        return new SecurityContextConcurrencyStrategy();
    }
}

// è‡ªå®šä¹‰å¹¶å‘ç­–ç•¥
public class SecurityContextConcurrencyStrategy 
        extends HystrixConcurrencyStrategy {
    
    @Override
    public <T> Callable<T> wrapCallable(Callable<T> callable) {
        // è·å–å½“å‰å®‰å…¨ä¸Šä¸‹æ–‡
        SecurityContext context = SecurityContextHolder.getContext();
        
        return () -> {
            try {
                // åœ¨Hystrixçº¿ç¨‹ä¸­è®¾ç½®å®‰å…¨ä¸Šä¸‹æ–‡
                SecurityContextHolder.setContext(context);
                return callable.call();
            } finally {
                SecurityContextHolder.clearContext();
            }
        };
    }
}
```

**ğŸ“Š ä¸Šä¸‹æ–‡ä¼ é€’æµç¨‹**
```
ä¸»çº¿ç¨‹                    Hystrixçº¿ç¨‹æ± 
  |                            |
è·å–SecurityContext            |
  |                            |
  |----(ä¼ é€’ä¸Šä¸‹æ–‡)----------->|
  |                            |
  |                     è®¾ç½®SecurityContext
  |                            |
  |                        æ‰§è¡ŒFallback
  |                            |
  |                        æ¸…ç†ä¸Šä¸‹æ–‡
  |<---------(è¿”å›ç»“æœ)--------|
```

---

## 6. âš–ï¸ è´Ÿè½½å‡è¡¡å®‰å…¨å¤„ç†


### 6.1 Ribbonè´Ÿè½½å‡è¡¡è®¤è¯


**ğŸ”¸ æ ¸å¿ƒé—®é¢˜**

```
åœºæ™¯ï¼š
æœåŠ¡Aè°ƒç”¨æœåŠ¡Bé›†ç¾¤
   â†“
æœåŠ¡B: [å®ä¾‹1, å®ä¾‹2, å®ä¾‹3]
   â†“
Ribbonè´Ÿè½½å‡è¡¡é€‰æ‹©å®ä¾‹
   â†“
é—®é¢˜ï¼šæ¯ä¸ªå®ä¾‹éƒ½è¦éªŒè¯Tokenå—ï¼Ÿ
```

**ğŸ“‹ å¤„ç†æ–¹æ¡ˆ**

```
æ–¹æ¡ˆ1ï¼šç»Ÿä¸€TokenéªŒè¯
â€¢ Tokenåœ¨ç½‘å…³ç»Ÿä¸€éªŒè¯
â€¢ å†…éƒ¨æœåŠ¡é—´ä¿¡ä»»è°ƒç”¨
â€¢ é€‚åˆå°è§„æ¨¡ã€å†…ç½‘ç¯å¢ƒ

æ–¹æ¡ˆ2ï¼šæ¯ä¸ªå®ä¾‹ç‹¬ç«‹éªŒè¯
â€¢ æ¯ä¸ªæœåŠ¡ç‹¬ç«‹éªŒè¯Token
â€¢ æ›´å®‰å…¨ä½†æ€§èƒ½å¼€é”€å¤§
â€¢ é€‚åˆåˆ†å¸ƒå¼ã€å¤šç½‘ç»œç¯å¢ƒ

æ–¹æ¡ˆ3ï¼šæ··åˆæ¨¡å¼ï¼ˆæ¨èï¼‰
â€¢ ç½‘å…³éªŒè¯ + æœåŠ¡æŠ½æŸ¥
â€¢ å¹³è¡¡å®‰å…¨æ€§å’Œæ€§èƒ½
```

### 6.2 è´Ÿè½½å‡è¡¡æ‹¦æˆªå™¨


**ğŸ’» å®ç°ç¤ºä¾‹**

```java
@Component
public class LoadBalancedFeignInterceptor implements RequestInterceptor {
    
    @Override
    public void apply(RequestTemplate template) {
        // 1. æ·»åŠ Token
        addAuthToken(template);
        
        // 2. æ·»åŠ è´Ÿè½½å‡è¡¡è¿½è¸ªID
        addTraceId(template);
        
        // 3. æ·»åŠ é‡è¯•æ ‡è¯†
        addRetryFlag(template);
    }
    
    private void addAuthToken(RequestTemplate template) {
        String token = SecurityContextHolder.getContext()
            .getAuthentication().getCredentials().toString();
        template.header("Authorization", "Bearer " + token);
    }
    
    private void addTraceId(RequestTemplate template) {
        // ä¼ é€’è¿½è¸ªIDï¼Œæ–¹ä¾¿é—®é¢˜æ’æŸ¥
        String traceId = MDC.get("traceId");
        if (traceId != null) {
            template.header("X-Trace-Id", traceId);
        }
    }
}
```

**ğŸ” è´Ÿè½½å‡è¡¡å®‰å…¨é…ç½®**

```yaml
# application.yml
ribbon:
  # è¿æ¥è¶…æ—¶
  ConnectTimeout: 5000
  # è¯»å–è¶…æ—¶
  ReadTimeout: 10000
  # é‡è¯•æ¬¡æ•°
  MaxAutoRetries: 1
  # åˆ‡æ¢å®ä¾‹é‡è¯•æ¬¡æ•°
  MaxAutoRetriesNextServer: 2

feign:
  hystrix:
    enabled: true
  client:
    config:
      default:
        # è¯·æ±‚æ‹¦æˆªå™¨
        requestInterceptors:
          - com.example.security.LoadBalancedFeignInterceptor
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Feignå®‰å…¨é›†æˆï¼šè®©æœåŠ¡é—´è°ƒç”¨è‡ªåŠ¨æºå¸¦è®¤è¯ä¿¡æ¯
ğŸ”¸ RequestInterceptorï¼šè¯·æ±‚æ‹¦æˆªå™¨ï¼Œç»Ÿä¸€å¤„ç†è®¤è¯é€»è¾‘
ğŸ”¸ OAuth2ä¼ é€’ï¼šè‡ªåŠ¨ä¼ é€’å’Œåˆ·æ–°OAuth2 Token
ğŸ”¸ ä¸Šä¸‹æ–‡ä¼ é€’ï¼šè§£å†³å¼‚æ­¥çº¿ç¨‹ä¸­çš„Tokenä¼ é€’é—®é¢˜
ğŸ”¸ ç†”æ–­å®‰å…¨ï¼šHystrixé™çº§æ—¶çš„å®‰å…¨ä¸Šä¸‹æ–‡å¤„ç†
ğŸ”¸ è´Ÿè½½å‡è¡¡ï¼šå¤šå®ä¾‹è°ƒç”¨æ—¶çš„è®¤è¯å¤„ç†
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ Tokenä¼ é€’æ ¸å¿ƒæµç¨‹**
```
â”Œâ”€ å®Œæ•´Tokenä¼ é€’é“¾ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                â”‚
â”‚ 1. ç”¨æˆ·ç™»å½•è·å–Token           â”‚
â”‚         â†“                      â”‚
â”‚ 2. è¯·æ±‚åˆ°è¾¾æœåŠ¡A               â”‚
â”‚         â†“                      â”‚
â”‚ 3. æœåŠ¡AéªŒè¯Token              â”‚
â”‚         â†“                      â”‚
â”‚ 4. Feignè°ƒç”¨æœåŠ¡Bå‰            â”‚
â”‚         â†“                      â”‚
â”‚ 5. æ‹¦æˆªå™¨è·å–Token             â”‚
â”‚         â†“                      â”‚
â”‚ 6. æ·»åŠ åˆ°HTTP Header           â”‚
â”‚         â†“                      â”‚
â”‚ 7. æœåŠ¡Bæ¥æ”¶å¹¶éªŒè¯             â”‚
â”‚                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”¹ æ‹¦æˆªå™¨é…ç½®è¦ç‚¹**

| é…ç½®é¡¹ | ä½œç”¨ | æ³¨æ„äº‹é¡¹ |
|-------|------|---------|
| **å…¨å±€æ‹¦æˆªå™¨** | å¯¹æ‰€æœ‰Feignç”Ÿæ•ˆ | å¯èƒ½å½±å“æ€§èƒ½ |
| **æŒ‡å®šå®¢æˆ·ç«¯æ‹¦æˆªå™¨** | ä»…å¯¹ç‰¹å®šFeignç”Ÿæ•ˆ | æ›´çµæ´»å¯æ§ |
| **å¤šæ‹¦æˆªå™¨é“¾** | å¤šä¸ªæ‹¦æˆªå™¨ç»„åˆ | æ³¨æ„æ‰§è¡Œé¡ºåº |

**ğŸ”¹ å¸¸è§é—®é¢˜è§£å†³**

```
é—®é¢˜1ï¼šTokenä¸¢å¤±
åŸå› ï¼šå¼‚æ­¥çº¿ç¨‹æ— æ³•è·å–ä¸»çº¿ç¨‹Token
è§£å†³ï¼šä½¿ç”¨InheritableThreadLocal

é—®é¢˜2ï¼šTokenè¿‡æœŸ
åŸå› ï¼šé•¿æ—¶é—´è°ƒç”¨å¯¼è‡´Tokenå¤±æ•ˆ
è§£å†³ï¼šæå‰åˆ·æ–°Tokenæœºåˆ¶

é—®é¢˜3ï¼šç†”æ–­åæ— æ³•è®¤è¯
åŸå› ï¼šHystrixçº¿ç¨‹æ± éš”ç¦»å¯¼è‡´ä¸Šä¸‹æ–‡ä¸¢å¤±
è§£å†³ï¼šè‡ªå®šä¹‰HystrixConcurrencyStrategy
```

### 7.3 å®é™…åº”ç”¨å»ºè®®


**ğŸ¯ æœ€ä½³å®è·µ**

```
âœ… æ¨èåšæ³•ï¼š
1. ä½¿ç”¨å…¨å±€æ‹¦æˆªå™¨å¤„ç†é€šç”¨è®¤è¯
2. Tokenæå‰5åˆ†é’Ÿè‡ªåŠ¨åˆ·æ–°
3. é…ç½®Hystrixå®‰å…¨ä¸Šä¸‹æ–‡ä¼ é€’
4. æ·»åŠ è°ƒç”¨é“¾è¿½è¸ªID
5. è®¾ç½®åˆç†çš„è¶…æ—¶å’Œé‡è¯•

âŒ é¿å…åšæ³•ï¼š
1. æ¯ä¸ªFeignå•ç‹¬é…ç½®è®¤è¯
2. Tokenè¿‡æœŸåå†åˆ·æ–°
3. å¿½ç•¥å¼‚æ­¥åœºæ™¯çš„ä¸Šä¸‹æ–‡ä¼ é€’
4. ä¸å¤„ç†ç†”æ–­æ—¶çš„å®‰å…¨é—®é¢˜
```

**ğŸ·ï¸ æŠ€æœ¯é€‰å‹å‚è€ƒ**

```
åœºæ™¯1ï¼šç®€å•å†…éƒ¨è°ƒç”¨
â†’ åŸºç¡€RequestInterceptor
â†’ ä¼ é€’Tokenå³å¯

åœºæ™¯2ï¼šOAuth2è®¤è¯ä½“ç³»
â†’ OAuth2FeignRequestInterceptor  
â†’ è‡ªåŠ¨åˆ·æ–°Token

åœºæ™¯3ï¼šå¤šç§Ÿæˆ·ç³»ç»Ÿ
â†’ MultiTenantFeignInterceptor
â†’ ä¼ é€’ç§Ÿæˆ·ä¿¡æ¯

åœºæ™¯4ï¼šé«˜å¹¶å‘åœºæ™¯
â†’ è´Ÿè½½å‡è¡¡ + Tokenç¼“å­˜
â†’ å‡å°‘è®¤è¯å¼€é”€
```

### 7.4 å­¦ä¹ æ£€æŸ¥æ¸…å•


```
ğŸ“ çŸ¥è¯†æŒæ¡è‡ªæµ‹ï¼š

â–¡ ç†è§£Feignå®‰å…¨é›†æˆçš„å¿…è¦æ€§
â–¡ èƒ½å¤Ÿå®ç°åŸºç¡€RequestInterceptor
â–¡ æŒæ¡OAuth2ä»¤ç‰Œä¼ é€’æœºåˆ¶
â–¡ äº†è§£Tokenè‡ªåŠ¨åˆ·æ–°ç­–ç•¥
â–¡ èƒ½å¤„ç†å¼‚æ­¥åœºæ™¯çš„ä¸Šä¸‹æ–‡ä¼ é€’
â–¡ é…ç½®Hystrixå®‰å…¨ä¸Šä¸‹æ–‡
â–¡ ç†è§£è´Ÿè½½å‡è¡¡ä¸‹çš„è®¤è¯å¤„ç†
â–¡ èƒ½è§£å†³å¸¸è§çš„Tokenä¸¢å¤±é—®é¢˜
```

**ğŸ§  è®°å¿†è¦ç‚¹**
```
æ ¸å¿ƒå£è¯€ï¼š
"æ‹¦æˆªè¯·æ±‚ä¼ Tokenï¼Œä¸Šä¸‹æ–‡ä¿å®‰å…¨
 è‡ªåŠ¨åˆ·æ–°é˜²è¿‡æœŸï¼Œç†”æ–­é™çº§ä¸ä¸¢é“¾"

å…³é”®æ¦‚å¿µï¼š
â€¢ RequestInterceptor = è¯·æ±‚å®ˆé—¨å‘˜
â€¢ OAuth2ä¼ é€’ = èº«ä»½è¯æ¥åŠ›
â€¢ ä¸Šä¸‹æ–‡ä¼ é€’ = è·¨çº¿ç¨‹ä¼ è¯ç­’
â€¢ ç†”æ–­å®‰å…¨ = é™çº§æ—¶çš„æŠ¤èº«ç¬¦
```

---

## ğŸ“š æ‰©å±•å­¦ä¹ 


**ğŸ”— ç›¸å…³ä¸»é¢˜**
- `Spring SecurityåŸºç¡€é…ç½®` â†’ è®¤è¯æˆæƒåŸºç¡€
- `OAuth2.0åè®®è¯¦è§£` â†’ æ·±å…¥ç†è§£Tokenæœºåˆ¶
- `Hystrixç†”æ–­æœºåˆ¶` â†’ æœåŠ¡é™çº§åŸç†
- `å¾®æœåŠ¡è°ƒç”¨é“¾è¿½è¸ª` â†’ åˆ†å¸ƒå¼è¿½è¸ª

**ğŸ’¡ è¿›é˜¶æ–¹å‘**
- è‡ªå®šä¹‰TokenéªŒè¯é€»è¾‘
- å¤šçº§Tokenç¼“å­˜ç­–ç•¥
- æœåŠ¡ç½‘æ ¼(Service Mesh)å®‰å…¨
- é›¶ä¿¡ä»»æ¶æ„å®è·µ