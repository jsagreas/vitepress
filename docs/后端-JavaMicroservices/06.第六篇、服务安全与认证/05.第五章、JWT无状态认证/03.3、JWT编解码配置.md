---
title: 3ã€JWTç¼–è§£ç é…ç½®
---
## ğŸ“š ç›®å½•

1. [JWTç¼–è§£ç æ ¸å¿ƒæ¦‚å¿µ](#1-jwtç¼–è§£ç æ ¸å¿ƒæ¦‚å¿µ)
2. [JwtEncoderç¼–ç å™¨è¯¦è§£](#2-jwtencoderç¼–ç å™¨è¯¦è§£)
3. [JwtDecoderè§£ç å™¨è¯¦è§£](#3-jwtdecoderè§£ç å™¨è¯¦è§£)
4. [å¯†é’¥é…ç½®ä¸ç®¡ç†](#4-å¯†é’¥é…ç½®ä¸ç®¡ç†)
5. [ç®—æ³•é€‰æ‹©ä¸å®‰å…¨æ€§](#5-ç®—æ³•é€‰æ‹©ä¸å®‰å…¨æ€§)
6. [ä»¤ç‰Œåˆ·æ–°æœºåˆ¶](#6-ä»¤ç‰Œåˆ·æ–°æœºåˆ¶)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” JWTç¼–è§£ç æ ¸å¿ƒæ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯JWTç¼–è§£ç 


> ğŸ’¡ **æ ¸å¿ƒç†è§£**ï¼šJWTç¼–è§£ç å°±æ˜¯"åˆ¶ä½œä»¤ç‰Œ"å’Œ"éªŒè¯ä»¤ç‰Œ"çš„è¿‡ç¨‹ï¼Œç±»ä¼¼äºé€ å¸å‚é“¸å¸å’Œé“¶è¡ŒéªŒé’

**é€šä¿—ç†è§£**ï¼š
```
ç”Ÿæ´»ç±»æ¯”ï¼š
é€ å¸å‚ (JwtEncoder) â”€â”€åˆ¶ä½œè´§å¸â”€â”€> æµé€šè´§å¸ â”€â”€éªŒè¯çœŸä¼ªâ”€â”€> é“¶è¡Œ (JwtDecoder)
   â†“                                                    â†“
ç”ŸæˆJWTä»¤ç‰Œ                                          éªŒè¯JWTä»¤ç‰Œ

æ ¸å¿ƒæµç¨‹ï¼š
ç”¨æˆ·ç™»å½• â†’ ç¼–ç å™¨ç”ŸæˆJWT â†’ ç”¨æˆ·æºå¸¦JWTè®¿é—® â†’ è§£ç å™¨éªŒè¯JWT â†’ å…è®¸è®¿é—®
```

**ä¸ºä»€ä¹ˆéœ€è¦ç¼–è§£ç å™¨**ï¼š
- ğŸ”¸ **ç¼–ç å™¨**ï¼šæŠŠç”¨æˆ·ä¿¡æ¯å˜æˆåŠ å¯†ä»¤ç‰Œï¼Œå°±åƒæŠŠç°é‡‘å­˜è¿›é“¶è¡Œå¡
- ğŸ”¸ **è§£ç å™¨**ï¼šéªŒè¯ä»¤ç‰ŒçœŸä¼ªå¹¶å–å‡ºä¿¡æ¯ï¼Œå°±åƒåˆ·å¡å–æ¬¾éªŒè¯èº«ä»½

### 1.2 JWTç¼–è§£ç åœ¨è®¤è¯æµç¨‹ä¸­çš„ä½ç½®


**å®Œæ•´è®¤è¯æµç¨‹**ï¼š
```
å®¢æˆ·ç«¯                     åç«¯æœåŠ¡å™¨
  |                           |
  |--[1]ç”¨æˆ·åå¯†ç ç™»å½•-------->|
  |                           |-[éªŒè¯è´¦å·å¯†ç ]
  |                           |-[JwtEncoderç¼–ç ]
  |<--[2]è¿”å›JWTä»¤ç‰Œ----------|  ç”Ÿæˆä»¤ç‰Œ
  |                           |
  |--[3]æºå¸¦JWTè®¿é—®èµ„æº------->|
  |   (Header: Authorization) |-[JwtDecoderè§£ç ]
  |                           |-[éªŒè¯ç­¾å+æœ‰æ•ˆæœŸ]
  |<--[4]è¿”å›å—ä¿æŠ¤èµ„æº-------|  éªŒè¯é€šè¿‡
```

**å…³é”®ç†è§£**ï¼š
- **ç¼–ç **ï¼šåªåœ¨ç™»å½•æˆåŠŸæ—¶æ‰§è¡Œä¸€æ¬¡ï¼Œç”Ÿæˆä»¤ç‰Œ
- **è§£ç **ï¼šæ¯æ¬¡è®¿é—®å—ä¿æŠ¤èµ„æºéƒ½è¦æ‰§è¡Œï¼ŒéªŒè¯ä»¤ç‰Œ

---

## 2. ğŸ”¨ JwtEncoderç¼–ç å™¨è¯¦è§£


### 2.1 JwtEncoderæ˜¯ä»€ä¹ˆ


> **ç®€å•è¯´**ï¼šJwtEncoderå°±æ˜¯JWTä»¤ç‰Œçš„"ç”Ÿäº§è½¦é—´"ï¼Œè´Ÿè´£æŠŠç”¨æˆ·ä¿¡æ¯æ‰“åŒ…æˆä»¤ç‰Œ

**æ ¸å¿ƒä½œç”¨**ï¼š
```
è¾“å…¥ä¿¡æ¯                JwtEncoder               è¾“å‡ºç»“æœ
ç”¨æˆ·ID + è§’è‰²  â”€â”€â”€â”€>  [åŠ å¯†+ç­¾å]  â”€â”€â”€â”€>  eyJhbGci...å®Œæ•´JWT
æœ‰æ•ˆæœŸé…ç½®                                    å¯ç›´æ¥ä½¿ç”¨çš„ä»¤ç‰Œ
```

### 2.2 NimbusJwtEncoderé…ç½®è¯¦è§£


**ä»€ä¹ˆæ˜¯Nimbus**ï¼š
- Nimbusæ˜¯Spring Securityæ¨èçš„JWTå®ç°åº“
- æä¾›äº†å®‰å…¨å¯é çš„ç¼–ç è§£ç åŠŸèƒ½
- æ”¯æŒå¤šç§åŠ å¯†ç®—æ³•

**åŸºç¡€é…ç½®ç¤ºä¾‹**ï¼š
```java
@Configuration
public class JwtConfig {
    
    // é…ç½®JWTç¼–ç å™¨
    @Bean
    public JwtEncoder jwtEncoder() {
        // åˆ›å»ºå¯†é’¥ï¼ˆå®é™…é¡¹ç›®è¦ä¿å¯†ï¼ï¼‰
        SecretKey key = Keys.hmacShaKeyFor(
            "your-256-bit-secret-key-here-must-be-long-enough".getBytes()
        );
        
        // ä½¿ç”¨Nimbuså®ç°
        return new NimbusJwtEncoder(
            new ImmutableSecret<>(key)
        );
    }
}
```

**é…ç½®è¯´æ˜**ï¼š
- `SecretKey`ï¼šåŠ å¯†å¯†é’¥ï¼Œè‡³å°‘256ä½ï¼ˆ32ä¸ªå­—ç¬¦ï¼‰
- `ImmutableSecret`ï¼šå¯†é’¥åŒ…è£…å™¨ï¼Œä¿è¯å¯†é’¥ä¸å¯å˜
- `NimbusJwtEncoder`ï¼šNimbusåº“æä¾›çš„ç¼–ç å™¨å®ç°

### 2.3 ç”ŸæˆJWTä»¤ç‰Œå®æˆ˜


**ç™»å½•æˆåŠŸåç”Ÿæˆä»¤ç‰Œ**ï¼š
```java
@Service
public class AuthService {
    
    @Autowired
    private JwtEncoder jwtEncoder;
    
    // ç”¨æˆ·ç™»å½•æˆåŠŸï¼Œç”ŸæˆJWT
    public String generateToken(String username, List<String> roles) {
        
        // è®¾ç½®ä»¤ç‰Œæœ‰æ•ˆæœŸï¼ˆ1å°æ—¶ï¼‰
        Instant now = Instant.now();
        Instant expiry = now.plus(1, ChronoUnit.HOURS);
        
        // æ„å»ºJWTå£°æ˜ï¼ˆç”¨æˆ·ä¿¡æ¯ï¼‰
        JwtClaimsSet claims = JwtClaimsSet.builder()
            .issuer("my-app")              // ä»¤ç‰Œç­¾å‘è€…
            .subject(username)             // ç”¨æˆ·å
            .issuedAt(now)                 // ç­¾å‘æ—¶é—´
            .expiresAt(expiry)             // è¿‡æœŸæ—¶é—´
            .claim("roles", roles)         // è‡ªå®šä¹‰ï¼šç”¨æˆ·è§’è‰²
            .build();
        
        // ç¼–ç ç”ŸæˆJWT
        return jwtEncoder.encode(
            JwtEncoderParameters.from(claims)
        ).getTokenValue();
    }
}
```

**ä»£ç è¯¦è§£**ï¼š
- `JwtClaimsSet`ï¼šJWTçš„"å†…å®¹æ¸…å•"ï¼ŒåŒ…å«ç”¨æˆ·ä¿¡æ¯
- `subject`ï¼šä¸»é¢˜ï¼Œé€šå¸¸æ”¾ç”¨æˆ·å
- `claim`ï¼šè‡ªå®šä¹‰å­—æ®µï¼Œè¿™é‡Œæ”¾è§’è‰²ä¿¡æ¯
- `encode()`ï¼šæ‰§è¡Œç¼–ç ï¼Œç”Ÿæˆæœ€ç»ˆä»¤ç‰Œ

**ç”Ÿæˆçš„JWTç»“æ„**ï¼š
```
eyJhbGci...     .    eyJzdWI...    .    SflKxwRJ...
   â†“                    â†“                   â†“
 Header             Payload            Signature
(ç®—æ³•ä¿¡æ¯)          (ç”¨æˆ·æ•°æ®)          (ç­¾åéªŒè¯)
```

---

## 3. ğŸ” JwtDecoderè§£ç å™¨è¯¦è§£


### 3.1 JwtDecoderæ˜¯ä»€ä¹ˆ


> **ç®€å•è¯´**ï¼šJwtDecoderæ˜¯JWTä»¤ç‰Œçš„"è´¨æ£€éƒ¨é—¨"ï¼Œè´Ÿè´£éªŒè¯ä»¤ç‰ŒçœŸå‡å¹¶æå–ä¿¡æ¯

**æ ¸å¿ƒèŒè´£**ï¼š
```
å®¢æˆ·ç«¯JWTä»¤ç‰Œ  â”€â”€â”€â”€>  JwtDecoder  â”€â”€â”€â”€>  éªŒè¯ç»“æœ
                         |
                    [éªŒè¯ç­¾å]
                    [æ£€æŸ¥è¿‡æœŸ]
                    [æå–ä¿¡æ¯]
                         |
                         â†“
                    âœ… é€šè¿‡ï¼šè¿”å›ç”¨æˆ·ä¿¡æ¯
                    âŒ å¤±è´¥ï¼šæŠ›å‡ºå¼‚å¸¸
```

### 3.2 NimbusJwtDecoderé…ç½®è¯¦è§£


**åŸºç¡€é…ç½®ç¤ºä¾‹**ï¼š
```java
@Configuration
public class JwtConfig {
    
    // é…ç½®JWTè§£ç å™¨
    @Bean
    public JwtDecoder jwtDecoder() {
        // ä½¿ç”¨ç›¸åŒçš„å¯†é’¥ï¼ˆå¿…é¡»å’Œç¼–ç å™¨ä¸€è‡´ï¼ï¼‰
        SecretKey key = Keys.hmacShaKeyFor(
            "your-256-bit-secret-key-here-must-be-long-enough".getBytes()
        );
        
        // åˆ›å»ºNimbusè§£ç å™¨
        return NimbusJwtDecoder.withSecretKey(key).build();
    }
}
```

**å…³é”®ç‚¹**ï¼š
- âš ï¸ **å¯†é’¥å¿…é¡»ä¸€è‡´**ï¼šè§£ç å™¨çš„å¯†é’¥è¦å’Œç¼–ç å™¨å®Œå…¨ç›¸åŒ
- âš ï¸ **è‡ªåŠ¨éªŒè¯**ï¼šè§£ç å™¨ä¼šè‡ªåŠ¨æ£€æŸ¥ç­¾åå’Œæœ‰æ•ˆæœŸ
- âœ… **éªŒè¯å¤±è´¥**ï¼šè‡ªåŠ¨æŠ›å‡ºå¼‚å¸¸ï¼Œæ— éœ€æ‰‹åŠ¨å¤„ç†

### 3.3 è§£ç éªŒè¯å®æˆ˜


**éªŒè¯å¹¶æå–ç”¨æˆ·ä¿¡æ¯**ï¼š
```java
@Service
public class TokenService {
    
    @Autowired
    private JwtDecoder jwtDecoder;
    
    // éªŒè¯JWTå¹¶è·å–ç”¨æˆ·ä¿¡æ¯
    public UserDetails validateToken(String token) {
        try {
            // è§£ç JWTï¼ˆè‡ªåŠ¨éªŒè¯ç­¾åå’Œæœ‰æ•ˆæœŸï¼‰
            Jwt jwt = jwtDecoder.decode(token);
            
            // æå–ç”¨æˆ·ä¿¡æ¯
            String username = jwt.getSubject();
            List<String> roles = jwt.getClaim("roles");
            
            // è½¬æ¢ä¸ºUserDetailså¯¹è±¡
            return User.builder()
                .username(username)
                .authorities(roles.stream()
                    .map(SimpleGrantedAuthority::new)
                    .collect(Collectors.toList()))
                .build();
                
        } catch (JwtException e) {
            // ä»¤ç‰Œæ— æ•ˆï¼ˆè¿‡æœŸã€ç­¾åé”™è¯¯ç­‰ï¼‰
            throw new BadCredentialsException("æ— æ•ˆçš„JWTä»¤ç‰Œ");
        }
    }
}
```

**éªŒè¯è¿‡ç¨‹**ï¼š
```
JWTä»¤ç‰Œè¾“å…¥
    â†“
[éªŒè¯ç­¾å] â”€â”€å¤±è´¥â”€â”€> JwtExceptionå¼‚å¸¸
    â†“ é€šè¿‡
[æ£€æŸ¥è¿‡æœŸ] â”€â”€è¿‡æœŸâ”€â”€> JwtExceptionå¼‚å¸¸
    â†“ æœ‰æ•ˆ
[æå–ä¿¡æ¯] â”€â”€è¿”å›â”€â”€> UserDetailså¯¹è±¡
```

---

## 4. ğŸ”‘ å¯†é’¥é…ç½®ä¸ç®¡ç†


### 4.1 å¯†é’¥ç”Ÿæˆæ–¹å¼


**å¯¹ç§°å¯†é’¥ï¼ˆHMACç®—æ³•ï¼‰**ï¼š
```java
// æ–¹å¼1ï¼šæ‰‹åŠ¨æŒ‡å®šå¯†é’¥
SecretKey key = Keys.hmacShaKeyFor(
    "è‡³å°‘32ä¸ªå­—ç¬¦çš„å¯†é’¥å­—ç¬¦ä¸²abcdefg123456".getBytes(StandardCharsets.UTF_8)
);

// æ–¹å¼2ï¼šéšæœºç”Ÿæˆå¯†é’¥ï¼ˆæ¨èç”¨äºç”Ÿäº§ç¯å¢ƒï¼‰
SecretKey key = Keys.secretKeyFor(SignatureAlgorithm.HS256);
```

**éå¯¹ç§°å¯†é’¥ï¼ˆRSAç®—æ³•ï¼‰**ï¼š
```java
// ç”ŸæˆRSAå¯†é’¥å¯¹
KeyPair keyPair = Keys.keyPairFor(SignatureAlgorithm.RS256);
RSAPrivateKey privateKey = (RSAPrivateKey) keyPair.getPrivate();
RSAPublicKey publicKey = (RSAPublicKey) keyPair.getPublic();

// ç¼–ç å™¨ä½¿ç”¨ç§é’¥
JwtEncoder encoder = new NimbusJwtEncoder(
    new ImmutableSecret<>(privateKey)
);

// è§£ç å™¨ä½¿ç”¨å…¬é’¥
JwtDecoder decoder = NimbusJwtDecoder.withPublicKey(publicKey).build();
```

### 4.2 å¯†é’¥ç®¡ç†æœ€ä½³å®è·µ


> âš ï¸ **å®‰å…¨è­¦å‘Š**ï¼šå¯†é’¥æ³„éœ²ç­‰äºç³»ç»Ÿå¤±å®ˆï¼

**ç”Ÿäº§ç¯å¢ƒå¯†é’¥é…ç½®**ï¼š

| é…ç½®æ–¹å¼ | **å®‰å…¨ç­‰çº§** | **ä½¿ç”¨åœºæ™¯** |
|---------|------------|-------------|
| ç¡¬ç¼–ç  | âŒ æä¸å®‰å…¨ | ä»…ç”¨äºå­¦ä¹ æµ‹è¯• |
| é…ç½®æ–‡ä»¶ | âš ï¸ ä¸€èˆ¬ | éœ€åŠ å¯†é…ç½®æ–‡ä»¶ |
| ç¯å¢ƒå˜é‡ | âœ… æ¨è | ç”Ÿäº§ç¯å¢ƒé¦–é€‰ |
| å¯†é’¥ç®¡ç†æœåŠ¡ | âœ…âœ… æœ€å®‰å…¨ | ä¼ä¸šçº§åº”ç”¨ |

**æ¨èé…ç½®æ–¹å¼**ï¼š
```yaml
# application.ymlï¼ˆä»…å­˜å‚¨å ä½ç¬¦ï¼‰
jwt:
  secret: ${JWT_SECRET_KEY}  # ä»ç¯å¢ƒå˜é‡è¯»å–
  
# å®é™…éƒ¨ç½²æ—¶è®¾ç½®ç¯å¢ƒå˜é‡
# export JWT_SECRET_KEY="your-production-secret-key"
```

```java
@Configuration
public class JwtConfig {
    
    @Value("${jwt.secret}")
    private String secretKey;
    
    @Bean
    public JwtEncoder jwtEncoder() {
        SecretKey key = Keys.hmacShaKeyFor(secretKey.getBytes());
        return new NimbusJwtEncoder(new ImmutableSecret<>(key));
    }
}
```

**å¯†é’¥å®‰å…¨æ¸…å•**ï¼š
- âœ… é•¿åº¦è‡³å°‘256ä½
- âœ… ä½¿ç”¨å¼ºéšæœºç”Ÿæˆ
- âœ… å®šæœŸè½®æ¢æ›´æ–°
- âœ… ä¸åŒç¯å¢ƒä¸åŒå¯†é’¥
- âŒ ç»ä¸æäº¤åˆ°ä»£ç ä»“åº“

---

## 5. ğŸ›¡ï¸ ç®—æ³•é€‰æ‹©ä¸å®‰å…¨æ€§


### 5.1 å¸¸ç”¨JWTç®—æ³•å¯¹æ¯”


**ç®—æ³•åˆ†ç±»**ï¼š
```
å¯¹ç§°åŠ å¯†ï¼ˆHMACç³»åˆ—ï¼‰          éå¯¹ç§°åŠ å¯†ï¼ˆRSA/ECç³»åˆ—ï¼‰
    â†“                              â†“
åŒä¸€å¯†é’¥ç¼–ç è§£ç               ç§é’¥ç¼–ç ï¼Œå…¬é’¥è§£ç 
    â†“                              â†“
é€Ÿåº¦å¿«ï¼Œé…ç½®ç®€å•              æ›´å®‰å…¨ï¼Œé€‚åˆåˆ†å¸ƒå¼
```

| ç®—æ³• | **ç±»å‹** | **å¯†é’¥é•¿åº¦** | **æ€§èƒ½** | **é€‚ç”¨åœºæ™¯** |
|------|---------|------------|---------|-------------|
| HS256 | å¯¹ç§° | 256ä½ | âš¡ æœ€å¿« | å•ä½“åº”ç”¨ |
| HS384 | å¯¹ç§° | 384ä½ | âš¡ å¿« | é«˜å®‰å…¨è¦æ±‚ |
| RS256 | éå¯¹ç§° | 2048ä½ | ğŸ¢ è¾ƒæ…¢ | å¾®æœåŠ¡æ¶æ„ |
| ES256 | éå¯¹ç§° | 256ä½ | ğŸš€ è¾ƒå¿« | ç§»åŠ¨åº”ç”¨ |

### 5.2 ç®—æ³•é€‰æ‹©å»ºè®®


**å•ä½“åº”ç”¨æ¨è**ï¼š
```java
// ä½¿ç”¨HS256ï¼ˆHMAC-SHA256ï¼‰
@Bean
public JwtEncoder jwtEncoder() {
    SecretKey key = Keys.secretKeyFor(SignatureAlgorithm.HS256);
    return new NimbusJwtEncoder(new ImmutableSecret<>(key));
}
```

**å¾®æœåŠ¡æ¶æ„æ¨è**ï¼š
```java
// ä½¿ç”¨RS256ï¼ˆRSA-SHA256ï¼‰
@Bean
public JwtEncoder jwtEncoder(RSAPrivateKey privateKey) {
    return new NimbusJwtEncoder(new ImmutableSecret<>(privateKey));
}

@Bean
public JwtDecoder jwtDecoder(RSAPublicKey publicKey) {
    return NimbusJwtDecoder.withPublicKey(publicKey).build();
}
```

**é€‰æ‹©åŸåˆ™**ï¼š
- ğŸ”¸ **å•æœºéƒ¨ç½²** â†’ HS256ï¼ˆç®€å•å¿«é€Ÿï¼‰
- ğŸ”¸ **å¾®æœåŠ¡** â†’ RS256ï¼ˆå…¬é’¥å¯å…±äº«ï¼‰
- ğŸ”¸ **ç§»åŠ¨ç«¯** â†’ ES256ï¼ˆæ€§èƒ½å¥½ï¼‰
- ğŸ”¸ **é«˜å®‰å…¨** â†’ ä½¿ç”¨æ›´é•¿å¯†é’¥ï¼ˆHS512ã€RS512ï¼‰

---

## 6. ğŸ”„ ä»¤ç‰Œåˆ·æ–°æœºåˆ¶


### 6.1 ä¸ºä»€ä¹ˆéœ€è¦åˆ·æ–°ä»¤ç‰Œ


**é—®é¢˜åœºæ™¯**ï¼š
```
ç”¨æˆ·ç™»å½• â†’ è·å¾—1å°æ—¶æœ‰æ•ˆJWT â†’ 1å°æ—¶åè¿‡æœŸ â†’ ç”¨æˆ·è¢«å¼ºåˆ¶é€€å‡º âŒ

ç†æƒ³ä½“éªŒï¼š
ç”¨æˆ·ç™»å½• â†’ é•¿æœŸä½¿ç”¨ â†’ æ— æ„ŸçŸ¥ç»­æœŸ â†’ å®‰å…¨ä¸”æ–¹ä¾¿ âœ…
```

> ğŸ’¡ **æ ¸å¿ƒæ€è·¯**ï¼šå‘æ”¾ä¸¤ä¸ªä»¤ç‰Œ - è®¿é—®ä»¤ç‰Œï¼ˆçŸ­æœŸï¼‰+ åˆ·æ–°ä»¤ç‰Œï¼ˆé•¿æœŸï¼‰

### 6.2 åŒä»¤ç‰Œæœºåˆ¶è®¾è®¡


**ä»¤ç‰Œå¯¹æ¯”**ï¼š

| ä»¤ç‰Œç±»å‹ | **æœ‰æ•ˆæœŸ** | **ç”¨é€”** | **å­˜å‚¨ä½ç½®** |
|---------|----------|---------|------------|
| Access Token | 15åˆ†é’Ÿ | è®¿é—®èµ„æº | å†…å­˜/LocalStorage |
| Refresh Token | 7å¤© | åˆ·æ–°Access Token | HttpOnly Cookie |

**å·¥ä½œæµç¨‹**ï¼š
```
ç™»å½•æˆåŠŸ
   â†“
ç”ŸæˆåŒä»¤ç‰Œï¼š
â€¢ AccessToken (15åˆ†é’Ÿ)
â€¢ RefreshToken (7å¤©)
   â†“
æ­£å¸¸è®¿é—®(15åˆ†é’Ÿå†…)
   â†“
AccessTokenè¿‡æœŸ
   â†“
ä½¿ç”¨RefreshTokenæ¢æ–°AccessToken
   â†“
ç»§ç»­è®¿é—®(æ–°15åˆ†é’Ÿ)
```

### 6.3 åˆ·æ–°ä»¤ç‰Œå®ç°


**ç”ŸæˆåŒä»¤ç‰Œ**ï¼š
```java
@Service
public class TokenService {
    
    @Autowired
    private JwtEncoder jwtEncoder;
    
    // ç”Ÿæˆè®¿é—®ä»¤ç‰Œï¼ˆçŸ­æœŸï¼‰
    public String generateAccessToken(String username, List<String> roles) {
        Instant now = Instant.now();
        JwtClaimsSet claims = JwtClaimsSet.builder()
            .subject(username)
            .claim("roles", roles)
            .issuedAt(now)
            .expiresAt(now.plus(15, ChronoUnit.MINUTES))  // 15åˆ†é’Ÿ
            .build();
        return jwtEncoder.encode(JwtEncoderParameters.from(claims)).getTokenValue();
    }
    
    // ç”Ÿæˆåˆ·æ–°ä»¤ç‰Œï¼ˆé•¿æœŸï¼‰
    public String generateRefreshToken(String username) {
        Instant now = Instant.now();
        JwtClaimsSet claims = JwtClaimsSet.builder()
            .subject(username)
            .claim("type", "refresh")  // æ ‡è®°ä¸ºåˆ·æ–°ä»¤ç‰Œ
            .issuedAt(now)
            .expiresAt(now.plus(7, ChronoUnit.DAYS))  // 7å¤©
            .build();
        return jwtEncoder.encode(JwtEncoderParameters.from(claims)).getTokenValue();
    }
}
```

**åˆ·æ–°æ¥å£å®ç°**ï¼š
```java
@RestController
@RequestMapping("/auth")
public class AuthController {
    
    @Autowired
    private TokenService tokenService;
    
    @Autowired
    private JwtDecoder jwtDecoder;
    
    // åˆ·æ–°ä»¤ç‰Œæ¥å£
    @PostMapping("/refresh")
    public ResponseEntity<?> refreshToken(
        @RequestHeader("Refresh-Token") String refreshToken
    ) {
        try {
            // éªŒè¯åˆ·æ–°ä»¤ç‰Œ
            Jwt jwt = jwtDecoder.decode(refreshToken);
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºåˆ·æ–°ä»¤ç‰Œç±»å‹
            if (!"refresh".equals(jwt.getClaim("type"))) {
                return ResponseEntity.status(401).body("æ— æ•ˆçš„åˆ·æ–°ä»¤ç‰Œ");
            }
            
            String username = jwt.getSubject();
            List<String> roles = loadUserRoles(username);
            
            // ç”Ÿæˆæ–°çš„è®¿é—®ä»¤ç‰Œ
            String newAccessToken = tokenService.generateAccessToken(username, roles);
            
            return ResponseEntity.ok(Map.of("accessToken", newAccessToken));
            
        } catch (JwtException e) {
            return ResponseEntity.status(401).body("åˆ·æ–°ä»¤ç‰Œå·²è¿‡æœŸ");
        }
    }
}
```

**å‰ç«¯åˆ·æ–°é€»è¾‘**ï¼š
```javascript
// æ‹¦æˆªå™¨æ£€æµ‹401é”™è¯¯
axios.interceptors.response.use(
  response => response,
  async error => {
    if (error.response?.status === 401) {
      // AccessTokenè¿‡æœŸï¼Œå°è¯•åˆ·æ–°
      const refreshToken = localStorage.getItem('refreshToken');
      
      const response = await axios.post('/auth/refresh', null, {
        headers: { 'Refresh-Token': refreshToken }
      });
      
      // æ›´æ–°AccessToken
      localStorage.setItem('accessToken', response.data.accessToken);
      
      // é‡è¯•åŸè¯·æ±‚
      return axios(error.config);
    }
    return Promise.reject(error);
  }
);
```

### 6.4 åˆ·æ–°æœºåˆ¶å®‰å…¨è€ƒè™‘


**å®‰å…¨æªæ–½**ï¼š
- ğŸ”¸ **RefreshTokenå­˜å‚¨**ï¼šä½¿ç”¨HttpOnly Cookieé˜²æ­¢XSS
- ğŸ”¸ **å•æ¬¡ä½¿ç”¨**ï¼šåˆ·æ–°åæ—§RefreshTokenå¤±æ•ˆ
- ğŸ”¸ **è®¾å¤‡ç»‘å®š**ï¼šè®°å½•è®¾å¤‡æŒ‡çº¹ï¼Œé˜²æ­¢ç›—ç”¨
- ğŸ”¸ **é»‘åå•æœºåˆ¶**ï¼šç”¨æˆ·ç™»å‡ºæ—¶åŠ å…¥é»‘åå•

**åˆ·æ–°ä»¤ç‰Œé»‘åå•**ï¼š
```java
@Service
public class TokenBlacklistService {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    // åŠ å…¥é»‘åå•
    public void addToBlacklist(String refreshToken) {
        Jwt jwt = jwtDecoder.decode(refreshToken);
        long ttl = jwt.getExpiresAt().getEpochSecond() - Instant.now().getEpochSecond();
        redisTemplate.opsForValue().set(
            "blacklist:" + refreshToken, 
            "revoked", 
            ttl, 
            TimeUnit.SECONDS
        );
    }
    
    // æ£€æŸ¥æ˜¯å¦åœ¨é»‘åå•
    public boolean isBlacklisted(String refreshToken) {
        return redisTemplate.hasKey("blacklist:" + refreshToken);
    }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ JwtEncoderï¼šä»¤ç‰Œç”Ÿæˆå™¨ï¼Œç™»å½•æ—¶ä½¿ç”¨
ğŸ”¸ JwtDecoderï¼šä»¤ç‰ŒéªŒè¯å™¨ï¼Œè®¿é—®èµ„æºæ—¶ä½¿ç”¨
ğŸ”¸ å¯†é’¥ç®¡ç†ï¼šç”Ÿäº§ç¯å¢ƒå¿…é¡»ç”¨ç¯å¢ƒå˜é‡æˆ–å¯†é’¥æœåŠ¡
ğŸ”¸ ç®—æ³•é€‰æ‹©ï¼šå•ä½“ç”¨HS256ï¼Œå¾®æœåŠ¡ç”¨RS256
ğŸ”¸ ä»¤ç‰Œåˆ·æ–°ï¼šåŒä»¤ç‰Œæœºåˆ¶ï¼ŒAccessTokençŸ­æœŸ+RefreshTokené•¿æœŸ
```

### 7.2 é…ç½®æ£€æŸ¥æ¸…å•


**ç¼–ç å™¨é…ç½®**ï¼š
- [ ] é€‰æ‹©åˆé€‚çš„åŠ å¯†ç®—æ³•
- [ ] é…ç½®å®‰å…¨çš„å¯†é’¥ï¼ˆé•¿åº¦â‰¥256ä½ï¼‰
- [ ] è®¾ç½®åˆç†çš„ä»¤ç‰Œæœ‰æ•ˆæœŸ
- [ ] æ·»åŠ å¿…è¦çš„å£°æ˜ä¿¡æ¯

**è§£ç å™¨é…ç½®**ï¼š
- [ ] ä½¿ç”¨ä¸ç¼–ç å™¨ç›¸åŒçš„å¯†é’¥
- [ ] é…ç½®ç­¾åéªŒè¯
- [ ] é…ç½®æœ‰æ•ˆæœŸæ£€æŸ¥
- [ ] å¤„ç†éªŒè¯å¤±è´¥å¼‚å¸¸

**å¯†é’¥å®‰å…¨**ï¼š
- [ ] ä¸åœ¨ä»£ç ä¸­ç¡¬ç¼–ç å¯†é’¥
- [ ] ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–å¯†é’¥ç®¡ç†æœåŠ¡
- [ ] ä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒå¯†é’¥
- [ ] å®šæœŸè½®æ¢å¯†é’¥

**åˆ·æ–°æœºåˆ¶**ï¼š
- [ ] å®ç°åŒä»¤ç‰Œæœºåˆ¶
- [ ] AccessTokenè®¾ç½®çŸ­æœŸï¼ˆ15-30åˆ†é’Ÿï¼‰
- [ ] RefreshTokenè®¾ç½®é•¿æœŸï¼ˆ7-30å¤©ï¼‰
- [ ] å®ç°ä»¤ç‰Œé»‘åå•

### 7.3 å¸¸è§é—®é¢˜è§£ç­”


**Q1ï¼šç¼–ç å™¨å’Œè§£ç å™¨ä¸€å®šè¦é…å¯¹å—ï¼Ÿ**
```
Aï¼šæ˜¯çš„ï¼å¯†é’¥å¿…é¡»å®Œå…¨ä¸€è‡´ã€‚
   HS256ï¼šç¼–ç å’Œè§£ç ç”¨åŒä¸€ä¸ªå¯†é’¥
   RS256ï¼šç¼–ç ç”¨ç§é’¥ï¼Œè§£ç ç”¨å¯¹åº”çš„å…¬é’¥
```

**Q2ï¼šAccessTokenè¿‡æœŸåæ€ä¹ˆåŠï¼Ÿ**
```
Aï¼šä½¿ç”¨RefreshTokenæ¢å–æ–°çš„AccessToken
   å‰ç«¯è‡ªåŠ¨æ£€æµ‹401é”™è¯¯ â†’ è°ƒç”¨åˆ·æ–°æ¥å£ â†’ è·å–æ–°ä»¤ç‰Œ â†’ é‡è¯•è¯·æ±‚
```

**Q3ï¼šå¦‚ä½•å¼ºåˆ¶ç”¨æˆ·ä¸‹çº¿ï¼Ÿ**
```
Aï¼šå°†RefreshTokenåŠ å…¥é»‘åå•
   ç”¨æˆ·é€€å‡ºç™»å½• â†’ RefreshTokenåŠ å…¥Redisé»‘åå• â†’ æ— æ³•åˆ·æ–° â†’ è‡ªåŠ¨ä¸‹çº¿
```

**Q4ï¼šå¾®æœåŠ¡ä¸­å¦‚ä½•å…±äº«JWTéªŒè¯ï¼Ÿ**
```
Aï¼šä½¿ç”¨éå¯¹ç§°åŠ å¯†ï¼ˆRS256ï¼‰
   è®¤è¯æœåŠ¡ï¼šä½¿ç”¨ç§é’¥ç”ŸæˆJWT
   ä¸šåŠ¡æœåŠ¡ï¼šä½¿ç”¨å…¬é’¥éªŒè¯JWTï¼ˆæ— éœ€å…±äº«ç§é’¥ï¼‰
```

### 7.4 å®æˆ˜åº”ç”¨ä»·å€¼


**å•ä½“åº”ç”¨**ï¼š
- âœ… ä½¿ç”¨HS256å¯¹ç§°åŠ å¯†
- âœ… ç¼–ç å™¨å’Œè§£ç å™¨å…±äº«å¯†é’¥
- âœ… é…ç½®ç®€å•ï¼Œæ€§èƒ½é«˜æ•ˆ

**å¾®æœåŠ¡æ¶æ„**ï¼š
- âœ… ä½¿ç”¨RS256éå¯¹ç§°åŠ å¯†
- âœ… è®¤è¯æœåŠ¡æŒæœ‰ç§é’¥ç”ŸæˆJWT
- âœ… ä¸šåŠ¡æœåŠ¡ä½¿ç”¨å…¬é’¥éªŒè¯JWT
- âœ… æ— éœ€å¯†é’¥å…±äº«ï¼Œæ›´å®‰å…¨

**ç§»åŠ¨åº”ç”¨**ï¼š
- âœ… å®ç°ä»¤ç‰Œè‡ªåŠ¨åˆ·æ–°
- âœ… RefreshTokené•¿æœŸæœ‰æ•ˆ
- âœ… æå‡ç”¨æˆ·ä½“éªŒ

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
ç¼–ç å™¨ç”Ÿæˆï¼Œè§£ç å™¨éªŒè¯
å¯†é’¥ä¸€è‡´ï¼Œç®—æ³•åŒ¹é…
å¯¹ç§°å¿«é€Ÿï¼Œéå¯¹ç§°å®‰å…¨
çŸ­æœŸè®¿é—®ï¼Œé•¿æœŸåˆ·æ–°
ç¯å¢ƒå˜é‡ï¼Œå®‰å…¨ç¬¬ä¸€
```