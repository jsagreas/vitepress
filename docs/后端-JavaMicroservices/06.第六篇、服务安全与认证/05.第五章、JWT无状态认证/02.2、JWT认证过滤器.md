---
title: 2ã€JWTè®¤è¯è¿‡æ»¤å™¨
---
## ğŸ“š ç›®å½•

1. [è®¤è¯è¿‡æ»¤å™¨æ ¸å¿ƒæ¦‚å¿µ](#1-è®¤è¯è¿‡æ»¤å™¨æ ¸å¿ƒæ¦‚å¿µ)
2. [OncePerRequestFilterå•æ¬¡è¿‡æ»¤å™¨](#2-OncePerRequestFilterå•æ¬¡è¿‡æ»¤å™¨)
3. [Authorization Headerè§£æ](#3-Authorization-Headerè§£æ)
4. [Bearer Tokenæå–ä¸éªŒè¯](#4-Bearer-Tokenæå–ä¸éªŒè¯)
5. [JwtAuthenticationTokenä»¤ç‰Œå¯¹è±¡](#5-JwtAuthenticationTokenä»¤ç‰Œå¯¹è±¡)
6. [SecurityContextå®‰å…¨ä¸Šä¸‹æ–‡è®¾ç½®](#6-SecurityContextå®‰å…¨ä¸Šä¸‹æ–‡è®¾ç½®)
7. [å¼‚å¸¸å¤„ç†æœºåˆ¶](#7-å¼‚å¸¸å¤„ç†æœºåˆ¶)
8. [å®Œæ•´å®ç°æ¡ˆä¾‹](#8-å®Œæ•´å®ç°æ¡ˆä¾‹)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” è®¤è¯è¿‡æ»¤å™¨æ ¸å¿ƒæ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯JWTè®¤è¯è¿‡æ»¤å™¨


> ğŸ’¡ **é€šä¿—ç†è§£**  
> JWTè®¤è¯è¿‡æ»¤å™¨å°±åƒå…¬å¸é—¨å£çš„ä¿å®‰ï¼Œæ¯æ¬¡æœ‰äººï¼ˆè¯·æ±‚ï¼‰è¿›æ¥æ—¶ï¼Œä¿å®‰éƒ½ä¼šæ£€æŸ¥ä»–çš„é—¨ç¦å¡ï¼ˆJWTä»¤ç‰Œï¼‰æ˜¯å¦æœ‰æ•ˆï¼ŒéªŒè¯é€šè¿‡æ‰èƒ½æ”¾è¡Œã€‚

**ğŸ”¸ æ ¸å¿ƒä½œç”¨**
```
ä¼ ç»Ÿç™»å½•è¿‡ç¨‹ï¼š
1. ç”¨æˆ·è¾“å…¥è´¦å·å¯†ç 
2. åç«¯éªŒè¯æˆåŠŸåç”ŸæˆJWTä»¤ç‰Œ
3. å‰ç«¯ä¿å­˜ä»¤ç‰Œ
4. ä»¥åæ¯æ¬¡è¯·æ±‚éƒ½å¸¦ä¸Šè¿™ä¸ªä»¤ç‰Œ

JWTè¿‡æ»¤å™¨çš„å·¥ä½œï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®¢æˆ·ç«¯è¯·æ±‚   â”‚
â”‚ (æºå¸¦JWT)   â”‚ 
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  JWTè®¤è¯è¿‡æ»¤å™¨        â”‚
â”‚  1. æå–ä»¤ç‰Œ         â”‚
â”‚  2. éªŒè¯ä»¤ç‰Œ         â”‚
â”‚  3. è§£æç”¨æˆ·ä¿¡æ¯      â”‚
â”‚  4. è®¾ç½®è®¤è¯çŠ¶æ€      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸šåŠ¡å¤„ç†     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 è¿‡æ»¤å™¨åœ¨Spring Securityä¸­çš„ä½ç½®


**ğŸ”¸ è¿‡æ»¤å™¨é“¾æ‰§è¡Œæµç¨‹**
```
HTTPè¯·æ±‚è¿›å…¥
    â†“
[å…¶ä»–å®‰å…¨è¿‡æ»¤å™¨...]
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ JWTè®¤è¯è¿‡æ»¤å™¨           â”‚ â† æˆ‘ä»¬è¦å®ç°çš„
â”‚ (JwtAuthenticationFilter)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
[æˆæƒè¿‡æ»¤å™¨...]
    â†“
åˆ°è¾¾Controller
```

> ğŸ“– **æœ¯è¯­è§£é‡Š**  
> **è¿‡æ»¤å™¨ï¼ˆFilterï¼‰**ï¼šåœ¨è¯·æ±‚åˆ°è¾¾Controllerä¹‹å‰ï¼Œå…ˆæ‰§è¡Œçš„æ‹¦æˆªå™¨  
> **è¿‡æ»¤å™¨é“¾ï¼ˆFilter Chainï¼‰**ï¼šå¤šä¸ªè¿‡æ»¤å™¨æŒ‰é¡ºåºæ‰§è¡Œï¼Œå½¢æˆä¸€æ¡é“¾

---

## 2. ğŸ”„ OncePerRequestFilterå•æ¬¡è¿‡æ»¤å™¨


### 2.1 ä¸ºä»€ä¹ˆè¦ç”¨OncePerRequestFilter


**é—®é¢˜åœºæ™¯ï¼šæ™®é€šFilterçš„é‡å¤æ‰§è¡Œé—®é¢˜**
```
æ™®é€šFilterå¯èƒ½çš„é—®é¢˜ï¼š
è¯·æ±‚ /api/user
    â†“
è¿‡æ»¤å™¨æ‰§è¡Œ1æ¬¡
    â†“
å†…éƒ¨è½¬å‘åˆ° /login
    â†“  
è¿‡æ»¤å™¨åˆæ‰§è¡Œ1æ¬¡ï¼â† é‡å¤äº†

OncePerRequestFilterçš„ä¿è¯ï¼š
æ— è®ºè¯·æ±‚å¦‚ä½•è½¬å‘ï¼Œæ¯ä¸ªè¯·æ±‚åªæ‰§è¡Œ1æ¬¡è¿‡æ»¤é€»è¾‘
```

### 2.2 OncePerRequestFilteræ ¸å¿ƒç‰¹ç‚¹


| ç‰¹æ€§ | **è¯´æ˜** | **å¥½å¤„** |
|------|---------|---------|
| ğŸ”¸ **å•æ¬¡æ‰§è¡Œ** | `æ¯ä¸ªè¯·æ±‚åªæ‰§è¡Œä¸€æ¬¡` | `é¿å…é‡å¤éªŒè¯ï¼Œæé«˜æ€§èƒ½` |
| ğŸ”¸ **è‡ªåŠ¨åˆ¤æ–­** | `æ¡†æ¶è‡ªåŠ¨åˆ¤æ–­æ˜¯å¦å·²æ‰§è¡Œ` | `å¼€å‘è€…æ— éœ€å…³å¿ƒå†…éƒ¨è½¬å‘` |
| ğŸ”¸ **å¼‚æ­¥æ”¯æŒ** | `æ”¯æŒå¼‚æ­¥è¯·æ±‚åœºæ™¯` | `é€‚é…ç°ä»£Webåº”ç”¨` |

### 2.3 åŸºç¡€ä½¿ç”¨æ–¹å¼


```java
// ç»§æ‰¿OncePerRequestFilterï¼Œåªéœ€å®ç°ä¸€ä¸ªæ–¹æ³•
public class JwtAuthenticationFilter extends OncePerRequestFilter {
    
    @Override
    protected void doFilterInternal(
            HttpServletRequest request,
            HttpServletResponse response,
            FilterChain filterChain) throws ServletException, IOException {
        
        // è¿™é‡Œå†™è®¤è¯é€»è¾‘
        // æ¯ä¸ªè¯·æ±‚åªä¼šæ‰§è¡Œä¸€æ¬¡
        
        filterChain.doFilter(request, response); // æ”¾è¡Œåˆ°ä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨
    }
}
```

> âš ï¸ **é‡è¦æé†’**  
> `doFilterInternal()`æ–¹æ³•åå¾ˆé‡è¦ï¼Œä¸è¦å†™é”™ï¼è¿™æ˜¯æ¡†æ¶è§„å®šçš„æ–¹æ³•åã€‚

---

## 3. ğŸ“‹ Authorization Headerè§£æ


### 3.1 ä»€ä¹ˆæ˜¯Authorization Header


**ğŸ”¸ HTTPè¯·æ±‚å¤´ç¤ºä¾‹**
```
å®¢æˆ·ç«¯å‘é€çš„HTTPè¯·æ±‚ï¼š
GET /api/user/profile HTTP/1.1
Host: api.example.com
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json
```

> ğŸ’¡ **é€šä¿—è§£é‡Š**  
> `Authorization`å°±æ˜¯HTTPè¯·æ±‚å¤´ä¸­çš„ä¸€ä¸ªå­—æ®µï¼Œä¸“é—¨ç”¨æ¥ä¼ é€’è®¤è¯ä¿¡æ¯ã€‚  
> å°±åƒä½ å»é“¶è¡ŒåŠä¸šåŠ¡ï¼Œè¦å‡ºç¤ºèº«ä»½è¯ï¼Œ`Authorization`å°±æ˜¯ä½ çš„"èº«ä»½è¯"ã€‚

### 3.2 Authorization Headerçš„æ ‡å‡†æ ¼å¼


**æ ¼å¼è§„èŒƒ**
```
Authorization: <è®¤è¯ç±»å‹> <å‡­è¯å†…å®¹>

å¸¸è§ç±»å‹ï¼š
1. Basic  username:passwordçš„Base64ç¼–ç 
2. Bearer ä»¤ç‰Œï¼ˆJWTæœ€å¸¸ç”¨è¿™ç§ï¼‰
3. Digest æ‘˜è¦è®¤è¯

JWTä½¿ç”¨çš„æ ¼å¼ï¼š
Authorization: Bearer <JWTä»¤ç‰Œå­—ç¬¦ä¸²>
                â†‘      â†‘
              ç±»å‹    å®é™…ä»¤ç‰Œ
```

### 3.3 ä»è¯·æ±‚ä¸­æå–Header


```java
public class JwtAuthenticationFilter extends OncePerRequestFilter {
    
    @Override
    protected void doFilterInternal(HttpServletRequest request, 
                                   HttpServletResponse response,
                                   FilterChain filterChain) {
        // ç¬¬1æ­¥ï¼šè·å–Authorizationè¯·æ±‚å¤´
        String authHeader = request.getHeader("Authorization");
        
        // ç¬¬2æ­¥ï¼šåˆ¤æ–­è¯·æ±‚å¤´æ˜¯å¦å­˜åœ¨
        if (authHeader == null || authHeader.isEmpty()) {
            // æ²¡æœ‰æºå¸¦ä»¤ç‰Œï¼Œç›´æ¥æ”¾è¡Œï¼ˆåç»­ä¼šè¢«å…¶ä»–è¿‡æ»¤å™¨æ‹¦æˆªï¼‰
            filterChain.doFilter(request, response);
            return;
        }
        
        // ç»§ç»­å¤„ç†...
    }
}
```

**ğŸ”¸ å¤„ç†æµç¨‹å›¾**
```
è¯·æ±‚è¿›æ¥
    â†“
è·å–Authorization Header
    â†“
    åˆ¤æ–­ï¼šHeaderå­˜åœ¨å—ï¼Ÿ
    â”œâ”€ å¦ â†’ ç›´æ¥æ”¾è¡Œ
    â””â”€ æ˜¯ â†’ ç»§ç»­è§£æBearer Token
```

---

## 4. ğŸ« Bearer Tokenæå–ä¸éªŒè¯


### 4.1 ä»€ä¹ˆæ˜¯Bearer Token


> ğŸ“– **æœ¯è¯­è§£é‡Š**  
> **Bearer**ï¼ˆæŒç¥¨äººï¼‰ï¼šæ„æ€æ˜¯"è°æ‹¿ç€è¿™ä¸ªä»¤ç‰Œï¼Œè°å°±æœ‰æƒé™"  
> å°±åƒç”µå½±ç¥¨ï¼Œä¸ç®¡è°æ‹¿ç€ï¼Œéƒ½èƒ½å‡­ç¥¨å…¥åœº

**Bearer Tokenç‰¹ç‚¹**
```
ç‰¹ç‚¹ï¼š
âœ… æ— çŠ¶æ€ï¼šæœåŠ¡å™¨ä¸ä¿å­˜ä¼šè¯
âœ… ä¾¿æºï¼šå¯åœ¨HTTP Headerä¸­ä¼ è¾“
âœ… è‡ªåŒ…å«ï¼šä»¤ç‰Œå†…åŒ…å«ç”¨æˆ·ä¿¡æ¯

é£é™©ï¼š
âš ï¸ è¢«ç›—ç”¨ï¼šä»¤ç‰Œæ³„éœ²å³å¯ä¼ªè£…èº«ä»½
âš ï¸ æ— æ³•ä¸»åŠ¨ä½œåºŸï¼šé™¤éè¿‡æœŸ
```

### 4.2 Bearer Tokenæå–é€»è¾‘


```java
// å®Œæ•´çš„Tokenæå–æ–¹æ³•
private String extractBearerToken(String authHeader) {
    // Authorizationæ ¼å¼ï¼šBearer eyJhbGciOiJIUzI1NiIsInR5...
    
    // ç¬¬1æ­¥ï¼šæ£€æŸ¥æ˜¯å¦ä»¥"Bearer "å¼€å¤´ï¼ˆæ³¨æ„æœ‰ç©ºæ ¼ï¼‰
    if (authHeader.startsWith("Bearer ")) {
        // ç¬¬2æ­¥ï¼šæˆªå–"Bearer "åé¢çš„éƒ¨åˆ†
        return authHeader.substring(7); // "Bearer "é•¿åº¦ä¸º7
    }
    
    return null; // æ ¼å¼ä¸å¯¹ï¼Œè¿”å›null
}
```

**ğŸ”¸ æå–è¿‡ç¨‹ç¤ºä¾‹**
```
åŸå§‹Headerï¼š
"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
       â†‘
    ä½ç½®7å¼€å§‹

substring(7)åå¾—åˆ°ï¼š
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." â† è¿™å°±æ˜¯JWTä»¤ç‰Œ
```

### 4.3 ä»¤ç‰ŒéªŒè¯æ ¸å¿ƒé€»è¾‘


**éªŒè¯æ­¥éª¤**
```
1. æ ¼å¼éªŒè¯
   â”œâ”€ æ˜¯å¦ä¸ºJWTæ ¼å¼ï¼ˆ3æ®µç”¨.åˆ†éš”ï¼‰
   â””â”€ æ¯æ®µæ˜¯å¦ä¸ºåˆæ³•Base64

2. ç­¾åéªŒè¯
   â”œâ”€ ä½¿ç”¨å¯†é’¥éªŒè¯ç­¾å
   â””â”€ ç¡®ä¿ä»¤ç‰Œæœªè¢«ç¯¡æ”¹

3. æœ‰æ•ˆæœŸéªŒè¯
   â”œâ”€ æ£€æŸ¥expè¿‡æœŸæ—¶é—´
   â””â”€ ç¡®ä¿ä»¤ç‰Œæœªè¿‡æœŸ

4. ä¸šåŠ¡éªŒè¯
   â”œâ”€ ç”¨æˆ·æ˜¯å¦å­˜åœ¨
   â””â”€ ç”¨æˆ·çŠ¶æ€æ˜¯å¦æ­£å¸¸
```

```java
// JWTéªŒè¯ç¤ºä¾‹
private boolean validateToken(String token) {
    try {
        // ä½¿ç”¨JWTå·¥å…·ç±»è§£æå¹¶éªŒè¯
        Claims claims = Jwts.parserBuilder()
            .setSigningKey(secretKey) // è®¾ç½®å¯†é’¥
            .build()
            .parseClaimsJws(token)    // è§£æå¹¶éªŒè¯
            .getBody();
        
        // éªŒè¯æˆåŠŸ
        return true;
        
    } catch (ExpiredJwtException e) {
        // ä»¤ç‰Œè¿‡æœŸ
        return false;
    } catch (JwtException e) {
        // å…¶ä»–JWTå¼‚å¸¸ï¼ˆç­¾åé”™è¯¯ç­‰ï¼‰
        return false;
    }
}
```

> âš ï¸ **å¸¸è§é”™è¯¯**  
> å¾ˆå¤šæ–°æ‰‹å¿˜è®°éªŒè¯ä»¤ç‰Œç­¾åï¼Œåªæ£€æŸ¥æ ¼å¼ï¼Œè¿™æ ·ä¸å®‰å…¨ï¼  
> å¿…é¡»ä½¿ç”¨å¯†é’¥éªŒè¯ç­¾åï¼Œç¡®ä¿ä»¤ç‰Œæœªè¢«ç¯¡æ”¹ã€‚

---

## 5. ğŸ”‘ JwtAuthenticationTokenä»¤ç‰Œå¯¹è±¡


### 5.1 ä»€ä¹ˆæ˜¯JwtAuthenticationToken


> ğŸ’¡ **é€šä¿—ç†è§£**  
> `JwtAuthenticationToken`æ˜¯Spring Securityä¸­çš„"èº«ä»½è¯å¯¹è±¡"  
> å®ƒåŒ…å«äº†ç”¨æˆ·çš„èº«ä»½ä¿¡æ¯ï¼Œç”¨äºåç»­çš„æƒé™åˆ¤æ–­

**å¯¹æ¯”ç†è§£**
```
ç”Ÿæ´»ä¸­çš„èº«ä»½è¯ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å§“åï¼šå¼ ä¸‰        â”‚ â† principalï¼ˆä¸»ä½“ï¼‰
â”‚ èº«ä»½è¯å·ï¼š123456  â”‚
â”‚ æƒé™ï¼šå…¬æ°‘        â”‚ â† authoritiesï¼ˆæƒé™ï¼‰
â”‚ æ˜¯å¦è®¤è¯ï¼šå·²è®¤è¯  â”‚ â† authenticatedï¼ˆè®¤è¯çŠ¶æ€ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

JwtAuthenticationTokenï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ principal: "å¼ ä¸‰" â”‚
â”‚ credentials: null â”‚
â”‚ authorities: [ROLE_USER]â”‚
â”‚ authenticated: trueâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 JwtAuthenticationTokenæ ¸å¿ƒå±æ€§


| å±æ€§ | **ç±»å‹** | **å«ä¹‰** | **ç¤ºä¾‹** |
|------|---------|---------|---------|
| **principal** | `Object` | `ç”¨æˆ·ä¸»ä½“ä¿¡æ¯` | `ç”¨æˆ·å/ç”¨æˆ·å¯¹è±¡` |
| **credentials** | `Object` | `å‡­è¯ä¿¡æ¯(å¯†ç )` | `é€šå¸¸ä¸ºnull` |
| **authorities** | `Collection` | `ç”¨æˆ·æƒé™åˆ—è¡¨` | `[ROLE_USER, ROLE_ADMIN]` |
| **authenticated** | `boolean` | `æ˜¯å¦å·²è®¤è¯` | `true/false` |

### 5.3 åˆ›å»ºJwtAuthenticationToken


```java
// ä»JWTä¸­æå–ä¿¡æ¯å¹¶åˆ›å»ºTokenå¯¹è±¡
private Authentication createAuthentication(String jwt) {
    // ç¬¬1æ­¥ï¼šè§£æJWTè·å–ç”¨æˆ·ä¿¡æ¯
    Claims claims = Jwts.parserBuilder()
        .setSigningKey(secretKey)
        .build()
        .parseClaimsJws(jwt)
        .getBody();
    
    // ç¬¬2æ­¥ï¼šæå–ç”¨æˆ·å
    String username = claims.getSubject();
    
    // ç¬¬3æ­¥ï¼šæå–æƒé™ï¼ˆä»JWTçš„claimsä¸­ï¼‰
    List<String> roles = claims.get("roles", List.class);
    List<GrantedAuthority> authorities = roles.stream()
        .map(SimpleGrantedAuthority::new)
        .collect(Collectors.toList());
    
    // ç¬¬4æ­¥ï¼šåˆ›å»ºè®¤è¯å¯¹è±¡
    return new UsernamePasswordAuthenticationToken(
        username,      // principalï¼šç”¨æˆ·å
        null,          // credentialsï¼šå¯†ç ï¼ˆJWTä¸éœ€è¦ï¼‰
        authorities    // authoritiesï¼šæƒé™åˆ—è¡¨
    );
}
```

> ğŸ“– **ä¸ºä»€ä¹ˆcredentialsæ˜¯nullï¼Ÿ**  
> JWTè®¤è¯ä¸éœ€è¦å¯†ç ï¼Œå› ä¸ºä»¤ç‰Œæœ¬èº«å°±è¯æ˜äº†èº«ä»½ã€‚  
> å°±åƒä½ æ‹¿ç€é—¨ç¦å¡è¿›å…¬å¸ï¼Œä¸éœ€è¦å†è¾“å…¥å¯†ç ã€‚

---

## 6. ğŸ”’ SecurityContextå®‰å…¨ä¸Šä¸‹æ–‡è®¾ç½®


### 6.1 ä»€ä¹ˆæ˜¯SecurityContext


> ğŸ’¡ **å½¢è±¡æ¯”å–»**  
> `SecurityContext`å°±åƒæ˜¯ä¸€ä¸ª"ä¸´æ—¶å·¥ä½œè¯"  
> åœ¨æ•´ä¸ªè¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸­ï¼Œéšæ—¶å¯ä»¥æŸ¥çœ‹"å½“å‰æ˜¯è°åœ¨æ“ä½œ"

**SecurityContextçš„ä½œç”¨åŸŸ**
```
ä¸€æ¬¡HTTPè¯·æ±‚çš„ç”Ÿå‘½å‘¨æœŸï¼š

è¯·æ±‚åˆ°è¾¾
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åˆ›å»ºSecurityContext     â”‚ â† åœ¨è¿‡æ»¤å™¨ä¸­è®¾ç½®
â”‚  å­˜å…¥è®¤è¯ä¿¡æ¯            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Controllerå¤„ç†          â”‚
â”‚  å¯é€šè¿‡SecurityContext   â”‚ â† éšæ—¶å¯è·å–å½“å‰ç”¨æˆ·
â”‚  è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Serviceå¤„ç†             â”‚
â”‚  å¯è¿›è¡Œæƒé™åˆ¤æ–­          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
è¯·æ±‚ç»“æŸï¼Œæ¸…ç©ºSecurityContext
```

### 6.2 SecurityContextçš„æ ¸å¿ƒæ¦‚å¿µ


**ä¸‰ä¸ªæ ¸å¿ƒç±»çš„å…³ç³»**
```
SecurityContextHolder (æŒæœ‰è€…)
        â†“ æŒæœ‰
SecurityContext (ä¸Šä¸‹æ–‡)
        â†“ åŒ…å«
Authentication (è®¤è¯ä¿¡æ¯)
```

| ç±»å | **èŒè´£** | **æ¯”å–»** |
|------|---------|---------|
| **SecurityContextHolder** | `ç®¡ç†SecurityContext` | `æ¡£æ¡ˆæŸœï¼ˆå­˜æ”¾å·¥ä½œè¯ï¼‰` |
| **SecurityContext** | `å­˜å‚¨è®¤è¯ä¿¡æ¯` | `å·¥ä½œè¯æœ¬èº«` |
| **Authentication** | `ç”¨æˆ·èº«ä»½ä¿¡æ¯` | `å·¥ä½œè¯ä¸Šçš„ä¸ªäººä¿¡æ¯` |

### 6.3 è®¾ç½®SecurityContextçš„æ ‡å‡†æ–¹å¼


```java
// JWTè¿‡æ»¤å™¨ä¸­è®¾ç½®è®¤è¯ä¿¡æ¯
public class JwtAuthenticationFilter extends OncePerRequestFilter {
    
    @Override
    protected void doFilterInternal(HttpServletRequest request,
                                   HttpServletResponse response,
                                   FilterChain filterChain) {
        
        // å‰é¢çš„æå–å’ŒéªŒè¯...
        String jwt = extractBearerToken(authHeader);
        
        if (jwt != null && validateToken(jwt)) {
            // ç¬¬1æ­¥ï¼šåˆ›å»ºè®¤è¯å¯¹è±¡
            Authentication authentication = createAuthentication(jwt);
            
            // ç¬¬2æ­¥ï¼šåˆ›å»ºå®‰å…¨ä¸Šä¸‹æ–‡
            SecurityContext context = SecurityContextHolder.createEmptyContext();
            
            // ç¬¬3æ­¥ï¼šå°†è®¤è¯ä¿¡æ¯æ”¾å…¥ä¸Šä¸‹æ–‡
            context.setAuthentication(authentication);
            
            // ç¬¬4æ­¥ï¼šå°†ä¸Šä¸‹æ–‡è®¾ç½®åˆ°Holderä¸­
            SecurityContextHolder.setContext(context);
        }
        
        // æ”¾è¡Œåˆ°ä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨
        filterChain.doFilter(request, response);
    }
}
```

**ğŸ”¸ æ‰§è¡Œæµç¨‹è¯¦è§£**
```
æ­¥éª¤1ï¼šåˆ›å»ºAuthenticationå¯¹è±¡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ UsernamePasswordAuth   â”‚
â”‚ principal: "å¼ ä¸‰"      â”‚
â”‚ authorities: [USER]    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ­¥éª¤2-4ï¼šè®¾ç½®åˆ°SecurityContext
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SecurityContextHolder  â”‚
â”‚   â”œâ”€ SecurityContext   â”‚
â”‚   â”‚   â””â”€ Authenticationâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åç»­åœ¨Controllerä¸­è·å–ï¼š
String username = SecurityContextHolder
    .getContext()
    .getAuthentication()
    .getName(); // å¾—åˆ°"å¼ ä¸‰"
```

### 6.4 åœ¨ä¸šåŠ¡ä»£ç ä¸­è·å–å½“å‰ç”¨æˆ·


```java
// Controllerä¸­è·å–å½“å‰ç”¨æˆ·
@RestController
public class UserController {
    
    @GetMapping("/profile")
    public UserInfo getProfile() {
        // æ–¹å¼1ï¼šä»SecurityContextHolderè·å–
        Authentication auth = SecurityContextHolder
            .getContext()
            .getAuthentication();
        
        String username = auth.getName();
        
        // æ–¹å¼2ï¼šä½¿ç”¨@AuthenticationPrincipalæ³¨è§£ï¼ˆæ›´ç®€æ´ï¼‰
        // public UserInfo getProfile(@AuthenticationPrincipal String username)
        
        // æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
        return userService.getUserByUsername(username);
    }
}
```

> ğŸ’¡ **æœ€ä½³å®è·µ**  
> æ¨èä½¿ç”¨`@AuthenticationPrincipal`æ³¨è§£ï¼Œä»£ç æ›´ç®€æ´  
> Springä¼šè‡ªåŠ¨ä»SecurityContextä¸­æå–è®¤è¯ä¿¡æ¯æ³¨å…¥

---

## 7. âš ï¸ å¼‚å¸¸å¤„ç†æœºåˆ¶


### 7.1 JWTè®¤è¯ä¸­çš„å¸¸è§å¼‚å¸¸


**å¼‚å¸¸ç±»å‹æ€»è§ˆ**
```
JWTè®¤è¯å¼‚å¸¸åˆ†ç±»ï¼š

1. ä»¤ç‰Œæ ¼å¼å¼‚å¸¸
   â”œâ”€ ç¼ºå°‘Authorization Header
   â”œâ”€ ä¸æ˜¯Bearerç±»å‹
   â””â”€ JWTæ ¼å¼é”™è¯¯

2. ä»¤ç‰ŒéªŒè¯å¼‚å¸¸
   â”œâ”€ ç­¾åéªŒè¯å¤±è´¥
   â”œâ”€ ä»¤ç‰Œå·²è¿‡æœŸ
   â””â”€ ä»¤ç‰Œè¢«ç¯¡æ”¹

3. ç”¨æˆ·ä¿¡æ¯å¼‚å¸¸
   â”œâ”€ ç”¨æˆ·ä¸å­˜åœ¨
   â”œâ”€ ç”¨æˆ·è¢«ç¦ç”¨
   â””â”€ æƒé™ä¸è¶³
```

### 7.2 å¼‚å¸¸å¤„ç†ç­–ç•¥


| å¼‚å¸¸ç±»å‹ | **å¤„ç†æ–¹å¼** | **HTTPçŠ¶æ€ç ** | **è¿”å›ä¿¡æ¯** |
|---------|-------------|---------------|-------------|
| ğŸ”¸ **ä»¤ç‰Œç¼ºå¤±** | `æ”¾è¡Œåˆ°ä¸‹ä¸ªè¿‡æ»¤å™¨` | `401` | `æœªæä¾›è®¤è¯ä¿¡æ¯` |
| ğŸ”¸ **ä»¤ç‰Œæ ¼å¼é”™è¯¯** | `è¿”å›é”™è¯¯å“åº”` | `400` | `ä»¤ç‰Œæ ¼å¼ä¸æ­£ç¡®` |
| ğŸ”¸ **ä»¤ç‰Œè¿‡æœŸ** | `è¿”å›é”™è¯¯å“åº”` | `401` | `ä»¤ç‰Œå·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•` |
| ğŸ”¸ **ç­¾åéªŒè¯å¤±è´¥** | `è¿”å›é”™è¯¯å“åº”` | `401` | `ä»¤ç‰Œæ— æ•ˆ` |
| ğŸ”¸ **ç”¨æˆ·ä¸å­˜åœ¨** | `è¿”å›é”™è¯¯å“åº”` | `401` | `ç”¨æˆ·ä¸å­˜åœ¨` |

### 7.3 å¼‚å¸¸å¤„ç†å®Œæ•´å®ç°


```java
@Override
protected void doFilterInternal(HttpServletRequest request,
                               HttpServletResponse response,
                               FilterChain filterChain) {
    try {
        // ç¬¬1æ­¥ï¼šæå–ä»¤ç‰Œ
        String authHeader = request.getHeader("Authorization");
        
        if (authHeader == null || !authHeader.startsWith("Bearer ")) {
            // æ²¡æœ‰ä»¤ç‰Œï¼Œæ”¾è¡Œï¼ˆåç»­ä¼šè¢«å…¶ä»–è¿‡æ»¤å™¨å¤„ç†ï¼‰
            filterChain.doFilter(request, response);
            return;
        }
        
        String jwt = authHeader.substring(7);
        
        // ç¬¬2æ­¥ï¼šéªŒè¯ä»¤ç‰Œ
        Claims claims = Jwts.parserBuilder()
            .setSigningKey(secretKey)
            .build()
            .parseClaimsJws(jwt)
            .getBody();
        
        // ç¬¬3æ­¥ï¼šåˆ›å»ºè®¤è¯å¯¹è±¡
        Authentication auth = createAuthentication(claims);
        SecurityContextHolder.getContext().setAuthentication(auth);
        
        // æ”¾è¡Œ
        filterChain.doFilter(request, response);
        
    } catch (ExpiredJwtException e) {
        // ä»¤ç‰Œè¿‡æœŸ
        handleException(response, 401, "ä»¤ç‰Œå·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•");
        
    } catch (SignatureException e) {
        // ç­¾åéªŒè¯å¤±è´¥
        handleException(response, 401, "ä»¤ç‰Œç­¾åæ— æ•ˆ");
        
    } catch (MalformedJwtException e) {
        // JWTæ ¼å¼é”™è¯¯
        handleException(response, 400, "ä»¤ç‰Œæ ¼å¼ä¸æ­£ç¡®");
        
    } catch (Exception e) {
        // å…¶ä»–å¼‚å¸¸
        handleException(response, 500, "è®¤è¯å¤„ç†å¤±è´¥");
    }
}

// ç»Ÿä¸€å¼‚å¸¸å“åº”å¤„ç†
private void handleException(HttpServletResponse response, 
                             int status, 
                             String message) throws IOException {
    response.setStatus(status);
    response.setContentType("application/json;charset=UTF-8");
    
    String json = String.format(
        "{\"code\":%d,\"message\":\"%s\"}", 
        status, message
    );
    
    response.getWriter().write(json);
}
```

**ğŸ”¸ å¼‚å¸¸å¤„ç†æµç¨‹å›¾**
```
è¯·æ±‚è¿›å…¥è¿‡æ»¤å™¨
    â†“
    æå–ä»¤ç‰Œ
    â†“
    éªŒè¯ä»¤ç‰Œ
    â†“
    åˆ¤æ–­ï¼šéªŒè¯æˆåŠŸï¼Ÿ
    â”œâ”€ æ˜¯ â†’ è®¾ç½®SecurityContext â†’ æ”¾è¡Œ
    â””â”€ å¦ â†’ æ•è·å¼‚å¸¸
              â†“
        åˆ¤æ–­å¼‚å¸¸ç±»å‹
        â”œâ”€ ExpiredJwtException â†’ è¿”å›401"ä»¤ç‰Œè¿‡æœŸ"
        â”œâ”€ SignatureException â†’ è¿”å›401"ç­¾åæ— æ•ˆ"  
        â”œâ”€ MalformedJwtException â†’ è¿”å›400"æ ¼å¼é”™è¯¯"
        â””â”€ å…¶ä»– â†’ è¿”å›500"è®¤è¯å¤±è´¥"
```

> âš ï¸ **é‡è¦æé†’**  
> å¼‚å¸¸å¤„ç†åä¸è¦è°ƒç”¨`filterChain.doFilter()`  
> å¦åˆ™ä¼šç»§ç»­æ‰§è¡Œåç»­è¿‡æ»¤å™¨ï¼Œå¯¼è‡´é‡å¤å¤„ç†

---

## 8. ğŸ¯ å®Œæ•´å®ç°æ¡ˆä¾‹


### 8.1 å®Œæ•´çš„JWTè®¤è¯è¿‡æ»¤å™¨


```java
@Component
public class JwtAuthenticationFilter extends OncePerRequestFilter {
    
    @Value("${jwt.secret}")
    private String secretKey;
    
    @Autowired
    private UserDetailsService userDetailsService;
    
    @Override
    protected void doFilterInternal(
            HttpServletRequest request,
            HttpServletResponse response,
            FilterChain filterChain) throws ServletException, IOException {
        
        try {
            // 1. æå–JWTä»¤ç‰Œ
            String jwt = extractJwtFromRequest(request);
            
            // 2. éªŒè¯å¹¶è§£æJWT
            if (jwt != null && validateToken(jwt)) {
                // 3. ä»JWTä¸­æå–ç”¨æˆ·ä¿¡æ¯
                String username = getUsernameFromToken(jwt);
                
                // 4. åŠ è½½ç”¨æˆ·è¯¦æƒ…
                UserDetails userDetails = userDetailsService
                    .loadUserByUsername(username);
                
                // 5. åˆ›å»ºè®¤è¯å¯¹è±¡
                UsernamePasswordAuthenticationToken authentication =
                    new UsernamePasswordAuthenticationToken(
                        userDetails,
                        null,
                        userDetails.getAuthorities()
                    );
                
                // 6. è®¾ç½®åˆ°SecurityContext
                SecurityContextHolder.getContext()
                    .setAuthentication(authentication);
            }
            
            // 7. ç»§ç»­è¿‡æ»¤å™¨é“¾
            filterChain.doFilter(request, response);
            
        } catch (ExpiredJwtException e) {
            handleAuthenticationException(response, "ä»¤ç‰Œå·²è¿‡æœŸ");
        } catch (Exception e) {
            handleAuthenticationException(response, "è®¤è¯å¤±è´¥");
        }
    }
    
    // ä»è¯·æ±‚ä¸­æå–JWT
    private String extractJwtFromRequest(HttpServletRequest request) {
        String bearerToken = request.getHeader("Authorization");
        if (bearerToken != null && bearerToken.startsWith("Bearer ")) {
            return bearerToken.substring(7);
        }
        return null;
    }
    
    // éªŒè¯ä»¤ç‰Œ
    private boolean validateToken(String token) {
        try {
            Jwts.parserBuilder()
                .setSigningKey(secretKey)
                .build()
                .parseClaimsJws(token);
            return true;
        } catch (JwtException e) {
            return false;
        }
    }
    
    // ä»ä»¤ç‰Œè·å–ç”¨æˆ·å
    private String getUsernameFromToken(String token) {
        Claims claims = Jwts.parserBuilder()
            .setSigningKey(secretKey)
            .build()
            .parseClaimsJws(token)
            .getBody();
        return claims.getSubject();
    }
    
    // å¤„ç†è®¤è¯å¼‚å¸¸
    private void handleAuthenticationException(
            HttpServletResponse response, 
            String message) throws IOException {
        response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
        response.setContentType("application/json;charset=UTF-8");
        response.getWriter().write(
            "{\"code\":401,\"message\":\"" + message + "\"}"
        );
    }
}
```

### 8.2 é…ç½®è¿‡æ»¤å™¨åˆ°Spring Security


```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Autowired
    private JwtAuthenticationFilter jwtAuthFilter;
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            // ç¦ç”¨CSRFï¼ˆJWTä¸éœ€è¦ï¼‰
            .csrf(csrf -> csrf.disable())
            
            // é…ç½®è¯·æ±‚æˆæƒ
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/api/auth/**").permitAll() // ç™»å½•æ¥å£æ”¾è¡Œ
                .anyRequest().authenticated()                // å…¶ä»–éœ€è¦è®¤è¯
            )
            
            // æ·»åŠ JWTè¿‡æ»¤å™¨ï¼ˆåœ¨UsernamePasswordAuthenticationFilterä¹‹å‰ï¼‰
            .addFilterBefore(
                jwtAuthFilter, 
                UsernamePasswordAuthenticationFilter.class
            );
        
        return http.build();
    }
}
```

**ğŸ”¸ è¿‡æ»¤å™¨ä½ç½®ç¤ºæ„**
```
Spring Securityè¿‡æ»¤å™¨é“¾ï¼š

[SecurityContextPersistenceFilter]
          â†“
[å…¶ä»–å®‰å…¨è¿‡æ»¤å™¨...]
          â†“
[JwtAuthenticationFilter]          â† æˆ‘ä»¬çš„JWTè¿‡æ»¤å™¨
          â†“
[UsernamePasswordAuthenticationFilter]
          â†“
[å…¶ä»–è¿‡æ»¤å™¨...]
          â†“
åˆ°è¾¾Controller
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


> ğŸ¯ **æ ¸å¿ƒçŸ¥è¯†æ¸…å•**
> 
> âœ… **OncePerRequestFilter**ï¼šç¡®ä¿æ¯ä¸ªè¯·æ±‚åªæ‰§è¡Œä¸€æ¬¡è¿‡æ»¤é€»è¾‘  
> âœ… **Authorization Header**ï¼šHTTPè¯·æ±‚å¤´ä¸­ä¼ é€’è®¤è¯ä¿¡æ¯çš„æ ‡å‡†æ–¹å¼  
> âœ… **Bearer Token**ï¼šJWTçš„ä¼ è¾“æ ¼å¼ï¼Œæ ¼å¼ä¸º`Bearer <ä»¤ç‰Œ>`  
> âœ… **JwtAuthenticationToken**ï¼šSpring Securityä¸­è¡¨ç¤ºJWTè®¤è¯çš„å¯¹è±¡  
> âœ… **SecurityContext**ï¼šå­˜å‚¨å½“å‰è¯·æ±‚è®¤è¯ä¿¡æ¯çš„ä¸Šä¸‹æ–‡  
> âœ… **å¼‚å¸¸å¤„ç†**ï¼šåŒºåˆ†ä¸åŒå¼‚å¸¸ç±»å‹ï¼Œè¿”å›åˆé€‚çš„é”™è¯¯ä¿¡æ¯

### 9.2 JWTè®¤è¯è¿‡æ»¤å™¨æ‰§è¡Œæµç¨‹


```
å®Œæ•´è®¤è¯æµç¨‹æ€»ç»“ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. è¯·æ±‚è¿›å…¥OncePerRequestFilter         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ä»Authorization Headeræå–Bearer Tokenâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. éªŒè¯JWTç­¾åå’Œæœ‰æ•ˆæœŸ                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. è§£æJWTè·å–ç”¨æˆ·ä¿¡æ¯å’Œæƒé™             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. åˆ›å»ºJwtAuthenticationTokenå¯¹è±¡       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. è®¾ç½®åˆ°SecurityContext                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. æ”¾è¡Œåˆ°ä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨/Controller         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.3 å…³é”®ä»£ç æ¨¡æ¿


**ğŸ”¸ æ ¸å¿ƒæ–¹æ³•é€Ÿè®°**
```java
// æ¨¡æ¿1ï¼šæå–ä»¤ç‰Œ
String jwt = request.getHeader("Authorization")
    .substring(7); // å»æ‰"Bearer "

// æ¨¡æ¿2ï¼šéªŒè¯ä»¤ç‰Œ
Claims claims = Jwts.parserBuilder()
    .setSigningKey(secretKey)
    .build()
    .parseClaimsJws(jwt)
    .getBody();

// æ¨¡æ¿3ï¼šåˆ›å»ºè®¤è¯å¯¹è±¡
Authentication auth = new UsernamePasswordAuthenticationToken(
    username,
    null,
    authorities
);

// æ¨¡æ¿4ï¼šè®¾ç½®SecurityContext
SecurityContextHolder.getContext().setAuthentication(auth);
```

### 9.4 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ


| é—®é¢˜ | **åŸå› ** | **è§£å†³æ–¹æ¡ˆ** |
|------|---------|-------------|
| ğŸ”¸ **è¿‡æ»¤å™¨æ‰§è¡Œå¤šæ¬¡** | `ä½¿ç”¨æ™®é€šFilter` | `æ”¹ç”¨OncePerRequestFilter` |
| ğŸ”¸ **è·å–ä¸åˆ°ç”¨æˆ·ä¿¡æ¯** | `SecurityContextæœªè®¾ç½®` | `æ£€æŸ¥æ˜¯å¦æ­£ç¡®è®¾ç½®åˆ°Holder` |
| ğŸ”¸ **ä»¤ç‰ŒéªŒè¯å¤±è´¥** | `å¯†é’¥ä¸ä¸€è‡´` | `ç¡®ä¿ç”Ÿæˆå’ŒéªŒè¯ä½¿ç”¨åŒä¸€å¯†é’¥` |
| ğŸ”¸ **å¼‚å¸¸åä»ç»§ç»­æ‰§è¡Œ** | `å¼‚å¸¸å¤„ç†åè°ƒç”¨äº†doFilter` | `å¼‚å¸¸å¤„ç†åç›´æ¥return` |
| ğŸ”¸ **CORSè·¨åŸŸå¤±è´¥** | `è¿‡æ»¤å™¨é¡ºåºé—®é¢˜` | `å°†JWTè¿‡æ»¤å™¨æ”¾åœ¨CORSè¿‡æ»¤å™¨å` |

### 9.5 æœ€ä½³å®è·µå»ºè®®


> ğŸ’¡ **å®è·µè¦ç‚¹**
> 
> **1. ä»¤ç‰Œæå–**
> - ç»Ÿä¸€ä½¿ç”¨`Authorization: Bearer <token>`æ ¼å¼
> - åšå¥½ç©ºå€¼å’Œæ ¼å¼æ ¡éªŒ
> 
> **2. å¼‚å¸¸å¤„ç†**
> - åŒºåˆ†ä¸åŒå¼‚å¸¸ç±»å‹ï¼Œè¿”å›æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯
> - æ•æ„Ÿä¿¡æ¯ä¸è¦æš´éœ²åœ¨é”™è¯¯æ¶ˆæ¯ä¸­
> 
> **3. æ€§èƒ½ä¼˜åŒ–**
> - ç¼“å­˜ç”¨æˆ·ä¿¡æ¯ï¼Œé¿å…æ¯æ¬¡éƒ½æŸ¥æ•°æ®åº“
> - ä½¿ç”¨Rediså­˜å‚¨é»‘åå•ä»¤ç‰Œ
> 
> **4. å®‰å…¨åŠ å›º**
> - è®¾ç½®åˆç†çš„ä»¤ç‰Œè¿‡æœŸæ—¶é—´
> - ä½¿ç”¨HTTPSä¼ è¾“
> - å®ç°ä»¤ç‰Œåˆ·æ–°æœºåˆ¶

### 9.6 å­¦ä¹ æ£€æŸ¥æ¸…å•


**ğŸ“‹ è‡ªæˆ‘æ£€æµ‹**
- [ ] èƒ½è¯´å‡ºOncePerRequestFilterçš„ä½œç”¨å’Œä½¿ç”¨åœºæ™¯
- [ ] ç†è§£Authorization Headerçš„æ ‡å‡†æ ¼å¼
- [ ] ä¼šä»è¯·æ±‚ä¸­æå–å’ŒéªŒè¯Bearer Token
- [ ] èƒ½åˆ›å»ºJwtAuthenticationTokenå¯¹è±¡
- [ ] æŒæ¡SecurityContextçš„è®¾ç½®æ–¹æ³•
- [ ] äº†è§£å¸¸è§å¼‚å¸¸ç±»å‹åŠå¤„ç†æ–¹å¼
- [ ] èƒ½ç‹¬ç«‹å®ç°å®Œæ•´çš„JWTè®¤è¯è¿‡æ»¤å™¨

---

**ğŸ’¡ æ ¸å¿ƒè®°å¿†å£è¯€**
```
OncePerRequestFilterä¿è¯æ‰§è¡Œä¸€æ¬¡
Authorization Headerä¼ é€’èº«ä»½å‡­è¯
Bearer Tokenæå–éœ€éªŒè¯ç­¾å
JwtAuthenticationTokenå°è£…ç”¨æˆ·ä¿¡æ¯
SecurityContextè®¾ç½®åå…¨å±€å¯ç”¨
å¼‚å¸¸åˆ†ç±»å¤„ç†è¿”å›æ˜ç¡®é”™è¯¯
```