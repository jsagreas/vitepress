---
title: 2ã€æ ¸å¿ƒæ¶æ„ä¸ç»„ä»¶
---
## ğŸ“š ç›®å½•

1. [Spring Security æ¶æ„æ¦‚è§ˆ](#1-Spring-Security-æ¶æ„æ¦‚è§ˆ)
2. [DelegatingFilterProxy ä»£ç†è¿‡æ»¤å™¨](#2-DelegatingFilterProxy-ä»£ç†è¿‡æ»¤å™¨)
3. [FilterChainProxy è¿‡æ»¤å™¨é“¾ä»£ç†](#3-FilterChainProxy-è¿‡æ»¤å™¨é“¾ä»£ç†)
4. [SecurityFilterChain å®‰å…¨è¿‡æ»¤å™¨é“¾](#4-SecurityFilterChain-å®‰å…¨è¿‡æ»¤å™¨é“¾)
5. [è®¤è¯æ ¸å¿ƒç»„ä»¶](#5-è®¤è¯æ ¸å¿ƒç»„ä»¶)
6. [SecurityContextHolder å®‰å…¨ä¸Šä¸‹æ–‡](#6-SecurityContextHolder-å®‰å…¨ä¸Šä¸‹æ–‡)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ—ï¸ Spring Security æ¶æ„æ¦‚è§ˆ


### 1.1 Spring Security æ˜¯ä»€ä¹ˆ


**ç”¨ç”Ÿæ´»åœºæ™¯æ¥ç†è§£**ï¼š
æƒ³è±¡ä½ å»å‚åŠ ä¸€ä¸ªé«˜ç«¯ä¼šè®®ï¼Œè¿›é—¨æ—¶ä¼šç»å†è¿™äº›æ­¥éª¤ï¼š
- é—¨å«éªŒè¯ä½ çš„é‚€è¯·å‡½ï¼ˆ**è®¤è¯**ï¼‰
- æ£€æŸ¥ä½ èƒ½è¿›å…¥å“ªäº›åŒºåŸŸï¼ˆ**æˆæƒ**ï¼‰
- å…¨ç¨‹æœ‰å®‰ä¿è·Ÿè¸ªä½ çš„ä½ç½®ï¼ˆ**ä¼šè¯ç®¡ç†**ï¼‰

Spring Security å°±æ˜¯ä½ åº”ç”¨ç¨‹åºçš„"å®‰ä¿ç³»ç»Ÿ"ï¼Œè´Ÿè´£ç¡®ä¿åªæœ‰åˆæ³•ç”¨æˆ·èƒ½è®¿é—®ç›¸åº”çš„èµ„æºã€‚

```
ğŸ¯ Spring Security æ ¸å¿ƒåŠŸèƒ½ï¼š
âœ… èº«ä»½è®¤è¯ - ç¡®è®¤"ä½ æ˜¯è°"
âœ… æƒé™æ§åˆ¶ - ç¡®å®š"ä½ èƒ½åšä»€ä¹ˆ"
âœ… æ”»å‡»é˜²æŠ¤ - é˜²æ­¢å¸¸è§å®‰å…¨æ”»å‡»
âœ… ä¼šè¯ç®¡ç† - è¿½è¸ªç”¨æˆ·ç™»å½•çŠ¶æ€
```

### 1.2 æ•´ä½“æ¶æ„ä¸€è§ˆ


Spring Security çš„å·¥ä½œåŸç†å°±åƒä¸€ä¸ª**å±‚å±‚æŠŠå…³çš„å®‰æ£€æµç¨‹**ï¼š

```
ğŸ” è¯·æ±‚å¤„ç†æµç¨‹ï¼š
ç”¨æˆ·è¯·æ±‚
    â†“
Servlet å®¹å™¨ (Tomcat/Jetty)
    â†“
DelegatingFilterProxy (Springçš„ä»£ç†æ¡¥æ¢)
    â†“
FilterChainProxy (Spring Securityçš„æ ¸å¿ƒè°ƒåº¦å™¨)
    â†“
SecurityFilterChain (ä¸€ç³»åˆ—å®‰å…¨æ£€æŸ¥)
    â†“
ä½ çš„ä¸šåŠ¡ä»£ç  (Controller/Service)
```

**ğŸ¨ æ ¸å¿ƒç»„ä»¶å…³ç³»å›¾**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Servlet å®¹å™¨                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   DelegatingFilterProxy          â”‚   â”‚ â† Servlet è¿‡æ»¤å™¨
â”‚  â”‚   (å§”æ‰˜ç»™Springç®¡ç†çš„è¿‡æ»¤å™¨)      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                 â†“                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   FilterChainProxy               â”‚   â”‚ â† Spring Security æ ¸å¿ƒ
â”‚  â”‚   (ç®¡ç†å¤šä¸ªè¿‡æ»¤å™¨é“¾)              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                 â†“                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  SecurityFilterChain 1           â”‚  â”‚ â† å…·ä½“çš„å®‰å…¨è§„åˆ™
â”‚  â”‚  - Filter A (è®¤è¯)                â”‚  â”‚
â”‚  â”‚  - Filter B (æˆæƒ)                â”‚  â”‚
â”‚  â”‚  - Filter C (CSRFä¿æŠ¤)            â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  SecurityFilterChain 2           â”‚  â”‚
â”‚  â”‚  (å¯ä»¥æœ‰å¤šä¸ªä¸åŒçš„å®‰å…¨é…ç½®)       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸ”— DelegatingFilterProxy ä»£ç†è¿‡æ»¤å™¨


### 2.1 ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªä»£ç†


**é—®é¢˜èƒŒæ™¯**ï¼š
Servlet å®¹å™¨ï¼ˆæ¯”å¦‚ Tomcatï¼‰å¯åŠ¨æ—¶ä¼šåˆ›å»ºè¿‡æ»¤å™¨ï¼Œä½†è¿™ä¸ªæ—¶å€™ Spring å®¹å™¨è¿˜æ²¡æœ‰åˆå§‹åŒ–å®Œæˆã€‚å°±åƒä½ æƒ³ç”¨å®¶é‡Œçš„æ™ºèƒ½å®¶å±…ç³»ç»Ÿï¼Œä½†ç”µæºè¿˜æ²¡é€šä¸Šã€‚

**DelegatingFilterProxy çš„ä½œç”¨**ï¼š
å®ƒå°±åƒä¸€ä¸ª"å ä½ç¬¦"æˆ–"ä¸­é—´äºº"ï¼Œå…ˆåœ¨ Servlet å®¹å™¨ä¸­å ä¸ªä½ç½®ï¼Œç­‰ Spring å®¹å™¨å¯åŠ¨å¥½äº†ï¼Œå†æŠŠå®é™…å·¥ä½œå§”æ‰˜ç»™ Spring ç®¡ç†çš„è¿‡æ»¤å™¨ã€‚

```
ğŸ­ ä»£ç†æ¨¡å¼çš„å¦™ç”¨ï¼š
Servletå®¹å™¨å¯åŠ¨
    â†“
åˆ›å»º DelegatingFilterProxy (å ä½ç¬¦)
    â†“
Springå®¹å™¨å¯åŠ¨
    â†“
DelegatingFilterProxy æ‰¾åˆ°çœŸæ­£çš„ Bean
    â†“
æŠŠè¯·æ±‚å§”æ‰˜ç»™ Spring ç®¡ç†çš„è¿‡æ»¤å™¨
```

### 2.2 å·¥ä½œåŸç†è¯¦è§£


**æ ¸å¿ƒæœºåˆ¶**ï¼š
```java
// ç®€åŒ–çš„å·¥ä½œåŸç†ç¤ºæ„
public class DelegatingFilterProxy extends GenericFilterBean {
    
    private String targetBeanName = "springSecurityFilterChain";
    
    @Override
    public void doFilter(ServletRequest request, 
                         ServletResponse response, 
                         FilterChain chain) {
        
        // 1. ä»Springå®¹å™¨ä¸­æ‰¾åˆ°çœŸæ­£çš„è¿‡æ»¤å™¨
        Filter delegate = findFilterBean();
        
        // 2. å§”æ‰˜ç»™çœŸæ­£çš„è¿‡æ»¤å™¨å¤„ç†
        delegate.doFilter(request, response, chain);
    }
    
    private Filter findFilterBean() {
        // ä»Spring ApplicationContextä¸­è·å–Bean
        return applicationContext.getBean(targetBeanName, Filter.class);
    }
}
```

**ğŸ”„ å§”æ‰˜æµç¨‹**ï¼š
```
HTTPè¯·æ±‚åˆ°è¾¾
    â†“
Servletå®¹å™¨è°ƒç”¨ DelegatingFilterProxy
    â†“
æŸ¥æ‰¾Spring Bean: "springSecurityFilterChain"
    â†“
æ‰¾åˆ° FilterChainProxy å®ä¾‹
    â†“
å§”æ‰˜ç»™ FilterChainProxy å¤„ç†
    â†“
å®é™…çš„å®‰å…¨æ£€æŸ¥å¼€å§‹
```

### 2.3 Spring Boot ä¸­çš„è‡ªåŠ¨é…ç½®


åœ¨ Spring Boot é¡¹ç›®ä¸­ï¼Œä½ é€šå¸¸**ä¸éœ€è¦æ‰‹åŠ¨é…ç½®** DelegatingFilterProxyï¼Œå› ä¸ºå®ƒä¼šè‡ªåŠ¨æ³¨å†Œï¼š

```java
// Spring Boot è‡ªåŠ¨é…ç½®ï¼ˆæ— éœ€æ‰‹åŠ¨ç¼–å†™ï¼‰
@Configuration
@ConditionalOnWebApplication
public class SecurityFilterAutoConfiguration {
    
    @Bean
    public DelegatingFilterProxyRegistrationBean securityFilterChain() {
        DelegatingFilterProxyRegistrationBean registration = 
            new DelegatingFilterProxyRegistrationBean("springSecurityFilterChain");
        registration.setOrder(SecurityProperties.DEFAULT_FILTER_ORDER);
        return registration;
    }
}
```

**ğŸ’¡ è®°å¿†è¦ç‚¹**ï¼š
- DelegatingFilterProxy æ˜¯ Servlet è¿‡æ»¤å™¨ï¼Œç”± Servlet å®¹å™¨ç®¡ç†
- å®ƒçš„èŒè´£æ˜¯**æ¡¥æ¥** Servlet ä¸–ç•Œå’Œ Spring ä¸–ç•Œ
- å®é™…å®‰å…¨å·¥ä½œç”±å®ƒå§”æ‰˜çš„ Spring Bean å®Œæˆ

---

## 3. âš™ï¸ FilterChainProxy è¿‡æ»¤å™¨é“¾ä»£ç†


### 3.1 æ ¸å¿ƒè°ƒåº¦å™¨çš„è§’è‰²


å¦‚æœè¯´ DelegatingFilterProxy æ˜¯"å‰å°æ¥å¾…å‘˜"ï¼Œé‚£ä¹ˆ **FilterChainProxy å°±æ˜¯"å®‰ä¿ä¸»ç®¡"**ï¼Œè´Ÿè´£åè°ƒæ‰€æœ‰å®‰å…¨æ£€æŸ¥å·¥ä½œã€‚

```
ğŸ¯ FilterChainProxy çš„èŒè´£ï¼š
âœ… ç®¡ç†å¤šä¸ª SecurityFilterChainï¼ˆå¯ä»¥æœ‰ä¸åŒçš„å®‰å…¨è§„åˆ™ï¼‰
âœ… æ ¹æ®è¯·æ±‚è·¯å¾„åŒ¹é…åˆé€‚çš„è¿‡æ»¤å™¨é“¾
âœ… ç¡®ä¿å®‰å…¨è¿‡æ»¤å™¨æŒ‰æ­£ç¡®é¡ºåºæ‰§è¡Œ
âœ… æä¾›ç»Ÿä¸€çš„å®‰å…¨å¼‚å¸¸å¤„ç†
```

### 3.2 å¤šè¿‡æ»¤å™¨é“¾ç®¡ç†


**ä¸ºä»€ä¹ˆéœ€è¦å¤šä¸ªè¿‡æ»¤å™¨é“¾ï¼Ÿ**
ä¸åŒçš„URLè·¯å¾„å¯èƒ½éœ€è¦ä¸åŒçš„å®‰å…¨ç­–ç•¥ï¼Œå°±åƒåšç‰©é¦†çš„ä¸åŒåŒºåŸŸæœ‰ä¸åŒçš„è®¿é—®è§„åˆ™ï¼š

```
ğŸ›ï¸ å®é™…åœºæ™¯å¯¹æ¯”ï¼š
/api/public/**    â†’ å…¬å¼€åŒºåŸŸï¼Œæ— éœ€ç™»å½•
/api/user/**      â†’ éœ€è¦æ™®é€šç”¨æˆ·ç™»å½•
/api/admin/**     â†’ éœ€è¦ç®¡ç†å‘˜æƒé™
/oauth2/**        â†’ OAuth2 è®¤è¯æµç¨‹
```

**å·¥ä½œæœºåˆ¶**ï¼š
```
FilterChainProxy æ”¶åˆ°è¯·æ±‚
    â†“
éå†æ‰€æœ‰ SecurityFilterChain
    â†“
æ£€æŸ¥å“ªä¸ªé“¾çš„ RequestMatcher åŒ¹é…å½“å‰è¯·æ±‚
    â†“
ä½¿ç”¨ç¬¬ä¸€ä¸ªåŒ¹é…çš„ SecurityFilterChain
    â†“
æ‰§è¡Œè¯¥é“¾ä¸­çš„æ‰€æœ‰è¿‡æ»¤å™¨
```

### 3.3 æ ¸å¿ƒå®ç°é€»è¾‘


```java
// ç®€åŒ–çš„æ ¸å¿ƒé€»è¾‘
public class FilterChainProxy extends GenericFilterBean {
    
    private List<SecurityFilterChain> filterChains;
    
    @Override
    public void doFilter(ServletRequest request, 
                         ServletResponse response, 
                         FilterChain chain) {
        
        HttpServletRequest httpRequest = (HttpServletRequest) request;
        
        // 1. æ‰¾åˆ°åŒ¹é…çš„è¿‡æ»¤å™¨é“¾
        List<Filter> filters = getFilters(httpRequest);
        
        if (filters.isEmpty()) {
            // æ²¡æœ‰åŒ¹é…çš„å®‰å…¨è§„åˆ™ï¼Œç›´æ¥æ”¾è¡Œ
            chain.doFilter(request, response);
            return;
        }
        
        // 2. åˆ›å»ºè™šæ‹Ÿè¿‡æ»¤å™¨é“¾
        VirtualFilterChain virtualChain = 
            new VirtualFilterChain(chain, filters);
        
        // 3. æ‰§è¡Œå®‰å…¨è¿‡æ»¤å™¨
        virtualChain.doFilter(request, response);
    }
    
    private List<Filter> getFilters(HttpServletRequest request) {
        for (SecurityFilterChain chain : filterChains) {
            if (chain.matches(request)) {
                return chain.getFilters();
            }
        }
        return Collections.emptyList();
    }
}
```

### 3.4 è¿‡æ»¤å™¨æ‰§è¡Œé¡ºåº


Spring Security çš„è¿‡æ»¤å™¨æœ‰**å›ºå®šçš„æ‰§è¡Œé¡ºåº**ï¼Œè¿™ä¸ªé¡ºåºéå¸¸é‡è¦ï¼š

```
ğŸ“‹ å…³é”®è¿‡æ»¤å™¨æ‰§è¡Œé¡ºåºï¼ˆä»ä¸Šåˆ°ä¸‹ï¼‰ï¼š
1. ChannelProcessingFilter          - HTTPSé‡å®šå‘
2. SecurityContextPersistenceFilter - æ¢å¤SecurityContext
3. LogoutFilter                     - å¤„ç†ç™»å‡º
4. UsernamePasswordAuthenticationFilter - ç”¨æˆ·åå¯†ç è®¤è¯
5. BasicAuthenticationFilter        - HTTP Basicè®¤è¯
6. RequestCacheAwareFilter          - è¯·æ±‚ç¼“å­˜
7. SecurityContextHolderAwareRequestFilter - RequeståŒ…è£…
8. AnonymousAuthenticationFilter    - åŒ¿åç”¨æˆ·å¤„ç†
9. SessionManagementFilter          - ä¼šè¯ç®¡ç†
10. ExceptionTranslationFilter      - å¼‚å¸¸è½¬æ¢
11. FilterSecurityInterceptor       - æœ€ç»ˆçš„æˆæƒå†³ç­–
```

**ğŸ”¢ é¡ºåºé‡è¦æ€§ç¤ºä¾‹**ï¼š
```
é”™è¯¯çš„é¡ºåºï¼š
è®¤è¯è¿‡æ»¤å™¨ â†’ æˆæƒè¿‡æ»¤å™¨ â†’ å¼‚å¸¸å¤„ç†è¿‡æ»¤å™¨
é—®é¢˜ï¼šå¼‚å¸¸æ— æ³•è¢«æ­£ç¡®æ•è·å¤„ç†

æ­£ç¡®çš„é¡ºåºï¼š
å¼‚å¸¸å¤„ç†è¿‡æ»¤å™¨ â†’ è®¤è¯è¿‡æ»¤å™¨ â†’ æˆæƒè¿‡æ»¤å™¨
ä¼˜åŠ¿ï¼šæ‰€æœ‰å¼‚å¸¸éƒ½èƒ½è¢«ç»Ÿä¸€å¤„ç†
```

---

## 4. ğŸ” SecurityFilterChain å®‰å…¨è¿‡æ»¤å™¨é“¾


### 4.1 è¿‡æ»¤å™¨é“¾çš„æœ¬è´¨


SecurityFilterChain å°±æ˜¯ä¸€ä¸ª**å®‰å…¨æ£€æŸ¥æ¸…å•**ï¼Œå®šä¹‰äº†è¯·æ±‚éœ€è¦ç»è¿‡å“ªäº›å®‰å…¨éªŒè¯ã€‚

```
ğŸ¯ SecurityFilterChain åŒ…å«ä¸¤ä¸ªæ ¸å¿ƒéƒ¨åˆ†ï¼š
1. RequestMatcher - åˆ¤æ–­è¿™ä¸ªé“¾æ˜¯å¦é€‚ç”¨äºå½“å‰è¯·æ±‚
2. List<Filter>   - é€‚ç”¨æ—¶è¦æ‰§è¡Œçš„è¿‡æ»¤å™¨åˆ—è¡¨
```

### 4.2 é…ç½®å®ä¾‹è§£æ


**ä¼ ç»Ÿé…ç½®æ–¹å¼**ï¼ˆSpring Security 5.xï¼‰ï¼š
```java
@Configuration
@EnableWebSecurity
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
            // è¿™äº›é…ç½®æœ€ç»ˆä¼šè½¬æ¢æˆ SecurityFilterChain
            .authorizeRequests()
                .antMatchers("/public/**").permitAll()
                .antMatchers("/admin/**").hasRole("ADMIN")
                .anyRequest().authenticated()
            .and()
            .formLogin()
            .and()
            .httpBasic();
    }
}
```

**ç°ä»£é…ç½®æ–¹å¼**ï¼ˆSpring Security 6.x+ï¼‰ï¼š
```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(authorize -> authorize
                .requestMatchers("/public/**").permitAll()
                .requestMatchers("/admin/**").hasRole("ADMIN")
                .anyRequest().authenticated()
            )
            .formLogin(Customizer.withDefaults())
            .httpBasic(Customizer.withDefaults());
        
        return http.build(); // è¿”å›é…ç½®å¥½çš„ SecurityFilterChain
    }
}
```

### 4.3 å¤šè¿‡æ»¤å™¨é“¾é…ç½®


**å®é™…ä¸šåŠ¡åœºæ™¯**ï¼š
```java
@Configuration
@EnableWebSecurity
public class MultiChainSecurityConfig {
    
    // API æ¥å£çš„å®‰å…¨é…ç½®
    @Bean
    @Order(1)  // ä¼˜å…ˆçº§é«˜ï¼Œå…ˆåŒ¹é…
    public SecurityFilterChain apiFilterChain(HttpSecurity http) throws Exception {
        http
            .securityMatcher("/api/**")  // åªåŒ¹é… /api/** è·¯å¾„
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/api/public/**").permitAll()
                .anyRequest().authenticated()
            )
            .sessionManagement(session -> 
                session.sessionCreationPolicy(SessionCreationPolicy.STATELESS)
            )
            .httpBasic(Customizer.withDefaults());
        
        return http.build();
    }
    
    // Web é¡µé¢çš„å®‰å…¨é…ç½®
    @Bean
    @Order(2)  // ä¼˜å…ˆçº§ä½ï¼ŒååŒ¹é…
    public SecurityFilterChain webFilterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/login", "/css/**", "/js/**").permitAll()
                .anyRequest().authenticated()
            )
            .formLogin(form -> form
                .loginPage("/login")
                .permitAll()
            )
            .logout(logout -> logout.permitAll());
        
        return http.build();
    }
}
```

**ğŸ”„ åŒ¹é…æµç¨‹è¯´æ˜**ï¼š
```
è¯·æ±‚ï¼š/api/users/profile
    â†“
æ£€æŸ¥ Order(1) çš„ apiFilterChain
    â†“
RequestMatcher: /api/** âœ“ åŒ¹é…æˆåŠŸ
    â†“
ä½¿ç”¨ API çš„å®‰å…¨è§„åˆ™ï¼ˆæ— çŠ¶æ€ã€Basicè®¤è¯ï¼‰
    â†“
ä¸å†æ£€æŸ¥å…¶ä»– FilterChain

è¯·æ±‚ï¼š/dashboard
    â†“
æ£€æŸ¥ Order(1) çš„ apiFilterChain
    â†“
RequestMatcher: /api/** âœ— ä¸åŒ¹é…
    â†“
æ£€æŸ¥ Order(2) çš„ webFilterChain
    â†“
RequestMatcher: /** âœ“ åŒ¹é…æˆåŠŸ
    â†“
ä½¿ç”¨ Web çš„å®‰å…¨è§„åˆ™ï¼ˆæœ‰çŠ¶æ€ã€è¡¨å•ç™»å½•ï¼‰
```

### 4.4 è¿‡æ»¤å™¨é“¾è°ƒè¯•æŠ€å·§


**å¦‚ä½•æŸ¥çœ‹å®é™…çš„è¿‡æ»¤å™¨é“¾ï¼Ÿ**
```java
@Configuration
public class SecurityDebugConfig {
    
    @Bean
    public WebSecurityCustomizer webSecurityCustomizer() {
        return (web) -> web.debug(true);  // å¼€å¯è°ƒè¯•æ¨¡å¼
    }
}
```

å¼€å¯åï¼Œå¯åŠ¨æ—¥å¿—ä¼šæ˜¾ç¤ºï¼š
```
Security filter chain: [
  DisableEncodeUrlFilter
  WebAsyncManagerIntegrationFilter
  SecurityContextHolderFilter
  HeaderWriterFilter
  CsrfFilter
  LogoutFilter
  UsernamePasswordAuthenticationFilter
  ...
]
```

---

## 5. ğŸ« è®¤è¯æ ¸å¿ƒç»„ä»¶


### 5.1 è®¤è¯æµç¨‹æ¦‚è§ˆ


è®¤è¯è¿‡ç¨‹å°±åƒæœºåœºå®‰æ£€ï¼Œåˆ†ä¸ºå‡ ä¸ªæ˜ç¡®çš„æ­¥éª¤ï¼š

```
ğŸ›‚ è®¤è¯æµç¨‹ç±»æ¯”ï¼š
1. å‡ºç¤ºè¯ä»¶ â†’ æä¾›ç”¨æˆ·åå¯†ç  (Authenticationå¯¹è±¡)
2. éªŒè¯è¯ä»¶ â†’ è°ƒç”¨ AuthenticationManager
3. ä¸“ä¸šéªŒè¯ â†’ ProviderManager æ‰¾åˆé€‚çš„ Provider
4. æŸ¥è¯¢æ•°æ®åº“ â†’ AuthenticationProvider éªŒè¯
5. æ”¾è¡Œæˆ–æ‹’ç» â†’ è¿”å›è®¤è¯ç»“æœ
```

**æ ¸å¿ƒç»„ä»¶å…³ç³»**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    UsernamePasswordAuthenticationFilter â”‚ â† æ”¶é›†ç”¨æˆ·å‡­è¯
â”‚    (åˆ›å»º Authentication å¯¹è±¡)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       AuthenticationManager              â”‚ â† è®¤è¯ç®¡ç†å™¨æ¥å£
â”‚       (å®šä¹‰è®¤è¯çš„æ ‡å‡†è¡Œä¸º)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ProviderManager                  â”‚ â† å®é™…çš„ç®¡ç†å™¨å®ç°
â”‚         (ç®¡ç†å¤šä¸ª Provider)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    AuthenticationProvider (å¤šä¸ª)         â”‚ â† å…·ä½“çš„è®¤è¯é€»è¾‘
â”‚    - DaoAuthenticationProvider           â”‚
â”‚    - JwtAuthenticationProvider           â”‚
â”‚    - OAuth2AuthenticationProvider        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 AuthenticationManager è®¤è¯ç®¡ç†å™¨


**æ¥å£å®šä¹‰**ï¼š
```java
public interface AuthenticationManager {
    
    /**
     * è®¤è¯æ–¹æ³•
     * @param authentication åŒ…å«ç”¨æˆ·æä¾›çš„å‡­è¯
     * @return è®¤è¯æˆåŠŸåçš„å®Œæ•´è®¤è¯ä¿¡æ¯
     * @throws AuthenticationException è®¤è¯å¤±è´¥
     */
    Authentication authenticate(Authentication authentication) 
        throws AuthenticationException;
}
```

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- è¿™æ˜¯ä¸€ä¸ª**æ¥å£**ï¼Œå®šä¹‰äº†è®¤è¯çš„æ ‡å‡†è¡Œä¸º
- è¾“å…¥ï¼šæœªè®¤è¯çš„ `Authentication` å¯¹è±¡ï¼ˆåªæœ‰ç”¨æˆ·åå¯†ç ï¼‰
- è¾“å‡ºï¼šå·²è®¤è¯çš„ `Authentication` å¯¹è±¡ï¼ˆåŒ…å«æƒé™ç­‰å®Œæ•´ä¿¡æ¯ï¼‰
- å¤±è´¥ï¼šæŠ›å‡º `AuthenticationException` å¼‚å¸¸

### 5.3 ProviderManager æä¾›è€…ç®¡ç†å™¨


**ProviderManager æ˜¯ AuthenticationManager çš„ä¸»è¦å®ç°**ï¼Œå®ƒå°±åƒä¸€ä¸ª"è®¤è¯æœåŠ¡è°ƒåº¦ä¸­å¿ƒ"ï¼š

```java
public class ProviderManager implements AuthenticationManager {
    
    private List<AuthenticationProvider> providers;
    private AuthenticationManager parent;  // å¯é€‰çš„çˆ¶çº§ç®¡ç†å™¨
    
    @Override
    public Authentication authenticate(Authentication authentication) 
            throws AuthenticationException {
        
        Class<?> toTest = authentication.getClass();
        
        // éå†æ‰€æœ‰ Providerï¼Œæ‰¾åˆ°æ”¯æŒå½“å‰è®¤è¯ç±»å‹çš„
        for (AuthenticationProvider provider : providers) {
            if (!provider.supports(toTest)) {
                continue;  // ä¸æ”¯æŒï¼Œè·³è¿‡
            }
            
            try {
                // å°è¯•è®¤è¯
                Authentication result = provider.authenticate(authentication);
                if (result != null) {
                    return result;  // è®¤è¯æˆåŠŸï¼Œè¿”å›
                }
            } catch (AuthenticationException e) {
                // è®¤è¯å¤±è´¥ï¼Œç»§ç»­å°è¯•ä¸‹ä¸€ä¸ª
            }
        }
        
        // å¦‚æœæœ‰çˆ¶çº§ç®¡ç†å™¨ï¼Œå§”æ‰˜ç»™çˆ¶çº§
        if (parent != null) {
            return parent.authenticate(authentication);
        }
        
        throw new ProviderNotFoundException("æ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„è®¤è¯æä¾›è€…");
    }
}
```

**ğŸ”„ å·¥ä½œæœºåˆ¶**ï¼š
```
ç”¨æˆ·æäº¤ç™»å½•
    â†“
åˆ›å»º UsernamePasswordAuthenticationToken
    â†“
ä¼ é€’ç»™ ProviderManager.authenticate()
    â†“
éå† providers åˆ—è¡¨
    â†“
æ‰¾åˆ° DaoAuthenticationProvider (supports è¿”å›true)
    â†“
DaoAuthenticationProvider.authenticate()
    â†“
æŸ¥è¯¢æ•°æ®åº“éªŒè¯ç”¨æˆ·åå¯†ç 
    â†“
æˆåŠŸï¼šè¿”å›å®Œæ•´çš„ Authentication
å¤±è´¥ï¼šæŠ›å‡º BadCredentialsException
```

### 5.4 AuthenticationProvider è®¤è¯æä¾›è€…


**Provider çš„èŒè´£**ï¼š
æ¯ä¸ª Provider è´Ÿè´£ä¸€ç§ç‰¹å®šçš„è®¤è¯æ–¹å¼ï¼Œå°±åƒä¸åŒçš„å®‰æ£€é€šé“ï¼š

```
ğŸšª ä¸åŒçš„è®¤è¯æä¾›è€…ï¼š
DaoAuthenticationProvider      - ç”¨æˆ·åå¯†ç ï¼ˆæ•°æ®åº“æŸ¥è¯¢ï¼‰
LdapAuthenticationProvider     - LDAP ç›®å½•æœåŠ¡è®¤è¯
JwtAuthenticationProvider      - JWT Token è®¤è¯
OAuth2AuthenticationProvider   - OAuth2 è®¤è¯
RememberMeAuthenticationProvider - è®°ä½æˆ‘è®¤è¯
```

**æ¥å£å®šä¹‰**ï¼š
```java
public interface AuthenticationProvider {
    
    // æ‰§è¡Œè®¤è¯
    Authentication authenticate(Authentication authentication) 
        throws AuthenticationException;
    
    // åˆ¤æ–­æ˜¯å¦æ”¯æŒè¿™ç§è®¤è¯ç±»å‹
    boolean supports(Class<?> authentication);
}
```

**DaoAuthenticationProvider å®ç°ç¤ºä¾‹**ï¼š
```java
public class DaoAuthenticationProvider extends AbstractUserDetailsAuthenticationProvider {
    
    private UserDetailsService userDetailsService;
    private PasswordEncoder passwordEncoder;
    
    @Override
    protected void additionalAuthenticationChecks(
            UserDetails userDetails,
            UsernamePasswordAuthenticationToken authentication) {
        
        // 1. è·å–ç”¨æˆ·è¾“å…¥çš„å¯†ç 
        String presentedPassword = authentication.getCredentials().toString();
        
        // 2. è·å–æ•°æ®åº“ä¸­çš„åŠ å¯†å¯†ç 
        String encodedPassword = userDetails.getPassword();
        
        // 3. éªŒè¯å¯†ç æ˜¯å¦åŒ¹é…
        if (!passwordEncoder.matches(presentedPassword, encodedPassword)) {
            throw new BadCredentialsException("å¯†ç é”™è¯¯");
        }
    }
    
    @Override
    protected UserDetails retrieveUser(
            String username,
            UsernamePasswordAuthenticationToken authentication) {
        
        // ä»æ•°æ®åº“åŠ è½½ç”¨æˆ·ä¿¡æ¯
        UserDetails user = userDetailsService.loadUserByUsername(username);
        
        if (user == null) {
            throw new UsernameNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨");
        }
        
        return user;
    }
}
```

### 5.5 è®¤è¯é…ç½®å®ä¾‹


**å®Œæ•´çš„è®¤è¯é…ç½®**ï¼š
```java
@Configuration
public class AuthenticationConfig {
    
    // é…ç½® AuthenticationManager
    @Bean
    public AuthenticationManager authenticationManager(
            AuthenticationConfiguration authConfig) throws Exception {
        return authConfig.getAuthenticationManager();
    }
    
    // é…ç½®ç”¨æˆ·è¯¦æƒ…æœåŠ¡
    @Bean
    public UserDetailsService userDetailsService() {
        return new CustomUserDetailsService();  // è‡ªå®šä¹‰å®ç°
    }
    
    // é…ç½®å¯†ç ç¼–ç å™¨
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
    
    // é…ç½®è®¤è¯æä¾›è€…ï¼ˆå¯é€‰ï¼Œé€šå¸¸è‡ªåŠ¨é…ç½®ï¼‰
    @Bean
    public DaoAuthenticationProvider authenticationProvider() {
        DaoAuthenticationProvider provider = new DaoAuthenticationProvider();
        provider.setUserDetailsService(userDetailsService());
        provider.setPasswordEncoder(passwordEncoder());
        return provider;
    }
}
```

---

## 6. ğŸ—„ï¸ SecurityContextHolder å®‰å…¨ä¸Šä¸‹æ–‡


### 6.1 å®‰å…¨ä¸Šä¸‹æ–‡çš„ä½œç”¨


**SecurityContextHolder å°±åƒä½ çš„"èº«ä»½è¯ä»¶åŒ…"**ï¼Œéšæ—¶å¯ä»¥æŸ¥çœ‹å½“å‰ç™»å½•ç”¨æˆ·æ˜¯è°ã€‚

```
ğŸ¯ SecurityContextHolder æ ¸å¿ƒåŠŸèƒ½ï¼š
âœ… å­˜å‚¨å½“å‰ç”¨æˆ·çš„è®¤è¯ä¿¡æ¯
âœ… æä¾›çº¿ç¨‹çº§åˆ«çš„è®¿é—®æ–¹å¼
âœ… æ”¯æŒå¤šç§å­˜å‚¨ç­–ç•¥
âœ… è´¯ç©¿æ•´ä¸ªè¯·æ±‚ç”Ÿå‘½å‘¨æœŸ
```

### 6.2 å·¥ä½œåŸç†


**ä¸‰å±‚ç»“æ„**ï¼š
```
SecurityContextHolder (æŒæœ‰è€…)
    â†“ æŒæœ‰
SecurityContext (ä¸Šä¸‹æ–‡)
    â†“ åŒ…å«
Authentication (è®¤è¯ä¿¡æ¯)
    â”œâ”€â”€ Principal (ç”¨æˆ·ä¸»ä½“)
    â”œâ”€â”€ Credentials (å‡­è¯)
    â””â”€â”€ Authorities (æƒé™åˆ—è¡¨)
```

**æ ¸å¿ƒä»£ç ç»“æ„**ï¼š
```java
// ç®€åŒ–çš„å®ç°é€»è¾‘
public class SecurityContextHolder {
    
    // å­˜å‚¨ç­–ç•¥ï¼ˆé»˜è®¤ä½¿ç”¨ ThreadLocalï¼‰
    private static SecurityContextHolderStrategy strategy;
    
    // è·å–å½“å‰å®‰å…¨ä¸Šä¸‹æ–‡
    public static SecurityContext getContext() {
        return strategy.getContext();
    }
    
    // è®¾ç½®å®‰å…¨ä¸Šä¸‹æ–‡
    public static void setContext(SecurityContext context) {
        strategy.setContext(context);
    }
    
    // æ¸…é™¤ä¸Šä¸‹æ–‡ï¼ˆé‡è¦ï¼šè¯·æ±‚ç»“æŸæ—¶ï¼‰
    public static void clearContext() {
        strategy.clearContext();
    }
}
```

### 6.3 å­˜å‚¨ç­–ç•¥


Spring Security æä¾›äº†ä¸‰ç§å­˜å‚¨ç­–ç•¥ï¼š

**ğŸ“‹ å­˜å‚¨ç­–ç•¥å¯¹æ¯”**ï¼š

| ç­–ç•¥ç±»å‹ | **å®ç°ç±»** | **é€‚ç”¨åœºæ™¯** | **ç‰¹ç‚¹** |
|---------|-----------|-------------|---------|
| **ThreadLocal** | `ThreadLocalSecurityContextHolderStrategy` | `å•ä½“åº”ç”¨ï¼ˆé»˜è®¤ï¼‰` | `çº¿ç¨‹éš”ç¦»ï¼Œæœ€å¸¸ç”¨` |
| **InheritableThreadLocal** | `InheritableThreadLocalSecurityContextHolderStrategy` | `éœ€è¦å­çº¿ç¨‹ç»§æ‰¿` | `çˆ¶å­çº¿ç¨‹å…±äº«` |
| **Global** | `GlobalSecurityContextHolderStrategy` | `ç‹¬ç«‹åº”ç”¨` | `å…¨å±€å…±äº«ï¼Œå°‘ç”¨` |

**é»˜è®¤ç­–ç•¥ï¼ˆThreadLocalï¼‰**ï¼š
```java
// æ¯ä¸ªçº¿ç¨‹æœ‰ç‹¬ç«‹çš„å®‰å…¨ä¸Šä¸‹æ–‡
Thread 1: SecurityContext(ç”¨æˆ·A) â† äº’ä¸å¹²æ‰°
Thread 2: SecurityContext(ç”¨æˆ·B)
Thread 3: SecurityContext(ç”¨æˆ·C)
```

**è®¾ç½®å­˜å‚¨ç­–ç•¥**ï¼š
```java
// åœ¨åº”ç”¨å¯åŠ¨æ—¶è®¾ç½®ï¼ˆé€šå¸¸ä¸éœ€è¦æ”¹ï¼‰
@PostConstruct
public void init() {
    SecurityContextHolder.setStrategyName(
        SecurityContextHolder.MODE_INHERITABLETHREADLOCAL
    );
}
```

### 6.4 è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯


**æœ€å¸¸è§çš„ç”¨æ³•**ï¼š
```java
@RestController
public class UserController {
    
    @GetMapping("/me")
    public UserInfo getCurrentUser() {
        // 1. è·å– SecurityContext
        SecurityContext context = SecurityContextHolder.getContext();
        
        // 2. è·å– Authentication
        Authentication authentication = context.getAuthentication();
        
        if (authentication == null) {
            return null;  // æœªè®¤è¯
        }
        
        // 3. è·å–ç”¨æˆ·ä¸»ä½“
        Object principal = authentication.getPrincipal();
        
        if (principal instanceof UserDetails) {
            UserDetails userDetails = (UserDetails) principal;
            return new UserInfo(
                userDetails.getUsername(),
                userDetails.getAuthorities()
            );
        }
        
        return null;
    }
    
    // ç®€åŒ–å†™æ³•
    @GetMapping("/username")
    public String getUsername() {
        return SecurityContextHolder.getContext()
            .getAuthentication()
            .getName();
    }
}
```

**ä½¿ç”¨æ³¨è§£è·å–ç”¨æˆ·**ï¼š
```java
@RestController
public class UserController {
    
    // Spring Security æä¾›çš„æ³¨è§£
    @GetMapping("/profile")
    public String getProfile(@AuthenticationPrincipal UserDetails user) {
        return "å½“å‰ç”¨æˆ·ï¼š" + user.getUsername();
    }
    
    // è‡ªå®šä¹‰ç”¨æˆ·ç±»
    @GetMapping("/info")
    public String getUserInfo(@AuthenticationPrincipal CustomUser user) {
        return "ç”¨æˆ·IDï¼š" + user.getId() + 
               ", å§“åï¼š" + user.getRealName();
    }
}
```

### 6.5 å®‰å…¨ä¸Šä¸‹æ–‡çš„ç”Ÿå‘½å‘¨æœŸ


**è¯·æ±‚å¤„ç†å…¨æµç¨‹**ï¼š
```
1. è¯·æ±‚åˆ°è¾¾
    â†“
2. SecurityContextPersistenceFilter 
   ä» Session ä¸­æ¢å¤ SecurityContext
    â†“
3. è®¾ç½®åˆ° SecurityContextHolder
    â†“
4. æ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼ˆå¯ä»¥éšæ—¶é€šè¿‡ SecurityContextHolder è·å–ç”¨æˆ·ï¼‰
    â†“
5. è¯·æ±‚å¤„ç†å®Œæˆ
    â†“
6. SecurityContextPersistenceFilter 
   å°† SecurityContext ä¿å­˜åˆ° Session
    â†“
7. æ¸…é™¤ SecurityContextHolderï¼ˆé˜²æ­¢å†…å­˜æ³„æ¼ï¼‰
```

**æ‰‹åŠ¨è®¾ç½®è®¤è¯ä¿¡æ¯**ï¼ˆå°‘è§ä½†æœ‰ç”¨ï¼‰ï¼š
```java
@Service
public class CustomAuthService {
    
    public void authenticateUser(String username) {
        // 1. åŠ è½½ç”¨æˆ·ä¿¡æ¯
        UserDetails user = userDetailsService.loadUserByUsername(username);
        
        // 2. åˆ›å»ºè®¤è¯å¯¹è±¡
        UsernamePasswordAuthenticationToken authentication = 
            new UsernamePasswordAuthenticationToken(
                user, 
                user.getPassword(), 
                user.getAuthorities()
            );
        
        // 3. è®¾ç½®åˆ° SecurityContext
        SecurityContext context = SecurityContextHolder.createEmptyContext();
        context.setAuthentication(authentication);
        SecurityContextHolder.setContext(context);
    }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 æ¶æ„å±‚æ¬¡è®°å¿†


```
ğŸ—ï¸ ä»å¤–åˆ°å†…çš„å±‚æ¬¡ç»“æ„ï¼š
Servlet Filter (DelegatingFilterProxy)
    â†“ å§”æ‰˜ç»™
Spring Bean (FilterChainProxy)
    â†“ ç®¡ç†
å¤šä¸ª SecurityFilterChain
    â†“ åŒ…å«
å…·ä½“çš„ Security Filters
    â†“ ä½¿ç”¨
AuthenticationManager + SecurityContextHolder
```

### 7.2 æ ¸å¿ƒç»„ä»¶é€Ÿè®°


**ğŸ”‘ äº”å¤§æ ¸å¿ƒç»„ä»¶**ï¼š

```
1ï¸âƒ£ DelegatingFilterProxy
   è§’è‰²ï¼šæ¡¥æ¢
   èŒè´£ï¼šè¿æ¥ Servlet å®¹å™¨å’Œ Spring å®¹å™¨

2ï¸âƒ£ FilterChainProxy
   è§’è‰²ï¼šè°ƒåº¦å™¨
   èŒè´£ï¼šç®¡ç†å’Œè°ƒåº¦å¤šä¸ª SecurityFilterChain

3ï¸âƒ£ SecurityFilterChain
   è§’è‰²ï¼šè§„åˆ™é›†
   èŒè´£ï¼šå®šä¹‰å…·ä½“çš„å®‰å…¨æ£€æŸ¥æµç¨‹

4ï¸âƒ£ AuthenticationManager + ProviderManager
   è§’è‰²ï¼šè®¤è¯ä¸­å¿ƒ
   èŒè´£ï¼šåè°ƒå„ç§è®¤è¯æ–¹å¼

5ï¸âƒ£ SecurityContextHolder
   è§’è‰²ï¼šä¸Šä¸‹æ–‡
   èŒè´£ï¼šå­˜å‚¨å’Œæä¾›å½“å‰ç”¨æˆ·ä¿¡æ¯
```

### 7.3 è®¤è¯æµç¨‹å®Œæ•´é“¾è·¯


```
ğŸ” ç”¨æˆ·ç™»å½•å®Œæ•´æµç¨‹ï¼š
1. ç”¨æˆ·æäº¤ç”¨æˆ·åå¯†ç 
    â†“
2. UsernamePasswordAuthenticationFilter æ‹¦æˆª
    â†“
3. åˆ›å»º UsernamePasswordAuthenticationToken (æœªè®¤è¯)
    â†“
4. è°ƒç”¨ AuthenticationManager.authenticate()
    â†“
5. ProviderManager æ‰¾åˆ°åˆé€‚çš„ Provider
    â†“
6. DaoAuthenticationProvider éªŒè¯
    â”œâ”€â”€ UserDetailsService åŠ è½½ç”¨æˆ·
    â””â”€â”€ PasswordEncoder éªŒè¯å¯†ç 
    â†“
7. è®¤è¯æˆåŠŸï¼Œåˆ›å»ºå·²è®¤è¯çš„ Authentication
    â†“
8. è®¾ç½®åˆ° SecurityContextHolder
    â†“
9. ä¿å­˜åˆ° Sessionï¼ˆç”± SecurityContextPersistenceFilterï¼‰
    â†“
10. åç»­è¯·æ±‚ç›´æ¥ä» Session æ¢å¤ SecurityContext
```

### 7.4 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¹ˆå¤šå±‚æ¬¡ï¼Ÿ**
```
åˆ†å±‚çš„å¥½å¤„ï¼š
âœ… èŒè´£åˆ†ç¦»ï¼šæ¯å±‚åªå…³æ³¨è‡ªå·±çš„äº‹
âœ… çµæ´»æ‰©å±•ï¼šå¯ä»¥æ›¿æ¢ä»»ä½•ä¸€å±‚çš„å®ç°
âœ… å…¼å®¹æ€§å¥½ï¼šæ”¯æŒå¤šç§è®¤è¯æ–¹å¼å…±å­˜
âœ… æ˜“äºæµ‹è¯•ï¼šæ¯å±‚å¯ä»¥ç‹¬ç«‹æµ‹è¯•
```

**ğŸ”¹ è¿‡æ»¤å™¨é“¾å’Œè®¤è¯ç®¡ç†çš„å…³ç³»**ï¼š
```
è¿‡æ»¤å™¨é“¾ï¼šå®šä¹‰"åœ¨å“ªé‡Œæ£€æŸ¥"ã€"æ£€æŸ¥ä»€ä¹ˆ"
è®¤è¯ç®¡ç†ï¼šå®šä¹‰"æ€ä¹ˆæ£€æŸ¥"ã€"æ£€æŸ¥çš„å…·ä½“é€»è¾‘"

äºŒè€…åä½œï¼š
SecurityFilterChain ä¸­çš„è®¤è¯è¿‡æ»¤å™¨
    â†“ ä½¿ç”¨
AuthenticationManager è¿›è¡Œè®¤è¯
    â†“ ç»“æœå­˜å‚¨åœ¨
SecurityContextHolder
```

**ğŸ”¹ SecurityContextHolder çš„é‡è¦æ€§**ï¼š
```
ä¸ºä»€ä¹ˆå®ƒè¿™ä¹ˆé‡è¦ï¼Ÿ
â€¢ è´¯ç©¿æ•´ä¸ªè¯·æ±‚ç”Ÿå‘½å‘¨æœŸ
â€¢ æ‰€æœ‰éœ€è¦ç”¨æˆ·ä¿¡æ¯çš„åœ°æ–¹éƒ½ç”¨å®ƒ
â€¢ æ”¯æŒå£°æ˜å¼çš„æƒé™æ§åˆ¶
â€¢ æ˜¯ Spring Security çš„æ ¸å¿ƒæ•°æ®å­˜å‚¨
```

### 7.5 å®æˆ˜å»ºè®®


**ğŸ’¡ æ–°æ‰‹å­¦ä¹ è·¯å¾„**ï¼š
```
ç¬¬ä¸€æ­¥ï¼šç†è§£æ•´ä½“æµç¨‹
å…ˆçœ‹æ‡‚è¯·æ±‚ä»è¿›å…¥åˆ°å“åº”çš„å®Œæ•´æµç¨‹

ç¬¬äºŒæ­¥ï¼šæŒæ¡æ ¸å¿ƒç»„ä»¶
é‡ç‚¹ç†è§£ FilterChainProxyã€AuthenticationManagerã€SecurityContextHolder

ç¬¬ä¸‰æ­¥ï¼šå®è·µé…ç½®
ä»ç®€å•çš„é…ç½®å¼€å§‹ï¼Œé€æ­¥æ·±å…¥

ç¬¬å››æ­¥ï¼šè°ƒè¯•æºç 
å¼€å¯ debug æ¨¡å¼ï¼Œè§‚å¯Ÿè¿‡æ»¤å™¨æ‰§è¡Œé¡ºåº
```

**ğŸ”§ å¸¸è§é—®é¢˜æ’æŸ¥**ï¼š
```
é—®é¢˜ï¼šSecurityContext ä¸ºç©º
æ’æŸ¥ï¼š
1. æ£€æŸ¥æ˜¯å¦æ­£ç¡®é…ç½®äº† SecurityFilterChain
2. ç¡®è®¤è¯·æ±‚æ˜¯å¦ç»è¿‡è®¤è¯è¿‡æ»¤å™¨
3. æŸ¥çœ‹ Session æ˜¯å¦æ­£å¸¸

é—®é¢˜ï¼šè‡ªå®šä¹‰è¿‡æ»¤å™¨ä¸ç”Ÿæ•ˆ
æ’æŸ¥ï¼š
1. æ£€æŸ¥è¿‡æ»¤å™¨é¡ºåºæ˜¯å¦æ­£ç¡®
2. ç¡®è®¤æ˜¯å¦æ·»åŠ åˆ°äº† SecurityFilterChain
3. éªŒè¯ RequestMatcher æ˜¯å¦åŒ¹é…

é—®é¢˜ï¼šå¤šè¿‡æ»¤å™¨é“¾å†²çª
æ’æŸ¥ï¼š
1. æ£€æŸ¥ @Order ä¼˜å…ˆçº§è®¾ç½®
2. ç¡®è®¤ RequestMatcher çš„åŒ¹é…èŒƒå›´
3. é¿å…é‡å çš„åŒ¹é…è§„åˆ™
```

**ğŸ¯ æœ€ä½³å®è·µå»ºè®®**ï¼š
```
1. ä½¿ç”¨ç°ä»£é…ç½®æ–¹å¼
   ä¼˜å…ˆä½¿ç”¨ SecurityFilterChain Beanï¼Œè€Œéç»§æ‰¿ WebSecurityConfigurerAdapter

2. åˆç†åˆ’åˆ†è¿‡æ»¤å™¨é“¾
   ä¸åŒå®‰å…¨éœ€æ±‚çš„URLä½¿ç”¨ä¸åŒçš„ SecurityFilterChain

3. å–„ç”¨ SecurityContextHolder
   é¿å…åœ¨æ¯ä¸ªæ–¹æ³•ä¸­é‡å¤è·å–ç”¨æˆ·ä¿¡æ¯

4. å¼€å¯è°ƒè¯•æ¨¡å¼
   å¼€å‘ç¯å¢ƒå¼€å¯ debugï¼Œç”Ÿäº§ç¯å¢ƒå…³é—­

5. å¼‚å¸¸å¤„ç†è¦å®Œå–„
   é…ç½®è‡ªå®šä¹‰çš„ AuthenticationEntryPoint å’Œ AccessDeniedHandler
```

**ğŸ§  è®°å¿†å£è¯€**ï¼š
```
ä»£ç†è¿‡æ»¤æ˜¯æ¡¥æ¢ï¼Œè¿æ¥å®¹å™¨ä¸Springï¼›
é“¾å¼ä»£ç†åšè°ƒåº¦ï¼Œå¤šé“¾ç®¡ç†å¾ˆè½»æ¾ï¼›
è¿‡æ»¤å™¨é“¾å®šè§„åˆ™ï¼Œè®¤è¯æˆæƒå…¨åŒ…å®¹ï¼›
ç®¡ç†å™¨æ¥ç®¡è®¤è¯ï¼Œæä¾›è€…åšçœŸåŠŸï¼›
ä¸Šä¸‹æ–‡å­˜ç”¨æˆ·ä¿¡æ¯ï¼Œå…¨ç¨‹å¯ç”¨ä¸ä¼šç©ºã€‚
```

**æ ¸å¿ƒç†å¿µ**ï¼šSpring Security çš„æ¶æ„è®¾è®¡ä½“ç°äº†ä¼˜ç§€çš„**åˆ†å±‚æ€æƒ³**å’Œ**èŒè´£åˆ†ç¦»**åŸåˆ™ã€‚ç†è§£æ¯å±‚çš„èŒè´£ï¼Œå°±èƒ½è½»æ¾æŒæ¡æ•´ä¸ªå®‰å…¨æ¡†æ¶çš„è¿ä½œæœºåˆ¶ï¼