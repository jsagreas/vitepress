---
title: 1ã€ä¼šè¯ç®¡ç†é…ç½®
---
## ğŸ“š ç›®å½•

1. [ä¼šè¯ç®¡ç†åŸºç¡€æ¦‚å¿µ](#1-ä¼šè¯ç®¡ç†åŸºç¡€æ¦‚å¿µ)
2. [ä¼šè¯åˆ›å»ºç­–ç•¥è¯¦è§£](#2-ä¼šè¯åˆ›å»ºç­–ç•¥è¯¦è§£)
3. [å¹¶å‘ä¼šè¯æ§åˆ¶](#3-å¹¶å‘ä¼šè¯æ§åˆ¶)
4. [ä¼šè¯å›ºå®šæ”»å‡»é˜²æŠ¤](#4-ä¼šè¯å›ºå®šæ”»å‡»é˜²æŠ¤)
5. [ä¼šè¯æ³¨å†Œè¡¨æœºåˆ¶](#5-ä¼šè¯æ³¨å†Œè¡¨æœºåˆ¶)
6. [å®æˆ˜åº”ç”¨åœºæ™¯](#6-å®æˆ˜åº”ç”¨åœºæ™¯)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” ä¼šè¯ç®¡ç†åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Sessionä¼šè¯


**é€šä¿—ç†è§£**ï¼šå°±åƒä½ å»é“¶è¡ŒåŠä¸šåŠ¡ï¼ŒæŸœå‘˜ç»™ä½ ä¸€ä¸ªå·ç ç‰Œï¼Œè¿™ä¸ªå·ç ç‰Œå°±æ˜¯"ä¼šè¯"

```
ç°å®åœºæ™¯ç±»æ¯”ï¼š
é¡¾å®¢è¿›é“¶è¡Œ â†’ å–å·(åˆ›å»ºSession) â†’ å·ç ç‰Œ:A001
åŠç†ä¸šåŠ¡   â†’ ç”¨å·ç ç‰Œè¯†åˆ«èº«ä»½(ä½¿ç”¨Session)
ä¸šåŠ¡å®Œæˆ   â†’ å½’è¿˜å·ç (é”€æ¯Session)

Webåº”ç”¨åœºæ™¯ï¼š
ç”¨æˆ·ç™»å½•   â†’ æœåŠ¡å™¨åˆ›å»ºSession â†’ SessionID: abc123
è®¿é—®é¡µé¢   â†’ æºå¸¦SessionIDè¯†åˆ«ç”¨æˆ·
é€€å‡ºç™»å½•   â†’ é”€æ¯Session
```

**æ ¸å¿ƒä½œç”¨**ï¼š
- ğŸ¯ **èº«ä»½è¯†åˆ«**ï¼šæœåŠ¡å™¨é€šè¿‡SessionçŸ¥é“"ä½ æ˜¯è°"
- ğŸ¯ **çŠ¶æ€ä¿æŒ**ï¼šè®°å½•ç”¨æˆ·çš„ç™»å½•çŠ¶æ€ã€è´­ç‰©è½¦ä¿¡æ¯ç­‰
- ğŸ¯ **å®‰å…¨ä¿éšœ**ï¼šé˜²æ­¢ç”¨æˆ·è¢«å†’å……

### 1.2 Sessionçš„å·¥ä½œåŸç†


```
å®¢æˆ·ç«¯                        æœåŠ¡å™¨
  |                             |
  |--[1]é¦–æ¬¡ç™»å½•è¯·æ±‚------------>|
  |    (ç”¨æˆ·å+å¯†ç )              |
  |                             |[åˆ›å»ºSession]
  |                             |[ç”ŸæˆSessionID]
  |<--[2]è¿”å›SessionID----------|
  |    (é€šè¿‡Cookie)              |
  |                             |
  |--[3]åç»­è¯·æ±‚--------------->|
  |    (æºå¸¦SessionID)           |
  |                             |[æ ¹æ®SessionIDæŸ¥æ‰¾ç”¨æˆ·]
  |<--[4]è¿”å›å“åº”---------------|
  |                             |
```

**å…³é”®ç‚¹è¯´æ˜**ï¼š
- SessionIDé€šå¸¸å­˜åœ¨Cookieä¸­ï¼Œæ¯æ¬¡è¯·æ±‚è‡ªåŠ¨æºå¸¦
- æœåŠ¡å™¨ç»´æŠ¤ä¸€ä¸ªSessionå­˜å‚¨ï¼Œè®°å½•æ‰€æœ‰åœ¨çº¿ç”¨æˆ·
- Sessionæœ‰è¿‡æœŸæ—¶é—´ï¼Œè¶…æ—¶è‡ªåŠ¨å¤±æ•ˆ

### 1.3 ä¸ºä»€ä¹ˆéœ€è¦ä¼šè¯ç®¡ç†


**å®é™…é—®é¢˜**ï¼š
```
é—®é¢˜1ï¼šç”¨æˆ·é‡å¤ç™»å½•
- åŒä¸€è´¦å·åœ¨å¤šä¸ªè®¾å¤‡ç™»å½•
- å¯èƒ½å­˜åœ¨è´¦å·è¢«ç›—é£é™©

é—®é¢˜2ï¼šä¼šè¯åŠ«æŒ
- é»‘å®¢çªƒå–SessionID
- å†’å……ç”¨æˆ·èº«ä»½

é—®é¢˜3ï¼šèµ„æºå ç”¨
- å¤§é‡æ— æ•ˆSessionå ç”¨å†…å­˜
- å½±å“ç³»ç»Ÿæ€§èƒ½
```

**Spring Securityçš„è§£å†³æ–¹æ¡ˆ**ï¼š
- âœ… æ§åˆ¶åŒä¸€ç”¨æˆ·çš„æœ€å¤§ä¼šè¯æ•°
- âœ… é˜²æ­¢ä¼šè¯å›ºå®šæ”»å‡»
- âœ… è‡ªåŠ¨æ¸…ç†æ— æ•ˆä¼šè¯
- âœ… çµæ´»çš„ä¼šè¯åˆ›å»ºç­–ç•¥

---

## 2. âš™ï¸ ä¼šè¯åˆ›å»ºç­–ç•¥è¯¦è§£


### 2.1 SessionCreationPolicy ç­–ç•¥ç±»å‹


**å››ç§ç­–ç•¥å¯¹æ¯”**ï¼š

| ç­–ç•¥ | å«ä¹‰ | ä½¿ç”¨åœºæ™¯ | ç‰¹ç‚¹ |
|------|------|----------|------|
| `ALWAYS` | æ€»æ˜¯åˆ›å»º | ä¼ ç»ŸWebåº”ç”¨ | æ¯ä¸ªè¯·æ±‚éƒ½åˆ›å»ºSession |
| `IF_REQUIRED` | éœ€è¦æ—¶åˆ›å»º | é»˜è®¤ç­–ç•¥ | Spring Securityéœ€è¦æ—¶æ‰åˆ›å»º |
| `NEVER` | æ°¸ä¸åˆ›å»º | å‰åç«¯åˆ†ç¦» | ä¸ä¸»åŠ¨åˆ›å»ºï¼Œä½†ä¼šä½¿ç”¨å·²æœ‰çš„ |
| `STATELESS` | æ— çŠ¶æ€ | RESTful APIã€JWT | å®Œå…¨ä¸ä½¿ç”¨Session |

### 2.2 ç­–ç•¥è¯¦ç»†è¯´æ˜


#### ğŸ”¹ ALWAYS - æ€»æ˜¯åˆ›å»º


**å«ä¹‰**ï¼šæ¯æ¬¡è¯·æ±‚éƒ½åˆ›å»ºæ–°çš„Session

```java
@Configuration
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .sessionManagement(session -> session
                .sessionCreationPolicy(SessionCreationPolicy.ALWAYS)
            );
        return http.build();
    }
}
```

**é€‚ç”¨åœºæ™¯**ï¼š
- ä¼ ç»ŸJSPã€Thymeleafç­‰æœåŠ¡ç«¯æ¸²æŸ“åº”ç”¨
- éœ€è¦åœ¨Sessionä¸­å­˜å‚¨å¤§é‡æ•°æ®

**æ³¨æ„äº‹é¡¹**ï¼š
> âš ï¸ **æ€§èƒ½å½±å“**ï¼šé¢‘ç¹åˆ›å»ºSessionä¼šå ç”¨å†…å­˜ï¼Œä¸é€‚åˆé«˜å¹¶å‘åœºæ™¯

#### ğŸ”¹ IF_REQUIRED - éœ€è¦æ—¶åˆ›å»ºï¼ˆé»˜è®¤ï¼‰


**å«ä¹‰**ï¼šSpring Securityéœ€è¦æ—¶æ‰åˆ›å»ºï¼ˆæ¯”å¦‚ç™»å½•æˆåŠŸï¼‰

```java
@Bean
public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
    http
        .sessionManagement(session -> session
            // è¿™æ˜¯é»˜è®¤å€¼ï¼Œå¯ä»¥ä¸é…ç½®
            .sessionCreationPolicy(SessionCreationPolicy.IF_REQUIRED)
        );
    return http.build();
}
```

**å·¥ä½œæœºåˆ¶**ï¼š
```
è®¿é—®å…¬å¼€é¡µé¢    â†’ ä¸åˆ›å»ºSession
è¿›è¡Œç™»å½•æ“ä½œ    â†’ åˆ›å»ºSession
è®¿é—®å—ä¿æŠ¤èµ„æº  â†’ ä½¿ç”¨å·²åˆ›å»ºçš„Session
```

**æœ€ä½³å®è·µ**ï¼š
- å¤§å¤šæ•°åœºæ™¯æ¨èä½¿ç”¨
- å¹³è¡¡äº†åŠŸèƒ½å’Œæ€§èƒ½

#### ğŸ”¹ NEVER - æ°¸ä¸ä¸»åŠ¨åˆ›å»º


**å«ä¹‰**ï¼šSpring Securityè‡ªå·±ä¸åˆ›å»ºï¼Œä½†ä¼šä½¿ç”¨å·²å­˜åœ¨çš„

```java
@Bean
public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
    http
        .sessionManagement(session -> session
            .sessionCreationPolicy(SessionCreationPolicy.NEVER)
        );
    return http.build();
}
```

**åº”ç”¨åœºæ™¯**ï¼š
- å‰åç«¯åˆ†ç¦»é¡¹ç›®ï¼Œå‰ç«¯ç®¡ç†Token
- ä¸å…¶ä»–æ¡†æ¶å…±äº«Session

**æ³¨æ„åŒºåˆ«**ï¼š
```
NEVER   â†’ ä¸ä¸»åŠ¨åˆ›å»ºï¼Œä½†ä¼šç”¨åˆ«äººåˆ›å»ºçš„
STATELESS â†’ å®Œå…¨ä¸ç”¨Sessionï¼Œè¿åˆ«äººåˆ›å»ºçš„ä¹Ÿä¸ç”¨
```

#### ğŸ”¹ STATELESS - å®Œå…¨æ— çŠ¶æ€


**å«ä¹‰**ï¼šå®Œå…¨ä¸ä½¿ç”¨Sessionæœºåˆ¶

```java
@Bean
public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
    http
        .sessionManagement(session -> session
            .sessionCreationPolicy(SessionCreationPolicy.STATELESS)
        )
        .csrf(csrf -> csrf.disable()); // é€šå¸¸é…åˆç¦ç”¨CSRF
    return http.build();
}
```

**å…¸å‹åœºæ™¯ - JWTè®¤è¯**ï¼š
```
å®¢æˆ·ç«¯                    æœåŠ¡å™¨
  |                         |
  |--ç™»å½•è¯·æ±‚--------------->|
  |                         |[éªŒè¯ç”¨æˆ·åå¯†ç ]
  |<--è¿”å›JWT Token---------|[ç”ŸæˆToken]
  |                         |
  |--è¯·æ±‚(å¸¦Token)--------->|
  |   Header: Authorization |[éªŒè¯Token]
  |   Bearer eyJhbGc...     |
  |<--è¿”å›æ•°æ®--------------|
```

**ä¼˜åŠ¿**ï¼š
- âœ… æœåŠ¡å™¨ä¸ä¿å­˜çŠ¶æ€ï¼Œæ˜“äºæ‰©å±•
- âœ… é€‚åˆå¾®æœåŠ¡æ¶æ„
- âœ… è·¨åŸŸå‹å¥½

### 2.3 å¦‚ä½•é€‰æ‹©ç­–ç•¥


**å†³ç­–æµç¨‹**ï¼š
```
æ˜¯å¦æ˜¯RESTful API? 
  â””â”€æ˜¯ â†’ STATELESS (é…åˆJWT)
  â””â”€å¦ â†’ æ˜¯å¦å‰åç«¯åˆ†ç¦»?
         â””â”€æ˜¯ â†’ NEVER æˆ– STATELESS
         â””â”€å¦ â†’ IF_REQUIRED (é»˜è®¤æ¨è)
```

---

## 3. ğŸ‘¥ å¹¶å‘ä¼šè¯æ§åˆ¶


### 3.1 ä»€ä¹ˆæ˜¯å¹¶å‘ä¼šè¯æ§åˆ¶


**é—®é¢˜åœºæ™¯**ï¼š
```
å°æ˜çš„è´¦å·ï¼šzhangsan
åœºæ™¯1ï¼šå°æ˜åœ¨å…¬å¸ç”µè„‘ç™»å½•
åœºæ™¯2ï¼šå°æ˜åœ¨å®¶é‡Œç”µè„‘ä¹Ÿç™»å½•
åœºæ™¯3ï¼šå°æ˜åœ¨æ‰‹æœºä¸Šä¹Ÿç™»å½•

é—®é¢˜ï¼šåŒä¸€è´¦å·3ä¸ªåœ°æ–¹åŒæ—¶åœ¨çº¿ï¼Œæ€ä¹ˆç®¡ç†ï¼Ÿ
```

**è§£å†³æ–¹æ¡ˆ**ï¼šé™åˆ¶åŒä¸€ç”¨æˆ·çš„æœ€å¤§åœ¨çº¿ä¼šè¯æ•°

### 3.2 maximumSessions() æœ€å¤§ä¼šè¯æ•°é…ç½®


#### åŸºç¡€é…ç½®


```java
@Bean
public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
    http
        .sessionManagement(session -> session
            .maximumSessions(1)  // åŒä¸€ç”¨æˆ·æœ€å¤š1ä¸ªä¼šè¯
            .maxSessionsPreventsLogin(true)  // æ–°ç™»å½•è¸¢æ‰æ—§ä¼šè¯
        );
    return http.build();
}
```

**å‚æ•°è¯´æ˜**ï¼š
- `maximumSessions(1)` â†’ é™åˆ¶æœ€å¤š1ä¸ªåœ¨çº¿ä¼šè¯
- `maxSessionsPreventsLogin(true)` â†’ è¾¾åˆ°ä¸Šé™æ—¶çš„å¤„ç†æ–¹å¼

#### ä¸¤ç§å¤„ç†æ–¹å¼å¯¹æ¯”


**æ–¹å¼1ï¼šè¸¢æ‰æ—§ä¼šè¯ï¼ˆé»˜è®¤ï¼‰**
```java
.maximumSessions(1)
.maxSessionsPreventsLogin(false)  // é»˜è®¤å€¼
```

```
æ—¶é—´çº¿ï¼š
10:00 - å°æ˜åœ¨ç”µè„‘Aç™»å½• âœ“
10:30 - å°æ˜åœ¨ç”µè„‘Bç™»å½• âœ“
ç»“æœï¼šç”µè„‘Açš„ä¼šè¯å¤±æ•ˆï¼Œåªæœ‰ç”µè„‘Båœ¨çº¿
```

**æ–¹å¼2ï¼šé˜»æ­¢æ–°ç™»å½•**
```java
.maximumSessions(1)
.maxSessionsPreventsLogin(true)
```

```
æ—¶é—´çº¿ï¼š
10:00 - å°æ˜åœ¨ç”µè„‘Aç™»å½• âœ“
10:30 - å°æ˜åœ¨ç”µè„‘Bç™»å½• âœ— (æç¤ºï¼šå·²è¾¾åˆ°æœ€å¤§ç™»å½•æ•°)
ç»“æœï¼šç”µè„‘Aç»§ç»­åœ¨çº¿ï¼Œç”µè„‘Bæ— æ³•ç™»å½•
```

**å¦‚ä½•é€‰æ‹©**ï¼š
- è¸¢æ‰æ—§ä¼šè¯ â†’ æ–¹ä¾¿ç”¨æˆ·ï¼Œç”¨æˆ·ä½“éªŒå¥½
- é˜»æ­¢æ–°ç™»å½• â†’ å®‰å…¨æ€§é«˜ï¼Œé˜²æ­¢è´¦å·è¢«ç›—

### 3.3 è‡ªå®šä¹‰ä¼šè¯å¤±æ•ˆæç¤º


```java
@Bean
public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
    http
        .sessionManagement(session -> session
            .maximumSessions(1)
            .expiredUrl("/session-expired")  // ä¼šè¯å¤±æ•ˆè·³è½¬é¡µé¢
            .expiredSessionStrategy(event -> {
                // è‡ªå®šä¹‰å¤±æ•ˆå¤„ç†
                HttpServletResponse response = event.getResponse();
                response.setContentType("application/json;charset=UTF-8");
                response.getWriter().write(
                    "{\"code\":401,\"message\":\"æ‚¨çš„è´¦å·åœ¨å…¶ä»–åœ°æ–¹ç™»å½•,å½“å‰ä¼šè¯å·²å¤±æ•ˆ\"}"
                );
            })
        );
    return http.build();
}
```

### 3.4 å®é™…åº”ç”¨åœºæ™¯


**åœºæ™¯1ï¼šæ™®é€šç½‘ç«™ï¼ˆå…è®¸å¤šè®¾å¤‡ï¼‰**
```java
.maximumSessions(3)  // å…è®¸3ä¸ªè®¾å¤‡åŒæ—¶åœ¨çº¿
.maxSessionsPreventsLogin(false)  // æ–°è®¾å¤‡ç™»å½•è¸¢æ‰æœ€æ—©çš„
```

**åœºæ™¯2ï¼šä¼ä¸šç³»ç»Ÿï¼ˆä¸¥æ ¼æ§åˆ¶ï¼‰**
```java
.maximumSessions(1)  // åªå…è®¸1ä¸ªè®¾å¤‡
.maxSessionsPreventsLogin(true)  // ç¦æ­¢å¤šåœ°ç™»å½•
```

**åœºæ™¯3ï¼šé“¶è¡Œç³»ç»Ÿï¼ˆé«˜å®‰å…¨ï¼‰**
```java
.maximumSessions(1)
.maxSessionsPreventsLogin(true)
.expiredUrl("/security-alert")  // è·³è½¬åˆ°å®‰å…¨æç¤ºé¡µé¢
```

---

## 4. ğŸ›¡ï¸ ä¼šè¯å›ºå®šæ”»å‡»é˜²æŠ¤


### 4.1 ä»€ä¹ˆæ˜¯ä¼šè¯å›ºå®šæ”»å‡»


**æ”»å‡»åŸç†**ï¼ˆé€šä¿—è®²è§£ï¼‰ï¼š

```
æ­£å¸¸æµç¨‹ï¼š
1. ç”¨æˆ·è®¿é—®ç½‘ç«™ â†’ æœåŠ¡å™¨ç»™SessionID: ABC
2. ç”¨æˆ·ç™»å½•æˆåŠŸ â†’ æœåŠ¡å™¨æ¢æ–°SessionID: XYZ
3. ç”¨æˆ·ç»§ç»­è®¿é—® â†’ ä½¿ç”¨æ–°SessionID: XYZ

æ”»å‡»æµç¨‹ï¼š
1. é»‘å®¢è®¿é—®ç½‘ç«™ â†’ è·å¾—SessionID: ABC
2. é»‘å®¢è¯±å¯¼ç”¨æˆ·ç”¨è¿™ä¸ªSessionIDç™»å½•
3. ç”¨æˆ·ç™»å½•æˆåŠŸä½†SessionIDè¿˜æ˜¯: ABC
4. é»‘å®¢ç”¨ABCå°±èƒ½å†’å……ç”¨æˆ·ï¼
```

**å½¢è±¡æ¯”å–»**ï¼š
```
å°±åƒé»‘å®¢å…ˆæ‹¿åˆ°ä¸€ä¸ªæˆ¿é—´é’¥åŒ™(SessionID)ï¼Œ
ç„¶åéª—ä½ ç”¨è¿™ä¸ªé’¥åŒ™è¿›æˆ¿é—´ï¼Œ
ä½ ç™»å½•åï¼Œé»‘å®¢ä¹Ÿèƒ½ç”¨åŒä¸€æŠŠé’¥åŒ™è¿›æ¥ï¼
```

### 4.2 sessionFixation() é˜²æŠ¤ç­–ç•¥


Spring Securityæä¾›3ç§é˜²æŠ¤ç­–ç•¥ï¼š

| ç­–ç•¥ | è¡Œä¸º | å®‰å…¨æ€§ | ä½¿ç”¨åœºæ™¯ |
|------|------|--------|----------|
| `changeSessionId()` | ç™»å½•ååªæ”¹SessionID | é«˜ | **æ¨èä½¿ç”¨** |
| `newSession()` | ç™»å½•ååˆ›å»ºå…¨æ–°Session | æœ€é«˜ | æ•°æ®ä¸å¤šçš„åœºæ™¯ |
| `none()` | ä¸é˜²æŠ¤ | æ—  | ä»…æµ‹è¯•ç¯å¢ƒ |

#### ğŸ”¹ changeSessionIdï¼ˆæ¨èï¼‰


```java
@Bean
public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
    http
        .sessionManagement(session -> session
            .sessionFixation()
                .changeSessionId()  // ç™»å½•åæ”¹å˜SessionID
        );
    return http.build();
}
```

**å·¥ä½œåŸç†**ï¼š
```
ç™»å½•å‰ï¼šSessionID = ABC, æ•°æ® = {cartItems: [...]}
ç™»å½•åï¼šSessionID = XYZ, æ•°æ® = {cartItems: [...]}
        â†‘               â†‘
      æ”¹å˜äº†          æ•°æ®ä¿ç•™
```

**ä¼˜ç‚¹**ï¼š
- âœ… å®‰å…¨ï¼šSessionIDæ”¹å˜ï¼Œé»‘å®¢çš„SessionIDå¤±æ•ˆ
- âœ… æ–¹ä¾¿ï¼šSessionæ•°æ®ä¿ç•™ï¼Œè´­ç‰©è½¦ç­‰ä¸ä¸¢å¤±

#### ğŸ”¹ newSessionï¼ˆæœ€å®‰å…¨ï¼‰


```java
.sessionFixation()
    .newSession()  // ç™»å½•ååˆ›å»ºå…¨æ–°Session
```

**å·¥ä½œåŸç†**ï¼š
```
ç™»å½•å‰ï¼šSessionID = ABC, æ•°æ® = {cartItems: [...]}
ç™»å½•åï¼šSessionID = XYZ, æ•°æ® = {} (å…¨æ–°Session)
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- é“¶è¡Œã€æ”¯ä»˜ç­‰é«˜å®‰å…¨åœºæ™¯
- Sessionä¸­æ•°æ®ä¸é‡è¦çš„åœºæ™¯

> âš ï¸ **æ³¨æ„**ï¼šä¼šä¸¢å¤±ç™»å½•å‰çš„Sessionæ•°æ®ï¼ˆå¦‚è´­ç‰©è½¦ï¼‰

#### ğŸ”¹ noneï¼ˆä¸æ¨èï¼‰


```java
.sessionFixation()
    .none()  // ä¸é˜²æŠ¤ï¼Œä»…æµ‹è¯•ç”¨
```

**å±é™©ç¤ºä¾‹**ï¼š
```
æµ‹è¯•ç¯å¢ƒå¯èƒ½ç”¨äºè°ƒè¯•
ç”Ÿäº§ç¯å¢ƒç»å¯¹ä¸èƒ½ç”¨ï¼
```

### 4.3 é˜²æŠ¤ç­–ç•¥é€‰æ‹©å»ºè®®


```
é€‰æ‹©å†³ç­–æ ‘ï¼š
æ˜¯å¦æœ‰ç™»å½•å‰çš„é‡è¦æ•°æ®(è´­ç‰©è½¦ç­‰)?
  â””â”€æœ‰ â†’ changeSessionId()
  â””â”€æ—  â†’ æ˜¯å¦é«˜å®‰å…¨è¦æ±‚?
         â””â”€æ˜¯ â†’ newSession()
         â””â”€å¦ â†’ changeSessionId()
```

---

## 5. ğŸ“‹ ä¼šè¯æ³¨å†Œè¡¨æœºåˆ¶


### 5.1 ä»€ä¹ˆæ˜¯SessionRegistry


**é€šä¿—ç†è§£**ï¼šSessionRegistryå°±åƒä¸€ä¸ª"åœ¨çº¿ç”¨æˆ·åå†Œ"

```
ä¼ ç»Ÿæ–¹å¼ï¼š
æœåŠ¡å™¨åªçŸ¥é“æœ‰Sessionï¼Œä¸çŸ¥é“æ˜¯å“ªä¸ªç”¨æˆ·

SessionRegistryï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åœ¨çº¿ç”¨æˆ·ç®¡ç†è¡¨              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç”¨æˆ·å     SessionID   ç™»å½•æ—¶é—´ â”‚
â”‚ zhangsan   ABC123    10:00    â”‚
â”‚ lisi       XYZ789    10:30    â”‚
â”‚ wangwu     DEF456    11:00    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒä½œç”¨**ï¼š
- ğŸ¯ çŸ¥é“å“ªäº›ç”¨æˆ·åœ¨çº¿
- ğŸ¯ çŸ¥é“æ¯ä¸ªç”¨æˆ·æœ‰å‡ ä¸ªä¼šè¯
- ğŸ¯ å¯ä»¥ä¸»åŠ¨è¸¢å‡ºæŸä¸ªç”¨æˆ·

### 5.2 é…ç½®SessionRegistry


```java
@Configuration
public class SecurityConfig {
    
    @Bean
    public SessionRegistry sessionRegistry() {
        return new SessionRegistryImpl();
    }
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .sessionManagement(session -> session
                .maximumSessions(2)
                .sessionRegistry(sessionRegistry())  // æ³¨å…¥æ³¨å†Œè¡¨
            );
        return http.build();
    }
}
```

### 5.3 SessionRegistryå¸¸ç”¨åŠŸèƒ½


#### åŠŸèƒ½1ï¼šæŸ¥è¯¢åœ¨çº¿ç”¨æˆ·


```java
@RestController
public class SessionController {
    
    @Autowired
    private SessionRegistry sessionRegistry;
    
    @GetMapping("/online-users")
    public List<String> getOnlineUsers() {
        return sessionRegistry.getAllPrincipals()
            .stream()
            .map(principal -> ((User) principal).getUsername())
            .collect(Collectors.toList());
    }
}
```

**è¿”å›ç¤ºä¾‹**ï¼š
```json
["zhangsan", "lisi", "wangwu"]
```

#### åŠŸèƒ½2ï¼šæŸ¥è¯¢ç”¨æˆ·ä¼šè¯æ•°


```java
@GetMapping("/user-sessions/{username}")
public int getUserSessionCount(@PathVariable String username) {
    return sessionRegistry.getAllPrincipals()
        .stream()
        .filter(p -> ((User) p).getUsername().equals(username))
        .findFirst()
        .map(p -> sessionRegistry.getAllSessions(p, false).size())
        .orElse(0);
}
```

#### åŠŸèƒ½3ï¼šå¼ºåˆ¶è¸¢å‡ºç”¨æˆ·


```java
@PostMapping("/kick-user/{username}")
public String kickUser(@PathVariable String username) {
    sessionRegistry.getAllPrincipals()
        .stream()
        .filter(p -> ((User) p).getUsername().equals(username))
        .findFirst()
        .ifPresent(principal -> {
            // è¸¢å‡ºè¯¥ç”¨æˆ·çš„æ‰€æœ‰ä¼šè¯
            sessionRegistry.getAllSessions(principal, false)
                .forEach(SessionInformation::expireNow);
        });
    
    return "ç”¨æˆ· " + username + " å·²è¢«è¸¢å‡º";
}
```

### 5.4 å®é™…åº”ç”¨åœºæ™¯


**åœºæ™¯1ï¼šç®¡ç†å‘˜è¸¢äººåŠŸèƒ½**
```
ç®¡ç†åå°ï¼š
- æŸ¥çœ‹åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
- ç‚¹å‡»"è¸¢å‡º"æŒ‰é’®
- è°ƒç”¨ /kick-user/{username}
- è¯¥ç”¨æˆ·æ‰€æœ‰ä¼šè¯å¤±æ•ˆ
```

**åœºæ™¯2ï¼šç”¨æˆ·è‡ªåŠ©ç®¡ç†**
```
ç”¨æˆ·ä¸­å¿ƒï¼š
- æ˜¾ç¤ºå½“å‰ç™»å½•è®¾å¤‡
- ç”¨æˆ·å¯ä»¥è¸¢å‡ºå…¶ä»–è®¾å¤‡
- ä¿æŠ¤è´¦å·å®‰å…¨
```

**åœºæ™¯3ï¼šç³»ç»Ÿç›‘æ§**
```
è¿ç»´ç›‘æ§ï¼š
- å®æ—¶åœ¨çº¿ç”¨æˆ·æ•°
- æ¯ä¸ªç”¨æˆ·çš„ä¼šè¯æ•°
- å¼‚å¸¸ç™»å½•å‘Šè­¦
```

---

## 6. ğŸ¯ å®æˆ˜åº”ç”¨åœºæ™¯


### 6.1 åœºæ™¯1ï¼šä¼ä¸šOAç³»ç»Ÿ


**éœ€æ±‚**ï¼š
- åŒä¸€è´¦å·åªèƒ½1ä¸ªè®¾å¤‡ç™»å½•
- å¼‚åœ°ç™»å½•éœ€è¦è¸¢æ‰åŸè®¾å¤‡
- æ˜¾ç¤ºç™»å½•æç¤º

**é…ç½®æ–¹æ¡ˆ**ï¼š
```java
@Bean
public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
    http
        .sessionManagement(session -> session
            // ä¼šè¯ç­–ç•¥
            .sessionCreationPolicy(SessionCreationPolicy.IF_REQUIRED)
            
            // å¹¶å‘æ§åˆ¶
            .maximumSessions(1)
            .maxSessionsPreventsLogin(false)  // æ–°ç™»å½•è¸¢æ‰æ—§çš„
            
            // ä¼šè¯å›ºå®šé˜²æŠ¤
            .sessionFixation()
                .changeSessionId()
            
            // å¤±æ•ˆæç¤º
            .expiredSessionStrategy(event -> {
                event.getResponse().setContentType("application/json;charset=UTF-8");
                event.getResponse().getWriter().write(
                    "{\"message\":\"æ‚¨çš„è´¦å·åœ¨å…¶ä»–è®¾å¤‡ç™»å½•ï¼Œå½“å‰ä¼šè¯å·²å¤±æ•ˆ\"}"
                );
            })
        )
        // æ— æ•ˆä¼šè¯è·³è½¬
        .sessionManagement(session -> session
            .invalidSessionUrl("/login?expired=true")
        );
    return http.build();
}
```

### 6.2 åœºæ™¯2ï¼šåœ¨çº¿æ•™è‚²å¹³å°


**éœ€æ±‚**ï¼š
- å…è®¸3ä¸ªè®¾å¤‡åŒæ—¶å­¦ä¹ 
- ç™»å½•åä¿ç•™å­¦ä¹ è¿›åº¦
- è¶…è¿‡3ä¸ªè®¾å¤‡è¸¢æ‰æœ€æ—©çš„

**é…ç½®æ–¹æ¡ˆ**ï¼š
```java
@Bean
public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
    http
        .sessionManagement(session -> session
            .sessionCreationPolicy(SessionCreationPolicy.IF_REQUIRED)
            .maximumSessions(3)  // æœ€å¤š3ä¸ªè®¾å¤‡
            .maxSessionsPreventsLogin(false)  // è¸¢æ‰æœ€æ—©çš„
            .sessionRegistry(sessionRegistry())
        )
        .sessionManagement(session -> session
            .sessionFixation()
                .changeSessionId()  // ä¿ç•™å­¦ä¹ è¿›åº¦
        );
    return http.build();
}
```

### 6.3 åœºæ™¯3ï¼šRESTful APIæœåŠ¡


**éœ€æ±‚**ï¼š
- æ— çŠ¶æ€APIè®¾è®¡
- ä½¿ç”¨JWT Token
- ä¸ä½¿ç”¨Session

**é…ç½®æ–¹æ¡ˆ**ï¼š
```java
@Bean
public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
    http
        .sessionManagement(session -> session
            .sessionCreationPolicy(SessionCreationPolicy.STATELESS)  // æ— çŠ¶æ€
        )
        .csrf(csrf -> csrf.disable())  // ç¦ç”¨CSRF
        .addFilterBefore(jwtFilter, UsernamePasswordAuthenticationFilter.class);
    
    return http.build();
}
```

### 6.4 åœºæ™¯4ï¼šé“¶è¡Œç³»ç»Ÿ


**éœ€æ±‚**ï¼š
- ä¸¥æ ¼å•è®¾å¤‡ç™»å½•
- ç¦æ­¢å¤šåœ°ç™»å½•
- é«˜å®‰å…¨é˜²æŠ¤

**é…ç½®æ–¹æ¡ˆ**ï¼š
```java
@Bean
public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
    http
        .sessionManagement(session -> session
            .maximumSessions(1)
            .maxSessionsPreventsLogin(true)  // ç¦æ­¢æ–°ç™»å½•
            .sessionRegistry(sessionRegistry())
        )
        .sessionManagement(session -> session
            .sessionFixation()
                .newSession()  // æœ€é«˜å®‰å…¨é˜²æŠ¤
            .invalidSessionUrl("/security/session-invalid")
        );
    return http.build();
}
```

---

## 7. ğŸ“ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Sessionæœ¬è´¨ï¼šæœåŠ¡å™¨è¯†åˆ«ç”¨æˆ·çš„"èº«ä»½è¯"
ğŸ”¸ ä¼šè¯åˆ›å»ºç­–ç•¥ï¼š4ç§ç­–ç•¥åº”å¯¹ä¸åŒåœºæ™¯
ğŸ”¸ å¹¶å‘ä¼šè¯æ§åˆ¶ï¼šé™åˆ¶åŒä¸€ç”¨æˆ·çš„ç™»å½•è®¾å¤‡æ•°
ğŸ”¸ ä¼šè¯å›ºå®šé˜²æŠ¤ï¼šé˜²æ­¢SessionIDè¢«é»‘å®¢åˆ©ç”¨
ğŸ”¸ SessionRegistryï¼šç®¡ç†åœ¨çº¿ç”¨æˆ·çš„"åå†Œ"
```

### 7.2 å…³é”®é…ç½®å†³ç­–


**ğŸ”¹ ä¼šè¯ç­–ç•¥é€‰æ‹©**
```
ä¼ ç»ŸWebåº”ç”¨   â†’ IF_REQUIRED (é»˜è®¤)
å‰åç«¯åˆ†ç¦»    â†’ NEVER æˆ– STATELESS  
RESTful API  â†’ STATELESS (é…åˆJWT)
```

**ğŸ”¹ å¹¶å‘æ§åˆ¶é€‰æ‹©**
```
ç”¨æˆ·ä½“éªŒä¼˜å…ˆ  â†’ maxSessionsPreventsLogin(false)
å®‰å…¨æ€§ä¼˜å…ˆ    â†’ maxSessionsPreventsLogin(true)
```

**ğŸ”¹ å›ºå®šæ”»å‡»é˜²æŠ¤**
```
æœ‰Sessionæ•°æ® â†’ changeSessionId()
é«˜å®‰å…¨è¦æ±‚    â†’ newSession()
```

### 7.3 å®æˆ˜æœ€ä½³å®è·µ


**ğŸ¯ å…¸å‹é…ç½®æ¨¡æ¿**
```java
// é€‚åˆå¤§å¤šæ•°ä¸šåŠ¡ç³»ç»Ÿçš„é…ç½®
@Bean
public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
    return http
        .sessionManagement(session -> session
            .sessionCreationPolicy(SessionCreationPolicy.IF_REQUIRED)
            .maximumSessions(2)
            .maxSessionsPreventsLogin(false)
            .sessionRegistry(sessionRegistry())
            .expiredSessionStrategy(customExpiredStrategy())
        )
        .sessionManagement(session -> session
            .sessionFixation().changeSessionId()
            .invalidSessionUrl("/login?invalid=true")
        )
        .build();
}
```

### 7.4 å¸¸è§é—®é¢˜è§£å†³


| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| Sessionä¸¢å¤± | ç­–ç•¥è®¾ç½®ä¸ºSTATELESS | æ”¹ä¸ºIF_REQUIRED |
| æ— æ³•å¤šè®¾å¤‡ç™»å½• | maximumSessionsè®¾ç½®è¿‡å° | å¢å¤§æœ€å¤§ä¼šè¯æ•° |
| ç™»å½•åæ•°æ®ä¸¢å¤± | ä½¿ç”¨äº†newSession() | æ”¹ç”¨changeSessionId() |
| ä¼šè¯ä¸€ç›´æ— æ•ˆ | invalidSessionUrlé…ç½®é”™è¯¯ | æ£€æŸ¥URLé…ç½® |

### 7.5 å®‰å…¨æ³¨æ„äº‹é¡¹


> âš ï¸ **ç”Ÿäº§ç¯å¢ƒå¿…é¡»**ï¼š
> - å¯ç”¨ä¼šè¯å›ºå®šé˜²æŠ¤
> - é…ç½®åˆç†çš„æœ€å¤§ä¼šè¯æ•°
> - è®¾ç½®ä¼šè¯è¶…æ—¶æ—¶é—´
> - ä½¿ç”¨HTTPSä¼ è¾“SessionID

> ğŸ’¡ **æ€§èƒ½ä¼˜åŒ–å»ºè®®**ï¼š
> - é¿å…åœ¨Sessionå­˜å‚¨å¤§å¯¹è±¡
> - å®šæœŸæ¸…ç†è¿‡æœŸSession
> - ä½¿ç”¨Redisç­‰å¤–éƒ¨å­˜å‚¨
> - ç›‘æ§Sessionæ•°é‡

### 7.6 æ ¸å¿ƒè®°å¿†å£è¯€


```
ä¼šè¯ç®¡ç†å››ç­–ç•¥ï¼ŒæŒ‰éœ€é€‰æ‹©ä¸è¿·ç³Š
å¹¶å‘æ§åˆ¶é˜²å¤šç™»ï¼Œè¸¢æ—§é˜»æ–°ä¸¤æ¡è·¯  
å›ºå®šæ”»å‡»è¦é˜²èŒƒï¼Œæ”¹IDåˆ›æ–°çœ‹åœºæ™¯
æ³¨å†Œè¡¨é‡Œç®¡åœ¨çº¿ï¼Œè¸¢äººæŸ¥è¯¢å…¨æå®š
```

**å…³é”®ç†è§£**ï¼š
- Sessionæ˜¯ç”¨æˆ·çš„"èº«ä»½è¯"ï¼ŒæœåŠ¡å™¨ç”¨å®ƒè¯†åˆ«ç”¨æˆ·
- ä¸åŒåœºæ™¯ç”¨ä¸åŒç­–ç•¥ï¼Œæ²¡æœ‰æœ€å¥½åªæœ‰æœ€åˆé€‚
- å®‰å…¨å’Œä½“éªŒè¦å¹³è¡¡ï¼Œæ ¹æ®ä¸šåŠ¡éœ€æ±‚åšå–èˆ
- SessionRegistryè®©æˆ‘ä»¬èƒ½ä¸»åŠ¨ç®¡ç†åœ¨çº¿ç”¨æˆ·