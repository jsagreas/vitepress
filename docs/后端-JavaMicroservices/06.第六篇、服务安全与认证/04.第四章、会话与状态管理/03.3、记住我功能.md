---
title: 3ã€è®°ä½æˆ‘åŠŸèƒ½
---
## ğŸ“š ç›®å½•

1. [è®°ä½æˆ‘åŠŸèƒ½æ¦‚è¿°](#1-è®°ä½æˆ‘åŠŸèƒ½æ¦‚è¿°)
2. [å·¥ä½œåŸç†è¯¦è§£](#2-å·¥ä½œåŸç†è¯¦è§£)
3. [åŸºäºä»¤ç‰Œçš„è®°ä½æˆ‘](#3-åŸºäºä»¤ç‰Œçš„è®°ä½æˆ‘)
4. [æŒä¹…åŒ–ä»¤ç‰Œæ–¹æ¡ˆ](#4-æŒä¹…åŒ–ä»¤ç‰Œæ–¹æ¡ˆ)
5. [æ ¸å¿ƒé…ç½®è¯¦è§£](#5-æ ¸å¿ƒé…ç½®è¯¦è§£)
6. [å®‰å…¨æ€§è€ƒè™‘](#6-å®‰å…¨æ€§è€ƒè™‘)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” è®°ä½æˆ‘åŠŸèƒ½æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯è®°ä½æˆ‘åŠŸèƒ½


**é€šä¿—ç†è§£**ï¼š
æƒ³è±¡ä½ æ¯å¤©éƒ½è¦ç™»å½•æŸä¸ªç½‘ç«™ï¼Œå¦‚æœæ¯æ¬¡éƒ½è¦è¾“å…¥è´¦å·å¯†ç å¾ˆéº»çƒ¦ã€‚"è®°ä½æˆ‘"åŠŸèƒ½å°±åƒæ˜¯ç»™ä½ å‘äº†ä¸€å¼ **ä¸´æ—¶é€šè¡Œè¯**ï¼Œä¸‹æ¬¡è®¿é—®æ—¶ä¸ç”¨å†ç™»å½•ï¼Œç›´æ¥å°±èƒ½è¿›å»ã€‚

```
æ™®é€šç™»å½•æµç¨‹ï¼š
ç”¨æˆ·è®¿é—® â†’ è¾“å…¥è´¦å·å¯†ç  â†’ éªŒè¯æˆåŠŸ â†’ è¿›å…¥ç³»ç»Ÿ
â†“ å…³é—­æµè§ˆå™¨
ä¸‹æ¬¡è®¿é—® â†’ åˆè¦é‡æ–°è¾“å…¥è´¦å·å¯†ç  ğŸ˜«

å¯ç”¨"è®°ä½æˆ‘"åï¼š
ç”¨æˆ·è®¿é—® â†’ è¾“å…¥è´¦å·å¯†ç  â†’ âœ…å‹¾é€‰"è®°ä½æˆ‘" â†’ è¿›å…¥ç³»ç»Ÿ
â†“ å…³é—­æµè§ˆå™¨
ä¸‹æ¬¡è®¿é—® â†’ è‡ªåŠ¨ç™»å½• â†’ ç›´æ¥è¿›å…¥ ğŸ˜Š
```

**æ ¸å¿ƒä½œç”¨**ï¼š
- âœ… æå‡ç”¨æˆ·ä½“éªŒï¼Œæ— éœ€é¢‘ç¹ç™»å½•
- âœ… åœ¨å®‰å…¨æ€§å’Œä¾¿æ·æ€§ä¹‹é—´æ‰¾å¹³è¡¡
- âœ… é€‚åˆä¸ªäººè®¾å¤‡ä¸Šçš„é•¿æœŸè®¿é—®

### 1.2 åº”ç”¨åœºæ™¯


**é€‚ç”¨åœºæ™¯** â­ï¼š
```
ğŸ“± ä¸ªäººè®¾å¤‡
â€¢ è‡ªå·±çš„ç”µè„‘æˆ–æ‰‹æœº
â€¢ å®¶åº­ç½‘ç»œç¯å¢ƒ
â€¢ å¯ä¿¡ä»»çš„è®¾å¤‡

ğŸ  é•¿æœŸä½¿ç”¨
â€¢ è´­ç‰©ç½‘ç«™ï¼ˆäº¬ä¸œã€æ·˜å®ï¼‰
â€¢ ç¤¾äº¤å¹³å°ï¼ˆå¾®ä¿¡ç½‘é¡µç‰ˆï¼‰
â€¢ å†…å®¹å¹³å°ï¼ˆBç«™ã€çŸ¥ä¹ï¼‰
```

**ä¸é€‚ç”¨åœºæ™¯** âš ï¸ï¼š
```
ğŸš« å…¬å…±è®¾å¤‡
â€¢ ç½‘å§ã€å›¾ä¹¦é¦†çš„ç”µè„‘
â€¢ å…¬å¸çš„å…±äº«è®¾å¤‡
â€¢ ä»–äººçš„æ‰‹æœº

ğŸš« é«˜å®‰å…¨è¦æ±‚
â€¢ ç½‘é“¶ç³»ç»Ÿ
â€¢ æ”¯ä»˜å¹³å°
â€¢ ä¼ä¸šæ ¸å¿ƒç³»ç»Ÿ
```

---

## 2. âš™ï¸ å·¥ä½œåŸç†è¯¦è§£


### 2.1 åŸºæœ¬æµç¨‹å›¾ç¤º


```
ã€ç”¨æˆ·ç™»å½•æµç¨‹ã€‘

ç”¨æˆ·æµè§ˆå™¨                    Spring SecurityæœåŠ¡å™¨
    |                              |
    |--[1]POSTç™»å½•è¡¨å•------------->|
    |   username=admin             | [éªŒè¯ç”¨æˆ·åå¯†ç ]
    |   password=123               |
    |   remember-me=true           | [æ£€æŸ¥remember-meå‚æ•°]
    |                              |
    |<-[2]è¿”å›å“åº”-------------------|
    |   Set-Cookie: remember-me=   | [ç”Ÿæˆè®°ä½æˆ‘ä»¤ç‰Œ]
    |   xxxToken...                | [ä¿å­˜åˆ°Cookie]
    |                              |

ã€ä¸‹æ¬¡è®¿é—®æµç¨‹ã€‘

    |--[3]æºå¸¦Cookieè®¿é—®----------->|
    |   Cookie: remember-me=       | [è¯»å–Cookieä¸­çš„ä»¤ç‰Œ]
    |   xxxToken...                |
    |                              | [éªŒè¯ä»¤ç‰Œæœ‰æ•ˆæ€§]
    |                              | [è‡ªåŠ¨ç™»å½•ç”¨æˆ·]
    |<-[4]è¿”å›é¡µé¢å†…å®¹---------------|
    |   (å·²ç™»å½•çŠ¶æ€)               |
```

### 2.2 æ ¸å¿ƒåŸç†è¯´æ˜


**è®°ä½æˆ‘çš„æœ¬è´¨**ï¼š
> ğŸ’¡ è®°ä½æˆ‘åŠŸèƒ½æœ¬è´¨ä¸Šæ˜¯ç”¨**ä¸€ä¸ªç‰¹æ®Šçš„ä»¤ç‰Œ(Token)**ä»£æ›¿ç”¨æˆ·çš„è´¦å·å¯†ç ï¼Œè¿™ä¸ªä»¤ç‰Œå­˜å‚¨åœ¨æµè§ˆå™¨Cookieä¸­ã€‚

**å·¥ä½œæ­¥éª¤**ï¼š

**ç¬¬1æ­¥ - ç”¨æˆ·ç™»å½•**ï¼š
```
1. ç”¨æˆ·è¾“å…¥è´¦å·å¯†ç ï¼Œå‹¾é€‰"è®°ä½æˆ‘"
2. Spring SecurityéªŒè¯è´¦å·å¯†ç æ­£ç¡®
3. ç”Ÿæˆä¸€ä¸ªåŠ å¯†çš„ä»¤ç‰Œ(Token)
4. å°†ä»¤ç‰Œå­˜å…¥æµè§ˆå™¨Cookie
```

**ç¬¬2æ­¥ - ä¸‹æ¬¡è®¿é—®**ï¼š
```
1. æµè§ˆå™¨è‡ªåŠ¨æºå¸¦Cookieä¸­çš„ä»¤ç‰Œ
2. Spring Securityè¯»å–å¹¶éªŒè¯ä»¤ç‰Œ
3. ä»¤ç‰Œæœ‰æ•ˆâ†’è‡ªåŠ¨ç™»å½•ç”¨æˆ·
4. ä»¤ç‰Œæ— æ•ˆâ†’è·³è½¬åˆ°ç™»å½•é¡µ
```

### 2.3 ä»¤ç‰Œçš„ç»„æˆ


**åŸºæœ¬ä»¤ç‰Œæ ¼å¼**ï¼š
```
ä»¤ç‰Œ = Base64(username + ":" + expiryTime + ":" + MD5(username + ":" + expiryTime + ":" + password + ":" + key))

é€šä¿—è§£é‡Šï¼š
â€¢ usernameï¼šç”¨æˆ·å
â€¢ expiryTimeï¼šè¿‡æœŸæ—¶é—´æˆ³
â€¢ passwordï¼šç”¨æˆ·å¯†ç 
â€¢ keyï¼šç³»ç»Ÿå¯†é’¥ï¼ˆé˜²æ­¢ä¼ªé€ ï¼‰
â€¢ MD5ï¼šåŠ å¯†ç®—æ³•ï¼ˆé˜²æ­¢ç¯¡æ”¹ï¼‰

å®é™…ä»¤ç‰Œç¤ºä¾‹ï¼š
YWRtaW46MTY5NTEyMzQ1Njc4OTplYjI3YzU5YWE0ZDk4ZGZiNTZjOTg3ZTRmYWI1ZDNjNg==
```

---

## 3. ğŸ¯ åŸºäºä»¤ç‰Œçš„è®°ä½æˆ‘


### 3.1 å¿«é€Ÿé…ç½®


**æœ€ç®€å•çš„é…ç½®æ–¹å¼**ï¼š

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(auth -> auth
                .anyRequest().authenticated()
            )
            .formLogin(form -> form
                .loginPage("/login")
                .permitAll()
            )
            // å¯ç”¨è®°ä½æˆ‘åŠŸèƒ½
            .rememberMe(remember -> remember
                .key("mySecretKey")  // å¯†é’¥ï¼Œç”¨äºåŠ å¯†ä»¤ç‰Œ
            );
        
        return http.build();
    }
}
```

**å¯¹åº”çš„ç™»å½•é¡µé¢**ï¼š

```html
<form action="/login" method="post">
    <input type="text" name="username" placeholder="ç”¨æˆ·å">
    <input type="password" name="password" placeholder="å¯†ç ">
    
    <!-- è®°ä½æˆ‘å¤é€‰æ¡† -->
    <label>
        <input type="checkbox" name="remember-me"> è®°ä½æˆ‘
    </label>
    
    <button type="submit">ç™»å½•</button>
</form>
```

### 3.2 æ ¸å¿ƒå‚æ•°é…ç½®


**rememberMeParameter()** - è‡ªå®šä¹‰å‚æ•°åï¼š

```java
.rememberMe(remember -> remember
    .rememberMeParameter("remember-login")  // é»˜è®¤æ˜¯"remember-me"
)
```

```html
<!-- å¯¹åº”çš„HTMLéœ€è¦åŒæ­¥ä¿®æ”¹ -->
<input type="checkbox" name="remember-login"> è®°ä½æˆ‘
```

**tokenValiditySeconds()** - è®¾ç½®æœ‰æ•ˆæœŸï¼š

```java
.rememberMe(remember -> remember
    .tokenValiditySeconds(7 * 24 * 60 * 60)  // 7å¤©ï¼ˆå•ä½ï¼šç§’ï¼‰
)
```

| æ—¶é•¿ | ç§’æ•° | é€‚ç”¨åœºæ™¯ |
|------|------|---------|
| **1å¤©** | `86400` | æµ‹è¯•ç¯å¢ƒ |
| **7å¤©** | `604800` | ä¸ªäººè®¾å¤‡ â­ |
| **14å¤©** | `1209600` | é•¿æœŸä½¿ç”¨ |
| **30å¤©** | `2592000` | ä½é£é™©åº”ç”¨ |

**key()** - è®¾ç½®åŠ å¯†å¯†é’¥ï¼š

```java
.rememberMe(remember -> remember
    .key("my-secure-secret-key-2024")  // å»ºè®®ä½¿ç”¨å¤æ‚å¯†é’¥
)
```

> âš ï¸ **é‡è¦æé†’**ï¼šå¯†é’¥ä¸€æ—¦ä¿®æ”¹ï¼Œæ‰€æœ‰æ—§ä»¤ç‰Œç«‹å³å¤±æ•ˆï¼

### 3.3 å®Œæ•´é…ç½®ç¤ºä¾‹


```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/public/**").permitAll()
                .anyRequest().authenticated()
            )
            .formLogin(form -> form
                .loginPage("/login")
                .permitAll()
            )
            .rememberMe(remember -> remember
                .key("mySecretKey2024")           // åŠ å¯†å¯†é’¥
                .tokenValiditySeconds(604800)     // 7å¤©æœ‰æ•ˆæœŸ
                .rememberMeParameter("remember")  // å‚æ•°å
                .rememberMeCookieName("app-remember")  // Cookieåç§°
            );
        
        return http.build();
    }
}
```

---

## 4. ğŸ’¾ æŒä¹…åŒ–ä»¤ç‰Œæ–¹æ¡ˆ


### 4.1 ä¸ºä»€ä¹ˆéœ€è¦æŒä¹…åŒ–


**åŸºäºä»¤ç‰Œçš„é—®é¢˜**ï¼š

```
é—®é¢˜1ï¼šå¯†ç ä¿®æ”¹ä»¤ç‰Œå¤±æ•ˆ
ç”¨æˆ·ä¿®æ”¹å¯†ç  â†’ ä»¤ç‰Œä¸­åŒ…å«æ—§å¯†ç çš„MD5 â†’ éªŒè¯å¤±è´¥ â†’ è¢«è¿«é‡æ–°ç™»å½•

é—®é¢˜2ï¼šå®‰å…¨æ€§ä¸è¶³
ä»¤ç‰Œä¸€æ—¦æ³„éœ² â†’ å¯ä»¥ä¸€ç›´ä½¿ç”¨ç›´åˆ°è¿‡æœŸ â†’ æ— æ³•ä¸»åŠ¨æ’¤é”€

é—®é¢˜3ï¼šæ— æ³•ç®¡ç†
ç®¡ç†å‘˜æ— æ³•æŸ¥çœ‹å“ªäº›ç”¨æˆ·ä½¿ç”¨äº†è®°ä½æˆ‘
æ— æ³•æ‰¹é‡æ¸…é™¤æ‰€æœ‰è®°ä½æˆ‘ä»¤ç‰Œ
```

**æŒä¹…åŒ–ä»¤ç‰Œçš„ä¼˜åŠ¿**ï¼š
- âœ… ä»¤ç‰Œå­˜å‚¨åœ¨æ•°æ®åº“ï¼Œå¯ä»¥ç®¡ç†
- âœ… æ”¯æŒä»¤ç‰Œåˆ·æ–°æœºåˆ¶
- âœ… å¯ä»¥ä¸»åŠ¨æ’¤é”€ä»¤ç‰Œ
- âœ… å¯†ç ä¿®æ”¹ä¸å½±å“è®°ä½æˆ‘

### 4.2 æ•°æ®åº“è¡¨ç»“æ„


**åˆ›å»ºä»¤ç‰Œè¡¨**ï¼š

```sql
-- MySQLæ•°æ®åº“
CREATE TABLE persistent_logins (
    username VARCHAR(64) NOT NULL,      -- ç”¨æˆ·å
    series VARCHAR(64) PRIMARY KEY,     -- ç³»åˆ—æ ‡è¯†ï¼ˆå”¯ä¸€ï¼‰
    token VARCHAR(64) NOT NULL,         -- ä»¤ç‰Œå€¼
    last_used TIMESTAMP NOT NULL        -- æœ€åä½¿ç”¨æ—¶é—´
);

-- æ·»åŠ ç´¢å¼•æå‡æŸ¥è¯¢æ€§èƒ½
CREATE INDEX idx_username ON persistent_logins(username);
```

**å­—æ®µè¯´æ˜**ï¼š

| å­—æ®µ | è¯´æ˜ | ç¤ºä¾‹å€¼ |
|------|------|--------|
| **username** | ç”¨æˆ·å | `admin` |
| **series** | ç³»åˆ—æ ‡è¯†ï¼Œç™»å½•æ—¶ç”Ÿæˆï¼Œä¸å˜ | `a1b2c3d4...` |
| **token** | ä»¤ç‰Œå€¼ï¼Œæ¯æ¬¡ä½¿ç”¨ååˆ·æ–° | `x9y8z7w6...` |
| **last_used** | æœ€åä½¿ç”¨æ—¶é—´ | `2024-09-23 10:30:00` |

### 4.3 æŒä¹…åŒ–é…ç½®


**å®Œæ•´é…ç½®ä»£ç **ï¼š

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Autowired
    private DataSource dataSource;  // æ•°æ®æº
    
    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(auth -> auth
                .anyRequest().authenticated()
            )
            .formLogin(form -> form
                .loginPage("/login")
                .permitAll()
            )
            .rememberMe(remember -> remember
                .tokenRepository(persistentTokenRepository())  // ä½¿ç”¨æŒä¹…åŒ–
                .tokenValiditySeconds(604800)  // 7å¤©
            );
        
        return http.build();
    }
    
    // é…ç½®æŒä¹…åŒ–ä»¤ç‰Œå­˜å‚¨
    @Bean
    public PersistentTokenRepository persistentTokenRepository() {
        JdbcTokenRepositoryImpl tokenRepository = new JdbcTokenRepositoryImpl();
        tokenRepository.setDataSource(dataSource);
        // tokenRepository.setCreateTableOnStartup(true);  // é¦–æ¬¡è¿è¡Œå¯è‡ªåŠ¨å»ºè¡¨
        return tokenRepository;
    }
}
```

### 4.4 åˆ·æ–°æœºåˆ¶åŸç†


```
ã€æŒä¹…åŒ–ä»¤ç‰Œåˆ·æ–°æµç¨‹ã€‘

ç¬¬1æ¬¡ç™»å½•ï¼š
1. ç”Ÿæˆ series = "ABC123"ï¼ˆå›ºå®šä¸å˜ï¼‰
2. ç”Ÿæˆ token = "XYZ789"
3. å­˜å…¥æ•°æ®åº“å’ŒCookie

ç¬¬2æ¬¡è®¿é—®ï¼š
1. è¯»å–Cookieä¸­çš„ series å’Œ token
2. éªŒè¯serieså’Œtokenæ˜¯å¦åŒ¹é…
3. âœ… åŒ¹é…æˆåŠŸï¼š
   - ç”Ÿæˆæ–°token = "LMN456"ï¼ˆæ—§tokenä½œåºŸï¼‰
   - æ›´æ–°æ•°æ®åº“ä¸­çš„token
   - æ›´æ–°Cookieä¸­çš„token
   - ç”¨æˆ·æ­£å¸¸è®¿é—®

4. âŒ seriesåŒ¹é…ä½†tokenä¸åŒ¹é…ï¼š
   - å¯èƒ½æ˜¯ä»¤ç‰Œè¢«ç›—ç”¨
   - åˆ é™¤è¯¥ç”¨æˆ·æ‰€æœ‰remember-meä»¤ç‰Œ
   - å¼ºåˆ¶é‡æ–°ç™»å½•
```

**å®‰å…¨æœºåˆ¶**ï¼š
> ğŸ’¡ æ¯æ¬¡ä½¿ç”¨ä»¤ç‰Œåéƒ½ä¼šç”Ÿæˆæ–°ä»¤ç‰Œï¼Œå¦‚æœåŒä¸€ä¸ªserieså‡ºç°ä¸¤ä¸ªä¸åŒtokenï¼Œè¯´æ˜ä»¤ç‰Œå¯èƒ½è¢«ç›—ç”¨ï¼Œç³»ç»Ÿä¼šç«‹å³æ’¤é”€æ‰€æœ‰è¯¥ç”¨æˆ·çš„è®°ä½æˆ‘ä»¤ç‰Œã€‚

---

## 5. ğŸ”§ æ ¸å¿ƒé…ç½®è¯¦è§£


### 5.1 rememberMeServices() è‡ªå®šä¹‰æœåŠ¡


**ä»€ä¹ˆæ—¶å€™éœ€è¦è‡ªå®šä¹‰**ï¼š
- éœ€è¦è‡ªå®šä¹‰ä»¤ç‰Œç”Ÿæˆé€»è¾‘
- éœ€è¦æ·»åŠ é¢å¤–çš„å®‰å…¨éªŒè¯
- éœ€è¦è®°å½•è®°ä½æˆ‘çš„ä½¿ç”¨æ—¥å¿—

**è‡ªå®šä¹‰æœåŠ¡ç¤ºä¾‹**ï¼š

```java
@Bean
public RememberMeServices rememberMeServices() {
    // åˆ›å»ºæŒä¹…åŒ–ä»¤ç‰ŒæœåŠ¡
    PersistentTokenBasedRememberMeServices services = 
        new PersistentTokenBasedRememberMeServices(
            "mySecretKey",                    // å¯†é’¥
            userDetailsService,               // ç”¨æˆ·æœåŠ¡
            persistentTokenRepository()       // ä»¤ç‰Œå­˜å‚¨
        );
    
    // è‡ªå®šä¹‰é…ç½®
    services.setParameter("remember");        // å‚æ•°å
    services.setTokenValiditySeconds(604800); // æœ‰æ•ˆæœŸ
    services.setAlwaysRemember(false);        // æ˜¯å¦æ€»æ˜¯è®°ä½
    
    return services;
}
```

**åœ¨SecurityConfigä¸­ä½¿ç”¨**ï¼š

```java
.rememberMe(remember -> remember
    .rememberMeServices(rememberMeServices())
)
```

### 5.2 å¸¸ç”¨é…ç½®æ–¹æ³•å¯¹ç…§è¡¨


| æ–¹æ³• | è¯´æ˜ | ç¤ºä¾‹å€¼ | é»˜è®¤å€¼ |
|------|------|--------|--------|
| **key()** | åŠ å¯†å¯†é’¥ | `"myKey123"` | éšæœºç”Ÿæˆ |
| **tokenValiditySeconds()** | ä»¤ç‰Œæœ‰æ•ˆæœŸ(ç§’) | `604800` | 2å‘¨ |
| **rememberMeParameter()** | è¡¨å•å‚æ•°å | `"remember"` | `"remember-me"` |
| **rememberMeCookieName()** | Cookieåç§° | `"app-token"` | `"remember-me"` |
| **tokenRepository()** | ä»¤ç‰Œå­˜å‚¨æ–¹å¼ | æŒä¹…åŒ–/å†…å­˜ | å†…å­˜ |
| **alwaysRemember()** | æ€»æ˜¯è®°ä½ | `true/false` | `false` |
| **useSecureCookie()** | ä»…HTTPS | `true/false` | `false` |

### 5.3 é…ç½®æœ€ä½³å®è·µ


**ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®**ï¼š

```java
.rememberMe(remember -> remember
    // å®‰å…¨è®¾ç½®
    .key("complex-secret-key-2024")       // ä½¿ç”¨å¤æ‚å¯†é’¥
    .useSecureCookie(true)                // ä»…HTTPSä¼ è¾“
    
    // åŠŸèƒ½è®¾ç½®
    .tokenRepository(persistentTokenRepository())  // æŒä¹…åŒ–å­˜å‚¨
    .tokenValiditySeconds(7 * 24 * 60 * 60)       // 7å¤©æœ‰æ•ˆ
    
    // è‡ªå®šä¹‰è®¾ç½®
    .rememberMeParameter("remember-login")
    .rememberMeCookieName("app-remember-token")
    
    // ç”¨æˆ·æœåŠ¡
    .userDetailsService(userDetailsService)
)
```

---

## 6. ğŸ›¡ï¸ å®‰å…¨æ€§è€ƒè™‘


### 6.1 ä¸»è¦å®‰å…¨é£é™©


**é£é™©æ¸…å•**ï¼š

```
ğŸ”´ é«˜é£é™©åœºæ™¯

é£é™©1ï¼šCookieè¢«ç›—
æ”»å‡»è€…è·å–Cookie â†’ ä¼ªè£…æˆç”¨æˆ·è®¿é—® â†’ ä¿¡æ¯æ³„éœ²

é£é™©2ï¼šå…¬å…±è®¾å¤‡
å¿˜è®°é€€å‡º â†’ ä»–äººç›´æ¥è®¿é—® â†’ éšç§æš´éœ²

é£é™©3ï¼šä¸­é—´äººæ”»å‡»
HTTPä¼ è¾“ â†’ Cookieè¢«æˆªè· â†’ è´¦å·è¢«ç›—

é£é™©4ï¼šXSSæ”»å‡»
æ¶æ„è„šæœ¬ â†’ è¯»å–Cookie â†’ å‘é€ç»™æ”»å‡»è€…
```

### 6.2 å®‰å…¨é˜²æŠ¤æªæ–½


**æªæ–½1ï¼šä½¿ç”¨HTTPS** â­â­â­

```java
.rememberMe(remember -> remember
    .useSecureCookie(true)  // Cookieä»…åœ¨HTTPSä¸‹ä¼ è¾“
)
```

**æªæ–½2ï¼šè®¾ç½®HttpOnly** â­â­â­

```java
// Spring Securityé»˜è®¤å·²å¯ç”¨HttpOnly
// HttpOnlyå¯é˜²æ­¢JavaScriptè¯»å–Cookieï¼Œé˜²å¾¡XSSæ”»å‡»
```

**æªæ–½3ï¼šIPç»‘å®šéªŒè¯**ï¼š

```java
@Component
public class RememberMeWithIpCheck extends PersistentTokenBasedRememberMeServices {
    
    @Override
    protected UserDetails processAutoLoginCookie(String[] cookieTokens, 
                                                  HttpServletRequest request,
                                                  HttpServletResponse response) {
        // è·å–åŸå§‹IP
        String originalIp = cookieTokens[3];  // å‡è®¾å­˜å‚¨äº†IP
        String currentIp = request.getRemoteAddr();
        
        // IPä¸åŒ¹é…åˆ™æ‹’ç»
        if (!originalIp.equals(currentIp)) {
            throw new InvalidCookieException("IPåœ°å€å·²å˜æ›´");
        }
        
        return super.processAutoLoginCookie(cookieTokens, request, response);
    }
}
```

**æªæ–½4ï¼šå®šæœŸåˆ·æ–°ä»¤ç‰Œ** â­â­

```
ä½¿ç”¨æŒä¹…åŒ–ä»¤ç‰Œæ–¹æ¡ˆ
â†’ æ¯æ¬¡è®¿é—®è‡ªåŠ¨åˆ·æ–°token
â†’ æ—§tokenç«‹å³ä½œåºŸ
â†’ é™ä½è¢«ç›—ç”¨é£é™©
```

**æªæ–½5ï¼šæä¾›é€€å‡ºåŠŸèƒ½** â­â­â­

```java
.logout(logout -> logout
    .logoutUrl("/logout")
    .deleteCookies("remember-me")  // é€€å‡ºæ—¶åˆ é™¤Cookie
    .clearAuthentication(true)
    .invalidateHttpSession(true)
)
```

### 6.3 å®‰å…¨é…ç½®å»ºè®®


**ä¸åŒåœºæ™¯çš„é…ç½®æ–¹æ¡ˆ**ï¼š

```
ğŸ“± ä¸ªäººè®¾å¤‡ï¼ˆä½é£é™©ï¼‰
â€¢ ä»¤ç‰Œæœ‰æ•ˆæœŸï¼š7-14å¤©
â€¢ ä½¿ç”¨æŒä¹…åŒ–ä»¤ç‰Œ
â€¢ å¯ç”¨HTTPSå’ŒHttpOnly

ğŸ’¼ åŠå…¬è®¾å¤‡ï¼ˆä¸­é£é™©ï¼‰  
â€¢ ä»¤ç‰Œæœ‰æ•ˆæœŸï¼š1-3å¤©
â€¢ ä½¿ç”¨æŒä¹…åŒ–ä»¤ç‰Œ
â€¢ å¯ç”¨HTTPSã€HttpOnly
â€¢ æ·»åŠ IPéªŒè¯

ğŸ¦ é‡‘èç³»ç»Ÿï¼ˆé«˜é£é™©ï¼‰
â€¢ ä¸å»ºè®®ä½¿ç”¨è®°ä½æˆ‘
â€¢ æˆ–ä»…é™æçŸ­æ—¶é—´ï¼ˆ1å°æ—¶ï¼‰
â€¢ å¼ºåˆ¶HTTPS
â€¢ å¤šå› ç´ è®¤è¯
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ è®°ä½æˆ‘æœ¬è´¨ï¼šç”¨åŠ å¯†ä»¤ç‰Œä»£æ›¿å¯†ç çš„è‡ªåŠ¨ç™»å½•æœºåˆ¶
ğŸ”¸ ä¸¤ç§æ–¹æ¡ˆï¼šåŸºäºä»¤ç‰Œï¼ˆç®€å•ï¼‰vs æŒä¹…åŒ–ä»¤ç‰Œï¼ˆå®‰å…¨ï¼‰
ğŸ”¸ å·¥ä½œåŸç†ï¼šç™»å½•æ—¶ç”Ÿæˆä»¤ç‰Œ â†’ å­˜å…¥Cookie â†’ ä¸‹æ¬¡è‡ªåŠ¨éªŒè¯
ğŸ”¸ å®‰å…¨è¦ç‚¹ï¼šHTTPS + HttpOnly + å®šæœŸåˆ·æ–° + åˆç†æœ‰æ•ˆæœŸ
ğŸ”¸ é€‚ç”¨åœºæ™¯ï¼šä¸ªäººè®¾å¤‡é•¿æœŸä½¿ç”¨ï¼Œä¸é€‚åˆå…¬å…±è®¾å¤‡
```

### 7.2 é…ç½®è¦ç‚¹å¯¹æ¯”


| å¯¹æ¯”é¡¹ | åŸºäºä»¤ç‰Œ | æŒä¹…åŒ–ä»¤ç‰Œ |
|--------|---------|-----------|
| **å®ç°éš¾åº¦** | â­ ç®€å• | â­â­ ä¸­ç­‰ |
| **å®‰å…¨æ€§** | â­â­ ä¸€èˆ¬ | â­â­â­ è¾ƒé«˜ |
| **å¯†ç ä¿®æ”¹** | âŒ ä»¤ç‰Œå¤±æ•ˆ | âœ… ä¸å—å½±å“ |
| **ä»¤ç‰Œç®¡ç†** | âŒ æ— æ³•ç®¡ç† | âœ… å¯ç®¡ç†å¯æ’¤é”€ |
| **æ€§èƒ½å¼€é”€** | â­ å¾ˆå° | â­â­ éœ€æ•°æ®åº“ |
| **æ¨èåœºæ™¯** | æµ‹è¯•/æ¼”ç¤º | ç”Ÿäº§ç¯å¢ƒ â­ |

### 7.3 å®é™…åº”ç”¨å»ºè®®


**å¿«é€Ÿä¸Šæ‰‹æ­¥éª¤**ï¼š

```
æ­¥éª¤1ï¼šåŸºç¡€é…ç½®ï¼ˆ5åˆ†é’Ÿï¼‰
â†’ æ·»åŠ  .rememberMe() é…ç½®
â†’ è®¾ç½® key å’Œæœ‰æ•ˆæœŸ
â†’ ç™»å½•é¡µæ·»åŠ å¤é€‰æ¡†

æ­¥éª¤2ï¼šæŒä¹…åŒ–å‡çº§ï¼ˆ15åˆ†é’Ÿï¼‰
â†’ åˆ›å»ºæ•°æ®åº“è¡¨
â†’ é…ç½® tokenRepository
â†’ æµ‹è¯•éªŒè¯

æ­¥éª¤3ï¼šå®‰å…¨åŠ å›ºï¼ˆ10åˆ†é’Ÿï¼‰
â†’ å¯ç”¨ useSecureCookie(true)
â†’ é…ç½®HTTPS
â†’ æ·»åŠ é€€å‡ºç™»å½•åŠŸèƒ½
```

**å¸¸è§é—®é¢˜æ’æŸ¥**ï¼š

```
â“ è®°ä½æˆ‘ä¸ç”Ÿæ•ˆ
â†’ æ£€æŸ¥è¡¨å•å‚æ•°åæ˜¯å¦åŒ¹é…
â†’ æ£€æŸ¥Cookieæ˜¯å¦è¢«æµè§ˆå™¨ç¦ç”¨
â†’ æ£€æŸ¥tokenæœ‰æ•ˆæœŸæ˜¯å¦è¿‡æœŸ

â“ ä¿®æ”¹å¯†ç åæ— æ³•è‡ªåŠ¨ç™»å½•
â†’ åŸºäºä»¤ç‰Œæ–¹æ¡ˆçš„æ­£å¸¸ç°è±¡
â†’ æ”¹ç”¨æŒä¹…åŒ–ä»¤ç‰Œæ–¹æ¡ˆ

â“ Cookieè¢«æ¸…é™¤
â†’ æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†useSecureCookieä½†æœªä½¿ç”¨HTTPS
â†’ æ£€æŸ¥æµè§ˆå™¨éšç§è®¾ç½®
â†’ æ£€æŸ¥é€€å‡ºç™»å½•æ˜¯å¦åˆ é™¤Cookie
```

### 7.4 æ ¸å¿ƒè®°å¿†è¦ç‚¹


> ğŸ’¡ **è®°ä½æˆ‘ = ç”¨ä»¤ç‰Œä»£æ›¿å¯†ç **  
> ğŸ’¾ **æŒä¹…åŒ– = æ›´å®‰å…¨å¯ç®¡ç†**  
> ğŸ” **HTTPS + HttpOnly = åŸºæœ¬é˜²æŠ¤**  
> â° **æœ‰æ•ˆæœŸ = å¹³è¡¡å®‰å…¨ä¸ä¾¿åˆ©**  
> ğŸš« **å…¬å…±è®¾å¤‡ = ç¦ç”¨è®°ä½æˆ‘**

**é…ç½®æ¨¡æ¿è®°å¿†**ï¼š

```java
// è®°ä½æˆ‘ä¸‰ä»¶å¥—
.rememberMe(remember -> remember
    .tokenRepository(æŒä¹…åŒ–å­˜å‚¨)  // â† å®‰å…¨å­˜å‚¨
    .tokenValiditySeconds(æœ‰æ•ˆæœŸ) // â† æ§åˆ¶æ—¶é•¿
    .useSecureCookie(true)        // â† å®‰å…¨ä¼ è¾“
)
```