---
title: 2ã€åŠ¨æ€è·¯ç”±é…ç½®
---
## ğŸ“š ç›®å½•

1. [åŠ¨æ€è·¯ç”±æ ¸å¿ƒæ¦‚å¿µ](#1-åŠ¨æ€è·¯ç”±æ ¸å¿ƒæ¦‚å¿µ)
2. [RouteDefinitionç¼–ç¨‹é…ç½®](#2-RouteDefinitionç¼–ç¨‹é…ç½®)
3. [RouteLocator Beané…ç½®](#3-RouteLocator-Beané…ç½®)
4. [Java DSLæµå¼é…ç½®](#4-Java-DSLæµå¼é…ç½®)
5. [é…ç½®ä¸­å¿ƒé›†æˆæ–¹æ¡ˆ](#5-é…ç½®ä¸­å¿ƒé›†æˆæ–¹æ¡ˆ)
6. [è·¯ç”±åŠ¨æ€åˆ·æ–°æœºåˆ¶](#6-è·¯ç”±åŠ¨æ€åˆ·æ–°æœºåˆ¶)
7. [çƒ­æ›´æ–°å®ç°æ–¹æ¡ˆ](#7-çƒ­æ›´æ–°å®ç°æ–¹æ¡ˆ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ åŠ¨æ€è·¯ç”±æ ¸å¿ƒæ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯åŠ¨æ€è·¯ç”±


**ğŸ”¸ é€šä¿—ç†è§£**

> æƒ³è±¡ä¸€ä¸‹ï¼šä½ åœ¨å¼€é«˜é€Ÿå…¬è·¯ï¼Œå¯¼èˆªä¼šæ ¹æ®å®æ—¶è·¯å†µå‘Šè¯‰ä½ èµ°å“ªæ¡è·¯ã€‚åŠ¨æ€è·¯ç”±å°±æ˜¯è¿™æ ·â€”â€”ç½‘å…³å¯ä»¥æ ¹æ®å®é™…æƒ…å†µï¼Œå®æ—¶è°ƒæ•´è¯·æ±‚åº”è¯¥è½¬å‘åˆ°å“ªä¸ªæœåŠ¡ï¼Œè€Œä¸éœ€è¦é‡å¯ç³»ç»Ÿã€‚

**ä¼ ç»Ÿé™æ€è·¯ç”± vs åŠ¨æ€è·¯ç”±å¯¹æ¯”**

```
ã€é™æ€è·¯ç”±ã€‘- å†™æ­»åœ¨é…ç½®æ–‡ä»¶é‡Œ
é…ç½®æ–‡ä»¶(application.yml) â†’ å¯åŠ¨æ—¶åŠ è½½ â†’ æƒ³æ”¹å¿…é¡»é‡å¯
å°±åƒï¼šè·¯æ ‡é’‰æ­»åœ¨åœ°ä¸Šï¼Œæƒ³è°ƒæ•´å¾—æ‹”æ‰é‡è£…

ã€åŠ¨æ€è·¯ç”±ã€‘- å¯ä»¥éšæ—¶ä¿®æ”¹
ç¨‹åºè¿è¡Œä¸­ â†’ ä¿®æ”¹è·¯ç”±è§„åˆ™ â†’ ç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯
å°±åƒï¼šç”µå­æ˜¾ç¤ºå±ï¼Œéšæ—¶å¯ä»¥æ›´æ–°å†…å®¹
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦åŠ¨æ€è·¯ç”±


**ğŸ¯ å®é™…åº”ç”¨åœºæ™¯**

| åœºæ™¯ | ä¼ ç»Ÿåšæ³•çš„é—®é¢˜ | åŠ¨æ€è·¯ç”±çš„ä¼˜åŠ¿ |
|------|---------------|---------------|
| **æœåŠ¡ä¸Šçº¿** | éœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œé‡å¯ç½‘å…³ | æ–°æœåŠ¡æ³¨å†Œåè‡ªåŠ¨å‘ç°ï¼Œç«‹å³å¯ç”¨ |
| **ç°åº¦å‘å¸ƒ** | æ‰‹åŠ¨ä¿®æ”¹é…ç½®ï¼Œåˆ†æ‰¹é‡å¯ | åŠ¨æ€è°ƒæ•´æµé‡æ¯”ä¾‹ï¼Œå®æ—¶ç”Ÿæ•ˆ |
| **æ•…éšœåˆ‡æ¢** | å‘ç°é—®é¢˜è¦æ”¹é…ç½®é‡å¯ | æ£€æµ‹åˆ°æ•…éšœè‡ªåŠ¨åˆ‡æ¢è·¯ç”± |
| **ABæµ‹è¯•** | æ”¹é…ç½®éƒ¨ç½²å¤šæ¬¡ | éšæ—¶è°ƒæ•´è·¯ç”±è§„åˆ™ï¼Œå¿«é€ŸéªŒè¯ |

**ğŸ’¡ æ ¸å¿ƒä»·å€¼**
- âœ… **é›¶åœæœºæ›´æ–°** - ä¿®æ”¹è·¯ç”±ä¸å½±å“ä¸šåŠ¡
- âœ… **å¿«é€Ÿå“åº”** - å‡ ç§’å†…å®Œæˆè·¯ç”±è°ƒæ•´
- âœ… **çµæ´»æ§åˆ¶** - å¯ä»¥ç²¾ç»†åŒ–ç®¡ç†æµé‡
- âœ… **é™ä½é£é™©** - å‡ºé—®é¢˜å¯ä»¥ç«‹å³å›æ»š

### 1.3 åŠ¨æ€è·¯ç”±å®ç°æ–¹å¼å…¨æ™¯


```
GatewayåŠ¨æ€è·¯ç”±çš„ä¸‰ç§å®ç°æ–¹å¼ï¼š

æ–¹å¼ä¸€ï¼šRouteDefinition
        â†“
    æ‰‹åŠ¨å®šä¹‰è·¯ç”±å¯¹è±¡
    é€‚åˆï¼šå®Œå…¨è‡ªå®šä¹‰åœºæ™¯

æ–¹å¼äºŒï¼šRouteLocator
        â†“
    Java Beané…ç½®
    é€‚åˆï¼šç¨‹åºåŒ–é…ç½®

æ–¹å¼ä¸‰ï¼šé…ç½®ä¸­å¿ƒ
        â†“
    é›†æˆNacos/Apollo
    é€‚åˆï¼šä¼ä¸šçº§ç®¡ç†
```

---

## 2. ğŸ”§ RouteDefinitionç¼–ç¨‹é…ç½®


### 2.1 RouteDefinitionæ˜¯ä»€ä¹ˆ


**ğŸ”¸ æ¦‚å¿µè§£é‡Š**

`RouteDefinition` å°±æ˜¯è·¯ç”±çš„"é…ç½®å•"ï¼Œå®ƒåŒ…å«äº†ä¸€æ¡è·¯ç”±è§„åˆ™çš„æ‰€æœ‰ä¿¡æ¯ï¼š
- **å»å“ªé‡Œ** - ç›®æ ‡æœåŠ¡åœ°å€ï¼ˆURIï¼‰
- **ä»€ä¹ˆæ¡ä»¶** - åŒ¹é…è§„åˆ™ï¼ˆPredicatesï¼‰
- **æ€ä¹ˆå¤„ç†** - è¿‡æ»¤å™¨é“¾ï¼ˆFiltersï¼‰

å¯ä»¥ç†è§£ä¸ºï¼š**ç”¨Javaå¯¹è±¡çš„æ–¹å¼ï¼ŒæŠŠé…ç½®æ–‡ä»¶ä¸­çš„è·¯ç”±è§„åˆ™è¡¨è¾¾å‡ºæ¥**

### 2.2 RouteDefinitionæ ¸å¿ƒå±æ€§


```
RouteDefinitionå¯¹è±¡ç»“æ„ï¼š

RouteDefinition
â”œâ”€â”€ id              è·¯ç”±å”¯ä¸€æ ‡è¯†ï¼ˆå¿…å¡«ï¼‰
â”œâ”€â”€ uri             ç›®æ ‡æœåŠ¡åœ°å€ï¼ˆå¿…å¡«ï¼‰
â”œâ”€â”€ predicates[]    åŒ¹é…æ¡ä»¶æ•°ç»„ï¼ˆå¿…å¡«ï¼‰
â”‚   â”œâ”€â”€ name        æ–­è¨€ç±»å‹ï¼ˆå¦‚ï¼šPathï¼‰
â”‚   â””â”€â”€ args        æ–­è¨€å‚æ•°ï¼ˆå¦‚ï¼š/user/**ï¼‰
â”œâ”€â”€ filters[]       è¿‡æ»¤å™¨æ•°ç»„ï¼ˆå¯é€‰ï¼‰
â”‚   â”œâ”€â”€ name        è¿‡æ»¤å™¨ç±»å‹
â”‚   â””â”€â”€ args        è¿‡æ»¤å™¨å‚æ•°
â””â”€â”€ order           ä¼˜å…ˆçº§ï¼ˆå¯é€‰ï¼Œæ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼‰
```

### 2.3 æ‰‹åŠ¨åˆ›å»ºè·¯ç”±å®šä¹‰


**ğŸ“ åŸºç¡€ç¤ºä¾‹**

```java
@Service
public class DynamicRouteService {
    
    @Autowired
    private RouteDefinitionWriter routeDefinitionWriter;
    
    /**
     * æ·»åŠ ä¸€æ¡æ–°è·¯ç”±
     * ä¾‹å¦‚ï¼šæ·»åŠ ç”¨æˆ·æœåŠ¡çš„è·¯ç”±è§„åˆ™
     */
    public String addRoute() {
        // 1. åˆ›å»ºè·¯ç”±å®šä¹‰å¯¹è±¡
        RouteDefinition definition = new RouteDefinition();
        
        // 2. è®¾ç½®è·¯ç”±IDï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰
        definition.setId("user-service-route");
        
        // 3. è®¾ç½®ç›®æ ‡æœåŠ¡åœ°å€
        definition.setUri(URI.create("lb://user-service"));
        
        // 4. åˆ›å»ºæ–­è¨€ï¼ˆä»€ä¹ˆè¯·æ±‚èµ°è¿™æ¡è·¯ç”±ï¼‰
        PredicateDefinition predicate = new PredicateDefinition();
        predicate.setName("Path");  // ä½¿ç”¨è·¯å¾„åŒ¹é…
        predicate.addArg("pattern", "/user/**");  // /userå¼€å¤´çš„éƒ½åŒ¹é…
        definition.getPredicates().add(predicate);
        
        // 5. åˆ›å»ºè¿‡æ»¤å™¨ï¼ˆå¯¹è¯·æ±‚åšä»€ä¹ˆå¤„ç†ï¼‰
        FilterDefinition filter = new FilterDefinition();
        filter.setName("StripPrefix");  // å»æ‰è·¯å¾„å‰ç¼€
        filter.addArg("parts", "1");    // å»æ‰1å±‚å‰ç¼€
        definition.getFilters().add(filter);
        
        // 6. ä¿å­˜è·¯ç”±å®šä¹‰
        routeDefinitionWriter.save(Mono.just(definition)).subscribe();
        
        return "è·¯ç”±æ·»åŠ æˆåŠŸ";
    }
}
```

**ğŸ” ä»£ç è§£æ**

| æ­¥éª¤ | ä»£ç å«ä¹‰ | å®é™…æ•ˆæœ |
|------|---------|---------|
| `setId()` | ç»™è·¯ç”±å–ä¸ªåå­— | æ ‡è¯†è¿™æ¡è·¯ç”±ï¼Œæ–¹ä¾¿åç»­ç®¡ç† |
| `setUri()` | æŒ‡å®šç›®æ ‡åœ°å€ | `lb://user-service` è¡¨ç¤ºè´Ÿè½½å‡è¡¡åˆ°user-service |
| `Pathæ–­è¨€` | å®šä¹‰åŒ¹é…è§„åˆ™ | `/user/**` å¼€å¤´çš„è¯·æ±‚éƒ½èµ°è¿™æ¡è·¯ç”± |
| `StripPrefix` | å»æ‰è·¯å¾„å‰ç¼€ | `/user/info` â†’ `/info` è½¬å‘ç»™æœåŠ¡ |

### 2.4 å®Œæ•´çš„CRUDæ“ä½œ


**ğŸ› ï¸ è·¯ç”±çš„å¢åˆ æ”¹æŸ¥**

```java
@RestController
@RequestMapping("/route")
public class RouteManageController {
    
    @Autowired
    private RouteDefinitionWriter routeWriter;
    
    @Autowired
    private RouteDefinitionLocator routeLocator;
    
    @Autowired
    private ApplicationEventPublisher publisher;
    
    /**
     * æŸ¥è¯¢æ‰€æœ‰è·¯ç”±
     */
    @GetMapping("/list")
    public List<RouteDefinition> listRoutes() {
        return routeLocator.getRouteDefinitions()
            .collectList()
            .block();  // è·å–æ‰€æœ‰è·¯ç”±é…ç½®
    }
    
    /**
     * åˆ é™¤æŒ‡å®šè·¯ç”±
     */
    @DeleteMapping("/{id}")
    public String deleteRoute(@PathVariable String id) {
        routeWriter.delete(Mono.just(id)).subscribe();
        // å‘å¸ƒè·¯ç”±åˆ·æ–°äº‹ä»¶
        publisher.publishEvent(new RefreshRoutesEvent(this));
        return "åˆ é™¤æˆåŠŸ";
    }
    
    /**
     * æ›´æ–°è·¯ç”±ï¼ˆå…ˆåˆ é™¤å†æ·»åŠ ï¼‰
     */
    @PutMapping("/update")
    public String updateRoute(@RequestBody RouteDefinition definition) {
        // åˆ é™¤æ—§è·¯ç”±
        routeWriter.delete(Mono.just(definition.getId())).subscribe();
        // æ·»åŠ æ–°è·¯ç”±
        routeWriter.save(Mono.just(definition)).subscribe();
        // åˆ·æ–°è·¯ç”±
        publisher.publishEvent(new RefreshRoutesEvent(this));
        return "æ›´æ–°æˆåŠŸ";
    }
}
```

**âš¡ å…³é”®ç‚¹è¯´æ˜**

- **RouteDefinitionWriter** - è·¯ç”±å†™å…¥å™¨ï¼Œè´Ÿè´£ä¿å­˜å’Œåˆ é™¤
- **RouteDefinitionLocator** - è·¯ç”±å®šä½å™¨ï¼Œè´Ÿè´£æŸ¥è¯¢
- **RefreshRoutesEvent** - åˆ·æ–°äº‹ä»¶ï¼Œé€šçŸ¥ç½‘å…³é‡æ–°åŠ è½½è·¯ç”±

---

## 3. ğŸ—ï¸ RouteLocator Beané…ç½®


### 3.1 RouteLocatoré…ç½®æ–¹å¼


**ğŸ”¸ æ¦‚å¿µç†è§£**

`RouteLocator` æ˜¯å¦ä¸€ç§é…ç½®è·¯ç”±çš„æ–¹å¼ï¼Œå®ƒé€šè¿‡**Beançš„æ–¹å¼**æŠŠè·¯ç”±æ³¨å†Œåˆ°Springå®¹å™¨ä¸­ã€‚ç›¸æ¯”RouteDefinitionï¼š
- **æ›´é¢å‘å¯¹è±¡** - ç›´æ¥è¿”å›Routeå¯¹è±¡
- **æ›´ç®€æ´** - ä¸éœ€è¦æ‰‹åŠ¨å‘å¸ƒåˆ·æ–°äº‹ä»¶
- **é€‚åˆå›ºå®šè·¯ç”±** - é¡¹ç›®å¯åŠ¨æ—¶å°±ç¡®å®šçš„è·¯ç”±è§„åˆ™

### 3.2 åŸºç¡€é…ç½®ç¤ºä¾‹


```java
@Configuration
public class GatewayRouteConfig {
    
    /**
     * æ–¹å¼ä¸€ï¼šæœ€ç®€å•çš„è·¯ç”±é…ç½®
     */
    @Bean
    public RouteLocator simpleRoutes(RouteLocatorBuilder builder) {
        return builder.routes()
            // è·¯ç”±1ï¼šç”¨æˆ·æœåŠ¡
            .route("user_route", r -> r
                .path("/user/**")
                .uri("lb://user-service"))
            
            // è·¯ç”±2ï¼šè®¢å•æœåŠ¡
            .route("order_route", r -> r
                .path("/order/**")
                .uri("lb://order-service"))
            
            .build();
    }
}
```

**ğŸ“Š é…ç½®ç»“æ„è¯´æ˜**

```
builder.routes()                  å¼€å§‹æ„å»ºè·¯ç”±
    â†“
.route(id, é…ç½®å‡½æ•°)              å®šä¹‰ä¸€æ¡è·¯ç”±
    â†“
r.path("/user/**")                åŒ¹é…æ¡ä»¶
    â†“
.uri("lb://user-service")         ç›®æ ‡åœ°å€
    â†“
.build()                          å®Œæˆæ„å»º
```

### 3.3 é«˜çº§é…ç½®æŠ€å·§


**ğŸ”§ ç»„åˆå¤šä¸ªæ–­è¨€å’Œè¿‡æ»¤å™¨**

```java
@Bean
public RouteLocator advancedRoutes(RouteLocatorBuilder builder) {
    return builder.routes()
        .route("advanced_route", r -> r
            // ç»„åˆå¤šä¸ªåŒ¹é…æ¡ä»¶ï¼ˆANDå…³ç³»ï¼‰
            .path("/api/**")
            .and().header("X-Request-Type", "mobile")
            .and().method(HttpMethod.POST)
            
            // æ·»åŠ å¤šä¸ªè¿‡æ»¤å™¨
            .filters(f -> f
                .stripPrefix(1)           // å»æ‰/apiå‰ç¼€
                .addRequestHeader("X-Gateway", "true")  // æ·»åŠ è¯·æ±‚å¤´
                .retry(config -> config   // é‡è¯•é…ç½®
                    .setRetries(3)
                    .setStatuses(HttpStatus.INTERNAL_SERVER_ERROR)))
            
            .uri("lb://mobile-service"))
        .build();
}
```

**ğŸ’¡ é…ç½®è§£è¯»**

| é…ç½®é¡¹ | å«ä¹‰ | å®é™…æ•ˆæœ |
|--------|------|---------|
| `.path("/api/**")` | è·¯å¾„åŒ¹é… | URLåŒ…å«/apiçš„è¯·æ±‚ |
| `.header("X-Request-Type", "mobile")` | è¯·æ±‚å¤´åŒ¹é… | å¿…é¡»å¸¦æœ‰æŒ‡å®šè¯·æ±‚å¤´ |
| `.method(POST)` | è¯·æ±‚æ–¹æ³•åŒ¹é… | åªæ¥å—POSTè¯·æ±‚ |
| `.stripPrefix(1)` | å»æ‰å‰ç¼€ | /api/user â†’ /user |
| `.retry(3)` | é‡è¯•è®¾ç½® | å¤±è´¥æ—¶æœ€å¤šé‡è¯•3æ¬¡ |

### 3.4 åŠ¨æ€Beanæ³¨å†Œ


**ğŸš€ æ ¹æ®é…ç½®åŠ¨æ€åˆ›å»ºè·¯ç”±**

```java
@Configuration
public class DynamicBeanRouteConfig {
    
    @Autowired
    private RouteProperties routeProperties;  // è‡ªå®šä¹‰é…ç½®ç±»
    
    @Bean
    public RouteLocator dynamicBeanRoutes(RouteLocatorBuilder builder) {
        RouteLocatorBuilder.Builder routes = builder.routes();
        
        // ä»é…ç½®è¯»å–è·¯ç”±åˆ—è¡¨ï¼ŒåŠ¨æ€åˆ›å»º
        for (RouteConfig config : routeProperties.getRoutes()) {
            routes.route(config.getId(), r -> {
                // åŠ¨æ€è®¾ç½®æ–­è¨€
                r.path(config.getPath());
                
                // åŠ¨æ€è®¾ç½®è¿‡æ»¤å™¨
                if (config.isStripPrefix()) {
                    r.filters(f -> f.stripPrefix(1));
                }
                
                return r.uri(config.getUri());
            });
        }
        
        return routes.build();
    }
}
```

**ğŸ“ é…ç½®æ–‡ä»¶ç¤ºä¾‹**

```yaml
# application.yml
gateway:
  custom-routes:
    - id: dynamic-route-1
      path: /service1/**
      uri: lb://service-1
      stripPrefix: true
    - id: dynamic-route-2
      path: /service2/**
      uri: lb://service-2
      stripPrefix: false
```

---

## 4. ğŸ’» Java DSLæµå¼é…ç½®


### 4.1 DSLé…ç½®é£æ ¼


**ğŸ”¸ ä»€ä¹ˆæ˜¯DSL**

DSLï¼ˆDomain Specific Languageï¼‰é¢†åŸŸç‰¹å®šè¯­è¨€ï¼Œç®€å•è¯´å°±æ˜¯ï¼š**ä¸“é—¨ä¸ºæŸä¸ªé¢†åŸŸè®¾è®¡çš„ã€æ›´ç®€æ´æ˜“è¯»çš„é…ç½®æ–¹å¼**ã€‚

Gatewayçš„DSLå°±æ˜¯ç”¨æµå¼APIï¼ˆé“¾å¼è°ƒç”¨ï¼‰æ¥é…ç½®è·¯ç”±ï¼Œä»£ç åƒå†™å¥å­ä¸€æ ·æµç•…ã€‚

### 4.2 DSLé…ç½®å®Œæ•´ç¤ºä¾‹


```java
@Configuration
public class DSLRouteConfig {
    
    @Bean
    public RouteLocator dslRoutes(RouteLocatorBuilder builder) {
        return builder.routes()
            // åœºæ™¯1ï¼šåŸºäºæ—¶é—´çš„è·¯ç”±ï¼ˆé™æ—¶æ´»åŠ¨ï¼‰
            .route("limited_time_route", r -> r
                .between(
                    ZonedDateTime.now(),
                    ZonedDateTime.now().plusDays(7)  // 7å¤©å†…æœ‰æ•ˆ
                )
                .and().path("/promo/**")
                .uri("lb://promotion-service"))
            
            // åœºæ™¯2ï¼šåŸºäºæƒé‡çš„ç°åº¦å‘å¸ƒ
            .route("gray_v1", r -> r
                .path("/api/**")
                .and().weight("version", 90)  // 90%æµé‡åˆ°v1
                .uri("lb://service-v1"))
            
            .route("gray_v2", r -> r
                .path("/api/**")
                .and().weight("version", 10)  // 10%æµé‡åˆ°v2
                .uri("lb://service-v2"))
            
            // åœºæ™¯3ï¼šåŸºäºCookieçš„è·¯ç”±
            .route("vip_route", r -> r
                .cookie("vip_level", "gold|platinum")  // æ­£åˆ™åŒ¹é…
                .and().path("/vip/**")
                .filters(f -> f
                    .addResponseHeader("X-VIP-Service", "true"))
                .uri("lb://vip-service"))
            
            .build();
    }
}
```

**ğŸ¯ åœºæ™¯è§£è¯»**

| åœºæ™¯ | ä½¿ç”¨çš„æ–­è¨€ | å®é™…ç”¨é€” |
|------|-----------|---------|
| **é™æ—¶æ´»åŠ¨** | `between()` | æ´»åŠ¨æœŸé—´è‡ªåŠ¨å¼€å¯è·¯ç”±ï¼Œè¿‡æœŸè‡ªåŠ¨å¤±æ•ˆ |
| **ç°åº¦å‘å¸ƒ** | `weight()` | æ–°ç‰ˆæœ¬å…ˆç»™10%ç”¨æˆ·ï¼Œç¨³å®šåé€æ­¥æ‰©å¤§ |
| **VIPç”¨æˆ·** | `cookie()` | æ ¹æ®Cookieåˆ¤æ–­ç”¨æˆ·ç­‰çº§ï¼Œæä¾›ä¸“å±æœåŠ¡ |

### 4.3 å¸¸ç”¨DSLæ–¹æ³•é€ŸæŸ¥


**ğŸ“‹ æ–­è¨€æ–¹æ³•æ±‡æ€»**

```java
// è·¯å¾„åŒ¹é…
.path("/user/**")

// è¯·æ±‚æ–¹æ³•
.method(HttpMethod.GET, HttpMethod.POST)

// è¯·æ±‚å¤´
.header("X-Token", "\\d+")  // æ­£åˆ™åŒ¹é…

// æŸ¥è¯¢å‚æ•°
.query("id", "\\d+")

// æ—¶é—´èŒƒå›´
.between(start, end)
.before(dateTime)
.after(dateTime)

// IPåœ°å€
.remoteAddr("192.168.1.0/24")

// æƒé‡åˆ†æµ
.weight("group", 80)

// Cookie
.cookie("session", ".*")

// Host
.host("**.example.com")
```

---

## 5. ğŸ”„ é…ç½®ä¸­å¿ƒé›†æˆæ–¹æ¡ˆ


### 5.1 ä¸ºä»€ä¹ˆéœ€è¦é…ç½®ä¸­å¿ƒ


**ğŸ”¸ ç—›ç‚¹åˆ†æ**

```
ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜ï¼š
1. é…ç½®åˆ†æ•£ â†’ æ¯ä¸ªç½‘å…³å®ä¾‹éƒ½è¦é…ç½®
2. æ›´æ–°éº»çƒ¦ â†’ ä¿®æ”¹ä¸€å¤„è¦é‡å¯æ‰€æœ‰å®ä¾‹
3. ä¸æ˜“ç®¡ç† â†’ æ²¡æœ‰ç»Ÿä¸€çš„ç®¡ç†ç•Œé¢
4. éš¾ä»¥è¿½æº¯ â†’ ä¸çŸ¥é“è°æ”¹äº†ä»€ä¹ˆ

é…ç½®ä¸­å¿ƒçš„è§£å†³æ–¹æ¡ˆï¼š
1. ç»Ÿä¸€å­˜å‚¨ â†’ æ‰€æœ‰é…ç½®å­˜åœ¨ä¸€ä¸ªåœ°æ–¹
2. åŠ¨æ€æ¨é€ â†’ ä¿®æ”¹åè‡ªåŠ¨é€šçŸ¥æ‰€æœ‰å®ä¾‹
3. å¯è§†åŒ–ç®¡ç† â†’ ç•Œé¢æ“ä½œï¼Œæ–¹ä¾¿å¿«æ·
4. ç‰ˆæœ¬æ§åˆ¶ â†’ å®Œæ•´çš„ä¿®æ”¹å†å²è®°å½•
```

### 5.2 Nacosé…ç½®ä¸­å¿ƒé›†æˆ


**ğŸ“¦ é›†æˆæ­¥éª¤**

**æ­¥éª¤1ï¼šæ·»åŠ ä¾èµ–**

```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
</dependency>
```

**æ­¥éª¤2ï¼šé…ç½®Nacosè¿æ¥**

```yaml
# bootstrap.yml
spring:
  application:
    name: gateway-service
  cloud:
    nacos:
      config:
        server-addr: localhost:8848
        file-extension: yaml
        namespace: dev
        group: GATEWAY_GROUP
```

**æ­¥éª¤3ï¼šåˆ›å»ºåŠ¨æ€è·¯ç”±ç›‘å¬å™¨**

```java
@Component
public class NacosDynamicRouteService implements CommandLineRunner {
    
    @Autowired
    private RouteDefinitionWriter routeWriter;
    
    @Autowired
    private ApplicationEventPublisher publisher;
    
    @Value("${spring.cloud.nacos.config.server-addr}")
    private String serverAddr;
    
    private static final String DATA_ID = "gateway-routes";
    private static final String GROUP = "GATEWAY_GROUP";
    
    @Override
    public void run(String... args) throws Exception {
        // åˆ›å»ºNacosé…ç½®ç›‘å¬å™¨
        ConfigService configService = NacosFactory.createConfigService(serverAddr);
        
        // è·å–åˆå§‹é…ç½®
        String configInfo = configService.getConfig(DATA_ID, GROUP, 5000);
        updateRoutes(configInfo);
        
        // ç›‘å¬é…ç½®å˜åŒ–
        configService.addListener(DATA_ID, GROUP, new Listener() {
            @Override
            public void receiveConfigInfo(String configInfo) {
                updateRoutes(configInfo);  // é…ç½®å˜åŒ–æ—¶æ›´æ–°è·¯ç”±
            }
            
            @Override
            public Executor getExecutor() {
                return null;
            }
        });
    }
    
    private void updateRoutes(String configInfo) {
        // è§£æé…ç½®ï¼ˆè¿™é‡Œå‡è®¾æ˜¯JSONæ ¼å¼ï¼‰
        List<RouteDefinition> routes = parseRoutes(configInfo);
        
        // å…ˆæ¸…ç©ºæ—§è·¯ç”±
        // å†æ·»åŠ æ–°è·¯ç”±
        routes.forEach(route -> {
            routeWriter.save(Mono.just(route)).subscribe();
        });
        
        // å‘å¸ƒåˆ·æ–°äº‹ä»¶
        publisher.publishEvent(new RefreshRoutesEvent(this));
    }
}
```

### 5.3 Nacosé…ç½®æ ¼å¼


**ğŸ“ åœ¨Nacosä¸­é…ç½®è·¯ç”±**

```yaml
# Data ID: gateway-routes
# Group: GATEWAY_GROUP

routes:
  - id: user-service
    uri: lb://user-service
    predicates:
      - name: Path
        args:
          pattern: /user/**
    filters:
      - name: StripPrefix
        args:
          parts: 1
          
  - id: order-service
    uri: lb://order-service
    predicates:
      - name: Path
        args:
          pattern: /order/**
    filters:
      - name: AddRequestHeader
        args:
          name: X-Gateway
          value: nacos-route
```

**ğŸ¯ é…ç½®ç®¡ç†ç•Œé¢æ“ä½œ**

```
Nacosæ§åˆ¶å°æ“ä½œæµç¨‹ï¼š

1. ç™»å½•Nacos â†’ http://localhost:8848/nacos
2. é…ç½®ç®¡ç† â†’ é…ç½®åˆ—è¡¨
3. æ–°å»ºé…ç½®ï¼š
   - Data ID: gateway-routes
   - Group: GATEWAY_GROUP
   - é…ç½®æ ¼å¼: YAML
4. ç²˜è´´è·¯ç”±é…ç½® â†’ å‘å¸ƒ
5. ç½‘å…³è‡ªåŠ¨æ¥æ”¶æ›´æ–° â†’ è·¯ç”±ç«‹å³ç”Ÿæ•ˆ
```

---

## 6. ğŸ”„ è·¯ç”±åŠ¨æ€åˆ·æ–°æœºåˆ¶


### 6.1 åˆ·æ–°æœºåˆ¶åŸç†


**ğŸ”¸ å·¥ä½œæµç¨‹**

```
è·¯ç”±åˆ·æ–°å®Œæ•´æµç¨‹ï¼š

1. é…ç½®å˜æ›´
   â”œâ”€ æ‰‹åŠ¨è°ƒç”¨APIä¿®æ”¹
   â”œâ”€ é…ç½®ä¸­å¿ƒæ¨é€
   â””â”€ å®šæ—¶ä»»åŠ¡æ›´æ–°
        â†“
2. å‘å¸ƒåˆ·æ–°äº‹ä»¶
   RefreshRoutesEvent
        â†“
3. äº‹ä»¶ç›‘å¬å™¨è§¦å‘
   CachingRouteLocator
        â†“
4. æ¸…ç©ºè·¯ç”±ç¼“å­˜
   routeCache.clear()
        â†“
5. é‡æ–°åŠ è½½è·¯ç”±
   ä»RouteDefinitionLocatorè·å–æœ€æ–°é…ç½®
        â†“
6. è·¯ç”±ç”Ÿæ•ˆ
   æ–°è¯·æ±‚ä½¿ç”¨æ–°è·¯ç”±è§„åˆ™
```

### 6.2 æ‰‹åŠ¨åˆ·æ–°å®ç°


**ğŸ› ï¸ æä¾›åˆ·æ–°æ¥å£**

```java
@RestController
@RequestMapping("/actuator")
public class RouteRefreshController {
    
    @Autowired
    private ApplicationEventPublisher publisher;
    
    @Autowired
    private RouteDefinitionLocator routeLocator;
    
    /**
     * æ‰‹åŠ¨è§¦å‘è·¯ç”±åˆ·æ–°
     */
    @PostMapping("/gateway/refresh")
    public Map<String, Object> refresh() {
        // å‘å¸ƒåˆ·æ–°äº‹ä»¶
        publisher.publishEvent(new RefreshRoutesEvent(this));
        
        // è·å–å½“å‰è·¯ç”±æ•°é‡
        long count = routeLocator.getRouteDefinitions().count().block();
        
        Map<String, Object> result = new HashMap<>();
        result.put("status", "success");
        result.put("message", "è·¯ç”±åˆ·æ–°æˆåŠŸ");
        result.put("routeCount", count);
        result.put("timestamp", System.currentTimeMillis());
        
        return result;
    }
    
    /**
     * æŸ¥çœ‹å½“å‰æ‰€æœ‰è·¯ç”±
     */
    @GetMapping("/gateway/routes")
    public List<Map<String, Object>> listRoutes() {
        return routeLocator.getRouteDefinitions()
            .map(route -> {
                Map<String, Object> map = new HashMap<>();
                map.put("id", route.getId());
                map.put("uri", route.getUri().toString());
                map.put("predicates", route.getPredicates());
                return map;
            })
            .collectList()
            .block();
    }
}
```

### 6.3 è‡ªåŠ¨åˆ·æ–°é…ç½®


**âš™ï¸ å®šæ—¶åˆ·æ–°ç­–ç•¥**

```java
@Component
public class AutoRefreshRouteTask {
    
    @Autowired
    private ApplicationEventPublisher publisher;
    
    /**
     * æ¯30ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡è·¯ç”±
     * é€‚ç”¨äºé…ç½®ä¸­å¿ƒå¯èƒ½å»¶è¿Ÿæ¨é€çš„åœºæ™¯
     */
    @Scheduled(fixedDelay = 30000)
    public void autoRefresh() {
        publisher.publishEvent(new RefreshRoutesEvent(this));
        log.info("è·¯ç”±è‡ªåŠ¨åˆ·æ–°å®Œæˆ");
    }
}
```

**ğŸ¯ åˆ·æ–°ç­–ç•¥å¯¹æ¯”**

| åˆ·æ–°æ–¹å¼ | è§¦å‘æ—¶æœº | é€‚ç”¨åœºæ™¯ | ä¼˜ç¼ºç‚¹ |
|---------|---------|---------|--------|
| **æ‰‹åŠ¨åˆ·æ–°** | è°ƒç”¨æ¥å£è§¦å‘ | æ˜ç¡®çŸ¥é“é…ç½®å˜æ›´æ—¶ | âœ…ç²¾ç¡®æ§åˆ¶ âŒéœ€è¦äººå·¥ä»‹å…¥ |
| **äº‹ä»¶é©±åŠ¨** | é…ç½®å˜æ›´è‡ªåŠ¨è§¦å‘ | é…ç½®ä¸­å¿ƒæ¨é€é€šçŸ¥ | âœ…å®æ—¶å“åº” âŒä¾èµ–é…ç½®ä¸­å¿ƒ |
| **å®šæ—¶åˆ·æ–°** | å›ºå®šæ—¶é—´é—´éš” | å…œåº•ä¿éšœæœºåˆ¶ | âœ…ç¨³å®šå¯é  âŒæœ‰å»¶è¿Ÿ |

---

## 7. ğŸ”¥ çƒ­æ›´æ–°å®ç°æ–¹æ¡ˆ


### 7.1 çƒ­æ›´æ–°æ ¸å¿ƒåŸç†


**ğŸ”¸ ä»€ä¹ˆæ˜¯çƒ­æ›´æ–°**

> çƒ­æ›´æ–°å°±æ˜¯ï¼š**åœ¨ç³»ç»Ÿè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œä¸åœæœã€ä¸é‡å¯ï¼Œç›´æ¥æ›¿æ¢è·¯ç”±é…ç½®**ã€‚å°±åƒæ¢è½®èƒä¸ç”¨åœè½¦ä¸€æ ·ã€‚

**å®ç°å…³é”®ç‚¹**

```
çƒ­æ›´æ–°ä¸‰è¦ç´ ï¼š

1. é…ç½®éš”ç¦»
   â†“
   è·¯ç”±é…ç½®å’Œä¸šåŠ¡ä»£ç åˆ†ç¦»
   é…ç½®å­˜å‚¨åœ¨å¤–éƒ¨ï¼ˆæ•°æ®åº“/é…ç½®ä¸­å¿ƒï¼‰

2. åŠ¨æ€åŠ è½½
   â†“
   è¿è¡Œæ—¶è¯»å–æœ€æ–°é…ç½®
   ä¸ä¾èµ–å¯åŠ¨æ—¶çš„é…ç½®

3. å¹³æ»‘åˆ‡æ¢
   â†“
   æ—§è¯·æ±‚ç»§ç»­ç”¨æ—§è·¯ç”±
   æ–°è¯·æ±‚ä½¿ç”¨æ–°è·¯ç”±
   æ— ç¼è¿‡æ¸¡
```

### 7.2 æ•°æ®åº“å­˜å‚¨æ–¹æ¡ˆ


**ğŸ“Š è·¯ç”±é…ç½®è¡¨è®¾è®¡**

```sql
CREATE TABLE gateway_routes (
    id VARCHAR(64) PRIMARY KEY COMMENT 'è·¯ç”±ID',
    uri VARCHAR(255) NOT NULL COMMENT 'ç›®æ ‡URI',
    predicates JSON COMMENT 'æ–­è¨€é…ç½®',
    filters JSON COMMENT 'è¿‡æ»¤å™¨é…ç½®',
    route_order INT DEFAULT 0 COMMENT 'ä¼˜å…ˆçº§',
    enabled TINYINT DEFAULT 1 COMMENT 'æ˜¯å¦å¯ç”¨',
    description VARCHAR(500) COMMENT 'è·¯ç”±æè¿°',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

**ğŸ”§ åŠ¨æ€åŠ è½½å®ç°**

```java
@Component
public class DatabaseRouteDefinitionRepository 
    implements RouteDefinitionRepository {
    
    @Autowired
    private GatewayRouteMapper routeMapper;
    
    /**
     * ä»æ•°æ®åº“åŠ è½½æ‰€æœ‰å¯ç”¨çš„è·¯ç”±
     */
    @Override
    public Flux<RouteDefinition> getRouteDefinitions() {
        List<GatewayRoute> routes = routeMapper.selectEnabled();
        
        return Flux.fromIterable(routes)
            .map(this::convertToDefinition);
    }
    
    /**
     * ä¿å­˜è·¯ç”±åˆ°æ•°æ®åº“
     */
    @Override
    public Mono<Void> save(Mono<RouteDefinition> route) {
        return route.flatMap(r -> {
            GatewayRoute entity = convertToEntity(r);
            routeMapper.insert(entity);
            return Mono.empty();
        });
    }
    
    /**
     * ä»æ•°æ®åº“åˆ é™¤è·¯ç”±
     */
    @Override
    public Mono<Void> delete(Mono<String> routeId) {
        return routeId.flatMap(id -> {
            routeMapper.deleteById(id);
            return Mono.empty();
        });
    }
    
    private RouteDefinition convertToDefinition(GatewayRoute entity) {
        RouteDefinition definition = new RouteDefinition();
        definition.setId(entity.getId());
        definition.setUri(URI.create(entity.getUri()));
        // ä»JSONååºåˆ—åŒ–æ–­è¨€å’Œè¿‡æ»¤å™¨
        // ...çœç•¥å…·ä½“è½¬æ¢é€»è¾‘
        return definition;
    }
}
```

### 7.3 Redisç¼“å­˜ä¼˜åŒ–


**ğŸš€ åŒå±‚å­˜å‚¨æ¶æ„**

```
çƒ­æ›´æ–°æ•°æ®æµï¼š

æ•°æ®åº“ï¼ˆæŒä¹…åŒ–ï¼‰
    â†“ è¯»å–
Redisï¼ˆç¼“å­˜å±‚ï¼‰
    â†“ åŠ è½½
Gatewayå†…å­˜ï¼ˆè¿è¡Œæ—¶ï¼‰
    â†“ ä½¿ç”¨
å¤„ç†è¯·æ±‚

æ›´æ–°æµç¨‹ï¼š
ä¿®æ”¹æ•°æ®åº“ â†’ æ¸…é™¤Redis â†’ å‘å¸ƒåˆ·æ–°äº‹ä»¶ â†’ é‡æ–°åŠ è½½
```

**ğŸ’» Redisé›†æˆä»£ç **

```java
@Component
public class RedisRouteService {
    
    @Autowired
    private StringRedisTemplate redisTemplate;
    
    @Autowired
    private RouteDefinitionRepository repository;
    
    @Autowired
    private ApplicationEventPublisher publisher;
    
    private static final String ROUTE_KEY = "gateway:routes";
    
    /**
     * æ›´æ–°è·¯ç”±ï¼ˆå†™å…¥æ•°æ®åº“+æ¸…é™¤ç¼“å­˜ï¼‰
     */
    public void updateRoute(RouteDefinition definition) {
        // 1. ä¿å­˜åˆ°æ•°æ®åº“
        repository.save(Mono.just(definition)).subscribe();
        
        // 2. åˆ é™¤Redisç¼“å­˜
        redisTemplate.delete(ROUTE_KEY);
        
        // 3. è§¦å‘åˆ·æ–°
        publisher.publishEvent(new RefreshRoutesEvent(this));
    }
    
    /**
     * è·å–è·¯ç”±ï¼ˆä¼˜å…ˆä»ç¼“å­˜è¯»å–ï¼‰
     */
    public List<RouteDefinition> getRoutes() {
        String cache = redisTemplate.opsForValue().get(ROUTE_KEY);
        
        if (cache != null) {
            // ç¼“å­˜å‘½ä¸­ï¼Œç›´æ¥è¿”å›
            return JSON.parseArray(cache, RouteDefinition.class);
        }
        
        // ç¼“å­˜æœªå‘½ä¸­ï¼Œä»æ•°æ®åº“åŠ è½½
        List<RouteDefinition> routes = repository.getRouteDefinitions()
            .collectList()
            .block();
        
        // å†™å…¥ç¼“å­˜ï¼ˆæœ‰æ•ˆæœŸ5åˆ†é’Ÿï¼‰
        redisTemplate.opsForValue().set(
            ROUTE_KEY, 
            JSON.toJSONString(routes),
            5, TimeUnit.MINUTES
        );
        
        return routes;
    }
}
```

### 7.4 ç°åº¦å‘å¸ƒå®ç°


**ğŸ¯ é‡‘ä¸é›€å‘å¸ƒï¼ˆCanaryï¼‰**

```java
@Service
public class GrayReleaseService {
    
    @Autowired
    private RouteDefinitionWriter routeWriter;
    
    /**
     * å¼€å¯ç°åº¦å‘å¸ƒ
     * @param newVersion æ–°ç‰ˆæœ¬æœåŠ¡å
     * @param grayPercent ç°åº¦ç™¾åˆ†æ¯”ï¼ˆå¦‚10è¡¨ç¤º10%ï¼‰
     */
    public void enableGrayRelease(String newVersion, int grayPercent) {
        // ä¸»è·¯ç”±ï¼š90%æµé‡èµ°æ—§ç‰ˆæœ¬
        RouteDefinition mainRoute = new RouteDefinition();
        mainRoute.setId("main-route");
        mainRoute.setUri(URI.create("lb://service-v1"));
        
        PredicateDefinition mainPredicate = new PredicateDefinition();
        mainPredicate.setName("Weight");
        mainPredicate.addArg("group", "version");
        mainPredicate.addArg("weight", String.valueOf(100 - grayPercent));
        mainRoute.getPredicates().add(mainPredicate);
        
        // ç°åº¦è·¯ç”±ï¼š10%æµé‡èµ°æ–°ç‰ˆæœ¬
        RouteDefinition grayRoute = new RouteDefinition();
        grayRoute.setId("gray-route");
        grayRoute.setUri(URI.create("lb://" + newVersion));
        
        PredicateDefinition grayPredicate = new PredicateDefinition();
        grayPredicate.setName("Weight");
        grayPredicate.addArg("group", "version");
        grayPredicate.addArg("weight", String.valueOf(grayPercent));
        grayRoute.getPredicates().add(grayPredicate);
        
        // ä¿å­˜è·¯ç”±
        routeWriter.save(Mono.just(mainRoute)).subscribe();
        routeWriter.save(Mono.just(grayRoute)).subscribe();
        
        // åˆ·æ–°
        publisher.publishEvent(new RefreshRoutesEvent(this));
    }
    
    /**
     * é€æ­¥æ‰©å¤§ç°åº¦èŒƒå›´
     */
    public void expandGray(int newPercent) {
        // æ›´æ–°æƒé‡é…ç½®
        enableGrayRelease("service-v2", newPercent);
    }
    
    /**
     * å®Œæˆç°åº¦ï¼Œå…¨é‡åˆ‡æ¢
     */
    public void finishGray(String newVersion) {
        // åˆ é™¤ç°åº¦è·¯ç”±ï¼Œåªä¿ç•™æ–°ç‰ˆæœ¬è·¯ç”±
        routeWriter.delete(Mono.just("gray-route")).subscribe();
        // ... æ›´æ–°ä¸»è·¯ç”±æŒ‡å‘æ–°ç‰ˆæœ¬
    }
}
```

**ğŸ“ˆ ç°åº¦å‘å¸ƒæµç¨‹**

```
ç°åº¦å‘å¸ƒæ­¥éª¤ï¼š

1. åˆå§‹çŠ¶æ€
   100%æµé‡ â†’ v1ç‰ˆæœ¬

2. å¼€å¯ç°åº¦ï¼ˆ10%ï¼‰
   90%æµé‡ â†’ v1ç‰ˆæœ¬
   10%æµé‡ â†’ v2ç‰ˆæœ¬ï¼ˆç°åº¦ï¼‰

3. è§‚å¯ŸéªŒè¯
   ç›‘æ§v2ç‰ˆæœ¬çš„é”™è¯¯ç‡ã€å“åº”æ—¶é—´
   å¦‚æœ‰é—®é¢˜ç«‹å³å›æ»š

4. æ‰©å¤§ç°åº¦ï¼ˆ50%ï¼‰
   50%æµé‡ â†’ v1ç‰ˆæœ¬
   50%æµé‡ â†’ v2ç‰ˆæœ¬

5. å…¨é‡å‘å¸ƒ
   100%æµé‡ â†’ v2ç‰ˆæœ¬
   ä¸‹çº¿v1ç‰ˆæœ¬
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ åŠ¨æ€è·¯ç”±æœ¬è´¨ï¼šè¿è¡Œæ—¶ä¿®æ”¹è·¯ç”±é…ç½®ï¼Œæ— éœ€é‡å¯
ğŸ”¸ ä¸‰ç§é…ç½®æ–¹å¼ï¼šRouteDefinitionã€RouteLocatorã€é…ç½®ä¸­å¿ƒ
ğŸ”¸ åˆ·æ–°æœºåˆ¶ï¼šå‘å¸ƒRefreshRoutesEventäº‹ä»¶è§¦å‘é‡æ–°åŠ è½½
ğŸ”¸ çƒ­æ›´æ–°åŸç†ï¼šé…ç½®å¤–ç½®åŒ– + åŠ¨æ€åŠ è½½ + å¹³æ»‘åˆ‡æ¢
ğŸ”¸ é…ç½®ä¸­å¿ƒä»·å€¼ï¼šç»Ÿä¸€ç®¡ç†ã€åŠ¨æ€æ¨é€ã€ç‰ˆæœ¬æ§åˆ¶
ğŸ”¸ ç°åº¦å‘å¸ƒï¼šé€šè¿‡æƒé‡è·¯ç”±é€æ­¥åˆ‡æ¢ç‰ˆæœ¬
```

### 8.2 ä¸‰ç§é…ç½®æ–¹å¼å¯¹æ¯”


| é…ç½®æ–¹å¼ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|---------|---------|------|------|
| **RouteDefinition** | å®Œå…¨åŠ¨æ€ï¼Œè¿è¡Œæ—¶ä¿®æ”¹ | çµæ´»æ€§æœ€é«˜ï¼Œå¯CRUDæ“ä½œ | ä»£ç ç›¸å¯¹å¤æ‚ |
| **RouteLocator** | é¡¹ç›®å¯åŠ¨æ—¶çš„å›ºå®šè·¯ç”± | ä»£ç ç®€æ´ï¼Œç±»å‹å®‰å…¨ | ä¿®æ”¹éœ€è¦é‡å¯ |
| **é…ç½®ä¸­å¿ƒ** | ä¼ä¸šçº§å¤šå®ä¾‹ç®¡ç† | ç»Ÿä¸€ç®¡ç†ï¼Œå¯è§†åŒ–æ“ä½œ | ä¾èµ–å¤–éƒ¨ç³»ç»Ÿ |

### 8.3 å®é™…åº”ç”¨å»ºè®®


**ğŸ¯ é€‰æ‹©ç­–ç•¥**

```
åœºæ™¯1ï¼šç®€å•é¡¹ç›®ï¼ˆå‡ ä¸ªå›ºå®šæœåŠ¡ï¼‰
â†’ ä½¿ç”¨RouteLocator Beané…ç½®
â†’ å†™åœ¨ä»£ç é‡Œï¼Œç®€å•ç›´æ¥

åœºæ™¯2ï¼šéœ€è¦è¿ç»´åŠ¨æ€è°ƒæ•´
â†’ é›†æˆNacosé…ç½®ä¸­å¿ƒ
â†’ é€šè¿‡ç•Œé¢ç®¡ç†ï¼Œæ–¹ä¾¿ç»´æŠ¤

åœºæ™¯3ï¼šå¤§å‹å¾®æœåŠ¡å¹³å°
â†’ æ•°æ®åº“ + Redis + é…ç½®ä¸­å¿ƒ
â†’ å¤šå±‚æ¶æ„ï¼Œæ€§èƒ½å’Œç®¡ç†å…¼é¡¾
```

**âš ï¸ å¸¸è§é—®é¢˜ä¸è§£å†³**

| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|---------|
| è·¯ç”±ä¸ç”Ÿæ•ˆ | å¿˜è®°å‘å¸ƒåˆ·æ–°äº‹ä»¶ | è°ƒç”¨`RefreshRoutesEvent` |
| ä¿®æ”¹æ— æ•ˆ | æ—§é…ç½®ç¼“å­˜æœªæ¸…é™¤ | æ¸…é™¤Redis/æœ¬åœ°ç¼“å­˜ |
| æ€§èƒ½ä¸‹é™ | é¢‘ç¹æŸ¥è¯¢æ•°æ®åº“ | å¢åŠ Redisç¼“å­˜å±‚ |
| é…ç½®ä¸¢å¤± | åªå­˜å†…å­˜æœªæŒä¹…åŒ– | ä¿å­˜åˆ°æ•°æ®åº“ |

**ğŸ’¡ æœ€ä½³å®è·µ**

```
1. é…ç½®åˆ†å±‚
   - åŸºç¡€é…ç½®ï¼šå†™åœ¨ä»£ç ä¸­ï¼ˆRouteLocatorï¼‰
   - åŠ¨æ€é…ç½®ï¼šå­˜é…ç½®ä¸­å¿ƒ/æ•°æ®åº“
   
2. ç›‘æ§å‘Šè­¦
   - ç›‘æ§è·¯ç”±åˆ·æ–°é¢‘ç‡
   - è®°å½•è·¯ç”±å˜æ›´æ—¥å¿—
   - å¼‚å¸¸æ—¶è‡ªåŠ¨å‘Šè­¦

3. ç°åº¦å‘å¸ƒ
   - æ–°åŠŸèƒ½å…ˆç°åº¦10%ç”¨æˆ·
   - è§‚å¯Ÿ24å°æ—¶æ— é—®é¢˜å†æ‰©å¤§
   - ä¿ç•™å¿«é€Ÿå›æ»šèƒ½åŠ›

4. ç‰ˆæœ¬ç®¡ç†
   - è®°å½•æ¯æ¬¡é…ç½®å˜æ›´
   - æ”¯æŒä¸€é”®å›æ»šåˆ°å†å²ç‰ˆæœ¬
   - é‡è¦å˜æ›´éœ€è¦å®¡æ‰¹æµç¨‹
```

**æ ¸å¿ƒè®°å¿†**ï¼š
```
åŠ¨æ€è·¯ç”±ä¸‰æ¿æ–§ï¼šå®šä¹‰ã€åˆ·æ–°ã€ç”Ÿæ•ˆ
é…ç½®ä¸­å¿ƒæ˜¯æ ¸å¿ƒï¼šç»Ÿä¸€ç®¡ç†æœ€çœå¿ƒ
çƒ­æ›´æ–°è¦åšå¥½ï¼šæ•°æ®åº“RedisåŒä¿é™©
ç°åº¦å‘å¸ƒä¿å¹³ç¨³ï¼šå°æ­¥å¿«è·‘é™é£é™©
```