---
title: 5ã€æ€§èƒ½ç›‘æ§å‘Šè­¦
---
## ğŸ“š ç›®å½•

1. [æ€§èƒ½ç›‘æ§æ¦‚è¿°](#1-æ€§èƒ½ç›‘æ§æ¦‚è¿°)
2. [PrometheusæŒ‡æ ‡æ”¶é›†](#2-PrometheusæŒ‡æ ‡æ”¶é›†)
3. [Grafanaå¯è§†åŒ–é¢æ¿](#3-Grafanaå¯è§†åŒ–é¢æ¿)
4. [å‘Šè­¦è§„åˆ™é…ç½®](#4-å‘Šè­¦è§„åˆ™é…ç½®)
5. [é’‰é’‰å‘Šè­¦é›†æˆ](#5-é’‰é’‰å‘Šè­¦é›†æˆ)
6. [é‚®ä»¶å‘Šè­¦é…ç½®](#6-é‚®ä»¶å‘Šè­¦é…ç½®)
7. [å…³é”®æŒ‡æ ‡ç›‘æ§](#7-å…³é”®æŒ‡æ ‡ç›‘æ§)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ æ€§èƒ½ç›‘æ§æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯æ€§èƒ½ç›‘æ§


**é€šä¿—ç†è§£ï¼šå°±åƒç»™ç³»ç»Ÿè£…ä¸Š"ä½“æ£€ä»ªå™¨"**

æƒ³è±¡ä½ å¼€è½¦ï¼Œä»ªè¡¨ç›˜ä¼šæ˜¾ç¤ºé€Ÿåº¦ã€æ²¹é‡ã€æ°´æ¸©ç­‰ä¿¡æ¯ï¼Œè¿™æ ·ä½ å°±èƒ½éšæ—¶çŸ¥é“è½¦çš„çŠ¶æ€ã€‚æ€§èƒ½ç›‘æ§å°±æ˜¯ç»™ä½ çš„å¾®æœåŠ¡ç½‘å…³è£…ä¸Šè¿™æ ·çš„"ä»ªè¡¨ç›˜"ã€‚

```
ä¼ ç»Ÿåšæ³•ï¼ˆæ²¡æœ‰ç›‘æ§ï¼‰ï¼š
ç³»ç»Ÿå‡ºé—®é¢˜ â†’ ç”¨æˆ·æŠ•è¯‰ â†’ ç´§æ€¥æ’æŸ¥ â†’ æ‰¾åˆ°åŸå› 
é—®é¢˜ï¼šå‘ç°å¤ªæ™šï¼Œå½±å“ç”¨æˆ·ä½“éªŒ

ç›‘æ§æ–¹æ¡ˆï¼ˆä¸»åŠ¨ç›‘æ§ï¼‰ï¼š
ç³»ç»ŸæŒ‡æ ‡å¼‚å¸¸ â†’ è‡ªåŠ¨å‘Šè­¦ â†’ æå‰å¤„ç† â†’ é¿å…æ•…éšœ
ä¼˜åŠ¿ï¼šæ—©å‘ç°æ—©å¤„ç†ï¼Œç”¨æˆ·æ— æ„ŸçŸ¥
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦æ€§èƒ½ç›‘æ§


**æ ¸å¿ƒä»·å€¼ï¼š**
- ğŸ” **åŠæ—¶å‘ç°é—®é¢˜** - ç³»ç»Ÿæ…¢äº†ã€æŒ‚äº†ï¼Œç¬¬ä¸€æ—¶é—´çŸ¥é“
- ğŸ“Š **äº†è§£è¿è¡ŒçŠ¶æ€** - CPUã€å†…å­˜ç”¨äº†å¤šå°‘ï¼Œå¿ƒé‡Œæœ‰æ•°
- ğŸš¨ **è‡ªåŠ¨å‘Šè­¦é€šçŸ¥** - å¼‚å¸¸æ—¶è‡ªåŠ¨å‘æ¶ˆæ¯ï¼Œä¸ç”¨ç›¯ç€å±å¹•
- ğŸ“ˆ **åˆ†æå†å²è¶‹åŠ¿** - æµé‡å¢é•¿è¶‹åŠ¿ï¼Œä¸ºæ‰©å®¹æä¾›ä¾æ®

**ç”Ÿæ´»åŒ–ç±»æ¯”ï¼š**
```
å°±åƒä½ å…³å¿ƒè‡ªå·±çš„å¥åº·ï¼š
â€¢ ä½“é‡ã€è¡€å‹ â†’ CPUã€å†…å­˜ä½¿ç”¨ç‡
â€¢ ä½“æ¸©ã€å¿ƒè·³ â†’ è¯·æ±‚å“åº”æ—¶é—´
â€¢ å®šæœŸä½“æ£€   â†’ ç›‘æ§æ•°æ®çœ‹æ¿
â€¢ èº«ä½“ä¸é€‚   â†’ ç³»ç»Ÿå‘Šè­¦é€šçŸ¥
```

### 1.3 ç›‘æ§ä½“ç³»æ¶æ„


**ä¸‰å¤§æ ¸å¿ƒç»„ä»¶ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         å¾®æœåŠ¡ç½‘å…³ï¼ˆè¢«ç›‘æ§å¯¹è±¡ï¼‰          â”‚
â”‚    æš´éœ²æŒ‡æ ‡æ•°æ®ï¼ˆè®¿é—®é‡ã€å“åº”æ—¶é—´ç­‰ï¼‰      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ å®šæœŸé‡‡é›†
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Prometheusï¼ˆæ•°æ®é‡‡é›†ä¸å­˜å‚¨ï¼‰          â”‚
â”‚   â€¢ å®šæ—¶æ‹‰å–æŒ‡æ ‡æ•°æ®                      â”‚
â”‚   â€¢ å­˜å‚¨æ—¶åºæ•°æ®                         â”‚
â”‚   â€¢ æä¾›æŸ¥è¯¢æ¥å£                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ æ•°æ®æŸ¥è¯¢
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
          â†“                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Grafanaå¯è§†åŒ–    â”‚  â”‚  å‘Šè­¦è§„åˆ™å¼•æ“    â”‚
â”‚ â€¢ å›¾è¡¨å±•ç¤º       â”‚  â”‚  â€¢ æ£€æŸ¥é˜ˆå€¼      â”‚
â”‚ â€¢ ä»ªè¡¨ç›˜         â”‚  â”‚  â€¢ è§¦å‘å‘Šè­¦      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â†“
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚   å‘Šè­¦é€šçŸ¥æ¸ é“    â”‚
                      â”‚ â€¢ é’‰é’‰ç¾¤æ¶ˆæ¯      â”‚
                      â”‚ â€¢ é‚®ä»¶é€šçŸ¥        â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸ“Š PrometheusæŒ‡æ ‡æ”¶é›†


### 2.1 Prometheusæ˜¯ä»€ä¹ˆ


**ç®€å•ç†è§£ï¼šä¸€ä¸ªä¸“é—¨æ”¶é›†å’Œå­˜å‚¨ç›‘æ§æ•°æ®çš„"æ•°æ®åº“"**

Prometheusä¸æ˜¯æ™®é€šæ•°æ®åº“ï¼Œå®ƒä¸“é—¨ä¸ºç›‘æ§æ•°æ®è®¾è®¡ï¼Œæ“…é•¿å¤„ç†æ—¶é—´åºåˆ—æ•°æ®ï¼ˆéšæ—¶é—´å˜åŒ–çš„æ•°æ®ï¼Œæ¯”å¦‚æ¯åˆ†é’Ÿçš„è¯·æ±‚é‡ï¼‰ã€‚

**å·¥ä½œæ–¹å¼ï¼š**
```
å®šæ—¶ä»»åŠ¡ï¼ˆé»˜è®¤15ç§’ä¸€æ¬¡ï¼‰ï¼š
1. Prometheusä¸»åŠ¨å»ç½‘å…³æ‹‰å–æŒ‡æ ‡æ•°æ®
2. å­˜å‚¨åˆ°è‡ªå·±çš„æ—¶åºæ•°æ®åº“
3. ç­‰å¾…è¢«æŸ¥è¯¢æˆ–è§¦å‘å‘Šè­¦è§„åˆ™

ç±»æ¯”ï¼šå°±åƒé“¶è¡Œæ¯å¤©è‡ªåŠ¨è®°å½•ä½ çš„è´¦æˆ·ä½™é¢å˜åŒ–
```

### 2.2 é›†æˆPrometheusåˆ°ç½‘å…³


**æ­¥éª¤1ï¼šæ·»åŠ ä¾èµ–**

åœ¨ç½‘å…³é¡¹ç›®çš„`pom.xml`ä¸­åŠ å…¥ï¼š

```xml
<!-- Spring Bootç›‘æ§ä¾èµ– -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>

<!-- PrometheusæŒ‡æ ‡æ ¼å¼æ”¯æŒ -->
<dependency>
    <groupId>io.micrometer</groupId>
    <artifactId>micrometer-registry-prometheus</artifactId>
</dependency>
```

ğŸ’¡ **å«ä¹‰è§£é‡Šï¼š**
- `actuator` - Spring Bootå†…ç½®çš„ç›‘æ§ç«¯ç‚¹ï¼Œè‡ªåŠ¨æš´éœ²å„ç§æŒ‡æ ‡
- `micrometer` - æŒ‡æ ‡æ•°æ®çš„"ç¿»è¯‘å™¨"ï¼ŒæŠŠJavaæŒ‡æ ‡è½¬æˆPrometheusèƒ½ç†è§£çš„æ ¼å¼

**æ­¥éª¤2ï¼šé…ç½®æ–‡ä»¶å¼€å¯æŒ‡æ ‡æš´éœ²**

```yaml
# application.yml
management:
  endpoints:
    web:
      exposure:
        include: 'prometheus,health,info'  # æš´éœ²çš„ç›‘æ§ç«¯ç‚¹
  metrics:
    tags:
      application: ${spring.application.name}  # ç»™æ‰€æœ‰æŒ‡æ ‡æ‰“ä¸Šåº”ç”¨åæ ‡ç­¾
```

**æ­¥éª¤3ï¼šè®¿é—®æŒ‡æ ‡æ•°æ®**

å¯åŠ¨ç½‘å…³åï¼Œè®¿é—®ï¼š`http://localhost:8080/actuator/prometheus`

ä½ ä¼šçœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„æ•°æ®ï¼š
```
# è¯·æ±‚æ€»æ•°
http_server_requests_seconds_count{method="GET",status="200",uri="/api/user"} 1523

# JVMå†…å­˜ä½¿ç”¨
jvm_memory_used_bytes{area="heap",id="PS Eden Space"} 157286400

# CPUä½¿ç”¨ç‡
process_cpu_usage 0.25
```

### 2.3 å¸¸ç”¨æŒ‡æ ‡ç±»å‹


**ğŸ”¹ Counterï¼ˆè®¡æ•°å™¨ï¼‰- åªå¢ä¸å‡çš„æ•°å­—**
```
ç”¨é€”ï¼šç»Ÿè®¡ç´¯è®¡å€¼
ç¤ºä¾‹ï¼š
â€¢ è¯·æ±‚æ€»æ•°
â€¢ é”™è¯¯æ€»æ•°
â€¢ å¤„ç†çš„æ¶ˆæ¯æ€»æ•°

ä»£ç ç¤ºä¾‹ï¼š
Counter requestCounter = Counter.builder("gateway.requests.total")
    .description("ç½‘å…³è¯·æ±‚æ€»æ•°")
    .tag("method", "GET")  // å¯ä»¥åŠ æ ‡ç­¾åˆ†ç±»
    .register(meterRegistry);

requestCounter.increment();  // æ¯æ¬¡è¯·æ±‚+1
```

**ğŸ”¹ Gaugeï¼ˆä»ªè¡¨ï¼‰- å¯å¢å¯å‡çš„æ•°å­—**
```
ç”¨é€”ï¼šå½“å‰çŠ¶æ€å€¼
ç¤ºä¾‹ï¼š
â€¢ å½“å‰å†…å­˜ä½¿ç”¨é‡
â€¢ åœ¨çº¿ç”¨æˆ·æ•°
â€¢ é˜Ÿåˆ—é•¿åº¦

ä»£ç ç¤ºä¾‹ï¼š
Gauge.builder("gateway.active.connections", () -> connectionPool.size())
    .description("å½“å‰æ´»è·ƒè¿æ¥æ•°")
    .register(meterRegistry);
```

**ğŸ”¹ Histogramï¼ˆç›´æ–¹å›¾ï¼‰- ç»Ÿè®¡åˆ†å¸ƒæƒ…å†µ**
```
ç”¨é€”ï¼šè§‚å¯Ÿæ•°å€¼åˆ†å¸ƒ
ç¤ºä¾‹ï¼š
â€¢ å“åº”æ—¶é—´åˆ†å¸ƒï¼ˆå¤šå°‘è¯·æ±‚åœ¨100mså†…ï¼Œå¤šå°‘åœ¨500mså†…ï¼‰
â€¢ è¯·æ±‚å¤§å°åˆ†å¸ƒ

Prometheusä¼šè‡ªåŠ¨è®¡ç®—ï¼š
â€¢ å¹³å‡å€¼
â€¢ ç™¾åˆ†ä½æ•°ï¼ˆP50ã€P90ã€P99ï¼‰
â€¢ æœ€å¤§æœ€å°å€¼
```

**ğŸ”¹ Summaryï¼ˆæ‘˜è¦ï¼‰- ç±»ä¼¼ç›´æ–¹å›¾**
```
ç”¨é€”ï¼šç»Ÿè®¡æ€»ç»“
åŒºåˆ«ï¼šSummaryåœ¨å®¢æˆ·ç«¯è®¡ç®—ï¼ŒHistogramåœ¨æœåŠ¡ç«¯è®¡ç®—
```

### 2.4 è‡ªå®šä¹‰ä¸šåŠ¡æŒ‡æ ‡


**åœºæ™¯ï¼šç›‘æ§æŸä¸ªç‰¹å®šæ¥å£çš„è°ƒç”¨æƒ…å†µ**

```java
@Component
public class GatewayMetrics {
    
    private final Counter orderRequestCounter;
    private final Timer orderResponseTimer;
    
    public GatewayMetrics(MeterRegistry registry) {
        // ç»Ÿè®¡è®¢å•æ¥å£è¯·æ±‚æ•°
        this.orderRequestCounter = Counter.builder("gateway.order.requests")
            .description("è®¢å•æ¥å£è¯·æ±‚æ€»æ•°")
            .tag("service", "order-service")
            .register(registry);
        
        // ç»Ÿè®¡è®¢å•æ¥å£å“åº”æ—¶é—´
        this.orderResponseTimer = Timer.builder("gateway.order.response.time")
            .description("è®¢å•æ¥å£å“åº”æ—¶é—´")
            .register(registry);
    }
    
    // åœ¨ç½‘å…³è¿‡æ»¤å™¨ä¸­ä½¿ç”¨
    public void recordOrderRequest() {
        orderRequestCounter.increment();
    }
    
    public void recordOrderResponse(long startTime) {
        orderResponseTimer.record(Duration.ofMillis(
            System.currentTimeMillis() - startTime
        ));
    }
}
```

ğŸ’¡ **é€šä¿—ç†è§£ï¼š**
- Counterå°±åƒè®¡æ•°å™¨ï¼Œæ¯æ¬¡è¯·æ±‚ç‚¹å‡»ä¸€æ¬¡
- Timerå°±åƒç§’è¡¨ï¼Œè®°å½•æ¯ä¸ªè¯·æ±‚èŠ±äº†å¤šé•¿æ—¶é—´

---

## 3. ğŸ“ˆ Grafanaå¯è§†åŒ–é¢æ¿


### 3.1 Grafanaæ˜¯ä»€ä¹ˆ


**ç®€å•ç†è§£ï¼šæŠŠæ¯ç‡¥çš„æ•°å­—å˜æˆå¥½çœ‹çš„å›¾è¡¨**

Prometheusæ”¶é›†äº†ä¸€å †æ•°å­—æ•°æ®ï¼Œä½†ç›´æ¥çœ‹æ•°å­—å¾ˆéš¾ç†è§£ã€‚Grafanaå°±åƒExcelçš„å›¾è¡¨åŠŸèƒ½ï¼ŒæŠŠæ•°æ®ç”»æˆçº¿å›¾ã€æŸ±çŠ¶å›¾ã€ä»ªè¡¨ç›˜ï¼Œä¸€çœ¼å°±èƒ½çœ‹æ‡‚ã€‚

```
æ²¡æœ‰Grafanaï¼š
http_requests_total 1523
http_requests_total 1689
http_requests_total 1847
â†‘ è¿™äº›æ•°å­—å¾ˆéš¾çœ‹å‡ºè¶‹åŠ¿

æœ‰äº†Grafanaï¼š
  è¯·æ±‚é‡
   â†‘ 
2000|        ï¼ï¿£
1500|    ï¼ï¿£
1000|ï¼ï¿£
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ æ—¶é—´
â†‘ ä¸€çœ¼å°±çœ‹å‡ºæµé‡åœ¨å¢é•¿
```

### 3.2 GrafanaåŸºç¡€é…ç½®


**æ­¥éª¤1ï¼šå®‰è£…Grafanaï¼ˆDockeræ–¹å¼æœ€ç®€å•ï¼‰**

```bash
# ä¸‹è½½å¹¶å¯åŠ¨Grafanaå®¹å™¨
docker run -d \
  --name=grafana \
  -p 3000:3000 \
  grafana/grafana
```

è®¿é—® `http://localhost:3000`ï¼Œé»˜è®¤è´¦å·å¯†ç éƒ½æ˜¯ `admin`

**æ­¥éª¤2ï¼šæ·»åŠ Prometheusæ•°æ®æº**

```
åœ¨Grafanaç•Œé¢æ“ä½œï¼š
1. ç‚¹å‡»å·¦ä¾§é½¿è½®å›¾æ ‡ â†’ Data Sources
2. ç‚¹å‡» Add data source â†’ é€‰æ‹©Prometheus
3. å¡«å†™URLï¼šhttp://localhost:9090ï¼ˆä½ çš„Prometheusåœ°å€ï¼‰
4. ç‚¹å‡» Save & Test
```

### 3.3 åˆ›å»ºç›‘æ§é¢æ¿


**åœºæ™¯ï¼šä¸ºç½‘å…³åˆ›å»ºä¸€ä¸ªç›‘æ§å¤§å±**

**é¢æ¿1ï¼šè¯·æ±‚é‡è¶‹åŠ¿å›¾**
```
å›¾è¡¨ç±»å‹ï¼šæ—¶é—´åºåˆ—å›¾ï¼ˆæŠ˜çº¿å›¾ï¼‰
æŸ¥è¯¢è¯­å¥ï¼š
sum(rate(http_server_requests_seconds_count[1m])) by (uri)

è§£é‡Šï¼š
â€¢ rate(...[1m])ï¼šè®¡ç®—1åˆ†é’Ÿå†…çš„å¢é•¿é€Ÿç‡
â€¢ sum(...) by (uri)ï¼šæŒ‰æ¥å£è·¯å¾„åˆ†ç»„ç»Ÿè®¡
â€¢ ç»“æœï¼šæ¯ä¸ªæ¥å£æ¯ç§’çš„è¯·æ±‚é‡

æ˜¾ç¤ºæ•ˆæœï¼š
/api/user    â”€â”€â”€â”€â”€â”€ (è“çº¿)
/api/order   Â·Â·Â·Â·Â·Â· (çº¢çº¿)
/api/product â”€ â”€ â”€ (ç»¿çº¿)
```

**é¢æ¿2ï¼šå“åº”æ—¶é—´åˆ†ä½å›¾**
```
å›¾è¡¨ç±»å‹ï¼šä»ªè¡¨ç›˜
æŸ¥è¯¢è¯­å¥ï¼š
histogram_quantile(0.99, 
  sum(rate(http_server_requests_seconds_bucket[5m])) by (le)
)

è§£é‡Šï¼š
â€¢ histogram_quantile(0.99, ...)ï¼šè®¡ç®—99%åˆ†ä½æ•°
â€¢ æ„æ€ï¼š99%çš„è¯·æ±‚å“åº”æ—¶é—´åœ¨è¿™ä¸ªå€¼ä»¥ä¸‹

æ˜¾ç¤ºæ•ˆæœï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    150ms    â”‚  â† å¦‚æœæ˜¯ç»¿è‰²è¡¨ç¤ºæ­£å¸¸
â”‚   â—â”€â”€â”€â”€â”€    â”‚  â† å¦‚æœæ˜¯çº¢è‰²è¡¨ç¤ºæ…¢
â”‚   P99å“åº”   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é¢æ¿3ï¼šé”™è¯¯ç‡ç»Ÿè®¡**
```
å›¾è¡¨ç±»å‹ï¼šå•å€¼é¢æ¿
æŸ¥è¯¢è¯­å¥ï¼š
sum(rate(http_server_requests_seconds_count{status=~"5.."}[5m])) 
/ 
sum(rate(http_server_requests_seconds_count[5m])) * 100

è§£é‡Šï¼š
â€¢ status=~"5.."ï¼šåŒ¹é…æ‰€æœ‰5xxé”™è¯¯çŠ¶æ€ç 
â€¢ åˆ†å­ï¼š5xxé”™è¯¯çš„é€Ÿç‡
â€¢ åˆ†æ¯ï¼šæ€»è¯·æ±‚é€Ÿç‡
â€¢ *100ï¼šè½¬æˆç™¾åˆ†æ¯”

æ˜¾ç¤ºæ•ˆæœï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   0.5%      â”‚  â† é”™è¯¯ç‡
â”‚   é”™è¯¯ç‡    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.4 å¯¼å…¥å®˜æ–¹æ¨¡æ¿


**å¿«é€Ÿä¸Šæ‰‹ï¼šä½¿ç”¨ç°æˆçš„Dashboardæ¨¡æ¿**

```
æ“ä½œæ­¥éª¤ï¼š
1. è®¿é—® https://grafana.com/grafana/dashboards/
2. æœç´¢ "Spring Boot" æˆ– "Gateway"
3. æ‰¾åˆ°åˆé€‚çš„æ¨¡æ¿ï¼Œè®°ä½IDå·ï¼ˆæ¯”å¦‚ï¼š12900ï¼‰
4. åœ¨Grafanaä¸­ï¼š
   å·¦ä¾§ + å· â†’ Import â†’ è¾“å…¥ID â†’ Load
   é€‰æ‹©æ•°æ®æº â†’ Import

æ¨èæ¨¡æ¿ï¼š
â€¢ ID 4701ï¼šJVMç›‘æ§ï¼ˆå†…å­˜ã€çº¿ç¨‹ã€GCï¼‰
â€¢ ID 11378ï¼šSpring Bootåº”ç”¨ç›‘æ§
â€¢ ID 12900ï¼šSpring Cloud Gatewayä¸“ç”¨
```

---

## 4. ğŸš¨ å‘Šè­¦è§„åˆ™é…ç½®


### 4.1 å‘Šè­¦çš„æ„ä¹‰


**é€šä¿—ç†è§£ï¼šè®©ç³»ç»Ÿåœ¨å‡ºé—®é¢˜æ—¶ä¸»åŠ¨"å–Šä½ "**

```
æ²¡æœ‰å‘Šè­¦çš„åœºæ™¯ï¼š
å‡Œæ™¨3ç‚¹ç³»ç»ŸæŒ‚äº† â†’ æ—©ä¸Š9ç‚¹ç”¨æˆ·æŠ•è¯‰ â†’ ä½ æ‰çŸ¥é“
ç»“æœï¼šå½±å“äº†6å°æ—¶

æœ‰å‘Šè­¦çš„åœºæ™¯ï¼š
å‡Œæ™¨3ç‚¹ç³»ç»ŸæŒ‚äº† â†’ 1åˆ†é’Ÿåæ‰‹æœºæ”¶åˆ°é’‰é’‰æ¶ˆæ¯ â†’ ç«‹å³å¤„ç†
ç»“æœï¼šå‡ åˆ†é’Ÿå†…æ¢å¤
```

### 4.2 Prometheuså‘Šè­¦è§„åˆ™


**åœ¨Prometheusä¸­å®šä¹‰å‘Šè­¦è§„åˆ™æ–‡ä»¶ï¼š`alert_rules.yml`**

```yaml
groups:
  - name: gateway_alerts  # å‘Šè­¦ç»„åç§°
    interval: 30s         # æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
    rules:
      # è§„åˆ™1ï¼šé«˜é”™è¯¯ç‡å‘Šè­¦
      - alert: HighErrorRate
        expr: |
          sum(rate(http_server_requests_seconds_count{status=~"5.."}[5m])) 
          / 
          sum(rate(http_server_requests_seconds_count[5m])) > 0.05
        for: 2m  # æŒç»­2åˆ†é’Ÿæ‰è§¦å‘ï¼Œé¿å…è¯¯æŠ¥
        labels:
          severity: critical  # ä¸¥é‡ç¨‹åº¦
          service: gateway
        annotations:
          summary: "ç½‘å…³é”™è¯¯ç‡è¿‡é«˜"
          description: "å½“å‰é”™è¯¯ç‡ {{ $value | humanizePercentage }}ï¼Œè¶…è¿‡5%é˜ˆå€¼"
      
      # è§„åˆ™2ï¼šå“åº”æ—¶é—´è¿‡æ…¢
      - alert: SlowResponse
        expr: |
          histogram_quantile(0.99,
            sum(rate(http_server_requests_seconds_bucket[5m])) by (le)
          ) > 1
        for: 5m
        labels:
          severity: warning
          service: gateway
        annotations:
          summary: "ç½‘å…³å“åº”è¿‡æ…¢"
          description: "P99å“åº”æ—¶é—´ {{ $value }}ç§’ï¼Œè¶…è¿‡1ç§’é˜ˆå€¼"
      
      # è§„åˆ™3ï¼šè¯·æ±‚é‡æ¿€å¢
      - alert: HighTraffic
        expr: |
          sum(rate(http_server_requests_seconds_count[1m])) > 1000
        for: 3m
        labels:
          severity: warning
          service: gateway
        annotations:
          summary: "æµé‡æ¿€å¢"
          description: "å½“å‰QPS {{ $value }}ï¼Œè¶…è¿‡æ­£å¸¸æ°´å¹³"
```

ğŸ’¡ **è§„åˆ™è¦ç´ è§£é‡Šï¼š**
- `expr` - å‘Šè­¦æ¡ä»¶è¡¨è¾¾å¼ï¼Œä¸ºtrueæ—¶è§¦å‘
- `for` - æŒç»­æ—¶é—´ï¼Œé¿å…çŸ­æš‚æŠ–åŠ¨è§¦å‘å‘Šè­¦
- `labels` - æ ‡ç­¾ï¼Œç”¨äºåˆ†ç±»å’Œè·¯ç”±å‘Šè­¦
- `annotations` - å‘Šè­¦æè¿°ä¿¡æ¯ï¼Œå‘é€ç»™æ¥æ”¶è€…

**åœ¨Prometheusé…ç½®ä¸­å¼•å…¥è§„åˆ™æ–‡ä»¶ï¼š**

```yaml
# prometheus.yml
rule_files:
  - "alert_rules.yml"

alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - 'localhost:9093'  # Alertmanageråœ°å€
```

### 4.3 AlertManageré…ç½®


**AlertManageræ˜¯å‘Šè­¦è·¯ç”±å™¨ï¼Œå†³å®šå‘Šè­¦å‘ç»™è°**

é…ç½®æ–‡ä»¶ï¼š`alertmanager.yml`

```yaml
global:
  resolve_timeout: 5m  # å‘Šè­¦æ¢å¤åç­‰å¾…æ—¶é—´

route:
  group_by: ['alertname', 'service']  # æŒ‰è¿™äº›æ ‡ç­¾åˆ†ç»„
  group_wait: 10s       # æ”¶åˆ°å‘Šè­¦åç­‰å¾…10ç§’ï¼Œçœ‹æ˜¯å¦æœ‰ç›¸åŒå‘Šè­¦ä¸€èµ·å‘
  group_interval: 10s   # åŒä¸€ç»„å‘Šè­¦é—´éš”10ç§’å‘é€ä¸€æ¬¡
  repeat_interval: 1h   # é‡å¤å‘Šè­¦é—´éš”1å°æ—¶
  receiver: 'default'   # é»˜è®¤æ¥æ”¶è€…
  
  routes:
    # ä¸¥é‡å‘Šè­¦ç«‹å³å‘é€
    - match:
        severity: critical
      receiver: 'critical-team'
      group_wait: 0s
      
    # è­¦å‘Šçº§åˆ«çš„å‘Šè­¦å‘ç»™å¼€å‘ç»„
    - match:
        severity: warning
      receiver: 'dev-team'

receivers:
  - name: 'default'
    webhook_configs:
      - url: 'http://localhost:8060/webhook'  # åé¢ä¼šé…ç½®é’‰é’‰webhook
  
  - name: 'critical-team'
    webhook_configs:
      - url: 'http://localhost:8060/webhook/critical'
  
  - name: 'dev-team'
    webhook_configs:
      - url: 'http://localhost:8060/webhook/dev'
```

---

## 5. ğŸ’¬ é’‰é’‰å‘Šè­¦é›†æˆ


### 5.1 ä¸ºä»€ä¹ˆé€‰æ‹©é’‰é’‰


**å®é™…åœºæ™¯è€ƒè™‘ï¼š**
- âœ… å›¢é˜Ÿéƒ½åœ¨ç”¨é’‰é’‰æ²Ÿé€šï¼Œæ”¶åˆ°å¿«
- âœ… æ”¯æŒç¾¤æœºå™¨äººï¼Œé…ç½®ç®€å•
- âœ… æ¶ˆæ¯æ”¯æŒ@ç‰¹å®šäºº
- âœ… ç§»åŠ¨ç«¯é€šçŸ¥åŠæ—¶

### 5.2 åˆ›å»ºé’‰é’‰æœºå™¨äºº


**æ­¥éª¤1ï¼šåœ¨é’‰é’‰ç¾¤ä¸­æ·»åŠ æœºå™¨äºº**

```
æ“ä½œæµç¨‹ï¼š
1. æ‰“å¼€é’‰é’‰ç¾¤ â†’ å³ä¸Šè§’è®¾ç½® â†’ æ™ºèƒ½ç¾¤åŠ©æ‰‹
2. æ·»åŠ æœºå™¨äºº â†’ è‡ªå®šä¹‰æœºå™¨äºº
3. è®¾ç½®åç§°ï¼šç½‘å…³å‘Šè­¦æœºå™¨äºº
4. å®‰å…¨è®¾ç½®ï¼šé€‰æ‹©"åŠ ç­¾"æ–¹å¼
5. å¤åˆ¶Webhookåœ°å€å’Œå¯†é’¥
```

**å¾—åˆ°çš„ä¿¡æ¯ï¼š**
```
Webhook URL: 
https://oapi.dingtalk.com/robot/send?access_token=xxxxx

Secretå¯†é’¥ï¼š
SECxxxxxxxxxxxxxxxxxxxxxx
```

### 5.3 ç¼–å†™å‘Šè­¦è½¬å‘æœåŠ¡


**åˆ›å»ºä¸€ä¸ªSpring BootæœåŠ¡æ¥æ”¶Prometheuså‘Šè­¦å¹¶è½¬å‘åˆ°é’‰é’‰ï¼š**

```java
@RestController
@RequestMapping("/webhook")
public class AlertWebhookController {
    
    @Value("${dingtalk.webhook.url}")
    private String webhookUrl;
    
    @Value("${dingtalk.webhook.secret}")
    private String secret;
    
    private final RestTemplate restTemplate = new RestTemplate();
    
    @PostMapping
    public void handleAlert(@RequestBody PrometheusAlert alert) {
        // æ„é€ é’‰é’‰æ¶ˆæ¯æ ¼å¼
        DingTalkMessage message = buildMessage(alert);
        
        // è®¡ç®—ç­¾å
        String sign = calculateSign();
        
        // å‘é€åˆ°é’‰é’‰
        String url = webhookUrl + "&timestamp=" + System.currentTimeMillis() 
                     + "&sign=" + sign;
        restTemplate.postForEntity(url, message, String.class);
    }
    
    private DingTalkMessage buildMessage(PrometheusAlert alert) {
        StringBuilder content = new StringBuilder();
        content.append("### ğŸš¨ å‘Šè­¦é€šçŸ¥\n\n");
        content.append("**å‘Šè­¦åç§°ï¼š** ").append(alert.getAlertName()).append("\n\n");
        content.append("**ä¸¥é‡ç¨‹åº¦ï¼š** ").append(alert.getSeverity()).append("\n\n");
        content.append("**å‘Šè­¦æè¿°ï¼š** ").append(alert.getDescription()).append("\n\n");
        content.append("**è§¦å‘æ—¶é—´ï¼š** ").append(alert.getStartTime()).append("\n\n");
        
        // @ ç›¸å…³äººå‘˜
        if ("critical".equals(alert.getSeverity())) {
            content.append("@æ‰€æœ‰äºº");
        }
        
        DingTalkMessage message = new DingTalkMessage();
        message.setMsgtype("markdown");
        message.setMarkdown(new Markdown("å‘Šè­¦é€šçŸ¥", content.toString()));
        return message;
    }
    
    private String calculateSign() {
        // é’‰é’‰è¦æ±‚çš„ç­¾åç®—æ³•
        long timestamp = System.currentTimeMillis();
        String stringToSign = timestamp + "\n" + secret;
        try {
            Mac mac = Mac.getInstance("HmacSHA256");
            mac.init(new SecretKeySpec(secret.getBytes(), "HmacSHA256"));
            byte[] signData = mac.doFinal(stringToSign.getBytes());
            return URLEncoder.encode(Base64.getEncoder().encodeToString(signData), "UTF-8");
        } catch (Exception e) {
            throw new RuntimeException("ç­¾åè®¡ç®—å¤±è´¥", e);
        }
    }
}
```

**æ¶ˆæ¯æ•ˆæœï¼š**
```
ğŸš¨ å‘Šè­¦é€šçŸ¥

å‘Šè­¦åç§°ï¼š HighErrorRate
ä¸¥é‡ç¨‹åº¦ï¼š critical
å‘Šè­¦æè¿°ï¼š å½“å‰é”™è¯¯ç‡5.8%ï¼Œè¶…è¿‡5%é˜ˆå€¼
è§¦å‘æ—¶é—´ï¼š 2024-01-15 14:30:25

@æ‰€æœ‰äºº
```

### 5.4 é…ç½®æ–‡ä»¶


```yaml
# application.yml
dingtalk:
  webhook:
    url: https://oapi.dingtalk.com/robot/send?access_token=xxxxx
    secret: SECxxxxxxxxxxxxxxxxxxxxxx
```

---

## 6. ğŸ“§ é‚®ä»¶å‘Šè­¦é…ç½®


### 6.1 é‚®ä»¶å‘Šè­¦åœºæ™¯


**é€‚ç”¨åœºæ™¯ï¼š**
- éç´§æ€¥å‘Šè­¦ï¼ˆwarningçº§åˆ«ï¼‰
- æ¯æ—¥æŠ¥è¡¨å‘é€
- è¯¦ç»†çš„å‘Šè­¦æŠ¥å‘Šï¼ˆé‚®ä»¶å¯ä»¥æ”¾æ›´å¤šä¿¡æ¯ï¼‰

### 6.2 Spring Booté‚®ä»¶é…ç½®


**æ­¥éª¤1ï¼šæ·»åŠ ä¾èµ–**

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-mail</artifactId>
</dependency>
```

**æ­¥éª¤2ï¼šé…ç½®é‚®ä»¶æœåŠ¡**

```yaml
spring:
  mail:
    host: smtp.qq.com        # QQé‚®ç®±SMTPæœåŠ¡å™¨
    port: 587
    username: your@qq.com    # ä½ çš„é‚®ç®±
    password:æˆæƒç           # ä¸æ˜¯é‚®ç®±å¯†ç ï¼Œæ˜¯SMTPæˆæƒç 
    properties:
      mail:
        smtp:
          auth: true
          starttls:
            enable: true
            required: true
```

ğŸ’¡ **è·å–QQé‚®ç®±æˆæƒç ï¼š**
```
1. ç™»å½•QQé‚®ç®±ç½‘é¡µç‰ˆ
2. è®¾ç½® â†’ è´¦æˆ· â†’ POP3/IMAP/SMTPæœåŠ¡
3. å¼€å¯æœåŠ¡ â†’ ç”Ÿæˆæˆæƒç 
```

### 6.3 é‚®ä»¶å‘Šè­¦å®ç°


```java
@Service
public class EmailAlertService {
    
    @Autowired
    private JavaMailSender mailSender;
    
    @Value("${alert.email.to}")
    private String alertEmailTo;
    
    public void sendAlertEmail(PrometheusAlert alert) {
        try {
            MimeMessage message = mailSender.createMimeMessage();
            MimeMessageHelper helper = new MimeMessageHelper(message, true, "UTF-8");
            
            helper.setFrom("your@qq.com");
            helper.setTo(alertEmailTo.split(","));  // æ”¯æŒå¤šä¸ªæ”¶ä»¶äºº
            helper.setSubject("ğŸš¨ ç½‘å…³å‘Šè­¦ - " + alert.getAlertName());
            
            // HTMLé‚®ä»¶å†…å®¹
            String htmlContent = buildHtmlContent(alert);
            helper.setText(htmlContent, true);
            
            mailSender.send(message);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    private String buildHtmlContent(PrometheusAlert alert) {
        return """
            <html>
            <body style="font-family: Arial;">
                <h2 style="color: #e74c3c;">å‘Šè­¦é€šçŸ¥</h2>
                <table border="1" cellpadding="10" style="border-collapse: collapse;">
                    <tr>
                        <td><strong>å‘Šè­¦åç§°</strong></td>
                        <td>%s</td>
                    </tr>
                    <tr>
                        <td><strong>ä¸¥é‡ç¨‹åº¦</strong></td>
                        <td style="color: %s;">%s</td>
                    </tr>
                    <tr>
                        <td><strong>å‘Šè­¦æè¿°</strong></td>
                        <td>%s</td>
                    </tr>
                    <tr>
                        <td><strong>è§¦å‘æ—¶é—´</strong></td>
                        <td>%s</td>
                    </tr>
                </table>
                <p style="margin-top: 20px;">
                    <a href="http://grafana.example.com" style="background-color: #3498db; color: white; padding: 10px 20px; text-decoration: none;">
                        æŸ¥çœ‹ç›‘æ§é¢æ¿
                    </a>
                </p>
            </body>
            </html>
            """.formatted(
                alert.getAlertName(),
                "critical".equals(alert.getSeverity()) ? "red" : "orange",
                alert.getSeverity(),
                alert.getDescription(),
                alert.getStartTime()
            );
    }
}
```

### 6.4 å‘Šè­¦è·¯ç”±ç­–ç•¥


**æ ¹æ®ä¸¥é‡ç¨‹åº¦å†³å®šé€šçŸ¥æ–¹å¼ï¼š**

```java
@Service
public class AlertRouter {
    
    @Autowired
    private AlertWebhookController dingTalkAlert;
    
    @Autowired
    private EmailAlertService emailAlert;
    
    public void routeAlert(PrometheusAlert alert) {
        switch (alert.getSeverity()) {
            case "critical":
                // ä¸¥é‡å‘Šè­¦ï¼šé’‰é’‰ç«‹å³é€šçŸ¥ + é‚®ä»¶
                dingTalkAlert.handleAlert(alert);
                emailAlert.sendAlertEmail(alert);
                break;
                
            case "warning":
                // è­¦å‘Šçº§åˆ«ï¼šåªå‘é‚®ä»¶
                emailAlert.sendAlertEmail(alert);
                break;
                
            default:
                // ä¿¡æ¯çº§åˆ«ï¼šåªè®°å½•æ—¥å¿—
                log.info("æ”¶åˆ°å‘Šè­¦ï¼š{}", alert);
        }
    }
}
```

---

## 7. ğŸ¯ å…³é”®æŒ‡æ ‡ç›‘æ§


### 7.1 æ ¸å¿ƒç›‘æ§æŒ‡æ ‡ä½“ç³»


**ğŸ”¹ æµé‡æŒ‡æ ‡ï¼ˆTraffic Metricsï¼‰**

```
â€¢ QPSï¼ˆæ¯ç§’è¯·æ±‚æ•°ï¼‰
  æŸ¥è¯¢ï¼šsum(rate(http_server_requests_seconds_count[1m]))
  é˜ˆå€¼ï¼š> 1000 å‘Šè­¦
  
â€¢ è¯·æ±‚æ€»æ•°
  æŸ¥è¯¢ï¼šsum(http_server_requests_seconds_count)
  ç”¨é€”ï¼šäº†è§£æ€»ä½“è®¿é—®é‡
  
â€¢ å„æ¥å£æµé‡åˆ†å¸ƒ
  æŸ¥è¯¢ï¼šsum(rate(http_server_requests_seconds_count[5m])) by (uri)
  ç”¨é€”ï¼šæ‰¾å‡ºçƒ­ç‚¹æ¥å£
```

**ğŸ”¹ æ€§èƒ½æŒ‡æ ‡ï¼ˆPerformance Metricsï¼‰**

```
â€¢ P50å“åº”æ—¶é—´ï¼ˆä¸­ä½æ•°ï¼‰
  æŸ¥è¯¢ï¼šhistogram_quantile(0.5, sum(rate(...[5m])) by (le))
  æ„ä¹‰ï¼š50%çš„è¯·æ±‚åœ¨è¿™ä¸ªæ—¶é—´å†…å®Œæˆ
  
â€¢ P90å“åº”æ—¶é—´
  æŸ¥è¯¢ï¼šhistogram_quantile(0.9, sum(rate(...[5m])) by (le))
  æ„ä¹‰ï¼š90%çš„è¯·æ±‚åœ¨è¿™ä¸ªæ—¶é—´å†…å®Œæˆ
  
â€¢ P99å“åº”æ—¶é—´ï¼ˆå…³é”®æŒ‡æ ‡ï¼‰
  æŸ¥è¯¢ï¼šhistogram_quantile(0.99, sum(rate(...[5m])) by (le))
  é˜ˆå€¼ï¼š> 500ms å‘Šè­¦
  æ„ä¹‰ï¼š99%çš„è¯·æ±‚åœ¨è¿™ä¸ªæ—¶é—´å†…å®Œæˆï¼Œå‰©ä½™1%æ˜¯æ…¢è¯·æ±‚
```

ğŸ’¡ **ä¸ºä»€ä¹ˆå…³æ³¨P99è€Œä¸æ˜¯å¹³å‡å€¼ï¼Ÿ**
```
åœºæ™¯ï¼š100ä¸ªè¯·æ±‚
99ä¸ªç”¨æ—¶ï¼š100ms
1ä¸ªç”¨æ—¶ï¼š10000ms

å¹³å‡å€¼ï¼š(99*100 + 10000)/100 = 199ms  â† çœ‹èµ·æ¥è¿˜è¡Œ
P99å€¼ï¼š100ms                          â† æ›´çœŸå®åæ˜ ç”¨æˆ·ä½“éªŒ

ç»“è®ºï¼šå¹³å‡å€¼ä¼šè¢«æå€¼æ‹‰æ‰¯ï¼ŒP99æ›´èƒ½åæ˜ å¤§å¤šæ•°ç”¨æˆ·çš„çœŸå®ä½“éªŒ
```

**ğŸ”¹ é”™è¯¯æŒ‡æ ‡ï¼ˆError Metricsï¼‰**

```
â€¢ é”™è¯¯ç‡
  æŸ¥è¯¢ï¼š
  sum(rate(http_server_requests_seconds_count{status=~"5.."}[5m])) 
  / sum(rate(http_server_requests_seconds_count[5m]))
  
  é˜ˆå€¼ï¼š> 1% å‘Šè­¦
  
â€¢ å„çŠ¶æ€ç åˆ†å¸ƒ
  æŸ¥è¯¢ï¼šsum(rate(...[5m])) by (status)
  
  å¸¸è§çŠ¶æ€ç ï¼š
  200ï¼šæˆåŠŸ
  400ï¼šå®¢æˆ·ç«¯é”™è¯¯ï¼ˆå‚æ•°é”™è¯¯ç­‰ï¼‰
  401ï¼šæœªè®¤è¯
  403ï¼šæ— æƒé™
  404ï¼šæ¥å£ä¸å­˜åœ¨
  500ï¼šæœåŠ¡å™¨å†…éƒ¨é”™è¯¯
  502ï¼šç½‘å…³é”™è¯¯ï¼ˆåç«¯æœåŠ¡æŒ‚äº†ï¼‰
  503ï¼šæœåŠ¡ä¸å¯ç”¨
  504ï¼šç½‘å…³è¶…æ—¶
```

**ğŸ”¹ èµ„æºæŒ‡æ ‡ï¼ˆResource Metricsï¼‰**

```
â€¢ CPUä½¿ç”¨ç‡
  æŸ¥è¯¢ï¼šprocess_cpu_usage
  é˜ˆå€¼ï¼š> 80% å‘Šè­¦
  
â€¢ å†…å­˜ä½¿ç”¨ç‡
  æŸ¥è¯¢ï¼š
  jvm_memory_used_bytes / jvm_memory_max_bytes * 100
  é˜ˆå€¼ï¼š> 85% å‘Šè­¦
  
â€¢ å †å†…å­˜ä½¿ç”¨
  æŸ¥è¯¢ï¼šjvm_memory_used_bytes{area="heap"}
  
â€¢ GCé¢‘ç‡
  æŸ¥è¯¢ï¼šrate(jvm_gc_pause_seconds_count[1m])
  é˜ˆå€¼ï¼šé¢‘ç¹GCéœ€è¦å…³æ³¨
```

**ğŸ”¹ è¿æ¥æŒ‡æ ‡ï¼ˆConnection Metricsï¼‰**

```
â€¢ æ´»è·ƒè¿æ¥æ•°
  æŸ¥è¯¢ï¼štomcat_threads_busy_threads
  é˜ˆå€¼ï¼š> æœ€å¤§çº¿ç¨‹æ•°çš„80% å‘Šè­¦
  
â€¢ çº¿ç¨‹æ± ä½¿ç”¨ç‡
  æŸ¥è¯¢ï¼š
  tomcat_threads_busy_threads / tomcat_threads_config_max_threads
```

### 7.2 ç›‘æ§æŒ‡æ ‡é…ç½®è¡¨


| æŒ‡æ ‡åˆ†ç±» | æŒ‡æ ‡åç§° | æŸ¥è¯¢è¡¨è¾¾å¼ | å‘Šè­¦é˜ˆå€¼ | ä¸¥é‡ç¨‹åº¦ |
|---------|---------|-----------|---------|---------|
| **æµé‡** | QPS | `sum(rate(http_server_requests_seconds_count[1m]))` | > 1000 | warning |
| **æ€§èƒ½** | P99å“åº”æ—¶é—´ | `histogram_quantile(0.99, ...)` | > 500ms | warning |
| **æ€§èƒ½** | P99å“åº”æ—¶é—´ | `histogram_quantile(0.99, ...)` | > 1s | critical |
| **é”™è¯¯** | é”™è¯¯ç‡ | `sum(rate(...{status=~"5.."}[5m])) / sum(rate(...[5m]))` | > 1% | warning |
| **é”™è¯¯** | é”™è¯¯ç‡ | åŒä¸Š | > 5% | critical |
| **èµ„æº** | CPUä½¿ç”¨ç‡ | `process_cpu_usage * 100` | > 80% | warning |
| **èµ„æº** | å†…å­˜ä½¿ç”¨ç‡ | `jvm_memory_used_bytes/jvm_memory_max_bytes*100` | > 85% | warning |
| **è¿æ¥** | çº¿ç¨‹æ± ä½¿ç”¨ç‡ | `tomcat_threads_busy/tomcat_threads_max` | > 80% | warning |

### 7.3 ç›‘æ§å¤§ç›˜å¸ƒå±€å»ºè®®


**æ¨èçš„Grafanaé¢æ¿å¸ƒå±€ï¼š**

```
ç¬¬ä¸€è¡Œï¼ˆå…¨å±€æ¦‚è§ˆï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ€»QPS  â”‚ P99å“åº” â”‚ é”™è¯¯ç‡  â”‚ CPUä½¿ç”¨ â”‚
â”‚  1247   â”‚ 156ms   â”‚  0.3%   â”‚  45%    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¬¬äºŒè¡Œï¼ˆæµé‡è¶‹åŠ¿ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        QPSè¶‹åŠ¿å›¾ï¼ˆè¿‡å»1å°æ—¶ï¼‰              â”‚
â”‚   â†‘                          ï¼ï¿£ï¼¼       â”‚
â”‚1500|                      ï¼      ï¼¼     â”‚
â”‚1000|                  ï¼ï¿£            ï¼¼   â”‚
â”‚ 500|             ï¼ï¿£                  ï¼¼ â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¬¬ä¸‰è¡Œï¼ˆæ€§èƒ½åˆ†æï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å“åº”æ—¶é—´åˆ†å¸ƒå›¾   â”‚   å„æ¥å£å“åº”æ—¶é—´      â”‚
â”‚                  â”‚  /api/user:  120ms   â”‚
â”‚  P50: 100ms      â”‚  /api/order: 280ms   â”‚
â”‚  P90: 200ms      â”‚  /api/product: 95ms  â”‚
â”‚  P99: 350ms      â”‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¬¬å››è¡Œï¼ˆé”™è¯¯åˆ†æï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  çŠ¶æ€ç åˆ†å¸ƒ       â”‚   é”™è¯¯æ—¥å¿—          â”‚
â”‚                  â”‚                      â”‚
â”‚  200: 95%        â”‚  æœ€è¿‘10æ¡é”™è¯¯...     â”‚
â”‚  404: 3%         â”‚                      â”‚
â”‚  500: 2%         â”‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ ç›‘æ§ä¸‰è¦ç´ ï¼šæŒ‡æ ‡æ”¶é›†ï¼ˆPrometheusï¼‰ + å¯è§†åŒ–ï¼ˆGrafanaï¼‰ + å‘Šè­¦é€šçŸ¥
ğŸ”¸ å››å¤§æŒ‡æ ‡ç±»å‹ï¼šCounterï¼ˆè®¡æ•°ï¼‰ã€Gaugeï¼ˆä»ªè¡¨ï¼‰ã€Histogramï¼ˆç›´æ–¹å›¾ï¼‰ã€Summaryï¼ˆæ‘˜è¦ï¼‰
ğŸ”¸ å‘Šè­¦ç­–ç•¥ï¼šæ ¹æ®ä¸¥é‡ç¨‹åº¦åˆ†çº§å¤„ç†ï¼Œé¿å…å‘Šè­¦ç–²åŠ³
ğŸ”¸ å…³é”®æŒ‡æ ‡ï¼šQPSã€P99å“åº”æ—¶é—´ã€é”™è¯¯ç‡ã€CPU/å†…å­˜ä½¿ç”¨ç‡
ğŸ”¸ é€šçŸ¥æ–¹å¼ï¼šé’‰é’‰ï¼ˆç´§æ€¥ï¼‰+ é‚®ä»¶ï¼ˆè¯¦ç»†æŠ¥å‘Šï¼‰
```

### 8.2 å®æ–½ç›‘æ§çš„å®Œæ•´æµç¨‹


**æ­¥éª¤æ¸…å•ï¼š**

```markdown
âœ… **ç¬¬ä¸€æ­¥ï¼šé›†æˆPrometheus**
- [ ] æ·»åŠ actuatorå’Œmicrometerä¾èµ–
- [ ] é…ç½®æš´éœ²/actuator/prometheusç«¯ç‚¹
- [ ] éªŒè¯æŒ‡æ ‡æ•°æ®å¯è®¿é—®

âœ… **ç¬¬äºŒæ­¥ï¼šéƒ¨ç½²Prometheus**
- [ ] Dockerå¯åŠ¨Prometheuså®¹å™¨
- [ ] é…ç½®prometheus.ymlæŒ‡å®šæŠ“å–ç›®æ ‡
- [ ] è®¿é—®Prometheus UIéªŒè¯æ•°æ®é‡‡é›†

âœ… **ç¬¬ä¸‰æ­¥ï¼šé…ç½®Grafana**
- [ ] å¯åŠ¨Grafanaå¹¶æ·»åŠ Prometheusæ•°æ®æº
- [ ] å¯¼å…¥å®˜æ–¹Dashboardæ¨¡æ¿
- [ ] æ ¹æ®éœ€è¦è‡ªå®šä¹‰é¢æ¿

âœ… **ç¬¬å››æ­¥ï¼šè®¾ç½®å‘Šè­¦è§„åˆ™**
- [ ] ç¼–å†™alert_rules.ymlå®šä¹‰å‘Šè­¦æ¡ä»¶
- [ ] éƒ¨ç½²AlertManagerå¤„ç†å‘Šè­¦è·¯ç”±
- [ ] é…ç½®å‘Šè­¦é˜ˆå€¼å’ŒæŒç»­æ—¶é—´

âœ… **ç¬¬äº”æ­¥ï¼šé›†æˆé€šçŸ¥æ¸ é“**
- [ ] åˆ›å»ºé’‰é’‰æœºå™¨äººè·å–webhook
- [ ] ç¼–å†™å‘Šè­¦è½¬å‘æœåŠ¡
- [ ] é…ç½®é‚®ä»¶æœåŠ¡ï¼ˆå¯é€‰ï¼‰

âœ… **ç¬¬å…­æ­¥ï¼šæµ‹è¯•éªŒè¯**
- [ ] æ¨¡æ‹Ÿé«˜è´Ÿè½½è§¦å‘QPSå‘Šè­¦
- [ ] æ‰‹åŠ¨æŠ›å¼‚å¸¸è§¦å‘é”™è¯¯ç‡å‘Šè­¦
- [ ] éªŒè¯é’‰é’‰/é‚®ä»¶æ”¶åˆ°é€šçŸ¥
```

### 8.3 æœ€ä½³å®è·µå»ºè®®


**ğŸ¯ å‘Šè­¦è®¾è®¡åŸåˆ™ï¼š**
```
1. åˆ†çº§åˆ†ç±»
   â€¢ criticalï¼šå½±å“ä¸šåŠ¡ï¼Œç«‹å³å¤„ç†
   â€¢ warningï¼šæ½œåœ¨é£é™©ï¼Œå…³æ³¨å¤„ç†
   â€¢ infoï¼šä¿¡æ¯è®°å½•ï¼Œå®šæœŸæŸ¥çœ‹

2. é¿å…å‘Šè­¦ç–²åŠ³
   â€¢ è®¾ç½®åˆç†é˜ˆå€¼ï¼Œä¸è¦è¿‡äºæ•æ„Ÿ
   â€¢ ç›¸åŒå‘Šè­¦åˆå¹¶ï¼Œä¸è¦é‡å¤è½°ç‚¸
   â€¢ å·¥ä½œæ—¶é—´å’Œéå·¥ä½œæ—¶é—´åŒºåˆ«å¯¹å¾…

3. å¯æ‰§è¡Œæ€§
   â€¢ å‘Šè­¦ä¿¡æ¯è¦åŒ…å«è¶³å¤Ÿä¸Šä¸‹æ–‡
   â€¢ æä¾›å¿«é€Ÿè·³è½¬åˆ°ç›‘æ§é¢æ¿çš„é“¾æ¥
   â€¢ æ˜ç¡®å‘ŠçŸ¥å¦‚ä½•å¤„ç†
```

**ğŸ“Š ç›‘æ§æŒ‡æ ‡é€‰æ‹©ï¼š**
```
ä¼˜å…ˆçº§æ’åºï¼š
1. ä¸šåŠ¡æŒ‡æ ‡ï¼ˆæœ€é‡è¦ï¼‰
   â€¢ æ ¸å¿ƒæ¥å£çš„å¯ç”¨æ€§
   â€¢ å…³é”®ä¸šåŠ¡çš„æˆåŠŸç‡
   
2. æ€§èƒ½æŒ‡æ ‡
   â€¢ P99å“åº”æ—¶é—´
   â€¢ é”™è¯¯ç‡
   
3. èµ„æºæŒ‡æ ‡
   â€¢ CPUã€å†…å­˜ä½¿ç”¨ç‡
   â€¢ çº¿ç¨‹æ± çŠ¶æ€
   
4. åŸºç¡€è®¾æ–½
   â€¢ ç£ç›˜ã€ç½‘ç»œIO
   â€¢ æ•°æ®åº“è¿æ¥æ± 
```

**ğŸ”§ å®æˆ˜å°æŠ€å·§ï¼š**
```
1. å‘Šè­¦é™é»˜
   â€¢ ç»´æŠ¤çª—å£æœŸé—´å…³é—­å‘Šè­¦
   â€¢ AlertManageræ”¯æŒé™é»˜è§„åˆ™

2. å‘Šè­¦æŠ‘åˆ¶
   â€¢ æœåŠ¡å™¨å®•æœºæ—¶ï¼ŒæŠ‘åˆ¶è¯¥æœåŠ¡å™¨ä¸Šçš„æ‰€æœ‰å…¶ä»–å‘Šè­¦
   â€¢ é¿å…å‘Šè­¦é£æš´

3. å‘Šè­¦æ¨¡æ¿
   â€¢ ç»Ÿä¸€å‘Šè­¦æ¶ˆæ¯æ ¼å¼
   â€¢ åŒ…å«ï¼šæœåŠ¡åã€å‘Šè­¦çº§åˆ«ã€å½“å‰å€¼ã€é˜ˆå€¼ã€æ—¶é—´ã€å¤„ç†å»ºè®®

4. å†å²æ•°æ®
   â€¢ Prometheusé»˜è®¤ä¿å­˜15å¤©
   â€¢ é•¿æœŸå­˜å‚¨éœ€è¦å¯¹æ¥æ—¶åºæ•°æ®åº“ï¼ˆå¦‚VictoriaMetricsï¼‰
```

### 8.4 å¸¸è§é—®é¢˜æ’æŸ¥


**é—®é¢˜1ï¼šPrometheusæŠ“å–å¤±è´¥**
```
ç°è±¡ï¼štargetçŠ¶æ€æ˜¾ç¤ºDOWN
æ’æŸ¥ï¼š
1. æ£€æŸ¥ç½‘å…³çš„/actuator/prometheusç«¯ç‚¹æ˜¯å¦å¯è®¿é—®
2. æ£€æŸ¥é˜²ç«å¢™æ˜¯å¦é˜»æ­¢Prometheusè®¿é—®
3. æŸ¥çœ‹Prometheusæ—¥å¿—ï¼šdocker logs prometheus
```

**é—®é¢˜2ï¼šGrafanaé¢æ¿æ— æ•°æ®**
```
æ’æŸ¥ï¼š
1. æ£€æŸ¥æ•°æ®æºé…ç½®æ˜¯å¦æ­£ç¡®
2. åœ¨Grafanaçš„Exploreé¡µé¢æ‰‹åŠ¨æ‰§è¡ŒæŸ¥è¯¢éªŒè¯
3. æ£€æŸ¥æ—¶é—´èŒƒå›´æ˜¯å¦é€‰æ‹©æ­£ç¡®
```

**é—®é¢˜3ï¼šå‘Šè­¦æœªè§¦å‘**
```
æ’æŸ¥ï¼š
1. åœ¨Prometheus UIä¸­æ‰‹åŠ¨æ‰§è¡Œå‘Šè­¦è¡¨è¾¾å¼
2. æ£€æŸ¥foræŒç»­æ—¶é—´æ˜¯å¦å¤ªé•¿
3. æŸ¥çœ‹AlertManageræ˜¯å¦æ­£å¸¸è¿è¡Œ
4. æ£€æŸ¥å‘Šè­¦è·¯ç”±é…ç½®
```

**é—®é¢˜4ï¼šé’‰é’‰æ¶ˆæ¯å‘é€å¤±è´¥**
```
æ’æŸ¥ï¼š
1. æ£€æŸ¥webhook URLæ˜¯å¦æ­£ç¡®
2. éªŒè¯ç­¾åç®—æ³•æ˜¯å¦æ­£ç¡®
3. æŸ¥çœ‹é’‰é’‰æœºå™¨äººå®‰å…¨è®¾ç½®
4. æ£€æŸ¥IPç™½åå•é™åˆ¶
```

---

**ğŸ“ å­¦ä¹ å»ºè®®ï¼š**

1. **åŠ¨æ‰‹å®è·µ** - æ­å»ºæœ¬åœ°ç¯å¢ƒï¼Œäº²è‡ªé…ç½®ä¸€é
2. **ç†è§£åŸç†** - çŸ¥é“ä¸ºä»€ä¹ˆè¿™æ ·é…ç½®ï¼Œä¸åªæ˜¯å¤åˆ¶ç²˜è´´
3. **å…³æ³¨å…³é”®æŒ‡æ ‡** - å…ˆç›‘æ§æ ¸å¿ƒçš„ï¼Œå†é€æ­¥å®Œå–„
4. **å‘Šè­¦è¦åˆç†** - å®å¯å°‘æŠ¥ä¹Ÿä¸è¦è¯¯æŠ¥ï¼Œé€æ­¥è°ƒä¼˜

**æ ¸å¿ƒè®°å¿†ï¼š**
- ç›‘æ§ä½“ç³»ï¼šPrometheusé‡‡é›† â†’ Grafanaå±•ç¤º â†’ AlertManagerå‘Šè­¦
- å…³é”®æŒ‡æ ‡ï¼šæµé‡ï¼ˆQPSï¼‰ã€æ€§èƒ½ï¼ˆP99ï¼‰ã€é”™è¯¯ï¼ˆé”™è¯¯ç‡ï¼‰ã€èµ„æºï¼ˆCPU/å†…å­˜ï¼‰
- å‘Šè­¦åˆ†çº§ï¼šcriticalç«‹å³å¤„ç†ã€warningå…³æ³¨ã€infoè®°å½•
- é€šçŸ¥æ¸ é“ï¼šé’‰é’‰å¿«é€Ÿã€é‚®ä»¶è¯¦ç»†