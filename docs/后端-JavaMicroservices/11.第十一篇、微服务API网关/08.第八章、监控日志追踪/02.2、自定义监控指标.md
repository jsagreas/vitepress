---
title: 2ã€è‡ªå®šä¹‰ç›‘æ§æŒ‡æ ‡
---
## ğŸ“š ç›®å½•

1. [ç›‘æ§æŒ‡æ ‡åŸºç¡€æ¦‚å¿µ](#1-ç›‘æ§æŒ‡æ ‡åŸºç¡€æ¦‚å¿µ)
2. [Micrometeré›†æˆé…ç½®](#2-Micrometeré›†æˆé…ç½®)
3. [Counterè®¡æ•°å™¨æŒ‡æ ‡](#3-Counterè®¡æ•°å™¨æŒ‡æ ‡)
4. [Gaugeä»ªè¡¨ç›˜æŒ‡æ ‡](#4-Gaugeä»ªè¡¨ç›˜æŒ‡æ ‡)
5. [Timerè®¡æ—¶å™¨æŒ‡æ ‡](#5-Timerè®¡æ—¶å™¨æŒ‡æ ‡)
6. [Summaryæ‘˜è¦æŒ‡æ ‡](#6-Summaryæ‘˜è¦æŒ‡æ ‡)
7. [è¯·æ±‚è€—æ—¶ç»Ÿè®¡å®æˆ˜](#7-è¯·æ±‚è€—æ—¶ç»Ÿè®¡å®æˆ˜)
8. [é”™è¯¯ç‡ç»Ÿè®¡å®æˆ˜](#8-é”™è¯¯ç‡ç»Ÿè®¡å®æˆ˜)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ“Š ç›‘æ§æŒ‡æ ‡åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯ç›‘æ§æŒ‡æ ‡


> ğŸ’¡ **ç”Ÿæ´»ç±»æ¯”**  
> å°±åƒæ±½è½¦ä»ªè¡¨ç›˜ï¼šé€Ÿåº¦è¡¨ã€æ²¹è¡¨ã€æ¸©åº¦è®¡ï¼Œå¸®ä½ éšæ—¶äº†è§£è½¦å†µã€‚  
> ç›‘æ§æŒ‡æ ‡å°±æ˜¯å¾®æœåŠ¡çš„"ä»ªè¡¨ç›˜"ï¼Œå‘Šè¯‰ä½ ç³»ç»Ÿè¿è¡ŒçŠ¶æ€ã€‚

**ç›‘æ§æŒ‡æ ‡çš„æœ¬è´¨**ï¼š
```
ç›‘æ§æŒ‡æ ‡ = ç”¨æ•°å­—è¯´è¯çš„ç³»ç»Ÿå¥åº·æŠ¥å‘Š

å®é™…ä½œç”¨ï¼š
â€¢ å®æ—¶æŒæ¡ï¼šç³»ç»Ÿç°åœ¨æ˜¯å¦æ­£å¸¸è¿è¡Œ
â€¢ æå‰é¢„è­¦ï¼šé—®é¢˜å‡ºç°å‰å°±å‘ç°è‹—å¤´
â€¢ é—®é¢˜å®šä½ï¼šå‡ºæ•…éšœäº†å¿«é€Ÿæ‰¾åˆ°åŸå› 
â€¢ æ€§èƒ½ä¼˜åŒ–ï¼šçŸ¥é“å“ªé‡Œæ…¢ï¼Œé’ˆå¯¹æ€§æ”¹è¿›
```

**ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰ç›‘æ§**ï¼š
```
ç³»ç»Ÿé»˜è®¤ç›‘æ§ï¼š
âœ… CPUã€å†…å­˜ã€ç½‘ç»œæµé‡ç­‰åŸºç¡€æŒ‡æ ‡
âŒ ä½†ä¸çŸ¥é“ä½ çš„ä¸šåŠ¡æƒ…å†µ

è‡ªå®šä¹‰ç›‘æ§ï¼š
âœ… è®¢å•æ”¯ä»˜æˆåŠŸç‡
âœ… ç”¨æˆ·ç™»å½•æ¬¡æ•°
âœ… æ¥å£å“åº”æ—¶é—´
âœ… ä¸šåŠ¡é”™è¯¯å‘ç”Ÿæ¬¡æ•°

ç®€å•è¯´ï¼šé»˜è®¤ç›‘æ§å‘Šè¯‰ä½ "æœºå™¨å¥½ä¸å¥½"ï¼Œè‡ªå®šä¹‰ç›‘æ§å‘Šè¯‰ä½ "ä¸šåŠ¡å¥½ä¸å¥½"
```

### 1.2 Micrometeræ˜¯ä»€ä¹ˆ


**ç®€å•ç†è§£**ï¼š
```
Micrometer = ç›‘æ§æ•°æ®çš„"ç¿»è¯‘å®˜"

ä½œç”¨ï¼šç»Ÿä¸€ä¸åŒç›‘æ§ç³»ç»Ÿçš„æ¥å£æ ‡å‡†

            ä½ çš„ä»£ç 
               â†“
          Micrometerï¼ˆç¿»è¯‘å®˜ï¼‰
               â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â†“                   â†“
 Prometheus          Grafana
ï¼ˆæ•°æ®å­˜å‚¨ï¼‰        ï¼ˆå›¾è¡¨å±•ç¤ºï¼‰
```

**æ ¸å¿ƒä»·å€¼**ï¼š
- **å†™ä¸€æ¬¡ä»£ç **ï¼šä¸ç®¡ç”¨ä»€ä¹ˆç›‘æ§å·¥å…·
- **éšæ—¶åˆ‡æ¢**ï¼šæ¢ç›‘æ§ç³»ç»Ÿä¸ç”¨æ”¹ä»£ç 
- **Springå®˜æ–¹**ï¼šSpring Bootå¤©ç„¶æ”¯æŒ

### 1.3 å››ç§æ ¸å¿ƒæŒ‡æ ‡ç±»å‹å¯¹æ¯”


| æŒ‡æ ‡ç±»å‹ | **ä½œç”¨è¯´æ˜** | **ç”Ÿæ´»ç±»æ¯”** | **å…¸å‹åœºæ™¯** |
|---------|------------|------------|------------|
| ğŸ”¢ **Counter** | `åªå¢ä¸å‡çš„è®¡æ•°å™¨` | æ±½è½¦é‡Œç¨‹è¡¨ | ç»Ÿè®¡è®¿é—®æ¬¡æ•°ã€é”™è¯¯æ¬¡æ•° |
| ğŸ“ **Gauge** | `å¯å¢å¯å‡çš„ä»ªè¡¨ç›˜` | æ¸©åº¦è®¡ã€æ²¹è¡¨ | å½“å‰åœ¨çº¿äººæ•°ã€é˜Ÿåˆ—é•¿åº¦ |
| â±ï¸ **Timer** | `æ—¶é—´æµ‹é‡å·¥å…·` | ç§’è¡¨è®¡æ—¶ | æ¥å£å“åº”æ—¶é—´ã€SQLæ‰§è¡Œæ—¶é•¿ |
| ğŸ“ˆ **Summary** | `æ•°æ®åˆ†å¸ƒç»Ÿè®¡` | è€ƒè¯•æˆç»©åˆ†å¸ƒ | å“åº”å¤§å°åˆ†å¸ƒã€æ•°æ®é‡ç»Ÿè®¡ |

---

## 2. ğŸ”§ Micrometeré›†æˆé…ç½®


### 2.1 æ·»åŠ ä¾èµ–


**Mavené…ç½®**ï¼š
```xml
<!-- Spring Boot Actuatorï¼ˆåŒ…å«Micrometerï¼‰ -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>

<!-- Prometheusç›‘æ§ç«¯ç‚¹ -->
<dependency>
    <groupId>io.micrometer</groupId>
    <artifactId>micrometer-registry-prometheus</artifactId>
</dependency>
```

**é…ç½®æ–‡ä»¶**ï¼ˆapplication.ymlï¼‰ï¼š
```yaml
management:
  endpoints:
    web:
      exposure:
        include: prometheus,health,metrics  # æš´éœ²ç›‘æ§ç«¯ç‚¹
  metrics:
    export:
      prometheus:
        enabled: true
    tags:
      application: ${spring.application.name}  # ç»Ÿä¸€æ ‡ç­¾
```

### 2.2 å¿«é€ŸéªŒè¯


**å¯åŠ¨åè®¿é—®**ï¼š
```
ç›‘æ§ç«¯ç‚¹ï¼šhttp://localhost:8080/actuator/prometheus
å¥åº·æ£€æŸ¥ï¼šhttp://localhost:8080/actuator/health

çœ‹åˆ°ç±»ä¼¼è¾“å‡ºå°±æˆåŠŸäº†ï¼š
# HELP jvm_memory_used_bytes The amount of used memory
# TYPE jvm_memory_used_bytes gauge
jvm_memory_used_bytes{...} 123456789
```

**ğŸ¯ æŒæ¡åº¦è‡ªè¯„**ï¼š
- [ ] èƒ½ç‹¬ç«‹æ·»åŠ Micrometerä¾èµ–
- [ ] èƒ½é…ç½®Prometheusç«¯ç‚¹
- [ ] èƒ½è®¿é—®æŸ¥çœ‹ç›‘æ§æ•°æ®

---

## 3. ğŸ”¢ Counterè®¡æ•°å™¨æŒ‡æ ‡


### 3.1 Counterå·¥ä½œåŸç†


**æ ¸å¿ƒç‰¹ç‚¹**ï¼š
```
Counter = åªä¼šå¢åŠ çš„æ•°å­—

ç‰¹æ€§ï¼š
âœ… åªèƒ½é€’å¢ï¼ˆ+1, +2, +Nï¼‰
âœ… é‡å¯åå½’é›¶
âœ… é€‚åˆç»Ÿè®¡"å‘ç”Ÿäº†å¤šå°‘æ¬¡"

å®é™…ä¾‹å­ï¼š
â€¢ ç½‘ç«™è®¿é—®é‡ï¼šæ¯æ¬¡è®¿é—® +1
â€¢ è®¢å•åˆ›å»ºæ•°ï¼šæ¯ç¬”è®¢å• +1
â€¢ æ¥å£è°ƒç”¨æ¬¡æ•°ï¼šæ¯æ¬¡è°ƒç”¨ +1
```

**å›¾ç¤ºè¯´æ˜**ï¼š
```
æ—¶é—´è½´ï¼šâ†’â†’â†’â†’â†’â†’â†’â†’â†’
è®¡æ•°å€¼ï¼š0 â†’ 1 â†’ 2 â†’ 5 â†’ 8 â†’ 8 â†’ 12
         â†‘   â†‘   â†‘   â†‘   â†‘   â†‘   â†‘
äº‹ä»¶ï¼š å¯åŠ¨  è¯·æ±‚1 è¯·æ±‚2 3æ¬¡  3æ¬¡  æ—    4æ¬¡

è§„å¾‹ï¼šåªå¢ä¸å‡ï¼Œç´¯åŠ ç»Ÿè®¡
```

### 3.2 å®æˆ˜ä»£ç ç¤ºä¾‹


**åˆ›å»ºå’Œä½¿ç”¨Counter**ï¼š
```java
@Component
public class ApiMetrics {
    
    private final Counter requestCounter;
    private final Counter loginCounter;
    
    // é€šè¿‡æ„é€ å™¨æ³¨å…¥MeterRegistry
    public ApiMetrics(MeterRegistry registry) {
        // åˆ›å»ºè¯·æ±‚è®¡æ•°å™¨
        requestCounter = Counter.builder("api.request.total")
            .description("APIæ€»è¯·æ±‚æ¬¡æ•°")
            .tag("type", "gateway")
            .register(registry);
            
        // åˆ›å»ºç™»å½•è®¡æ•°å™¨    
        loginCounter = Counter.builder("user.login.total")
            .description("ç”¨æˆ·ç™»å½•æ¬¡æ•°")
            .register(registry);
    }
    
    // è®°å½•APIè¯·æ±‚
    public void recordRequest() {
        requestCounter.increment();  // +1
    }
    
    // è®°å½•ç™»å½•
    public void recordLogin() {
        loginCounter.increment();
    }
    
    // æ‰¹é‡å¢åŠ 
    public void recordBatchRequests(int count) {
        requestCounter.increment(count);  // +count
    }
}
```

### 3.3 å®é™…åº”ç”¨åœºæ™¯


**åœºæ™¯1ï¼šç»Ÿè®¡æ¥å£è°ƒç”¨æ¬¡æ•°**
```java
@RestController
public class GatewayController {
    
    @Autowired
    private ApiMetrics metrics;
    
    @GetMapping("/api/**")
    public ResponseEntity<?> handleRequest() {
        metrics.recordRequest();  // æ¯æ¬¡è¯·æ±‚+1
        // ä¸šåŠ¡é€»è¾‘...
        return ResponseEntity.ok("success");
    }
}
```

**åœºæ™¯2ï¼šåŒºåˆ†ä¸åŒç±»å‹çš„è¯·æ±‚**
```java
// æ ¹æ®çŠ¶æ€ç åŒºåˆ†æˆåŠŸ/å¤±è´¥
Counter.builder("api.response.total")
    .tag("status", "success")  // æ ‡ç­¾åŒºåˆ†
    .register(registry);

Counter.builder("api.response.total")
    .tag("status", "error")
    .register(registry);
```

**ğŸ”´ æ˜“é”™é‡ç‚¹**ï¼š
> Counterä¸èƒ½å‡å°‘ï¼å¦‚æœéœ€è¦å¯å¢å¯å‡çš„æŒ‡æ ‡ï¼Œç”¨Gauge

---

## 4. ğŸ“ Gaugeä»ªè¡¨ç›˜æŒ‡æ ‡


### 4.1 Gaugeå·¥ä½œåŸç†


**ä¸Counterçš„åŒºåˆ«**ï¼š
```
Counterï¼šåªå¢ä¸å‡çš„é‡Œç¨‹è¡¨
         0 â†’ 100 â†’ 500 â†’ 1000 âœ…

Gaugeï¼šå¯å¢å¯å‡çš„æ¸©åº¦è®¡
       20â„ƒ â†’ 35â„ƒ â†’ 15â„ƒ â†’ 28â„ƒ âœ…

é€‚ç”¨åœºæ™¯å¯¹æ¯”ï¼š
Counter â†’ ç»Ÿè®¡"ç´¯è®¡å‘ç”Ÿå¤šå°‘æ¬¡"
Gauge   â†’ ç›‘æ§"å½“å‰æ˜¯å¤šå°‘"
```

**å…¸å‹åº”ç”¨**ï¼š
- **å½“å‰åœ¨çº¿ç”¨æˆ·æ•°**ï¼šä¼šå¢åŠ ä¹Ÿä¼šå‡å°‘
- **å†…å­˜ä½¿ç”¨é‡**ï¼šå®æ—¶å˜åŒ–
- **é˜Ÿåˆ—é•¿åº¦**ï¼šä»»åŠ¡è¿›å‡º
- **è¿æ¥æ± å¯ç”¨æ•°**ï¼šåŠ¨æ€å˜åŒ–

### 4.2 å®æˆ˜ä»£ç ç¤ºä¾‹


**åœºæ™¯1ï¼šç›‘æ§åœ¨çº¿ç”¨æˆ·æ•°**
```java
@Component
public class OnlineUserMetrics {
    
    private final AtomicInteger onlineUsers = new AtomicInteger(0);
    
    public OnlineUserMetrics(MeterRegistry registry) {
        // Gaugeç›‘æ§onlineUsersçš„å½“å‰å€¼
        Gauge.builder("online.users.current", onlineUsers, AtomicInteger::get)
            .description("å½“å‰åœ¨çº¿ç”¨æˆ·æ•°")
            .register(registry);
    }
    
    // ç”¨æˆ·ä¸Šçº¿
    public void userLogin() {
        onlineUsers.incrementAndGet();  // äººæ•°+1
    }
    
    // ç”¨æˆ·ä¸‹çº¿
    public void userLogout() {
        onlineUsers.decrementAndGet();  // äººæ•°-1
    }
}
```

**åœºæ™¯2ï¼šç›‘æ§é˜Ÿåˆ—é•¿åº¦**
```java
@Component
public class QueueMetrics {
    
    private final BlockingQueue<String> taskQueue = new LinkedBlockingQueue<>();
    
    public QueueMetrics(MeterRegistry registry) {
        // ç›‘æ§é˜Ÿåˆ—å®æ—¶å¤§å°
        Gauge.builder("task.queue.size", taskQueue, Collection::size)
            .description("å¾…å¤„ç†ä»»åŠ¡é˜Ÿåˆ—é•¿åº¦")
            .register(registry);
    }
}
```

### 4.3 Gaugeçš„ä¸‰ç§åˆ›å»ºæ–¹å¼


**æ–¹å¼å¯¹æ¯”**ï¼š
```java
// æ–¹å¼1ï¼šç›‘æ§å¯¹è±¡çš„æŸä¸ªå€¼ï¼ˆæ¨èï¼‰
Gauge.builder("memory.used", memoryBean, MemoryBean::getUsed)
    .register(registry);

// æ–¹å¼2ï¼šç›‘æ§é›†åˆå¤§å°
Gauge.builder("list.size", myList, List::size)
    .register(registry);

// æ–¹å¼3ï¼šè‡ªå®šä¹‰è®¡ç®—é€»è¾‘
Gauge.builder("cpu.usage", this, obj -> calculateCpuUsage())
    .register(registry);
```

**âš ï¸ æ³¨æ„äº‹é¡¹**ï¼š
- Gaugeä¼š**å®šæœŸè°ƒç”¨**ä½ æä¾›çš„æ–¹æ³•è·å–å€¼
- ä¸è¦åœ¨Gaugeæ–¹æ³•é‡Œåš**è€—æ—¶æ“ä½œ**
- è¢«ç›‘æ§çš„å¯¹è±¡ä¸èƒ½è¢«GCå›æ”¶

---

## 5. â±ï¸ Timerè®¡æ—¶å™¨æŒ‡æ ‡


### 5.1 Timerå·¥ä½œåŸç†


**ç®€å•ç†è§£**ï¼š
```
Timer = ç§’è¡¨ + è®¡æ•°å™¨çš„ç»„åˆ

åŒæ—¶è®°å½•ä¸¤ä¸ªä¿¡æ¯ï¼š
1. æ‰§è¡Œäº†å¤šå°‘æ¬¡ï¼ˆcountï¼‰
2. æ€»å…±èŠ±äº†å¤šå°‘æ—¶é—´ï¼ˆdurationï¼‰

è‡ªåŠ¨è®¡ç®—ï¼š
â€¢ å¹³å‡è€—æ—¶ = æ€»æ—¶é—´ / æ¬¡æ•°
â€¢ æœ€å¤§/æœ€å°è€—æ—¶
â€¢ ç™¾åˆ†ä½è€—æ—¶ï¼ˆP95, P99ï¼‰
```

**ç›‘æ§ç»´åº¦**ï¼š
```
å‡è®¾æ¥å£è°ƒç”¨3æ¬¡ï¼š
ç¬¬1æ¬¡ï¼š100ms
ç¬¬2æ¬¡ï¼š200ms  
ç¬¬3æ¬¡ï¼š150ms

Timerè‡ªåŠ¨ç»Ÿè®¡ï¼š
âœ… count: 3æ¬¡
âœ… sum: 450ms
âœ… avg: 150ms
âœ… max: 200ms
âœ… P95: 190msï¼ˆ95%çš„è¯·æ±‚åœ¨æ­¤æ—¶é—´å†…å®Œæˆï¼‰
```

### 5.2 å®æˆ˜ä»£ç ç¤ºä¾‹


**æ–¹å¼1ï¼šæ‰‹åŠ¨è®¡æ—¶ï¼ˆåŸºç¡€ç”¨æ³•ï¼‰**
```java
@Service
public class OrderService {
    
    private final Timer orderTimer;
    
    public OrderService(MeterRegistry registry) {
        orderTimer = Timer.builder("order.create.time")
            .description("è®¢å•åˆ›å»ºè€—æ—¶")
            .tag("service", "order")
            .register(registry);
    }
    
    public void createOrder() {
        Timer.Sample sample = Timer.start();  // å¼€å§‹è®¡æ—¶
        
        try {
            // ä¸šåŠ¡é€»è¾‘
            Thread.sleep(100);
        } finally {
            sample.stop(orderTimer);  // åœæ­¢è®¡æ—¶å¹¶è®°å½•
        }
    }
}
```

**æ–¹å¼2ï¼šLambdaç®€åŒ–ï¼ˆæ¨èï¼‰**
```java
public void createOrder() {
    orderTimer.record(() -> {
        // ä¸šåŠ¡é€»è¾‘ï¼Œè‡ªåŠ¨è®¡æ—¶
        processOrder();
        saveToDatabase();
    });
}
```

**æ–¹å¼3ï¼šæ³¨è§£æ–¹å¼ï¼ˆæœ€ç®€å•ï¼‰**
```java
@Service
public class OrderService {
    
    @Timed(value = "order.create", description = "è®¢å•åˆ›å»º")
    public void createOrder() {
        // è‡ªåŠ¨è®¡æ—¶ï¼Œæ— éœ€æ‰‹åŠ¨ä»£ç 
        processOrder();
    }
}
```

### 5.3 å®é™…åº”ç”¨åœºæ™¯


**åœºæ™¯1ï¼šæ•°æ®åº“æŸ¥è¯¢è€—æ—¶**
```java
Timer.builder("db.query.time")
    .tag("table", "orders")
    .register(registry)
    .record(() -> {
        return jdbcTemplate.query("SELECT * FROM orders");
    });
```

**åœºæ™¯2ï¼šHTTPè¯·æ±‚è€—æ—¶**
```java
@GetMapping("/api/users")
@Timed(value = "api.users.time", percentiles = {0.95, 0.99})
public List<User> getUsers() {
    return userService.findAll();
}
```

**ğŸ¯ Timeræ ¸å¿ƒä»·å€¼**ï¼š
- è‡ªåŠ¨è®¡ç®—å¹³å‡å€¼ã€æœ€å¤§å€¼
- æ”¯æŒç™¾åˆ†ä½ç»Ÿè®¡ï¼ˆP95/P99ï¼‰
- é€‚åˆç›‘æ§æ€§èƒ½ç“¶é¢ˆ

---

## 6. ğŸ“ˆ Summaryæ‘˜è¦æŒ‡æ ‡


### 6.1 Summary vs Timerçš„åŒºåˆ«


**æ ¸å¿ƒå¯¹æ¯”**ï¼š
```
Timerï¼šä¸“æ³¨æ—¶é—´æµ‹é‡
â€¢ å•ä½ï¼šæ—¶é—´ï¼ˆç§’ã€æ¯«ç§’ï¼‰
â€¢ åœºæ™¯ï¼šæ¥å£è€—æ—¶ã€SQLæ‰§è¡Œæ—¶é—´

Summaryï¼šé€šç”¨æ•°æ®åˆ†å¸ƒç»Ÿè®¡  
â€¢ å•ä½ï¼šä»»æ„ï¼ˆå­—èŠ‚ã€ä¸ªæ•°ã€åˆ†æ•°ï¼‰
â€¢ åœºæ™¯ï¼šå“åº”å¤§å°ã€å¹¶å‘æ•°ã€è¯„åˆ†åˆ†å¸ƒ
```

**ç±»æ¯”ç†è§£**ï¼š
```
è€ƒè¯•æˆç»©ç»Ÿè®¡ï¼ˆSummaryï¼‰ï¼š
â€¢ æ€»åˆ†åˆ†å¸ƒï¼š60åˆ†ä»¥ä¸‹ã€60-80ã€80-100
â€¢ å¹³å‡åˆ†ï¼š75åˆ†
â€¢ æœ€é«˜åˆ†ï¼š95åˆ†
â€¢ P95åˆ†æ•°çº¿ï¼š90åˆ†

æ¥å£å“åº”å¤§å°ï¼ˆSummaryï¼‰ï¼š
â€¢ å°äº1KBï¼š30%
â€¢ 1-10KBï¼š50%  
â€¢ å¤§äº10KBï¼š20%
â€¢ å¹³å‡å¤§å°ï¼š5KB
```

### 6.2 å®æˆ˜ä»£ç ç¤ºä¾‹


**ç›‘æ§å“åº”ä½“å¤§å°**ï¼š
```java
@Component
public class ResponseMetrics {
    
    private final DistributionSummary responseSizeSummary;
    
    public ResponseMetrics(MeterRegistry registry) {
        responseSizeSummary = DistributionSummary.builder("response.size.bytes")
            .description("å“åº”ä½“å¤§å°åˆ†å¸ƒ")
            .baseUnit("bytes")
            .register(registry);
    }
    
    public void recordResponseSize(int size) {
        responseSizeSummary.record(size);  // è®°å½•æœ¬æ¬¡å“åº”å¤§å°
    }
}
```

**ç›‘æ§å¹¶å‘è¯·æ±‚æ•°**ï¼š
```java
DistributionSummary.builder("concurrent.requests")
    .description("å¹¶å‘è¯·æ±‚æ•°åˆ†å¸ƒ")
    .publishPercentiles(0.5, 0.95, 0.99)  // ç™¾åˆ†ä½
    .register(registry);
```

### 6.3 Summaryé…ç½®é€‰é¡¹


**ç™¾åˆ†ä½é…ç½®**ï¼š
```java
DistributionSummary.builder("metric.name")
    .publishPercentiles(0.5, 0.95, 0.99)  // P50, P95, P99
    .minimumExpectedValue(1.0)            // æœ€å°æœŸæœ›å€¼
    .maximumExpectedValue(1000.0)         // æœ€å¤§æœŸæœ›å€¼
    .register(registry);
```

**ğŸ“Š ç›‘æ§æ•ˆæœ**ï¼š
```
response.size.bytes.count: 1000       // æ€»è¯·æ±‚æ•°
response.size.bytes.sum: 5000000      // æ€»å“åº”å­—èŠ‚æ•°
response.size.bytes.max: 50000        // æœ€å¤§å“åº”
response.size.bytes.avg: 5000         // å¹³å‡å¤§å°
response.size.bytes.percentile_95: 8000  // 95%çš„è¯·æ±‚å“åº”å°äº8KB
```

---

## 7. ğŸš€ è¯·æ±‚è€—æ—¶ç»Ÿè®¡å®æˆ˜


### 7.1 å®Œæ•´ç›‘æ§æ–¹æ¡ˆ


**ä¸šåŠ¡éœ€æ±‚**ï¼š
```
ç›‘æ§ç›®æ ‡ï¼š
1. ç»Ÿè®¡æ¯ä¸ªæ¥å£çš„è°ƒç”¨æ¬¡æ•°
2. è®°å½•æ¯ä¸ªæ¥å£çš„å“åº”æ—¶é—´
3. åŒºåˆ†æˆåŠŸ/å¤±è´¥è¯·æ±‚
4. æŒ‰æ¥å£è·¯å¾„åˆ†ç»„ç»Ÿè®¡
```

**å®ç°æ¶æ„**ï¼š
```
                è¯·æ±‚è¿›å…¥
                   â†“
            æ‹¦æˆªå™¨ï¼ˆå¼€å§‹è®¡æ—¶ï¼‰
                   â†“
              æ‰§è¡Œä¸šåŠ¡é€»è¾‘
                   â†“
            æ‹¦æˆªå™¨ï¼ˆåœæ­¢è®¡æ—¶ï¼‰
                   â†“
          è®°å½•Counter + Timer
```

### 7.2 æ ¸å¿ƒä»£ç å®ç°


**æ­¥éª¤1ï¼šåˆ›å»ºç›‘æ§ç»„ä»¶**
```java
@Component
public class RequestMetrics {
    
    private final MeterRegistry registry;
    
    public RequestMetrics(MeterRegistry registry) {
        this.registry = registry;
    }
    
    // è®°å½•è¯·æ±‚è€—æ—¶å’Œæ¬¡æ•°
    public void recordRequest(String path, String method, 
                              String status, long duration) {
        // è®¡æ•°å™¨ï¼šè¯·æ±‚æ¬¡æ•°
        Counter.builder("http.request.total")
            .tag("path", path)
            .tag("method", method)
            .tag("status", status)
            .register(registry)
            .increment();
            
        // è®¡æ—¶å™¨ï¼šè¯·æ±‚è€—æ—¶    
        Timer.builder("http.request.duration")
            .tag("path", path)
            .tag("method", method)
            .register(registry)
            .record(duration, TimeUnit.MILLISECONDS);
    }
}
```

**æ­¥éª¤2ï¼šåˆ›å»ºæ‹¦æˆªå™¨**
```java
@Component
public class MetricsInterceptor implements HandlerInterceptor {
    
    @Autowired
    private RequestMetrics requestMetrics;
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                            HttpServletResponse response, 
                            Object handler) {
        // è®°å½•å¼€å§‹æ—¶é—´
        request.setAttribute("startTime", System.currentTimeMillis());
        return true;
    }
    
    @Override
    public void afterCompletion(HttpServletRequest request, 
                               HttpServletResponse response,
                               Object handler, Exception ex) {
        // è®¡ç®—è€—æ—¶
        long startTime = (Long) request.getAttribute("startTime");
        long duration = System.currentTimeMillis() - startTime;
        
        // è·å–è¯·æ±‚ä¿¡æ¯
        String path = request.getRequestURI();
        String method = request.getMethod();
        String status = response.getStatus() < 400 ? "success" : "error";
        
        // è®°å½•ç›‘æ§æ•°æ®
        requestMetrics.recordRequest(path, method, status, duration);
    }
}
```

**æ­¥éª¤3ï¼šæ³¨å†Œæ‹¦æˆªå™¨**
```java
@Configuration
public class WebConfig implements WebMvcConfigurer {
    
    @Autowired
    private MetricsInterceptor metricsInterceptor;
    
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(metricsInterceptor)
            .addPathPatterns("/api/**");  // ç›‘æ§æ‰€æœ‰APIæ¥å£
    }
}
```

### 7.3 ç›‘æ§æ•°æ®æŸ¥çœ‹


**PrometheusæŸ¥è¯¢ç¤ºä¾‹**ï¼š
```promql
# æŸ¥çœ‹å„æ¥å£è¯·æ±‚æ¬¡æ•°
http_request_total

# æŸ¥çœ‹å¹³å‡å“åº”æ—¶é—´
rate(http_request_duration_sum[5m]) / rate(http_request_duration_count[5m])

# æŸ¥çœ‹æŸä¸ªæ¥å£çš„P95è€—æ—¶
histogram_quantile(0.95, http_request_duration_bucket{path="/api/users"})
```

**ğŸ¯ å®æˆ˜æ£€éªŒ**ï¼š
- [ ] èƒ½ç‹¬ç«‹å®ç°è¯·æ±‚æ‹¦æˆªå™¨
- [ ] èƒ½æ­£ç¡®è®¡ç®—è¯·æ±‚è€—æ—¶
- [ ] èƒ½åŒºåˆ†æˆåŠŸ/å¤±è´¥è¯·æ±‚
- [ ] èƒ½æŒ‰è·¯å¾„åˆ†ç»„ç»Ÿè®¡

---

## 8. âš ï¸ é”™è¯¯ç‡ç»Ÿè®¡å®æˆ˜


### 8.1 é”™è¯¯ç›‘æ§æ–¹æ¡ˆè®¾è®¡


**ç›‘æ§ç»´åº¦**ï¼š
```
é”™è¯¯åˆ†ç±»ï¼š
1. HTTPçŠ¶æ€ç é”™è¯¯ï¼ˆ4xx, 5xxï¼‰
2. ä¸šåŠ¡å¼‚å¸¸é”™è¯¯
3. ç¬¬ä¸‰æ–¹è°ƒç”¨å¤±è´¥
4. è¶…æ—¶é”™è¯¯

ç»Ÿè®¡æŒ‡æ ‡ï¼š
â€¢ é”™è¯¯æ€»æ•°ï¼ˆCounterï¼‰
â€¢ é”™è¯¯ç‡ = é”™è¯¯æ•° / æ€»è¯·æ±‚æ•°
â€¢ æŒ‰é”™è¯¯ç±»å‹åˆ†ç»„
```

**è®¡ç®—é€»è¾‘**ï¼š
```
æ—¶é—´çª—å£ï¼šæœ€è¿‘5åˆ†é’Ÿ
æ€»è¯·æ±‚ï¼š1000æ¬¡
é”™è¯¯è¯·æ±‚ï¼š50æ¬¡

é”™è¯¯ç‡ = 50 / 1000 = 5%

å‘Šè­¦è§„åˆ™ï¼š
ğŸŸ¢ é”™è¯¯ç‡ < 1%ï¼šæ­£å¸¸
ğŸŸ¡ é”™è¯¯ç‡ 1-5%ï¼šè­¦å‘Š  
ğŸ”´ é”™è¯¯ç‡ > 5%ï¼šä¸¥é‡
```

### 8.2 æ ¸å¿ƒä»£ç å®ç°


**é”™è¯¯ç›‘æ§ç»„ä»¶**ï¼š
```java
@Component
public class ErrorMetrics {
    
    private final Counter errorCounter;
    private final Counter totalCounter;
    
    public ErrorMetrics(MeterRegistry registry) {
        // é”™è¯¯è®¡æ•°å™¨
        errorCounter = Counter.builder("api.error.total")
            .description("APIé”™è¯¯æ€»æ•°")
            .register(registry);
            
        // æ€»è¯·æ±‚è®¡æ•°å™¨    
        totalCounter = Counter.builder("api.request.total")
            .description("APIæ€»è¯·æ±‚æ•°")
            .register(registry);
    }
    
    // è®°å½•æ­£å¸¸è¯·æ±‚
    public void recordSuccess() {
        totalCounter.increment();
    }
    
    // è®°å½•é”™è¯¯è¯·æ±‚
    public void recordError(String errorType) {
        totalCounter.increment();
        Counter.builder("api.error.total")
            .tag("type", errorType)  // æŒ‰é”™è¯¯ç±»å‹åˆ†ç»„
            .register(registry)
            .increment();
    }
}
```

**å…¨å±€å¼‚å¸¸å¤„ç†å™¨**ï¼š
```java
@RestControllerAdvice
public class GlobalExceptionHandler {
    
    @Autowired
    private ErrorMetrics errorMetrics;
    
    @ExceptionHandler(Exception.class)
    public ResponseEntity<?> handleException(Exception ex) {
        // è®°å½•é”™è¯¯
        String errorType = ex.getClass().getSimpleName();
        errorMetrics.recordError(errorType);
        
        return ResponseEntity.status(500)
            .body("ç³»ç»Ÿé”™è¯¯ï¼š" + ex.getMessage());
    }
    
    @ExceptionHandler(BusinessException.class)
    public ResponseEntity<?> handleBusinessException(BusinessException ex) {
        errorMetrics.recordError("business_error");
        return ResponseEntity.status(400).body(ex.getMessage());
    }
}
```

### 8.3 é”™è¯¯ç‡è®¡ç®—ä¸å‘Šè­¦


**Prometheuså‘Šè­¦è§„åˆ™**ï¼š
```yaml
groups:
  - name: api_alerts
    rules:
      # é”™è¯¯ç‡è¶…è¿‡5%å‘Šè­¦
      - alert: HighErrorRate
        expr: |
          (
            sum(rate(api_error_total[5m]))
            /
            sum(rate(api_request_total[5m]))
          ) > 0.05
        for: 2m
        annotations:
          summary: "APIé”™è¯¯ç‡è¿‡é«˜"
          description: "é”™è¯¯ç‡: {{ $value | humanizePercentage }}"
```

**Grafanaçœ‹æ¿å±•ç¤º**ï¼š
```
é”™è¯¯ç‡è¶‹åŠ¿å›¾ï¼š
  100% â”¤
   50% â”¤     â•­â•®
   10% â”¤    â•­â•¯â•°â•®
    5% â”¼â”€â”€â”€â”€â•¯  â•°â”€â”€â”€â”€ğŸ”´è¶…è¿‡é˜ˆå€¼
    0% â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ æ—¶é—´

é”™è¯¯ç±»å‹åˆ†å¸ƒé¥¼å›¾ï¼š
  ä¸šåŠ¡å¼‚å¸¸: 60%
  è¶…æ—¶é”™è¯¯: 25%
  4xxé”™è¯¯: 10%
  å…¶ä»–: 5%
```

**ğŸ”´ é‡è¦æé†’**ï¼š
> é”™è¯¯ç‡ä¸èƒ½åªçœ‹æ€»æ•°ï¼Œè¦ç»“åˆæµé‡çœ‹ã€‚  
> 100ä¸ªè¯·æ±‚é”™1ä¸ªï¼ˆ1%ï¼‰vs 10000ä¸ªè¯·æ±‚é”™100ä¸ªï¼ˆ1%ï¼‰ï¼Œå½±å“å·®100å€ï¼

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å››ç§æŒ‡æ ‡ç±»å‹é€Ÿè®°


| æŒ‡æ ‡ | **å£è¯€** | **åº”ç”¨** | **å…¸å‹ä»£ç ** |
|------|---------|---------|-------------|
| Counter | `åªå¢ä¸å‡çš„è®¡æ•°å™¨` | è¯·æ±‚æ¬¡æ•°ã€é”™è¯¯æ•° | `counter.increment()` |
| Gauge | `å¯å¢å¯å‡çš„ä»ªè¡¨` | åœ¨çº¿äººæ•°ã€é˜Ÿåˆ—é•¿åº¦ | `Gauge.builder(..., obj::getValue)` |
| Timer | `ç§’è¡¨è®¡æ—¶å™¨` | æ¥å£è€—æ—¶ã€SQLæ‰§è¡Œ | `timer.record(() -> {...})` |
| Summary | `æ•°æ®åˆ†å¸ƒç»Ÿè®¡` | å“åº”å¤§å°ã€å¹¶å‘æ•° | `summary.record(value)` |

### 9.2 å®æˆ˜åº”ç”¨æ£€æŸ¥æ¸…å•


**âœ… ç›‘æ§è®¾è®¡**ï¼š
- [ ] æ˜ç¡®ç›‘æ§ç›®æ ‡ï¼ˆç›‘æ§ä»€ä¹ˆï¼‰
- [ ] é€‰æ‹©åˆé€‚çš„æŒ‡æ ‡ç±»å‹
- [ ] è®¾è®¡åˆç†çš„æ ‡ç­¾åˆ†ç»„
- [ ] é…ç½®å‘Šè­¦é˜ˆå€¼

**âœ… ä»£ç å®ç°**ï¼š
- [ ] æ­£ç¡®æ³¨å…¥MeterRegistry
- [ ] åˆç†å‘½åæŒ‡æ ‡ï¼ˆç”¨ç‚¹åˆ†éš”ï¼‰
- [ ] æ·»åŠ æè¿°ä¿¡æ¯
- [ ] ä½¿ç”¨æ ‡ç­¾åŒºåˆ†ç»´åº¦

**âœ… æ€§èƒ½ä¼˜åŒ–**ï¼š
- [ ] é¿å…åˆ›å»ºè¿‡å¤šæŒ‡æ ‡ï¼ˆå†…å­˜å¼€é”€ï¼‰
- [ ] æ ‡ç­¾å€¼ä¸èƒ½æ— é™å¢é•¿
- [ ] Gaugeä¸è¦åšè€—æ—¶æ“ä½œ
- [ ] å®šæœŸæ¸…ç†æ— ç”¨æŒ‡æ ‡

### 9.3 å¸¸è§é—®é¢˜ä¸è§£å†³


**é—®é¢˜1ï¼šæŒ‡æ ‡æ•°æ®çœ‹ä¸åˆ°**
```
æ’æŸ¥æ­¥éª¤ï¼š
1. æ£€æŸ¥ä¾èµ–æ˜¯å¦æ­£ç¡®
2. ç¡®è®¤ç«¯ç‚¹å·²æš´éœ²ï¼ˆ/actuator/prometheusï¼‰
3. éªŒè¯æŒ‡æ ‡æ˜¯å¦æ³¨å†ŒæˆåŠŸ
4. æŸ¥çœ‹æ˜¯å¦æœ‰å¼‚å¸¸æ—¥å¿—
```

**é—®é¢˜2ï¼šç›‘æ§æ•°æ®ä¸å‡†ç¡®**
```
åŸå› åˆ†æï¼š
â€¢ Counterè¢«å¤šæ¬¡åˆ›å»ºï¼ˆåº”è¯¥å•ä¾‹ï¼‰
â€¢ æ ‡ç­¾å€¼æ‹¼å†™é”™è¯¯
â€¢ æ—¶é—´çª—å£è®¾ç½®ä¸åˆç†
â€¢ å¼‚å¸¸æ•è·ä¸å®Œæ•´
```

**é—®é¢˜3ï¼šå†…å­˜å ç”¨è¿‡é«˜**
```
ä¼˜åŒ–å»ºè®®ï¼š
â€¢ æ§åˆ¶æ ‡ç­¾åŸºæ•°ï¼ˆä¸è¶…è¿‡100ï¼‰
â€¢ é¿å…ä½¿ç”¨ç”¨æˆ·IDç­‰é«˜åŸºæ•°æ ‡ç­¾
â€¢ å®šæœŸæ¸…ç†è¿‡æœŸæŒ‡æ ‡
â€¢ ä½¿ç”¨æ ‡ç­¾å¤ç”¨
```

### 9.4 æœ€ä½³å®è·µå»ºè®®


**ğŸ¯ å‘½åè§„èŒƒ**ï¼š
```
æ¨èæ ¼å¼ï¼š<namespace>.<subsystem>.<name>

âœ… å¥½çš„å‘½åï¼š
api.request.total
http.response.time
db.query.duration

âŒ ä¸å¥½çš„å‘½åï¼š
requestsï¼ˆå¤ªç¬¼ç»Ÿï¼‰
api_response_time_msï¼ˆä¸ç»Ÿä¸€ï¼‰
```

**ğŸ·ï¸ æ ‡ç­¾ä½¿ç”¨**ï¼š
```
âœ… åˆç†çš„æ ‡ç­¾ï¼š
â€¢ path: æ¥å£è·¯å¾„
â€¢ method: HTTPæ–¹æ³•
â€¢ status: æˆåŠŸ/å¤±è´¥
â€¢ service: æœåŠ¡åç§°

âŒ ä¸åˆç†çš„æ ‡ç­¾ï¼š
â€¢ userId: ç”¨æˆ·IDï¼ˆåŸºæ•°å¤ªé«˜ï¼‰
â€¢ timestamp: æ—¶é—´æˆ³ï¼ˆæ— é™å¢é•¿ï¼‰
â€¢ requestId: è¯·æ±‚IDï¼ˆå”¯ä¸€å€¼ï¼‰
```

**ğŸ“Š ç›‘æ§è¦†ç›–**ï¼š
```
æ ¸å¿ƒç›‘æ§æŒ‡æ ‡ï¼ˆå¿…é¡»æœ‰ï¼‰ï¼š
ğŸ”´ è¯·æ±‚é‡ï¼šQPSè¶‹åŠ¿
ğŸ”´ å“åº”æ—¶é—´ï¼šP95/P99
ğŸ”´ é”™è¯¯ç‡ï¼šæŒ‰ç±»å‹ç»Ÿè®¡
ğŸ”´ ç³»ç»Ÿèµ„æºï¼šCPU/å†…å­˜

å¢å¼ºç›‘æ§æŒ‡æ ‡ï¼ˆå»ºè®®æœ‰ï¼‰ï¼š
ğŸŸ¡ ä¸šåŠ¡æŒ‡æ ‡ï¼šè®¢å•é‡ã€æ”¯ä»˜æˆåŠŸç‡
ğŸŸ¡ ä¾èµ–ç›‘æ§ï¼šDBã€Redisã€HTTPè°ƒç”¨
ğŸŸ¡ è‡ªå®šä¹‰å‘Šè­¦ï¼šé˜ˆå€¼åŠ¨æ€è°ƒæ•´
```

### 9.5 å­¦ä¹ è·¯çº¿å›¾


**æ–°æ‰‹å…¥é—¨**ï¼š
```
ç¬¬1æ­¥ï¼šç†è§£å››ç§æŒ‡æ ‡ç±»å‹ â†’ çŸ¥é“ç”¨å“ªä¸ª
ç¬¬2æ­¥ï¼šå®ç°åŸºç¡€ç›‘æ§ â†’ Counterç»Ÿè®¡è¯·æ±‚
ç¬¬3æ­¥ï¼šæ·»åŠ è€—æ—¶ç›‘æ§ â†’ Timerè®¡ç®—å“åº”æ—¶é—´
```

**è¿›é˜¶åº”ç”¨**ï¼š
```
ç¬¬4æ­¥ï¼šè®¾è®¡é”™è¯¯ç›‘æ§ â†’ åŒºåˆ†é”™è¯¯ç±»å‹
ç¬¬5æ­¥ï¼šæ•´åˆPrometheus â†’ æ•°æ®æŒä¹…åŒ–
ç¬¬6æ­¥ï¼šé…ç½®Grafana â†’ å¯è§†åŒ–å±•ç¤º
```

**é«˜çº§å®æˆ˜**ï¼š
```
ç¬¬7æ­¥ï¼šè‡ªå®šä¹‰ä¸šåŠ¡æŒ‡æ ‡ â†’ è®¢å•ã€æ”¯ä»˜ç›‘æ§
ç¬¬8æ­¥ï¼šé…ç½®æ™ºèƒ½å‘Šè­¦ â†’ åŸºçº¿+åŠ¨æ€é˜ˆå€¼
ç¬¬9æ­¥ï¼šä¼˜åŒ–æ€§èƒ½ â†’ å‡å°‘æŒ‡æ ‡æ•°é‡ï¼Œé™ä½å¼€é”€
```

---

**ğŸ¯ æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
Counterè®¡æ¬¡æ•°ï¼Œåªå¢æ°¸ä¸å‡
Gaugeçœ‹å½“å‰ï¼Œå®æ—¶ä¸Šä¸‹å˜  
Timeræµ‹è€—æ—¶ï¼Œè‡ªåŠ¨ç®—ç™¾åˆ†
Summaryçœ‹åˆ†å¸ƒï¼Œä»»æ„æ•°æ®è½¬

å››ç§æŒ‡æ ‡é…åˆç”¨ï¼Œç›‘æ§ç³»ç»Ÿç¨³å¦‚å±±
æ ‡ç­¾åˆ†ç»„è¦åˆç†ï¼Œå†…å­˜æ€§èƒ½ä¸¤å…¼é¡¾
```

**ğŸ’¡ å®æˆ˜å»ºè®®**ï¼š
- ä»ç®€å•çš„Counterå¼€å§‹ï¼Œé€æ­¥æŒæ¡å…¶ä»–ç±»å‹
- ç›‘æ§æŒ‡æ ‡å®ç¼ºæ¯‹æ»¥ï¼Œå…³é”®æŒ‡æ ‡å¿…é¡»æœ‰
- ç»“åˆä¸šåŠ¡åœºæ™¯è®¾è®¡ï¼Œä¸è¦ä¸ºäº†ç›‘æ§è€Œç›‘æ§
- å®šæœŸreviewç›‘æ§æ•°æ®ï¼ŒæŒç»­ä¼˜åŒ–å‘Šè­¦è§„åˆ™