---
title: 1ã€æ ¸å¿ƒæ¶æ„ç»„ä»¶
---
## ğŸ“š ç›®å½•

1. [Gatewayæ¶æ„æ¦‚è§ˆ](#1-Gatewayæ¶æ„æ¦‚è§ˆ)
2. [Routeè·¯ç”±å®šä¹‰](#2-Routeè·¯ç”±å®šä¹‰)
3. [Predicateæ–­è¨€åˆ¤æ–­](#3-Predicateæ–­è¨€åˆ¤æ–­)
4. [Filterè¿‡æ»¤å™¨é“¾](#4-Filterè¿‡æ»¤å™¨é“¾)
5. [WebFluxå“åº”å¼åŸºç¡€](#5-WebFluxå“åº”å¼åŸºç¡€)
6. [Reactor Nettyå¼‚æ­¥IO](#6-Reactor-Nettyå¼‚æ­¥IO)
7. [HandlerMappingè·¯ç”±æ˜ å°„](#7-HandlerMappingè·¯ç”±æ˜ å°„)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ—ï¸ Gatewayæ¶æ„æ¦‚è§ˆ


### 1.1 ä»€ä¹ˆæ˜¯Spring Cloud Gateway


**ğŸ”¸ é€šä¿—ç†è§£**

æƒ³è±¡ä¸€ä¸ªå¤§å‹å•†åœºçš„æ€»æœåŠ¡å°ï¼š
- é¡¾å®¢è¿›é—¨éƒ½å…ˆåˆ°æœåŠ¡å°é—®è·¯ï¼ˆç½‘å…³æ¥æ”¶è¯·æ±‚ï¼‰
- æœåŠ¡å°æ ¹æ®éœ€æ±‚æŒ‡å¼•åˆ°å¯¹åº”æ¥¼å±‚ï¼ˆè·¯ç”±åˆ†å‘ï¼‰
- é¡¾å®¢ä¸Šæ¥¼å‰è¦ç»è¿‡å®‰æ£€ï¼ˆè¿‡æ»¤å™¨å¤„ç†ï¼‰
- æœ€ç»ˆåˆ°è¾¾ç›®æ ‡åº—é“ºï¼ˆåç«¯æœåŠ¡ï¼‰

```
å®¢æˆ·ç«¯è¯·æ±‚ â†’ Gatewayç½‘å…³ â†’ åç«¯æœåŠ¡A
                â†“         â†’ åç«¯æœåŠ¡B
              è·¯ç”±+è¿‡æ»¤    â†’ åç«¯æœåŠ¡C
```

**ğŸ“‹ æ ¸å¿ƒå®šä½**
```
Spring Cloud Gatewayæ˜¯åŸºäºSpring Framework 5ã€
Spring Boot 2å’ŒProject Reactoræ„å»ºçš„APIç½‘å…³

ä½œç”¨ï¼š
â€¢ ç»Ÿä¸€å…¥å£ï¼šæ‰€æœ‰è¯·æ±‚éƒ½ç»è¿‡ç½‘å…³
â€¢ è·¯ç”±è½¬å‘ï¼šæ ¹æ®è§„åˆ™åˆ†å‘åˆ°ä¸åŒæœåŠ¡
â€¢ è¯·æ±‚è¿‡æ»¤ï¼šç»Ÿä¸€å¤„ç†é‰´æƒã€é™æµç­‰
â€¢ åè®®è½¬æ¢ï¼šæ”¯æŒHTTPã€WebSocketç­‰
```

### 1.2 æ•´ä½“æ¶æ„è®¾è®¡


**ğŸ—ï¸ æ¶æ„å…¨æ™¯å›¾**
```
                     Gatewayæ ¸å¿ƒæ¶æ„
                           
å®¢æˆ·ç«¯è¯·æ±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                  â”‚
    â†“                                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         HandlerMapping è·¯ç”±æ˜ å°„          â”‚
â”‚   (æ‰¾åˆ°è¯·æ±‚å¯¹åº”çš„Routeè·¯ç”±é…ç½®)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Predicate æ–­è¨€åˆ¤æ–­              â”‚
â”‚   (æ£€æŸ¥è¯·æ±‚æ˜¯å¦ç¬¦åˆè·¯ç”±æ¡ä»¶)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â†“ (ç¬¦åˆæ¡ä»¶)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Filter Chain è¿‡æ»¤å™¨é“¾           â”‚
â”‚                                         â”‚
â”‚  Pre Filter â†’ ç›®æ ‡æœåŠ¡ â†’ Post Filter    â”‚
â”‚  (å‰ç½®å¤„ç†)   (è½¬å‘è¯·æ±‚)  (åç½®å¤„ç†)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Reactor Netty å¼‚æ­¥IO            â”‚
â”‚         (éé˜»å¡å¼ç½‘ç»œé€šä¿¡)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â†“
  åç«¯å¾®æœåŠ¡
```

**ğŸ’¡ å·¥ä½œæµç¨‹è¯´æ˜**

**æ­¥éª¤1ï¼šè¯·æ±‚åˆ°è¾¾**
- å®¢æˆ·ç«¯å‘èµ·HTTPè¯·æ±‚åˆ°Gateway
- NettyæœåŠ¡å™¨æ¥æ”¶è¯·æ±‚ï¼ˆéé˜»å¡ï¼‰

**æ­¥éª¤2ï¼šè·¯ç”±åŒ¹é…**
- HandlerMappingæŸ¥æ‰¾åŒ¹é…çš„Route
- Predicateåˆ¤æ–­è¯·æ±‚æ˜¯å¦ç¬¦åˆæ¡ä»¶

**æ­¥éª¤3ï¼šè¿‡æ»¤å¤„ç†**
- æ‰§è¡ŒPre Filterï¼ˆå‰ç½®è¿‡æ»¤ï¼‰
- è½¬å‘è¯·æ±‚åˆ°ç›®æ ‡æœåŠ¡
- æ‰§è¡ŒPost Filterï¼ˆåç½®è¿‡æ»¤ï¼‰

**æ­¥éª¤4ï¼šè¿”å›å“åº”**
- é€šè¿‡Nettyå¼‚æ­¥è¿”å›å“åº”
- å®Œæˆæ•´ä¸ªè¯·æ±‚å¤„ç†æµç¨‹

### 1.3 æ ¸å¿ƒç»„ä»¶å…³ç³»


**ğŸ”— ç»„ä»¶åä½œå…³ç³»**
```
Route (è·¯ç”±)
  â”œâ”€â”€ id: è·¯ç”±å”¯ä¸€æ ‡è¯†
  â”œâ”€â”€ uri: ç›®æ ‡æœåŠ¡åœ°å€
  â”œâ”€â”€ predicates: [æ–­è¨€åˆ—è¡¨]
  â”‚     â”œâ”€â”€ Path=/api/**
  â”‚     â”œâ”€â”€ Method=GET
  â”‚     â””â”€â”€ Header=token
  â””â”€â”€ filters: [è¿‡æ»¤å™¨åˆ—è¡¨]
        â”œâ”€â”€ AddRequestHeader
        â”œâ”€â”€ StripPrefix
        â””â”€â”€ RateLimiter
```

---

## 2. ğŸ›£ï¸ Routeè·¯ç”±å®šä¹‰


### 2.1 è·¯ç”±æ˜¯ä»€ä¹ˆ


**ğŸ”¸ ç”Ÿæ´»åŒ–ç†è§£**

è·¯ç”±å°±åƒå¿«é€’åˆ†æ‹£ä¸­å¿ƒçš„è§„åˆ™ï¼š
- çœ‹å¿«é€’å•å·ï¼ˆè¯·æ±‚è·¯å¾„ï¼‰
- åˆ¤æ–­ç›®çš„åœ°ï¼ˆPredicateæ–­è¨€ï¼‰
- é€‰æ‹©è¿è¾“è·¯çº¿ï¼ˆç›®æ ‡æœåŠ¡URIï¼‰
- ç»è¿‡åˆ†æ‹£å¤„ç†ï¼ˆFilterè¿‡æ»¤ï¼‰

**ğŸ“‹ è·¯ç”±çš„ä¸‰è¦ç´ **
```
1. IDæ ‡è¯†ï¼šç»™è¿™æ¡è·¯ç”±èµ·ä¸ªåå­—
2. ç›®æ ‡URIï¼šè¯·æ±‚è¦è½¬å‘åˆ°å“ªé‡Œ
3. æ¡ä»¶é…ç½®ï¼š
   - Predicatesï¼šä»€ä¹ˆæ ·çš„è¯·æ±‚èµ°è¿™æ¡è·¯ç”±
   - Filtersï¼šè¯·æ±‚è¿‡ç¨‹ä¸­è¦åšä»€ä¹ˆå¤„ç†
```

### 2.2 è·¯ç”±é…ç½®æ–¹å¼


**æ–¹å¼1ï¼šé…ç½®æ–‡ä»¶æ–¹å¼ï¼ˆæ¨èæ–°æ‰‹ï¼‰**

```yaml
spring:
  cloud:
    gateway:
      routes:
        # è·¯ç”±1ï¼šç”¨æˆ·æœåŠ¡
        - id: user_route              # è·¯ç”±ID
          uri: lb://user-service      # ç›®æ ‡æœåŠ¡ï¼ˆlb=è´Ÿè½½å‡è¡¡ï¼‰
          predicates:                 # æ–­è¨€æ¡ä»¶
            - Path=/user/**           # è·¯å¾„åŒ¹é…
          filters:                    # è¿‡æ»¤å™¨
            - StripPrefix=1           # å»æ‰/userå‰ç¼€
        
        # è·¯ç”±2ï¼šè®¢å•æœåŠ¡  
        - id: order_route
          uri: http://localhost:8082
          predicates:
            - Path=/order/**
            - Method=GET,POST
          filters:
            - AddRequestHeader=X-Request-Source, gateway
```

**ğŸ’¡ é…ç½®è§£è¯»**

```
è·¯ç”±user_routeåšäº†ä»€ä¹ˆï¼Ÿ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
è¯·æ±‚ï¼šGET /user/info

1ï¸âƒ£ åŒ¹é…åˆ¤æ–­
   Path=/user/** âœ“ ç¬¦åˆ
   
2ï¸âƒ£ è¿‡æ»¤å¤„ç†
   StripPrefix=1 â†’ å»æ‰ç¬¬ä¸€æ®µè·¯å¾„
   /user/info â†’ /info
   
3ï¸âƒ£ è½¬å‘è¯·æ±‚
   lb://user-service/info
   (è´Ÿè½½å‡è¡¡åˆ°ç”¨æˆ·æœåŠ¡çš„/infoæ¥å£)
```

**æ–¹å¼2ï¼šJavaä»£ç æ–¹å¼ï¼ˆçµæ´»ä½†å¤æ‚ï¼‰**

```java
@Configuration
public class GatewayConfig {
    
    @Bean
    public RouteLocator customRoutes(RouteLocatorBuilder builder) {
        return builder.routes()
            // è·¯ç”±1ï¼šç®€å•è·¯ç”±
            .route("simple_route", r -> r
                .path("/api/**")
                .uri("http://localhost:8080"))
            
            // è·¯ç”±2ï¼šå¸¦è¿‡æ»¤å™¨
            .route("filter_route", r -> r
                .path("/order/**")
                .filters(f -> f
                    .addRequestHeader("X-Gateway", "true")
                    .stripPrefix(1))
                .uri("lb://order-service"))
            .build();
    }
}
```

### 2.3 è·¯ç”±åŒ¹é…ä¼˜å…ˆçº§


**ğŸ¯ åŒ¹é…è§„åˆ™**

| ä¼˜å…ˆçº§ | è§„åˆ™ | è¯´æ˜ |
|-------|------|------|
| **æœ€é«˜** | `ç²¾ç¡®è·¯å¾„` | `/user/123` |
| **è¾ƒé«˜** | `å‰ç¼€åŒ¹é…` | `/user/**` |
| **ä¸€èˆ¬** | `æ­£åˆ™è¡¨è¾¾å¼` | `/user/\d+` |
| **å…œåº•** | `é»˜è®¤è·¯ç”±` | `/**` |

**ç¤ºä¾‹ï¼šå¤šè·¯ç”±å†²çª**
```yaml
routes:
  - id: exact_route
    uri: http://service-a
    predicates:
      - Path=/user/login        # ç²¾ç¡®åŒ¹é…

  - id: prefix_route  
    uri: http://service-b
    predicates:
      - Path=/user/**           # å‰ç¼€åŒ¹é…

# è¯·æ±‚ /user/login ä¼šåŒ¹é… exact_route
# è¯·æ±‚ /user/info ä¼šåŒ¹é… prefix_route
```

---

## 3. âš–ï¸ Predicateæ–­è¨€åˆ¤æ–­


### 3.1 æ–­è¨€çš„ä½œç”¨


**ğŸ”¸ ä»€ä¹ˆæ˜¯æ–­è¨€**

æ–­è¨€å°±æ˜¯"åˆ¤æ–­æ¡ä»¶"ï¼Œåƒé—¨å«æ£€æŸ¥è¯ä»¶ï¼š
- æ£€æŸ¥è¯·æ±‚è·¯å¾„å¯¹ä¸å¯¹
- éªŒè¯è¯·æ±‚æ–¹æ³•æ˜¯GETè¿˜æ˜¯POST
- çœ‹è¯·æ±‚å¤´é‡Œæœ‰æ²¡æœ‰å¿…éœ€ä¿¡æ¯
- åˆ¤æ–­è¯·æ±‚æ—¶é—´æ˜¯å¦åœ¨å…è®¸èŒƒå›´

**âœ… åªæœ‰æ»¡è¶³æ‰€æœ‰æ–­è¨€æ¡ä»¶ï¼Œè¯·æ±‚æ‰èƒ½è¿›å…¥è¿™æ¡è·¯ç”±**

### 3.2 å¸¸ç”¨æ–­è¨€ç±»å‹


**ğŸ“‹ å†…ç½®æ–­è¨€å·¥å‚**

â”Œâ”€ è·¯å¾„ç›¸å…³ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ **Path** - è·¯å¾„åŒ¹é…        â”‚
â”‚ â€¢ Path=/api/**            â”‚
â”‚ â€¢ Path=/user/{id}         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ æ–¹æ³•ç›¸å…³ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ **Method** - HTTPæ–¹æ³•      â”‚
â”‚ â€¢ Method=GET              â”‚
â”‚ â€¢ Method=POST,PUT         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ è¯·æ±‚å¤´ç›¸å…³ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ **Header** - è¯·æ±‚å¤´        â”‚
â”‚ â€¢ Header=token, \d+       â”‚
â”‚ â€¢ Header=X-User-Id        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ å‚æ•°ç›¸å…³ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ **Query** - æŸ¥è¯¢å‚æ•°       â”‚
â”‚ â€¢ Query=name              â”‚
â”‚ â€¢ Query=age, \d+          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ æ—¶é—´ç›¸å…³ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ **After/Before** - æ—¶é—´é™åˆ¶â”‚
â”‚ â€¢ After=2024-01-01T00:00  â”‚
â”‚ â€¢ Between=å¼€å§‹,ç»“æŸ        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

### 3.3 æ–­è¨€ç»„åˆä½¿ç”¨


**ğŸ”— ANDç»„åˆï¼ˆåŒæ—¶æ»¡è¶³ï¼‰**

```yaml
predicates:
  - Path=/api/**              # æ¡ä»¶1ï¼šè·¯å¾„åŒ¹é…
  - Method=POST               # æ¡ä»¶2ï¼šPOSTè¯·æ±‚
  - Header=Authorization      # æ¡ä»¶3ï¼šæœ‰token

# ä¸‰ä¸ªæ¡ä»¶éƒ½æ»¡è¶³æ‰é€šè¿‡
```

**å®é™…åº”ç”¨åœºæ™¯**
```yaml
# åœºæ™¯ï¼šé™åˆ¶APIè°ƒç”¨æ—¶é—´å’Œæ¥æº
routes:
  - id: business_route
    uri: lb://business-service
    predicates:
      - Path=/business/**
      - After=2024-01-01T09:00:00+08:00    # è¥ä¸šæ—¶é—´å
      - Before=2024-01-01T18:00:00+08:00   # ä¸‹ç­æ—¶é—´å‰
      - Header=X-Client-Type, mobile       # åªå…è®¸æ‰‹æœºç«¯
```

**ğŸ’¡ å¤šè·¯ç”±ORæ•ˆæœï¼ˆæ»¡è¶³å…¶ä¸€ï¼‰**
```yaml
# é€šè¿‡å¤šä¸ªè·¯ç”±å®ç°ORé€»è¾‘
routes:
  - id: admin_route
    uri: lb://admin-service
    predicates:
      - Path=/admin/**
      
  - id: vip_route  
    uri: lb://admin-service
    predicates:
      - Header=X-User-Level, VIP

# ç®¡ç†å‘˜è·¯å¾„ OR VIPç”¨æˆ· éƒ½èƒ½è®¿é—®admin-service
```

### 3.4 è‡ªå®šä¹‰æ–­è¨€


**åœºæ™¯ï¼šéœ€è¦å¤æ‚ä¸šåŠ¡åˆ¤æ–­**

```java
// 1. è‡ªå®šä¹‰æ–­è¨€é…ç½®ç±»
public class IpCheckRoutePredicateFactory 
    extends AbstractRoutePredicateFactory<IpCheckRoutePredicateFactory.Config> {
    
    public IpCheckRoutePredicateFactory() {
        super(Config.class);
    }
    
    @Override
    public Predicate<ServerWebExchange> apply(Config config) {
        return exchange -> {
            String clientIp = getClientIp(exchange);
            // åˆ¤æ–­IPæ˜¯å¦åœ¨ç™½åå•ä¸­
            return config.getAllowedIps().contains(clientIp);
        };
    }
    
    public static class Config {
        private List<String> allowedIps;
        // getter/setter
    }
}

// 2. ä½¿ç”¨è‡ªå®šä¹‰æ–­è¨€
@Configuration
public class GatewayConfig {
    @Bean
    public RouteLocator routes(RouteLocatorBuilder builder, 
                               IpCheckRoutePredicateFactory ipCheck) {
        return builder.routes()
            .route(r -> r
                .predicate(ipCheck.apply(c -> 
                    c.setAllowedIps(List.of("192.168.1.100"))))
                .uri("lb://secure-service"))
            .build();
    }
}
```

---

## 4. ğŸ”§ Filterè¿‡æ»¤å™¨é“¾


### 4.1 è¿‡æ»¤å™¨çš„ä½œç”¨


**ğŸ”¸ ä»€ä¹ˆæ˜¯è¿‡æ»¤å™¨**

è¿‡æ»¤å™¨å°±åƒæµæ°´çº¿ä¸Šçš„å·¥äººï¼š
- **å‰ç½®å¤„ç†ï¼ˆPreï¼‰**ï¼šè¯·æ±‚å‘ç»™åç«¯å‰åšçš„äº‹
  - åŠ ä¸ªè¯·æ±‚å¤´ã€æ”¹ä¸ªå‚æ•°
  - éªŒè¯æƒé™ã€è®°å½•æ—¥å¿—
  
- **åç½®å¤„ç†ï¼ˆPostï¼‰**ï¼šåç«¯è¿”å›ååšçš„äº‹
  - ä¿®æ”¹å“åº”å¤´ã€æ·»åŠ æ•°æ®
  - ç»Ÿè®¡è€—æ—¶ã€å¤„ç†å¼‚å¸¸

**ğŸ”„ è¿‡æ»¤å™¨é“¾æ‰§è¡Œæµç¨‹**
```
è¯·æ±‚ â†’ Pre Filter 1 â†’ Pre Filter 2 â†’ åç«¯æœåŠ¡
                                         â†“
å“åº” â† Post Filter 1 â† Post Filter 2 â†â”€â”€â”˜
```

### 4.2 Filteråˆ†ç±»


**ğŸ“‚ ä¸¤å¤§ç±»å‹**

â”Œâ”€ GatewayFilter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ **ç½‘å…³è¿‡æ»¤å™¨ï¼ˆå±€éƒ¨ï¼‰**       â”‚
â”‚ â€¢ åªä½œç”¨äºé…ç½®çš„è·¯ç”±         â”‚
â”‚ â€¢ åœ¨routesä¸‹é…ç½®            â”‚
â”‚ â€¢ çµæ´»é’ˆå¯¹å•ä¸ªè·¯ç”±          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ GlobalFilter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ **å…¨å±€è¿‡æ»¤å™¨ï¼ˆå…¨å±€ï¼‰**       â”‚
â”‚ â€¢ ä½œç”¨äºæ‰€æœ‰è·¯ç”±            â”‚
â”‚ â€¢ é€šè¿‡@Beanæ³¨å†Œ             â”‚
â”‚ â€¢ ç»Ÿä¸€å¤„ç†å…¨å±€é€»è¾‘          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

### 4.3 å†…ç½®è¿‡æ»¤å™¨


**ğŸ› ï¸ å¸¸ç”¨å†…ç½®è¿‡æ»¤å™¨**

| è¿‡æ»¤å™¨ | ä½œç”¨ | é…ç½®ç¤ºä¾‹ |
|--------|------|----------|
| `AddRequestHeader` | æ·»åŠ è¯·æ±‚å¤´ | `AddRequestHeader=X-User, admin` |
| `AddRequestParameter` | æ·»åŠ è¯·æ±‚å‚æ•° | `AddRequestParameter=source, gateway` |
| `StripPrefix` | å»é™¤è·¯å¾„å‰ç¼€ | `StripPrefix=1` (å»æ‰ç¬¬ä¸€æ®µ) |
| `PrefixPath` | æ·»åŠ è·¯å¾„å‰ç¼€ | `PrefixPath=/api` |
| `RewritePath` | é‡å†™è·¯å¾„ | `RewritePath=/red(?<segment>.*), ${segment}` |
| `RequestRateLimiter` | é™æµ | `RequestRateLimiter=ä»¤ç‰Œæ¡¶ç®—æ³•` |

**å®æˆ˜ç¤ºä¾‹ï¼šè·¯å¾„å¤„ç†**
```yaml
routes:
  - id: path_example
    uri: http://localhost:8080
    predicates:
      - Path=/api/user/**
    filters:
      - StripPrefix=2           # å»æ‰å‰2æ®µ
      - PrefixPath=/service     # æ·»åŠ å‰ç¼€

# è¯·æ±‚ï¼š/api/user/info
# å¤„ç†ï¼šå»æ‰/api/user â†’ /info
# å†åŠ ï¼š/service â†’ /service/info
# å®é™…ï¼šhttp://localhost:8080/service/info
```

**å®æˆ˜ç¤ºä¾‹ï¼šè¯·æ±‚å¢å¼º**
```yaml
routes:
  - id: enhance_request
    uri: lb://backend-service
    predicates:
      - Path=/business/**
    filters:
      # æ·»åŠ è¯·æ±‚å¤´
      - AddRequestHeader=X-Gateway-Time, #{T(System).currentTimeMillis()}
      # æ·»åŠ è¯·æ±‚å‚æ•°
      - AddRequestParameter=gateway, spring-cloud-gateway
      # ä¿®æ”¹å“åº”å¤´
      - AddResponseHeader=X-Response-From, Gateway
```

### 4.4 è‡ªå®šä¹‰è¿‡æ»¤å™¨


**åœºæ™¯1ï¼šç»Ÿè®¡è¯·æ±‚è€—æ—¶ï¼ˆå…¨å±€è¿‡æ»¤å™¨ï¼‰**

```java
@Component
public class TimeStatisticsFilter implements GlobalFilter, Ordered {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, 
                             GatewayFilterChain chain) {
        // è®°å½•å¼€å§‹æ—¶é—´
        long startTime = System.currentTimeMillis();
        
        // æ‰§è¡Œåç»­è¿‡æ»¤å™¨
        return chain.filter(exchange).then(
            Mono.fromRunnable(() -> {
                // è®¡ç®—è€—æ—¶
                long duration = System.currentTimeMillis() - startTime;
                String path = exchange.getRequest().getPath().value();
                System.out.println(path + " è€—æ—¶: " + duration + "ms");
            })
        );
    }
    
    @Override
    public int getOrder() {
        return -1; // ä¼˜å…ˆçº§ï¼ˆæ•°å­—è¶Šå°è¶Šä¼˜å…ˆï¼‰
    }
}
```

**åœºæ™¯2ï¼šTokenéªŒè¯ï¼ˆå±€éƒ¨è¿‡æ»¤å™¨ï¼‰**

```java
@Component
public class AuthGatewayFilterFactory 
    extends AbstractGatewayFilterFactory<AuthGatewayFilterFactory.Config> {
    
    public AuthGatewayFilterFactory() {
        super(Config.class);
    }
    
    @Override
    public GatewayFilter apply(Config config) {
        return (exchange, chain) -> {
            String token = exchange.getRequest()
                .getHeaders()
                .getFirst("Authorization");
            
            // éªŒè¯token
            if (token == null || !validateToken(token)) {
                exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);
                return exchange.getResponse().setComplete();
            }
            
            return chain.filter(exchange);
        };
    }
    
    public static class Config {
        // é…ç½®å‚æ•°
    }
}
```

### 4.5 è¿‡æ»¤å™¨æ‰§è¡Œé¡ºåº


**ğŸ”¢ é¡ºåºæ§åˆ¶è§„åˆ™**

```
1. Orderå€¼è¶Šå°è¶Šä¼˜å…ˆ
2. å…¨å±€è¿‡æ»¤å™¨é»˜è®¤æŒ‰æ·»åŠ é¡ºåº
3. åŒOrderå€¼æŒ‰æ·»åŠ é¡ºåº

æ‰§è¡Œé¡ºåºç¤ºä¾‹ï¼š
GlobalFilter A (Order=-1)  â†’ æœ€å…ˆæ‰§è¡Œ
GlobalFilter B (Order=0)   â†’ å…¶æ¬¡
GatewayFilter X (Order=1)  â†’ å†æ¬¡
GatewayFilter Y (Order=1)  â†’ æœ€åï¼ˆåŒOrderæŒ‰é…ç½®é¡ºåºï¼‰
```

---

## 5. ğŸŒŠ WebFluxå“åº”å¼åŸºç¡€


### 5.1 ä»€ä¹ˆæ˜¯å“åº”å¼ç¼–ç¨‹


**ğŸ”¸ ä¼ ç»Ÿæ–¹å¼ vs å“åº”å¼**

```
ä¼ ç»Ÿé˜»å¡æ¨¡å¼ï¼ˆåŒæ­¥ï¼‰ï¼š
æœåŠ¡å‘˜ç‚¹é¤ â†’ ç­‰å¨æˆ¿åšå®Œ â†’ ä¸Šèœ â†’ ä¸‹ä¸€æ¡Œ
           (é˜»å¡ç­‰å¾…)
æ¯ä¸ªè¯·æ±‚å ç”¨ä¸€ä¸ªçº¿ç¨‹ï¼Œçº¿ç¨‹ç­‰å¾…æ—¶æµªè´¹èµ„æº

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

å“åº”å¼æ¨¡å¼ï¼ˆå¼‚æ­¥éé˜»å¡ï¼‰ï¼š
æœåŠ¡å‘˜ç‚¹é¤ â†’ å»æœåŠ¡ä¸‹ä¸€æ¡Œ â†’ èœå¥½äº†é€šçŸ¥ â†’ ä¸Šèœ
           (ä¸ç­‰å¾…)           (å›è°ƒ)
å°‘é‡çº¿ç¨‹å¤„ç†å¤§é‡è¯·æ±‚ï¼Œç­‰å¾…æ—¶å¯ä»¥å¤„ç†å…¶ä»–è¯·æ±‚
```

**ğŸ’¡ å“åº”å¼æ ¸å¿ƒæ€æƒ³**
- **å¼‚æ­¥éé˜»å¡**ï¼šä¸ç­‰å¾…ï¼Œç»§ç»­åšå…¶ä»–äº‹
- **äº‹ä»¶é©±åŠ¨**ï¼šæœ‰ç»“æœäº†é€šçŸ¥æˆ‘
- **æ•°æ®æµ**ï¼šæ•°æ®åƒæµæ°´ä¸€æ ·å¤„ç†

### 5.2 WebFluxæ ¸å¿ƒç»„ä»¶


**ğŸ“š Reactoræ ¸å¿ƒç±»**

â”Œâ”€ Mono â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ **0æˆ–1ä¸ªå…ƒç´ çš„æµ**          â”‚
â”‚                            â”‚
â”‚ ç”¨é€”ï¼šå•ä¸ªç»“æœ             â”‚
â”‚ â€¢ æŸ¥è¯¢ä¸€æ¡è®°å½•             â”‚
â”‚ â€¢ è¯·æ±‚å•ä¸ªå“åº”             â”‚
â”‚                            â”‚
â”‚ Mono<User> findById(1)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ Flux â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ **0åˆ°Nä¸ªå…ƒç´ çš„æµ**          â”‚
â”‚                            â”‚
â”‚ ç”¨é€”ï¼šå¤šä¸ªç»“æœ             â”‚
â”‚ â€¢ æŸ¥è¯¢åˆ—è¡¨                 â”‚
â”‚ â€¢ å®æ—¶æ•°æ®æµ               â”‚
â”‚                            â”‚
â”‚ Flux<User> findAll()       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

**ä»£ç ç¤ºä¾‹**
```java
// Monoç¤ºä¾‹ï¼šå•ä¸ªç”¨æˆ·
Mono<User> userMono = userService.findById(1);
userMono.subscribe(user -> System.out.println(user.getName()));

// Fluxç¤ºä¾‹ï¼šç”¨æˆ·åˆ—è¡¨
Flux<User> usersFlux = userService.findAll();
usersFlux.subscribe(user -> System.out.println(user.getName()));
```

### 5.3 Gatewayä¸­çš„WebFluxåº”ç”¨


**ğŸ”„ è¯·æ±‚å“åº”æµç¨‹**

```java
// Gatewayä¸­çš„å“åº”å¼å¤„ç†
public Mono<Void> filter(ServerWebExchange exchange, 
                         GatewayFilterChain chain) {
    
    // 1. å¼‚æ­¥å¤„ç†è¯·æ±‚
    return Mono.fromRunnable(() -> {
        // å‰ç½®å¤„ç†ï¼ˆä¸é˜»å¡ï¼‰
        addRequestHeader(exchange);
    })
    // 2. è½¬å‘åˆ°ä¸‹æ¸¸ï¼ˆéé˜»å¡ï¼‰
    .then(chain.filter(exchange))
    // 3. åç½®å¤„ç†ï¼ˆä¸é˜»å¡ï¼‰
    .then(Mono.fromRunnable(() -> {
        addResponseHeader(exchange);
    }));
}
```

**ğŸ’¡ ä¸ºä»€ä¹ˆGatewayç”¨WebFluxï¼Ÿ**

```
ä¼˜åŠ¿å¯¹æ¯”ï¼š

ä¼ ç»ŸServletï¼š
â€¢ æ¯è¯·æ±‚ä¸€çº¿ç¨‹
â€¢ çº¿ç¨‹é˜»å¡ç­‰å¾…
â€¢ 10000è¯·æ±‚ = 10000çº¿ç¨‹ï¼ˆä¸å¯è¡Œï¼‰

WebFluxï¼š
â€¢ å°‘é‡çº¿ç¨‹ï¼ˆCPUæ ¸å¿ƒæ•°çš„2å€ï¼‰
â€¢ éé˜»å¡å¤„ç†
â€¢ 10000è¯·æ±‚ = å‡ åä¸ªçº¿ç¨‹ï¼ˆé«˜æ•ˆï¼‰

ç‰¹åˆ«é€‚åˆï¼š
âœ“ é«˜å¹¶å‘åœºæ™¯
âœ“ I/Oå¯†é›†å‹æ“ä½œ
âœ“ ç½‘å…³è½¬å‘ä¸šåŠ¡
```

### 5.4 å“åº”å¼å¸¸ç”¨æ“ä½œ


**ğŸ› ï¸ æ•°æ®è½¬æ¢æ“ä½œ**

```java
// mapï¼šè½¬æ¢å…ƒç´ 
Mono<String> nameMono = userMono
    .map(user -> user.getName());

// flatMapï¼šè½¬æ¢ä¸ºæ–°çš„æµ
Mono<Order> orderMono = userMono
    .flatMap(user -> orderService.findByUserId(user.getId()));

// filterï¼šè¿‡æ»¤å…ƒç´   
Flux<User> adultUsers = usersFlux
    .filter(user -> user.getAge() >= 18);

// zipWithï¼šåˆå¹¶æµ
Mono<Tuple2<User, Order>> combined = userMono
    .zipWith(orderMono);
```

---

## 6. âš¡ Reactor Nettyå¼‚æ­¥IO


### 6.1 Nettyæ˜¯ä»€ä¹ˆ


**ğŸ”¸ é€šä¿—ç†è§£**

Nettyå°±åƒä¸€ä¸ªé«˜æ•ˆçš„å¿«é€’å‘˜è°ƒåº¦ç³»ç»Ÿï¼š
- **ä¼ ç»ŸIO**ï¼šä¸€ä¸ªå¿«é€’å‘˜é€ä¸€ä¸ªå¿«é€’ï¼ˆä¸€ä¸ªçº¿ç¨‹å¤„ç†ä¸€ä¸ªè¿æ¥ï¼‰
- **Nettyå¼‚æ­¥IO**ï¼šä¸€ä¸ªè°ƒåº¦å‘˜ç®¡ç†å¤šä¸ªå¿«é€’å‘˜ï¼Œè°ç©ºé—²è°æ¥å•

**ğŸ“‹ Nettyæ ¸å¿ƒç‰¹ç‚¹**
```
âœ“ å¼‚æ­¥éé˜»å¡ï¼šä¸ç­‰å¾…ï¼Œç»§ç»­å¤„ç†å…¶ä»–ä»»åŠ¡
âœ“ äº‹ä»¶é©±åŠ¨ï¼šæœ‰äº‹ä»¶å‘ç”Ÿæ—¶å›è°ƒå¤„ç†
âœ“ é«˜æ€§èƒ½ï¼šå•æœºæ”¯æŒç™¾ä¸‡çº§è¿æ¥
âœ“ æ˜“ç”¨æ€§ï¼šå°è£…äº†åº•å±‚NIOå¤æ‚æ€§
```

### 6.2 Nettyåœ¨Gatewayä¸­çš„ä½œç”¨


**ğŸ—ï¸ Nettyæ¶æ„å±‚æ¬¡**

```
Gatewayåº”ç”¨å±‚
     â†“
Spring WebFlux
     â†“
Reactor Netty (ç½‘ç»œé€šä¿¡å±‚)
     â†“
Netty (åº•å±‚NIOå°è£…)
     â†“
Java NIO (æ“ä½œç³»ç»ŸIO)
```

**ğŸ”„ è¯·æ±‚å¤„ç†æµç¨‹**

```
å®¢æˆ·ç«¯è¿æ¥
    â†“
Netty EventLoopæ¥æ”¶
    â†“
è§£æHTTPè¯·æ±‚ (éé˜»å¡)
    â†“
WebFluxå¤„ç†å™¨ (å“åº”å¼)
    â†“
ç½‘å…³è·¯ç”±+è¿‡æ»¤
    â†“
Nettyè½¬å‘è¯·æ±‚ (å¼‚æ­¥)
    â†“
åç«¯å“åº”
    â†“
Nettyè¿”å›å®¢æˆ·ç«¯
```

### 6.3 EventLoopäº‹ä»¶å¾ªç¯


**ğŸ” EventLoopå·¥ä½œåŸç†**

```
EventLoopå°±åƒä¸€ä¸ªæ°¸ä¸åœæ­‡çš„å·¥äººï¼š

while(true) {
    1. æ£€æŸ¥æœ‰æ²¡æœ‰æ–°è¿æ¥  â†’ æ¥å—è¿æ¥
    2. æ£€æŸ¥æœ‰æ²¡æœ‰æ•°æ®æ¥  â†’ è¯»å–æ•°æ®
    3. æ£€æŸ¥æœ‰æ²¡æœ‰è¦å‘é€  â†’ å‘é€æ•°æ®
    4. æ‰§è¡Œå®šæ—¶ä»»åŠ¡      â†’ å¤„ç†ä»»åŠ¡
}

ç‰¹ç‚¹ï¼š
â€¢ å•çº¿ç¨‹å¾ªç¯
â€¢ éé˜»å¡æ‰§è¡Œ
â€¢ é«˜æ•ˆäº‹ä»¶åˆ†å‘
```

**ğŸ’¡ å¤šEventLoopå¹¶å‘**

```
Nettyé€šè¿‡å¤šä¸ªEventLoopå®ç°é«˜å¹¶å‘ï¼š

EventLoop-1 â†’ [è¿æ¥A, è¿æ¥B, è¿æ¥C]
EventLoop-2 â†’ [è¿æ¥D, è¿æ¥E, è¿æ¥F]  
EventLoop-3 â†’ [è¿æ¥G, è¿æ¥H, è¿æ¥I]

â€¢ æ¯ä¸ªè¿æ¥ç»‘å®šä¸€ä¸ªEventLoop
â€¢ ä¸€ä¸ªEventLoopå¤„ç†å¤šä¸ªè¿æ¥
â€¢ é¿å…çº¿ç¨‹åˆ‡æ¢å¼€é”€
```

### 6.4 é…ç½®ä¼˜åŒ–


**âš™ï¸ æ€§èƒ½è°ƒä¼˜é…ç½®**

```yaml
spring:
  cloud:
    gateway:
      httpclient:
        # è¿æ¥æ± é…ç½®
        pool:
          max-connections: 1000        # æœ€å¤§è¿æ¥æ•°
          max-idle-time: 30s          # ç©ºé—²è¶…æ—¶
          max-life-time: 60s          # è¿æ¥æœ€å¤§å­˜æ´»
        
        # è¿æ¥è¶…æ—¶
        connect-timeout: 5000         # 5ç§’
        
        # å“åº”è¶…æ—¶  
        response-timeout: 10s
        
        # æ˜¯å¦å‹ç¼©
        compression: true
```

---

## 7. ğŸ—ºï¸ HandlerMappingè·¯ç”±æ˜ å°„


### 7.1 HandlerMappingä½œç”¨


**ğŸ”¸ ä»€ä¹ˆæ˜¯HandlerMapping**

HandlerMappingå°±åƒå›¾ä¹¦é¦†çš„ç´¢å¼•ç³»ç»Ÿï¼š
- ä½ æŠ¥ä¹¦åï¼ˆè¯·æ±‚URLï¼‰
- æŸ¥ç´¢å¼•å¡ï¼ˆHandlerMappingï¼‰
- æ‰¾åˆ°ä¹¦æ¶ä½ç½®ï¼ˆè·¯ç”±Routeï¼‰
- å–åˆ°ä¹¦ï¼ˆè½¬å‘è¯·æ±‚ï¼‰

**ğŸ“‹ æ ¸å¿ƒèŒè´£**
```
1. æ¥æ”¶è¯·æ±‚
2. æŸ¥æ‰¾åŒ¹é…çš„Route
3. è¿”å›å¯¹åº”çš„Handler
4. äº¤ç»™FilterChainå¤„ç†
```

### 7.2 è·¯ç”±æŸ¥æ‰¾æµç¨‹


**ğŸ” åŒ¹é…è¿‡ç¨‹**

```
è¯·æ±‚åˆ°è¾¾
    â†“
RoutePredicateHandlerMappingå¯åŠ¨
    â†“
éå†æ‰€æœ‰Route
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Route 1                 â”‚
â”‚ predicates: ä¸åŒ¹é… âœ—    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Route 2                 â”‚
â”‚ predicates: åŒ¹é… âœ“      â”‚ â†’ è¿”å›æ­¤Route
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
æ„å»ºFilterChain
    â†“
æ‰§è¡Œè¿‡æ»¤å™¨é“¾
```

### 7.3 æ ¸å¿ƒå®ç°ç±»


**ğŸ“š å…³é”®ç»„ä»¶**

| ç»„ä»¶ | ä½œç”¨ |
|------|------|
| `RoutePredicateHandlerMapping` | ä¸»è¦è·¯ç”±æ˜ å°„å™¨ |
| `RouteLocator` | è·¯ç”±å®šä½å™¨ï¼Œæä¾›Route |
| `RouteDefinitionLocator` | è·¯ç”±å®šä¹‰åŠ è½½å™¨ |
| `RoutePredicateFactory` | æ–­è¨€å·¥å‚ï¼Œåˆ›å»ºPredicate |

**ğŸ”— ç»„ä»¶å…³ç³»**
```
RoutePredicateHandlerMapping
         â†“ (ä¾èµ–)
    RouteLocator
         â†“ (è·å–)
  List<Route> routes
         â†“ (åŒ…å«)
    Route (id, uri, predicates, filters)
```

### 7.4 åŠ¨æ€è·¯ç”±


**ğŸ”„ åŠ¨æ€åŠ è½½è·¯ç”±**

```java
@Service
public class DynamicRouteService {
    
    @Autowired
    private RouteDefinitionWriter routeDefinitionWriter;
    
    // æ·»åŠ è·¯ç”±
    public void addRoute(RouteDefinition definition) {
        routeDefinitionWriter.save(Mono.just(definition))
            .subscribe();
        // åˆ·æ–°è·¯ç”±
        refreshRoutes();
    }
    
    // åˆ é™¤è·¯ç”±
    public void deleteRoute(String routeId) {
        routeDefinitionWriter.delete(Mono.just(routeId))
            .subscribe();
        refreshRoutes();
    }
    
    // åˆ·æ–°è·¯ç”±ï¼ˆå‘å¸ƒäº‹ä»¶ï¼‰
    private void refreshRoutes() {
        applicationEventPublisher.publishEvent(
            new RefreshRoutesEvent(this));
    }
}
```

**å®é™…åº”ç”¨**
```java
// ä»æ•°æ®åº“åŠ è½½è·¯ç”±
@Component
public class DatabaseRouteLoader implements ApplicationRunner {
    
    @Autowired
    private DynamicRouteService routeService;
    
    @Override
    public void run(ApplicationArguments args) {
        // ä»æ•°æ®åº“æŸ¥è¯¢è·¯ç”±é…ç½®
        List<RouteConfig> configs = routeRepository.findAll();
        
        configs.forEach(config -> {
            RouteDefinition definition = new RouteDefinition();
            definition.setId(config.getId());
            definition.setUri(URI.create(config.getUri()));
            // è®¾ç½®predicateså’Œfilters...
            
            routeService.addRoute(definition);
        });
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 æ¶æ„æ ¸å¿ƒç†è§£


**ğŸ”¸ å…­å¤§ç»„ä»¶è®°å¿†**

```
1ï¸âƒ£ Route (è·¯ç”±)
   â†’ å®šä¹‰ï¼šå»å“ªé‡Œ
   â†’ åŒ…å«ï¼šIDã€URIã€æ¡ä»¶ã€è¿‡æ»¤

2ï¸âƒ£ Predicate (æ–­è¨€)  
   â†’ ä½œç”¨ï¼šåˆ¤æ–­æ˜¯å¦åŒ¹é…
   â†’ ç±»å‹ï¼šè·¯å¾„ã€æ–¹æ³•ã€å¤´ã€å‚æ•°ç­‰

3ï¸âƒ£ Filter (è¿‡æ»¤å™¨)
   â†’ åŠŸèƒ½ï¼šè¯·æ±‚/å“åº”å¤„ç†
   â†’ åˆ†ç±»ï¼šå±€éƒ¨/å…¨å±€

4ï¸âƒ£ WebFlux (å“åº”å¼)
   â†’ ç‰¹ç‚¹ï¼šå¼‚æ­¥éé˜»å¡
   â†’ æ ¸å¿ƒï¼šMonoå’ŒFlux

5ï¸âƒ£ Reactor Netty
   â†’ ä½œç”¨ï¼šé«˜æ€§èƒ½ç½‘ç»œé€šä¿¡
   â†’ ä¼˜åŠ¿ï¼šå°‘çº¿ç¨‹é«˜å¹¶å‘

6ï¸âƒ£ HandlerMapping
   â†’ èŒè´£ï¼šè·¯ç”±æŸ¥æ‰¾æ˜ å°„
   â†’ æµç¨‹ï¼šåŒ¹é…â†’è¿‡æ»¤â†’è½¬å‘
```

### 8.2 å…³é”®æµç¨‹æ¢³ç†


**ğŸ”„ å®Œæ•´è¯·æ±‚æµç¨‹**

```
                Gatewayå¤„ç†å…¨æµç¨‹
                        
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    1.æ¥æ”¶    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®¢æˆ·ç«¯  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”‚ NettyæœåŠ¡å™¨   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“ 2.è§£æ
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ HandlerMappingâ”‚
                        â”‚   æŸ¥æ‰¾è·¯ç”±    â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“ 3.åˆ¤æ–­
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  Predicate   â”‚
                        â”‚   æ–­è¨€åŒ¹é…   â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“ 4.å¤„ç†
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ Filter Chain â”‚
                        â”‚  è¿‡æ»¤å™¨æ‰§è¡Œ  â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“ 5.è½¬å‘
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  åç«¯æœåŠ¡    â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.3 é…ç½®è¦ç‚¹é€Ÿè®°


**âš™ï¸ å¿«é€Ÿé…ç½®æ¨¡æ¿**

```yaml
spring:
  cloud:
    gateway:
      routes:
        - id: [è·¯ç”±å]
          uri: [ç›®æ ‡åœ°å€]
          predicates:
            - Path=[è·¯å¾„]
            - Method=[æ–¹æ³•]
          filters:
            - StripPrefix=[æ•°å­—]
            - AddRequestHeader=[key,value]
```

### 8.4 å­¦ä¹ è·¯å¾„å»ºè®®


**ğŸ“š è¿›é˜¶å­¦ä¹ é¡ºåº**

```
ç¬¬1æ­¥ï¼šç†è§£åŸºç¡€
âœ“ Routeã€Predicateã€Filterä¸‰è¦ç´ 
âœ“ é…ç½®æ–‡ä»¶æ–¹å¼å®ç°ç®€å•è·¯ç”±

ç¬¬2æ­¥ï¼šæŒæ¡åŸç†  
âœ“ WebFluxå“åº”å¼æ€æƒ³
âœ“ Nettyå¼‚æ­¥IOæœºåˆ¶
âœ“ HandlerMappingæ˜ å°„è¿‡ç¨‹

ç¬¬3æ­¥ï¼šå®æˆ˜åº”ç”¨
âœ“ è‡ªå®šä¹‰Filterå®ç°ä¸šåŠ¡é€»è¾‘
âœ“ åŠ¨æ€è·¯ç”±é…ç½®
âœ“ æ€§èƒ½ä¼˜åŒ–è°ƒä¼˜

ç¬¬4æ­¥ï¼šæ·±å…¥æºç 
âœ“ é˜…è¯»æ ¸å¿ƒç±»å®ç°
âœ“ ç†è§£è®¾è®¡æ¨¡å¼åº”ç”¨
```

### 8.5 å¸¸è§é—®é¢˜è§£ç­”


**â“ FAQé€ŸæŸ¥**

**Q1: Routeã€Predicateã€Filterçš„å…³ç³»ï¼Ÿ**
```
Routeæ˜¯å®¹å™¨ï¼ŒåŒ…å«Predicateå’ŒFilter
Predicateè´Ÿè´£åŒ¹é…ï¼ŒFilterè´Ÿè´£å¤„ç†
å°±åƒï¼šRoute=é¤å…ï¼ŒPredicate=é—¨å«ï¼ŒFilter=å¨å¸ˆ
```

**Q2: ä¸ºä»€ä¹ˆç”¨WebFluxè€Œä¸æ˜¯Servletï¼Ÿ**
```
â€¢ Servletï¼šä¸€ä¸ªè¯·æ±‚ä¸€ä¸ªçº¿ç¨‹ï¼Œé«˜å¹¶å‘å‹åŠ›å¤§
â€¢ WebFluxï¼šå°‘é‡çº¿ç¨‹å¤„ç†æµ·é‡è¯·æ±‚ï¼Œå¤©ç”Ÿé€‚åˆç½‘å…³
```

**Q3: å¦‚ä½•é€‰æ‹©GatewayFilterè¿˜æ˜¯GlobalFilterï¼Ÿ**
```
â€¢ ç‰¹å®šè·¯ç”±é€»è¾‘ â†’ GatewayFilter
â€¢ å…¨å±€ç»Ÿä¸€é€»è¾‘ â†’ GlobalFilter
â€¢ ç¤ºä¾‹ï¼šé‰´æƒç”¨Globalï¼Œè·¯å¾„é‡å†™ç”¨Gateway
```

**Q4: Nettyå’ŒTomcatæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**
```
â€¢ Tomcatï¼šåŸºäºServletï¼Œé˜»å¡IO
â€¢ Nettyï¼šåŸºäºNIOï¼Œéé˜»å¡IO
â€¢ Gatewayé€‰Nettyæ˜¯ä¸ºäº†å¼‚æ­¥é«˜å¹¶å‘
```

---

**ğŸ¯ æœ¬ç« å­¦ä¹ ç›®æ ‡**

- âœ… ç†è§£Gatewayæ•´ä½“æ¶æ„è®¾è®¡
- âœ… æŒæ¡Routeã€Predicateã€Filterä¸‰å¤§æ ¸å¿ƒ
- âœ… äº†è§£WebFluxå“åº”å¼ç¼–ç¨‹æ€æƒ³
- âœ… è®¤è¯†Nettyå¼‚æ­¥IOçš„ä½œç”¨
- âœ… èƒ½å¤Ÿé…ç½®å’Œä½¿ç”¨Gatewayè·¯ç”±

**ä¸‹ä¸€ç« é¢„å‘Š**ï¼šGatewayå®æˆ˜åº”ç”¨ - é‰´æƒã€é™æµã€ç†”æ–­...