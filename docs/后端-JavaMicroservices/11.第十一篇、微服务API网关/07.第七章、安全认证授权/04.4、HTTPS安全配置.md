---
title: 4ã€HTTPSå®‰å…¨é…ç½®
---
## ğŸ“š ç›®å½•

1. [HTTPSåŸºç¡€æ¦‚å¿µ](#1-HTTPSåŸºç¡€æ¦‚å¿µ)
2. [SSL/TLSè¯ä¹¦é…ç½®](#2-SSLTLSè¯ä¹¦é…ç½®)
3. [TLSç‰ˆæœ¬å®‰å…¨æ§åˆ¶](#3-TLSç‰ˆæœ¬å®‰å…¨æ§åˆ¶)
4. [HTTPåˆ°HTTPSè‡ªåŠ¨è·³è½¬](#4-HTTPåˆ°HTTPSè‡ªåŠ¨è·³è½¬)
5. [å®‰å…¨å“åº”å¤´é…ç½®](#5-å®‰å…¨å“åº”å¤´é…ç½®)
6. [HSTSå®‰å…¨ç­–ç•¥](#6-HSTSå®‰å…¨ç­–ç•¥)
7. [è¯ä¹¦è‡ªåŠ¨ç»­æœŸæ–¹æ¡ˆ](#7-è¯ä¹¦è‡ªåŠ¨ç»­æœŸæ–¹æ¡ˆ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” HTTPSåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯HTTPS


**ç®€å•ç†è§£**ï¼šHTTPSå°±æ˜¯ç»™HTTPç©¿ä¸Šäº†ä¸€ä»¶"é˜²æŠ¤æœ"

```
HTTPé€šä¿¡ï¼ˆæ˜æ–‡ä¼ è¾“ï¼‰ï¼š
ç”¨æˆ· ----[è´¦å·:admin,å¯†ç :123456]----> æœåŠ¡å™¨
           â†‘ ä»»ä½•äººéƒ½èƒ½çœ‹åˆ°ï¼

HTTPSé€šä¿¡ï¼ˆåŠ å¯†ä¼ è¾“ï¼‰ï¼š
ç”¨æˆ· ----[%@#$!åŠ å¯†å†…å®¹&*()]----> æœåŠ¡å™¨
           â†‘ åªæœ‰åŒæ–¹èƒ½è§£å¯†ï¼
```

**æ ¸å¿ƒä½œç”¨**ï¼š
- ğŸ”’ **æ•°æ®åŠ å¯†**ï¼šä¼ è¾“å†…å®¹åŠ å¯†ï¼Œé˜²æ­¢è¢«çªƒå¬
- âœ… **èº«ä»½éªŒè¯**ï¼šç¡®è®¤æœåŠ¡å™¨æ˜¯çœŸçš„ï¼Œä¸æ˜¯å‡å†’çš„
- ğŸ›¡ï¸ **æ•°æ®å®Œæ•´**ï¼šé˜²æ­¢æ•°æ®åœ¨ä¼ è¾“ä¸­è¢«ç¯¡æ”¹

### 1.2 HTTPSå·¥ä½œåŸç†


**é€šä¿—æ¯”å–»**ï¼šå°±åƒå¯„å¿«é€’æ—¶ç”¨ä¿é™©ç®±

```
å»ºç«‹HTTPSè¿æ¥çš„è¿‡ç¨‹ï¼š

ç¬¬1æ­¥ï¼šå®¢æˆ·ç«¯é—®å€™
å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨ï¼š"ä½ å¥½,æˆ‘æ”¯æŒè¿™äº›åŠ å¯†ç®—æ³•"

ç¬¬2æ­¥ï¼šæœåŠ¡å™¨å‡ºç¤ºè¯ä¹¦
æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯ï¼š"è¿™æ˜¯æˆ‘çš„èº«ä»½è¯(è¯ä¹¦)"

ç¬¬3æ­¥ï¼šéªŒè¯è¯ä¹¦
å®¢æˆ·ç«¯æ£€æŸ¥ï¼š"è¿™ä¸ªèº«ä»½è¯æ˜¯çœŸçš„å—?"
         "æ˜¯CAæœºæ„é¢å‘çš„å—?"
         "æ²¡æœ‰è¿‡æœŸå§?"

ç¬¬4æ­¥ï¼šåå•†å¯†é’¥
åŒæ–¹å•†å®šï¼š"æˆ‘ä»¬ç”¨è¿™ä¸ªå¯†ç æœ¬(å¯†é’¥)é€šä¿¡"

ç¬¬5æ­¥ï¼šåŠ å¯†é€šä¿¡
å¼€å§‹ç”¨å¯†é’¥åŠ å¯†ä¼ è¾“æ•°æ® âœ“
```

### 1.3 ä¸ºä»€ä¹ˆAPIç½‘å…³éœ€è¦HTTPS


**å®‰å…¨åœºæ™¯å¯¹æ¯”**ï¼š

| åœºæ™¯ | HTTPé£é™© | HTTPSä¿æŠ¤ |
|------|---------|-----------|
| **ç”¨æˆ·ç™»å½•** | `å¯†ç è¢«çªƒå–` | `åŠ å¯†ä¼ è¾“,æ— æ³•ç ´è§£` |
| **æ”¯ä»˜æ“ä½œ** | `é“¶è¡Œå¡ä¿¡æ¯æ³„éœ²` | `ç«¯åˆ°ç«¯åŠ å¯†ä¿æŠ¤` |
| **APIè°ƒç”¨** | `Tokenè¢«åŠ«æŒ` | `å®‰å…¨ä¼ è¾“å‡­è¯` |
| **æ•æ„Ÿæ•°æ®** | `æ•°æ®è¢«ç¯¡æ”¹` | `å®Œæ•´æ€§æ ¡éªŒ` |

> ğŸ’¡ **é‡è¦æç¤º**ï¼šç°ä»£APIç½‘å…³å¿…é¡»ä½¿ç”¨HTTPSï¼Œè¿™æ˜¯å®‰å…¨çš„åº•çº¿è¦æ±‚ï¼

---

## 2. ğŸ“œ SSL/TLSè¯ä¹¦é…ç½®


### 2.1 è¯ä¹¦åŸºç¡€çŸ¥è¯†


**ä»€ä¹ˆæ˜¯SSL/TLSè¯ä¹¦?**

ç®€å•ç†è§£ï¼šè¯ä¹¦å°±æ˜¯ç½‘ç«™çš„"æ•°å­—èº«ä»½è¯"

```
è¯ä¹¦åŒ…å«çš„ä¿¡æ¯ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç½‘ç«™åŸŸåï¼šapi.example.com   â”‚
â”‚  æ‰€æœ‰è€…ï¼šæŸæŸå…¬å¸             â”‚
â”‚  æœ‰æ•ˆæœŸï¼š2024-01-01è‡³2025-01-01â”‚
â”‚  å…¬é’¥ï¼šç”¨äºåŠ å¯†çš„å¯†é’¥         â”‚
â”‚  ç­¾å‘æœºæ„ï¼šLet's Encrypt CA   â”‚
â”‚  æ•°å­—ç­¾åï¼šé˜²ä¼ªæ ‡è¯†           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¯ä¹¦ç±»å‹å¯¹æ¯”**ï¼š

| è¯ä¹¦ç±»å‹ | **éªŒè¯çº§åˆ«** | **é€‚ç”¨åœºæ™¯** | **ä»·æ ¼** | **è·å–æ—¶é—´** |
|---------|------------|-------------|---------|------------|
| **DVè¯ä¹¦** | `åŸŸåéªŒè¯` | `ä¸ªäººç½‘ç«™ã€æµ‹è¯•ç¯å¢ƒ` | `å…è´¹-ä½` | `å‡ åˆ†é’Ÿ` |
| **OVè¯ä¹¦** | `ç»„ç»‡éªŒè¯` | `ä¼ä¸šç½‘ç«™ã€APIæœåŠ¡` | `ä¸­ç­‰` | `1-3å¤©` |
| **EVè¯ä¹¦** | `æ‰©å±•éªŒè¯` | `é‡‘èã€ç”µå•†å¹³å°` | `è¾ƒé«˜` | `3-7å¤©` |

> ğŸ“ **æ–°æ‰‹å»ºè®®**ï¼šå­¦ä¹ é˜¶æ®µç”¨å…è´¹çš„Let's Encrypt DVè¯ä¹¦å³å¯

### 2.2 Spring Cloud Gatewayè¯ä¹¦é…ç½®


**é…ç½®æ­¥éª¤1ï¼šå‡†å¤‡è¯ä¹¦æ–‡ä»¶**

```
è¯ä¹¦æ–‡ä»¶æ¸…å•ï¼š
my-cert.crt     â† è¯ä¹¦æ–‡ä»¶(å…¬é’¥)
my-cert.key     â† ç§é’¥æ–‡ä»¶(å¿…é¡»ä¿å¯†!)
ca-bundle.crt   â† CAè¯ä¹¦é“¾(å¯é€‰)
```

**é…ç½®æ­¥éª¤2ï¼šSpring Booté…ç½®æ–‡ä»¶**

```yaml
# application.yml
server:
  port: 8443                    # HTTPSé»˜è®¤ç«¯å£
  ssl:
    enabled: true               # å¯ç”¨SSL
    key-store: classpath:keystore.p12    # å¯†é’¥åº“ä½ç½®
    key-store-password: your-password    # å¯†é’¥åº“å¯†ç 
    key-store-type: PKCS12              # å¯†é’¥åº“ç±»å‹
    key-alias: gateway                  # å¯†é’¥åˆ«å
```

**é…ç½®æ­¥éª¤3ï¼šç”Ÿæˆå¯†é’¥åº“(å¼€å‘ç¯å¢ƒ)**

```bash
# ä½¿ç”¨keytoolå·¥å…·ç”Ÿæˆè‡ªç­¾åè¯ä¹¦(ä»…ç”¨äºå¼€å‘æµ‹è¯•)
keytool -genkeypair \
  -alias gateway \
  -keyalg RSA \
  -keysize 2048 \
  -keystore keystore.p12 \
  -storetype PKCS12 \
  -validity 365 \
  -dname "CN=localhost, OU=Dev, O=MyCompany, L=Beijing, ST=Beijing, C=CN"
```

> âš ï¸ **æ³¨æ„**ï¼šç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨æ­£è§„CAæœºæ„ç­¾å‘çš„è¯ä¹¦,ä¸èƒ½ç”¨è‡ªç­¾åï¼

### 2.3 Nginxåå‘ä»£ç†è¯ä¹¦é…ç½®


**å…¸å‹æ¶æ„**ï¼š

```
ç”¨æˆ·æµè§ˆå™¨ --HTTPS--> Nginxç½‘å…³ --HTTP--> Spring Cloud Gateway
                      â†‘
                   åœ¨è¿™é‡Œé…ç½®è¯ä¹¦
```

**Nginxé…ç½®ç¤ºä¾‹**ï¼š

```nginx
server {
    listen 443 ssl http2;
    server_name api.example.com;
    
    # SSLè¯ä¹¦é…ç½®
    ssl_certificate /etc/nginx/ssl/api.example.com.crt;
    ssl_certificate_key /etc/nginx/ssl/api.example.com.key;
    
    # åå‘ä»£ç†åˆ°åç«¯ç½‘å…³
    location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto https;
    }
}
```

**é…ç½®è¯´æ˜**ï¼š
- `ssl_certificate`ï¼šè¯ä¹¦æ–‡ä»¶è·¯å¾„
- `ssl_certificate_key`ï¼šç§é’¥æ–‡ä»¶è·¯å¾„(ä¸¥æ ¼ä¿å¯†)
- `X-Forwarded-Proto`ï¼šå‘Šè¯‰åç«¯ä½¿ç”¨çš„æ˜¯HTTPSåè®®

---

## 3. ğŸ”§ TLSç‰ˆæœ¬å®‰å…¨æ§åˆ¶


### 3.1 TLSç‰ˆæœ¬æ¼”è¿›


**ç‰ˆæœ¬å†å²**ï¼š

```
SSL 2.0 (1995) âŒ å·²åºŸå¼ƒ,ä¸¥é‡æ¼æ´
SSL 3.0 (1996) âŒ å·²åºŸå¼ƒ,POODLEæ”»å‡»
TLS 1.0 (1999) âš ï¸ ä¸å®‰å…¨,åº”ç¦ç”¨
TLS 1.1 (2006) âš ï¸ ä¸å®‰å…¨,åº”ç¦ç”¨
TLS 1.2 (2008) âœ… å®‰å…¨,æ¨èä½¿ç”¨
TLS 1.3 (2018) âœ… æœ€å®‰å…¨,ä¼˜å…ˆä½¿ç”¨
```

> ğŸ’¡ **å®‰å…¨å»ºè®®**ï¼šåªå¯ç”¨TLS 1.2å’ŒTLS 1.3ï¼Œç¦ç”¨æ‰€æœ‰æ—§ç‰ˆæœ¬

### 3.2 Spring Boot TLSç‰ˆæœ¬é…ç½®


```yaml
server:
  ssl:
    enabled-protocols: TLS1.2,TLS1.3    # åªå…è®¸å®‰å…¨ç‰ˆæœ¬
    protocol: TLS                        # ä½¿ç”¨TLSåè®®
```

### 3.3 Nginx TLSç‰ˆæœ¬æ§åˆ¶


```nginx
server {
    listen 443 ssl http2;
    
    # TLSç‰ˆæœ¬æ§åˆ¶(åªå…è®¸1.2å’Œ1.3)
    ssl_protocols TLSv1.2 TLSv1.3;
    
    # ä¼˜å…ˆä½¿ç”¨æœåŠ¡å™¨çš„åŠ å¯†å¥—ä»¶é¡ºåº
    ssl_prefer_server_ciphers on;
    
    # æ¨èçš„åŠ å¯†å¥—ä»¶(é«˜å®‰å…¨æ€§)
    ssl_ciphers 'ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384';
}
```

**é…ç½®è§£è¯»**ï¼š
- `ssl_protocols`ï¼šåªå…è®¸TLS 1.2å’Œ1.3
- `ssl_ciphers`ï¼šæŒ‡å®šå¼ºåŠ å¯†ç®—æ³•,æ’é™¤å¼±åŠ å¯†

---

## 4. ğŸ”„ HTTPåˆ°HTTPSè‡ªåŠ¨è·³è½¬


### 4.1 ä¸ºä»€ä¹ˆéœ€è¦è‡ªåŠ¨è·³è½¬


**ç”¨æˆ·è®¿é—®åœºæ™¯**ï¼š

```
ç”¨æˆ·è¾“å…¥ï¼šhttp://api.example.com
          â†“
ä¸è‡ªåŠ¨è·³è½¬ï¼šâŒ ä½¿ç”¨ä¸å®‰å…¨çš„HTTPè¿æ¥
          â†“
è‡ªåŠ¨è·³è½¬ï¼šâœ… é‡å®šå‘åˆ° https://api.example.com
```

> ğŸ¯ **ç›®çš„**ï¼šç¡®ä¿æ‰€æœ‰è¯·æ±‚éƒ½èµ°HTTPSï¼Œé¿å…å®‰å…¨æ¼æ´

### 4.2 Spring Bootå®ç°HTTPè·³è½¬


**æ–¹æ³•1ï¼šé…ç½®ç«¯å£é‡å®šå‘**

```yaml
server:
  port: 8443              # HTTPSç«¯å£
  http:
    port: 8080            # HTTPç«¯å£(ç”¨äºè·³è½¬)
    
# éœ€è¦æ·»åŠ é…ç½®ç±»
```

**æ–¹æ³•2ï¼šJavaé…ç½®ç±»å®ç°**

```java
@Configuration
public class HttpsRedirectConfig {
    
    @Bean
    public TomcatServletWebServerFactory servletContainer() {
        TomcatServletWebServerFactory tomcat = new TomcatServletWebServerFactory() {
            @Override
            protected void postProcessContext(Context context) {
                // é…ç½®å®‰å…¨çº¦æŸ
                SecurityConstraint constraint = new SecurityConstraint();
                constraint.setUserConstraint("CONFIDENTIAL");
                
                SecurityCollection collection = new SecurityCollection();
                collection.addPattern("/*");  // æ‰€æœ‰è·¯å¾„éƒ½è·³è½¬
                constraint.addCollection(collection);
                
                context.addConstraint(constraint);
            }
        };
        
        // æ·»åŠ HTTPè¿æ¥å™¨(ç”¨äºè·³è½¬)
        tomcat.addAdditionalTomcatConnectors(httpConnector());
        return tomcat;
    }
    
    private Connector httpConnector() {
        Connector connector = new Connector("org.apache.coyote.http11.Http11NioProtocol");
        connector.setPort(8080);              // HTTPç«¯å£
        connector.setRedirectPort(8443);      // è·³è½¬åˆ°HTTPSç«¯å£
        return connector;
    }
}
```

### 4.3 Nginxå®ç°HTTPè·³è½¬


**æ–¹æ³•1ï¼šç®€å•é‡å®šå‘**

```nginx
# HTTPæœåŠ¡å™¨é…ç½®
server {
    listen 80;
    server_name api.example.com;
    
    # æ‰€æœ‰HTTPè¯·æ±‚301æ°¸ä¹…é‡å®šå‘åˆ°HTTPS
    return 301 https://$server_name$request_uri;
}

# HTTPSæœåŠ¡å™¨é…ç½®
server {
    listen 443 ssl http2;
    server_name api.example.com;
    # ... SSLé…ç½® ...
}
```

**æ–¹æ³•2ï¼šä¿ç•™è¯·æ±‚å‚æ•°çš„è·³è½¬**

```nginx
server {
    listen 80;
    server_name api.example.com;
    
    location / {
        # é‡å®šå‘å¹¶ä¿ç•™å®Œæ•´URI
        return 301 https://$host$request_uri;
    }
}
```

**è·³è½¬æ•ˆæœå¯¹æ¯”**ï¼š

| ç”¨æˆ·è¯·æ±‚ | è·³è½¬ç»“æœ |
|---------|---------|
| `http://api.example.com/user/login` | `https://api.example.com/user/login` |
| `http://api.example.com/order?id=123` | `https://api.example.com/order?id=123` |

---

## 5. ğŸ›¡ï¸ å®‰å…¨å“åº”å¤´é…ç½®


### 5.1 ä»€ä¹ˆæ˜¯å®‰å…¨å“åº”å¤´


**ç®€å•ç†è§£**ï¼šå®‰å…¨å“åº”å¤´æ˜¯æœåŠ¡å™¨å‘Šè¯‰æµè§ˆå™¨çš„"å®‰å…¨æŒ‡ä»¤"

```
æœåŠ¡å™¨å“åº”ï¼š
HTTP/1.1 200 OK
Content-Type: application/json
X-Frame-Options: DENY              â† å®‰å…¨å¤´1ï¼šç¦æ­¢è¢«iframeåµŒå…¥
X-Content-Type-Options: nosniff    â† å®‰å…¨å¤´2ï¼šç¦æ­¢MIMEç±»å‹å—…æ¢
X-XSS-Protection: 1; mode=block    â† å®‰å…¨å¤´3ï¼šå¼€å¯XSSé˜²æŠ¤

{ "data": "..." }
```

### 5.2 å…³é”®å®‰å…¨å“åº”å¤´è¯¦è§£


**ğŸ”¸ X-Frame-Options(é˜²æ­¢ç‚¹å‡»åŠ«æŒ)**

```
ä½œç”¨ï¼šæ§åˆ¶é¡µé¢èƒ½å¦è¢«å…¶ä»–ç½‘ç«™åµŒå…¥iframe

å¯é€‰å€¼ï¼š
- DENY            â† å®Œå…¨ç¦æ­¢è¢«åµŒå…¥
- SAMEORIGIN      â† åªå…è®¸åŒåŸŸååµŒå…¥
- ALLOW-FROM uri  â† å…è®¸æŒ‡å®šç½‘ç«™åµŒå…¥
```

**ğŸ”¸ X-Content-Type-Options(é˜²æ­¢MIMEå—…æ¢)**

```
ä½œç”¨ï¼šç¦æ­¢æµè§ˆå™¨çŒœæµ‹æ–‡ä»¶ç±»å‹

è®¾ç½®å€¼ï¼šnosniff   â† ä¸¥æ ¼æŒ‰Content-Typeå¤„ç†
```

**ğŸ”¸ X-XSS-Protection(XSSé˜²æŠ¤)**

```
ä½œç”¨ï¼šå¯ç”¨æµè§ˆå™¨å†…ç½®çš„XSSè¿‡æ»¤å™¨

è®¾ç½®å€¼ï¼š
- 0                    â† ç¦ç”¨ä¿æŠ¤
- 1                    â† å¯ç”¨ä¿æŠ¤
- 1; mode=block        â† å¯ç”¨å¹¶é˜»æ­¢æ¸²æŸ“
```

**ğŸ”¸ Content-Security-Policy(å†…å®¹å®‰å…¨ç­–ç•¥)**

```
ä½œç”¨ï¼šç²¾ç»†æ§åˆ¶é¡µé¢å¯ä»¥åŠ è½½å“ªäº›èµ„æº

ç¤ºä¾‹ï¼š
Content-Security-Policy: 
  default-src 'self';           â† é»˜è®¤åªåŠ è½½åŒåŸŸèµ„æº
  script-src 'self' cdn.com;    â† è„šæœ¬åªèƒ½æ¥è‡ªæœ¬ç«™å’ŒCDN
  img-src *;                    â† å›¾ç‰‡å¯ä»¥æ¥è‡ªä»»ä½•åœ°æ–¹
```

### 5.3 Spring Cloud Gatewayé…ç½®å®‰å…¨å¤´


```java
@Configuration
public class SecurityHeadersFilter implements GlobalFilter, Ordered {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        return chain.filter(exchange).then(Mono.fromRunnable(() -> {
            ServerHttpResponse response = exchange.getResponse();
            HttpHeaders headers = response.getHeaders();
            
            // æ·»åŠ å®‰å…¨å“åº”å¤´
            headers.add("X-Frame-Options", "DENY");
            headers.add("X-Content-Type-Options", "nosniff");
            headers.add("X-XSS-Protection", "1; mode=block");
            headers.add("Content-Security-Policy", "default-src 'self'");
        }));
    }
    
    @Override
    public int getOrder() {
        return -1;  // ä¼˜å…ˆçº§æœ€é«˜
    }
}
```

### 5.4 Nginxé…ç½®å®‰å…¨å¤´


```nginx
server {
    listen 443 ssl http2;
    
    # å®‰å…¨å“åº”å¤´é…ç½®
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'" always;
    
    # å¼•ç”¨ç«™ç‚¹ç­–ç•¥(é˜²æ­¢ä¿¡æ¯æ³„éœ²)
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    location / {
        # ... å…¶ä»–é…ç½® ...
    }
}
```

---

## 6. ğŸš€ HSTSå®‰å…¨ç­–ç•¥


### 6.1 ä»€ä¹ˆæ˜¯HSTS


**HSTSå…¨ç§°**ï¼šHTTP Strict Transport Security(HTTPä¸¥æ ¼ä¼ è¾“å®‰å…¨)

**é€šä¿—è§£é‡Š**ï¼šæµè§ˆå™¨è®°ä½"è¿™ä¸ªç½‘ç«™åªèƒ½ç”¨HTTPSè®¿é—®"

```
é¦–æ¬¡è®¿é—®æµç¨‹ï¼š
ç”¨æˆ· â†’ http://api.example.com
     â†“ æœåŠ¡å™¨301è·³è½¬
     â†’ https://api.example.com
     â†“ æœåŠ¡å™¨è¿”å›HSTSå“åº”å¤´
     â† Strict-Transport-Security: max-age=31536000

åç»­è®¿é—®æµç¨‹ï¼š
ç”¨æˆ· â†’ http://api.example.com
     â†“ æµè§ˆå™¨ç›´æ¥æ”¹å†™ä¸ºHTTPS(æ— éœ€æœåŠ¡å™¨è·³è½¬!)
     â†’ https://api.example.com âœ“
```

> ğŸ’¡ **ä¼˜åŠ¿**ï¼šçœå»äº†HTTPåˆ°HTTPSçš„è·³è½¬æ—¶é—´,æ›´å®‰å…¨æ›´å¿«ï¼

### 6.2 HSTSå“åº”å¤´é…ç½®


**åŸºç¡€é…ç½®**ï¼š

```
Strict-Transport-Security: max-age=31536000

å‚æ•°è¯´æ˜ï¼š
max-age=31536000  â† 1å¹´å†…å¼ºåˆ¶HTTPS(ç§’æ•°)
```

**å®Œæ•´é…ç½®**ï¼š

```
Strict-Transport-Security: max-age=31536000; includeSubDomains; preload

å‚æ•°è¯´æ˜ï¼š
max-age=31536000      â† æœ‰æ•ˆæœŸ1å¹´
includeSubDomains     â† å­åŸŸåä¹Ÿå¼ºåˆ¶HTTPS
preload               â† åŠ å…¥æµè§ˆå™¨é¢„åŠ è½½åˆ—è¡¨
```

### 6.3 Spring Booté…ç½®HSTS


```yaml
server:
  ssl:
    enabled: true
  # HSTSé…ç½®
  http2:
    enabled: true
    
# é€šè¿‡è¿‡æ»¤å™¨æ·»åŠ HSTSå¤´
```

```java
@Configuration
public class HstsConfig implements GlobalFilter {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        return chain.filter(exchange).then(Mono.fromRunnable(() -> {
            ServerHttpRequest request = exchange.getRequest();
            
            // åªåœ¨HTTPSè¯·æ±‚æ—¶æ·»åŠ HSTSå¤´
            if (request.getURI().getScheme().equals("https")) {
                exchange.getResponse().getHeaders()
                    .add("Strict-Transport-Security", 
                         "max-age=31536000; includeSubDomains; preload");
            }
        }));
    }
}
```

### 6.4 Nginxé…ç½®HSTS


```nginx
server {
    listen 443 ssl http2;
    server_name api.example.com;
    
    # HSTSé…ç½®(1å¹´æœ‰æ•ˆæœŸ,åŒ…å«å­åŸŸå)
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    
    # ... å…¶ä»–SSLé…ç½® ...
}
```

### 6.5 HSTSæ³¨æ„äº‹é¡¹


> âš ï¸ **é‡è¦è­¦å‘Š**ï¼š

```
HSTSé£é™©æç¤ºï¼š
1. æµ‹è¯•é˜¶æ®µç”¨çŸ­æ—¶é—´ï¼šmax-age=300(5åˆ†é’Ÿ)
2. ç¡®è®¤æ— è¯¯åå†å»¶é•¿ï¼šmax-age=31536000(1å¹´)
3. é…ç½®é”™è¯¯ä¼šå¯¼è‡´ï¼šç½‘ç«™å®Œå…¨æ— æ³•è®¿é—®!
4. å–æ¶ˆHSTSå¾ˆå›°éš¾ï¼šéœ€è¦ç­‰å¾…max-ageè¿‡æœŸ

å»ºè®®æ­¥éª¤ï¼š
ç¬¬1å‘¨ï¼šmax-age=604800(1å‘¨)
ç¬¬2å‘¨ï¼šmax-age=2592000(1ä¸ªæœˆ)
ç¨³å®šåï¼šmax-age=31536000(1å¹´)
```

---

## 7. ğŸ”„ è¯ä¹¦è‡ªåŠ¨ç»­æœŸæ–¹æ¡ˆ


### 7.1 ä¸ºä»€ä¹ˆéœ€è¦è‡ªåŠ¨ç»­æœŸ


**è¯ä¹¦è¿‡æœŸçš„åæœ**ï¼š

```
è¯ä¹¦è¿‡æœŸåœºæ™¯ï¼š
2025-01-01: è¯ä¹¦æ­£å¸¸ âœ“
2025-12-31: è¯ä¹¦å³å°†è¿‡æœŸ âš ï¸
2026-01-01: è¯ä¹¦è¿‡æœŸ âŒ
            â†“
ç”¨æˆ·è®¿é—®ï¼šæµè§ˆå™¨æ˜¾ç¤º"ä¸å®‰å…¨"è­¦å‘Š
APIè°ƒç”¨ï¼šè¯·æ±‚å¤±è´¥,æœåŠ¡ä¸­æ–­
å½±å“ï¼šä¸šåŠ¡åœæ‘†,ç”¨æˆ·æµå¤±
```

> ğŸ’¡ **è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨Let's Encryptå…è´¹è¯ä¹¦ + è‡ªåŠ¨ç»­æœŸå·¥å…·

### 7.2 Let's Encryptè¯ä¹¦ç”³è¯·


**ä»€ä¹ˆæ˜¯Let's Encrypt?**

```
Let's Encryptç‰¹ç‚¹ï¼š
âœ… å®Œå…¨å…è´¹
âœ… è‡ªåŠ¨åŒ–ç”³è¯·
âœ… 90å¤©æœ‰æ•ˆæœŸ(é¼“åŠ±è‡ªåŠ¨ç»­æœŸ)
âœ… è¢«æ‰€æœ‰ä¸»æµæµè§ˆå™¨ä¿¡ä»»
```

**ä½¿ç”¨Certbotç”³è¯·è¯ä¹¦**ï¼š

```bash
# 1. å®‰è£…Certbotå·¥å…·
sudo apt install certbot python3-certbot-nginx

# 2. ç”³è¯·è¯ä¹¦(è‡ªåŠ¨é…ç½®Nginx)
sudo certbot --nginx -d api.example.com

# 3. Certbotä¼šè‡ªåŠ¨ï¼š
#    - éªŒè¯åŸŸåæ‰€æœ‰æƒ
#    - ç”³è¯·è¯ä¹¦
#    - é…ç½®Nginx
#    - è®¾ç½®è‡ªåŠ¨ç»­æœŸ
```

### 7.3 é…ç½®è‡ªåŠ¨ç»­æœŸ


**æ–¹æ³•1ï¼šCertbotå†…ç½®å®šæ—¶ä»»åŠ¡**

```bash
# æŸ¥çœ‹è‡ªåŠ¨ç»­æœŸé…ç½®
sudo systemctl status certbot.timer

# æ‰‹åŠ¨æµ‹è¯•ç»­æœŸ(ä¸ä¼šçœŸçš„æ›´æ–°)
sudo certbot renew --dry-run

# Certbotä¼šè‡ªåŠ¨åˆ›å»ºå®šæ—¶ä»»åŠ¡ï¼š
# æ¯å¤©æ£€æŸ¥2æ¬¡,è¯ä¹¦åˆ°æœŸå‰30å¤©è‡ªåŠ¨ç»­æœŸ
```

**æ–¹æ³•2ï¼šæ‰‹åŠ¨é…ç½®Cronå®šæ—¶ä»»åŠ¡**

```bash
# ç¼–è¾‘crontab
crontab -e

# æ·»åŠ å®šæ—¶ä»»åŠ¡(æ¯å¤©å‡Œæ™¨2ç‚¹æ£€æŸ¥)
0 2 * * * certbot renew --quiet --post-hook "systemctl reload nginx"
```

**å®šæ—¶ä»»åŠ¡è¯´æ˜**ï¼š
- `0 2 * * *`ï¼šæ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
- `--quiet`ï¼šé™é»˜æ¨¡å¼,æ— è¾“å‡º
- `--post-hook`ï¼šç»­æœŸæˆåŠŸåé‡å¯Nginx

### 7.4 ç»­æœŸæµç¨‹ç›‘æ§


**ç›‘æ§è„šæœ¬ç¤ºä¾‹**ï¼š

```bash
#!/bin/bash
# check-ssl-expiry.sh

DOMAIN="api.example.com"
DAYS_THRESHOLD=30

# è·å–è¯ä¹¦è¿‡æœŸæ—¶é—´
EXPIRY_DATE=$(echo | openssl s_client -servername $DOMAIN \
  -connect $DOMAIN:443 2>/dev/null | \
  openssl x509 -noout -enddate | cut -d= -f2)

# è®¡ç®—å‰©ä½™å¤©æ•°
EXPIRY_EPOCH=$(date -d "$EXPIRY_DATE" +%s)
NOW_EPOCH=$(date +%s)
DAYS_LEFT=$(( ($EXPIRY_EPOCH - $NOW_EPOCH) / 86400 ))

# æ£€æŸ¥æ˜¯å¦éœ€è¦å‘Šè­¦
if [ $DAYS_LEFT -lt $DAYS_THRESHOLD ]; then
    echo "âš ï¸ è¯ä¹¦å°†åœ¨ ${DAYS_LEFT} å¤©åè¿‡æœŸ!"
    # å‘é€å‘Šè­¦é‚®ä»¶æˆ–é’‰é’‰é€šçŸ¥
fi
```

### 7.5 Spring Bootè¯ä¹¦çƒ­åŠ è½½


**é—®é¢˜**ï¼šè¯ä¹¦æ›´æ–°åéœ€è¦é‡å¯æœåŠ¡?

**è§£å†³**ï¼šå®ç°è¯ä¹¦çƒ­åŠ è½½

```java
@Configuration
public class SslReloadConfig {
    
    private static final String KEYSTORE_PATH = "/path/to/keystore.p12";
    
    @Scheduled(cron = "0 0 3 * * ?")  // æ¯å¤©å‡Œæ™¨3ç‚¹æ£€æŸ¥
    public void reloadSslCertificate() {
        try {
            // æ£€æµ‹è¯ä¹¦æ–‡ä»¶å˜åŒ–
            if (certificateChanged()) {
                // é‡æ–°åŠ è½½SSLä¸Šä¸‹æ–‡
                reloadSslContext();
                log.info("âœ… SSLè¯ä¹¦çƒ­åŠ è½½æˆåŠŸ");
            }
        } catch (Exception e) {
            log.error("âŒ SSLè¯ä¹¦åŠ è½½å¤±è´¥", e);
        }
    }
    
    private boolean certificateChanged() {
        // æ£€æŸ¥æ–‡ä»¶ä¿®æ”¹æ—¶é—´
        File keystoreFile = new File(KEYSTORE_PATH);
        long lastModified = keystoreFile.lastModified();
        // ä¸ä¸Šæ¬¡æ£€æŸ¥æ—¶é—´å¯¹æ¯”...
        return true;
    }
    
    private void reloadSslContext() {
        // é‡æ–°åŠ è½½å¯†é’¥åº“é€»è¾‘
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 HTTPSé…ç½®æ ¸å¿ƒæ¸…å•


```
âœ… å¿…åšé…ç½®ï¼š
ğŸ”¸ ä½¿ç”¨æ­£è§„CAè¯ä¹¦(ç”Ÿäº§ç¯å¢ƒ)
ğŸ”¸ åªå¯ç”¨TLS 1.2å’ŒTLS 1.3
ğŸ”¸ é…ç½®HTTPè‡ªåŠ¨è·³è½¬HTTPS
ğŸ”¸ æ·»åŠ å…³é”®å®‰å…¨å“åº”å¤´
ğŸ”¸ å¯ç”¨HSTSç­–ç•¥
ğŸ”¸ é…ç½®è¯ä¹¦è‡ªåŠ¨ç»­æœŸ

âŒ ç¦æ­¢é…ç½®ï¼š
ğŸ”¸ ä½¿ç”¨è‡ªç­¾åè¯ä¹¦(ç”Ÿäº§ç¯å¢ƒ)
ğŸ”¸ å¯ç”¨SSL 3.0ã€TLS 1.0/1.1
ğŸ”¸ å…è®¸å¼±åŠ å¯†ç®—æ³•
ğŸ”¸ å¿½ç•¥è¯ä¹¦è¿‡æœŸæ—¶é—´
```

### 8.2 å®‰å…¨å“åº”å¤´é€ŸæŸ¥è¡¨


| å“åº”å¤´ | **ä½œç”¨** | **æ¨èé…ç½®** |
|-------|---------|------------|
| `X-Frame-Options` | `é˜²ç‚¹å‡»åŠ«æŒ` | `DENY` |
| `X-Content-Type-Options` | `é˜²MIMEå—…æ¢` | `nosniff` |
| `X-XSS-Protection` | `XSSé˜²æŠ¤` | `1; mode=block` |
| `Strict-Transport-Security` | `å¼ºåˆ¶HTTPS` | `max-age=31536000; includeSubDomains` |
| `Content-Security-Policy` | `å†…å®¹å®‰å…¨` | `default-src 'self'` |

### 8.3 è¯ä¹¦ç®¡ç†æœ€ä½³å®è·µ


> ğŸ¯ **å…³é”®åŸåˆ™**ï¼š

```
è¯ä¹¦ç”³è¯·ï¼š
â€¢ ç”Ÿäº§ç¯å¢ƒï¼šè´­ä¹°OV/EVè¯ä¹¦
â€¢ æµ‹è¯•ç¯å¢ƒï¼šä½¿ç”¨Let's Encryptå…è´¹è¯ä¹¦
â€¢ å¼€å‘ç¯å¢ƒï¼šå¯ä»¥ç”¨è‡ªç­¾åè¯ä¹¦

è¯ä¹¦éƒ¨ç½²ï¼š
â€¢ ç§é’¥ä¸¥æ ¼ä¿å¯†,æƒé™è®¾ä¸º400
â€¢ è¯ä¹¦æ–‡ä»¶å®šæœŸå¤‡ä»½
â€¢ é…ç½®æ–‡ä»¶ä¸è¦ç¡¬ç¼–ç å¯†ç 

è¯ä¹¦ç»­æœŸï¼š
â€¢ æå‰30å¤©å¼€å§‹ç»­æœŸ
â€¢ é…ç½®è‡ªåŠ¨ç»­æœŸå®šæ—¶ä»»åŠ¡
â€¢ ç›‘æ§è¯ä¹¦è¿‡æœŸæ—¶é—´
â€¢ æµ‹è¯•ç»­æœŸæµç¨‹æ˜¯å¦æ­£å¸¸
```

### 8.4 å¸¸è§é—®é¢˜å¤„ç†


**ğŸ”¸ é—®é¢˜1ï¼šæµè§ˆå™¨æ˜¾ç¤º"ä¸å®‰å…¨"**

```
æ’æŸ¥æ­¥éª¤ï¼š
1. æ£€æŸ¥è¯ä¹¦æ˜¯å¦è¿‡æœŸ
2. æ£€æŸ¥åŸŸåæ˜¯å¦åŒ¹é…
3. æ£€æŸ¥è¯ä¹¦é“¾æ˜¯å¦å®Œæ•´
4. æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†è‡ªç­¾åè¯ä¹¦
```

**ğŸ”¸ é—®é¢˜2ï¼šHTTPè·³è½¬ä¸ç”Ÿæ•ˆ**

```
æ’æŸ¥æ­¥éª¤ï¼š
1. ç¡®è®¤80ç«¯å£ç›‘å¬æ­£å¸¸
2. æ£€æŸ¥é‡å®šå‘é…ç½®æ˜¯å¦æ­£ç¡®
3. æŸ¥çœ‹é˜²ç«å¢™è§„åˆ™
4. æµ‹è¯•ï¼šcurl -I http://api.example.com
```

**ğŸ”¸ é—®é¢˜3ï¼šè¯ä¹¦è‡ªåŠ¨ç»­æœŸå¤±è´¥**

```
æ’æŸ¥æ­¥éª¤ï¼š
1. æ£€æŸ¥Certbotå®šæ—¶ä»»åŠ¡çŠ¶æ€
2. æŸ¥çœ‹Certbotæ—¥å¿—ï¼š/var/log/letsencrypt/
3. æ‰‹åŠ¨æµ‹è¯•ç»­æœŸï¼šcertbot renew --dry-run
4. æ£€æŸ¥80ç«¯å£æ˜¯å¦è¢«å ç”¨(éªŒè¯éœ€è¦)
```

### 8.5 å®æˆ˜æ£€æŸ¥å‘½ä»¤


```bash
# 1. æ£€æŸ¥è¯ä¹¦ä¿¡æ¯
openssl s_client -connect api.example.com:443 -servername api.example.com

# 2. æŸ¥çœ‹è¯ä¹¦è¿‡æœŸæ—¶é—´
echo | openssl s_client -connect api.example.com:443 2>/dev/null | \
  openssl x509 -noout -dates

# 3. æµ‹è¯•TLSç‰ˆæœ¬æ”¯æŒ
nmap --script ssl-enum-ciphers -p 443 api.example.com

# 4. æ£€æŸ¥å®‰å…¨å“åº”å¤´
curl -I https://api.example.com

# 5. éªŒè¯HSTSæ˜¯å¦ç”Ÿæ•ˆ
curl -I https://api.example.com | grep -i strict
```

---

**ğŸ“ å­¦ä¹ å»ºè®®**ï¼š

```
æ–°æ‰‹å­¦ä¹ è·¯å¾„ï¼š
ç¬¬1æ­¥ï¼šç†è§£HTTPSåŸºæœ¬åŸç†(1-2å°æ—¶)
ç¬¬2æ­¥ï¼šæœ¬åœ°æ­å»ºæµ‹è¯•ç¯å¢ƒ,ç”³è¯·è‡ªç­¾åè¯ä¹¦(2å°æ—¶)
ç¬¬3æ­¥ï¼šé…ç½®Nginx/Spring Bootçš„HTTPS(3å°æ—¶)
ç¬¬4æ­¥ï¼šä½¿ç”¨Let's Encryptç”³è¯·å…è´¹è¯ä¹¦(1å°æ—¶)
ç¬¬5æ­¥ï¼šé…ç½®å®‰å…¨å“åº”å¤´å’ŒHSTS(2å°æ—¶)
ç¬¬6æ­¥ï¼šå®ç°è¯ä¹¦è‡ªåŠ¨ç»­æœŸ(2å°æ—¶)

å®è·µé¡¹ç›®ï¼š
â€¢ æ­å»ºä¸€ä¸ªå®Œæ•´çš„HTTPS APIç½‘å…³
â€¢ é…ç½®æ‰€æœ‰å®‰å…¨å“åº”å¤´
â€¢ å®ç°è¯ä¹¦è‡ªåŠ¨ç»­æœŸ
â€¢ ç¼–å†™ç›‘æ§è„šæœ¬
```

> ğŸ’¡ **æ ¸å¿ƒè®°å¿†**ï¼šHTTPS = è¯ä¹¦ + åŠ å¯† + å®‰å…¨å¤´ï¼Œä¸‰è€…ç¼ºä¸€ä¸å¯ï¼