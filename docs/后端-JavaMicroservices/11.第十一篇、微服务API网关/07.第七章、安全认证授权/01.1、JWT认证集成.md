---
title: 1ã€JWTè®¤è¯é›†æˆ
---
## ğŸ“š ç›®å½•

1. [JWTè®¤è¯åŸºç¡€æ¦‚å¿µ](#1-JWTè®¤è¯åŸºç¡€æ¦‚å¿µ)
2. [JWT Tokenç»“æ„è¯¦è§£](#2-JWT-Tokenç»“æ„è¯¦è§£)
3. [Tokenç­¾åéªŒè¯æœºåˆ¶](#3-Tokenç­¾åéªŒè¯æœºåˆ¶)
4. [å…¬é’¥ç§é’¥é…ç½®å®æˆ˜](#4-å…¬é’¥ç§é’¥é…ç½®å®æˆ˜)
5. [Tokenè§£æä¸ä¿¡æ¯æå–](#5-Tokenè§£æä¸ä¿¡æ¯æå–)
6. [ç”¨æˆ·ä¿¡æ¯ä¼ é€’æ–¹æ¡ˆ](#6-ç”¨æˆ·ä¿¡æ¯ä¼ é€’æ–¹æ¡ˆ)
7. [Tokenè¿‡æœŸå¤„ç†ç­–ç•¥](#7-Tokenè¿‡æœŸå¤„ç†ç­–ç•¥)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” JWTè®¤è¯åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯JWTè®¤è¯


**ç®€å•ç†è§£**ï¼šJWTå°±åƒä½ çš„"ç”µå­èº«ä»½è¯"ï¼Œè¯æ˜ä½ æ˜¯è°ï¼Œæœ‰ä»€ä¹ˆæƒé™

```
ä¼ ç»ŸSessionè®¤è¯ï¼š
ç”¨æˆ·ç™»å½• â†’ æœåŠ¡å™¨ç”ŸæˆSession â†’ å­˜å‚¨åœ¨æœåŠ¡å™¨å†…å­˜
é—®é¢˜ï¼šåˆ†å¸ƒå¼ç¯å¢ƒä¸‹Sessionéš¾ä»¥å…±äº«

JWTè®¤è¯æ–¹å¼ï¼š
ç”¨æˆ·ç™»å½• â†’ æœåŠ¡å™¨ç”ŸæˆToken â†’ å®¢æˆ·ç«¯è‡ªå·±ä¿å­˜
ä¼˜åŠ¿ï¼šæ— éœ€æœåŠ¡å™¨å­˜å‚¨ï¼Œå¤©ç„¶æ”¯æŒåˆ†å¸ƒå¼
```

**JWTå…¨ç§°**ï¼šJSON Web Tokenï¼ˆJSON ç½‘ç»œä»¤ç‰Œï¼‰
- **JSON**ï¼šæ•°æ®æ ¼å¼æ˜¯JSON
- **Web**ï¼šç”¨äºç½‘ç»œä¼ è¾“
- **Token**ï¼šä»¤ç‰Œï¼Œå°±æ˜¯ä¸€ä¸²åŠ å¯†å­—ç¬¦ä¸²

### 1.2 ä¸ºä»€ä¹ˆå¾®æœåŠ¡éœ€è¦JWT


**å¾®æœåŠ¡åœºæ™¯çš„è®¤è¯éš¾é¢˜**ï¼š

```
å•ä½“åº”ç”¨æ—¶ä»£ï¼š
   ç”¨æˆ· â†’ ç½‘å…³ â†’ åº”ç”¨æœåŠ¡å™¨
        (Sessionå­˜å‚¨åœ¨è¿™é‡Œ)
å¾ˆç®€å•ï¼ŒSessionå…±äº«ä¸æ˜¯é—®é¢˜

å¾®æœåŠ¡æ—¶ä»£ï¼š
   ç”¨æˆ· â†’ ç½‘å…³ â†’ è®¢å•æœåŠ¡
              â†’ ç”¨æˆ·æœåŠ¡  
              â†’ å•†å“æœåŠ¡
              â†’ æ”¯ä»˜æœåŠ¡
              
é—®é¢˜æ¥äº†ï¼š
âŒ Sessionå­˜åœ¨å“ªä¸ªæœåŠ¡ï¼Ÿ
âŒ æ¯ä¸ªæœåŠ¡éƒ½è¦è®¿é—®Sessionå­˜å‚¨å—ï¼Ÿ
âŒ Sessionå…±äº«å¤ªå¤æ‚ï¼
```

**JWTè§£å†³æ–¹æ¡ˆ**ï¼š

```
âœ… Tokenè‡ªåŒ…å«ï¼šç”¨æˆ·ä¿¡æ¯éƒ½åœ¨Tokené‡Œ
âœ… æ— çŠ¶æ€éªŒè¯ï¼šæœåŠ¡ä¸éœ€è¦å­˜å‚¨Session
âœ… è·¨æœåŠ¡ä¼ é€’ï¼šTokenéšè¯·æ±‚ä¸€èµ·ä¼ é€’
âœ… ç»Ÿä¸€è®¤è¯ï¼šç½‘å…³ç»Ÿä¸€éªŒè¯ï¼Œå¾®æœåŠ¡ç›´æ¥ä½¿ç”¨
```

### 1.3 JWTè®¤è¯æµç¨‹


**å®Œæ•´è®¤è¯æµç¨‹å›¾**ï¼š

```
1. ç”¨æˆ·ç™»å½•
   ç”¨æˆ· â†’ [è´¦å·å¯†ç ] â†’ è®¤è¯æœåŠ¡
   
2. ç”ŸæˆToken
   è®¤è¯æœåŠ¡ â†’ [éªŒè¯æˆåŠŸ] â†’ ç”ŸæˆJWT Token
   
3. è¿”å›Token
   è®¤è¯æœåŠ¡ â†’ [è¿”å›Token] â†’ ç”¨æˆ·
   
4. æºå¸¦Tokenè®¿é—®
   ç”¨æˆ· â†’ [è¯·æ±‚+Token] â†’ ç½‘å…³
   
5. ç½‘å…³éªŒè¯
   ç½‘å…³ â†’ [éªŒè¯Token] â†’ æå–ç”¨æˆ·ä¿¡æ¯
   
6. ä¼ é€’ç»™å¾®æœåŠ¡
   ç½‘å…³ â†’ [è¯·æ±‚+ç”¨æˆ·ä¿¡æ¯] â†’ è®¢å•æœåŠ¡/ç”¨æˆ·æœåŠ¡/å•†å“æœåŠ¡
   
7. å¾®æœåŠ¡å¤„ç†
   å¾®æœåŠ¡ â†’ [ç›´æ¥ä½¿ç”¨ç”¨æˆ·ä¿¡æ¯] â†’ ä¸šåŠ¡å¤„ç†
```

---

## 2. ğŸ“¦ JWT Tokenç»“æ„è¯¦è§£


### 2.1 Tokençš„ä¸‰æ®µå¼ç»“æ„


**JWT Tokenç»„æˆ**ï¼šç”±ä¸‰éƒ¨åˆ†ç”¨ `.` è¿æ¥è€Œæˆ

```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiIxMjM0NSIsInVzZXJuYW1lIjoiemhhbmdzYW4ifQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c

   â†“                    â†“                    â†“
 Header              Payload             Signature
 (å¤´éƒ¨)              (è½½è·)               (ç­¾å)
```

### 2.2 Headerå¤´éƒ¨ - Tokençš„è¯´æ˜ä¹¦


**ä½œç”¨**ï¼šè¯´æ˜è¿™ä¸ªTokenç”¨ä»€ä¹ˆç®—æ³•åŠ å¯†çš„

```json
{
  "alg": "HS256",    // åŠ å¯†ç®—æ³•ï¼šHMAC SHA256
  "typ": "JWT"       // ç±»å‹ï¼šJWT Token
}
```

**é€šä¿—ç†è§£**ï¼š
- `alg`ï¼šå‘Šè¯‰éªŒè¯æ–¹"æˆ‘æ˜¯ç”¨HS256ç®—æ³•åŠ å¯†çš„ï¼Œä½ ç”¨åŒæ ·ç®—æ³•éªŒè¯"
- `typ`ï¼šæ ‡è¯†"æˆ‘æ˜¯JWTç±»å‹çš„Token"

**å¸¸è§åŠ å¯†ç®—æ³•**ï¼š

| ç®—æ³• | **å…¨ç§°** | **è¯´æ˜** | **é€‚ç”¨åœºæ™¯** |
|------|---------|---------|------------|
| `HS256` | HMAC-SHA256 | å¯¹ç§°åŠ å¯†ï¼Œç”¨å¯†é’¥åŠ å¯†å’ŒéªŒè¯ | å•ä½“åº”ç”¨ã€ç®€å•åœºæ™¯ |
| `RS256` | RSA-SHA256 | éå¯¹ç§°åŠ å¯†ï¼Œç§é’¥åŠ å¯†ã€å…¬é’¥éªŒè¯ | **å¾®æœåŠ¡æ¨è** |
| `ES256` | ECDSA-SHA256 | æ¤­åœ†æ›²çº¿åŠ å¯†ï¼Œæ›´å®‰å…¨ | é«˜å®‰å…¨è¦æ±‚åœºæ™¯ |

### 2.3 Payloadè½½è· - çœŸæ­£çš„ç”¨æˆ·æ•°æ®


**ä½œç”¨**ï¼šå­˜å‚¨å®é™…è¦ä¼ é€’çš„ä¿¡æ¯

```json
{
  "userId": "12345",              // ç”¨æˆ·ID
  "username": "zhangsan",         // ç”¨æˆ·å
  "roles": ["admin", "user"],     // è§’è‰²åˆ—è¡¨
  "exp": 1705982400,              // è¿‡æœŸæ—¶é—´æˆ³
  "iat": 1705896000               // ç­¾å‘æ—¶é—´æˆ³
}
```

**æ ‡å‡†å­—æ®µè¯´æ˜**ï¼š

- `iss` (issuer)ï¼šç­¾å‘è€…ï¼Œè°é¢å‘çš„è¿™ä¸ªToken
- `sub` (subject)ï¼šä¸»é¢˜ï¼Œè¿™ä¸ªTokenæ˜¯å…³äºè°çš„
- `aud` (audience)ï¼šå—ä¼—ï¼Œè¿™ä¸ªTokenæ˜¯ç»™è°ç”¨çš„
- `exp` (expiration)ï¼šè¿‡æœŸæ—¶é—´ âš ï¸ **å¿…éœ€å­—æ®µ**
- `iat` (issued at)ï¼šç­¾å‘æ—¶é—´
- `nbf` (not before)ï¼šç”Ÿæ•ˆæ—¶é—´ï¼Œåœ¨æ­¤ä¹‹å‰ä¸å¯ç”¨

**è‡ªå®šä¹‰å­—æ®µ**ï¼šå¯ä»¥æ·»åŠ ä¸šåŠ¡éœ€è¦çš„ä»»ä½•ä¿¡æ¯
```json
{
  "userId": "12345",
  "username": "zhangsan",
  "phone": "13800138000",
  "roles": ["admin"],
  "permissions": ["order:read", "order:write"]
}
```

> âš ï¸ **é‡è¦æç¤º**  
> Payloadæ˜¯Base64ç¼–ç ï¼Œ**ä¸æ˜¯åŠ å¯†**ï¼ä»»ä½•äººéƒ½å¯ä»¥è§£ç æŸ¥çœ‹  
> âŒ ä¸è¦å­˜å‚¨æ•æ„Ÿä¿¡æ¯ï¼šå¯†ç ã€èº«ä»½è¯å·ã€é“¶è¡Œå¡ç­‰  
> âœ… åªå­˜å‚¨å¿…è¦çš„èº«ä»½æ ‡è¯†å’Œæƒé™ä¿¡æ¯

### 2.4 Signatureç­¾å - é˜²ç¯¡æ”¹çš„ä¿è¯


**ä½œç”¨**ï¼šé˜²æ­¢Tokenè¢«ç¯¡æ”¹

**ç­¾åç”Ÿæˆè¿‡ç¨‹**ï¼š

```
1. å‡†å¤‡æ•°æ®
   data = base64UrlEncode(header) + "." + base64UrlEncode(payload)
   
2. ä½¿ç”¨å¯†é’¥åŠ å¯†
   signature = HMACSHA256(data, secret_key)
   
3. æœ€ç»ˆToken
   token = data + "." + signature
```

**é€šä¿—ç†è§£**ï¼š
- å°±åƒç»™æ–‡ä»¶ç›–ç« ï¼Œæœ‰ç« æ‰æ˜¯çœŸçš„
- å¦‚æœæœ‰äººå·å·æ”¹äº†Payloadï¼Œç­¾åå°±å¯¹ä¸ä¸Šäº†
- éªŒè¯æ—¶é‡æ–°è®¡ç®—ç­¾åï¼Œå¯¹æ¯”æ˜¯å¦ä¸€è‡´

**éªŒè¯è¿‡ç¨‹ç¤ºä¾‹**ï¼š

```
æ”¶åˆ°Tokenï¼š
eyJhbGc...  .  eyJ1c2Vy...  .  SflKxwRJ...
 Header         Payload        Signature(æ—§)

éªŒè¯æ­¥éª¤ï¼š
1. æå–Headerå’ŒPayload
2. ç”¨åŒæ ·ç®—æ³•å’Œå¯†é’¥é‡æ–°è®¡ç®—ç­¾å
   newSignature = HMACSHA256(Header+Payload, secret_key)
3. å¯¹æ¯”ç­¾å
   if (newSignature == Signature(æ—§)) {
     âœ… éªŒè¯é€šè¿‡ï¼Œæ•°æ®æœªè¢«ç¯¡æ”¹
   } else {
     âŒ éªŒè¯å¤±è´¥ï¼Œæ•°æ®å¯èƒ½è¢«ä¿®æ”¹
   }
```

---

## 3. ğŸ”’ Tokenç­¾åéªŒè¯æœºåˆ¶


### 3.1 å¯¹ç§°åŠ å¯†éªŒè¯ï¼ˆHS256ï¼‰


**å·¥ä½œåŸç†**ï¼šåŠ å¯†å’Œè§£å¯†ç”¨åŒä¸€ä¸ªå¯†é’¥

```
è®¤è¯æœåŠ¡                      ç½‘å…³/å¾®æœåŠ¡
    |                             |
    |-- ç”¨åŒä¸€ä¸ªå¯†é’¥ secret123 ----|
    |                             |
  ç”ŸæˆToken                    éªŒè¯Token
  HMAC(data, secret123)       HMAC(data, secret123)
```

**é…ç½®ç¤ºä¾‹**ï¼š

```yaml
# application.yml
spring:
  security:
    jwt:
      secret: mySecretKey123456789  # å¯†é’¥è‡³å°‘32ä½
```

**éªŒè¯ä»£ç ç¤ºä¾‹**ï¼š

```java
// HS256éªŒè¯Token
public boolean validateToken(String token) {
    try {
        // ä½¿ç”¨å¯†é’¥éªŒè¯
        Jwts.parser()
            .setSigningKey("mySecretKey123456789")
            .parseClaimsJws(token);
        return true;  // éªŒè¯æˆåŠŸ
    } catch (Exception e) {
        return false; // éªŒè¯å¤±è´¥
    }
}
```

**ä¼˜ç¼ºç‚¹å¯¹æ¯”**ï¼š

| ç‰¹ç‚¹ | è¯´æ˜ |
|------|------|
| âœ… **ç®€å•** | é…ç½®ç®€å•ï¼Œåªéœ€ä¸€ä¸ªå¯†é’¥ |
| âœ… **å¿«é€Ÿ** | åŠ å¯†è§£å¯†é€Ÿåº¦å¿« |
| âŒ **å¯†é’¥å…±äº«** | æ‰€æœ‰æœåŠ¡éƒ½è¦æœ‰è¿™ä¸ªå¯†é’¥ |
| âŒ **å®‰å…¨é£é™©** | å¯†é’¥æ³„éœ²ï¼Œæ‰€æœ‰Tokenéƒ½ä¸å®‰å…¨ |

### 3.2 éå¯¹ç§°åŠ å¯†éªŒè¯ï¼ˆRS256ï¼‰- å¾®æœåŠ¡æ¨è


**å·¥ä½œåŸç†**ï¼šç§é’¥åŠ å¯†ï¼Œå…¬é’¥éªŒè¯

```
è®¤è¯æœåŠ¡                      ç½‘å…³/å¾®æœåŠ¡
    |                             |
 ç§é’¥åŠ å¯†                       å…¬é’¥éªŒè¯
    |                             |
    |--- åªéœ€è¦å…¬é’¥å³å¯éªŒè¯ -------|
```

**ä¸ºä»€ä¹ˆæ›´å®‰å…¨**ï¼š

```
ç§é’¥ï¼šåªæœ‰è®¤è¯æœåŠ¡æŒæœ‰
   â†“
ç”ŸæˆTokenï¼ˆç­¾åï¼‰
   â†“
å…¬é’¥ï¼šæ‰€æœ‰æœåŠ¡éƒ½å¯ä»¥æœ‰
   â†“
éªŒè¯Tokenï¼ˆä¸èƒ½ç”Ÿæˆæ–°Tokenï¼‰

ä¼˜åŠ¿ï¼š
âœ… å³ä½¿å…¬é’¥æ³„éœ²ï¼Œä¹Ÿæ— æ³•ä¼ªé€ Token
âœ… å¾®æœåŠ¡åªéœ€è¦å…¬é’¥ï¼Œä¸éœ€è¦ç§é’¥
âœ… è®¤è¯å’ŒéªŒè¯èŒè´£åˆ†ç¦»
```

**å®é™…åœºæ™¯å¯¹æ¯”**ï¼š

```
å¯¹ç§°åŠ å¯†é—®é¢˜ï¼š
è®¢å•æœåŠ¡è¢«æ”»å‡» â†’ å¯†é’¥æ³„éœ² â†’ æ”»å‡»è€…å¯ä»¥ç”Ÿæˆä»»æ„Token
                           â†’ å…¨ç³»ç»Ÿå¤±å®ˆï¼

éå¯¹ç§°åŠ å¯†ä¼˜åŠ¿ï¼š
è®¢å•æœåŠ¡è¢«æ”»å‡» â†’ å…¬é’¥æ³„éœ² â†’ æ”»å‡»è€…åªèƒ½éªŒè¯Token
                          â†’ æ— æ³•ç”Ÿæˆæ–°Token
                          â†’ ç³»ç»Ÿä»ç„¶å®‰å…¨ï¼
```

### 3.3 éªŒè¯æµç¨‹è¯¦è§£


**ç½‘å…³TokenéªŒè¯å®Œæ•´æµç¨‹**ï¼š

```
1. æå–Token
   è¯·æ±‚å¤´ â†’ Authorization: Bearer eyJhbGc...
          â†“
   æå– â†’ eyJhbGc...

2. è§£æTokenç»“æ„
   Token â†’ Header + Payload + Signature
   
3. éªŒè¯ç­¾å
   ç”¨å…¬é’¥/å¯†é’¥éªŒè¯ â†’ ç­¾åæ˜¯å¦æœ‰æ•ˆï¼Ÿ
   
4. éªŒè¯è¿‡æœŸæ—¶é—´
   å½“å‰æ—¶é—´ vs Tokençš„expå­—æ®µ
   
5. éªŒè¯è‡ªå®šä¹‰è§„åˆ™ï¼ˆå¯é€‰ï¼‰
   - æ˜¯å¦åœ¨é»‘åå•ä¸­
   - æ˜¯å¦è¢«å¼ºåˆ¶ä¸‹çº¿
   - å…¶ä»–ä¸šåŠ¡è§„åˆ™
   
6. éªŒè¯ç»“æœ
   âœ… å…¨éƒ¨é€šè¿‡ â†’ æ”¾è¡Œè¯·æ±‚
   âŒ ä»»ä¸€å¤±è´¥ â†’ è¿”å›401æœªæˆæƒ
```

---

## 4. ğŸ”‘ å…¬é’¥ç§é’¥é…ç½®å®æˆ˜


### 4.1 ç”ŸæˆRSAå¯†é’¥å¯¹


**ä½¿ç”¨OpenSSLç”Ÿæˆ**ï¼š

```bash
# 1. ç”Ÿæˆç§é’¥ï¼ˆ2048ä½ï¼‰
openssl genrsa -out private_key.pem 2048

# 2. ä»ç§é’¥ç”Ÿæˆå…¬é’¥
openssl rsa -in private_key.pem -pubout -out public_key.pem
```

**ä½¿ç”¨Javaä»£ç ç”Ÿæˆ**ï¼š

```java
// ç”ŸæˆRSAå¯†é’¥å¯¹
KeyPairGenerator generator = KeyPairGenerator.getInstance("RSA");
generator.initialize(2048);  // å¯†é’¥é•¿åº¦2048ä½
KeyPair keyPair = generator.generateKeyPair();

// è·å–ç§é’¥
PrivateKey privateKey = keyPair.getPrivate();
String privateKeyStr = Base64.getEncoder()
    .encodeToString(privateKey.getEncoded());

// è·å–å…¬é’¥
PublicKey publicKey = keyPair.getPublic();
String publicKeyStr = Base64.getEncoder()
    .encodeToString(publicKey.getEncoded());

System.out.println("ç§é’¥ï¼š" + privateKeyStr);
System.out.println("å…¬é’¥ï¼š" + publicKeyStr);
```

### 4.2 è®¤è¯æœåŠ¡é…ç½®ï¼ˆæŒæœ‰ç§é’¥ï¼‰


**é…ç½®æ–‡ä»¶**ï¼š

```yaml
# auth-service/application.yml
spring:
  security:
    jwt:
      # ç§é’¥é…ç½®ï¼ˆç”¨äºç”ŸæˆTokenï¼‰
      private-key: |
        -----BEGIN PRIVATE KEY-----
        MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQC7VJT...
        -----END PRIVATE KEY-----
      
      # Tokenæœ‰æ•ˆæœŸï¼ˆå•ä½ï¼šç§’ï¼‰
      expiration: 7200  # 2å°æ—¶
```

**ç”ŸæˆTokenä»£ç **ï¼š

```java
@Service
public class JwtTokenService {
    
    @Value("${spring.security.jwt.private-key}")
    private String privateKeyStr;
    
    @Value("${spring.security.jwt.expiration}")
    private Long expiration;
    
    // ç”ŸæˆToken
    public String generateToken(UserDetails user) {
        // åŠ è½½ç§é’¥
        PrivateKey privateKey = loadPrivateKey(privateKeyStr);
        
        // æ„å»ºToken
        return Jwts.builder()
            .setSubject(user.getUsername())                    // ç”¨æˆ·å
            .claim("userId", user.getId())                     // ç”¨æˆ·ID
            .claim("roles", user.getRoles())                   // è§’è‰²
            .setIssuedAt(new Date())                           // ç­¾å‘æ—¶é—´
            .setExpiration(new Date(System.currentTimeMillis() 
                + expiration * 1000))                          // è¿‡æœŸæ—¶é—´
            .signWith(privateKey, SignatureAlgorithm.RS256)    // ç§é’¥ç­¾å
            .compact();
    }
    
    // åŠ è½½ç§é’¥
    private PrivateKey loadPrivateKey(String key) {
        // å»é™¤PEMæ ¼å¼çš„å¤´å°¾
        key = key.replace("-----BEGIN PRIVATE KEY-----", "")
                 .replace("-----END PRIVATE KEY-----", "")
                 .replaceAll("\\s", "");
        
        // Base64è§£ç 
        byte[] keyBytes = Base64.getDecoder().decode(key);
        
        // ç”Ÿæˆç§é’¥å¯¹è±¡
        PKCS8EncodedKeySpec spec = new PKCS8EncodedKeySpec(keyBytes);
        KeyFactory factory = KeyFactory.getInstance("RSA");
        return factory.generatePrivate(spec);
    }
}
```

### 4.3 ç½‘å…³é…ç½®ï¼ˆæŒæœ‰å…¬é’¥ï¼‰


**é…ç½®æ–‡ä»¶**ï¼š

```yaml
# gateway-service/application.yml
spring:
  cloud:
    gateway:
      routes:
        - id: order-service
          uri: lb://order-service
          predicates:
            - Path=/order/**
          filters:
            - JwtAuthFilter  # JWTéªŒè¯è¿‡æ»¤å™¨
            
  security:
    jwt:
      # å…¬é’¥é…ç½®ï¼ˆç”¨äºéªŒè¯Tokenï¼‰
      public-key: |
        -----BEGIN PUBLIC KEY-----
        MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAu1SU9PN...
        -----END PUBLIC KEY-----
```

**éªŒè¯Tokenä»£ç **ï¼š

```java
@Component
public class JwtAuthFilter implements GlobalFilter, Ordered {
    
    @Value("${spring.security.jwt.public-key}")
    private String publicKeyStr;
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, 
                              GatewayFilterChain chain) {
        // 1. è·å–Token
        String token = extractToken(exchange.getRequest());
        
        if (token == null) {
            return unauthorized(exchange);  // æœªæä¾›Token
        }
        
        // 2. éªŒè¯Token
        try {
            PublicKey publicKey = loadPublicKey(publicKeyStr);
            
            Claims claims = Jwts.parserBuilder()
                .setSigningKey(publicKey)     // è®¾ç½®å…¬é’¥
                .build()
                .parseClaimsJws(token)        // è§£æéªŒè¯
                .getBody();
            
            // 3. TokenéªŒè¯æˆåŠŸï¼Œæå–ç”¨æˆ·ä¿¡æ¯
            String userId = claims.get("userId", String.class);
            String username = claims.getSubject();
            
            // 4. å°†ç”¨æˆ·ä¿¡æ¯ä¼ é€’ç»™ä¸‹æ¸¸æœåŠ¡ï¼ˆè§ç¬¬6ç« ï¼‰
            ServerHttpRequest request = exchange.getRequest()
                .mutate()
                .header("X-User-Id", userId)
                .header("X-Username", username)
                .build();
            
            return chain.filter(exchange.mutate()
                .request(request).build());
            
        } catch (ExpiredJwtException e) {
            return unauthorized(exchange, "Tokenå·²è¿‡æœŸ");
        } catch (Exception e) {
            return unauthorized(exchange, "Tokenæ— æ•ˆ");
        }
    }
    
    // åŠ è½½å…¬é’¥
    private PublicKey loadPublicKey(String key) {
        key = key.replace("-----BEGIN PUBLIC KEY-----", "")
                 .replace("-----END PUBLIC KEY-----", "")
                 .replaceAll("\\s", "");
        
        byte[] keyBytes = Base64.getDecoder().decode(key);
        X509EncodedKeySpec spec = new X509EncodedKeySpec(keyBytes);
        KeyFactory factory = KeyFactory.getInstance("RSA");
        return factory.generatePublic(spec);
    }
    
    // æå–Token
    private String extractToken(ServerHttpRequest request) {
        String auth = request.getHeaders().getFirst("Authorization");
        if (auth != null && auth.startsWith("Bearer ")) {
            return auth.substring(7);
        }
        return null;
    }
    
    @Override
    public int getOrder() {
        return -100;  // ä¼˜å…ˆçº§é«˜ï¼Œå…ˆæ‰§è¡Œ
    }
}
```

### 4.4 é…ç½®æœ€ä½³å®è·µ


**å¯†é’¥ç®¡ç†å»ºè®®**ï¼š

```
1. å¯†é’¥å­˜å‚¨
   âŒ ä¸è¦ç¡¬ç¼–ç åœ¨ä»£ç ä¸­
   âŒ ä¸è¦æäº¤åˆ°Gitä»“åº“
   âœ… ä½¿ç”¨é…ç½®ä¸­å¿ƒï¼ˆNacosã€Apolloï¼‰
   âœ… ä½¿ç”¨ç¯å¢ƒå˜é‡
   âœ… ä½¿ç”¨å¯†é’¥ç®¡ç†æœåŠ¡ï¼ˆVaultï¼‰

2. å¯†é’¥è½®æ¢
   âœ… å®šæœŸæ›´æ¢å¯†é’¥ï¼ˆå¦‚æ¯3ä¸ªæœˆï¼‰
   âœ… æ”¯æŒå¤šç‰ˆæœ¬å¯†é’¥å…±å­˜
   âœ… å¹³æ»‘è¿‡æ¸¡ï¼Œé¿å…æœåŠ¡ä¸­æ–­

3. ç¯å¢ƒéš”ç¦»
   å¼€å‘ç¯å¢ƒï¼šå¼€å‘å¯†é’¥å¯¹
   æµ‹è¯•ç¯å¢ƒï¼šæµ‹è¯•å¯†é’¥å¯¹
   ç”Ÿäº§ç¯å¢ƒï¼šç”Ÿäº§å¯†é’¥å¯¹
   âœ… ä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒå¯†é’¥
```

---

## 5. ğŸ” Tokenè§£æä¸ä¿¡æ¯æå–


### 5.1 æ‰‹åŠ¨è§£æToken


**è§£æHeaderå’ŒPayload**ï¼š

```java
public class JwtParser {
    
    // è§£æTokenï¼ˆä¸éªŒè¯ç­¾åï¼‰
    public static void parseToken(String token) {
        // Tokenæ ¼å¼ï¼šHeader.Payload.Signature
        String[] parts = token.split("\\.");
        
        // è§£æHeader
        String headerJson = new String(
            Base64.getUrlDecoder().decode(parts[0]));
        System.out.println("Header: " + headerJson);
        
        // è§£æPayload
        String payloadJson = new String(
            Base64.getUrlDecoder().decode(parts[1]));
        System.out.println("Payload: " + payloadJson);
    }
}

è¾“å‡ºç»“æœï¼š
Header: {"alg":"RS256","typ":"JWT"}
Payload: {"userId":"12345","username":"zhangsan","exp":1705982400}
```

> âš ï¸ **å®‰å…¨æç¤º**  
> æ‰‹åŠ¨è§£æåªç”¨äºæŸ¥çœ‹å†…å®¹ï¼Œ**å¿…é¡»å…ˆéªŒè¯ç­¾åå†ä½¿ç”¨æ•°æ®**ï¼

### 5.2 ä½¿ç”¨JWTåº“è§£æ


**å®Œæ•´çš„è§£æéªŒè¯ä»£ç **ï¼š

```java
@Component
public class JwtTokenParser {
    
    @Value("${spring.security.jwt.public-key}")
    private String publicKeyStr;
    
    // è§£æå¹¶éªŒè¯Token
    public UserInfo parseToken(String token) {
        try {
            PublicKey publicKey = loadPublicKey(publicKeyStr);
            
            // è§£æTokenï¼ˆè‡ªåŠ¨éªŒè¯ç­¾åå’Œè¿‡æœŸæ—¶é—´ï¼‰
            Claims claims = Jwts.parserBuilder()
                .setSigningKey(publicKey)
                .build()
                .parseClaimsJws(token)
                .getBody();
            
            // æå–ç”¨æˆ·ä¿¡æ¯
            UserInfo userInfo = new UserInfo();
            userInfo.setUserId(claims.get("userId", String.class));
            userInfo.setUsername(claims.getSubject());
            userInfo.setRoles(claims.get("roles", List.class));
            
            return userInfo;
            
        } catch (ExpiredJwtException e) {
            throw new RuntimeException("Tokenå·²è¿‡æœŸ");
        } catch (SignatureException e) {
            throw new RuntimeException("Tokenç­¾åæ— æ•ˆ");
        } catch (Exception e) {
            throw new RuntimeException("Tokenè§£æå¤±è´¥");
        }
    }
}
```

### 5.3 æå–ç‰¹å®šå­—æ®µ


**å¸¸ç”¨å­—æ®µæå–æ–¹æ³•**ï¼š

```java
// æå–ç”¨æˆ·ID
String userId = claims.get("userId", String.class);

// æå–ç”¨æˆ·å
String username = claims.getSubject();

// æå–è§’è‰²åˆ—è¡¨
@SuppressWarnings("unchecked")
List<String> roles = claims.get("roles", List.class);

// æå–æƒé™åˆ—è¡¨
@SuppressWarnings("unchecked")
List<String> permissions = claims.get("permissions", List.class);

// æå–è¿‡æœŸæ—¶é—´
Date expiration = claims.getExpiration();

// æå–ç­¾å‘æ—¶é—´
Date issuedAt = claims.getIssuedAt();
```

**ç±»å‹å®‰å…¨çš„æå–å°è£…**ï¼š

```java
public class ClaimsExtractor {
    
    // æå–å­—ç¬¦ä¸²
    public static String getString(Claims claims, String key) {
        return claims.get(key, String.class);
    }
    
    // æå–æ•´æ•°
    public static Integer getInteger(Claims claims, String key) {
        return claims.get(key, Integer.class);
    }
    
    // æå–åˆ—è¡¨
    @SuppressWarnings("unchecked")
    public static <T> List<T> getList(Claims claims, String key) {
        return claims.get(key, List.class);
    }
    
    // æå–å¯¹è±¡
    public static <T> T getObject(Claims claims, String key, Class<T> clazz) {
        Object obj = claims.get(key);
        return new ObjectMapper().convertValue(obj, clazz);
    }
}
```

---

## 6. ğŸ“¤ ç”¨æˆ·ä¿¡æ¯ä¼ é€’æ–¹æ¡ˆ


### 6.1 é€šè¿‡è¯·æ±‚å¤´ä¼ é€’


**ç½‘å…³æ·»åŠ è¯·æ±‚å¤´**ï¼š

```java
// åœ¨ç½‘å…³è¿‡æ»¤å™¨ä¸­
@Override
public Mono<Void> filter(ServerWebExchange exchange, 
                          GatewayFilterChain chain) {
    // 1. éªŒè¯Token
    Claims claims = parseAndValidateToken(token);
    
    // 2. æå–ç”¨æˆ·ä¿¡æ¯
    String userId = claims.get("userId", String.class);
    String username = claims.getSubject();
    List<String> roles = claims.get("roles", List.class);
    
    // 3. æ·»åŠ åˆ°è¯·æ±‚å¤´
    ServerHttpRequest request = exchange.getRequest().mutate()
        .header("X-User-Id", userId)
        .header("X-Username", username)
        .header("X-User-Roles", String.join(",", roles))
        .build();
    
    // 4. ä¼ é€’ç»™ä¸‹æ¸¸æœåŠ¡
    return chain.filter(exchange.mutate().request(request).build());
}
```

**å¾®æœåŠ¡æ¥æ”¶ç”¨æˆ·ä¿¡æ¯**ï¼š

```java
@RestController
@RequestMapping("/order")
public class OrderController {
    
    @GetMapping("/my-orders")
    public List<Order> getMyOrders(
        @RequestHeader("X-User-Id") String userId,
        @RequestHeader("X-Username") String username) {
        
        // ç›´æ¥ä½¿ç”¨ç”¨æˆ·ä¿¡æ¯
        return orderService.findByUserId(userId);
    }
}
```

### 6.2 é€šè¿‡ThreadLocalä¼ é€’


**æ‹¦æˆªå™¨æå–ç”¨æˆ·ä¿¡æ¯**ï¼š

```java
@Component
public class UserContextInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                            HttpServletResponse response, 
                            Object handler) {
        // ä»è¯·æ±‚å¤´æå–ç”¨æˆ·ä¿¡æ¯
        String userId = request.getHeader("X-User-Id");
        String username = request.getHeader("X-Username");
        String roles = request.getHeader("X-User-Roles");
        
        // å­˜å…¥ThreadLocal
        UserContext.setUserId(userId);
        UserContext.setUsername(username);
        UserContext.setRoles(Arrays.asList(roles.split(",")));
        
        return true;
    }
    
    @Override
    public void afterCompletion(HttpServletRequest request, 
                                HttpServletResponse response, 
                                Object handler, Exception ex) {
        // æ¸…ç†ThreadLocalï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
        UserContext.clear();
    }
}
```

**ThreadLocalå·¥å…·ç±»**ï¼š

```java
public class UserContext {
    
    private static final ThreadLocal<String> userIdHolder = 
        new ThreadLocal<>();
    private static final ThreadLocal<String> usernameHolder = 
        new ThreadLocal<>();
    private static final ThreadLocal<List<String>> rolesHolder = 
        new ThreadLocal<>();
    
    // è®¾ç½®ç”¨æˆ·ID
    public static void setUserId(String userId) {
        userIdHolder.set(userId);
    }
    
    // è·å–ç”¨æˆ·ID
    public static String getUserId() {
        return userIdHolder.get();
    }
    
    // è®¾ç½®ç”¨æˆ·å
    public static void setUsername(String username) {
        usernameHolder.set(username);
    }
    
    // è·å–ç”¨æˆ·å
    public static String getUsername() {
        return usernameHolder.get();
    }
    
    // è®¾ç½®è§’è‰²
    public static void setRoles(List<String> roles) {
        rolesHolder.set(roles);
    }
    
    // è·å–è§’è‰²
    public static List<String> getRoles() {
        return rolesHolder.get();
    }
    
    // æ¸…ç†æ‰€æœ‰ä¿¡æ¯
    public static void clear() {
        userIdHolder.remove();
        usernameHolder.remove();
        rolesHolder.remove();
    }
}
```

**ä¸šåŠ¡ä»£ç ä½¿ç”¨**ï¼š

```java
@Service
public class OrderService {
    
    public List<Order> getMyOrders() {
        // ç›´æ¥ä»ThreadLocalè·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
        String userId = UserContext.getUserId();
        String username = UserContext.getUsername();
        
        // æŸ¥è¯¢è®¢å•
        return orderRepository.findByUserId(userId);
    }
}
```

### 6.3 ä¸¤ç§æ–¹æ¡ˆå¯¹æ¯”


| æ–¹å¼ | **ä¼˜ç‚¹** | **ç¼ºç‚¹** | **é€‚ç”¨åœºæ™¯** |
|------|---------|---------|------------|
| **è¯·æ±‚å¤´ä¼ é€’** | ç®€å•ç›´æ¥<br>æ— çŠ¶æ€<br>æ˜“äºè°ƒè¯• | æ¯æ¬¡éƒ½è¦ä¼ å‚æ•°<br>Controllerå±‚ä»£ç å†—ä½™ | æœåŠ¡é—´è°ƒç”¨<br>éœ€è¦æ˜ç¡®ä¼ é€’çš„åœºæ™¯ |
| **ThreadLocal** | ä»£ç ç®€æ´<br>å…¨å±€å¯ç”¨<br>æ— éœ€ä¼ å‚ | éœ€è¦æ‹¦æˆªå™¨é…ç½®<br>å¿…é¡»è®°å¾—æ¸…ç†<br>å¼‚æ­¥è°ƒç”¨ä¼šä¸¢å¤± | åŒæ­¥ä¸šåŠ¡å¤„ç†<br>éœ€è¦å…¨å±€ç”¨æˆ·ä¿¡æ¯ |

---

## 7. â° Tokenè¿‡æœŸå¤„ç†ç­–ç•¥


### 7.1 Tokenè¿‡æœŸæ£€æµ‹


**è‡ªåŠ¨è¿‡æœŸæ£€æµ‹**ï¼š

```java
try {
    Claims claims = Jwts.parserBuilder()
        .setSigningKey(publicKey)
        .build()
        .parseClaimsJws(token)  // ä¼šè‡ªåŠ¨æ£€æŸ¥expå­—æ®µ
        .getBody();
    
    // Tokenæœ‰æ•ˆ
    
} catch (ExpiredJwtException e) {
    // Tokenå·²è¿‡æœŸ
    log.warn("Tokenå·²è¿‡æœŸ: {}", e.getMessage());
    throw new UnauthorizedException("ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•");
}
```

**æ‰‹åŠ¨æ£€æŸ¥è¿‡æœŸæ—¶é—´**ï¼š

```java
public boolean isTokenExpired(Claims claims) {
    Date expiration = claims.getExpiration();
    return expiration.before(new Date());  // è¿‡æœŸæ—¶é—´æ˜¯å¦æ—©äºå½“å‰æ—¶é—´
}
```

### 7.2 åˆ·æ–°Tokenæœºåˆ¶


**åŒTokenæ–¹æ¡ˆ**ï¼šAccess Token + Refresh Token

```
Access Tokenï¼ˆè®¿é—®ä»¤ç‰Œï¼‰ï¼š
- æœ‰æ•ˆæœŸçŸ­ï¼ˆå¦‚2å°æ—¶ï¼‰
- ç”¨äºæ—¥å¸¸APIè®¿é—®
- åŒ…å«ç”¨æˆ·ä¿¡æ¯

Refresh Tokenï¼ˆåˆ·æ–°ä»¤ç‰Œï¼‰ï¼š
- æœ‰æ•ˆæœŸé•¿ï¼ˆå¦‚7å¤©ï¼‰
- åªç”¨äºåˆ·æ–°Access Token
- å­˜å‚¨æ›´å®‰å…¨ï¼ˆå¦‚HttpOnly Cookieï¼‰
```

**å®ç°æµç¨‹**ï¼š

```
1. ç”¨æˆ·ç™»å½•
   â†“
2. è¿”å›åŒToken
   Access Token (2å°æ—¶) + Refresh Token (7å¤©)
   â†“
3. æ­£å¸¸è®¿é—®
   æºå¸¦Access Tokenè®¿é—®API
   â†“
4. Access Tokenè¿‡æœŸ
   â†“
5. ä½¿ç”¨Refresh Tokenåˆ·æ–°
   POST /auth/refresh
   Body: { "refreshToken": "xxx" }
   â†“
6. è¿”å›æ–°çš„Access Token
   æ–°Access Token (2å°æ—¶)
```

**åˆ·æ–°Tokenæ¥å£å®ç°**ï¼š

```java
@RestController
@RequestMapping("/auth")
public class AuthController {
    
    @PostMapping("/refresh")
    public TokenResponse refreshToken(
        @RequestBody RefreshRequest request) {
        
        String refreshToken = request.getRefreshToken();
        
        try {
            // 1. éªŒè¯Refresh Token
            Claims claims = jwtService.parseRefreshToken(refreshToken);
            String userId = claims.get("userId", String.class);
            
            // 2. ç”Ÿæˆæ–°çš„Access Token
            String newAccessToken = jwtService.generateAccessToken(userId);
            
            // 3. è¿”å›æ–°Token
            return TokenResponse.builder()
                .accessToken(newAccessToken)
                .tokenType("Bearer")
                .expiresIn(7200)  // 2å°æ—¶
                .build();
                
        } catch (ExpiredJwtException e) {
            // Refresh Tokenä¹Ÿè¿‡æœŸäº†
            throw new UnauthorizedException("ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•");
        }
    }
}
```

### 7.3 å‰ç«¯Tokenç®¡ç†


**å‰ç«¯å¤„ç†æµç¨‹**ï¼š

```javascript
// Axiosè¯·æ±‚æ‹¦æˆªå™¨
axios.interceptors.request.use(
  config => {
    // æ·»åŠ Access Token
    const token = localStorage.getItem('accessToken');
    if (token) {
      config.headers['Authorization'] = `Bearer ${token}`;
    }
    return config;
  }
);

// Axioså“åº”æ‹¦æˆªå™¨
axios.interceptors.response.use(
  response => response,
  async error => {
    const originalRequest = error.config;
    
    // Tokenè¿‡æœŸï¼ˆ401ï¼‰ä¸”æœªé‡è¯•è¿‡
    if (error.response.status === 401 && !originalRequest._retry) {
      originalRequest._retry = true;
      
      try {
        // ä½¿ç”¨Refresh Tokenåˆ·æ–°
        const refreshToken = localStorage.getItem('refreshToken');
        const response = await axios.post('/auth/refresh', {
          refreshToken
        });
        
        // ä¿å­˜æ–°Token
        const newToken = response.data.accessToken;
        localStorage.setItem('accessToken', newToken);
        
        // é‡è¯•åŸè¯·æ±‚
        originalRequest.headers['Authorization'] = `Bearer ${newToken}`;
        return axios(originalRequest);
        
      } catch (refreshError) {
        // åˆ·æ–°å¤±è´¥ï¼Œè·³è½¬ç™»å½•é¡µ
        localStorage.clear();
        window.location.href = '/login';
        return Promise.reject(refreshError);
      }
    }
    
    return Promise.reject(error);
  }
);
```

### 7.4 Tokenè¿‡æœŸæ—¶é—´è®¾ç½®å»ºè®®


**ä¸åŒåœºæ™¯çš„è¿‡æœŸæ—¶é—´**ï¼š

| åœºæ™¯ | **Access Token** | **Refresh Token** | **è¯´æ˜** |
|------|-----------------|------------------|---------|
| **Webåº”ç”¨** | 2å°æ—¶ | 7å¤© | å¹³è¡¡å®‰å…¨æ€§å’Œç”¨æˆ·ä½“éªŒ |
| **ç§»åŠ¨App** | 24å°æ—¶ | 30å¤© | å‡å°‘é¢‘ç¹ç™»å½• |
| **ç®¡ç†åå°** | 30åˆ†é’Ÿ | 1å¤© | é«˜å®‰å…¨è¦æ±‚ |
| **å…¬å…±è®¾å¤‡** | 15åˆ†é’Ÿ | æ— Refresh Token | ç”¨å®Œå³ç™»å‡º |

**é…ç½®ç¤ºä¾‹**ï¼š

```yaml
spring:
  security:
    jwt:
      access-token-expiration: 7200    # 2å°æ—¶
      refresh-token-expiration: 604800 # 7å¤©
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ JWTæœ¬è´¨ï¼šè‡ªåŒ…å«çš„åŠ å¯†Tokenï¼Œæ— éœ€æœåŠ¡å™¨å­˜å‚¨
ğŸ”¸ ä¸‰æ®µç»“æ„ï¼šHeader(ç®—æ³•) + Payload(æ•°æ®) + Signature(ç­¾å)
ğŸ”¸ éªŒè¯æ–¹å¼ï¼šå¯¹ç§°åŠ å¯†(HS256) å’Œ éå¯¹ç§°åŠ å¯†(RS256)
ğŸ”¸ å®‰å…¨åŸåˆ™ï¼šç§é’¥ç­¾å‘ã€å…¬é’¥éªŒè¯ã€å®šæœŸè½®æ¢
ğŸ”¸ ä¿¡æ¯ä¼ é€’ï¼šè¯·æ±‚å¤´ä¼ é€’ æˆ– ThreadLocalå­˜å‚¨
ğŸ”¸ è¿‡æœŸå¤„ç†ï¼šåŒTokenæœºåˆ¶ã€è‡ªåŠ¨åˆ·æ–°ã€å‰ç«¯æ‹¦æˆª
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆå¾®æœåŠ¡ç”¨JWT**

```
Sessionæ–¹å¼çš„é—®é¢˜ï¼š
âŒ éœ€è¦å…±äº«Sessionå­˜å‚¨
âŒ å¢åŠ ç³»ç»Ÿå¤æ‚åº¦
âŒ éš¾ä»¥æ°´å¹³æ‰©å±•

JWTçš„ä¼˜åŠ¿ï¼š
âœ… è‡ªåŒ…å«ï¼Œæ— éœ€å­˜å‚¨
âœ… å¤©ç„¶æ”¯æŒåˆ†å¸ƒå¼
âœ… å‡å°‘æ•°æ®åº“æŸ¥è¯¢
âœ… ç»Ÿä¸€è®¤è¯ç½‘å…³
```

**ğŸ”¹ å¯¹ç§°vséå¯¹ç§°åŠ å¯†çš„é€‰æ‹©**

```
å¯¹ç§°åŠ å¯†(HS256)ï¼š
é€‚ç”¨ï¼šå•ä½“åº”ç”¨ã€å†…éƒ¨ç³»ç»Ÿ
ä¼˜åŠ¿ï¼šç®€å•å¿«é€Ÿ
é£é™©ï¼šå¯†é’¥æ³„éœ²å½±å“å¤§

éå¯¹ç§°åŠ å¯†(RS256)ï¼š
é€‚ç”¨ï¼šå¾®æœåŠ¡ã€å¼€æ”¾å¹³å°
ä¼˜åŠ¿ï¼šå®‰å…¨æ€§é«˜ã€èŒè´£åˆ†ç¦»
æˆæœ¬ï¼šé…ç½®ç¨å¤æ‚ã€æ€§èƒ½ç¨ä½

æ¨èï¼šå¾®æœåŠ¡ç¯å¢ƒä½¿ç”¨RS256
```

**ğŸ”¹ Tokenè¿‡æœŸçš„å¤„ç†æ€è·¯**

```
å•Tokenæ–¹æ¡ˆï¼š
- è¿‡æœŸå°±é‡æ–°ç™»å½•
- ç®€å•ä½†ä½“éªŒå·®

åŒTokenæ–¹æ¡ˆï¼š
- Access Token: çŸ­æœŸæœ‰æ•ˆï¼Œé¢‘ç¹ä½¿ç”¨
- Refresh Token: é•¿æœŸæœ‰æ•ˆï¼Œä»…ç”¨äºåˆ·æ–°
- å¹³è¡¡å®‰å…¨æ€§å’Œç”¨æˆ·ä½“éªŒ

æœ€ä½³å®è·µï¼š
Access Tokenå­˜å†…å­˜ï¼ŒRefresh Tokenå­˜HttpOnly Cookie
```

### 8.3 å®æˆ˜æ³¨æ„äº‹é¡¹


**å®‰å…¨è¦ç‚¹**ï¼š

```
âœ… å¿…åšï¼š
1. Payloadä¸å­˜æ•æ„Ÿä¿¡æ¯
2. ä½¿ç”¨HTTPSä¼ è¾“Token
3. è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´
4. å®šæœŸè½®æ¢å¯†é’¥
5. éªŒè¯Tokenç­¾åå’Œè¿‡æœŸæ—¶é—´

âŒ ç¦æ­¢ï¼š
1. åœ¨URLä¸­ä¼ é€’Token
2. Tokenå­˜å‚¨åœ¨LocalStorageï¼ˆæ˜“å—XSSæ”»å‡»ï¼‰
3. ä½¿ç”¨è¿‡çŸ­çš„å¯†é’¥
4. å¿½ç•¥Tokenè¿‡æœŸæ£€æŸ¥
```

**æ€§èƒ½ä¼˜åŒ–**ï¼š

```
1. ç¼“å­˜å…¬é’¥
   - é¿å…æ¯æ¬¡è¯·æ±‚éƒ½åŠ è½½å…¬é’¥æ–‡ä»¶
   - ä½¿ç”¨å•ä¾‹æ¨¡å¼æˆ–@Beané…ç½®

2. å¼‚æ­¥éªŒè¯ï¼ˆå¯é€‰ï¼‰
   - é«˜å¹¶å‘åœºæ™¯ä¸‹å¼‚æ­¥éªŒè¯Token
   - ä½¿ç”¨Reactorå“åº”å¼ç¼–ç¨‹

3. Tokenä½“ç§¯ä¼˜åŒ–
   - Payloadåªå­˜å¿…è¦ä¿¡æ¯
   - é¿å…å­˜å‚¨å¤§é‡æ•°æ®
```

**è°ƒè¯•æŠ€å·§**ï¼š

```
1. åœ¨çº¿è§£æå·¥å…·
   https://jwt.io
   ç²˜è´´TokenæŸ¥çœ‹Payloadå†…å®¹

2. æ—¥å¿—è®°å½•
   è®°å½•TokenéªŒè¯å¤±è´¥çš„åŸå› 
   ä¾¿äºæ’æŸ¥é—®é¢˜

3. ç»Ÿä¸€å¼‚å¸¸å¤„ç†
   æ•è·JWTç›¸å…³å¼‚å¸¸
   è¿”å›å‹å¥½çš„é”™è¯¯ä¿¡æ¯
```

### 8.4 å®Œæ•´å®ç°æ£€æŸ¥æ¸…å•


- [x] **è®¤è¯æœåŠ¡**
  - [x] ç”ŸæˆRSAå¯†é’¥å¯¹
  - [x] é…ç½®ç§é’¥
  - [x] å®ç°Tokenç”Ÿæˆæ¥å£
  - [x] å®ç°Tokenåˆ·æ–°æ¥å£

- [x] **ç½‘å…³æœåŠ¡**
  - [x] é…ç½®å…¬é’¥
  - [x] å®ç°JWTéªŒè¯è¿‡æ»¤å™¨
  - [x] æå–ç”¨æˆ·ä¿¡æ¯ä¼ é€’ä¸‹æ¸¸
  - [x] å¤„ç†Tokenè¿‡æœŸå¼‚å¸¸

- [x] **å¾®æœåŠ¡**
  - [x] é…ç½®æ‹¦æˆªå™¨æå–ç”¨æˆ·ä¿¡æ¯
  - [x] å®ç°ThreadLocalå·¥å…·ç±»
  - [x] ä¸šåŠ¡ä»£ç ä½¿ç”¨ç”¨æˆ·ä¿¡æ¯

- [x] **å‰ç«¯åº”ç”¨**
  - [x] ä¿å­˜Token
  - [x] è¯·æ±‚æºå¸¦Token
  - [x] Tokenè¿‡æœŸè‡ªåŠ¨åˆ·æ–°
  - [x] åˆ·æ–°å¤±è´¥è·³è½¬ç™»å½•

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- JWTä¸‰æ®µå¼ï¼Œå¤´éƒ¨è½½è·åŠ ç­¾å
- ç§é’¥ç­¾å‘å…¬é’¥éªŒï¼Œå¾®æœåŠ¡è®¤è¯æœ€å®‰å…¨
- ç½‘å…³ç»Ÿä¸€éªŒèº«ä»½ï¼Œè¯·æ±‚å¤´ä¼ ç”¨æˆ·ä¿¡æ¯
- åŒTokené˜²è¿‡æœŸï¼Œä½“éªŒå®‰å…¨ä¸¤å…¼é¡¾