---
title: 2ã€OAuth2é›†æˆ
---
## ğŸ“š ç›®å½•

1. [OAuth2åŸºç¡€è®¤çŸ¥](#1-OAuth2åŸºç¡€è®¤çŸ¥)
2. [OAuth2è®¤è¯æµç¨‹è¯¦è§£](#2-OAuth2è®¤è¯æµç¨‹è¯¦è§£)
3. [å››ç§æˆæƒæ¨¡å¼æ·±å…¥ç†è§£](#3-å››ç§æˆæƒæ¨¡å¼æ·±å…¥ç†è§£)
4. [Tokenæ ¡éªŒé€»è¾‘å®ç°](#4-Tokenæ ¡éªŒé€»è¾‘å®ç°)
5. [æƒé™æ§åˆ¶å®ç°æ–¹æ¡ˆ](#5-æƒé™æ§åˆ¶å®ç°æ–¹æ¡ˆ)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” OAuth2åŸºç¡€è®¤çŸ¥


### 1.1 ä»€ä¹ˆæ˜¯OAuth2


**é€šä¿—ç†è§£**ï¼šOAuth2å°±åƒæ˜¯ä½ å®¶é—¨å£çš„"ä¸´æ—¶é—¨å¡"ç³»ç»Ÿã€‚

```
ç”Ÿæ´»åœºæ™¯ç±»æ¯”ï¼š
ä½ ä½é…’åº—æ—¶ï¼š
- å‰å°ç»™ä½ ä¸€å¼ æˆ¿å¡ï¼ˆTokenï¼‰
- è¿™å¼ å¡åªèƒ½å¼€ä½ çš„æˆ¿é—´é—¨
- æœ‰ä½¿ç”¨æœŸé™ï¼ˆè¿‡æœŸå¤±æ•ˆï¼‰
- ä¸¢äº†å¯ä»¥é‡æ–°åŠç†
- é€€æˆ¿åè‡ªåŠ¨å¤±æ•ˆ

OAuth2å°±æ˜¯è¿™æ ·çš„"æ•°å­—é—¨å¡"ç³»ç»Ÿï¼
```

**ğŸ’¡ æ ¸å¿ƒæ¦‚å¿µ**
```
OAuth2 = Open Authorization 2.0ï¼ˆå¼€æ”¾æˆæƒ2.0ç‰ˆæœ¬ï¼‰

æœ¬è´¨ï¼šä¸€ç§æˆæƒæ¡†æ¶
ä½œç”¨ï¼šè®©ç¬¬ä¸‰æ–¹åº”ç”¨å®‰å…¨åœ°è·å–ç”¨æˆ·èµ„æºï¼Œè€Œä¸éœ€è¦ç”¨æˆ·å¯†ç 
ä½ç½®ï¼šç½‘å…³å±‚çš„å®‰å…¨å«å£«
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦OAuth2


**ğŸ¤” æ²¡æœ‰OAuth2çš„é—®é¢˜**

```
ä¼ ç»Ÿæ–¹å¼çš„å®‰å…¨éšæ‚£ï¼š

åœºæ™¯ï¼šä½ æƒ³è®©"ç¾å›¾ç§€ç§€"è®¿é—®ä½ å¾®ä¿¡çš„å¤´åƒ

âŒ ç›´æ¥ç»™å¯†ç æ–¹å¼ï¼š
ç”¨æˆ· â†’ æŠŠå¾®ä¿¡è´¦å·å¯†ç ç»™ç¾å›¾ç§€ç§€ â†’ ç¾å›¾ç§€ç§€ç™»å½•å¾®ä¿¡ â†’ è·å–å¤´åƒ

é—®é¢˜æ¸…å•ï¼š
1. å¯†ç æ³„éœ²é£é™© - ç¾å›¾ç§€ç§€çŸ¥é“äº†ä½ çš„å¯†ç 
2. æƒé™è¿‡å¤§ - ç¾å›¾ç§€ç§€å¯ä»¥æ“ä½œä½ æ‰€æœ‰å¾®ä¿¡åŠŸèƒ½
3. éš¾ä»¥æ’¤é”€ - æƒ³æ’¤æƒåªèƒ½æ”¹å¯†ç 
4. æ— æ³•æ§åˆ¶ - ä¸çŸ¥é“ç¾å›¾ç§€ç§€åšäº†ä»€ä¹ˆ
```

**âœ… ä½¿ç”¨OAuth2çš„ä¼˜åŠ¿**

```
OAuth2æˆæƒæ–¹å¼ï¼š

ç”¨æˆ· â†’ å¾®ä¿¡æˆæƒé¡µé¢ï¼ˆåŒæ„æˆæƒï¼‰ â†’ ç¾å›¾ç§€ç§€è·å¾—ä¸´æ—¶ä»¤ç‰Œ â†’ ç”¨ä»¤ç‰Œè®¿é—®å¤´åƒ

ä¼˜åŠ¿å¯¹æ¯”ï¼š
ğŸ”¸ å¯†ç å®‰å…¨ï¼šç¾å›¾ç§€ç§€æ°¸è¿œä¸çŸ¥é“ä½ çš„å¯†ç 
ğŸ”¸ æƒé™å¯æ§ï¼šåªæˆæƒ"è¯»å–å¤´åƒ"æƒé™
ğŸ”¸ éšæ—¶æ’¤é”€ï¼šå¯ä»¥åœ¨å¾®ä¿¡é‡Œå–æ¶ˆæˆæƒ
ğŸ”¸ æœ‰æ•ˆæœŸé™ï¼šä»¤ç‰Œä¼šè¿‡æœŸï¼Œå®šæœŸæ›´æ–°
ğŸ”¸ æ“ä½œå¯æŸ¥ï¼šå¯ä»¥çœ‹åˆ°ç¾å›¾ç§€ç§€çš„è®¿é—®è®°å½•
```

### 1.3 OAuth2æ ¸å¿ƒè§’è‰²


**ğŸ­ å››å¤§æ ¸å¿ƒè§’è‰²**

```
ç”Ÿæ´»åŒ–è§’è‰²å¯¹åº”ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  èµ„æºæ‹¥æœ‰è€…                               â”‚
â”‚  (Resource Owner)                       â”‚  â† ä½ ï¼ˆç”¨æˆ·ï¼‰
â”‚  å°±æ˜¯ä½ æœ¬äººï¼Œæ‹¥æœ‰å¾®ä¿¡è´¦å·å’Œå¤´åƒ          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“ æˆæƒ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¢æˆ·ç«¯åº”ç”¨                               â”‚
â”‚  (Client)                               â”‚  â† ç¾å›¾ç§€ç§€APP
â”‚  æƒ³è¦è®¿é—®ä½ èµ„æºçš„ç¬¬ä¸‰æ–¹åº”ç”¨              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“ è¯·æ±‚ä»¤ç‰Œ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æˆæƒæœåŠ¡å™¨                               â”‚
â”‚  (Authorization Server)                 â”‚  â† å¾®ä¿¡è®¤è¯ä¸­å¿ƒ
â”‚  è´Ÿè´£éªŒè¯ç”¨æˆ·èº«ä»½å¹¶é¢å‘ä»¤ç‰Œ              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“ ä½¿ç”¨ä»¤ç‰Œ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  èµ„æºæœåŠ¡å™¨                               â”‚
â”‚  (Resource Server)                      â”‚  â† å¾®ä¿¡å¤´åƒæœåŠ¡å™¨
â”‚  å­˜å‚¨ç”¨æˆ·èµ„æºï¼ŒéªŒè¯ä»¤ç‰Œåæä¾›æ•°æ®        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ“‹ è§’è‰²èŒè´£è¯¦è§£**

| è§’è‰² | é€šä¿—ç†è§£ | ä¸»è¦èŒè´£ | å®é™…ä¾‹å­ |
|------|---------|---------|---------|
| **èµ„æºæ‹¥æœ‰è€…** | ä½ è‡ªå·± | å†³å®šæ˜¯å¦æˆæƒ | å¾®ä¿¡ç”¨æˆ· |
| **å®¢æˆ·ç«¯åº”ç”¨** | ç¬¬ä¸‰æ–¹APP | è¯·æ±‚è®¿é—®èµ„æº | ç¾å›¾ç§€ç§€ |
| **æˆæƒæœåŠ¡å™¨** | è®¤è¯ä¸­å¿ƒ | éªŒè¯èº«ä»½ã€é¢å‘ä»¤ç‰Œ | å¾®ä¿¡OAuthæœåŠ¡ |
| **èµ„æºæœåŠ¡å™¨** | æ•°æ®ä»“åº“ | å­˜å‚¨èµ„æºã€éªŒè¯ä»¤ç‰Œ | å¾®ä¿¡APIæœåŠ¡å™¨ |

---

## 2. ğŸ”„ OAuth2è®¤è¯æµç¨‹è¯¦è§£


### 2.1 æŠ½è±¡æˆæƒæµç¨‹


**ğŸ¯ æ ¸å¿ƒæµç¨‹å›¾**

```
å®¢æˆ·ç«¯           èµ„æºæ‹¥æœ‰è€…         æˆæƒæœåŠ¡å™¨        èµ„æºæœåŠ¡å™¨
(ç¾å›¾ç§€ç§€)        (ä½ )            (å¾®ä¿¡è®¤è¯)        (å¾®ä¿¡API)
   |               |                 |                |
   |--[1]è¯·æ±‚æˆæƒ-->|                 |                |
   |               |                 |                |
   |<--[2]æˆæƒè®¸å¯-|                 |                |
   |               |                 |                |
   |----------[3]æäº¤æˆæƒè®¸å¯-------->|                |
   |               |                 |                |
   |<---------[4]è¿”å›è®¿é—®ä»¤ç‰Œ---------|                |
   |               |                 |                |
   |---------[5]æºå¸¦ä»¤ç‰Œè¯·æ±‚èµ„æº----------------->|
   |               |                 |                |
   |<--------[6]è¿”å›å—ä¿æŠ¤èµ„æº--------------------|
   |               |                 |                |
```

**ğŸ“ æµç¨‹æ­¥éª¤è¯¦è§£**

```
ç¬¬1æ­¥ï¼šè¯·æ±‚æˆæƒ
- ç¾å›¾ç§€ç§€ï¼šã€Œæˆ‘æƒ³è®¿é—®ä½ çš„å¾®ä¿¡å¤´åƒã€
- æ–¹å¼ï¼šè·³è½¬åˆ°å¾®ä¿¡æˆæƒé¡µé¢

ç¬¬2æ­¥ï¼šç”¨æˆ·æˆæƒ
- ä½ ï¼šç‚¹å‡»ã€ŒåŒæ„ã€æŒ‰é’®
- å¾®ä¿¡ï¼šç”Ÿæˆæˆæƒç è¿”å›ç»™ç¾å›¾ç§€ç§€

ç¬¬3æ­¥ï¼šç”³è¯·ä»¤ç‰Œ
- ç¾å›¾ç§€ç§€ï¼šç”¨æˆæƒç å‘å¾®ä¿¡æ¢å–è®¿é—®ä»¤ç‰Œ
- é™„å¸¦ï¼šå®¢æˆ·ç«¯ID + å®¢æˆ·ç«¯å¯†é’¥ï¼ˆè¯æ˜èº«ä»½ï¼‰

ç¬¬4æ­¥ï¼šé¢å‘ä»¤ç‰Œ
- å¾®ä¿¡ï¼šéªŒè¯æˆæƒç å’Œå®¢æˆ·ç«¯èº«ä»½
- è¿”å›ï¼šè®¿é—®ä»¤ç‰Œï¼ˆAccess Tokenï¼‰+ åˆ·æ–°ä»¤ç‰Œï¼ˆRefresh Tokenï¼‰

ç¬¬5æ­¥ï¼šè®¿é—®èµ„æº
- ç¾å›¾ç§€ç§€ï¼šæºå¸¦è®¿é—®ä»¤ç‰Œè¯·æ±‚å¤´åƒ
- æ ¼å¼ï¼šAuthorization: Bearer <access_token>

ç¬¬6æ­¥ï¼šè¿”å›èµ„æº
- å¾®ä¿¡APIï¼šéªŒè¯ä»¤ç‰Œæœ‰æ•ˆæ€§
- è¿”å›ï¼šç”¨æˆ·å¤´åƒæ•°æ®
```

### 2.2 Tokenä»¤ç‰Œæœºåˆ¶


**ğŸ”‘ ä»¤ç‰Œç±»å‹ä¸ä½œç”¨**

```
ä»¤ç‰Œå®¶æ—æˆå‘˜ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è®¿é—®ä»¤ç‰Œ (Access Token)              â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚
â”‚  ä½œç”¨ï¼šè®¿é—®å—ä¿æŠ¤èµ„æºçš„"é—¨ç¥¨"         â”‚
â”‚  ç‰¹ç‚¹ï¼šçŸ­æœŸæœ‰æ•ˆï¼ˆå¦‚2å°æ—¶ï¼‰             â”‚
â”‚  æ ¼å¼ï¼šJWTæˆ–éšæœºå­—ç¬¦ä¸²                 â”‚
â”‚  ç¤ºä¾‹ï¼šeyJhbGciOiJIUzI1NiIsInR5cCI... â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åˆ·æ–°ä»¤ç‰Œ (Refresh Token)             â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚
â”‚  ä½œç”¨ï¼šè®¿é—®ä»¤ç‰Œè¿‡æœŸåæ¢å–æ–°ä»¤ç‰Œ        â”‚
â”‚  ç‰¹ç‚¹ï¼šé•¿æœŸæœ‰æ•ˆï¼ˆå¦‚30å¤©ï¼‰              â”‚
â”‚  ç”¨é€”ï¼šé¿å…é¢‘ç¹è¦æ±‚ç”¨æˆ·é‡æ–°ç™»å½•        â”‚
â”‚  å®‰å…¨ï¼šå­˜å‚¨æ›´å®‰å…¨ï¼Œä½¿ç”¨é¢‘ç‡ä½          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**âš™ï¸ ä»¤ç‰Œå·¥ä½œæœºåˆ¶**

| ä»¤ç‰Œç‰¹æ€§ | è®¿é—®ä»¤ç‰Œ | åˆ·æ–°ä»¤ç‰Œ |
|---------|---------|---------|
| **æœ‰æ•ˆæœŸ** | `çŸ­ï¼ˆ1-2å°æ—¶ï¼‰` | `é•¿ï¼ˆ7-30å¤©ï¼‰` |
| **ä½¿ç”¨é¢‘ç‡** | `æ¯æ¬¡APIè°ƒç”¨` | `ä»…ä»¤ç‰Œè¿‡æœŸæ—¶` |
| **å­˜å‚¨ä½ç½®** | `å†…å­˜/Cookie` | `å®‰å…¨å­˜å‚¨/æ•°æ®åº“` |
| **æ³„éœ²é£é™©** | `é«˜ï¼ˆé¢‘ç¹ä½¿ç”¨ï¼‰` | `ä½ï¼ˆå¾ˆå°‘ä½¿ç”¨ï¼‰` |
| **æ’¤é”€éš¾åº¦** | `å®¹æ˜“` | `éœ€è¦æœåŠ¡ç«¯æ”¯æŒ` |

---

## 3. ğŸ­ å››ç§æˆæƒæ¨¡å¼æ·±å…¥ç†è§£


### 3.1 æˆæƒç æ¨¡å¼ï¼ˆæœ€å®‰å…¨ï¼‰


**ğŸ” Authorization Code Grant**

**é€‚ç”¨åœºæ™¯**
```
å…¸å‹åº”ç”¨ï¼šæœ‰åç«¯æœåŠ¡å™¨çš„Webåº”ç”¨

âœ… é€‚åˆï¼š
- ä¼ ç»Ÿç½‘ç«™ï¼ˆå¦‚ç”µå•†å¹³å°ï¼‰
- æœ‰æœåŠ¡å™¨ç«¯çš„åº”ç”¨
- éœ€è¦é«˜å®‰å…¨æ€§çš„åœºæ™¯

âŒ ä¸é€‚åˆï¼š
- çº¯å‰ç«¯åº”ç”¨ï¼ˆSPAï¼‰
- ç§»åŠ¨ç«¯åŸç”Ÿåº”ç”¨
- æ— æœåŠ¡å™¨æ¶æ„
```

**ğŸ”„ å®Œæ•´æµç¨‹**

```
ç”¨æˆ·æµè§ˆå™¨         å®¢æˆ·ç«¯æœåŠ¡å™¨        æˆæƒæœåŠ¡å™¨         èµ„æºæœåŠ¡å™¨
    |                  |                  |                  |
    |--[1]è®¿é—®åº”ç”¨---->|                  |                  |
    |                  |                  |                  |
    |<-[2]é‡å®šå‘åˆ°æˆæƒé¡µé¢-------------->|                  |
    | (é™„å¸¦client_id+redirect_uri)       |                  |
    |                  |                  |                  |
    |--[3]ç”¨æˆ·ç™»å½•å¹¶æˆæƒ---------------->|                  |
    |                  |                  |                  |
    |<-[4]è¿”å›æˆæƒç (code)---------------|                  |
    | (é‡å®šå‘å›å®¢æˆ·ç«¯)                     |                  |
    |                  |                  |                  |
    |-[5]ä¼ æˆæƒç ----->|                  |                  |
    |                  |                  |                  |
    |                  |-[6]ç”¨codeæ¢token->|                  |
    |                  | (é™„å¸¦client_secret)|                  |
    |                  |                  |                  |
    |                  |<-[7]è¿”å›token----|                  |
    |                  |                  |                  |
    |<-[8]è¿”å›é¡µé¢-----|                  |                  |
    | (tokenå­˜æœåŠ¡ç«¯)                      |                  |
    |                  |                  |                  |
    |--[9]è¯·æ±‚èµ„æº---->|--[10]æºå¸¦tokenè¯·æ±‚èµ„æº--------->|
    |                  |                  |                  |
    |<-[11]è¿”å›æ•°æ®----|<--------[12]è¿”å›æ•°æ®-----------|
```

**ğŸ’» å…³é”®ä»£ç ç¤ºä¾‹**

```java
// ç¬¬2æ­¥ï¼šé‡å®šå‘åˆ°æˆæƒé¡µé¢
@GetMapping("/oauth2/authorize")
public String authorize() {
    String authUrl = "https://auth-server.com/oauth/authorize" +
        "?client_id=your_client_id" +           // å®¢æˆ·ç«¯ID
        "&response_type=code" +                  // è¡¨ç¤ºè¦æˆæƒç 
        "&redirect_uri=http://your-app.com/callback" + // å›è°ƒåœ°å€
        "&scope=read_user_info";                 // è¯·æ±‚çš„æƒé™èŒƒå›´
    
    return "redirect:" + authUrl;
}

// ç¬¬4æ­¥ï¼šæ¥æ”¶æˆæƒç å¹¶æ¢å–ä»¤ç‰Œ
@GetMapping("/callback")
public String callback(@RequestParam String code) {
    // ç”¨æˆæƒç æ¢å–è®¿é—®ä»¤ç‰Œ
    TokenResponse token = oauthClient.exchangeCodeForToken(
        code,                    // æˆæƒç 
        "your_client_secret"     // å®¢æˆ·ç«¯å¯†é’¥ï¼ˆåç«¯æŒæœ‰ï¼Œä¸æš´éœ²ï¼‰
    );
    
    // ä¿å­˜tokenåˆ°sessionï¼ˆæœåŠ¡ç«¯å­˜å‚¨ï¼‰
    session.setAttribute("access_token", token.getAccessToken());
    
    return "redirect:/home";
}
```

**ğŸ”’ å®‰å…¨ä¼˜åŠ¿**

```
ä¸ºä»€ä¹ˆæœ€å®‰å…¨ï¼Ÿ

âœ“ æˆæƒç æ˜¯ä¸€æ¬¡æ€§çš„
  â””â”€ ç”¨å®Œå³å¤±æ•ˆï¼Œæ— æ³•é‡å¤ä½¿ç”¨

âœ“ client_secretä¸æš´éœ²
  â””â”€ åªåœ¨æœåŠ¡å™¨é—´ä¼ è¾“ï¼Œå‰ç«¯æ°¸è¿œä¸çŸ¥é“

âœ“ tokenå­˜å‚¨åœ¨æœåŠ¡ç«¯
  â””â”€ ä¸ç»è¿‡æµè§ˆå™¨ï¼Œé¿å…XSSæ”»å‡»

âœ“ åŒé‡éªŒè¯
  â””â”€ æˆæƒç éªŒè¯ç”¨æˆ· + client_secretéªŒè¯å®¢æˆ·ç«¯
```

### 3.2 ç®€åŒ–æ¨¡å¼ï¼ˆå·²æ·˜æ±°ï¼‰


**ğŸ“± Implicit Grant**

**é€‚ç”¨åœºæ™¯**
```
å†å²ç”¨é€”ï¼šçº¯å‰ç«¯åº”ç”¨ï¼ˆå·²ä¸æ¨èï¼‰

âš ï¸ ç°çŠ¶ï¼š
- OAuth 2.1è§„èŒƒå·²åºŸå¼ƒ
- å­˜åœ¨ä¸¥é‡å®‰å…¨é—®é¢˜
- å»ºè®®ä½¿ç”¨PKCEæ›¿ä»£

ğŸ“š äº†è§£å³å¯ï¼Œå®é™…å¼€å‘ä¸ä½¿ç”¨
```

**ğŸ”„ ç®€åŒ–æµç¨‹**

```
ç”¨æˆ·æµè§ˆå™¨              æˆæƒæœåŠ¡å™¨
    |                       |
    |--[1]è¯·æ±‚æˆæƒ---------->|
    | (ç›´æ¥è¯·æ±‚token)         |
    |                       |
    |<--[2]è¿”å›token---------|
    | (é€šè¿‡URLç‰‡æ®µ #token)   |
    |                       |
    |--[3]æºå¸¦tokenè®¿é—®API-->|
```

**âŒ å®‰å…¨é—®é¢˜**

| å®‰å…¨éšæ‚£ | å…·ä½“é—®é¢˜ | é£é™©ç­‰çº§ |
|---------|---------|---------|
| **Tokenæš´éœ²** | `åœ¨URLä¸­ä¼ è¾“ï¼Œæ˜“è¢«çªƒå–` | `ğŸ”´ é«˜` |
| **æ— æ³•åˆ·æ–°** | `æ²¡æœ‰refresh_tokenæœºåˆ¶` | `ğŸŸ¡ ä¸­` |
| **æµè§ˆå™¨å†å²** | `tokenè®°å½•åœ¨æµè§ˆå™¨å†å²ä¸­` | `ğŸ”´ é«˜` |
| **æ— å®¢æˆ·ç«¯è®¤è¯** | `æ— æ³•éªŒè¯å®¢æˆ·ç«¯èº«ä»½` | `ğŸ”´ é«˜` |

### 3.3 å¯†ç æ¨¡å¼ï¼ˆæ…ç”¨ï¼‰


**ğŸ”‘ Resource Owner Password Credentials Grant**

**é€‚ç”¨åœºæ™¯**
```
ç‰¹å®šæƒ…å†µï¼šé«˜åº¦ä¿¡ä»»çš„ç¬¬ä¸€æ–¹åº”ç”¨

âœ… å¯ä»¥ä½¿ç”¨ï¼š
- å®˜æ–¹ç§»åŠ¨APPï¼ˆè‡ªå®¶äº§å“ï¼‰
- ä¼ä¸šå†…éƒ¨ç³»ç»Ÿ
- é—ç•™ç³»ç»Ÿè¿ç§»è¿‡æ¸¡

âŒ ç¦æ­¢ä½¿ç”¨ï¼š
- ç¬¬ä¸‰æ–¹åº”ç”¨
- å…¬å¼€çš„Webåº”ç”¨
- ä¸å—ä¿¡ä»»çš„å®¢æˆ·ç«¯
```

**ğŸ”„ å¯†ç æ¨¡å¼æµç¨‹**

```
å®¢æˆ·ç«¯åº”ç”¨         æˆæƒæœåŠ¡å™¨         èµ„æºæœåŠ¡å™¨
    |                  |                  |
    |--[1]ç”¨æˆ·è¾“å…¥è´¦å·å¯†ç -->              |
    |                  |                  |
    |--[2]ç›´æ¥æäº¤ç”¨æˆ·åå¯†ç -->|              |
    |   (é™„å¸¦client_id)      |              |
    |                  |                  |
    |<--[3]è¿”å›token---|                  |
    |                  |                  |
    |--[4]ä½¿ç”¨tokenè®¿é—®èµ„æº------------->|
    |                  |                  |
    |<--[5]è¿”å›æ•°æ®-----------------------|
```

**ğŸ’» ä»£ç ç¤ºä¾‹**

```java
// å¯†ç æ¨¡å¼è·å–ä»¤ç‰Œ
@PostMapping("/oauth2/token/password")
public TokenResponse getTokenByPassword(
    @RequestParam String username,
    @RequestParam String password
) {
    // ç›´æ¥ç”¨ç”¨æˆ·åå¯†ç æ¢token
    return oauthClient.getToken(
        "password",          // grant_type
        username,            // ç”¨æˆ·å
        password,            // å¯†ç 
        "your_client_id",    // å®¢æˆ·ç«¯ID
        "your_client_secret" // å®¢æˆ·ç«¯å¯†é’¥
    );
}
```

**âš ï¸ ä½¿ç”¨æ³¨æ„**

```
å®‰å…¨è¦æ±‚ï¼š

ğŸ”¸ HTTPSä¼ è¾“
  â””â”€ å¿…é¡»ä½¿ç”¨åŠ å¯†é€šé“

ğŸ”¸ å®¢æˆ·ç«¯å¯ä¿¡
  â””â”€ åªç”¨äºå®˜æ–¹åº”ç”¨

ğŸ”¸ å¯†ç ä¸å­˜å‚¨
  â””â”€ ä»…ç”¨äºäº¤æ¢token

ğŸ”¸ å°½å¿«è¿ç§»
  â””â”€ é€æ­¥æ›¿æ¢ä¸ºå…¶ä»–æ¨¡å¼
```

### 3.4 å®¢æˆ·ç«¯æ¨¡å¼ï¼ˆæœåŠ¡é—´è°ƒç”¨ï¼‰


**ğŸ¤– Client Credentials Grant**

**é€‚ç”¨åœºæ™¯**
```
æœåŠ¡é—´é€šä¿¡ï¼šæ— ç”¨æˆ·å‚ä¸çš„åå°äº¤äº’

âœ… å…¸å‹åº”ç”¨ï¼š
- å¾®æœåŠ¡é—´è°ƒç”¨
- å®šæ—¶ä»»åŠ¡è®¿é—®API
- æœåŠ¡å™¨ç«¯æ‰¹å¤„ç†
- ç³»ç»Ÿçº§æ“ä½œ

ç‰¹ç‚¹ï¼šæ²¡æœ‰ç”¨æˆ·æ¦‚å¿µï¼Œåªæœ‰å®¢æˆ·ç«¯èº«ä»½
```

**ğŸ”„ å®¢æˆ·ç«¯æ¨¡å¼æµç¨‹**

```
å®¢æˆ·ç«¯æœåŠ¡         æˆæƒæœåŠ¡å™¨         èµ„æºæœåŠ¡å™¨
    |                  |                  |
    |--[1]è¯·æ±‚token---->|                  |
    | (client_id +      |                  |
    |  client_secret)   |                  |
    |                  |                  |
    |<--[2]è¿”å›token---|                  |
    |                  |                  |
    |--[3]æºå¸¦tokenè®¿é—®API------------->|
    |                  |                  |
    |<--[4]è¿”å›æ•°æ®-----------------------|
```

**ğŸ’» å®ç°ä»£ç **

```java
// å®¢æˆ·ç«¯æ¨¡å¼é…ç½®
@Configuration
public class OAuth2ClientConfig {
    
    @Bean
    public OAuth2RestTemplate clientCredentialsTemplate() {
        // å®¢æˆ·ç«¯å‡­è¯é…ç½®
        ClientCredentialsResourceDetails details = 
            new ClientCredentialsResourceDetails();
        
        details.setClientId("service_client_id");
        details.setClientSecret("service_client_secret");
        details.setAccessTokenUri("https://auth-server.com/oauth/token");
        
        return new OAuth2RestTemplate(details);
    }
}

// ä½¿ç”¨å®¢æˆ·ç«¯æ¨¡å¼è°ƒç”¨
@Service
public class MicroserviceClient {
    
    @Autowired
    private OAuth2RestTemplate restTemplate;
    
    public UserInfo getUserInfo(String userId) {
        // è‡ªåŠ¨æºå¸¦tokenè¯·æ±‚
        return restTemplate.getForObject(
            "https://api-server.com/users/" + userId,
            UserInfo.class
        );
    }
}
```

**ğŸ¯ åº”ç”¨åœºæ™¯å¯¹æ¯”**

| åœºæ™¯ | æ˜¯å¦éœ€è¦ç”¨æˆ· | æ¨èæ¨¡å¼ | åŸå›  |
|------|------------|---------|------|
| **ç”¨æˆ·ç™»å½•ç¬¬ä¸‰æ–¹** | âœ… | `æˆæƒç æ¨¡å¼` | `æœ€å®‰å…¨ï¼Œæ ‡å‡†æµç¨‹` |
| **å®˜æ–¹APPç™»å½•** | âœ… | `æˆæƒç +PKCE` | `ç§»åŠ¨ç«¯å¢å¼ºå®‰å…¨` |
| **æœåŠ¡é—´è°ƒç”¨** | âŒ | `å®¢æˆ·ç«¯æ¨¡å¼` | `æ— éœ€ç”¨æˆ·å‚ä¸` |
| **çº¯å‰ç«¯åº”ç”¨** | âœ… | `æˆæƒç +PKCE` | `é¿å…ç®€åŒ–æ¨¡å¼` |

---

## 4. âœ… Tokenæ ¡éªŒé€»è¾‘å®ç°


### 4.1 TokenéªŒè¯æµç¨‹


**ğŸ” å®Œæ•´éªŒè¯é“¾è·¯**

```
APIè¯·æ±‚åˆ°è¾¾ç½‘å…³
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. Tokenæå–     â”‚ â† ä»è¯·æ±‚å¤´æå–token
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. æ ¼å¼éªŒè¯      â”‚ â† æ£€æŸ¥tokenæ ¼å¼
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. ç­¾åéªŒè¯      â”‚ â† éªŒè¯tokenç­¾å
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. è¿‡æœŸæ£€æŸ¥      â”‚ â† æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. æƒé™éªŒè¯      â”‚ â† æ£€æŸ¥è®¿é—®æƒé™
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. æ”¾è¡Œ/æ‹’ç»     â”‚ â† å†³ç­–ç»“æœ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 JWT TokenéªŒè¯å®ç°


**ğŸ“¦ JWTç»“æ„ç†è§£**

```
JWT = Header + Payload + Signature

å®Œæ•´Tokenç¤ºä¾‹ï¼š
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiIxMjM0IiwibmFtZSI6IuW8oOS4iSIsImV4cCI6MTYzMjgwMDAwMH0.K7Z8w3QqX5nY9pM2vL4jR6tU8sN1oE3fG9hC0dA2bW

ç»“æ„æ‹†è§£ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Headerï¼ˆå¤´éƒ¨ï¼‰- Base64ç¼–ç 
{
  "alg": "HS256",      // ç­¾åç®—æ³•
  "typ": "JWT"         // ä»¤ç‰Œç±»å‹
}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Payloadï¼ˆè½½è·ï¼‰- Base64ç¼–ç 
{
  "userId": "1234",    // ç”¨æˆ·ID
  "name": "å¼ ä¸‰",      // ç”¨æˆ·å
  "exp": 1632800000    // è¿‡æœŸæ—¶é—´æˆ³
}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Signatureï¼ˆç­¾åï¼‰- åŠ å¯†ç”Ÿæˆ
HMACSHA256(
  base64(header) + "." + base64(payload),
  secret_key
)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

**ğŸ’» Spring GatewayéªŒè¯å®ç°**

```java
@Component
public class JwtAuthenticationFilter implements GlobalFilter, Ordered {
    
    @Autowired
    private JwtUtil jwtUtil;
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, 
                             GatewayFilterChain chain) {
        
        // 1. æå–Token
        String token = extractToken(exchange.getRequest());
        
        if (token == null) {
            return unauthorized(exchange, "ç¼ºå°‘è®¤è¯ä»¤ç‰Œ");
        }
        
        try {
            // 2. è§£æå¹¶éªŒè¯Token
            Claims claims = jwtUtil.parseToken(token);
            
            // 3. æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
            if (claims.getExpiration().before(new Date())) {
                return unauthorized(exchange, "ä»¤ç‰Œå·²è¿‡æœŸ");
            }
            
            // 4. æå–ç”¨æˆ·ä¿¡æ¯å¹¶ä¼ é€’
            String userId = claims.get("userId", String.class);
            exchange.getRequest().mutate()
                .header("X-User-Id", userId)
                .build();
            
            // 5. æ”¾è¡Œè¯·æ±‚
            return chain.filter(exchange);
            
        } catch (Exception e) {
            return unauthorized(exchange, "ä»¤ç‰ŒéªŒè¯å¤±è´¥: " + e.getMessage());
        }
    }
    
    // Tokenæå–é€»è¾‘
    private String extractToken(ServerHttpRequest request) {
        String authHeader = request.getHeaders().getFirst("Authorization");
        
        if (authHeader != null && authHeader.startsWith("Bearer ")) {
            return authHeader.substring(7); // ç§»é™¤"Bearer "å‰ç¼€
        }
        
        return null;
    }
    
    // è¿”å›401æœªæˆæƒ
    private Mono<Void> unauthorized(ServerWebExchange exchange, String message) {
        exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);
        exchange.getResponse().getHeaders().add("Content-Type", "application/json");
        
        String errorJson = "{\"error\":\"" + message + "\"}";
        DataBuffer buffer = exchange.getResponse()
            .bufferFactory()
            .wrap(errorJson.getBytes());
            
        return exchange.getResponse().writeWith(Mono.just(buffer));
    }
    
    @Override
    public int getOrder() {
        return -100; // ä¼˜å…ˆçº§ï¼šåœ¨å…¶ä»–è¿‡æ»¤å™¨ä¹‹å‰æ‰§è¡Œ
    }
}
```

### 4.3 è¿œç¨‹TokenéªŒè¯


**ğŸŒ è°ƒç”¨æˆæƒæœåŠ¡å™¨éªŒè¯**

```java
@Service
public class RemoteTokenValidator {
    
    @Autowired
    private RestTemplate restTemplate;
    
    @Value("${oauth2.introspect-url}")
    private String introspectUrl;
    
    // è¿œç¨‹éªŒè¯Token
    public TokenValidationResult validateToken(String token) {
        
        // æ„å»ºéªŒè¯è¯·æ±‚
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);
        headers.setBasicAuth(clientId, clientSecret); // å®¢æˆ·ç«¯è®¤è¯
        
        MultiValueMap<String, String> body = new LinkedMultiValueMap<>();
        body.add("token", token);
        
        HttpEntity<MultiValueMap<String, String>> request = 
            new HttpEntity<>(body, headers);
        
        // è°ƒç”¨æˆæƒæœåŠ¡å™¨çš„introspectç«¯ç‚¹
        ResponseEntity<IntrospectResponse> response = restTemplate.postForEntity(
            introspectUrl,
            request,
            IntrospectResponse.class
        );
        
        IntrospectResponse result = response.getBody();
        
        // è§£æéªŒè¯ç»“æœ
        if (result != null && result.isActive()) {
            return TokenValidationResult.success(
                result.getUserId(),
                result.getScopes()
            );
        } else {
            return TokenValidationResult.failure("Tokenæ— æ•ˆæˆ–å·²è¿‡æœŸ");
        }
    }
}

// éªŒè¯å“åº”ç»“æ„
@Data
class IntrospectResponse {
    private boolean active;      // tokenæ˜¯å¦æœ‰æ•ˆ
    private String userId;       // ç”¨æˆ·ID
    private List<String> scopes; // æƒé™èŒƒå›´
    private Long exp;            // è¿‡æœŸæ—¶é—´
}
```

**âš–ï¸ JWT vs è¿œç¨‹éªŒè¯å¯¹æ¯”**

| å¯¹æ¯”é¡¹ | JWTè‡ªéªŒè¯ | è¿œç¨‹éªŒè¯ |
|-------|----------|---------|
| **æ€§èƒ½** | `âš¡ æå¿«ï¼ˆæœ¬åœ°éªŒè¯ï¼‰` | `ğŸŒ è¾ƒæ…¢ï¼ˆç½‘ç»œè°ƒç”¨ï¼‰` |
| **å®æ—¶æ€§** | `âŒ æ— æ³•å®æ—¶æ’¤é”€` | `âœ… æ”¯æŒå®æ—¶æ’¤é”€` |
| **ä¾èµ–æ€§** | `âœ… æ— å¤–éƒ¨ä¾èµ–` | `âŒ ä¾èµ–æˆæƒæœåŠ¡å™¨` |
| **Tokenå¤§å°** | `ğŸ“¦ è¾ƒå¤§ï¼ˆå«ç”¨æˆ·ä¿¡æ¯ï¼‰` | `ğŸ“„ è¾ƒå°ï¼ˆéšæœºå­—ç¬¦ä¸²ï¼‰` |
| **é€‚ç”¨åœºæ™¯** | `è¯»å¤šå†™å°‘çš„åœºæ™¯` | `éœ€è¦å®æ—¶æ§åˆ¶çš„åœºæ™¯` |

---

## 5. ğŸ›¡ï¸ æƒé™æ§åˆ¶å®ç°æ–¹æ¡ˆ


### 5.1 åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰


**ğŸ‘¥ RBACæ ¸å¿ƒæ¦‚å¿µ**

```
æƒé™æ§åˆ¶ä¸‰è¦ç´ ï¼š

ç”¨æˆ· â”€â”€æ‹¥æœ‰â”€â”€> è§’è‰² â”€â”€æ‹¥æœ‰â”€â”€> æƒé™
(User)        (Role)        (Permission)

ç¤ºä¾‹å…³ç³»ï¼š
å¼ ä¸‰ â”€â”€> ã€ç®¡ç†å‘˜ã€‘ â”€â”€> [ç”¨æˆ·ç®¡ç†, è®¢å•ç®¡ç†, ç³»ç»Ÿé…ç½®]
æå›› â”€â”€> ã€æ™®é€šç”¨æˆ·ã€‘ â”€â”€> [æŸ¥çœ‹è®¢å•, ä¸ªäººèµ„æ–™]
ç‹äº” â”€â”€> ã€è®¿å®¢ã€‘ â”€â”€> [æŸ¥çœ‹å…¬å¼€å†…å®¹]
```

**ğŸ’» ç½‘å…³å±‚æƒé™éªŒè¯**

```java
@Component
public class RbacAuthorizationFilter implements GlobalFilter, Ordered {
    
    @Autowired
    private PermissionService permissionService;
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, 
                             GatewayFilterChain chain) {
        
        // 1. è·å–å½“å‰è¯·æ±‚è·¯å¾„å’Œæ–¹æ³•
        String path = exchange.getRequest().getPath().value();
        String method = exchange.getRequest().getMethodValue();
        
        // 2. ä»Tokenä¸­æå–ç”¨æˆ·è§’è‰²
        String token = extractToken(exchange);
        List<String> userRoles = extractRoles(token);
        
        // 3. è·å–è®¿é—®è¯¥è·¯å¾„éœ€è¦çš„æƒé™
        String requiredPermission = getRequiredPermission(path, method);
        
        // 4. æ£€æŸ¥ç”¨æˆ·è§’è‰²æ˜¯å¦åŒ…å«æ‰€éœ€æƒé™
        boolean hasPermission = permissionService
            .checkPermission(userRoles, requiredPermission);
        
        if (!hasPermission) {
            return forbidden(exchange, "æ— æƒè®¿é—®è¯¥èµ„æº");
        }
        
        return chain.filter(exchange);
    }
    
    // æƒé™æ˜ å°„é…ç½®
    private String getRequiredPermission(String path, String method) {
        // è·¯å¾„æƒé™æ˜ å°„è¡¨
        Map<String, String> pathPermissions = Map.of(
            "GET:/api/users", "user:read",
            "POST:/api/users", "user:create",
            "DELETE:/api/users/*", "user:delete",
            "GET:/api/orders", "order:read"
        );
        
        String key = method + ":" + path;
        return pathPermissions.getOrDefault(key, "public:access");
    }
    
    @Override
    public int getOrder() {
        return -90; // åœ¨è®¤è¯è¿‡æ»¤å™¨ä¹‹åæ‰§è¡Œ
    }
}
```

### 5.2 åŸºäºèµ„æºçš„è®¿é—®æ§åˆ¶


**ğŸ” ç»†ç²’åº¦æƒé™æ§åˆ¶**

```
åœºæ™¯ï¼šç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„è®¢å•

ä¼ ç»ŸRBACï¼š
- ç”¨æˆ·æœ‰"æŸ¥çœ‹è®¢å•"æƒé™
- ä½†å¯èƒ½æŸ¥çœ‹åˆ°æ‰€æœ‰è®¢å• âŒ

èµ„æºçº§æ§åˆ¶ï¼š
- æ£€æŸ¥è®¢å•æ‰€æœ‰è€…æ˜¯å¦æ˜¯å½“å‰ç”¨æˆ·
- åªè¿”å›ç”¨æˆ·è‡ªå·±çš„è®¢å• âœ…
```

**ğŸ’» èµ„æºæ‰€æœ‰æƒéªŒè¯**

```java
@Component
public class ResourceOwnershipFilter implements GlobalFilter {
    
    @Autowired
    private ResourceService resourceService;
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, 
                             GatewayFilterChain chain) {
        
        String path = exchange.getRequest().getPath().value();
        
        // åŒ¹é…éœ€è¦èµ„æºæ£€æŸ¥çš„è·¯å¾„
        if (path.matches("/api/orders/\\d+")) {
            
            // æå–èµ„æºID
            String orderId = extractResourceId(path);
            
            // æå–å½“å‰ç”¨æˆ·ID
            String userId = exchange.getRequest()
                .getHeaders()
                .getFirst("X-User-Id");
            
            // æ£€æŸ¥èµ„æºå½’å±
            return resourceService.checkOwnership(orderId, userId)
                .flatMap(isOwner -> {
                    if (isOwner) {
                        return chain.filter(exchange);
                    } else {
                        return forbidden(exchange, "æ— æƒè®¿é—®è¯¥è®¢å•");
                    }
                });
        }
        
        return chain.filter(exchange);
    }
}
```

### 5.3 åŠ¨æ€æƒé™é…ç½®


**ğŸ“‹ æƒé™é…ç½®è¡¨è®¾è®¡**

```yaml
# æƒé™è·¯ç”±é…ç½®ï¼ˆapplication.ymlï¼‰
spring:
  cloud:
    gateway:
      routes:
        - id: user-service
          uri: lb://user-service
          predicates:
            - Path=/api/users/**
          metadata:
            # è·¯ç”±çº§æƒé™é…ç½®
            requiredRoles: ADMIN,MANAGER
            requiredPermissions: user:read,user:write
            
        - id: order-service
          uri: lb://order-service
          predicates:
            - Path=/api/orders/**
          metadata:
            requiredRoles: USER
            checkOwnership: true  # å¯ç”¨èµ„æºå½’å±æ£€æŸ¥
```

**ğŸ”„ æƒé™åŠ¨æ€åŠ è½½**

```java
@Service
public class DynamicPermissionService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // ä»RedisåŠ è½½æƒé™é…ç½®
    public List<String> getUserPermissions(String userId) {
        String cacheKey = "user:permissions:" + userId;
        
        // å…ˆä»ç¼“å­˜è·å–
        List<String> permissions = (List<String>) redisTemplate
            .opsForValue()
            .get(cacheKey);
        
        if (permissions == null) {
            // ç¼“å­˜æœªå‘½ä¸­ï¼Œä»æ•°æ®åº“åŠ è½½
            permissions = loadPermissionsFromDB(userId);
            
            // å†™å…¥ç¼“å­˜ï¼ˆ5åˆ†é’Ÿè¿‡æœŸï¼‰
            redisTemplate.opsForValue()
                .set(cacheKey, permissions, 5, TimeUnit.MINUTES);
        }
        
        return permissions;
    }
    
    // æƒé™å˜æ›´æ—¶åˆ·æ–°ç¼“å­˜
    public void refreshPermissions(String userId) {
        String cacheKey = "user:permissions:" + userId;
        redisTemplate.delete(cacheKey);
    }
}
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 OAuth2æ ¸å¿ƒç†è§£


```
ğŸ”¸ OAuth2æœ¬è´¨ï¼šæˆæƒæ¡†æ¶ï¼Œä¸æ˜¯è®¤è¯åè®®
ğŸ”¸ æ ¸å¿ƒæ€æƒ³ï¼šé€šè¿‡ä»¤ç‰Œä»£æ›¿å¯†ç ï¼Œå®ç°å®‰å…¨æˆæƒ
ğŸ”¸ å››å¤§è§’è‰²ï¼šèµ„æºæ‹¥æœ‰è€…ã€å®¢æˆ·ç«¯ã€æˆæƒæœåŠ¡å™¨ã€èµ„æºæœåŠ¡å™¨
ğŸ”¸ ä¸¤ç§ä»¤ç‰Œï¼šè®¿é—®ä»¤ç‰Œï¼ˆçŸ­æœŸï¼‰+ åˆ·æ–°ä»¤ç‰Œï¼ˆé•¿æœŸï¼‰
```

### 6.2 æˆæƒæ¨¡å¼é€‰æ‹©æŒ‡å—


| åº”ç”¨ç±»å‹ | æ¨èæ¨¡å¼ | æ ¸å¿ƒåŸå›  |
|---------|---------|---------|
| **ä¼ ç»ŸWebåº”ç”¨** | `æˆæƒç æ¨¡å¼` | `æœ€å®‰å…¨ï¼Œæœ‰æœåŠ¡ç«¯` |
| **å•é¡µåº”ç”¨(SPA)** | `æˆæƒç +PKCE` | `å‰ç«¯æ— æ³•ä¿å¯†secret` |
| **ç§»åŠ¨APP** | `æˆæƒç +PKCE` | `ç§»åŠ¨ç«¯å¢å¼ºå®‰å…¨` |
| **å®˜æ–¹åº”ç”¨** | `å¯†ç æ¨¡å¼ï¼ˆæ…ç”¨ï¼‰` | `é«˜åº¦å¯ä¿¡çš„ç¬¬ä¸€æ–¹` |
| **æœåŠ¡é—´è°ƒç”¨** | `å®¢æˆ·ç«¯æ¨¡å¼` | `æ— ç”¨æˆ·å‚ä¸` |
| **~~çº¯å‰ç«¯~~** | `~~ç®€åŒ–æ¨¡å¼~~` | `âŒå·²åºŸå¼ƒï¼Œä¸ä½¿ç”¨` |

### 6.3 TokenéªŒè¯è¦ç‚¹


```
éªŒè¯æ­¥éª¤ï¼š
1ï¸âƒ£ æå–Tokenï¼ˆä»Authorizationå¤´ï¼‰
2ï¸âƒ£ æ ¼å¼æ£€æŸ¥ï¼ˆBeareræ ¼å¼ï¼‰
3ï¸âƒ£ ç­¾åéªŒè¯ï¼ˆJWTç­¾åæˆ–è¿œç¨‹æ ¡éªŒï¼‰
4ï¸âƒ£ è¿‡æœŸæ£€æŸ¥ï¼ˆexpå­—æ®µï¼‰
5ï¸âƒ£ æƒé™éªŒè¯ï¼ˆscope/roleï¼‰
6ï¸âƒ£ å†³ç­–æ”¾è¡Œï¼ˆé€šè¿‡/æ‹’ç»ï¼‰

éªŒè¯æ–¹å¼å¯¹æ¯”ï¼š
âœ“ JWTè‡ªéªŒè¯ â†’ æ€§èƒ½å¥½ï¼Œæ— æ³•æ’¤é”€
âœ“ è¿œç¨‹éªŒè¯ â†’ å®æ—¶æ§åˆ¶ï¼Œæ€§èƒ½å·®
```

### 6.4 æƒé™æ§åˆ¶ç­–ç•¥


```
ä¸‰å±‚æƒé™é˜²æŠ¤ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è·¯ç”±çº§æƒé™                   â”‚ â† ç²—ç²’åº¦ï¼šè§’è‰²è®¿é—®æ§åˆ¶
â”‚  (RBAC - Role Based)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  èµ„æºçº§æƒé™                   â”‚ â† ç»†ç²’åº¦ï¼šæ‰€æœ‰æƒéªŒè¯
â”‚  (Resource Ownership)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å­—æ®µçº§æƒé™                   â”‚ â† è¶…ç»†ç²’åº¦ï¼šæ•°æ®è„±æ•
â”‚  (Field Level Security)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.5 å®æˆ˜æ³¨æ„äº‹é¡¹


```
ğŸ”’ å®‰å…¨è¦ç‚¹ï¼š
- å§‹ç»ˆä½¿ç”¨HTTPSä¼ è¾“
- Tokenå­˜å‚¨å®‰å…¨ï¼ˆä¸æ”¾LocalStorageï¼‰
- å®šæœŸè½®æ¢å¯†é’¥
- è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´
- è®°å½•å®¡è®¡æ—¥å¿—

âš¡ æ€§èƒ½ä¼˜åŒ–ï¼š
- TokenéªŒè¯ç»“æœç¼“å­˜
- æƒé™ä¿¡æ¯ç¼“å­˜
- é¿å…é¢‘ç¹è¿œç¨‹è°ƒç”¨
- ä½¿ç”¨JWTå‡å°‘ç½‘ç»œå¼€é”€

ğŸ› ï¸ å·¥ç¨‹å®è·µï¼š
- ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†
- æ¸…æ™°çš„é”™è¯¯æç¤º
- å®Œå–„çš„ç›‘æ§å‘Šè­¦
- çµæ´»çš„é…ç½®ç®¡ç†
```

**ğŸ’­ è®°å¿†å£è¯€**

```
OAuthæˆæƒä¸ä¼ å¯†ï¼Œä»¤ç‰Œæœºåˆ¶ä¿å®‰å…¨
æˆæƒç æ¨¡å¼æœ€å¯é ï¼ŒæœåŠ¡è°ƒç”¨å®¢æˆ·ç«¯
TokenéªŒè¯å…­æ­¥èµ°ï¼Œæƒé™æ§åˆ¶ä¸‰å±‚é˜²
HTTPSä¼ è¾“æ˜¯åŸºç¡€ï¼Œç¼“å­˜ä¼˜åŒ–ææ€§èƒ½
```