---
title: 3ã€Spring Securityé›†æˆ
---
## ğŸ“š ç›®å½•

1. [Spring Securityæ ¸å¿ƒæ¦‚å¿µ](#1-Spring-Securityæ ¸å¿ƒæ¦‚å¿µ)
2. [SecurityWebFilterChainé…ç½®](#2-SecurityWebFilterChainé…ç½®)
3. [ReactiveAuthenticationManagerè®¤è¯ç®¡ç†](#3-ReactiveAuthenticationManagerè®¤è¯ç®¡ç†)
4. [å¼‚å¸¸å¤„ç†æœºåˆ¶](#4-å¼‚å¸¸å¤„ç†æœºåˆ¶)
5. [è§’è‰²æƒé™æ§åˆ¶](#5-è§’è‰²æƒé™æ§åˆ¶)
6. [æ–¹æ³•çº§åˆ«æˆæƒ](#6-æ–¹æ³•çº§åˆ«æˆæƒ)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” Spring Securityæ ¸å¿ƒæ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Spring Security

ğŸ¯ **ç®€å•ç†è§£**ï¼šSpring Securityå°±åƒå°åŒºçš„é—¨ç¦ç³»ç»Ÿ

```
ç”Ÿæ´»ä¸­çš„é—¨ç¦ç³»ç»Ÿï¼š
1. èº«ä»½éªŒè¯ï¼šåˆ·é—¨ç¦å¡ç¡®è®¤ä½ æ˜¯è°ï¼ˆAuthenticationï¼‰
2. æƒé™æ£€æŸ¥ï¼šåˆ¤æ–­ä½ èƒ½è¿›å“ªäº›æ¥¼æ ‹ï¼ˆAuthorizationï¼‰
3. å¼‚å¸¸å¤„ç†ï¼šå¡æ— æ•ˆæ—¶çš„æç¤ºï¼ˆException Handlingï¼‰

Spring Securityåšçš„äº‹ï¼š
1. éªŒè¯ç”¨æˆ·èº«ä»½ï¼ˆç”¨æˆ·åå¯†ç /Tokenï¼‰
2. æ£€æŸ¥ç”¨æˆ·æƒé™ï¼ˆèƒ½è®¿é—®å“ªäº›æ¥å£ï¼‰
3. å¤„ç†å®‰å…¨å¼‚å¸¸ï¼ˆæœªç™»å½•/æ— æƒé™çš„æƒ…å†µï¼‰
```

**ğŸ”¸ Spring Securityçš„æ ¸å¿ƒä»·å€¼**
```
å®‰å…¨é˜²æŠ¤ï¼š
- é˜²æ­¢æœªæˆæƒè®¿é—®
- ä¿æŠ¤æ•æ„Ÿæ•°æ®
- é˜²èŒƒå¸¸è§æ”»å‡»ï¼ˆCSRFã€XSSç­‰ï¼‰

çµæ´»é…ç½®ï¼š
- æ”¯æŒå¤šç§è®¤è¯æ–¹å¼
- ç»†ç²’åº¦çš„æƒé™æ§åˆ¶
- å¯æ‰©å±•çš„å®‰å…¨ç­–ç•¥
```

### 1.2 å“åº”å¼å®‰å…¨ä¸ä¼ ç»Ÿå®‰å…¨çš„åŒºåˆ«

**ğŸ“Š å“åº”å¼vsä¼ ç»Ÿå¯¹æ¯”**

| ç‰¹æ€§ | **ä¼ ç»ŸSpring Security** | **å“åº”å¼Spring Security** |
|------|----------------------|------------------------|
| ğŸ”¸ **ç¼–ç¨‹æ¨¡å‹** | `ServletåŒæ­¥é˜»å¡` | `WebFluxå¼‚æ­¥éé˜»å¡` |
| ğŸ”¸ **æ ¸å¿ƒæ¥å£** | `SecurityFilterChain` | `SecurityWebFilterChain` |
| ğŸ”¸ **è®¤è¯ç®¡ç†å™¨** | `AuthenticationManager` | `ReactiveAuthenticationManager` |
| ğŸ”¸ **ä¸Šä¸‹æ–‡** | `SecurityContext` | `ReactiveSecurityContextHolder` |
| ğŸ”¸ **è¿”å›ç±»å‹** | `å¯¹è±¡/é›†åˆ` | `Mono/Flux` |

**ğŸ’¡ ä¸ºä»€ä¹ˆç½‘å…³è¦ç”¨å“åº”å¼Security**
```
ç½‘å…³çš„ç‰¹æ®Šæ€§ï¼š
- é«˜å¹¶å‘åœºæ™¯ï¼šæ¯ç§’å¤„ç†æˆåƒä¸Šä¸‡è¯·æ±‚
- ä¸èƒ½é˜»å¡ï¼šç­‰å¾…è®¤è¯ä¼šæ‹–æ…¢æ•´ä½“æ€§èƒ½
- èµ„æºæ•ˆç‡ï¼šç”¨æ›´å°‘çš„çº¿ç¨‹å¤„ç†æ›´å¤šè¯·æ±‚

å“åº”å¼çš„ä¼˜åŠ¿ï¼š
- éé˜»å¡IOï¼šè®¤è¯æ—¶ä¸å ç”¨çº¿ç¨‹
- é«˜ååé‡ï¼šå……åˆ†åˆ©ç”¨ç³»ç»Ÿèµ„æº
- å¼¹æ€§ä¼¸ç¼©ï¼šå‹åŠ›å¤§æ—¶æ€§èƒ½æ›´ç¨³å®š
```

### 1.3 æ ¸å¿ƒç»„ä»¶å…³ç³»å›¾

**ğŸ—ï¸ Spring Securityç»„ä»¶åä½œ**

```
è¯·æ±‚æµç¨‹ï¼š
å®¢æˆ·ç«¯è¯·æ±‚
    â”‚
    â–¼
SecurityWebFilterChainï¼ˆå®‰å…¨è¿‡æ»¤é“¾ï¼‰
    â”‚
    â”œâ”€â†’ è®¤è¯è¿‡æ»¤å™¨ â†’ ReactiveAuthenticationManager
    â”‚                      â”‚
    â”‚                      â”œâ”€ éªŒè¯æˆåŠŸ â†’ æ”¾è¡Œ
    â”‚                      â””â”€ éªŒè¯å¤±è´¥ â†’ ServerAuthenticationEntryPoint
    â”‚
    â”œâ”€â†’ æˆæƒè¿‡æ»¤å™¨ â†’ æƒé™æ£€æŸ¥
    â”‚                â”‚
    â”‚                â”œâ”€ æœ‰æƒé™ â†’ æ”¾è¡Œ
    â”‚                â””â”€ æ— æƒé™ â†’ ServerAccessDeniedHandler
    â”‚
    â–¼
ä¸šåŠ¡æœåŠ¡

æ ¸å¿ƒç†è§£ï¼š
- SecurityWebFilterChainï¼šå®‰å…¨æ£€æŸ¥çš„æ€»æŒ‡æŒ¥
- AuthenticationManagerï¼šä¸“é—¨è´Ÿè´£"ä½ æ˜¯è°"
- å¼‚å¸¸å¤„ç†å™¨ï¼šè´Ÿè´£"å‡ºé—®é¢˜æ€ä¹ˆåŠ"
```

---

## 2. âš™ï¸ SecurityWebFilterChainé…ç½®


### 2.1 SecurityWebFilterChainæ˜¯ä»€ä¹ˆ

ğŸ¯ **é€šä¿—ç†è§£**ï¼šå®ƒå°±æ˜¯å®‰å…¨æ£€æŸ¥çš„è§„åˆ™æ‰‹å†Œ

```
æƒ³è±¡æˆæœºåœºå®‰æ£€æµç¨‹ï¼š
1. å“ªäº›äººéœ€è¦å®‰æ£€ï¼ˆå“ªäº›URLéœ€è¦ä¿æŠ¤ï¼‰
2. å®‰æ£€æ–¹å¼æ˜¯ä»€ä¹ˆï¼ˆJWTè¿˜æ˜¯Sessionï¼‰
3. å‡ºé—®é¢˜æ€ä¹ˆåŠï¼ˆæ‹’ç»ç™»æœº/æç¤ºè¡¥ç¥¨ï¼‰

SecurityWebFilterChainå®šä¹‰ï¼š
1. å“ªäº›è·¯å¾„éœ€è¦è®¤è¯
2. ä½¿ç”¨ä»€ä¹ˆè®¤è¯æ–¹å¼
3. å¼‚å¸¸å¦‚ä½•å¤„ç†
```

### 2.2 åŸºç¡€é…ç½®ç¤ºä¾‹

**ğŸ”§ æœ€ç®€å•çš„å®‰å…¨é…ç½®**

```java
@Configuration
@EnableWebFluxSecurity  // å¼€å¯WebFluxçš„Security
public class SecurityConfig {
    
    @Bean
    public SecurityWebFilterChain securityFilterChain(ServerHttpSecurity http) {
        return http
            // 1. å®šä¹‰å“ªäº›è·¯å¾„çš„è®¿é—®è§„åˆ™
            .authorizeExchange(exchanges -> exchanges
                .pathMatchers("/login", "/public/**").permitAll()  // å…¬å¼€è·¯å¾„
                .anyExchange().authenticated()  // å…¶ä»–éƒ½éœ€è¦è®¤è¯
            )
            // 2. é…ç½®è®¤è¯æ–¹å¼
            .httpBasic(Customizer.withDefaults())  // ä½¿ç”¨HTTPåŸºç¡€è®¤è¯
            .build();
    }
}
```

**ğŸ’¡ é…ç½®è§£è¯»**
```
.authorizeExchange() 
â†’ é…ç½®URLè®¿é—®æƒé™è§„åˆ™

.pathMatchers("/login").permitAll()
â†’ åŒ¹é…/loginè·¯å¾„ï¼Œå…è®¸æ‰€æœ‰äººè®¿é—®

.anyExchange().authenticated()
â†’ å…¶ä»–æ‰€æœ‰è¯·æ±‚éƒ½éœ€è¦è®¤è¯

.httpBasic()
â†’ ä½¿ç”¨HTTP Basicè®¤è¯æ–¹å¼
```

### 2.3 JWTè®¤è¯é…ç½®

**ğŸ”‘ å®é™…é¡¹ç›®ä¸­çš„JWTé…ç½®**

```java
@Configuration
@EnableWebFluxSecurity
public class JwtSecurityConfig {
    
    @Autowired
    private JwtAuthenticationManager authenticationManager;
    
    @Autowired
    private ServerAuthenticationEntryPoint authEntryPoint;
    
    @Bean
    public SecurityWebFilterChain securityFilterChain(ServerHttpSecurity http) {
        return http
            // ç¦ç”¨CSRFï¼ˆå‰åç«¯åˆ†ç¦»ä¸éœ€è¦ï¼‰
            .csrf(csrf -> csrf.disable())
            
            // é…ç½®è®¿é—®è§„åˆ™
            .authorizeExchange(exchanges -> exchanges
                // ç™»å½•æ¥å£å…¬å¼€
                .pathMatchers("/auth/login").permitAll()
                // éœ€è¦ADMINè§’è‰²
                .pathMatchers("/admin/**").hasRole("ADMIN")
                // éœ€è¦USERè§’è‰²æˆ–ADMINè§’è‰²
                .pathMatchers("/user/**").hasAnyRole("USER", "ADMIN")
                // å…¶ä»–éœ€è¦è®¤è¯
                .anyExchange().authenticated()
            )
            
            // é…ç½®JWTè®¤è¯
            .authenticationManager(authenticationManager)
            
            // é…ç½®å¼‚å¸¸å¤„ç†
            .exceptionHandling(exceptionHandling -> 
                exceptionHandling.authenticationEntryPoint(authEntryPoint)
            )
            .build();
    }
}
```

### 2.4 è·¯å¾„åŒ¹é…è§„åˆ™è¯¦è§£

**ğŸ¯ çµæ´»çš„è·¯å¾„é…ç½®**

| åŒ¹é…æ¨¡å¼ | **è¯´æ˜** | **ç¤ºä¾‹** |
|---------|---------|---------|
| ğŸ”¸ **ç²¾ç¡®åŒ¹é…** | `å®Œå…¨åŒ¹é…è·¯å¾„` | `.pathMatchers("/login")` |
| ğŸ”¸ **é€šé…ç¬¦åŒ¹é…** | `*åŒ¹é…ä¸€çº§è·¯å¾„` | `.pathMatchers("/api/*")` åŒ¹é…/api/users |
| ğŸ”¸ **å¤šçº§é€šé…** | `**åŒ¹é…å¤šçº§è·¯å¾„` | `.pathMatchers("/api/**")` åŒ¹é…/api/users/123 |
| ğŸ”¸ **æ­£åˆ™åŒ¹é…** | `ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼` | `.pathMatchers(RegexPathMatcher("/api/\\d+"))` |
| ğŸ”¸ **HTTPæ–¹æ³•** | `é™å®šè¯·æ±‚æ–¹æ³•` | `.pathMatchers(HttpMethod.POST, "/api/**")` |

**ğŸ’¡ å®ç”¨é…ç½®ç¤ºä¾‹**
```java
.authorizeExchange(exchanges -> exchanges
    // é™æ€èµ„æºå®Œå…¨å…¬å¼€
    .pathMatchers("/static/**", "/css/**", "/js/**").permitAll()
    
    // åªå…è®¸POSTç™»å½•
    .pathMatchers(HttpMethod.POST, "/auth/login").permitAll()
    
    // APIæ¥å£éœ€è¦è®¤è¯
    .pathMatchers("/api/**").authenticated()
    
    // ç®¡ç†åå°éœ€è¦ADMINæƒé™
    .pathMatchers("/admin/**").hasAuthority("ROLE_ADMIN")
    
    // å…¶ä»–æƒ…å†µæ‹’ç»è®¿é—®
    .anyExchange().denyAll()
)
```

---

## 3. ğŸ” ReactiveAuthenticationManagerè®¤è¯ç®¡ç†


### 3.1 è®¤è¯ç®¡ç†å™¨çš„ä½œç”¨

ğŸ¯ **é€šä¿—ç†è§£**ï¼šå®ƒæ˜¯ä¸“é—¨éªŒè¯"ä½ æ˜¯è°"çš„å·¥ä½œäººå‘˜

```
é“¶è¡ŒæŸœå°åŠä¸šåŠ¡çš„åœºæ™¯ï¼š
1. ä½ å‡ºç¤ºèº«ä»½è¯ï¼ˆæäº¤å‡­è¯ï¼‰
2. æŸœå‘˜éªŒè¯çœŸä¼ªï¼ˆè®¤è¯ç®¡ç†å™¨å·¥ä½œï¼‰
3. éªŒè¯é€šè¿‡æ‰èƒ½åŠä¸šåŠ¡ï¼ˆè®¤è¯æˆåŠŸï¼‰

ReactiveAuthenticationManagerï¼š
1. æ¥æ”¶è®¤è¯å‡­è¯ï¼ˆToken/ç”¨æˆ·åå¯†ç ï¼‰
2. éªŒè¯å‡­è¯çš„çœŸå®æ€§
3. è¿”å›è®¤è¯ç»“æœï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰
```

### 3.2 JWTè®¤è¯ç®¡ç†å™¨å®ç°

**ğŸ”§ è‡ªå®šä¹‰JWTè®¤è¯é€»è¾‘**

```java
@Component
public class JwtAuthenticationManager implements ReactiveAuthenticationManager {
    
    @Autowired
    private JwtTokenProvider jwtTokenProvider;
    
    @Override
    public Mono<Authentication> authenticate(Authentication authentication) {
        // ä»Authenticationå¯¹è±¡ä¸­è·å–Token
        String token = authentication.getCredentials().toString();
        
        // éªŒè¯å¹¶è§£æToken
        return jwtTokenProvider.validateToken(token)
            .filter(valid -> valid)  // Tokenå¿…é¡»æœ‰æ•ˆ
            .flatMap(valid -> {
                // ä»Tokenä¸­æå–ç”¨æˆ·ä¿¡æ¯
                String username = jwtTokenProvider.getUsername(token);
                List<String> roles = jwtTokenProvider.getRoles(token);
                
                // æ„å»ºæƒé™åˆ—è¡¨
                Collection<GrantedAuthority> authorities = roles.stream()
                    .map(SimpleGrantedAuthority::new)
                    .collect(Collectors.toList());
                
                // åˆ›å»ºè®¤è¯å¯¹è±¡
                UsernamePasswordAuthenticationToken auth = 
                    new UsernamePasswordAuthenticationToken(
                        username,
                        null,
                        authorities
                    );
                
                return Mono.just(auth);
            })
            .switchIfEmpty(Mono.error(
                new BadCredentialsException("Invalid token")
            ));
    }
}
```

**ğŸ’¡ å…³é”®æ­¥éª¤ç†è§£**
```
æ­¥éª¤1ï¼šè·å–å‡­è¯
authentication.getCredentials() â†’ æ‹¿åˆ°JWT Token

æ­¥éª¤2ï¼šéªŒè¯Token
jwtTokenProvider.validateToken() â†’ æ£€æŸ¥Tokenæ˜¯å¦æœ‰æ•ˆ
- æ˜¯å¦è¿‡æœŸ
- ç­¾åæ˜¯å¦æ­£ç¡®
- æ ¼å¼æ˜¯å¦åˆæ³•

æ­¥éª¤3ï¼šæå–ä¿¡æ¯
- ç”¨æˆ·åï¼šç”¨äºæ ‡è¯†ç”¨æˆ·èº«ä»½
- è§’è‰²åˆ—è¡¨ï¼šç”¨äºåç»­æƒé™åˆ¤æ–­

æ­¥éª¤4ï¼šæ„å»ºAuthentication
UsernamePasswordAuthenticationToken â†’ Spring Securityè®¤è¯†çš„è®¤è¯å¯¹è±¡
- åŒ…å«ç”¨æˆ·ä¿¡æ¯
- åŒ…å«æƒé™åˆ—è¡¨
- æ ‡è®°ä¸ºå·²è®¤è¯
```

### 3.3 æ•°æ®åº“ç”¨æˆ·è®¤è¯ç®¡ç†å™¨

**ğŸ”§ åŸºäºæ•°æ®åº“çš„è®¤è¯å®ç°**

```java
@Component
public class DatabaseAuthenticationManager 
    implements ReactiveAuthenticationManager {
    
    @Autowired
    private ReactiveUserDetailsService userDetailsService;
    
    @Autowired
    private PasswordEncoder passwordEncoder;
    
    @Override
    public Mono<Authentication> authenticate(Authentication authentication) {
        String username = authentication.getName();
        String password = authentication.getCredentials().toString();
        
        return userDetailsService.findByUsername(username)
            // éªŒè¯å¯†ç 
            .filter(userDetails -> 
                passwordEncoder.matches(password, userDetails.getPassword())
            )
            // å¯†ç æ­£ç¡®ï¼Œè¿”å›è®¤è¯å¯¹è±¡
            .map(userDetails -> 
                new UsernamePasswordAuthenticationToken(
                    userDetails.getUsername(),
                    userDetails.getPassword(),
                    userDetails.getAuthorities()
                )
            )
            // å¯†ç é”™è¯¯ï¼ŒæŠ›å‡ºå¼‚å¸¸
            .switchIfEmpty(Mono.error(
                new BadCredentialsException("Invalid username or password")
            ));
    }
}
```

### 3.4 è®¤è¯æµç¨‹å®Œæ•´ç¤ºä¾‹

**ğŸ”„ ä»è¯·æ±‚åˆ°è®¤è¯çš„å®Œæ•´æµç¨‹**

```
è¯·æ±‚æµç¨‹å›¾ï¼š

1. å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚
   GET /api/users
   Header: Authorization: Bearer eyJhbGc...

2. Securityè¿‡æ»¤å™¨æ‹¦æˆª
   â†’ æå–Token
   â†’ æ„å»ºAuthenticationå¯¹è±¡

3. è°ƒç”¨ReactiveAuthenticationManager
   â†’ éªŒè¯Tokenæœ‰æ•ˆæ€§
   â†’ æå–ç”¨æˆ·ä¿¡æ¯å’Œæƒé™

4. è®¤è¯æˆåŠŸ
   â†’ å°†Authenticationå­˜å…¥SecurityContext
   â†’ ç»§ç»­æ‰§è¡Œåç»­ä¸šåŠ¡é€»è¾‘

5. è®¤è¯å¤±è´¥
   â†’ è§¦å‘ServerAuthenticationEntryPoint
   â†’ è¿”å›401 Unauthorized
```

---

## 4. ğŸš¨ å¼‚å¸¸å¤„ç†æœºåˆ¶


### 4.1 ä¸¤ç§æ ¸å¿ƒå¼‚å¸¸å¤„ç†å™¨

ğŸ¯ **é€šä¿—ç†è§£**ï¼šSecurityæœ‰ä¸¤ä¸ªä¸“é—¨çš„"å®¢æœäººå‘˜"

```
é—¨ç¦ç³»ç»Ÿçš„ç±»æ¯”ï¼š
1. æ²¡å¸¦é—¨ç¦å¡ï¼ˆæœªè®¤è¯ï¼‰â†’ ä¿å®‰æç¤º"è¯·å…ˆç™»è®°"
   å¯¹åº”ï¼šServerAuthenticationEntryPoint

2. å¡æœ‰æ•ˆä½†æ²¡æƒé™è¿›æŸåŒºåŸŸï¼ˆæœªæˆæƒï¼‰â†’ ä¿å®‰æç¤º"æ‚¨æ— æƒè¿›å…¥"
   å¯¹åº”ï¼šServerAccessDeniedHandler

åŒºåˆ«ç†è§£ï¼š
EntryPointï¼šä½ è¿˜ä¸æ˜¯"åˆæ³•ç”¨æˆ·"
AccessDeniedï¼šä½ æ˜¯ç”¨æˆ·ä½†"æƒé™ä¸å¤Ÿ"
```

### 4.2 ServerAuthenticationEntryPointå®ç°

**ğŸ”§ æœªè®¤è¯å¼‚å¸¸å¤„ç†**

```java
@Component
public class CustomAuthenticationEntryPoint 
    implements ServerAuthenticationEntryPoint {
    
    @Override
    public Mono<Void> commence(ServerWebExchange exchange, 
                               AuthenticationException ex) {
        // è®¾ç½®å“åº”çŠ¶æ€ç 
        exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);
        
        // è®¾ç½®å“åº”å¤´
        exchange.getResponse().getHeaders()
            .setContentType(MediaType.APPLICATION_JSON);
        
        // æ„å»ºé”™è¯¯å“åº”ä½“
        Map<String, Object> errorResponse = new HashMap<>();
        errorResponse.put("code", 401);
        errorResponse.put("message", "æœªè®¤è¯ï¼Œè¯·å…ˆç™»å½•");
        errorResponse.put("timestamp", System.currentTimeMillis());
        errorResponse.put("path", exchange.getRequest().getPath().value());
        
        // å†™å…¥å“åº”
        return exchange.getResponse()
            .writeWith(Mono.just(
                exchange.getResponse().bufferFactory()
                    .wrap(JSON.toJSONBytes(errorResponse))
            ));
    }
}
```

**ğŸ’¡ ä½¿ç”¨åœºæ™¯è¯´æ˜**
```
è§¦å‘åœºæ™¯ï¼š
1. è¯·æ±‚å¤´æ²¡æœ‰Token
2. Tokenæ ¼å¼ä¸æ­£ç¡®
3. Tokenå·²è¿‡æœŸ
4. Tokenç­¾åéªŒè¯å¤±è´¥

å¤„ç†æ–¹å¼ï¼š
- è¿”å›401çŠ¶æ€ç 
- æä¾›å‹å¥½çš„é”™è¯¯ä¿¡æ¯
- å¼•å¯¼ç”¨æˆ·é‡æ–°ç™»å½•
```

### 4.3 ServerAccessDeniedHandlerå®ç°

**ğŸ”§ æƒé™ä¸è¶³å¼‚å¸¸å¤„ç†**

```java
@Component
public class CustomAccessDeniedHandler 
    implements ServerAccessDeniedHandler {
    
    @Override
    public Mono<Void> handle(ServerWebExchange exchange, 
                            AccessDeniedException denied) {
        // è®¾ç½®403çŠ¶æ€ç 
        exchange.getResponse().setStatusCode(HttpStatus.FORBIDDEN);
        
        // è®¾ç½®å“åº”å¤´
        exchange.getResponse().getHeaders()
            .setContentType(MediaType.APPLICATION_JSON);
        
        // è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
        return exchange.getPrincipal()
            .flatMap(principal -> {
                Map<String, Object> errorResponse = new HashMap<>();
                errorResponse.put("code", 403);
                errorResponse.put("message", "æƒé™ä¸è¶³ï¼Œæ— æ³•è®¿é—®");
                errorResponse.put("user", principal.getName());
                errorResponse.put("requiredRole", extractRequiredRole(denied));
                errorResponse.put("timestamp", System.currentTimeMillis());
                
                return exchange.getResponse()
                    .writeWith(Mono.just(
                        exchange.getResponse().bufferFactory()
                            .wrap(JSON.toJSONBytes(errorResponse))
                    ));
            });
    }
    
    private String extractRequiredRole(AccessDeniedException denied) {
        // ä»å¼‚å¸¸ä¿¡æ¯ä¸­æå–éœ€è¦çš„è§’è‰²ï¼ˆç®€åŒ–ç¤ºä¾‹ï¼‰
        return "ADMIN";
    }
}
```

**ğŸ’¡ ä½¿ç”¨åœºæ™¯è¯´æ˜**
```
è§¦å‘åœºæ™¯ï¼š
1. ç”¨æˆ·å·²ç™»å½•ä½†è§’è‰²ä¸ç¬¦
   - æ™®é€šç”¨æˆ·è®¿é—®ç®¡ç†å‘˜æ¥å£
   
2. ç”¨æˆ·å·²ç™»å½•ä½†æƒé™ä¸å¤Ÿ
   - åªè¯»ç”¨æˆ·å°è¯•åˆ é™¤æ“ä½œ
   
3. IPé™åˆ¶
   - ç‰¹å®šIPæ‰èƒ½è®¿é—®çš„æ¥å£

å¤„ç†æ–¹å¼ï¼š
- è¿”å›403çŠ¶æ€ç 
- æ˜ç¡®å‘ŠçŸ¥æƒé™ä¸è¶³
- å¯æç¤ºæ‰€éœ€çš„å…·ä½“æƒé™
```

### 4.4 å®Œæ•´é…ç½®é›†æˆ

**ğŸ”— å°†å¼‚å¸¸å¤„ç†å™¨é›†æˆåˆ°Securityé…ç½®**

```java
@Configuration
@EnableWebFluxSecurity
public class SecurityConfig {
    
    @Autowired
    private CustomAuthenticationEntryPoint authEntryPoint;
    
    @Autowired
    private CustomAccessDeniedHandler accessDeniedHandler;
    
    @Bean
    public SecurityWebFilterChain securityFilterChain(ServerHttpSecurity http) {
        return http
            .authorizeExchange(exchanges -> exchanges
                .pathMatchers("/public/**").permitAll()
                .anyExchange().authenticated()
            )
            .exceptionHandling(exceptionHandling -> exceptionHandling
                // æœªè®¤è¯å¼‚å¸¸å¤„ç†
                .authenticationEntryPoint(authEntryPoint)
                // æƒé™ä¸è¶³å¼‚å¸¸å¤„ç†
                .accessDeniedHandler(accessDeniedHandler)
            )
            .build();
    }
}
```

---

## 5. ğŸ‘¥ è§’è‰²æƒé™æ§åˆ¶


### 5.1 è§’è‰²ä¸æƒé™çš„åŒºåˆ«

ğŸ¯ **é€šä¿—ç†è§£**ï¼šè§’è‰²æ˜¯"å²—ä½"ï¼Œæƒé™æ˜¯"èƒ½åšçš„äº‹"

```
å…¬å¸ç®¡ç†çš„ç±»æ¯”ï¼š
è§’è‰²ï¼ˆRoleï¼‰ï¼š
- æ€»ç»ç†ã€éƒ¨é—¨ç»ç†ã€å‘˜å·¥
- æ˜¯ä¸€ä¸ªèº«ä»½æ ‡ç­¾

æƒé™ï¼ˆAuthorityï¼‰ï¼š
- å®¡æ‰¹æƒã€æŸ¥çœ‹æƒã€ç¼–è¾‘æƒ
- æ˜¯å…·ä½“çš„æ“ä½œè®¸å¯

å…³ç³»ï¼š
- ä¸€ä¸ªè§’è‰²åŒ…å«å¤šä¸ªæƒé™
- ä¸€ä¸ªäººå¯ä»¥æœ‰å¤šä¸ªè§’è‰²

Spring Securityä¸­ï¼š
- è§’è‰²é€šå¸¸ä»¥ROLE_å¼€å¤´ï¼šROLE_ADMIN
- æƒé™æ˜¯å…·ä½“æ“ä½œï¼šuser:read, user:write
```

### 5.2 åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶

**ğŸ”§ é…ç½®è§’è‰²è®¿é—®è§„åˆ™**

```java
@Bean
public SecurityWebFilterChain securityFilterChain(ServerHttpSecurity http) {
    return http
        .authorizeExchange(exchanges -> exchanges
            // æ–¹å¼1ï¼šhasRole - è¦æ±‚ç‰¹å®šè§’è‰²
            .pathMatchers("/admin/**").hasRole("ADMIN")
            // å†…éƒ¨ä¼šè‡ªåŠ¨åŠ ä¸ŠROLE_å‰ç¼€ï¼ŒåŒ¹é…ROLE_ADMIN
            
            // æ–¹å¼2ï¼šhasAnyRole - æ»¡è¶³ä»»ä¸€è§’è‰²å³å¯
            .pathMatchers("/user/**").hasAnyRole("USER", "ADMIN")
            // ç”¨æˆ·æ˜¯USERæˆ–ADMINéƒ½å¯ä»¥è®¿é—®
            
            // æ–¹å¼3ï¼šhasAuthority - ç²¾ç¡®åŒ¹é…æƒé™
            .pathMatchers("/api/delete/**")
                .hasAuthority("ROLE_ADMIN")
            
            // æ–¹å¼4ï¼šhasAnyAuthority - æ»¡è¶³ä»»ä¸€æƒé™
            .pathMatchers("/api/read/**")
                .hasAnyAuthority("user:read", "admin:read")
                
            .anyExchange().authenticated()
        )
        .build();
}
```

**ğŸ’¡ è§’è‰²é…ç½®æœ€ä½³å®è·µ**
```
URLå±‚çº§è®¾è®¡ï¼š
/public/**     â†’ å®Œå…¨å…¬å¼€
/auth/**       â†’ è®¤è¯ç›¸å…³ï¼ˆç™»å½•æ³¨å†Œï¼‰
/api/user/**   â†’ æ™®é€šç”¨æˆ·æ¥å£
/api/admin/**  â†’ ç®¡ç†å‘˜æ¥å£
/api/super/**  â†’ è¶…çº§ç®¡ç†å‘˜æ¥å£

è§’è‰²åˆ†é…ç­–ç•¥ï¼š
1. æœ€å°æƒé™åŸåˆ™
   - é»˜è®¤ç»™æœ€åŸºç¡€çš„è§’è‰²
   - éœ€è¦æ—¶å†å‡çº§æƒé™

2. èŒè´£åˆ†ç¦»
   - è¯»æ“ä½œè§’è‰²ï¼šUSER
   - å†™æ“ä½œè§’è‰²ï¼šEDITOR
   - ç®¡ç†è§’è‰²ï¼šADMIN

3. ä¸´æ—¶æƒé™
   - ç‰¹æ®Šæƒ…å†µä¸´æ—¶æˆæƒ
   - è®¾ç½®è¿‡æœŸæ—¶é—´
```

### 5.3 åŠ¨æ€æƒé™åˆ¤æ–­

**ğŸ¨ å¤æ‚åœºæ™¯çš„æƒé™æ§åˆ¶**

```java
@Bean
public SecurityWebFilterChain securityFilterChain(ServerHttpSecurity http) {
    return http
        .authorizeExchange(exchanges -> exchanges
            // ä½¿ç”¨SpELè¡¨è¾¾å¼è¿›è¡Œå¤æ‚åˆ¤æ–­
            .pathMatchers("/api/user/{id}/**")
                .access((authentication, context) -> {
                    // è·å–è·¯å¾„å‚æ•°ä¸­çš„ç”¨æˆ·ID
                    String pathUserId = context.getVariables()
                        .get("id").toString();
                    
                    // åˆ¤æ–­ï¼šæ˜¯æœ¬äººæˆ–è€…æ˜¯ç®¡ç†å‘˜
                    return authentication
                        .map(auth -> {
                            // å½“å‰ç”¨æˆ·ID
                            String currentUserId = auth.getName();
                            // æ˜¯å¦ä¸ºç®¡ç†å‘˜
                            boolean isAdmin = auth.getAuthorities().stream()
                                .anyMatch(a -> 
                                    a.getAuthority().equals("ROLE_ADMIN")
                                );
                            
                            // æœ¬äººæˆ–ç®¡ç†å‘˜éƒ½å¯ä»¥è®¿é—®
                            return currentUserId.equals(pathUserId) || isAdmin;
                        })
                        .map(AuthorizationDecision::new);
                })
                
            .anyExchange().authenticated()
        )
        .build();
}
```

**ğŸ’¡ åŠ¨æ€æƒé™åº”ç”¨åœºæ™¯**
```
åœºæ™¯1ï¼šèµ„æºæ‰€æœ‰æƒåˆ¤æ–­
- ç”¨æˆ·åªèƒ½ç¼–è¾‘è‡ªå·±çš„æ–‡ç« 
- ç®¡ç†å‘˜å¯ä»¥ç¼–è¾‘æ‰€æœ‰æ–‡ç« 

åœºæ™¯2ï¼šæ—¶é—´é™åˆ¶
- å·¥ä½œæ—¶é—´æ‰èƒ½è®¿é—®æŸäº›æ¥å£
- ä¿ƒé”€æœŸé—´å¼€æ”¾ç‰¹å®šåŠŸèƒ½

åœºæ™¯3ï¼šIPé™åˆ¶
- å†…ç½‘IPå¯ä»¥è®¿é—®ç®¡ç†æ¥å£
- å¤–ç½‘IPåªèƒ½è®¿é—®å…¬å¼€æ¥å£

åœºæ™¯4ï¼šé…é¢é™åˆ¶
- æ™®é€šç”¨æˆ·æ¯å¤©100æ¬¡è¯·æ±‚
- VIPç”¨æˆ·æ¯å¤©1000æ¬¡è¯·æ±‚
```

### 5.4 æƒé™æ•°æ®æ¨¡å‹

**ğŸ—‚ï¸ ç”¨æˆ·-è§’è‰²-æƒé™æ•°æ®ç»“æ„**

```
æ•°æ®åº“è®¾è®¡ç¤ºä¾‹ï¼š

ç”¨æˆ·è¡¨ (user)
â”œâ”€ id: ç”¨æˆ·ID
â”œâ”€ username: ç”¨æˆ·å
â””â”€ password: å¯†ç 

è§’è‰²è¡¨ (role)
â”œâ”€ id: è§’è‰²ID
â”œâ”€ name: è§’è‰²åç§°ï¼ˆROLE_ADMINï¼‰
â””â”€ description: è§’è‰²æè¿°

æƒé™è¡¨ (permission)
â”œâ”€ id: æƒé™ID
â”œâ”€ name: æƒé™åç§°ï¼ˆuser:readï¼‰
â””â”€ description: æƒé™æè¿°

ç”¨æˆ·-è§’è‰²å…³è” (user_role)
â”œâ”€ user_id
â””â”€ role_id

è§’è‰²-æƒé™å…³è” (role_permission)
â”œâ”€ role_id
â””â”€ permission_id

å…³ç³»ç†è§£ï¼š
ç”¨æˆ· â”€â”€å¤šå¯¹å¤šâ”€â”€ è§’è‰² â”€â”€å¤šå¯¹å¤šâ”€â”€ æƒé™
ä¸€ä¸ªç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªè§’è‰²
ä¸€ä¸ªè§’è‰²å¯ä»¥æœ‰å¤šä¸ªæƒé™
```

---

## 6. ğŸ¯ æ–¹æ³•çº§åˆ«æˆæƒ


### 6.1 ä¸ºä»€ä¹ˆéœ€è¦æ–¹æ³•çº§æˆæƒ

ğŸ¯ **é€šä¿—ç†è§£**ï¼šURLæ§åˆ¶æ˜¯"å¤§é—¨"ï¼Œæ–¹æ³•æ§åˆ¶æ˜¯"æˆ¿é—´é—¨"

```
åˆ†å±‚é˜²æŠ¤çš„æ¦‚å¿µï¼š
ç¬¬ä¸€å±‚ï¼šURLè·¯å¾„æ§åˆ¶
- æ‹¦æˆªåœ¨Controllerå±‚
- ç²—ç²’åº¦æ§åˆ¶ï¼ˆæ•´ä¸ªè·¯å¾„ï¼‰

ç¬¬äºŒå±‚ï¼šæ–¹æ³•çº§æˆæƒ
- æ§åˆ¶åˆ°å…·ä½“æ–¹æ³•
- ç»†ç²’åº¦æ§åˆ¶ï¼ˆå•ä¸ªæ“ä½œï¼‰

ä¸ºä»€ä¹ˆéœ€è¦ä¸¤å±‚ï¼š
1. é˜²æ­¢ç»•è¿‡ï¼šæœ‰äººå¯èƒ½ç›´æ¥è°ƒç”¨æ–¹æ³•
2. ç²¾ç¡®æ§åˆ¶ï¼šåŒä¸€URLä¸åŒæ“ä½œä¸åŒæƒé™
3. ä¸šåŠ¡é€»è¾‘ï¼šåŸºäºä¸šåŠ¡è§„åˆ™çš„å¤æ‚åˆ¤æ–­
```

### 6.2 å¯ç”¨æ–¹æ³•çº§å®‰å…¨

**ğŸ”§ å¼€å¯æ–¹æ³•çº§æˆæƒåŠŸèƒ½**

```java
@Configuration
@EnableReactiveMethodSecurity  // å¯ç”¨å“åº”å¼æ–¹æ³•å®‰å…¨
public class MethodSecurityConfig {
    // é…ç½®ç±»å¯ä»¥ä¸ºç©ºï¼Œæ³¨è§£å·²ç»å¯ç”¨äº†åŠŸèƒ½
}
```

### 6.3 å¸¸ç”¨æ–¹æ³•å®‰å…¨æ³¨è§£

**ğŸ”– å››ç§æ ¸å¿ƒæ³¨è§£è¯¦è§£**

**@PreAuthorize - æ–¹æ³•æ‰§è¡Œå‰åˆ¤æ–­**
```java
@RestController
@RequestMapping("/api/users")
public class UserController {
    
    // è¦æ±‚ADMINè§’è‰²
    @PreAuthorize("hasRole('ADMIN')")
    @DeleteMapping("/{id}")
    public Mono<Void> deleteUser(@PathVariable String id) {
        return userService.deleteUser(id);
    }
    
    // è¦æ±‚æ˜¯æœ¬äººæˆ–ç®¡ç†å‘˜
    @PreAuthorize("authentication.name == #username or hasRole('ADMIN')")
    @GetMapping("/{username}/profile")
    public Mono<UserProfile> getUserProfile(@PathVariable String username) {
        return userService.getProfile(username);
    }
    
    // è¦æ±‚ç‰¹å®šæƒé™
    @PreAuthorize("hasAuthority('user:write')")
    @PutMapping("/{id}")
    public Mono<User> updateUser(@PathVariable String id, 
                                  @RequestBody User user) {
        return userService.updateUser(id, user);
    }
}
```

**@PostAuthorize - æ–¹æ³•æ‰§è¡Œååˆ¤æ–­**
```java
@RestController
@RequestMapping("/api/articles")
public class ArticleController {
    
    // åªèƒ½æŸ¥çœ‹è‡ªå·±çš„æ–‡ç« æˆ–å…¬å¼€æ–‡ç« 
    @PostAuthorize("returnObject.authorId == authentication.name or returnObject.isPublic")
    @GetMapping("/{id}")
    public Mono<Article> getArticle(@PathVariable String id) {
        return articleService.findById(id);
    }
    
    // æ‰§è¡Œåæ£€æŸ¥è¿”å›å€¼
    @PostAuthorize("returnObject.level <= principal.maxLevel")
    @GetMapping("/secret/{id}")
    public Mono<SecretDocument> getDocument(@PathVariable String id) {
        return documentService.findById(id);
    }
}
```

**ğŸ’¡ æ³¨è§£å¯¹æ¯”ç†è§£**

| æ³¨è§£ | **æ‰§è¡Œæ—¶æœº** | **é€‚ç”¨åœºæ™¯** | **ç¤ºä¾‹** |
|------|------------|------------|---------|
| ğŸ”¸ **@PreAuthorize** | `æ–¹æ³•æ‰§è¡Œå‰` | `æƒé™æ£€æŸ¥ã€è§’è‰²åˆ¤æ–­` | `åˆ é™¤ç”¨æˆ·å‰æ£€æŸ¥æ˜¯å¦ä¸ºç®¡ç†å‘˜` |
| ğŸ”¸ **@PostAuthorize** | `æ–¹æ³•æ‰§è¡Œå` | `åŸºäºè¿”å›å€¼åˆ¤æ–­` | `æŸ¥çœ‹æ–‡ç« ååˆ¤æ–­æ˜¯å¦ä¸ºä½œè€…` |
| ğŸ”¸ **@Secured** | `æ–¹æ³•æ‰§è¡Œå‰` | `ç®€å•è§’è‰²æ£€æŸ¥` | `ä»…æ”¯æŒè§’è‰²åˆ¤æ–­ï¼Œä¸æ”¯æŒSpEL` |
| ğŸ”¸ **@RolesAllowed** | `æ–¹æ³•æ‰§è¡Œå‰` | `JSR-250æ ‡å‡†` | `æ ‡å‡†æ³¨è§£ï¼Œå…¼å®¹æ€§å¥½` |

### 6.4 SpELè¡¨è¾¾å¼è¯¦è§£

**ğŸ¨ çµæ´»çš„æƒé™è¡¨è¾¾å¼**

```java
@RestController
@RequestMapping("/api/orders")
public class OrderController {
    
    // ç¤ºä¾‹1ï¼šåŸºç¡€è§’è‰²åˆ¤æ–­
    @PreAuthorize("hasRole('ADMIN')")
    public Mono<List<Order>> getAllOrders() { }
    
    // ç¤ºä¾‹2ï¼šå¤šè§’è‰²åˆ¤æ–­ï¼ˆæˆ–å…³ç³»ï¼‰
    @PreAuthorize("hasAnyRole('ADMIN', 'MANAGER')")
    public Mono<Order> approveOrder() { }
    
    // ç¤ºä¾‹3ï¼šå‚æ•°åˆ¤æ–­
    @PreAuthorize("#userId == authentication.name")
    public Mono<Order> getMyOrder(@PathVariable String userId) { }
    
    // ç¤ºä¾‹4ï¼šå¯¹è±¡å±æ€§åˆ¤æ–­
    @PreAuthorize("#order.userId == authentication.name or hasRole('ADMIN')")
    public Mono<Order> updateOrder(@RequestBody Order order) { }
    
    // ç¤ºä¾‹5ï¼šè‡ªå®šä¹‰æ–¹æ³•è°ƒç”¨
    @PreAuthorize("@orderSecurityService.canAccess(#orderId, authentication)")
    public Mono<Order> viewOrder(@PathVariable String orderId) { }
    
    // ç¤ºä¾‹6ï¼šå¤æ‚é€»è¾‘ç»„åˆ
    @PreAuthorize(
        "hasRole('ADMIN') or " +
        "(hasRole('USER') and #order.amount < 1000) or " +
        "@orderSecurityService.isVip(authentication.name)"
    )
    public Mono<Order> createOrder(@RequestBody Order order) { }
}
```

**ğŸ’¡ SpELå¸¸ç”¨è¡¨è¾¾å¼**
```
æƒé™åˆ¤æ–­ï¼š
hasRole('ADMIN')           - æ˜¯å¦æœ‰ADMINè§’è‰²
hasAnyRole('USER','VIP')   - æ˜¯å¦æœ‰ä»»ä¸€è§’è‰²
hasAuthority('user:read')  - æ˜¯å¦æœ‰ç‰¹å®šæƒé™
hasAnyAuthority('a','b')   - æ˜¯å¦æœ‰ä»»ä¸€æƒé™

ç”¨æˆ·ä¿¡æ¯ï¼š
authentication.name        - å½“å‰ç”¨æˆ·å
principal.userId          - ç”¨æˆ·ID
principal.å±æ€§             - ç”¨æˆ·å¯¹è±¡çš„å±æ€§

å‚æ•°å¼•ç”¨ï¼š
#å‚æ•°å                    - å¼•ç”¨æ–¹æ³•å‚æ•°
#å‚æ•°å.å±æ€§               - å‚æ•°å¯¹è±¡çš„å±æ€§

è‡ªå®šä¹‰åˆ¤æ–­ï¼š
@beanName.methodName()     - è°ƒç”¨è‡ªå®šä¹‰Beanæ–¹æ³•

é€»è¾‘è¿ç®—ï¼š
and, or, not              - é€»è¾‘ä¸ã€æˆ–ã€é
```

### 6.5 è‡ªå®šä¹‰æƒé™åˆ¤æ–­æœåŠ¡

**ğŸ”§ å°è£…å¤æ‚çš„æƒé™é€»è¾‘**

```java
@Service("orderSecurityService")
public class OrderSecurityService {
    
    @Autowired
    private OrderRepository orderRepository;
    
    @Autowired
    private UserService userService;
    
    // åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å¯ä»¥è®¿é—®è®¢å•
    public Mono<Boolean> canAccess(String orderId, Authentication auth) {
        String currentUserId = auth.getName();
        
        return orderRepository.findById(orderId)
            .flatMap(order -> {
                // æ˜¯è®¢å•æ‰€æœ‰è€…
                if (order.getUserId().equals(currentUserId)) {
                    return Mono.just(true);
                }
                
                // æ˜¯ç®¡ç†å‘˜
                boolean isAdmin = auth.getAuthorities().stream()
                    .anyMatch(a -> a.getAuthority().equals("ROLE_ADMIN"));
                if (isAdmin) {
                    return Mono.just(true);
                }
                
                // æ˜¯å®¢æœä¸”è®¢å•éœ€è¦å¤„ç†
                return hasCustomerServiceRole(auth)
                    .filter(hasRole -> hasRole && order.needsSupport())
                    .map(result -> true)
                    .defaultIfEmpty(false);
            })
            .defaultIfEmpty(false);
    }
    
    // åˆ¤æ–­æ˜¯å¦ä¸ºVIPç”¨æˆ·
    public Mono<Boolean> isVip(String username) {
        return userService.findByUsername(username)
            .map(user -> "VIP".equals(user.getMemberLevel()))
            .defaultIfEmpty(false);
    }
    
    // åˆ¤æ–­æ˜¯å¦æœ‰å®¢æœè§’è‰²
    private Mono<Boolean> hasCustomerServiceRole(Authentication auth) {
        return Mono.just(
            auth.getAuthorities().stream()
                .anyMatch(a -> a.getAuthority().equals("ROLE_CUSTOMER_SERVICE"))
        );
    }
}
```

**ğŸ’¡ ä½¿ç”¨è‡ªå®šä¹‰æœåŠ¡**
```java
@RestController
public class OrderController {
    
    // åœ¨æ³¨è§£ä¸­ä½¿ç”¨è‡ªå®šä¹‰åˆ¤æ–­æœåŠ¡
    @PreAuthorize("@orderSecurityService.canAccess(#orderId, authentication)")
    @GetMapping("/orders/{orderId}")
    public Mono<Order> getOrder(@PathVariable String orderId) {
        return orderService.findById(orderId);
    }
    
    // ç»„åˆä½¿ç”¨
    @PreAuthorize(
        "hasRole('ADMIN') or " +
        "@orderSecurityService.isVip(authentication.name)"
    )
    @PostMapping("/orders/express")
    public Mono<Order> createExpressOrder(@RequestBody Order order) {
        return orderService.createExpressOrder(order);
    }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Spring Securityæœ¬è´¨ï¼šæä¾›è®¤è¯å’Œæˆæƒçš„å®‰å…¨æ¡†æ¶
ğŸ”¸ å“åº”å¼ç‰¹æ€§ï¼šWebFluxç¯å¢ƒä¸‹çš„éé˜»å¡å®‰å…¨æ§åˆ¶
ğŸ”¸ SecurityWebFilterChainï¼šå®šä¹‰å®‰å…¨è§„åˆ™çš„é…ç½®ä¸­å¿ƒ
ğŸ”¸ ReactiveAuthenticationManagerï¼šè´Ÿè´£éªŒè¯ç”¨æˆ·èº«ä»½
ğŸ”¸ å¼‚å¸¸å¤„ç†å™¨ï¼šå¤„ç†è®¤è¯å¤±è´¥å’Œæƒé™ä¸è¶³
ğŸ”¸ è§’è‰²æƒé™ï¼šåŸºäºè§’è‰²å’Œæƒé™çš„è®¿é—®æ§åˆ¶
ğŸ”¸ æ–¹æ³•çº§æˆæƒï¼šç»†ç²’åº¦çš„å®‰å…¨æ§åˆ¶
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ è®¤è¯ä¸æˆæƒçš„åŒºåˆ«**
```
è®¤è¯ï¼ˆAuthenticationï¼‰ï¼š
- å›ç­”"ä½ æ˜¯è°"çš„é—®é¢˜
- éªŒè¯ç”¨æˆ·èº«ä»½çš„çœŸå®æ€§
- å¸¸è§æ–¹å¼ï¼šç”¨æˆ·åå¯†ç ã€JWTã€OAuth

æˆæƒï¼ˆAuthorizationï¼‰ï¼š
- å›ç­”"ä½ èƒ½åšä»€ä¹ˆ"çš„é—®é¢˜
- éªŒè¯ç”¨æˆ·çš„æ“ä½œæƒé™
- å¸¸è§æ–¹å¼ï¼šè§’è‰²æ§åˆ¶ã€æƒé™æ£€æŸ¥

å…³ç³»ï¼šå…ˆè®¤è¯åæˆæƒ
- å¿…é¡»å…ˆçŸ¥é“ä½ æ˜¯è°
- æ‰èƒ½åˆ¤æ–­ä½ èƒ½åšä»€ä¹ˆ
```

**ğŸ”¹ å“åº”å¼Securityçš„ä¼˜åŠ¿**
```
ä¼ ç»ŸSecurityçš„é—®é¢˜ï¼š
- æ¯ä¸ªè¯·æ±‚å ç”¨ä¸€ä¸ªçº¿ç¨‹
- é˜»å¡ç­‰å¾…è®¤è¯ç»“æœ
- é«˜å¹¶å‘æ—¶çº¿ç¨‹èµ„æºç´§å¼ 

å“åº”å¼Securityçš„æ”¹è¿›ï¼š
- éé˜»å¡å¼‚æ­¥å¤„ç†
- æ›´å°‘çš„çº¿ç¨‹å¤„ç†æ›´å¤šè¯·æ±‚
- ç½‘å…³åœºæ™¯æ€§èƒ½æ›´ä¼˜

é€‚ç”¨åœºæ™¯ï¼š
- APIç½‘å…³ï¼ˆæœ¬è¯¾ç¨‹åœºæ™¯ï¼‰
- é«˜å¹¶å‘å¾®æœåŠ¡
- å®æ—¶æ•°æ®å¤„ç†
```

**ğŸ”¹ URLæ§åˆ¶vsæ–¹æ³•æ§åˆ¶**
```
URLçº§åˆ«æ§åˆ¶ï¼š
- ç²—ç²’åº¦ï¼Œæ§åˆ¶æ•´ä¸ªè·¯å¾„
- åœ¨Securityé…ç½®ä¸­å®šä¹‰
- é€‚åˆé€šç”¨æƒé™è§„åˆ™

æ–¹æ³•çº§åˆ«æ§åˆ¶ï¼š
- ç»†ç²’åº¦ï¼Œæ§åˆ¶åˆ°å…·ä½“æ–¹æ³•
- ä½¿ç”¨æ³¨è§£å®šä¹‰
- é€‚åˆå¤æ‚ä¸šåŠ¡é€»è¾‘

æœ€ä½³å®è·µï¼š
- URLæ§åˆ¶åŸºç¡€æƒé™ï¼ˆå¤§é—¨ï¼‰
- æ–¹æ³•æ§åˆ¶ç²¾ç»†æƒé™ï¼ˆæˆ¿é—´é—¨ï¼‰
- ä¸¤å±‚é˜²æŠ¤æ›´å®‰å…¨
```

### 7.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ å®é™…é¡¹ç›®åº”ç”¨åœºæ™¯**
- **ç”µå•†å¹³å°**ï¼šæ™®é€šç”¨æˆ·æµè§ˆå•†å“ï¼ŒVIPç”¨æˆ·äº«å—ç‰¹æƒï¼Œç®¡ç†å‘˜ç®¡ç†ç³»ç»Ÿ
- **å†…å®¹å¹³å°**ï¼šæ¸¸å®¢æŸ¥çœ‹å…¬å¼€å†…å®¹ï¼Œæ³¨å†Œç”¨æˆ·å‘è¡¨è¯„è®ºï¼Œä½œè€…ç®¡ç†æ–‡ç« 
- **ä¼ä¸šç³»ç»Ÿ**ï¼šå‘˜å·¥æŸ¥çœ‹æ•°æ®ï¼Œä¸»ç®¡å®¡æ‰¹æµç¨‹ï¼Œç®¡ç†å‘˜ç³»ç»Ÿé…ç½®
- **é‡‘èåº”ç”¨**ï¼šå®¢æˆ·æŸ¥è¯¢è´¦æˆ·ï¼ŒæŸœå‘˜åŠç†ä¸šåŠ¡ï¼Œé£æ§äººå‘˜ç›‘æ§å¼‚å¸¸

**ğŸ”§ å¼€å‘å®è·µå»ºè®®**
- **å®‰å…¨ä¼˜å…ˆ**ï¼šè®¾è®¡ä¹‹åˆå°±è€ƒè™‘å®‰å…¨æ§åˆ¶ï¼Œä¸è¦äº‹åè¡¥æ•‘
- **æœ€å°æƒé™**ï¼šé»˜è®¤æ‹’ç»ï¼ŒæŒ‰éœ€æˆæƒï¼Œéµå¾ªæœ€å°æƒé™åŸåˆ™
- **åˆ†å±‚é˜²æŠ¤**ï¼šURL + æ–¹æ³•åŒé‡æ§åˆ¶ï¼Œçºµæ·±é˜²å¾¡
- **å¼‚å¸¸å‹å¥½**ï¼šæä¾›æ¸…æ™°çš„é”™è¯¯æç¤ºï¼Œå¼•å¯¼ç”¨æˆ·æ­£ç¡®æ“ä½œ
- **æµ‹è¯•è¦†ç›–**ï¼šç¼–å†™å®‰å…¨æµ‹è¯•ç”¨ä¾‹ï¼Œè¦†ç›–å„ç§æƒé™åœºæ™¯

**ğŸ“ˆ è¿›é˜¶å­¦ä¹ æ–¹å‘**
- **OAuth2.0é›†æˆ**ï¼šç¬¬ä¸‰æ–¹ç™»å½•ã€ç»Ÿä¸€è®¤è¯ä¸­å¿ƒ
- **åŠ¨æ€æƒé™**ï¼šåŸºäºæ•°æ®åº“çš„æƒé™é…ç½®ç³»ç»Ÿ
- **å®‰å…¨å®¡è®¡**ï¼šè®°å½•æ‰€æœ‰å®‰å…¨ç›¸å…³æ“ä½œæ—¥å¿—
- **å¤šå› ç´ è®¤è¯**ï¼šæ‰‹æœºéªŒè¯ç ã€é‚®ç®±éªŒè¯ç­‰
- **ä¼šè¯ç®¡ç†**ï¼šåˆ†å¸ƒå¼Sessionã€Tokenåˆ·æ–°ç­–ç•¥

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- Securityå®ˆæŠ¤å¾®æœåŠ¡ï¼Œè®¤è¯æˆæƒåŒä¿é™©
- FilterChainå®šè§„åˆ™ï¼ŒManageréªŒèº«ä»½
- å¼‚å¸¸å¤„ç†è¦å‹å¥½ï¼Œè§’è‰²æƒé™åˆ†å¾—æ¸…
- æ–¹æ³•æ³¨è§£ç»†æ§åˆ¶ï¼ŒSpELè¡¨è¾¾å¼çµæ´»ç”¨