---
title: 2ã€Nettyå‚æ•°è°ƒä¼˜
---
## ğŸ“š ç›®å½•

1. [Nettyè°ƒä¼˜åŸºç¡€è®¤çŸ¥](#1-nettyè°ƒä¼˜åŸºç¡€è®¤çŸ¥)
2. [Bossçº¿ç¨‹æ± é…ç½®](#2-bossçº¿ç¨‹æ± é…ç½®)
3. [Workerçº¿ç¨‹æ± é…ç½®](#3-workerçº¿ç¨‹æ± é…ç½®)
4. [ChannelOptionå‚æ•°è¯¦è§£](#4-channeloptionå‚æ•°è¯¦è§£)
5. [ByteBufå†…å­˜ç®¡ç†](#5-bytebufå†…å­˜ç®¡ç†)
6. [EventLoopä¼˜åŒ–ç­–ç•¥](#6-eventloopä¼˜åŒ–ç­–ç•¥)
7. [ç½‘ç»œIOä¼˜åŒ–æŠ€å·§](#7-ç½‘ç»œioä¼˜åŒ–æŠ€å·§)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ Nettyè°ƒä¼˜åŸºç¡€è®¤çŸ¥


### 1.1 ä»€ä¹ˆæ˜¯Nettyè°ƒä¼˜


**é€šä¿—ç†è§£**ï¼šå°±åƒæ±½è½¦éœ€è¦è°ƒæ ¡æ‰èƒ½è·‘å¾—æ›´å¿«æ›´ç¨³ï¼ŒNettyä¹Ÿéœ€è¦è°ƒä¼˜æ‰èƒ½å‘æŒ¥æœ€ä½³æ€§èƒ½ã€‚

```
æ—¥å¸¸ç±»æ¯”ï¼š
ğŸï¸ åŸå‚æ±½è½¦ â†’ é»˜è®¤Nettyé…ç½®ï¼ˆèƒ½ç”¨ä½†ä¸æ˜¯æœ€ä¼˜ï¼‰
ğŸ”§ ä¸“ä¸šè°ƒæ ¡ â†’ Nettyè°ƒä¼˜ï¼ˆæ ¹æ®å®é™…æƒ…å†µä¼˜åŒ–ï¼‰
ğŸ èµ›é“è¡¨ç° â†’ é«˜å¹¶å‘åœºæ™¯ä¸‹çš„æ€§èƒ½

è°ƒä¼˜å°±æ˜¯ï¼šæ‰¾åˆ°æœ€é€‚åˆä½ ä¸šåŠ¡åœºæ™¯çš„å‚æ•°é…ç½®
```

**æ ¸å¿ƒç›®æ ‡**ï¼š
- âš¡ **æå‡ååé‡**ï¼šå•ä½æ—¶é—´å¤„ç†æ›´å¤šè¯·æ±‚
- ğŸ¯ **é™ä½å»¶è¿Ÿ**ï¼šè¯·æ±‚å“åº”æ›´å¿«
- ğŸ’° **èŠ‚çœèµ„æº**ï¼šç”¨æ›´å°‘çš„CPUå’Œå†…å­˜å®Œæˆä»»åŠ¡
- ğŸ›¡ï¸ **å¢å¼ºç¨³å®šæ€§**ï¼šé«˜è´Ÿè½½ä¸‹ä¹Ÿèƒ½ç¨³å®šè¿è¡Œ

### 1.2 Nettyçš„å·¥ä½œåŸç†ç®€å›¾


```
å®¢æˆ·ç«¯è¯·æ±‚æµç¨‹ï¼š
                                
å®¢æˆ·ç«¯          ç½‘ç»œ          Bossçº¿ç¨‹         Workerçº¿ç¨‹         ä¸šåŠ¡Handler
  |              |              |                |                  |
  |--è¯·æ±‚æ•°æ®---->|              |                |                  |
  |              |--æ–°è¿æ¥----->|                |                  |
  |              |              |--åˆ†é…è¿æ¥----->|                  |
  |              |              |                |--è¯»å–æ•°æ®------->|
  |              |              |                |                  |--å¤„ç†ä¸šåŠ¡
  |              |              |                |<--è¿”å›ç»“æœ-------|
  |              |<--å“åº”æ•°æ®----------------------|                  |
  |<--æ”¶åˆ°å“åº”---|              |                |                  |

å…³é”®è§’è‰²ï¼š
â€¢ Bossçº¿ç¨‹ï¼šä¸“é—¨æ¥æ”¶æ–°è¿æ¥ï¼ˆåƒå‰å°æ¥å¾…ï¼‰
â€¢ Workerçº¿ç¨‹ï¼šå¤„ç†å·²æœ‰è¿æ¥çš„æ•°æ®è¯»å†™ï¼ˆåƒä¸šåŠ¡å‘˜ï¼‰
â€¢ EventLoopï¼šäº‹ä»¶å¾ªç¯ï¼Œé©±åŠ¨æ•´ä¸ªæµç¨‹è¿è½¬
```

### 1.3 è°ƒä¼˜çš„æ ¸å¿ƒæ€è·¯


**ğŸ” è°ƒä¼˜ä¸‰æ­¥æ³•**ï¼š

```
ç¬¬1æ­¥ï¼šäº†è§£ä¸šåŠ¡ç‰¹ç‚¹
â”œâ”€â”€ è¿æ¥æ•°å¤šå°‘ï¼Ÿï¼ˆ100ä¸ª vs 10ä¸‡ä¸ªï¼‰
â”œâ”€â”€ è¯·æ±‚é¢‘ç‡ï¼Ÿï¼ˆæ¯ç§’10æ¬¡ vs æ¯ç§’10ä¸‡æ¬¡ï¼‰
â”œâ”€â”€ æ•°æ®åŒ…å¤§å°ï¼Ÿï¼ˆ1KB vs 1MBï¼‰
â””â”€â”€ å“åº”æ—¶é—´è¦æ±‚ï¼Ÿï¼ˆ100ms vs 10msï¼‰

ç¬¬2æ­¥ï¼šè¯†åˆ«æ€§èƒ½ç“¶é¢ˆ
â”œâ”€â”€ CPUä½¿ç”¨ç‡é«˜ï¼Ÿâ†’ çº¿ç¨‹æ•°å¯èƒ½ä¸å¤Ÿ
â”œâ”€â”€ å†…å­˜é¢‘ç¹GCï¼Ÿâ†’ å†…å­˜åˆ†é…ç­–ç•¥æœ‰é—®é¢˜
â”œâ”€â”€ ç½‘ç»œååä½ï¼Ÿâ†’ IOå‚æ•°é…ç½®ä¸å½“
â””â”€â”€ å»¶è¿Ÿæ³¢åŠ¨å¤§ï¼Ÿâ†’ EventLoopè°ƒåº¦æœ‰é—®é¢˜

ç¬¬3æ­¥ï¼šé’ˆå¯¹æ€§è°ƒä¼˜
â”œâ”€â”€ è°ƒæ•´çº¿ç¨‹æ± å¤§å°
â”œâ”€â”€ ä¼˜åŒ–å†…å­˜åˆ†é…ç­–ç•¥
â”œâ”€â”€ è®¾ç½®åˆç†çš„ChannelOption
â””â”€â”€ é€‰æ‹©åˆé€‚çš„EventLoopæ¨¡å‹
```

::: tip ğŸ’¡ è°ƒä¼˜å¿ƒæ³•
æ²¡æœ‰ä¸‡èƒ½é…ç½®ï¼Œåªæœ‰æœ€é€‚åˆçš„é…ç½®ã€‚å…ˆæµ‹è¯•ï¼Œå†è°ƒä¼˜ï¼ŒåéªŒè¯ã€‚
:::

---

## 2. ğŸ‘” Bossçº¿ç¨‹æ± é…ç½®


### 2.1 Bossçº¿ç¨‹çš„ä½œç”¨


**ğŸ  ç”Ÿæ´»ç±»æ¯”**ï¼š
```
Bossçº¿ç¨‹ = é…’åº—å‰å°æ¥å¾…å‘˜
ä½œç”¨ï¼š
- åªè´Ÿè´£è¿æ¥æ–°å®¢äººï¼ˆæ¥æ”¶æ–°è¿æ¥ï¼‰
- åŠç†å…¥ä½æ‰‹ç»­ï¼ˆå®ŒæˆTCPä¸‰æ¬¡æ¡æ‰‹ï¼‰
- å®‰æ’æˆ¿é—´ï¼ˆæŠŠè¿æ¥åˆ†é…ç»™Workerçº¿ç¨‹ï¼‰

ä¸è´Ÿè´£ï¼š
- å®¢æˆ¿æœåŠ¡ï¼ˆæ•°æ®è¯»å†™ï¼‰
- é¤é¥®æœåŠ¡ï¼ˆä¸šåŠ¡å¤„ç†ï¼‰
```

**æ ¸å¿ƒèŒè´£**ï¼š
```
Bossçº¿ç¨‹ä¸“é—¨åšçš„äº‹ï¼š
1. ç›‘å¬ç«¯å£ï¼ˆServerSocket.accept()ï¼‰
2. æ¥æ”¶æ–°è¿æ¥ï¼ˆTCPæ¡æ‰‹ï¼‰
3. åˆ›å»ºChannelå¯¹è±¡
4. æ³¨å†Œåˆ°Workerçº¿ç¨‹ç»„

ä¸€å¥è¯æ€»ç»“ï¼šä¸“èŒ"æ¥å®¢"ï¼Œä¸ç®¡"æœåŠ¡"
```

### 2.2 Bossçº¿ç¨‹æ•°é‡é…ç½®


**ğŸ“Š é…ç½®åŸåˆ™**ï¼š

| åœºæ™¯ | æ¨èé…ç½® | ç†ç”± |
|------|---------|------|
| **å•ç«¯å£æœåŠ¡** | `1ä¸ªçº¿ç¨‹` | ä¸€ä¸ªç«¯å£ä¸€ä¸ªBossè¶³å¤Ÿ |
| **å¤šç«¯å£æœåŠ¡** | `ç«¯å£æ•°ä¸ªçº¿ç¨‹` | æ¯ä¸ªç«¯å£é…ä¸€ä¸ªBoss |
| **è¶…é«˜å¹¶å‘** | `1-2ä¸ªçº¿ç¨‹` | Bossä¸æ˜¯ç“¶é¢ˆï¼Œä¸éœ€è¦å¤š |

```java
// âœ… æ¨èé…ç½®ï¼ˆå•ç«¯å£åœºæ™¯ï¼‰
EventLoopGroup bossGroup = new NioEventLoopGroup(1);

// âœ… æ¨èé…ç½®ï¼ˆå¤šç«¯å£åœºæ™¯ï¼Œæ¯”å¦‚åŒæ—¶ç›‘å¬8080å’Œ9090ï¼‰
EventLoopGroup bossGroup = new NioEventLoopGroup(2);

// âŒ é”™è¯¯é…ç½®ï¼ˆBossçº¿ç¨‹è¿‡å¤šï¼‰
EventLoopGroup bossGroup = new NioEventLoopGroup(10); 
// ä¸ºä»€ä¹ˆé”™ï¼Ÿå•ç«¯å£åªéœ€è¦1ä¸ªBossï¼Œå¤šäº†æµªè´¹èµ„æº
```

**ğŸ¯ é…ç½®å»ºè®®**ï¼š

```
Bossçº¿ç¨‹æ•° = ç›‘å¬çš„ç«¯å£æ•°é‡

å®é™…æ¡ˆä¾‹ï¼š
åœºæ™¯1ï¼šAPIç½‘å…³åªç›‘å¬8080ç«¯å£
      â†’ bossGroup = 1ä¸ªçº¿ç¨‹

åœºæ™¯2ï¼šåŒæ—¶æä¾›HTTP(8080)å’ŒHTTPS(8443)
      â†’ bossGroup = 2ä¸ªçº¿ç¨‹

åœºæ™¯3ï¼šç›‘å¬5ä¸ªä¸åŒç«¯å£
      â†’ bossGroup = 5ä¸ªçº¿ç¨‹

è®°ä½ï¼šBossçº¿ç¨‹ä¸æ˜¯è¶Šå¤šè¶Šå¥½ï¼Œå¤Ÿç”¨å°±è¡Œï¼
```

### 2.3 Bossçº¿ç¨‹ä¼˜åŒ–è¦ç‚¹


::: warning âš ï¸ å¸¸è§è¯¯åŒº
è¯¯åŒºï¼šä»¥ä¸ºBossçº¿ç¨‹è¶Šå¤šï¼Œæ¥æ”¶è¿æ¥è¶Šå¿«
çœŸç›¸ï¼šBossçº¿ç¨‹åªåšTCPæ¡æ‰‹ï¼Œå•ä¸ªçº¿ç¨‹æ¯ç§’èƒ½å¤„ç†ä¸Šä¸‡è¿æ¥ï¼Œä¸æ˜¯ç“¶é¢ˆ
:::

**ä¼˜åŒ–æ£€æŸ¥æ¸…å•**ï¼š
- [ ] Bossçº¿ç¨‹æ•° = ç›‘å¬ç«¯å£æ•°
- [ ] æ²¡æœ‰åœ¨Bossçº¿ç¨‹åšè€—æ—¶æ“ä½œ
- [ ] Bossçº¿ç¨‹å’ŒWorkerçº¿ç¨‹åˆ†ç¦»
- [ ] åˆç†è®¾ç½®accepté˜Ÿåˆ—å¤§å°

```java
// å®Œæ•´çš„Bossçº¿ç¨‹é…ç½®ç¤ºä¾‹
ServerBootstrap bootstrap = new ServerBootstrap();
bootstrap.group(
    new NioEventLoopGroup(1),      // Boss: 1ä¸ªçº¿ç¨‹å¤Ÿç”¨
    new NioEventLoopGroup()         // Worker: è‡ªåŠ¨è®¡ç®—ï¼ˆåé¢è®²ï¼‰
)
.channel(NioServerSocketChannel.class)
.option(ChannelOption.SO_BACKLOG, 128)  // è¿æ¥é˜Ÿåˆ—å¤§å°ï¼ˆåé¢è¯¦è®²ï¼‰
.childHandler(new ChannelInitializer<SocketChannel>() {
    @Override
    protected void initChannel(SocketChannel ch) {
        // é…ç½®ä¸šåŠ¡å¤„ç†å™¨
    }
});
```

---

## 3. ğŸ‘· Workerçº¿ç¨‹æ± é…ç½®


### 3.1 Workerçº¿ç¨‹çš„ä½œç”¨


**ğŸ  ç”Ÿæ´»ç±»æ¯”**ï¼š
```
Workerçº¿ç¨‹ = é…’åº—æœåŠ¡å‘˜
ä½œç”¨ï¼š
- è´Ÿè´£å®¢æˆ¿æœåŠ¡ï¼ˆæ•°æ®è¯»å†™ï¼‰
- å¤„ç†å®¢äººéœ€æ±‚ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰
- ä¸€å¯¹å¤šæœåŠ¡ï¼ˆä¸€ä¸ªWorkerç®¡ç†å¤šä¸ªè¿æ¥ï¼‰

ç‰¹ç‚¹ï¼š
- æ•°é‡å¤šï¼ˆæœåŠ¡å‘˜æ¯”å‰å°å¤šï¼‰
- å·¥ä½œé‡ï¼ˆè¯»å†™+ä¸šåŠ¡å¤„ç†ï¼‰
- éœ€è¦ä¼˜åŒ–ï¼ˆè¿™æ˜¯æ€§èƒ½å…³é”®ï¼‰
```

**æ ¸å¿ƒèŒè´£**ï¼š
```
Workerçº¿ç¨‹çš„å·¥ä½œæµç¨‹ï¼š
                        
1. ç›‘å¬å·²æ³¨å†Œçš„è¿æ¥    â”
2. è¯»å–ç½‘ç»œæ•°æ®        â”‚
3. è§£ç æ•°æ®           â”‚ å¾ªç¯æ‰§è¡Œ
4. è°ƒç”¨ä¸šåŠ¡Handler    â”‚ (EventLoop)
5. ç¼–ç å“åº”æ•°æ®        â”‚
6. å†™å›ç½‘ç»œ           â”˜

ä¸€å¥è¯ï¼šWorkerè´Ÿè´£è¿æ¥çš„å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†
```

### 3.2 Workerçº¿ç¨‹æ•°é‡è®¡ç®—


**ğŸ“Š æ ¸å¿ƒå…¬å¼**ï¼š

```
Workerçº¿ç¨‹æ•° = CPUæ ¸å¿ƒæ•° Ã— 2

ä¸ºä»€ä¹ˆè¿™æ ·ç®—ï¼Ÿ

CPUå¯†é›†å‹ï¼š
- çº¿ç¨‹æ•° = CPUæ ¸å¿ƒæ•°
- ä¾‹ï¼š4æ ¸CPU â†’ 4ä¸ªWorkerçº¿ç¨‹

IOå¯†é›†å‹ï¼ˆNettyå±äºè¿™ç§ï¼‰ï¼š
- çº¿ç¨‹æ•° = CPUæ ¸å¿ƒæ•° Ã— 2
- ä¾‹ï¼š4æ ¸CPU â†’ 8ä¸ªWorkerçº¿ç¨‹

æ··åˆå‹ï¼ˆæœ‰é˜»å¡æ“ä½œï¼‰ï¼š
- çº¿ç¨‹æ•° = CPUæ ¸å¿ƒæ•° Ã— (1 + ç­‰å¾…æ—¶é—´/è®¡ç®—æ—¶é—´)
- ä¾‹ï¼š4æ ¸CPUï¼Œç­‰å¾…æ—¶é—´æ˜¯è®¡ç®—æ—¶é—´3å€ â†’ 4Ã—(1+3) = 16ä¸ªçº¿ç¨‹
```

**å®é™…é…ç½®ç¤ºä¾‹**ï¼š

| æœåŠ¡å™¨é…ç½® | CPUæ ¸å¿ƒæ•° | æ¨èWorkeræ•° | é€‚ç”¨åœºæ™¯ |
|-----------|----------|-------------|---------|
| å…¥é—¨çº§ | 2æ ¸ | 4ä¸ª | å°å‹åº”ç”¨ |
| æ ‡å‡†çº§ | 4æ ¸ | 8ä¸ª | ä¸­å‹åº”ç”¨ |
| é«˜æ€§èƒ½ | 8æ ¸ | 16ä¸ª | å¤§å‹åº”ç”¨ |
| æœåŠ¡å™¨çº§ | 16æ ¸ | 32ä¸ª | ä¼ä¸šçº§åº”ç”¨ |

```java
// æ–¹å¼1ï¼šè‡ªåŠ¨è®¡ç®—ï¼ˆæ¨èï¼‰
EventLoopGroup workerGroup = new NioEventLoopGroup();
// é»˜è®¤çº¿ç¨‹æ•° = CPUæ ¸å¿ƒæ•° Ã— 2

// æ–¹å¼2ï¼šæ‰‹åŠ¨æŒ‡å®š
EventLoopGroup workerGroup = new NioEventLoopGroup(16);

// æ–¹å¼3ï¼šæ ¹æ®CPUåŠ¨æ€è®¡ç®—
int workerThreads = Runtime.getRuntime().availableProcessors() * 2;
EventLoopGroup workerGroup = new NioEventLoopGroup(workerThreads);
```

### 3.3 Workerçº¿ç¨‹ä¼˜åŒ–ç­–ç•¥


**ğŸ¯ ä¼˜åŒ–è¦ç‚¹**ï¼š

```
åœºæ™¯1ï¼šé«˜å¹¶å‘çŸ­è¿æ¥ï¼ˆå¦‚HTTPè¯·æ±‚ï¼‰
ç­–ç•¥ï¼š
â€¢ Workerçº¿ç¨‹æ•° = CPUæ ¸å¿ƒæ•° Ã— 2
â€¢ å¯ç”¨è¿æ¥æ± å¤ç”¨
â€¢ å‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢

åœºæ™¯2ï¼šé•¿è¿æ¥ä½é¢‘äº¤äº’ï¼ˆå¦‚WebSocketèŠå¤©ï¼‰
ç­–ç•¥ï¼š
â€¢ Workerçº¿ç¨‹æ•° = CPUæ ¸å¿ƒæ•°
â€¢ å¢å¤§æ¯ä¸ªçº¿ç¨‹ç®¡ç†çš„è¿æ¥æ•°
â€¢ ä¼˜åŒ–ç©ºé—²è¿æ¥æ£€æµ‹

åœºæ™¯3ï¼šæ··åˆåœºæ™¯
ç­–ç•¥ï¼š
â€¢ åˆ†ç¦»IOçº¿ç¨‹å’Œä¸šåŠ¡çº¿ç¨‹
â€¢ IOçº¿ç¨‹ï¼šCPUæ ¸å¿ƒæ•° Ã— 2
â€¢ ä¸šåŠ¡çº¿ç¨‹ï¼šç‹¬ç«‹çº¿ç¨‹æ± å¤„ç†
```

**å®æˆ˜é…ç½®ç¤ºä¾‹**ï¼š

```java
// é«˜æ€§èƒ½é…ç½®ï¼ˆé€‚åˆAPIç½‘å…³ï¼‰
public class NettyServerConfig {
    
    public ServerBootstrap createServer() {
        // Bossçº¿ç¨‹ï¼š1ä¸ª
        EventLoopGroup bossGroup = new NioEventLoopGroup(1);
        
        // Workerçº¿ç¨‹ï¼šCPUæ ¸å¿ƒæ•° Ã— 2
        int workerThreads = Runtime.getRuntime().availableProcessors() * 2;
        EventLoopGroup workerGroup = new NioEventLoopGroup(workerThreads);
        
        // ä¸šåŠ¡çº¿ç¨‹æ± ï¼ˆé¿å…é˜»å¡Workerï¼‰
        ThreadPoolExecutor businessExecutor = new ThreadPoolExecutor(
            10,                          // æ ¸å¿ƒçº¿ç¨‹
            50,                          // æœ€å¤§çº¿ç¨‹
            60, TimeUnit.SECONDS,        // ç©ºé—²æ—¶é—´
            new LinkedBlockingQueue<>(1000)  // ä»»åŠ¡é˜Ÿåˆ—
        );
        
        ServerBootstrap bootstrap = new ServerBootstrap();
        bootstrap.group(bossGroup, workerGroup)
            .channel(NioServerSocketChannel.class)
            .childHandler(new ChannelInitializer<SocketChannel>() {
                @Override
                protected void initChannel(SocketChannel ch) {
                    ch.pipeline()
                        .addLast(new HttpServerCodec())
                        .addLast(new HttpObjectAggregator(65536))
                        // ä¸šåŠ¡å¤„ç†å™¨ï¼Œä½¿ç”¨ç‹¬ç«‹çº¿ç¨‹æ± 
                        .addLast(businessExecutor, new BusinessHandler());
                }
            });
        
        return bootstrap;
    }
}
```

::: tip ğŸ’¡ å…³é”®ç†è§£
Workerçº¿ç¨‹ä¸è¦å¤„ç†è€—æ—¶æ“ä½œï¼å¦‚æœæœ‰æ•°æ®åº“æŸ¥è¯¢ã€æ–‡ä»¶IOç­‰ï¼Œä¸€å®šè¦ç”¨ç‹¬ç«‹çš„ä¸šåŠ¡çº¿ç¨‹æ± ã€‚
:::

---

## 4. ğŸ”§ ChannelOptionå‚æ•°è¯¦è§£


### 4.1 ä»€ä¹ˆæ˜¯ChannelOption


**é€šä¿—ç†è§£**ï¼šå°±åƒç”µè„‘çš„BIOSè®¾ç½®ï¼ŒChannelOptionæ˜¯Nettyçš„åº•å±‚å‚æ•°é…ç½®ã€‚

```
ç±»æ¯”ç†è§£ï¼š
ğŸ“± æ‰‹æœºè®¾ç½®
â”œâ”€â”€ å±å¹•äº®åº¦       â†’ ChannelOption.SO_RCVBUFï¼ˆæ¥æ”¶ç¼“å†²åŒºï¼‰
â”œâ”€â”€ éŸ³é‡å¤§å°       â†’ ChannelOption.SO_SNDBUFï¼ˆå‘é€ç¼“å†²åŒºï¼‰
â”œâ”€â”€ çœç”µæ¨¡å¼       â†’ ChannelOption.SO_KEEPALIVEï¼ˆä¿æ´»æœºåˆ¶ï¼‰
â””â”€â”€ è¿æ¥è®¾ç½®       â†’ ChannelOption.SO_BACKLOGï¼ˆè¿æ¥é˜Ÿåˆ—ï¼‰

è°ƒå¯¹äº†å‚æ•° â†’ æ€§èƒ½æå‡
è°ƒé”™äº†å‚æ•° â†’ é—®é¢˜é¢‘å‡º
```

### 4.2 æ ¸å¿ƒå‚æ•°è¯¦è§£


#### ğŸ”¸ SO_BACKLOGï¼ˆè¿æ¥é˜Ÿåˆ—å¤§å°ï¼‰


**ä½œç”¨**ï¼šæ§åˆ¶æœåŠ¡å™¨èƒ½æ’é˜Ÿç­‰å¾…çš„è¿æ¥æ•°é‡

```
å½¢è±¡ç†è§£ï¼š
é¤å…åœºæ™¯ï¼š
- SO_BACKLOG = å€™é¤åŒºåº§ä½æ•°
- å®¢äººæ¥äº†ä½†æ²¡ä½ç½® â†’ æ’é˜Ÿç­‰å¾…
- é˜Ÿåˆ—æ»¡äº† â†’ æ‹’ç»æ–°å®¢äºº

Nettyåœºæ™¯ï¼š
- æ–°è¿æ¥æ¥äº†ä½†Workerå¿™ â†’ æ”¾å…¥é˜Ÿåˆ—
- é˜Ÿåˆ—æ»¡äº† â†’ æ‹’ç»è¿æ¥ï¼ˆConnection refusedï¼‰
```

| åœºæ™¯ | æ¨èå€¼ | è¯´æ˜ |
|------|--------|------|
| ä½å¹¶å‘ | 128 | é»˜è®¤å€¼ï¼Œå¤Ÿç”¨ |
| ä¸­å¹¶å‘ | 512 | é€‚åˆä¸­å‹åº”ç”¨ |
| é«˜å¹¶å‘ | 1024-2048 | å¤§å‹åº”ç”¨ã€ç§’æ€åœºæ™¯ |

```java
// é…ç½®ç¤ºä¾‹
bootstrap.option(ChannelOption.SO_BACKLOG, 1024);

// âš ï¸ æ³¨æ„äº‹é¡¹
// 1. ä¸æ˜¯è¶Šå¤§è¶Šå¥½ï¼Œè¦ç»“åˆç³»ç»Ÿèµ„æº
// 2. Linuxç³»ç»Ÿè¿˜æœ‰somaxconnå‚æ•°é™åˆ¶
// 3. éœ€è¦åŒæ—¶è°ƒæ•´æ“ä½œç³»ç»Ÿå‚æ•°
```

#### ğŸ”¸ SO_KEEPALIVEï¼ˆè¿æ¥ä¿æ´»ï¼‰


**ä½œç”¨**ï¼šå®šæœŸæ£€æµ‹è¿æ¥æ˜¯å¦è¿˜æ´»ç€

```
ä¸ºä»€ä¹ˆéœ€è¦ï¼Ÿ
é—®é¢˜ï¼šå®¢æˆ·ç«¯å¼‚å¸¸æ–­å¼€ï¼ŒæœåŠ¡å™¨ä¸çŸ¥é“
åœºæ™¯ï¼š
1. å®¢æˆ·ç«¯æ–­ç”µ
2. ç½‘ç»œä¸­æ–­
3. ç¨‹åºå´©æºƒ

SO_KEEPALIVEåšä»€ä¹ˆï¼š
å®šæœŸå‘é€å¿ƒè·³åŒ… â†’ æ£€æµ‹è¿æ¥çŠ¶æ€ â†’ åŠæ—¶æ¸…ç†æ­»è¿æ¥
```

```java
// å¯ç”¨ä¿æ´»æœºåˆ¶
bootstrap.childOption(ChannelOption.SO_KEEPALIVE, true);

// é…åˆä½¿ç”¨ï¼šè‡ªå®šä¹‰å¿ƒè·³æ£€æµ‹
pipeline.addLast(new IdleStateHandler(
    60,  // è¯»è¶…æ—¶ï¼š60ç§’æ²¡æ”¶åˆ°æ•°æ®
    30,  // å†™è¶…æ—¶ï¼š30ç§’æ²¡å‘é€æ•°æ®  
    0    // è¯»å†™è¶…æ—¶ï¼šä¸æ£€æµ‹
));
```

**ä½¿ç”¨å»ºè®®**ï¼š
- âœ… é•¿è¿æ¥åœºæ™¯ï¼šå¼€å¯ï¼ˆå¦‚WebSocketã€RPCï¼‰
- âŒ çŸ­è¿æ¥åœºæ™¯ï¼šå…³é—­ï¼ˆå¦‚HTTPè¯·æ±‚ï¼‰

#### ğŸ”¸ TCP_NODELAYï¼ˆç¦ç”¨Nagleç®—æ³•ï¼‰


**ä½œç”¨**ï¼šæ§åˆ¶æ•°æ®åŒ…çš„å‘é€æ—¶æœº

```
Nagleç®—æ³•ï¼š
ç›®çš„ï¼šå‡å°‘å°åŒ…ä¼ è¾“ï¼Œæé«˜ç½‘ç»œåˆ©ç”¨ç‡
åšæ³•ï¼šç­‰å¾…æ•°æ®ç§¯ç´¯åˆ°ä¸€å®šé‡å†å‘é€

é—®é¢˜ï¼šå¢åŠ å»¶è¿Ÿï¼

ç¤ºä¾‹ï¼š
å‘é€"Hello" â†’ Nagleç­‰å¾…å‡‘å¤Ÿæ•°æ® â†’ å»¶è¿Ÿ200ms
TCP_NODELAY = true â†’ ç«‹å³å‘é€ â†’ å»¶è¿Ÿ5ms
```

| åœºæ™¯ | é…ç½® | åŸå›  |
|------|------|------|
| å³æ—¶é€šè®¯ | `TCP_NODELAY = true` | è¦æ±‚ä½å»¶è¿Ÿ |
| æ–‡ä»¶ä¼ è¾“ | `TCP_NODELAY = false` | è¦æ±‚é«˜åå |
| APIç½‘å…³ | `TCP_NODELAY = true` | å“åº”è¦å¿« |

```java
// ç¦ç”¨Nagleç®—æ³•ï¼ˆæ¨èï¼‰
bootstrap.childOption(ChannelOption.TCP_NODELAY, true);
```

::: warning âš ï¸ æ³¨æ„
APIç½‘å…³åœºæ™¯ï¼Œä¸€å®šè¦è®¾ç½® TCP_NODELAY = trueï¼Œå¦åˆ™å»¶è¿Ÿä¼šå¾ˆé«˜ï¼
:::

#### ğŸ”¸ SO_RCVBUF / SO_SNDBUFï¼ˆç¼“å†²åŒºå¤§å°ï¼‰


**ä½œç”¨**ï¼šæ§åˆ¶æ¥æ”¶å’Œå‘é€ç¼“å†²åŒºçš„å¤§å°

```
ç¼“å†²åŒº = æ•°æ®ä¸­è½¬ç«™

æ¥æ”¶ç¼“å†²åŒº(SO_RCVBUF)ï¼š
ç½‘ç»œ â†’ [æ¥æ”¶ç¼“å†²åŒº] â†’ åº”ç”¨ç¨‹åº

å‘é€ç¼“å†²åŒº(SO_SNDBUF)ï¼š
åº”ç”¨ç¨‹åº â†’ [å‘é€ç¼“å†²åŒº] â†’ ç½‘ç»œ

ç¼“å†²åŒºå¤ªå°ï¼šæ•°æ®ä¸¢å¤±ï¼Œé¢‘ç¹è¯»å†™
ç¼“å†²åŒºå¤ªå¤§ï¼šæµªè´¹å†…å­˜
```

**æ¨èé…ç½®**ï¼š

```java
// é«˜åååœºæ™¯ï¼ˆå¤§æ•°æ®ä¼ è¾“ï¼‰
bootstrap.childOption(ChannelOption.SO_RCVBUF, 1024 * 1024);  // 1MB
bootstrap.childOption(ChannelOption.SO_SNDBUF, 1024 * 1024);  // 1MB

// ä½å»¶è¿Ÿåœºæ™¯ï¼ˆå°æ•°æ®äº¤äº’ï¼‰
bootstrap.childOption(ChannelOption.SO_RCVBUF, 64 * 1024);    // 64KB
bootstrap.childOption(ChannelOption.SO_SNDBUF, 64 * 1024);    // 64KB

// ä¸€èˆ¬åœºæ™¯ï¼ˆä½¿ç”¨ç³»ç»Ÿé»˜è®¤ï¼‰
// ä¸è®¾ç½®ï¼Œè®©æ“ä½œç³»ç»Ÿè‡ªåŠ¨è°ƒæ•´
```

### 4.3 å®Œæ•´é…ç½®ç¤ºä¾‹


```java
// é«˜æ€§èƒ½APIç½‘å…³é…ç½®
ServerBootstrap bootstrap = new ServerBootstrap();
bootstrap.group(bossGroup, workerGroup)
    .channel(NioServerSocketChannel.class)
    
    // === Bossçº¿ç¨‹é…ç½® ===
    .option(ChannelOption.SO_BACKLOG, 1024)        // è¿æ¥é˜Ÿåˆ—
    
    // === Workerçº¿ç¨‹é…ç½® ===
    .childOption(ChannelOption.TCP_NODELAY, true)  // ç¦ç”¨Nagle
    .childOption(ChannelOption.SO_KEEPALIVE, true) // ä¿æ´»æ£€æµ‹
    .childOption(ChannelOption.SO_RCVBUF, 128 * 1024)  // æ¥æ”¶ç¼“å†²128KB
    .childOption(ChannelOption.SO_SNDBUF, 128 * 1024)  // å‘é€ç¼“å†²128KB
    .childOption(ChannelOption.ALLOCATOR, PooledByteBufAllocator.DEFAULT)  // å†…å­˜æ± ï¼ˆä¸‹èŠ‚è®²ï¼‰
    
    .childHandler(new ChannelInitializer<SocketChannel>() {
        @Override
        protected void initChannel(SocketChannel ch) {
            // é…ç½®å¤„ç†å™¨
        }
    });
```

**ğŸ¯ é…ç½®é€ŸæŸ¥è¡¨**ï¼š

| å‚æ•° | æ¨èå€¼ | é€‚ç”¨åœºæ™¯ |
|------|--------|---------|
| SO_BACKLOG | 1024 | é«˜å¹¶å‘ |
| TCP_NODELAY | true | ä½å»¶è¿Ÿ |
| SO_KEEPALIVE | true | é•¿è¿æ¥ |
| SO_RCVBUF | 128KB | ä¸­å°æ•°æ® |
| SO_SNDBUF | 128KB | ä¸­å°æ•°æ® |

---

## 5. ğŸ§  ByteBufå†…å­˜ç®¡ç†


### 5.1 ByteBufåŸºç¡€è®¤çŸ¥


**ğŸ  ç”Ÿæ´»ç±»æ¯”**ï¼š
```
ByteBuf = å¯é‡å¤ä½¿ç”¨çš„æ°´æ¯

æ™®é€šåšæ³•ï¼ˆJDK ByteBufferï¼‰ï¼š
- ç”¨ä¸€æ¬¡æ‰”ä¸€æ¬¡ â†’ é¢‘ç¹åˆ›å»ºé”€æ¯
- åƒåœ¾æ»¡åœ° â†’ é¢‘ç¹GC
- æµªè´¹èµ„æº â†’ æ€§èƒ½å·®

Nettyåšæ³•ï¼ˆByteBufï¼‰ï¼š
- æ°´æ¯å¾ªç¯ä½¿ç”¨ â†’ å¯¹è±¡æ± å¤ç”¨
- å®šæœŸæ¸…æ´— â†’ å¼•ç”¨è®¡æ•°ç®¡ç†
- æŒ‰éœ€åˆ†é… â†’ å‡å°‘æµªè´¹
```

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
```
ByteBuf vs ByteBuffer

ByteBufferï¼ˆJDKï¼‰çš„é—®é¢˜ï¼š
âŒ è¯»å†™å…±ç”¨ä¸€ä¸ªæŒ‡é’ˆï¼Œè¦flip()åˆ‡æ¢
âŒ å®¹é‡å›ºå®šï¼Œæ‰©å®¹éº»çƒ¦
âŒ æ¯æ¬¡éƒ½è¦åˆ›å»ºæ–°å¯¹è±¡

ByteBufï¼ˆNettyï¼‰çš„ä¼˜åŠ¿ï¼š
âœ… è¯»å†™ç‹¬ç«‹æŒ‡é’ˆï¼Œæ— éœ€flip()
âœ… åŠ¨æ€æ‰©å®¹ï¼Œè‡ªåŠ¨å¤„ç†
âœ… æ± åŒ–ç®¡ç†ï¼Œå‡å°‘GC
```

### 5.2 å†…å­˜åˆ†é…ç­–ç•¥


**ğŸ“Š ä¸‰ç§åˆ†é…æ–¹å¼**ï¼š

#### æ–¹å¼1ï¼šéæ± åŒ– Heapï¼ˆå †å†…å­˜ï¼‰

```java
// æ¯æ¬¡åˆ†é…æ–°å¯¹è±¡
ByteBuf buffer = Unpooled.buffer();

ä¼˜ç‚¹ï¼š
â€¢ ç®€å•ç›´æ¥
â€¢ æ— éœ€ç®¡ç†ç”Ÿå‘½å‘¨æœŸ

ç¼ºç‚¹ï¼š
â€¢ é¢‘ç¹GC
â€¢ æ€§èƒ½ä¸€èˆ¬

é€‚ç”¨ï¼š
â€¢ ä½å¹¶å‘åœºæ™¯
â€¢ ä¸´æ—¶ä½¿ç”¨
```

#### æ–¹å¼2ï¼šéæ± åŒ– Directï¼ˆç›´æ¥å†…å­˜ï¼‰

```java
ByteBuf buffer = Unpooled.directBuffer();

ä¼˜ç‚¹ï¼š
â€¢ å‡å°‘æ•°æ®æ‹·è´
â€¢ é€‚åˆç½‘ç»œIO

ç¼ºç‚¹ï¼š
â€¢ åˆ›å»ºé”€æ¯æ…¢
â€¢ ä»ç„¶é¢‘ç¹åˆ†é…

é€‚ç”¨ï¼š
â€¢ å¤§æ•°æ®ä¼ è¾“
â€¢ ä¸€æ¬¡æ€§åœºæ™¯
```

#### æ–¹å¼3ï¼šæ± åŒ–ï¼ˆæ¨èï¼‰

```java
ByteBuf buffer = PooledByteBufAllocator.DEFAULT.buffer();

ä¼˜ç‚¹ï¼š
â€¢ å¯¹è±¡å¤ç”¨ï¼Œå‡å°‘GC
â€¢ æ€§èƒ½æœ€ä¼˜
â€¢ å†…å­˜å¯æ§

ç¼ºç‚¹ï¼š
â€¢ éœ€è¦æ‰‹åŠ¨é‡Šæ”¾
â€¢ ç®¡ç†å¤æ‚

é€‚ç”¨ï¼š
â€¢ é«˜å¹¶å‘åœºæ™¯
â€¢ ç”Ÿäº§ç¯å¢ƒ
```

### 5.3 æ± åŒ–é…ç½®è¯¦è§£


**å¯ç”¨æ± åŒ–å†…å­˜**ï¼š

```java
// æ–¹å¼1ï¼šå…¨å±€é…ç½®ï¼ˆæ¨èï¼‰
bootstrap.childOption(
    ChannelOption.ALLOCATOR, 
    PooledByteBufAllocator.DEFAULT
);

// æ–¹å¼2ï¼šè®¾ç½®JVMå‚æ•°
-Dio.netty.allocator.type=pooled

// æ–¹å¼3ï¼šä»£ç ä¸­æ‰‹åŠ¨åˆ›å»º
PooledByteBufAllocator allocator = new PooledByteBufAllocator(
    true,      // preferDirectï¼šä¼˜å…ˆä½¿ç”¨ç›´æ¥å†…å­˜
    2,         // nHeapArenaï¼šå †å†…å­˜åŒºåŸŸæ•°ï¼ˆé€šå¸¸=CPUæ ¸å¿ƒæ•°ï¼‰
    2,         // nDirectArenaï¼šç›´æ¥å†…å­˜åŒºåŸŸæ•°
    8192,      // pageSizeï¼šé¡µå¤§å°
    11,        // maxOrderï¼šæœ€å¤§å—å¤§å° = pageSize << maxOrder
    64,        // tinyCacheSizeï¼šå¾®å‹ç¼“å­˜å¤§å°
    256,       // smallCacheSizeï¼šå°å‹ç¼“å­˜å¤§å°
    512        // normalCacheSizeï¼šæ™®é€šç¼“å­˜å¤§å°
);
```

**ğŸ¯ é…ç½®å»ºè®®**ï¼š

| åœºæ™¯ | å†…å­˜ç±»å‹ | æ˜¯å¦æ± åŒ– | é…ç½® |
|------|---------|---------|------|
| é«˜å¹¶å‘API | Direct | âœ… æ± åŒ– | `PooledByteBufAllocator.DEFAULT` |
| ä½å¹¶å‘åº”ç”¨ | Heap | âŒ éæ± åŒ– | `UnpooledByteBufAllocator.DEFAULT` |
| å†…å­˜å—é™ | Heap | âœ… æ± åŒ– | é™åˆ¶æ± å¤§å° |

### 5.4 å†…å­˜æ³„æ¼é¢„é˜²


**ğŸš¨ å†…å­˜æ³„æ¼çš„å¸¸è§åŸå› **ï¼š

```
é—®é¢˜1ï¼šå¿˜è®°é‡Šæ”¾ByteBuf
ByteBuf buffer = allocator.buffer();
// ... ä½¿ç”¨buffer
// âŒ å¿˜è®°è°ƒç”¨ buffer.release()

é—®é¢˜2ï¼šé‡å¤é‡Šæ”¾
buffer.release();
buffer.release();  // âŒ ç¬¬äºŒæ¬¡releaseä¼šæŠ¥é”™

é—®é¢˜3ï¼šå¼•ç”¨è®¡æ•°ä¸å¯¹
channel.writeAndFlush(buffer);
buffer.release();  // âŒ writeAndFlushä¼šè‡ªåŠ¨é‡Šæ”¾
```

**âœ… æ­£ç¡®çš„å†…å­˜ç®¡ç†**ï¼š

```java
// æ–¹å¼1ï¼šæ‰‹åŠ¨é‡Šæ”¾ï¼ˆéœ€è¦å°å¿ƒï¼‰
ByteBuf buffer = allocator.buffer();
try {
    // ä½¿ç”¨buffer
    channel.writeAndFlush(buffer);
} finally {
    // âš ï¸ writeAndFlushä¼šè‡ªåŠ¨é‡Šæ”¾ï¼Œè¿™é‡Œä¸ç”¨å†release
}

// æ–¹å¼2ï¼šä½¿ç”¨try-with-resourcesï¼ˆæ¨èï¼‰
public class AutoReleaseByteBuf implements AutoCloseable {
    private final ByteBuf buffer;
    
    public AutoReleaseByteBuf(ByteBuf buffer) {
        this.buffer = buffer;
    }
    
    @Override
    public void close() {
        if (buffer.refCnt() > 0) {
            buffer.release();
        }
    }
}

// ä½¿ç”¨
try (AutoReleaseByteBuf wrapper = new AutoReleaseByteBuf(buffer)) {
    // ä½¿ç”¨buffer
}  // è‡ªåŠ¨é‡Šæ”¾

// æ–¹å¼3ï¼šå¯ç”¨å†…å­˜æ³„æ¼æ£€æµ‹
// JVMå‚æ•°ï¼š-Dio.netty.leakDetection.level=ADVANCED
```

**å†…å­˜æ³„æ¼æ£€æµ‹çº§åˆ«**ï¼š

```
DISABLEDï¼šå…³é—­æ£€æµ‹ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
SIMPLEï¼š  é‡‡æ ·1%çš„bufferï¼ˆé»˜è®¤ï¼‰
ADVANCEDï¼šé‡‡æ ·1%ï¼Œè¾“å‡ºè¯¦ç»†ä¿¡æ¯ï¼ˆæµ‹è¯•ç¯å¢ƒï¼‰
PARANOIDï¼šæ£€æµ‹æ‰€æœ‰bufferï¼ˆè°ƒè¯•ä¸“ç”¨ï¼Œæ€§èƒ½å¾ˆå·®ï¼‰

é…ç½®æ–¹æ³•ï¼š
-Dio.netty.leakDetection.level=ADVANCED
```

::: warning âš ï¸ é‡è¦æé†’
1. writeAndFlush()ä¼šè‡ªåŠ¨é‡Šæ”¾ByteBufï¼Œä¸è¦é‡å¤release()
2. ç”Ÿäº§ç¯å¢ƒç”¨SIMPLEçº§åˆ«ï¼Œæµ‹è¯•ç¯å¢ƒç”¨ADVANCED
3. çœ‹åˆ°å†…å­˜æ³„æ¼è­¦å‘Šï¼Œä¸€å®šè¦é‡è§†ï¼
:::

### 5.5 å†…å­˜ä¼˜åŒ–å®æˆ˜


**åœºæ™¯1ï¼šå¤§é‡å°å¯¹è±¡**
```java
// é—®é¢˜ï¼šé¢‘ç¹åˆ†é…å°bufferï¼ŒGCå‹åŠ›å¤§
// ä¼˜åŒ–ï¼šä½¿ç”¨CompositeByteBufç»„åˆ

CompositeByteBuf composite = Unpooled.compositeBuffer();
composite.addComponent(true, buffer1);
composite.addComponent(true, buffer2);
// é¿å…æ•°æ®æ‹·è´ï¼Œç›´æ¥ç»„åˆ
```

**åœºæ™¯2ï¼šé›¶æ‹·è´ä¼ è¾“**
```java
// ä½¿ç”¨FileRegionå®ç°é›¶æ‹·è´
FileRegion region = new DefaultFileRegion(
    new FileInputStream(file).getChannel(), 
    0, 
    file.length()
);
channel.writeAndFlush(region);
// æ•°æ®ç›´æ¥ä»æ–‡ä»¶åˆ°ç½‘ç»œï¼Œä¸ç»è¿‡åº”ç”¨å†…å­˜
```

**åœºæ™¯3ï¼šå†…å­˜é¢„åˆ†é…**
```java
// æå‰åˆ†é…å›ºå®šå¤§å°çš„bufferæ± 
int bufferSize = 1024;
Queue<ByteBuf> bufferPool = new ConcurrentLinkedQueue<>();

// åˆå§‹åŒ–æ± 
for (int i = 0; i < 100; i++) {
    bufferPool.offer(allocator.buffer(bufferSize));
}

// ä½¿ç”¨æ—¶ä»æ± è·å–
ByteBuf buffer = bufferPool.poll();
if (buffer == null) {
    buffer = allocator.buffer(bufferSize);
}

// ä½¿ç”¨å®Œå½’è¿˜
buffer.clear();
bufferPool.offer(buffer);
```

---

## 6. ğŸ”„ EventLoopä¼˜åŒ–ç­–ç•¥


### 6.1 EventLoopå·¥ä½œåŸç†


**ğŸ  ç”Ÿæ´»ç±»æ¯”**ï¼š
```
EventLoop = é¤å…æœåŠ¡å‘˜çš„å·¥ä½œå¾ªç¯

ä¸€ä¸ªæœåŠ¡å‘˜ï¼ˆEventLoopï¼‰çš„ä¸€å¤©ï¼š
1. æŸ¥çœ‹æœ‰æ²¡æœ‰æ–°å®¢äººï¼ˆå¤„ç†æ–°äº‹ä»¶ï¼‰
2. ç»™Aæ¡Œä¸Šèœï¼ˆå¤„ç†è¿æ¥1çš„è¯»äº‹ä»¶ï¼‰
3. ç»™Bæ¡Œæ”¶ç›˜å­ï¼ˆå¤„ç†è¿æ¥2çš„å†™äº‹ä»¶ï¼‰
4. ç»™Cæ¡Œç»“è´¦ï¼ˆå¤„ç†è¿æ¥3çš„ä¸šåŠ¡ï¼‰
5. é‡å¤1-4ï¼ˆæ— é™å¾ªç¯ï¼‰

å…³é”®ï¼šä¸€ä¸ªæœåŠ¡å‘˜åŒæ—¶æœåŠ¡å¤šæ¡Œï¼ˆä¸€ä¸ªEventLoopç®¡ç†å¤šä¸ªè¿æ¥ï¼‰
```

**æ ¸å¿ƒæœºåˆ¶**ï¼š
```
EventLoopäº‹ä»¶å¾ªç¯ï¼š
                    
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  1. æ£€æŸ¥æ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿ   â”‚
    â”‚     (select/poll/epoll) â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  2. å¤„ç†IOäº‹ä»¶          â”‚
    â”‚     - æ–°è¿æ¥            â”‚
    â”‚     - è¯»å°±ç»ª            â”‚
    â”‚     - å†™å°±ç»ª            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  3. å¤„ç†ä»»åŠ¡é˜Ÿåˆ—         â”‚
    â”‚     - å®šæ—¶ä»»åŠ¡          â”‚
    â”‚     - æ™®é€šä»»åŠ¡          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
    â””â”€â”€â”€â”€â”€â†’  å¾ªç¯å›åˆ°æ­¥éª¤1
```

### 6.2 EventLoopçº¿ç¨‹æ¨¡å‹


**ğŸ“Š ä¸‰ç§çº¿ç¨‹æ¨¡å‹**ï¼š

#### æ¨¡å‹1ï¼šå•çº¿ç¨‹æ¨¡å‹

```
é€‚ç”¨ï¼šæ¼”ç¤ºã€å­¦ä¹ 
ä¸é€‚ç”¨ï¼šç”Ÿäº§ç¯å¢ƒ

ç»“æ„ï¼š
Bosså’ŒWorkerå…±ç”¨ä¸€ä¸ªEventLoop

   EventLoop(1ä¸ªçº¿ç¨‹)
      â†“
   æ‰€æœ‰è¿æ¥

ç¼ºç‚¹ï¼š
â€¢ æ€§èƒ½å·®
â€¢ æ— æ³•åˆ©ç”¨å¤šæ ¸
```

#### æ¨¡å‹2ï¼šå¤šçº¿ç¨‹æ¨¡å‹ï¼ˆæ¨èï¼‰

```
é€‚ç”¨ï¼šå¤§éƒ¨åˆ†ç”Ÿäº§åœºæ™¯

ç»“æ„ï¼š
Boss(1ä¸ªçº¿ç¨‹) + Worker(å¤šä¸ªçº¿ç¨‹)

    Boss              Worker Pool
     â†“              â†™    â†“    â†˜
  æ–°è¿æ¥          è¿æ¥1 è¿æ¥2 è¿æ¥3

ä¼˜ç‚¹ï¼š
â€¢ Bossä¸“æ³¨æ¥æ”¶è¿æ¥
â€¢ Workerå¹¶å‘å¤„ç†IO
â€¢ å……åˆ†åˆ©ç”¨å¤šæ ¸
```

#### æ¨¡å‹3ï¼šä¸»ä»å¤šçº¿ç¨‹æ¨¡å‹

```
é€‚ç”¨ï¼šè¶…é«˜å¹¶å‘åœºæ™¯

ç»“æ„ï¼š
Boss Pool + Worker Pool

  Boss Pool         Worker Pool
   â†™   â†˜          â†™    â†“    â†˜
ç«¯å£1 ç«¯å£2      è¿æ¥1 è¿æ¥2 è¿æ¥3

åœºæ™¯ï¼š
â€¢ å¤šç«¯å£ç›‘å¬
â€¢ äº¿çº§è¿æ¥
â€¢ ä¸“ä¸šæœåŠ¡å™¨
```

**é…ç½®ç¤ºä¾‹**ï¼š

```java
// æ¨¡å‹1ï¼šå•çº¿ç¨‹ï¼ˆä¸æ¨èï¼‰
EventLoopGroup group = new NioEventLoopGroup(1);
bootstrap.group(group);

// æ¨¡å‹2ï¼šå¤šçº¿ç¨‹ï¼ˆæ¨èï¼‰
EventLoopGroup bossGroup = new NioEventLoopGroup(1);
EventLoopGroup workerGroup = new NioEventLoopGroup();
bootstrap.group(bossGroup, workerGroup);

// æ¨¡å‹3ï¼šä¸»ä»å¤šçº¿ç¨‹
EventLoopGroup bossGroup = new NioEventLoopGroup(4);  // 4ä¸ªBoss
EventLoopGroup workerGroup = new NioEventLoopGroup(32); // 32ä¸ªWorker
bootstrap.group(bossGroup, workerGroup);
```

### 6.3 EventLoopä»»åŠ¡è°ƒåº¦ä¼˜åŒ–


**ğŸ¯ ä»»åŠ¡ç±»å‹**ï¼š

```
EventLoopå¤„ç†ä¸‰ç±»ä»»åŠ¡ï¼š

1. IOä»»åŠ¡ï¼ˆæ ¸å¿ƒï¼‰
   - æ–°è¿æ¥æ¥å…¥
   - æ•°æ®è¯»å†™
   - ä¼˜å…ˆçº§ï¼šæœ€é«˜

2. æ™®é€šä»»åŠ¡
   - ä¸šåŠ¡é€»è¾‘
   - å¼‚æ­¥å›è°ƒ
   - ä¼˜å…ˆçº§ï¼šä¸­

3. å®šæ—¶ä»»åŠ¡
   - å¿ƒè·³æ£€æµ‹
   - è¶…æ—¶æ¸…ç†
   - ä¼˜å…ˆçº§ï¼šä¸­
```

**ä¼˜åŒ–åŸåˆ™**ï¼š

```
åŸåˆ™1ï¼šä¸è¦é˜»å¡EventLoop
âŒ é”™è¯¯ç¤ºèŒƒï¼š
eventLoop.execute(() -> {
    // æ•°æ®åº“æŸ¥è¯¢ï¼Œé˜»å¡100ms
    userDao.query(userId);
});

âœ… æ­£ç¡®åšæ³•ï¼š
businessExecutor.execute(() -> {
    // åœ¨ä¸šåŠ¡çº¿ç¨‹æ± æ‰§è¡Œ
    userDao.query(userId);
});

åŸåˆ™2ï¼šåˆç†è®¾ç½®ä»»åŠ¡æ¯”ä¾‹
-Dio.netty.eventLoopThreads=16           // Workerçº¿ç¨‹æ•°
-Dio.netty.eventLoop.maxPendingTasks=1000 // æœ€å¤§å¾…å¤„ç†ä»»åŠ¡
```

**ä»»åŠ¡è°ƒåº¦ç¤ºä¾‹**ï¼š

```java
// æäº¤æ™®é€šä»»åŠ¡åˆ°EventLoop
channel.eventLoop().execute(() -> {
    // å¿«é€Ÿæ‰§è¡Œçš„ä»»åŠ¡
    System.out.println("å¤„ç†ä»»åŠ¡");
});

// æäº¤å®šæ—¶ä»»åŠ¡
channel.eventLoop().schedule(() -> {
    // å®šæ—¶æ‰§è¡Œ
    System.out.println("1ç§’åæ‰§è¡Œ");
}, 1, TimeUnit.SECONDS);

// æäº¤å‘¨æœŸä»»åŠ¡
channel.eventLoop().scheduleAtFixedRate(() -> {
    // æ¯5ç§’æ‰§è¡Œä¸€æ¬¡
    checkHeartbeat();
}, 0, 5, TimeUnit.SECONDS);

// âš ï¸ è€—æ—¶ä»»åŠ¡ç”¨ç‹¬ç«‹çº¿ç¨‹æ± 
ThreadPoolExecutor businessExecutor = new ThreadPoolExecutor(
    10, 50, 60L, TimeUnit.SECONDS,
    new LinkedBlockingQueue<>(1000)
);

channel.eventLoop().execute(() -> {
    // å¿«é€Ÿä»»åŠ¡åœ¨EventLoopæ‰§è¡Œ
    if (needHeavyWork) {
        // è€—æ—¶ä»»åŠ¡è½¬åˆ°ä¸šåŠ¡çº¿ç¨‹æ± 
        businessExecutor.execute(() -> {
            // æ•°æ®åº“ã€æ–‡ä»¶IOç­‰
        });
    }
});
```

### 6.4 EventLoopæ€§èƒ½ç›‘æ§


**ğŸ“Š å…³é”®æŒ‡æ ‡**ï¼š

```
ç›‘æ§æŒ‡æ ‡ï¼š

1. ä»»åŠ¡é˜Ÿåˆ—é•¿åº¦
   - æŒ‡æ ‡ï¼ševentLoop.pendingTasks()
   - æ­£å¸¸ï¼š< 100
   - å‘Šè­¦ï¼š> 1000

2. EventLoopå¤„ç†æ—¶å»¶
   - æŒ‡æ ‡ï¼šä»»åŠ¡æäº¤åˆ°æ‰§è¡Œçš„æ—¶é—´
   - æ­£å¸¸ï¼š< 10ms
   - å‘Šè­¦ï¼š> 100ms

3. çº¿ç¨‹CPUä½¿ç”¨ç‡
   - æ­£å¸¸ï¼š50% - 80%
   - å‘Šè­¦ï¼š> 90%ï¼ˆå¯èƒ½é˜»å¡ï¼‰
```

**ç›‘æ§ä»£ç ç¤ºä¾‹**ï¼š

```java
public class EventLoopMonitor {
    
    // ç›‘æ§EventLoopçŠ¶æ€
    public void monitor(EventLoop eventLoop) {
        eventLoop.execute(() -> {
            // è·å–å¾…å¤„ç†ä»»åŠ¡æ•°
            int pendingTasks = eventLoop.pendingTasks();
            
            // è·å–çº¿ç¨‹ä¿¡æ¯
            Thread thread = Thread.currentThread();
            ThreadMXBean threadMXBean = ManagementFactory.getThreadMXBean();
            long cpuTime = threadMXBean.getThreadCpuTime(thread.getId());
            
            // è¾“å‡ºç›‘æ§ä¿¡æ¯
            System.out.println("EventLoopç›‘æ§:");
            System.out.println("- å¾…å¤„ç†ä»»åŠ¡: " + pendingTasks);
            System.out.println("- CPUæ—¶é—´: " + cpuTime / 1_000_000 + "ms");
            
            // å‘Šè­¦åˆ¤æ–­
            if (pendingTasks > 1000) {
                System.err.println("âš ï¸ å‘Šè­¦ï¼šä»»åŠ¡é˜Ÿåˆ—ç§¯å‹ä¸¥é‡ï¼");
            }
        });
    }
}
```

::: tip ğŸ’¡ ä¼˜åŒ–å»ºè®®
1. EventLoopåªå¤„ç†IOå’Œè½»é‡ä»»åŠ¡
2. è€—æ—¶æ“ä½œï¼ˆDBã€æ–‡ä»¶ï¼‰ç”¨ç‹¬ç«‹çº¿ç¨‹æ± 
3. å®šæœŸç›‘æ§ä»»åŠ¡é˜Ÿåˆ—é•¿åº¦
4. CPUä½¿ç”¨ç‡è¿‡é«˜è¦æ’æŸ¥é˜»å¡ç‚¹
:::

---

## 7. ğŸŒ ç½‘ç»œIOä¼˜åŒ–æŠ€å·§


### 7.1 IOæ¨¡å‹é€‰æ‹©


**ğŸ“Š Javaçš„IOæ¨¡å‹å¯¹æ¯”**ï¼š

```
BIO (Blocking IO)ï¼š
å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨çº¿ç¨‹ï¼ˆé˜»å¡ç­‰å¾…ï¼‰
ç‰¹ç‚¹ï¼šä¸€ä¸ªè¿æ¥ä¸€ä¸ªçº¿ç¨‹
é—®é¢˜ï¼šé«˜å¹¶å‘æ—¶çº¿ç¨‹çˆ†ç‚¸

    å®¢æˆ·ç«¯1 â”€â”€â”€ çº¿ç¨‹1 (é˜»å¡)
    å®¢æˆ·ç«¯2 â”€â”€â”€ çº¿ç¨‹2 (é˜»å¡)
    å®¢æˆ·ç«¯3 â”€â”€â”€ çº¿ç¨‹3 (é˜»å¡)
    ...1000ä¸ªè¿æ¥ â†’ 1000ä¸ªçº¿ç¨‹ âŒ

NIO (Non-blocking IO)ï¼š
å®¢æˆ·ç«¯ â†’ Selector â†’ å•çº¿ç¨‹å¤„ç†
ç‰¹ç‚¹ï¼šä¸€ä¸ªçº¿ç¨‹ç®¡ç†å¤šä¸ªè¿æ¥
ä¼˜åŠ¿ï¼šé«˜å¹¶å‘æ€§èƒ½å¥½

    å®¢æˆ·ç«¯1 â”
    å®¢æˆ·ç«¯2 â”œâ”€â†’ Selector â†’ çº¿ç¨‹1
    å®¢æˆ·ç«¯3 â”˜
    ...1000ä¸ªè¿æ¥ â†’ 1ä¸ªçº¿ç¨‹ âœ…

AIO (Asynchronous IO)ï¼š
å®¢æˆ·ç«¯ â†’ ç³»ç»Ÿå†…æ ¸ â†’ å›è°ƒé€šçŸ¥
ç‰¹ç‚¹ï¼šå®Œå…¨å¼‚æ­¥
ç°çŠ¶ï¼šNettyæœªä½¿ç”¨ï¼ˆNIOå·²å¤Ÿç”¨ï¼‰
```

**Nettyçš„é€‰æ‹©**ï¼š

| å¹³å° | IOæ¨¡å‹ | å®ç°ç±» | è¯´æ˜ |
|------|--------|--------|------|
| Linux | **Epoll** | `EpollEventLoopGroup` | æ€§èƒ½æœ€ä¼˜ â­ |
| MacOS | Kqueue | `KQueueEventLoopGroup` | æ€§èƒ½å¥½ |
| Windows | IOCP | `NioEventLoopGroup` | é€šç”¨æ–¹æ¡ˆ |

```java
// æ ¹æ®æ“ä½œç³»ç»Ÿé€‰æ‹©æœ€ä¼˜IOæ¨¡å‹
public EventLoopGroup createEventLoopGroup(int threads) {
    String osName = System.getProperty("os.name").toLowerCase();
    
    if (osName.contains("linux")) {
        // Linuxç”¨Epollï¼ˆæœ€ä¼˜ï¼‰
        return new EpollEventLoopGroup(threads);
    } else if (osName.contains("mac")) {
        // Macç”¨KQueue
        return new KQueueEventLoopGroup(threads);
    } else {
        // Windowsç”¨NIO
        return new NioEventLoopGroup(threads);
    }
}

// å¯¹åº”çš„Channelç±»å‹
if (osName.contains("linux")) {
    bootstrap.channel(EpollServerSocketChannel.class);
} else {
    bootstrap.channel(NioServerSocketChannel.class);
}
```

### 7.2 é›¶æ‹·è´æŠ€æœ¯


**ğŸ” ä»€ä¹ˆæ˜¯é›¶æ‹·è´**ï¼š

```
ä¼ ç»ŸIOï¼ˆ4æ¬¡æ‹·è´ï¼‰ï¼š
                    
ç£ç›˜ â†’ å†…æ ¸ç¼“å†²åŒº â†’ åº”ç”¨ç¼“å†²åŒº â†’ Socketç¼“å†²åŒº â†’ ç½‘å¡
     (æ‹·è´1)      (æ‹·è´2)      (æ‹·è´3)       (æ‹·è´4)

é›¶æ‹·è´ï¼ˆ2æ¬¡æ‹·è´ï¼‰ï¼š
                    
ç£ç›˜ â†’ å†…æ ¸ç¼“å†²åŒº â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ ç½‘å¡
     (æ‹·è´1)                      (æ‹·è´2)
     
çœç•¥äº†2æ¬¡CPUæ‹·è´ï¼æ€§èƒ½æå‡æ˜æ˜¾
```

**Nettyé›¶æ‹·è´å®ç°**ï¼š

#### æ–¹å¼1ï¼šFileRegionï¼ˆæ–‡ä»¶ä¼ è¾“ï¼‰

```java
// ä¼ ç»Ÿæ–¹å¼ï¼ˆæœ‰æ‹·è´ï¼‰
byte[] bytes = Files.readAllBytes(Paths.get("file.txt"));
channel.writeAndFlush(Unpooled.wrappedBuffer(bytes));

// é›¶æ‹·è´æ–¹å¼ï¼ˆFileRegionï¼‰
File file = new File("file.txt");
FileRegion region = new DefaultFileRegion(
    new FileInputStream(file).getChannel(),
    0,                    // èµ·å§‹ä½ç½®
    file.length()         // ä¼ è¾“é•¿åº¦
);
channel.writeAndFlush(region);

// æ€§èƒ½å¯¹æ¯”ï¼š
// 100MBæ–‡ä»¶ä¼ è¾“
// ä¼ ç»Ÿæ–¹å¼ï¼š150msï¼ˆæœ‰æ‹·è´ï¼‰
// é›¶æ‹·è´ï¼š  50ms ï¼ˆå‡å°‘2/3æ—¶é—´ï¼‰
```

#### æ–¹å¼2ï¼šCompositeByteBufï¼ˆç»„åˆBufferï¼‰

```java
// ä¼ ç»Ÿæ–¹å¼ï¼ˆéœ€è¦æ‹·è´åˆå¹¶ï¼‰
ByteBuf header = ...;
ByteBuf body = ...;
ByteBuf merged = Unpooled.buffer(header.readableBytes() + body.readableBytes());
merged.writeBytes(header);  // æ‹·è´1
merged.writeBytes(body);    // æ‹·è´2

// é›¶æ‹·è´æ–¹å¼ï¼ˆCompositeByteBufï¼‰
CompositeByteBuf composite = Unpooled.compositeBuffer();
composite.addComponent(true, header);  // ä¸æ‹·è´ï¼Œåªå¼•ç”¨
composite.addComponent(true, body);    // ä¸æ‹·è´ï¼Œåªå¼•ç”¨
channel.writeAndFlush(composite);
```

#### æ–¹å¼3ï¼šByteBuf.slice()ï¼ˆåˆ‡ç‰‡ï¼‰

```java
// ä¼ ç»Ÿæ–¹å¼ï¼ˆæ‹·è´ï¼‰
ByteBuf source = ...;
ByteBuf part = Unpooled.buffer(100);
source.readBytes(part);  // æ‹·è´æ•°æ®

// é›¶æ‹·è´æ–¹å¼ï¼ˆsliceï¼‰
ByteBuf slice = source.slice(0, 100);  // å…±äº«å†…å­˜ï¼Œä¸æ‹·è´
```

### 7.3 æ‰¹é‡å†™å…¥ä¼˜åŒ–


**é—®é¢˜åœºæ™¯**ï¼š
```
é—®é¢˜ï¼šé¢‘ç¹è°ƒç”¨write()ï¼Œç³»ç»Ÿè°ƒç”¨å¼€é”€å¤§

é”™è¯¯ç¤ºèŒƒï¼š
for (int i = 0; i < 1000; i++) {
    channel.write(data[i]);      // 1000æ¬¡ç³»ç»Ÿè°ƒç”¨
    channel.flush();              // 1000æ¬¡åˆ·æ–°
}
// æ€§èƒ½ï¼šå¾ˆå·® âŒ

ä¼˜åŒ–æ–¹æ¡ˆ1ï¼šæ‰¹é‡åˆ·æ–°
for (int i = 0; i < 1000; i++) {
    channel.write(data[i]);       // å…ˆç§¯ç´¯
}
channel.flush();                  // ä¸€æ¬¡æ€§åˆ·æ–°
// æ€§èƒ½ï¼šæå‡10å€ âœ…

ä¼˜åŒ–æ–¹æ¡ˆ2ï¼šä½¿ç”¨writeAndFlush
for (int i = 0; i < 1000; i++) {
    if (i == 999) {
        channel.writeAndFlush(data[i]);  // æœ€åä¸€æ¬¡æ‰flush
    } else {
        channel.write(data[i]);
    }
}
```

**é«˜çº§ä¼˜åŒ–ï¼šChannelOutboundBuffer**

```java
// Nettyå†…éƒ¨çš„æ‰¹é‡å†™å…¥æœºåˆ¶
public class BatchWriteHandler extends ChannelOutboundHandlerAdapter {
    
    private List<Object> batch = new ArrayList<>();
    private static final int BATCH_SIZE = 100;
    
    @Override
    public void write(ChannelHandlerContext ctx, Object msg, ChannelPromise promise) {
        batch.add(msg);
        
        // æ”’å¤Ÿä¸€æ‰¹å†å†™
        if (batch.size() >= BATCH_SIZE) {
            flushBatch(ctx);
        }
    }
    
    @Override
    public void flush(ChannelHandlerContext ctx) {
        flushBatch(ctx);
    }
    
    private void flushBatch(ChannelHandlerContext ctx) {
        if (!batch.isEmpty()) {
            for (Object msg : batch) {
                ctx.write(msg);
            }
            ctx.flush();
            batch.clear();
        }
    }
}
```

### 7.4 è¿æ¥ä¼˜åŒ–


**è¿æ¥æ± ç®¡ç†**ï¼š

```java
// å®¢æˆ·ç«¯è¿æ¥æ± ï¼ˆé¿å…é¢‘ç¹åˆ›å»ºè¿æ¥ï¼‰
public class NettyClientPool {
    
    private Channel[] channels;
    private AtomicInteger counter = new AtomicInteger(0);
    
    public NettyClientPool(int poolSize) {
        channels = new Channel[poolSize];
        Bootstrap bootstrap = new Bootstrap();
        // ... bootstrapé…ç½®
        
        // é¢„åˆ›å»ºè¿æ¥
        for (int i = 0; i < poolSize; i++) {
            channels[i] = bootstrap.connect(host, port)
                .syncUninterruptibly()
                .channel();
        }
    }
    
    // è½®è¯¢è·å–è¿æ¥
    public Channel getChannel() {
        int index = Math.abs(counter.getAndIncrement() % channels.length);
        return channels[index];
    }
}

// ä½¿ç”¨è¿æ¥æ± 
NettyClientPool pool = new NettyClientPool(10);  // 10ä¸ªè¿æ¥
Channel channel = pool.getChannel();
channel.writeAndFlush(request);
```

**ç©ºé—²è¿æ¥æ£€æµ‹**ï¼š

```java
// è‡ªåŠ¨æ¸…ç†ç©ºé—²è¿æ¥
pipeline.addLast(new IdleStateHandler(
    60,  // è¯»ç©ºé—²ï¼š60ç§’æ²¡è¯»åˆ°æ•°æ®
    30,  // å†™ç©ºé—²ï¼š30ç§’æ²¡å†™æ•°æ®
    0    // è¯»å†™ç©ºé—²ï¼šä¸æ£€æµ‹
));

pipeline.addLast(new ChannelInboundHandlerAdapter() {
    @Override
    public void userEventTriggered(ChannelHandlerContext ctx, Object evt) {
        if (evt instanceof IdleStateEvent) {
            IdleStateEvent event = (IdleStateEvent) evt;
            
            if (event.state() == IdleState.READER_IDLE) {
                // è¯»ç©ºé—²ï¼Œå…³é—­è¿æ¥
                System.out.println("è¿æ¥ç©ºé—²ï¼Œå…³é—­: " + ctx.channel());
                ctx.close();
            } else if (event.state() == IdleState.WRITER_IDLE) {
                // å†™ç©ºé—²ï¼Œå‘é€å¿ƒè·³
                ctx.writeAndFlush(heartbeatMsg);
            }
        }
    }
});
```

### 7.5 å‹ç¼©ä¼˜åŒ–


**HTTPå‹ç¼©**ï¼š

```java
// å¯ç”¨HTTPå‹ç¼©ï¼ˆå‡å°‘ä¼ è¾“æ•°æ®é‡ï¼‰
pipeline.addLast(new HttpContentCompressor(6));  // å‹ç¼©çº§åˆ«1-9

// æ•ˆæœæ¼”ç¤ºï¼š
// åŸå§‹JSONï¼š100KB
// Gzipå‹ç¼©åï¼š15KB ï¼ˆå‹ç¼©ç‡85%ï¼‰
// ä¼ è¾“æ—¶é—´ï¼šä» 200ms é™åˆ° 50ms
```

**è‡ªå®šä¹‰å‹ç¼©**ï¼š

```java
// è‡ªå®šä¹‰å‹ç¼©Handler
public class GzipEncoder extends MessageToByteEncoder<ByteBuf> {
    
    @Override
    protected void encode(ChannelHandlerContext ctx, ByteBuf msg, ByteBuf out) {
        byte[] data = new byte[msg.readableBytes()];
        msg.readBytes(data);
        
        // Gzipå‹ç¼©
        ByteArrayOutputStream baos = new ByteArrayOutputStream();
        try (GZIPOutputStream gzip = new GZIPOutputStream(baos)) {
            gzip.write(data);
        }
        
        byte[] compressed = baos.toByteArray();
        out.writeBytes(compressed);
        
        // å‹ç¼©ç‡ç›‘æ§
        double ratio = 1.0 - (double) compressed.length / data.length;
        System.out.println("å‹ç¼©ç‡: " + (ratio * 100) + "%");
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Bossçº¿ç¨‹ï¼šä¸“èŒæ¥æ”¶æ–°è¿æ¥ï¼Œæ•°é‡ = ç›‘å¬ç«¯å£æ•°
ğŸ”¸ Workerçº¿ç¨‹ï¼šå¤„ç†æ•°æ®è¯»å†™ï¼Œæ•°é‡ = CPUæ ¸å¿ƒæ•° Ã— 2
ğŸ”¸ ChannelOptionï¼šåº•å±‚TCPå‚æ•°ï¼Œç›´æ¥å½±å“æ€§èƒ½
ğŸ”¸ ByteBufï¼šNettyæ ¸å¿ƒå†…å­˜æ¨¡å‹ï¼Œæ± åŒ–æ˜¯å…³é”®
ğŸ”¸ EventLoopï¼šäº‹ä»¶å¾ªç¯ï¼Œä¸èƒ½é˜»å¡
ğŸ”¸ é›¶æ‹·è´ï¼šå‡å°‘æ•°æ®æ‹·è´ï¼Œæå‡æ€§èƒ½
```

### 8.2 è°ƒä¼˜é…ç½®é€ŸæŸ¥è¡¨


**é«˜æ€§èƒ½é…ç½®æ¨¡æ¿**ï¼š

```java
// === çº¿ç¨‹é…ç½® ===
EventLoopGroup bossGroup = new NioEventLoopGroup(1);
EventLoopGroup workerGroup = new NioEventLoopGroup(
    Runtime.getRuntime().availableProcessors() * 2
);

// === åŸºç¡€é…ç½® ===
ServerBootstrap bootstrap = new ServerBootstrap();
bootstrap.group(bossGroup, workerGroup)
    .channel(NioServerSocketChannel.class)
    
    // === ChannelOptioné…ç½® ===
    .option(ChannelOption.SO_BACKLOG, 1024)                    // â­ è¿æ¥é˜Ÿåˆ—
    .childOption(ChannelOption.TCP_NODELAY, true)              // â­ ç¦ç”¨Nagle
    .childOption(ChannelOption.SO_KEEPALIVE, true)             // â­ ä¿æ´»
    .childOption(ChannelOption.SO_RCVBUF, 128 * 1024)          // æ¥æ”¶ç¼“å†²
    .childOption(ChannelOption.SO_SNDBUF, 128 * 1024)          // å‘é€ç¼“å†²
    .childOption(ChannelOption.ALLOCATOR,                      // â­ å†…å­˜æ± 
        PooledByteBufAllocator.DEFAULT)
    
    .childHandler(new ChannelInitializer<SocketChannel>() {
        @Override
        protected void initChannel(SocketChannel ch) {
            ch.pipeline()
                // ç©ºé—²æ£€æµ‹
                .addLast(new IdleStateHandler(60, 30, 0))
                // HTTPç¼–è§£ç 
                .addLast(new HttpServerCodec())
                // å‹ç¼©
                .addLast(new HttpContentCompressor())
                // ä¸šåŠ¡å¤„ç†
                .addLast(businessExecutor, new BusinessHandler());
        }
    });
```

### 8.3 å¸¸è§é—®é¢˜æ’æŸ¥


**é—®é¢˜1ï¼šè¿æ¥è¢«æ‹’ç»**
```
ç°è±¡ï¼šConnection refused
åŸå› ï¼šSO_BACKLOGå¤ªå°
è§£å†³ï¼šå¢å¤§SO_BACKLOGåˆ°1024æˆ–æ›´å¤§
```

**é—®é¢˜2ï¼šå»¶è¿Ÿé«˜**
```
ç°è±¡ï¼šå“åº”æ…¢ï¼ŒRTé«˜
åŸå› ï¼šTCP_NODELAY = falseï¼ˆNagleç®—æ³•ï¼‰
è§£å†³ï¼šè®¾ç½® TCP_NODELAY = true
```

**é—®é¢˜3ï¼šå†…å­˜æ³„æ¼**
```
ç°è±¡ï¼šå†…å­˜æŒç»­å¢é•¿ï¼ŒGCé¢‘ç¹
åŸå› ï¼šByteBufæ²¡æœ‰æ­£ç¡®é‡Šæ”¾
è§£å†³ï¼š
1. å¯ç”¨æ³„æ¼æ£€æµ‹ï¼š-Dio.netty.leakDetection.level=ADVANCED
2. æ£€æŸ¥release()è°ƒç”¨
3. ä½¿ç”¨æ± åŒ–å†…å­˜
```

**é—®é¢˜4ï¼šCPUä½¿ç”¨ç‡é«˜**
```
ç°è±¡ï¼šCPU 100%
åŸå› ï¼šEventLoopè¢«é˜»å¡
è§£å†³ï¼š
1. æ£€æŸ¥æ˜¯å¦æœ‰è€—æ—¶æ“ä½œ
2. å°†DBã€æ–‡ä»¶IOç§»åˆ°ä¸šåŠ¡çº¿ç¨‹æ± 
3. ç›‘æ§ä»»åŠ¡é˜Ÿåˆ—é•¿åº¦
```

### 8.4 æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥æ¸…å•


**ğŸ¯ éƒ¨ç½²å‰æ£€æŸ¥**ï¼š
- [ ] Bossçº¿ç¨‹æ•° = ç›‘å¬ç«¯å£æ•°
- [ ] Workerçº¿ç¨‹æ•° = CPUæ ¸å¿ƒæ•° Ã— 2
- [ ] å¯ç”¨TCP_NODELAY
- [ ] å¯ç”¨SO_KEEPALIVEï¼ˆé•¿è¿æ¥åœºæ™¯ï¼‰
- [ ] ä½¿ç”¨æ± åŒ–ByteBuf
- [ ] é…ç½®åˆç†çš„SO_BACKLOG
- [ ] è€—æ—¶æ“ä½œä½¿ç”¨ç‹¬ç«‹çº¿ç¨‹æ± 
- [ ] å¯ç”¨å†…å­˜æ³„æ¼æ£€æµ‹ï¼ˆæµ‹è¯•ç¯å¢ƒï¼‰
- [ ] è€ƒè™‘ä½¿ç”¨Epollï¼ˆLinuxç¯å¢ƒï¼‰
- [ ] å¯ç”¨HTTPå‹ç¼©

**ğŸ“Š ç›‘æ§æŒ‡æ ‡**ï¼š
- ğŸ‘€ **è¿æ¥æ•°**ï¼šå½“å‰æ´»è·ƒè¿æ¥
- ğŸ“ˆ **QPS**ï¼šæ¯ç§’è¯·æ±‚æ•°
- â±ï¸ **RT**ï¼šå¹³å‡å“åº”æ—¶é—´
- ğŸ’¾ **å†…å­˜**ï¼šå †å†…å­˜ã€ç›´æ¥å†…å­˜ä½¿ç”¨ç‡
- ğŸ”„ **GC**ï¼šGCé¢‘ç‡å’Œæ—¶é•¿
- ğŸ“Š **CPU**ï¼šä½¿ç”¨ç‡å’Œè´Ÿè½½

### 8.5 è¿›é˜¶ä¼˜åŒ–æ–¹å‘


**ğŸš€ æ€§èƒ½æè‡´ä¼˜åŒ–**ï¼š
```
1. ä½¿ç”¨Epollï¼ˆLinuxï¼‰
   - æ€§èƒ½æ¯”NIOæå‡30%
   - é…ç½®ï¼šEpollEventLoopGroup

2. é›¶æ‹·è´æŠ€æœ¯
   - FileRegionï¼šæ–‡ä»¶ä¼ è¾“
   - CompositeByteBufï¼šç»„åˆBuffer
   - slice()ï¼šå…±äº«å†…å­˜

3. å¯¹è±¡æ± 
   - ByteBufæ± åŒ–
   - Handlerå¯¹è±¡å¤ç”¨
   - è‡ªå®šä¹‰å¯¹è±¡æ± 

4. æ‰¹é‡æ“ä½œ
   - æ‰¹é‡å†™å…¥
   - æ‰¹é‡è¯»å–
   - åˆå¹¶å°åŒ…

5. å†…å­˜ä¼˜åŒ–
   - ç›´æ¥å†…å­˜
   - å†…å­˜é¢„åˆ†é…
   - å‡å°‘GC
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
Bossä¸€ä¸ªå¤Ÿï¼ŒWorkeræŒ‰æ ¸ç®—
TCPè°ƒä¼˜è®°ä¸‰ç‚¹ï¼šBacklogã€NodeDelayã€KeepAlive
å†…å­˜ç”¨æ± åŒ–ï¼Œé‡Šæ”¾è¦è®°ç‰¢
EventLoopåˆ«é˜»å¡ï¼Œè€—æ—¶æ‰”çº¿ç¨‹æ± 
é›¶æ‹·è´ææ€§èƒ½ï¼Œæ‰¹é‡å†™æ›´å¿«
ç›‘æ§å…¨æ–¹ä½ï¼Œé—®é¢˜æ—©å‘ç°
```

::: tip ğŸ¯ æœ€ç»ˆå»ºè®®
1. **ä¸è¦è¿‡æ—©ä¼˜åŒ–**ï¼šå…ˆè®©ç³»ç»Ÿè·‘èµ·æ¥ï¼Œå†æ ¹æ®ç›‘æ§æ•°æ®è°ƒä¼˜
2. **ä¸€æ¬¡æ”¹ä¸€ä¸ªå‚æ•°**ï¼šæ–¹ä¾¿å®šä½å“ªä¸ªå‚æ•°æœ‰æ•ˆ
3. **å‹æµ‹éªŒè¯**ï¼šæ¯æ¬¡è°ƒä¼˜åéƒ½è¦å‹æµ‹å¯¹æ¯”
4. **ç›‘æ§å…ˆè¡Œ**ï¼šå®Œå–„çš„ç›‘æ§æ¯”ç›²ç›®è°ƒä¼˜æ›´é‡è¦
5. **æŒç»­å­¦ä¹ **ï¼šå…³æ³¨Nettyæ–°ç‰ˆæœ¬ç‰¹æ€§å’Œæœ€ä½³å®è·µ
:::

---

**æ­å–œä½ å®ŒæˆNettyè°ƒä¼˜å­¦ä¹ ï¼** ğŸ‰

ç°åœ¨ä½ å·²ç»æŒæ¡äº†ï¼š
- âœ… Bosså’ŒWorkerçº¿ç¨‹çš„é…ç½®
- âœ… ChannelOptionå‚æ•°çš„å«ä¹‰
- âœ… ByteBufå†…å­˜ç®¡ç†
- âœ… EventLoopä¼˜åŒ–ç­–ç•¥
- âœ… ç½‘ç»œIOä¼˜åŒ–æŠ€å·§

**ä¸‹ä¸€æ­¥**ï¼š
- ğŸ“– å®æˆ˜ç»ƒä¹ ï¼šæ­å»ºé«˜æ€§èƒ½APIç½‘å…³
- ğŸ”¬ å‹æµ‹éªŒè¯ï¼šå¯¹æ¯”ä¼˜åŒ–å‰åæ€§èƒ½
- ğŸ“Š ç›‘æ§å®è·µï¼šæ­å»ºå®Œæ•´ç›‘æ§ä½“ç³»