---
title: 4ã€å…¨å±€è¿‡æ»¤å™¨å®ç°
---
## ğŸ“š ç›®å½•

1. [å…¨å±€è¿‡æ»¤å™¨æ ¸å¿ƒæ¦‚å¿µ](#1-å…¨å±€è¿‡æ»¤å™¨æ ¸å¿ƒæ¦‚å¿µ)
2. [GlobalFilteræ¥å£å®ç°](#2-GlobalFilteræ¥å£å®ç°)
3. [è¿‡æ»¤å™¨æ‰§è¡Œé¡ºåºæ§åˆ¶](#3-è¿‡æ»¤å™¨æ‰§è¡Œé¡ºåºæ§åˆ¶)
4. [è·¨åŸŸCORSå¤„ç†](#4-è·¨åŸŸCORSå¤„ç†)
5. [å…¨å±€æ—¥å¿—è®°å½•](#5-å…¨å±€æ—¥å¿—è®°å½•)
6. [å…¨å±€å¼‚å¸¸å¤„ç†](#6-å…¨å±€å¼‚å¸¸å¤„ç†)
7. [è¯·æ±‚å“åº”ä¿®æ”¹](#7-è¯·æ±‚å“åº”ä¿®æ”¹)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ å…¨å±€è¿‡æ»¤å™¨æ ¸å¿ƒæ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯å…¨å±€è¿‡æ»¤å™¨


**å¤§ç™½è¯ç†è§£**ï¼š
æƒ³è±¡ä¸€ä¸‹ä½ åœ¨å•†åœºå…¥å£ï¼Œæ‰€æœ‰è¿›å‡ºçš„äººéƒ½è¦ç»è¿‡å®‰æ£€é—¨ã€‚å…¨å±€è¿‡æ»¤å™¨å°±åƒè¿™ä¸ªå®‰æ£€é—¨ï¼Œ**æ‰€æœ‰ç»è¿‡ç½‘å…³çš„è¯·æ±‚**éƒ½ä¼šè¢«å®ƒæ‹¦ä¸‹æ¥æ£€æŸ¥ä¸€éã€‚

```
æ­£å¸¸æµç¨‹ï¼š
å®¢æˆ·ç«¯ â†’ ç½‘å…³ â†’ å¾®æœåŠ¡A
         â†“       â†“ 
      ç›´æ¥æ”¾è¡Œ  ç›´æ¥è®¿é—®

ä½¿ç”¨å…¨å±€è¿‡æ»¤å™¨ï¼š
å®¢æˆ·ç«¯ â†’ ç½‘å…³ â†’ [å…¨å±€è¿‡æ»¤å™¨æ£€æŸ¥] â†’ å¾®æœåŠ¡A
                   â†“
              âœ… æ£€æŸ¥é€šè¿‡ï¼Œæ”¾è¡Œ
              âŒ æ£€æŸ¥å¤±è´¥ï¼Œæ‹¦æˆª
```

### 1.2 å…¨å±€è¿‡æ»¤å™¨ vs å±€éƒ¨è¿‡æ»¤å™¨


**æ ¸å¿ƒåŒºåˆ«**ï¼š

| å¯¹æ¯”ç»´åº¦ | **å…¨å±€è¿‡æ»¤å™¨ï¼ˆGlobalFilterï¼‰** | **å±€éƒ¨è¿‡æ»¤å™¨ï¼ˆGatewayFilterï¼‰** |
|---------|---------------------------|----------------------------|
| ğŸ“ **ä½œç”¨èŒƒå›´** | `æ‰€æœ‰è·¯ç”±éƒ½ç”Ÿæ•ˆ` | `åªå¯¹æŒ‡å®šè·¯ç”±ç”Ÿæ•ˆ` |
| ğŸ¯ **ä½¿ç”¨åœºæ™¯** | `ç»Ÿä¸€çš„æ—¥å¿—ã€é‰´æƒã€è·¨åŸŸ` | `ç‰¹å®šè·¯ç”±çš„ä¸ªæ€§åŒ–å¤„ç†` |
| ğŸ’» **é…ç½®æ–¹å¼** | `å†™ä»£ç ï¼Œè‡ªåŠ¨ç”Ÿæ•ˆ` | `é…ç½®æ–‡ä»¶æˆ–ä»£ç æŒ‡å®š` |
| ğŸ”¢ **æ•°é‡** | `é€šå¸¸å‡ ä¸ªæ ¸å¿ƒè¿‡æ»¤å™¨` | `å¯ä»¥å¾ˆå¤šä¸ª` |

**ç”Ÿæ´»ç±»æ¯”**ï¼š
- **å…¨å±€è¿‡æ»¤å™¨**ï¼šå°±åƒå°åŒºå¤§é—¨çš„ä¿å®‰ï¼Œæ‰€æœ‰äººè¿›å‡ºéƒ½è¦æ£€æŸ¥
- **å±€éƒ¨è¿‡æ»¤å™¨**ï¼šå°±åƒæŸæ ‹æ¥¼çš„é—¨ç¦ï¼Œåªæœ‰è¿›è¿™æ ‹æ¥¼çš„äººæ‰éœ€è¦åˆ·å¡

### 1.3 å…¨å±€è¿‡æ»¤å™¨çš„å·¥ä½œåŸç†


**æ‰§è¡Œæµç¨‹å›¾**ï¼š

```
è¯·æ±‚è¿›æ¥                                      å“åº”è¿”å›
   â†“                                            â†‘
[å…¨å±€è¿‡æ»¤å™¨1] ----â†’ preå¤„ç†é€»è¾‘ ----â†’ [è°ƒç”¨ä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨]
   â†“                                            â†‘
[å…¨å±€è¿‡æ»¤å™¨2] ----â†’ preå¤„ç†é€»è¾‘ ----â†’ [è°ƒç”¨ä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨]
   â†“                                            â†‘
[è·¯ç”±åˆ°å¾®æœåŠ¡] â†------ è·å–å“åº” â†------ [å¾®æœåŠ¡å¤„ç†]
   â†“                                            â†‘
[å…¨å±€è¿‡æ»¤å™¨2] ----â†’ postå¤„ç†é€»è¾‘ ----â†’ [è¿”å›ä¸Šä¸€å±‚]
   â†“                                            â†‘
[å…¨å±€è¿‡æ»¤å™¨1] ----â†’ postå¤„ç†é€»è¾‘ ----â†’ [æœ€ç»ˆè¿”å›]
```

**å…³é”®ç†è§£**ï¼š
- ğŸ”¸ **è´£ä»»é“¾æ¨¡å¼**ï¼šä¸€ä¸ªè¿‡æ»¤å™¨å¤„ç†å®Œï¼Œäº¤ç»™ä¸‹ä¸€ä¸ª
- ğŸ”¸ **åŒå‘å¤„ç†**ï¼šè¯·æ±‚è¿›æ¥æ—¶å¤„ç†ï¼ˆpreï¼‰ï¼Œå“åº”è¿”å›æ—¶ä¹Ÿå¤„ç†ï¼ˆpostï¼‰
- ğŸ”¸ **å¯ä¸­æ–­**ï¼šä»»ä½•è¿‡æ»¤å™¨éƒ½å¯ä»¥ç›´æ¥è¿”å›å“åº”ï¼Œä¸å†å¾€ä¸‹ä¼ 

---

## 2. ğŸ’¡ GlobalFilteræ¥å£å®ç°


### 2.1 GlobalFilteræ¥å£è¯¦è§£


**æ¥å£å®šä¹‰**ï¼š
```java
public interface GlobalFilter {
    Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain);
}
```

**å‚æ•°å«ä¹‰è§£é‡Š**ï¼š

ğŸ”¹ **ServerWebExchange**ï¼š
- ç†è§£ä¸ºä¸€ä¸ª**å¤§ç›’å­**ï¼Œè£…ç€æœ¬æ¬¡è¯·æ±‚çš„æ‰€æœ‰ä¿¡æ¯
- å¯ä»¥ä»é‡Œé¢æ‹¿åˆ°ï¼šè¯·æ±‚å¯¹è±¡ã€å“åº”å¯¹è±¡ã€è¯·æ±‚å¤´ã€è¯·æ±‚å‚æ•°ç­‰
- å°±åƒå¿«é€’å‘˜æ‰‹é‡Œçš„åŒ…è£¹å•ï¼Œè®°å½•äº†æ‰€æœ‰ä¿¡æ¯

ğŸ”¹ **GatewayFilterChain**ï¼š
- ç†è§£ä¸º**è¿‡æ»¤å™¨é“¾æ¡**ï¼Œæ§åˆ¶æµç¨‹å¾€ä¸‹èµ°
- è°ƒç”¨ `chain.filter(exchange)` = å‘Šè¯‰ä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨"è¯¥ä½ äº†"
- å°±åƒæ¥åŠ›èµ›ä¼ æ£’å­ï¼Œå¿…é¡»ä¸»åŠ¨ä¼ ç»™ä¸‹ä¸€ä¸ªäºº

ğŸ”¹ **Mono<Void>**ï¼š
- è¿™æ˜¯å“åº”å¼ç¼–ç¨‹çš„è¿”å›ç±»å‹
- ç®€å•ç†è§£ï¼šè¡¨ç¤ºè¿™ä¸ªæ“ä½œ**ä¸ç›´æ¥è¿”å›ç»“æœï¼Œè€Œæ˜¯å¼‚æ­¥æ‰§è¡Œ**
- å°±åƒä½ ç‚¹å¤–å–ï¼Œä¸ä¼šåœ¨é—¨å£å¹²ç­‰ï¼Œè€Œæ˜¯å…ˆå»å¿™åˆ«çš„

### 2.2 æœ€ç®€å•çš„å…¨å±€è¿‡æ»¤å™¨å®ç°


```java
@Component  // æ³¨å†Œä¸ºSpringç»„ä»¶ï¼Œç½‘å…³ä¼šè‡ªåŠ¨è¯†åˆ«
public class MyFirstGlobalFilter implements GlobalFilter {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        
        // 1ï¸âƒ£ å‰ç½®å¤„ç†ï¼šè¯·æ±‚è¿›æ¥æ—¶æ‰§è¡Œ
        System.out.println("è¯·æ±‚è·¯å¾„ï¼š" + exchange.getRequest().getPath());
        
        // 2ï¸âƒ£ è°ƒç”¨ä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨ï¼ˆå¿…é¡»è°ƒç”¨ï¼Œå¦åˆ™è¯·æ±‚ä¸­æ–­ï¼‰
        return chain.filter(exchange).then(
            // 3ï¸âƒ£ åç½®å¤„ç†ï¼šå“åº”è¿”å›æ—¶æ‰§è¡Œ
            Mono.fromRunnable(() -> {
                System.out.println("å“åº”çŠ¶æ€ï¼š" + exchange.getResponse().getStatusCode());
            })
        );
    }
}
```

**ä»£ç è§£è¯»**ï¼š
- âœ… `@Component`ï¼šè®©Springå®¹å™¨ç®¡ç†ï¼Œç½‘å…³å¯åŠ¨æ—¶è‡ªåŠ¨åŠ è½½
- âœ… å‰ç½®é€»è¾‘ï¼šåœ¨ `chain.filter()` **ä¹‹å‰**æ‰§è¡Œ
- âœ… åç½®é€»è¾‘ï¼šåœ¨ `.then()` **é‡Œé¢**æ‰§è¡Œ
- âœ… `chain.filter(exchange)`ï¼š**å¿…é¡»è°ƒç”¨**ï¼Œå¦åˆ™è¯·æ±‚åˆ°æ­¤ä¸ºæ­¢

### 2.3 è·å–è¯·æ±‚ä¿¡æ¯çš„å¸¸ç”¨æ–¹æ³•


```java
@Component
public class RequestInfoFilter implements GlobalFilter {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        
        // ğŸ“ è·å–è¯·æ±‚å¯¹è±¡
        ServerHttpRequest request = exchange.getRequest();
        
        // ğŸ”¹ è·å–è¯·æ±‚è·¯å¾„
        String path = request.getPath().value();
        System.out.println("è¯·æ±‚è·¯å¾„ï¼š" + path);
        
        // ğŸ”¹ è·å–è¯·æ±‚æ–¹æ³•ï¼ˆGETã€POSTç­‰ï¼‰
        String method = request.getMethodValue();
        System.out.println("è¯·æ±‚æ–¹æ³•ï¼š" + method);
        
        // ğŸ”¹ è·å–è¯·æ±‚å¤´
        String token = request.getHeaders().getFirst("Authorization");
        System.out.println("Tokenï¼š" + token);
        
        // ğŸ”¹ è·å–è¯·æ±‚å‚æ•°
        String userId = request.getQueryParams().getFirst("userId");
        System.out.println("ç”¨æˆ·IDï¼š" + userId);
        
        // ğŸ”¹ è·å–å®¢æˆ·ç«¯IP
        String ip = request.getRemoteAddress().getHostString();
        System.out.println("å®¢æˆ·ç«¯IPï¼š" + ip);
        
        return chain.filter(exchange);
    }
}
```

---

## 3. ğŸ”¢ è¿‡æ»¤å™¨æ‰§è¡Œé¡ºåºæ§åˆ¶


### 3.1 ä¸ºä»€ä¹ˆéœ€è¦æ§åˆ¶é¡ºåº


**å®é™…åœºæ™¯**ï¼š
```
å‡è®¾æœ‰3ä¸ªå…¨å±€è¿‡æ»¤å™¨ï¼š
1. æ—¥å¿—è¿‡æ»¤å™¨ - è®°å½•è¯·æ±‚ä¿¡æ¯
2. é‰´æƒè¿‡æ»¤å™¨ - æ£€æŸ¥ç”¨æˆ·æƒé™  
3. é™æµè¿‡æ»¤å™¨ - æ§åˆ¶è®¿é—®é¢‘ç‡

âŒ é”™è¯¯é¡ºåºï¼šé™æµ â†’ é‰´æƒ â†’ æ—¥å¿—
   é—®é¢˜ï¼šéæ³•è¯·æ±‚ä¹Ÿæ¶ˆè€—äº†é™æµé…é¢

âœ… æ­£ç¡®é¡ºåºï¼šæ—¥å¿— â†’ é‰´æƒ â†’ é™æµ
   é€»è¾‘ï¼šå…ˆè®°å½•ï¼Œå†éªŒæƒï¼Œæœ€åé™æµ
```

### 3.2 Orderedæ¥å£å®ç°æ’åº


**æ–¹å¼ä¸€ï¼šå®ç°Orderedæ¥å£**

```java
@Component
public class LogFilter implements GlobalFilter, Ordered {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        System.out.println("1ï¸âƒ£ æ—¥å¿—è¿‡æ»¤å™¨æ‰§è¡Œ");
        return chain.filter(exchange);
    }
    
    @Override
    public int getOrder() {
        return 1;  // æ•°å­—è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼Œè¶Šå…ˆæ‰§è¡Œ
    }
}

@Component
public class AuthFilter implements GlobalFilter, Ordered {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        System.out.println("2ï¸âƒ£ é‰´æƒè¿‡æ»¤å™¨æ‰§è¡Œ");
        return chain.filter(exchange);
    }
    
    @Override
    public int getOrder() {
        return 2;  // ç¬¬äºŒä¸ªæ‰§è¡Œ
    }
}
```

**æ–¹å¼äºŒï¼šä½¿ç”¨@Orderæ³¨è§£**

```java
@Component
@Order(1)  // æœ€å…ˆæ‰§è¡Œ
public class LogFilter implements GlobalFilter {
    // ... è¿‡æ»¤å™¨é€»è¾‘
}

@Component
@Order(2)  // ç¬¬äºŒä¸ªæ‰§è¡Œ
public class AuthFilter implements GlobalFilter {
    // ... è¿‡æ»¤å™¨é€»è¾‘
}
```

### 3.3 æ‰§è¡Œé¡ºåºçš„æ ¸å¿ƒè§„åˆ™


**ä¼˜å…ˆçº§è§„åˆ™**ï¼š

| æ•°å€¼èŒƒå›´ | **ä¼˜å…ˆçº§** | **æ‰§è¡Œæ—¶æœº** | **å¸¸ç”¨åœºæ™¯** |
|---------|----------|------------|------------|
| `è´Ÿæ•°ï¼ˆ-100ï¼‰` | `æœ€é«˜` | `æœ€å…ˆæ‰§è¡Œ` | `æ—¥å¿—è®°å½•ã€è¯·æ±‚IDç”Ÿæˆ` |
| `0-100` | `é«˜` | `è¾ƒæ—©æ‰§è¡Œ` | `é‰´æƒã€ç­¾åéªŒè¯` |
| `100-1000` | `ä¸­` | `ä¸­é—´æ‰§è¡Œ` | `é™æµã€ç†”æ–­` |
| `1000+` | `ä½` | `æœ€åæ‰§è¡Œ` | `å“åº”ä¿®æ”¹ã€ç»Ÿè®¡` |

> ğŸ’¡ **è®°å¿†æŠ€å·§**ï¼šæƒ³è±¡æˆè·‘æ­¥æ¯”èµ›ï¼Œ**æ•°å­—å°çš„è·‘å¾—å¿«ï¼Œå…ˆåˆ°ç»ˆç‚¹**

### 3.4 æ‰§è¡Œé¡ºåºå®æˆ˜ç¤ºä¾‹


```java
@Component
@Order(-100)  // ç¬¬ä¸€ä¸ªæ‰§è¡Œ
public class RequestIdFilter implements GlobalFilter {
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        // ç”Ÿæˆè¯·æ±‚IDï¼Œä¾›åç»­è¿‡æ»¤å™¨ä½¿ç”¨
        String requestId = UUID.randomUUID().toString();
        exchange.getAttributes().put("requestId", requestId);
        
        System.out.println("ğŸ”¹ è¯·æ±‚IDï¼š" + requestId);
        return chain.filter(exchange);
    }
}

@Component
@Order(1)  // ç¬¬äºŒä¸ªæ‰§è¡Œ
public class LogFilter implements GlobalFilter {
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        // ä½¿ç”¨å‰é¢ç”Ÿæˆçš„è¯·æ±‚ID
        String requestId = exchange.getAttribute("requestId");
        System.out.println("ğŸ“ [" + requestId + "] è®°å½•è¯·æ±‚æ—¥å¿—");
        
        return chain.filter(exchange);
    }
}

@Component
@Order(10)  // ç¬¬ä¸‰ä¸ªæ‰§è¡Œ
public class AuthFilter implements GlobalFilter {
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        String requestId = exchange.getAttribute("requestId");
        System.out.println("ğŸ” [" + requestId + "] é‰´æƒæ£€æŸ¥");
        
        // æ£€æŸ¥token
        String token = exchange.getRequest().getHeaders().getFirst("token");
        if (token == null) {
            exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);
            return exchange.getResponse().setComplete();  // ä¸­æ–­è¯·æ±‚
        }
        
        return chain.filter(exchange);
    }
}
```

**æ‰§è¡Œæ•ˆæœ**ï¼š
```
ğŸ”¹ è¯·æ±‚IDï¼ša1b2c3d4-5678-90ef-ghij-klmnopqrstuv
ğŸ“ [a1b2c3d4] è®°å½•è¯·æ±‚æ—¥å¿—
ğŸ” [a1b2c3d4] é‰´æƒæ£€æŸ¥
```

---

## 4. ğŸŒ è·¨åŸŸCORSå¤„ç†


### 4.1 ä»€ä¹ˆæ˜¯è·¨åŸŸé—®é¢˜


**å¤§ç™½è¯è§£é‡Š**ï¼š
- ä½ çš„å‰ç«¯é¡µé¢åœ¨ `http://localhost:3000`
- è¦è®¿é—®åç«¯æ¥å£ `http://localhost:8080`
- æµè§ˆå™¨è¯´ï¼š"ä¸è¡Œï¼ç«¯å£ä¸ä¸€æ ·ï¼Œä¸èƒ½è®¿é—®ï¼" â† è¿™å°±æ˜¯è·¨åŸŸ

**è·¨åŸŸçš„ä¸‰ç§æƒ…å†µ**ï¼š
```
1ï¸âƒ£ åè®®ä¸åŒï¼šhttp://a.com â†’ https://a.com  âŒ
2ï¸âƒ£ åŸŸåä¸åŒï¼šhttp://a.com â†’ http://b.com  âŒ
3ï¸âƒ£ ç«¯å£ä¸åŒï¼šhttp://a.com:80 â†’ http://a.com:8080  âŒ
```

> âš ï¸ **æµè§ˆå™¨çš„å®‰å…¨é™åˆ¶**ï¼šä¸ºäº†å®‰å…¨ï¼Œæµè§ˆå™¨é»˜è®¤ä¸å…è®¸è·¨åŸŸè¯·æ±‚

### 4.2 CORSè·¨åŸŸè¿‡æ»¤å™¨å®ç°


```java
@Component
@Order(-200)  // ä¼˜å…ˆçº§å¾ˆé«˜ï¼Œæœ€å…ˆå¤„ç†
public class CorsFilter implements GlobalFilter {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        
        ServerHttpRequest request = exchange.getRequest();
        ServerHttpResponse response = exchange.getResponse();
        
        // âœ… å…è®¸æ‰€æœ‰æ¥æºè®¿é—®ï¼ˆç”Ÿäº§ç¯å¢ƒè¦æŒ‡å®šå…·ä½“åŸŸåï¼‰
        response.getHeaders().add("Access-Control-Allow-Origin", "*");
        
        // âœ… å…è®¸çš„è¯·æ±‚æ–¹æ³•
        response.getHeaders().add("Access-Control-Allow-Methods", 
            "GET, POST, PUT, DELETE, OPTIONS");
        
        // âœ… å…è®¸çš„è¯·æ±‚å¤´
        response.getHeaders().add("Access-Control-Allow-Headers", 
            "Content-Type, Authorization, token");
        
        // âœ… å…è®¸æºå¸¦Cookie
        response.getHeaders().add("Access-Control-Allow-Credentials", "true");
        
        // âœ… é¢„æ£€è¯·æ±‚ç¼“å­˜æ—¶é—´ï¼ˆç§’ï¼‰
        response.getHeaders().add("Access-Control-Max-Age", "3600");
        
        // ğŸ”¹ å¤„ç†OPTIONSé¢„æ£€è¯·æ±‚ï¼ˆæµè§ˆå™¨ä¼šå…ˆå‘ä¸€ä¸ªOPTIONSè¯·æ±‚æ¢è·¯ï¼‰
        if (request.getMethod() == HttpMethod.OPTIONS) {
            response.setStatusCode(HttpStatus.OK);
            return Mono.empty();  // ç›´æ¥è¿”å›ï¼Œä¸å†å¾€ä¸‹èµ°
        }
        
        return chain.filter(exchange);
    }
}
```

### 4.3 CORSé…ç½®è¯¦è§£


**å…³é”®é…ç½®é¡¹è¯´æ˜**ï¼š

| é…ç½®é¡¹ | **å«ä¹‰** | **ç¤ºä¾‹å€¼** | **è¯´æ˜** |
|-------|---------|-----------|---------|
| `Access-Control-Allow-Origin` | `å…è®¸çš„æ¥æº` | `*` æˆ– `http://localhost:3000` | `*è¡¨ç¤ºæ‰€æœ‰ï¼Œç”Ÿäº§ç¯å¢ƒè¦æŒ‡å®š` |
| `Access-Control-Allow-Methods` | `å…è®¸çš„æ–¹æ³•` | `GET, POST, PUT, DELETE` | `é™å®šå…è®¸çš„HTTPæ–¹æ³•` |
| `Access-Control-Allow-Headers` | `å…è®¸çš„è¯·æ±‚å¤´` | `Content-Type, token` | `å‰ç«¯èƒ½å‘é€å“ªäº›è‡ªå®šä¹‰å¤´` |
| `Access-Control-Allow-Credentials` | `å…è®¸æºå¸¦å‡­è¯` | `true` | `æ˜¯å¦å…è®¸å‘é€Cookie` |
| `Access-Control-Max-Age` | `é¢„æ£€ç¼“å­˜æ—¶é—´` | `3600`ï¼ˆç§’ï¼‰ | `é¿å…é¢‘ç¹é¢„æ£€è¯·æ±‚` |

> ğŸ’¡ **ç”Ÿäº§ç¯å¢ƒå»ºè®®**ï¼šä¸è¦ç”¨ `*`ï¼Œæ˜ç¡®æŒ‡å®šå…è®¸çš„åŸŸåï¼Œæé«˜å®‰å…¨æ€§

### 4.4 OPTIONSé¢„æ£€è¯·æ±‚å¤„ç†


**ä»€ä¹ˆæ˜¯é¢„æ£€è¯·æ±‚**ï¼š
```
æµè§ˆå™¨å‘é€çœŸå®è¯·æ±‚å‰ï¼Œä¼šå…ˆå‘ä¸€ä¸ªOPTIONSè¯·æ±‚"æ¢è·¯"ï¼š

1ï¸âƒ£ æµè§ˆå™¨ï¼šæˆ‘æƒ³å‘ä¸ªPOSTè¯·æ±‚ï¼Œå¸¦Authorizationå¤´ï¼Œå¯ä»¥å—ï¼Ÿ
   â†“ OPTIONSè¯·æ±‚
   
2ï¸âƒ£ æœåŠ¡å™¨ï¼šå¯ä»¥ï¼è¿™äº›å¤´å’Œæ–¹æ³•éƒ½å…è®¸
   â†“ è¿”å›CORSé…ç½®
   
3ï¸âƒ£ æµè§ˆå™¨ï¼šå¥½çš„ï¼Œé‚£æˆ‘å‘çœŸå®è¯·æ±‚äº†
   â†“ å‘é€POSTè¯·æ±‚
```

**ä¸ºä»€ä¹ˆè¦å•ç‹¬å¤„ç†OPTIONS**ï¼š
- OPTIONSè¯·æ±‚ä¸éœ€è¦çœŸæ­£å¤„ç†ä¸šåŠ¡é€»è¾‘
- ç›´æ¥è¿”å›200çŠ¶æ€ç å³å¯
- èŠ‚çœèµ„æºï¼Œæé«˜æ•ˆç‡

---

## 5. ğŸ“ å…¨å±€æ—¥å¿—è®°å½•


### 5.1 æ—¥å¿—è¿‡æ»¤å™¨çš„ä½œç”¨


**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- ğŸ”¹ è®°å½•æ¯ä¸ªè¯·æ±‚çš„**è®¿é—®ä¿¡æ¯**ï¼ˆè·¯å¾„ã€æ–¹æ³•ã€å‚æ•°ï¼‰
- ğŸ”¹ è®°å½•æ¯ä¸ªè¯·æ±‚çš„**è€—æ—¶**
- ğŸ”¹ è®°å½•è¯·æ±‚çš„**å¤„ç†ç»“æœ**ï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰
- ğŸ”¹ æ–¹ä¾¿**é—®é¢˜æ’æŸ¥**å’Œ**æ€§èƒ½åˆ†æ**

### 5.2 å®Œæ•´çš„æ—¥å¿—è¿‡æ»¤å™¨å®ç°


```java
@Slf4j  // Lombokæ³¨è§£ï¼Œè‡ªåŠ¨ç”Ÿæˆlogå¯¹è±¡
@Component
@Order(-100)  // ä¼˜å…ˆçº§é«˜ï¼Œæœ€æ—©æ‰§è¡Œ
public class AccessLogFilter implements GlobalFilter {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        
        // ğŸ“ è·å–è¯·æ±‚ä¿¡æ¯
        ServerHttpRequest request = exchange.getRequest();
        String path = request.getPath().value();
        String method = request.getMethodValue();
        String ip = request.getRemoteAddress().getHostString();
        
        // ğŸ• è®°å½•å¼€å§‹æ—¶é—´
        long startTime = System.currentTimeMillis();
        exchange.getAttributes().put("startTime", startTime);
        
        // ğŸ“‹ æ‰“å°è¯·æ±‚æ—¥å¿—
        log.info("ğŸ“¥ è¯·æ±‚è¿›æ¥ â†’ æ–¹æ³•:{} è·¯å¾„:{} IP:{}", method, path, ip);
        
        // â±ï¸ è°ƒç”¨ä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œå¹¶åœ¨å“åº”æ—¶è®°å½•ç»“æŸæ—¥å¿—
        return chain.filter(exchange).then(
            Mono.fromRunnable(() -> {
                // è®¡ç®—è€—æ—¶
                Long start = exchange.getAttribute("startTime");
                long duration = System.currentTimeMillis() - start;
                
                // è·å–å“åº”çŠ¶æ€
                HttpStatus statusCode = exchange.getResponse().getStatusCode();
                
                // ğŸ“‹ æ‰“å°å“åº”æ—¥å¿—
                log.info("ğŸ“¤ å“åº”è¿”å› â†’ çŠ¶æ€:{} è€—æ—¶:{}ms è·¯å¾„:{}", 
                    statusCode, duration, path);
            })
        );
    }
}
```

### 5.3 å¸¦è¯·æ±‚å‚æ•°çš„æ—¥å¿—è®°å½•


```java
@Slf4j
@Component
@Order(-100)
public class DetailedLogFilter implements GlobalFilter {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        
        ServerHttpRequest request = exchange.getRequest();
        
        // ğŸ“ æ”¶é›†è¯·æ±‚ä¿¡æ¯
        String method = request.getMethodValue();
        String path = request.getPath().value();
        String ip = request.getRemoteAddress().getHostString();
        
        // ğŸ”¹ è·å–æŸ¥è¯¢å‚æ•°ï¼ˆGETè¯·æ±‚çš„å‚æ•°ï¼‰
        MultiValueMap<String, String> queryParams = request.getQueryParams();
        
        // ğŸ”¹ è·å–è¯·æ±‚å¤´
        HttpHeaders headers = request.getHeaders();
        String token = headers.getFirst("Authorization");
        
        // ğŸ“‹ æ‰“å°è¯¦ç»†æ—¥å¿—
        log.info("""
            ============ è¯·æ±‚å¼€å§‹ ============
            æ–¹æ³•: {}
            è·¯å¾„: {}
            IP: {}
            å‚æ•°: {}
            Token: {}
            ================================
            """, method, path, ip, queryParams, token);
        
        long startTime = System.currentTimeMillis();
        
        return chain.filter(exchange).then(
            Mono.fromRunnable(() -> {
                long duration = System.currentTimeMillis() - startTime;
                log.info("============ è¯·æ±‚ç»“æŸ ============ è€—æ—¶: {}ms", duration);
            })
        );
    }
}
```

### 5.4 æ—¥å¿—è¾“å‡ºæ•ˆæœ


```
2025-09-23 10:30:15.123 INFO  ğŸ“¥ è¯·æ±‚è¿›æ¥ â†’ æ–¹æ³•:GET è·¯å¾„:/api/user/info IP:192.168.1.100
2025-09-23 10:30:15.234 INFO  ğŸ“¤ å“åº”è¿”å› â†’ çŠ¶æ€:200 OK è€—æ—¶:111ms è·¯å¾„:/api/user/info

============ è¯·æ±‚å¼€å§‹ ============
æ–¹æ³•: POST
è·¯å¾„: /api/order/create
IP: 192.168.1.100
å‚æ•°: {userId=[123], productId=[456]}
Token: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
================================
============ è¯·æ±‚ç»“æŸ ============ è€—æ—¶: 235ms
```

---

## 6. âš ï¸ å…¨å±€å¼‚å¸¸å¤„ç†


### 6.1 ä¸ºä»€ä¹ˆéœ€è¦å…¨å±€å¼‚å¸¸å¤„ç†


**é—®é¢˜åœºæ™¯**ï¼š
```
âŒ æ²¡æœ‰å¼‚å¸¸å¤„ç†ï¼š
- æœåŠ¡æŒ‚äº†ï¼Œè¿”å›500é”™è¯¯ï¼Œå‰ç«¯çœ‹åˆ°ä¸€å †ä¹±ç 
- ä¸çŸ¥é“å“ªé‡Œå‡ºé”™ï¼Œæ’æŸ¥å›°éš¾
- ç”¨æˆ·ä½“éªŒå·®

âœ… æœ‰å¼‚å¸¸å¤„ç†ï¼š
- è¿”å›ç»Ÿä¸€æ ¼å¼çš„é”™è¯¯ä¿¡æ¯
- è®°å½•è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
- å‹å¥½çš„é”™è¯¯æç¤º
```

### 6.2 å…¨å±€å¼‚å¸¸å¤„ç†è¿‡æ»¤å™¨


```java
@Slf4j
@Component
@Order(-50)  // ä¼˜å…ˆçº§è¾ƒé«˜
public class GlobalExceptionFilter implements GlobalFilter {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        
        return chain.filter(exchange)
            // æ•è·æ‰€æœ‰å¼‚å¸¸
            .onErrorResume(error -> {
                
                // ğŸ“ è®°å½•é”™è¯¯æ—¥å¿—
                log.error("âŒ ç½‘å…³å¼‚å¸¸ï¼š{}", error.getMessage(), error);
                
                ServerHttpResponse response = exchange.getResponse();
                
                // ğŸ”¹ è®¾ç½®å“åº”ç±»å‹ä¸ºJSON
                response.getHeaders().setContentType(MediaType.APPLICATION_JSON);
                
                // ğŸ”¹ æ„å»ºé”™è¯¯å“åº”
                String errorMsg = buildErrorResponse(error);
                DataBuffer buffer = response.bufferFactory()
                    .wrap(errorMsg.getBytes(StandardCharsets.UTF_8));
                
                // ğŸ”¹ è¿”å›é”™è¯¯å“åº”
                return response.writeWith(Mono.just(buffer));
            });
    }
    
    // æ„å»ºç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼
    private String buildErrorResponse(Throwable error) {
        Map<String, Object> result = new HashMap<>();
        result.put("success", false);
        result.put("code", 500);
        
        // ğŸ”¹ æ ¹æ®ä¸åŒå¼‚å¸¸ç±»å‹ï¼Œè¿”å›ä¸åŒæ¶ˆæ¯
        if (error instanceof TimeoutException) {
            result.put("message", "è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•");
        } else if (error instanceof ConnectException) {
            result.put("message", "æœåŠ¡è¿æ¥å¤±è´¥");
        } else {
            result.put("message", "ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·è”ç³»ç®¡ç†å‘˜");
        }
        
        result.put("timestamp", System.currentTimeMillis());
        
        // è½¬ä¸ºJSONå­—ç¬¦ä¸²
        return new JSONObject(result).toString();
    }
}
```

### 6.3 é’ˆå¯¹ä¸åŒå¼‚å¸¸çš„å¤„ç†ç­–ç•¥


```java
@Slf4j
@Component
public class SmartExceptionFilter implements GlobalFilter {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        
        return chain.filter(exchange)
            .onErrorResume(error -> {
                
                ServerHttpResponse response = exchange.getResponse();
                response.getHeaders().setContentType(MediaType.APPLICATION_JSON);
                
                // ğŸ“‹ æ ¹æ®å¼‚å¸¸ç±»å‹è¿”å›ä¸åŒçš„çŠ¶æ€ç å’Œæ¶ˆæ¯
                String errorResponse;
                
                if (error instanceof TimeoutException) {
                    // â±ï¸ è¶…æ—¶å¼‚å¸¸
                    response.setStatusCode(HttpStatus.GATEWAY_TIMEOUT);
                    errorResponse = buildError(504, "è¯·æ±‚è¶…æ—¶");
                    log.warn("â±ï¸ è¯·æ±‚è¶…æ—¶ï¼š{}", exchange.getRequest().getPath());
                    
                } else if (error instanceof ConnectException) {
                    // ğŸ”Œ è¿æ¥å¼‚å¸¸
                    response.setStatusCode(HttpStatus.BAD_GATEWAY);
                    errorResponse = buildError(502, "æœåŠ¡ä¸å¯ç”¨");
                    log.error("ğŸ”Œ æœåŠ¡è¿æ¥å¤±è´¥ï¼š{}", error.getMessage());
                    
                } else if (error.getMessage().contains("401")) {
                    // ğŸ” è®¤è¯å¼‚å¸¸
                    response.setStatusCode(HttpStatus.UNAUTHORIZED);
                    errorResponse = buildError(401, "æœªæˆæƒï¼Œè¯·å…ˆç™»å½•");
                    log.warn("ğŸ” è®¤è¯å¤±è´¥ï¼š{}", exchange.getRequest().getPath());
                    
                } else {
                    // âŒ å…¶ä»–å¼‚å¸¸
                    response.setStatusCode(HttpStatus.INTERNAL_SERVER_ERROR);
                    errorResponse = buildError(500, "ç³»ç»Ÿå¼‚å¸¸");
                    log.error("âŒ æœªçŸ¥å¼‚å¸¸ï¼š{}", error.getMessage(), error);
                }
                
                DataBuffer buffer = response.bufferFactory()
                    .wrap(errorResponse.getBytes(StandardCharsets.UTF_8));
                
                return response.writeWith(Mono.just(buffer));
            });
    }
    
    // æ„å»ºé”™è¯¯å“åº”
    private String buildError(int code, String message) {
        return String.format(
            "{\"success\":false,\"code\":%d,\"message\":\"%s\",\"timestamp\":%d}",
            code, message, System.currentTimeMillis()
        );
    }
}
```

### 6.4 é”™è¯¯å“åº”æ ¼å¼


**ç»Ÿä¸€çš„é”™è¯¯å“åº”ç»“æ„**ï¼š

```json
{
  "success": false,
  "code": 500,
  "message": "ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·è”ç³»ç®¡ç†å‘˜",
  "timestamp": 1695456789000
}
```

**ä¸åŒå¼‚å¸¸çš„å“åº”ç¤ºä¾‹**ï¼š

| å¼‚å¸¸ç±»å‹ | **HTTPçŠ¶æ€ç ** | **code** | **message** |
|---------|--------------|---------|------------|
| `TimeoutException` | `504` | `504` | `è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•` |
| `ConnectException` | `502` | `502` | `æœåŠ¡ä¸å¯ç”¨` |
| `è®¤è¯å¤±è´¥` | `401` | `401` | `æœªæˆæƒï¼Œè¯·å…ˆç™»å½•` |
| `å…¶ä»–å¼‚å¸¸` | `500` | `500` | `ç³»ç»Ÿå¼‚å¸¸` |

---

## 7. ğŸ”„ è¯·æ±‚å“åº”ä¿®æ”¹


### 7.1 ä¿®æ”¹è¯·æ±‚ä¿¡æ¯


**åº”ç”¨åœºæ™¯**ï¼š
- ğŸ”¹ ç»™æ‰€æœ‰è¯·æ±‚**æ·»åŠ ç»Ÿä¸€çš„è¯·æ±‚å¤´**ï¼ˆå¦‚é“¾è·¯è¿½è¸ªIDï¼‰
- ğŸ”¹ **ä¿®æ”¹è¯·æ±‚è·¯å¾„**ï¼ˆè·¯å¾„é‡å†™ï¼‰
- ğŸ”¹ **æ·»åŠ è®¤è¯ä¿¡æ¯**åˆ°è¯·æ±‚å¤´

```java
@Component
@Order(10)
public class RequestModifyFilter implements GlobalFilter {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        
        // ğŸ”¹ ä¿®æ”¹è¯·æ±‚ï¼šæ·»åŠ è‡ªå®šä¹‰è¯·æ±‚å¤´
        ServerHttpRequest modifiedRequest = exchange.getRequest()
            .mutate()
            // æ·»åŠ é“¾è·¯è¿½è¸ªID
            .header("X-Trace-Id", UUID.randomUUID().toString())
            // æ·»åŠ ç½‘å…³æ ‡è¯†
            .header("X-Gateway", "API-Gateway")
            // æ·»åŠ è¯·æ±‚æ—¶é—´
            .header("X-Request-Time", String.valueOf(System.currentTimeMillis()))
            .build();
        
        // ğŸ”¹ ä½¿ç”¨ä¿®æ”¹åçš„è¯·æ±‚ç»§ç»­æ‰§è¡Œ
        ServerWebExchange modifiedExchange = exchange.mutate()
            .request(modifiedRequest)
            .build();
        
        return chain.filter(modifiedExchange);
    }
}
```

### 7.2 ä¿®æ”¹è¯·æ±‚è·¯å¾„


```java
@Component
public class PathRewriteFilter implements GlobalFilter {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        
        ServerHttpRequest request = exchange.getRequest();
        String originalPath = request.getPath().value();
        
        // ğŸ”¹ è·¯å¾„é‡å†™ï¼šå»æ‰APIç‰ˆæœ¬å·
        // /api/v1/user â†’ /user
        if (originalPath.startsWith("/api/v1/")) {
            String newPath = originalPath.replace("/api/v1", "");
            
            ServerHttpRequest modifiedRequest = request.mutate()
                .path(newPath)
                .build();
            
            ServerWebExchange modifiedExchange = exchange.mutate()
                .request(modifiedRequest)
                .build();
            
            log.info("ğŸ”„ è·¯å¾„é‡å†™: {} â†’ {}", originalPath, newPath);
            
            return chain.filter(modifiedExchange);
        }
        
        return chain.filter(exchange);
    }
}
```

### 7.3 ä¿®æ”¹å“åº”ä¿¡æ¯


**åº”ç”¨åœºæ™¯**ï¼š
- ğŸ”¹ ç»™æ‰€æœ‰å“åº”**æ·»åŠ ç»Ÿä¸€çš„å“åº”å¤´**
- ğŸ”¹ **ä¿®æ”¹å“åº”ä½“å†…å®¹**ï¼ˆå¦‚ç»Ÿä¸€åŒ…è£…ï¼‰
- ğŸ”¹ **æ·»åŠ å“åº”æ—¶é—´**ç­‰å…ƒæ•°æ®

```java
@Component
@Order(1000)  // ä¼˜å…ˆçº§ä½ï¼Œæœ€åæ‰§è¡Œ
public class ResponseModifyFilter implements GlobalFilter {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        
        ServerHttpResponse response = exchange.getResponse();
        
        // ğŸ”¹ æ·»åŠ è‡ªå®šä¹‰å“åº”å¤´
        response.getHeaders().add("X-Response-Time", 
            String.valueOf(System.currentTimeMillis()));
        response.getHeaders().add("X-Gateway-Version", "1.0.0");
        
        return chain.filter(exchange).then(
            Mono.fromRunnable(() -> {
                // å“åº”è¿”å›æ—¶æ‰§è¡Œ
                log.info("âœ… å“åº”å¤´å·²æ·»åŠ ");
            })
        );
    }
}
```

### 7.4 å“åº”ä½“å†…å®¹ä¿®æ”¹ï¼ˆé«˜çº§ï¼‰


```java
@Component
public class ResponseBodyModifyFilter implements GlobalFilter {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        
        ServerHttpResponse originalResponse = exchange.getResponse();
        
        // ğŸ”¹ è£…é¥°å™¨æ¨¡å¼ï¼šåŒ…è£…åŸå§‹å“åº”
        ServerHttpResponseDecorator decoratedResponse = 
            new ServerHttpResponseDecorator(originalResponse) {
            
            @Override
            public Mono<Void> writeWith(Publisher<? extends DataBuffer> body) {
                
                if (body instanceof Flux) {
                    Flux<? extends DataBuffer> fluxBody = (Flux<? extends DataBuffer>) body;
                    
                    return super.writeWith(fluxBody.map(dataBuffer -> {
                        // ğŸ”¹ è¯»å–åŸå§‹å“åº”ä½“
                        byte[] content = new byte[dataBuffer.readableByteCount()];
                        dataBuffer.read(content);
                        
                        // ğŸ”¹ ä¿®æ”¹å“åº”ä½“ï¼ˆè¿™é‡Œç®€å•æ·»åŠ ä¸€ä¸ªåŒ…è£…ï¼‰
                        String originalBody = new String(content, StandardCharsets.UTF_8);
                        String modifiedBody = wrapResponse(originalBody);
                        
                        // ğŸ”¹ è¿”å›ä¿®æ”¹åçš„å“åº”ä½“
                        return originalResponse.bufferFactory()
                            .wrap(modifiedBody.getBytes(StandardCharsets.UTF_8));
                    }));
                }
                
                return super.writeWith(body);
            }
        };
        
        // ä½¿ç”¨è£…é¥°åçš„å“åº”
        return chain.filter(exchange.mutate().response(decoratedResponse).build());
    }
    
    // åŒ…è£…å“åº”ä½“
    private String wrapResponse(String originalBody) {
        return String.format(
            "{\"success\":true,\"data\":%s,\"timestamp\":%d}",
            originalBody, System.currentTimeMillis()
        );
    }
}
```

### 7.5 è¯·æ±‚å“åº”ä¿®æ”¹å¯¹æ¯”


| ä¿®æ”¹ç±»å‹ | **éš¾åº¦** | **å¸¸ç”¨åœºæ™¯** | **æ³¨æ„äº‹é¡¹** |
|---------|---------|------------|-------------|
| `æ·»åŠ è¯·æ±‚å¤´` | â­ | `é“¾è·¯è¿½è¸ªã€è®¤è¯ä¿¡æ¯` | `ç®€å•å®ç”¨` |
| `ä¿®æ”¹è¯·æ±‚è·¯å¾„` | â­â­ | `è·¯å¾„é‡å†™ã€ç‰ˆæœ¬ç®¡ç†` | `æ³¨æ„è·¯ç”±åŒ¹é…` |
| `æ·»åŠ å“åº”å¤´` | â­ | `CORSã€ç¼“å­˜æ§åˆ¶` | `ç®€å•ç›´æ¥` |
| `ä¿®æ”¹å“åº”ä½“` | â­â­â­â­ | `ç»Ÿä¸€å“åº”æ ¼å¼` | `æ€§èƒ½å¼€é”€å¤§ï¼Œæ…ç”¨` |

> âš ï¸ **æ€§èƒ½æç¤º**ï¼šä¿®æ”¹å“åº”ä½“éœ€è¦è¯»å–å®Œæ•´å†…å®¹ï¼Œ**æ€§èƒ½å¼€é”€è¾ƒå¤§**ï¼Œéå¿…è¦ä¸å»ºè®®ä½¿ç”¨

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å…¨å±€è¿‡æ»¤å™¨ï¼šå¯¹æ‰€æœ‰è¯·æ±‚ç”Ÿæ•ˆçš„è¿‡æ»¤å™¨ï¼Œå®ç°GlobalFilteræ¥å£
ğŸ”¸ æ‰§è¡Œé¡ºåºï¼šé€šè¿‡Orderedæ¥å£æˆ–@Orderæ³¨è§£æ§åˆ¶ï¼Œæ•°å­—è¶Šå°è¶Šå…ˆæ‰§è¡Œ
ğŸ”¸ è´£ä»»é“¾æ¨¡å¼ï¼šä¸€ä¸ªè¿‡æ»¤å™¨å¤„ç†å®Œï¼Œè°ƒç”¨chain.filter()ä¼ ç»™ä¸‹ä¸€ä¸ª
ğŸ”¸ åŒå‘å¤„ç†ï¼šè¯·æ±‚è¿›æ¥æ—¶å¤„ç†ï¼ˆpreï¼‰ï¼Œå“åº”è¿”å›æ—¶å¤„ç†ï¼ˆpostï¼‰
ğŸ”¸ ServerWebExchangeï¼šè¯·æ±‚å“åº”çš„å¤§ç›’å­ï¼ŒåŒ…å«æ‰€æœ‰ä¿¡æ¯
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å…¨å±€è¿‡æ»¤å™¨çš„æœ¬è´¨**
```
ç†è§£è¦ç‚¹ï¼š
- å…¨å±€è¿‡æ»¤å™¨ = æ‰€æœ‰è¯·æ±‚çš„"æ£€æŸ¥ç«™"
- å®ç°GlobalFilteræ¥å£å³å¯ï¼ŒSpringä¼šè‡ªåŠ¨åŠ è½½
- å¿…é¡»è°ƒç”¨chain.filter()ï¼Œå¦åˆ™è¯·æ±‚ä¸­æ–­
- æ”¯æŒå‰ç½®å¤„ç†å’Œåç½®å¤„ç†
```

**ğŸ”¹ è¿‡æ»¤å™¨é¡ºåºçš„é‡è¦æ€§**
```
é”™è¯¯ç¤ºä¾‹ï¼šé™æµ â†’ é‰´æƒ â†’ æ—¥å¿—
é—®é¢˜ï¼šéæ³•è¯·æ±‚ä¹Ÿæ¶ˆè€—é™æµé…é¢

æ­£ç¡®ç¤ºä¾‹ï¼šæ—¥å¿— â†’ é‰´æƒ â†’ é™æµ
é€»è¾‘ï¼šå…ˆè®°å½•ï¼Œå†éªŒæƒï¼Œæœ€åé™æµ

è®°å¿†ï¼šæ•°å­—è¶Šå°ï¼Œè¶Šå…ˆæ‰§è¡Œï¼ˆ-100 â†’ 0 â†’ 100 â†’ 1000ï¼‰
```

**ğŸ”¹ å¸¸è§åŠŸèƒ½å®ç°è¦ç‚¹**
```
è·¨åŸŸå¤„ç†ï¼š
- æ·»åŠ CORSå“åº”å¤´
- OPTIONSé¢„æ£€è¯·æ±‚ç›´æ¥è¿”å›

æ—¥å¿—è®°å½•ï¼š
- å‰ç½®ï¼šè®°å½•è¯·æ±‚ä¿¡æ¯å’Œå¼€å§‹æ—¶é—´
- åç½®ï¼šè®°å½•å“åº”çŠ¶æ€å’Œè€—æ—¶

å¼‚å¸¸å¤„ç†ï¼š
- ä½¿ç”¨onErrorResumeæ•è·å¼‚å¸¸
- è¿”å›ç»Ÿä¸€æ ¼å¼çš„é”™è¯¯å“åº”
- è®°å½•è¯¦ç»†çš„é”™è¯¯æ—¥å¿—

è¯·æ±‚ä¿®æ”¹ï¼š
- ä½¿ç”¨mutate()æ–¹æ³•ä¿®æ”¹è¯·æ±‚
- å¸¸ç”¨äºæ·»åŠ è¯·æ±‚å¤´ã€è·¯å¾„é‡å†™

å“åº”ä¿®æ”¹ï¼š
- æ·»åŠ å“åº”å¤´å¾ˆç®€å•
- ä¿®æ”¹å“åº”ä½“è¾ƒå¤æ‚ï¼Œæ…ç”¨
```

### 8.3 å®é™…åº”ç”¨æœ€ä½³å®è·µ


**âœ… æ¨èåšæ³•**ï¼š

1. **åˆç†è§„åˆ’è¿‡æ»¤å™¨é¡ºåº**
```
-200  è·¨åŸŸå¤„ç†
-100  è¯·æ±‚IDç”Ÿæˆ
-50   å…¨å±€å¼‚å¸¸å¤„ç†
1     æ—¥å¿—è®°å½•
10    é‰´æƒéªŒè¯
100   é™æµæ§åˆ¶
1000  å“åº”å¤„ç†
```

2. **ä½¿ç”¨æ—¥å¿—è®°å½•å…³é”®ä¿¡æ¯**
```java
// å¥½çš„åšæ³•ï¼šè®°å½•å…³é”®ä¿¡æ¯
log.info("ğŸ“¥ {} {} æ¥è‡ª:{} è€—æ—¶:{}ms", 
    method, path, ip, duration);

// ä¸å¥½çš„åšæ³•ï¼šä¿¡æ¯è¿‡å¤šæˆ–è¿‡å°‘
log.info("è¯·æ±‚");  // âŒ å¤ªç®€ç•¥
log.info(exchange.toString());  // âŒ å¤ªè¯¦ç»†
```

3. **å¼‚å¸¸å¤„ç†è¦å‹å¥½**
```java
// âœ… å¥½çš„åšæ³•ï¼šè¿”å›å‹å¥½çš„é”™è¯¯ä¿¡æ¯
{
  "success": false,
  "code": 500,
  "message": "ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•",
  "timestamp": 1695456789000
}

// âŒ ä¸å¥½çš„åšæ³•ï¼šæš´éœ²æŠ€æœ¯ç»†èŠ‚
{
  "error": "NullPointerException at line 123"
}
```

### 8.4 å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ


**Q1ï¼šä¸ºä»€ä¹ˆæˆ‘çš„è¿‡æ»¤å™¨ä¸ç”Ÿæ•ˆï¼Ÿ**
```
âœ… æ£€æŸ¥æ¸…å•ï¼š
- æ˜¯å¦æ·»åŠ äº†@Componentæ³¨è§£
- æ˜¯å¦å®ç°äº†GlobalFilteræ¥å£
- æ˜¯å¦æ­£ç¡®è°ƒç”¨äº†chain.filter()
- å¯åŠ¨ç±»ä¸Šæ˜¯å¦æœ‰@EnableDiscoveryClientç­‰æ³¨è§£
```

**Q2ï¼šä¸ºä»€ä¹ˆè¿‡æ»¤å™¨æ‰§è¡Œé¡ºåºä¸å¯¹ï¼Ÿ**
```
âœ… è§£å†³æ–¹æ¡ˆï¼š
- æ£€æŸ¥@Orderæ³¨è§£æˆ–getOrder()è¿”å›å€¼
- æ•°å­—è¶Šå°è¶Šå…ˆæ‰§è¡Œï¼ˆ-100æ¯”100å…ˆæ‰§è¡Œï¼‰
- ç¡®ä¿æ¯ä¸ªè¿‡æ»¤å™¨éƒ½è®¾ç½®äº†é¡ºåº
```

**Q3ï¼šå¦‚ä½•åœ¨è¿‡æ»¤å™¨é—´ä¼ é€’æ•°æ®ï¼Ÿ**
```java
// âœ… ä½¿ç”¨Exchangeçš„attributes
exchange.getAttributes().put("requestId", "123");
String id = exchange.getAttribute("requestId");
```

**Q4ï¼šå“åº”ä½“ä¿®æ”¹ä¸ºä»€ä¹ˆä¸ç”Ÿæ•ˆï¼Ÿ**
```
âœ… æ³¨æ„äº‹é¡¹ï¼š
- å“åº”ä½“ä¿®æ”¹éœ€è¦ä½¿ç”¨è£…é¥°å™¨æ¨¡å¼
- éœ€è¦å¤„ç†Fluxæ•°æ®æµ
- æ€§èƒ½å¼€é”€è¾ƒå¤§ï¼Œéå¿…è¦ä¸ä½¿ç”¨
```

### 8.5 å­¦ä¹ å»ºè®®


**ğŸ“š å­¦ä¹ è·¯å¾„**ï¼š
```
1ï¸âƒ£ ç†è§£å…¨å±€è¿‡æ»¤å™¨çš„åŸºæœ¬æ¦‚å¿µå’Œå·¥ä½œåŸç†
2ï¸âƒ£ æŒæ¡GlobalFilteræ¥å£å’ŒOrderedæ¥å£
3ï¸âƒ£ å®è·µå¸¸è§åœºæ™¯ï¼šæ—¥å¿—ã€è·¨åŸŸã€å¼‚å¸¸å¤„ç†
4ï¸âƒ£ æ·±å…¥å­¦ä¹ è¯·æ±‚å“åº”ä¿®æ”¹çš„é«˜çº§ç”¨æ³•
5ï¸âƒ£ ç»“åˆå®é™…é¡¹ç›®ï¼Œä¼˜åŒ–è¿‡æ»¤å™¨é…ç½®
```

**ğŸ”§ å®è·µå»ºè®®**ï¼š
- ä»ç®€å•çš„æ—¥å¿—è¿‡æ»¤å™¨å¼€å§‹ç»ƒä¹ 
- é€æ­¥æ·»åŠ è·¨åŸŸã€é‰´æƒç­‰åŠŸèƒ½
- æ³¨æ„è§‚å¯Ÿè¿‡æ»¤å™¨çš„æ‰§è¡Œé¡ºåº
- å¤šæ‰“æ—¥å¿—ï¼Œç†è§£æ‰§è¡Œæµç¨‹

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
å…¨å±€è¿‡æ»¤å™¨æ‹¦ä¸‡å®¶ï¼Œ
å®ç°æ¥å£åŠ æ³¨è§£ã€‚
é¡ºåºæ§åˆ¶è¦ç‰¢è®°ï¼Œ
æ•°å°åœ¨å‰æ•°å¤§åã€‚
æ—¥å¿—è·¨åŸŸå’Œé‰´æƒï¼Œ
å¼‚å¸¸å¤„ç†è¦åšå¥½ã€‚
è¯·æ±‚å“åº”èƒ½ä¿®æ”¹ï¼Œ
é“¾å¼è°ƒç”¨è«å¿˜æ‰ã€‚
```