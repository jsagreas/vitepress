---
title: 1ã€è¿‡æ»¤å™¨åˆ†ç±»ä½“ç³»
---
## ğŸ“š ç›®å½•

1. [è¿‡æ»¤å™¨æ ¸å¿ƒæ¦‚å¿µ](#1-è¿‡æ»¤å™¨æ ¸å¿ƒæ¦‚å¿µ)
2. [å…¨å±€è¿‡æ»¤å™¨GlobalFilter](#2-å…¨å±€è¿‡æ»¤å™¨GlobalFilter)
3. [ç½‘å…³è¿‡æ»¤å™¨GatewayFilter](#3-ç½‘å…³è¿‡æ»¤å™¨GatewayFilter)
4. [å†…ç½®è¿‡æ»¤å™¨å·¥å‚](#4-å†…ç½®è¿‡æ»¤å™¨å·¥å‚)
5. [è‡ªå®šä¹‰è¿‡æ»¤å™¨å¼€å‘](#5-è‡ªå®šä¹‰è¿‡æ»¤å™¨å¼€å‘)
6. [è¿‡æ»¤å™¨æ‰§è¡Œé¡ºåº](#6-è¿‡æ»¤å™¨æ‰§è¡Œé¡ºåº)
7. [è¿‡æ»¤å™¨é“¾è°ƒç”¨æœºåˆ¶](#7-è¿‡æ»¤å™¨é“¾è°ƒç”¨æœºåˆ¶)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ è¿‡æ»¤å™¨æ ¸å¿ƒæ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯è¿‡æ»¤å™¨


**é€šä¿—ç†è§£**ï¼šè¿‡æ»¤å™¨å°±åƒæœºåœºçš„å®‰æ£€é€šé“ï¼Œæ‰€æœ‰ä¹˜å®¢ï¼ˆè¯·æ±‚ï¼‰éƒ½å¿…é¡»ç»è¿‡å®‰æ£€æ‰èƒ½ç™»æœºï¼ˆåˆ°è¾¾åç«¯æœåŠ¡ï¼‰ã€‚

```
çœŸå®åœºæ™¯ç±»æ¯”ï¼š
æœºåœºå®‰æ£€æµç¨‹                APIç½‘å…³è¿‡æ»¤å™¨
    â†“                          â†“
èº«ä»½éªŒè¯ï¼ˆæŸ¥èº«ä»½è¯ï¼‰  â†’   Tokenè®¤è¯è¿‡æ»¤å™¨
å®‰å…¨æ£€æŸ¥ï¼ˆè¿‡Xå…‰ï¼‰     â†’   å®‰å…¨æ ¡éªŒè¿‡æ»¤å™¨  
è¡Œæç§°é‡ï¼ˆé™é‡ï¼‰      â†’   è¯·æ±‚é™æµè¿‡æ»¤å™¨
ç™»æœºç‰Œæ£€æŸ¥            â†’   è·¯ç”±åŒ¹é…è¿‡æ»¤å™¨
    â†“                          â†“
  ç™»æœº                    è½¬å‘åˆ°åç«¯æœåŠ¡
```

**æ ¸å¿ƒä½œç”¨**ï¼š
- ğŸ” **å®‰å…¨æ§åˆ¶**ï¼šéªŒè¯ç”¨æˆ·èº«ä»½ï¼Œæ£€æŸ¥æƒé™
- ğŸ“Š **ç›‘æ§ç»Ÿè®¡**ï¼šè®°å½•è¯·æ±‚æ—¥å¿—ï¼Œç»Ÿè®¡è®¿é—®é‡
- ğŸ”„ **è¯·æ±‚å¤„ç†**ï¼šä¿®æ”¹è¯·æ±‚å¤´ã€è¯·æ±‚ä½“
- ğŸš¦ **æµé‡æ§åˆ¶**ï¼šé™æµã€ç†”æ–­ã€é™çº§
- ğŸ“ **å“åº”å¤„ç†**ï¼šä¿®æ”¹å“åº”æ•°æ®ã€æ·»åŠ å“åº”å¤´

### 1.2 è¿‡æ»¤å™¨åœ¨ç½‘å…³ä¸­çš„ä½ç½®


**è¯·æ±‚å¤„ç†æµç¨‹**ï¼š
```
å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚
    â†“
è¿›å…¥APIç½‘å…³
    â†“
ã€å‰ç½®è¿‡æ»¤å™¨Pre Filterã€‘â† è¯·æ±‚åˆ°è¾¾æ—¶æ‰§è¡Œ
    â”œâ”€ èº«ä»½è®¤è¯
    â”œâ”€ å‚æ•°æ ¡éªŒ
    â””â”€ è¯·æ±‚æ—¥å¿—
    â†“
è·¯ç”±åˆ°åç«¯æœåŠ¡
    â†“
ã€åç½®è¿‡æ»¤å™¨Post Filterã€‘â† å“åº”è¿”å›æ—¶æ‰§è¡Œ
    â”œâ”€ å“åº”åŠ å¯†
    â”œâ”€ ç»Ÿè®¡è€—æ—¶
    â””â”€ å¼‚å¸¸å¤„ç†
    â†“
è¿”å›ç»™å®¢æˆ·ç«¯
```

### 1.3 è¿‡æ»¤å™¨çš„ä¸¤å¤§åˆ†ç±»


**åˆ†ç±»ä½“ç³»**ï¼š
```
è¿‡æ»¤å™¨Filter
â”œâ”€â”€ GlobalFilterï¼ˆå…¨å±€è¿‡æ»¤å™¨ï¼‰
â”‚   â”œâ”€â”€ ä½œç”¨èŒƒå›´ï¼šæ‰€æœ‰è·¯ç”±
â”‚   â”œâ”€â”€ åº”ç”¨åœºæ™¯ï¼šé€šç”¨åŠŸèƒ½
â”‚   â””â”€â”€ ç¤ºä¾‹ï¼šè®¤è¯ã€æ—¥å¿—ã€é™æµ
â”‚
â””â”€â”€ GatewayFilterï¼ˆç½‘å…³è¿‡æ»¤å™¨ï¼‰
    â”œâ”€â”€ ä½œç”¨èŒƒå›´ï¼šæŒ‡å®šè·¯ç”±
    â”œâ”€â”€ åº”ç”¨åœºæ™¯ï¼šç‰¹å®šéœ€æ±‚
    â””â”€â”€ ç¤ºä¾‹ï¼šæ·»åŠ è¯·æ±‚å¤´ã€ä¿®æ”¹è·¯å¾„
```

**ç®€å•è®°å¿†**ï¼š
- **GlobalFilter**ï¼šåƒå…¬å¸å‰å°ï¼Œæ‰€æœ‰äººéƒ½è¦ç»è¿‡
- **GatewayFilter**ï¼šåƒéƒ¨é—¨é—¨ç¦ï¼Œåªæœ‰ç‰¹å®šéƒ¨é—¨éœ€è¦

---

## 2. ğŸŒ å…¨å±€è¿‡æ»¤å™¨GlobalFilter


### 2.1 GlobalFilteråŸºæœ¬æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯GlobalFilter**ï¼šå…¨å±€è¿‡æ»¤å™¨ä¼šå¯¹**æ‰€æœ‰ç»è¿‡ç½‘å…³çš„è¯·æ±‚**éƒ½è¿›è¡Œå¤„ç†ï¼Œä¸ç®¡è¯·æ±‚å»å“ªä¸ªæœåŠ¡ã€‚

**ç”Ÿæ´»ç±»æ¯”**ï¼š
```
è¿›å…¥å•†åœº                  è¿›å…¥APIç½‘å…³
    â†“                         â†“
ä½“æ¸©æ£€æµ‹ï¼ˆå…¨å‘˜ï¼‰    â†’    GlobalFilterï¼ˆå…¨å±€ï¼‰
    â†“                         â†“
å»ä¸åŒåº—é“º              å»ä¸åŒå¾®æœåŠ¡
(Aåº—/Båº—/Cåº—)          (ç”¨æˆ·æœåŠ¡/è®¢å•æœåŠ¡...)
```

### 2.2 GlobalFilteræ ¸å¿ƒæ¥å£


**æ¥å£å®šä¹‰è§£æ**ï¼š
```java
public interface GlobalFilter {
    Mono<Void> filter(ServerWebExchange exchange, 
                      GatewayFilterChain chain);
}
```

**å‚æ•°å«ä¹‰é€šä¿—è§£é‡Š**ï¼š

| å‚æ•° | é€šä¿—ç†è§£ | ä¸“ä¸šè¯´æ˜ |
|------|---------|---------|
| `ServerWebExchange` | è¯·æ±‚å’Œå“åº”çš„"å·¥å…·ç®±" | åŒ…å«HTTPè¯·æ±‚ã€å“åº”ã€å±æ€§çš„ä¸Šä¸‹æ–‡å¯¹è±¡ |
| `GatewayFilterChain` | è¿‡æ»¤å™¨çš„"æ¥åŠ›æ£’" | è¿‡æ»¤å™¨é“¾ï¼Œç”¨äºä¼ é€’åˆ°ä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨ |
| `Mono<Void>` | å¼‚æ­¥æ‰§è¡Œçš„"æ‰¿è¯º" | å“åº”å¼ç¼–ç¨‹è¿”å›ç±»å‹ï¼Œè¡¨ç¤ºå¼‚æ­¥æ“ä½œ |

### 2.3 å®æˆ˜æ¡ˆä¾‹ï¼šè®¤è¯è¿‡æ»¤å™¨


**éœ€æ±‚**ï¼šæ£€æŸ¥æ‰€æœ‰è¯·æ±‚æ˜¯å¦æºå¸¦Tokenï¼Œæ²¡æœ‰Tokenå°±æ‹’ç»è®¿é—®ã€‚

```java
@Component
public class AuthFilter implements GlobalFilter, Ordered {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, 
                            GatewayFilterChain chain) {
        // 1. è·å–è¯·æ±‚å¯¹è±¡
        ServerHttpRequest request = exchange.getRequest();
        
        // 2. ä»è¯·æ±‚å¤´è·å–Token
        String token = request.getHeaders().getFirst("Authorization");
        
        // 3. TokenéªŒè¯
        if (token == null || token.isEmpty()) {
            // æ²¡æœ‰Tokenï¼Œè¿”å›401é”™è¯¯
            ServerHttpResponse response = exchange.getResponse();
            response.setStatusCode(HttpStatus.UNAUTHORIZED);
            return response.setComplete(); // ç»“æŸè¯·æ±‚
        }
        
        // 4. TokenéªŒè¯é€šè¿‡ï¼Œæ”¾è¡Œåˆ°ä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨
        return chain.filter(exchange);
    }
    
    // è®¾ç½®è¿‡æ»¤å™¨ä¼˜å…ˆçº§ï¼ˆæ•°å­—è¶Šå°è¶Šå…ˆæ‰§è¡Œï¼‰
    @Override
    public int getOrder() {
        return -100; // è®¤è¯è¿‡æ»¤å™¨ä¼˜å…ˆçº§é«˜
    }
}
```

**ä»£ç è¯¦è§£**ï¼š

ğŸ”¹ **æ­¥éª¤1**ï¼š`exchange.getRequest()` è·å–è¯·æ±‚å¯¹è±¡
- å°±åƒå¿«é€’å‘˜æ‹¿åˆ°åŒ…è£¹ä¿¡æ¯

ğŸ”¹ **æ­¥éª¤2**ï¼š`getHeaders().getFirst("Authorization")` è·å–è¯·æ±‚å¤´
- æ£€æŸ¥åŒ…è£¹ä¸Šçš„"å¯„ä»¶äººä¿¡æ¯"

ğŸ”¹ **æ­¥éª¤3**ï¼šTokenéªŒè¯å¤±è´¥å¤„ç†
- `setStatusCode(HttpStatus.UNAUTHORIZED)` è®¾ç½®401çŠ¶æ€ç 
- `setComplete()` ç»“æŸè¯·æ±‚ï¼Œä¸å†å¾€ä¸‹ä¼ é€’

ğŸ”¹ **æ­¥éª¤4**ï¼š`chain.filter(exchange)` æ”¾è¡Œ
- æŠŠè¯·æ±‚ä¼ é€’ç»™ä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨å¤„ç†

### 2.4 GlobalFilteråº”ç”¨åœºæ™¯


**å¸¸è§ä½¿ç”¨åœºæ™¯**ï¼š

| åœºæ™¯ | è¯´æ˜ | ä»£ç å…³é”®ç‚¹ |
|------|------|-----------|
| ğŸ” **ç»Ÿä¸€è®¤è¯** | éªŒè¯ç”¨æˆ·ç™»å½•çŠ¶æ€ | æ£€æŸ¥Tokenã€Session |
| ğŸ“Š **è¯·æ±‚æ—¥å¿—** | è®°å½•æ‰€æœ‰è¯·æ±‚ä¿¡æ¯ | è®°å½•æ—¶é—´ã€IPã€è·¯å¾„ |
| ğŸš¦ **å…¨å±€é™æµ** | æ§åˆ¶æ€»ä½“è®¿é—®é‡ | ä½¿ç”¨Redisè®¡æ•°å™¨ |
| ğŸŒ **è·¨åŸŸå¤„ç†** | å…è®¸è·¨åŸŸè¯·æ±‚ | æ·»åŠ CORSå“åº”å¤´ |
| â±ï¸ **è¶…æ—¶æ§åˆ¶** | è¯·æ±‚è¶…æ—¶å¤„ç† | è®¾ç½®è¶…æ—¶æ—¶é—´ |

---

## 3. ğŸ¯ ç½‘å…³è¿‡æ»¤å™¨GatewayFilter


### 3.1 GatewayFilteråŸºæœ¬æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯GatewayFilter**ï¼šç½‘å…³è¿‡æ»¤å™¨åªå¯¹**æŒ‡å®šçš„è·¯ç”±**ç”Ÿæ•ˆï¼Œå¯ä»¥é’ˆå¯¹ä¸åŒçš„æœåŠ¡åšä¸åŒçš„å¤„ç†ã€‚

**ç”Ÿæ´»ç±»æ¯”**ï¼š
```
è¿›å…¥åŒ»é™¢çœ‹ç—…                APIç½‘å…³è·¯ç”±
    â†“                          â†“
æ€»æœåŠ¡å°ï¼ˆå…¨å±€ï¼‰          GlobalFilter
    â†“                          â†“
å†…ç§‘ã€å¤–ç§‘ã€å„¿ç§‘         ä¸åŒè·¯ç”±è§„åˆ™
    â†“                          â†“
ç§‘å®¤ä¸“å±æ£€æŸ¥              GatewayFilter
(å†…ç§‘é‡è¡€å‹/å¤–ç§‘æ‹ç‰‡)    (æ·»åŠ è¯·æ±‚å¤´/ä¿®æ”¹è·¯å¾„)
```

### 3.2 GatewayFilteré…ç½®æ–¹å¼


**æ–¹å¼ä¸€ï¼šé…ç½®æ–‡ä»¶æ–¹å¼**

```yaml
spring:
  cloud:
    gateway:
      routes:
        - id: user-service
          uri: lb://user-service
          predicates:
            - Path=/user/**
          filters:  # ğŸ‘ˆ åªå¯¹è¿™ä¸ªè·¯ç”±ç”Ÿæ•ˆ
            - AddRequestHeader=X-Request-Source, Gateway
            - AddResponseHeader=X-Response-Time, ${timestamp}
```

**é…ç½®è§£è¯»**ï¼š
- `AddRequestHeader`ï¼šç»™è¯·æ±‚æ·»åŠ å¤´ä¿¡æ¯
  - åç§°ï¼š`X-Request-Source`
  - å€¼ï¼š`Gateway`
  - ğŸ’¡ åç«¯æœåŠ¡å¯ä»¥çŸ¥é“è¯·æ±‚æ¥è‡ªç½‘å…³

- `AddResponseHeader`ï¼šç»™å“åº”æ·»åŠ å¤´ä¿¡æ¯
  - åç§°ï¼š`X-Response-Time`
  - å€¼ï¼šæ—¶é—´æˆ³
  - ğŸ’¡ å®¢æˆ·ç«¯å¯ä»¥çœ‹åˆ°å“åº”æ—¶é—´

**æ–¹å¼äºŒï¼šä»£ç é…ç½®æ–¹å¼**

```java
@Configuration
public class GatewayConfig {
    
    @Bean
    public RouteLocator customRoutes(RouteLocatorBuilder builder) {
        return builder.routes()
            .route("order-service", r -> r
                .path("/order/**")
                .filters(f -> f
                    .addRequestHeader("X-Request-Id", UUID.randomUUID().toString())
                    .stripPrefix(1)) // å»æ‰è·¯å¾„å‰ç¼€
                .uri("lb://order-service"))
            .build();
    }
}
```

### 3.3 è‡ªå®šä¹‰GatewayFilter


**éœ€æ±‚**ï¼šä¸ºç‰¹å®šæœåŠ¡æ·»åŠ è¯·æ±‚è®¡æ—¶åŠŸèƒ½ã€‚

```java
public class TimerFilter implements GatewayFilter, Ordered {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, 
                            GatewayFilterChain chain) {
        // è®°å½•å¼€å§‹æ—¶é—´
        long startTime = System.currentTimeMillis();
        
        // æ‰§è¡Œåç»­è¿‡æ»¤å™¨
        return chain.filter(exchange).then(
            Mono.fromRunnable(() -> {
                // è®¡ç®—è€—æ—¶
                long endTime = System.currentTimeMillis();
                long duration = endTime - startTime;
                
                System.out.println("è¯·æ±‚è€—æ—¶ï¼š" + duration + "ms");
            })
        );
    }
    
    @Override
    public int getOrder() {
        return 0;
    }
}
```

**æ ¸å¿ƒæŠ€å·§**ï¼š
- `.then()` æ–¹æ³•ï¼šåœ¨è¿‡æ»¤å™¨æ‰§è¡Œå®Œååšé¢å¤–æ“ä½œ
- `Mono.fromRunnable()`ï¼šæŠŠæ™®é€šä»£ç åŒ…è£…æˆå“åº”å¼

---

## 4. ğŸ­ å†…ç½®è¿‡æ»¤å™¨å·¥å‚


### 4.1 ä»€ä¹ˆæ˜¯è¿‡æ»¤å™¨å·¥å‚


**é€šä¿—ç†è§£**ï¼šSpring Cloud Gatewayè‡ªå¸¦çš„"å·¥å…·ç®±"ï¼Œæä¾›äº†å¾ˆå¤šç°æˆçš„è¿‡æ»¤å™¨ï¼Œç›´æ¥é…ç½®å°±èƒ½ç”¨ã€‚

**å·¥å‚æ¨¡å¼ç±»æ¯”**ï¼š
```
æ‰‹æœºå·¥å‚                    è¿‡æ»¤å™¨å·¥å‚
    â†“                          â†“
ç”Ÿäº§çº¿A â†’ ç”Ÿäº§iPhone    â†’  AddRequestHeaderGatewayFilterFactory
ç”Ÿäº§çº¿B â†’ ç”Ÿäº§å°ç±³      â†’  StripPrefixGatewayFilterFactory
ç”Ÿäº§çº¿C â†’ ç”Ÿäº§åä¸º      â†’  RewritePathGatewayFilterFactory
```

### 4.2 å¸¸ç”¨å†…ç½®è¿‡æ»¤å™¨


**ğŸ”¹ è¯·æ±‚å¤´å¤„ç†ç±»**

| è¿‡æ»¤å™¨ | ä½œç”¨ | é…ç½®ç¤ºä¾‹ |
|-------|------|---------|
| `AddRequestHeader` | æ·»åŠ è¯·æ±‚å¤´ | `AddRequestHeader=X-Request-ID, 123` |
| `RemoveRequestHeader` | åˆ é™¤è¯·æ±‚å¤´ | `RemoveRequestHeader=Cookie` |
| `SetRequestHeader` | è®¾ç½®è¯·æ±‚å¤´ | `SetRequestHeader=Host, www.example.com` |

**ğŸ”¹ è·¯å¾„å¤„ç†ç±»**

| è¿‡æ»¤å™¨ | ä½œç”¨ | é…ç½®ç¤ºä¾‹ | æ•ˆæœè¯´æ˜ |
|-------|------|---------|---------|
| `StripPrefix` | å»æ‰è·¯å¾„å‰ç¼€ | `StripPrefix=1` | `/api/user/info` â†’ `/user/info` |
| `PrefixPath` | æ·»åŠ è·¯å¾„å‰ç¼€ | `PrefixPath=/api` | `/user/info` â†’ `/api/user/info` |
| `RewritePath` | é‡å†™è·¯å¾„ | `RewritePath=/red(?<segment>/?.*), $\{segment}` | `/red/blue` â†’ `/blue` |

**ğŸ”¹ å‚æ•°å¤„ç†ç±»**

```yaml
filters:
  # æ·»åŠ è¯·æ±‚å‚æ•°
  - AddRequestParameter=color, red
  # åˆ é™¤è¯·æ±‚å‚æ•°  
  - RemoveRequestParameter=token
```

**å®é™…æ¡ˆä¾‹**ï¼š

```yaml
spring:
  cloud:
    gateway:
      routes:
        - id: user-api
          uri: lb://user-service
          predicates:
            - Path=/api/user/**
          filters:
            - StripPrefix=2           # /api/user/info â†’ /info
            - AddRequestHeader=X-From, Gateway
            - AddRequestParameter=version, v1
```

**è¯·æ±‚è½¬æ¢è¿‡ç¨‹**ï¼š
```
å®¢æˆ·ç«¯è¯·æ±‚ï¼šGET /api/user/info?name=tom
    â†“
StripPrefix=2 å¤„ç†ï¼šå»æ‰/api/user
    â†“
AddRequestHeaderï¼šæ·»åŠ è¯·æ±‚å¤´ X-From: Gateway
    â†“
AddRequestParameterï¼šæ·»åŠ å‚æ•° version=v1
    â†“
è½¬å‘åˆ°åç«¯ï¼šGET /info?name=tom&version=v1
è¯·æ±‚å¤´åŒ…å«ï¼šX-From: Gateway
```

### 4.3 å“åº”å¤„ç†è¿‡æ»¤å™¨


**ğŸ”¹ å“åº”å¤´å¤„ç†**

```yaml
filters:
  - AddResponseHeader=X-Response-Time, ${timestamp}
  - RemoveResponseHeader=Server
  - SetResponseHeader=Cache-Control, max-age=3600
```

**ğŸ”¹ çŠ¶æ€ç å¤„ç†**

```yaml
filters:
  # ä¿®æ”¹å“åº”çŠ¶æ€ç 
  - SetStatus=200
  # é‡å®šå‘
  - RedirectTo=302, https://www.example.com
```

---

## 5. ğŸ› ï¸ è‡ªå®šä¹‰è¿‡æ»¤å™¨å¼€å‘


### 5.1 è‡ªå®šä¹‰GlobalFilterå®Œæ•´æ¡ˆä¾‹


**éœ€æ±‚**ï¼šè®°å½•æ‰€æœ‰è¯·æ±‚çš„è¯¦ç»†æ—¥å¿—ï¼ˆIPã€è·¯å¾„ã€è€—æ—¶ï¼‰

```java
@Slf4j
@Component
public class RequestLogFilter implements GlobalFilter, Ordered {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, 
                            GatewayFilterChain chain) {
        // 1ï¸âƒ£ è·å–è¯·æ±‚ä¿¡æ¯
        ServerHttpRequest request = exchange.getRequest();
        String path = request.getPath().value();
        String method = request.getMethodValue();
        String ip = request.getRemoteAddress().getHostString();
        
        // 2ï¸âƒ£ è®°å½•å¼€å§‹æ—¶é—´
        long startTime = System.currentTimeMillis();
        
        // 3ï¸âƒ£ æ‰“å°è¯·æ±‚æ—¥å¿—
        log.info("è¯·æ±‚å¼€å§‹ >>> æ–¹æ³•:{} è·¯å¾„:{} IP:{}", method, path, ip);
        
        // 4ï¸âƒ£ æ‰§è¡Œåç»­è¿‡æ»¤å™¨ï¼Œå¹¶åœ¨å®Œæˆåè®°å½•è€—æ—¶
        return chain.filter(exchange).then(
            Mono.fromRunnable(() -> {
                long endTime = System.currentTimeMillis();
                long duration = endTime - startTime;
                
                // è·å–å“åº”çŠ¶æ€ç 
                HttpStatus statusCode = exchange.getResponse().getStatusCode();
                
                log.info("è¯·æ±‚å®Œæˆ <<< çŠ¶æ€ç :{} è€—æ—¶:{}ms", statusCode, duration);
            })
        );
    }
    
    @Override
    public int getOrder() {
        return -200; // æœ€å…ˆæ‰§è¡Œ
    }
}
```

**å…³é”®ç‚¹è§£æ**ï¼š

ğŸ“Œ **è·å–è¯·æ±‚ä¿¡æ¯**
- `getPath().value()`ï¼šè·å–è¯·æ±‚è·¯å¾„
- `getMethodValue()`ï¼šè·å–HTTPæ–¹æ³•ï¼ˆGET/POST...ï¼‰
- `getRemoteAddress().getHostString()`ï¼šè·å–å®¢æˆ·ç«¯IP

ğŸ“Œ **å“åº”å¼å¤„ç†**
- `chain.filter(exchange)`ï¼šä¼ é€’ç»™ä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨
- `.then()`ï¼šåœ¨å‰é¢çš„æ“ä½œå®Œæˆåæ‰§è¡Œ
- `Mono.fromRunnable()`ï¼šåŒ…è£…æ™®é€šä»£ç ä¸ºå“åº”å¼

### 5.2 è‡ªå®šä¹‰GatewayFilterFactory


**åˆ›å»ºè¿‡æ»¤å™¨å·¥å‚çš„ä¸‰ä¸ªæ­¥éª¤**ï¼š

**æ­¥éª¤1ï¸âƒ£**ï¼šå®šä¹‰é…ç½®ç±»
```java
@Data
public class CustomConfig {
    private String headerName;  // è¦æ·»åŠ çš„è¯·æ±‚å¤´åç§°
    private String headerValue; // è¯·æ±‚å¤´çš„å€¼
}
```

**æ­¥éª¤2ï¸âƒ£**ï¼šç»§æ‰¿AbstractGatewayFilterFactory
```java
@Component
public class CustomGatewayFilterFactory 
    extends AbstractGatewayFilterFactory<CustomConfig> {
    
    public CustomGatewayFilterFactory() {
        super(CustomConfig.class);
    }
    
    @Override
    public GatewayFilter apply(CustomConfig config) {
        return (exchange, chain) -> {
            // æ·»åŠ è‡ªå®šä¹‰è¯·æ±‚å¤´
            ServerHttpRequest request = exchange.getRequest()
                .mutate()
                .header(config.getHeaderName(), config.getHeaderValue())
                .build();
            
            return chain.filter(exchange.mutate().request(request).build());
        };
    }
    
    @Override
    public List<String> shortcutFieldOrder() {
        return Arrays.asList("headerName", "headerValue");
    }
}
```

**æ­¥éª¤3ï¸âƒ£**ï¼šé…ç½®æ–‡ä»¶ä½¿ç”¨
```yaml
spring:
  cloud:
    gateway:
      routes:
        - id: user-service
          uri: lb://user-service
          filters:
            - Custom=X-Custom-Header, CustomValue
```

**å‘½åè§„èŒƒ**ï¼š
- ç±»åï¼š`CustomGatewayFilterFactory`
- é…ç½®ä¸­ä½¿ç”¨ï¼š`Custom`ï¼ˆè‡ªåŠ¨å»æ‰`GatewayFilterFactory`åç¼€ï¼‰

---

## 6. ğŸ“Š è¿‡æ»¤å™¨æ‰§è¡Œé¡ºåº


### 6.1 Orderä¼˜å…ˆçº§è§„åˆ™


**æ ¸å¿ƒåŸåˆ™**ï¼šæ•°å­—è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼ˆè¶Šå…ˆæ‰§è¡Œï¼‰

```
æ‰§è¡Œé¡ºåºå›¾ç¤ºï¼š
Orderå€¼      è¿‡æ»¤å™¨ç±»å‹          æ‰§è¡Œæ—¶æœº
-200    â†’  RequestLogFilter  (æœ€å…ˆæ‰§è¡Œ)
  â†“
-100    â†’  AuthFilter        (è®¤è¯æ£€æŸ¥)
  â†“
  0     â†’  DefaultFilter     (é»˜è®¤è¿‡æ»¤å™¨)
  â†“
 100    â†’  CustomFilter      (è‡ªå®šä¹‰é€»è¾‘)
  â†“
 200    â†’  ResponseFilter    (æœ€åæ‰§è¡Œ)
```

**ä»£ç å®ç°**ï¼š
```java
@Component
public class AuthFilter implements GlobalFilter, Ordered {
    @Override
    public int getOrder() {
        return -100; // ğŸ‘ˆ è®¾ç½®ä¼˜å…ˆçº§
    }
}
```

### 6.2 è¿‡æ»¤å™¨æ‰§è¡Œæµç¨‹


**è¯·æ±‚å¤„ç†å®Œæ•´æµç¨‹**ï¼š

```
å®¢æˆ·ç«¯è¯·æ±‚
    â†“
ã€Preé˜¶æ®µï¼šæŒ‰Orderä»å°åˆ°å¤§æ‰§è¡Œã€‘
    â†“
GlobalFilter(-200) â†’ æ—¥å¿—è®°å½•å¼€å§‹
    â†“
GlobalFilter(-100) â†’ Tokenè®¤è¯
    â†“  
GatewayFilter(0)   â†’ æ·»åŠ è¯·æ±‚å¤´
    â†“
è½¬å‘åˆ°åç«¯æœåŠ¡
    â†“
åç«¯æœåŠ¡å¤„ç†
    â†“
ã€Posté˜¶æ®µï¼šæŒ‰Orderä»å¤§åˆ°å°æ‰§è¡Œã€‘
    â†“
GatewayFilter(0)   â†’ æ·»åŠ å“åº”å¤´
    â†“
GlobalFilter(-100) â†’ è®°å½•è®¤è¯ä¿¡æ¯
    â†“
GlobalFilter(-200) â†’ æ—¥å¿—è®°å½•ç»“æŸ
    â†“
è¿”å›ç»™å®¢æˆ·ç«¯
```

**é¡ºåºæ§åˆ¶æŠ€å·§**ï¼š

| Orderå€¼èŒƒå›´ | å»ºè®®ç”¨é€” | ç¤ºä¾‹ |
|-----------|---------|------|
| **-1000 ~ -500** | ç³»ç»Ÿçº§è¿‡æ»¤å™¨ | é™æµã€ç†”æ–­ |
| **-500 ~ 0** | ä¸šåŠ¡çº§è¿‡æ»¤å™¨ | è®¤è¯ã€æ—¥å¿— |
| **0 ~ 500** | åŠŸèƒ½æ€§è¿‡æ»¤å™¨ | æ·»åŠ è¯·æ±‚å¤´ |
| **500 ~ 1000** | å“åº”å¤„ç†è¿‡æ»¤å™¨ | æ•°æ®åŠ å¯† |

### 6.3 å¤šä¸ªè¿‡æ»¤å™¨ååŒå·¥ä½œ


**å®æˆ˜æ¡ˆä¾‹**ï¼šè¯·æ±‚å¤„ç†é“¾

```java
// 1ï¸âƒ£ é™æµè¿‡æ»¤å™¨ï¼ˆæœ€å…ˆæ‰§è¡Œï¼‰
@Component
public class RateLimitFilter implements GlobalFilter, Ordered {
    @Override
    public int getOrder() { return -500; }
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, 
                            GatewayFilterChain chain) {
        // æ£€æŸ¥è¯·æ±‚é¢‘ç‡
        if (isRateLimited()) {
            return blockRequest(exchange);
        }
        return chain.filter(exchange);
    }
}

// 2ï¸âƒ£ è®¤è¯è¿‡æ»¤å™¨ï¼ˆç¬¬äºŒæ‰§è¡Œï¼‰
@Component
public class AuthFilter implements GlobalFilter, Ordered {
    @Override
    public int getOrder() { return -100; }
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, 
                            GatewayFilterChain chain) {
        // æ£€æŸ¥Token
        if (!hasValidToken(exchange)) {
            return unauthorized(exchange);
        }
        return chain.filter(exchange);
    }
}

// 3ï¸âƒ£ æ—¥å¿—è¿‡æ»¤å™¨ï¼ˆæœ€åæ‰§è¡Œï¼‰
@Component
public class LogFilter implements GlobalFilter, Ordered {
    @Override
    public int getOrder() { return 0; }
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, 
                            GatewayFilterChain chain) {
        // è®°å½•è¯·æ±‚æ—¥å¿—
        logRequest(exchange);
        return chain.filter(exchange);
    }
}
```

**æ‰§è¡Œæ•ˆæœ**ï¼š
```
è¯·æ±‚åˆ°è¾¾
    â†“
RateLimitFilter(-500)  âœ… é€šè¿‡é™æµæ£€æŸ¥
    â†“
AuthFilter(-100)       âœ… é€šè¿‡è®¤è¯æ£€æŸ¥
    â†“
LogFilter(0)          ğŸ“ è®°å½•æ—¥å¿—
    â†“
è½¬å‘åˆ°åç«¯æœåŠ¡
```

---

## 7. ğŸ”— è¿‡æ»¤å™¨é“¾è°ƒç”¨æœºåˆ¶


### 7.1 ä»€ä¹ˆæ˜¯è¿‡æ»¤å™¨é“¾


**é€šä¿—ç†è§£**ï¼šè¿‡æ»¤å™¨é“¾å°±åƒå·¥å‚æµæ°´çº¿ï¼Œè¯·æ±‚åƒäº§å“ä¸€æ ·ç»è¿‡æ¯ä¸ªå·¥ä½ï¼ˆè¿‡æ»¤å™¨ï¼‰åŠ å·¥å¤„ç†ã€‚

```
å·¥å‚æµæ°´çº¿                  è¿‡æ»¤å™¨é“¾
åŸææ–™è¿›å…¥          â†’    è¯·æ±‚åˆ°è¾¾ç½‘å…³
    â†“                       â†“
å·¥ä½1ï¼šè´¨æ£€         â†’    è¿‡æ»¤å™¨1ï¼šè®¤è¯
    â†“                       â†“
å·¥ä½2ï¼šç»„è£…         â†’    è¿‡æ»¤å™¨2ï¼šæ—¥å¿—
    â†“                       â†“
å·¥ä½3ï¼šåŒ…è£…         â†’    è¿‡æ»¤å™¨3ï¼šé™æµ
    â†“                       â†“
æˆå“å‡ºå‚            â†’    è½¬å‘åˆ°åç«¯
```

### 7.2 Chainçš„å·¥ä½œåŸç†


**æ ¸å¿ƒæ¥å£**ï¼š
```java
public interface GatewayFilterChain {
    Mono<Void> filter(ServerWebExchange exchange);
}
```

**è°ƒç”¨æœºåˆ¶å›¾ç¤º**ï¼š
```
Filter1.filter(exchange, chain)
    â†“
æ‰§è¡ŒFilter1çš„ä¸šåŠ¡é€»è¾‘
    â†“
è°ƒç”¨ chain.filter(exchange) â† ä¼ é€’ç»™ä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨
    â†“
Filter2.filter(exchange, chain)
    â†“
æ‰§è¡ŒFilter2çš„ä¸šåŠ¡é€»è¾‘
    â†“
è°ƒç”¨ chain.filter(exchange)
    â†“
...ç»§ç»­ä¼ é€’
```

**ä»£ç ç¤ºä¾‹**ï¼š
```java
@Component
public class DemoFilter implements GlobalFilter, Ordered {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, 
                            GatewayFilterChain chain) {
        
        System.out.println("å‰ç½®å¤„ç†ï¼šè¿›å…¥è¿‡æ»¤å™¨");
        
        // ğŸ‘‡ æŠŠè¯·æ±‚ä¼ é€’ç»™ä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨
        return chain.filter(exchange).then(
            Mono.fromRunnable(() -> {
                System.out.println("åç½®å¤„ç†ï¼šç¦»å¼€è¿‡æ»¤å™¨");
            })
        );
    }
    
    @Override
    public int getOrder() {
        return 0;
    }
}
```

**æ‰§è¡Œè¾“å‡º**ï¼š
```
å‰ç½®å¤„ç†ï¼šè¿›å…¥è¿‡æ»¤å™¨
â†“ (chain.filterä¼ é€’)
... å…¶ä»–è¿‡æ»¤å™¨æ‰§è¡Œ ...
â†“ (è¿”å›)
åç½®å¤„ç†ï¼šç¦»å¼€è¿‡æ»¤å™¨
```

### 7.3 è¿‡æ»¤å™¨é“¾ä¼ é€’æ•°æ®


**éœ€æ±‚**ï¼šåœ¨è¿‡æ»¤å™¨ä¹‹é—´ä¼ é€’æ•°æ®

```java
// ç¬¬ä¸€ä¸ªè¿‡æ»¤å™¨ï¼šä¿å­˜æ•°æ®
@Component
public class SaveDataFilter implements GlobalFilter, Ordered {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, 
                            GatewayFilterChain chain) {
        // åœ¨exchangeä¸­ä¿å­˜æ•°æ®
        exchange.getAttributes().put("requestId", UUID.randomUUID().toString());
        exchange.getAttributes().put("startTime", System.currentTimeMillis());
        
        return chain.filter(exchange);
    }
    
    @Override
    public int getOrder() {
        return -100;
    }
}

// ç¬¬äºŒä¸ªè¿‡æ»¤å™¨ï¼šè¯»å–æ•°æ®
@Component
public class ReadDataFilter implements GlobalFilter, Ordered {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, 
                            GatewayFilterChain chain) {
        // ä»exchangeä¸­è¯»å–æ•°æ®
        String requestId = exchange.getAttribute("requestId");
        Long startTime = exchange.getAttribute("startTime");
        
        System.out.println("è¯·æ±‚IDï¼š" + requestId);
        System.out.println("å¼€å§‹æ—¶é—´ï¼š" + startTime);
        
        return chain.filter(exchange);
    }
    
    @Override
    public int getOrder() {
        return 0;
    }
}
```

**æ•°æ®ä¼ é€’æœºåˆ¶**ï¼š
```
ServerWebExchangeï¼ˆä¸Šä¸‹æ–‡å¯¹è±¡ï¼‰
    â†“
.getAttributes() â† è·å–å±æ€§Map
    â†“
.put(key, value) â† å­˜æ•°æ®
.get(key)        â† å–æ•°æ®
```

### 7.4 ä¸­æ–­è¿‡æ»¤å™¨é“¾


**åœºæ™¯**ï¼šè®¤è¯å¤±è´¥æ—¶ï¼Œä¸å†æ‰§è¡Œåç»­è¿‡æ»¤å™¨

```java
@Component
public class AuthFilter implements GlobalFilter, Ordered {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, 
                            GatewayFilterChain chain) {
        
        String token = exchange.getRequest()
            .getHeaders().getFirst("Authorization");
        
        // TokenéªŒè¯å¤±è´¥
        if (token == null || !isValidToken(token)) {
            ServerHttpResponse response = exchange.getResponse();
            response.setStatusCode(HttpStatus.UNAUTHORIZED);
            
            // âš ï¸ ç›´æ¥è¿”å›ï¼Œä¸è°ƒç”¨chain.filter()ï¼Œä¸­æ–­è¿‡æ»¤å™¨é“¾
            return response.setComplete();
        }
        
        // âœ… éªŒè¯é€šè¿‡ï¼Œç»§ç»­æ‰§è¡Œåç»­è¿‡æ»¤å™¨
        return chain.filter(exchange);
    }
    
    @Override
    public int getOrder() {
        return -100;
    }
}
```

**é“¾è·¯å¯¹æ¯”**ï¼š
```
æ­£å¸¸æµç¨‹ï¼š
AuthFilter â†’ chain.filter() â†’ ä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨ â†’ ... â†’ åç«¯æœåŠ¡

ä¸­æ–­æµç¨‹ï¼š
AuthFilter â†’ response.setComplete() â†’ âŒ ç›´æ¥è¿”å›ï¼Œä¸å†æ‰§è¡Œåç»­
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ è¿‡æ»¤å™¨æœ¬è´¨ï¼šè¯·æ±‚å¤„ç†çš„æ‹¦æˆªå™¨ï¼Œåœ¨è¯·æ±‚åˆ°è¾¾åç«¯å‰åè¿›è¡Œå¤„ç†
ğŸ”¸ ä¸¤å¤§åˆ†ç±»ï¼šGlobalFilterï¼ˆå…¨å±€ï¼‰å’Œ GatewayFilterï¼ˆå±€éƒ¨ï¼‰
ğŸ”¸ æ‰§è¡Œé¡ºåºï¼šé€šè¿‡Orderå€¼æ§åˆ¶ï¼Œæ•°å­—è¶Šå°è¶Šå…ˆæ‰§è¡Œ
ğŸ”¸ è¿‡æ»¤å™¨é“¾ï¼šé€šè¿‡chain.filter()ä¼ é€’è¯·æ±‚åˆ°ä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨
ğŸ”¸ æ•°æ®ä¼ é€’ï¼šä½¿ç”¨exchange.getAttributes()åœ¨è¿‡æ»¤å™¨é—´å…±äº«æ•°æ®
```

### 8.2 GlobalFilter vs GatewayFilter


| å¯¹æ¯”ç»´åº¦ | GlobalFilter | GatewayFilter |
|---------|--------------|---------------|
| **ä½œç”¨èŒƒå›´** | æ‰€æœ‰è·¯ç”± | æŒ‡å®šè·¯ç”± |
| **é…ç½®æ–¹å¼** | ä»£ç é…ç½®ï¼ˆ@Componentï¼‰ | é…ç½®æ–‡ä»¶æˆ–ä»£ç  |
| **ä½¿ç”¨åœºæ™¯** | é€šç”¨åŠŸèƒ½ï¼ˆè®¤è¯ã€æ—¥å¿—ï¼‰ | ç‰¹å®šéœ€æ±‚ï¼ˆæ·»åŠ è¯·æ±‚å¤´ï¼‰ |
| **å®ç°æ–¹å¼** | å®ç°GlobalFilteræ¥å£ | å®ç°GatewayFilteræˆ–ä½¿ç”¨å·¥å‚ |
| **ç”Ÿå‘½å‘¨æœŸ** | åº”ç”¨å¯åŠ¨æ—¶åŠ è½½ | è·¯ç”±åŒ¹é…æ—¶åŠ è½½ |

### 8.3 è¿‡æ»¤å™¨å¼€å‘æœ€ä½³å®è·µ


**âœ… æ¨èåšæ³•**ï¼š
```
1. åˆç†è®¾ç½®Orderå€¼
   - è®¤è¯ï¼š-100
   - æ—¥å¿—ï¼š-200
   - ä¸šåŠ¡ï¼š0

2. é¿å…é˜»å¡æ“ä½œ
   âŒ Thread.sleep()
   âœ… ä½¿ç”¨å“åº”å¼API

3. å¼‚å¸¸å¤„ç†å®Œå–„
   try-catchåŒ…è£¹ä¸šåŠ¡é€»è¾‘

4. æ—¥å¿—è®°å½•æ¸…æ™°
   è®°å½•å…³é”®ä¿¡æ¯å’Œå¼‚å¸¸
```

**âŒ é¿å…é—®é¢˜**ï¼š
```
1. Orderå€¼å†²çª
   å¤šä¸ªè¿‡æ»¤å™¨ä¸è¦ä½¿ç”¨ç›¸åŒOrder

2. å¿˜è®°è°ƒç”¨chain.filter()
   ä¼šå¯¼è‡´è¯·æ±‚æ— æ³•è½¬å‘

3. é˜»å¡ä¸»çº¿ç¨‹
   é¿å…åŒæ­¥IOæ“ä½œ

4. å†…å­˜æ³„æ¼
   åŠæ—¶æ¸…ç†exchangeä¸­çš„æ•°æ®
```

### 8.4 å®é™…åº”ç”¨åœºæ™¯æ€»ç»“


**GlobalFilteråº”ç”¨**ï¼š
- ğŸ” ç»Ÿä¸€è®¤è¯æˆæƒ
- ğŸ“Š å…¨å±€è¯·æ±‚æ—¥å¿—
- ğŸš¦ å…¨å±€é™æµç†”æ–­
- ğŸŒ è·¨åŸŸé…ç½®
- ğŸ”’ æ•æ„Ÿæ•°æ®åŠ å¯†

**GatewayFilteråº”ç”¨**ï¼š
- ğŸ“ ç‰¹å®šæœåŠ¡æ·»åŠ è¯·æ±‚å¤´
- ğŸ”„ è·¯å¾„é‡å†™å’Œå‰ç¼€å¤„ç†
- â±ï¸ å•ä¸ªæœåŠ¡è¶…æ—¶æ§åˆ¶
- ğŸ¯ ç‰¹å®šæœåŠ¡å‚æ•°æ ¡éªŒ
- ğŸ“¦ å“åº”æ•°æ®è½¬æ¢

### 8.5 è¿‡æ»¤å™¨é“¾æ‰§è¡Œè®°å¿†å£è¯€


```
è¿‡æ»¤å™¨é“¾åƒæµæ°´çº¿ï¼Œ
Orderå€¼å°çš„æ’å‰é¢ï¼Œ
Preé˜¶æ®µä»å°åˆ°å¤§ï¼Œ
Posté˜¶æ®µä»å¤§åˆ°å°ï¼Œ
chain.filterè¦è®°ç‰¢ï¼Œ
ä¸è°ƒç”¨å°±ä¼šä¸­æ–­æ‰ã€‚
```

**æ ¸å¿ƒç†è§£**ï¼š
- è¿‡æ»¤å™¨ = è¯·æ±‚å¤„ç†çš„ä¸­é—´ä»¶
- è¿‡æ»¤å™¨é“¾ = èŒè´£é“¾æ¨¡å¼çš„åº”ç”¨
- Orderå€¼ = æ‰§è¡Œé¡ºåºçš„æ§åˆ¶å™¨
- chain.filter() = ä¼ é€’è¯·æ±‚çš„æ¥åŠ›æ£’
- exchange = è¯·æ±‚ä¸Šä¸‹æ–‡çš„è½½ä½“