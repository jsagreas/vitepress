---
title: 4ã€å†…å­˜é™æµå®ç°
---
## ğŸ“š ç›®å½•

1. [ä»€ä¹ˆæ˜¯å†…å­˜é™æµ](#1-ä»€ä¹ˆæ˜¯å†…å­˜é™æµ)
2. [æœ¬åœ°ç¼“å­˜é™æµæ–¹æ¡ˆ](#2-æœ¬åœ°ç¼“å­˜é™æµæ–¹æ¡ˆ)
3. [Guava RateLimiterè¯¦è§£](#3-Guava-RateLimiterè¯¦è§£)
4. [è‡ªå®šä¹‰é™æµå™¨å®ç°](#4-è‡ªå®šä¹‰é™æµå™¨å®ç°)
5. [é›†ç¾¤é™æµæ•°æ®åŒæ­¥](#5-é›†ç¾¤é™æµæ•°æ®åŒæ­¥)
6. [é™æµçŠ¶æ€æŒä¹…åŒ–](#6-é™æµçŠ¶æ€æŒä¹…åŒ–)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ’¾ ä»€ä¹ˆæ˜¯å†…å­˜é™æµ


### 1.1 æ ¸å¿ƒæ¦‚å¿µç†è§£


**å†…å­˜é™æµå°±æ˜¯æŠŠé™æµæ•°æ®å­˜åœ¨æœåŠ¡å™¨å†…å­˜é‡Œ**

æƒ³è±¡ä¸€ä¸ªåœºæ™¯ï¼šä½ å®¶é—¨å£æœ‰ä¸ªä¿å®‰ï¼Œä»–è„‘å­é‡Œè®°ç€"æ¯åˆ†é’Ÿæœ€å¤šè¿›10ä¸ªäºº"ï¼Œä¸ç”¨æŸ¥æœ¬å­ã€ä¸ç”¨æ‰“ç”µè¯é—®åˆ«äººï¼Œç›´æ¥å°±èƒ½åˆ¤æ–­èƒ½ä¸èƒ½æ”¾äººè¿›æ¥ã€‚**è¿™å°±æ˜¯å†…å­˜é™æµ**ã€‚

```
ä¼ ç»Ÿé™æµï¼ˆæŸ¥æ•°æ®åº“ï¼‰ï¼š          å†…å­˜é™æµï¼ˆç›´æ¥åˆ¤æ–­ï¼‰ï¼š
ç”¨æˆ·è¯·æ±‚                       ç”¨æˆ·è¯·æ±‚
   â†“                             â†“
æŸ¥æ•°æ®åº“çœ‹è®¿é—®æ¬¡æ•°               ç›´æ¥è¯»å†…å­˜é‡Œçš„è®¡æ•°å™¨
   â†“                             â†“
åˆ¤æ–­æ˜¯å¦è¶…é™                     ç«‹å³åˆ¤æ–­æ˜¯å¦è¶…é™
   â†“                             â†“
å“åº”ï¼ˆæ…¢ï¼‰                       å“åº”ï¼ˆå¿«ï¼‰

å¯¹æ¯”ï¼šæŸ¥æ•°æ®åº“è¦10ms            è¯»å†…å­˜åªè¦0.01ms
```

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- âš¡ **é€Ÿåº¦å¿«** - ä¸éœ€è¦è®¿é—®æ•°æ®åº“æˆ–Redisï¼Œæ¯«ç§’çº§å“åº”
- ğŸ’° **æˆæœ¬ä½** - ä¸ä¾èµ–å¤–éƒ¨å­˜å‚¨ï¼Œå‡å°‘ç½‘ç»œå¼€é”€
- ğŸ”§ **å®ç°ç®€å•** - ä»£ç é€»è¾‘æ¸…æ™°ï¼Œå®¹æ˜“ç»´æŠ¤

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… å•æœºæœåŠ¡æˆ–å°è§„æ¨¡é›†ç¾¤
- âœ… å¯¹é™æµç²¾åº¦è¦æ±‚ä¸æ˜¯ç‰¹åˆ«ä¸¥æ ¼
- âœ… å¸Œæœ›é™ä½åŸºç¡€è®¾æ–½æˆæœ¬

### 1.2 å†…å­˜é™æµçš„å·¥ä½œåŸç†


**åŸºæœ¬æ€è·¯å°±æ˜¯"è®¡æ•°+æ—¶é—´çª—å£"**

```
è¯·æ±‚æ—¶é—´è½´ï¼š
|â€”â€”1ç§’â€”â€”|â€”â€”1ç§’â€”â€”|â€”â€”1ç§’â€”â€”|
   5æ¬¡      8æ¬¡      3æ¬¡
   â†“        â†“        â†“
  é€šè¿‡     æ‹’ç»     é€šè¿‡
(â‰¤10)   (>10)    (â‰¤10)

å†…å­˜ä¸­å­˜å‚¨ï¼š
{
  "userId:123": {
    "count": 8,           // å½“å‰è®¡æ•°
    "windowStart": 10:30:00  // çª—å£å¼€å§‹æ—¶é—´
  }
}
```

**å·¥ä½œæ­¥éª¤**ï¼š
1. **è¯·æ±‚åˆ°è¾¾** - ç”¨æˆ·å‘èµ·APIè°ƒç”¨
2. **è¯»å–å†…å­˜** - ä»å†…å­˜è·å–è¯¥ç”¨æˆ·çš„è®¿é—®è®°å½•
3. **åˆ¤æ–­çª—å£** - æ£€æŸ¥æ˜¯å¦åœ¨åŒä¸€æ—¶é—´çª—å£
4. **è®¡æ•°åˆ¤æ–­** - æ¯”è¾ƒæ¬¡æ•°æ˜¯å¦è¶…è¿‡é™åˆ¶
5. **æ›´æ–°çŠ¶æ€** - å¢åŠ è®¡æ•°æˆ–é‡ç½®çª—å£

---

## 2. ğŸ—‚ï¸ æœ¬åœ°ç¼“å­˜é™æµæ–¹æ¡ˆ


### 2.1 ä½¿ç”¨ConcurrentHashMapå®ç°


**ConcurrentHashMapå°±åƒä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„è®°äº‹æœ¬**

å¤šä¸ªç”¨æˆ·åŒæ—¶è®¿é—®æ—¶ï¼Œä¸ä¼šå‡ºç°æ•°æ®æ··ä¹±ã€‚å°±åƒå¤šä¸ªæ”¶é“¶å‘˜åŒæ—¶è®°è´¦ï¼Œæ¯ä¸ªäººçš„è´¦æœ¬éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œäº’ä¸å¹²æ‰°ã€‚

```java
public class LocalCacheLimiter {
    // å­˜å‚¨é™æµæ•°æ®çš„å®¹å™¨ï¼ˆçº¿ç¨‹å®‰å…¨çš„Mapï¼‰
    private ConcurrentHashMap<String, RateLimitInfo> limitCache;
    
    // é™æµä¿¡æ¯ç±»
    static class RateLimitInfo {
        int count;              // è®¿é—®æ¬¡æ•°
        long windowStart;       // çª—å£å¼€å§‹æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
        
        RateLimitInfo(int count, long windowStart) {
            this.count = count;
            this.windowStart = windowStart;
        }
    }
    
    public LocalCacheLimiter() {
        this.limitCache = new ConcurrentHashMap<>();
    }
    
    // æ£€æŸ¥æ˜¯å¦å…è®¸è®¿é—®
    public boolean allowRequest(String key, int maxCount, long windowMs) {
        long now = System.currentTimeMillis();
        
        // ä½¿ç”¨computeIfAbsentä¿è¯åŸå­æ€§æ“ä½œ
        RateLimitInfo info = limitCache.compute(key, (k, oldInfo) -> {
            // ç¬¬ä¸€æ¬¡è®¿é—®æˆ–çª—å£å·²è¿‡æœŸ
            if (oldInfo == null || now - oldInfo.windowStart > windowMs) {
                return new RateLimitInfo(1, now);
            }
            
            // åŒä¸€çª—å£å†…ï¼Œå¢åŠ è®¡æ•°
            oldInfo.count++;
            return oldInfo;
        });
        
        // åˆ¤æ–­æ˜¯å¦è¶…é™
        return info.count <= maxCount;
    }
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```java
// åˆ›å»ºé™æµå™¨
LocalCacheLimiter limiter = new LocalCacheLimiter();

// é™åˆ¶ç”¨æˆ·æ¯ç§’æœ€å¤šè®¿é—®10æ¬¡
String userId = "user_123";
boolean allowed = limiter.allowRequest(userId, 10, 1000);

if (allowed) {
    // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
    return "è¯·æ±‚æˆåŠŸ";
} else {
    return "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•";
}
```

### 2.2 å†…å­˜æ•°æ®æ¸…ç†ç­–ç•¥


**é—®é¢˜ï¼šå¦‚æœç”¨æˆ·ä¸€ç›´ä¸è®¿é—®ï¼Œæ•°æ®ä¼šä¸€ç›´å ç”¨å†…å­˜å—ï¼Ÿ**

ç­”æ¡ˆæ˜¯éœ€è¦**å®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®**ï¼Œå°±åƒå®šæœŸæ¸…ç†è¿‡æœŸæ–‡ä»¶ä¸€æ ·ã€‚

**æ¸…ç†ç­–ç•¥å¯¹æ¯”**ï¼š

| ç­–ç•¥ | å·¥ä½œåŸç† | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|---------|------|------|---------|
| **å®šæ—¶æ¸…ç†** | æ¯éš”ä¸€æ®µæ—¶é—´æ‰«ææ‰€æœ‰æ•°æ® | å®ç°ç®€å•ï¼Œæ¸…ç†å½»åº• | å¯èƒ½å½±å“æ€§èƒ½ | æ•°æ®é‡ä¸å¤§ |
| **æ‡’æƒ°æ¸…ç†** | è®¿é—®æ—¶æ£€æŸ¥æ˜¯å¦è¿‡æœŸ | ä¸å½±å“æ€§èƒ½ | å¯èƒ½æœ‰æ®‹ç•™æ•°æ® | è®¿é—®é¢‘ç¹ |
| **LRUæ·˜æ±°** | è‡ªåŠ¨æ·˜æ±°æœ€å°‘ä½¿ç”¨çš„æ•°æ® | å†…å­˜å¯æ§ | é…ç½®ç¨å¤æ‚ | å†…å­˜æœ‰é™ |

**å®šæ—¶æ¸…ç†å®ç°**ï¼š

```java
public class LocalCacheLimiter {
    private ConcurrentHashMap<String, RateLimitInfo> limitCache;
    private ScheduledExecutorService cleanExecutor;
    
    public LocalCacheLimiter(long cleanIntervalMs) {
        this.limitCache = new ConcurrentHashMap<>();
        
        // å¯åŠ¨å®šæ—¶æ¸…ç†ä»»åŠ¡
        this.cleanExecutor = Executors.newScheduledThreadPool(1);
        cleanExecutor.scheduleAtFixedRate(
            this::cleanExpiredData,
            cleanIntervalMs,
            cleanIntervalMs,
            TimeUnit.MILLISECONDS
        );
    }
    
    // æ¸…ç†è¿‡æœŸæ•°æ®
    private void cleanExpiredData() {
        long now = System.currentTimeMillis();
        
        limitCache.entrySet().removeIf(entry -> {
            // è¶…è¿‡5åˆ†é’Ÿæœªè®¿é—®çš„æ•°æ®æ¸…ç†æ‰
            return now - entry.getValue().windowStart > 300000;
        });
    }
}
```

---

## 3. ğŸ”§ Guava RateLimiterè¯¦è§£


### 3.1 ä»€ä¹ˆæ˜¯Guava RateLimiter


**Guava RateLimiteræ˜¯Googleæä¾›çš„ä¸€ä¸ªé™æµå·¥å…·ï¼Œå°±åƒä¸€ä¸ªæ™ºèƒ½æ°´é¾™å¤´**

ä½ å¯ä»¥è®¾å®šæ¯ç§’é’Ÿæœ€å¤šæµå‡ºå¤šå°‘"æ°´"ï¼ˆè¯·æ±‚ï¼‰ï¼Œè¶…è¿‡çš„éƒ¨åˆ†è¦ä¹ˆç­‰å¾…ï¼Œè¦ä¹ˆç›´æ¥æ‹’ç»ã€‚

```
æ™®é€šæ°´é¾™å¤´ï¼š                    æ™ºèƒ½æ°´é¾™å¤´(RateLimiter)ï¼š
å¼€å…³åªæœ‰å¼€/å…³                   å¯ä»¥ç²¾ç¡®æ§åˆ¶æµé€Ÿ
  â†“                              â†“
è¦ä¹ˆå…¨å¼€                        æ¯ç§’å›ºå®šæµé‡
è¦ä¹ˆå…¨å…³                        è¶…è¿‡çš„æ’é˜Ÿæˆ–æ‹’ç»

[========]  å…¨é€Ÿ               [==  ]  é™é€Ÿ
100ä¸ª/ç§’                        10ä¸ª/ç§’
```

**ä¸¤ç§é™æµæ¨¡å¼**ï¼š

ğŸ”¸ **å¹³æ»‘çªå‘æ¨¡å¼(SmoothBursty)** - å…è®¸çŸ­æ—¶é—´å†…çªå‘æµé‡
```
æ­£å¸¸æƒ…å†µï¼š====    ====    ====
çªå‘æƒ…å†µï¼š========        ====
         â†‘
       å…è®¸çŸ­æš‚è¶…é‡
```

ğŸ”¸ **å¹³æ»‘é¢„çƒ­æ¨¡å¼(SmoothWarmingUp)** - é€æ¸æå‡åˆ°æœ€å¤§é€Ÿç‡
```
å†·å¯åŠ¨ï¼š=    ==    ===    ====
        â†‘    â†‘     â†‘      â†‘
       æ…¢   æ…¢æ…¢   é€æ¸   æœ€å¿«
```

### 3.2 åŸºæœ¬ä½¿ç”¨æ–¹æ³•


**åˆ›å»ºé™æµå™¨**ï¼š

```java
// æ¯ç§’å…è®¸10ä¸ªè¯·æ±‚
RateLimiter limiter = RateLimiter.create(10.0);

// æ¯ç§’2ä¸ªè¯·æ±‚ï¼Œ3ç§’é¢„çƒ­æ—¶é—´
RateLimiter warmUpLimiter = RateLimiter.create(2.0, 3, TimeUnit.SECONDS);
```

**ä½¿ç”¨æ–¹å¼å¯¹æ¯”**ï¼š

```java
// æ–¹å¼1ï¼šé˜»å¡ç­‰å¾…ï¼ˆä¼šç­‰åˆ°è·å–åˆ°è®¸å¯ï¼‰
public String method1() {
    limiter.acquire();  // å¦‚æœè¶…é™ï¼Œä¼šç­‰å¾…
    return "è¯·æ±‚æˆåŠŸ";
}

// æ–¹å¼2ï¼šå°è¯•è·å–ï¼ˆè¶…æ—¶å°±æ”¾å¼ƒï¼‰
public String method2() {
    boolean acquired = limiter.tryAcquire(100, TimeUnit.MILLISECONDS);
    if (acquired) {
        return "è¯·æ±‚æˆåŠŸ";
    } else {
        return "ç³»ç»Ÿç¹å¿™";
    }
}

// æ–¹å¼3ï¼šç«‹å³åˆ¤æ–­ï¼ˆä¸ç­‰å¾…ï¼‰
public String method3() {
    if (limiter.tryAcquire()) {
        return "è¯·æ±‚æˆåŠŸ";
    } else {
        return "è¯·æ±‚è¿‡å¿«";
    }
}
```

### 3.3 å®æˆ˜åº”ç”¨åœºæ™¯


**åœºæ™¯1ï¼šAPIæ¥å£é™æµ**

```java
@RestController
public class UserController {
    // æ¯ç§’æœ€å¤š100ä¸ªè¯·æ±‚
    private final RateLimiter rateLimiter = RateLimiter.create(100.0);
    
    @GetMapping("/api/users")
    public Result getUsers() {
        // å°è¯•è·å–è®¸å¯ï¼Œæœ€å¤šç­‰å¾…50æ¯«ç§’
        if (!rateLimiter.tryAcquire(50, TimeUnit.MILLISECONDS)) {
            return Result.error("è¯·æ±‚è¿‡äºé¢‘ç¹");
        }
        
        // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
        List<User> users = userService.getUsers();
        return Result.success(users);
    }
}
```

**åœºæ™¯2ï¼šæ‰¹é‡ä»»åŠ¡é€Ÿç‡æ§åˆ¶**

```java
public class DataProcessor {
    // æ¯ç§’å¤„ç†50æ¡æ•°æ®
    private final RateLimiter rateLimiter = RateLimiter.create(50.0);
    
    public void processBatch(List<Data> dataList) {
        for (Data data : dataList) {
            // æ§åˆ¶å¤„ç†é€Ÿåº¦ï¼Œé¿å…å‹å®ä¸‹æ¸¸ç³»ç»Ÿ
            rateLimiter.acquire();
            processData(data);
        }
    }
}
```

**åœºæ™¯3ï¼šé¢„çƒ­å¼é™æµï¼ˆåº”å¯¹å†·å¯åŠ¨ï¼‰**

```java
// ç³»ç»Ÿåˆšå¯åŠ¨æ—¶ä»æ¯ç§’1ä¸ªè¯·æ±‚é€æ¸æå‡åˆ°100ä¸ª
// é¢„çƒ­æ—¶é—´30ç§’
RateLimiter warmUpLimiter = RateLimiter.create(
    100.0,           // æœ€å¤§é€Ÿç‡ï¼š100ä¸ª/ç§’
    30,              // é¢„çƒ­æ—¶é—´ï¼š30ç§’
    TimeUnit.SECONDS
);

// åº”ç”¨åœºæ™¯ï¼šé¿å…å†·å¯åŠ¨æ—¶å¤§é‡è¯·æ±‚å‹å®æœªå®Œå…¨åˆå§‹åŒ–çš„ç³»ç»Ÿ
```

### 3.4 å·¥ä½œåŸç†ç®€è¿°


**ä»¤ç‰Œæ¡¶ç®—æ³•ï¼ˆToken Bucketï¼‰**

```
ä»¤ç‰Œæ¡¶æ¨¡å‹ï¼š

    [ä»¤ç‰Œç”Ÿäº§å™¨]
         â†“ æ¯ç§’ç”ŸæˆNä¸ªä»¤ç‰Œ
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ğŸª™ğŸª™ğŸª™ğŸª™ â”‚ â† ä»¤ç‰Œæ¡¶ï¼ˆæœ‰å®¹é‡é™åˆ¶ï¼‰
    â”‚ ğŸª™ğŸª™    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ è¯·æ±‚æ¥äº†å–èµ°1ä¸ªä»¤ç‰Œ
    [å¤„ç†è¯·æ±‚]

è§„åˆ™ï¼š
- ä»¤ç‰Œä»¥å›ºå®šé€Ÿç‡ç”Ÿæˆï¼ˆå¦‚æ¯ç§’10ä¸ªï¼‰
- æ¡¶æœ‰æœ€å¤§å®¹é‡ï¼ˆå¦‚æœ€å¤šå­˜20ä¸ªï¼‰
- è¯·æ±‚éœ€è¦æ¶ˆè€—ä»¤ç‰Œæ‰èƒ½æ‰§è¡Œ
- æ²¡æœ‰ä»¤ç‰Œå°±ç­‰å¾…æˆ–æ‹’ç»
```

**æ ¸å¿ƒå‚æ•°å«ä¹‰**ï¼š

```java
RateLimiter.create(permitsPerSecond)
                   â†‘
          æ¯ç§’ç”Ÿæˆçš„ä»¤ç‰Œæ•°

RateLimiter.create(permitsPerSecond, warmupPeriod, unit)
                   â†‘                 â†‘
              æœ€å¤§é€Ÿç‡            é¢„çƒ­æ—¶é•¿
```

---

## 4. ğŸ› ï¸ è‡ªå®šä¹‰é™æµå™¨å®ç°


### 4.1 ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰é™æµå™¨


**Guava RateLimiterå¾ˆå¥½ï¼Œä½†æœ‰æ—¶å€™ä¸å¤Ÿç”¨**

- âŒ ä¸æ”¯æŒåˆ†å¸ƒå¼ï¼ˆåªèƒ½å•æœºä½¿ç”¨ï¼‰
- âŒ ä¸èƒ½åŠ¨æ€è°ƒæ•´é™æµè§„åˆ™
- âŒ ç¼ºå°‘è¯¦ç»†çš„é™æµç»Ÿè®¡ä¿¡æ¯

**è‡ªå®šä¹‰é™æµå™¨å¯ä»¥åšåˆ°**ï¼š
- âœ… çµæ´»çš„é™æµç­–ç•¥
- âœ… è¯¦ç»†çš„ç»Ÿè®¡ä¿¡æ¯
- âœ… åŠ¨æ€é…ç½®è°ƒæ•´
- âœ… æ›´ç¬¦åˆä¸šåŠ¡éœ€æ±‚

### 4.2 æ»‘åŠ¨çª—å£é™æµå™¨å®ç°


**æ»‘åŠ¨çª—å£æ¯”å›ºå®šçª—å£æ›´ç²¾ç¡®**

```
å›ºå®šçª—å£é—®é¢˜ï¼š
0s      1s      2s      3s
|â€”â€”10æ¬¡â€”â€”|â€”â€”10æ¬¡â€”â€”|
           â†‘
    è¾¹ç•Œå¤„å¯èƒ½20æ¬¡/ç§’

æ»‘åŠ¨çª—å£è§£å†³ï¼š
æ—¶é—´: 0.5s   1.5s   2.5s
     |â€”â€”â€”â€”1ç§’â€”â€”â€”â€”|
         â†‘
    ä»»æ„æ—¶åˆ»éƒ½ç²¾ç¡®
```

**ä»£ç å®ç°**ï¼š

```java
public class SlidingWindowLimiter {
    // å­˜å‚¨æ¯ä¸ªkeyçš„è®¿é—®æ—¶é—´æˆ³é˜Ÿåˆ—
    private final ConcurrentHashMap<String, Queue<Long>> windowMap;
    
    public SlidingWindowLimiter() {
        this.windowMap = new ConcurrentHashMap<>();
    }
    
    public boolean allowRequest(String key, int maxCount, long windowMs) {
        long now = System.currentTimeMillis();
        
        // è·å–æˆ–åˆ›å»ºæ—¶é—´æˆ³é˜Ÿåˆ—
        Queue<Long> timestamps = windowMap.computeIfAbsent(
            key, 
            k -> new ConcurrentLinkedQueue<>()
        );
        
        // ç§»é™¤çª—å£å¤–çš„æ—§æ—¶é—´æˆ³
        timestamps.removeIf(timestamp -> now - timestamp > windowMs);
        
        // æ£€æŸ¥å½“å‰çª—å£å†…çš„è¯·æ±‚æ•°
        if (timestamps.size() < maxCount) {
            timestamps.offer(now);  // æ·»åŠ å½“å‰æ—¶é—´æˆ³
            return true;
        }
        
        return false;
    }
    
    // è·å–ç»Ÿè®¡ä¿¡æ¯
    public LimitStats getStats(String key) {
        Queue<Long> timestamps = windowMap.get(key);
        if (timestamps == null) {
            return new LimitStats(0, 0);
        }
        
        long now = System.currentTimeMillis();
        long count = timestamps.stream()
            .filter(t -> now - t <= 1000)  // æœ€è¿‘1ç§’
            .count();
            
        return new LimitStats(count, timestamps.size());
    }
}

// ç»Ÿè®¡ä¿¡æ¯ç±»
class LimitStats {
    long recentCount;    // æœ€è¿‘1ç§’è¯·æ±‚æ•°
    long totalCount;     // çª—å£å†…æ€»è¯·æ±‚æ•°
    
    LimitStats(long recentCount, long totalCount) {
        this.recentCount = recentCount;
        this.totalCount = totalCount;
    }
}
```

### 4.3 å¯é…ç½®çš„é™æµå™¨


**æ”¯æŒåŠ¨æ€è°ƒæ•´é™æµè§„åˆ™**

```java
public class ConfigurableLimiter {
    private volatile int maxCount;      // æœ€å¤§è¯·æ±‚æ•°ï¼ˆå¯åŠ¨æ€ä¿®æ”¹ï¼‰
    private volatile long windowMs;     // æ—¶é—´çª—å£ï¼ˆå¯åŠ¨æ€ä¿®æ”¹ï¼‰
    private final SlidingWindowLimiter limiter;
    
    public ConfigurableLimiter(int maxCount, long windowMs) {
        this.maxCount = maxCount;
        this.windowMs = windowMs;
        this.limiter = new SlidingWindowLimiter();
    }
    
    public boolean allowRequest(String key) {
        return limiter.allowRequest(key, maxCount, windowMs);
    }
    
    // åŠ¨æ€è°ƒæ•´é™æµé…ç½®
    public void updateConfig(int newMaxCount, long newWindowMs) {
        this.maxCount = newMaxCount;
        this.windowMs = newWindowMs;
        System.out.println("é™æµé…ç½®å·²æ›´æ–°ï¼š" + maxCount + "æ¬¡/" + windowMs + "ms");
    }
}
```

**åº”ç”¨ç¤ºä¾‹**ï¼š

```java
// åˆå§‹é…ç½®ï¼šæ¯ç§’10æ¬¡
ConfigurableLimiter limiter = new ConfigurableLimiter(10, 1000);

// ä¸šåŠ¡é«˜å³°æœŸåŠ¨æ€è°ƒæ•´ä¸ºæ¯ç§’20æ¬¡
if (isHighTrafficPeriod()) {
    limiter.updateConfig(20, 1000);
}

// å‡Œæ™¨ä½å³°æœŸè°ƒæ•´ä¸ºæ¯ç§’5æ¬¡
if (isLowTrafficPeriod()) {
    limiter.updateConfig(5, 1000);
}
```

---

## 5. ğŸŒ é›†ç¾¤é™æµæ•°æ®åŒæ­¥


### 5.1 é›†ç¾¤ç¯å¢ƒçš„æŒ‘æˆ˜


**å•æœºé™æµåœ¨é›†ç¾¤ä¸‹ä¼šå¤±æ•ˆ**

```
åœºæ™¯è¯´æ˜ï¼š
æ¯å°æœåŠ¡å™¨é™åˆ¶100æ¬¡/ç§’
æœ‰3å°æœåŠ¡å™¨

å•æœºè§†è§’ï¼š
æœåŠ¡å™¨Aï¼š100æ¬¡/ç§’ âœ“
æœåŠ¡å™¨Bï¼š100æ¬¡/ç§’ âœ“  
æœåŠ¡å™¨Cï¼š100æ¬¡/ç§’ âœ“

å®é™…æƒ…å†µï¼š
æ€»è¯·æ±‚é‡ï¼š300æ¬¡/ç§’ âœ—
         â†‘
    é™æµç›®æ ‡å¤±æ•ˆï¼
```

**æ ¸å¿ƒé—®é¢˜**ï¼š
- âŒ å„æœåŠ¡å™¨ç‹¬ç«‹è®¡æ•°ï¼Œæ€»é‡è¶…é™
- âŒ åŒä¸€ç”¨æˆ·è¢«åˆ†é…åˆ°ä¸åŒæœåŠ¡å™¨
- âŒ é™æµæ•°æ®æ— æ³•å…±äº«

### 5.2 æ•°æ®åŒæ­¥æ–¹æ¡ˆå¯¹æ¯”


| æ–¹æ¡ˆ | åŸç† | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|------|---------|
| **Rediså…±äº«** | æ‰€æœ‰æœåŠ¡å™¨è¯»å†™Redis | ç²¾ç¡®ï¼Œå®æ—¶ | ä¾èµ–Redis | ä¸¥æ ¼é™æµ |
| **å®šæœŸåŒæ­¥** | å®šæ—¶æ±‡æ€»å„èŠ‚ç‚¹æ•°æ® | ç®€å•ï¼Œä½æˆæœ¬ | æœ‰å»¶è¿Ÿ | ç²¾åº¦è¦æ±‚ä¸é«˜ |
| **å¹³å‡åˆ†é…** | æ¯å°åˆ†é…æ€»é‡/N | æ— éœ€åŒæ­¥ | ä¸å‡è¡¡ | æµé‡å‡åŒ€ |
| **ä»¤ç‰Œä¸­å¿ƒ** | ä¸­å¿ƒèŠ‚ç‚¹åˆ†å‘ä»¤ç‰Œ | çµæ´»æ§åˆ¶ | å•ç‚¹ä¾èµ– | å¤æ‚åœºæ™¯ |

### 5.3 Rediså…±äº«æ–¹æ¡ˆå®ç°


**ä½¿ç”¨Redisä½œä¸ºå…±äº«å­˜å‚¨**

```java
public class RedisSharedLimiter {
    private final RedisTemplate<String, String> redisTemplate;
    
    public boolean allowRequest(String key, int maxCount, long windowMs) {
        String redisKey = "rate_limit:" + key;
        long now = System.currentTimeMillis();
        long windowStart = now - windowMs;
        
        // ä½¿ç”¨Luaè„šæœ¬ä¿è¯åŸå­æ€§
        String luaScript = 
            "local count = redis.call('ZCOUNT', KEYS[1], ARGV[1], ARGV[2]) " +
            "if count < tonumber(ARGV[3]) then " +
            "  redis.call('ZADD', KEYS[1], ARGV[2], ARGV[2]) " +
            "  redis.call('EXPIRE', KEYS[1], ARGV[4]) " +
            "  return 1 " +
            "else " +
            "  return 0 " +
            "end";
        
        Long result = redisTemplate.execute(
            new DefaultRedisScript<>(luaScript, Long.class),
            Collections.singletonList(redisKey),
            String.valueOf(windowStart),
            String.valueOf(now),
            String.valueOf(maxCount),
            String.valueOf(windowMs / 1000)
        );
        
        return result != null && result == 1;
    }
}
```

### 5.4 æœ¬åœ°+è¿œç¨‹æ··åˆæ–¹æ¡ˆ


**å…ˆæŸ¥æœ¬åœ°ï¼Œå†æŸ¥è¿œç¨‹ï¼Œæå‡æ€§èƒ½**

```java
public class HybridLimiter {
    private final LocalCacheLimiter localLimiter;
    private final RedisSharedLimiter redisLimiter;
    
    public boolean allowRequest(String key, int maxCount, long windowMs) {
        // ç¬¬ä¸€å±‚ï¼šæœ¬åœ°å¿«é€Ÿæ£€æŸ¥ï¼ˆ80%çš„æ€»é‡ï¼‰
        if (!localLimiter.allowRequest(key, (int)(maxCount * 0.8), windowMs)) {
            return false;
        }
        
        // ç¬¬äºŒå±‚ï¼šRedisç²¾ç¡®æ£€æŸ¥ï¼ˆ100%çš„æ€»é‡ï¼‰
        return redisLimiter.allowRequest(key, maxCount, windowMs);
    }
}
```

**å·¥ä½œæµç¨‹**ï¼š

```
è¯·æ±‚åˆ°è¾¾
   â†“
æœ¬åœ°å†…å­˜æ£€æŸ¥ï¼ˆ80%é™é¢ï¼‰
   â†“
  é€šè¿‡ï¼Ÿ
   â†“ æ˜¯
Redisæ£€æŸ¥ï¼ˆ100%é™é¢ï¼‰
   â†“
  é€šè¿‡ï¼Ÿ
   â†“ æ˜¯
æ‰§è¡Œä¸šåŠ¡é€»è¾‘

ä¼˜åŠ¿ï¼š
- å¤§éƒ¨åˆ†è¯·æ±‚åœ¨æœ¬åœ°æ‹¦æˆªï¼Œå‡å°‘Rediså‹åŠ›
- å°‘é‡è¯·æ±‚è¿›å…¥Redisåšç²¾ç¡®æ§åˆ¶
- æ€§èƒ½å’Œç²¾åº¦çš„å¹³è¡¡
```

---

## 6. ğŸ’¾ é™æµçŠ¶æ€æŒä¹…åŒ–


### 6.1 ä¸ºä»€ä¹ˆéœ€è¦æŒä¹…åŒ–


**æœåŠ¡é‡å¯ï¼Œé™æµæ•°æ®å°±ä¸¢äº†ï¼Ÿ**

```
åœºæ™¯é—®é¢˜ï¼š
æŸç”¨æˆ·å·²ä½¿ç”¨999æ¬¡ï¼ˆé™åˆ¶1000æ¬¡ï¼‰
   â†“
æœåŠ¡å™¨é‡å¯
   â†“
é™æµè®¡æ•°å™¨æ¸…é›¶
   â†“
ç”¨æˆ·åˆå¯ä»¥è®¿é—®1000æ¬¡
   â†“
é™æµå¤±æ•ˆï¼
```

**æŒä¹…åŒ–è§£å†³**ï¼š
- âœ… æœåŠ¡é‡å¯åé™æµæ•°æ®ä¸ä¸¢å¤±
- âœ… é˜²æ­¢æ¶æ„ç”¨æˆ·åˆ©ç”¨é‡å¯åˆ·æ–°é™é¢
- âœ… æ”¯æŒç°åº¦å‘å¸ƒå’Œæ»šåŠ¨å‡çº§

### 6.2 æŒä¹…åŒ–ç­–ç•¥é€‰æ‹©


**æŒä¹…åŒ–æ—¶æœºå¯¹æ¯”**ï¼š

| ç­–ç•¥ | è¯´æ˜ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|------|---------|
| **å®æ—¶æŒä¹…åŒ–** | æ¯æ¬¡è¯·æ±‚éƒ½ä¿å­˜ | æ•°æ®æœ€å‡†ç¡® | æ€§èƒ½å·® | ä¸¥æ ¼é™æµ |
| **å®šæ—¶æŒä¹…åŒ–** | æ¯éš”Nç§’ä¿å­˜ä¸€æ¬¡ | æ€§èƒ½å¥½ | å¯èƒ½ä¸¢æ•°æ® | ä¸€èˆ¬åœºæ™¯ |
| **å»¶è¿ŸæŒä¹…åŒ–** | æ•°æ®å˜åŒ–åå»¶è¿Ÿä¿å­˜ | å¹³è¡¡æ€§èƒ½ | ç¨å¤æ‚ | æ¨è |
| **å¿«ç…§æŒä¹…åŒ–** | å…³é—­æ—¶ä¿å­˜å¿«ç…§ | ç®€å• | å¼‚å¸¸ä¸¢å¤± | å¯¹ç²¾åº¦è¦æ±‚ä½ |

### 6.3 å®šæ—¶æŒä¹…åŒ–å®ç°


**æ¯éš”ä¸€æ®µæ—¶é—´ä¿å­˜åˆ°Redis**

```java
public class PersistentLimiter {
    private final LocalCacheLimiter localLimiter;
    private final RedisTemplate<String, String> redisTemplate;
    private final ScheduledExecutorService scheduler;
    
    public PersistentLimiter() {
        this.localLimiter = new LocalCacheLimiter();
        this.scheduler = Executors.newScheduledThreadPool(1);
        
        // æ¯5ç§’æŒä¹…åŒ–ä¸€æ¬¡
        scheduler.scheduleAtFixedRate(
            this::persistData,
            5, 5, TimeUnit.SECONDS
        );
    }
    
    // æŒä¹…åŒ–æ•°æ®åˆ°Redis
    private void persistData() {
        localLimiter.getAllData().forEach((key, info) -> {
            String redisKey = "limiter:persist:" + key;
            
            // ä¿å­˜é™æµä¿¡æ¯
            Map<String, String> data = new HashMap<>();
            data.put("count", String.valueOf(info.count));
            data.put("windowStart", String.valueOf(info.windowStart));
            
            redisTemplate.opsForHash().putAll(redisKey, data);
            redisTemplate.expire(redisKey, 10, TimeUnit.MINUTES);
        });
    }
    
    // æœåŠ¡å¯åŠ¨æ—¶æ¢å¤æ•°æ®
    public void recoverData() {
        Set<String> keys = redisTemplate.keys("limiter:persist:*");
        
        for (String redisKey : keys) {
            Map<Object, Object> data = redisTemplate.opsForHash().entries(redisKey);
            
            int count = Integer.parseInt((String) data.get("count"));
            long windowStart = Long.parseLong((String) data.get("windowStart"));
            
            // æ¢å¤åˆ°æœ¬åœ°ç¼“å­˜
            String key = redisKey.replace("limiter:persist:", "");
            localLimiter.restore(key, count, windowStart);
        }
    }
}
```

### 6.4 ä¼˜é›…å…³é—­å¤„ç†


**æœåŠ¡å…³é—­æ—¶ä¿å­˜å½“å‰çŠ¶æ€**

```java
@Component
public class LimiterShutdownHook {
    private final PersistentLimiter limiter;
    
    @PreDestroy  // Springå®¹å™¨é”€æ¯å‰æ‰§è¡Œ
    public void onShutdown() {
        System.out.println("æ­£åœ¨ä¿å­˜é™æµæ•°æ®...");
        
        // ç«‹å³æŒä¹…åŒ–å½“å‰æ•°æ®
        limiter.persistData();
        
        // å…³é—­å®šæ—¶ä»»åŠ¡
        limiter.shutdown();
        
        System.out.println("é™æµæ•°æ®ä¿å­˜å®Œæˆ");
    }
}
```

**å®Œæ•´ç”Ÿå‘½å‘¨æœŸ**ï¼š

```
æœåŠ¡å¯åŠ¨
   â†“
ä»Redisæ¢å¤æ•°æ®
   â†“
æ­£å¸¸è¿è¡Œï¼ˆå®šæ—¶æŒä¹…åŒ–ï¼‰
   â†“
æ”¶åˆ°å…³é—­ä¿¡å·
   â†“
ç«‹å³æŒä¹…åŒ–å½“å‰çŠ¶æ€
   â†“
æœåŠ¡å…³é—­

ä¼˜åŠ¿ï¼š
- å¯åŠ¨æ—¶æ¢å¤ä¸Šæ¬¡çŠ¶æ€
- è¿è¡Œæ—¶å®šæœŸå¤‡ä»½
- å…³é—­æ—¶ç¡®ä¿æ•°æ®ä¿å­˜
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å†…å­˜é™æµæœ¬è´¨ï¼šæŠŠè®¡æ•°å™¨æ”¾åœ¨å†…å­˜ï¼Œå¿«é€Ÿåˆ¤æ–­æ˜¯å¦è¶…é™
ğŸ”¸ Guava RateLimiterï¼šåŸºäºä»¤ç‰Œæ¡¶ç®—æ³•çš„æˆç†Ÿé™æµå·¥å…·
ğŸ”¸ æ»‘åŠ¨çª—å£ï¼šæ¯”å›ºå®šçª—å£æ›´ç²¾ç¡®çš„é™æµæ–¹å¼
ğŸ”¸ é›†ç¾¤åŒæ­¥ï¼šå¤šå°æœåŠ¡å™¨å…±äº«é™æµæ•°æ®çš„å…³é”®
ğŸ”¸ æ•°æ®æŒä¹…åŒ–ï¼šé˜²æ­¢é‡å¯å¯¼è‡´é™æµå¤±æ•ˆ
```

### 7.2 æ–¹æ¡ˆé€‰æ‹©æŒ‡å—


**å•æœºåº”ç”¨**ï¼š
```
æµé‡å° â†’ ConcurrentHashMap
      â†“
æµé‡å¤§ â†’ Guava RateLimiter
      â†“
éœ€è¦ç»Ÿè®¡ â†’ è‡ªå®šä¹‰æ»‘åŠ¨çª—å£
```

**é›†ç¾¤åº”ç”¨**ï¼š
```
ç²¾åº¦è¦æ±‚é«˜ â†’ Rediså…±äº«å­˜å‚¨
          â†“
æ€§èƒ½è¦æ±‚é«˜ â†’ æœ¬åœ°+Redisæ··åˆ
          â†“
æˆæœ¬é™åˆ¶ â†’ å¹³å‡åˆ†é…æ–¹æ¡ˆ
```

**æŒä¹…åŒ–éœ€æ±‚**ï¼š
```
ä¸¥æ ¼é™æµ â†’ å®æ—¶æŒä¹…åŒ–
       â†“
ä¸€èˆ¬åœºæ™¯ â†’ å®šæ—¶æŒä¹…åŒ–
       â†“
è¦æ±‚ä¸é«˜ â†’ å…³é—­æ—¶ä¿å­˜
```

### 7.3 å®æˆ˜å»ºè®®


**æ€§èƒ½ä¼˜åŒ–æŠ€å·§**ï¼š
- ğŸ’¡ ä¼˜å…ˆæœ¬åœ°æ£€æŸ¥ï¼Œå‡å°‘è¿œç¨‹è°ƒç”¨
- ğŸ’¡ åˆç†è®¾ç½®æ¸…ç†é—´éš”ï¼Œé¿å…å†…å­˜æ³„æ¼
- ğŸ’¡ ä½¿ç”¨Luaè„šæœ¬ä¿è¯Redisæ“ä½œåŸå­æ€§

**å¸¸è§é—®é¢˜å¤„ç†**ï¼š
- âš ï¸ æ—¶é’Ÿä¸åŒæ­¥ â†’ ä½¿ç”¨é€»è¾‘æ—¶é’Ÿæˆ–NTPåŒæ­¥
- âš ï¸ å†…å­˜æº¢å‡º â†’ è®¾ç½®æœ€å¤§å®¹é‡å’Œè¿‡æœŸæ—¶é—´
- âš ï¸ Redisæ•…éšœ â†’ é™çº§åˆ°æœ¬åœ°é™æµ

**æ ¸å¿ƒè®°å¿†**ï¼š
- å†…å­˜é™æµå¿«ï¼Œä½†è¦æ³¨æ„é›†ç¾¤åœºæ™¯
- Guavaå¥½ç”¨ï¼Œä½†åªèƒ½å•æœº
- è‡ªå®šä¹‰çµæ´»ï¼Œä½†è¦è€ƒè™‘æ€§èƒ½
- æŒä¹…åŒ–é‡è¦ï¼Œé˜²æ­¢é‡å¯ä¸¢æ•°æ®