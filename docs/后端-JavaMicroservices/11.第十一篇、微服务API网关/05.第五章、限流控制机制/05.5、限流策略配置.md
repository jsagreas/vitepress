---
title: 5ã€é™æµç­–ç•¥é…ç½®
---
## ğŸ“š ç›®å½•

1. [é™æµç­–ç•¥æ¦‚è¿°](#1-é™æµç­–ç•¥æ¦‚è¿°)
2. [æŒ‰IPåœ°å€é™æµ](#2-æŒ‰IPåœ°å€é™æµ)
3. [æŒ‰ç”¨æˆ·IDé™æµ](#3-æŒ‰ç”¨æˆ·IDé™æµ)
4. [æŒ‰APIæ¥å£é™æµ](#4-æŒ‰APIæ¥å£é™æµ)
5. [æŒ‰è¯·æ±‚è·¯å¾„é™æµ](#5-æŒ‰è¯·æ±‚è·¯å¾„é™æµ)
6. [åˆ†çº§é™æµç­–ç•¥](#6-åˆ†çº§é™æµç­–ç•¥)
7. [ç™½åå•å…é™æµ](#7-ç™½åå•å…é™æµ)
8. [é™æµå¼‚å¸¸å¤„ç†](#8-é™æµå¼‚å¸¸å¤„ç†)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ é™æµç­–ç•¥æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯é™æµç­–ç•¥


**é€šä¿—ç†è§£**ï¼šæƒ³è±¡ä¸€ä¸ªæ™¯åŒºå…¥å£ï¼Œä¸ºäº†é˜²æ­¢æ‹¥æŒ¤ï¼Œéœ€è¦æ§åˆ¶è¿›å…¥çš„æ¸¸å®¢æ•°é‡ã€‚é™æµç­–ç•¥å°±åƒæ˜¯ä¸åŒçš„ç®¡ç†è§„åˆ™ï¼š

```
ç°å®åœºæ™¯                        é™æµç­–ç•¥
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸš— æŒ‰è½¦ç‰Œé™è¡Œ        â†’        æŒ‰IPåœ°å€é™æµ
ğŸ« æŒ‰é—¨ç¥¨ç±»å‹åˆ†æµ    â†’        æŒ‰ç”¨æˆ·ç­‰çº§é™æµ  
ğŸšª ä¸åŒå…¥å£é™äººæ•°    â†’        æŒ‰æ¥å£è·¯å¾„é™æµ
ğŸ‘¥ VIPé€šé“å…æ’é˜Ÿ     â†’        ç™½åå•å…é™æµ
```

**æ ¸å¿ƒå®šä¹‰**ï¼š
- **é™æµç­–ç•¥**ï¼šæ ¹æ®ä¸åŒç»´åº¦æ§åˆ¶è®¿é—®é¢‘ç‡çš„è§„åˆ™
- **ç›®çš„**ï¼šä¿æŠ¤ç³»ç»Ÿèµ„æºï¼Œé˜²æ­¢æœåŠ¡è¢«æ‰“å®
- **å®ç°æ–¹å¼**ï¼šåœ¨ç½‘å…³å±‚ç»Ÿä¸€æ‹¦æˆªå’Œæ§åˆ¶

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦å¤šç§é™æµç­–ç•¥


**ä¸šåŠ¡åœºæ™¯å·®å¼‚**ï¼š

| åœºæ™¯ | é—®é¢˜ | å¯¹åº”ç­–ç•¥ |
|------|------|----------|
| **æ¶æ„æ”»å‡»** | å•ä¸ªIPç–¯ç‹‚è¯·æ±‚ | æŒ‰IPé™æµ |
| **æ™®é€šç”¨æˆ·** | å…è´¹ç”¨æˆ·é¢‘ç¹è°ƒç”¨ | æŒ‰ç”¨æˆ·IDé™æµ |
| **æ ¸å¿ƒæ¥å£** | æ”¯ä»˜æ¥å£å‹åŠ›å¤§ | æŒ‰æ¥å£é™æµ |
| **VIPå®¢æˆ·** | å¤§å®¢æˆ·éœ€è¦æ›´é«˜é…é¢ | ç™½åå•è±å… |

**ç­–ç•¥ç»„åˆ**ï¼šå®é™…åº”ç”¨ä¸­å¾€å¾€éœ€è¦å¤šç§ç­–ç•¥é…åˆä½¿ç”¨

```
è¯·æ±‚æµç¨‹ï¼š
å®¢æˆ·ç«¯è¯·æ±‚
    â†“
æ£€æŸ¥ç™½åå•ï¼ˆVIPç›´æ¥æ”¾è¡Œï¼‰
    â†“
æŒ‰IPé™æµï¼ˆé˜²æ­¢å•ç‚¹æ”»å‡»ï¼‰
    â†“
æŒ‰ç”¨æˆ·é™æµï¼ˆæ§åˆ¶ç”¨æˆ·é…é¢ï¼‰
    â†“
æŒ‰æ¥å£é™æµï¼ˆä¿æŠ¤æ ¸å¿ƒæ¥å£ï¼‰
    â†“
è¯·æ±‚é€šè¿‡/æ‹’ç»
```

---

## 2. ğŸŒ æŒ‰IPåœ°å€é™æµ


### 2.1 åŸºæœ¬æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯IPé™æµ**ï¼šæ ¹æ®å®¢æˆ·ç«¯çš„IPåœ°å€æ¥æ§åˆ¶è®¿é—®é¢‘ç‡

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… é˜²æ­¢å•ä¸ªIPçš„æ¶æ„æ”»å‡»
- âœ… æ§åˆ¶çˆ¬è™«æŠ“å–é¢‘ç‡
- âœ… é˜²æ­¢DDoSæ”»å‡»

### 2.2 å·¥ä½œåŸç†


**åŸºæœ¬é€»è¾‘**ï¼š

```
æ­¥éª¤è¯´æ˜ï¼š
1. æå–å®¢æˆ·ç«¯çœŸå®IPåœ°å€
2. ä»¥IPä¸ºkeyè®°å½•è®¿é—®æ¬¡æ•°
3. åˆ¤æ–­æ˜¯å¦è¶…è¿‡é™åˆ¶
4. è¶…è¿‡åˆ™æ‹’ç»ï¼Œå¦åˆ™æ”¾è¡Œ

ç¤ºä¾‹ï¼š
IP: 192.168.1.100
è§„åˆ™: æ¯ç§’æœ€å¤š10æ¬¡è¯·æ±‚
å½“å‰: ç¬¬8æ¬¡è¯·æ±‚ â†’ æ”¾è¡Œâœ…
      ç¬¬11æ¬¡è¯·æ±‚ â†’ æ‹’ç»âŒ
```

### 2.3 é…ç½®ç¤ºä¾‹


**Spring Cloud Gatewayé…ç½®**ï¼š

```yaml
spring:
  cloud:
    gateway:
      routes:
        - id: api-route
          uri: lb://user-service
          predicates:
            - Path=/api/**
          filters:
            # IPé™æµè¿‡æ»¤å™¨
            - name: RequestRateLimiter
              args:
                # ä½¿ç”¨IPä½œä¸ºé™æµkey
                key-resolver: "#{@ipKeyResolver}"
                # æ¯ç§’å…è®¸10ä¸ªè¯·æ±‚
                redis-rate-limiter.replenishRate: 10
                # çªå‘æµé‡æœ€å¤š20ä¸ª
                redis-rate-limiter.burstCapacity: 20
```

**è‡ªå®šä¹‰IPæå–å™¨**ï¼š

```java
@Configuration
public class RateLimitConfig {
    
    /**
     * IPåœ°å€æå–å™¨
     * ä»è¯·æ±‚ä¸­è·å–çœŸå®å®¢æˆ·ç«¯IP
     */
    @Bean
    public KeyResolver ipKeyResolver() {
        return exchange -> {
            // è·å–çœŸå®IPï¼ˆè€ƒè™‘ä»£ç†æƒ…å†µï¼‰
            String ip = exchange.getRequest()
                .getHeaders()
                .getFirst("X-Forwarded-For");
            
            // å¦‚æœæ²¡æœ‰ä»£ç†ï¼Œç›´æ¥è·å–è¿œç¨‹åœ°å€
            if (ip == null) {
                ip = exchange.getRequest()
                    .getRemoteAddress()
                    .getAddress()
                    .getHostAddress();
            }
            
            return Mono.just(ip);
        };
    }
}
```

### 2.4 æ³¨æ„äº‹é¡¹


> âš ï¸ **ä»£ç†é—®é¢˜**ï¼šå®¢æˆ·ç«¯å¯èƒ½é€šè¿‡ä»£ç†è®¿é—®ï¼Œéœ€è¦æ­£ç¡®è·å–çœŸå®IP
> 
> ğŸ’¡ **è§£å†³æ–¹æ¡ˆ**ï¼šä¼˜å…ˆä»`X-Forwarded-For`ã€`X-Real-IP`ç­‰è¯·æ±‚å¤´è·å–

**å¸¸è§é—®é¢˜**ï¼š

```
é—®é¢˜1ï¼šå¤šä¸ªç”¨æˆ·å…±äº«åŒä¸€ä¸ªå‡ºå£IP
åœºæ™¯ï¼šå…¬å¸ã€å­¦æ ¡ç­‰å†…ç½‘ç”¨æˆ·
å½±å“ï¼šå¯èƒ½è¯¯ä¼¤æ­£å¸¸ç”¨æˆ·
è§£å†³ï¼šç»“åˆç”¨æˆ·IDé™æµ

é—®é¢˜2ï¼šIPåœ°å€ä¼ªé€ 
åœºæ™¯ï¼šæ¶æ„ç”¨æˆ·ä¿®æ”¹è¯·æ±‚å¤´
å½±å“ï¼šç»•è¿‡IPé™æµ
è§£å†³ï¼šåœ¨è´Ÿè½½å‡è¡¡å±‚è®°å½•çœŸå®IP
```

---

## 3. ğŸ‘¤ æŒ‰ç”¨æˆ·IDé™æµ


### 3.1 åŸºæœ¬æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯ç”¨æˆ·é™æµ**ï¼šé’ˆå¯¹å·²ç™»å½•ç”¨æˆ·ï¼Œæ ¹æ®ç”¨æˆ·èº«ä»½æ§åˆ¶è®¿é—®é¢‘ç‡

**ä¸IPé™æµçš„åŒºåˆ«**ï¼š

| ç»´åº¦ | IPé™æµ | ç”¨æˆ·é™æµ |
|------|--------|----------|
| **è¯†åˆ«æ–¹å¼** | å®¢æˆ·ç«¯IPåœ°å€ | ç”¨æˆ·ç™»å½•å‡­è¯ |
| **é€‚ç”¨å¯¹è±¡** | æ‰€æœ‰è¯·æ±‚ | å·²è®¤è¯ç”¨æˆ· |
| **ç²’åº¦** | ç²—ç²’åº¦ | ç»†ç²’åº¦ |
| **ä¸šåŠ¡åœºæ™¯** | é˜²æ”»å‡» | ç”¨æˆ·é…é¢ç®¡ç† |

### 3.2 å®ç°æ–¹å¼


**æå–ç”¨æˆ·ID**ï¼š

```java
@Bean
public KeyResolver userKeyResolver() {
    return exchange -> {
        // ä»JWT Tokenä¸­è§£æç”¨æˆ·ID
        String token = exchange.getRequest()
            .getHeaders()
            .getFirst("Authorization");
        
        if (token != null && token.startsWith("Bearer ")) {
            // è§£æTokenè·å–ç”¨æˆ·ID
            String userId = JwtUtil.getUserId(token);
            return Mono.just(userId);
        }
        
        // æœªç™»å½•ç”¨æˆ·ä½¿ç”¨IPä½œä¸ºkey
        return Mono.just("anonymous");
    };
}
```

**é…ç½®ç¤ºä¾‹**ï¼š

```yaml
spring:
  cloud:
    gateway:
      routes:
        - id: user-api
          uri: lb://user-service
          filters:
            - name: RequestRateLimiter
              args:
                key-resolver: "#{@userKeyResolver}"
                # æ™®é€šç”¨æˆ·ï¼šæ¯åˆ†é’Ÿ100æ¬¡
                redis-rate-limiter.replenishRate: 100
                redis-rate-limiter.burstCapacity: 150
```

### 3.3 å·®å¼‚åŒ–é…é¢


**ä¸åŒç”¨æˆ·ç­‰çº§è®¾ç½®ä¸åŒé™åˆ¶**ï¼š

```java
@Component
public class UserRateLimitFilter implements GatewayFilter {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, 
                             GatewayFilterChain chain) {
        // è·å–ç”¨æˆ·ç­‰çº§
        String userLevel = getUserLevel(exchange);
        
        // æ ¹æ®ç­‰çº§è®¾ç½®ä¸åŒé™æµå‚æ•°
        int rateLimit = switch(userLevel) {
            case "VIP" -> 1000;      // VIPç”¨æˆ·ï¼š1000æ¬¡/åˆ†é’Ÿ
            case "PREMIUM" -> 500;   // é«˜çº§ç”¨æˆ·ï¼š500æ¬¡/åˆ†é’Ÿ
            case "NORMAL" -> 100;    // æ™®é€šç”¨æˆ·ï¼š100æ¬¡/åˆ†é’Ÿ
            default -> 10;           // æ¸¸å®¢ï¼š10æ¬¡/åˆ†é’Ÿ
        };
        
        // æ‰§è¡Œé™æµæ£€æŸ¥
        return checkRateLimit(exchange, rateLimit)
            .flatMap(allowed -> {
                if (allowed) {
                    return chain.filter(exchange);
                } else {
                    return rejectRequest(exchange);
                }
            });
    }
}
```

---

## 4. ğŸ”Œ æŒ‰APIæ¥å£é™æµ


### 4.1 ä¸ºä»€ä¹ˆéœ€è¦æ¥å£çº§é™æµ


**ä¸åŒæ¥å£å‹åŠ›ä¸åŒ**ï¼š

```
æ¥å£ç±»å‹              èµ„æºæ¶ˆè€—           é™æµéœ€æ±‚
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š æŸ¥è¯¢æ¥å£           ä½              å¯ä»¥æ”¾å®½é™åˆ¶
ğŸ’° æ”¯ä»˜æ¥å£           ä¸­              ä¸¥æ ¼æ§åˆ¶
ğŸ“ å†™å…¥æ¥å£           é«˜              é‡ç‚¹ä¿æŠ¤
ğŸ” æœç´¢æ¥å£           å¾ˆé«˜            ä¸¥æ ¼é™æµ
```

**æ ¸å¿ƒæ€æƒ³**ï¼šæ ¹æ®æ¥å£çš„é‡è¦æ€§å’Œèµ„æºæ¶ˆè€—ï¼Œè®¾ç½®ä¸åŒçš„é™æµè§„åˆ™

### 4.2 å®ç°æ–¹å¼


**è·¯ç”±çº§é…ç½®**ï¼š

```yaml
spring:
  cloud:
    gateway:
      routes:
        # æŸ¥è¯¢æ¥å£ - å®½æ¾é™æµ
        - id: query-api
          uri: lb://query-service
          predicates:
            - Path=/api/query/**
          filters:
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 1000
                
        # æ”¯ä»˜æ¥å£ - ä¸¥æ ¼é™æµ        
        - id: payment-api
          uri: lb://payment-service
          predicates:
            - Path=/api/payment/**
          filters:
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 10
```

**åŸºäºæ¥å£è·¯å¾„é™æµ**ï¼š

```java
@Bean
public KeyResolver apiKeyResolver() {
    return exchange -> {
        // è·å–è¯·æ±‚è·¯å¾„
        String path = exchange.getRequest().getPath().value();
        
        // æå–æ¥å£æ ‡è¯†
        // /api/user/info -> user
        // /api/order/list -> order
        String api = extractApiName(path);
        
        return Mono.just(api);
    };
}
```

### 4.3 æ¥å£åˆ†ç»„é™æµ


**å°†ç›¸ä¼¼æ¥å£åˆ†ç»„ç®¡ç†**ï¼š

```java
public class ApiGroupConfig {
    
    // å®šä¹‰æ¥å£åˆ†ç»„
    private static final Map<String, List<String>> API_GROUPS = Map.of(
        "WRITE", List.of("/create", "/update", "/delete"),
        "READ", List.of("/query", "/list", "/detail"),
        "CRITICAL", List.of("/payment", "/withdraw", "/transfer")
    );
    
    // åˆ†ç»„é™æµé…ç½®
    private static final Map<String, Integer> GROUP_LIMITS = Map.of(
        "WRITE", 100,      // å†™æ¥å£ï¼š100æ¬¡/åˆ†é’Ÿ
        "READ", 1000,      // è¯»æ¥å£ï¼š1000æ¬¡/åˆ†é’Ÿ
        "CRITICAL", 10     // æ ¸å¿ƒæ¥å£ï¼š10æ¬¡/åˆ†é’Ÿ
    );
}
```

---

## 5. ğŸ›¤ï¸ æŒ‰è¯·æ±‚è·¯å¾„é™æµ


### 5.1 è·¯å¾„é™æµä¸æ¥å£é™æµçš„åŒºåˆ«


**æ¦‚å¿µåŒºåˆ†**ï¼š

```
æ¥å£é™æµï¼šé’ˆå¯¹ä¸šåŠ¡åŠŸèƒ½
/api/user/info    }
/api/user/list    } â†’ useræ¥å£ç»„
/api/user/detail  }

è·¯å¾„é™æµï¼šé’ˆå¯¹URLè·¯å¾„
/api/v1/**        â†’ æ‰€æœ‰v1ç‰ˆæœ¬æ¥å£
/api/admin/**     â†’ æ‰€æœ‰ç®¡ç†æ¥å£
/public/**        â†’ æ‰€æœ‰å…¬å¼€æ¥å£
```

### 5.2 è·¯å¾„æ¨¡å¼åŒ¹é…


**é€šé…ç¬¦è§„åˆ™**ï¼š

| æ¨¡å¼ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `*` | åŒ¹é…å•å±‚è·¯å¾„ | `/api/*/list` åŒ¹é… `/api/user/list` |
| `**` | åŒ¹é…å¤šå±‚è·¯å¾„ | `/api/**` åŒ¹é…æ‰€æœ‰apiå¼€å¤´çš„è·¯å¾„ |
| `?` | åŒ¹é…å•ä¸ªå­—ç¬¦ | `/api/user?` åŒ¹é… `/api/user1` |

**é…ç½®ç¤ºä¾‹**ï¼š

```yaml
spring:
  cloud:
    gateway:
      routes:
        # é™åˆ¶æ‰€æœ‰ç®¡ç†æ¥å£
        - id: admin-route
          uri: lb://admin-service
          predicates:
            - Path=/api/admin/**
          filters:
            - name: RequestRateLimiter
              args:
                key-resolver: "#{@pathKeyResolver}"
                redis-rate-limiter.replenishRate: 50
```

### 5.3 è·¯å¾„åˆ†çº§é™æµ


**ä¸åŒè·¯å¾„å±‚çº§è®¾ç½®ä¸åŒè§„åˆ™**ï¼š

```java
@Component
public class PathRateLimitConfig {
    
    public int getRateLimitByPath(String path) {
        // ä¼˜å…ˆçº§ï¼šå…·ä½“è·¯å¾„ > è·¯å¾„å‰ç¼€ > é»˜è®¤å€¼
        
        if (path.startsWith("/api/admin/")) {
            return 10;  // ç®¡ç†æ¥å£ä¸¥æ ¼é™åˆ¶
        } else if (path.startsWith("/api/public/")) {
            return 1000;  // å…¬å¼€æ¥å£æ”¾å®½é™åˆ¶
        } else if (path.startsWith("/api/")) {
            return 100;  // æ™®é€šAPIæ¥å£
        } else {
            return 500;  // é»˜è®¤é™åˆ¶
        }
    }
}
```

---

## 6. ğŸ“Š åˆ†çº§é™æµç­–ç•¥


### 6.1 ä»€ä¹ˆæ˜¯åˆ†çº§é™æµ


**é€šä¿—ç†è§£**ï¼šå°±åƒé«˜é€Ÿå…¬è·¯çš„ä¸åŒè½¦é“

```
è½¦é“ç±»å‹            é™æµç­–ç•¥            ä¸šåŠ¡å¯¹åº”
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸš— æ™®é€šè½¦é“         ä¸¥æ ¼é™é€Ÿ            æ™®é€šç”¨æˆ·
ğŸš™ å¿«é€Ÿè½¦é“         é€‚ä¸­é™é€Ÿ            VIPç”¨æˆ·
ğŸï¸ VIPè½¦é“          å®½æ¾é™é€Ÿ            ä¼ä¸šå®¢æˆ·
ğŸš‘ åº”æ€¥è½¦é“         æ— é™åˆ¶              å†…éƒ¨è°ƒç”¨
```

### 6.2 å¤šç»´åº¦åˆ†çº§


**ç”¨æˆ·ç­‰çº§ + æ¥å£ç±»å‹**ï¼š

```java
public class MultiLevelRateLimit {
    
    /**
     * è®¡ç®—æœ€ç»ˆé™æµå€¼
     * @param userLevel ç”¨æˆ·ç­‰çº§
     * @param apiType æ¥å£ç±»å‹
     * @return æ¯åˆ†é’Ÿå…è®¸çš„è¯·æ±‚æ•°
     */
    public int calculateRateLimit(String userLevel, String apiType) {
        
        // åŸºç¡€é…é¢
        int baseRate = switch(userLevel) {
            case "ENTERPRISE" -> 10000;  // ä¼ä¸šç”¨æˆ·
            case "VIP" -> 1000;          // VIPç”¨æˆ·
            case "NORMAL" -> 100;        // æ™®é€šç”¨æˆ·
            default -> 10;               // æ¸¸å®¢
        };
        
        // æ¥å£ç³»æ•°
        double apiMultiplier = switch(apiType) {
            case "READ" -> 1.0;      // è¯»æ¥å£ï¼š100%
            case "WRITE" -> 0.5;     // å†™æ¥å£ï¼š50%
            case "CRITICAL" -> 0.1;  // æ ¸å¿ƒæ¥å£ï¼š10%
            default -> 0.8;
        };
        
        return (int)(baseRate * apiMultiplier);
    }
}
```

### 6.3 æ—¶æ®µåˆ†çº§é™æµ


**ä¸åŒæ—¶é—´æ®µä½¿ç”¨ä¸åŒç­–ç•¥**ï¼š

```java
public class TimePeriodRateLimit {
    
    public int getRateLimitByTime() {
        int hour = LocalDateTime.now().getHour();
        
        // é«˜å³°æœŸé™æµ
        if (hour >= 9 && hour <= 18) {
            return 100;  // å·¥ä½œæ—¶é—´ä¸¥æ ¼é™åˆ¶
        }
        // ä½å³°æœŸæ”¾å®½
        else if (hour >= 22 || hour <= 6) {
            return 500;  // æ·±å¤œæ—¶æ®µæ”¾å®½
        }
        // æ™®é€šæ—¶æ®µ
        else {
            return 200;
        }
    }
}
```

### 6.4 åŠ¨æ€è°ƒæ•´ç­–ç•¥


**æ ¹æ®ç³»ç»Ÿè´Ÿè½½å®æ—¶è°ƒæ•´**ï¼š

```
ç³»ç»Ÿè´Ÿè½½ç›‘æ§ï¼š
CPU < 50%  â†’ æ”¾å®½é™æµï¼ˆ200%ï¼‰
CPU < 70%  â†’ æ­£å¸¸é™æµï¼ˆ100%ï¼‰
CPU < 85%  â†’ æ”¶ç´§é™æµï¼ˆ50%ï¼‰
CPU > 85%  â†’ ä¸¥æ ¼é™æµï¼ˆ20%ï¼‰

å®æ—¶è°ƒæ•´ï¼šæ¯30ç§’æ£€æŸ¥ä¸€æ¬¡ç³»ç»Ÿè´Ÿè½½
è‡ªåŠ¨é™çº§ï¼šè´Ÿè½½è¿‡é«˜æ—¶è‡ªåŠ¨é™ä½é™æµé˜ˆå€¼
è‡ªåŠ¨æ¢å¤ï¼šè´Ÿè½½é™ä½åé€æ­¥æ¢å¤é™æµé˜ˆå€¼
```

---

## 7. ğŸ« ç™½åå•å…é™æµ


### 7.1 ä»€ä¹ˆæ˜¯ç™½åå•


**é€šä¿—ç†è§£**ï¼šVIPé€šé“ï¼Œç‰¹å®šçš„ç”¨æˆ·æˆ–IPå¯ä»¥ç»•è¿‡é™æµæ£€æŸ¥

**åº”ç”¨åœºæ™¯**ï¼š
- âœ… å†…éƒ¨ç³»ç»Ÿè°ƒç”¨ï¼ˆä¸éœ€è¦é™æµï¼‰
- âœ… ç›‘æ§å¥åº·æ£€æŸ¥ï¼ˆé¿å…è¯¯æŠ¥ï¼‰
- âœ… å¤§å®¢æˆ·ä¸“å±é€šé“ï¼ˆå•†ä¸šéœ€æ±‚ï¼‰
- âœ… ç´§æ€¥æ•…éšœä¿®å¤ï¼ˆä¸´æ—¶è±å…ï¼‰

### 7.2 ç™½åå•é…ç½®


**IPç™½åå•**ï¼š

```yaml
# application.yml
rate-limit:
  whitelist:
    # IPç™½åå•
    ips:
      - 192.168.1.100    # å†…ç½‘æœåŠ¡å™¨
      - 10.0.0.0/24      # å†…ç½‘ç½‘æ®µ
      - 114.114.114.114  # åˆä½œä¼™ä¼´
    
    # ç”¨æˆ·ç™½åå•
    users:
      - admin            # ç®¡ç†å‘˜
      - system           # ç³»ç»Ÿç”¨æˆ·
      - monitor          # ç›‘æ§è´¦å·
    
    # è·¯å¾„ç™½åå•
    paths:
      - /actuator/**     # å¥åº·æ£€æŸ¥
      - /internal/**     # å†…éƒ¨æ¥å£
```

**ç™½åå•æ£€æŸ¥é€»è¾‘**ï¼š

```java
@Component
public class WhitelistFilter implements GatewayFilter {
    
    @Autowired
    private WhitelistConfig whitelistConfig;
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, 
                             GatewayFilterChain chain) {
        
        // 1. æ£€æŸ¥IPç™½åå•
        String clientIp = getClientIp(exchange);
        if (whitelistConfig.isIpInWhitelist(clientIp)) {
            return chain.filter(exchange);  // ç›´æ¥æ”¾è¡Œ
        }
        
        // 2. æ£€æŸ¥ç”¨æˆ·ç™½åå•
        String userId = getUserId(exchange);
        if (whitelistConfig.isUserInWhitelist(userId)) {
            return chain.filter(exchange);  // ç›´æ¥æ”¾è¡Œ
        }
        
        // 3. æ£€æŸ¥è·¯å¾„ç™½åå•
        String path = exchange.getRequest().getPath().value();
        if (whitelistConfig.isPathInWhitelist(path)) {
            return chain.filter(exchange);  // ç›´æ¥æ”¾è¡Œ
        }
        
        // 4. ä¸åœ¨ç™½åå•ï¼Œæ‰§è¡Œæ­£å¸¸é™æµé€»è¾‘
        return doRateLimit(exchange, chain);
    }
}
```

### 7.3 ç™½åå•ç®¡ç†


**åŠ¨æ€ç®¡ç†**ï¼š

```java
@RestController
@RequestMapping("/admin/whitelist")
public class WhitelistController {
    
    @Autowired
    private WhitelistService whitelistService;
    
    /**
     * æ·»åŠ IPåˆ°ç™½åå•
     */
    @PostMapping("/ip")
    public void addIpWhitelist(@RequestParam String ip, 
                               @RequestParam String reason) {
        whitelistService.addIp(ip, reason);
        // åŒæ—¶åˆ·æ–°Redisç¼“å­˜
        redisTemplate.opsForSet().add("whitelist:ip", ip);
    }
    
    /**
     * ç§»é™¤ç™½åå•IP
     */
    @DeleteMapping("/ip")
    public void removeIpWhitelist(@RequestParam String ip) {
        whitelistService.removeIp(ip);
        redisTemplate.opsForSet().remove("whitelist:ip", ip);
    }
}
```

> ğŸ’¡ **æœ€ä½³å®è·µ**ï¼šç™½åå•è®°å½•åº”åŒ…å«æ·»åŠ åŸå› å’Œè¿‡æœŸæ—¶é—´ï¼Œé¿å…é•¿æœŸç§¯ç´¯

---

## 8. âš ï¸ é™æµå¼‚å¸¸å¤„ç†


### 8.1 é™æµè§¦å‘åçš„å“åº”


**ç”¨æˆ·ä½“éªŒä¼˜å…ˆ**ï¼šè¢«é™æµä¸åº”è¯¥ç®€å•è¿”å›é”™è¯¯ï¼Œè€Œè¦å‹å¥½æç¤º

**æ ‡å‡†å“åº”æ ¼å¼**ï¼š

```json
{
    "code": 429,
    "message": "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•",
    "data": {
        "retryAfter": 60,        // å»ºè®®60ç§’åé‡è¯•
        "limit": 100,            // é™æµé˜ˆå€¼
        "remaining": 0,          // å‰©ä½™é…é¢
        "reset": 1642405200      // é™æµé‡ç½®æ—¶é—´æˆ³
    }
}
```

### 8.2 è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†å™¨


**å…¨å±€å¼‚å¸¸æ‹¦æˆª**ï¼š

```java
@Component
public class RateLimitExceptionHandler implements ErrorWebExceptionHandler {
    
    @Override
    public Mono<Void> handle(ServerWebExchange exchange, Throwable ex) {
        
        if (ex instanceof RateLimitException) {
            RateLimitException rateLimitEx = (RateLimitException) ex;
            
            // è®¾ç½®å“åº”çŠ¶æ€ç 
            exchange.getResponse().setStatusCode(HttpStatus.TOO_MANY_REQUESTS);
            
            // è®¾ç½®å“åº”å¤´
            HttpHeaders headers = exchange.getResponse().getHeaders();
            headers.add("X-RateLimit-Limit", 
                String.valueOf(rateLimitEx.getLimit()));
            headers.add("X-RateLimit-Remaining", "0");
            headers.add("X-RateLimit-Reset", 
                String.valueOf(rateLimitEx.getResetTime()));
            
            // æ„å»ºå“åº”ä½“
            Result<Object> result = Result.error(429, 
                "è¯·æ±‚é¢‘ç‡è¶…é™ï¼Œè¯·" + rateLimitEx.getRetryAfter() + "ç§’åé‡è¯•");
            
            return writeResponse(exchange, result);
        }
        
        return Mono.error(ex);
    }
}
```

### 8.3 é™çº§ä¸ç†”æ–­


**é™æµè§¦å‘åçš„å¤„ç†ç­–ç•¥**ï¼š

```
å¤„ç†æµç¨‹ï¼š
è¯·æ±‚è¢«é™æµ
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ˜¯å¦æœ‰é™çº§æ–¹æ¡ˆï¼Ÿ      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“Yes              â†“No
è¿”å›ç¼“å­˜æ•°æ®        è¿”å›å‹å¥½æç¤º
æˆ–é»˜è®¤å€¼            å’Œé‡è¯•å»ºè®®
```

**é™çº§ç¤ºä¾‹**ï¼š

```java
@Component
public class RateLimitFallback {
    
    /**
     * æŸ¥è¯¢æ¥å£é™çº§ï¼šè¿”å›ç¼“å­˜æ•°æ®
     */
    public Mono<Result> queryFallback(ServerWebExchange exchange) {
        String cacheKey = getCacheKey(exchange);
        Object cachedData = redisTemplate.opsForValue().get(cacheKey);
        
        if (cachedData != null) {
            return Mono.just(Result.success(cachedData)
                .message("ç³»ç»Ÿç¹å¿™ï¼Œè¿”å›ç¼“å­˜æ•°æ®"));
        }
        
        return Mono.just(Result.error("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•"));
    }
    
    /**
     * å†™æ¥å£é™çº§ï¼šåŠ å…¥æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å¤„ç†
     */
    public Mono<Result> writeFallback(ServerWebExchange exchange) {
        // å°†è¯·æ±‚æ”¾å…¥æ¶ˆæ¯é˜Ÿåˆ—
        messageQueue.send(buildMessage(exchange));
        
        return Mono.just(Result.success()
            .message("è¯·æ±‚å·²æ¥æ”¶ï¼Œæ­£åœ¨å¼‚æ­¥å¤„ç†"));
    }
}
```

### 8.4 ç›‘æ§ä¸å‘Šè­¦


**é™æµäº‹ä»¶è®°å½•**ï¼š

```java
@Aspect
@Component
public class RateLimitMonitor {
    
    /**
     * è®°å½•é™æµäº‹ä»¶
     */
    @AfterThrowing(
        pointcut = "execution(* com.example..*RateLimit*(..))",
        throwing = "ex"
    )
    public void logRateLimitEvent(JoinPoint joinPoint, 
                                   RateLimitException ex) {
        
        RateLimitEvent event = RateLimitEvent.builder()
            .timestamp(System.currentTimeMillis())
            .ip(ex.getClientIp())
            .userId(ex.getUserId())
            .path(ex.getRequestPath())
            .limitType(ex.getLimitType())
            .build();
        
        // è®°å½•æ—¥å¿—
        log.warn("é™æµè§¦å‘: {}", event);
        
        // å‘é€ç›‘æ§æŒ‡æ ‡
        metricsCollector.recordRateLimit(event);
        
        // é¢‘ç¹è§¦å‘æ—¶å‘Šè­¦
        if (isFrequentRateLimit(event)) {
            alertService.sendAlert("é™æµé¢‘ç¹è§¦å‘", event);
        }
    }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 é™æµç­–ç•¥é€‰æ‹©æŒ‡å—


```
ç­–ç•¥ç±»å‹              ä½¿ç”¨åœºæ™¯                  ä¼˜å…ˆçº§
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸŒ IPé™æµ            é˜²æ”»å‡»ã€é˜²çˆ¬è™«             â­â­â­
ğŸ‘¤ ç”¨æˆ·é™æµ          é…é¢ç®¡ç†ã€åˆ†çº§æœåŠ¡          â­â­â­â­
ğŸ”Œ æ¥å£é™æµ          ä¿æŠ¤æ ¸å¿ƒæ¥å£               â­â­â­â­â­
ğŸ›¤ï¸ è·¯å¾„é™æµ          ç‰ˆæœ¬éš”ç¦»ã€åŠŸèƒ½åˆ†ç»„          â­â­â­
ğŸ“Š åˆ†çº§é™æµ          ç²¾ç»†åŒ–ç®¡ç†                 â­â­â­â­
ğŸ« ç™½åå•            å†…éƒ¨è°ƒç”¨ã€VIPæœåŠ¡          â­â­
```

### 9.2 é…ç½®å»ºè®®


**åŸºç¡€é…ç½®ç»„åˆ**ï¼š

```yaml
# æ¨èçš„ä¸‰å±‚é˜²æŠ¤
spring:
  cloud:
    gateway:
      routes:
        - id: api-route
          filters:
            # ç¬¬ä¸€å±‚ï¼šIPé™æµï¼ˆé˜²æ”»å‡»ï¼‰
            - name: IpRateLimiter
              args:
                replenishRate: 1000
            
            # ç¬¬äºŒå±‚ï¼šç”¨æˆ·é™æµï¼ˆé…é¢ç®¡ç†ï¼‰  
            - name: UserRateLimiter
              args:
                replenishRate: 100
            
            # ç¬¬ä¸‰å±‚ï¼šæ¥å£é™æµï¼ˆæ ¸å¿ƒä¿æŠ¤ï¼‰
            - name: ApiRateLimiter
              args:
                replenishRate: 10
```

### 9.3 å…³é”®å®ç°è¦ç‚¹


**å¿…é¡»æŒæ¡**ï¼š
- ğŸ”¸ **ç­–ç•¥ç»„åˆ**ï¼šå¤šç§é™æµç­–ç•¥é…åˆä½¿ç”¨ï¼Œå½¢æˆé˜²æŠ¤ä½“ç³»
- ğŸ”¸ **ç™½åå•ä¼˜å…ˆ**ï¼šå…ˆæ£€æŸ¥ç™½åå•ï¼Œé¿å…è¯¯ä¼¤
- ğŸ”¸ **å‹å¥½æç¤º**ï¼šè¢«é™æµæ—¶ç»™å‡ºæ˜ç¡®çš„é‡è¯•å»ºè®®
- ğŸ”¸ **åŠ¨æ€è°ƒæ•´**ï¼šæ ¹æ®ç³»ç»Ÿè´Ÿè½½å®æ—¶è°ƒæ•´é™æµé˜ˆå€¼
- ğŸ”¸ **ç›‘æ§å‘Šè­¦**ï¼šè®°å½•é™æµäº‹ä»¶ï¼ŒåŠæ—¶å‘ç°é—®é¢˜

### 9.4 å®æˆ˜ç»éªŒ


> âœ… **æœ€ä½³å®è·µ**
> - é™æµè§„åˆ™è¦è€ƒè™‘çªå‘æµé‡ï¼Œè®¾ç½®åˆç†çš„`burstCapacity`
> - å…³é”®æ¥å£å¿…é¡»è®¾ç½®å¤šå±‚é™æµä¿æŠ¤
> - ç™½åå•è¦æœ‰è¿‡æœŸæœºåˆ¶ï¼Œé¿å…é•¿æœŸç§¯ç´¯
> - é™æµè§¦å‘æ—¶æä¾›é™çº§æ–¹æ¡ˆï¼Œè€Œä¸æ˜¯ç›´æ¥æ‹’ç»

> âš ï¸ **å¸¸è§é™·é˜±**
> - é™æµé˜ˆå€¼è®¾ç½®è¿‡å°ï¼Œå½±å“æ­£å¸¸ç”¨æˆ·ä½“éªŒ
> - åªåšIPé™æµï¼Œæ— æ³•åº”å¯¹åˆ†å¸ƒå¼æ”»å‡»
> - å¿½ç•¥ä»£ç†æƒ…å†µï¼Œå¯¼è‡´IPè·å–é”™è¯¯
> - ç¼ºå°‘ç›‘æ§ï¼Œæ— æ³•åŠæ—¶å‘ç°é™æµé—®é¢˜

### 9.5 è®°å¿†å£è¯€


```
é™æµç­–ç•¥å¤šç»´åº¦ï¼Œ
IPç”¨æˆ·æ¥å£è·¯å¾„é½ã€‚
ç™½åå•è±å…è¦è°¨æ…ï¼Œ
å¼‚å¸¸å¤„ç†åˆ«å¿˜è®°ã€‚
åˆ†çº§ç­–ç•¥æ›´ç²¾ç»†ï¼Œ
åŠ¨æ€è°ƒæ•´ä¿ç¨³å®šã€‚
```