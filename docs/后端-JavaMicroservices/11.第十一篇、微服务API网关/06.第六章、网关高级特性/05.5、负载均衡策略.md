---
title: 5ã€è´Ÿè½½å‡è¡¡ç­–ç•¥
---
## ğŸ“š ç›®å½•

1. [è´Ÿè½½å‡è¡¡æ ¸å¿ƒæ¦‚å¿µ](#1-è´Ÿè½½å‡è¡¡æ ¸å¿ƒæ¦‚å¿µ)
2. [Spring Cloud LoadBalancerè¯¦è§£](#2-Spring-Cloud-LoadBalancerè¯¦è§£)
3. [è½®è¯¢è´Ÿè½½å‡è¡¡](#3-è½®è¯¢è´Ÿè½½å‡è¡¡)
4. [éšæœºè´Ÿè½½å‡è¡¡](#4-éšæœºè´Ÿè½½å‡è¡¡)
5. [æƒé‡è´Ÿè½½å‡è¡¡](#5-æƒé‡è´Ÿè½½å‡è¡¡)
6. [æœ€å°‘è¿æ¥è´Ÿè½½å‡è¡¡](#6-æœ€å°‘è¿æ¥è´Ÿè½½å‡è¡¡)
7. [ä¸€è‡´æ€§å“ˆå¸Œè´Ÿè½½å‡è¡¡](#7-ä¸€è‡´æ€§å“ˆå¸Œè´Ÿè½½å‡è¡¡)
8. [è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç­–ç•¥](#8-è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç­–ç•¥)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ è´Ÿè½½å‡è¡¡æ ¸å¿ƒæ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯è´Ÿè½½å‡è¡¡


**ğŸ’¡ ç”Ÿæ´»ä¸­çš„ä¾‹å­ç†è§£**

æƒ³è±¡ä¸€ä¸‹é“¶è¡ŒåŠä¸šåŠ¡çš„åœºæ™¯ï¼š
```
åœºæ™¯1ï¼šåªæœ‰1ä¸ªçª—å£
å®¢æˆ·Aã€Bã€Cã€Dã€E éƒ½æ’é˜Ÿç­‰å¾… â†’ æ•ˆç‡ä½ï¼Œå®¢æˆ·ç­‰å¾…æ—¶é—´é•¿

åœºæ™¯2ï¼šæœ‰5ä¸ªçª—å£
å®¢æˆ·Aâ†’çª—å£1   å®¢æˆ·Bâ†’çª—å£2   å®¢æˆ·Câ†’çª—å£3
å®¢æˆ·Dâ†’çª—å£4   å®¢æˆ·Eâ†’çª—å£5   â†’ æ•ˆç‡é«˜ï¼Œå¿«é€ŸåŠç†
```

**ğŸ”¸ å¾®æœåŠ¡ä¸­çš„è´Ÿè½½å‡è¡¡å°±æ˜¯è¿™ä¸ªé“ç†**ï¼šå½“æœ‰å¤šä¸ªç›¸åŒçš„æœåŠ¡å®ä¾‹æ—¶ï¼ŒæŠŠè¯·æ±‚åˆç†åˆ†é…ç»™ä¸åŒå®ä¾‹ï¼Œé¿å…æŸä¸ªå®ä¾‹å¤ªå¿™ã€æŸä¸ªå®ä¾‹å¤ªé—²ã€‚

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦è´Ÿè½½å‡è¡¡


**æ ¸å¿ƒåŸå› **ï¼š
- **ğŸ”´ å•ç‚¹å‹åŠ›é—®é¢˜**ï¼šä¸€ä¸ªæœåŠ¡æ‰›ä¸ä½æ‰€æœ‰è¯·æ±‚
- **ğŸŸ¢ èµ„æºåˆ©ç”¨ç‡**ï¼šå¤šä¸ªæœåŠ¡å®ä¾‹è¦å……åˆ†åˆ©ç”¨
- **ğŸ”µ é«˜å¯ç”¨ä¿éšœ**ï¼šæŸä¸ªå®ä¾‹æŒ‚äº†ï¼Œè¿˜æœ‰å…¶ä»–å®ä¾‹ç»§ç»­æœåŠ¡
- **ğŸŸ¡ æ€§èƒ½æå‡**ï¼šè¯·æ±‚åˆ†æ•£å¤„ç†ï¼Œå“åº”æ›´å¿«

**å®é™…åœºæ™¯å¯¹æ¯”**ï¼š

```
æ— è´Ÿè½½å‡è¡¡ï¼š
ç½‘å…³ â†’ è®¢å•æœåŠ¡å®ä¾‹1ï¼ˆ100%è¯·æ±‚å‹åŠ›ï¼‰ â†’ ğŸ’¥å¯èƒ½å´©æºƒ
        è®¢å•æœåŠ¡å®ä¾‹2ï¼ˆ0%é—²ç½®ï¼‰
        è®¢å•æœåŠ¡å®ä¾‹3ï¼ˆ0%é—²ç½®ï¼‰

æœ‰è´Ÿè½½å‡è¡¡ï¼š
ç½‘å…³ â†’ è®¢å•æœåŠ¡å®ä¾‹1ï¼ˆ33%è¯·æ±‚ï¼‰   âœ… å‹åŠ›å‡è¡¡
    â†’ è®¢å•æœåŠ¡å®ä¾‹2ï¼ˆ33%è¯·æ±‚ï¼‰   âœ… å……åˆ†åˆ©ç”¨
    â†’ è®¢å•æœåŠ¡å®ä¾‹3ï¼ˆ33%è¯·æ±‚ï¼‰   âœ… é«˜å¯ç”¨
```

### 1.3 è´Ÿè½½å‡è¡¡çš„ä½ç½®


**åœ¨å¾®æœåŠ¡æ¶æ„ä¸­çš„ä½ç½®**ï¼š
```
ç”¨æˆ·è¯·æ±‚
   â†“
APIç½‘å…³ï¼ˆè¿™é‡Œåšè´Ÿè½½å‡è¡¡ï¼‰
   â†“
â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”
â”‚æœåŠ¡1 â”‚æœåŠ¡2 â”‚æœåŠ¡3 â”‚ â† ç›¸åŒæœåŠ¡çš„å¤šä¸ªå®ä¾‹
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç†è§£**ï¼š
- APIç½‘å…³æ”¶åˆ°è¯·æ±‚åï¼Œéœ€è¦é€‰æ‹©ä¸€ä¸ªæœåŠ¡å®ä¾‹æ¥å¤„ç†
- è¿™ä¸ª"é€‰æ‹©"çš„è¿‡ç¨‹å°±æ˜¯**è´Ÿè½½å‡è¡¡ç­–ç•¥**
- ä¸åŒçš„ç­–ç•¥æœ‰ä¸åŒçš„é€‰æ‹©æ–¹å¼

---

## 2. ğŸš€ Spring Cloud LoadBalancerè¯¦è§£


### 2.1 ä»€ä¹ˆæ˜¯Spring Cloud LoadBalancer


**ğŸ“‹ å®˜æ–¹å®šä¹‰ç®€åŒ–**ï¼šSpring Cloudè‡ªå¸¦çš„å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡å™¨ï¼Œç”¨æ¥æ›¿ä»£è€ç‰ˆæœ¬çš„Ribbonã€‚

**ğŸ”¸ é€šä¿—ç†è§£**ï¼š
- å®ƒæ˜¯Spring Cloudæä¾›çš„"æ™ºèƒ½é€‰æ‹©å™¨"
- å½“ç½‘å…³è¦è°ƒç”¨æœåŠ¡æ—¶ï¼Œå®ƒå¸®ä½ ä»å¤šä¸ªå®ä¾‹ä¸­æŒ‘ä¸€ä¸ª
- å°±åƒä½ å»é¤å…ï¼ŒæœåŠ¡å‘˜å¸®ä½ å®‰æ’åˆ°å“ªä¸ªä½ç½®å

### 2.2 æ ¸å¿ƒç»„ä»¶è¯´æ˜


```
Spring Cloud LoadBalancer æ ¸å¿ƒç»„ä»¶ï¼š

ğŸ“¦ ServiceInstanceListSupplier
   â†“ï¼ˆæä¾›æœåŠ¡å®ä¾‹åˆ—è¡¨ï¼‰
   ä½œç”¨ï¼šä»æ³¨å†Œä¸­å¿ƒï¼ˆå¦‚Nacosï¼‰è·å–å¯ç”¨æœåŠ¡å®ä¾‹
   ç®€å•è¯´ï¼šå®ƒçŸ¥é“æœ‰å“ªäº›æœåŠ¡å®ä¾‹å¯ä»¥ç”¨

ğŸ“¦ ReactorLoadBalancer
   â†“ï¼ˆæ‰§è¡Œè´Ÿè½½å‡è¡¡é€»è¾‘ï¼‰
   ä½œç”¨ï¼šæ ¹æ®ç­–ç•¥ä»å®ä¾‹åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ª
   ç®€å•è¯´ï¼šå®ƒå†³å®šé€‰å“ªä¸ªå®ä¾‹

ğŸ“¦ LoadBalancerClient
   â†“ï¼ˆå¯¹å¤–æä¾›è°ƒç”¨æ¥å£ï¼‰
   ä½œç”¨ï¼šä¾›ç½‘å…³å’Œå…¶ä»–ç»„ä»¶ä½¿ç”¨
   ç®€å•è¯´ï¼šä½ åªéœ€è¦è°ƒç”¨å®ƒï¼Œå®ƒå¸®ä½ å®Œæˆè´Ÿè½½å‡è¡¡
```

### 2.3 åŸºç¡€ä¾èµ–é…ç½®


**Mavenä¾èµ–**ï¼š
```xml
<!-- Spring Cloud LoadBalanceræ ¸å¿ƒä¾èµ– -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-loadbalancer</artifactId>
</dependency>
```

**é…ç½®æ–‡ä»¶åŸºç¡€è®¾ç½®**ï¼š
```yaml
spring:
  cloud:
    loadbalancer:
      ribbon:
        enabled: false  # ç¦ç”¨æ—§ç‰ˆRibbon
```

ğŸ’¡ **å°è´´å£«**ï¼šSpring Cloud 2020ç‰ˆæœ¬åï¼Œå®˜æ–¹æ¨èä½¿ç”¨LoadBalanceræ›¿ä»£Ribbonã€‚

---

## 3. ğŸ”„ è½®è¯¢è´Ÿè½½å‡è¡¡


### 3.1 ä»€ä¹ˆæ˜¯è½®è¯¢ç­–ç•¥


**ğŸ¯ æ ¸å¿ƒæ€æƒ³**ï¼šæŒ‰é¡ºåºä¾æ¬¡é€‰æ‹©æœåŠ¡å®ä¾‹ï¼Œåƒæ’é˜Ÿä¸€æ ·ä¸€ä¸ªæ¥ä¸€ä¸ªã€‚

**å½¢è±¡æ¯”å–»**ï¼š
```
æƒ³è±¡3ä¸ªæœåŠ¡å‘˜Aã€Bã€Cè½®æµæ¥å¾…å®¢æˆ·ï¼š

ç¬¬1ä¸ªå®¢æˆ· â†’ æœåŠ¡å‘˜A
ç¬¬2ä¸ªå®¢æˆ· â†’ æœåŠ¡å‘˜B  
ç¬¬3ä¸ªå®¢æˆ· â†’ æœåŠ¡å‘˜C
ç¬¬4ä¸ªå®¢æˆ· â†’ æœåŠ¡å‘˜Aï¼ˆåˆå›åˆ°Aï¼Œå¾ªç¯ï¼‰
ç¬¬5ä¸ªå®¢æˆ· â†’ æœåŠ¡å‘˜B
...ä¾æ­¤ç±»æ¨
```

### 3.2 å·¥ä½œåŸç†å›¾ç¤º


```
è¯·æ±‚æµç¨‹ï¼š
                    è½®è¯¢ç´¢å¼•
                   (å¾ªç¯é€’å¢)
                       â†“
è¯·æ±‚1 â†’ [ç´¢å¼•0] â†’ æœåŠ¡å®ä¾‹1
è¯·æ±‚2 â†’ [ç´¢å¼•1] â†’ æœåŠ¡å®ä¾‹2
è¯·æ±‚3 â†’ [ç´¢å¼•2] â†’ æœåŠ¡å®ä¾‹3
è¯·æ±‚4 â†’ [ç´¢å¼•0] â†’ æœåŠ¡å®ä¾‹1ï¼ˆé‡æ–°å¼€å§‹ï¼‰
è¯·æ±‚5 â†’ [ç´¢å¼•1] â†’ æœåŠ¡å®ä¾‹2
```

### 3.3 é…ç½®æ–¹å¼


**æ–¹å¼ä¸€ï¼šé»˜è®¤å³æ˜¯è½®è¯¢**
```yaml
# application.yml
# ä¸é…ç½®ç­–ç•¥æ—¶ï¼Œé»˜è®¤å°±æ˜¯è½®è¯¢
```

**æ–¹å¼äºŒï¼šæ˜¾å¼æŒ‡å®šè½®è¯¢**
```java
@Configuration
public class LoadBalancerConfig {
    
    @Bean
    public ReactorLoadBalancer<ServiceInstance> reactorServiceInstanceLoadBalancer(
            Environment environment,
            LoadBalancerClientFactory loadBalancerClientFactory) {
        
        String name = environment.getProperty(LoadBalancerClientFactory.PROPERTY_NAME);
        
        // ä½¿ç”¨è½®è¯¢ç­–ç•¥
        return new RoundRobinLoadBalancer(
            loadBalancerClientFactory.getLazyProvider(name, ServiceInstanceListSupplier.class),
            name
        );
    }
}
```

### 3.4 ä¼˜ç¼ºç‚¹åˆ†æ


| ç‰¹ç‚¹ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| âœ… **ç®€å•å…¬å¹³** | æ¯ä¸ªå®ä¾‹æœºä¼šå‡ç­‰ | æœåŠ¡å®ä¾‹æ€§èƒ½ç›¸è¿‘ |
| âœ… **æ— çŠ¶æ€** | ä¸éœ€è¦è®°å½•é¢å¤–ä¿¡æ¯ | æ— sessionä¾èµ–çš„æœåŠ¡ |
| âœ… **æ˜“ç†è§£** | é€»è¾‘ç®€å•ï¼Œå¥½ç»´æŠ¤ | å¤§éƒ¨åˆ†åœºæ™¯ |
| âŒ **ä¸è€ƒè™‘æ€§èƒ½å·®å¼‚** | å¼ºå¼±æœåŠ¡å™¨ä¸€è§†åŒä» | æœåŠ¡å™¨é…ç½®å·®è·å¤§æ—¶ä¸é€‚ç”¨ |
| âŒ **ä¸è€ƒè™‘å®æ—¶è´Ÿè½½** | å¿½ç•¥å½“å‰ç¹å¿™ç¨‹åº¦ | è´Ÿè½½æ³¢åŠ¨å¤§æ—¶æ•ˆæœå·® |

**ğŸ”¥ æœ€ä½³å®è·µ**ï¼š
- æœåŠ¡å™¨é…ç½®ä¸€è‡´æ—¶é¦–é€‰è½®è¯¢
- ç®€å•åœºæ™¯ä¸‹é»˜è®¤ä½¿ç”¨è½®è¯¢å³å¯
- éœ€è¦è€ƒè™‘æ€§èƒ½å·®å¼‚æ—¶æ”¹ç”¨æƒé‡ç­–ç•¥

---

## 4. ğŸ² éšæœºè´Ÿè½½å‡è¡¡


### 4.1 ä»€ä¹ˆæ˜¯éšæœºç­–ç•¥


**ğŸ¯ æ ¸å¿ƒæ€æƒ³**ï¼šéšæœºé€‰æ‹©ä¸€ä¸ªæœåŠ¡å®ä¾‹ï¼Œå°±åƒæŠ½å¥–ä¸€æ ·ã€‚

**å½¢è±¡æ¯”å–»**ï¼š
```
æƒ³è±¡æœ‰3ä¸ªç›’å­ï¼ˆæœåŠ¡å®ä¾‹ï¼‰ï¼Œæ¯æ¬¡é—­çœ¼éšæœºé€‰ä¸€ä¸ªï¼š

ç¬¬1æ¬¡ï¼šéšæœº â†’ å¯èƒ½é€‰åˆ°ç›’å­B
ç¬¬2æ¬¡ï¼šéšæœº â†’ å¯èƒ½é€‰åˆ°ç›’å­A
ç¬¬3æ¬¡ï¼šéšæœº â†’ å¯èƒ½é€‰åˆ°ç›’å­Bï¼ˆå¯èƒ½é‡å¤ï¼‰
ç¬¬4æ¬¡ï¼šéšæœº â†’ å¯èƒ½é€‰åˆ°ç›’å­C
```

### 4.2 éšæœºä¸è½®è¯¢çš„åŒºåˆ«


```
è½®è¯¢ç­–ç•¥ï¼ˆæœ‰åºï¼‰ï¼š
å®ä¾‹A â†’ å®ä¾‹B â†’ å®ä¾‹C â†’ å®ä¾‹A â†’ å®ä¾‹B â†’ ...
è§„å¾‹ï¼š1-2-3-1-2-3...

éšæœºç­–ç•¥ï¼ˆæ— åºï¼‰ï¼š
å®ä¾‹B â†’ å®ä¾‹A â†’ å®ä¾‹B â†’ å®ä¾‹C â†’ å®ä¾‹A â†’ ...
è§„å¾‹ï¼š2-1-2-3-1...ï¼ˆå®Œå…¨éšæœºï¼‰
```

**å…³é”®å·®å¼‚**ï¼š
- è½®è¯¢æ˜¯**ç¡®å®šæ€§**çš„ï¼Œä¸‹ä¸€ä¸ªé€‰è°æ˜¯å›ºå®šçš„
- éšæœºæ˜¯**æ¦‚ç‡æ€§**çš„ï¼Œä¸‹ä¸€ä¸ªé€‰è°ä¸ç¡®å®š

### 4.3 å®ç°é…ç½®


```java
@Configuration
public class RandomLoadBalancerConfig {
    
    @Bean
    public ReactorLoadBalancer<ServiceInstance> randomLoadBalancer(
            Environment environment,
            LoadBalancerClientFactory loadBalancerClientFactory) {
        
        String name = environment.getProperty(LoadBalancerClientFactory.PROPERTY_NAME);
        
        // ä½¿ç”¨éšæœºç­–ç•¥
        return new RandomLoadBalancer(
            loadBalancerClientFactory.getLazyProvider(name, ServiceInstanceListSupplier.class),
            name
        );
    }
}
```

### 4.4 ç»Ÿè®¡åˆ†å¸ƒç‰¹æ€§


**ğŸ“Š è¯·æ±‚åˆ†å¸ƒè¶‹åŠ¿**ï¼ˆ1000æ¬¡è¯·æ±‚ï¼‰ï¼š
```
å®ä¾‹æ•°é‡ï¼š3ä¸ª
ç†è®ºåˆ†é…ï¼šæ¯ä¸ªçº¦333æ¬¡

å®é™…ç»“æœç¤ºä¾‹ï¼š
å®ä¾‹Aï¼š328æ¬¡ (32.8%)  â‰ˆ 33.3%
å®ä¾‹Bï¼š341æ¬¡ (34.1%)  â‰ˆ 33.3%
å®ä¾‹Cï¼š331æ¬¡ (33.1%)  â‰ˆ 33.3%

ç»“è®ºï¼šè¯·æ±‚é‡è¶Šå¤§ï¼Œåˆ†å¸ƒè¶Šå‡åŒ€
```

**âš ï¸ æ³¨æ„**ï¼šçŸ­æ—¶é—´å†…å¯èƒ½ä¸å‡åŒ€ï¼Œé•¿æœŸè¿è¡Œä¼šè¶‹äºå‡è¡¡ã€‚

### 4.5 é€‚ç”¨åœºæ™¯


âœ… **æ¨èä½¿ç”¨**ï¼š
- æœåŠ¡å®ä¾‹æ€§èƒ½ç›¸è¿‘
- ä¸éœ€è¦sessionä¿æŒ
- è¿½æ±‚ç®€å•å®ç°
- è¯·æ±‚é‡è¾ƒå¤§çš„åœºæ™¯

âŒ **ä¸æ¨èä½¿ç”¨**ï¼š
- éœ€è¦ä¼šè¯ä¿æŒçš„åœºæ™¯
- æœåŠ¡å™¨æ€§èƒ½å·®å¼‚å¤§
- å¯¹è¯·æ±‚é¡ºåºæœ‰è¦æ±‚

---

## 5. âš–ï¸ æƒé‡è´Ÿè½½å‡è¡¡


### 5.1 ä»€ä¹ˆæ˜¯æƒé‡ç­–ç•¥


**ğŸ¯ æ ¸å¿ƒæ€æƒ³**ï¼šç»™ä¸åŒæœåŠ¡å®ä¾‹è®¾ç½®æƒé‡ï¼Œæƒé‡å¤§çš„åˆ†é…æ›´å¤šè¯·æ±‚ã€‚

**ç”Ÿæ´»ä¾‹å­ç†è§£**ï¼š
```
å…¬å¸åˆ†ä»»åŠ¡ç»™3ä¸ªå‘˜å·¥ï¼š
å‘˜å·¥Aï¼ˆæ–°æ‰‹ï¼‰ï¼šæƒé‡1  â†’ åˆ†é…10%ä»»åŠ¡
å‘˜å·¥Bï¼ˆç†Ÿæ‰‹ï¼‰ï¼šæƒé‡3  â†’ åˆ†é…30%ä»»åŠ¡
å‘˜å·¥Cï¼ˆä¸“å®¶ï¼‰ï¼šæƒé‡6  â†’ åˆ†é…60%ä»»åŠ¡

æ€»æƒé‡ = 1+3+6 = 10
Açš„æ¯”ä¾‹ = 1/10 = 10%
Bçš„æ¯”ä¾‹ = 3/10 = 30%
Cçš„æ¯”ä¾‹ = 6/10 = 60%
```

### 5.2 æƒé‡è®¡ç®—åŸç†


**æƒé‡åˆ†é…å…¬å¼**ï¼š
```
å®ä¾‹æƒé‡å æ¯” = å½“å‰å®ä¾‹æƒé‡ / æ‰€æœ‰å®ä¾‹æƒé‡ä¹‹å’Œ

ç¤ºä¾‹ï¼š
å®ä¾‹Aæƒé‡=2, å®ä¾‹Bæƒé‡=3, å®ä¾‹Cæƒé‡=5
æ€»æƒé‡ = 2+3+5 = 10

å®ä¾‹Aåˆ†é…ç‡ = 2/10 = 20%
å®ä¾‹Båˆ†é…ç‡ = 3/10 = 30%
å®ä¾‹Cåˆ†é…ç‡ = 5/10 = 50%
```

**å®é™…åˆ†é…å›¾ç¤º**ï¼š
```
100ä¸ªè¯·æ±‚çš„æƒé‡åˆ†é…ï¼š

å®ä¾‹A (æƒé‡2, 20%) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 20ä¸ªè¯·æ±‚
å®ä¾‹B (æƒé‡3, 30%) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 30ä¸ªè¯·æ±‚
å®ä¾‹C (æƒé‡5, 50%) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 50ä¸ªè¯·æ±‚
```

### 5.3 é…ç½®å®ç°æ–¹å¼


**æ–¹å¼ä¸€ï¼šNacoså…ƒæ•°æ®é…ç½®æƒé‡**
```yaml
# åœ¨æœåŠ¡æä¾›è€…çš„application.ymlä¸­é…ç½®
spring:
  cloud:
    nacos:
      discovery:
        metadata:
          weight: 5  # è®¾ç½®å½“å‰å®ä¾‹æƒé‡ä¸º5
```

**æ–¹å¼äºŒï¼šè‡ªå®šä¹‰æƒé‡è´Ÿè½½å‡è¡¡å™¨**
```java
@Configuration
public class WeightedLoadBalancerConfig {
    
    @Bean
    public ReactorLoadBalancer<ServiceInstance> weightedLoadBalancer(
            Environment environment,
            LoadBalancerClientFactory loadBalancerClientFactory) {
        
        String name = environment.getProperty(LoadBalancerClientFactory.PROPERTY_NAME);
        
        return new WeightedLoadBalancer(
            loadBalancerClientFactory.getLazyProvider(name, ServiceInstanceListSupplier.class),
            name
        );
    }
}

// æƒé‡è´Ÿè½½å‡è¡¡å™¨å®ç°
public class WeightedLoadBalancer implements ReactorServiceInstanceLoadBalancer {
    
    private ObjectProvider<ServiceInstanceListSupplier> serviceInstanceListSupplierProvider;
    private String serviceId;
    
    @Override
    public Mono<Response<ServiceInstance>> choose(Request request) {
        ServiceInstanceListSupplier supplier = serviceInstanceListSupplierProvider.getIfAvailable();
        
        return supplier.get(request).next()
            .map(instances -> getInstanceByWeight(instances));
    }
    
    // æ ¹æ®æƒé‡é€‰æ‹©å®ä¾‹
    private Response<ServiceInstance> getInstanceByWeight(List<ServiceInstance> instances) {
        // è®¡ç®—æ€»æƒé‡
        int totalWeight = instances.stream()
            .mapToInt(instance -> getWeight(instance))
            .sum();
        
        // éšæœºæ•°é€‰æ‹©
        int randomWeight = ThreadLocalRandom.current().nextInt(totalWeight);
        int currentWeight = 0;
        
        for (ServiceInstance instance : instances) {
            currentWeight += getWeight(instance);
            if (randomWeight < currentWeight) {
                return new DefaultResponse(instance);
            }
        }
        
        return new DefaultResponse(instances.get(0));
    }
    
    // è·å–å®ä¾‹æƒé‡
    private int getWeight(ServiceInstance instance) {
        Map<String, String> metadata = instance.getMetadata();
        String weight = metadata.get("weight");
        return weight != null ? Integer.parseInt(weight) : 1;
    }
}
```

### 5.4 ä½¿ç”¨åœºæ™¯åˆ†æ


**âœ… é€‚ç”¨åœºæ™¯**ï¼š

ğŸ“Œ **åœºæ™¯1ï¼šæœåŠ¡å™¨æ€§èƒ½å·®å¼‚**
```
æœåŠ¡å™¨Aï¼š8æ ¸16G  â†’ æƒé‡è®¾ä¸º5
æœåŠ¡å™¨Bï¼š4æ ¸8G   â†’ æƒé‡è®¾ä¸º3
æœåŠ¡å™¨Cï¼š2æ ¸4G   â†’ æƒé‡è®¾ä¸º2
```

ğŸ“Œ **åœºæ™¯2ï¼šç°åº¦å‘å¸ƒ**
```
ç¨³å®šç‰ˆæœ¬å®ä¾‹ â†’ æƒé‡9 (90%æµé‡)
æ–°ç‰ˆæœ¬å®ä¾‹   â†’ æƒé‡1 (10%æµé‡ï¼Œç°åº¦æµ‹è¯•)
```

ğŸ“Œ **åœºæ™¯3ï¼šè·¨æœºæˆ¿éƒ¨ç½²**
```
åŒæœºæˆ¿å®ä¾‹   â†’ æƒé‡8 (ä¼˜å…ˆè°ƒç”¨)
å¼‚åœ°æœºæˆ¿å®ä¾‹ â†’ æƒé‡2 (å¤‡ç”¨)
```

**âŒ ä¸é€‚ç”¨åœºæ™¯**ï¼š
- æ‰€æœ‰æœåŠ¡å™¨æ€§èƒ½å®Œå…¨ä¸€è‡´
- ä¸éœ€è¦æµé‡æ§åˆ¶
- åŠ¨æ€è´Ÿè½½è°ƒæ•´éœ€æ±‚ï¼ˆéœ€è¦ç”¨æœ€å°‘è¿æ¥ç­–ç•¥ï¼‰

---

## 6. ğŸ“Š æœ€å°‘è¿æ¥è´Ÿè½½å‡è¡¡


### 6.1 ä»€ä¹ˆæ˜¯æœ€å°‘è¿æ¥ç­–ç•¥


**ğŸ¯ æ ¸å¿ƒæ€æƒ³**ï¼šé€‰æ‹©å½“å‰è¿æ¥æ•°æœ€å°‘ï¼ˆæœ€ç©ºé—²ï¼‰çš„æœåŠ¡å®ä¾‹ã€‚

**ç”Ÿæ´»ä¾‹å­ç†è§£**ï¼š
```
è¶…å¸‚æ”¶é“¶åœºæ™¯ï¼š
æ”¶é“¶å°Aï¼šæ­£åœ¨æœåŠ¡3ä¸ªäºº  â†’ ä¸é€‰
æ”¶é“¶å°Bï¼šæ­£åœ¨æœåŠ¡1ä¸ªäºº  â†’ é€‰è¿™ä¸ªï¼
æ”¶é“¶å°Cï¼šæ­£åœ¨æœåŠ¡5ä¸ªäºº  â†’ ä¸é€‰

ä½ ä¼šé€‰æ‹©æ’é˜Ÿäººæ•°æœ€å°‘çš„æ”¶é“¶å°ï¼Œæœ€å°‘è¿æ¥ç­–ç•¥ä¹Ÿæ˜¯è¿™ä¸ªé“ç†
```

### 6.2 å·¥ä½œåŸç†å›¾ç¤º


```
å®æ—¶çŠ¶æ€ç›‘æ§ï¼š
                    è¿æ¥æ•°ç»Ÿè®¡
                        â†“
å®ä¾‹Aï¼šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 8ä¸ªè¿æ¥
å®ä¾‹Bï¼šâ–ˆâ–ˆâ–ˆ 3ä¸ªè¿æ¥      â† é€‰æ‹©è¿™ä¸ªï¼ˆè¿æ¥æœ€å°‘ï¼‰
å®ä¾‹Cï¼šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 6ä¸ªè¿æ¥

æ–°è¯·æ±‚åˆ°æ¥ â†’ åˆ†é…ç»™å®ä¾‹Bï¼ˆå½“å‰æœ€ç©ºé—²ï¼‰
```

**åŠ¨æ€è°ƒæ•´ç¤ºä¾‹**ï¼š
```
åˆå§‹çŠ¶æ€ï¼š
å®ä¾‹A: 5ä¸ªè¿æ¥
å®ä¾‹B: 3ä¸ªè¿æ¥  â† ç¬¬1ä¸ªè¯·æ±‚åˆ†é…ç»™B
å®ä¾‹C: 8ä¸ªè¿æ¥

ç¬¬1ä¸ªè¯·æ±‚åï¼š
å®ä¾‹A: 5ä¸ªè¿æ¥
å®ä¾‹B: 4ä¸ªè¿æ¥
å®ä¾‹C: 8ä¸ªè¿æ¥

ç¬¬2ä¸ªè¯·æ±‚ï¼š
å®ä¾‹Bå’ŒAéƒ½æ˜¯4-5ä¸ªï¼Œé€‰è¿æ¥å°‘çš„ â†’ é€‰B

ç¬¬3ä¸ªè¯·æ±‚ï¼š
å®ä¾‹B: 5ä¸ªè¿æ¥
å®ä¾‹A: 5ä¸ªè¿æ¥  â† ç›¸åŒæ—¶éšæœºé€‰ä¸€ä¸ª
å®ä¾‹C: 8ä¸ªè¿æ¥
```

### 6.3 å®ç°æ–¹å¼


```java
@Configuration
public class LeastConnectionLoadBalancerConfig {
    
    // è¿æ¥è®¡æ•°å™¨
    private final ConcurrentHashMap<String, AtomicInteger> connectionCounts = new ConcurrentHashMap<>();
    
    @Bean
    public ReactorLoadBalancer<ServiceInstance> leastConnectionLoadBalancer(
            Environment environment,
            LoadBalancerClientFactory loadBalancerClientFactory) {
        
        String name = environment.getProperty(LoadBalancerClientFactory.PROPERTY_NAME);
        
        return new LeastConnectionLoadBalancer(
            loadBalancerClientFactory.getLazyProvider(name, ServiceInstanceListSupplier.class),
            name,
            connectionCounts
        );
    }
}

// æœ€å°‘è¿æ¥è´Ÿè½½å‡è¡¡å™¨
public class LeastConnectionLoadBalancer implements ReactorServiceInstanceLoadBalancer {
    
    private ObjectProvider<ServiceInstanceListSupplier> serviceInstanceListSupplierProvider;
    private String serviceId;
    private ConcurrentHashMap<String, AtomicInteger> connectionCounts;
    
    @Override
    public Mono<Response<ServiceInstance>> choose(Request request) {
        ServiceInstanceListSupplier supplier = serviceInstanceListSupplierProvider.getIfAvailable();
        
        return supplier.get(request).next()
            .map(instances -> chooseLeastConnection(instances));
    }
    
    private Response<ServiceInstance> chooseLeastConnection(List<ServiceInstance> instances) {
        ServiceInstance selected = null;
        int minConnections = Integer.MAX_VALUE;
        
        // æ‰¾å‡ºè¿æ¥æ•°æœ€å°‘çš„å®ä¾‹
        for (ServiceInstance instance : instances) {
            String instanceId = instance.getInstanceId();
            int connections = connectionCounts
                .computeIfAbsent(instanceId, k -> new AtomicInteger(0))
                .get();
            
            if (connections < minConnections) {
                minConnections = connections;
                selected = instance;
            }
        }
        
        // å¢åŠ è¿æ¥è®¡æ•°
        connectionCounts.get(selected.getInstanceId()).incrementAndGet();
        
        return new DefaultResponse(selected);
    }
}
```

### 6.4 ä¼˜åŠ¿ä¸é™åˆ¶


**âœ… ä¼˜åŠ¿**ï¼š

| ä¼˜åŠ¿ | è¯´æ˜ | æ•ˆæœ |
|------|------|------|
| **åŠ¨æ€é€‚åº”è´Ÿè½½** | å®æ—¶æ„ŸçŸ¥å®ä¾‹ç¹å¿™ç¨‹åº¦ | é¿å…è¿‡è½½ |
| **æ€§èƒ½æœ€ä¼˜** | æ€»æ˜¯é€‰æœ€ç©ºé—²çš„å®ä¾‹ | å“åº”æ›´å¿« |
| **è‡ªåŠ¨å‡è¡¡** | ä¸éœ€è¦äººå·¥è®¾ç½®æƒé‡ | æ™ºèƒ½åˆ†é… |

**âŒ é™åˆ¶**ï¼š

âš ï¸ **éœ€è¦è¿æ¥è¿½è¸ª**ï¼šå¿…é¡»å®æ—¶ç»Ÿè®¡æ¯ä¸ªå®ä¾‹çš„è¿æ¥æ•°
âš ï¸ **çŠ¶æ€åŒæ­¥å¼€é”€**ï¼šéœ€è¦ç»´æŠ¤è¿æ¥è®¡æ•°çŠ¶æ€
âš ï¸ **å¤æ‚åº¦è¾ƒé«˜**ï¼šå®ç°æ¯”è½®è¯¢å’Œéšæœºå¤æ‚

**ğŸ”¥ é€‚ç”¨åœºæ™¯**ï¼š
- é•¿è¿æ¥æœåŠ¡ï¼ˆWebSocketã€æ•°æ®åº“è¿æ¥æ± ï¼‰
- å¤„ç†æ—¶é—´å·®å¼‚å¤§çš„è¯·æ±‚
- å®ä¾‹æ€§èƒ½åŠ¨æ€å˜åŒ–çš„åœºæ™¯

---

## 7. ğŸ”— ä¸€è‡´æ€§å“ˆå¸Œè´Ÿè½½å‡è¡¡


### 7.1 ä»€ä¹ˆæ˜¯ä¸€è‡´æ€§å“ˆå¸Œ


**ğŸ¯ æ ¸å¿ƒæ€æƒ³**ï¼šæ ¹æ®è¯·æ±‚çš„æŸä¸ªç‰¹å¾ï¼ˆå¦‚ç”¨æˆ·IDï¼‰è®¡ç®—å“ˆå¸Œå€¼ï¼Œç›¸åŒç‰¹å¾çš„è¯·æ±‚æ€»æ˜¯è·¯ç”±åˆ°åŒä¸€ä¸ªæœåŠ¡å®ä¾‹ã€‚

**ä¸ºä»€ä¹ˆéœ€è¦ä¸€è‡´æ€§å“ˆå¸Œ**ï¼š

æ™®é€šå“ˆå¸Œçš„é—®é¢˜ï¼š
```
åœºæ™¯ï¼š3ä¸ªæœåŠ¡å®ä¾‹
ç”¨æˆ·Açš„è¯·æ±‚ï¼šhash(userA) % 3 = å®ä¾‹1

å¦‚æœå®ä¾‹æ•°å˜ä¸º4ï¼š
ç”¨æˆ·Açš„è¯·æ±‚ï¼šhash(userA) % 4 = å®ä¾‹2  â† å˜äº†ï¼

é—®é¢˜ï¼šå®ä¾‹æ•°æ”¹å˜ï¼Œå¤§é‡è¯·æ±‚ä¼šè·¯ç”±åˆ°ä¸åŒå®ä¾‹
å½±å“ï¼šç¼“å­˜å¤±æ•ˆã€sessionä¸¢å¤±
```

ä¸€è‡´æ€§å“ˆå¸Œè§£å†³æ–¹æ¡ˆï¼š
```
å°†æœåŠ¡å®ä¾‹æ˜ å°„åˆ°ä¸€ä¸ªç¯ä¸Šï¼Œè¯·æ±‚æ ¹æ®å“ˆå¸Œå€¼åœ¨ç¯ä¸Šæ‰¾æœ€è¿‘çš„å®ä¾‹

ä¼˜åŠ¿ï¼šå®ä¾‹å¢å‡æ—¶ï¼Œåªå½±å“å°‘é‡è¯·æ±‚è·¯ç”±
```

### 7.2 ä¸€è‡´æ€§å“ˆå¸Œç¯åŸç†


**å“ˆå¸Œç¯ç»“æ„å›¾**ï¼š
```
                    0/360Â°
                      â†‘
        270Â° â†        â€¢        â†’ 90Â°
                   â•±     â•²
    å®ä¾‹Bâ€¢     â•±           â•²     â€¢å®ä¾‹A
            â•±                 â•²
          â•±                     â•²
        â•±                         â•²
      â€¢                             â€¢
   è¯·æ±‚1(hash=100)              è¯·æ±‚2(hash=270)
      â†“                             â†“
   åˆ†é…ç»™å®ä¾‹A                    åˆ†é…ç»™å®ä¾‹B
                  â•²           â•±
                    â•²       â•±
                      â†“   â†“
                     180Â°
                    å®ä¾‹Câ€¢

å·¥ä½œæµç¨‹ï¼š
1. å°†æœåŠ¡å®ä¾‹æ˜ å°„åˆ°ç¯ä¸Šï¼ˆé€šè¿‡å®ä¾‹IDå“ˆå¸Œï¼‰
2. è¯·æ±‚é€šè¿‡ç‰¹å¾å€¼ï¼ˆå¦‚ç”¨æˆ·IDï¼‰å“ˆå¸Œåˆ°ç¯ä¸ŠæŸä¸ªä½ç½®
3. é¡ºæ—¶é’ˆæ‰¾åˆ°ç¬¬ä¸€ä¸ªå®ä¾‹èŠ‚ç‚¹
```

**æ·»åŠ /åˆ é™¤å®ä¾‹çš„å½±å“**ï¼š
```
åŸå§‹ç¯ï¼ˆ3ä¸ªå®ä¾‹ï¼‰ï¼š
        A(90Â°)
           â€¢
    C(270Â°)â€¢   â€¢B(180Â°)
    
åˆ é™¤å®ä¾‹Båï¼š
        A(90Â°)
           â€¢
    C(270Â°)â€¢   
           
å½±å“åˆ†æï¼š
- åŸæœ¬è·¯ç”±åˆ°Bçš„è¯·æ±‚(90Â°-180Â°åŒºé—´) â†’ ç°åœ¨è·¯ç”±åˆ°C
- å…¶ä»–è¯·æ±‚ä¸å—å½±å“
- åªå½±å“çº¦1/3çš„è¯·æ±‚è·¯ç”±
```

### 7.3 è™šæ‹ŸèŠ‚ç‚¹ä¼˜åŒ–


**ä¸ºä»€ä¹ˆéœ€è¦è™šæ‹ŸèŠ‚ç‚¹**ï¼š

é—®é¢˜ï¼šå®ä¾‹æ•°é‡å°‘æ—¶ï¼ŒèŠ‚ç‚¹åœ¨ç¯ä¸Šåˆ†å¸ƒä¸å‡åŒ€
```
2ä¸ªå®ä¾‹çš„æƒ…å†µï¼š
    A(30Â°)
      â€¢
              ç¯çš„ä¸€å¤§åŠéƒ½æ˜¯Aè´Ÿè´£
                    â†“
                è´Ÿè½½ä¸å‡è¡¡
      â€¢
    B(200Â°)
```

è§£å†³ï¼šä¸ºæ¯ä¸ªå®ä¾‹åˆ›å»ºå¤šä¸ªè™šæ‹ŸèŠ‚ç‚¹
```
å®ä¾‹A â†’ è™šæ‹ŸèŠ‚ç‚¹ï¼šA-1(30Â°), A-2(120Â°), A-3(210Â°)
å®ä¾‹B â†’ è™šæ‹ŸèŠ‚ç‚¹ï¼šB-1(60Â°), B-2(150Â°), B-3(240Â°)

ç»“æœï¼š6ä¸ªè™šæ‹ŸèŠ‚ç‚¹å‡åŒ€åˆ†å¸ƒ â†’ è´Ÿè½½æ›´å‡è¡¡
```

### 7.4 é…ç½®å®ç°


```java
@Configuration
public class ConsistentHashLoadBalancerConfig {
    
    @Bean
    public ReactorLoadBalancer<ServiceInstance> consistentHashLoadBalancer(
            Environment environment,
            LoadBalancerClientFactory loadBalancerClientFactory) {
        
        String name = environment.getProperty(LoadBalancerClientFactory.PROPERTY_NAME);
        
        return new ConsistentHashLoadBalancer(
            loadBalancerClientFactory.getLazyProvider(name, ServiceInstanceListSupplier.class),
            name,
            150  // è™šæ‹ŸèŠ‚ç‚¹æ•°é‡
        );
    }
}

// ä¸€è‡´æ€§å“ˆå¸Œè´Ÿè½½å‡è¡¡å™¨
public class ConsistentHashLoadBalancer implements ReactorServiceInstanceLoadBalancer {
    
    private TreeMap<Long, ServiceInstance> virtualNodes = new TreeMap<>();
    private int virtualNodeCount;
    
    @Override
    public Mono<Response<ServiceInstance>> choose(Request request) {
        ServiceInstanceListSupplier supplier = serviceInstanceListSupplierProvider.getIfAvailable();
        
        return supplier.get(request).next()
            .map(instances -> {
                // æ„å»ºå“ˆå¸Œç¯
                buildHashRing(instances);
                
                // ä»è¯·æ±‚ä¸­æå–å“ˆå¸Œé”®ï¼ˆå¦‚ç”¨æˆ·IDï¼‰
                String hashKey = getHashKey(request);
                long hash = hash(hashKey);
                
                // åœ¨ç¯ä¸Šæ‰¾åˆ°å¯¹åº”å®ä¾‹
                return new DefaultResponse(getInstanceFromRing(hash));
            });
    }
    
    private void buildHashRing(List<ServiceInstance> instances) {
        virtualNodes.clear();
        
        // ä¸ºæ¯ä¸ªå®ä¾‹åˆ›å»ºè™šæ‹ŸèŠ‚ç‚¹
        for (ServiceInstance instance : instances) {
            for (int i = 0; i < virtualNodeCount; i++) {
                String virtualNodeKey = instance.getInstanceId() + "-VN" + i;
                long hash = hash(virtualNodeKey);
                virtualNodes.put(hash, instance);
            }
        }
    }
    
    private ServiceInstance getInstanceFromRing(long hash) {
        // åœ¨ç¯ä¸Šé¡ºæ—¶é’ˆæŸ¥æ‰¾
        Map.Entry<Long, ServiceInstance> entry = virtualNodes.ceilingEntry(hash);
        
        if (entry == null) {
            // è¶…è¿‡æœ€å¤§å€¼ï¼Œè¿”å›ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆç¯çŠ¶ç»“æ„ï¼‰
            entry = virtualNodes.firstEntry();
        }
        
        return entry.getValue();
    }
    
    private long hash(String key) {
        // MurmurHashç®—æ³•ï¼ˆé«˜æ€§èƒ½å“ˆå¸Œï¼‰
        return MurmurHash.hash64(key.getBytes());
    }
}
```

### 7.5 åº”ç”¨åœºæ™¯


**âœ… æœ€ä½³åº”ç”¨åœºæ™¯**ï¼š

ğŸ“Œ **åœºæ™¯1ï¼šåˆ†å¸ƒå¼ç¼“å­˜**
```
éœ€æ±‚ï¼šç”¨æˆ·sessionç¼“å­˜åœ¨æœåŠ¡å®ä¾‹æœ¬åœ°å†…å­˜
è¦æ±‚ï¼šåŒä¸€ç”¨æˆ·çš„è¯·æ±‚å¿…é¡»è·¯ç”±åˆ°åŒä¸€å®ä¾‹

è§£å†³ï¼šä½¿ç”¨ç”¨æˆ·IDä½œä¸ºå“ˆå¸Œé”®
ç”¨æˆ·A(ID=12345) â†’ hash â†’ æ€»æ˜¯è·¯ç”±åˆ°å®ä¾‹B
```

ğŸ“Œ **åœºæ™¯2ï¼šæœ‰çŠ¶æ€æœåŠ¡**
```
WebSocketé•¿è¿æ¥ï¼š
å®¢æˆ·ç«¯Aè¿æ¥åˆ°å®ä¾‹1åï¼Œåç»­æ¶ˆæ¯å¿…é¡»å‘åˆ°å®ä¾‹1

è§£å†³ï¼šä½¿ç”¨è¿æ¥IDä½œä¸ºå“ˆå¸Œé”®
```

ğŸ“Œ **åœºæ™¯3ï¼šåˆ†ç‰‡æ•°æ®å¤„ç†**
```
å¤§æ•°æ®å¤„ç†åœºæ™¯ï¼š
è®¢å•1-1000   â†’ å®ä¾‹Aå¤„ç†
è®¢å•1001-2000 â†’ å®ä¾‹Bå¤„ç†

è§£å†³ï¼šä½¿ç”¨è®¢å•IDä½œä¸ºå“ˆå¸Œé”®
```

**âŒ ä¸é€‚ç”¨åœºæ™¯**ï¼š
- æ— çŠ¶æ€æœåŠ¡ï¼ˆç”¨è½®è¯¢æ›´ç®€å•ï¼‰
- éœ€è¦ç»å¯¹è´Ÿè½½å‡è¡¡ï¼ˆä¸€è‡´æ€§å“ˆå¸Œå…è®¸ä¸€å®šåå·®ï¼‰
- å®ä¾‹é¢‘ç¹å˜åŠ¨ï¼ˆè™½ç„¶å½±å“å°ï¼Œä½†ä»æœ‰å½±å“ï¼‰

---

## 8. ğŸ› ï¸ è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç­–ç•¥


### 8.1 ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰ç­–ç•¥


**å†…ç½®ç­–ç•¥çš„å±€é™æ€§**ï¼š
```
è½®è¯¢ï¼šä¸è€ƒè™‘æœåŠ¡å™¨æ€§èƒ½
éšæœºï¼šä¸è€ƒè™‘å®æ—¶è´Ÿè½½
æƒé‡ï¼šéœ€è¦æ‰‹åŠ¨é…ç½®æƒé‡
æœ€å°‘è¿æ¥ï¼šä¸è€ƒè™‘å“åº”æ—¶é—´
ä¸€è‡´æ€§å“ˆå¸Œï¼šå±€é™äºç‰¹å®šåœºæ™¯
```

**å®é™…ä¸šåŠ¡éœ€æ±‚å¯èƒ½æ›´å¤æ‚**ï¼š
- æ ¹æ®å“åº”æ—¶é—´åŠ¨æ€è°ƒæ•´
- æ ¹æ®åœ°ç†ä½ç½®ä¼˜å…ˆé€‰æ‹©
- ç»“åˆå¤šç§ç­–ç•¥çš„æ··åˆæ¨¡å¼
- æ ¹æ®ä¸šåŠ¡è§„åˆ™å®šåˆ¶è·¯ç”±

### 8.2 è‡ªå®šä¹‰ç­–ç•¥å¼€å‘æ­¥éª¤


**ğŸ“‹ å¼€å‘æµç¨‹**ï¼š

```
æ­¥éª¤1ï¼šå®ç°ReactorServiceInstanceLoadBalanceræ¥å£
   â†“
æ­¥éª¤2ï¼šç¼–å†™choose()æ–¹æ³•å®ç°é€‰æ‹©é€»è¾‘
   â†“
æ­¥éª¤3ï¼šæ³¨å†Œä¸ºSpring Bean
   â†“
æ­¥éª¤4ï¼šåœ¨é…ç½®ä¸­æŒ‡å®šä½¿ç”¨
```

### 8.3 ç¤ºä¾‹ï¼šåŸºäºå“åº”æ—¶é—´çš„è´Ÿè½½å‡è¡¡


**ä¸šåŠ¡éœ€æ±‚**ï¼šä¼˜å…ˆé€‰æ‹©å“åº”æ—¶é—´çŸ­çš„æœåŠ¡å®ä¾‹

```java
/**
 * åŸºäºå“åº”æ—¶é—´çš„è´Ÿè½½å‡è¡¡ç­–ç•¥
 * åŸç†ï¼šè®°å½•æ¯ä¸ªå®ä¾‹çš„å¹³å‡å“åº”æ—¶é—´ï¼Œä¼˜å…ˆé€‰æ‹©å“åº”å¿«çš„å®ä¾‹
 */
@Slf4j
public class ResponseTimeLoadBalancer implements ReactorServiceInstanceLoadBalancer {
    
    // è®°å½•æ¯ä¸ªå®ä¾‹çš„å“åº”æ—¶é—´
    private final ConcurrentHashMap<String, ResponseTimeStats> responseTimeMap = new ConcurrentHashMap<>();
    
    private ObjectProvider<ServiceInstanceListSupplier> serviceInstanceListSupplierProvider;
    private String serviceId;
    
    @Override
    public Mono<Response<ServiceInstance>> choose(Request request) {
        ServiceInstanceListSupplier supplier = serviceInstanceListSupplierProvider.getIfAvailable();
        
        return supplier.get(request).next()
            .map(instances -> chooseByResponseTime(instances));
    }
    
    private Response<ServiceInstance> chooseByResponseTime(List<ServiceInstance> instances) {
        ServiceInstance selected = null;
        long minResponseTime = Long.MAX_VALUE;
        
        // æ‰¾å‡ºå¹³å‡å“åº”æ—¶é—´æœ€çŸ­çš„å®ä¾‹
        for (ServiceInstance instance : instances) {
            ResponseTimeStats stats = responseTimeMap.computeIfAbsent(
                instance.getInstanceId(), 
                k -> new ResponseTimeStats()
            );
            
            long avgResponseTime = stats.getAverageResponseTime();
            
            if (avgResponseTime < minResponseTime) {
                minResponseTime = avgResponseTime;
                selected = instance;
            }
        }
        
        // å¦‚æœéƒ½æ²¡æœ‰å†å²è®°å½•ï¼Œéšæœºé€‰ä¸€ä¸ª
        if (selected == null) {
            selected = instances.get(ThreadLocalRandom.current().nextInt(instances.size()));
        }
        
        // è®°å½•æœ¬æ¬¡é€‰æ‹©ï¼Œç”¨äºåç»­æ›´æ–°å“åº”æ—¶é—´
        final ServiceInstance finalSelected = selected;
        
        return new DefaultResponse(selected);
    }
    
    // æ›´æ–°å“åº”æ—¶é—´ç»Ÿè®¡
    public void recordResponseTime(String instanceId, long responseTime) {
        responseTimeMap.computeIfAbsent(instanceId, k -> new ResponseTimeStats())
            .addResponseTime(responseTime);
    }
    
    // å“åº”æ—¶é—´ç»Ÿè®¡ç±»
    static class ResponseTimeStats {
        private final AtomicLong totalResponseTime = new AtomicLong(0);
        private final AtomicInteger requestCount = new AtomicInteger(0);
        
        public void addResponseTime(long responseTime) {
            totalResponseTime.addAndGet(responseTime);
            requestCount.incrementAndGet();
        }
        
        public long getAverageResponseTime() {
            int count = requestCount.get();
            return count > 0 ? totalResponseTime.get() / count : Long.MAX_VALUE;
        }
    }
}
```

**é…ç½®ä½¿ç”¨**ï¼š
```java
@Configuration
public class CustomLoadBalancerConfig {
    
    @Bean
    public ResponseTimeLoadBalancer responseTimeLoadBalancer(
            Environment environment,
            LoadBalancerClientFactory loadBalancerClientFactory) {
        
        String name = environment.getProperty(LoadBalancerClientFactory.PROPERTY_NAME);
        
        return new ResponseTimeLoadBalancer(
            loadBalancerClientFactory.getLazyProvider(name, ServiceInstanceListSupplier.class),
            name
        );
    }
}
```

### 8.4 ç¤ºä¾‹ï¼šåœ°ç†ä½ç½®ä¼˜å…ˆç­–ç•¥


**ä¸šåŠ¡éœ€æ±‚**ï¼šä¼˜å…ˆé€‰æ‹©åŒæœºæˆ¿çš„æœåŠ¡å®ä¾‹

```java
/**
 * åœ°ç†ä½ç½®ä¼˜å…ˆè´Ÿè½½å‡è¡¡ç­–ç•¥
 * åŸç†ï¼šä¼˜å…ˆé€‰æ‹©åŒæœºæˆ¿å®ä¾‹ï¼Œæ²¡æœ‰æ—¶é€‰æ‹©ä¸´è¿‘æœºæˆ¿
 */
public class RegionAwareLoadBalancer implements ReactorServiceInstanceLoadBalancer {
    
    private ObjectProvider<ServiceInstanceListSupplier> serviceInstanceListSupplierProvider;
    private String serviceId;
    private String currentRegion; // å½“å‰ç½‘å…³æ‰€åœ¨æœºæˆ¿
    
    @Override
    public Mono<Response<ServiceInstance>> choose(Request request) {
        ServiceInstanceListSupplier supplier = serviceInstanceListSupplierProvider.getIfAvailable();
        
        return supplier.get(request).next()
            .map(instances -> chooseByRegion(instances));
    }
    
    private Response<ServiceInstance> chooseByRegion(List<ServiceInstance> instances) {
        // ç¬¬ä¸€ä¼˜å…ˆçº§ï¼šåŒæœºæˆ¿å®ä¾‹
        List<ServiceInstance> sameRegionInstances = instances.stream()
            .filter(instance -> currentRegion.equals(getRegion(instance)))
            .collect(Collectors.toList());
        
        if (!sameRegionInstances.isEmpty()) {
            // åŒæœºæˆ¿å†…ä½¿ç”¨è½®è¯¢
            return new DefaultResponse(
                sameRegionInstances.get(
                    ThreadLocalRandom.current().nextInt(sameRegionInstances.size())
                )
            );
        }
        
        // ç¬¬äºŒä¼˜å…ˆçº§ï¼šä¸´è¿‘æœºæˆ¿å®ä¾‹
        List<ServiceInstance> nearbyInstances = instances.stream()
            .filter(instance -> isNearbyRegion(getRegion(instance)))
            .collect(Collectors.toList());
        
        if (!nearbyInstances.isEmpty()) {
            return new DefaultResponse(
                nearbyInstances.get(
                    ThreadLocalRandom.current().nextInt(nearbyInstances.size())
                )
            );
        }
        
        // éƒ½æ²¡æœ‰ï¼Œéšæœºé€‰ä¸€ä¸ª
        return new DefaultResponse(
            instances.get(ThreadLocalRandom.current().nextInt(instances.size()))
        );
    }
    
    private String getRegion(ServiceInstance instance) {
        return instance.getMetadata().getOrDefault("region", "unknown");
    }
    
    private boolean isNearbyRegion(String region) {
        // å®šä¹‰æœºæˆ¿ä¸´è¿‘å…³ç³»
        Map<String, List<String>> nearbyMap = Map.of(
            "beijing", List.of("tianjin", "hebei"),
            "shanghai", List.of("jiangsu", "zhejiang")
        );
        
        return nearbyMap.getOrDefault(currentRegion, List.of()).contains(region);
    }
}
```

### 8.5 æ··åˆç­–ç•¥ç¤ºä¾‹


**ä¸šåŠ¡éœ€æ±‚**ï¼šç»“åˆæƒé‡å’Œå“åº”æ—¶é—´

```java
/**
 * æ··åˆè´Ÿè½½å‡è¡¡ç­–ç•¥
 * åŸç†ï¼š70%æŒ‰æƒé‡åˆ†é…ï¼Œ30%æŒ‰å“åº”æ—¶é—´é€‰æ‹©
 */
public class HybridLoadBalancer implements ReactorServiceInstanceLoadBalancer {
    
    private WeightedLoadBalancer weightedLoadBalancer;
    private ResponseTimeLoadBalancer responseTimeLoadBalancer;
    private double weightRatio = 0.7; // æƒé‡ç­–ç•¥å æ¯”
    
    @Override
    public Mono<Response<ServiceInstance>> choose(Request request) {
        // 70%æ¦‚ç‡ä½¿ç”¨æƒé‡ç­–ç•¥
        if (ThreadLocalRandom.current().nextDouble() < weightRatio) {
            return weightedLoadBalancer.choose(request);
        } else {
            // 30%æ¦‚ç‡ä½¿ç”¨å“åº”æ—¶é—´ç­–ç•¥
            return responseTimeLoadBalancer.choose(request);
        }
    }
}
```

### 8.6 è‡ªå®šä¹‰ç­–ç•¥æœ€ä½³å®è·µ


**ğŸ’¡ è®¾è®¡åŸåˆ™**ï¼š

| åŸåˆ™ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| **å•ä¸€èŒè´£** | ä¸€ä¸ªç­–ç•¥åªè§£å†³ä¸€ä¸ªé—®é¢˜ | å“åº”æ—¶é—´ç­–ç•¥åªå…³æ³¨å“åº”æ—¶é—´ |
| **å¯é…ç½®** | ç­–ç•¥å‚æ•°å¯ä»¥å¤–éƒ¨é…ç½® | æƒé‡æ¯”ä¾‹å¯é…ç½® |
| **æœ‰ç›‘æ§** | è®°å½•ç­–ç•¥æ‰§è¡Œæƒ…å†µ | ç»Ÿè®¡æ¯ä¸ªå®ä¾‹è¢«é€‰æ‹©æ¬¡æ•° |
| **æœ‰é™çº§** | å¼‚å¸¸æ—¶æœ‰å¤‡ç”¨æ–¹æ¡ˆ | ä¸»ç­–ç•¥å¤±è´¥æ—¶ç”¨è½®è¯¢ |

**âš ï¸ æ³¨æ„äº‹é¡¹**ï¼š
- é¿å…è¿‡åº¦å¤æ‚ï¼šç­–ç•¥é€»è¾‘ä¸å®œè¿‡äºå¤æ‚ï¼Œå½±å“æ€§èƒ½
- è€ƒè™‘çº¿ç¨‹å®‰å…¨ï¼šå¤šçº¿ç¨‹ç¯å¢ƒä¸‹è¦æ³¨æ„å¹¶å‘é—®é¢˜
- å®šæœŸæ¸…ç†ï¼šç»Ÿè®¡æ•°æ®è¦å®šæœŸæ¸…ç†ï¼Œé¿å…å†…å­˜æ³„æ¼
- ç°åº¦ä¸Šçº¿ï¼šæ–°ç­–ç•¥å…ˆå°æµé‡éªŒè¯

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å„ç­–ç•¥å¯¹æ¯”æ€»è§ˆ


| ç­–ç•¥ç±»å‹ | **æ ¸å¿ƒç‰¹ç‚¹** | **é€‚ç”¨åœºæ™¯** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** |
|---------|------------|------------|---------|---------|
| **è½®è¯¢** | æŒ‰é¡ºåºä¾æ¬¡é€‰æ‹© | æœåŠ¡å™¨æ€§èƒ½ä¸€è‡´ | ç®€å•å…¬å¹³ | ä¸è€ƒè™‘å®æ—¶è´Ÿè½½ |
| **éšæœº** | éšæœºé€‰æ‹©å®ä¾‹ | æ— ç‰¹æ®Šè¦æ±‚åœºæ™¯ | å®ç°ç®€å• | çŸ­æœŸå¯èƒ½ä¸å‡åŒ€ |
| **æƒé‡** | æŒ‰æƒé‡æ¯”ä¾‹åˆ†é… | æ€§èƒ½å·®å¼‚å¤§ | çµæ´»å¯æ§ | éœ€è¦æ‰‹åŠ¨é…ç½® |
| **æœ€å°‘è¿æ¥** | é€‰è¿æ¥æœ€å°‘çš„ | é•¿è¿æ¥æœåŠ¡ | åŠ¨æ€å‡è¡¡ | å®ç°å¤æ‚ |
| **ä¸€è‡´æ€§å“ˆå¸Œ** | åŒç‰¹å¾è·¯ç”±åˆ°åŒå®ä¾‹ | æœ‰çŠ¶æ€æœåŠ¡ | è¯·æ±‚ç¨³å®š | å¯èƒ½è´Ÿè½½ä¸å‡ |

### 9.2 é€‰æ‹©ç­–ç•¥çš„å†³ç­–æ ‘


```
å¼€å§‹é€‰æ‹©è´Ÿè½½å‡è¡¡ç­–ç•¥
        â†“
    æ˜¯å¦æœ‰çŠ¶æ€æœåŠ¡ï¼Ÿ
    â”œâ”€ æ˜¯ â†’ ä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œ
    â””â”€ å¦ â†“
        æœåŠ¡å™¨æ€§èƒ½æ˜¯å¦ä¸€è‡´ï¼Ÿ
        â”œâ”€ æ˜¯ â†“
        â”‚   è¯·æ±‚æ˜¯å¦é•¿è¿æ¥ï¼Ÿ
        â”‚   â”œâ”€ æ˜¯ â†’ ä½¿ç”¨æœ€å°‘è¿æ¥
        â”‚   â””â”€ å¦ â†’ ä½¿ç”¨è½®è¯¢
        â””â”€ å¦ â†“
            æ˜¯å¦èƒ½é…ç½®æƒé‡ï¼Ÿ
            â”œâ”€ æ˜¯ â†’ ä½¿ç”¨æƒé‡ç­–ç•¥
            â””â”€ å¦ â†’ è‡ªå®šä¹‰ç­–ç•¥
```

### 9.3 å®æˆ˜é…ç½®å»ºè®®


**ğŸ”¥ ä¸åŒåœºæ™¯æ¨èé…ç½®**ï¼š

ğŸ“Œ **ç”µå•†ç³»ç»Ÿ**ï¼š
```yaml
è®¢å•æœåŠ¡ï¼šæƒé‡è´Ÿè½½å‡è¡¡ï¼ˆä¸åŒæ€§èƒ½æœåŠ¡å™¨ï¼‰
å•†å“æŸ¥è¯¢ï¼šè½®è¯¢ï¼ˆæ— çŠ¶æ€ï¼Œæ€§èƒ½ä¸€è‡´ï¼‰
ç”¨æˆ·ä¼šè¯ï¼šä¸€è‡´æ€§å“ˆå¸Œï¼ˆsessionä¿æŒï¼‰
```

ğŸ“Œ **ç›´æ’­å¹³å°**ï¼š
```yaml
ç›´æ’­æ¨æµï¼šæœ€å°‘è¿æ¥ï¼ˆé•¿è¿æ¥ä¼˜åŒ–ï¼‰
è§†é¢‘æ‹‰æµï¼šåœ°ç†ä½ç½®ä¼˜å…ˆï¼ˆå‡å°‘å»¶è¿Ÿï¼‰
èŠå¤©æœåŠ¡ï¼šä¸€è‡´æ€§å“ˆå¸Œï¼ˆä¿æŒè¿æ¥ï¼‰
```

ğŸ“Œ **é‡‘èç³»ç»Ÿ**ï¼š
```yaml
äº¤æ˜“æœåŠ¡ï¼šæœ€å°‘è¿æ¥ï¼ˆå®æ—¶è´Ÿè½½å‡è¡¡ï¼‰
æŸ¥è¯¢æœåŠ¡ï¼šè½®è¯¢ï¼ˆæ— çŠ¶æ€æŸ¥è¯¢ï¼‰
é£æ§æœåŠ¡ï¼šå“åº”æ—¶é—´ç­–ç•¥ï¼ˆæ€§èƒ½ä¼˜å…ˆï¼‰
```

### 9.4 ç›‘æ§ä¸ä¼˜åŒ–


**ğŸ“Š å…³é”®ç›‘æ§æŒ‡æ ‡**ï¼š
```
å®ä¾‹ç»´åº¦ï¼š
- è¯·æ±‚åˆ†é…æ¯”ä¾‹ï¼ˆæ˜¯å¦å‡è¡¡ï¼‰
- å¹³å‡å“åº”æ—¶é—´
- é”™è¯¯ç‡ç»Ÿè®¡
- è¿æ¥æ•°ç»Ÿè®¡

ç­–ç•¥ç»´åº¦ï¼š
- ç­–ç•¥æ‰§è¡Œè€—æ—¶
- è´Ÿè½½å‡è¡¡æ•ˆæœè¯„åˆ†
- å¼‚å¸¸æƒ…å†µæ¬¡æ•°
```

**ğŸ”§ ä¼˜åŒ–æŠ€å·§**ï¼š

âœ… **å®šæœŸè¯„ä¼°**ï¼šæ¯æœˆè¯„ä¼°ç­–ç•¥æ•ˆæœï¼Œå¿…è¦æ—¶è°ƒæ•´
âœ… **ç°åº¦åˆ‡æ¢**ï¼šæ›´æ¢ç­–ç•¥æ—¶é€æ­¥åˆ‡æ¢ï¼Œè§‚å¯Ÿæ•ˆæœ
âœ… **A/Bæµ‹è¯•**ï¼šåŒæ—¶è¿è¡Œä¸¤ç§ç­–ç•¥ï¼Œå¯¹æ¯”æ•ˆæœ
âœ… **åº”æ€¥é¢„æ¡ˆ**ï¼šå‡†å¤‡é™çº§ç­–ç•¥ï¼Œå¼‚å¸¸æ—¶å¿«é€Ÿåˆ‡æ¢

### 9.5 å¸¸è§é—®é¢˜è§£ç­”


**â“ é—®é¢˜1ï¼šç­–ç•¥èƒ½å¦åŠ¨æ€åˆ‡æ¢ï¼Ÿ**
```
ç­”ï¼šå¯ä»¥ï¼é€šè¿‡é…ç½®ä¸­å¿ƒåŠ¨æ€ä¸‹å‘ç­–ç•¥é…ç½®
å®ç°ï¼š
@RefreshScope
@Bean
public ReactorLoadBalancer<ServiceInstance> dynamicLoadBalancer() {
    // æ ¹æ®é…ç½®è¿”å›ä¸åŒç­–ç•¥
}
```

**â“ é—®é¢˜2ï¼šå¤šä¸ªç­–ç•¥èƒ½å¦ç»„åˆä½¿ç”¨ï¼Ÿ**
```
ç­”ï¼šå¯ä»¥ï¼å®ç°æ··åˆç­–ç•¥
ç¤ºä¾‹ï¼šå…ˆæŒ‰åœ°ç†ä½ç½®è¿‡æ»¤ï¼Œå†æŒ‰æƒé‡åˆ†é…
```

**â“ é—®é¢˜3ï¼šå¦‚ä½•éªŒè¯ç­–ç•¥ç”Ÿæ•ˆï¼Ÿ**
```
ç­”ï¼šé€šè¿‡æ—¥å¿—å’Œç›‘æ§éªŒè¯
1. æ‰“å°é€‰æ‹©çš„å®ä¾‹ID
2. ç»Ÿè®¡å„å®ä¾‹è¯·æ±‚åˆ†å¸ƒ
3. è§‚å¯Ÿè´Ÿè½½æ˜¯å¦ç¬¦åˆé¢„æœŸ
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
è´Ÿè½½å‡è¡¡é€‰ç­–ç•¥ï¼Œåœºæ™¯éœ€æ±‚è¦åˆ†æ¸…
è½®è¯¢éšæœºæœ€ç®€å•ï¼Œæ— çŠ¶æ€æ—¶ä¼˜å…ˆç”¨
æƒé‡é…ç½®åˆ†é«˜ä½ï¼Œæ€§èƒ½å·®å¼‚å®ƒæ¥å¹³
æœ€å°‘è¿æ¥æŸ¥å®æ—¶ï¼Œé•¿è¿æ¥æ—¶æ•ˆæœå¥½
ä¸€è‡´å“ˆå¸Œä¿è·¯ç”±ï¼Œæœ‰çŠ¶æ€æ—¶ä¸èƒ½ä¸¢
è‡ªå®šä¹‰ç­–ç•¥çµæ´»å¼ºï¼Œå¤æ‚éœ€æ±‚å®ƒæ¥æ‰›
```