---
title: 3ã€è¶…æ—¶æ§åˆ¶é…ç½®
---
## ğŸ“š ç›®å½•

1. [è¶…æ—¶æ§åˆ¶åŸºæœ¬æ¦‚å¿µ](#1-è¶…æ—¶æ§åˆ¶åŸºæœ¬æ¦‚å¿µ)
2. [è¿æ¥è¶…æ—¶é…ç½®](#2-è¿æ¥è¶…æ—¶é…ç½®)
3. [è¯»å–è¶…æ—¶é…ç½®](#3-è¯»å–è¶…æ—¶é…ç½®)
4. [å“åº”è¶…æ—¶é…ç½®](#4-å“åº”è¶…æ—¶é…ç½®)
5. [å…¨å±€è¶…æ—¶è®¾ç½®](#5-å…¨å±€è¶…æ—¶è®¾ç½®)
6. [è¶…æ—¶å¼‚å¸¸å¤„ç†](#6-è¶…æ—¶å¼‚å¸¸å¤„ç†)
7. [è¶…æ—¶ç›‘æ§å‘Šè­¦](#7-è¶…æ—¶ç›‘æ§å‘Šè­¦)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ• è¶…æ—¶æ§åˆ¶åŸºæœ¬æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯è¶…æ—¶æ§åˆ¶


**é€šä¿—ç†è§£**ï¼šæƒ³è±¡ä½ åœ¨é¤å…ç‚¹é¤ï¼Œå¦‚æœå¨å¸ˆ30åˆ†é’Ÿè¿˜æ²¡ä¸Šèœï¼Œä½ å°±ä¸ç­‰äº†ç›´æ¥èµ°äººã€‚ç½‘å…³çš„è¶…æ—¶æ§åˆ¶å°±æ˜¯è¿™ä¸ªé“ç†â€”â€”å¦‚æœåç«¯æœåŠ¡åœ¨è§„å®šæ—¶é—´å†…æ²¡æœ‰å“åº”ï¼Œç½‘å…³å°±ä¸å†ç­‰å¾…ï¼Œç›´æ¥è¿”å›é”™è¯¯ã€‚

```
ç”¨æˆ·è¯·æ±‚ â†’ ç½‘å…³ â†’ åç«¯æœåŠ¡
         â†“
    è®¾å®šç­‰å¾…æ—¶é—´
         â†“
    è¶…æ—¶ï¼Ÿè¿”å›é”™è¯¯ï¼
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦è¶…æ—¶æ§åˆ¶


**æ ¸å¿ƒä½œç”¨**ï¼š
- ğŸ›¡ï¸ **ä¿æŠ¤ç½‘å…³**ï¼šé˜²æ­¢è¯·æ±‚é•¿æ—¶é—´å ç”¨èµ„æºï¼Œé¿å…ç½‘å…³è¢«æ‹–å®
- âš¡ **æå‡ç”¨æˆ·ä½“éªŒ**ï¼šä¸å…¶æ— é™ç­‰å¾…ï¼Œä¸å¦‚å¿«é€Ÿå¤±è´¥è®©ç”¨æˆ·çŸ¥é“é—®é¢˜
- ğŸ”„ **å¿«é€Ÿå¤±è´¥æœºåˆ¶**ï¼šå°½æ—©å‘ç°é—®é¢˜ï¼Œè§¦å‘é™çº§æˆ–é‡è¯•ç­–ç•¥
- ğŸ“Š **èµ„æºåˆç†åˆ†é…**ï¼šé‡Šæ”¾è¢«é˜»å¡çš„èµ„æºï¼ŒæœåŠ¡å…¶ä»–è¯·æ±‚

**å®é™…åœºæ™¯**ï¼š
```
âŒ æ²¡æœ‰è¶…æ—¶æ§åˆ¶ï¼š
ç”¨æˆ·è¯·æ±‚ â†’ ç­‰å¾…...ç­‰å¾…...ï¼ˆå¯èƒ½æ°¸ä¹…ç­‰å¾…ï¼‰â†’ ç½‘å…³èµ„æºè€—å°½ â†’ æ•´ä¸ªç³»ç»Ÿç˜«ç—ª

âœ… æœ‰è¶…æ—¶æ§åˆ¶ï¼š
ç”¨æˆ·è¯·æ±‚ â†’ ç­‰å¾…3ç§’ â†’ è¶…æ—¶è¿”å› â†’ èµ„æºé‡Šæ”¾ â†’ ç³»ç»Ÿç¨³å®šè¿è¡Œ
```

### 1.3 è¶…æ—¶çš„ä¸‰ä¸ªå…³é”®æ—¶åˆ»


```
å®¢æˆ·ç«¯ â”€â”€â‘ è¿æ¥è¶…æ—¶â”€â”€> ç½‘å…³ â”€â”€â‘¡è¯»å–è¶…æ—¶â”€â”€> åç«¯æœåŠ¡
                             â†“
                         â‘¢å“åº”è¶…æ—¶
                             â†“
                          è¿”å›å®¢æˆ·ç«¯

â‘  è¿æ¥è¶…æ—¶ï¼šå»ºç«‹è¿æ¥çš„æ—¶é—´é™åˆ¶ï¼ˆæ¡æ‰‹é˜¶æ®µï¼‰
â‘¡ è¯»å–è¶…æ—¶ï¼šç­‰å¾…åç«¯è¿”å›æ•°æ®çš„æ—¶é—´ï¼ˆæ•°æ®ä¼ è¾“ï¼‰
â‘¢ å“åº”è¶…æ—¶ï¼šæ•´ä¸ªè¯·æ±‚çš„æ€»æ—¶é—´é™åˆ¶ï¼ˆç«¯åˆ°ç«¯ï¼‰
```

**æ—¶é—´å…³ç³»**ï¼š
- **è¿æ¥è¶…æ—¶** < **è¯»å–è¶…æ—¶** < **å“åº”è¶…æ—¶**
- æ¨èæ¯”ä¾‹ï¼š`1 : 3 : 5`ï¼ˆä¾‹å¦‚ï¼š2ç§’ã€6ç§’ã€10ç§’ï¼‰

---

## 2. ğŸ”Œ è¿æ¥è¶…æ—¶é…ç½®


### 2.1 è¿æ¥è¶…æ—¶æ˜¯ä»€ä¹ˆ


**é€šä¿—è§£é‡Š**ï¼šå°±åƒæ‰“ç”µè¯ï¼Œæ‹¨å·åå¯¹æ–¹éœ€è¦ä¸€å®šæ—¶é—´æ¥é€šã€‚è¿æ¥è¶…æ—¶å°±æ˜¯ä½ æ„¿æ„ç­‰å¾…"æ¥é€š"çš„æœ€é•¿æ—¶é—´ã€‚

```
ç½‘å…³ â”€ å‘èµ·è¿æ¥ â”€â”€â”
               â±ï¸ ç­‰å¾…æ¡æ‰‹
åç«¯ â”€ æ¥å—è¿æ¥ â”€â”€â”˜

å¦‚æœè¿™ä¸ªè¿‡ç¨‹è¶…è¿‡è®¾å®šæ—¶é—´ â†’ è¿æ¥è¶…æ—¶
```

### 2.2 Spring Cloud Gateway è¿æ¥è¶…æ—¶é…ç½®


**é…ç½®æ–¹å¼ä¸€ï¼šå…¨å±€é…ç½®ï¼ˆapplication.ymlï¼‰**

```yaml
spring:
  cloud:
    gateway:
      httpclient:
        # è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
        connect-timeout: 2000  # 2ç§’
        
        # è¿æ¥æ± é…ç½®
        pool:
          max-connections: 500    # æœ€å¤§è¿æ¥æ•°
          max-idle-time: 30000   # ç©ºé—²è¿æ¥å­˜æ´»æ—¶é—´
```

**é…ç½®æ–¹å¼äºŒï¼šè·¯ç”±çº§åˆ«é…ç½®**

```yaml
spring:
  cloud:
    gateway:
      routes:
        - id: user-service
          uri: lb://user-service
          predicates:
            - Path=/user/**
          metadata:
            # å•ç‹¬ä¸ºè¯¥è·¯ç”±è®¾ç½®è¿æ¥è¶…æ—¶
            connect-timeout: 3000  # 3ç§’
```

### 2.3 è¿æ¥è¶…æ—¶çš„å®é™…å½±å“


| è¶…æ—¶æ—¶é—´ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|---------|---------|------|------|
| `1-2ç§’` | `å†…ç½‘æœåŠ¡` | `å¿«é€Ÿå¤±è´¥ï¼Œèµ„æºé‡Šæ”¾å¿«` | `ç½‘ç»œæ³¢åŠ¨æ—¶è¯¯åˆ¤å¤š` |
| `3-5ç§’` | `ä¸€èˆ¬ä¸šåŠ¡` | `å¹³è¡¡æ€§èƒ½ä¸å®¹é”™` | `ç­‰å¾…æ—¶é—´ç¨é•¿` |
| `>5ç§’` | `å¤§æ–‡ä»¶ä¼ è¾“` | `å®¹é”™æ€§é«˜` | `èµ„æºå ç”¨æ—¶é—´é•¿` |

**ç»éªŒå€¼**ï¼š
- å†…ç½‘å¾®æœåŠ¡ä¹‹é—´ï¼š`1-2ç§’`
- è°ƒç”¨ç¬¬ä¸‰æ–¹æœåŠ¡ï¼š`3-5ç§’`
- ç‰¹æ®Šåœºæ™¯ï¼ˆæ–‡ä»¶ä¸Šä¼ ç­‰ï¼‰ï¼š`10ç§’ä»¥ä¸Š`

---

## 3. ğŸ“– è¯»å–è¶…æ—¶é…ç½®


### 3.1 è¯»å–è¶…æ—¶çš„å«ä¹‰


**é€šä¿—ç†è§£**ï¼šè¿æ¥å»ºç«‹åï¼Œå°±åƒæ”¶å¿«é€’ï¼Œå¿«é€’å‘˜å·²ç»åˆ°é—¨å£äº†ï¼ˆè¿æ¥æˆåŠŸï¼‰ï¼Œä½†ä»–ä»è½¦ä¸Šæ¬è´§ç‰©éœ€è¦æ—¶é—´ï¼ˆè¯»å–æ•°æ®ï¼‰ã€‚è¯»å–è¶…æ—¶å°±æ˜¯ä½ æ„¿æ„ç­‰ä»–æ¬è´§çš„æœ€é•¿æ—¶é—´ã€‚

```
è¿æ¥å·²å»ºç«‹ âœ“
     â†“
ç½‘å…³ç­‰å¾…åç«¯è¿”å›æ•°æ®
     â†“
â±ï¸ è¯»å–è¶…æ—¶æ—¶é—´
     â†“
è¶…æ—¶ï¼Ÿä¸­æ–­è¿æ¥ï¼
```

### 3.2 è¯»å–è¶…æ—¶é…ç½®æ–¹æ³•


**å…¨å±€è¯»å–è¶…æ—¶é…ç½®**ï¼š

```yaml
spring:
  cloud:
    gateway:
      httpclient:
        # å“åº”è¶…æ—¶ï¼ˆå³è¯»å–è¶…æ—¶ï¼‰
        response-timeout: 5000  # 5ç§’
```

**è·¯ç”±çº§åˆ«è¯»å–è¶…æ—¶**ï¼š

```yaml
spring:
  cloud:
    gateway:
      routes:
        - id: order-service
          uri: lb://order-service
          predicates:
            - Path=/order/**
          metadata:
            response-timeout: 8000  # 8ç§’ï¼ˆè®¢å•æœåŠ¡å¤„ç†æ…¢ï¼Œç»™æ›´å¤šæ—¶é—´ï¼‰
```

**Javaä»£ç åŠ¨æ€é…ç½®**ï¼š

```java
@Configuration
public class GatewayConfig {
    
    @Bean
    public RouteLocator customRouteLocator(RouteLocatorBuilder builder) {
        return builder.routes()
            .route("slow-service", r -> r
                .path("/slow/**")
                .filters(f -> f
                    // åŠ¨æ€è®¾ç½®è¯»å–è¶…æ—¶ä¸º10ç§’
                    .setResponseTimeout(Duration.ofSeconds(10))
                )
                .uri("lb://slow-service")
            )
            .build();
    }
}
```

### 3.3 è¯»å–è¶…æ—¶çš„å¸¸è§é—®é¢˜


**é—®é¢˜1ï¼šè¯»å–è¶…æ—¶ vs è¿æ¥è¶…æ—¶çš„åŒºåˆ«**

```
è¿æ¥è¶…æ—¶ï¼šè¿˜æ²¡å»ºç«‹è¿æ¥å°±æ”¾å¼ƒäº†ï¼ˆå»ºç«‹è¿æ¥é˜¶æ®µï¼‰
è¯»å–è¶…æ—¶ï¼šè¿æ¥å»ºç«‹äº†ï¼Œä½†æ•°æ®æ²¡å›æ¥ï¼ˆæ•°æ®ä¼ è¾“é˜¶æ®µï¼‰

å®é™…æ¡ˆä¾‹ï¼š
åœºæ™¯ï¼šè°ƒç”¨ç”¨æˆ·æœåŠ¡è·å–ç”¨æˆ·ä¿¡æ¯
- è¿æ¥è¶…æ—¶2ç§’ï¼šå¦‚æœ2ç§’å†…è¿ä¸ä¸Šç”¨æˆ·æœåŠ¡ â†’ å¤±è´¥
- è¯»å–è¶…æ—¶5ç§’ï¼šè¿ä¸Šäº†ï¼Œä½†5ç§’å†…æ²¡è¿”å›æ•°æ® â†’ å¤±è´¥
```

**é—®é¢˜2ï¼šå¦‚ä½•è®¾ç½®åˆç†çš„è¯»å–è¶…æ—¶**

```
ğŸ”¸ åˆ†ææœåŠ¡å“åº”æ—¶é—´ï¼š
- æŸ¥çœ‹å†å²æ•°æ®ï¼šP99å“åº”æ—¶é—´æ˜¯å¤šå°‘
- è®¡ç®—å…¬å¼ï¼šè¯»å–è¶…æ—¶ = P99å“åº”æ—¶é—´ Ã— 1.5

ğŸ”¸ ç¤ºä¾‹è®¡ç®—ï¼š
å‡è®¾ç”¨æˆ·æœåŠ¡P99å“åº”æ—¶é—´ä¸º3ç§’
æ¨èè¯»å–è¶…æ—¶ = 3 Ã— 1.5 = 4.5ç§’ï¼ˆè®¾ç½®ä¸º5ç§’ï¼‰
```

---

## 4. â±ï¸ å“åº”è¶…æ—¶é…ç½®


### 4.1 å“åº”è¶…æ—¶çš„å®Œæ•´å«ä¹‰


**æœ¬è´¨ç†è§£**ï¼šå“åº”è¶…æ—¶æ˜¯**ç«¯åˆ°ç«¯çš„æ€»æ—¶é—´é™åˆ¶**ï¼ŒåŒ…å«äº†è¿æ¥å»ºç«‹ã€æ•°æ®ä¼ è¾“ã€ä¸šåŠ¡å¤„ç†çš„å…¨è¿‡ç¨‹ã€‚

```
ç”¨æˆ·å‘èµ·è¯·æ±‚
    â†“
â±ï¸ å“åº”è¶…æ—¶è®¡æ—¶å¼€å§‹
    â†“
ç½‘å…³è¿æ¥åç«¯ï¼ˆæ¶ˆè€—ï¼šè¿æ¥è¶…æ—¶æ—¶é—´ï¼‰
    â†“
åç«¯å¤„ç†ä¸šåŠ¡ï¼ˆæ¶ˆè€—ï¼šå¤„ç†æ—¶é—´ï¼‰
    â†“
ç½‘å…³è¯»å–å“åº”ï¼ˆæ¶ˆè€—ï¼šè¯»å–è¶…æ—¶æ—¶é—´ï¼‰
    â†“
â±ï¸ å“åº”è¶…æ—¶è®¡æ—¶ç»“æŸ
    â†“
è¿”å›ç»™ç”¨æˆ·

æ€»è€—æ—¶è¶…è¿‡å“åº”è¶…æ—¶ â†’ è¯·æ±‚å¤±è´¥
```

### 4.2 å“åº”è¶…æ—¶é…ç½®å®æˆ˜


**é…ç½®å±‚çº§å…³ç³»**ï¼š

```yaml
spring:
  cloud:
    gateway:
      # ã€å±‚çº§1ã€‘å…¨å±€é»˜è®¤å“åº”è¶…æ—¶
      httpclient:
        response-timeout: 10000  # 10ç§’
      
      routes:
        # ã€å±‚çº§2ã€‘è·¯ç”±çº§åˆ«è¶…æ—¶ï¼ˆè¦†ç›–å…¨å±€ï¼‰
        - id: payment-service
          uri: lb://payment-service
          predicates:
            - Path=/payment/**
          metadata:
            response-timeout: 30000  # æ”¯ä»˜æ¥å£30ç§’
        
        # ã€å±‚çº§3ã€‘è¿‡æ»¤å™¨çº§åˆ«è¶…æ—¶ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
        - id: report-service
          uri: lb://report-service
          predicates:
            - Path=/report/**
          filters:
            - name: SetResponseTimeout
              args:
                timeout: 60000  # æŠ¥è¡¨ç”Ÿæˆ60ç§’
```

**ä¼˜å…ˆçº§è§„åˆ™**ï¼š
```
è¿‡æ»¤å™¨çº§åˆ« > è·¯ç”±çº§åˆ« > å…¨å±€é…ç½®

å®é™…ç”Ÿæ•ˆï¼š
/payment/** â†’ 30ç§’ï¼ˆè·¯ç”±çº§åˆ«è¦†ç›–å…¨å±€10ç§’ï¼‰
/report/**  â†’ 60ç§’ï¼ˆè¿‡æ»¤å™¨è¦†ç›–å…¨å±€10ç§’ï¼‰
å…¶ä»–è·¯å¾„   â†’ 10ç§’ï¼ˆä½¿ç”¨å…¨å±€é…ç½®ï¼‰
```

### 4.3 ä¸åŒä¸šåŠ¡åœºæ™¯çš„è¶…æ—¶è®¾ç½®


| ä¸šåŠ¡ç±»å‹ | **æ¨èè¶…æ—¶** | **ç†ç”±** | **ç¤ºä¾‹** |
|---------|------------|---------|---------|
| ğŸ” æŸ¥è¯¢æ¥å£ | `3-5ç§’` | `å¿«é€Ÿå“åº”ï¼Œé¿å…ç”¨æˆ·ç­‰å¾…` | `ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢` |
| ğŸ’° æ”¯ä»˜æ¥å£ | `30-60ç§’` | `æ¶‰åŠèµ„é‡‘ï¼Œéœ€è¦æ›´å¤šæ—¶é—´ç¡®è®¤` | `è®¢å•æ”¯ä»˜` |
| ğŸ“Š æŠ¥è¡¨ç”Ÿæˆ | `60-120ç§’` | `æ•°æ®è®¡ç®—é‡å¤§ï¼Œéœ€è¦å……è¶³æ—¶é—´` | `æœˆåº¦é”€å”®æŠ¥è¡¨` |
| ğŸ“ æ–‡ä»¶ä¸Šä¼  | `120-300ç§’` | `æ–‡ä»¶å¤§å°ä¸å®šï¼Œé¢„ç•™è¶³å¤Ÿæ—¶é—´` | `å›¾ç‰‡/æ–‡æ¡£ä¸Šä¼ ` |
| ğŸ”„ æ‰¹é‡æ“ä½œ | `60-180ç§’` | `æ‰¹é‡å¤„ç†è€—æ—¶ï¼Œä½†ä¸èƒ½æ— é™ç­‰å¾…` | `æ‰¹é‡å¯¼å…¥æ•°æ®` |

---

## 5. ğŸŒ å…¨å±€è¶…æ—¶è®¾ç½®


### 5.1 å…¨å±€è¶…æ—¶çš„é…ç½®ç­–ç•¥


**å®Œæ•´çš„å…¨å±€è¶…æ—¶é…ç½®**ï¼š

```yaml
spring:
  cloud:
    gateway:
      httpclient:
        # â”€â”€â”€â”€â”€â”€â”€â”€ è¿æ¥ç›¸å…³è¶…æ—¶ â”€â”€â”€â”€â”€â”€â”€â”€
        connect-timeout: 3000        # è¿æ¥è¶…æ—¶3ç§’
        
        # â”€â”€â”€â”€â”€â”€â”€â”€ å“åº”ç›¸å…³è¶…æ—¶ â”€â”€â”€â”€â”€â”€â”€â”€
        response-timeout: 10000      # é»˜è®¤å“åº”è¶…æ—¶10ç§’
        
        # â”€â”€â”€â”€â”€â”€â”€â”€ è¿æ¥æ± é…ç½® â”€â”€â”€â”€â”€â”€â”€â”€
        pool:
          type: elastic              # å¼¹æ€§è¿æ¥æ± 
          max-connections: 1000      # æœ€å¤§è¿æ¥æ•°
          max-idle-time: 30000       # ç©ºé—²è¿æ¥30ç§’åå…³é—­
          max-life-time: 60000       # è¿æ¥æœ€å¤§å­˜æ´»æ—¶é—´60ç§’
          eviction-interval: 5000    # æ¯5ç§’æ¸…ç†ä¸€æ¬¡ç©ºé—²è¿æ¥

      # â”€â”€â”€â”€â”€â”€â”€â”€ å…¨å±€é»˜è®¤è¿‡æ»¤å™¨ â”€â”€â”€â”€â”€â”€â”€â”€
      default-filters:
        - name: SetResponseTimeout
          args:
            timeout: 10000           # å…¨å±€å“åº”è¶…æ—¶10ç§’
```

### 5.2 å…¨å±€è¶…æ—¶çš„è¦†ç›–æœºåˆ¶


**è¦†ç›–ä¼˜å…ˆçº§ï¼ˆä»é«˜åˆ°ä½ï¼‰**ï¼š

```
ç¬¬1ä¼˜å…ˆçº§ï¼šè·¯ç”±è¿‡æ»¤å™¨è¶…æ—¶
    â†“
ç¬¬2ä¼˜å…ˆçº§ï¼šè·¯ç”±metadataè¶…æ—¶
    â†“
ç¬¬3ä¼˜å…ˆçº§ï¼šå…¨å±€default-filtersè¶…æ—¶
    â†“
ç¬¬4ä¼˜å…ˆçº§ï¼šhttpclienté…ç½®è¶…æ—¶
```

**å®æˆ˜æ¡ˆä¾‹**ï¼š

```yaml
spring:
  cloud:
    gateway:
      httpclient:
        response-timeout: 5000    # å…¨å±€5ç§’
      
      default-filters:
        - name: SetResponseTimeout
          args:
            timeout: 8000          # é»˜è®¤è¿‡æ»¤å™¨8ç§’ï¼ˆè¦†ç›–5ç§’ï¼‰
      
      routes:
        - id: service-a
          uri: lb://service-a
          predicates:
            - Path=/api/a/**
          # æ­¤è·¯ç”±å®é™…ç”Ÿæ•ˆï¼š8ç§’ï¼ˆä½¿ç”¨default-filtersï¼‰
        
        - id: service-b
          uri: lb://service-b
          predicates:
            - Path=/api/b/**
          metadata:
            response-timeout: 15000  # è·¯ç”±çº§15ç§’ï¼ˆè¦†ç›–8ç§’ï¼‰
          # æ­¤è·¯ç”±å®é™…ç”Ÿæ•ˆï¼š15ç§’
```

### 5.3 è¶…æ—¶é…ç½®çš„æœ€ä½³å®è·µ


**ğŸ”¸ æ¨èé…ç½®æ€è·¯**ï¼š

```
æ­¥éª¤ â‘  è®¾ç½®ä¿å®ˆçš„å…¨å±€è¶…æ—¶ï¼ˆåŸºå‡†çº¿ï¼‰
      â†“ 
      å…¨å±€ï¼š10ç§’ï¼ˆæ»¡è¶³80%çš„æ¥å£éœ€æ±‚ï¼‰
      
æ­¥éª¤ â‘¡ é’ˆå¯¹æ…¢æ¥å£å•ç‹¬è°ƒæ•´
      â†“
      æ”¯ä»˜æ¥å£ï¼š30ç§’
      æŠ¥è¡¨æ¥å£ï¼š60ç§’
      
æ­¥éª¤ â‘¢ é’ˆå¯¹å¿«æ¥å£ä¼˜åŒ–
      â†“
      å¥åº·æ£€æŸ¥ï¼š2ç§’
      ç¼“å­˜æŸ¥è¯¢ï¼š3ç§’

åŸåˆ™ï¼šä»ä¸¥åˆ°å®½ï¼Œé€æ­¥ä¼˜åŒ–
```

**âš ï¸ å¸¸è§é…ç½®é”™è¯¯**ï¼š

```
âŒ é”™è¯¯1ï¼šå…¨å±€è¶…æ—¶å¤ªçŸ­
spring.cloud.gateway.httpclient.response-timeout: 1000  # 1ç§’å¤ªæ¿€è¿›

âœ… æ­£ç¡®ï¼š
spring.cloud.gateway.httpclient.response-timeout: 10000  # 10ç§’æ›´åˆç†

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

âŒ é”™è¯¯2ï¼šæ‰€æœ‰æ¥å£ç”¨ç›¸åŒè¶…æ—¶
/user/**     â†’ 10ç§’
/payment/**  â†’ 10ç§’  # æ”¯ä»˜åº”è¯¥æ›´é•¿
/report/**   â†’ 10ç§’  # æŠ¥è¡¨åº”è¯¥æ›´é•¿

âœ… æ­£ç¡®ï¼šå·®å¼‚åŒ–é…ç½®
/user/**     â†’ 5ç§’
/payment/**  â†’ 30ç§’
/report/**   â†’ 60ç§’
```

---

## 6. ğŸš¨ è¶…æ—¶å¼‚å¸¸å¤„ç†


### 6.1 è¶…æ—¶å¼‚å¸¸çš„ç±»å‹


**å¸¸è§è¶…æ—¶å¼‚å¸¸**ï¼š

```java
// è¿æ¥è¶…æ—¶å¼‚å¸¸
ConnectTimeoutException
â†’ å«ä¹‰ï¼šæ— æ³•åœ¨è§„å®šæ—¶é—´å†…è¿æ¥åˆ°åç«¯æœåŠ¡
â†’ åŸå› ï¼šç½‘ç»œé—®é¢˜ã€æœåŠ¡å®•æœºã€é˜²ç«å¢™æ‹¦æˆª

// è¯»å–è¶…æ—¶å¼‚å¸¸  
ReadTimeoutException
â†’ å«ä¹‰ï¼šè¿æ¥æˆåŠŸä½†æœªèƒ½åŠæ—¶è¯»å–åˆ°å“åº”æ•°æ®
â†’ åŸå› ï¼šåç«¯å¤„ç†æ…¢ã€ç½‘ç»œä¼ è¾“æ…¢

// å“åº”è¶…æ—¶å¼‚å¸¸
TimeoutException
â†’ å«ä¹‰ï¼šæ•´ä¸ªè¯·æ±‚å¤„ç†æ—¶é—´è¶…è¿‡é™åˆ¶
â†’ åŸå› ï¼šä¸šåŠ¡é€»è¾‘å¤æ‚ã€æ•°æ®é‡å¤§
```

### 6.2 å…¨å±€å¼‚å¸¸å¤„ç†å™¨


**åˆ›å»ºç»Ÿä¸€å¼‚å¸¸å¤„ç†**ï¼š

```java
@Component
@Order(-1)  // ä¼˜å…ˆçº§æœ€é«˜
public class GlobalTimeoutExceptionHandler implements ErrorWebExceptionHandler {
    
    @Override
    public Mono<Void> handle(ServerWebExchange exchange, Throwable ex) {
        ServerHttpResponse response = exchange.getResponse();
        
        // è®¾ç½®å“åº”å¤´
        response.getHeaders().setContentType(MediaType.APPLICATION_JSON);
        
        // æ ¹æ®å¼‚å¸¸ç±»å‹è¿”å›ä¸åŒä¿¡æ¯
        if (ex instanceof TimeoutException || 
            ex instanceof ReadTimeoutException) {
            
            // è¶…æ—¶é”™è¯¯å“åº”
            String errorMsg = """
                {
                  "code": 504,
                  "message": "æœåŠ¡å“åº”è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•",
                  "timestamp": "%s"
                }
                """.formatted(LocalDateTime.now());
            
            response.setStatusCode(HttpStatus.GATEWAY_TIMEOUT);
            return response.writeWith(Mono.just(
                response.bufferFactory().wrap(errorMsg.getBytes())
            ));
        }
        
        // å…¶ä»–å¼‚å¸¸å¤„ç†
        return Mono.error(ex);
    }
}
```

### 6.3 è¶…æ—¶é™çº§ç­–ç•¥


**ä½¿ç”¨ Hystrix/Resilience4j é™çº§**ï¼š

```yaml
# application.yml
spring:
  cloud:
    gateway:
      routes:
        - id: user-service
          uri: lb://user-service
          predicates:
            - Path=/user/**
          filters:
            # æ·»åŠ ç†”æ–­é™çº§
            - name: CircuitBreaker
              args:
                name: userServiceCircuitBreaker
                fallbackUri: forward:/fallback/user
          metadata:
            response-timeout: 5000
```

**é™çº§å¤„ç†æ§åˆ¶å™¨**ï¼š

```java
@RestController
@RequestMapping("/fallback")
public class FallbackController {
    
    // ç”¨æˆ·æœåŠ¡é™çº§å¤„ç†
    @GetMapping("/user")
    public Map<String, Object> userFallback() {
        return Map.of(
            "code", 503,
            "message", "ç”¨æˆ·æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œå·²å¯ç”¨é™çº§ç­–ç•¥",
            "data", Map.of(
                "userId", "default-user",
                "userName", "è®¿å®¢"
            )
        );
    }
}
```

### 6.4 è¶…æ—¶é‡è¯•æœºåˆ¶


**é…ç½®é‡è¯•ç­–ç•¥**ï¼š

```yaml
spring:
  cloud:
    gateway:
      routes:
        - id: order-service
          uri: lb://order-service
          predicates:
            - Path=/order/**
          filters:
            # è¶…æ—¶åè‡ªåŠ¨é‡è¯•
            - name: Retry
              args:
                retries: 3              # æœ€å¤šé‡è¯•3æ¬¡
                statuses: BAD_GATEWAY   # é‡åˆ°502é‡è¯•
                methods: GET            # åªå¯¹GETè¯·æ±‚é‡è¯•
                backoff:
                  firstBackoff: 100ms   # ç¬¬ä¸€æ¬¡é‡è¯•å»¶è¿Ÿ100ms
                  maxBackoff: 500ms     # æœ€å¤§å»¶è¿Ÿ500ms
                  factor: 2             # å»¶è¿Ÿå€æ•°
```

**é‡è¯•é€»è¾‘è¯´æ˜**ï¼š

```
ç¬¬1æ¬¡è¯·æ±‚å¤±è´¥ï¼ˆè¶…æ—¶ï¼‰
    â†“
â±ï¸ ç­‰å¾…100ms
    â†“
ç¬¬2æ¬¡é‡è¯•
    â†“ å¤±è´¥
â±ï¸ ç­‰å¾…200msï¼ˆ100ms Ã— 2ï¼‰
    â†“
ç¬¬3æ¬¡é‡è¯•
    â†“ å¤±è´¥
â±ï¸ ç­‰å¾…400msï¼ˆ200ms Ã— 2ï¼‰
    â†“
ç¬¬4æ¬¡é‡è¯•ï¼ˆæœ€åä¸€æ¬¡ï¼‰
    â†“
ä»å¤±è´¥ â†’ è¿”å›é”™è¯¯
```

---

## 7. ğŸ“Š è¶…æ—¶ç›‘æ§å‘Šè­¦


### 7.1 ç›‘æ§æŒ‡æ ‡é…ç½®


**æš´éœ²è¶…æ—¶ç›¸å…³æŒ‡æ ‡**ï¼š

```yaml
# application.yml
management:
  endpoints:
    web:
      exposure:
        include: '*'  # æš´éœ²æ‰€æœ‰ç›‘æ§ç«¯ç‚¹
  metrics:
    tags:
      application: ${spring.application.name}
    export:
      prometheus:
        enabled: true  # å¯ç”¨Prometheusç›‘æ§
```

### 7.2 å…³é”®ç›‘æ§æŒ‡æ ‡


**æ ¸å¿ƒç›‘æ§ç»´åº¦**ï¼š

| æŒ‡æ ‡åç§° | **æŒ‡æ ‡å«ä¹‰** | **å‘Šè­¦é˜ˆå€¼** | **å¤„ç†æªæ–½** |
|---------|------------|------------|------------|
| `gateway_requests_timeout_total` | `è¶…æ—¶è¯·æ±‚æ€»æ•°` | `> 100æ¬¡/åˆ†é’Ÿ` | `æ£€æŸ¥åç«¯æœåŠ¡å¥åº·çŠ¶æ€` |
| `gateway_timeout_rate` | `è¶…æ—¶ç‡ï¼ˆ%ï¼‰` | `> 5%` | `è°ƒæ•´è¶…æ—¶é…ç½®æˆ–æ‰©å®¹` |
| `gateway_response_time_p99` | `P99å“åº”æ—¶é—´` | `> è¶…æ—¶é˜ˆå€¼çš„80%` | `é¢„è­¦ï¼Œå‡†å¤‡æ‰©å®¹` |
| `gateway_active_connections` | `æ´»è·ƒè¿æ¥æ•°` | `> æœ€å¤§è¿æ¥æ•°çš„70%` | `å¢åŠ è¿æ¥æ± å¤§å°` |

### 7.3 è‡ªå®šä¹‰è¶…æ—¶ç›‘æ§


**è®°å½•è¶…æ—¶æ—¥å¿—**ï¼š

```java
@Component
public class TimeoutMetricsFilter implements GlobalFilter, Ordered {
    
    private final MeterRegistry meterRegistry;
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        long startTime = System.currentTimeMillis();
        String routeId = getRouteId(exchange);
        
        return chain.filter(exchange)
            .doOnError(ex -> {
                if (ex instanceof TimeoutException) {
                    // è®°å½•è¶…æ—¶æŒ‡æ ‡
                    meterRegistry.counter(
                        "gateway.timeout",
                        "route", routeId,
                        "type", "response"
                    ).increment();
                    
                    // è®°å½•è¶…æ—¶æ—¥å¿—
                    long duration = System.currentTimeMillis() - startTime;
                    log.warn("è·¯ç”±[{}]å‘ç”Ÿè¶…æ—¶ï¼Œè€—æ—¶:{}ms", routeId, duration);
                }
            });
    }
    
    @Override
    public int getOrder() {
        return -100;
    }
}
```

### 7.4 å‘Šè­¦è§„åˆ™é…ç½®


**Prometheuså‘Šè­¦è§„åˆ™ç¤ºä¾‹**ï¼š

```yaml
# prometheus-rules.yml
groups:
  - name: gateway_timeout_alerts
    interval: 30s
    rules:
      # è§„åˆ™1ï¼šè¶…æ—¶ç‡è¿‡é«˜
      - alert: HighTimeoutRate
        expr: |
          (sum(rate(gateway_requests_timeout_total[5m])) / 
           sum(rate(gateway_requests_total[5m]))) > 0.05
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "ç½‘å…³è¶…æ—¶ç‡è¿‡é«˜"
          description: "è¶…æ—¶ç‡è¾¾åˆ° {{ $value }}%ï¼Œè¶…è¿‡5%é˜ˆå€¼"
      
      # è§„åˆ™2ï¼šè¿ç»­è¶…æ—¶
      - alert: ContinuousTimeout
        expr: |
          increase(gateway_requests_timeout_total[1m]) > 50
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "ç½‘å…³è¿ç»­è¶…æ—¶"
          description: "1åˆ†é’Ÿå†…è¶…æ—¶{{ $value }}æ¬¡ï¼Œè¯·ç«‹å³æ£€æŸ¥"
```

### 7.5 è¶…æ—¶åˆ†æçœ‹æ¿


**å…³é”®æŒ‡æ ‡å¯è§†åŒ–**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ è¶…æ—¶ç›‘æ§çœ‹æ¿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    â”‚
â”‚  ğŸ“Š å®æ—¶è¶…æ—¶ç‡ï¼š2.3%               â”‚
â”‚  â±ï¸ å¹³å‡å“åº”æ—¶é—´ï¼š450ms            â”‚
â”‚  ğŸ”¥ è¶…æ—¶æœ€å¤šçš„è·¯ç”±ï¼š                â”‚
â”‚     1. /report/** (15æ¬¡/åˆ†é’Ÿ)      â”‚
â”‚     2. /payment/** (8æ¬¡/åˆ†é’Ÿ)      â”‚
â”‚                                    â”‚
â”‚  ğŸ“ˆ è¶…æ—¶è¶‹åŠ¿å›¾ï¼š                    â”‚
â”‚     12:00  â–ˆ                       â”‚
â”‚     12:05  â–ˆâ–ˆ                      â”‚
â”‚     12:10  â–ˆâ–ˆâ–ˆâ–ˆ  â† æµé‡é«˜å³°        â”‚
â”‚     12:15  â–ˆâ–ˆ                      â”‚
â”‚                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ ä¸‰ç§è¶…æ—¶ç±»å‹ï¼š
   â€¢ è¿æ¥è¶…æ—¶ï¼šå»ºç«‹è¿æ¥çš„æ—¶é—´é™åˆ¶ï¼ˆ1-3ç§’ï¼‰
   â€¢ è¯»å–è¶…æ—¶ï¼šç­‰å¾…æ•°æ®è¿”å›çš„æ—¶é—´ï¼ˆ3-10ç§’ï¼‰
   â€¢ å“åº”è¶…æ—¶ï¼šç«¯åˆ°ç«¯çš„æ€»æ—¶é—´ï¼ˆ5-60ç§’ï¼‰

ğŸ”¸ é…ç½®ä¼˜å…ˆçº§ï¼š
   è¿‡æ»¤å™¨ > è·¯ç”± > å…¨å±€é…ç½®

ğŸ”¸ æ ¸å¿ƒä½œç”¨ï¼š
   â€¢ å¿«é€Ÿå¤±è´¥ï¼Œé¿å…èµ„æºè€—å°½
   â€¢ æå‡ç”¨æˆ·ä½“éªŒ
   â€¢ è§¦å‘é™çº§å’Œé‡è¯•æœºåˆ¶
```

### 8.2 é…ç½®æœ€ä½³å®è·µ


**ğŸŸ¢ æ¨èé…ç½®æ¨¡æ¿**ï¼š

```yaml
# åŸºç¡€è¶…æ—¶é…ç½®ï¼ˆ80%åœºæ™¯é€‚ç”¨ï¼‰
spring:
  cloud:
    gateway:
      httpclient:
        connect-timeout: 2000      # è¿æ¥2ç§’
        response-timeout: 10000    # å“åº”10ç§’
      
      # ç‰¹æ®Šåœºæ™¯å•ç‹¬é…ç½®
      routes:
        - id: fast-api
          uri: lb://fast-service
          metadata:
            response-timeout: 3000  # å¿«æ¥å£3ç§’
        
        - id: slow-api
          uri: lb://slow-service
          metadata:
            response-timeout: 30000  # æ…¢æ¥å£30ç§’
```

### 8.3 å¸¸è§é—®é¢˜ä¸è§£å†³


**ğŸ”´ é—®é¢˜1ï¼šé¢‘ç¹è¶…æ—¶**
```
åŸå› åˆ†æï¼š
â‘  åç«¯æœåŠ¡æ€§èƒ½å·® â†’ ä¼˜åŒ–ä»£ç /æ‰©å®¹
â‘¡ è¶…æ—¶è®¾ç½®å¤ªçŸ­ â†’ è°ƒæ•´è¶…æ—¶æ—¶é—´
â‘¢ ç½‘ç»œä¸ç¨³å®š â†’ æ£€æŸ¥ç½‘ç»œé“¾è·¯

è§£å†³æ­¥éª¤ï¼š
1ï¸âƒ£ æŸ¥çœ‹ç›‘æ§ï¼Œç¡®è®¤è¶…æ—¶ç‡
2ï¸âƒ£ åˆ†ææ—¥å¿—ï¼Œå®šä½æ…¢æ¥å£
3ï¸âƒ£ è°ƒæ•´é…ç½®æˆ–ä¼˜åŒ–æœåŠ¡
```

**ğŸŸ¡ é—®é¢˜2ï¼šè¶…æ—¶é…ç½®ä¸ç”Ÿæ•ˆ**
```
æ£€æŸ¥æ¸…å•ï¼š
âœ… é…ç½®ä¼˜å…ˆçº§æ˜¯å¦æ­£ç¡®
âœ… YAMLæ ¼å¼æ˜¯å¦æ­£ç¡®ï¼ˆç¼©è¿›ï¼‰
âœ… æ˜¯å¦é‡å¯äº†ç½‘å…³æœåŠ¡
âœ… è·¯ç”±IDæ˜¯å¦åŒ¹é…
```

### 8.4 æ ¸å¿ƒè®°å¿†å£è¯€


```
è¶…æ—¶æ§åˆ¶ä¸‰å…„å¼Ÿï¼Œè¿æ¥è¯»å–å’Œå“åº”
è¿æ¥æœ€çŸ­ä¸€ä¸¤ç§’ï¼Œè¯»å–ç¨é•¿ä¸‰äº”ç§’
å“åº”è¶…æ—¶è¦çµæ´»ï¼ŒæŒ‰éœ€é…ç½®åˆ«å·æ‡’

å…¨å±€é…ç½®ä½œåŸºå‡†ï¼Œç‰¹æ®Šè·¯ç”±å•ç‹¬è°ƒ
ç›‘æ§å‘Šè­¦è¦è·Ÿä¸Šï¼Œè¶…æ—¶é—®é¢˜æ—©å‘ç°
é™çº§é‡è¯•åŒä¿é™©ï¼Œç”¨æˆ·ä½“éªŒæœ€é‡è¦
```

**ğŸ’¡ å®æˆ˜å°æŠ€å·§**ï¼š
- ä»ä¸¥åˆ°å®½ï¼šå…ˆè®¾ä¿å®ˆå€¼ï¼Œæ ¹æ®ç›‘æ§æ•°æ®é€æ­¥è°ƒæ•´
- å·®å¼‚åŒ–é…ç½®ï¼šä¸åŒä¸šåŠ¡åœºæ™¯ç”¨ä¸åŒè¶…æ—¶æ—¶é—´
- ç›‘æ§å…ˆè¡Œï¼šå…ˆæœ‰ç›‘æ§ï¼Œå†ä¼˜åŒ–é…ç½®
- é™çº§å…œåº•ï¼šè¶…æ—¶åè¦æœ‰åˆç†çš„é™çº§æ–¹æ¡ˆ