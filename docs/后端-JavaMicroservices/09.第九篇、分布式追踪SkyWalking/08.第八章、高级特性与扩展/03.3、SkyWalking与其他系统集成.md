---
title: 3ã€SkyWalkingä¸å…¶ä»–ç³»ç»Ÿé›†æˆ
---
## ğŸ“š ç›®å½•

1. [é›†æˆæ¦‚è¿°ä¸ä»·å€¼](#1-é›†æˆæ¦‚è¿°ä¸ä»·å€¼)
2. [Prometheusé›†æˆï¼šæŒ‡æ ‡ç›‘æ§](#2-Prometheusé›†æˆæŒ‡æ ‡ç›‘æ§)
3. [Grafanaå¯è§†åŒ–é›†æˆ](#3-Grafanaå¯è§†åŒ–é›†æˆ)
4. [Istio Service Meshé›†æˆ](#4-Istio-Service-Meshé›†æˆ)
5. [Kubernetesç”Ÿæ€é›†æˆ](#5-Kubernetesç”Ÿæ€é›†æˆ)
6. [Sidecaræ¨¡å¼æ·±åº¦åº”ç”¨](#6-Sidecaræ¨¡å¼æ·±åº¦åº”ç”¨)
7. [æœåŠ¡æ²»ç†è”åŠ¨](#7-æœåŠ¡æ²»ç†è”åŠ¨)
8. [ç°åº¦å‘å¸ƒç›‘æ§](#8-ç°åº¦å‘å¸ƒç›‘æ§)
9. [æ··åˆäº‘ç›‘æ§æ–¹æ¡ˆ](#9-æ··åˆäº‘ç›‘æ§æ–¹æ¡ˆ)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ é›†æˆæ¦‚è¿°ä¸ä»·å€¼


### 1.1 ä¸ºä»€ä¹ˆéœ€è¦ç³»ç»Ÿé›†æˆ


ğŸ’­ **æƒ³è±¡ä¸€ä¸ªåœºæ™¯**ï¼š
```
ä½ å¼€äº†ä¸€å®¶è¿é”é¤å…ï¼š
- æ”¶é“¶ç³»ç»Ÿè®°å½•é”€å”®æ•°æ®
- ç›‘æ§æ‘„åƒå¤´çœ‹åº—é¢æƒ…å†µ  
- è¿›é”€å­˜ç³»ç»Ÿç®¡ç†åº“å­˜
- é¡¾å®¢è¯„ä»·ç³»ç»Ÿæ”¶é›†åé¦ˆ

å¦‚æœè¿™äº›ç³»ç»Ÿéƒ½ç‹¬ç«‹è¿è¡Œï¼Œä½ éœ€è¦ï¼š
âœ— æ‰“å¼€4ä¸ªä¸åŒçš„è½¯ä»¶æŸ¥çœ‹
âœ— æ•°æ®æ— æ³•å…³è”åˆ†æ
âœ— é—®é¢˜å®šä½å›°éš¾

é›†æˆåçš„æ•ˆæœï¼š
âœ“ ä¸€ä¸ªå¤§å±çœ‹æ‰€æœ‰æ•°æ®
âœ“ é”€å”®ä¸‹é™è‡ªåŠ¨å…³è”ç›‘æ§è§†é¢‘
âœ“ åº“å­˜ä¸è¶³è‡ªåŠ¨æé†’
âœ“ å·®è¯„ç«‹å³å®šä½åˆ°å…·ä½“è®¢å•
```

ğŸ¯ **SkyWalkingé›†æˆçš„ä»·å€¼**ï¼š
- **æ•°æ®äº’é€š**ï¼šè¿½è¸ªã€æŒ‡æ ‡ã€æ—¥å¿—ä¸‰ä½ä¸€ä½“
- **ç»Ÿä¸€å±•ç¤º**ï¼šä¸€ä¸ªç•Œé¢æŒæ¡å…¨å±€
- **æ™ºèƒ½å…³è”**ï¼šé—®é¢˜è‡ªåŠ¨å…³è”ä¸Šä¸‹æ–‡
- **èƒ½åŠ›äº’è¡¥**ï¼šå„ç³»ç»Ÿå‘æŒ¥æ‰€é•¿

### 1.2 é›†æˆç”Ÿæ€å…¨æ™¯


```
                    SkyWalking OAP æ ¸å¿ƒ
                           |
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        |                  |                  |
   æŒ‡æ ‡ç›‘æ§             è¿½è¸ªåˆ†æ            æœåŠ¡æ²»ç†
        |                  |                  |
    Prometheus          Jaeger            Istio/K8s
        |                  |                  |
    â”Œâ”€â”€â”€â”´â”€â”€â”€â”          â”Œâ”€â”€â”€â”´â”€â”€â”€â”          â”Œâ”€â”€â”€â”´â”€â”€â”€â”
    |       |          |       |          |       |
 Grafana  å‘Šè­¦      æ—¥å¿—ç³»ç»Ÿ  APM      é™æµ  ç†”æ–­  è·¯ç”±
```

ğŸ·ï¸ **ä¸“ä¸šæœ¯è¯­è§£é‡Š**ï¼š
- `OAP` = Observability Analysis Platformï¼ˆå¯è§‚æµ‹æ€§åˆ†æå¹³å°ï¼‰
- `APM` = Application Performance Monitoringï¼ˆåº”ç”¨æ€§èƒ½ç›‘æ§ï¼‰
- `Service Mesh` = æœåŠ¡ç½‘æ ¼ï¼ˆç®¡ç†å¾®æœåŠ¡é—´é€šä¿¡çš„åŸºç¡€è®¾æ–½å±‚ï¼‰

---

## 2. ğŸ“Š Prometheusé›†æˆï¼šæŒ‡æ ‡ç›‘æ§


### 2.1 Prometheusæ˜¯ä»€ä¹ˆ


ğŸ” **ç®€å•ç†è§£**ï¼š
```
Prometheus = ä¸“ä¸šçš„"æ•°æ®é‡‡é›†å™¨" + "æ—¶é—´åºåˆ—æ•°æ®åº“"

å°±åƒè¶…å¸‚çš„è¿›é”€å­˜ç³»ç»Ÿï¼š
- æ¯åˆ†é’Ÿè®°å½•ä¸€æ¬¡è´§æ¶å•†å“æ•°é‡
- ä¿å­˜æˆæ—¶é—´åºåˆ—ï¼š9:00æœ‰100ä¸ªï¼Œ9:01æœ‰98ä¸ª...
- å¯ä»¥æŸ¥è¯¢ï¼šè¿‡å»ä¸€å°æ—¶å–äº†å¤šå°‘ï¼Ÿ
- å¯ä»¥å‘Šè­¦ï¼šåº“å­˜ä½äº10ä¸ªæ—¶é€šçŸ¥

Prometheusåšçš„äº‹ï¼š
- é‡‡é›†ç³»ç»ŸæŒ‡æ ‡ï¼ˆCPUã€å†…å­˜ã€è¯·æ±‚æ•°...ï¼‰
- å­˜å‚¨æ—¶é—´åºåˆ—æ•°æ®
- æ”¯æŒå¼ºå¤§çš„æŸ¥è¯¢è¯­è¨€ï¼ˆPromQLï¼‰
- è‡ªå¸¦å‘Šè­¦åŠŸèƒ½
```

ğŸ’¡ **ä¸SkyWalkingçš„å…³ç³»**ï¼š
```
SkyWalkingä¾§é‡ï¼š
âœ“ åˆ†å¸ƒå¼è¿½è¸ªï¼ˆè°ƒç”¨é“¾è·¯ï¼‰
âœ“ æœåŠ¡æ‹“æ‰‘å…³ç³»
âœ“ åº”ç”¨å±‚é¢ç›‘æ§

Prometheusä¾§é‡ï¼š
âœ“ ç³»ç»ŸæŒ‡æ ‡ï¼ˆCPU/å†…å­˜/ç£ç›˜ï¼‰
âœ“ è‡ªå®šä¹‰ä¸šåŠ¡æŒ‡æ ‡
âœ“ çµæ´»çš„æŸ¥è¯¢å’Œå‘Šè­¦

é›†æˆå = 1 + 1 > 2ï¼š
âœ“ SkyWalkingè¿½è¸ªåˆ°æ…¢è¯·æ±‚
âœ“ Prometheusç«‹å³æŸ¥çœ‹è¯¥æ—¶åˆ»CPUæ˜¯å¦é£™å‡
âœ“ å¿«é€Ÿå®šä½æ˜¯ä»£ç é—®é¢˜è¿˜æ˜¯èµ„æºé—®é¢˜
```

### 2.2 é›†æˆé…ç½®å®æˆ˜


**æ­¥éª¤1ï¼šå¼€å¯SkyWalkingçš„Prometheusæ’ä»¶**

```yaml
# application.yml
receiver-prometheus:
  selector: ${SW_PROMETHEUS:default}
  default:
    # Prometheusè¿œç¨‹å†™å…¥ç«¯å£
    port: ${SW_PROMETHEUS_PORT:9090}
    # æ•°æ®ä¿ç•™æ—¶é—´
    enabledRules: ${SW_PROMETHEUS_RULES:service_traffic}
```

ğŸ·ï¸ **é…ç½®è¯´æ˜**ï¼š
- `port: 9090` â†’ è®©PrometheusæŠŠæ•°æ®å‘åˆ°è¿™ä¸ªç«¯å£
- `enabledRules` â†’ å†³å®šæ¥æ”¶å“ªäº›ç±»å‹çš„æŒ‡æ ‡ï¼ˆæœåŠ¡æµé‡ã€JVMæŒ‡æ ‡ç­‰ï¼‰

**æ­¥éª¤2ï¼šé…ç½®Prometheusè¿œç¨‹å†™å…¥**

```yaml
# prometheus.yml
remote_write:
  - url: "http://skywalking-oap:9090/prometheus"
    queue_config:
      capacity: 5000
      max_samples_per_send: 1000
```

ğŸ”„ **æ¢å¥è¯è¯´**ï¼š
- è¿™å°±åƒç»™Prometheusè£…äº†ä¸€ä¸ª"æ•°æ®å¤å°æœº"
- é‡‡é›†çš„æŒ‡æ ‡æ—¢å­˜åœ¨Prometheusæœ¬åœ°ï¼Œåˆå‘ä¸€ä»½ç»™SkyWalking
- `capacity: 5000` = ä¼ è¾“é˜Ÿåˆ—å¤§å°ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±

**æ­¥éª¤3ï¼šåœ¨SkyWalkingä¸­æŸ¥è¯¢PrometheusæŒ‡æ ‡**

```java
// é€šè¿‡GraphQLæŸ¥è¯¢PrometheusæŒ‡æ ‡
query {
  readMetricsValues(condition: {
    name: "service_instance_cpu_usage"
    entity: { scope: ServiceInstance, serviceName: "user-service" }
  }, duration: { start: "2024-01-20 1000", end: "2024-01-20 1100" }) {
    label
    values { values { value } }
  }
}
```

### 2.3 å®é™…åº”ç”¨åœºæ™¯


**åœºæ™¯1ï¼šèµ„æºä¸æ€§èƒ½å…³è”åˆ†æ**

```
é—®é¢˜ï¼šè®¢å•æœåŠ¡å“åº”çªç„¶å˜æ…¢

ä¼ ç»Ÿæ’æŸ¥ï¼ˆç—›è‹¦ï¼‰ï¼š
1. çœ‹SkyWalkingå‘ç°æ…¢ â†’ ä¸çŸ¥é“åŸå› 
2. ç™»å½•æœåŠ¡å™¨çœ‹CPU â†’ æ¥å›åˆ‡æ¢
3. å¯¹æ¯”æ—¶é—´ç‚¹ â†’ æ‰‹åŠ¨è®°å½•

é›†æˆåï¼ˆè½»æ¾ï¼‰ï¼š
1. SkyWalkingæ˜¾ç¤ºæ…¢è¯·æ±‚æ—¶åˆ»
2. åŒç•Œé¢æŸ¥çœ‹CPU/å†…å­˜æŒ‡æ ‡
3. å‘ç°CPU 100% â†’ å®šä½ä»£ç æ­»å¾ªç¯
```

**åœºæ™¯2ï¼šè‡ªå®šä¹‰ä¸šåŠ¡æŒ‡æ ‡ç›‘æ§**

```java
// ä½¿ç”¨Prometheuså®¢æˆ·ç«¯åŸ‹ç‚¹
import io.prometheus.client.Counter;

public class OrderService {
    // è®¢å•è®¡æ•°å™¨
    private static final Counter orderCounter = Counter.build()
        .name("order_total")
        .help("è®¢å•æ€»æ•°")
        .labelNames("status")  // æ ‡ç­¾ï¼šæˆåŠŸ/å¤±è´¥
        .register();
    
    public void createOrder(Order order) {
        try {
            // ä¸šåŠ¡é€»è¾‘
            orderCounter.labels("success").inc();
        } catch (Exception e) {
            orderCounter.labels("failed").inc();
        }
    }
}
```

ğŸ’­ **è¿™æ ·åšçš„å¥½å¤„**ï¼š
- Prometheusé‡‡é›†åˆ°ä¸šåŠ¡æŒ‡æ ‡
- è‡ªåŠ¨åŒæ­¥åˆ°SkyWalking
- å¯ä»¥åœ¨è¿½è¸ªé“¾è·¯ä¸Šçœ‹åˆ°ä¸šåŠ¡æ•°æ®
- å®ç°æŠ€æœ¯æŒ‡æ ‡ä¸ä¸šåŠ¡æŒ‡æ ‡çš„ç»Ÿä¸€ç›‘æ§

---

## 3. ğŸ“ˆ Grafanaå¯è§†åŒ–é›†æˆ


### 3.1 Grafanaçš„æ ¸å¿ƒä¼˜åŠ¿


ğŸŒ° **ä¸¾ä¸ªä¾‹å­**ï¼š
```
SkyWalking UI = ä¸“ä¸šçš„åŒ»ç–—æ£€æŸ¥æŠ¥å‘Š
- æ•°æ®å‡†ç¡®ï¼ŒåŠŸèƒ½é½å…¨
- ä½†å¯èƒ½çœ‹èµ·æ¥æ¯”è¾ƒ"ä¸“ä¸š"

Grafana = å¥åº·çŠ¶å†µå¯è§†åŒ–å¤§å±
- æŠŠå¤æ‚æ•°æ®å˜æˆç›´è§‚å›¾è¡¨
- å¯ä»¥è‡ªå®šä¹‰ä»»ä½•æ ·å¼
- æ”¯æŒå¤šæ•°æ®æºæ•´åˆ

å°±åƒï¼š
SkyWalkingå‘Šè¯‰ä½ ï¼š"CPUä½¿ç”¨ç‡75%ï¼Œå†…å­˜8GBï¼Œè¯·æ±‚1000æ¬¡/åˆ†"
Grafanaç»™ä½ ä¸€ä¸ªï¼š"å¥åº·ä»ªè¡¨ç›˜"ï¼Œçº¢ç»¿ç¯ä¸€ç›®äº†ç„¶
```

### 3.2 é›†æˆé…ç½®æ­¥éª¤


**æ­¥éª¤1ï¼šå®‰è£…SkyWalkingæ•°æ®æºæ’ä»¶**

```bash
# Grafanaæ’ä»¶ç›®å½•
cd /var/lib/grafana/plugins
git clone https://github.com/apache/skywalking-grafana-plugin

# é‡å¯Grafana
systemctl restart grafana-server
```

**æ­¥éª¤2ï¼šé…ç½®æ•°æ®æº**

```json
{
  "name": "SkyWalking",
  "type": "skywalking-datasource",
  "url": "http://skywalking-oap:12800/graphql",
  "access": "proxy",
  "basicAuth": false
}
```

ğŸ·ï¸ **é…ç½®è¯´æ˜**ï¼š
- `url` â†’ SkyWalking GraphQLæŸ¥è¯¢åœ°å€
- `access: proxy` â†’ é€šè¿‡GrafanaæœåŠ¡å™¨è®¿é—®ï¼ˆå®‰å…¨ï¼‰

**æ­¥éª¤3ï¼šåˆ›å»ºä»ªè¡¨ç›˜**

```json
{
  "dashboard": {
    "title": "å¾®æœåŠ¡å¥åº·ç›‘æ§",
    "panels": [
      {
        "title": "æœåŠ¡å“åº”æ—¶é—´TOP5",
        "type": "graph",
        "datasource": "SkyWalking",
        "targets": [{
          "queryType": "Service",
          "metric": "service_resp_time",
          "topN": 5
        }]
      },
      {
        "title": "é”™è¯¯ç‡å‘Šè­¦",
        "type": "stat",
        "datasource": "SkyWalking",
        "targets": [{
          "metric": "service_sla",
          "thresholds": [
            { "value": 99, "color": "green" },
            { "value": 95, "color": "yellow" },
            { "value": 0, "color": "red" }
          ]
        }]
      }
    ]
  }
}
```

### 3.3 é«˜çº§å¯è§†åŒ–æŠ€å·§


**æŠ€å·§1ï¼šå¤šæ•°æ®æºå…³è”å±•ç¤º**

```
å•ä¸ªPanelæ˜¾ç¤ºï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æœåŠ¡å“åº”æ—¶é—´ vs CPUä½¿ç”¨ç‡   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   å“åº”æ—¶é—´ï¼ˆSkyWalkingï¼‰     â”‚
â”‚        â•±â•²                   â”‚
â”‚       â•±  â•²   CPUï¼ˆPrometheusï¼‰â”‚
â”‚      â•±    â•²  â–“â–“â–“             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æŠ€å·§2ï¼šä¸šåŠ¡å¤§å±è®¾è®¡**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ è®¢å•ç³»ç»Ÿå®æ—¶ç›‘æ§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                  â”‚
â”‚  ğŸ“Š ä»Šæ—¥è®¢å•  ğŸ’° äº¤æ˜“é¢    âš¡ å“åº”æ—¶é—´  âŒ é”™è¯¯ç‡â”‚
â”‚   12,345     Â¥123ä¸‡      125ms       0.01%    â”‚
â”‚                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æœåŠ¡æ‹“æ‰‘ï¼ˆå®æ—¶ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”‚
â”‚                                                  â”‚
â”‚      [ç”¨æˆ·æœåŠ¡] â†’ [è®¢å•æœåŠ¡] â†’ [æ”¯ä»˜æœåŠ¡]        â”‚
â”‚         â†“            â†“            â†“             â”‚
â”‚      1000rps      800rps      600rps            â”‚
â”‚                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å¼‚å¸¸è¿½è¸ªï¼ˆæœ€è¿‘1å°æ—¶ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚                                                  â”‚
â”‚  âŒ 14:32 æ”¯ä»˜è¶…æ—¶ TraceID:abc123               â”‚
â”‚  âŒ 14:28 åº“å­˜ä¸è¶³ TraceID:def456               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. ğŸ•¸ï¸ Istio Service Meshé›†æˆ


### 4.1 Service Meshæ˜¯ä»€ä¹ˆ


ğŸ’­ **é€šä¿—ç†è§£**ï¼š
```
ä¼ ç»Ÿå¾®æœåŠ¡ï¼š
æ¯ä¸ªæœåŠ¡éƒ½è¦è‡ªå·±å¤„ç†ï¼š
âœ— æœåŠ¡å‘ç°  âœ— è´Ÿè½½å‡è¡¡  âœ— é™æµ  âœ— é‡è¯•  âœ— åŠ å¯†

å°±åƒæ¯å®¶é¤å…éƒ½è¦ï¼š
- è‡ªå·±æ‹›æœåŠ¡å‘˜
- è‡ªå·±ç®¡æ”¶é“¶
- è‡ªå·±åšå¤–å–é…é€

Service Meshï¼ˆæœåŠ¡ç½‘æ ¼ï¼‰ï¼š
ç»Ÿä¸€çš„"åŸºç¡€è®¾æ–½å±‚"è´Ÿè´£æœåŠ¡é—´é€šä¿¡ï¼š
âœ“ è‡ªåŠ¨æœåŠ¡å‘ç°
âœ“ æ™ºèƒ½è´Ÿè½½å‡è¡¡
âœ“ è‡ªåŠ¨é‡è¯•/ç†”æ–­
âœ“ æµé‡åŠ å¯†

å°±åƒå¤–åŒ…ç»™ä¸“ä¸šå…¬å¸ï¼š
- ç»Ÿä¸€çš„æ”¶é“¶ç³»ç»Ÿ
- ä¸“ä¸šçš„é…é€å›¢é˜Ÿ
- æ ‡å‡†åŒ–çš„æœåŠ¡æµç¨‹
```

ğŸ·ï¸ **Istio** = ç›®å‰æœ€æµè¡Œçš„Service Meshå®ç°
ğŸ·ï¸ **Sidecar** = æ¯ä¸ªæœåŠ¡æ—è¾¹çš„"ä»£ç†åŠ©æ‰‹"

### 4.2 SkyWalkingä¸IstioååŒ


**é›†æˆæ¶æ„å›¾**ï¼š

```
           ç”¨æˆ·è¯·æ±‚
              â†“
         Istio Gateway
              â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    |                   |
æœåŠ¡A Pod          æœåŠ¡B Pod
    |                   |
â”Œâ”€â”€â”€â”´â”€â”€â”€â”          â”Œâ”€â”€â”€â”´â”€â”€â”€â”
â”‚æœåŠ¡A  â”‚          â”‚æœåŠ¡B  â”‚
â”‚       â”‚          â”‚       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”¤          â”œâ”€â”€â”€â”€â”€â”€â”€â”¤
â”‚Envoy  â”‚  â†â”€â”€â”€â”€â†’  â”‚Envoy  â”‚ â† Istio Sidecarä»£ç†
â”‚Sidecarâ”‚          â”‚Sidecarâ”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”˜          â””â”€â”€â”€â”¬â”€â”€â”€â”˜
    |                   |
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
    SkyWalking OAPï¼ˆæ¥æ”¶è¿½è¸ªæ•°æ®ï¼‰
```

ğŸ” **å·¥ä½œæµç¨‹**ï¼š
1. è¯·æ±‚åˆ°è¾¾ â†’ Istio Gatewayæ‹¦æˆª
2. è½¬å‘ç»™æœåŠ¡A â†’ ç»è¿‡Envoy Sidecar
3. Envoyé‡‡é›†è¿½è¸ªæ•°æ® â†’ å‘é€ç»™SkyWalking
4. æœåŠ¡Aè°ƒç”¨æœåŠ¡B â†’ å†æ¬¡ç»è¿‡Envoy
5. SkyWalkingæ”¶é›†å®Œæ•´è°ƒç”¨é“¾

### 4.3 é…ç½®å®æˆ˜


**æ­¥éª¤1ï¼šå¯ç”¨Istioè¿½è¸ª**

```yaml
# istio-config.yaml
apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
spec:
  meshConfig:
    # è¿½è¸ªé…ç½®
    enableTracing: true
    defaultConfig:
      tracing:
        # é‡‡æ ·ç‡100%
        sampling: 100.0
        # SkyWalkingåœ°å€
        zipkin:
          address: skywalking-oap.istio-system:11800
```

ğŸ·ï¸ **é…ç½®è¯´æ˜**ï¼š
- `sampling: 100.0` â†’ 100%é‡‡æ ·ï¼ˆç”Ÿäº§ç¯å¢ƒå»ºè®®1-10%ï¼‰
- `zipkin` â†’ è™½ç„¶å†™zipkinï¼Œä½†ç”¨çš„æ˜¯å…¼å®¹åè®®

**æ­¥éª¤2ï¼šä¸ºæœåŠ¡æ³¨å…¥Sidecar**

```yaml
# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: order-service
spec:
  template:
    metadata:
      labels:
        app: order-service
        # è‡ªåŠ¨æ³¨å…¥Sidecaræ ‡ç­¾
        sidecar.istio.io/inject: "true"
    spec:
      containers:
      - name: order-service
        image: order-service:latest
```

âœ… **æ³¨å…¥åçš„æ•ˆæœ**ï¼š
```
Podä¸­ä¼šè‡ªåŠ¨å¤šä¸€ä¸ªå®¹å™¨ï¼š
1. order-service ï¼ˆä½ çš„ä¸šåŠ¡å®¹å™¨ï¼‰
2. istio-proxy ï¼ˆEnvoyä»£ç†å®¹å™¨ï¼‰â† è‡ªåŠ¨æ³¨å…¥
```

**æ­¥éª¤3ï¼šéªŒè¯é›†æˆ**

```bash
# æŸ¥çœ‹Podä¸­çš„å®¹å™¨
kubectl get pod order-service-xxx -o jsonpath='{.spec.containers[*].name}'
# è¾“å‡ºï¼šorder-service istio-proxy

# æŸ¥çœ‹è¿½è¸ªæ•°æ®
curl http://skywalking-ui:8080/graphql -d '{
  "query": "query { traces(condition: {}) { traces { traceId } } }"
}'
```

### 4.4 æµé‡æ²»ç†ä¸è¿½è¸ªè”åŠ¨


**åœºæ™¯ï¼šç°åº¦å‘å¸ƒç›‘æ§**

```yaml
# é‡‘ä¸é›€å‘å¸ƒè§„åˆ™
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: order-service
spec:
  hosts:
  - order-service
  http:
  - match:
    - headers:
        user-type:
          exact: "vip"  # VIPç”¨æˆ·æµé‡
    route:
    - destination:
        host: order-service
        subset: v2    # æ–°ç‰ˆæœ¬
      weight: 100
  - route:
    - destination:
        host: order-service
        subset: v1    # è€ç‰ˆæœ¬
      weight: 90
    - destination:
        host: order-service
        subset: v2    # æ–°ç‰ˆæœ¬
      weight: 10      # 10%æµé‡åˆ°æ–°ç‰ˆæœ¬
```

ğŸ’¡ **SkyWalkingè‡ªåŠ¨è¿½è¸ª**ï¼š
- è‡ªåŠ¨åŒºåˆ†v1å’Œv2ç‰ˆæœ¬çš„è°ƒç”¨é“¾
- å¯ä»¥å¯¹æ¯”ä¸¤ä¸ªç‰ˆæœ¬çš„æ€§èƒ½
- å‘ç°é—®é¢˜ç«‹å³å›æ»š

---

## 5. â˜¸ï¸ Kubernetesç”Ÿæ€é›†æˆ


### 5.1 K8sé›†æˆçš„æ ¸å¿ƒä»·å€¼


ğŸŒ° **ç±»æ¯”ç†è§£**ï¼š
```
Kubernetes = å¤§å‹è´­ç‰©ä¸­å¿ƒçš„ç®¡ç†ç³»ç»Ÿ
- çŸ¥é“æ¯ä¸ªåº—é“ºï¼ˆPodï¼‰åœ¨å“ªé‡Œ
- æ§åˆ¶äººæµï¼ˆæµé‡ï¼‰åˆ†é…
- è‡ªåŠ¨æ›¿æ¢æ•…éšœåº—é“º

SkyWalking = è´­ç‰©ä¸­å¿ƒçš„ç›‘æ§ç³»ç»Ÿ
- è¿½è¸ªé¡¾å®¢ï¼ˆè¯·æ±‚ï¼‰è·¯å¾„
- åˆ†æå„åº—é“ºï¼ˆæœåŠ¡ï¼‰æ€§èƒ½
- å‘ç°å¼‚å¸¸åŠæ—¶å‘Šè­¦

é›†æˆåï¼š
âœ“ ç›‘æ§çŸ¥é“Podåœ¨å“ªä¸ªèŠ‚ç‚¹
âœ“ æ•…éšœæ—¶è‡ªåŠ¨å…³è”K8säº‹ä»¶
âœ“ æ‰©ç¼©å®¹è‡ªåŠ¨æ›´æ–°æœåŠ¡æ‹“æ‰‘
```

### 5.2 é›†æˆéƒ¨ç½²å®æˆ˜


**æ–¹å¼1ï¼šHelmå¿«é€Ÿéƒ¨ç½²**

```bash
# æ·»åŠ SkyWalking Helmä»“åº“
helm repo add skywalking https://apache.jfrog.io/artifactory/skywalking-helm

# å®‰è£…SkyWalkingï¼ˆåŒ…å«K8sé›†æˆï¼‰
helm install skywalking skywalking/skywalking \
  --set oap.replicas=2 \
  --set ui.service.type=LoadBalancer \
  --set elasticsearch.enabled=true \
  --set oap.env.SW_CLUSTER=kubernetes \
  --set oap.env.SW_CLUSTER_K8S_NAMESPACE=skywalking
```

ğŸ·ï¸ **å…³é”®å‚æ•°**ï¼š
- `SW_CLUSTER=kubernetes` â†’ å¯ç”¨K8sé›†ç¾¤æ¨¡å¼
- `SW_CLUSTER_K8S_NAMESPACE` â†’ æŒ‡å®šå‘½åç©ºé—´

**æ–¹å¼2ï¼šè‡ªå®šä¹‰éƒ¨ç½²é…ç½®**

```yaml
# skywalking-oap-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: skywalking-oap
spec:
  replicas: 2
  selector:
    matchLabels:
      app: skywalking-oap
  template:
    metadata:
      labels:
        app: skywalking-oap
    spec:
      serviceAccountName: skywalking-oap
      containers:
      - name: oap
        image: apache/skywalking-oap-server:9.5.0
        env:
        - name: SW_CLUSTER
          value: kubernetes
        - name: SW_CLUSTER_K8S_NAMESPACE
          value: skywalking
        - name: SW_CLUSTER_K8S_LABEL
          value: app=skywalking-oap
        - name: JAVA_OPTS
          value: "-Xms2g -Xmx2g"
```

**åˆ›å»ºServiceAccountï¼ˆæƒé™é…ç½®ï¼‰**

```yaml
# skywalking-rbac.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: skywalking-oap
  namespace: skywalking
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: skywalking-oap
rules:
- apiGroups: [""]
  resources: ["pods", "services", "endpoints"]
  verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: skywalking-oap
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: skywalking-oap
subjects:
- kind: ServiceAccount
  name: skywalking-oap
  namespace: skywalking
```

âœ… **ä¸ºä»€ä¹ˆéœ€è¦è¿™äº›æƒé™**ï¼š
- `pods` â†’ è·å–Podä¿¡æ¯ï¼Œè‡ªåŠ¨å‘ç°æœåŠ¡å®ä¾‹
- `services` â†’ è·å–Serviceä¿¡æ¯ï¼Œæ„å»ºæœåŠ¡æ‹“æ‰‘
- `endpoints` â†’ è·å–ç«¯ç‚¹ä¿¡æ¯ï¼Œå®ç°é›†ç¾¤å‘ç°

### 5.3 è‡ªåŠ¨æœåŠ¡å‘ç°


**å·¥ä½œåŸç†**ï¼š

```
K8sç¯å¢ƒï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Namespace: default              â”‚
â”‚                                 â”‚
â”‚  Service: order-service         â”‚
â”‚  â”œâ”€ Pod: order-xxx-1 (10.0.1.5) â”‚
â”‚  â”œâ”€ Pod: order-xxx-2 (10.0.1.6) â”‚
â”‚  â””â”€ Pod: order-xxx-3 (10.0.1.7) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ SkyWalkingè‡ªåŠ¨å‘ç°
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SkyWalkingæœåŠ¡æ‹“æ‰‘              â”‚
â”‚                                 â”‚
â”‚  order-service                  â”‚
â”‚  â”œâ”€ Instance: 10.0.1.5:8080    â”‚
â”‚  â”œâ”€ Instance: 10.0.1.6:8080    â”‚
â”‚  â””â”€ Instance: 10.0.1.7:8080    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é…ç½®æœåŠ¡å‘ç°**ï¼š

```yaml
# application.yml
cluster:
  kubernetes:
    # K8s APIåœ°å€ï¼ˆé»˜è®¤é›†ç¾¤å†…ï¼‰
    api_server_url: https://kubernetes.default.svc
    # å‘½åç©ºé—´
    namespace: ${SW_CLUSTER_K8S_NAMESPACE:default}
    # æœåŠ¡æ ‡ç­¾é€‰æ‹©å™¨
    label_selector: ${SW_CLUSTER_K8S_LABEL:app=skywalking-oap}
    # ç›‘å¬èµ„æº
    watch_resources:
      - pods
      - services
```

### 5.4 äº‹ä»¶å…³è”ä¸æ•…éšœå®šä½


**åœºæ™¯ï¼šPodé‡å¯é—®é¢˜å®šä½**

```
é—®é¢˜ï¼šè®¢å•æœåŠ¡å“åº”æ…¢

ä¼ ç»Ÿæ’æŸ¥ï¼š
1. SkyWalkingçœ‹åˆ°æ…¢ â†’ ä¸çŸ¥é“PodçŠ¶æ€
2. ç™»å½•K8sæŸ¥Pod â†’ å‘ç°é‡å¯äº†
3. æ‰‹åŠ¨å¯¹æ¯”æ—¶é—´ â†’ æ‰çŸ¥é“æ˜¯é‡å¯å¯¼è‡´

é›†æˆåï¼š
1. SkyWalkingè‡ªåŠ¨æ£€æµ‹åˆ°æ…¢
2. åŒæ—¶æ˜¾ç¤ºï¼šPodåœ¨14:30é‡å¯
3. è¿½è¸ªé“¾è·¯ä¸Šç›´æ¥æ ‡æ³¨"Podé‡å¯ä¸­"
4. ä¸€ç›®äº†ç„¶ï¼šæ…¢æ˜¯å› ä¸ºé‡å¯æ¢å¤
```

**å®ç°æ–¹å¼**ï¼š

```java
// SkyWalkingè‡ªåŠ¨é‡‡é›†K8säº‹ä»¶
@Component
public class K8sEventCollector {
    
    @Scheduled(fixedRate = 30000) // 30ç§’æ£€æŸ¥ä¸€æ¬¡
    public void collectEvents() {
        // è·å–Podäº‹ä»¶
        List<Event> events = k8sClient.events()
            .inNamespace("default")
            .withLabel("app=order-service")
            .list()
            .getItems();
        
        for (Event event : events) {
            if ("Warning".equals(event.getType())) {
                // å‘é€åˆ°SkyWalking
                sendEventToSkyWalking(EventInfo.builder()
                    .name(event.getReason())
                    .message(event.getMessage())
                    .time(event.getLastTimestamp())
                    .source(event.getSource().getComponent())
                    .build());
            }
        }
    }
}
```

---

## 6. ğŸ”„ Sidecaræ¨¡å¼æ·±åº¦åº”ç”¨


### 6.1 Sidecaræ¨¡å¼è¯¦è§£


ğŸ’­ **é€šä¿—æ¯”å–»**ï¼š
```
ä¸»å®¹å™¨ = é¤å…å¨å¸ˆï¼ˆæ ¸å¿ƒä¸šåŠ¡ï¼‰
Sidecarå®¹å™¨ = æœåŠ¡å‘˜ï¼ˆè¾…åŠ©åŠŸèƒ½ï¼‰

å¨å¸ˆä¸“æ³¨åšèœï¼ŒæœåŠ¡å‘˜è´Ÿè´£ï¼š
âœ“ æ¥å¾…å®¢äººï¼ˆæµé‡ç®¡ç†ï¼‰
âœ“ ä¸Šèœï¼ˆè¯·æ±‚è½¬å‘ï¼‰
âœ“ æ”¶é“¶ï¼ˆç›‘æ§ç»Ÿè®¡ï¼‰
âœ“ å¤„ç†æŠ•è¯‰ï¼ˆå¼‚å¸¸å¤„ç†ï¼‰

è¿™æ ·ï¼š
- å¨å¸ˆä¸ç”¨å…³å¿ƒæœåŠ¡æµç¨‹
- æœåŠ¡å‘˜å¯ä»¥ç»Ÿä¸€åŸ¹è®­
- æ¢æœåŠ¡å‘˜ä¸å½±å“å¨å¸ˆ
```

**å®¹å™¨ç¼–æ’è§†å›¾**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Pod â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚             â”‚      â”‚              â”‚  â”‚
â”‚  â”‚  ä¸šåŠ¡å®¹å™¨    â”‚â—„â”€â”€â”€â”€â–ºâ”‚  Sidecarå®¹å™¨ â”‚  â”‚
â”‚  â”‚             â”‚      â”‚              â”‚  â”‚
â”‚  â”‚ order-serviceâ”‚      â”‚ skywalking   â”‚  â”‚
â”‚  â”‚             â”‚      â”‚ -agent       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚        â†‘                      â†“          â”‚
â”‚        â”‚                  è¿½è¸ªæ•°æ®        â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 Sidecaræ³¨å…¥é…ç½®


**è‡ªåŠ¨æ³¨å…¥é…ç½®**

```yaml
# skywalking-sidecar-injector.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: skywalking-sidecar-injector
  namespace: skywalking
data:
  # Sidecarå®¹å™¨æ¨¡æ¿
  sidecar-template: |
    - name: skywalking-agent
      image: apache/skywalking-java-agent:8.16.0
      env:
      - name: SW_AGENT_NAME
        value: "$(POD_NAME)"
      - name: SW_AGENT_COLLECTOR_BACKEND_SERVICES
        value: "skywalking-oap:11800"
      volumeMounts:
      - name: skywalking-agent
        mountPath: /skywalking
  
  # æ³¨å…¥è§„åˆ™
  injection-rules: |
    namespaceSelector:
      matchLabels:
        skywalking-injection: enabled
    podSelector:
      matchLabels:
        app: order-service
```

**æ‰‹åŠ¨æ³¨å…¥ç¤ºä¾‹**

```yaml
# order-service-with-sidecar.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: order-service
spec:
  template:
    spec:
      # åˆå§‹åŒ–å®¹å™¨ï¼šå‡†å¤‡Agent
      initContainers:
      - name: agent-init
        image: apache/skywalking-java-agent:8.16.0
        command:
        - sh
        - -c
        - "cp -r /skywalking/agent /agent-volume"
        volumeMounts:
        - name: agent-volume
          mountPath: /agent-volume
      
      # ä¸»å®¹å™¨
      containers:
      - name: order-service
        image: order-service:latest
        env:
        - name: JAVA_TOOL_OPTIONS
          value: "-javaagent:/skywalking/agent/skywalking-agent.jar"
        volumeMounts:
        - name: agent-volume
          mountPath: /skywalking
      
      volumes:
      - name: agent-volume
        emptyDir: {}
```

âœ… **å·¥ä½œæµç¨‹**ï¼š
1. `initContainer`å…ˆè¿è¡Œï¼Œå¤åˆ¶Agentæ–‡ä»¶
2. ä¸»å®¹å™¨å¯åŠ¨ï¼Œé€šè¿‡`JAVA_TOOL_OPTIONS`åŠ è½½Agent
3. Agentè‡ªåŠ¨æ‹¦æˆªè¯·æ±‚ï¼Œå‘é€è¿½è¸ªæ•°æ®

### 6.3 Sidecaré«˜çº§ç”¨æ³•


**ç”¨æ³•1ï¼šå¤šè¯­è¨€æ··åˆç›‘æ§**

```yaml
# ä¸€ä¸ªPodä¸­è¿è¡Œå¤šä¸ªæœåŠ¡
apiVersion: v1
kind: Pod
metadata:
  name: mixed-service
spec:
  containers:
  # JavaæœåŠ¡
  - name: java-api
    image: java-service:latest
    env:
    - name: JAVA_TOOL_OPTIONS
      value: "-javaagent:/skywalking/java-agent.jar"
  
  # PythonæœåŠ¡
  - name: python-worker
    image: python-service:latest
    env:
    - name: SW_AGENT_NAME
      value: "python-worker"
    - name: SW_AGENT_COLLECTOR_BACKEND_SERVICES
      value: "skywalking-oap:11800"
  
  # GoæœåŠ¡
  - name: go-gateway
    image: go-service:latest
    env:
    - name: SW_AGENT_NAME
      value: "go-gateway"
```

**ç”¨æ³•2ï¼šåŠ¨æ€é…ç½®æ›´æ–°**

```yaml
# ä½¿ç”¨ConfigMapåŠ¨æ€é…ç½®
apiVersion: v1
kind: ConfigMap
metadata:
  name: skywalking-agent-config
data:
  agent.config: |
    agent.service_name=${SW_AGENT_NAME:default-service}
    collector.backend_service=${SW_AGENT_COLLECTOR_BACKEND_SERVICES:127.0.0.1:11800}
    # é‡‡æ ·ç‡ï¼ˆå¯çƒ­æ›´æ–°ï¼‰
    agent.sample_n_per_3_secs=9
    # å¿½ç•¥è·¯å¾„
    agent.ignore_suffix=.jpg,.jpeg,.png
    # æ’ä»¶å¯ç”¨
    plugin.mongodb.trace_param=true
```

---

## 7. ğŸ›ï¸ æœåŠ¡æ²»ç†è”åŠ¨


### 7.1 é™æµç†”æ–­é›†æˆ


ğŸŒ° **åœºæ™¯è¯´æ˜**ï¼š
```
åŒåä¸€åœºæ™¯ï¼š
è®¢å•æœåŠ¡çªç„¶æ”¶åˆ°10å€æµé‡

æ²¡æœ‰æ²»ç†çš„åæœï¼š
âœ— æœåŠ¡ç›´æ¥å´©æºƒ
âœ— æ•°æ®åº“è¿æ¥è€—å°½
âœ— æ•´ä¸ªç³»ç»Ÿé›ªå´©

æœ‰æ²»ç†çš„æ•ˆæœï¼š
âœ“ é™æµï¼šè¶…è¿‡é˜ˆå€¼çš„è¯·æ±‚æ’é˜Ÿæˆ–æ‹’ç»
âœ“ ç†”æ–­ï¼šæ£€æµ‹åˆ°å¼‚å¸¸ç«‹å³åˆ‡æ–­è°ƒç”¨
âœ“ é™çº§ï¼šè¿”å›å…œåº•æ•°æ®ï¼Œä¿è¯åŸºæœ¬åŠŸèƒ½
```

**Sentinel + SkyWalkingé›†æˆ**

```java
// Sentinelè§„åˆ™é…ç½®
@Configuration
public class SentinelConfig {
    
    @PostConstruct
    public void init() {
        // é™æµè§„åˆ™
        FlowRule flowRule = new FlowRule();
        flowRule.setResource("createOrder"); // èµ„æºå
        flowRule.setGrade(RuleConstant.FLOW_GRADE_QPS); // QPSæ¨¡å¼
        flowRule.setCount(100); // æ¯ç§’100æ¬¡
        
        // ç†”æ–­è§„åˆ™
        DegradeRule degradeRule = new DegradeRule();
        degradeRule.setResource("paymentService");
        degradeRule.setGrade(RuleConstant.DEGRADE_GRADE_RT); // å“åº”æ—¶é—´
        degradeRule.setCount(500); // è¶…è¿‡500ms
        degradeRule.setTimeWindow(10); // ç†”æ–­10ç§’
        
        // åŠ è½½è§„åˆ™
        FlowRuleManager.loadRules(Arrays.asList(flowRule));
        DegradeRuleManager.loadRules(Arrays.asList(degradeRule));
        
        // é›†æˆSkyWalkingï¼šé™æµ/ç†”æ–­äº‹ä»¶ä¸ŠæŠ¥
        SentinelConfig.setConfig(new SentinelConfig() {
            @Override
            public void onBlock(BlockException ex) {
                // ä¸ŠæŠ¥åˆ°SkyWalking
                TraceContext.putTag("flow.blocked", "true");
                TraceContext.putTag("block.rule", ex.getRule().toString());
            }
        });
    }
}
```

**åœ¨SkyWalkingä¸­æŸ¥çœ‹æ²»ç†æ•ˆæœ**

```
è¿½è¸ªè¯¦æƒ…ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TraceID: abc123                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ order-service                      â”‚
â”‚ â”œâ”€ createOrder  âš¡é™æµè§¦å‘          â”‚
â”‚ â”‚  â””â”€ Tags:                        â”‚
â”‚ â”‚     flow.blocked: true           â”‚
â”‚ â”‚     block.rule: QPS > 100        â”‚
â”‚ â”‚     action: rejected             â”‚
â”‚ â”œâ”€ queryOrder  âœ“ æ­£å¸¸              â”‚
â”‚ â””â”€ payment-service  ğŸ”´ ç†”æ–­        â”‚
â”‚    â””â”€ Tags:                        â”‚
â”‚       circuit.broken: true         â”‚
â”‚       reason: RT > 500ms           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 åŠ¨æ€è·¯ç”±ä¸è¿½è¸ª


**åŸºäºè¿½è¸ªæ•°æ®çš„æ™ºèƒ½è·¯ç”±**

```java
// æ ¹æ®è¿½è¸ªæ•°æ®åŠ¨æ€è°ƒæ•´è·¯ç”±
@Component
public class SmartRouter {
    
    @Autowired
    private SkyWalkingClient skyWalkingClient;
    
    public ServiceInstance selectInstance(String serviceName) {
        // æŸ¥è¯¢å„å®ä¾‹çš„æ€§èƒ½æŒ‡æ ‡
        List<InstanceMetrics> metrics = skyWalkingClient.getInstanceMetrics(
            serviceName, Duration.ofMinutes(5)
        );
        
        // é€‰æ‹©æœ€ä¼˜å®ä¾‹
        return metrics.stream()
            .filter(m -> m.getSuccessRate() > 0.99)  // æˆåŠŸç‡>99%
            .filter(m -> m.getAvgResponseTime() < 100) // å“åº”<100ms
            .min(Comparator.comparing(InstanceMetrics::getLoad)) // è´Ÿè½½æœ€ä½
            .map(InstanceMetrics::getInstance)
            .orElse(fallbackInstance());
    }
}
```

**è·¯ç”±ç­–ç•¥ç¤ºä¾‹**

```yaml
# åŸºäºè¿½è¸ªæ•°æ®çš„åŠ¨æ€è·¯ç”±è§„åˆ™
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: smart-routing
spec:
  hosts:
  - order-service
  http:
  - match:
    - headers:
        trace-sampling:
          exact: "true"  # é‡‡æ ·è¯·æ±‚
    route:
    - destination:
        host: order-service
        subset: debug  # è·¯ç”±åˆ°è°ƒè¯•å®ä¾‹
  - route:
    - destination:
        host: order-service
        subset: prod
      weight: 80
    - destination:
        host: order-service-v2
        subset: canary
      weight: 20  # 20%æµé‡åˆ°é‡‘ä¸é›€ç‰ˆæœ¬
```

---

## 8. ğŸš€ ç°åº¦å‘å¸ƒç›‘æ§


### 8.1 ç°åº¦å‘å¸ƒåŸç†


ğŸ’­ **é€šä¿—ç†è§£**ï¼š
```
ç°åº¦å‘å¸ƒ = æ–°ç‰ˆæœ¬çš„"å†…æµ‹"

ä¼ ç»Ÿå‘å¸ƒï¼š
âœ— æ–°ç‰ˆæœ¬ç›´æ¥ä¸Šçº¿
âœ— æœ‰é—®é¢˜å…¨å‘˜é­æ®ƒ

ç°åº¦å‘å¸ƒï¼š
âœ“ å…ˆç»™1%ç”¨æˆ·ç”¨æ–°ç‰ˆæœ¬
âœ“ æ²¡é—®é¢˜å†é€æ­¥æ‰©å¤§
âœ“ æœ‰é—®é¢˜ç«‹å³å›æ»š

å°±åƒé¤å…ï¼š
- å…ˆåœ¨ä¸€å¼ æ¡Œå­è¯•æ–°èœ
- å®¢äººæ»¡æ„å†æ¨å¹¿å…¨åº—
- ä¸æ»¡æ„ç«‹å³ä¸‹æ¶
```

**ç°åº¦æµç¨‹å›¾**ï¼š

```
ç”¨æˆ·è¯·æ±‚
   â†“
ç½‘å…³åˆ¤æ–­
   â†“
â”Œâ”€â”€â”´â”€â”€â”
â”‚è§„åˆ™  â”‚
â””â”€â”€â”¬â”€â”€â”˜
   â”œâ”€ VIPç”¨æˆ· â†’ æ–°ç‰ˆæœ¬(v2)  â† SkyWalkingè¿½è¸ª
   â”œâ”€ æ™®é€šç”¨æˆ·
   â”‚   â”œâ”€ 10% â†’ æ–°ç‰ˆæœ¬(v2)  â† SkyWalkingè¿½è¸ª
   â”‚   â””â”€ 90% â†’ è€ç‰ˆæœ¬(v1)  â† SkyWalkingè¿½è¸ª
   â””â”€ å¯¹æ¯”åˆ†æ
       â”œâ”€ v2æ€§èƒ½å¥½ â†’ æ‰©å¤§æ¯”ä¾‹
       â””â”€ v2æœ‰é—®é¢˜ â†’ ç«‹å³å›æ»š
```

### 8.2 ç°åº¦é…ç½®ä¸è¿½è¸ª


**æ­¥éª¤1ï¼šé…ç½®ç°åº¦è§„åˆ™**

```yaml
# ç°åº¦å‘å¸ƒé…ç½®
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: order-service-canary
spec:
  hosts:
  - order-service
  http:
  # è§„åˆ™1ï¼šVIPç”¨æˆ·å…¨é‡æ–°ç‰ˆæœ¬
  - match:
    - headers:
        user-level:
          exact: "vip"
    route:
    - destination:
        host: order-service
        subset: v2
        headers:
          response:
            set:
              x-version: "v2"  # å“åº”å¤´æ ‡è®°ç‰ˆæœ¬
  
  # è§„åˆ™2ï¼šæ™®é€šç”¨æˆ·10%æ–°ç‰ˆæœ¬
  - match:
    - headers:
        user-level:
          exact: "normal"
    route:
    - destination:
        host: order-service
        subset: v1
      weight: 90
      headers:
        response:
          set:
            x-version: "v1"
    - destination:
        host: order-service
        subset: v2
      weight: 10
      headers:
        response:
          set:
            x-version: "v2"
```

**æ­¥éª¤2ï¼šè¿½è¸ªæ•°æ®æ‰“æ ‡ç­¾**

```java
// è‡ªåŠ¨æ ‡è®°ç°åº¦ç‰ˆæœ¬
@Component
public class CanaryTracer {
    
    @Around("@annotation(org.springframework.web.bind.annotation.RequestMapping)")
    public Object trace(ProceedingJoinPoint pjp) throws Throwable {
        // è·å–ç‰ˆæœ¬ä¿¡æ¯
        String version = System.getenv("APP_VERSION");
        
        // SkyWalkingæ‰“æ ‡ç­¾
        TraceContext.putTag("canary.version", version);
        TraceContext.putTag("canary.pod", System.getenv("HOSTNAME"));
        
        try {
            Object result = pjp.proceed();
            TraceContext.putTag("canary.status", "success");
            return result;
        } catch (Exception e) {
            TraceContext.putTag("canary.status", "error");
            TraceContext.putTag("canary.error", e.getMessage());
            throw e;
        }
    }
}
```

### 8.3 ç°åº¦æ•ˆæœåˆ†æ


**SkyWalkingæŸ¥è¯¢å¯¹æ¯”**

```graphql
# æŸ¥è¯¢v1å’Œv2çš„æ€§èƒ½å¯¹æ¯”
query {
  # v1ç‰ˆæœ¬æŒ‡æ ‡
  v1: readMetricsValues(
    condition: {
      name: "service_resp_time"
      entity: {
        serviceName: "order-service"
        normal: true
      }
    }
    labels: ["version:v1"]
  ) {
    values { value }
  }
  
  # v2ç‰ˆæœ¬æŒ‡æ ‡
  v2: readMetricsValues(
    condition: {
      name: "service_resp_time"
      entity: {
        serviceName: "order-service"
        normal: true
      }
    }
    labels: ["version:v2"]
  ) {
    values { value }
  }
}
```

**å¯è§†åŒ–å¯¹æ¯”**

```
ç°åº¦å‘å¸ƒç›‘æ§é¢æ¿ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è®¢å•æœåŠ¡ v1 vs v2 å®æ—¶å¯¹æ¯”               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                           â”‚
â”‚  å“åº”æ—¶é—´ï¼š                               â”‚
â”‚  v1: 120ms â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                       â”‚
â”‚  v2:  80ms â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                          â”‚
â”‚                                           â”‚
â”‚  æˆåŠŸç‡ï¼š                                 â”‚
â”‚  v1: 99.5% â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                    â”‚
â”‚  v2: 99.8% â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                    â”‚
â”‚                                           â”‚
â”‚  æµé‡å æ¯”ï¼š                               â”‚
â”‚  v1: 90% â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ            â”‚
â”‚  v2: 10% â–ˆâ–ˆ                              â”‚
â”‚                                           â”‚
â”‚  âœ… å»ºè®®ï¼šv2æ€§èƒ½ä¼˜äºv1ï¼Œå¯æ‰©å¤§ç°åº¦æ¯”ä¾‹     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è‡ªåŠ¨å†³ç­–ç¤ºä¾‹**

```java
// åŸºäºè¿½è¸ªæ•°æ®çš„è‡ªåŠ¨ç°åº¦å†³ç­–
@Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿæ£€æŸ¥
public void autoCanaryDecision() {
    // è·å–v1å’Œv2çš„æŒ‡æ ‡
    Metrics v1 = getMetrics("v1");
    Metrics v2 = getMetrics("v2");
    
    // å†³ç­–é€»è¾‘
    if (v2.getErrorRate() > v1.getErrorRate() * 1.5) {
        // v2é”™è¯¯ç‡é«˜50% â†’ ç«‹å³å›æ»š
        rollback();
        alertOps("ç°åº¦ç‰ˆæœ¬å¼‚å¸¸ï¼Œå·²è‡ªåŠ¨å›æ»š");
    } else if (v2.getResponseTime() < v1.getResponseTime() * 0.8
               && v2.getErrorRate() < 0.01) {
        // v2å“åº”å¿«20%ä¸”é”™è¯¯ç‡ä½ â†’ æ‰©å¤§æ¯”ä¾‹
        increaseCanaryWeight(20); // å¢åŠ åˆ°30%
        alertOps("ç°åº¦ç‰ˆæœ¬è¡¨ç°è‰¯å¥½ï¼Œå·²æ‰©å¤§æµé‡");
    }
}
```

---

## 9. â˜ï¸ æ··åˆäº‘ç›‘æ§æ–¹æ¡ˆ


### 9.1 æ··åˆäº‘åœºæ™¯æŒ‘æˆ˜


ğŸŒ° **å®é™…åœºæ™¯**ï¼š
```
æŸç”µå•†å…¬å¸æ¶æ„ï¼š
- è®¢å•æœåŠ¡ï¼šéƒ¨ç½²åœ¨é˜¿é‡Œäº‘
- æ”¯ä»˜æœåŠ¡ï¼šéƒ¨ç½²åœ¨AWS
- åº“å­˜æœåŠ¡ï¼šéƒ¨ç½²åœ¨è‡ªå»ºIDC
- ç”¨æˆ·æœåŠ¡ï¼šéƒ¨ç½²åœ¨è…¾è®¯äº‘

æŒ‘æˆ˜ï¼š
âœ— è·¨äº‘ç½‘ç»œå¤æ‚
âœ— æ•°æ®å­¤å²›ä¸¥é‡
âœ— è¿½è¸ªé“¾è·¯æ–­è£‚
âœ— ç»Ÿä¸€ç›‘æ§å›°éš¾
```

**é—®é¢˜ç¤ºæ„å›¾**ï¼š

```
         ç”¨æˆ·è¯·æ±‚
            â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ é˜¿é‡Œäº‘ ECS     â”‚
    â”‚ order-service â”‚ â† é“¾è·¯å¼€å§‹
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“ è·¨äº‘è°ƒç”¨ï¼ˆè¿½è¸ªæ–­è£‚ï¼Ÿï¼‰
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ AWS EC2       â”‚
    â”‚ payment       â”‚ â† è¿½è¸ªæ•°æ®åœ¨å¦ä¸€ä¸ªäº‘
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ è‡ªå»ºIDC       â”‚
    â”‚ inventory     â”‚ â† å®Œå…¨ç‹¬ç«‹çš„ç›‘æ§
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.2 ç»Ÿä¸€è¿½è¸ªæ–¹æ¡ˆ


**æ–¹æ¡ˆ1ï¼šä¸­å¿ƒåŒ–OAPé›†ç¾¤**

```
æ¶æ„è®¾è®¡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         é˜¿é‡Œäº‘                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Service â”‚â”€â”€â”€â”€â†’â”‚ SkyWalking   â”‚   â”‚
â”‚  â”‚   A     â”‚     â”‚ OAP (ä¸­å¿ƒ)   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â†‘            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚               â”‚               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
â”‚   AWS        â”‚  â”‚ è…¾è®¯äº‘       â”‚  â”‚ è‡ªå»ºIDC  â”‚
â”‚              â”‚  â”‚              â”‚  â”‚          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ Service â”‚ â”‚  â”‚ â”‚ Service â”‚  â”‚  â”‚â”‚Service â”‚â”‚
â”‚ â”‚   B     â”‚ â”‚  â”‚ â”‚   C     â”‚  â”‚  â”‚â”‚   D    â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â”‚  â”‚â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜â”‚
â”‚      â”‚      â”‚  â”‚      â”‚       â”‚  â”‚    â”‚     â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”€â”€â”€â”˜     â”‚
â”‚   è¿½è¸ªæ•°æ®  â”‚  â”‚  è¿½è¸ªæ•°æ®    â”‚  â”‚ è¿½è¸ªæ•°æ® â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é…ç½®ç¤ºä¾‹**ï¼š

```yaml
# å„äº‘ç¯å¢ƒçš„Agenté…ç½®
# AWSç¯å¢ƒ
collector.backend_service=skywalking-oap.aliyun.com:11800

# è…¾è®¯äº‘ç¯å¢ƒ  
collector.backend_service=skywalking-oap.aliyun.com:11800

# è‡ªå»ºIDC
collector.backend_service=skywalking-oap.aliyun.com:11800

# å®‰å…¨é…ç½®ï¼šä½¿ç”¨TLSåŠ å¯†è·¨äº‘ä¼ è¾“
agent.is_open_tls=true
agent.tls_ca_path=/certs/ca.crt
```

**æ–¹æ¡ˆ2ï¼šè”é‚¦å¼éƒ¨ç½²**

```
æ¶æ„è®¾è®¡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é˜¿é‡Œäº‘OAP  â”‚  â”‚  AWS OAP    â”‚  â”‚  IDC OAP    â”‚
â”‚  (Region1)  â”‚  â”‚  (Region2)  â”‚  â”‚  (Region3)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                â”‚                â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚  ä¸­å¤®èšåˆOAP   â”‚
               â”‚  (è”é‚¦ä¸­å¿ƒ)    â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```yaml
# è”é‚¦é…ç½®
cluster:
  selector: ${SW_CLUSTER:standalone}
  standalone:
  nacos:
    serverAddr: ${SW_CLUSTER_NACOS_HOST_PORT:nacos.global.com:8848}
    namespace: ${SW_CLUSTER_NACOS_NAMESPACE:skywalking-federation}
    
# å„Region OAPé…ç½®
core:
  default:
    # Regionæ ‡è¯†
    regionId: ${SW_REGION_ID:cn-hangzhou}
    # è”é‚¦ä¸­å¿ƒåœ°å€
    federationCenterAddress: ${SW_FEDERATION_CENTER:oap.global.com:12800}
```

### 9.3 è·¨äº‘ç½‘ç»œä¼˜åŒ–


**ç½‘ç»œä¸“çº¿é…ç½®**

```yaml
# ä½¿ç”¨äº‘è”ç½‘/ä¸“çº¿åŠ é€Ÿ
apiVersion: v1
kind: Service
metadata:
  name: skywalking-oap-cross-cloud
spec:
  type: LoadBalancer
  loadBalancerIP: 10.0.0.100  # ä¸“çº¿IP
  ports:
  - name: grpc
    port: 11800
    targetPort: 11800
  selector:
    app: skywalking-oap
```

**æ™ºèƒ½è·¯ç”±ç­–ç•¥**

```java
// Agentç«¯æ™ºèƒ½é€‰æ‹©æœ€è¿‘çš„OAP
@Configuration
public class SmartOAPSelector {
    
    public String selectOAP() {
        // è·å–å½“å‰äº‘å‚å•†
        String cloudProvider = detectCloudProvider();
        
        // ä¼˜å…ˆé€‰æ‹©åŒäº‘å‚å•†çš„OAP
        Map<String, String> oapMap = Map.of(
            "aliyun", "oap.aliyun.internal:11800",
            "aws", "oap.aws.internal:11800",
            "tencent", "oap.tencent.internal:11800"
        );
        
        String primaryOAP = oapMap.get(cloudProvider);
        
        // æµ‹è¯•è¿é€šæ€§
        if (isReachable(primaryOAP)) {
            return primaryOAP;
        }
        
        // é™çº§åˆ°å…¬ç½‘OAP
        return "oap.global.com:11800";
    }
}
```

### 9.4 æ··åˆäº‘ç›‘æ§æœ€ä½³å®è·µ


**å®è·µ1ï¼šç»Ÿä¸€æœåŠ¡å‘½å**

```java
// ç»Ÿä¸€çš„æœåŠ¡å‘½åè§„èŒƒ
agent.service_name=${CLOUD_PROVIDER}-${REGION}-${SERVICE_NAME}

ç¤ºä¾‹ï¼š
- aliyun-cn-hangzhou-order-service
- aws-us-east-1-payment-service
- idc-beijing-inventory-service

ä¼˜åŠ¿ï¼š
âœ“ ä¸€çœ¼çœ‹å‡ºæœåŠ¡æ‰€åœ¨ä½ç½®
âœ“ ä¾¿äºè·¨äº‘è¿½è¸ªåˆ†æ
âœ“ æ”¯æŒæŒ‰äº‘å‚å•†è¿‡æ»¤
```

**å®è·µ2ï¼šæˆæœ¬ä¼˜åŒ–**

```yaml
# åˆ†çº§å­˜å‚¨ç­–ç•¥
storage:
  elasticsearch:
    # çƒ­æ•°æ®ï¼šæœ€è¿‘7å¤©ï¼Œå­˜å‚¨åœ¨SSD
    hot:
      namespace: skywalking-hot
      clusterNodes: es-hot.aliyun.com:9200
      bulkActions: 5000
      retention: 7  # 7å¤©
    
    # æ¸©æ•°æ®ï¼š7-30å¤©ï¼Œå­˜å‚¨åœ¨HDD
    warm:
      namespace: skywalking-warm
      clusterNodes: es-warm.aliyun.com:9200
      retention: 30
    
    # å†·æ•°æ®ï¼š30å¤©ä»¥ä¸Šï¼Œå­˜å‚¨åœ¨å¯¹è±¡å­˜å‚¨
    cold:
      namespace: skywalking-cold
      clusterNodes: oss://skywalking-archive/
      retention: 365
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 é›†æˆä»·å€¼å›é¡¾


```
ğŸ¯ æ ¸å¿ƒæ”¶ç›Šï¼š
âœ“ æ•°æ®äº’é€šï¼šæ‰“ç ´ç›‘æ§å­¤å²›
âœ“ èƒ½åŠ›äº’è¡¥ï¼šå„ç³»ç»Ÿå‘æŒ¥æ‰€é•¿
âœ“ æ•ˆç‡æå‡ï¼šä¸€ç«™å¼é—®é¢˜å®šä½
âœ“ æ™ºèƒ½å†³ç­–ï¼šåŸºäºæ•°æ®è‡ªåŠ¨åŒ–
```

### 10.2 æŠ€æœ¯é€‰å‹æŒ‡å—


| é›†æˆç±»å‹ | é€‚ç”¨åœºæ™¯ | éš¾åº¦ | æ¨èåº¦ |
|---------|---------|------|--------|
| **Prometheus** | éœ€è¦ç³»ç»ŸæŒ‡æ ‡ç›‘æ§ | â­â­ | â­â­â­â­â­ |
| **Grafana** | éœ€è¦ä¸°å¯Œçš„å¯è§†åŒ– | â­ | â­â­â­â­â­ |
| **Istio** | æœåŠ¡ç½‘æ ¼ç¯å¢ƒ | â­â­â­ | â­â­â­â­ |
| **K8s** | å®¹å™¨åŒ–éƒ¨ç½² | â­â­ | â­â­â­â­â­ |
| **Sentinel** | éœ€è¦æµé‡æ²»ç† | â­â­ | â­â­â­â­ |

### 10.3 å®æ–½è·¯çº¿å›¾


**é˜¶æ®µ1ï¼šåŸºç¡€é›†æˆï¼ˆ1-2å‘¨ï¼‰**
```
âœ“ éƒ¨ç½²SkyWalkingåŸºç¡€ç¯å¢ƒ
âœ“ é›†æˆPrometheusé‡‡é›†ç³»ç»ŸæŒ‡æ ‡
âœ“ é…ç½®GrafanaåŸºç¡€ä»ªè¡¨ç›˜
```

**é˜¶æ®µ2ï¼šK8sé›†æˆï¼ˆ2-3å‘¨ï¼‰**
```
âœ“ é…ç½®K8sè‡ªåŠ¨æœåŠ¡å‘ç°
âœ“ å®ç°Sidecarè‡ªåŠ¨æ³¨å…¥
âœ“ å…³è”K8säº‹ä»¶ä¸è¿½è¸ª
```

**é˜¶æ®µ3ï¼šæœåŠ¡æ²»ç†ï¼ˆ3-4å‘¨ï¼‰**
```
âœ“ é›†æˆé™æµç†”æ–­ç»„ä»¶
âœ“ é…ç½®ç°åº¦å‘å¸ƒç›‘æ§
âœ“ å®ç°æ™ºèƒ½è·¯ç”±å†³ç­–
```

**é˜¶æ®µ4ï¼šæ··åˆäº‘æ‰©å±•ï¼ˆ4-6å‘¨ï¼‰**
```
âœ“ éƒ¨ç½²è·¨äº‘OAPé›†ç¾¤
âœ“ é…ç½®ç½‘ç»œä¸“çº¿
âœ“ å®æ–½ç»Ÿä¸€ç›‘æ§
```

### 10.4 å¸¸è§é—®é¢˜ä¸è§£å†³


**Q1ï¼šé›†æˆåæ€§èƒ½ä¸‹é™æ€ä¹ˆåŠï¼Ÿ**
```
åŸå› åˆ†æï¼š
- é‡‡æ ·ç‡è¿‡é«˜å¯¼è‡´èµ„æºæ¶ˆè€—
- ç½‘ç»œä¼ è¾“æ•°æ®é‡è¿‡å¤§

è§£å†³æ–¹æ¡ˆï¼š
âœ“ è°ƒæ•´é‡‡æ ·ç‡åˆ°1-10%
âœ“ å¯ç”¨æ•°æ®å‹ç¼©ä¼ è¾“
âœ“ ä½¿ç”¨å¼‚æ­¥å‘é€æœºåˆ¶
```

**Q2ï¼šè·¨äº‘è¿½è¸ªé“¾è·¯æ–­è£‚ï¼Ÿ**
```
åŸå› åˆ†æï¼š
- ç½‘ç»œä¸é€šå¯¼è‡´æ•°æ®ä¸¢å¤±
- TraceIDä¼ é€’å¤±è´¥

è§£å†³æ–¹æ¡ˆï¼š
âœ“ é…ç½®ä¸“çº¿æˆ–VPN
âœ“ æ£€æŸ¥HTTPå¤´ä¼ é€’é…ç½®
âœ“ ä½¿ç”¨ç»Ÿä¸€çš„OAPé›†ç¾¤
```

**Q3ï¼šæ•°æ®å­˜å‚¨æˆæœ¬è¿‡é«˜ï¼Ÿ**
```
è§£å†³æ–¹æ¡ˆï¼š
âœ“ å®æ–½åˆ†çº§å­˜å‚¨ç­–ç•¥
âœ“ é™ä½éå…³é”®æ•°æ®é‡‡æ ·ç‡
âœ“ å®šæœŸæ¸…ç†å†å²æ•°æ®
âœ“ ä½¿ç”¨å¯¹è±¡å­˜å‚¨å½’æ¡£
```

### 10.5 ä¸€å¥è¯æ€»ç»“


ğŸ’¡ **æ ¸å¿ƒç†å¿µ**ï¼š
```
SkyWalkingä¸æ˜¯å­¤å²›ï¼Œè€Œæ˜¯ç›‘æ§ç”Ÿæ€çš„"è¿æ¥å™¨"

é€šè¿‡é›†æˆï¼š
- Prometheusè¡¥å……ç³»ç»ŸæŒ‡æ ‡
- Grafanaå¢å¼ºå¯è§†åŒ–èƒ½åŠ›
- Istio/K8så®ç°æœåŠ¡æ²»ç†
- æ··åˆäº‘æ–¹æ¡ˆè¦†ç›–å…¨åœºæ™¯

æœ€ç»ˆå®ç°ï¼šå…¨æ ˆç›‘æ§ + æ™ºèƒ½è¿ç»´ + æˆæœ¬ä¼˜åŒ–
```

ğŸ¯ **è®°å¿†å£è¯€**ï¼š
```
é›†æˆç”Ÿæ€ä¸å­¤å•ï¼Œ
PrometheusæŒ‡æ ‡æ¥ç›¸ä¼´ã€‚
Grafanaç”»å›¾æ›´ç›´è§‚ï¼Œ
Istioæ²»ç†ä¿å¹³å®‰ã€‚
K8sè”åŠ¨æ•ˆç‡é«˜ï¼Œ
æ··åˆäº‘ä¸Šæ¶é‡‘æ¡¥ã€‚
è¿½è¸ªæŒ‡æ ‡æ—¥å¿—å…¨ï¼Œ
ä¸€ç«™ç›‘æ§ä¹æ— è¾¹ï¼
```