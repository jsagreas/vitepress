---
title: 1ã€SkyWalkingæ’ä»¶å¼€å‘å®è·µ
---
## ğŸ“š ç›®å½•

1. [SkyWalkingæ’ä»¶å¼€å‘åŸºç¡€](#1-SkyWalkingæ’ä»¶å¼€å‘åŸºç¡€)
2. [æ’ä»¶å¼€å‘æ ¸å¿ƒæœºåˆ¶](#2-æ’ä»¶å¼€å‘æ ¸å¿ƒæœºåˆ¶)
3. [æ‹¦æˆªå™¨ç¼–å†™å®æˆ˜](#3-æ‹¦æˆªå™¨ç¼–å†™å®æˆ˜)
4. [å¸¸è§æ¡†æ¶æ’ä»¶å¼€å‘](#4-å¸¸è§æ¡†æ¶æ’ä»¶å¼€å‘)
5. [æ’ä»¶æ‰“åŒ…ä¸éƒ¨ç½²](#5-æ’ä»¶æ‰“åŒ…ä¸éƒ¨ç½²)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ SkyWalkingæ’ä»¶å¼€å‘åŸºç¡€


### 1.1 ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰æ’ä»¶


**ğŸ¤” å®é™…åœºæ™¯é—®é¢˜**
```
é—®ï¼šSkyWalkingè‡ªå¸¦äº†å¾ˆå¤šæ’ä»¶ï¼Œä¸ºä»€ä¹ˆè¿˜è¦è‡ªå·±å¼€å‘ï¼Ÿ

ç­”ï¼šä¸‰ä¸ªå¸¸è§åŸå› 
1. å…¬å¸å†…éƒ¨æ¡†æ¶ï¼šç”¨äº†è‡ªç ”çš„RPCæ¡†æ¶ï¼Œå®˜æ–¹æ²¡æœ‰å¯¹åº”æ’ä»¶
2. ç‰¹æ®Šéœ€æ±‚ï¼šéœ€è¦è¿½è¸ªç‰¹å®šçš„ä¸šåŠ¡é€»è¾‘æˆ–æ€§èƒ½æŒ‡æ ‡
3. ç¬¬ä¸‰æ–¹ç»„ä»¶ï¼šä½¿ç”¨äº†å°ä¼—çš„ä¸­é—´ä»¶ï¼Œæ²¡æœ‰ç°æˆæ’ä»¶
```

**ğŸ’¡ ä¸€ä¸ªç”Ÿæ´»åŒ–çš„æ¯”å–»**
> SkyWalkingå°±åƒä¸€ä¸ªæ™ºèƒ½ç›‘æ§æ‘„åƒå¤´ç³»ç»Ÿï¼Œè‡ªå¸¦æ’ä»¶æ˜¯æ ‡å‡†é•œå¤´ï¼Œå¯ä»¥æ‹åˆ°å¸¸è§çš„åœºæ™¯ï¼ˆHTTPã€MySQLã€Redisç­‰ï¼‰ã€‚ä½†å¦‚æœä½ å®¶æœ‰ç‰¹æ®Šè§’è½ï¼ˆè‡ªç ”æ¡†æ¶ï¼‰ï¼Œå°±éœ€è¦å®šåˆ¶ä¸“å±é•œå¤´ï¼ˆè‡ªå®šä¹‰æ’ä»¶ï¼‰æ‰èƒ½ç›‘æ§åˆ°ã€‚

### 1.2 æ’ä»¶å¼€å‘æ•´ä½“æ€è·¯


**ğŸ“‹ å¼€å‘æµç¨‹æ¦‚è§ˆ**
```
ç¬¬ä¸€æ­¥ï¼šç¡®å®šç›®æ ‡
â†“ æ˜ç¡®è¦ç›‘æ§ä»€ä¹ˆç»„ä»¶/æ–¹æ³•
â†“
ç¬¬äºŒæ­¥ï¼šå®šä¹‰æ‹¦æˆªç‚¹
â†“ æ‰¾åˆ°éœ€è¦æ‹¦æˆªçš„ç±»å’Œæ–¹æ³•
â†“
ç¬¬ä¸‰æ­¥ï¼šç¼–å†™æ‹¦æˆªå™¨
â†“ å®ç°æ•°æ®é‡‡é›†é€»è¾‘
â†“
ç¬¬å››æ­¥ï¼šæ‰“åŒ…éƒ¨ç½²
â†“ ç”Ÿæˆæ’ä»¶jaråŒ…å¹¶åŠ è½½
â†“
ç¬¬äº”æ­¥ï¼šéªŒè¯æµ‹è¯•
â†“ ç¡®è®¤è¿½è¸ªæ•°æ®æ­£å¸¸ä¸ŠæŠ¥
```

### 1.3 æ’ä»¶å¼€å‘æ ¸å¿ƒæ¦‚å¿µ


**ğŸ”¸ å…³é”®ç»„ä»¶è¯´æ˜**

| ç»„ä»¶åç§° | **ä½œç”¨** | **é€šä¿—ç†è§£** |
|---------|---------|-------------|
| **Instrumentation** | `å®šä¹‰æ‹¦æˆªè§„åˆ™` | å‘Šè¯‰SkyWalkingè¦ç›‘æ§å“ªä¸ªç±» |
| **Interceptor** | `æ‰§è¡Œæ‹¦æˆªé€»è¾‘` | å…·ä½“æ”¶é›†ä»€ä¹ˆæ•°æ® |
| **PluginDefine** | `æ’ä»¶å®šä¹‰ç±»` | æ’ä»¶çš„"èº«ä»½è¯" |
| **Witness** | `éªŒè¯ä¾èµ–å­˜åœ¨` | ç¡®ä¿ç›®æ ‡ç»„ä»¶çœŸçš„å­˜åœ¨ |

**ğŸ”¹ å·¥ä½œåŸç†ç¤ºæ„**
```
åº”ç”¨å¯åŠ¨æ—¶ï¼š
1. Agentæ‰«æpluginsç›®å½•
   â””â”€ å‘ç°ä½ çš„æ’ä»¶jaråŒ…
   
2. åŠ è½½PluginDefineé…ç½®
   â””â”€ çŸ¥é“è¦æ‹¦æˆªå“ªäº›ç±»
   
3. å­—èŠ‚ç å¢å¼º
   â””â”€ åœ¨ç›®æ ‡æ–¹æ³•å‰åæ’å…¥ç›‘æ§ä»£ç 
   
åº”ç”¨è¿è¡Œæ—¶ï¼š
4. æ–¹æ³•è¢«è°ƒç”¨
   â””â”€ è§¦å‘Interceptoré€»è¾‘
   
5. é‡‡é›†è¿½è¸ªæ•°æ®
   â””â”€ ä¸ŠæŠ¥åˆ°OAPæœåŠ¡å™¨
```

---

## 2. âš™ï¸ æ’ä»¶å¼€å‘æ ¸å¿ƒæœºåˆ¶


### 2.1 æ’ä»¶å¼€å‘æ¡†æ¶ç»“æ„


**ğŸ“¦ å¿…éœ€çš„ä¾èµ–åŒ…**
```xml
<!-- SkyWalkingæ’ä»¶å¼€å‘æ ¸å¿ƒä¾èµ– -->
<dependency>
    <groupId>org.apache.skywalking</groupId>
    <artifactId>apm-agent-core</artifactId>
    <version>9.0.0</version>
    <scope>provided</scope>
</dependency>
```

> âš ï¸ **æ³¨æ„**ï¼š`scope`å¿…é¡»æ˜¯`provided`ï¼Œå› ä¸ºè¿è¡Œæ—¶ç”±Agentæä¾›ï¼Œä¸éœ€è¦æ‰“åŒ…è¿›å»ã€‚

**ğŸ—ï¸ æ’ä»¶é¡¹ç›®ç»“æ„**
```
my-custom-plugin/
â”œâ”€â”€ src/main/java/
â”‚   â””â”€â”€ com/example/skywalking/
â”‚       â”œâ”€â”€ define/              â† æ’ä»¶å®šä¹‰
â”‚       â”‚   â””â”€â”€ MyFrameworkInstrumentation.java
â”‚       â””â”€â”€ interceptor/         â† æ‹¦æˆªå™¨å®ç°
â”‚           â””â”€â”€ MyMethodInterceptor.java
â””â”€â”€ src/main/resources/
    â””â”€â”€ skywalking-plugin.def    â† æ’ä»¶å£°æ˜æ–‡ä»¶
```

### 2.2 æ’ä»¶å®šä¹‰æ ¸å¿ƒä»£ç 


**ğŸ“ å®šä¹‰æ’ä»¶æ‹¦æˆªè§„åˆ™**
```java
// ç¬¬ä¸€æ­¥ï¼šç»§æ‰¿ClassInstanceMethodsEnhancePluginDefine
public class MyFrameworkInstrumentation extends ClassInstanceMethodsEnhancePluginDefine {
    
    // å®šä¹‰è¦æ‹¦æˆªçš„ç±»åï¼ˆå¯ä»¥ç”¨é€šé…ç¬¦ï¼‰
    @Override
    protected ClassMatch enhanceClass() {
        return NameMatch.byName("com.example.MyRpcClient");
    }
    
    // å®šä¹‰è¦æ‹¦æˆªçš„æ–¹æ³•
    @Override
    public InstanceMethodsInterceptPoint[] getInstanceMethodsInterceptPoints() {
        return new InstanceMethodsInterceptPoint[] {
            new InstanceMethodsInterceptPoint() {
                // æ–¹æ³•åŒ¹é…è§„åˆ™
                @Override
                public ElementMatcher<MethodDescription> getMethodsMatcher() {
                    return named("invoke")  // æ‹¦æˆªåä¸ºinvokeçš„æ–¹æ³•
                        .and(takesArguments(2));  // ä¸”æœ‰2ä¸ªå‚æ•°
                }
                
                // æŒ‡å®šæ‹¦æˆªå™¨ç±»
                @Override
                public String getMethodsInterceptor() {
                    return "com.example.skywalking.interceptor.MyMethodInterceptor";
                }
                
                @Override
                public boolean isOverrideArgs() {
                    return false;  // æ˜¯å¦ä¿®æ”¹æ–¹æ³•å‚æ•°
                }
            }
        };
    }
}
```

**ğŸ” ä»£ç è¯¦è§£**
- `enhanceClass()`ï¼šå‘Šè¯‰SkyWalkingè¦ç›‘æ§å“ªä¸ªç±»
- `getMethodsMatcher()`ï¼šç²¾ç¡®åŒ¹é…è¦æ‹¦æˆªçš„æ–¹æ³•
- `getMethodsInterceptor()`ï¼šæŒ‡å®šæ‹¦æˆªå™¨ç±»çš„å…¨é™å®šå

### 2.3 æ’ä»¶åŠ è½½æœºåˆ¶


**ğŸ”§ æ’ä»¶å£°æ˜æ–‡ä»¶**

åˆ›å»º `skywalking-plugin.def` æ–‡ä»¶ï¼š
```properties
# æ ¼å¼ï¼šæ’ä»¶å=æ’ä»¶å®šä¹‰ç±»å…¨è·¯å¾„
my-custom-plugin=com.example.skywalking.define.MyFrameworkInstrumentation
```

**ğŸ“Š åŠ è½½æµç¨‹å›¾ç¤º**
```
Agentå¯åŠ¨
   |
   â”œâ”€ è¯»å– skywalking-plugin.def
   |     â””â”€ å‘ç°ï¼šmy-custom-plugin=xxx.MyFrameworkInstrumentation
   |
   â”œâ”€ åŠ è½½æ’ä»¶å®šä¹‰ç±»
   |     â””â”€ è§£ææ‹¦æˆªè§„åˆ™ï¼ˆç±»åã€æ–¹æ³•åï¼‰
   |
   â”œâ”€ å­—èŠ‚ç å¢å¼º
   |     â””â”€ åœ¨ç›®æ ‡æ–¹æ³•å‰åæ’å…¥ç›‘æ§ä»£ç 
   |
   â””â”€ åº”ç”¨å¯åŠ¨å®Œæˆ
         â””â”€ æ’ä»¶æ¿€æ´»ï¼Œå¼€å§‹é‡‡é›†æ•°æ®
```

---

## 3. ğŸ”¨ æ‹¦æˆªå™¨ç¼–å†™å®æˆ˜


### 3.1 æ‹¦æˆªå™¨æ¥å£è¯¦è§£


**ğŸ¯ æ ¸å¿ƒæ¥å£ï¼šInstanceMethodsAroundInterceptor**
```java
public class MyMethodInterceptor implements InstanceMethodsAroundInterceptor {
    
    // æ–¹æ³•æ‰§è¡Œå‰è°ƒç”¨
    @Override
    public void beforeMethod(EnhancedInstance objInst, 
                            Method method, 
                            Object[] allArguments, 
                            Class<?>[] argumentsTypes,
                            MethodInterceptResult result) {
        // é‡‡é›†æ–¹æ³•è°ƒç”¨å‰çš„ä¿¡æ¯
    }
    
    // æ–¹æ³•æ‰§è¡Œåè°ƒç”¨
    @Override
    public Object afterMethod(EnhancedInstance objInst, 
                             Method method, 
                             Object[] allArguments,
                             Class<?>[] argumentsTypes, 
                             Object ret) {
        // é‡‡é›†æ–¹æ³•è°ƒç”¨åçš„ä¿¡æ¯
        return ret;  // å¿…é¡»è¿”å›åŸå§‹è¿”å›å€¼
    }
    
    // æ–¹æ³•æŠ›å¼‚å¸¸æ—¶è°ƒç”¨
    @Override
    public void handleMethodException(EnhancedInstance objInst, 
                                      Method method,
                                      Object[] allArguments, 
                                      Class<?>[] argumentsTypes,
                                      Throwable t) {
        // è®°å½•å¼‚å¸¸ä¿¡æ¯
    }
}
```

**ğŸ’¡ å‚æ•°è¯´æ˜**

| å‚æ•°å | **å«ä¹‰** | **ç”¨é€”** |
|-------|---------|---------|
| `objInst` | è¢«æ‹¦æˆªçš„å¯¹è±¡å®ä¾‹ | è·å–å¯¹è±¡çŠ¶æ€ä¿¡æ¯ |
| `method` | è¢«æ‹¦æˆªçš„æ–¹æ³• | è·å–æ–¹æ³•åç­‰å…ƒä¿¡æ¯ |
| `allArguments` | æ–¹æ³•å‚æ•°æ•°ç»„ | è·å–è°ƒç”¨å‚æ•° |
| `result` | æ–¹æ³•æ‹¦æˆªç»“æœ | å¯ä»¥è·³è¿‡åŸæ–¹æ³•æ‰§è¡Œ |
| `ret` | æ–¹æ³•è¿”å›å€¼ | è®°å½•è¿”å›æ•°æ® |
| `t` | å¼‚å¸¸å¯¹è±¡ | è®°å½•å¼‚å¸¸ä¿¡æ¯ |

### 3.2 åˆ›å»ºSpanå®æˆ˜ç¤ºä¾‹


**ğŸš€ å®Œæ•´æ‹¦æˆªå™¨å®ç°**
```java
public class RpcClientInterceptor implements InstanceMethodsAroundInterceptor {
    
    @Override
    public void beforeMethod(EnhancedInstance objInst, Method method, 
                            Object[] allArguments, Class<?>[] argumentsTypes,
                            MethodInterceptResult result) {
        
        // 1. åˆ›å»ºSpanï¼ˆä»£è¡¨ä¸€æ¬¡æ“ä½œï¼‰
        AbstractSpan span = ContextManager.createExitSpan(
            "MyRPC/invoke",           // æ“ä½œåç§°
            (String) allArguments[0]  // è¿œç¨‹åœ°å€
        );
        
        // 2. è®¾ç½®ç»„ä»¶ä¿¡æ¯
        span.setComponent(ComponentsDefine.DUBBO);  // ä½¿ç”¨å·²æœ‰ç»„ä»¶ID
        
        // 3. è®¾ç½®ä¸ºå®¢æˆ·ç«¯ç±»å‹
        SpanLayer.asRPCFramework(span);
        
        // 4. æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾
        span.tag("rpc.method", method.getName());
        span.tag("rpc.target", (String) allArguments[0]);
    }
    
    @Override
    public Object afterMethod(EnhancedInstance objInst, Method method,
                             Object[] allArguments, Class<?>[] argumentsTypes,
                             Object ret) {
        
        // ç»“æŸSpanï¼ˆä¼šè‡ªåŠ¨è®¡ç®—è€—æ—¶ï¼‰
        ContextManager.stopSpan();
        return ret;
    }
    
    @Override
    public void handleMethodException(EnhancedInstance objInst, Method method,
                                      Object[] allArguments, Class<?>[] argumentsTypes,
                                      Throwable t) {
        
        // è®°å½•å¼‚å¸¸åˆ°Span
        ContextManager.activeSpan().log(t);
    }
}
```

**ğŸ” å…³é”®APIè§£é‡Š**

```
ContextManager.createExitSpan()   â† åˆ›å»ºå®¢æˆ·ç«¯è°ƒç”¨Span
ContextManager.createEntrySpan()  â† åˆ›å»ºæœåŠ¡ç«¯æ¥æ”¶Span  
ContextManager.createLocalSpan()  â† åˆ›å»ºæœ¬åœ°æ–¹æ³•Span

span.setComponent()               â† è®¾ç½®ç»„ä»¶ç±»å‹
SpanLayer.asRPCFramework()        â† æ ‡è®°ä¸ºRPCè°ƒç”¨
span.tag(key, value)              â† æ·»åŠ è¿½è¸ªæ ‡ç­¾
span.log(throwable)               â† è®°å½•å¼‚å¸¸ä¿¡æ¯
```

### 3.3 è·¨è¿›ç¨‹è¿½è¸ªå®ç°


**ğŸŒ ä¼ é€’è¿½è¸ªä¸Šä¸‹æ–‡**
```java
public class RpcClientInterceptor implements InstanceMethodsAroundInterceptor {
    
    @Override
    public void beforeMethod(...) {
        AbstractSpan span = ContextManager.createExitSpan(...);
        
        // è·å–ä¸Šä¸‹æ–‡è½½ä½“ï¼ˆç”¨äºè·¨è¿›ç¨‹ä¼ é€’ï¼‰
        ContextCarrier contextCarrier = new ContextCarrier();
        ContextManager.inject(contextCarrier);
        
        // å°†è¿½è¸ªä¿¡æ¯æ³¨å…¥åˆ°RPCè¯·æ±‚å¤´
        RpcRequest request = (RpcRequest) allArguments[1];
        
        // æŠŠè¿½è¸ªIDç­‰ä¿¡æ¯æ”¾åˆ°è¯·æ±‚å¤´
        for (CarrierItem item : contextCarrier.items()) {
            request.addHeader(item.getHeadKey(), item.getHeadValue());
        }
    }
}
```

**ğŸ“¡ æ¥æ”¶ç«¯æå–ä¸Šä¸‹æ–‡**
```java
public class RpcServerInterceptor implements InstanceMethodsAroundInterceptor {
    
    @Override
    public void beforeMethod(...) {
        // ä»è¯·æ±‚å¤´æå–è¿½è¸ªä¿¡æ¯
        RpcRequest request = (RpcRequest) allArguments[0];
        ContextCarrier contextCarrier = new ContextCarrier();
        
        for (CarrierItem item : contextCarrier.items()) {
            String value = request.getHeader(item.getHeadKey());
            item.setHeadValue(value);
        }
        
        // åˆ›å»ºSpanå¹¶å…³è”ä¸Šæ¸¸è¿½è¸ª
        AbstractSpan span = ContextManager.createEntrySpan(
            "MyRPC/receive", 
            null
        );
        ContextManager.extract(contextCarrier);  // å…³è”ä¸Šæ¸¸
    }
}
```

---

## 4. ğŸ› ï¸ å¸¸è§æ¡†æ¶æ’ä»¶å¼€å‘


### 4.1 MySQLæ’ä»¶å¼€å‘ç¤ºä¾‹


**ğŸ¯ ç›‘æ§ç›®æ ‡ï¼šJDBCæ‰§è¡ŒSQLè¯­å¥**
```java
// å®šä¹‰æ‹¦æˆªJDBC Statement
public class JdbcStatementInstrumentation extends ClassInstanceMethodsEnhancePluginDefine {
    
    @Override
    protected ClassMatch enhanceClass() {
        // æ‹¦æˆªJDBCçš„Statementå®ç°ç±»
        return MultiClassNameMatch.byMultiClassMatch(
            "com.mysql.jdbc.StatementImpl",
            "com.mysql.cj.jdbc.StatementImpl"
        );
    }
    
    @Override
    public InstanceMethodsInterceptPoint[] getInstanceMethodsInterceptPoints() {
        return new InstanceMethodsInterceptPoint[] {
            new InstanceMethodsInterceptPoint() {
                @Override
                public ElementMatcher<MethodDescription> getMethodsMatcher() {
                    // æ‹¦æˆªexecuteå¼€å¤´çš„æ–¹æ³•
                    return named("execute")
                        .or(named("executeQuery"))
                        .or(named("executeUpdate"));
                }
                
                @Override
                public String getMethodsInterceptor() {
                    return "com.example.interceptor.JdbcStatementInterceptor";
                }
                
                @Override
                public boolean isOverrideArgs() {
                    return false;
                }
            }
        };
    }
}
```

**ğŸ“ æ‹¦æˆªå™¨å®ç°**
```java
public class JdbcStatementInterceptor implements InstanceMethodsAroundInterceptor {
    
    @Override
    public void beforeMethod(...) {
        // è·å–SQLè¯­å¥ï¼ˆç¬¬ä¸€ä¸ªå‚æ•°ï¼‰
        String sql = (String) allArguments[0];
        
        // åˆ›å»ºæ•°æ®åº“æ“ä½œSpan
        AbstractSpan span = ContextManager.createExitSpan(
            "MySQL/execute",
            "mysql-server:3306"  // æ•°æ®åº“åœ°å€
        );
        
        span.setComponent(ComponentsDefine.MYSQL_JDBC_DRIVER);
        SpanLayer.asDB(span);  // æ ‡è®°ä¸ºæ•°æ®åº“æ“ä½œ
        
        // è®°å½•SQLè¯­å¥
        span.tag(Tags.DB_STATEMENT, sql);
        span.tag(Tags.DB_TYPE, "mysql");
    }
    
    @Override
    public Object afterMethod(...) {
        ContextManager.stopSpan();
        return ret;
    }
}
```

### 4.2 Redisæ’ä»¶å¼€å‘ç¤ºä¾‹


**ğŸ¯ ç›‘æ§ç›®æ ‡ï¼šJediså®¢æˆ·ç«¯**
```java
public class JedisInstrumentation extends ClassInstanceMethodsEnhancePluginDefine {
    
    @Override
    protected ClassMatch enhanceClass() {
        return NameMatch.byName("redis.clients.jedis.Jedis");
    }
    
    @Override
    public InstanceMethodsInterceptPoint[] getInstanceMethodsInterceptPoints() {
        return new InstanceMethodsInterceptPoint[] {
            new InstanceMethodsInterceptPoint() {
                @Override
                public ElementMatcher<MethodDescription> getMethodsMatcher() {
                    // æ‹¦æˆªRediså‘½ä»¤æ–¹æ³•
                    return named("get").or(named("set"))
                        .or(named("del")).or(named("hget"));
                }
                
                @Override
                public String getMethodsInterceptor() {
                    return "com.example.interceptor.JedisInterceptor";
                }
                
                @Override
                public boolean isOverrideArgs() {
                    return false;
                }
            }
        };
    }
}
```

**ğŸ“ æ‹¦æˆªå™¨å®ç°**
```java
public class JedisInterceptor implements InstanceMethodsAroundInterceptor {
    
    @Override
    public void beforeMethod(...) {
        // åˆ›å»ºRedisæ“ä½œSpan
        AbstractSpan span = ContextManager.createExitSpan(
            "Redis/" + method.getName(),  // æ“ä½œåï¼šRedis/get
            "redis-server:6379"
        );
        
        span.setComponent(ComponentsDefine.JEDIS);
        SpanLayer.asCache(span);  // æ ‡è®°ä¸ºç¼“å­˜æ“ä½œ
        
        // è®°å½•Rediså‘½ä»¤å’Œkey
        span.tag("redis.command", method.getName());
        if (allArguments.length > 0) {
            span.tag("redis.key", String.valueOf(allArguments[0]));
        }
    }
    
    @Override
    public Object afterMethod(...) {
        ContextManager.stopSpan();
        return ret;
    }
}
```

### 4.3 Kafkaæ’ä»¶å¼€å‘ç¤ºä¾‹


**ğŸ¯ ç›‘æ§ç›®æ ‡ï¼šKafkaç”Ÿäº§è€…**
```java
public class KafkaProducerInstrumentation extends ClassInstanceMethodsEnhancePluginDefine {
    
    @Override
    protected ClassMatch enhanceClass() {
        return NameMatch.byName("org.apache.kafka.clients.producer.KafkaProducer");
    }
    
    @Override
    public InstanceMethodsInterceptPoint[] getInstanceMethodsInterceptPoints() {
        return new InstanceMethodsInterceptPoint[] {
            new InstanceMethodsInterceptPoint() {
                @Override
                public ElementMatcher<MethodDescription> getMethodsMatcher() {
                    return named("send");  // æ‹¦æˆªsendæ–¹æ³•
                }
                
                @Override
                public String getMethodsInterceptor() {
                    return "com.example.interceptor.KafkaProducerInterceptor";
                }
                
                @Override
                public boolean isOverrideArgs() {
                    return false;
                }
            }
        };
    }
}
```

**ğŸ“ æ‹¦æˆªå™¨å®ç°**
```java
public class KafkaProducerInterceptor implements InstanceMethodsAroundInterceptor {
    
    @Override
    public void beforeMethod(...) {
        ProducerRecord record = (ProducerRecord) allArguments[0];
        
        // åˆ›å»ºæ¶ˆæ¯å‘é€Span
        AbstractSpan span = ContextManager.createExitSpan(
            "Kafka/Producer/" + record.topic(),
            "kafka-broker:9092"
        );
        
        span.setComponent(ComponentsDefine.KAFKA_PRODUCER);
        SpanLayer.asMQ(span);  // æ ‡è®°ä¸ºæ¶ˆæ¯é˜Ÿåˆ—
        
        // è®°å½•Topicå’ŒKey
        span.tag("mq.topic", record.topic());
        if (record.key() != null) {
            span.tag("mq.key", String.valueOf(record.key()));
        }
    }
    
    @Override
    public Object afterMethod(...) {
        ContextManager.stopSpan();
        return ret;
    }
}
```

### 4.4 Dubboæ’ä»¶å¼€å‘ç¤ºä¾‹


**ğŸ¯ ç›‘æ§ç›®æ ‡ï¼šDubboæ¶ˆè´¹è€…è°ƒç”¨**
```java
public class DubboConsumerInstrumentation extends ClassInstanceMethodsEnhancePluginDefine {
    
    @Override
    protected ClassMatch enhanceClass() {
        return NameMatch.byName("org.apache.dubbo.rpc.proxy.AbstractProxyInvoker");
    }
    
    @Override
    public InstanceMethodsInterceptPoint[] getInstanceMethodsInterceptPoints() {
        return new InstanceMethodsInterceptPoint[] {
            new InstanceMethodsInterceptPoint() {
                @Override
                public ElementMatcher<MethodDescription> getMethodsMatcher() {
                    return named("invoke");
                }
                
                @Override
                public String getMethodsInterceptor() {
                    return "com.example.interceptor.DubboConsumerInterceptor";
                }
                
                @Override
                public boolean isOverrideArgs() {
                    return false;
                }
            }
        };
    }
}
```

**ğŸ“ æ‹¦æˆªå™¨å®ç°**
```java
public class DubboConsumerInterceptor implements InstanceMethodsAroundInterceptor {
    
    @Override
    public void beforeMethod(...) {
        Invocation invocation = (Invocation) allArguments[0];
        
        // è·å–æœåŠ¡ä¿¡æ¯
        String serviceName = invocation.getInvoker().getInterface().getName();
        String methodName = invocation.getMethodName();
        String remotePeer = invocation.getInvoker().getUrl().getAddress();
        
        // åˆ›å»ºRPCè°ƒç”¨Span
        AbstractSpan span = ContextManager.createExitSpan(
            serviceName + "." + methodName,
            remotePeer
        );
        
        span.setComponent(ComponentsDefine.DUBBO);
        SpanLayer.asRPCFramework(span);
        
        // è®°å½•Dubboç‰¹æœ‰ä¿¡æ¯
        span.tag("dubbo.service", serviceName);
        span.tag("dubbo.method", methodName);
    }
    
    @Override
    public Object afterMethod(...) {
        ContextManager.stopSpan();
        return ret;
    }
}
```

---

## 5. ğŸ“¦ æ’ä»¶æ‰“åŒ…ä¸éƒ¨ç½²


### 5.1 Mavenæ‰“åŒ…é…ç½®


**ğŸ”§ å®Œæ•´pom.xmlé…ç½®**
```xml
<project>
    <groupId>com.example</groupId>
    <artifactId>my-skywalking-plugin</artifactId>
    <version>1.0.0</version>
    <packaging>jar</packaging>

    <dependencies>
        <!-- SkyWalkingæ ¸å¿ƒä¾èµ– -->
        <dependency>
            <groupId>org.apache.skywalking</groupId>
            <artifactId>apm-agent-core</artifactId>
            <version>9.0.0</version>
            <scope>provided</scope>
        </dependency>
        
        <!-- å­—èŠ‚ç å¢å¼ºå·¥å…· -->
        <dependency>
            <groupId>net.bytebuddy</groupId>
            <artifactId>byte-buddy</artifactId>
            <version>1.12.10</version>
            <scope>provided</scope>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <!-- æ‰“åŒ…æ’ä»¶ -->
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-shade-plugin</artifactId>
                <version>3.2.4</version>
                <executions>
                    <execution>
                        <phase>package</phase>
                        <goals>
                            <goal>shade</goal>
                        </goals>
                        <configuration>
                            <!-- ä¸è¦æŠŠprovidedä¾èµ–æ‰“è¿›å» -->
                            <createDependencyReducedPom>false</createDependencyReducedPom>
                        </configuration>
                    </execution>
                </executions>
            </plugin>
        </plugins>
    </build>
</project>
```

**ğŸ“‹ æ‰“åŒ…æ­¥éª¤**
```bash
# 1. æ¸…ç†æ—§çš„æ„å»º
mvn clean

# 2. ç¼–è¯‘æ‰“åŒ…
mvn package

# 3. æŸ¥çœ‹ç”Ÿæˆçš„jaråŒ…
ls target/my-skywalking-plugin-1.0.0.jar
```

### 5.2 æ’ä»¶éƒ¨ç½²æ–¹å¼


**ğŸš€ éƒ¨ç½²åˆ°Agent**

**æ–¹å¼ä¸€ï¼šæ”¾å…¥pluginsç›®å½•ï¼ˆæ¨èï¼‰**
```bash
# 1. å¤åˆ¶jaråŒ…åˆ°Agentçš„pluginsç›®å½•
cp target/my-skywalking-plugin-1.0.0.jar \
   /path/to/skywalking-agent/plugins/

# 2. é‡å¯åº”ç”¨å³å¯ç”Ÿæ•ˆ
java -javaagent:/path/to/skywalking-agent/skywalking-agent.jar \
     -jar your-app.jar
```

**æ–¹å¼äºŒï¼šæ”¾å…¥optional-pluginsç›®å½•**
```bash
# é€‚ç”¨äºå¯é€‰æ’ä»¶ï¼ˆé»˜è®¤ä¸å¯ç”¨çš„æ’ä»¶ï¼‰
cp target/my-skywalking-plugin-1.0.0.jar \
   /path/to/skywalking-agent/optional-plugins/

# éœ€è¦æ—¶å†ç§»åŠ¨åˆ°pluginsç›®å½•å¯ç”¨
```

**ğŸ—‚ï¸ Agentç›®å½•ç»“æ„**
```
skywalking-agent/
â”œâ”€â”€ skywalking-agent.jar       â† Agentä¸»ç¨‹åº
â”œâ”€â”€ config/
â”‚   â””â”€â”€ agent.config           â† é…ç½®æ–‡ä»¶
â”œâ”€â”€ plugins/                   â† å¯ç”¨çš„æ’ä»¶
â”‚   â”œâ”€â”€ apm-jdbc-plugin.jar
â”‚   â”œâ”€â”€ apm-okhttp-plugin.jar
â”‚   â””â”€â”€ my-skywalking-plugin-1.0.0.jar  â† ä½ çš„æ’ä»¶
â””â”€â”€ optional-plugins/          â† å¯é€‰æ’ä»¶
    â””â”€â”€ apm-trace-ignore-plugin.jar
```

### 5.3 æ’ä»¶éªŒè¯æµ‹è¯•


**âœ… éªŒè¯æ’ä»¶æ˜¯å¦åŠ è½½æˆåŠŸ**

**æ–¹æ³•ä¸€ï¼šæŸ¥çœ‹Agentæ—¥å¿—**
```bash
# å¯åŠ¨åº”ç”¨æ—¶åŠ ä¸Šè°ƒè¯•å‚æ•°
java -javaagent:/path/to/skywalking-agent/skywalking-agent.jar \
     -Dskywalking.logging.level=DEBUG \
     -jar your-app.jar

# æŸ¥çœ‹æ—¥å¿—è¾“å‡º
tail -f skywalking-agent/logs/skywalking-api.log

# æˆåŠŸåŠ è½½ä¼šçœ‹åˆ°ï¼š
# [INFO] Plugin my-custom-plugin loaded successfully
# [DEBUG] Enhance class: com.example.MyRpcClient
```

**æ–¹æ³•äºŒï¼šæŸ¥çœ‹UIè¿½è¸ªæ•°æ®**
```
1. è§¦å‘ä¸šåŠ¡è°ƒç”¨
   â””â”€ è°ƒç”¨ä½¿ç”¨äº†æ’ä»¶çš„ä»£ç 

2. æ‰“å¼€SkyWalking UI
   â””â”€ http://localhost:8080

3. æŸ¥çœ‹Traceè¯¦æƒ…
   â””â”€ åº”è¯¥èƒ½çœ‹åˆ°è‡ªå®šä¹‰çš„Span
   â””â”€ æ“ä½œåã€æ ‡ç­¾ç­‰ä¿¡æ¯æ­£ç¡®æ˜¾ç¤º
```

**ğŸ” å¸¸è§é—®é¢˜æ’æŸ¥**

| é—®é¢˜ç°è±¡ | **å¯èƒ½åŸå› ** | **è§£å†³æ–¹æ³•** |
|---------|-------------|-------------|
| æ’ä»¶ä¸ç”Ÿæ•ˆ | `jaråŒ…æœªæ”¾å…¥pluginsç›®å½•` | æ£€æŸ¥æ–‡ä»¶è·¯å¾„ |
| ç±»æ‰¾ä¸åˆ° | `åŒ…åé…ç½®é”™è¯¯` | æ£€æŸ¥skywalking-plugin.def |
| æ–¹æ³•æœªæ‹¦æˆª | `æ–¹æ³•åŒ¹é…è§„åˆ™é”™è¯¯` | è°ƒæ•´getMethodsMatcher() |
| Spanæ•°æ®å¼‚å¸¸ | `æ‹¦æˆªå™¨é€»è¾‘é”™è¯¯` | æ£€æŸ¥beforeMethod/afterMethod |
| å†…å­˜æº¢å‡º | `Spanæœªæ­£ç¡®å…³é—­` | ç¡®ä¿æ¯ä¸ªSpanéƒ½è°ƒç”¨stopSpan() |

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ”¸ æ’ä»¶å¼€å‘ä¸‰è¦ç´ **
```
1. PluginDefineï¼ˆå®šä¹‰ï¼‰
   â†“ å‘Šè¯‰SkyWalkingç›‘æ§ä»€ä¹ˆ
   
2. Interceptorï¼ˆæ‹¦æˆªï¼‰
   â†“ å…·ä½“é‡‡é›†å“ªäº›æ•°æ®
   
3. skywalking-plugin.defï¼ˆå£°æ˜ï¼‰
   â†“ è®©Agentèƒ½æ‰¾åˆ°ä½ çš„æ’ä»¶
```

**ğŸ”¸ å…³é”®APIé€ŸæŸ¥**
```java
// åˆ›å»ºSpan
ContextManager.createExitSpan()   // å®¢æˆ·ç«¯è°ƒç”¨
ContextManager.createEntrySpan()  // æœåŠ¡ç«¯æ¥æ”¶
ContextManager.createLocalSpan()  // æœ¬åœ°æ–¹æ³•

// ç»“æŸSpan
ContextManager.stopSpan()         // å¿…é¡»è°ƒç”¨ï¼

// è·¨è¿›ç¨‹è¿½è¸ª
ContextCarrier carrier = new ContextCarrier();
ContextManager.inject(carrier);   // æ³¨å…¥ä¸Šä¸‹æ–‡
ContextManager.extract(carrier);  // æå–ä¸Šä¸‹æ–‡

// è®¾ç½®Spanå±æ€§
span.setComponent()               // ç»„ä»¶ç±»å‹
span.tag(key, value)             // æ·»åŠ æ ‡ç­¾
span.log(throwable)              // è®°å½•å¼‚å¸¸
SpanLayer.asXXX(span)            // è®¾ç½®å±‚çº§
```

### 6.2 å¼€å‘æµç¨‹æ€»ç»“


**ğŸ“ æ ‡å‡†å¼€å‘æ­¥éª¤**
```
ç¬¬1æ­¥ï¼šåˆ†æç›®æ ‡ç»„ä»¶
â”œâ”€ ç¡®å®šè¦ç›‘æ§çš„ç±»å’Œæ–¹æ³•
â””â”€ äº†è§£æ–¹æ³•å‚æ•°å’Œè¿”å›å€¼

ç¬¬2æ­¥ï¼šç¼–å†™PluginDefine
â”œâ”€ ç»§æ‰¿ClassInstanceMethodsEnhancePluginDefine
â”œâ”€ å®ç°enhanceClass()æŒ‡å®šç›®æ ‡ç±»
â””â”€ å®ç°getInstanceMethodsInterceptPoints()å®šä¹‰æ‹¦æˆªç‚¹

ç¬¬3æ­¥ï¼šç¼–å†™Interceptor
â”œâ”€ å®ç°InstanceMethodsAroundInterceptoræ¥å£
â”œâ”€ beforeMethod()åˆ›å»ºSpanå¹¶é‡‡é›†ä¿¡æ¯
â”œâ”€ afterMethod()ç»“æŸSpan
â””â”€ handleMethodException()å¤„ç†å¼‚å¸¸

ç¬¬4æ­¥ï¼šåˆ›å»ºæ’ä»¶å£°æ˜
â”œâ”€ åˆ›å»ºskywalking-plugin.defæ–‡ä»¶
â””â”€ å†™å…¥ï¼šæ’ä»¶å=PluginDefineç±»å…¨è·¯å¾„

ç¬¬5æ­¥ï¼šæ‰“åŒ…éƒ¨ç½²
â”œâ”€ mvn clean packageæ‰“åŒ…
â”œâ”€ å¤åˆ¶jaråˆ°pluginsç›®å½•
â””â”€ é‡å¯åº”ç”¨éªŒè¯
```

### 6.3 å®æˆ˜æ³¨æ„äº‹é¡¹


**âš ï¸ å¼€å‘ä¸­çš„å¸¸è§å‘**

```
âŒ å‘1ï¼šå¿˜è®°è°ƒç”¨stopSpan()
åæœï¼šSpanä¸€ç›´æ‰“å¼€ï¼Œå¯¼è‡´å†…å­˜æ³„æ¼
è§£å†³ï¼šfinallyå—ä¸­ç¡®ä¿è°ƒç”¨

âŒ å‘2ï¼šscopeè®¾ç½®é”™è¯¯
åæœï¼šä¾èµ–å†²çªæˆ–æ‰“åŒ…ä½“ç§¯è¿‡å¤§
è§£å†³ï¼šSkyWalkingä¾èµ–å¿…é¡»æ˜¯provided

âŒ å‘3ï¼šç±»ååŒ¹é…å¤ªå®½æ³›
åæœï¼šæ‹¦æˆªäº†ä¸è¯¥æ‹¦æˆªçš„ç±»ï¼Œæ€§èƒ½ä¸‹é™
è§£å†³ï¼šç²¾ç¡®åŒ¹é…ç±»åå’Œæ–¹æ³•

âŒ å‘4ï¼šå¿½ç•¥å¼‚å¸¸å¤„ç†
åæœï¼šå¼‚å¸¸ä¿¡æ¯ä¸¢å¤±ï¼Œæ’æŸ¥å›°éš¾
è§£å†³ï¼šå®ç°handleMethodException()

âŒ å‘5ï¼šè·¨è¿›ç¨‹è¿½è¸ªç¼ºå¤±
åæœï¼šè°ƒç”¨é“¾æ–­è£‚
è§£å†³ï¼šæ­£ç¡®ä½¿ç”¨ContextCarrierä¼ é€’ä¸Šä¸‹æ–‡
```

**âœ… æœ€ä½³å®è·µå»ºè®®**

```
1. æ€§èƒ½ä¼˜å…ˆ
   â”œâ”€ åªæ‹¦æˆªå¿…è¦çš„æ–¹æ³•
   â”œâ”€ é¿å…åœ¨æ‹¦æˆªå™¨ä¸­æ‰§è¡Œé‡æ“ä½œ
   â””â”€ åˆç†ä½¿ç”¨Witnessé¿å…æ— æ•ˆå¢å¼º

2. æ—¥å¿—å®Œå–„
   â”œâ”€ è®°å½•å…³é”®ä¸šåŠ¡ä¿¡æ¯åˆ°Tag
   â”œâ”€ å¼‚å¸¸å¿…é¡»è®°å½•åˆ°Span
   â””â”€ ä½¿ç”¨æœ‰æ„ä¹‰çš„æ“ä½œå

3. å…¼å®¹æ€§è€ƒè™‘
   â”œâ”€ é€‚é…å¤šä¸ªç‰ˆæœ¬çš„ç›®æ ‡æ¡†æ¶
   â”œâ”€ ä½¿ç”¨é€šé…ç¬¦åŒ¹é…ç±»å
   â””â”€ å¤„ç†å¥½æ–¹æ³•é‡è½½æƒ…å†µ

4. æµ‹è¯•å……åˆ†
   â”œâ”€ å•å…ƒæµ‹è¯•è¦†ç›–æ ¸å¿ƒé€»è¾‘
   â”œâ”€ é›†æˆæµ‹è¯•éªŒè¯è¿½è¸ªé“¾è·¯
   â””â”€ å‹æµ‹éªŒè¯æ€§èƒ½å½±å“
```

### 6.4 å­¦ä¹ è·¯å¾„å»ºè®®


**ğŸ“š è¿›é˜¶å­¦ä¹ é¡ºåº**
```
ç¬¬1é˜¶æ®µï¼šåŸºç¡€æŒæ¡
â”œâ”€ ç†è§£Agentå­—èŠ‚ç å¢å¼ºåŸç†
â”œâ”€ ç†Ÿæ‚‰æ’ä»¶å¼€å‘ä¸‰è¦ç´ 
â””â”€ å®Œæˆä¸€ä¸ªç®€å•æ’ä»¶ï¼ˆå¦‚HTTPå®¢æˆ·ç«¯ï¼‰

ç¬¬2é˜¶æ®µï¼šæ·±å…¥å®è·µ
â”œâ”€ å¼€å‘å¤šç§ç±»å‹æ’ä»¶ï¼ˆDBã€MQã€RPCï¼‰
â”œâ”€ æŒæ¡è·¨è¿›ç¨‹è¿½è¸ª
â””â”€ å¤„ç†å¤æ‚åœºæ™¯ï¼ˆå¼‚æ­¥ã€æ‰¹å¤„ç†ï¼‰

ç¬¬3é˜¶æ®µï¼šé«˜çº§å®šåˆ¶
â”œâ”€ å¼€å‘å…¬å¸å†…éƒ¨æ¡†æ¶æ’ä»¶
â”œâ”€ æ€§èƒ½ä¼˜åŒ–å’Œé—®é¢˜æ’æŸ¥
â””â”€ è´¡çŒ®æ’ä»¶åˆ°å¼€æºç¤¾åŒº
```

**ğŸ¯ æ ¸å¿ƒè®°å¿†å£è¯€**
```
æ’ä»¶å¼€å‘ä¸‰éƒ¨æ›²ï¼šå®šä¹‰ã€æ‹¦æˆªã€å£°æ˜
Spanç”Ÿå‘½å‘¨æœŸï¼šåˆ›å»ºã€è®¾ç½®ã€ç»“æŸ
è·¨è¿›ç¨‹è¿½è¸ªï¼šæ³¨å…¥ã€ä¼ é€’ã€æå–
éƒ¨ç½²éªŒè¯ï¼šæ‰“åŒ…ã€æ”¾å…¥ã€æµ‹è¯•
```

> ğŸ’¡ **æœ€åæé†’**ï¼šæ’ä»¶å¼€å‘çš„æ ¸å¿ƒæ˜¯ç†è§£"åœ¨å“ªé‡Œæ‹¦æˆª"å’Œ"é‡‡é›†ä»€ä¹ˆæ•°æ®"ï¼ŒæŒæ¡äº†è¿™ä¸¤ç‚¹ï¼Œå°±èƒ½ä¸ºä»»ä½•æ¡†æ¶å¼€å‘SkyWalkingæ’ä»¶ï¼