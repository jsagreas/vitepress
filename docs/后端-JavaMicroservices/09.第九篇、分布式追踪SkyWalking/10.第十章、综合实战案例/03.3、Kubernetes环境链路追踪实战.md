---
title: 3ã€Kubernetesç¯å¢ƒé“¾è·¯è¿½è¸ªå®æˆ˜
---
## ğŸ“š ç›®å½•

1. [K8sç¯å¢ƒé“¾è·¯è¿½è¸ªæ¦‚è¿°](#1-K8sç¯å¢ƒé“¾è·¯è¿½è¸ªæ¦‚è¿°)
2. [SkyWalkingåœ¨K8sä¸­çš„éƒ¨ç½²](#2-SkyWalkingåœ¨K8sä¸­çš„éƒ¨ç½²)
3. [Sidecaræ³¨å…¥æ–¹å¼](#3-Sidecaræ³¨å…¥æ–¹å¼)
4. [IstioæœåŠ¡ç½‘æ ¼é›†æˆ](#4-IstioæœåŠ¡ç½‘æ ¼é›†æˆ)
5. [Podçº§åˆ«ç›‘æ§å®æˆ˜](#5-Podçº§åˆ«ç›‘æ§å®æˆ˜)
6. [å®¹å™¨è¿½è¸ªæœ€ä½³å®è·µ](#6-å®¹å™¨è¿½è¸ªæœ€ä½³å®è·µ)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ K8sç¯å¢ƒé“¾è·¯è¿½è¸ªæ¦‚è¿°


### 1.1 ä¸ºä»€ä¹ˆK8sç¯å¢ƒéœ€è¦é“¾è·¯è¿½è¸ª


**ç†è§£K8sçš„ç‰¹æ®Šæ€§**

```
ä¼ ç»Ÿéƒ¨ç½² vs K8séƒ¨ç½²çš„åŒºåˆ«ï¼š

ä¼ ç»Ÿæ–¹å¼ï¼š
åº”ç”¨A â†’ åº”ç”¨B â†’ åº”ç”¨C
(å›ºå®šIPï¼Œä½ç½®ä¸å˜)

K8sæ–¹å¼ï¼š
Pod-A-1 â”€â”€â”
Pod-A-2 â”€â”€â”¼â†’ Service-B â†’ Pod-C-1
Pod-A-3 â”€â”€â”˜              Pod-C-2
(åŠ¨æ€IPï¼Œä½ç½®éšæ—¶å˜)
```

**æ ¸å¿ƒæŒ‘æˆ˜**
- **åŠ¨æ€æ€§**ï¼šPodéšæ—¶åˆ›å»ºé”€æ¯ï¼ŒIPåœ°å€ä¸å›ºå®š
- **åˆ†å¸ƒæ€§**ï¼šæœåŠ¡åˆ†æ•£åœ¨ä¸åŒèŠ‚ç‚¹ã€ä¸åŒå‘½åç©ºé—´
- **å¤æ‚æ€§**ï¼šæ¶‰åŠServiceã€Ingressã€ConfigMapç­‰å¤šå±‚æŠ½è±¡
- **å¯è§‚æµ‹æ€§å·®**ï¼šå®¹å™¨å†…éƒ¨å‘ç”Ÿä»€ä¹ˆå¾ˆéš¾ç›´æ¥çœ‹åˆ°

ğŸ¯ **é“¾è·¯è¿½è¸ªçš„ä»·å€¼**
```
æ²¡æœ‰è¿½è¸ªï¼š
ç”¨æˆ·åé¦ˆæ…¢ â†’ å“ªä¸ªPodæœ‰é—®é¢˜ï¼Ÿ â†’ ä¸€ä¸ªä¸ªPodæŸ¥æ—¥å¿— â†’ è€—æ—¶è´¹åŠ›

æœ‰äº†è¿½è¸ªï¼š
ç”¨æˆ·åé¦ˆæ…¢ â†’ æŸ¥çœ‹è¿½è¸ªé“¾è·¯ â†’ å®šä½åˆ°Pod-B-2å“åº”æ…¢ â†’ ç›´æ¥æ’æŸ¥
```

### 1.2 K8sç¯å¢ƒè¿½è¸ªæ¶æ„


**æ•´ä½“æ¶æ„å›¾**
```
â”Œâ”€ Kubernetesé›†ç¾¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                   â”‚
â”‚  â”Œâ”€ Namespace: app â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚                                      â”‚        â”‚
â”‚  â”‚  [Pod: service-a]                    â”‚        â”‚
â”‚  â”‚  â”œâ”€ åº”ç”¨å®¹å™¨ (å¸¦Agent)               â”‚        â”‚
â”‚  â”‚  â””â”€ Sidecarå®¹å™¨ (SkyWalking)         â”‚        â”‚
â”‚  â”‚         â”‚                            â”‚        â”‚
â”‚  â”‚         â†“ å‘é€è¿½è¸ªæ•°æ®               â”‚        â”‚
â”‚  â”‚  [Pod: service-b]                    â”‚        â”‚
â”‚  â”‚  â””â”€ åº”ç”¨å®¹å™¨ + Agent                 â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                   â”‚
â”‚  â”Œâ”€ Namespace: monitoring â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚                                      â”‚         â”‚
â”‚  â”‚  [Pod: SkyWalking OAP]              â”‚         â”‚
â”‚  â”‚  â”œâ”€ æ”¶é›†è¿½è¸ªæ•°æ®                     â”‚         â”‚
â”‚  â”‚  â””â”€ å­˜å‚¨åˆ°Elasticsearch              â”‚         â”‚
â”‚  â”‚                                      â”‚         â”‚
â”‚  â”‚  [Pod: SkyWalking UI]               â”‚         â”‚
â”‚  â”‚  â””â”€ å¯è§†åŒ–å±•ç¤º                       â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒç»„ä»¶**

| ç»„ä»¶ | ä½œç”¨ | éƒ¨ç½²å½¢å¼ |
|------|------|----------|
| **SkyWalking Agent** | é‡‡é›†åº”ç”¨è¿½è¸ªæ•°æ® | Sidecarå®¹å™¨ æˆ– Initå®¹å™¨æ³¨å…¥ |
| **SkyWalking OAP** | æ¥æ”¶å’Œå¤„ç†è¿½è¸ªæ•°æ® | Deployment (å¤šå‰¯æœ¬) |
| **SkyWalking UI** | å¯è§†åŒ–å±•ç¤ºç•Œé¢ | Deployment + Service |
| **Elasticsearch** | å­˜å‚¨è¿½è¸ªæ•°æ® | StatefulSet |

---

## 2. ğŸš€ SkyWalkingåœ¨K8sä¸­çš„éƒ¨ç½²


### 2.1 ä½¿ç”¨Helmå¿«é€Ÿéƒ¨ç½²


**ä»€ä¹ˆæ˜¯Helm**
```
ç®€å•ç†è§£ï¼š
Helmå°±æ˜¯K8sçš„"åº”ç”¨å•†åº—"
- ä¸€æ¡å‘½ä»¤å®‰è£…å¤æ‚åº”ç”¨
- è‡ªåŠ¨é…ç½®æ‰€æœ‰èµ„æº
- æ–¹ä¾¿å‡çº§å’Œå¸è½½
```

**æ­¥éª¤1ï¼šæ·»åŠ Helmä»“åº“**
```bash
# æ·»åŠ SkyWalkingå®˜æ–¹ä»“åº“
helm repo add skywalking https://apache.jfrog.io/artifactory/skywalking-helm

# æ›´æ–°ä»“åº“
helm repo update
```

**æ­¥éª¤2ï¼šå‡†å¤‡é…ç½®æ–‡ä»¶**
```yaml
# values.yaml - æ ¸å¿ƒé…ç½®è¯´æ˜
oap:
  replicas: 2                    # OAPå‰¯æœ¬æ•°ï¼Œå»ºè®®2ä¸ªä»¥ä¸Š
  resources:
    requests:
      cpu: 500m                  # æœ€å°‘éœ€è¦0.5æ ¸CPU
      memory: 1Gi                # æœ€å°‘éœ€è¦1GBå†…å­˜
    limits:
      cpu: 2                     # æœ€å¤šä½¿ç”¨2æ ¸CPU
      memory: 4Gi                # æœ€å¤šä½¿ç”¨4GBå†…å­˜
  
  storageType: elasticsearch7    # ä½¿ç”¨ESå­˜å‚¨

ui:
  replicas: 1                    # UIå‰¯æœ¬æ•°
  service:
    type: LoadBalancer           # å¯¹å¤–æš´éœ²æœåŠ¡
    port: 8080

elasticsearch:
  enabled: true                  # è‡ªåŠ¨éƒ¨ç½²ES
  replicas: 3                    # ESé›†ç¾¤èŠ‚ç‚¹æ•°
```

**æ­¥éª¤3ï¼šå®‰è£…SkyWalking**
```bash
# åˆ›å»ºç‹¬ç«‹çš„å‘½åç©ºé—´
kubectl create namespace skywalking

# ä½¿ç”¨Helmå®‰è£…
helm install skywalking skywalking/skywalking \
  -n skywalking \
  -f values.yaml

# æŸ¥çœ‹å®‰è£…çŠ¶æ€
kubectl get pods -n skywalking
```

**é¢„æœŸç»“æœ**
```
NAME                              READY   STATUS    
skywalking-oap-7b8c9d8f6b-abc12   1/1     Running   
skywalking-oap-7b8c9d8f6b-def34   1/1     Running   
skywalking-ui-6d5f8c9b7d-xyz89    1/1     Running   
elasticsearch-master-0            1/1     Running   
elasticsearch-master-1            1/1     Running   
elasticsearch-master-2            1/1     Running   
```

### 2.2 éªŒè¯éƒ¨ç½²æ˜¯å¦æˆåŠŸ


**æ£€æŸ¥Service**
```bash
kubectl get svc -n skywalking

# è¾“å‡ºç¤ºä¾‹
NAME              TYPE           EXTERNAL-IP    PORT(S)
skywalking-oap    ClusterIP      10.96.5.100    11800/TCP,12800/TCP
skywalking-ui     LoadBalancer   34.68.123.45   8080:30080/TCP
```

**è®¿é—®UIç•Œé¢**
```bash
# æ–¹å¼1: å¦‚æœæ˜¯LoadBalancerç±»å‹
æµè§ˆå™¨è®¿é—®ï¼šhttp://34.68.123.45:8080

# æ–¹å¼2: ä½¿ç”¨ç«¯å£è½¬å‘
kubectl port-forward -n skywalking svc/skywalking-ui 8080:8080
æµè§ˆå™¨è®¿é—®ï¼šhttp://localhost:8080
```

---

## 3. ğŸ’‰ Sidecaræ³¨å…¥æ–¹å¼


### 3.1 ä»€ä¹ˆæ˜¯Sidecaræ¨¡å¼


**ç”Ÿæ´»ç±»æ¯”ç†è§£**
```
ä¸»åº”ç”¨å®¹å™¨ = å¸æœºå¼€è½¦
Sidecarå®¹å™¨ = å‰¯é©¾é©¶å¯¼èˆªå‘˜

â”Œâ”€ Pod â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          â”‚
â”‚  [åº”ç”¨å®¹å™¨]    [Sidecar]  â”‚
â”‚   è¿è¡Œä¸šåŠ¡    æ”¶é›†è¿½è¸ª   â”‚
â”‚                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¥½å¤„ï¼š
- ä¸šåŠ¡ä»£ç ä¸ç”¨æ”¹
- è¿½è¸ªé€»è¾‘ç‹¬ç«‹ç»´æŠ¤
- å¯ä»¥éšæ—¶å¼€å¯/å…³é—­
```

### 3.2 æ‰‹åŠ¨Sidecaræ³¨å…¥


**ç¤ºä¾‹ï¼šä¸ºåº”ç”¨æ·»åŠ SkyWalking Agent**

```yaml
# app-with-sidecar.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: order-service
spec:
  replicas: 2
  template:
    metadata:
      labels:
        app: order-service
    spec:
      # å…±äº«å·ï¼šè®©ä¸¤ä¸ªå®¹å™¨å…±äº«Agentæ–‡ä»¶
      volumes:
      - name: skywalking-agent
        emptyDir: {}
      
      # Initå®¹å™¨ï¼šå¯åŠ¨å‰å‡†å¤‡Agent
      initContainers:
      - name: agent-init
        image: apache/skywalking-java-agent:9.0.0
        command:
        - sh
        - -c
        - cp -r /skywalking/agent /agent/
        volumeMounts:
        - name: skywalking-agent
          mountPath: /agent
      
      # ä¸»åº”ç”¨å®¹å™¨
      containers:
      - name: app
        image: your-order-service:v1.0
        env:
        # Javaå¯åŠ¨å‚æ•°ï¼šåŠ è½½Agent
        - name: JAVA_TOOL_OPTIONS
          value: "-javaagent:/agent/skywalking-agent.jar"
        # Agenté…ç½®
        - name: SW_AGENT_NAME
          value: "order-service"           # æœåŠ¡å
        - name: SW_AGENT_COLLECTOR_BACKEND_SERVICES
          value: "skywalking-oap.skywalking:11800"  # OAPåœ°å€
        volumeMounts:
        - name: skywalking-agent
          mountPath: /agent
```

**é…ç½®è§£é‡Š**
```
å·¥ä½œæµç¨‹ï¼š
1. Podå¯åŠ¨æ—¶ï¼ŒInitå®¹å™¨å…ˆè¿è¡Œ
2. Initå®¹å™¨å¤åˆ¶Agentåˆ°å…±äº«å·
3. ä¸»åº”ç”¨å®¹å™¨å¯åŠ¨ï¼Œè¯»å–å…±äº«å·ä¸­çš„Agent
4. Agentéšåº”ç”¨å¯åŠ¨ï¼Œå¼€å§‹æ”¶é›†è¿½è¸ªæ•°æ®
5. è¿½è¸ªæ•°æ®å‘é€åˆ°OAPæœåŠ¡
```

### 3.3 è‡ªåŠ¨Sidecaræ³¨å…¥


**ä½¿ç”¨Operatorå®ç°**

```yaml
# å®‰è£…SkyWalking Operator
kubectl apply -f https://github.com/apache/skywalking-swck/releases/download/v0.9.0/operator.yaml

# åˆ›å»ºæ³¨å…¥é…ç½®
apiVersion: operator.skywalking.apache.org/v1alpha1
kind: JavaAgent
metadata:
  name: default-java-agent
  namespace: default
spec:
  # é€‰æ‹©è¦æ³¨å…¥çš„Pod
  podSelector:
    matchLabels:
      swck-inject: enabled      # åªæ³¨å…¥å¸¦æ­¤æ ‡ç­¾çš„Pod
  
  # Agenté…ç½®
  agentConfiguration:
    serviceName: ${POD_NAME}    # ä½¿ç”¨Podåä½œä¸ºæœåŠ¡å
    backendService: skywalking-oap.skywalking:11800
```

**åº”ç”¨éƒ¨ç½²æ—¶è‡ªåŠ¨æ³¨å…¥**
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: product-service
spec:
  template:
    metadata:
      labels:
        app: product-service
        swck-inject: enabled    # æ·»åŠ è¿™ä¸ªæ ‡ç­¾å³å¯è‡ªåŠ¨æ³¨å…¥
    spec:
      containers:
      - name: app
        image: your-product-service:v1.0
        # ä¸éœ€è¦æ‰‹åŠ¨é…ç½®Agentï¼ŒOperatorä¼šè‡ªåŠ¨å¤„ç†
```

**è‡ªåŠ¨æ³¨å…¥çš„ä¼˜åŠ¿**
- âœ… å¼€å‘äººå‘˜æ— éœ€å…³å¿ƒAgenté…ç½®
- âœ… ç»Ÿä¸€ç®¡ç†æ‰€æœ‰æœåŠ¡çš„è¿½è¸ªé…ç½®
- âœ… æ–°æœåŠ¡éƒ¨ç½²æ—¶è‡ªåŠ¨å¯ç”¨è¿½è¸ª

---

## 4. ğŸŒ IstioæœåŠ¡ç½‘æ ¼é›†æˆ


### 4.1 ä¸ºä»€ä¹ˆè¦ç”¨Istio


**Service Meshçš„ä»·å€¼**
```
æ²¡æœ‰Service Meshï¼š
åº”ç”¨A â†’ åº”ç”¨B â†’ åº”ç”¨C
(æ¯ä¸ªåº”ç”¨è‡ªå·±å¤„ç†ï¼šé‡è¯•ã€è¶…æ—¶ã€è´Ÿè½½å‡è¡¡)

æœ‰Service Meshï¼š
åº”ç”¨A â†’ [Envoyä»£ç†] â†’ [Envoyä»£ç†] â†’ åº”ç”¨B
(Envoyç»Ÿä¸€å¤„ç†ï¼šé‡è¯•ã€è¶…æ—¶ã€è´Ÿè½½å‡è¡¡ã€è¿½è¸ª)
```

**Istio + SkyWalking çš„ç»„åˆ**
```
â”Œâ”€ Istioæ§åˆ¶è¿½è¸ª â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                 â”‚
â”‚  åº”ç”¨å‘èµ·è¯·æ±‚                   â”‚
â”‚    â†“                            â”‚
â”‚  Envoy Sidecar (ç”ŸæˆTrace ID)   â”‚
â”‚    â†“                            â”‚
â”‚  ä¼ é€’åˆ°ä¸‹æ¸¸æœåŠ¡                 â”‚
â”‚    â†“                            â”‚
â”‚  SkyWalking Agent (æ”¶é›†æ•°æ®)    â”‚
â”‚    â†“                            â”‚
â”‚  SkyWalking OAP (åˆ†æå±•ç¤º)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 é…ç½®Istioè¿½è¸ª


**æ­¥éª¤1ï¼šå¯ç”¨Istioè¿½è¸ª**
```yaml
# istio-config.yaml
apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
spec:
  meshConfig:
    # å¯ç”¨è¿½è¸ª
    enableTracing: true
    
    # é…ç½®é‡‡æ ·ç‡
    defaultConfig:
      tracing:
        sampling: 100.0        # 100%é‡‡æ ·ï¼ˆç”Ÿäº§ç¯å¢ƒå»ºè®®1-10%ï¼‰
        
        # é…ç½®è¿½è¸ªåç«¯ä¸ºSkyWalking
        zipkin:
          address: skywalking-oap.skywalking:11800
```

**æ­¥éª¤2ï¼šä¸ºåº”ç”¨å¯ç”¨Sidecaræ³¨å…¥**
```bash
# ç»™å‘½åç©ºé—´æ·»åŠ æ ‡ç­¾ï¼Œè‡ªåŠ¨æ³¨å…¥Envoy
kubectl label namespace default istio-injection=enabled

# é‡æ–°éƒ¨ç½²åº”ç”¨ä»¥æ³¨å…¥Sidecar
kubectl rollout restart deployment -n default
```

**æ­¥éª¤3ï¼šéªŒè¯è¿½è¸ªæ•ˆæœ**
```bash
# å‘èµ·æµ‹è¯•è¯·æ±‚
kubectl exec -it test-pod -- curl http://order-service/api/create

# åœ¨SkyWalking UIæŸ¥çœ‹
æµè§ˆå™¨è®¿é—®ï¼šhttp://skywalking-ui:8080
â†’ æ‹“æ‰‘å›¾ï¼šæŸ¥çœ‹æœåŠ¡è°ƒç”¨å…³ç³»
â†’ è¿½è¸ªï¼šæŸ¥çœ‹è¯·æ±‚é“¾è·¯è¯¦æƒ…
```

### 4.3 æœåŠ¡ç½‘æ ¼ç›‘æ§æŒ‡æ ‡


**Istioæä¾›çš„é¢å¤–ç›‘æ§**

| æŒ‡æ ‡ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|---------|------|------|
| **è¯·æ±‚é‡** | æ¯ç§’è¯·æ±‚æ•° | `order-service: 1200 req/s` |
| **æˆåŠŸç‡** | HTTP 2xxå æ¯” | `payment-service: 99.5%` |
| **å»¶è¿Ÿåˆ†å¸ƒ** | P50/P95/P99å»¶è¿Ÿ | `P99: 150ms` |
| **æµé‡æ¥æº** | è¯·æ±‚ä»å“ªä¸ªæœåŠ¡æ¥ | `90% from web-gateway` |

**å…³è”æŸ¥çœ‹**
```
åœºæ™¯ï¼šå‘ç°æ”¯ä»˜æœåŠ¡æˆåŠŸç‡ä¸‹é™

æ­¥éª¤1: Istio Grafana â†’ å‘ç°payment-serviceæˆåŠŸç‡90%
æ­¥éª¤2: SkyWalking UI â†’ æŸ¥çœ‹å¤±è´¥è¯·æ±‚çš„è¿½è¸ªé“¾è·¯
æ­¥éª¤3: å®šä½é—®é¢˜ â†’ å‘ç°æ˜¯ä¸‹æ¸¸æ•°æ®åº“è¿æ¥è¶…æ—¶
```

---

## 5. ğŸ“Š Podçº§åˆ«ç›‘æ§å®æˆ˜


### 5.1 ç›‘æ§Podå†…éƒ¨æŒ‡æ ‡


**é…ç½®ServiceMonitoré‡‡é›†PodæŒ‡æ ‡**
```yaml
apiVersion: v1
kind: Service
metadata:
  name: order-service-metrics
  labels:
    app: order-service
spec:
  ports:
  - name: metrics
    port: 9090              # PrometheusæŒ‡æ ‡ç«¯å£
    targetPort: 9090
  selector:
    app: order-service

---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: order-service-monitor
spec:
  selector:
    matchLabels:
      app: order-service
  endpoints:
  - port: metrics
    interval: 30s           # æ¯30ç§’é‡‡é›†ä¸€æ¬¡
    path: /actuator/prometheus
```

**åº”ç”¨æš´éœ²æŒ‡æ ‡**
```yaml
# application.yml (Spring Bootåº”ç”¨)
management:
  endpoints:
    web:
      exposure:
        include: prometheus, health
  metrics:
    export:
      prometheus:
        enabled: true
    tags:
      pod: ${POD_NAME}      # æ·»åŠ Podåç§°æ ‡ç­¾
      namespace: ${NAMESPACE}
```

### 5.2 å…³è”è¿½è¸ªä¸æŒ‡æ ‡


**åœ¨SkyWalkingä¸­æŸ¥çœ‹PodæŒ‡æ ‡**

```yaml
# é…ç½®SkyWalkingé‡‡é›†PrometheusæŒ‡æ ‡
apiVersion: v1
kind: ConfigMap
metadata:
  name: oap-config
  namespace: skywalking
data:
  application.yml: |
    receiver-meter:
      selector: ${SW_RECEIVER_METER:default}
      default:
        enabledRules:
          - name: prometheus-pod-metrics
            metricPrefix: pod_
```

**å®æˆ˜æ¡ˆä¾‹ï¼šå®šä½æ…¢Pod**
```
ç°è±¡ï¼šæŸä¸ªæ¥å£å¹³å‡å“åº”æ—¶é—´å˜æ…¢

åˆ†ææ­¥éª¤ï¼š
1. SkyWalkingæ‹“æ‰‘ â†’ å‘ç°order-serviceæ•´ä½“å˜æ…¢
2. Podåˆ—è¡¨ â†’ å‘ç°order-serviceæœ‰3ä¸ªPod
3. è¿½è¸ªè¯¦æƒ… â†’ å‘ç°æ…¢è¯·æ±‚éƒ½è·¯ç”±åˆ°Pod-2
4. æŒ‡æ ‡å¯¹æ¯”ï¼š
   - Pod-1: CPU 30%, Memory 500MB, å“åº”100ms
   - Pod-2: CPU 80%, Memory 1.5GB, å“åº”500ms  â† é—®é¢˜Pod
   - Pod-3: CPU 25%, Memory 450MB, å“åº”90ms
5. è§£å†³æ–¹æ¡ˆ â†’ é‡å¯Pod-2æˆ–è°ƒæ•´èµ„æºé™åˆ¶
```

---

## 6. ğŸ› ï¸ å®¹å™¨è¿½è¸ªæœ€ä½³å®è·µ


### 6.1 ç¯å¢ƒå˜é‡é…ç½®æŠ€å·§


**åŠ¨æ€é…ç½®Agent**
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: user-service
spec:
  template:
    spec:
      containers:
      - name: app
        env:
        # ä½¿ç”¨K8så­—æ®µè‡ªåŠ¨è®¾ç½®
        - name: SW_AGENT_NAME
          value: "user-service"
        
        - name: SW_INSTANCE_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name    # è‡ªåŠ¨è·å–Podåç§°
        
        - name: SW_AGENT_COLLECTOR_BACKEND_SERVICES
          value: "skywalking-oap.skywalking:11800"
        
        # é‡‡æ ·ç‡æ ¹æ®ç¯å¢ƒå˜åŒ–
        - name: SW_AGENT_SAMPLE
          value: "1"                      # å¼€å‘ç¯å¢ƒ100%
          # value: "0.1"                  # ç”Ÿäº§ç¯å¢ƒ10%
```

### 6.2 æ—¥å¿—ä¸è¿½è¸ªå…³è”


**é…ç½®æ—¥å¿—è¾“å‡ºTrace ID**
```yaml
# logback-spring.xml
<configuration>
  <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
    <encoder>
      <pattern>
        %d{HH:mm:ss.SSS} [%thread] %-5level [TraceID:%X{tid}] %logger{36} - %msg%n
      </pattern>
    </encoder>
  </appender>
</configuration>
```

**åº”ç”¨ä»£ç ä¸­æ‰“å°Trace ID**
```java
import org.apache.skywalking.apm.toolkit.trace.TraceContext;

@RestController
public class OrderController {
    
    @GetMapping("/create")
    public String createOrder() {
        // è·å–å½“å‰Trace ID
        String traceId = TraceContext.traceId();
        
        log.info("å¤„ç†è®¢å•ï¼ŒTraceID: {}", traceId);
        
        // è¿”å›ç»™å‰ç«¯ï¼Œæ–¹ä¾¿ç”¨æˆ·åé¦ˆé—®é¢˜æ—¶æä¾›
        return "è®¢å•åˆ›å»ºæˆåŠŸï¼Œè¿½è¸ªID: " + traceId;
    }
}
```

**é—®é¢˜æ’æŸ¥æµç¨‹**
```
ç”¨æˆ·åé¦ˆï¼šè®¢å•åˆ›å»ºå¤±è´¥

æ­¥éª¤1: ç”¨æˆ·æä¾›é”™è¯¯æˆªå›¾ï¼ŒåŒ…å«TraceID: abc123xyz
æ­¥éª¤2: åœ¨SkyWalkingæœç´¢TraceID
æ­¥éª¤3: æŸ¥çœ‹å®Œæ•´è°ƒç”¨é“¾è·¯
æ­¥éª¤4: å‘ç°åœ¨æ”¯ä»˜æœåŠ¡è°ƒç”¨æ—¶å¤±è´¥
æ­¥éª¤5: æŸ¥çœ‹å¯¹åº”Podçš„æ—¥å¿—ï¼Œå®šä½å…·ä½“é”™è¯¯åŸå› 
```

### 6.3 æ€§èƒ½ä¼˜åŒ–å»ºè®®


**é¿å…è¿½è¸ªå½±å“æ€§èƒ½**

| é…ç½®é¡¹ | æ¨èå€¼ | è¯´æ˜ |
|-------|--------|------|
| **é‡‡æ ·ç‡** | ç”Ÿäº§ç¯å¢ƒ1-10% | åªè¿½è¸ªéƒ¨åˆ†è¯·æ±‚ï¼Œå‡å°‘å¼€é”€ |
| **é˜Ÿåˆ—å¤§å°** | 5000 | å†…å­˜ç¼“å†²é˜Ÿåˆ—å¤§å° |
| **æ‰¹é‡å‘é€** | æ¯3ç§’æˆ–100æ¡ | å‡å°‘ç½‘ç»œè¯·æ±‚æ¬¡æ•° |
| **å¿½ç•¥è·¯å¾„** | `/health`, `/metrics` | å¥åº·æ£€æŸ¥ä¸éœ€è¦è¿½è¸ª |

**é…ç½®ç¤ºä¾‹**
```yaml
env:
- name: SW_AGENT_SAMPLE
  value: "0.05"                          # 5%é‡‡æ ·ç‡

- name: SW_AGENT_IGNORE_SUFFIX
  value: ".jpg,.css,.js,.ico,.health"   # å¿½ç•¥é™æ€èµ„æº

- name: SW_BUFFER_SIZE
  value: "5000"

- name: SW_BUFFER_OFFSET_MAX_FILE_SIZE
  value: "100"                           # 100MBç¼“å†²æ–‡ä»¶
```

### 6.4 æ•…éšœè¯Šæ–­æŠ€å·§


**å¸¸è§é—®é¢˜æ’æŸ¥**

**é—®é¢˜1ï¼šAgentæ— æ³•è¿æ¥OAP**
```bash
# æ£€æŸ¥Podæ—¥å¿—
kubectl logs <pod-name> -c app | grep skywalking

# å¸¸è§é”™è¯¯
Failed to connect to OAP server

# è§£å†³æ–¹æ¡ˆ
1. æ£€æŸ¥OAP Serviceæ˜¯å¦æ­£å¸¸
   kubectl get svc -n skywalking skywalking-oap
   
2. æ£€æŸ¥ç½‘ç»œç­–ç•¥æ˜¯å¦é˜»æ­¢
   kubectl get networkpolicy
   
3. éªŒè¯DNSè§£æ
   kubectl exec <pod-name> -- nslookup skywalking-oap.skywalking
```

**é—®é¢˜2ï¼šè¿½è¸ªæ•°æ®ä¸å®Œæ•´**
```yaml
# æ£€æŸ¥é‡‡æ ·ç‡è®¾ç½®
env:
- name: SW_AGENT_SAMPLE
  value: "1"              # æ”¹ä¸º100%é‡‡æ ·

# æ£€æŸ¥Spané™åˆ¶
- name: SW_AGENT_SPAN_LIMIT_PER_SEGMENT
  value: "500"            # å¢åŠ Spanæ•°é‡é™åˆ¶
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 éƒ¨ç½²æ¶æ„æ ¸å¿ƒ


```
K8s + SkyWalking å®Œæ•´é“¾è·¯ï¼š

ç”¨æˆ·è¯·æ±‚
  â†“
Ingress Controller (ç”Ÿæˆå…¥å£Trace)
  â†“
Service A (Pod-1, Pod-2, Pod-3)
  â”œâ”€ åº”ç”¨å®¹å™¨ (ä¸šåŠ¡é€»è¾‘)
  â””â”€ Agentå®¹å™¨ (æ”¶é›†è¿½è¸ª)
  â†“
Service B (Istio Envoyä»£ç†)
  â”œâ”€ æµé‡æ§åˆ¶
  â””â”€ è¿½è¸ªæ•°æ®ä¼ é€’
  â†“
SkyWalking OAP (åˆ†æå¤„ç†)
  â†“
Elasticsearch (å­˜å‚¨)
  â†“
SkyWalking UI (å¯è§†åŒ–)
```

### 7.2 å…³é”®çŸ¥è¯†ç‚¹å›é¡¾


**éƒ¨ç½²æ–¹å¼å¯¹æ¯”**

| æ–¹å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| **æ‰‹åŠ¨Sidecar** | å®Œå…¨å¯æ§ | é…ç½®ç¹ç | æµ‹è¯•ç¯å¢ƒ |
| **Operatorè‡ªåŠ¨æ³¨å…¥** | ç»Ÿä¸€ç®¡ç† | éœ€è¦é¢å¤–ç»„ä»¶ | ç”Ÿäº§ç¯å¢ƒ |
| **Istioé›†æˆ** | åŠŸèƒ½å¼ºå¤§ | å­¦ä¹ æˆæœ¬é«˜ | å¤§è§„æ¨¡å¾®æœåŠ¡ |

**æ ¸å¿ƒé…ç½®æ¸…å•**
```
å¿…é¡»é…ç½®ï¼š
âœ… AgentæœåŠ¡å (SW_AGENT_NAME)
âœ… OAPåç«¯åœ°å€ (SW_AGENT_COLLECTOR_BACKEND_SERVICES)
âœ… é‡‡æ ·ç‡ (SW_AGENT_SAMPLE)

å»ºè®®é…ç½®ï¼š
ğŸ”¸ å®ä¾‹åä½¿ç”¨Podå (${POD_NAME})
ğŸ”¸ å¿½ç•¥å¥åº·æ£€æŸ¥è·¯å¾„
ğŸ”¸ è®¾ç½®åˆç†çš„é˜Ÿåˆ—å¤§å°
ğŸ”¸ å…³è”æ—¥å¿—Trace ID
```

### 7.3 å®æˆ˜ç»éªŒæ€»ç»“


**æœ€ä½³å®è·µ**
- ğŸ¯ **æµ‹è¯•ç¯å¢ƒ100%é‡‡æ ·**ï¼Œç”Ÿäº§ç¯å¢ƒ1-10%
- ğŸ¯ **ä½¿ç”¨Operatorç»Ÿä¸€ç®¡ç†** Agenté…ç½®
- ğŸ¯ **ç»“åˆIstio** è·å¾—æ›´å¼ºå¤§çš„å¯è§‚æµ‹æ€§
- ğŸ¯ **æ—¥å¿—æ‰“å°Trace ID**ï¼Œæ–¹ä¾¿é—®é¢˜å®šä½
- ğŸ¯ **ç›‘æ§Agentèµ„æºå ç”¨**ï¼Œé¿å…å½±å“ä¸šåŠ¡

**å¸¸è§é™·é˜±**
- âš ï¸ é‡‡æ ·ç‡è®¾ç½®è¿‡ä½ï¼Œå…³é”®é—®é¢˜æ— æ³•è¿½è¸ª
- âš ï¸ å¿˜è®°é…ç½®DNSè§£æï¼ŒAgentè¿æ¥å¤±è´¥
- âš ï¸ èµ„æºé™åˆ¶è¿‡å°ï¼ŒAgenté¢‘ç¹é‡å¯
- âš ï¸ è¿½è¸ªæ‰€æœ‰è¯·æ±‚ï¼Œæ€§èƒ½ä¸¥é‡ä¸‹é™

**ä¸‹ä¸€æ­¥å­¦ä¹ **
1. æ·±å…¥å­¦ä¹ Istioæµé‡ç®¡ç†
2. æŒæ¡Prometheus + Grafanaé›†æˆ
3. äº†è§£åˆ†å¸ƒå¼è¿½è¸ªæ ‡å‡†(OpenTelemetry)
4. å®è·µå¤šé›†ç¾¤è¿½è¸ªæ–¹æ¡ˆ

---

**æ ¸å¿ƒè®°å¿†**ï¼š
- K8sç¯å¢ƒè¿½è¸ªå…³é”®åœ¨äºSidecaræ¨¡å¼
- Istioè®©è¿½è¸ªæ›´å¼ºå¤§ä½†ä¹Ÿæ›´å¤æ‚
- åˆç†é…ç½®é‡‡æ ·ç‡å¹³è¡¡æ€§èƒ½ä¸å¯è§‚æµ‹æ€§
- æ—¥å¿—ä¸è¿½è¸ªç»“åˆï¼Œé—®é¢˜æ’æŸ¥æ›´é«˜æ•ˆ