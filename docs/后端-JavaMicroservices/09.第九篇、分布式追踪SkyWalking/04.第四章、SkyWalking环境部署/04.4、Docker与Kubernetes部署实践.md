---
title: 4、Docker与Kubernetes部署实践
---
## 📚 目录

1. [Docker部署方式](#1-Docker部署方式)
2. [Kubernetes部署实战](#2-Kubernetes部署实战)
3. [Helm Chart快速部署](#3-Helm-Chart快速部署)
4. [生产环境高可用配置](#4-生产环境高可用配置)
5. [核心要点总结](#5-核心要点总结)

---

## 1. 🐳 Docker部署方式


### 1.1 什么是容器化部署


**通俗理解**：
```
传统部署就像买房子：
- 需要准备操作系统（地基）
- 安装各种依赖（装修）
- 配置环境变量（家具摆放）
- 非常繁琐，容易出错

Docker容器就像住酒店：
- 环境已经配置好（拎包入住）
- 随时可以换房间（快速迁移）
- 每个房间独立（互不影响）
- 标准化管理（统一服务）
```

**核心概念**：
- **镜像（Image）**：打包好的应用程序模板，就像装修好的样板房
- **容器（Container）**：运行中的镜像实例，就像实际入住的房间
- **Docker Compose**：管理多个容器的工具，就像物业管理多个房间

### 1.2 SkyWalking单机部署


**部署架构图**：
```
┌─────────────────────────────────────┐
│         宿主机（Host）               │
│  ┌──────────┐  ┌──────────────┐    │
│  │ SkyWalking│  │ ElasticSearch│    │
│  │  OAP容器  │  │    容器      │    │
│  │  端口11800│←→│   端口9200   │    │
│  └──────────┘  └──────────────┘    │
│         ↑                           │
│  ┌──────────┐                       │
│  │SkyWalking│                       │
│  │  UI容器  │                       │
│  │  端口8080│                       │
│  └──────────┘                       │
└─────────────────────────────────────┘
```

**Docker Compose配置**：
```yaml
version: '3.8'

services:
  # 存储层：Elasticsearch
  elasticsearch:
    image: elasticsearch:7.17.0
    container_name: elasticsearch
    environment:
      - discovery.type=single-node  # 单节点模式
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"  # 内存设置
    ports:
      - "9200:9200"
    volumes:
      - es-data:/usr/share/elasticsearch/data
    networks:
      - skywalking

  # 核心服务：OAP Server
  oap:
    image: apache/skywalking-oap-server:9.5.0
    container_name: skywalking-oap
    depends_on:
      - elasticsearch
    environment:
      SW_STORAGE: elasticsearch  # 使用ES存储
      SW_STORAGE_ES_CLUSTER_NODES: elasticsearch:9200
      SW_HEALTH_CHECKER: default
      SW_TELEMETRY: prometheus
    ports:
      - "11800:11800"  # gRPC端口
      - "12800:12800"  # REST端口
    networks:
      - skywalking

  # 界面层：UI
  ui:
    image: apache/skywalking-ui:9.5.0
    container_name: skywalking-ui
    depends_on:
      - oap
    environment:
      SW_OAP_ADDRESS: http://oap:12800
    ports:
      - "8080:8080"
    networks:
      - skywalking

networks:
  skywalking:
    driver: bridge

volumes:
  es-data:
```

> 💡 **配置说明**：
> - `depends_on`：定义服务启动顺序，确保ES先启动
> - `networks`：所有容器在同一网络，可以互相通信
> - `volumes`：持久化存储，防止数据丢失

**启动命令**：
```bash
# 启动所有服务
docker-compose up -d

# 查看运行状态
docker-compose ps

# 查看日志
docker-compose logs -f oap
```

### 1.3 容器化配置要点


**资源限制配置**：
```yaml
services:
  oap:
    image: apache/skywalking-oap-server:9.5.0
    deploy:
      resources:
        limits:
          cpus: '2.0'      # 最多使用2核CPU
          memory: 2G       # 最多使用2G内存
        reservations:
          cpus: '0.5'      # 至少保留0.5核
          memory: 512M     # 至少保留512M内存
```

**环境变量说明**：
```
SW_STORAGE=elasticsearch
  ├─ 含义：指定存储类型
  └─ 可选值：h2、mysql、elasticsearch、influxdb

SW_STORAGE_ES_CLUSTER_NODES=elasticsearch:9200
  ├─ 含义：ES集群地址
  └─ 格式：host:port，多个用逗号分隔

SW_CORE_GRPC_PORT=11800
  ├─ 含义：Agent上报数据的端口
  └─ 协议：gRPC高性能协议

SW_CORE_REST_PORT=12800
  ├─ 含义：提供HTTP查询接口
  └─ 用途：UI和其他服务查询数据
```

---

## 2. ☸️ Kubernetes部署实战


### 2.1 K8s部署优势


**为什么要用Kubernetes**：
```
Docker部署的局限：
❌ 手动管理多台服务器很麻烦
❌ 服务挂了需要人工重启
❌ 流量增大时无法自动扩容
❌ 版本更新需要手动操作

Kubernetes的优势：
✅ 自动化部署和管理
✅ 服务自愈（挂了自动重启）
✅ 弹性伸缩（自动增减实例）
✅ 滚动更新（无缝升级版本）
✅ 服务发现和负载均衡
```

**核心概念解释**：
```
Pod（容器组）：
  └─ 最小部署单元，包含一个或多个容器
  └─ 就像一个"盒子"，装着你的应用

Deployment（部署）：
  └─ 管理Pod的副本数量
  └─ 就像"工厂"，负责生产和管理Pod

Service（服务）：
  └─ 为Pod提供统一访问入口
  └─ 就像"前台"，负责接待和分配请求

ConfigMap/Secret：
  └─ 存储配置信息和敏感数据
  └─ 就像"配置中心"，统一管理配置
```

### 2.2 完整部署清单


**命名空间创建**：
```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: skywalking
```

**Elasticsearch部署**：
```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: elasticsearch
  namespace: skywalking
spec:
  serviceName: elasticsearch
  replicas: 1
  selector:
    matchLabels:
      app: elasticsearch
  template:
    metadata:
      labels:
        app: elasticsearch
    spec:
      containers:
      - name: elasticsearch
        image: elasticsearch:7.17.0
        env:
        - name: discovery.type
          value: single-node
        - name: ES_JAVA_OPTS
          value: "-Xms1g -Xmx1g"
        ports:
        - containerPort: 9200
          name: http
        - containerPort: 9300
          name: transport
        volumeMounts:
        - name: data
          mountPath: /usr/share/elasticsearch/data
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 10Gi

---
apiVersion: v1
kind: Service
metadata:
  name: elasticsearch
  namespace: skywalking
spec:
  ports:
  - port: 9200
    name: http
  - port: 9300
    name: transport
  selector:
    app: elasticsearch
```

> 📌 **StatefulSet说明**：
> - 用于有状态服务，保证Pod名称和存储的稳定性
> - `volumeClaimTemplates`：自动为每个Pod创建存储卷
> - 适合数据库、缓存等需要持久化的服务

**OAP Server部署**：
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: skywalking-oap
  namespace: skywalking
spec:
  replicas: 2  # 两个实例，高可用
  selector:
    matchLabels:
      app: skywalking-oap
  template:
    metadata:
      labels:
        app: skywalking-oap
    spec:
      containers:
      - name: oap
        image: apache/skywalking-oap-server:9.5.0
        env:
        - name: SW_STORAGE
          value: elasticsearch
        - name: SW_STORAGE_ES_CLUSTER_NODES
          value: elasticsearch:9200
        - name: JAVA_OPTS
          value: "-Xms2g -Xmx2g"
        ports:
        - containerPort: 11800
          name: grpc
        - containerPort: 12800
          name: rest
        livenessProbe:  # 存活检查
          tcpSocket:
            port: 12800
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:  # 就绪检查
          httpGet:
            path: /internal/l7check
            port: 12800
          initialDelaySeconds: 20
          periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: skywalking-oap
  namespace: skywalking
spec:
  type: ClusterIP
  ports:
  - port: 11800
    name: grpc
    targetPort: 11800
  - port: 12800
    name: rest
    targetPort: 12800
  selector:
    app: skywalking-oap
```

> 💡 **健康检查说明**：
> - `livenessProbe`：检查容器是否存活，失败则重启
> - `readinessProbe`：检查容器是否就绪，未就绪不接收流量
> - 这样可以避免将请求发送到未启动完成的Pod

**UI部署**：
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: skywalking-ui
  namespace: skywalking
spec:
  replicas: 1
  selector:
    matchLabels:
      app: skywalking-ui
  template:
    metadata:
      labels:
        app: skywalking-ui
    spec:
      containers:
      - name: ui
        image: apache/skywalking-ui:9.5.0
        env:
        - name: SW_OAP_ADDRESS
          value: http://skywalking-oap:12800
        ports:
        - containerPort: 8080

---
apiVersion: v1
kind: Service
metadata:
  name: skywalking-ui
  namespace: skywalking
spec:
  type: LoadBalancer  # 对外暴露服务
  ports:
  - port: 80
    targetPort: 8080
  selector:
    app: skywalking-ui
```

**部署执行**：
```bash
# 应用所有配置
kubectl apply -f skywalking-namespace.yaml
kubectl apply -f elasticsearch.yaml
kubectl apply -f oap.yaml
kubectl apply -f ui.yaml

# 查看部署状态
kubectl get pods -n skywalking

# 查看服务状态
kubectl get svc -n skywalking

# 查看Pod日志
kubectl logs -f skywalking-oap-xxx -n skywalking
```

### 2.3 服务发现机制


**K8s内部通信**：
```
场景1：Agent连接OAP
  Agent配置：SW_AGENT_COLLECTOR_BACKEND_SERVICES=skywalking-oap:11800
  └─ K8s DNS自动解析服务名到Pod IP
  └─ 实现负载均衡（轮询分发请求）

场景2：UI连接OAP
  环境变量：SW_OAP_ADDRESS=http://skywalking-oap:12800
  └─ Service提供统一入口
  └─ 后端有多个OAP Pod时自动负载均衡

通信流程：
Application → Agent → Service(skywalking-oap) → Pod1/Pod2/Pod3
                                                    ↓
                                              ElasticSearch
```

---

## 3. 🎯 Helm Chart快速部署


### 3.1 Helm是什么


**通俗理解**：
```
传统K8s部署：
├─ 需要编写多个YAML文件
├─ 手动管理配置参数
├─ 升级时要逐个修改文件
└─ 非常繁琐易出错

Helm的作用：
├─ 就像"应用商店"
├─ 一键安装整个应用
├─ 参数化配置（类似填表单）
└─ 一键升级和回滚
```

**核心概念**：
- **Chart**：应用程序包，包含所有K8s资源定义
- **Release**：Chart的运行实例，就像安装后的应用
- **Repository**：Chart仓库，就像应用商店

### 3.2 使用官方Chart部署


**添加仓库**：
```bash
# 添加SkyWalking官方仓库
helm repo add skywalking https://apache.jfrog.io/artifactory/skywalking-helm

# 更新仓库
helm repo update

# 搜索可用版本
helm search repo skywalking
```

**自定义配置**：
```yaml
# values.yaml
oap:
  replicas: 2  # OAP实例数
  javaOpts: "-Xms2g -Xmx2g"
  
  # 存储配置
  storageType: elasticsearch
  
  resources:
    limits:
      cpu: 2000m
      memory: 4Gi
    requests:
      cpu: 500m
      memory: 1Gi

ui:
  replicas: 1
  service:
    type: LoadBalancer  # 对外暴露

elasticsearch:
  enabled: true  # 启用内置ES
  minimumMasterNodes: 1
  replicas: 1
  
  # 持久化配置
  persistence:
    enabled: true
    size: 20Gi
```

**一键部署**：
```bash
# 安装SkyWalking
helm install skywalking skywalking/skywalking \
  --namespace skywalking \
  --create-namespace \
  --values values.yaml

# 查看安装状态
helm status skywalking -n skywalking

# 查看所有资源
kubectl get all -n skywalking

# 升级配置（修改values.yaml后）
helm upgrade skywalking skywalking/skywalking \
  --namespace skywalking \
  --values values.yaml

# 回滚到上一版本
helm rollback skywalking -n skywalking
```

> 🚀 **Helm优势**：
> - 5分钟内完成完整部署
> - 配置集中管理，修改方便
> - 支持版本管理和回滚
> - 社区维护，配置最佳实践

---

## 4. 🏗️ 生产环境高可用配置


### 4.1 高可用架构设计


**生产架构图**：
```
                    互联网
                      ↓
            ┌─────────────────┐
            │   LoadBalancer  │ ← 负载均衡器
            └─────────────────┘
                      ↓
        ┌─────────────┴─────────────┐
        ↓                           ↓
  ┌──────────┐              ┌──────────┐
  │ UI Pod-1 │              │ UI Pod-2 │ ← UI层（2副本）
  └──────────┘              └──────────┘
        ↓                           ↓
  ┌─────────────────────────────────────┐
  │         OAP Service                 │
  └─────────────────────────────────────┘
        ↓                           ↓
  ┌──────────┐  ┌──────────┐  ┌──────────┐
  │OAP Pod-1│  │OAP Pod-2 │  │OAP Pod-3 │ ← 核心层（3副本）
  └──────────┘  └──────────┘  └──────────┘
        ↓             ↓             ↓
  ┌─────────────────────────────────────┐
  │      ElasticSearch Cluster          │
  └─────────────────────────────────────┘
        ↓             ↓             ↓
  ┌──────────┐  ┌──────────┐  ┌──────────┐
  │  ES-0    │  │  ES-1    │  │  ES-2    │ ← 存储层（3节点）
  └──────────┘  └──────────┘  └──────────┘
```

### 4.2 OAP高可用配置


**多副本部署**：
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: skywalking-oap
spec:
  replicas: 3  # 生产建议3个副本
  
  # Pod反亲和性：不同副本分散到不同节点
  affinity:
    podAntiAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
      - labelSelector:
          matchExpressions:
          - key: app
            operator: In
            values:
            - skywalking-oap
        topologyKey: kubernetes.io/hostname
  
  template:
    spec:
      containers:
      - name: oap
        image: apache/skywalking-oap-server:9.5.0
        
        # 资源配置
        resources:
          requests:
            cpu: "1"
            memory: 2Gi
          limits:
            cpu: "2"
            memory: 4Gi
        
        # 优雅关闭
        lifecycle:
          preStop:
            exec:
              command: ["/bin/sh", "-c", "sleep 15"]
```

> 📌 **配置要点**：
> - `podAntiAffinity`：确保副本分散在不同节点，避免单点故障
> - `preStop`：优雅关闭，给15秒处理完正在进行的请求
> - 资源限制：防止某个Pod占用过多资源影响其他服务

**集群模式配置**：
```yaml
env:
- name: SW_CLUSTER
  value: kubernetes  # 使用K8s作为集群管理
  
- name: SW_CLUSTER_K8S_NAMESPACE
  value: skywalking
  
- name: SW_CLUSTER_K8S_LABEL_SELECTOR
  value: app=skywalking-oap
```

**集群工作原理**：
```
OAP集群协调：
Pod-1 ←─────→ Pod-2 ←─────→ Pod-3
  ↓             ↓             ↓
  └─────────────┴─────────────┘
            协调机制
  
职责分配：
  ├─ 数据收集：所有Pod都接收Agent数据
  ├─ 数据聚合：通过选举确定Leader处理
  ├─ 告警检测：Leader负责，避免重复告警
  └─ 数据同步：成员间共享状态信息
```

### 4.3 存储层高可用


**Elasticsearch集群配置**：
```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: elasticsearch
spec:
  replicas: 3  # 3节点集群
  serviceName: elasticsearch
  
  template:
    spec:
      initContainers:
      - name: increase-vm-max-map
        image: busybox
        command: ["sysctl", "-w", "vm.max_map_count=262144"]
        securityContext:
          privileged: true
      
      containers:
      - name: elasticsearch
        image: elasticsearch:7.17.0
        env:
        - name: cluster.name
          value: skywalking-es
        
        - name: cluster.initial_master_nodes
          value: elasticsearch-0,elasticsearch-1,elasticsearch-2
        
        - name: discovery.seed_hosts
          value: elasticsearch-0.elasticsearch,elasticsearch-1.elasticsearch,elasticsearch-2.elasticsearch
        
        - name: ES_JAVA_OPTS
          value: "-Xms2g -Xmx2g"
        
        resources:
          requests:
            cpu: "1"
            memory: 2Gi
          limits:
            cpu: "2"
            memory: 4Gi
```

**存储持久化**：
```yaml
volumeClaimTemplates:
- metadata:
    name: data
  spec:
    accessModes: ["ReadWriteOnce"]
    storageClassName: fast-ssd  # 使用SSD存储
    resources:
      requests:
        storage: 100Gi  # 生产环境建议100G+
```

### 4.4 监控与告警配置


**资源监控**：
```yaml
apiVersion: v1
kind: Service
metadata:
  name: skywalking-oap-metrics
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "1234"
spec:
  selector:
    app: skywalking-oap
  ports:
  - port: 1234
    name: metrics
```

**HPA自动伸缩**：
```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: skywalking-oap-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: skywalking-oap
  
  minReplicas: 2
  maxReplicas: 10
  
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70  # CPU超70%扩容
  
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80  # 内存超80%扩容
```

> 🚀 **自动伸缩说明**：
> - CPU使用率超过70%时，自动增加Pod
> - 最少保持2个，最多扩展到10个
> - 负载降低后自动缩容，节省资源

---

## 5. 📋 核心要点总结


### 5.1 部署方式选择


| 部署方式 | **适用场景** | **优势** | **劣势** |
|---------|-------------|---------|---------|
| 🐳 **Docker Compose** | `开发测试环境` | `部署简单，快速启动` | `单机部署，无法高可用` |
| ☸️ **K8s原生部署** | `生产环境，需要定制` | `灵活可控，精细配置` | `配置复杂，学习成本高` |
| 🎯 **Helm Chart** | `生产环境，标准部署` | `一键部署，社区维护` | `定制化受限于Chart` |

### 5.2 必须掌握的核心概念


**容器化核心**：
```
🔸 镜像（Image）：应用程序的打包形式
🔸 容器（Container）：镜像的运行实例
🔸 编排（Orchestration）：管理多个容器的工具
🔸 持久化（Persistence）：数据保存不丢失
```

**K8s核心资源**：
```
🔸 Pod：最小部署单元，运行容器
🔸 Deployment：管理无状态应用
🔸 StatefulSet：管理有状态应用
🔸 Service：提供服务访问入口
🔸 ConfigMap/Secret：配置和密钥管理
```

**高可用三要素**：
```
🔸 多副本：至少3个实例，避免单点故障
🔸 健康检查：自动检测和重启异常Pod
🔸 负载均衡：请求均匀分配到各个实例
```

### 5.3 生产部署检查清单


**部署前检查**：
- [ ] 资源配置是否充足（CPU、内存、存储）
- [ ] 网络策略是否正确（端口、防火墙）
- [ ] 持久化存储是否配置（防止数据丢失）
- [ ] 镜像版本是否统一（避免兼容问题）

**高可用检查**：
- [ ] OAP至少3个副本
- [ ] ES至少3节点集群
- [ ] Pod反亲和性配置（分散节点）
- [ ] 健康检查配置完整
- [ ] HPA自动伸缩配置

**安全性检查**：
- [ ] 使用Secret存储敏感信息
- [ ] 网络策略限制访问
- [ ] RBAC权限控制
- [ ] 镜像安全扫描

### 5.4 常见问题与解决


**问题1：Pod启动失败**
```
症状：Pod一直处于Pending或CrashLoopBackOff状态

排查步骤：
1️⃣ 查看Pod详情：kubectl describe pod <pod-name> -n skywalking
2️⃣ 查看Pod日志：kubectl logs <pod-name> -n skywalking
3️⃣ 检查资源配置：是否有足够的CPU和内存
4️⃣ 检查存储卷：PVC是否成功绑定
```

**问题2：服务无法访问**
```
症状：外部无法访问UI或Agent连接失败

排查步骤：
1️⃣ 检查Service：kubectl get svc -n skywalking
2️⃣ 检查端口映射：确认端口号正确
3️⃣ 检查网络策略：防火墙规则是否允许
4️⃣ 测试内部连通：kubectl exec进入Pod测试
```

**问题3：存储空间不足**
```
症状：ES写入失败，日志显示磁盘满

解决方案：
1️⃣ 扩容存储卷：修改PVC的storage大小
2️⃣ 清理历史数据：调整数据保留时间
3️⃣ 启用数据压缩：ES索引压缩配置
4️⃣ 增加ES节点：分散存储压力
```

### 5.5 实战经验总结


**🔹 Docker部署经验**：
- 开发测试用Docker Compose，快速验证功能
- 注意容器间网络互通，使用同一network
- 数据一定要持久化，使用volumes挂载
- 合理设置资源限制，避免OOM

**🔹 K8s部署经验**：
- 生产环境必须用K8s，保证高可用
- StatefulSet部署ES，Deployment部署OAP
- 合理配置健康检查，避免流量打到未就绪Pod
- 使用命名空间隔离不同环境

**🔹 Helm部署经验**：
- 首选Helm部署，省时省力
- 仔细配置values.yaml，参数化管理
- 定期更新Chart版本，获取最新优化
- 测试环境先验证，再部署生产

**核心记忆**：
- 容器化部署标准化，快速迁移易管理
- K8s编排保高可用，自动伸缩有保障
- Helm一键快部署，配置集中易维护
- 生产环境三副本，监控告警不能少