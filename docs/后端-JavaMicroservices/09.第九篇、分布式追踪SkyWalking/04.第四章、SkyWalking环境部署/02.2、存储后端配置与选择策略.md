---
title: 2、存储后端配置与选择策略
---
## 📚 目录

1. [存储后端基础概念](#1-存储后端基础概念)
2. [三大存储方案详解](#2-三大存储方案详解)
3. [存储性能对比分析](#3-存储性能对比分析)
4. [数据保留与归档策略](#4-数据保留与归档策略)
5. [存储容量规划](#5-存储容量规划)
6. [核心要点总结](#6-核心要点总结)

---

## 1. 💾 存储后端基础概念


### 1.1 什么是存储后端


**🔸 通俗理解**
```
想象一下：
SkyWalking就像一个监控摄像头，不断记录系统运行情况
但这些"录像"要存在哪里呢？这就是存储后端的作用

存储后端 = 数据仓库
• 保存所有监控数据
• 支持快速查询
• 管理数据生命周期
```

**💡 核心作用**
- **数据持久化**：把监控信息永久保存下来
- **快速检索**：需要查问题时能快速找到数据
- **容量管理**：控制数据量，避免存储爆炸

### 1.2 SkyWalking支持的存储类型


**📊 三大主力存储方案**
```
┌─────────────┐
│  H2数据库    │ ← 最简单，测试用
├─────────────┤
│  MySQL      │ ← 传统数据库，中小规模
├─────────────┤
│ElasticSearch│ ← 专业方案，大规模生产
└─────────────┘
```

🔗 **选择逻辑**：
- 🟢 **学习测试** → H2数据库（开箱即用）
- 🟡 **小型项目** → MySQL（熟悉易用）
- 🔴 **生产环境** → ElasticSearch（性能强劲）

---

## 2. 🗄️ 三大存储方案详解


### 2.1 H2数据库 - 快速上手方案


**🔸 什么是H2**
```
H2就像一个"便携式保险箱"
• 不需要安装，自带在SkyWalking里
• 数据存在本地文件中
• 开发测试时最方便
```

**⚙️ 配置方式**

```yaml
storage:
  selector: ${SW_STORAGE:h2}  # 选择H2存储
  h2:
    driver: org.h2.jdbcx.JdbcDataSource
    url: jdbc:h2:mem:skywalking-oap-db  # 内存模式
    user: sa
    password: ""
```

**📋 优缺点分析**

| 维度 | 评价 | 说明 |
|------|------|------|
| 🚀 **上手难度** | ⭐⭐⭐⭐⭐ | 零配置，开箱即用 |
| 📈 **性能表现** | ⭐⭐ | 数据量大时很慢 |
| 💰 **成本投入** | ⭐⭐⭐⭐⭐ | 完全免费 |
| 🏢 **适用场景** | 学习测试 | **不能用于生产！** |

**⚠️ 关键限制**
- **数据易丢失**：重启服务数据就没了（内存模式）
- **性能差**：并发查询时响应慢
- **功能受限**：高级分析功能不支持

### 2.2 MySQL存储 - 传统稳妥方案


**🔸 为什么选MySQL**
```
MySQL就像一个"标准文件柜"
• 大家都熟悉，运维简单
• 数据持久化有保障
• 中小规模项目够用
```

**⚙️ 配置示例**

```yaml
storage:
  selector: ${SW_STORAGE:mysql}
  mysql:
    properties:
      jdbcUrl: jdbc:mysql://localhost:3306/swtest
      dataSource.user: root
      dataSource.password: root123
      # 连接池配置
      dataSource.cachePrepStmts: true
      dataSource.prepStmtCacheSize: 250
      dataSource.prepStmtCacheSqlLimit: 2048
```

**🔧 关键配置参数解释**

```
jdbcUrl：MySQL数据库地址
  ↓
  格式：jdbc:mysql://服务器IP:端口/数据库名

dataSource.cachePrepStmts：开启SQL预编译缓存
  ↓
  作用：提升重复查询的速度
  
prepStmtCacheSize：缓存的SQL语句数量
  ↓
  建议：250条够用，太大占内存
```

**📊 性能表现**

| 指标 | MySQL表现 | 适用规模 |
|------|-----------|----------|
| 📝 **写入速度** | 5000条/秒 | 10台服务器以内 |
| 🔍 **查询效率** | 秒级响应 | 7天内数据查询 |
| 💾 **数据量** | GB级别 | 中小型项目 |
| 🔄 **并发能力** | 100并发 | 50人以内团队 |

**💡 实用建议**
- ✅ **适合场景**：20台以下服务器监控
- ✅ **团队优势**：运维人员熟悉MySQL
- ❌ **不建议**：大规模微服务集群（100+服务）

### 2.3 ElasticSearch - 生产级专业方案


**🔸 为什么ES是最佳选择**
```
ElasticSearch就像一个"智能图书馆"
• 专门为海量数据设计
• 检索速度极快（毫秒级）
• 支持复杂的聚合分析
```

**⚙️ 基础配置**

```yaml
storage:
  selector: ${SW_STORAGE:elasticsearch}
  elasticsearch:
    # ES集群地址
    nameSpace: ${SW_NAMESPACE:"skywalking"}
    clusterNodes: ${SW_STORAGE_ES_CLUSTER_NODES:localhost:9200}
    protocol: ${SW_STORAGE_ES_HTTP_PROTOCOL:"http"}
    # 性能调优参数
    bulkActions: ${SW_STORAGE_ES_BULK_ACTIONS:5000}
    flushInterval: ${SW_STORAGE_ES_FLUSH_INTERVAL:15}
    concurrentRequests: ${SW_STORAGE_ES_CONCURRENT_REQUESTS:2}
```

**🔑 核心参数详解**

```
nameSpace：索引前缀
  ↓
  作用：多个SkyWalking实例共用ES时，用来区分数据
  示例：skywalking-prod、skywalking-test

bulkActions：批量写入数量
  ↓
  含义：攒够5000条数据再一次性写入
  目的：提升写入效率，减少网络开销

flushInterval：强制刷新间隔（秒）
  ↓
  含义：超过15秒必须写一次，即使没攒够5000条
  目的：防止数据延迟太久

concurrentRequests：并发写入线程数
  ↓
  建议：2-4个，太多会拖慢ES性能
```

**📈 性能优势**

| 对比维度 | MySQL | ElasticSearch |
|----------|-------|---------------|
| ⚡ **写入速度** | 5千/秒 | 5万/秒 **提升10倍** |
| 🔍 **查询速度** | 秒级 | 毫秒级 **快100倍** |
| 📊 **数据量** | GB级 | TB级 **千倍容量** |
| 🔄 **并发能力** | 100 | 1000+ **10倍并发** |

**🎯 高级特性**

```
索引生命周期管理：
  ↓
30天内数据 → 热索引（SSD存储，查询快）
  ↓
30-90天数据 → 温索引（普通硬盘，成本低）
  ↓
90天以上 → 归档/删除
```

---

## 3. ⚖️ 存储性能对比分析


### 3.1 写入性能对比


**📊 不同场景下的表现**

```
小规模场景（10台服务器）：
┌──────────┬──────────┬──────────┐
│   H2     │  MySQL   │    ES    │
│ 1000条/秒│ 3000条/秒│ 10000条/秒│
└──────────┴──────────┴──────────┘
结论：MySQL足够用，ES有点"大材小用"

中等规模（50台服务器）：
┌──────────┬──────────┬──────────┐
│   H2     │  MySQL   │    ES    │
│  ❌不行  │ 5000条/秒│ 30000条/秒│
└──────────┴──────────┴──────────┘
结论：MySQL开始吃力，ES游刃有余

大规模（200+台服务器）：
┌──────────┬──────────┬──────────┐
│   H2     │  MySQL   │    ES    │
│  ❌不行  │  ❌撑不住│ 50000条/秒│
└──────────┴──────────┴──────────┘
结论：只有ES能胜任
```

### 3.2 查询效率对比


**🔍 典型查询场景测试**

| 查询类型 | H2耗时 | MySQL耗时 | ES耗时 | 最佳选择 |
|----------|--------|-----------|--------|----------|
| 📅 **查询1小时数据** | 2秒 | 0.5秒 | 0.1秒 | 都可以 |
| 📆 **查询1天数据** | 30秒 | 5秒 | 0.3秒 | MySQL/ES |
| 📊 **查询7天数据** | ❌超时 | 20秒 | 0.8秒 | 仅ES |
| 🔎 **复杂聚合查询** | ❌不支持 | 60秒+ | 2秒 | 仅ES |

**💡 性能优化建议**

```
MySQL优化策略：
✅ 为常用查询字段添加索引
✅ 定期清理过期数据（保留7天）
✅ 分库分表（超过50台服务器）

ElasticSearch优化：
✅ 使用索引模板预定义结构
✅ 配置副本数量（生产建议2副本）
✅ 启用索引生命周期管理
```

### 3.3 资源消耗对比


**💻 硬件资源需求**

```
H2数据库：
内存：512MB
磁盘：1GB
CPU：1核

MySQL：
内存：4GB起步
磁盘：100GB+（看数据量）
CPU：4核推荐

ElasticSearch：
内存：8GB起步（生产建议16GB）
磁盘：500GB+（SSD最佳）
CPU：8核推荐
```

---

## 4. 🗂️ 数据保留与归档策略


### 4.1 数据生命周期管理


**🔸 为什么要管理数据**
```
问题：监控数据会无限增长吗？
回答：不行！会把存储撑爆

解决方案：设定数据保留期
• 热数据：最近7天，快速查询
•温数据：8-30天，归档存储
• 冷数据：超过30天，删除或备份
```

**⏰ 保留策略配置**

```yaml
# MySQL数据保留配置
core:
  default:
    # 指标数据保留天数
    metricsDataTTL: ${SW_CORE_METRICS_DATA_TTL:7}
    # 记录数据保留天数  
    recordDataTTL: ${SW_CORE_RECORD_DATA_TTL:3}
```

**📋 不同数据类型保留建议**

| 数据类型 | 重要性 | 建议保留 | 原因 |
|----------|--------|----------|------|
| 🔴 **Trace链路** | 高 | 7天 | 问题排查核心数据 |
| 🟡 **Metrics指标** | 中 | 30天 | 趋势分析需要 |
| 🟢 **Log日志** | 低 | 3天 | 占空间大，保留核心即可 |
| 🔵 **拓扑关系** | 高 | 90天 | 变化慢，长期参考 |

### 4.2 ElasticSearch索引设计


**🔸 什么是索引设计**
```
把不同时间的数据分开存储
就像把书按年份分册存放

好处：
• 查询快：只查需要的那一册
• 删除快：直接删整册，不影响其他
• 管理易：每册独立配置
```

**📚 索引命名规范**

```
按天索引：
skywalking-segment-20250923
skywalking-segment-20250924
  ↓
优点：精确到天，删除方便
缺点：索引数量多

按月索引：
skywalking-segment-202509
skywalking-segment-202510
  ↓
优点：索引数量少，管理简单
缺点：删除粒度粗
```

**⚙️ 索引生命周期配置**

```json
{
  "policy": "skywalking-policy",
  "phases": {
    "hot": {
      "min_age": "0ms",
      "actions": {
        "rollover": {
          "max_age": "1d",
          "max_size": "50GB"
        }
      }
    },
    "warm": {
      "min_age": "7d",
      "actions": {
        "shrink": {
          "number_of_shards": 1
        }
      }
    },
    "delete": {
      "min_age": "30d",
      "actions": {
        "delete": {}
      }
    }
  }
}
```

**🔑 配置解读**
- **hot阶段**：新数据写入，性能优先
- **warm阶段**：7天后数据合并，节省空间
- **delete阶段**：30天后自动删除

### 4.3 数据归档与备份


**💾 归档方案设计**

```
实时数据（0-7天）
    ↓
保存在ES热节点（SSD）
查询速度：毫秒级

历史数据（7-30天）
    ↓  
迁移到温节点（HDD）
查询速度：秒级

过期数据（30天+）
    ↓
选择1：完全删除
选择2：备份到对象存储（OSS）
选择3：归档到Hadoop
```

**🔧 备份脚本示例**

```bash
#!/bin/bash
# 备份30天前的索引到OSS

# 获取30天前的日期
OLD_DATE=$(date -d "30 days ago" +%Y%m%d)

# 导出索引数据
elasticdump \
  --input=http://localhost:9200/skywalking-*-${OLD_DATE} \
  --output=/backup/skywalking-${OLD_DATE}.json

# 上传到OSS
ossutil cp /backup/skywalking-${OLD_DATE}.json \
  oss://skywalking-backup/

# 删除原索引
curl -X DELETE "localhost:9200/skywalking-*-${OLD_DATE}"
```

---

## 5. 📊 存储容量规划


### 5.1 容量估算方法


**🔸 如何计算需要多大存储**

```
容量 = 每秒数据量 × 保留天数 × 24 × 3600

举例说明：
服务数量：50个
每个服务QPS：100
每条Trace大小：2KB

计算过程：
1. 每秒Trace数 = 50 × 100 = 5000条
2. 每秒数据量 = 5000 × 2KB = 10MB
3. 每天数据量 = 10MB × 86400 = 864GB
4. 保留7天 = 864GB × 7 ≈ 6TB
```

**📊 不同规模容量参考**

| 规模 | 服务数 | 日数据量 | 7天存储 | 30天存储 |
|------|--------|----------|---------|----------|
| 🟢 **小型** | 10-20 | 100GB | 700GB | 3TB |
| 🟡 **中型** | 50-100 | 500GB | 3.5TB | 15TB |
| 🔴 **大型** | 200+ | 2TB | 14TB | 60TB |

### 5.2 存储成本优化


**💰 成本控制策略**

```
策略1：采样率调整
  ↓
全量采集：100%数据，成本高
智能采样：10%数据，成本降90%
  ↓
适用：正常运行时用10%，出问题时调100%

策略2：数据分级存储
  ↓
热数据（7天）→ SSD（快但贵）
温数据（30天）→ HDD（慢但便宜）
冷数据（备份）→ OSS（极便宜）
  ↓
成本可降低70%

策略3：压缩优化
  ↓
ES开启压缩：数据量减少50%
代价：CPU多消耗10%
  ↓
适用：存储贵、CPU便宜的场景
```

**🔧 采样率配置**

```yaml
# agent配置文件
agent:
  sample_n_per_3_secs: 3  # 每3秒采样3条
  # 或者
  sample_percentage: 0.1   # 采样10%的请求
```

### 5.3 扩容与缩容策略


**📈 何时需要扩容**

```
扩容信号：
⚠️ 写入延迟超过1秒
⚠️ 查询响应超过5秒
⚠️ 磁盘使用率超过80%
⚠️ CPU持续超过70%

扩容方案：
方案1：垂直扩容（加大单机配置）
  ↓
  适用：初期快速解决，有上限

方案2：水平扩容（增加节点）
  ↓
  适用：长期方案，理论无上限
```

**🔄 ES集群扩容示例**

```
原集群：3节点
节点配置：8核16GB、500GB SSD
承载能力：50台服务器

扩容后：6节点
节点配置：不变
承载能力：100台服务器

操作步骤：
1. 新增3个ES节点
2. 自动平衡数据分片
3. 观察负载下降
4. 完成扩容（无需停机）
```

---

## 6. 📋 核心要点总结


### 6.1 必须掌握的核心概念


```
🔸 存储后端三选择：H2、MySQL、ElasticSearch
🔸 H2用于测试，MySQL适合中小规模，ES是生产首选
🔸 数据要分级：热温冷三层，省空间提性能
🔸 容量要规划：提前算好空间，避免突然爆满
🔸 性能要优化：采样、压缩、归档多管齐下
```

### 6.2 选型决策树


```
开始
 ↓
是否生产环境？
 ├─ 否 → 使用H2（学习测试）
 └─ 是 ↓
    ↓
服务器数量？
 ├─ <20台 → MySQL（简单够用）
 ├─ 20-50台 → MySQL或ES（看团队熟悉度）
 └─ >50台 → ElasticSearch（必选）
```

### 6.3 实战配置建议


**🎯 小型项目配置（10-20台服务器）**
```yaml
存储选择：MySQL
保留天数：7天
采样率：30%
预估存储：500GB
```

**🎯 中型项目配置（50-100台服务器）**
```yaml
存储选择：ElasticSearch单节点
保留天数：30天
采样率：10%
预估存储：5TB
集群规模：1主节点
```

**🎯 大型项目配置（200+台服务器）**
```yaml
存储选择：ElasticSearch集群
保留天数：30天（热7天+温23天）
采样率：智能采样（正常10%，异常100%）
预估存储：20TB+
集群规模：3主节点+数据节点按需扩展
```

### 6.4 常见问题速查


**❓ 数据丢失怎么办？**
```
MySQL：每天备份数据库
ES：配置副本数≥2，多副本防丢失
```

**❓ 查询太慢怎么优化？**
```
1. 缩短查询时间范围（只查最近1小时）
2. 添加更多过滤条件（指定服务名）
3. 使用索引（MySQL加索引，ES优化mapping）
```

**❓ 存储空间不够了？**
```
紧急方案：删除历史数据，保留最近3天
长期方案：扩容存储或调低采样率
```

**🧠 记忆口诀**
```
H2测试用，MySQL中小搞
生产必上ES，性能才可靠
数据分冷热，归档不能少
容量早规划，扩容有预兆
```

**核心理解**：
- 存储后端不是越高级越好，要匹配实际规模
- 数据不是保留越久越好，要平衡成本和需求
- 性能不是配置越高越好，要优化策略和架构
- 监控不是采集越全越好，要智能采样省资源