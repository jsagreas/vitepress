---
title: 3ã€OpenTracingæ ‡å‡†ä¸åè®®è§„èŒƒ
---
## ğŸ“š ç›®å½•

1. [ä¸ºä»€ä¹ˆéœ€è¦è¿½è¸ªæ ‡å‡†](#1-ä¸ºä»€ä¹ˆéœ€è¦è¿½è¸ªæ ‡å‡†)
2. [OpenTracingè§„èŒƒè¯¦è§£](#2-OpenTracingè§„èŒƒè¯¦è§£)
3. [OpenTelemetryç»Ÿä¸€æ ‡å‡†](#3-OpenTelemetryç»Ÿä¸€æ ‡å‡†)
4. [B3åè®®ä¼ æ’­æœºåˆ¶](#4-B3åè®®ä¼ æ’­æœºåˆ¶)
5. [W3C Trace Contextæ ‡å‡†](#5-W3C-Trace-Contextæ ‡å‡†)
6. [è·¨è¿›ç¨‹è¿½è¸ªå®ç°](#6-è·¨è¿›ç¨‹è¿½è¸ªå®ç°)
7. [åè®®å…¼å®¹æ€§å¤„ç†](#7-åè®®å…¼å®¹æ€§å¤„ç†)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¤” ä¸ºä»€ä¹ˆéœ€è¦è¿½è¸ªæ ‡å‡†


### 1.1 æ²¡æœ‰æ ‡å‡†çš„æ··ä¹±åœºæ™¯


**é—®é¢˜åœºæ™¯**ï¼šæƒ³è±¡ä½ çš„å…¬å¸ç”¨äº†å¤šä¸ªè¿½è¸ªå·¥å…·

```
æœåŠ¡Aä½¿ç”¨ â†’ Zipkinè¿½è¸ª
æœåŠ¡Bä½¿ç”¨ â†’ Jaegerè¿½è¸ª  
æœåŠ¡Cä½¿ç”¨ â†’ SkyWalkingè¿½è¸ª

é—®é¢˜æ¥äº†ï¼š
- è¯·æ±‚ä»Aåˆ°Båˆ°Cï¼Œè¿½è¸ªé“¾è·¯æ–­äº†ï¼
- å„è‡ªéƒ½åœ¨è®°å½•ï¼Œä½†äº’ç›¸çœ‹ä¸æ‡‚å¯¹æ–¹çš„æ•°æ®
- æ¢å·¥å…·ï¼Ÿæ‰€æœ‰ä»£ç éƒ½è¦é‡å†™ï¼
```

> ğŸ’¡ **æ ¸å¿ƒé—®é¢˜**ï¼šå°±åƒå„åœ°è¯´æ–¹è¨€ï¼Œå½¼æ­¤å¬ä¸æ‡‚ã€‚éœ€è¦ä¸€ä¸ª"æ™®é€šè¯"æ ‡å‡†ï¼Œå¤§å®¶éƒ½èƒ½ç†è§£ã€‚

### 1.2 æ ‡å‡†åŒ–çš„ä»·å€¼


**ğŸ¯ æ ‡å‡†èƒ½è§£å†³ä»€ä¹ˆ**

| ç—›ç‚¹ | æ ‡å‡†åŒ–è§£å†³æ–¹æ¡ˆ | å®é™…æ•ˆæœ |
|------|--------------|---------|
| **å·¥å…·ç»‘å®š** | ç»Ÿä¸€APIæ¥å£ | æ¢å·¥å…·ä¸ç”¨æ”¹ä»£ç  |
| **é“¾è·¯æ–­è£‚** | ç»Ÿä¸€ä¼ æ’­åè®® | è·¨å·¥å…·ä¹Ÿèƒ½è¿½è¸ª |
| **æ•°æ®å­¤å²›** | ç»Ÿä¸€æ•°æ®æ ¼å¼ | æ•°æ®å¯ä»¥äº’é€š |
| **å­¦ä¹ æˆæœ¬** | ç»Ÿä¸€æ¦‚å¿µæœ¯è¯­ | å­¦ä¸€æ¬¡åˆ°å¤„ç”¨ |

**é€šä¿—ç†è§£**ï¼š
- âŒ **æ²¡æ ‡å‡†**ï¼šæ¯ä¸ªè¿½è¸ªå·¥å…·éƒ½æ˜¯"æ–¹è¨€"ï¼Œç›¸äº’å¬ä¸æ‡‚
- âœ… **æœ‰æ ‡å‡†**ï¼šå¤§å®¶éƒ½è¯´"æ™®é€šè¯"ï¼Œè½»æ¾äº¤æµ

---

## 2. ğŸ“– OpenTracingè§„èŒƒè¯¦è§£


### 2.1 ä»€ä¹ˆæ˜¯OpenTracing


**OpenTracingç®€å•è¯´**ï¼šä¸€å¥—"è¿½è¸ªçš„è§„åˆ™æ‰‹å†Œ"ï¼Œå‘Šè¯‰å¤§å®¶æ€ä¹ˆè®°å½•è°ƒç”¨é“¾è·¯

```
ç±»æ¯”ç†è§£ï¼š
OpenTracing = äº¤é€šè§„åˆ™
- è§„å®šäº†çº¢ç»¿ç¯æ€ä¹ˆçœ‹ï¼ˆTraceæ€ä¹ˆè®°ï¼‰
- è§„å®šäº†æ€ä¹ˆå¼€è½¦ï¼ˆSpanæ€ä¹ˆåˆ›å»ºï¼‰
- ä½†å…·ä½“å¼€ä»€ä¹ˆè½¦ï¼ˆç”¨ä»€ä¹ˆå·¥å…·ï¼‰ä½ è‡ªå·±å®š

ä¸æ˜¯å…·ä½“å·¥å…·ï¼Œè€Œæ˜¯å¤§å®¶éƒ½éµå®ˆçš„"æ¸¸æˆè§„åˆ™"
```

> âš ï¸ **é‡è¦ç†è§£**ï¼šOpenTracingåªæ˜¯è§„èŒƒï¼Œä¸æ˜¯å…·ä½“è½¯ä»¶ã€‚å°±åƒ"æ™®é€šè¯æ ‡å‡†"ä¸æ˜¯æŸä¸ªäººè¯´çš„è¯ï¼Œè€Œæ˜¯è¯´è¯çš„è§„åˆ™ã€‚

### 2.2 æ ¸å¿ƒæ¦‚å¿µè§£æ


**ğŸ”¸ Traceï¼ˆè¿½è¸ªï¼‰**

```
é€šä¿—è§£é‡Šï¼š
Trace = ä¸€æ¬¡å®Œæ•´çš„è¯·æ±‚æ—…ç¨‹

ç”¨æˆ·ä¸‹å•æµç¨‹ï¼š
å¼€å§‹ â†’ è®¢å•æœåŠ¡ â†’ åº“å­˜æœåŠ¡ â†’ æ”¯ä»˜æœåŠ¡ â†’ ç»“æŸ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ è¿™æ•´ä¸ªè¿‡ç¨‹å°±æ˜¯ä¸€ä¸ªTrace â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å°±åƒå¿«é€’åŒ…è£¹çš„å®Œæ•´è¿è¾“è·¯çº¿
```

**ğŸ”¸ Spanï¼ˆè·¨åº¦ï¼‰**

```
é€šä¿—è§£é‡Šï¼š
Span = Traceä¸­çš„ä¸€å°æ®µè·¯ç¨‹

è®¢å•æœåŠ¡å¤„ç†ï¼š
â”œâ”€ æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼ˆSpan1ï¼‰
â”œâ”€ åˆ›å»ºè®¢å•è®°å½•ï¼ˆSpan2ï¼‰  
â””â”€ å‘é€æ¶ˆæ¯é€šçŸ¥ï¼ˆSpan3ï¼‰

å°±åƒå¿«é€’ä»Aç«™åˆ°Bç«™çš„ä¸€æ®µè·¯ç¨‹
```

**ğŸ”¸ Spançš„çˆ¶å­å…³ç³»**

```
çˆ¶Spanï¼šè®¢å•æœåŠ¡å¤„ç†
  â”œâ”€â”€ å­Span1ï¼šæŸ¥è¯¢ç”¨æˆ·
  â”œâ”€â”€ å­Span2ï¼šåˆ›å»ºè®¢å•
  â””â”€â”€ å­Span3ï¼šå‘é€é€šçŸ¥

çˆ¶Spanï¼šåº“å­˜æœåŠ¡å¤„ç†
  â”œâ”€â”€ å­Span1ï¼šæ£€æŸ¥åº“å­˜
  â””â”€â”€ å­Span2ï¼šé”å®šåº“å­˜

å°±åƒå®¶è°±ï¼šçˆ¸çˆ¸-å„¿å­-å­™å­çš„å…³ç³»
```

### 2.3 OpenTracingçš„APIè§„èŒƒ


**æ ¸å¿ƒæ“ä½œæ¥å£**

```
â‘  å¯åŠ¨Spanï¼ˆå¼€å§‹è®°å½•ï¼‰
  tracer.startSpan("è®¢å•å¤„ç†")
  â†’ æ„æ€ï¼šå¼€å§‹è®°å½•"è®¢å•å¤„ç†"è¿™æ®µæ“ä½œ

â‘¡ è®¾ç½®æ ‡ç­¾ï¼ˆæ·»åŠ å±æ€§ï¼‰
  span.setTag("ç”¨æˆ·ID", "12345")
  â†’ æ„æ€ï¼šç»™è¿™æ®µæ“ä½œè´´ä¸ªæ ‡ç­¾ï¼Œè®°å½•ç”¨æˆ·ID

â‘¢ è®°å½•æ—¥å¿—ï¼ˆé‡è¦äº‹ä»¶ï¼‰
  span.log("è®¢å•åˆ›å»ºæˆåŠŸ")
  â†’ æ„æ€ï¼šåœ¨è¿™ä¸ªæ—¶é—´ç‚¹è®°å½•ä¸€æ¡é‡è¦ä¿¡æ¯

â‘£ ç»“æŸSpanï¼ˆå®Œæˆè®°å½•ï¼‰
  span.finish()
  â†’ æ„æ€ï¼šè¿™æ®µæ“ä½œç»“æŸäº†ï¼Œè®°å½•å®Œæ¯•
```

**ç®€åŒ–ç¤ºä¾‹**ï¼ˆä¼ªä»£ç ï¼Œç†è§£æ¦‚å¿µå³å¯ï¼‰

```java
// 1. å¼€å§‹è¿½è¸ª"ä¸‹è®¢å•"æ“ä½œ
Span span = tracer.startSpan("ä¸‹è®¢å•");

// 2. è®°å½•å…³é”®ä¿¡æ¯
span.setTag("ç”¨æˆ·ID", "12345");
span.setTag("è®¢å•é‡‘é¢", "299");

try {
    // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
    åˆ›å»ºè®¢å•();
    
    // 3. è®°å½•æˆåŠŸäº‹ä»¶
    span.log("è®¢å•åˆ›å»ºæˆåŠŸ");
    
} finally {
    // 4. ç»“æŸè¿½è¸ª
    span.finish();
}
```

### 2.4 OpenTracingçš„å±€é™æ€§


**âš ï¸ å­˜åœ¨çš„é—®é¢˜**

- **åªç®¡è¿½è¸ª**ï¼šä¸ç®¡æŒ‡æ ‡ï¼ˆMetricsï¼‰ã€æ—¥å¿—ï¼ˆLogsï¼‰
- **å„è‡ªå®ç°**ï¼šæ¯ä¸ªå·¥å…·ç†è§£ä¸åŒï¼Œè¿˜æ˜¯æœ‰å·®å¼‚
- **æ ‡å‡†åˆ†è£‚**ï¼šåæ¥åˆå‡ºäº†OpenCensusï¼Œä¸¤å¥—æ ‡å‡†

> ğŸ’¡ **ç»“æœ**ï¼šä¸šç•Œå†³å®šåˆå¹¶ä¸¤ä¸ªæ ‡å‡†ï¼Œè¯ç”Ÿäº†**OpenTelemetry**

---

## 3. ğŸŒŸ OpenTelemetryç»Ÿä¸€æ ‡å‡†


### 3.1 OpenTelemetryæ˜¯ä»€ä¹ˆ


**é€šä¿—è§£é‡Š**ï¼šOpenTracingçš„å‡çº§ç‰ˆï¼Œæ›´å…¨é¢çš„è§‚æµ‹æ ‡å‡†

```
OpenTracing        åªç®¡è¿½è¸ªï¼ˆTraceï¼‰
     +
OpenCensus         ç®¡è¿½è¸ª+æŒ‡æ ‡ï¼ˆMetricsï¼‰
     â†“
OpenTelemetry      ä¸‰åˆä¸€ï¼šè¿½è¸ª+æŒ‡æ ‡+æ—¥å¿—
```

**å½¢è±¡æ¯”å–»**ï¼š
- OpenTracing = åªæœ‰GPSå®šä½
- OpenTelemetry = GPSå®šä½ + é€Ÿåº¦ç›‘æ§ + è¡Œè½¦è®°å½•ä»ª

### 3.2 æ ¸å¿ƒæ”¹è¿›ç‚¹


**ğŸ”¹ ä¸‰å¤§æ”¯æŸ±ç»Ÿä¸€**

| è§‚æµ‹ç»´åº¦ | ä½œç”¨ | ä¾‹å­ |
|---------|------|------|
| **Traceï¼ˆè¿½è¸ªï¼‰** | çœ‹è¯·æ±‚è·¯å¾„ | è®¢å•â†’åº“å­˜â†’æ”¯ä»˜ |
| **Metricsï¼ˆæŒ‡æ ‡ï¼‰** | çœ‹æ€§èƒ½æ•°æ® | å“åº”æ—¶é—´ã€QPS |
| **Logsï¼ˆæ—¥å¿—ï¼‰** | çœ‹è¯¦ç»†äº‹ä»¶ | é”™è¯¯å †æ ˆã€è°ƒè¯•ä¿¡æ¯ |

**ğŸ”¹ ç»Ÿä¸€æ•°æ®æ¨¡å‹**

```
OpenTelemetryå®šä¹‰ï¼š
- Traceæ•°æ®æ€ä¹ˆå­˜
- Metricsæ•°æ®æ€ä¹ˆå­˜  
- Logsæ•°æ®æ€ä¹ˆå­˜
- ä¸‰è€…ä¹‹é—´æ€ä¹ˆå…³è”

å¥½å¤„ï¼š
å·¥å…·Aé‡‡é›†çš„æ•°æ® â†’ å·¥å…·Bä¹Ÿèƒ½çœ‹æ‡‚
å°±åƒç»Ÿä¸€äº†"æ•°æ®åº“çš„è¡¨ç»“æ„"
```

**ğŸ”¹ æ›´å¼ºçš„å…¼å®¹æ€§**

```
æ”¯æŒå¤šç§åè®®ï¼š
âœ… OpenTracing API
âœ… OpenCensus API
âœ… Zipkinæ ¼å¼
âœ… Jaegeræ ¼å¼

æ„å‘³ç€ï¼š
æ—§é¡¹ç›®ç”¨OpenTracingï¼Ÿæ²¡é—®é¢˜ï¼Œå…¼å®¹ï¼
æƒ³æ¢æ–°å·¥å…·ï¼Ÿä¸ç”¨æ”¹ä»£ç ï¼
```

### 3.3 å®é™…ä½¿ç”¨æ–¹å¼


**ç®€åŒ–æ¦‚å¿µç†è§£**

```
ç¬¬ä¸€æ­¥ï¼šé›†æˆSDK
â†’ åœ¨ä½ çš„æœåŠ¡é‡Œå¼•å…¥OpenTelemetryåº“

ç¬¬äºŒæ­¥ï¼šè‡ªåŠ¨é‡‡é›†
â†’ SDKè‡ªåŠ¨è®°å½•HTTPè¯·æ±‚ã€æ•°æ®åº“è°ƒç”¨ç­‰

ç¬¬ä¸‰æ­¥ï¼šé…ç½®å¯¼å‡º
â†’ æŠŠæ•°æ®å‘ç»™Jaegerã€Zipkinæˆ–SkyWalking

ç¬¬å››æ­¥ï¼šæŸ¥çœ‹åˆ†æ
â†’ åœ¨è¿½è¸ªå·¥å…·é‡Œçœ‹å®Œæ•´é“¾è·¯
```

> ğŸ’¡ **å…³é”®ä¼˜åŠ¿**ï¼šå†™ä»£ç æ—¶ç”¨OpenTelemetryæ ‡å‡†ï¼Œåç«¯æ¢ä»€ä¹ˆè¿½è¸ªå·¥å…·éƒ½è¡Œï¼Œä¸ç”¨æ”¹ä»£ç ï¼

---

## 4. ğŸ”„ B3åè®®ä¼ æ’­æœºåˆ¶


### 4.1 ä»€ä¹ˆæ˜¯B3åè®®


**é€šä¿—è§£é‡Š**ï¼šä¸€ç§"æ¥åŠ›æ£’ä¼ é€’è§„åˆ™"ï¼Œå‘Šè¯‰æœåŠ¡ä¹‹é—´æ€ä¹ˆä¼ é€’è¿½è¸ªä¿¡æ¯

```
æœåŠ¡Aè°ƒç”¨æœåŠ¡Bï¼š
A â”€â”€â”€â”€â”€[è¯·æ±‚]â”€â”€â”€â”€â†’ B

è¯·æ±‚é‡Œè¦å¸¦ä¸Šï¼š
- æˆ‘æ˜¯å“ªä¸ªTraceï¼ˆTraceIDï¼‰
- æˆ‘æ˜¯å“ªä¸ªSpanï¼ˆSpanIDï¼‰  
- æˆ‘çš„çˆ¶Spanæ˜¯è°ï¼ˆParentSpanIDï¼‰

Bæ¥æ”¶åˆ°åç»§ç»­ä¼ é€’ç»™C
```

**åå­—ç”±æ¥**ï¼š**B**rave **3**rd generationï¼ˆç¬¬ä¸‰ä»£Braveè¿½è¸ªæ ¼å¼ï¼‰

### 4.2 B3åè®®çš„ä¼ é€’å†…å®¹


**æ ¸å¿ƒå­—æ®µè¯´æ˜**

```
HTTPè¯·æ±‚å¤´ä¸­æºå¸¦ï¼š

X-B3-TraceId: æ•´æ¡é“¾è·¯çš„å”¯ä¸€ID
  â†’ å°±åƒå¿«é€’å•å·ï¼Œä»å¤´åˆ°å°¾ä¸å˜

X-B3-SpanId: å½“å‰æ“ä½œçš„ID
  â†’ å°±åƒå¿«é€’å½“å‰åœ¨å“ªä¸ªç«™ç‚¹

X-B3-ParentSpanId: ä¸Šä¸€ä¸ªæ“ä½œçš„ID
  â†’ å°±åƒå¿«é€’ä»å“ªä¸ªç«™ç‚¹æ¥çš„

X-B3-Sampled: æ˜¯å¦é‡‡æ ·ï¼ˆ1æˆ–0ï¼‰
  â†’ å†³å®šè¿™æ¡é“¾è·¯è¦ä¸è¦è®°å½•
```

**ä¼ æ’­æµç¨‹å›¾**

```
å®¢æˆ·ç«¯                æœåŠ¡A                æœåŠ¡B
  |                    |                    |
  |--è¯·æ±‚------------->|                    |
  |  TraceId: abc      |                    |
  |  SpanId: 001       |                    |
  |                    |                    |
  |                    |--è¯·æ±‚------------->|
  |                    |  TraceId: abc      |
  |                    |  SpanId: 002       |
  |                    |  ParentId: 001     |
  |                    |                    |
  
æ³¨æ„ï¼š
- TraceIdä¿æŒä¸å˜ï¼ˆabcï¼‰
- SpanIdæ¯æ¬¡ç”Ÿæˆæ–°çš„ï¼ˆ001â†’002ï¼‰
- ParentIdæŒ‡å‘ä¸Šä¸€ä¸ªSpanï¼ˆ001ï¼‰
```

### 4.3 ä¸¤ç§ä¼ æ’­æ ¼å¼


**ğŸ”¸ å•Headeræ ¼å¼ï¼ˆç´§å‡‘ï¼‰**

```
b3: {TraceId}-{SpanId}-{Sampled}-{ParentSpanId}

ç¤ºä¾‹ï¼š
b3: 80f198ee56343ba864fe8b2a57d3eff7-e457b5a2e4d86bd1-1-05e3ac9a4f6e3b90

ä¼˜ç‚¹ï¼šåªç”¨ä¸€ä¸ªè¯·æ±‚å¤´ï¼ŒèŠ‚çœç©ºé—´
ç¼ºç‚¹ï¼šè§£æç¨å¾®å¤æ‚ç‚¹
```

**ğŸ”¸ å¤šHeaderæ ¼å¼ï¼ˆæ¸…æ™°ï¼‰**

```
X-B3-TraceId: 80f198ee56343ba864fe8b2a57d3eff7
X-B3-SpanId: e457b5a2e4d86bd1
X-B3-ParentSpanId: 05e3ac9a4f6e3b90
X-B3-Sampled: 1

ä¼˜ç‚¹ï¼šå­—æ®µæ¸…æ™°ï¼Œå®¹æ˜“ç†è§£
ç¼ºç‚¹ï¼šå¤šä¸ªè¯·æ±‚å¤´ï¼Œç¨å¾®å ç©ºé—´
```

> ğŸ’¡ **å·¥å…·é€‰æ‹©**ï¼šZipkinã€Jaegeréƒ½æ”¯æŒB3åè®®ï¼Œæ‰€ä»¥å®ƒä»¬ä¹‹é—´å¯ä»¥äº’é€šï¼

---

## 5. ğŸŒ W3C Trace Contextæ ‡å‡†


### 5.1 ä¸ºä»€ä¹ˆåˆæœ‰æ–°æ ‡å‡†


**èƒŒæ™¯é—®é¢˜**

```
B3åè®®ï¼šZipkiné˜µè¥ç”¨
Uber Traceï¼šJaegerç”¨
AWS X-Rayï¼šäºšé©¬é€Šç”¨

é—®é¢˜ï¼š
å¤šäº‘ç¯å¢ƒä¸‹ï¼Œä¸åŒäº‘æœåŠ¡å•†çš„è¿½è¸ªä¿¡æ¯ä¼ ä¸äº†ï¼
```

**W3Cçš„è§£å†³æ–¹æ¡ˆ**ï¼šåˆ¶å®šä¸€ä¸ª"å›½é™…æ ‡å‡†"ï¼Œæ‰€æœ‰äººéƒ½éµå®ˆ

> ğŸŒŸ **é‡è¦æ€§**ï¼šå°±åƒUSBæ¥å£æ ‡å‡†ï¼Œæ‰€æœ‰å‚å•†éƒ½æ”¯æŒï¼Œæ‰èƒ½é€šç”¨

### 5.2 æ ¸å¿ƒHeaderå­—æ®µ


**ğŸ”¸ traceparentï¼ˆçˆ¶çº§è¿½è¸ªï¼‰**

```
æ ¼å¼ï¼š
traceparent: ç‰ˆæœ¬-TraceID-SpanID-æ ‡å¿—ä½

ç¤ºä¾‹ï¼š
traceparent: 00-0af7651916cd43dd8448eb211c80319c-b7ad6b7169203331-01

å­—æ®µè§£é‡Šï¼š
00                           â†’ ç‰ˆæœ¬å·ï¼ˆç›®å‰æ˜¯00ï¼‰
0af7651916cd43dd8448eb211c80319c â†’ TraceIDï¼ˆ32ä½16è¿›åˆ¶ï¼‰
b7ad6b7169203331             â†’ SpanIDï¼ˆ16ä½16è¿›åˆ¶ï¼‰
01                           â†’ æ ‡å¿—ä½ï¼ˆ01è¡¨ç¤ºé‡‡æ ·ï¼‰
```

**ğŸ”¸ tracestateï¼ˆçŠ¶æ€ä¼ é€’ï¼‰**

```
ä½œç”¨ï¼šä¼ é€’å‚å•†è‡ªå®šä¹‰ä¿¡æ¯

æ ¼å¼ï¼š
tracestate: å‚å•†1=å€¼1,å‚å•†2=å€¼2

ç¤ºä¾‹ï¼š
tracestate: skywalking=abc123,zipkin=def456

ç”¨é€”ï¼š
- SkyWalkingå¯ä»¥åŠ è‡ªå·±çš„é‡‡æ ·ä¿¡æ¯
- Zipkinå¯ä»¥åŠ è‡ªå·±çš„è°ƒè¯•ä¿¡æ¯
- äº’ä¸å¹²æ‰°ï¼Œå„å–æ‰€éœ€
```

### 5.3 ä¼ æ’­æµç¨‹ç¤ºä¾‹


```
æµè§ˆå™¨             å‰ç«¯æœåŠ¡           åç«¯æœåŠ¡          æ•°æ®åº“æœåŠ¡
  |                  |                  |                  |
  |--è¯·æ±‚---------->|                  |                  |
  | traceparent:    |                  |                  |
  | 00-aaa-111-01   |                  |                  |
  |                  |                  |                  |
  |                  |--è¯·æ±‚---------->|                  |
  |                  | traceparent:    |                  |
  |                  | 00-aaa-222-01   |                  |
  |                  | (TraceIDä¸å˜)   |                  |
  |                  |                  |                  |
  |                  |                  |--è¯·æ±‚---------->|
  |                  |                  | traceparent:    |
  |                  |                  | 00-aaa-333-01   |
  |                  |                  |                  |

è§„åˆ™ï¼š
âœ… TraceIDå…¨ç¨‹ä¸å˜ï¼ˆaaaï¼‰
âœ… æ¯ä¸ªæœåŠ¡ç”Ÿæˆæ–°SpanIDï¼ˆ111â†’222â†’333ï¼‰
âœ… ç‰ˆæœ¬å’Œæ ‡å¿—ä½ä¿æŒä¼ é€’
```

### 5.4 ä¸B3åè®®çš„å¯¹æ¯”


| ç‰¹æ€§ | B3åè®® | W3C Trace Context |
|------|--------|------------------|
| **æ¥æº** | Zipkiné¡¹ç›® | W3Cå›½é™…æ ‡å‡† |
| **æ™®åŠåº¦** | è¿½è¸ªå·¥å…·å¸¸ç”¨ | æµè§ˆå™¨ã€äº‘å‚å•†æ”¯æŒ |
| **å­—æ®µæ•°é‡** | 4ä¸ªå­—æ®µ | 2ä¸ªå­—æ®µï¼ˆæ›´ç®€æ´ï¼‰ |
| **æ‰©å±•æ€§** | æœ‰é™ | tracestateçµæ´»æ‰©å±• |
| **è·¨äº‘æ”¯æŒ** | ä¸€èˆ¬ | ä¼˜ç§€ï¼ˆæ ‡å‡†åŒ–ï¼‰ |

> ğŸ’¡ **è¶‹åŠ¿**ï¼šæœªæ¥W3Cæ ‡å‡†ä¼šæ›´æµè¡Œï¼Œå› ä¸ºæµè§ˆå™¨ã€äº‘æœåŠ¡éƒ½åœ¨æ”¯æŒ

---

## 6. ğŸ”— è·¨è¿›ç¨‹è¿½è¸ªå®ç°


### 6.1 è·¨è¿›ç¨‹è¿½è¸ªçš„æœ¬è´¨


**æ ¸å¿ƒé—®é¢˜**ï¼šæœåŠ¡Aè°ƒç”¨æœåŠ¡Bï¼Œæ€ä¹ˆæŠŠè¿½è¸ªä¿¡æ¯ä¼ è¿‡å»ï¼Ÿ

```
æœåŠ¡Aå†…éƒ¨ï¼š
â”œâ”€ TraceID: abc123
â”œâ”€ SpanID: span001
â””â”€ è¦è°ƒç”¨æœåŠ¡Bäº†

æœåŠ¡Bæ€ä¹ˆçŸ¥é“ï¼š
- æˆ‘æ˜¯å“ªä¸ªTraceçš„ä¸€éƒ¨åˆ†ï¼Ÿ
- æˆ‘çš„çˆ¶Spanæ˜¯è°ï¼Ÿ

ç­”æ¡ˆï¼šé€šè¿‡HTTPè¯·æ±‚å¤´ä¼ é€’ï¼
```

### 6.2 HTTPè¯·æ±‚å¤´ä¼ é€’


**ä¼ é€’æœºåˆ¶**

```
æœåŠ¡Aå‘èµ·HTTPè¯·æ±‚ï¼š

GET /api/order HTTP/1.1
Host: service-b.com
X-B3-TraceId: abc123           â† è¿½è¸ªID
X-B3-SpanId: span002           â† å½“å‰Span
X-B3-ParentSpanId: span001     â† çˆ¶Span
X-B3-Sampled: 1                â† é‡‡æ ·æ ‡è®°

æœåŠ¡Bæ¥æ”¶è¯·æ±‚ï¼š
1. è¯»å–è¯·æ±‚å¤´ä¸­çš„TraceID
2. è¯»å–ParentSpanID
3. åˆ›å»ºè‡ªå·±çš„æ–°SpanID
4. ç»§ç»­ä¼ é€’ç»™ä¸‹æ¸¸æœåŠ¡
```

**ä»£ç å®ç°æ€è·¯**

```java
// æœåŠ¡Aå‘é€è¯·æ±‚å‰
public void callServiceB() {
    // 1. è·å–å½“å‰Spanä¿¡æ¯
    Span currentSpan = tracer.activeSpan();
    String traceId = currentSpan.getTraceId();
    String spanId = currentSpan.getSpanId();
    
    // 2. æ„é€ HTTPè¯·æ±‚
    HttpRequest request = HttpRequest.newBuilder()
        .uri(URI.create("http://service-b/api"))
        .header("X-B3-TraceId", traceId)      // ä¼ é€’TraceID
        .header("X-B3-SpanId", newSpanId)     // æ–°SpanID
        .header("X-B3-ParentSpanId", spanId)  // å½“å‰ä½œä¸ºçˆ¶Span
        .build();
    
    // 3. å‘é€è¯·æ±‚
    httpClient.send(request);
}

// æœåŠ¡Bæ¥æ”¶è¯·æ±‚å
public void handleRequest(HttpRequest request) {
    // 1. æå–è¿½è¸ªä¿¡æ¯
    String traceId = request.getHeader("X-B3-TraceId");
    String parentSpanId = request.getHeader("X-B3-ParentSpanId");
    
    // 2. åˆ›å»ºå½“å‰Spanï¼ˆä½œä¸ºå­Spanï¼‰
    Span span = tracer.buildSpan("å¤„ç†è®¢å•")
        .asChildOf(parentSpanId)  // è®¾ç½®çˆ¶Span
        .start();
    
    // 3. æ‰§è¡Œä¸šåŠ¡é€»è¾‘
    processOrder();
    
    // 4. ç»“æŸSpan
    span.finish();
}
```

### 6.3 æ¶ˆæ¯é˜Ÿåˆ—çš„è¿½è¸ªä¼ é€’


**åœºæ™¯**ï¼šæœåŠ¡Aå‘æ¶ˆæ¯åˆ°RabbitMQ/Kafkaï¼ŒæœåŠ¡Bæ¶ˆè´¹

```
æŒ‘æˆ˜ï¼š
æ¶ˆæ¯ä¸­é—´ä»¶ä¸æ˜¯HTTPï¼Œæ€ä¹ˆä¼ é€’è¿½è¸ªä¿¡æ¯ï¼Ÿ

è§£å†³æ–¹æ¡ˆï¼š
æŠŠè¿½è¸ªä¿¡æ¯æ”¾åˆ°æ¶ˆæ¯çš„Header/Propertiesé‡Œ
```

**RabbitMQç¤ºä¾‹**

```java
// æœåŠ¡Aå‘é€æ¶ˆæ¯
public void sendMessage() {
    // 1. è·å–è¿½è¸ªä¿¡æ¯
    String traceId = tracer.activeSpan().getTraceId();
    String spanId = tracer.activeSpan().getSpanId();
    
    // 2. æ”¾å…¥æ¶ˆæ¯å±æ€§
    MessageProperties props = new MessageProperties();
    props.setHeader("X-B3-TraceId", traceId);
    props.setHeader("X-B3-SpanId", spanId);
    
    // 3. å‘é€æ¶ˆæ¯
    rabbitTemplate.send("order-queue", message, props);
}

// æœåŠ¡Bæ¶ˆè´¹æ¶ˆæ¯
@RabbitListener(queues = "order-queue")
public void consumeMessage(Message message) {
    // 1. æå–è¿½è¸ªä¿¡æ¯
    String traceId = message.getMessageProperties()
        .getHeader("X-B3-TraceId");
    
    // 2. åˆ›å»ºSpanç»§ç»­è¿½è¸ª
    Span span = tracer.buildSpan("å¤„ç†è®¢å•æ¶ˆæ¯")
        .withTag("trace.id", traceId)
        .start();
    
    // 3. å¤„ç†ä¸šåŠ¡
    processOrderMessage(message);
    
    span.finish();
}
```

### 6.4 RPCæ¡†æ¶çš„è¿½è¸ªä¼ é€’


**Dubbo/gRPCç­‰RPCæ¡†æ¶**

```
åŸç†ï¼š
RPCæ¡†æ¶æœ‰è‡ªå·±çš„"ä¸Šä¸‹æ–‡ä¼ é€’"æœºåˆ¶
æŠŠè¿½è¸ªä¿¡æ¯æ”¾åˆ°RPCä¸Šä¸‹æ–‡é‡Œè‡ªåŠ¨ä¼ é€’

Dubboç¤ºä¾‹ï¼š
å‘é€æ–¹ â†’ æ‹¦æˆªå™¨æå–è¿½è¸ªä¿¡æ¯ â†’ æ”¾å…¥RpcContext
         â†“
æ¥æ”¶æ–¹ â† æ‹¦æˆªå™¨è¯»å–è¿½è¸ªä¿¡æ¯ â† ä»RpcContextè·å–
```

**å…³é”®ç‚¹**

```
âœ… HTTPåè®®ï¼šç”¨è¯·æ±‚å¤´ä¼ é€’
âœ… æ¶ˆæ¯é˜Ÿåˆ—ï¼šç”¨æ¶ˆæ¯å±æ€§ä¼ é€’
âœ… RPCæ¡†æ¶ï¼šç”¨ä¸Šä¸‹æ–‡ä¼ é€’
âœ… æ ¸å¿ƒæ€æƒ³ï¼šæ‰¾åˆ°"èƒ½æºå¸¦é¢å¤–ä¿¡æ¯çš„åœ°æ–¹"
```

---

## 7. ğŸ”§ åè®®å…¼å®¹æ€§å¤„ç†


### 7.1 å¤šåè®®å…±å­˜åœºæ™¯


**å®é™…é—®é¢˜**

```
å…¬å¸ç°çŠ¶ï¼š
- æ—§ç³»ç»Ÿç”¨Zipkinï¼ˆB3åè®®ï¼‰
- æ–°ç³»ç»Ÿç”¨Jaegerï¼ˆUber Traceåè®®ï¼‰
- äº‘æœåŠ¡ç”¨AWS X-Ray

æ€ä¹ˆè®©å®ƒä»¬èƒ½äº’ç›¸è¿½è¸ªï¼Ÿ
```

### 7.2 åè®®è½¬æ¢ç­–ç•¥


**ğŸ”¸ ç­–ç•¥1ï¼šç½‘å…³ç»Ÿä¸€è½¬æ¢**

```
è¯·æ±‚æµç¨‹ï¼š
å®¢æˆ·ç«¯ï¼ˆW3Cæ ¼å¼ï¼‰
    â†“
APIç½‘å…³ï¼ˆè¯†åˆ«å¹¶è½¬æ¢ï¼‰
    â†“
å†…éƒ¨æœåŠ¡ï¼ˆB3æ ¼å¼ï¼‰

ç½‘å…³åšçš„äº‹ï¼š
1. è¯†åˆ«è¯·æ±‚å¤´æ˜¯ä»€ä¹ˆåè®®
2. æå–TraceIDã€SpanID
3. è½¬æ¢æˆå†…éƒ¨æœåŠ¡éœ€è¦çš„æ ¼å¼
4. ç»§ç»­ä¼ é€’
```

**ğŸ”¸ ç­–ç•¥2ï¼šå¤šåè®®åŒæ—¶æ”¯æŒ**

```java
// åŒæ—¶å†™å…¥å¤šç§æ ¼å¼
public void propagateTrace(HttpRequest request) {
    String traceId = getCurrentTraceId();
    String spanId = getCurrentSpanId();
    
    // B3åè®®
    request.setHeader("X-B3-TraceId", traceId);
    request.setHeader("X-B3-SpanId", spanId);
    
    // W3Cåè®®
    request.setHeader("traceparent", 
        "00-" + traceId + "-" + spanId + "-01");
    
    // Uber Traceåè®®
    request.setHeader("uber-trace-id", 
        traceId + ":" + spanId + ":0:1");
}

// è¯»å–æ—¶æŒ‰ä¼˜å…ˆçº§å°è¯•
public String extractTraceId(HttpRequest request) {
    // ä¼˜å…ˆW3Cæ ‡å‡†
    String w3c = request.getHeader("traceparent");
    if (w3c != null) {
        return extractFromW3C(w3c);
    }
    
    // å…¶æ¬¡B3åè®®
    String b3 = request.getHeader("X-B3-TraceId");
    if (b3 != null) {
        return b3;
    }
    
    // æœ€åUberåè®®
    String uber = request.getHeader("uber-trace-id");
    if (uber != null) {
        return extractFromUber(uber);
    }
    
    // éƒ½æ²¡æœ‰ï¼Œåˆ›å»ºæ–°çš„
    return generateNewTraceId();
}
```

### 7.3 SkyWalkingçš„å…¼å®¹å¤„ç†


**SkyWalkingçš„åšæ³•**

```
æ”¯æŒå¤šç§åè®®ï¼š
âœ… SkyWalkingåŸç”Ÿåè®®ï¼ˆsw8/sw6ï¼‰
âœ… Zipkin B3åè®®
âœ… Jaegeråè®®
âœ… W3C Trace Context

é…ç½®æ–¹å¼ï¼š
åœ¨agenté…ç½®æ–‡ä»¶ä¸­å¼€å¯ï¼š
plugin.propagation.protocols=sw8,b3,jaeger,w3c
```

**å·¥ä½œåŸç†**

```
æ¥æ”¶è¯·æ±‚æ—¶ï¼š
1. ä¾æ¬¡å°è¯•è§£æå„ç§åè®®
2. åªè¦æœ‰ä¸€ä¸ªèƒ½è§£ææˆåŠŸå°±ç”¨
3. æå–å‡ºTraceIDå’ŒSpanID

å‘é€è¯·æ±‚æ—¶ï¼š
1. æŒ‰é…ç½®çš„åè®®åˆ—è¡¨
2. åŒæ—¶å†™å…¥å¤šç§æ ¼å¼
3. ä¸‹æ¸¸æœåŠ¡è‡³å°‘èƒ½è¯†åˆ«ä¸€ç§
```

### 7.4 æœ€ä½³å®è·µå»ºè®®


**ğŸ¯ é€‰æ‹©æ ‡å‡†çš„ä¼˜å…ˆçº§**

```
1ï¸âƒ£ æ–°é¡¹ç›®é¦–é€‰ï¼šW3C Trace Context
   ç†ç”±ï¼šå›½é™…æ ‡å‡†ï¼Œæœªæ¥è¶‹åŠ¿

2ï¸âƒ£ å¤šè¿½è¸ªå·¥å…·ï¼šOpenTelemetry
   ç†ç”±ï¼šå…¼å®¹æ€§æœ€å¥½

3ï¸âƒ£ å•ä¸€å·¥å…·ï¼šå·¥å…·åŸç”Ÿåè®®
   ç†ç”±ï¼šæ€§èƒ½æœ€ä¼˜

4ï¸âƒ£ æ··åˆç¯å¢ƒï¼šå¤šåè®®æ”¯æŒ
   ç†ç”±ï¼šä¿è¯äº’é€š
```

**âš ï¸ æ³¨æ„äº‹é¡¹**

```
â— TraceIDæ ¼å¼ç»Ÿä¸€
  - ä¸åŒåè®®TraceIDé•¿åº¦å¯èƒ½ä¸åŒ
  - éœ€è¦åšæ ¼å¼è½¬æ¢æˆ–æˆªæ–­

â— é‡‡æ ·ç‡ä¿æŒä¸€è‡´
  - è½¬æ¢æ—¶ä¸è¦ä¸¢å¤±é‡‡æ ·æ ‡è®°
  - é¿å…éƒ¨åˆ†é“¾è·¯ä¸¢å¤±

â— æ€§èƒ½å¼€é”€è€ƒè™‘
  - å¤šåè®®æ”¯æŒä¼šå¢åŠ è§£æå¼€é”€
  - ç”Ÿäº§ç¯å¢ƒæŒ‰éœ€å¯ç”¨
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ ‡å‡†çš„ä½œç”¨ï¼šè§£å†³å·¥å…·ç»‘å®šã€é“¾è·¯æ–­è£‚ã€æ•°æ®å­¤å²›é—®é¢˜
ğŸ”¸ OpenTracingï¼šå®šä¹‰äº†Traceã€Spanç­‰è¿½è¸ªæ¦‚å¿µçš„APIè§„èŒƒ
ğŸ”¸ OpenTelemetryï¼šè¿½è¸ª+æŒ‡æ ‡+æ—¥å¿—ä¸‰åˆä¸€çš„ç»Ÿä¸€æ ‡å‡†
ğŸ”¸ B3åè®®ï¼šZipkinå®šä¹‰çš„è¿½è¸ªä¿¡æ¯ä¼ æ’­åè®®
ğŸ”¸ W3Cæ ‡å‡†ï¼šå›½é™…æ ‡å‡†åŒ–çš„è¿½è¸ªä¸Šä¸‹æ–‡ä¼ é€’è§„èŒƒ
ğŸ”¸ è·¨è¿›ç¨‹è¿½è¸ªï¼šé€šè¿‡è¯·æ±‚å¤´/æ¶ˆæ¯å±æ€§ä¼ é€’è¿½è¸ªä¿¡æ¯
ğŸ”¸ åè®®å…¼å®¹ï¼šå¤šåè®®å¹¶å­˜æ—¶çš„è½¬æ¢å’Œé€‚é…ç­–ç•¥
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ æ ‡å‡† vs å®ç°**

```
æ ‡å‡†ï¼ˆè§„èŒƒï¼‰ï¼š
- OpenTracingï¼šå®šä¹‰APIæ¥å£
- OpenTelemetryï¼šå®šä¹‰æ•°æ®æ¨¡å‹å’Œåè®®
- W3Cï¼šå®šä¹‰ä¼ æ’­æ ¼å¼

å®ç°ï¼ˆå·¥å…·ï¼‰ï¼š
- Zipkinï¼šå…·ä½“çš„è¿½è¸ªç³»ç»Ÿ
- Jaegerï¼šå…·ä½“çš„è¿½è¸ªç³»ç»Ÿ
- SkyWalkingï¼šå…·ä½“çš„è¿½è¸ªç³»ç»Ÿ

å…³ç³»ï¼š
æ ‡å‡†æ˜¯"æ¸¸æˆè§„åˆ™"ï¼Œå·¥å…·æ˜¯"ç©å®¶"
éµå®ˆæ ‡å‡†çš„å·¥å…·å¯ä»¥äº’é€š
```

**ğŸ”¹ è¿½è¸ªä¿¡æ¯çš„ä¼ é€’æœ¬è´¨**

```
æ ¸å¿ƒï¼šTraceIDä¿æŒä¸å˜ï¼ŒSpanIDé€çº§åˆ›å»º

HTTPä¼ é€’ï¼š
è¯·æ±‚å¤´ â†’ X-B3-TraceId / traceparent

æ¶ˆæ¯é˜Ÿåˆ—ä¼ é€’ï¼š
æ¶ˆæ¯å±æ€§ â†’ MessageProperties / Headers

RPCä¼ é€’ï¼š
ä¸Šä¸‹æ–‡ â†’ RpcContext / Metadata

æœ¬è´¨éƒ½æ˜¯ï¼šæ‰¾åˆ°èƒ½æºå¸¦é¢å¤–ä¿¡æ¯çš„"è½½ä½“"
```

**ğŸ”¹ åè®®é€‰æ‹©çš„æƒè¡¡**

```
W3C Trace Contextï¼š
âœ… ä¼˜ç‚¹ï¼šæ ‡å‡†åŒ–ã€è·¨äº‘ã€æµè§ˆå™¨æ”¯æŒ
âŒ ç¼ºç‚¹ï¼šè¾ƒæ–°ï¼Œéƒ¨åˆ†è€å·¥å…·ä¸æ”¯æŒ

B3åè®®ï¼š
âœ… ä¼˜ç‚¹ï¼šå¹¿æ³›æ”¯æŒã€æˆç†Ÿç¨³å®š
âŒ ç¼ºç‚¹ï¼šéå›½é™…æ ‡å‡†

OpenTelemetryï¼š
âœ… ä¼˜ç‚¹ï¼šå…¨é¢ã€å…¼å®¹æ€§å¥½
âŒ ç¼ºç‚¹ï¼šå­¦ä¹ æˆæœ¬ç¨é«˜

å»ºè®®ï¼šæ–°é¡¹ç›®ç”¨W3C + OpenTelemetry
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ æ–°æ‰‹å…¥é—¨è·¯å¾„**

```
ç¬¬ä¸€æ­¥ï¼šç†è§£æ¦‚å¿µ
- Trace = å®Œæ•´è¯·æ±‚
- Span = æ“ä½œç‰‡æ®µ
- ä¼ æ’­ = ä¿¡æ¯ä¼ é€’

ç¬¬äºŒæ­¥ï¼šé€‰æ‹©æ ‡å‡†
- å°é¡¹ç›®ï¼šç›´æ¥ç”¨å·¥å…·åŸç”Ÿåè®®
- å¤§é¡¹ç›®ï¼šOpenTelemetry + W3C

ç¬¬ä¸‰æ­¥ï¼šé›†æˆå®è·µ
- HTTPæœåŠ¡ï¼šè¯·æ±‚å¤´ä¼ é€’
- æ¶ˆæ¯é˜Ÿåˆ—ï¼šæ¶ˆæ¯å±æ€§ä¼ é€’
- è§‚å¯Ÿè¿½è¸ªï¼šæŸ¥çœ‹å®Œæ•´é“¾è·¯

ç¬¬å››æ­¥ï¼šä¼˜åŒ–å‡çº§
- å¤šåè®®å…¼å®¹
- é‡‡æ ·ç‡è°ƒä¼˜
- æ€§èƒ½ä¼˜åŒ–
```

**ğŸ”§ å¸¸è§é—®é¢˜å¤„ç†**

| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|---------|
| **é“¾è·¯æ–­äº†** | åè®®ä¸åŒ¹é… | å¼€å¯å¤šåè®®æ”¯æŒ |
| **TraceIDå¯¹ä¸ä¸Š** | æ ¼å¼è½¬æ¢é”™è¯¯ | ç»Ÿä¸€TraceIDé•¿åº¦ |
| **æ€§èƒ½ä¸‹é™** | é‡‡æ ·ç‡100% | è°ƒæ•´é‡‡æ ·ç‡10-20% |
| **è·¨äº‘è¿½è¸ªå¤±è´¥** | åè®®ä¸é€šç”¨ | ä½¿ç”¨W3Cæ ‡å‡† |

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
æ ‡å‡†å¦‚è§„åˆ™ï¼Œå·¥å…·æ˜¯å®ç°
TraceIDå…¨ç¨‹ä¼ ï¼ŒSpanIDé€çº§å»º  
HTTPç”¨è¯·æ±‚å¤´ï¼Œæ¶ˆæ¯ç”¨å±æ€§ä¼ 
åè®®èƒ½è½¬æ¢ï¼Œå…¼å®¹ä¿å¹³å®‰
```