---
title: 3ã€Java Agentå­—èŠ‚ç å¢å¼ºæŠ€æœ¯
---
## ğŸ“š ç›®å½•

1. [Java AgentåŸºç¡€æ¦‚å¿µ](#1-java-agentåŸºç¡€æ¦‚å¿µ)
2. [å­—èŠ‚ç æ’æ¡©æŠ€æœ¯](#2-å­—èŠ‚ç æ’æ¡©æŠ€æœ¯)
3. [æ–¹æ³•æ‹¦æˆªå™¨æœºåˆ¶](#3-æ–¹æ³•æ‹¦æˆªå™¨æœºåˆ¶)
4. [SkyWalkingæ’ä»¶ä½“ç³»](#4-skywalkingæ’ä»¶ä½“ç³»)
5. [æ€§èƒ½å½±å“ä¸ä¼˜åŒ–](#5-æ€§èƒ½å½±å“ä¸ä¼˜åŒ–)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”§ Java AgentåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Java Agent


**é€šä¿—ç†è§£**ï¼šJava Agentå°±åƒæ˜¯ç»™ä½ çš„ç¨‹åºè£…äº†ä¸€ä¸ª"ç›‘æ§æ‘„åƒå¤´"ï¼Œåœ¨ç¨‹åºè¿è¡Œæ—¶æ‚„æ‚„åœ°è®°å½•ä¸‹å®ƒåšäº†ä»€ä¹ˆï¼Œä½†ä¸ä¼šæ”¹å˜ç¨‹åºåŸæœ¬çš„åŠŸèƒ½ã€‚

```
ä¼ ç»ŸJavaç¨‹åºè¿è¡Œï¼š
ä½ çš„ä»£ç  â†’ JVMæ‰§è¡Œ â†’ å¾—åˆ°ç»“æœ

åŠ å…¥Java Agentåï¼š
ä½ çš„ä»£ç  â†’ Agentå·å·è®°å½• â†’ JVMæ‰§è¡Œ â†’ å¾—åˆ°ç»“æœ + ç›‘æ§æ•°æ®
```

**æ ¸å¿ƒå®šä¹‰**ï¼š
```
Java Agentï¼šä¸€ç§åœ¨Javaè™šæ‹Ÿæœº(JVM)å¯åŠ¨æ—¶åŠ è½½çš„ç‰¹æ®Šç¨‹åº
ä½œç”¨ï¼šåœ¨ä¸ä¿®æ”¹åŸå§‹ä»£ç çš„æƒ…å†µä¸‹ï¼Œå¯¹ç¨‹åºè¡Œä¸ºè¿›è¡Œç›‘æ§å’Œå¢å¼º
ä½ç½®ï¼šè¿è¡Œåœ¨JVMå†…éƒ¨ï¼Œæ¯”åº”ç”¨ç¨‹åºæ›´åº•å±‚
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦Java Agent


**å®é™…é—®é¢˜åœºæ™¯**ï¼š

å‡è®¾ä½ æœ‰ä¸€ä¸ªç”µå•†ç³»ç»Ÿï¼Œçªç„¶å‘ç°æŸä¸ªæ¥å£å“åº”å¾ˆæ…¢ï¼Œä½ æƒ³çŸ¥é“ï¼š
- è¿™ä¸ªæ¥å£è°ƒç”¨äº†å“ªäº›æ–¹æ³•ï¼Ÿ
- æ¯ä¸ªæ–¹æ³•æ‰§è¡Œäº†å¤šé•¿æ—¶é—´ï¼Ÿ
- è®¿é—®äº†å“ªäº›æ•°æ®åº“ï¼Ÿ
- è°ƒç”¨äº†å“ªäº›ç¬¬ä¸‰æ–¹æœåŠ¡ï¼Ÿ

**ä¼ ç»Ÿæ–¹å¼çš„å›°å¢ƒ**ï¼š
```
âŒ æ–¹æ¡ˆ1ï¼šæ‰‹åŠ¨åŠ æ—¥å¿—
- éœ€è¦ä¿®æ”¹æ¯ä¸ªæ–¹æ³•
- ä»£ç å˜å¾—è‡ƒè‚¿
- æ—¥å¿—ä»£ç å’Œä¸šåŠ¡ä»£ç æ··åœ¨ä¸€èµ·

âŒ æ–¹æ¡ˆ2ï¼šä½¿ç”¨AOP
- éœ€è¦é…ç½®åˆ‡é¢
- åªèƒ½åœ¨Springç®¡ç†çš„Beanä¸­ä½¿ç”¨
- æ— æ³•ç›‘æ§ç¬¬ä¸‰æ–¹åº“

âœ… Java Agentæ–¹æ¡ˆï¼š
- æ— éœ€ä¿®æ”¹ä»»ä½•ä»£ç 
- è‡ªåŠ¨ç›‘æ§æ‰€æœ‰æ–¹æ³•
- å¯ä»¥ç›‘æ§ç¬¬ä¸‰æ–¹åº“
- éšæ—¶å¯ä»¥å¼€å¯/å…³é—­
```

### 1.3 Java Agentçš„å·¥ä½œåŸç†


**æ ¸å¿ƒæœºåˆ¶å›¾ç¤º**ï¼š
```
å¯åŠ¨è¿‡ç¨‹ï¼š
1. JVMå¯åŠ¨
   â†“
2. åŠ è½½Agent (premainæ–¹æ³•)
   â†“
3. Agentä¿®æ”¹å­—èŠ‚ç 
   â†“
4. åŠ è½½ä½ çš„åº”ç”¨ç¨‹åº
   â†“
5. è¿è¡Œè¢«å¢å¼ºåçš„ä»£ç 

è¿è¡Œæ—¶è¿‡ç¨‹ï¼š
åŸå§‹æ–¹æ³• â†’ Agentæ‹¦æˆª â†’ è®°å½•ä¿¡æ¯ â†’ æ‰§è¡ŒåŸæ–¹æ³• â†’ è¿”å›ç»“æœ
```

**ä¸¤ç§åŠ è½½æ–¹å¼**ï¼š

| åŠ è½½æ–¹å¼ | **å¯åŠ¨å‚æ•°** | **ä½¿ç”¨åœºæ™¯** | **é™åˆ¶** |
|---------|------------|------------|---------|
| **å¯åŠ¨æ—¶åŠ è½½** | `-javaagent:agent.jar` | ä»ç¨‹åºå¯åŠ¨å°±éœ€è¦ç›‘æ§ | éœ€è¦é‡å¯åº”ç”¨ |
| **è¿è¡Œæ—¶åŠ è½½** | `VirtualMachine.attach()` | ä¸´æ—¶è¯Šæ–­é—®é¢˜ | éƒ¨åˆ†åŠŸèƒ½å—é™ |

---

## 2. ğŸ” å­—èŠ‚ç æ’æ¡©æŠ€æœ¯


### 2.1 ä»€ä¹ˆæ˜¯å­—èŠ‚ç 


**é€šä¿—ç±»æ¯”**ï¼š
```
Javaæºä»£ç ï¼šå°±åƒæ˜¯èœè°±(äººç±»èƒ½çœ‹æ‡‚)
â†“ javacç¼–è¯‘
å­—èŠ‚ç ï¼šå°±åƒæ˜¯æœºå™¨æŒ‡ä»¤(JVMèƒ½çœ‹æ‡‚)
â†“ JVMæ‰§è¡Œ
ç¨‹åºè¿è¡Œï¼šå°±åƒæ˜¯åšå‡ºçš„èœ
```

**å­—èŠ‚ç ç¤ºä¾‹**ï¼š

åŸå§‹Javaä»£ç ï¼š
```java
public int add(int a, int b) {
    return a + b;
}
```

å¯¹åº”çš„å­—èŠ‚ç ï¼ˆç®€åŒ–ç‰ˆï¼‰ï¼š
```
ILOAD 1      // åŠ è½½å˜é‡a
ILOAD 2      // åŠ è½½å˜é‡b  
IADD         // æ‰§è¡ŒåŠ æ³•
IRETURN      // è¿”å›ç»“æœ
```

### 2.2 ä»€ä¹ˆæ˜¯å­—èŠ‚ç æ’æ¡©


**æ ¸å¿ƒæ¦‚å¿µ**ï¼šæ’æ¡©å°±æ˜¯åœ¨å­—èŠ‚ç ä¸­"æ’å…¥"é¢å¤–çš„æŒ‡ä»¤ï¼Œå°±åƒåœ¨èœè°±ä¸­åŠ å…¥æ–°çš„æ­¥éª¤ã€‚

**æ’æ¡©è¿‡ç¨‹å›¾ç¤º**ï¼š
```
åŸå§‹å­—èŠ‚ç ï¼š          æ’æ¡©åï¼š
æ–¹æ³•å¼€å§‹              æ–¹æ³•å¼€å§‹
  â†“                    â†“
æ‰§è¡Œä¸šåŠ¡é€»è¾‘    â†’    è®°å½•å¼€å§‹æ—¶é—´ï¼ˆæ–°å¢ï¼‰
  â†“                    â†“
æ–¹æ³•è¿”å›            æ‰§è¡Œä¸šåŠ¡é€»è¾‘
                       â†“
                    è®°å½•ç»“æŸæ—¶é—´ï¼ˆæ–°å¢ï¼‰
                       â†“
                    è®¡ç®—è€—æ—¶ï¼ˆæ–°å¢ï¼‰
                       â†“
                    æ–¹æ³•è¿”å›
```

**å®é™…ç¤ºä¾‹**ï¼š

åŸå§‹ä»£ç ï¼š
```java
public void queryUser(String userId) {
    // æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
    User user = userDao.findById(userId);
    return user;
}
```

Agentæ’æ¡©åï¼ˆæ•ˆæœç­‰åŒäºï¼‰ï¼š
```java
public void queryUser(String userId) {
    long startTime = System.currentTimeMillis(); // Agentè‡ªåŠ¨åŠ çš„
    String traceId = TraceContext.getTraceId();  // Agentè‡ªåŠ¨åŠ çš„
    
    try {
        // åŸå§‹ä¸šåŠ¡ä»£ç 
        User user = userDao.findById(userId);
        return user;
    } finally {
        long cost = System.currentTimeMillis() - startTime; // Agentè‡ªåŠ¨åŠ çš„
        reportToSkyWalking(traceId, cost); // Agentè‡ªåŠ¨åŠ çš„
    }
}
```

> ğŸ’¡ **å…³é”®ç‚¹**ï¼šä½ çš„æºä»£ç å®Œå…¨ä¸å˜ï¼Œä½†è¿è¡Œæ—¶ä¼šè‡ªåŠ¨åŠ ä¸Šç›‘æ§ä»£ç ï¼

### 2.3 å­—èŠ‚ç å¢å¼ºå·¥å…·


SkyWalkingä½¿ç”¨çš„å·¥å…·é“¾ï¼š

**Byte Buddyæ¡†æ¶**ï¼š
```
ç‰¹ç‚¹ï¼š
âœ… APIç®€å•æ˜“ç”¨
âœ… æ€§èƒ½å¼€é”€å°
âœ… æ”¯æŒå¤æ‚çš„å¢å¼ºé€»è¾‘
âœ… è¢«å¹¿æ³›ä½¿ç”¨

å¯¹æ¯”å…¶ä»–å·¥å…·ï¼š
- ASMï¼šæ€§èƒ½æœ€å¥½ï¼Œä½†APIå¤æ‚
- Javassistï¼šæ˜“ç”¨ï¼Œä½†æ€§èƒ½ä¸€èˆ¬
- Byte Buddyï¼šå¹³è¡¡æ˜“ç”¨æ€§å’Œæ€§èƒ½
```

**ç®€åŒ–çš„å¢å¼ºç¤ºä¾‹**ï¼š
```java
// ä½¿ç”¨Byte Buddyå¢å¼ºæ‰€æœ‰Serviceç±»
new AgentBuilder.Default()
    .type(nameEndsWith("Service"))  // åŒ¹é…æ‰€æœ‰Serviceç»“å°¾çš„ç±»
    .transform((builder, type, classLoader, module) ->
        builder.method(any())  // åŒ¹é…æ‰€æœ‰æ–¹æ³•
            .intercept(MethodDelegation.to(TimeInterceptor.class))
    )
    .installOnByteBuddyAgent();
```

---

## 3. ğŸ¯ æ–¹æ³•æ‹¦æˆªå™¨æœºåˆ¶


### 3.1 æ‹¦æˆªå™¨çš„å·¥ä½œæµç¨‹


**å®Œæ•´è°ƒç”¨é“¾è·¯**ï¼š
```
ç”¨æˆ·è°ƒç”¨æ–¹æ³•
   â†“
SkyWalkingæ‹¦æˆªå™¨æ•è·
   â†“
before() - æ–¹æ³•æ‰§è¡Œå‰
   â”œâ”€ åˆ›å»ºSpanï¼ˆè®°å½•èŠ‚ç‚¹ï¼‰
   â”œâ”€ è®°å½•å¼€å§‹æ—¶é—´
   â””â”€ æå–/ä¼ é€’TraceId
   â†“
æ‰§è¡ŒåŸå§‹ä¸šåŠ¡æ–¹æ³•
   â†“
after() - æ–¹æ³•æ‰§è¡Œå  
   â”œâ”€ è®°å½•ç»“æŸæ—¶é—´
   â”œâ”€ è®°å½•è¿”å›å€¼
   â””â”€ æ ‡è®°Spanç»“æŸ
   â†“
å¼‚å¸¸å¤„ç†ï¼ˆå¦‚æœæœ‰ï¼‰
   â”œâ”€ è®°å½•å¼‚å¸¸ä¿¡æ¯
   â””â”€ æ ‡è®°Spanå¼‚å¸¸
   â†“
ä¸ŠæŠ¥åˆ°SkyWalkingåç«¯
```

### 3.2 æ‹¦æˆªå™¨æ ¸å¿ƒæ¥å£


**åŸºç¡€æ‹¦æˆªå™¨ç¤ºä¾‹**ï¼š
```java
// SkyWalkingçš„æ‹¦æˆªå™¨æ¥å£
public interface InstanceMethodsAroundInterceptor {
    
    // æ–¹æ³•æ‰§è¡Œå‰è°ƒç”¨
    void beforeMethod(EnhancedInstance objInst, 
                     Method method,
                     Object[] allArguments,
                     Class<?>[] argumentsTypes,
                     MethodInterceptResult result);
    
    // æ–¹æ³•æ‰§è¡Œåè°ƒç”¨  
    Object afterMethod(EnhancedInstance objInst,
                      Method method, 
                      Object[] allArguments,
                      Class<?>[] argumentsTypes,
                      Object ret);
    
    // æ–¹æ³•å¼‚å¸¸æ—¶è°ƒç”¨
    void handleMethodException(EnhancedInstance objInst,
                              Method method,
                              Object[] allArguments, 
                              Class<?>[] argumentsTypes,
                              Throwable t);
}
```

### 3.3 å®é™…æ‹¦æˆªæ¡ˆä¾‹


**HTTPè¯·æ±‚æ‹¦æˆªç¤ºä¾‹**ï¼š

```java
public class SpringMVCInterceptor implements InstanceMethodsAroundInterceptor {
    
    @Override
    public void beforeMethod(EnhancedInstance objInst, Method method, 
                            Object[] allArguments, Class<?>[] argumentsTypes,
                            MethodInterceptResult result) {
        // è·å–HTTPè¯·æ±‚å¯¹è±¡
        HttpServletRequest request = (HttpServletRequest) allArguments[0];
        
        // åˆ›å»ºEntry Spanï¼ˆå…¥å£èŠ‚ç‚¹ï¼‰
        AbstractSpan span = ContextManager.createEntrySpan(
            request.getRequestURI(),  // æ“ä½œåç§°ï¼š/user/query
            null
        );
        
        // è®°å½•è¯·æ±‚ä¿¡æ¯
        span.setComponent(ComponentsDefine.SPRING_MVC);
        span.tag("http.method", request.getMethod());
        span.tag("http.url", request.getRequestURL().toString());
    }
    
    @Override
    public Object afterMethod(EnhancedInstance objInst, Method method,
                             Object[] allArguments, Class<?>[] argumentsTypes, 
                             Object ret) {
        // æ ‡è®°Spanç»“æŸ
        ContextManager.stopSpan();
        return ret;
    }
    
    @Override
    public void handleMethodException(EnhancedInstance objInst, Method method,
                                      Object[] allArguments, Class<?>[] argumentsTypes,
                                      Throwable t) {
        // è®°å½•å¼‚å¸¸
        AbstractSpan span = ContextManager.activeSpan();
        span.log(t);
        span.errorOccurred();
    }
}
```

**æ•ˆæœè¯´æ˜**ï¼š
```
åŸå§‹ä»£ç ï¼š
@GetMapping("/user/{id}")
public User getUser(@PathVariable String id) {
    return userService.findById(id);
}

æ‹¦æˆªåçš„æ•ˆæœï¼š
- è‡ªåŠ¨è®°å½•è¯·æ±‚è·¯å¾„ï¼š/user/123
- è‡ªåŠ¨è®°å½•HTTPæ–¹æ³•ï¼šGET
- è‡ªåŠ¨è®°å½•æ‰§è¡Œè€—æ—¶ï¼š45ms
- è‡ªåŠ¨è®°å½•å¼‚å¸¸ä¿¡æ¯ï¼ˆå¦‚æœå‡ºé”™ï¼‰
- è‡ªåŠ¨å…³è”TraceIdï¼Œå½¢æˆè°ƒç”¨é“¾
```

---

## 4. ğŸ”Œ SkyWalkingæ’ä»¶ä½“ç³»


### 4.1 æ’ä»¶æ¶æ„è®¾è®¡


**æ’ä»¶åˆ†å±‚ç»“æ„**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     SkyWalking Agent Core       â”‚ â† æ ¸å¿ƒå¼•æ“
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚       Plugin Manager            â”‚ â† æ’ä»¶ç®¡ç†å™¨
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ HTTPæ’ä»¶ â”‚  â”‚ RPCæ’ä»¶  â”‚       â”‚ â† å„ç§æ’ä»¶
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ DBæ’ä»¶   â”‚  â”‚ MQæ’ä»¶   â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 æ’ä»¶å®šä¹‰æ–‡ä»¶


**æ’ä»¶é…ç½®ç¤ºä¾‹** (`skywalking-plugin.def`)ï¼š
```properties
# Spring MVCæ’ä»¶å®šä¹‰
springmvc-annotation-5.x=
  org.apache.skywalking.apm.plugin.spring.mvc.v5.define.HandlerMethodInstrumentation

# MyBatisæ’ä»¶å®šä¹‰  
mybatis-3.x=
  org.apache.skywalking.apm.plugin.mybatis.define.ExecutorInstrumentation

# æ–‡ä»¶å«ä¹‰ï¼š
# æ’ä»¶å=å¢å¼ºå®šä¹‰ç±»çš„å…¨è·¯å¾„
```

### 4.3 å¸¸ç”¨æ’ä»¶ç±»å‹


| æ’ä»¶ç±»å‹ | **ç›‘æ§ç›®æ ‡** | **æ ¸å¿ƒåŠŸèƒ½** | **å…¸å‹ç¤ºä¾‹** |
|---------|------------|------------|------------|
| **HTTPæ’ä»¶** | Webæ¡†æ¶ | è®°å½•è¯·æ±‚ä¿¡æ¯ã€å“åº”æ—¶é—´ | `SpringMVCã€Servlet` |
| **RPCæ’ä»¶** | è¿œç¨‹è°ƒç”¨ | è®°å½•æœåŠ¡è°ƒç”¨é“¾è·¯ | `Dubboã€gRPC` |
| **æ•°æ®åº“æ’ä»¶** | æ•°æ®è®¿é—® | è®°å½•SQLè¯­å¥ã€æ‰§è¡Œæ—¶é—´ | `MyBatisã€JDBC` |
| **ç¼“å­˜æ’ä»¶** | ç¼“å­˜æ“ä½œ | è®°å½•ç¼“å­˜å‘½ä¸­ç‡ã€è€—æ—¶ | `Redisã€Jedis` |
| **æ¶ˆæ¯é˜Ÿåˆ—æ’ä»¶** | å¼‚æ­¥æ¶ˆæ¯ | è®°å½•æ¶ˆæ¯å‘é€/æ¶ˆè´¹ | `Kafkaã€RabbitMQ` |

### 4.4 æ’ä»¶å¼€å‘ç¤ºä¾‹


**è‡ªå®šä¹‰æ’ä»¶çš„ä¸‰æ­¥éª¤**ï¼š

**æ­¥éª¤1ï¼šå®šä¹‰å¢å¼ºç‚¹**
```java
public class MyServiceInstrumentation extends ClassInstanceMethodsEnhancePluginDefine {
    
    // æŒ‡å®šè¦å¢å¼ºçš„ç±»
    @Override
    protected ClassMatch enhanceClass() {
        return NameMatch.byName("com.example.MyService");
    }
    
    // æŒ‡å®šè¦å¢å¼ºçš„æ–¹æ³•
    @Override
    public InstanceMethodsInterceptPoint[] getInstanceMethodsInterceptPoints() {
        return new InstanceMethodsInterceptPoint[] {
            new InstanceMethodsInterceptPoint() {
                @Override
                public ElementMatcher<MethodDescription> getMethodsMatcher() {
                    return named("execute"); // æ‹¦æˆªexecuteæ–¹æ³•
                }
                
                @Override
                public String getMethodsInterceptor() {
                    return "com.example.MyInterceptor";
                }
            }
        };
    }
}
```

**æ­¥éª¤2ï¼šå®ç°æ‹¦æˆªé€»è¾‘**
```java
public class MyInterceptor implements InstanceMethodsAroundInterceptor {
    
    @Override
    public void beforeMethod(...) {
        AbstractSpan span = ContextManager.createLocalSpan("MyService/execute");
        span.tag("business.type", "custom");
    }
    
    @Override
    public Object afterMethod(...) {
        ContextManager.stopSpan();
        return ret;
    }
    
    @Override
    public void handleMethodException(...) {
        ContextManager.activeSpan().log(t);
    }
}
```

**æ­¥éª¤3ï¼šæ³¨å†Œæ’ä»¶**
```properties
# åœ¨skywalking-plugin.defæ–‡ä»¶ä¸­
myservice-plugin=com.example.MyServiceInstrumentation
```

---

## 5. âš¡ æ€§èƒ½å½±å“ä¸ä¼˜åŒ–


### 5.1 æ€§èƒ½å¼€é”€åˆ†æ


**Agentçš„æ€§èƒ½æ¶ˆè€—æ¥æº**ï¼š
```
1. å­—èŠ‚ç å¢å¼º
   â””â”€ å¯åŠ¨æ—¶ä¸€æ¬¡æ€§æ“ä½œï¼Œå½±å“å¯åŠ¨é€Ÿåº¦

2. æ–¹æ³•æ‹¦æˆª
   â””â”€ æ¯æ¬¡æ–¹æ³•è°ƒç”¨éƒ½è§¦å‘ï¼Œä¸»è¦æ€§èƒ½å¼€é”€

3. æ•°æ®é‡‡é›†
   â””â”€ åˆ›å»ºSpanã€è®°å½•æ•°æ®

4. ç½‘ç»œä¸ŠæŠ¥  
   â””â”€ å‘é€æ•°æ®åˆ°åç«¯
```

**å®æµ‹æ•°æ®å‚è€ƒ**ï¼š
```
æ— Agentï¼š                å¯ç”¨Agentï¼š
å“åº”æ—¶é—´ï¼š50ms          å“åº”æ—¶é—´ï¼š52ms
CPUä½¿ç”¨ï¼š20%           CPUä½¿ç”¨ï¼š22%
å†…å­˜å ç”¨ï¼š500MB        å†…å­˜å ç”¨ï¼š550MB

æ€§èƒ½æŸè€—ï¼šçº¦3-5%ï¼ˆå¯æ¥å—èŒƒå›´ï¼‰
```

### 5.2 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


**ä¼˜åŒ–é…ç½®é¡¹**ï¼š

```properties
# Agenté…ç½®æ–‡ä»¶ï¼šagent.config

# 1. é‡‡æ ·ç‡æ§åˆ¶
agent.sample_n_per_3_secs=9
# å«ä¹‰ï¼šæ¯3ç§’æœ€å¤šé‡‡æ ·9æ¬¡ï¼Œé™ä½å¼€é”€

# 2. å¿½ç•¥ç‰¹å®šè·¯å¾„
agent.ignore_suffix=.jpg,.css,.js
# å«ä¹‰ï¼šé™æ€èµ„æºä¸ç›‘æ§

# 3. é™åˆ¶Spanæ•°é‡
agent.span_limit_per_segment=300
# å«ä¹‰ï¼šå•æ¬¡è¿½è¸ªæœ€å¤š300ä¸ªSpan

# 4. å¼‚æ­¥ä¸ŠæŠ¥
collector.backend_service=127.0.0.1:11800
collector.get_agent_dynamic_config_interval=20
# å«ä¹‰ï¼šå®šæœŸæ‰¹é‡ä¸ŠæŠ¥ï¼Œå‡å°‘ç½‘ç»œå¼€é”€
```

**ä»£ç çº§ä¼˜åŒ–**ï¼š
```java
// åªåœ¨å…³é”®è·¯å¾„åˆ›å»ºSpan
if (needTrace) {  // å¢åŠ åˆ¤æ–­æ¡ä»¶
    AbstractSpan span = ContextManager.createLocalSpan(operationName);
    // ... ç›‘æ§é€»è¾‘
    ContextManager.stopSpan();
}

// ä½¿ç”¨å¯¹è±¡æ± å‡å°‘GC
private static final ObjectPool<Span> SPAN_POOL = new ObjectPool<>();
```

### 5.3 å¼€é”€æ§åˆ¶å»ºè®®


**åˆ†çº§ç›‘æ§ç­–ç•¥**ï¼š

```
ç”Ÿäº§ç¯å¢ƒï¼š
âœ… åªç›‘æ§æ ¸å¿ƒæ¥å£
âœ… é™ä½é‡‡æ ·ç‡ï¼ˆæ¯ç§’1-2æ¬¡ï¼‰
âœ… å¿½ç•¥é™æ€èµ„æº
âœ… å…³é—­Debugæ—¥å¿—

æµ‹è¯•ç¯å¢ƒï¼š
âœ… å…¨é‡ç›‘æ§
âœ… æé«˜é‡‡æ ·ç‡
âœ… å¼€å¯è¯¦ç»†æ—¥å¿—

å¼€å‘ç¯å¢ƒï¼š
âœ… æŒ‰éœ€å¼€å¯
âœ… å¯ä»¥ä¸è£…Agent
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Java Agentï¼šJVMå¯åŠ¨æ—¶åŠ è½½çš„ç›‘æ§ç¨‹åºï¼Œæ— éœ€ä¿®æ”¹ä»£ç 
ğŸ”¸ å­—èŠ‚ç æ’æ¡©ï¼šåœ¨ç¼–è¯‘åçš„å­—èŠ‚ç ä¸­æ’å…¥ç›‘æ§ä»£ç 
ğŸ”¸ æ–¹æ³•æ‹¦æˆªå™¨ï¼šåœ¨æ–¹æ³•æ‰§è¡Œå‰åè‡ªåŠ¨æ‰§è¡Œç›‘æ§é€»è¾‘
ğŸ”¸ æ’ä»¶ä½“ç³»ï¼šæ¨¡å—åŒ–è®¾è®¡ï¼Œæ”¯æŒå„ç§æ¡†æ¶çš„è‡ªåŠ¨ç›‘æ§
ğŸ”¸ æ€§èƒ½ä¼˜åŒ–ï¼šé€šè¿‡é‡‡æ ·ã€è¿‡æ»¤ã€å¼‚æ­¥ç­‰æ‰‹æ®µæ§åˆ¶å¼€é”€
```

### 6.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ Agentçš„æœ¬è´¨**
```
ç†è§£è¦ç‚¹ï¼š
- Agentæ˜¯"å¯„ç”Ÿ"åœ¨JVMå†…éƒ¨çš„ç¨‹åº
- é€šè¿‡ä¿®æ”¹å­—èŠ‚ç å®ç°"æ— ä¾µå…¥"ç›‘æ§
- ä¸æ”¹å˜ä¸šåŠ¡é€»è¾‘ï¼Œåªæ˜¯"æ—è§‚è€…"

ç±»æ¯”ï¼š
å°±åƒç»™æ±½è½¦è£…è¡Œè½¦è®°å½•ä»ªï¼Œè®°å½•è¡Œé©¶è¿‡ç¨‹ï¼Œä½†ä¸å½±å“é©¾é©¶
```

**ğŸ”¹ å­—èŠ‚ç å¢å¼ºçš„æ—¶æœº**
```
å¯åŠ¨æ—¶å¢å¼ºï¼š
- JVMåŠ è½½ç±»æ—¶ä¿®æ”¹å­—èŠ‚ç 
- ä¸€æ¬¡æ€§æ“ä½œï¼Œåç»­æ— é¢å¤–å¼€é”€

è¿è¡Œæ—¶å¢å¼ºï¼š
- å·²åŠ è½½çš„ç±»ä¹Ÿå¯ä»¥é‡æ–°å¢å¼º
- ç”¨äºä¸´æ—¶è¯Šæ–­é—®é¢˜
```

**ğŸ”¹ æ‹¦æˆªå™¨çš„æ‰§è¡Œé¡ºåº**
```
æ­£å¸¸æµç¨‹ï¼š
beforeMethod() â†’ ä¸šåŠ¡æ–¹æ³• â†’ afterMethod()

å¼‚å¸¸æµç¨‹ï¼š
beforeMethod() â†’ ä¸šåŠ¡æ–¹æ³•ï¼ˆæŠ›å¼‚å¸¸ï¼‰â†’ handleException()
```

### 6.3 å®é™…åº”ç”¨ä»·å€¼


**å…¸å‹ä½¿ç”¨åœºæ™¯**ï¼š
- **æ€§èƒ½è¯Šæ–­**ï¼šå‘ç°æ…¢æ–¹æ³•ï¼Œä¼˜åŒ–æ€§èƒ½
- **æ•…éšœæ’æŸ¥**ï¼šè¿½è¸ªå¼‚å¸¸è°ƒç”¨é“¾è·¯
- **å®¹é‡è§„åˆ’**ï¼šç»Ÿè®¡æ¥å£QPSã€RT
- **ä¾èµ–åˆ†æ**ï¼šæ¢³ç†æœåŠ¡ä¾èµ–å…³ç³»

**é…ç½®å»ºè®®**ï¼š
```
å¯åŠ¨å‚æ•°ï¼š
java -javaagent:/path/to/skywalking-agent.jar \
     -Dskywalking.agent.service_name=order-service \
     -Dskywalking.collector.backend_service=127.0.0.1:11800 \
     -jar your-application.jar
```

### 6.4 å­¦ä¹ è·¯çº¿å»ºè®®


```
ğŸ¯ å…¥é—¨é˜¶æ®µï¼š
1. ç†è§£Java Agentæ¦‚å¿µ
2. ä¼šé…ç½®Agentå¯åŠ¨å‚æ•°
3. çœ‹æ‡‚æ‹¦æˆªå™¨çš„æ‰§è¡Œæµç¨‹

ğŸ¯ è¿›é˜¶é˜¶æ®µï¼š
1. äº†è§£å­—èŠ‚ç åŸºç¡€çŸ¥è¯†
2. å­¦ä¹ Byte Buddyæ¡†æ¶
3. å¼€å‘è‡ªå®šä¹‰æ’ä»¶

ğŸ¯ é«˜çº§é˜¶æ®µï¼š
1. æ·±å…¥JVMå­—èŠ‚ç è§„èŒƒ
2. ä¼˜åŒ–Agentæ€§èƒ½
3. å®šåˆ¶åŒ–è¿½è¸ªç­–ç•¥
```

### 6.5 å¸¸è§é—®é¢˜è§£ç­”


> â“ **Agentä¼šä¸ä¼šå¯¼è‡´åº”ç”¨å¯åŠ¨å˜æ…¢ï¼Ÿ**
> 
> ä¼šæœ‰è½»å¾®å½±å“ï¼Œå› ä¸ºéœ€è¦å¢å¼ºå­—èŠ‚ç ã€‚é€šå¸¸å¢åŠ 1-3ç§’å¯åŠ¨æ—¶é—´ï¼Œå¯æ¥å—ã€‚

> â“ **Agentå‡ºé—®é¢˜ä¼šå¯¼è‡´åº”ç”¨å´©æºƒå—ï¼Ÿ**
> 
> ä¸ä¼šã€‚Agentå†…éƒ¨æœ‰å¼‚å¸¸éš”ç¦»ï¼Œå³ä½¿AgentæŠ¥é”™ï¼Œä¹Ÿä¸å½±å“ä¸šåŠ¡è¿è¡Œã€‚

> â“ **å¯ä»¥åŠ¨æ€å¼€å¯/å…³é—­ç›‘æ§å—ï¼Ÿ**
> 
> å¯ä»¥ã€‚é€šè¿‡é…ç½®ä¸­å¿ƒåŠ¨æ€è°ƒæ•´é‡‡æ ·ç‡ï¼Œè®¾ä¸º0å°±ç­‰äºå…³é—­ã€‚

> â“ **æ‰€æœ‰æ–¹æ³•éƒ½ä¼šè¢«ç›‘æ§å—ï¼Ÿ**
> 
> ä¸æ˜¯ã€‚åªç›‘æ§æ’ä»¶å®šä¹‰çš„ç›®æ ‡æ–¹æ³•ï¼Œå¦‚Controllerã€Serviceã€DAOå±‚ã€‚

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
Agentå¯åŠ¨å…ˆåŠ è½½ï¼Œå­—èŠ‚ç é‡Œåšæ‰‹è„š
æ–¹æ³•æ‰§è¡Œè‡ªåŠ¨æ‹¦ï¼Œå‰åè®°å½•ä¸æ‰“æ‰°
æ’ä»¶ä½“ç³»æ¨¡å—åŒ–ï¼Œå„ç§æ¡†æ¶å…¨è¦†ç›–
æ€§èƒ½å¼€é”€æ§åˆ¶å¥½ï¼Œé‡‡æ ·è¿‡æ»¤å°‘ä¸äº†
```