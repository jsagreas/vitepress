---
title: 4、采样策略配置与优化
---
## 📚 目录

1. [采样策略基础概念](#1-采样策略基础概念)
2. [常见采样方式详解](#2-常见采样方式详解)
3. [采样率配置与调优](#3-采样率配置与调优)
4. [性能与存储优化](#4-性能与存储优化)
5. [实战配置指南](#5-实战配置指南)
6. [核心要点总结](#6-核心要点总结)

---

## 1. 🎯 采样策略基础概念


### 1.1 什么是链路追踪采样


> 💡 **新手理解**  
> 想象你在超市收银台，不可能检查每个顾客的每件商品，但可以抽查一部分。采样就是这个道理——不记录所有请求，只记录一部分有代表性的请求。

**采样的本质**
```
正常情况（无采样）：
用户请求 → 100%记录 → 数据爆炸 💥
└─ 每秒10000个请求 = 每天8.64亿条记录

使用采样（10%采样率）：
用户请求 → 10%记录 → 数据可控 ✓
└─ 每秒10000个请求 = 每天8640万条记录（减少90%）
```

**为什么需要采样？**
- **存储成本**：全量记录会产生海量数据，存储成本高昂
- **性能影响**：记录每个请求会消耗系统资源，影响业务性能
- **分析效率**：数据太多反而不便于问题定位和分析
- **实际需求**：大多数场景下采样数据已足够分析问题

### 1.2 采样的核心目标


**平衡三角关系**
```
        数据完整性
           /\
          /  \
         /    \
        /      \
       /________\
  系统性能    存储成本

目标：在三者之间找到最佳平衡点
```

**采样策略要解决的问题**

| 问题场景 | **不采样的后果** | **合理采样的效果** |
|---------|----------------|------------------|
| 🔥 **高并发系统** | `Agent性能开销大，影响业务` | `降低开销，业务正常运行` |
| 💾 **存储压力** | `ES/数据库快速膨胀，成本高` | `数据量可控，成本合理` |
| 🔍 **问题排查** | `数据太多，难以定位问题` | `精准采样，快速定位` |
| 📊 **性能分析** | `全量分析耗时长` | `采样分析，效率高` |

---

## 2. 🔄 常见采样方式详解


### 2.1 全量采集（100%采样）


**工作原理**
```
每个请求都记录：
请求1 → 记录 ✓
请求2 → 记录 ✓
请求3 → 记录 ✓
...
请求N → 记录 ✓
```

**适用场景**
- ✅ **开发测试环境**：方便调试，无性能压力
- ✅ **低流量系统**：每天请求量 < 100万
- ✅ **核心链路**：关键业务必须全量监控
- ✅ **故障排查期**：临时开启，快速定位问题

**优缺点分析**

> ⚠️ **注意事项**  
> 全量采集看似完美，但在生产环境高并发下会成为"甜蜜的负担"

| 优势 | **劣势** |
|-----|---------|
| `数据完整，不遗漏任何问题` | `存储成本高（可能是采样的10-100倍）` |
| `精确统计，100%准确` | `Agent性能开销大，影响业务` |
| `问题追溯完整` | `数据查询慢，分析困难` |

### 2.2 概率采样（固定比例采样）


**工作原理**
```
设定采样率：10%
请求1 → 随机数0.15 > 0.10 → 不记录 ✗
请求2 → 随机数0.03 < 0.10 → 记录 ✓
请求3 → 随机数0.88 > 0.10 → 不记录 ✗
请求4 → 随机数0.09 < 0.10 → 记录 ✓
...

统计结果：约10%的请求被记录
```

**配置示例**
```yaml
# SkyWalking Agent配置
agent.config:
  # 采样率：10% = 1/10
  agent.sample_n_per_3_secs: 100
  # 或者使用概率采样
  sampling.rate: 1000  # 万分之1000 = 10%
```

> 💭 **理解技巧**  
> 想象掷骰子，掷到1就记录，掷到2-10就不记录。这就是10%的概率采样。

**适用场景**
- ✅ **中等流量系统**：每天100万-1000万请求
- ✅ **性能敏感应用**：不能承受全量采集的性能开销
- ✅ **长期监控**：稳定运行的生产环境
- ✅ **趋势分析**：关注整体趋势，不需要每个细节

**配置建议**

| 流量级别 | **推荐采样率** | **说明** |
|---------|--------------|---------|
| 🟢 **低流量** | `50%-100%` | `QPS < 100，可以较高采样` |
| 🟡 **中流量** | `10%-30%` | `QPS 100-1000，平衡性能和数据` |
| 🔴 **高流量** | `1%-5%` | `QPS > 1000，降低性能影响` |
| ⚫ **超高流量** | `0.1%-1%` | `QPS > 10000，极限优化` |

### 2.3 动态采样（智能采样）


**工作原理**
```
智能调整采样率：

正常情况（系统健康）：
QPS: 1000 → 采样率: 5% → 记录50个请求

异常情况（响应变慢）：
QPS: 1000 → 采样率: 50% → 记录500个请求
└─ 自动提高采样率，捕获更多异常数据

恢复正常：
QPS: 1000 → 采样率: 5% → 记录50个请求
└─ 自动降低采样率，减少开销
```

**触发条件示例**
```yaml
# 动态采样配置（示例）
dynamic_sampling:
  # 正常情况采样率
  normal_rate: 0.05  # 5%
  
  # 触发条件
  triggers:
    - condition: response_time > 1000ms
      action: increase_rate_to 0.3  # 提升到30%
    
    - condition: error_rate > 5%
      action: increase_rate_to 0.5  # 提升到50%
    
    - condition: cpu_usage > 80%
      action: decrease_rate_to 0.01  # 降低到1%
```

> 🎯 **核心优势**  
> 动态采样就像"智能空调"，会根据温度自动调节。系统正常时省资源，出问题时多记录。

**适用场景**
- ✅ **不确定的流量**：流量波动大的系统
- ✅ **自动化运维**：减少人工干预
- ✅ **故障自愈**：问题出现时自动提高采样
- ✅ **成本敏感**：在性能和数据间智能平衡

### 2.4 热点请求优先采样


**工作原理**
```
请求类型分级采样：

核心接口（必采样）：
/api/payment → 100% 采样 ✓
/api/order   → 100% 采样 ✓

重要接口（高采样）：
/api/user    → 30% 采样
/api/product → 30% 采样

普通接口（低采样）：
/api/health  → 1% 采样
/api/static  → 0.1% 采样
```

**配置示例**
```yaml
# 基于URL的采样策略
sampling_rules:
  - pattern: "/api/payment/**"
    rate: 1.0  # 100% 采样
    
  - pattern: "/api/order/**"
    rate: 1.0  # 100% 采样
    
  - pattern: "/api/user/**"
    rate: 0.3  # 30% 采样
    
  - pattern: "/api/**"
    rate: 0.05  # 其他接口 5% 采样
    
  - pattern: "/health"
    rate: 0.01  # 健康检查 1% 采样
```

**实际应用案例**
```
电商系统采样策略：

高优先级（100%）：
├─ 下单接口
├─ 支付接口
└─ 退款接口

中优先级（30%）：
├─ 购物车
├─ 商品详情
└─ 用户信息

低优先级（5%）：
├─ 搜索接口
├─ 推荐接口
└─ 评论接口

忽略级（0.1%）：
├─ 静态资源
├─ 健康检查
└─ 监控探针
```

---

## 3. ⚙️ 采样率配置与调优


### 3.1 采样率过高的问题


**问题表现**
```
采样率 80% 的系统：
                                          
性能影响：                  存储压力：
CPU: 15% ↑                 磁盘: 2TB/天 ↑
内存: 20% ↑                ES查询: 慢 ↓
网络: 300MB/s ↑            成本: 高 ↑

业务影响：                  运维难度：
响应时间: +50ms            数据清理: 频繁
吞吐量: -10%               查询超时: 常见
```

> ⚠️ **真实案例**  
> 某公司设置了80%采样率，导致每天产生2TB追踪数据，ES集群磁盘3天就满了，被迫紧急降低采样率到10%。

**如何识别采样率过高**
- Agent CPU使用率 > 10%
- 网络传输带宽 > 100MB/s
- 存储增长 > 500GB/天
- 业务接口响应时间明显增加

**解决方案**
```yaml
# 优化前（采样率过高）
agent.sample_n_per_3_secs: 8000  # 80%

# 优化后（分级采样）
agent.sample_n_per_3_secs: 1000  # 默认10%

# 配合动态采样
dynamic_config:
  core_api_rate: 0.5      # 核心接口50%
  normal_api_rate: 0.1    # 普通接口10%
  low_api_rate: 0.01      # 低优先级1%
```

### 3.2 采样率过低的问题


**问题表现**
```
采样率 0.1% 的系统（千分之一）：

问题定位难：
偶发问题 → 可能没被采样 → 无法复现
间歇性错误 → 数据不足 → 难以分析
性能抖动 → 采样遗漏 → 找不到原因

统计不准确：
实际错误率: 5%
采样显示: 0.5% (数据太少，失真)
```

**如何识别采样率过低**
- 问题排查时经常"无数据可查"
- 错误率统计与实际日志不符
- 性能分析曲线不平滑，数据点太少
- 告警触发后查不到相关链路

**解决方案**

| 场景 | **采样率调整** | **补充措施** |
|-----|--------------|------------|
| 🔴 **故障排查** | `临时提升到30%-50%` | `结合日志和指标分析` |
| 🟡 **性能优化** | `提升到10%-20%` | `关注慢请求，全量采样` |
| 🟢 **日常监控** | `保持1%-5%` | `核心接口单独配置高采样率` |

### 3.3 最佳实践配置


**分层采样策略**
```yaml
# SkyWalking配置文件（推荐）

# 默认基准采样率
agent.sample_n_per_3_secs: 300  # 3秒300次 ≈ 10%

# 特殊路径配置
trace.ignore_path: 
  - /health
  - /metrics
  - /favicon.ico

# 核心链路配置
trace.force_sample_path:
  - /api/payment/**
  - /api/order/create
  - /api/refund/**

# 错误全采样
trace.error.sample: true  # 错误请求100%采样

# 慢请求全采样  
trace.slow.sample: true   # 响应时间>3s的100%采样
trace.slow.threshold: 3000
```

**不同环境的采样率建议**

```
开发环境 (DEV)：
采样率: 100%
原因: 方便调试，无性能压力
配置: agent.sample_n_per_3_secs=-1

测试环境 (TEST)：
采样率: 50%
原因: 模拟生产，兼顾性能测试
配置: agent.sample_n_per_3_secs=5000

预发布环境 (STAGING)：
采样率: 20%
原因: 接近生产，但流量较小
配置: agent.sample_n_per_3_secs=2000

生产环境 (PROD)：
采样率: 5%-10%
原因: 平衡性能和监控需求
配置: agent.sample_n_per_3_secs=500-1000
```

---

## 4. 🚀 性能与存储优化


### 4.1 存储压力优化


**数据量估算公式**
```
每日数据量 = 请求总数 × 采样率 × 单条链路大小

示例计算：
请求总数: 1亿次/天
采样率: 10%
单条链路: 10KB

每日数据量 = 100,000,000 × 0.1 × 10KB
          = 10,000,000 × 10KB
          = 100GB/天
```

**存储优化策略**

| 优化方向 | **具体措施** | **效果** |
|---------|------------|---------|
| 🎯 **降低采样率** | `核心10%，普通1%，健康检查0.1%` | `数据量减少70%` |
| 🗜️ **数据压缩** | `启用GZIP压缩，压缩比3:1` | `存储减少66%` |
| ⏰ **数据保留期** | `7天详细数据，30天聚合数据` | `长期存储减少80%` |
| 🔄 **分级存储** | `热数据SSD，冷数据HDD` | `成本降低50%` |

**ElasticSearch优化配置**
```yaml
# ES索引生命周期管理
indices.lifecycle:
  # 热数据（0-3天）
  hot_phase:
    min_age: 0d
    actions:
      rollover:
        max_size: 50GB
        max_age: 1d
  
  # 温数据（3-7天）  
  warm_phase:
    min_age: 3d
    actions:
      shrink:
        number_of_shards: 1
      force_merge:
        max_num_segments: 1
  
  # 冷数据（7-30天）
  cold_phase:
    min_age: 7d
    actions:
      allocate:
        require:
          box_type: cold
  
  # 删除（30天后）
  delete_phase:
    min_age: 30d
    actions:
      delete: {}
```

### 4.2 性能影响控制


**Agent性能开销分析**
```
正常采样（10%）的开销：

CPU开销：
无采样: 0%
采样中: 3-5% ↑
原因: 数据序列化、网络发送

内存开销：
无采样: 100MB
采样中: 120MB ↑
原因: 链路数据缓存

网络开销：
无采样: 0 MB/s
采样中: 10-20 MB/s ↑
原因: 向OAP发送追踪数据
```

**性能优化技巧**

> 💡 **优化建议**  
> 性能优化要"对症下药"，先监控定位瓶颈，再针对性优化。

**1. 批量发送优化**
```yaml
# Agent配置
collector.backend_service: oap-server:11800

# 批量配置
agent.buffer.channel_size: 10000    # 缓冲区大小
agent.buffer.buffer_size: 1000      # 批量发送条数
agent.keep_tracing: true            # 持续追踪
```

**2. 异步处理优化**
```yaml
# 启用异步发送
agent.async: true
agent.async_buffer_size: 2048

# 工作线程数
agent.collector.grpc.worker.thread: 4
```

**3. 采样决策前置**
```
优化前（记录后判断）：
请求 → 记录数据 → 判断采样 → 丢弃（浪费资源）

优化后（判断后记录）：
请求 → 判断采样 → 记录数据（节省资源）
      ↓
    丢弃（不浪费资源）
```

### 4.3 监控采样效果


**关键指标监控**
```yaml
# 采样效果监控指标

采样率指标：
- skywalking_agent_sample_rate
- skywalking_agent_sampled_count
- skywalking_agent_total_count

性能指标：
- skywalking_agent_cpu_usage
- skywalking_agent_memory_usage
- skywalking_agent_network_bytes

存储指标：
- elasticsearch_index_size
- elasticsearch_query_latency
- elasticsearch_disk_usage
```

**告警阈值设置**
```yaml
# Prometheus告警规则
groups:
  - name: skywalking_sampling
    rules:
      - alert: SamplingRateTooHigh
        expr: skywalking_agent_sample_rate > 0.5
        for: 5m
        annotations:
          summary: "采样率过高，可能影响性能"
          
      - alert: SamplingRateTooLow
        expr: skywalking_agent_sample_rate < 0.01
        for: 5m
        annotations:
          summary: "采样率过低，可能遗漏问题"
          
      - alert: StorageGrowthTooFast
        expr: rate(elasticsearch_index_size[1h]) > 10GB
        for: 10m
        annotations:
          summary: "存储增长过快，检查采样配置"
```

---

## 5. 🛠️ 实战配置指南


### 5.1 电商系统采样方案


**业务场景分析**
```
电商系统特点：
- 流量高峰：秒杀、促销时QPS可达10万+
- 核心链路：下单、支付不能出错
- 一般链路：商品浏览、搜索可适当降低监控
- 低价值链路：健康检查、静态资源可忽略
```

**分级采样配置**
```yaml
# application.yml
skywalking:
  agent:
    # 基础配置
    service-name: ecommerce-order-service
    
    # 采样配置
    sample:
      # 默认采样率 5%
      default-rate: 0.05
      
      # 核心链路（100%采样）
      force-sample-paths:
        - /api/order/create
        - /api/payment/pay
        - /api/payment/callback
        - /api/refund/**
      
      # 重要链路（30%采样）
      high-priority-paths:
        - /api/cart/**
        - /api/user/login
        - /api/order/query
      
      # 普通链路（5%采样）
      normal-paths:
        - /api/product/**
        - /api/search/**
        - /api/recommend/**
      
      # 忽略链路（0%采样）
      ignore-paths:
        - /health
        - /actuator/**
        - /static/**
        - /favicon.ico
    
    # 特殊规则
    trace:
      # 错误全采样
      sample-error: true
      
      # 慢请求全采样（>2秒）
      sample-slow: true
      slow-threshold: 2000
```

**预期效果**
```
优化前（全量采集）：
每日数据量: 500GB
Agent CPU: 15%
响应时间: +80ms

优化后（分级采样）：
每日数据量: 50GB ↓ 90%
Agent CPU: 3% ↓ 80%
响应时间: +15ms ↓ 81%

同时保证：
- 核心链路100%可追踪
- 问题定位不受影响
- 性能分析数据充足
```

### 5.2 微服务架构采样方案


**架构说明**
```
微服务架构（10个服务）：

网关层：
API Gateway → 采样率: 10%

业务层：
├─ User Service    → 20%（用户相关，重要）
├─ Order Service   → 100%（订单核心）
├─ Payment Service → 100%（支付核心）
├─ Product Service → 5%（商品查询，量大）
└─ Message Service → 1%（消息推送，量大）

基础层：
├─ Auth Service    → 50%（认证，中等重要）
└─ Config Service  → 1%（配置，低优先级）
```

**统一配置管理**
```yaml
# Nacos配置中心
# Group: skywalking-config
# DataId: sampling-strategy.yml

sampling:
  # 全局默认
  global:
    default-rate: 0.05
    error-sample: true
    slow-sample: true
    slow-threshold: 3000
  
  # 服务级配置
  services:
    - name: api-gateway
      rate: 0.1
      force-paths: ["/api/v1/**"]
      
    - name: user-service
      rate: 0.2
      force-paths: ["/user/login", "/user/register"]
      
    - name: order-service
      rate: 1.0  # 100%
      ignore-paths: ["/health"]
      
    - name: payment-service
      rate: 1.0  # 100%
      ignore-paths: ["/health"]
      
    - name: product-service
      rate: 0.05
      ignore-paths: ["/product/image/**"]
      
    - name: message-service
      rate: 0.01
      ignore-paths: ["/health", "/metrics"]
```

### 5.3 动态调整实战


**场景：促销活动期间动态调整**

**调整策略**
```
活动前（T-1小时）：
提高采样率，确保问题及时发现
order-service: 50% → 100%
payment-service: 50% → 100%
其他服务: 保持不变

活动中（高峰期）：
根据系统压力动态调整
if (cpu > 80%) {
  降低采样率: 10% → 5%
}
if (error_rate > 5%) {
  提高采样率: 5% → 30%
}

活动后（T+2小时）：
恢复正常配置
所有服务: 恢复到基准值
```

**自动化脚本**
```python
# 动态调整采样率脚本
import requests
from datetime import datetime

def adjust_sampling_rate(service, rate):
    """调整采样率"""
    config_url = "http://nacos:8848/nacos/v1/cs/configs"
    
    # 读取当前配置
    current_config = get_config(service)
    
    # 更新采样率
    current_config['sampling']['rate'] = rate
    
    # 推送配置
    response = requests.post(config_url, data={
        'dataId': f'{service}-sampling',
        'group': 'skywalking',
        'content': yaml.dump(current_config)
    })
    
    print(f"[{datetime.now()}] {service} 采样率调整为 {rate*100}%")

# 活动前提高采样
adjust_sampling_rate('order-service', 1.0)
adjust_sampling_rate('payment-service', 1.0)

# 活动后恢复
time.sleep(7200)  # 2小时后
adjust_sampling_rate('order-service', 0.5)
adjust_sampling_rate('payment-service', 0.5)
```

---

## 6. 📋 核心要点总结


### 6.1 必须掌握的核心概念


> 🎯 **核心理解**  
> 采样不是"能省就省"，而是在数据完整性、系统性能、存储成本之间找平衡。

**采样策略三要素**
```
1. 采样率（Sample Rate）
   含义：记录请求的比例
   取值：0%-100%
   影响：数据量、性能、成本

2. 采样规则（Sample Rules）
   含义：哪些请求要记录
   类型：全量、概率、动态、分级
   影响：数据质量、问题定位

3. 采样优化（Sample Optimization）
   含义：如何调整采样配置
   方法：监控指标、动态调整、分层存储
   影响：系统稳定性、运维效率
```

### 6.2 关键配置速查


**快速配置模板**
```yaml
# 通用配置（复制即用）
skywalking:
  agent:
    # 服务名
    service-name: ${spring.application.name}
    
    # 采样配置
    sample:
      # 基准采样率
      default-rate: 0.1  # 10%
      
      # 核心链路100%
      force-sample-paths:
        - /api/payment/**
        - /api/order/**
      
      # 忽略路径
      ignore-paths:
        - /health
        - /actuator/**
      
      # 错误和慢请求全采样
      sample-error: true
      sample-slow: true
      slow-threshold: 3000
```

### 6.3 问题排查检查清单


**采样问题诊断流程**
```
步骤1：检查采样率
□ 查看agent配置的采样率
□ 确认是否符合预期
□ 检查动态配置是否生效

步骤2：检查性能影响
□ Agent CPU使用率是否正常（<10%）
□ 内存使用是否稳定
□ 网络带宽是否合理

步骤3：检查存储压力
□ ES磁盘使用率
□ 每日数据增长量
□ 索引查询性能

步骤4：检查数据质量
□ 关键链路是否有数据
□ 错误请求是否被采样
□ 慢请求是否被记录

步骤5：优化调整
□ 调整采样率
□ 配置分级采样
□ 启用动态采样
```

### 6.4 最佳实践清单


**✅ 推荐做法**
- 生产环境采用**分级采样**，核心高、普通低
- 启用**错误和慢请求全采样**，确保问题可追踪
- 使用**配置中心**统一管理采样配置
- 定期**监控采样效果**，根据数据调整
- 设置**存储生命周期**，自动清理旧数据

**❌ 避免误区**
- 不要盲目追求全量采集
- 不要所有服务用相同采样率
- 不要忽略存储和性能监控
- 不要固定采样率，要根据场景调整
- 不要采样率过低导致问题无法定位

**核心记忆口诀**
```
采样策略三平衡：性能、存储、数据全
分级采样是关键：核心高、普通低、无用不看
动态调整最灵活：正常省、异常详、自动化
监控优化要持续：看指标、调参数、验效果
```

---

**学习建议**

> 💭 **实践建议**  
> 1. 从开发环境100%采样开始，逐步降低到生产的5-10%  
> 2. 先配置核心链路的分级采样，再优化全局  
> 3. 定期查看监控数据，根据实际情况调整  
> 4. 记录每次调整的效果，形成自己的配置经验

**下一步学习**
- 深入学习SkyWalking告警配置
- 掌握自定义Trace扩展
- 了解多集群采样同步策略