---
title: 1ã€æœåŠ¡ç†”æ–­æ¦‚å¿µ
---
## ğŸ“š ç›®å½•

1. [æœåŠ¡ç†”æ–­åŸºç¡€](#1-æœåŠ¡ç†”æ–­åŸºç¡€)
2. [ç†”æ–­å™¨å·¥ä½œåŸç†](#2-ç†”æ–­å™¨å·¥ä½œåŸç†)
3. [ç†”æ–­ç­–ç•¥é…ç½®](#3-ç†”æ–­ç­–ç•¥é…ç½®)
4. [é™çº§å¤„ç†æœºåˆ¶](#4-é™çº§å¤„ç†æœºåˆ¶)
5. [å®æˆ˜åº”ç”¨åœºæ™¯](#5-å®æˆ˜åº”ç”¨åœºæ™¯)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ›¡ï¸ æœåŠ¡ç†”æ–­åŸºç¡€


### 1.1 ä»€ä¹ˆæ˜¯æœåŠ¡ç†”æ–­


**ğŸ”¸ ç”Ÿæ´»ä¸­çš„ä¾‹å­å¸®ä½ ç†è§£**

æƒ³è±¡ä½ å®¶é‡Œçš„ç”µè·¯ç³»ç»Ÿï¼šå½“ç”¨ç”µå™¨åŠŸç‡è¿‡å¤§æˆ–å‘ç”ŸçŸ­è·¯æ—¶ï¼Œæ–­è·¯å™¨ä¼šè‡ªåŠ¨è·³é—¸åˆ‡æ–­ç”µæºï¼Œä¿æŠ¤æ•´ä¸ªç”µè·¯ä¸è¢«çƒ§æ¯ã€‚ç­‰é—®é¢˜è§£å†³åï¼Œå†åˆä¸Šå¼€å…³æ¢å¤ä¾›ç”µã€‚

```
å®¶ç”¨æ–­è·¯å™¨ï¼š                å¾®æœåŠ¡ç†”æ–­å™¨ï¼š
ç”¨ç”µè¿‡è½½ â†’ è·³é—¸ä¿æŠ¤         æœåŠ¡å¼‚å¸¸ â†’ ç†”æ–­ä¿æŠ¤
ä¿®å¤é—®é¢˜ â†’ åˆé—¸æ¢å¤         æ¢å¤æ­£å¸¸ â†’ è§£é™¤ç†”æ–­
ä¿æŠ¤æ•´ä¸ªç”µè·¯ç³»ç»Ÿ            ä¿æŠ¤æ•´ä¸ªæœåŠ¡ç³»ç»Ÿ
```

**ğŸ”¸ å¾®æœåŠ¡ä¸­çš„ç†”æ–­**

åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œç†”æ–­å™¨å°±åƒæ˜¯æœåŠ¡ä¹‹é—´çš„"ä¿é™©ä¸"ï¼š
- å½“ä¸‹æ¸¸æœåŠ¡å‡ºé—®é¢˜ï¼ˆå“åº”æ…¢ã€é¢‘ç¹æŠ¥é”™ï¼‰æ—¶
- ç†”æ–­å™¨ä¼šè‡ªåŠ¨"æ–­å¼€"å¯¹è¯¥æœåŠ¡çš„è°ƒç”¨
- ç›´æ¥è¿”å›ä¸€ä¸ªå¤‡ç”¨å“åº”ï¼ˆé™çº§æ–¹æ¡ˆï¼‰
- é¿å…ä¸Šæ¸¸æœåŠ¡ä¹Ÿè·Ÿç€å‡ºé—®é¢˜

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦ç†”æ–­æœºåˆ¶


**âŒ æ²¡æœ‰ç†”æ–­çš„åæœ - æœåŠ¡é›ªå´©**

```
æ­£å¸¸æƒ…å†µï¼š
ç”¨æˆ· â†’ è®¢å•æœåŠ¡ â†’ åº“å­˜æœåŠ¡ â†’ æ•°æ®åº“
      (100ms)    (50ms)      (20ms)
      å“åº”å¿«é€Ÿï¼Œä½“éªŒè‰¯å¥½

åº“å­˜æœåŠ¡æ•…éšœæ—¶ï¼š
ç”¨æˆ· â†’ è®¢å•æœåŠ¡ â†’ åº“å­˜æœåŠ¡(è¶…æ—¶) â†’ æ•°æ®åº“
      (ç­‰å¾…ä¸­)    (å¡ä½30ç§’)        (å‹åŠ›å¤§)
      
ç»“æœï¼š
1. è®¢å•æœåŠ¡çš„çº¿ç¨‹è¢«è€—å°½ï¼ˆç­‰å¾…åº“å­˜å“åº”ï¼‰
2. æ–°çš„ç”¨æˆ·è¯·æ±‚è¿›ä¸æ¥
3. è®¢å•æœåŠ¡ä¹Ÿå´©æºƒäº†
4. æ•´ä¸ªç³»ç»Ÿç˜«ç—ªï¼ˆé›ªå´©æ•ˆåº”ï¼‰
```

**âœ… æœ‰ç†”æ–­æœºåˆ¶çš„æ•ˆæœ**

```
åº“å­˜æœåŠ¡æ•…éšœæ—¶ï¼š
ç”¨æˆ· â†’ è®¢å•æœåŠ¡ â†’ [ç†”æ–­å™¨æ‰“å¼€]
                 â†“
                è¿”å›ï¼šæŠ±æ­‰,åº“å­˜æš‚æ—¶æ— æ³•æŸ¥è¯¢
                     (ç«‹å³å“åº”,ä¸ç­‰å¾…)

ä¼˜åŠ¿ï¼š
â€¢ è®¢å•æœåŠ¡ä¸ä¼šè¢«æ‹–ç´¯
â€¢ ç”¨æˆ·èƒ½å¿«é€Ÿå¾—åˆ°å“åº”
â€¢ ç³»ç»Ÿå…¶ä»–åŠŸèƒ½æ­£å¸¸è¿è¡Œ
â€¢ ä¿æŠ¤äº†æ•´ä¸ªæœåŠ¡é“¾è·¯
```

### 1.3 æ ¸å¿ƒæ¦‚å¿µè§£é‡Š


**ğŸ”¹ å¤±è´¥ç‡é˜ˆå€¼**

ç®€å•è¯´å°±æ˜¯"å®¹é”™çº¢çº¿"ï¼š
- æ¯”å¦‚è®¾å®šå¤±è´¥ç‡é˜ˆå€¼ä¸º `50%`
- æ„æ€æ˜¯ï¼š10æ¬¡è°ƒç”¨ä¸­ï¼Œå¦‚æœæœ‰5æ¬¡å¤±è´¥
- ç†”æ–­å™¨å°±ä¼šå¯åŠ¨ä¿æŠ¤ï¼Œé˜»æ­¢åç»­è°ƒç”¨
- å°±åƒè€ƒè¯•ä¸åŠæ ¼çº¿ï¼Œä½äº60åˆ†å°±ä¸åŠæ ¼

**ğŸ”¹ å¿«é€Ÿå¤±è´¥**

ä¸ç­‰å¾…çš„å¤„ç†æ–¹å¼ï¼š
- ä¼ ç»Ÿæ–¹å¼ï¼šè°ƒç”¨å¤±è´¥ â†’ ç­‰è¶…æ—¶(30ç§’) â†’ è¿”å›é”™è¯¯
- ç†”æ–­æ–¹å¼ï¼šæ£€æµ‹åˆ°ç†”æ–­ â†’ ç«‹å³è¿”å›(1æ¯«ç§’) â†’ é™çº§å“åº”
- å¥½æ¯”å·²çŸ¥é“å•†åº—å…³é—¨ï¼Œå°±ä¸ç”¨èµ°è¿‡å»æ•²é—¨äº†

**ğŸ”¹ é›ªå´©é˜²æŠ¤**

é˜»æ­¢è¿é”å´©æºƒï¼š
```
æ²¡æœ‰é˜²æŠ¤ï¼š
æœåŠ¡Aæ•…éšœ â†’ æ‹–ç´¯æœåŠ¡B â†’ æ‹–ç´¯æœåŠ¡C â†’ æ•´ä½“å´©æºƒ
    âŒ        âŒ          âŒ         âŒ

æœ‰ç†”æ–­é˜²æŠ¤ï¼š
æœåŠ¡Aæ•…éšœ â†’ ç†”æ–­å™¨ä¿æŠ¤ â†’ æœåŠ¡Bæ­£å¸¸ â†’ æ•´ä½“å¯ç”¨
    âŒ         ğŸ›¡ï¸         âœ…         âœ…
```

---

## 2. âš™ï¸ ç†”æ–­å™¨å·¥ä½œåŸç†


### 2.1 ç†”æ–­å™¨çš„ä¸‰ç§çŠ¶æ€


ç†”æ–­å™¨å°±åƒäº¤é€šä¿¡å·ç¯ï¼Œæœ‰ä¸‰ç§çŠ¶æ€ï¼š

```
ğŸŸ¢ å…³é—­çŠ¶æ€(Closed)           ğŸ”´ æ‰“å¼€çŠ¶æ€(Open)           ğŸŸ¡ åŠå¼€çŠ¶æ€(Half-Open)
æ­£å¸¸å·¥ä½œ                      ç†”æ–­ä¿æŠ¤                    è¯•æ¢æ¢å¤

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¯·æ±‚é€šè¿‡ â”‚                  â”‚ è¯·æ±‚è¢«æ‹¦æˆªâ”‚                â”‚ éƒ¨åˆ†è¯·æ±‚â”‚
â”‚ æ­£å¸¸è°ƒç”¨ â”‚                  â”‚ å¿«é€Ÿå¤±è´¥ â”‚                â”‚ æµ‹è¯•æ¢å¤â”‚
â”‚ ç»Ÿè®¡å¤±è´¥ç‡â”‚                  â”‚ è¿”å›é™çº§ â”‚                â”‚ å†³å®šçŠ¶æ€â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                            â–²                          â”‚
     â”‚                            â”‚                          â”‚
     â””â”€â”€å¤±è´¥ç‡è¶…æ ‡â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
                                  â”‚                          â”‚
                                  â””â”€â”€â”€â”€â”€â”€ç­‰å¾…æ—¶é—´åˆ°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”¸ å…³é—­çŠ¶æ€ (Closed) - æ­£å¸¸è¿è¡Œ**

è¿™æ˜¯ç†”æ–­å™¨çš„åˆå§‹çŠ¶æ€ï¼Œå°±åƒé—¨æ˜¯å¼€ç€çš„ï¼š
- æ‰€æœ‰è¯·æ±‚æ­£å¸¸é€šè¿‡
- å®æ—¶ç»Ÿè®¡å¤±è´¥ç‡
- ä¸€æ—¦å¤±è´¥ç‡è¶…è¿‡é˜ˆå€¼ï¼Œç«‹å³è½¬ä¸ºæ‰“å¼€çŠ¶æ€

```java
// ç¤ºä¾‹ï¼š10æ¬¡è°ƒç”¨ä¸­æœ‰6æ¬¡å¤±è´¥
æˆåŠŸ: âœ… âœ… âœ… âœ…     (4æ¬¡æˆåŠŸ)
å¤±è´¥: âŒ âŒ âŒ âŒ âŒ âŒ  (6æ¬¡å¤±è´¥)
å¤±è´¥ç‡ = 6/10 = 60% > é˜ˆå€¼50%
â†’ è§¦å‘ç†”æ–­ï¼Œè½¬ä¸ºæ‰“å¼€çŠ¶æ€
```

**ğŸ”¸ æ‰“å¼€çŠ¶æ€ (Open) - ç†”æ–­ä¿æŠ¤**

è¿™æ—¶ç†”æ–­å™¨å®Œå…¨é˜»æ–­è°ƒç”¨ï¼š
- æ‰€æœ‰è¯·æ±‚ç›´æ¥è¿”å›é™çº§å“åº”
- ä¸ä¼šçœŸæ­£è°ƒç”¨ä¸‹æ¸¸æœåŠ¡
- è®¾å®šä¸€ä¸ªæ¢å¤æ—¶é—´çª—å£ï¼ˆå¦‚5ç§’ï¼‰

```java
// ç†”æ–­æ‰“å¼€æœŸé—´
ç”¨æˆ·è¯·æ±‚ â†’ [ç†”æ–­å™¨] â†’ ç›´æ¥è¿”å›"æœåŠ¡ç¹å¿™ï¼Œè¯·ç¨åé‡è¯•"
                    (ä¸è°ƒç”¨ä¸‹æ¸¸ï¼Œå¿«é€Ÿå“åº”)
```

**ğŸ”¸ åŠå¼€çŠ¶æ€ (Half-Open) - è¯•æ¢æ¢å¤**

ç­‰å¾…æ—¶é—´åˆ°äº†åï¼Œè¿›å…¥è¯•æ¢é˜¶æ®µï¼š
- å…è®¸å°‘é‡è¯·æ±‚é€šè¿‡ï¼ˆå¦‚3ä¸ªï¼‰
- æµ‹è¯•æœåŠ¡æ˜¯å¦æ¢å¤æ­£å¸¸
- æ ¹æ®ç»“æœå†³å®šä¸‹ä¸€æ­¥

```java
è¯•æ¢è¯·æ±‚ï¼š
ç¬¬1ä¸ªè¯·æ±‚ â†’ âœ… æˆåŠŸ
ç¬¬2ä¸ªè¯·æ±‚ â†’ âœ… æˆåŠŸ  
ç¬¬3ä¸ªè¯·æ±‚ â†’ âœ… æˆåŠŸ
ç»“è®ºï¼šæœåŠ¡æ¢å¤äº† â†’ è½¬å›å…³é—­çŠ¶æ€

æˆ–è€…ï¼š
ç¬¬1ä¸ªè¯·æ±‚ â†’ âŒ å¤±è´¥
ç»“è®ºï¼šè¿˜æ²¡å¥½ â†’ é‡æ–°æ‰“å¼€ç†”æ–­
```

### 2.2 çŠ¶æ€è½¬æ¢æµç¨‹


**ğŸ”„ å®Œæ•´çš„çŠ¶æ€æµè½¬**

```
å¯åŠ¨
 â†“
ğŸŸ¢ å…³é—­çŠ¶æ€(æ­£å¸¸è°ƒç”¨)
 â”‚
 â”‚ ç»Ÿè®¡å¤±è´¥æƒ…å†µ
 â†“
å¤±è´¥ç‡ > 50%?
 â”‚
 â†“ æ˜¯
ğŸ”´ æ‰“å¼€çŠ¶æ€(ç†”æ–­ä¿æŠ¤)
 â”‚
 â”‚ ç­‰å¾…5ç§’
 â†“
æ—¶é—´åˆ°äº†
 â†“
ğŸŸ¡ åŠå¼€çŠ¶æ€(è¯•æ¢3æ¬¡)
 â”‚
 â”œâ”€â†’ æˆåŠŸ â†’ ğŸŸ¢ å…³é—­çŠ¶æ€
 â”‚
 â””â”€â†’ å¤±è´¥ â†’ ğŸ”´ æ‰“å¼€çŠ¶æ€
```

**ğŸ“Š å®é™…è¿è¡Œç¤ºä¾‹**

| æ—¶é—´ç‚¹ | ç†”æ–­å™¨çŠ¶æ€ | å‘ç”Ÿçš„äº‹æƒ… | å¤„ç†æ–¹å¼ |
|--------|-----------|-----------|---------|
| `09:00` | ğŸŸ¢ å…³é—­ | æœåŠ¡æ­£å¸¸è¿è¡Œ | æ­£å¸¸è°ƒç”¨ä¸‹æ¸¸ |
| `09:05` | ğŸŸ¢ å…³é—­ | ä¸‹æ¸¸æœåŠ¡å¼€å§‹å˜æ…¢ | ç»§ç»­è°ƒç”¨,ç»Ÿè®¡å¤±è´¥ |
| `09:06` | ğŸ”´ æ‰“å¼€ | å¤±è´¥ç‡è¾¾åˆ°60% | è§¦å‘ç†”æ–­,å¿«é€Ÿå¤±è´¥ |
| `09:11` | ğŸŸ¡ åŠå¼€ | 5ç§’åè¯•æ¢æ¢å¤ | æ”¾è¡Œ3ä¸ªæµ‹è¯•è¯·æ±‚ |
| `09:11` | ğŸŸ¢ å…³é—­ | æµ‹è¯•è¯·æ±‚æˆåŠŸ | æ¢å¤æ­£å¸¸è°ƒç”¨ |

### 2.3 ç†”æ–­åˆ¤æ–­æœºåˆ¶


**ğŸ”¹ æ…¢è°ƒç”¨æ¯”ä¾‹ç†”æ–­**

å½“å“åº”æ—¶é—´å¤ªé•¿æ—¶è§¦å‘ï¼š

```
åœºæ™¯ï¼šè®¾ç½®æ…¢è°ƒç”¨æ ‡å‡†ä¸ºå“åº”è¶…è¿‡1ç§’

ç»Ÿè®¡10æ¬¡è°ƒç”¨ï¼š
å¿«é€Ÿå“åº”: 100ms, 200ms, 150ms         (3æ¬¡)
æ…¢é€Ÿå“åº”: 1.2s, 1.5s, 2s, 1.8s       (4æ¬¡)
è¶…æ—¶å¤±è´¥: timeout, timeout, timeout   (3æ¬¡)

æ…¢è°ƒç”¨æ¯”ä¾‹ = 7/10 = 70% > é˜ˆå€¼50%
â†’ è§¦å‘ç†”æ–­
```

**ğŸ”¹ å¼‚å¸¸æ¯”ä¾‹ç†”æ–­**

å½“é”™è¯¯å¤ªå¤šæ—¶è§¦å‘ï¼š

```
åœºæ™¯ï¼šè®¾ç½®å¼‚å¸¸æ¯”ä¾‹é˜ˆå€¼ä¸º30%

ç»Ÿè®¡20æ¬¡è°ƒç”¨ï¼š
æˆåŠŸ: âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…âœ…   (13æ¬¡)
å¼‚å¸¸: âŒâŒâŒâŒâŒâŒâŒ            (7æ¬¡)

å¼‚å¸¸æ¯”ä¾‹ = 7/20 = 35% > é˜ˆå€¼30%
â†’ è§¦å‘ç†”æ–­
```

**ğŸ”¹ å¼‚å¸¸æ•°é‡ç†”æ–­**

å½“é”™è¯¯æ¬¡æ•°è¾¾åˆ°ä¸Šé™æ—¶è§¦å‘ï¼š

```
åœºæ™¯ï¼šè®¾ç½®å¼‚å¸¸æ•°é‡é˜ˆå€¼ä¸º5æ¬¡

çŸ­æ—¶é—´å†…ï¼š
âŒ ç¬¬1æ¬¡å¼‚å¸¸ â†’ è®°å½•
âŒ ç¬¬2æ¬¡å¼‚å¸¸ â†’ è®°å½•
âŒ ç¬¬3æ¬¡å¼‚å¸¸ â†’ è®°å½•
âŒ ç¬¬4æ¬¡å¼‚å¸¸ â†’ è®°å½•
âŒ ç¬¬5æ¬¡å¼‚å¸¸ â†’ è§¦å‘ç†”æ–­ï¼
```

---

## 3. ğŸ”§ ç†”æ–­ç­–ç•¥é…ç½®


### 3.1 Sentinelç†”æ–­è§„åˆ™


**ğŸ”¸ åŸºç¡€é…ç½®å‚æ•°**

```java
// ç†”æ–­è§„åˆ™é…ç½®
DegradeRule rule = new DegradeRule("è®¢å•æœåŠ¡è°ƒç”¨åº“å­˜")
    .setGrade(RuleConstant.DEGRADE_GRADE_EXCEPTION_RATIO)  // æŒ‰å¼‚å¸¸æ¯”ä¾‹
    .setCount(0.5)              // 50% å¼‚å¸¸ç‡é˜ˆå€¼
    .setTimeWindow(10)          // ç†”æ–­æŒç»­10ç§’
    .setMinRequestAmount(5)     // è‡³å°‘5æ¬¡è¯·æ±‚æ‰ç»Ÿè®¡
    .setStatIntervalMs(1000);   // ç»Ÿè®¡æ—¶é—´çª—å£1ç§’
```

**å‚æ•°å«ä¹‰é€šä¿—è§£é‡Šï¼š**

| å‚æ•° | é€šä¿—ç†è§£ | ä¸¾ä¾‹è¯´æ˜ |
|-----|---------|---------|
| `èµ„æºåç§°` | ç»™è°è®¾ç½®ç†”æ–­ | "è®¢å•æœåŠ¡è°ƒç”¨åº“å­˜" |
| `ç†”æ–­ç­–ç•¥` | æŒ‰ä»€ä¹ˆæ ‡å‡†åˆ¤æ–­ | å¼‚å¸¸æ¯”ä¾‹ã€æ…¢è°ƒç”¨ã€å¼‚å¸¸æ•° |
| `é˜ˆå€¼` | å®¹å¿çš„ä¸Šé™ | 50%å¤±è´¥ç‡ã€5æ¬¡å¼‚å¸¸ |
| `æ—¶é—´çª—å£` | ç†”æ–­æŒç»­å¤šä¹… | 10ç§’åå°è¯•æ¢å¤ |
| `æœ€å°è¯·æ±‚æ•°` | è‡³å°‘å¤šå°‘æ¬¡æ‰ç»Ÿè®¡ | é˜²æ­¢å¶ç„¶å¤±è´¥å°±ç†”æ–­ |

### 3.2 ä¸‰ç§ç†”æ–­ç­–ç•¥è¯¦è§£


**â‘  æ…¢è°ƒç”¨æ¯”ä¾‹ç­–ç•¥**

é€‚ç”¨åœºæ™¯ï¼šæœåŠ¡å“åº”å˜æ…¢

```java
DegradeRule slowRule = new DegradeRule("æŸ¥è¯¢å•†å“è¯¦æƒ…")
    .setGrade(RuleConstant.DEGRADE_GRADE_RT)
    .setCount(1000)           // è¶…è¿‡1ç§’ç®—æ…¢è°ƒç”¨
    .setSlowRatioThreshold(0.6) // 60%çš„è¯·æ±‚éƒ½æ…¢äº†
    .setTimeWindow(5);        // ç†”æ–­5ç§’

// å®é™…æ•ˆæœ
è°ƒç”¨è€—æ—¶: 1.2s â†’ æ…¢è°ƒç”¨ âŒ
è°ƒç”¨è€—æ—¶: 0.8s â†’ æ­£å¸¸ âœ…
è°ƒç”¨è€—æ—¶: 1.5s â†’ æ…¢è°ƒç”¨ âŒ
...
æ…¢è°ƒç”¨è¾¾åˆ°60% â†’ è§¦å‘ç†”æ–­
```

**â‘¡ å¼‚å¸¸æ¯”ä¾‹ç­–ç•¥**

é€‚ç”¨åœºæ™¯ï¼šé¢‘ç¹æŠ¥é”™

```java
DegradeRule errorRule = new DegradeRule("è°ƒç”¨æ”¯ä»˜æ¥å£")
    .setGrade(RuleConstant.DEGRADE_GRADE_EXCEPTION_RATIO)
    .setCount(0.3)            // 30%å¼‚å¸¸ç‡
    .setTimeWindow(10);       // ç†”æ–­10ç§’

// å®é™…æ•ˆæœ
10æ¬¡è°ƒç”¨ä¸­æœ‰4æ¬¡å¼‚å¸¸ â†’ 40% > 30% â†’ ç†”æ–­
```

**â‘¢ å¼‚å¸¸æ•°ç­–ç•¥**

é€‚ç”¨åœºæ™¯ï¼šè¿ç»­å‡ºé”™

```java
DegradeRule countRule = new DegradeRule("å‘é€çŸ­ä¿¡")
    .setGrade(RuleConstant.DEGRADE_GRADE_EXCEPTION_COUNT)
    .setCount(5)              // 5æ¬¡å¼‚å¸¸
    .setTimeWindow(60);       // ç†”æ–­60ç§’

// å®é™…æ•ˆæœ
è¿ç»­5æ¬¡è°ƒç”¨å¤±è´¥ â†’ ç«‹å³ç†”æ–­1åˆ†é’Ÿ
```

### 3.3 å®ç”¨é…ç½®å»ºè®®


**ğŸ¯ é…ç½®é€‰æ‹©æŒ‡å—**

```
æ ¸å¿ƒä¸šåŠ¡ï¼ˆæ”¯ä»˜ã€ä¸‹å•ï¼‰ï¼š
âœ“ é‡‡ç”¨å¼‚å¸¸æ¯”ä¾‹ç­–ç•¥
âœ“ é˜ˆå€¼è®¾ä½ä¸€ç‚¹ï¼ˆ20-30%ï¼‰
âœ“ ç†”æ–­æ—¶é—´çŸ­ï¼ˆ5-10ç§’ï¼‰
â†’ å¿«é€Ÿå‘ç°é—®é¢˜ï¼Œå¿«é€Ÿæ¢å¤

éæ ¸å¿ƒä¸šåŠ¡ï¼ˆæ¨èã€è¯„è®ºï¼‰ï¼š
âœ“ é‡‡ç”¨æ…¢è°ƒç”¨ç­–ç•¥
âœ“ é˜ˆå€¼è®¾é«˜ä¸€ç‚¹ï¼ˆ50-70%ï¼‰  
âœ“ ç†”æ–­æ—¶é—´é•¿ï¼ˆ30-60ç§’ï¼‰
â†’ å®¹å¿åº¦é«˜ï¼Œé¿å…é¢‘ç¹ç†”æ–­

é«˜é¢‘è°ƒç”¨ï¼ˆæŸ¥è¯¢æ¥å£ï¼‰ï¼š
âœ“ æœ€å°è¯·æ±‚æ•°è®¾å¤§ï¼ˆ20-50ï¼‰
âœ“ é¿å…å› å¶ç„¶å¤±è´¥è§¦å‘ç†”æ–­
â†’ éœ€è¦è¶³å¤Ÿæ ·æœ¬æ‰åˆ¤æ–­
```

---

## 4. ğŸ¯ é™çº§å¤„ç†æœºåˆ¶


### 4.1 ä»€ä¹ˆæ˜¯æœåŠ¡é™çº§


**ğŸ”¸ ç”¨é¤å…çš„ä¾‹å­ç†è§£**

```
æ­£å¸¸æƒ…å†µï¼š
é¡¾å®¢ç‚¹é¤ â†’ å¤§å¨ç°åš â†’ æ–°é²œçƒ­èœ
         (15åˆ†é’Ÿ)

é«˜å³°æœŸé™çº§ï¼š
é¡¾å®¢ç‚¹é¤ â†’ æä¾›å¿«é¤å¥—é¤ â†’ é¢„åˆ¶èœå“
         (3åˆ†é’Ÿ)      (è™½ç„¶ä¸æ˜¯æœ€å¥½çš„ï¼Œä½†èƒ½åƒ)
```

åœ¨å¾®æœåŠ¡ä¸­ï¼š
- **æ­£å¸¸**ï¼šè°ƒç”¨çœŸå®æœåŠ¡ï¼Œè¿”å›å®Œæ•´æ•°æ®
- **é™çº§**ï¼šè¿”å›å¤‡ç”¨æ–¹æ¡ˆï¼Œä¿è¯åŸºæœ¬åŠŸèƒ½

### 4.2 é™çº§æ–¹æ¡ˆè®¾è®¡


**ğŸ”¹ è¿”å›é»˜è®¤å€¼**

```java
// æŸ¥è¯¢ç”¨æˆ·ä½™é¢
@SentinelResource(value = "getUserBalance", 
    blockHandler = "balanceBlockHandler")
public BigDecimal getUserBalance(Long userId) {
    // æ­£å¸¸è°ƒç”¨é’±åŒ…æœåŠ¡
    return walletService.getBalance(userId);
}

// é™çº§å¤„ç†ï¼šè¿”å›0
public BigDecimal balanceBlockHandler(Long userId, BlockException ex) {
    log.warn("ä½™é¢æŸ¥è¯¢è¢«é™æµï¼Œè¿”å›é»˜è®¤å€¼0");
    return BigDecimal.ZERO;  // é™çº§æ–¹æ¡ˆï¼šä½™é¢æ˜¾ç¤ºä¸º0
}
```

**ğŸ”¹ è¿”å›ç¼“å­˜æ•°æ®**

```java
@SentinelResource(value = "getProductDetail", 
    blockHandler = "productBlockHandler")
public Product getProductDetail(Long productId) {
    return productService.getById(productId);
}

// é™çº§å¤„ç†ï¼šè¿”å›ç¼“å­˜
public Product productBlockHandler(Long productId, BlockException ex) {
    // ä»æœ¬åœ°ç¼“å­˜è·å–
    Product cached = localCache.get(productId);
    if (cached != null) {
        return cached;  // è¿”å›ç¼“å­˜æ•°æ®ï¼ˆå¯èƒ½ä¸æ˜¯æœ€æ–°çš„ï¼‰
    }
    return Product.builder()
        .id(productId)
        .name("å•†å“ä¿¡æ¯åŠ è½½ä¸­...")
        .build();
}
```

**ğŸ”¹ è¿”å›å‹å¥½æç¤º**

```java
@SentinelResource(value = "submitOrder", 
    blockHandler = "orderBlockHandler")  
public OrderResult submitOrder(Order order) {
    return orderService.create(order);
}

// é™çº§å¤„ç†ï¼šè¿”å›æç¤ºä¿¡æ¯
public OrderResult orderBlockHandler(Order order, BlockException ex) {
    return OrderResult.builder()
        .success(false)
        .message("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•")
        .suggestion("æ‚¨å¯ä»¥å…ˆæµè§ˆå…¶ä»–å•†å“")
        .build();
}
```

### 4.3 é™çº§å“åº”ç­–ç•¥


**ğŸ“Š ä¸åŒåœºæ™¯çš„é™çº§ç­–ç•¥**

| ä¸šåŠ¡åœºæ™¯ | é™çº§æ–¹æ¡ˆ | ç”¨æˆ·ä½“éªŒ |
|---------|---------|---------|
| **æŸ¥è¯¢å•†å“è¯¦æƒ…** | è¿”å›ç¼“å­˜æ•°æ® | å¯èƒ½çœ‹åˆ°ç¨æ—§çš„ä¿¡æ¯ |
| **åº“å­˜æŸ¥è¯¢** | æ˜¾ç¤º"åº“å­˜å……è¶³" | ä¸å½±å“ä¸‹å•æµç¨‹ |
| **æ¨èå•†å“** | è¿”å›çƒ­é”€å•†å“ | æ¨èä¸ç²¾å‡†ä½†æœ‰å†…å®¹ |
| **ä¼˜æƒ åˆ¸æŸ¥è¯¢** | éšè—ä¼˜æƒ å…¥å£ | æš‚æ—¶çœ‹ä¸åˆ°ä¼˜æƒ  |
| **è¯„è®ºåŠ è½½** | æ˜¾ç¤º"è¯„è®ºåŠ è½½ä¸­" | æ ¸å¿ƒåŠŸèƒ½ä¸å—å½±å“ |
| **æ”¯ä»˜æ¥å£** | æ˜ç¡®æç¤ºé‡è¯• | å‘ŠçŸ¥ç”¨æˆ·ç¨åå†è¯• |

**ğŸ¨ é™çº§å“åº”ç¤ºä¾‹**

```java
// å¤šçº§é™çº§ç­–ç•¥
public Product getProductWithFallback(Long productId) {
    try {
        // 1. å°è¯•è°ƒç”¨è¿œç¨‹æœåŠ¡
        return remoteService.getProduct(productId);
    } catch (Exception e) {
        // 2. è¿œç¨‹å¤±è´¥ï¼Œå°è¯•æœ¬åœ°ç¼“å­˜
        Product cached = cache.get(productId);
        if (cached != null) {
            return cached;
        }
        
        // 3. ç¼“å­˜ä¹Ÿæ²¡æœ‰ï¼Œè¿”å›åŸºç¡€ä¿¡æ¯
        return Product.builder()
            .id(productId)
            .name("å•†å“è¯¦æƒ…æš‚æ—¶æ— æ³•åŠ è½½")
            .status("æ­£åœ¨æ¢å¤ä¸­...")
            .build();
    }
}
```

---

## 5. ğŸ’¼ å®æˆ˜åº”ç”¨åœºæ™¯


### 5.1 ç”µå•†è®¢å•åœºæ™¯


**ğŸ›’ ä¸šåŠ¡æµç¨‹**

```
ç”¨æˆ·ä¸‹å•æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è®¢å•æœåŠ¡ â”‚ â”€â”€â”€â†’ â”‚  åº“å­˜æœåŠ¡ â”‚ â”€â”€â”€â†’ â”‚  æ•°æ®åº“  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚               
     â†“               
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      
â”‚  æ”¯ä»˜æœåŠ¡ â”‚      
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      
```

**âŒ åº“å­˜æœåŠ¡æ•…éšœæ—¶çš„å¤„ç†**

```java
@Service
public class OrderService {
    
    @SentinelResource(value = "checkStock",
        blockHandler = "stockBlockHandler")
    public boolean checkStock(Long productId, Integer quantity) {
        // è°ƒç”¨åº“å­˜æœåŠ¡æ£€æŸ¥
        return stockService.check(productId, quantity);
    }
    
    // é™çº§æ–¹æ¡ˆï¼šå…è®¸ä¸‹å•ä½†æ ‡è®°ä¸ºå¾…ç¡®è®¤
    public boolean stockBlockHandler(Long productId, Integer quantity, 
                                     BlockException ex) {
        log.warn("åº“å­˜æœåŠ¡ç†”æ–­ï¼Œé‡‡ç”¨é™çº§ç­–ç•¥");
        
        // 1. è®°å½•éœ€è¦äººå·¥ç¡®è®¤çš„è®¢å•
        orderConfirmQueue.add(productId, quantity);
        
        // 2. å…è®¸ä¸‹å•ï¼Œä½†æ ‡è®°çŠ¶æ€
        return true;  // å‡å®šæœ‰è´§ï¼Œåç»­äººå·¥ç¡®è®¤
    }
    
    // è®¢å•åˆ›å»º
    public Order createOrder(OrderRequest request) {
        // æ£€æŸ¥åº“å­˜
        boolean hasStock = checkStock(request.getProductId(), 
                                     request.getQuantity());
        
        Order order = new Order();
        order.setProductId(request.getProductId());
        order.setQuantity(request.getQuantity());
        
        if (hasStock) {
            order.setStatus("å¾…æ”¯ä»˜");
        } else {
            order.setStatus("åº“å­˜ä¸è¶³");
        }
        
        return orderRepository.save(order);
    }
}
```

### 5.2 ç”¨æˆ·æœåŠ¡åœºæ™¯


**ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢**

```java
@Service  
public class UserService {
    
    @SentinelResource(value = "getUserInfo",
        blockHandler = "userInfoBlockHandler")
    public UserInfo getUserInfo(Long userId) {
        // è°ƒç”¨ç”¨æˆ·æœåŠ¡
        return userClient.getById(userId);
    }
    
    // é™çº§ï¼šè¿”å›åŸºç¡€ä¿¡æ¯
    public UserInfo userInfoBlockHandler(Long userId, BlockException ex) {
        // ä»æœ¬åœ°ç¼“å­˜è·å–åŸºç¡€ä¿¡æ¯
        UserInfo basic = userCache.getBasicInfo(userId);
        if (basic != null) {
            return basic;
        }
        
        // è¿”å›æœ€å°åŒ–ç”¨æˆ·ä¿¡æ¯
        return UserInfo.builder()
            .id(userId)
            .nickname("ç”¨æˆ·" + userId)
            .avatar("/default-avatar.png")
            .build();
    }
}
```

**å®é™…æ•ˆæœå¯¹æ¯”ï¼š**

```
æ­£å¸¸æƒ…å†µï¼š
ç”¨æˆ·ä¿¡æ¯ = {
  id: 10001,
  nickname: "å¼ ä¸‰",
  avatar: "https://xxx.com/avatar.jpg",
  level: "VIP",
  points: 5000,
  coupons: [...],
  recentOrders: [...]
}

ç†”æ–­é™çº§åï¼š
ç”¨æˆ·ä¿¡æ¯ = {
  id: 10001,
  nickname: "ç”¨æˆ·10001",     // åŸºç¡€ä¿¡æ¯
  avatar: "/default-avatar.png"
}
// è™½ç„¶ä¿¡æ¯ä¸å®Œæ•´ï¼Œä½†ä¸å½±å“æ ¸å¿ƒåŠŸèƒ½
```

### 5.3 å¾®æœåŠ¡è°ƒç”¨é“¾ä¿æŠ¤


**ğŸ”— å¤æ‚è°ƒç”¨é“¾è·¯**

```
å®Œæ•´è°ƒç”¨é“¾ï¼š
å‰ç«¯ â†’ APIç½‘å…³ â†’ è®¢å•æœåŠ¡ â†’ åº“å­˜æœåŠ¡ â†’ æ•°æ®åº“
                    â†“
                 ä¼˜æƒ åˆ¸æœåŠ¡
                    â†“
                 ç”¨æˆ·æœåŠ¡
```

**é€çº§ç†”æ–­ä¿æŠ¤ï¼š**

```java
// 1. è®¢å•æœåŠ¡é…ç½®
@Configuration
public class OrderServiceConfig {
    
    @PostConstruct
    public void initRules() {
        List<DegradeRule> rules = new ArrayList<>();
        
        // åº“å­˜æœåŠ¡ç†”æ–­
        rules.add(new DegradeRule("stockService")
            .setGrade(DEGRADE_GRADE_EXCEPTION_RATIO)
            .setCount(0.5)
            .setTimeWindow(10));
        
        // ä¼˜æƒ åˆ¸æœåŠ¡ç†”æ–­ï¼ˆéæ ¸å¿ƒï¼Œå®¹å¿åº¦é«˜ï¼‰
        rules.add(new DegradeRule("couponService")
            .setGrade(DEGRADE_GRADE_EXCEPTION_RATIO)
            .setCount(0.7)    // 70%æ‰ç†”æ–­
            .setTimeWindow(30));
        
        DegradeRuleManager.loadRules(rules);
    }
}

// 2. ä¸šåŠ¡å¤„ç†
@Service
public class OrderCreateService {
    
    public Order create(OrderRequest request) {
        Order order = new Order();
        
        // æ£€æŸ¥åº“å­˜ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼Œå¿…é¡»å¤„ç†ï¼‰
        try {
            boolean hasStock = stockService.check(request.getProductId());
            if (!hasStock) {
                throw new BusinessException("åº“å­˜ä¸è¶³");
            }
        } catch (BlockException e) {
            // åº“å­˜æœåŠ¡ç†”æ–­ï¼Œæ ‡è®°ä¸ºå¾…ç¡®è®¤
            order.setNeedConfirm(true);
        }
        
        // æŸ¥è¯¢ä¼˜æƒ åˆ¸ï¼ˆéæ ¸å¿ƒï¼Œå¯é™çº§ï¼‰
        try {
            List<Coupon> coupons = couponService.getAvailable(request.getUserId());
            order.setCoupons(coupons);
        } catch (BlockException e) {
            // ä¼˜æƒ åˆ¸æœåŠ¡ç†”æ–­ï¼Œè·³è¿‡ä¼˜æƒ 
            order.setCoupons(Collections.emptyList());
        }
        
        return orderRepository.save(order);
    }
}
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æœåŠ¡ç†”æ–­ = æœåŠ¡çš„"ä¿é™©ä¸"
  å½“æœåŠ¡å‡ºç°é—®é¢˜æ—¶ï¼Œè‡ªåŠ¨åˆ‡æ–­è°ƒç”¨ï¼Œä¿æŠ¤æ•´ä¸ªç³»ç»Ÿ

ğŸ”¸ ä¸‰ç§çŠ¶æ€ = å…³é—­(æ­£å¸¸) â†’ æ‰“å¼€(ç†”æ–­) â†’ åŠå¼€(è¯•æ¢)
  åƒäº¤é€šä¿¡å·ç¯ï¼Œæ ¹æ®æƒ…å†µåˆ‡æ¢

ğŸ”¸ ç†”æ–­ç­–ç•¥ = æ…¢è°ƒç”¨æ¯”ä¾‹ã€å¼‚å¸¸æ¯”ä¾‹ã€å¼‚å¸¸æ•°é‡
  æ ¹æ®ä¸šåŠ¡é€‰æ‹©åˆé€‚çš„åˆ¤æ–­æ ‡å‡†

ğŸ”¸ æœåŠ¡é™çº§ = æä¾›å¤‡ç”¨æ–¹æ¡ˆ
  ä¸æ˜¯ä¸æä¾›æœåŠ¡ï¼Œè€Œæ˜¯æä¾›"ä½é…ç‰ˆ"æœåŠ¡

ğŸ”¸ å¿«é€Ÿå¤±è´¥ = ç«‹å³è¿”å›ï¼Œä¸å‚»ç­‰
  é¿å…èµ„æºæµªè´¹ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
```

### 6.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ç†”æ–­ä¸é™çº§çš„åŒºåˆ«**

```
ç†”æ–­ï¼ˆCircuit Breakerï¼‰ï¼š
â†’ è§¦å‘æ¡ä»¶ï¼šå¤±è´¥ç‡/æ…¢è°ƒç”¨è¶…è¿‡é˜ˆå€¼
â†’ ä½œç”¨ä½ç½®ï¼šè°ƒç”¨æ–¹
â†’ ä¸»è¦ç›®çš„ï¼šä¿æŠ¤ç³»ç»Ÿä¸è¢«æ‹–å®
â†’ ä¸¾ä¾‹ï¼šåº“å­˜æœåŠ¡æŒ‚äº†ï¼Œè®¢å•æœåŠ¡ç†”æ–­å¯¹å®ƒçš„è°ƒç”¨

é™çº§ï¼ˆFallbackï¼‰ï¼š
â†’ è§¦å‘æ¡ä»¶ï¼šç†”æ–­ã€é™æµã€å¼‚å¸¸
â†’ ä½œç”¨ä½ç½®ï¼šå½“å‰æœåŠ¡  
â†’ ä¸»è¦ç›®çš„ï¼šæä¾›å¤‡ç”¨æ–¹æ¡ˆ
â†’ ä¸¾ä¾‹ï¼šè¿”å›ç¼“å­˜ã€é»˜è®¤å€¼ã€å‹å¥½æç¤º
```

**ğŸ”¹ ç†”æ–­å‚æ•°è®¾ç½®æŠ€å·§**

| ä¸šåŠ¡ç±»å‹ | å¼‚å¸¸é˜ˆå€¼ | ç†”æ–­æ—¶é—´ | æœ€å°è¯·æ±‚æ•° |
|---------|---------|---------|-----------|
| **æ ¸å¿ƒä¸šåŠ¡** | 20-30% | 5-10ç§’ | 20-50 |
| **é‡è¦ä¸šåŠ¡** | 40-50% | 10-30ç§’ | 10-20 |
| **ä¸€èˆ¬ä¸šåŠ¡** | 60-70% | 30-60ç§’ | 5-10 |

**ğŸ”¹ å®æˆ˜ç»éªŒæ€»ç»“**

```
âœ… é™çº§æ–¹æ¡ˆè¦æå‰è®¾è®¡å¥½
   ä¸è¦ç­‰å‡ºé—®é¢˜äº†å†æƒ³æ€ä¹ˆé™çº§

âœ… æ ¸å¿ƒåŠŸèƒ½å¯ä»¥é™çº§ä½†ä¸èƒ½ä¸å¯ç”¨  
   æ¯”å¦‚ä¸‹å•åŠŸèƒ½ï¼Œå¯ä»¥æš‚æ—¶ä¸æ‰£åº“å­˜ï¼Œä½†è¦è®©ç”¨æˆ·èƒ½ä¸‹å•

âœ… ç†”æ–­æ—¶é—´ä¸è¦å¤ªé•¿
   5-30ç§’æ¯”è¾ƒåˆé€‚ï¼Œå¤ªé•¿ä¼šå½±å“æœåŠ¡æ¢å¤

âœ… ç›‘æ§å’Œå‘Šè­¦è¦å®Œå–„
   ç†”æ–­è§¦å‘åè¦åŠæ—¶é€šçŸ¥è¿ç»´äººå‘˜

âœ… æµ‹è¯•ç¯å¢ƒè¦æ¨¡æ‹Ÿç†”æ–­åœºæ™¯
   ç¡®ä¿é™çº§æ–¹æ¡ˆçœŸçš„èƒ½ç”¨
```

### 6.3 è®°å¿†å£è¯€


```
ç†”æ–­é™çº§æŠ¤å¹³å®‰ï¼Œ
ä¸‰ç§çŠ¶æ€è½®æµè½¬ã€‚
å…³é—­æ­£å¸¸åŠå¼€è¯•ï¼Œ
æ‰“å¼€å¿«é€ŸæŠŠé”™æ‹¦ã€‚

æ…¢è°ƒå¼‚å¸¸æœ‰ä¸‰ç­–ï¼Œ
é˜ˆå€¼æ—¶é—´è¦è®¾å…¨ã€‚
é™çº§æ–¹æ¡ˆæ—©è®¾è®¡ï¼Œ
ç¼“å­˜é»˜è®¤å‹å¥½é€‰ã€‚

æ ¸å¿ƒä¸šåŠ¡ä¸¥è¦æ±‚ï¼Œ
ä¸€èˆ¬åŠŸèƒ½æ¾ä¸€ç‚¹ã€‚
ç›‘æ§å‘Šè­¦ä¸èƒ½å°‘ï¼Œ
æµ‹è¯•éªŒè¯ä¿å¹³å®‰ã€‚
```

**æ ¸å¿ƒè®°å¿†ï¼š**
- ç†”æ–­æ˜¯"æ–­è·¯å™¨"ï¼Œä¿æŠ¤ç³»ç»Ÿä¸å´©æºƒ
- é™çº§æ˜¯"å¤‡èƒ"ï¼Œä¿è¯åŸºæœ¬åŠŸèƒ½å¯ç”¨
- åˆç†é…ç½®å‚æ•°ï¼Œå¹³è¡¡ä¿æŠ¤å’Œä½“éªŒ
- æå‰è®¾è®¡å¥½é™çº§æ–¹æ¡ˆï¼Œä¸è¦ä¸´æ—¶æŠ±ä½›è„š