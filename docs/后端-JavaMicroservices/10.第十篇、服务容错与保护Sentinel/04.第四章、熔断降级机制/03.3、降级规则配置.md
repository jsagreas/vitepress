---
title: 3、降级规则配置
---
## 📚 目录

1. [熔断降级规则概述](#1-熔断降级规则概述)
2. [DegradeRule核心配置](#2-degraderule核心配置)
3. [三种降级策略详解](#3-三种降级策略详解)
4. [规则配置实战](#4-规则配置实战)
5. [核心要点总结](#5-核心要点总结)

---

## 1. 🛡️ 熔断降级规则概述


### 1.1 什么是熔断降级


**通俗理解：保险丝机制**
```
想象你家里的电路保险丝：
- 正常情况：电流通畅，电器正常工作
- 电流过大：保险丝熔断，切断电路保护电器
- 恢复后：更换保险丝，电路重新工作

微服务中的熔断降级也是同样的道理：
- 正常情况：请求正常处理，服务运行良好
- 服务异常：触发熔断，快速失败返回兜底数据
- 问题解决：自动恢复，服务重新接收请求
```

**核心作用**
```
🔸 保护系统：防止级联故障，避免雪崩效应
🔸 快速失败：异常时立即返回，不再调用出问题的服务
🔸 自动恢复：问题解决后自动放开流量，无需人工干预
🔸 降低延迟：减少无谓的等待时间，提升用户体验
```

### 1.2 熔断降级的工作流程


**三态转换模型**
```
                触发熔断条件
    CLOSED ──────────────────→ OPEN
    (关闭)                      (打开)
       ↑                          │
       │                          │ 等待时间窗口
       │                          ↓
       │                      HALF_OPEN
       │                      (半开启)
       │                          │
       └──────────────────────────┘
           探测成功，恢复正常

状态说明：
• CLOSED（关闭）：正常状态，请求正常处理
• OPEN（打开）：熔断状态，请求直接降级处理
• HALF_OPEN（半开）：探测状态，尝试恢复服务
```

**状态转换示例**
```
时间线：
0s   │ [正常] 100个请求，95个成功 → CLOSED状态
     │
30s  │ [异常] 100个请求，60个失败 → 触发熔断，进入OPEN
     │        后续请求全部快速失败，返回降级数据
     │
40s  │ [探测] 时间窗口结束 → 进入HALF_OPEN状态
     │        允许少量请求通过测试
     │
42s  │ [恢复] 探测请求成功 → 回到CLOSED状态
     │        服务完全恢复正常
```

---

## 2. ⚙️ DegradeRule核心配置


### 2.1 DegradeRule类详解


**基本定义**
```java
// Sentinel的熔断降级规则类
DegradeRule rule = new DegradeRule();

核心作用：
定义什么情况下触发熔断，以及如何恢复
```

**六大核心属性**

| 属性 | 说明 | 类比理解 |
|------|------|----------|
| **resource** | 资源名称 | 给哪个服务接口设置保险丝 |
| **grade** | 降级策略 | 保险丝的触发条件（电流/温度/时间） |
| **count** | 阈值 | 保险丝的承受极限值 |
| **timeWindow** | 时间窗口（秒） | 保险丝熔断后的冷却时间 |
| **minRequestAmount** | 最小请求数 | 至少有多少电流才判断是否超载 |
| **statIntervalMs** | 统计时长（毫秒） | 观察多长时间内的情况 |

### 2.2 基础配置示例


**最简单的熔断规则**
```java
// 为订单服务设置熔断规则
DegradeRule rule = new DegradeRule("orderService");

// 设置降级策略：异常比例
rule.setGrade(RuleConstant.DEGRADE_GRADE_EXCEPTION_RATIO);

// 设置阈值：异常比例超过50%就熔断
rule.setCount(0.5);

// 设置时间窗口：熔断10秒后尝试恢复
rule.setTimeWindow(10);

通俗解释：
订单服务如果在一段时间内有超过50%的请求出错，
就启动熔断，后续10秒内的请求直接返回降级结果，
10秒后尝试恢复看服务是否正常了
```

---

## 3. 📊 三种降级策略详解


### 3.1 慢调用比例策略


**什么是慢调用？**
```
慢调用：就是响应时间过长的请求

日常类比：
你去饭店点餐：
- 正常：5分钟上菜 ✓
- 慢调用：等了30分钟还没上菜 ✗

微服务中：
- 正常：接口200ms返回结果 ✓
- 慢调用：接口2秒还没返回 ✗
```

**配置说明**
```java
DegradeRule slowRule = new DegradeRule("userService");

// 策略：慢调用比例
slowRule.setGrade(RuleConstant.DEGRADE_GRADE_RT);

// 响应时间超过500ms就算慢调用
slowRule.setCount(500);

// 慢调用比例超过60%触发熔断
slowRule.setSlowRatioThreshold(0.6);

// 统计1秒内的请求
slowRule.setStatIntervalMs(1000);

// 至少5个请求才统计
slowRule.setMinRequestAmount(5);

// 熔断15秒
slowRule.setTimeWindow(15);

实际效果：
1秒内如果有5个以上请求，且60%的请求超过500ms响应，
就认为服务太慢了，启动熔断保护15秒
```

**使用场景**
```
✅ 适合：数据库查询、第三方API调用等可能变慢的场景
✅ 目的：防止慢请求拖垮整个系统
✅ 效果：及时切断慢服务，使用本地缓存或默认数据
```

### 3.2 异常比例策略


**什么是异常比例？**
```
异常比例：出错请求占总请求的百分比

日常类比：
工厂质检：
- 生产100个产品，5个次品 → 次品率5%，正常
- 生产100个产品，40个次品 → 次品率40%，异常

微服务中：
- 100个请求，3个失败 → 异常率3%，可接受
- 100个请求，55个失败 → 异常率55%，需要熔断
```

**配置说明**
```java
DegradeRule exceptionRule = new DegradeRule("paymentService");

// 策略：异常比例
exceptionRule.setGrade(RuleConstant.DEGRADE_GRADE_EXCEPTION_RATIO);

// 异常比例超过30%触发熔断
exceptionRule.setCount(0.3);

// 统计时长1秒
exceptionRule.setStatIntervalMs(1000);

// 最少10个请求才统计
exceptionRule.setMinRequestAmount(10);

// 熔断20秒
exceptionRule.setTimeWindow(20);

实际效果：
1秒内至少10个请求的情况下，如果超过30%的请求抛异常，
立即熔断20秒，快速返回降级结果
```

**使用场景**
```
✅ 适合：容易出错的外部服务调用
✅ 目的：避免大量异常消耗系统资源
✅ 效果：异常激增时快速熔断，保护系统稳定
```

### 3.3 异常数策略


**什么是异常数？**
```
异常数：统计时间内的错误请求总数

日常类比：
超市收银：
- 1分钟内刷卡失败2次 → 偶尔失败，正常
- 1分钟内刷卡失败20次 → 频繁失败，可能POS机坏了

微服务中：
- 1分钟内5个请求失败 → 偶发异常
- 1分钟内50个请求失败 → 系统异常
```

**配置说明**
```java
DegradeRule countRule = new DegradeRule("smsService");

// 策略：异常数
countRule.setGrade(RuleConstant.DEGRADE_GRADE_EXCEPTION_COUNT);

// 异常数超过10次触发熔断
countRule.setCount(10);

// 统计时长60秒（1分钟）
countRule.setStatIntervalMs(60000);

// 最少20个请求才统计
countRule.setMinRequestAmount(20);

// 熔断30秒
countRule.setTimeWindow(30);

实际效果：
1分钟内至少20个请求的情况下，如果异常数超过10次，
启动熔断保护30秒
```

**三种策略对比表**

| 策略 | 触发条件 | 适用场景 | 优先级 |
|------|----------|----------|--------|
| **慢调用比例** | 响应慢的请求占比高 | 数据库查询、远程调用 | ⭐⭐⭐⭐⭐ |
| **异常比例** | 出错请求占比高 | 不稳定的第三方服务 | ⭐⭐⭐⭐ |
| **异常数** | 错误次数多 | 低流量但关键的服务 | ⭐⭐⭐ |

---

## 4. 🔧 规则配置实战


### 4.1 代码方式配置


**Spring Boot集成配置**
```java
@Configuration
public class SentinelConfig {
    
    @PostConstruct
    public void initDegradeRules() {
        List<DegradeRule> rules = new ArrayList<>();
        
        // 规则1：订单服务慢调用保护
        DegradeRule orderRule = new DegradeRule("orderService")
            .setGrade(RuleConstant.DEGRADE_GRADE_RT)
            .setCount(1000)                    // 1秒算慢
            .setSlowRatioThreshold(0.5)        // 50%慢调用
            .setTimeWindow(10);                // 熔断10秒
        
        // 规则2：支付服务异常保护
        DegradeRule payRule = new DegradeRule("paymentService")
            .setGrade(RuleConstant.DEGRADE_GRADE_EXCEPTION_RATIO)
            .setCount(0.3)                     // 30%异常率
            .setMinRequestAmount(10)           // 至少10个请求
            .setTimeWindow(20);                // 熔断20秒
        
        rules.add(orderRule);
        rules.add(payRule);
        
        DegradeRuleManager.loadRules(rules);
    }
}
```

### 4.2 配置文件方式


**application.yml配置**
```yaml
spring:
  cloud:
    sentinel:
      transport:
        dashboard: localhost:8080
      datasource:
        # 降级规则配置
        degrade:
          nacos:
            server-addr: localhost:8848
            dataId: sentinel-degrade-rules
            groupId: DEFAULT_GROUP
            rule-type: degrade
```

**Nacos中的规则配置**
```json
[
  {
    "resource": "orderService",
    "grade": 0,
    "count": 1000,
    "slowRatioThreshold": 0.5,
    "timeWindow": 10,
    "minRequestAmount": 5
  },
  {
    "resource": "paymentService", 
    "grade": 1,
    "count": 0.3,
    "timeWindow": 20,
    "minRequestAmount": 10
  }
]

字段说明：
grade - 0:慢调用比例, 1:异常比例, 2:异常数
count - 阈值（RT毫秒/异常比例/异常数）
timeWindow - 熔断时长（秒）
```

### 4.3 关键参数调优指南


**时间窗口（timeWindow）选择**
```
⏱️ 5-10秒：快速恢复，适合偶发故障
⏱️ 10-30秒：标准配置，适合大多数场景  
⏱️ 30-60秒：谨慎恢复，适合严重故障

调优建议：
• 从小到大逐步调整
• 观察实际恢复时间
• 避免频繁熔断和恢复
```

**最小请求数（minRequestAmount）设置**
```
🔸 太小（<5）：容易误判，偶然失败就熔断
🔸 适中（5-20）：平衡准确性和响应速度
🔸 太大（>50）：反应迟钝，异常已经影响系统了才熔断

推荐配置：
• 高流量接口：10-20
• 中流量接口：5-10
• 低流量接口：3-5
```

**阈值（count）设置原则**

| 策略类型 | 阈值范围 | 推荐值 | 说明 |
|----------|----------|--------|------|
| 慢调用RT | 200-2000ms | 500-1000ms | 根据正常响应时间的2-3倍设置 |
| 异常比例 | 0.1-0.5 | 0.3 | 30%异常率是常见阈值 |
| 异常数 | 5-50次 | 10-20次 | 结合流量大小决定 |

### 4.4 降级处理方法


**自定义降级逻辑**
```java
@Service
public class OrderService {
    
    // 定义降级方法
    @SentinelResource(
        value = "queryOrder",
        blockHandler = "handleBlock",      // 熔断降级处理
        fallback = "handleFallback"        // 异常降级处理
    )
    public Order queryOrder(Long orderId) {
        // 正常业务逻辑
        return orderMapper.selectById(orderId);
    }
    
    // 熔断时的处理方法
    public Order handleBlock(Long orderId, BlockException ex) {
        // 返回兜底数据
        return Order.builder()
            .id(orderId)
            .status("服务繁忙，请稍后重试")
            .build();
    }
    
    // 异常时的处理方法  
    public Order handleFallback(Long orderId, Throwable ex) {
        // 记录日志
        log.error("查询订单异常", ex);
        // 返回默认值
        return Order.builder()
            .id(orderId)
            .status("订单查询失败")
            .build();
    }
}
```

---

## 5. 📋 核心要点总结


### 5.1 必须掌握的核心概念


```
🔸 熔断降级本质：保险丝机制，异常时快速失败保护系统
🔸 三种状态：CLOSED（正常）→ OPEN（熔断）→ HALF_OPEN（探测）
🔸 DegradeRule：Sentinel的熔断规则配置类
🔸 三大策略：慢调用比例、异常比例、异常数
🔸 时间窗口：熔断后的恢复等待时间
```

### 5.2 配置要点记忆


**参数配置口诀**
```
资源名称要明确，降级策略选对路
阈值设置看场景，时间窗口别太短
最小请求防误判，统计时长要合理
```

**三种策略选择**
```
✅ 服务响应慢 → 选慢调用比例策略
✅ 异常率突增 → 选异常比例策略  
✅ 低流量关键服务 → 选异常数策略
```

### 5.3 实战经验


**常见配置模板**
```
🔸 通用Web服务：
   慢调用RT=500ms, 比例=50%, 时间窗口=10s

🔸 第三方API：
   异常比例=30%, 最小请求=10, 时间窗口=20s

🔸 数据库查询：
   慢调用RT=1000ms, 比例=40%, 时间窗口=15s

🔸 消息发送：
   异常数=10次, 统计=60s, 时间窗口=30s
```

**调优建议**
```
📝 先保守后激进：从高阈值、长时间窗口开始
📝 持续监控：观察熔断频率和恢复效果
📝 结合实际：根据业务特点调整参数
📝 灰度验证：生产环境逐步调整，避免影响业务
```

### 5.4 注意事项


> ⚠️ **重要提醒**
> 
> - 熔断规则不是越多越好，重点保护核心服务
> - 时间窗口太短会导致频繁熔断和恢复
> - 降级方法必须简单快速，不能有复杂逻辑
> - 配置变更要有版本管理和回滚机制

**核心记忆**
```
熔断降级像保险，异常来了快切断
三态转换要理解，参数配置要合理
降级方法要简单，监控调优不能忘
```