---
title: 2ã€Gatewayé›†æˆ
---
## ğŸ“š ç›®å½•

1. [Gatewayé›†æˆåŸºç¡€](#1-Gatewayé›†æˆåŸºç¡€)
2. [ç½‘å…³é™æµé…ç½®](#2-ç½‘å…³é™æµé…ç½®)
3. [è·¯ç”±çº§ä¿æŠ¤ç­–ç•¥](#3-è·¯ç”±çº§ä¿æŠ¤ç­–ç•¥)
4. [APIåˆ†ç»„ç®¡ç†](#4-APIåˆ†ç»„ç®¡ç†)
5. [å‚æ•°é™æµå®æˆ˜](#5-å‚æ•°é™æµå®æˆ˜)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ Gatewayé›†æˆåŸºç¡€


### 1.1 ä»€ä¹ˆæ˜¯Spring Cloud Gateway


**ğŸ’¡ é€šä¿—ç†è§£**
```
æƒ³è±¡ä¸€ä¸ªå•†åœºçš„å¤§é—¨ï¼š
- æ‰€æœ‰é¡¾å®¢éƒ½å¿…é¡»ä»å¤§é—¨è¿›å…¥
- ä¿å®‰åœ¨é—¨å£æ£€æŸ¥ã€å¼•å¯¼
- æ§åˆ¶è¿›å…¥äººæµï¼Œé˜²æ­¢æ‹¥æŒ¤
- æŠŠé¡¾å®¢å¼•å¯¼åˆ°å¯¹åº”çš„åº—é“º

Spring Cloud Gatewayå°±æ˜¯å¾®æœåŠ¡ç³»ç»Ÿçš„"å¤§é—¨"ï¼š
- ç»Ÿä¸€å…¥å£ï¼Œæ‰€æœ‰è¯·æ±‚å…ˆåˆ°è¿™é‡Œ
- æ£€æŸ¥è¯·æ±‚ï¼Œå†³å®šæ˜¯å¦æ”¾è¡Œ
- æ§åˆ¶æµé‡ï¼Œé˜²æ­¢ç³»ç»Ÿè¿‡è½½
- æŠŠè¯·æ±‚è½¬å‘åˆ°å¯¹åº”çš„æœåŠ¡
```

**ğŸ”¸ æ ¸å¿ƒä½œç”¨**
```
ä¼ ç»Ÿæ–¹å¼ï¼š
å®¢æˆ·ç«¯ â†’ æœåŠ¡A
å®¢æˆ·ç«¯ â†’ æœåŠ¡B  
å®¢æˆ·ç«¯ â†’ æœåŠ¡C
âŒ æ¯ä¸ªæœåŠ¡éƒ½è¦æš´éœ²ç»™å¤–éƒ¨
âŒ æ²¡æœ‰ç»Ÿä¸€çš„ä¿æŠ¤æªæ–½

ä½¿ç”¨Gatewayï¼š
å®¢æˆ·ç«¯ â†’ Gateway â†’ æœåŠ¡A/B/C
âœ… åªæš´éœ²ä¸€ä¸ªå…¥å£
âœ… ç»Ÿä¸€çš„æµé‡æ§åˆ¶
âœ… ç»Ÿä¸€çš„å®‰å…¨è®¤è¯
```

### 1.2 ä¸ºä»€ä¹ˆè¦åœ¨Gatewayé›†æˆSentinel


**ğŸ¯ ä¿æŠ¤åœºæ™¯**
```
åœºæ™¯1ï¼šçªå‘æµé‡å†²å‡»
åŒ11æ´»åŠ¨å¼€å§‹ â†’ å¤§é‡ç”¨æˆ·æ¶Œå…¥ â†’ Gatewayé¦–å½“å…¶å†²
ğŸ’¡ åœ¨ç½‘å…³å±‚é™æµï¼Œä¿æŠ¤åç«¯æ‰€æœ‰æœåŠ¡

åœºæ™¯2ï¼šæ¶æ„æ”»å‡»é˜²æŠ¤
é»‘å®¢å‘èµ·æ”»å‡» â†’ å¤§é‡æ— æ•ˆè¯·æ±‚ â†’ æ¶ˆè€—ç³»ç»Ÿèµ„æº
ğŸ’¡ åœ¨å…¥å£å¤„æ‹¦æˆªï¼Œé¿å…èµ„æºæµªè´¹

åœºæ™¯3ï¼šæœåŠ¡é™çº§å¤„ç†
åç«¯æœåŠ¡æ•…éšœ â†’ è¯·æ±‚è¶…æ—¶ â†’ å½±å“æ•´ä½“å¯ç”¨æ€§
ğŸ’¡ å¿«é€Ÿé™çº§ï¼Œè¿”å›å‹å¥½æç¤º
```

**ğŸ“Š é˜²æŠ¤ä¼˜åŠ¿å¯¹æ¯”**

| é˜²æŠ¤ä½ç½® | **ä¿æŠ¤èŒƒå›´** | **æ€§èƒ½å½±å“** | **é…ç½®å¤æ‚åº¦** | **é€‚ç”¨åœºæ™¯** |
|---------|------------|------------|--------------|------------|
| ç½‘å…³å±‚ | `æ‰€æœ‰æœåŠ¡ç»Ÿä¸€é˜²æŠ¤` | `è¾ƒå°ï¼Œä¸€æ¬¡æ‹¦æˆª` | `é›†ä¸­é…ç½®ï¼Œç®€å•` | `å…¨å±€æµé‡æ§åˆ¶` |
| æœåŠ¡å±‚ | `å•ä¸ªæœåŠ¡ç‹¬ç«‹é˜²æŠ¤` | `è¾ƒå¤§ï¼Œå¤šæ¬¡æ£€æŸ¥` | `åˆ†æ•£é…ç½®ï¼Œå¤æ‚` | `ç²¾ç»†åŒ–æ§åˆ¶` |
| ç»„åˆé˜²æŠ¤ | `å¤šå±‚ä¿æŠ¤` | `ä¸­ç­‰` | `éœ€åè°ƒé…ç½®` | `é‡è¦ç³»ç»Ÿ` |

### 1.3 é›†æˆå‡†å¤‡å·¥ä½œ


**ğŸ“¦ ä¾èµ–å¼•å…¥**
```xml
<!-- Spring Cloud Gateway -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-gateway</artifactId>
</dependency>

<!-- Sentinel Gatewayé€‚é…å™¨ -->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-alibaba-sentinel-gateway</artifactId>
</dependency>

<!-- Sentinelæ•°æ®æºï¼ˆå¯é€‰ï¼Œç”¨äºåŠ¨æ€é…ç½®ï¼‰ -->
<dependency>
    <groupId>com.alibaba.csp</groupId>
    <artifactId>sentinel-datasource-nacos</artifactId>
</dependency>
```

**ğŸ”§ åŸºç¡€é…ç½®**
```yaml
spring:
  cloud:
    # GatewayåŸºç¡€é…ç½®
    gateway:
      routes:
        - id: user-service
          uri: lb://user-service
          predicates:
            - Path=/user/**
        - id: order-service
          uri: lb://order-service
          predicates:
            - Path=/order/**
    
    # Sentinelé…ç½®
    sentinel:
      transport:
        dashboard: localhost:8080  # æ§åˆ¶å°åœ°å€
        port: 8719                 # é€šä¿¡ç«¯å£
      # å¼€å¯Gatewayæ”¯æŒ
      scg:
        fallback:
          mode: response           # é™çº§å“åº”æ¨¡å¼
          response-body: '{"code":429,"msg":"ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•"}'
```

---

## 2. âš¡ ç½‘å…³é™æµé…ç½®


### 2.1 GatewayFlowRuleè¯¦è§£


**ğŸ”¸ è§„åˆ™æ ¸å¿ƒå­—æ®µ**
```
GatewayFlowRule å°±æ˜¯ç½‘å…³çš„"äº¤é€šè§„åˆ™"ï¼š

resourceï¼šä¿æŠ¤å“ªæ¡è·¯ â†’ è·¯ç”±IDæˆ–APIåˆ†ç»„å
countï¼šé™åˆ¶å¤šå°‘è½¦ â†’ QPSæˆ–å¹¶å‘æ•°
intervalSecï¼šç»Ÿè®¡æ—¶é—´çª—å£ â†’ 1ç§’å†…çš„æµé‡
controlBehaviorï¼šè¶…é™æ€ä¹ˆåŠ â†’ æ‹’ç»/æ’é˜Ÿ
```

**ğŸ’» ä»£ç é…ç½®ç¤ºä¾‹**
```java
@Configuration
public class GatewayRuleConfig {
    
    @PostConstruct
    public void initGatewayRules() {
        Set<GatewayFlowRule> rules = new HashSet<>();
        
        // è§„åˆ™1ï¼šç”¨æˆ·æœåŠ¡é™æµ
        GatewayFlowRule userRule = new GatewayFlowRule("user-service")
            .setCount(100)              // æ¯ç§’100ä¸ªè¯·æ±‚
            .setIntervalSec(1);         // 1ç§’æ—¶é—´çª—å£
        
        // è§„åˆ™2ï¼šè®¢å•æœåŠ¡é™æµï¼ˆæ›´ä¸¥æ ¼ï¼‰
        GatewayFlowRule orderRule = new GatewayFlowRule("order-service")
            .setCount(50)               // æ¯ç§’50ä¸ªè¯·æ±‚
            .setIntervalSec(1)
            .setControlBehavior(RuleConstant.CONTROL_BEHAVIOR_RATE_LIMITER)
            .setMaxQueueingTimeMs(500); // æ’é˜Ÿç­‰å¾…500ms
        
        rules.add(userRule);
        rules.add(orderRule);
        
        // åŠ è½½è§„åˆ™
        GatewayRuleManager.loadRules(rules);
    }
}
```

### 2.2 é™æµç­–ç•¥è¯¦è§£


**ğŸ”¹ å¿«é€Ÿå¤±è´¥æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰**
```
å·¥ä½œåŸç†ï¼š
è¯·æ±‚åˆ°è¾¾ â†’ æ£€æŸ¥QPS â†’ è¶…é™ç›´æ¥æ‹’ç»

å°±åƒé“¶è¡Œçª—å£ï¼š
æ­£å¸¸æ—¶ï¼š[å®¢æˆ·1è¿›å…¥] [å®¢æˆ·2è¿›å…¥] [å®¢æˆ·3è¿›å…¥]
é«˜å³°æ—¶ï¼š[å®¢æˆ·1è¿›å…¥] [å®¢æˆ·2è¿›å…¥] [å®¢æˆ·3âŒæ‹’ç»]

é…ç½®ç¤ºä¾‹ï¼š
GatewayFlowRule rule = new GatewayFlowRule("api-route")
    .setCount(100)
    .setControlBehavior(RuleConstant.CONTROL_BEHAVIOR_DEFAULT);

ä¼˜ç‚¹ï¼šå“åº”å¿«ï¼Œä¿æŠ¤åŠæ—¶
ç¼ºç‚¹ï¼šç”¨æˆ·ä½“éªŒå·®ï¼Œç›´æ¥è¢«æ‹’
```

**ğŸ”¹ åŒ€é€Ÿæ’é˜Ÿæ¨¡å¼**
```
å·¥ä½œåŸç†ï¼š
è¯·æ±‚åˆ°è¾¾ â†’ æ£€æŸ¥é˜Ÿåˆ— â†’ æ’é˜Ÿç­‰å¾…å¤„ç†

å°±åƒæœºåœºå®‰æ£€ï¼š
é«˜å³°æœŸä¸ç›´æ¥æ‹’ç»ï¼Œè€Œæ˜¯è®©ä¹˜å®¢æ’é˜Ÿ
é˜Ÿä¼å¤ªé•¿è¶…æ—¶æ‰æ‹’ç»

é…ç½®ç¤ºä¾‹ï¼š
GatewayFlowRule rule = new GatewayFlowRule("api-route")
    .setCount(50)
    .setControlBehavior(RuleConstant.CONTROL_BEHAVIOR_RATE_LIMITER)
    .setMaxQueueingTimeMs(1000);  // æœ€å¤šæ’é˜Ÿ1ç§’

è®¡ç®—å…¬å¼ï¼š
æ’é˜Ÿæ—¶é—´ = (å½“å‰ä½ç½® - count) / count Ã— 1000ms
ç¤ºä¾‹ï¼šç¬¬51ä¸ªè¯·æ±‚ï¼Œæ’é˜Ÿ = (51-50)/50 Ã— 1000 = 20ms

ä¼˜ç‚¹ï¼šæµé‡å¹³æ»‘ï¼Œæå‡é€šè¿‡ç‡
ç¼ºç‚¹ï¼šå“åº”å˜æ…¢ï¼Œç­‰å¾…æ—¶é—´å¢åŠ 
```

### 2.3 è‡ªå®šä¹‰é™çº§å“åº”


**ğŸ¨ ä¼˜é›…çš„é”™è¯¯æç¤º**
```java
@Component
public class CustomBlockRequestHandler implements BlockRequestHandler {
    
    @Override
    public Mono<ServerResponse> handleRequest(ServerWebExchange exchange, Throwable ex) {
        
        // åˆ¤æ–­å¼‚å¸¸ç±»å‹
        if (ex instanceof FlowException) {
            // é™æµå¼‚å¸¸
            return buildResponse(429, "è®¿é—®å¤ªé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•");
        } else if (ex instanceof DegradeException) {
            // é™çº§å¼‚å¸¸
            return buildResponse(503, "æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•");
        }
        
        // é»˜è®¤å“åº”
        return buildResponse(500, "ç³»ç»Ÿç¹å¿™");
    }
    
    private Mono<ServerResponse> buildResponse(int code, String message) {
        Map<String, Object> result = new HashMap<>();
        result.put("code", code);
        result.put("message", message);
        result.put("timestamp", System.currentTimeMillis());
        
        return ServerResponse
            .status(code)
            .contentType(MediaType.APPLICATION_JSON)
            .body(BodyInserters.fromValue(result));
    }
}
```

**ğŸ“± ç”¨æˆ·å‹å¥½çš„æç¤º**
```json
é™æµå“åº”ç¤ºä¾‹ï¼š
{
  "code": 429,
  "message": "è®¿é—®å¤ªé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•",
  "timestamp": 1695456789000,
  "retryAfter": 1  // å»ºè®®1ç§’åé‡è¯•
}

é™çº§å“åº”ç¤ºä¾‹ï¼š
{
  "code": 503,
  "message": "æœåŠ¡å‡çº§ä¸­ï¼Œé¢„è®¡5åˆ†é’Ÿåæ¢å¤",
  "timestamp": 1695456789000
}
```

---

## 3. ğŸ›¡ï¸ è·¯ç”±çº§ä¿æŠ¤ç­–ç•¥


### 3.1 ä»€ä¹ˆæ˜¯è·¯ç”±çº§ä¿æŠ¤


**ğŸ’¡ æ¦‚å¿µç†è§£**
```
ç½‘å…³ä¸­çš„è·¯ç”± = ä¸åŒçš„ä¸šåŠ¡å…¥å£

ç”¨æˆ·è·¯ç”±ï¼š    /user/**  â†’ ç”¨æˆ·æœåŠ¡
è®¢å•è·¯ç”±ï¼š    /order/** â†’ è®¢å•æœåŠ¡
æ”¯ä»˜è·¯ç”±ï¼š    /pay/**   â†’ æ”¯ä»˜æœåŠ¡

è·¯ç”±çº§ä¿æŠ¤ = ä¸ºæ¯æ¡è·¯ç”±è®¾ç½®ç‹¬ç«‹çš„ä¿æŠ¤è§„åˆ™
```

**ğŸ¯ ä¸ºä»€ä¹ˆéœ€è¦åˆ†åˆ«ä¿æŠ¤**
```
åœºæ™¯å¯¹æ¯”ï¼š

æ–¹å¼1ï¼šç»Ÿä¸€é™æµï¼ˆä¸æ¨èï¼‰
æ‰€æœ‰è·¯ç”±å…±äº«QPS=1000
âŒ è®¢å•æœåŠ¡æŠ¢å äº†900ä¸ªé…é¢
âŒ ç”¨æˆ·æœåŠ¡åªå‰©100ä¸ªå¯ç”¨
âŒ é‡è¦ä¸šåŠ¡å¯èƒ½è¢«å½±å“

æ–¹å¼2ï¼šè·¯ç”±çº§é™æµï¼ˆæ¨èï¼‰
ç”¨æˆ·è·¯ç”±ï¼šQPS=500
è®¢å•è·¯ç”±ï¼šQPS=300
æ”¯ä»˜è·¯ç”±ï¼šQPS=200
âœ… å„ä¸šåŠ¡ç‹¬ç«‹é…é¢
âœ… äº’ä¸å½±å“
âœ… ç²¾ç¡®æ§åˆ¶
```

### 3.2 è·¯ç”±ä¿æŠ¤é…ç½®å®æˆ˜


**ğŸ“‹ åŸºç¡€é…ç½®**
```java
@Configuration
public class RouteProtectionConfig {
    
    @PostConstruct
    public void initRouteRules() {
        Set<GatewayFlowRule> rules = new HashSet<>();
        
        // 1. ç”¨æˆ·æœåŠ¡è·¯ç”±ä¿æŠ¤
        rules.add(new GatewayFlowRule("user-service")
            .setResourceMode(SentinelGatewayConstants.RESOURCE_MODE_ROUTE_ID)
            .setCount(500)
            .setIntervalSec(1));
        
        // 2. è®¢å•æœåŠ¡è·¯ç”±ä¿æŠ¤ï¼ˆæ›´ä¸¥æ ¼ï¼‰
        rules.add(new GatewayFlowRule("order-service")
            .setResourceMode(SentinelGatewayConstants.RESOURCE_MODE_ROUTE_ID)
            .setCount(300)
            .setIntervalSec(1)
            .setControlBehavior(RuleConstant.CONTROL_BEHAVIOR_RATE_LIMITER)
            .setMaxQueueingTimeMs(500));
        
        // 3. æ”¯ä»˜æœåŠ¡è·¯ç”±ä¿æŠ¤ï¼ˆæœ€ä¸¥æ ¼ï¼‰
        rules.add(new GatewayFlowRule("pay-service")
            .setResourceMode(SentinelGatewayConstants.RESOURCE_MODE_ROUTE_ID)
            .setCount(100)
            .setIntervalSec(1)
            .setBurst(10));  // å…è®¸10ä¸ªçªå‘æµé‡
        
        GatewayRuleManager.loadRules(rules);
    }
}
```

**ğŸ” èµ„æºæ¨¡å¼è¯´æ˜**
```
ä¸¤ç§èµ„æºæ¨¡å¼å¯¹æ¯”ï¼š

RESOURCE_MODE_ROUTE_IDï¼š
- æŒ‰è·¯ç”±IDåŒ¹é…
- ç²—ç²’åº¦æ§åˆ¶
- é…ç½®ç®€å•
ç¤ºä¾‹ï¼šé™åˆ¶æ•´ä¸ª user-service è·¯ç”±

RESOURCE_MODE_CUSTOM_API_NAMEï¼š
- æŒ‰APIåˆ†ç»„åŒ¹é…
- ç»†ç²’åº¦æ§åˆ¶
- é…ç½®çµæ´»
ç¤ºä¾‹ï¼šé™åˆ¶ user-service ä¸­çš„ç‰¹å®šAPIç»„
```

### 3.3 åŠ¨æ€è°ƒæ•´ä¿æŠ¤ç­–ç•¥


**âš™ï¸ æ ¹æ®ä¸šåŠ¡åœºæ™¯è°ƒæ•´**
```java
@Service
public class DynamicRouteProtection {
    
    // æ´»åŠ¨æœŸé—´æé«˜é™æµé˜ˆå€¼
    public void increaseLimit(String routeId, double factor) {
        Set<GatewayFlowRule> rules = GatewayRuleManager.getRules();
        
        rules.forEach(rule -> {
            if (rule.getResource().equals(routeId)) {
                // é˜ˆå€¼æå‡åˆ°åŸæ¥çš„factorå€
                rule.setCount(rule.getCount() * factor);
            }
        });
        
        GatewayRuleManager.loadRules(rules);
        System.out.println(routeId + " é™æµé˜ˆå€¼å·²æå‡" + factor + "å€");
    }
    
    // æ•…éšœæ—¶å¿«é€Ÿé™çº§
    public void quickDegrade(String routeId) {
        Set<GatewayFlowRule> rules = GatewayRuleManager.getRules();
        
        rules.forEach(rule -> {
            if (rule.getResource().equals(routeId)) {
                // é™ä½åˆ°åŸæ¥çš„10%
                rule.setCount(rule.getCount() * 0.1);
            }
        });
        
        GatewayRuleManager.loadRules(rules);
        System.out.println(routeId + " å·²è¿›å…¥é™çº§æ¨¡å¼");
    }
}
```

---

## 4. ğŸ“¦ APIåˆ†ç»„ç®¡ç†


### 4.1 ä»€ä¹ˆæ˜¯APIåˆ†ç»„


**ğŸ’¡ é€šä¿—ç†è§£**
```
åŒä¸€ä¸ªè·¯ç”±ä¸‹å¯èƒ½æœ‰å¾ˆå¤šæ¥å£ï¼š

ç”¨æˆ·æœåŠ¡è·¯ç”± (/user/**)ï¼š
â”œâ”€ /user/login      â†’ ç™»å½•æ¥å£
â”œâ”€ /user/register   â†’ æ³¨å†Œæ¥å£
â”œâ”€ /user/info       â†’ æŸ¥è¯¢ä¿¡æ¯
â””â”€ /user/update     â†’ æ›´æ–°ä¿¡æ¯

å¦‚æœåªæŒ‰è·¯ç”±é™æµï¼š
âŒ æ‰€æœ‰æ¥å£å…±äº«é…é¢
âŒ æ— æ³•é’ˆå¯¹é‡è¦æ¥å£ç‰¹æ®Šä¿æŠ¤

ä½¿ç”¨APIåˆ†ç»„ï¼š
âœ… æŠŠç›¸å…³æ¥å£åˆ†æˆä¸€ç»„
âœ… å¯¹ä¸åŒç»„è®¾ç½®ä¸åŒè§„åˆ™
âœ… ç²¾ç»†åŒ–æµé‡æ§åˆ¶
```

**ğŸ¯ åˆ†ç»„çš„å¿…è¦æ€§**
```
åœºæ™¯ç¤ºä¾‹ï¼š

ä¸åˆ†ç»„ï¼š
/user/** ç»Ÿä¸€é™æµ1000 QPS
â†’ æŸ¥è¯¢æ¥å£å ç”¨900ä¸ª
â†’ ç™»å½•æ¥å£åªå‰©100ä¸ª
â†’ ç”¨æˆ·æ— æ³•ç™»å½•ï¼

ä½¿ç”¨åˆ†ç»„ï¼š
æ ¸å¿ƒAPIç»„ï¼ˆç™»å½•ã€æ³¨å†Œï¼‰ï¼š500 QPS
æŸ¥è¯¢APIç»„ï¼ˆæŸ¥ä¿¡æ¯ï¼‰ï¼š    300 QPS
æ›´æ–°APIç»„ï¼ˆæ”¹ä¿¡æ¯ï¼‰ï¼š    200 QPS
â†’ å„å¸å…¶èŒï¼Œäº’ä¸å¹²æ‰°
```

### 4.2 åˆ›å»ºAPIåˆ†ç»„


**ğŸ“‹ åˆ†ç»„é…ç½®æ­¥éª¤**
```java
@Configuration
public class ApiGroupConfig {
    
    @PostConstruct
    public void initApiGroups() {
        Set<ApiDefinition> definitions = new HashSet<>();
        
        // 1. åˆ›å»ºæ ¸å¿ƒAPIç»„ï¼ˆç™»å½•ã€æ³¨å†Œç­‰é‡è¦æ¥å£ï¼‰
        ApiDefinition coreApi = new ApiDefinition("core-api")
            .setPredicateItems(new HashSet<ApiPredicateItem>() {{
                // ç™»å½•æ¥å£
                add(new ApiPathPredicateItem()
                    .setPattern("/user/login")
                    .setMatchStrategy(SentinelGatewayConstants.URL_MATCH_STRATEGY_EXACT));
                
                // æ³¨å†Œæ¥å£
                add(new ApiPathPredicateItem()
                    .setPattern("/user/register")
                    .setMatchStrategy(SentinelGatewayConstants.URL_MATCH_STRATEGY_EXACT));
            }});
        
        // 2. åˆ›å»ºæŸ¥è¯¢APIç»„
        ApiDefinition queryApi = new ApiDefinition("query-api")
            .setPredicateItems(new HashSet<ApiPredicateItem>() {{
                // æ‰€æœ‰æŸ¥è¯¢æ¥å£ï¼ˆå‰ç¼€åŒ¹é…ï¼‰
                add(new ApiPathPredicateItem()
                    .setPattern("/user/get/**")
                    .setMatchStrategy(SentinelGatewayConstants.URL_MATCH_STRATEGY_PREFIX));
            }});
        
        // 3. åˆ›å»ºè®¢å•APIç»„
        ApiDefinition orderApi = new ApiDefinition("order-api")
            .setPredicateItems(new HashSet<ApiPredicateItem>() {{
                // ä¸‹å•æ¥å£
                add(new ApiPathPredicateItem()
                    .setPattern("/order/create")
                    .setMatchStrategy(SentinelGatewayConstants.URL_MATCH_STRATEGY_EXACT));
                
                // æ”¯ä»˜æ¥å£
                add(new ApiPathPredicateItem()
                    .setPattern("/order/pay")
                    .setMatchStrategy(SentinelGatewayConstants.URL_MATCH_STRATEGY_EXACT));
            }});
        
        definitions.add(coreApi);
        definitions.add(queryApi);
        definitions.add(orderApi);
        
        GatewayApiDefinitionManager.loadApiDefinitions(definitions);
    }
}
```

**ğŸ” åŒ¹é…ç­–ç•¥è¯´æ˜**
```
URL_MATCH_STRATEGY_EXACTï¼šç²¾ç¡®åŒ¹é…
ç¤ºä¾‹ï¼š/user/login åªåŒ¹é…è¿™ä¸ªè·¯å¾„
é€‚ç”¨ï¼šå…·ä½“çš„æ¥å£

URL_MATCH_STRATEGY_PREFIXï¼šå‰ç¼€åŒ¹é…
ç¤ºä¾‹ï¼š/user/get/** åŒ¹é…æ‰€æœ‰getå¼€å¤´çš„
é€‚ç”¨ï¼šä¸€ç±»ç›¸ä¼¼çš„æ¥å£

URL_MATCH_STRATEGY_REGEXï¼šæ­£åˆ™åŒ¹é…
ç¤ºä¾‹ï¼š/user/\\d+ åŒ¹é…å¸¦æ•°å­—çš„è·¯å¾„
é€‚ç”¨ï¼šå¤æ‚çš„åŒ¹é…è§„åˆ™
```

### 4.3 APIåˆ†ç»„é™æµè§„åˆ™


**âš¡ ä¸ºåˆ†ç»„è®¾ç½®è§„åˆ™**
```java
@Configuration
public class ApiGroupRuleConfig {
    
    @PostConstruct
    public void initApiGroupRules() {
        Set<GatewayFlowRule> rules = new HashSet<>();
        
        // æ ¸å¿ƒAPIç»„ï¼šé«˜ä¼˜å…ˆçº§ï¼Œé™æµå®½æ¾
        rules.add(new GatewayFlowRule("core-api")
            .setResourceMode(SentinelGatewayConstants.RESOURCE_MODE_CUSTOM_API_NAME)
            .setCount(500)
            .setIntervalSec(1)
            .setControlBehavior(RuleConstant.CONTROL_BEHAVIOR_RATE_LIMITER)
            .setMaxQueueingTimeMs(1000));  // æ’é˜Ÿ1ç§’
        
        // æŸ¥è¯¢APIç»„ï¼šä¸­ç­‰é™æµ
        rules.add(new GatewayFlowRule("query-api")
            .setResourceMode(SentinelGatewayConstants.RESOURCE_MODE_CUSTOM_API_NAME)
            .setCount(300)
            .setIntervalSec(1));
        
        // è®¢å•APIç»„ï¼šä¸¥æ ¼é™æµ
        rules.add(new GatewayFlowRule("order-api")
            .setResourceMode(SentinelGatewayConstants.RESOURCE_MODE_CUSTOM_API_NAME)
            .setCount(100)
            .setIntervalSec(1)
            .setBurst(10));  // å…è®¸10ä¸ªçªå‘
        
        GatewayRuleManager.loadRules(rules);
    }
}
```

**ğŸ“Š åˆ†ç»„ä¿æŠ¤æ•ˆæœ**
```
è¯·æ±‚æµç¨‹ï¼š

å®¢æˆ·ç«¯è¯·æ±‚ /user/login
    â†“
è¿›å…¥Gateway
    â†“
åŒ¹é…åˆ° user-service è·¯ç”± â†’ æ£€æŸ¥è·¯ç”±è§„åˆ™ âœ“
    â†“
åŒ¹é…åˆ° core-api åˆ†ç»„ â†’ æ£€æŸ¥åˆ†ç»„è§„åˆ™ âœ“
    â†“
éƒ½é€šè¿‡ â†’ è½¬å‘åˆ°åç«¯æœåŠ¡
```

---

## 5. ğŸ¯ å‚æ•°é™æµå®æˆ˜


### 5.1 ä»€ä¹ˆæ˜¯å‚æ•°é™æµ


**ğŸ’¡ æ ¸å¿ƒæ¦‚å¿µ**
```
æ™®é€šé™æµï¼š
ä¸ç®¡è°è®¿é—®ï¼Œç»Ÿä¸€é™åˆ¶
ç¤ºä¾‹ï¼šæ‰€æœ‰ç”¨æˆ·å…±äº«1000 QPS

å‚æ•°é™æµï¼š
æ ¹æ®è¯·æ±‚å‚æ•°åŒºåˆ«å¯¹å¾…
ç¤ºä¾‹ï¼š
- VIPç”¨æˆ·ï¼š2000 QPS
- æ™®é€šç”¨æˆ·ï¼š500 QPS
- é»‘åå•ç”¨æˆ·ï¼š10 QPS
```

**ğŸ¯ åº”ç”¨åœºæ™¯**
```
åœºæ™¯1ï¼šç”¨æˆ·ç­‰çº§åŒºåˆ†
VIPä¼šå‘˜ â†’ é«˜é…é¢
æ™®é€šä¼šå‘˜ â†’ æ ‡å‡†é…é¢
æ¸¸å®¢ â†’ ä½é…é¢

åœºæ™¯2ï¼šIPé™æµ
æ­£å¸¸IP â†’ æ­£å¸¸è®¿é—®
å¯ç–‘IP â†’ ä¸¥æ ¼é™åˆ¶
é»‘åå•IP â†’ ç›´æ¥æ‹’ç»

åœºæ™¯3ï¼šæ¥å£å‚æ•°æ§åˆ¶
æŸ¥è¯¢å•ä¸ªå•†å“ â†’ é…é¢å……è¶³
æ‰¹é‡æŸ¥è¯¢å•†å“ â†’ ä¸¥æ ¼é™åˆ¶
```

### 5.2 å‚æ•°æå–é…ç½®


**ğŸ”§ é…ç½®å‚æ•°æå–å™¨**
```java
@Configuration
public class ParamExtractorConfig {
    
    @PostConstruct
    public void initParamExtractor() {
        Set<GatewayFlowRule> rules = new HashSet<>();
        
        // 1. æ ¹æ®URLå‚æ•°é™æµ
        GatewayFlowRule paramRule = new GatewayFlowRule("user-service")
            .setCount(100)
            .setIntervalSec(1);
        
        // é…ç½®å‚æ•°æå–
        GatewayParamFlowItem paramItem = new GatewayParamFlowItem()
            .setParseStrategy(SentinelGatewayConstants.PARAM_PARSE_STRATEGY_URL_PARAM)
            .setFieldName("userId");  // æå–userIdå‚æ•°
        
        paramRule.setParamItem(paramItem);
        rules.add(paramRule);
        
        // 2. æ ¹æ®Headeré™æµ
        GatewayFlowRule headerRule = new GatewayFlowRule("order-service")
            .setCount(50)
            .setIntervalSec(1);
        
        GatewayParamFlowItem headerItem = new GatewayParamFlowItem()
            .setParseStrategy(SentinelGatewayConstants.PARAM_PARSE_STRATEGY_HEADER)
            .setFieldName("X-User-Level");  // æå–ç”¨æˆ·ç­‰çº§
        
        headerRule.setParamItem(headerItem);
        rules.add(headerRule);
        
        GatewayRuleManager.loadRules(rules);
    }
}
```

**ğŸ“‹ å‚æ•°æå–ç­–ç•¥**
```
PARAM_PARSE_STRATEGY_URL_PARAMï¼š
æå–URLå‚æ•°
ç¤ºä¾‹ï¼š/user/info?userId=123 â†’ æå–userId=123

PARAM_PARSE_STRATEGY_HEADERï¼š
æå–è¯·æ±‚å¤´
ç¤ºä¾‹ï¼šX-User-Id: 123 â†’ æå–123

PARAM_PARSE_STRATEGY_HOSTï¼š
æå–Host
ç¤ºä¾‹ï¼šapi.example.com â†’ æå–åŸŸå

PARAM_PARSE_STRATEGY_CLIENT_IPï¼š
æå–å®¢æˆ·ç«¯IP
ç¤ºä¾‹ï¼š192.168.1.100 â†’ æå–IPåœ°å€
```

### 5.3 çƒ­ç‚¹å‚æ•°é™æµ


**ğŸ”¥ é…ç½®çƒ­ç‚¹è§„åˆ™**
```java
@Configuration
public class HotParamConfig {
    
    @PostConstruct
    public void initHotParamRules() {
        // åˆ›å»ºçƒ­ç‚¹å‚æ•°è§„åˆ™
        ParamFlowRule rule = new ParamFlowRule("user-api")
            .setParamIdx(0)              // ç¬¬0ä¸ªå‚æ•°
            .setCount(100)               // é»˜è®¤QPS=100
            .setDurationInSec(1);
        
        // é…ç½®ç‰¹æ®Šå‚æ•°çš„ä¾‹å¤–é¡¹
        List<ParamFlowItem> items = new ArrayList<>();
        
        // VIPç”¨æˆ·ç‰¹æ®Šé…ç½®
        items.add(new ParamFlowItem()
            .setObject("VIP")            // VIPç”¨æˆ·
            .setClassType(String.class)
            .setCount(500));             // QPSæå‡åˆ°500
        
        // é»‘åå•ç”¨æˆ·é™åˆ¶
        items.add(new ParamFlowItem()
            .setObject("BLOCKED")        // é»‘åå•ç”¨æˆ·
            .setClassType(String.class)
            .setCount(10));              // ä¸¥æ ¼é™åˆ¶QPS=10
        
        rule.setParamFlowItemList(items);
        
        // åŠ è½½è§„åˆ™
        ParamFlowRuleManager.loadRules(Collections.singletonList(rule));
    }
}
```

**ğŸ’» ä¸šåŠ¡ä»£ç ä½¿ç”¨**
```java
@RestController
@RequestMapping("/user")
public class UserController {
    
    @GetMapping("/info")
    public Result getUserInfo(@RequestParam String userId,
                             @RequestHeader("X-User-Level") String userLevel) {
        
        // Sentinelä¼šè‡ªåŠ¨æ ¹æ®userLevelå‚æ•°é™æµ
        // VIPç”¨æˆ·ï¼š500 QPS
        // æ™®é€šç”¨æˆ·ï¼š100 QPS
        // é»‘åå•ç”¨æˆ·ï¼š10 QPS
        
        return userService.getInfo(userId);
    }
}
```

### 5.4 è‡ªå®šä¹‰å‚æ•°æå–


**ğŸ¨ å¤æ‚åœºæ™¯å¤„ç†**
```java
@Component
public class CustomParamExtractor implements RequestItemParser {
    
    @Override
    public String parseParameterFor(String resource, ServerWebExchange exchange, 
                                    GatewayParamFlowItem item) {
        
        // 1. ä»è¯·æ±‚å¤´æå–ç”¨æˆ·ID
        String userId = exchange.getRequest()
            .getHeaders()
            .getFirst("X-User-Id");
        
        // 2. æŸ¥è¯¢ç”¨æˆ·ç­‰çº§
        String userLevel = getUserLevel(userId);
        
        // 3. æ ¹æ®ç­‰çº§è¿”å›ä¸åŒçš„é™æµå‚æ•°
        if ("VIP".equals(userLevel)) {
            return "VIP-" + userId;
        } else if ("BLOCKED".equals(userLevel)) {
            return "BLOCKED-" + userId;
        }
        
        return "NORMAL-" + userId;
    }
    
    private String getUserLevel(String userId) {
        // ä»ç¼“å­˜æˆ–æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·ç­‰çº§
        // è¿™é‡Œç®€åŒ–å¤„ç†
        return "NORMAL";
    }
}
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 Gatewayé›†æˆè¦ç‚¹


```
ğŸ”¸ é›†æˆç›®çš„ï¼š
â€¢ ç»Ÿä¸€å…¥å£æµé‡æ§åˆ¶
â€¢ ä¿æŠ¤åç«¯æ‰€æœ‰æœåŠ¡
â€¢ æä¾›é™çº§å‹å¥½å“åº”

ğŸ”¸ æ ¸å¿ƒç»„ä»¶ï¼š
â€¢ GatewayFlowRuleï¼šç½‘å…³é™æµè§„åˆ™
â€¢ GatewayRuleManagerï¼šè§„åˆ™ç®¡ç†å™¨
â€¢ BlockRequestHandlerï¼šé™çº§å¤„ç†å™¨

ğŸ”¸ ä¿æŠ¤å±‚æ¬¡ï¼š
â‘  è·¯ç”±çº§ä¿æŠ¤ï¼šæŒ‰æœåŠ¡è·¯ç”±é™æµ
â‘¡ APIåˆ†ç»„ä¿æŠ¤ï¼šæŒ‰æ¥å£ç»„é™æµ
â‘¢ å‚æ•°çº§ä¿æŠ¤ï¼šæŒ‰å‚æ•°å€¼é™æµ
```

### 6.2 é…ç½®ç­–ç•¥é€‰æ‹©


| åœºæ™¯ | **æ¨èç­–ç•¥** | **é…ç½®è¦ç‚¹** | **æ³¨æ„äº‹é¡¹** |
|-----|------------|------------|------------|
| æ•´ä½“ä¿æŠ¤ | `è·¯ç”±çº§é™æµ` | `æ¯ä¸ªè·¯ç”±ç‹¬ç«‹é…é¢` | `é¿å…äº’ç›¸å½±å“` |
| ç²¾ç»†æ§åˆ¶ | `APIåˆ†ç»„é™æµ` | `é‡è¦æ¥å£ç‰¹æ®Šä¿æŠ¤` | `åˆ†ç»„è¦åˆç†` |
| å·®å¼‚åŒ–æœåŠ¡ | `å‚æ•°é™æµ` | `æ ¹æ®ç”¨æˆ·ç­‰çº§åŒºåˆ†` | `æå–æ•ˆç‡è¦é«˜` |
| çªå‘æµé‡ | `æ’é˜Ÿç­‰å¾…` | `è®¾ç½®åˆç†ç­‰å¾…æ—¶é—´` | `é¿å…æ’é˜Ÿè¿‡é•¿` |

### 6.3 å®æˆ˜å»ºè®®


**âœ… æœ€ä½³å®è·µ**
```
1. åˆ†å±‚ä¿æŠ¤ï¼š
   Gatewayé™æµ + æœåŠ¡é™æµ
   ç¬¬ä¸€é“é˜²çº¿ + æœ€åé˜²çº¿

2. åŠ¨æ€è°ƒæ•´ï¼š
   æ¥å…¥é…ç½®ä¸­å¿ƒ
   æ ¹æ®æµé‡å®æ—¶è°ƒæ•´

3. å‹å¥½é™çº§ï¼š
   è‡ªå®šä¹‰é”™è¯¯å“åº”
   ç»™ç”¨æˆ·æ¸…æ™°æç¤º

4. ç›‘æ§å‘Šè­¦ï¼š
   æ¥å…¥ç›‘æ§ç³»ç»Ÿ
   å¼‚å¸¸åŠæ—¶å‘ç°
```

**âš ï¸ å¸¸è§é—®é¢˜**
```
é—®é¢˜1ï¼šé™æµä¸ç”Ÿæ•ˆ
â†’ æ£€æŸ¥èµ„æºåæ˜¯å¦åŒ¹é…
â†’ ç¡®è®¤è§„åˆ™åŠ è½½æˆåŠŸ

é—®é¢˜2ï¼šè¯¯æ€æ­£å¸¸è¯·æ±‚
â†’ é˜ˆå€¼è®¾ç½®æ˜¯å¦åˆç†
â†’ è€ƒè™‘ä½¿ç”¨æ’é˜Ÿç­–ç•¥

é—®é¢˜3ï¼šæ€§èƒ½å½±å“
â†’ å‚æ•°æå–è¦é«˜æ•ˆ
â†’ é¿å…å¤æ‚è®¡ç®—
```

**ğŸ¯ è®°å¿†è¦ç‚¹**
```
ç½‘å…³é›†æˆä¸‰æ­¥èµ°ï¼š
â‘  å¼•å…¥ä¾èµ–é…ç½®Gateway
â‘¡ å®šä¹‰è§„åˆ™è®¾ç½®é˜ˆå€¼
â‘¢ è‡ªå®šä¹‰é™çº§å‹å¥½å“åº”

ä¿æŠ¤ç²’åº¦ä¸‰å±‚æ¬¡ï¼š
â‘  è·¯ç”±çº§ â†’ ç²—ç²’åº¦ï¼Œç®€å•æœ‰æ•ˆ
â‘¡ APIç»„çº§ â†’ ä¸­ç²’åº¦ï¼Œçµæ´»æ§åˆ¶
â‘¢ å‚æ•°çº§ â†’ ç»†ç²’åº¦ï¼Œç²¾å‡†æ‰“å‡»
```

---

## ğŸ”— ç›¸å…³ä¸»é¢˜

- [SentinelåŸºç¡€æ¦‚å¿µ](./sentinel-basic.md)
- [é™æµè§„åˆ™è¯¦è§£](./sentinel-flow-rule.md)
- [é™çº§ç­–ç•¥é…ç½®](./sentinel-degrade.md)