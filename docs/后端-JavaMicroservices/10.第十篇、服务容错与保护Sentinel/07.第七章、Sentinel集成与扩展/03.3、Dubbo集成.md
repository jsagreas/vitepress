---
title: 3ã€Dubboé›†æˆ
---
## ğŸ“š ç›®å½•

1. [Dubboé›†æˆåŸºç¡€æ¦‚å¿µ](#1-dubboé›†æˆåŸºç¡€æ¦‚å¿µ)
2. [Dubbo Filteræœºåˆ¶è¯¦è§£](#2-dubbo-filteræœºåˆ¶è¯¦è§£)
3. [æœåŠ¡ç«¯ä¿æŠ¤ç­–ç•¥](#3-æœåŠ¡ç«¯ä¿æŠ¤ç­–ç•¥)
4. [å®¢æˆ·ç«¯ä¿æŠ¤ç­–ç•¥](#4-å®¢æˆ·ç«¯ä¿æŠ¤ç­–ç•¥)
5. [æ¥å£çº§æµé‡æ§åˆ¶](#5-æ¥å£çº§æµé‡æ§åˆ¶)
6. [æ–¹æ³•çº§ç²¾ç»†æ§åˆ¶](#6-æ–¹æ³•çº§ç²¾ç»†æ§åˆ¶)
7. [RPCè°ƒç”¨ä¿æŠ¤å®æˆ˜](#7-rpcè°ƒç”¨ä¿æŠ¤å®æˆ˜)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ Dubboé›†æˆåŸºç¡€æ¦‚å¿µ


### 1.1 ä¸ºä»€ä¹ˆéœ€è¦åœ¨Dubboä¸­ä½¿ç”¨Sentinel


**ğŸ”¸ å®é™…ä¸šåŠ¡åœºæ™¯ç†è§£**

æƒ³è±¡ä¸€ä¸‹è¿™æ ·çš„åœºæ™¯ï¼šä½ å¼€å‘äº†ä¸€ä¸ªç”µå•†ç³»ç»Ÿï¼Œç”¨æˆ·æœåŠ¡ã€è®¢å•æœåŠ¡ã€åº“å­˜æœåŠ¡ä¹‹é—´é€šè¿‡Dubboè¿›è¡Œè¿œç¨‹è°ƒç”¨ã€‚çªç„¶æœ‰ä¸€å¤©æä¿ƒé”€æ´»åŠ¨ï¼Œå¤§é‡ç”¨æˆ·æ¶Œå…¥ï¼š

```
æ­£å¸¸æƒ…å†µï¼š
ç”¨æˆ·æœåŠ¡ â”€â”€è°ƒç”¨â”€â”€> è®¢å•æœåŠ¡ â”€â”€è°ƒç”¨â”€â”€> åº“å­˜æœåŠ¡
   âœ…           âœ…            âœ…
  æ­£å¸¸         æ­£å¸¸          æ­£å¸¸

ä¿ƒé”€é«˜å³°æœŸï¼ˆæ²¡æœ‰ä¿æŠ¤ï¼‰ï¼š
ç”¨æˆ·æœåŠ¡ â”€â”€è°ƒç”¨â”€â”€> è®¢å•æœåŠ¡ â”€â”€è°ƒç”¨â”€â”€> åº“å­˜æœåŠ¡
 ğŸ˜°å¤§é‡è¯·æ±‚    ğŸ˜µè®¢å•å †ç§¯    ğŸ’¥åº“å­˜å´©æºƒ
   â†“              â†“             â†“
 å“åº”æ…¢         è°ƒç”¨è¶…æ—¶      æœåŠ¡å®•æœº
```

**ğŸ’¡ Sentinelèƒ½è§£å†³ä»€ä¹ˆé—®é¢˜**

| é—®é¢˜åœºæ™¯ | æ²¡æœ‰Sentinel | ä½¿ç”¨Sentinelå |
|---------|-------------|---------------|
| **è°ƒç”¨æ´ªå³°** | ä¸‹æ¸¸æœåŠ¡è¢«æ‰“å® | æµé‡å‰Šå³°ï¼Œä¿æŠ¤æœåŠ¡ |
| **æ…¢è°ƒç”¨** | çº¿ç¨‹æ± è€—å°½ | ç†”æ–­å¿«é€Ÿå¤±è´¥ |
| **æœåŠ¡å¼‚å¸¸** | é›ªå´©æ•ˆåº” | é™çº§ä¿æŠ¤ |
| **ä¾èµ–è¶…æ—¶** | èµ„æºæµªè´¹ | åŠæ—¶ç†”æ–­é‡Šæ”¾ |

### 1.2 Dubboä¸Sentinelçš„åä½œå…³ç³»


**ğŸ”— åä½œæ¶æ„å›¾**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Dubbo RPC è°ƒç”¨é“¾è·¯            â”‚
â”‚                                        â”‚
â”‚  Consumer        Provider             â”‚
â”‚  æ¶ˆè´¹è€…          æä¾›è€…                â”‚
â”‚    â”‚               â”‚                   â”‚
â”‚    â”œâ”€è¯·æ±‚â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚
â”‚    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                   â”‚
â”‚    â”‚   â”‚Sentinel â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚    â”‚   â”‚ Filter  â”‚ â”‚ â”‚Sentinel â”‚      â”‚
â”‚    â”‚   â”‚å®¢æˆ·ç«¯ä¿æŠ¤â”‚ â”‚ â”‚ Filter  â”‚      â”‚
â”‚    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚æœåŠ¡ç«¯ä¿æŠ¤â”‚      â”‚
â”‚    â”‚               â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚    â”‚<â”€å“åº”â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å…³é”®ç†è§£ï¼š
â€¢ Filteræ˜¯Dubboçš„æ‹¦æˆªå™¨æœºåˆ¶
â€¢ Sentinelé€šè¿‡Filteråœ¨è°ƒç”¨å‰åè¿›è¡Œä¿æŠ¤
â€¢ æ”¯æŒæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯åŒå‘ä¿æŠ¤
```

### 1.3 é›†æˆæ–¹å¼æ¦‚è§ˆ


**ğŸ“¦ é›†æˆçš„ä¸‰ç§å½¢å¼**

**æ–¹å¼ä¸€ï¼šè‡ªåŠ¨é›†æˆï¼ˆæ¨èæ–°æ‰‹ï¼‰**
```xml
<!-- åªéœ€å¼•å…¥ä¾èµ–ï¼Œè‡ªåŠ¨ç”Ÿæ•ˆ -->
<dependency>
    <groupId>com.alibaba.csp</groupId>
    <artifactId>sentinel-apache-dubbo-adapter</artifactId>
    <version>1.8.6</version>
</dependency>
```

**æ–¹å¼äºŒï¼šæ‰‹åŠ¨é…ç½®Filter**
```xml
<!-- Dubboé…ç½®æ–‡ä»¶ä¸­æ˜¾å¼å£°æ˜ -->
<dubbo:provider filter="sentinel.dubbo.provider.filter"/>
<dubbo:consumer filter="sentinel.dubbo.consumer.filter"/>
```

**æ–¹å¼ä¸‰ï¼šç¼–ç¨‹å¼é…ç½®**
```java
// åœ¨ä»£ç ä¸­åŠ¨æ€é…ç½®
@Bean
public FilterConfig sentinelFilterConfig() {
    FilterConfig config = new FilterConfig();
    config.setId("sentinel.dubbo.provider.filter");
    return config;
}
```

---

## 2. ğŸ”§ Dubbo Filteræœºåˆ¶è¯¦è§£


### 2.1 Filteræ˜¯ä»€ä¹ˆ


**ğŸ”¸ é€šä¿—ç†è§£**

Filterå°±åƒæ˜¯å®‰æ£€é—¨ï¼Œæ¯æ¬¡Dubboè°ƒç”¨éƒ½è¦ç»è¿‡è¿™é“é—¨ï¼š

```
è¯·æ±‚æµç¨‹ï¼š
å®¢æˆ·ç«¯å‘èµ·è°ƒç”¨
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Filter 1   â”‚ â† è®°å½•æ—¥å¿—
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Filter 2   â”‚ â† Sentinelæµæ§
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  
â”‚  Filter 3   â”‚ â† ç›‘æ§ç»Ÿè®¡
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
å®é™…çš„æœåŠ¡æ–¹æ³•
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Filter 3   â”‚ â† è¿”å›æ—¶ä¹Ÿä¼šç»è¿‡
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Filter 2   â”‚ 
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Filter 1   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
è¿”å›ç»™å®¢æˆ·ç«¯
```

### 2.2 Sentinel Filterçš„å·¥ä½œåŸç†


**âš™ï¸ SentinelDubboProviderFilterï¼ˆæœåŠ¡ç«¯ï¼‰**

è¿™ä¸ªFilteråœ¨**æœåŠ¡æä¾›æ–¹**å·¥ä½œï¼Œä¸»è¦åŠŸèƒ½ï¼š

- **æµé‡ç»Ÿè®¡**ï¼šè®°å½•è¿™ä¸ªæ¥å£è¢«è°ƒç”¨äº†å¤šå°‘æ¬¡
- **é™æµä¿æŠ¤**ï¼šQPSè¶…è¿‡é˜ˆå€¼æ—¶æ‹’ç»è¯·æ±‚
- **ç†”æ–­é™çº§**ï¼šå‘ç°å¼‚å¸¸å¤šäº†å°±å¿«é€Ÿå¤±è´¥
- **èµ„æºç®¡ç†**ï¼šç»™æ¯ä¸ªæ¥å£åˆ†é…èµ„æºåç§°

```java
// ç®€åŒ–çš„å·¥ä½œæµç¨‹
public Result invoke(Invoker invoker, Invocation invocation) {
    // 1. æ„å»ºèµ„æºåç§°ï¼ˆæ¥å£+æ–¹æ³•ï¼‰
    String resourceName = "dubbo:provider:" + 
        invocation.getInvoker().getInterface().getName() + 
        ":" + invocation.getMethodName();
    
    Entry entry = null;
    try {
        // 2. è¿›è¡ŒSentinelæ£€æŸ¥
        entry = SphU.entry(resourceName);
        
        // 3. é€šè¿‡æ£€æŸ¥ï¼Œæ‰§è¡Œå®é™…æ–¹æ³•
        return invoker.invoke(invocation);
        
    } catch (BlockException e) {
        // 4. è¢«é™æµ/ç†”æ–­ï¼Œè¿”å›å‹å¥½æç¤º
        return new RpcResult(new Exception("æœåŠ¡ç¹å¿™ï¼Œè¯·ç¨åé‡è¯•"));
    } finally {
        // 5. é‡Šæ”¾èµ„æº
        if (entry != null) {
            entry.exit();
        }
    }
}
```

**âš™ï¸ SentinelDubboConsumerFilterï¼ˆå®¢æˆ·ç«¯ï¼‰**

è¿™ä¸ªFilteråœ¨**æœåŠ¡è°ƒç”¨æ–¹**å·¥ä½œï¼Œé˜²æ­¢å·±æ–¹è¢«æ‹–å®ï¼š

```
åœºæ™¯ï¼šä¸‹æ¸¸æœåŠ¡å˜æ…¢äº†

æ²¡æœ‰å®¢æˆ·ç«¯ä¿æŠ¤ï¼š
è°ƒç”¨æ–¹ â”€â”€â”€â”€â”€ç­‰å¾…â”€â”€â”€â”€> æ…¢æœåŠ¡
  â†“
çº¿ç¨‹å †ç§¯
  â†“  
è°ƒç”¨æ–¹ä¹ŸæŒ‚äº†

æœ‰å®¢æˆ·ç«¯ä¿æŠ¤ï¼š
è°ƒç”¨æ–¹ â”€è¶…æ—¶ç†”æ–­â”€Xâ”€> æ…¢æœåŠ¡
  â†“
å¿«é€Ÿå¤±è´¥
  â†“
è°ƒç”¨æ–¹æ­£å¸¸è¿è¡Œ
```

---

## 3. ğŸ›¡ï¸ æœåŠ¡ç«¯ä¿æŠ¤ç­–ç•¥


### 3.1 ä¸ºä»€ä¹ˆéœ€è¦æœåŠ¡ç«¯ä¿æŠ¤


**åœºæ™¯æ¨¡æ‹Ÿï¼šå•†å“è¯¦æƒ…æœåŠ¡**

ä½ çš„å•†å“è¯¦æƒ…æœåŠ¡æ­£å¸¸èƒ½å¤„ç†**1000 QPS**ï¼Œä½†çªç„¶é‡åˆ°ï¼š

```
æ­£å¸¸æµé‡ï¼š
â”Œâ”€â”€â”€â”€â”€â”  800 QPS   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚å®¢æˆ·ç«¯â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚å•†å“è¯¦æƒ…æœåŠ¡â”‚ âœ… å“åº”æ­£å¸¸
â””â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¼‚å¸¸æµé‡ï¼š
â”Œâ”€â”€â”€â”€â”€â”  5000 QPS  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚çˆ¬è™«  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚å•†å“è¯¦æƒ…æœåŠ¡â”‚ ğŸ’¥ CPU 100%
â””â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     ğŸ’¥ å†…å­˜æº¢å‡º
                                    ğŸ’¥ æœåŠ¡å´©æºƒ
```

**ğŸ¯ æœåŠ¡ç«¯ä¿æŠ¤çš„ç›®æ ‡**

> ğŸ’¡ **æ ¸å¿ƒæ€æƒ³**ï¼šä¿æŠ¤è‡ªå·±çš„æœåŠ¡ä¸è¢«æ‰“å®ï¼Œæ‹’ç»è¶…å‡ºæ‰¿å—èƒ½åŠ›çš„è¯·æ±‚

---

### 3.2 QPSé™æµä¿æŠ¤


**ğŸ“Š é…ç½®ç¤ºä¾‹ï¼šé™åˆ¶å•†å“è¯¦æƒ…æ¥å£**

```java
@Service
public class ProductServiceImpl implements ProductService {
    
    @Override
    public ProductDetail getProductDetail(Long productId) {
        // è¿™ä¸ªæ–¹æ³•ä¼šè¢«Sentinelè‡ªåŠ¨ä¿æŠ¤
        // èµ„æºåï¼šdubbo:provider:com.example.ProductService:getProductDetail
        return productMapper.selectById(productId);
    }
}
```

**é…ç½®é™æµè§„åˆ™ï¼š**
```java
// åœ¨åº”ç”¨å¯åŠ¨æ—¶é…ç½®
@PostConstruct
public void initFlowRules() {
    List<FlowRule> rules = new ArrayList<>();
    
    FlowRule rule = new FlowRule();
    // èµ„æºåç§°ï¼ˆDubboæ¥å£+æ–¹æ³•ï¼‰
    rule.setResource("dubbo:provider:com.example.ProductService:getProductDetail");
    // QPSé˜ˆå€¼
    rule.setCount(1000);
    // é™æµæ¨¡å¼ï¼šQPS
    rule.setGrade(RuleConstant.FLOW_GRADE_QPS);
    // æµæ§æ•ˆæœï¼šå¿«é€Ÿå¤±è´¥
    rule.setControlBehavior(RuleConstant.CONTROL_BEHAVIOR_DEFAULT);
    
    rules.add(rule);
    FlowRuleManager.loadRules(rules);
}
```

**æ•ˆæœæ¼”ç¤ºï¼š**
```
ç¬¬1000æ¬¡è°ƒç”¨ï¼šâœ… æˆåŠŸè¿”å›å•†å“è¯¦æƒ…
ç¬¬1001æ¬¡è°ƒç”¨ï¼šâŒ è¢«é™æµï¼Œè¿”å›"æœåŠ¡ç¹å¿™"
ç¬¬1002æ¬¡è°ƒç”¨ï¼šâŒ è¢«é™æµ
...
ç­‰1ç§’åï¼š
ç¬¬1æ¬¡è°ƒç”¨ï¼šâœ… åˆå¯ä»¥è°ƒç”¨äº†
```

### 3.3 æ…¢è°ƒç”¨ç†”æ–­ä¿æŠ¤


**åœºæ™¯ï¼šæ•°æ®åº“æŸ¥è¯¢å˜æ…¢**

```
æ­£å¸¸æƒ…å†µï¼šæŸ¥è¯¢å•†å“ â†’ 50msè¿”å› âœ…

æ•°æ®åº“æ…¢äº†ï¼š
è¯·æ±‚1ï¼šæŸ¥è¯¢å•†å“ â†’ 2ç§’è¿”å› ğŸ˜°
è¯·æ±‚2ï¼šæŸ¥è¯¢å•†å“ â†’ 2ç§’è¿”å› ğŸ˜°
è¯·æ±‚3ï¼šæŸ¥è¯¢å•†å“ â†’ 2ç§’è¿”å› ğŸ˜°
...
çº¿ç¨‹æ± è¢«å æ»¡ ğŸ’¥

å¯ç”¨æ…¢è°ƒç”¨ç†”æ–­ï¼š
è¯·æ±‚1ï¼šæŸ¥è¯¢å•†å“ â†’ 2ç§’è¿”å› ğŸ˜°
è¯·æ±‚2ï¼šæŸ¥è¯¢å•†å“ â†’ 2ç§’è¿”å› ğŸ˜°
è¯·æ±‚3ï¼šè§¦å‘ç†”æ–­ â†’ ç«‹å³è¿”å› âš¡ï¼ˆä¸å†ç­‰å¾…ï¼‰
è¯·æ±‚4-100ï¼šå…¨éƒ¨å¿«é€Ÿå¤±è´¥ âš¡
...
ç­‰5ç§’åå°è¯•æ¢å¤
```

**é…ç½®æ…¢è°ƒç”¨ç†”æ–­ï¼š**
```java
DegradeRule rule = new DegradeRule();
rule.setResource("dubbo:provider:com.example.ProductService:getProductDetail");

// æ…¢è°ƒç”¨æ¯”ä¾‹æ¨¡å¼
rule.setGrade(RuleConstant.DEGRADE_GRADE_RT);
// å“åº”æ—¶é—´è¶…è¿‡1ç§’ç®—æ…¢è°ƒç”¨
rule.setCount(1000);
// æ…¢è°ƒç”¨æ¯”ä¾‹è¶…è¿‡50%è§¦å‘ç†”æ–­
rule.setSlowRatioThreshold(0.5);
// ç»Ÿè®¡æ—¶é•¿1ç§’
rule.setStatIntervalMs(1000);
// æœ€å°‘5ä¸ªè¯·æ±‚æ‰ç»Ÿè®¡
rule.setMinRequestAmount(5);

DegradeRuleManager.loadRules(Collections.singletonList(rule));
```

### 3.4 å¼‚å¸¸æ¯”ä¾‹ç†”æ–­


**åœºæ™¯ï¼šä¾èµ–æœåŠ¡å¼‚å¸¸**

å‡è®¾å•†å“æœåŠ¡ä¾èµ–åº“å­˜æœåŠ¡ï¼Œåº“å­˜æœåŠ¡ä¸ç¨³å®šï¼š

```
åº“å­˜æœåŠ¡æ­£å¸¸ï¼š
å•†å“æœåŠ¡ â”€æŸ¥åº“å­˜â”€> åº“å­˜æœåŠ¡ âœ… è¿”å›åº“å­˜æ•°
      â†“
  æ˜¾ç¤ºå•†å“ä¿¡æ¯

åº“å­˜æœåŠ¡å¼‚å¸¸ï¼ˆæœªç†”æ–­ï¼‰ï¼š
å•†å“æœåŠ¡ â”€æŸ¥åº“å­˜â”€> åº“å­˜æœåŠ¡ âŒ è¶…æ—¶/å¼‚å¸¸
      â†“
  æ¯æ¬¡éƒ½ç­‰å¾…è¶…æ—¶
      â†“
  èµ„æºè€—å°½ ğŸ’¥

åº“å­˜æœåŠ¡å¼‚å¸¸ï¼ˆå·²ç†”æ–­ï¼‰ï¼š
ç¬¬1-5æ¬¡ï¼šå°è¯•è°ƒç”¨ âŒ
ç¬¬6æ¬¡ï¼šæ£€æµ‹åˆ°å¼‚å¸¸æ¯”ä¾‹é«˜ â†’ è§¦å‘ç†”æ–­
ç¬¬7-Næ¬¡ï¼šç«‹å³è¿”å›é»˜è®¤å€¼ âš¡ï¼ˆæ˜¾ç¤º"åº“å­˜ä¸è¶³"ï¼‰
```

**é…ç½®å¼‚å¸¸æ¯”ä¾‹ç†”æ–­ï¼š**
```java
DegradeRule rule = new DegradeRule();
rule.setResource("dubbo:consumer:com.example.InventoryService:getStock");

// å¼‚å¸¸æ¯”ä¾‹æ¨¡å¼
rule.setGrade(RuleConstant.DEGRADE_GRADE_EXCEPTION_RATIO);
// å¼‚å¸¸æ¯”ä¾‹è¶…è¿‡30%è§¦å‘ç†”æ–­  
rule.setCount(0.3);
// ç†”æ–­æ—¶é•¿10ç§’
rule.setTimeWindow(10);
// æœ€å°‘10ä¸ªè¯·æ±‚æ‰ç»Ÿè®¡
rule.setMinRequestAmount(10);

DegradeRuleManager.loadRules(Collections.singletonList(rule));
```

---

## 4. ğŸ”° å®¢æˆ·ç«¯ä¿æŠ¤ç­–ç•¥


### 4.1 å®¢æˆ·ç«¯ä¿æŠ¤çš„å¿…è¦æ€§


**ğŸ”¸ ä¸ºä»€ä¹ˆè°ƒç”¨æ–¹ä¹Ÿè¦ä¿æŠ¤**

å¾ˆå¤šæ–°æ‰‹ä¼šç–‘æƒ‘ï¼šæœåŠ¡ç«¯éƒ½ä¿æŠ¤äº†ï¼Œå®¢æˆ·ç«¯è¿˜è¦ä¿æŠ¤å—ï¼Ÿ

```
åœºæ™¯ï¼šè®¢å•æœåŠ¡è°ƒç”¨æ”¯ä»˜æœåŠ¡

åªæœ‰æœåŠ¡ç«¯ä¿æŠ¤ï¼š
è®¢å•æœåŠ¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€> æ”¯ä»˜æœåŠ¡ï¼ˆé™æµ1000QPSï¼‰
 ğŸ˜° å¯èƒ½å‘èµ·      âœ… æœ€å¤šå¤„ç†1000
   5000æ¬¡è°ƒç”¨         
    â†“
è®¢å•æœåŠ¡çº¿ç¨‹æ± è¢«å æ»¡
è®¢å•æœåŠ¡ä¹ŸæŒ‚äº† ğŸ’¥

å®¢æˆ·ç«¯+æœåŠ¡ç«¯ä¿æŠ¤ï¼š
è®¢å•æœåŠ¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€> æ”¯ä»˜æœåŠ¡
 âœ… å®¢æˆ·ç«¯é™æµ      âœ… æœåŠ¡ç«¯é™æµ
    åªå‘1000æ¬¡         å¤„ç†1000æ¬¡
    â†“
åŒé‡ä¿æŠ¤ï¼Œä¸¤è¾¹éƒ½å®‰å…¨
```

### 4.2 å®¢æˆ·ç«¯é™æµé…ç½®


**ç›®çš„ï¼šé™åˆ¶è‡ªå·±å¯¹å¤–çš„è°ƒç”¨é¢‘ç‡**

```java
// é™åˆ¶è°ƒç”¨æ”¯ä»˜æœåŠ¡çš„é¢‘ç‡
FlowRule consumerRule = new FlowRule();

// æ³¨æ„ï¼šå®¢æˆ·ç«¯èµ„æºåå‰ç¼€æ˜¯ dubbo:consumer
consumerRule.setResource("dubbo:consumer:com.example.PaymentService:pay");

// æ¯ç§’æœ€å¤šè°ƒç”¨800æ¬¡
consumerRule.setCount(800);
consumerRule.setGrade(RuleConstant.FLOW_GRADE_QPS);

FlowRuleManager.loadRules(Collections.singletonList(consumerRule));
```

**æ•ˆæœï¼š**
```
å½“å‰QPSï¼š750  âœ… æ­£å¸¸è°ƒç”¨æ”¯ä»˜æœåŠ¡
å½“å‰QPSï¼š800  âœ… è¾¾åˆ°ä¸Šé™ï¼Œä»æ­£å¸¸
å½“å‰QPSï¼š801  âŒ è¶…å‡ºé™åˆ¶ï¼Œéƒ¨åˆ†è°ƒç”¨è¢«æ‹’ç»

å¥½å¤„ï¼š
1. ä¿æŠ¤è‡ªå·±çš„çº¿ç¨‹æ± ä¸è¢«è€—å°½
2. é¿å…ç»™ä¸‹æ¸¸æœåŠ¡è¿‡å¤§å‹åŠ›
3. é˜²æ­¢é›ªå´©æ•ˆåº”
```

### 4.3 å®¢æˆ·ç«¯ç†”æ–­é™çº§


**åœºæ™¯ï¼šä¸‹æ¸¸æœåŠ¡å“åº”æ…¢**

```java
// å¯¹æ…¢æœåŠ¡è¿›è¡Œç†”æ–­
DegradeRule consumerRule = new DegradeRule();
consumerRule.setResource("dubbo:consumer:com.example.PaymentService:pay");

// å“åº”æ—¶é—´è¶…è¿‡500msç®—æ…¢è°ƒç”¨
consumerRule.setGrade(RuleConstant.DEGRADE_GRADE_RT);
consumerRule.setCount(500);

// æ…¢è°ƒç”¨æ¯”ä¾‹è¶…è¿‡60%è§¦å‘ç†”æ–­
consumerRule.setSlowRatioThreshold(0.6);

// ç†”æ–­å5ç§’å†…éƒ½å¿«é€Ÿå¤±è´¥
consumerRule.setTimeWindow(5);

DegradeRuleManager.loadRules(Collections.singletonList(consumerRule));
```

**é…åˆé™çº§æ–¹æ³•ä½¿ç”¨ï¼š**
```java
@Service
public class OrderServiceImpl implements OrderService {
    
    @DubboReference
    private PaymentService paymentService;
    
    public OrderResult createOrder(OrderDTO order) {
        try {
            // è°ƒç”¨æ”¯ä»˜æœåŠ¡
            PaymentResult result = paymentService.pay(order.getAmount());
            return OrderResult.success(result);
            
        } catch (DubboException e) {
            // è¢«ç†”æ–­æˆ–è°ƒç”¨å¤±è´¥æ—¶çš„é™çº§å¤„ç†
            if (e.getCause() instanceof BlockException) {
                // ä½¿ç”¨é™çº§æ–¹æ¡ˆï¼šå…ˆåˆ›å»ºè®¢å•ï¼Œæ”¯ä»˜çŠ¶æ€ä¸ºå¾…æ”¯ä»˜
                return OrderResult.pending("æ”¯ä»˜æœåŠ¡ç¹å¿™ï¼Œè®¢å•å·²åˆ›å»ºï¼Œè¯·ç¨åæ”¯ä»˜");
            }
            throw e;
        }
    }
}
```

---

## 5. ğŸ¯ æ¥å£çº§æµé‡æ§åˆ¶


### 5.1 æ¥å£çº§æ§åˆ¶çš„å«ä¹‰


**ğŸ”¸ ç†è§£"æ¥å£çº§"**

åœ¨Dubboä¸­ï¼Œæ¥å£çº§æ§åˆ¶æŒ‡çš„æ˜¯å¯¹**æ•´ä¸ªDubboæ¥å£**çš„æ‰€æœ‰æ–¹æ³•è¿›è¡Œç»Ÿä¸€æ§åˆ¶ï¼š

```
ç”¨æˆ·æœåŠ¡æ¥å£ï¼š
com.example.UserService
  â”œâ”€ getUserById(Long id)
  â”œâ”€ getUserList(QueryDTO query)  
  â”œâ”€ updateUser(UserDTO user)
  â””â”€ deleteUser(Long id)

æ¥å£çº§é™æµï¼š
- å¯¹æ•´ä¸ªUserServiceæ¥å£é™æµ
- æ‰€æœ‰æ–¹æ³•å…±äº«é™æµé…é¢
- é€‚åˆæ•´ä½“ä¿æŠ¤åœºæ™¯
```

### 5.2 æ¥å£çº§é™æµé…ç½®


**é…ç½®æ–¹å¼ï¼š**
```java
FlowRule interfaceRule = new FlowRule();

// åªæŒ‡å®šåˆ°æ¥å£ï¼Œä¸æŒ‡å®šæ–¹æ³•
interfaceRule.setResource("dubbo:provider:com.example.UserService");

// æ•´ä¸ªæ¥å£QPSé™åˆ¶2000
interfaceRule.setCount(2000);
interfaceRule.setGrade(RuleConstant.FLOW_GRADE_QPS);

FlowRuleManager.loadRules(Collections.singletonList(interfaceRule));
```

**å®é™…æ•ˆæœï¼š**
```
åœºæ™¯ï¼šUserServiceçš„QPSé™åˆ¶2000

æƒ…å†µ1ï¼š
getUserById: 800 QPS  
getUserList: 700 QPS   âœ… æ€»è®¡1500ï¼Œæœªè¶…é™
updateUser: 300 QPS    
deleteUser: 200 QPS    

æƒ…å†µ2ï¼š  
getUserById: 1200 QPS
getUserList: 900 QPS   âŒ æ€»è®¡2100ï¼Œè¶…å‡ºé™åˆ¶
updateUser: 0 QPS      éƒ¨åˆ†è¯·æ±‚è¢«æ‹’ç»
deleteUser: 0 QPS
```

### 5.3 æ¥å£çº§ä¸æ–¹æ³•çº§çš„å¯¹æ¯”


| ç»´åº¦ | **æ¥å£çº§æ§åˆ¶** | **æ–¹æ³•çº§æ§åˆ¶** |
|-----|--------------|--------------|
| **ç²’åº¦** | ç²—ç²’åº¦ï¼Œæ§åˆ¶æ•´ä¸ªæ¥å£ | ç»†ç²’åº¦ï¼Œæ§åˆ¶å•ä¸ªæ–¹æ³• |
| **é…ç½®** | ç®€å•ï¼Œä¸€æ¡è§„åˆ™ | å¤æ‚ï¼Œæ¯ä¸ªæ–¹æ³•ä¸€æ¡è§„åˆ™ |
| **é€‚ç”¨åœºæ™¯** | æœåŠ¡æ•´ä½“ä¿æŠ¤ | é‡ç‚¹æ–¹æ³•ä¿æŠ¤ |
| **èµ„æºæ¶ˆè€—** | ä½ï¼Œè§„åˆ™å°‘ | é«˜ï¼Œè§„åˆ™å¤š |
| **çµæ´»æ€§** | ä½ï¼Œæ— æ³•åŒºåˆ†æ–¹æ³• | é«˜ï¼Œå¯é’ˆå¯¹æ€§è°ƒæ•´ |

**é€‰æ‹©å»ºè®®ï¼š**
```
ä½¿ç”¨æ¥å£çº§æ§åˆ¶ï¼š
âœ… æœåŠ¡åˆšä¸Šçº¿ï¼Œæ‘¸åº•æ•´ä½“å®¹é‡
âœ… å„æ–¹æ³•è°ƒç”¨æ¯”è¾ƒå‡åŒ€
âœ… å¸Œæœ›ç®€åŒ–é…ç½®ç®¡ç†

ä½¿ç”¨æ–¹æ³•çº§æ§åˆ¶ï¼š  
âœ… æŸäº›æ–¹æ³•æ˜¯çƒ­ç‚¹ï¼ˆå¦‚æŸ¥è¯¢ï¼‰
âœ… æŸäº›æ–¹æ³•èµ„æºæ¶ˆè€—å¤§ï¼ˆå¦‚å¯¼å‡ºï¼‰
âœ… éœ€è¦ç²¾ç»†åŒ–æµé‡ç®¡ç†
```

---

## 6. ğŸ”¬ æ–¹æ³•çº§ç²¾ç»†æ§åˆ¶


### 6.1 ä¸ºä»€ä¹ˆéœ€è¦æ–¹æ³•çº§æ§åˆ¶


**åœºæ™¯å¯¹æ¯”ï¼šç”µå•†å•†å“æœåŠ¡**

```
å•†å“æœåŠ¡æ¥å£çš„ä¸åŒæ–¹æ³•ï¼š

getProductDetail(å•†å“è¯¦æƒ…)ï¼š
- è°ƒç”¨é¢‘ç‡ï¼šæé«˜ï¼ˆæ¯ç§’5000æ¬¡ï¼‰
- å“åº”æ—¶é—´ï¼šå¿«ï¼ˆ50msï¼‰
- èµ„æºæ¶ˆè€—ï¼šä½

exportAllProducts(å¯¼å‡ºå•†å“)ï¼š
- è°ƒç”¨é¢‘ç‡ï¼šä½ï¼ˆæ¯å°æ—¶å‡ æ¬¡ï¼‰
- å“åº”æ—¶é—´ï¼šæ…¢ï¼ˆ30ç§’ï¼‰
- èµ„æºæ¶ˆè€—ï¼šæé«˜ï¼ˆæŸ¥è¯¢æ‰€æœ‰æ•°æ®ï¼‰

å¦‚æœç”¨æ¥å£çº§é™æµï¼š
- é™åˆ¶å¤ªä¸¥æ ¼ï¼šæ­£å¸¸çš„å•†å“è¯¦æƒ…æŸ¥è¯¢ä¹Ÿå—å½±å“
- é™åˆ¶å¤ªå®½æ¾ï¼šå¯¼å‡ºæ“ä½œå¯èƒ½æ‹–å®æœåŠ¡
```

### 6.2 æ–¹æ³•çº§é™æµé…ç½®


**ğŸ”§ é’ˆå¯¹ä¸åŒæ–¹æ³•è®¾ç½®ä¸åŒè§„åˆ™**

```java
public void initMethodLevelRules() {
    List<FlowRule> rules = new ArrayList<>();
    
    // è§„åˆ™1ï¼šå•†å“è¯¦æƒ…æŸ¥è¯¢ - é«˜é¢‘ä½è€—
    FlowRule detailRule = new FlowRule();
    detailRule.setResource("dubbo:provider:com.example.ProductService:getProductDetail");
    detailRule.setCount(5000);  // å…è®¸5000 QPS
    detailRule.setGrade(RuleConstant.FLOW_GRADE_QPS);
    rules.add(detailRule);
    
    // è§„åˆ™2ï¼šå•†å“å¯¼å‡º - ä½é¢‘é«˜è€—  
    FlowRule exportRule = new FlowRule();
    exportRule.setResource("dubbo:provider:com.example.ProductService:exportAllProducts");
    exportRule.setCount(2);     // åªå…è®¸2 QPS
    exportRule.setGrade(RuleConstant.FLOW_GRADE_QPS);
    rules.add(exportRule);
    
    // è§„åˆ™3ï¼šå•†å“æ›´æ–° - ä¸­é¢‘ä¸­è€—
    FlowRule updateRule = new FlowRule();
    updateRule.setResource("dubbo:provider:com.example.ProductService:updateProduct");
    updateRule.setCount(500);   // å…è®¸500 QPS
    updateRule.setGrade(RuleConstant.FLOW_GRADE_QPS);
    rules.add(updateRule);
    
    FlowRuleManager.loadRules(rules);
}
```

### 6.3 æ–¹æ³•çº§ç†”æ–­é…ç½®


**é’ˆå¯¹æ…¢æ–¹æ³•çš„ç†”æ–­ä¿æŠ¤ï¼š**

```java
public void initMethodDegradeRules() {
    List<DegradeRule> rules = new ArrayList<>();
    
    // å¯¼å‡ºæ–¹æ³•çš„æ…¢è°ƒç”¨ç†”æ–­
    DegradeRule exportDegrade = new DegradeRule();
    exportDegrade.setResource("dubbo:provider:com.example.ProductService:exportAllProducts");
    
    // è¶…è¿‡30ç§’ç®—æ…¢è°ƒç”¨ï¼ˆå› ä¸ºè¿™ä¸ªæ–¹æ³•æœ¬èº«å°±æ…¢ï¼‰
    exportDegrade.setGrade(RuleConstant.DEGRADE_GRADE_RT);
    exportDegrade.setCount(30000);
    
    // æ…¢è°ƒç”¨æ¯”ä¾‹è¶…è¿‡80%è§¦å‘ç†”æ–­
    exportDegrade.setSlowRatioThreshold(0.8);
    exportDegrade.setMinRequestAmount(3);
    exportDegrade.setTimeWindow(60);  // ç†”æ–­60ç§’
    
    rules.add(exportDegrade);
    DegradeRuleManager.loadRules(rules);
}
```

### 6.4 æ–¹æ³•çº§æ§åˆ¶çš„æœ€ä½³å®è·µ


**ğŸ“‹ é…ç½®ç­–ç•¥è¡¨**

| æ–¹æ³•ç±»å‹ | QPSé™åˆ¶ | ç†”æ–­é˜ˆå€¼ | è¯´æ˜ |
|---------|---------|---------|------|
| **æŸ¥è¯¢æ–¹æ³•** | é«˜ï¼ˆ3000-5000ï¼‰ | 500ms | é«˜é¢‘å¿«é€Ÿå“åº” |
| **åˆ—è¡¨æ–¹æ³•** | ä¸­ï¼ˆ1000-2000ï¼‰ | 1000ms | ä¸­é¢‘ä¸­é€Ÿ |
| **æ›´æ–°æ–¹æ³•** | ä¸­ï¼ˆ500-1000ï¼‰ | 2000ms | æœ‰æ•°æ®åº“å†™æ“ä½œ |
| **å¯¼å‡ºæ–¹æ³•** | ä½ï¼ˆ1-5ï¼‰ | 30000ms | èµ„æºæ¶ˆè€—å¤§ |
| **æ‰¹é‡æ“ä½œ** | ä½ï¼ˆ5-10ï¼‰ | 10000ms | éœ€è¦æ§åˆ¶å¹¶å‘ |

**ğŸ¯ é…ç½®å»ºè®®ï¼š**

```
1. åˆ†ææ–¹æ³•ç‰¹å¾ï¼š
   - è°ƒç”¨é¢‘ç‡å¦‚ä½•ï¼Ÿ
   - å“åº”æ—¶é—´å¤šä¹…ï¼Ÿ
   - èµ„æºæ¶ˆè€—å¤šå¤§ï¼Ÿ

2. è®¾ç½®åˆç†é˜ˆå€¼ï¼š
   - åŸºäºå‹æµ‹æ•°æ®è®¾ç½®QPS
   - é¢„ç•™20%çš„å®‰å…¨ä½™é‡
   - è€ƒè™‘å³°å€¼å’Œå¹³æ—¶çš„å·®å¼‚

3. ç›‘æ§å’Œè°ƒæ•´ï¼š
   - è§‚å¯Ÿå®é™…æµé‡æ¨¡å¼
   - æ ¹æ®ç›‘æ§æ•°æ®ä¼˜åŒ–
   - å®šæœŸreviewè§„åˆ™åˆç†æ€§
```

---

## 7. ğŸš€ RPCè°ƒç”¨ä¿æŠ¤å®æˆ˜


### 7.1 å®Œæ•´çš„ä¿æŠ¤æ–¹æ¡ˆ


**ğŸ¯ å¤šå±‚é˜²æŠ¤æ¶æ„**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          å®¢æˆ·ç«¯ï¼ˆConsumerï¼‰             â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  1. å®¢æˆ·ç«¯é™æµ               â”‚       â”‚
â”‚  â”‚     æ§åˆ¶å‘å‡ºçš„è¯·æ±‚é‡          â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚              â†“                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  2. å®¢æˆ·ç«¯ç†”æ–­               â”‚       â”‚
â”‚  â”‚     å¿«é€Ÿå¤±è´¥ï¼Œé˜²æ­¢é›ªå´©        â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚              â†“                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ RPC è°ƒç”¨
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          æœåŠ¡ç«¯ï¼ˆProviderï¼‰              â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  3. æœåŠ¡ç«¯é™æµ               â”‚       â”‚
â”‚  â”‚     ä¿æŠ¤æœåŠ¡ä¸è¢«æ‰“å®          â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚              â†“                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  4. æœåŠ¡ç«¯ç†”æ–­               â”‚       â”‚
â”‚  â”‚     å¼‚å¸¸æ—¶å¿«é€Ÿå¤±è´¥            â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 å®æˆ˜æ¡ˆä¾‹ï¼šè®¢å•ç³»ç»Ÿä¿æŠ¤


**åœºæ™¯ï¼šè®¢å•æœåŠ¡è°ƒç”¨åº“å­˜æœåŠ¡**

```java
// ============ è®¢å•æœåŠ¡ï¼ˆConsumerç«¯ï¼‰============
@Service
public class OrderServiceImpl implements OrderService {
    
    @DubboReference
    private InventoryService inventoryService;
    
    @PostConstruct
    public void initConsumerProtection() {
        List<FlowRule> flowRules = new ArrayList<>();
        List<DegradeRule> degradeRules = new ArrayList<>();
        
        // å®¢æˆ·ç«¯é™æµï¼šæ§åˆ¶è°ƒç”¨åº“å­˜æœåŠ¡çš„é¢‘ç‡
        FlowRule consumerFlow = new FlowRule();
        consumerFlow.setResource("dubbo:consumer:com.example.InventoryService:deductStock");
        consumerFlow.setCount(1000);  // æ¯ç§’æœ€å¤šè°ƒç”¨1000æ¬¡
        flowRules.add(consumerFlow);
        
        // å®¢æˆ·ç«¯ç†”æ–­ï¼šåº“å­˜æœåŠ¡å“åº”æ…¢æ—¶å¿«é€Ÿå¤±è´¥
        DegradeRule consumerDegrade = new DegradeRule();
        consumerDegrade.setResource("dubbo:consumer:com.example.InventoryService:deductStock");
        consumerDegrade.setGrade(RuleConstant.DEGRADE_GRADE_RT);
        consumerDegrade.setCount(1000);  // è¶…è¿‡1ç§’ç®—æ…¢
        consumerDegrade.setSlowRatioThreshold(0.5);
        consumerDegrade.setTimeWindow(10);
        degradeRules.add(consumerDegrade);
        
        FlowRuleManager.loadRules(flowRules);
        DegradeRuleManager.loadRules(degradeRules);
    }
    
    public OrderResult createOrder(OrderDTO orderDTO) {
        try {
            // è°ƒç”¨åº“å­˜æœåŠ¡æ‰£å‡åº“å­˜
            boolean success = inventoryService.deductStock(
                orderDTO.getProductId(), 
                orderDTO.getQuantity()
            );
            
            if (success) {
                // åˆ›å»ºè®¢å•
                return OrderResult.success("è®¢å•åˆ›å»ºæˆåŠŸ");
            } else {
                return OrderResult.fail("åº“å­˜ä¸è¶³");
            }
            
        } catch (DubboException e) {
            // å¤„ç†é™çº§æƒ…å†µ
            if (e.getCause() instanceof BlockException) {
                // è¢«é™æµæˆ–ç†”æ–­ï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ
                return handleDegradeScenario(orderDTO);
            }
            throw e;
        }
    }
    
    // é™çº§å¤„ç†æ–¹æ³•
    private OrderResult handleDegradeScenario(OrderDTO orderDTO) {
        // æ–¹æ¡ˆ1ï¼šåˆ›å»ºé¢„è®¢å•ï¼Œå¼‚æ­¥æ‰£åº“å­˜
        // æ–¹æ¡ˆ2ï¼šä½¿ç”¨æœ¬åœ°ç¼“å­˜çš„åº“å­˜æ•°æ®
        // æ–¹æ¡ˆ3ï¼šè¿”å›å‹å¥½æç¤º
        return OrderResult.pending("ç³»ç»Ÿç¹å¿™ï¼Œè®¢å•å·²æäº¤ï¼Œç¨åå¤„ç†");
    }
}
```

```java
// ============ åº“å­˜æœåŠ¡ï¼ˆProviderç«¯ï¼‰============
@Service
public class InventoryServiceImpl implements InventoryService {
    
    @PostConstruct
    public void initProviderProtection() {
        List<FlowRule> flowRules = new ArrayList<>();
        List<DegradeRule> degradeRules = new ArrayList<>();
        
        // æœåŠ¡ç«¯é™æµï¼šä¿æŠ¤è‡ªå·±ä¸è¢«æ‰“å®
        FlowRule providerFlow = new FlowRule();
        providerFlow.setResource("dubbo:provider:com.example.InventoryService:deductStock");
        providerFlow.setCount(1500);  // æœåŠ¡ç«¯èƒ½åŠ›1500 QPS
        flowRules.add(providerFlow);
        
        // æœåŠ¡ç«¯ç†”æ–­ï¼šæ•°æ®åº“å¼‚å¸¸æ—¶å¿«é€Ÿå¤±è´¥
        DegradeRule providerDegrade = new DegradeRule();
        providerDegrade.setResource("dubbo:provider:com.example.InventoryService:deductStock");
        providerDegrade.setGrade(RuleConstant.DEGRADE_GRADE_EXCEPTION_RATIO);
        providerDegrade.setCount(0.3);  // å¼‚å¸¸è¶…è¿‡30%ç†”æ–­
        providerDegrade.setTimeWindow(20);
        degradeRules.add(providerDegrade);
        
        FlowRuleManager.loadRules(flowRules);
        DegradeRuleManager.loadRules(degradeRules);
    }
    
    @Override
    public boolean deductStock(Long productId, Integer quantity) {
        // å®é™…çš„åº“å­˜æ‰£å‡é€»è¾‘
        return inventoryMapper.deductStock(productId, quantity) > 0;
    }
}
```

### 7.3 è¿è¡Œæ•ˆæœåˆ†æ


**æ­£å¸¸æµé‡ï¼š**
```
è®¢å•æœåŠ¡å‘èµ·900æ¬¡/ç§’è°ƒç”¨
    â†“
âœ… å®¢æˆ·ç«¯é™æµï¼š1000/ç§’ï¼Œé€šè¿‡
    â†“  
âœ… æœåŠ¡ç«¯é™æµï¼š1500/ç§’ï¼Œé€šè¿‡
    â†“
âœ… æ­£å¸¸å¤„ç†ï¼Œæ‰£å‡åº“å­˜æˆåŠŸ
```

**å¼‚å¸¸æµé‡ï¼š**
```
åœºæ™¯1ï¼šè®¢å•æœåŠ¡å‘èµ·2000æ¬¡/ç§’è°ƒç”¨
    â†“
âŒ å®¢æˆ·ç«¯é™æµï¼šè¶…è¿‡1000/ç§’ï¼Œæ‹’ç»1000æ¬¡
    â†“
âœ… 1000æ¬¡åˆ°è¾¾æœåŠ¡ç«¯ï¼Œæ­£å¸¸å¤„ç†
ç»“æœï¼šè®¢å•æœåŠ¡çº¿ç¨‹æ± å®‰å…¨

åœºæ™¯2ï¼šåº“å­˜æœåŠ¡æ•°æ®åº“æ…¢æŸ¥è¯¢
    â†“
ğŸ˜° å“åº”æ—¶é—´ä»50msä¸Šå‡åˆ°2ç§’
    â†“  
âš¡ å®¢æˆ·ç«¯ç†”æ–­ï¼šæ£€æµ‹åˆ°æ…¢è°ƒç”¨ï¼Œè§¦å‘ç†”æ–­
    â†“
âš¡ åç»­è¯·æ±‚å¿«é€Ÿå¤±è´¥ï¼Œä¸å†ç­‰å¾…
ç»“æœï¼šè®¢å•æœåŠ¡ä¸å—å½±å“

åœºæ™¯3ï¼šåº“å­˜æœåŠ¡æ•°æ®åº“å¼‚å¸¸
    â†“
ğŸ˜° å¤§é‡è¯·æ±‚æŠ›å‡ºSQLException
    â†“
âš¡ æœåŠ¡ç«¯ç†”æ–­ï¼šå¼‚å¸¸ç‡è¶…30%ï¼Œè§¦å‘ç†”æ–­  
    â†“
âš¡ å¿«é€Ÿè¿”å›å¤±è´¥ï¼Œä¸å†æŸ¥è¯¢æ•°æ®åº“
ç»“æœï¼šæ•°æ®åº“å‹åŠ›é™ä½ï¼Œæœ‰æ—¶é—´æ¢å¤
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Dubbo Filterï¼šRPCè°ƒç”¨çš„æ‹¦æˆªå™¨ï¼ŒSentinelçš„åˆ‡å…¥ç‚¹
ğŸ”¸ åŒå‘ä¿æŠ¤ï¼šå®¢æˆ·ç«¯+æœåŠ¡ç«¯ï¼Œä¸¤ç«¯éƒ½è¦é…ç½®
ğŸ”¸ èµ„æºå‘½åï¼šdubbo:provider/consumer:æ¥å£:æ–¹æ³•
ğŸ”¸ æ¥å£çº§vsæ–¹æ³•çº§ï¼šç²—ç²’åº¦vsç»†ç²’åº¦çš„æ§åˆ¶é€‰æ‹©
ğŸ”¸ ç†”æ–­é™çº§ï¼šå¿«é€Ÿå¤±è´¥+é™çº§æ–¹æ¡ˆï¼Œä¿è¯ç³»ç»Ÿç¨³å®š
```

### 8.2 ä¿æŠ¤ç­–ç•¥é€‰æ‹©


**ğŸ”¹ ä»€ä¹ˆæ—¶å€™ç”¨ä»€ä¹ˆä¿æŠ¤**

| åœºæ™¯ | æ¨èç­–ç•¥ | åŸå›  |
|-----|---------|------|
| **é«˜é¢‘æŸ¥è¯¢æ¥å£** | æœåŠ¡ç«¯QPSé™æµ | ä¿æŠ¤æœåŠ¡ä¸è¢«æ‰“å® |
| **ä¾èµ–ä¸ç¨³å®šæœåŠ¡** | å®¢æˆ·ç«¯ç†”æ–­ | é˜²æ­¢è‡ªå·±è¢«æ‹–ç´¯ |
| **èµ„æºæ¶ˆè€—å¤§çš„æ–¹æ³•** | æ–¹æ³•çº§é™æµ | ç²¾ç»†æ§åˆ¶èµ„æºä½¿ç”¨ |
| **æ•´ä½“æœåŠ¡ä¿æŠ¤** | æ¥å£çº§é™æµ | ç®€å•æœ‰æ•ˆ |
| **æ•°æ®åº“æŸ¥è¯¢æ…¢** | æ…¢è°ƒç”¨ç†”æ–­ | é¿å…çº¿ç¨‹å †ç§¯ |
| **ç¬¬ä¸‰æ–¹APIè°ƒç”¨** | å®¢æˆ·ç«¯é™æµ+ç†”æ–­ | æ§åˆ¶è°ƒç”¨é¢‘ç‡å’Œå¿«é€Ÿå¤±è´¥ |

### 8.3 é…ç½®å»ºè®®


**ğŸ’¡ åˆ†é˜¶æ®µé…ç½®ç­–ç•¥**

```
ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€ä¿æŠ¤
âœ… æœåŠ¡ç«¯æ¥å£çº§é™æµï¼ˆåŸºäºå‹æµ‹æ•°æ®ï¼‰
âœ… å®¢æˆ·ç«¯å¼‚å¸¸ç†”æ–­ï¼ˆé˜²æ­¢é›ªå´©ï¼‰
ç›®æ ‡ï¼šä¿è¯æœåŠ¡åŸºæœ¬ç¨³å®š

ç¬¬äºŒé˜¶æ®µï¼šç²¾ç»†ä¼˜åŒ–  
âœ… çƒ­ç‚¹æ–¹æ³•å•ç‹¬é…ç½®é™æµ
âœ… æ…¢æ–¹æ³•é…ç½®RTç†”æ–­
âœ… å®¢æˆ·ç«¯é™æµé˜²æ­¢è¿‡è½½
ç›®æ ‡ï¼šæå‡ç³»ç»Ÿæ€§èƒ½

ç¬¬ä¸‰é˜¶æ®µï¼šé«˜çº§é˜²æŠ¤
âœ… æ ¹æ®ç›‘æ§æ•°æ®åŠ¨æ€è°ƒæ•´
âœ… é…ç½®é™çº§æ–¹æ¡ˆ
âœ… å»ºç«‹å®Œæ•´çš„å®¹é”™ä½“ç³»
ç›®æ ‡ï¼šè¾¾åˆ°ç”Ÿäº§çº§å¯ç”¨
```

### 8.4 å¸¸è§é—®é¢˜é¿å‘


**âŒ é”™è¯¯é…ç½®ç¤ºä¾‹ï¼š**

```java
// é”™è¯¯1ï¼šèµ„æºåå†™é”™
rule.setResource("ProductService:getDetail");  
// æ­£ç¡®ï¼šå¿…é¡»åŠ å‰ç¼€
rule.setResource("dubbo:provider:com.example.ProductService:getDetail");

// é”™è¯¯2ï¼šå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯é™æµå€¼ä¸€æ ·
consumerRule.setCount(1000);
providerRule.setCount(1000);
// æ­£ç¡®ï¼šå®¢æˆ·ç«¯åº”è¯¥å°äºæœåŠ¡ç«¯
consumerRule.setCount(800);   // å®¢æˆ·ç«¯é™800
providerRule.setCount(1000);  // æœåŠ¡ç«¯é™1000

// é”™è¯¯3ï¼šç†”æ–­é˜ˆå€¼è®¾ç½®ä¸åˆç†
degradeRule.setCount(100);  // RTé˜ˆå€¼100ms
// é—®é¢˜ï¼šæ­£å¸¸å“åº”å°±è¦200msï¼Œä¼šè¯¯è§¦å‘
// æ­£ç¡®ï¼šåŸºäºå®é™…RTè®¾ç½®ï¼ŒåŠ ä¸Šbuffer
degradeRule.setCount(500);  // å®é™…200msï¼Œè®¾ç½®500msé˜ˆå€¼
```

**âœ… æœ€ä½³å®è·µæ¸…å•ï¼š**

```
é…ç½®å‰ï¼š
â–¡ å‹æµ‹ç¡®å®šæœåŠ¡çœŸå®å®¹é‡
â–¡ åˆ†æå„æ–¹æ³•çš„è°ƒç”¨ç‰¹å¾
â–¡ è¯„ä¼°ä¾èµ–æœåŠ¡çš„ç¨³å®šæ€§

é…ç½®æ—¶ï¼š
â–¡ å®¢æˆ·ç«¯é™æµ < æœåŠ¡ç«¯é™æµ
â–¡ é¢„ç•™20-30%çš„å®‰å…¨ä½™é‡
â–¡ ç†”æ–­é˜ˆå€¼åŸºäºå®é™…ç›‘æ§æ•°æ®

é…ç½®åï¼š
â–¡ ç°åº¦éªŒè¯è§„åˆ™æ•ˆæœ
â–¡ ç›‘æ§é™æµ/ç†”æ–­æŒ‡æ ‡
â–¡ æ ¹æ®å®é™…è°ƒæ•´ä¼˜åŒ–
â–¡ å‡†å¤‡å¥½é™çº§é¢„æ¡ˆ
```

**æ ¸å¿ƒè®°å¿†ï¼š**
- Dubboé›†æˆSentinelå°±åƒç»™RPCè°ƒç”¨åŠ ä¿é™©
- Filteræ˜¯å·¥ä½œåŸç†ï¼ŒåŒå‘ä¿æŠ¤æ˜¯æ ¸å¿ƒæ€æƒ³
- æ¥å£çº§ç®€å•å¤Ÿç”¨ï¼Œæ–¹æ³•çº§ç²¾ç»†å¼ºå¤§
- é™æµä¿æŠ¤è‡ªå·±ï¼Œç†”æ–­é˜²æ­¢è¢«æ‹–ç´¯
- é…ç½®éœ€è¦åŸºäºæ•°æ®ï¼Œä¸èƒ½æ‹è„‘è¢‹å†³å®š