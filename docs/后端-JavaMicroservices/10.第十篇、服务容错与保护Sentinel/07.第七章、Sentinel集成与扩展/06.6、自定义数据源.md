---
title: 6ã€è‡ªå®šä¹‰æ•°æ®æº
---
## ğŸ“š ç›®å½•


1. [è‡ªå®šä¹‰æ•°æ®æºåŸºç¡€æ¦‚å¿µ](#1-è‡ªå®šä¹‰æ•°æ®æºåŸºç¡€æ¦‚å¿µ)
2. [DataSourceæ¥å£è¯¦è§£](#2-datasourceæ¥å£è¯¦è§£)
3. [è§„åˆ™è½¬æ¢æœºåˆ¶](#3-è§„åˆ™è½¬æ¢æœºåˆ¶)
4. [æ•°æ®æºé…ç½®æ–¹æ³•](#4-æ•°æ®æºé…ç½®æ–¹æ³•)
5. [æ‰©å±•å®ç°æ¡ˆä¾‹](#5-æ‰©å±•å®ç°æ¡ˆä¾‹)
6. [æœ€ä½³å®è·µæŒ‡å—](#6-æœ€ä½³å®è·µæŒ‡å—)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

# ğŸ¯ **å­¦ä¹ å¯¼èˆª**


**å‰ç½®çŸ¥è¯†**ï¼šéœ€è¦äº†è§£SentinelåŸºç¡€ã€é…ç½®ä¸­å¿ƒæ¦‚å¿µ â†’ **å½“å‰å†…å®¹**ï¼šè‡ªå®šä¹‰æ•°æ®æºé›†æˆ â†’ **åç»­å­¦ä¹ **ï¼šSentinelé«˜çº§ç‰¹æ€§

â±ï¸ **é¢„è®¡å­¦ä¹ æ—¶é—´**ï¼šæœ¬ç« é¢„è®¡45åˆ†é’Ÿ | å®è·µç»ƒä¹ 30åˆ†é’Ÿ

**ğŸ”– æœ¬ç« æ ‡ç­¾**ï¼š`#æ ¸å¿ƒæ¦‚å¿µ` `#å¿…æŒæ¡` `#å®æˆ˜åº”ç”¨`

---

## 1. ğŸ”Œ è‡ªå®šä¹‰æ•°æ®æºåŸºç¡€æ¦‚å¿µ



### 1.1 ä»€ä¹ˆæ˜¯Sentinelæ•°æ®æº



**ğŸ”¸ æ ¸å¿ƒå®šä¹‰**
```
æ•°æ®æº(DataSource)ï¼šSentinelè·å–å’Œæ›´æ–°è§„åˆ™é…ç½®çš„æ¥æº
ä½œç”¨ï¼šè®©è§„åˆ™é…ç½®å¯ä»¥åŠ¨æ€ä¿®æ”¹ï¼Œæ— éœ€é‡å¯åº”ç”¨
æœ¬è´¨ï¼šä¸€ä¸ªèƒ½ç›‘å¬é…ç½®å˜åŒ–å¹¶é€šçŸ¥Sentinelçš„æœºåˆ¶
```

**ğŸ’¡ é€šä¿—ç†è§£**
æƒ³è±¡ä½ åœ¨ç©æ¸¸æˆè°ƒæ•´éš¾åº¦è®¾ç½®ï¼š
- **ç¡¬ç¼–ç æ–¹å¼**ï¼šæ”¹ä»£ç â†’é‡å¯æ¸¸æˆâ†’ç”Ÿæ•ˆï¼ˆå¤ªéº»çƒ¦ï¼‰
- **é…ç½®æ–‡ä»¶**ï¼šæ”¹æ–‡ä»¶â†’é‡å¯æ¸¸æˆâ†’ç”Ÿæ•ˆï¼ˆè¿˜æ˜¯è¦é‡å¯ï¼‰
- **åŠ¨æ€æ•°æ®æº**ï¼šåœ¨çº¿è°ƒæ•´â†’å®æ—¶ç”Ÿæ•ˆï¼ˆè¿™å°±å¯¹äº†ï¼ï¼‰

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰æ•°æ®æº



**ğŸ¯ è§£å†³çš„é—®é¢˜**

| **åœºæ™¯** | **æ²¡æœ‰æ•°æ®æº** | **æœ‰äº†æ•°æ®æº** |
|---------|--------------|--------------|
| **ä¿®æ”¹é™æµè§„åˆ™** | æ”¹ä»£ç â†’å‘å¸ƒâ†’é‡å¯ | é…ç½®ä¸­å¿ƒæ”¹â†’ç§’çº§ç”Ÿæ•ˆ |
| **åº”æ€¥å¤„ç†** | ç­‰å¾…å‘ç‰ˆæµç¨‹ | ç«‹å³è°ƒæ•´è§„åˆ™ |
| **å¤šç¯å¢ƒç®¡ç†** | æ¯ä¸ªç¯å¢ƒæ‰‹åŠ¨é…ç½® | ç»Ÿä¸€é…ç½®ä¸­å¿ƒç®¡ç† |

**ğŸ” å®é™…åº”ç”¨ä»·å€¼**
```
è¿ç»´åœºæ™¯ï¼š
å‡Œæ™¨2ç‚¹ç³»ç»Ÿè¢«åˆ·ï¼Œéœ€è¦ç´§æ€¥é™æµ
â†’ æœ‰æ•°æ®æºï¼šé…ç½®ä¸­å¿ƒæ”¹ä¸ªå€¼ï¼Œ1ç§’ç”Ÿæ•ˆ âœ…
â†’ æ²¡æ•°æ®æºï¼šæ”¹ä»£ç ã€æ‰“åŒ…ã€å‘å¸ƒã€é‡å¯ï¼Œè‡³å°‘30åˆ†é’Ÿ âŒ

ä¸šåŠ¡åœºæ™¯ï¼š
å¤§ä¿ƒæ´»åŠ¨éœ€è¦åŠ¨æ€è°ƒæ•´æµæ§é˜ˆå€¼
â†’ æ ¹æ®å®æ—¶æµé‡åœ¨é…ç½®ä¸­å¿ƒè°ƒæ•´
â†’ æ— éœ€é‡å¯ä»»ä½•æœåŠ¡
```

### 1.3 Sentinelæ•°æ®æºå·¥ä½œåŸç†



**ğŸ”„ æ•°æ®æµè½¬è¿‡ç¨‹**
```
é…ç½®ä¸­å¿ƒå­˜å‚¨è§„åˆ™
      â†“ 
æ•°æ®æºç›‘å¬é…ç½®å˜åŒ–
      â†“
è§£æé…ç½®è½¬ä¸ºè§„åˆ™å¯¹è±¡
      â†“
æ¨é€ç»™Sentinelè§„åˆ™ç®¡ç†å™¨
      â†“
è§„åˆ™ç«‹å³ç”Ÿæ•ˆ
```

**ğŸ“Š æ•°æ®æºç±»å‹å¯¹æ¯”**

| **æ•°æ®æºç±»å‹** | **é€‚ç”¨åœºæ™¯** | **å®æ—¶æ€§** | **å®ç°éš¾åº¦** |
|--------------|------------|----------|------------|
| **æ–‡ä»¶æ•°æ®æº** | å¼€å‘æµ‹è¯•ç¯å¢ƒ | â­â­ | â­ |
| **Nacosæ•°æ®æº** | ç”Ÿäº§ç¯å¢ƒæ¨è | â­â­â­â­â­ | â­â­ |
| **Apolloæ•°æ®æº** | å·²æœ‰Apolloç¯å¢ƒ | â­â­â­â­ | â­â­ |
| **Redisæ•°æ®æº** | é«˜æ€§èƒ½è¦æ±‚ | â­â­â­â­â­ | â­â­â­ |
| **è‡ªå®šä¹‰æ•°æ®æº** | ç‰¹æ®Šéœ€æ±‚åœºæ™¯ | å¯å®šåˆ¶ | â­â­â­â­ |

---

## 2. ğŸ§© DataSourceæ¥å£è¯¦è§£



### 2.1 DataSourceæ ¸å¿ƒæ¥å£



**ğŸ“‹ æ¥å£å®šä¹‰è¯´æ˜**
```java
// Sentinelæä¾›çš„æ•°æ®æºæ¥å£
public interface ReadableDataSource<S, T> {
    
    // è¯»å–åŸå§‹é…ç½®æ•°æ®
    S readSource() throws Exception;
    
    // è·å–è½¬æ¢åçš„è§„åˆ™åˆ—è¡¨
    T getProperty();
    
    // å…³é—­æ•°æ®æº
    void close() throws Exception;
}
```

**ğŸ” æ¥å£å‚æ•°è§£é‡Š**
- **S (Source)**ï¼šåŸå§‹æ•°æ®ç±»å‹ï¼Œæ¯”å¦‚å­—ç¬¦ä¸²ã€JSON
- **T (Target)**ï¼šç›®æ ‡è§„åˆ™ç±»å‹ï¼Œæ¯”å¦‚FlowRuleæµæ§è§„åˆ™

**ğŸ’¡ ç†è§£æŠ€å·§**
æŠŠDataSourceæƒ³è±¡æˆ"ç¿»è¯‘å®˜"ï¼š
- ä»é…ç½®ä¸­å¿ƒè¯»å–"å¤–è¯­"ï¼ˆåŸå§‹é…ç½®ï¼‰
- ç¿»è¯‘æˆSentinelèƒ½æ‡‚çš„"ä¸­æ–‡"ï¼ˆè§„åˆ™å¯¹è±¡ï¼‰

### 2.2 æ•°æ®æºæ¥å£ç»§æ‰¿å…³ç³»



**ğŸŒ³ æ¥å£å®¶æ—æ ‘**
```
ReadableDataSource (åªè¯»æ•°æ®æº)
    â†“
AbstractDataSource (æŠ½è±¡å®ç°ï¼Œæä¾›é€šç”¨é€»è¾‘)
    â†“
å…·ä½“å®ç°ç±»:
â”œâ”€â”€ FileRefreshableDataSource (æ–‡ä»¶æ•°æ®æº)
â”œâ”€â”€ NacosDataSource (Nacosæ•°æ®æº)
â”œâ”€â”€ ApolloDataSource (Apolloæ•°æ®æº)
â””â”€â”€ ä½ çš„è‡ªå®šä¹‰å®ç°
```

### 2.3 AbstractDataSourceæŠ½è±¡ç±»



**ğŸ”§ æ ¸å¿ƒå®ç°é€»è¾‘**
```java
// Sentinelæä¾›çš„æŠ½è±¡æ•°æ®æºåŸºç±»ï¼ˆç®€åŒ–ç‰ˆï¼‰
public abstract class AbstractDataSource<S, T> 
    implements ReadableDataSource<S, T> {
    
    // é…ç½®è½¬æ¢å™¨ï¼ˆå°†åŸå§‹æ•°æ®è½¬ä¸ºè§„åˆ™ï¼‰
    private final Converter<S, T> parser;
    
    // è§„åˆ™å±æ€§ï¼ˆå­˜å‚¨è½¬æ¢åçš„è§„åˆ™ï¼‰
    private final SentinelProperty<T> property;
    
    // æ„é€ å‡½æ•°
    public AbstractDataSource(Converter<S, T> parser) {
        this.parser = parser;
        this.property = new DynamicSentinelProperty<>();
    }
    
    // åŠ è½½é…ç½®å¹¶æ›´æ–°è§„åˆ™
    public T loadConfig() throws Exception {
        // 1. è¯»å–åŸå§‹é…ç½®
        S rawConfig = readSource();
        
        // 2. è½¬æ¢ä¸ºè§„åˆ™å¯¹è±¡
        T rules = parser.convert(rawConfig);
        
        // 3. æ›´æ–°åˆ°Sentinel
        property.updateValue(rules);
        
        return rules;
    }
}
```

**ğŸ’­ ç†è§£è¦ç‚¹**
- `parser`ï¼šå°±åƒç¿»è¯‘å­—å…¸ï¼Œå®šä¹‰æ€ä¹ˆè½¬æ¢
- `property`ï¼šå°±åƒå…¬å‘Šæ¿ï¼Œè§„åˆ™æ›´æ–°ä¼šé€šçŸ¥æ‰€æœ‰ç›‘å¬è€…
- `loadConfig`ï¼šå®Œæ•´çš„åŠ è½½æµç¨‹ï¼Œè¯»å–â†’è½¬æ¢â†’é€šçŸ¥

---

## 3. ğŸ”„ è§„åˆ™è½¬æ¢æœºåˆ¶



### 3.1 Converterè½¬æ¢å™¨æ¥å£



**ğŸ“ è½¬æ¢å™¨å®šä¹‰**
```java
// é…ç½®è½¬æ¢å™¨æ¥å£
public interface Converter<S, T> {
    // å°†åŸå§‹æ•°æ®Sè½¬æ¢ä¸ºç›®æ ‡ç±»å‹T
    T convert(S source);
}
```

**ğŸ¯ è½¬æ¢å™¨çš„ä½œç”¨**
```
åŸå§‹JSONå­—ç¬¦ä¸²
      â†“ (Converterè½¬æ¢)
List<FlowRule>æµæ§è§„åˆ™å¯¹è±¡
      â†“
Sentinelç›´æ¥ä½¿ç”¨
```

### 3.2 JSONè½¬è§„åˆ™çš„è½¬æ¢ç¤ºä¾‹



**ğŸ”§ å®ç°JSONè½¬æ¢å™¨**
```java
// å°†JSONå­—ç¬¦ä¸²è½¬ä¸ºæµæ§è§„åˆ™åˆ—è¡¨
public class FlowRuleJsonConverter 
    implements Converter<String, List<FlowRule>> {
    
    @Override
    public List<FlowRule> convert(String source) {
        if (source == null || source.isEmpty()) {
            return new ArrayList<>();
        }
        
        try {
            // ä½¿ç”¨JSONå·¥å…·è§£æ
            return JSON.parseArray(source, FlowRule.class);
        } catch (Exception e) {
            // è½¬æ¢å¤±è´¥è¿”å›ç©ºåˆ—è¡¨
            return new ArrayList<>();
        }
    }
}
```

**ğŸ’¡ JSONé…ç½®ç¤ºä¾‹**
```json
[
    {
        "resource": "userService",
        "grade": 1,
        "count": 100,
        "limitApp": "default"
    },
    {
        "resource": "orderService", 
        "grade": 1,
        "count": 50
    }
]
```

### 3.3 è§„åˆ™å­—æ®µå«ä¹‰è¯´æ˜



**ğŸ“Š æµæ§è§„åˆ™å­—æ®µè§£é‡Š**

| **å­—æ®µ** | **å«ä¹‰** | **ç¤ºä¾‹å€¼** | **è¯´æ˜** |
|---------|---------|-----------|---------|
| `resource` | èµ„æºåç§° | "userService" | è¦ä¿æŠ¤çš„æ¥å£æˆ–æ–¹æ³• |
| `grade` | é™æµé˜ˆå€¼ç±»å‹ | 1 | 1=QPS, 0=å¹¶å‘çº¿ç¨‹æ•° |
| `count` | é™æµé˜ˆå€¼ | 100 | æ¯ç§’100æ¬¡æˆ–100ä¸ªçº¿ç¨‹ |
| `limitApp` | è°ƒç”¨æ¥æº | "default" | é™åˆ¶å“ªä¸ªåº”ç”¨è°ƒç”¨ |

**ğŸ” é˜ˆå€¼ç±»å‹è¯¦è§£**
- **QPSé™æµ**ï¼šæ¯ç§’è¯·æ±‚æ•°ä¸è¶…è¿‡countï¼ˆå¸¸ç”¨ï¼‰
- **çº¿ç¨‹æ•°é™æµ**ï¼šåŒæ—¶å¤„ç†çš„è¯·æ±‚ä¸è¶…è¿‡count

---

## 4. âš™ï¸ æ•°æ®æºé…ç½®æ–¹æ³•



### 4.1 é…ç½®æ–¹å¼å¯¹æ¯”



**ğŸ“‹ ä¸‰ç§é…ç½®æ–¹å¼**

| **é…ç½®æ–¹å¼** | **çµæ´»æ€§** | **æ¨èåœºæ™¯** | **ä¼˜ç¼ºç‚¹** |
|------------|----------|------------|----------|
| **ç¡¬ç¼–ç ** | â­ | æ¼”ç¤ºDemo | ç®€å•ä½†ä¸çµæ´» |
| **é…ç½®æ–‡ä»¶** | â­â­â­ | å¼€å‘ç¯å¢ƒ | éœ€é‡å¯ç”Ÿæ•ˆ |
| **é…ç½®ä¸­å¿ƒ** | â­â­â­â­â­ | ç”Ÿäº§ç¯å¢ƒ | åŠ¨æ€ç”Ÿæ•ˆï¼Œæ¨è |

### 4.2 åŸºäºNacosçš„é…ç½®ç¤ºä¾‹



**ğŸ”§ ä¾èµ–å¼•å…¥**
```xml
<!-- Sentinel Nacosæ•°æ®æº -->
<dependency>
    <groupId>com.alibaba.csp</groupId>
    <artifactId>sentinel-datasource-nacos</artifactId>
    <version>1.8.6</version>
</dependency>
```

**âš™ï¸ é…ç½®æ•°æ®æº**
```java
@Configuration
public class SentinelDataSourceConfig {
    
    @Value("${spring.cloud.nacos.server-addr}")
    private String nacosServer;
    
    @PostConstruct
    public void initDataSource() {
        // é…ç½®Nacosæ•°æ®æº
        String groupId = "DEFAULT_GROUP";
        String dataId = "sentinel-flow-rules";
        
        ReadableDataSource<String, List<FlowRule>> dataSource = 
            new NacosDataSource<>(
                nacosServer,        // Nacosåœ°å€
                groupId,            // é…ç½®åˆ†ç»„
                dataId,             // é…ç½®ID
                source -> JSON.parseArray(source, FlowRule.class) // è½¬æ¢å™¨
            );
        
        // æ³¨å†Œåˆ°Sentinel
        FlowRuleManager.register2Property(
            dataSource.getProperty()
        );
    }
}
```

**ğŸ“ Nacosé…ç½®å†…å®¹**
```yaml
# åœ¨Nacosé…ç½®ä¸­å¿ƒåˆ›å»ºé…ç½®

Data ID: sentinel-flow-rules
Group: DEFAULT_GROUP
é…ç½®æ ¼å¼: JSON
é…ç½®å†…å®¹:
[
    {
        "resource": "/api/user",
        "grade": 1,
        "count": 100
    }
]
```

### 4.3 é…ç½®ç”Ÿæ•ˆéªŒè¯



**âœ… éªŒè¯æ­¥éª¤**
```
1. åœ¨Nacosä¿®æ”¹é™æµé˜ˆå€¼ 100 â†’ 50
2. è§‚å¯Ÿåº”ç”¨æ—¥å¿—ï¼ˆæ— éœ€é‡å¯ï¼‰
3. æµ‹è¯•æ¥å£é™æµæ•ˆæœ
4. ç¡®è®¤æ–°è§„åˆ™å·²ç”Ÿæ•ˆ
```

---

## 5. ğŸ› ï¸ æ‰©å±•å®ç°æ¡ˆä¾‹



### 5.1 å®ç°è‡ªå®šä¹‰Redisæ•°æ®æº



**ğŸ¯ éœ€æ±‚åœºæ™¯**
- å…¬å¸å·²æœ‰Redisé…ç½®ä¸­å¿ƒ
- éœ€è¦äºšç§’çº§è§„åˆ™æ›´æ–°
- æ”¯æŒè§„åˆ™ç‰ˆæœ¬ç®¡ç†

**ğŸ”§ å®ç°æ­¥éª¤**

**Step 1: å®šä¹‰æ•°æ®æºç±»**
```java
public class RedisDataSource<T> extends AbstractDataSource<String, T> {
    
    private RedisTemplate<String, String> redisTemplate;
    private String ruleKey;  // Redisä¸­çš„è§„åˆ™key
    
    public RedisDataSource(
        RedisTemplate<String, String> redisTemplate,
        String ruleKey,
        Converter<String, T> converter) {
        
        super(converter);
        this.redisTemplate = redisTemplate;
        this.ruleKey = ruleKey;
        
        // å¯åŠ¨ç›‘å¬çº¿ç¨‹
        startListener();
    }
    
    @Override
    public String readSource() throws Exception {
        // ä»Redisè¯»å–è§„åˆ™é…ç½®
        return redisTemplate.opsForValue().get(ruleKey);
    }
    
    // ç›‘å¬Redisé…ç½®å˜åŒ–
    private void startListener() {
        new Thread(() -> {
            while (true) {
                try {
                    // åŠ è½½æœ€æ–°é…ç½®
                    loadConfig();
                    Thread.sleep(3000); // 3ç§’è½®è¯¢ä¸€æ¬¡
                } catch (Exception e) {
                    // è®°å½•å¼‚å¸¸
                }
            }
        }).start();
    }
}
```

**ğŸ’¡ å®ç°è¦ç‚¹è¯´æ˜**
- `readSource()`ï¼šä»Redisè¯»å–åŸå§‹JSONå­—ç¬¦ä¸²
- `startListener()`ï¼šå®šæ—¶æ£€æŸ¥é…ç½®å˜åŒ–ï¼ˆç®€åŒ–ç‰ˆï¼Œç”Ÿäº§å¯ç”¨Rediså‘å¸ƒè®¢é˜…ï¼‰
- `loadConfig()`ï¼šçˆ¶ç±»æ–¹æ³•ï¼Œè‡ªåŠ¨å®Œæˆè½¬æ¢å’Œæ›´æ–°

**Step 2: ä½¿ç”¨è‡ªå®šä¹‰æ•°æ®æº**
```java
@Configuration
public class RedisDataSourceConfig {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    @PostConstruct
    public void init() {
        // åˆ›å»ºè½¬æ¢å™¨
        Converter<String, List<FlowRule>> converter = 
            source -> JSON.parseArray(source, FlowRule.class);
        
        // åˆ›å»ºRedisæ•°æ®æº
        RedisDataSource<List<FlowRule>> dataSource = 
            new RedisDataSource<>(
                redisTemplate,
                "sentinel:flow:rules",  // Redis key
                converter
            );
        
        // æ³¨å†Œåˆ°Sentinel
        FlowRuleManager.register2Property(
            dataSource.getProperty()
        );
    }
}
```

### 5.2 å®ç°æ•°æ®åº“æ•°æ®æº



**ğŸ¯ é€‚ç”¨åœºæ™¯**
- è§„åˆ™éœ€è¦å®¡è®¡è®°å½•
- å¤æ‚çš„è§„åˆ™ç®¡ç†éœ€æ±‚
- å·²æœ‰è§„åˆ™ç®¡ç†ç³»ç»Ÿ

**ğŸ”§ æ ¸å¿ƒå®ç°**
```java
public class DatabaseDataSource extends AbstractDataSource<String, List<FlowRule>> {
    
    private JdbcTemplate jdbcTemplate;
    
    public DatabaseDataSource(JdbcTemplate jdbcTemplate) {
        super(source -> JSON.parseArray(source, FlowRule.class));
        this.jdbcTemplate = jdbcTemplate;
        startScheduledRefresh();  // å®šæ—¶åˆ·æ–°
    }
    
    @Override
    public String readSource() throws Exception {
        // ä»æ•°æ®åº“æŸ¥è¯¢è§„åˆ™
        String sql = "SELECT rule_content FROM sentinel_rules WHERE app_name = ? AND enabled = 1";
        List<String> rules = jdbcTemplate.queryForList(
            sql, String.class, "my-service"
        );
        
        // åˆå¹¶å¤šæ¡è§„åˆ™
        return rules.isEmpty() ? "[]" : rules.get(0);
    }
    
    private void startScheduledRefresh() {
        ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(1);
        scheduler.scheduleAtFixedRate(() -> {
            try {
                loadConfig();
            } catch (Exception e) {
                // å¤„ç†å¼‚å¸¸
            }
        }, 0, 10, TimeUnit.SECONDS);  // æ¯10ç§’åˆ·æ–°
    }
}
```

---

## 6. ğŸ“š æœ€ä½³å®è·µæŒ‡å—



### 6.1 æ•°æ®æºé€‰å‹å»ºè®®



**ğŸ¯ é€‰å‹å†³ç­–æ ‘**
```
é¡¹ç›®è§„æ¨¡å°ï¼Ÿ
  â”œâ”€ æ˜¯ â†’ æ–‡ä»¶æ•°æ®æºï¼ˆå¼€å‘æµ‹è¯•è¶³å¤Ÿï¼‰
  â””â”€ å¦ â†’ ç»§ç»­åˆ¤æ–­
           â†“
å·²ä½¿ç”¨é…ç½®ä¸­å¿ƒï¼Ÿ
  â”œâ”€ æ˜¯ â†’ å¯¹åº”æ•°æ®æºï¼ˆNacos/Apollo/Consulç­‰ï¼‰
  â””â”€ å¦ â†’ ç»§ç»­åˆ¤æ–­
           â†“
æ€§èƒ½è¦æ±‚æé«˜ï¼Ÿ
  â”œâ”€ æ˜¯ â†’ Redisæ•°æ®æºï¼ˆäºšç§’çº§æ›´æ–°ï¼‰
  â””â”€ å¦ â†’ æ•°æ®åº“æ•°æ®æºï¼ˆä¾¿äºç®¡ç†å®¡è®¡ï¼‰
```

### 6.2 é…ç½®è§„èŒƒå»ºè®®



**ğŸ“‹ è§„åˆ™é…ç½®è§„èŒƒ**
```json
// âœ… æ¨èï¼šå­—æ®µå®Œæ•´ï¼Œå«ä¹‰æ¸…æ™°
{
    "resource": "/api/order/create",
    "grade": 1,
    "count": 100,
    "limitApp": "mobile-app",
    "strategy": 0,
    "controlBehavior": 0,
    "clusterMode": false
}

// âŒ ä¸æ¨èï¼šå­—æ®µç¼ºå¤±ï¼Œå®¹æ˜“å‡ºé”™
{
    "resource": "/api/order/create",
    "count": 100
}
```

**âš ï¸ é…ç½®æ³¨æ„äº‹é¡¹**
- **æµ‹è¯•éªŒè¯**ï¼šè§„åˆ™ä¸Šçº¿å‰å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯
- **ç°åº¦å‘å¸ƒ**ï¼šé‡è¦è§„åˆ™åˆ†æ‰¹æ¬¡å‘å¸ƒ
- **å›æ»šå‡†å¤‡**ï¼šä¿ç•™ä¸Šä¸€ç‰ˆæœ¬é…ç½®ä¾¿äºå›æ»š
- **ç›‘æ§å‘Šè­¦**ï¼šé…ç½®å˜æ›´è¦æœ‰æ“ä½œæ—¥å¿—å’Œé€šçŸ¥

### 6.3 é”™è¯¯å¤„ç†ç­–ç•¥



**ğŸ›¡ï¸ å¼‚å¸¸å¤„ç†æœ€ä½³å®è·µ**
```java
public class SafeDataSource<T> extends AbstractDataSource<String, T> {
    
    private T lastValidRules;  // ç¼“å­˜æœ€åæœ‰æ•ˆè§„åˆ™
    
    @Override
    public String readSource() throws Exception {
        try {
            String config = actualReadSource();  // å®é™…è¯»å–é€»è¾‘
            
            // éªŒè¯é…ç½®æœ‰æ•ˆæ€§
            if (isValidConfig(config)) {
                return config;
            } else {
                // é…ç½®æ— æ•ˆï¼Œä½¿ç”¨ç¼“å­˜
                return convertToString(lastValidRules);
            }
        } catch (Exception e) {
            // è¯»å–å¤±è´¥ï¼Œè¿”å›ç¼“å­˜è§„åˆ™
            log.warn("è¯»å–é…ç½®å¤±è´¥ï¼Œä½¿ç”¨ç¼“å­˜è§„åˆ™", e);
            return convertToString(lastValidRules);
        }
    }
    
    private boolean isValidConfig(String config) {
        // éªŒè¯JSONæ ¼å¼
        // éªŒè¯å¿…å¡«å­—æ®µ
        // éªŒè¯å€¼èŒƒå›´åˆç†æ€§
        return true;
    }
}
```

### 6.4 æ€§èƒ½ä¼˜åŒ–å»ºè®®



**âš¡ ä¼˜åŒ–è¦ç‚¹**

| **ä¼˜åŒ–é¡¹** | **æ–¹æ¡ˆ** | **æ”¶ç›Š** |
|----------|---------|---------|
| **å‡å°‘ç½‘ç»œè°ƒç”¨** | æœ¬åœ°ç¼“å­˜ + å®šæ—¶åˆ·æ–° | é™ä½å»¶è¿Ÿ |
| **æ‰¹é‡æ›´æ–°** | å¤šä¸ªè§„åˆ™ä¸€æ¬¡æ€§æ›´æ–° | å‡å°‘æ›´æ–°æ¬¡æ•° |
| **å¼‚æ­¥åŠ è½½** | å¯åŠ¨æ—¶å¼‚æ­¥åˆå§‹åŒ– | æå‡å¯åŠ¨é€Ÿåº¦ |
| **å¢é‡æ›´æ–°** | åªæ›´æ–°å˜åŒ–çš„è§„åˆ™ | é™ä½è®¡ç®—å¼€é”€ |

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“



### 7.1 å¿…é¡»ç†è§£çš„æ ¸å¿ƒæ¦‚å¿µ



```
ğŸ”¸ æ•°æ®æºæœ¬è´¨ï¼šç›‘å¬é…ç½®å˜åŒ–å¹¶é€šçŸ¥Sentinelçš„æœºåˆ¶
ğŸ”¸ æ¥å£è®¾è®¡ï¼šReadableDataSourceå®šä¹‰è¯»å–è§„åˆ™çš„æ ‡å‡†
ğŸ”¸ è½¬æ¢æœºåˆ¶ï¼šConverterè´Ÿè´£åŸå§‹é…ç½®åˆ°è§„åˆ™å¯¹è±¡çš„è½¬æ¢
ğŸ”¸ åŠ¨æ€æ›´æ–°ï¼šé…ç½®å˜åŒ–åæ— éœ€é‡å¯å³å¯ç”Ÿæ•ˆ
ğŸ”¸ æ‰©å±•æ–¹å¼ï¼šç»§æ‰¿AbstractDataSourceå®ç°è‡ªå®šä¹‰é€»è¾‘
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹



**ğŸ”¹ ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®æº**
```
é—®é¢˜ï¼šç¡¬ç¼–ç è§„åˆ™éœ€è¦é‡å¯åº”ç”¨æ‰èƒ½ç”Ÿæ•ˆ
è§£å†³ï¼šæ•°æ®æºè®©è§„åˆ™å¯ä»¥åŠ¨æ€åŠ è½½å’Œæ›´æ–°

ç±»æ¯”ï¼š
ç¡¬ç¼–ç  = å°åˆ·çš„çº¸è´¨ä¹¦ï¼ˆè¦æ”¹å†…å®¹å¾—é‡å°ï¼‰
æ•°æ®æº = ç”µå­ä¹¦ï¼ˆå†…å®¹éšæ—¶æ›´æ–°ï¼‰
```

**ğŸ”¹ æ•°æ®æºå·¥ä½œæµç¨‹**
```
1. æ•°æ®æºç›‘å¬é…ç½®ä¸­å¿ƒå˜åŒ–
2. æ£€æµ‹åˆ°å˜åŒ–åè¯»å–æ–°é…ç½®
3. é€šè¿‡Converterè½¬æ¢ä¸ºè§„åˆ™å¯¹è±¡
4. æ›´æ–°åˆ°Sentinelè§„åˆ™ç®¡ç†å™¨
5. æ–°è§„åˆ™ç«‹å³ç”Ÿæ•ˆï¼ˆæ— éœ€é‡å¯ï¼‰
```

**ğŸ”¹ è‡ªå®šä¹‰æ•°æ®æºè¦ç‚¹**
```
æ ¸å¿ƒæ­¥éª¤ï¼š
1. ç»§æ‰¿AbstractDataSourceæŠ½è±¡ç±»
2. å®ç°readSource()è¯»å–é…ç½®
3. æä¾›Converterè½¬æ¢å™¨
4. å®ç°é…ç½®å˜åŒ–ç›‘å¬æœºåˆ¶
5. æ³¨å†Œåˆ°Sentinelè§„åˆ™ç®¡ç†å™¨
```

### 7.3 å®æˆ˜åº”ç”¨æŒ‡å—



**ğŸ¯ å¼€å‘åœºæ™¯åº”ç”¨**
- **å¼€å‘æµ‹è¯•**ï¼šä½¿ç”¨æ–‡ä»¶æ•°æ®æºï¼Œé…ç½®ç®€å•
- **ç”Ÿäº§ç¯å¢ƒ**ï¼šæ¥å…¥Nacosç­‰é…ç½®ä¸­å¿ƒï¼ŒåŠ¨æ€ç®¡ç†
- **ç‰¹æ®Šéœ€æ±‚**ï¼šè‡ªå®šä¹‰æ•°æ®æºå¯¹æ¥å·²æœ‰ç³»ç»Ÿ

**ğŸ› ï¸ å®æ–½æ­¥éª¤**
```
ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©åˆé€‚çš„æ•°æ®æºç±»å‹
  â†’ è¯„ä¼°ï¼šæ€§èƒ½ã€å¯é æ€§ã€ç»´æŠ¤æˆæœ¬

ç¬¬äºŒæ­¥ï¼šç¼–å†™è½¬æ¢å™¨
  â†’ å®šä¹‰ï¼šå¦‚ä½•å°†é…ç½®è½¬ä¸ºè§„åˆ™å¯¹è±¡

ç¬¬ä¸‰æ­¥ï¼šé…ç½®æ•°æ®æº
  â†’ æ³¨å†Œï¼šå°†æ•°æ®æºæ³¨å†Œåˆ°è§„åˆ™ç®¡ç†å™¨

ç¬¬å››æ­¥ï¼šæµ‹è¯•éªŒè¯
  â†’ éªŒè¯ï¼šä¿®æ”¹é…ç½®æ˜¯å¦å®æ—¶ç”Ÿæ•ˆ
```

### 7.4 å­¦ä¹ æ£€æŸ¥æ¸…å•



- [ ] ç†è§£æ•°æ®æºçš„ä½œç”¨å’Œå·¥ä½œåŸç†
- [ ] æŒæ¡DataSourceæ¥å£çš„è®¾è®¡
- [ ] ä¼šç¼–å†™Converterè½¬æ¢å™¨
- [ ] èƒ½é…ç½®Nacosç­‰å¸¸è§æ•°æ®æº
- [ ] ç†è§£è‡ªå®šä¹‰æ•°æ®æºçš„å®ç°æ–¹å¼
- [ ] äº†è§£é…ç½®è§„èŒƒå’Œæœ€ä½³å®è·µ

**ğŸ”‘ æ ¸å¿ƒè®°å¿†å£è¯€**
> æ•°æ®æºåŠ¨æ€é…ï¼Œè§„åˆ™æ›´æ–°ä¸é‡å¯
> è½¬æ¢å™¨æ˜¯ç¿»è¯‘å®˜ï¼ŒJSONå˜æˆè§„åˆ™å¯¹è±¡
> ç»§æ‰¿æŠ½è±¡åŸºç±»å¥½ï¼Œç›‘å¬é…ç½®å®æ—¶æ•ˆ

**ğŸ’¡ è¿›é˜¶å­¦ä¹ å»ºè®®**
- ç ”ç©¶Sentinel-Dashboardæ§åˆ¶å°æ¨é€æœºåˆ¶
- å­¦ä¹ è§„åˆ™æŒä¹…åŒ–çš„å®Œæ•´æ–¹æ¡ˆ
- äº†è§£å¤šæ•°æ®æºçš„ä¼˜å…ˆçº§å’Œå†²çªå¤„ç†
- å®è·µç”Ÿäº§ç¯å¢ƒçš„è§„åˆ™ç®¡ç†æµç¨‹

**âš ï¸ å¸¸è§é—®é¢˜**
- **Q: æ•°æ®æºæ›´æ–°å¤±è´¥æ€ä¹ˆåŠï¼Ÿ**
  - A: åº”è¯¥ä¿ç•™ä¸Šä¸€æ¬¡æœ‰æ•ˆè§„åˆ™ä½œä¸ºå…œåº•ï¼Œé¿å…æ— è§„åˆ™ä¿æŠ¤
  
- **Q: å¤šä¸ªæ•°æ®æºå†²çªå¦‚ä½•å¤„ç†ï¼Ÿ**
  - A: æœ€åæ³¨å†Œçš„æ•°æ®æºä¼šè¦†ç›–ä¹‹å‰çš„ï¼Œå»ºè®®åªç”¨ä¸€ä¸ªæ•°æ®æº

- **Q: é…ç½®æ ¼å¼é”™è¯¯ä¼šå½±å“æœåŠ¡å—ï¼Ÿ**
  - A: å¥½çš„å®ç°ä¼šéªŒè¯é…ç½®ï¼Œæ— æ•ˆé…ç½®ä¸ä¼šæ›´æ–°è§„åˆ™