---
title: 8ã€çƒ­ç‚¹é™æµå®æˆ˜
---
## ğŸ“š ç›®å½•

1. [ä»€ä¹ˆæ˜¯çƒ­ç‚¹å‚æ•°é™æµ](#1-ä»€ä¹ˆæ˜¯çƒ­ç‚¹å‚æ•°é™æµ)
2. [æ ¸å¿ƒåº”ç”¨åœºæ™¯](#2-æ ¸å¿ƒåº”ç”¨åœºæ™¯)
3. [çƒ­ç‚¹é™æµé…ç½®å®æˆ˜](#3-çƒ­ç‚¹é™æµé…ç½®å®æˆ˜)
4. [å•†å“IDé™æµæ¡ˆä¾‹](#4-å•†å“IDé™æµæ¡ˆä¾‹)
5. [ç”¨æˆ·IDé™æµæ¡ˆä¾‹](#5-ç”¨æˆ·IDé™æµæ¡ˆä¾‹)
6. [IPåœ°å€é™æµæ¡ˆä¾‹](#6-IPåœ°å€é™æµæ¡ˆä¾‹)
7. [å‚æ•°æå–æŠ€å·§](#7-å‚æ•°æå–æŠ€å·§)
8. [ç”µå•†ç§’æ€ä¿æŠ¤æ–¹æ¡ˆ](#8-ç”µå•†ç§’æ€ä¿æŠ¤æ–¹æ¡ˆ)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ ä»€ä¹ˆæ˜¯çƒ­ç‚¹å‚æ•°é™æµ


### 1.1 é€šä¿—ç†è§£


**ç”Ÿæ´»ä¸­çš„ä¾‹å­**ï¼š
```
æƒ³è±¡ä¸€ä¸ªå¥¶èŒ¶åº—çš„åœºæ™¯ï¼š
- æ™®é€šå¥¶èŒ¶ï¼šæ¯åˆ†é’Ÿå¯ä»¥åš10æ¯
- ä½†æŸæ¬¾ç½‘çº¢å¥¶èŒ¶ï¼ˆæ¯”å¦‚"éœ¸æ°”èŠå£«è‘¡è„"ï¼‰ç‰¹åˆ«ç«çˆ†
- å¦‚æœä¸é™åˆ¶ï¼Œè¿™æ¬¾å¥¶èŒ¶ä¼šå æ»¡æ‰€æœ‰äº§èƒ½
- åº—å®¶å†³å®šï¼šç½‘çº¢å¥¶èŒ¶æ¯åˆ†é’Ÿæœ€å¤šåš5æ¯ï¼Œå…¶ä»–æ¬¾å¼ç…§å¸¸

è¿™å°±æ˜¯çƒ­ç‚¹é™æµçš„æ€æƒ³ï¼
```

**æŠ€æœ¯åœºæ™¯**ï¼š
```
ç”µå•†ç³»ç»Ÿä¸­ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¥å£ï¼šæŸ¥è¯¢å•†å“è¯¦æƒ…              â”‚
â”‚  /product/detail?id=xxx         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
    â”‚  ä¸åŒå•†å“  â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
          â†“
  æ™®é€šå•†å“ ID=1001  â†’ è®¿é—®é‡ï¼š100æ¬¡/ç§’  âœ… æ­£å¸¸
  æ™®é€šå•†å“ ID=1002  â†’ è®¿é—®é‡ï¼š150æ¬¡/ç§’  âœ… æ­£å¸¸
  çƒ­é—¨å•†å“ ID=9999  â†’ è®¿é—®é‡ï¼š10000æ¬¡/ç§’ âš ï¸ è¶…é«˜ï¼
  
çƒ­ç‚¹é™æµä½œç”¨ï¼š
â†’ å¯¹ ID=9999 å•ç‹¬é™åˆ¶åˆ° 1000æ¬¡/ç§’
â†’ å…¶ä»–å•†å“ä¸å—å½±å“
```

### 1.2 æ ¸å¿ƒæ¦‚å¿µ


**çƒ­ç‚¹å‚æ•°ï¼ˆHot Parameterï¼‰**ï¼š
- **å®šä¹‰**ï¼šè¯·æ±‚ä¸­æŸä¸ªå‚æ•°çš„ç‰¹å®šå€¼è¢«é¢‘ç¹è®¿é—®
- **ç‰¹å¾**ï¼š<mark>å°‘æ•°å‚æ•°å€¼å æ®äº†å¤§é‡æµé‡</mark>
- **ç¤ºä¾‹**ï¼šæŸä¸ªå•†å“IDã€æŸä¸ªç”¨æˆ·IDã€æŸä¸ªåŸå¸‚ä»£ç 

**ä¸ºä»€ä¹ˆéœ€è¦çƒ­ç‚¹é™æµ**ï¼š
```
é—®é¢˜åœºæ™¯ï¼š
æ¥å£é™æµ â†’ æ¯ç§’1000æ¬¡è¯·æ±‚
ä½†æ˜¯æŸä¸ªå•†å“å äº†900æ¬¡è¯·æ±‚ â†’ å…¶ä»–å•†å“åªå‰©100æ¬¡

çƒ­ç‚¹é™æµè§£å†³ï¼š
æ¥å£æ€»é™æµï¼š1000æ¬¡/ç§’
çƒ­é—¨å•†å“å•ç‹¬é™æµï¼š200æ¬¡/ç§’
â†’ ä¿è¯å…¶ä»–å•†å“æœ‰è¶³å¤Ÿèµ„æº
```

### 1.3 ä¸æ™®é€šé™æµçš„åŒºåˆ«


| å¯¹æ¯”ç»´åº¦ | **æ™®é€šé™æµ** | **çƒ­ç‚¹å‚æ•°é™æµ** |
|---------|------------|-----------------|
| ğŸ“Š **ç²’åº¦** | `æ¥å£çº§åˆ«` | `å‚æ•°å€¼çº§åˆ«` |
| ğŸ¯ **ç›®æ ‡** | `æ§åˆ¶æ¥å£æ€»æµé‡` | `æ§åˆ¶çƒ­ç‚¹å‚æ•°æµé‡` |
| ğŸ’¡ **åœºæ™¯** | `é˜²æ­¢æ¥å£è¢«æ‰“å®` | `é˜²æ­¢çƒ­ç‚¹æ•°æ®æ‰“å®ç³»ç»Ÿ` |
| ğŸ”§ **é…ç½®** | `ä¸€ä¸ªé˜ˆå€¼` | `å¯ä¸ºä¸åŒå‚æ•°å€¼è®¾ç½®ä¸åŒé˜ˆå€¼` |

**å®é™…æ•ˆæœå¯¹æ¯”**ï¼š
```
æ™®é€šé™æµï¼š
/product/detail æ¥å£ â†’ é™åˆ¶ 1000 QPS
æ‰€æœ‰å•†å“å…±äº«è¿™1000æ¬¡è¯·æ±‚

çƒ­ç‚¹é™æµï¼š
/product/detail æ¥å£ â†’ æ€»é™åˆ¶ 1000 QPS
  â”œâ”€ å•†å“ ID=9999 â†’ å•ç‹¬é™åˆ¶ 200 QPS
  â”œâ”€ å•†å“ ID=8888 â†’ å•ç‹¬é™åˆ¶ 150 QPS  
  â””â”€ å…¶ä»–å•†å“     â†’ å…±äº«å‰©ä½™ 650 QPS
```

---

## 2. ğŸš€ æ ¸å¿ƒåº”ç”¨åœºæ™¯


### 2.1 ç”µå•†ç³»ç»Ÿåœºæ™¯


**å•†å“è¯¦æƒ…é¡µçƒ­ç‚¹**ï¼š
```
åœºæ™¯ï¼šåŒåä¸€å¤§ä¿ƒ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  çƒ­é—¨å•†å“ï¼ˆiPhone 15ï¼‰    â”‚
â”‚  è®¿é—®é‡ï¼š50000 æ¬¡/ç§’      â”‚
â”‚  æ™®é€šå•†å“å¹³å‡ï¼š10 æ¬¡/ç§’   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¸é™æµçš„åæœï¼š
â†’ æ•°æ®åº“è¢«çƒ­ç‚¹å•†å“æŸ¥è¯¢æ‰“çˆ†
â†’ ç¼“å­˜é›ªå´©
â†’ æ•´ä¸ªå•†å“æœåŠ¡æŒ‚æ‰

çƒ­ç‚¹é™æµæ–¹æ¡ˆï¼š
â†’ iPhone 15 é™åˆ¶ 2000 QPS
â†’ è¶…å‡ºéƒ¨åˆ†è¿”å›é™çº§é¡µé¢
â†’ å…¶ä»–å•†å“æ­£å¸¸æœåŠ¡
```

**ç§’æ€æ´»åŠ¨ä¿æŠ¤**ï¼š
```
ç§’æ€å•†å“ ID=99999
æ­£å¸¸å•†å“å¹³å‡ï¼š100 QPS
ç§’æ€å•†å“ç¬æ—¶ï¼š100000 QPS

çƒ­ç‚¹é™æµç­–ç•¥ï¼š
ç§’æ€å•†å“ â†’ 5000 QPS
  â”œâ”€ é€šè¿‡çš„è¯·æ±‚ â†’ è¿›å…¥ç§’æ€é€»è¾‘
  â””â”€ è¶…é™è¯·æ±‚   â†’ å¿«é€Ÿå¤±è´¥è¿”å›"å•†å“å·²æŠ¢å…‰"
```

### 2.2 ç”¨æˆ·è¡Œä¸ºåœºæ™¯


**VIPç”¨æˆ·ä¿æŠ¤**ï¼š
```
åœºæ™¯ï¼šè§†é¢‘ç½‘ç«™
æ™®é€šç”¨æˆ·ï¼šæ¯ç§’ 1 ä¸ªè¯·æ±‚
æ¶æ„åˆ·é‡ç”¨æˆ·ï¼šæ¯ç§’ 1000 ä¸ªè¯·æ±‚

é™æµç­–ç•¥ï¼š
æ¯ä¸ªç”¨æˆ·ID â†’ é™åˆ¶ 10 QPS
â†’ æ­£å¸¸ç”¨æˆ·ä¸å—å½±å“
â†’ åˆ·é‡è¡Œä¸ºè¢«è‡ªåŠ¨æ‹¦æˆª
```

**çˆ¬è™«é˜²æŠ¤**ï¼š
```
åœºæ™¯ï¼šAPIæ¥å£è¢«çˆ¬è™«æ”»å‡»
æŸIPåœ°å€ â†’ 10000 æ¬¡/ç§’è¯·æ±‚

IPé™æµç­–ç•¥ï¼š
å•ä¸ªIP â†’ é™åˆ¶ 100 QPS
â†’ æ­£å¸¸ç”¨æˆ·ï¼šè¿œè¾¾ä¸åˆ°é™åˆ¶
â†’ çˆ¬è™«ï¼šè¢«å¿«é€Ÿæ‹¦æˆª
```

### 2.3 åœ°åŸŸæµé‡åœºæ™¯


**åŸå¸‚çƒ­ç‚¹é™æµ**ï¼š
```
åœºæ™¯ï¼šå¤©æ°”æŸ¥è¯¢æœåŠ¡
åŒ—äº¬ã€ä¸Šæµ·æŸ¥è¯¢é‡ï¼š10000 æ¬¡/ç§’
å°åŸå¸‚æŸ¥è¯¢é‡ï¼š10 æ¬¡/ç§’

é™æµç­–ç•¥ï¼š
çƒ­é—¨åŸå¸‚ â†’ 1000 QPS
å…¶ä»–åŸå¸‚ â†’ ä¸é™åˆ¶
â†’ ä¿è¯å°åŸå¸‚ç”¨æˆ·ä½“éªŒ
```

---

## 3. ğŸ”§ çƒ­ç‚¹é™æµé…ç½®å®æˆ˜


### 3.1 å¿«é€Ÿå…¥é—¨é…ç½®


**åŸºç¡€ä¾èµ–**ï¼š
```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>
</dependency>
```

**æœ€ç®€å•çš„çƒ­ç‚¹é™æµ**ï¼š
```java
@RestController
public class ProductController {
    
    // 1ï¸âƒ£ å®šä¹‰èµ„æºå¹¶æŒ‡å®šå‚æ•°ç´¢å¼•
    @GetMapping("/product/detail")
    @SentinelResource(value = "productDetail", blockHandler = "handleBlock")
    public String getProduct(@RequestParam("id") String productId) {
        // ä¸šåŠ¡é€»è¾‘
        return "å•†å“è¯¦æƒ…ï¼š" + productId;
    }
    
    // 2ï¸âƒ£ é™çº§å¤„ç†æ–¹æ³•
    public String handleBlock(String productId, BlockException ex) {
        return "å•†å“ " + productId + " è®¿é—®äººæ•°è¿‡å¤šï¼Œè¯·ç¨åå†è¯•";
    }
}
```

**é…ç½®çƒ­ç‚¹è§„åˆ™**ï¼š
```java
@Configuration
public class SentinelConfig {
    
    @PostConstruct
    public void initHotParamRules() {
        List<ParamFlowRule> rules = new ArrayList<>();
        
        ParamFlowRule rule = new ParamFlowRule();
        rule.setResource("productDetail");  // èµ„æºå
        rule.setParamIdx(0);                // å‚æ•°ç´¢å¼•ï¼ˆç¬¬1ä¸ªå‚æ•°ï¼‰
        rule.setCount(100);                 // æ¯ç§’æœ€å¤š100æ¬¡
        rule.setGrade(RuleConstant.FLOW_GRADE_QPS);
        
        rules.add(rule);
        ParamFlowRuleManager.loadRules(rules);
    }
}
```

### 3.2 å‚æ•°ç´¢å¼•è¯´æ˜


**å‚æ•°ç´¢å¼•è§„åˆ™**ï¼š
```java
// ç¤ºä¾‹1ï¼šå•ä¸ªå‚æ•°
@GetMapping("/api/query")
public String query(@RequestParam("id") String id) {
    // id çš„ç´¢å¼•æ˜¯ 0
}

// ç¤ºä¾‹2ï¼šå¤šä¸ªå‚æ•°
@GetMapping("/api/search")
public String search(
    @RequestParam("keyword") String keyword,  // ç´¢å¼• 0
    @RequestParam("city") String city,        // ç´¢å¼• 1
    @RequestParam("type") Integer type        // ç´¢å¼• 2
) {
    // é…ç½®æ—¶æ ¹æ®éœ€è¦é€‰æ‹©ç›‘æ§å“ªä¸ªå‚æ•°
}
```

> ğŸ’¡ **é‡è¦æç¤º**  
> å‚æ•°ç´¢å¼•ä» **0** å¼€å§‹è®¡æ•°ï¼Œå¯¹åº”æ–¹æ³•å‚æ•°çš„ä½ç½®é¡ºåº

### 3.3 é™æµæ¨¡å¼è¯¦è§£


**QPSæ¨¡å¼ï¼ˆæœ€å¸¸ç”¨ï¼‰**ï¼š
```java
ParamFlowRule rule = new ParamFlowRule();
rule.setGrade(RuleConstant.FLOW_GRADE_QPS);  // QPSæ¨¡å¼
rule.setCount(100);  // æ¯ç§’100æ¬¡
```

**çº¿ç¨‹æ•°æ¨¡å¼**ï¼š
```java
ParamFlowRule rule = new ParamFlowRule();
rule.setGrade(RuleConstant.FLOW_GRADE_THREAD_COUNT);  // çº¿ç¨‹æ•°æ¨¡å¼
rule.setCount(10);   // æœ€å¤š10ä¸ªçº¿ç¨‹åŒæ—¶å¤„ç†
```

**ä¸¤ç§æ¨¡å¼å¯¹æ¯”**ï¼š
```
QPSæ¨¡å¼ï¼š
é€‚åˆï¼šå¿«é€Ÿå“åº”çš„æ¥å£
ç¤ºä¾‹ï¼šå•†å“æŸ¥è¯¢ï¼ˆ10mså“åº”ï¼‰
é™åˆ¶ï¼šæ¯ç§’è¯·æ±‚æ¬¡æ•°

çº¿ç¨‹æ•°æ¨¡å¼ï¼š
é€‚åˆï¼šå“åº”æ…¢çš„æ¥å£
ç¤ºä¾‹ï¼šå¤æ‚è®¡ç®—ï¼ˆ500mså“åº”ï¼‰
é™åˆ¶ï¼šåŒæ—¶å¤„ç†çš„çº¿ç¨‹æ•°
```

---

## 4. ğŸ›’ å•†å“IDé™æµæ¡ˆä¾‹


### 4.1 ä¸šåŠ¡åœºæ™¯


**çœŸå®åœºæ™¯**ï¼š
```
ç”µå•†é¦–é¡µæ¨èä½ï¼š
æ™®é€šå•†å“ï¼š100 æ¬¡/ç§’
çˆ†æ¬¾å•†å“ï¼š20000 æ¬¡/ç§’

ä¸é™æµåæœï¼š
â†’ æ•°æ®åº“è¿æ¥æ± è€—å°½
â†’ Redisç¼“å­˜å‡»ç©¿
â†’ æ•´ä¸ªå•†å“æœåŠ¡é›ªå´©
```

### 4.2 å®Œæ•´å®ç°æ–¹æ¡ˆ


**æ§åˆ¶å™¨ä»£ç **ï¼š
```java
@RestController
@RequestMapping("/product")
public class ProductController {
    
    @Autowired
    private ProductService productService;
    
    @GetMapping("/detail")
    @SentinelResource(
        value = "productDetail",
        blockHandler = "productBlockHandler"
    )
    public ResponseEntity<?> getProductDetail(
        @RequestParam("productId") String productId
    ) {
        // æŸ¥è¯¢å•†å“è¯¦æƒ…
        Product product = productService.getById(productId);
        return ResponseEntity.ok(product);
    }
    
    // é™æµé™çº§å¤„ç†
    public ResponseEntity<?> productBlockHandler(
        String productId, 
        BlockException ex
    ) {
        // è¿”å›é™çº§æ•°æ®
        Map<String, Object> fallback = new HashMap<>();
        fallback.put("message", "å•†å“è®¿é—®é‡è¿‡å¤§ï¼Œè¯·ç¨åé‡è¯•");
        fallback.put("productId", productId);
        fallback.put("cached", true);  // æ ‡è®°ä¸ºé™çº§æ•°æ®
        
        return ResponseEntity.status(429).body(fallback);
    }
}
```

**çƒ­ç‚¹è§„åˆ™é…ç½®**ï¼š
```java
@Configuration
public class ProductHotParamConfig {
    
    @PostConstruct
    public void initProductHotRule() {
        ParamFlowRule rule = new ParamFlowRule();
        rule.setResource("productDetail");
        rule.setParamIdx(0);  // ç›‘æ§ç¬¬ä¸€ä¸ªå‚æ•° productId
        rule.setCount(1000);  // é»˜è®¤é™åˆ¶ 1000 QPS
        
        // ğŸ”¥ ä¸ºç‰¹å®šå•†å“è®¾ç½®ä¸“å±é™æµ
        Map<Object, Integer> hotItems = new HashMap<>();
        hotItems.put("IPHONE15", 500);    // iPhone15 é™åˆ¶500 QPS
        hotItems.put("HUAWEI_P60", 300);  // åä¸ºP60 é™åˆ¶300 QPS
        
        rule.setParamFlowItemList(convertToItemList(hotItems));
        
        ParamFlowRuleManager.loadRules(Collections.singletonList(rule));
    }
    
    // è½¬æ¢ä¸ºSentineléœ€è¦çš„æ ¼å¼
    private List<ParamFlowItem> convertToItemList(Map<Object, Integer> items) {
        return items.entrySet().stream()
            .map(entry -> {
                ParamFlowItem item = new ParamFlowItem();
                item.setObject(String.valueOf(entry.getKey()));
                item.setCount(entry.getValue());
                item.setClassType(String.class.getName());
                return item;
            })
            .collect(Collectors.toList());
    }
}
```

### 4.3 é™æµæ•ˆæœæ¼”ç¤º


**è®¿é—®æµ‹è¯•**ï¼š
```
è¯·æ±‚1ï¼šGET /product/detail?productId=COMMON_001
å“åº”ï¼šæ­£å¸¸è¿”å›å•†å“ä¿¡æ¯ï¼ˆé™åˆ¶1000 QPSï¼‰

è¯·æ±‚2ï¼šGET /product/detail?productId=IPHONE15  
å“åº”ï¼šæ­£å¸¸è¿”å›å•†å“ä¿¡æ¯ï¼ˆé™åˆ¶500 QPSï¼‰

è¯·æ±‚3ï¼ˆè¶…é™ï¼‰ï¼šGET /product/detail?productId=IPHONE15
å“åº”ï¼šHTTP 429
{
  "message": "å•†å“è®¿é—®é‡è¿‡å¤§ï¼Œè¯·ç¨åé‡è¯•",
  "productId": "IPHONE15",
  "cached": true
}
```

---

## 5. ğŸ‘¤ ç”¨æˆ·IDé™æµæ¡ˆä¾‹


### 5.1 åº”ç”¨åœºæ™¯


**é˜²åˆ·åœºæ™¯**ï¼š
```
APIæ¥å£ï¼šæŸ¥è¯¢è®¢å•åˆ—è¡¨
æ­£å¸¸ç”¨æˆ·ï¼šæ¯ç§’ 2-3 æ¬¡è¯·æ±‚
åˆ·å•ç”¨æˆ·ï¼šæ¯ç§’ 1000 æ¬¡è¯·æ±‚

ç”¨æˆ·IDé™æµç›®æ ‡ï¼š
â†’ é™åˆ¶å•ä¸ªç”¨æˆ·çš„è¯·æ±‚é¢‘ç‡
â†’ é˜²æ­¢æ¶æ„åˆ·å•ã€åˆ·æ•°æ®
â†’ ä¿æŠ¤ç³»ç»Ÿèµ„æº
```

### 5.2 å®ç°æ–¹æ¡ˆ


**æ¥å£å®šä¹‰**ï¼š
```java
@RestController
@RequestMapping("/order")
public class OrderController {
    
    @GetMapping("/list")
    @SentinelResource(
        value = "orderList",
        blockHandler = "orderListBlockHandler"
    )
    public ResponseEntity<?> getOrderList(
        @RequestParam("userId") String userId,
        @RequestParam(value = "page", defaultValue = "1") Integer page
    ) {
        // æŸ¥è¯¢è®¢å•åˆ—è¡¨
        List<Order> orders = orderService.getByUserId(userId, page);
        return ResponseEntity.ok(orders);
    }
    
    public ResponseEntity<?> orderListBlockHandler(
        String userId, 
        Integer page,
        BlockException ex
    ) {
        Map<String, Object> result = new HashMap<>();
        result.put("code", 429);
        result.put("message", "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•");
        result.put("userId", userId);
        
        return ResponseEntity.status(429).body(result);
    }
}
```

**ç”¨æˆ·é™æµè§„åˆ™**ï¼š
```java
@Configuration
public class UserRateLimitConfig {
    
    @PostConstruct
    public void initUserLimitRule() {
        ParamFlowRule rule = new ParamFlowRule();
        rule.setResource("orderList");
        rule.setParamIdx(0);          // ç¬¬ä¸€ä¸ªå‚æ•°ï¼šuserId
        rule.setCount(10);            // æ¯ä¸ªç”¨æˆ·æ¯ç§’æœ€å¤š10æ¬¡
        rule.setDurationInSec(1);     // ç»Ÿè®¡çª—å£1ç§’
        rule.setGrade(RuleConstant.FLOW_GRADE_QPS);
        
        // ğŸŒŸ VIPç”¨æˆ·ç‰¹æ®Šå¤„ç†
        Map<Object, Integer> vipUsers = new HashMap<>();
        vipUsers.put("VIP_USER_001", 100);  // VIPç”¨æˆ·é™åˆ¶100 QPS
        vipUsers.put("VIP_USER_002", 100);
        
        rule.setParamFlowItemList(convertToItems(vipUsers));
        
        ParamFlowRuleManager.loadRules(Collections.singletonList(rule));
    }
}
```

### 5.3 å®é™…åº”ç”¨æ•ˆæœ


**é˜²æŠ¤æ•ˆæœ**ï¼š
```
åœºæ™¯1ï¼šæ­£å¸¸ç”¨æˆ·
ç”¨æˆ·Aï¼ˆuser_123ï¼‰â†’ æ¯ç§’5æ¬¡è¯·æ±‚ â†’ âœ… æ­£å¸¸é€šè¿‡

åœºæ™¯2ï¼šé¢‘ç¹æ“ä½œç”¨æˆ·
ç”¨æˆ·Bï¼ˆuser_456ï¼‰â†’ æ¯ç§’15æ¬¡è¯·æ±‚ â†’ âš ï¸ è¢«é™æµ
  â”œâ”€ å‰10æ¬¡è¯·æ±‚ â†’ æ­£å¸¸å¤„ç†
  â””â”€ å5æ¬¡è¯·æ±‚  â†’ è¿”å›429é”™è¯¯

åœºæ™¯3ï¼šVIPç”¨æˆ·
ç”¨æˆ·Cï¼ˆVIP_USER_001ï¼‰â†’ æ¯ç§’50æ¬¡è¯·æ±‚ â†’ âœ… æ­£å¸¸é€šè¿‡
```

---

## 6. ğŸŒ IPåœ°å€é™æµæ¡ˆä¾‹


### 6.1 åœºæ™¯åˆ†æ


**å…¸å‹åœºæ™¯**ï¼š
```
APIæ¥å£è¢«çˆ¬è™«æ”»å‡»ï¼š
æŸä¸ªIPï¼š200.200.200.200
è¯·æ±‚é¢‘ç‡ï¼šæ¯ç§’10000æ¬¡

å½±å“ï¼š
â†’ å ç”¨å¤§é‡å¸¦å®½
â†’ æ¶ˆè€—æœåŠ¡å™¨èµ„æº
â†’ å½±å“æ­£å¸¸ç”¨æˆ·è®¿é—®
```

### 6.2 IPæå–ä¸é™æµ


**IPåœ°å€æå–**ï¼š
```java
@Component
public class IpUtils {
    
    public static String getClientIP(HttpServletRequest request) {
        String ip = request.getHeader("X-Forwarded-For");
        
        if (ip == null || ip.isEmpty() || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getHeader("X-Real-IP");
        }
        if (ip == null || ip.isEmpty() || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getRemoteAddr();
        }
        
        // å¤„ç†å¤šçº§ä»£ç†çš„æƒ…å†µ
        if (ip != null && ip.contains(",")) {
            ip = ip.split(",")[0].trim();
        }
        
        return ip;
    }
}
```

**æ§åˆ¶å™¨å®ç°**ï¼š
```java
@RestController
@RequestMapping("/api")
public class ApiController {
    
    @Autowired
    private HttpServletRequest request;
    
    @GetMapping("/data")
    @SentinelResource(
        value = "apiData",
        blockHandler = "apiBlockHandler"
    )
    public ResponseEntity<?> getData(@RequestParam("type") String type) {
        // è·å–å®¢æˆ·ç«¯IP
        String clientIp = IpUtils.getClientIP(request);
        
        // ä¸šåŠ¡é€»è¾‘
        Map<String, Object> data = apiService.getData(type);
        data.put("clientIp", clientIp);
        
        return ResponseEntity.ok(data);
    }
    
    public ResponseEntity<?> apiBlockHandler(
        String type,
        BlockException ex
    ) {
        return ResponseEntity.status(429)
            .body("IPè®¿é—®é¢‘ç‡è¿‡é«˜ï¼Œè¯·ç¨åé‡è¯•");
    }
}
```

**IPé™æµé…ç½®**ï¼ˆéœ€è¦è‡ªå®šä¹‰å‚æ•°æå–ï¼‰ï¼š
```java
@Configuration
public class IpRateLimitConfig implements InitFunc {
    
    @Override
    public void init() {
        // æ³¨å†ŒIPå‚æ•°æå–å™¨
        ParamFlowRuleManager.setParamParser(new RequestOriginParser() {
            @Override
            public String parseOrigin(HttpServletRequest request) {
                return IpUtils.getClientIP(request);
            }
        });
        
        // é…ç½®IPé™æµè§„åˆ™
        ParamFlowRule rule = new ParamFlowRule();
        rule.setResource("apiData");
        rule.setCount(100);  // å•ä¸ªIPæ¯ç§’100æ¬¡
        rule.setGrade(RuleConstant.FLOW_GRADE_QPS);
        
        ParamFlowRuleManager.loadRules(Collections.singletonList(rule));
    }
}
```

---

## 7. ğŸ” å‚æ•°æå–æŠ€å·§


### 7.1 åŸºç¡€å‚æ•°æå–


**URLå‚æ•°æå–**ï¼š
```java
// è‡ªåŠ¨æå–URLå‚æ•°
@GetMapping("/search")
@SentinelResource(value = "search")
public String search(
    @RequestParam("keyword") String keyword  // ç´¢å¼•0
) {
    return "æœç´¢ï¼š" + keyword;
}
```

**è·¯å¾„å˜é‡æå–**ï¼š
```java
// æå–è·¯å¾„å‚æ•°
@GetMapping("/product/{id}")
@SentinelResource(value = "productById")
public String getProduct(
    @PathVariable("id") String id  // ç´¢å¼•0
) {
    return "å•†å“ï¼š" + id;
}
```

### 7.2 å¤æ‚å‚æ•°æå–


**è¯·æ±‚ä½“å‚æ•°æå–**ï¼š
```java
@PostMapping("/order/create")
@SentinelResource(
    value = "createOrder",
    blockHandler = "createOrderBlock"
)
public ResponseEntity<?> createOrder(@RequestBody OrderRequest request) {
    // éœ€è¦è‡ªå®šä¹‰å‚æ•°æå–é€»è¾‘
    // å› ä¸º@RequestBodyå‚æ•°æ— æ³•ç›´æ¥ç”¨ç´¢å¼•æå–
    return ResponseEntity.ok(orderService.create(request));
}

// ä½¿ç”¨RequestOriginParserè‡ªå®šä¹‰æå–
public class OrderParamParser implements RequestOriginParser {
    @Override
    public String parseOrigin(HttpServletRequest request) {
        // ä»è¯·æ±‚ä½“ä¸­æå–userId
        try {
            String body = StreamUtils.copyToString(
                request.getInputStream(), 
                StandardCharsets.UTF_8
            );
            JSONObject json = JSON.parseObject(body);
            return json.getString("userId");
        } catch (Exception e) {
            return "unknown";
        }
    }
}
```

### 7.3 Headerå‚æ•°æå–


**æå–è¯·æ±‚å¤´ä¿¡æ¯**ï¼š
```java
@GetMapping("/api/resource")
@SentinelResource(value = "resource")
public String getResource(
    @RequestHeader("User-Token") String token  // ç´¢å¼•0
) {
    return "èµ„æºè®¿é—®ï¼š" + token;
}

// é…ç½®è§„åˆ™
ParamFlowRule rule = new ParamFlowRule();
rule.setResource("resource");
rule.setParamIdx(0);  // ç›‘æ§tokenå‚æ•°
rule.setCount(50);    // æ¯ä¸ªtokenæ¯ç§’50æ¬¡
```

---

## 8. âš¡ ç”µå•†ç§’æ€ä¿æŠ¤æ–¹æ¡ˆ


### 8.1 ç§’æ€åœºæ™¯åˆ†æ


**ç§’æ€ç‰¹ç‚¹**ï¼š
```
æ—¶é—´ç‰¹å¾ï¼š
â†’ ç¬æ—¶æµé‡æå¤§ï¼ˆ10ä¸‡+ QPSï¼‰
â†’ æŒç»­æ—¶é—´çŸ­ï¼ˆå‡ ç§’åˆ°å‡ åˆ†é’Ÿï¼‰
â†’ æµé‡é›†ä¸­åœ¨å°‘æ•°å•†å“

é£é™©ç‚¹ï¼š
â†’ æ•°æ®åº“å‹åŠ›ï¼ˆåº“å­˜æ‰£å‡ï¼‰
â†’ ç¼“å­˜å‡»ç©¿ï¼ˆçƒ­ç‚¹æ•°æ®å¤±æ•ˆï¼‰
â†’ æœåŠ¡é›ªå´©ï¼ˆä¾èµ–æœåŠ¡æŒ‚æ‰ï¼‰
```

### 8.2 å¤šå±‚é˜²æŠ¤æ–¹æ¡ˆ


**æ¶æ„è®¾è®¡**ï¼š
```
ç”¨æˆ·è¯·æ±‚
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1ï¸âƒ£ Nginxé™æµ    â”‚ â†’ 10ä¸‡ QPS
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2ï¸âƒ£ ç½‘å…³å±‚é™æµ   â”‚ â†’ 5ä¸‡ QPS
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3ï¸âƒ£ çƒ­ç‚¹å‚æ•°é™æµ â”‚ â†’ 1ä¸‡ QPSï¼ˆæœ¬å±‚é‡ç‚¹ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4ï¸âƒ£ åº“å­˜é¢„æ‰£å‡   â”‚ â†’ çœŸå®åº“å­˜æ£€æŸ¥
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5ï¸âƒ£ æ•°æ®åº“æ‰£å‡   â”‚ â†’ æœ€ç»ˆè½åº“
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.3 æ ¸å¿ƒä»£ç å®ç°


**ç§’æ€æ¥å£**ï¼š
```java
@RestController
@RequestMapping("/seckill")
public class SeckillController {
    
    @Autowired
    private SeckillService seckillService;
    
    @PostMapping("/purchase")
    @SentinelResource(
        value = "seckillPurchase",
        blockHandler = "seckillBlockHandler"
    )
    public ResponseEntity<?> purchase(
        @RequestParam("productId") String productId,
        @RequestParam("userId") String userId
    ) {
        // æ‰§è¡Œç§’æ€é€»è¾‘
        SeckillResult result = seckillService.doPurchase(productId, userId);
        return ResponseEntity.ok(result);
    }
    
    // é™æµé™çº§å¤„ç†
    public ResponseEntity<?> seckillBlockHandler(
        String productId,
        String userId,
        BlockException ex
    ) {
        SeckillResult result = new SeckillResult();
        result.setSuccess(false);
        result.setMessage("å•†å“å¤ªç«çˆ†äº†ï¼Œå·²è¢«æŠ¢å…‰ï¼");
        result.setProductId(productId);
        
        return ResponseEntity.ok(result);
    }
}
```

**ç§’æ€é™æµè§„åˆ™**ï¼š
```java
@Configuration
public class SeckillHotParamConfig {
    
    @PostConstruct
    public void initSeckillRules() {
        // è§„åˆ™1ï¼šå•†å“ç»´åº¦é™æµ
        ParamFlowRule productRule = new ParamFlowRule();
        productRule.setResource("seckillPurchase");
        productRule.setParamIdx(0);  // productId
        productRule.setCount(10000); // é»˜è®¤1ä¸‡QPS
        
        // çƒ­é—¨ç§’æ€å•†å“ç‰¹æ®Šé™åˆ¶
        Map<Object, Integer> hotProducts = new HashMap<>();
        hotProducts.put("SECKILL_IPHONE", 5000);   // iPhoneé™åˆ¶5000
        hotProducts.put("SECKILL_HUAWEI", 3000);   // åä¸ºé™åˆ¶3000
        productRule.setParamFlowItemList(convert(hotProducts));
        
        // è§„åˆ™2ï¼šç”¨æˆ·ç»´åº¦é™æµï¼ˆé˜²æ­¢å•ç”¨æˆ·åˆ·æ¥å£ï¼‰
        ParamFlowRule userRule = new ParamFlowRule();
        userRule.setResource("seckillPurchase");
        userRule.setParamIdx(1);  // userId
        userRule.setCount(5);     // æ¯ä¸ªç”¨æˆ·æ¯ç§’æœ€å¤š5æ¬¡
        
        List<ParamFlowRule> rules = Arrays.asList(productRule, userRule);
        ParamFlowRuleManager.loadRules(rules);
    }
}
```

### 8.4 å®Œæ•´é˜²æŠ¤é“¾è·¯


**ä¸šåŠ¡å±‚é¢é˜²æŠ¤**ï¼š
```java
@Service
public class SeckillService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    public SeckillResult doPurchase(String productId, String userId) {
        // 1ï¸âƒ£ æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²è´­ä¹°ï¼ˆé˜²æ­¢é‡å¤è´­ä¹°ï¼‰
        String userKey = "seckill:user:" + userId + ":" + productId;
        if (redisTemplate.hasKey(userKey)) {
            return SeckillResult.fail("æ‚¨å·²ç»å‚ä¸è¿‡è¯¥å•†å“çš„ç§’æ€");
        }
        
        // 2ï¸âƒ£ Redisé¢„æ‰£åº“å­˜ï¼ˆå‡å°‘æ•°æ®åº“å‹åŠ›ï¼‰
        String stockKey = "seckill:stock:" + productId;
        Long stock = redisTemplate.opsForValue().decrement(stockKey);
        
        if (stock < 0) {
            // åº“å­˜ä¸è¶³ï¼Œå›æ»š
            redisTemplate.opsForValue().increment(stockKey);
            return SeckillResult.fail("å•†å“å·²å”®ç½„");
        }
        
        // 3ï¸âƒ£ è®°å½•ç”¨æˆ·å·²è´­ä¹°
        redisTemplate.opsForValue().set(userKey, "1", 24, TimeUnit.HOURS);
        
        // 4ï¸âƒ£ å¼‚æ­¥å¤„ç†è®¢å•ï¼ˆæ”¾å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼‰
        sendToOrderQueue(productId, userId);
        
        return SeckillResult.success("ç§’æ€æˆåŠŸï¼Œè¯·ç­‰å¾…è®¢å•ç”Ÿæˆ");
    }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ¦‚å¿µ


**çƒ­ç‚¹é™æµä¸‰è¦ç´ **ï¼š
- ğŸ¯ **å‚æ•°è¯†åˆ«**ï¼šç¡®å®šå“ªä¸ªå‚æ•°æ˜¯çƒ­ç‚¹ï¼ˆå•†å“IDã€ç”¨æˆ·IDç­‰ï¼‰
- ğŸ“Š **é˜ˆå€¼è®¾ç½®**ï¼šä¸ºä¸åŒå‚æ•°å€¼è®¾ç½®ä¸åŒé™æµé˜ˆå€¼
- ğŸ›¡ï¸ **é™çº§ç­–ç•¥**ï¼šé™æµåçš„å‹å¥½æç¤ºå’Œå¤‡ç”¨æ–¹æ¡ˆ

**æ ¸å¿ƒé…ç½®é¡¹**ï¼š
```java
ParamFlowRule rule = new ParamFlowRule();
rule.setResource("èµ„æºå");      // è¦ä¿æŠ¤çš„æ¥å£
rule.setParamIdx(0);            // å‚æ•°ä½ç½®ï¼ˆä»0å¼€å§‹ï¼‰
rule.setCount(100);             // é™æµé˜ˆå€¼
rule.setGrade(é™æµæ¨¡å¼);         // QPSæˆ–çº¿ç¨‹æ•°
```

### 9.2 å®æˆ˜ç»éªŒæ€»ç»“


**âœ… æ¨èåšæ³•**ï¼š
```
1. å¤šå±‚é˜²æŠ¤ï¼šç½‘å…³ + åº”ç”¨ + æ•°æ®åº“
2. å·®å¼‚åŒ–é™æµï¼šçƒ­ç‚¹å•†å“å•ç‹¬é™åˆ¶
3. å‹å¥½é™çº§ï¼šè¿”å›æœ‰æ„ä¹‰çš„æç¤ºä¿¡æ¯
4. ç›‘æ§å‘Šè­¦ï¼šå®æ—¶ç›‘æ§é™æµæƒ…å†µ
```

**âŒ é¿å…è¯¯åŒº**ï¼š
```
1. ä¸è¦å¯¹æ‰€æœ‰å‚æ•°éƒ½é™æµï¼ˆæ€§èƒ½å¼€é”€å¤§ï¼‰
2. ä¸è¦è®¾ç½®è¿‡ä½çš„é˜ˆå€¼ï¼ˆå½±å“æ­£å¸¸ç”¨æˆ·ï¼‰
3. ä¸è¦å¿˜è®°é™çº§å¤„ç†ï¼ˆç”¨æˆ·ä½“éªŒå·®ï¼‰
4. ä¸è¦åœ¨é™æµååšå¤æ‚é€»è¾‘ï¼ˆå¿«é€Ÿå¤±è´¥ï¼‰
```

### 9.3 å…¸å‹åº”ç”¨åœºæ™¯é€ŸæŸ¥


| åœºæ™¯ | å‚æ•°ç±»å‹ | é™æµç­–ç•¥ | é™çº§æ–¹æ¡ˆ |
|------|---------|---------|---------|
| ğŸ›’ **å•†å“è¯¦æƒ…** | `å•†å“ID` | `çƒ­é—¨å•†å“200 QPS` | `è¿”å›ç¼“å­˜æ•°æ®` |
| ğŸ‘¤ **ç”¨æˆ·API** | `ç”¨æˆ·ID` | `å•ç”¨æˆ·10 QPS` | `æç¤ºè¯·æ±‚è¿‡å¿«` |
| ğŸŒ **é˜²çˆ¬è™«** | `IPåœ°å€` | `å•IP 100 QPS` | `è¿”å›éªŒè¯ç é¡µé¢` |
| âš¡ **ç§’æ€æ´»åŠ¨** | `å•†å“ID` | `ç§’æ€å•†å“5000 QPS` | `æç¤ºå·²æŠ¢å…‰` |

### 9.4 å¿«é€Ÿè®°å¿†å£è¯€


```
çƒ­ç‚¹é™æµè¦è®°ç‰¢ï¼Œå‚æ•°é€‰æ‹©å¾ˆé‡è¦
å•†å“ç”¨æˆ·å’ŒIPï¼Œæ ¹æ®åœºæ™¯æ¥è®¾ç½®
é˜ˆå€¼ä¸èƒ½å¤ªéšæ„ï¼Œç›‘æ§æ•°æ®åšä¾æ®
é™çº§æ–¹æ¡ˆè¦å‹å¥½ï¼Œç”¨æˆ·ä½“éªŒæ”¾é¦–ä½
```

> âš ï¸ **é‡è¦æé†’**  
> çƒ­ç‚¹å‚æ•°é™æµæ˜¯ä¿æŠ¤ç³»ç»Ÿçš„**æœ€åä¸€é“é˜²çº¿**ï¼Œåº”è¯¥é…åˆç¼“å­˜ã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰æ‰‹æ®µç»¼åˆä½¿ç”¨ï¼Œä¸èƒ½å•ç‹¬ä¾èµ–é™æµè§£å†³æ‰€æœ‰é—®é¢˜ï¼