---
title: 3ã€é›†ç¾¤æµæ§å®æˆ˜
---
## ğŸ“š ç›®å½•

1. [é›†ç¾¤æµæ§åŸºç¡€æ¦‚å¿µ](#1-é›†ç¾¤æµæ§åŸºç¡€æ¦‚å¿µ)
2. [é›†ç¾¤æµæ§å·¥ä½œåŸç†](#2-é›†ç¾¤æµæ§å·¥ä½œåŸç†)
3. [é›†ç¾¤æµæ§å®æˆ˜éƒ¨ç½²](#3-é›†ç¾¤æµæ§å®æˆ˜éƒ¨ç½²)
4. [æ€§èƒ½ä¼˜åŒ–ä¸é«˜å¯ç”¨](#4-æ€§èƒ½ä¼˜åŒ–ä¸é«˜å¯ç”¨)
5. [ç›‘æ§è¿ç»´å®è·µ](#5-ç›‘æ§è¿ç»´å®è·µ)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ é›†ç¾¤æµæ§åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯é›†ç¾¤æµæ§


**é€šä¿—ç†è§£**ï¼š
æƒ³è±¡ä½ å¼€äº†ä¸€å®¶è¿é”å¥¶èŒ¶åº—ï¼Œæœ‰3å®¶åˆ†åº—ã€‚å¦‚æœæ¯å®¶åº—éƒ½ç‹¬ç«‹é™åˆ¶"æ¯åˆ†é’Ÿæœ€å¤šæ¥100å•"ï¼Œé‚£ä¹ˆ3å®¶åº—åŠ èµ·æ¥å°±æ˜¯300å•ã€‚ä½†ä½ çš„åå¨ä¾›åº”èƒ½åŠ›åªèƒ½æ”¯æ’‘150å•ï¼Œè¿™æ—¶å°±ä¼šå´©æºƒã€‚

**é›†ç¾¤æµæ§å°±æ˜¯**ï¼šè®©è¿™3å®¶åˆ†åº—å…±åŒéµå®ˆ"æ€»å…±æ¯åˆ†é’Ÿ150å•"çš„è§„åˆ™ï¼Œä¸ç®¡å“ªå®¶åº—æ¥çš„è®¢å•ï¼Œéƒ½è¦å…ˆé—®æ€»éƒ¨"è¿˜èƒ½ä¸èƒ½æ¥å•"ã€‚

```
å•æœºæµæ§é—®é¢˜ï¼š
åˆ†åº—A: é™100å•/åˆ†é’Ÿ     â”
åˆ†åº—B: é™100å•/åˆ†é’Ÿ     â”œâ”€> æ€»å’Œ300å• > åå¨èƒ½åŠ›150å• âŒ
åˆ†åº—C: é™100å•/åˆ†é’Ÿ     â”˜

é›†ç¾¤æµæ§æ–¹æ¡ˆï¼š
     Token Server (æ€»éƒ¨è°ƒåº¦ä¸­å¿ƒ)
           â†“  â†“  â†“
        æ€»é¢åº¦: 150å•/åˆ†é’Ÿ
         /    |    \
    åˆ†åº—A   åˆ†åº—B   åˆ†åº—C
    (æŠ¢é…é¢) (æŠ¢é…é¢) (æŠ¢é…é¢)
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦é›†ç¾¤æµæ§


**æ ¸å¿ƒåœºæ™¯**ï¼š

**ğŸ”¸ åœºæ™¯1ï¼šå¤šå®ä¾‹éƒ¨ç½²çš„æµé‡æ€»é‡æ§åˆ¶**
```
é—®é¢˜ï¼š
è®¢å•æœåŠ¡éƒ¨ç½²äº†5ä¸ªå®ä¾‹
æ¯ä¸ªå®ä¾‹é™æµ1000 QPS
å®é™…æ€»æµé‡ = 5 Ã— 1000 = 5000 QPS
ä½†æ•°æ®åº“åªèƒ½æ‰¿å—3000 QPS â†’ å´©æºƒï¼

è§£å†³ï¼š
ä½¿ç”¨é›†ç¾¤æµæ§ï¼Œ5ä¸ªå®ä¾‹å…±äº«3000 QPSæ€»é¢åº¦
ä»»ä½•å®ä¾‹çš„è¯·æ±‚éƒ½è¦å…ˆå‘Token Serverç”³è¯·é…é¢
```

**ğŸ”¸ åœºæ™¯2ï¼šçƒ­ç‚¹å•†å“ç§’æ€**
```
ç§’æ€åœºæ™¯ï¼š
- iPhoneæ–°å“ä¸Šå¸‚ï¼Œ10000å°åº“å­˜
- ç”¨æˆ·è®¿é—®ä»»æ„ä¸€å°æœåŠ¡å™¨éƒ½å¯èƒ½æŠ¢è´­
- å•æœºé™æµæ— æ³•æ§åˆ¶æ€»é‡

é›†ç¾¤æµæ§ï¼š
Token Serverç»Ÿä¸€ç®¡ç†10000ä¸ªä»¤ç‰Œ
æ‰€æœ‰æœåŠ¡å™¨å®ä¾‹å…±äº«è¿™ä¸ªæ± å­
ç¡®ä¿ä¸ä¼šè¶…å–
```

**ğŸ”¸ åœºæ™¯3ï¼šAPIè°ƒç”¨æ€»é‡æ§åˆ¶**
```
ç¬¬ä¸‰æ–¹APIé™åˆ¶ï¼š
- çŸ­ä¿¡æœåŠ¡å•†é™åˆ¶ï¼š1000æ¡/åˆ†é’Ÿ
- ä½†ä½ çš„åº”ç”¨éƒ¨ç½²äº†20ä¸ªå®ä¾‹
- æ¯ä¸ªå®ä¾‹é™50æ¡/åˆ†é’Ÿ = 1000æ¡ âœ“

é—®é¢˜ï¼šæµé‡ä¸å‡è¡¡æ—¶ä¼šæµªè´¹é…é¢
è§£å†³ï¼šé›†ç¾¤æµæ§åŠ¨æ€åˆ†é…é…é¢
```

### 1.3 é›†ç¾¤æµæ§ vs å•æœºæµæ§å¯¹æ¯”


| å¯¹æ¯”ç»´åº¦ | **å•æœºæµæ§** | **é›†ç¾¤æµæ§** | **é€‚ç”¨åœºæ™¯** |
|---------|------------|------------|------------|
| ğŸ¯ **æ§åˆ¶ç²’åº¦** | å•ä¸ªå®ä¾‹ç‹¬ç«‹æ§åˆ¶ | å¤šå®ä¾‹ç»Ÿä¸€åè°ƒ | éœ€è¦æ€»é‡æ§åˆ¶æ—¶ç”¨é›†ç¾¤ |
| ğŸ“Š **é…é¢åˆ†é…** | å›ºå®šé…é¢ï¼Œå¯èƒ½æµªè´¹ | åŠ¨æ€åˆ†é…ï¼Œåˆ©ç”¨ç‡é«˜ | æµé‡ä¸å‡è¡¡ç”¨é›†ç¾¤ |
| âš¡ **å“åº”é€Ÿåº¦** | æœ¬åœ°åˆ¤æ–­ï¼Œæå¿«(nsçº§) | ç½‘ç»œé€šä¿¡ï¼Œè¾ƒæ…¢(msçº§) | å»¶è¿Ÿæ•æ„Ÿç”¨å•æœº |
| ğŸ”§ **éƒ¨ç½²å¤æ‚åº¦** | ç®€å•ï¼Œæ— éœ€é¢å¤–ç»„ä»¶ | éœ€è¦Token Server | ç®€å•åœºæ™¯ç”¨å•æœº |
| ğŸ’ª **å®¹é”™èƒ½åŠ›** | å®ä¾‹é—´äº’ä¸å½±å“ | Token Serveræ•…éšœå½±å“å…¨å±€ | é«˜å¯é è¦æ±‚éœ€è¦HAæ–¹æ¡ˆ |

> **ğŸ’¡ é€‰æ‹©å»ºè®®**
> - å•æœºæµæ§ï¼šå¤§éƒ¨åˆ†å¸¸è§„é™æµåœºæ™¯ï¼Œç®€å•é«˜æ•ˆ
> - é›†ç¾¤æµæ§ï¼šä¸¥æ ¼æ€»é‡æ§åˆ¶ã€çƒ­ç‚¹æ•°æ®ä¿æŠ¤ã€ç¬¬ä¸‰æ–¹APIé™é¢ç®¡ç†

---

## 2. âš™ï¸ é›†ç¾¤æµæ§å·¥ä½œåŸç†


### 2.1 æ¶æ„è§’è‰²åˆ’åˆ†


**é›†ç¾¤æµæ§çš„ä¸‰ä¸ªè§’è‰²**ï¼š

```
é›†ç¾¤æ¶æ„å›¾ï¼š
                   
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Token Server (ä»¤ç‰ŒæœåŠ¡å™¨)  â”‚  â† æ ¸å¿ƒåè°ƒè€…
    â”‚   - å­˜å‚¨æµæ§è§„åˆ™              â”‚
    â”‚   - ç®¡ç†ä»¤ç‰Œåˆ†é…              â”‚
    â”‚   - ç»Ÿè®¡å…¨å±€æµé‡              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ gRPCé€šä¿¡
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
         â†“                 â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Client1 â”‚       â”‚ Client2 â”‚  â† Token Client
    â”‚ è¯·æ±‚ä»¤ç‰Œ â”‚       â”‚ è¯·æ±‚ä»¤ç‰Œ â”‚     (åº”ç”¨å®ä¾‹)
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“                 â†“
      ç”¨æˆ·è¯·æ±‚           ç”¨æˆ·è¯·æ±‚
```

**ğŸ”¸ Token Server (ä»¤ç‰ŒæœåŠ¡å™¨)**
```
èŒè´£ï¼š
â€¢ é›†ä¸­ç®¡ç†æµæ§è§„åˆ™å’Œé…é¢
â€¢ æ¥æ”¶å®¢æˆ·ç«¯çš„ä»¤ç‰Œç”³è¯·è¯·æ±‚
â€¢ åˆ¤æ–­æ˜¯å¦å…è®¸é€šè¿‡å¹¶è¿”å›ç»“æœ
â€¢ ç»Ÿè®¡å…¨å±€æµé‡æ•°æ®

ç‰¹ç‚¹ï¼š
â€¢ å¯ä»¥æ˜¯ç‹¬ç«‹éƒ¨ç½²çš„æœåŠ¡
â€¢ ä¹Ÿå¯ä»¥ç”±æŸä¸ªåº”ç”¨å®ä¾‹å…¼ä»»
â€¢ æ”¯æŒå¤šä¸ªToken Serveråšé›†ç¾¤(é«˜å¯ç”¨)
```

**ğŸ”¸ Token Client (ä»¤ç‰Œå®¢æˆ·ç«¯)**
```
èŒè´£ï¼š
â€¢ å‘Token Serverç”³è¯·ä»¤ç‰Œ
â€¢ æœ¬åœ°ä¹Ÿä¼šç¼“å­˜éƒ¨åˆ†é…é¢(æ€§èƒ½ä¼˜åŒ–)
â€¢ Token Serverä¸å¯ç”¨æ—¶é™çº§ä¸ºå•æœºæ¨¡å¼

ç‰¹ç‚¹ï¼š
â€¢ æ¯ä¸ªåº”ç”¨å®ä¾‹éƒ½æ˜¯Token Client
â€¢ ä¸Token Serveré€šè¿‡gRPCé€šä¿¡
â€¢ è‡ªåŠ¨å¤„ç†è¿æ¥å’Œé‡è¯•
```

### 2.2 ä»¤ç‰Œç”³è¯·æµç¨‹


**å®Œæ•´äº¤äº’æµç¨‹**ï¼š

```
è¯·æ±‚å¤„ç†æ—¶åºå›¾ï¼š

ç”¨æˆ·è¯·æ±‚          Token Client          Token Server
   |                  |                      |
   |--[1]å‘èµ·è¯·æ±‚----->|                      |
   |                  |                      |
   |                  |--[2]ç”³è¯·ä»¤ç‰Œ--------->|
   |                  |   (å½“å‰æµé‡æ•°æ®)      |
   |                  |                      |
   |                  |                      |--[3]åˆ¤æ–­è§„åˆ™
   |                  |                      |   æ˜¯å¦è¶…é™ï¼Ÿ
   |                  |                      |
   |                  |<--[4]è¿”å›ç»“æœ---------|
   |                  |   (é€šè¿‡/æ‹’ç»)         |
   |                  |                      |
   |<--[5]å“åº”ç”¨æˆ·-----|                      |
   |   (æˆåŠŸ/é™æµ)     |                      |
```

**è¯¦ç»†æ­¥éª¤è§£æ**ï¼š

**æ­¥éª¤1ï¼šè¯·æ±‚åˆ°è¾¾**
```java
// ç”¨æˆ·è¯·æ±‚åˆ°è¾¾åº”ç”¨å®ä¾‹
@GetMapping("/order")
public Result createOrder() {
    // Sentinelæ‹¦æˆªç‚¹
    Entry entry = null;
    try {
        // è¯·æ±‚é€šè¿‡Sentinelæ£€æŸ¥
        entry = SphU.entry("createOrder");
        
        // ä¸šåŠ¡é€»è¾‘
        return orderService.create();
        
    } catch (BlockException e) {
        // è¢«é™æµï¼Œè¿”å›å‹å¥½æç¤º
        return Result.fail("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•");
    } finally {
        if (entry != null) {
            entry.exit();
        }
    }
}
```

**æ­¥éª¤2-4ï¼šä»¤ç‰Œç”³è¯·ä¸åˆ¤æ–­**
```
Token Clientè¡Œä¸ºï¼š
1. æ£€æŸ¥æœ¬åœ°æ˜¯å¦æœ‰ç¼“å­˜çš„ä»¤ç‰Œ(æ€§èƒ½ä¼˜åŒ–)
2. å¦‚æœæœ¬åœ°æ— ä»¤ç‰Œï¼Œå‘Token Serverç”³è¯·
3. Token Serveræ ¹æ®è§„åˆ™åˆ¤æ–­ï¼š
   - å½“å‰çª—å£æµé‡æ˜¯å¦è¶…é™ï¼Ÿ
   - æ˜¯å¦è¿˜æœ‰å¯ç”¨é…é¢ï¼Ÿ
4. è¿”å›ç»“æœï¼šPASS(é€šè¿‡) æˆ– BLOCK(æ‹’ç»)
```

**æ­¥éª¤5ï¼šç»“æœå¤„ç†**
```
é€šè¿‡(PASS)ï¼š
â†’ æ‰§è¡Œä¸šåŠ¡é€»è¾‘
â†’ è¿”å›æ­£å¸¸ç»“æœ

æ‹’ç»(BLOCK)ï¼š
â†’ æŠ›å‡ºBlockException
â†’ è¿”å›é™æµæç¤º
```

### 2.3 é…é¢åˆ†é…æœºåˆ¶


**åŠ¨æ€é…é¢åˆ†é…ç­–ç•¥**ï¼š

```
ç­–ç•¥1: å‡åŒ€åˆ†é…
æ€»é…é¢: 1000 QPS
å®ä¾‹æ•°: 5ä¸ª
æ¯ä¸ªå®ä¾‹åˆå§‹é…é¢: 1000/5 = 200 QPS

   Token Server
       â†“
   [1000 QPS]
     /  |  \
   200 200 200  â†’ å„å®ä¾‹å‡åˆ†
   
ä¼˜ç‚¹: ç®€å•å…¬å¹³
ç¼ºç‚¹: æµé‡ä¸å‡æ—¶æµªè´¹é…é¢
```

```
ç­–ç•¥2: åŠ¨æ€å€Ÿç”¨
å®ä¾‹A: æµé‡é«˜ï¼Œ200ä¸å¤Ÿ â†’ å‘Serverå†å€Ÿ100
å®ä¾‹B: æµé‡ä½ï¼Œåªç”¨äº†50 â†’ å‰©ä½™150å¯å€Ÿç»™åˆ«äºº

      Token Server (åè°ƒä¸­å¿ƒ)
           â†“
      åŠ¨æ€è°ƒé…æ± 
      /         \
   å®ä¾‹A(300)  å®ä¾‹B(50)
   
ä¼˜ç‚¹: é…é¢åˆ©ç”¨ç‡é«˜
ç¼ºç‚¹: é€šä¿¡å¼€é”€å¢åŠ 
```

> **ğŸ” æ·±å…¥ç†è§£**
> 
> Token Serverç±»ä¼¼é“¶è¡Œï¼Œç®¡ç†"æµé‡é¢åº¦"è¿™ä¸ªèµ„æºï¼š
> - æ¯ä¸ªåº”ç”¨å®ä¾‹æ˜¯å‚¨æˆ·ï¼Œå¯ä»¥æ¥å–é¢åº¦
> - æ€»é¢åº¦å›ºå®š(æ¯”å¦‚1000 QPS)
> - å–å®Œäº†å°±å¾—ç­‰ä¸‹ä¸ªæ—¶é—´çª—å£
> - åŠ¨æ€åˆ†é…è®©èµ„æºä¸æµªè´¹

---

## 3. ğŸš€ é›†ç¾¤æµæ§å®æˆ˜éƒ¨ç½²


### 3.1 éƒ¨ç½²æ¨¡å¼é€‰æ‹©


**ä¸¤ç§éƒ¨ç½²æ¨¡å¼å¯¹æ¯”**ï¼š

**ğŸ”¸ åµŒå…¥å¼æ¨¡å¼ (Embedded)**
```
è¯´æ˜ï¼šæŸä¸ªåº”ç”¨å®ä¾‹æ—¢æ˜¯Clientåˆæ˜¯Server

åº”ç”¨å®ä¾‹1           åº”ç”¨å®ä¾‹2          åº”ç”¨å®ä¾‹3
    â†“                   â†“                  â†“
[Client+Server] â† [Client]          [Client]
    (Token Server)      â†“                  â†“
         â†‘â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              gRPCè¯·æ±‚ä»¤ç‰Œ

ä¼˜ç‚¹ï¼š
â€¢ éƒ¨ç½²ç®€å•ï¼Œæ— éœ€é¢å¤–æœåŠ¡
â€¢ èµ„æºåˆ©ç”¨ç‡é«˜

ç¼ºç‚¹ï¼š
â€¢ Serverå®¿ä¸»å®ä¾‹å‹åŠ›å¤§
â€¢ Serveræ•…éšœå½±å“å…¨å±€
```

**ğŸ”¸ ç‹¬ç«‹å¼æ¨¡å¼ (Standalone)**
```
è¯´æ˜ï¼šToken Serverç‹¬ç«‹éƒ¨ç½²

       ç‹¬ç«‹Token Serveré›†ç¾¤
            â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”
            â”‚ S1 â”‚ S2 â”‚ â† é«˜å¯ç”¨é›†ç¾¤
            â””â”€â”¬â”€â”€â”´â”€â”€â”¬â”€â”˜
              â†‘     â†‘
       â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
       â†“      â†“      â†“      â†“
    [Client][Client][Client][Client]
    åº”ç”¨å®ä¾‹1  å®ä¾‹2  å®ä¾‹3  å®ä¾‹4

ä¼˜ç‚¹ï¼š
â€¢ èŒè´£åˆ†ç¦»ï¼Œç¨³å®šæ€§é«˜
â€¢ Serverå¯ä»¥åšé›†ç¾¤é«˜å¯ç”¨
â€¢ æ˜“äºç›‘æ§å’Œè¿ç»´

ç¼ºç‚¹ï¼š
â€¢ éœ€è¦é¢å¤–éƒ¨ç½²èµ„æº
â€¢ æ¶æ„å¤æ‚åº¦å¢åŠ 
```

> **ğŸ’¡ é€‰æ‹©å»ºè®®**
> - å¼€å‘æµ‹è¯•ç¯å¢ƒï¼šåµŒå…¥å¼æ¨¡å¼ï¼Œå¿«é€Ÿæ­å»º
> - ç”Ÿäº§ç¯å¢ƒï¼šç‹¬ç«‹å¼æ¨¡å¼ï¼Œç¨³å®šå¯é 

### 3.2 åµŒå…¥å¼æ¨¡å¼é…ç½®


**Step 1ï¼šå¼•å…¥ä¾èµ–**
```xml
<dependency>
    <groupId>com.alibaba.csp</groupId>
    <artifactId>sentinel-cluster-server-default</artifactId>
    <version>1.8.6</version>
</dependency>
<dependency>
    <groupId>com.alibaba.csp</groupId>
    <artifactId>sentinel-cluster-client-default</artifactId>
    <version>1.8.6</version>
</dependency>
```

**Step 2ï¼šé…ç½®Token Server**
```java
@Configuration
public class ClusterConfig {
    
    @PostConstruct
    public void initClusterServer() {
        // è®¾ç½®å½“å‰å®ä¾‹ä¸ºToken Server
        ClusterServerConfigManager.loadGlobalTransportConfig(
            new ServerTransportConfig()
                .setPort(18730)  // gRPCç«¯å£
                .setIdleSeconds(600) // è¿æ¥ç©ºé—²æ—¶é—´
        );
        
        // åŠ è½½é›†ç¾¤æµæ§è§„åˆ™
        List<FlowRule> rules = new ArrayList<>();
        FlowRule rule = new FlowRule();
        rule.setResource("createOrder");
        rule.setCount(1000);  // é›†ç¾¤æ€»QPSé™åˆ¶
        rule.setGrade(RuleConstant.FLOW_GRADE_QPS);
        rule.setClusterMode(true);  // å¯ç”¨é›†ç¾¤æ¨¡å¼
        
        // è®¾ç½®é›†ç¾¤é…ç½®
        ClusterFlowConfig clusterConfig = new ClusterFlowConfig();
        clusterConfig.setThresholdType(
            ClusterRuleConstant.FLOW_THRESHOLD_GLOBAL  // å…¨å±€é˜ˆå€¼
        );
        rule.setClusterConfig(clusterConfig);
        
        rules.add(rule);
        FlowRuleManager.loadRules(rules);
        
        // å¯åŠ¨Server
        ClusterTokenServer tokenServer = new SentinelDefaultTokenServer();
        tokenServer.start();
    }
}
```

**Step 3ï¼šé…ç½®Token Client**
```java
@Configuration
public class ClusterClientConfig {
    
    @PostConstruct
    public void initClusterClient() {
        // é…ç½®Token Serveråœ°å€
        ClusterClientConfig clientConfig = new ClusterClientConfig();
        clientConfig.setServerHost("192.168.1.100");  // Server IP
        clientConfig.setServerPort(18730);
        
        ClusterClientConfigManager.applyNewConfig(clientConfig);
        
        // å¯åŠ¨Client
        ClusterTokenClient tokenClient = new DefaultClusterTokenClient();
        tokenClient.start();
    }
}
```

### 3.3 ç‹¬ç«‹å¼æ¨¡å¼é…ç½®


**Token Serverç‹¬ç«‹éƒ¨ç½²**ï¼š

```java
// TokenServerApplication.java
@SpringBootApplication
public class TokenServerApplication {
    
    public static void main(String[] args) {
        SpringApplication.run(TokenServerApplication.class, args);
        
        // åˆå§‹åŒ–Token Server
        initTokenServer();
    }
    
    private static void initTokenServer() {
        // Serveré…ç½®
        ServerTransportConfig config = new ServerTransportConfig();
        config.setPort(18730);
        ClusterServerConfigManager.loadGlobalTransportConfig(config);
        
        // åŠ è½½æµæ§è§„åˆ™(å¯ä»é…ç½®ä¸­å¿ƒè¯»å–)
        loadFlowRules();
        
        // å¯åŠ¨æœåŠ¡
        ClusterTokenServer server = new SentinelDefaultTokenServer();
        server.start();
    }
}
```

**åº”ç”¨å®ä¾‹é…ç½®Client**ï¼š

```yaml
# application.yml
spring:
  cloud:
    sentinel:
      transport:
        dashboard: localhost:8080
      datasource:
        cluster:
          nacos:
            server-addr: localhost:8848
            dataId: cluster-server-config
            groupId: SENTINEL_GROUP
```

```java
// åº”ç”¨å¯åŠ¨æ—¶é…ç½®
@Configuration
public class SentinelClusterConfig {
    
    @Value("${token.server.host}")
    private String serverHost;
    
    @Value("${token.server.port}")
    private Integer serverPort;
    
    @PostConstruct
    public void init() {
        // å®¢æˆ·ç«¯é…ç½®
        ClusterClientAssignConfig assignConfig = 
            new ClusterClientAssignConfig(serverHost, serverPort);
        ClusterClientConfigManager.applyNewAssignConfig(assignConfig);
    }
}
```

### 3.4 è§„åˆ™é…ç½®è¯¦è§£


**é›†ç¾¤æµæ§è§„åˆ™å…³é”®å‚æ•°**ï¼š

| å‚æ•° | **å«ä¹‰** | **é…ç½®ç¤ºä¾‹** | **è¯´æ˜** |
|------|---------|------------|---------|
| `resource` | èµ„æºåç§° | `"createOrder"` | è¦ä¿æŠ¤çš„èµ„æº |
| `count` | é˜ˆå€¼ | `1000` | QPSæˆ–çº¿ç¨‹æ•°é™åˆ¶ |
| `clusterMode` | é›†ç¾¤æ¨¡å¼ | `true` | æ˜¯å¦å¯ç”¨é›†ç¾¤æµæ§ |
| `thresholdType` | é˜ˆå€¼ç±»å‹ | `GLOBAL/SINGLE` | å…¨å±€/å•æœº |
| `fallbackToLocalWhenFail` | é™çº§ç­–ç•¥ | `true` | Serverä¸å¯ç”¨æ—¶é€€åŒ–åˆ°å•æœº |

**å®Œæ•´é…ç½®ç¤ºä¾‹**ï¼š

```java
FlowRule rule = new FlowRule();
rule.setResource("createOrder");
rule.setCount(1000);  // é›†ç¾¤æ€»QPS
rule.setGrade(RuleConstant.FLOW_GRADE_QPS);
rule.setClusterMode(true);

// é›†ç¾¤é…ç½®
ClusterFlowConfig clusterConfig = new ClusterFlowConfig();
// å…¨å±€é˜ˆå€¼ï¼š1000 QPSæ˜¯æ‰€æœ‰å®ä¾‹å…±äº«
clusterConfig.setThresholdType(
    ClusterRuleConstant.FLOW_THRESHOLD_GLOBAL
);
// Serverä¸å¯ç”¨æ—¶é™çº§ä¸ºå•æœºæ¨¡å¼ï¼Œé˜ˆå€¼ä¸º200
clusterConfig.setFallbackToLocalWhenFail(true);
clusterConfig.setSampleCount(10);  // æ»‘åŠ¨çª—å£æ ·æœ¬æ•°
clusterConfig.setWindowIntervalMs(1000);  // çª—å£æ—¶é—´1ç§’

rule.setClusterConfig(clusterConfig);
```

---

## 4. ğŸ”§ æ€§èƒ½ä¼˜åŒ–ä¸é«˜å¯ç”¨


### 4.1 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


**ğŸ”¸ ä¼˜åŒ–1ï¼šæœ¬åœ°ä»¤ç‰Œç¼“å­˜**

```
åŸç†ï¼šClientæœ¬åœ°ç¼“å­˜éƒ¨åˆ†ä»¤ç‰Œï¼Œå‡å°‘ç½‘ç»œè¯·æ±‚

æœªä¼˜åŒ–ï¼šæ¯æ¬¡è¯·æ±‚éƒ½ç”³è¯·ä»¤ç‰Œ
ç”¨æˆ·è¯·æ±‚ â†’ Client â†’ Server â†’ åˆ¤æ–­ â†’ è¿”å›
        (æ¯æ¬¡éƒ½è¦ç½‘ç»œé€šä¿¡ï¼Œå»¶è¿Ÿé«˜)

ä¼˜åŒ–åï¼šæ‰¹é‡è·å–ä»¤ç‰Œ
Clientå¯åŠ¨ â†’ å‘Serverç”³è¯·100ä¸ªä»¤ç‰Œ â†’ æœ¬åœ°ç¼“å­˜
ç”¨æˆ·è¯·æ±‚1-100 â†’ ç›´æ¥ç”¨æœ¬åœ°ä»¤ç‰Œ(æ— ç½‘ç»œå¼€é”€)
ä»¤ç‰Œç”¨å®Œ â†’ å†æ¬¡æ‰¹é‡ç”³è¯·
```

```java
// é…ç½®æœ¬åœ°ä»¤ç‰Œç¼“å­˜
ClusterClientConfig config = new ClusterClientConfig();
config.setRequestTimeout(20);  // è¯·æ±‚è¶…æ—¶20ms

// æœ¬åœ°ä»¤ç‰Œæ¡¶é…ç½®
TokenClientHandler handler = new DefaultTokenClientHandler();
handler.setBucketCapacity(100);  // æœ¬åœ°ç¼“å­˜100ä¸ªä»¤ç‰Œ
handler.setRefillInterval(100);  // 100msè¡¥å……ä¸€æ¬¡
```

**ğŸ”¸ ä¼˜åŒ–2ï¼šå¼‚æ­¥é€šä¿¡**

```java
// å¼‚æ­¥ç”³è¯·ä»¤ç‰Œï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹
CompletableFuture<TokenResult> future = 
    tokenClient.requestTokenAsync(
        ruleId, 
        acquireCount
    );

future.whenComplete((result, ex) -> {
    if (result.getStatus() == TokenResultStatus.OK) {
        // é€šè¿‡ï¼Œæ‰§è¡Œä¸šåŠ¡
        processBusiness();
    } else {
        // æ‹’ç»ï¼Œè¿”å›é™æµ
        returnBlockResponse();
    }
});
```

**ğŸ”¸ ä¼˜åŒ–3ï¼šè¿æ¥æ± å¤ç”¨**

```
gRPCè¿æ¥æ± ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Clientå®ä¾‹      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚è¿æ¥æ± (10ä¸ª)â”‚ â”‚ â†’ å¤ç”¨è¿æ¥ï¼Œå‡å°‘æ¡æ‰‹å¼€é”€
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
   Token Server
```

### 4.2 é«˜å¯ç”¨è®¾è®¡


**ğŸ”¸ æ–¹æ¡ˆ1ï¼šToken Serveré›†ç¾¤**

```
æ¶æ„ï¼šå¤šä¸ªToken Serveräº’ä¸ºå¤‡ä»½

         è´Ÿè½½å‡è¡¡ (Nginx/LVS)
              â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â†“                   â†“
Token Server1    Token Server2
(ä¸»èŠ‚ç‚¹)          (å¤‡èŠ‚ç‚¹)
    â†“                   â†“
   å…±äº«å­˜å‚¨ (Redis/Nacos)
   - æµæ§è§„åˆ™
   - å…¨å±€è®¡æ•°
```

```java
// é…ç½®å¤šä¸ªServeråœ°å€
List<ServerNode> serverList = Arrays.asList(
    new ServerNode("192.168.1.100", 18730),
    new ServerNode("192.168.1.101", 18730),
    new ServerNode("192.168.1.102", 18730)
);

ClusterClientConfig config = new ClusterClientConfig();
config.setServerNodeList(serverList);
config.setFailover(true);  // å¼€å¯æ•…éšœè½¬ç§»
```

**ğŸ”¸ æ–¹æ¡ˆ2ï¼šé™çº§ç­–ç•¥**

```
é™çº§æµç¨‹ï¼š
1. Clientå°è¯•è¿æ¥Token Server
2. è¿æ¥å¤±è´¥æˆ–è¶…æ—¶
3. è‡ªåŠ¨é™çº§ä¸ºå•æœºæµæ§
4. Serveræ¢å¤åè‡ªåŠ¨åˆ‡å›é›†ç¾¤æ¨¡å¼

é…ç½®ç¤ºä¾‹ï¼š
rule.setClusterConfig(
    new ClusterFlowConfig()
        .setFallbackToLocalWhenFail(true)  // å¯ç”¨é™çº§
        .setFallbackQPS(200)  // é™çº§åçš„å•æœºé™æµå€¼
);
```

**ğŸ”¸ æ–¹æ¡ˆ3ï¼šç›‘æ§å‘Šè­¦**

```
ç›‘æ§æŒ‡æ ‡ï¼š
ğŸ“Š Token ServerçŠ¶æ€
   - CPU/å†…å­˜ä½¿ç”¨ç‡
   - gRPCè¿æ¥æ•°
   - è¯·æ±‚å¤„ç†å»¶è¿Ÿ

ğŸ“Š ClientçŠ¶æ€
   - ä»¤ç‰Œç”³è¯·æˆåŠŸç‡
   - é™çº§æ¬¡æ•°ç»Ÿè®¡
   - é™æµæ‹¦æˆªæ•°é‡

å‘Šè­¦è§„åˆ™ï¼š
âš ï¸  Serverä¸å¯ç”¨è¶…è¿‡1åˆ†é’Ÿ â†’ çŸ­ä¿¡/é‚®ä»¶å‘Šè­¦
âš ï¸  é™çº§æ¬¡æ•°è¿‡å¤š â†’ æ£€æŸ¥ç½‘ç»œ/Serverè´Ÿè½½
âš ï¸  é™æµç‡çªå¢ â†’ å¯èƒ½é­å—æ”»å‡»
```

### 4.3 æ€§èƒ½æµ‹è¯•æ•°æ®


**å‹æµ‹ç»“æœå‚è€ƒ**ï¼š

| åœºæ™¯ | **QPS** | **å»¶è¿Ÿ(P99)** | **CPUä½¿ç”¨ç‡** | **è¯´æ˜** |
|------|---------|--------------|--------------|---------|
| å•æœºæµæ§ | 50000 | < 1ms | 20% | æœ¬åœ°åˆ¤æ–­ï¼Œæå¿« |
| é›†ç¾¤æµæ§(æ— ç¼“å­˜) | 8000 | 15ms | 60% | æ¯æ¬¡ç½‘ç»œé€šä¿¡ |
| é›†ç¾¤æµæ§(æœ‰ç¼“å­˜) | 35000 | 3ms | 35% | æ‰¹é‡è·å–ä»¤ç‰Œ |
| é›†ç¾¤æµæ§(å¼‚æ­¥) | 42000 | 5ms | 40% | å¼‚æ­¥å¤„ç†è¯·æ±‚ |

> **ğŸ’ª ä¼˜åŒ–å»ºè®®**
> 1. å¼€å¯æœ¬åœ°ä»¤ç‰Œç¼“å­˜ï¼Œæ€§èƒ½æå‡4å€
> 2. ä½¿ç”¨å¼‚æ­¥é€šä¿¡ï¼Œé™ä½å»¶è¿Ÿ
> 3. åˆç†è®¾ç½®gRPCè¿æ¥æ± å¤§å°
> 4. ç”Ÿäº§ç¯å¢ƒå¿…é¡»éƒ¨ç½²Serveré›†ç¾¤

---

## 5. ğŸ“Š ç›‘æ§è¿ç»´å®è·µ


### 5.1 ç›‘æ§æŒ‡æ ‡ä½“ç³»


**æ ¸å¿ƒç›‘æ§æŒ‡æ ‡**ï¼š

```
ğŸ”¸ Token Serverç›‘æ§
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ ååé‡: å¤„ç†çš„ä»¤ç‰Œè¯·æ±‚æ•°/ç§’    â”‚
â”‚ â€¢ å»¶è¿Ÿ: P50/P95/P99å“åº”æ—¶é—´     â”‚
â”‚ â€¢ è¿æ¥æ•°: å½“å‰æ´»è·ƒçš„gRPCè¿æ¥    â”‚
â”‚ â€¢ æ‹’ç»ç‡: å› è¶…é™æ‹’ç»çš„è¯·æ±‚æ¯”ä¾‹   â”‚
â”‚ â€¢ èµ„æº: CPU/å†…å­˜/ç½‘ç»œä½¿ç”¨æƒ…å†µ   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ”¸ Token Clientç›‘æ§
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ ç”³è¯·æˆåŠŸç‡: ä»¤ç‰Œè·å–æˆåŠŸæ¯”ä¾‹   â”‚
â”‚ â€¢ é™çº§æ¬¡æ•°: é€€åŒ–ä¸ºå•æœºçš„æ¬¡æ•°    â”‚
â”‚ â€¢ é€šä¿¡å»¶è¿Ÿ: ä¸Serverçš„å¾€è¿”æ—¶é—´  â”‚
â”‚ â€¢ ç¼“å­˜å‘½ä¸­ç‡: æœ¬åœ°ä»¤ç‰Œä½¿ç”¨ç‡    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ”¸ ä¸šåŠ¡ç›‘æ§
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ é™æµæ‹¦æˆªæ•°: è¢«é™æµçš„è¯·æ±‚æ•°    â”‚
â”‚ â€¢ é€šè¿‡è¯·æ±‚æ•°: æ­£å¸¸å¤„ç†çš„è¯·æ±‚æ•°  â”‚
â”‚ â€¢ ä¸šåŠ¡å½±å“: é™æµå¯¹è®¢å•çš„å½±å“    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 Sentinel Dashboardé›†æˆ


**Dashboardé…ç½®**ï¼š

```yaml
# Sentinelæ§åˆ¶å°é…ç½®
spring:
  cloud:
    sentinel:
      transport:
        dashboard: localhost:8080  # Dashboardåœ°å€
        port: 8719  # ä¸Dashboardé€šä¿¡ç«¯å£
      
      # é›†ç¾¤é…ç½®æ¨é€
      datasource:
        cluster-server:
          nacos:
            server-addr: localhost:8848
            dataId: cluster-server-${spring.application.name}
            groupId: SENTINEL_GROUP
            data-type: json
            rule-type: flow  # æµæ§è§„åˆ™
```

**DashboardåŠŸèƒ½**ï¼š

```
ä¸»è¦åŠŸèƒ½ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. å®æ—¶ç›‘æ§                       â”‚
â”‚    - å®æ—¶QPSæ›²çº¿                  â”‚
â”‚    - é™æµæ‹¦æˆªç»Ÿè®¡                 â”‚
â”‚    - å“åº”æ—¶é—´åˆ†å¸ƒ                 â”‚
â”‚                                   â”‚
â”‚ 2. è§„åˆ™ç®¡ç†                       â”‚
â”‚    - å¯è§†åŒ–é…ç½®æµæ§è§„åˆ™           â”‚
â”‚    - é›†ç¾¤/å•æœºæ¨¡å¼åˆ‡æ¢            â”‚
â”‚    - è§„åˆ™æ¨é€åˆ°å„å®ä¾‹             â”‚
â”‚                                   â”‚
â”‚ 3. é›†ç¾¤ç®¡ç†                       â”‚
â”‚    - Token ServerçŠ¶æ€æŸ¥çœ‹         â”‚
â”‚    - Clientåˆ—è¡¨ä¸è¿æ¥çŠ¶æ€         â”‚
â”‚    - é›†ç¾¤æ‹“æ‰‘å±•ç¤º                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 æ—¥å¿—ä¸å‘Šè­¦


**æ—¥å¿—é…ç½®**ï¼š

```xml
<!-- logback-spring.xml -->
<configuration>
    <appender name="SENTINEL" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>logs/sentinel.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>logs/sentinel-%d{yyyy-MM-dd}.log</fileNamePattern>
            <maxHistory>30</maxHistory>
        </rollingPolicy>
        <encoder>
            <pattern>%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>
    
    <logger name="com.alibaba.csp.sentinel" level="INFO" additivity="false">
        <appender-ref ref="SENTINEL"/>
    </logger>
</configuration>
```

**å…³é”®æ—¥å¿—ç¤ºä¾‹**ï¼š

```
[INFO] Token Server started on port: 18730
[INFO] Flow rule loaded: resource=createOrder, count=1000, cluster=true
[WARN] Client connection timeout: 192.168.1.50:8080
[ERROR] Token Server unavailable, fallback to local mode
[INFO] Cluster mode recovered, switch back from local mode
```

**å‘Šè­¦è§„åˆ™é…ç½®**ï¼š

```java
// è‡ªå®šä¹‰å‘Šè­¦å¤„ç†
@Component
public class SentinelAlertHandler {
    
    @Autowired
    private AlarmService alarmService;
    
    // ç›‘å¬é™çº§äº‹ä»¶
    @EventListener
    public void onDegradeEvent(DegradeEvent event) {
        if (event.getDegradeCount() > 10) {
            alarmService.sendAlert(
                "é›†ç¾¤æµæ§é™çº§",
                "Token Serverè¿æ¥å¤±è´¥ï¼Œå·²é™çº§ä¸ºå•æœºæ¨¡å¼è¶…è¿‡10æ¬¡"
            );
        }
    }
    
    // ç›‘å¬é™æµäº‹ä»¶
    @EventListener
    public void onBlockEvent(BlockEvent event) {
        long blockQps = event.getBlockQps();
        if (blockQps > 100) {
            alarmService.sendAlert(
                "é«˜é¢‘é™æµå‘Šè­¦",
                String.format("å½“å‰é™æµQPS: %dï¼Œè¯·æ£€æŸ¥æ˜¯å¦é­å—æ”»å‡»", blockQps)
            );
        }
    }
}
```

### 5.4 è¿ç»´æœ€ä½³å®è·µ


**ğŸ”¸ éƒ¨ç½²å»ºè®®**ï¼š

```
ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ¸…å•ï¼š
âœ… Token Serverè‡³å°‘éƒ¨ç½²2ä¸ªå®ä¾‹(é«˜å¯ç”¨)
âœ… Serverä¸Clientåˆ†ç¦»éƒ¨ç½²(èŒè´£åˆ†ç¦»)
âœ… ä½¿ç”¨é…ç½®ä¸­å¿ƒç®¡ç†è§„åˆ™(Nacos/Apollo)
âœ… å¯ç”¨é™çº§ç­–ç•¥(Serveræ•…éšœæ—¶ä¿æŠ¤)
âœ… é…ç½®ç›‘æ§å‘Šè­¦(åŠæ—¶å‘ç°é—®é¢˜)
âœ… å®šæœŸå‹æµ‹(éªŒè¯æ€§èƒ½å’Œå®¹é‡)
```

**ğŸ”¸ å¸¸è§é—®é¢˜æ’æŸ¥**ï¼š

| é—®é¢˜ç°è±¡ | **å¯èƒ½åŸå› ** | **æ’æŸ¥æ­¥éª¤** | **è§£å†³æ–¹æ¡ˆ** |
|---------|------------|------------|------------|
| Clientè¿æ¥å¤±è´¥ | Serveræœªå¯åŠ¨/ç½‘ç»œä¸é€š | 1. æ£€æŸ¥Serverè¿›ç¨‹<br>2. æµ‹è¯•ç½‘ç»œè¿é€šæ€§ | å¯åŠ¨Server<br>ä¿®å¤ç½‘ç»œ |
| é™æµä¸ç”Ÿæ•ˆ | è§„åˆ™æœªæ¨é€/é…ç½®é”™è¯¯ | 1. æŸ¥çœ‹Dashboardè§„åˆ™<br>2. æ£€æŸ¥Clientæ—¥å¿— | é‡æ–°æ¨é€è§„åˆ™<br>ä¿®æ­£é…ç½® |
| æ€§èƒ½ä¸‹é™ | Serverè´Ÿè½½è¿‡é«˜ | 1. æŸ¥çœ‹Serverèµ„æº<br>2. åˆ†ææ…¢æŸ¥è¯¢ | æ‰©å®¹Server<br>ä¼˜åŒ–è§„åˆ™ |
| é¢‘ç¹é™çº§ | Serverä¸ç¨³å®š | 1. æŸ¥çœ‹Serveræ—¥å¿—<br>2. ç½‘ç»œæŠ–åŠ¨æ’æŸ¥ | ä¿®å¤Server<br>ç½‘ç»œä¼˜åŒ– |

**ğŸ”¸ è¿ç»´è„šæœ¬ç¤ºä¾‹**ï¼š

```bash
#!/bin/bash
# sentinel-health-check.sh

# æ£€æŸ¥Token Serverå¥åº·çŠ¶æ€
check_server_health() {
    server_ip=$1
    server_port=$2
    
    # å°è¯•è¿æ¥Server
    nc -zv $server_ip $server_port > /dev/null 2>&1
    
    if [ $? -eq 0 ]; then
        echo "âœ… Token Server ($server_ip:$server_port) is healthy"
        return 0
    else
        echo "âŒ Token Server ($server_ip:$server_port) is down"
        # å‘é€å‘Šè­¦
        send_alert "Token Server Down" "$server_ip:$server_port"
        return 1
    fi
}

# æ£€æŸ¥æ‰€æœ‰Server
check_server_health "192.168.1.100" "18730"
check_server_health "192.168.1.101" "18730"
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ é›†ç¾¤æµæ§æœ¬è´¨ï¼šå¤šä¸ªå®ä¾‹å…±äº«æµé‡é…é¢ï¼Œç»Ÿä¸€æ§åˆ¶æ€»é‡
ğŸ”¸ æ ¸å¿ƒè§’è‰²ï¼šToken Serverç®¡ç†é…é¢ï¼ŒToken Clientç”³è¯·ä»¤ç‰Œ
ğŸ”¸ é€‚ç”¨åœºæ™¯ï¼šæ€»é‡æ§åˆ¶ã€çƒ­ç‚¹ä¿æŠ¤ã€ç¬¬ä¸‰æ–¹APIé™é¢ç®¡ç†
ğŸ”¸ éƒ¨ç½²æ¨¡å¼ï¼šåµŒå…¥å¼(ç®€å•)ã€ç‹¬ç«‹å¼(ç¨³å®š)
ğŸ”¸ æ€§èƒ½ä¼˜åŒ–ï¼šæœ¬åœ°ç¼“å­˜ã€å¼‚æ­¥é€šä¿¡ã€è¿æ¥å¤ç”¨
ğŸ”¸ é«˜å¯ç”¨ï¼šServeré›†ç¾¤ã€é™çº§ç­–ç•¥ã€ç›‘æ§å‘Šè­¦
```

### 6.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆéœ€è¦é›†ç¾¤æµæ§**
```
å•æœºæµæ§é—®é¢˜ï¼š
â€¢ å¤šå®ä¾‹å åŠ ï¼Œæ€»é‡å¤±æ§
â€¢ æµé‡ä¸å‡ï¼Œé…é¢æµªè´¹
â€¢ æ— æ³•ç²¾ç¡®æ§åˆ¶çƒ­ç‚¹èµ„æº

é›†ç¾¤æµæ§ä¼˜åŠ¿ï¼š
â€¢ ç²¾ç¡®çš„å…¨å±€æ€»é‡æ§åˆ¶
â€¢ åŠ¨æ€é…é¢åˆ†é…ï¼Œé«˜åˆ©ç”¨ç‡
â€¢ é€‚åˆä¸¥æ ¼é™æµåœºæ™¯
```

**ğŸ”¹ æ€§èƒ½ä¸å¯ç”¨æ€§çš„å¹³è¡¡**
```
æ€§èƒ½ä¼˜åŒ–ï¼š
â€¢ æœ¬åœ°ç¼“å­˜å‡å°‘ç½‘ç»œè¯·æ±‚
â€¢ å¼‚æ­¥é€šä¿¡é™ä½å»¶è¿Ÿ
â€¢ æ‰¹é‡è·å–æå‡åå

é«˜å¯ç”¨ä¿éšœï¼š
â€¢ Serveré›†ç¾¤é˜²æ­¢å•ç‚¹æ•…éšœ
â€¢ é™çº§ç­–ç•¥ä¿è¯åŸºæœ¬å¯ç”¨
â€¢ ç›‘æ§å‘Šè­¦åŠæ—¶å‘ç°é—®é¢˜
```

**ğŸ”¹ é›†ç¾¤æµæ§ vs å•æœºæµæ§**
```
é€‰æ‹©ä¾æ®ï¼š
â€¢ éœ€è¦ç²¾ç¡®æ€»é‡æ§åˆ¶ â†’ é›†ç¾¤æµæ§
â€¢ æµé‡åˆ†å¸ƒä¸å‡ â†’ é›†ç¾¤æµæ§
â€¢ æ€§èƒ½è¦æ±‚æé«˜ â†’ å•æœºæµæ§
â€¢ éƒ¨ç½²ç®€å•ä¼˜å…ˆ â†’ å•æœºæµæ§
```

### 6.3 å®æˆ˜åº”ç”¨ä»·å€¼


**ğŸ¯ å…¸å‹åº”ç”¨åœºæ™¯**ï¼š
- **ç”µå•†ç§’æ€**ï¼š10000ä»¶åº“å­˜ï¼Œç¡®ä¿ä¸è¶…å–
- **çŸ­ä¿¡å‘é€**ï¼šè¿è¥å•†é™åˆ¶1000æ¡/åˆ†é’Ÿï¼Œå¤šå®ä¾‹å…±äº«
- **ç¬¬ä¸‰æ–¹API**ï¼šæ”¯ä»˜å®é™åˆ¶100 QPSï¼Œå…¨å±€æ§åˆ¶
- **æ•°æ®åº“ä¿æŠ¤**ï¼šå†™å…¥é™åˆ¶3000 QPSï¼Œé˜²æ­¢å‹å®DB

**ğŸ”§ å®æ–½è¦ç‚¹**ï¼š
- å¼€å‘æµ‹è¯•ï¼šåµŒå…¥å¼éƒ¨ç½²å¿«é€ŸéªŒè¯
- ç”Ÿäº§ç¯å¢ƒï¼šç‹¬ç«‹å¼éƒ¨ç½²ä¿è¯ç¨³å®š
- æ€§èƒ½è°ƒä¼˜ï¼šå¼€å¯æœ¬åœ°ç¼“å­˜å’Œå¼‚æ­¥é€šä¿¡
- é«˜å¯ç”¨ï¼šServeré›†ç¾¤+é™çº§ç­–ç•¥

**ğŸ’¡ æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
å¤šå®ä¾‹éƒ¨ç½²æ€»é‡å¤±æ§ï¼Œé›†ç¾¤æµæ§ç»Ÿä¸€åè°ƒ
Serverç®¡ç†Clientç”³è¯·ï¼Œä»¤ç‰Œæœºåˆ¶ä¿æŠ¤èµ„æº  
æœ¬åœ°ç¼“å­˜å¼‚æ­¥é€šä¿¡ï¼Œæ€§èƒ½ä¼˜åŒ–ä¸‰æ¿æ–§
é›†ç¾¤é™çº§ç›‘æ§å‘Šè­¦ï¼Œé«˜å¯ç”¨è®¾è®¡ä¸èƒ½å°‘
```

> **ğŸ“ å­¦ä¹ å»ºè®®**
> 1. å…ˆç†è§£å•æœºæµæ§åŸç†
> 2. æŒæ¡é›†ç¾¤æµæ§çš„å¿…è¦æ€§
> 3. åŠ¨æ‰‹æ­å»ºåµŒå…¥å¼é›†ç¾¤
> 4. ç”Ÿäº§ç¯å¢ƒé‡‡ç”¨ç‹¬ç«‹å¼éƒ¨ç½²
> 5. é‡ç‚¹å…³æ³¨æ€§èƒ½ä¼˜åŒ–å’Œé«˜å¯ç”¨è®¾è®¡

---

**ğŸ“š æ‰©å±•é˜…è¯»**ï¼š
- Sentinelå®˜æ–¹æ–‡æ¡£ï¼šé›†ç¾¤æµæ§è¯¦è§£
- é«˜å¹¶å‘ç³»ç»Ÿè®¾è®¡ï¼šæµé‡æ§åˆ¶æœ€ä½³å®è·µ
- å¾®æœåŠ¡å®¹é”™ï¼šç†”æ–­é™çº§ä¸é™æµç­–ç•¥