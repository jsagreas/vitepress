---
title: 5ã€æ³¨è§£é«˜çº§ç”¨æ³•
---
## ðŸ“š ç›®å½•

1. [@SentinelResourceæ ¸å¿ƒç†è§£](#1-SentinelResourceæ ¸å¿ƒç†è§£)
2. [å¼‚å¸¸å¤„ç†æœºåˆ¶](#2-å¼‚å¸¸å¤„ç†æœºåˆ¶)
3. [å‚æ•°ä¼ é€’ä¸ŽåŠ¨æ€é…ç½®](#3-å‚æ•°ä¼ é€’ä¸ŽåŠ¨æ€é…ç½®)
4. [æ¡ä»¶åˆ¤æ–­ä¸Žå¤æ‚åœºæ™¯](#4-æ¡ä»¶åˆ¤æ–­ä¸Žå¤æ‚åœºæ™¯)
5. [æ³¨è§£é…ç½®æœ€ä½³å®žè·µ](#5-æ³¨è§£é…ç½®æœ€ä½³å®žè·µ)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ðŸŽ¯ @SentinelResourceæ ¸å¿ƒç†è§£


### 1.1 ä»€ä¹ˆæ˜¯@SentinelResource


> **ðŸ’¡ é€šä¿—ç†è§£**
> 
> @SentinelResourceå°±åƒç»™ä½ çš„æ–¹æ³•åŠ äº†ä¸€å±‚"ä¿æŠ¤ç½©"ã€‚å½“ä½ çš„æ–¹æ³•å¯èƒ½å‡ºé—®é¢˜æ—¶ï¼ˆæ¯”å¦‚è¢«è®¿é—®å¤ªå¤šæ¬¡ã€è°ƒç”¨è¶…æ—¶ï¼‰ï¼Œè¿™ä¸ªä¿æŠ¤ç½©ä¼šè‡ªåŠ¨å¯åŠ¨ï¼Œä¿æŠ¤ä½ çš„ç³»ç»Ÿä¸å´©æºƒã€‚

**æ ¸å¿ƒä½œç”¨ï¼š**
```
æ™®é€šæ–¹æ³•è°ƒç”¨ï¼š
ç”¨æˆ·è¯·æ±‚ â†’ ç›´æŽ¥æ‰§è¡Œæ–¹æ³• â†’ è¿”å›žç»“æžœï¼ˆå¯èƒ½å´©æºƒï¼‰

åŠ äº†@SentinelResourceï¼š
ç”¨æˆ·è¯·æ±‚ â†’ Sentinelæ£€æŸ¥ï¼ˆæµé‡ã€ç†”æ–­ç­‰ï¼‰ â†’ æ‰§è¡Œæ–¹æ³• â†’ è¿”å›žç»“æžœ
           â†“ (å¦‚æžœè¶…é™)
        æ‰§è¡Œé™çº§æ–¹æ³• â†’ è¿”å›žå¤‡ç”¨ç»“æžœï¼ˆç³»ç»Ÿå®‰å…¨ï¼‰
```

### 1.2 åŸºæœ¬ä½¿ç”¨æ–¹å¼


**æœ€ç®€å•çš„ç”¨æ³•ï¼š**
```java
@Service
public class OrderService {
    
    // valueï¼šç»™è¿™ä¸ªèµ„æºèµ·ä¸ªåå­—ï¼Œæ–¹ä¾¿åœ¨æŽ§åˆ¶å°é…ç½®è§„åˆ™
    @SentinelResource(value = "createOrder")
    public String createOrder(String userId) {
        // ä½ çš„ä¸šåŠ¡é€»è¾‘
        return "è®¢å•åˆ›å»ºæˆåŠŸ";
    }
}
```

**å…³é”®ç†è§£ï¼š**
- `value = "createOrder"`ï¼šè¿™æ˜¯èµ„æºåç§°ï¼ŒåŽç»­æ‰€æœ‰çš„é™æµã€é™çº§è§„åˆ™éƒ½æ˜¯é’ˆå¯¹è¿™ä¸ªåå­—é…ç½®çš„
- Sentinelä¼šè‡ªåŠ¨ç›‘æŽ§è¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨æƒ…å†µ
- ä¸éœ€è¦å†™ä»»ä½•é¢å¤–ä»£ç ï¼ŒSentinelå°±èƒ½ç»Ÿè®¡QPSã€å“åº”æ—¶é—´ç­‰æŒ‡æ ‡

### 1.3 æ ¸å¿ƒå±žæ€§ä¸€è§ˆ


| å±žæ€§ | **ä½œç”¨** | **ä»€ä¹ˆæ—¶å€™ç”¨** | **ä¸¾ä¾‹** |
|------|---------|---------------|---------|
| `value` | `èµ„æºåç§°` | `å¿…å¡«ï¼Œç»™èµ„æºå‘½å` | `"createOrder"` |
| `blockHandler` | `é™æµ/ç†”æ–­æ—¶è°ƒç”¨çš„æ–¹æ³•` | `æµé‡å¤ªå¤§éœ€è¦é™çº§` | `"handleBlock"` |
| `fallback` | `å‡ºå¼‚å¸¸æ—¶è°ƒç”¨çš„æ–¹æ³•` | `ä»£ç æ‰§è¡Œå‡ºé”™` | `"handleFallback"` |
| `exceptionsToIgnore` | `å¿½ç•¥æŸäº›å¼‚å¸¸` | `ç‰¹å®šå¼‚å¸¸ä¸é™çº§` | `IllegalArgumentException.class` |

---

## 2. ðŸ›¡ï¸ å¼‚å¸¸å¤„ç†æœºåˆ¶


### 2.1 ä¸¤ç§å¤„ç†æ–¹å¼çš„åŒºåˆ«


**blockHandler vs fallbackï¼šæ–°æ‰‹æœ€å®¹æ˜“æ··æ·†ï¼**

```
blockHandlerï¼šæµæŽ§è§„åˆ™è§¦å‘æ—¶æ‰§è¡Œ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¯·æ±‚å¤ªå¤šè¶…è¿‡é™åˆ¶          â”‚ â†’ blockHandlerå¤„ç†
â”‚ ç†”æ–­å™¨æ‰“å¼€               â”‚ â†’ blockHandlerå¤„ç†
â”‚ ç³»ç»Ÿä¿æŠ¤è§„åˆ™è§¦å‘          â”‚ â†’ blockHandlerå¤„ç†
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

fallbackï¼šä»£ç æ‰§è¡Œå‡ºé”™æ—¶æ‰§è¡Œ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç©ºæŒ‡é’ˆå¼‚å¸¸               â”‚ â†’ fallbackå¤„ç†
â”‚ æ•°æ®åº“è¿žæŽ¥å¤±è´¥            â”‚ â†’ fallbackå¤„ç†
â”‚ è¿œç¨‹è°ƒç”¨è¶…æ—¶             â”‚ â†’ fallbackå¤„ç†
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> **ðŸ”§ è®°å¿†æŠ€å·§**
> - **blockHandler**ï¼šSentinelä¸»åŠ¨"æ‹¦æˆª"ï¼ˆblockï¼‰è¯·æ±‚
> - **fallback**ï¼šä»£ç æ‰§è¡Œ"å¤±è´¥"ï¼ˆfallï¼‰åŽçš„å¤‡ç”¨æ–¹æ¡ˆ

### 2.2 blockHandlerä½¿ç”¨ç¤ºä¾‹


**åœºæ™¯ï¼šè®¢å•æŽ¥å£é™æµä¿æŠ¤**

```java
@Service
public class OrderService {
    
    // æ­£å¸¸ä¸šåŠ¡æ–¹æ³•
    @SentinelResource(
        value = "createOrder",
        blockHandler = "orderBlockHandler"  // æŒ‡å®šé™çº§æ–¹æ³•
    )
    public String createOrder(String userId, String productId) {
        // åˆ›å»ºè®¢å•çš„ä¸šåŠ¡é€»è¾‘
        return "è®¢å•åˆ›å»ºæˆåŠŸï¼Œè®¢å•å·ï¼š" + System.currentTimeMillis();
    }
    
    // é™çº§æ–¹æ³•ï¼šå½“æµé‡è¶…é™æ—¶è‡ªåŠ¨è°ƒç”¨è¿™ä¸ªæ–¹æ³•
    // âš ï¸ æ³¨æ„ï¼šå‚æ•°å¿…é¡»å’ŒåŽŸæ–¹æ³•ä¸€è‡´ï¼Œæœ€åŽåŠ ä¸€ä¸ªBlockException
    public String orderBlockHandler(String userId, String productId, 
                                    BlockException ex) {
        // è¿”å›žå‹å¥½çš„æç¤ºä¿¡æ¯
        return "å½“å‰ä¸‹å•äººæ•°è¿‡å¤šï¼Œè¯·ç¨åŽå†è¯•";
    }
}
```

**å…³é”®ç‚¹ç†è§£ï¼š**
```
1. æ–¹æ³•ç­¾åå¿…é¡»åŒ¹é…ï¼š
   åŽŸæ–¹æ³•ï¼šcreateOrder(String userId, String productId)
   é™çº§æ–¹æ³•ï¼šorderBlockHandler(String userId, String productId, BlockException ex)
   
2. BlockExceptionå‚æ•°ï¼š
   - è¿™ä¸ªå‚æ•°å‘Šè¯‰ä½ æ˜¯ä»€ä¹ˆåŽŸå› è§¦å‘çš„é™çº§
   - FlowExceptionï¼šæµé‡æŽ§åˆ¶
   - DegradeExceptionï¼šç†”æ–­é™çº§
   - SystemBlockExceptionï¼šç³»ç»Ÿä¿æŠ¤
```

### 2.3 fallbackä½¿ç”¨ç¤ºä¾‹


**åœºæ™¯ï¼šè¿œç¨‹è°ƒç”¨å¤±è´¥ä¿æŠ¤**

```java
@Service
public class ProductService {
    
    @Autowired
    private RestTemplate restTemplate;
    
    // è°ƒç”¨åº“å­˜æœåŠ¡
    @SentinelResource(
        value = "getStock",
        fallback = "stockFallback"  // å‡ºé”™æ—¶çš„å¤‡ç”¨æ–¹æ¡ˆ
    )
    public Integer getStock(String productId) {
        // è¿œç¨‹è°ƒç”¨å¯èƒ½å¤±è´¥
        String url = "http://stock-service/stock/" + productId;
        return restTemplate.getForObject(url, Integer.class);
    }
    
    // å¤‡ç”¨æ–¹æ³•ï¼šè°ƒç”¨å¤±è´¥æ—¶è¿”å›žé»˜è®¤å€¼
    public Integer stockFallback(String productId, Throwable ex) {
        System.out.println("åº“å­˜æœåŠ¡è°ƒç”¨å¤±è´¥ï¼š" + ex.getMessage());
        return 0;  // è¿”å›žåº“å­˜ä¸º0ï¼Œé¿å…ç³»ç»Ÿå´©æºƒ
    }
}
```

### 2.4 åŒæ—¶ä½¿ç”¨blockHandlerå’Œfallback


**å®Œæ•´ä¿æŠ¤æ–¹æ¡ˆï¼š**

```java
@Service
public class OrderService {
    
    @SentinelResource(
        value = "submitOrder",
        blockHandler = "handleBlock",    // æµæŽ§é™çº§
        fallback = "handleFallback"      // å¼‚å¸¸é™çº§
    )
    public String submitOrder(String orderId) {
        // å¯èƒ½è§¦å‘æµæŽ§ï¼ˆå¤ªå¤šè¯·æ±‚ï¼‰
        // ä¹Ÿå¯èƒ½æŠ›å‡ºå¼‚å¸¸ï¼ˆä»£ç bugã€ç½‘ç»œé—®é¢˜ç­‰ï¼‰
        return processOrder(orderId);
    }
    
    // æµæŽ§è§¦å‘æ—¶è°ƒç”¨
    public String handleBlock(String orderId, BlockException ex) {
        return "ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åŽé‡è¯•";
    }
    
    // å¼‚å¸¸è§¦å‘æ—¶è°ƒç”¨
    public String handleFallback(String orderId, Throwable ex) {
        return "è®¢å•å¤„ç†å¤±è´¥ï¼Œè¯·è”ç³»å®¢æœ";
    }
}
```

**æ‰§è¡Œä¼˜å…ˆçº§ï¼š**
```
è¯·æ±‚åˆ°æ¥
   â†“
SentinelæµæŽ§æ£€æŸ¥
   â†“
è¶…é™ï¼Ÿ â”€Yesâ†’ blockHandler â”€â”€â†’ è¿”å›ž
   â†“ No
æ‰§è¡Œä¸šåŠ¡æ–¹æ³•
   â†“
å‡ºå¼‚å¸¸ï¼Ÿ â”€Yesâ†’ fallback â”€â”€â†’ è¿”å›ž
   â†“ No
æ­£å¸¸è¿”å›žç»“æžœ
```

---

## 3. ðŸ”„ å‚æ•°ä¼ é€’ä¸ŽåŠ¨æ€é…ç½®


### 3.1 å‚æ•°ä¼ é€’çš„å®Œæ•´è§„åˆ™


**blockHandleræ–¹æ³•çš„å‚æ•°è§„åˆ™ï¼š**

> **ðŸ“‹ å‚æ•°åŒ¹é…è§„åˆ™**
> 
> åŽŸæ–¹æ³•æœ‰å‡ ä¸ªå‚æ•°ï¼ŒblockHandleræ–¹æ³•å°±è¦æœ‰å‡ ä¸ª**ç›¸åŒç±»åž‹**çš„å‚æ•°ï¼Œæœ€åŽå†åŠ ä¸€ä¸ª`BlockException`å‚æ•°

**ç¤ºä¾‹å¯¹ç…§ï¼š**

| åŽŸæ–¹æ³•ç­¾å | blockHandleræ–¹æ³•ç­¾å | è¯´æ˜Ž |
|-----------|-------------------|------|
| `String method(String id)` | `String handler(String id, BlockException ex)` | `å•å‚æ•°` |
| `void method(String id, Integer num)` | `void handler(String id, Integer num, BlockException ex)` | `å¤šå‚æ•°` |
| `Order method(OrderDTO dto)` | `Order handler(OrderDTO dto, BlockException ex)` | `å¯¹è±¡å‚æ•°` |

**å®žé™…ä»£ç ï¼š**
```java
// åŽŸæ–¹æ³•
@SentinelResource(value = "updateUser", blockHandler = "updateUserBlock")
public void updateUser(String userId, String name, Integer age) {
    // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
}

// blockHandleræ–¹æ³• - å‚æ•°å®Œå…¨å¯¹åº”
public void updateUserBlock(String userId, String name, Integer age, 
                            BlockException ex) {
    // å‚æ•°userId, name, ageå¯ä»¥ç›´æŽ¥ä½¿ç”¨
    log.warn("ç”¨æˆ·{}æ›´æ–°å¤±è´¥ï¼ŒåŽŸå› ï¼š{}", userId, ex.getClass().getName());
}
```

### 3.2 fallbackæ–¹æ³•çš„å‚æ•°è§„åˆ™


**fallbackæ–¹æ³•çš„å‚æ•°è§„åˆ™ï¼š**

```
åŽŸæ–¹æ³•å‚æ•° + Throwableå¼‚å¸¸å‚æ•°

ä¸ºä»€ä¹ˆæ˜¯Throwableï¼Ÿ
- Throwableæ˜¯æ‰€æœ‰å¼‚å¸¸çš„çˆ¶ç±»
- å¯ä»¥æ•èŽ·æ‰€æœ‰ç±»åž‹çš„å¼‚å¸¸
- BlockExceptionåªèƒ½æŽ¥æ”¶Sentinelçš„è§„åˆ™å¼‚å¸¸
```

**å¯¹æ¯”ç¤ºä¾‹ï¼š**
```java
@Service
public class PaymentService {
    
    @SentinelResource(
        value = "pay",
        blockHandler = "payBlock",
        fallback = "payFallback"
    )
    public String pay(String orderId, Double amount) {
        // æ”¯ä»˜é€»è¾‘
        return "æ”¯ä»˜æˆåŠŸ";
    }
    
    // blockHandlerï¼šæœ€åŽæ˜¯BlockException
    public String payBlock(String orderId, Double amount, BlockException ex) {
        return "æ”¯ä»˜äººæ•°è¿‡å¤šï¼Œè¯·ç¨åŽå†è¯•";
    }
    
    // fallbackï¼šæœ€åŽæ˜¯Throwable
    public String payFallback(String orderId, Double amount, Throwable ex) {
        return "æ”¯ä»˜å¤±è´¥ï¼š" + ex.getMessage();
    }
}
```

### 3.3 å‚æ•°ä½¿ç”¨æŠ€å·§


**æŠ€å·§1ï¼šåœ¨é™çº§æ–¹æ³•ä¸­ä½¿ç”¨åŽŸæ–¹æ³•å‚æ•°**

```java
@SentinelResource(value = "queryOrder", fallback = "queryOrderFallback")
public Order queryOrder(String orderId, String userId) {
    return orderMapper.findById(orderId);
}

// å¯ä»¥ç”¨åŽŸæ–¹æ³•çš„å‚æ•°åšä¸ªæ€§åŒ–å¤„ç†
public Order queryOrderFallback(String orderId, String userId, Throwable ex) {
    log.error("ç”¨æˆ·{}æŸ¥è¯¢è®¢å•{}å¤±è´¥", userId, orderId, ex);
    
    // è¿”å›žä¸€ä¸ªé»˜è®¤è®¢å•å¯¹è±¡ï¼Œé¿å…ç©ºæŒ‡é’ˆ
    Order defaultOrder = new Order();
    defaultOrder.setOrderId(orderId);
    defaultOrder.setStatus("æŸ¥è¯¢å¤±è´¥");
    return defaultOrder;
}
```

**æŠ€å·§2ï¼šå¿½ç•¥ç‰¹å®šå¼‚å¸¸**

```java
@SentinelResource(
    value = "register",
    fallback = "registerFallback",
    exceptionsToIgnore = {IllegalArgumentException.class}  // å‚æ•°å¼‚å¸¸ä¸é™çº§
)
public String register(String username, String password) {
    if (username == null || username.isEmpty()) {
        throw new IllegalArgumentException("ç”¨æˆ·åä¸èƒ½ä¸ºç©º");
    }
    // æ³¨å†Œé€»è¾‘
    return "æ³¨å†ŒæˆåŠŸ";
}

// IllegalArgumentExceptionä¼šç›´æŽ¥æŠ›å‡ºï¼Œä¸ä¼šè¿›å…¥è¿™ä¸ªæ–¹æ³•
public String registerFallback(String username, String password, Throwable ex) {
    return "æ³¨å†Œå¤±è´¥ï¼Œè¯·é‡è¯•";
}
```

---

## 4. ðŸŽ¯ æ¡ä»¶åˆ¤æ–­ä¸Žå¤æ‚åœºæ™¯


### 4.1 æ ¹æ®å¼‚å¸¸ç±»åž‹åšä¸åŒå¤„ç†


**åœºæ™¯ï¼šåŒºåˆ†ä¸åŒå¼‚å¸¸è¿”å›žä¸åŒä¿¡æ¯**

```java
@Service
public class UserService {
    
    @SentinelResource(value = "login", fallback = "loginFallback")
    public String login(String username, String password) {
        // å„ç§å¯èƒ½çš„å¼‚å¸¸
        User user = userMapper.findByUsername(username);
        if (user == null) {
            throw new UserNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨");
        }
        if (!user.getPassword().equals(password)) {
            throw new PasswordErrorException("å¯†ç é”™è¯¯");
        }
        return "ç™»å½•æˆåŠŸ";
    }
    
    // æ ¹æ®å¼‚å¸¸ç±»åž‹è¿”å›žä¸åŒæç¤º
    public String loginFallback(String username, String password, Throwable ex) {
        if (ex instanceof UserNotFoundException) {
            return "ç”¨æˆ·åä¸å­˜åœ¨ï¼Œè¯·å…ˆæ³¨å†Œ";
        } else if (ex instanceof PasswordErrorException) {
            return "å¯†ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥";
        } else {
            return "ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·ç¨åŽé‡è¯•";
        }
    }
}
```

### 4.2 åŠ¨æ€è¿”å›žå€¼å¤„ç†


**åœºæ™¯ï¼šæ ¹æ®å‚æ•°å’Œå¼‚å¸¸è¿”å›žä¸åŒå†…å®¹**

```java
@Service
public class DiscountService {
    
    @SentinelResource(value = "getDiscount", fallback = "discountFallback")
    public Double getDiscount(String userId, String level) {
        // æ ¹æ®ç”¨æˆ·ç­‰çº§è®¡ç®—æŠ˜æ‰£
        return calculateDiscount(level);
    }
    
    // æ ¹æ®ç”¨æˆ·ç­‰çº§è¿”å›žä¸åŒçš„é»˜è®¤æŠ˜æ‰£
    public Double discountFallback(String userId, String level, Throwable ex) {
        log.error("ç”¨æˆ·{}èŽ·å–æŠ˜æ‰£å¤±è´¥", userId, ex);
        
        // æ ¹æ®ç­‰çº§è¿”å›žä¿åº•æŠ˜æ‰£
        switch (level) {
            case "VIP":
                return 0.8;   // VIPé»˜è®¤8æŠ˜
            case "SVIP":
                return 0.6;   // SVIPé»˜è®¤6æŠ˜
            default:
                return 0.95;  // æ™®é€šç”¨æˆ·é»˜è®¤9.5æŠ˜
        }
    }
}
```

### 4.3 å¤æ‚åœºæ™¯ï¼šç»“åˆçƒ­ç‚¹å‚æ•°é™æµ


**åœºæ™¯ï¼šé’ˆå¯¹ä¸åŒå•†å“IDè®¾ç½®ä¸åŒçš„é™æµè§„åˆ™**

```java
@Service
public class ProductService {
    
    // çƒ­ç‚¹å‚æ•°é™æµï¼šé’ˆå¯¹ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆproductIdï¼‰
    @SentinelResource(
        value = "buyProduct",
        blockHandler = "buyProductBlock"
    )
    public String buyProduct(String productId, Integer count) {
        // è´­ä¹°å•†å“é€»è¾‘
        return "è´­ä¹°æˆåŠŸ";
    }
    
    public String buyProductBlock(String productId, Integer count, BlockException ex) {
        // å¯ä»¥æ ¹æ®å•†å“IDè¿”å›žä¸åŒæç¤º
        if ("HOT001".equals(productId)) {
            return "è¯¥å•†å“è¿‡äºŽç«çˆ†ï¼Œè¯·ç¨åŽå†è¯•";
        } else {
            return "å½“å‰è´­ä¹°äººæ•°è¾ƒå¤šï¼Œè¯·æŽ’é˜Ÿç­‰å€™";
        }
    }
}
```

**é…åˆæŽ§åˆ¶å°é…ç½®ï¼š**
```
èµ„æºåï¼šbuyProduct
å‚æ•°ç´¢å¼•ï¼š0ï¼ˆç¬¬ä¸€ä¸ªå‚æ•°productIdï¼‰
è§„åˆ™ï¼š
- é»˜è®¤QPSï¼š100
- å•†å“HOT001çš„QPSï¼š10ï¼ˆçƒ­é—¨å•†å“ç‰¹æ®Šé™åˆ¶ï¼‰
- å•†å“NORMAL001çš„QPSï¼š50
```

---

## 5. âš™ï¸ æ³¨è§£é…ç½®æœ€ä½³å®žè·µ


### 5.1 é…ç½®è§„èŒƒå»ºè®®


**è§„èŒƒ1ï¼šèµ„æºå‘½åæ¸…æ™°**

```java
// âŒ ä¸å¥½çš„å‘½å
@SentinelResource(value = "method1")

// âœ… å¥½çš„å‘½åï¼šä¸šåŠ¡å«ä¹‰æ¸…æ™°
@SentinelResource(value = "order:create")
@SentinelResource(value = "user:login")
@SentinelResource(value = "product:detail")
```

**è§„èŒƒ2ï¼šé™çº§æ–¹æ³•å°±è¿‘æ”¾ç½®**

```java
@Service
public class OrderService {
    
    // ä¸šåŠ¡æ–¹æ³•
    @SentinelResource(value = "createOrder", blockHandler = "createOrderBlock")
    public String createOrder(String userId) {
        // ä¸šåŠ¡é€»è¾‘
    }
    
    // âœ… é™çº§æ–¹æ³•ç´§è·Ÿå…¶åŽï¼Œæ–¹ä¾¿ç»´æŠ¤
    public String createOrderBlock(String userId, BlockException ex) {
        return "ä¸‹å•å¤±è´¥ï¼Œè¯·é‡è¯•";
    }
    
    // ä¸‹ä¸€ä¸ªä¸šåŠ¡æ–¹æ³•
    @SentinelResource(value = "cancelOrder", blockHandler = "cancelOrderBlock")
    public String cancelOrder(String orderId) {
        // å–æ¶ˆè®¢å•é€»è¾‘
    }
    
    // å¯¹åº”çš„é™çº§æ–¹æ³•
    public String cancelOrderBlock(String orderId, BlockException ex) {
        return "å–æ¶ˆå¤±è´¥ï¼Œè¯·é‡è¯•";
    }
}
```

### 5.2 å¸¸è§é”™è¯¯ä¸Žè§£å†³


**é”™è¯¯1ï¼šé™çº§æ–¹æ³•å‚æ•°ä¸åŒ¹é…**

```java
// âŒ é”™è¯¯ç¤ºä¾‹
@SentinelResource(value = "test", blockHandler = "testBlock")
public String test(String id, Integer num) {
    return "ok";
}

// å‚æ•°ç±»åž‹ä¸å¯¹ï¼
public String testBlock(String id, String num, BlockException ex) {
    return "error";
}

// âœ… æ­£ç¡®å†™æ³•
public String testBlock(String id, Integer num, BlockException ex) {
    return "error";
}
```

**é”™è¯¯2ï¼šé™çº§æ–¹æ³•è®¿é—®æƒé™é—®é¢˜**

```java
// âŒ é”™è¯¯ï¼šé™çº§æ–¹æ³•æ˜¯private
@SentinelResource(value = "test", blockHandler = "testBlock")
public String test() {
    return "ok";
}

private String testBlock(BlockException ex) {  // privateä¼šæ‰¾ä¸åˆ°ï¼
    return "error";
}

// âœ… æ­£ç¡®ï¼šå¿…é¡»æ˜¯publicæˆ–è€…é»˜è®¤æƒé™
public String testBlock(BlockException ex) {
    return "error";
}
```

### 5.3 å®Œæ•´é…ç½®ç¤ºä¾‹


**ç”Ÿäº§çº§åˆ«çš„å®Œæ•´é…ç½®ï¼š**

```java
@Service
@Slf4j
public class OrderService {
    
    @Autowired
    private OrderMapper orderMapper;
    
    /**
     * åˆ›å»ºè®¢å•
     * - é™æµä¿æŠ¤ï¼šé˜²æ­¢æµé‡è¿‡å¤§
     * - å¼‚å¸¸é™çº§ï¼šæ•°æ®åº“æ•…éšœæ—¶è¿”å›žé»˜è®¤å€¼
     */
    @SentinelResource(
        value = "order:create",
        blockHandler = "createOrderBlock",
        fallback = "createOrderFallback",
        exceptionsToIgnore = {IllegalArgumentException.class}
    )
    public OrderResult createOrder(String userId, OrderDTO orderDTO) {
        // å‚æ•°æ ¡éªŒï¼ˆIllegalArgumentExceptionä¸ä¼šè§¦å‘é™çº§ï¼‰
        if (userId == null || orderDTO == null) {
            throw new IllegalArgumentException("å‚æ•°ä¸èƒ½ä¸ºç©º");
        }
        
        // åˆ›å»ºè®¢å•
        Order order = new Order();
        order.setUserId(userId);
        order.setAmount(orderDTO.getAmount());
        orderMapper.insert(order);
        
        return OrderResult.success(order);
    }
    
    /**
     * æµæŽ§é™çº§æ–¹æ³•
     */
    public OrderResult createOrderBlock(String userId, OrderDTO orderDTO, 
                                       BlockException ex) {
        log.warn("è®¢å•åˆ›å»ºè¢«é™æµï¼Œç”¨æˆ·ï¼š{}", userId);
        return OrderResult.fail("å½“å‰ä¸‹å•äººæ•°è¿‡å¤šï¼Œè¯·ç¨åŽå†è¯•");
    }
    
    /**
     * å¼‚å¸¸é™çº§æ–¹æ³•
     */
    public OrderResult createOrderFallback(String userId, OrderDTO orderDTO, 
                                          Throwable ex) {
        log.error("è®¢å•åˆ›å»ºå¼‚å¸¸ï¼Œç”¨æˆ·ï¼š{}", userId, ex);
        return OrderResult.fail("è®¢å•åˆ›å»ºå¤±è´¥ï¼Œè¯·é‡è¯•æˆ–è”ç³»å®¢æœ");
    }
}
```

---

## 6. ðŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŽŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ðŸ”¸ @SentinelResourceï¼šç»™æ–¹æ³•åŠ ä¿æŠ¤ï¼Œç›‘æŽ§å’Œé™æµçš„å…¥å£
ðŸ”¸ blockHandlerï¼šæµæŽ§è§„åˆ™è§¦å‘æ—¶çš„é™çº§æ–¹æ³•
ðŸ”¸ fallbackï¼šä»£ç å¼‚å¸¸æ—¶çš„é™çº§æ–¹æ³•
ðŸ”¸ å‚æ•°åŒ¹é…ï¼šé™çº§æ–¹æ³•å‚æ•°å¿…é¡»å’ŒåŽŸæ–¹æ³•ä¸€è‡´
ðŸ”¸ å¼‚å¸¸ç±»åž‹ï¼šBlockExceptionç”¨äºŽblockHandlerï¼ŒThrowableç”¨äºŽfallback
```

### 6.2 å…³é”®ç†è§£è¦ç‚¹


**ðŸ”¹ ä¸¤ç§é™çº§çš„åŒºåˆ«**
```
blockHandlerï¼šSentinelä¸»åŠ¨æ‹¦æˆª
- æµé‡è¶…é™
- ç†”æ–­å™¨æ‰“å¼€
- ç³»ç»Ÿä¿æŠ¤è§¦å‘

fallbackï¼šä»£ç æ‰§è¡Œå¤±è´¥
- ç©ºæŒ‡é’ˆå¼‚å¸¸
- æ•°æ®åº“å¼‚å¸¸
- è¿œç¨‹è°ƒç”¨å¤±è´¥
```

**ðŸ”¹ å‚æ•°ä¼ é€’è§„åˆ™**
```
blockHandlerï¼šåŽŸå‚æ•° + BlockException
fallbackï¼šåŽŸå‚æ•° + Throwable

ä¸ºä»€ä¹ˆä¸åŒï¼Ÿ
- BlockExceptionæ˜¯Sentinelä¸“ç”¨å¼‚å¸¸
- Throwableå¯ä»¥æ•èŽ·æ‰€æœ‰å¼‚å¸¸
```

**ðŸ”¹ æ‰§è¡Œä¼˜å…ˆçº§**
```
è¯·æ±‚æµç¨‹ï¼š
1. Sentinelè§„åˆ™æ£€æŸ¥
2. è§¦å‘é™æµï¼Ÿâ†’ blockHandler
3. æ‰§è¡Œä¸šåŠ¡æ–¹æ³•
4. æŠ›å‡ºå¼‚å¸¸ï¼Ÿâ†’ fallback
5. æ­£å¸¸è¿”å›ž
```

### 6.3 å®žæˆ˜åº”ç”¨å»ºè®®


**ðŸ“ é…ç½®æ£€æŸ¥æ¸…å•ï¼š**

- [ ] èµ„æºåç§°æ˜¯å¦æ¸…æ™°æ˜“æ‡‚
- [ ] blockHandleræ–¹æ³•å‚æ•°æ˜¯å¦æ­£ç¡®
- [ ] fallbackæ–¹æ³•å‚æ•°æ˜¯å¦æ­£ç¡®
- [ ] é™çº§æ–¹æ³•è®¿é—®æƒé™æ˜¯å¦æ­£ç¡®ï¼ˆpublicï¼‰
- [ ] æ˜¯å¦éœ€è¦å¿½ç•¥æŸäº›å¼‚å¸¸
- [ ] é™çº§è¿”å›žå€¼æ˜¯å¦å‹å¥½
- [ ] æ—¥å¿—è®°å½•æ˜¯å¦å®Œå–„

**ðŸŽ¯ ä½¿ç”¨åœºæ™¯é€‰æ‹©ï¼š**

| åœºæ™¯ | **ä½¿ç”¨æ–¹æ¡ˆ** | **åŽŸå› ** |
|------|------------|---------|
| `é«˜å¹¶å‘æŽ¥å£` | `blockHandler` | `é˜²æ­¢æµé‡å†²å‡»` |
| `è¿œç¨‹è°ƒç”¨` | `fallback` | `é˜²æ­¢è°ƒç”¨å¤±è´¥` |
| `å…³é”®ä¸šåŠ¡` | `ä¸¤è€…éƒ½ç”¨` | `å…¨é¢ä¿æŠ¤` |
| `æŸ¥è¯¢æŽ¥å£` | `fallback` | `å¼‚å¸¸æ—¶è¿”å›žé»˜è®¤å€¼` |

**ðŸ”§ è°ƒè¯•æŠ€å·§ï¼š**

```java
// åœ¨é™çº§æ–¹æ³•ä¸­åŠ è¯¦ç»†æ—¥å¿—
public String handleFallback(String param, Throwable ex) {
    // æ‰“å°å®Œæ•´å¼‚å¸¸ä¿¡æ¯
    log.error("æ–¹æ³•é™çº§ï¼Œå‚æ•°ï¼š{}ï¼Œå¼‚å¸¸ï¼š", param, ex);
    
    // è®°å½•å¼‚å¸¸ç±»åž‹
    log.error("å¼‚å¸¸ç±»åž‹ï¼š{}", ex.getClass().getName());
    
    return "é™çº§è¿”å›ž";
}
```

**æ ¸å¿ƒè®°å¿†å£è¯€ï¼š**
- é™æµç”¨blockHandlerï¼Œå¼‚å¸¸ç”¨fallback
- å‚æ•°è¦å¯¹åº”ï¼Œå¼‚å¸¸ç±»åž‹åˆ«æžé”™
- èµ„æºå‘½åæ¸…æ™°ï¼Œé™çº§è¿”å›žå‹å¥½
- æ—¥å¿—è®°å½•è¯¦ç»†ï¼Œé—®é¢˜å¥½æŽ’æŸ¥

---

> **âš¡ å¿«é€Ÿå‚è€ƒå¡ç‰‡**
> 
> **æ³¨è§£å±žæ€§ï¼š**
> - `value`ï¼šèµ„æºåç§°ï¼ˆå¿…å¡«ï¼‰
> - `blockHandler`ï¼šé™æµé™çº§æ–¹æ³•
> - `fallback`ï¼šå¼‚å¸¸é™çº§æ–¹æ³•
> - `exceptionsToIgnore`ï¼šå¿½ç•¥çš„å¼‚å¸¸
> 
> **æ–¹æ³•ç­¾åï¼š**
> - blockHandlerï¼š`åŽŸå‚æ•° + BlockException`
> - fallbackï¼š`åŽŸå‚æ•° + Throwable`
> 
> **è®°å¿†è¦ç‚¹ï¼š**
> - Block = æ‹¦æˆªï¼ˆæµæŽ§ï¼‰
> - Fallback = å¤‡ç”¨ï¼ˆå¼‚å¸¸ï¼‰