---
title: 3ã€æ¥æºè¯†åˆ«é…ç½®
---
## ğŸ“š ç›®å½•

1. [æ¥æºè¯†åˆ«æ˜¯ä»€ä¹ˆ](#1-æ¥æºè¯†åˆ«æ˜¯ä»€ä¹ˆ)
2. [RequestOriginParseræ ¸å¿ƒæ¥å£](#2-requestoriginparseræ ¸å¿ƒæ¥å£)
3. [æ¥æºè¯†åˆ«é…ç½®å®ç°](#3-æ¥æºè¯†åˆ«é…ç½®å®ç°)
4. [å®æˆ˜åº”ç”¨åœºæ™¯](#4-å®æˆ˜åº”ç”¨åœºæ™¯)
5. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#5-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ æ¥æºè¯†åˆ«æ˜¯ä»€ä¹ˆ


### 1.1 é€šä¿—ç†è§£


**ç”Ÿæ´»åœºæ™¯ç±»æ¯”**ï¼š
```
æƒ³è±¡ä¸€ä¸ªé«˜æ¡£å°åŒºçš„é—¨ç¦ç³»ç»Ÿï¼š
ğŸ‘¤ ä¸šä¸»åˆ·å¡è¿›å…¥    â†’ ç›´æ¥æ”¾è¡Œ
ğŸ‘¥ è®¿å®¢ç™»è®°ä¿¡æ¯    â†’ è®°å½•æ¥è®¿
ğŸš« é»‘åå•äººå‘˜      â†’ æ‹’ç»è¿›å…¥
```

**åœ¨å¾®æœåŠ¡ä¸­**ï¼š
```
åŒæ ·çš„é“ç†ï¼š
âœ… å¯ä¿¡ä»»çš„æœåŠ¡    â†’ æ­£å¸¸è®¿é—®
âš ï¸  æ™®é€šç”¨æˆ·è¯·æ±‚    â†’ é™æµæ§åˆ¶
ğŸš« æ¶æ„è¯·æ±‚æ¥æº    â†’ ç›´æ¥æ‹¦æˆª
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦æ¥æºè¯†åˆ«


**æ ¸å¿ƒç›®çš„**ï¼š
- ğŸ” **è¯†åˆ«è¯·æ±‚è€…** - çŸ¥é“æ˜¯è°åœ¨è°ƒç”¨æˆ‘çš„æœåŠ¡
- ğŸ›¡ï¸ **å®‰å…¨é˜²æŠ¤** - åŒºåˆ†å¯ä¿¡å’Œä¸å¯ä¿¡çš„æ¥æº
- âš–ï¸ **å·®å¼‚åŒ–å¤„ç†** - å¯¹ä¸åŒæ¥æºé‡‡ç”¨ä¸åŒç­–ç•¥
- ğŸ“Š **ç²¾å‡†æ§åˆ¶** - åŸºäºæ¥æºåšæµé‡ç®¡ç†

**å®é™…é—®é¢˜**ï¼š
```
åœºæ™¯ï¼šè®¢å•æœåŠ¡è¢«å¤§é‡è°ƒç”¨
é—®é¢˜ï¼šä¸çŸ¥é“è¯·æ±‚æ¥è‡ªå“ªé‡Œï¼Ÿ
      - æ˜¯æ­£å¸¸ç”¨æˆ·ï¼Ÿ
      - æ˜¯å…¶ä»–å¾®æœåŠ¡ï¼Ÿ
      - è¿˜æ˜¯æ¶æ„æ”»å‡»ï¼Ÿ

è§£å†³ï¼šé€šè¿‡æ¥æºè¯†åˆ«
      â†’ æ ‡è®°æ¯ä¸ªè¯·æ±‚çš„æ¥æº
      â†’ é’ˆå¯¹æ€§åœ°è¿›è¡Œæ§åˆ¶
```

---

## 2. ğŸ”§ RequestOriginParseræ ¸å¿ƒæ¥å£


### 2.1 æ¥å£å®šä¹‰ä¸ä½œç”¨


**æ ¸å¿ƒæ¥å£**ï¼š
```java
public interface RequestOriginParser {
    /**
     * ä»è¯·æ±‚ä¸­è§£æå‡ºæ¥æºæ ‡è¯†
     * @param request HTTPè¯·æ±‚å¯¹è±¡
     * @return æ¥æºæ ‡è¯†å­—ç¬¦ä¸²
     */
    String parseOrigin(HttpServletRequest request);
}
```

**é€šä¿—ç†è§£**ï¼š
```
è¿™ä¸ªæ¥å£å°±æ˜¯ä¸€ä¸ª"èº«ä»½è¯†åˆ«å™¨"ï¼š

è¾“å…¥ï¼šHTTPè¯·æ±‚
å¤„ç†ï¼šæå–æ¥æºä¿¡æ¯
è¾“å‡ºï¼šæ¥æºæ ‡è¯†ï¼ˆæ¯”å¦‚ï¼š"app"ã€"web"ã€"admin"ï¼‰

ç±»æ¯”ï¼š
å°±åƒå¿«é€’å‘˜çœ‹åŒ…è£¹ä¸Šçš„å¯„ä»¶åœ°å€
â†’ çŸ¥é“è¿™ä¸ªåŒ…è£¹ä»å“ªé‡Œæ¥çš„
```

### 2.2 å·¥ä½œåŸç†å›¾ç¤º


```
HTTPè¯·æ±‚è¿›æ¥
    â†“
RequestOriginParser è§£æ
    â†“
æå–æ¥æºæ ‡è¯† (origin)
    â†“
    â”œâ”€â†’ "app"     â†’ ç§»åŠ¨ç«¯è¯·æ±‚
    â”œâ”€â†’ "web"     â†’ ç½‘é¡µè¯·æ±‚
    â”œâ”€â†’ "internal"â†’ å†…éƒ¨æœåŠ¡
    â””â”€â†’ "unknown" â†’ æœªçŸ¥æ¥æº
    â†“
ä¼ é€’ç»™ Sentinel è§„åˆ™å¼•æ“
    â†“
æ ¹æ®é»‘ç™½åå•åˆ¤æ–­æ˜¯å¦å…è®¸
```

---

## 3. ğŸ’» æ¥æºè¯†åˆ«é…ç½®å®ç°


### 3.1 åŸºç¡€å®ç°æ–¹å¼


**æ–¹å¼ä¸€ï¼šä»è¯·æ±‚å¤´è·å–æ¥æº**

```java
@Component
public class HeaderOriginParser implements RequestOriginParser {
    
    @Override
    public String parseOrigin(HttpServletRequest request) {
        // ä»è¯·æ±‚å¤´ä¸­è·å–æ¥æºæ ‡è¯†
        String origin = request.getHeader("X-Origin");
        
        // å¦‚æœæ²¡æœ‰ï¼Œè¿”å›é»˜è®¤å€¼
        return origin != null ? origin : "unknown";
    }
}
```

**è¯´æ˜**ï¼š
- ğŸ“ æœ€ç®€å•çš„æ–¹å¼ï¼šä»HTTPè¯·æ±‚å¤´å–å€¼
- ğŸ”‘ çº¦å®šå¥½å¤´éƒ¨åç§°ï¼ˆæ¯”å¦‚ `X-Origin`ï¼‰
- âš ï¸ å®¢æˆ·ç«¯éœ€è¦åœ¨è¯·æ±‚æ—¶å¸¦ä¸Šè¿™ä¸ªå¤´éƒ¨

**æ–¹å¼äºŒï¼šä»è¯·æ±‚å‚æ•°è·å–**

```java
@Component
public class ParamOriginParser implements RequestOriginParser {
    
    @Override
    public String parseOrigin(HttpServletRequest request) {
        // ä»URLå‚æ•°ä¸­è·å–
        String origin = request.getParameter("origin");
        
        // æ”¯æŒå¤šç§å‚æ•°å
        if (origin == null) {
            origin = request.getParameter("source");
        }
        
        return origin != null ? origin : "unknown";
    }
}
```

**è¯´æ˜**ï¼š
- ğŸ“Œ ä»URLå‚æ•°è¯»å–ï¼š`/api/order?origin=app`
- ğŸ”„ å¯ä»¥æ”¯æŒå¤šä¸ªå‚æ•°åä½œä¸ºå¤‡é€‰
- ğŸ’¡ é€‚åˆç®€å•åœºæ™¯

### 3.2 è¿›é˜¶å®ç° - å¤šæ¥æºç»¼åˆåˆ¤æ–­


**æ™ºèƒ½è¯†åˆ«å®ç°**ï¼š

```java
@Component
public class SmartOriginParser implements RequestOriginParser {
    
    @Override
    public String parseOrigin(HttpServletRequest request) {
        
        // 1ï¸âƒ£ ä¼˜å…ˆä»è‡ªå®šä¹‰è¯·æ±‚å¤´è·å–
        String origin = request.getHeader("X-Client-Type");
        if (origin != null) {
            return origin;
        }
        
        // 2ï¸âƒ£ é€šè¿‡User-Agentåˆ¤æ–­
        String userAgent = request.getHeader("User-Agent");
        if (userAgent != null) {
            if (userAgent.contains("Mobile")) {
                return "mobile-app";
            }
            if (userAgent.contains("MicroMessenger")) {
                return "wechat";
            }
        }
        
        // 3ï¸âƒ£ é€šè¿‡IPæ®µåˆ¤æ–­ï¼ˆå†…ç½‘æœåŠ¡ï¼‰
        String ip = request.getRemoteAddr();
        if (ip.startsWith("192.168.") || ip.startsWith("10.")) {
            return "internal-service";
        }
        
        // 4ï¸âƒ£ é»˜è®¤æœªçŸ¥æ¥æº
        return "unknown";
    }
}
```

**è¯†åˆ«é€»è¾‘è¯´æ˜**ï¼š

| ä¼˜å…ˆçº§ | è¯†åˆ«æ–¹å¼ | æ¥æºæ ‡è¯† | é€‚ç”¨åœºæ™¯ |
|--------|----------|----------|----------|
| **1** | `è‡ªå®šä¹‰è¯·æ±‚å¤´` | å®¢æˆ·ç«¯ä¸»åŠ¨å£°æ˜ | ğŸ¯ æ˜ç¡®æ ‡è¯†çš„å®¢æˆ·ç«¯ |
| **2** | `User-Agent` | æ ¹æ®æµè§ˆå™¨ç‰¹å¾ | ğŸ“± ç§»åŠ¨ç«¯/WebåŒºåˆ† |
| **3** | `IPåœ°å€æ®µ` | å†…ç½‘IPè¯†åˆ« | ğŸ¢ å†…éƒ¨æœåŠ¡è°ƒç”¨ |
| **4** | `é»˜è®¤å€¼` | unknown | â“ å…¶ä»–æœªçŸ¥æ¥æº |

### 3.3 æ³¨å†Œè§£æå™¨


**é…ç½®ç±»æ³¨å†Œ**ï¼š

```java
@Configuration
public class SentinelConfig {
    
    @Bean
    public RequestOriginParser requestOriginParser() {
        return new SmartOriginParser();
    }
}
```

**è¯´æ˜**ï¼š
- âœ… æ³¨å†Œä¸ºSpring Beanå³å¯ç”Ÿæ•ˆ
- ğŸ”„ Sentinelä¼šè‡ªåŠ¨è°ƒç”¨è¿™ä¸ªè§£æå™¨
- ğŸ“ æ¯ä¸ªè¯·æ±‚éƒ½ä¼šç»è¿‡è§£æ

---

## 4. ğŸš€ å®æˆ˜åº”ç”¨åœºæ™¯


### 4.1 åœºæ™¯ä¸€ï¼šåŒºåˆ†å†…å¤–éƒ¨è°ƒç”¨


**éœ€æ±‚**ï¼šå†…éƒ¨æœåŠ¡è°ƒç”¨ä¸é™æµï¼Œå¤–éƒ¨è¯·æ±‚è¦é™æµ

**å®ç°æ­¥éª¤**ï¼š

**æ­¥éª¤1ï¼šé…ç½®æ¥æºè§£æ**
```java
@Component
public class InternalOriginParser implements RequestOriginParser {
    
    @Override
    public String parseOrigin(HttpServletRequest request) {
        // å†…éƒ¨æœåŠ¡éƒ½å¸¦è¿™ä¸ªtoken
        String token = request.getHeader("Internal-Token");
        
        if ("secret-internal-key".equals(token)) {
            return "internal";  // å†…éƒ¨æ¥æº
        }
        return "external";      // å¤–éƒ¨æ¥æº
    }
}
```

**æ­¥éª¤2ï¼šé…ç½®æˆæƒè§„åˆ™**
```java
@PostConstruct
public void initRules() {
    List<AuthorityRule> rules = new ArrayList<>();
    
    AuthorityRule rule = new AuthorityRule();
    rule.setResource("orderService");
    rule.setStrategy(RuleConstant.AUTHORITY_WHITE);
    rule.setLimitApp("internal");  // åªå…è®¸internalæ¥æº
    
    rules.add(rule);
    AuthorityRuleManager.loadRules(rules);
}
```

**æ•ˆæœæ¼”ç¤º**ï¼š
```
è¯·æ±‚1ï¼šå¸¦ Internal-Token: secret-internal-key
      â†“ è§£æä¸º "internal"
      â†“ åŒ¹é…ç™½åå•
      â†’ âœ… æ”¾è¡Œï¼ˆå†…éƒ¨æœåŠ¡ï¼‰

è¯·æ±‚2ï¼šä¸å¸¦ Internal-Token
      â†“ è§£æä¸º "external"  
      â†“ ä¸åœ¨ç™½åå•
      â†’ ğŸš« æ‹’ç»ï¼ˆå¤–éƒ¨è¯·æ±‚ï¼‰
```

### 4.2 åœºæ™¯äºŒï¼šå¤šæ¸ é“å·®å¼‚åŒ–é™æµ


**éœ€æ±‚**ï¼š
- APPç«¯ï¼šQPSé™åˆ¶1000
- ç½‘é¡µç«¯ï¼šQPSé™åˆ¶500
- ç®¡ç†åå°ï¼šä¸é™æµ

**å®ç°**ï¼š

```java
// æ¥æºè¯†åˆ«
@Component
public class ChannelOriginParser implements RequestOriginParser {
    
    @Override
    public String parseOrigin(HttpServletRequest request) {
        String channel = request.getHeader("X-Channel");
        
        if (channel == null) {
            // æ ¹æ®åŸŸååˆ¤æ–­
            String host = request.getHeader("Host");
            if (host.contains("admin")) {
                return "admin";
            }
            if (host.contains("m.")) {
                return "app";
            }
            return "web";
        }
        
        return channel;
    }
}

// é™æµè§„åˆ™é…ç½®
@PostConstruct
public void initFlowRules() {
    List<FlowRule> rules = new ArrayList<>();
    
    // APPç«¯é™æµ
    FlowRule appRule = new FlowRule("orderService");
    appRule.setLimitApp("app");
    appRule.setCount(1000);
    appRule.setGrade(RuleConstant.FLOW_GRADE_QPS);
    rules.add(appRule);
    
    // Webç«¯é™æµ
    FlowRule webRule = new FlowRule("orderService");
    webRule.setLimitApp("web");
    webRule.setCount(500);
    rules.add(webRule);
    
    FlowRuleManager.loadRules(rules);
}
```

**æ•ˆæœå¯¹æ¯”**ï¼š

```
æ¥æºè¯†åˆ«ç»“æœ â†’ åº”ç”¨è§„åˆ™
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app         â†’ é™æµ1000 QPS
web         â†’ é™æµ500 QPS  
admin       â†’ ä¸é™æµ
unknown     â†’ é»˜è®¤è§„åˆ™
```

### 4.3 åœºæ™¯ä¸‰ï¼šå®‰å…¨é˜²æŠ¤ - é»‘åå•


**éœ€æ±‚**ï¼šæ‹¦æˆªå·²çŸ¥çš„æ¶æ„æ¥æº

```java
// è§£ææ¶æ„æ¥æº
@Component
public class SecurityOriginParser implements RequestOriginParser {
    
    // æ¶æ„IPåˆ—è¡¨ï¼ˆå®é™…åº”ä»æ•°æ®åº“æˆ–Redisè¯»å–ï¼‰
    private Set<String> blackIPs = new HashSet<>();
    
    @Override
    public String parseOrigin(HttpServletRequest request) {
        String ip = getClientIP(request);
        
        // åˆ¤æ–­æ˜¯å¦åœ¨é»‘åå•
        if (blackIPs.contains(ip)) {
            return "malicious";  // æ¶æ„æ¥æº
        }
        
        return "normal";  // æ­£å¸¸æ¥æº
    }
    
    private String getClientIP(HttpServletRequest request) {
        String ip = request.getHeader("X-Forwarded-For");
        if (ip == null) {
            ip = request.getRemoteAddr();
        }
        return ip;
    }
}

// é»‘åå•è§„åˆ™
@PostConstruct
public void initBlackList() {
    AuthorityRule rule = new AuthorityRule();
    rule.setResource("orderService");
    rule.setStrategy(RuleConstant.AUTHORITY_BLACK);
    rule.setLimitApp("malicious");  // æ‹’ç»æ¶æ„æ¥æº
    
    AuthorityRuleManager.loadRules(Arrays.asList(rule));
}
```

---

## 5. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 5.1 å…³é”®æ¦‚å¿µå›é¡¾


**RequestOriginParser æ ¸å¿ƒä½œç”¨**ï¼š
```
ğŸ“ ä½œç”¨ï¼šä»HTTPè¯·æ±‚ä¸­æå–æ¥æºæ ‡è¯†
ğŸ”§ æ–¹æ³•ï¼šparseOrigin(HttpServletRequest)
ğŸ“¤ è¿”å›ï¼šæ¥æºæ ‡è¯†å­—ç¬¦ä¸²ï¼ˆoriginï¼‰
```

**æ¥æºè¯†åˆ«çš„ä»·å€¼**ï¼š
- âœ… **å®‰å…¨é˜²æŠ¤** - åŒºåˆ†å¯ä¿¡/ä¸å¯ä¿¡æ¥æº
- âœ… **ç²¾å‡†æ§åˆ¶** - é’ˆå¯¹æ¥æºå®šåˆ¶è§„åˆ™
- âœ… **å·®å¼‚åŒ–æœåŠ¡** - ä¸åŒæ¥æºä¸åŒå¾…é‡

### 5.2 å®ç°æ–¹å¼å¯¹æ¯”


| æ–¹å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| **è¯·æ±‚å¤´** | æ˜ç¡®å¯æ§ | éœ€å®¢æˆ·ç«¯é…åˆ | ğŸ¯ å·²çŸ¥å®¢æˆ·ç«¯ |
| **URLå‚æ•°** | ç®€å•ç›´è§‚ | å®¹æ˜“ä¼ªé€  | ğŸ“ æµ‹è¯•/ç®€å•åœºæ™¯ |
| **User-Agent** | è‡ªåŠ¨è¯†åˆ« | ä¸å¤Ÿç²¾å‡† | ğŸ“± ç§»åŠ¨/WebåŒºåˆ† |
| **IPåœ°å€** | æ— éœ€é…åˆ | å¯èƒ½è¢«ä»£ç† | ğŸ¢ å†…ç½‘æœåŠ¡ |
| **ç»¼åˆåˆ¤æ–­** | å‡†ç¡®æ€§é«˜ | å®ç°å¤æ‚ | ğŸš€ ç”Ÿäº§ç¯å¢ƒ |

### 5.3 æœ€ä½³å®è·µå»ºè®®


**â­ æ¨èåšæ³•**ï¼š
```
1ï¸âƒ£ å¤šå±‚æ¬¡è¯†åˆ«
   ä¼˜å…ˆè‡ªå®šä¹‰å¤´ â†’ å…¶æ¬¡User-Agent â†’ æœ€åIP

2ï¸âƒ£ åˆç†è®¾ç½®é»˜è®¤å€¼
   æœªè¯†åˆ«çš„ç»Ÿä¸€æ ‡è®°ä¸º "unknown"

3ï¸âƒ£ é…åˆæˆæƒè§„åˆ™ä½¿ç”¨
   é»‘åå•æ‹¦æˆª + ç™½åå•æ”¾è¡Œ

4ï¸âƒ£ åŠ¨æ€æ›´æ–°æ¥æºè§„åˆ™
   æ”¯æŒè¿è¡Œæ—¶è°ƒæ•´é»‘ç™½åå•
```

**âš ï¸ æ³¨æ„äº‹é¡¹**ï¼š
```
âŒ ä¸è¦å®Œå…¨ä¾èµ–è¯·æ±‚å¤´ï¼ˆå®¹æ˜“ä¼ªé€ ï¼‰
âŒ ä¸è¦ç¡¬ç¼–ç æ¥æºå€¼ï¼ˆä¸ä¾¿ç»´æŠ¤ï¼‰
âœ… ç»“åˆå¤šç§è¯†åˆ«æ–¹å¼
âœ… åšå¥½æ—¥å¿—è®°å½•å’Œç›‘æ§
```

### 5.4 è®°å¿†è¦ç‚¹


**æ ¸å¿ƒæµç¨‹**ï¼š
```
HTTPè¯·æ±‚ â†’ RequestOriginParserè§£æ â†’ æå–origin
         â†“
    ä¼ é€’ç»™Sentinel
         â†“
    é»‘ç™½åå•åˆ¤æ–­ â†’ æ”¾è¡Œ/æ‹’ç»
```

**ä¸€å¥è¯æ€»ç»“**ï¼š
> **æ¥æºè¯†åˆ«æ˜¯Sentinelçš„"é—¨å«ç³»ç»Ÿ"ï¼Œé€šè¿‡è¯†åˆ«è¯·æ±‚æ¥æºï¼Œå®ç°ç²¾å‡†çš„è®¿é—®æ§åˆ¶å’Œå®‰å…¨é˜²æŠ¤ã€‚**

---

**ğŸ¯ å­¦ä¹ æ£€æŸ¥æ¸…å•**ï¼š
- [ ] ç†è§£æ¥æºè¯†åˆ«çš„ä½œç”¨å’Œä»·å€¼
- [ ] æŒæ¡RequestOriginParseræ¥å£ç”¨æ³•
- [ ] èƒ½å®ç°åŸºæœ¬çš„æ¥æºè§£æå™¨
- [ ] äº†è§£å¤šç§è¯†åˆ«æ–¹å¼çš„ä¼˜åŠ£
- [ ] èƒ½ç»“åˆå®é™…åœºæ™¯åº”ç”¨