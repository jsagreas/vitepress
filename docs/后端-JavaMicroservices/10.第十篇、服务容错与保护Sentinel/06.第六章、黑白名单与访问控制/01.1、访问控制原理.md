---
title: 1ã€è®¿é—®æ§åˆ¶åŸç†
---
## ğŸ“š ç›®å½•

1. [è®¿é—®æ§åˆ¶åŸºç¡€](#1-è®¿é—®æ§åˆ¶åŸºç¡€)
2. [é»‘ç™½åå•æœºåˆ¶è¯¦è§£](#2-é»‘ç™½åå•æœºåˆ¶è¯¦è§£)
3. [æˆæƒè§„åˆ™é…ç½®å®æˆ˜](#3-æˆæƒè§„åˆ™é…ç½®å®æˆ˜)
4. [æ¥æºè¯†åˆ«ä¸è¯·æ±‚é‰´åˆ«](#4-æ¥æºè¯†åˆ«ä¸è¯·æ±‚é‰´åˆ«)
5. [å®é™…åº”ç”¨åœºæ™¯](#5-å®é™…åº”ç”¨åœºæ™¯)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” è®¿é—®æ§åˆ¶åŸºç¡€


### 1.1 ä»€ä¹ˆæ˜¯è®¿é—®æ§åˆ¶


**é€šä¿—ç†è§£**ï¼šå°±åƒå°åŒºé—¨ç¦ä¸€æ ·ï¼Œå†³å®šè°èƒ½è¿›æ¥ã€è°ä¸èƒ½è¿›æ¥

```
ç°å®ç”Ÿæ´»ç±»æ¯”ï¼š
å°åŒºé—¨ç¦ç³»ç»Ÿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Sentinelè®¿é—®æ§åˆ¶
ä¸šä¸»åˆ·å¡è¿›å…¥          åˆæ³•æ¥æºæ­£å¸¸è®¿é—®
é™Œç”Ÿäººè¢«æ‹¦æˆª          éæ³•æ¥æºè¢«æ‹’ç»
è®¿å®¢ç™»è®°åæ”¾è¡Œ        æˆæƒåå…è®¸é€šè¿‡
```

**æ ¸å¿ƒä½œç”¨**ï¼š
- ğŸ›¡ï¸ **å®‰å…¨é˜²æŠ¤**ï¼šé˜»æ­¢æ¶æ„è¯·æ±‚è®¿é—®ç³»ç»Ÿ
- ğŸ¯ **ç²¾å‡†æ§åˆ¶**ï¼šåªå…è®¸ç‰¹å®šæ¥æºè®¿é—®èµ„æº
- ğŸ“Š **æµé‡ç®¡ç†**ï¼šåŒºåˆ†ä¸åŒæ¥æºçš„è¯·æ±‚ï¼Œåˆ†åˆ«å¤„ç†
- ğŸ” **é—®é¢˜è¿½è¸ª**ï¼šå¿«é€Ÿå®šä½å¼‚å¸¸è¯·æ±‚æ¥æº

### 1.2 è®¿é—®æ§åˆ¶çš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ”¸ æˆæƒè§„åˆ™ï¼ˆAuthority Ruleï¼‰**
```
å®šä¹‰ï¼šç”¨æ¥å®šä¹‰å“ªäº›æ¥æºå¯ä»¥è®¿é—®èµ„æº
ä½œç”¨ï¼šè®¾ç½®è®¿é—®çš„"è§„çŸ©"

å°±åƒè®¾å®šè§„åˆ™ï¼š
- åªæœ‰VIPç”¨æˆ·æ‰èƒ½è®¿é—®é«˜çº§åŠŸèƒ½
- åªæœ‰å†…éƒ¨ç³»ç»Ÿæ‰èƒ½è°ƒç”¨æ ¸å¿ƒæ¥å£
- ç¦æ­¢æŸäº›IPè®¿é—®æ•æ„Ÿèµ„æº
```

**ğŸ”¸ æ¥æºè¯†åˆ«ï¼ˆOriginï¼‰**
```
å®šä¹‰ï¼šè¯†åˆ«è¯·æ±‚æ˜¯ä»å“ªé‡Œæ¥çš„
æ–¹å¼ï¼šé€šè¿‡IPã€åº”ç”¨åã€ç”¨æˆ·æ ‡è¯†ç­‰

ç±»æ¯”å¿«é€’é…é€ï¼š
- é…é€åœ°å€ â†’ è¯·æ±‚æ¥æºIP
- å‘ä»¶äºº â†’ è°ƒç”¨æ–¹åº”ç”¨å
- è®¢å•å· â†’ è¯·æ±‚å”¯ä¸€æ ‡è¯†
```

**ğŸ”¸ é»‘ç™½åå•**
```
ç™½åå•ï¼šåªå…è®¸åå•å†…çš„è®¿é—®ï¼ˆå®‰å…¨æ€§é«˜ï¼‰
é»‘åå•ï¼šåªæ‹’ç»åå•å†…çš„è®¿é—®ï¼ˆçµæ´»æ€§é«˜ï¼‰

ç”Ÿæ´»ä¾‹å­ï¼š
ç™½åå• â†’ é…’åº—ä½å®¢åå•ï¼Œåªæœ‰ç™»è®°çš„æ‰èƒ½å…¥ä½
é»‘åå• â†’ èˆªç©ºé»‘åå•ï¼Œåå•ä¸Šçš„äººç¦æ­¢ç™»æœº
```

### 1.3 è®¿é—®æ§åˆ¶çš„å·¥ä½œæµç¨‹


```
è¯·æ±‚åˆ°è¾¾
   â†“
æå–æ¥æºä¿¡æ¯ï¼ˆIPã€åº”ç”¨åç­‰ï¼‰
   â†“
æ£€æŸ¥æˆæƒè§„åˆ™
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç™½åå•ï¼Ÿ â”‚ é»‘åå•ï¼Ÿ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“           â†“
   æ˜¯           å¦
     â†“           â†“
  æ”¾è¡Œ        æ‹’ç»
```

**å¤„ç†é€»è¾‘**ï¼š
1. **æå–æ¥æº**ï¼šä»è¯·æ±‚ä¸­è·å–æ¥æºæ ‡è¯†
2. **è§„åˆ™åŒ¹é…**ï¼šå¯¹æ¯”æˆæƒè§„åˆ™
3. **å†³ç­–åˆ¤æ–­**ï¼šå†³å®šæ”¾è¡Œè¿˜æ˜¯æ‹’ç»
4. **æ‰§è¡ŒåŠ¨ä½œ**ï¼šé€šè¿‡æˆ–æŠ›å‡ºå¼‚å¸¸

---

## 2. ğŸ“‹ é»‘ç™½åå•æœºåˆ¶è¯¦è§£


### 2.1 ç™½åå•æœºåˆ¶


**ğŸ”¸ ç™½åå•åŸç†**
```
ç­–ç•¥ï¼šåªå…è®¸åå•å†…çš„æ¥æºè®¿é—®
ç‰¹ç‚¹ï¼šé»˜è®¤æ‹’ç»ï¼Œæ˜ç¡®å…è®¸

é€‚ç”¨åœºæ™¯ï¼š
âœ… å†…éƒ¨æ ¸å¿ƒæ¥å£ï¼ˆåªå…è®¸å†…éƒ¨ç³»ç»Ÿè°ƒç”¨ï¼‰
âœ… æ•æ„Ÿæ•°æ®è®¿é—®ï¼ˆåªå…è®¸æˆæƒç”¨æˆ·ï¼‰
âœ… ä»˜è´¹åŠŸèƒ½ä½¿ç”¨ï¼ˆåªå…è®¸VIPç”¨æˆ·ï¼‰
```

**é…ç½®æ–¹å¼**ï¼š
```java
// å®šä¹‰ç™½åå•æˆæƒè§„åˆ™
AuthorityRule rule = new AuthorityRule();
rule.setResource("sensitive-api");           // èµ„æºåç§°
rule.setStrategy(RuleConstant.AUTHORITY_WHITE); // ç™½åå•ç­–ç•¥
rule.setLimitApp("app1,app2");               // å…è®¸çš„æ¥æº

// æ„æ€ï¼šåªå…è®¸ app1 å’Œ app2 è®¿é—® sensitive-api
```

**æ‰§è¡Œæ•ˆæœ**ï¼š
```
æ¥æºapp1 â†’ æ£€æŸ¥è§„åˆ™ â†’ åœ¨ç™½åå• â†’ âœ… å…è®¸è®¿é—®
æ¥æºapp3 â†’ æ£€æŸ¥è§„åˆ™ â†’ ä¸åœ¨ç™½åå• â†’ âŒ æ‹’ç»è®¿é—®
```

### 2.2 é»‘åå•æœºåˆ¶


**ğŸ”¸ é»‘åå•åŸç†**
```
ç­–ç•¥ï¼šåªæ‹’ç»åå•å†…çš„æ¥æºè®¿é—®
ç‰¹ç‚¹ï¼šé»˜è®¤å…è®¸ï¼Œæ˜ç¡®æ‹’ç»

é€‚ç”¨åœºæ™¯ï¼š
âœ… æ¶æ„IPæ‹¦æˆªï¼ˆæ‹¦æˆªå·²çŸ¥çš„æ”»å‡»IPï¼‰
âœ… é—®é¢˜åº”ç”¨éš”ç¦»ï¼ˆä¸´æ—¶ç¦ç”¨æ•…éšœç³»ç»Ÿï¼‰
âœ… é™çº§ä¿æŠ¤ï¼ˆç´§æ€¥æƒ…å†µä¸‹é™åˆ¶æŸäº›æ¥æºï¼‰
```

**é…ç½®æ–¹å¼**ï¼š
```java
// å®šä¹‰é»‘åå•æˆæƒè§„åˆ™
AuthorityRule rule = new AuthorityRule();
rule.setResource("public-api");              // èµ„æºåç§°
rule.setStrategy(RuleConstant.AUTHORITY_BLACK); // é»‘åå•ç­–ç•¥
rule.setLimitApp("bad-app");                 // æ‹’ç»çš„æ¥æº

// æ„æ€ï¼šæ‹’ç» bad-app è®¿é—® public-apiï¼Œå…¶ä»–æ¥æºéƒ½å¯ä»¥
```

**æ‰§è¡Œæ•ˆæœ**ï¼š
```
æ¥æºgood-app â†’ æ£€æŸ¥è§„åˆ™ â†’ ä¸åœ¨é»‘åå• â†’ âœ… å…è®¸è®¿é—®
æ¥æºbad-app  â†’ æ£€æŸ¥è§„åˆ™ â†’ åœ¨é»‘åå• â†’ âŒ æ‹’ç»è®¿é—®
```

### 2.3 é»‘ç™½åå•å¯¹æ¯”


| ç‰¹æ€§ | **ç™½åå•** | **é»‘åå•** |
|------|-----------|-----------|
| ğŸ¯ **é»˜è®¤ç­–ç•¥** | `æ‹’ç»æ‰€æœ‰ï¼Œæ˜ç¡®å…è®¸` | `å…è®¸æ‰€æœ‰ï¼Œæ˜ç¡®æ‹’ç»` |
| ğŸ”’ **å®‰å…¨æ€§** | `é«˜ï¼ˆæ›´ä¸¥æ ¼ï¼‰` | `ä¸­ï¼ˆç›¸å¯¹å®½æ¾ï¼‰` |
| ğŸ”§ **ç»´æŠ¤æˆæœ¬** | `é«˜ï¼ˆéœ€è¦ç»´æŠ¤å…è®¸åˆ—è¡¨ï¼‰` | `ä½ï¼ˆåªç»´æŠ¤ç¦æ­¢åˆ—è¡¨ï¼‰` |
| ğŸ“Š **é€‚ç”¨åœºæ™¯** | `æ ¸å¿ƒæ¥å£ã€æ•æ„Ÿæ•°æ®` | `å…¬å¼€æ¥å£ã€æ¶æ„æ‹¦æˆª` |
| âš¡ **çµæ´»æ€§** | `ä½ï¼ˆæ–°å¢æ¥æºéœ€é…ç½®ï¼‰` | `é«˜ï¼ˆé»˜è®¤éƒ½å¯ä»¥è®¿é—®ï¼‰` |

**é€‰æ‹©å»ºè®®**ï¼š
```
æ ¸å¿ƒèµ„æº â†’ ç”¨ç™½åå•ï¼ˆå®å¯è¯¯æ‹¦ï¼Œä¸å¯æ¼æ”¾ï¼‰
æ™®é€šèµ„æº â†’ ç”¨é»‘åå•ï¼ˆæ–¹ä¾¿ä½¿ç”¨ï¼ŒæŒ‰éœ€æ‹¦æˆªï¼‰
```

---

## 3. ğŸ› ï¸ æˆæƒè§„åˆ™é…ç½®å®æˆ˜


### 3.1 åŸºç¡€é…ç½®æ–¹å¼


**æ–¹å¼ä¸€ï¼šä»£ç é…ç½®ï¼ˆç¡¬ç¼–ç ï¼‰**
```java
@PostConstruct
public void initRules() {
    List<AuthorityRule> rules = new ArrayList<>();
    
    // é…ç½®ç™½åå•è§„åˆ™
    AuthorityRule whiteRule = new AuthorityRule();
    whiteRule.setResource("order-service");
    whiteRule.setStrategy(RuleConstant.AUTHORITY_WHITE);
    whiteRule.setLimitApp("web-app,mobile-app");
    rules.add(whiteRule);
    
    // é…ç½®é»‘åå•è§„åˆ™
    AuthorityRule blackRule = new AuthorityRule();
    blackRule.setResource("public-api");
    blackRule.setStrategy(RuleConstant.AUTHORITY_BLACK);
    blackRule.setLimitApp("malicious-app");
    rules.add(blackRule);
    
    // åŠ è½½è§„åˆ™
    AuthorityRuleManager.loadRules(rules);
}
```

**æ–¹å¼äºŒï¼šæ§åˆ¶å°é…ç½®ï¼ˆåŠ¨æ€ç®¡ç†ï¼‰**
```
è®¿é—®Sentinelæ§åˆ¶å°ï¼š
1. é€‰æ‹©åº”ç”¨ â†’ æˆæƒè§„åˆ™
2. ç‚¹å‡»"æ–°å¢æˆæƒè§„åˆ™"
3. å¡«å†™é…ç½®ï¼š
   - èµ„æºåï¼šorder-service
   - æµæ§åº”ç”¨ï¼šweb-app,mobile-app
   - æˆæƒç±»å‹ï¼šç™½åå•
4. ä¿å­˜ç”Ÿæ•ˆ
```

### 3.2 è§„åˆ™å‚æ•°è¯¦è§£


| å‚æ•° | **è¯´æ˜** | **ç¤ºä¾‹å€¼** |
|------|---------|-----------|
| `resource` | `å—ä¿æŠ¤çš„èµ„æºåç§°` | `"user-api"` |
| `limitApp` | `æ¥æºåº”ç”¨åˆ—è¡¨ï¼Œé€—å·åˆ†éš”` | `"app1,app2"` |
| `strategy` | `ç­–ç•¥ç±»å‹ï¼š0-ç™½åå• 1-é»‘åå•` | `RuleConstant.AUTHORITY_WHITE` |

**âš ï¸ é‡è¦æç¤º**ï¼š
```
limitApp é…ç½®æ³¨æ„ï¼š
âœ… å¤šä¸ªæ¥æºç”¨é€—å·åˆ†éš”ï¼š"app1,app2,app3"
âœ… ä¸èƒ½æœ‰ç©ºæ ¼ï¼š"app1,app2" âœ“  "app1, app2" âœ—
âœ… å¤§å°å†™æ•æ„Ÿï¼š"App1" å’Œ "app1" æ˜¯ä¸åŒçš„
```

### 3.3 å¤šè§„åˆ™ç»„åˆé…ç½®


**åœºæ™¯ï¼šè®¢å•æœåŠ¡çš„è®¿é—®æ§åˆ¶**
```java
// éœ€æ±‚ï¼š
// 1. åªå…è®¸webå’Œmobileè®¿é—®ä¸‹å•æ¥å£
// 2. ç¦æ­¢å·²çŸ¥çš„æ¶æ„åº”ç”¨è®¿é—®
// 3. æŸ¥è¯¢æ¥å£å¼€æ”¾ç»™æ‰€æœ‰äººï¼Œä½†æ‹’ç»æŸä¸ªé—®é¢˜åº”ç”¨

List<AuthorityRule> rules = new ArrayList<>();

// è§„åˆ™1ï¼šä¸‹å•æ¥å£ç™½åå•
AuthorityRule orderRule = new AuthorityRule();
orderRule.setResource("createOrder");
orderRule.setStrategy(RuleConstant.AUTHORITY_WHITE);
orderRule.setLimitApp("web-app,mobile-app");
rules.add(orderRule);

// è§„åˆ™2ï¼šå…¨å±€é»‘åå•ï¼ˆæ‹¦æˆªæ¶æ„åº”ç”¨ï¼‰
AuthorityRule globalBlack = new AuthorityRule();
globalBlack.setResource("*");  // æ‰€æœ‰èµ„æº
globalBlack.setStrategy(RuleConstant.AUTHORITY_BLACK);
globalBlack.setLimitApp("malicious-app");
rules.add(globalBlack);

// è§„åˆ™3ï¼šæŸ¥è¯¢æ¥å£é»‘åå•ï¼ˆæ‹’ç»é—®é¢˜åº”ç”¨ï¼‰
AuthorityRule queryRule = new AuthorityRule();
queryRule.setResource("queryOrder");
queryRule.setStrategy(RuleConstant.AUTHORITY_BLACK);
queryRule.setLimitApp("buggy-app");
rules.add(queryRule);

AuthorityRuleManager.loadRules(rules);
```

---

## 4. ğŸ” æ¥æºè¯†åˆ«ä¸è¯·æ±‚é‰´åˆ«


### 4.1 æ¥æºä¿¡æ¯çš„æå–


**ğŸ”¸ æ¥æºæ ‡è¯†çš„è·å–æ–¹å¼**
```
å¸¸è§æ¥æºæ ‡è¯†ï¼š
1. åº”ç”¨åç§°ï¼ˆapplicationï¼‰
2. IPåœ°å€ï¼ˆremoteIPï¼‰
3. ç”¨æˆ·æ ‡è¯†ï¼ˆuserIdï¼‰
4. è¯·æ±‚å¤´ä¿¡æ¯ï¼ˆheaderï¼‰
```

**è‡ªå®šä¹‰æ¥æºæå–å™¨**ï¼š
```java
// å®ç° RequestOriginParser æ¥å£
@Component
public class CustomOriginParser implements RequestOriginParser {
    
    @Override
    public String parseOrigin(HttpServletRequest request) {
        // æ–¹å¼1ï¼šä»è¯·æ±‚å¤´è·å–åº”ç”¨å
        String appName = request.getHeader("app-name");
        if (appName != null) {
            return appName;
        }
        
        // æ–¹å¼2ï¼šä»IPè·å–
        String ip = request.getRemoteAddr();
        return ip;
        
        // æ–¹å¼3ï¼šç»„åˆå¤šä¸ªä¿¡æ¯
        // return appName + ":" + ip;
    }
}
```

**è§£é‡Šè¯´æ˜**ï¼š
```
è¿™ä¸ªè§£æå™¨çš„ä½œç”¨ï¼š
å‘Šè¯‰Sentinel"è¿™ä¸ªè¯·æ±‚æ˜¯ä»å“ªé‡Œæ¥çš„"

å°±åƒé—¨å«æ£€æŸ¥ï¼š
- çœ‹å·¥ç‰Œï¼ˆè¯·æ±‚å¤´çš„app-nameï¼‰
- çœ‹èº«ä»½è¯ï¼ˆIPåœ°å€ï¼‰
- è®°å½•è¯¦ç»†ä¿¡æ¯ï¼ˆç»„åˆæ ‡è¯†ï¼‰
```

### 4.2 æ¥æºè¯†åˆ«çš„ä¼˜å…ˆçº§


```
ä¼˜å…ˆçº§é¡ºåºï¼ˆä»é«˜åˆ°ä½ï¼‰ï¼š
1. è‡ªå®šä¹‰RequestOriginParser
2. é»˜è®¤æ¥æºæ ‡è¯†
3. ä½¿ç”¨"default"ä½œä¸ºæ¥æº

å¤„ç†æµç¨‹ï¼š
è¯·æ±‚åˆ°è¾¾
   â†“
æœ‰è‡ªå®šä¹‰Parserï¼Ÿ
   â†“ æ˜¯        â†“ å¦
ä½¿ç”¨è‡ªå®šä¹‰    ä½¿ç”¨é»˜è®¤
   â†“            â†“
è·å–æ¥æºæ ‡è¯†
   â†“
åº”ç”¨æˆæƒè§„åˆ™
```

### 4.3 å®é™…é‰´åˆ«ç¤ºä¾‹


**åœºæ™¯ï¼šåŒºåˆ†å†…å¤–ç½‘è®¿é—®**
```java
@Component
public class NetworkOriginParser implements RequestOriginParser {
    
    @Override
    public String parseOrigin(HttpServletRequest request) {
        String ip = request.getRemoteAddr();
        
        // åˆ¤æ–­å†…ç½‘IP
        if (isInternalIP(ip)) {
            return "internal";  // å†…ç½‘æ¥æº
        } else {
            return "external";  // å¤–ç½‘æ¥æº
        }
    }
    
    private boolean isInternalIP(String ip) {
        // ç®€åŒ–åˆ¤æ–­ï¼š10.x.x.x å’Œ 192.168.x.x ä¸ºå†…ç½‘
        return ip.startsWith("10.") || ip.startsWith("192.168.");
    }
}

// é…ç½®è§„åˆ™ï¼šå†…ç½‘æ¥å£åªå…è®¸å†…ç½‘è®¿é—®
AuthorityRule rule = new AuthorityRule();
rule.setResource("internal-api");
rule.setStrategy(RuleConstant.AUTHORITY_WHITE);
rule.setLimitApp("internal");  // åªå…è®¸å†…ç½‘æ¥æº
```

**æ‰§è¡Œæ•ˆæœ**ï¼š
```
å†…ç½‘IPè®¿é—® â†’ æ¥æºè¯†åˆ«ä¸º"internal" â†’ åŒ¹é…ç™½åå• â†’ âœ… å…è®¸
å¤–ç½‘IPè®¿é—® â†’ æ¥æºè¯†åˆ«ä¸º"external" â†’ ä¸åœ¨ç™½åå• â†’ âŒ æ‹’ç»
```

---

## 5. ğŸ¯ å®é™…åº”ç”¨åœºæ™¯


### 5.1 åœºæ™¯ä¸€ï¼šAPIç½‘å…³é‰´æƒ


**éœ€æ±‚**ï¼šåªå…è®¸å·²æ³¨å†Œçš„åº”ç”¨è®¿é—®åç«¯æœåŠ¡

```java
// æ¥æºè§£æï¼šä»API Keyè·å–åº”ç”¨æ ‡è¯†
@Component
public class ApiKeyParser implements RequestOriginParser {
    
    @Override
    public String parseOrigin(HttpServletRequest request) {
        // ä»headerè·å–API Key
        String apiKey = request.getHeader("X-API-Key");
        
        // æ ¹æ®API KeyæŸ¥è¯¢åº”ç”¨åï¼ˆç®€åŒ–ç¤ºä¾‹ï¼‰
        if ("key-12345".equals(apiKey)) {
            return "web-app";
        } else if ("key-67890".equals(apiKey)) {
            return "mobile-app";
        }
        
        return "unknown";  // æœªçŸ¥æ¥æº
    }
}

// æˆæƒè§„åˆ™ï¼šåªå…è®¸æ³¨å†Œåº”ç”¨è®¿é—®
AuthorityRule rule = new AuthorityRule();
rule.setResource("backend-api");
rule.setStrategy(RuleConstant.AUTHORITY_WHITE);
rule.setLimitApp("web-app,mobile-app");
```

### 5.2 åœºæ™¯äºŒï¼šæ¶æ„IPæ‹¦æˆª


**éœ€æ±‚**ï¼šå‘ç°æ¶æ„IPåå¿«é€Ÿå°ç¦

```java
// 1. å®šä¹‰é»‘åå•è§„åˆ™
AuthorityRule blackRule = new AuthorityRule();
blackRule.setResource("*");  // å…¨å±€ç”Ÿæ•ˆ
blackRule.setStrategy(RuleConstant.AUTHORITY_BLACK);
blackRule.setLimitApp("192.168.1.100");  // æ¶æ„IP

// 2. IPæ¥æºè§£æå™¨
@Component
public class IpOriginParser implements RequestOriginParser {
    
    @Override
    public String parseOrigin(HttpServletRequest request) {
        return request.getRemoteAddr();  // ç›´æ¥è¿”å›IP
    }
}

// 3. åŠ¨æ€æ·»åŠ åˆ°é»‘åå•
public void blockMaliciousIp(String ip) {
    List<AuthorityRule> rules = AuthorityRuleManager.getRules();
    
    // æŸ¥æ‰¾å…¨å±€é»‘åå•è§„åˆ™
    for (AuthorityRule rule : rules) {
        if ("*".equals(rule.getResource()) && 
            rule.getStrategy() == RuleConstant.AUTHORITY_BLACK) {
            
            // è¿½åŠ æ–°çš„IPåˆ°é»‘åå•
            String currentApps = rule.getLimitApp();
            rule.setLimitApp(currentApps + "," + ip);
            break;
        }
    }
    
    // é‡æ–°åŠ è½½è§„åˆ™
    AuthorityRuleManager.loadRules(rules);
}
```

### 5.3 åœºæ™¯ä¸‰ï¼šç°åº¦å‘å¸ƒæ§åˆ¶


**éœ€æ±‚**ï¼šæ–°ç‰ˆæœ¬åªå¯¹éƒ¨åˆ†ç”¨æˆ·å¼€æ”¾

```java
// ç°åº¦ç”¨æˆ·æ ‡è¯†è§£æ
@Component
public class GrayUserParser implements RequestOriginParser {
    
    @Override
    public String parseOrigin(HttpServletRequest request) {
        String userId = request.getHeader("user-id");
        
        // åˆ¤æ–­æ˜¯å¦ç°åº¦ç”¨æˆ·ï¼ˆä¾‹å¦‚ï¼šå°¾å·ä¸º0çš„ç”¨æˆ·ï¼‰
        if (userId != null && userId.endsWith("0")) {
            return "gray-user";
        }
        
        return "normal-user";
    }
}

// æ–°åŠŸèƒ½ç™½åå•ï¼šåªå…è®¸ç°åº¦ç”¨æˆ·è®¿é—®
AuthorityRule grayRule = new AuthorityRule();
grayRule.setResource("new-feature");
grayRule.setStrategy(RuleConstant.AUTHORITY_WHITE);
grayRule.setLimitApp("gray-user");

// ç»“æœï¼š
// ç”¨æˆ·ID=1230 â†’ gray-user â†’ âœ… å¯ä»¥è®¿é—®æ–°åŠŸèƒ½
// ç”¨æˆ·ID=1234 â†’ normal-user â†’ âŒ è®¿é—®æ—§ç‰ˆæœ¬
```

### 5.4 åœºæ™¯å››ï¼šå†…å¤–ç½‘éš”ç¦»


**éœ€æ±‚**ï¼šç®¡ç†æ¥å£åªå…è®¸å†…ç½‘è®¿é—®

```java
// ç½‘ç»œæ¥æºè¯†åˆ«
@Component
public class NetworkParser implements RequestOriginParser {
    
    @Override
    public String parseOrigin(HttpServletRequest request) {
        String ip = request.getRemoteAddr();
        
        // å†…ç½‘IPæ®µåˆ¤æ–­
        if (ip.startsWith("10.") || 
            ip.startsWith("172.16.") || 
            ip.startsWith("192.168.")) {
            return "intranet";  // å†…ç½‘
        }
        
        return "internet";  // å¤–ç½‘
    }
}

// é…ç½®è§„åˆ™ï¼šç®¡ç†æ¥å£åªå…è®¸å†…ç½‘
AuthorityRule adminRule = new AuthorityRule();
adminRule.setResource("admin-api");
adminRule.setStrategy(RuleConstant.AUTHORITY_WHITE);
adminRule.setLimitApp("intranet");

// é…ç½®è§„åˆ™ï¼šå…¬å¼€æ¥å£ç¦æ­¢å†…ç½‘ï¼ˆé˜²æ­¢å†…ç½‘æ»¥ç”¨ï¼‰
AuthorityRule publicRule = new AuthorityRule();
publicRule.setResource("public-api");
publicRule.setStrategy(RuleConstant.AUTHORITY_BLACK);
publicRule.setLimitApp("intranet");
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ è®¿é—®æ§åˆ¶ï¼šæ§åˆ¶è°èƒ½è®¿é—®ä»€ä¹ˆèµ„æºçš„æœºåˆ¶
ğŸ”¸ æˆæƒè§„åˆ™ï¼šå®šä¹‰è®¿é—®è§„åˆ™çš„é…ç½®
ğŸ”¸ æ¥æºè¯†åˆ«ï¼šåˆ¤æ–­è¯·æ±‚æ¥è‡ªå“ªé‡Œ
ğŸ”¸ é»‘åå•ï¼šæ‹’ç»åå•å†…çš„æ¥æºï¼ˆé»˜è®¤å…è®¸ï¼‰
ğŸ”¸ ç™½åå•ï¼šåªå…è®¸åå•å†…çš„æ¥æºï¼ˆé»˜è®¤æ‹’ç»ï¼‰
```

### 6.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ é»‘ç™½åå•çš„é€‰æ‹©ç­–ç•¥**
```
é€‰æ‹©ç™½åå•ï¼š
âœ… æ ¸å¿ƒèµ„æºä¿æŠ¤
âœ… å®‰å…¨æ€§è¦æ±‚é«˜
âœ… å·²çŸ¥çš„æˆæƒå¯¹è±¡å°‘

é€‰æ‹©é»‘åå•ï¼š
âœ… å…¬å¼€èµ„æºç®¡ç†
âœ… ä½¿ç”¨ä¾¿åˆ©æ€§ä¼˜å…ˆ
âœ… éœ€è¦æ‹¦æˆªçš„å¯¹è±¡å°‘
```

**ğŸ”¹ æ¥æºè¯†åˆ«çš„æ–¹å¼**
```
åº”ç”¨åè¯†åˆ« â†’ é€‚åˆå¾®æœåŠ¡é—´è°ƒç”¨
IPè¯†åˆ« â†’ é€‚åˆç½‘ç»œå±‚æ§åˆ¶
ç”¨æˆ·æ ‡è¯† â†’ é€‚åˆç”¨æˆ·çº§æ§åˆ¶
ç»„åˆè¯†åˆ« â†’ é€‚åˆå¤æ‚åœºæ™¯
```

**ğŸ”¹ è§„åˆ™é…ç½®çš„æœ€ä½³å®è·µ**
```
1. ä¼˜å…ˆä½¿ç”¨æ§åˆ¶å°åŠ¨æ€é…ç½®ï¼ˆçµæ´»ï¼‰
2. æ ¸å¿ƒè§„åˆ™å¯ä»¥ä»£ç åˆå§‹åŒ–ï¼ˆç¨³å®šï¼‰
3. å®šæœŸå®¡æŸ¥å’Œæ›´æ–°è§„åˆ™ï¼ˆå®‰å…¨ï¼‰
4. åšå¥½è§„åˆ™å˜æ›´çš„ç›‘æ§å‘Šè­¦ï¼ˆå¯æ§ï¼‰
```

### 6.3 å®é™…åº”ç”¨æŒ‡å¯¼


**é…ç½®å»ºè®®**ï¼š
- ğŸ¯ **æ ¸å¿ƒæ¥å£**ï¼šä½¿ç”¨ç™½åå•ï¼Œä¸¥æ ¼æ§åˆ¶
- ğŸŒ **å…¬å¼€æ¥å£**ï¼šä½¿ç”¨é»‘åå•ï¼Œçµæ´»æ‹¦æˆª
- ğŸ”„ **æ··åˆåœºæ™¯**ï¼šç™½åå•+é»‘åå•ç»„åˆ
- ğŸ“Š **ç›‘æ§å‘Šè­¦**ï¼šè®°å½•è¢«æ‹’ç»çš„è®¿é—®æ—¥å¿—

**å¸¸è§é—®é¢˜è§£å†³**ï¼š

| é—®é¢˜ | **åŸå› ** | **è§£å†³æ–¹æ¡ˆ** |
|------|---------|------------|
| `åˆæ³•è¯·æ±‚è¢«æ‹¦æˆª` | `æ¥æºæ ‡è¯†ä¸åŒ¹é…` | `æ£€æŸ¥RequestOriginParserå®ç°` |
| `æ¶æ„è¯·æ±‚é€šè¿‡` | `è§„åˆ™é…ç½®ä¸å®Œæ•´` | `è¡¥å……é»‘åå•è§„åˆ™` |
| `è§„åˆ™ä¸ç”Ÿæ•ˆ` | `æœªæ­£ç¡®åŠ è½½è§„åˆ™` | `ç¡®è®¤è§„åˆ™æ˜¯å¦åŠ è½½åˆ°RuleManager` |
| `æ— æ³•åŠ¨æ€æ›´æ–°` | `æœªæ¥å…¥é…ç½®ä¸­å¿ƒ` | `é›†æˆNacos/Apolloç­‰é…ç½®ä¸­å¿ƒ` |

**ğŸ§  è®°å¿†è¦ç‚¹**ï¼š
```
è®¿é—®æ§åˆ¶åƒé—¨ç¦ï¼Œé»‘ç™½åå•å®šè§„çŸ©
ç™½åå•ä¸¥æ ¼é˜²æŠ¤ï¼Œé»‘åå•çµæ´»æ‹¦æˆª
æ¥æºè¯†åˆ«æ˜¯å…³é”®ï¼Œè§„åˆ™é…ç½®è¦å‡†ç¡®
å®é™…åº”ç”¨å¤šåœºæ™¯ï¼Œå®‰å…¨é˜²æŠ¤ç¬¬ä¸€ä½
```