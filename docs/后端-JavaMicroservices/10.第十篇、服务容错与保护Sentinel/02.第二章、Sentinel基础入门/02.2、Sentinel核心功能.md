---
title: 2、Sentinel核心功能
---
## 📚 目录

1. [Sentinel概述](#1-sentinel概述)
2. [Sentinel核心功能详解](#2-sentinel核心功能详解)
3. [Sentinel工作原理](#3-sentinel工作原理)
4. [核心要点总结](#4-核心要点总结)

---

## 1. 🛡️ Sentinel概述


### 1.1 什么是Sentinel


**💡 通俗理解**

想象一下高速公路收费站：当车流量过大时，收费站会限制通行速度，防止拥堵；当某个收费口出故障时，会关闭该通道，引导车辆走其他通道。**Sentinel就是微服务系统中的"智能收费站"**。

```
正常情况：
用户请求 → 服务A → 服务B → 返回结果 ✅

流量过大：
用户请求(1000个/秒) → Sentinel限流 → 只允许100个通过 → 保护服务 🚦

服务故障：
用户请求 → 服务A崩溃 → Sentinel熔断 → 返回备用结果 🔌
```

**🔸 核心定义**
```
Sentinel：阿里巴巴开源的服务容错组件
作用：保护微服务不被流量压垮，不被故障拖累
目标：让系统在异常情况下仍能稳定运行
```

### 1.2 为什么需要Sentinel


**📊 微服务面临的问题**

```
场景1：流量突增
双11零点 → 10万用户同时下单 → 订单服务崩溃 → 整个系统瘫痪 ❌

场景2：服务雪崩
支付服务故障 → 订单服务等待超时 → 用户服务也被拖累 → 全链路崩溃 ❌

场景3：慢调用堆积
数据库查询变慢 → 线程池被占满 → 新请求无法处理 → 服务卡死 ❌
```

**✅ Sentinel的解决方案**

| 问题类型 | Sentinel方案 | 效果 |
|---------|-------------|------|
| 🌊 **流量过大** | 流量控制 | 限制请求速度，保护服务 |
| 💥 **服务故障** | 熔断降级 | 快速失败，防止雪崩 |
| 🐌 **响应变慢** | 系统保护 | 自动调节，避免崩溃 |
| 🔥 **热点访问** | 热点限流 | 保护热点资源 |

---

## 2. ⚙️ Sentinel核心功能详解


### 2.1 流量控制（Flow Control）


**🎯 功能解释**

流量控制就像**水龙头的开关**，控制水流速度，防止水管爆裂。在微服务中，它控制请求的速度和数量。

**📋 三种限流模式**

```
1️⃣ QPS限流（每秒请求数）
规则：每秒最多处理100个请求
效果：第101个请求被拒绝

实际场景：
秒杀商品 → 设置QPS=1000 → 保护库存服务

2️⃣ 线程数限流
规则：最多10个线程同时处理
效果：第11个请求排队等待

实际场景：
数据库连接池只有10个 → 限制并发线程=10

3️⃣ 关联限流
规则：写操作达到阈值时，限制读操作
效果：保证写优先级

实际场景：
数据修改接口忙碌 → 暂停查询接口 → 保证数据一致性
```

**💻 配置示例**

```java
// QPS限流规则
FlowRule rule = new FlowRule();
rule.setResource("orderService");  // 保护订单服务
rule.setGrade(RuleConstant.FLOW_GRADE_QPS);  // 限流类型：QPS
rule.setCount(100);  // 每秒最多100个请求

// 限流效果
正常：请求量80/秒  → 全部通过 ✅
高峰：请求量200/秒 → 只允许100/秒，其余拒绝 🚫
```

### 2.2 熔断降级（Circuit Breaking）


**🎯 功能解释**

熔断降级就像**电路保险丝**，当电流过大时自动断开，保护整个电路。在微服务中，当服务出现故障时快速失败，防止拖累其他服务。

**📊 熔断策略对比**

| 策略类型 | 触发条件 | 适用场景 | 恢复机制 |
|---------|---------|---------|---------|
| 🔴 **慢调用比例** | 响应时间>1秒的请求超过50% | 服务响应慢 | 半开状态试探 |
| 🔴 **异常比例** | 异常请求超过50% | 服务出错多 | 半开状态试探 |
| 🔴 **异常数** | 1分钟内异常超过10次 | 服务频繁报错 | 半开状态试探 |

**🔄 熔断三状态**

```
【关闭状态 - CLOSED】
正常工作，所有请求正常通过
监控异常情况
    ↓ (异常率超过阈值)
    
【开启状态 - OPEN】
快速失败，所有请求直接拒绝
返回降级结果(备用数据)
    ↓ (等待恢复时间)
    
【半开状态 - HALF_OPEN】
允许少量请求试探
    ↓ (成功) → 回到关闭状态
    ↓ (失败) → 回到开启状态
```

**💡 实际案例**

```java
// 慢调用熔断规则
DegradeRule rule = new DegradeRule();
rule.setResource("paymentService");  // 保护支付服务
rule.setGrade(RuleConstant.DEGRADE_GRADE_RT);  // 慢调用比例
rule.setCount(1000);  // 响应时间超过1秒算慢调用
rule.setSlowRatioThreshold(0.5);  // 慢调用比例50%
rule.setTimeWindow(10);  // 熔断持续10秒

// 执行过程
1. 支付服务响应慢，60%请求>1秒
2. 触发熔断，后续请求直接返回"支付繁忙"
3. 10秒后进入半开状态，试探性恢复
4. 服务正常后完全恢复
```

### 2.3 系统自适应保护


**🎯 功能解释**

系统保护就像**汽车的ABS防抱死系统**，根据路况自动调节刹车力度。Sentinel监控系统负载，自动调整流量。

**📈 监控指标**

```
🔸 CPU使用率
阈值：CPU > 80% → 开始限流
场景：计算密集型服务

🔸 系统平均负载（Load）
阈值：Load > 核心数 → 开始限流  
场景：Linux系统压力大

🔸 并发线程数
阈值：线程数 > 200 → 开始限流
场景：线程池即将耗尽

🔸 入口QPS
阈值：总QPS > 10000 → 开始限流
场景：系统总入口保护

🔸 平均响应时间
阈值：RT > 500ms → 开始限流
场景：系统响应变慢
```

**💻 自适应示例**

```java
// 系统保护规则
SystemRule rule = new SystemRule();
rule.setHighestSystemLoad(4.0);  // Load阈值
rule.setAvgRt(500);  // 平均响应时间500ms
rule.setMaxThread(200);  // 最大线程数200

// 运行效果
CPU正常(50%) → 正常处理请求
CPU升高(85%) → 自动降低接收请求 → 保护系统
CPU恢复(60%) → 逐步恢复正常
```

### 2.4 热点参数限流


**🎯 功能解释**

热点限流就像**商场的明星专柜**，对人气商品单独控制人流。在系统中，对高频访问的参数做特殊限流。

**🔥 典型场景**

```
场景1：商品详情页
普通商品：每秒100次访问 ✅
爆款商品：每秒10万次访问 ❌ → 针对该商品ID限流

场景2：用户查询
普通用户：正常访问 ✅
刷单用户：频繁查询 ❌ → 针对该用户ID限流

场景3：地区流量
北京地区：QPS=1000 
上海地区：QPS=500
其他地区：QPS=100
```

**💻 配置示例**

```java
// 热点参数规则
ParamFlowRule rule = new ParamFlowRule();
rule.setResource("getProductDetail");  // 商品详情接口
rule.setParamIdx(0);  // 第一个参数(商品ID)
rule.setCount(100);  // 默认每秒100次

// 特殊参数配置
ParamFlowItem item = new ParamFlowItem();
item.setObject("iphone15");  // 爆款商品ID
item.setCount(10);  // 限制每秒10次
rule.setParamFlowItemList(Arrays.asList(item));

// 效果
普通商品(ID=123) → 每秒100次 ✅
爆款商品(ID=iphone15) → 每秒10次 🔥
```

### 2.5 集群流控


**🎯 功能解释**

集群流控就像**多个收费站统一管理**，所有收费站共享一个总限额。在分布式系统中，多个实例共享限流配额。

**📊 单机 vs 集群流控**

```
单机流控问题：
服务实例1：限流100QPS
服务实例2：限流100QPS  
服务实例3：限流100QPS
总QPS：300 (无法精确控制总流量)

集群流控方案：
所有实例共享：总限流100QPS
实例1：分到30QPS
实例2：分到40QPS
实例3：分到30QPS
```

**🏗️ 集群架构**

```
          Token Server (令牌服务器)
                |
     统一管理流量配额(100QPS)
                |
    ┌───────────┼───────────┐
    ↓           ↓           ↓
Client1      Client2      Client3
(30QPS)      (40QPS)      (30QPS)
```

### 2.6 黑白名单控制


**🎯 功能解释**

黑白名单就像**门禁系统**，白名单放行，黑名单拦截。

**📋 使用场景**

```
✅ 白名单场景
内部管理系统 → 只允许公司IP访问
VIP用户 → 不受限流影响
监控探活 → 健康检查接口放行

🚫 黑名单场景
恶意IP → 直接拒绝访问
爬虫地址 → 禁止抓取
异常用户 → 临时封禁
```

**💻 配置示例**

```java
// 授权规则
AuthorityRule rule = new AuthorityRule();
rule.setResource("userInfo");  // 用户信息接口
rule.setStrategy(RuleConstant.AUTHORITY_WHITE);  // 白名单模式
rule.setLimitApp("admin,vip");  // 允许admin和vip访问

// 效果
admin用户 → 直接通过 ✅
vip用户 → 直接通过 ✅
普通用户 → 拒绝访问 🚫
```

---

## 3. 🔧 Sentinel工作原理


### 3.1 核心概念


**📋 资源（Resource）**

```
定义：需要保护的对象
示例：
- 接口：/order/create
- 方法：OrderService.createOrder()
- URL：http://api.com/user

理解：就像给每个重要的门安装门禁
```

**📋 规则（Rule）**

```
定义：保护资源的策略
类型：
- FlowRule：流量规则
- DegradeRule：熔断规则
- SystemRule：系统规则
- ParamFlowRule：热点规则

理解：门禁的各种设置（谁能进、什么时候进）
```

**📋 槽链（Slot Chain）**

```
请求处理流程：
请求进入
  ↓
NodeSelectorSlot (构建调用链)
  ↓
ClusterBuilderSlot (集群信息)
  ↓
StatisticSlot (统计数据)
  ↓
FlowSlot (流量控制检查)
  ↓
DegradeSlot (熔断降级检查)
  ↓
SystemSlot (系统保护检查)
  ↓
处理业务逻辑

理解：就像过安检的多道关卡
```

### 3.2 运行机制


**🔄 完整流程**

```
步骤1️⃣：资源定义
@SentinelResource("orderService")
public Order createOrder() { ... }

步骤2️⃣：规则配置
设置QPS=100，RT=1000ms

步骤3️⃣：请求到达
用户发起订单请求

步骤4️⃣：槽链检查
依次通过各个检查点

步骤5️⃣：统计数据
记录QPS、RT、异常数

步骤6️⃣：决策
通过 → 执行业务
拒绝 → 返回限流信息
```

---

## 4. 📋 核心要点总结


### 4.1 必须掌握的核心概念


```
🔸 Sentinel作用：保护微服务，防止流量压垮和故障蔓延
🔸 六大功能：流控、熔断、系统保护、热点限流、集群流控、黑白名单
🔸 三个核心：资源(保护对象)、规则(保护策略)、槽链(检查流程)
```

### 4.2 功能对比记忆


| 功能 | 解决问题 | 通俗比喻 | 使用时机 |
|-----|---------|---------|---------|
| 🌊 **流量控制** | 请求太多 | 水龙头控制水流 | 高并发场景 |
| 💥 **熔断降级** | 服务故障 | 电路保险丝 | 服务异常时 |
| 🛡️ **系统保护** | 系统负载高 | 汽车ABS | 系统压力大 |
| 🔥 **热点限流** | 某些数据访问过多 | 明星专柜限流 | 爆款商品 |
| 🌐 **集群流控** | 分布式总量控制 | 多收费站统一管理 | 集群环境 |
| 🚪 **黑白名单** | 访问权限控制 | 门禁系统 | 权限管理 |

### 4.3 实际应用建议


**🎯 新手入门路径**

```
第1步：理解为什么需要Sentinel
场景：双11订单服务被压垮

第2步：掌握基础流控
实践：给订单接口加QPS限流

第3步：学习熔断降级
实践：支付服务故障时返回备用数据

第4步：尝试系统保护
实践：CPU过高时自动限流

第5步：深入高级功能
实践：热点商品限流、集群流控
```

**💡 记忆口诀**

```
Sentinel服务保护神，
流控熔断两把剑。
系统自适应保护好，
热点限流防爆款。
集群流控齐协作，
黑白名单把门关。
```

### 4.4 常见问题


**❓ 流控和熔断的区别？**
```
流控：控制流量速度（防止太多请求）
熔断：处理故障服务（防止服务拖累）

比喻：
流控 = 限制进店人数
熔断 = 某个柜台故障就关闭
```

**❓ 什么时候用系统保护？**
```
场景：
- CPU使用率过高
- 系统负载过大
- 线程池快满了
- 整体响应变慢

作用：保护整个系统，而不是某个接口
```

**❓ 热点限流实际用在哪？**
```
电商：爆款商品详情页
社交：热门话题评论
视频：热门视频播放
新闻：突发新闻阅读
```