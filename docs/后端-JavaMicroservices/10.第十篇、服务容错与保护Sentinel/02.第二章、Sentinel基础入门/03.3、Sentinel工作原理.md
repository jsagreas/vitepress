---
title: 3、Sentinel工作原理
---
## 📚 目录

1. [Sentinel概述](#1-sentinel概述)
2. [Sentinel工作原理](#2-sentinel工作原理)
3. [核心要点总结](#3-核心要点总结)

---

## 1. 🛡️ Sentinel概述


### 1.1 什么是Sentinel


**🔸 通俗理解**

想象一下，你家门口有个保安（Sentinel），他的工作就是：
- 控制进入人数，人太多就让后面的人等等
- 记录每天来访人数的规律
- 发现可疑人员（异常流量）就拦截
- 遇到紧急情况能快速反应

**这就是Sentinel在微服务中的角色** —— 一个智能的流量保镖。

### 1.2 为什么需要Sentinel


**💡 实际场景问题**

```
电商系统突然搞秒杀活动：
正常情况：每秒100个请求 → 系统正常运行 ✅
秒杀开始：每秒10000个请求 → 系统崩溃 ❌

问题：
1. 数据库连接被打满
2. 服务器CPU 100%
3. 整个系统瘫痪
4. 所有用户都无法访问
```

**Sentinel的解决方案**：
- **限流**：只允许合理数量的请求通过，超出部分排队或拒绝
- **降级**：非核心功能暂时关闭，保证核心功能可用
- **熔断**：发现下游服务有问题，暂时停止调用，避免连锁崩溃

### 1.3 Sentinel核心能力


| 能力 | **说明** | **生活类比** |
|------|---------|------------|
| 🚦 **流量控制** | `控制请求通过的速度` | `红绿灯控制车流` |
| 🔄 **熔断降级** | `检测异常自动切断` | `保险丝烧断保护电路` |
| ⚡ **系统负载保护** | `防止系统过载` | `电梯限载保护` |
| 🎯 **热点参数限流** | `对热门商品特殊控制` | `明星见面会限流` |

---

## 2. ⚙️ Sentinel工作原理


### 2.1 资源定义（什么是资源）


**🔸 核心概念**

```
资源 = 需要保护的东西

可以是：
✓ 一个接口方法（/api/order）
✓ 一段代码逻辑（下单流程）
✓ 一个服务调用（调用库存服务）
```

**简单示例**：

```java
// 把查询订单接口定义为资源
@GetMapping("/order/{id}")
@SentinelResource(value = "getOrder")  // 定义资源名称
public Order getOrder(@PathVariable Long id) {
    return orderService.findById(id);
}
```

这里 `"getOrder"` 就是资源名，Sentinel会保护这个资源。

### 2.2 规则配置（保护规则）


**🔸 三大核心规则**

**1️⃣ 流控规则（限制流量）**

```
规则配置：
资源名：getOrder
限流阈值：每秒100个请求
超出处理：直接拒绝

效果：
第1-100个请求 → 正常通过 ✅
第101个请求 → 被拒绝，返回错误 ❌
```

**2️⃣ 降级规则（服务降级）**

```
规则配置：
资源名：queryStock（查库存）
降级策略：异常比例 > 50%
时间窗口：10秒

效果：
10秒内如果一半请求都失败了
→ 触发降级，后续请求直接返回默认值
→ 不再调用有问题的库存服务
```

**3️⃣ 热点规则（针对特定参数）**

```
规则配置：
资源名：getProduct
热点参数：商品ID
限流阈值：普通商品100/秒，热门商品10/秒

效果：
iPhone15（热门） → 限制每秒10个请求
普通商品 → 限制每秒100个请求
```

### 2.3 统计指标（数据采集）


**🔸 Sentinel会实时记录**

```
监控数据包括：
📊 通过的请求数（QPS）
📊 被拒绝的请求数
📊 响应时间
📊 异常数量
📊 成功率
```

**数据流向图**：

```
请求进来
    ↓
[Sentinel拦截]
    ↓
统计当前指标：
┌─────────────────────┐
│ QPS: 850/秒         │
│ 响应时间: 120ms     │
│ 异常率: 2%          │
│ 通过: 850  拒绝: 50 │
└─────────────────────┘
    ↓
对比规则判断
    ↓
是否放行？
```

### 2.4 滑动窗口机制（核心算法）


**🔸 通俗理解**

传统计数方式的问题：

```
假设限制每秒100个请求：

时间轴：  00:00  →  00:01  →  00:02
         ├──────┼──────┼──────┤
第1秒末：  99个请求 ✅
第2秒初：  99个请求 ✅
实际1秒内：198个请求！❌ （漏洞）
```

**滑动窗口解决方案**：

```
把1秒钟分成10个小格（每格100ms）：

窗口滑动示意：
时间 →
┌───┬───┬───┬───┬───┬───┬───┬───┬───┬───┐
│ 8 │ 12│ 15│ 10│ 9 │ 11│ 14│ 8 │ 10│ 13│  ← 每格的请求数
└───┴───┴───┴───┴───┴───┴───┴───┴───┴───┘
  ↑                                   ↑
  最早                               最新

计算方式：
当前1秒的请求数 = 所有小格的和
= 8+12+15+10+9+11+14+8+10+13 = 110个

判断：110 > 100 → 拒绝新请求
```

**工作流程**：

```
1. 时间窗口持续滑动
   每100ms移动一次
   
2. 丢弃过期数据
   超过1秒的数据被移除
   
3. 统计当前窗口
   累加所有格子的数据
   
4. 实时判断
   是否超过阈值
```

### 2.5 实时监控（Dashboard）


**🔸 可视化监控面板**

```
Sentinel控制台展示：

┌─────────────────────────────────────┐
│  资源名：getOrder                   │
├─────────────────────────────────────┤
│  📈 实时QPS：  [████████░░] 850/1000│
│  ⏱️  平均RT：   120ms                │
│  ✅ 通过QPS：  850                   │
│  ❌ 拒绝QPS：  150                   │
│  💥 异常数：    5                    │
├─────────────────────────────────────┤
│  🔧 当前规则：                       │
│     • 流控：1000/秒                 │
│     • 降级：异常率>10%              │
└─────────────────────────────────────┘
```

**监控告警流程**：

```
服务运行中
    ↓
Sentinel收集数据
    ↓
发送到控制台
    ↓
可视化展示
    ↓
触发告警规则？
    ↓
是 → 发送告警通知
否 → 继续监控
```

### 2.6 责任链模式（处理流程）


**🔸 什么是责任链**

想象你去银行办业务：

```
客户请求
    ↓
[保安检查] → 通过？ → 继续
    ↓              ↓
   拒绝          [取号机] → 有号？ → 继续
                    ↓           ↓
                   等待        [柜台] → 办理成功
```

**Sentinel的责任链**：

```
请求到达
    ↓
[责任链槽位1：限流检查]
    ↓ 通过
[责任链槽位2：降级检查]
    ↓ 通过
[责任链槽位3：系统保护]
    ↓ 通过
[责任链槽位4：热点检查]
    ↓ 通过
执行业务逻辑
    ↓
返回结果
```

**代码层面的理解**：

```java
// 简化的责任链处理流程
public void processRequest(Request request) {
    // 槽位1：流量控制
    if (!flowRuleChecker.check(request)) {
        throw new BlockException("流量超限");
    }
    
    // 槽位2：熔断降级
    if (!degradeRuleChecker.check(request)) {
        return getFallbackResponse(); // 降级处理
    }
    
    // 槽位3：系统负载
    if (!systemRuleChecker.check(request)) {
        throw new BlockException("系统过载");
    }
    
    // 都通过了，执行业务
    return doRealBusiness(request);
}
```

**责任链优势**：

| 特点 | **说明** |
|------|---------|
| 🔧 **灵活扩展** | `可以随时增加新的检查节点` |
| 🎯 **职责清晰** | `每个节点只负责一件事` |
| ⚡ **按序执行** | `有明确的执行顺序` |
| 🔄 **易于维护** | `修改某个规则不影响其他` |

### 2.7 完整工作流程


**🔸 请求处理全过程**

```
用户发起请求
    ↓
┌─────────────────────────────────┐
│  1. Sentinel拦截                │
│     识别资源：getOrder          │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│  2. 滑动窗口统计                │
│     当前QPS：850                │
│     平均RT：120ms               │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│  3. 责任链检查                  │
│     流控规则：850 < 1000 ✅     │
│     降级规则：异常率2% < 10% ✅ │
│     系统规则：CPU 60% < 80% ✅  │
└─────────────────────────────────┘
    ↓
┌─────────────────────────────────┐
│  4. 所有检查通过                │
│     放行请求                    │
└─────────────────────────────────┘
    ↓
执行业务逻辑
    ↓
┌─────────────────────────────────┐
│  5. 记录执行结果                │
│     成功 → 更新成功指标         │
│     失败 → 更新异常指标         │
└─────────────────────────────────┘
    ↓
返回响应给用户
    ↓
数据同步到监控面板
```

---

## 3. 📋 核心要点总结


### 3.1 必须理解的概念


```
🎯 Sentinel是什么？
→ 微服务的流量保镖，防止系统被压垮

🎯 核心三大功能：
→ 限流：控制流量不超标
→ 降级：异常时快速失败
→ 熔断：切断问题服务

🎯 工作原理关键词：
→ 资源：需要保护的目标
→ 规则：保护的策略
→ 滑动窗口：精准的流量统计
→ 责任链：有序的检查流程
```

### 3.2 关键理解要点


**🔹 资源与规则的关系**

```
资源 = 保护对象（接口/方法）
规则 = 保护策略（怎么保护）

关系：
一个资源可以配多个规则
一个规则只针对一个资源

示例：
资源：getOrder
规则1：限流1000/秒
规则2：异常率>10%降级
规则3：商品ID=888限流10/秒
```

**🔹 滑动窗口vs固定窗口**

```
固定窗口缺陷：
├─────1秒─────┼─────1秒─────┤
      99个            99个
      ↑               ↑
    边界处可能瞬间198个（突刺）

滑动窗口优势：
永远统计最近1秒内的真实数据
├─┼─┼─┼─┼─┼─┼─┼─┼─┼─┤
 100ms为单位滑动，更精确
```

**🔹 责任链的好处**

```
请求处理像流水线：
┌────┐  ┌────┐  ┌────┐  ┌────┐
│限流│→│降级│→│系统│→│热点│→ 业务
└────┘  └────┘  └────┘  └────┘
  ↓       ↓       ↓       ↓
拒绝    降级    拒绝    拒绝

任何一关不过，直接返回，不执行业务
所有关卡通过，才能执行真正的业务逻辑
```

### 3.3 实际应用价值


**🎯 使用场景**

| 场景 | **Sentinel方案** | **效果** |
|------|-----------------|---------|
| 🛒 **秒杀活动** | `限流规则控制流量` | `保护系统不崩溃` |
| 📦 **依赖服务故障** | `熔断降级快速失败` | `避免连锁崩溃` |
| 🔥 **热点商品** | `热点参数限流` | `公平访问机会` |
| 💻 **服务器过载** | `系统负载保护` | `自动拒绝请求` |

**🔧 配置建议**

```
新手入门配置建议：

1️⃣ 先配流控规则
   设置合理的QPS阈值
   
2️⃣ 再配降级规则
   设置异常率或慢调用比例
   
3️⃣ 观察监控数据
   根据实际情况调整
   
4️⃣ 逐步优化
   添加热点规则、系统规则等

记住：
规则不是一次配好的
需要根据业务特点持续调优
```

**核心记忆口诀**：
- Sentinel守护微服务，流量保护第一位
- 滑动窗口统计准，责任链上层层关
- 限流降级加熔断，保护系统不崩盘
- 规则配置要合理，监控调优是关键