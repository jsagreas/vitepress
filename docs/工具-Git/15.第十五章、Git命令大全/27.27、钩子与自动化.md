---
title: 27、钩子与自动化
---
## 📚 目录

1. [Git钩子基础概念](#1-Git钩子基础概念)
2. [钩子目录结构详解](#2-钩子目录结构详解)
3. [客户端钩子详解](#3-客户端钩子详解)
4. [服务端钩子详解](#4-服务端钩子详解)
5. [钩子脚本编写实战](#5-钩子脚本编写实战)
6. [钩子权限与安全](#6-钩子权限与安全)
7. [常见应用场景](#7-常见应用场景)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🪝 Git钩子基础概念


### 1.1 什么是Git钩子？


**通俗理解**：Git钩子就像是**"触发器"**或**"自动助手"**

```
生活中的类比：
- 闹钟响了 → 自动播放音乐
- 门铃按了 → 自动开灯
- 到了晚上 → 自动关窗帘

Git钩子：
- 准备提交 → 自动检查代码格式
- 完成提交 → 自动发送通知
- 准备推送 → 自动运行测试
- 收到推送 → 自动部署网站
```

**核心定义**：
- **钩子**：在Git操作的特定时刻自动执行的脚本
- **自动化**：无需手动干预，Git自己触发执行
- **定制化**：可以根据项目需要编写不同的脚本

### 1.2 钩子的工作原理


**触发机制**：
```
操作流程示意：
开发者执行命令 → Git检查是否有钩子 → 执行钩子脚本 → 继续/停止原操作

具体例子：
git commit → 检查pre-commit钩子 → 执行代码检查 → 
如果通过：完成提交
如果失败：取消提交
```

**钩子类型分类**：
- **客户端钩子**：在你的本地电脑上运行
- **服务端钩子**：在远程仓库（如GitHub）上运行

### 1.3 为什么需要钩子？


**解决的问题**：
- **忘记检查**：人总会忘记运行测试或格式化代码
- **标准不一**：团队成员的代码风格可能不统一
- **手动繁琐**：每次都手动部署很麻烦
- **质量控制**：防止有问题的代码进入主分支

**实际收益**：
```
✅ 自动化：减少重复性手工操作
✅ 一致性：确保团队遵循相同标准
✅ 质量：在问题发生前就拦截
✅ 效率：节省大量时间和精力
```

---

## 2. 📁 钩子目录结构详解


### 2.1 .git/hooks/目录探索


**位置说明**：
```
你的项目文件夹/
├── src/              ← 你的源代码
├── README.md         
├── .gitignore        
└── .git/             ← Git的隐藏文件夹
    ├── config        
    ├── objects/      
    └── hooks/        ← 钩子脚本就放在这里！
        ├── pre-commit.sample
        ├── post-commit.sample
        ├── pre-push.sample
        └── ...更多钩子文件
```

**查看钩子目录**：
```bash
# 进入项目根目录
cd your-project

# 查看钩子文件夹（Mac/Linux）
ls -la .git/hooks/

# 查看钩子文件夹（Windows）
dir .git\hooks\
```

### 2.2 钩子文件命名规则


**示例文件结构**：
```
.git/hooks/
├── applypatch-msg.sample      ← 示例文件（不会执行）
├── commit-msg.sample          ← 示例文件（不会执行）
├── pre-commit.sample          ← 示例文件（不会执行）
├── pre-commit                 ← 实际钩子（会执行）
├── post-commit                ← 实际钩子（会执行）
└── pre-push                   ← 实际钩子（会执行）
```

**重要规则**：
- **`.sample` 结尾**：只是示例，不会被执行
- **无扩展名**：实际的钩子文件名，Git会执行
- **可执行权限**：文件必须有执行权限才能运行

### 2.3 钩子类型一览表


| 钩子名称 | **触发时机** | **用途说明** | **常见应用** |
|---------|------------|-------------|-------------|
| `pre-commit` | **提交前** | `检查将要提交的内容` | `代码格式化、语法检查` |
| `commit-msg` | **编辑提交信息时** | `验证提交信息格式` | `提交信息规范检查` |
| `post-commit` | **提交后** | `提交完成后的通知` | `发送邮件、更新状态` |
| `pre-push` | **推送前** | `推送前的最后检查` | `运行完整测试套件` |
| `post-receive` | **接收推送后** | `服务器接收代码后` | `自动部署、通知团队` |

---

## 3. 💻 客户端钩子详解


### 3.1 pre-commit：提交前的守门员


**作用机制**：
```
提交流程：
git add .           ← 暂存文件
git commit -m "..."  ← 开始提交
    ↓
触发 pre-commit    ← 钩子执行检查
    ↓
检查通过 → 完成提交 ✅
检查失败 → 取消提交 ❌
```

**典型应用场景**：
- **代码格式检查**：确保代码符合团队规范
- **语法错误检查**：防止明显的语法错误被提交
- **文件大小检查**：防止提交过大的文件
- **敏感信息检查**：防止提交密码、密钥等

**实践示例**：
```bash
#!/bin/bash
# .git/hooks/pre-commit

echo "🔍 正在检查代码..."

# 检查是否有Python语法错误
python -m py_compile *.py
if [ $? -ne 0 ]; then
    echo "❌ Python语法错误，请修复后再提交"
    exit 1
fi

# 检查代码格式
black --check *.py
if [ $? -ne 0 ]; then
    echo "❌ 代码格式不规范，请运行 black *.py 格式化"
    exit 1
fi

echo "✅ 检查通过，可以提交"
exit 0
```

### 3.2 commit-msg：提交信息的审查员


**作用说明**：
```
提交信息规范示例：

✅ 好的提交信息：
feat: 添加用户登录功能
fix: 修复密码验证错误
docs: 更新API文档

❌ 差的提交信息：
修改
fix
更新一些东西
```

**脚本示例**：
```bash
#!/bin/bash
# .git/hooks/commit-msg

commit_msg_file=$1
commit_msg=$(cat $commit_msg_file)

# 检查提交信息长度（至少10个字符）
if [ ${#commit_msg} -lt 10 ]; then
    echo "❌ 提交信息太短，至少需要10个字符"
    exit 1
fi

# 检查是否包含类型前缀
if ! echo "$commit_msg" | grep -qE "^(feat|fix|docs|style|test):" ; then
    echo "❌ 提交信息必须以类型开头，如：feat: 或 fix:"
    exit 1
fi

echo "✅ 提交信息格式正确"
exit 0
```

### 3.3 post-commit：提交后的通知员


**使用场景**：
- **自动备份**：提交后自动备份到其他位置
- **状态通知**：发送邮件或消息通知
- **统计更新**：更新项目统计信息
- **文档生成**：自动生成或更新文档

**实用示例**：
```bash
#!/bin/bash
# .git/hooks/post-commit

# 获取最新提交信息
commit_msg=$(git log -1 --pretty=format:"%s")
author=$(git log -1 --pretty=format:"%an")

# 创建备份（可选）
echo "📦 正在创建备份..."
git archive --format=zip HEAD > "backup_$(date +%Y%m%d_%H%M%S).zip"

# 发送通知（示例）
echo "📧 提交通知："
echo "作者：$author"
echo "内容：$commit_msg"
echo "时间：$(date)"
```

### 3.4 pre-push：推送前的最后检查


**关键作用**：
```
推送流程：
git push origin main   ← 开始推送
    ↓
触发 pre-push         ← 最后一道检查
    ↓
运行完整测试          ← 确保代码质量
    ↓
检查通过 → 推送到远程 ✅
检查失败 → 取消推送   ❌
```

**实战示例**：
```bash
#!/bin/bash
# .git/hooks/pre-push

echo "🧪 正在运行测试..."

# 运行单元测试
pytest tests/
if [ $? -ne 0 ]; then
    echo "❌ 测试失败，请修复后再推送"
    exit 1
fi

# 检查代码覆盖率
coverage run -m pytest
coverage report --fail-under=80
if [ $? -ne 0 ]; then
    echo "❌ 代码覆盖率不足80%，请增加测试"
    exit 1
fi

echo "✅ 所有检查通过，可以推送"
exit 0
```

---

## 4. 🖥️ 服务端钩子详解


### 4.1 服务端钩子概述


**运行位置**：
```
客户端钩子 vs 服务端钩子：

客户端（你的电脑）：
pre-commit → commit-msg → post-commit → pre-push
                                        ↓
                                   网络传输
                                        ↓
服务端（GitHub/GitLab等）：
pre-receive → update → post-receive
```

### 4.2 post-receive：自动部署的利器


**典型应用**：网站自动部署

**部署流程图**：
```
开发流程：
本地修改代码 → git push → 服务器接收 → post-receive钩子 → 自动部署

具体步骤：
1. 开发者推送代码到远程仓库
2. 服务器触发post-receive钩子
3. 钩子脚本自动拉取最新代码
4. 重启Web服务器
5. 网站更新完成
```

**部署脚本示例**：
```bash
#!/bin/bash
# 服务器上的 post-receive 钩子

echo "🚀 开始自动部署..."

# 切换到网站目录
cd /var/www/mywebsite

# 拉取最新代码
git pull origin main

# 安装依赖
npm install

# 构建项目
npm run build

# 重启服务
systemctl restart nginx

echo "✅ 部署完成！"
```

---

## 5. ✍️ 钩子脚本编写实战


### 5.1 创建你的第一个钩子


**步骤一：进入钩子目录**
```bash
cd your-project/.git/hooks
```

**步骤二：创建钩子文件**
```bash
# 创建pre-commit钩子
touch pre-commit

# 或者复制示例文件
cp pre-commit.sample pre-commit
```

**步骤三：编写钩子脚本**
```bash
#!/bin/bash
# 简单的pre-commit钩子示例

echo "🔍 检查中..."

# 检查是否有TODO注释
if git diff --cached | grep -i "TODO"; then
    echo "❌ 发现TODO注释，请处理后再提交"
    exit 1
fi

echo "✅ 检查通过"
exit 0
```

### 5.2 脚本编写最佳实践


**脚本结构模板**：
```bash
#!/bin/bash
# 钩子描述：这个钩子的作用

# 1. 环境检查
echo "🔧 环境检查..."

# 2. 核心检查逻辑
echo "🔍 执行检查..."

# 3. 结果处理
if [ 检查结果 ]; then
    echo "✅ 检查通过"
    exit 0
else
    echo "❌ 检查失败"
    exit 1
fi
```

**编程语言选择**：
```
支持的脚本类型：
✅ Bash脚本     → #!/bin/bash
✅ Python脚本   → #!/usr/bin/env python3
✅ Node.js脚本  → #!/usr/bin/env node
✅ 任何可执行文件
```

### 5.3 实用钩子脚本集合


**① 防止大文件提交**：
```bash
#!/bin/bash
# pre-commit: 检查文件大小

max_size=5242880  # 5MB = 5 * 1024 * 1024

for file in $(git diff --cached --name-only); do
    if [ -f "$file" ]; then
        size=$(wc -c < "$file")
        if [ $size -gt $max_size ]; then
            echo "❌ 文件 $file 太大（$(($size/1024/1024))MB），最大允许5MB"
            exit 1
        fi
    fi
done

echo "✅ 文件大小检查通过"
```

**② 代码质量检查**：
```bash
#!/bin/bash
# pre-commit: 多语言代码检查

echo "🔍 正在检查代码质量..."

# JavaScript/TypeScript 检查
if ls *.js *.ts > /dev/null 2>&1; then
    npx eslint *.js *.ts
    if [ $? -ne 0 ]; then
        echo "❌ JavaScript代码检查失败"
        exit 1
    fi
fi

# Python 检查
if ls *.py > /dev/null 2>&1; then
    flake8 *.py
    if [ $? -ne 0 ]; then
        echo "❌ Python代码检查失败"
        exit 1
    fi
fi

echo "✅ 代码质量检查通过"
```

---

## 6. 🔐 钩子权限与安全


### 6.1 文件权限设置


**权限重要性**：
```
权限问题 = 钩子不执行

常见错误：
-rw-r--r-- pre-commit  ← 没有执行权限，不会运行
-rwxr-xr-x pre-commit  ← 有执行权限，正常运行
```

**设置执行权限**：
```bash
# 给钩子文件添加执行权限
chmod +x .git/hooks/pre-commit
chmod +x .git/hooks/post-commit
chmod +x .git/hooks/pre-push

# 检查权限
ls -la .git/hooks/pre-commit
```

### 6.2 安全注意事项


**安全原则**：
- **不要在钩子中处理敏感信息**（密码、密钥）
- **验证输入数据**，防止恶意脚本注入
- **限制钩子权限**，不要使用root权限运行
- **定期检查钩子内容**，防止被恶意修改

**安全示例**：
```bash
#!/bin/bash
# 安全的钩子脚本示例

# ❌ 不安全：直接使用用户输入
# rm -rf $1

# ✅ 安全：验证输入
input="$1"
if [[ "$input" =~ ^[a-zA-Z0-9_.-]+$ ]]; then
    echo "输入安全：$input"
else
    echo "❌ 输入包含非法字符"
    exit 1
fi
```

### 6.3 团队协作中的钩子管理


**问题**：钩子文件不会被Git跟踪

**解决方案**：
```
项目结构：
your-project/
├── src/
├── hooks/                    ← 创建hooks文件夹
│   ├── pre-commit           ← 存放钩子脚本
│   ├── post-commit
│   └── install-hooks.sh     ← 安装脚本
└── README.md
```

**安装脚本示例**：
```bash
#!/bin/bash
# hooks/install-hooks.sh

echo "📥 安装Git钩子..."

# 复制钩子文件到.git/hooks/
cp hooks/* .git/hooks/

# 设置执行权限
chmod +x .git/hooks/*

echo "✅ 钩子安装完成"
```

---

## 7. 🎯 常见应用场景


### 7.1 前端项目自动化


**场景描述**：React/Vue项目的代码质量控制

**钩子配置**：
```bash
#!/bin/bash
# pre-commit for 前端项目

echo "🎨 前端代码检查中..."

# 1. 代码格式化
echo "正在格式化代码..."
npx prettier --write src/**/*.{js,jsx,ts,tsx,css,scss}

# 2. ESLint检查
echo "正在检查代码规范..."
npx eslint src/
if [ $? -ne 0 ]; then
    echo "❌ 代码规范检查失败"
    exit 1
fi

# 3. 类型检查（TypeScript）
echo "正在检查类型..."
npx tsc --noEmit
if [ $? -ne 0 ]; then
    echo "❌ 类型检查失败"
    exit 1
fi

# 4. 运行测试
echo "正在运行测试..."
npm test -- --watchAll=false
if [ $? -ne 0 ]; then
    echo "❌ 测试失败"
    exit 1
fi

echo "✅ 前端检查全部通过"
```

### 7.2 后端API项目


**Python Django/Flask项目**：
```bash
#!/bin/bash
# pre-commit for Python后端

echo "🐍 Python后端检查中..."

# 1. 代码格式化
black .
isort .

# 2. 代码质量检查
flake8 .
if [ $? -ne 0 ]; then
    echo "❌ 代码质量检查失败"
    exit 1
fi

# 3. 安全检查
bandit -r .
if [ $? -ne 0 ]; then
    echo "❌ 安全检查失败"
    exit 1
fi

# 4. 运行测试
pytest
if [ $? -ne 0 ]; then
    echo "❌ 测试失败"
    exit 1
fi

echo "✅ 后端检查全部通过"
```

### 7.3 自动部署场景


**简单的静态网站部署**：
```bash
#!/bin/bash
# post-receive: 静态网站自动部署

echo "🌐 开始部署静态网站..."

# 网站目录
SITE_DIR="/var/www/html"
REPO_DIR="/opt/repos/website.git"

# 1. 清理旧文件
rm -rf $SITE_DIR/*

# 2. 检出最新代码
git --git-dir=$REPO_DIR --work-tree=$SITE_DIR checkout -f

# 3. 安装依赖并构建
cd $SITE_DIR
npm install
npm run build

# 4. 设置权限
chown -R www-data:www-data $SITE_DIR
chmod -R 755 $SITE_DIR

# 5. 重启Web服务器
systemctl reload nginx

echo "✅ 网站部署完成！"
echo "🌐 请访问: https://yourwebsite.com"
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的基本概念


```
🔸 Git钩子本质：在特定Git操作时自动执行的脚本
🔸 钩子位置：.git/hooks/ 目录下的可执行文件
🔸 钩子类型：客户端钩子（本地）+ 服务端钩子（远程）
🔸 执行权限：钩子文件必须有执行权限才能运行
🔸 返回值：exit 0 表示成功，exit 1 表示失败
```

### 8.2 关键钩子理解要点


**🔹 pre-commit（提交前检查）**：
```
触发时机：git commit 执行前
主要用途：代码质量检查、格式验证
成功：继续提交
失败：取消提交
```

**🔹 post-commit（提交后通知）**：
```
触发时机：git commit 成功后
主要用途：通知、备份、统计
特点：不能阻止提交（已经完成）
```

**🔹 pre-push（推送前检查）**：
```
触发时机：git push 执行前
主要用途：完整测试、最终验证
作用：防止有问题的代码推送到远程
```

**🔹 post-receive（接收后处理）**：
```
触发时机：服务器接收推送后
主要用途：自动部署、CI/CD
运行位置：远程服务器上
```

### 8.3 实际应用价值


**🎯 开发质量提升**：
- **自动检查**：代码格式、语法、测试
- **标准统一**：团队遵循相同的代码规范
- **错误预防**：在提交前发现并修复问题

**⚡ 工作效率提升**：
- **自动化**：减少手动重复操作
- **快速反馈**：立即发现问题
- **持续集成**：与CI/CD流程无缝集成

**🔧 运维自动化**：
- **自动部署**：代码推送后自动更新网站
- **通知机制**：及时告知团队成员
- **备份机制**：自动备份重要代码

### 8.4 新手实践建议


**🚀 入门步骤**：
1. **从简单开始**：先写一个打印信息的pre-commit钩子
2. **逐步增强**：添加代码检查、测试运行等功能
3. **团队共享**：使用install-hooks.sh脚本分享给团队
4. **持续改进**：根据项目需要不断优化钩子

**⚠️ 常见陷阱**：
- **忘记设置执行权限**：chmod +x 是必须的
- **钩子路径错误**：必须在 .git/hooks/ 目录下
- **脚本语法错误**：先在命令行测试脚本
- **过度复杂化**：从简单开始，逐步添加功能

**核心记忆口诀**：
- **钩子如哨兵，自动把关门**
- **pre是之前，post是之后**
- **权限要设对，脚本才执行**
- **团队要共享，质量有保障**