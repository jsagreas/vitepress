---
title: 2ã€Sessioné›†ä¸­å­˜å‚¨æ–¹æ¡ˆ
---
## ğŸ“š ç›®å½•

1. [ä»€ä¹ˆæ˜¯Sessioné›†ä¸­å­˜å‚¨](#1-ä»€ä¹ˆæ˜¯Sessioné›†ä¸­å­˜å‚¨)
2. [ä¸ºä»€ä¹ˆéœ€è¦é›†ä¸­å­˜å‚¨](#2-ä¸ºä»€ä¹ˆéœ€è¦é›†ä¸­å­˜å‚¨)
3. [Redisç»Ÿä¸€å­˜å‚¨æ–¹æ¡ˆ](#3-Redisç»Ÿä¸€å­˜å‚¨æ–¹æ¡ˆ)
4. [æ•°æ®åº“Sessionå­˜å‚¨](#4-æ•°æ®åº“Sessionå­˜å‚¨)
5. [Spring Sessioné›†æˆ](#5-Spring-Sessioné›†æˆ)
6. [åˆ†å¸ƒå¼æ¶æ„æœ€ä½³å®è·µ](#6-åˆ†å¸ƒå¼æ¶æ„æœ€ä½³å®è·µ)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ ä»€ä¹ˆæ˜¯Sessioné›†ä¸­å­˜å‚¨


### 1.1 æ¦‚å¿µç†è§£


ğŸ§  **ç®€å•ç†è§£**ï¼šæŠŠæ‰€æœ‰æœåŠ¡å™¨çš„Sessionæ•°æ®éƒ½å­˜åˆ°ä¸€ä¸ªå…¬å…±çš„åœ°æ–¹ï¼Œå°±åƒæ‰€æœ‰äººéƒ½æŠŠé’±å­˜åˆ°åŒä¸€ä¸ªé“¶è¡Œé‡Œ

**ğŸ“– æ­£å¼å®šä¹‰**ï¼š
Sessioné›†ä¸­å­˜å‚¨æ˜¯æŒ‡å°†å¤šä¸ªWebæœåŠ¡å™¨çš„Sessionæ•°æ®ç»Ÿä¸€å­˜å‚¨åœ¨ç‹¬ç«‹çš„å­˜å‚¨ç³»ç»Ÿä¸­ï¼Œè€Œä¸æ˜¯å­˜å‚¨åœ¨å„è‡ªçš„æœåŠ¡å™¨å†…å­˜ä¸­ã€‚

```
ä¼ ç»Ÿæ–¹å¼ï¼ˆå„è‡ªå­˜å‚¨ï¼‰ï¼š           é›†ä¸­å­˜å‚¨æ–¹å¼ï¼š
ç”¨æˆ· â†’ æœåŠ¡å™¨Aï¼ˆSessionåœ¨Aï¼‰      ç”¨æˆ· â†’ æœåŠ¡å™¨A â†˜
ç”¨æˆ· â†’ æœåŠ¡å™¨Bï¼ˆSessionåœ¨Bï¼‰              â†“     Redis/æ•°æ®åº“
ç”¨æˆ· â†’ æœåŠ¡å™¨Cï¼ˆSessionåœ¨Cï¼‰      ç”¨æˆ· â†’ æœåŠ¡å™¨B â†—
                                ç”¨æˆ· â†’ æœåŠ¡å™¨C â†—
é—®é¢˜ï¼šSessionä¸å…±äº«             ä¼˜åŠ¿ï¼šæ‰€æœ‰æœåŠ¡å™¨å…±äº«Session
```

### 1.2 æ ¸å¿ƒä»·å€¼


ğŸ’¡ **å®é™…æ„ä¹‰**ï¼š
- **ç”¨æˆ·ä½“éªŒ**ï¼šæ— è®ºè®¿é—®å“ªå°æœåŠ¡å™¨éƒ½èƒ½ä¿æŒç™»å½•çŠ¶æ€
- **ç³»ç»Ÿæ‰©å±•**ï¼šå¯ä»¥éšæ„å¢åŠ æœåŠ¡å™¨æ•°é‡
- **é«˜å¯ç”¨**ï¼šå•å°æœåŠ¡å™¨å®•æœºä¸å½±å“ç”¨æˆ·Session

---

## 2. ğŸ¤” ä¸ºä»€ä¹ˆéœ€è¦é›†ä¸­å­˜å‚¨


### 2.1 ä¼ ç»ŸSessionå­˜å‚¨çš„é—®é¢˜


**ğŸ”¸ Sessionç²˜æ€§é—®é¢˜**

æƒ³è±¡ä¸€ä¸ªåœºæ™¯ï¼šä½ åœ¨æ·˜å®ç™»å½•ååŠ äº†å•†å“åˆ°è´­ç‰©è½¦ï¼Œä½†ä¸‹æ¬¡åˆ·æ–°é¡µé¢æ—¶è´Ÿè½½å‡è¡¡æŠŠä½ åˆ†é…åˆ°å¦ä¸€å°æœåŠ¡å™¨ï¼Œç»“æœå‘ç°éœ€è¦é‡æ–°ç™»å½•ï¼Œè´­ç‰©è½¦ä¹Ÿç©ºäº†ã€‚

```
ç”¨æˆ·ç™»å½•æµç¨‹é—®é¢˜ç¤ºæ„ï¼š
ç¬¬ä¸€æ¬¡è®¿é—® â†’ æœåŠ¡å™¨A â†’ ç™»å½•æˆåŠŸï¼ŒSessionå­˜åœ¨A
ç¬¬äºŒæ¬¡è®¿é—® â†’ æœåŠ¡å™¨B â†’ æ‰¾ä¸åˆ°Sessionï¼Œè¦æ±‚é‡æ–°ç™»å½•
ç¬¬ä¸‰æ¬¡è®¿é—® â†’ æœåŠ¡å™¨A â†’ åˆèƒ½æ­£å¸¸è®¿é—®äº†

ç”¨æˆ·æ„Ÿå—ï¼šç½‘ç«™ä¸ç¨³å®šï¼Œæ—¶å¥½æ—¶å
```

**ğŸ”¸ æ‰©å±•æ€§é™åˆ¶**

```
ä¼ ç»Ÿæ–¹å¼çš„å›°å¢ƒï¼š
ğŸ¢ å…¬å¸ä¸šåŠ¡å¢é•¿ â†’ éœ€è¦å¢åŠ æœåŠ¡å™¨
ğŸ’» æ–°å¢æœåŠ¡å™¨ â†’ Sessionæ•°æ®ä¸åŒæ­¥
ğŸ‘¥ ç”¨æˆ·è®¿é—® â†’ ä½“éªŒä¸ä¸€è‡´
ğŸ“‰ ç”¨æˆ·æµå¤± â†’ ä¸šåŠ¡å—æŸ
```

### 2.2 é›†ä¸­å­˜å‚¨è§£å†³çš„æ ¸å¿ƒé—®é¢˜


| é—®é¢˜ç±»å‹ | **ä¼ ç»Ÿå­˜å‚¨** | **é›†ä¸­å­˜å‚¨** |
|---------|------------|------------|
| ğŸ”„ **Sessionå…±äº«** | âŒ å„æœåŠ¡å™¨ç‹¬ç«‹ | âœ… æ‰€æœ‰æœåŠ¡å™¨å…±äº« |
| ğŸ“ˆ **æ‰©å±•èƒ½åŠ›** | âŒ å—é™åˆ¶ | âœ… æ— é™åˆ¶æ‰©å±• |
| ğŸ›¡ï¸ **æ•…éšœæ¢å¤** | âŒ æ•°æ®ä¸¢å¤± | âœ… æ•°æ®æŒä¹…åŒ– |
| ğŸ‘¥ **ç”¨æˆ·ä½“éªŒ** | âŒ ä¸ä¸€è‡´ | âœ… å§‹ç»ˆä¸€è‡´ |

---

## 3. ğŸ”´ Redisç»Ÿä¸€å­˜å‚¨æ–¹æ¡ˆ


### 3.1 ä¸ºä»€ä¹ˆé€‰æ‹©Redis


ğŸ¯ **Redisçš„å¤©ç„¶ä¼˜åŠ¿**ï¼š

**âš¡ æ€§èƒ½ä¼˜åŠ¿**ï¼š
- å†…å­˜å­˜å‚¨ï¼Œè¯»å†™é€Ÿåº¦æå¿«ï¼ˆ10ä¸‡+QPSï¼‰
- æ¯”æ•°æ®åº“å¿«100å€ä»¥ä¸Š

**ğŸ”§ åŠŸèƒ½ä¼˜åŠ¿**ï¼š
- å¤©ç„¶æ”¯æŒè¿‡æœŸæ—¶é—´ï¼ˆSessionè¶…æ—¶è‡ªåŠ¨æ¸…ç†ï¼‰
- æ”¯æŒå¤šç§æ•°æ®ç»“æ„
- æ”¯æŒæŒä¹…åŒ–ï¼Œé‡å¯ä¸ä¸¢æ•°æ®

**ğŸ’ª å¯é æ€§ä¼˜åŠ¿**ï¼š
- æ”¯æŒä¸»ä»å¤åˆ¶
- æ”¯æŒé›†ç¾¤æ¨¡å¼
- é«˜å¯ç”¨ä¿éšœ

### 3.2 Redis Sessionå­˜å‚¨æ¶æ„


```
å®Œæ•´çš„Redis Sessionæ¶æ„ï¼š

ç”¨æˆ·è¯·æ±‚ â†’ è´Ÿè½½å‡è¡¡å™¨ â†’ WebæœåŠ¡å™¨é›†ç¾¤ â†’ Redisé›†ç¾¤
    â†“                      â†“              â†“
æµè§ˆå™¨Cookie          Sessionè¯»å†™æ“ä½œ   ç»Ÿä¸€Sessionå­˜å‚¨
    â†‘_____________________________________________â†‘
                    æ•°æ®æµè½¬å®Œæ•´é“¾è·¯
```

### 3.3 Spring Boot + Rediså®ç°


**ğŸ”§ ä¾èµ–é…ç½®**

```xml
<!-- åªå±•ç¤ºæ ¸å¿ƒä¾èµ– -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.session</groupId>
    <artifactId>spring-session-data-redis</artifactId>
</dependency>
```

**âš™ï¸ é…ç½®æ–‡ä»¶**

```properties
# Redisè¿æ¥é…ç½®
spring.redis.host=localhost
spring.redis.port=6379
spring.redis.password=yourpassword

# Sessioné…ç½®
spring.session.store-type=redis
spring.session.timeout=30m
server.servlet.session.cookie.name=JSESSIONID
```

**ğŸ’» æ ¸å¿ƒé…ç½®ç±»**

```java
@EnableRedisHttpSession(maxInactiveIntervalInSeconds = 1800)
@Configuration
public class RedisSessionConfig {
    
    @Bean
    public RedisTemplate<String, Object> redisTemplate(
            RedisConnectionFactory factory) {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(factory);
        
        // è®¾ç½®åºåˆ—åŒ–æ–¹å¼ï¼ˆé‡è¦ï¼‰
        template.setDefaultSerializer(new GenericJackson2JsonRedisSerializer());
        return template;
    }
}
```

### 3.4 Sessionæ“ä½œç¤ºä¾‹


**ğŸ“ æ§åˆ¶å™¨ä»£ç **

```java
@RestController
public class SessionController {
    
    // ç™»å½•æ¥å£
    @PostMapping("/login")
    public String login(HttpServletRequest request, 
                       @RequestParam String username) {
        
        // è·å–Sessionï¼ˆè‡ªåŠ¨å­˜å‚¨åˆ°Redisï¼‰
        HttpSession session = request.getSession();
        session.setAttribute("user", username);
        session.setAttribute("loginTime", new Date());
        
        return "ç™»å½•æˆåŠŸï¼ŒSessionå·²å­˜å‚¨åˆ°Redis";
    }
    
    // è·å–ç”¨æˆ·ä¿¡æ¯
    @GetMapping("/userInfo")
    public Map<String, Object> getUserInfo(HttpServletRequest request) {
        HttpSession session = request.getSession();
        
        Map<String, Object> result = new HashMap<>();
        result.put("user", session.getAttribute("user"));
        result.put("loginTime", session.getAttribute("loginTime"));
        result.put("sessionId", session.getId());
        
        return result;
    }
}
```

### 3.5 Redisä¸­çš„Sessionæ•°æ®ç»“æ„


**ğŸ“Š æ•°æ®å­˜å‚¨å½¢å¼**

```
Redisä¸­çš„Sessionæ•°æ®ï¼š

Key: spring:session:sessions:xxxxx-xxxxx-xxxxx
Value: {
  "sessionAttr:user": "å¼ ä¸‰",
  "sessionAttr:loginTime": "2024-01-01 10:00:00",
  "creationTime": 1704067200000,
  "lastAccessedTime": 1704067800000,
  "maxInactiveInterval": 1800,
  "expired": false
}

è¿‡æœŸæ—¶é—´ï¼šè‡ªåŠ¨è®¾ç½®ä¸º30åˆ†é’Ÿï¼ˆ1800ç§’ï¼‰
```

### 3.6 æ€§èƒ½ä¼˜åŒ–é…ç½®


**ğŸš€ è¿æ¥æ± ä¼˜åŒ–**

```properties
# Redisè¿æ¥æ± é…ç½®
spring.redis.jedis.pool.max-active=50
spring.redis.jedis.pool.max-wait=3000ms
spring.redis.jedis.pool.max-idle=20
spring.redis.jedis.pool.min-idle=5

# è¶…æ—¶é…ç½®
spring.redis.connect-timeout=5000ms
spring.redis.timeout=3000ms
```

---

## 4. ğŸ—„ï¸ æ•°æ®åº“Sessionå­˜å‚¨


### 4.1 ä»€ä¹ˆæ—¶å€™ç”¨æ•°æ®åº“å­˜å‚¨


**ğŸ¯ é€‚ç”¨åœºæ™¯**ï¼š
- å·²æœ‰å®Œå–„çš„æ•°æ®åº“é›†ç¾¤
- å¯¹Sessionæ•°æ®æœ‰å¼ºä¸€è‡´æ€§è¦æ±‚
- éœ€è¦å¤æ‚çš„SessionæŸ¥è¯¢å’Œåˆ†æ
- Redisç­‰NoSQLä¸å¯ç”¨çš„ç¯å¢ƒ

**âš–ï¸ ä¼˜ç¼ºç‚¹å¯¹æ¯”**ï¼š

| ç‰¹æ€§ | **æ•°æ®åº“å­˜å‚¨** | **Rediså­˜å‚¨** |
|------|--------------|--------------|
| ğŸƒâ€â™‚ï¸ **æ€§èƒ½** | ä¸€èˆ¬ï¼ˆæ¯«ç§’çº§ï¼‰ | ä¼˜ç§€ï¼ˆå¾®ç§’çº§ï¼‰ |
| ğŸ’¾ **æŒä¹…åŒ–** | å®Œå…¨å¯é  | å¯é…ç½® |
| ğŸ” **æŸ¥è¯¢èƒ½åŠ›** | å¼ºå¤§ï¼ˆSQLï¼‰ | åŸºç¡€ |
| ğŸ’° **æˆæœ¬** | ä¸­ç­‰ | è¾ƒä½ |
| ğŸ“Š **åˆ†æèƒ½åŠ›** | ä¸°å¯Œ | æœ‰é™ |

### 4.2 æ•°æ®åº“è¡¨è®¾è®¡


**ğŸ“‹ Sessionè¡¨ç»“æ„**

```sql
-- åˆ›å»ºSessionå­˜å‚¨è¡¨
CREATE TABLE http_sessions (
    session_id VARCHAR(100) NOT NULL PRIMARY KEY,
    creation_time BIGINT NOT NULL,
    last_access_time BIGINT NOT NULL,
    max_inactive_interval INT NOT NULL,
    expiry_time BIGINT NOT NULL,
    principal_name VARCHAR(100),
    INDEX idx_expiry_time (expiry_time),
    INDEX idx_principal (principal_name)
) ENGINE=InnoDB;

-- Sessionå±æ€§è¡¨
CREATE TABLE session_attributes (
    session_primary_id VARCHAR(100) NOT NULL,
    attribute_name VARCHAR(200) NOT NULL,
    attribute_bytes BLOB NOT NULL,
    PRIMARY KEY (session_primary_id, attribute_name),
    FOREIGN KEY (session_primary_id) REFERENCES http_sessions(session_id) ON DELETE CASCADE
) ENGINE=InnoDB;
```

### 4.3 Spring Session JDBCé…ç½®


**âš™ï¸ é…ç½®æ–‡ä»¶**

```properties
# æ•°æ®åº“é…ç½®
spring.datasource.url=jdbc:mysql://localhost:3306/sessiondb
spring.datasource.username=root
spring.datasource.password=password

# Sessioné…ç½®
spring.session.store-type=jdbc
spring.session.timeout=30m
spring.session.jdbc.initialize-schema=always
```

**ğŸ’» é…ç½®ç±»**

```java
@EnableJdbcHttpSession(maxInactiveIntervalInSeconds = 1800)
@Configuration
public class JdbcSessionConfig {
    
    @Bean
    public JdbcOperationsSessionRepository sessionRepository(
            JdbcOperations jdbcOperations, 
            TransactionOperations transactionOperations) {
        
        JdbcOperationsSessionRepository repository = 
            new JdbcOperationsSessionRepository(jdbcOperations, transactionOperations);
        
        // è‡ªå®šä¹‰è¡¨åï¼ˆå¯é€‰ï¼‰
        repository.setTableName("custom_sessions");
        
        return repository;
    }
}
```

### 4.4 æ•°æ®åº“Sessionçš„æ€§èƒ½ä¼˜åŒ–


**ğŸ“ˆ æ€§èƒ½æå‡ç­–ç•¥**ï¼š

**ğŸ”¸ ç´¢å¼•ä¼˜åŒ–**
```sql
-- ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µå»ºç«‹ç´¢å¼•
CREATE INDEX idx_expiry_time ON http_sessions(expiry_time);
CREATE INDEX idx_last_access ON http_sessions(last_access_time);
CREATE INDEX idx_principal ON http_sessions(principal_name);
```

**ğŸ”¸ å®šæœŸæ¸…ç†è¿‡æœŸSession**
```sql
-- å®šæ—¶æ¸…ç†è¿‡æœŸSessionï¼ˆå»ºè®®æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡ï¼‰
DELETE FROM http_sessions 
WHERE expiry_time < UNIX_TIMESTAMP(NOW()) * 1000;
```

---

## 5. ğŸŒ¸ Spring Sessioné›†æˆ


### 5.1 Spring Sessionçš„ä»·å€¼


ğŸ¯ **æ ¸å¿ƒä»·å€¼**ï¼šè®©Sessionå­˜å‚¨æ–¹å¼çš„åˆ‡æ¢å˜å¾—ç®€å•ï¼Œåªéœ€è¦ä¿®æ”¹é…ç½®ï¼Œä»£ç æ— éœ€æ”¹åŠ¨

**ğŸ”„ æ”¯æŒçš„å­˜å‚¨æ–¹å¼**ï¼š
- Redis
- MongoDB  
- JDBCï¼ˆå…³ç³»å‹æ•°æ®åº“ï¼‰
- Hazelcast
- è‡ªå®šä¹‰å­˜å‚¨

### 5.2 ç»Ÿä¸€çš„ç¼–ç¨‹æ¨¡å‹


**ğŸ’¡ å…³é”®ä¼˜åŠ¿**ï¼šæ— è®ºåº•å±‚ç”¨Redisè¿˜æ˜¯æ•°æ®åº“ï¼Œä»£ç éƒ½ä¸€æ ·

```java
// è¿™æ®µä»£ç åœ¨Rediså’Œæ•°æ®åº“å­˜å‚¨ä¸‹éƒ½å®Œå…¨ç›¸åŒ
@RestController
public class UniversalSessionController {
    
    @PostMapping("/setData")
    public String setSessionData(HttpServletRequest request,
                               @RequestParam String key,
                               @RequestParam String value) {
        // Spring Sessionè‡ªåŠ¨å¤„ç†å­˜å‚¨é€»è¾‘
        request.getSession().setAttribute(key, value);
        return "æ•°æ®å·²ä¿å­˜åˆ°Session";
    }
    
    @GetMapping("/getData")
    public Object getSessionData(HttpServletRequest request,
                               @RequestParam String key) {
        // ä»Sessionä¸­è·å–æ•°æ®ï¼ˆè‡ªåŠ¨ä»å­˜å‚¨ç³»ç»Ÿè¯»å–ï¼‰
        return request.getSession().getAttribute(key);
    }
}
```

### 5.3 å¤šå­˜å‚¨åˆ‡æ¢é…ç½®


**ğŸ”„ Rediså­˜å‚¨é…ç½®**

```properties
# application-redis.properties
spring.session.store-type=redis
spring.redis.host=localhost
spring.redis.port=6379
```

**ğŸ”„ æ•°æ®åº“å­˜å‚¨é…ç½®**

```properties
# application-jdbc.properties
spring.session.store-type=jdbc
spring.datasource.url=jdbc:mysql://localhost:3306/sessiondb
spring.datasource.username=root
spring.datasource.password=password
```

**ğŸ”„ ç¯å¢ƒåˆ‡æ¢**

```properties
# å¼€å‘ç¯å¢ƒç”¨Redis
spring.profiles.active=redis

# ç”Ÿäº§ç¯å¢ƒç”¨æ•°æ®åº“
spring.profiles.active=jdbc
```

### 5.4 Sessionäº‹ä»¶ç›‘å¬


**ğŸ“¡ ç›‘å¬Sessionåˆ›å»ºå’Œé”€æ¯**

```java
@Component
public class SessionEventListener {
    
    @EventListener
    public void handleSessionCreated(SessionCreatedEvent event) {
        String sessionId = event.getSession().getId();
        System.out.println("Sessionåˆ›å»º: " + sessionId);
        
        // å¯ä»¥åšä¸€äº›åˆå§‹åŒ–å·¥ä½œ
        // æ¯”å¦‚è®°å½•ç”¨æˆ·ä¸Šçº¿æ—¥å¿—
    }
    
    @EventListener
    public void handleSessionDestroyed(SessionDestroyedEvent event) {
        String sessionId = event.getSession().getId();
        System.out.println("Sessioné”€æ¯: " + sessionId);
        
        // å¯ä»¥åšä¸€äº›æ¸…ç†å·¥ä½œ
        // æ¯”å¦‚è®°å½•ç”¨æˆ·ä¸‹çº¿æ—¥å¿—
    }
}
```

### 5.5 è‡ªå®šä¹‰Sessioné…ç½®


**âš™ï¸ é«˜çº§é…ç½®é€‰é¡¹**

```java
@Configuration
public class CustomSessionConfig {
    
    @Bean
    public CookieSerializer cookieSerializer() {
        DefaultCookieSerializer serializer = new DefaultCookieSerializer();
        
        // è‡ªå®šä¹‰Cookieé…ç½®
        serializer.setCookieName("MY_SESSION"); // è‡ªå®šä¹‰Cookieå
        serializer.setCookiePath("/");          // Cookieè·¯å¾„
        serializer.setDomainNamePattern("^.+?\\.(\\w+\\.[a-z]+)$"); // åŸŸåæ¨¡å¼
        serializer.setHttpOnly(true);          // é˜²XSSæ”»å‡»
        serializer.setSecure(true);            // HTTPSç¯å¢ƒ
        serializer.setUseSecureCookie(true);   // å¼ºåˆ¶å®‰å…¨Cookie
        
        return serializer;
    }
    
    @Bean
    public HttpSessionIdResolver httpSessionIdResolver() {
        // ä½¿ç”¨Headeræ–¹å¼ä¼ é€’SessionIDï¼ˆé€‚ç”¨äºAPIï¼‰
        return HeaderHttpSessionIdResolver.xAuthToken();
    }
}
```

---

## 6. ğŸ—ï¸ åˆ†å¸ƒå¼æ¶æ„æœ€ä½³å®è·µ


### 6.1 æ¶æ„è®¾è®¡åŸåˆ™


**ğŸ¯ è®¾è®¡ç›®æ ‡**ï¼š

```
é«˜å¯ç”¨æ¶æ„ç›®æ ‡ï¼š
â”œâ”€â”€ 99.9% å¯ç”¨æ€§ä¿éšœ
â”œâ”€â”€ æ¯«ç§’çº§å“åº”æ—¶é—´
â”œâ”€â”€ æ”¯æŒæ¨ªå‘æ‰©å±•
â””â”€â”€ æ•°æ®å¼ºä¸€è‡´æ€§
```

**ğŸ›ï¸ åˆ†å±‚æ¶æ„è®¾è®¡**

```
å®Œæ•´çš„åˆ†å¸ƒå¼Sessionæ¶æ„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·æµè§ˆå™¨     â”‚  â”‚   ç§»åŠ¨ç«¯APP     â”‚  â”‚   ç¬¬ä¸‰æ–¹ç³»ç»Ÿ     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                    â”‚                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è´Ÿè½½å‡è¡¡å™¨ (Nginx)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                    â”‚                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   WebæœåŠ¡å™¨A     â”‚  â”‚   WebæœåŠ¡å™¨B     â”‚  â”‚   WebæœåŠ¡å™¨C     â”‚
â”‚  (æ— çŠ¶æ€åº”ç”¨)     â”‚  â”‚  (æ— çŠ¶æ€åº”ç”¨)     â”‚  â”‚  (æ— çŠ¶æ€åº”ç”¨)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                    â”‚                    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚           â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚     Redisé›†ç¾¤ (ä¸»ä»)         â”‚
         â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
         â”‚   â”‚ Master  â”‚ â”‚ Slave   â”‚   â”‚
         â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 Redisé›†ç¾¤éƒ¨ç½²ç­–ç•¥


**ğŸ”¸ ä¸»ä»å¤åˆ¶æ¨¡å¼**

```bash
# Redisä¸»æœåŠ¡å™¨é…ç½® (redis-master.conf)
port 6379
bind 0.0.0.0
requirepass your-password
save 900 1      # 900ç§’å†…æœ‰1æ¬¡å†™å…¥å°±ä¿å­˜
save 300 10     # 300ç§’å†…æœ‰10æ¬¡å†™å…¥å°±ä¿å­˜
save 60 10000   # 60ç§’å†…æœ‰10000æ¬¡å†™å…¥å°±ä¿å­˜

# Redisä»æœåŠ¡å™¨é…ç½® (redis-slave.conf)  
port 6380
bind 0.0.0.0
replicaof 192.168.1.100 6379  # ä¸»æœåŠ¡å™¨åœ°å€
masterauth your-password      # ä¸»æœåŠ¡å™¨å¯†ç 
replica-read-only yes         # ä»æœåŠ¡å™¨åªè¯»
```

**ğŸ”¸ å“¨å…µæ¨¡å¼é…ç½®**

```bash
# å“¨å…µé…ç½® (sentinel.conf)
port 26379
sentinel monitor mymaster 192.168.1.100 6379 2
sentinel auth-pass mymaster your-password
sentinel down-after-milliseconds mymaster 5000
sentinel failover-timeout mymaster 10000
```

### 6.3 Sessionæ•°æ®ä¼˜åŒ–ç­–ç•¥


**ğŸ“Š æ•°æ®åˆ†å±‚å­˜å‚¨**

```java
@Service
public class OptimizedSessionService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // çƒ­ç‚¹æ•°æ®ï¼ˆç”¨æˆ·åŸºæœ¬ä¿¡æ¯ï¼‰- å­˜Redis
    public void storeHotData(String sessionId, UserBasicInfo userInfo) {
        String key = "session:hot:" + sessionId;
        redisTemplate.opsForValue().set(key, userInfo, Duration.ofMinutes(30));
    }
    
    // å†·æ•°æ®ï¼ˆç”¨æˆ·è¯¦ç»†èµ„æ–™ï¼‰- å­˜æ•°æ®åº“
    public void storeColdData(String sessionId, UserDetailInfo detailInfo) {
        // å­˜å…¥æ•°æ®åº“ï¼ŒæŒ‰éœ€åŠ è½½
        userDetailRepository.saveBySessionId(sessionId, detailInfo);
    }
    
    // æ™ºèƒ½åŠ è½½ç­–ç•¥
    public UserInfo getUserInfo(String sessionId) {
        // å…ˆåŠ è½½çƒ­ç‚¹æ•°æ®
        UserBasicInfo basicInfo = getHotData(sessionId);
        
        // æŒ‰éœ€åŠ è½½è¯¦ç»†æ•°æ®
        if (needDetailInfo()) {
            UserDetailInfo detailInfo = getColdData(sessionId);
            return UserInfo.merge(basicInfo, detailInfo);
        }
        
        return UserInfo.fromBasic(basicInfo);
    }
}
```

### 6.4 æ€§èƒ½ç›‘æ§ä½“ç³»


**ğŸ“ˆ å…³é”®ç›‘æ§æŒ‡æ ‡**

| æŒ‡æ ‡ç±»å‹ | **ç›‘æ§å†…å®¹** | **å‘Šè­¦é˜ˆå€¼** | **å¤„ç†æªæ–½** |
|---------|-------------|-------------|-------------|
| ğŸƒâ€â™‚ï¸ **å“åº”æ—¶é—´** | Sessionè¯»å†™å»¶è¿Ÿ | >50ms | æ£€æŸ¥ç½‘ç»œ/ä¼˜åŒ–æŸ¥è¯¢ |
| ğŸ“Š **å‘½ä¸­ç‡** | Redisç¼“å­˜å‘½ä¸­ç‡ | <95% | è°ƒæ•´ç¼“å­˜ç­–ç•¥ |
| ğŸ’¾ **å†…å­˜ä½¿ç”¨** | Rediså†…å­˜å ç”¨ | >80% | æ¸…ç†è¿‡æœŸæ•°æ® |
| ğŸ”— **è¿æ¥æ•°** | Redisè¿æ¥æ± ä½¿ç”¨ç‡ | >90% | å¢åŠ è¿æ¥æ± å¤§å° |

**ğŸ“Š ç›‘æ§å®ç°ç¤ºä¾‹**

```java
@Component
public class SessionMonitor {
    
    private final MeterRegistry meterRegistry;
    private final RedisTemplate redisTemplate;
    
    @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    public void checkSessionMetrics() {
        
        // ç›‘æ§Redisè¿æ¥æ•°
        RedisConnectionFactory factory = redisTemplate.getConnectionFactory();
        long activeConnections = getActiveConnections(factory);
        meterRegistry.gauge("session.redis.connections", activeConnections);
        
        // ç›‘æ§Sessionæ•°é‡
        long sessionCount = getSessionCount();
        meterRegistry.gauge("session.total.count", sessionCount);
        
        // ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ
        RedisConnection connection = factory.getConnection();
        Properties info = connection.info("memory");
        long usedMemory = Long.parseLong(info.getProperty("used_memory"));
        meterRegistry.gauge("session.redis.memory", usedMemory);
    }
}
```

### 6.5 å®¹ç¾ä¸å¤‡ä»½ç­–ç•¥


**ğŸ›¡ï¸ å¤šçº§å¤‡ä»½æ–¹æ¡ˆ**

```
å®¹ç¾å¤‡ä»½ä½“ç³»ï¼š

Level 1: å®æ—¶å¤‡ä»½
â”œâ”€â”€ Redisä¸»ä»å¤åˆ¶ï¼ˆå®æ—¶åŒæ­¥ï¼‰
â”œâ”€â”€ å®šæ—¶å¿«ç…§ï¼ˆæ¯å°æ—¶ï¼‰
â””â”€â”€ AOFæŒä¹…åŒ–ï¼ˆå®æ—¶å†™å…¥ï¼‰

Level 2: å¼‚åœ°å¤‡ä»½
â”œâ”€â”€ è·¨æœºæˆ¿Redisé›†ç¾¤
â”œâ”€â”€ æ•°æ®åº“å®šæ—¶åŒæ­¥
â””â”€â”€ å†·å¤‡ä»½å­˜å‚¨

Level 3: åº”æ€¥é¢„æ¡ˆ
â”œâ”€â”€ è‡ªåŠ¨æ•…éšœè½¬ç§»
â”œâ”€â”€ é™çº§æœåŠ¡ï¼ˆä¸´æ—¶Cookieå­˜å‚¨ï¼‰
â””â”€â”€ æ‰‹åŠ¨æ¢å¤æµç¨‹
```

**âš ï¸ æ•…éšœå¤„ç†æµç¨‹**

```java
@Component
public class SessionFailoverHandler {
    
    @Autowired
    private RedisTemplate primaryRedis;
    
    @Autowired  
    private RedisTemplate backupRedis;
    
    public Object getSession(String sessionId) {
        try {
            // å°è¯•ä»ä¸»Redisè·å–
            return primaryRedis.opsForValue().get("session:" + sessionId);
        } catch (Exception e) {
            log.warn("ä¸»Redisä¸å¯ç”¨ï¼Œåˆ‡æ¢åˆ°å¤‡ç”¨Redis");
            try {
                // åˆ‡æ¢åˆ°å¤‡ç”¨Redis
                return backupRedis.opsForValue().get("session:" + sessionId);
            } catch (Exception ex) {
                log.error("å¤‡ç”¨Redisä¹Ÿä¸å¯ç”¨ï¼Œå¯ç”¨é™çº§ç­–ç•¥");
                // å¯ç”¨æœ¬åœ°ä¸´æ—¶å­˜å‚¨æˆ–è¿”å›åŒ¿åSession
                return createAnonymousSession();
            }
        }
    }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ”¸ é›†ä¸­å­˜å‚¨ï¼šæŠŠæ‰€æœ‰æœåŠ¡å™¨çš„Sessionæ”¾åœ¨ä¸€ä¸ªå…¬å…±åœ°æ–¹
ğŸ”¸ Rediså­˜å‚¨ï¼šé«˜æ€§èƒ½å†…å­˜æ•°æ®åº“ï¼Œæœ€é€‚åˆSessionå­˜å‚¨
ğŸ”¸ æ•°æ®åº“å­˜å‚¨ï¼šä¼ ç»Ÿå…³ç³»å‹æ•°æ®åº“ï¼Œé€‚åˆå¤æ‚æŸ¥è¯¢éœ€æ±‚
ğŸ”¸ Spring Sessionï¼šç»Ÿä¸€çš„Sessionç®¡ç†æ¡†æ¶ï¼Œç®€åŒ–å¼€å‘
ğŸ”¸ åˆ†å¸ƒå¼æ¶æ„ï¼šå¤šæœåŠ¡å™¨ååŒå·¥ä½œï¼Œæä¾›é«˜å¯ç”¨æœåŠ¡
```

### 7.2 æŠ€æœ¯é€‰æ‹©å†³ç­–æ ‘


```
é€‰æ‹©Sessionå­˜å‚¨æ–¹æ¡ˆçš„å†³ç­–è·¯å¾„ï¼š

ç”¨æˆ·é‡å¤§å—ï¼Ÿ
â”œâ”€â”€ æ˜¯ â†’ æ€§èƒ½è¦æ±‚é«˜å—ï¼Ÿ
â”‚   â”œâ”€â”€ æ˜¯ â†’ é€‰æ‹©Rediså­˜å‚¨ â­â­â­
â”‚   â””â”€â”€ å¦ â†’ æ•°æ®ä¸€è‡´æ€§è¦æ±‚é«˜å—ï¼Ÿ
â”‚       â”œâ”€â”€ æ˜¯ â†’ é€‰æ‹©æ•°æ®åº“å­˜å‚¨
â”‚       â””â”€â”€ å¦ â†’ é€‰æ‹©Rediså­˜å‚¨
â””â”€â”€ å¦ â†’ ç³»ç»Ÿå¤æ‚å—ï¼Ÿ
    â”œâ”€â”€ æ˜¯ â†’ é€‰æ‹©Spring Session + Redis
    â””â”€â”€ å¦ â†’ æ™®é€šSessionå³å¯
```

### 7.3 å®æ–½è·¯çº¿å›¾


**ğŸš€ å®æ–½æ­¥éª¤**

**Phase 1: åŸºç¡€å‡†å¤‡** â±ï¸ 1-2å¤©
- [ ] æ­å»ºRedisç¯å¢ƒ
- [ ] é›†æˆSpring Session
- [ ] åŸºæœ¬é…ç½®æµ‹è¯•

**Phase 2: åŠŸèƒ½å¼€å‘** â±ï¸ 3-5å¤©  
- [ ] Sessionè¯»å†™æ¥å£å¼€å‘
- [ ] ç”¨æˆ·ç™»å½•é›†æˆ
- [ ] åŸºç¡€æµ‹è¯•ç”¨ä¾‹

**Phase 3: æ€§èƒ½ä¼˜åŒ–** â±ï¸ 2-3å¤©
- [ ] è¿æ¥æ± ä¼˜åŒ–  
- [ ] åºåˆ—åŒ–ä¼˜åŒ–
- [ ] ç¼“å­˜ç­–ç•¥è°ƒæ•´

**Phase 4: ç›‘æ§è¿ç»´** â±ï¸ 2-4å¤©
- [ ] ç›‘æ§æŒ‡æ ‡æ¥å…¥
- [ ] å‘Šè­¦ç­–ç•¥é…ç½®  
- [ ] æ•…éšœæ¼”ç»ƒ

### 7.4 å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ


**â“ å¸¸è§é—®é¢˜ FAQ**

**Q: Sessionä¸¢å¤±æ€ä¹ˆåŠï¼Ÿ**
**A:** æ£€æŸ¥Redisè¿æ¥çŠ¶æ€ï¼Œç¡®è®¤è¿‡æœŸæ—¶é—´è®¾ç½®ï¼ŒæŸ¥çœ‹åºåˆ—åŒ–é…ç½®æ˜¯å¦æ­£ç¡®

**Q: æ€§èƒ½ä¸å¦‚é¢„æœŸæ€ä¹ˆåŠï¼Ÿ** 
**A:** æ£€æŸ¥è¿æ¥æ± é…ç½®ï¼Œè€ƒè™‘è¯»å†™åˆ†ç¦»ï¼Œä¼˜åŒ–æ•°æ®ç»“æ„è®¾è®¡

**Q: å¦‚ä½•å¤„ç†Rediså®•æœºï¼Ÿ**
**A:** é…ç½®Redisä¸»ä»æˆ–é›†ç¾¤ï¼Œå®ç°è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼Œå‡†å¤‡é™çº§ç­–ç•¥

### 7.5 æœ€ä½³å®è·µæ¸…å•


**âœ… å¼€å‘é˜¶æ®µ**
- [ ] ä½¿ç”¨Spring Sessionç»Ÿä¸€ç®¡ç†
- [ ] åˆç†è®¾ç½®Sessionè¿‡æœŸæ—¶é—´
- [ ] é€‰æ‹©åˆé€‚çš„åºåˆ—åŒ–æ–¹å¼
- [ ] é¿å…åœ¨Sessionä¸­å­˜å‚¨å¤§å¯¹è±¡

**âœ… éƒ¨ç½²é˜¶æ®µ**  
- [ ] é…ç½®RedisæŒä¹…åŒ–
- [ ] è®¾ç½®åˆç†çš„è¿æ¥æ± å‚æ•°
- [ ] é…ç½®ç›‘æ§å’Œå‘Šè­¦
- [ ] å‡†å¤‡æ•…éšœæ¢å¤é¢„æ¡ˆ

**âœ… è¿ç»´é˜¶æ®µ**
- [ ] å®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®
- [ ] ç›‘æ§ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡
- [ ] å®šæœŸå¤‡ä»½é‡è¦æ•°æ®  
- [ ] æŒç»­ä¼˜åŒ–é…ç½®å‚æ•°

**ğŸ§  æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- Sessioné›†ä¸­å­˜ï¼Œå¤šæœåŠ¡å™¨èƒ½å…±äº«
- Redisåšå­˜å‚¨ï¼Œæ€§èƒ½é«˜æ¥æ‰©å±•å¼º  
- Spring Sessionå¥½ï¼Œåˆ‡æ¢å­˜å‚¨ä¸ç”¨æ„
- ç›‘æ§è¦åˆ°ä½ï¼Œé—®é¢˜æ—©å‘ç°æ—©è§£å†³

**ğŸ’¡ å­¦ä¹ å»ºè®®**ï¼š
1. **åŠ¨æ‰‹å®è·µ**ï¼šè‡ªå·±æ­å»ºä¸€ä¸ªRedis + Spring Sessionçš„ç¯å¢ƒ
2. **å‹åŠ›æµ‹è¯•**ï¼šç”¨å·¥å…·æ¨¡æ‹Ÿå¤§é‡ç”¨æˆ·ï¼Œè§‚å¯Ÿç³»ç»Ÿè¡¨ç°
3. **æ•…éšœæ¨¡æ‹Ÿ**ï¼šä¸»åŠ¨åœæ‰Redisï¼Œçœ‹ç³»ç»Ÿå¦‚ä½•å¤„ç†
4. **æºç å­¦ä¹ **ï¼šäº†è§£Spring Sessionçš„å®ç°åŸç†

è¿™æ ·ä½ å°±æŒæ¡äº†åˆ†å¸ƒå¼Sessionç®¡ç†çš„æ ¸å¿ƒæŠ€æœ¯ï¼Œå¯ä»¥åº”å¯¹å¤§éƒ¨åˆ†ä¼ä¸šçº§åº”ç”¨çš„éœ€æ±‚äº†ï¼