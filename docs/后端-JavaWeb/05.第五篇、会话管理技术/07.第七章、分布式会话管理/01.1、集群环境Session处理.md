---
title: 1ã€é›†ç¾¤ç¯å¢ƒSessionå¤„ç†
---
## ğŸ“š ç›®å½•

1. [é›†ç¾¤ç¯å¢ƒSessioné—®é¢˜æ¦‚è¿°](#1-é›†ç¾¤ç¯å¢ƒSessioné—®é¢˜æ¦‚è¿°)
2. [Sessionå¤åˆ¶ç­–ç•¥è¯¦è§£](#2-Sessionå¤åˆ¶ç­–ç•¥è¯¦è§£)
3. [ç²˜æ€§ä¼šè¯é…ç½®å®ç°](#3-ç²˜æ€§ä¼šè¯é…ç½®å®ç°)
4. [è´Ÿè½½å‡è¡¡å¯¹Sessionçš„å½±å“](#4-è´Ÿè½½å‡è¡¡å¯¹Sessionçš„å½±å“)
5. [é›†ç¾¤åŒæ­¥æœºåˆ¶åŸç†](#5-é›†ç¾¤åŒæ­¥æœºåˆ¶åŸç†)
6. [æ€§èƒ½è€ƒè™‘ä¸ä¼˜åŒ–ç­–ç•¥](#6-æ€§èƒ½è€ƒè™‘ä¸ä¼˜åŒ–ç­–ç•¥)
7. [å®æˆ˜è§£å†³æ–¹æ¡ˆ](#7-å®æˆ˜è§£å†³æ–¹æ¡ˆ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ é›†ç¾¤ç¯å¢ƒSessioné—®é¢˜æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯é›†ç¾¤ç¯å¢ƒä¸‹çš„Sessioné—®é¢˜


**ç”Ÿæ´»åŒ–ç†è§£**ï¼š
æƒ³è±¡ä½ å»é“¶è¡ŒåŠä¸šåŠ¡ï¼Œé“¶è¡Œæœ‰å¥½å‡ ä¸ªçª—å£ï¼ˆæœåŠ¡å™¨ï¼‰ï¼Œä½ åœ¨1å·çª—å£åŠäº†ä¸€åŠä¸šåŠ¡ï¼Œä½†ä¸‹æ¬¡æ¥çš„æ—¶å€™è¢«å®‰æ’åˆ°äº†2å·çª—å£ï¼Œå·¥ä½œäººå‘˜å´ä¸çŸ¥é“ä½ ä¹‹å‰åŠäº†ä»€ä¹ˆ - è¿™å°±æ˜¯é›†ç¾¤ç¯å¢ƒä¸‹çš„Sessioné—®é¢˜ï¼

```
ğŸ¢ å•æœºç¯å¢ƒ vs é›†ç¾¤ç¯å¢ƒï¼š

å•æœºç¯å¢ƒï¼ˆä¸€å°æœåŠ¡å™¨ï¼‰ï¼š
ç”¨æˆ· â†’ æœåŠ¡å™¨A â†’ Sessionå­˜å‚¨åœ¨æœåŠ¡å™¨Aå†…å­˜
       âœ… Sessionä¸€ç›´å¯ç”¨

é›†ç¾¤ç¯å¢ƒï¼ˆå¤šå°æœåŠ¡å™¨ï¼‰ï¼š
ç”¨æˆ· â†’ è´Ÿè½½å‡è¡¡å™¨ â†’ æœåŠ¡å™¨Aï¼ˆç¬¬1æ¬¡è®¿é—®ï¼Œåˆ›å»ºSessionï¼‰
ç”¨æˆ· â†’ è´Ÿè½½å‡è¡¡å™¨ â†’ æœåŠ¡å™¨Bï¼ˆç¬¬2æ¬¡è®¿é—®ï¼Œæ‰¾ä¸åˆ°Sessionï¼ï¼‰
                    âŒ Sessionä¸¢å¤±é—®é¢˜
```

### 1.2 Sessionä¸¢å¤±å¸¦æ¥çš„é—®é¢˜


**å®é™…ä¸šåŠ¡å½±å“**ï¼š
- **è´­ç‰©è½¦æ¸…ç©º**ï¼šç”¨æˆ·æ·»åŠ çš„å•†å“çªç„¶æ¶ˆå¤±
- **ç™»å½•çŠ¶æ€ä¸¢å¤±**ï¼šåˆšç™»å½•å°±è¦æ±‚é‡æ–°ç™»å½•
- **è¡¨å•æ•°æ®ä¸¢å¤±**ï¼šå¡«å†™ä¸€åŠçš„è¡¨å•æ•°æ®æ¶ˆå¤±
- **ç”¨æˆ·ä½“éªŒæå·®**ï¼šç½‘ç«™çœ‹èµ·æ¥"æœ‰é—®é¢˜"

```
âŒ é—®é¢˜åœºæ™¯ç¤ºä¾‹ï¼š
1. ç”¨æˆ·åœ¨æ·˜å®ç™»å½• â†’ Sessionå­˜å‚¨åœ¨æœåŠ¡å™¨A
2. ç”¨æˆ·æµè§ˆå•†å“ â†’ è´Ÿè½½å‡è¡¡åˆ†é…åˆ°æœåŠ¡å™¨B
3. æœåŠ¡å™¨Bæ‰¾ä¸åˆ°ç™»å½•Session â†’ æç¤ºç”¨æˆ·é‡æ–°ç™»å½•
4. ç”¨æˆ·å›°æƒ‘ï¼šæˆ‘æ˜æ˜åˆšç™»å½•è¿‡ï¼
```

### 1.3 é›†ç¾¤Sessionç®¡ç†çš„æŒ‘æˆ˜


**æŠ€æœ¯æŒ‘æˆ˜åˆ†æ**ï¼š
```
ğŸ¯ ä¸»è¦æŒ‘æˆ˜ï¼š

æ•°æ®ä¸€è‡´æ€§ï¼š
â€¢ å¤šå°æœåŠ¡å™¨çš„Sessionæ•°æ®å¦‚ä½•ä¿æŒåŒæ­¥ï¼Ÿ
â€¢ æŸå°æœåŠ¡å™¨æ›´æ–°Sessionï¼Œå…¶ä»–æœåŠ¡å™¨å¦‚ä½•çŸ¥é“ï¼Ÿ

æ€§èƒ½å½±å“ï¼š
â€¢ SessionåŒæ­¥ä¼šä¸ä¼šæ‹–æ…¢ç³»ç»Ÿå“åº”ï¼Ÿ
â€¢ å†…å­˜ä½¿ç”¨é‡æ˜¯å¦ä¼šæˆå€å¢é•¿ï¼Ÿ

å¯é æ€§ä¿è¯ï¼š
â€¢ æŸå°æœåŠ¡å™¨å®•æœºï¼ŒSessionæ•°æ®ä¼šä¸¢å¤±å—ï¼Ÿ
â€¢ å¦‚ä½•ä¿è¯7x24å°æ—¶æœåŠ¡ä¸ä¸­æ–­ï¼Ÿ

æ‰©å±•æ€§è€ƒè™‘ï¼š
â€¢ æ–°å¢æœåŠ¡å™¨æ—¶ï¼ŒSessionç®¡ç†å¤æ‚åº¦ä¼šå¢åŠ å—ï¼Ÿ
â€¢ èƒ½å¦æ”¯æŒåŠ¨æ€æ‰©å®¹ç¼©å®¹ï¼Ÿ
```

---

## 2. ğŸ”„ Sessionå¤åˆ¶ç­–ç•¥è¯¦è§£


### 2.1 å…¨å¤åˆ¶ç­–ç•¥ï¼ˆAll-to-Allï¼‰


**å·¥ä½œåŸç†**ï¼š
å°±åƒç¾¤èŠå¤©ï¼Œæ¯ä¸ªäººå‘çš„æ¶ˆæ¯éƒ½ä¼šåŒæ­¥åˆ°ç¾¤é‡Œçš„æ¯ä¸ªäººï¼Œæ‰€ä»¥ä»»ä½•äººéƒ½èƒ½çœ‹åˆ°å®Œæ•´çš„èŠå¤©è®°å½•ã€‚

```
ğŸŒŸ å…¨å¤åˆ¶æœºåˆ¶ï¼š
æœåŠ¡å™¨Aåˆ›å»ºSession â†’ ç«‹å³å¤åˆ¶åˆ°æœåŠ¡å™¨Bã€Cã€D
æœåŠ¡å™¨Bä¿®æ”¹Session â†’ ç«‹å³å¤åˆ¶åˆ°æœåŠ¡å™¨Aã€Cã€D
æœåŠ¡å™¨Cåˆ é™¤Session â†’ ç«‹å³é€šçŸ¥æœåŠ¡å™¨Aã€Bã€D

ä¼˜ç‚¹ï¼š
âœ… æ•°æ®ä¸€è‡´æ€§æœ€å¼º
âœ… ä»»æ„æœåŠ¡å™¨éƒ½æœ‰å®Œæ•´æ•°æ®
âœ… å•ç‚¹æ•…éšœå½±å“æœ€å°

ç¼ºç‚¹ï¼š
âŒ ç½‘ç»œæµé‡å¤§
âŒ å†…å­˜ä½¿ç”¨é‡æˆå€å¢é•¿
âŒ åŒæ­¥å»¶è¿Ÿå½±å“æ€§èƒ½
```

**Tomcaté›†ç¾¤å…¨å¤åˆ¶é…ç½®**ï¼š
```xml
<!-- server.xml é…ç½®ç¤ºä¾‹ -->
<Cluster className="org.apache.catalina.ha.tcp.SimpleTcpCluster">
  <!-- ç»„æ’­é€šä¿¡é…ç½® -->
  <Channel className="org.apache.catalina.tribes.group.GroupChannel">
    <Membership className="org.apache.catalina.tribes.membership.McastService"
                address="228.0.0.4"
                port="45564"
                frequency="500"
                dropTime="3000"/>
  </Channel>
  
  <!-- Sessionå¤åˆ¶é…ç½® -->
  <ClusterListener className="org.apache.catalina.ha.session.ClusterSessionListener"/>
  <Valve className="org.apache.catalina.ha.tcp.ReplicationValve" filter=""/>
  
  <Deployer className="org.apache.catalina.ha.deploy.FarmWarDeployer"
            tempDir="/tmp/war-temp/"
            deployDir="/tmp/war-deploy/"
            watchDir="/tmp/war-listen/"/>
</Cluster>
```

### 2.2 ä¸»å¤‡å¤åˆ¶ç­–ç•¥ï¼ˆPrimary-Backupï¼‰


**æ ¸å¿ƒæ€æƒ³**ï¼š
åƒé‡è¦æ–‡ä»¶åšå¤‡ä»½ä¸€æ ·ï¼Œæ¯ä¸ªSessionæ•°æ®éƒ½æœ‰ä¸€ä¸ª"ä¸»æœ¬"å’Œå‡ ä¸ª"å¤‡ä»½"ï¼Œä¸»æœ¬è´Ÿè´£å¤„ç†è¯·æ±‚ï¼Œå¤‡ä»½ç”¨äºæ•…éšœæ¢å¤ã€‚

```
ğŸ¯ ä¸»å¤‡å¤åˆ¶æµç¨‹ï¼š
1. Sessionåˆ›å»ºåœ¨ä¸»æœåŠ¡å™¨
2. åŒæ—¶åœ¨1-2å°å¤‡ä»½æœåŠ¡å™¨åˆ›å»ºå‰¯æœ¬
3. ç”¨æˆ·è¯·æ±‚ä¼˜å…ˆè·¯ç”±åˆ°ä¸»æœåŠ¡å™¨
4. ä¸»æœåŠ¡å™¨æ•…éšœæ—¶ï¼Œå¤‡ä»½æœåŠ¡å™¨æ¥ç®¡

æ¶æ„ç¤ºæ„ï¼š
æœåŠ¡å™¨Aï¼ˆä¸»ï¼‰â”€â”€ Session-123 â”€â”€â”
                              â”œâ”€â”€ åŒæ­¥
æœåŠ¡å™¨Bï¼ˆå¤‡ï¼‰â”€â”€ Session-123å‰¯æœ¬ â”˜
æœåŠ¡å™¨Cï¼ˆæ™®é€šï¼‰â”€â”€ æ— æ­¤Session
```

### 2.3 æ™ºèƒ½å¤åˆ¶ç­–ç•¥ï¼ˆSelective Replicationï¼‰


**è®¾è®¡ç†å¿µ**ï¼š
ä¸æ˜¯æ‰€æœ‰Sessionéƒ½éœ€è¦å¤åˆ¶ï¼Œæ ¹æ®é‡è¦ç¨‹åº¦å’Œè®¿é—®é¢‘ç‡æ¥å†³å®šå¤åˆ¶ç­–ç•¥ï¼Œå°±åƒVIPå®¢æˆ·äº«å—ç‰¹æ®Šå¾…é‡ã€‚

```
ğŸ“Š å¤åˆ¶ç­–ç•¥åˆ†çº§ï¼š

é«˜ä»·å€¼Sessionï¼ˆç«‹å³å…¨å¤åˆ¶ï¼‰ï¼š
â€¢ å·²ç™»å½•ç”¨æˆ·Session
â€¢ åŒ…å«è´­ç‰©è½¦çš„Session
â€¢ æ­£åœ¨æ”¯ä»˜çš„Session

ä¸­ä»·å€¼Sessionï¼ˆå»¶è¿Ÿå¤åˆ¶ï¼‰ï¼š
â€¢ æµè§ˆè®°å½•Session
â€¢ ä¸´æ—¶æ•°æ®Session

ä½ä»·å€¼Sessionï¼ˆä¸å¤åˆ¶ï¼‰ï¼š
â€¢ åŒ¿åè®¿é—®Session
â€¢ é™æ€èµ„æºè¯·æ±‚Session
```

---

## 3. ğŸ¯ ç²˜æ€§ä¼šè¯é…ç½®å®ç°


### 3.1 ç²˜æ€§ä¼šè¯åŸºæœ¬æ¦‚å¿µ


**é€šä¿—è§£é‡Š**ï¼š
ç²˜æ€§ä¼šè¯å°±åƒä½ æœ‰ä¸ª"ä¸“å±é“¶è¡ŒæŸœå‘˜"ï¼Œæ¯æ¬¡å»é“¶è¡Œéƒ½æ‰¾åŒä¸€ä¸ªäººåŠäº‹ï¼Œè¿™æ ·å¥¹å°±è®°å¾—ä½ çš„æ‰€æœ‰ä¸šåŠ¡æƒ…å†µï¼Œä¸ç”¨æ¯æ¬¡éƒ½é‡æ–°ä»‹ç»ã€‚

```
ğŸ”— ç²˜æ€§ä¼šè¯åŸç†ï¼š
1. ç”¨æˆ·é¦–æ¬¡è®¿é—® â†’ è´Ÿè½½å‡è¡¡å™¨åˆ†é…åˆ°æœåŠ¡å™¨A
2. åœ¨ç”¨æˆ·Cookieä¸­æ ‡è®°"æ¥æºæœåŠ¡å™¨A"
3. åç»­æ‰€æœ‰è¯·æ±‚éƒ½è·¯ç”±åˆ°æœåŠ¡å™¨A
4. ç›´åˆ°Sessionè¿‡æœŸæˆ–æœåŠ¡å™¨æ•…éšœ

å·¥ä½œæµç¨‹ï¼š
ç”¨æˆ·è¯·æ±‚ â†’ è´Ÿè½½å‡è¡¡å™¨æ£€æŸ¥Cookie â†’ å‘ç°æ ‡è®°"ServerA" â†’ è·¯ç”±åˆ°ServerA
```

### 2.2 Nginxç²˜æ€§ä¼šè¯é…ç½®


```nginx
# nginx.conf é…ç½®ç¤ºä¾‹
upstream backend_servers {
    # IPå“ˆå¸Œæ–¹å¼å®ç°ç²˜æ€§ä¼šè¯
    ip_hash;
    
    server 192.168.1.10:8080 weight=3;
    server 192.168.1.11:8080 weight=2;
    server 192.168.1.12:8080 weight=1;
    
    # å¤‡ä»½æœåŠ¡å™¨
    server 192.168.1.13:8080 backup;
}

server {
    listen 80;
    server_name myapp.com;
    
    location / {
        proxy_pass http://backend_servers;
        
        # ä¼ é€’çœŸå®å®¢æˆ·ç«¯IP
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # Sessionç²˜æ€§ç›¸å…³å¤´éƒ¨
        proxy_set_header Host $host;
        proxy_cookie_path / "/; HttpOnly; Secure";
    }
}
```

### 3.3 Apache HTTP Serverç²˜æ€§ä¼šè¯


```apache
# httpd.conf é…ç½®
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_balancer_module modules/mod_proxy_balancer.so
LoadModule proxy_http_module modules/mod_proxy_http.so

# å®šä¹‰åç«¯æœåŠ¡å™¨é›†ç¾¤
ProxyPass /app balancer://mycluster stickysession=JSESSIONID

<Proxy balancer://mycluster>
    BalancerMember http://192.168.1.10:8080 route=server1
    BalancerMember http://192.168.1.11:8080 route=server2
    BalancerMember http://192.168.1.12:8080 route=server3
    
    # å¯ç”¨ç®¡ç†ç•Œé¢
    ProxySet lbmethod=byrequests
</Proxy>

# ç®¡ç†ç•Œé¢ï¼ˆç”Ÿäº§ç¯å¢ƒéœ€è¦æƒé™æ§åˆ¶ï¼‰
<Location "/balancer-manager">
    SetHandler balancer-manager
    Require local
</Location>
```

### 3.4 åº”ç”¨å±‚ç²˜æ€§ä¼šè¯å®ç°


**Javaå®ç°æ€è·¯**ï¼š
```java
// è‡ªå®šä¹‰ç²˜æ€§ä¼šè¯è¿‡æ»¤å™¨
@Component
public class StickySessionFilter implements Filter {
    
    private static final String SERVER_ID_COOKIE = "SERVER_ID";
    private static final String CURRENT_SERVER_ID = "SERVER_001";
    
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, 
                        FilterChain chain) throws IOException, ServletException {
        
        HttpServletRequest httpRequest = (HttpServletRequest) request;
        HttpServletResponse httpResponse = (HttpServletResponse) response;
        
        // æ£€æŸ¥æ˜¯å¦æœ‰æœåŠ¡å™¨æ ‡è¯†Cookie
        String serverIdFromCookie = getCookieValue(httpRequest, SERVER_ID_COOKIE);
        
        if (serverIdFromCookie == null) {
            // é¦–æ¬¡è®¿é—®ï¼Œè®¾ç½®æœåŠ¡å™¨æ ‡è¯†
            Cookie serverCookie = new Cookie(SERVER_ID_COOKIE, CURRENT_SERVER_ID);
            serverCookie.setPath("/");
            serverCookie.setMaxAge(3600); // 1å°æ—¶
            httpResponse.addCookie(serverCookie);
        } else if (!CURRENT_SERVER_ID.equals(serverIdFromCookie)) {
            // è¯·æ±‚è¢«é”™è¯¯è·¯ç”±åˆ°å…¶ä»–æœåŠ¡å™¨
            // å¯ä»¥é€‰æ‹©é‡å®šå‘æˆ–è€…å¤„ç†Sessionè¿ç§»
            handleWrongServerRequest(httpRequest, httpResponse);
            return;
        }
        
        chain.doFilter(request, response);
    }
    
    private String getCookieValue(HttpServletRequest request, String cookieName) {
        Cookie[] cookies = request.getCookies();
        if (cookies != null) {
            for (Cookie cookie : cookies) {
                if (cookieName.equals(cookie.getName())) {
                    return cookie.getValue();
                }
            }
        }
        return null;
    }
}
```

---

## 4. âš–ï¸ è´Ÿè½½å‡è¡¡å¯¹Sessionçš„å½±å“


### 4.1 ä¸åŒè´Ÿè½½å‡è¡¡ç®—æ³•çš„Sessionå½±å“


**ç®—æ³•å¯¹æ¯”åˆ†æ**ï¼š

| è´Ÿè½½å‡è¡¡ç®—æ³• | **Sessionå…¼å®¹æ€§** | **æ€§èƒ½** | **ä½¿ç”¨åœºæ™¯** |
|------------|------------------|----------|-------------|
| **è½®è¯¢ï¼ˆRound Robinï¼‰** | `âŒ ä¸å…¼å®¹` | `â­â­â­â­â­` | `æ— çŠ¶æ€åº”ç”¨` |
| **åŠ æƒè½®è¯¢** | `âŒ ä¸å…¼å®¹` | `â­â­â­â­â­` | `æ— çŠ¶æ€åº”ç”¨` |
| **IPå“ˆå¸Œ** | `âœ… å¤©ç„¶ç²˜æ€§` | `â­â­â­â­â˜†` | `æœ‰çŠ¶æ€åº”ç”¨` |
| **æœ€å°‘è¿æ¥** | `âŒ ä¸å…¼å®¹` | `â­â­â­â­â˜†` | `é•¿è¿æ¥åº”ç”¨` |
| **ä¸€è‡´æ€§å“ˆå¸Œ** | `âœ… éƒ¨åˆ†ç²˜æ€§` | `â­â­â­â˜†â˜†` | `åˆ†å¸ƒå¼ç³»ç»Ÿ` |

### 4.2 è´Ÿè½½å‡è¡¡å™¨Sessionå¤„ç†æ–¹æ¡ˆ


**ğŸ”§ æ–¹æ¡ˆä¸€ï¼šIPå“ˆå¸Œç²˜æ€§**
```
åŸç†ï¼šæ ¹æ®å®¢æˆ·ç«¯IPè®¡ç®—å“ˆå¸Œå€¼ï¼Œç¡®ä¿åŒä¸€IPæ€»æ˜¯è®¿é—®åŒä¸€æœåŠ¡å™¨

ä¼˜ç‚¹ï¼š
âœ… å®ç°ç®€å•ï¼Œé…ç½®æ–¹ä¾¿
âœ… å¤©ç„¶ä¿è¯Sessionç²˜æ€§
âœ… æ— éœ€ä¿®æ”¹åº”ç”¨ä»£ç 

ç¼ºç‚¹ï¼š
âŒ NATç½‘ç»œç¯å¢ƒä¸‹å¤šç”¨æˆ·å†²çª
âŒ æœåŠ¡å™¨æ•…éšœæ—¶Sessionä¸¢å¤±
âŒ è´Ÿè½½åˆ†å¸ƒå¯èƒ½ä¸å‡åŒ€

å®é™…åœºæ™¯ï¼š
é€‚åˆä¼ä¸šå†…ç½‘ã€ç”¨æˆ·IPç›¸å¯¹å›ºå®šçš„åœºæ™¯
```

**ğŸ”§ æ–¹æ¡ˆäºŒï¼šCookieè·¯ç”±**
```
åŸç†ï¼šåœ¨Cookieä¸­è®°å½•ç”¨æˆ·åº”è¯¥è®¿é—®å“ªå°æœåŠ¡å™¨

å®ç°æµç¨‹ï¼š
1. ç”¨æˆ·é¦–æ¬¡è®¿é—® â†’ è´Ÿè½½å‡è¡¡å™¨éšæœºåˆ†é…æœåŠ¡å™¨A
2. åœ¨å“åº”ä¸­è®¾ç½®Cookieï¼š"server=A"
3. åç»­è¯·æ±‚æºå¸¦Cookie â†’ è·¯ç”±åˆ°æœåŠ¡å™¨A

ä¼˜åŠ¿ï¼š
âœ… ä¸å—IPé™åˆ¶
âœ… å¯ä»¥å®ç°è´Ÿè½½å‡è¡¡
âœ… æ•…éšœè½¬ç§»ç›¸å¯¹å®¹æ˜“
```

### 4.3 Sessioné›†ç¾¤ä¸è´Ÿè½½å‡è¡¡çš„é…åˆ


**ğŸ¯ æœ€ä½³å®è·µæ¶æ„**ï¼š
```
å®Œæ•´è§£å†³æ–¹æ¡ˆï¼š
           â”Œâ”€â”€â”€ æœåŠ¡å™¨Aï¼ˆTomcat + Sessionå¤åˆ¶ï¼‰
ç”¨æˆ· â†’ è´Ÿè½½å‡è¡¡å™¨ â”œâ”€â”€â”€ æœåŠ¡å™¨Bï¼ˆTomcat + Sessionå¤åˆ¶ï¼‰
           â””â”€â”€â”€ æœåŠ¡å™¨Cï¼ˆTomcat + Sessionå¤åˆ¶ï¼‰
                    â†“
            å…±äº«Sessionå­˜å‚¨ï¼ˆRedis/DBï¼‰

å¤šå±‚ä¿éšœï¼š
1. ç²˜æ€§ä¼šè¯ç¡®ä¿æ­£å¸¸æƒ…å†µä¸‹è®¿é—®å›ºå®šæœåŠ¡å™¨
2. Sessionå¤åˆ¶ç¡®ä¿æœåŠ¡å™¨é—´æ•°æ®åŒæ­¥
3. å¤–éƒ¨å­˜å‚¨ç¡®ä¿æ•°æ®æŒä¹…åŒ–å’Œé«˜å¯ç”¨
```

---

## 5. ğŸ”„ é›†ç¾¤åŒæ­¥æœºåˆ¶åŸç†


### 5.1 é›†ç¾¤é€šä¿¡åè®®


**ç»„æ’­é€šä¿¡ï¼ˆMulticastï¼‰**ï¼š
å°±åƒåœ¨å¤§ä¼šè®®å®¤é‡Œè®²è¯ï¼Œä¸€ä¸ªäººè¯´è¯ï¼Œæ‰€æœ‰äººéƒ½èƒ½å¬åˆ°ï¼Œè¿™å°±æ˜¯ç»„æ’­é€šä¿¡çš„åŸç†ã€‚

```
ğŸŒ ç»„æ’­é€šä¿¡ç‰¹ç‚¹ï¼š
ç½‘ç»œå±‚é¢ï¼š
â€¢ ä¸€ä¸ªæ•°æ®åŒ…å‘é€ç»™å¤šä¸ªæ¥æ”¶è€…
â€¢ å‡å°‘ç½‘ç»œå¸¦å®½ä½¿ç”¨
â€¢ é€‚åˆå±€åŸŸç½‘ç¯å¢ƒ

åº”ç”¨åœºæ™¯ï¼š
â€¢ Tomcaté›†ç¾¤SessionåŒæ­¥
â€¢ é›†ç¾¤æˆå‘˜å‘ç°
â€¢ çŠ¶æ€å˜åŒ–é€šçŸ¥

é…ç½®ç¤ºä¾‹ï¼š
ç»„æ’­åœ°å€ï¼š224.0.0.1-239.255.255.255
ç«¯å£ï¼š45564ï¼ˆTomcaté»˜è®¤ï¼‰
```

**ç‚¹å¯¹ç‚¹é€šä¿¡ï¼ˆPoint-to-Pointï¼‰**ï¼š
```
ğŸ¯ TCPç›´è¿æ–¹å¼ï¼š
ç‰¹ç‚¹ï¼š
â€¢ æ¯ä¸¤å°æœåŠ¡å™¨å»ºç«‹ä¸“ç”¨è¿æ¥
â€¢ æ•°æ®ä¼ è¾“æ›´å¯é 
â€¢ é€‚åˆå¹¿åŸŸç½‘ç¯å¢ƒ

ç¼ºç‚¹ï¼š
â€¢ è¿æ¥æ•°é‡éšæœåŠ¡å™¨æ•°é‡æŒ‡æ•°å¢é•¿
â€¢ nå°æœåŠ¡å™¨éœ€è¦n*(n-1)/2ä¸ªè¿æ¥
â€¢ é…ç½®å’Œç»´æŠ¤å¤æ‚
```

### 5.2 åŒæ­¥æ—¶æœºä¸ç­–ç•¥


**ğŸ”„ åŒæ­¥æ—¶æœºé€‰æ‹©**ï¼š

```
å®æ—¶åŒæ­¥ï¼š
è§¦å‘æ—¶æœºï¼šSessionåˆ›å»º/ä¿®æ”¹/åˆ é™¤æ—¶ç«‹å³åŒæ­¥
é€‚ç”¨åœºæ™¯ï¼šå¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚æé«˜çš„åœºæ™¯
æ€§èƒ½å½±å“ï¼šæ¯æ¬¡æ“ä½œéƒ½æœ‰ç½‘ç»œå¼€é”€

å®šæ—¶åŒæ­¥ï¼š
è§¦å‘æ—¶æœºï¼šæ¯éš”å›ºå®šæ—¶é—´é—´éš”åŒæ­¥ä¸€æ¬¡
é€‚ç”¨åœºæ™¯ï¼šå¯¹å®æ—¶æ€§è¦æ±‚ä¸é«˜çš„åœºæ™¯
æ€§èƒ½å½±å“ï¼šæ‰¹é‡åŒæ­¥ï¼Œç½‘ç»œæ•ˆç‡æ›´é«˜

è¯·æ±‚ç»“æŸåŒæ­¥ï¼š
è§¦å‘æ—¶æœºï¼šHTTPè¯·æ±‚å¤„ç†å®ŒæˆååŒæ­¥
é€‚ç”¨åœºæ™¯ï¼šå¤§å¤šæ•°Webåº”ç”¨
æ€§èƒ½å½±å“ï¼šç”¨æˆ·æ„Ÿå—ä¸åˆ°åŒæ­¥å»¶è¿Ÿ
```

### 5.3 å†²çªæ£€æµ‹ä¸è§£å†³


**æ•°æ®å†²çªåœºæ™¯**ï¼š
```
ğŸ’¥ å…¸å‹å†²çªæƒ…å†µï¼š
1. ç”¨æˆ·åœ¨æœåŠ¡å™¨Aä¿®æ”¹è´­ç‰©è½¦
2. åŒæ—¶åœ¨æœåŠ¡å™¨Bä¹Ÿä¿®æ”¹è´­ç‰©è½¦
3. ä¸¤ä¸ªä¿®æ”¹åŒæ—¶åŒæ­¥åˆ°å…¶ä»–æœåŠ¡å™¨
4. äº§ç”Ÿæ•°æ®å†²çª

è§£å†³ç­–ç•¥ï¼š
æ—¶é—´æˆ³ä¼˜å…ˆï¼šæœ€åä¿®æ”¹æ—¶é—´æˆ³è¾ƒå¤§çš„æ•°æ®è·èƒœ
ç‰ˆæœ¬å·æœºåˆ¶ï¼šç»´æŠ¤æ•°æ®ç‰ˆæœ¬å·ï¼Œç‰ˆæœ¬é«˜çš„è·èƒœ
ä¸šåŠ¡è§„åˆ™ï¼šæ ¹æ®å…·ä½“ä¸šåŠ¡é€»è¾‘å†³å®š
```

**å†²çªè§£å†³å®ç°**ï¼š
```java
// Sessionæ•°æ®åŒ…è£…ç±»
public class ClusterSession {
    private String sessionId;
    private Map<String, Object> attributes;
    private long lastModified;    // æœ€åä¿®æ”¹æ—¶é—´
    private int version;          // ç‰ˆæœ¬å·
    
    // å†²çªè§£å†³æ–¹æ³•
    public ClusterSession resolveConflict(ClusterSession other) {
        // åŸºäºæ—¶é—´æˆ³çš„å†²çªè§£å†³
        if (this.lastModified > other.lastModified) {
            return this;
        } else if (this.lastModified < other.lastModified) {
            return other;
        } else {
            // æ—¶é—´æˆ³ç›¸åŒï¼Œæ¯”è¾ƒç‰ˆæœ¬å·
            return this.version >= other.version ? this : other;
        }
    }
}
```

---

## 6. âš¡ æ€§èƒ½è€ƒè™‘ä¸ä¼˜åŒ–ç­–ç•¥


### 6.1 æ€§èƒ½ç“¶é¢ˆåˆ†æ


**ğŸ¯ ä¸»è¦æ€§èƒ½é—®é¢˜**ï¼š

```
ç½‘ç»œå¸¦å®½æ¶ˆè€—ï¼š
é—®é¢˜ï¼šSessionæ•°æ®åœ¨å¤šå°æœåŠ¡å™¨é—´ä¼ è¾“
å½±å“ï¼šå¸¦å®½ä¸è¶³æ—¶å½±å“ä¸šåŠ¡å“åº”
ä¼°ç®—ï¼š100å°æœåŠ¡å™¨ï¼Œæ¯ä¸ªSession 10KBï¼Œå…¨å¤åˆ¶éœ€è¦çº¦100MB/æ¬¡

å†…å­˜ä½¿ç”¨ç¿»å€ï¼š
é—®é¢˜ï¼šæ¯å°æœåŠ¡å™¨å­˜å‚¨æ‰€æœ‰Sessionå‰¯æœ¬
å½±å“ï¼šå†…å­˜ä¸è¶³å¯¼è‡´ç³»ç»Ÿä¸ç¨³å®š
è®¡ç®—ï¼šåŸæ¥éœ€è¦8GBå†…å­˜ï¼Œé›†ç¾¤ç¯å¢ƒå¯èƒ½éœ€è¦16-32GB

CPUå¼€é”€å¢åŠ ï¼š
é—®é¢˜ï¼šåºåˆ—åŒ–/ååºåˆ—åŒ–Sessionæ•°æ®
å½±å“ï¼šå“åº”æ—¶é—´å»¶é•¿
è¡¨ç°ï¼šåŸæœ¬50mså“åº”å˜ä¸º80-100ms
```

### 6.2 ä¼˜åŒ–ç­–ç•¥è¯¦è§£


**ğŸš€ æ•°æ®å‹ç¼©ä¼˜åŒ–**ï¼š
```java
// Sessionæ•°æ®å‹ç¼©å·¥å…·
public class SessionCompressor {
    
    public static byte[] compressSession(HttpSession session) {
        try {
            // åºåˆ—åŒ–Session
            ByteArrayOutputStream baos = new ByteArrayOutputStream();
            ObjectOutputStream oos = new ObjectOutputStream(baos);
            
            // åªåºåˆ—åŒ–å¿…è¦çš„å±æ€§
            Map<String, Object> essentialData = extractEssentialData(session);
            oos.writeObject(essentialData);
            oos.close();
            
            // GZIPå‹ç¼©
            ByteArrayOutputStream compressedStream = new ByteArrayOutputStream();
            GZIPOutputStream gzipStream = new GZIPOutputStream(compressedStream);
            gzipStream.write(baos.toByteArray());
            gzipStream.close();
            
            return compressedStream.toByteArray();
        } catch (IOException e) {
            throw new RuntimeException("Sessionå‹ç¼©å¤±è´¥", e);
        }
    }
    
    // æå–å…³é”®æ•°æ®ï¼Œè¿‡æ»¤ä¸å¿…è¦çš„å¯¹è±¡
    private static Map<String, Object> extractEssentialData(HttpSession session) {
        Map<String, Object> essential = new HashMap<>();
        Enumeration<String> names = session.getAttributeNames();
        
        while (names.hasMoreElements()) {
            String name = names.nextElement();
            Object value = session.getAttribute(name);
            
            // åªåŒæ­¥å¯åºåˆ—åŒ–çš„é‡è¦æ•°æ®
            if (isSerializable(value) && isEssential(name)) {
                essential.put(name, value);
            }
        }
        return essential;
    }
}
```

**âš¡ å¼‚æ­¥åŒæ­¥æœºåˆ¶**ï¼š
```java
// å¼‚æ­¥SessionåŒæ­¥å™¨
@Component
public class AsyncSessionSynchronizer {
    
    private final ExecutorService syncExecutor = 
        Executors.newFixedThreadPool(3);
    private final BlockingQueue<SessionChangeEvent> syncQueue = 
        new LinkedBlockingQueue<>(1000);
    
    @PostConstruct
    public void startSyncWorkers() {
        // å¯åŠ¨3ä¸ªåŒæ­¥å·¥ä½œçº¿ç¨‹
        for (int i = 0; i < 3; i++) {
            syncExecutor.submit(this::syncWorker);
        }
    }
    
    // å¼‚æ­¥æäº¤Sessionå˜æ›´
    public void submitSessionChange(String sessionId, Object sessionData) {
        SessionChangeEvent event = new SessionChangeEvent(sessionId, sessionData);
        
        // éé˜»å¡æäº¤ï¼Œå¦‚æœé˜Ÿåˆ—æ»¡äº†å°±ä¸¢å¼ƒæ—§æ•°æ®
        if (!syncQueue.offer(event)) {
            SessionChangeEvent oldEvent = syncQueue.poll();
            syncQueue.offer(event);
            logger.warn("åŒæ­¥é˜Ÿåˆ—å·²æ»¡ï¼Œä¸¢å¼ƒæ—§çš„Sessionå˜æ›´ï¼š{}", oldEvent.getSessionId());
        }
    }
    
    // åŒæ­¥å·¥ä½œçº¿ç¨‹
    private void syncWorker() {
        while (!Thread.currentThread().isInterrupted()) {
            try {
                SessionChangeEvent event = syncQueue.take();
                doSync(event);
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
                break;
            } catch (Exception e) {
                logger.error("SessionåŒæ­¥å¼‚å¸¸", e);
            }
        }
    }
}
```

### 6.3 ç›‘æ§ä¸è°ƒä¼˜


**ğŸ“Š å…³é”®ç›‘æ§æŒ‡æ ‡**ï¼š

```
æ€§èƒ½ç›‘æ§æŒ‡æ ‡ï¼š
â€¢ SessionåŒæ­¥å»¶è¿Ÿï¼šå¹³å‡ã€P95ã€P99
â€¢ ç½‘ç»œå¸¦å®½ä½¿ç”¨ï¼šå…¥å¸¦å®½ã€å‡ºå¸¦å®½
â€¢ å†…å­˜ä½¿ç”¨ç‡ï¼šå †å†…å­˜ã€éå †å†…å­˜
â€¢ åŒæ­¥æˆåŠŸç‡ï¼šæˆåŠŸæ¬¡æ•°/æ€»æ¬¡æ•°

ä¸šåŠ¡ç›‘æ§æŒ‡æ ‡ï¼š
â€¢ Sessionä¸¢å¤±ç‡ï¼šä¸¢å¤±æ¬¡æ•°/æ€»Sessionæ•°
â€¢ ç”¨æˆ·ç™»å½•çŠ¶æ€ä¿æŒç‡
â€¢ è´­ç‰©è½¦æ•°æ®ä¸€è‡´æ€§
â€¢ ç”¨æˆ·æŠ•è¯‰ç›¸å…³é—®é¢˜æ•°é‡
```

**ğŸ”§ è°ƒä¼˜å‚æ•°é…ç½®**ï¼š
```properties
# Tomcaté›†ç¾¤è°ƒä¼˜å‚æ•°
# server.xml
<Cluster className="org.apache.catalina.ha.tcp.SimpleTcpCluster">
  <!-- åŒæ­¥é¢‘ç‡æ§åˆ¶ -->
  <Channel className="org.apache.catalina.tribes.group.GroupChannel">
    <Membership frequency="500"        <!-- å¿ƒè·³é¢‘ç‡ï¼š500ms -->
                dropTime="3000"       <!-- èŠ‚ç‚¹è¶…æ—¶ï¼š3ç§’ -->
                />
    <Sender className="org.apache.catalina.tribes.transport.ReplicationTransmitter">
      <Transport poolSize="2"          <!-- å‘é€çº¿ç¨‹æ± å¤§å° -->
                 rxBufSize="65536"     <!-- æ¥æ”¶ç¼“å†²åŒº -->
                 txBufSize="65536"     <!-- å‘é€ç¼“å†²åŒº -->
                 />
    </Sender>
  </Channel>
  
  <!-- Sessionå¤åˆ¶è®¾ç½® -->
  <Deployer waitForAck="true"          <!-- ç­‰å¾…ç¡®è®¤ -->
            sendClusterDomainOnly="false"/>
</Cluster>
```

---

## 7. ğŸ› ï¸ å®æˆ˜è§£å†³æ–¹æ¡ˆ


### 7.1 Spring Session + Redisæ–¹æ¡ˆ


**æ¶æ„è®¾è®¡æ€è·¯**ï¼š
å¤–éƒ¨å­˜å‚¨æ–¹æ¡ˆæ˜¯ç›®å‰æœ€ä¸»æµçš„è§£å†³æ–¹æ¡ˆï¼Œå°±åƒæŠŠæ‰€æœ‰çš„"æ¡£æ¡ˆ"éƒ½å­˜åœ¨ä¸€ä¸ªä¸­å¤®æ¡£æ¡ˆé¦†ï¼Œä»»ä½•æœåŠ¡çª—å£éƒ½å¯ä»¥æŸ¥é˜…ã€‚

```java
// Spring Booté…ç½®
@Configuration
@EnableRedisHttpSession(maxInactiveIntervalInSeconds = 1800)
public class SessionConfig {
    
    @Bean
    public LettuceConnectionFactory redisConnectionFactory() {
        // Redisé›†ç¾¤é…ç½®
        RedisClusterConfiguration clusterConfig = 
            new RedisClusterConfiguration();
        clusterConfig.clusterNode("redis-node1", 6379);
        clusterConfig.clusterNode("redis-node2", 6379);
        clusterConfig.clusterNode("redis-node3", 6379);
        
        LettuceConnectionFactory factory = 
            new LettuceConnectionFactory(clusterConfig);
        
        // è¿æ¥æ± é…ç½®
        LettucePoolingClientConfiguration clientConfig = 
            LettucePoolingClientConfiguration.builder()
                .poolConfig(buildPoolConfig())
                .build();
                
        factory.setClientConfiguration(clientConfig);
        return factory;
    }
    
    private GenericObjectPoolConfig buildPoolConfig() {
        GenericObjectPoolConfig poolConfig = new GenericObjectPoolConfig();
        poolConfig.setMaxTotal(100);        // æœ€å¤§è¿æ¥æ•°
        poolConfig.setMaxIdle(20);          // æœ€å¤§ç©ºé—²è¿æ¥
        poolConfig.setMinIdle(5);           // æœ€å°ç©ºé—²è¿æ¥
        poolConfig.setMaxWaitMillis(3000);  // æœ€å¤§ç­‰å¾…æ—¶é—´
        return poolConfig;
    }
}
```

**Sessionæ“ä½œç¤ºä¾‹**ï¼š
```java
@RestController
public class UserController {
    
    // Spring Sessionä¼šè‡ªåŠ¨å¤„ç†Sessionå­˜å‚¨åˆ°Redis
    @PostMapping("/login")
    public ResponseEntity<?> login(@RequestBody LoginRequest request, 
                                  HttpServletRequest httpRequest) {
        
        // éªŒè¯ç”¨æˆ·ç™»å½•
        User user = userService.authenticate(request.getUsername(), 
                                           request.getPassword());
        if (user == null) {
            return ResponseEntity.badRequest()
                .body(new ApiResponse(false, "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"));
        }
        
        // å­˜å‚¨ç”¨æˆ·ä¿¡æ¯åˆ°Sessionï¼ˆè‡ªåŠ¨å­˜å‚¨åˆ°Redisï¼‰
        HttpSession session = httpRequest.getSession();
        session.setAttribute("user", user);
        session.setAttribute("loginTime", System.currentTimeMillis());
        
        return ResponseEntity.ok(new ApiResponse(true, "ç™»å½•æˆåŠŸ"));
    }
    
    @GetMapping("/profile")
    public ResponseEntity<?> getProfile(HttpServletRequest request) {
        HttpSession session = request.getSession(false);
        if (session == null) {
            return ResponseEntity.status(401)
                .body(new ApiResponse(false, "æœªç™»å½•"));
        }
        
        User user = (User) session.getAttribute("user");
        return ResponseEntity.ok(user);
    }
}
```

### 7.2 è‡ªå®šä¹‰Sessionç®¡ç†å™¨


**é€‚ç”¨åœºæ™¯**ï¼šå¯¹Sessionå­˜å‚¨æœ‰ç‰¹æ®Šè¦æ±‚ï¼Œæˆ–éœ€è¦é›†æˆç°æœ‰ç³»ç»Ÿæ—¶ã€‚

```java
// è‡ªå®šä¹‰Sessionç®¡ç†å™¨
@Component
public class CustomSessionManager implements HttpSessionListener {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    private static final String SESSION_PREFIX = "session:";
    private static final int SESSION_TIMEOUT = 1800; // 30åˆ†é’Ÿ
    
    // Sessionåˆ›å»ºæ—¶çš„å¤„ç†
    @Override
    public void sessionCreated(HttpSessionEvent event) {
        HttpSession session = event.getSession();
        String sessionId = session.getId();
        
        // åœ¨Redisä¸­åˆ›å»ºSessionè®°å½•
        String redisKey = SESSION_PREFIX + sessionId;
        Map<String, Object> sessionData = new HashMap<>();
        sessionData.put("creationTime", session.getCreationTime());
        sessionData.put("lastAccessedTime", session.getLastAccessedTime());
        
        redisTemplate.opsForHash().putAll(redisKey, sessionData);
        redisTemplate.expire(redisKey, SESSION_TIMEOUT, TimeUnit.SECONDS);
        
        logger.info("Sessionåˆ›å»ºï¼š{}", sessionId);
    }
    
    // Sessioné”€æ¯æ—¶çš„å¤„ç†
    @Override
    public void sessionDestroyed(HttpSessionEvent event) {
        String sessionId = event.getSession().getId();
        String redisKey = SESSION_PREFIX + sessionId;
        
        redisTemplate.delete(redisKey);
        logger.info("Sessioné”€æ¯ï¼š{}", sessionId);
    }
    
    // è‡ªå®šä¹‰Sessionæ“ä½œæ–¹æ³•
    public void setAttribute(String sessionId, String name, Object value) {
        String redisKey = SESSION_PREFIX + sessionId;
        redisTemplate.opsForHash().put(redisKey, name, value);
        // é‡ç½®è¿‡æœŸæ—¶é—´
        redisTemplate.expire(redisKey, SESSION_TIMEOUT, TimeUnit.SECONDS);
    }
    
    public Object getAttribute(String sessionId, String name) {
        String redisKey = SESSION_PREFIX + sessionId;
        return redisTemplate.opsForHash().get(redisKey, name);
    }
}
```

### 7.3 æ··åˆæ–¹æ¡ˆï¼šæœ¬åœ°ç¼“å­˜ + é›†ä¸­å­˜å‚¨


**è®¾è®¡æ€è·¯**ï¼š
ç»“åˆæœ¬åœ°ç¼“å­˜çš„é«˜æ€§èƒ½å’Œé›†ä¸­å­˜å‚¨çš„å¯é æ€§ï¼Œå°±åƒé“¶è¡Œæ—¢æœ‰ç°é‡‘æŸœå°ï¼ˆå¿«é€Ÿï¼‰åˆæœ‰é‡‘åº“ï¼ˆå®‰å…¨ï¼‰ã€‚

```java
@Component
public class HybridSessionManager {
    
    // æœ¬åœ°ç¼“å­˜ï¼ˆL1ç¼“å­˜ï¼‰
    private final Cache<String, SessionData> localCache = 
        Caffeine.newBuilder()
            .maximumSize(1000)
            .expireAfterWrite(5, TimeUnit.MINUTES)
            .build();
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate; // L2ç¼“å­˜
    
    public SessionData getSession(String sessionId) {
        // 1. å…ˆæŸ¥æœ¬åœ°ç¼“å­˜
        SessionData session = localCache.getIfPresent(sessionId);
        if (session != null) {
            return session;
        }
        
        // 2. æœ¬åœ°ç¼“å­˜æ²¡æœ‰ï¼ŒæŸ¥Redis
        String redisKey = "session:" + sessionId;
        session = (SessionData) redisTemplate.opsForValue().get(redisKey);
        
        if (session != null) {
            // 3. æ”¾å…¥æœ¬åœ°ç¼“å­˜
            localCache.put(sessionId, session);
            return session;
        }
        
        return null; // Sessionä¸å­˜åœ¨
    }
    
    public void saveSession(String sessionId, SessionData session) {
        // 1. ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜
        localCache.put(sessionId, session);
        
        // 2. å¼‚æ­¥ä¿å­˜åˆ°Redis
        CompletableFuture.runAsync(() -> {
            String redisKey = "session:" + sessionId;
            redisTemplate.opsForValue().set(redisKey, session, 
                                          30, TimeUnit.MINUTES);
        });
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ é›†ç¾¤Sessioné—®é¢˜ï¼šå¤šæœåŠ¡å™¨ç¯å¢ƒä¸‹Sessionæ•°æ®ä¸å…±äº«
ğŸ”¸ è§£å†³æ–¹æ¡ˆåˆ†ç±»ï¼šSessionå¤åˆ¶ã€ç²˜æ€§ä¼šè¯ã€å¤–éƒ¨å­˜å‚¨
ğŸ”¸ Sessionå¤åˆ¶ï¼šæ•°æ®åœ¨æœåŠ¡å™¨é—´åŒæ­¥ï¼Œä¿è¯ä¸€è‡´æ€§
ğŸ”¸ ç²˜æ€§ä¼šè¯ï¼šç”¨æˆ·è¯·æ±‚å›ºå®šè·¯ç”±åˆ°åŒä¸€æœåŠ¡å™¨
ğŸ”¸ å¤–éƒ¨å­˜å‚¨ï¼šSessionå­˜å‚¨åœ¨Redis/æ•°æ®åº“ç­‰å¤–éƒ¨ç³»ç»Ÿ
ğŸ”¸ æ€§èƒ½è€ƒè™‘ï¼šç½‘ç»œã€å†…å­˜ã€CPUå¼€é”€çš„æƒè¡¡
ğŸ”¸ ç›‘æ§è¿ç»´ï¼šå…³é”®æŒ‡æ ‡ç›‘æ§å’Œæ•…éšœå¤„ç†
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆä¼šæœ‰Sessioné›†ç¾¤é—®é¢˜**ï¼š
```
æ ¹æœ¬åŸå› ï¼š
â€¢ HTTPåè®®æ— çŠ¶æ€ç‰¹æ€§
â€¢ è´Ÿè½½å‡è¡¡åˆ†æ•£è¯·æ±‚åˆ°ä¸åŒæœåŠ¡å™¨
â€¢ æ¯å°æœåŠ¡å™¨ç»´æŠ¤ç‹¬ç«‹çš„Sessionå­˜å‚¨

ä¸šåŠ¡å½±å“ï¼š
â€¢ ç”¨æˆ·ä½“éªŒå·®ï¼šé¢‘ç¹è¦æ±‚é‡æ–°ç™»å½•
â€¢ æ•°æ®ä¸¢å¤±ï¼šè´­ç‰©è½¦ã€è¡¨å•æ•°æ®æ¶ˆå¤±
â€¢ åŠŸèƒ½å¼‚å¸¸ï¼šä¾èµ–Sessionçš„åŠŸèƒ½ä¸å¯ç”¨
```

**ğŸ”¹ å„ç§è§£å†³æ–¹æ¡ˆçš„é€‚ç”¨åœºæ™¯**ï¼š
```
Sessionå¤åˆ¶ â†’ é€‚åˆä¸­å°è§„æ¨¡é›†ç¾¤ï¼ˆ<10å°æœåŠ¡å™¨ï¼‰
ç²˜æ€§ä¼šè¯ â†’ é€‚åˆå¯¹ä¸€è‡´æ€§è¦æ±‚ä¸é«˜çš„åœºæ™¯
å¤–éƒ¨å­˜å‚¨ â†’ é€‚åˆå¤§è§„æ¨¡é›†ç¾¤å’Œé«˜å¯ç”¨è¦æ±‚
æ··åˆæ–¹æ¡ˆ â†’ é€‚åˆå¯¹æ€§èƒ½å’Œå¯é æ€§éƒ½æœ‰è¦æ±‚çš„åœºæ™¯
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–çš„å…³é”®è¦ç´ **ï¼š
```
æ•°æ®é‡æ§åˆ¶ï¼šåªå­˜å‚¨å¿…è¦çš„Sessionæ•°æ®
ä¼ è¾“ä¼˜åŒ–ï¼šå‹ç¼©ã€å¼‚æ­¥ã€æ‰¹é‡å¤„ç†
ç¼“å­˜ç­–ç•¥ï¼šå¤šçº§ç¼“å­˜å‡å°‘è¿œç¨‹è°ƒç”¨
ç›‘æ§è°ƒä¼˜ï¼šåŸºäºå®é™…æŒ‡æ ‡è°ƒæ•´å‚æ•°
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ’¼ æŠ€æœ¯é€‰å‹å»ºè®®**ï¼š
```
å°å‹åº”ç”¨ï¼ˆ<5å°æœåŠ¡å™¨ï¼‰ï¼š
æ¨èï¼šTomcat Sessionå¤åˆ¶ + ç²˜æ€§ä¼šè¯
ç†ç”±ï¼šé…ç½®ç®€å•ï¼Œç»´æŠ¤æˆæœ¬ä½

ä¸­å‹åº”ç”¨ï¼ˆ5-20å°æœåŠ¡å™¨ï¼‰ï¼š
æ¨èï¼šSpring Session + Redis
ç†ç”±ï¼šå¯é æ€§å¥½ï¼Œæ‰©å±•æ€§å¼º

å¤§å‹åº”ç”¨ï¼ˆ>20å°æœåŠ¡å™¨ï¼‰ï¼š
æ¨èï¼šRedisé›†ç¾¤ + æœ¬åœ°ç¼“å­˜
ç†ç”±ï¼šé«˜æ€§èƒ½ï¼Œé«˜å¯ç”¨

å¾®æœåŠ¡æ¶æ„ï¼š
æ¨èï¼šJWT Token + æ— çŠ¶æ€è®¾è®¡
ç†ç”±ï¼šå¤©ç„¶æ”¯æŒåˆ†å¸ƒå¼ï¼Œæ— Sessioné—®é¢˜
```

**ğŸ› ï¸ å®æ–½æœ€ä½³å®è·µ**ï¼š
```
å¼€å‘é˜¶æ®µï¼š
â€¢ è®¾è®¡æ—¶è€ƒè™‘Sessionæœ€å°åŒ–å­˜å‚¨
â€¢ é¿å…åœ¨Sessionä¸­å­˜å‚¨å¤§å¯¹è±¡
â€¢ å®ç°Sessionæ•°æ®çš„åºåˆ—åŒ–æ¥å£

æµ‹è¯•é˜¶æ®µï¼š
â€¢ æ¨¡æ‹Ÿé›†ç¾¤ç¯å¢ƒæµ‹è¯•Sessionä¸€è‡´æ€§
â€¢ å‹åŠ›æµ‹è¯•éªŒè¯æ€§èƒ½è¡¨ç°
â€¢ æ•…éšœæµ‹è¯•éªŒè¯é«˜å¯ç”¨æ€§

è¿ç»´é˜¶æ®µï¼š
â€¢ ç›‘æ§Sessionç›¸å…³çš„å…³é”®æŒ‡æ ‡
â€¢ å»ºç«‹Sessioné—®é¢˜çš„æ’æŸ¥æµç¨‹
â€¢ å®šæœŸè¯„ä¼°å’Œä¼˜åŒ–Sessionæ–¹æ¡ˆ
```

### 8.4 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ


**â“ SessionåŒæ­¥å»¶è¿Ÿå¯¼è‡´æ•°æ®ä¸ä¸€è‡´æ€ä¹ˆåŠï¼Ÿ**
```
è§£å†³ç­–ç•¥ï¼š
1. ç¼©çŸ­åŒæ­¥é—´éš”ï¼ˆå½±å“æ€§èƒ½ï¼‰
2. ä½¿ç”¨å¤–éƒ¨å­˜å‚¨æ–¹æ¡ˆï¼ˆæ¨èï¼‰
3. ä¸šåŠ¡å±‚é¢åšå¹‚ç­‰å¤„ç†
4. å…³é”®æ“ä½œä½¿ç”¨æ•°æ®åº“äº‹åŠ¡
```

**â“ Rediså®•æœºå¯¼è‡´æ‰€æœ‰Sessionä¸¢å¤±æ€ä¹ˆåŠï¼Ÿ**
```
é«˜å¯ç”¨æ–¹æ¡ˆï¼š
1. Redisä¸»ä»å¤åˆ¶ + å“¨å…µæ¨¡å¼
2. Redisé›†ç¾¤æ¨¡å¼
3. å¤šæ•°æ®ä¸­å¿ƒéƒ¨ç½²
4. å®šæœŸå¤‡ä»½Sessionæ•°æ®
```

**â“ Sessionå ç”¨å†…å­˜è¿‡å¤§æ€ä¹ˆä¼˜åŒ–ï¼Ÿ**
```
ä¼˜åŒ–ç­–ç•¥ï¼š
1. ç²¾ç®€Sessionå­˜å‚¨å†…å®¹
2. ä½¿ç”¨å‹ç¼©ç®—æ³•
3. è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
4. ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ
```

**ğŸ§  è®°å¿†è¦ç‚¹**ï¼š
- é›†ç¾¤ç¯å¢ƒSessioné—®é¢˜æºäºæ— çŠ¶æ€HTTP + è´Ÿè½½å‡è¡¡
- è§£å†³æ–¹æ¡ˆä¸‰å¤§ç±»ï¼šå¤åˆ¶åŒæ­¥ã€ç²˜æ€§è·¯ç”±ã€å¤–éƒ¨å­˜å‚¨
- å¤–éƒ¨å­˜å‚¨ï¼ˆRedisï¼‰æ˜¯ç›®å‰ä¸»æµå’Œæ¨èæ–¹æ¡ˆ
- æ€§èƒ½ä¼˜åŒ–å…³é”®åœ¨äºå‡å°‘ç½‘ç»œä¼ è¾“å’Œå†…å­˜å ç”¨
- æ–¹æ¡ˆé€‰æ‹©è¦è€ƒè™‘ï¼šè§„æ¨¡ã€æ€§èƒ½ã€å¯é æ€§ã€ç»´æŠ¤æˆæœ¬

**æ ¸å¿ƒç†å¿µ**ï¼šæ²¡æœ‰å®Œç¾çš„Sessionç®¡ç†æ–¹æ¡ˆï¼Œåªæœ‰æœ€é€‚åˆå½“å‰ä¸šåŠ¡åœºæ™¯çš„é€‰æ‹©ã€‚ç†è§£å„æ–¹æ¡ˆçš„ä¼˜ç¼ºç‚¹ï¼Œæ ¹æ®å®é™…éœ€æ±‚åšæŠ€æœ¯å†³ç­–ï¼Œæ‰èƒ½æ„å»ºç¨³å®šé«˜æ•ˆçš„Webåº”ç”¨ï¼