---
title: 3ã€æƒé™éªŒè¯ä¸æ‹¦æˆª
---
## ğŸ“š ç›®å½•

1. [ç™»å½•çŠ¶æ€æ£€æŸ¥åŸºç¡€](#1-ç™»å½•çŠ¶æ€æ£€æŸ¥åŸºç¡€)
2. [æƒé™éªŒè¯é€»è¾‘è®¾è®¡](#2-æƒé™éªŒè¯é€»è¾‘è®¾è®¡)
3. [Filterè¿‡æ»¤å™¨å®ç°](#3-filterè¿‡æ»¤å™¨å®ç°)
4. [æ‹¦æˆªå™¨åº”ç”¨å®æˆ˜](#4-æ‹¦æˆªå™¨åº”ç”¨å®æˆ˜)
5. [ç»Ÿä¸€ä¼šè¯ç®¡ç†ç­–ç•¥](#5-ç»Ÿä¸€ä¼šè¯ç®¡ç†ç­–ç•¥)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” ç™»å½•çŠ¶æ€æ£€æŸ¥åŸºç¡€


### 1.1 ä»€ä¹ˆæ˜¯ç™»å½•çŠ¶æ€æ£€æŸ¥


**ğŸ”¹ ç®€å•ç†è§£**
ç™»å½•çŠ¶æ€æ£€æŸ¥å°±åƒé—¨å«æ£€æŸ¥ä½ çš„å·¥ä½œè¯ä¸€æ ·ï¼Œç¡®ä¿åªæœ‰å·²ç»ç™»å½•çš„ç”¨æˆ·æ‰èƒ½è®¿é—®éœ€è¦æƒé™çš„é¡µé¢ã€‚

```
ç°å®ç”Ÿæ´»ç±»æ¯”ï¼š
ğŸ¢ è¿›å…¥åŠå…¬æ¥¼ â†’ ğŸ†” é—¨å«æ£€æŸ¥å·¥ä½œè¯ â†’ âœ… æ”¾è¡Œ / âŒ æ‹’ç»

Webåº”ç”¨ä¸­ï¼š
ğŸŒ è®¿é—®é¡µé¢ â†’ ğŸ” æ£€æŸ¥ç™»å½•çŠ¶æ€ â†’ âœ… æ˜¾ç¤ºå†…å®¹ / âŒ è·³è½¬ç™»å½•
```

**ğŸ”¹ æ ¸å¿ƒæ¦‚å¿µ**
- **ä¼šè¯çŠ¶æ€**ï¼šç”¨æˆ·æ˜¯å¦å·²ç»æˆåŠŸç™»å½•çš„æ ‡è®°
- **èº«ä»½éªŒè¯**ï¼šç¡®è®¤ç”¨æˆ·æ˜¯è°çš„è¿‡ç¨‹
- **è®¿é—®æ§åˆ¶**ï¼šå†³å®šç”¨æˆ·èƒ½è®¿é—®ä»€ä¹ˆèµ„æº

### 1.2 ç™»å½•çŠ¶æ€çš„å­˜å‚¨æ–¹å¼


**ğŸ“Š å¸¸è§å­˜å‚¨æ–¹å¼å¯¹æ¯”**

| å­˜å‚¨æ–¹å¼ | **å·¥ä½œåŸç†** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** | **é€‚ç”¨åœºæ™¯** |
|---------|------------|---------|---------|-------------|
| ğŸª **Session+Cookie** | `æœåŠ¡å™¨å­˜å‚¨çŠ¶æ€ï¼ŒCookieå­˜ID` | `æœåŠ¡å™¨æ§åˆ¶ï¼Œå®‰å…¨æ€§é«˜` | `å ç”¨æœåŠ¡å™¨å†…å­˜` | `ä¼ ç»ŸWebåº”ç”¨` |
| ğŸ« **JWT Token** | `å®¢æˆ·ç«¯å­˜å‚¨åŠ å¯†ä»¤ç‰Œ` | `æ— çŠ¶æ€ï¼Œæ˜“æ‰©å±•` | `ä»¤ç‰Œè¾ƒå¤§ï¼Œéš¾æ’¤é”€` | `å‰åç«¯åˆ†ç¦»` |
| ğŸ’¾ **æœ¬åœ°å­˜å‚¨** | `æµè§ˆå™¨æœ¬åœ°å­˜å‚¨ç”¨æˆ·ä¿¡æ¯` | `å‡è½»æœåŠ¡å™¨å‹åŠ›` | `å®‰å…¨æ€§è¾ƒä½` | `ç®€å•åº”ç”¨` |

### 1.3 ç™»å½•çŠ¶æ€æ£€æŸ¥çš„æ—¶æœº


**â° æ£€æŸ¥æ—¶æœºå›¾ç¤º**

```
ç”¨æˆ·è¯·æ±‚æµç¨‹ï¼š
ç”¨æˆ· â†’ æµè§ˆå™¨ â†’ æœåŠ¡å™¨ â†’ æƒé™æ£€æŸ¥ â†’ ä¸šåŠ¡å¤„ç† â†’ å“åº”

æ£€æŸ¥ç‚¹ä½ç½®ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·   â”‚â”€â”€â”€â–¶â”‚  æœåŠ¡å™¨   â”‚â”€â”€â”€â–¶â”‚ ä¸šåŠ¡é€»è¾‘ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ æƒé™æ£€æŸ¥  â”‚ â† åœ¨è¿™é‡Œæ‹¦æˆª
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ¯ æ£€æŸ¥æ—¶æœºé€‰æ‹©**
- **âœ… æ¨è**ï¼šåœ¨ä¸šåŠ¡é€»è¾‘æ‰§è¡Œå‰æ£€æŸ¥
- **âœ… æ¨è**ï¼šä½¿ç”¨è¿‡æ»¤å™¨æˆ–æ‹¦æˆªå™¨ç»Ÿä¸€å¤„ç†
- **âŒ ä¸æ¨è**ï¼šåœ¨æ¯ä¸ªä¸šåŠ¡æ–¹æ³•ä¸­é‡å¤æ£€æŸ¥

---

## 2. âš–ï¸ æƒé™éªŒè¯é€»è¾‘è®¾è®¡


### 2.1 æƒé™æ¨¡å‹åŸºç¡€


**ğŸ—ï¸ æƒé™æ¨¡å‹å±‚æ¬¡ç»“æ„**

```
æƒé™ç®¡ç†å±‚æ¬¡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è¶…çº§ç®¡ç†å‘˜  â”‚ â† æœ€é«˜æƒé™ï¼Œå¯ä»¥åšä»»ä½•äº‹
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æ™®é€šç®¡ç†å‘˜  â”‚ â† éƒ¨åˆ†ç®¡ç†æƒé™
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ä¼šå‘˜ç”¨æˆ·    â”‚ â† åŸºç¡€åŠŸèƒ½æƒé™
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æ¸¸å®¢ç”¨æˆ·    â”‚ â† åªèƒ½æµè§ˆå…¬å¼€å†…å®¹
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”¸ æƒé™éªŒè¯çš„æ ¸å¿ƒè¦ç´ **
- **ç”¨æˆ·èº«ä»½**ï¼šå½“å‰ç”¨æˆ·æ˜¯è°
- **èµ„æºæƒé™**ï¼šè¦è®¿é—®çš„èµ„æºéœ€è¦ä»€ä¹ˆæƒé™
- **æƒé™åŒ¹é…**ï¼šç”¨æˆ·æƒé™æ˜¯å¦æ»¡è¶³èµ„æºè¦æ±‚

### 2.2 æƒé™éªŒè¯æµç¨‹è®¾è®¡


**ğŸ“‹ æ ‡å‡†éªŒè¯æµç¨‹**

```
æƒé™éªŒè¯æ­¥éª¤ï¼š
1ï¸âƒ£ è·å–ç”¨æˆ·ä¿¡æ¯
   â†“
2ï¸âƒ£ æ£€æŸ¥ç™»å½•çŠ¶æ€
   â†“
3ï¸âƒ£ è·å–ç”¨æˆ·æƒé™
   â†“
4ï¸âƒ£ åŒ¹é…èµ„æºæƒé™è¦æ±‚
   â†“
5ï¸âƒ£ åšå‡ºé€šè¿‡/æ‹’ç»å†³å®š
```

**ğŸ’¡ å®é™…éªŒè¯ç¤ºä¾‹**

```
ç”¨æˆ·è®¿é—® "/admin/users" é¡µé¢ï¼š

æ£€æŸ¥è¿‡ç¨‹ï¼š
âœ… ç”¨æˆ·å·²ç™»å½•ï¼Ÿ â†’ æ˜¯
âœ… ç”¨æˆ·è§’è‰²ï¼Ÿ â†’ ç®¡ç†å‘˜
âœ… é¡µé¢æƒé™è¦æ±‚ï¼Ÿ â†’ éœ€è¦ç®¡ç†å‘˜æƒé™
âœ… æƒé™åŒ¹é…ï¼Ÿ â†’ åŒ¹é…æˆåŠŸ
ğŸ¯ ç»“æœï¼šå…è®¸è®¿é—®
```

### 2.3 æƒé™ç²’åº¦æ§åˆ¶


**ğŸ¯ æƒé™æ§åˆ¶çº§åˆ«**

| æ§åˆ¶çº§åˆ« | **è¯´æ˜** | **ç¤ºä¾‹** | **å®ç°å¤æ‚åº¦** |
|---------|---------|---------|---------------|
| ğŸŒ **é¡µé¢çº§** | `æ§åˆ¶æ•´ä¸ªé¡µé¢çš„è®¿é—®` | `åªæœ‰ç®¡ç†å‘˜èƒ½è®¿é—®åå°` | `â­â­â˜†â˜†â˜†` |
| ğŸ”§ **åŠŸèƒ½çº§** | `æ§åˆ¶å…·ä½“åŠŸèƒ½æ“ä½œ` | `åªèƒ½æŸ¥çœ‹ä¸èƒ½ä¿®æ”¹` | `â­â­â­â˜†â˜†` |
| ğŸ“„ **æ•°æ®çº§** | `æ§åˆ¶æ•°æ®çš„è®¿é—®èŒƒå›´` | `åªèƒ½çœ‹è‡ªå·±çš„è®¢å•` | `â­â­â­â­â˜†` |
| ğŸ·ï¸ **å­—æ®µçº§** | `æ§åˆ¶å­—æ®µçš„æ˜¾ç¤ºéšè—` | `éšè—æ•æ„Ÿä¿¡æ¯å­—æ®µ` | `â­â­â­â­â­` |

**ğŸ“ æƒé™è®¾è®¡å»ºè®®**
- **æ–°æ‰‹é¡¹ç›®**ï¼šä»é¡µé¢çº§æƒé™å¼€å§‹
- **ä¸­çº§é¡¹ç›®**ï¼šæ·»åŠ åŠŸèƒ½çº§æƒé™æ§åˆ¶
- **å¤æ‚é¡¹ç›®**ï¼šè€ƒè™‘æ•°æ®çº§æƒé™éš”ç¦»

---

## 3. ğŸ” Filterè¿‡æ»¤å™¨å®ç°


### 3.1 Filterè¿‡æ»¤å™¨åŸºç¡€


**ğŸ”¹ ä»€ä¹ˆæ˜¯è¿‡æ»¤å™¨**
è¿‡æ»¤å™¨å°±åƒæœºåœºå®‰æ£€ä¸€æ ·ï¼Œåœ¨ç”¨æˆ·è¯·æ±‚åˆ°è¾¾ç›®æ ‡ä¹‹å‰ï¼Œå…ˆè¿›è¡Œå„ç§æ£€æŸ¥å’Œå¤„ç†ã€‚

```
è¿‡æ»¤å™¨å·¥ä½œæµç¨‹ï¼š
ç”¨æˆ·è¯·æ±‚ â†’ Filterè¿‡æ»¤å™¨ â†’ Servlet â†’ å“åº”ç»“æœ
           â†‘
        åœ¨è¿™é‡Œæ‹¦æˆªå’Œå¤„ç†
```

**ğŸ”¸ è¿‡æ»¤å™¨çš„ç‰¹ç‚¹**
- **é¢„å¤„ç†**ï¼šåœ¨è¯·æ±‚åˆ°è¾¾Servletä¹‹å‰æ‰§è¡Œ
- **åå¤„ç†**ï¼šåœ¨å“åº”è¿”å›å®¢æˆ·ç«¯ä¹‹å‰æ‰§è¡Œ
- **é“¾å¼å¤„ç†**ï¼šå¤šä¸ªè¿‡æ»¤å™¨å¯ä»¥å½¢æˆè¿‡æ»¤é“¾

### 3.2 ç™»å½•éªŒè¯è¿‡æ»¤å™¨å®ç°


**ğŸ’» åŸºç¡€ç™»å½•è¿‡æ»¤å™¨**

```java
@WebFilter(urlPatterns = {"/admin/*", "/user/*"})
public class LoginCheckFilter implements Filter {
    
    // ä¸éœ€è¦ç™»å½•çš„é¡µé¢
    private String[] excludeUrls = {
        "/login.jsp", 
        "/register.jsp", 
        "/public/*"
    };
    
    @Override
    public void doFilter(ServletRequest request, 
                        ServletResponse response, 
                        FilterChain chain) throws IOException, ServletException {
        
        HttpServletRequest req = (HttpServletRequest) request;
        HttpServletResponse resp = (HttpServletResponse) response;
        
        // 1. è·å–è¯·æ±‚è·¯å¾„
        String requestURI = req.getRequestURI();
        
        // 2. åˆ¤æ–­æ˜¯å¦éœ€è¦ç™»å½•éªŒè¯
        if (needLogin(requestURI)) {
            // 3. æ£€æŸ¥ç™»å½•çŠ¶æ€
            HttpSession session = req.getSession();
            Object user = session.getAttribute("loginUser");
            
            if (user == null) {
                // æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
                resp.sendRedirect(req.getContextPath() + "/login.jsp");
                return;
            }
        }
        
        // 4. æ”¾è¡Œè¯·æ±‚
        chain.doFilter(request, response);
    }
    
    // åˆ¤æ–­æ˜¯å¦éœ€è¦ç™»å½•éªŒè¯
    private boolean needLogin(String uri) {
        for (String excludeUrl : excludeUrls) {
            if (uri.contains(excludeUrl)) {
                return false;  // ä¸éœ€è¦ç™»å½•
            }
        }
        return true;  // éœ€è¦ç™»å½•
    }
}
```

### 3.3 è§’è‰²æƒé™è¿‡æ»¤å™¨å®ç°


**ğŸ” è§’è‰²æƒé™éªŒè¯è¿‡æ»¤å™¨**

```java
@WebFilter(urlPatterns = {"/admin/*"})
public class AdminAuthFilter implements Filter {
    
    @Override
    public void doFilter(ServletRequest request, 
                        ServletResponse response, 
                        FilterChain chain) throws IOException, ServletException {
        
        HttpServletRequest req = (HttpServletRequest) request;
        HttpServletResponse resp = (HttpServletResponse) response;
        
        // è·å–ç”¨æˆ·ä¿¡æ¯
        HttpSession session = req.getSession();
        User user = (User) session.getAttribute("loginUser");
        
        // æ£€æŸ¥ç”¨æˆ·è§’è‰²
        if (user == null || !"admin".equals(user.getRole())) {
            // æƒé™ä¸è¶³ï¼Œè¿”å›é”™è¯¯é¡µé¢
            resp.sendRedirect(req.getContextPath() + "/error/403.jsp");
            return;
        }
        
        // æƒé™éªŒè¯é€šè¿‡ï¼Œç»§ç»­æ‰§è¡Œ
        chain.doFilter(request, response);
    }
}
```

### 3.4 è¿‡æ»¤å™¨é…ç½®ä¸ç®¡ç†


**âš™ï¸ è¿‡æ»¤å™¨é…ç½®æ–¹å¼**

```java
// æ–¹å¼1ï¼šæ³¨è§£é…ç½®
@WebFilter(
    filterName = "LoginFilter",
    urlPatterns = {"/protected/*"},
    initParams = {
        @WebInitParam(name = "excludeUrls", value = "/login,/register")
    }
)

// æ–¹å¼2ï¼šweb.xmlé…ç½®
```

```xml
<filter>
    <filter-name>LoginFilter</filter-name>
    <filter-class>com.example.filter.LoginCheckFilter</filter-class>
    <init-param>
        <param-name>excludeUrls</param-name>
        <param-value>/login,/register,/public</param-value>
    </init-param>
</filter>
<filter-mapping>
    <filter-name>LoginFilter</filter-name>
    <url-pattern>/protected/*</url-pattern>
</filter-mapping>
```

---

## 4. ğŸ›¡ï¸ æ‹¦æˆªå™¨åº”ç”¨å®æˆ˜


### 4.1 æ‹¦æˆªå™¨ä¸è¿‡æ»¤å™¨çš„åŒºåˆ«


**ğŸ“Š è¿‡æ»¤å™¨ vs æ‹¦æˆªå™¨å¯¹æ¯”**

```
æ‰§è¡Œé¡ºåºå›¾ï¼š
å®¢æˆ·ç«¯è¯·æ±‚
    â†“
Filterè¿‡æ»¤å™¨ â† åœ¨Servletå®¹å™¨å±‚é¢
    â†“
DispatcherServlet
    â†“
Interceptoræ‹¦æˆªå™¨ â† åœ¨Springæ¡†æ¶å±‚é¢
    â†“
Controllerå¤„ç†
```

| ç‰¹æ€§ | **Filterè¿‡æ»¤å™¨** | **Interceptoræ‹¦æˆªå™¨** |
|------|-----------------|---------------------|
| ğŸ—ï¸ **æ‰€å±å±‚é¢** | `Servletå®¹å™¨å±‚` | `Springæ¡†æ¶å±‚` |
| âš¡ **æ‰§è¡Œæ—¶æœº** | `Servletå‰å` | `Controllerå‰å` |
| ğŸ”§ **åŠŸèƒ½ç‰¹ç‚¹** | `é€šç”¨æ€§å¼ºï¼Œåº•å±‚` | `Springé›†æˆå¥½ï¼Œçµæ´»` |
| ğŸ“ **é…ç½®æ–¹å¼** | `web.xmlæˆ–@WebFilter` | `å®ç°HandlerInterceptor` |

### 4.2 Springæ‹¦æˆªå™¨å®ç°


**ğŸš€ ç™»å½•éªŒè¯æ‹¦æˆªå™¨**

```java
@Component
public class LoginInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler) throws Exception {
        
        // 1. è·å–sessionä¸­çš„ç”¨æˆ·ä¿¡æ¯
        HttpSession session = request.getSession();
        User loginUser = (User) session.getAttribute("user");
        
        // 2. åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç™»å½•
        if (loginUser == null) {
            // æœªç™»å½•ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯ï¼ˆé€‚ç”¨äºAJAXè¯·æ±‚ï¼‰
            if (isAjaxRequest(request)) {
                response.setContentType("application/json;charset=utf-8");
                response.getWriter().write("{\"code\":401,\"msg\":\"è¯·å…ˆç™»å½•\"}");
            } else {
                // æ™®é€šè¯·æ±‚ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ
                response.sendRedirect("/login");
            }
            return false;  // æ‹¦æˆªè¯·æ±‚
        }
        
        return true;  // æ”¾è¡Œè¯·æ±‚
    }
    
    // åˆ¤æ–­æ˜¯å¦ä¸ºAJAXè¯·æ±‚
    private boolean isAjaxRequest(HttpServletRequest request) {
        return "XMLHttpRequest".equals(request.getHeader("X-Requested-With"));
    }
}
```

### 4.3 æƒé™çº§åˆ«æ‹¦æˆªå™¨


**ğŸ¯ å¤šçº§æƒé™æ§åˆ¶æ‹¦æˆªå™¨**

```java
@Component
public class AuthorityInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler) throws Exception {
        
        // 1. è·å–è¯·æ±‚çš„æ–¹æ³•ä¿¡æ¯
        if (handler instanceof HandlerMethod) {
            HandlerMethod handlerMethod = (HandlerMethod) handler;
            
            // 2. æ£€æŸ¥æ–¹æ³•æ˜¯å¦éœ€è¦æƒé™éªŒè¯
            RequireAuth requireAuth = handlerMethod.getMethodAnnotation(RequireAuth.class);
            if (requireAuth == null) {
                return true;  // ä¸éœ€è¦æƒé™éªŒè¯
            }
            
            // 3. è·å–ç”¨æˆ·ä¿¡æ¯å’Œæƒé™
            User user = getCurrentUser(request);
            String[] requiredRoles = requireAuth.roles();
            
            // 4. éªŒè¯ç”¨æˆ·æƒé™
            if (!hasPermission(user, requiredRoles)) {
                response.setStatus(403);
                response.getWriter().write("æƒé™ä¸è¶³");
                return false;
            }
        }
        
        return true;
    }
    
    // è·å–å½“å‰ç”¨æˆ·
    private User getCurrentUser(HttpServletRequest request) {
        HttpSession session = request.getSession();
        return (User) session.getAttribute("user");
    }
    
    // æ£€æŸ¥ç”¨æˆ·æƒé™
    private boolean hasPermission(User user, String[] requiredRoles) {
        if (user == null || requiredRoles.length == 0) {
            return false;
        }
        
        String userRole = user.getRole();
        for (String role : requiredRoles) {
            if (role.equals(userRole)) {
                return true;
            }
        }
        return false;
    }
}
```

### 4.4 è‡ªå®šä¹‰æƒé™æ³¨è§£


**ğŸ·ï¸ æƒé™æ³¨è§£å®šä¹‰**

```java
// æƒé™éªŒè¯æ³¨è§£
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface RequireAuth {
    String[] roles() default {};  // éœ€è¦çš„è§’è‰²
    String[] permissions() default {};  // éœ€è¦çš„æƒé™
}

// ä½¿ç”¨ç¤ºä¾‹
@RestController
public class AdminController {
    
    @RequireAuth(roles = {"admin"})
    @PostMapping("/admin/deleteUser")
    public String deleteUser(@RequestParam int userId) {
        // åªæœ‰ç®¡ç†å‘˜èƒ½æ‰§è¡Œçš„æ“ä½œ
        return "åˆ é™¤æˆåŠŸ";
    }
    
    @RequireAuth(roles = {"admin", "moderator"})
    @GetMapping("/admin/userList")
    public List<User> getUserList() {
        // ç®¡ç†å‘˜å’Œç‰ˆä¸»éƒ½èƒ½è®¿é—®
        return userService.getAllUsers();
    }
}
```

---

## 5. ğŸ”§ ç»Ÿä¸€ä¼šè¯ç®¡ç†ç­–ç•¥


### 5.1 ä¼šè¯ç®¡ç†æ¶æ„è®¾è®¡


**ğŸ—ï¸ ç»Ÿä¸€ä¼šè¯ç®¡ç†æ¶æ„**

```
ä¼šè¯ç®¡ç†å±‚æ¬¡ç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å‰ç«¯é¡µé¢                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ä¼šè¯ç®¡ç†å±‚                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ç™»å½•éªŒè¯ â”‚ â”‚æƒé™æ§åˆ¶ â”‚ â”‚ä¼šè¯å­˜å‚¨ â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ä¸šåŠ¡é€»è¾‘å±‚                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 ä¼šè¯å·¥å…·ç±»è®¾è®¡


**ğŸ› ï¸ ç»Ÿä¸€ä¼šè¯ç®¡ç†å·¥å…·**

```java
@Component
public class SessionManager {
    
    // ä¼šè¯keyå¸¸é‡
    public static final String USER_SESSION_KEY = "loginUser";
    public static final String USER_PERMISSIONS_KEY = "userPermissions";
    
    /**
     * ç”¨æˆ·ç™»å½• - åˆ›å»ºä¼šè¯
     */
    public void login(HttpServletRequest request, User user) {
        HttpSession session = request.getSession();
        
        // å­˜å‚¨ç”¨æˆ·ä¿¡æ¯
        session.setAttribute(USER_SESSION_KEY, user);
        
        // è·å–å¹¶å­˜å‚¨ç”¨æˆ·æƒé™
        List<String> permissions = getUserPermissions(user);
        session.setAttribute(USER_PERMISSIONS_KEY, permissions);
        
        // è®¾ç½®ä¼šè¯è¶…æ—¶æ—¶é—´ï¼ˆ30åˆ†é’Ÿï¼‰
        session.setMaxInactiveInterval(30 * 60);
        
        // è®°å½•ç™»å½•æ—¥å¿—
        logUserLogin(user, request.getRemoteAddr());
    }
    
    /**
     * è·å–å½“å‰ç™»å½•ç”¨æˆ·
     */
    public User getCurrentUser(HttpServletRequest request) {
        HttpSession session = request.getSession(false);
        if (session != null) {
            return (User) session.getAttribute(USER_SESSION_KEY);
        }
        return null;
    }
    
    /**
     * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
     */
    public boolean isLogin(HttpServletRequest request) {
        return getCurrentUser(request) != null;
    }
    
    /**
     * æ£€æŸ¥ç”¨æˆ·æƒé™
     */
    @SuppressWarnings("unchecked")
    public boolean hasPermission(HttpServletRequest request, String permission) {
        HttpSession session = request.getSession(false);
        if (session != null) {
            List<String> permissions = (List<String>) session.getAttribute(USER_PERMISSIONS_KEY);
            return permissions != null && permissions.contains(permission);
        }
        return false;
    }
    
    /**
     * ç”¨æˆ·ç™»å‡º - é”€æ¯ä¼šè¯
     */
    public void logout(HttpServletRequest request) {
        HttpSession session = request.getSession(false);
        if (session != null) {
            User user = getCurrentUser(request);
            session.invalidate();  // é”€æ¯ä¼šè¯
            
            // è®°å½•ç™»å‡ºæ—¥å¿—
            if (user != null) {
                logUserLogout(user, request.getRemoteAddr());
            }
        }
    }
    
    // è·å–ç”¨æˆ·æƒé™åˆ—è¡¨
    private List<String> getUserPermissions(User user) {
        // è¿™é‡Œå¯ä»¥ä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·æƒé™
        // ä¸ºç®€åŒ–ç¤ºä¾‹ï¼Œç›´æ¥æ ¹æ®è§’è‰²è¿”å›
        List<String> permissions = new ArrayList<>();
        if ("admin".equals(user.getRole())) {
            permissions.add("user:create");
            permissions.add("user:delete");
            permissions.add("user:update");
            permissions.add("user:view");
        } else if ("user".equals(user.getRole())) {
            permissions.add("user:view");
        }
        return permissions;
    }
    
    // ç™»å½•æ—¥å¿—è®°å½•
    private void logUserLogin(User user, String ip) {
        System.out.println("ç”¨æˆ·ç™»å½•: " + user.getUsername() + ", IP: " + ip);
    }
    
    // ç™»å‡ºæ—¥å¿—è®°å½•
    private void logUserLogout(User user, String ip) {
        System.out.println("ç”¨æˆ·ç™»å‡º: " + user.getUsername() + ", IP: " + ip);
    }
}
```

### 5.3 ä¼šè¯å®‰å…¨å¢å¼º


**ğŸ›¡ï¸ ä¼šè¯å®‰å…¨é…ç½®**

```java
@Configuration
public class SessionConfig {
    
    /**
     * é…ç½®ä¼šè¯å®‰å…¨ç­–ç•¥
     */
    @Bean
    public HttpSessionListener sessionSecurityListener() {
        return new HttpSessionListener() {
            @Override
            public void sessionCreated(HttpSessionEvent se) {
                HttpSession session = se.getSession();
                
                // 1. è®¾ç½®ä¼šè¯è¶…æ—¶æ—¶é—´
                session.setMaxInactiveInterval(30 * 60);
                
                // 2. è®°å½•ä¼šè¯åˆ›å»º
                System.out.println("æ–°ä¼šè¯åˆ›å»º: " + session.getId());
            }
            
            @Override
            public void sessionDestroyed(HttpSessionEvent se) {
                HttpSession session = se.getSession();
                System.out.println("ä¼šè¯é”€æ¯: " + session.getId());
            }
        };
    }
}
```

**âš ï¸ ä¼šè¯å®‰å…¨æ³¨æ„äº‹é¡¹**

```
ğŸ”’ ä¼šè¯å›ºåŒ–æ”»å‡»é˜²æŠ¤ï¼š
â€¢ ç™»å½•æˆåŠŸåé‡æ–°ç”ŸæˆSession ID
â€¢ é¿å…åœ¨URLä¸­ä¼ é€’Session ID

ğŸ”’ ä¼šè¯åŠ«æŒé˜²æŠ¤ï¼š
â€¢ ä½¿ç”¨HTTPSä¼ è¾“
â€¢ è®¾ç½®Cookieçš„Secureå’ŒHttpOnlyå±æ€§

ğŸ”’ ä¼šè¯è¶…æ—¶ç®¡ç†ï¼š
â€¢ è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
â€¢ æ•æ„Ÿæ“ä½œè¦æ±‚é‡æ–°éªŒè¯
```

### 5.4 é›†ç¾¤ç¯å¢ƒä¼šè¯åŒæ­¥


**ğŸŒ åˆ†å¸ƒå¼ä¼šè¯è§£å†³æ–¹æ¡ˆ**

| æ–¹æ¡ˆ | **å·¥ä½œåŸç†** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** | **é€‚ç”¨åœºæ™¯** |
|------|------------|---------|---------|-------------|
| ğŸ“‹ **Sessionå¤åˆ¶** | `å¤šä¸ªæœåŠ¡å™¨åŒæ­¥Session` | `å®ç°ç®€å•` | `æ€§èƒ½å¼€é”€å¤§` | `å°è§„æ¨¡é›†ç¾¤` |
| ğŸ’¾ **é›†ä¸­å­˜å‚¨** | `Redisç­‰å­˜å‚¨Session` | `æ€§èƒ½å¥½ï¼Œå¯æ‰©å±•` | `éœ€è¦é¢å¤–ä¸­é—´ä»¶` | `å¤§è§„æ¨¡é›†ç¾¤` |
| ğŸ« **Tokenæ–¹æ¡ˆ** | `JWTç­‰æ— çŠ¶æ€ä»¤ç‰Œ` | `æ— éœ€å­˜å‚¨ï¼Œæ˜“æ‰©å±•` | `ä»¤ç‰Œç®¡ç†å¤æ‚` | `å¾®æœåŠ¡æ¶æ„` |

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ ç™»å½•çŠ¶æ€æ£€æŸ¥ï¼šéªŒè¯ç”¨æˆ·èº«ä»½çš„é—¨å«æœºåˆ¶
ğŸ”¸ æƒé™éªŒè¯é€»è¾‘ï¼šç¡®ä¿ç”¨æˆ·åªèƒ½è®¿é—®æœ‰æƒé™çš„èµ„æº
ğŸ”¸ Filterè¿‡æ»¤å™¨ï¼šåœ¨è¯·æ±‚å¤„ç†å‰è¿›è¡Œç»Ÿä¸€æ‹¦æˆª
ğŸ”¸ æ‹¦æˆªå™¨åº”ç”¨ï¼šSpringæ¡†æ¶å±‚é¢çš„è¯·æ±‚æ‹¦æˆª
ğŸ”¸ ç»Ÿä¸€ä¼šè¯ç®¡ç†ï¼šé›†ä¸­ç®¡ç†ç”¨æˆ·ä¼šè¯çŠ¶æ€å’Œæƒé™
```

### 6.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ æƒé™æ§åˆ¶çš„æœ¬è´¨**
```
æƒé™æ§åˆ¶ = èº«ä»½éªŒè¯ + æˆæƒéªŒè¯
â€¢ èº«ä»½éªŒè¯ï¼šç¡®è®¤ç”¨æˆ·æ˜¯è°
â€¢ æˆæƒéªŒè¯ï¼šç¡®è®¤ç”¨æˆ·èƒ½åšä»€ä¹ˆ
â€¢ ä¸¤è€…ç¼ºä¸€ä¸å¯ï¼Œå…±åŒä¿éšœç³»ç»Ÿå®‰å…¨
```

**ğŸ”¹ Filterå’ŒInterceptorçš„é€‰æ‹©**
```
é€‰æ‹©åŸåˆ™ï¼š
â€¢ é€šç”¨æ€§è¦æ±‚é«˜ â†’ é€‰æ‹©Filter
â€¢ Springé›†æˆéœ€æ±‚ â†’ é€‰æ‹©Interceptor  
â€¢ åº•å±‚æ§åˆ¶éœ€æ±‚ â†’ é€‰æ‹©Filter
â€¢ çµæ´»é…ç½®éœ€æ±‚ â†’ é€‰æ‹©Interceptor
```

**ğŸ”¹ ä¼šè¯ç®¡ç†çš„æ ¸å¿ƒæ€è·¯**
```
ç»Ÿä¸€ç®¡ç†æ€è·¯ï¼š
â€¢ ç»Ÿä¸€çš„ç™»å½•å…¥å£
â€¢ ç»Ÿä¸€çš„æƒé™æ£€æŸ¥
â€¢ ç»Ÿä¸€çš„ä¼šè¯å­˜å‚¨
â€¢ ç»Ÿä¸€çš„å®‰å…¨ç­–ç•¥
```

### 6.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¸šåŠ¡åœºæ™¯åº”ç”¨**
- **ç”µå•†ç½‘ç«™**ï¼šç”¨æˆ·ä¸­å¿ƒæƒé™ã€ç®¡ç†åå°æ§åˆ¶
- **å†…å®¹ç®¡ç†**ï¼šæ–‡ç« ç¼–è¾‘æƒé™ã€å®¡æ ¸æµç¨‹æ§åˆ¶
- **ä¼ä¸šç³»ç»Ÿ**ï¼šå‘˜å·¥æƒé™åˆ†çº§ã€éƒ¨é—¨æ•°æ®éš”ç¦»
- **åœ¨çº¿æ•™è‚²**ï¼šå­¦å‘˜å’Œè®²å¸ˆæƒé™åŒºåˆ†

**ğŸ”§ å¼€å‘å®è·µæŒ‡å¯¼**
- **æ–°æ‰‹é˜¶æ®µ**ï¼šä»ç®€å•çš„ç™»å½•æ£€æŸ¥å¼€å§‹
- **è¿›é˜¶é˜¶æ®µ**ï¼šå®ç°è§’è‰²æƒé™æ§åˆ¶
- **é«˜çº§é˜¶æ®µ**ï¼šè®¾è®¡ç»†ç²’åº¦æƒé™ç³»ç»Ÿ
- **æ¶æ„é˜¶æ®µ**ï¼šè€ƒè™‘åˆ†å¸ƒå¼ä¼šè¯æ–¹æ¡ˆ

**ğŸ’¡ æœ€ä½³å®è·µå»ºè®®**

```
âœ… æ¨èåšæ³•ï¼š
â€¢ ä½¿ç”¨è¿‡æ»¤å™¨æˆ–æ‹¦æˆªå™¨ç»Ÿä¸€å¤„ç†
â€¢ è®¾è®¡æ¸…æ™°çš„æƒé™æ¨¡å‹
â€¢ å®ç°ç»Ÿä¸€çš„ä¼šè¯ç®¡ç†å·¥å…·ç±»
â€¢ åŠ å¼ºä¼šè¯å®‰å…¨é˜²æŠ¤

âŒ é¿å…çš„é—®é¢˜ï¼š
â€¢ åœ¨æ¯ä¸ªControllerä¸­é‡å¤æ£€æŸ¥æƒé™
â€¢ ç¡¬ç¼–ç æƒé™é€»è¾‘
â€¢ å¿½è§†ä¼šè¯å®‰å…¨é—®é¢˜
â€¢ è¿‡åº¦å¤æ‚åŒ–æƒé™è®¾è®¡
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- æƒé™æ§åˆ¶å¦‚åŒé—¨å«æ£€æŸ¥ï¼Œç¡®ä¿å®‰å…¨è®¿é—®
- Filterå’ŒInterceptorå„æœ‰ä¼˜åŠ¿ï¼ŒæŒ‰éœ€é€‰æ‹©
- ç»Ÿä¸€ä¼šè¯ç®¡ç†æ˜¯å¤§å‹åº”ç”¨çš„å¿…å¤‡æŠ€èƒ½
- å®‰å…¨æ°¸è¿œæ˜¯æƒé™ç³»ç»Ÿè®¾è®¡çš„ç¬¬ä¸€è¦åŠ¡