---
title: 4ã€éªŒè¯ç æœºåˆ¶å®ç°
---
## ğŸ“š ç›®å½•

1. [éªŒè¯ç åŸºç¡€æ¦‚å¿µ](#1-éªŒè¯ç åŸºç¡€æ¦‚å¿µ)
2. [éªŒè¯ç ç”Ÿæˆç®—æ³•](#2-éªŒè¯ç ç”Ÿæˆç®—æ³•)
3. [å›¾å½¢éªŒè¯ç å®ç°](#3-å›¾å½¢éªŒè¯ç å®ç°)
4. [Sessionå­˜å‚¨éªŒè¯ç ](#4-Sessionå­˜å‚¨éªŒè¯ç )
5. [éªŒè¯ç æ ¡éªŒé€»è¾‘](#5-éªŒè¯ç æ ¡éªŒé€»è¾‘)
6. [é˜²åˆ·æ–°æœºåˆ¶](#6-é˜²åˆ·æ–°æœºåˆ¶)
7. [å®Œæ•´å®æˆ˜æ¡ˆä¾‹](#7-å®Œæ•´å®æˆ˜æ¡ˆä¾‹)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” éªŒè¯ç åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯éªŒè¯ç 


**éªŒè¯ç ï¼ˆCAPTCHAï¼‰**ï¼šå…¨ç§°æ˜¯"Completely Automated Public Turing test to tell Computers and Humans Apart"ï¼Œç¿»è¯‘è¿‡æ¥å°±æ˜¯"å…¨è‡ªåŠ¨åŒºåˆ†è®¡ç®—æœºå’Œäººç±»çš„å›¾çµæµ‹è¯•"ã€‚

**ğŸ¯ ç®€å•ç†è§£**ï¼šéªŒè¯ç å°±æ˜¯è®©ç”¨æˆ·è¯æ˜"æˆ‘æ˜¯çœŸäºº"çš„ä¸€ç§æµ‹è¯•æ–¹å¼ã€‚

```
ä¸ºä»€ä¹ˆéœ€è¦éªŒè¯ç ï¼Ÿ

ç°å®æƒ…å†µï¼š
â†’ æ¶æ„ç¨‹åºå¯ä»¥è‡ªåŠ¨æäº¤è¡¨å•
â†’ çˆ¬è™«å¯ä»¥æ‰¹é‡æ³¨å†Œè´¦å·
â†’ æœºå™¨äººå¯ä»¥æ¶æ„åˆ·ç¥¨ã€åˆ·è¯„è®º

éªŒè¯ç çš„ä½œç”¨ï¼š
â†’ é˜»æ­¢æœºå™¨è‡ªåŠ¨æ“ä½œ
â†’ ä¿æŠ¤ç½‘ç«™å…å—æ¶æ„æ”»å‡»
â†’ ç¡®ä¿æ“ä½œæ˜¯ç”±çœŸäººå®Œæˆ
```

### 1.2 éªŒè¯ç çš„å·¥ä½œåŸç†


**åŸºæœ¬å·¥ä½œæµç¨‹**ï¼š

```
æœåŠ¡å™¨ç«¯                     å®¢æˆ·ç«¯
    |                          |
1. ç”ŸæˆéšæœºéªŒè¯ç  ---------------â†’ æ˜¾ç¤ºéªŒè¯ç å›¾ç‰‡
2. å­˜å‚¨åˆ°Sessionä¸­              |
    |                          |
    | â†--------------------- 3. ç”¨æˆ·è¾“å…¥éªŒè¯ç 
4. ä»Sessionå–å‡ºéªŒè¯ç           |
5. å¯¹æ¯”ç”¨æˆ·è¾“å…¥                |
6. è¿”å›éªŒè¯ç»“æœ ---------------â†’ æ˜¾ç¤ºæˆåŠŸ/å¤±è´¥
```

**ğŸ”¸ æ ¸å¿ƒè¦ç´ **ï¼š
- **éšæœºæ€§**ï¼šæ¯æ¬¡ç”Ÿæˆçš„éªŒè¯ç éƒ½ä¸åŒ
- **æ—¶æ•ˆæ€§**ï¼šéªŒè¯ç æœ‰ä½¿ç”¨æ—¶é—´é™åˆ¶
- **å”¯ä¸€æ€§**ï¼šä¸€ä¸ªéªŒè¯ç åªèƒ½ä½¿ç”¨ä¸€æ¬¡
- **å®‰å…¨æ€§**ï¼šå­˜å‚¨åœ¨æœåŠ¡å™¨ç«¯ï¼Œå®¢æˆ·ç«¯çœ‹ä¸åˆ°ç­”æ¡ˆ

### 1.3 éªŒè¯ç çš„ç±»å‹


**å¸¸è§éªŒè¯ç ç±»å‹**ï¼š

| ç±»å‹ | ç‰¹ç‚¹ | ä½¿ç”¨åœºæ™¯ | å®‰å…¨æ€§ |
|------|------|----------|--------|
| **æ•°å­—éªŒè¯ç ** | `ç®€å•æ˜“è¯†åˆ«ï¼Œ4-6ä½æ•°å­—` | `ç™»å½•ã€æ³¨å†Œ` | â­â­ |
| **å­—æ¯éªŒè¯ç ** | `åŒ…å«å¤§å°å†™å­—æ¯` | `è¡¨å•æäº¤` | â­â­â­ |
| **æ•°å­—å­—æ¯æ··åˆ** | `æ•°å­—+å­—æ¯ç»„åˆ` | `æ”¯ä»˜éªŒè¯` | â­â­â­â­ |
| **æ•°å­¦è¿ç®—** | `1+1=?ç®€å•è®¡ç®—` | `è¯„è®ºå‘å¸ƒ` | â­â­ |
| **æ»‘åŠ¨éªŒè¯** | `æ‹–æ‹½æ»‘å—å®Œæˆæ‹¼å›¾` | `ç°ä»£ç½‘ç«™` | â­â­â­â­â­ |

---

## 2. ğŸ² éªŒè¯ç ç”Ÿæˆç®—æ³•


### 2.1 éšæœºå­—ç¬¦ç”Ÿæˆ


**æ ¸å¿ƒæ€è·¯**ï¼šä»é¢„å®šä¹‰çš„å­—ç¬¦é›†ä¸­éšæœºé€‰æ‹©å­—ç¬¦ç»„æˆéªŒè¯ç ã€‚

**å­—ç¬¦é›†å®šä¹‰**ï¼š
```java
// å®šä¹‰å¯ç”¨çš„å­—ç¬¦é›†åˆ
public class CaptchaGenerator {
    // æ•°å­—å­—ç¬¦é›†
    private static final String NUMBERS = "0123456789";
    
    // å­—æ¯å­—ç¬¦é›†ï¼ˆå»æ‰å®¹æ˜“æ··æ·†çš„å­—ç¬¦ï¼‰
    private static final String LETTERS = "ABCDEFGHJKLMNPQRSTUVWXYZ";
    
    // æ•°å­—+å­—æ¯æ··åˆå­—ç¬¦é›†
    private static final String MIXED_CHARS = NUMBERS + LETTERS;
}
```

> ğŸ’¡ **ä¸ºä»€ä¹ˆè¦å»æ‰æŸäº›å­—ç¬¦ï¼Ÿ**  
> å»æ‰äº† `0O`ã€`1lI` è¿™äº›å®¹æ˜“æ··æ·†çš„å­—ç¬¦ï¼Œæé«˜ç”¨æˆ·ä½“éªŒ

### 2.2 éšæœºç”Ÿæˆç®—æ³•å®ç°


**åŸºç¡€éšæœºç”Ÿæˆæ–¹æ³•**ï¼š
```java
public class CaptchaGenerator {
    private static final String CHAR_SET = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    private static final Random random = new Random();
    
    /**
     * ç”ŸæˆæŒ‡å®šé•¿åº¦çš„éªŒè¯ç 
     * @param length éªŒè¯ç é•¿åº¦
     * @return éªŒè¯ç å­—ç¬¦ä¸²
     */
    public static String generateCode(int length) {
        StringBuilder code = new StringBuilder();
        
        for (int i = 0; i < length; i++) {
            // éšæœºé€‰æ‹©ä¸€ä¸ªå­—ç¬¦
            int index = random.nextInt(CHAR_SET.length());
            code.append(CHAR_SET.charAt(index));
        }
        
        return code.toString();
    }
}
```

**ğŸ”¸ ç®—æ³•è§£æ**ï¼š
1. **å®šä¹‰å­—ç¬¦é›†**ï¼šåŒ…å«æ‰€æœ‰å¯èƒ½çš„å­—ç¬¦
2. **éšæœºç´¢å¼•**ï¼š`random.nextInt(length)` ç”Ÿæˆéšæœºä½ç½®
3. **å­—ç¬¦é€‰å–**ï¼šæ ¹æ®éšæœºç´¢å¼•é€‰æ‹©å­—ç¬¦
4. **æ‹¼æ¥ç»“æœ**ï¼šå°†é€‰ä¸­çš„å­—ç¬¦ç»„åˆæˆéªŒè¯ç 

### 2.3 å¢å¼ºéšæœºæ€§çš„æ–¹æ³•


**ä½¿ç”¨ SecureRandom æé«˜å®‰å…¨æ€§**ï¼š
```java
import java.security.SecureRandom;

public class SecureCaptchaGenerator {
    private static final SecureRandom secureRandom = new SecureRandom();
    
    public static String generateSecureCode(int length) {
        String chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
        StringBuilder code = new StringBuilder();
        
        for (int i = 0; i < length; i++) {
            int index = secureRandom.nextInt(chars.length());
            code.append(chars.charAt(index));
        }
        
        return code.toString();
    }
}
```

> âš ï¸ **SecureRandom vs Random**  
> `SecureRandom` æä¾›æ›´å¼ºçš„éšæœºæ€§ï¼Œé€‚åˆå®‰å…¨è¦æ±‚é«˜çš„åœºæ™¯

---

## 3. ğŸ–¼ï¸ å›¾å½¢éªŒè¯ç å®ç°


### 3.1 å›¾å½¢éªŒè¯ç çš„ç»„æˆè¦ç´ 


**ä¸€ä¸ªå›¾å½¢éªŒè¯ç åŒ…å«ä»€ä¹ˆï¼Ÿ**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  A B C D    â†éªŒè¯ç æ–‡å­—  â”‚
â”‚   â•± â•²  â•±   â†å¹²æ‰°çº¿     â”‚
â”‚  â— â—‹ â—     â†å¹²æ‰°ç‚¹     â”‚
â”‚    ï½ï½     â†å™ªç‚¹      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†‘           â†‘
 èƒŒæ™¯è‰²    æ–‡å­—é¢œè‰²
```

**ğŸ”¸ å…³é”®å…ƒç´ **ï¼š
- **ç”»å¸ƒ**ï¼šè®¾å®šå›¾ç‰‡çš„å®½åº¦å’Œé«˜åº¦
- **èƒŒæ™¯**ï¼šé€šå¸¸æ˜¯ç™½è‰²æˆ–æµ…è‰²
- **æ–‡å­—**ï¼šéªŒè¯ç å­—ç¬¦ï¼Œä½¿ç”¨ä¸åŒå­—ä½“å’Œé¢œè‰²
- **å¹²æ‰°å…ƒç´ **ï¼šçº¿æ¡ã€ç‚¹ã€å™ªç‚¹ç­‰ï¼Œå¢åŠ è¯†åˆ«éš¾åº¦

### 3.2 ä½¿ç”¨ Java ç»˜åˆ¶éªŒè¯ç å›¾ç‰‡


**æ ¸å¿ƒç»˜åˆ¶æµç¨‹**ï¼š
```java
import java.awt.*;
import java.awt.image.BufferedImage;

public class ImageCaptcha {
    
    public static BufferedImage createCaptchaImage(String code) {
        // 1. åˆ›å»ºç”»å¸ƒ
        int width = 120, height = 40;
        BufferedImage image = new BufferedImage(width, height, BufferedImage.TYPE_INT_RGB);
        
        // 2. è·å–ç”»ç¬”
        Graphics2D g = image.createGraphics();
        
        // 3. è®¾ç½®èƒŒæ™¯
        g.setColor(Color.WHITE);
        g.fillRect(0, 0, width, height);
        
        // 4. ç»˜åˆ¶æ–‡å­—
        drawText(g, code, width, height);
        
        // 5. æ·»åŠ å¹²æ‰°
        drawNoise(g, width, height);
        
        g.dispose();
        return image;
    }
}
```

**æ–‡å­—ç»˜åˆ¶è¯¦ç»†å®ç°**ï¼š
```java
private static void drawText(Graphics2D g, String code, int width, int height) {
    // è®¾ç½®å­—ä½“
    Font font = new Font("Arial", Font.BOLD, 28);
    g.setFont(font);
    
    // è®¡ç®—å­—ç¬¦é—´è·
    int charWidth = width / code.length();
    
    for (int i = 0; i < code.length(); i++) {
        // æ¯ä¸ªå­—ç¬¦ä½¿ç”¨éšæœºé¢œè‰²
        g.setColor(getRandomColor());
        
        // è®¡ç®—å­—ç¬¦ä½ç½®
        int x = i * charWidth + 10;
        int y = height / 2 + 10;
        
        // ç»˜åˆ¶å­—ç¬¦
        g.drawString(String.valueOf(code.charAt(i)), x, y);
    }
}

private static Color getRandomColor() {
    Random random = new Random();
    return new Color(
        random.nextInt(128),    // R: 0-127 (æ·±è‰²)
        random.nextInt(128),    // G: 0-127
        random.nextInt(128)     // B: 0-127
    );
}
```

### 3.3 æ·»åŠ å¹²æ‰°å…ƒç´ 


**ç»˜åˆ¶å¹²æ‰°çº¿**ï¼š
```java
private static void drawNoise(Graphics2D g, int width, int height) {
    Random random = new Random();
    
    // ç»˜åˆ¶å¹²æ‰°çº¿
    for (int i = 0; i < 5; i++) {
        g.setColor(getRandomColor());
        int x1 = random.nextInt(width);
        int y1 = random.nextInt(height);
        int x2 = random.nextInt(width);
        int y2 = random.nextInt(height);
        g.drawLine(x1, y1, x2, y2);
    }
    
    // ç»˜åˆ¶å¹²æ‰°ç‚¹
    for (int i = 0; i < 50; i++) {
        g.setColor(getRandomColor());
        int x = random.nextInt(width);
        int y = random.nextInt(height);
        g.fillOval(x, y, 2, 2);
    }
}
```

---

## 4. ğŸ’¾ Sessionå­˜å‚¨éªŒè¯ç 


### 4.1 ä¸ºä»€ä¹ˆä½¿ç”¨ Session å­˜å‚¨


**å­˜å‚¨æ–¹å¼å¯¹æ¯”**ï¼š

| å­˜å‚¨æ–¹å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|----------|------|------|----------|
| **Session** | `æœåŠ¡å™¨ç«¯å®‰å…¨ï¼Œæ— æ³•ç¯¡æ”¹` | `å ç”¨æœåŠ¡å™¨å†…å­˜` | âœ… **æ¨èä½¿ç”¨** |
| **Cookie** | `ä¸å ç”¨æœåŠ¡å™¨èµ„æº` | `å®¢æˆ·ç«¯å¯è§ï¼Œä¸å®‰å…¨` | âŒ ä¸æ¨è |
| **æ•°æ®åº“** | `æŒä¹…åŒ–å­˜å‚¨` | `æ€§èƒ½å¼€é”€å¤§` | å¤§å‹ç³»ç»Ÿ |
| **Redis** | `é«˜æ€§èƒ½ï¼Œå¯å…±äº«` | `éœ€è¦é¢å¤–ä¸­é—´ä»¶` | åˆ†å¸ƒå¼ç³»ç»Ÿ |

**ğŸ¯ Session å­˜å‚¨çš„ä¼˜åŠ¿**ï¼š
- **å®‰å…¨æ€§é«˜**ï¼šéªŒè¯ç å­˜å‚¨åœ¨æœåŠ¡å™¨ç«¯ï¼Œå®¢æˆ·ç«¯æ— æ³•è·å–
- **è‡ªåŠ¨è¿‡æœŸ**ï¼šSession æœ‰ç”Ÿå‘½å‘¨æœŸï¼ŒéªŒè¯ç è‡ªåŠ¨å¤±æ•ˆ
- **ç®€å•æ˜“ç”¨**ï¼šJavaWeb åŸç”Ÿæ”¯æŒï¼Œæ— éœ€é¢å¤–é…ç½®

### 4.2 Session å­˜å‚¨éªŒè¯ç å®ç°


**åœ¨ Servlet ä¸­å­˜å‚¨éªŒè¯ç **ï¼š
```java
@WebServlet("/captcha")
public class CaptchaServlet extends HttpServlet {
    
    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) 
            throws ServletException, IOException {
        
        // 1. ç”ŸæˆéªŒè¯ç 
        String code = CaptchaGenerator.generateCode(4);
        
        // 2. å­˜å‚¨åˆ°Sessionä¸­
        HttpSession session = req.getSession();
        session.setAttribute("captcha", code);
        
        // 3. ç”ŸæˆéªŒè¯ç å›¾ç‰‡
        BufferedImage image = ImageCaptcha.createCaptchaImage(code);
        
        // 4. è¾“å‡ºå›¾ç‰‡åˆ°æµè§ˆå™¨
        resp.setContentType("image/jpeg");
        ImageIO.write(image, "JPEG", resp.getOutputStream());
    }
}
```

**ğŸ”¸ å…³é”®æ­¥éª¤è§£æ**ï¼š
1. **ç”ŸæˆéªŒè¯ç **ï¼šè°ƒç”¨éšæœºç”Ÿæˆç®—æ³•
2. **å­˜å‚¨åˆ°Session**ï¼šä½¿ç”¨ `session.setAttribute()` ä¿å­˜
3. **ç”Ÿæˆå›¾ç‰‡**ï¼šå°†éªŒè¯ç è½¬æ¢ä¸ºå›¾ç‰‡
4. **å“åº”å›¾ç‰‡**ï¼šè®¾ç½®æ­£ç¡®çš„å“åº”å¤´å¹¶è¾“å‡ºå›¾ç‰‡æµ

### 4.3 Session ä¸­éªŒè¯ç çš„ç”Ÿå‘½å‘¨æœŸ


**éªŒè¯ç çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼š

```
ç”¨æˆ·è¯·æ±‚éªŒè¯ç 
        â†“
   ç”ŸæˆéªŒè¯ç å­—ç¬¦ä¸²
        â†“
   å­˜å‚¨åˆ°Sessionä¸­
        â†“
   ç”Ÿæˆå¯¹åº”å›¾ç‰‡
        â†“
   ç”¨æˆ·è¾“å…¥éªŒè¯ç 
        â†“
   éªŒè¯æˆåŠŸååˆ é™¤
```

**è®¾ç½®éªŒè¯ç è¿‡æœŸæ—¶é—´**ï¼š
```java
// è®¾ç½®Sessionè¶…æ—¶æ—¶é—´ï¼ˆå•ä½ï¼šç§’ï¼‰
session.setMaxInactiveInterval(300); // 5åˆ†é’Ÿåè¿‡æœŸ

// æˆ–è€…åœ¨éªŒè¯æ—¶æ£€æŸ¥æ—¶é—´æˆ³
long timestamp = System.currentTimeMillis();
session.setAttribute("captcha_time", timestamp);
```

---

## 5. âœ… éªŒè¯ç æ ¡éªŒé€»è¾‘


### 5.1 æ ¡éªŒæµç¨‹è®¾è®¡


**å®Œæ•´çš„æ ¡éªŒæµç¨‹**ï¼š

```
ç”¨æˆ·æäº¤è¡¨å•
        â†“
   è·å–ç”¨æˆ·è¾“å…¥çš„éªŒè¯ç 
        â†“
   ä»Sessionä¸­å–å‡ºæ­£ç¡®ç­”æ¡ˆ
        â†“
   æ¯”è¾ƒä¸¤ä¸ªéªŒè¯ç æ˜¯å¦ä¸€è‡´
        â†“
â”Œâ”€â”€â”€ éªŒè¯æˆåŠŸ â”€â”€â”€â”€â”    â”Œâ”€â”€â”€ éªŒè¯å¤±è´¥ â”€â”€â”€â”€â”
â”‚  åˆ é™¤å·²ç”¨éªŒè¯ç    â”‚    â”‚   ä¿ç•™éªŒè¯ç      â”‚
â”‚  ç»§ç»­ä¸šåŠ¡é€»è¾‘    â”‚    â”‚   è¿”å›é”™è¯¯ä¿¡æ¯   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 æ ¡éªŒæ–¹æ³•å®ç°


**åŸºç¡€æ ¡éªŒå®ç°**ï¼š
```java
@WebServlet("/login")
public class LoginServlet extends HttpServlet {
    
    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) 
            throws ServletException, IOException {
        
        // 1. è·å–ç”¨æˆ·è¾“å…¥çš„éªŒè¯ç 
        String userInput = req.getParameter("captcha");
        
        // 2. ä»Sessionä¸­è·å–æ­£ç¡®çš„éªŒè¯ç 
        HttpSession session = req.getSession();
        String correctCode = (String) session.getAttribute("captcha");
        
        // 3. éªŒè¯ç æ ¡éªŒ
        boolean isValid = validateCaptcha(userInput, correctCode, session);
        
        if (isValid) {
            // éªŒè¯é€šè¿‡ï¼Œç»§ç»­ç™»å½•é€»è¾‘
            processLogin(req, resp);
        } else {
            // éªŒè¯å¤±è´¥ï¼Œè¿”å›é”™è¯¯
            req.setAttribute("error", "éªŒè¯ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥");
            req.getRequestDispatcher("/login.jsp").forward(req, resp);
        }
    }
}
```

**è¯¦ç»†çš„æ ¡éªŒæ–¹æ³•**ï¼š
```java
private boolean validateCaptcha(String userInput, String correctCode, HttpSession session) {
    
    // 1. åŸºç¡€éªŒè¯ï¼šæ£€æŸ¥è¾“å…¥æ˜¯å¦ä¸ºç©º
    if (userInput == null || userInput.trim().isEmpty()) {
        return false;
    }
    
    // 2. æ£€æŸ¥Sessionä¸­æ˜¯å¦æœ‰éªŒè¯ç 
    if (correctCode == null) {
        return false;
    }
    
    // 3. å¿½ç•¥å¤§å°å†™æ¯”è¾ƒ
    boolean isMatch = userInput.trim().equalsIgnoreCase(correctCode);
    
    // 4. éªŒè¯æˆåŠŸåç«‹å³åˆ é™¤éªŒè¯ç ï¼ˆé˜²æ­¢é‡å¤ä½¿ç”¨ï¼‰
    if (isMatch) {
        session.removeAttribute("captcha");
    }
    
    return isMatch;
}
```

### 5.3 æ ¡éªŒè¿‡ç¨‹ä¸­çš„æ³¨æ„äº‹é¡¹


**ğŸ”¸ é‡è¦çš„æ ¡éªŒåŸåˆ™**ï¼š

- [x] **å¿½ç•¥å¤§å°å†™**ï¼šç”¨æˆ·è¾“å…¥ `abcd` å’Œ `ABCD` åº”è¯¥éƒ½ç®—æ­£ç¡®
- [x] **å»é™¤ç©ºæ ¼**ï¼šé˜²æ­¢ç”¨æˆ·æ— æ„ä¸­è¾“å…¥ç©ºæ ¼å¯¼è‡´éªŒè¯å¤±è´¥
- [x] **ä¸€æ¬¡æ€§ä½¿ç”¨**ï¼šéªŒè¯æˆåŠŸåç«‹å³åˆ é™¤ï¼Œé˜²æ­¢é‡å¤ä½¿ç”¨
- [x] **ç©ºå€¼æ£€æŸ¥**ï¼šé˜²æ­¢ç©ºæŒ‡é’ˆå¼‚å¸¸

**å¸¸è§çš„æ ¡éªŒé”™è¯¯å¤„ç†**ï¼š
```java
public class CaptchaValidator {
    
    public static ValidationResult validate(String userInput, HttpSession session) {
        String correctCode = (String) session.getAttribute("captcha");
        
        // é”™è¯¯æƒ…å†µ1ï¼šéªŒè¯ç å·²è¿‡æœŸæˆ–ä¸å­˜åœ¨
        if (correctCode == null) {
            return new ValidationResult(false, "éªŒè¯ç å·²è¿‡æœŸï¼Œè¯·åˆ·æ–°åé‡è¯•");
        }
        
        // é”™è¯¯æƒ…å†µ2ï¼šç”¨æˆ·æœªè¾“å…¥éªŒè¯ç 
        if (userInput == null || userInput.trim().isEmpty()) {
            return new ValidationResult(false, "è¯·è¾“å…¥éªŒè¯ç ");
        }
        
        // é”™è¯¯æƒ…å†µ3ï¼šéªŒè¯ç ä¸åŒ¹é…
        if (!userInput.trim().equalsIgnoreCase(correctCode)) {
            return new ValidationResult(false, "éªŒè¯ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥");
        }
        
        // éªŒè¯æˆåŠŸ
        session.removeAttribute("captcha");
        return new ValidationResult(true, "éªŒè¯æˆåŠŸ");
    }
    
    // éªŒè¯ç»“æœå°è£…ç±»
    static class ValidationResult {
        private boolean success;
        private String message;
        
        // æ„é€ å‡½æ•°å’Œgetteræ–¹æ³•...
    }
}
```

---

## 6. ğŸ”„ é˜²åˆ·æ–°æœºåˆ¶


### 6.1 ä»€ä¹ˆæ˜¯é˜²åˆ·æ–°æœºåˆ¶


**åˆ·æ–°æ”»å‡»çš„åœºæ™¯**ï¼š
```
æ¶æ„ç”¨æˆ·çš„è¡Œä¸ºï¼š
1. è®¿é—®ç™»å½•é¡µé¢ï¼Œè·å–éªŒè¯ç å›¾ç‰‡
2. ä½¿ç”¨ç¨‹åºè¯†åˆ«éªŒè¯ç å†…å®¹
3. ä¸æ–­åˆ·æ–°é¡µé¢ï¼Œè·å–æ–°çš„éªŒè¯ç 
4. æ‰¹é‡å°è¯•ç™»å½•ï¼Œç»•è¿‡éªŒè¯ç ä¿æŠ¤
```

**é˜²åˆ·æ–°æœºåˆ¶çš„ç›®çš„**ï¼š
- ğŸ›¡ï¸ **é™åˆ¶é¢‘ç‡**ï¼šé˜²æ­¢ç”¨æˆ·é¢‘ç¹åˆ·æ–°éªŒè¯ç 
- ğŸ›¡ï¸ **å¢åŠ æˆæœ¬**ï¼šè®©è‡ªåŠ¨åŒ–æ”»å‡»å˜å¾—å›°éš¾
- ğŸ›¡ï¸ **ä¿æŠ¤èµ„æº**ï¼šå‡å°‘æœåŠ¡å™¨èµ„æºæ¶ˆè€—

### 6.2 æ—¶é—´é—´éš”é™åˆ¶


**åŸºäºæ—¶é—´æˆ³çš„é˜²åˆ·æ–°**ï¼š
```java
@WebServlet("/captcha")
public class CaptchaServlet extends HttpServlet {
    
    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) 
            throws ServletException, IOException {
        
        HttpSession session = req.getSession();
        
        // 1. æ£€æŸ¥ä¸Šæ¬¡ç”ŸæˆéªŒè¯ç çš„æ—¶é—´
        Long lastTime = (Long) session.getAttribute("last_captcha_time");
        long currentTime = System.currentTimeMillis();
        
        // 2. è®¾ç½®æœ€å°é—´éš”æ—¶é—´ï¼ˆ3ç§’ï¼‰
        long minInterval = 3000;
        
        if (lastTime != null && (currentTime - lastTime) < minInterval) {
            // åˆ·æ–°å¤ªé¢‘ç¹ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯
            resp.setContentType("text/plain; charset=utf-8");
            resp.getWriter().write("è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•");
            return;
        }
        
        // 3. æ›´æ–°æ—¶é—´æˆ³
        session.setAttribute("last_captcha_time", currentTime);
        
        // 4. æ­£å¸¸ç”ŸæˆéªŒè¯ç 
        generateAndResponseCaptcha(req, resp);
    }
}
```

### 6.3 IP åœ°å€é™åˆ¶


**åŸºäº IP çš„è¯·æ±‚é¢‘ç‡æ§åˆ¶**ï¼š
```java
public class IPRateLimiter {
    // ä½¿ç”¨å†…å­˜å­˜å‚¨IPè®¿é—®è®°å½•
    private static final Map<String, List<Long>> ipRequestTimes = new HashMap<>();
    private static final long TIME_WINDOW = 60000; // 1åˆ†é’Ÿæ—¶é—´çª—å£
    private static final int MAX_REQUESTS = 10;     // æœ€å¤š10æ¬¡è¯·æ±‚
    
    public static boolean isAllowed(String clientIP) {
        long currentTime = System.currentTimeMillis();
        
        // è·å–è¯¥IPçš„è®¿é—®è®°å½•
        List<Long> requestTimes = ipRequestTimes.computeIfAbsent(clientIP, k -> new ArrayList<>());
        
        // æ¸…ç†è¿‡æœŸçš„è®¿é—®è®°å½•
        requestTimes.removeIf(time -> currentTime - time > TIME_WINDOW);
        
        // æ£€æŸ¥æ˜¯å¦è¶…è¿‡é™åˆ¶
        if (requestTimes.size() >= MAX_REQUESTS) {
            return false; // è¶…è¿‡é™åˆ¶
        }
        
        // è®°å½•æœ¬æ¬¡è®¿é—®
        requestTimes.add(currentTime);
        return true; // å…è®¸è®¿é—®
    }
}
```

**åœ¨ Servlet ä¸­åº”ç”¨ IP é™åˆ¶**ï¼š
```java
@Override
protected void doGet(HttpServletRequest req, HttpServletResponse resp) 
        throws ServletException, IOException {
    
    // è·å–å®¢æˆ·ç«¯IP
    String clientIP = getClientIP(req);
    
    // æ£€æŸ¥IPè®¿é—®é¢‘ç‡
    if (!IPRateLimiter.isAllowed(clientIP)) {
        resp.setStatus(429); // Too Many Requests
        resp.getWriter().write("è®¿é—®è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•");
        return;
    }
    
    // æ­£å¸¸å¤„ç†éªŒè¯ç ç”Ÿæˆ
    // ...
}

private String getClientIP(HttpServletRequest request) {
    String ip = request.getHeader("X-Forwarded-For");
    if (ip == null || ip.isEmpty()) {
        ip = request.getRemoteAddr();
    }
    return ip;
}
```

### 6.4 éªŒè¯ç å¤æ‚åº¦åŠ¨æ€è°ƒæ•´


**æ ¹æ®å¤±è´¥æ¬¡æ•°è°ƒæ•´éš¾åº¦**ï¼š
```java
public class AdaptiveCaptcha {
    
    public static String generateCodeByDifficulty(HttpSession session) {
        // è·å–å¤±è´¥æ¬¡æ•°
        Integer failCount = (Integer) session.getAttribute("captcha_fail_count");
        if (failCount == null) failCount = 0;
        
        // æ ¹æ®å¤±è´¥æ¬¡æ•°è°ƒæ•´éªŒè¯ç å¤æ‚åº¦
        if (failCount < 2) {
            // ç®€å•æ¨¡å¼ï¼š4ä½æ•°å­—
            return generateNumericCode(4);
        } else if (failCount < 5) {
            // ä¸­ç­‰æ¨¡å¼ï¼š4ä½æ•°å­—+å­—æ¯
            return generateMixedCode(4);
        } else {
            // å›°éš¾æ¨¡å¼ï¼š6ä½æ•°å­—+å­—æ¯ï¼ŒåŠ æ›´å¤šå¹²æ‰°
            return generateComplexCode(6);
        }
    }
    
    public static void recordFailure(HttpSession session) {
        Integer failCount = (Integer) session.getAttribute("captcha_fail_count");
        failCount = (failCount == null) ? 1 : failCount + 1;
        session.setAttribute("captcha_fail_count", failCount);
    }
    
    public static void resetFailCount(HttpSession session) {
        session.removeAttribute("captcha_fail_count");
    }
}
```

---

## 7. ğŸš€ å®Œæ•´å®æˆ˜æ¡ˆä¾‹


### 7.1 é¡¹ç›®ç»“æ„


```
CaptchaDemo/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ servlet/
â”‚   â”‚   â”œâ”€â”€ CaptchaServlet.java      â† éªŒè¯ç ç”Ÿæˆ
â”‚   â”‚   â””â”€â”€ LoginServlet.java        â† ç™»å½•éªŒè¯  
â”‚   â”œâ”€â”€ util/
â”‚   â”‚   â”œâ”€â”€ CaptchaGenerator.java    â† éªŒè¯ç ç”Ÿæˆå·¥å…·
â”‚   â”‚   â””â”€â”€ ImageCaptcha.java        â† å›¾ç‰‡ç”Ÿæˆå·¥å…·
â”‚   â””â”€â”€ filter/
â”‚       â””â”€â”€ RateLimitFilter.java     â† é˜²åˆ·æ–°è¿‡æ»¤å™¨
â”œâ”€â”€ webapp/
â”‚   â”œâ”€â”€ login.jsp                    â† ç™»å½•é¡µé¢
â”‚   â”œâ”€â”€ success.jsp                  â† æˆåŠŸé¡µé¢
â”‚   â””â”€â”€ WEB-INF/web.xml             â† é…ç½®æ–‡ä»¶
```

### 7.2 å®Œæ•´çš„ç™»å½•é¡µé¢


**login.jsp - å‰ç«¯é¡µé¢**ï¼š
```html
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<!DOCTYPE html>
<html>
<head>
    <title>ç™»å½•é¡µé¢</title>
    <style>
        .login-form { width: 300px; margin: 100px auto; padding: 20px; border: 1px solid #ddd; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; }
        .form-group input { width: 100%; padding: 8px; border: 1px solid #ccc; }
        .captcha-container { display: flex; align-items: center; }
        .captcha-input { flex: 1; margin-right: 10px; }
        .captcha-img { cursor: pointer; }
        .error { color: red; margin-top: 10px; }
        .btn { background: #007cba; color: white; padding: 10px 20px; border: none; cursor: pointer; }
    </style>
</head>
<body>
    <div class="login-form">
        <h2>ç”¨æˆ·ç™»å½•</h2>
        
        <form action="login" method="post">
            <div class="form-group">
                <label>ç”¨æˆ·åï¼š</label>
                <input type="text" name="username" required>
            </div>
            
            <div class="form-group">
                <label>å¯†ç ï¼š</label>
                <input type="password" name="password" required>
            </div>
            
            <div class="form-group">
                <label>éªŒè¯ç ï¼š</label>
                <div class="captcha-container">
                    <input type="text" name="captcha" class="captcha-input" 
                           placeholder="è¯·è¾“å…¥éªŒè¯ç " required maxlength="4">
                    <img src="captcha" class="captcha-img" alt="éªŒè¯ç " 
                         title="ç‚¹å‡»åˆ·æ–°" onclick="refreshCaptcha()">
                </div>
            </div>
            
            <button type="submit" class="btn">ç™»å½•</button>
            
            <!-- é”™è¯¯ä¿¡æ¯æ˜¾ç¤º -->
            <% if (request.getAttribute("error") != null) { %>
                <div class="error">${error}</div>
            <% } %>
        </form>
    </div>

    <script>
        // åˆ·æ–°éªŒè¯ç çš„JavaScriptå‡½æ•°
        function refreshCaptcha() {
            var img = document.querySelector('.captcha-img');
            img.src = 'captcha?' + new Date().getTime(); // æ·»åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨èšç„¦åˆ°ç”¨æˆ·åè¾“å…¥æ¡†
        window.onload = function() {
            document.querySelector('input[name="username"]').focus();
        };
    </script>
</body>
</html>
```

### 7.3 å®Œæ•´çš„åç«¯å®ç°


**CaptchaServlet.java - éªŒè¯ç ç”Ÿæˆ**ï¼š
```java
package servlet;

import util.CaptchaGenerator;
import util.ImageCaptcha;

import javax.imageio.ImageIO;
import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import java.awt.image.BufferedImage;
import java.io.IOException;

@WebServlet("/captcha")
public class CaptchaServlet extends HttpServlet {
    
    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) 
            throws ServletException, IOException {
        
        // é˜²åˆ·æ–°æ£€æŸ¥
        if (!checkRefreshRate(req)) {
            resp.setStatus(429);
            return;
        }
        
        // ç”Ÿæˆ4ä½éªŒè¯ç 
        String code = CaptchaGenerator.generateCode(4);
        
        // å­˜å‚¨åˆ°Session
        HttpSession session = req.getSession();
        session.setAttribute("captcha", code);
        session.setAttribute("captcha_time", System.currentTimeMillis());
        
        // ç”Ÿæˆå›¾ç‰‡å¹¶è¾“å‡º
        BufferedImage image = ImageCaptcha.createCaptchaImage(code);
        
        resp.setContentType("image/jpeg");
        resp.setHeader("Cache-Control", "no-cache, no-store, must-revalidate");
        resp.setHeader("Pragma", "no-cache");
        resp.setDateHeader("Expires", 0);
        
        ImageIO.write(image, "JPEG", resp.getOutputStream());
    }
    
    private boolean checkRefreshRate(HttpServletRequest req) {
        HttpSession session = req.getSession();
        Long lastTime = (Long) session.getAttribute("last_captcha_request");
        long currentTime = System.currentTimeMillis();
        
        if (lastTime != null && (currentTime - lastTime) < 2000) {
            return false; // 2ç§’å†…ä¸å…è®¸é‡å¤è¯·æ±‚
        }
        
        session.setAttribute("last_captcha_request", currentTime);
        return true;
    }
}
```

**LoginServlet.java - ç™»å½•å¤„ç†**ï¼š
```java
package servlet;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import java.io.IOException;

@WebServlet("/login")
public class LoginServlet extends HttpServlet {
    
    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) 
            throws ServletException, IOException {
        
        req.setCharacterEncoding("UTF-8");
        
        // è·å–è¡¨å•å‚æ•°
        String username = req.getParameter("username");
        String password = req.getParameter("password");
        String captcha = req.getParameter("captcha");
        
        HttpSession session = req.getSession();
        
        // 1. éªŒè¯ç æ ¡éªŒ
        if (!validateCaptcha(captcha, session)) {
            req.setAttribute("error", "éªŒè¯ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥");
            req.getRequestDispatcher("/login.jsp").forward(req, resp);
            return;
        }
        
        // 2. ç”¨æˆ·åå¯†ç æ ¡éªŒï¼ˆè¿™é‡Œç®€åŒ–å¤„ç†ï¼‰
        if ("admin".equals(username) && "123456".equals(password)) {
            // ç™»å½•æˆåŠŸ
            session.setAttribute("user", username);
            resp.sendRedirect("success.jsp");
        } else {
            // ç™»å½•å¤±è´¥
            req.setAttribute("error", "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
            req.getRequestDispatcher("/login.jsp").forward(req, resp);
        }
    }
    
    private boolean validateCaptcha(String userInput, HttpSession session) {
        String correctCode = (String) session.getAttribute("captcha");
        
        if (correctCode == null || userInput == null) {
            return false;
        }
        
        boolean isValid = userInput.trim().equalsIgnoreCase(correctCode);
        
        if (isValid) {
            session.removeAttribute("captcha"); // éªŒè¯æˆåŠŸååˆ é™¤
        }
        
        return isValid;
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ éªŒè¯ç æœ¬è´¨ï¼šäººæœºè¯†åˆ«æµ‹è¯•ï¼Œé˜²æ­¢è‡ªåŠ¨åŒ–æ”»å‡»
ğŸ”¸ ç”Ÿæˆç®—æ³•ï¼šéšæœºå­—ç¬¦é€‰æ‹©ï¼Œä½¿ç”¨SecureRandomå¢å¼ºå®‰å…¨æ€§  
ğŸ”¸ å›¾å½¢å®ç°ï¼šJava2Dç»˜åˆ¶ï¼ŒåŒ…å«æ–‡å­—ã€èƒŒæ™¯ã€å¹²æ‰°å…ƒç´ 
ğŸ”¸ Sessionå­˜å‚¨ï¼šæœåŠ¡å™¨ç«¯ä¿å­˜ï¼Œå®¢æˆ·ç«¯æ— æ³•è·å–å’Œç¯¡æ”¹
ğŸ”¸ æ ¡éªŒé€»è¾‘ï¼šå¿½ç•¥å¤§å°å†™ï¼Œä¸€æ¬¡æ€§ä½¿ç”¨ï¼Œå®Œå–„çš„é”™è¯¯å¤„ç†
ğŸ”¸ é˜²åˆ·æ–°æœºåˆ¶ï¼šæ—¶é—´é—´éš”ã€IPé™åˆ¶ã€éš¾åº¦è‡ªé€‚åº”è°ƒæ•´
```

### 8.2 å…³é”®å®ç°è¦ç‚¹


**ğŸ”¹ éªŒè¯ç ç”Ÿæˆçš„æœ€ä½³å®è·µ**ï¼š
```
å­—ç¬¦é›†é€‰æ‹©ï¼šå»é™¤æ˜“æ··æ·†å­—ç¬¦(0Oã€1lI)
é•¿åº¦è®¾è®¡ï¼š4-6ä½å¹³è¡¡å®‰å…¨æ€§å’Œç”¨æˆ·ä½“éªŒ
éšæœºæ€§ï¼šä½¿ç”¨SecureRandomè€Œä¸æ˜¯Random
å›¾ç‰‡è´¨é‡ï¼šé€‚å½“çš„å¹²æ‰°å…ƒç´ ï¼Œä¸å½±å“å¯è¯»æ€§
```

**ğŸ”¹ Sessionç®¡ç†çš„æ³¨æ„äº‹é¡¹**ï¼š
```
ç”Ÿå‘½å‘¨æœŸï¼šè®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´
å­˜å‚¨å†…å®¹ï¼šåªå­˜éªŒè¯ç æ–‡æœ¬ï¼Œä¸å­˜å›¾ç‰‡æ•°æ®
æ¸…ç†æœºåˆ¶ï¼šéªŒè¯æˆåŠŸåç«‹å³åˆ é™¤
å¹¶å‘å¤„ç†ï¼šè€ƒè™‘å¤šæ ‡ç­¾é¡µåŒæ—¶ä½¿ç”¨çš„æƒ…å†µ
```

**ğŸ”¹ å®‰å…¨é˜²æŠ¤çš„è¦ç‚¹**ï¼š
```
é˜²åˆ·æ–°ï¼šæ—¶é—´é—´éš”é™åˆ¶+IPé¢‘ç‡æ§åˆ¶
é˜²è¯†åˆ«ï¼šé€‚å½“çš„å›¾ç‰‡å¹²æ‰°+å­—ç¬¦å˜å½¢
é˜²é‡æ”¾ï¼šä¸€æ¬¡æ€§ä½¿ç”¨+æ—¶æ•ˆæ€§æ£€æŸ¥
é˜²æš´åŠ›ï¼šå¤±è´¥æ¬¡æ•°ç´¯è®¡+éš¾åº¦åŠ¨æ€è°ƒæ•´
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… **ç”¨æˆ·æ³¨å†Œ**ï¼šé˜²æ­¢æ‰¹é‡æ³¨å†Œåƒåœ¾è´¦å·
- âœ… **ç”¨æˆ·ç™»å½•**ï¼šé˜²æ­¢æš´åŠ›ç ´è§£å¯†ç   
- âœ… **è¡¨å•æäº¤**ï¼šé˜²æ­¢æ¶æ„æ‰¹é‡æäº¤
- âœ… **æ•æ„Ÿæ“ä½œ**ï¼šæ‰¾å›å¯†ç ã€ä¿®æ”¹èµ„æ–™ç­‰

**æŠ€æœ¯é€‰å‹å»ºè®®**ï¼š
- ğŸ¯ **å°å‹é¡¹ç›®**ï¼šSession + ç®€å•å›¾å½¢éªŒè¯ç 
- ğŸ¯ **ä¸­å‹é¡¹ç›®**ï¼šRedis + å¤æ‚éªŒè¯ç  + IPé™åˆ¶  
- ğŸ¯ **å¤§å‹é¡¹ç›®**ï¼šç¬¬ä¸‰æ–¹éªŒè¯ç æœåŠ¡ï¼ˆå¦‚è…¾è®¯ã€é˜¿é‡Œï¼‰

**ç”¨æˆ·ä½“éªŒä¼˜åŒ–**ï¼š
- ğŸ”§ **ç‚¹å‡»åˆ·æ–°**ï¼šå›¾ç‰‡å¯ç‚¹å‡»æ›´æ¢
- ğŸ”§ **æ— éšœç¢è®¿é—®**ï¼šæä¾›è¯­éŸ³éªŒè¯ç é€‰é¡¹
- ğŸ”§ **ç§»åŠ¨é€‚é…**ï¼šå“åº”å¼è®¾è®¡ï¼Œé€‚åˆæ‰‹æœºæ“ä½œ
- ğŸ”§ **é”™è¯¯æç¤º**ï¼šæ˜ç¡®çš„å¤±è´¥åŸå› è¯´æ˜

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- éªŒè¯ç  = éšæœºç”Ÿæˆ + Sessionå­˜å‚¨ + å›¾å½¢å±•ç¤º + ä¸€æ¬¡éªŒè¯
- å®‰å…¨æ€§ = é˜²åˆ·æ–° + é˜²è¯†åˆ« + é˜²é‡æ”¾ + é˜²æš´åŠ›
- ç”¨æˆ·ä½“éªŒ = æ¸…æ™°æ˜“è¯» + ç‚¹å‡»åˆ·æ–° + å‹å¥½æç¤º + åˆç†éš¾åº¦