---
title: 1ã€Sessionç›‘å¬å™¨è¯¦è§£
---
## ğŸ“š ç›®å½•

1. [Sessionç›‘å¬å™¨æ˜¯ä»€ä¹ˆ](#1-Sessionç›‘å¬å™¨æ˜¯ä»€ä¹ˆ)
2. [HttpSessionListeneræ¥å£è¯¦è§£](#2-HttpSessionListeneræ¥å£è¯¦è§£)
3. [HttpSessionAttributeListenerè¯¦è§£](#3-HttpSessionAttributeListenerè¯¦è§£)
4. [Sessionäº‹ä»¶ç›‘å¬æœºåˆ¶](#4-Sessionäº‹ä»¶ç›‘å¬æœºåˆ¶)
5. [ç›‘å¬å™¨æ³¨å†Œé…ç½®æ–¹å¼](#5-ç›‘å¬å™¨æ³¨å†Œé…ç½®æ–¹å¼)
6. [å®é™…åº”ç”¨åœºæ™¯](#6-å®é™…åº”ç”¨åœºæ™¯)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” Sessionç›‘å¬å™¨æ˜¯ä»€ä¹ˆ


### 1.1 ç›‘å¬å™¨çš„åŸºæœ¬æ¦‚å¿µ

ğŸ¯ **ç®€å•ç†è§£**ï¼šSessionç›‘å¬å™¨å°±åƒæ˜¯Sessionçš„"è´´èº«ä¿é•–"

```
ç”Ÿæ´»ä¸­çš„ç±»æ¯”ï¼š
ä¿é•–çš„å·¥ä½œ â†’ ç›‘å¬å™¨çš„å·¥ä½œ
å®ˆæŠ¤ä¸»äºº â†’ ç›‘å¬Session
ä¸»äººç¦»å¼€æ—¶é€šçŸ¥å®¶äºº â†’ Sessioné”€æ¯æ—¶æ‰§è¡Œæ¸…ç†
ä¸»äººæ‹¿ä¸œè¥¿æ—¶è®°å½• â†’ Sessionå­˜å–æ•°æ®æ—¶è®°å½•
ä¸»äººæ¢è¡£æœæ—¶å¸®å¿™ â†’ Sessionå±æ€§å˜åŒ–æ—¶å¤„ç†
```

**ğŸ”¸ ç›‘å¬å™¨çš„æ ¸å¿ƒä½œç”¨**
```
å®æ—¶ç›‘æ§ï¼š
- ç›‘å¬Sessionçš„åˆ›å»ºå’Œé”€æ¯
- ç›‘å¬Sessionä¸­æ•°æ®çš„å˜åŒ–
- åœ¨å…³é”®æ—¶åˆ»è‡ªåŠ¨æ‰§è¡Œç‰¹å®šæ“ä½œ

è‡ªåŠ¨åŒ–ç®¡ç†ï¼š
- æ— éœ€æ‰‹åŠ¨è°ƒç”¨ï¼Œç³»ç»Ÿè‡ªåŠ¨è§¦å‘
- åœ¨åå°é™é»˜å·¥ä½œ
- æä¾›ç»Ÿä¸€çš„äº‹ä»¶å¤„ç†æœºåˆ¶
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦Sessionç›‘å¬å™¨

**ğŸ’¡ å®é™…éœ€æ±‚åœºæ™¯**

```
åœ¨çº¿ç”¨æˆ·ç»Ÿè®¡éœ€æ±‚ï¼š
é—®é¢˜ï¼šå¦‚ä½•çŸ¥é“ç½‘ç«™å½“å‰æœ‰å¤šå°‘ç”¨æˆ·åœ¨çº¿ï¼Ÿ
ä¼ ç»Ÿæ–¹å¼ï¼šæ¯æ¬¡ç™»å½•æ—¶è®¡æ•°å™¨+1ï¼Œæ‰‹åŠ¨é€€å‡ºæ—¶-1
é—®é¢˜ï¼šç”¨æˆ·ç›´æ¥å…³é—­æµè§ˆå™¨æ—¶æ— æ³•æ„ŸçŸ¥

ç›‘å¬å™¨è§£å†³æ–¹æ¡ˆï¼š
- Sessionåˆ›å»ºæ—¶ï¼šåœ¨çº¿äººæ•°+1
- Sessioné”€æ¯æ—¶ï¼šåœ¨çº¿äººæ•°-1
- æ— è®ºç”¨æˆ·å¦‚ä½•ç¦»å¼€éƒ½èƒ½å‡†ç¡®ç»Ÿè®¡

èµ„æºæ¸…ç†éœ€æ±‚ï¼š
ç”¨æˆ·ç™»å½•åå¯èƒ½ä¼šï¼š
- ä¸Šä¼ ä¸´æ—¶æ–‡ä»¶
- å ç”¨ç³»ç»Ÿèµ„æº
- å»ºç«‹æ•°æ®åº“è¿æ¥

Sessioné”€æ¯æ—¶éœ€è¦ï¼š
- åˆ é™¤ä¸´æ—¶æ–‡ä»¶
- é‡Šæ”¾ç³»ç»Ÿèµ„æº
- å…³é—­æ•°æ®åº“è¿æ¥
```

### 1.3 Sessionç›‘å¬å™¨çš„åˆ†ç±»

**ğŸ“Š ä¸¤å¤§ç›‘å¬å™¨ç±»å‹**

| ç›‘å¬å™¨ç±»å‹ | **ç›‘å¬å†…å®¹** | **ä¸»è¦æ–¹æ³•** | **ä½¿ç”¨åœºæ™¯** |
|-----------|-------------|-------------|-------------|
| ğŸ”¸ **HttpSessionListener** | `Sessionçš„ç”Ÿå‘½å‘¨æœŸ` | `sessionCreated` <br> `sessionDestroyed` | `åœ¨çº¿ç”¨æˆ·ç»Ÿè®¡` <br> `èµ„æºæ¸…ç†` |
| ğŸ”¸ **HttpSessionAttributeListener** | `Sessionä¸­çš„å±æ€§å˜åŒ–` | `attributeAdded` <br> `attributeRemoved` <br> `attributeReplaced` | `æ•°æ®å˜åŒ–ç›‘æ§` <br> `æ“ä½œæ—¥å¿—è®°å½•` |

**ğŸ¯ é€‰æ‹©ç›‘å¬å™¨çš„åŸåˆ™**
```
å…³å¿ƒSessionåˆ›å»ºé”€æ¯ â†’ ä½¿ç”¨HttpSessionListener
å…³å¿ƒSessionæ•°æ®å˜åŒ– â†’ ä½¿ç”¨HttpSessionAttributeListener
ä¸¤è€…éƒ½å…³å¿ƒ â†’ åŒæ—¶å®ç°ä¸¤ä¸ªæ¥å£
```

---

## 2. ğŸ‘¤ HttpSessionListeneræ¥å£è¯¦è§£


### 2.1 HttpSessionListeneræ¥å£ä»‹ç»

**ğŸ”¸ æ¥å£åŸºæœ¬ç»“æ„**

è¿™ä¸ªæ¥å£éå¸¸ç®€å•ï¼Œå°±åƒä¸€ä¸ªç®€å•çš„å¼€å…³ï¼Œåªæœ‰ä¸¤ä¸ªæ–¹æ³•ï¼š

```java
public interface HttpSessionListener {
    // Sessionåˆ›å»ºæ—¶è°ƒç”¨
    void sessionCreated(HttpSessionEvent event);
    
    // Sessioné”€æ¯æ—¶è°ƒç”¨  
    void sessionDestroyed(HttpSessionEvent event);
}
```

**ğŸ’¡ ç†è§£ä¸¤ä¸ªæ–¹æ³•çš„è§¦å‘æ—¶æœº**
```
sessionCreatedè§¦å‘æ—¶æœºï¼š
- ç”¨æˆ·ç¬¬ä¸€æ¬¡è®¿é—®ç½‘ç«™æ—¶
- è°ƒç”¨request.getSession()åˆ›å»ºæ–°Sessionæ—¶
- Session IDè¿˜ä¸å­˜åœ¨æ—¶

sessionDestroyedè§¦å‘æ—¶æœºï¼š
- Sessionè¿‡æœŸæ—¶ï¼ˆè¶…æ—¶ï¼‰
- æ‰‹åŠ¨è°ƒç”¨session.invalidate()æ—¶
- æœåŠ¡å™¨å…³é—­æ—¶ï¼ˆæ¸…ç†æ‰€æœ‰Sessionï¼‰
- ç”¨æˆ·å…³é—­æµè§ˆå™¨åè¿‡æœŸæ—¶é—´åˆ°è¾¾æ—¶
```

### 2.2 å®ç°åœ¨çº¿ç”¨æˆ·ç»Ÿè®¡

**ğŸ“Š æœ€ç»å…¸çš„åº”ç”¨æ¡ˆä¾‹**

è®©æˆ‘ä»¬ç”¨ç”Ÿæ´»åŒ–çš„æ–¹å¼ç†è§£åœ¨çº¿ç”¨æˆ·ç»Ÿè®¡ï¼š

```java
@WebListener  // æ³¨è§£æ–¹å¼æ³¨å†Œç›‘å¬å™¨
public class OnlineUserCounter implements HttpSessionListener {
    
    // ç”¨æ¥è®°å½•åœ¨çº¿äººæ•°çš„è®¡æ•°å™¨ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰
    private static AtomicInteger onlineCount = new AtomicInteger(0);
    
    /**
     * æœ‰æ–°ç”¨æˆ·æ¥äº†ï¼
     * å°±åƒå•†åº—é‡Œæ¥äº†æ–°é¡¾å®¢ï¼Œé—¨å£è®¡æ•°å™¨+1
     */
    @Override
    public void sessionCreated(HttpSessionEvent event) {
        // è·å–æ–°åˆ›å»ºçš„Session
        HttpSession session = event.getSession();
        
        // åœ¨çº¿äººæ•°+1
        int currentCount = onlineCount.incrementAndGet();
        
        // è®°å½•æ—¥å¿—ï¼ˆå¯é€‰ï¼‰
        System.out.println("æ–°ç”¨æˆ·ä¸Šçº¿ï¼Session ID: " + session.getId());
        System.out.println("å½“å‰åœ¨çº¿äººæ•°: " + currentCount);
        
        // å¯ä»¥å°†åœ¨çº¿äººæ•°å­˜å‚¨åˆ°åº”ç”¨èŒƒå›´ï¼Œä¾›å…¶ä»–åœ°æ–¹ä½¿ç”¨
        ServletContext application = session.getServletContext();
        application.setAttribute("onlineUserCount", currentCount);
    }
    
    /**
     * æœ‰ç”¨æˆ·ç¦»å¼€äº†ï¼
     * å°±åƒé¡¾å®¢ç¦»å¼€å•†åº—ï¼Œé—¨å£è®¡æ•°å™¨-1
     */
    @Override
    public void sessionDestroyed(HttpSessionEvent event) {
        // åœ¨çº¿äººæ•°-1
        int currentCount = onlineCount.decrementAndGet();
        
        // è®°å½•æ—¥å¿—
        System.out.println("ç”¨æˆ·ä¸‹çº¿ï¼");
        System.out.println("å½“å‰åœ¨çº¿äººæ•°: " + currentCount);
        
        // æ›´æ–°åº”ç”¨èŒƒå›´çš„åœ¨çº¿äººæ•°
        HttpSession session = event.getSession();
        ServletContext application = session.getServletContext();
        application.setAttribute("onlineUserCount", currentCount);
    }
    
    // æä¾›è·å–åœ¨çº¿äººæ•°çš„é™æ€æ–¹æ³•
    public static int getOnlineUserCount() {
        return onlineCount.get();
    }
}
```

**ğŸ¯ åœ¨JSPé¡µé¢ä¸­æ˜¾ç¤ºåœ¨çº¿äººæ•°**

```html
<!-- åœ¨ç½‘é¡µä¸Šæ˜¾ç¤ºåœ¨çº¿äººæ•° -->
<div class="online-users">
    <span class="icon">ğŸ‘¥</span>
    å½“å‰åœ¨çº¿ç”¨æˆ·ï¼š
    <span class="count">${applicationScope.onlineUserCount}</span> äºº
</div>
```

### 2.3 å®ç°èµ„æºæ¸…ç†ç®¡ç†

**ğŸ§¹ Sessioné”€æ¯æ—¶çš„æ¸…ç†å·¥ä½œ**

```java
@WebListener
public class ResourceCleanupListener implements HttpSessionListener {
    
    @Override
    public void sessionCreated(HttpSessionEvent event) {
        HttpSession session = event.getSession();
        System.out.println("ä¸ºç”¨æˆ·å‡†å¤‡èµ„æºï¼ŒSession: " + session.getId());
    }
    
    @Override
    public void sessionDestroyed(HttpSessionEvent event) {
        HttpSession session = event.getSession();
        
        // 1. æ¸…ç†ç”¨æˆ·ä¸Šä¼ çš„ä¸´æ—¶æ–‡ä»¶
        cleanupTempFiles(session);
        
        // 2. é‡Šæ”¾ç”¨æˆ·å ç”¨çš„ç¼“å­˜
        clearUserCache(session);
        
        // 3. è®°å½•ç”¨æˆ·ç¦»çº¿æ—¥å¿—
        logUserOffline(session);
        
        System.out.println("ç”¨æˆ·èµ„æºæ¸…ç†å®Œæˆï¼ŒSession: " + session.getId());
    }
    
    /**
     * æ¸…ç†ä¸´æ—¶æ–‡ä»¶
     * æ¯”å¦‚ç”¨æˆ·ä¸Šä¼ çš„å¤´åƒé¢„è§ˆå›¾ã€ä¸´æ—¶æ–‡æ¡£ç­‰
     */
    private void cleanupTempFiles(HttpSession session) {
        // å‡è®¾ä¸´æ—¶æ–‡ä»¶å­˜æ”¾è·¯å¾„åŒ…å«Session ID
        String tempDir = "/tmp/user_" + session.getId();
        File dir = new File(tempDir);
        
        if (dir.exists()) {
            // åˆ é™¤æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶
            File[] files = dir.listFiles();
            if (files != null) {
                for (File file : files) {
                    file.delete();
                }
            }
            dir.delete();
            System.out.println("æ¸…ç†ä¸´æ—¶æ–‡ä»¶å®Œæˆï¼š" + tempDir);
        }
    }
    
    /**
     * æ¸…ç†ç”¨æˆ·ç¼“å­˜
     */
    private void clearUserCache(HttpSession session) {
        // ä»Sessionä¸­è·å–ç”¨æˆ·ä¿¡æ¯
        Object userInfo = session.getAttribute("userInfo");
        if (userInfo != null) {
            // æ¸…ç†ä¸è¯¥ç”¨æˆ·ç›¸å…³çš„ç¼“å­˜
            // CacheManager.clearUserCache(userId);
            System.out.println("ç”¨æˆ·ç¼“å­˜æ¸…ç†å®Œæˆ");
        }
    }
    
    /**
     * è®°å½•ç”¨æˆ·ç¦»çº¿æ—¥å¿—
     */
    private void logUserOffline(HttpSession session) {
        Object userInfo = session.getAttribute("userInfo");
        if (userInfo != null) {
            // è®°å½•åˆ°æ—¥å¿—æ–‡ä»¶æˆ–æ•°æ®åº“
            String logMessage = String.format(
                "ç”¨æˆ·ç¦»çº¿ - Session: %s, æ—¶é—´: %s", 
                session.getId(), 
                new Date()
            );
            System.out.println(logMessage);
            // Logger.info(logMessage);
        }
    }
}
```

---

## 3. ğŸ—ƒï¸ HttpSessionAttributeListenerè¯¦è§£


### 3.1 HttpSessionAttributeListeneræ¥å£ä»‹ç»

**ğŸ”¸ æ¥å£æ–¹æ³•è¯¦è§£**

è¿™ä¸ªæ¥å£ä¸“é—¨ç›‘å¬Sessionä¸­æ•°æ®çš„å˜åŒ–ï¼Œå°±åƒä¸€ä¸ªç»†å¿ƒçš„ç®¡å®¶ï¼š

```java
public interface HttpSessionAttributeListener {
    // å‘Sessionä¸­æ·»åŠ å±æ€§æ—¶è°ƒç”¨
    void attributeAdded(HttpSessionBindingEvent event);
    
    // ä»Sessionä¸­ç§»é™¤å±æ€§æ—¶è°ƒç”¨
    void attributeRemoved(HttpSessionBindingEvent event);
    
    // Sessionä¸­å±æ€§å€¼è¢«æ›¿æ¢æ—¶è°ƒç”¨
    void attributeReplaced(HttpSessionBindingEvent event);
}
```

**ğŸ’¡ ä¸‰ä¸ªæ–¹æ³•çš„è§¦å‘åœºæ™¯**
```
attributeAddedè§¦å‘æ—¶æœºï¼š
- session.setAttribute("key", value) ç¬¬ä¸€æ¬¡è®¾ç½®æ—¶
- ä¹‹å‰æ²¡æœ‰è¿™ä¸ªkeyçš„æƒ…å†µä¸‹

attributeReplacedè§¦å‘æ—¶æœºï¼š
- session.setAttribute("key", newValue) è¦†ç›–å·²æœ‰å€¼æ—¶
- keyå·²å­˜åœ¨ï¼Œä½†å€¼å‘ç”Ÿå˜åŒ–æ—¶

attributeRemovedè§¦å‘æ—¶æœºï¼š
- session.removeAttribute("key") æ—¶
- sessionè¢«é”€æ¯æ—¶ï¼ˆæ‰€æœ‰å±æ€§éƒ½ä¼šè¢«ç§»é™¤ï¼‰
```

### 3.2 ç”¨æˆ·è¡Œä¸ºç›‘æ§å®ç°

**ğŸ‘€ ç›‘æ§ç”¨æˆ·çš„æ“ä½œè¡Œä¸º**

```java
@WebListener
public class UserActivityMonitor implements HttpSessionAttributeListener {
    
    /**
     * ç”¨æˆ·å­˜å‚¨äº†æ–°æ•°æ®
     * æ¯”å¦‚ç™»å½•ä¿¡æ¯ã€è´­ç‰©è½¦å•†å“ã€ä¸ªäººè®¾ç½®ç­‰
     */
    @Override
    public void attributeAdded(HttpSessionBindingEvent event) {
        String attributeName = event.getName();  // å±æ€§å
        Object attributeValue = event.getValue(); // å±æ€§å€¼
        HttpSession session = event.getSession(); // æ‰€å±Session
        
        // è®°å½•ç”¨æˆ·è¡Œä¸º
        logUserActivity(session, "ADD", attributeName, attributeValue);
        
        // ç‰¹æ®Šå¤„ç†ï¼šç”¨æˆ·ç™»å½•
        if ("userInfo".equals(attributeName)) {
            handleUserLogin(session, attributeValue);
        }
        
        // ç‰¹æ®Šå¤„ç†ï¼šåŠ å…¥è´­ç‰©è½¦
        if ("shoppingCart".equals(attributeName)) {
            handleShoppingCartChange(session, attributeValue);
        }
    }
    
    /**
     * ç”¨æˆ·æ›´æ–°äº†æ•°æ®
     * æ¯”å¦‚ä¿®æ”¹ä¸ªäººä¿¡æ¯ã€æ›´æ–°è´­ç‰©è½¦ç­‰
     */
    @Override
    public void attributeReplaced(HttpSessionBindingEvent event) {
        String attributeName = event.getName();
        Object oldValue = event.getValue();      // æ—§å€¼
        Object newValue = event.getSession().getAttribute(attributeName); // æ–°å€¼
        HttpSession session = event.getSession();
        
        // è®°å½•æ•°æ®å˜æ›´
        logDataChange(session, attributeName, oldValue, newValue);
        
        // ç‰¹æ®Šå¤„ç†ï¼šè´­ç‰©è½¦æ›´æ–°
        if ("shoppingCart".equals(attributeName)) {
            handleShoppingCartUpdate(session, oldValue, newValue);
        }
    }
    
    /**
     * ç”¨æˆ·åˆ é™¤äº†æ•°æ®
     * æ¯”å¦‚é€€å‡ºç™»å½•ã€æ¸…ç©ºè´­ç‰©è½¦ç­‰
     */
    @Override
    public void attributeRemoved(HttpSessionBindingEvent event) {
        String attributeName = event.getName();
        Object attributeValue = event.getValue();
        HttpSession session = event.getSession();
        
        // è®°å½•ç”¨æˆ·è¡Œä¸º
        logUserActivity(session, "REMOVE", attributeName, attributeValue);
        
        // ç‰¹æ®Šå¤„ç†ï¼šç”¨æˆ·é€€å‡º
        if ("userInfo".equals(attributeName)) {
            handleUserLogout(session, attributeValue);
        }
    }
    
    /**
     * è®°å½•ç”¨æˆ·æ´»åŠ¨æ—¥å¿—
     */
    private void logUserActivity(HttpSession session, String action, 
                                String attributeName, Object value) {
        String logMessage = String.format(
            "[ç”¨æˆ·æ´»åŠ¨] Session: %s, æ“ä½œ: %s, å±æ€§: %s, æ—¶é—´: %s",
            session.getId(), action, attributeName, new Date()
        );
        System.out.println(logMessage);
        
        // å¯ä»¥ä¿å­˜åˆ°æ•°æ®åº“æˆ–æ—¥å¿—æ–‡ä»¶
        // UserActivityLogger.log(session.getId(), action, attributeName, value);
    }
    
    /**
     * å¤„ç†ç”¨æˆ·ç™»å½•
     */
    private void handleUserLogin(HttpSession session, Object userInfo) {
        System.out.println("ç”¨æˆ·ç™»å½•æˆåŠŸï¼Session: " + session.getId());
        
        // å¯ä»¥æ‰§è¡Œç™»å½•åçš„åˆå§‹åŒ–å·¥ä½œ
        // - åŠ è½½ç”¨æˆ·åå¥½è®¾ç½®
        // - åˆå§‹åŒ–ç”¨æˆ·æƒé™
        // - è®°å½•ç™»å½•æ—¶é—´å’ŒIP
        
        session.setAttribute("loginTime", new Date());
    }
    
    /**
     * å¤„ç†è´­ç‰©è½¦å˜åŒ–
     */
    private void handleShoppingCartChange(HttpSession session, Object cartData) {
        System.out.println("è´­ç‰©è½¦å‘ç”Ÿå˜åŒ–ï¼Session: " + session.getId());
        
        // å¯ä»¥æ‰§è¡Œç›¸å…³ä¸šåŠ¡é€»è¾‘
        // - è®¡ç®—è´­ç‰©è½¦æ€»ä»·
        // - æ£€æŸ¥å•†å“åº“å­˜
        // - æ¨èç›¸å…³å•†å“
    }
    
    /**
     * å¤„ç†ç”¨æˆ·é€€å‡º
     */
    private void handleUserLogout(HttpSession session, Object userInfo) {
        System.out.println("ç”¨æˆ·é€€å‡ºç™»å½•ï¼Session: " + session.getId());
        
        // æ‰§è¡Œé€€å‡ºåçš„æ¸…ç†å·¥ä½œ
        // - è®°å½•é€€å‡ºæ—¶é—´
        // - æ¸…ç†ç›¸å…³ç¼“å­˜
        // - ä¿å­˜ç”¨æˆ·çŠ¶æ€
    }
}
```

### 3.3 æ•°æ®å˜åŒ–å®¡è®¡å®ç°

**ğŸ“ è¯¦ç»†è®°å½•æ•°æ®å˜åŒ–è¿‡ç¨‹**

```java
@WebListener
public class DataAuditListener implements HttpSessionAttributeListener {
    
    @Override
    public void attributeAdded(HttpSessionBindingEvent event) {
        recordAuditLog("CREATE", event);
    }
    
    @Override
    public void attributeReplaced(HttpSessionBindingEvent event) {
        recordAuditLog("UPDATE", event);
    }
    
    @Override
    public void attributeRemoved(HttpSessionBindingEvent event) {
        recordAuditLog("DELETE", event);
    }
    
    /**
     * è®°å½•å®¡è®¡æ—¥å¿—
     */
    private void recordAuditLog(String operation, HttpSessionBindingEvent event) {
        // åˆ›å»ºå®¡è®¡è®°å½•
        AuditRecord record = new AuditRecord();
        record.setSessionId(event.getSession().getId());
        record.setOperation(operation);
        record.setAttributeName(event.getName());
        record.setAttributeValue(event.getValue());
        record.setTimestamp(new Date());
        
        // è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆå¦‚æœå·²ç™»å½•ï¼‰
        Object userInfo = event.getSession().getAttribute("userInfo");
        if (userInfo != null) {
            // record.setUserId(((User) userInfo).getId());
        }
        
        // ä¿å­˜å®¡è®¡è®°å½•
        // auditService.saveAuditRecord(record);
        
        System.out.println("å®¡è®¡è®°å½•ï¼š" + record.toString());
    }
    
    /**
     * å®¡è®¡è®°å½•å®ä½“ç±»
     */
    private static class AuditRecord {
        private String sessionId;
        private String operation;
        private String attributeName;
        private Object attributeValue;
        private Date timestamp;
        private String userId;
        
        // getterå’Œsetteræ–¹æ³•...
        
        @Override
        public String toString() {
            return String.format(
                "AuditRecord{sessionId='%s', operation='%s', attribute='%s', time=%s}",
                sessionId, operation, attributeName, timestamp
            );
        }
    }
}
```

---

## 4. âš¡ Sessionäº‹ä»¶ç›‘å¬æœºåˆ¶


### 4.1 äº‹ä»¶ä¼ æ’­æœºåˆ¶ç†è§£

**ğŸ”„ äº‹ä»¶å¦‚ä½•åœ¨ç³»ç»Ÿä¸­ä¼ æ’­**

æƒ³è±¡ä¸€ä¸‹äº‹ä»¶ä¼ æ’­å°±åƒå¤šç±³è¯ºéª¨ç‰Œï¼š

```
ç”¨æˆ·æ“ä½œè§¦å‘ â†’ Servletå®¹å™¨æ£€æµ‹ â†’ åˆ›å»ºäº‹ä»¶å¯¹è±¡ â†’ é€šçŸ¥æ‰€æœ‰ç›‘å¬å™¨

å…·ä½“è¿‡ç¨‹ï¼š
1. ç”¨æˆ·è®¿é—®ç½‘é¡µ â†’ request.getSession()
2. Servletå®¹å™¨å‘ç°éœ€è¦åˆ›å»ºæ–°Session
3. å®¹å™¨åˆ›å»ºHttpSessionEventå¯¹è±¡
4. å®¹å™¨æŸ¥æ‰¾æ‰€æœ‰HttpSessionListener
5. ä¾æ¬¡è°ƒç”¨æ¯ä¸ªç›‘å¬å™¨çš„sessionCreatedæ–¹æ³•
6. ç›‘å¬å™¨æ‰§è¡Œè‡ªå·±çš„ä¸šåŠ¡é€»è¾‘

æ•°æ®å˜åŒ–æ—¶ï¼š
1. ä»£ç æ‰§è¡Œ session.setAttribute("key", value)
2. å®¹å™¨åˆ›å»ºHttpSessionBindingEventå¯¹è±¡  
3. å®¹å™¨æŸ¥æ‰¾æ‰€æœ‰HttpSessionAttributeListener
4. è°ƒç”¨ç›¸åº”çš„æ–¹æ³•ï¼ˆadded/replaced/removedï¼‰
```

### 4.2 å¤šä¸ªç›‘å¬å™¨çš„æ‰§è¡Œé¡ºåº

**ğŸ“‹ å½“æœ‰å¤šä¸ªç›‘å¬å™¨æ—¶çš„å¤„ç†æœºåˆ¶**

```java
// ç¬¬ä¸€ä¸ªç›‘å¬å™¨
@WebListener
public class FirstSessionListener implements HttpSessionListener {
    @Override
    public void sessionCreated(HttpSessionEvent event) {
        System.out.println("ç¬¬ä¸€ä¸ªç›‘å¬å™¨ï¼šSessionåˆ›å»º");
    }
}

// ç¬¬äºŒä¸ªç›‘å¬å™¨  
@WebListener
public class SecondSessionListener implements HttpSessionListener {
    @Override
    public void sessionCreated(HttpSessionEvent event) {
        System.out.println("ç¬¬äºŒä¸ªç›‘å¬å™¨ï¼šSessionåˆ›å»º");
    }
}
```

**âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹**
```
æ‰§è¡Œé¡ºåºä¸ç¡®å®šï¼š
- Servletå®¹å™¨ä¸ä¿è¯ç›‘å¬å™¨çš„æ‰§è¡Œé¡ºåº
- ä¸è¦ä¾èµ–ç‰¹å®šçš„æ‰§è¡Œé¡ºåºç¼–å†™ä»£ç 
- æ¯ä¸ªç›‘å¬å™¨åº”è¯¥ç‹¬ç«‹å®Œæˆè‡ªå·±çš„ä»»åŠ¡

å¼‚å¸¸å¤„ç†ï¼š
- å¦‚æœæŸä¸ªç›‘å¬å™¨æŠ›å‡ºå¼‚å¸¸ï¼Œä¸ä¼šå½±å“å…¶ä»–ç›‘å¬å™¨
- ä½†å¯èƒ½ä¼šå½±å“å½“å‰çš„HTTPè¯·æ±‚å¤„ç†
- å»ºè®®åœ¨ç›‘å¬å™¨ä¸­åšå¥½å¼‚å¸¸å¤„ç†

æ€§èƒ½è€ƒè™‘ï¼š
- ç›‘å¬å™¨ä¸­çš„ä»£ç åº”è¯¥å°½é‡ç®€æ´å¿«é€Ÿ
- é¿å…æ‰§è¡Œè€—æ—¶æ“ä½œï¼ˆå¦‚ç½‘ç»œè¯·æ±‚ã€å¤æ‚è®¡ç®—ï¼‰
- å¯ä»¥è€ƒè™‘å¼‚æ­¥å¤„ç†å¤æ‚ä»»åŠ¡
```

### 4.3 äº‹ä»¶å¯¹è±¡çš„ä½¿ç”¨

**ğŸ HttpSessionEventå’ŒHttpSessionBindingEventè¯¦è§£**

```java
@WebListener
public class EventDetailsListener implements HttpSessionListener, 
                                           HttpSessionAttributeListener {
    
    @Override
    public void sessionCreated(HttpSessionEvent event) {
        // HttpSessionEventæä¾›çš„ä¿¡æ¯
        HttpSession session = event.getSession();
        
        System.out.println("Sessionè¯¦ç»†ä¿¡æ¯ï¼š");
        System.out.println("- Session ID: " + session.getId());
        System.out.println("- åˆ›å»ºæ—¶é—´: " + new Date(session.getCreationTime()));
        System.out.println("- æœ€å¤§éæ´»è·ƒæ—¶é—´: " + session.getMaxInactiveInterval() + "ç§’");
        System.out.println("- æ˜¯å¦æ˜¯æ–°Session: " + session.isNew());
        
        // è·å–ServletContext
        ServletContext context = session.getServletContext();
        System.out.println("- åº”ç”¨ç¨‹åº: " + context.getServletContextName());
    }
    
    @Override
    public void attributeAdded(HttpSessionBindingEvent event) {
        // HttpSessionBindingEventæä¾›æ›´ä¸°å¯Œçš„ä¿¡æ¯
        System.out.println("å±æ€§å˜åŒ–è¯¦æƒ…ï¼š");
        System.out.println("- å±æ€§å: " + event.getName());
        System.out.println("- å±æ€§å€¼: " + event.getValue());
        System.out.println("- å±æ€§å€¼ç±»å‹: " + event.getValue().getClass().getSimpleName());
        System.out.println("- Session ID: " + event.getSession().getId());
        
        // å¯ä»¥è·å–Sessionä¸­çš„å…¶ä»–å±æ€§
        HttpSession session = event.getSession();
        System.out.println("- Sessionä¸­çš„æ‰€æœ‰å±æ€§: ");
        java.util.Enumeration<String> names = session.getAttributeNames();
        while (names.hasMoreElements()) {
            String name = names.nextElement();
            System.out.println("  * " + name + " = " + session.getAttribute(name));
        }
    }
}
```

---

## 5. âš™ï¸ ç›‘å¬å™¨æ³¨å†Œé…ç½®æ–¹å¼


### 5.1 æ³¨è§£æ–¹å¼é…ç½®ï¼ˆæ¨èï¼‰

**âœ¨ æœ€ç®€å•ç›´è§‚çš„é…ç½®æ–¹å¼**

ä½¿ç”¨@WebListeneræ³¨è§£æ˜¯æœ€ç°ä»£å’Œç®€ä¾¿çš„æ–¹å¼ï¼š

```java
// åªéœ€è¦ä¸€ä¸ªæ³¨è§£å°±å¯ä»¥æ³¨å†Œç›‘å¬å™¨
@WebListener
public class SimpleSessionListener implements HttpSessionListener {
    
    @Override
    public void sessionCreated(HttpSessionEvent event) {
        System.out.println("Sessionåˆ›å»ºï¼š" + event.getSession().getId());
    }
    
    @Override
    public void sessionDestroyed(HttpSessionEvent event) {
        System.out.println("Sessioné”€æ¯ï¼š" + event.getSession().getId());
    }
}
```

**ğŸ¯ æ³¨è§£æ–¹å¼çš„ä¼˜ç‚¹**
```
ç®€å•æ˜“ç”¨ï¼š
- åªéœ€è¦ä¸€ä¸ª@WebListeneræ³¨è§£
- ä¸éœ€è¦ä¿®æ”¹web.xmlé…ç½®æ–‡ä»¶
- ä»£ç å’Œé…ç½®åœ¨ä¸€èµ·ï¼Œä¾¿äºç»´æŠ¤

è‡ªåŠ¨å‘ç°ï¼š
- Servlet 3.0+æ”¯æŒè‡ªåŠ¨æ‰«æ
- å®¹å™¨å¯åŠ¨æ—¶è‡ªåŠ¨æ³¨å†Œ
- æ— éœ€æ‰‹åŠ¨é…ç½®

ç±»å‹å®‰å…¨ï¼š
- ç¼–è¯‘æ—¶æ£€æŸ¥æ¥å£å®ç°
- IDEæ”¯æŒä»£ç æç¤ºå’Œé”™è¯¯æ£€æŸ¥
```

### 5.2 web.xmlé…ç½®æ–¹å¼

**ğŸ“„ ä¼ ç»Ÿä½†ç¨³å®šçš„é…ç½®æ–¹å¼**

åœ¨web.xmlæ–‡ä»¶ä¸­é…ç½®ç›‘å¬å™¨ï¼š

```xml
<?xml version="1.0" encoding="UTF-8"?>
<web-app xmlns="http://java.sun.com/xml/ns/javaee"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://java.sun.com/xml/ns/javaee 
         http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd"
         version="3.0">
    
    <!-- é…ç½®Sessionç›‘å¬å™¨ -->
    <listener>
        <description>åœ¨çº¿ç”¨æˆ·ç»Ÿè®¡ç›‘å¬å™¨</description>
        <listener-class>com.example.OnlineUserCounter</listener-class>
    </listener>
    
    <listener>
        <description>ç”¨æˆ·æ´»åŠ¨ç›‘æ§ç›‘å¬å™¨</description>
        <listener-class>com.example.UserActivityMonitor</listener-class>
    </listener>
    
    <!-- å…¶ä»–é…ç½®... -->
</web-app>
```

**ğŸ”¸ web.xmlé…ç½®çš„ç‰¹ç‚¹**
```
é›†ä¸­ç®¡ç†ï¼š
- æ‰€æœ‰ç›‘å¬å™¨é…ç½®éƒ½åœ¨web.xmlä¸­
- ä¾¿äºç»Ÿä¸€æŸ¥çœ‹å’Œç®¡ç†
- éƒ¨ç½²æ—¶å¯ä»¥çµæ´»è°ƒæ•´

åŠ è½½é¡ºåºï¼š
- æŒ‰ç…§åœ¨web.xmlä¸­çš„é…ç½®é¡ºåºåŠ è½½
- å¯ä»¥æ§åˆ¶ç›‘å¬å™¨çš„åˆå§‹åŒ–é¡ºåº
- é€‚åˆæœ‰ä¾èµ–å…³ç³»çš„ç›‘å¬å™¨

å…¼å®¹æ€§å¥½ï¼š
- æ”¯æŒæ‰€æœ‰Servletç‰ˆæœ¬
- ä¸ä¾èµ–æ³¨è§£åŠŸèƒ½
- åœ¨è€é¡¹ç›®ä¸­ä¾ç„¶æœ‰æ•ˆ
```

### 5.3 ç¨‹åºåŒ–æ³¨å†Œæ–¹å¼

**ğŸ”§ åŠ¨æ€æ³¨å†Œç›‘å¬å™¨**

åœ¨ServletContextListenerä¸­åŠ¨æ€æ³¨å†Œï¼š

```java
@WebListener
public class ApplicationInitializer implements ServletContextListener {
    
    @Override
    public void contextInitialized(ServletContextEvent event) {
        ServletContext context = event.getServletContext();
        
        // ç¨‹åºåŒ–æ³¨å†ŒSessionç›‘å¬å™¨
        OnlineUserCounter onlineCounter = new OnlineUserCounter();
        context.addListener(onlineCounter);
        
        UserActivityMonitor activityMonitor = new UserActivityMonitor();
        context.addListener(activityMonitor);
        
        System.out.println("ç›‘å¬å™¨åŠ¨æ€æ³¨å†Œå®Œæˆ");
    }
}
```

**ğŸ’¡ ç¨‹åºåŒ–æ³¨å†Œçš„åº”ç”¨åœºæ™¯**
```
æ¡ä»¶æ€§æ³¨å†Œï¼š
- æ ¹æ®é…ç½®æ–‡ä»¶å†³å®šæ˜¯å¦æ³¨å†ŒæŸä¸ªç›‘å¬å™¨
- æ ¹æ®ç¯å¢ƒï¼ˆå¼€å‘/æµ‹è¯•/ç”Ÿäº§ï¼‰é€‰æ‹©æ€§æ³¨å†Œ
- åŸºäºåŠŸèƒ½å¼€å…³æ§åˆ¶ç›‘å¬å™¨

åŠ¨æ€é…ç½®ï¼š
- è¿è¡Œæ—¶å†³å®šç›‘å¬å™¨çš„å‚æ•°
- æ ¹æ®æ•°æ®åº“é…ç½®åŠ¨æ€åˆ›å»ºç›‘å¬å™¨
- æ’ä»¶å¼æ¶æ„ä¸­çš„ç›‘å¬å™¨æ³¨å†Œ
```

### 5.4 Springæ¡†æ¶ä¸­çš„ç›‘å¬å™¨é…ç½®

**ğŸŒ¿ ä¸Springæ¡†æ¶çš„é›†æˆ**

åœ¨Springç¯å¢ƒä¸­ï¼Œå¯ä»¥å°†ç›‘å¬å™¨å£°æ˜ä¸ºBeanï¼š

```java
@Component  // Springç®¡ç†çš„Bean
public class SpringSessionListener implements HttpSessionListener {
    
    @Autowired
    private UserService userService;  // å¯ä»¥æ³¨å…¥Spring Bean
    
    @Autowired  
    private RedisTemplate redisTemplate;  // ä½¿ç”¨Springçš„Rediså®¢æˆ·ç«¯
    
    @Override
    public void sessionCreated(HttpSessionEvent event) {
        // å¯ä»¥ä½¿ç”¨Springç®¡ç†çš„æœåŠ¡
        String sessionId = event.getSession().getId();
        
        // å°†Sessionä¿¡æ¯å­˜å‚¨åˆ°Redis
        redisTemplate.opsForValue().set("session:" + sessionId, "active");
        
        System.out.println("Springç®¡ç†çš„ç›‘å¬å™¨ï¼šSessionåˆ›å»º");
    }
    
    @Override
    public void sessionDestroyed(HttpSessionEvent event) {
        String sessionId = event.getSession().getId();
        
        // ä»Redisä¸­æ¸…é™¤Sessionä¿¡æ¯
        redisTemplate.delete("session:" + sessionId);
        
        System.out.println("Springç®¡ç†çš„ç›‘å¬å™¨ï¼šSessioné”€æ¯");
    }
}
```

---

## 6. ğŸš€ å®é™…åº”ç”¨åœºæ™¯


### 6.1 åœ¨çº¿ç”¨æˆ·å®æ—¶ç»Ÿè®¡

**ğŸ‘¥ å®Œæ•´çš„åœ¨çº¿ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ**

```java
@WebListener
public class RealTimeUserTracker implements HttpSessionListener, 
                                           HttpSessionAttributeListener {
    
    // ä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„é›†åˆå­˜å‚¨åœ¨çº¿ç”¨æˆ·ä¿¡æ¯
    private static final ConcurrentHashMap<String, UserInfo> onlineUsers = 
        new ConcurrentHashMap<>();
    
    @Override
    public void sessionCreated(HttpSessionEvent event) {
        String sessionId = event.getSession().getId();
        
        // åˆ›å»ºåŒ¿åç”¨æˆ·ä¿¡æ¯
        UserInfo userInfo = new UserInfo();
        userInfo.setSessionId(sessionId);
        userInfo.setLoginTime(new Date());
        userInfo.setStatus("è®¿å®¢");
        userInfo.setIpAddress(getClientIP(event.getSession()));
        
        onlineUsers.put(sessionId, userInfo);
        
        // å¹¿æ’­åœ¨çº¿ç”¨æˆ·æ•°é‡å˜åŒ–ï¼ˆWebSocketå®ç°ï¼‰
        broadcastOnlineCount();
        
        System.out.println("æ–°è®¿å®¢ä¸Šçº¿ï¼Œå½“å‰åœ¨çº¿: " + onlineUsers.size() + " äºº");
    }
    
    @Override  
    public void attributeAdded(HttpSessionBindingEvent event) {
        // ç”¨æˆ·ç™»å½•æ—¶æ›´æ–°ç”¨æˆ·ä¿¡æ¯
        if ("loginUser".equals(event.getName())) {
            String sessionId = event.getSession().getId();
            UserInfo userInfo = onlineUsers.get(sessionId);
            
            if (userInfo != null) {
                // æ›´æ–°ä¸ºå·²ç™»å½•ç”¨æˆ·
                Object loginUser = event.getValue();
                userInfo.setUsername(getUserName(loginUser));
                userInfo.setStatus("å·²ç™»å½•");
                userInfo.setUserId(getUserId(loginUser));
                
                // å¹¿æ’­ç”¨æˆ·çŠ¶æ€å˜åŒ–
                broadcastUserLogin(userInfo);
            }
        }
    }
    
    @Override
    public void sessionDestroyed(HttpSessionEvent event) {
        String sessionId = event.getSession().getId();
        UserInfo userInfo = onlineUsers.remove(sessionId);
        
        if (userInfo != null) {
            // è®°å½•ç”¨æˆ·åœ¨çº¿æ—¶é•¿
            long onlineTime = System.currentTimeMillis() - 
                             userInfo.getLoginTime().getTime();
            System.out.println("ç”¨æˆ·ä¸‹çº¿: " + userInfo.getUsername() + 
                             ", åœ¨çº¿æ—¶é•¿: " + (onlineTime / 1000) + " ç§’");
            
            // å¹¿æ’­ç”¨æˆ·ä¸‹çº¿
            broadcastUserLogout(userInfo);
        }
        
        // å¹¿æ’­åœ¨çº¿ç”¨æˆ·æ•°é‡å˜åŒ–
        broadcastOnlineCount();
    }
    
    // è·å–å½“å‰æ‰€æœ‰åœ¨çº¿ç”¨æˆ·ä¿¡æ¯
    public static List<UserInfo> getOnlineUsers() {
        return new ArrayList<>(onlineUsers.values());
    }
    
    // è·å–åœ¨çº¿ç”¨æˆ·æ•°é‡
    public static int getOnlineUserCount() {
        return onlineUsers.size();
    }
    
    // è¾…åŠ©æ–¹æ³•
    private String getClientIP(HttpSession session) {
        // è¿™é‡Œå¯ä»¥é€šè¿‡å…¶ä»–æ–¹å¼è·å–å®¢æˆ·ç«¯IP
        return "æœªçŸ¥IP";
    }
    
    private void broadcastOnlineCount() {
        // é€šè¿‡WebSocketå‘æ‰€æœ‰å®¢æˆ·ç«¯å¹¿æ’­åœ¨çº¿äººæ•°
        // WebSocketManager.broadcast("onlineCount", onlineUsers.size());
    }
    
    // ç”¨æˆ·ä¿¡æ¯å®ä½“ç±»
    public static class UserInfo {
        private String sessionId;
        private String userId;
        private String username;
        private String status;
        private Date loginTime;
        private String ipAddress;
        
        // getterå’Œsetteræ–¹æ³•...
    }
}
```

### 6.2 è´­ç‰©è½¦çŠ¶æ€ç›‘æ§

**ğŸ›’ ç”µå•†ç½‘ç«™è´­ç‰©è½¦ç®¡ç†**

```java
@WebListener
public class ShoppingCartMonitor implements HttpSessionAttributeListener {
    
    @Override
    public void attributeAdded(HttpSessionBindingEvent event) {
        if ("shoppingCart".equals(event.getName())) {
            handleCartCreated(event);
        }
    }
    
    @Override
    public void attributeReplaced(HttpSessionBindingEvent event) {
        if ("shoppingCart".equals(event.getName())) {
            handleCartUpdated(event);
        }
    }
    
    @Override
    public void attributeRemoved(HttpSessionBindingEvent event) {
        if ("shoppingCart".equals(event.getName())) {
            handleCartRemoved(event);
        }
    }
    
    /**
     * å¤„ç†è´­ç‰©è½¦åˆ›å»º
     */
    private void handleCartCreated(HttpSessionBindingEvent event) {
        ShoppingCart cart = (ShoppingCart) event.getValue();
        String sessionId = event.getSession().getId();
        
        System.out.println("ç”¨æˆ·åˆ›å»ºè´­ç‰©è½¦: " + sessionId);
        
        // ç»Ÿè®¡è´­ç‰©è½¦åˆ›å»ºæƒ…å†µ
        updateCartStatistics("created", cart);
        
        // å¯ä»¥è§¦å‘è¥é”€æ´»åŠ¨ï¼Œæ¯”å¦‚æ–°ç”¨æˆ·ä¼˜æƒ åˆ¸
        triggerMarketingEvent("cart_created", sessionId, cart);
    }
    
    /**
     * å¤„ç†è´­ç‰©è½¦æ›´æ–°
     */
    private void handleCartUpdated(HttpSessionBindingEvent event) {
        ShoppingCart oldCart = (ShoppingCart) event.getValue();
        ShoppingCart newCart = (ShoppingCart) event.getSession().getAttribute("shoppingCart");
        
        // åˆ†æè´­ç‰©è½¦å˜åŒ–
        analyzeCartChanges(oldCart, newCart);
        
        // å¦‚æœè´­ç‰©è½¦é‡‘é¢è¾¾åˆ°æŸä¸ªé˜ˆå€¼ï¼Œå¯ä»¥æ¨é€ä¼˜æƒ ä¿¡æ¯
        if (newCart.getTotalAmount().compareTo(new BigDecimal("200")) >= 0) {
            // æ¨é€æ»¡å‡ä¼˜æƒ ä¿¡æ¯
            pushDiscountNotification(event.getSession(), newCart);
        }
        
        // å¦‚æœç”¨æˆ·æ·»åŠ äº†çƒ­é—¨å•†å“ï¼Œå¯ä»¥æ¨èç›¸å…³å•†å“
        recommendRelatedProducts(event.getSession(), newCart);
    }
    
    /**
     * å¤„ç†è´­ç‰©è½¦åˆ é™¤
     */
    private void handleCartRemoved(HttpSessionBindingEvent event) {
        ShoppingCart cart = (ShoppingCart) event.getValue();
        String sessionId = event.getSession().getId();
        
        System.out.println("ç”¨æˆ·æ¸…ç©ºè´­ç‰©è½¦: " + sessionId);
        
        // åˆ†æè´­ç‰©è½¦æ”¾å¼ƒåŸå› 
        analyzeCartAbandonment(cart);
        
        // å¯ä»¥å‘é€é‚®ä»¶æé†’æˆ–ä¼˜æƒ åˆ¸æŒ½å›ç”¨æˆ·
        sendCartRecoveryEmail(sessionId, cart);
    }
    
    /**
     * åˆ†æè´­ç‰©è½¦å˜åŒ–
     */
    private void analyzeCartChanges(ShoppingCart oldCart, ShoppingCart newCart) {
        System.out.println("è´­ç‰©è½¦å˜åŒ–åˆ†æï¼š");
        System.out.println("åŸå•†å“æ•°é‡: " + oldCart.getItemCount());
        System.out.println("æ–°å•†å“æ•°é‡: " + newCart.getItemCount());
        System.out.println("åŸæ€»é‡‘é¢: " + oldCart.getTotalAmount());
        System.out.println("æ–°æ€»é‡‘é¢: " + newCart.getTotalAmount());
        
        // æ£€æŸ¥æ˜¯æ·»åŠ å•†å“è¿˜æ˜¯ç§»é™¤å•†å“
        if (newCart.getItemCount() > oldCart.getItemCount()) {
            System.out.println("ç”¨æˆ·æ·»åŠ äº†å•†å“åˆ°è´­ç‰©è½¦");
        } else if (newCart.getItemCount() < oldCart.getItemCount()) {
            System.out.println("ç”¨æˆ·ä»è´­ç‰©è½¦ç§»é™¤äº†å•†å“");
        } else {
            System.out.println("ç”¨æˆ·ä¿®æ”¹äº†å•†å“æ•°é‡");
        }
    }
    
    // è´­ç‰©è½¦å®ä½“ç±»
    public static class ShoppingCart {
        private List<CartItem> items = new ArrayList<>();
        
        public int getItemCount() {
            return items.size();
        }
        
        public BigDecimal getTotalAmount() {
            return items.stream()
                .map(item -> item.getPrice().multiply(new BigDecimal(item.getQuantity())))
                .reduce(BigDecimal.ZERO, BigDecimal::add);
        }
        
        // å…¶ä»–æ–¹æ³•...
    }
    
    public static class CartItem {
        private String productId;
        private String productName;
        private BigDecimal price;
        private int quantity;
        
        // getterå’Œsetteræ–¹æ³•...
    }
}
```

### 6.3 ç³»ç»Ÿå®‰å…¨ç›‘æ§

**ğŸ”’ å®‰å…¨ç›¸å…³çš„ç›‘å¬å™¨åº”ç”¨**

```java
@WebListener
public class SecurityMonitor implements HttpSessionListener, 
                                       HttpSessionAttributeListener {
    
    // å­˜å‚¨å¯ç–‘çš„Session ID
    private static final Set<String> suspiciousSessions = 
        Collections.synchronizedSet(new HashSet<>());
    
    @Override
    public void sessionCreated(HttpSessionEvent event) {
        String sessionId = event.getSession().getId();
        
        // è®°å½•Sessionåˆ›å»ºæ—¥å¿—
        logSecurityEvent("SESSION_CREATED", sessionId, "æ–°Sessionåˆ›å»º");
        
        // æ£€æŸ¥æ˜¯å¦æœ‰å¼‚å¸¸çš„Sessionåˆ›å»ºé¢‘ç‡
        checkSessionCreationRate(event.getSession());
    }
    
    @Override
    public void attributeAdded(HttpSessionBindingEvent event) {
        String attributeName = event.getName();
        String sessionId = event.getSession().getId();
        
        // ç›‘æ§æ•æ„Ÿæ“ä½œ
        if ("adminUser".equals(attributeName)) {
            logSecurityEvent("ADMIN_LOGIN", sessionId, "ç®¡ç†å‘˜ç™»å½•");
            
            // ç®¡ç†å‘˜ç™»å½•éœ€è¦ç‰¹æ®Šç›‘æ§
            monitorAdminSession(event.getSession());
        }
        
        // ç›‘æ§ç™»å½•å°è¯•
        if ("loginAttempts".equals(attributeName)) {
            Integer attempts = (Integer) event.getValue();
            if (attempts > 3) {
                // ç™»å½•å°è¯•æ¬¡æ•°è¿‡å¤šï¼Œæ ‡è®°ä¸ºå¯ç–‘
                suspiciousSessions.add(sessionId);
                logSecurityEvent("SUSPICIOUS_LOGIN", sessionId, 
                               "ç™»å½•å°è¯•æ¬¡æ•°è¿‡å¤š: " + attempts);
            }
        }
    }
    
    @Override
    public void attributeReplaced(HttpSessionBindingEvent event) {
        String attributeName = event.getName();
        String sessionId = event.getSession().getId();
        
        // ç›‘æ§æƒé™å˜åŒ–
        if ("userRole".equals(attributeName)) {
            Object oldRole = event.getValue();
            Object newRole = event.getSession().getAttribute(attributeName);
            
            logSecurityEvent("ROLE_CHANGED", sessionId, 
                           "ç”¨æˆ·è§’è‰²å˜åŒ–: " + oldRole + " -> " + newRole);
            
            // æƒé™æå‡éœ€è¦ç‰¹æ®Šå…³æ³¨
            if (isPrivilegeEscalation(oldRole, newRole)) {
                logSecurityEvent("PRIVILEGE_ESCALATION", sessionId, 
                               "æ£€æµ‹åˆ°æƒé™æå‡è¡Œä¸º");
                // å¯ä»¥å‘é€å‘Šè­¦é€šçŸ¥
                sendSecurityAlert(sessionId, "æƒé™æå‡");
            }
        }
    }
    
    @Override
    public void sessionDestroyed(HttpSessionEvent event) {
        String sessionId = event.getSession().getId();
        
        // æ¸…ç†å¯ç–‘Sessionè®°å½•
        suspiciousSessions.remove(sessionId);
        
        // è®°å½•Sessioné”€æ¯
        logSecurityEvent("SESSION_DESTROYED", sessionId, "Sessioné”€æ¯");
        
        // å¦‚æœæ˜¯ç®¡ç†å‘˜Sessionï¼Œè®°å½•ç‰¹æ®Šæ—¥å¿—
        Object adminUser = event.getSession().getAttribute("adminUser");
        if (adminUser != null) {
            logSecurityEvent("ADMIN_LOGOUT", sessionId, "ç®¡ç†å‘˜é€€å‡º");
        }
    }
    
    /**
     * æ£€æŸ¥Sessionåˆ›å»ºé¢‘ç‡
     */
    private void checkSessionCreationRate(HttpSession session) {
        // ç®€å•çš„é¢‘ç‡æ£€æŸ¥é€»è¾‘
        // å®é™…åº”ç”¨ä¸­å¯èƒ½éœ€è¦æ›´å¤æ‚çš„ç®—æ³•
        String clientIP = getClientIP(session);
        
        // æ£€æŸ¥æ¥è‡ªåŒä¸€IPçš„Sessionåˆ›å»ºé¢‘ç‡
        // å¦‚æœé¢‘ç‡è¿‡é«˜ï¼Œå¯èƒ½æ˜¯æ”»å‡»è¡Œä¸º
    }
    
    /**
     * ç›‘æ§ç®¡ç†å‘˜Session
     */
    private void monitorAdminSession(HttpSession session) {
        // ä¸ºç®¡ç†å‘˜Sessionè®¾ç½®æ›´çŸ­çš„è¶…æ—¶æ—¶é—´
        session.setMaxInactiveInterval(1800); // 30åˆ†é’Ÿ
        
        // è®°å½•ç®¡ç†å‘˜çš„è¯¦ç»†ä¿¡æ¯
        String sessionId = session.getId();
        logSecurityEvent("ADMIN_SESSION_MONITOR", sessionId, 
                       "ç®¡ç†å‘˜Sessionç›‘æ§å·²å¯ç”¨");
    }
    
    /**
     * è®°å½•å®‰å…¨äº‹ä»¶
     */
    private void logSecurityEvent(String eventType, String sessionId, String description) {
        String logMessage = String.format(
            "[å®‰å…¨ç›‘æ§] %s - Session: %s, æè¿°: %s, æ—¶é—´: %s",
            eventType, sessionId, description, new Date()
        );
        
        System.out.println(logMessage);
        
        // å®é™…åº”ç”¨ä¸­åº”è¯¥ä¿å­˜åˆ°å®‰å…¨æ—¥å¿—æ–‡ä»¶æˆ–æ•°æ®åº“
        // SecurityLogger.log(eventType, sessionId, description);
    }
    
    /**
     * å‘é€å®‰å…¨å‘Šè­¦
     */
    private void sendSecurityAlert(String sessionId, String alertType) {
        System.out.println("ğŸš¨ å®‰å…¨å‘Šè­¦: " + alertType + ", Session: " + sessionId);
        
        // å®é™…åº”ç”¨ä¸­å¯ä»¥å‘é€é‚®ä»¶ã€çŸ­ä¿¡æˆ–æ¨é€é€šçŸ¥
        // AlertManager.sendAlert(alertType, sessionId);
    }
    
    /**
     * æ£€æŸ¥æ˜¯å¦ä¸ºæƒé™æå‡
     */
    private boolean isPrivilegeEscalation(Object oldRole, Object newRole) {
        // ç®€å•çš„æƒé™ç­‰çº§åˆ¤æ–­
        // å®é™…åº”ç”¨ä¸­éœ€è¦æ ¹æ®å…·ä½“çš„æƒé™ä½“ç³»è®¾è®¡
        return "user".equals(oldRole) && "admin".equals(newRole);
    }
    
    /**
     * è·å–å®¢æˆ·ç«¯IPåœ°å€
     */
    private String getClientIP(HttpSession session) {
        // è¿™é‡Œéœ€è¦é€šè¿‡å…¶ä»–æ–¹å¼è·å–å®¢æˆ·ç«¯IP
        // å®é™…å®ç°å¯èƒ½éœ€è¦åœ¨Servletä¸­è·å–å¹¶å­˜å‚¨åˆ°Session
        return "unknown";
    }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ ç›‘å¬å™¨æœ¬è´¨ï¼šSessionçš„"è´´èº«ä¿é•–"ï¼Œè‡ªåŠ¨ç›‘æ§SessionçŠ¶æ€å˜åŒ–
ğŸ”¸ ä¸¤å¤§æ¥å£ï¼šHttpSessionListenerç›‘æ§ç”Ÿå‘½å‘¨æœŸï¼ŒHttpSessionAttributeListenerç›‘æ§æ•°æ®å˜åŒ–
ğŸ”¸ äº‹ä»¶æœºåˆ¶ï¼šå®¹å™¨è‡ªåŠ¨åˆ›å»ºäº‹ä»¶å¯¹è±¡ï¼Œé€šçŸ¥æ‰€æœ‰æ³¨å†Œçš„ç›‘å¬å™¨
ğŸ”¸ é…ç½®æ–¹å¼ï¼š@WebListeneræ³¨è§£æœ€ç®€å•ï¼Œweb.xmlé…ç½®æœ€ä¼ ç»Ÿï¼Œç¨‹åºåŒ–æ³¨å†Œæœ€çµæ´»
ğŸ”¸ åº”ç”¨åœºæ™¯ï¼šåœ¨çº¿ç»Ÿè®¡ã€èµ„æºæ¸…ç†ã€è¡Œä¸ºç›‘æ§ã€å®‰å…¨å®¡è®¡ç­‰
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ç›‘å¬å™¨çš„å·¥ä½œåŸç†**
```
è‡ªåŠ¨åŒ–æœºåˆ¶ï¼š
- æ— éœ€æ‰‹åŠ¨è°ƒç”¨ï¼Œå®¹å™¨è‡ªåŠ¨è§¦å‘
- åœ¨å…³é”®èŠ‚ç‚¹è‡ªåŠ¨æ‰§è¡Œä¸šåŠ¡é€»è¾‘
- æä¾›ç»Ÿä¸€çš„äº‹ä»¶å¤„ç†æ¡†æ¶

è§£è€¦è®¾è®¡ï¼š
- ä¸šåŠ¡ä»£ç ä¸ç›‘æ§ä»£ç åˆ†ç¦»
- é€šè¿‡äº‹ä»¶æœºåˆ¶å®ç°æ¾è€¦åˆ
- ä¾¿äºç»´æŠ¤å’Œæ‰©å±•åŠŸèƒ½
```

**ğŸ”¹ ä¸¤ç§ç›‘å¬å™¨çš„é€‰æ‹©ç­–ç•¥**
```
HttpSessionListeneré€‚ç”¨åœºæ™¯ï¼š
- åœ¨çº¿ç”¨æˆ·ç»Ÿè®¡
- ç³»ç»Ÿèµ„æºç®¡ç†
- ç”¨æˆ·ç”Ÿå‘½å‘¨æœŸè·Ÿè¸ª

HttpSessionAttributeListeneré€‚ç”¨åœºæ™¯ï¼š
- æ•°æ®å˜åŒ–ç›‘æ§
- ç”¨æˆ·è¡Œä¸ºåˆ†æ
- ä¸šåŠ¡çŠ¶æ€è·Ÿè¸ª
```

**ğŸ”¹ å®é™…å¼€å‘ä¸­çš„æœ€ä½³å®è·µ**
```
æ€§èƒ½ä¼˜åŒ–ï¼š
- ç›‘å¬å™¨ä»£ç è¦ç®€æ´é«˜æ•ˆ
- é¿å…åœ¨ç›‘å¬å™¨ä¸­æ‰§è¡Œè€—æ—¶æ“ä½œ
- å¿…è¦æ—¶ä½¿ç”¨å¼‚æ­¥å¤„ç†

å¼‚å¸¸å¤„ç†ï¼š
- ç›‘å¬å™¨ä¸­è¦åšå¥½å¼‚å¸¸å¤„ç†
- é¿å…å¼‚å¸¸å½±å“æ­£å¸¸ä¸šåŠ¡æµç¨‹
- è®°å½•å¼‚å¸¸æ—¥å¿—ä¾¿äºæ’æŸ¥

çº¿ç¨‹å®‰å…¨ï¼š
- æ³¨æ„å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„æ•°æ®å®‰å…¨
- ä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„é›†åˆç±»
- é¿å…ç«æ€æ¡ä»¶é—®é¢˜
```

### 7.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¼ä¸šçº§åº”ç”¨åœºæ™¯**
- **ç”µå•†ç½‘ç«™**ï¼šè´­ç‰©è½¦ç›‘æ§ã€ç”¨æˆ·è¡Œä¸ºåˆ†æã€ä¿ƒé”€æ´»åŠ¨è§¦å‘
- **åœ¨çº¿æ•™è‚²**ï¼šå­¦ä¹ è¿›åº¦è·Ÿè¸ªã€è€ƒè¯•çŠ¶æ€ç›‘æ§ã€èµ„æºä½¿ç”¨ç»Ÿè®¡
- **ä¼ä¸šç³»ç»Ÿ**ï¼šç”¨æˆ·æƒé™ç›‘æ§ã€æ“ä½œå®¡è®¡ã€å®‰å…¨äº‹ä»¶è®°å½•
- **ç¤¾äº¤å¹³å°**ï¼šåœ¨çº¿çŠ¶æ€ç®¡ç†ã€æ´»åŠ¨ç›‘æ§ã€å†…å®¹å®¡æ ¸

**ğŸ”§ å¼€å‘å®è·µå»ºè®®**
- **åˆç†ä½¿ç”¨**ï¼šæ ¹æ®å®é™…éœ€æ±‚é€‰æ‹©åˆé€‚çš„ç›‘å¬å™¨ç±»å‹
- **ä»£ç è§„èŒƒ**ï¼šç›‘å¬å™¨ä»£ç è¦ç®€æ´ã€é«˜æ•ˆã€æ˜“ç»´æŠ¤
- **æµ‹è¯•éªŒè¯**ï¼šå……åˆ†æµ‹è¯•ç›‘å¬å™¨åœ¨å„ç§åœºæ™¯ä¸‹çš„è¡¨ç°
- **ç›‘æ§å‘Šè­¦**ï¼šå»ºç«‹ç›‘å¬å™¨å¼‚å¸¸çš„ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶

**ğŸ“ˆ æŠ€æœ¯å‘å±•è¶‹åŠ¿**
- **å¾®æœåŠ¡æ¶æ„**ï¼šç›‘å¬å™¨åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„åº”ç”¨
- **å®æ—¶å¤„ç†**ï¼šç»“åˆæ¶ˆæ¯é˜Ÿåˆ—å®ç°æ›´å¤æ‚çš„äº‹ä»¶å¤„ç†
- **å¤§æ•°æ®åˆ†æ**ï¼šç›‘å¬å™¨æ•°æ®ç”¨äºç”¨æˆ·è¡Œä¸ºå¤§æ•°æ®åˆ†æ
- **äººå·¥æ™ºèƒ½**ï¼šåŸºäºç›‘å¬å™¨æ•°æ®è¿›è¡Œæ™ºèƒ½æ¨èå’Œé¢„æµ‹

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- ç›‘å¬å™¨åƒä¿é•–å®ˆæŠ¤Sessionï¼Œåˆ›å»ºé”€æ¯å…¨ç›‘æ§
- å±æ€§å˜åŒ–ç»†è§‚å¯Ÿï¼Œæ·»åŠ åˆ é™¤æ›¿æ¢å…¨è®°å½•  
- æ³¨è§£é…ç½®æœ€ç®€å•ï¼ŒXMLé…ç½®æ›´çµæ´»
- åœ¨çº¿ç»Ÿè®¡èµ„æºæ¸…ç†ï¼Œå®‰å…¨ç›‘æ§æ ·æ ·è¡Œ