---
title: 3ã€å¼€å‘è§„èŒƒä¸è®¾è®¡æ¨¡å¼
---
## ğŸ“š ç›®å½•å¯¼èˆª

1. [ä¼šè¯ç®¡ç†è®¾è®¡æ¨¡å¼æ¦‚è¿°](#1-ä¼šè¯ç®¡ç†è®¾è®¡æ¨¡å¼æ¦‚è¿°)
2. [ç™»å½•æ€ç®¡ç†è§„èŒƒ](#2-ç™»å½•æ€ç®¡ç†è§„èŒƒ)
3. [å¼‚å¸¸å¤„ç†ç­–ç•¥](#3-å¼‚å¸¸å¤„ç†ç­–ç•¥)
4. [ä»£ç å¤ç”¨æŠ€å·§](#4-ä»£ç å¤ç”¨æŠ€å·§)
5. [é¡¹ç›®æœ€ä½³å®è·µ](#5-é¡¹ç›®æœ€ä½³å®è·µ)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ ä¼šè¯ç®¡ç†è®¾è®¡æ¨¡å¼æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯ä¼šè¯ç®¡ç†è®¾è®¡æ¨¡å¼


**ç®€å•ç†è§£**ï¼šå°±åƒç®¡ç†ä¸€ä¸ªå¤§å‹å›¾ä¹¦é¦†ä¸€æ ·ï¼Œæˆ‘ä»¬éœ€è¦æœ‰æ¡ç†çš„æ–¹æ³•æ¥ç®¡ç†ç”¨æˆ·çš„ç™»å½•çŠ¶æ€ã€‚

```
å›¾ä¹¦é¦†ç®¡ç†ç±»æ¯”ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è¯»è€…ç™»è®°å†Œ     â”‚ â†’  â”‚   ç”¨æˆ·ä¼šè¯ç®¡ç†   â”‚
â”‚ (è°åœ¨ä½¿ç”¨å›¾ä¹¦é¦†) â”‚    â”‚  (è°åœ¨ä½¿ç”¨ç³»ç»Ÿ)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   å€Ÿä¹¦å¡ç®¡ç†     â”‚ â†’  â”‚   Tokenç®¡ç†     â”‚
â”‚ (èº«ä»½éªŒè¯å·¥å…·)   â”‚    â”‚  (èº«ä»½éªŒè¯ä»¤ç‰Œ)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æƒé™ç­‰çº§       â”‚ â†’  â”‚   è§’è‰²æƒé™       â”‚
â”‚ (æ™®é€š/VIPè¯»è€…)   â”‚    â”‚ (ç”¨æˆ·/ç®¡ç†å‘˜)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒæ€æƒ³**ï¼š
- **ç»Ÿä¸€ç®¡ç†**ï¼šæ‰€æœ‰ç”¨æˆ·çš„ç™»å½•çŠ¶æ€éƒ½ç”¨åŒä¸€å¥—è§„åˆ™ç®¡ç†
- **å®‰å…¨å¯é **ï¼šé˜²æ­¢æœªæˆæƒè®¿é—®ï¼Œä¿æŠ¤ç”¨æˆ·æ•°æ®
- **æ˜“äºç»´æŠ¤**ï¼šä»£ç ç»“æ„æ¸…æ™°ï¼Œæ–¹ä¾¿åæœŸä¿®æ”¹å’Œæ‰©å±•

### 1.2 å¸¸è§çš„ä¼šè¯ç®¡ç†æ¨¡å¼


#### ğŸ” å•ä¾‹æ¨¡å¼ï¼ˆSingleton Patternï¼‰


**ä½œç”¨**ï¼šç¡®ä¿ä¼šè¯ç®¡ç†å™¨åœ¨æ•´ä¸ªåº”ç”¨ä¸­åªæœ‰ä¸€ä¸ªå®ä¾‹

**ç”Ÿæ´»ä¾‹å­**ï¼šå°±åƒä¸€ä¸ªå…¬å¸åªèƒ½æœ‰ä¸€ä¸ªäººäº‹éƒ¨é—¨ç®¡ç†æ‰€æœ‰å‘˜å·¥ä¿¡æ¯ä¸€æ ·

```java
// ä¼šè¯ç®¡ç†å™¨ - å•ä¾‹æ¨¡å¼
public class SessionManager {
    // ç§æœ‰é™æ€å®ä¾‹ï¼Œç¡®ä¿åªæœ‰ä¸€ä¸ª
    private static SessionManager instance;
    // å­˜å‚¨æ‰€æœ‰æ´»è·ƒä¼šè¯
    private Map<String, UserSession> activeSessions;
    
    // ç§æœ‰æ„é€ å‡½æ•°ï¼Œé˜²æ­¢å¤–éƒ¨åˆ›å»ºå®ä¾‹
    private SessionManager() {
        activeSessions = new ConcurrentHashMap<>();
    }
    
    // è·å–å”¯ä¸€å®ä¾‹çš„æ–¹æ³•
    public static synchronized SessionManager getInstance() {
        if (instance == null) {
            instance = new SessionManager();
        }
        return instance;
    }
    
    // åˆ›å»ºæ–°ä¼šè¯
    public String createSession(String userId) {
        String sessionId = generateSessionId();
        UserSession session = new UserSession(userId);
        activeSessions.put(sessionId, session);
        return sessionId;
    }
}
```

> ğŸ’¡ **ä¸ºä»€ä¹ˆç”¨å•ä¾‹ï¼Ÿ**
> - é¿å…å¤šä¸ªç®¡ç†å™¨å¯¼è‡´æ•°æ®ä¸ä¸€è‡´
> - èŠ‚çœå†…å­˜èµ„æº
> - æ–¹ä¾¿ç»Ÿä¸€ç®¡ç†æ‰€æœ‰ä¼šè¯

#### ğŸ­ ç­–ç•¥æ¨¡å¼ï¼ˆStrategy Patternï¼‰


**ä½œç”¨**ï¼šæ ¹æ®ä¸åŒåœºæ™¯é€‰æ‹©ä¸åŒçš„ä¼šè¯éªŒè¯ç­–ç•¥

**ç”Ÿæ´»ä¾‹å­**ï¼šé“¶è¡Œå¯¹ä¸åŒé‡‘é¢çš„è½¬è´¦æœ‰ä¸åŒçš„éªŒè¯æ–¹å¼ï¼ˆå°é¢ç”¨å¯†ç ï¼Œå¤§é¢ç”¨æ‰‹æœºéªŒè¯ç ï¼‰

```java
// ä¼šè¯éªŒè¯ç­–ç•¥æ¥å£
public interface SessionValidationStrategy {
    boolean validateSession(String sessionId, HttpServletRequest request);
}

// åŸºç¡€éªŒè¯ç­–ç•¥ï¼ˆåªæ£€æŸ¥Sessionæ˜¯å¦å­˜åœ¨ï¼‰
public class BasicValidationStrategy implements SessionValidationStrategy {
    public boolean validateSession(String sessionId, HttpServletRequest request) {
        HttpSession session = request.getSession(false);
        return session != null && session.getAttribute("user") != null;
    }
}

// å¢å¼ºéªŒè¯ç­–ç•¥ï¼ˆæ£€æŸ¥IPåœ°å€ã€æ—¶é—´ç­‰ï¼‰
public class EnhancedValidationStrategy implements SessionValidationStrategy {
    public boolean validateSession(String sessionId, HttpServletRequest request) {
        HttpSession session = request.getSession(false);
        if (session == null) return false;
        
        // æ£€æŸ¥IPæ˜¯å¦åŒ¹é…
        String sessionIP = (String) session.getAttribute("loginIP");
        String currentIP = request.getRemoteAddr();
        
        return sessionIP != null && sessionIP.equals(currentIP);
    }
}
```

### 1.3 å·¥å‚æ¨¡å¼åœ¨ä¼šè¯ç®¡ç†ä¸­çš„åº”ç”¨


**ä½œç”¨**ï¼šæ ¹æ®ä¸åŒéœ€æ±‚åˆ›å»ºä¸åŒç±»å‹çš„ä¼šè¯å¯¹è±¡

```java
// ä¼šè¯å·¥å‚
public class SessionFactory {
    public static UserSession createSession(String userType, String userId) {
        switch (userType.toLowerCase()) {
            case "admin":
                return new AdminSession(userId, 60); // 60åˆ†é’Ÿè¶…æ—¶
            case "vip":
                return new VipSession(userId, 120);  // 120åˆ†é’Ÿè¶…æ—¶
            default:
                return new RegularSession(userId, 30); // 30åˆ†é’Ÿè¶…æ—¶
        }
    }
}
```

---

## 2. ğŸ‘¤ ç™»å½•æ€ç®¡ç†è§„èŒƒ


### 2.1 ç™»å½•æ€çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†


**ç™»å½•æ€å°±åƒèº«ä»½è¯**ï¼šæœ‰å‘æ”¾ã€ä½¿ç”¨ã€æ›´æ–°ã€æ³¨é”€çš„å®Œæ•´è¿‡ç¨‹

```
ç”¨æˆ·ç™»å½•æµç¨‹ï¼š
ç”¨æˆ·è¾“å…¥è´¦å·å¯†ç 
       â†“
   éªŒè¯ç”¨æˆ·èº«ä»½
       â†“
  åˆ›å»ºä¼šè¯(Session)
       â†“
   è¿”å›ä¼šè¯æ ‡è¯†
       â†“
  ç”¨æˆ·æºå¸¦æ ‡è¯†è®¿é—®
       â†“
    éªŒè¯ä¼šè¯æœ‰æ•ˆæ€§
       â†“
  [æœ‰æ•ˆ] â†’ å…è®¸è®¿é—®
  [æ— æ•ˆ] â†’ è·³è½¬ç™»å½•é¡µ
```

#### ğŸš€ ä¼šè¯åˆ›å»ºè§„èŒƒ


```java
public class LoginService {
    private SessionManager sessionManager = SessionManager.getInstance();
    
    public LoginResult login(String username, String password, HttpServletRequest request) {
        // 1. éªŒè¯ç”¨æˆ·åå¯†ç 
        User user = userService.authenticate(username, password);
        if (user == null) {
            return LoginResult.failed("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
        }
        
        // 2. æ£€æŸ¥è´¦æˆ·çŠ¶æ€
        if (!user.isActive()) {
            return LoginResult.failed("è´¦æˆ·å·²è¢«ç¦ç”¨");
        }
        
        // 3. åˆ›å»ºä¼šè¯
        HttpSession session = request.getSession(true);
        session.setAttribute("user", user);
        session.setAttribute("loginTime", new Date());
        session.setAttribute("loginIP", request.getRemoteAddr());
        
        // 4. è®¾ç½®ä¼šè¯è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
        session.setMaxInactiveInterval(30 * 60); // 30åˆ†é’Ÿ
        
        // 5. è®°å½•ç™»å½•æ—¥å¿—
        logService.recordLogin(user.getId(), request.getRemoteAddr());
        
        return LoginResult.success(session.getId());
    }
}
```

#### â° ä¼šè¯è¶…æ—¶å¤„ç†


**è¶…æ—¶ç­–ç•¥**ï¼š
- **å›ºå®šè¶…æ—¶**ï¼šç™»å½•åå›ºå®šæ—¶é—´å†…æœ‰æ•ˆ
- **æ»‘åŠ¨è¶…æ—¶**ï¼šæ¯æ¬¡è®¿é—®éƒ½é‡æ–°è®¡æ—¶
- **ç»å¯¹è¶…æ—¶**ï¼šæ— è®ºå¦‚ä½•éƒ½åœ¨æŒ‡å®šæ—¶é—´å¤±æ•ˆ

```java
// ä¼šè¯è¶…æ—¶æ£€æŸ¥æ‹¦æˆªå™¨
public class SessionTimeoutInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, 
                           Object handler) throws Exception {
        
        HttpSession session = request.getSession(false);
        
        if (session == null) {
            redirectToLogin(response);
            return false;
        }
        
        // æ£€æŸ¥ä¼šè¯æ˜¯å¦è¶…æ—¶
        Date loginTime = (Date) session.getAttribute("loginTime");
        Date lastAccessTime = (Date) session.getAttribute("lastAccessTime");
        
        if (isSessionExpired(loginTime, lastAccessTime)) {
            session.invalidate(); // é”€æ¯è¿‡æœŸä¼šè¯
            redirectToLogin(response);
            return false;
        }
        
        // æ›´æ–°æœ€åè®¿é—®æ—¶é—´ï¼ˆæ»‘åŠ¨è¶…æ—¶ï¼‰
        session.setAttribute("lastAccessTime", new Date());
        return true;
    }
    
    private boolean isSessionExpired(Date loginTime, Date lastAccessTime) {
        long maxInactiveTime = 30 * 60 * 1000; // 30åˆ†é’Ÿæ¯«ç§’æ•°
        Date checkTime = lastAccessTime != null ? lastAccessTime : loginTime;
        
        return System.currentTimeMillis() - checkTime.getTime() > maxInactiveTime;
    }
}
```

### 2.2 å¤šç»ˆç«¯ç™»å½•ç®¡ç†


**åœºæ™¯**ï¼šç”¨æˆ·å¯èƒ½åœ¨æ‰‹æœºã€ç”µè„‘ã€å¹³æ¿ä¸ŠåŒæ—¶ç™»å½•

#### ğŸ”„ ç™»å½•ç­–ç•¥é€‰æ‹©


| ç­–ç•¥ç±»å‹ | **æè¿°** | **é€‚ç”¨åœºæ™¯** | **ä¼˜ç¼ºç‚¹** |
|---------|----------|-------------|-----------|
| **å•ç‚¹ç™»å½•** | `åªå…è®¸ä¸€ä¸ªè®¾å¤‡ç™»å½•` | `é“¶è¡Œç³»ç»Ÿ` | `å®‰å…¨æ€§é«˜ï¼Œç”¨æˆ·ä½“éªŒå·®` |
| **å¤šç‚¹ç™»å½•** | `å…è®¸å¤šä¸ªè®¾å¤‡åŒæ—¶ç™»å½•` | `ç¤¾äº¤è½¯ä»¶` | `ç”¨æˆ·ä½“éªŒå¥½ï¼Œå®‰å…¨é£é™©é«˜` |
| **å—é™å¤šç™»** | `é™åˆ¶åŒæ—¶ç™»å½•è®¾å¤‡æ•°é‡` | `è§†é¢‘ç½‘ç«™` | `å¹³è¡¡å®‰å…¨ä¸ä½“éªŒ` |

```java
public class MultiDeviceLoginManager {
    // å­˜å‚¨ç”¨æˆ·çš„æ‰€æœ‰æ´»è·ƒä¼šè¯
    private Map<String, Set<String>> userSessions = new ConcurrentHashMap<>();
    
    public boolean handleLogin(String userId, String sessionId, String deviceType) {
        Set<String> sessions = userSessions.getOrDefault(userId, new HashSet<>());
        
        // æ ¹æ®ç­–ç•¥å¤„ç†
        switch (getLoginStrategy(userId)) {
            case SINGLE_LOGIN:
                // è¸¢æ‰å…¶ä»–è®¾å¤‡
                invalidateOtherSessions(userId, sessions);
                sessions.clear();
                break;
                
            case LIMITED_LOGIN:
                // é™åˆ¶æœ€å¤š3ä¸ªè®¾å¤‡
                if (sessions.size() >= 3) {
                    // è¸¢æ‰æœ€æ—©ç™»å½•çš„è®¾å¤‡
                    removeOldestSession(sessions);
                }
                break;
                
            case UNLIMITED_LOGIN:
                // ä¸é™åˆ¶
                break;
        }
        
        sessions.add(sessionId);
        userSessions.put(userId, sessions);
        return true;
    }
}
```

---

## 3. âš ï¸ å¼‚å¸¸å¤„ç†ç­–ç•¥


### 3.1 ä¼šè¯å¼‚å¸¸çš„åˆ†ç±»


#### ğŸš¨ å¸¸è§ä¼šè¯å¼‚å¸¸


```
ä¼šè¯å¼‚å¸¸åˆ†ç±»ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä¼šè¯ä¸å­˜åœ¨     â”‚ â† ç”¨æˆ·æœªç™»å½•æˆ–ä¼šè¯å·²è¿‡æœŸ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ä¼šè¯è¢«ç¯¡æ”¹     â”‚ â† SessionIDè¢«æ¶æ„ä¿®æ”¹
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  
â”‚   æƒé™ä¸è¶³       â”‚ â† ç”¨æˆ·è§’è‰²ä¸å¤Ÿè®¿é—®è¯¥èµ„æº
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   å¹¶å‘å†²çª       â”‚ â† å¤šä¸ªè¯·æ±‚åŒæ—¶ä¿®æ”¹ä¼šè¯
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ğŸ›¡ï¸ å¼‚å¸¸å¤„ç†åŸåˆ™


**å®‰å…¨ä¼˜å…ˆ**ï¼šé‡åˆ°å¼‚å¸¸æ—¶ï¼Œä¼˜å…ˆä¿æŠ¤ç³»ç»Ÿå®‰å…¨
**ç”¨æˆ·å‹å¥½**ï¼šç»™ç”¨æˆ·æ¸…æ™°çš„é”™è¯¯æç¤ºï¼Œä¸æš´éœ²æŠ€æœ¯ç»†èŠ‚
**æ—¥å¿—è®°å½•**ï¼šè¯¦ç»†è®°å½•å¼‚å¸¸ä¿¡æ¯ï¼Œæ–¹ä¾¿æ’æŸ¥é—®é¢˜

### 3.2 ç»Ÿä¸€å¼‚å¸¸å¤„ç†æœºåˆ¶


```java
// ä¼šè¯å¼‚å¸¸å¤„ç†å™¨
@ControllerAdvice
public class SessionExceptionHandler {
    
    // å¤„ç†ä¼šè¯è¿‡æœŸå¼‚å¸¸
    @ExceptionHandler(SessionExpiredException.class)
    public ModelAndView handleSessionExpired(SessionExpiredException e, 
                                           HttpServletRequest request) {
        
        // è®°å½•æ—¥å¿—
        logger.warn("ç”¨æˆ·ä¼šè¯è¿‡æœŸ: {}, IP: {}", e.getSessionId(), request.getRemoteAddr());
        
        // åˆ¤æ–­è¯·æ±‚ç±»å‹
        if (isAjaxRequest(request)) {
            // AJAXè¯·æ±‚è¿”å›JSON
            return JsonResponse.error("ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•", 401);
        } else {
            // æ™®é€šè¯·æ±‚è·³è½¬ç™»å½•é¡µ
            ModelAndView mv = new ModelAndView("redirect:/login");
            mv.addObject("message", "ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•");
            return mv;
        }
    }
    
    // å¤„ç†æƒé™ä¸è¶³å¼‚å¸¸
    @ExceptionHandler(InsufficientPermissionException.class)
    public ModelAndView handleInsufficientPermission(InsufficientPermissionException e,
                                                    HttpServletRequest request) {
        logger.warn("ç”¨æˆ·æƒé™ä¸è¶³: ç”¨æˆ·ID={}, è®¿é—®èµ„æº={}", 
                   e.getUserId(), request.getRequestURI());
        
        return new ModelAndView("error/403")
                .addObject("message", "æ‚¨æ²¡æœ‰æƒé™è®¿é—®è¯¥èµ„æº");
    }
}
```

### 3.3 ä¼šè¯å®‰å…¨é˜²æŠ¤


#### ğŸ”’ é˜²æ­¢Sessionå›ºå®šæ”»å‡»


```java
public class SessionSecurityManager {
    
    // ç™»å½•æˆåŠŸåé‡æ–°ç”ŸæˆSessionID
    public void regenerateSessionId(HttpServletRequest request) {
        HttpSession oldSession = request.getSession(false);
        if (oldSession != null) {
            // ä¿å­˜æ—§ä¼šè¯ä¸­çš„æ•°æ®
            Map<String, Object> attributes = new HashMap<>();
            Enumeration<String> names = oldSession.getAttributeNames();
            while (names.hasMoreElements()) {
                String name = names.nextElement();
                attributes.put(name, oldSession.getAttribute(name));
            }
            
            // é”€æ¯æ—§ä¼šè¯
            oldSession.invalidate();
            
            // åˆ›å»ºæ–°ä¼šè¯å¹¶æ¢å¤æ•°æ®
            HttpSession newSession = request.getSession(true);
            for (Map.Entry<String, Object> entry : attributes.entrySet()) {
                newSession.setAttribute(entry.getKey(), entry.getValue());
            }
        }
    }
}
```

#### ğŸ›¡ï¸ CSRFé˜²æŠ¤


**CSRF(è·¨ç«™è¯·æ±‚ä¼ªé€ )**ï¼šæ”»å‡»è€…è¯±å¯¼ç”¨æˆ·åœ¨å·²ç™»å½•çš„ç½‘ç«™ä¸Šæ‰§è¡Œéé¢„æœŸæ“ä½œ

```java
// CSRFä»¤ç‰Œç®¡ç†
public class CSRFTokenManager {
    
    // ç”ŸæˆCSRFä»¤ç‰Œ
    public String generateToken(HttpSession session) {
        String token = UUID.randomUUID().toString();
        session.setAttribute("csrfToken", token);
        return token;
    }
    
    // éªŒè¯CSRFä»¤ç‰Œ
    public boolean validateToken(HttpServletRequest request) {
        HttpSession session = request.getSession(false);
        if (session == null) return false;
        
        String sessionToken = (String) session.getAttribute("csrfToken");
        String requestToken = request.getParameter("csrfToken");
        
        return sessionToken != null && sessionToken.equals(requestToken);
    }
}
```

---

## 4. ğŸ”„ ä»£ç å¤ç”¨æŠ€å·§


### 4.1 ä¼šè¯å·¥å…·ç±»çš„è®¾è®¡


#### ğŸ› ï¸ SessionUtilså·¥å…·ç±»


**ä½œç”¨**ï¼šæŠŠå¸¸ç”¨çš„ä¼šè¯æ“ä½œå°è£…æˆå·¥å…·æ–¹æ³•ï¼Œé¿å…é‡å¤ä»£ç 

```java
// ä¼šè¯å·¥å…·ç±» - æä¾›å¸¸ç”¨ä¼šè¯æ“ä½œæ–¹æ³•
public class SessionUtils {
    
    /**
     * è·å–å½“å‰ç™»å½•ç”¨æˆ·
     * @param request HTTPè¯·æ±‚å¯¹è±¡
     * @return ç”¨æˆ·å¯¹è±¡ï¼Œæœªç™»å½•è¿”å›null
     */
    public static User getCurrentUser(HttpServletRequest request) {
        HttpSession session = request.getSession(false);
        if (session == null) {
            return null;
        }
        return (User) session.getAttribute("user");
    }
    
    /**
     * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
     * @param request HTTPè¯·æ±‚å¯¹è±¡
     * @return true-å·²ç™»å½•ï¼Œfalse-æœªç™»å½•
     */
    public static boolean isLoggedIn(HttpServletRequest request) {
        return getCurrentUser(request) != null;
    }
    
    /**
     * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æŒ‡å®šæƒé™
     * @param request HTTPè¯·æ±‚å¯¹è±¡  
     * @param permission æƒé™åç§°
     * @return true-æœ‰æƒé™ï¼Œfalse-æ— æƒé™
     */
    public static boolean hasPermission(HttpServletRequest request, String permission) {
        User user = getCurrentUser(request);
        if (user == null) {
            return false;
        }
        return user.getPermissions().contains(permission);
    }
    
    /**
     * å®‰å…¨é€€å‡ºç™»å½•
     * @param request HTTPè¯·æ±‚å¯¹è±¡
     */
    public static void logout(HttpServletRequest request) {
        HttpSession session = request.getSession(false);
        if (session != null) {
            // è®°å½•é€€å‡ºæ—¥å¿—
            User user = getCurrentUser(request);
            if (user != null) {
                LogUtils.recordLogout(user.getId());
            }
            
            // é”€æ¯ä¼šè¯
            session.invalidate();
        }
    }
}
```

### 4.2 æ³¨è§£é©±åŠ¨çš„æƒé™æ§åˆ¶


#### ğŸ·ï¸ è‡ªå®šä¹‰æƒé™æ³¨è§£


**ä¼˜åŠ¿**ï¼šä½¿ç”¨æ³¨è§£è®©æƒé™æ§åˆ¶æ›´ç®€æ´ï¼Œä»£ç æ›´æ˜“è¯»

```java
// æƒé™æ£€æŸ¥æ³¨è§£
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface RequireLogin {
    // æ˜¯å¦éœ€è¦ç™»å½•ï¼Œé»˜è®¤éœ€è¦
    boolean value() default true;
}

@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)  
public @interface RequirePermission {
    // éœ€è¦çš„æƒé™åç§°
    String[] value();
    // æƒé™å…³ç³»ï¼šAND(éƒ½éœ€è¦) æˆ– OR(ä»»ä¸€å³å¯)
    LogicType logic() default LogicType.AND;
}

// æƒé™é€»è¾‘ç±»å‹æšä¸¾
public enum LogicType {
    AND, OR
}
```

#### ğŸ¯ æ³¨è§£å¤„ç†å™¨ï¼ˆæ‹¦æˆªå™¨ï¼‰


```java
// æƒé™æ£€æŸ¥æ‹¦æˆªå™¨
public class PermissionInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, 
                           Object handler) throws Exception {
        
        // åªå¤„ç†Controlleræ–¹æ³•
        if (!(handler instanceof HandlerMethod)) {
            return true;
        }
        
        HandlerMethod handlerMethod = (HandlerMethod) handler;
        
        // æ£€æŸ¥ç™»å½•è¦æ±‚
        if (!checkLoginRequirement(handlerMethod, request, response)) {
            return false;
        }
        
        // æ£€æŸ¥æƒé™è¦æ±‚  
        if (!checkPermissionRequirement(handlerMethod, request, response)) {
            return false;
        }
        
        return true;
    }
    
    private boolean checkLoginRequirement(HandlerMethod handlerMethod, 
                                        HttpServletRequest request, 
                                        HttpServletResponse response) throws IOException {
        
        RequireLogin requireLogin = handlerMethod.getMethodAnnotation(RequireLogin.class);
        if (requireLogin == null) {
            requireLogin = handlerMethod.getBeanType().getAnnotation(RequireLogin.class);
        }
        
        // å¦‚æœéœ€è¦ç™»å½•ä½†ç”¨æˆ·æœªç™»å½•
        if (requireLogin != null && requireLogin.value() && !SessionUtils.isLoggedIn(request)) {
            response.sendRedirect("/login");
            return false;
        }
        
        return true;
    }
}
```

### 4.3 æ¨¡æ¿æ–¹æ³•æ¨¡å¼


**ä½œç”¨**ï¼šå®šä¹‰ä¼šè¯å¤„ç†çš„é€šç”¨æµç¨‹ï¼Œå…·ä½“æ­¥éª¤ç”±å­ç±»å®ç°

```java
// ä¼šè¯å¤„ç†æ¨¡æ¿
public abstract class SessionHandlerTemplate {
    
    // æ¨¡æ¿æ–¹æ³• - å®šä¹‰å¤„ç†æµç¨‹
    public final boolean handleSession(HttpServletRequest request, HttpServletResponse response) {
        try {
            // 1. ä¼šè¯é¢„å¤„ç†
            if (!preProcess(request, response)) {
                return false;
            }
            
            // 2. æ‰§è¡Œå…·ä½“ä¸šåŠ¡é€»è¾‘
            boolean result = doProcess(request, response);
            
            // 3. åå¤„ç†
            postProcess(request, response, result);
            
            return result;
            
        } catch (Exception e) {
            // 4. å¼‚å¸¸å¤„ç†
            handleException(request, response, e);
            return false;
        }
    }
    
    // é¢„å¤„ç† - å¯ä»¥è¢«å­ç±»é‡å†™
    protected boolean preProcess(HttpServletRequest request, HttpServletResponse response) {
        return SessionUtils.isLoggedIn(request);
    }
    
    // æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ - å¿…é¡»ç”±å­ç±»å®ç°
    protected abstract boolean doProcess(HttpServletRequest request, HttpServletResponse response);
    
    // åå¤„ç† - å¯ä»¥è¢«å­ç±»é‡å†™
    protected void postProcess(HttpServletRequest request, HttpServletResponse response, boolean result) {
        // é»˜è®¤ä»€ä¹ˆéƒ½ä¸åš
    }
    
    // å¼‚å¸¸å¤„ç† - å¯ä»¥è¢«å­ç±»é‡å†™
    protected void handleException(HttpServletRequest request, HttpServletResponse response, Exception e) {
        logger.error("ä¼šè¯å¤„ç†å¼‚å¸¸", e);
    }
}
```

---

## 5. ğŸ—ï¸ é¡¹ç›®æœ€ä½³å®è·µ


### 5.1 åˆ†å±‚æ¶æ„è®¾è®¡


#### ğŸ“Š ä¼šè¯ç®¡ç†åˆ†å±‚ç»“æ„


```
ä¼šè¯ç®¡ç†åˆ†å±‚æ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    è¡¨ç°å±‚(Webå±‚)     â”‚ â† Controllerã€Filterã€Interceptor
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ä¸šåŠ¡é€»è¾‘å±‚(Service) â”‚ â† ä¼šè¯ä¸šåŠ¡é€»è¾‘ã€æƒé™éªŒè¯
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  
â”‚   æ•°æ®è®¿é—®å±‚(DAO)    â”‚ â† ç”¨æˆ·æ•°æ®ã€ä¼šè¯æ•°æ®æŒä¹…åŒ–
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   å·¥å…·å±‚(Utils)     â”‚ â† SessionUtilsã€SecurityUtils
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ğŸ¯ æœ€ä½³å®è·µåŸåˆ™


**å•ä¸€èŒè´£**ï¼šæ¯ä¸ªç±»åªè´Ÿè´£ä¸€ä¸ªæ–¹é¢çš„åŠŸèƒ½
**ä¾èµ–æ³¨å…¥**ï¼šä½¿ç”¨Springç­‰æ¡†æ¶ç®¡ç†å¯¹è±¡ä¾èµ–
**é…ç½®å¤–éƒ¨åŒ–**ï¼šæŠŠä¼šè¯é…ç½®æ”¾åœ¨å¤–éƒ¨é…ç½®æ–‡ä»¶ä¸­

```java
// ä¼šè¯é…ç½®ç±»
@ConfigurationProperties(prefix = "app.session")
@Component
public class SessionConfig {
    
    // ä¼šè¯è¶…æ—¶æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
    private int timeout = 30;
    
    // æ˜¯å¦å…è®¸å¤šè®¾å¤‡ç™»å½•
    private boolean allowMultipleLogin = false;
    
    // æœ€å¤§åŒæ—¶ç™»å½•è®¾å¤‡æ•°
    private int maxLoginDevices = 3;
    
    // æ˜¯å¦å¯ç”¨è®°ä½æˆ‘åŠŸèƒ½
    private boolean enableRememberMe = true;
    
    // è®°ä½æˆ‘æœ‰æ•ˆæœŸï¼ˆå¤©ï¼‰
    private int rememberMeDays = 7;
    
    // getterå’Œsetteræ–¹æ³•...
}
```

### 5.2 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


#### âš¡ ä¼šè¯æ•°æ®ä¼˜åŒ–


**é—®é¢˜**ï¼šåœ¨Sessionä¸­å­˜å‚¨å¤§é‡æ•°æ®ä¼šå ç”¨æœåŠ¡å™¨å†…å­˜

**è§£å†³æ–¹æ¡ˆ**ï¼š
- åªå­˜å‚¨å¿…è¦çš„ç”¨æˆ·ä¿¡æ¯
- å¤§æ•°æ®æ”¾å…¥ç¼“å­˜æˆ–æ•°æ®åº“
- ä½¿ç”¨æ‡’åŠ è½½è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯

```java
// è½»é‡çº§ç”¨æˆ·ä¼šè¯å¯¹è±¡
public class UserSessionInfo {
    private Long userId;           // ç”¨æˆ·ID
    private String username;       // ç”¨æˆ·å  
    private String userType;       // ç”¨æˆ·ç±»å‹
    private Set<String> roles;     // ç”¨æˆ·è§’è‰²
    private Date loginTime;        // ç™»å½•æ—¶é—´
    
    // ä¸å­˜å‚¨å®Œæ•´çš„ç”¨æˆ·å¯¹è±¡ï¼Œéœ€è¦æ—¶å†æŸ¥è¯¢
    public User getFullUserInfo() {
        return userService.getUserById(this.userId);
    }
}
```

#### ğŸ—„ï¸ ä¼šè¯å­˜å‚¨é€‰æ‹©


| å­˜å‚¨æ–¹å¼ | **ä¼˜ç‚¹** | **ç¼ºç‚¹** | **é€‚ç”¨åœºæ™¯** |
|---------|---------|---------|-------------|
| **å†…å­˜å­˜å‚¨** | `é€Ÿåº¦å¿«ï¼Œå®ç°ç®€å•` | `é‡å¯ä¸¢å¤±ï¼Œä¸æ”¯æŒé›†ç¾¤` | `å•æœºåº”ç”¨ï¼Œå¼€å‘æµ‹è¯•` |
| **æ•°æ®åº“å­˜å‚¨** | `æ•°æ®æŒä¹…ï¼Œæ”¯æŒé›†ç¾¤` | `é€Ÿåº¦ç›¸å¯¹æ…¢ï¼ŒDBå‹åŠ›å¤§` | `å°å‹åˆ†å¸ƒå¼åº”ç”¨` |
| **Rediså­˜å‚¨** | `é€Ÿåº¦å¿«ï¼Œæ”¯æŒé›†ç¾¤` | `éœ€è¦é¢å¤–ç»„ä»¶ï¼Œæœ‰å­¦ä¹ æˆæœ¬` | `å¤§å‹åˆ†å¸ƒå¼åº”ç”¨` |

### 5.3 å®‰å…¨æœ€ä½³å®è·µ


#### ğŸ” ä¼šè¯å®‰å…¨æ£€æŸ¥æ¸…å•


> âœ… **ä¼šè¯åˆ›å»ºå®‰å…¨**
> - ç™»å½•æˆåŠŸåé‡æ–°ç”ŸæˆSessionID
> - è®¾ç½®åˆé€‚çš„ä¼šè¯è¶…æ—¶æ—¶é—´
> - è®°å½•ç™»å½•IPå’Œæ—¶é—´

> âœ… **ä¼šè¯ä¼ è¾“å®‰å…¨** 
> - ä½¿ç”¨HTTPSä¼ è¾“SessionID
> - è®¾ç½®Cookieçš„HttpOnlyå±æ€§
> - è®¾ç½®Cookieçš„Secureå±æ€§

> âœ… **ä¼šè¯å­˜å‚¨å®‰å…¨**
> - ä¸åœ¨Sessionä¸­å­˜å‚¨æ•æ„Ÿä¿¡æ¯
> - å®šæœŸæ¸…ç†è¿‡æœŸä¼šè¯
> - ç›‘æ§å¼‚å¸¸ä¼šè¯è¡Œä¸º

```java
// å®‰å…¨çš„Session Cookieé…ç½®
@Configuration
public class SessionSecurityConfig {
    
    @Bean
    public CookieSerializer cookieSerializer() {
        DefaultCookieSerializer serializer = new DefaultCookieSerializer();
        
        // è®¾ç½®Cookieåç§°
        serializer.setCookieName("JSESSIONID");
        
        // é˜²æ­¢XSSæ”»å‡» - JavaScriptæ— æ³•è®¿é—®Cookie
        serializer.setUseHttpOnlyCookies(true);
        
        // HTTPSç¯å¢ƒä¸‹æ‰ä¼ è¾“Cookie
        serializer.setUseSecureCookies(true);
        
        // é˜²æ­¢CSRFæ”»å‡» - é™åˆ¶è·¨ç«™è¯·æ±‚æºå¸¦Cookie
        serializer.setSameSite("Strict");
        
        // è®¾ç½®Cookieè·¯å¾„
        serializer.setCookiePath("/");
        
        return serializer;
    }
}
```

### 5.4 ç›‘æ§ä¸æ—¥å¿—


#### ğŸ“Š ä¼šè¯ç›‘æ§æŒ‡æ ‡


**å…³é”®æŒ‡æ ‡**ï¼š
- **åœ¨çº¿ç”¨æˆ·æ•°**ï¼šå½“å‰æ´»è·ƒä¼šè¯æ•°é‡
- **ç™»å½•å¤±è´¥ç‡**ï¼šç™»å½•å¤±è´¥æ¬¡æ•°/æ€»ç™»å½•æ¬¡æ•°
- **ä¼šè¯è¶…æ—¶ç‡**ï¼šå› è¶…æ—¶è¢«é”€æ¯çš„ä¼šè¯æ¯”ä¾‹
- **å¼‚å¸¸ä¼šè¯æ•°**ï¼šæ£€æµ‹åˆ°çš„å¯ç–‘ä¼šè¯æ•°é‡

```java
// ä¼šè¯ç›‘æ§æœåŠ¡
@Service
public class SessionMonitorService {
    
    // è·å–åœ¨çº¿ç”¨æˆ·ç»Ÿè®¡
    public SessionStatistics getOnlineStatistics() {
        SessionStatistics stats = new SessionStatistics();
        
        // ç»Ÿè®¡å½“å‰åœ¨çº¿ç”¨æˆ·æ•°
        stats.setOnlineUserCount(sessionManager.getActiveSessionCount());
        
        // ç»Ÿè®¡ä¸åŒç±»å‹ç”¨æˆ·æ•°é‡
        stats.setAdminCount(sessionManager.getSessionCountByRole("ADMIN"));
        stats.setRegularUserCount(sessionManager.getSessionCountByRole("USER"));
        
        // ç»Ÿè®¡ä»Šæ—¥ç™»å½•æ¬¡æ•°
        stats.setTodayLoginCount(loginLogService.getTodayLoginCount());
        
        return stats;
    }
    
    // æ£€æµ‹å¼‚å¸¸ä¼šè¯
    @Scheduled(fixedDelay = 300000) // æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    public void detectAbnormalSessions() {
        List<String> suspiciousSessions = sessionManager.findSuspiciousSessions();
        
        for (String sessionId : suspiciousSessions) {
            logger.warn("æ£€æµ‹åˆ°å¯ç–‘ä¼šè¯: {}", sessionId);
            
            // å¯ä»¥é€‰æ‹©å¼ºåˆ¶ä¸‹çº¿æˆ–è€…æ ‡è®°è§‚å¯Ÿ
            sessionManager.markSessionSuspicious(sessionId);
        }
    }
}
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 è®¾è®¡æ¨¡å¼åº”ç”¨è¦ç‚¹


```
ğŸ¯ æ ¸å¿ƒè®¾è®¡æ¨¡å¼è®°å¿†ï¼š
ğŸ”¸ å•ä¾‹æ¨¡å¼ï¼šä¸€ä¸ªåº”ç”¨ä¸€ä¸ªä¼šè¯ç®¡ç†å™¨
ğŸ”¸ ç­–ç•¥æ¨¡å¼ï¼šä¸åŒåœºæ™¯ä¸åŒéªŒè¯ç­–ç•¥  
ğŸ”¸ å·¥å‚æ¨¡å¼ï¼šæ ¹æ®ç”¨æˆ·ç±»å‹åˆ›å»ºä¸åŒä¼šè¯
ğŸ”¸ æ¨¡æ¿æ¨¡å¼ï¼šç»Ÿä¸€ä¼šè¯å¤„ç†æµç¨‹æ¡†æ¶
```

### 6.2 å¼€å‘è§„èŒƒè¦ç‚¹


**ä¼šè¯åˆ›å»ºè§„èŒƒ**ï¼š
- éªŒè¯ç”¨æˆ·èº«ä»½åå†åˆ›å»ºä¼šè¯
- è®¾ç½®åˆé€‚çš„è¶…æ—¶æ—¶é—´
- è®°å½•å¿…è¦çš„å®‰å…¨ä¿¡æ¯ï¼ˆIPã€æ—¶é—´ï¼‰
- ç™»å½•æˆåŠŸåé‡æ–°ç”ŸæˆSessionID

**å¼‚å¸¸å¤„ç†è§„èŒƒ**ï¼š
- ç»Ÿä¸€å¼‚å¸¸å¤„ç†æœºåˆ¶
- åŒºåˆ†AJAXå’Œæ™®é€šè¯·æ±‚çš„å“åº”æ–¹å¼
- è¯¦ç»†çš„æ—¥å¿—è®°å½•
- ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º

**å®‰å…¨é˜²æŠ¤è§„èŒƒ**ï¼š
- é˜²æ­¢Sessionå›ºå®šæ”»å‡»
- å®æ–½CSRFé˜²æŠ¤æœºåˆ¶
- åˆç†çš„æƒé™éªŒè¯
- å®‰å…¨çš„Cookieé…ç½®

### 6.3 æ€§èƒ½ä¼˜åŒ–è¦ç‚¹


**å†…å­˜ä¼˜åŒ–**ï¼š
- Sessionä¸­åªå­˜å‚¨å¿…è¦ä¿¡æ¯
- åŠæ—¶æ¸…ç†è¿‡æœŸä¼šè¯
- ä½¿ç”¨è½»é‡çº§ä¼šè¯å¯¹è±¡

**å­˜å‚¨é€‰æ‹©**ï¼š
- å•æœºåº”ç”¨ï¼šå†…å­˜å­˜å‚¨
- å°å‹åˆ†å¸ƒå¼ï¼šæ•°æ®åº“å­˜å‚¨
- å¤§å‹åˆ†å¸ƒå¼ï¼šRedisç­‰ç¼“å­˜å­˜å‚¨

### 6.4 å®é™…é¡¹ç›®åº”ç”¨å»ºè®®


**å°å‹é¡¹ç›®**ï¼š
- ä½¿ç”¨å†…ç½®Sessionç®¡ç†
- ç®€å•çš„æƒé™æ§åˆ¶
- åŸºæœ¬çš„å¼‚å¸¸å¤„ç†

**ä¸­å‹é¡¹ç›®**ï¼š
- è‡ªå®šä¹‰ä¼šè¯ç®¡ç†å™¨
- æ³¨è§£é©±åŠ¨çš„æƒé™æ§åˆ¶
- å®Œå–„çš„å¼‚å¸¸å¤„ç†æœºåˆ¶

**å¤§å‹é¡¹ç›®**ï¼š
- åˆ†å¸ƒå¼ä¼šè¯ç®¡ç†
- ç»†ç²’åº¦æƒé™æ§åˆ¶
- å®Œæ•´çš„ç›‘æ§å’Œæ—¥å¿—ç³»ç»Ÿ

### 6.5 å¼€å‘å»ºè®®


> ğŸ’¡ **æ–°æ‰‹èµ·æ­¥å»ºè®®**ï¼š
> 1. å…ˆæŒæ¡åŸºæœ¬çš„Session APIä½¿ç”¨
> 2. ç†è§£ä¼šè¯çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†
> 3. å­¦ä¼šåŸºæœ¬çš„æƒé™æ§åˆ¶å®ç°
> 4. é€æ­¥å­¦ä¹ é«˜çº§çš„è®¾è®¡æ¨¡å¼åº”ç”¨

> âš ï¸ **å¸¸è§è¯¯åŒºæé†’**ï¼š
> - ä¸è¦åœ¨Sessionä¸­å­˜å‚¨å¤§é‡æ•°æ®
> - ä¸è¦å¿½è§†ä¼šè¯çš„å®‰å…¨é…ç½®
> - ä¸è¦å¿˜è®°å¤„ç†ä¼šè¯è¶…æ—¶æƒ…å†µ
> - ä¸è¦è¿‡åº¦è®¾è®¡ï¼Œæ ¹æ®é¡¹ç›®éœ€æ±‚é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆ

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- è®¾è®¡æ¨¡å¼å·§åº”ç”¨ï¼Œä»£ç å¤ç”¨å¥½ç»´æŠ¤
- å®‰å…¨ç¬¬ä¸€è¦è®°ç‰¢ï¼Œå¼‚å¸¸å¤„ç†ä¸èƒ½å°‘  
- æ€§èƒ½ä¼˜åŒ–çœ‹åœºæ™¯ï¼Œç›‘æ§æ—¥å¿—åŠ©æ’æŸ¥
- ç®€å•é¡¹ç›®ç®€å•åšï¼Œå¤æ‚é¡¹ç›®éœ€æ¶æ„