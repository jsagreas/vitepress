---
title: 2ã€åˆ†å¸ƒå¼è®¤è¯æ–¹æ¡ˆ
---
## ğŸ“š ç›®å½•

1. [åˆ†å¸ƒå¼è®¤è¯åŸºç¡€æ¦‚å¿µ](#1-åˆ†å¸ƒå¼è®¤è¯åŸºç¡€æ¦‚å¿µ)
2. [åˆ†å¸ƒå¼Tokenç®¡ç†](#2-åˆ†å¸ƒå¼Tokenç®¡ç†)
3. [è®¤è¯æœåŠ¡è®¾è®¡](#3-è®¤è¯æœåŠ¡è®¾è®¡)
4. [æƒé™æœåŠ¡åˆ†ç¦»](#4-æƒé™æœåŠ¡åˆ†ç¦»)
5. [ç¼“å­˜ç­–ç•¥ä¼˜åŒ–](#5-ç¼“å­˜ç­–ç•¥ä¼˜åŒ–)
6. [é«˜å¯ç”¨ä¿éšœ](#6-é«˜å¯ç”¨ä¿éšœ)
7. [å®æˆ˜æ¡ˆä¾‹åˆ†æ](#7-å®æˆ˜æ¡ˆä¾‹åˆ†æ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ åˆ†å¸ƒå¼è®¤è¯åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼è®¤è¯


**ğŸ  ç”Ÿæ´»ç±»æ¯”**
> æƒ³è±¡ä¸€ä¸ªå¤§å‹å•†åœºï¼Œæœ‰å¾ˆå¤šä¸åŒçš„åº—é“ºã€‚ä¼ ç»Ÿè®¤è¯å°±åƒæ¯ä¸ªåº—é“ºéƒ½æœ‰è‡ªå·±çš„ä¼šå‘˜å¡ï¼Œä½ éœ€è¦åŠå¾ˆå¤šå¼ å¡ã€‚è€Œåˆ†å¸ƒå¼è®¤è¯å°±åƒæœ‰ä¸€å¼ é€šç”¨çš„å•†åœºVIPå¡ï¼Œå‡­è¿™å¼ å¡å¯ä»¥åœ¨æ‰€æœ‰åº—é“ºäº«å—æœåŠ¡ã€‚

**æ ¸å¿ƒå®šä¹‰**
```
åˆ†å¸ƒå¼è®¤è¯ï¼šåœ¨å¤šä¸ªç‹¬ç«‹çš„æœåŠ¡ç³»ç»Ÿä¸­ï¼Œç”¨æˆ·åªéœ€è¦ç™»å½•ä¸€æ¬¡
å°±èƒ½è®¿é—®æ‰€æœ‰æœ‰æƒé™çš„æœåŠ¡ï¼Œæ— éœ€é‡å¤è®¤è¯

å…³é”®ç‰¹ç‚¹ï¼š
âœ… ä¸€æ¬¡ç™»å½•ï¼Œåˆ°å¤„é€šè¡Œ
âœ… ç»Ÿä¸€èº«ä»½ç®¡ç†
âœ… æœåŠ¡é—´ä¿¡ä»»ä¼ é€’
âœ… æƒé™ç»Ÿä¸€æ§åˆ¶
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼è®¤è¯


**ä¼ ç»Ÿå•ä½“åº”ç”¨ vs åˆ†å¸ƒå¼ç³»ç»Ÿå¯¹æ¯”**

```
ä¼ ç»Ÿå•ä½“åº”ç”¨ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    ç”¨æˆ·ç™»å½•ç•Œé¢         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    Sessionå­˜å‚¨          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç”¨æˆ·ç®¡ç† | å•†å“ | è®¢å•  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
é—®é¢˜ï¼šæ‰€æœ‰åŠŸèƒ½è€¦åˆåœ¨ä¸€èµ·

åˆ†å¸ƒå¼å¾®æœåŠ¡ï¼š
ç”¨æˆ· â†’ è®¤è¯ä¸­å¿ƒ â†’ ç”¨æˆ·æœåŠ¡
              â†’ å•†å“æœåŠ¡  
              â†’ è®¢å•æœåŠ¡
              â†’ æ”¯ä»˜æœåŠ¡
```

**é¢ä¸´çš„æŒ‘æˆ˜**
- **ğŸ”¸ æœåŠ¡ç‹¬ç«‹**ï¼šæ¯ä¸ªæœåŠ¡éƒ½æ˜¯ç‹¬ç«‹éƒ¨ç½²çš„åº”ç”¨
- **ğŸ”¸ æ— æ³•å…±äº«Session**ï¼šä¸åŒæœåŠ¡å™¨é—´Sessionæ— æ³•å…±äº«
- **ğŸ”¸ é‡å¤ç™»å½•**ï¼šç”¨æˆ·å¯èƒ½éœ€è¦åœ¨æ¯ä¸ªæœåŠ¡ä¸­é‡æ–°ç™»å½•
- **ğŸ”¸ æƒé™åˆ†æ•£**ï¼šæƒé™æ§åˆ¶åˆ†æ•£åœ¨å„ä¸ªæœåŠ¡ä¸­

### 1.3 åˆ†å¸ƒå¼è®¤è¯çš„æ ¸å¿ƒæ€è·¯


**ğŸ’¡ å…³é”®æ´å¯Ÿ**
> æŠŠ"èº«ä»½è¯æ˜"å’Œ"æƒé™è¯æ˜"ä»å…·ä½“çš„æœåŠ¡ä¸­æŠ½ç¦»å‡ºæ¥ï¼Œå˜æˆå¯ä»¥åœ¨æœåŠ¡é—´ä¼ é€’çš„"é€šè¡Œè¯"

**è§£å†³æ–¹æ¡ˆå¯¹æ¯”**

| æ–¹æ¡ˆç±»å‹ | **å®ç°æ–¹å¼** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** | **é€‚ç”¨åœºæ™¯** |
|---------|-------------|---------|---------|-------------|
| ğŸ« **Tokenæ–¹æ¡ˆ** | `JWTã€OAuthç­‰æ— çŠ¶æ€Token` | `æ— éœ€æœåŠ¡å™¨å­˜å‚¨ï¼Œå¯è·¨åŸŸ` | `Tokenè¾ƒå¤§ï¼Œéš¾ä»¥æ’¤é”€` | `å¾®æœåŠ¡æ¶æ„` |
| ğŸª **Sessionå…±äº«** | `Redisç­‰å…±äº«å­˜å‚¨` | `ä¼ ç»Ÿæ–¹å¼ï¼Œæ˜“ç†è§£` | `éœ€è¦å…±äº«å­˜å‚¨ï¼Œæœ‰çŠ¶æ€` | `ä¼ ç»Ÿå‡çº§æ”¹é€ ` |
| ğŸŒŸ **ç»Ÿä¸€è®¤è¯ä¸­å¿ƒ** | `SSOå•ç‚¹ç™»å½•` | `ç»Ÿä¸€ç®¡ç†ï¼Œå®‰å…¨æ€§é«˜` | `å®ç°å¤æ‚ï¼Œå•ç‚¹æ•…éšœ` | `ä¼ä¸šçº§åº”ç”¨` |

---

## 2. ğŸ¯ åˆ†å¸ƒå¼Tokenç®¡ç†


### 2.1 Tokenè®¤è¯åŸç†æ·±å…¥è§£æ


**ğŸ” Tokenå·¥ä½œæµç¨‹**
```
ç”¨æˆ·ç™»å½•æµç¨‹ï¼š
å®¢æˆ·ç«¯                è®¤è¯æœåŠ¡å™¨              ä¸šåŠ¡æœåŠ¡å™¨
   |                      |                     |
   |--[1]ç”¨æˆ·åå¯†ç ------->|                     |
   |                      |--éªŒè¯ç”¨æˆ·ä¿¡æ¯       |
   |                      |                     |
   |<----[2]è¿”å›Token-----|                     |
   |                      |                     |
   |--[3]æºå¸¦Tokenè¯·æ±‚------------------->|
   |                      |              |--éªŒè¯Token
   |                      |              |
   |<----[4]è¿”å›ä¸šåŠ¡æ•°æ®------------------|
```

**Tokençš„æœ¬è´¨ç†è§£**
- **ğŸ« èº«ä»½å‡­è¯**ï¼šè¯æ˜"ä½ æ˜¯è°"
- **ğŸ“œ æƒé™è¯æ˜**ï¼šè¯´æ˜"ä½ èƒ½åšä»€ä¹ˆ"  
- **â° æ—¶æ•ˆæ§åˆ¶**ï¼šé™åˆ¶"æœ‰æ•ˆæœŸå¤šä¹…"
- **ğŸ”’ é˜²ä¼ªæ ‡è¯†**ï¼šç¡®ä¿"æ— æ³•ä¼ªé€ "

### 2.2 JWT Tokenè¯¦è§£


**ğŸ”¸ JWTç»“æ„ç»„æˆ**
```
JWT Tokenç»„æˆï¼šHeader.Payload.Signature

å®é™…ä¾‹å­ï¼š
eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.
eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.
SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c

Headeréƒ¨åˆ†ï¼ˆå¤´éƒ¨ä¿¡æ¯ï¼‰ï¼š
{
  "typ": "JWT",      // Tokenç±»å‹
  "alg": "HS256"     // åŠ å¯†ç®—æ³•
}

Payloadéƒ¨åˆ†ï¼ˆè½½è·æ•°æ®ï¼‰ï¼š
{
  "sub": "1234567890",           // ç”¨æˆ·ID
  "name": "John Doe",            // ç”¨æˆ·å§“å
  "iat": 1516239022,            // ç­¾å‘æ—¶é—´
  "exp": 1516325422,            // è¿‡æœŸæ—¶é—´
  "role": ["admin", "user"]      // ç”¨æˆ·è§’è‰²
}

Signatureéƒ¨åˆ†ï¼ˆç­¾åï¼‰ï¼š
HMACSHA256(
  base64UrlEncode(header) + "." +
  base64UrlEncode(payload),
  secret)
```

**JWTå®ç°ç¤ºä¾‹**
```java
// JWTå·¥å…·ç±» - ç®€åŒ–ç‰ˆå®ç°
public class JwtUtil {
    private static final String SECRET = "mySecret123";
    private static final long EXPIRATION = 24 * 60 * 60 * 1000; // 24å°æ—¶
    
    // ç”ŸæˆToken
    public static String generateToken(User user) {
        return Jwts.builder()
            .setSubject(user.getId().toString())
            .claim("username", user.getUsername())
            .claim("roles", user.getRoles())
            .setIssuedAt(new Date())
            .setExpiration(new Date(System.currentTimeMillis() + EXPIRATION))
            .signWith(SignatureAlgorithm.HS256, SECRET)
            .compact();
    }
    
    // è§£æToken
    public static Claims parseToken(String token) {
        return Jwts.parser()
            .setSigningKey(SECRET)
            .parseClaimsJws(token)
            .getBody();
    }
    
    // éªŒè¯Tokenæ˜¯å¦æœ‰æ•ˆ
    public static boolean isTokenValid(String token) {
        try {
            Claims claims = parseToken(token);
            return !claims.getExpiration().before(new Date());
        } catch (Exception e) {
            return false;
        }
    }
}
```

### 2.3 Tokençš„ä¼ é€’æ–¹å¼


**ğŸ“‹ å¸¸ç”¨ä¼ é€’æ–¹å¼å¯¹æ¯”**

| ä¼ é€’æ–¹å¼ | **æ ¼å¼ç¤ºä¾‹** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** | **ä½¿ç”¨åœºæ™¯** |
|---------|-------------|---------|---------|-------------|
| ğŸ”— **Headerä¼ é€’** | `Authorization: Bearer token123` | `æ ‡å‡†åŒ–ï¼Œæ”¯æŒè·¨åŸŸ` | `éœ€è¦å‰ç«¯å¤„ç†` | `APIæ¥å£è°ƒç”¨` |
| ğŸª **Cookieä¼ é€’** | `Cookie: token=token123` | `æµè§ˆå™¨è‡ªåŠ¨æºå¸¦` | `è·¨åŸŸé™åˆ¶` | `Webåº”ç”¨` |
| ğŸ“ **å‚æ•°ä¼ é€’** | `?token=token123` | `ç®€å•ç›´æ¥` | `å®‰å…¨æ€§å·®` | `ç‰¹æ®Šåœºæ™¯` |

**ğŸš€ æ¨èå®ç°æ–¹å¼**
```java
// å‰ç«¯è¯·æ±‚ç¤ºä¾‹
fetch('/api/users', {
    headers: {
        'Authorization': 'Bearer ' + localStorage.getItem('token'),
        'Content-Type': 'application/json'
    }
});

// åç«¯æ‹¦æˆªå™¨è§£æ
@Component
public class TokenInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler) {
        
        // è·å–Token
        String token = request.getHeader("Authorization");
        if (token != null && token.startsWith("Bearer ")) {
            token = token.substring(7); // ç§»é™¤"Bearer "å‰ç¼€
        }
        
        // éªŒè¯Token
        if (JwtUtil.isTokenValid(token)) {
            // Tokenæœ‰æ•ˆï¼Œç»§ç»­å¤„ç†
            return true;
        } else {
            // Tokenæ— æ•ˆï¼Œè¿”å›401
            response.setStatus(401);
            return false;
        }
    }
}
```

---

## 3. ğŸ—ï¸ è®¤è¯æœåŠ¡è®¾è®¡


### 3.1 è®¤è¯ä¸­å¿ƒæ¶æ„è®¾è®¡


**ğŸŒŸ ç»Ÿä¸€è®¤è¯ä¸­å¿ƒæ¶æ„å›¾**
```
                    è®¤è¯ä¸­å¿ƒ (Auth Center)
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   ç™»å½•æ¥å£          â”‚
                    â”‚   Tokenç”Ÿæˆ         â”‚
                    â”‚   ç”¨æˆ·éªŒè¯          â”‚
                    â”‚   æƒé™æŸ¥è¯¢          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                     â”‚                     â”‚
   ç”¨æˆ·æœåŠ¡              å•†å“æœåŠ¡              è®¢å•æœåŠ¡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚TokenéªŒè¯    â”‚    â”‚TokenéªŒè¯    â”‚    â”‚TokenéªŒè¯    â”‚
â”‚æƒé™æ£€æŸ¥    â”‚    â”‚æƒé™æ£€æŸ¥    â”‚    â”‚æƒé™æ£€æŸ¥    â”‚
â”‚ä¸šåŠ¡é€»è¾‘    â”‚    â”‚ä¸šåŠ¡é€»è¾‘    â”‚    â”‚ä¸šåŠ¡é€»è¾‘    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è®¤è¯ä¸­å¿ƒæ ¸å¿ƒåŠŸèƒ½**
- **ğŸ” ç”¨æˆ·è®¤è¯**ï¼šéªŒè¯ç”¨æˆ·åå¯†ç ï¼Œç”ŸæˆToken
- **ğŸ« Tokenç®¡ç†**ï¼šç”Ÿæˆã€éªŒè¯ã€åˆ·æ–°Token
- **ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯**ï¼šæä¾›ç”¨æˆ·åŸºæœ¬ä¿¡æ¯æŸ¥è¯¢
- **ğŸ”‘ æƒé™æŸ¥è¯¢**ï¼šæä¾›ç”¨æˆ·æƒé™ä¿¡æ¯æ¥å£

### 3.2 è®¤è¯æœåŠ¡æ¥å£è®¾è®¡


**æ ¸å¿ƒAPIæ¥å£è®¾è®¡**
```java
@RestController
@RequestMapping("/auth")
public class AuthController {
    
    @Autowired
    private AuthService authService;
    
    // ç”¨æˆ·ç™»å½•
    @PostMapping("/login")
    public ResponseEntity<?> login(@RequestBody LoginRequest request) {
        // éªŒè¯ç”¨æˆ·åå¯†ç 
        User user = authService.authenticate(
            request.getUsername(), 
            request.getPassword()
        );
        
        if (user != null) {
            // ç”ŸæˆToken
            String token = JwtUtil.generateToken(user);
            
            return ResponseEntity.ok(new LoginResponse(
                token, 
                user.getUsername(), 
                user.getRoles()
            ));
        } else {
            return ResponseEntity.status(401)
                .body(new ErrorResponse("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"));
        }
    }
    
    // TokenéªŒè¯
    @PostMapping("/verify")
    public ResponseEntity<?> verifyToken(@RequestBody TokenRequest request) {
        String token = request.getToken();
        
        if (JwtUtil.isTokenValid(token)) {
            Claims claims = JwtUtil.parseToken(token);
            return ResponseEntity.ok(new TokenInfo(
                claims.getSubject(),
                claims.get("username", String.class),
                claims.get("roles", List.class)
            ));
        } else {
            return ResponseEntity.status(401)
                .body(new ErrorResponse("Tokenæ— æ•ˆ"));
        }
    }
    
    // åˆ·æ–°Token
    @PostMapping("/refresh")
    public ResponseEntity<?> refreshToken(@RequestBody RefreshRequest request) {
        // å®ç°Tokenåˆ·æ–°é€»è¾‘
        // ...
    }
}
```

### 3.3 è®¤è¯æœåŠ¡çš„éƒ¨ç½²ç­–ç•¥


**ğŸ’¡ éƒ¨ç½²è€ƒè™‘å› ç´ **

::: tip éƒ¨ç½²ç­–ç•¥é€‰æ‹©
- **ç‹¬ç«‹éƒ¨ç½²**ï¼šè®¤è¯æœåŠ¡ä½œä¸ºç‹¬ç«‹çš„å¾®æœåŠ¡éƒ¨ç½²
- **é«˜å¯ç”¨**ï¼šè‡³å°‘éƒ¨ç½²2ä¸ªå®ä¾‹ï¼Œé¿å…å•ç‚¹æ•…éšœ  
- **æ•°æ®åº“**ï¼šç”¨æˆ·ä¿¡æ¯å­˜å‚¨éœ€è¦è€ƒè™‘å®‰å…¨æ€§
- **ç¼“å­˜**ï¼šTokenéªŒè¯ç»“æœå¯ä»¥ç¼“å­˜æå‡æ€§èƒ½
:::

**éƒ¨ç½²æ¶æ„ç¤ºæ„**
```
è´Ÿè½½å‡è¡¡å™¨ (Nginx/LB)
           |
    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
    â”‚             â”‚
è®¤è¯æœåŠ¡A     è®¤è¯æœåŠ¡B
    â”‚             â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚
    ç”¨æˆ·æ•°æ®åº“ (MySQL)
           â”‚
    ç¼“å­˜æœåŠ¡ (Redis)
```

---

## 4. ğŸ” æƒé™æœåŠ¡åˆ†ç¦»


### 4.1 æƒé™æ¨¡å‹è®¾è®¡


**ğŸ  æƒé™ç†è§£ç±»æ¯”**
> æƒ³è±¡å…¬å¸çš„é—¨ç¦ç³»ç»Ÿï¼šä½ çš„å‘˜å·¥å¡ï¼ˆèº«ä»½è®¤è¯ï¼‰è¯æ˜ä½ æ˜¯å…¬å¸å‘˜å·¥ï¼Œä½†å…·ä½“èƒ½è¿›å“ªäº›åŠå…¬å®¤ï¼ˆæƒé™æ§åˆ¶ï¼‰åˆ™éœ€è¦é¢å¤–çš„æƒé™è®¾ç½®ã€‚

**RBACæƒé™æ¨¡å‹**
```
ç”¨æˆ· (User) â†’ è§’è‰² (Role) â†’ æƒé™ (Permission)

å…·ä½“ä¾‹å­ï¼š
ç”¨æˆ·å¼ ä¸‰ â†’ é”€å”®ç»ç†è§’è‰² â†’ æŸ¥çœ‹å®¢æˆ·ä¿¡æ¯æƒé™
                     â†’ ä¿®æ”¹è®¢å•æƒé™
                     â†’ ç”Ÿæˆé”€å”®æŠ¥è¡¨æƒé™

ç”¨æˆ·æå›› â†’ æ™®é€šå‘˜å·¥è§’è‰² â†’ æŸ¥çœ‹å®¢æˆ·ä¿¡æ¯æƒé™
                     â†’ åˆ›å»ºè®¢å•æƒé™
```

**æƒé™æ•°æ®ç»“æ„è®¾è®¡**
```java
// ç”¨æˆ·å®ä½“
@Entity
public class User {
    private Long id;
    private String username;
    private String password;
    private Set<Role> roles; // ç”¨æˆ·æ‹¥æœ‰çš„è§’è‰²
}

// è§’è‰²å®ä½“  
@Entity
public class Role {
    private Long id;
    private String name;        // è§’è‰²åç§°ï¼šadminã€userç­‰
    private String description; // è§’è‰²æè¿°
    private Set<Permission> permissions; // è§’è‰²æ‹¥æœ‰çš„æƒé™
}

// æƒé™å®ä½“
@Entity  
public class Permission {
    private Long id;
    private String resource;  // èµ„æºï¼šuserã€orderã€product
    private String action;    // æ“ä½œï¼šcreateã€readã€updateã€delete
    private String code;      // æƒé™ç¼–ç ï¼šuser:create
}
```

### 4.2 æƒé™éªŒè¯å®ç°


**æ³¨è§£å¼æƒé™æ§åˆ¶**
```java
// è‡ªå®šä¹‰æƒé™æ³¨è§£
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface RequirePermission {
    String value(); // æƒé™ç¼–ç 
}

// åœ¨Controllerä¸­ä½¿ç”¨
@RestController
@RequestMapping("/users")
public class UserController {
    
    @RequirePermission("user:create")
    @PostMapping
    public ResponseEntity<?> createUser(@RequestBody User user) {
        // åˆ›å»ºç”¨æˆ·é€»è¾‘
        return ResponseEntity.ok("ç”¨æˆ·åˆ›å»ºæˆåŠŸ");
    }
    
    @RequirePermission("user:delete") 
    @DeleteMapping("/{id}")
    public ResponseEntity<?> deleteUser(@PathVariable Long id) {
        // åˆ é™¤ç”¨æˆ·é€»è¾‘
        return ResponseEntity.ok("ç”¨æˆ·åˆ é™¤æˆåŠŸ");
    }
}
```

**æƒé™éªŒè¯æ‹¦æˆªå™¨**
```java
@Component
public class PermissionInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request,
                           HttpServletResponse response,
                           Object handler) {
        
        // æ£€æŸ¥æ˜¯å¦æœ‰æƒé™æ³¨è§£
        if (handler instanceof HandlerMethod) {
            HandlerMethod method = (HandlerMethod) handler;
            RequirePermission annotation = method.getMethodAnnotation(RequirePermission.class);
            
            if (annotation != null) {
                // è·å–å½“å‰ç”¨æˆ·æƒé™
                String token = getTokenFromRequest(request);
                Set<String> userPermissions = getUserPermissions(token);
                
                // æ£€æŸ¥æ˜¯å¦æœ‰æ‰€éœ€æƒé™
                String requiredPermission = annotation.value();
                if (!userPermissions.contains(requiredPermission)) {
                    response.setStatus(403);
                    return false; // æ— æƒé™ï¼Œæ‹’ç»è®¿é—®
                }
            }
        }
        
        return true; // æœ‰æƒé™ï¼Œå…è®¸è®¿é—®
    }
}
```

### 4.3 æƒé™ç¼“å­˜ä¼˜åŒ–


**ğŸš¨ æƒé™æŸ¥è¯¢æ€§èƒ½é—®é¢˜**
> æ¯æ¬¡è¯·æ±‚éƒ½æŸ¥æ•°æ®åº“è·å–ç”¨æˆ·æƒé™ä¼šä¸¥é‡å½±å“æ€§èƒ½

**æƒé™ç¼“å­˜ç­–ç•¥**
```java
@Service
public class PermissionService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // è·å–ç”¨æˆ·æƒé™ï¼ˆå¸¦ç¼“å­˜ï¼‰
    public Set<String> getUserPermissions(Long userId) {
        String cacheKey = "user:permissions:" + userId;
        
        // å…ˆä»ç¼“å­˜è·å–
        Set<String> permissions = (Set<String>) redisTemplate.opsForValue().get(cacheKey);
        
        if (permissions == null) {
            // ç¼“å­˜æœªå‘½ä¸­ï¼Œä»æ•°æ®åº“æŸ¥è¯¢
            permissions = loadPermissionsFromDB(userId);
            
            // å­˜å…¥ç¼“å­˜ï¼Œè¿‡æœŸæ—¶é—´30åˆ†é’Ÿ
            redisTemplate.opsForValue().set(cacheKey, permissions, 30, TimeUnit.MINUTES);
        }
        
        return permissions;
    }
    
    // æƒé™å˜æ›´æ—¶æ¸…é™¤ç¼“å­˜
    public void clearUserPermissionsCache(Long userId) {
        String cacheKey = "user:permissions:" + userId;
        redisTemplate.delete(cacheKey);
    }
}
```

**ç¼“å­˜ç­–ç•¥å¯¹æ¯”**

| ç­–ç•¥ç±»å‹ | **ç¼“å­˜æ—¶æœº** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** | **é€‚ç”¨åœºæ™¯** |
|---------|-------------|---------|---------|-------------|
| ğŸ”„ **å®æ—¶æ›´æ–°** | `æƒé™å˜æ›´ç«‹å³æ›´æ–°ç¼“å­˜` | `æ•°æ®ä¸€è‡´æ€§å¥½` | `æ›´æ–°é¢‘ç¹ï¼Œæ€§èƒ½å¼€é”€å¤§` | `æƒé™å˜æ›´é¢‘ç¹çš„ç³»ç»Ÿ` |
| â° **å®šæ—¶è¿‡æœŸ** | `è®¾ç½®å›ºå®šè¿‡æœŸæ—¶é—´` | `å®ç°ç®€å•ï¼Œæ€§èƒ½å¥½` | `å¯èƒ½å­˜åœ¨çŸ­æš‚ä¸ä¸€è‡´` | `æƒé™ç›¸å¯¹ç¨³å®šçš„ç³»ç»Ÿ` |
| ğŸ“¢ **äº‹ä»¶é€šçŸ¥** | `æƒé™å˜æ›´æ—¶å¹¿æ’­é€šçŸ¥` | `å¹³è¡¡æ€§èƒ½å’Œä¸€è‡´æ€§` | `å®ç°å¤æ‚` | `å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿ` |

---

## 5. ğŸš€ ç¼“å­˜ç­–ç•¥ä¼˜åŒ–


### 5.1 å¤šçº§ç¼“å­˜æ¶æ„


**ğŸ’¡ ç¼“å­˜å±‚æ¬¡è®¾è®¡æ€è·¯**
> å°±åƒå¿«é€’é…é€ç³»ç»Ÿï¼šæ€»ä»“åº“(æ•°æ®åº“) â†’ åŒºåŸŸä»“åº“(Redis) â†’ é…é€ç‚¹(æœ¬åœ°ç¼“å­˜) â†’ ç”¨æˆ·æ‰‹ä¸­ï¼Œè¶Šè¿‘çš„åœ°æ–¹å–è´§è¶Šå¿«

**å¤šçº§ç¼“å­˜æ¶æ„å›¾**
```
åº”ç”¨æœåŠ¡å™¨å±‚çº§ç¼“å­˜ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åº”ç”¨æœåŠ¡å™¨1    â”‚   åº”ç”¨æœåŠ¡å™¨2      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ æœ¬åœ°ç¼“å­˜    â”‚ â”‚ â”‚ æœ¬åœ°ç¼“å­˜    â”‚   â”‚
â”‚ â”‚ (Caffeine)  â”‚ â”‚ â”‚ (Caffeine)  â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚               â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   Redisé›†ç¾¤     â”‚  â† åˆ†å¸ƒå¼ç¼“å­˜
         â”‚   (å…±äº«ç¼“å­˜)    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   MySQLæ•°æ®åº“   â”‚  â† æŒä¹…åŒ–å­˜å‚¨
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç¼“å­˜å®ç°ç¤ºä¾‹**
```java
@Service
public class UserCacheService {
    
    // æœ¬åœ°ç¼“å­˜ - ä¸€çº§ç¼“å­˜
    private final Cache<String, User> localCache = Caffeine.newBuilder()
        .maximumSize(1000)
        .expireAfterWrite(5, TimeUnit.MINUTES)
        .build();
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate; // äºŒçº§ç¼“å­˜
    
    @Autowired  
    private UserRepository userRepository; // æ•°æ®åº“
    
    public User getUserById(Long userId) {
        String cacheKey = "user:" + userId;
        
        // 1. å…ˆæŸ¥æœ¬åœ°ç¼“å­˜
        User user = localCache.getIfPresent(cacheKey);
        if (user != null) {
            return user;
        }
        
        // 2. æœ¬åœ°ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥Redis
        user = (User) redisTemplate.opsForValue().get(cacheKey);
        if (user != null) {
            // å†™å…¥æœ¬åœ°ç¼“å­˜
            localCache.put(cacheKey, user);
            return user;
        }
        
        // 3. Redisä¹Ÿæœªå‘½ä¸­ï¼ŒæŸ¥æ•°æ®åº“
        user = userRepository.findById(userId).orElse(null);
        if (user != null) {
            // å†™å…¥Redis (è¿‡æœŸæ—¶é—´1å°æ—¶)
            redisTemplate.opsForValue().set(cacheKey, user, 1, TimeUnit.HOURS);
            // å†™å…¥æœ¬åœ°ç¼“å­˜
            localCache.put(cacheKey, user);
        }
        
        return user;
    }
}
```

### 5.2 ç¼“å­˜æ›´æ–°ç­–ç•¥


**ğŸ”„ ç¼“å­˜æ›´æ–°æ¨¡å¼å¯¹æ¯”**

| æ›´æ–°æ¨¡å¼ | **å·¥ä½œåŸç†** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** | **é€‚ç”¨åœºæ™¯** |
|---------|-------------|---------|---------|-------------|
| ğŸ”„ **Cache Aside** | `åº”ç”¨è´Ÿè´£ç»´æŠ¤ç¼“å­˜å’ŒDBä¸€è‡´æ€§` | `ç®€å•å¯æ§` | `ä»£ç å¤æ‚ï¼Œå¯èƒ½ä¸ä¸€è‡´` | `è¯»å¤šå†™å°‘` |
| ğŸ“ **Write Through** | `å†™æ“ä½œåŒæ—¶æ›´æ–°ç¼“å­˜å’ŒDB` | `ä¸€è‡´æ€§å¥½` | `å†™æ€§èƒ½å·®` | `å¼ºä¸€è‡´æ€§è¦æ±‚` |
| ğŸ“‹ **Write Behind** | `å…ˆå†™ç¼“å­˜ï¼Œå¼‚æ­¥å†™DB` | `å†™æ€§èƒ½å¥½` | `å¯èƒ½ä¸¢æ•°æ®` | `é«˜å¹¶å‘å†™å…¥` |

**æ¨èå®ç°æ–¹æ¡ˆï¼šCache Aside + æ¶ˆæ¯é€šçŸ¥**
```java
@Service
@Transactional
public class UserService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Autowired
    private UserCacheService cacheService;
    
    @Autowired
    private MessagePublisher messagePublisher;
    
    // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
    public User updateUser(User user) {
        // 1. å…ˆæ›´æ–°æ•°æ®åº“
        User updatedUser = userRepository.save(user);
        
        // 2. åˆ é™¤ç›¸å…³ç¼“å­˜
        cacheService.evictUser(user.getId());
        
        // 3. å‘é€ç¼“å­˜æ›´æ–°æ¶ˆæ¯ï¼ˆç”¨äºé›†ç¾¤ç¯å¢ƒï¼‰
        messagePublisher.publishCacheEvict("user", user.getId());
        
        return updatedUser;
    }
}
```

### 5.3 ç¼“å­˜é›ªå´©ä¸ç©¿é€é˜²æŠ¤


**âš ï¸ å¸¸è§ç¼“å­˜é—®é¢˜**

::: warning ç¼“å­˜é›ªå´©
å¤§é‡ç¼“å­˜åŒæ—¶å¤±æ•ˆï¼Œå¯¼è‡´è¯·æ±‚ç›´æ¥æ‰“åˆ°æ•°æ®åº“ï¼Œé€ æˆæ•°æ®åº“å‹åŠ›æ¿€å¢
:::

::: danger ç¼“å­˜ç©¿é€  
æŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®ï¼Œç¼“å­˜æ— æ³•ç¼“å­˜nullå€¼ï¼Œæ¯æ¬¡éƒ½æŸ¥æ•°æ®åº“
:::

**é˜²æŠ¤ç­–ç•¥å®ç°**
```java
@Service
public class SafeCacheService {
    
    // é˜²æ­¢ç¼“å­˜é›ªå´©ï¼šéšæœºè¿‡æœŸæ—¶é—´
    public void setWithRandomExpire(String key, Object value, int baseSeconds) {
        // åœ¨åŸºç¡€æ—¶é—´ä¸Šéšæœºå¢åŠ 0-30ç§’
        int randomExpire = baseSeconds + ThreadLocalRandom.current().nextInt(30);
        redisTemplate.opsForValue().set(key, value, randomExpire, TimeUnit.SECONDS);
    }
    
    // é˜²æ­¢ç¼“å­˜ç©¿é€ï¼šç¼“å­˜ç©ºå€¼
    public User getUserSafely(Long userId) {
        String cacheKey = "user:" + userId;
        
        // å…ˆæŸ¥ç¼“å­˜
        Object cached = redisTemplate.opsForValue().get(cacheKey);
        
        if (cached != null) {
            // å¦‚æœæ˜¯ç©ºå€¼æ ‡è®°ï¼Œè¿”å›null
            if ("EMPTY".equals(cached)) {
                return null;
            }
            return (User) cached;
        }
        
        // æŸ¥æ•°æ®åº“
        User user = userRepository.findById(userId).orElse(null);
        
        if (user != null) {
            // æ­£å¸¸æ•°æ®ï¼Œç¼“å­˜1å°æ—¶
            setWithRandomExpire(cacheKey, user, 3600);
        } else {
            // ç©ºå€¼ï¼Œç¼“å­˜5åˆ†é’Ÿé˜²æ­¢ç©¿é€
            redisTemplate.opsForValue().set(cacheKey, "EMPTY", 5, TimeUnit.MINUTES);
        }
        
        return user;
    }
}
```

---

## 6. ğŸ›¡ï¸ é«˜å¯ç”¨ä¿éšœ


### 6.1 è®¤è¯æœåŠ¡é«˜å¯ç”¨è®¾è®¡


**ğŸ—ï¸ é«˜å¯ç”¨æ¶æ„è®¾è®¡**
```
å®¢æˆ·ç«¯è¯·æ±‚
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è´Ÿè½½å‡è¡¡å™¨   â”‚  â† Nginx/HAProxy
â”‚ (æ•…éšœæ£€æµ‹)  â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
  â”Œâ”€â”€â”€â”´â”€â”€â”€â”
  â”‚       â”‚
è®¤è¯æœåŠ¡A  è®¤è¯æœåŠ¡B  â† å¤šå®ä¾‹éƒ¨ç½²
  â”‚       â”‚
  â””â”€â”€â”€â”¬â”€â”€â”€â”˜
      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å…±äº«å­˜å‚¨     â”‚  â† Redisé›†ç¾¤/DB
â”‚ (ç”¨æˆ·æ•°æ®)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¥åº·æ£€æŸ¥å®ç°**
```java
@RestController
public class HealthController {
    
    @Autowired
    private DataSource dataSource;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @GetMapping("/health")
    public ResponseEntity<Map<String, Object>> healthCheck() {
        Map<String, Object> health = new HashMap<>();
        
        // æ£€æŸ¥æ•°æ®åº“è¿æ¥
        try {
            dataSource.getConnection().close();
            health.put("database", "UP");
        } catch (Exception e) {
            health.put("database", "DOWN");
        }
        
        // æ£€æŸ¥Redisè¿æ¥
        try {
            redisTemplate.opsForValue().get("health_check");
            health.put("redis", "UP");
        } catch (Exception e) {
            health.put("redis", "DOWN");
        }
        
        // åˆ¤æ–­æ•´ä½“çŠ¶æ€
        boolean allUp = health.values().stream()
            .allMatch(status -> "UP".equals(status));
        
        health.put("status", allUp ? "UP" : "DOWN");
        
        return ResponseEntity.ok(health);
    }
}
```

### 6.2 æœåŠ¡å®¹é”™å¤„ç†


**ğŸ”§ ç†”æ–­å™¨æ¨¡å¼å®ç°**
```java
@Service
public class AuthServiceWithCircuitBreaker {
    
    private final CircuitBreaker circuitBreaker = CircuitBreaker.ofDefaults("authService");
    
    @Autowired
    private AuthService authService;
    
    public User authenticateWithFallback(String username, String password) {
        // ä½¿ç”¨ç†”æ–­å™¨åŒ…è£…è®¤è¯è°ƒç”¨
        return circuitBreaker.executeSupplier(() -> {
            return authService.authenticate(username, password);
        }, throwable -> {
            // é™çº§å¤„ç†ï¼šè¿”å›æ¸¸å®¢æƒé™ç”¨æˆ·
            return createGuestUser();
        });
    }
    
    private User createGuestUser() {
        User guest = new User();
        guest.setUsername("guest");
        guest.setRoles(Collections.singleton("GUEST"));
        return guest;
    }
}
```

**è¶…æ—¶å’Œé‡è¯•ç­–ç•¥**
```java
@Configuration
public class HttpClientConfig {
    
    @Bean
    public RestTemplate restTemplate() {
        // é…ç½®è¿æ¥è¶…æ—¶å’Œè¯»å–è¶…æ—¶
        HttpComponentsClientHttpRequestFactory factory = 
            new HttpComponentsClientHttpRequestFactory();
        factory.setConnectTimeout(5000);    // è¿æ¥è¶…æ—¶5ç§’
        factory.setReadTimeout(10000);      // è¯»å–è¶…æ—¶10ç§’
        
        RestTemplate restTemplate = new RestTemplate(factory);
        
        // æ·»åŠ é‡è¯•æ‹¦æˆªå™¨
        restTemplate.setInterceptors(Arrays.asList(new RetryInterceptor()));
        
        return restTemplate;
    }
}
```

### 6.3 ç›‘æ§ä¸å‘Šè­¦


**ğŸ“Š å…³é”®ç›‘æ§æŒ‡æ ‡**

| ç›‘æ§ç±»åˆ« | **å…³é”®æŒ‡æ ‡** | **æ­£å¸¸èŒƒå›´** | **å‘Šè­¦é˜ˆå€¼** |
|---------|-------------|-------------|-------------|
| ğŸš€ **æ€§èƒ½æŒ‡æ ‡** | `å“åº”æ—¶é—´ã€QPSã€æˆåŠŸç‡` | `<200ms, >1000QPS, >99%` | `>500ms, <500QPS, <95%` |
| ğŸ’¾ **èµ„æºæŒ‡æ ‡** | `CPUã€å†…å­˜ã€ç£ç›˜` | `<70%, <80%, <85%` | `>90%, >95%, >95%` |
| ğŸ” **ä¸šåŠ¡æŒ‡æ ‡** | `ç™»å½•æˆåŠŸç‡ã€TokenéªŒè¯ç‡` | `>98%, >99%` | `<95%, <97%` |

**ç›‘æ§å®ç°ç¤ºä¾‹**
```java
@Component
public class AuthMetrics {
    
    private final MeterRegistry meterRegistry;
    private final Counter loginAttempts;
    private final Counter loginSuccess;
    private final Timer authTime;
    
    public AuthMetrics(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.loginAttempts = Counter.builder("auth.login.attempts")
            .description("Login attempts count")
            .register(meterRegistry);
        this.loginSuccess = Counter.builder("auth.login.success")
            .description("Successful login count")
            .register(meterRegistry);
        this.authTime = Timer.builder("auth.time")
            .description("Authentication time")
            .register(meterRegistry);
    }
    
    public User authenticate(String username, String password) {
        Timer.Sample sample = Timer.start(meterRegistry);
        loginAttempts.increment();
        
        try {
            User user = doAuthenticate(username, password);
            if (user != null) {
                loginSuccess.increment();
            }
            return user;
        } finally {
            sample.stop(authTime);
        }
    }
}
```

---

## 7. ğŸ’¼ å®æˆ˜æ¡ˆä¾‹åˆ†æ


### 7.1 ç”µå•†ç³»ç»Ÿåˆ†å¸ƒå¼è®¤è¯å®è·µ


**ä¸šåŠ¡åœºæ™¯**
> ä¸€ä¸ªå…¸å‹çš„ç”µå•†ç³»ç»Ÿï¼ŒåŒ…å«ç”¨æˆ·æœåŠ¡ã€å•†å“æœåŠ¡ã€è®¢å•æœåŠ¡ã€æ”¯ä»˜æœåŠ¡ç­‰å¤šä¸ªå¾®æœåŠ¡

**æ¶æ„è®¾è®¡**
```
ç”¨æˆ·ç«¯åº”ç”¨
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  APIç½‘å…³    â”‚  â† ç»Ÿä¸€å…¥å£ï¼ŒTokenéªŒè¯
â”‚ (Gateway)   â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
  â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                            â”‚
è®¤è¯ä¸­å¿ƒ                  ä¸šåŠ¡æœåŠ¡é›†ç¾¤
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·ç™»å½•    â”‚         â”‚ ç”¨æˆ·æœåŠ¡         â”‚
â”‚ Tokenç”Ÿæˆ   â”‚         â”‚ å•†å“æœåŠ¡         â”‚  
â”‚ æƒé™ç®¡ç†    â”‚         â”‚ è®¢å•æœåŠ¡         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ æ”¯ä»˜æœåŠ¡         â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…·ä½“å®ç°è¦ç‚¹**

1. **ğŸ” è®¤è¯æµç¨‹**
```java
// APIç½‘å…³çš„TokenéªŒè¯Filter
@Component
public class AuthenticationGatewayFilter implements GlobalFilter, Ordered {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        ServerHttpRequest request = exchange.getRequest();
        
        // è·³è¿‡ç™»å½•æ¥å£
        if (request.getPath().toString().contains("/auth/login")) {
            return chain.filter(exchange);
        }
        
        // è·å–Token
        String token = request.getHeaders().getFirst("Authorization");
        if (token == null || !token.startsWith("Bearer ")) {
            return unauthorizedResponse(exchange);
        }
        
        token = token.substring(7);
        
        // éªŒè¯Token
        return validateToken(token)
            .flatMap(userInfo -> {
                // Tokenæœ‰æ•ˆï¼Œæ·»åŠ ç”¨æˆ·ä¿¡æ¯åˆ°è¯·æ±‚å¤´
                ServerHttpRequest newRequest = request.mutate()
                    .header("X-User-Id", userInfo.getUserId())
                    .header("X-User-Name", userInfo.getUsername())
                    .header("X-User-Roles", String.join(",", userInfo.getRoles()))
                    .build();
                
                return chain.filter(exchange.mutate().request(newRequest).build());
            })
            .onErrorResume(throwable -> unauthorizedResponse(exchange));
    }
    
    @Override
    public int getOrder() {
        return -100; // ä¼˜å…ˆçº§æœ€é«˜
    }
}
```

2. **ğŸ“‹ æƒé™æ§åˆ¶**
```java
// è®¢å•æœåŠ¡ä¸­çš„æƒé™æ§åˆ¶
@RestController
@RequestMapping("/orders")
public class OrderController {
    
    @PostMapping
    public ResponseEntity<?> createOrder(
            @RequestHeader("X-User-Id") Long userId,
            @RequestHeader("X-User-Roles") String roles,
            @RequestBody OrderRequest request) {
        
        // æ£€æŸ¥ç”¨æˆ·æƒé™
        if (!hasPermission(roles, "order:create")) {
            return ResponseEntity.status(403).body("æ— æƒé™åˆ›å»ºè®¢å•");
        }
        
        // åˆ›å»ºè®¢å•é€»è¾‘
        Order order = orderService.createOrder(userId, request);
        return ResponseEntity.ok(order);
    }
    
    @GetMapping("/{orderId}")
    public ResponseEntity<?> getOrder(
            @PathVariable Long orderId,
            @RequestHeader("X-User-Id") Long userId,
            @RequestHeader("X-User-Roles") String roles) {
        
        Order order = orderService.findById(orderId);
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯è®¢å•ä¸»äººæˆ–ç®¡ç†å‘˜
        if (!order.getUserId().equals(userId) && !hasRole(roles, "ADMIN")) {
            return ResponseEntity.status(403).body("æ— æƒé™æŸ¥çœ‹æ­¤è®¢å•");
        }
        
        return ResponseEntity.ok(order);
    }
}
```

### 7.2 æ€§èƒ½ä¼˜åŒ–å®è·µ


**ğŸ” æ€§èƒ½é—®é¢˜è¯†åˆ«**
- **TokenéªŒè¯é¢‘ç¹**ï¼šæ¯ä¸ªè¯·æ±‚éƒ½éœ€è¦éªŒè¯Token
- **æƒé™æŸ¥è¯¢é‡å¤**ï¼šç›¸åŒç”¨æˆ·é¢‘ç¹æŸ¥è¯¢æƒé™
- **ç½‘ç»œè°ƒç”¨å¼€é”€**ï¼šä¸šåŠ¡æœåŠ¡é¢‘ç¹è°ƒç”¨è®¤è¯æœåŠ¡

**âš¡ ä¼˜åŒ–æ–¹æ¡ˆ**
```java
// 1. Tokenä¿¡æ¯ç¼“å­˜åœ¨ç½‘å…³å±‚
@Component  
public class TokenCacheService {
    
    private final Cache<String, UserInfo> tokenCache = Caffeine.newBuilder()
        .maximumSize(10000)
        .expireAfterWrite(10, TimeUnit.MINUTES) // 10åˆ†é’Ÿè¿‡æœŸ
        .build();
    
    public Mono<UserInfo> getUserInfo(String token) {
        // å…ˆæŸ¥æœ¬åœ°ç¼“å­˜
        UserInfo cached = tokenCache.getIfPresent(token);
        if (cached != null) {
            return Mono.just(cached);
        }
        
        // ç¼“å­˜æœªå‘½ä¸­ï¼Œè°ƒç”¨è®¤è¯æœåŠ¡
        return authServiceClient.validateToken(token)
            .doOnNext(userInfo -> tokenCache.put(token, userInfo));
    }
}

// 2. æƒé™ä¿¡æ¯ç›´æ¥åŒ…å«åœ¨Tokenä¸­
public class EnhancedJwtUtil {
    
    public static String generateTokenWithPermissions(User user) {
        // å°†æƒé™ä¿¡æ¯ç›´æ¥ç¼–ç åˆ°Tokenä¸­
        List<String> permissions = user.getRoles().stream()
            .flatMap(role -> role.getPermissions().stream())
            .map(Permission::getCode)
            .collect(Collectors.toList());
        
        return Jwts.builder()
            .setSubject(user.getId().toString())
            .claim("username", user.getUsername())
            .claim("roles", user.getRoles().stream()
                .map(Role::getName)
                .collect(Collectors.toList()))
            .claim("permissions", permissions) // ç›´æ¥åŒ…å«æƒé™
            .setIssuedAt(new Date())
            .setExpiration(new Date(System.currentTimeMillis() + EXPIRATION))
            .signWith(SignatureAlgorithm.HS256, SECRET)
            .compact();
    }
}
```

**ğŸ“Š ä¼˜åŒ–æ•ˆæœå¯¹æ¯”**

| ä¼˜åŒ–é¡¹ç›® | **ä¼˜åŒ–å‰** | **ä¼˜åŒ–å** | **æå‡å¹…åº¦** |
|---------|-----------|-----------|-------------|
| ğŸ” **TokenéªŒè¯è€—æ—¶** | `æ¯æ¬¡20ms` | `ç¼“å­˜å‘½ä¸­1ms` | `95%æå‡` |
| ğŸ¯ **æƒé™æŸ¥è¯¢è€—æ—¶** | `æ¯æ¬¡10ms` | `Tokenå†…ç½®0ms` | `100%æå‡` |
| ğŸš€ **æ•´ä½“å“åº”æ—¶é—´** | `å¹³å‡150ms` | `å¹³å‡80ms` | `47%æå‡` |
| ğŸ’¾ **æ•°æ®åº“æŸ¥è¯¢** | `1000æ¬¡/åˆ†é’Ÿ` | `50æ¬¡/åˆ†é’Ÿ` | `95%å‡å°‘` |

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ åˆ†å¸ƒå¼è®¤è¯æœ¬è´¨ï¼šè§£å†³å¤šæœåŠ¡é—´çš„èº«ä»½è®¤è¯å’Œæƒé™æ§åˆ¶é—®é¢˜
ğŸ”¸ Tokenè®¤è¯åŸç†ï¼šæ— çŠ¶æ€çš„èº«ä»½å‡­è¯ï¼Œå¯åœ¨æœåŠ¡é—´å®‰å…¨ä¼ é€’  
ğŸ”¸ JWTç»“æ„ç»„æˆï¼šHeader.Payload.Signatureä¸‰éƒ¨åˆ†æ„æˆ
ğŸ”¸ æƒé™æ¨¡å‹è®¾è®¡ï¼šRBACæ¨¡å‹ï¼Œç”¨æˆ·-è§’è‰²-æƒé™çš„å±‚çº§å…³ç³»
ğŸ”¸ ç¼“å­˜ä¼˜åŒ–ç­–ç•¥ï¼šå¤šçº§ç¼“å­˜æå‡æ€§èƒ½ï¼Œåˆç†çš„è¿‡æœŸå’Œæ›´æ–°ç­–ç•¥
ğŸ”¸ é«˜å¯ç”¨ä¿éšœï¼šå¤šå®ä¾‹éƒ¨ç½²ã€ç†”æ–­å™¨ã€ç›‘æ§å‘Šè­¦æœºåˆ¶
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆé€‰æ‹©Tokenè€ŒéSession**
```
Sessionæ–¹æ¡ˆé—®é¢˜ï¼š
âŒ éœ€è¦æœåŠ¡å™¨å­˜å‚¨çŠ¶æ€
âŒ éš¾ä»¥åœ¨å¤šæœåŠ¡é—´å…±äº«  
âŒ æ‰©å±•æ€§å·®ï¼Œæ— æ³•è·¨åŸŸ

Tokenæ–¹æ¡ˆä¼˜åŠ¿ï¼š
âœ… æ— çŠ¶æ€ï¼ŒæœåŠ¡å™¨æ— éœ€å­˜å‚¨
âœ… å¯ä»¥åœ¨HTTPå¤´ä¸­ä¼ é€’
âœ… æ”¯æŒè·¨åŸŸå’Œç§»åŠ¨ç«¯
âœ… åŒ…å«ç”¨æˆ·ä¿¡æ¯å’Œæƒé™
```

**ğŸ”¹ å®‰å…¨æ€§å¦‚ä½•ä¿éšœ**
```
é˜²ä¼ªé€ ï¼šä½¿ç”¨å¯†é’¥ç­¾åï¼Œæ— æ³•ä¼ªé€ 
é˜²ç¯¡æ”¹ï¼šä»»ä½•ä¿®æ”¹éƒ½ä¼šå¯¼è‡´ç­¾åéªŒè¯å¤±è´¥
é˜²é‡æ”¾ï¼šè®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œé™åˆ¶Tokenç”Ÿå‘½å‘¨æœŸ
é˜²æ³„éœ²ï¼šHTTPSä¼ è¾“ï¼Œé¿å…æ˜æ–‡ä¼ è¾“
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–çš„å…³é”®**
```
ç¼“å­˜ç­–ç•¥ï¼šå‡å°‘é‡å¤éªŒè¯å’ŒæŸ¥è¯¢
å¼‚æ­¥å¤„ç†ï¼šéå…³é”®æ“ä½œå¼‚æ­¥æ‰§è¡Œ
æ•°æ®é¢„åŠ è½½ï¼šå°†æƒé™ä¿¡æ¯åŒ…å«åœ¨Tokenä¸­
åˆç†è¿‡æœŸï¼šå¹³è¡¡å®‰å…¨æ€§å’Œæ€§èƒ½
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ æŠ€æœ¯é€‰å‹å»ºè®®**

::: tip å°å‹é¡¹ç›®æ¨è
- **è®¤è¯æ–¹æ¡ˆ**ï¼šSpring Security + JWT
- **ç¼“å­˜æ–¹æ¡ˆ**ï¼šRediså•å®ä¾‹
- **éƒ¨ç½²æ–¹æ¡ˆ**ï¼šå•ä½“åº”ç”¨å†…åµŒè®¤è¯æ¨¡å—
:::

::: warning ä¸­å‹é¡¹ç›®æ¨è  
- **è®¤è¯æ–¹æ¡ˆ**ï¼šç‹¬ç«‹è®¤è¯æœåŠ¡ + Gateway
- **ç¼“å­˜æ–¹æ¡ˆ**ï¼šRedisé›†ç¾¤ + æœ¬åœ°ç¼“å­˜
- **éƒ¨ç½²æ–¹æ¡ˆ**ï¼šè®¤è¯æœåŠ¡ç‹¬ç«‹éƒ¨ç½²
:::

::: danger å¤§å‹é¡¹ç›®æ¨è
- **è®¤è¯æ–¹æ¡ˆ**ï¼šSSOç»Ÿä¸€è®¤è¯å¹³å°
- **ç¼“å­˜æ–¹æ¡ˆ**ï¼šå¤šçº§ç¼“å­˜ + åˆ†å¸ƒå¼ç¼“å­˜
- **éƒ¨ç½²æ–¹æ¡ˆ**ï¼šé«˜å¯ç”¨é›†ç¾¤ + å®¹ç¾å¤‡ä»½
:::

**ğŸ”§ å¼€å‘å®è·µè¦ç‚¹**
- **å®‰å…¨ç¬¬ä¸€**ï¼šå¯†é’¥ç®¡ç†ã€HTTPSä¼ è¾“ã€æƒé™æœ€å°åŒ–
- **æ€§èƒ½è€ƒè™‘**ï¼šåˆç†ä½¿ç”¨ç¼“å­˜ã€å¼‚æ­¥å¤„ç†ã€è¿æ¥æ± 
- **å¯ç»´æŠ¤æ€§**ï¼šç»Ÿä¸€å¼‚å¸¸å¤„ç†ã€å®Œå–„çš„æ—¥å¿—ã€ç›‘æ§å‘Šè­¦
- **æ‰©å±•æ€§**ï¼šå¾®æœåŠ¡æ¶æ„ã€æ°´å¹³æ‰©å±•ã€ç‰ˆæœ¬å…¼å®¹

**ğŸš€ å­¦ä¹ è·¯å¾„å»ºè®®**
```
åŸºç¡€å­¦ä¹ è·¯å¾„ï¼š
1ï¸âƒ£ ç†è§£ä¼ ç»ŸSessionè®¤è¯åŸç†
2ï¸âƒ£ å­¦ä¹ JWT Tokenç»“æ„å’Œä½¿ç”¨
3ï¸âƒ£ æŒæ¡Spring Securityé›†æˆ
4ï¸âƒ£ å®è·µæƒé™æ§åˆ¶å’Œç¼“å­˜ä¼˜åŒ–
5ï¸âƒ£ å­¦ä¹ å¾®æœåŠ¡è®¤è¯æ¶æ„è®¾è®¡

è¿›é˜¶å­¦ä¹ æ–¹å‘ï¼š
ğŸ”¸ OAuth2.0å’ŒOpenID Connect
ğŸ”¸ å•ç‚¹ç™»å½•(SSO)ç³»ç»Ÿè®¾è®¡
ğŸ”¸ é›¶ä¿¡ä»»å®‰å…¨æ¶æ„
ğŸ”¸ APIç½‘å…³å’ŒæœåŠ¡ç½‘æ ¼
ğŸ”¸ å®¹å™¨åŒ–éƒ¨ç½²å’ŒDevOps
```

**ğŸ’¡ å¸¸è§é—®é¢˜è§£å†³**
- **Tokenè¿‡æœŸå¤„ç†**ï¼šå®ç°è‡ªåŠ¨åˆ·æ–°æœºåˆ¶
- **æƒé™å®æ—¶æ›´æ–°**ï¼šä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—é€šçŸ¥æƒé™å˜æ›´
- **è·¨åŸŸé—®é¢˜**ï¼šæ­£ç¡®é…ç½®CORSå’Œé¢„æ£€è¯·æ±‚
- **æ€§èƒ½ç“¶é¢ˆ**ï¼šå¤šçº§ç¼“å­˜å’Œæ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
> Tokenè®¤è¯è§£å†³åˆ†å¸ƒå¼ï¼Œæ— çŠ¶æ€ä¼ é€’å¾ˆä¾¿åˆ©
> æƒé™ç¼“å­˜ææ€§èƒ½ï¼Œå®‰å…¨å¯ç”¨æ˜¯æ ¹åŸº
> å¾®æœåŠ¡æ¶æ„è¦ç»Ÿä¸€ï¼Œç›‘æ§å‘Šè­¦ä¸èƒ½ç¦»

è¿™å¥—åˆ†å¸ƒå¼è®¤è¯æ–¹æ¡ˆæ˜¯ç°ä»£å¾®æœåŠ¡æ¶æ„çš„åŸºç¡€è®¾æ–½ï¼ŒæŒæ¡å¥½è¿™äº›çŸ¥è¯†ç‚¹ï¼Œå°±èƒ½åº”å¯¹ç»å¤§å¤šæ•°ä¼ä¸šçº§åº”ç”¨çš„è®¤è¯éœ€æ±‚ï¼