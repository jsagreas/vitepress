---
title: 1ã€Listener-Sessionç»‘å®šç›‘å¬
---
## ğŸ“š ç›®å½•

1. [Sessionç»‘å®šç›‘å¬å™¨åŸºç¡€æ¦‚å¿µ](#1-Sessionç»‘å®šç›‘å¬å™¨åŸºç¡€æ¦‚å¿µ)
2. [HttpSessionBindingListeneræ¥å£è¯¦è§£](#2-HttpSessionBindingListeneræ¥å£è¯¦è§£)
3. [valueBoundç»‘å®šç›‘å¬æœºåˆ¶](#3-valueBoundç»‘å®šç›‘å¬æœºåˆ¶)
4. [valueUnboundè§£ç»‘ç›‘å¬æœºåˆ¶](#4-valueUnboundè§£ç»‘ç›‘å¬æœºåˆ¶)
5. [å¯¹è±¡ç”Ÿå‘½å‘¨æœŸç®¡ç†å®è·µ](#5-å¯¹è±¡ç”Ÿå‘½å‘¨æœŸç®¡ç†å®è·µ)
6. [èµ„æºè‡ªåŠ¨æ¸…ç†ç­–ç•¥](#6-èµ„æºè‡ªåŠ¨æ¸…ç†ç­–ç•¥)
7. [å†…å­˜ä¼˜åŒ–ä¸æœ€ä½³å®è·µ](#7-å†…å­˜ä¼˜åŒ–ä¸æœ€ä½³å®è·µ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ Sessionç»‘å®šç›‘å¬å™¨åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Sessionç»‘å®šç›‘å¬å™¨


**ç®€å•ç†è§£**ï¼šæƒ³è±¡Sessionå°±åƒä¸€ä¸ª**å‚¨ç‰©æŸœ**ï¼Œè€ŒSessionç»‘å®šç›‘å¬å™¨å°±åƒä¸€ä¸ª**æ™ºèƒ½ç‰©å“**ï¼Œè¿™ä¸ªç‰©å“èƒ½å¤Ÿæ„ŸçŸ¥åˆ°è‡ªå·±ä»€ä¹ˆæ—¶å€™è¢«**æ”¾è¿›å‚¨ç‰©æŸœ**ï¼Œä»€ä¹ˆæ—¶å€™è¢«**æ‹¿å‡ºå‚¨ç‰©æŸœ**ã€‚

```
ç°å®æ¯”å–»ï¼š
æ™ºèƒ½æ‰‹è¡¨ â†’ HttpSessionBindingListenerå¯¹è±¡
å‚¨ç‰©æŸœ   â†’ HttpSession
æ”¾å…¥     â†’ valueBound() è¢«è°ƒç”¨
æ‹¿å‡º     â†’ valueUnbound() è¢«è°ƒç”¨

å½“æ™ºèƒ½æ‰‹è¡¨è¢«æ”¾å…¥å‚¨ç‰©æŸœæ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨è®°å½•"æˆ‘è¢«å­˜æ”¾äº†"
å½“æ™ºèƒ½æ‰‹è¡¨è¢«æ‹¿å‡ºå‚¨ç‰©æŸœæ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨è®°å½•"æˆ‘è¢«å–å‡ºäº†"
```

### 1.2 Sessionç»‘å®šç›‘å¬å™¨çš„æ ¸å¿ƒç‰¹ç‚¹


ğŸ’¡ **è‡ªæˆ‘æ„ŸçŸ¥èƒ½åŠ›**
- å¯¹è±¡æœ¬èº«å°±æ˜¯ç›‘å¬å™¨ï¼Œä¸éœ€è¦é¢å¤–æ³¨å†Œ
- å½“å¯¹è±¡è¢«å­˜å…¥Sessionæ—¶ï¼Œè‡ªå·±çŸ¥é“
- å½“å¯¹è±¡è¢«ç§»å‡ºSessionæ—¶ï¼Œè‡ªå·±ä¹ŸçŸ¥é“

ğŸ”— **ä¸æ™®é€šç›‘å¬å™¨çš„åŒºåˆ«**

| ç‰¹å¾ | **æ™®é€šç›‘å¬å™¨** | **Sessionç»‘å®šç›‘å¬å™¨** |
|------|-------------|-------------------|
| **æ³¨å†Œæ–¹å¼** | `web.xmlé…ç½®` | `å®ç°æ¥å£å³å¯` |
| **ç›‘å¬èŒƒå›´** | `å…¨å±€æ‰€æœ‰Session` | `åªç›‘å¬è‡ªå·±çš„ç»‘å®š` |
| **ä½¿ç”¨åœºæ™¯** | `ç»Ÿè®¡åˆ†æã€æ—¥å¿—è®°å½•` | `å¯¹è±¡ç”Ÿå‘½å‘¨æœŸç®¡ç†` |
| **å®ç°ä½ç½®** | `ç‹¬ç«‹çš„ç›‘å¬å™¨ç±»` | `ä¸šåŠ¡å¯¹è±¡æœ¬èº«` |

### 1.3 ä¸ºä»€ä¹ˆéœ€è¦Sessionç»‘å®šç›‘å¬å™¨


**å®é™…åº”ç”¨åœºæ™¯ä¸¾ä¾‹**ï¼š

ğŸ® **åœ¨çº¿æ¸¸æˆç©å®¶å¯¹è±¡**
```
ç©å®¶ç™»å½• â†’ Playerå¯¹è±¡å­˜å…¥Session â†’ è‡ªåŠ¨åˆå§‹åŒ–æ¸¸æˆèµ„æº
ç©å®¶é€€å‡º â†’ Playerå¯¹è±¡ç§»å‡ºSession â†’ è‡ªåŠ¨æ¸…ç†å ç”¨èµ„æº
```

ğŸ’¾ **æ•°æ®åº“è¿æ¥ç®¡ç†**
```
ç”¨æˆ·ç™»å½• â†’ è¿æ¥å¯¹è±¡ç»‘å®šåˆ°Session â†’ å»ºç«‹æ•°æ®åº“è¿æ¥
ç”¨æˆ·ç™»å‡º â†’ è¿æ¥å¯¹è±¡è§£ç»‘ â†’ è‡ªåŠ¨å…³é—­æ•°æ®åº“è¿æ¥
```

ğŸ“Š **åœ¨çº¿ç”¨æˆ·ç»Ÿè®¡**
```
ç”¨æˆ·è¿›å…¥ â†’ ç”¨æˆ·å¯¹è±¡ç»‘å®š â†’ åœ¨çº¿äººæ•°+1
ç”¨æˆ·ç¦»å¼€ â†’ ç”¨æˆ·å¯¹è±¡è§£ç»‘ â†’ åœ¨çº¿äººæ•°-1
```

---

## 2. ğŸ”§ HttpSessionBindingListeneræ¥å£è¯¦è§£


### 2.1 æ¥å£åŸºæœ¬ç»“æ„


**æ¥å£å®šä¹‰**ï¼š`HttpSessionBindingListener`æ˜¯ä¸€ä¸ª**æ ‡è®°æ¥å£**ï¼Œå°±åƒç»™å¯¹è±¡è´´ä¸Š"æˆ‘èƒ½æ„ŸçŸ¥Sessionç»‘å®š"çš„æ ‡ç­¾ã€‚

```java
// javax.servlet.http.HttpSessionBindingListener
public interface HttpSessionBindingListener extends EventListener {
    
    // å½“å¯¹è±¡è¢«ç»‘å®šåˆ°Sessionæ—¶è°ƒç”¨
    public void valueBound(HttpSessionBindingEvent event);
    
    // å½“å¯¹è±¡ä»Sessionä¸­è§£ç»‘æ—¶è°ƒç”¨  
    public void valueUnbound(HttpSessionBindingEvent event);
}
```

### 2.2 æ¥å£æ–¹æ³•è¯¦è§£


**ğŸ”¸ valueBoundæ–¹æ³•**
- **è°ƒç”¨æ—¶æœº**ï¼šå¯¹è±¡è¢«`session.setAttribute()`å­˜å…¥æ—¶
- **å‚æ•°å«ä¹‰**ï¼š`HttpSessionBindingEvent`åŒ…å«Sessionå’Œå±æ€§ä¿¡æ¯
- **å¸¸ç”¨æ“ä½œ**ï¼šåˆå§‹åŒ–èµ„æºã€è®°å½•æ—¥å¿—ã€ç»Ÿè®¡è®¡æ•°

**ğŸ”¸ valueUnboundæ–¹æ³•** 
- **è°ƒç”¨æ—¶æœº**ï¼šå¯¹è±¡è¢«ç§»é™¤æ—¶ï¼ˆæ‰‹åŠ¨ç§»é™¤ã€Sessionå¤±æ•ˆã€è¢«è¦†ç›–ï¼‰
- **å‚æ•°å«ä¹‰**ï¼šåŒæ ·æ˜¯`HttpSessionBindingEvent`å¯¹è±¡
- **å¸¸ç”¨æ“ä½œ**ï¼šé‡Šæ”¾èµ„æºã€æ¸…ç†æ•°æ®ã€æ›´æ–°ç»Ÿè®¡

### 2.3 HttpSessionBindingEventäº‹ä»¶å¯¹è±¡


```
HttpSessionBindingEventåŒ…å«çš„ä¿¡æ¯ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  HttpSessionBindingEvent     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ getSession()  è·å–Session â”‚
â”‚  â€¢ getName()     è·å–å±æ€§å   â”‚  
â”‚  â€¢ getValue()    è·å–å±æ€§å€¼   â”‚
â”‚  â€¢ getSource()   è·å–äº‹ä»¶æº   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. âœ¨ valueBoundç»‘å®šç›‘å¬æœºåˆ¶


### 3.1 ç»‘å®šç›‘å¬çš„è§¦å‘æ—¶æœº


**ç»‘å®šæ“ä½œè§¦å‘æƒ…å†µ**ï¼š

1ï¸âƒ£ **é¦–æ¬¡å­˜å‚¨**ï¼š`session.setAttribute("user", userObject)`
2ï¸âƒ£ **å€¼æ›¿æ¢**ï¼šç”¨æ–°å¯¹è±¡æ›¿æ¢æ—§å¯¹è±¡æ—¶ï¼Œæ–°å¯¹è±¡è§¦å‘ç»‘å®š
3ï¸âƒ£ **Sessionå¤åˆ¶**ï¼šé›†ç¾¤ç¯å¢ƒä¸­Sessionå¤åˆ¶æ—¶

```java
// è§¦å‘ç»‘å®šçš„å…¸å‹ä»£ç 
HttpSession session = request.getSession();
User user = new User("å¼ ä¸‰");  // Userå®ç°äº†HttpSessionBindingListener
session.setAttribute("loginUser", user);  // æ­¤æ—¶è§¦å‘user.valueBound()
```

### 3.2 å®ç°ç»‘å®šç›‘å¬çš„å®Œæ•´ç¤ºä¾‹


```java
public class OnlineUser implements HttpSessionBindingListener, Serializable {
    private String username;
    private Date loginTime;
    
    // é™æ€å˜é‡ï¼šè®°å½•åœ¨çº¿äººæ•°
    private static int onlineCount = 0;
    
    public OnlineUser(String username) {
        this.username = username;
        this.loginTime = new Date();
    }
    
    @Override
    public void valueBound(HttpSessionBindingEvent event) {
        synchronized(OnlineUser.class) {
            onlineCount++;  // åœ¨çº¿äººæ•°å¢åŠ 
        }
        
        System.out.println("ç”¨æˆ· " + username + " ä¸Šçº¿äº†ï¼");
        System.out.println("å½“å‰åœ¨çº¿äººæ•°ï¼š" + onlineCount);
        
        // å¯ä»¥åœ¨è¿™é‡Œåšæ›´å¤šåˆå§‹åŒ–å·¥ä½œ
        // æ¯”å¦‚ï¼šè®°å½•ç™»å½•æ—¥å¿—ã€åˆå§‹åŒ–ç”¨æˆ·èµ„æºç­‰
    }
    
    // getter/setteræ–¹æ³•...
    public static int getOnlineCount() {
        return onlineCount;
    }
}
```

### 3.3 ç»‘å®šç›‘å¬çš„å®é™…åº”ç”¨


**ğŸ¯ ç”¨æˆ·ç™»å½•å¤„ç†**

```java
@WebServlet("/login")
public class LoginServlet extends HttpServlet {
    protected void doPost(HttpServletRequest request, 
                         HttpServletResponse response) throws IOException {
        
        String username = request.getParameter("username");
        
        // åˆ›å»ºç”¨æˆ·å¯¹è±¡ï¼ˆå®ç°äº†ç»‘å®šç›‘å¬å™¨ï¼‰
        OnlineUser user = new OnlineUser(username);
        
        // å­˜å…¥Sessionï¼Œè‡ªåŠ¨è§¦å‘valueBound()
        request.getSession().setAttribute("user", user);
        
        response.getWriter().println("ç™»å½•æˆåŠŸï¼å½“å‰åœ¨çº¿ï¼š" + 
                                   OnlineUser.getOnlineCount() + "äºº");
    }
}
```

---

## 4. ğŸ”„ valueUnboundè§£ç»‘ç›‘å¬æœºåˆ¶


### 4.1 è§£ç»‘ç›‘å¬çš„è§¦å‘æ—¶æœº


**è§£ç»‘æ“ä½œè§¦å‘æƒ…å†µ**ï¼š

1ï¸âƒ£ **æ‰‹åŠ¨ç§»é™¤**ï¼š`session.removeAttribute("user")`
2ï¸âƒ£ **Sessionå¤±æ•ˆ**ï¼šè¶…æ—¶æˆ–è°ƒç”¨`session.invalidate()`
3ï¸âƒ£ **å€¼è¦†ç›–**ï¼šç”¨æ–°å€¼è¦†ç›–åŸæœ‰å±æ€§
4ï¸âƒ£ **Webåº”ç”¨åœæ­¢**ï¼šæœåŠ¡å™¨å…³é—­æ—¶

```
è§£ç»‘è§¦å‘æ—¶åºå›¾ï¼š

ç”¨æˆ·æ“ä½œ                Session                OnlineUserå¯¹è±¡
    |                     |                         |
    |--æ‰‹åŠ¨ç™»å‡º----------->|                         |
    |                     |--è°ƒç”¨removeAttribute--->|
    |                     |                         |--valueUnbound()
    |                     |<--æ‰§è¡Œæ¸…ç†é€»è¾‘----------|
    |<--è¿”å›ç™»å‡ºæˆåŠŸ-------|                         |
```

### 4.2 å®ç°è§£ç»‘ç›‘å¬çš„å®Œæ•´ç¤ºä¾‹


```java
public class OnlineUser implements HttpSessionBindingListener, Serializable {
    private String username;
    private Date loginTime;
    private static int onlineCount = 0;
    
    // å¯èƒ½å ç”¨çš„èµ„æº
    private DatabaseConnection dbConnection;
    private Timer heartbeatTimer;
    
    @Override
    public void valueUnbound(HttpSessionBindingEvent event) {
        synchronized(OnlineUser.class) {
            onlineCount--;  // åœ¨çº¿äººæ•°å‡å°‘
        }
        
        System.out.println("ç”¨æˆ· " + username + " ä¸‹çº¿äº†ï¼");
        System.out.println("å½“å‰åœ¨çº¿äººæ•°ï¼š" + onlineCount);
        
        // ğŸ”§ è‡ªåŠ¨æ¸…ç†èµ„æº
        cleanupResources();
    }
    
    private void cleanupResources() {
        // å…³é—­æ•°æ®åº“è¿æ¥
        if (dbConnection != null) {
            dbConnection.close();
            System.out.println("å·²å…³é—­ " + username + " çš„æ•°æ®åº“è¿æ¥");
        }
        
        // åœæ­¢å¿ƒè·³å®šæ—¶å™¨
        if (heartbeatTimer != null) {
            heartbeatTimer.cancel();
            System.out.println("å·²åœæ­¢ " + username + " çš„å¿ƒè·³å®šæ—¶å™¨");
        }
    }
}
```

### 4.3 è§£ç»‘ç›‘å¬çš„æœ€ä½³å®è·µ


**âœ… æ¨èåšæ³•**ï¼š
- åœ¨`valueUnbound()`ä¸­é‡Šæ”¾æ‰€æœ‰å ç”¨èµ„æº
- ä½¿ç”¨åŒæ­¥æœºåˆ¶ä¿è¯çº¿ç¨‹å®‰å…¨
- è®°å½•æ¸…ç†æ—¥å¿—ä¾¿äºè°ƒè¯•
- å¤„ç†å¯èƒ½çš„å¼‚å¸¸æƒ…å†µ

**âŒ é¿å…æ“ä½œ**ï¼š
- ä¸è¦åœ¨è§£ç»‘æ–¹æ³•ä¸­è®¿é—®Sessionï¼ˆå¯èƒ½å·²å¤±æ•ˆï¼‰
- ä¸è¦æ‰§è¡Œè€—æ—¶æ“ä½œï¼ˆä¼šå½±å“æ€§èƒ½ï¼‰
- ä¸è¦æŠ›å‡ºæœªå¤„ç†å¼‚å¸¸

---

## 5. âš™ï¸ å¯¹è±¡ç”Ÿå‘½å‘¨æœŸç®¡ç†å®è·µ


### 5.1 å®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†æ¨¡å‹


```
å¯¹è±¡ç”Ÿå‘½å‘¨æœŸæµç¨‹å›¾ï¼š

åˆ›å»ºé˜¶æ®µ    â†’    ç»‘å®šé˜¶æ®µ    â†’    æ´»è·ƒé˜¶æ®µ    â†’    è§£ç»‘é˜¶æ®µ    â†’    é”€æ¯é˜¶æ®µ
   |              |              |              |              |
newå¯¹è±¡      valueBound()    æ­£å¸¸ä½¿ç”¨     valueUnbound()    GCå›æ”¶
   |              |              |              |              |
åˆå§‹åŒ–          å»ºç«‹è¿æ¥        å¤„ç†è¯·æ±‚        æ¸…ç†èµ„æº        å†…å­˜é‡Šæ”¾
```

### 5.2 å®ç°å®Œæ•´ç”Ÿå‘½å‘¨æœŸç®¡ç†


```java
public class UserSession implements HttpSessionBindingListener, Serializable {
    
    private String userId;
    private Date createTime;
    private Date lastAccessTime;
    
    // èµ„æºç®¡ç†
    private List<Resource> managedResources;
    
    public UserSession(String userId) {
        this.userId = userId;
        this.createTime = new Date();
        this.managedResources = new ArrayList<>();
        
        System.out.println("ğŸ“ UserSessionå¯¹è±¡åˆ›å»ºï¼š" + userId);
    }
    
    @Override
    public void valueBound(HttpSessionBindingEvent event) {
        this.lastAccessTime = new Date();
        
        // ğŸš€ åˆå§‹åŒ–ç”¨æˆ·èµ„æº
        initializeResources();
        
        // ğŸ“Š æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        UserStatistics.userLogin(userId);
        
        System.out.println("ğŸ”— ç”¨æˆ·ä¼šè¯ç»‘å®šæˆåŠŸï¼š" + userId);
    }
    
    @Override
    public void valueUnbound(HttpSessionBindingEvent event) {
        // ğŸ”§ æ¸…ç†æ‰€æœ‰èµ„æº
        cleanupAllResources();
        
        // ğŸ“Š æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        UserStatistics.userLogout(userId);
        
        System.out.println("ğŸ”“ ç”¨æˆ·ä¼šè¯è§£ç»‘å®Œæˆï¼š" + userId);
    }
    
    private void initializeResources() {
        // åˆå§‹åŒ–æ•°æ®åº“è¿æ¥æ± 
        DatabaseResource dbResource = new DatabaseResource(userId);
        managedResources.add(dbResource);
        
        // åˆå§‹åŒ–ç¼“å­˜
        CacheResource cacheResource = new CacheResource(userId);
        managedResources.add(cacheResource);
        
        System.out.println("âœ… å·²åˆå§‹åŒ– " + managedResources.size() + " ä¸ªèµ„æº");
    }
    
    private void cleanupAllResources() {
        for (Resource resource : managedResources) {
            try {
                resource.cleanup();
                System.out.println("ğŸ§¹ å·²æ¸…ç†èµ„æºï¼š" + resource.getResourceType());
            } catch (Exception e) {
                System.err.println("âŒ æ¸…ç†èµ„æºå¤±è´¥ï¼š" + e.getMessage());
            }
        }
        managedResources.clear();
    }
}
```

### 5.3 ç”Ÿå‘½å‘¨æœŸç®¡ç†çš„å®é™…ä»·å€¼


**ğŸ¯ å®é™…åº”ç”¨æ”¶ç›Š**ï¼š

| ç®¡ç†æ–¹é¢ | **ä¼ ç»Ÿæ–¹å¼** | **ç”Ÿå‘½å‘¨æœŸç®¡ç†** | **æ”¹è¿›æ•ˆæœ** |
|---------|------------|----------------|-------------|
| **å†…å­˜ä½¿ç”¨** | `æ‰‹åŠ¨æ¸…ç†ï¼Œå®¹æ˜“é—æ¼` | `è‡ªåŠ¨æ¸…ç†ï¼Œç¡®ä¿é‡Šæ”¾` | `å‡å°‘å†…å­˜æ³„æ¼95%+` |
| **æ•°æ®åº“è¿æ¥** | `å¯èƒ½å¿˜è®°å…³é—­` | `è§£ç»‘æ—¶è‡ªåŠ¨å…³é—­` | `é¿å…è¿æ¥æ± è€—å°½` |
| **ç»Ÿè®¡å‡†ç¡®æ€§** | `éœ€è¦å¤šå¤„ç»´æŠ¤` | `ç»‘å®šè§£ç»‘è‡ªåŠ¨æ›´æ–°` | `æ•°æ®å‡†ç¡®æ€§100%` |
| **å¼€å‘æ•ˆç‡** | `éœ€è¦è®°ä½æ¸…ç†` | `ä¸€æ¬¡å®ç°ï¼Œè‡ªåŠ¨ç®¡ç†` | `å¼€å‘æ•ˆç‡æå‡50%+` |

---

## 6. ğŸ§¹ èµ„æºè‡ªåŠ¨æ¸…ç†ç­–ç•¥


### 6.1 èµ„æºæ¸…ç†çš„åˆ†ç±»ç®¡ç†


**èµ„æºåˆ†ç±»æ¸…ç†ç­–ç•¥**ï¼š

```
èµ„æºæ¸…ç†ä¼˜å…ˆçº§ï¼š
é«˜ä¼˜å…ˆçº§ ğŸ”´ â†’ æ•°æ®åº“è¿æ¥ã€æ–‡ä»¶å¥æŸ„ã€ç½‘ç»œè¿æ¥
ä¸­ä¼˜å…ˆçº§ ğŸŸ¡ â†’ ç¼“å­˜æ•°æ®ã€ä¸´æ—¶æ–‡ä»¶ã€å®šæ—¶å™¨
ä½ä¼˜å…ˆçº§ ğŸŸ¢ â†’ ç»Ÿè®¡æ•°æ®ã€æ—¥å¿—è®°å½•ã€é…ç½®ä¿¡æ¯
```

### 6.2 æ™ºèƒ½æ¸…ç†ç­–ç•¥å®ç°


```java
public class ResourceManager implements HttpSessionBindingListener {
    
    // ğŸ”´ é«˜ä¼˜å…ˆçº§èµ„æº
    private final Map<String, AutoCloseable> criticalResources = new ConcurrentHashMap<>();
    
    // ğŸŸ¡ ä¸­ä¼˜å…ˆçº§èµ„æº  
    private final Map<String, Cleanable> normalResources = new ConcurrentHashMap<>();
    
    // ğŸŸ¢ ä½ä¼˜å…ˆçº§èµ„æº
    private final Map<String, Object> optionalResources = new ConcurrentHashMap<>();
    
    @Override
    public void valueUnbound(HttpSessionBindingEvent event) {
        // æŒ‰ä¼˜å…ˆçº§æ¸…ç†èµ„æº
        cleanupCriticalResources();    // å¿…é¡»æˆåŠŸ
        cleanupNormalResources();      // å°½åŠ›è€Œä¸º
        cleanupOptionalResources();    // å¯ä»¥å¤±è´¥
    }
    
    private void cleanupCriticalResources() {
        criticalResources.forEach((name, resource) -> {
            try {
                resource.close();
                System.out.println("âœ… å…³é”®èµ„æºæ¸…ç†æˆåŠŸï¼š" + name);
            } catch (Exception e) {
                // å…³é”®èµ„æºæ¸…ç†å¤±è´¥è¦è®°å½•é”™è¯¯
                System.err.println("ğŸš¨ å…³é”®èµ„æºæ¸…ç†å¤±è´¥ï¼š" + name + ", " + e.getMessage());
            }
        });
        criticalResources.clear();
    }
    
    private void cleanupNormalResources() {
        normalResources.forEach((name, resource) -> {
            try {
                resource.cleanup();
                System.out.println("âœ… æ™®é€šèµ„æºæ¸…ç†æˆåŠŸï¼š" + name);
            } catch (Exception e) {
                System.out.println("âš ï¸ æ™®é€šèµ„æºæ¸…ç†å¤±è´¥ï¼š" + name);
            }
        });
        normalResources.clear();
    }
    
    private void cleanupOptionalResources() {
        optionalResources.clear();
        System.out.println("â„¹ï¸ å¯é€‰èµ„æºå·²æ¸…ç†");
    }
    
    // èµ„æºæ³¨å†Œæ–¹æ³•
    public void registerCriticalResource(String name, AutoCloseable resource) {
        criticalResources.put(name, resource);
    }
    
    public void registerNormalResource(String name, Cleanable resource) {
        normalResources.put(name, resource);
    }
}
```

### 6.3 è¶…æ—¶æ¸…ç†æœºåˆ¶


**â° å®šæ—¶æ¸…ç†ç­–ç•¥**ï¼š

```java
public class TimeoutCleaner implements HttpSessionBindingListener {
    
    private final ScheduledExecutorService scheduler = 
        Executors.newSingleThreadScheduledExecutor();
    
    private ScheduledFuture<?> timeoutTask;
    
    @Override
    public void valueBound(HttpSessionBindingEvent event) {
        // å¯åŠ¨è¶…æ—¶æ¸…ç†ä»»åŠ¡
        timeoutTask = scheduler.schedule(() -> {
            System.out.println("â° ä¼šè¯è¶…æ—¶ï¼Œæ‰§è¡Œé¢„æ¸…ç†");
            // æ‰§è¡Œé¢„æ¸…ç†æ“ä½œ
            performPreCleanup();
        }, 25, TimeUnit.MINUTES);  // æ¯”Sessionè¶…æ—¶æå‰5åˆ†é’Ÿ
    }
    
    @Override
    public void valueUnbound(HttpSessionBindingEvent event) {
        // å–æ¶ˆè¶…æ—¶ä»»åŠ¡
        if (timeoutTask != null && !timeoutTask.isCancelled()) {
            timeoutTask.cancel(false);
        }
        
        // æ‰§è¡Œæœ€ç»ˆæ¸…ç†
        performFinalCleanup();
        
        // å…³é—­è°ƒåº¦å™¨
        scheduler.shutdown();
    }
    
    private void performPreCleanup() {
        System.out.println("ğŸ§¹ æ‰§è¡Œé¢„æ¸…ç†ï¼šé‡Šæ”¾éå…³é”®èµ„æº");
        // æå‰é‡Šæ”¾ä¸€äº›ä¸é‡è¦çš„èµ„æº
    }
    
    private void performFinalCleanup() {
        System.out.println("ğŸ§¹ æ‰§è¡Œæœ€ç»ˆæ¸…ç†ï¼šé‡Šæ”¾æ‰€æœ‰èµ„æº");
        // é‡Šæ”¾æ‰€æœ‰å‰©ä½™èµ„æº
    }
}
```

---

## 7. ğŸš€ å†…å­˜ä¼˜åŒ–ä¸æœ€ä½³å®è·µ


### 7.1 å†…å­˜ä¼˜åŒ–ç­–ç•¥


**ğŸ“Š å†…å­˜ä½¿ç”¨ä¼˜åŒ–æŠ€å·§**ï¼š

```
å†…å­˜ä¼˜åŒ–é‡‘å­—å¡”ï¼š

        ğŸ” å¯¹è±¡æ± åŒ–
       /           \
    ğŸ”¸ å¼±å¼•ç”¨ç¼“å­˜   ğŸ”¸ å»¶è¿ŸåŠ è½½  
   /               \           \
ğŸ”¹ åŠæ—¶æ¸…ç†      ğŸ”¹ èµ„æºå¤ç”¨   ğŸ”¹ å¤§å°é™åˆ¶
```

### 7.2 ä¼˜åŒ–å®ç°ä»£ç 


```java
public class OptimizedSessionObject implements HttpSessionBindingListener {
    
    // ä½¿ç”¨å¼±å¼•ç”¨é¿å…å†…å­˜æ³„æ¼
    private final Map<String, WeakReference<CacheItem>> cache = 
        new ConcurrentHashMap<>();
    
    // é™åˆ¶é›†åˆå¤§å°
    private final int MAX_CACHE_SIZE = 1000;
    
    // å»¶è¿Ÿåˆå§‹åŒ–çš„é‡èµ„æº
    private volatile HeavyResource heavyResource;
    
    @Override
    public void valueBound(HttpSessionBindingEvent event) {
        System.out.println("ğŸ’¡ ä¼šè¯ç»‘å®š - ä½¿ç”¨å†…å­˜ä¼˜åŒ–ç­–ç•¥");
        // ä¸ç«‹å³åˆ›å»ºé‡èµ„æºï¼Œç­‰éœ€è¦æ—¶å†åˆ›å»º
    }
    
    @Override
    public void valueUnbound(HttpSessionBindingEvent event) {
        // æ¸…ç†ç¼“å­˜
        cache.clear();
        
        // æ¸…ç†é‡èµ„æº
        if (heavyResource != null) {
            heavyResource.cleanup();
            heavyResource = null;
        }
        
        System.out.println("ğŸ§¹ å†…å­˜ä¼˜åŒ–æ¸…ç†å®Œæˆ");
    }
    
    // å»¶è¿ŸåŠ è½½é‡èµ„æº
    public HeavyResource getHeavyResource() {
        if (heavyResource == null) {
            synchronized (this) {
                if (heavyResource == null) {
                    heavyResource = new HeavyResource();
                    System.out.println("ğŸ“¦ å»¶è¿Ÿåˆ›å»ºé‡èµ„æº");
                }
            }
        }
        return heavyResource;
    }
    
    // ç¼“å­˜å¤§å°æ§åˆ¶
    public void addToCache(String key, CacheItem item) {
        if (cache.size() >= MAX_CACHE_SIZE) {
            // æ¸…ç†ä¸€äº›æ—§çš„ç¼“å­˜é¡¹
            cleanupOldCache();
        }
        cache.put(key, new WeakReference<>(item));
    }
    
    private void cleanupOldCache() {
        // ç§»é™¤å·²ç»è¢«GCçš„å¼±å¼•ç”¨
        cache.entrySet().removeIf(entry -> entry.getValue().get() == null);
        System.out.println("ğŸ§¹ æ¸…ç†äº†æ— æ•ˆç¼“å­˜é¡¹");
    }
}
```

### 7.3 æ€§èƒ½ç›‘æ§ä¸è°ƒä¼˜


**ğŸ“ˆ æ€§èƒ½ç›‘æ§å®ç°**ï¼š

```java
public class PerformanceMonitor implements HttpSessionBindingListener {
    
    private long bindTime;
    private long memoryUsageAtBind;
    
    @Override
    public void valueBound(HttpSessionBindingEvent event) {
        bindTime = System.currentTimeMillis();
        memoryUsageAtBind = getUsedMemory();
        
        System.out.printf("ğŸ“Š ä¼šè¯ç»‘å®š - æ—¶é—´:%s, å†…å­˜:%dMB%n", 
                         new Date(), memoryUsageAtBind / 1024 / 1024);
    }
    
    @Override
    public void valueUnbound(HttpSessionBindingEvent event) {
        long unbindTime = System.currentTimeMillis();
        long memoryUsageAtUnbind = getUsedMemory();
        
        long sessionDuration = unbindTime - bindTime;
        long memoryDelta = memoryUsageAtUnbind - memoryUsageAtBind;
        
        System.out.printf("ğŸ“Š ä¼šè¯è§£ç»‘ - æŒç»­æ—¶é—´:%dms, å†…å­˜å˜åŒ–:%+dMB%n",
                         sessionDuration, memoryDelta / 1024 / 1024);
        
        // å¦‚æœå†…å­˜å¢é•¿å¼‚å¸¸ï¼Œè®°å½•è­¦å‘Š
        if (memoryDelta > 50 * 1024 * 1024) { // 50MB
            System.out.println("âš ï¸ è­¦å‘Šï¼šä¼šè¯æœŸé—´å†…å­˜å¢é•¿è¿‡å¤šï¼");
        }
    }
    
    private long getUsedMemory() {
        Runtime runtime = Runtime.getRuntime();
        return runtime.totalMemory() - runtime.freeMemory();
    }
}
```

### 7.4 æœ€ä½³å®è·µæ€»ç»“


**âœ… æ¨èå®è·µ**ï¼š

1. **ğŸ¯ åˆç†è®¾è®¡å¯¹è±¡å¤§å°** - é¿å…åœ¨Sessionä¸­å­˜å‚¨è¿‡å¤§å¯¹è±¡
2. **â±ï¸ åŠæ—¶æ¸…ç†èµ„æº** - åœ¨`valueUnbound()`ä¸­é‡Šæ”¾æ‰€æœ‰èµ„æº
3. **ğŸ”’ çº¿ç¨‹å®‰å…¨è€ƒè™‘** - ä½¿ç”¨é€‚å½“çš„åŒæ­¥æœºåˆ¶
4. **ğŸ“ å……åˆ†çš„æ—¥å¿—è®°å½•** - ä¾¿äºé—®é¢˜æ’æŸ¥å’Œæ€§èƒ½åˆ†æ
5. **ğŸ§ª å……åˆ†çš„æµ‹è¯•** - æµ‹è¯•å„ç§è§£ç»‘åœºæ™¯

**âŒ é¿å…é™·é˜±**ï¼š

1. **ğŸš« åœ¨è§£ç»‘æ–¹æ³•ä¸­è®¿é—®Session** - Sessionå¯èƒ½å·²å¤±æ•ˆ
2. **ğŸš« é•¿æ—¶é—´é˜»å¡æ“ä½œ** - å½±å“åº”ç”¨æ€§èƒ½
3. **ğŸš« å¿½ç•¥å¼‚å¸¸å¤„ç†** - å¯èƒ½å¯¼è‡´èµ„æºæ³„æ¼
4. **ğŸš« å¾ªç¯å¼•ç”¨** - å¯¼è‡´å†…å­˜æ³„æ¼

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Sessionç»‘å®šç›‘å¬å™¨ï¼šå¯¹è±¡è‡ªå·±æ„ŸçŸ¥ç»‘å®šå’Œè§£ç»‘çŠ¶æ€
ğŸ”¸ HttpSessionBindingListenerï¼šå®ç°æ¥å£å³å¯è·å¾—ç›‘å¬èƒ½åŠ›
ğŸ”¸ valueBound()ï¼šå¯¹è±¡ç»‘å®šåˆ°Sessionæ—¶è‡ªåŠ¨è°ƒç”¨
ğŸ”¸ valueUnbound()ï¼šå¯¹è±¡ä»Sessionç§»é™¤æ—¶è‡ªåŠ¨è°ƒç”¨  
ğŸ”¸ è‡ªåŠ¨èµ„æºç®¡ç†ï¼šæ— éœ€æ‰‹åŠ¨æ¸…ç†ï¼Œè§£ç»‘æ—¶è‡ªåŠ¨æ‰§è¡Œ
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ç›‘å¬å™¨çš„æœ¬è´¨**
```
Sessionç»‘å®šç›‘å¬å™¨ = æ™ºèƒ½å¯¹è±¡ + è‡ªæˆ‘ç®¡ç†èƒ½åŠ›
â€¢ å¯¹è±¡çŸ¥é“è‡ªå·±ä½•æ—¶è¢«ä½¿ç”¨
â€¢ å¯¹è±¡çŸ¥é“è‡ªå·±ä½•æ—¶è¢«é‡Šæ”¾  
â€¢ å¯¹è±¡èƒ½å¤Ÿè‡ªåŠ¨ç®¡ç†è‡ªå·±çš„èµ„æº
```

**ğŸ”¹ ç”Ÿå‘½å‘¨æœŸç®¡ç†ä»·å€¼**
```
ä¼ ç»Ÿæ–¹å¼ï¼šæ‰‹åŠ¨ç®¡ç† â†’ å®¹æ˜“å‡ºé”™ â†’ èµ„æºæ³„æ¼
ç›‘å¬å™¨æ–¹å¼ï¼šè‡ªåŠ¨ç®¡ç† â†’ ç¡®ä¿æ¸…ç† â†’ ç³»ç»Ÿç¨³å®š
```

**ğŸ”¹ é€‚ç”¨åœºæ™¯åˆ¤æ–­**
```
âœ… é€‚åˆä½¿ç”¨ï¼š
â€¢ å¯¹è±¡éœ€è¦å ç”¨ç³»ç»Ÿèµ„æº
â€¢ éœ€è¦ç²¾ç¡®çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†
â€¢ å¸Œæœ›è‡ªåŠ¨åŒ–æ¸…ç†è¿‡ç¨‹

âŒ ä¸é€‚åˆä½¿ç”¨ï¼š
â€¢ ç®€å•çš„æ•°æ®å¯¹è±¡
â€¢ ä¸å ç”¨å¤–éƒ¨èµ„æº
â€¢ æ€§èƒ½è¦æ±‚æè‡´çš„åœºæ™¯
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ å¼€å‘å»ºè®®**ï¼š
- ä¼˜å…ˆè€ƒè™‘èµ„æºæ¸…ç†çš„å®Œæ•´æ€§
- è®¾è®¡æ—¶å°±è€ƒè™‘å†…å­˜ä¼˜åŒ–
- æ·»åŠ ç›‘æ§å’Œæ—¥å¿—ä¾¿äºè°ƒè¯•
- è¿›è¡Œå……åˆ†çš„æµ‹è¯•éªŒè¯

**ğŸ”§ è°ƒè¯•æŠ€å·§**ï¼š
- ä½¿ç”¨æ—¥å¿—è·Ÿè¸ªå¯¹è±¡ç”Ÿå‘½å‘¨æœŸ
- ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ
- æµ‹è¯•å„ç§Sessionå¤±æ•ˆåœºæ™¯
- éªŒè¯èµ„æºæ¸…ç†çš„å®Œæ•´æ€§

**æ ¸å¿ƒè®°å¿†**ï¼š
- Sessionç»‘å®šç›‘å¬å™¨è®©å¯¹è±¡æ‹¥æœ‰è‡ªæˆ‘ç®¡ç†èƒ½åŠ›
- valueBoundå’ŒvalueUnboundæ„æˆå®Œæ•´ç”Ÿå‘½å‘¨æœŸ
- èµ„æºè‡ªåŠ¨æ¸…ç†æ˜¯æœ€å¤§çš„åº”ç”¨ä»·å€¼
- å†…å­˜ä¼˜åŒ–å’Œæ€§èƒ½ç›‘æ§ä¸å¯å¿½è§†