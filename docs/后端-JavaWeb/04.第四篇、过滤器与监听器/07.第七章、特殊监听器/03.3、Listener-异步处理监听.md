---
title: 3ã€Listener-å¼‚æ­¥å¤„ç†ç›‘å¬
---
## ğŸ“š ç›®å½•

1. [å¼‚æ­¥ç›‘å¬å™¨åŸºç¡€æ¦‚å¿µ](#1-å¼‚æ­¥ç›‘å¬å™¨åŸºç¡€æ¦‚å¿µ)
2. [AsyncListeneræ¥å£è¯¦è§£](#2-AsyncListeneræ¥å£è¯¦è§£)
3. [å¼‚æ­¥ç›‘å¬å™¨çš„å››å¤§æ–¹æ³•](#3-å¼‚æ­¥ç›‘å¬å™¨çš„å››å¤§æ–¹æ³•)
4. [å¼‚æ­¥è¯·æ±‚ç”Ÿå‘½å‘¨æœŸ](#4-å¼‚æ­¥è¯·æ±‚ç”Ÿå‘½å‘¨æœŸ)
5. [å®æˆ˜åº”ç”¨åœºæ™¯](#5-å®æˆ˜åº”ç”¨åœºæ™¯)
6. [å¼‚æ­¥æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#6-å¼‚æ­¥æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸš€ å¼‚æ­¥ç›‘å¬å™¨åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯å¼‚æ­¥ç›‘å¬å™¨


**ğŸ”¸ ç®€å•ç†è§£**
æƒ³è±¡ä½ ç‚¹äº†ä¸€ä»½å¤–å–ï¼Œä½ ä¸ä¼šä¸€ç›´ç«™åœ¨é—¨å£ç­‰ï¼Œè€Œæ˜¯åšå…¶ä»–äº‹æƒ…ã€‚å½“å¤–å–åˆ°äº†ï¼Œé…é€å‘˜ä¼šé€šçŸ¥ä½ ã€‚å¼‚æ­¥ç›‘å¬å™¨å°±åƒè¿™ä¸ª"é€šçŸ¥æœºåˆ¶"ã€‚

```
ä¼ ç»ŸåŒæ­¥å¤„ç†ï¼š
ç”¨æˆ·è¯·æ±‚ â†’ æœåŠ¡å™¨å¤„ç† â†’ ç­‰å¾…å®Œæˆ â†’ è¿”å›ç»“æœ
(æœåŠ¡å™¨çº¿ç¨‹ä¸€ç›´è¢«å ç”¨ï¼Œç›´åˆ°å®Œæˆ)

å¼‚æ­¥å¤„ç†ï¼š
ç”¨æˆ·è¯·æ±‚ â†’ æœåŠ¡å™¨å¯åŠ¨å¼‚æ­¥ä»»åŠ¡ â†’ ç«‹å³é‡Šæ”¾çº¿ç¨‹ â†’ å¼‚æ­¥å®Œæˆåé€šçŸ¥
(æœåŠ¡å™¨çº¿ç¨‹å¯ä»¥å»å¤„ç†å…¶ä»–è¯·æ±‚)
```

**ğŸ¯ æ ¸å¿ƒä½œç”¨**
- **ç›‘æ§å¼‚æ­¥ä»»åŠ¡çŠ¶æ€** - çŸ¥é“ä»»åŠ¡ä»€ä¹ˆæ—¶å€™å®Œæˆã€å‡ºé”™æˆ–è¶…æ—¶
- **èµ„æºç®¡ç†** - åœ¨ä»»åŠ¡ç»“æŸæ—¶æ¸…ç†èµ„æº
- **é”™è¯¯å¤„ç†** - ç»Ÿä¸€å¤„ç†å¼‚æ­¥ä»»åŠ¡ä¸­çš„å¼‚å¸¸
- **æ€§èƒ½ç›‘æ§** - ç»Ÿè®¡å¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡Œæƒ…å†µ

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦å¼‚æ­¥ç›‘å¬å™¨


**ğŸ“Š ä¼ ç»ŸåŒæ­¥é—®é¢˜**

```
åŒæ­¥å¤„ç†åœºæ™¯ï¼š
å®¢æˆ·ç«¯Aè¯·æ±‚ â†’ å ç”¨çº¿ç¨‹1 â†’ å¤„ç†3ç§’ â†’ è¿”å›ç»“æœ â†’ é‡Šæ”¾çº¿ç¨‹1
å®¢æˆ·ç«¯Bè¯·æ±‚ â†’ ç­‰å¾…çº¿ç¨‹1é‡Šæ”¾ â†’ å ç”¨çº¿ç¨‹1 â†’ å¤„ç†2ç§’ â†’ è¿”å›ç»“æœ

é—®é¢˜ï¼šçº¿ç¨‹åˆ©ç”¨ç‡ä½ï¼Œå¹¶å‘èƒ½åŠ›å·®
```

**âš¡ å¼‚æ­¥å¤„ç†ä¼˜åŠ¿**

```
å¼‚æ­¥å¤„ç†åœºæ™¯ï¼š
å®¢æˆ·ç«¯Aè¯·æ±‚ â†’ å¯åŠ¨å¼‚æ­¥ä»»åŠ¡ â†’ ç«‹å³é‡Šæ”¾çº¿ç¨‹ â†’ çº¿ç¨‹å»å¤„ç†å…¶ä»–è¯·æ±‚
å¼‚æ­¥ä»»åŠ¡å®Œæˆ â†’ è§¦å‘ç›‘å¬å™¨ â†’ è¿”å›ç»“æœç»™å®¢æˆ·ç«¯A

ä¼˜åŠ¿ï¼šçº¿ç¨‹åˆ©ç”¨ç‡é«˜ï¼Œå¹¶å‘èƒ½åŠ›å¼º
```

---

## 2. ğŸ“‹ AsyncListeneræ¥å£è¯¦è§£


### 2.1 æ¥å£åŸºæœ¬ç»“æ„


**ğŸ”¸ AsyncListeneræ˜¯ä»€ä¹ˆ**
`AsyncListener`æ˜¯Java Servlet 3.0å¼•å…¥çš„æ¥å£ï¼Œä¸“é—¨ç”¨æ¥ç›‘å¬å¼‚æ­¥è¯·æ±‚çš„å„ç§çŠ¶æ€å˜åŒ–ã€‚

```java
public interface AsyncListener extends EventListener {
    void onComplete(AsyncEvent event) throws IOException;
    void onTimeout(AsyncEvent event) throws IOException;
    void onError(AsyncEvent event) throws IOException;
    void onStartAsync(AsyncEvent event) throws IOException;
}
```

**ğŸ’¡ å››ä¸ªæ ¸å¿ƒæ–¹æ³•çš„å«ä¹‰**
- `onComplete` - å¼‚æ­¥ä»»åŠ¡**æ­£å¸¸å®Œæˆ**æ—¶è°ƒç”¨
- `onTimeout` - å¼‚æ­¥ä»»åŠ¡**è¶…æ—¶**æ—¶è°ƒç”¨
- `onError` - å¼‚æ­¥ä»»åŠ¡**å‡ºé”™**æ—¶è°ƒç”¨
- `onStartAsync` - å¼‚æ­¥ä»»åŠ¡**å¼€å§‹**æ—¶è°ƒç”¨

### 2.2 AsyncEventå‚æ•°è¯¦è§£


**ğŸ”¸ AsyncEventæ˜¯ä»€ä¹ˆ**
å®ƒæ˜¯å¼‚æ­¥äº‹ä»¶çš„è½½ä½“ï¼ŒåŒ…å«äº†å¼‚æ­¥è¯·æ±‚çš„æ‰€æœ‰é‡è¦ä¿¡æ¯ã€‚

```java
// AsyncEventæä¾›çš„ä¸»è¦æ–¹æ³•
AsyncContext getAsyncContext()    // è·å–å¼‚æ­¥ä¸Šä¸‹æ–‡
ServletRequest getSuppliedRequest()  // è·å–è¯·æ±‚å¯¹è±¡
ServletResponse getSuppliedResponse() // è·å–å“åº”å¯¹è±¡
Throwable getThrowable()         // è·å–å¼‚å¸¸ä¿¡æ¯(å¦‚æœæœ‰çš„è¯)
```

---

## 3. ğŸ”§ å¼‚æ­¥ç›‘å¬å™¨çš„å››å¤§æ–¹æ³•


### 3.1 onCompleteå®Œæˆç›‘å¬


**ğŸ¯ ä»€ä¹ˆæ—¶å€™è§¦å‘**
å½“å¼‚æ­¥ä»»åŠ¡æ­£å¸¸å®Œæˆå¹¶è°ƒç”¨`AsyncContext.complete()`æ—¶è§¦å‘ã€‚

```java
public class MyAsyncListener implements AsyncListener {
    @Override
    public void onComplete(AsyncEvent event) throws IOException {
        System.out.println("âœ… å¼‚æ­¥ä»»åŠ¡å®Œæˆäº†ï¼");
        
        // è®°å½•å®Œæˆæ—¶é—´
        long endTime = System.currentTimeMillis();
        ServletRequest request = event.getSuppliedRequest();
        Long startTime = (Long) request.getAttribute("startTime");
        System.out.println("ä»»åŠ¡è€—æ—¶ï¼š" + (endTime - startTime) + "ms");
        
        // æ¸…ç†èµ„æº
        // å…³é—­æ•°æ®åº“è¿æ¥ã€æ¸…ç†ç¼“å­˜ç­‰
    }
}
```

**ğŸ“ å®é™…åº”ç”¨åœºæ™¯**
- è®°å½•ä»»åŠ¡æ‰§è¡Œæ—¶é—´
- æ¸…ç†ä¸´æ—¶èµ„æº
- å‘é€å®Œæˆé€šçŸ¥
- æ›´æ–°ç»Ÿè®¡æ•°æ®

### 3.2 onTimeoutè¶…æ—¶ç›‘å¬


**â° ä»€ä¹ˆæ—¶å€™è§¦å‘**
å½“å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œæ—¶é—´è¶…è¿‡è®¾å®šçš„è¶…æ—¶æ—¶é—´æ—¶è§¦å‘ã€‚

```java
@Override
public void onTimeout(AsyncEvent event) throws IOException {
    System.out.println("â° å¼‚æ­¥ä»»åŠ¡è¶…æ—¶äº†ï¼");
    
    AsyncContext asyncContext = event.getAsyncContext();
    ServletResponse response = asyncContext.getResponse();
    
    // è®¾ç½®è¶…æ—¶å“åº”
    response.setContentType("application/json;charset=UTF-8");
    response.getWriter().write("{\"error\":\"è¯·æ±‚è¶…æ—¶\",\"code\":408}");
    
    // å®Œæˆå¼‚æ­¥å¤„ç†
    asyncContext.complete();
}
```

**ğŸš¨ è¶…æ—¶å¤„ç†ç­–ç•¥**
- **è®°å½•è¶…æ—¶æ—¥å¿—** - ä¾¿äºé—®é¢˜æ’æŸ¥
- **è¿”å›å‹å¥½æç¤º** - å‘ŠçŸ¥ç”¨æˆ·è¯·æ±‚è¶…æ—¶
- **æ¸…ç†èµ„æº** - é¿å…èµ„æºæ³„éœ²
- **ç»Ÿè®¡è¶…æ—¶ç‡** - ç›‘æ§ç³»ç»Ÿæ€§èƒ½

### 3.3 onErroré”™è¯¯ç›‘å¬


**ğŸ’¥ ä»€ä¹ˆæ—¶å€™è§¦å‘**
å½“å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸æ—¶è§¦å‘ã€‚

```java
@Override
public void onError(AsyncEvent event) throws IOException {
    System.out.println("ğŸ’¥ å¼‚æ­¥ä»»åŠ¡å‡ºé”™äº†ï¼");
    
    Throwable throwable = event.getThrowable();
    System.out.println("é”™è¯¯ä¿¡æ¯ï¼š" + throwable.getMessage());
    
    AsyncContext asyncContext = event.getAsyncContext();
    ServletResponse response = asyncContext.getResponse();
    
    // è®¾ç½®é”™è¯¯å“åº”
    response.setContentType("application/json;charset=UTF-8");
    response.getWriter().write("{\"error\":\"æœåŠ¡å™¨å†…éƒ¨é”™è¯¯\",\"code\":500}");
    
    // å®Œæˆå¼‚æ­¥å¤„ç†
    asyncContext.complete();
}
```

**ğŸ› ï¸ é”™è¯¯å¤„ç†æœ€ä½³å®è·µ**
- **è®°å½•è¯¦ç»†é”™è¯¯ä¿¡æ¯** - åŒ…æ‹¬å †æ ˆè·Ÿè¸ª
- **åˆ†ç±»å¤„ç†ä¸åŒé”™è¯¯** - ä¸šåŠ¡å¼‚å¸¸ã€ç³»ç»Ÿå¼‚å¸¸åŒºåˆ«å¯¹å¾…
- **è¿”å›åˆé€‚çš„çŠ¶æ€ç ** - 400ã€500ç­‰HTTPçŠ¶æ€ç 
- **é€šçŸ¥è¿ç»´äººå‘˜** - ä¸¥é‡é”™è¯¯åŠæ—¶å‘Šè­¦

### 3.4 onStartAsyncå¯åŠ¨ç›‘å¬


**ğŸš€ ä»€ä¹ˆæ—¶å€™è§¦å‘**
å½“å¼‚æ­¥ä»»åŠ¡å¼€å§‹æ—¶è§¦å‘ï¼Œé€šå¸¸ç”¨äºåˆå§‹åŒ–å·¥ä½œã€‚

```java
@Override
public void onStartAsync(AsyncEvent event) throws IOException {
    System.out.println("ğŸš€ å¼‚æ­¥ä»»åŠ¡å¼€å§‹äº†ï¼");
    
    ServletRequest request = event.getSuppliedRequest();
    
    // è®°å½•å¼€å§‹æ—¶é—´
    request.setAttribute("startTime", System.currentTimeMillis());
    
    // è®¾ç½®è¯·æ±‚IDï¼Œä¾¿äºè¿½è¸ª
    String requestId = UUID.randomUUID().toString();
    request.setAttribute("requestId", requestId);
    
    System.out.println("è¯·æ±‚IDï¼š" + requestId);
}
```

---

## 4. ğŸ”„ å¼‚æ­¥è¯·æ±‚ç”Ÿå‘½å‘¨æœŸ


### 4.1 å®Œæ•´ç”Ÿå‘½å‘¨æœŸå›¾ç¤º


```
å®¢æˆ·ç«¯è¯·æ±‚
    â†“
Servletå¤„ç†
    â†“
startAsync() â† å¼€å§‹å¼‚æ­¥å¤„ç†
    â†“
onStartAsync() â† è§¦å‘å¯åŠ¨ç›‘å¬
    â†“
å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œä¸­...
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ­£å¸¸å®Œæˆ       â”‚     ä»»åŠ¡è¶…æ—¶     â”‚     å‘ç”Ÿé”™è¯¯     â”‚
â”‚      â†“          â”‚        â†“        â”‚        â†“        â”‚
â”‚ onComplete()    â”‚  onTimeout()    â”‚   onError()     â”‚
â”‚      â†“          â”‚        â†“        â”‚        â†“        â”‚
â”‚ complete()      â”‚  complete()     â”‚  complete()     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
è¿”å›å“åº”ç»™å®¢æˆ·ç«¯
```

### 4.2 ç”Ÿå‘½å‘¨æœŸè¯¦ç»†æ­¥éª¤


**1ï¸âƒ£ å¯åŠ¨é˜¶æ®µ**
```java
// åœ¨Servletä¸­å¯åŠ¨å¼‚æ­¥å¤„ç†
AsyncContext asyncContext = request.startAsync();
asyncContext.addListener(new MyAsyncListener());
asyncContext.setTimeout(30000); // è®¾ç½®30ç§’è¶…æ—¶
```

**2ï¸âƒ£ æ‰§è¡Œé˜¶æ®µ**
```java
// åœ¨æ–°çº¿ç¨‹ä¸­æ‰§è¡Œè€—æ—¶ä»»åŠ¡
executor.execute(() -> {
    try {
        // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
        Thread.sleep(5000);
        
        // å†™å…¥å“åº”
        response.getWriter().write("å¼‚æ­¥ä»»åŠ¡å®Œæˆ");
        
        // å®Œæˆå¼‚æ­¥å¤„ç†
        asyncContext.complete();
    } catch (Exception e) {
        // å¼‚å¸¸ä¼šè§¦å‘onError
        throw new RuntimeException(e);
    }
});
```

**3ï¸âƒ£ ç»“æŸé˜¶æ®µ**
- æ­£å¸¸å®Œæˆï¼šè§¦å‘`onComplete`
- è¶…æ—¶ï¼šè§¦å‘`onTimeout`
- å¼‚å¸¸ï¼šè§¦å‘`onError`

---

## 5. ğŸ’¼ å®æˆ˜åº”ç”¨åœºæ™¯


### 5.1 æ–‡ä»¶ä¸Šä¼ è¿›åº¦ç›‘æ§


**ğŸ¯ åº”ç”¨åœºæ™¯**
å¤§æ–‡ä»¶ä¸Šä¼ æ—¶ï¼Œç”¨æˆ·éœ€è¦çŸ¥é“ä¸Šä¼ è¿›åº¦ï¼Œé¿å…é¡µé¢å‡æ­»ã€‚

```java
public class FileUploadListener implements AsyncListener {
    @Override
    public void onComplete(AsyncEvent event) throws IOException {
        // ä¸Šä¼ å®Œæˆï¼Œé€šçŸ¥å‰ç«¯
        ServletRequest request = event.getSuppliedRequest();
        String uploadId = (String) request.getAttribute("uploadId");
        
        // é€šè¿‡WebSocketæˆ–SSEé€šçŸ¥å‰ç«¯ä¸Šä¼ å®Œæˆ
        notifyUploadComplete(uploadId);
        
        // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        cleanupTempFiles(uploadId);
    }
    
    @Override
    public void onError(AsyncEvent event) throws IOException {
        // ä¸Šä¼ å¤±è´¥ï¼Œæ¸…ç†èµ„æº
        String uploadId = (String) event.getSuppliedRequest()
                                .getAttribute("uploadId");
        cleanupTempFiles(uploadId);
        notifyUploadError(uploadId, event.getThrowable());
    }
    
    // å…¶ä»–æ–¹æ³•çœç•¥...
}
```

### 5.2 é•¿æ—¶é—´æ•°æ®å¤„ç†


**ğŸ¯ åº”ç”¨åœºæ™¯**
æ•°æ®æŠ¥è¡¨ç”Ÿæˆã€æ‰¹é‡æ•°æ®å¯¼å…¥ç­‰è€—æ—¶æ“ä½œã€‚

```java
public class DataProcessListener implements AsyncListener {
    @Override
    public void onTimeout(AsyncEvent event) throws IOException {
        // æ•°æ®å¤„ç†è¶…æ—¶ï¼Œä¿å­˜ä¸­é—´çŠ¶æ€
        ServletRequest request = event.getSuppliedRequest();
        String taskId = (String) request.getAttribute("taskId");
        
        // ä¿å­˜å¤„ç†è¿›åº¦ï¼Œå…è®¸ç”¨æˆ·ç¨åæŸ¥çœ‹
        saveProcessProgress(taskId, "TIMEOUT");
        
        // è¿”å›è¶…æ—¶å“åº”
        AsyncContext ctx = event.getAsyncContext();
        ServletResponse response = ctx.getResponse();
        response.getWriter().write("æ•°æ®å¤„ç†è¶…æ—¶ï¼Œè¯·ç¨åæŸ¥çœ‹ç»“æœ");
        ctx.complete();
    }
}
```

### 5.3 ç¬¬ä¸‰æ–¹APIè°ƒç”¨


**ğŸ¯ åº”ç”¨åœºæ™¯**
è°ƒç”¨å¤–éƒ¨APIè·å–æ•°æ®ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚

```java
public class ApiCallListener implements AsyncListener {
    @Override
    public void onComplete(AsyncEvent event) throws IOException {
        // APIè°ƒç”¨å®Œæˆï¼Œè®°å½•è°ƒç”¨ç»Ÿè®¡
        ServletRequest request = event.getSuppliedRequest();
        String apiName = (String) request.getAttribute("apiName");
        Long startTime = (Long) request.getAttribute("startTime");
        
        // è®°å½•APIè°ƒç”¨æ—¶é—´
        long duration = System.currentTimeMillis() - startTime;
        recordApiCallTime(apiName, duration);
    }
    
    @Override
    public void onError(AsyncEvent event) throws IOException {
        // APIè°ƒç”¨å¤±è´¥ï¼Œè®°å½•é”™è¯¯å¹¶é‡è¯•
        String apiName = (String) event.getSuppliedRequest()
                                .getAttribute("apiName");
        recordApiError(apiName, event.getThrowable());
        
        // å¯ä»¥è€ƒè™‘é‡è¯•æœºåˆ¶
        scheduleRetry(apiName);
    }
}
```

---

## 6. âš¡ å¼‚æ­¥æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


### 6.1 åˆç†è®¾ç½®è¶…æ—¶æ—¶é—´


**ğŸ“Š è¶…æ—¶æ—¶é—´è®¾ç½®åŸåˆ™**

| ä»»åŠ¡ç±»å‹ | **å»ºè®®è¶…æ—¶æ—¶é—´** | **è¯´æ˜** |
|---------|----------------|---------|
| `æ•°æ®åº“æŸ¥è¯¢` | 5-10ç§’ | è¶…è¿‡æ­¤æ—¶é—´å¯èƒ½æ˜¯SQLæ€§èƒ½é—®é¢˜ |
| `æ–‡ä»¶ä¸Šä¼ ` | æ ¹æ®æ–‡ä»¶å¤§å° | ä¸€èˆ¬æŒ‰1MB/ç§’è®¡ç®— |
| `ç¬¬ä¸‰æ–¹API` | 10-30ç§’ | æ ¹æ®APIæä¾›æ–¹çš„æ€§èƒ½ç‰¹ç‚¹ |
| `æ•°æ®å¤„ç†` | 60-300ç§’ | å¤æ‚è®¡ç®—å¯é€‚å½“å»¶é•¿ |

```java
// åŠ¨æ€è®¾ç½®è¶…æ—¶æ—¶é—´
AsyncContext asyncContext = request.startAsync();
String taskType = request.getParameter("taskType");

switch(taskType) {
    case "upload":
        long fileSize = getFileSize(request);
        int timeout = (int)(fileSize / 1024 / 1024 * 1000); // 1MB/ç§’
        asyncContext.setTimeout(Math.max(timeout, 10000)); // æœ€å°‘10ç§’
        break;
    case "report":
        asyncContext.setTimeout(300000); // æŠ¥è¡¨ç”Ÿæˆ5åˆ†é’Ÿ
        break;
    default:
        asyncContext.setTimeout(30000); // é»˜è®¤30ç§’
}
```

### 6.2 çº¿ç¨‹æ± ç®¡ç†ä¼˜åŒ–


**ğŸ”§ åˆç†é…ç½®çº¿ç¨‹æ± **

```java
public class AsyncThreadPoolConfig {
    private static ExecutorService asyncExecutor;
    
    static {
        // æ ¹æ®CPUæ ¸å¿ƒæ•°é…ç½®çº¿ç¨‹æ± 
        int corePoolSize = Runtime.getRuntime().availableProcessors();
        int maximumPoolSize = corePoolSize * 2;
        
        asyncExecutor = new ThreadPoolExecutor(
            corePoolSize,
            maximumPoolSize,
            60L, TimeUnit.SECONDS,
            new LinkedBlockingQueue<>(1000), // é™åˆ¶é˜Ÿåˆ—å¤§å°
            new ThreadFactory() {
                private AtomicInteger counter = new AtomicInteger(1);
                @Override
                public Thread newThread(Runnable r) {
                    Thread t = new Thread(r, "async-" + counter.getAndIncrement());
                    t.setDaemon(true);
                    return t;
                }
            },
            new ThreadPoolExecutor.CallerRunsPolicy() // æ‹’ç»ç­–ç•¥
        );
    }
    
    public static ExecutorService getExecutor() {
        return asyncExecutor;
    }
}
```

### 6.3 èµ„æºæ¸…ç†æœ€ä½³å®è·µ


**ğŸ§¹ èµ„æºæ¸…ç†æ£€æŸ¥æ¸…å•**

```java
public class ResourceCleanupListener implements AsyncListener {
    @Override
    public void onComplete(AsyncEvent event) throws IOException {
        cleanupResources(event);
    }
    
    @Override
    public void onTimeout(AsyncEvent event) throws IOException {
        cleanupResources(event);
    }
    
    @Override
    public void onError(AsyncEvent event) throws IOException {
        cleanupResources(event);
    }
    
    private void cleanupResources(AsyncEvent event) {
        ServletRequest request = event.getSuppliedRequest();
        
        // 1. å…³é—­æ•°æ®åº“è¿æ¥
        Connection conn = (Connection) request.getAttribute("dbConnection");
        if (conn != null) {
            try { conn.close(); } catch (Exception e) {}
        }
        
        // 2. æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        String tempFilePath = (String) request.getAttribute("tempFile");
        if (tempFilePath != null) {
            new File(tempFilePath).delete();
        }
        
        // 3. æ¸…ç†ç¼“å­˜
        String cacheKey = (String) request.getAttribute("cacheKey");
        if (cacheKey != null) {
            clearCache(cacheKey);
        }
        
        // 4. é‡Šæ”¾å…¶ä»–èµ„æº
        // ...
    }
}
```

### 6.4 ç›‘æ§å’Œç»Ÿè®¡


**ğŸ“ˆ æ€§èƒ½ç›‘æ§æŒ‡æ ‡**

```java
public class PerformanceMonitorListener implements AsyncListener {
    private static final Map<String, AtomicLong> statistics = new ConcurrentHashMap<>();
    
    @Override
    public void onStartAsync(AsyncEvent event) throws IOException {
        incrementCounter("async.started");
        event.getSuppliedRequest().setAttribute("startTime", System.currentTimeMillis());
    }
    
    @Override
    public void onComplete(AsyncEvent event) throws IOException {
        Long startTime = (Long) event.getSuppliedRequest().getAttribute("startTime");
        long duration = System.currentTimeMillis() - startTime;
        
        incrementCounter("async.completed");
        recordDuration("async.duration", duration);
    }
    
    @Override
    public void onTimeout(AsyncEvent event) throws IOException {
        incrementCounter("async.timeout");
    }
    
    @Override
    public void onError(AsyncEvent event) throws IOException {
        incrementCounter("async.error");
    }
    
    private void incrementCounter(String key) {
        statistics.computeIfAbsent(key, k -> new AtomicLong(0)).incrementAndGet();
    }
    
    private void recordDuration(String key, long duration) {
        // è®°å½•æ‰§è¡Œæ—¶é—´ç»Ÿè®¡
        // å¯ä»¥ä½¿ç”¨æ›´å¤æ‚çš„ç»Ÿè®¡åº“å¦‚Micrometer
    }
    
    // è·å–ç»Ÿè®¡ä¿¡æ¯çš„æ–¹æ³•
    public static Map<String, Long> getStatistics() {
        return statistics.entrySet().stream()
                .collect(Collectors.toMap(
                    Map.Entry::getKey,
                    e -> e.getValue().get()
                ));
    }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ AsyncListenerä½œç”¨ï¼šç›‘å¬å¼‚æ­¥è¯·æ±‚çš„ç”Ÿå‘½å‘¨æœŸ
ğŸ”¸ å››å¤§æ ¸å¿ƒæ–¹æ³•ï¼šonCompleteã€onTimeoutã€onErrorã€onStartAsync
ğŸ”¸ AsyncEventå‚æ•°ï¼šåŒ…å«å¼‚æ­¥è¯·æ±‚çš„æ‰€æœ‰ä¸Šä¸‹æ–‡ä¿¡æ¯
ğŸ”¸ ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼šä»å¯åŠ¨åˆ°ç»“æŸçš„å®Œæ•´æµç¨‹æ§åˆ¶
ğŸ”¸ èµ„æºæ¸…ç†ï¼šæ— è®ºæˆåŠŸå¤±è´¥éƒ½è¦æ¸…ç†èµ„æº
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å¼‚æ­¥ç›‘å¬å™¨çš„æœ¬è´¨**
```
ç›‘å¬å™¨ä¸æ˜¯æ‰§è¡Œè€…ï¼Œè€Œæ˜¯è§‚å¯Ÿè€…
- ä¸è´Ÿè´£æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡æœ¬èº«
- è´Ÿè´£ç›‘æ§ä»»åŠ¡çš„çŠ¶æ€å˜åŒ–
- åœ¨å…³é”®èŠ‚ç‚¹è¿›è¡Œå¿…è¦çš„å¤„ç†
```

**ğŸ”¹ ç”Ÿå‘½å‘¨æœŸç®¡ç†çš„é‡è¦æ€§**
```
å®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†åŒ…æ‹¬ï¼š
- å¯åŠ¨æ—¶çš„åˆå§‹åŒ–å·¥ä½œ
- æ‰§è¡Œè¿‡ç¨‹ä¸­çš„çŠ¶æ€è·Ÿè¸ª
- ç»“æŸæ—¶çš„èµ„æºæ¸…ç†
- å¼‚å¸¸æƒ…å†µçš„å¦¥å–„å¤„ç†
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–çš„æ ¸å¿ƒæ€è·¯**
```
å¼‚æ­¥å¤„ç†çš„æ€§èƒ½ä¼˜åŒ–é‡ç‚¹ï¼š
- åˆç†è®¾ç½®è¶…æ—¶æ—¶é—´
- ä¼˜åŒ–çº¿ç¨‹æ± é…ç½®
- åŠæ—¶æ¸…ç†èµ„æº
- ç›‘æ§å…³é”®æŒ‡æ ‡
```

### 7.3 å®é™…åº”ç”¨æŒ‡å¯¼


**âœ… é€‚åˆä½¿ç”¨å¼‚æ­¥ç›‘å¬å™¨çš„åœºæ™¯**
- æ–‡ä»¶ä¸Šä¼ ä¸‹è½½è¿›åº¦ç›‘æ§
- é•¿æ—¶é—´æ•°æ®å¤„ç†ä»»åŠ¡
- ç¬¬ä¸‰æ–¹APIè°ƒç”¨
- æŠ¥è¡¨ç”Ÿæˆç­‰è€—æ—¶æ“ä½œ

**âŒ ä¸é€‚åˆä½¿ç”¨çš„åœºæ™¯**
- ç®€å•å¿«é€Ÿçš„è¯·æ±‚å¤„ç†
- éœ€è¦ç«‹å³è¿”å›ç»“æœçš„æ“ä½œ
- èµ„æºæ¶ˆè€—å¾ˆå°çš„ä»»åŠ¡

**ğŸ› ï¸ å®æ–½å»ºè®®**
- **ä»ç®€å•å¼€å§‹** - å…ˆå®ç°åŸºæœ¬åŠŸèƒ½ï¼Œå†è€ƒè™‘ä¼˜åŒ–
- **ç»Ÿä¸€å¼‚å¸¸å¤„ç†** - å»ºç«‹å®Œå–„çš„å¼‚å¸¸å¤„ç†æœºåˆ¶
- **ç›‘æ§å¾ˆé‡è¦** - å»ºç«‹ç›‘æ§ä½“ç³»ï¼ŒåŠæ—¶å‘ç°é—®é¢˜
- **æµ‹è¯•è¦å……åˆ†** - ç‰¹åˆ«æ˜¯è¶…æ—¶å’Œå¼‚å¸¸åœºæ™¯çš„æµ‹è¯•

### 7.4 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ


**â“ é—®é¢˜1ï¼šå¼‚æ­¥ä»»åŠ¡ä¸€ç›´ä¸å®Œæˆæ€ä¹ˆåŠï¼Ÿ**
```
è§£å†³æ–¹æ¡ˆï¼š
- è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
- åœ¨onTimeoutä¸­å¤„ç†è¶…æ—¶é€»è¾‘
- è®°å½•è¯¦ç»†æ—¥å¿—ä¾¿äºæ’æŸ¥
```

**â“ é—®é¢˜2ï¼šèµ„æºæ²¡æœ‰æ­£ç¡®æ¸…ç†ï¼Ÿ**
```
è§£å†³æ–¹æ¡ˆï¼š
- åœ¨æ‰€æœ‰ç›‘å¬å™¨æ–¹æ³•ä¸­éƒ½è°ƒç”¨æ¸…ç†é€»è¾‘
- ä½¿ç”¨try-catchç¡®ä¿æ¸…ç†ä»£ç èƒ½æ‰§è¡Œ
- å®šæœŸæ£€æŸ¥ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ
```

**â“ é—®é¢˜3ï¼šç›‘å¬å™¨ä¸­çš„å¼‚å¸¸å¦‚ä½•å¤„ç†ï¼Ÿ**
```
è§£å†³æ–¹æ¡ˆï¼š
- ç›‘å¬å™¨æ–¹æ³•è¦æœ‰å®Œå–„çš„å¼‚å¸¸å¤„ç†
- è®°å½•å¼‚å¸¸æ—¥å¿—ä½†ä¸è¦æŠ›å‡º
- ç¡®ä¿asyncContext.complete()èƒ½æ­£å¸¸è°ƒç”¨
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- å¼‚æ­¥ç›‘å¬å››æ–¹æ³•ï¼Œå¯åŠ¨å®Œæˆè¶…æ—¶é”™
- ç”Ÿå‘½å‘¨æœŸè¦ç®¡å¥½ï¼Œèµ„æºæ¸…ç†ä¸èƒ½å°‘
- æ€§èƒ½ä¼˜åŒ–é‡ç›‘æ§ï¼Œåˆç†é…ç½®æ•ˆæœå¥½