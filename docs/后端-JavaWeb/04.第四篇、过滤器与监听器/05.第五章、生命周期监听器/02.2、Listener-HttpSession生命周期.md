---
title: 2ã€Listener-HttpSessionç”Ÿå‘½å‘¨æœŸ
---
## ğŸ“š ç›®å½•

1. [HttpSessionæ˜¯ä»€ä¹ˆ](#1-HttpSessionæ˜¯ä»€ä¹ˆ)
2. [HttpSessionListeneræ¥å£è¯¦è§£](#2-HttpSessionListeneræ¥å£è¯¦è§£)
3. [ä¼šè¯åˆ›å»ºç›‘å¬ sessionCreated](#3-ä¼šè¯åˆ›å»ºç›‘å¬-sessionCreated)
4. [ä¼šè¯é”€æ¯ç›‘å¬ sessionDestroyed](#4-ä¼šè¯é”€æ¯ç›‘å¬-sessionDestroyed)
5. [ä¼šè¯è¶…æ—¶ç›‘å¬æœºåˆ¶](#5-ä¼šè¯è¶…æ—¶ç›‘å¬æœºåˆ¶)
6. [åœ¨çº¿ç”¨æˆ·ç»Ÿè®¡å®æˆ˜](#6-åœ¨çº¿ç”¨æˆ·ç»Ÿè®¡å®æˆ˜)
7. [ä¼šè¯çŠ¶æ€ç®¡ç†](#7-ä¼šè¯çŠ¶æ€ç®¡ç†)
8. [å†…å­˜æ³„æ¼é˜²èŒƒ](#8-å†…å­˜æ³„æ¼é˜²èŒƒ)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ HttpSessionæ˜¯ä»€ä¹ˆ


### 1.1 ä»€ä¹ˆæ˜¯HttpSession


**ç®€å•ç†è§£**ï¼šæƒ³è±¡ä½ å»é“¶è¡ŒåŠä¸šåŠ¡ï¼Œæ¯æ¬¡éƒ½è¦æ’é˜Ÿå–å·ã€‚è¿™ä¸ªå·ç å°±ç›¸å½“äºSessionï¼Œå®ƒèƒ½è®©é“¶è¡ŒçŸ¥é“ä½ æ˜¯è°ï¼Œä½ åŠäº†ä»€ä¹ˆä¸šåŠ¡ã€‚

```
ç”¨æˆ·è®¿é—®ç½‘ç«™çš„è¿‡ç¨‹ï¼š

ç¬¬ä¸€æ¬¡è®¿é—®ç½‘ç«™ â†’ æœåŠ¡å™¨ç»™ä½ å‘ä¸€ä¸ª"èº«ä»½è¯å·"(SessionId) â†’ ä¿å­˜åˆ°Cookie
å†æ¬¡è®¿é—®ç½‘ç«™ â†’ æµè§ˆå™¨è‡ªåŠ¨å¸¦ä¸Š"èº«ä»½è¯å·" â†’ æœåŠ¡å™¨è®¤å‡ºä½ æ˜¯è°

è¿™ä¸ª"èº«ä»½è¯å·"å¯¹åº”çš„å°±æ˜¯HttpSessionå¯¹è±¡ï¼
```

**HttpSessionçš„ä½œç”¨**ï¼š
- ğŸ”¸ **èº«ä»½è¯†åˆ«**ï¼šåŒºåˆ†ä¸åŒç”¨æˆ·
- ğŸ”¸ **æ•°æ®å­˜å‚¨**ï¼šä¸´æ—¶ä¿å­˜ç”¨æˆ·ä¿¡æ¯
- ğŸ”¸ **çŠ¶æ€ç»´æŒ**ï¼šè®°ä½ç”¨æˆ·çš„æ“ä½œçŠ¶æ€

### 1.2 Sessionçš„ç”Ÿå‘½å‘¨æœŸ


```
ä¼šè¯ç”Ÿå‘½å‘¨æœŸå›¾ï¼š

åˆ›å»ºé˜¶æ®µ                ä½¿ç”¨é˜¶æ®µ                é”€æ¯é˜¶æ®µ
    â†“                      â†“                      â†“
ç”¨æˆ·é¦–æ¬¡è®¿é—®  â†’  æœåŠ¡å™¨ä½¿ç”¨ä¼šè¯æ•°æ®  â†’  ä¼šè¯è¿‡æœŸ/æ‰‹åŠ¨é”€æ¯
    â†“                      â†“                      â†“
åˆ›å»ºSession     å­˜å‚¨/è¯»å–ç”¨æˆ·æ•°æ®      é‡Šæ”¾å†…å­˜èµ„æº
    â†“                      â†“                      â†“
åˆ†é…SessionId   ç»´æŠ¤ä¼šè¯çŠ¶æ€          æ¸…ç†ç›¸å…³æ•°æ®
```

**ç”Ÿå‘½å‘¨æœŸçš„ä¸‰ä¸ªå…³é”®æ—¶åˆ»**ï¼š
1. **åˆ›å»º**ï¼šç”¨æˆ·ç¬¬ä¸€æ¬¡è®¿é—®æ—¶
2. **ä½¿ç”¨**ï¼šç”¨æˆ·åœ¨ç½‘ç«™ä¸Šçš„å„ç§æ“ä½œ
3. **é”€æ¯**ï¼šä¼šè¯è¶…æ—¶æˆ–ç”¨æˆ·é€€å‡º

---

## 2. ğŸ”§ HttpSessionListeneræ¥å£è¯¦è§£


### 2.1 HttpSessionListeneræ¥å£ä»‹ç»


**ä»€ä¹ˆæ˜¯ç›‘å¬å™¨**ï¼šå°±åƒé—¨å«ä¸€æ ·ï¼Œä¸“é—¨"ç›‘å¬"Sessionçš„åˆ›å»ºå’Œé”€æ¯äº‹ä»¶ã€‚

```java
// HttpSessionListeneræ¥å£ç»“æ„
public interface HttpSessionListener extends EventListener {
    
    // Sessionåˆ›å»ºæ—¶è°ƒç”¨
    public void sessionCreated(HttpSessionEvent se);
    
    // Sessioné”€æ¯æ—¶è°ƒç”¨  
    public void sessionDestroyed(HttpSessionEvent se);
}
```

**ç›‘å¬å™¨çš„å·¥ä½œåŸç†**ï¼š
```
ç›‘å¬å™¨å·¥ä½œæµç¨‹ï¼š

æœåŠ¡å™¨å¯åŠ¨ â†’ æ³¨å†Œç›‘å¬å™¨ â†’ ç­‰å¾…Sessionäº‹ä»¶
    â†“
Sessionåˆ›å»º â†’ è§¦å‘sessionCreatedæ–¹æ³• â†’ æ‰§è¡Œè‡ªå®šä¹‰é€»è¾‘
    â†“
Sessioné”€æ¯ â†’ è§¦å‘sessionDestroyedæ–¹æ³• â†’ æ‰§è¡Œæ¸…ç†é€»è¾‘
```

### 2.2 åˆ›å»ºç›‘å¬å™¨çš„æ­¥éª¤


**æ­¥éª¤ä¸€ï¼šåˆ›å»ºç›‘å¬å™¨ç±»**

```java
@WebListener  // æ³¨è§£æ–¹å¼æ³¨å†Œ
public class MySessionListener implements HttpSessionListener {
    
    @Override
    public void sessionCreated(HttpSessionEvent se) {
        // Sessionåˆ›å»ºæ—¶çš„å¤„ç†é€»è¾‘
    }
    
    @Override
    public void sessionDestroyed(HttpSessionEvent se) {
        // Sessioné”€æ¯æ—¶çš„å¤„ç†é€»è¾‘
    }
}
```

**æ­¥éª¤äºŒï¼šé…ç½®ç›‘å¬å™¨**ï¼ˆå¦‚æœä¸ç”¨æ³¨è§£ï¼‰

```xml
<!-- åœ¨web.xmlä¸­é…ç½® -->
<listener>
    <listener-class>com.example.MySessionListener</listener-class>
</listener>
```

---

## 3. ğŸš€ ä¼šè¯åˆ›å»ºç›‘å¬ sessionCreated


### 3.1 ä»€ä¹ˆæ—¶å€™è§¦å‘sessionCreated


**è§¦å‘æ—¶æœº**ï¼šå½“ç”¨æˆ·ç¬¬ä¸€æ¬¡è®¿é—®ç½‘ç«™ï¼ŒæœåŠ¡å™¨ä¸ºå…¶åˆ›å»ºæ–°Sessionæ—¶ã€‚

```
ç”¨æˆ·è®¿é—®æµç¨‹ï¼š

ç”¨æˆ·æ‰“å¼€æµè§ˆå™¨ â†’ è®¿é—®ç½‘ç«™é¦–é¡µ â†’ æœåŠ¡å™¨æ£€æŸ¥æ˜¯å¦æœ‰Session
    â†“
æ²¡æœ‰Session â†’ åˆ›å»ºæ–°Session â†’ è§¦å‘sessionCreatedäº‹ä»¶
    â†“
ç›‘å¬å™¨æ‰§è¡Œ â†’ å¯ä»¥è®°å½•ç”¨æˆ·è®¿é—®ã€åˆå§‹åŒ–æ•°æ®ç­‰
```

### 3.2 sessionCreatedæ–¹æ³•è¯¦è§£


```java
@WebListener
public class SessionCreateListener implements HttpSessionListener {
    
    @Override
    public void sessionCreated(HttpSessionEvent se) {
        // è·å–æ–°åˆ›å»ºçš„Sessionå¯¹è±¡
        HttpSession session = se.getSession();
        
        // è·å–SessionId
        String sessionId = session.getId();
        
        // è®°å½•Sessionåˆ›å»ºæ—¶é—´
        Date createTime = new Date(session.getCreationTime());
        
        System.out.println("æ–°ä¼šè¯åˆ›å»º: " + sessionId + ", æ—¶é—´: " + createTime);
    }
}
```

### 3.3 å®ç”¨åº”ç”¨åœºæ™¯


**åœºæ™¯1ï¼šè®°å½•ç”¨æˆ·è®¿é—®æ—¥å¿—**

```java
@Override
public void sessionCreated(HttpSessionEvent se) {
    HttpSession session = se.getSession();
    
    // è®°å½•è®¿é—®æ—¥å¿—
    String logInfo = String.format("ç”¨æˆ·è®¿é—® - SessionId: %s, æ—¶é—´: %s", 
        session.getId(), 
        new SimpleDateFormat("yyyy-MM-dd HH:mm:ss").format(new Date())
    );
    
    // å†™å…¥æ—¥å¿—æ–‡ä»¶æˆ–æ•°æ®åº“
    logger.info(logInfo);
}
```

**åœºæ™¯2ï¼šåˆå§‹åŒ–ç”¨æˆ·æ•°æ®**

```java
@Override
public void sessionCreated(HttpSessionEvent se) {
    HttpSession session = se.getSession();
    
    // ä¸ºæ–°ç”¨æˆ·åˆå§‹åŒ–è´­ç‰©è½¦
    session.setAttribute("shoppingCart", new ArrayList<>());
    
    // è®¾ç½®é»˜è®¤è¯­è¨€
    session.setAttribute("language", "zh_CN");
    
    // è®°å½•è®¿é—®æ¥æºï¼ˆå¦‚æœæœ‰ï¼‰
    // æ³¨æ„ï¼šè¿™é‡Œæ— æ³•ç›´æ¥è·å–requestï¼Œéœ€è¦å…¶ä»–æ–¹å¼
}
```

---

## 4. ğŸ”š ä¼šè¯é”€æ¯ç›‘å¬ sessionDestroyed


### 4.1 ä»€ä¹ˆæ—¶å€™è§¦å‘sessionDestroyed


**è§¦å‘æ—¶æœº**ï¼š

| é”€æ¯åŸå›  | **è¯´æ˜** | **æ˜¯å¦å¯æ§** |
|----------|----------|-------------|
| **è¶…æ—¶é”€æ¯** | `è¶…è¿‡è®¾ç½®çš„æœ€å¤§é—²ç½®æ—¶é—´` | `å¯é…ç½®` |
| **æ‰‹åŠ¨é”€æ¯** | `è°ƒç”¨session.invalidate()æ–¹æ³•` | `å®Œå…¨å¯æ§` |
| **æœåŠ¡å™¨å…³é—­** | `Webåº”ç”¨åœæ­¢æˆ–é‡å¯` | `è¿ç»´æ“ä½œ` |

### 4.2 sessionDestroyedæ–¹æ³•è¯¦è§£


```java
@Override
public void sessionDestroyed(HttpSessionEvent se) {
    HttpSession session = se.getSession();
    String sessionId = session.getId();
    
    System.out.println("ä¼šè¯é”€æ¯: " + sessionId);
    
    // è·å–Sessionä¸­çš„æ•°æ®è¿›è¡Œæ¸…ç†
    String username = (String) session.getAttribute("username");
    if (username != null) {
        System.out.println("ç”¨æˆ· " + username + " çš„ä¼šè¯å·²ç»“æŸ");
    }
}
```

### 4.3 é‡è¦æ¸…ç†å·¥ä½œ


**æ¸…ç†ç¤ºä¾‹ï¼šé‡Šæ”¾èµ„æº**

```java
@Override
public void sessionDestroyed(HttpSessionEvent se) {
    HttpSession session = se.getSession();
    
    // æ¸…ç†æ–‡ä»¶ä¸Šä¼ çš„ä¸´æ—¶æ–‡ä»¶
    List<File> tempFiles = (List<File>) session.getAttribute("tempFiles");
    if (tempFiles != null) {
        for (File file : tempFiles) {
            if (file.exists()) {
                file.delete();  // åˆ é™¤ä¸´æ—¶æ–‡ä»¶
            }
        }
    }
    
    // å…³é—­æ•°æ®åº“è¿æ¥ï¼ˆå¦‚æœæœ‰ï¼‰
    Connection conn = (Connection) session.getAttribute("dbConnection");
    if (conn != null) {
        try {
            conn.close();
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }
}
```

---

## 5. â° ä¼šè¯è¶…æ—¶ç›‘å¬æœºåˆ¶


### 5.1 ä»€ä¹ˆæ˜¯ä¼šè¯è¶…æ—¶


**ç®€å•ç†è§£**ï¼šå°±åƒå›¾ä¹¦é¦†çš„åº§ä½ï¼Œå¦‚æœä½ ç¦»å¼€å¤ªä¹…ä¸å›æ¥ï¼Œåº§ä½å°±è¢«æ”¶å›ç»™åˆ«äººç”¨ã€‚

**è¶…æ—¶æœºåˆ¶**ï¼š
- ğŸ”¸ **é—²ç½®æ—¶é—´**ï¼šç”¨æˆ·æœ€åä¸€æ¬¡æ“ä½œåˆ°ç°åœ¨çš„æ—¶é—´
- ğŸ”¸ **è¶…æ—¶é˜ˆå€¼**ï¼šç³»ç»Ÿè®¾å®šçš„æœ€å¤§é—²ç½®æ—¶é—´
- ğŸ”¸ **è‡ªåŠ¨é”€æ¯**ï¼šè¶…è¿‡é˜ˆå€¼åè‡ªåŠ¨é”€æ¯Session

### 5.2 é…ç½®è¶…æ—¶æ—¶é—´


**æ–¹å¼1ï¼šåœ¨web.xmlä¸­é…ç½®**

```xml
<web-app>
    <!-- è®¾ç½®ä¼šè¯è¶…æ—¶æ—¶é—´ä¸º30åˆ†é’Ÿ -->
    <session-config>
        <session-timeout>30</session-timeout>
    </session-config>
</web-app>
```

**æ–¹å¼2ï¼šä»£ç ä¸­è®¾ç½®**

```java
// è®¾ç½®ç‰¹å®šSessionçš„è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
session.setMaxInactiveInterval(30 * 60);  // 30åˆ†é’Ÿ

// è®¾ç½®æ°¸ä¸è¿‡æœŸ
session.setMaxInactiveInterval(-1);
```

### 5.3 ç›‘å¬è¶…æ—¶äº‹ä»¶


```java
@WebListener
public class SessionTimeoutListener implements HttpSessionListener {
    
    @Override
    public void sessionCreated(HttpSessionEvent se) {
        HttpSession session = se.getSession();
        
        // è®°å½•ä¼šè¯åˆ›å»ºæ—¶é—´
        session.setAttribute("createTime", System.currentTimeMillis());
        
        System.out.println("ä¼šè¯åˆ›å»ºï¼Œè¶…æ—¶æ—¶é—´: " + 
            session.getMaxInactiveInterval() + "ç§’");
    }
    
    @Override
    public void sessionDestroyed(HttpSessionEvent se) {
        HttpSession session = se.getSession();
        
        // è®¡ç®—ä¼šè¯å­˜æ´»æ—¶é—´
        Long createTime = (Long) session.getAttribute("createTime");
        if (createTime != null) {
            long liveTime = System.currentTimeMillis() - createTime;
            System.out.println("ä¼šè¯å­˜æ´»æ—¶é—´: " + (liveTime / 1000) + "ç§’");
        }
    }
}
```

---

## 6. ğŸ“Š åœ¨çº¿ç”¨æˆ·ç»Ÿè®¡å®æˆ˜


### 6.1 å®ç°åœ¨çº¿ç”¨æˆ·è®¡æ•°å™¨


**æ ¸å¿ƒæ€è·¯**ï¼šSessionåˆ›å»ºæ—¶+1ï¼ŒSessioné”€æ¯æ—¶-1

```java
@WebListener
public class OnlineUserCounter implements HttpSessionListener {
    
    // é™æ€å˜é‡ä¿å­˜åœ¨çº¿ç”¨æˆ·æ•°ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰
    private static final AtomicInteger onlineUserCount = new AtomicInteger(0);
    
    @Override
    public void sessionCreated(HttpSessionEvent se) {
        // åœ¨çº¿ç”¨æˆ·æ•°+1
        int currentCount = onlineUserCount.incrementAndGet();
        
        System.out.println("æ–°ç”¨æˆ·ä¸Šçº¿ï¼Œå½“å‰åœ¨çº¿äººæ•°: " + currentCount);
        
        // å°†å½“å‰åœ¨çº¿äººæ•°å­˜å‚¨åˆ°ServletContextä¸­ï¼Œä¾›é¡µé¢æ˜¾ç¤º
        ServletContext context = se.getSession().getServletContext();
        context.setAttribute("onlineUserCount", currentCount);
    }
    
    @Override
    public void sessionDestroyed(HttpSessionEvent se) {
        // åœ¨çº¿ç”¨æˆ·æ•°-1
        int currentCount = onlineUserCount.decrementAndGet();
        
        System.out.println("ç”¨æˆ·ç¦»çº¿ï¼Œå½“å‰åœ¨çº¿äººæ•°: " + currentCount);
        
        // æ›´æ–°ServletContextä¸­çš„åœ¨çº¿äººæ•°
        ServletContext context = se.getSession().getServletContext();
        context.setAttribute("onlineUserCount", currentCount);
    }
    
    // æä¾›è·å–å½“å‰åœ¨çº¿äººæ•°çš„é™æ€æ–¹æ³•
    public static int getCurrentOnlineCount() {
        return onlineUserCount.get();
    }
}
```

### 6.2 åœ¨JSPé¡µé¢æ˜¾ç¤ºåœ¨çº¿äººæ•°


```jsp
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<html>
<head>
    <title>ç½‘ç«™é¦–é¡µ</title>
</head>
<body>
    <div class="header">
        <h1>æ¬¢è¿è®¿é—®æˆ‘ä»¬çš„ç½‘ç«™</h1>
        <!-- æ˜¾ç¤ºå½“å‰åœ¨çº¿äººæ•° -->
        <p>å½“å‰åœ¨çº¿äººæ•°: <span style="color: red; font-weight: bold;">
            ${applicationScope.onlineUserCount}
        </span> äºº</p>
    </div>
</body>
</html>
```

### 6.3 è¯¦ç»†ç”¨æˆ·ä¿¡æ¯ç»Ÿè®¡


```java
@WebListener
public class DetailedUserTracker implements HttpSessionListener, HttpSessionAttributeListener {
    
    // å­˜å‚¨åœ¨çº¿ç”¨æˆ·ä¿¡æ¯çš„Map
    private static final ConcurrentHashMap<String, UserInfo> onlineUsers = 
        new ConcurrentHashMap<>();
    
    @Override
    public void sessionCreated(HttpSessionEvent se) {
        HttpSession session = se.getSession();
        String sessionId = session.getId();
        
        // åˆ›å»ºç”¨æˆ·ä¿¡æ¯å¯¹è±¡
        UserInfo userInfo = new UserInfo();
        userInfo.setSessionId(sessionId);
        userInfo.setLoginTime(new Date());
        userInfo.setLastAccessTime(new Date());
        
        // å­˜å‚¨ç”¨æˆ·ä¿¡æ¯
        onlineUsers.put(sessionId, userInfo);
        
        System.out.println("ç”¨æˆ·ä¸Šçº¿: " + sessionId);
    }
    
    @Override
    public void sessionDestroyed(HttpSessionEvent se) {
        String sessionId = se.getSession().getId();
        
        // ç§»é™¤ç”¨æˆ·ä¿¡æ¯
        UserInfo userInfo = onlineUsers.remove(sessionId);
        
        if (userInfo != null) {
            System.out.println("ç”¨æˆ·ä¸‹çº¿: " + userInfo.getUsername() + 
                " (SessionId: " + sessionId + ")");
        }
    }
    
    // è·å–åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
    public static Collection<UserInfo> getOnlineUsers() {
        return onlineUsers.values();
    }
}

// ç”¨æˆ·ä¿¡æ¯ç±»
class UserInfo {
    private String sessionId;
    private String username;
    private Date loginTime;
    private Date lastAccessTime;
    
    // getterå’Œsetteræ–¹æ³•...
}
```

---

## 7. ğŸ›ï¸ ä¼šè¯çŠ¶æ€ç®¡ç†


### 7.1 ä»€ä¹ˆæ˜¯ä¼šè¯çŠ¶æ€ç®¡ç†


**ç®€å•ç†è§£**ï¼šå°±åƒç®¡ç†å‘˜è¦çŸ¥é“æ¯ä¸ªæˆ¿é—´é‡Œæœ‰ä»€ä¹ˆäººï¼Œåœ¨åšä»€ä¹ˆäº‹æƒ…ã€‚

**çŠ¶æ€ç®¡ç†åŒ…æ‹¬**ï¼š
- ğŸ”¸ **ç”¨æˆ·èº«ä»½**ï¼šè°åœ¨ä½¿ç”¨è¿™ä¸ªä¼šè¯
- ğŸ”¸ **æƒé™ä¿¡æ¯**ï¼šç”¨æˆ·èƒ½åšä»€ä¹ˆæ“ä½œ
- ğŸ”¸ **ä¸šåŠ¡çŠ¶æ€**ï¼šç”¨æˆ·å½“å‰çš„æ“ä½œè¿›åº¦
- ğŸ”¸ **ä¸´æ—¶æ•°æ®**ï¼šè´­ç‰©è½¦ã€è¡¨å•æ•°æ®ç­‰

### 7.2 ç›‘å¬Sessionå±æ€§å˜åŒ–


```java
@WebListener
public class SessionStateManager implements HttpSessionListener, 
    HttpSessionAttributeListener {
    
    @Override
    public void sessionCreated(HttpSessionEvent se) {
        HttpSession session = se.getSession();
        
        // ä¸ºæ–°ä¼šè¯è®¾ç½®åˆå§‹çŠ¶æ€
        session.setAttribute("userStatus", "guest");  // æ¸¸å®¢çŠ¶æ€
        session.setAttribute("permissions", new ArrayList<String>());
        
        System.out.println("ä¼šè¯çŠ¶æ€åˆå§‹åŒ–å®Œæˆ: " + session.getId());
    }
    
    @Override
    public void attributeAdded(HttpSessionBindingEvent se) {
        String name = se.getName();
        Object value = se.getValue();
        
        System.out.println("ä¼šè¯å±æ€§æ·»åŠ : " + name + " = " + value);
        
        // ç›‘å¬ç”¨æˆ·ç™»å½•çŠ¶æ€å˜åŒ–
        if ("user".equals(name)) {
            handleUserLogin(se.getSession(), value);
        }
    }
    
    private void handleUserLogin(HttpSession session, Object user) {
        // ç”¨æˆ·ç™»å½•æ—¶æ›´æ–°çŠ¶æ€
        session.setAttribute("userStatus", "logged");
        
        // æ ¹æ®ç”¨æˆ·è§’è‰²è®¾ç½®æƒé™
        // User userObj = (User) user;
        // List<String> permissions = getUserPermissions(userObj);
        // session.setAttribute("permissions", permissions);
        
        System.out.println("ç”¨æˆ·ç™»å½•çŠ¶æ€æ›´æ–°å®Œæˆ");
    }
}
```

### 7.3 ä¼šè¯çŠ¶æ€çš„ç”Ÿå‘½å‘¨æœŸ


```
ä¼šè¯çŠ¶æ€å˜åŒ–æµç¨‹ï¼š

è®¿é—®ç½‘ç«™ â†’ åˆ›å»ºSession â†’ è®¾ç½®æ¸¸å®¢çŠ¶æ€
    â†“
ç”¨æˆ·ç™»å½• â†’ æ›´æ–°ç™»å½•çŠ¶æ€ â†’ è®¾ç½®ç”¨æˆ·æƒé™  
    â†“
è¿›è¡Œæ“ä½œ â†’ æ›´æ–°ä¸šåŠ¡çŠ¶æ€ â†’ ä¿å­˜ä¸´æ—¶æ•°æ®
    â†“
ä¼šè¯è¿‡æœŸ/é€€å‡º â†’ æ¸…ç†çŠ¶æ€ä¿¡æ¯ â†’ é‡Šæ”¾èµ„æº
```

---

## 8. ğŸ›¡ï¸ å†…å­˜æ³„æ¼é˜²èŒƒ


### 8.1 ä»€ä¹ˆæ˜¯å†…å­˜æ³„æ¼


**ç®€å•ç†è§£**ï¼šå°±åƒå®¶é‡Œçš„åƒåœ¾ä¸åŠæ—¶æ¸…ç†ï¼Œè¶Šç§¯è¶Šå¤šï¼Œæœ€åæ²¡åœ°æ–¹ä½äº†ã€‚

**Sessionå†…å­˜æ³„æ¼çš„å¸¸è§åŸå› **ï¼š
- ğŸ”¸ **å¤§å¯¹è±¡å­˜å‚¨**ï¼šåœ¨Sessionä¸­å­˜æ”¾è¿‡å¤§çš„å¯¹è±¡
- ğŸ”¸ **å¿˜è®°æ¸…ç†**ï¼šSessioné”€æ¯æ—¶æ²¡æœ‰é‡Šæ”¾èµ„æº
- ğŸ”¸ **å¾ªç¯å¼•ç”¨**ï¼šå¯¹è±¡ä¹‹é—´ç›¸äº’å¼•ç”¨ï¼Œåƒåœ¾å›æ”¶å™¨æ— æ³•å›æ”¶

### 8.2 é˜²èŒƒå†…å­˜æ³„æ¼çš„ç›‘å¬å™¨


```java
@WebListener
public class MemoryLeakPreventionListener implements HttpSessionListener {
    
    // ç›‘æ§Sessionå¤§å°çš„é˜ˆå€¼ï¼ˆå­—èŠ‚ï¼‰
    private static final long MAX_SESSION_SIZE = 1024 * 1024;  // 1MB
    
    @Override
    public void sessionCreated(HttpSessionEvent se) {
        HttpSession session = se.getSession();
        
        // è®°å½•Sessionåˆ›å»ºæ—¶é—´ï¼Œç”¨äºåç»­æ¸…ç†åˆ¤æ–­
        session.setAttribute("_createTime", System.currentTimeMillis());
        
        System.out.println("Sessionåˆ›å»ºï¼Œå¼€å§‹å†…å­˜ç›‘æ§: " + session.getId());
    }
    
    @Override
    public void sessionDestroyed(HttpSessionEvent se) {
        HttpSession session = se.getSession();
        String sessionId = session.getId();
        
        System.out.println("å¼€å§‹æ¸…ç†Sessionèµ„æº: " + sessionId);
        
        // æ¸…ç†å¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼çš„å¯¹è±¡
        cleanupSessionResources(session);
        
        System.out.println("Sessionèµ„æºæ¸…ç†å®Œæˆ: " + sessionId);
    }
    
    private void cleanupSessionResources(HttpSession session) {
        // æ¸…ç†æ–‡ä»¶è¾“å…¥æµ
        Enumeration<String> attributeNames = session.getAttributeNames();
        while (attributeNames.hasMoreElements()) {
            String name = attributeNames.nextElement();
            Object value = session.getAttribute(name);
            
            // å…³é—­å¯èƒ½çš„IOæµ
            if (value instanceof Closeable) {
                try {
                    ((Closeable) value).close();
                } catch (Exception e) {
                    System.err.println("å…³é—­èµ„æºå¤±è´¥: " + e.getMessage());
                }
            }
            
            // æ¸…ç†å¤§å¯¹è±¡å¼•ç”¨
            if (isLargeObject(value)) {
                session.removeAttribute(name);
                System.out.println("æ¸…ç†å¤§å¯¹è±¡: " + name);
            }
        }
    }
    
    private boolean isLargeObject(Object obj) {
        // ç®€å•åˆ¤æ–­ï¼šå­—ç¬¦ä¸²é•¿åº¦æˆ–é›†åˆå¤§å°
        if (obj instanceof String) {
            return ((String) obj).length() > 10000;
        } else if (obj instanceof Collection) {
            return ((Collection<?>) obj).size() > 1000;
        }
        return false;
    }
}
```

### 8.3 Sessionå¤§å°ç›‘æ§


```java
@WebListener
public class SessionSizeMonitor implements HttpSessionAttributeListener {
    
    @Override
    public void attributeAdded(HttpSessionBindingEvent se) {
        checkSessionSize(se.getSession(), "å±æ€§æ·»åŠ ");
    }
    
    @Override
    public void attributeReplaced(HttpSessionBindingEvent se) {
        checkSessionSize(se.getSession(), "å±æ€§æ›¿æ¢");
    }
    
    private void checkSessionSize(HttpSession session, String operation) {
        // ç®€å•çš„Sessionå¤§å°ä¼°ç®—
        int attributeCount = 0;
        long estimatedSize = 0;
        
        Enumeration<String> names = session.getAttributeNames();
        while (names.hasMoreElements()) {
            attributeCount++;
            String name = names.nextElement();
            Object value = session.getAttribute(name);
            
            // ç²—ç•¥ä¼°ç®—å¯¹è±¡å¤§å°
            estimatedSize += estimateObjectSize(value);
        }
        
        // å¦‚æœSessionå¤ªå¤§ï¼Œå‘å‡ºè­¦å‘Š
        if (estimatedSize > 500 * 1024) {  // 500KB
            System.out.println("âš ï¸ è­¦å‘Šï¼šSessionè¿‡å¤§ - " + operation + 
                ", SessionId: " + session.getId() + 
                ", å±æ€§æ•°é‡: " + attributeCount + 
                ", ä¼°ç®—å¤§å°: " + (estimatedSize / 1024) + "KB");
        }
    }
    
    private long estimateObjectSize(Object obj) {
        if (obj == null) return 0;
        if (obj instanceof String) {
            return ((String) obj).length() * 2;  // å­—ç¬¦å 2å­—èŠ‚
        } else if (obj instanceof Collection) {
            return ((Collection<?>) obj).size() * 50;  // æ¯ä¸ªå…ƒç´ ä¼°ç®—50å­—èŠ‚
        } else {
            return 100;  // å…¶ä»–å¯¹è±¡ä¼°ç®—100å­—èŠ‚
        }
    }
}
```

### 8.4 æœ€ä½³å®è·µå»ºè®®


> **ğŸ’¡ é˜²èŒƒå†…å­˜æ³„æ¼çš„å»ºè®®**ï¼š
> 
> 1. **é€‚é‡å­˜å‚¨**ï¼šä¸è¦åœ¨Sessionä¸­å­˜æ”¾å¤ªå¤§çš„å¯¹è±¡
> 2. **åŠæ—¶æ¸…ç†**ï¼šåœ¨ç›‘å¬å™¨ä¸­ä¸»åŠ¨æ¸…ç†èµ„æº
> 3. **å®šæœŸç›‘æ§**ï¼šç›‘æ§Sessionçš„å¤§å°å’Œæ•°é‡
> 4. **åˆç†è¶…æ—¶**ï¼šè®¾ç½®åˆé€‚çš„Sessionè¶…æ—¶æ—¶é—´

> **âš ï¸ å¸¸è§é”™è¯¯**ï¼š
> 
> - åœ¨Sessionä¸­å­˜å‚¨æ–‡ä»¶æµè€Œä¸å…³é—­
> - å­˜å‚¨å¤§å‹é›†åˆæˆ–å›¾ç‰‡æ•°æ®
> - å¾ªç¯å¼•ç”¨çš„å¯¹è±¡ç»“æ„
> - å¿˜è®°åœ¨é”€æ¯æ—¶æ¸…ç†èµ„æº

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ HttpSessionç”Ÿå‘½å‘¨æœŸï¼šåˆ›å»º â†’ ä½¿ç”¨ â†’ é”€æ¯
ğŸ”¸ HttpSessionListeneræ¥å£ï¼šç›‘å¬Sessionçš„åˆ›å»ºå’Œé”€æ¯
ğŸ”¸ sessionCreatedæ–¹æ³•ï¼šSessionåˆ›å»ºæ—¶è§¦å‘ï¼Œç”¨äºåˆå§‹åŒ–
ğŸ”¸ sessionDestroyedæ–¹æ³•ï¼šSessioné”€æ¯æ—¶è§¦å‘ï¼Œç”¨äºèµ„æºæ¸…ç†
ğŸ”¸ ä¼šè¯è¶…æ—¶æœºåˆ¶ï¼šè‡ªåŠ¨æ¸…ç†é•¿æ—¶é—´æœªä½¿ç”¨çš„Session
ğŸ”¸ åœ¨çº¿ç”¨æˆ·ç»Ÿè®¡ï¼šåˆ©ç”¨ç›‘å¬å™¨å®ç°å®æ—¶ç”¨æˆ·è®¡æ•°
ğŸ”¸ å†…å­˜æ³„æ¼é˜²èŒƒï¼šåˆç†ç®¡ç†Sessionä¸­çš„å¯¹è±¡å¼•ç”¨
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ Sessionç›‘å¬å™¨çš„ä½œç”¨**ï¼š
```
å®é™…ç”¨é€”ï¼š
- ç»Ÿè®¡ç½‘ç«™è®¿é—®æƒ…å†µ
- ç®¡ç†åœ¨çº¿ç”¨æˆ·æ•°é‡  
- æ¸…ç†ä¸´æ—¶æ–‡ä»¶å’Œèµ„æº
- è®°å½•ç”¨æˆ·è¡Œä¸ºæ—¥å¿—
- é˜²èŒƒå†…å­˜æ³„æ¼é—®é¢˜
```

**ğŸ”¹ ç”Ÿå‘½å‘¨æœŸäº‹ä»¶çš„æ—¶æœº**ï¼š
```
sessionCreatedè§¦å‘æ—¶æœºï¼š
- ç”¨æˆ·ç¬¬ä¸€æ¬¡è®¿é—®ç½‘ç«™
- è°ƒç”¨request.getSession()ä¸”Sessionä¸å­˜åœ¨
- ä¸æ˜¯æ¯æ¬¡è¯·æ±‚éƒ½è§¦å‘ï¼Œåªåœ¨åˆ›å»ºæ—¶è§¦å‘ä¸€æ¬¡

sessionDestroyedè§¦å‘æ—¶æœºï¼š  
- Sessionè¶…æ—¶è‡ªåŠ¨é”€æ¯
- æ‰‹åŠ¨è°ƒç”¨session.invalidate()
- æœåŠ¡å™¨å…³é—­æˆ–åº”ç”¨é‡å¯
```

**ğŸ”¹ çº¿ç¨‹å®‰å…¨æ³¨æ„äº‹é¡¹**ï¼š
```
ç›‘å¬å™¨çš„çº¿ç¨‹å®‰å…¨ï¼š
- å¤šä¸ªç”¨æˆ·åŒæ—¶è®¿é—®ï¼Œç›‘å¬å™¨æ–¹æ³•ä¼šå¹¶å‘æ‰§è¡Œ
- ä½¿ç”¨é™æ€å˜é‡æ—¶è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨ï¼ˆAtomicIntegerç­‰ï¼‰
- é¿å…åœ¨ç›‘å¬å™¨ä¸­ä½¿ç”¨éçº¿ç¨‹å®‰å…¨çš„é›†åˆ
```

### 9.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¸šåŠ¡åº”ç”¨åœºæ™¯**ï¼š
- **ç”µå•†ç½‘ç«™**ï¼šç»Ÿè®¡åŒæ—¶åœ¨çº¿è´­ç‰©ç”¨æˆ·æ•°
- **åœ¨çº¿æ•™è‚²**ï¼šç›‘æ§å­¦ç”Ÿå­¦ä¹ ä¼šè¯æ—¶é•¿
- **ä¼ä¸šç³»ç»Ÿ**ï¼šç®¡ç†å‘˜å·¥ç™»å½•çŠ¶æ€å’Œæƒé™
- **æ¸¸æˆå¹³å°**ï¼šå®æ—¶æ˜¾ç¤ºåœ¨çº¿ç©å®¶æ•°é‡

**ğŸ”§ æŠ€æœ¯åº”ç”¨åœºæ™¯**ï¼š
- **æ€§èƒ½ç›‘æ§**ï¼šç›‘æ§Sessionä½¿ç”¨æƒ…å†µå’Œç³»ç»Ÿè´Ÿè½½
- **èµ„æºç®¡ç†**ï¼šè‡ªåŠ¨æ¸…ç†ä¸´æ—¶æ–‡ä»¶å’Œæ•°æ®åº“è¿æ¥
- **å®‰å…¨æ§åˆ¶**ï¼šæ£€æµ‹å¼‚å¸¸ç™»å½•å’Œä¼šè¯åŠ«æŒ
- **ç”¨æˆ·ä½“éªŒ**ï¼šæ˜¾ç¤ºå®æ—¶åœ¨çº¿çŠ¶æ€å’Œæ´»è·ƒåº¦

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- Sessionç”Ÿå‘½æœ‰ä¸‰æ®µï¼Œåˆ›å»ºä½¿ç”¨å’Œé”€æ¯
- ç›‘å¬å™¨åƒå®ˆé—¨å‘˜ï¼Œäº‹ä»¶å‘ç”Ÿå°±çŸ¥é“
- åˆ›å»ºæ—¶æ¥åšåˆå§‹ï¼Œé”€æ¯æ—¶è¦æ¸…èµ„æº
- åœ¨çº¿ç»Ÿè®¡å¾ˆå®ç”¨ï¼Œå†…å­˜æ³„æ¼è¦é˜²èŒƒ