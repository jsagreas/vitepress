---
title: 3ã€Listener-ServletRequestç”Ÿå‘½å‘¨æœŸ
---
## ğŸ“š ç›®å½•

1. [ServletRequestç”Ÿå‘½å‘¨æœŸåŸºç¡€](#1-servletrequestç”Ÿå‘½å‘¨æœŸåŸºç¡€)
2. [ServletRequestListeneræ¥å£è¯¦è§£](#2-servletrequestlisteneræ¥å£è¯¦è§£)
3. [è¯·æ±‚åˆ›å»ºä¸é”€æ¯ç›‘å¬](#3-è¯·æ±‚åˆ›å»ºä¸é”€æ¯ç›‘å¬)
4. [è¯·æ±‚å¤„ç†ç›‘æ§å®æˆ˜](#4-è¯·æ±‚å¤„ç†ç›‘æ§å®æˆ˜)
5. [æ€§èƒ½ç»Ÿè®¡ä¸åˆ†æ](#5-æ€§èƒ½ç»Ÿè®¡ä¸åˆ†æ)
6. [å¼‚å¸¸æƒ…å†µå¤„ç†](#6-å¼‚å¸¸æƒ…å†µå¤„ç†)
7. [è¯·æ±‚é“¾è·¯è·Ÿè¸ª](#7-è¯·æ±‚é“¾è·¯è·Ÿè¸ª)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”„ ServletRequestç”Ÿå‘½å‘¨æœŸåŸºç¡€


### 1.1 ä»€ä¹ˆæ˜¯ServletRequestç”Ÿå‘½å‘¨æœŸ


**é€šä¿—ç†è§£**ï¼šæƒ³è±¡ä¸€ä¸‹é¤å…ç‚¹é¤çš„è¿‡ç¨‹
- é¡¾å®¢è¿›é—¨æ—¶æœåŠ¡å‘˜é€’ä¸Šèœå•ï¼ˆ**è¯·æ±‚åˆ›å»º**ï¼‰
- é¡¾å®¢çœ‹èœå•ã€ç‚¹èœã€ç”¨é¤ï¼ˆ**è¯·æ±‚å¤„ç†è¿‡ç¨‹**ï¼‰
- é¡¾å®¢ç»“è´¦ç¦»å¼€ï¼ŒæœåŠ¡å‘˜æ”¶æ‹¾æ¡Œå­ï¼ˆ**è¯·æ±‚é”€æ¯**ï¼‰

```
å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚ â†’ æœåŠ¡å™¨åˆ›å»ºRequestå¯¹è±¡ â†’ å¤„ç†è¯·æ±‚ â†’ é”€æ¯Requestå¯¹è±¡
     â†‘                    â†‘                 â†‘              â†‘
   ç”¨æˆ·ç‚¹å‡»é“¾æ¥        requestInitialized   ä¸šåŠ¡å¤„ç†    requestDestroyed
```

**ServletRequestç”Ÿå‘½å‘¨æœŸ**ï¼šæ¯ä¸ªHTTPè¯·æ±‚åœ¨æœåŠ¡å™¨ä¸­éƒ½ä¼šç»å†åˆ›å»ºâ†’ä½¿ç”¨â†’é”€æ¯è¿™ä¸‰ä¸ªé˜¶æ®µ

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦ç›‘å¬Requestç”Ÿå‘½å‘¨æœŸ


**å®é™…åº”ç”¨åœºæ™¯**ï¼š
- ğŸ” **è¯·æ±‚ç›‘æ§**ï¼šç»Ÿè®¡æ¯å¤©æœ‰å¤šå°‘ç”¨æˆ·è®¿é—®ç½‘ç«™
- â±ï¸ **æ€§èƒ½åˆ†æ**ï¼šè®°å½•æ¯ä¸ªè¯·æ±‚å¤„ç†èŠ±è´¹çš„æ—¶é—´
- ğŸš¨ **å¼‚å¸¸è¿½è¸ª**ï¼šå½“è¯·æ±‚å‡ºé”™æ—¶ï¼Œèƒ½è¿½è¸ªåˆ°å…·ä½“æ˜¯å“ªä¸ªè¯·æ±‚
- ğŸ“Š **ç”¨æˆ·è¡Œä¸ºåˆ†æ**ï¼šåˆ†æç”¨æˆ·çš„è®¿é—®è·¯å¾„å’Œè¡Œä¸ºä¹ æƒ¯

### 1.3 Requestå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå›¾ç¤º


```
HTTPè¯·æ±‚åˆ°è¾¾æœåŠ¡å™¨
         |
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚ åˆ›å»ºRequest â”‚ â† requestInitialized() è¢«è°ƒç”¨
    â”‚   å¯¹è±¡     â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         |
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚ å¤„ç†ä¸šåŠ¡é€»è¾‘ â”‚   Filteré“¾ â†’ Servlet â†’ JSP
    â”‚   é€»è¾‘     â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         |
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚ é”€æ¯Request â”‚ â† requestDestroyed() è¢«è°ƒç”¨
    â”‚   å¯¹è±¡     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         |
    å“åº”è¿”å›ç»™å®¢æˆ·ç«¯
```

---

## 2. ğŸ“‹ ServletRequestListeneræ¥å£è¯¦è§£


### 2.1 æ¥å£åŸºæœ¬ç»“æ„


**ServletRequestListener** æ˜¯Java Webæä¾›çš„æ ‡å‡†æ¥å£ï¼Œä¸“é—¨ç”¨æ¥ç›‘å¬Requestå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå˜åŒ–ã€‚

```java
public interface ServletRequestListener extends EventListener {
    
    // è¯·æ±‚åˆ›å»ºæ—¶è°ƒç”¨
    void requestInitialized(ServletRequestEvent sre);
    
    // è¯·æ±‚é”€æ¯æ—¶è°ƒç”¨  
    void requestDestroyed(ServletRequestEvent sre);
}
```

### 2.2 æ ¸å¿ƒæ–¹æ³•è¯´æ˜


| æ–¹æ³•å | **è°ƒç”¨æ—¶æœº** | **ä½œç”¨** | **å¸¸è§ç”¨é€”** |
|--------|------------|---------|-------------|
| `requestInitialized` | Requestå¯¹è±¡åˆ›å»ºåç«‹å³è°ƒç”¨ | åˆå§‹åŒ–æ“ä½œ | è®°å½•è¯·æ±‚å¼€å§‹æ—¶é—´ã€è®¾ç½®è¯·æ±‚ID |
| `requestDestroyed` | Requestå¯¹è±¡é”€æ¯å‰è°ƒç”¨ | æ¸…ç†æ“ä½œ | è®¡ç®—è¯·æ±‚è€—æ—¶ã€é‡Šæ”¾èµ„æº |

### 2.3 ServletRequestEventäº‹ä»¶å¯¹è±¡


**ServletRequestEvent** æ˜¯äº‹ä»¶å¯¹è±¡ï¼ŒåŒ…å«äº†Requestç›¸å…³çš„ä¿¡æ¯ï¼š

```java
// è·å–ServletRequestå¯¹è±¡
ServletRequest request = event.getServletRequest();

// è·å–ServletContextå¯¹è±¡  
ServletContext context = event.getServletContext();

// å¦‚æœæ˜¯HTTPè¯·æ±‚ï¼Œå¯ä»¥å¼ºè½¬ä¸ºHttpServletRequest
HttpServletRequest httpRequest = (HttpServletRequest) request;
```

> ğŸ’¡ **å°è´´å£«**ï¼šServletRequestEventå°±åƒæ˜¯ä¸€ä¸ªä¿¡æ¯åŒ…ï¼Œé‡Œé¢è£…ç€å½“å‰è¯·æ±‚çš„æ‰€æœ‰åŸºæœ¬ä¿¡æ¯

---

## 3. ğŸš€ è¯·æ±‚åˆ›å»ºä¸é”€æ¯ç›‘å¬


### 3.1 åŸºç¡€å®ç°ç¤ºä¾‹


```java
@WebListener  // æ³¨è§£æ–¹å¼æ³¨å†Œç›‘å¬å™¨
public class RequestLifecycleListener implements ServletRequestListener {
    
    private static final Logger logger = LoggerFactory.getLogger(RequestLifecycleListener.class);
    
    @Override
    public void requestInitialized(ServletRequestEvent sre) {
        HttpServletRequest request = (HttpServletRequest) sre.getServletRequest();
        
        // è·å–è¯·æ±‚åŸºæœ¬ä¿¡æ¯
        String requestURI = request.getRequestURI();
        String method = request.getMethod();
        String clientIP = request.getRemoteAddr();
        
        logger.info("ğŸ”µ è¯·æ±‚å¼€å§‹ - URI: {}, Method: {}, IP: {}", 
                   requestURI, method, clientIP);
        
        // è®°å½•è¯·æ±‚å¼€å§‹æ—¶é—´
        request.setAttribute("startTime", System.currentTimeMillis());
    }
    
    @Override  
    public void requestDestroyed(ServletRequestEvent sre) {
        HttpServletRequest request = (HttpServletRequest) sre.getServletRequest();
        
        // è®¡ç®—è¯·æ±‚å¤„ç†æ—¶é—´
        Long startTime = (Long) request.getAttribute("startTime");
        if (startTime != null) {
            long duration = System.currentTimeMillis() - startTime;
            logger.info("ğŸ”´ è¯·æ±‚ç»“æŸ - URI: {}, è€—æ—¶: {}ms", 
                       request.getRequestURI(), duration);
        }
    }
}
```

### 3.2 é…ç½®æ–¹å¼å¯¹æ¯”


**æ³¨è§£é…ç½®**ï¼ˆæ¨èï¼‰ï¼š
```java
@WebListener
public class MyRequestListener implements ServletRequestListener {
    // å®ç°æ–¹æ³•...
}
```

**XMLé…ç½®**ï¼š
```xml
<web-app>
    <listener>
        <listener-class>com.example.MyRequestListener</listener-class>
    </listener>
</web-app>
```

| é…ç½®æ–¹å¼ | **ä¼˜ç‚¹** | **ç¼ºç‚¹** | **é€‚ç”¨åœºæ™¯** |
|---------|---------|---------|-------------|
| **@WebListener** | ç®€å•ç›´æ¥ã€ä»£ç é›†ä¸­ | éœ€è¦Servlet 3.0+ | ç°ä»£é¡¹ç›®æ¨è |
| **XMLé…ç½®** | é…ç½®çµæ´»ã€ç‰ˆæœ¬å…¼å®¹å¥½ | é…ç½®åˆ†æ•£ | è€é¡¹ç›®æˆ–ç‰¹æ®Šéœ€æ±‚ |

---

## 4. ğŸ“Š è¯·æ±‚å¤„ç†ç›‘æ§å®æˆ˜


### 4.1 è¯·æ±‚ç»Ÿè®¡ç›‘æ§å™¨


```java
@WebListener
public class RequestMonitorListener implements ServletRequestListener {
    
    // ä½¿ç”¨AtomicLongä¿è¯çº¿ç¨‹å®‰å…¨çš„è®¡æ•°
    private static final AtomicLong totalRequests = new AtomicLong(0);
    private static final AtomicLong activeRequests = new AtomicLong(0);
    
    @Override
    public void requestInitialized(ServletRequestEvent sre) {
        // æ€»è¯·æ±‚æ•°+1
        long total = totalRequests.incrementAndGet();
        // å½“å‰æ´»è·ƒè¯·æ±‚æ•°+1  
        long active = activeRequests.incrementAndGet();
        
        HttpServletRequest request = (HttpServletRequest) sre.getServletRequest();
        
        // è®¾ç½®è¯·æ±‚å”¯ä¸€æ ‡è¯†
        String requestId = "REQ-" + System.nanoTime();
        request.setAttribute("requestId", requestId);
        
        System.out.println("ğŸ“ˆ è¯·æ±‚ç›‘æ§ - æ€»æ•°: " + total + ", æ´»è·ƒ: " + active + 
                          ", ID: " + requestId);
    }
    
    @Override
    public void requestDestroyed(ServletRequestEvent sre) {
        // å½“å‰æ´»è·ƒè¯·æ±‚æ•°-1
        long active = activeRequests.decrementAndGet();
        
        HttpServletRequest request = (HttpServletRequest) sre.getServletRequest();
        String requestId = (String) request.getAttribute("requestId");
        
        System.out.println("ğŸ“‰ è¯·æ±‚å®Œæˆ - æ´»è·ƒæ•°: " + active + ", ID: " + requestId);
    }
    
    // æä¾›é™æ€æ–¹æ³•è·å–ç»Ÿè®¡æ•°æ®
    public static long getTotalRequests() {
        return totalRequests.get();
    }
    
    public static long getActiveRequests() {
        return activeRequests.get();
    }
}
```

### 4.2 è¯·æ±‚ä¿¡æ¯æ”¶é›†å™¨


```java
@WebListener
public class RequestInfoCollector implements ServletRequestListener {
    
    @Override
    public void requestInitialized(ServletRequestEvent sre) {
        HttpServletRequest request = (HttpServletRequest) sre.getServletRequest();
        
        // æ”¶é›†è¯·æ±‚è¯¦ç»†ä¿¡æ¯
        Map<String, Object> requestInfo = new HashMap<>();
        requestInfo.put("uri", request.getRequestURI());
        requestInfo.put("method", request.getMethod());
        requestInfo.put("userAgent", request.getHeader("User-Agent"));
        requestInfo.put("referer", request.getHeader("Referer"));
        requestInfo.put("clientIP", getClientIP(request));
        requestInfo.put("startTime", System.currentTimeMillis());
        
        // å­˜å‚¨åˆ°Requestä¸­ï¼Œä¾›å…¶ä»–ç»„ä»¶ä½¿ç”¨
        request.setAttribute("requestInfo", requestInfo);
        
        // å¦‚æœæ˜¯é‡è¦è·¯å¾„ï¼Œç‰¹åˆ«æ ‡è®°
        if (isImportantPath(request.getRequestURI())) {
            request.setAttribute("important", true);
            System.out.println("â­ é‡è¦è¯·æ±‚: " + request.getRequestURI());
        }
    }
    
    // è·å–çœŸå®å®¢æˆ·ç«¯IPï¼ˆè€ƒè™‘ä»£ç†æƒ…å†µï¼‰
    private String getClientIP(HttpServletRequest request) {
        String ip = request.getHeader("X-Forwarded-For");
        if (ip == null || ip.length() == 0 || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getHeader("X-Real-IP");
        }
        if (ip == null || ip.length() == 0 || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getRemoteAddr();
        }
        return ip;
    }
    
    // åˆ¤æ–­æ˜¯å¦ä¸ºé‡è¦è·¯å¾„
    private boolean isImportantPath(String uri) {
        return uri.contains("/admin") || uri.contains("/api") || uri.contains("/login");
    }
    
    @Override
    public void requestDestroyed(ServletRequestEvent sre) {
        HttpServletRequest request = (HttpServletRequest) sre.getServletRequest();
        
        @SuppressWarnings("unchecked")
        Map<String, Object> requestInfo = (Map<String, Object>) request.getAttribute("requestInfo");
        
        if (requestInfo != null) {
            // è®¡ç®—å¤„ç†æ—¶é—´
            Long startTime = (Long) requestInfo.get("startTime");
            long duration = System.currentTimeMillis() - startTime;
            requestInfo.put("duration", duration);
            
            // è¾“å‡ºå®Œæ•´è¯·æ±‚ä¿¡æ¯
            System.out.println("ğŸ“‹ è¯·æ±‚ä¿¡æ¯: " + requestInfo);
        }
    }
}
```

---

## 5. â±ï¸ æ€§èƒ½ç»Ÿè®¡ä¸åˆ†æ


### 5.1 æ€§èƒ½ç»Ÿè®¡ç›‘å¬å™¨


```java
@WebListener
public class PerformanceAnalyzer implements ServletRequestListener {
    
    // ä½¿ç”¨ConcurrentHashMapå­˜å‚¨URLçš„æ€§èƒ½æ•°æ®
    private static final Map<String, UrlStats> urlStatsMap = new ConcurrentHashMap<>();
    
    // URLç»Ÿè®¡æ•°æ®ç±»
    static class UrlStats {
        private final AtomicLong count = new AtomicLong(0);      // è®¿é—®æ¬¡æ•°
        private final AtomicLong totalTime = new AtomicLong(0);  // æ€»è€—æ—¶
        private volatile long maxTime = 0;                       // æœ€å¤§è€—æ—¶
        private volatile long minTime = Long.MAX_VALUE;          // æœ€å°è€—æ—¶
        
        public void addRequest(long duration) {
            count.incrementAndGet();
            totalTime.addAndGet(duration);
            
            // æ›´æ–°æœ€å¤§æœ€å°å€¼
            synchronized (this) {
                if (duration > maxTime) maxTime = duration;
                if (duration < minTime) minTime = duration;
            }
        }
        
        public double getAverageTime() {
            long total = totalTime.get();
            long cnt = count.get();
            return cnt > 0 ? (double) total / cnt : 0;
        }
        
        // getteræ–¹æ³•çœç•¥...
    }
    
    @Override
    public void requestInitialized(ServletRequestEvent sre) {
        HttpServletRequest request = (HttpServletRequest) sre.getServletRequest();
        request.setAttribute("perfStartTime", System.currentTimeMillis());
    }
    
    @Override
    public void requestDestroyed(ServletRequestEvent sre) {
        HttpServletRequest request = (HttpServletRequest) sre.getServletRequest();
        
        Long startTime = (Long) request.getAttribute("perfStartTime");
        if (startTime != null) {
            long duration = System.currentTimeMillis() - startTime;
            String uri = request.getRequestURI();
            
            // æ›´æ–°URLç»Ÿè®¡æ•°æ®
            urlStatsMap.computeIfAbsent(uri, k -> new UrlStats())
                      .addRequest(duration);
            
            // å¦‚æœè¯·æ±‚è€—æ—¶è¶…è¿‡é˜ˆå€¼ï¼Œè®°å½•æ…¢è¯·æ±‚
            if (duration > 1000) { // è¶…è¿‡1ç§’è§†ä¸ºæ…¢è¯·æ±‚
                System.out.println("ğŸŒ æ…¢è¯·æ±‚è­¦å‘Š: " + uri + " è€—æ—¶ " + duration + "ms");
            }
        }
    }
    
    // è·å–æ€§èƒ½ç»Ÿè®¡æŠ¥å‘Š
    public static void printPerformanceReport() {
        System.out.println("\nğŸ“Š =====æ€§èƒ½ç»Ÿè®¡æŠ¥å‘Š=====");
        
        urlStatsMap.forEach((url, stats) -> {
            System.out.printf("URL: %s\n", url);
            System.out.printf("  è®¿é—®æ¬¡æ•°: %d\n", stats.count.get());
            System.out.printf("  å¹³å‡è€—æ—¶: %.2fms\n", stats.getAverageTime());
            System.out.printf("  æœ€å¤§è€—æ—¶: %dms\n", stats.maxTime);
            System.out.printf("  æœ€å°è€—æ—¶: %dms\n", stats.minTime);
            System.out.println("  ----------------");
        });
    }
}
```

### 5.2 å†…å­˜ä½¿ç”¨ç›‘æ§


```java
@WebListener  
public class MemoryMonitorListener implements ServletRequestListener {
    
    private static final MemoryMXBean memoryBean = ManagementFactory.getMemoryMXBean();
    
    @Override
    public void requestInitialized(ServletRequestEvent sre) {
        // è®°å½•è¯·æ±‚å¼€å§‹æ—¶çš„å†…å­˜ä½¿ç”¨æƒ…å†µ
        MemoryUsage heapUsage = memoryBean.getHeapMemoryUsage();
        long usedMemory = heapUsage.getUsed();
        
        HttpServletRequest request = (HttpServletRequest) sre.getServletRequest();
        request.setAttribute("initialMemory", usedMemory);
    }
    
    @Override
    public void requestDestroyed(ServletRequestEvent sre) {
        HttpServletRequest request = (HttpServletRequest) sre.getServletRequest();
        
        Long initialMemory = (Long) request.getAttribute("initialMemory");
        if (initialMemory != null) {
            // è®¡ç®—å†…å­˜å˜åŒ–
            MemoryUsage heapUsage = memoryBean.getHeapMemoryUsage();
            long currentMemory = heapUsage.getUsed();
            long memoryDiff = currentMemory - initialMemory;
            
            // å¦‚æœå†…å­˜å¢é•¿è¿‡å¤šï¼Œå‘å‡ºè­¦å‘Š
            if (memoryDiff > 10 * 1024 * 1024) { // è¶…è¿‡10MB
                System.out.println("âš ï¸  å†…å­˜ä½¿ç”¨è­¦å‘Š: " + request.getRequestURI() + 
                                 " å†…å­˜å¢é•¿ " + (memoryDiff / 1024 / 1024) + "MB");
            }
        }
    }
}
```

---

## 6. ğŸš¨ å¼‚å¸¸æƒ…å†µå¤„ç†


### 6.1 å¼‚å¸¸ç›‘æ§ä¸è®°å½•


```java
@WebListener
public class ExceptionTrackingListener implements ServletRequestListener {
    
    private static final Logger logger = LoggerFactory.getLogger(ExceptionTrackingListener.class);
    
    @Override
    public void requestInitialized(ServletRequestEvent sre) {
        HttpServletRequest request = (HttpServletRequest) sre.getServletRequest();
        
        // åˆ›å»ºè¯·æ±‚ä¸Šä¸‹æ–‡ä¿¡æ¯
        RequestContext context = new RequestContext();
        context.setRequestId(UUID.randomUUID().toString());
        context.setStartTime(System.currentTimeMillis());
        context.setUri(request.getRequestURI());
        context.setMethod(request.getMethod());
        context.setUserAgent(request.getHeader("User-Agent"));
        
        request.setAttribute("requestContext", context);
    }
    
    @Override
    public void requestDestroyed(ServletRequestEvent sre) {
        HttpServletRequest request = (HttpServletRequest) sre.getServletRequest();
        HttpServletResponse response = (HttpServletResponse) sre.getServletRequest()
                                     .getAttribute("httpResponse");
        
        RequestContext context = (RequestContext) request.getAttribute("requestContext");
        if (context != null) {
            context.setEndTime(System.currentTimeMillis());
            
            // æ£€æŸ¥æ˜¯å¦æœ‰å¼‚å¸¸å‘ç”Ÿ
            Throwable exception = (Throwable) request.getAttribute("javax.servlet.error.exception");
            if (exception != null) {
                handleException(context, exception, request);
            }
            
            // æ£€æŸ¥HTTPçŠ¶æ€ç 
            if (response != null) {
                int status = response.getStatus();
                if (status >= 400) {
                    handleErrorStatus(context, status, request);
                }
            }
        }
    }
    
    private void handleException(RequestContext context, Throwable exception, 
                               HttpServletRequest request) {
        logger.error("ğŸš¨ è¯·æ±‚å¼‚å¸¸ - ID: {}, URI: {}, å¼‚å¸¸: {}", 
                    context.getRequestId(), 
                    context.getUri(), 
                    exception.getMessage(), exception);
        
        // å¯ä»¥å°†å¼‚å¸¸ä¿¡æ¯å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ
        sendToMonitoringSystem(context, exception);
    }
    
    private void handleErrorStatus(RequestContext context, int status, 
                                 HttpServletRequest request) {
        if (status == 404) {
            logger.warn("ğŸ“„ 404é”™è¯¯ - ID: {}, URI: {}", 
                       context.getRequestId(), context.getUri());
        } else if (status >= 500) {
            logger.error("ğŸ’¥ æœåŠ¡å™¨é”™è¯¯ - ID: {}, URI: {}, Status: {}", 
                        context.getRequestId(), context.getUri(), status);
        }
    }
    
    private void sendToMonitoringSystem(RequestContext context, Throwable exception) {
        // è¿™é‡Œå¯ä»¥é›†æˆç¬¬ä¸‰æ–¹ç›‘æ§ç³»ç»Ÿï¼Œå¦‚ï¼š
        // - å‘é€é‚®ä»¶é€šçŸ¥
        // - æ¨é€åˆ°é’‰é’‰ã€ä¼ä¸šå¾®ä¿¡
        // - å‘é€åˆ°ELKæ—¥å¿—ç³»ç»Ÿ
        // - ä¸ŠæŠ¥åˆ°APMç›‘æ§å¹³å°
        System.out.println("ğŸ“¤ å¼‚å¸¸å·²ä¸ŠæŠ¥åˆ°ç›‘æ§ç³»ç»Ÿ");
    }
}

// è¯·æ±‚ä¸Šä¸‹æ–‡ç±»
class RequestContext {
    private String requestId;
    private long startTime;
    private long endTime;
    private String uri;
    private String method;
    private String userAgent;
    
    // getter/setteræ–¹æ³•çœç•¥...
    
    public long getDuration() {
        return endTime - startTime;
    }
}
```

### 6.2 è¯·æ±‚è¶…æ—¶ç›‘æ§


```java
@WebListener
public class RequestTimeoutMonitor implements ServletRequestListener {
    
    private static final long TIMEOUT_THRESHOLD = 30000; // 30ç§’è¶…æ—¶é˜ˆå€¼
    private static final ScheduledExecutorService scheduler = 
            Executors.newScheduledThreadPool(2);
    
    // å­˜å‚¨æ´»è·ƒè¯·æ±‚çš„è¶…æ—¶æ£€æŸ¥ä»»åŠ¡
    private static final Map<String, ScheduledFuture<?>> timeoutTasks = 
            new ConcurrentHashMap<>();
    
    @Override
    public void requestInitialized(ServletRequestEvent sre) {
        HttpServletRequest request = (HttpServletRequest) sre.getServletRequest();
        String requestId = "REQ-" + System.nanoTime();
        
        request.setAttribute("requestId", requestId);
        request.setAttribute("startTime", System.currentTimeMillis());
        
        // å¯åŠ¨è¶…æ—¶æ£€æŸ¥ä»»åŠ¡
        ScheduledFuture<?> timeoutTask = scheduler.schedule(() -> {
            checkTimeout(requestId, request);
        }, TIMEOUT_THRESHOLD, TimeUnit.MILLISECONDS);
        
        timeoutTasks.put(requestId, timeoutTask);
    }
    
    @Override
    public void requestDestroyed(ServletRequestEvent sre) {
        HttpServletRequest request = (HttpServletRequest) sre.getServletRequest();
        String requestId = (String) request.getAttribute("requestId");
        
        if (requestId != null) {
            // å–æ¶ˆè¶…æ—¶æ£€æŸ¥ä»»åŠ¡
            ScheduledFuture<?> task = timeoutTasks.remove(requestId);
            if (task != null && !task.isDone()) {
                task.cancel(false);
            }
            
            // è®°å½•æ­£å¸¸å®Œæˆçš„è¯·æ±‚
            Long startTime = (Long) request.getAttribute("startTime");
            if (startTime != null) {
                long duration = System.currentTimeMillis() - startTime;
                System.out.println("âœ… è¯·æ±‚æ­£å¸¸å®Œæˆ - ID: " + requestId + 
                                 ", è€—æ—¶: " + duration + "ms");
            }
        }
    }
    
    private void checkTimeout(String requestId, HttpServletRequest request) {
        System.out.println("â° è¯·æ±‚è¶…æ—¶è­¦å‘Š - ID: " + requestId + 
                          ", URI: " + request.getRequestURI() + 
                          ", å·²è¶…è¿‡" + TIMEOUT_THRESHOLD + "ms");
        
        // å¯ä»¥åœ¨è¿™é‡Œé‡‡å–è¿›ä¸€æ­¥çš„æªæ–½ï¼š
        // 1. å‘é€å‘Šè­¦é€šçŸ¥
        // 2. è®°å½•åˆ°ç›‘æ§ç³»ç»Ÿ  
        // 3. å°è¯•ç»ˆæ­¢é•¿æ—¶é—´è¿è¡Œçš„è¯·æ±‚ï¼ˆéœ€è¦ç‰¹æ®Šæœºåˆ¶ï¼‰
    }
}
```

---

## 7. ğŸ” è¯·æ±‚é“¾è·¯è·Ÿè¸ª


### 7.1 ç®€å•é“¾è·¯è·Ÿè¸ªå®ç°


```java
@WebListener
public class SimpleTraceListener implements ServletRequestListener {
    
    // ä½¿ç”¨ThreadLocalå­˜å‚¨å½“å‰çº¿ç¨‹çš„è·Ÿè¸ªä¿¡æ¯
    private static final ThreadLocal<TraceContext> traceContextHolder = new ThreadLocal<>();
    
    @Override
    public void requestInitialized(ServletRequestEvent sre) {
        HttpServletRequest request = (HttpServletRequest) sre.getServletRequest();
        
        // ç”Ÿæˆæˆ–è·å–è·Ÿè¸ªID
        String traceId = getOrGenerateTraceId(request);
        String spanId = generateSpanId();
        
        // åˆ›å»ºè·Ÿè¸ªä¸Šä¸‹æ–‡
        TraceContext traceContext = new TraceContext(traceId, spanId);
        traceContext.setOperation("HTTP " + request.getMethod() + " " + request.getRequestURI());
        traceContext.setStartTime(System.currentTimeMillis());
        
        // è®¾ç½®åˆ°ThreadLocalå’ŒRequestä¸­
        traceContextHolder.set(traceContext);
        request.setAttribute("traceContext", traceContext);
        
        // è¾“å‡ºé“¾è·¯å¼€å§‹ä¿¡æ¯
        System.out.println("ğŸ”— é“¾è·¯å¼€å§‹ - TraceID: " + traceId + 
                          ", SpanID: " + spanId + 
                          ", Operation: " + traceContext.getOperation());
    }
    
    @Override
    public void requestDestroyed(ServletRequestEvent sre) {
        try {
            TraceContext traceContext = traceContextHolder.get();
            if (traceContext != null) {
                traceContext.setEndTime(System.currentTimeMillis());
                
                // è¾“å‡ºé“¾è·¯ç»“æŸä¿¡æ¯
                System.out.println("ğŸ é“¾è·¯ç»“æŸ - TraceID: " + traceContext.getTraceId() + 
                                  ", SpanID: " + traceContext.getSpanId() + 
                                  ", Duration: " + traceContext.getDuration() + "ms");
                
                // å‘é€åˆ°é“¾è·¯è·Ÿè¸ªç³»ç»Ÿï¼ˆå¦‚Zipkinã€Jaegerç­‰ï¼‰
                sendTraceToSystem(traceContext);
            }
        } finally {
            // æ¸…ç†ThreadLocalï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
            traceContextHolder.remove();
        }
    }
    
    private String getOrGenerateTraceId(HttpServletRequest request) {
        // å…ˆå°è¯•ä»è¯·æ±‚å¤´è·å–ï¼ˆç”¨äºåˆ†å¸ƒå¼åœºæ™¯ï¼‰
        String traceId = request.getHeader("X-Trace-Id");
        if (traceId == null || traceId.trim().isEmpty()) {
            // ç”Ÿæˆæ–°çš„è·Ÿè¸ªID
            traceId = "trace-" + System.currentTimeMillis() + "-" + 
                     Integer.toHexString((int)(Math.random() * 1000000));
        }
        return traceId;
    }
    
    private String generateSpanId() {
        return "span-" + Integer.toHexString((int)(Math.random() * 1000000));
    }
    
    private void sendTraceToSystem(TraceContext traceContext) {
        // è¿™é‡Œå¯ä»¥é›†æˆå…·ä½“çš„é“¾è·¯è·Ÿè¸ªç³»ç»Ÿ
        // ä¾‹å¦‚ï¼šå‘é€åˆ°Zipkinã€Jaegerã€SkyWalkingç­‰
        System.out.println("ğŸ“¤ é“¾è·¯æ•°æ®å·²å‘é€åˆ°è·Ÿè¸ªç³»ç»Ÿ");
    }
    
    // æä¾›é™æ€æ–¹æ³•ç»™å…¶ä»–ç»„ä»¶ä½¿ç”¨
    public static TraceContext getCurrentTrace() {
        return traceContextHolder.get();
    }
    
    public static String getCurrentTraceId() {
        TraceContext context = traceContextHolder.get();
        return context != null ? context.getTraceId() : null;
    }
}

// è·Ÿè¸ªä¸Šä¸‹æ–‡ç±»
class TraceContext {
    private final String traceId;
    private final String spanId;
    private String operation;
    private long startTime;
    private long endTime;
    private final Map<String, String> tags = new HashMap<>();
    
    public TraceContext(String traceId, String spanId) {
        this.traceId = traceId;
        this.spanId = spanId;
    }
    
    public long getDuration() {
        return endTime - startTime;
    }
    
    public void addTag(String key, String value) {
        tags.put(key, value);
    }
    
    // getter/setteræ–¹æ³•çœç•¥...
}
```

### 7.2 ä¸å…¶ä»–ç»„ä»¶çš„é›†æˆç¤ºä¾‹


åœ¨Servletä¸­ä½¿ç”¨é“¾è·¯è·Ÿè¸ªï¼š
```java
@WebServlet("/api/users")
public class UserServlet extends HttpServlet {
    
    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) 
            throws ServletException, IOException {
        
        // è·å–å½“å‰è¯·æ±‚çš„è·Ÿè¸ªä¿¡æ¯
        String traceId = SimpleTraceListener.getCurrentTraceId();
        System.out.println("ğŸ” å¤„ç†ç”¨æˆ·æŸ¥è¯¢è¯·æ±‚ - TraceID: " + traceId);
        
        // åœ¨å“åº”å¤´ä¸­è¿”å›è·Ÿè¸ªIDï¼Œæ–¹ä¾¿å‰ç«¯è°ƒè¯•
        response.setHeader("X-Trace-Id", traceId);
        
        // ä¸šåŠ¡é€»è¾‘å¤„ç†...
        response.getWriter().write("ç”¨æˆ·æ•°æ®æŸ¥è¯¢å®Œæˆï¼ŒTraceID: " + traceId);
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ ServletRequestç”Ÿå‘½å‘¨æœŸï¼šåˆ›å»º â†’ ä½¿ç”¨ â†’ é”€æ¯ä¸‰ä¸ªé˜¶æ®µ
ğŸ”¸ ServletRequestListenerï¼šç›‘å¬Requestå¯¹è±¡ç”Ÿå‘½å‘¨æœŸçš„æ ‡å‡†æ¥å£  
ğŸ”¸ requestInitializedï¼šRequeståˆ›å»ºæ—¶è°ƒç”¨ï¼Œç”¨äºåˆå§‹åŒ–æ“ä½œ
ğŸ”¸ requestDestroyedï¼šRequesté”€æ¯æ—¶è°ƒç”¨ï¼Œç”¨äºæ¸…ç†å’Œç»Ÿè®¡
ğŸ”¸ ServletRequestEventï¼šäº‹ä»¶å¯¹è±¡ï¼ŒåŒ…å«Requestå’ŒServletContextä¿¡æ¯
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ç›‘å¬å™¨çš„æ‰§è¡Œæ—¶æœº**
```
HTTPè¯·æ±‚ â†’ Tomcatåˆ›å»ºRequestå¯¹è±¡ â†’ requestInitialized()
         â†“
Filteré“¾ â†’ Servletå¤„ç† â†’ JSPæ¸²æŸ“
         â†“  
é”€æ¯Requestå¯¹è±¡ â† requestDestroyed() â† å“åº”è¿”å›å®¢æˆ·ç«¯
```

**ğŸ”¹ ä¸Filterçš„åŒºåˆ«**
| ç»„ä»¶ç±»å‹ | **æ‰§è¡Œæ—¶æœº** | **ä¸»è¦ç”¨é€”** | **æ‰§è¡Œæ¬¡æ•°** |
|---------|------------|-------------|-------------|
| **RequestListener** | Requestç”Ÿå‘½å‘¨æœŸè¾¹ç•Œ | ç›‘æ§ã€ç»Ÿè®¡ã€åˆå§‹åŒ– | æ¯æ¬¡è¯·æ±‚2æ¬¡ï¼ˆåˆå§‹åŒ–+é”€æ¯ï¼‰ |  
| **Filter** | è¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸­ | é¢„å¤„ç†ã€åå¤„ç† | å¯å¤šæ¬¡æ‰§è¡Œï¼ˆé“¾å¼ï¼‰ |

**ğŸ”¹ çº¿ç¨‹å®‰å…¨è€ƒè™‘**
```
âš ï¸  ç›‘å¬å™¨æ˜¯å•ä¾‹ï¼šä¸€ä¸ªåº”ç”¨åªæœ‰ä¸€ä¸ªå®ä¾‹
âœ…  ä½¿ç”¨ThreadLocalï¼šå­˜å‚¨çº¿ç¨‹ç›¸å…³æ•°æ®  
âœ…  ä½¿ç”¨Atomicç±»ï¼šçº¿ç¨‹å®‰å…¨çš„è®¡æ•°å™¨
âœ…  é¿å…å…±äº«å˜é‡ï¼šé˜²æ­¢å¹¶å‘é—®é¢˜
```

### 8.3 å®é™…åº”ç”¨åœºæ™¯æ€»ç»“


**ğŸ“Š æ€§èƒ½ç›‘æ§**ï¼š
- ç»Ÿè®¡è¯·æ±‚æ•°é‡ã€å“åº”æ—¶é—´
- ç›‘æ§æ…¢è¯·æ±‚ã€å†…å­˜ä½¿ç”¨
- ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š

**ğŸ” è¯·æ±‚è·Ÿè¸ª**ï¼š
- ç”Ÿæˆå”¯ä¸€è¯·æ±‚ID
- è®°å½•è¯·æ±‚é“¾è·¯ä¿¡æ¯  
- ä¾¿äºé—®é¢˜æ’æŸ¥

**ğŸš¨ å¼‚å¸¸å¤„ç†**ï¼š
- æ•è·å’Œè®°å½•å¼‚å¸¸
- ç›‘æ§é”™è¯¯çŠ¶æ€ç 
- å‘é€å‘Šè­¦é€šçŸ¥

**ğŸ“ˆ ä¸šåŠ¡åˆ†æ**ï¼š
- ç”¨æˆ·è¡Œä¸ºç»Ÿè®¡
- è®¿é—®è·¯å¾„åˆ†æ
- ä¸šåŠ¡æŒ‡æ ‡æ”¶é›†

### 8.4 æœ€ä½³å®è·µå»ºè®®


âœ… **æ¨èåšæ³•**ï¼š
- ä½¿ç”¨`@WebListener`æ³¨è§£æ³¨å†Œç›‘å¬å™¨
- åœ¨ç›‘å¬å™¨ä¸­åªåšè½»é‡çº§æ“ä½œ
- ä½¿ç”¨å¼‚æ­¥æ–¹å¼å¤„ç†é‡é‡çº§ä»»åŠ¡ï¼ˆå¦‚å‘é€é‚®ä»¶ï¼‰
- åˆç†ä½¿ç”¨ThreadLocalå­˜å‚¨è¯·æ±‚ç›¸å…³æ•°æ®
- åŠæ—¶æ¸…ç†èµ„æºï¼Œé˜²æ­¢å†…å­˜æ³„æ¼

âŒ **é¿å…åšæ³•**ï¼š
- åœ¨ç›‘å¬å™¨ä¸­æ‰§è¡Œè€—æ—¶æ“ä½œ
- ç›´æ¥æ“ä½œæ•°æ®åº“è¿›è¡Œå¤§é‡æŸ¥è¯¢
- å¿˜è®°æ¸…ç†ThreadLocalå˜é‡
- åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨è¿‡å¤šçš„æ—¥å¿—è¾“å‡º

> ğŸ’¡ **æ ¸å¿ƒè®°å¿†**ï¼šServletRequestç›‘å¬å™¨å°±åƒæ˜¯è¯·æ±‚çš„"é—¨å«"ï¼Œåœ¨è¯·æ±‚è¿›é—¨å’Œå‡ºé—¨æ—¶éƒ½ä¼šè®°å½•ä¸€ä¸‹ï¼Œä¸»è¦ç”¨æ¥åšç»Ÿè®¡ã€ç›‘æ§å’Œè·Ÿè¸ªå·¥ä½œã€‚è®°ä½å®ƒåªè´Ÿè´£ç›‘å¬ï¼Œä¸å‚ä¸å…·ä½“çš„ä¸šåŠ¡å¤„ç†ï¼