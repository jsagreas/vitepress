---
title: 2ã€Filter-ç”¨æˆ·è®¤è¯æˆæƒæ§åˆ¶
---
## ğŸ“š ç›®å½•

1. [è®¤è¯ä¸æˆæƒåŸºç¡€æ¦‚å¿µ](#1-è®¤è¯ä¸æˆæƒåŸºç¡€æ¦‚å¿µ)
2. [ç™»å½•çŠ¶æ€æ£€æŸ¥å®ç°](#2-ç™»å½•çŠ¶æ€æ£€æŸ¥å®ç°)
3. [Sessionä¼šè¯éªŒè¯æœºåˆ¶](#3-Sessionä¼šè¯éªŒè¯æœºåˆ¶)
4. [Tokenä»¤ç‰ŒéªŒè¯å®ç°](#4-Tokenä»¤ç‰ŒéªŒè¯å®ç°)
5. [ç™½åå•è·¯å¾„é…ç½®](#5-ç™½åå•è·¯å¾„é…ç½®)
6. [è§’è‰²æƒé™æ§åˆ¶ç³»ç»Ÿ](#6-è§’è‰²æƒé™æ§åˆ¶ç³»ç»Ÿ)
7. [æœªç™»å½•é‡å®šå‘å¤„ç†](#7-æœªç™»å½•é‡å®šå‘å¤„ç†)
8. [æƒé™ä¸è¶³å¤„ç†æœºåˆ¶](#8-æƒé™ä¸è¶³å¤„ç†æœºåˆ¶)
9. [å®Œæ•´å®æˆ˜æ¡ˆä¾‹](#9-å®Œæ•´å®æˆ˜æ¡ˆä¾‹)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” è®¤è¯ä¸æˆæƒåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯è®¤è¯ä¸æˆæƒ


**ğŸ¤” å…ˆææ¸…æ¥šè¿™ä¸¤ä¸ªæ¦‚å¿µ**

```
è®¤è¯(Authentication)ï¼šä½ æ˜¯è°ï¼Ÿ
- å°±åƒè¿›å°åŒºè¦åˆ·é—¨ç¦å¡
- ç³»ç»Ÿç¡®è®¤ä½ çš„èº«ä»½æ˜¯çœŸå®çš„
- å¸¸è§æ–¹å¼ï¼šç”¨æˆ·åå¯†ç ã€æ‰‹æœºéªŒè¯ç 

æˆæƒ(Authorization)ï¼šä½ èƒ½åšä»€ä¹ˆï¼Ÿ
- å°±åƒä¸åŒçš„å‘˜å·¥æœ‰ä¸åŒçš„åŠå…¬æƒé™
- ç¡®è®¤ä½ æœ‰æƒé™è®¿é—®æŸä¸ªèµ„æº
- å¸¸è§æ–¹å¼ï¼šè§’è‰²æƒé™ã€è®¿é—®æ§åˆ¶åˆ—è¡¨
```

**ğŸ’¡ ç”Ÿæ´»ä¸­çš„ä¾‹å­**
```
é“¶è¡Œå–é’±è¿‡ç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ’é“¶è¡Œå¡      â”‚â”€â”€â”€â–¶â”‚   è¾“å…¥å¯†ç       â”‚  â† è¿™æ˜¯è®¤è¯
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   éªŒè¯èº«ä»½      â”‚    â”‚   ç¡®è®¤æ˜¯æœ¬äºº    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                     â”‚
           â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ£€æŸ¥ä½™é¢      â”‚â”€â”€â”€â–¶â”‚   å…è®¸å–é’±      â”‚  â† è¿™æ˜¯æˆæƒ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æŸ¥çœ‹æƒé™      â”‚    â”‚   æ‰§è¡Œæ“ä½œ      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 åœ¨JavaWebä¸­çš„åº”ç”¨åœºæ™¯


**ğŸ¯ å¸¸è§ä¸šåŠ¡åœºæ™¯**

| åœºæ™¯ | è®¤è¯éœ€æ±‚ | æˆæƒéœ€æ±‚ |
|------|----------|----------|
| **ç”µå•†ç½‘ç«™** | ç”¨æˆ·ç™»å½•éªŒè¯ | æ™®é€šç”¨æˆ·vsä¼šå‘˜æƒé™ |
| **ç®¡ç†åå°** | ç®¡ç†å‘˜èº«ä»½éªŒè¯ | ä¸åŒè§’è‰²ç®¡ç†ä¸åŒæ¨¡å— |
| **åœ¨çº¿æ•™è‚²** | å­¦å‘˜èº«ä»½ç¡®è®¤ | å…è´¹è¯¾ç¨‹vsä»˜è´¹è¯¾ç¨‹ |
| **ä¼ä¸šç³»ç»Ÿ** | å‘˜å·¥å·¥å·éªŒè¯ | éƒ¨é—¨æƒé™ã€èŒçº§æƒé™ |

**âš ï¸ ä¸ºä»€ä¹ˆè¦ç”¨è¿‡æ»¤å™¨å®ç°**
- **ç»Ÿä¸€å¤„ç†**ï¼šæ‰€æœ‰è¯·æ±‚éƒ½ç»è¿‡è¿‡æ»¤å™¨ï¼Œé¿å…é‡å¤ä»£ç 
- **é›†ä¸­ç®¡ç†**ï¼šè®¤è¯æˆæƒé€»è¾‘é›†ä¸­åœ¨ä¸€å¤„ï¼Œä¾¿äºç»´æŠ¤
- **çµæ´»é…ç½®**ï¼šå¯ä»¥çµæ´»é…ç½®å“ªäº›è·¯å¾„éœ€è¦éªŒè¯

---

## 2. âœ… ç™»å½•çŠ¶æ€æ£€æŸ¥å®ç°


### 2.1 ç™»å½•çŠ¶æ€æ£€æŸ¥çš„æœ¬è´¨


**ğŸ” ä»€ä¹ˆæ˜¯ç™»å½•çŠ¶æ€æ£€æŸ¥**

ç®€å•è¯´å°±æ˜¯ï¼š**åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å·²ç»ç™»å½•è¿‡ç³»ç»Ÿ**

```
ç”¨æˆ·è®¿é—®é¡µé¢æ—¶ï¼š
å¦‚æœå·²ç™»å½• â†’ æ­£å¸¸è®¿é—®
å¦‚æœæœªç™»å½• â†’ è·³è½¬åˆ°ç™»å½•é¡µé¢
```

**ğŸ’­ å®ç°æ€è·¯**
```
ç”¨æˆ·ç™»å½•æˆåŠŸåï¼š
1. åœ¨Sessionä¸­å­˜å‚¨ç”¨æˆ·ä¿¡æ¯
2. åç»­è¯·æ±‚æ£€æŸ¥Sessionä¸­æ˜¯å¦æœ‰ç”¨æˆ·ä¿¡æ¯
3. æœ‰ä¿¡æ¯ = å·²ç™»å½•ï¼Œæ— ä¿¡æ¯ = æœªç™»å½•
```

### 2.2 åŸºç¡€ç™»å½•æ£€æŸ¥è¿‡æ»¤å™¨


```java
@WebFilter(urlPatterns = "/*")
public class LoginCheckFilter implements Filter {
    
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, 
                        FilterChain chain) throws IOException, ServletException {
        
        // ç±»å‹è½¬æ¢ï¼Œè·å¾—æ›´å¤šåŠŸèƒ½
        HttpServletRequest req = (HttpServletRequest) request;
        HttpServletResponse resp = (HttpServletResponse) response;
        
        // è·å–å½“å‰è®¿é—®çš„è·¯å¾„
        String requestPath = req.getRequestURI();
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯ç™»å½•ç›¸å…³é¡µé¢ï¼ˆè¿™äº›é¡µé¢ä¸éœ€è¦éªŒè¯ï¼‰
        if (requestPath.contains("/login")) {
            // æ”¾è¡Œï¼Œç»§ç»­æ‰§è¡Œ
            chain.doFilter(request, response);
            return;
        }
        
        // ä»Sessionä¸­è·å–ç”¨æˆ·ä¿¡æ¯
        HttpSession session = req.getSession();
        Object user = session.getAttribute("user");
        
        if (user != null) {
            // å·²ç™»å½•ï¼Œç»§ç»­è®¿é—®
            chain.doFilter(request, response);
        } else {
            // æœªç™»å½•ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢
            resp.sendRedirect("/login.jsp");
        }
    }
}
```

**ğŸ“ ä»£ç è§£é‡Š**
- `req.getRequestURI()`ï¼šè·å–ç”¨æˆ·è®¿é—®çš„è·¯å¾„
- `session.getAttribute("user")`ï¼šä»Sessionä¸­è·å–ç”¨æˆ·ä¿¡æ¯
- `chain.doFilter()`ï¼šæ”¾è¡Œè¯·æ±‚ï¼Œç»§ç»­æ‰§è¡Œ
- `resp.sendRedirect()`ï¼šé‡å®šå‘åˆ°ç™»å½•é¡µé¢

---

## 3. ğŸ”„ Sessionä¼šè¯éªŒè¯æœºåˆ¶


### 3.1 Sessionæ˜¯ä»€ä¹ˆ


**ğŸ¤” é€šä¿—ç†è§£Session**

æƒ³è±¡ä½ å»é“¶è¡ŒåŠäº‹ï¼š
```
ç¬¬ä¸€æ¬¡å»é“¶è¡Œï¼š
ä½  â†’ å‘Šè¯‰æŸœå‘˜ä½ çš„èº«ä»½è¯å·
æŸœå‘˜ â†’ æŸ¥æ‰¾ä½ çš„ä¿¡æ¯ï¼Œç»™ä½ ä¸€ä¸ªå·ç ç‰Œ(SessionID)

åç»­åŠäº‹ï¼š
ä½  â†’ å‡ºç¤ºå·ç ç‰Œ
æŸœå‘˜ â†’ æ ¹æ®å·ç ç‰Œæ‰¾åˆ°ä½ çš„ä¿¡æ¯ï¼ŒçŸ¥é“ä½ æ˜¯è°
```

åœ¨Webä¸­ï¼š
- **SessionID**ï¼šå°±æ˜¯é‚£ä¸ªå·ç ç‰Œï¼Œå­˜åœ¨æµè§ˆå™¨Cookieä¸­
- **Sessionæ•°æ®**ï¼šå°±æ˜¯ä½ çš„ä¸ªäººä¿¡æ¯ï¼Œå­˜åœ¨æœåŠ¡å™¨å†…å­˜ä¸­

### 3.2 Sessionä¼šè¯éªŒè¯çš„å®Œæ•´æµç¨‹


```
ç”¨æˆ·ç™»å½•æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¾“å…¥è´¦å·   â”‚â”€â”€â”€â–¶â”‚  éªŒè¯å¯†ç    â”‚â”€â”€â”€â–¶â”‚ åˆ›å»ºSession â”‚
â”‚  å¯†ç        â”‚    â”‚            â”‚    â”‚ å­˜å‚¨ç”¨æˆ·ä¿¡æ¯â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åç»­è®¿é—®æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‘é€è¯·æ±‚   â”‚â”€â”€â”€â–¶â”‚ æ£€æŸ¥Session â”‚â”€â”€â”€â–¶â”‚  éªŒè¯ç»“æœ   â”‚
â”‚ (å¸¦SessionID)â”‚    â”‚ æ˜¯å¦æœ‰æ•ˆ    â”‚    â”‚ å†³å®šæ˜¯å¦æ”¾è¡Œâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 SessionéªŒè¯è¿‡æ»¤å™¨å®ç°


```java
@WebFilter(urlPatterns = "/*")
public class SessionValidationFilter implements Filter {
    
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, 
                        FilterChain chain) throws IOException, ServletException {
        
        HttpServletRequest req = (HttpServletRequest) request;
        HttpServletResponse resp = (HttpServletResponse) response;
        
        // è·å–Sessionï¼ˆä¸åˆ›å»ºæ–°çš„ï¼‰
        HttpSession session = req.getSession(false);
        
        // æ£€æŸ¥Sessionæ˜¯å¦å­˜åœ¨ä¸”æœ‰æ•ˆ
        if (isValidSession(session)) {
            // Sessionæœ‰æ•ˆï¼Œç»§ç»­æ‰§è¡Œ
            chain.doFilter(request, response);
        } else {
            // Sessionæ— æ•ˆï¼Œæ¸…ç†å¹¶é‡å®šå‘
            if (session != null) {
                session.invalidate(); // æ¸…ç†æ— æ•ˆSession
            }
            resp.sendRedirect("/login.jsp");
        }
    }
    
    /**
     * æ£€æŸ¥Sessionæ˜¯å¦æœ‰æ•ˆ
     */
    private boolean isValidSession(HttpSession session) {
        if (session == null) {
            return false; // Sessionä¸å­˜åœ¨
        }
        
        Object user = session.getAttribute("user");
        if (user == null) {
            return false; // æ²¡æœ‰ç”¨æˆ·ä¿¡æ¯
        }
        
        // æ£€æŸ¥Sessionæ˜¯å¦è¿‡æœŸ
        long lastAccessTime = session.getLastAccessedTime();
        long currentTime = System.currentTimeMillis();
        long timeout = session.getMaxInactiveInterval() * 1000; // è½¬æ¢ä¸ºæ¯«ç§’
        
        if (currentTime - lastAccessTime > timeout) {
            return false; // Sessionå·²è¿‡æœŸ
        }
        
        return true; // Sessionæœ‰æ•ˆ
    }
}
```

**ğŸ”§ SessionéªŒè¯çš„å…³é”®ç‚¹**

| éªŒè¯é¡¹ç›® | æ£€æŸ¥å†…å®¹ | å¤„ç†æ–¹å¼ |
|----------|----------|----------|
| **Sessionå­˜åœ¨æ€§** | `session != null` | ä¸å­˜åœ¨åˆ™é‡å®šå‘ç™»å½• |
| **ç”¨æˆ·ä¿¡æ¯** | `userå¯¹è±¡` | æ— ç”¨æˆ·ä¿¡æ¯åˆ™é‡å®šå‘ |
| **è¿‡æœŸæ—¶é—´** | `lastAccessTime` | è¶…æ—¶åˆ™æ¸…ç†Session |
| **SessionçŠ¶æ€** | `isValid()` | æ— æ•ˆåˆ™æ¸…ç†é‡å®šå‘ |

---

## 4. ğŸ« Tokenä»¤ç‰ŒéªŒè¯å®ç°


### 4.1 Tokenæ˜¯ä»€ä¹ˆ


**ğŸ¤” Tokenä»¤ç‰Œçš„é€šä¿—ç†è§£**

æƒ³è±¡ä½ å»æ¸¸ä¹å›­ï¼š
```
ä¼ ç»Ÿæ–¹å¼(Session)ï¼š
è¿›é—¨æ—¶ â†’ å·¥ä½œäººå‘˜åœ¨ä½ æ‰‹ä¸Šç›–ç« 
æ¯ä¸ªé¡¹ç›® â†’ æ£€æŸ¥æ‰‹ä¸Šçš„ç« 

Tokenæ–¹å¼ï¼š
è¿›é—¨æ—¶ â†’ ç»™ä½ ä¸€å¼ ç‰¹æ®Šç¥¨æ®(Token)
æ¯ä¸ªé¡¹ç›® â†’ æ‰«æç¥¨æ®ä¸Šçš„äºŒç»´ç éªŒè¯
```

**ğŸ’¡ Tokençš„ä¼˜åŠ¿**
- **æ— çŠ¶æ€**ï¼šæœåŠ¡å™¨ä¸éœ€è¦å­˜å‚¨Sessionä¿¡æ¯
- **å¯æ‰©å±•**ï¼šé€‚åˆåˆ†å¸ƒå¼ç³»ç»Ÿ
- **å®‰å…¨**ï¼šå¯ä»¥åŒ…å«è¿‡æœŸæ—¶é—´å’ŒåŠ å¯†ä¿¡æ¯

### 4.2 TokenéªŒè¯çš„å®ç°æ€è·¯


```
Tokenç”Ÿæˆè¿‡ç¨‹ï¼š
ç”¨æˆ·ç™»å½• â†’ éªŒè¯å¯†ç  â†’ ç”ŸæˆToken â†’ è¿”å›ç»™å®¢æˆ·ç«¯

TokenéªŒè¯è¿‡ç¨‹ï¼š
å®¢æˆ·ç«¯å‘é€è¯·æ±‚ â†’ æºå¸¦Token â†’ æœåŠ¡å™¨éªŒè¯Token â†’ å†³å®šæ˜¯å¦æ”¾è¡Œ
```

### 4.3 ç®€å•TokenéªŒè¯è¿‡æ»¤å™¨


```java
@WebFilter(urlPatterns = "/*")
public class TokenValidationFilter implements Filter {
    
    // ç®€å•çš„Tokenå­˜å‚¨ï¼ˆå®é™…é¡¹ç›®ä¸­å¯èƒ½ç”¨Redisï¼‰
    private static Map<String, UserInfo> tokenStore = new ConcurrentHashMap<>();
    
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, 
                        FilterChain chain) throws IOException, ServletException {
        
        HttpServletRequest req = (HttpServletRequest) request;
        HttpServletResponse resp = (HttpServletResponse) response;
        
        // ä»è¯·æ±‚å¤´ä¸­è·å–Token
        String token = getTokenFromRequest(req);
        
        if (token == null || !isValidToken(token)) {
            // Tokenæ— æ•ˆï¼Œè¿”å›é”™è¯¯ä¿¡æ¯
            resp.setStatus(401);
            resp.getWriter().write("è¯·å…ˆç™»å½•");
            return;
        }
        
        // Tokenæœ‰æ•ˆï¼Œå°†ç”¨æˆ·ä¿¡æ¯æ”¾å…¥è¯·æ±‚ä¸­
        UserInfo userInfo = tokenStore.get(token);
        req.setAttribute("currentUser", userInfo);
        
        chain.doFilter(request, response);
    }
    
    /**
     * ä»è¯·æ±‚ä¸­è·å–Token
     */
    private String getTokenFromRequest(HttpServletRequest req) {
        // ä»è¯·æ±‚å¤´è·å–
        String token = req.getHeader("Authorization");
        if (token != null && token.startsWith("Bearer ")) {
            return token.substring(7); // å»æ‰"Bearer "å‰ç¼€
        }
        
        // ä»å‚æ•°è·å–
        return req.getParameter("token");
    }
    
    /**
     * éªŒè¯Tokenæ˜¯å¦æœ‰æ•ˆ
     */
    private boolean isValidToken(String token) {
        UserInfo userInfo = tokenStore.get(token);
        if (userInfo == null) {
            return false;
        }
        
        // æ£€æŸ¥Tokenæ˜¯å¦è¿‡æœŸ
        return userInfo.getExpirationTime() > System.currentTimeMillis();
    }
    
    /**
     * ç”ŸæˆTokençš„å·¥å…·æ–¹æ³•
     */
    public static String generateToken(String username) {
        String token = UUID.randomUUID().toString();
        UserInfo userInfo = new UserInfo();
        userInfo.setUsername(username);
        userInfo.setExpirationTime(System.currentTimeMillis() + 24 * 60 * 60 * 1000); // 24å°æ—¶åè¿‡æœŸ
        
        tokenStore.put(token, userInfo);
        return token;
    }
}
```

**ğŸ“± Tokençš„ä½¿ç”¨æ–¹å¼**

| ä¼ é€’æ–¹å¼ | æ ¼å¼ | ç¤ºä¾‹ |
|----------|------|------|
| **è¯·æ±‚å¤´** | `Authorization: Bearer <token>` | `Authorization: Bearer abc123` |
| **URLå‚æ•°** | `?token=<token>` | `http://example.com/api?token=abc123` |
| **POSTå‚æ•°** | `token=<token>` | è¡¨å•ä¸­åŒ…å«tokenå­—æ®µ |

---

## 5. ğŸ“‹ ç™½åå•è·¯å¾„é…ç½®


### 5.1 ä»€ä¹ˆæ˜¯ç™½åå•è·¯å¾„


**ğŸ¤” ç™½åå•çš„é€šä¿—ç†è§£**

ç™½åå•å°±åƒï¼š
```
å°åŒºçš„è®¿å®¢é€šé“ï¼š
- ä¸šä¸»å¯ä»¥è‡ªç”±è¿›å‡ºï¼ˆå·²ç™»å½•ç”¨æˆ·ï¼‰
- è®¿å®¢åªèƒ½èµ°æŒ‡å®šé€šé“ï¼ˆç™½åå•è·¯å¾„ï¼‰
- å¿«é€’å‘˜å¯ä»¥åˆ°é—¨å…ï¼ˆå…¬å…±èµ„æºï¼‰
```

åœ¨Webç³»ç»Ÿä¸­ï¼š
- **ç™½åå•è·¯å¾„**ï¼šæ— éœ€ç™»å½•å°±èƒ½è®¿é—®çš„é¡µé¢
- **å¸¸è§ç™½åå•**ï¼šç™»å½•é¡µã€æ³¨å†Œé¡µã€é¦–é¡µã€é™æ€èµ„æº

### 5.2 ç™½åå•é…ç½®çš„å®ç°æ–¹å¼


**ğŸ“ é…ç½®æ–‡ä»¶æ–¹å¼ï¼ˆæ¨èï¼‰**

åˆ›å»ºé…ç½®æ–‡ä»¶ `whitelist.properties`ï¼š
```properties
# ç™½åå•è·¯å¾„é…ç½®
whitelist.paths=/login,/register,/index,/captcha,/static/*,*.css,*.js,*.jpg,*.png
```

**ğŸ”§ ç™½åå•è¿‡æ»¤å™¨å®ç°**

```java
@WebFilter(urlPatterns = "/*")
public class WhitelistFilter implements Filter {
    
    private List<String> whitelistPaths;
    
    @Override
    public void init(FilterConfig filterConfig) throws ServletException {
        // åˆå§‹åŒ–æ—¶åŠ è½½ç™½åå•é…ç½®
        loadWhitelistPaths();
    }
    
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, 
                        FilterChain chain) throws IOException, ServletException {
        
        HttpServletRequest req = (HttpServletRequest) request;
        HttpServletResponse resp = (HttpServletResponse) response;
        
        String requestPath = req.getRequestURI();
        
        // æ£€æŸ¥æ˜¯å¦åœ¨ç™½åå•ä¸­
        if (isInWhitelist(requestPath)) {
            // åœ¨ç™½åå•ä¸­ï¼Œç›´æ¥æ”¾è¡Œ
            chain.doFilter(request, response);
            return;
        }
        
        // ä¸åœ¨ç™½åå•ä¸­ï¼Œè¿›è¡Œè®¤è¯æ£€æŸ¥
        if (isAuthenticated(req)) {
            chain.doFilter(request, response);
        } else {
            resp.sendRedirect("/login");
        }
    }
    
    /**
     * åŠ è½½ç™½åå•è·¯å¾„
     */
    private void loadWhitelistPaths() {
        whitelistPaths = new ArrayList<>();
        try {
            Properties props = new Properties();
            props.load(getClass().getResourceAsStream("/whitelist.properties"));
            
            String paths = props.getProperty("whitelist.paths");
            String[] pathArray = paths.split(",");
            
            for (String path : pathArray) {
                whitelistPaths.add(path.trim());
            }
        } catch (IOException e) {
            // ä½¿ç”¨é»˜è®¤ç™½åå•
            whitelistPaths.add("/login");
            whitelistPaths.add("/register");
            whitelistPaths.add("/static/*");
        }
    }
    
    /**
     * æ£€æŸ¥è·¯å¾„æ˜¯å¦åœ¨ç™½åå•ä¸­
     */
    private boolean isInWhitelist(String requestPath) {
        for (String whitelistPath : whitelistPaths) {
            if (matchPath(requestPath, whitelistPath)) {
                return true;
            }
        }
        return false;
    }
    
    /**
     * è·¯å¾„åŒ¹é…é€»è¾‘ï¼ˆæ”¯æŒé€šé…ç¬¦ï¼‰
     */
    private boolean matchPath(String requestPath, String whitelistPath) {
        // ç²¾ç¡®åŒ¹é…
        if (whitelistPath.equals(requestPath)) {
            return true;
        }
        
        // é€šé…ç¬¦åŒ¹é…
        if (whitelistPath.endsWith("/*")) {
            String prefix = whitelistPath.substring(0, whitelistPath.length() - 2);
            return requestPath.startsWith(prefix);
        }
        
        // æ‰©å±•ååŒ¹é…
        if (whitelistPath.startsWith("*.")) {
            String extension = whitelistPath.substring(1);
            return requestPath.endsWith(extension);
        }
        
        return false;
    }
    
    private boolean isAuthenticated(HttpServletRequest req) {
        HttpSession session = req.getSession(false);
        return session != null && session.getAttribute("user") != null;
    }
}
```

### 5.3 å¸¸è§ç™½åå•é…ç½®


**ğŸ¯ å…¸å‹ç™½åå•è·¯å¾„**

| è·¯å¾„ç±»å‹ | ç¤ºä¾‹ | è¯´æ˜ |
|----------|------|------|
| **ç™»å½•ç›¸å…³** | `/login`, `/register`, `/logout` | ç”¨æˆ·è®¤è¯ç›¸å…³é¡µé¢ |
| **å…¬å…±é¡µé¢** | `/`, `/index`, `/about` | é¦–é¡µå’Œä»‹ç»é¡µé¢ |
| **é™æ€èµ„æº** | `/static/*`, `*.css`, `*.js` | CSSã€JSã€å›¾ç‰‡ç­‰ |
| **APIæ¥å£** | `/api/public/*` | å…¬å¼€çš„APIæ¥å£ |
| **éªŒè¯ç ** | `/captcha`, `/verify` | éªŒè¯ç ç”Ÿæˆå’ŒéªŒè¯ |

**âš ï¸ ç™½åå•é…ç½®æ³¨æ„äº‹é¡¹**
- ğŸ”¸ **æœ€å°æƒé™åŸåˆ™**ï¼šåªå¼€æ”¾å¿…è¦çš„è·¯å¾„
- ğŸ”¸ **é™æ€èµ„æº**ï¼šCSSã€JSç­‰å¿…é¡»åœ¨ç™½åå•ä¸­
- ğŸ”¸ **è·¯å¾„åŒ¹é…**ï¼šæ³¨æ„é€šé…ç¬¦çš„ä½¿ç”¨
- ğŸ”¸ **å®‰å…¨å®¡æŸ¥**ï¼šå®šæœŸæ£€æŸ¥ç™½åå•é…ç½®

---

## 6. ğŸ‘¥ è§’è‰²æƒé™æ§åˆ¶ç³»ç»Ÿ


### 6.1 è§’è‰²æƒé™çš„åŸºæœ¬æ¦‚å¿µ


**ğŸ¤” è§’è‰²æƒé™çš„ç”Ÿæ´»ä¾‹å­**

æƒ³è±¡ä¸€ä¸ªå…¬å¸çš„æƒé™ä½“ç³»ï¼š
```
å‘˜å·¥å±‚çº§ï¼š
è€æ¿ â†’ å¯ä»¥çœ‹æ‰€æœ‰éƒ¨é—¨æ•°æ®ï¼Œåšæ‰€æœ‰å†³å®š
éƒ¨é—¨ç»ç† â†’ åªèƒ½çœ‹è‡ªå·±éƒ¨é—¨æ•°æ®ï¼Œç®¡ç†ä¸‹å±
æ™®é€šå‘˜å·¥ â†’ åªèƒ½çœ‹è‡ªå·±çš„å·¥ä½œä»»åŠ¡

å¯¹åº”åˆ°ç³»ç»Ÿä¸­ï¼š
ç®¡ç†å‘˜ â†’ ç”¨æˆ·ç®¡ç†ã€ç³»ç»Ÿé…ç½®ã€æ•°æ®ç»Ÿè®¡
æ™®é€šç”¨æˆ· â†’ ä¸ªäººä¿¡æ¯ã€åŸºæœ¬åŠŸèƒ½ä½¿ç”¨
æ¸¸å®¢ â†’ åªèƒ½æµè§ˆå…¬å¼€å†…å®¹
```

**ğŸ”§ æƒé™æ§åˆ¶çš„ä¸‰ä¸ªå±‚æ¬¡**

```
ç”¨æˆ· â†â†’ è§’è‰² â†â†’ æƒé™
å¼ ä¸‰     ç®¡ç†å‘˜     ç”¨æˆ·ç®¡ç†
æå››     æ™®é€šç”¨æˆ·   æŸ¥çœ‹è®¢å•
ç‹äº”     VIPç”¨æˆ·    é«˜çº§åŠŸèƒ½
```

### 6.2 è§’è‰²æƒé™æ•°æ®ç»“æ„è®¾è®¡


```java
/**
 * ç”¨æˆ·è§’è‰²æšä¸¾
 */
public enum UserRole {
    ADMIN("ç®¡ç†å‘˜", 1),
    USER("æ™®é€šç”¨æˆ·", 2),
    VIP("VIPç”¨æˆ·", 3),
    GUEST("æ¸¸å®¢", 4);
    
    private String roleName;
    private int level;
    
    UserRole(String roleName, int level) {
        this.roleName = roleName;
        this.level = level;
    }
    
    // getteræ–¹æ³•...
}

/**
 * ç”¨æˆ·ä¿¡æ¯ç±»
 */
public class User {
    private String username;
    private UserRole role;
    private List<String> permissions; // å…·ä½“æƒé™åˆ—è¡¨
    
    // æ£€æŸ¥æ˜¯å¦æœ‰æŸä¸ªæƒé™
    public boolean hasPermission(String permission) {
        return permissions != null && permissions.contains(permission);
    }
}
```

### 6.3 è§’è‰²æƒé™éªŒè¯è¿‡æ»¤å™¨


```java
@WebFilter(urlPatterns = "/*")
public class RolePermissionFilter implements Filter {
    
    // è·¯å¾„æƒé™é…ç½®ï¼ˆå®é™…é¡¹ç›®ä¸­å¯èƒ½å­˜åœ¨æ•°æ®åº“ï¼‰
    private Map<String, String[]> pathPermissions;
    
    @Override
    public void init(FilterConfig filterConfig) throws ServletException {
        initPathPermissions();
    }
    
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, 
                        FilterChain chain) throws IOException, ServletException {
        
        HttpServletRequest req = (HttpServletRequest) request;
        HttpServletResponse resp = (HttpServletResponse) response;
        
        String requestPath = req.getRequestURI();
        
        // è·å–å½“å‰ç”¨æˆ·
        User currentUser = getCurrentUser(req);
        if (currentUser == null) {
            resp.sendRedirect("/login");
            return;
        }
        
        // æ£€æŸ¥æ˜¯å¦æœ‰æƒé™è®¿é—®
        if (hasPermissionForPath(currentUser, requestPath)) {
            chain.doFilter(request, response);
        } else {
            // æƒé™ä¸è¶³ï¼Œè¿”å›403
            resp.setStatus(403);
            resp.getWriter().write("æƒé™ä¸è¶³ï¼Œæ— æ³•è®¿é—®æ­¤é¡µé¢");
        }
    }
    
    /**
     * åˆå§‹åŒ–è·¯å¾„æƒé™é…ç½®
     */
    private void initPathPermissions() {
        pathPermissions = new HashMap<>();
        
        // ç®¡ç†å‘˜é¡µé¢
        pathPermissions.put("/admin/*", new String[]{"ADMIN"});
        pathPermissions.put("/user-management", new String[]{"ADMIN"});
        
        // VIPåŠŸèƒ½
        pathPermissions.put("/vip/*", new String[]{"ADMIN", "VIP"});
        
        // æ™®é€šç”¨æˆ·åŠŸèƒ½
        pathPermissions.put("/profile", new String[]{"ADMIN", "VIP", "USER"});
        pathPermissions.put("/order/*", new String[]{"ADMIN", "VIP", "USER"});
    }
    
    /**
     * è·å–å½“å‰ç”¨æˆ·
     */
    private User getCurrentUser(HttpServletRequest req) {
        HttpSession session = req.getSession(false);
        if (session != null) {
            return (User) session.getAttribute("currentUser");
        }
        return null;
    }
    
    /**
     * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®æŒ‡å®šè·¯å¾„
     */
    private boolean hasPermissionForPath(User user, String path) {
        // æ£€æŸ¥è·¯å¾„æ˜¯å¦éœ€è¦æƒé™éªŒè¯
        String[] requiredRoles = getRequiredRolesForPath(path);
        if (requiredRoles == null || requiredRoles.length == 0) {
            return true; // æ— éœ€ç‰¹æ®Šæƒé™
        }
        
        // æ£€æŸ¥ç”¨æˆ·è§’è‰²æ˜¯å¦æ»¡è¶³è¦æ±‚
        String userRole = user.getRole().name();
        for (String requiredRole : requiredRoles) {
            if (requiredRole.equals(userRole)) {
                return true;
            }
        }
        
        return false;
    }
    
    /**
     * è·å–è·¯å¾„æ‰€éœ€çš„è§’è‰²æƒé™
     */
    private String[] getRequiredRolesForPath(String path) {
        for (String pattern : pathPermissions.keySet()) {
            if (matchPath(path, pattern)) {
                return pathPermissions.get(pattern);
            }
        }
        return null;
    }
    
    private boolean matchPath(String path, String pattern) {
        if (pattern.endsWith("/*")) {
            String prefix = pattern.substring(0, pattern.length() - 2);
            return path.startsWith(prefix);
        }
        return pattern.equals(path);
    }
}
```

### 6.4 æƒé™é…ç½®è¡¨


**ğŸ“Š å…¸å‹æƒé™é…ç½®ç¤ºä¾‹**

| è·¯å¾„æ¨¡å¼ | æ‰€éœ€è§’è‰² | åŠŸèƒ½è¯´æ˜ |
|----------|----------|----------|
| `/admin/*` | `ADMIN` | ç®¡ç†å‘˜åå° |
| `/user-management` | `ADMIN` | ç”¨æˆ·ç®¡ç† |
| `/system-config` | `ADMIN` | ç³»ç»Ÿé…ç½® |
| `/vip/*` | `ADMIN, VIP` | VIPä¸“å±åŠŸèƒ½ |
| `/profile` | `ADMIN, VIP, USER` | ä¸ªäººä¸­å¿ƒ |
| `/order/*` | `ADMIN, VIP, USER` | è®¢å•ç®¡ç† |
| `/public/*` | `æ‰€æœ‰ç”¨æˆ·` | å…¬å…±èµ„æº |

---

## 7. ğŸ”„ æœªç™»å½•é‡å®šå‘å¤„ç†


### 7.1 é‡å®šå‘çš„åŸºæœ¬æ¦‚å¿µ


**ğŸ¤” é‡å®šå‘æ˜¯ä»€ä¹ˆ**

é‡å®šå‘å°±åƒï¼š
```
ä½ å»é“¶è¡ŒåŠäº‹ â†’ å‘ç°æ²¡å¸¦èº«ä»½è¯ â†’ å·¥ä½œäººå‘˜è¯´"è¯·å…ˆå›å®¶æ‹¿èº«ä»½è¯"
ä½ è®¿é—®ç½‘é¡µ â†’ å‘ç°æ²¡æœ‰ç™»å½• â†’ ç³»ç»Ÿè¯´"è¯·å…ˆå»ç™»å½•é¡µé¢"
```

**ğŸ’¡ é‡å®šå‘ vs è½¬å‘çš„åŒºåˆ«**

```
é‡å®šå‘(Redirect)ï¼š
å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨A â†’ å‘Šè¯‰å®¢æˆ·ç«¯å»è®¿é—®æœåŠ¡å™¨B â†’ å®¢æˆ·ç«¯è®¿é—®æœåŠ¡å™¨B
ç‰¹ç‚¹ï¼šæµè§ˆå™¨åœ°å€æ ä¼šå˜åŒ–ï¼Œæ˜¯ä¸¤æ¬¡è¯·æ±‚

è½¬å‘(Forward)ï¼š
å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨A â†’ æœåŠ¡å™¨Aå†…éƒ¨è°ƒç”¨æœåŠ¡å™¨B â†’ è¿”å›ç»“æœç»™å®¢æˆ·ç«¯
ç‰¹ç‚¹ï¼šæµè§ˆå™¨åœ°å€æ ä¸å˜ï¼Œæ˜¯ä¸€æ¬¡è¯·æ±‚
```

### 7.2 ç™»å½•é‡å®šå‘å®ç°ç­–ç•¥


**ğŸ¯ é‡å®šå‘çš„å‡ ç§ç­–ç•¥**

| ç­–ç•¥ | å®ç°æ–¹å¼ | é€‚ç”¨åœºæ™¯ |
|------|----------|----------|
| **ç®€å•é‡å®šå‘** | ç›´æ¥è·³è½¬åˆ°ç™»å½•é¡µ | ç®€å•ç³»ç»Ÿ |
| **è®°ä½åŸé¡µé¢** | ç™»å½•åå›åˆ°åŸæ¥æƒ³è®¿é—®çš„é¡µé¢ | ç”¨æˆ·ä½“éªŒå¥½ |
| **Ajaxå‹å¥½** | APIè¯·æ±‚è¿”å›JSONï¼Œé¡µé¢è¯·æ±‚æ‰é‡å®šå‘ | å‰åç«¯åˆ†ç¦» |

### 7.3 å®Œæ•´çš„é‡å®šå‘å¤„ç†å®ç°


```java
@WebFilter(urlPatterns = "/*")
public class LoginRedirectFilter implements Filter {
    
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, 
                        FilterChain chain) throws IOException, ServletException {
        
        HttpServletRequest req = (HttpServletRequest) request;
        HttpServletResponse resp = (HttpServletResponse) response;
        
        // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
        if (!isLoggedIn(req)) {
            handleNotLoggedIn(req, resp);
            return;
        }
        
        chain.doFilter(request, response);
    }
    
    /**
     * å¤„ç†æœªç™»å½•çš„æƒ…å†µ
     */
    private void handleNotLoggedIn(HttpServletRequest req, HttpServletResponse resp) 
            throws IOException {
        
        String requestPath = req.getRequestURI();
        
        // åˆ¤æ–­æ˜¯å¦æ˜¯Ajaxè¯·æ±‚
        if (isAjaxRequest(req)) {
            handleAjaxRequest(resp);
        } else {
            handlePageRequest(req, resp, requestPath);
        }
    }
    
    /**
     * å¤„ç†Ajaxè¯·æ±‚
     */
    private void handleAjaxRequest(HttpServletResponse resp) throws IOException {
        resp.setStatus(401);
        resp.setContentType("application/json;charset=UTF-8");
        resp.getWriter().write("{\"code\":401,\"message\":\"è¯·å…ˆç™»å½•\"}");
    }
    
    /**
     * å¤„ç†é¡µé¢è¯·æ±‚
     */
    private void handlePageRequest(HttpServletRequest req, HttpServletResponse resp, 
                                 String requestPath) throws IOException {
        
        // è®°ä½ç”¨æˆ·åŸæ¥æƒ³è®¿é—®çš„é¡µé¢
        HttpSession session = req.getSession();
        if (!requestPath.equals("/login") && !requestPath.contains("login")) {
            session.setAttribute("redirectAfterLogin", requestPath);
        }
        
        // é‡å®šå‘åˆ°ç™»å½•é¡µé¢
        resp.sendRedirect(req.getContextPath() + "/login?from=" + 
                         java.net.URLEncoder.encode(requestPath, "UTF-8"));
    }
    
    /**
     * åˆ¤æ–­æ˜¯å¦æ˜¯Ajaxè¯·æ±‚
     */
    private boolean isAjaxRequest(HttpServletRequest req) {
        String xhr = req.getHeader("X-Requested-With");
        String contentType = req.getHeader("Content-Type");
        
        return "XMLHttpRequest".equals(xhr) || 
               (contentType != null && contentType.contains("application/json"));
    }
    
    /**
     * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
     */
    private boolean isLoggedIn(HttpServletRequest req) {
        HttpSession session = req.getSession(false);
        return session != null && session.getAttribute("user") != null;
    }
}
```

### 7.4 ç™»å½•åçš„å›è·³å¤„ç†


åœ¨ç™»å½•æˆåŠŸåï¼Œéœ€è¦è·³è½¬å›ç”¨æˆ·åŸæ¥æƒ³è®¿é—®çš„é¡µé¢ï¼š

```java
@WebServlet("/login")
public class LoginServlet extends HttpServlet {
    
    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) 
            throws ServletException, IOException {
        
        String username = req.getParameter("username");
        String password = req.getParameter("password");
        
        // éªŒè¯ç”¨æˆ·åå¯†ç 
        if (validateUser(username, password)) {
            // ç™»å½•æˆåŠŸï¼Œåˆ›å»ºSession
            HttpSession session = req.getSession();
            session.setAttribute("user", getUserInfo(username));
            
            // è·å–ç™»å½•å‰æƒ³è®¿é—®çš„é¡µé¢
            String redirectUrl = (String) session.getAttribute("redirectAfterLogin");
            if (redirectUrl != null && !redirectUrl.isEmpty()) {
                session.removeAttribute("redirectAfterLogin");
                resp.sendRedirect(redirectUrl);
            } else {
                // é»˜è®¤è·³è½¬åˆ°é¦–é¡µ
                resp.sendRedirect("/index");
            }
        } else {
            // ç™»å½•å¤±è´¥ï¼Œè¿”å›ç™»å½•é¡µé¢
            req.setAttribute("error", "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
            req.getRequestDispatcher("/login.jsp").forward(req, resp);
        }
    }
}
```

**ğŸ¯ é‡å®šå‘çš„ç”¨æˆ·ä½“éªŒä¼˜åŒ–**

```
æ™®é€šé‡å®šå‘æµç¨‹ï¼š
ç”¨æˆ·è®¿é—® /order â†’ è·³è½¬ /login â†’ ç™»å½•æˆåŠŸ â†’ è·³è½¬ /index âŒ

ä¼˜åŒ–åçš„æµç¨‹ï¼š
ç”¨æˆ·è®¿é—® /order â†’ è·³è½¬ /login â†’ ç™»å½•æˆåŠŸ â†’ è·³è½¬ /order âœ…
```

---

## 8. â›” æƒé™ä¸è¶³å¤„ç†æœºåˆ¶


### 8.1 æƒé™ä¸è¶³çš„åœºæ™¯


**ğŸ¤” ä»€ä¹ˆæ—¶å€™ä¼šå‡ºç°æƒé™ä¸è¶³**

ç”Ÿæ´»ä¸­çš„ä¾‹å­ï¼š
```
ä½ æœ‰å›¾ä¹¦é¦†å€Ÿä¹¦è¯ â†’ å¯ä»¥å€Ÿä¹¦çœ‹ä¹¦ âœ…
ä½†æ˜¯ä½ ä¸æ˜¯ç®¡ç†å‘˜ â†’ ä¸èƒ½è¿›å…¥å›¾ä¹¦ç®¡ç†ç³»ç»Ÿ âŒ

å¯¹åº”åˆ°ç³»ç»Ÿä¸­ï¼š
ç”¨æˆ·å·²ç»ç™»å½• â†’ å¯ä»¥ä½¿ç”¨åŸºæœ¬åŠŸèƒ½ âœ…
ä½†æ˜¯ä¸æ˜¯ç®¡ç†å‘˜ â†’ ä¸èƒ½è®¿é—®ç®¡ç†åå° âŒ
```

**âš ï¸ æƒé™ä¸è¶³ vs æœªç™»å½•çš„åŒºåˆ«**

| æƒ…å†µ | ç”¨æˆ·çŠ¶æ€ | å¤„ç†æ–¹å¼ | HTTPçŠ¶æ€ç  |
|------|----------|----------|------------|
| **æœªç™»å½•** | æ²¡æœ‰èº«ä»½è®¤è¯ | é‡å®šå‘åˆ°ç™»å½•é¡µ | `302` |
| **æƒé™ä¸è¶³** | å·²ç™»å½•ä½†æƒé™ä¸å¤Ÿ | æ˜¾ç¤ºæƒé™ä¸è¶³é¡µé¢ | `403` |

### 8.2 æƒé™ä¸è¶³çš„å¤„ç†ç­–ç•¥


**ğŸ¯ ä¸åŒçš„å¤„ç†ç­–ç•¥**

```
1. å‹å¥½æç¤ºç­–ç•¥ï¼š
   æ˜¾ç¤º"æƒé™ä¸è¶³"é¡µé¢ï¼Œå‘Šè¯‰ç”¨æˆ·å¦‚ä½•è·å¾—æƒé™

2. é™é»˜å¤„ç†ç­–ç•¥ï¼š
   éšè—ç”¨æˆ·çœ‹ä¸åˆ°çš„åŠŸèƒ½ï¼Œé¿å…æƒé™ä¸è¶³çš„æƒ…å†µ

3. é™çº§æœåŠ¡ç­–ç•¥ï¼š
   æä¾›åŸºç¡€ç‰ˆæœ¬çš„åŠŸèƒ½ï¼Œå¼•å¯¼ç”¨æˆ·å‡çº§æƒé™
```

### 8.3 æƒé™ä¸è¶³å¤„ç†è¿‡æ»¤å™¨


```java
@WebFilter(urlPatterns = "/*")
public class PermissionDeniedFilter implements Filter {
    
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, 
                        FilterChain chain) throws IOException, ServletException {
        
        HttpServletRequest req = (HttpServletRequest) request;
        HttpServletResponse resp = (HttpServletResponse) response;
        
        // å…ˆæ£€æŸ¥æ˜¯å¦ç™»å½•
        User currentUser = getCurrentUser(req);
        if (currentUser == null) {
            resp.sendRedirect("/login");
            return;
        }
        
        String requestPath = req.getRequestURI();
        
        // æ£€æŸ¥æƒé™
        if (!hasPermission(currentUser, requestPath)) {
            handlePermissionDenied(req, resp, requestPath, currentUser);
            return;
        }
        
        chain.doFilter(request, response);
    }
    
    /**
     * å¤„ç†æƒé™ä¸è¶³çš„æƒ…å†µ
     */
    private void handlePermissionDenied(HttpServletRequest req, HttpServletResponse resp,
                                      String requestPath, User user) throws IOException {
        
        // è®°å½•è®¿é—®æ—¥å¿—ï¼ˆé‡è¦ï¼ï¼‰
        logUnauthorizedAccess(user, requestPath, req);
        
        if (isAjaxRequest(req)) {
            handleAjaxPermissionDenied(resp, requestPath);
        } else {
            handlePagePermissionDenied(req, resp, requestPath);
        }
    }
    
    /**
     * å¤„ç†Ajaxè¯·æ±‚çš„æƒé™ä¸è¶³
     */
    private void handleAjaxPermissionDenied(HttpServletResponse resp, String requestPath) 
            throws IOException {
        resp.setStatus(403);
        resp.setContentType("application/json;charset=UTF-8");
        
        String message = String.format("æƒé™ä¸è¶³ï¼Œæ— æ³•è®¿é—® %s", requestPath);
        String jsonResponse = String.format(
            "{\"code\":403,\"message\":\"%s\",\"data\":null}", message);
        
        resp.getWriter().write(jsonResponse);
    }
    
    /**
     * å¤„ç†é¡µé¢è¯·æ±‚çš„æƒé™ä¸è¶³
     */
    private void handlePagePermissionDenied(HttpServletRequest req, HttpServletResponse resp,
                                          String requestPath) throws IOException {
        
        // è®¾ç½®é”™è¯¯ä¿¡æ¯
        req.getSession().setAttribute("errorMessage", 
            "æ‚¨æ²¡æœ‰æƒé™è®¿é—®ï¼š" + requestPath);
        req.getSession().setAttribute("suggestedAction", 
            getSuggestedAction(requestPath));
        
        // è·³è½¬åˆ°æƒé™ä¸è¶³é¡µé¢
        resp.sendRedirect("/error/403");
    }
    
    /**
     * è·å–å»ºè®®çš„æ“ä½œ
     */
    private String getSuggestedAction(String requestPath) {
        if (requestPath.startsWith("/admin")) {
            return "è¯·è”ç³»ç®¡ç†å‘˜ç”³è¯·ç®¡ç†å‘˜æƒé™";
        } else if (requestPath.startsWith("/vip")) {
            return "è¯·å‡çº§åˆ°VIPä¼šå‘˜ä»¥ä½¿ç”¨æ­¤åŠŸèƒ½";
        } else {
            return "è¯·è”ç³»å®¢æœäº†è§£å¦‚ä½•è·å¾—ç›¸å…³æƒé™";
        }
    }
    
    /**
     * è®°å½•æœªæˆæƒè®¿é—®æ—¥å¿—
     */
    private void logUnauthorizedAccess(User user, String requestPath, HttpServletRequest req) {
        String logMessage = String.format(
            "æœªæˆæƒè®¿é—® - ç”¨æˆ·: %s, è·¯å¾„: %s, IP: %s, æ—¶é—´: %s",
            user.getUsername(),
            requestPath,
            getClientIP(req),
            new java.util.Date()
        );
        
        // è¿™é‡Œå¯ä»¥å†™å…¥æ—¥å¿—æ–‡ä»¶æˆ–æ•°æ®åº“
        System.out.println("[SECURITY WARNING] " + logMessage);
    }
    
    private String getClientIP(HttpServletRequest req) {
        String ip = req.getHeader("X-Forwarded-For");
        if (ip == null || ip.length() == 0 || "unknown".equalsIgnoreCase(ip)) {
            ip = req.getRemoteAddr();
        }
        return ip;
    }
    
    private User getCurrentUser(HttpServletRequest req) {
        HttpSession session = req.getSession(false);
        return session != null ? (User) session.getAttribute("user") : null;
    }
    
    private boolean isAjaxRequest(HttpServletRequest req) {
        String xhr = req.getHeader("X-Requested-With");
        return "XMLHttpRequest".equals(xhr);
    }
    
    private boolean hasPermission(User user, String path) {
        // è¿™é‡Œå®ç°å…·ä½“çš„æƒé™æ£€æŸ¥é€»è¾‘
        // å¯ä»¥å‚è€ƒå‰é¢è§’è‰²æƒé™æ§åˆ¶çš„å®ç°
        return checkUserPermission(user, path);
    }
}
```

### 8.4 æƒé™ä¸è¶³é¡µé¢è®¾è®¡


åˆ›å»º `/error/403.jsp` é¡µé¢ï¼š

```jsp
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<html>
<head>
    <title>æƒé™ä¸è¶³ - 403</title>
    <style>
        .error-container {
            text-align: center;
            padding: 50px;
        }
        .error-code {
            font-size: 72px;
            color: #ff6b6b;
            margin-bottom: 20px;
        }
        .error-message {
            font-size: 18px;
            color: #666;
            margin-bottom: 30px;
        }
        .suggested-action {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="error-container">
        <div class="error-code">403</div>
        <div class="error-message">
            ${sessionScope.errorMessage}
        </div>
        
        <div class="suggested-action">
            <strong>å»ºè®®ï¼š</strong>${sessionScope.suggestedAction}
        </div>
        
        <div>
            <a href="javascript:history.back()">è¿”å›ä¸Šä¸€é¡µ</a> | 
            <a href="/">å›åˆ°é¦–é¡µ</a> | 
            <a href="/contact">è”ç³»å®¢æœ</a>
        </div>
    </div>
</body>
</html>
```

---

## 9. ğŸš€ å®Œæ•´å®æˆ˜æ¡ˆä¾‹


### 9.1 ç”µå•†ç½‘ç«™æƒé™æ§åˆ¶ç³»ç»Ÿ


**ğŸ“‹ éœ€æ±‚åˆ†æ**

```
ç”¨æˆ·è§’è‰²ï¼š
- æ¸¸å®¢ï¼šåªèƒ½æµè§ˆå•†å“ï¼Œä¸èƒ½ä¸‹å•
- æ™®é€šç”¨æˆ·ï¼šå¯ä»¥ä¸‹å•ã€æŸ¥çœ‹è®¢å•
- VIPç”¨æˆ·ï¼šäº«å—ç‰¹ä»·ã€ä¸“å±å®¢æœ
- ç®¡ç†å‘˜ï¼šå•†å“ç®¡ç†ã€è®¢å•ç®¡ç†ã€ç”¨æˆ·ç®¡ç†
```

### 9.2 ç»Ÿä¸€è®¤è¯æˆæƒè¿‡æ»¤å™¨


```java
@WebFilter(urlPatterns = "/*")
public class UnifiedAuthFilter implements Filter {
    
    private List<String> whiteList;
    private Map<String, String[]> permissionMap;
    
    @Override
    public void init(FilterConfig filterConfig) throws ServletException {
        initWhiteList();
        initPermissionMap();
    }
    
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, 
                        FilterChain chain) throws IOException, ServletException {
        
        HttpServletRequest req = (HttpServletRequest) request;
        HttpServletResponse resp = (HttpServletResponse) response;
        
        String requestPath = req.getRequestURI();
        
        // 1. æ£€æŸ¥ç™½åå•
        if (isInWhiteList(requestPath)) {
            chain.doFilter(request, response);
            return;
        }
        
        // 2. æ£€æŸ¥ç™»å½•çŠ¶æ€
        User currentUser = getCurrentUser(req);
        if (currentUser == null) {
            handleNotLoggedIn(req, resp);
            return;
        }
        
        // 3. æ£€æŸ¥æƒé™
        if (!hasRequiredPermission(currentUser, requestPath)) {
            handlePermissionDenied(req, resp, requestPath);
            return;
        }
        
        // 4. é€šè¿‡æ‰€æœ‰æ£€æŸ¥ï¼Œæ”¾è¡Œè¯·æ±‚
        req.setAttribute("currentUser", currentUser);
        chain.doFilter(request, response);
    }
    
    private void initWhiteList() {
        whiteList = Arrays.asList(
            "/", "/index", "/login", "/register",
            "/product/list", "/product/detail",
            "/static/*", "*.css", "*.js", "*.jpg", "*.png"
        );
    }
    
    private void initPermissionMap() {
        permissionMap = new HashMap<>();
        
        // è®¢å•ç›¸å…³ - éœ€è¦ç™»å½•ç”¨æˆ·
        permissionMap.put("/order/*", new String[]{"USER", "VIP", "ADMIN"});
        permissionMap.put("/cart/*", new String[]{"USER", "VIP", "ADMIN"});
        
        // VIPåŠŸèƒ½
        permissionMap.put("/vip/*", new String[]{"VIP", "ADMIN"});
        permissionMap.put("/special-offer", new String[]{"VIP", "ADMIN"});
        
        // ç®¡ç†åŠŸèƒ½
        permissionMap.put("/admin/*", new String[]{"ADMIN"});
        permissionMap.put("/manage/*", new String[]{"ADMIN"});
    }
    
    // ... å…¶ä»–æ–¹æ³•å®ç°
}
```

### 9.3 ç”¨æˆ·ç™»å½•å¤„ç†


```java
@WebServlet("/login")
public class LoginServlet extends HttpServlet {
    
    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) 
            throws ServletException, IOException {
        
        String username = req.getParameter("username");
        String password = req.getParameter("password");
        String rememberMe = req.getParameter("rememberMe");
        
        try {
            // éªŒè¯ç”¨æˆ·
            User user = validateAndGetUser(username, password);
            
            if (user != null) {
                // ç™»å½•æˆåŠŸ
                handleLoginSuccess(req, resp, user, "true".equals(rememberMe));
            } else {
                // ç™»å½•å¤±è´¥
                handleLoginFailure(req, resp, "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
            }
            
        } catch (Exception e) {
            handleLoginFailure(req, resp, "ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•");
        }
    }
    
    /**
     * å¤„ç†ç™»å½•æˆåŠŸ
     */
    private void handleLoginSuccess(HttpServletRequest req, HttpServletResponse resp,
                                  User user, boolean rememberMe) throws IOException {
        
        // åˆ›å»ºSession
        HttpSession session = req.getSession();
        session.setAttribute("user", user);
        session.setAttribute("loginTime", new Date());
        
        // è®¾ç½®Sessionè¶…æ—¶æ—¶é—´
        if (rememberMe) {
            session.setMaxInactiveInterval(7 * 24 * 60 * 60); // 7å¤©
        } else {
            session.setMaxInactiveInterval(2 * 60 * 60); // 2å°æ—¶
        }
        
        // è®°å½•ç™»å½•æ—¥å¿—
        logUserLogin(user, req);
        
        // é‡å®šå‘åˆ°åŸæ¥æƒ³è®¿é—®çš„é¡µé¢
        String redirectUrl = (String) session.getAttribute("redirectAfterLogin");
        if (redirectUrl != null) {
            session.removeAttribute("redirectAfterLogin");
            resp.sendRedirect(redirectUrl);
        } else {
            resp.sendRedirect(getDefaultPageByRole(user.getRole()));
        }
    }
    
    /**
     * æ ¹æ®ç”¨æˆ·è§’è‰²è¿”å›é»˜è®¤é¡µé¢
     */
    private String getDefaultPageByRole(UserRole role) {
        switch (role) {
            case ADMIN:
                return "/admin/dashboard";
            case VIP:
                return "/vip/center";
            default:
                return "/user/center";
        }
    }
    
    private void logUserLogin(User user, HttpServletRequest req) {
        String logMessage = String.format(
            "ç”¨æˆ·ç™»å½• - ç”¨æˆ·å: %s, IP: %s, æ—¶é—´: %s",
            user.getUsername(),
            req.getRemoteAddr(),
            new Date()
        );
        // è®°å½•åˆ°æ—¥å¿—æ–‡ä»¶æˆ–æ•°æ®åº“
        System.out.println("[LOGIN] " + logMessage);
    }
}
```

### 9.4 é…ç½®æ–‡ä»¶ç¤ºä¾‹


`web.xml` é…ç½®ï¼š
```xml
<?xml version="1.0" encoding="UTF-8"?>
<web-app xmlns="http://java.sun.com/xml/ns/javaee"
         version="3.0">
    
    <!-- è®¾ç½®Sessionè¶…æ—¶æ—¶é—´ï¼ˆ30åˆ†é’Ÿï¼‰ -->
    <session-config>
        <session-timeout>30</session-timeout>
    </session-config>
    
    <!-- é”™è¯¯é¡µé¢é…ç½® -->
    <error-page>
        <error-code>403</error-code>
        <location>/error/403.jsp</location>
    </error-page>
    
    <error-page>
        <error-code>404</error-code>
        <location>/error/404.jsp</location>
    </error-page>
    
</web-app>
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ è®¤è¯ä¸æˆæƒï¼šè®¤è¯ç¡®è®¤èº«ä»½ï¼Œæˆæƒç¡®è®¤æƒé™
ğŸ”¸ ç™»å½•çŠ¶æ€æ£€æŸ¥ï¼šé€šè¿‡Sessionæˆ–Tokenåˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç™»å½•
ğŸ”¸ ç™½åå•æœºåˆ¶ï¼šæ— éœ€è®¤è¯å°±èƒ½è®¿é—®çš„é¡µé¢è·¯å¾„é…ç½®
ğŸ”¸ è§’è‰²æƒé™æ§åˆ¶ï¼šä¸åŒè§’è‰²æ‹¥æœ‰ä¸åŒçš„è®¿é—®æƒé™
ğŸ”¸ é‡å®šå‘å¤„ç†ï¼šæœªç™»å½•ç”¨æˆ·çš„è·³è½¬å’Œå›è·³é€»è¾‘
ğŸ”¸ æƒé™ä¸è¶³å¤„ç†ï¼šå·²ç™»å½•ä½†æƒé™ä¸å¤Ÿçš„å‹å¥½æç¤º
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ è¿‡æ»¤å™¨çš„ä¼˜åŠ¿**
```
ç»Ÿä¸€å¤„ç†ï¼š
- æ‰€æœ‰è¯·æ±‚éƒ½ç»è¿‡è¿‡æ»¤å™¨ï¼Œé¿å…é—æ¼
- è®¤è¯æˆæƒé€»è¾‘é›†ä¸­ç®¡ç†ï¼Œä¾¿äºç»´æŠ¤

çµæ´»é…ç½®ï¼š
- å¯ä»¥çµæ´»é…ç½®ç™½åå•å’Œæƒé™è§„åˆ™
- æ”¯æŒå¤šç§éªŒè¯æ–¹å¼ï¼ˆSessionã€Tokenç­‰ï¼‰

æ€§èƒ½å‹å¥½ï¼š
- åœ¨è¯·æ±‚æ—©æœŸå°±è¿›è¡Œè¿‡æ»¤ï¼Œé¿å…æ— æ•ˆå¤„ç†
- å¯ä»¥é…åˆç¼“å­˜æé«˜éªŒè¯æ•ˆç‡
```

**ğŸ”¹ å®ç°è¦ç‚¹**
```
å®‰å…¨åŸåˆ™ï¼š
âœ… ç™½åå•æœ€å°åŒ–ï¼Œåªå¼€æ”¾å¿…è¦è·¯å¾„
âœ… æƒé™æ£€æŸ¥è¦å…¨é¢ï¼Œä¸èƒ½æœ‰é—æ¼
âœ… æ•æ„Ÿæ“ä½œè¦è®°å½•æ—¥å¿—
âœ… é”™è¯¯ä¿¡æ¯è¦å‹å¥½ä½†ä¸æ³„éœ²æ•æ„Ÿä¿¡æ¯

ç”¨æˆ·ä½“éªŒï¼š
âœ… ç™»å½•åè¦å›è·³åˆ°åŸé¡µé¢
âœ… æƒé™ä¸è¶³è¦æœ‰å‹å¥½æç¤º
âœ… æ”¯æŒè®°ä½ç™»å½•çŠ¶æ€
âœ… Ajaxè¯·æ±‚è¦è¿”å›åˆé€‚çš„çŠ¶æ€ç 
```

**ğŸ”¹ å¸¸è§åº”ç”¨åœºæ™¯**
- **ç”µå•†ç½‘ç«™**ï¼šæ¸¸å®¢æµè§ˆã€ç”¨æˆ·ä¸‹å•ã€ç®¡ç†å‘˜ç®¡ç†
- **å†…å®¹ç®¡ç†**ï¼šæ¸¸å®¢é˜…è¯»ã€ä¼šå‘˜è¯„è®ºã€ç¼–è¾‘å‘å¸ƒ
- **ä¼ä¸šç³»ç»Ÿ**ï¼šå‘˜å·¥ç™»å½•ã€éƒ¨é—¨æƒé™ã€ç®¡ç†å‘˜é…ç½®
- **åœ¨çº¿æ•™è‚²**ï¼šå…è´¹è¯¾ç¨‹ã€ä»˜è´¹è¯¾ç¨‹ã€æ•™å¸ˆç®¡ç†

### 10.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ’¼ ä¸šåŠ¡ä»·å€¼**
- ä¿æŠ¤ç³»ç»Ÿå®‰å…¨ï¼Œé˜²æ­¢æœªæˆæƒè®¿é—®
- æä¾›ä¸ªæ€§åŒ–æœåŠ¡ï¼Œä¸åŒç”¨æˆ·çœ‹åˆ°ä¸åŒå†…å®¹
- æ”¯æŒä¼šå‘˜ä½“ç³»ï¼Œå®ç°å·®å¼‚åŒ–æœåŠ¡

**ğŸ”§ æŠ€æœ¯ä»·å€¼**
- ç»Ÿä¸€è®¤è¯æˆæƒå¤„ç†ï¼Œä»£ç å¤ç”¨æ€§é«˜
- é™ä½ä¸šåŠ¡ä»£ç å¤æ‚åº¦ï¼Œå…³æ³¨ç‚¹åˆ†ç¦»
- ä¾¿äºæ‰©å±•å’Œç»´æŠ¤ï¼Œæ”¯æŒå¤šç§è®¤è¯æ–¹å¼

**è®°å¿†å£è¯€**ï¼š
```
è¿‡æ»¤å™¨å®ˆé—¨ï¼Œè®¤è¯æˆæƒå…¨
ç™½åå•é…å¥½ï¼Œæƒé™è¦æ£€ä¸¥
ç™»å½•è¦å›è·³ï¼Œæ— æƒå‹å¥½æ˜¾
æ—¥å¿—è¦è®°å½•ï¼Œå®‰å…¨ç¬¬ä¸€å…³
```