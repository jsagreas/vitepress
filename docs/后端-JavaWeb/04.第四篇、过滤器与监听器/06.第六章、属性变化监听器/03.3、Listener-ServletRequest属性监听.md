---
title: 3ã€Listener-ServletRequestå±æ€§ç›‘å¬
---
## ğŸ“š ç›®å½•

1. [ServletRequestå±æ€§ç›‘å¬å™¨æ¦‚è¿°](#1-ServletRequestå±æ€§ç›‘å¬å™¨æ¦‚è¿°)
2. [ServletRequestAttributeListeneræ¥å£è¯¦è§£](#2-ServletRequestAttributeListeneræ¥å£è¯¦è§£)
3. [è¯·æ±‚å±æ€§å˜åŒ–ç›‘å¬æœºåˆ¶](#3-è¯·æ±‚å±æ€§å˜åŒ–ç›‘å¬æœºåˆ¶)
4. [å®é™…å¼€å‘åº”ç”¨åœºæ™¯](#4-å®é™…å¼€å‘åº”ç”¨åœºæ™¯)
5. [æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹](#5-æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ ServletRequestå±æ€§ç›‘å¬å™¨æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯ServletRequestå±æ€§ç›‘å¬å™¨


**é€šä¿—ç†è§£**ï¼šæƒ³è±¡ä¸€ä¸‹ä½ çš„æ‰‹æœºé€šè®¯å½•ï¼Œæ¯å½“ä½ æ·»åŠ ã€ä¿®æ”¹æˆ–åˆ é™¤è”ç³»äººæ—¶ï¼Œç³»ç»Ÿéƒ½ä¼šè®°å½•è¿™äº›å˜åŒ–ã€‚ServletRequestå±æ€§ç›‘å¬å™¨å°±åƒæ˜¯ä¸“é—¨ç›‘æ§"è¯·æ±‚å¯¹è±¡é€šè®¯å½•"çš„ç®¡å®¶ï¼Œæ¯å½“è¯·æ±‚ä¸­çš„å±æ€§å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå®ƒéƒ½ä¼šç«‹å³çŸ¥æ™“å¹¶é‡‡å–ç›¸åº”è¡ŒåŠ¨ã€‚

**æ ¸å¿ƒä½œç”¨**ï¼š
```
è¯·æ±‚å¤„ç†è¿‡ç¨‹ï¼š
ç”¨æˆ·è¯·æ±‚ â†’ Servletå®¹å™¨ â†’ åˆ›å»ºRequestå¯¹è±¡ â†’ å¤„ç†ä¸šåŠ¡é€»è¾‘
             â†“
         å±æ€§ç›‘å¬å™¨æ—¶åˆ»ç›‘æ§ç€Requestå¯¹è±¡ä¸­çš„å±æ€§å˜åŒ–
             â†“
    ä¸€æ—¦å±æ€§å‘ç”Ÿå¢åˆ æ”¹ï¼Œç«‹å³è§¦å‘ç›¸åº”çš„ç›‘å¬æ–¹æ³•
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦ServletRequestå±æ€§ç›‘å¬


**å®é™…åº”ç”¨åœºæ™¯ç†è§£**ï¼š

```
ç”µå•†è´­ç‰©æµç¨‹ç¤ºä¾‹ï¼š
1. ç”¨æˆ·è®¿é—®å•†å“é¡µé¢
   â””â”€â”€ request.setAttribute("viewedProduct", "iPhone15")
   
2. ç”¨æˆ·åŠ å…¥è´­ç‰©è½¦  
   â””â”€â”€ request.setAttribute("cartAction", "add")
   
3. ç”¨æˆ·é€‰æ‹©é…é€æ–¹å¼
   â””â”€â”€ request.setAttribute("delivery", "express")

å±æ€§ç›‘å¬å™¨çš„ä»·å€¼ï¼š
â€¢ å®æ—¶è·Ÿè¸ªç”¨æˆ·æ“ä½œæµç¨‹
â€¢ è®°å½•å…³é”®ä¸šåŠ¡æ•°æ®å˜åŒ–
â€¢ ä¸ºåç»­åˆ†ææä¾›æ•°æ®æ”¯æŒ
â€¢ åŠæ—¶å‘ç°å¼‚å¸¸æ“ä½œ
```

### 1.3 ServletRequestå±æ€§ç›‘å¬å™¨çš„ç‰¹ç‚¹


**ğŸ”¸ ç›‘å¬èŒƒå›´**ï¼š
- **å•æ¬¡è¯·æ±‚ç”Ÿå‘½å‘¨æœŸ**ï¼šåªåœ¨ä¸€æ¬¡HTTPè¯·æ±‚æœŸé—´æœ‰æ•ˆ
- **å±æ€§çº§åˆ«ç›‘æ§**ï¼šç²¾ç¡®åˆ°æ¯ä¸ªå±æ€§çš„å¢åˆ æ”¹æ“ä½œ
- **å®æ—¶å“åº”**ï¼šå±æ€§å˜åŒ–ç«‹å³è§¦å‘ç›‘å¬å™¨

**ğŸ”¸ ä¸å…¶ä»–ç›‘å¬å™¨çš„åŒºåˆ«**ï¼š

| ç›‘å¬å™¨ç±»å‹ | **ç›‘å¬å¯¹è±¡** | **ç”Ÿå‘½å‘¨æœŸ** | **ä¸»è¦ç”¨é€”** |
|-----------|------------|------------|-------------|
| **ServletContextå±æ€§ç›‘å¬** | `åº”ç”¨çº§å±æ€§` | `æ•´ä¸ªåº”ç”¨è¿è¡ŒæœŸ` | `å…¨å±€é…ç½®ç›‘æ§` |
| **HttpSessionå±æ€§ç›‘å¬** | `ä¼šè¯çº§å±æ€§` | `ç”¨æˆ·ä¼šè¯æœŸé—´` | `ç”¨æˆ·çŠ¶æ€è·Ÿè¸ª` |
| **ServletRequestå±æ€§ç›‘å¬** | `è¯·æ±‚çº§å±æ€§` | `å•æ¬¡è¯·æ±‚å¤„ç†` | `è¯·æ±‚æµç¨‹ç›‘æ§` |

---

## 2. ğŸ”§ ServletRequestAttributeListeneræ¥å£è¯¦è§£


### 2.1 æ¥å£å®šä¹‰ä¸æ–¹æ³•


```java
public interface ServletRequestAttributeListener extends EventListener {
    
    // å±æ€§æ·»åŠ æ—¶è§¦å‘
    void attributeAdded(ServletRequestAttributeEvent srae);
    
    // å±æ€§ç§»é™¤æ—¶è§¦å‘  
    void attributeRemoved(ServletRequestAttributeEvent srae);
    
    // å±æ€§æ›¿æ¢æ—¶è§¦å‘
    void attributeReplaced(ServletRequestAttributeEvent srae);
}
```

**æ–¹æ³•è¯¦ç»†è¯´æ˜**ï¼š

**ğŸ”¸ attributeAdded()æ–¹æ³•**
```
è§¦å‘æ—¶æœºï¼šè°ƒç”¨ request.setAttribute(name, value) é¦–æ¬¡è®¾ç½®å±æ€§æ—¶
å…¸å‹åœºæ™¯ï¼š
â€¢ ç”¨æˆ·ç™»å½•åè®¾ç½®ç”¨æˆ·ä¿¡æ¯
â€¢ ä¸šåŠ¡å¤„ç†ä¸­å­˜å‚¨ä¸´æ—¶æ•°æ®
â€¢ è¯·æ±‚è½¬å‘å‰å‡†å¤‡æ•°æ®
```

**ğŸ”¸ attributeRemoved()æ–¹æ³•**
```
è§¦å‘æ—¶æœºï¼šè°ƒç”¨ request.removeAttribute(name) åˆ é™¤å±æ€§æ—¶
å…¸å‹åœºæ™¯ï¼š
â€¢ æ¸…ç†æ•æ„Ÿä¿¡æ¯
â€¢ é‡Šæ”¾å¤§å¯¹è±¡å†…å­˜
â€¢ æ¸…é™¤ä¸´æ—¶æ ‡è®°
```

**ğŸ”¸ attributeReplaced()æ–¹æ³•**
```
è§¦å‘æ—¶æœºï¼šå¯¹å·²å­˜åœ¨çš„å±æ€§å†æ¬¡è°ƒç”¨ setAttribute() æ—¶
å…¸å‹åœºæ™¯ï¼š
â€¢ æ›´æ–°ç”¨æˆ·çŠ¶æ€
â€¢ ä¿®æ­£ä¸šåŠ¡æ•°æ®
â€¢ è¦†ç›–é»˜è®¤é…ç½®
```

### 2.2 ServletRequestAttributeEventäº‹ä»¶å¯¹è±¡


```java
public class ServletRequestAttributeEvent extends ServletRequestEvent {
    
    private String name;        // å±æ€§å
    private Object value;       // å±æ€§å€¼
    
    // è·å–å±æ€§å
    public String getName();
    
    // è·å–å±æ€§å€¼ï¼ˆæ–°å¢æ—¶æ˜¯æ–°å€¼ï¼Œåˆ é™¤/æ›¿æ¢æ—¶æ˜¯æ—§å€¼ï¼‰
    public Object getValue();
    
    // è·å–ServletRequestå¯¹è±¡
    public ServletRequest getServletRequest();
}
```

**é‡è¦ç†è§£**ï¼š`getValue()` æ–¹æ³•è¿”å›çš„å€¼å«ä¹‰ï¼š
- **æ·»åŠ æ—¶**ï¼šè¿”å›æ–°æ·»åŠ çš„å€¼
- **åˆ é™¤æ—¶**ï¼šè¿”å›è¢«åˆ é™¤çš„æ—§å€¼  
- **æ›¿æ¢æ—¶**ï¼šè¿”å›è¢«æ›¿æ¢çš„æ—§å€¼ï¼ˆä¸æ˜¯æ–°å€¼ï¼ï¼‰

### 2.3 åŸºç¡€å®ç°ç¤ºä¾‹


```java
@WebListener
public class RequestAttributeTracker implements ServletRequestAttributeListener {
    
    private static final Logger logger = LoggerFactory.getLogger(RequestAttributeTracker.class);
    
    @Override
    public void attributeAdded(ServletRequestAttributeEvent event) {
        String name = event.getName();
        Object value = event.getValue();
        
        logger.info("è¯·æ±‚å±æ€§æ·»åŠ  - å±æ€§å: {}, å±æ€§å€¼: {}", name, value);
        
        // è®°å½•å…³é”®ä¸šåŠ¡å±æ€§
        if ("currentUser".equals(name)) {
            logger.info("ç”¨æˆ·ä¿¡æ¯å·²è®¾ç½®åˆ°è¯·æ±‚ä¸­: {}", value);
        }
    }
    
    @Override
    public void attributeRemoved(ServletRequestAttributeEvent event) {
        String name = event.getName();
        Object oldValue = event.getValue();
        
        logger.info("è¯·æ±‚å±æ€§åˆ é™¤ - å±æ€§å: {}, åŸå±æ€§å€¼: {}", name, oldValue);
    }
    
    @Override
    public void attributeReplaced(ServletRequestAttributeEvent event) {
        String name = event.getName();
        Object oldValue = event.getValue();
        Object newValue = event.getServletRequest().getAttribute(name);
        
        logger.info("è¯·æ±‚å±æ€§æ›¿æ¢ - å±æ€§å: {}, æ—§å€¼: {}, æ–°å€¼: {}", 
                   name, oldValue, newValue);
    }
}
```

---

## 3. âš¡ è¯·æ±‚å±æ€§å˜åŒ–ç›‘å¬æœºåˆ¶


### 3.1 å±æ€§å˜åŒ–çš„ç”Ÿå‘½å‘¨æœŸ


```
è¯·æ±‚å±æ€§å˜åŒ–å®Œæ•´æµç¨‹ï¼š

HTTPè¯·æ±‚åˆ°è¾¾
    â†“
å®¹å™¨åˆ›å»ºRequestå¯¹è±¡
    â†“
ä¸šåŠ¡ä»£ç æ“ä½œå±æ€§ â”€â”€â†’ ç›‘å¬å™¨å®æ—¶ç›‘æ§
    â†“                    â†“
setAttribute()  â”€â”€â†’ attributeAdded()
    â†“                    â†“
setAttribute()  â”€â”€â†’ attributeReplaced()  
(åŒåå±æ€§)              â†“
    â†“                    â†“
removeAttribute() â”€â”€â†’ attributeRemoved()
    â†“                    â†“
è¯·æ±‚å¤„ç†å®Œæˆ â”€â”€â†’ ç›‘å¬å™¨ç”Ÿå‘½å‘¨æœŸç»“æŸ
```

### 3.2 è¯·æ±‚æ•°æ®æµè½¬ç›‘æ§å®ç°


```java
@WebListener
public class RequestDataFlowMonitor implements ServletRequestAttributeListener {
    
    // ä½¿ç”¨ThreadLocalå­˜å‚¨æ¯ä¸ªè¯·æ±‚çš„æ•°æ®æµè½¬è®°å½•
    private static final ThreadLocal<List<String>> dataFlowRecord = new ThreadLocal<>();
    
    @Override
    public void attributeAdded(ServletRequestAttributeEvent event) {
        recordDataFlow("ADD", event);
        
        // ç‰¹æ®Šå±æ€§å¤„ç†
        String attributeName = event.getName();
        if ("userPermissions".equals(attributeName)) {
            // æƒé™ä¿¡æ¯è®¾ç½®æ—¶çš„ç‰¹æ®Šå¤„ç†
            validatePermissions(event.getValue());
        }
    }
    
    @Override
    public void attributeReplaced(ServletRequestAttributeEvent event) {
        recordDataFlow("UPDATE", event);
        
        // ç›‘æ§æ•æ„Ÿæ•°æ®å˜æ›´
        if (isSensitiveAttribute(event.getName())) {
            auditSensitiveDataChange(event);
        }
    }
    
    @Override
    public void attributeRemoved(ServletRequestAttributeEvent event) {
        recordDataFlow("REMOVE", event);
    }
    
    // è®°å½•æ•°æ®æµè½¬
    private void recordDataFlow(String operation, ServletRequestAttributeEvent event) {
        List<String> records = dataFlowRecord.get();
        if (records == null) {
            records = new ArrayList<>();
            dataFlowRecord.set(records);
        }
        
        String record = String.format("[%s] %s: %s", 
            operation, 
            event.getName(), 
            getValueSummary(event.getValue())
        );
        records.add(record);
    }
    
    // è·å–å±æ€§å€¼æ‘˜è¦ï¼ˆé¿å…æ•æ„Ÿä¿¡æ¯æ³„éœ²ï¼‰
    private String getValueSummary(Object value) {
        if (value == null) return "null";
        
        String className = value.getClass().getSimpleName();
        if (value instanceof String && ((String) value).length() > 50) {
            return className + "(é•¿åº¦: " + ((String) value).length() + ")";
        }
        return className + ": " + String.valueOf(value);
    }
    
    // åˆ¤æ–­æ˜¯å¦ä¸ºæ•æ„Ÿå±æ€§
    private boolean isSensitiveAttribute(String name) {
        return name.contains("password") || 
               name.contains("token") || 
               name.contains("secret");
    }
}
```

### 3.3 å±æ€§ä¼ é€’è·Ÿè¸ªæœºåˆ¶


**è½¬å‘è¿‡ç¨‹ä¸­çš„å±æ€§è·Ÿè¸ª**ï¼š

```
è¯·æ±‚è½¬å‘æµç¨‹ä¸­çš„å±æ€§ä¼ é€’ï¼š

åŸå§‹è¯·æ±‚
    â†“
Servlet A è®¾ç½®å±æ€§
    â†“
request.setAttribute("processStep", "validation")  â† ç›‘å¬å™¨è®°å½•
    â†“
è½¬å‘åˆ° Servlet B
    â†“
Servlet B è¯»å–å¹¶ä¿®æ”¹å±æ€§
    â†“  
request.setAttribute("processStep", "business")    â† ç›‘å¬å™¨è®°å½•æ›¿æ¢
    â†“
è½¬å‘åˆ° JSP
    â†“
JSP ç§»é™¤ä¸´æ—¶å±æ€§
    â†“
request.removeAttribute("tempData")               â† ç›‘å¬å™¨è®°å½•ç§»é™¤
```

```java
@WebListener
public class AttributeTransferTracker implements ServletRequestAttributeListener {
    
    private static final String TRANSFER_CHAIN = "ATTR_TRANSFER_CHAIN";
    
    @Override
    public void attributeAdded(ServletRequestAttributeEvent event) {
        trackTransferChain(event, "ADDED");
    }
    
    @Override
    public void attributeReplaced(ServletRequestAttributeEvent event) {
        trackTransferChain(event, "REPLACED");
    }
    
    private void trackTransferChain(ServletRequestAttributeEvent event, String action) {
        HttpServletRequest request = (HttpServletRequest) event.getServletRequest();
        
        @SuppressWarnings("unchecked")
        Map<String, List<String>> chainMap = (Map<String, List<String>>) 
            request.getAttribute(TRANSFER_CHAIN);
        
        if (chainMap == null) {
            chainMap = new HashMap<>();
            request.setAttribute(TRANSFER_CHAIN, chainMap);
        }
        
        String attributeName = event.getName();
        chainMap.computeIfAbsent(attributeName, k -> new ArrayList<>())
               .add(action + " at " + getCurrentLocation());
    }
    
    private String getCurrentLocation() {
        // é€šè¿‡å †æ ˆè·Ÿè¸ªç¡®å®šå½“å‰æ“ä½œä½ç½®
        StackTraceElement[] stack = Thread.currentThread().getStackTrace();
        for (StackTraceElement element : stack) {
            String className = element.getClassName();
            if (className.contains("servlet") || className.contains("Servlet")) {
                return element.getClassName() + "." + element.getMethodName() 
                       + ":" + element.getLineNumber();
            }
        }
        return "Unknown";
    }
}
```

---

## 4. ğŸš€ å®é™…å¼€å‘åº”ç”¨åœºæ™¯


### 4.1 è°ƒè¯•ä¿¡æ¯æ”¶é›†


**é—®é¢˜åœºæ™¯**ï¼šå¼€å‘è¿‡ç¨‹ä¸­éœ€è¦è¿½è¸ªè¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸­å±æ€§çš„å˜åŒ–æƒ…å†µï¼Œä¾¿äºæ’æŸ¥é—®é¢˜ã€‚

```java
@WebListener
public class DebugAttributeCollector implements ServletRequestAttributeListener {
    
    private static final String DEBUG_INFO_KEY = "DEBUG_ATTRIBUTE_CHANGES";
    private static final Logger logger = LoggerFactory.getLogger(DebugAttributeCollector.class);
    
    @Override
    public void attributeAdded(ServletRequestAttributeEvent event) {
        if (isDebugMode(event.getServletRequest())) {
            collectDebugInfo(event, "ADDED");
        }
    }
    
    @Override
    public void attributeReplaced(ServletRequestAttributeEvent event) {
        if (isDebugMode(event.getServletRequest())) {
            collectDebugInfo(event, "REPLACED");
        }
    }
    
    @Override
    public void attributeRemoved(ServletRequestAttributeEvent event) {
        if (isDebugMode(event.getServletRequest())) {
            collectDebugInfo(event, "REMOVED");
        }
    }
    
    private boolean isDebugMode(ServletRequest request) {
        // æ£€æŸ¥æ˜¯å¦å¯ç”¨è°ƒè¯•æ¨¡å¼
        HttpServletRequest httpRequest = (HttpServletRequest) request;
        return "true".equals(httpRequest.getParameter("debug")) ||
               "development".equals(System.getProperty("app.profile"));
    }
    
    private void collectDebugInfo(ServletRequestAttributeEvent event, String operation) {
        HttpServletRequest request = (HttpServletRequest) event.getServletRequest();
        
        @SuppressWarnings("unchecked")
        List<String> debugInfo = (List<String>) request.getAttribute(DEBUG_INFO_KEY);
        if (debugInfo == null) {
            debugInfo = new ArrayList<>();
            request.setAttribute(DEBUG_INFO_KEY, debugInfo);
        }
        
        String info = String.format("[%s] %s - %s: %s (æ—¶é—´: %s)", 
            operation,
            request.getRequestURI(),
            event.getName(),
            getValueDescription(event.getValue()),
            new Date()
        );
        
        debugInfo.add(info);
        logger.debug("å±æ€§å˜åŒ–: {}", info);
    }
    
    private String getValueDescription(Object value) {
        if (value == null) return "null";
        return value.getClass().getSimpleName() + " - " + String.valueOf(value);
    }
}
```

### 4.2 ä¸´æ—¶æ•°æ®ç®¡ç†


**åº”ç”¨åœºæ™¯**ï¼šç®¡ç†è¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸­çš„ä¸´æ—¶æ•°æ®ï¼Œç¡®ä¿åŠæ—¶æ¸…ç†ï¼Œé¿å…å†…å­˜æ³„æ¼ã€‚

```java
@WebListener
public class TempDataManager implements ServletRequestAttributeListener {
    
    private static final Set<String> TEMP_ATTRIBUTE_PATTERNS = Set.of(
        "temp_", "tmp_", "cache_", "_internal"
    );
    
    // è®°å½•ä¸´æ—¶æ•°æ®çš„åˆ›å»ºæ—¶é—´
    private static final String TEMP_DATA_TIMESTAMPS = "TEMP_DATA_TIMESTAMPS";
    
    @Override
    public void attributeAdded(ServletRequestAttributeEvent event) {
        String attributeName = event.getName();
        
        if (isTempAttribute(attributeName)) {
            recordTempDataCreation(event);
            scheduleCleanup(event);
        }
    }
    
    @Override
    public void attributeRemoved(ServletRequestAttributeEvent event) {
        String attributeName = event.getName();
        
        if (isTempAttribute(attributeName)) {
            logger.debug("ä¸´æ—¶æ•°æ®å·²æ¸…ç†: {}", attributeName);
        }
    }
    
    private boolean isTempAttribute(String attributeName) {
        return TEMP_ATTRIBUTE_PATTERNS.stream()
                .anyMatch(attributeName::startsWith);
    }
    
    private void recordTempDataCreation(ServletRequestAttributeEvent event) {
        HttpServletRequest request = (HttpServletRequest) event.getServletRequest();
        
        @SuppressWarnings("unchecked")
        Map<String, Long> timestamps = (Map<String, Long>) 
            request.getAttribute(TEMP_DATA_TIMESTAMPS);
        
        if (timestamps == null) {
            timestamps = new HashMap<>();
            request.setAttribute(TEMP_DATA_TIMESTAMPS, timestamps);
        }
        
        timestamps.put(event.getName(), System.currentTimeMillis());
    }
    
    private void scheduleCleanup(ServletRequestAttributeEvent event) {
        // å®é™…é¡¹ç›®ä¸­å¯ä»¥ä½¿ç”¨å®šæ—¶å™¨æˆ–å…¶ä»–æœºåˆ¶
        HttpServletRequest request = (HttpServletRequest) event.getServletRequest();
        Object value = event.getValue();
        
        // å¦‚æœæ˜¯å¤§å¯¹è±¡ï¼Œè®°å½•è­¦å‘Š
        if (isLargeObject(value)) {
            logger.warn("æ£€æµ‹åˆ°å¤§å‹ä¸´æ—¶å¯¹è±¡: {} - {}", 
                       event.getName(), value.getClass().getName());
        }
    }
    
    private boolean isLargeObject(Object value) {
        // ç®€å•çš„å¤§å¯¹è±¡åˆ¤æ–­é€»è¾‘
        if (value instanceof Collection) {
            return ((Collection<?>) value).size() > 1000;
        }
        if (value instanceof Map) {
            return ((Map<?, ?>) value).size() > 1000;
        }
        return false;
    }
}
```

### 4.3 è¯·æ±‚ä¸Šä¸‹æ–‡ç»´æŠ¤


**åœºæ™¯è¯´æ˜**ï¼šç»´æŠ¤è¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸­çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œä¸ºä¸šåŠ¡é€»è¾‘æä¾›ç¯å¢ƒæ„ŸçŸ¥èƒ½åŠ›ã€‚

```java
@WebListener
public class RequestContextMaintainer implements ServletRequestAttributeListener {
    
    private static final String CONTEXT_INFO = "REQUEST_CONTEXT_INFO";
    
    @Override
    public void attributeAdded(ServletRequestAttributeEvent event) {
        updateContext(event, "ADD");
    }
    
    @Override
    public void attributeReplaced(ServletRequestAttributeEvent event) {
        updateContext(event, "UPDATE");
    }
    
    @Override
    public void attributeRemoved(ServletRequestAttributeEvent event) {
        updateContext(event, "REMOVE");
    }
    
    private void updateContext(ServletRequestAttributeEvent event, String operation) {
        HttpServletRequest request = (HttpServletRequest) event.getServletRequest();
        String attributeName = event.getName();
        
        // æ›´æ–°ä¸Šä¸‹æ–‡çŠ¶æ€
        if ("currentUser".equals(attributeName)) {
            updateUserContext(request, event.getValue(), operation);
        } else if ("businessProcess".equals(attributeName)) {
            updateProcessContext(request, event.getValue(), operation);
        } else if (attributeName.startsWith("security_")) {
            updateSecurityContext(request, attributeName, event.getValue(), operation);
        }
    }
    
    private void updateUserContext(HttpServletRequest request, Object userValue, String operation) {
        RequestContextInfo contextInfo = getOrCreateContextInfo(request);
        
        if ("ADD".equals(operation) || "UPDATE".equals(operation)) {
            contextInfo.setUserPresent(userValue != null);
            contextInfo.setLastUserUpdate(System.currentTimeMillis());
        } else if ("REMOVE".equals(operation)) {
            contextInfo.setUserPresent(false);
        }
    }
    
    private void updateProcessContext(HttpServletRequest request, Object processValue, String operation) {
        RequestContextInfo contextInfo = getOrCreateContextInfo(request);
        
        if ("ADD".equals(operation) || "UPDATE".equals(operation)) {
            contextInfo.setCurrentProcess(String.valueOf(processValue));
        }
    }
    
    private void updateSecurityContext(HttpServletRequest request, String attributeName, 
                                     Object value, String operation) {
        RequestContextInfo contextInfo = getOrCreateContextInfo(request);
        contextInfo.getSecurityAttributes().put(attributeName, 
            "REMOVE".equals(operation) ? null : String.valueOf(value));
    }
    
    private RequestContextInfo getOrCreateContextInfo(HttpServletRequest request) {
        RequestContextInfo contextInfo = (RequestContextInfo) request.getAttribute(CONTEXT_INFO);
        if (contextInfo == null) {
            contextInfo = new RequestContextInfo();
            request.setAttribute(CONTEXT_INFO, contextInfo);
        }
        return contextInfo;
    }
    
    // ä¸Šä¸‹æ–‡ä¿¡æ¯ç±»
    public static class RequestContextInfo {
        private boolean userPresent;
        private long lastUserUpdate;
        private String currentProcess;
        private Map<String, String> securityAttributes = new HashMap<>();
        
        // getter/setter æ–¹æ³•çœç•¥...
        
        public boolean isUserPresent() { return userPresent; }
        public void setUserPresent(boolean userPresent) { this.userPresent = userPresent; }
        public String getCurrentProcess() { return currentProcess; }
        public void setCurrentProcess(String currentProcess) { this.currentProcess = currentProcess; }
        public Map<String, String> getSecurityAttributes() { return securityAttributes; }
        public long getLastUserUpdate() { return lastUserUpdate; }
        public void setLastUserUpdate(long lastUserUpdate) { this.lastUserUpdate = lastUserUpdate; }
    }
}
```

---

## 5. â­ æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹


### 5.1 æ€§èƒ½è€ƒè™‘


**ğŸ”¸ é¿å…è¿‡åº¦ç›‘å¬**
```java
// âŒ é”™è¯¯åšæ³•ï¼šç›‘å¬æ‰€æœ‰å±æ€§å˜åŒ–
@Override
public void attributeAdded(ServletRequestAttributeEvent event) {
    // å¯¹æ‰€æœ‰å±æ€§éƒ½è¿›è¡Œå¤æ‚å¤„ç†
    doComplexProcessing(event);
}

// âœ… æ­£ç¡®åšæ³•ï¼šæœ‰é€‰æ‹©æ€§åœ°ç›‘å¬
@Override
public void attributeAdded(ServletRequestAttributeEvent event) {
    String name = event.getName();
    
    // åªå¤„ç†å…³å¿ƒçš„å±æ€§
    if (MONITORED_ATTRIBUTES.contains(name)) {
        doComplexProcessing(event);
    }
}

private static final Set<String> MONITORED_ATTRIBUTES = Set.of(
    "currentUser", "businessProcess", "errorFlag"
);
```

**ğŸ”¸ é¿å…åœ¨ç›‘å¬å™¨ä¸­è¿›è¡Œé‡æ“ä½œ**
```java
// âŒ é”™è¯¯ï¼šåœ¨ç›‘å¬å™¨ä¸­æ‰§è¡Œè€—æ—¶æ“ä½œ
@Override
public void attributeAdded(ServletRequestAttributeEvent event) {
    // æ•°æ®åº“æ“ä½œï¼ˆè€—æ—¶ï¼‰
    saveToDatabase(event);
    
    // ç½‘ç»œè¯·æ±‚ï¼ˆè€—æ—¶ï¼‰
    sendNotification(event);
}

// âœ… æ­£ç¡®ï¼šå¼‚æ­¥å¤„ç†æˆ–ç®€å•è®°å½•
@Override
public void attributeAdded(ServletRequestAttributeEvent event) {
    // ç®€å•è®°å½•
    logger.info("å±æ€§æ·»åŠ : {}", event.getName());
    
    // å¼‚æ­¥å¤„ç†è€—æ—¶æ“ä½œ
    if (needsAsyncProcessing(event)) {
        executor.submit(() -> handleAsync(event));
    }
}
```

### 5.2 å†…å­˜ç®¡ç†


**ğŸ”¸ é¿å…å†…å­˜æ³„æ¼**
```java
@WebListener
public class MemoryAwareRequestListener implements ServletRequestAttributeListener {
    
    // ä½¿ç”¨ThreadLocalæ—¶è®°å¾—æ¸…ç†
    private static final ThreadLocal<Map<String, Object>> requestData = new ThreadLocal<>();
    
    @Override
    public void attributeAdded(ServletRequestAttributeEvent event) {
        // å¤„ç†é€»è¾‘...
    }
    
    // åœ¨è¯·æ±‚ç»“æŸæ—¶æ¸…ç†ThreadLocal
    public static void cleanup() {
        requestData.remove(); // é‡è¦ï¼é¿å…å†…å­˜æ³„æ¼
    }
}

// åœ¨Filteræˆ–å…¶ä»–åœ°æ–¹ç¡®ä¿æ¸…ç†
@WebFilter("/*")
public class CleanupFilter implements Filter {
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, 
                        FilterChain chain) throws IOException, ServletException {
        try {
            chain.doFilter(request, response);
        } finally {
            MemoryAwareRequestListener.cleanup();
        }
    }
}
```

### 5.3 çº¿ç¨‹å®‰å…¨


**é‡è¦æé†’**ï¼šServletRequestå±æ€§ç›‘å¬å™¨åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹éœ€è¦æ³¨æ„çº¿ç¨‹å®‰å…¨ï¼

```java
@WebListener
public class ThreadSafeRequestListener implements ServletRequestAttributeListener {
    
    // âŒ é”™è¯¯ï¼šå…±äº«çŠ¶æ€å¯èƒ½å¯¼è‡´çº¿ç¨‹å®‰å…¨é—®é¢˜
    private Map<String, Object> sharedData = new HashMap<>();
    
    // âœ… æ­£ç¡®ï¼šä½¿ç”¨ThreadLocalæˆ–åœ¨requestä¸­å­˜å‚¨çŠ¶æ€
    @Override
    public void attributeAdded(ServletRequestAttributeEvent event) {
        // æ–¹æ¡ˆ1ï¼šä½¿ç”¨ThreadLocal
        ThreadLocal<Map<String, Object>> threadLocalData = new ThreadLocal<>();
        
        // æ–¹æ¡ˆ2ï¼šå°†çŠ¶æ€å­˜å‚¨åœ¨requestä¸­
        HttpServletRequest request = (HttpServletRequest) event.getServletRequest();
        @SuppressWarnings("unchecked")
        Map<String, Object> requestData = (Map<String, Object>) 
            request.getAttribute("LISTENER_DATA");
        
        if (requestData == null) {
            requestData = new HashMap<>();
            request.setAttribute("LISTENER_DATA", requestData);
        }
    }
}
```

### 5.4 è°ƒè¯•ä¸æ’é”™


**ğŸ”¸ ç›‘å¬å™¨å¼‚å¸¸å¤„ç†**
```java
@Override
public void attributeAdded(ServletRequestAttributeEvent event) {
    try {
        // ç›‘å¬å™¨å¤„ç†é€»è¾‘
        handleAttributeAdded(event);
    } catch (Exception e) {
        // ç›‘å¬å™¨å¼‚å¸¸ä¸åº”è¯¥å½±å“æ­£å¸¸ä¸šåŠ¡æµç¨‹
        logger.error("å±æ€§ç›‘å¬å™¨å¤„ç†å¼‚å¸¸: " + event.getName(), e);
        
        // å¯ä»¥é€‰æ‹©å°†å¼‚å¸¸ä¿¡æ¯è®°å½•åˆ°requestä¸­ä¾›åç»­å¤„ç†
        HttpServletRequest request = (HttpServletRequest) event.getServletRequest();
        request.setAttribute("LISTENER_ERROR", e.getMessage());
    }
}
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ ServletRequestå±æ€§ç›‘å¬å™¨ï¼šç›‘æ§å•æ¬¡è¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸­å±æ€§çš„å˜åŒ–
ğŸ”¸ ä¸‰ä¸ªæ ¸å¿ƒæ–¹æ³•ï¼šattributeAddedã€attributeReplacedã€attributeRemoved
ğŸ”¸ ç›‘å¬èŒƒå›´ï¼šä»…é™äºå½“å‰è¯·æ±‚çš„ç”Ÿå‘½å‘¨æœŸ
ğŸ”¸ äº‹ä»¶å¯¹è±¡ï¼šServletRequestAttributeEventåŒ…å«å±æ€§åå’Œå±æ€§å€¼ä¿¡æ¯
ğŸ”¸ å®é™…åº”ç”¨ï¼šè°ƒè¯•ä¿¡æ¯æ”¶é›†ã€ä¸´æ—¶æ•°æ®ç®¡ç†ã€è¯·æ±‚ä¸Šä¸‹æ–‡ç»´æŠ¤
```

### 6.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ç”Ÿå‘½å‘¨æœŸç†è§£**
```
Requestå¯¹è±¡åˆ›å»º â†’ å±æ€§æ“ä½œå¼€å§‹ â†’ ç›‘å¬å™¨æ¿€æ´»
     â†“               â†“            â†“
è¯·æ±‚å¤„ç†å®Œæˆ â† å±æ€§æ“ä½œç»“æŸ â† ç›‘å¬å™¨ç»“æŸ
```

**ğŸ”¹ ä¸å…¶ä»–ç›‘å¬å™¨çš„é…åˆ**
```
ServletContextç›‘å¬å™¨ï¼šåº”ç”¨çº§åˆ«ï¼Œå…¨å±€é…ç½®
HttpSessionç›‘å¬å™¨ï¼šä¼šè¯çº§åˆ«ï¼Œç”¨æˆ·çŠ¶æ€  
ServletRequestç›‘å¬å™¨ï¼šè¯·æ±‚çº§åˆ«ï¼Œå¤„ç†æµç¨‹ â† å½“å‰å­¦ä¹ å†…å®¹
```

**ğŸ”¹ å®é™…ä»·å€¼ä½“ç°**
```
å¼€å‘é˜¶æ®µï¼šè°ƒè¯•ä¿¡æ¯æ”¶é›†ï¼Œé—®é¢˜æ’æŸ¥
æµ‹è¯•é˜¶æ®µï¼šæ•°æ®æµè½¬è·Ÿè¸ªï¼ŒçŠ¶æ€éªŒè¯
ç”Ÿäº§é˜¶æ®µï¼šæ€§èƒ½ç›‘æ§ï¼Œå¼‚å¸¸é¢„è­¦
```

### 6.3 æœ€ä½³å®è·µè¦ç‚¹


**âœ… æ¨èåšæ³•**ï¼š
- æœ‰é€‰æ‹©æ€§åœ°ç›‘å¬å…³é”®å±æ€§ï¼Œé¿å…æ€§èƒ½å½±å“
- åœ¨ç›‘å¬å™¨ä¸­è¿›è¡Œè½»é‡çº§æ“ä½œï¼Œé‡æ“ä½œå¼‚æ­¥å¤„ç†
- åˆç†ä½¿ç”¨ThreadLocalï¼Œå¹¶ç¡®ä¿åŠæ—¶æ¸…ç†
- åšå¥½å¼‚å¸¸å¤„ç†ï¼Œé¿å…å½±å“æ­£å¸¸ä¸šåŠ¡æµç¨‹

**âŒ é¿å…è¯¯åŒº**ï¼š
- ä¸è¦åœ¨ç›‘å¬å™¨ä¸­æ‰§è¡Œæ•°æ®åº“æ“ä½œç­‰è€—æ—¶ä»»åŠ¡
- ä¸è¦å¿½ç•¥çº¿ç¨‹å®‰å…¨é—®é¢˜
- ä¸è¦è¿‡åº¦ä¾èµ–ç›‘å¬å™¨å®ç°ä¸šåŠ¡é€»è¾‘
- ä¸è¦å¿˜è®°getValue()æ–¹æ³•åœ¨ä¸åŒæ“ä½œä¸­çš„å«ä¹‰å·®å¼‚

**ğŸ’¡ è®°å¿†è¦ç‚¹**ï¼š
- **Requestå±æ€§ç›‘å¬**ï¼šä¸“æ³¨å•æ¬¡è¯·æ±‚ï¼Œç²¾ç¡®åˆ°å±æ€§çº§åˆ«
- **ä¸‰ç§æ“ä½œç›‘å¬**ï¼šæ·»åŠ ã€æ›¿æ¢ã€ç§»é™¤ï¼Œå„æœ‰ä¸“é—¨çš„å¤„ç†æ–¹æ³•  
- **å®é™…åº”ç”¨å¯¼å‘**ï¼šè°ƒè¯•ã€ç›‘æ§ã€æ•°æ®ç®¡ç†æ˜¯ä¸»è¦åº”ç”¨åœºæ™¯
- **æ€§èƒ½å’Œå®‰å…¨**ï¼šè½»é‡çº§å¤„ç†ï¼Œçº¿ç¨‹å®‰å…¨ï¼Œå¼‚å¸¸éš”ç¦»

**æ ¸å¿ƒç†è§£**ï¼šServletRequestå±æ€§ç›‘å¬å™¨æ˜¯JavaWebä¸­ç”¨äºç›‘æ§è¯·æ±‚å¤„ç†è¿‡ç¨‹çš„é‡è¦å·¥å…·ï¼Œå®ƒè®©æˆ‘ä»¬èƒ½å¤Ÿå®æ—¶æ„ŸçŸ¥è¯·æ±‚ä¸­æ•°æ®çš„å˜åŒ–ï¼Œä¸ºè°ƒè¯•ã€ç›‘æ§å’Œæ•°æ®ç®¡ç†æä¾›äº†å¼ºå¤§çš„æ”¯æŒã€‚æŒæ¡å®ƒçš„å…³é”®åœ¨äºç†è§£å…¶ç”Ÿå‘½å‘¨æœŸèŒƒå›´å’Œåˆç†çš„åº”ç”¨åœºæ™¯ã€‚