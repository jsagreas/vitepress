---
title: 2ã€Listener-HttpSessionå±æ€§ç›‘å¬
---
## ğŸ“š ç›®å½•

1. [HttpSessionå±æ€§ç›‘å¬åŸºç¡€æ¦‚å¿µ](#1-HttpSessionå±æ€§ç›‘å¬åŸºç¡€æ¦‚å¿µ)
2. [HttpSessionAttributeListeneræ¥å£è¯¦è§£](#2-HttpSessionAttributeListeneræ¥å£è¯¦è§£)
3. [ä¼šè¯å±æ€§å˜åŒ–ç›‘å¬å®æˆ˜](#3-ä¼šè¯å±æ€§å˜åŒ–ç›‘å¬å®æˆ˜)
4. [ç”¨æˆ·çŠ¶æ€åŒæ­¥åº”ç”¨](#4-ç”¨æˆ·çŠ¶æ€åŒæ­¥åº”ç”¨)
5. [è´­ç‰©è½¦çŠ¶æ€ç›‘æ§å®ç°](#5-è´­ç‰©è½¦çŠ¶æ€ç›‘æ§å®ç°)
6. [ç”¨æˆ·è¡Œä¸ºåˆ†æ](#6-ç”¨æˆ·è¡Œä¸ºåˆ†æ)
7. [ä¼šè¯æ•°æ®ä¸€è‡´æ€§ä¿éšœ](#7-ä¼šè¯æ•°æ®ä¸€è‡´æ€§ä¿éšœ)
8. [å±æ€§å®‰å…¨æ£€æŸ¥æœºåˆ¶](#8-å±æ€§å®‰å…¨æ£€æŸ¥æœºåˆ¶)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ HttpSessionå±æ€§ç›‘å¬åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯HttpSessionå±æ€§ç›‘å¬


**é€šä¿—ç†è§£**ï¼šæƒ³è±¡ä¸€ä¸‹ä½ çš„ä¸ªäººå‚¨ç‰©æŸœï¼Œæ¯å½“ä½ å¾€é‡Œé¢æ”¾ä¸œè¥¿ã€å–ä¸œè¥¿æˆ–è€…æ›¿æ¢ä¸œè¥¿æ—¶ï¼Œéƒ½æœ‰ä¸€ä¸ªç®¡ç†å‘˜åœ¨è®°å½•ã€‚HttpSessionå±æ€§ç›‘å¬å°±æ˜¯è¿™ä¸ª"ç®¡ç†å‘˜"ï¼Œä¸“é—¨ç›‘æ§ç”¨æˆ·ä¼šè¯ä¸­æ•°æ®çš„å˜åŒ–ã€‚

```
ç°å®ç”Ÿæ´»ä¸­çš„å‚¨ç‰©æŸœï¼š                    HttpSessionä¸­çš„å±æ€§ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ’ ä¹¦åŒ…         â”‚ â† æ·»åŠ ç‰©å“         â”‚ "user" â†’ ç”¨æˆ·ä¿¡æ¯ â”‚ â† æ·»åŠ å±æ€§
â”‚  ğŸ“± æ‰‹æœº         â”‚ â† æ›¿æ¢ç‰©å“         â”‚ "cart" â†’ è´­ç‰©è½¦   â”‚ â† ä¿®æ”¹å±æ€§  
â”‚  ğŸ’° é’±åŒ…         â”‚ â† ç§»é™¤ç‰©å“         â”‚ "theme" â†’ ä¸»é¢˜    â”‚ â† åˆ é™¤å±æ€§
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    ç®¡ç†å‘˜è®°å½•å˜åŒ–                         ç›‘å¬å™¨è®°å½•å˜åŒ–
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦ç›‘å¬Sessionå±æ€§å˜åŒ–


**å®é™…éœ€æ±‚åœºæ™¯**ï¼š
- ğŸ›’ **è´­ç‰©è½¦ç›‘æ§**ï¼šç”¨æˆ·æ·»åŠ å•†å“æ—¶è®°å½•è¡Œä¸º
- ğŸ‘¤ **ç”¨æˆ·çŠ¶æ€è·Ÿè¸ª**ï¼šç™»å½•çŠ¶æ€å˜åŒ–æ—¶æ›´æ–°æ•°æ®  
- ğŸ“Š **æ•°æ®ç»Ÿè®¡**ï¼šç»Ÿè®¡ç”¨æˆ·åå¥½å’Œä½¿ç”¨ä¹ æƒ¯
- ğŸ”’ **å®‰å…¨å®¡è®¡**ï¼šç›‘æ§æ•æ„Ÿä¿¡æ¯çš„è®¿é—®
- ğŸ”„ **æ•°æ®åŒæ­¥**ï¼šå¤šç³»ç»Ÿé—´ä¿æŒæ•°æ®ä¸€è‡´æ€§

### 1.3 Sessionå±æ€§å˜åŒ–çš„ä¸‰ç§æƒ…å†µ


```
å±æ€§å˜åŒ–ç±»å‹ï¼š

â”Œâ”€ æ·»åŠ å±æ€§ (attributeAdded) â”€â”
â”‚ ä¹‹å‰ï¼šsessionä¸­æ²¡æœ‰è¿™ä¸ªå±æ€§   â”‚
â”‚ ä¹‹åï¼šsessionä¸­æ–°å¢äº†å±æ€§     â”‚
â”‚ ä¾‹å­ï¼šç”¨æˆ·é¦–æ¬¡ç™»å½•            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ æ›¿æ¢å±æ€§ (attributeReplaced) â”€â”  
â”‚ ä¹‹å‰ï¼šsessionä¸­å·²æœ‰è¿™ä¸ªå±æ€§     â”‚
â”‚ ä¹‹åï¼šå±æ€§å€¼è¢«æ–°å€¼æ›¿æ¢          â”‚
â”‚ ä¾‹å­ï¼šç”¨æˆ·ä¿®æ”¹ä¸ªäººä¿¡æ¯          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ ç§»é™¤å±æ€§ (attributeRemoved) â”€â”
â”‚ ä¹‹å‰ï¼šsessionä¸­å­˜åœ¨è¿™ä¸ªå±æ€§     â”‚  
â”‚ ä¹‹åï¼šå±æ€§è¢«åˆ é™¤               â”‚
â”‚ ä¾‹å­ï¼šç”¨æˆ·é€€å‡ºç™»å½•             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸ”§ HttpSessionAttributeListeneræ¥å£è¯¦è§£


### 2.1 æ¥å£æ ¸å¿ƒæ–¹æ³•


HttpSessionAttributeListeneræ¥å£æä¾›äº†ä¸‰ä¸ªæ ¸å¿ƒæ–¹æ³•ï¼Œå¯¹åº”Sessionå±æ€§çš„ä¸‰ç§å˜åŒ–ï¼š

```java
public interface HttpSessionAttributeListener extends EventListener {
    // å½“Sessionä¸­æ·»åŠ æ–°å±æ€§æ—¶è°ƒç”¨
    void attributeAdded(HttpSessionBindingEvent event);
    
    // å½“Sessionä¸­æ›¿æ¢å·²æœ‰å±æ€§æ—¶è°ƒç”¨  
    void attributeReplaced(HttpSessionBindingEvent event);
    
    // å½“Sessionä¸­ç§»é™¤å±æ€§æ—¶è°ƒç”¨
    void attributeRemoved(HttpSessionBindingEvent event);
}
```

### 2.2 HttpSessionBindingEventäº‹ä»¶å¯¹è±¡


**äº‹ä»¶å¯¹è±¡åŒ…å«çš„ä¿¡æ¯**ï¼š

```
HttpSessionBindingEvent åŒ…å«ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”— getSession()             â”‚ â†’ è·å–å‘ç”Ÿå˜åŒ–çš„Sessionå¯¹è±¡
â”‚ ğŸ·ï¸  getName()               â”‚ â†’ è·å–å‘ç”Ÿå˜åŒ–çš„å±æ€§å
â”‚ ğŸ“¦ getValue()               â”‚ â†’ è·å–å±æ€§çš„å€¼  
â”‚ âš¡ getSource()              â”‚ â†’ è·å–äº‹ä»¶æºå¯¹è±¡
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ³¨æ„ï¼šgetValue()æ–¹æ³•åœ¨ä¸åŒäº‹ä»¶ä¸­çš„å«ä¹‰
â€¢ attributeAddedï¼š   è¿”å›æ–°æ·»åŠ çš„å€¼
â€¢ attributeReplacedï¼šè¿”å›è¢«æ›¿æ¢çš„æ—§å€¼  
â€¢ attributeRemovedï¼š  è¿”å›è¢«ç§»é™¤çš„å€¼
```

### 2.3 åŸºç¡€ç›‘å¬å™¨å®ç°


```java
@WebListener
public class SessionAttributeMonitor implements HttpSessionAttributeListener {
    
    @Override
    public void attributeAdded(HttpSessionBindingEvent event) {
        String attributeName = event.getName();
        Object attributeValue = event.getValue();
        HttpSession session = event.getSession();
        
        System.out.println("âœ… Sessionå±æ€§æ·»åŠ :");
        System.out.println("   Session ID: " + session.getId());
        System.out.println("   å±æ€§å: " + attributeName);
        System.out.println("   å±æ€§å€¼: " + attributeValue);
    }
    
    @Override
    public void attributeReplaced(HttpSessionBindingEvent event) {
        String attributeName = event.getName();
        Object oldValue = event.getValue(); // æ³¨æ„ï¼šè¿™æ˜¯æ—§å€¼
        HttpSession session = event.getSession();
        Object newValue = session.getAttribute(attributeName); // è·å–æ–°å€¼
        
        System.out.println("ğŸ”„ Sessionå±æ€§æ›¿æ¢:");
        System.out.println("   Session ID: " + session.getId());
        System.out.println("   å±æ€§å: " + attributeName);
        System.out.println("   æ—§å€¼: " + oldValue);
        System.out.println("   æ–°å€¼: " + newValue);
    }
    
    @Override
    public void attributeRemoved(HttpSessionBindingEvent event) {
        String attributeName = event.getName();
        Object removedValue = event.getValue();
        HttpSession session = event.getSession();
        
        System.out.println("âŒ Sessionå±æ€§ç§»é™¤:");
        System.out.println("   Session ID: " + session.getId());
        System.out.println("   å±æ€§å: " + attributeName);
        System.out.println("   ç§»é™¤çš„å€¼: " + removedValue);
    }
}
```

---

## 3. ğŸª ä¼šè¯å±æ€§å˜åŒ–ç›‘å¬å®æˆ˜


### 3.1 ç”¨æˆ·ç™»å½•çŠ¶æ€ç›‘å¬å™¨


è¿™ä¸ªä¾‹å­å±•ç¤ºå¦‚ä½•ç›‘å¬ç”¨æˆ·çš„ç™»å½•å’Œé€€å‡ºçŠ¶æ€å˜åŒ–ï¼š

```java
@WebListener
public class UserLoginStatusListener implements HttpSessionAttributeListener {
    
    // å†…å­˜ä¸­ç»´æŠ¤åœ¨çº¿ç”¨æˆ·ç»Ÿè®¡ï¼ˆå®é™…é¡¹ç›®ä¸­å¯èƒ½å­˜å‚¨åœ¨æ•°æ®åº“æˆ–Redisï¼‰
    private static final AtomicInteger onlineUserCount = new AtomicInteger(0);
    
    @Override
    public void attributeAdded(HttpSessionBindingEvent event) {
        String attributeName = event.getName();
        
        // ç›‘å¬ç”¨æˆ·ç™»å½•ï¼ˆé€šå¸¸ç™»å½•æ—¶ä¼šè®¾ç½®userå±æ€§ï¼‰
        if ("user".equals(attributeName)) {
            Object userInfo = event.getValue();
            HttpSession session = event.getSession();
            
            // ç”¨æˆ·ä¸Šçº¿ç»Ÿè®¡
            int currentCount = onlineUserCount.incrementAndGet();
            
            System.out.println("ğŸŸ¢ ç”¨æˆ·ä¸Šçº¿é€šçŸ¥:");
            System.out.println("   ç”¨æˆ·ä¿¡æ¯: " + userInfo);
            System.out.println("   Session ID: " + session.getId());
            System.out.println("   å½“å‰åœ¨çº¿ç”¨æˆ·æ•°: " + currentCount);
            
            // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ›´å¤šä¸šåŠ¡é€»è¾‘
            // æ¯”å¦‚ï¼šè®°å½•ç™»å½•æ—¥å¿—ã€æ›´æ–°ç”¨æˆ·æœ€åç™»å½•æ—¶é—´ç­‰
        }
    }
    
    @Override
    public void attributeRemoved(HttpSessionBindingEvent event) {
        String attributeName = event.getName();
        
        // ç›‘å¬ç”¨æˆ·é€€å‡ºï¼ˆé€€å‡ºæ—¶ä¼šç§»é™¤userå±æ€§ï¼‰
        if ("user".equals(attributeName)) {
            Object userInfo = event.getValue();
            HttpSession session = event.getSession();
            
            // ç”¨æˆ·ä¸‹çº¿ç»Ÿè®¡
            int currentCount = onlineUserCount.decrementAndGet();
            
            System.out.println("ğŸ”´ ç”¨æˆ·ä¸‹çº¿é€šçŸ¥:");
            System.out.println("   ç”¨æˆ·ä¿¡æ¯: " + userInfo);
            System.out.println("   Session ID: " + session.getId());  
            System.out.println("   å½“å‰åœ¨çº¿ç”¨æˆ·æ•°: " + currentCount);
        }
    }
    
    @Override
    public void attributeReplaced(HttpSessionBindingEvent event) {
        String attributeName = event.getName();
        
        if ("user".equals(attributeName)) {
            Object oldUserInfo = event.getValue();
            Object newUserInfo = event.getSession().getAttribute(attributeName);
            
            System.out.println("ğŸ”„ ç”¨æˆ·ä¿¡æ¯æ›´æ–°:");
            System.out.println("   åŸç”¨æˆ·ä¿¡æ¯: " + oldUserInfo);
            System.out.println("   æ–°ç”¨æˆ·ä¿¡æ¯: " + newUserInfo);
        }
    }
    
    // æä¾›é™æ€æ–¹æ³•è·å–åœ¨çº¿ç”¨æˆ·æ•°
    public static int getOnlineUserCount() {
        return onlineUserCount.get();
    }
}
```

### 3.2 é…å¥—çš„ç™»å½•Servletç¤ºä¾‹


```java
@WebServlet("/login")
public class LoginServlet extends HttpServlet {
    
    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response) 
            throws ServletException, IOException {
        
        String username = request.getParameter("username");
        String password = request.getParameter("password");
        
        // ç®€å•çš„ç™»å½•éªŒè¯ï¼ˆå®é™…é¡¹ç›®ä¸­éœ€è¦æŸ¥è¯¢æ•°æ®åº“ï¼‰
        if (isValidUser(username, password)) {
            // åˆ›å»ºç”¨æˆ·å¯¹è±¡
            User user = new User(username);
            
            // è®¾ç½®åˆ°Sessionä¸­ - è¿™ä¼šè§¦å‘attributeAddedäº‹ä»¶
            HttpSession session = request.getSession();
            session.setAttribute("user", user);
            
            response.getWriter().println("ç™»å½•æˆåŠŸï¼å½“å‰åœ¨çº¿ç”¨æˆ·: " + 
                UserLoginStatusListener.getOnlineUserCount());
        } else {
            response.getWriter().println("ç™»å½•å¤±è´¥ï¼");
        }
    }
    
    private boolean isValidUser(String username, String password) {
        // ç®€åŒ–çš„éªŒè¯é€»è¾‘
        return username != null && password != null && password.equals("123456");
    }
}
```

---

## 4. ğŸ‘¥ ç”¨æˆ·çŠ¶æ€åŒæ­¥åº”ç”¨


### 4.1 å¤šç³»ç»Ÿç”¨æˆ·çŠ¶æ€åŒæ­¥ç›‘å¬å™¨


åœ¨å¤§å‹é¡¹ç›®ä¸­ï¼Œç»å¸¸éœ€è¦åœ¨å¤šä¸ªå­ç³»ç»Ÿé—´åŒæ­¥ç”¨æˆ·çŠ¶æ€ã€‚ä¸‹é¢å±•ç¤ºå¦‚ä½•ä½¿ç”¨Sessionå±æ€§ç›‘å¬å™¨å®ç°è¿™ä¸ªåŠŸèƒ½ï¼š

```java
@WebListener
public class UserStateSyncListener implements HttpSessionAttributeListener {
    
    // æ¨¡æ‹Ÿå¤–éƒ¨ç³»ç»Ÿæ¥å£ï¼ˆå®é™…ä¸­å¯èƒ½æ˜¯å¾®æœåŠ¡è°ƒç”¨ï¼‰
    private UserSyncService syncService = new UserSyncService();
    
    @Override
    public void attributeAdded(HttpSessionBindingEvent event) {
        if (isUserStateAttribute(event.getName())) {
            syncUserStateToExternalSystems(event, "ADD");
        }
    }
    
    @Override
    public void attributeReplaced(HttpSessionBindingEvent event) {
        if (isUserStateAttribute(event.getName())) {
            syncUserStateToExternalSystems(event, "UPDATE");
        }
    }
    
    @Override
    public void attributeRemoved(HttpSessionBindingEvent event) {
        if (isUserStateAttribute(event.getName())) {
            syncUserStateToExternalSystems(event, "REMOVE");
        }
    }
    
    /**
     * åˆ¤æ–­æ˜¯å¦ä¸ºéœ€è¦åŒæ­¥çš„ç”¨æˆ·çŠ¶æ€å±æ€§
     */
    private boolean isUserStateAttribute(String attributeName) {
        // å®šä¹‰éœ€è¦åŒæ­¥çš„å±æ€§åç§°
        return "user".equals(attributeName) || 
               "userRole".equals(attributeName) || 
               "userPermissions".equals(attributeName);
    }
    
    /**
     * åŒæ­¥ç”¨æˆ·çŠ¶æ€åˆ°å¤–éƒ¨ç³»ç»Ÿ
     */
    private void syncUserStateToExternalSystems(HttpSessionBindingEvent event, String operation) {
        try {
            String sessionId = event.getSession().getId();
            String attributeName = event.getName();
            Object attributeValue = event.getValue();
            
            // æ„å»ºåŒæ­¥æ•°æ®
            UserStateSync syncData = new UserStateSync();
            syncData.setSessionId(sessionId);
            syncData.setAttributeName(attributeName);
            syncData.setOperation(operation);
            
            if ("REMOVE".equals(operation)) {
                syncData.setAttributeValue(attributeValue);
            } else {
                // å¯¹äºADDå’ŒUPDATEï¼Œè·å–å½“å‰å€¼
                syncData.setAttributeValue(event.getSession().getAttribute(attributeName));
            }
            
            // å¼‚æ­¥åŒæ­¥åˆ°å¤–éƒ¨ç³»ç»Ÿï¼ˆé¿å…é˜»å¡å½“å‰è¯·æ±‚ï¼‰
            CompletableFuture.runAsync(() -> {
                syncService.syncUserState(syncData);
            });
            
            System.out.println("ğŸ”„ ç”¨æˆ·çŠ¶æ€åŒæ­¥: " + operation + " - " + attributeName);
            
        } catch (Exception e) {
            System.err.println("âŒ ç”¨æˆ·çŠ¶æ€åŒæ­¥å¤±è´¥: " + e.getMessage());
            // åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œè¿™é‡Œåº”è¯¥è®°å½•é”™è¯¯æ—¥å¿—ï¼Œå¯èƒ½éœ€è¦é‡è¯•æœºåˆ¶
        }
    }
}

// æ•°æ®ä¼ è¾“å¯¹è±¡
class UserStateSync {
    private String sessionId;
    private String attributeName;  
    private Object attributeValue;
    private String operation;
    private long timestamp = System.currentTimeMillis();
    
    // getterå’Œsetteræ–¹æ³•...
}

// æ¨¡æ‹Ÿçš„åŒæ­¥æœåŠ¡
class UserSyncService {
    public void syncUserState(UserStateSync syncData) {
        // æ¨¡æ‹Ÿè°ƒç”¨å¤–éƒ¨ç³»ç»ŸAPI
        System.out.println("ğŸ“¤ åŒæ­¥æ•°æ®åˆ°å¤–éƒ¨ç³»ç»Ÿ: " + syncData.getOperation());
        
        // å®é™…å®ç°ä¸­å¯èƒ½åŒ…æ‹¬ï¼š
        // 1. è°ƒç”¨å…¶ä»–å¾®æœåŠ¡çš„API
        // 2. å‘é€æ¶ˆæ¯åˆ°æ¶ˆæ¯é˜Ÿåˆ—
        // 3. æ›´æ–°ç¼“å­˜ç³»ç»Ÿ(å¦‚Redis)
        // 4. è®°å½•åŒæ­¥æ—¥å¿—
    }
}
```

---

## 5. ğŸ›’ è´­ç‰©è½¦çŠ¶æ€ç›‘æ§å®ç°


### 5.1 è´­ç‰©è½¦ç›‘å¬å™¨


è´­ç‰©è½¦æ˜¯ç”µå•†ç³»ç»Ÿä¸­æœ€å¸¸è§çš„Sessionåº”ç”¨ï¼Œç›‘å¬è´­ç‰©è½¦å˜åŒ–å¯¹ä¸šåŠ¡åˆ†æå¾ˆé‡è¦ï¼š

```java
@WebListener  
public class ShoppingCartListener implements HttpSessionAttributeListener {
    
    @Override
    public void attributeAdded(HttpSessionBindingEvent event) {
        if ("shoppingCart".equals(event.getName())) {
            ShoppingCart cart = (ShoppingCart) event.getValue();
            recordCartActivity(event.getSession().getId(), "CART_CREATED", cart);
        }
    }
    
    @Override
    public void attributeReplaced(HttpSessionBindingEvent event) {
        if ("shoppingCart".equals(event.getName())) {
            ShoppingCart oldCart = (ShoppingCart) event.getValue();
            ShoppingCart newCart = (ShoppingCart) event.getSession().getAttribute("shoppingCart");
            
            // åˆ†æè´­ç‰©è½¦å˜åŒ–
            analyzeCartChanges(event.getSession().getId(), oldCart, newCart);
        }
    }
    
    @Override
    public void attributeRemoved(HttpSessionBindingEvent event) {
        if ("shoppingCart".equals(event.getName())) {
            ShoppingCart cart = (ShoppingCart) event.getValue();
            recordCartActivity(event.getSession().getId(), "CART_ABANDONED", cart);
        }
    }
    
    /**
     * åˆ†æè´­ç‰©è½¦å˜åŒ–è¯¦æƒ…
     */
    private void analyzeCartChanges(String sessionId, ShoppingCart oldCart, ShoppingCart newCart) {
        System.out.println("ğŸ›’ è´­ç‰©è½¦å˜åŒ–åˆ†æ:");
        System.out.println("   Session: " + sessionId);
        System.out.println("   åŸå•†å“æ•°é‡: " + oldCart.getItemCount());
        System.out.println("   æ–°å•†å“æ•°é‡: " + newCart.getItemCount());
        System.out.println("   åŸæ€»é‡‘é¢: Â¥" + oldCart.getTotalAmount());
        System.out.println("   æ–°æ€»é‡‘é¢: Â¥" + newCart.getTotalAmount());
        
        // æ£€æµ‹å…·ä½“çš„å˜åŒ–ç±»å‹
        if (newCart.getItemCount() > oldCart.getItemCount()) {
            System.out.println("   ğŸ“ˆ ç”¨æˆ·æ·»åŠ äº†å•†å“åˆ°è´­ç‰©è½¦");
            recordCartActivity(sessionId, "ITEM_ADDED", newCart);
        } else if (newCart.getItemCount() < oldCart.getItemCount()) {
            System.out.println("   ğŸ“‰ ç”¨æˆ·ä»è´­ç‰©è½¦ç§»é™¤äº†å•†å“");  
            recordCartActivity(sessionId, "ITEM_REMOVED", newCart);
        } else {
            System.out.println("   ğŸ”„ ç”¨æˆ·ä¿®æ”¹äº†å•†å“æ•°é‡");
            recordCartActivity(sessionId, "ITEM_QUANTITY_CHANGED", newCart);
        }
    }
    
    /**
     * è®°å½•è´­ç‰©è½¦æ´»åŠ¨ï¼ˆå®é™…é¡¹ç›®ä¸­å¯èƒ½å­˜å‚¨åˆ°æ•°æ®åº“ï¼‰
     */
    private void recordCartActivity(String sessionId, String activity, ShoppingCart cart) {
        CartActivity record = new CartActivity();
        record.setSessionId(sessionId);
        record.setActivity(activity);  
        record.setItemCount(cart.getItemCount());
        record.setTotalAmount(cart.getTotalAmount());
        record.setTimestamp(new Date());
        
        // å®é™…é¡¹ç›®ä¸­è¿™é‡Œä¼šä¿å­˜åˆ°æ•°æ®åº“
        System.out.println("ğŸ“Š è®°å½•è´­ç‰©è½¦æ´»åŠ¨: " + activity);
        
        // è§¦å‘å®æ—¶åˆ†æ
        triggerRealTimeAnalysis(record);
    }
    
    /**
     * è§¦å‘å®æ—¶åˆ†æå’Œæ¨è
     */
    private void triggerRealTimeAnalysis(CartActivity activity) {
        // å®é™…é¡¹ç›®ä¸­å¯èƒ½åŒ…æ‹¬ï¼š
        // 1. å®æ—¶æ¨èç›¸å…³å•†å“
        // 2. åˆ†æç”¨æˆ·è´­ä¹°æ„å‘
        // 3. è§¦å‘è¥é”€æ´»åŠ¨
        // 4. æ›´æ–°ç”¨æˆ·ç”»åƒ
        
        if ("CART_ABANDONED".equals(activity.getActivity()) && 
            activity.getTotalAmount() > 100) {
            System.out.println("ğŸ¯ æ£€æµ‹åˆ°é«˜ä»·å€¼è´­ç‰©è½¦æ”¾å¼ƒï¼Œè§¦å‘æŒ½å›ç­–ç•¥");
        }
    }
}

// è´­ç‰©è½¦æ•°æ®æ¨¡å‹
class ShoppingCart {
    private List<CartItem> items = new ArrayList<>();
    
    public int getItemCount() {
        return items.stream().mapToInt(CartItem::getQuantity).sum();
    }
    
    public BigDecimal getTotalAmount() {
        return items.stream()
                   .map(item -> item.getPrice().multiply(BigDecimal.valueOf(item.getQuantity())))
                   .reduce(BigDecimal.ZERO, BigDecimal::add);
    }
    
    // å…¶ä»–æ–¹æ³•...
}

class CartItem {
    private String productId;
    private String productName;
    private BigDecimal price;
    private int quantity;
    
    // getterå’Œsetteræ–¹æ³•...
}

// è´­ç‰©è½¦æ´»åŠ¨è®°å½•
class CartActivity {
    private String sessionId;
    private String activity;
    private int itemCount;
    private BigDecimal totalAmount;
    private Date timestamp;
    
    // getterå’Œsetteræ–¹æ³•...
}
```

---

## 6. ğŸ“ˆ ç”¨æˆ·è¡Œä¸ºåˆ†æ


### 6.1 ç”¨æˆ·è¡Œä¸ºè·Ÿè¸ªç›‘å¬å™¨


é€šè¿‡ç›‘å¬Sessionå±æ€§å˜åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥åˆ†æç”¨æˆ·çš„è¡Œä¸ºæ¨¡å¼ï¼š

```java
@WebListener
public class UserBehaviorAnalyzer implements HttpSessionAttributeListener {
    
    // ç”¨æˆ·è¡Œä¸ºæ•°æ®æ”¶é›†å™¨
    private BehaviorCollector behaviorCollector = new BehaviorCollector();
    
    @Override
    public void attributeAdded(HttpSessionBindingEvent event) {
        collectBehaviorData(event, "ADD");
    }
    
    @Override
    public void attributeReplaced(HttpSessionBindingEvent event) {
        collectBehaviorData(event, "UPDATE");  
    }
    
    @Override
    public void attributeRemoved(HttpSessionBindingEvent event) {
        collectBehaviorData(event, "REMOVE");
    }
    
    private void collectBehaviorData(HttpSessionBindingEvent event, String action) {
        String attributeName = event.getName();
        HttpSession session = event.getSession();
        
        // æ”¶é›†ä¸åŒç±»å‹çš„è¡Œä¸ºæ•°æ®
        switch (attributeName) {
            case "searchKeywords":
                handleSearchBehavior(session, event, action);
                break;
            case "viewedProducts":
                handleProductViewBehavior(session, event, action);
                break;
            case "userPreferences":
                handlePreferenceBehavior(session, event, action);
                break;
            case "shoppingCart":
                handleShoppingBehavior(session, event, action);
                break;
        }
    }
    
    /**
     * å¤„ç†æœç´¢è¡Œä¸ºåˆ†æ
     */
    private void handleSearchBehavior(HttpSession session, HttpSessionBindingEvent event, String action) {
        if ("ADD".equals(action) || "UPDATE".equals(action)) {
            @SuppressWarnings("unchecked")
            List<String> keywords = (List<String>) session.getAttribute("searchKeywords");
            
            if (keywords != null && !keywords.isEmpty()) {
                String latestKeyword = keywords.get(keywords.size() - 1);
                
                System.out.println("ğŸ” ç”¨æˆ·æœç´¢è¡Œä¸º:");
                System.out.println("   æœç´¢å…³é”®è¯: " + latestKeyword);
                System.out.println("   æœç´¢å†å²æ•°é‡: " + keywords.size());
                
                // åˆ†ææœç´¢æ„å›¾
                analyzeSearchIntent(session.getId(), latestKeyword, keywords);
            }
        }
    }
    
    /**
     * å¤„ç†å•†å“æµè§ˆè¡Œä¸ºåˆ†æ  
     */
    private void handleProductViewBehavior(HttpSession session, HttpSessionBindingEvent event, String action) {
        @SuppressWarnings("unchecked")
        List<String> viewedProducts = (List<String>) session.getAttribute("viewedProducts");
        
        if (viewedProducts != null) {
            System.out.println("ğŸ‘€ ç”¨æˆ·æµè§ˆè¡Œä¸º:");
            System.out.println("   æµè§ˆå•†å“æ•°é‡: " + viewedProducts.size());
            System.out.println("   æœ€è¿‘æµè§ˆ: " + (viewedProducts.isEmpty() ? "æ— " : 
                viewedProducts.get(viewedProducts.size() - 1)));
                
            // åˆ†ææµè§ˆæ¨¡å¼
            analyzeBrowsingPattern(session.getId(), viewedProducts);
        }
    }
    
    /**
     * åˆ†æç”¨æˆ·æœç´¢æ„å›¾
     */
    private void analyzeSearchIntent(String sessionId, String keyword, List<String> searchHistory) {
        SearchIntent intent = new SearchIntent();
        intent.setSessionId(sessionId);
        intent.setKeyword(keyword);
        intent.setTimestamp(new Date());
        
        // åŸºäºæœç´¢å†å²åˆ†ææ„å›¾å¼ºåº¦
        long recentSearches = searchHistory.stream()
            .filter(k -> k.toLowerCase().contains(keyword.toLowerCase()))
            .count();
            
        if (recentSearches > 3) {
            intent.setIntentLevel("HIGH");
            System.out.println("   ğŸ¯ æ£€æµ‹åˆ°é«˜æ„å›¾æœç´¢ï¼Œæ¨èç²¾å‡†å•†å“");
        } else {
            intent.setIntentLevel("MEDIUM");
        }
        
        // ä¿å­˜åˆ†æç»“æœ
        behaviorCollector.recordSearchIntent(intent);
    }
    
    /**
     * åˆ†æç”¨æˆ·æµè§ˆæ¨¡å¼
     */
    private void analyzeBrowsingPattern(String sessionId, List<String> viewedProducts) {
        if (viewedProducts.size() >= 5) {
            // åˆ†ææµè§ˆç±»åˆ«åå¥½
            Map<String, Long> categoryCount = viewedProducts.stream()
                .collect(Collectors.groupingBy(
                    this::getProductCategory, 
                    Collectors.counting()));
                    
            String preferredCategory = categoryCount.entrySet().stream()
                .max(Map.Entry.comparingByValue())
                .map(Map.Entry::getKey)
                .orElse("æœªçŸ¥");
                
            System.out.println("   ğŸ“Š ç”¨æˆ·åå¥½åˆ†æ: " + preferredCategory + " ç±»å•†å“");
            
            // æ£€æµ‹æ˜¯å¦ä¸ºæ¯”ä»·è¡Œä¸º
            if (viewedProducts.size() > 10) {
                System.out.println("   ğŸ’° æ£€æµ‹åˆ°æ¯”ä»·è¡Œä¸ºï¼Œæ¨èä»·æ ¼ä¼˜åŠ¿å•†å“");
            }
        }
    }
    
    /**
     * ç®€åŒ–çš„å•†å“ç±»åˆ«è·å–ï¼ˆå®é™…ä¸­å¯èƒ½æŸ¥è¯¢æ•°æ®åº“ï¼‰
     */
    private String getProductCategory(String productId) {
        // ç®€åŒ–å®ç°ï¼šæ ¹æ®äº§å“IDå‰ç¼€åˆ¤æ–­ç±»åˆ«
        if (productId.startsWith("ELEC")) return "ç”µå­äº§å“";
        if (productId.startsWith("CLOTH")) return "æœè£…";  
        if (productId.startsWith("BOOK")) return "å›¾ä¹¦";
        return "å…¶ä»–";
    }
}

// æœç´¢æ„å›¾åˆ†æç»“æœ
class SearchIntent {
    private String sessionId;
    private String keyword;
    private String intentLevel;
    private Date timestamp;
    
    // getterå’Œsetteræ–¹æ³•...
}

// è¡Œä¸ºæ•°æ®æ”¶é›†å™¨
class BehaviorCollector {
    public void recordSearchIntent(SearchIntent intent) {
        // å®é™…é¡¹ç›®ä¸­ä¿å­˜åˆ°æ•°æ®åº“æˆ–å‘é€åˆ°åˆ†æç³»ç»Ÿ
        System.out.println("ğŸ“ è®°å½•æœç´¢æ„å›¾: " + intent.getKeyword() + 
                          " (å¼ºåº¦: " + intent.getIntentLevel() + ")");
    }
}
```

---

## 7. ğŸ”„ ä¼šè¯æ•°æ®ä¸€è‡´æ€§ä¿éšœ


### 7.1 æ•°æ®ä¸€è‡´æ€§ç›‘å¬å™¨


åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œä¿è¯Sessionæ•°æ®çš„ä¸€è‡´æ€§å¾ˆé‡è¦ï¼š

```java
@WebListener
public class SessionDataConsistencyListener implements HttpSessionAttributeListener {
    
    // æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥å™¨
    private DataConsistencyChecker checker = new DataConsistencyChecker();
    
    @Override
    public void attributeAdded(HttpSessionBindingEvent event) {
        validateAndSync(event, "ADD");
    }
    
    @Override  
    public void attributeReplaced(HttpSessionBindingEvent event) {
        validateAndSync(event, "UPDATE");
    }
    
    @Override
    public void attributeRemoved(HttpSessionBindingEvent event) {
        validateAndSync(event, "REMOVE");
    }
    
    /**
     * éªŒè¯æ•°æ®å¹¶åŒæ­¥åˆ°ç¼“å­˜ç³»ç»Ÿ
     */
    private void validateAndSync(HttpSessionBindingEvent event, String operation) {
        String attributeName = event.getName();
        HttpSession session = event.getSession();
        
        // åªå¤„ç†éœ€è¦ä¿è¯ä¸€è‡´æ€§çš„å…³é”®å±æ€§
        if (isCriticalAttribute(attributeName)) {
            try {
                // 1. æ•°æ®æœ‰æ•ˆæ€§éªŒè¯
                boolean isValid = validateAttributeData(attributeName, 
                    session.getAttribute(attributeName), operation);
                
                if (!isValid) {
                    System.err.println("âŒ æ•°æ®éªŒè¯å¤±è´¥: " + attributeName);
                    handleDataValidationFailure(session, attributeName);
                    return;
                }
                
                // 2. åŒæ­¥åˆ°å¤–éƒ¨ç¼“å­˜ç³»ç»Ÿ
                syncToCache(session.getId(), attributeName, 
                    session.getAttribute(attributeName), operation);
                
                // 3. è®°å½•ä¸€è‡´æ€§æ—¥å¿—
                logConsistencyOperation(session.getId(), attributeName, operation);
                
                System.out.println("âœ… æ•°æ®ä¸€è‡´æ€§ä¿éšœå®Œæˆ: " + attributeName);
                
            } catch (Exception e) {
                System.err.println("âŒ ä¸€è‡´æ€§ä¿éšœå¼‚å¸¸: " + e.getMessage());
                handleConsistencyException(session, attributeName, e);
            }
        }
    }
    
    /**
     * åˆ¤æ–­æ˜¯å¦ä¸ºéœ€è¦ä¿è¯ä¸€è‡´æ€§çš„å…³é”®å±æ€§
     */
    private boolean isCriticalAttribute(String attributeName) {
        return "user".equals(attributeName) || 
               "shoppingCart".equals(attributeName) ||
               "paymentInfo".equals(attributeName) ||
               "userPermissions".equals(attributeName);
    }
    
    /**
     * éªŒè¯å±æ€§æ•°æ®çš„æœ‰æ•ˆæ€§
     */
    private boolean validateAttributeData(String attributeName, Object value, String operation) {
        if ("REMOVE".equals(operation)) {
            return true; // ç§»é™¤æ“ä½œä¸éœ€è¦éªŒè¯å€¼
        }
        
        switch (attributeName) {
            case "user":
                return validateUserData(value);
            case "shoppingCart":
                return validateCartData(value);
            case "paymentInfo":
                return validatePaymentData(value);
            default:
                return true;
        }
    }
    
    private boolean validateUserData(Object value) {
        if (!(value instanceof User)) return false;
        User user = (User) value;
        return user.getUserId() != null && !user.getUserId().trim().isEmpty();
    }
    
    private boolean validateCartData(Object value) {
        if (!(value instanceof ShoppingCart)) return false;
        ShoppingCart cart = (ShoppingCart) value;
        // éªŒè¯è´­ç‰©è½¦æ•°æ®å®Œæ•´æ€§
        return cart.getTotalAmount().compareTo(BigDecimal.ZERO) >= 0;
    }
    
    private boolean validatePaymentData(Object value) {
        // æ”¯ä»˜ä¿¡æ¯éªŒè¯é€»è¾‘ï¼ˆå®é™…ä¸­ä¼šæ›´å¤æ‚ï¼‰
        return value != null;
    }
    
    /**
     * åŒæ­¥æ•°æ®åˆ°ç¼“å­˜ç³»ç»Ÿ
     */
    private void syncToCache(String sessionId, String attributeName, Object value, String operation) {
        CacheSync syncData = new CacheSync();
        syncData.setSessionId(sessionId);
        syncData.setAttributeName(attributeName);
        syncData.setValue(value);
        syncData.setOperation(operation);
        syncData.setTimestamp(System.currentTimeMillis());
        
        // å¼‚æ­¥åŒæ­¥åˆ°ç¼“å­˜ï¼Œé¿å…é˜»å¡è¯·æ±‚
        CompletableFuture.runAsync(() -> {
            checker.syncToCache(syncData);
        });
    }
    
    /**
     * å¤„ç†æ•°æ®éªŒè¯å¤±è´¥
     */
    private void handleDataValidationFailure(HttpSession session, String attributeName) {
        // æ•°æ®éªŒè¯å¤±è´¥çš„å¤„ç†ç­–ç•¥ï¼š
        // 1. æ¢å¤åˆ°ä¸Šä¸€ä¸ªæœ‰æ•ˆå€¼
        // 2. è®°å½•é”™è¯¯æ—¥å¿—
        // 3. é€šçŸ¥ç›¸å…³ç³»ç»Ÿ
        
        System.out.println("ğŸ”§ å°è¯•æ¢å¤æ•°æ®ä¸€è‡´æ€§: " + attributeName);
        
        // ä»ç¼“å­˜ä¸­æ¢å¤æ•°æ®
        Object cachedValue = checker.getFromCache(session.getId(), attributeName);
        if (cachedValue != null) {
            session.setAttribute(attributeName, cachedValue);
            System.out.println("âœ… æ•°æ®å·²ä»ç¼“å­˜æ¢å¤");
        }
    }
    
    /**
     * å¤„ç†ä¸€è‡´æ€§ä¿éšœå¼‚å¸¸
     */
    private void handleConsistencyException(HttpSession session, String attributeName, Exception e) {
        // è®°å½•è¯¦ç»†çš„å¼‚å¸¸ä¿¡æ¯
        System.err.println("ä¸€è‡´æ€§å¼‚å¸¸è¯¦æƒ…:");
        System.err.println("  Session ID: " + session.getId());
        System.err.println("  å±æ€§å: " + attributeName);
        System.err.println("  å¼‚å¸¸: " + e.getMessage());
        
        // å®é™…é¡¹ç›®ä¸­å¯èƒ½éœ€è¦ï¼š
        // 1. å‘é€å‘Šè­¦é€šçŸ¥
        // 2. è®°å½•åˆ°ç›‘æ§ç³»ç»Ÿ  
        // 3. è§¦å‘è‡ªåŠ¨æ¢å¤æœºåˆ¶
    }
    
    private void logConsistencyOperation(String sessionId, String attributeName, String operation) {
        System.out.println("ğŸ“‹ ä¸€è‡´æ€§æ—¥å¿—: [" + operation + "] " + 
                          sessionId + " -> " + attributeName);
    }
}

// ç¼“å­˜åŒæ­¥æ•°æ®
class CacheSync {
    private String sessionId;
    private String attributeName;
    private Object value;
    private String operation;
    private long timestamp;
    
    // getterå’Œsetteræ–¹æ³•...
}

// æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥å™¨
class DataConsistencyChecker {
    public void syncToCache(CacheSync syncData) {
        // æ¨¡æ‹ŸåŒæ­¥åˆ°Redisç­‰ç¼“å­˜ç³»ç»Ÿ
        System.out.println("ğŸ”„ åŒæ­¥åˆ°ç¼“å­˜: " + syncData.getAttributeName());
    }
    
    public Object getFromCache(String sessionId, String attributeName) {
        // æ¨¡æ‹Ÿä»ç¼“å­˜è·å–æ•°æ®
        System.out.println("ğŸ“¥ ä»ç¼“å­˜è·å–: " + attributeName);
        return null; // å®é™…å®ç°ä¸­ä»ç¼“å­˜ç³»ç»Ÿè·å–
    }
}
```

---

## 8. ğŸ”’ å±æ€§å®‰å…¨æ£€æŸ¥æœºåˆ¶


### 8.1 å®‰å…¨æ£€æŸ¥ç›‘å¬å™¨


å¯¹äºæ•æ„Ÿæ•°æ®ï¼Œéœ€è¦åœ¨Sessionå±æ€§å˜åŒ–æ—¶è¿›è¡Œå®‰å…¨æ£€æŸ¥ï¼š

```java
@WebListener
public class AttributeSecurityListener implements HttpSessionAttributeListener {
    
    private SecurityChecker securityChecker = new SecurityChecker();
    
    @Override
    public void attributeAdded(HttpSessionBindingEvent event) {
        performSecurityCheck(event, "ADD");
    }
    
    @Override
    public void attributeReplaced(HttpSessionBindingEvent event) {
        performSecurityCheck(event, "REPLACE");
    }
    
    @Override
    public void attributeRemoved(HttpSessionBindingEvent event) {
        performSecurityCheck(event, "REMOVE");
    }
    
    /**
     * æ‰§è¡Œå®‰å…¨æ£€æŸ¥
     */
    private void performSecurityCheck(HttpSessionBindingEvent event, String operation) {
        String attributeName = event.getName();
        HttpSession session = event.getSession();
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºæ•æ„Ÿå±æ€§
        if (isSensitiveAttribute(attributeName)) {
            SecurityCheckResult result = securityChecker.checkSecurity(
                session, attributeName, event.getValue(), operation);
                
            if (!result.isSecure()) {
                handleSecurityViolation(session, attributeName, result, operation);
            } else {
                logSecurityEvent(session.getId(), attributeName, operation, "ALLOWED");
            }
        }
    }
    
    /**
     * åˆ¤æ–­æ˜¯å¦ä¸ºæ•æ„Ÿå±æ€§
     */
    private boolean isSensitiveAttribute(String attributeName) {
        // å®šä¹‰æ•æ„Ÿå±æ€§åˆ—è¡¨
        String[] sensitiveAttributes = {
            "user",           // ç”¨æˆ·ä¿¡æ¯
            "paymentInfo",    // æ”¯ä»˜ä¿¡æ¯  
            "creditCard",     // ä¿¡ç”¨å¡ä¿¡æ¯
            "personalData",   // ä¸ªäººæ•°æ®
            "adminRights",    // ç®¡ç†å‘˜æƒé™
            "sessionToken"    // ä¼šè¯ä»¤ç‰Œ
        };
        
        return Arrays.stream(sensitiveAttributes)
                     .anyMatch(attr -> attr.equals(attributeName));
    }
    
    /**
     * å¤„ç†å®‰å…¨è¿è§„
     */
    private void handleSecurityViolation(HttpSession session, String attributeName, 
                                       SecurityCheckResult result, String operation) {
        
        System.err.println("ğŸš¨ æ£€æµ‹åˆ°å®‰å…¨è¿è§„:");
        System.err.println("   Session ID: " + session.getId());
        System.err.println("   å±æ€§å: " + attributeName);
        System.err.println("   æ“ä½œç±»å‹: " + operation);
        System.err.println("   è¿è§„åŸå› : " + result.getViolationReason());
        System.err.println("   é£é™©ç­‰çº§: " + result.getRiskLevel());
        
        // æ ¹æ®é£é™©ç­‰çº§é‡‡å–ä¸åŒæªæ–½
        switch (result.getRiskLevel()) {
            case "HIGH":
                handleHighRiskViolation(session, attributeName);
                break;
            case "MEDIUM":  
                handleMediumRiskViolation(session, attributeName);
                break;
            case "LOW":
                handleLowRiskViolation(session, attributeName);
                break;
        }
        
        // è®°å½•å®‰å…¨äº‹ä»¶
        logSecurityEvent(session.getId(), attributeName, operation, "BLOCKED");
        
        // å‘é€å®‰å…¨å‘Šè­¦
        sendSecurityAlert(session, attributeName, result);
    }
    
    private void handleHighRiskViolation(HttpSession session, String attributeName) {
        System.out.println("ğŸ”´ é«˜é£é™©è¿è§„å¤„ç†:");
        System.out.println("   - ç«‹å³æ¸…é™¤æ•æ„Ÿå±æ€§");
        System.out.println("   - å¼ºåˆ¶ç”¨æˆ·é‡æ–°è®¤è¯");
        
        // æ¸…é™¤æ•æ„Ÿæ•°æ®
        session.removeAttribute(attributeName);
        session.removeAttribute("user");
        
        // æ ‡è®°éœ€è¦é‡æ–°è®¤è¯
        session.setAttribute("requireReauth", true);
    }
    
    private void handleMediumRiskViolation(HttpSession session, String attributeName) {
        System.out.println("ğŸŸ¡ ä¸­é£é™©è¿è§„å¤„ç†:");
        System.out.println("   - é™åˆ¶å±æ€§è®¿é—®");
        System.out.println("   - å¢å¼ºç›‘æ§");
        
        // è®¾ç½®è®¿é—®é™åˆ¶æ ‡è®°
        session.setAttribute("restrictedAccess", true);
        
        // å¢åŠ ç›‘æ§é¢‘ç‡
        session.setAttribute("enhancedMonitoring", true);
    }
    
    private void handleLowRiskViolation(HttpSession session, String attributeName) {
        System.out.println("ğŸŸ¢ ä½é£é™©è¿è§„å¤„ç†:");
        System.out.println("   - è®°å½•æ—¥å¿—");
        System.out.println("   - ç»§ç»­ç›‘æ§");
        
        // åªè®°å½•ï¼Œä¸é‡‡å–é™åˆ¶æªæ–½
    }
    
    private void logSecurityEvent(String sessionId, String attributeName, 
                                String operation, String result) {
        SecurityLog log = new SecurityLog();
        log.setSessionId(sessionId);
        log.setAttributeName(attributeName);
        log.setOperation(operation);
        log.setResult(result);
        log.setTimestamp(new Date());
        
        // å®é™…é¡¹ç›®ä¸­ä¿å­˜åˆ°å®‰å…¨æ—¥å¿—ç³»ç»Ÿ
        System.out.println("ğŸ“ å®‰å…¨æ—¥å¿—: " + operation + " " + attributeName + " -> " + result);
    }
    
    private void sendSecurityAlert(HttpSession session, String attributeName, 
                                 SecurityCheckResult result) {
        // å®é™…é¡¹ç›®ä¸­å¯èƒ½ï¼š
        // 1. å‘é€é‚®ä»¶ç»™å®‰å…¨å›¢é˜Ÿ
        // 2. æ¨é€åˆ°å®‰å…¨ç›‘æ§å¹³å°
        // 3. è§¦å‘è‡ªåŠ¨åŒ–å®‰å…¨å“åº”
        
        System.out.println("ğŸš¨ å‘é€å®‰å…¨å‘Šè­¦: " + result.getViolationReason());
    }
}

// å®‰å…¨æ£€æŸ¥å™¨
class SecurityChecker {
    public SecurityCheckResult checkSecurity(HttpSession session, String attributeName, 
                                           Object value, String operation) {
        SecurityCheckResult result = new SecurityCheckResult();
        
        // æ£€æŸ¥1: ä¼šè¯æœ‰æ•ˆæ€§
        if (!isValidSession(session)) {
            result.setSecure(false);
            result.setViolationReason("æ— æ•ˆä¼šè¯");
            result.setRiskLevel("HIGH");
            return result;
        }
        
        // æ£€æŸ¥2: å±æ€§å€¼å®‰å…¨æ€§
        if (!isSafeAttributeValue(attributeName, value)) {
            result.setSecure(false);
            result.setViolationReason("å±æ€§å€¼åŒ…å«å±é™©å†…å®¹");
            result.setRiskLevel("MEDIUM");
            return result;
        }
        
        // æ£€æŸ¥3: æ“ä½œæƒé™
        if (!hasOperationPermission(session, attributeName, operation)) {
            result.setSecure(false);
            result.setViolationReason("ç¼ºå°‘æ“ä½œæƒé™");
            result.setRiskLevel("HIGH");
            return result;
        }
        
        // æ£€æŸ¥4: é¢‘ç‡é™åˆ¶
        if (isOperationTooFrequent(session, attributeName)) {
            result.setSecure(false);
            result.setViolationReason("æ“ä½œé¢‘ç‡è¿‡é«˜");  
            result.setRiskLevel("MEDIUM");
            return result;
        }
        
        result.setSecure(true);
        return result;
    }
    
    private boolean isValidSession(HttpSession session) {
        // æ£€æŸ¥ä¼šè¯æ˜¯å¦æœ‰æ•ˆ
        try {
            session.getId(); // å¦‚æœä¼šè¯æ— æ•ˆä¼šæŠ›å¼‚å¸¸
            return true;
        } catch (IllegalStateException e) {
            return false;
        }
    }
    
    private boolean isSafeAttributeValue(String attributeName, Object value) {
        if (value == null) return true;
        
        String valueStr = value.toString();
        
        // ç®€å•çš„å®‰å…¨æ£€æŸ¥ï¼ˆå®é™…ä¸­ä¼šæ›´å¤æ‚ï¼‰
        String[] dangerousPatterns = {"<script", "javascript:", "eval(", "document.cookie"};
        
        return Arrays.stream(dangerousPatterns)
                     .noneMatch(pattern -> valueStr.toLowerCase().contains(pattern));
    }
    
    private boolean hasOperationPermission(HttpSession session, String attributeName, String operation) {
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æ“ä½œè¯¥å±æ€§çš„æƒé™
        Object user = session.getAttribute("user");
        if (user == null) return false;
        
        // ç®€åŒ–çš„æƒé™æ£€æŸ¥é€»è¾‘
        if ("adminRights".equals(attributeName)) {
            // åªæœ‰ç®¡ç†å‘˜æ‰èƒ½æ“ä½œç®¡ç†æƒé™
            return isAdmin(user);
        }
        
        return true; // å…¶ä»–å±æ€§å…è®¸æ“ä½œ
    }
    
    private boolean isAdmin(Object user) {
        // ç®€åŒ–çš„ç®¡ç†å‘˜æ£€æŸ¥
        return user.toString().contains("admin");
    }
    
    private boolean isOperationTooFrequent(HttpSession session, String attributeName) {
        // æ£€æŸ¥æ“ä½œé¢‘ç‡ï¼ˆå®é™…ä¸­å¯èƒ½ä½¿ç”¨è®¡æ•°å™¨æˆ–æ—¶é—´çª—å£ï¼‰
        Object lastOpTime = session.getAttribute("lastOpTime_" + attributeName);
        if (lastOpTime == null) {
            session.setAttribute("lastOpTime_" + attributeName, System.currentTimeMillis());
            return false;
        }
        
        long timeDiff = System.currentTimeMillis() - (Long) lastOpTime;
        session.setAttribute("lastOpTime_" + attributeName, System.currentTimeMillis());
        
        // å¦‚æœä¸¤æ¬¡æ“ä½œé—´éš”å°‘äº1ç§’ï¼Œè®¤ä¸ºé¢‘ç‡è¿‡é«˜
        return timeDiff < 1000;
    }
}

// å®‰å…¨æ£€æŸ¥ç»“æœ
class SecurityCheckResult {
    private boolean secure;
    private String violationReason;
    private String riskLevel;
    
    // getterå’Œsetteræ–¹æ³•...
}

// å®‰å…¨æ—¥å¿—
class SecurityLog {
    private String sessionId;
    private String attributeName;
    private String operation;
    private String result;
    private Date timestamp;
    
    // getterå’Œsetteræ–¹æ³•...
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ¯ HttpSessionå±æ€§ç›‘å¬æ ¸å¿ƒè¦ç‚¹ï¼š

ğŸ”¸ åŸºæœ¬æ¦‚å¿µï¼šç›‘æ§Sessionä¸­å±æ€§çš„å¢åŠ ã€ä¿®æ”¹ã€åˆ é™¤æ“ä½œ
ğŸ”¸ ä¸‰ä¸ªæ ¸å¿ƒæ–¹æ³•ï¼šattributeAddedã€attributeReplacedã€attributeRemoved  
ğŸ”¸ äº‹ä»¶å¯¹è±¡ï¼šHttpSessionBindingEventæä¾›ä¼šè¯å’Œå±æ€§ä¿¡æ¯
ğŸ”¸ åº”ç”¨åœºæ™¯ï¼šç”¨æˆ·çŠ¶æ€è·Ÿè¸ªã€è´­ç‰©è½¦ç›‘æ§ã€è¡Œä¸ºåˆ†æã€æ•°æ®åŒæ­¥
ğŸ”¸ å®‰å…¨æœºåˆ¶ï¼šæ•æ„Ÿæ•°æ®ä¿æŠ¤ã€ä¸€è‡´æ€§ä¿éšœã€æƒé™æ£€æŸ¥
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ç›‘å¬å™¨çš„å·¥ä½œæ—¶æœº**
```
å±æ€§æ“ä½œæ—¶æœºï¼š
session.setAttribute()     â†’ attributeAdded/attributeReplaced
session.removeAttribute()  â†’ attributeRemoved  

æ³¨æ„ï¼šgetValue()è¿”å›å€¼å«ä¹‰ä¸åŒ
â€¢ attributeAddedï¼šè¿”å›æ–°æ·»åŠ çš„å€¼
â€¢ attributeReplacedï¼šè¿”å›è¢«æ›¿æ¢çš„æ—§å€¼
â€¢ attributeRemovedï¼šè¿”å›è¢«åˆ é™¤çš„å€¼
```

**ğŸ”¹ å®é™…åº”ç”¨ä»·å€¼**
```
ä¸šåŠ¡ä»·å€¼ï¼š
âœ… å®æ—¶ç›‘æ§ç”¨æˆ·çŠ¶æ€å˜åŒ–
âœ… è‡ªåŠ¨è§¦å‘ç›¸å…³ä¸šåŠ¡é€»è¾‘
âœ… æä¾›æ•°æ®ä¸€è‡´æ€§ä¿éšœ
âœ… å¢å¼ºç³»ç»Ÿå®‰å…¨æ€§  
âœ… æ”¯æŒç”¨æˆ·è¡Œä¸ºåˆ†æ
âœ… å®ç°ç³»ç»Ÿé—´æ•°æ®åŒæ­¥
```

**ğŸ”¹ æ€§èƒ½å’Œå®‰å…¨è€ƒè™‘**
```
æ€§èƒ½ä¼˜åŒ–ï¼š
â€¢ ä½¿ç”¨å¼‚æ­¥å¤„ç†é¿å…é˜»å¡è¯·æ±‚
â€¢ åªç›‘å¬å…³é”®å±æ€§ï¼Œé¿å…è¿‡åº¦ç›‘æ§
â€¢ åˆç†è®¾è®¡ç¼“å­˜å’Œå­˜å‚¨ç­–ç•¥

å®‰å…¨é˜²æŠ¤ï¼š
â€¢ éªŒè¯æ•æ„Ÿå±æ€§çš„è®¿é—®æƒé™  
â€¢ æ£€æŸ¥å±æ€§å€¼çš„å®‰å…¨æ€§
â€¢ å®æ–½æ“ä½œé¢‘ç‡é™åˆ¶
â€¢ è®°å½•å®Œæ•´çš„å®‰å…¨å®¡è®¡æ—¥å¿—
```

### 9.3 æœ€ä½³å®è·µå»ºè®®


**ğŸ”§ å®ç°æŠ€å·§**ï¼š
- ğŸ¯ **ç²¾å‡†ç›‘å¬**ï¼šåªç›‘å¬ä¸šåŠ¡ç›¸å…³çš„å…³é”®å±æ€§
- âš¡ **å¼‚æ­¥å¤„ç†**ï¼šè€—æ—¶æ“ä½œä½¿ç”¨å¼‚æ­¥æ‰§è¡Œ
- ğŸ”’ **å®‰å…¨ä¼˜å…ˆ**ï¼šæ•æ„Ÿæ•°æ®å¿…é¡»åŠ å¼ºéªŒè¯
- ğŸ“Š **æ•°æ®é©±åŠ¨**ï¼šåŸºäºç›‘å¬æ•°æ®è¿›è¡Œä¸šåŠ¡å†³ç­–
- ğŸ”„ **å®¹é”™æœºåˆ¶**ï¼šå¤„ç†å¼‚å¸¸æƒ…å†µå’Œæ•…éšœæ¢å¤

**ğŸ’¡ å­¦ä¹ è®°å¿†**ï¼š
- HttpSessionå±æ€§ç›‘å¬å™¨åƒæ˜¯"ä¼šè¯ç®¡å®¶"
- ä¸‰ä¸ªæ–¹æ³•å¯¹åº”å¢åˆ æ”¹ä¸‰ç§æ“ä½œ
- äº‹ä»¶å¯¹è±¡åŒ…å«å®Œæ•´çš„å˜åŒ–ä¿¡æ¯
- å¼‚æ­¥å¤„ç†ä¿è¯ç³»ç»Ÿæ€§èƒ½
- å®‰å…¨æ£€æŸ¥ä¿æŠ¤æ•æ„Ÿæ•°æ®

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
Sessionå±æ€§æœ‰å˜åŒ–ï¼Œç›‘å¬å™¨æ¥æŠŠå…³æŠŠå¯Ÿ
æ·»åŠ æ›¿æ¢å’Œåˆ é™¤ï¼Œä¸‰ä¸ªæ–¹æ³•è¦è®°æ¸…
äº‹ä»¶å¯¹è±¡ä¿¡æ¯å…¨ï¼Œä¼šè¯å±æ€§å€¼éƒ½æœ‰
å¼‚æ­¥å¤„ç†ä¿æ€§èƒ½ï¼Œå®‰å…¨æ£€æŸ¥æŠ¤æ•°æ®
```