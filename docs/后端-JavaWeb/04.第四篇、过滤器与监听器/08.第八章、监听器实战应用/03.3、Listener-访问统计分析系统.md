---
title: 3ã€Listener-è®¿é—®ç»Ÿè®¡åˆ†æç³»ç»Ÿ
---
## ğŸ“š ç›®å½•

1. [è®¿é—®ç»Ÿè®¡ç³»ç»Ÿæ¦‚è¿°](#1-è®¿é—®ç»Ÿè®¡ç³»ç»Ÿæ¦‚è¿°)
2. [é¡µé¢è®¿é—®é‡ç»Ÿè®¡](#2-é¡µé¢è®¿é—®é‡ç»Ÿè®¡)
3. [ç”¨æˆ·è¡Œä¸ºè½¨è¿¹è¿½è¸ª](#3-ç”¨æˆ·è¡Œä¸ºè½¨è¿¹è¿½è¸ª)
4. [çƒ­é—¨é¡µé¢æ’è¡Œå®ç°](#4-çƒ­é—¨é¡µé¢æ’è¡Œå®ç°)
5. [è®¿é—®æ—¶é—´åˆ†å¸ƒåˆ†æ](#5-è®¿é—®æ—¶é—´åˆ†å¸ƒåˆ†æ)
6. [åœ°åŸŸåˆ†å¸ƒç»Ÿè®¡](#6-åœ°åŸŸåˆ†å¸ƒç»Ÿè®¡)
7. [æ•°æ®æŒä¹…åŒ–å­˜å‚¨](#7-æ•°æ®æŒä¹…åŒ–å­˜å‚¨)
8. [å®æ—¶æŠ¥è¡¨ç”Ÿæˆ](#8-å®æ—¶æŠ¥è¡¨ç”Ÿæˆ)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ è®¿é—®ç»Ÿè®¡ç³»ç»Ÿæ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯è®¿é—®ç»Ÿè®¡ç³»ç»Ÿ


**é€šä¿—ç†è§£**ï¼š
å°±åƒå•†åº—è€æ¿æƒ³çŸ¥é“æ¯å¤©æœ‰å¤šå°‘é¡¾å®¢æ¥åº—é‡Œã€ä»–ä»¬éƒ½çœ‹äº†ä»€ä¹ˆå•†å“ã€ä»€ä¹ˆæ—¶å€™äººæœ€å¤šä¸€æ ·ï¼Œç½‘ç«™ä¹Ÿéœ€è¦äº†è§£è®¿å®¢çš„è¡Œä¸ºã€‚è®¿é—®ç»Ÿè®¡ç³»ç»Ÿå°±æ˜¯ç½‘ç«™çš„"ç›‘æ§æ‘„åƒå¤´"ï¼Œè®°å½•ä¸‹æ‰€æœ‰è®¿é—®ä¿¡æ¯ã€‚

```
ğŸ¯ è®¿é—®ç»Ÿè®¡ç³»ç»Ÿçš„æ ¸å¿ƒä½œç”¨ï¼š
âœ… äº†è§£ç½‘ç«™æµé‡ï¼šæ¯å¤©æœ‰å¤šå°‘äººè®¿é—®
âœ… åˆ†æç”¨æˆ·å–œå¥½ï¼šå“ªäº›é¡µé¢æœ€å—æ¬¢è¿
âœ… ä¼˜åŒ–ç½‘ç«™æ€§èƒ½ï¼šæ‰¾å‡ºè®¿é—®é«˜å³°æœŸ
âœ… æ”¹è¿›ç”¨æˆ·ä½“éªŒï¼šå‘ç°ç”¨æˆ·è¡Œä¸ºæ¨¡å¼
âœ… å•†ä¸šå†³ç­–æ”¯æŒï¼šä¸ºè¿è¥æä¾›æ•°æ®ä¾æ®
```

### 1.2 ç›‘å¬å™¨åœ¨ç»Ÿè®¡ç³»ç»Ÿä¸­çš„ä½œç”¨


**ä¸ºä»€ä¹ˆç”¨ç›‘å¬å™¨æ¥åšè®¿é—®ç»Ÿè®¡ï¼Ÿ**
æƒ³è±¡ä¸€ä¸‹ï¼Œç›‘å¬å™¨å°±åƒæ˜¯ç«™åœ¨é—¨å£çš„è¿å®¾å‘˜ï¼Œæ¯å½“æœ‰å®¢äººè¿›å‡ºï¼Œä»–éƒ½èƒ½å‡†ç¡®è®°å½•ä¸‹æ—¶é—´ã€äººæ•°ç­‰ä¿¡æ¯ã€‚

```
ğŸ”„ ç›‘å¬å™¨ç»Ÿè®¡åŸç†ï¼š
ç”¨æˆ·è®¿é—®ç½‘ç«™
    â†“
è§¦å‘ç›‘å¬å™¨ (è‡ªåŠ¨æ‰§è¡Œ)
    â†“ 
è®°å½•è®¿é—®ä¿¡æ¯ (æ—¶é—´ã€IPã€é¡µé¢ç­‰)
    â†“
å­˜å‚¨åˆ°å†…å­˜æˆ–æ•°æ®åº“
    â†“
æä¾›ç»Ÿè®¡æŠ¥è¡¨æŸ¥è¯¢
```

**ğŸ“Š ç›‘å¬å™¨ç»Ÿè®¡çš„ä¼˜åŠ¿**ï¼š
- **è‡ªåŠ¨åŒ–**ï¼šæ— éœ€æ‰‹åŠ¨è°ƒç”¨ï¼Œè®¿é—®æ—¶è‡ªåŠ¨è§¦å‘
- **å…¨è¦†ç›–**ï¼šæ•è·æ‰€æœ‰HTTPè¯·æ±‚ï¼Œä¸ä¼šé—æ¼
- **é«˜æ€§èƒ½**ï¼šç›´æ¥åœ¨æœåŠ¡å™¨å†…éƒ¨å¤„ç†ï¼Œå“åº”é€Ÿåº¦å¿«
- **å®æ—¶æ€§**ï¼šè®¿é—®æ•°æ®å®æ—¶æ›´æ–°ï¼Œæ— å»¶è¿Ÿ

### 1.3 ç»Ÿè®¡ç³»ç»Ÿæ•´ä½“æ¶æ„


**ğŸ—ï¸ ç³»ç»Ÿæ¶æ„è®¾è®¡**ï¼š
```
å‰ç«¯å±•ç¤ºå±‚
â”œâ”€â”€ è®¿é—®é‡å›¾è¡¨
â”œâ”€â”€ çƒ­é—¨é¡µé¢åˆ—è¡¨  
â””â”€â”€ å®æ—¶æ•°æ®é¢æ¿

æ•°æ®å¤„ç†å±‚
â”œâ”€â”€ è®¿é—®æ—¥å¿—è§£æ
â”œâ”€â”€ ç»Ÿè®¡æ•°æ®è®¡ç®—
â””â”€â”€ æŠ¥è¡¨ç”Ÿæˆå™¨

æ•°æ®é‡‡é›†å±‚ (ç›‘å¬å™¨)
â”œâ”€â”€ ServletRequestListener  â† è¯·æ±‚ç›‘å¬
â”œâ”€â”€ HttpSessionListener     â† ä¼šè¯ç›‘å¬
â””â”€â”€ ServletContextListener  â† åº”ç”¨ç›‘å¬

å­˜å‚¨å±‚
â”œâ”€â”€ å†…å­˜ç¼“å­˜ (Map)
â”œâ”€â”€ æ•°æ®åº“æŒä¹…åŒ– (MySQL)
â””â”€â”€ æ–‡ä»¶æ—¥å¿— (Logæ–‡ä»¶)
```

---

## 2. ğŸ“ˆ é¡µé¢è®¿é—®é‡ç»Ÿè®¡


### 2.1 åŸºç¡€è®¿é—®é‡ç»Ÿè®¡å®ç°


**æ ¸å¿ƒæ€è·¯**ï¼šæ¯å½“ç”¨æˆ·è®¿é—®é¡µé¢æ—¶ï¼Œæˆ‘ä»¬å°±ç»™å¯¹åº”é¡µé¢çš„è®¡æ•°å™¨åŠ 1ï¼Œå°±åƒè®¡æ•°å™¨ä¸€æ ·ç®€å•ã€‚

**ğŸ› ï¸ è®¿é—®é‡ç»Ÿè®¡ç›‘å¬å™¨**ï¼š
```java
@WebListener
public class PageViewListener implements ServletRequestListener {
    
    @Override
    public void requestInitialized(ServletRequestEvent sre) {
        HttpServletRequest request = (HttpServletRequest) sre.getServletRequest();
        
        // è·å–è®¿é—®çš„é¡µé¢è·¯å¾„
        String requestURI = request.getRequestURI();
        String contextPath = request.getContextPath();
        String pagePath = requestURI.substring(contextPath.length());
        
        // ä»åº”ç”¨ä¸Šä¸‹æ–‡è·å–ç»Ÿè®¡æ•°æ®
        ServletContext context = request.getServletContext();
        
        // ç»Ÿè®¡æ€»è®¿é—®é‡
        updateTotalVisits(context);
        
        // ç»Ÿè®¡é¡µé¢è®¿é—®é‡
        updatePageVisits(context, pagePath);
        
        // è®°å½•è®¿é—®æ—¶é—´
        recordVisitTime(context);
    }
}
```

**ğŸ“Š ç»Ÿè®¡æ•°æ®å­˜å‚¨ç»“æ„**ï¼š
```java
// ç»Ÿè®¡æ•°æ®ç®¡ç†ç±»
public class AnalyticsManager {
    // æ€»è®¿é—®é‡
    private static AtomicLong totalVisits = new AtomicLong(0);
    
    // é¡µé¢è®¿é—®é‡ - é¡µé¢è·¯å¾„:è®¿é—®æ¬¡æ•°
    private static ConcurrentHashMap<String, AtomicLong> pageVisits 
        = new ConcurrentHashMap<>();
    
    // æ¯æ—¥è®¿é—®é‡ - æ—¥æœŸ:è®¿é—®æ¬¡æ•°
    private static ConcurrentHashMap<String, AtomicLong> dailyVisits 
        = new ConcurrentHashMap<>();
    
    // å¢åŠ æ€»è®¿é—®é‡
    public static void incrementTotalVisits() {
        totalVisits.incrementAndGet();
    }
    
    // å¢åŠ é¡µé¢è®¿é—®é‡
    public static void incrementPageVisits(String page) {
        pageVisits.computeIfAbsent(page, k -> new AtomicLong(0))
                  .incrementAndGet();
    }
}
```

### 2.2 è®¿é—®é‡ç»Ÿè®¡çš„å…³é”®ç»†èŠ‚


**ğŸ” éœ€è¦è€ƒè™‘çš„é—®é¢˜**ï¼š

**é—®é¢˜1ï¼šä»€ä¹ˆè¯·æ±‚éœ€è¦ç»Ÿè®¡ï¼Ÿ**
```java
private boolean shouldCount(HttpServletRequest request) {
    String uri = request.getRequestURI();
    String method = request.getMethod();
    
    // åªç»Ÿè®¡GETè¯·æ±‚çš„é¡µé¢è®¿é—®
    if (!"GET".equals(method)) {
        return false;
    }
    
    // æ’é™¤é™æ€èµ„æº
    if (uri.endsWith(".css") || uri.endsWith(".js") || 
        uri.endsWith(".jpg") || uri.endsWith(".png")) {
        return false;
    }
    
    // æ’é™¤APIè¯·æ±‚
    if (uri.contains("/api/")) {
        return false;
    }
    
    return true;
}
```

**é—®é¢˜2ï¼šå¦‚ä½•å¤„ç†é‡å¤è®¿é—®ï¼Ÿ**
```java
public class UniqueVisitorTracker {
    // å­˜å‚¨ä»Šå¤©å·²è®¿é—®çš„IPåœ°å€
    private static Set<String> todayVisitors = ConcurrentHashMap.newKeySet();
    // å­˜å‚¨IPåœ°å€çš„æœ€åè®¿é—®æ—¶é—´
    private static ConcurrentHashMap<String, Long> lastVisitTime = 
        new ConcurrentHashMap<>();
    
    public static boolean isUniqueVisitor(String clientIP) {
        String today = LocalDate.now().toString();
        String key = today + "_" + clientIP;
        
        // å¦‚æœä»Šå¤©ç¬¬ä¸€æ¬¡è®¿é—®ï¼Œç®—ä½œç‹¬ç«‹è®¿å®¢
        return todayVisitors.add(key);
    }
    
    // æ¯å¤©æ¸…ç©ºè®¿å®¢è®°å½•
    @Scheduled(cron = "0 0 0 * * ?") // æ¯å¤©0ç‚¹æ‰§è¡Œ
    public void resetDailyVisitors() {
        todayVisitors.clear();
    }
}
```

### 2.3 å®æ—¶è®¿é—®é‡å±•ç¤º


**ğŸ“± è·å–ç»Ÿè®¡æ•°æ®çš„Servlet**ï¼š
```java
@WebServlet("/analytics/stats")
public class AnalyticsServlet extends HttpServlet {
    
    protected void doGet(HttpServletRequest request, HttpServletResponse response) 
            throws ServletException, IOException {
        
        // è®¾ç½®å“åº”ç±»å‹ä¸ºJSON
        response.setContentType("application/json;charset=UTF-8");
        
        // æ„å»ºç»Ÿè®¡æ•°æ®JSON
        JSONObject stats = new JSONObject();
        stats.put("totalVisits", AnalyticsManager.getTotalVisits());
        stats.put("todayVisits", AnalyticsManager.getTodayVisits());
        stats.put("onlineUsers", SessionManager.getOnlineUserCount());
        
        // è¿”å›é¡µé¢è®¿é—®æ’è¡Œ
        Map<String, Long> topPages = AnalyticsManager.getTopPages(10);
        stats.put("topPages", topPages);
        
        response.getWriter().write(stats.toString());
    }
}
```

---

## 3. ğŸ‘¤ ç”¨æˆ·è¡Œä¸ºè½¨è¿¹è¿½è¸ª


### 3.1 ç”¨æˆ·è½¨è¿¹çš„æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯ç”¨æˆ·è¡Œä¸ºè½¨è¿¹ï¼Ÿ**
å°±åƒæˆ‘ä»¬åœ¨å•†åœºè´­ç‰©æ—¶çš„è·¯çº¿ä¸€æ ·ï¼Œç”¨æˆ·åœ¨ç½‘ç«™ä¸Šä¹Ÿæœ‰è‡ªå·±çš„"æµè§ˆè·¯å¾„"ï¼šé¦–é¡µ â†’ äº§å“é¡µ â†’ è¯¦æƒ…é¡µ â†’ è´­ä¹°é¡µã€‚è®°å½•è¿™äº›è·¯å¾„å¯ä»¥å¸®åŠ©æˆ‘ä»¬äº†è§£ç”¨æˆ·çš„å…´è¶£å’Œè¡Œä¸ºæ¨¡å¼ã€‚

```
ğŸ›¤ï¸ å…¸å‹ç”¨æˆ·è½¨è¿¹ç¤ºä¾‹ï¼š
æ—¶é—´è½´: 10:00 â†’ 10:05 â†’ 10:08 â†’ 10:12 â†’ 10:15
é¡µé¢:   é¦–é¡µ  â†’  ç™»å½•  â†’  å•†å“  â†’  è´­ç‰©è½¦ â†’  ç»“è´¦

é€šè¿‡åˆ†æå‘ç°ï¼š
âœ… ç”¨æˆ·ä»é¦–é¡µåˆ°è´­ä¹°ç”¨æ—¶15åˆ†é’Ÿ
âœ… ç™»å½•æ˜¯å…³é”®è½¬åŒ–ç¯èŠ‚
âœ… å•†å“é¡µåœç•™æ—¶é—´è¾ƒé•¿ï¼Œè¯´æ˜ç”¨æˆ·åœ¨æ¯”è¾ƒé€‰æ‹©
```

### 3.2 ç”¨æˆ·è½¨è¿¹è¿½è¸ªå®ç°


**ğŸ”— è½¨è¿¹æ•°æ®ç»“æ„è®¾è®¡**ï¼š
```java
// ç”¨æˆ·è®¿é—®è®°å½•
public class UserVisitRecord {
    private String sessionId;     // ä¼šè¯ID
    private String clientIP;      // ç”¨æˆ·IP
    private String pagePath;      // è®¿é—®é¡µé¢
    private Date visitTime;       // è®¿é—®æ—¶é—´
    private String userAgent;     // æµè§ˆå™¨ä¿¡æ¯
    private String referer;       // æ¥æºé¡µé¢
    private long stayDuration;    // åœç•™æ—¶é•¿ï¼ˆç§’ï¼‰
    
    // æ„é€ å‡½æ•°å’Œgetter/setterçœç•¥
}

// ç”¨æˆ·è½¨è¿¹ç®¡ç†å™¨
public class UserTrajectoryManager {
    // å­˜å‚¨æ¯ä¸ªä¼šè¯çš„è®¿é—®è½¨è¿¹
    private static ConcurrentHashMap<String, List<UserVisitRecord>> 
        userTrajectories = new ConcurrentHashMap<>();
    
    // æ·»åŠ è®¿é—®è®°å½•
    public static void addVisitRecord(String sessionId, UserVisitRecord record) {
        userTrajectories.computeIfAbsent(sessionId, k -> new ArrayList<>())
                        .add(record);
    }
}
```

**ğŸ“ è½¨è¿¹è¿½è¸ªç›‘å¬å™¨**ï¼š
```java
@WebListener
public class UserTrajectoryListener implements ServletRequestListener, 
                                               HttpSessionListener {
    
    @Override
    public void requestInitialized(ServletRequestEvent sre) {
        HttpServletRequest request = (HttpServletRequest) sre.getServletRequest();
        HttpSession session = request.getSession();
        
        // åˆ›å»ºè®¿é—®è®°å½•
        UserVisitRecord record = new UserVisitRecord();
        record.setSessionId(session.getId());
        record.setClientIP(getClientIP(request));
        record.setPagePath(request.getRequestURI());
        record.setVisitTime(new Date());
        record.setUserAgent(request.getHeader("User-Agent"));
        record.setReferer(request.getHeader("Referer"));
        
        // è®¡ç®—ä¸Šä¸€é¡µçš„åœç•™æ—¶é•¿
        calculateStayDuration(session, record);
        
        // æ·»åŠ åˆ°è½¨è¿¹è®°å½•
        UserTrajectoryManager.addVisitRecord(session.getId(), record);
    }
    
    // è·å–çœŸå®IPåœ°å€ï¼ˆè€ƒè™‘ä»£ç†æƒ…å†µï¼‰
    private String getClientIP(HttpServletRequest request) {
        String ip = request.getHeader("X-Forwarded-For");
        if (ip == null || ip.isEmpty() || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getHeader("X-Real-IP");
        }
        if (ip == null || ip.isEmpty() || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getRemoteAddr();
        }
        return ip;
    }
}
```

### 3.3 è½¨è¿¹åˆ†æå’Œå¯è§†åŒ–


**ğŸ“Š åˆ†æç”¨æˆ·è¡Œä¸ºæ¨¡å¼**ï¼š
```java
public class TrajectoryAnalyzer {
    
    // åˆ†ææœ€å¸¸è§çš„é¡µé¢è·³è½¬è·¯å¾„
    public static Map<String, Integer> getCommonPaths() {
        Map<String, Integer> pathCount = new HashMap<>();
        
        for (List<UserVisitRecord> trajectory : 
             UserTrajectoryManager.getAllTrajectories()) {
            
            // åˆ†æç›¸é‚»é¡µé¢çš„è·³è½¬
            for (int i = 0; i < trajectory.size() - 1; i++) {
                String fromPage = trajectory.get(i).getPagePath();
                String toPage = trajectory.get(i + 1).getPagePath();
                String path = fromPage + " â†’ " + toPage;
                
                pathCount.merge(path, 1, Integer::sum);
            }
        }
        
        // æŒ‰è®¿é—®é¢‘ç‡æ’åºè¿”å›å‰10æ¡è·¯å¾„
        return pathCount.entrySet().stream()
                .sorted(Map.Entry.<String, Integer>comparingByValue().reversed())
                .limit(10)
                .collect(LinkedHashMap::new, 
                        (m, e) -> m.put(e.getKey(), e.getValue()), 
                        LinkedHashMap::putAll);
    }
    
    // åˆ†æé¡µé¢åœç•™æ—¶é•¿
    public static Map<String, Double> getAverageStayTime() {
        Map<String, List<Long>> pageStayTimes = new HashMap<>();
        
        // æ”¶é›†å„é¡µé¢çš„åœç•™æ—¶é•¿æ•°æ®
        for (List<UserVisitRecord> trajectory : 
             UserTrajectoryManager.getAllTrajectories()) {
            for (UserVisitRecord record : trajectory) {
                if (record.getStayDuration() > 0) {
                    pageStayTimes.computeIfAbsent(record.getPagePath(), 
                                                 k -> new ArrayList<>())
                                 .add(record.getStayDuration());
                }
            }
        }
        
        // è®¡ç®—å¹³å‡åœç•™æ—¶é•¿
        Map<String, Double> avgStayTime = new HashMap<>();
        pageStayTimes.forEach((page, times) -> {
            double avg = times.stream().mapToLong(Long::longValue).average().orElse(0.0);
            avgStayTime.put(page, avg);
        });
        
        return avgStayTime;
    }
}
```

---

## 4. ğŸ† çƒ­é—¨é¡µé¢æ’è¡Œå®ç°


### 4.1 çƒ­é—¨é¡µé¢æ’è¡ŒåŸç†


**ä»€ä¹ˆæ˜¯çƒ­é—¨é¡µé¢ï¼Ÿ**
å°±åƒéŸ³ä¹æ’è¡Œæ¦œä¸€æ ·ï¼Œæ ¹æ®è®¿é—®é‡å¯¹ç½‘ç«™é¡µé¢è¿›è¡Œæ’åã€‚è®¿é—®é‡è¶Šé«˜ï¼Œæ’åè¶Šé å‰ã€‚

```
ğŸµ é¡µé¢æ’è¡Œæ¦œç¤ºä¾‹ï¼š
æ’å  é¡µé¢è·¯å¾„        è®¿é—®é‡    å æ¯”
1     /index.html    15,234   35.2%
2     /products      8,967    20.7% 
3     /about         5,431    12.6%
4     /contact       3,892     9.0%
5     /login         3,102     7.2%
```

### 4.2 æ’è¡Œæ¦œæ•°æ®ç»“æ„


**ğŸ“Š æ’è¡Œæ¦œç®¡ç†å™¨**ï¼š
```java
public class PageRankingManager {
    
    // é¡µé¢è®¿é—®æ•°æ®
    public static class PageStats {
        private String pagePath;
        private long visitCount;
        private long uniqueVisitors;
        private double averageStayTime;
        private Date lastVisit;
        
        // æ„é€ å‡½æ•°å’Œgetter/setter
        public PageStats(String pagePath) {
            this.pagePath = pagePath;
            this.visitCount = 0;
            this.uniqueVisitors = 0;
            this.lastVisit = new Date();
        }
    }
    
    // å­˜å‚¨æ‰€æœ‰é¡µé¢çš„ç»Ÿè®¡æ•°æ®
    private static ConcurrentHashMap<String, PageStats> pageStatsMap = 
        new ConcurrentHashMap<>();
    
    // æ›´æ–°é¡µé¢è®¿é—®é‡
    public static void updatePageStats(String pagePath, String clientIP) {
        PageStats stats = pageStatsMap.computeIfAbsent(pagePath, PageStats::new);
        
        // å¢åŠ è®¿é—®é‡
        stats.visitCount++;
        stats.lastVisit = new Date();
        
        // ç»Ÿè®¡ç‹¬ç«‹è®¿å®¢ï¼ˆç®€åŒ–å®ç°ï¼Œå®é™…åº”ç”¨éœ€è¦æ›´å¤æ‚çš„å»é‡é€»è¾‘ï¼‰
        // è¿™é‡Œå‡è®¾åŒä¸€IPåœ¨çŸ­æ—¶é—´å†…å¤šæ¬¡è®¿é—®åªç®—ä¸€æ¬¡ç‹¬ç«‹è®¿å®¢
    }
    
    // è·å–çƒ­é—¨é¡µé¢æ’è¡Œæ¦œ
    public static List<PageStats> getTopPages(int limit) {
        return pageStatsMap.values().stream()
                .sorted((a, b) -> Long.compare(b.visitCount, a.visitCount))
                .limit(limit)
                .collect(Collectors.toList());
    }
}
```

### 4.3 å®æ—¶æ’è¡Œæ¦œæ›´æ–°


**âš¡ æ’è¡Œæ¦œç›‘å¬å™¨**ï¼š
```java
@WebListener
public class PageRankingListener implements ServletRequestListener {
    
    @Override
    public void requestInitialized(ServletRequestEvent sre) {
        HttpServletRequest request = (HttpServletRequest) sre.getServletRequest();
        
        // åªç»Ÿè®¡é¡µé¢è®¿é—®ï¼ˆæ’é™¤é™æ€èµ„æºå’ŒAPIï¼‰
        if (!shouldCountForRanking(request)) {
            return;
        }
        
        String pagePath = getPagePath(request);
        String clientIP = getClientIP(request);
        
        // æ›´æ–°æ’è¡Œæ¦œæ•°æ®
        PageRankingManager.updatePageStats(pagePath, clientIP);
        
        // å¼‚æ­¥æ›´æ–°æ•°æ®åº“ï¼ˆé¿å…å½±å“å“åº”é€Ÿåº¦ï¼‰
        CompletableFuture.runAsync(() -> {
            persistPageStats(pagePath, clientIP);
        });
    }
    
    private boolean shouldCountForRanking(HttpServletRequest request) {
        String uri = request.getRequestURI().toLowerCase();
        
        // æ’é™¤ä¸éœ€è¦ç»Ÿè®¡çš„è¯·æ±‚
        String[] exclusions = {".css", ".js", ".jpg", ".png", ".gif", 
                              ".ico", "/api/", "/ajax/"};
        
        for (String exclusion : exclusions) {
            if (uri.contains(exclusion)) {
                return false;
            }
        }
        
        return "GET".equals(request.getMethod());
    }
}
```

### 4.4 æ’è¡Œæ¦œå±•ç¤ºå’Œåˆ†æ


**ğŸ“ˆ æ’è¡Œæ¦œåˆ†æåŠŸèƒ½**ï¼š
```java
public class RankingAnalyzer {
    
    // åˆ†æé¡µé¢çƒ­åº¦è¶‹åŠ¿
    public static Map<String, Object> analyzePageTrends() {
        List<PageRankingManager.PageStats> topPages = 
            PageRankingManager.getTopPages(20);
            
        Map<String, Object> analysis = new HashMap<>();
        
        // è®¡ç®—æ€»è®¿é—®é‡
        long totalVisits = topPages.stream()
            .mapToLong(page -> page.getVisitCount())
            .sum();
        
        // åˆ†æè®¿é—®åˆ†å¸ƒ
        List<Map<String, Object>> pageAnalysis = topPages.stream()
            .map(page -> {
                Map<String, Object> pageInfo = new HashMap<>();
                pageInfo.put("path", page.getPagePath());
                pageInfo.put("visits", page.getVisitCount());
                pageInfo.put("percentage", 
                    String.format("%.1f%%", (double)page.getVisitCount() / totalVisits * 100));
                pageInfo.put("uniqueVisitors", page.getUniqueVisitors());
                return pageInfo;
            })
            .collect(Collectors.toList());
        
        analysis.put("totalVisits", totalVisits);
        analysis.put("pageRanking", pageAnalysis);
        analysis.put("analysisTime", new Date());
        
        return analysis;
    }
    
    // ç”Ÿæˆæ’è¡Œæ¦œæŠ¥å‘Š
    public static String generateRankingReport() {
        StringBuilder report = new StringBuilder();
        report.append("=== é¡µé¢è®¿é—®æ’è¡Œæ¦œ ===\n");
        report.append("ç”Ÿæˆæ—¶é—´: ").append(new Date()).append("\n\n");
        
        List<PageRankingManager.PageStats> topPages = 
            PageRankingManager.getTopPages(10);
            
        int rank = 1;
        for (PageRankingManager.PageStats page : topPages) {
            report.append(String.format("ç¬¬%då: %s (è®¿é—®é‡: %d)\n", 
                rank++, page.getPagePath(), page.getVisitCount()));
        }
        
        return report.toString();
    }
}
```

---

## 5. â° è®¿é—®æ—¶é—´åˆ†å¸ƒåˆ†æ


### 5.1 æ—¶é—´åˆ†å¸ƒåˆ†æçš„æ„ä¹‰


**ä¸ºä»€ä¹ˆè¦åˆ†æè®¿é—®æ—¶é—´ï¼Ÿ**
å°±åƒå•†åº—éœ€è¦çŸ¥é“ä»€ä¹ˆæ—¶å€™å®¢æµé‡æœ€å¤§ä¸€æ ·ï¼Œç½‘ç«™ä¹Ÿéœ€è¦äº†è§£ç”¨æˆ·çš„è®¿é—®ä¹ æƒ¯ï¼Œè¿™æ ·å¯ä»¥ï¼š
- **ä¼˜åŒ–æœåŠ¡å™¨èµ„æº**ï¼šåœ¨é«˜å³°æœŸå¢åŠ æœåŠ¡å™¨æ€§èƒ½
- **å®‰æ’ç»´æŠ¤æ—¶é—´**ï¼šåœ¨è®¿é—®é‡æœ€å°‘æ—¶è¿›è¡Œç³»ç»Ÿç»´æŠ¤
- **åˆ¶å®šè¥é”€ç­–ç•¥**ï¼šåœ¨ç”¨æˆ·æ´»è·ƒæ—¶æ¨é€å¹¿å‘Šæˆ–æ´»åŠ¨

```
ğŸ“Š æ—¶é—´åˆ†å¸ƒåˆ†æç»´åº¦ï¼š
ğŸ• å°æ—¶åˆ†å¸ƒï¼šä¸€å¤©24å°æ—¶çš„è®¿é—®é‡åˆ†å¸ƒ
ğŸ“… æ—¥æœŸåˆ†å¸ƒï¼šä¸€å‘¨7å¤©çš„è®¿é—®é‡å¯¹æ¯”
ğŸ“ˆ æœˆåº¦è¶‹åŠ¿ï¼šä¸åŒæœˆä»½çš„è®¿é—®é‡å˜åŒ–
ğŸ”„ å·¥ä½œæ—¥vså‘¨æœ«ï¼šå·¥ä½œæ—¥å’Œä¼‘æ¯æ—¥çš„è®¿é—®å·®å¼‚
```

### 5.2 æ—¶é—´ç»Ÿè®¡æ•°æ®ç»“æ„


**â²ï¸ æ—¶é—´ç»Ÿè®¡ç®¡ç†å™¨**ï¼š
```java
public class TimeAnalyticsManager {
    
    // æŒ‰å°æ—¶ç»Ÿè®¡è®¿é—®é‡ (0-23å°æ—¶)
    private static AtomicLong[] hourlyVisits = new AtomicLong[24];
    
    // æŒ‰æ˜ŸæœŸç»Ÿè®¡è®¿é—®é‡ (1-7ï¼Œå‘¨ä¸€åˆ°å‘¨æ—¥)  
    private static AtomicLong[] weeklyVisits = new AtomicLong[7];
    
    // æŒ‰æ—¥æœŸç»Ÿè®¡è®¿é—®é‡ (æ—¥æœŸå­—ç¬¦ä¸²:è®¿é—®é‡)
    private static ConcurrentHashMap<String, AtomicLong> dailyVisits = 
        new ConcurrentHashMap<>();
    
    static {
        // åˆå§‹åŒ–æ•°ç»„
        for (int i = 0; i < 24; i++) {
            hourlyVisits[i] = new AtomicLong(0);
        }
        for (int i = 0; i < 7; i++) {
            weeklyVisits[i] = new AtomicLong(0);
        }
    }
    
    // è®°å½•è®¿é—®æ—¶é—´
    public static void recordVisitTime() {
        LocalDateTime now = LocalDateTime.now();
        
        // è®°å½•å°æ—¶è®¿é—®é‡
        int hour = now.getHour();
        hourlyVisits[hour].incrementAndGet();
        
        // è®°å½•æ˜ŸæœŸè®¿é—®é‡ (å‘¨ä¸€=0, å‘¨æ—¥=6)
        int dayOfWeek = now.getDayOfWeek().getValue() - 1;
        weeklyVisits[dayOfWeek].incrementAndGet();
        
        // è®°å½•æ¯æ—¥è®¿é—®é‡
        String dateKey = now.format(DateTimeFormatter.ofPattern("yyyy-MM-dd"));
        dailyVisits.computeIfAbsent(dateKey, k -> new AtomicLong(0))
                   .incrementAndGet();
    }
    
    // è·å–å°æ—¶åˆ†å¸ƒæ•°æ®
    public static Map<Integer, Long> getHourlyDistribution() {
        Map<Integer, Long> distribution = new HashMap<>();
        for (int i = 0; i < 24; i++) {
            distribution.put(i, hourlyVisits[i].get());
        }
        return distribution;
    }
}
```

### 5.3 æ—¶é—´åˆ†å¸ƒåˆ†æç›‘å¬å™¨


**ğŸ“ˆ æ—¶é—´ç»Ÿè®¡ç›‘å¬å™¨**ï¼š
```java
@WebListener
public class TimeAnalyticsListener implements ServletRequestListener {
    
    @Override
    public void requestInitialized(ServletRequestEvent sre) {
        HttpServletRequest request = (HttpServletRequest) sre.getServletRequest();
        
        // åªç»Ÿè®¡é¡µé¢è®¿é—®
        if (shouldCountForTimeAnalysis(request)) {
            TimeAnalyticsManager.recordVisitTime();
            
            // è®°å½•è¯¦ç»†çš„è®¿é—®æ—¶é—´ä¿¡æ¯
            recordDetailedTimeInfo(request);
        }
    }
    
    private void recordDetailedTimeInfo(HttpServletRequest request) {
        // è·å–è®¿é—®æ—¶é—´è¯¦æƒ…
        LocalDateTime visitTime = LocalDateTime.now();
        String sessionId = request.getSession().getId();
        
        // åˆ›å»ºæ—¶é—´è®¿é—®è®°å½•
        TimeVisitRecord record = new TimeVisitRecord();
        record.setSessionId(sessionId);
        record.setVisitTime(visitTime);
        record.setPagePath(request.getRequestURI());
        record.setHour(visitTime.getHour());
        record.setDayOfWeek(visitTime.getDayOfWeek().getValue());
        
        // å­˜å‚¨è®°å½•ç”¨äºåç»­åˆ†æ
        TimeRecordManager.addRecord(record);
    }
    
    private boolean shouldCountForTimeAnalysis(HttpServletRequest request) {
        String method = request.getMethod();
        String uri = request.getRequestURI().toLowerCase();
        
        // åªç»Ÿè®¡GETè¯·æ±‚çš„é¡µé¢
        if (!"GET".equals(method)) return false;
        
        // æ’é™¤é™æ€èµ„æº
        return !uri.contains(".css") && !uri.contains(".js") && 
               !uri.contains(".jpg") && !uri.contains(".png");
    }
}
```

### 5.4 æ—¶é—´åˆ†å¸ƒå¯è§†åŒ–åˆ†æ


**ğŸ“Š ç”Ÿæˆæ—¶é—´åˆ†ææŠ¥å‘Š**ï¼š
```java
public class TimeAnalysisReporter {
    
    // ç”Ÿæˆè®¿é—®é«˜å³°æ—¶æ®µåˆ†æ
    public static Map<String, Object> generatePeakTimeAnalysis() {
        Map<String, Object> analysis = new HashMap<>();
        
        // åˆ†æå°æ—¶è®¿é—®é«˜å³°
        Map<Integer, Long> hourlyData = TimeAnalyticsManager.getHourlyDistribution();
        
        // æ‰¾å‡ºè®¿é—®é‡æœ€é«˜çš„æ—¶æ®µ
        int peakHour = hourlyData.entrySet().stream()
            .max(Map.Entry.comparingByValue())
            .map(Map.Entry::getKey)
            .orElse(0);
        
        long peakVisits = hourlyData.get(peakHour);
        
        // åˆ†æç»“æœ
        analysis.put("peakHour", peakHour);
        analysis.put("peakHourVisits", peakVisits);
        analysis.put("peakTimeDescription", getPeakTimeDescription(peakHour));
        
        // è®¡ç®—è®¿é—®é‡åˆ†å¸ƒ
        long totalVisits = hourlyData.values().stream()
            .mapToLong(Long::longValue).sum();
        
        Map<String, Object> distribution = new HashMap<>();
        distribution.put("morning", getMorningVisits(hourlyData)); // 6-12ç‚¹
        distribution.put("afternoon", getAfternoonVisits(hourlyData)); // 12-18ç‚¹  
        distribution.put("evening", getEveningVisits(hourlyData)); // 18-24ç‚¹
        distribution.put("night", getNightVisits(hourlyData)); // 0-6ç‚¹
        
        analysis.put("timeDistribution", distribution);
        analysis.put("totalVisits", totalVisits);
        
        return analysis;
    }
    
    private static String getPeakTimeDescription(int hour) {
        if (hour >= 6 && hour < 12) return "ä¸Šåˆæ—¶æ®µ";
        if (hour >= 12 && hour < 18) return "ä¸‹åˆæ—¶æ®µ";
        if (hour >= 18 && hour < 24) return "æ™šä¸Šæ—¶æ®µ";
        return "æ·±å¤œæ—¶æ®µ";
    }
    
    // ç”Ÿæˆæ¯å‘¨è®¿é—®è¶‹åŠ¿
    public static Map<String, Object> generateWeeklyTrend() {
        Map<String, Object> weeklyAnalysis = new HashMap<>();
        
        String[] weekdays = {"å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­", "å‘¨æ—¥"};
        Map<String, Long> weeklyVisits = new LinkedHashMap<>();
        
        for (int i = 0; i < 7; i++) {
            long visits = TimeAnalyticsManager.getWeeklyVisits()[i].get();
            weeklyVisits.put(weekdays[i], visits);
        }
        
        // æ‰¾å‡ºè®¿é—®é‡æœ€é«˜çš„ä¸€å¤©
        String peakDay = weeklyVisits.entrySet().stream()
            .max(Map.Entry.comparingByValue())
            .map(Map.Entry::getKey)
            .orElse("æœªçŸ¥");
        
        weeklyAnalysis.put("weeklyData", weeklyVisits);
        weeklyAnalysis.put("peakDay", peakDay);
        weeklyAnalysis.put("isWeekendPopular", 
            weeklyVisits.get("å‘¨å…­") + weeklyVisits.get("å‘¨æ—¥") > 
            weeklyVisits.values().stream().mapToLong(Long::longValue).sum() * 0.4);
        
        return weeklyAnalysis;
    }
}
```

---

## 6. ğŸŒ åœ°åŸŸåˆ†å¸ƒç»Ÿè®¡


### 6.1 åœ°åŸŸç»Ÿè®¡çš„å®ç°åŸç†


**ä»€ä¹ˆæ˜¯åœ°åŸŸåˆ†å¸ƒç»Ÿè®¡ï¼Ÿ**
å°±åƒçœ‹åœ°å›¾ä¸Šçš„çƒ­åŠ›å›¾ä¸€æ ·ï¼Œæˆ‘ä»¬æƒ³çŸ¥é“ç½‘ç«™çš„è®¿é—®è€…éƒ½æ¥è‡ªå“ªäº›åœ°æ–¹ã€‚è™½ç„¶è·å–ç²¾ç¡®ä½ç½®æ¯”è¾ƒå¤æ‚ï¼Œä½†æˆ‘ä»¬å¯ä»¥é€šè¿‡IPåœ°å€æ¥å¤§è‡´åˆ¤æ–­è®¿é—®è€…çš„åœ°ç†ä½ç½®ã€‚

```
ğŸ—ºï¸ åœ°åŸŸç»Ÿè®¡å±‚æ¬¡ï¼š
å›½å®¶çº§åˆ«: ä¸­å›½ã€ç¾å›½ã€æ—¥æœ¬...
çœå¸‚çº§åˆ«: åŒ—äº¬ã€ä¸Šæµ·ã€å¹¿ä¸œ...  
è¿è¥å•†: ç”µä¿¡ã€è”é€šã€ç§»åŠ¨...
ç½‘ç»œç±»å‹: å®¶åº­å®½å¸¦ã€ç§»åŠ¨ç½‘ç»œã€ä¼ä¸šä¸“çº¿...
```

### 6.2 IPåœ°å€è§£æå®ç°


**ğŸŒ åœ°åŸŸç»Ÿè®¡ç®¡ç†å™¨**ï¼š
```java
public class LocationAnalyticsManager {
    
    // å­˜å‚¨IPå½’å±åœ°ä¿¡æ¯
    public static class LocationInfo {
        private String country;
        private String province; 
        private String city;
        private String isp; // ç½‘ç»œæœåŠ¡å•†
        
        public LocationInfo(String country, String province, String city, String isp) {
            this.country = country;
            this.province = province;
            this.city = city;
            this.isp = isp;
        }
        // getterå’Œsetteræ–¹æ³•çœç•¥
    }
    
    // ç»Ÿè®¡å„åœ°åŸŸçš„è®¿é—®é‡
    private static ConcurrentHashMap<String, AtomicLong> countryStats = 
        new ConcurrentHashMap<>();
    private static ConcurrentHashMap<String, AtomicLong> provinceStats = 
        new ConcurrentHashMap<>();
    private static ConcurrentHashMap<String, AtomicLong> cityStats = 
        new ConcurrentHashMap<>();
    
    // è®°å½•åœ°åŸŸè®¿é—®
    public static void recordLocationVisit(String ip) {
        LocationInfo location = getLocationByIP(ip);
        
        if (location != null) {
            // ç»Ÿè®¡å›½å®¶è®¿é—®é‡
            countryStats.computeIfAbsent(location.getCountry(), 
                                       k -> new AtomicLong(0)).incrementAndGet();
            
            // ç»Ÿè®¡çœä»½è®¿é—®é‡
            provinceStats.computeIfAbsent(location.getProvince(), 
                                        k -> new AtomicLong(0)).incrementAndGet();
            
            // ç»Ÿè®¡åŸå¸‚è®¿é—®é‡
            cityStats.computeIfAbsent(location.getCity(), 
                                    k -> new AtomicLong(0)).incrementAndGet();
        }
    }
    
    // æ ¹æ®IPè·å–åœ°ç†ä½ç½®ï¼ˆç®€åŒ–å®ç°ï¼‰
    private static LocationInfo getLocationByIP(String ip) {
        // å®é™…é¡¹ç›®ä¸­å¯ä»¥ä½¿ç”¨ï¼š
        // 1. å…è´¹IPæ•°æ®åº“å¦‚GeoLite2
        // 2. ä»˜è´¹æœåŠ¡å¦‚è…¾è®¯ä½ç½®æœåŠ¡ã€ç™¾åº¦åœ°å›¾API
        // 3. ç¦»çº¿IPæ•°æ®åº“å¦‚ip2region
        
        // è¿™é‡Œæä¾›ä¸€ä¸ªç®€åŒ–çš„åˆ¤æ–­é€»è¾‘
        if (isLocalIP(ip)) {
            return new LocationInfo("ä¸­å›½", "æœ¬åœ°", "localhost", "å†…ç½‘");
        }
        
        // ç®€å•çš„IPæ®µåˆ¤æ–­ï¼ˆå®é™…åº”ç”¨ä¸­éœ€è¦ä½¿ç”¨ä¸“ä¸šçš„IPæ•°æ®åº“ï¼‰
        if (ip.startsWith("110.")) {
            return new LocationInfo("ä¸­å›½", "åŒ—äº¬", "åŒ—äº¬å¸‚", "è”é€š");
        } else if (ip.startsWith("183.")) {
            return new LocationInfo("ä¸­å›½", "å¹¿ä¸œ", "å¹¿å·å¸‚", "ç§»åŠ¨");
        }
        
        // é»˜è®¤è¿”å›æœªçŸ¥ä½ç½®
        return new LocationInfo("æœªçŸ¥", "æœªçŸ¥", "æœªçŸ¥", "æœªçŸ¥");
    }
    
    private static boolean isLocalIP(String ip) {
        return ip.equals("127.0.0.1") || ip.equals("localhost") || 
               ip.startsWith("192.168.") || ip.startsWith("10.") || 
               ip.startsWith("172.");
    }
}
```

### 6.3 åœ°åŸŸç»Ÿè®¡ç›‘å¬å™¨


**ğŸ“ åœ°åŸŸè®¿é—®ç›‘å¬å™¨**ï¼š
```java
@WebListener
public class LocationAnalyticsListener implements ServletRequestListener {
    
    @Override
    public void requestInitialized(ServletRequestEvent sre) {
        HttpServletRequest request = (HttpServletRequest) sre.getServletRequest();
        
        // åªç»Ÿè®¡é¡µé¢è®¿é—®
        if (shouldCountForLocation(request)) {
            String clientIP = getClientRealIP(request);
            
            // è®°å½•åœ°åŸŸè®¿é—®
            LocationAnalyticsManager.recordLocationVisit(clientIP);
            
            // å¼‚æ­¥è®°å½•è¯¦ç»†ä¿¡æ¯
            CompletableFuture.runAsync(() -> {
                recordDetailedLocationInfo(request, clientIP);
            });
        }
    }
    
    // è·å–ç”¨æˆ·çœŸå®IPï¼ˆå¤„ç†ä»£ç†å’Œè´Ÿè½½å‡è¡¡æƒ…å†µï¼‰
    private String getClientRealIP(HttpServletRequest request) {
        String ip = null;
        
        // é¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰ä»£ç†
        ip = request.getHeader("X-Forwarded-For");
        if (ip != null && !ip.isEmpty() && !"unknown".equalsIgnoreCase(ip)) {
            // X-Forwarded-Forå¯èƒ½åŒ…å«å¤šä¸ªIPï¼Œå–ç¬¬ä¸€ä¸ª
            int index = ip.indexOf(',');
            if (index != -1) {
                ip = ip.substring(0, index);
            }
        }
        
        // æ£€æŸ¥å…¶ä»–å¯èƒ½çš„å¤´éƒ¨
        if (ip == null || ip.isEmpty() || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getHeader("X-Real-IP");
        }
        
        if (ip == null || ip.isEmpty() || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getHeader("Proxy-Client-IP");
        }
        
        if (ip == null || ip.isEmpty() || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getRemoteAddr();
        }
        
        return ip != null ? ip.trim() : "unknown";
    }
    
    private void recordDetailedLocationInfo(HttpServletRequest request, String ip) {
        // è®°å½•è¯¦ç»†çš„è®¿é—®ä¿¡æ¯
        LocationVisitRecord record = new LocationVisitRecord();
        record.setIp(ip);
        record.setVisitTime(new Date());
        record.setPagePath(request.getRequestURI());
        record.setUserAgent(request.getHeader("User-Agent"));
        record.setReferer(request.getHeader("Referer"));
        
        // ä¿å­˜åˆ°æ•°æ®åº“æˆ–ç¼“å­˜ä¸­
        LocationRecordManager.saveRecord(record);
    }
}
```

### 6.4 åœ°åŸŸåˆ†å¸ƒåˆ†æå’Œå¯è§†åŒ–


**ğŸ—ºï¸ åœ°åŸŸåˆ†ææŠ¥å‘Šç”Ÿæˆ**ï¼š
```java
public class LocationAnalysisReporter {
    
    // ç”Ÿæˆåœ°åŸŸåˆ†å¸ƒæŠ¥å‘Š
    public static Map<String, Object> generateLocationReport() {
        Map<String, Object> report = new HashMap<>();
        
        // è·å–è®¿é—®é‡å‰10çš„åŸå¸‚
        List<Map.Entry<String, Long>> topCities = 
            LocationAnalyticsManager.getCityStats().entrySet().stream()
                .map(entry -> new AbstractMap.SimpleEntry<>(
                    entry.getKey(), entry.getValue().get()))
                .sorted(Map.Entry.<String, Long>comparingByValue().reversed())
                .limit(10)
                .collect(Collectors.toList());
        
        // è®¡ç®—åœ°åŸŸè®¿é—®å æ¯”
        long totalVisits = topCities.stream()
            .mapToLong(Map.Entry::getValue)
            .sum();
        
        List<Map<String, Object>> cityAnalysis = topCities.stream()
            .map(entry -> {
                Map<String, Object> cityInfo = new HashMap<>();
                cityInfo.put("city", entry.getKey());
                cityInfo.put("visits", entry.getValue());
                cityInfo.put("percentage", 
                    String.format("%.1f%%", (double)entry.getValue() / totalVisits * 100));
                return cityInfo;
            })
            .collect(Collectors.toList());
        
        report.put("topCities", cityAnalysis);
        report.put("totalVisits", totalVisits);
        
        // åˆ†æè®¿é—®æ¥æºåˆ†å¸ƒ
        Map<String, Object> sourceAnalysis = analyzeVisitSources();
        report.put("sourceAnalysis", sourceAnalysis);
        
        // ç”Ÿæˆå»ºè®®
        List<String> suggestions = generateLocationSuggestions(topCities);
        report.put("suggestions", suggestions);
        
        return report;
    }
    
    private static Map<String, Object> analyzeVisitSources() {
        Map<String, Object> analysis = new HashMap<>();
        
        // åˆ†æå›½å†…å¤–è®¿é—®æ¯”ä¾‹
        long domesticVisits = LocationAnalyticsManager.getCountryStats()
            .getOrDefault("ä¸­å›½", new AtomicLong(0)).get();
        long totalCountryVisits = LocationAnalyticsManager.getCountryStats()
            .values().stream().mapToLong(AtomicLong::get).sum();
        long foreignVisits = totalCountryVisits - domesticVisits;
        
        analysis.put("domestic", domesticVisits);
        analysis.put("foreign", foreignVisits);
        analysis.put("domesticPercentage", 
            String.format("%.1f%%", (double)domesticVisits / totalCountryVisits * 100));
        
        return analysis;
    }
    
    private static List<String> generateLocationSuggestions(
            List<Map.Entry<String, Long>> topCities) {
        List<String> suggestions = new ArrayList<>();
        
        if (!topCities.isEmpty()) {
            String topCity = topCities.get(0).getKey();
            suggestions.add("ä¸»è¦è®¿é—®æ¥æºæ˜¯" + topCity + "ï¼Œå¯ä»¥è€ƒè™‘é’ˆå¯¹è¯¥åœ°åŒºä¼˜åŒ–å†…å®¹");
        }
        
        if (topCities.size() >= 3) {
            suggestions.add("è®¿é—®æ¥æºè¾ƒä¸ºåˆ†æ•£ï¼Œå»ºè®®å®æ–½å·®å¼‚åŒ–çš„åœ°åŸŸè¥é”€ç­–ç•¥");
        }
        
        suggestions.add("å»ºè®®æ ¹æ®ä¸»è¦è®¿é—®åœ°åŒºçš„æ—¶åŒºä¼˜åŒ–å†…å®¹æ›´æ–°æ—¶é—´");
        suggestions.add("å¯è€ƒè™‘åœ¨è®¿é—®é‡å¤§çš„åœ°åŒºéƒ¨ç½²CDNèŠ‚ç‚¹ä»¥æå‡è®¿é—®é€Ÿåº¦");
        
        return suggestions;
    }
}
```

---

## 7. ğŸ’¾ æ•°æ®æŒä¹…åŒ–å­˜å‚¨


### 7.1 ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®æŒä¹…åŒ–


**æ•°æ®æŒä¹…åŒ–çš„é‡è¦æ€§**ï¼š
æƒ³è±¡ä½ è¾›è‹¦æ”¶é›†çš„ç»Ÿè®¡æ•°æ®å°±åƒçè´µçš„ç…§ç‰‡ä¸€æ ·ï¼Œå¦‚æœåªå­˜åœ¨å†…å­˜ä¸­ï¼ŒæœåŠ¡å™¨ä¸€é‡å¯å°±å…¨éƒ¨ä¸¢å¤±äº†ã€‚æ•°æ®æŒä¹…åŒ–å°±åƒç»™æ•°æ®æ‰¾ä¸ª"ä¿é™©ç®±"ï¼Œç¡®ä¿æ•°æ®å®‰å…¨ä¿å­˜ã€‚

```
ğŸ’¡ æ•°æ®æŒä¹…åŒ–çš„å¥½å¤„ï¼š
âœ… æ•°æ®å®‰å…¨ï¼šæœåŠ¡å™¨é‡å¯ä¸ä¸¢å¤±å†å²æ•°æ®
âœ… å†å²åˆ†æï¼šå¯ä»¥åˆ†æé•¿æœŸçš„è®¿é—®è¶‹åŠ¿  
âœ… æŠ¥è¡¨ç”Ÿæˆï¼šåŸºäºå†å²æ•°æ®ç”Ÿæˆå„ç§æŠ¥å‘Š
âœ… æ•°æ®å¤‡ä»½ï¼šå®šæœŸå¤‡ä»½é˜²æ­¢æ•°æ®ä¸¢å¤±
âœ… æ€§èƒ½ä¼˜åŒ–ï¼šä»æ•°æ®åº“æŸ¥è¯¢æ¯”ä»å†…å­˜é‡æ–°è®¡ç®—æ›´å¿«
```

### 7.2 æ•°æ®åº“è¡¨ç»“æ„è®¾è®¡


**ğŸ—„ï¸ è®¿é—®ç»Ÿè®¡è¡¨è®¾è®¡**ï¼š
```sql
-- é¡µé¢è®¿é—®è®°å½•è¡¨
CREATE TABLE page_visit_log (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    session_id VARCHAR(64) NOT NULL COMMENT 'ä¼šè¯ID',
    client_ip VARCHAR(45) NOT NULL COMMENT 'å®¢æˆ·ç«¯IP',
    page_path VARCHAR(255) NOT NULL COMMENT 'é¡µé¢è·¯å¾„',
    visit_time DATETIME NOT NULL COMMENT 'è®¿é—®æ—¶é—´',
    user_agent TEXT COMMENT 'æµè§ˆå™¨ä¿¡æ¯',
    referer VARCHAR(255) COMMENT 'æ¥æºé¡µé¢',
    stay_duration INT DEFAULT 0 COMMENT 'åœç•™æ—¶é•¿(ç§’)',
    location_country VARCHAR(50) COMMENT 'è®¿é—®å›½å®¶',
    location_province VARCHAR(50) COMMENT 'è®¿é—®çœä»½',  
    location_city VARCHAR(50) COMMENT 'è®¿é—®åŸå¸‚',
    INDEX idx_visit_time (visit_time),
    INDEX idx_page_path (page_path),
    INDEX idx_client_ip (client_ip)
);

-- é¡µé¢è®¿é—®ç»Ÿè®¡æ±‡æ€»è¡¨
CREATE TABLE page_stats_summary (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    page_path VARCHAR(255) NOT NULL UNIQUE COMMENT 'é¡µé¢è·¯å¾„',
    total_visits BIGINT DEFAULT 0 COMMENT 'æ€»è®¿é—®é‡',
    unique_visitors BIGINT DEFAULT 0 COMMENT 'ç‹¬ç«‹è®¿å®¢æ•°',
    avg_stay_duration DECIMAL(10,2) DEFAULT 0 COMMENT 'å¹³å‡åœç•™æ—¶é•¿',
    last_visit_time DATETIME COMMENT 'æœ€åè®¿é—®æ—¶é—´',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- æ—¶é—´ç»´åº¦ç»Ÿè®¡è¡¨
CREATE TABLE time_stats (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    stat_date DATE NOT NULL COMMENT 'ç»Ÿè®¡æ—¥æœŸ',
    stat_hour TINYINT NOT NULL COMMENT 'å°æ—¶(0-23)',
    visit_count BIGINT DEFAULT 0 COMMENT 'è®¿é—®é‡',
    unique_count BIGINT DEFAULT 0 COMMENT 'ç‹¬ç«‹è®¿å®¢',
    UNIQUE KEY uk_date_hour (stat_date, stat_hour)
);
```

### 7.3 æ•°æ®æŒä¹…åŒ–å®ç°


**ğŸ’½ æ•°æ®è®¿é—®å±‚å®ç°**ï¼š
```java
// æ•°æ®è®¿é—®å¯¹è±¡
public class AnalyticsDAO {
    private DataSource dataSource;
    
    public AnalyticsDAO(DataSource dataSource) {
        this.dataSource = dataSource;
    }
    
    // ä¿å­˜è®¿é—®è®°å½•
    public void saveVisitLog(PageVisitRecord record) {
        String sql = """
            INSERT INTO page_visit_log 
            (session_id, client_ip, page_path, visit_time, user_agent, referer, 
             location_country, location_province, location_city)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
            """;
        
        try (Connection conn = dataSource.getConnection();
             PreparedStatement ps = conn.prepareStatement(sql)) {
            
            ps.setString(1, record.getSessionId());
            ps.setString(2, record.getClientIp());
            ps.setString(3, record.getPagePath());
            ps.setTimestamp(4, new Timestamp(record.getVisitTime().getTime()));
            ps.setString(5, record.getUserAgent());
            ps.setString(6, record.getReferer());
            ps.setString(7, record.getLocationCountry());
            ps.setString(8, record.getLocationProvince());
            ps.setString(9, record.getLocationCity());
            
            ps.executeUpdate();
            
        } catch (SQLException e) {
            // è®°å½•æ—¥å¿—ï¼Œä½†ä¸å½±å“ç”¨æˆ·è®¿é—®
            logger.error("ä¿å­˜è®¿é—®è®°å½•å¤±è´¥", e);
        }
    }
    
    // æ›´æ–°é¡µé¢ç»Ÿè®¡æ±‡æ€»
    public void updatePageStats(String pagePath) {
        String sql = """
            INSERT INTO page_stats_summary (page_path, total_visits, last_visit_time)
            VALUES (?, 1, NOW())
            ON DUPLICATE KEY UPDATE 
                total_visits = total_visits + 1,
                last_visit_time = NOW()
            """;
        
        try (Connection conn = dataSource.getConnection();
             PreparedStatement ps = conn.prepareStatement(sql)) {
            
            ps.setString(1, pagePath);
            ps.executeUpdate();
            
        } catch (SQLException e) {
            logger.error("æ›´æ–°é¡µé¢ç»Ÿè®¡å¤±è´¥", e);
        }
    }
}
```

### 7.4 å¼‚æ­¥æ•°æ®ä¿å­˜


**âš¡ å¼‚æ­¥æŒä¹…åŒ–ç›‘å¬å™¨**ï¼š
```java
@WebListener
public class AsyncPersistenceListener implements ServletRequestListener {
    
    // çº¿ç¨‹æ± ç”¨äºå¼‚æ­¥å¤„ç†æ•°æ®ä¿å­˜
    private static final ExecutorService executorService = 
        Executors.newFixedThreadPool(5);
    
    @Override
    public void requestInitialized(ServletRequestEvent sre) {
        HttpServletRequest request = (HttpServletRequest) sre.getServletRequest();
        
        if (shouldPersist(request)) {
            // åˆ›å»ºè®¿é—®è®°å½•
            PageVisitRecord record = createVisitRecord(request);
            
            // å¼‚æ­¥ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆä¸é˜»å¡ç”¨æˆ·è¯·æ±‚ï¼‰
            executorService.submit(() -> {
                try {
                    AnalyticsDAO dao = new AnalyticsDAO(getDataSource());
                    dao.saveVisitLog(record);
                    dao.updatePageStats(record.getPagePath());
                } catch (Exception e) {
                    logger.error("å¼‚æ­¥ä¿å­˜è®¿é—®æ•°æ®å¤±è´¥", e);
                }
            });
        }
    }
    
    private PageVisitRecord createVisitRecord(HttpServletRequest request) {
        PageVisitRecord record = new PageVisitRecord();
        record.setSessionId(request.getSession().getId());
        record.setClientIp(getClientIP(request));
        record.setPagePath(request.getRequestURI());
        record.setVisitTime(new Date());
        record.setUserAgent(request.getHeader("User-Agent"));
        record.setReferer(request.getHeader("Referer"));
        
        // è·å–åœ°ç†ä½ç½®ä¿¡æ¯
        LocationInfo location = LocationAnalyticsManager
            .getLocationByIP(record.getClientIp());
        if (location != null) {
            record.setLocationCountry(location.getCountry());
            record.setLocationProvince(location.getProvince());
            record.setLocationCity(location.getCity());
        }
        
        return record;
    }
    
    // åº”ç”¨å…³é—­æ—¶ä¼˜é›…å…³é—­çº¿ç¨‹æ± 
    @Override
    public void contextDestroyed(ServletContextEvent sce) {
        executorService.shutdown();
        try {
            if (!executorService.awaitTermination(30, TimeUnit.SECONDS)) {
                executorService.shutdownNow();
            }
        } catch (InterruptedException e) {
            executorService.shutdownNow();
        }
    }
}
```

### 7.5 æ•°æ®æŸ¥è¯¢å’Œåˆ†æ


**ğŸ“Š æ•°æ®æŸ¥è¯¢æœåŠ¡**ï¼š
```java
public class AnalyticsQueryService {
    
    private AnalyticsDAO analyticsDAO;
    
    // è·å–æŒ‡å®šæ—¶é—´æ®µçš„è®¿é—®ç»Ÿè®¡
    public Map<String, Object> getVisitStatsByDateRange(Date startDate, Date endDate) {
        String sql = """
            SELECT 
                DATE(visit_time) as visit_date,
                COUNT(*) as visit_count,
                COUNT(DISTINCT client_ip) as unique_visitors
            FROM page_visit_log 
            WHERE visit_time BETWEEN ? AND ?
            GROUP BY DATE(visit_time)
            ORDER BY visit_date
            """;
        
        Map<String, Object> result = new HashMap<>();
        List<Map<String, Object>> dailyStats = new ArrayList<>();
        
        try (Connection conn = dataSource.getConnection();
             PreparedStatement ps = conn.prepareStatement(sql)) {
            
            ps.setTimestamp(1, new Timestamp(startDate.getTime()));
            ps.setTimestamp(2, new Timestamp(endDate.getTime()));
            
            ResultSet rs = ps.executeQuery();
            long totalVisits = 0;
            long totalUniqueVisitors = 0;
            
            while (rs.next()) {
                Map<String, Object> dayStats = new HashMap<>();
                dayStats.put("date", rs.getString("visit_date"));
                dayStats.put("visits", rs.getLong("visit_count"));
                dayStats.put("uniqueVisitors", rs.getLong("unique_visitors"));
                
                dailyStats.add(dayStats);
                totalVisits += rs.getLong("visit_count");
                totalUniqueVisitors += rs.getLong("unique_visitors");
            }
            
            result.put("dailyStats", dailyStats);
            result.put("totalVisits", totalVisits);
            result.put("averageUniqueVisitors", totalUniqueVisitors / dailyStats.size());
            
        } catch (SQLException e) {
            logger.error("æŸ¥è¯¢è®¿é—®ç»Ÿè®¡å¤±è´¥", e);
        }
        
        return result;
    }
    
    // è·å–çƒ­é—¨é¡µé¢æ’è¡Œ
    public List<Map<String, Object>> getTopPagesByVisits(int limit) {
        String sql = """
            SELECT page_path, total_visits, unique_visitors, 
                   avg_stay_duration, last_visit_time
            FROM page_stats_summary 
            ORDER BY total_visits DESC 
            LIMIT ?
            """;
        
        List<Map<String, Object>> topPages = new ArrayList<>();
        
        try (Connection conn = dataSource.getConnection();
             PreparedStatement ps = conn.prepareStatement(sql)) {
            
            ps.setInt(1, limit);
            ResultSet rs = ps.executeQuery();
            
            while (rs.next()) {
                Map<String, Object> pageStats = new HashMap<>();
                pageStats.put("pagePath", rs.getString("page_path"));
                pageStats.put("visits", rs.getLong("total_visits"));
                pageStats.put("uniqueVisitors", rs.getLong("unique_visitors"));
                pageStats.put("avgStayTime", rs.getDouble("avg_stay_duration"));
                pageStats.put("lastVisit", rs.getTimestamp("last_visit_time"));
                
                topPages.add(pageStats);
            }
            
        } catch (SQLException e) {
            logger.error("æŸ¥è¯¢çƒ­é—¨é¡µé¢å¤±è´¥", e);
        }
        
        return topPages;
    }
}
```

---

## 8. ğŸ“ˆ å®æ—¶æŠ¥è¡¨ç”Ÿæˆ


### 8.1 å®æ—¶æŠ¥è¡¨çš„éœ€æ±‚


**ä»€ä¹ˆæ˜¯å®æ—¶æŠ¥è¡¨ï¼Ÿ**
å°±åƒè‚¡ç¥¨äº¤æ˜“å¤§å…çš„æ˜¾ç¤ºå±ä¸€æ ·ï¼Œå®æ—¶æŠ¥è¡¨èƒ½å¤Ÿå³æ—¶æ˜¾ç¤ºç½‘ç«™çš„è®¿é—®æƒ…å†µï¼Œè®©ç®¡ç†å‘˜éšæ—¶äº†è§£ç½‘ç«™çŠ¶æ€ã€‚

```
ğŸ“Š å®æ—¶æŠ¥è¡¨çš„ä»·å€¼ï¼š
âœ… å³æ—¶ç›‘æ§ï¼šå‘ç°å¼‚å¸¸è®¿é—®ç«‹å³å¤„ç†
âœ… è¿è¥å†³ç­–ï¼šæ ¹æ®å®æ—¶æ•°æ®è°ƒæ•´è¥é”€ç­–ç•¥
âœ… æ€§èƒ½ç›‘æ§ï¼šç›‘æ§æœåŠ¡å™¨è´Ÿè½½å’Œå“åº”æ—¶é—´
âœ… ç”¨æˆ·ä½“éªŒï¼šäº†è§£ç”¨æˆ·å½“å‰çš„è¡Œä¸ºæ¨¡å¼
âœ… æ•…éšœé¢„è­¦ï¼šè®¿é—®é‡å¼‚å¸¸æ—¶åŠæ—¶å‘Šè­¦
```

### 8.2 å®æ—¶æ•°æ®æ”¶é›†å™¨


**âš¡ å®æ—¶ç»Ÿè®¡æ•°æ®ç®¡ç†å™¨**ï¼š
```java
@Component
public class RealtimeStatsManager {
    
    // å®æ—¶ç»Ÿè®¡æ•°æ®
    private static class RealtimeStats {
        private AtomicLong currentOnlineUsers = new AtomicLong(0);
        private AtomicLong todayTotalVisits = new AtomicLong(0);
        private AtomicLong todayUniqueVisitors = new AtomicLong(0);
        private ConcurrentHashMap<String, AtomicLong> currentPageViews = 
            new ConcurrentHashMap<>();
        private Queue<PageAccessRecord> recentAccess = 
            new ConcurrentLinkedQueue<>();
        
        // getteræ–¹æ³•çœç•¥
    }
    
    private static final RealtimeStats stats = new RealtimeStats();
    
    // è®°å½•é¡µé¢è®¿é—®
    public static void recordPageAccess(String pagePath, String clientIP, 
                                       String sessionId) {
        // æ›´æ–°ä»Šæ—¥æ€»è®¿é—®é‡
        stats.todayTotalVisits.incrementAndGet();
        
        // æ›´æ–°é¡µé¢å®æ—¶è®¿é—®é‡
        stats.currentPageViews.computeIfAbsent(pagePath, k -> new AtomicLong(0))
                              .incrementAndGet();
        
        // è®°å½•æœ€è¿‘è®¿é—®è®°å½•ï¼ˆä¿ç•™æœ€è¿‘100æ¡ï¼‰
        PageAccessRecord record = new PageAccessRecord(
            pagePath, clientIP, sessionId, System.currentTimeMillis());
        
        stats.recentAccess.offer(record);
        
        // æ¸…ç†è¿‡æœŸè®°å½•ï¼Œåªä¿ç•™æœ€è¿‘5åˆ†é’Ÿçš„
        long fiveMinutesAgo = System.currentTimeMillis() - 5 * 60 * 1000;
        stats.recentAccess.removeIf(r -> r.getAccessTime() < fiveMinutesAgo);
    }
    
    // è·å–å®æ—¶ç»Ÿè®¡å¿«ç…§
    public static Map<String, Object> getCurrentStats() {
        Map<String, Object> currentStats = new HashMap<>();
        
        // åŸºæœ¬ç»Ÿè®¡
        currentStats.put("onlineUsers", SessionManager.getActiveSessionCount());
        currentStats.put("todayVisits", stats.todayTotalVisits.get());
        currentStats.put("recentAccessCount", stats.recentAccess.size());
        
        // å½“å‰çƒ­é—¨é¡µé¢ï¼ˆæœ€è¿‘5åˆ†é’Ÿè®¿é—®é‡ï¼‰
        Map<String, Long> recentPageViews = calculateRecentPageViews();
        currentStats.put("hotPages", recentPageViews);
        
        // è®¿é—®è¶‹åŠ¿ï¼ˆæ¯åˆ†é’Ÿè®¿é—®é‡ï¼‰
        List<Map<String, Object>> minuteTrend = calculateMinuteTrend();
        currentStats.put("minuteTrend", minuteTrend);
        
        currentStats.put("timestamp", System.currentTimeMillis());
        
        return currentStats;
    }
    
    private static Map<String, Long> calculateRecentPageViews() {
        long fiveMinutesAgo = System.currentTimeMillis() - 5 * 60 * 1000;
        
        return stats.recentAccess.stream()
            .filter(record -> record.getAccessTime() >= fiveMinutesAgo)
            .collect(Collectors.groupingBy(
                PageAccessRecord::getPagePath,
                Collectors.counting()
            ))
            .entrySet().stream()
            .sorted(Map.Entry.<String, Long>comparingByValue().reversed())
            .limit(5)
            .collect(LinkedHashMap::new, 
                    (map, entry) -> map.put(entry.getKey(), entry.getValue()),
                    LinkedHashMap::putAll);
    }
}
```

### 8.3 æŠ¥è¡¨ç”ŸæˆæœåŠ¡


**ğŸ“Š å®æ—¶æŠ¥è¡¨ç”Ÿæˆå™¨**ï¼š
```java
@Service
public class ReportGeneratorService {
    
    // ç”Ÿæˆå®æ—¶æ•°æ®æŠ¥è¡¨
    public String generateRealtimeReport() {
        Map<String, Object> stats = RealtimeStatsManager.getCurrentStats();
        
        StringBuilder report = new StringBuilder();
        report.append("=== ç½‘ç«™å®æ—¶è®¿é—®æŠ¥è¡¨ ===\n");
        report.append("ç”Ÿæˆæ—¶é—´: ").append(new Date()).append("\n\n");
        
        // åŸºç¡€ç»Ÿè®¡
        report.append("ğŸ“Š å®æ—¶ç»Ÿè®¡:\n");
        report.append("å½“å‰åœ¨çº¿ç”¨æˆ·: ").append(stats.get("onlineUsers")).append(" äºº\n");
        report.append("ä»Šæ—¥æ€»è®¿é—®é‡: ").append(stats.get("todayVisits")).append(" æ¬¡\n");
        report.append("æœ€è¿‘5åˆ†é’Ÿè®¿é—®: ").append(stats.get("recentAccessCount")).append(" æ¬¡\n\n");
        
        // çƒ­é—¨é¡µé¢
        report.append("ğŸ”¥ å®æ—¶çƒ­é—¨é¡µé¢:\n");
        Map<String, Long> hotPages = (Map<String, Long>) stats.get("hotPages");
        int rank = 1;
        for (Map.Entry<String, Long> entry : hotPages.entrySet()) {
            report.append(String.format("%d. %s (%dæ¬¡è®¿é—®)\n", 
                rank++, entry.getKey(), entry.getValue()));
        }
        
        // è®¿é—®è¶‹åŠ¿
        report.append("\nğŸ“ˆ æœ€è¿‘è®¿é—®è¶‹åŠ¿:\n");
        List<Map<String, Object>> trend = 
            (List<Map<String, Object>>) stats.get("minuteTrend");
        
        for (Map<String, Object> minute : trend) {
            report.append(String.format("%s: %dæ¬¡è®¿é—®\n", 
                minute.get("time"), minute.get("count")));
        }
        
        return report.toString();
    }
    
    // ç”ŸæˆJSONæ ¼å¼çš„å®æ—¶æ•°æ®ï¼ˆä¾›å‰ç«¯ä½¿ç”¨ï¼‰
    public String generateRealtimeJSON() {
        Map<String, Object> stats = RealtimeStatsManager.getCurrentStats();
        
        // æ·»åŠ ä¸€äº›é¢å¤–çš„åˆ†ææ•°æ®
        stats.put("serverStatus", "æ­£å¸¸");
        stats.put("avgResponseTime", calculateAvgResponseTime());
        stats.put("errorRate", calculateErrorRate());
        
        // è½¬æ¢ä¸ºJSONè¿”å›
        return new JSONObject(stats).toString();
    }
    
    private double calculateAvgResponseTime() {
        // è¿™é‡Œå¯ä»¥é›†æˆåº”ç”¨æ€§èƒ½ç›‘æ§æ•°æ®
        // ç®€åŒ–å®ç°ï¼Œè¿”å›æ¨¡æ‹Ÿæ•°æ®
        return 120.5; // æ¯«ç§’
    }
    
    private double calculateErrorRate() {
        // è®¡ç®—é”™è¯¯ç‡
        return 0.02; // 2%
    }
}
```

### 8.4 å®æ—¶æŠ¥è¡¨å±•ç¤º


**ğŸŒ å®æ—¶æ•°æ®æ¥å£**ï¼š
```java
@WebServlet("/analytics/realtime")
public class RealtimeAnalyticsServlet extends HttpServlet {
    
    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) 
            throws ServletException, IOException {
        
        response.setContentType("application/json;charset=UTF-8");
        response.setHeader("Cache-Control", "no-cache");
        response.setHeader("Access-Control-Allow-Origin", "*");
        
        String format = request.getParameter("format");
        ReportGeneratorService reportService = new ReportGeneratorService();
        
        String result;
        if ("text".equals(format)) {
            result = reportService.generateRealtimeReport();
            response.setContentType("text/plain;charset=UTF-8");
        } else {
            result = reportService.generateRealtimeJSON();
        }
        
        response.getWriter().write(result);
    }
}

// ç”¨äºWebSocketå®æ—¶æ¨é€çš„ç«¯ç‚¹
@ServerEndpoint("/realtime-stats")
public class RealtimeStatsWebSocket {
    
    private static Set<Session> sessions = 
        Collections.synchronizedSet(new HashSet<>());
    
    @OnOpen
    public void onOpen(Session session) {
        sessions.add(session);
        // ç«‹å³å‘é€å½“å‰ç»Ÿè®¡æ•°æ®
        sendCurrentStats(session);
    }
    
    @OnClose
    public void onClose(Session session) {
        sessions.remove(session);
    }
    
    // å®šæ—¶æ¨é€å®æ—¶æ•°æ®
    @Scheduled(fixedRate = 5000) // æ¯5ç§’æ¨é€ä¸€æ¬¡
    public void broadcastStats() {
        String statsJSON = new ReportGeneratorService().generateRealtimeJSON();
        
        synchronized (sessions) {
            sessions.removeIf(session -> !session.isOpen());
            
            for (Session session : sessions) {
                try {
                    session.getBasicRemote().sendText(statsJSON);
                } catch (IOException e) {
                    logger.error("æ¨é€å®æ—¶æ•°æ®å¤±è´¥", e);
                }
            }
        }
    }
    
    private void sendCurrentStats(Session session) {
        try {
            String currentStats = new ReportGeneratorService().generateRealtimeJSON();
            session.getBasicRemote().sendText(currentStats);
        } catch (IOException e) {
            logger.error("å‘é€å½“å‰ç»Ÿè®¡æ•°æ®å¤±è´¥", e);
        }
    }
}
```

### 8.5 å®æ—¶æŠ¥è¡¨ä¼˜åŒ–ç­–ç•¥


**âš¡ æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
```java
public class RealtimeStatsOptimizer {
    
    // ä½¿ç”¨ç¼“å­˜å‡å°‘é‡å¤è®¡ç®—
    private static final Cache<String, Map<String, Object>> statsCache = 
        CacheBuilder.newBuilder()
            .expireAfterWrite(30, TimeUnit.SECONDS) // 30ç§’è¿‡æœŸ
            .maximumSize(100)
            .build();
    
    // è·å–ç¼“å­˜çš„ç»Ÿè®¡æ•°æ®
    public static Map<String, Object> getCachedStats() {
        try {
            return statsCache.get("current_stats", () -> {
                return RealtimeStatsManager.getCurrentStats();
            });
        } catch (ExecutionException e) {
            logger.error("è·å–ç¼“å­˜ç»Ÿè®¡æ•°æ®å¤±è´¥", e);
            return RealtimeStatsManager.getCurrentStats();
        }
    }
    
    // æ‰¹é‡å¤„ç†è®¿é—®è®°å½•ï¼ˆæé«˜æ€§èƒ½ï¼‰
    public static class BatchProcessor {
        private Queue<PageAccessRecord> pendingRecords = 
            new ConcurrentLinkedQueue<>();
        private ScheduledExecutorService scheduler = 
            Executors.newScheduledThreadPool(2);
        
        public BatchProcessor() {
            // æ¯ç§’æ‰¹é‡å¤„ç†ä¸€æ¬¡
            scheduler.scheduleAtFixedRate(this::processBatch, 
                1, 1, TimeUnit.SECONDS);
        }
        
        public void addRecord(PageAccessRecord record) {
            pendingRecords.offer(record);
        }
        
        private void processBatch() {
            List<PageAccessRecord> batch = new ArrayList<>();
            
            // å–å‡ºæ‰€æœ‰å¾…å¤„ç†è®°å½•
            PageAccessRecord record;
            while ((record = pendingRecords.poll()) != null) {
                batch.add(record);
            }
            
            if (!batch.isEmpty()) {
                // æ‰¹é‡æ›´æ–°ç»Ÿè®¡æ•°æ®
                updateStatsBatch(batch);
            }
        }
        
        private void updateStatsBatch(List<PageAccessRecord> records) {
            Map<String, Long> pageViewCounts = records.stream()
                .collect(Collectors.groupingBy(
                    PageAccessRecord::getPagePath,
                    Collectors.counting()));
            
            // æ‰¹é‡æ›´æ–°é¡µé¢è®¿é—®é‡
            pageViewCounts.forEach((page, count) -> {
                RealtimeStatsManager.addPageViews(page, count);
            });
        }
    }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ”¸ è®¿é—®ç»Ÿè®¡ç³»ç»Ÿï¼šé€šè¿‡ç›‘å¬å™¨è‡ªåŠ¨æ”¶é›†ç½‘ç«™è®¿é—®æ•°æ®çš„ç³»ç»Ÿ
ğŸ”¸ é¡µé¢è®¿é—®é‡ï¼šè®°å½•æ¯ä¸ªé¡µé¢è¢«è®¿é—®çš„æ¬¡æ•°å’Œé¢‘ç‡
ğŸ”¸ ç”¨æˆ·è¡Œä¸ºè½¨è¿¹ï¼šè¿½è¸ªç”¨æˆ·åœ¨ç½‘ç«™ä¸Šçš„æµè§ˆè·¯å¾„å’Œåœç•™æ—¶é—´
ğŸ”¸ çƒ­é—¨é¡µé¢æ’è¡Œï¼šæ ¹æ®è®¿é—®é‡å¯¹é¡µé¢è¿›è¡Œæ’ååˆ†æ
ğŸ”¸ æ—¶é—´åˆ†å¸ƒåˆ†æï¼šç»Ÿè®¡ä¸åŒæ—¶é—´æ®µçš„è®¿é—®é‡å˜åŒ–è§„å¾‹
ğŸ”¸ åœ°åŸŸåˆ†å¸ƒç»Ÿè®¡ï¼šåˆ†æè®¿é—®è€…çš„åœ°ç†ä½ç½®åˆ†å¸ƒæƒ…å†µ
ğŸ”¸ æ•°æ®æŒä¹…åŒ–ï¼šå°†ç»Ÿè®¡æ•°æ®ä¿å­˜åˆ°æ•°æ®åº“ä¸­ç¡®ä¿ä¸ä¸¢å¤±
ğŸ”¸ å®æ—¶æŠ¥è¡¨ï¼šå³æ—¶å±•ç¤ºå½“å‰çš„è®¿é—®çŠ¶å†µå’Œè¶‹åŠ¿
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆç”¨ç›‘å¬å™¨åšè®¿é—®ç»Ÿè®¡**ï¼š
```
ä¼˜åŠ¿åˆ†æï¼š
â€¢ è‡ªåŠ¨è§¦å‘ï¼šæ— éœ€æ‰‹åŠ¨è°ƒç”¨ï¼Œè®¿é—®æ—¶è‡ªåŠ¨æ‰§è¡Œ
â€¢ å…¨é¢è¦†ç›–ï¼šèƒ½æ•è·æ‰€æœ‰HTTPè¯·æ±‚ï¼Œä¸ä¼šé—æ¼
â€¢ æ€§èƒ½è¾ƒå¥½ï¼šåœ¨æœåŠ¡å™¨å†…éƒ¨å¤„ç†ï¼Œå“åº”é€Ÿåº¦å¿«
â€¢ å®ç°ç®€å•ï¼šé€šè¿‡ç›‘å¬å™¨æ¥å£ï¼Œä»£ç ç»“æ„æ¸…æ™°

å¯¹æ¯”å…¶ä»–æ–¹æ¡ˆï¼š
â€¢ Filteræ–¹å¼ï¼šåŠŸèƒ½ç±»ä¼¼ï¼Œä½†ä¸»è¦ç”¨äºè¯·æ±‚å¤„ç†é“¾
â€¢ AOPåˆ‡é¢ï¼šéœ€è¦Springæ¡†æ¶æ”¯æŒï¼Œç›¸å¯¹å¤æ‚
â€¢ æ‰‹åŠ¨åŸ‹ç‚¹ï¼šå®¹æ˜“é—æ¼ï¼Œç»´æŠ¤æˆæœ¬é«˜
â€¢ ç¬¬ä¸‰æ–¹å·¥å…·ï¼šå¦‚Google Analyticsï¼Œä½†æ•°æ®åœ¨å¤–éƒ¨
```

**ğŸ”¹ æ•°æ®ç»Ÿè®¡çš„æ ¸å¿ƒæŒ‘æˆ˜**ï¼š
```
æŠ€æœ¯æŒ‘æˆ˜ï¼š
â€¢ å¹¶å‘å®‰å…¨ï¼šå¤šç”¨æˆ·åŒæ—¶è®¿é—®æ—¶çš„æ•°æ®ä¸€è‡´æ€§
â€¢ æ€§èƒ½å½±å“ï¼šç»Ÿè®¡é€»è¾‘ä¸èƒ½å½±å“æ­£å¸¸è®¿é—®é€Ÿåº¦  
â€¢ æ•°æ®å‡†ç¡®ï¼šæ’é™¤çˆ¬è™«ã€é‡å¤è®¿é—®ç­‰å¹²æ‰°å› ç´ 
â€¢ å­˜å‚¨ä¼˜åŒ–ï¼šå¤§é‡æ•°æ®çš„é«˜æ•ˆå­˜å‚¨å’ŒæŸ¥è¯¢

è§£å†³ç­–ç•¥ï¼š
â€¢ ä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„æ•°æ®ç»“æ„ï¼ˆConcurrentHashMapã€AtomicLongï¼‰
â€¢ å¼‚æ­¥å¤„ç†æ•°æ®ä¿å­˜ï¼Œé¿å…é˜»å¡ç”¨æˆ·è¯·æ±‚
â€¢ åˆç†çš„æ•°æ®è¿‡æ»¤å’Œå»é‡é€»è¾‘
â€¢ æ•°æ®åˆ†å±‚å­˜å‚¨ï¼šå†…å­˜+æ•°æ®åº“çš„ç»„åˆæ–¹æ¡ˆ
```

**ğŸ”¹ å®æ—¶æ€§ä¸å‡†ç¡®æ€§çš„å¹³è¡¡**ï¼š
```
å¹³è¡¡è€ƒè™‘ï¼š
â€¢ å®æ—¶æ€§è¦æ±‚ï¼šç”¨æˆ·å¸Œæœ›çœ‹åˆ°å³æ—¶çš„è®¿é—®æ•°æ®
â€¢ å‡†ç¡®æ€§éœ€æ±‚ï¼šç»Ÿè®¡æ•°æ®å¿…é¡»å¯é å’Œç²¾ç¡®
â€¢ æ€§èƒ½çº¦æŸï¼šä¸èƒ½ä¸ºäº†ç»Ÿè®¡å½±å“ç³»ç»Ÿæ€§èƒ½

æœ€ä½³å®è·µï¼š
â€¢ å…³é”®æ•°æ®å®æ—¶æ›´æ–°ï¼šåœ¨çº¿ç”¨æˆ·æ•°ã€å½“å‰è®¿é—®é‡
â€¢ å¤æ‚åˆ†æå¼‚æ­¥è®¡ç®—ï¼šç”¨æˆ·è½¨è¿¹ã€åœ°åŸŸåˆ†å¸ƒ
â€¢ ä½¿ç”¨ç¼“å­˜æœºåˆ¶ï¼šé¿å…é‡å¤è®¡ç®—ç›¸åŒæ•°æ®
â€¢ åˆ†çº§ç»Ÿè®¡ç­–ç•¥ï¼šå®æ—¶ç»Ÿè®¡+å®šæ—¶æ±‡æ€»
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ’¼ ä¼ä¸šé¡¹ç›®ä¸­çš„åº”ç”¨**ï¼š
```
ç”µå•†ç½‘ç«™ï¼š
âœ… å•†å“é¡µé¢è®¿é—®é‡ç»Ÿè®¡ï¼Œäº†è§£çƒ­é—¨å•†å“
âœ… ç”¨æˆ·è´­ä¹°è·¯å¾„åˆ†æï¼Œä¼˜åŒ–è½¬åŒ–æµç¨‹
âœ… åœ°åŸŸåˆ†å¸ƒåˆ†æï¼Œåˆ¶å®šé…é€ç­–ç•¥
âœ… è®¿é—®é«˜å³°æ—¶æ®µåˆ†æï¼Œä¼˜åŒ–ä¿ƒé”€æ—¶é—´

å†…å®¹ç½‘ç«™ï¼š
âœ… æ–‡ç« é˜…è¯»é‡ç»Ÿè®¡ï¼Œäº†è§£ç”¨æˆ·å…´è¶£
âœ… ç”¨æˆ·æµè§ˆä¹ æƒ¯åˆ†æï¼Œæ¨èç›¸å…³å†…å®¹
âœ… è®¿é—®æ¥æºåˆ†æï¼Œä¼˜åŒ–SEOç­–ç•¥
âœ… å®æ—¶çƒ­ç‚¹ç›‘æ§ï¼ŒåŠæ—¶è°ƒæ•´å†…å®¹ç­–ç•¥

ä¼ä¸šå®˜ç½‘ï¼š
âœ… é¡µé¢æ•ˆæœè¯„ä¼°ï¼Œä¼˜åŒ–ç½‘ç«™ç»“æ„
âœ… ç”¨æˆ·è®¿é—®è·¯å¾„åˆ†æï¼Œæ”¹è¿›ç”¨æˆ·ä½“éªŒ
âœ… è¥é”€æ´»åŠ¨æ•ˆæœè¿½è¸ªï¼Œè¯„ä¼°ROI
âœ… å®¢æˆ·åœ°åŸŸåˆ†å¸ƒï¼Œæ”¯æŒé”€å”®å†³ç­–
```

**ğŸ› ï¸ å¼€å‘å®æ–½å»ºè®®**ï¼š
```
ç³»ç»Ÿè®¾è®¡ï¼š
1. åˆ†å±‚æ¶æ„ï¼šé‡‡é›†å±‚â†’å¤„ç†å±‚â†’å­˜å‚¨å±‚â†’å±•ç¤ºå±‚
2. å¼‚æ­¥å¤„ç†ï¼šç»Ÿè®¡é€»è¾‘å¼‚æ­¥æ‰§è¡Œï¼Œä¸å½±å“ç”¨æˆ·ä½“éªŒ
3. æ•°æ®åˆ†ç±»ï¼šå®æ—¶æ•°æ®ã€å†å²æ•°æ®ã€æ±‡æ€»æ•°æ®åˆ†åˆ«å¤„ç†
4. æ‰©å±•æ€§è€ƒè™‘ï¼šæ”¯æŒæ–°çš„ç»Ÿè®¡ç»´åº¦å’Œåˆ†æéœ€æ±‚

æŠ€æœ¯é€‰æ‹©ï¼š
1. ç›‘å¬å™¨ç±»å‹ï¼šæ ¹æ®éœ€æ±‚é€‰æ‹©åˆé€‚çš„ç›‘å¬å™¨
2. å­˜å‚¨æ–¹æ¡ˆï¼šå†…å­˜ç¼“å­˜+æ•°æ®åº“æŒä¹…åŒ–ç»„åˆ
3. å¹¶å‘å¤„ç†ï¼šä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„æ•°æ®ç»“æ„
4. æ€§èƒ½ä¼˜åŒ–ï¼šæ‰¹é‡å¤„ç†ã€ç¼“å­˜æœºåˆ¶ã€ç´¢å¼•ä¼˜åŒ–
```

**âš ï¸ æ³¨æ„äº‹é¡¹å’Œæœ€ä½³å®è·µ**ï¼š
```
éšç§ä¿æŠ¤ï¼š
â€¢ éµå®ˆæ•°æ®ä¿æŠ¤æ³•è§„ï¼ˆå¦‚GDPRï¼‰
â€¢ ç”¨æˆ·IPåœ°å€è„±æ•å¤„ç†
â€¢ æä¾›æ•°æ®åˆ é™¤å’Œå¯¼å‡ºåŠŸèƒ½
â€¢ æ˜ç¡®å‘ŠçŸ¥ç”¨æˆ·æ•°æ®æ”¶é›†èŒƒå›´

æ€§èƒ½è€ƒè™‘ï¼š
â€¢ ç»Ÿè®¡ä»£ç è¦è½»é‡çº§ï¼Œé¿å…å¤æ‚è®¡ç®—
â€¢ ä½¿ç”¨å¼‚æ­¥æ–¹å¼å¤„ç†æ•°æ®ä¿å­˜
â€¢ å®šæœŸæ¸…ç†å†å²æ•°æ®ï¼Œæ§åˆ¶æ•°æ®é‡
â€¢ åˆç†è®¾ç½®ç¼“å­˜ç­–ç•¥

æ•°æ®å‡†ç¡®æ€§ï¼š
â€¢ è¯†åˆ«å’Œè¿‡æ»¤çˆ¬è™«è®¿é—®
â€¢ å¤„ç†é‡å¤æäº¤å’Œåˆ·æ–°é—®é¢˜
â€¢ è€ƒè™‘CDNå’Œä»£ç†å¯¹IPç»Ÿè®¡çš„å½±å“
â€¢ å»ºç«‹æ•°æ®æ ¡éªŒå’Œä¿®å¤æœºåˆ¶
```

### 9.4 å­¦ä¹ æ‰©å±•å»ºè®®


**ğŸ“š è¿›é˜¶å­¦ä¹ æ–¹å‘**ï¼š
```
æŠ€æœ¯æ·±åŒ–ï¼š
â€¢ å­¦ä¹ å¤§æ•°æ®åˆ†ææŠ€æœ¯ï¼ˆSparkã€Hadoopï¼‰
â€¢ æŒæ¡æ—¶é—´åºåˆ—æ•°æ®åº“ï¼ˆInfluxDBã€TimescaleDBï¼‰
â€¢ äº†è§£æµå¤„ç†æ¡†æ¶ï¼ˆKafkaã€Stormï¼‰
â€¢ ç ”ç©¶æœºå™¨å­¦ä¹ åœ¨ç”¨æˆ·è¡Œä¸ºåˆ†æä¸­çš„åº”ç”¨

å·¥å…·é›†æˆï¼š
â€¢ é›†æˆä¸“ä¸šåˆ†æå·¥å…·ï¼ˆGoogle Analyticsã€ç™¾åº¦ç»Ÿè®¡ï¼‰
â€¢ ä½¿ç”¨å¯è§†åŒ–å›¾è¡¨åº“ï¼ˆEChartsã€D3.jsï¼‰
â€¢ æ¥å…¥å‘Šè­¦ç³»ç»Ÿï¼ˆé’‰é’‰ã€ä¼ä¸šå¾®ä¿¡ï¼‰
â€¢ å¯¹æ¥å•†ä¸šæ™ºèƒ½å¹³å°ï¼ˆTableauã€PowerBIï¼‰

ç³»ç»Ÿä¼˜åŒ–ï¼š
â€¢ åˆ†å¸ƒå¼ç»Ÿè®¡æ¶æ„è®¾è®¡
â€¢ å¾®æœåŠ¡ç¯å¢ƒä¸‹çš„ç»Ÿè®¡æ–¹æ¡ˆ
â€¢ å®¹å™¨åŒ–éƒ¨ç½²å’Œæ‰©å±•
â€¢ äº‘åŸç”Ÿç»Ÿè®¡æœåŠ¡æ„å»º
```

**ğŸ¯ å®è·µé¡¹ç›®å»ºè®®**ï¼š
```
åˆçº§é¡¹ç›®ï¼š
â€¢ ä¸ªäººåšå®¢è®¿é—®ç»Ÿè®¡ç³»ç»Ÿ
â€¢ ç®€å•çš„é¡µé¢çƒ­åŠ›å›¾å±•ç¤º
â€¢ åŸºç¡€çš„è®¿é—®é‡æ’è¡Œæ¦œ

ä¸­çº§é¡¹ç›®ï¼š
â€¢ ç”µå•†ç½‘ç«™ç”¨æˆ·è¡Œä¸ºåˆ†æç³»ç»Ÿ
â€¢ å¤šç»´åº¦æ•°æ®é€è§†åˆ†æ
â€¢ å®æ—¶ç›‘æ§å‘Šè­¦ç³»ç»Ÿ

é«˜çº§é¡¹ç›®ï¼š
â€¢ ä¼ä¸šçº§å¤§æ•°æ®åˆ†æå¹³å°
â€¢ æ™ºèƒ½æ¨èç³»ç»Ÿæ•°æ®æ”¯æ’‘
â€¢ ç”¨æˆ·ç”»åƒæ„å»ºç³»ç»Ÿ
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- ç›‘å¬å™¨æ˜¯å®ç°è®¿é—®ç»Ÿè®¡çš„ç†æƒ³æ–¹æ¡ˆï¼Œè‡ªåŠ¨åŒ–ä¸”å…¨è¦†ç›–
- ç»Ÿè®¡ç³»ç»Ÿéœ€è¦åœ¨å®æ—¶æ€§ã€å‡†ç¡®æ€§ã€æ€§èƒ½ä¹‹é—´æ‰¾åˆ°å¹³è¡¡
- å¼‚æ­¥å¤„ç†æ˜¯å…³é”®ï¼Œé¿å…ç»Ÿè®¡é€»è¾‘å½±å“ç”¨æˆ·ä½“éªŒ
- æ•°æ®æŒä¹…åŒ–ç¡®ä¿ç»Ÿè®¡æ•°æ®çš„å®‰å…¨å’Œå†å²åˆ†æèƒ½åŠ›
- å®æ—¶æŠ¥è¡¨æä¾›å³æ—¶çš„è¿è¥å†³ç­–æ”¯æŒ
- æ³¨é‡ç”¨æˆ·éšç§ä¿æŠ¤ï¼Œéµå®ˆç›¸å…³æ³•è§„è¦æ±‚

**æœ€ç»ˆç†è§£**ï¼šè®¿é—®ç»Ÿè®¡åˆ†æç³»ç»Ÿä¸ä»…ä»…æ˜¯ç®€å•çš„è®¡æ•°å™¨ï¼Œè€Œæ˜¯ä¼ä¸šæ•°å­—åŒ–è¿è¥çš„é‡è¦åŸºç¡€è®¾æ–½ã€‚é€šè¿‡ç›‘å¬å™¨æŠ€æœ¯å®ç°çš„ç»Ÿè®¡ç³»ç»Ÿï¼Œèƒ½å¤Ÿä¸ºç½‘ç«™è¿è¥æä¾›å…¨é¢ã€å‡†ç¡®ã€å®æ—¶çš„æ•°æ®æ”¯æ’‘ï¼Œå¸®åŠ©ä¼ä¸šåšå‡ºæ›´å¥½çš„å•†ä¸šå†³ç­–ã€‚