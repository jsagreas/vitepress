---
title: 1ã€åå‘ä»£ç†é…ç½®
---
## ğŸ“š ç›®å½•

1. [é›†ç¾¤ä¸è´Ÿè½½å‡è¡¡åŸºç¡€æ¦‚å¿µ](#1-é›†ç¾¤ä¸è´Ÿè½½å‡è¡¡åŸºç¡€æ¦‚å¿µ)
2. [Nginxåå‘ä»£ç†é…ç½®è¯¦è§£](#2-Nginxåå‘ä»£ç†é…ç½®è¯¦è§£)
3. [Apache HTTP Serveré›†ç¾¤é…ç½®](#3-Apache-HTTP-Serveré›†ç¾¤é…ç½®)
4. [è´Ÿè½½å‡è¡¡ç®—æ³•æ·±å…¥ç†è§£](#4-è´Ÿè½½å‡è¡¡ç®—æ³•æ·±å…¥ç†è§£)
5. [å¥åº·æ£€æŸ¥ä¸æ•…éšœå¤„ç†](#5-å¥åº·æ£€æŸ¥ä¸æ•…éšœå¤„ç†)
6. [å®æˆ˜é…ç½®ä¸æœ€ä½³å®è·µ](#6-å®æˆ˜é…ç½®ä¸æœ€ä½³å®è·µ)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ é›†ç¾¤ä¸è´Ÿè½½å‡è¡¡åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯é›†ç¾¤ï¼Ÿ


**ç®€å•ç†è§£**ï¼šé›†ç¾¤å°±åƒä¸€ä¸ª**å›¢é˜Ÿåˆä½œ**çš„æ¦‚å¿µ

```
å•æœºæ¨¡å¼ï¼š                    é›†ç¾¤æ¨¡å¼ï¼š
   ç”¨æˆ·                         ç”¨æˆ·
    â†“                           â†“
  ä¸€å°æœåŠ¡å™¨                 è´Ÿè½½å‡è¡¡å™¨
    â†“                         â†™  â†“  â†˜
  å¤„ç†æ‰€æœ‰è¯·æ±‚           æœåŠ¡å™¨1 æœåŠ¡å™¨2 æœåŠ¡å™¨3
                          â†“     â†“     â†“
                       å„è‡ªå¤„ç† éƒ¨åˆ†è¯·æ±‚
```

> ğŸ  **ç”Ÿæ´»ç±»æ¯”**ï¼š
> 
> **å•æœº**å°±åƒä¸€ä¸ªäººå¼€å°åº—ï¼Œæ‰€æœ‰é¡¾å®¢éƒ½æ‰¾ä»–
> **é›†ç¾¤**å°±åƒè¿é”åº—ï¼Œå¤šä¸ªåˆ†åº—åŒæ—¶æœåŠ¡é¡¾å®¢
> é¡¾å®¢ä¸ç”¨æ’é•¿é˜Ÿï¼ŒæœåŠ¡è´¨é‡æ›´ç¨³å®š

**ğŸ”´ æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- **åˆ†æ‹…å‹åŠ›**ï¼šå¤šå°æœåŠ¡å™¨å…±åŒæ‰¿æ‹…ç”¨æˆ·è¯·æ±‚
- **é«˜å¯ç”¨æ€§**ï¼šä¸€å°åäº†ï¼Œå…¶ä»–è¿˜èƒ½æ­£å¸¸å·¥ä½œ
- **æ˜“æ‰©å±•**ï¼šä¸šåŠ¡é‡å¤§äº†å°±åŠ æœºå™¨

### 1.2 ä»€ä¹ˆæ˜¯è´Ÿè½½å‡è¡¡ï¼Ÿ


**é€šä¿—è§£é‡Š**ï¼šè´Ÿè½½å‡è¡¡å°±æ˜¯**æ™ºèƒ½åˆ†é…å·¥ä½œ**çš„ç®¡ç†å‘˜

**ğŸ¯ æ ¸å¿ƒèŒè´£**ï¼š
- **æ¥æ”¶è¯·æ±‚**ï¼šæ‰€æœ‰ç”¨æˆ·è¯·æ±‚å…ˆåˆ°è´Ÿè½½å‡è¡¡å™¨
- **æ™ºèƒ½åˆ†é…**ï¼šæ ¹æ®ç®—æ³•å†³å®šè½¬å‘ç»™å“ªå°æœåŠ¡å™¨
- **ç›‘æ§çŠ¶æ€**ï¼šæ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦æ­£å¸¸å·¥ä½œ
- **æ•…éšœå¤„ç†**ï¼šå‘ç°æ•…éšœè‡ªåŠ¨åˆ‡æ¢åˆ°æ­£å¸¸æœåŠ¡å™¨

### 1.3 ä¸ºä»€ä¹ˆéœ€è¦åå‘ä»£ç†ï¼Ÿ


**æ­£å‘ä»£ç† vs åå‘ä»£ç†å¯¹æ¯”**ï¼š

| ç‰¹å¾ | **æ­£å‘ä»£ç†** | **åå‘ä»£ç†** |
|------|------------|------------|
| **ä½ç½®** | `å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´ï¼Œé è¿‘å®¢æˆ·ç«¯` | `å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´ï¼Œé è¿‘æœåŠ¡å™¨` |
| **ä½œç”¨** | `ä»£ç†å®¢æˆ·ç«¯è®¿é—®æœåŠ¡å™¨` | `ä»£ç†æœåŠ¡å™¨å“åº”å®¢æˆ·ç«¯` |
| **ä¾‹å­** | `ç§‘å­¦ä¸Šç½‘å·¥å…·` | `Nginxã€Apache` |
| **å®¢æˆ·ç«¯æ„ŸçŸ¥** | `çŸ¥é“ä»£ç†å­˜åœ¨` | `ä¸çŸ¥é“åç«¯æœ‰å¤šå°æœåŠ¡å™¨` |

```
æ­£å‘ä»£ç†ï¼š
å®¢æˆ·ç«¯ â†’ ä»£ç†æœåŠ¡å™¨ â†’ ç›®æ ‡æœåŠ¡å™¨
(å®¢æˆ·ç«¯çŸ¥é“åœ¨ä½¿ç”¨ä»£ç†)

åå‘ä»£ç†ï¼š
å®¢æˆ·ç«¯ â†’ åå‘ä»£ç† â†’ åç«¯æœåŠ¡å™¨ç¾¤
(å®¢æˆ·ç«¯ä¸çŸ¥é“åé¢æœ‰å¤šå°æœåŠ¡å™¨)
```

> âš ï¸ **æ˜“é”™é‡ç‚¹**
> 
> å¾ˆå¤šæ–°æ‰‹åˆ†ä¸æ¸…æ­£å‘å’Œåå‘ä»£ç†
> **è®°å¿†æŠ€å·§**ï¼šåå‘ä»£ç†æ˜¯ç«™åœ¨æœåŠ¡å™¨è¿™è¾¹çš„ï¼Œå¸®æœåŠ¡å™¨"æ¥å®¢"

---

## 2. ğŸ”§ Nginxåå‘ä»£ç†é…ç½®è¯¦è§£


### 2.1 NginxåŸºç¡€æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯Nginxï¼Ÿ**
- **é«˜æ€§èƒ½**çš„WebæœåŠ¡å™¨å’Œåå‘ä»£ç†æœåŠ¡å™¨
- ç‰¹åˆ«æ“…é•¿å¤„ç†**å¤§é‡å¹¶å‘è¿æ¥**
- åœ¨JavaWebé¡¹ç›®ä¸­é€šå¸¸ä½œä¸º**å‰ç½®ä»£ç†**

**ğŸŒŸ æ ¸å¿ƒç‰¹ç‚¹**ï¼š
- **äº‹ä»¶é©±åŠ¨**ï¼šä¸€ä¸ªè¿›ç¨‹å¤„ç†å¤šä¸ªè¿æ¥ï¼Œæ•ˆç‡æé«˜
- **é…ç½®ç®€å•**ï¼šé…ç½®æ–‡ä»¶è¯­æ³•æ¸…æ™°æ˜“æ‡‚
- **åŠŸèƒ½ä¸°å¯Œ**ï¼šé™æ€æ–‡ä»¶æœåŠ¡ã€SSLã€ç¼“å­˜ç­‰

### 2.2 åŸºç¡€åå‘ä»£ç†é…ç½®


**ğŸ“ é…ç½®æ–‡ä»¶ç»“æ„**ï¼š
```
/etc/nginx/
â”œâ”€â”€ nginx.conf          # ä¸»é…ç½®æ–‡ä»¶
â”œâ”€â”€ conf.d/
â”‚   â””â”€â”€ javaweb.conf     # é¡¹ç›®ä¸“ç”¨é…ç½®
â””â”€â”€ sites-enabled/       # å¯ç”¨çš„ç«™ç‚¹é…ç½®
```

**ğŸ”¸ æœ€ç®€å•çš„åå‘ä»£ç†é…ç½®**ï¼š

```nginx
# javaweb.conf
server {
    listen 80;
    server_name www.myjavaweb.com;
    
    location / {
        proxy_pass http://127.0.0.1:8080;  # è½¬å‘åˆ°Tomcat
        proxy_set_header Host $host;       # ä¼ é€’åŸå§‹åŸŸå
        proxy_set_header X-Real-IP $remote_addr;  # ä¼ é€’çœŸå®IP
    }
}
```

**ğŸ’¡ é…ç½®è§£è¯»**ï¼š
- `listen 80`ï¼šç›‘å¬80ç«¯å£ï¼ˆHTTPé»˜è®¤ç«¯å£ï¼‰
- `server_name`ï¼šå¤„ç†çš„åŸŸå
- `proxy_pass`ï¼šè½¬å‘ç›®æ ‡åœ°å€
- `proxy_set_header`ï¼šè®¾ç½®è½¬å‘æ—¶çš„HTTPå¤´ä¿¡æ¯

### 2.3 å¤šå°æœåŠ¡å™¨è´Ÿè½½å‡è¡¡é…ç½®


**ğŸ¯ upstreamé…ç½®ï¼ˆæœåŠ¡å™¨ç»„ï¼‰**ï¼š

```nginx
# å®šä¹‰åç«¯æœåŠ¡å™¨ç»„
upstream javaweb_backend {
    # é»˜è®¤è½®è¯¢ç®—æ³•
    server 192.168.1.10:8080 weight=3;  # æƒé‡3
    server 192.168.1.11:8080 weight=1;  # æƒé‡1
    server 192.168.1.12:8080 backup;    # å¤‡ç”¨æœåŠ¡å™¨
}

server {
    listen 80;
    server_name www.myjavaweb.com;
    
    location / {
        proxy_pass http://javaweb_backend;
        
        # é‡è¦çš„ä»£ç†å¤´ä¿¡æ¯
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
}
```

**ğŸ”¸ å‚æ•°è¯¦è§£**ï¼š

| å‚æ•° | **å«ä¹‰** | **ä½œç”¨** |
|------|---------|---------|
| `weight=3` | `æƒé‡ä¸º3` | `è¿™å°æœåŠ¡å™¨å¤„ç†3å€çš„è¯·æ±‚` |
| `backup` | `å¤‡ç”¨æœåŠ¡å™¨` | `åªæœ‰å…¶ä»–éƒ½æ•…éšœæ—¶æ‰å¯ç”¨` |
| `max_fails=2` | `æœ€å¤§å¤±è´¥æ¬¡æ•°` | `å¤±è´¥2æ¬¡åæš‚æ—¶ä¸‹çº¿` |
| `fail_timeout=30s` | `æ•…éšœè¶…æ—¶æ—¶é—´` | `30ç§’åé‡æ–°å°è¯•` |

### 2.4 é«˜çº§é…ç½®é€‰é¡¹


**ğŸš€ æ€§èƒ½ä¼˜åŒ–é…ç½®**ï¼š

```nginx
upstream javaweb_backend {
    server 192.168.1.10:8080;
    server 192.168.1.11:8080;
    
    # ä¿æŒè¿æ¥æ•°
    keepalive 32;
}

server {
    listen 80;
    server_name www.myjavaweb.com;
    
    location / {
        proxy_pass http://javaweb_backend;
        
        # è¿æ¥å¤ç”¨
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        
        # ç¼“å­˜é…ç½®
        proxy_cache_bypass $http_upgrade;
        
        # å®‰å…¨å¤´ä¿¡æ¯
        add_header X-Frame-Options DENY;
        add_header X-Content-Type-Options nosniff;
    }
    
    # é™æ€èµ„æºç›´æ¥å¤„ç†
    location ~* \.(jpg|jpeg|png|css|js)$ {
        root /var/www/static;
        expires 1d;
        add_header Cache-Control "public, immutable";
    }
}
```

---

## 3. ğŸ—ï¸ Apache HTTP Serveré›†ç¾¤é…ç½®


### 3.1 Apacheä¸mod_jkè¿æ¥å™¨


**ä»€ä¹ˆæ˜¯mod_jkï¼Ÿ**
- Apacheçš„ä¸€ä¸ª**æ¨¡å—**ï¼Œä¸“é—¨ç”¨æ¥è¿æ¥Javaåº”ç”¨æœåŠ¡å™¨
- å®ç°Apacheå’ŒTomcatä¹‹é—´çš„**é«˜æ•ˆé€šä¿¡**
- æ”¯æŒ**é›†ç¾¤ã€è´Ÿè½½å‡è¡¡ã€æ•…éšœè½¬ç§»**

**ğŸ”¸ æ¶æ„å›¾**ï¼š
```
å®¢æˆ·ç«¯è¯·æ±‚
    â†“
Apache HTTP Server (80ç«¯å£)
    â†“
mod_jkæ¨¡å— (AJPåè®®)
    â†“
Tomcaté›†ç¾¤ (8009ç«¯å£)
    â†“
JavaWebåº”ç”¨
```

### 3.2 mod_jkå®‰è£…ä¸é…ç½®


**ğŸ“¦ å®‰è£…æ­¥éª¤**ï¼š

**CentOS/RHEL**ï¼š
```bash
# å®‰è£…Apacheå’Œmod_jk
yum install httpd
yum install tomcat-connectors-mod_jk
```

**Ubuntu/Debian**ï¼š
```bash
# å®‰è£…Apacheå’Œmod_jk
apt-get install apache2
apt-get install libapache2-mod-jk
```

### 3.3 workers.propertiesé…ç½®


**ğŸ‘· å·¥ä½œè¿›ç¨‹é…ç½®æ–‡ä»¶**ï¼š

```properties
# /etc/httpd/conf/workers.properties

# å®šä¹‰å·¥ä½œèŠ‚ç‚¹åˆ—è¡¨
worker.list=loadbalancer,status

# Tomcat1èŠ‚ç‚¹é…ç½®
worker.tomcat1.type=ajp13
worker.tomcat1.host=192.168.1.10
worker.tomcat1.port=8009
worker.tomcat1.lbfactor=3

# Tomcat2èŠ‚ç‚¹é…ç½®  
worker.tomcat2.type=ajp13
worker.tomcat2.host=192.168.1.11
worker.tomcat2.port=8009
worker.tomcat2.lbfactor=1

# è´Ÿè½½å‡è¡¡å™¨é…ç½®
worker.loadbalancer.type=lb
worker.loadbalancer.balanced_workers=tomcat1,tomcat2
worker.loadbalancer.sticky_session=true

# çŠ¶æ€ç›‘æ§
worker.status.type=status
```

**ğŸ’¡ å‚æ•°è¯´æ˜**ï¼š
- `ajp13`ï¼šApache JServ Protocol 1.3ï¼ŒApacheå’ŒTomcaté€šä¿¡åè®®
- `lbfactor`ï¼šè´Ÿè½½å‡è¡¡å› å­ï¼Œæ•°å­—è¶Šå¤§å¤„ç†è¯·æ±‚è¶Šå¤š
- `sticky_session`ï¼šä¼šè¯ç²˜æ€§ï¼ŒåŒä¸€ç”¨æˆ·çš„è¯·æ±‚å‘é€åˆ°åŒä¸€å°æœåŠ¡å™¨

### 3.4 Apacheä¸»é…ç½®æ–‡ä»¶


**httpd.confå…³é”®é…ç½®**ï¼š

```apache
# åŠ è½½mod_jkæ¨¡å—
LoadModule jk_module modules/mod_jk.so

# mod_jké…ç½®æ–‡ä»¶è·¯å¾„
JkWorkersFile /etc/httpd/conf/workers.properties

# æ—¥å¿—é…ç½®
JkLogFile /var/log/httpd/mod_jk.log
JkLogLevel info

# URLæ˜ å°„
JkMount /javaweb/* loadbalancer
JkMount /javaweb/status status

# è™šæ‹Ÿä¸»æœºé…ç½®
<VirtualHost *:80>
    ServerName www.myjavaweb.com
    DocumentRoot /var/www/html
    
    # æ‰€æœ‰åŠ¨æ€è¯·æ±‚è½¬å‘ç»™Tomcat
    JkMount /* loadbalancer
    
    # é™æ€èµ„æºæœ¬åœ°å¤„ç†
    JkUnMount /*.jpg loadbalancer
    JkUnMount /*.css loadbalancer  
    JkUnMount /*.js loadbalancer
</VirtualHost>
```

---

## 4. âš–ï¸ è´Ÿè½½å‡è¡¡ç®—æ³•æ·±å…¥ç†è§£


### 4.1 ç®—æ³•ç±»å‹å¯¹æ¯”


**ğŸ“Š å¸¸ç”¨ç®—æ³•ç‰¹ç‚¹**ï¼š

| ç®—æ³•åç§° | **å·¥ä½œåŸç†** | **é€‚ç”¨åœºæ™¯** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** |
|---------|------------|-------------|---------|---------|
| **è½®è¯¢(Round Robin)** | `æŒ‰é¡ºåºè½®æµåˆ†é…` | `æœåŠ¡å™¨æ€§èƒ½ç›¸è¿‘` | `ç®€å•å…¬å¹³` | `ä¸è€ƒè™‘è´Ÿè½½` |
| **åŠ æƒè½®è¯¢** | `æŒ‰æƒé‡æ¯”ä¾‹åˆ†é…` | `æœåŠ¡å™¨æ€§èƒ½ä¸åŒ` | `å¯è°ƒèŠ‚æ¯”ä¾‹` | `é™æ€æƒé‡` |
| **æœ€å°‘è¿æ¥** | `åˆ†é…ç»™è¿æ¥æ•°æœ€å°‘çš„` | `é•¿è¿æ¥åº”ç”¨` | `è€ƒè™‘å®æ—¶è´Ÿè½½` | `è®¡ç®—å¼€é”€å¤§` |
| **IPå“ˆå¸Œ** | `æ ¹æ®å®¢æˆ·ç«¯IPè®¡ç®—` | `éœ€è¦ä¼šè¯ä¿æŒ` | `åŒIPå›ºå®šæœåŠ¡å™¨` | `å¯èƒ½åˆ†å¸ƒä¸å‡` |

### 4.2 è½®è¯¢ç®—æ³•è¯¦è§£


**ğŸ”„ åŸºæœ¬è½®è¯¢**ï¼š

```
è¯·æ±‚åºåˆ—ï¼š1  2  3  4  5  6  7  8
åˆ†é…ç»“æœï¼šA  B  C  A  B  C  A  B

æœåŠ¡å™¨Aï¼šå¤„ç†è¯·æ±‚ 1,4,7
æœåŠ¡å™¨Bï¼šå¤„ç†è¯·æ±‚ 2,5,8  
æœåŠ¡å™¨Cï¼šå¤„ç†è¯·æ±‚ 3,6
```

**âš–ï¸ åŠ æƒè½®è¯¢**ï¼š

```
æœåŠ¡å™¨é…ç½®ï¼š
A: weight=3
B: weight=2  
C: weight=1

è¯·æ±‚åˆ†é…ï¼šA A A B B C (ä¸€ä¸ªå‘¨æœŸ)
å®é™…æ¯”ä¾‹ï¼šAå 50%, Bå 33%, Cå 17%
```

**ğŸ’¡ Nginxé…ç½®ç¤ºä¾‹**ï¼š
```nginx
upstream backend {
    server 192.168.1.10:8080 weight=3;
    server 192.168.1.11:8080 weight=2;
    server 192.168.1.12:8080 weight=1;
}
```

### 4.3 IPå“ˆå¸Œç®—æ³•


**ğŸ¯ å·¥ä½œåŸç†**ï¼š
```
å®¢æˆ·ç«¯IP â†’ å“ˆå¸Œå‡½æ•° â†’ å›ºå®šæœåŠ¡å™¨

ä¾‹å­ï¼š
IP: 192.168.1.100 â†’ hash() â†’ æœåŠ¡å™¨A
IP: 192.168.1.101 â†’ hash() â†’ æœåŠ¡å™¨B
IP: 192.168.1.102 â†’ hash() â†’ æœåŠ¡å™¨A
```

**âœ… é€‚ç”¨åœºæ™¯**ï¼š
- **è´­ç‰©è½¦åŠŸèƒ½**ï¼šç”¨æˆ·çš„è´­ç‰©è½¦æ•°æ®å­˜åœ¨ç‰¹å®šæœåŠ¡å™¨
- **ç”¨æˆ·ä¼šè¯**ï¼šç™»å½•çŠ¶æ€éœ€è¦ä¿æŒ
- **æ–‡ä»¶ä¸Šä¼ **ï¼šåˆ†æ®µä¸Šä¼ éœ€è¦å›ºå®šæœåŠ¡å™¨

**Nginxé…ç½®**ï¼š
```nginx
upstream backend {
    ip_hash;  # å¯ç”¨IPå“ˆå¸Œ
    server 192.168.1.10:8080;
    server 192.168.1.11:8080;
}
```

### 4.4 æœ€å°‘è¿æ¥ç®—æ³•


**ğŸ“Š åŠ¨æ€è´Ÿè½½æ„ŸçŸ¥**ï¼š

```
å½“å‰çŠ¶æ€ï¼š
æœåŠ¡å™¨Aï¼š5ä¸ªæ´»è·ƒè¿æ¥
æœåŠ¡å™¨Bï¼š3ä¸ªæ´»è·ƒè¿æ¥  
æœåŠ¡å™¨Cï¼š7ä¸ªæ´»è·ƒè¿æ¥

æ–°è¯·æ±‚åˆ°è¾¾ â†’ åˆ†é…ç»™æœåŠ¡å™¨B (è¿æ¥æœ€å°‘)
```

**ğŸ¯ ç®—æ³•ä¼˜åŠ¿**ï¼š
- **å®æ—¶è´Ÿè½½**ï¼šè€ƒè™‘æœåŠ¡å™¨å½“å‰å¤„ç†èƒ½åŠ›
- **è‡ªé€‚åº”**ï¼šè‡ªåŠ¨é€‚åº”ä¸åŒæœåŠ¡å™¨æ€§èƒ½
- **å…¬å¹³æ€§**ï¼šé¿å…æŸå°æœåŠ¡å™¨è¿‡è½½

**Nginxé…ç½®**ï¼š
```nginx
upstream backend {
    least_conn;  # å¯ç”¨æœ€å°‘è¿æ¥
    server 192.168.1.10:8080;
    server 192.168.1.11:8080;
}
```

---

## 5. ğŸ¥ å¥åº·æ£€æŸ¥ä¸æ•…éšœå¤„ç†


### 5.1 ä¸ºä»€ä¹ˆéœ€è¦å¥åº·æ£€æŸ¥ï¼Ÿ


**ğŸš¨ å¸¸è§æ•…éšœåœºæ™¯**ï¼š
- æœåŠ¡å™¨**ç¡¬ä»¶æ•…éšœ**ï¼ˆä¸»æ¿ã€ç¡¬ç›˜æŸåï¼‰
- **åº”ç”¨ç¨‹åºå´©æºƒ**ï¼ˆå†…å­˜æº¢å‡ºã€ç¨‹åºbugï¼‰
- **ç½‘ç»œè¿æ¥é—®é¢˜**ï¼ˆç½‘å¡æ•…éšœã€äº¤æ¢æœºé—®é¢˜ï¼‰
- **æ•°æ®åº“è¿æ¥**å¤±æ•ˆ

> ğŸ¥ **åŒ»é™¢ç±»æ¯”**ï¼š
> 
> å¥åº·æ£€æŸ¥å°±åƒåŒ»é™¢çš„**ä½“æ£€**
> - å®šæœŸæ£€æŸ¥æ¯å°æœåŠ¡å™¨æ˜¯å¦"å¥åº·"
> - å‘ç°"ç”Ÿç—…"çš„æœåŠ¡å™¨ç«‹å³"éš”ç¦»"
> - "åº·å¤"åé‡æ–°åŠ å…¥æœåŠ¡

### 5.2 Nginxå¥åº·æ£€æŸ¥é…ç½®


**ğŸ” è¢«åŠ¨å¥åº·æ£€æŸ¥**ï¼ˆå…è´¹ç‰ˆæœ¬ï¼‰ï¼š

```nginx
upstream backend {
    server 192.168.1.10:8080 max_fails=3 fail_timeout=30s;
    server 192.168.1.11:8080 max_fails=3 fail_timeout=30s;
    server 192.168.1.12:8080 backup;
}

server {
    listen 80;
    server_name www.myjavaweb.com;
    
    location / {
        proxy_pass http://backend;
        
        # é”™è¯¯é¡µé¢é…ç½®
        proxy_next_upstream error timeout http_502 http_503 http_504;
        proxy_next_upstream_tries 3;
        proxy_next_upstream_timeout 10s;
    }
}
```

**ğŸ”¸ å‚æ•°å«ä¹‰**ï¼š
- `max_fails=3`ï¼š3æ¬¡è¯·æ±‚å¤±è´¥åæ ‡è®°ä¸ºä¸å¯ç”¨
- `fail_timeout=30s`ï¼š30ç§’åé‡æ–°å°è¯•
- `proxy_next_upstream`ï¼šå‡ºç°é”™è¯¯æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€å°æœåŠ¡å™¨

**âœ… ä¸»åŠ¨å¥åº·æ£€æŸ¥**ï¼ˆå•†ä¸šç‰ˆæœ¬ï¼‰ï¼š

```nginx
upstream backend {
    server 192.168.1.10:8080;
    server 192.168.1.11:8080;
    
    # ä¸»åŠ¨å¥åº·æ£€æŸ¥
    health_check interval=5s
                 fails=3
                 passes=2
                 uri=/health
                 match=server_ok;
}

# å¥åº·æ£€æŸ¥å“åº”åŒ¹é…è§„åˆ™
match server_ok {
    status 200;
    header Content-Type ~ "application/json";
    body ~ "\"status\":\s*\"ok\"";
}
```

### 5.3 åº”ç”¨å±‚å¥åº·æ£€æŸ¥


**ğŸ—ï¸ JavaWebå¥åº·æ£€æŸ¥æ¥å£**ï¼š

```java
@RestController
public class HealthController {
    
    @Autowired
    private DataSource dataSource;
    
    @GetMapping("/health")
    public ResponseEntity<Map<String, Object>> health() {
        Map<String, Object> status = new HashMap<>();
        
        try {
            // æ£€æŸ¥æ•°æ®åº“è¿æ¥
            checkDatabase();
            status.put("database", "ok");
            
            // æ£€æŸ¥å†…å­˜ä½¿ç”¨
            checkMemory();
            status.put("memory", "ok");
            
            // æ£€æŸ¥ç£ç›˜ç©ºé—´
            checkDisk();
            status.put("disk", "ok");
            
            status.put("status", "ok");
            status.put("timestamp", System.currentTimeMillis());
            
            return ResponseEntity.ok(status);
            
        } catch (Exception e) {
            status.put("status", "error");
            status.put("error", e.getMessage());
            return ResponseEntity.status(503).body(status);
        }
    }
    
    private void checkDatabase() throws SQLException {
        try (Connection conn = dataSource.getConnection()) {
            conn.createStatement().execute("SELECT 1");
        }
    }
    
    private void checkMemory() {
        Runtime runtime = Runtime.getRuntime();
        long maxMemory = runtime.maxMemory();
        long usedMemory = runtime.totalMemory() - runtime.freeMemory();
        
        if (usedMemory > maxMemory * 0.9) {
            throw new RuntimeException("å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜");
        }
    }
    
    private void checkDisk() {
        File root = new File("/");
        long usableSpace = root.getUsableSpace();
        long totalSpace = root.getTotalSpace();
        
        if (usableSpace < totalSpace * 0.1) {
            throw new RuntimeException("ç£ç›˜ç©ºé—´ä¸è¶³");
        }
    }
}
```

### 5.4 æ•…éšœè½¬ç§»æœºåˆ¶


**ğŸ”„ è‡ªåŠ¨æ•…éšœè½¬ç§»æµç¨‹**ï¼š

```
æ­£å¸¸çŠ¶æ€ï¼š
ç”¨æˆ·è¯·æ±‚ â†’ è´Ÿè½½å‡è¡¡å™¨ â†’ æœåŠ¡å™¨A âœ…

æ•…éšœæ£€æµ‹ï¼š
è´Ÿè½½å‡è¡¡å™¨å®šæœŸæ£€æŸ¥ â†’ æœåŠ¡å™¨A âŒ (å“åº”è¶…æ—¶)

æ•…éšœæ ‡è®°ï¼š
æœåŠ¡å™¨Aè¢«æ ‡è®°ä¸ºä¸å¯ç”¨ï¼Œä»è´Ÿè½½å‡è¡¡æ± ç§»é™¤

è¯·æ±‚é‡å®šå‘ï¼š
ç”¨æˆ·è¯·æ±‚ â†’ è´Ÿè½½å‡è¡¡å™¨ â†’ æœåŠ¡å™¨B âœ…

æ¢å¤æ£€æµ‹ï¼š
è´Ÿè½½å‡è¡¡å™¨ç»§ç»­æ£€æŸ¥æœåŠ¡å™¨A â†’ æ¢å¤æ­£å¸¸ âœ…

æœåŠ¡æ¢å¤ï¼š
æœåŠ¡å™¨Aé‡æ–°åŠ å…¥è´Ÿè½½å‡è¡¡æ± 
```

**âš ï¸ æ˜“é”™é‡ç‚¹**ï¼š
> å¾ˆå¤šæ–°æ‰‹ä»¥ä¸ºæ•…éšœè½¬ç§»æ˜¯ç¬é—´çš„
> **å®é™…æƒ…å†µ**ï¼šéœ€è¦æ£€æµ‹æ—¶é—´ï¼ˆé€šå¸¸å‡ ç§’åˆ°å‡ åç§’ï¼‰
> **æœ€ä½³å®è·µ**ï¼šè®¾ç½®åˆç†çš„æ£€æŸ¥é—´éš”å’Œè¶…æ—¶æ—¶é—´

---

## 6. ğŸš€ å®æˆ˜é…ç½®ä¸æœ€ä½³å®è·µ


### 6.1 å®Œæ•´çš„ç”Ÿäº§ç¯å¢ƒé…ç½®


**ğŸ¢ å…¸å‹æ¶æ„å›¾**ï¼š
```
                      äº’è”ç½‘
                        â†“
                   [é˜²ç«å¢™/CDN]
                        â†“
              [Nginxè´Ÿè½½å‡è¡¡å™¨] (ä¸»)
                    /  |  \
                   /   |   \
            [Tomcat1] [Tomcat2] [Tomcat3]
                 |      |         |
            [JavaWebåº”ç”¨å®ä¾‹]
                     â†“
               [æ•°æ®åº“é›†ç¾¤]
```

**ğŸ”§ Nginxå®Œæ•´é…ç½®ç¤ºä¾‹**ï¼š

```nginx
# /etc/nginx/nginx.conf ä¸»è¦éƒ¨åˆ†
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;

events {
    worker_connections 1024;
    use epoll;
}

http {
    # åŸºç¡€è®¾ç½®
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # æ—¥å¿—æ ¼å¼
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                   '$status $body_bytes_sent "$http_referer" '
                   '"$http_user_agent" "$http_x_forwarded_for"';
    
    # æ€§èƒ½ä¼˜åŒ–
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    
    # Gzipå‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript;
    
    # åç«¯æœåŠ¡å™¨ç»„
    upstream javaweb_cluster {
        # ä½¿ç”¨æœ€å°‘è¿æ¥ç®—æ³•
        least_conn;
        
        server 192.168.1.10:8080 weight=3 max_fails=3 fail_timeout=30s;
        server 192.168.1.11:8080 weight=3 max_fails=3 fail_timeout=30s;
        server 192.168.1.12:8080 weight=2 max_fails=3 fail_timeout=30s;
        server 192.168.1.13:8080 backup;  # å¤‡ç”¨æœåŠ¡å™¨
        
        # è¿æ¥ä¿æŒ
        keepalive 32;
    }
    
    # ä¸»ç«™ç‚¹é…ç½®
    server {
        listen 80;
        server_name www.myjavaweb.com myjavaweb.com;
        
        # è®¿é—®æ—¥å¿—
        access_log /var/log/nginx/javaweb.access.log main;
        
        # å®‰å…¨è®¾ç½®
        add_header X-Frame-Options DENY;
        add_header X-Content-Type-Options nosniff;
        add_header X-XSS-Protection "1; mode=block";
        
        # åŠ¨æ€è¯·æ±‚è½¬å‘
        location / {
            proxy_pass http://javaweb_cluster;
            
            # ä»£ç†å¤´è®¾ç½®
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # è¶…æ—¶è®¾ç½®
            proxy_connect_timeout 10s;
            proxy_send_timeout 10s;
            proxy_read_timeout 10s;
            
            # HTTPç‰ˆæœ¬å’Œè¿æ¥è®¾ç½®
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            
            # é”™è¯¯å¤„ç†
            proxy_next_upstream error timeout http_502 http_503 http_504;
        }
        
        # é™æ€èµ„æºå¤„ç†
        location ~* \.(jpg|jpeg|png|gif|css|js|ico|svg)$ {
            root /var/www/javaweb/static;
            expires 30d;
            add_header Cache-Control "public, immutable";
        }
        
        # å¥åº·æ£€æŸ¥æ¥å£
        location /nginx_status {
            stub_status on;
            access_log off;
            allow 192.168.1.0/24;
            deny all;
        }
    }
}
```

### 6.2 Tomcaté›†ç¾¤é…ç½®


**ğŸ“ server.xmlå…³é”®é…ç½®**ï¼š

```xml
<!-- Tomcat1é…ç½® (/opt/tomcat1/conf/server.xml) -->
<Server port="8005" shutdown="SHUTDOWN">
    
    <!-- AJPè¿æ¥å™¨é…ç½® -->
    <Connector port="8009" protocol="AJP/1.3" 
               redirectPort="8443" 
               tomcatAuthentication="false"/>
    
    <!-- HTTPè¿æ¥å™¨ -->
    <Connector port="8080" protocol="HTTP/1.1"
               connectionTimeout="20000"
               redirectPort="8443"
               maxThreads="200"
               minSpareThreads="10"/>
    
    <Engine name="Catalina" defaultHost="localhost" jvmRoute="tomcat1">
        
        <!-- é›†ç¾¤é…ç½® -->
        <Cluster className="org.apache.catalina.ha.tcp.SimpleTcpCluster"
                 channelSendOptions="8">
            
            <Manager className="org.apache.catalina.ha.session.DeltaManager"
                     expireSessionsOnShutdown="false"
                     notifyListenersOnReplication="true"/>
            
            <Channel className="org.apache.catalina.tribes.group.GroupChannel">
                <Membership className="org.apache.catalina.tribes.membership.McastService"
                            address="228.0.0.4"
                            port="45564"
                            frequency="500"
                            dropTime="3000"/>
                            
                <Receiver className="org.apache.catalina.tribes.transport.nio.NioReceiver"
                          address="192.168.1.10"
                          port="4000"
                          autoBind="100"
                          selectorTimeout="5000"
                          maxThreads="6"/>
                          
                <Sender className="org.apache.catalina.tribes.transport.ReplicationTransmitter">
                    <Transport className="org.apache.catalina.tribes.transport.nio.PooledParallelSender"/>
                </Sender>
                
                <Interceptor className="org.apache.catalina.tribes.group.interceptors.TcpFailureDetector"/>
                <Interceptor className="org.apache.catalina.tribes.group.interceptors.MessageDispatch15Interceptor"/>
            </Channel>
            
            <Valve className="org.apache.catalina.ha.tcp.ReplicationValve"
                   filter=""/>
                   
            <Deployer className="org.apache.catalina.ha.deploy.FarmWarDeployer"
                      tempDir="/tmp/war-temp/"
                      deployDir="/tmp/war-deploy/"
                      watchDir="/tmp/war-listen/"
                      watchEnabled="false"/>
                      
            <ClusterListener className="org.apache.catalina.ha.session.JvmRouteBinderValve"/>
            <ClusterListener className="org.apache.catalina.ha.session.ClusterSessionListener"/>
        </Cluster>
        
        <Host name="localhost" appBase="webapps"
              unpackWARs="true" autoDeploy="true">
        </Host>
    </Engine>
</Server>
```

### 6.3 åº”ç”¨é…ç½®è¦ç‚¹


**web.xmlåˆ†å¸ƒå¼é…ç½®**ï¼š

```xml
<!-- web.xml -->
<web-app xmlns="http://java.sun.com/xml/ns/javaee"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://java.sun.com/xml/ns/javaee 
         http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd"
         version="3.0"
         metadata-complete="false">

    <display-name>JavaWeb Cluster App</display-name>
    
    <!-- å¯ç”¨åˆ†å¸ƒå¼ä¼šè¯ -->
    <distributable/>
    
    <!-- ä¼šè¯è¶…æ—¶è®¾ç½® -->
    <session-config>
        <session-timeout>30</session-timeout>
    </session-config>
    
</web-app>
```

### 6.4 ç›‘æ§ä¸ç»´æŠ¤


**ğŸ“Š ç›‘æ§æŒ‡æ ‡**ï¼š

```bash
#!/bin/bash
# é›†ç¾¤ç›‘æ§è„šæœ¬ cluster_monitor.sh

echo "=== JavaWebé›†ç¾¤çŠ¶æ€ç›‘æ§ ==="

# æ£€æŸ¥NginxçŠ¶æ€
echo "1. NginxçŠ¶æ€ï¼š"
systemctl status nginx | grep "Active"

# æ£€æŸ¥åç«¯æœåŠ¡å™¨çŠ¶æ€  
echo "2. åç«¯æœåŠ¡å™¨çŠ¶æ€ï¼š"
servers=("192.168.1.10:8080" "192.168.1.11:8080" "192.168.1.12:8080")

for server in "${servers[@]}"; do
    response=$(curl -s -o /dev/null -w "%{http_code}" "http://$server/health" --max-time 5)
    if [ "$response" = "200" ]; then
        echo "  $server: âœ… æ­£å¸¸"
    else
        echo "  $server: âŒ å¼‚å¸¸ (çŠ¶æ€ç : $response)"
    fi
done

# æ£€æŸ¥è¿æ¥æ•°
echo "3. å½“å‰è¿æ¥æ•°ï¼š"
ss -tuln | grep ":80\|:8080" | wc -l

# æ£€æŸ¥ç³»ç»Ÿè´Ÿè½½
echo "4. ç³»ç»Ÿè´Ÿè½½ï¼š"
uptime

echo "=== ç›‘æ§å®Œæˆ ==="
```

**ğŸ”” å‘Šè­¦é…ç½®**ï¼š
- **æœåŠ¡å™¨å®•æœº**ï¼šç«‹å³çŸ­ä¿¡é€šçŸ¥
- **å“åº”æ—¶é—´è¶…è¿‡2ç§’**ï¼šé‚®ä»¶å‘Šè­¦
- **é”™è¯¯ç‡è¶…è¿‡5%**ï¼šé’‰é’‰ç¾¤é€šçŸ¥
- **ç£ç›˜ç©ºé—´ä¸è¶³10%**ï¼šç³»ç»Ÿå‘Šè­¦

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ é›†ç¾¤æ¦‚å¿µï¼šå¤šå°æœåŠ¡å™¨ååŒå·¥ä½œï¼Œæé«˜æ€§èƒ½å’Œå¯ç”¨æ€§
ğŸ”¸ è´Ÿè½½å‡è¡¡ï¼šæ™ºèƒ½åˆ†é…è¯·æ±‚ï¼Œé¿å…å•ç‚¹è¿‡è½½
ğŸ”¸ åå‘ä»£ç†ï¼šç«™åœ¨æœåŠ¡å™¨è§’åº¦ï¼Œä»£ç†å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚
ğŸ”¸ å¥åº·æ£€æŸ¥ï¼šå®šæœŸæ£€æµ‹æœåŠ¡å™¨çŠ¶æ€ï¼Œå®ç°æ•…éšœè½¬ç§»
ğŸ”¸ ä¼šè¯ä¿æŒï¼šä¿è¯ç”¨æˆ·è¯·æ±‚çš„è¿ç»­æ€§å’Œæ•°æ®ä¸€è‡´æ€§
```

### 7.2 å…³é”®æŠ€æœ¯å¯¹æ¯”


**ğŸ”¹ Nginx vs Apacheå¯¹æ¯”**ï¼š

| ç‰¹å¾ | **Nginx** | **Apache** |
|------|----------|-----------|
| **æ€§èƒ½** | `äº‹ä»¶é©±åŠ¨ï¼Œé«˜å¹¶å‘` | `è¿›ç¨‹/çº¿ç¨‹æ¨¡å‹ï¼Œèµ„æºæ¶ˆè€—å¤§` |
| **é…ç½®** | `ç®€æ´æ¸…æ™°` | `åŠŸèƒ½ä¸°å¯Œï¼Œé…ç½®å¤æ‚` |
| **é™æ€æ–‡ä»¶** | `å¤„ç†æ•ˆç‡æé«˜` | `åŠŸèƒ½å¼ºå¤§ä½†ç›¸å¯¹è¾ƒæ…¢` |
| **åŠ¨æ€å†…å®¹** | `éœ€è¦è½¬å‘ç»™åç«¯` | `å¯ç›´æ¥å¤„ç†PHPç­‰` |
| **å­¦ä¹ æˆæœ¬** | `è¾ƒä½` | `è¾ƒé«˜` |

**ğŸ”¹ è´Ÿè½½å‡è¡¡ç®—æ³•é€‰æ‹©**ï¼š

```
è½®è¯¢ç®—æ³• â†’ é€‚åˆï¼šæœåŠ¡å™¨æ€§èƒ½ç›¸è¿‘
åŠ æƒè½®è¯¢ â†’ é€‚åˆï¼šæœåŠ¡å™¨æ€§èƒ½ä¸åŒ
æœ€å°‘è¿æ¥ â†’ é€‚åˆï¼šé•¿è¿æ¥åº”ç”¨
IPå“ˆå¸Œ â†’ é€‚åˆï¼šéœ€è¦ä¼šè¯ä¿æŒ
```

### 7.3 å®è·µåº”ç”¨è¦ç‚¹


**âœ… æœ¬èŠ‚æ£€æŸ¥æ¸…å•**ï¼š
- [ ] èƒ½è§£é‡Šé›†ç¾¤å’Œè´Ÿè½½å‡è¡¡çš„æ¦‚å¿µå·®å¼‚
- [ ] èƒ½é…ç½®åŸºæœ¬çš„Nginxåå‘ä»£ç†
- [ ] èƒ½ç†è§£ä¸åŒè´Ÿè½½å‡è¡¡ç®—æ³•çš„é€‚ç”¨åœºæ™¯  
- [ ] èƒ½è®¾ç½®å¥åº·æ£€æŸ¥å’Œæ•…éšœè½¬ç§»
- [ ] èƒ½ç›‘æ§é›†ç¾¤è¿è¡ŒçŠ¶æ€

**ğŸ¯ ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ**ï¼š
1. **å¤‡ç”¨æœåŠ¡å™¨**ï¼šè‡³å°‘é…ç½®ä¸€å°backupæœåŠ¡å™¨
2. **ç›‘æ§å‘Šè­¦**ï¼šå»ºç«‹å®Œå–„çš„ç›‘æ§ä½“ç³»
3. **æ—¥å¿—ç®¡ç†**ï¼šç»Ÿä¸€æ”¶é›†å’Œåˆ†æè®¿é—®æ—¥å¿—
4. **å®‰å…¨é˜²æŠ¤**ï¼šé…ç½®é˜²ç«å¢™å’ŒSSLè¯ä¹¦
5. **æ€§èƒ½è°ƒä¼˜**ï¼šæ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹è°ƒæ•´å‚æ•°

> ğŸ’¡ **ä¸€å¥è¯æ€»ç»“**ï¼š
> 
> é›†ç¾¤å°±æ˜¯"**å›¢é˜Ÿåˆä½œ**"ï¼Œè´Ÿè½½å‡è¡¡æ˜¯"**æ™ºèƒ½åˆ†å·¥**"
> è®©å¤šå°æœåŠ¡å™¨åƒä¸€å°è¶…çº§æœåŠ¡å™¨ä¸€æ ·å·¥ä½œ

**ğŸ§  è®°å¿†é”šç‚¹**ï¼š
- **é›†ç¾¤**ï¼šå¤šå°æœåŠ¡å™¨ = å›¢é˜Ÿåä½œ
- **è´Ÿè½½å‡è¡¡**ï¼šæ™ºèƒ½åˆ†é… = é¡¹ç›®ç»ç†
- **åå‘ä»£ç†**ï¼šä»£ç†æœåŠ¡å™¨ = å‰å°æ¥å¾…  
- **å¥åº·æ£€æŸ¥**ï¼šå®šæœŸä½“æ£€ = é¢„é˜²æ•…éšœ

**ğŸ¬ åº”ç”¨åœºæ™¯æ€»ç»“**ï¼š
- **ç”µå•†ç½‘ç«™**ï¼šå¤„ç†åŒ11é«˜å¹¶å‘æµé‡
- **è§†é¢‘ç½‘ç«™**ï¼šåˆ†å‘å¤§é‡è§†é¢‘æµ
- **ä¼ä¸šåº”ç”¨**ï¼šä¿è¯7x24å°æ—¶æœåŠ¡
- **æ¸¸æˆæœåŠ¡**ï¼šæ”¯æŒå¤§é‡ç©å®¶åŒæ—¶åœ¨çº¿

è¿™å¥—é›†ç¾¤å’Œè´Ÿè½½å‡è¡¡æŠ€æœ¯æ˜¯JavaWebé¡¹ç›®ä»**å•æœºç‰ˆ**è¿ˆå‘**ä¼ä¸šçº§**çš„å…³é”®ä¸€æ­¥ï¼