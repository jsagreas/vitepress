---
title: 3、fn集合与转义函数
---
## 📚 目录

1. [JSTL函数标签库概述](#1-JSTL函数标签库概述)
2. [XML与HTML转义函数](#2-XML与HTML转义函数)
3. [集合长度与空值处理](#3-集合长度与空值处理)
4. [安全输出最佳实践](#4-安全输出最佳实践)
5. [实际开发应用场景](#5-实际开发应用场景)
6. [核心要点总结](#6-核心要点总结)

---

## 1. 🎯 JSTL函数标签库概述


### 1.1 什么是JSTL函数标签库


**简单理解**：就像数学中的函数一样，给它一个输入，它帮你处理后返回结果。

想象你在做网页开发，经常需要处理各种数据：
- 用户输入的内容可能包含特殊字符，需要转义
- 需要检查集合是否为空
- 要获取字符串或集合的长度

JSTL的fn标签库就是专门解决这些常见问题的"工具箱"。

```jsp
<%-- 引入fn标签库 --%>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>

<%-- 就像调用工具一样简单 --%>
${fn:length(userList)}  <!-- 获取用户列表长度 -->
${fn:escapeXml(userInput)}  <!-- 转义用户输入 -->
```

### 1.2 为什么需要函数标签库


**🔍 实际问题场景**：

```
场景1：用户评论显示
用户输入：我觉得这个<script>alert('hack')</script>很好用
直接显示：💀 网页被恶意代码攻击
使用转义：✅ 安全显示为普通文本

场景2：数据列表展示  
情况：用户列表可能为空
不处理：💀 页面报错或显示异常
使用函数：✅ 优雅处理空值情况

场景3：条件判断
需求：根据集合大小显示不同内容
传统方式：💀 需要写Java代码判断
使用函数：✅ 直接在JSP中完成
```

### 1.3 fn标签库的核心特点


**⚡ 主要特征**：
```
🔸 简单易用：像调用函数一样使用
🔸 安全可靠：内置防XSS攻击机制
🔸 性能优化：比Java代码更高效
🔸 代码清晰：逻辑直观，易于维护
🔸 标准化：JSP标准的一部分
```

---

## 2. 🛡️ XML与HTML转义函数


### 2.1 fn:escapeXml 核心转义函数


**什么是XML转义？**
把一些在XML/HTML中有特殊意义的字符转换成普通文本，这样就不会被浏览器当成代码执行。

**🎯 转义对照表**：

| 原始字符 | 转义后 | 说明 |
|---------|-------|------|
| `<` | `&lt;` | 小于号 |
| `>` | `&gt;` | 大于号 |
| `&` | `&amp;` | 与符号 |
| `"` | `&quot;` | 双引号 |
| `'` | `&#039;` | 单引号 |

### 2.2 实际使用示例


**📝 基本语法**：
```jsp
<%-- 基本转义语法 --%>
${fn:escapeXml(变量名)}

<%-- 实际使用示例 --%>
<c:set var="userComment" value="我喜欢<b>粗体</b>和&符号"/>
<p>原始内容：${userComment}</p>
<p>转义内容：${fn:escapeXml(userComment)}</p>
```

**🌐 浏览器显示效果**：
```
原始内容：我喜欢粗体和&符号  (粗体会被渲染)
转义内容：我喜欢<b>粗体</b>和&符号  (显示为普通文本)
```

### 2.3 防XSS攻击实践


**⚠️ 安全场景演示**：

```jsp
<%-- 模拟用户恶意输入 --%>
<c:set var="maliciousInput" value="<script>alert('网站被攻击了!')</script>正常内容"/>

<%-- 危险做法：直接输出 --%>
<div class="danger">
    <h4>❌ 危险输出（不要这样做）：</h4>
    <p>${maliciousInput}</p>
    <!-- 这会执行JavaScript代码！ -->
</div>

<%-- 安全做法：使用转义 --%>
<div class="safe">
    <h4>✅ 安全输出：</h4>
    <p>${fn:escapeXml(maliciousInput)}</p>
    <!-- 恶意代码变成普通文本显示 -->
</div>
```

### 2.4 特殊字符处理技巧


**🔧 处理复杂内容**：
```jsp
<%-- 处理包含引号的内容 --%>
<c:set var="quotedText" value='他说："这个'很好用'，我喜欢"'/>

<%-- 在HTML属性中安全使用 --%>
<input type="text" value="${fn:escapeXml(quotedText)}" />
<div title="${fn:escapeXml(quotedText)}">鼠标悬停查看</div>

<%-- 处理URL参数 --%>
<c:set var="searchKeyword" value="Java & Web开发"/>
<a href="search.jsp?q=${fn:escapeXml(searchKeyword)}">搜索链接</a>
```

---

## 3. 📊 集合长度与空值处理


### 3.1 fn:length 长度获取函数


**什么是长度函数？**
就像测量工具一样，帮你测量各种数据的"大小"：
- 字符串有多少个字符
- 数组有多少个元素  
- 集合有多少个对象

**📏 基本用法**：
```jsp
<%-- 字符串长度 --%>
<c:set var="message" value="Hello World"/>
<p>消息长度：${fn:length(message)} 个字符</p>

<%-- 数组长度 --%>
<c:set var="colors" value="${['红色', '绿色', '蓝色']}"/>
<p>颜色数量：${fn:length(colors)} 种</p>

<%-- List集合长度 --%>
<p>用户数量：${fn:length(userList)} 人</p>
```

### 3.2 空值安全检查


**🛡️ 空值处理策略**：

```jsp
<%-- 安全的长度检查 --%>
<c:choose>
    <c:when test="${fn:length(userList) > 0}">
        <h3>用户列表 (共 ${fn:length(userList)} 人)</h3>
        <c:forEach var="user" items="${userList}">
            <p>${fn:escapeXml(user.name)}</p>
        </c:forEach>
    </c:when>
    <c:otherwise>
        <p class="empty-message">暂无用户数据</p>
    </c:otherwise>
</c:choose>
```

**💡 实用判断技巧**：
```jsp
<%-- 组合使用多个函数 --%>
<c:if test="${not empty searchResults and fn:length(searchResults) > 0}">
    <div class="search-info">
        找到 ${fn:length(searchResults)} 条相关结果
    </div>
</c:if>

<%-- 根据长度显示不同样式 --%>
<div class="${fn:length(messageList) > 10 ? 'long-list' : 'short-list'}">
    <c:forEach var="msg" items="${messageList}">
        <p>${fn:escapeXml(msg.content)}</p>
    </c:forEach>
</div>
```

### 3.3 分页显示应用


**📄 分页逻辑实现**：
```jsp
<%-- 分页信息显示 --%>
<c:set var="totalItems" value="${fn:length(allProducts)}"/>
<c:set var="itemsPerPage" value="10"/>
<c:set var="totalPages" value="${(totalItems + itemsPerPage - 1) / itemsPerPage}"/>

<div class="pagination-info">
    <p>
        共 ${totalItems} 个商品，
        每页显示 ${itemsPerPage} 个，
        共 ${totalPages} 页
    </p>
</div>

<%-- 根据数量决定是否显示分页 --%>
<c:if test="${fn:length(allProducts) > itemsPerPage}">
    <div class="pagination">
        <!-- 分页控件 -->
        <button>上一页</button>
        <button>下一页</button>
    </div>
</c:if>
```

---

## 4. 🔒 安全输出最佳实践


### 4.1 输出安全原则


**🎯 核心原则**：
```
黄金法则：永远不要信任用户输入！

安全输出三步骤：
1️⃣ 接收数据 → 验证格式
2️⃣ 存储数据 → 原样保存
3️⃣ 输出数据 → 转义显示
```

### 4.2 不同场景的安全策略


**📍 场景一：用户评论系统**
```jsp
<%-- 评论显示安全模板 --%>
<div class="comment">
    <div class="user-info">
        <span class="username">${fn:escapeXml(comment.username)}</span>
        <span class="time">${comment.createTime}</span>
    </div>
    <div class="content">
        ${fn:escapeXml(comment.content)}
    </div>
</div>
```

**📍 场景二：搜索结果高亮**
```jsp
<%-- 搜索关键词安全处理 --%>
<c:set var="safeKeyword" value="${fn:escapeXml(searchKeyword)}"/>
<div class="search-header">
    <h2>搜索 "${safeKeyword}" 的结果</h2>
    <p>找到 ${fn:length(searchResults)} 条结果</p>
</div>
```

**📍 场景三：表单回显**
```jsp
<%-- 表单数据安全回显 --%>
<form method="post">
    <input type="text" 
           name="username" 
           value="${fn:escapeXml(param.username)}"
           placeholder="请输入用户名"/>
    
    <textarea name="description" rows="5">${fn:escapeXml(param.description)}</textarea>
    
    <button type="submit">提交</button>
</form>
```

### 4.3 性能优化建议


**⚡ 优化策略**：

```jsp
<%-- 避免重复转义 --%>
<c:set var="safeContent" value="${fn:escapeXml(userInput)}"/>
<div class="title">${safeContent}</div>
<div class="description">${safeContent}</div>  <%-- 复用转义结果 --%>

<%-- 条件转义 --%>
<c:choose>
    <c:when test="${contentType == 'safe'}">
        ${trustedContent}  <%-- 已确认安全的内容 --%>
    </c:when>
    <c:otherwise>
        ${fn:escapeXml(userContent)}  <%-- 用户输入需转义 --%>
    </c:otherwise>
</c:choose>
```

---

## 5. 🎨 实际开发应用场景


### 5.1 博客系统应用


**📝 文章显示页面**：
```jsp
<%-- 博客文章安全显示 --%>
<article class="blog-post">
    <header>
        <h1>${fn:escapeXml(article.title)}</h1>
        <div class="meta">
            <span>作者：${fn:escapeXml(article.author)}</span>
            <span>字数：${fn:length(article.content)} 字</span>
        </div>
    </header>
    
    <div class="content">
        <%-- 文章内容（假设已经过安全处理）--%>
        ${article.htmlContent}
    </div>
    
    <div class="tags">
        <c:if test="${not empty article.tags and fn:length(article.tags) > 0}">
            <h4>标签 (${fn:length(article.tags)})：</h4>
            <c:forEach var="tag" items="${article.tags}">
                <span class="tag">${fn:escapeXml(tag)}</span>
            </c:forEach>
        </c:if>
    </div>
</article>
```

### 5.2 购物车系统应用


**🛒 购物车页面**：
```jsp
<%-- 购物车商品列表 --%>
<div class="cart">
    <h2>购物车</h2>
    
    <c:choose>
        <c:when test="${not empty cartItems and fn:length(cartItems) > 0}">
            <div class="cart-header">
                <p>您的购物车中有 ${fn:length(cartItems)} 件商品</p>
            </div>
            
            <c:forEach var="item" items="${cartItems}">
                <div class="cart-item">
                    <div class="product-name">${fn:escapeXml(item.productName)}</div>
                    <div class="quantity">数量：${item.quantity}</div>
                    <div class="price">单价：￥${item.price}</div>
                </div>
            </c:forEach>
            
            <div class="cart-summary">
                <p>总计：￥${cartTotal}</p>
                <button class="checkout-btn">结算</button>
            </div>
        </c:when>
        <c:otherwise>
            <div class="empty-cart">
                <p>购物车是空的</p>
                <a href="products.jsp">去购物</a>
            </div>
        </c:otherwise>
    </c:choose>
</div>
```

### 5.3 用户管理系统应用


**👥 用户列表页面**：
```jsp
<%-- 用户管理界面 --%>
<div class="user-management">
    <div class="header">
        <h2>用户管理</h2>
        <div class="stats">
            <c:choose>
                <c:when test="${not empty users}">
                    <span class="user-count">
                        总用户数：${fn:length(users)} 人
                    </span>
                </c:when>
                <c:otherwise>
                    <span class="no-users">暂无用户</span>
                </c:otherwise>
            </c:choose>
        </div>
    </div>
    
    <c:if test="${fn:length(users) > 0}">
        <table class="user-table">
            <thead>
                <tr>
                    <th>用户名</th>
                    <th>邮箱</th>
                    <th>注册时间</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                <c:forEach var="user" items="${users}" varStatus="status">
                    <tr class="${status.index % 2 == 0 ? 'even' : 'odd'}">
                        <td>${fn:escapeXml(user.username)}</td>
                        <td>${fn:escapeXml(user.email)}</td>
                        <td>${user.registerTime}</td>
                        <td>
                            <a href="edit-user.jsp?id=${user.id}">编辑</a>
                            <a href="delete-user.jsp?id=${user.id}" 
                               onclick="return confirm('确定删除用户 ${fn:escapeXml(user.username)} 吗？')">
                               删除
                            </a>
                        </td>
                    </tr>
                </c:forEach>
            </tbody>
        </table>
        
        <%-- 分页显示 --%>
        <c:if test="${fn:length(users) > 20}">
            <div class="pagination">
                <p>数据较多，建议添加分页功能</p>
            </div>
        </c:if>
    </c:if>
</div>
```

### 5.4 搜索功能应用


**🔍 智能搜索页面**：
```jsp
<%-- 搜索结果页面 --%>
<div class="search-page">
    <%-- 搜索框 --%>
    <form class="search-form" method="get">
        <input type="text" 
               name="keyword" 
               value="${fn:escapeXml(param.keyword)}"
               placeholder="请输入搜索关键词"/>
        <button type="submit">搜索</button>
    </form>
    
    <%-- 搜索结果 --%>
    <c:if test="${not empty param.keyword}">
        <div class="search-results">
            <div class="search-info">
                <h3>搜索 "${fn:escapeXml(param.keyword)}" 的结果</h3>
                
                <c:choose>
                    <c:when test="${not empty searchResults and fn:length(searchResults) > 0}">
                        <p class="result-count">
                            找到 ${fn:length(searchResults)} 条相关结果
                        </p>
                    </c:when>
                    <c:otherwise>
                        <p class="no-results">
                            没有找到与 "${fn:escapeXml(param.keyword)}" 相关的结果
                        </p>
                    </c:otherwise>
                </c:choose>
            </div>
            
            <%-- 结果列表 --%>
            <c:if test="${fn:length(searchResults) > 0}">
                <div class="results-list">
                    <c:forEach var="result" items="${searchResults}">
                        <div class="result-item">
                            <h4>
                                <a href="detail.jsp?id=${result.id}">
                                    ${fn:escapeXml(result.title)}
                                </a>
                            </h4>
                            <p class="description">
                                ${fn:escapeXml(result.description)}
                            </p>
                            <p class="meta">
                                分类：${fn:escapeXml(result.category)} | 
                                时间：${result.createTime}
                            </p>
                        </div>
                    </c:forEach>
                </div>
            </c:if>
        </div>
    </c:if>
</div>
```

---

## 6. 📋 核心要点总结


### 6.1 必须掌握的基本概念


```
🔸 fn标签库：JSTL提供的工具函数集合，解决常见数据处理问题
🔸 fn:escapeXml：XML/HTML转义函数，防止XSS攻击的核心工具  
🔸 fn:length：长度获取函数，统计字符串、数组、集合的大小
🔸 空值处理：配合JSTL核心标签进行安全的空值检查
🔸 安全输出：永远转义用户输入，保护网站安全
```

### 6.2 关键理解要点


**🔹 为什么需要转义**：
```
网络安全威胁：
• 用户可能输入恶意代码
• 直接输出会执行JavaScript
• 造成XSS跨站脚本攻击

转义的本质：
• 把特殊字符变成普通文本
• 浏览器不会执行，只会显示
• 保护网站和用户安全
```

**🔹 什么时候使用length函数**：
```
常见应用场景：
• 判断数据是否存在（长度>0）
• 显示统计信息（共X条数据）
• 控制页面布局（根据数量调整样式）
• 分页计算（总页数=总数据/每页数量）
```

**🔹 函数组合使用技巧**：
```
组合策略：
• fn:length + 条件判断 = 智能显示
• fn:escapeXml + 循环输出 = 安全列表
• empty检查 + fn:length = 双重保险
• 多个函数嵌套 = 复杂逻辑处理
```

### 6.3 实际应用指导


**💼 开发最佳实践**：
```
安全编码规范：
1. 🔒 用户输入必须转义
2. 📏 集合操作前检查长度
3. ⚡ 避免重复调用函数
4. 🧹 保持代码简洁易读
5. 🧪 充分测试边界情况
```

**🛠️ 常见使用模式**：
```jsp
<%-- 模式1：安全显示用户数据 --%>
<div class="user-content">
    ${fn:escapeXml(userData)}
</div>

<%-- 模式2：条件显示列表 --%>
<c:if test="${fn:length(dataList) > 0}">
    <!-- 显示列表内容 -->
</c:if>

<%-- 模式3：统计信息显示 --%>
<span class="count">共 ${fn:length(items)} 项</span>

<%-- 模式4：表单数据回显 --%>
<input value="${fn:escapeXml(param.inputName)}"/>
```

### 6.4 学习建议和注意事项


**📚 学习路径**：
```
第一步：理解安全问题
• 了解XSS攻击原理
• 认识转义的重要性

第二步：掌握基本函数
• fn:escapeXml的使用
• fn:length的各种场景

第三步：实践应用
• 在实际项目中使用
• 形成安全编码习惯

第四步：深入优化
• 性能考虑
• 复杂场景处理
```

**⚠️ 常见误区**：
```
❌ 认为内部数据不需要转义
   → 内部数据也可能包含特殊字符

❌ 过度依赖转义函数
   → 应该在数据入口处验证

❌ 忘记检查空值情况
   → 空集合调用length会返回0，但要防null

❌ 性能不考虑
   → 避免在循环中重复转义相同数据
```

**💡 实用技巧**：
```
开发技巧：
• 建立代码模板，包含常用的安全检查
• 使用IDE代码片段，快速插入转义代码
• 定期code review，检查安全问题
• 写单元测试，测试边界情况
```

**🧠 记忆要点**：
```
核心公式：
用户数据 + fn:escapeXml = 安全输出
数据集合 + fn:length = 智能处理
空值检查 + 函数调用 = 稳定系统
```

**总结语**：
JSTL函数标签库虽然简单，但是Web开发中不可缺少的安全工具。掌握好fn:escapeXml和fn:length两个核心函数，养成安全编码的习惯，就能写出既安全又友好的Web应用。

记住：**宁可多转义一次，也不要留下安全隐患！**