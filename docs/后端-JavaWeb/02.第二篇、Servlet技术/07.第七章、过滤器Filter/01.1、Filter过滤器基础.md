---
title: 1ã€Filterè¿‡æ»¤å™¨åŸºç¡€
---
## ğŸ“š ç›®å½•

1. [Filterè¿‡æ»¤å™¨æ¦‚å¿µç†è§£](#1-Filterè¿‡æ»¤å™¨æ¦‚å¿µç†è§£)
2. [Filteræ¥å£å®ç°è¯¦è§£](#2-Filteræ¥å£å®ç°è¯¦è§£)
3. [è¿‡æ»¤å™¨é“¾FilterChainæœºåˆ¶](#3-è¿‡æ»¤å™¨é“¾FilterChainæœºåˆ¶)
4. [doFilteræ–¹æ³•æ·±å…¥ç†è§£](#4-doFilteræ–¹æ³•æ·±å…¥ç†è§£)
5. [é“¾å¼è°ƒç”¨æœºåˆ¶åŸç†](#5-é“¾å¼è°ƒç”¨æœºåˆ¶åŸç†)
6. [æ‹¦æˆªå¤„ç†æœºåˆ¶åº”ç”¨](#6-æ‹¦æˆªå¤„ç†æœºåˆ¶åº”ç”¨)
7. [AOPæ€æƒ³åœ¨Filterä¸­çš„ä½“ç°](#7-AOPæ€æƒ³åœ¨Filterä¸­çš„ä½“ç°)
8. [Filterå®æˆ˜æ¡ˆä¾‹](#8-Filterå®æˆ˜æ¡ˆä¾‹)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” Filterè¿‡æ»¤å™¨æ¦‚å¿µç†è§£


### 1.1 ä»€ä¹ˆæ˜¯Filterè¿‡æ»¤å™¨

ğŸ¯ **ç”Ÿæ´»åŒ–ç†è§£**ï¼šFilterå°±åƒç”Ÿæ´»ä¸­çš„"æ£€æŸ¥ç«™"æˆ–"ç­›é€‰å™¨"

```
ç”Ÿæ´»ä¸­çš„è¿‡æ»¤åœºæ™¯ï¼š
æœºåœºå®‰æ£€ â†’ æ£€æŸ¥ä¹˜å®¢å’Œè¡Œæ â†’ æ”¾è¡Œæˆ–æ‹¦æˆª
æ°´å‡€åŒ–å™¨ â†’ è¿‡æ»¤æ±¡æŸ“ç‰© â†’ è¾“å‡ºçº¯å‡€æ°´
é—¨å«æ£€æŸ¥ â†’ éªŒè¯èº«ä»½ä¿¡æ¯ â†’ å…è®¸æˆ–æ‹’ç»è¿›å…¥

JavaWEBä¸­çš„Filterï¼š
ç”¨æˆ·è¯·æ±‚ â†’ Filteræ£€æŸ¥å¤„ç† â†’ è½¬å‘ç»™Servlet â†’ è¿”å›å“åº”
```

**ğŸ”¸ Filterçš„æ ¸å¿ƒä½œç”¨**
```
è¯·æ±‚é¢„å¤„ç†ï¼š
- ç¼–ç è®¾ç½®ï¼ˆè§£å†³ä¸­æ–‡ä¹±ç ï¼‰
- ç”¨æˆ·æƒé™éªŒè¯
- æ—¥å¿—è®°å½•
- æ•°æ®æ ¼å¼è½¬æ¢

å“åº”åå¤„ç†ï¼š
- å“åº”å†…å®¹ä¿®æ”¹
- æ€§èƒ½ç»Ÿè®¡
- èµ„æºæ¸…ç†
- é”™è¯¯å¤„ç†
```

### 1.2 Filteråœ¨Webåº”ç”¨ä¸­çš„ä½ç½®

**ğŸ“Š Webè¯·æ±‚å¤„ç†æµç¨‹å›¾**

```
æµè§ˆå™¨å‘èµ·è¯·æ±‚
        â†“
    Webå®¹å™¨æ¥æ”¶
        â†“
   Filter1è¿‡æ»¤å¤„ç† â†â”€â”
        â†“          â”‚
   Filter2è¿‡æ»¤å¤„ç†  â”‚  è¿‡æ»¤å™¨é“¾
        â†“          â”‚  (FilterChain)
   Filter3è¿‡æ»¤å¤„ç† â†â”€â”˜
        â†“
    Servletå¤„ç†ä¸šåŠ¡
        â†“
      JSPæ¸²æŸ“é¡µé¢
        â†“
   è¿‡æ»¤å™¨é“¾åå‘å¤„ç†
        â†“
    æµè§ˆå™¨æ¥æ”¶å“åº”
```

### 1.3 ä¸ºä»€ä¹ˆéœ€è¦Filterè¿‡æ»¤å™¨

**ğŸ’¡ è§£å†³çš„å®é™…é—®é¢˜**

```
æ²¡æœ‰Filteræ—¶çš„ç—›ç‚¹ï¼š

1. é‡å¤ä»£ç é—®é¢˜
   æ¯ä¸ªServletéƒ½è¦å†™ï¼š
   - ç¼–ç è®¾ç½®ä»£ç 
   - æƒé™éªŒè¯ä»£ç   
   - æ—¥å¿—è®°å½•ä»£ç 

2. ç»´æŠ¤å›°éš¾
   ä¿®æ”¹å…±åŒé€»è¾‘éœ€è¦æ”¹å¾ˆå¤šåœ°æ–¹
   å®¹æ˜“é—æ¼æŸäº›Servlet

3. ä»£ç æ··ä¹±
   ä¸šåŠ¡é€»è¾‘å’Œé€šç”¨å¤„ç†æ··åœ¨ä¸€èµ·
   è¿åå•ä¸€èŒè´£åŸåˆ™

ä½¿ç”¨Filteråçš„ä¼˜åŠ¿ï¼š
âœ… ç»Ÿä¸€å¤„ç†å…±åŒé€»è¾‘
âœ… ä¸šåŠ¡ä»£ç æ›´çº¯å‡€
âœ… ç»´æŠ¤æ›´ç®€å•
âœ… æ‰©å±•æ›´çµæ´»
```

## 2. ğŸ› ï¸ Filteræ¥å£å®ç°è¯¦è§£


### 2.1 Filteræ¥å£çš„æ ¸å¿ƒæ–¹æ³•

**ğŸ“‹ Filteræ¥å£ç»“æ„**

```java
public interface Filter {
    // 1. åˆå§‹åŒ–æ–¹æ³• - åªæ‰§è¡Œä¸€æ¬¡
    void init(FilterConfig filterConfig) throws ServletException;
    
    // 2. è¿‡æ»¤å¤„ç†æ–¹æ³• - æ¯æ¬¡è¯·æ±‚éƒ½æ‰§è¡Œ
    void doFilter(ServletRequest request, 
                  ServletResponse response,
                  FilterChain chain) throws IOException, ServletException;
    
    // 3. é”€æ¯æ–¹æ³• - åªæ‰§è¡Œä¸€æ¬¡
    void destroy();
}
```

**ğŸ”¸ æ–¹æ³•æ‰§è¡Œæ—¶æœº**
```
Webåº”ç”¨ç”Ÿå‘½å‘¨æœŸï¼š
å¯åŠ¨æ—¶ â†’ init()æ–¹æ³•æ‰§è¡Œ
è¿è¡Œä¸­ â†’ æ¯ä¸ªè¯·æ±‚è§¦å‘doFilter()æ–¹æ³•
åœæ­¢æ—¶ â†’ destroy()æ–¹æ³•æ‰§è¡Œ

ç±»æ¯”ç†è§£ï¼š
init() = å‘˜å·¥å…¥èŒåŸ¹è®­ï¼ˆä¸€æ¬¡æ€§ï¼‰
doFilter() = æ—¥å¸¸å·¥ä½œå¤„ç†ï¼ˆé‡å¤æ‰§è¡Œï¼‰
destroy() = å‘˜å·¥ç¦»èŒäº¤æ¥ï¼ˆä¸€æ¬¡æ€§ï¼‰
```

### 2.2 åˆ›å»ºç¬¬ä¸€ä¸ªFilter

**ğŸ¯ ç¼–ç è®¾ç½®è¿‡æ»¤å™¨å®ä¾‹**

```java
// CharacterEncodingFilter.java
public class CharacterEncodingFilter implements Filter {
    
    private String encoding = "UTF-8";  // é»˜è®¤ç¼–ç 
    
    @Override
    public void init(FilterConfig filterConfig) throws ServletException {
        // è·å–åˆå§‹åŒ–å‚æ•°
        String configEncoding = filterConfig.getInitParameter("encoding");
        if (configEncoding != null) {
            this.encoding = configEncoding;
        }
        System.out.println("ç¼–ç è¿‡æ»¤å™¨åˆå§‹åŒ–å®Œæˆï¼Œç¼–ç ï¼š" + encoding);
    }
    
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, 
                        FilterChain chain) throws IOException, ServletException {
        
        // è¯·æ±‚å‰å¤„ç†ï¼šè®¾ç½®è¯·æ±‚ç¼–ç 
        request.setCharacterEncoding(encoding);
        response.setCharacterEncoding(encoding);
        response.setContentType("text/html;charset=" + encoding);
        
        System.out.println("è®¾ç½®ç¼–ç ä¸ºï¼š" + encoding);
        
        // ç»§ç»­æ‰§è¡Œåç»­è¿‡æ»¤å™¨æˆ–Servlet
        chain.doFilter(request, response);
        
        // å“åº”åå¤„ç†ï¼ˆå¦‚æœéœ€è¦ï¼‰
        System.out.println("ç¼–ç å¤„ç†å®Œæˆ");
    }
    
    @Override
    public void destroy() {
        System.out.println("ç¼–ç è¿‡æ»¤å™¨é”€æ¯");
    }
}
```

### 2.3 Filteré…ç½®æ–¹å¼

**âš™ï¸ ä¸¤ç§ä¸»è¦é…ç½®æ–¹å¼**

**æ–¹å¼ä¸€ï¼šweb.xmlé…ç½®**
```xml
<!-- web.xmlä¸­é…ç½® -->
<filter>
    <filter-name>CharacterEncodingFilter</filter-name>
    <filter-class>com.example.filter.CharacterEncodingFilter</filter-class>
    <!-- åˆå§‹åŒ–å‚æ•° -->
    <init-param>
        <param-name>encoding</param-name>
        <param-value>UTF-8</param-value>
    </init-param>
</filter>

<!-- è¿‡æ»¤å™¨æ˜ å°„ -->
<filter-mapping>
    <filter-name>CharacterEncodingFilter</filter-name>
    <url-pattern>/*</url-pattern>  <!-- æ‹¦æˆªæ‰€æœ‰è¯·æ±‚ -->
</filter-mapping>
```

**æ–¹å¼äºŒï¼šæ³¨è§£é…ç½®**
```java
@WebFilter(
    filterName = "CharacterEncodingFilter",
    urlPatterns = {"/*"},  // æ‹¦æˆªè·¯å¾„
    initParams = {
        @WebInitParam(name = "encoding", value = "UTF-8")
    }
)
public class CharacterEncodingFilter implements Filter {
    // å®ç°ä»£ç åŒä¸Š
}
```

## 3. ğŸ”— è¿‡æ»¤å™¨é“¾FilterChainæœºåˆ¶


### 3.1 FilterChainæ˜¯ä»€ä¹ˆ

ğŸ¯ **é“¾æ¡å¼å¤„ç†æœºåˆ¶ç†è§£**

```
ç°å®ä¸­çš„é“¾æ¡å¤„ç†ï¼š
å·¥å‚æµæ°´çº¿ï¼šåŸæ–™ â†’ å·¥åº1 â†’ å·¥åº2 â†’ å·¥åº3 â†’ æˆå“
å®¡æ‰¹æµç¨‹ï¼šç”³è¯· â†’ éƒ¨é—¨ä¸»ç®¡ â†’ åˆ†ç®¡é¢†å¯¼ â†’ æ€»ç»ç† â†’ æ‰¹å‡†

FilterChainæœºåˆ¶ï¼š
è¯·æ±‚ â†’ Filter1 â†’ Filter2 â†’ Filter3 â†’ Servlet â†’ å“åº”
      â†‘_________________________________â†“
           å“åº”æ—¶åå‘ç»è¿‡æ¯ä¸ªFilter
```

### 3.2 FilterChainçš„å·¥ä½œåŸç†

**ğŸ”„ é“¾å¼è°ƒç”¨çš„å†…éƒ¨æœºåˆ¶**

```
FilterChainå†…éƒ¨ç»“æ„ï¼ˆç®€åŒ–ç†è§£ï¼‰ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   FilterChain   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ filters[]æ•°ç»„   â”‚ â† å­˜å‚¨æ‰€æœ‰Filter
â”‚ currentIndex    â”‚ â† å½“å‰æ‰§è¡Œä½ç½®
â”‚ doFilter()æ–¹æ³•  â”‚ â† æ‰§è¡Œä¸‹ä¸€ä¸ªFilter
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ‰§è¡Œè¿‡ç¨‹ï¼š
1. å®¹å™¨åˆ›å»ºFilterChainï¼ŒåŒ…å«æ‰€æœ‰åŒ¹é…çš„Filter
2. è°ƒç”¨ç¬¬ä¸€ä¸ªFilterçš„doFilter()æ–¹æ³•
3. Filterå¤„ç†å®Œæˆåè°ƒç”¨chain.doFilter()
4. FilterChainè‡ªåŠ¨è°ƒç”¨ä¸‹ä¸€ä¸ªFilter
5. ç›´åˆ°æœ€åä¸€ä¸ªFilterè°ƒç”¨Servlet
6. å“åº”æ—¶æŒ‰ç›¸åé¡ºåºè¿”å›
```

### 3.3 å¤šä¸ªFilterçš„æ‰§è¡Œé¡ºåº

**ğŸ“Š Filteræ‰§è¡Œé¡ºåºè§„åˆ™**

| é…ç½®æ–¹å¼ | **æ‰§è¡Œé¡ºåº** | **è¯´æ˜** |
|---------|-------------|---------|
| ğŸ”¸ **web.xmlé…ç½®** | `æŒ‰é…ç½®é¡ºåºæ‰§è¡Œ` | `å…ˆé…ç½®çš„å…ˆæ‰§è¡Œ` |
| ğŸ”¸ **æ³¨è§£é…ç½®** | `æŒ‰ç±»åå­—æ¯é¡ºåº` | `ä¸å¯é¢„æµ‹ï¼Œå»ºè®®ç”¨web.xml` |
| ğŸ”¸ **æ··åˆé…ç½®** | `web.xmlä¼˜å…ˆ` | `æ³¨è§£é…ç½®çš„åæ‰§è¡Œ` |

**ğŸ’¡ æ‰§è¡Œé¡ºåºç¤ºä¾‹**
```java
// å‡è®¾æœ‰ä¸‰ä¸ªFilteræŒ‰é¡ºåºé…ç½®
Filter1 â†’ Filter2 â†’ Filter3 â†’ Servlet

å®é™…æ‰§è¡Œæµç¨‹ï¼š
è¯·æ±‚é˜¶æ®µï¼š
Filter1.doFilter() å‰å¤„ç†
  â†’ Filter2.doFilter() å‰å¤„ç†  
    â†’ Filter3.doFilter() å‰å¤„ç†
      â†’ Servlet.service() ä¸šåŠ¡å¤„ç†
      
å“åº”é˜¶æ®µï¼ˆé€†åºï¼‰ï¼š
    â† Filter3.doFilter() åå¤„ç†
  â† Filter2.doFilter() åå¤„ç†
â† Filter1.doFilter() åå¤„ç†

ç±»ä¼¼äºï¼š(((è¯·æ±‚)))çš„åŒ…è£…è¿‡ç¨‹
```

## 4. âš¡ doFilteræ–¹æ³•æ·±å…¥ç†è§£


### 4.1 doFilteræ–¹æ³•çš„å‚æ•°è¯¦è§£

**ğŸ“‹ ä¸‰ä¸ªæ ¸å¿ƒå‚æ•°çš„ä½œç”¨**

```java
void doFilter(ServletRequest request,     // è¯·æ±‚å¯¹è±¡
              ServletResponse response,   // å“åº”å¯¹è±¡  
              FilterChain chain)         // è¿‡æ»¤å™¨é“¾

å‚æ•°ä½œç”¨åˆ†æï¼š
ServletRequest requestï¼š
- è·å–è¯·æ±‚å‚æ•°å’Œä¿¡æ¯
- è®¾ç½®è¯·æ±‚å±æ€§
- ä¿®æ”¹è¯·æ±‚ç¼–ç 

ServletResponse responseï¼š
- è®¾ç½®å“åº”å†…å®¹ç±»å‹
- å†™å…¥å“åº”æ•°æ®
- è®¾ç½®å“åº”å¤´ä¿¡æ¯

FilterChain chainï¼š
- è°ƒç”¨ä¸‹ä¸€ä¸ªFilter
- æ§åˆ¶è¯·æ±‚æ˜¯å¦ç»§ç»­
- å®ç°é“¾å¼å¤„ç†
```

### 4.2 doFilteræ–¹æ³•çš„æ‰§è¡Œæµç¨‹

**ğŸ”„ æ–¹æ³•å†…éƒ¨çš„æ ‡å‡†å¤„ç†æµç¨‹**

```java
public void doFilter(ServletRequest request, ServletResponse response, 
                    FilterChain chain) throws IOException, ServletException {
    
    // â•â•â•â•â•â•â•â•â•â•â• ç¬¬ä¸€é˜¶æ®µï¼šè¯·æ±‚é¢„å¤„ç† â•â•â•â•â•â•â•â•â•â•â•
    System.out.println("1. å¼€å§‹å¤„ç†è¯·æ±‚");
    
    // å¯ä»¥è¿›è¡Œçš„æ“ä½œï¼š
    // - ä¿®æ”¹è¯·æ±‚å‚æ•°
    // - è®¾ç½®è¯·æ±‚å±æ€§  
    // - éªŒè¯ç”¨æˆ·æƒé™
    // - è®°å½•è®¿é—®æ—¥å¿—
    request.setCharacterEncoding("UTF-8");
    
    // â•â•â•â•â•â•â•â•â•â•â• ç¬¬äºŒé˜¶æ®µï¼šå†³å®šæ˜¯å¦ç»§ç»­ â•â•â•â•â•â•â•â•â•â•â•
    // è¿™æ˜¯å…³é”®è°ƒç”¨ï¼ä¸è°ƒç”¨åˆ™è¯·æ±‚ç»ˆæ­¢
    chain.doFilter(request, response);
    
    // â•â•â•â•â•â•â•â•â•â•â• ç¬¬ä¸‰é˜¶æ®µï¼šå“åº”åå¤„ç† â•â•â•â•â•â•â•â•â•â•â•
    System.out.println("2. å¤„ç†å“åº”å®Œæˆ");
    
    // å¯ä»¥è¿›è¡Œçš„æ“ä½œï¼š
    // - ä¿®æ”¹å“åº”å†…å®¹
    // - æ·»åŠ å“åº”å¤´
    // - ç»Ÿè®¡å¤„ç†æ—¶é—´
    // - æ¸…ç†èµ„æº
}
```

### 4.3 ä¸åŒçš„doFilterå¤„ç†æ¨¡å¼

**ğŸ¯ ä¸‰ç§å…¸å‹çš„å¤„ç†æ¨¡å¼**

**æ¨¡å¼ä¸€ï¼šæ”¾è¡Œæ¨¡å¼**
```java
public void doFilter(ServletRequest request, ServletResponse response, 
                    FilterChain chain) throws IOException, ServletException {
    // ç®€å•é¢„å¤„ç†
    System.out.println("è¯·æ±‚å¼€å§‹å¤„ç†");
    
    // ç›´æ¥æ”¾è¡Œ
    chain.doFilter(request, response);
    
    // ç®€å•åå¤„ç†
    System.out.println("è¯·æ±‚å¤„ç†å®Œæˆ");
}
```

**æ¨¡å¼äºŒï¼šæ‹¦æˆªæ¨¡å¼**
```java
public void doFilter(ServletRequest request, ServletResponse response, 
                    FilterChain chain) throws IOException, ServletException {
    
    HttpServletRequest req = (HttpServletRequest) request;
    HttpServletResponse resp = (HttpServletResponse) response;
    
    // æƒé™æ£€æŸ¥
    String token = req.getHeader("Authorization");
    if (token == null || !isValidToken(token)) {
        // æ‹¦æˆªè¯·æ±‚ï¼Œä¸ç»§ç»­æ‰§è¡Œ
        resp.setStatus(401);
        resp.getWriter().write("æœªæˆæƒè®¿é—®");
        return;  // æ³¨æ„ï¼šä¸è°ƒç”¨chain.doFilter()
    }
    
    // éªŒè¯é€šè¿‡ï¼Œç»§ç»­æ‰§è¡Œ
    chain.doFilter(request, response);
}
```

**æ¨¡å¼ä¸‰ï¼šåŒ…è£…æ¨¡å¼**
```java
public void doFilter(ServletRequest request, ServletResponse response, 
                    FilterChain chain) throws IOException, ServletException {
    
    // åŒ…è£…è¯·æ±‚å¯¹è±¡ï¼Œæ·»åŠ é¢å¤–åŠŸèƒ½
    HttpServletRequestWrapper wrappedRequest = 
        new HttpServletRequestWrapper((HttpServletRequest) request) {
            @Override
            public String getParameter(String name) {
                String value = super.getParameter(name);
                // å¯¹å‚æ•°è¿›è¡Œç‰¹æ®Šå¤„ç†
                return value != null ? value.trim() : null;
            }
        };
    
    // ä½¿ç”¨åŒ…è£…åçš„è¯·æ±‚å¯¹è±¡
    chain.doFilter(wrappedRequest, response);
}
```

## 5. ğŸ”„ é“¾å¼è°ƒç”¨æœºåˆ¶åŸç†


### 5.1 é“¾å¼è°ƒç”¨çš„åº•å±‚å®ç°

**ğŸ”§ FilterChainçš„å†…éƒ¨å·¥ä½œæœºåˆ¶**

```
é“¾å¼è°ƒç”¨å®ç°åŸç†ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰ï¼š

public class ApplicationFilterChain implements FilterChain {
    private ApplicationFilterConfig[] filters;  // Filteræ•°ç»„
    private int pos = 0;                       // å½“å‰ä½ç½®
    private int n;                            // Filteræ€»æ•°
    private Servlet servlet;                  // ç›®æ ‡Servlet
    
    public void doFilter(ServletRequest request, ServletResponse response) {
        if (pos < n) {
            // è¿˜æœ‰Filteræœªæ‰§è¡Œï¼Œè°ƒç”¨ä¸‹ä¸€ä¸ªFilter
            ApplicationFilterConfig filterConfig = filters[pos++];
            Filter filter = filterConfig.getFilter();
            filter.doFilter(request, response, this);  // é€’å½’è°ƒç”¨
        } else {
            // æ‰€æœ‰Filteræ‰§è¡Œå®Œæ¯•ï¼Œè°ƒç”¨Servlet
            servlet.service(request, response);
        }
    }
}

é€’å½’è°ƒç”¨è¿‡ç¨‹ï¼š
Filter1.doFilter() 
  â†’ chain.doFilter() â†’ Filter2.doFilter()
    â†’ chain.doFilter() â†’ Filter3.doFilter()  
      â†’ chain.doFilter() â†’ Servlet.service()
```

### 5.2 é“¾å¼è°ƒç”¨çš„æ‰§è¡Œç‰¹ç‚¹

**ğŸ“Š è°ƒç”¨æœºåˆ¶çš„å…³é”®ç‰¹æ€§**

```
ç‰¹æ€§1ï¼šé€’å½’è°ƒç”¨ç»“æ„
æ¯ä¸ªFilterçš„doFilter()æ–¹æ³•åŒ…å«ä¸‰éƒ¨åˆ†ï¼š
å‰å¤„ç†ä»£ç 
  â†“
chain.doFilter()  â† è¿™é‡Œä¼šé€’å½’è°ƒç”¨ä¸‹ä¸€ä¸ªFilter
  â†“  
åå¤„ç†ä»£ç 

ç‰¹æ€§2ï¼šæ ˆå¼æ‰§è¡Œé¡ºåº
è¯·æ±‚è¿›å…¥ï¼šFilter1 â†’ Filter2 â†’ Filter3 â†’ Servlet
å“åº”è¿”å›ï¼šServlet â†’ Filter3 â†’ Filter2 â†’ Filter1

ç‰¹æ€§3ï¼šå¯ä¸­æ–­ç‰¹æ€§
ä»»ä½•Filterä¸è°ƒç”¨chain.doFilter()ï¼Œé“¾æ¡å°±ä¸­æ–­
åç»­Filterå’ŒServletéƒ½ä¸ä¼šæ‰§è¡Œ
```

### 5.3 é“¾å¼è°ƒç”¨çš„å®é™…åº”ç”¨

**ğŸ’¡ å®æˆ˜ä¸­çš„é“¾å¼å¤„ç†æ¡ˆä¾‹**

```java
// ç»„åˆå¤šä¸ªåŠŸèƒ½çš„Filterç¤ºä¾‹
public class CompositeFilter implements Filter {
    
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, 
                        FilterChain chain) throws IOException, ServletException {
        
        HttpServletRequest req = (HttpServletRequest) request;
        long startTime = System.currentTimeMillis();
        
        try {
            // 1. ç¼–ç å¤„ç†
            request.setCharacterEncoding("UTF-8");
            
            // 2. æ—¥å¿—è®°å½•
            System.out.println("è®¿é—®URL: " + req.getRequestURI());
            System.out.println("è®¿é—®æ—¶é—´: " + new Date());
            
            // 3. ç»§ç»­é“¾å¼è°ƒç”¨
            chain.doFilter(request, response);
            
        } finally {
            // 4. æ€§èƒ½ç»Ÿè®¡ï¼ˆæ— è®ºæ˜¯å¦å¼‚å¸¸éƒ½ä¼šæ‰§è¡Œï¼‰
            long endTime = System.currentTimeMillis();
            System.out.println("å¤„ç†è€—æ—¶: " + (endTime - startTime) + "ms");
        }
    }
}
```

## 6. ğŸ›¡ï¸ æ‹¦æˆªå¤„ç†æœºåˆ¶åº”ç”¨


### 6.1 å¸¸è§æ‹¦æˆªå¤„ç†åœºæ™¯

**ğŸ¯ å®é™…å¼€å‘ä¸­çš„æ‹¦æˆªéœ€æ±‚**

```
æƒé™éªŒè¯æ‹¦æˆªï¼š
åœºæ™¯ï¼šç”¨æˆ·è®¿é—®éœ€è¦ç™»å½•çš„é¡µé¢
å¤„ç†ï¼šæ£€æŸ¥sessionä¸­çš„ç”¨æˆ·ä¿¡æ¯
ç»“æœï¼šæœªç™»å½•åˆ™è·³è½¬åˆ°ç™»å½•é¡µé¢

ç¼–ç å¤„ç†æ‹¦æˆªï¼š
åœºæ™¯ï¼šè§£å†³ä¸­æ–‡ä¹±ç é—®é¢˜
å¤„ç†ï¼šç»Ÿä¸€è®¾ç½®è¯·æ±‚å’Œå“åº”ç¼–ç 
ç»“æœï¼šä¿è¯ä¸­æ–‡æ­£å¸¸æ˜¾ç¤º

æ—¥å¿—è®°å½•æ‹¦æˆªï¼š
åœºæ™¯ï¼šè®°å½•ç”¨æˆ·è®¿é—®è¡Œä¸º
å¤„ç†ï¼šè®°å½•è®¿é—®æ—¶é—´ã€IPã€URLç­‰ä¿¡æ¯
ç»“æœï¼šä¾¿äºç³»ç»Ÿç›‘æ§å’Œé—®é¢˜æ’æŸ¥

æ€§èƒ½ç›‘æ§æ‹¦æˆªï¼š
åœºæ™¯ï¼šç›‘æ§è¯·æ±‚å¤„ç†æ—¶é—´
å¤„ç†ï¼šè®¡ç®—è¯·æ±‚å¼€å§‹å’Œç»“æŸæ—¶é—´å·®
ç»“æœï¼šè¯†åˆ«æ€§èƒ½ç“¶é¢ˆ
```

### 6.2 æƒé™éªŒè¯Filterå®ç°

**ğŸ” ç”¨æˆ·ç™»å½•éªŒè¯çš„å®Œæ•´å®ç°**

```java
@WebFilter(urlPatterns = {"/admin/*", "/user/*"})
public class LoginCheckFilter implements Filter {
    
    // ä¸éœ€è¦ç™»å½•éªŒè¯çš„é¡µé¢
    private Set<String> excludeUrls = new HashSet<>();
    
    @Override
    public void init(FilterConfig filterConfig) throws ServletException {
        // åˆå§‹åŒ–æ’é™¤çš„URL
        excludeUrls.add("/login");
        excludeUrls.add("/register");
        excludeUrls.add("/index");
        System.out.println("ç™»å½•éªŒè¯è¿‡æ»¤å™¨åˆå§‹åŒ–å®Œæˆ");
    }
    
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, 
                        FilterChain chain) throws IOException, ServletException {
        
        HttpServletRequest req = (HttpServletRequest) request;
        HttpServletResponse resp = (HttpServletResponse) response;
        
        String requestURI = req.getRequestURI();
        System.out.println("æ£€æŸ¥URLï¼š" + requestURI);
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºæ’é™¤çš„URL
        if (isExcludeUrl(requestURI)) {
            System.out.println("æ— éœ€ç™»å½•éªŒè¯çš„URLï¼Œç›´æ¥æ”¾è¡Œ");
            chain.doFilter(request, response);
            return;
        }
        
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
        HttpSession session = req.getSession();
        Object user = session.getAttribute("loginUser");
        
        if (user != null) {
            System.out.println("ç”¨æˆ·å·²ç™»å½•ï¼Œæ”¾è¡Œ");
            // ç”¨æˆ·å·²ç™»å½•ï¼Œç»§ç»­å¤„ç†
            chain.doFilter(request, response);
        } else {
            System.out.println("ç”¨æˆ·æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢");
            // ç”¨æˆ·æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢
            resp.sendRedirect(req.getContextPath() + "/login.jsp");
        }
    }
    
    private boolean isExcludeUrl(String requestURI) {
        for (String excludeUrl : excludeUrls) {
            if (requestURI.contains(excludeUrl)) {
                return true;
            }
        }
        return false;
    }
    
    @Override
    public void destroy() {
        System.out.println("ç™»å½•éªŒè¯è¿‡æ»¤å™¨é”€æ¯");
    }
}
```

### 6.3 æ—¥å¿—è®°å½•Filterå®ç°

**ğŸ“ è®¿é—®æ—¥å¿—è®°å½•çš„å®ç°**

```java
public class AccessLogFilter implements Filter {
    
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, 
                        FilterChain chain) throws IOException, ServletException {
        
        HttpServletRequest req = (HttpServletRequest) request;
        
        // æ”¶é›†è®¿é—®ä¿¡æ¯
        String clientIP = getClientIP(req);
        String userAgent = req.getHeader("User-Agent");
        String requestURL = req.getRequestURL().toString();
        String method = req.getMethod();
        long startTime = System.currentTimeMillis();
        
        System.out.println("=== è®¿é—®å¼€å§‹ ===");
        System.out.println("å®¢æˆ·ç«¯IP: " + clientIP);
        System.out.println("è®¿é—®URL: " + requestURL);
        System.out.println("è¯·æ±‚æ–¹æ³•: " + method);
        System.out.println("æµè§ˆå™¨ä¿¡æ¯: " + userAgent);
        System.out.println("å¼€å§‹æ—¶é—´: " + new Date(startTime));
        
        try {
            // ç»§ç»­å¤„ç†è¯·æ±‚
            chain.doFilter(request, response);
        } finally {
            // è®°å½•å¤„ç†ç»“æœï¼ˆæ— è®ºæ˜¯å¦å¼‚å¸¸éƒ½ä¼šæ‰§è¡Œï¼‰
            long endTime = System.currentTimeMillis();
            long processingTime = endTime - startTime;
            
            System.out.println("å¤„ç†æ—¶é—´: " + processingTime + "ms");
            System.out.println("=== è®¿é—®ç»“æŸ ===\n");
        }
    }
    
    // è·å–å®¢æˆ·ç«¯çœŸå®IPåœ°å€
    private String getClientIP(HttpServletRequest request) {
        String ip = request.getHeader("X-Forwarded-For");
        if (ip == null || ip.length() == 0 || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getHeader("X-Real-IP");
        }
        if (ip == null || ip.length() == 0 || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getRemoteAddr();
        }
        return ip;
    }
}
```

## 7. ğŸ¯ AOPæ€æƒ³åœ¨Filterä¸­çš„ä½“ç°


### 7.1 ä»€ä¹ˆæ˜¯AOPæ€æƒ³

**ğŸ’¡ é¢å‘åˆ‡é¢ç¼–ç¨‹çš„æ ¸å¿ƒç†å¿µ**

```
AOPæ ¸å¿ƒæ¦‚å¿µç†è§£ï¼š

ä¼ ç»Ÿç¼–ç¨‹æ–¹å¼ï¼ˆçºµå‘ï¼‰ï¼š
ä¸šåŠ¡é€»è¾‘A { æ—¥å¿—è®°å½• + æƒé™éªŒè¯ + æ ¸å¿ƒä¸šåŠ¡ + æ€§èƒ½ç»Ÿè®¡ }
ä¸šåŠ¡é€»è¾‘B { æ—¥å¿—è®°å½• + æƒé™éªŒè¯ + æ ¸å¿ƒä¸šåŠ¡ + æ€§èƒ½ç»Ÿè®¡ }
ä¸šåŠ¡é€»è¾‘C { æ—¥å¿—è®°å½• + æƒé™éªŒè¯ + æ ¸å¿ƒä¸šåŠ¡ + æ€§èƒ½ç»Ÿè®¡ }

é—®é¢˜ï¼šå…¬å…±åŠŸèƒ½é‡å¤ç¼–å†™ï¼Œç»´æŠ¤å›°éš¾

AOPç¼–ç¨‹æ–¹å¼ï¼ˆæ¨ªå‘åˆ‡å…¥ï¼‰ï¼š
         æ—¥å¿—è®°å½•åˆ‡é¢
              â†“
         æƒé™éªŒè¯åˆ‡é¢  
              â†“
    æ ¸å¿ƒä¸šåŠ¡é€»è¾‘A/B/C
              â†“
         æ€§èƒ½ç»Ÿè®¡åˆ‡é¢

ä¼˜åŠ¿ï¼šå…¬å…±åŠŸèƒ½ç»Ÿä¸€å¤„ç†ï¼Œä»£ç æ›´æ¸…çˆ½
```

### 7.2 Filterä½“ç°AOPçš„å…³é”®æ¦‚å¿µ

**ğŸ“Š AOPæ¦‚å¿µåœ¨Filterä¸­çš„å¯¹åº”å…³ç³»**

| AOPæ¦‚å¿µ | **Filterä¸­çš„ä½“ç°** | **å…·ä½“è¯´æ˜** |
|---------|-------------------|-------------|
| ğŸ”¸ **åˆ‡é¢(Aspect)** | `Filterç±»` | `å°è£…æ¨ªåˆ‡å…³æ³¨ç‚¹çš„æ¨¡å—` |
| ğŸ”¸ **è¿æ¥ç‚¹(JoinPoint)** | `HTTPè¯·æ±‚` | `å¯ä»¥è¢«æ‹¦æˆªçš„æ‰§è¡Œç‚¹` |
| ğŸ”¸ **åˆ‡ç‚¹(Pointcut)** | `url-pattern` | `æŒ‡å®šå“ªäº›è¯·æ±‚è¢«æ‹¦æˆª` |
| ğŸ”¸ **é€šçŸ¥(Advice)** | `doFilter()æ–¹æ³•` | `åœ¨åˆ‡ç‚¹æ‰§è¡Œçš„ä»£ç ` |
| ğŸ”¸ **ç»‡å…¥(Weaving)** | `FilterChainè°ƒç”¨` | `å°†åˆ‡é¢ä»£ç ç»‡å…¥ä¸šåŠ¡æµç¨‹` |

### 7.3 Filterå®ç°AOPçš„ä¼˜åŠ¿

**â­ æ¨ªåˆ‡å…³æ³¨ç‚¹çš„ç»Ÿä¸€å¤„ç†**

```
æ¨ªåˆ‡å…³æ³¨ç‚¹ç¤ºä¾‹ï¼š

1. æ—¥å¿—è®°å½•ï¼ˆLoggingï¼‰
   - æ‰€æœ‰è¯·æ±‚éƒ½éœ€è¦è®°å½•è®¿é—®æ—¥å¿—
   - ä½¿ç”¨Filterç»Ÿä¸€å¤„ç†ï¼Œé¿å…æ¯ä¸ªServleté‡å¤ç¼–å†™

2. å®‰å…¨æ§åˆ¶ï¼ˆSecurityï¼‰
   - æƒé™éªŒè¯ã€SQLæ³¨å…¥é˜²æŠ¤
   - åœ¨Filterä¸­ç»Ÿä¸€å®ç°å®‰å…¨ç­–ç•¥

3. äº‹åŠ¡ç®¡ç†ï¼ˆTransactionï¼‰
   - æ•°æ®åº“äº‹åŠ¡çš„å¼€å§‹å’Œæäº¤/å›æ»š
   - åœ¨Filterä¸­ç»Ÿä¸€ç®¡ç†äº‹åŠ¡è¾¹ç•Œ

4. æ€§èƒ½ç›‘æ§ï¼ˆPerformanceï¼‰
   - è¯·æ±‚å“åº”æ—¶é—´ç»Ÿè®¡
   - ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡æ”¶é›†

5. ç¼“å­˜å¤„ç†ï¼ˆCachingï¼‰
   - å“åº”å†…å®¹ç¼“å­˜
   - é™æ€èµ„æºç¼“å­˜ç­–ç•¥
```

### 7.4 AOPæ€æƒ³çš„å®é™…åº”ç”¨

**ğŸ”§ ç»„åˆå¤šä¸ªæ¨ªåˆ‡å…³æ³¨ç‚¹çš„Filter**

```java
// ä½“ç°AOPæ€æƒ³çš„ç»¼åˆFilter
public class AOPFilter implements Filter {
    
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, 
                        FilterChain chain) throws IOException, ServletException {
        
        HttpServletRequest req = (HttpServletRequest) request;
        
        // ========== åˆ‡é¢1ï¼šå®‰å…¨æ£€æŸ¥ ==========
        if (!securityCheck(req)) {
            // å®‰å…¨æ£€æŸ¥å¤±è´¥ï¼Œç›´æ¥è¿”å›
            response.getWriter().write("Security Check Failed");
            return;
        }
        
        // ========== åˆ‡é¢2ï¼šæ—¥å¿—è®°å½•å¼€å§‹ ==========
        String requestInfo = logRequestStart(req);
        long startTime = System.currentTimeMillis();
        
        try {
            // ========== åˆ‡é¢3ï¼šç¼“å­˜æ£€æŸ¥ ==========
            String cachedResponse = checkCache(req);
            if (cachedResponse != null) {
                response.getWriter().write(cachedResponse);
                return;
            }
            
            // ç»§ç»­æ‰§è¡Œä¸šåŠ¡é€»è¾‘
            chain.doFilter(request, response);
            
        } catch (Exception e) {
            // ========== åˆ‡é¢4ï¼šå¼‚å¸¸å¤„ç† ==========
            handleException(e, response);
        } finally {
            // ========== åˆ‡é¢5ï¼šæ€§èƒ½ç»Ÿè®¡å’Œæ—¥å¿—ç»“æŸ ==========
            long processingTime = System.currentTimeMillis() - startTime;
            logRequestEnd(requestInfo, processingTime);
        }
    }
    
    private boolean securityCheck(HttpServletRequest request) {
        // å®ç°å®‰å…¨æ£€æŸ¥é€»è¾‘
        String userAgent = request.getHeader("User-Agent");
        return userAgent != null && !userAgent.contains("bot");
    }
    
    private String logRequestStart(HttpServletRequest request) {
        String info = "è¯·æ±‚: " + request.getRequestURI() + 
                     " æ¥è‡ª: " + request.getRemoteAddr();
        System.out.println("[å¼€å§‹] " + info);
        return info;
    }
    
    private void logRequestEnd(String requestInfo, long processingTime) {
        System.out.println("[ç»“æŸ] " + requestInfo + 
                          " è€—æ—¶: " + processingTime + "ms");
    }
    
    private String checkCache(HttpServletRequest request) {
        // æ¨¡æ‹Ÿç¼“å­˜æ£€æŸ¥
        return null;  // å‡è®¾æ²¡æœ‰ç¼“å­˜
    }
    
    private void handleException(Exception e, ServletResponse response) 
            throws IOException {
        System.err.println("å¤„ç†å¼‚å¸¸: " + e.getMessage());
        response.getWriter().write("ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•");
    }
}
```

## 8. ğŸš€ Filterå®æˆ˜æ¡ˆä¾‹


### 8.1 ç»¼åˆæ¡ˆä¾‹ï¼šåšå®¢ç³»ç»Ÿçš„Filteråº”ç”¨

**ğŸ—ï¸ å®é™…é¡¹ç›®ä¸­çš„Filteræ¶æ„è®¾è®¡**

```
åšå®¢ç³»ç»ŸFilteræ¶æ„ï¼š

1. CharacterEncodingFilter (ä¼˜å…ˆçº§1)
   â””â”€ å¤„ç†ä¸­æ–‡ç¼–ç é—®é¢˜

2. LoginCheckFilter (ä¼˜å…ˆçº§2)  
   â””â”€ éªŒè¯ç”¨æˆ·ç™»å½•çŠ¶æ€

3. AdminCheckFilter (ä¼˜å…ˆçº§3)
   â””â”€ éªŒè¯ç®¡ç†å‘˜æƒé™

4. AccessLogFilter (ä¼˜å…ˆçº§4)
   â””â”€ è®°å½•è®¿é—®æ—¥å¿—

5. PerformanceFilter (ä¼˜å…ˆçº§5)
   â””â”€ æ€§èƒ½ç›‘æ§å’Œç»Ÿè®¡
```

**web.xmlé…ç½®ç¤ºä¾‹**
```xml
<!-- 1. ç¼–ç è¿‡æ»¤å™¨ -->
<filter>
    <filter-name>CharacterEncodingFilter</filter-name>
    <filter-class>com.blog.filter.CharacterEncodingFilter</filter-class>
    <init-param>
        <param-name>encoding</param-name>
        <param-value>UTF-8</param-value>
    </init-param>
</filter>
<filter-mapping>
    <filter-name>CharacterEncodingFilter</filter-name>
    <url-pattern>/*</url-pattern>
</filter-mapping>

<!-- 2. ç™»å½•éªŒè¯è¿‡æ»¤å™¨ -->
<filter>
    <filter-name>LoginCheckFilter</filter-name>
    <filter-class>com.blog.filter.LoginCheckFilter</filter-class>
</filter>
<filter-mapping>
    <filter-name>LoginCheckFilter</filter-name>
    <url-pattern>/user/*</url-pattern>
    <url-pattern>/admin/*</url-pattern>
</filter-mapping>

<!-- 3. ç®¡ç†å‘˜æƒé™è¿‡æ»¤å™¨ -->
<filter>
    <filter-name>AdminCheckFilter</filter-name>
    <filter-class>com.blog.filter.AdminCheckFilter</filter-class>
</filter>
<filter-mapping>
    <filter-name>AdminCheckFilter</filter-name>
    <url-pattern>/admin/*</url-pattern>
</filter-mapping>
```

### 8.2 æ•æ„Ÿè¯è¿‡æ»¤Filter

**ğŸ”’ å†…å®¹å®¡æ ¸çš„å®é™…åº”ç”¨**

```java
public class SensitiveWordsFilter implements Filter {
    
    private Set<String> sensitiveWords = new HashSet<>();
    
    @Override
    public void init(FilterConfig filterConfig) throws ServletException {
        // åˆå§‹åŒ–æ•æ„Ÿè¯åº“ï¼ˆå®é™…é¡¹ç›®ä¸­å¯ä»æ•°æ®åº“æˆ–æ–‡ä»¶è¯»å–ï¼‰
        sensitiveWords.add("åƒåœ¾");
        sensitiveWords.add("spam");
        // ... æ›´å¤šæ•æ„Ÿè¯
        System.out.println("æ•æ„Ÿè¯è¿‡æ»¤å™¨åˆå§‹åŒ–ï¼ŒåŠ è½½æ•æ„Ÿè¯" + sensitiveWords.size() + "ä¸ª");
    }
    
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, 
                        FilterChain chain) throws IOException, ServletException {
        
        HttpServletRequest req = (HttpServletRequest) request;
        
        // åªå¯¹POSTè¯·æ±‚è¿›è¡Œæ•æ„Ÿè¯æ£€æŸ¥
        if ("POST".equalsIgnoreCase(req.getMethod())) {
            // åŒ…è£…è¯·æ±‚ï¼Œæ£€æŸ¥å‚æ•°ä¸­çš„æ•æ„Ÿè¯
            SensitiveRequestWrapper wrapper = new SensitiveRequestWrapper(req);
            chain.doFilter(wrapper, response);
        } else {
            chain.doFilter(request, response);
        }
    }
    
    // è¯·æ±‚åŒ…è£…ç±»
    class SensitiveRequestWrapper extends HttpServletRequestWrapper {
        
        public SensitiveRequestWrapper(HttpServletRequest request) {
            super(request);
        }
        
        @Override
        public String getParameter(String name) {
            String value = super.getParameter(name);
            return filterSensitiveWords(value);
        }
        
        @Override
        public String[] getParameterValues(String name) {
            String[] values = super.getParameterValues(name);
            if (values != null) {
                for (int i = 0; i < values.length; i++) {
                    values[i] = filterSensitiveWords(values[i]);
                }
            }
            return values;
        }
        
        private String filterSensitiveWords(String content) {
            if (content == null) return null;
            
            String filtered = content;
            for (String word : sensitiveWords) {
                if (filtered.contains(word)) {
                    // ç”¨*å·æ›¿æ¢æ•æ„Ÿè¯
                    String replacement = "*".repeat(word.length());
                    filtered = filtered.replace(word, replacement);
                    System.out.println("è¿‡æ»¤æ•æ„Ÿè¯: " + word);
                }
            }
            return filtered;
        }
    }
}
```

### 8.3 APIè®¿é—®é¢‘ç‡é™åˆ¶Filter

**âš¡ é˜²æ­¢æ¥å£è¢«æ¶æ„åˆ·å–**

```java
public class RateLimitFilter implements Filter {
    
    // ç”¨æˆ·è®¿é—®è®°å½• <IPåœ°å€, æœ€åè®¿é—®æ—¶é—´åˆ—è¡¨>
    private Map<String, List<Long>> userAccess = new ConcurrentHashMap<>();
    
    // é™åˆ¶è§„åˆ™ï¼šæ¯åˆ†é’Ÿæœ€å¤š60æ¬¡è¯·æ±‚
    private static final int MAX_REQUESTS_PER_MINUTE = 60;
    private static final long TIME_WINDOW = 60 * 1000; // 1åˆ†é’Ÿ
    
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, 
                        FilterChain chain) throws IOException, ServletException {
        
        HttpServletRequest req = (HttpServletRequest) request;
        HttpServletResponse resp = (HttpServletResponse) response;
        
        String clientIP = getClientIP(req);
        long currentTime = System.currentTimeMillis();
        
        // æ£€æŸ¥è®¿é—®é¢‘ç‡
        if (isRateLimited(clientIP, currentTime)) {
            // è®¿é—®é¢‘ç‡è¶…é™
            resp.setStatus(429); // Too Many Requests
            resp.setContentType("application/json;charset=UTF-8");
            resp.getWriter().write("{\"error\":\"è®¿é—®é¢‘ç‡è¶…é™ï¼Œè¯·ç¨åå†è¯•\"}");
            System.out.println("IP " + clientIP + " è®¿é—®é¢‘ç‡è¶…é™");
            return;
        }
        
        // è®°å½•æœ¬æ¬¡è®¿é—®
        recordAccess(clientIP, currentTime);
        
        // ç»§ç»­å¤„ç†è¯·æ±‚
        chain.doFilter(request, response);
    }
    
    private boolean isRateLimited(String clientIP, long currentTime) {
        List<Long> accessTimes = userAccess.get(clientIP);
        if (accessTimes == null) {
            return false; // ç¬¬ä¸€æ¬¡è®¿é—®
        }
        
        // æ¸…ç†è¿‡æœŸçš„è®¿é—®è®°å½•
        accessTimes.removeIf(time -> currentTime - time > TIME_WINDOW);
        
        // æ£€æŸ¥å½“å‰çª—å£å†…çš„è®¿é—®æ¬¡æ•°
        return accessTimes.size() >= MAX_REQUESTS_PER_MINUTE;
    }
    
    private void recordAccess(String clientIP, long currentTime) {
        userAccess.computeIfAbsent(clientIP, k -> new ArrayList<>()).add(currentTime);
    }
    
    private String getClientIP(HttpServletRequest request) {
        String ip = request.getHeader("X-Real-IP");
        if (ip == null || ip.isEmpty()) {
            ip = request.getRemoteAddr();
        }
        return ip;
    }
}
```

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Filteræœ¬è´¨ï¼šWebè¯·æ±‚çš„é¢„å¤„ç†å’Œåå¤„ç†æœºåˆ¶
ğŸ”¸ æ¥å£å®ç°ï¼šinit()ã€doFilter()ã€destroy()ä¸‰ä¸ªæ ¸å¿ƒæ–¹æ³•
ğŸ”¸ è¿‡æ»¤å™¨é“¾ï¼šå¤šä¸ªFilteræŒ‰é¡ºåºæ‰§è¡Œçš„é“¾å¼æœºåˆ¶
ğŸ”¸ é“¾å¼è°ƒç”¨ï¼šé€šè¿‡chain.doFilter()å®ç°é€’å½’è°ƒç”¨
ğŸ”¸ æ‹¦æˆªå¤„ç†ï¼šå¯ä»¥ä¸­æ–­è¯·æ±‚æˆ–ä¿®æ”¹è¯·æ±‚å“åº”
ğŸ”¸ AOPä½“ç°ï¼šæ¨ªåˆ‡å…³æ³¨ç‚¹çš„ç»Ÿä¸€å¤„ç†æœºåˆ¶
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ Filter vs Servletçš„åŒºåˆ«**
```
ç›¸åŒç‚¹ï¼š
- éƒ½å¤„ç†HTTPè¯·æ±‚
- éƒ½æœ‰ç”Ÿå‘½å‘¨æœŸç®¡ç†
- éƒ½å¯ä»¥è®¿é—®requestå’Œresponseå¯¹è±¡

ä¸åŒç‚¹ï¼š
Filterç‰¹ç‚¹ï¼š
- ä¸»è¦ç”¨äºé¢„å¤„ç†å’Œåå¤„ç†
- å¯ä»¥æ‹¦æˆªå¤šä¸ªServlet
- ä½“ç°AOPæ€æƒ³
- åœ¨Servletä¹‹å‰æ‰§è¡Œ

Servletç‰¹ç‚¹ï¼š
- ä¸»è¦å¤„ç†ä¸šåŠ¡é€»è¾‘
- ä¸€ä¸ªURLå¯¹åº”ä¸€ä¸ªServlet
- ä½“ç°MVCä¸­çš„Controller
- åœ¨Filterä¹‹åæ‰§è¡Œ
```

**ğŸ”¹ FilterChainçš„æ ¸å¿ƒæœºåˆ¶**
```
ç†è§£è¦ç‚¹ï¼š
1. é“¾å¼ç»“æ„ï¼šå¤šä¸ªFilterä¸²è”æ‰§è¡Œ
2. é€’å½’è°ƒç”¨ï¼šæ¯ä¸ªFilterè°ƒç”¨ä¸‹ä¸€ä¸ªFilter
3. å¯ä¸­æ–­æ€§ï¼šä¸è°ƒç”¨chain.doFilter()å°±ä¸­æ–­
4. åŒå‘å¤„ç†ï¼šè¯·æ±‚å’Œå“åº”éƒ½ç»è¿‡Filterå¤„ç†
5. é¡ºåºé‡è¦ï¼šæ‰§è¡Œé¡ºåºå½±å“å¤„ç†ç»“æœ
```

**ğŸ”¹ å®é™…å¼€å‘ä¸­çš„æœ€ä½³å®è·µ**
```
é…ç½®å»ºè®®ï¼š
- ä½¿ç”¨web.xmlé…ç½®ï¼Œä¿è¯æ‰§è¡Œé¡ºåº
- åˆç†è®¾ç½®url-patternï¼Œé¿å…ä¸å¿…è¦çš„æ‹¦æˆª
- ä½¿ç”¨æœ‰æ„ä¹‰çš„filter-nameä¾¿äºç»´æŠ¤

ä»£ç å»ºè®®ï¼š
- init()ä¸­è¿›è¡Œåˆå§‹åŒ–æ“ä½œ
- doFilter()ä¸­å®ç°æ ¸å¿ƒé€»è¾‘
- å¿…è¦æ—¶ä½¿ç”¨try-finallyä¿è¯èµ„æºæ¸…ç†
- åˆç†ä½¿ç”¨RequestWrapperå’ŒResponseWrapper

æ€§èƒ½å»ºè®®ï¼š
- é¿å…åœ¨Filterä¸­è¿›è¡Œè€—æ—¶æ“ä½œ
- åˆç†ä½¿ç”¨ç¼“å­˜å‡å°‘é‡å¤è®¡ç®—
- æ³¨æ„å†…å­˜æ³„æ¼é—®é¢˜
```

### 9.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ å¸¸è§åº”ç”¨åœºæ™¯**
- **æƒé™æ§åˆ¶**ï¼šç™»å½•éªŒè¯ã€è§’è‰²æƒé™æ£€æŸ¥
- **æ•°æ®å¤„ç†**ï¼šç¼–ç è®¾ç½®ã€å‚æ•°éªŒè¯ã€æ ¼å¼è½¬æ¢
- **ç³»ç»Ÿç›‘æ§**ï¼šè®¿é—®æ—¥å¿—ã€æ€§èƒ½ç»Ÿè®¡ã€å¼‚å¸¸æ•è·
- **å†…å®¹å®‰å…¨**ï¼šæ•æ„Ÿè¯è¿‡æ»¤ã€XSSé˜²æŠ¤ã€SQLæ³¨å…¥é˜²æŠ¤
- **è®¿é—®æ§åˆ¶**ï¼šIPé»‘ç™½åå•ã€è®¿é—®é¢‘ç‡é™åˆ¶

**ğŸ”§ æŠ€èƒ½å‘å±•è·¯å¾„**
- **åŸºç¡€é˜¶æ®µ**ï¼šæŒæ¡Filteræ¥å£å’ŒåŸºæœ¬ç”¨æ³•
- **è¿›é˜¶é˜¶æ®µ**ï¼šç†è§£FilterChainæœºåˆ¶å’ŒAOPæ€æƒ³
- **åº”ç”¨é˜¶æ®µ**ï¼šç»“åˆå®é™…é¡¹ç›®éœ€æ±‚è®¾è®¡Filter
- **ä¼˜åŒ–é˜¶æ®µ**ï¼šæ€§èƒ½ä¼˜åŒ–å’Œé«˜çº§ç‰¹æ€§åº”ç”¨

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- Filterè¿‡æ»¤å™¨ï¼Œè¯·æ±‚é¢„å¤„ç†
- ä¸‰ä¸ªæ–¹æ³•è¦è®°ç‰¢ï¼Œåˆå§‹åŒ–è¿‡æ»¤é”€æ¯
- é“¾å¼è°ƒç”¨é€’å½’è¡Œï¼Œä¸è°ƒå°±ä¼šè¢«æ‹¦æˆª
- AOPæ€æƒ³å¾—ä½“ç°ï¼Œæ¨ªåˆ‡å…³æ³¨ç»Ÿä¸€å¤„ç†