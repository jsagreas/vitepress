---
title: 3ã€ä¸‰å±‚æ¶æ„å®è·µ
---
## ğŸ“š ç›®å½•

1. [ä¸‰å±‚æ¶æ„åŸºç¡€æ¦‚å¿µ](#1-ä¸‰å±‚æ¶æ„åŸºç¡€æ¦‚å¿µ)
2. [Controlleræ§åˆ¶å™¨å±‚è¯¦è§£](#2-Controlleræ§åˆ¶å™¨å±‚è¯¦è§£)
3. [Serviceä¸šåŠ¡é€»è¾‘å±‚è¯¦è§£](#3-Serviceä¸šåŠ¡é€»è¾‘å±‚è¯¦è§£)
4. [DAOæ•°æ®è®¿é—®å±‚è¯¦è§£](#4-DAOæ•°æ®è®¿é—®å±‚è¯¦è§£)
5. [æ•°æ®æµè½¬æœºåˆ¶åŸç†](#5-æ•°æ®æµè½¬æœºåˆ¶åŸç†)
6. [å¼‚å¸¸å¤„ç†ä¼ é€’æœºåˆ¶](#6-å¼‚å¸¸å¤„ç†ä¼ é€’æœºåˆ¶)
7. [äº‹åŠ¡ç®¡ç†æ§åˆ¶å®è·µ](#7-äº‹åŠ¡ç®¡ç†æ§åˆ¶å®è·µ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ—ï¸ ä¸‰å±‚æ¶æ„åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯ä¸‰å±‚æ¶æ„


> ğŸ’¡ **é€šä¿—ç†è§£**ï¼šä¸‰å±‚æ¶æ„å°±åƒä¸€ä¸ªé¤å…çš„è¿ä½œæ¨¡å¼
> 
> - **Controllerå±‚ï¼ˆæœåŠ¡å‘˜ï¼‰**ï¼šæ¥å¾…å®¢äººï¼Œä¼ é€’éœ€æ±‚
> - **Serviceå±‚ï¼ˆå¨å¸ˆé•¿ï¼‰**ï¼šå¤„ç†ä¸šåŠ¡é€»è¾‘ï¼Œåè°ƒå·¥ä½œ
> - **DAOå±‚ï¼ˆé‡‡è´­å‘˜ï¼‰**ï¼šè´Ÿè´£è·å–åŸææ–™ï¼ˆæ•°æ®ï¼‰

**ğŸ”¸ ä¸‰å±‚æ¶æ„æ ¸å¿ƒæ€æƒ³**
```
èŒè´£åˆ†ç¦» â†’ å„å±‚ä¸“æ³¨è‡ªå·±çš„å·¥ä½œ
åˆ†å±‚è§£è€¦ â†’ ä¸Šå±‚ä¸ç›´æ¥æ¥è§¦åº•å±‚
ç»Ÿä¸€æ¥å£ â†’ å±‚ä¸å±‚ä¹‹é—´æœ‰æ˜ç¡®çš„è°ƒç”¨è§„èŒƒ
```

### 1.2 ä¸‰å±‚æ¶æ„ç»“æ„å›¾


```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           å‰ç«¯é¡µé¢ (JSP/HTML)        â”‚ â† ç”¨æˆ·ç•Œé¢
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ HTTPè¯·æ±‚/å“åº”
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Controllerå±‚ (Servlet/Controller) â”‚ â† ğŸ¯ æ¥æ”¶è¯·æ±‚ï¼Œè°ƒåº¦å¤„ç†
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           ğŸ”¸ è¯·æ±‚å‚æ•°éªŒè¯             â”‚
â”‚           ğŸ”¸ è°ƒç”¨Serviceå¤„ç†ä¸šåŠ¡       â”‚
â”‚           ğŸ”¸ è¿”å›å¤„ç†ç»“æœ             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ æ–¹æ³•è°ƒç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Serviceå±‚ (Business Logic)     â”‚ â† ğŸ¢ ä¸šåŠ¡é€»è¾‘å¤„ç†
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           ğŸ”¸ ä¸šåŠ¡è§„åˆ™éªŒè¯             â”‚
â”‚           ğŸ”¸ äº‹åŠ¡æ§åˆ¶                â”‚
â”‚           ğŸ”¸ è°ƒç”¨DAOè·å–æ•°æ®          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ æ–¹æ³•è°ƒç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       DAOå±‚ (Data Access Object)    â”‚ â† ğŸ—„ï¸ æ•°æ®åº“è®¿é—®
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           ğŸ”¸ SQLæ“ä½œ                 â”‚
â”‚           ğŸ”¸ æ•°æ®åº“è¿æ¥ç®¡ç†           â”‚
â”‚           ğŸ”¸ æ•°æ®å¯¹è±¡è½¬æ¢             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ JDBCè°ƒç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            æ•°æ®åº“ (MySQL/Oracle)     â”‚ â† ğŸ’¾ æ•°æ®å­˜å‚¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 ä¸ºä»€ä¹ˆè¦ç”¨ä¸‰å±‚æ¶æ„


**ğŸ¯ ä¼ ç»Ÿæ–¹å¼ vs ä¸‰å±‚æ¶æ„å¯¹æ¯”**

| å¯¹æ¯”é¡¹ç›® | **ä¼ ç»Ÿæ–¹å¼** | **ä¸‰å±‚æ¶æ„** |
|---------|------------|-------------|
| ğŸ”§ **ä»£ç ç»„ç»‡** | `Servleté‡Œå†™æ‰€æœ‰ä»£ç ` | `åˆ†å±‚æ˜ç¡®ï¼ŒèŒè´£æ¸…æ™°` |
| ğŸ”„ **ä»£ç å¤ç”¨** | `é‡å¤ä»£ç å¤šï¼Œéš¾å¤ç”¨` | `æ¯å±‚å¯ç‹¬ç«‹å¤ç”¨` |
| ğŸ› ï¸ **ç»´æŠ¤éš¾åº¦** | `ä¿®æ”¹ä¸€å¤„å½±å“å…¨å±€` | `ä¿®æ”¹æŸå±‚ä¸å½±å“å…¶ä»–å±‚` |
| ğŸ§ª **æµ‹è¯•ä¾¿åˆ©æ€§** | `éš¾ä»¥å•ç‹¬æµ‹è¯•` | `æ¯å±‚å¯ç‹¬ç«‹æµ‹è¯•` |
| ğŸ‘¥ **å›¢é˜Ÿåä½œ** | `å¤šäººä¿®æ”¹åŒä¸€æ–‡ä»¶å†²çª` | `ä¸åŒäººè´Ÿè´£ä¸åŒå±‚` |

**âœ… ä¸‰å±‚æ¶æ„çš„æ ¸å¿ƒä¼˜åŠ¿**
- **èŒè´£å•ä¸€**ï¼šæ¯å±‚åªè´Ÿè´£è‡ªå·±çš„äº‹æƒ…
- **ä½è€¦åˆ**ï¼šå±‚ä¸å±‚ä¹‹é—´ä¾èµ–å…³ç³»ç®€å•
- **é«˜å†…èš**ï¼šåŒä¸€å±‚å†…éƒ¨åŠŸèƒ½ç´§å¯†ç›¸å…³
- **æ˜“æ‰©å±•**ï¼šæ–°å¢åŠŸèƒ½æ—¶å½±å“èŒƒå›´å°

---

## 2. ğŸ¯ Controlleræ§åˆ¶å™¨å±‚è¯¦è§£


### 2.1 Controllerå±‚æ˜¯ä»€ä¹ˆ


> ğŸ”¸ **å½¢è±¡æ¯”å–»**ï¼šControllerå°±åƒé…’åº—çš„**å‰å°æ¥å¾…å‘˜**
> - æ¥å¾…å®¢äººï¼ˆæ¥æ”¶HTTPè¯·æ±‚ï¼‰
> - ç†è§£éœ€æ±‚ï¼ˆè§£æè¯·æ±‚å‚æ•°ï¼‰
> - å®‰æ’æœåŠ¡ï¼ˆè°ƒç”¨ç›¸åº”çš„Serviceï¼‰
> - åé¦ˆç»“æœï¼ˆè¿”å›å“åº”ç»™ç”¨æˆ·ï¼‰

**Controllerå±‚çš„æ ¸å¿ƒèŒè´£**
```
ğŸ¯ è¯·æ±‚æ¥æ”¶ â†’ è·å–ç”¨æˆ·å‘é€çš„HTTPè¯·æ±‚
ğŸ” å‚æ•°è§£æ â†’ æå–å’ŒéªŒè¯è¯·æ±‚å‚æ•°
ğŸ“ ä¸šåŠ¡è°ƒç”¨ â†’ è°ƒç”¨Serviceå±‚å¤„ç†ä¸šåŠ¡é€»è¾‘
ğŸ“¤ ç»“æœè¿”å› â†’ å°†å¤„ç†ç»“æœè¿”å›ç»™ç”¨æˆ·
```

### 2.2 Controllerå±‚ä»£ç ç¤ºä¾‹


**ğŸ”§ ç”¨æˆ·ç®¡ç†Controllerç¤ºä¾‹**
```java
@WebServlet("/user/*")
public class UserController extends HttpServlet {
    
    private UserService userService = new UserService();
    
    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) 
            throws ServletException, IOException {
        
        // 1. è·å–è¯·æ±‚è·¯å¾„ï¼Œåˆ¤æ–­å…·ä½“æ“ä½œ
        String pathInfo = request.getPathInfo();
        
        if ("/list".equals(pathInfo)) {
            listUsers(request, response);
        } else if ("/detail".equals(pathInfo)) {
            getUserDetail(request, response);
        }
    }
    
    // è·å–ç”¨æˆ·åˆ—è¡¨
    private void listUsers(HttpServletRequest request, HttpServletResponse response) 
            throws ServletException, IOException {
        try {
            // 2. è°ƒç”¨Serviceå±‚è·å–æ•°æ®
            List<User> users = userService.getAllUsers();
            
            // 3. å°†æ•°æ®ä¼ é€’ç»™JSPé¡µé¢
            request.setAttribute("users", users);
            request.getRequestDispatcher("/WEB-INF/jsp/userList.jsp")
                   .forward(request, response);
                   
        } catch (Exception e) {
            // 4. å¼‚å¸¸å¤„ç†
            request.setAttribute("errorMsg", "è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥ï¼š" + e.getMessage());
            request.getRequestDispatcher("/WEB-INF/jsp/error.jsp")
                   .forward(request, response);
        }
    }
}
```

### 2.3 Controllerå±‚çš„è®¾è®¡è¦ç‚¹


**ğŸ”¸ è¯·æ±‚è·¯å¾„è®¾è®¡**
```
ç»Ÿä¸€URLæ ¼å¼ï¼š
/æ¨¡å—å/æ“ä½œå

ç¤ºä¾‹ï¼š
/user/list     â†’ è·å–ç”¨æˆ·åˆ—è¡¨
/user/add      â†’ æ·»åŠ ç”¨æˆ·
/user/update   â†’ æ›´æ–°ç”¨æˆ·
/user/delete   â†’ åˆ é™¤ç”¨æˆ·
```

**ğŸ”¸ å‚æ•°éªŒè¯åŸåˆ™**
- **åŸºç¡€éªŒè¯**ï¼šéç©ºã€æ ¼å¼æ£€æŸ¥åœ¨Controller
- **ä¸šåŠ¡éªŒè¯**ï¼šä¸šåŠ¡è§„åˆ™æ£€æŸ¥äº¤ç»™Service
- **æ•°æ®éªŒè¯**ï¼šæ•°æ®åº“çº¦æŸæ£€æŸ¥åœ¨DAO

**âš ï¸ Controllerå±‚å¸¸è§è¯¯åŒº**
```
âŒ é”™è¯¯åšæ³•ï¼šåœ¨Controlleré‡Œå†™SQL
âŒ é”™è¯¯åšæ³•ï¼šåœ¨Controlleré‡Œå¤„ç†å¤æ‚ä¸šåŠ¡é€»è¾‘
âŒ é”™è¯¯åšæ³•ï¼šç›´æ¥åœ¨Controlleré‡Œæ“ä½œæ•°æ®åº“è¿æ¥

âœ… æ­£ç¡®åšæ³•ï¼šControlleråªè´Ÿè´£è¯·æ±‚è½¬å‘å’Œç»“æœè¿”å›
```

---

## 3. ğŸ¢ Serviceä¸šåŠ¡é€»è¾‘å±‚è¯¦è§£


### 3.1 Serviceå±‚æ˜¯ä»€ä¹ˆ


> ğŸ’¡ **å½¢è±¡æ¯”å–»**ï¼šServiceå±‚å°±åƒå…¬å¸çš„**éƒ¨é—¨ç»ç†**
> - åˆ¶å®šä¸šåŠ¡è§„åˆ™ï¼ˆä¸šåŠ¡é€»è¾‘å¤„ç†ï¼‰
> - åè°ƒä¸‹å±å·¥ä½œï¼ˆè°ƒç”¨å¤šä¸ªDAOï¼‰
> - ç¡®ä¿å·¥ä½œè´¨é‡ï¼ˆäº‹åŠ¡æ§åˆ¶ï¼‰
> - å¤„ç†æ„å¤–æƒ…å†µï¼ˆå¼‚å¸¸å¤„ç†ï¼‰

**Serviceå±‚çš„æ ¸å¿ƒä½œç”¨**
```
ğŸ“‹ ä¸šåŠ¡é€»è¾‘ â†’ å®ç°å…·ä½“çš„ä¸šåŠ¡è§„åˆ™
ğŸ”„ äº‹åŠ¡æ§åˆ¶ â†’ ä¿è¯æ•°æ®æ“ä½œçš„ä¸€è‡´æ€§
ğŸ¯ åè°ƒè°ƒç”¨ â†’ å¯èƒ½è°ƒç”¨å¤šä¸ªDAOå®Œæˆä¸€ä¸ªä¸šåŠ¡
âœ… ç»“æœéªŒè¯ â†’ ç¡®ä¿ä¸šåŠ¡æ“ä½œçš„æ­£ç¡®æ€§
```

### 3.2 Serviceå±‚ä»£ç ç¤ºä¾‹


**ğŸ”§ ç”¨æˆ·ä¸šåŠ¡Serviceç¤ºä¾‹**
```java
public class UserService {
    
    private UserDAO userDAO = new UserDAO();
    private Connection conn;
    
    // ç”¨æˆ·æ³¨å†Œä¸šåŠ¡ï¼ˆæ¶‰åŠå¤šä¸ªæ•°æ®æ“ä½œï¼‰
    public boolean registerUser(User user) throws Exception {
        
        try {
            // 1. å¼€å¯äº‹åŠ¡
            conn = DBUtil.getConnection();
            conn.setAutoCommit(false);
            
            // 2. ä¸šåŠ¡è§„åˆ™éªŒè¯
            if (userDAO.isUsernameExists(user.getUsername())) {
                throw new BusinessException("ç”¨æˆ·åå·²å­˜åœ¨");
            }
            
            if (user.getAge() < 18) {
                throw new BusinessException("ç”¨æˆ·å¹´é¾„å¿…é¡»æ»¡18å²");
            }
            
            // 3. æ‰§è¡Œä¸šåŠ¡æ“ä½œ
            // 3.1 ä¿å­˜ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
            int userId = userDAO.saveUser(user);
            
            // 3.2 åˆ›å»ºç”¨æˆ·é»˜è®¤è®¾ç½®
            UserSetting defaultSetting = new UserSetting(userId);
            userDAO.saveUserSetting(defaultSetting);
            
            // 3.3 è®°å½•æ³¨å†Œæ—¥å¿—
            userDAO.saveUserLog(userId, "ç”¨æˆ·æ³¨å†ŒæˆåŠŸ");
            
            // 4. æäº¤äº‹åŠ¡
            conn.commit();
            return true;
            
        } catch (Exception e) {
            // 5. å›æ»šäº‹åŠ¡
            if (conn != null) {
                conn.rollback();
            }
            throw e;
        } finally {
            // 6. å…³é—­è¿æ¥
            DBUtil.closeConnection(conn);
        }
    }
    
    // ç®€å•çš„æŸ¥è¯¢ä¸šåŠ¡
    public List<User> getAllUsers() throws Exception {
        return userDAO.findAllUsers();
    }
}
```

### 3.3 Serviceå±‚è®¾è®¡åŸåˆ™


**ğŸ”¸ ä¸šåŠ¡é€»è¾‘å°è£…**
```
å•ä¸€èŒè´£ï¼šä¸€ä¸ªServiceæ–¹æ³•å®Œæˆä¸€ä¸ªå®Œæ•´ä¸šåŠ¡
ä¸šåŠ¡å®Œæ•´ï¼šServiceæ–¹æ³•å†…åŒ…å«å®Œæ•´çš„ä¸šåŠ¡æµç¨‹
è§„åˆ™é›†ä¸­ï¼šæ‰€æœ‰ä¸šåŠ¡è§„åˆ™éƒ½åœ¨Serviceå±‚éªŒè¯
```

**ğŸ”¸ äº‹åŠ¡ç®¡ç†ç­–ç•¥**
- **è¯»æ“ä½œ**ï¼šä¸€èˆ¬ä¸éœ€è¦äº‹åŠ¡
- **å•è¡¨å†™æ“ä½œ**ï¼šç®€å•äº‹åŠ¡å³å¯
- **å¤šè¡¨å†™æ“ä½œ**ï¼šå¿…é¡»ä½¿ç”¨äº‹åŠ¡ï¼Œä¿è¯ä¸€è‡´æ€§

**ğŸ“Š Serviceå±‚æ–¹æ³•å‘½åè§„èŒƒ**
| æ“ä½œç±»å‹ | **å‘½åç¤ºä¾‹** | **è¯´æ˜** |
|---------|------------|---------|
| ğŸ” **æŸ¥è¯¢** | `getAllUsers()` `getUserById()` | `get/find/queryå¼€å¤´` |
| â• **æ–°å¢** | `addUser()` `createUser()` | `add/create/saveå¼€å¤´` |
| ğŸ“ **ä¿®æ”¹** | `updateUser()` `modifyUser()` | `update/modifyå¼€å¤´` |
| âŒ **åˆ é™¤** | `deleteUser()` `removeUser()` | `delete/removeå¼€å¤´` |
| ğŸ”§ **ä¸šåŠ¡** | `registerUser()` `loginUser()` | `ä¸šåŠ¡åŠ¨è¯å¼€å¤´` |

---

## 4. ğŸ—„ï¸ DAOæ•°æ®è®¿é—®å±‚è¯¦è§£


### 4.1 DAOå±‚æ˜¯ä»€ä¹ˆ


> ğŸ’¾ **å½¢è±¡æ¯”å–»**ï¼šDAOå±‚å°±åƒå›¾ä¹¦é¦†çš„**ç®¡ç†å‘˜**
> - çŸ¥é“ä¹¦æ”¾åœ¨å“ªé‡Œï¼ˆäº†è§£æ•°æ®åº“ç»“æ„ï¼‰
> - å¸®ä½ æ‰¾åˆ°éœ€è¦çš„ä¹¦ï¼ˆæ‰§è¡ŒSQLæŸ¥è¯¢ï¼‰
> - å¸®ä½ å½’è¿˜å’Œæ•´ç†ä¹¦ç±ï¼ˆæ•°æ®çš„å¢åˆ æ”¹ï¼‰
> - éµå¾ªå›¾ä¹¦é¦†è§„åˆ™ï¼ˆæ•°æ®åº“æ“ä½œè§„èŒƒï¼‰

**DAOå±‚çš„æ ¸å¿ƒèŒè´£**
```
ğŸ”Œ æ•°æ®åº“è¿æ¥ â†’ ç®¡ç†æ•°æ®åº“è¿æ¥çš„è·å–å’Œé‡Šæ”¾
ğŸ“ SQLæ‰§è¡Œ â†’ æ‰§è¡Œå…·ä½“çš„SQLè¯­å¥
ğŸ”„ æ•°æ®è½¬æ¢ â†’ ResultSetä¸Javaå¯¹è±¡ä¹‹é—´çš„è½¬æ¢
âš™ï¸ å¼‚å¸¸å¤„ç† â†’ å¤„ç†æ•°æ®åº“æ“ä½œå¼‚å¸¸
```

### 4.2 DAOå±‚ä»£ç ç¤ºä¾‹


**ğŸ”§ ç”¨æˆ·æ•°æ®è®¿é—®DAOç¤ºä¾‹**
```java
public class UserDAO {
    
    // æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·
    public List<User> findAllUsers() throws Exception {
        List<User> users = new ArrayList<>();
        Connection conn = null;
        PreparedStatement ps = null;
        ResultSet rs = null;
        
        try {
            // 1. è·å–è¿æ¥
            conn = DBUtil.getConnection();
            
            // 2. å‡†å¤‡SQL
            String sql = "SELECT id, username, email, age FROM user";
            ps = conn.prepareStatement(sql);
            
            // 3. æ‰§è¡ŒæŸ¥è¯¢
            rs = ps.executeQuery();
            
            // 4. å¤„ç†ç»“æœé›†
            while (rs.next()) {
                User user = new User();
                user.setId(rs.getInt("id"));
                user.setUsername(rs.getString("username"));
                user.setEmail(rs.getString("email"));
                user.setAge(rs.getInt("age"));
                users.add(user);
            }
            
        } finally {
            // 5. é‡Šæ”¾èµ„æº
            DBUtil.closeResources(rs, ps, conn);
        }
        
        return users;
    }
    
    // æ ¹æ®IDæŸ¥è¯¢å•ä¸ªç”¨æˆ·
    public User findById(int id) throws Exception {
        Connection conn = null;
        PreparedStatement ps = null;
        ResultSet rs = null;
        
        try {
            conn = DBUtil.getConnection();
            String sql = "SELECT * FROM user WHERE id = ?";
            ps = conn.prepareStatement(sql);
            ps.setInt(1, id);
            
            rs = ps.executeQuery();
            if (rs.next()) {
                User user = new User();
                user.setId(rs.getInt("id"));
                user.setUsername(rs.getString("username"));
                user.setEmail(rs.getString("email"));
                user.setAge(rs.getInt("age"));
                return user;
            }
            
        } finally {
            DBUtil.closeResources(rs, ps, conn);
        }
        
        return null;
    }
    
    // ä¿å­˜ç”¨æˆ·
    public int saveUser(User user) throws Exception {
        Connection conn = null;
        PreparedStatement ps = null;
        ResultSet rs = null;
        
        try {
            conn = DBUtil.getConnection();
            String sql = "INSERT INTO user(username, email, age) VALUES(?, ?, ?)";
            ps = conn.prepareStatement(sql, Statement.RETURN_GENERATED_KEYS);
            
            ps.setString(1, user.getUsername());
            ps.setString(2, user.getEmail());
            ps.setInt(3, user.getAge());
            
            int rows = ps.executeUpdate();
            if (rows > 0) {
                rs = ps.getGeneratedKeys();
                if (rs.next()) {
                    return rs.getInt(1); // è¿”å›ç”Ÿæˆçš„ID
                }
            }
            
        } finally {
            DBUtil.closeResources(rs, ps, conn);
        }
        
        return -1;
    }
}
```

### 4.3 DAOå±‚è®¾è®¡è¦ç‚¹


**ğŸ”¸ æ–¹æ³•å‘½åè§„èŒƒ**
```
æŸ¥è¯¢æ“ä½œï¼šfind/get/query + æ¡ä»¶
find()          â†’ æŸ¥è¯¢å¯èƒ½è¿”å›null
findAll()       â†’ æŸ¥è¯¢åˆ—è¡¨
findByXxx()     â†’ æ ¹æ®æŸä¸ªæ¡ä»¶æŸ¥è¯¢

ä¿®æ”¹æ“ä½œï¼šsave/update/delete + å¯¹è±¡
save()          â†’ ä¿å­˜ï¼ˆæ–°å¢ï¼‰
update()        â†’ æ›´æ–°
delete()        â†’ åˆ é™¤
```

**ğŸ”¸ èµ„æºç®¡ç†åŸåˆ™**
- **è°åˆ›å»ºè°é‡Šæ”¾**ï¼šåœ¨åŒä¸€ä¸ªæ–¹æ³•å†…è·å–å’Œé‡Šæ”¾è¿æ¥
- **finallyå¿…é‡Šæ”¾**ï¼šæ— è®ºæ˜¯å¦å¼‚å¸¸éƒ½è¦é‡Šæ”¾èµ„æº
- **é€†åºé‡Šæ”¾**ï¼šResultSet â†’ PreparedStatement â†’ Connection

**âš ï¸ DAOå±‚æ³¨æ„äº‹é¡¹**
```
âœ… åªå¤„ç†æ•°æ®åº“æ“ä½œï¼Œä¸åŒ…å«ä¸šåŠ¡é€»è¾‘
âœ… å¼‚å¸¸ç›´æ¥å‘ä¸ŠæŠ›å‡ºï¼Œä¸åœ¨DAOå±‚å¤„ç†ä¸šåŠ¡å¼‚å¸¸
âœ… SQLè¯­å¥ä½¿ç”¨PreparedStatementé˜²æ­¢æ³¨å…¥
âŒ ä¸åœ¨DAOå±‚åšæ•°æ®éªŒè¯ï¼ˆä¸šåŠ¡éªŒè¯äº¤ç»™Serviceï¼‰
```

---

## 5. ğŸ”„ æ•°æ®æµè½¬æœºåˆ¶åŸç†


### 5.1 å®Œæ•´çš„æ•°æ®æµè½¬è¿‡ç¨‹


**ğŸ“Š ç”¨æˆ·ç™»å½•æµç¨‹ç¤ºä¾‹**

```
ç”¨æˆ·æ“ä½œ                    ç³»ç»Ÿå¤„ç†æµç¨‹
   |                           |
   | 1. å¡«å†™ç™»å½•è¡¨å•              |
   â–¼                           |
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               |
â”‚  æäº¤è¡¨å•    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚
â”‚ username=admin â”‚              |
â”‚ password=123   â”‚              |
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               |
                               |
                        â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                        â”‚ LoginServlet â”‚ â—„â”€ Controllerå±‚
                        â”‚ (Controller) â”‚
                        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                               â”‚ 2. è°ƒç”¨ä¸šåŠ¡é€»è¾‘
                               â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ UserService  â”‚ â—„â”€ Serviceå±‚
                        â”‚   login()    â”‚
                        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚ 3. éªŒè¯ç”¨æˆ·ä¿¡æ¯
                               â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚   UserDAO    â”‚ â—„â”€ DAOå±‚
                        â”‚ findByName() â”‚
                        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚ 4. æ‰§è¡ŒSQLæŸ¥è¯¢
                               â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚   æ•°æ®åº“      â”‚ â—„â”€ æ•°æ®åº“
                        â”‚   MySQL      â”‚
                        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚ 5. è¿”å›ç”¨æˆ·æ•°æ®
                               â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚   UserDAO    â”‚ â—„â”€ æ•°æ®è½¬æ¢
                        â”‚ è½¬æ¢ä¸ºUserå¯¹è±¡â”‚
                        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚ 6. è¿”å›Userå¯¹è±¡
                               â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ UserService  â”‚ â—„â”€ ä¸šåŠ¡éªŒè¯
                        â”‚ éªŒè¯å¯†ç æ­£ç¡®æ€§ â”‚
                        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚ 7. è¿”å›éªŒè¯ç»“æœ
                               â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ LoginServlet â”‚ â—„â”€ ç»“æœå¤„ç†
                        â”‚   è·³è½¬é¡µé¢    â”‚
                        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚ 8. è¿”å›å“åº”
                               â–¼
                          ã€æˆåŠŸé¡µé¢ã€‘
```

### 5.2 æ•°æ®åœ¨å„å±‚çš„å½¢æ€å˜åŒ–


**ğŸ”„ æ•°æ®å½¢æ€è½¬æ¢è¿‡ç¨‹**

| é˜¶æ®µ | **æ•°æ®å½¢æ€** | **ç¤ºä¾‹** | **è¯´æ˜** |
|------|------------|---------|---------|
| 1ï¸âƒ£ **ç”¨æˆ·è¾“å…¥** | `HTTPå‚æ•°` | `username=admin&password=123` | `è¡¨å•æäº¤çš„å­—ç¬¦ä¸²` |
| 2ï¸âƒ£ **Controlleræ¥æ”¶** | `Stringå‚æ•°` | `String username = "admin"` | `ä»requestä¸­æå–` |
| 3ï¸âƒ£ **Serviceå¤„ç†** | `ä¸šåŠ¡å¯¹è±¡` | `User user = new User(username, password)` | `å°è£…æˆJavaå¯¹è±¡` |
| 4ï¸âƒ£ **DAOæŸ¥è¯¢** | `SQLè¯­å¥` | `SELECT * FROM user WHERE username=?` | `è½¬æ¢ä¸ºæ•°æ®åº“æ“ä½œ` |
| 5ï¸âƒ£ **æ•°æ®åº“è¿”å›** | `ResultSet` | `rs.getString("username")` | `æ•°æ®åº“ç»“æœé›†` |
| 6ï¸âƒ£ **DAOè½¬æ¢** | `Javaå¯¹è±¡` | `User user = new User()` | `ResultSetè½¬ä¸ºå¯¹è±¡` |
| 7ï¸âƒ£ **Serviceè¿”å›** | `ä¸šåŠ¡ç»“æœ` | `LoginResult.SUCCESS` | `ä¸šåŠ¡å¤„ç†ç»“æœ` |
| 8ï¸âƒ£ **Controllerå“åº”** | `é¡µé¢è·³è½¬` | `forward("success.jsp")` | `ç”¨æˆ·ç•Œé¢æ›´æ–°` |

### 5.3 å±‚é—´è°ƒç”¨çš„æ ‡å‡†æ¨¡å¼


**ğŸ”— æ ‡å‡†è°ƒç”¨é“¾æ¨¡å¼**
```java
// Controller â†’ Service â†’ DAO çš„æ ‡å‡†è°ƒç”¨
public class UserController extends HttpServlet {
    
    private UserService userService = new UserService();
    
    protected void doPost(HttpServletRequest request, HttpServletResponse response) {
        try {
            // 1. Controllerï¼šè·å–å‚æ•°
            String username = request.getParameter("username");
            String password = request.getParameter("password");
            
            // 2. Controller â†’ Serviceï¼šè°ƒç”¨ä¸šåŠ¡æ–¹æ³•
            User user = userService.login(username, password);
            
            if (user != null) {
                // 3. Controllerï¼šå¤„ç†æˆåŠŸç»“æœ
                request.getSession().setAttribute("currentUser", user);
                response.sendRedirect("success.jsp");
            } else {
                // 4. Controllerï¼šå¤„ç†å¤±è´¥ç»“æœ
                request.setAttribute("errorMsg", "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
                request.getRequestDispatcher("login.jsp").forward(request, response);
            }
            
        } catch (Exception e) {
            // 5. Controllerï¼šç»Ÿä¸€å¼‚å¸¸å¤„ç†
            request.setAttribute("errorMsg", "ç³»ç»Ÿå¼‚å¸¸ï¼š" + e.getMessage());
            request.getRequestDispatcher("error.jsp").forward(request, response);
        }
    }
}
```

---

## 6. âš ï¸ å¼‚å¸¸å¤„ç†ä¼ é€’æœºåˆ¶


### 6.1 å¼‚å¸¸å¤„ç†çš„åˆ†å±‚ç­–ç•¥


> ğŸ¯ **æ ¸å¿ƒåŸåˆ™**ï¼š**è°æœ€é€‚åˆå¤„ç†ï¼Œå°±åœ¨å“ªä¸€å±‚å¤„ç†**

**ğŸ”¸ å„å±‚å¼‚å¸¸å¤„ç†èŒè´£**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Controllerå±‚    â”‚ â† ğŸš¨ ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤ºï¼Œé¡µé¢è·³è½¬
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Serviceå±‚     â”‚ â† ğŸ“‹ ä¸šåŠ¡å¼‚å¸¸å¤„ç†ï¼Œäº‹åŠ¡å›æ»š
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    DAOå±‚        â”‚ â† ğŸ—„ï¸ æ•°æ®åº“å¼‚å¸¸å‘ä¸ŠæŠ›å‡ºï¼Œä¸å¤„ç†ä¸šåŠ¡
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 è‡ªå®šä¹‰å¼‚å¸¸ä½“ç³»è®¾è®¡


**ğŸ”§ å¼‚å¸¸ç±»è®¾è®¡ç¤ºä¾‹**
```java
// åŸºç¡€ä¸šåŠ¡å¼‚å¸¸ç±»
public class BusinessException extends Exception {
    private String errorCode;
    
    public BusinessException(String message) {
        super(message);
    }
    
    public BusinessException(String errorCode, String message) {
        super(message);
        this.errorCode = errorCode;
    }
}

// å…·ä½“ä¸šåŠ¡å¼‚å¸¸
public class UserNotFoundException extends BusinessException {
    public UserNotFoundException(String username) {
        super("USER_NOT_FOUND", "ç”¨æˆ·ä¸å­˜åœ¨ï¼š" + username);
    }
}

public class PasswordErrorException extends BusinessException {
    public PasswordErrorException() {
        super("PASSWORD_ERROR", "å¯†ç é”™è¯¯");
    }
}
```

### 6.3 å¼‚å¸¸å¤„ç†å®è·µç¤ºä¾‹


**ğŸ”„ å®Œæ•´å¼‚å¸¸å¤„ç†æµç¨‹**
```java
// DAOå±‚ï¼šåªæŠ›å‡ºå¼‚å¸¸ï¼Œä¸å¤„ç†
public class UserDAO {
    public User findByUsername(String username) throws SQLException {
        // ... æ•°æ®åº“æ“ä½œ
        // å¦‚æœå‘ç”ŸSQLExceptionï¼Œç›´æ¥å‘ä¸ŠæŠ›å‡º
    }
}

// Serviceå±‚ï¼šå¤„ç†ä¸šåŠ¡å¼‚å¸¸ï¼Œè½¬æ¢æŠ€æœ¯å¼‚å¸¸
public class UserService {
    private UserDAO userDAO = new UserDAO();
    
    public User login(String username, String password) throws BusinessException {
        try {
            // 1. ä¸šåŠ¡è§„åˆ™éªŒè¯
            if (username == null || username.trim().isEmpty()) {
                throw new BusinessException("ç”¨æˆ·åä¸èƒ½ä¸ºç©º");
            }
            
            // 2. è°ƒç”¨DAOæŸ¥è¯¢ç”¨æˆ·
            User user = userDAO.findByUsername(username);
            if (user == null) {
                throw new UserNotFoundException(username);
            }
            
            // 3. éªŒè¯å¯†ç 
            if (!user.getPassword().equals(password)) {
                throw new PasswordErrorException();
            }
            
            return user;
            
        } catch (SQLException e) {
            // 4. å°†æŠ€æœ¯å¼‚å¸¸è½¬æ¢ä¸ºä¸šåŠ¡å¼‚å¸¸
            throw new BusinessException("æ•°æ®åº“è®¿é—®å¤±è´¥ï¼š" + e.getMessage());
        }
    }
}

// Controllerå±‚ï¼šç”¨æˆ·å‹å¥½çš„å¼‚å¸¸å¤„ç†
public class LoginServlet extends HttpServlet {
    private UserService userService = new UserService();
    
    protected void doPost(HttpServletRequest request, HttpServletResponse response) {
        try {
            String username = request.getParameter("username");
            String password = request.getParameter("password");
            
            User user = userService.login(username, password);
            
            // ç™»å½•æˆåŠŸå¤„ç†...
            
        } catch (UserNotFoundException e) {
            request.setAttribute("errorMsg", "è¯¥ç”¨æˆ·ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·å");
            forwardToLoginPage(request, response);
            
        } catch (PasswordErrorException e) {
            request.setAttribute("errorMsg", "å¯†ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥");
            forwardToLoginPage(request, response);
            
        } catch (BusinessException e) {
            request.setAttribute("errorMsg", e.getMessage());
            forwardToErrorPage(request, response);
            
        } catch (Exception e) {
            // å¤„ç†æœªé¢„æœŸçš„å¼‚å¸¸
            request.setAttribute("errorMsg", "ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•");
            forwardToErrorPage(request, response);
        }
    }
}
```

### 6.4 å¼‚å¸¸å¤„ç†æœ€ä½³å®è·µ


**âœ… å¼‚å¸¸å¤„ç†åŸåˆ™**
- **æ—©å‘ç°**ï¼šåœ¨æœ€æ¥è¿‘é”™è¯¯æºçš„åœ°æ–¹æ£€æµ‹å¼‚å¸¸
- **åˆç†è½¬æ¢**ï¼šå°†æŠ€æœ¯å¼‚å¸¸è½¬æ¢ä¸ºç”¨æˆ·èƒ½ç†è§£çš„ä¸šåŠ¡å¼‚å¸¸
- **ç»Ÿä¸€å¤„ç†**ï¼šåœ¨Controllerå±‚ç»Ÿä¸€å¤„ç†ç”¨æˆ·ç•Œé¢ç›¸å…³çš„å¼‚å¸¸
- **æ—¥å¿—è®°å½•**ï¼šé‡è¦å¼‚å¸¸éƒ½è¦è®°å½•åˆ°æ—¥å¿—æ–‡ä»¶

**ğŸ“Š å¼‚å¸¸å¤„ç†ç­–ç•¥å¯¹æ¯”**

| å¼‚å¸¸ç±»å‹ | **å¤„ç†ä½ç½®** | **å¤„ç†æ–¹å¼** | **ç¤ºä¾‹** |
|---------|------------|-------------|---------|
| ğŸ”§ **æŠ€æœ¯å¼‚å¸¸** | `DAOå±‚æŠ›å‡ºï¼ŒServiceå±‚è½¬æ¢` | `è½¬æ¢ä¸ºä¸šåŠ¡å¼‚å¸¸` | `SQLException â†’ BusinessException` |
| ğŸ“‹ **ä¸šåŠ¡å¼‚å¸¸** | `Serviceå±‚æŠ›å‡ºï¼ŒControllerå¤„ç†` | `ç”¨æˆ·å‹å¥½æç¤º` | `ç”¨æˆ·ä¸å­˜åœ¨ â†’ è¯·æ£€æŸ¥ç”¨æˆ·å` |
| ğŸš¨ **ç³»ç»Ÿå¼‚å¸¸** | `Controllerå±‚ç»Ÿä¸€å¤„ç†` | `é€šç”¨é”™è¯¯é¡µé¢` | `æœªçŸ¥å¼‚å¸¸ â†’ ç³»ç»Ÿç¹å¿™é¡µé¢` |

---

## 7. ğŸ”’ äº‹åŠ¡ç®¡ç†æ§åˆ¶å®è·µ


### 7.1 äº‹åŠ¡æ˜¯ä»€ä¹ˆ


> ğŸ’¡ **ç”Ÿæ´»ä¸­çš„äº‹åŠ¡ä¾‹å­**ï¼šé“¶è¡Œè½¬è´¦
> 
> å¼ ä¸‰ç»™æå››è½¬è´¦100å…ƒï¼Œéœ€è¦ä¸¤ä¸ªæ“ä½œï¼š
> 1. å¼ ä¸‰è´¦æˆ·å‡å°‘100å…ƒ
> 2. æå››è´¦æˆ·å¢åŠ 100å…ƒ
> 
> è¿™ä¸¤ä¸ªæ“ä½œå¿…é¡»**å…¨éƒ¨æˆåŠŸ**æˆ–è€…**å…¨éƒ¨å¤±è´¥**ï¼Œä¸èƒ½å‡ºç°å¼ ä¸‰é’±æ‰£äº†ï¼Œæå››æ²¡æ”¶åˆ°çš„æƒ…å†µ

**ğŸ”¸ äº‹åŠ¡çš„å››å¤§ç‰¹æ€§ï¼ˆACIDï¼‰**
```
ğŸ”’ åŸå­æ€§ï¼ˆAtomicityï¼‰   â†’ è¦ä¹ˆå…¨åšï¼Œè¦ä¹ˆå…¨ä¸åš
ğŸ”„ ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ â†’ æ•°æ®å§‹ç»ˆä¿æŒæ­£ç¡®çŠ¶æ€  
ğŸ” éš”ç¦»æ€§ï¼ˆIsolationï¼‰   â†’ å¤šä¸ªäº‹åŠ¡äº’ä¸å¹²æ‰°
ğŸ’¾ æŒä¹…æ€§ï¼ˆDurabilityï¼‰  â†’ æäº¤åæ°¸ä¹…ä¿å­˜
```

### 7.2 æ‰‹åŠ¨äº‹åŠ¡ç®¡ç†


**ğŸ”§ æ‰‹åŠ¨äº‹åŠ¡æ§åˆ¶ç¤ºä¾‹**
```java
public class UserService {
    
    // ç”¨æˆ·æ³¨å†Œäº‹åŠ¡ï¼ˆéœ€è¦æ“ä½œå¤šå¼ è¡¨ï¼‰
    public boolean registerUser(User user) throws Exception {
        Connection conn = null;
        
        try {
            // 1. è·å–è¿æ¥å¹¶å¼€å¯äº‹åŠ¡
            conn = DBUtil.getConnection();
            conn.setAutoCommit(false);  // å…³é—­è‡ªåŠ¨æäº¤
            
            // 2. æ‰§è¡Œå¤šä¸ªæ•°æ®åº“æ“ä½œ
            UserDAO userDAO = new UserDAO();
            LogDAO logDAO = new LogDAO();
            
            // 2.1 ä¿å­˜ç”¨æˆ·ä¿¡æ¯
            int userId = userDAO.saveUser(user, conn);
            if (userId <= 0) {
                throw new Exception("ä¿å­˜ç”¨æˆ·ä¿¡æ¯å¤±è´¥");
            }
            
            // 2.2 ä¿å­˜æ“ä½œæ—¥å¿—
            Log log = new Log("ç”¨æˆ·æ³¨å†Œ", userId, new Date());
            boolean logSaved = logDAO.saveLog(log, conn);
            if (!logSaved) {
                throw new Exception("ä¿å­˜æ“ä½œæ—¥å¿—å¤±è´¥");
            }
            
            // 2.3 å‘é€æ¬¢è¿é‚®ä»¶ï¼ˆå‡è®¾è¿™é‡Œå¯èƒ½å¤±è´¥ï¼‰
            boolean emailSent = sendWelcomeEmail(user.getEmail());
            if (!emailSent) {
                throw new Exception("å‘é€æ¬¢è¿é‚®ä»¶å¤±è´¥");
            }
            
            // 3. æ‰€æœ‰æ“ä½œæˆåŠŸï¼Œæäº¤äº‹åŠ¡
            conn.commit();
            return true;
            
        } catch (Exception e) {
            // 4. å‘ç”Ÿå¼‚å¸¸ï¼Œå›æ»šäº‹åŠ¡
            if (conn != null) {
                try {
                    conn.rollback();
                    System.out.println("äº‹åŠ¡å›æ»šæˆåŠŸï¼š" + e.getMessage());
                } catch (SQLException rollbackEx) {
                    System.err.println("äº‹åŠ¡å›æ»šå¤±è´¥ï¼š" + rollbackEx.getMessage());
                }
            }
            throw e;  // å‘ä¸ŠæŠ›å‡ºå¼‚å¸¸
            
        } finally {
            // 5. æ¢å¤è‡ªåŠ¨æäº¤å¹¶å…³é—­è¿æ¥
            if (conn != null) {
                try {
                    conn.setAutoCommit(true);
                    DBUtil.closeConnection(conn);
                } catch (SQLException e) {
                    System.err.println("å…³é—­è¿æ¥å¤±è´¥ï¼š" + e.getMessage());
                }
            }
        }
    }
}
```

### 7.3 äº‹åŠ¡ç®¡ç†çš„åœºæ™¯åˆ†æ


**ğŸ¯ ä»€ä¹ˆæ—¶å€™éœ€è¦äº‹åŠ¡**

| åœºæ™¯ç±»å‹ | **æ˜¯å¦éœ€è¦äº‹åŠ¡** | **åŸå› ** | **ç¤ºä¾‹** |
|---------|----------------|---------|---------|
| ğŸ” **å•è¡¨æŸ¥è¯¢** | `âŒ ä¸éœ€è¦` | `åªè¯»æ“ä½œï¼Œä¸æ¶‰åŠæ•°æ®å˜æ›´` | `æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨` |
| â• **å•è¡¨æ–°å¢** | `ğŸŸ¡ å¯é€‰` | `å•ä¸ªæ“ä½œï¼Œå¤±è´¥å½±å“æœ‰é™` | `æ·»åŠ ä¸€ä¸ªç”¨æˆ·` |
| ğŸ“ **å•è¡¨æ›´æ–°** | `ğŸŸ¡ å¯é€‰` | `å•ä¸ªæ“ä½œï¼Œå¯é€šè¿‡é‡è¯•è§£å†³` | `ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯` |
| ğŸ”„ **å¤šè¡¨æ“ä½œ** | `âœ… å¿…éœ€` | `å¤šä¸ªå…³è”æ“ä½œï¼Œå¿…é¡»ä¿æŒä¸€è‡´æ€§` | `ç”¨æˆ·æ³¨å†Œ+æ—¥å¿—è®°å½•` |
| ğŸ’° **é‡‘èæ“ä½œ** | `âœ… å¿…éœ€` | `æ¶‰åŠé‡‘é’±ï¼Œç»å¯¹ä¸èƒ½å‡ºé”™` | `è½¬è´¦ã€æ”¯ä»˜` |
| ğŸ“Š **æ‰¹é‡æ“ä½œ** | `âœ… å¿…éœ€` | `å¤§é‡æ•°æ®æ“ä½œï¼Œéƒ¨åˆ†å¤±è´¥å½±å“å¤§` | `æ‰¹é‡å¯¼å…¥ç”¨æˆ·` |

### 7.4 äº‹åŠ¡ç®¡ç†å·¥å…·ç±»å°è£…


**ğŸ› ï¸ äº‹åŠ¡ç®¡ç†å·¥å…·ç±»**
```java
public class TransactionManager {
    
    // å¸¦äº‹åŠ¡çš„ä¸šåŠ¡æ“ä½œæ¨¡æ¿
    public static <T> T executeInTransaction(TransactionCallback<T> callback) 
            throws Exception {
        
        Connection conn = null;
        try {
            // 1. è·å–è¿æ¥ï¼Œå¼€å¯äº‹åŠ¡
            conn = DBUtil.getConnection();
            conn.setAutoCommit(false);
            
            // 2. æ‰§è¡Œä¸šåŠ¡æ“ä½œ
            T result = callback.doInTransaction(conn);
            
            // 3. æäº¤äº‹åŠ¡
            conn.commit();
            return result;
            
        } catch (Exception e) {
            // 4. å›æ»šäº‹åŠ¡
            if (conn != null) {
                conn.rollback();
            }
            throw e;
        } finally {
            // 5. æ¸…ç†èµ„æº
            if (conn != null) {
                conn.setAutoCommit(true);
                DBUtil.closeConnection(conn);
            }
        }
    }
    
    // äº‹åŠ¡å›è°ƒæ¥å£
    public interface TransactionCallback<T> {
        T doInTransaction(Connection conn) throws Exception;
    }
}

// ä½¿ç”¨ç¤ºä¾‹
public class UserService {
    
    public boolean registerUser(User user) throws Exception {
        return TransactionManager.executeInTransaction(conn -> {
            UserDAO userDAO = new UserDAO();
            LogDAO logDAO = new LogDAO();
            
            // åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œå¤šä¸ªæ“ä½œ
            int userId = userDAO.saveUser(user, conn);
            logDAO.saveLog(new Log("æ³¨å†Œ", userId), conn);
            
            return true;
        });
    }
}
```

**âœ… äº‹åŠ¡ç®¡ç†æœ€ä½³å®è·µ**
- **äº‹åŠ¡èŒƒå›´æœ€å°**ï¼šåªæŠŠéœ€è¦ä¸€è‡´æ€§çš„æ“ä½œæ”¾åœ¨äº‹åŠ¡ä¸­
- **å¼‚å¸¸å¿…å›æ»š**ï¼šä»»ä½•å¼‚å¸¸éƒ½è¦å›æ»šï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§
- **è¿æ¥è¦ä¼ é€’**ï¼šåŒä¸€äº‹åŠ¡ä¸­çš„æ‰€æœ‰DAOæ“ä½œä½¿ç”¨åŒä¸€ä¸ªè¿æ¥
- **èµ„æºå¿…é‡Šæ”¾**ï¼šæ— è®ºæˆåŠŸå¤±è´¥ï¼Œéƒ½è¦åœ¨finallyä¸­é‡Šæ”¾è¿æ¥

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


> ğŸ¯ **ä¸‰å±‚æ¶æ„çš„æœ¬è´¨**ï¼š**åˆ†å·¥åˆä½œï¼Œå„å¸å…¶èŒ**

**ğŸ”¸ å„å±‚èŒè´£ä¸€å¥è¯æ€»ç»“**
```
Controllerå±‚ï¼šæ¥å¾…å‘˜ â†’ "æ‚¨å¥½ï¼Œéœ€è¦ä»€ä¹ˆæœåŠ¡ï¼Ÿ"
Serviceå±‚ï¼šç»ç†    â†’ "æˆ‘æ¥å®‰æ’å…·ä½“æ€ä¹ˆåš"  
DAOå±‚ï¼šä¸“å‘˜       â†’ "æˆ‘å»æ•°æ®åº“æ‹¿æ•°æ®"
```

**ğŸ”¸ å±‚é—´è°ƒç”¨å…³ç³»**
```
ç”¨æˆ·è¯·æ±‚ â†’ Controller â†’ Service â†’ DAO â†’ æ•°æ®åº“
                â†“         â†“       â†“
            å‚æ•°è§£æ   ä¸šåŠ¡å¤„ç†   SQLæ‰§è¡Œ
                â†“         â†“       â†“  
            ç»“æœè¿”å›   ç»“æœéªŒè¯   æ•°æ®è½¬æ¢
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆè¦åˆ†å±‚**
- **èŒè´£æ¸…æ™°**ï¼šæ¯å±‚åªå…³å¿ƒè‡ªå·±çš„äº‹æƒ…
- **ä¾¿äºç»´æŠ¤**ï¼šä¿®æ”¹æŸå±‚ä¸å½±å“å…¶ä»–å±‚
- **ä»£ç å¤ç”¨**ï¼šServiceå’ŒDAOå¯ä»¥è¢«å¤šä¸ªControllerä½¿ç”¨
- **å›¢é˜Ÿåä½œ**ï¼šä¸åŒäººå¯ä»¥è´Ÿè´£ä¸åŒå±‚çš„å¼€å‘

**ğŸ”¹ æ•°æ®æµè½¬è§„å¾‹**
```
å‘ä¸‹ä¼ é€’ï¼šå…·ä½“æ•°æ®ï¼ˆå‚æ•°ã€å¯¹è±¡ï¼‰
å‘ä¸Šè¿”å›ï¼šå¤„ç†ç»“æœï¼ˆæ•°æ®ã€çŠ¶æ€ã€å¼‚å¸¸ï¼‰

Controller â†’ Serviceï¼šä¼ é€’ä¸šåŠ¡å‚æ•°
Service â†’ Controllerï¼šè¿”å›ä¸šåŠ¡ç»“æœ
Service â†’ DAOï¼šä¼ é€’æŸ¥è¯¢æ¡ä»¶  
DAO â†’ Serviceï¼šè¿”å›æ•°æ®å¯¹è±¡
```

**ğŸ”¹ å¼‚å¸¸å¤„ç†ç­–ç•¥**
```
DAOå±‚ï¼šç›´æ¥æŠ›å‡ºï¼Œä¸å¤„ç†ä¸šåŠ¡
Serviceå±‚ï¼šè½¬æ¢å¼‚å¸¸ï¼Œå¤„ç†ä¸šåŠ¡è§„åˆ™
Controllerå±‚ï¼šç”¨æˆ·å‹å¥½æç¤ºï¼Œé¡µé¢è·³è½¬
```

**ğŸ”¹ äº‹åŠ¡æ§åˆ¶åŸåˆ™**
```
è¯»æ“ä½œï¼šä¸éœ€è¦äº‹åŠ¡
å•è¡¨å†™ï¼šå¯é€‰äº‹åŠ¡
å¤šè¡¨å†™ï¼šå¿…é¡»äº‹åŠ¡
é‡‘èç±»ï¼šå¼ºåˆ¶äº‹åŠ¡
```

### 8.3 å®é™…å¼€å‘æŒ‡å¯¼


**ğŸ¯ å¼€å‘æ­¥éª¤å»ºè®®**
1. **å…ˆè®¾è®¡æ•°æ®åº“è¡¨ç»“æ„**
2. **ç¼–å†™å®ä½“ç±»ï¼ˆUserã€Orderç­‰ï¼‰**
3. **å¼€å‘DAOå±‚ï¼ˆæ•°æ®è®¿é—®ï¼‰**
4. **å¼€å‘Serviceå±‚ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰**
5. **å¼€å‘Controllerå±‚ï¼ˆè¯·æ±‚å¤„ç†ï¼‰**
6. **ç¼–å†™JSPé¡µé¢ï¼ˆç”¨æˆ·ç•Œé¢ï¼‰**

**âš ï¸ å¸¸è§é”™è¯¯é¿å…**
```
âŒ Controlleré‡Œç›´æ¥å†™SQL
âŒ DAOé‡Œå¤„ç†ä¸šåŠ¡é€»è¾‘  
âŒ Serviceé‡Œç›´æ¥æ“ä½œrequest/response
âŒ å¿˜è®°åœ¨finallyä¸­å…³é—­æ•°æ®åº“è¿æ¥
âŒ äº‹åŠ¡æ“ä½œä½¿ç”¨ä¸åŒçš„è¿æ¥å¯¹è±¡
```

**âœ… è‰¯å¥½ä¹ æƒ¯å…»æˆ**
```
âœ… ç»Ÿä¸€çš„åŒ…ç»“æ„ï¼šcontrollerã€serviceã€dao
âœ… ç»Ÿä¸€çš„å‘½åè§„èŒƒï¼šè§åçŸ¥æ„
âœ… ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†ï¼šåˆ†å±‚å¤„ç†
âœ… ç»Ÿä¸€çš„äº‹åŠ¡ç®¡ç†ï¼šè¯¥ç”¨å°±ç”¨
âœ… ç»Ÿä¸€çš„èµ„æºç®¡ç†ï¼šç”¨å®Œå°±å…³
```

### 8.4 æ ¸å¿ƒè®°å¿†å£è¯€


> ğŸ¯ **ä¸‰å±‚æ¶æ„é¡ºå£æºœ**
> 
> **Controlleræ¥å‰å°ï¼Œå‚æ•°éªŒè¯ä¸èƒ½å°‘**
> **Serviceç®¡ä¸šåŠ¡ï¼Œäº‹åŠ¡å¼‚å¸¸è¦å¤„ç†**  
> **DAOè®¿æ•°æ®åº“ï¼ŒSQLæ‰§è¡Œæ˜¯æœ¬èŒ**
> **å±‚å±‚æœ‰åˆ†å·¥ï¼Œæ•°æ®ä¸Šä¸‹æµè½¬é€š**

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- ä¸‰å±‚æ¶æ„æ˜¯**åˆ†å·¥åˆä½œ**çš„è®¾è®¡æ¨¡å¼
- æ¯å±‚éƒ½æœ‰**æ˜ç¡®èŒè´£**ï¼Œä¸èƒ½è¶Šç•Œ
- æ•°æ®åœ¨å±‚é—´**æœ‰åºæµè½¬**ï¼Œå¼‚å¸¸è¦**å¦¥å–„å¤„ç†**
- æ¶‰åŠå¤šè¡¨æ“ä½œæ—¶ï¼Œ**äº‹åŠ¡ç®¡ç†**ä¸å¯å°‘
- èµ„æºä½¿ç”¨å®Œæ¯•ï¼Œ**å¿…é¡»åŠæ—¶é‡Šæ”¾**