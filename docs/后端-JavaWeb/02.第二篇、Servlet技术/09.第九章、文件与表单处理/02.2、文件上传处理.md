---
title: 2ã€æ–‡ä»¶ä¸Šä¼ å¤„ç†
---
## ğŸ“š ç›®å½•

1. [ä»€ä¹ˆæ˜¯æ–‡ä»¶ä¸Šä¼ ](#1-ä»€ä¹ˆæ˜¯æ–‡ä»¶ä¸Šä¼ )
2. [æ–‡ä»¶ä¸Šä¼ çš„åŸºæœ¬åŸç†](#2-æ–‡ä»¶ä¸Šä¼ çš„åŸºæœ¬åŸç†)
3. [multipart/form-dataç¼–ç è¯¦è§£](#3-multipartform-dataç¼–ç è¯¦è§£)
4. [Servlet3.0åŸç”Ÿæ–‡ä»¶ä¸Šä¼ ](#4-servlet30åŸç”Ÿæ–‡ä»¶ä¸Šä¼ )
5. [Apache Commons FileUploadæ–¹å¼](#5-apache-commons-fileuploadæ–¹å¼)
6. [æ–‡ä»¶ä¸Šä¼ å®‰å…¨æ§åˆ¶](#6-æ–‡ä»¶ä¸Šä¼ å®‰å…¨æ§åˆ¶)
7. [ä¸Šä¼ è¿›åº¦ç›‘æ§å®ç°](#7-ä¸Šä¼ è¿›åº¦ç›‘æ§å®ç°)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ ä»€ä¹ˆæ˜¯æ–‡ä»¶ä¸Šä¼ 


### 1.1 æ–‡ä»¶ä¸Šä¼ çš„ç”Ÿæ´»åŒ–ç†è§£


**ğŸ”¸ ç”Ÿæ´»ä¸­çš„æ–‡ä»¶ä¸Šä¼ **
æƒ³è±¡ä¸€ä¸‹ä½ è¦ç»™æœ‹å‹å‘é€ä¸€å¼ ç…§ç‰‡ï¼š
- **é‚®å¯„æ–¹å¼**ï¼šæŠŠç…§ç‰‡è£…è¿›ä¿¡å°ï¼Œå†™å¥½åœ°å€ï¼ŒæŠ•é€’åˆ°é‚®å±€
- **ç½‘ç»œä¸Šä¼ **ï¼šé€‰æ‹©æ–‡ä»¶ï¼Œç‚¹å‡»ä¸Šä¼ ï¼Œæ–‡ä»¶ä¼ åˆ°æœåŠ¡å™¨

```
ç”¨æˆ·æ“ä½œæµç¨‹ï¼š
é€‰æ‹©æ–‡ä»¶ â†’ ç‚¹å‡»ä¸Šä¼  â†’ æ–‡ä»¶ä¼ è¾“ â†’ æœåŠ¡å™¨æ¥æ”¶ â†’ å­˜å‚¨åˆ°æŒ‡å®šä½ç½®

ç”Ÿæ´»ç±»æ¯”ï¼š
å¿«é€’åŒ…è£¹ â†’ å¡«å†™å•æ® â†’ ç‰©æµè¿è¾“ â†’ æ”¶ä»¶ç¡®è®¤ â†’ æ”¾å…¥ä»“åº“
```

### 1.2 Webæ–‡ä»¶ä¸Šä¼ çš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯æ–‡ä»¶ä¸Šä¼ **
```
æ–‡ä»¶ä¸Šä¼ ï¼šç”¨æˆ·é€šè¿‡ç½‘é¡µå°†æœ¬åœ°æ–‡ä»¶ä¼ é€åˆ°æœåŠ¡å™¨çš„è¿‡ç¨‹

æ ¸å¿ƒè¦ç´ ï¼š
â€¢ å‰ç«¯ï¼šHTMLè¡¨å• + æ–‡ä»¶é€‰æ‹©æ¡†
â€¢ ä¼ è¾“ï¼šHTTPåè®® + ç‰¹æ®Šç¼–ç æ ¼å¼
â€¢ åç«¯ï¼šServletæ¥æ”¶ + æ–‡ä»¶å­˜å‚¨
â€¢ å®‰å…¨ï¼šæ–‡ä»¶éªŒè¯ + å¤§å°é™åˆ¶
```

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦æ–‡ä»¶ä¸Šä¼ **
```
å®é™…åº”ç”¨åœºæ™¯ï¼š
ğŸ“¸ å¤´åƒä¸Šä¼ ï¼šç”¨æˆ·è®¾ç½®ä¸ªäººå¤´åƒ
ğŸ“„ æ–‡æ¡£åˆ†äº«ï¼šä¸Šä¼ PDFã€Wordæ–‡æ¡£
ğŸµ åª’ä½“æ–‡ä»¶ï¼šéŸ³ä¹ã€è§†é¢‘æ–‡ä»¶ä¸Šä¼ 
ğŸ’¼ åŠå…¬ç³»ç»Ÿï¼šåˆåŒã€æŠ¥è¡¨æ–‡ä»¶æäº¤
```

---

## 2. âš™ï¸ æ–‡ä»¶ä¸Šä¼ çš„åŸºæœ¬åŸç†


### 2.1 æ™®é€šè¡¨å• vs æ–‡ä»¶ä¸Šä¼ è¡¨å•


**ğŸ”¸ æ™®é€šè¡¨å•çš„æ•°æ®ä¼ è¾“**
```html
<!-- æ™®é€šè¡¨å•ï¼šåªèƒ½ä¼ è¾“æ–‡æœ¬æ•°æ® -->
<form action="/login" method="post">
    <input type="text" name="username" value="å¼ ä¸‰">
    <input type="password" name="password" value="123456">
    <button type="submit">ç™»å½•</button>
</form>

ä¼ è¾“æ•°æ®æ ¼å¼ï¼š
username=å¼ ä¸‰&password=123456
```

**ğŸ”¸ æ–‡ä»¶ä¸Šä¼ è¡¨å•çš„åŒºåˆ«**
```html
<!-- æ–‡ä»¶ä¸Šä¼ è¡¨å•ï¼šèƒ½ä¼ è¾“äºŒè¿›åˆ¶æ–‡ä»¶æ•°æ® -->
<form action="/upload" method="post" enctype="multipart/form-data">
    <input type="text" name="description" value="æˆ‘çš„ç…§ç‰‡">
    <input type="file" name="photo" accept="image/*">
    <button type="submit">ä¸Šä¼ </button>
</form>

å…³é”®åŒºåˆ«ï¼š
â€¢ method="post"ï¼šå¿…é¡»ä½¿ç”¨POSTæ–¹æ³•
â€¢ enctype="multipart/form-data"ï¼šç‰¹æ®Šç¼–ç æ ¼å¼
â€¢ type="file"ï¼šæ–‡ä»¶é€‰æ‹©æ¡†
```

### 2.2 æ–‡ä»¶ä¸Šä¼ çš„æ•°æ®æµè½¬è¿‡ç¨‹


**ğŸ“Š æ•°æ®ä¼ è¾“æµç¨‹å›¾**
```
æµè§ˆå™¨ç«¯                     æœåŠ¡å™¨ç«¯
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é€‰æ‹©æ–‡ä»¶   â”‚             â”‚   æ¥æ”¶è¯·æ±‚  â”‚
â”‚  photo.jpg  â”‚   HTTPè¯·æ±‚  â”‚   è§£ææ•°æ®  â”‚
â”‚   (2MB)     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”‚   éªŒè¯æ–‡ä»¶  â”‚
â”‚             â”‚             â”‚   ä¿å­˜æ–‡ä»¶  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”„ è¯¦ç»†ä¼ è¾“æ­¥éª¤**
```
æ­¥éª¤1ï¼šç”¨æˆ·åœ¨ç½‘é¡µä¸­é€‰æ‹©æ–‡ä»¶
æ­¥éª¤2ï¼šæµè§ˆå™¨è¯»å–æ–‡ä»¶å†…å®¹åˆ°å†…å­˜
æ­¥éª¤3ï¼šå°†æ–‡ä»¶æ•°æ®æŒ‰multipartæ ¼å¼ç¼–ç 
æ­¥éª¤4ï¼šé€šè¿‡HTTP POSTè¯·æ±‚å‘é€åˆ°æœåŠ¡å™¨
æ­¥éª¤5ï¼šæœåŠ¡å™¨è§£æmultipartæ•°æ®
æ­¥éª¤6ï¼šæå–æ–‡ä»¶å†…å®¹å’Œå…¶ä»–è¡¨å•æ•°æ®
æ­¥éª¤7ï¼šéªŒè¯æ–‡ä»¶æ ¼å¼å’Œå¤§å°
æ­¥éª¤8ï¼šå°†æ–‡ä»¶ä¿å­˜åˆ°æŒ‡å®šç›®å½•
```

---

## 3. ğŸ“‹ multipart/form-dataç¼–ç è¯¦è§£


### 3.1 ä»€ä¹ˆæ˜¯multipart/form-data


**ğŸ”¸ ç¼–ç æ ¼å¼å¯¹æ¯”**
```
æ™®é€šè¡¨å•ç¼–ç  (application/x-www-form-urlencoded)ï¼š
åªèƒ½å¤„ç†æ–‡æœ¬æ•°æ®ï¼Œåƒè¿™æ ·ï¼š
name=å¼ ä¸‰&age=25&city=åŒ—äº¬

æ–‡ä»¶ä¸Šä¼ ç¼–ç  (multipart/form-data)ï¼š
èƒ½å¤„ç†æ–‡æœ¬+äºŒè¿›åˆ¶æ•°æ®ï¼ŒåƒåŒ…è£¹ä¸€æ ·åˆ†æ®µæ‰“åŒ…ï¼š
--è¾¹ç•Œçº¿
æ™®é€šå­—æ®µæ•°æ®
--è¾¹ç•Œçº¿  
æ–‡ä»¶æ•°æ®ï¼ˆäºŒè¿›åˆ¶ï¼‰
--è¾¹ç•Œçº¿--
```

### 3.2 multipartæ•°æ®æ ¼å¼è¯¦è§£


**ğŸ“¦ å®é™…æ•°æ®åŒ…ç»“æ„**
```
POST /upload HTTP/1.1
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW

------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="description"

æˆ‘çš„ç…§ç‰‡æè¿°
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="photo"; filename="sunset.jpg"
Content-Type: image/jpeg

[äºŒè¿›åˆ¶æ–‡ä»¶æ•°æ®...]
------WebKitFormBoundary7MA4YWxkTrZu0gW--
```

**ğŸ’¡ æ•°æ®æ ¼å¼ç†è§£**
```
è¾¹ç•Œçº¿çš„ä½œç”¨ï¼š
å°±åƒå¿«é€’åŒ…è£¹é‡Œçš„åˆ†éš”æ¿ï¼ŒæŠŠä¸åŒç‰©å“åˆ†å¼€

æ¯ä¸ªéƒ¨åˆ†åŒ…å«ï¼š
â€¢ Content-Dispositionï¼šè¯´æ˜è¿™æ˜¯ä»€ä¹ˆå­—æ®µ
â€¢ Content-Typeï¼šæ–‡ä»¶ç±»å‹ï¼ˆå¯é€‰ï¼‰
â€¢ å®é™…æ•°æ®ï¼šæ–‡æœ¬å†…å®¹æˆ–äºŒè¿›åˆ¶æ–‡ä»¶æ•°æ®

è¾¹ç•Œçº¿è§„åˆ™ï¼š
â€¢ å¼€å§‹ï¼š--è¾¹ç•Œçº¿
â€¢ ç»“æŸï¼š--è¾¹ç•Œçº¿--ï¼ˆæœ«å°¾å¤šä¸¤ä¸ªæ¨ªçº¿ï¼‰
```

---

## 4. ğŸ›  Servlet3.0åŸç”Ÿæ–‡ä»¶ä¸Šä¼ 


### 4.1 @MultipartConfigæ³¨è§£é…ç½®


**ğŸ”¸ æ³¨è§£çš„ä½œç”¨å’Œé…ç½®**
```java
@WebServlet("/upload")
@MultipartConfig(
    maxFileSize = 5 * 1024 * 1024,        // å•ä¸ªæ–‡ä»¶æœ€å¤§5MB
    maxRequestSize = 10 * 1024 * 1024,    // æ•´ä¸ªè¯·æ±‚æœ€å¤§10MB
    fileSizeThreshold = 1024 * 1024,      // å†…å­˜é˜ˆå€¼1MB
    location = "/tmp"                      // ä¸´æ—¶æ–‡ä»¶å­˜å‚¨ä½ç½®
)
public class FileUploadServlet extends HttpServlet {
    // Servletä»£ç 
}
```

**ğŸ’¡ é…ç½®å‚æ•°è¯¦è§£**
```
maxFileSizeï¼šå•ä¸ªæ–‡ä»¶çš„æœ€å¤§å¤§å°
â€¢ è¶…è¿‡è¿™ä¸ªå¤§å°ï¼Œä¸Šä¼ ä¼šå¤±è´¥
â€¢ å•ä½ï¼šå­—èŠ‚ï¼ˆbytesï¼‰
â€¢ å»ºè®®ï¼šæ ¹æ®å®é™…éœ€æ±‚è®¾ç½®ï¼Œé¿å…è¿‡å¤§

maxRequestSizeï¼šæ•´ä¸ªè¯·æ±‚çš„æœ€å¤§å¤§å°  
â€¢ åŒ…æ‹¬æ‰€æœ‰æ–‡ä»¶å’Œè¡¨å•æ•°æ®çš„æ€»å’Œ
â€¢ é€šå¸¸è¦æ¯”maxFileSizeå¤§ä¸€äº›

fileSizeThresholdï¼šå†…å­˜é˜ˆå€¼
â€¢ å°äºè¿™ä¸ªå¤§å°çš„æ–‡ä»¶ä¼šä¿å­˜åœ¨å†…å­˜ä¸­
â€¢ å¤§äºè¿™ä¸ªå¤§å°ä¼šå†™å…¥ä¸´æ—¶æ–‡ä»¶
â€¢ å½±å“æ€§èƒ½ï¼Œéœ€è¦å¹³è¡¡

locationï¼šä¸´æ—¶æ–‡ä»¶å­˜å‚¨ç›®å½•
â€¢ å¤§æ–‡ä»¶ä¼šå…ˆå­˜åœ¨è¿™é‡Œ
â€¢ å¤„ç†å®Œæˆåé€šå¸¸ä¼šåˆ é™¤
```

### 4.2 Partæ¥å£æ ¸å¿ƒæ–¹æ³•


**ğŸ”§ Partæ¥å£çš„ä¸»è¦åŠŸèƒ½**
```java
// è·å–ä¸Šä¼ çš„æ–‡ä»¶éƒ¨åˆ†
Part filePart = request.getPart("photo");

// æ ¸å¿ƒæ–¹æ³•ä½¿ç”¨
String fileName = filePart.getSubmittedFileName();  // è·å–æ–‡ä»¶å
long fileSize = filePart.getSize();                 // è·å–æ–‡ä»¶å¤§å°
String contentType = filePart.getContentType();     // è·å–æ–‡ä»¶ç±»å‹
InputStream inputStream = filePart.getInputStream(); // è·å–æ–‡ä»¶æµ

// ç›´æ¥å†™å…¥æ–‡ä»¶
filePart.write("/upload/photos/" + fileName);
```

### 4.3 å®Œæ•´çš„æ–‡ä»¶ä¸Šä¼ Servletç¤ºä¾‹


**ğŸ“ å®ç”¨çš„ä¸Šä¼ å¤„ç†ä»£ç **
```java
@WebServlet("/upload")
@MultipartConfig(maxFileSize = 5 * 1024 * 1024)
public class FileUploadServlet extends HttpServlet {
    
    protected void doPost(HttpServletRequest request, HttpServletResponse response) 
            throws ServletException, IOException {
        
        // è®¾ç½®å“åº”ç¼–ç 
        response.setContentType("text/html;charset=UTF-8");
        PrintWriter out = response.getWriter();
        
        try {
            // 1. è·å–æ™®é€šè¡¨å•å­—æ®µ
            String description = request.getParameter("description");
            
            // 2. è·å–æ–‡ä»¶éƒ¨åˆ†
            Part filePart = request.getPart("photo");
            
            // 3. åŸºæœ¬éªŒè¯
            if (filePart == null || filePart.getSize() == 0) {
                out.println("è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶");
                return;
            }
            
            // 4. è·å–æ–‡ä»¶ä¿¡æ¯
            String fileName = filePart.getSubmittedFileName();
            String contentType = filePart.getContentType();
            long fileSize = filePart.getSize();
            
            // 5. æ–‡ä»¶ç±»å‹éªŒè¯
            if (!contentType.startsWith("image/")) {
                out.println("åªèƒ½ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶");
                return;
            }
            
            // 6. ç”Ÿæˆå”¯ä¸€æ–‡ä»¶åï¼ˆé¿å…é‡å¤ï¼‰
            String uniqueFileName = System.currentTimeMillis() + "_" + fileName;
            
            // 7. ä¿å­˜æ–‡ä»¶
            String uploadPath = getServletContext().getRealPath("/uploads");
            File uploadDir = new File(uploadPath);
            if (!uploadDir.exists()) {
                uploadDir.mkdirs();  // åˆ›å»ºç›®å½•
            }
            
            filePart.write(uploadPath + "/" + uniqueFileName);
            
            // 8. è¿”å›æˆåŠŸä¿¡æ¯
            out.println("æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼");
            out.println("æ–‡ä»¶åï¼š" + fileName);
            out.println("å¤§å°ï¼š" + fileSize + " å­—èŠ‚");
            out.println("æè¿°ï¼š" + description);
            
        } catch (Exception e) {
            out.println("ä¸Šä¼ å¤±è´¥ï¼š" + e.getMessage());
        }
    }
}
```

---

## 5. ğŸ“š Apache Commons FileUploadæ–¹å¼


### 5.1 ä¸ºä»€ä¹ˆéœ€è¦Commons FileUpload


**ğŸ”¸ åŸç”Ÿæ–¹å¼ vs Commons FileUploadå¯¹æ¯”**

| ç‰¹æ€§ | **Servlet3.0åŸç”Ÿ** | **Commons FileUpload** |
|------|-------------------|------------------------|
| ğŸ”§ **é…ç½®å¤æ‚åº¦** | `ç®€å•ï¼Œæ³¨è§£é…ç½®` | `éœ€è¦æ‰‹åŠ¨é…ç½®` |
| ğŸ¯ **åŠŸèƒ½ä¸°å¯Œåº¦** | `åŸºç¡€åŠŸèƒ½` | `åŠŸèƒ½å¼ºå¤§ï¼Œé€‰é¡¹å¤š` |
| âš¡ **æ€§èƒ½æ§åˆ¶** | `æœ‰é™æ§åˆ¶` | `ç²¾ç»†åŒ–æ§åˆ¶` |
| ğŸ”„ **å…¼å®¹æ€§** | `Servlet3.0+` | `æ”¯æŒè€ç‰ˆæœ¬` |
| ğŸ“Š **è¿›åº¦ç›‘æ§** | `ä¸æ”¯æŒ` | `æ”¯æŒä¸Šä¼ è¿›åº¦` |

**ğŸ’¡ é€‰æ‹©å»ºè®®**
```
ä½¿ç”¨åŸç”Ÿæ–¹å¼ï¼š
â€¢ é¡¹ç›®æ¯”è¾ƒç®€å•
â€¢ æ–‡ä»¶ä¸Šä¼ éœ€æ±‚ä¸å¤æ‚
â€¢ ä½¿ç”¨Servlet3.0ä»¥ä¸Šç‰ˆæœ¬

ä½¿ç”¨Commons FileUploadï¼š
â€¢ éœ€è¦ç²¾ç»†çš„è¿›åº¦æ§åˆ¶
â€¢ æœ‰å¤æ‚çš„æ–‡ä»¶å¤„ç†éœ€æ±‚
â€¢ éœ€è¦æ”¯æŒè€ç‰ˆæœ¬Servlet
```

### 5.2 Commons FileUploadåŸºæœ¬ä½¿ç”¨


**ğŸ”§ ä¾èµ–é…ç½®å’ŒåŸºæœ¬ä»£ç **
```xml
<!-- Mavenä¾èµ– -->
<dependency>
    <groupId>commons-fileupload</groupId>
    <artifactId>commons-fileupload</artifactId>
    <version>1.4</version>
</dependency>
<dependency>
    <groupId>commons-io</groupId>
    <artifactId>commons-io</artifactId>
    <version>2.11.0</version>
</dependency>
```

```java
public class CommonsFileUploadServlet extends HttpServlet {
    
    protected void doPost(HttpServletRequest request, HttpServletResponse response) 
            throws ServletException, IOException {
        
        // 1. åˆ›å»ºæ–‡ä»¶ä¸Šä¼ å¤„ç†å™¨
        DiskFileItemFactory factory = new DiskFileItemFactory();
        factory.setSizeThreshold(1024 * 1024);  // 1MBå†…å­˜é˜ˆå€¼
        factory.setRepository(new File("/tmp")); // ä¸´æ—¶ç›®å½•
        
        ServletFileUpload upload = new ServletFileUpload(factory);
        upload.setFileSizeMax(5 * 1024 * 1024);     // å•æ–‡ä»¶5MB
        upload.setSizeMax(10 * 1024 * 1024);        // æ€»è¯·æ±‚10MB
        upload.setHeaderEncoding("UTF-8");          // ä¸­æ–‡æ–‡ä»¶åæ”¯æŒ
        
        try {
            // 2. è§£æè¯·æ±‚
            List<FileItem> items = upload.parseRequest(request);
            
            for (FileItem item : items) {
                if (item.isFormField()) {
                    // æ™®é€šè¡¨å•å­—æ®µ
                    String fieldName = item.getFieldName();
                    String fieldValue = item.getString("UTF-8");
                    System.out.println(fieldName + " = " + fieldValue);
                } else {
                    // æ–‡ä»¶å­—æ®µ
                    String fileName = item.getName();
                    if (fileName != null && !fileName.trim().equals("")) {
                        // ä¿å­˜æ–‡ä»¶
                        String uploadPath = getServletContext().getRealPath("/uploads");
                        File file = new File(uploadPath, fileName);
                        item.write(file);
                        
                        response.getWriter().println("æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼š" + fileName);
                    }
                }
            }
        } catch (Exception e) {
            response.getWriter().println("ä¸Šä¼ å¤±è´¥ï¼š" + e.getMessage());
        }
    }
}
```

---

## 6. ğŸ”’ æ–‡ä»¶ä¸Šä¼ å®‰å…¨æ§åˆ¶


### 6.1 æ–‡ä»¶ç±»å‹éªŒè¯ç­–ç•¥


**ğŸ”¸ å¤šå±‚éªŒè¯æœºåˆ¶**
```java
public class FileValidator {
    
    // 1. æ‰©å±•åéªŒè¯
    private static final Set<String> ALLOWED_EXTENSIONS = 
        Set.of(".jpg", ".jpeg", ".png", ".gif", ".pdf", ".doc", ".docx");
    
    // 2. MIMEç±»å‹éªŒè¯
    private static final Set<String> ALLOWED_MIME_TYPES = 
        Set.of("image/jpeg", "image/png", "image/gif", "application/pdf");
    
    public static boolean isValidFile(String fileName, String contentType) {
        // æ‰©å±•åæ£€æŸ¥
        String extension = getFileExtension(fileName).toLowerCase();
        if (!ALLOWED_EXTENSIONS.contains(extension)) {
            return false;
        }
        
        // MIMEç±»å‹æ£€æŸ¥
        if (!ALLOWED_MIME_TYPES.contains(contentType)) {
            return false;
        }
        
        return true;
    }
    
    private static String getFileExtension(String fileName) {
        int lastDot = fileName.lastIndexOf('.');
        return lastDot > 0 ? fileName.substring(lastDot) : "";
    }
}
```

### 6.2 æ–‡ä»¶å¤§å°é™åˆ¶ç­–ç•¥


**ğŸ“Š å¤§å°æ§åˆ¶æœ€ä½³å®è·µ**
```java
public class FileSizeValidator {
    
    // ä¸åŒæ–‡ä»¶ç±»å‹çš„å¤§å°é™åˆ¶
    private static final Map<String, Long> SIZE_LIMITS = Map.of(
        "image", 2 * 1024 * 1024L,      // å›¾ç‰‡2MB
        "document", 5 * 1024 * 1024L,   // æ–‡æ¡£5MB
        "video", 50 * 1024 * 1024L      // è§†é¢‘50MB
    );
    
    public static boolean isValidSize(String contentType, long fileSize) {
        String category = getFileCategory(contentType);
        Long maxSize = SIZE_LIMITS.get(category);
        
        if (maxSize == null) {
            return false;  // ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹
        }
        
        return fileSize <= maxSize;
    }
    
    private static String getFileCategory(String contentType) {
        if (contentType.startsWith("image/")) return "image";
        if (contentType.startsWith("video/")) return "video";
        if (contentType.contains("pdf") || contentType.contains("document")) {
            return "document";
        }
        return "unknown";
    }
}
```

### 6.3 æ–‡ä»¶å­˜å‚¨è·¯å¾„å®‰å…¨


**ğŸ›¡ï¸ å®‰å…¨å­˜å‚¨ç­–ç•¥**
```java
public class SecureFileStorage {
    
    // 1. å®‰å…¨çš„æ–‡ä»¶åç”Ÿæˆ
    public static String generateSafeFileName(String originalName) {
        // ç§»é™¤å±é™©å­—ç¬¦
        String safeName = originalName.replaceAll("[^a-zA-Z0-9\\.\\-_]", "");
        
        // æ·»åŠ æ—¶é—´æˆ³é¿å…é‡å¤
        String timestamp = String.valueOf(System.currentTimeMillis());
        String extension = getFileExtension(safeName);
        String nameWithoutExt = safeName.substring(0, safeName.lastIndexOf('.'));
        
        return nameWithoutExt + "_" + timestamp + extension;
    }
    
    // 2. å®‰å…¨çš„å­˜å‚¨è·¯å¾„
    public static String getSecureUploadPath(ServletContext context) {
        // ä¸è¦ç›´æ¥å­˜å‚¨åœ¨webç›®å½•ä¸‹ï¼ˆå®‰å…¨é£é™©ï¼‰
        String webAppPath = context.getRealPath("/");
        File parentDir = new File(webAppPath).getParentFile();
        File uploadDir = new File(parentDir, "uploads");
        
        if (!uploadDir.exists()) {
            uploadDir.mkdirs();
        }
        
        return uploadDir.getAbsolutePath();
    }
    
    // 3. åˆ›å»ºæŒ‰æ—¥æœŸåˆ†å±‚çš„ç›®å½•ç»“æ„
    public static String createDateBasedPath(String basePath) {
        LocalDate today = LocalDate.now();
        String datePath = today.getYear() + "/" + 
                         String.format("%02d", today.getMonthValue()) + "/" +
                         String.format("%02d", today.getDayOfMonth());
        
        File dateDir = new File(basePath, datePath);
        if (!dateDir.exists()) {
            dateDir.mkdirs();
        }
        
        return dateDir.getAbsolutePath();
    }
}
```

**âš ï¸ å®‰å…¨æ³¨æ„äº‹é¡¹**
```
æ–‡ä»¶ä¸Šä¼ å®‰å…¨è¦ç‚¹ï¼š

1. æ–‡ä»¶ç±»å‹éªŒè¯
   âœ… æ£€æŸ¥æ‰©å±•åå’ŒMIMEç±»å‹
   âœ… ä¸èƒ½ä»…ä¾èµ–å‰ç«¯éªŒè¯
   âœ… ä½¿ç”¨ç™½åå•è€Œä¸æ˜¯é»‘åå•

2. æ–‡ä»¶å¤§å°æ§åˆ¶  
   âœ… è®¾ç½®åˆç†çš„å¤§å°é™åˆ¶
   âœ… è€ƒè™‘æœåŠ¡å™¨å­˜å‚¨ç©ºé—´
   âœ… é˜²æ­¢æ¶æ„å¤§æ–‡ä»¶æ”»å‡»

3. å­˜å‚¨è·¯å¾„å®‰å…¨
   âœ… ä¸è¦å­˜å‚¨åœ¨webå¯ç›´æ¥è®¿é—®ç›®å½•
   âœ… ç”Ÿæˆå”¯ä¸€æ–‡ä»¶åé˜²æ­¢è¦†ç›–
   âœ… ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œé˜²æ­¢è·¯å¾„éå†

4. æ–‡ä»¶åå®‰å…¨
   âœ… è¿‡æ»¤ç‰¹æ®Šå­—ç¬¦
   âœ… é™åˆ¶æ–‡ä»¶åé•¿åº¦
   âœ… é˜²æ­¢è·¯å¾„æ³¨å…¥æ”»å‡»
```

---

## 7. ğŸ“ˆ ä¸Šä¼ è¿›åº¦ç›‘æ§å®ç°


### 7.1 è¿›åº¦ç›‘æ§çš„å®ç°åŸç†


**ğŸ”¸ è¿›åº¦ç›‘æ§å·¥ä½œåŸç†**
```
ä¼ ç»Ÿä¸Šä¼ è¿‡ç¨‹ï¼š
ç”¨æˆ·é€‰æ‹©æ–‡ä»¶ â†’ ç‚¹å‡»ä¸Šä¼  â†’ ç­‰å¾…... â†’ ä¸Šä¼ å®Œæˆ

å¸¦è¿›åº¦ç›‘æ§çš„ä¸Šä¼ ï¼š
ç”¨æˆ·é€‰æ‹©æ–‡ä»¶ â†’ ç‚¹å‡»ä¸Šä¼  â†’ å®æ—¶æ˜¾ç¤ºè¿›åº¦æ¡ â†’ ä¸Šä¼ å®Œæˆ

æŠ€æœ¯å®ç°ï¼š
1. æœåŠ¡å™¨ç«¯ï¼šå®ç°ProgressListenerç›‘å¬ä¸Šä¼ è¿›åº¦
2. å‰ç«¯ï¼šAjaxè½®è¯¢æˆ–WebSocketè·å–è¿›åº¦ä¿¡æ¯
3. æ˜¾ç¤ºï¼šè¿›åº¦æ¡å®æ—¶æ›´æ–°
```

### 7.2 Commons FileUploadè¿›åº¦ç›‘æ§


**ğŸ“Š è¿›åº¦ç›‘å¬å™¨å®ç°**
```java
public class UploadProgressListener implements ProgressListener {
    
    private HttpSession session;
    
    public UploadProgressListener(HttpSession session) {
        this.session = session;
    }
    
    @Override
    public void update(long bytesRead, long contentLength, int items) {
        // è®¡ç®—ä¸Šä¼ è¿›åº¦
        int percentage = (int) (bytesRead * 100 / contentLength);
        
        // åˆ›å»ºè¿›åº¦ä¿¡æ¯å¯¹è±¡
        ProgressInfo progressInfo = new ProgressInfo();
        progressInfo.setBytesRead(bytesRead);
        progressInfo.setContentLength(contentLength);
        progressInfo.setPercentage(percentage);
        progressInfo.setCurrentItem(items);
        
        // å°†è¿›åº¦ä¿¡æ¯å­˜å‚¨åˆ°sessionä¸­
        session.setAttribute("uploadProgress", progressInfo);
        
        System.out.println("ä¸Šä¼ è¿›åº¦: " + percentage + "% (" + 
                          formatFileSize(bytesRead) + "/" + 
                          formatFileSize(contentLength) + ")");
    }
    
    private String formatFileSize(long size) {
        if (size >= 1024 * 1024) {
            return String.format("%.1f MB", size / 1024.0 / 1024.0);
        } else if (size >= 1024) {
            return String.format("%.1f KB", size / 1024.0);
        } else {
            return size + " B";
        }
    }
}

// è¿›åº¦ä¿¡æ¯ç±»
public class ProgressInfo {
    private long bytesRead;      // å·²è¯»å­—èŠ‚æ•°
    private long contentLength;  // æ€»å­—èŠ‚æ•°
    private int percentage;      // ç™¾åˆ†æ¯”
    private int currentItem;     // å½“å‰å¤„ç†é¡¹ç›®
    
    // getterå’Œsetteræ–¹æ³•...
}
```

### 7.3 å¸¦è¿›åº¦ç›‘æ§çš„æ–‡ä»¶ä¸Šä¼ Servlet


**ğŸ”§ å®Œæ•´çš„è¿›åº¦ç›‘æ§å®ç°**
```java
@WebServlet("/upload-with-progress")
public class ProgressUploadServlet extends HttpServlet {
    
    protected void doPost(HttpServletRequest request, HttpServletResponse response) 
            throws ServletException, IOException {
        
        // åˆ›å»ºè¿›åº¦ç›‘å¬å™¨
        UploadProgressListener progressListener = 
            new UploadProgressListener(request.getSession());
        
        // é…ç½®æ–‡ä»¶ä¸Šä¼ 
        DiskFileItemFactory factory = new DiskFileItemFactory();
        ServletFileUpload upload = new ServletFileUpload(factory);
        upload.setProgressListener(progressListener);  // è®¾ç½®è¿›åº¦ç›‘å¬
        upload.setFileSizeMax(10 * 1024 * 1024);      // 10MBé™åˆ¶
        
        try {
            List<FileItem> items = upload.parseRequest(request);
            
            for (FileItem item : items) {
                if (!item.isFormField()) {
                    String fileName = item.getName();
                    if (fileName != null && !fileName.trim().equals("")) {
                        // ä¿å­˜æ–‡ä»¶
                        String uploadPath = getServletContext().getRealPath("/uploads");
                        File file = new File(uploadPath, fileName);
                        item.write(file);
                    }
                }
            }
            
            // ä¸Šä¼ å®Œæˆï¼Œæ¸…é™¤è¿›åº¦ä¿¡æ¯
            request.getSession().removeAttribute("uploadProgress");
            response.getWriter().println("æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼");
            
        } catch (Exception e) {
            response.getWriter().println("ä¸Šä¼ å¤±è´¥ï¼š" + e.getMessage());
        }
    }
}

// è·å–è¿›åº¦çš„æ¥å£
@WebServlet("/upload-progress")
public class GetProgressServlet extends HttpServlet {
    
    protected void doGet(HttpServletRequest request, HttpServletResponse response) 
            throws ServletException, IOException {
        
        response.setContentType("application/json;charset=UTF-8");
        
        ProgressInfo progress = 
            (ProgressInfo) request.getSession().getAttribute("uploadProgress");
        
        if (progress != null) {
            // è¿”å›JSONæ ¼å¼çš„è¿›åº¦ä¿¡æ¯
            String json = String.format(
                "{\"percentage\": %d, \"bytesRead\": %d, \"contentLength\": %d}",
                progress.getPercentage(),
                progress.getBytesRead(),
                progress.getContentLength()
            );
            response.getWriter().print(json);
        } else {
            response.getWriter().print("{\"percentage\": 0}");
        }
    }
}
```

### 7.4 å‰ç«¯è¿›åº¦æ˜¾ç¤ºå®ç°


**ğŸ¨ ç®€å•çš„è¿›åº¦æ¡HTML+JavaScript**
```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>æ–‡ä»¶ä¸Šä¼ è¿›åº¦</title>
    <style>
        .progress-container {
            width: 400px;
            height: 20px;
            border: 1px solid #ccc;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-bar {
            height: 100%;
            background-color: #4CAF50;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            margin: 10px 0;
            font-family: Arial, sans-serif;
        }
    </style>
</head>
<body>
    <h2>æ–‡ä»¶ä¸Šä¼ </h2>
    
    <form id="uploadForm" action="/upload-with-progress" method="post" 
          enctype="multipart/form-data">
        <input type="file" name="file" id="fileInput" required>
        <br><br>
        <button type="submit">ä¸Šä¼ æ–‡ä»¶</button>
    </form>
    
    <div id="progressContainer" style="display: none;">
        <div class="progress-text">ä¸Šä¼ è¿›åº¦ï¼š<span id="progressText">0%</span></div>
        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>
    </div>

    <script>
        document.getElementById('uploadForm').onsubmit = function() {
            // æ˜¾ç¤ºè¿›åº¦æ¡
            document.getElementById('progressContainer').style.display = 'block';
            
            // å¼€å§‹ç›‘æ§è¿›åº¦
            monitorProgress();
            
            return true;
        };
        
        function monitorProgress() {
            const interval = setInterval(function() {
                fetch('/upload-progress')
                    .then(response => response.json())
                    .then(data => {
                        const percentage = data.percentage;
                        
                        // æ›´æ–°è¿›åº¦æ¡
                        document.getElementById('progressBar').style.width = percentage + '%';
                        document.getElementById('progressText').textContent = percentage + '%';
                        
                        // ä¸Šä¼ å®Œæˆ
                        if (percentage >= 100) {
                            clearInterval(interval);
                            setTimeout(() => {
                                document.getElementById('progressContainer').style.display = 'none';
                                alert('ä¸Šä¼ å®Œæˆï¼');
                            }, 1000);
                        }
                    })
                    .catch(error => {
                        console.error('è·å–è¿›åº¦å¤±è´¥:', error);
                        clearInterval(interval);
                    });
            }, 500); // æ¯500msæ£€æŸ¥ä¸€æ¬¡è¿›åº¦
        }
    </script>
</body>
</html>
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ–‡ä»¶ä¸Šä¼ æœ¬è´¨ï¼šå°†æœ¬åœ°æ–‡ä»¶é€šè¿‡HTTPä¼ è¾“åˆ°æœåŠ¡å™¨
ğŸ”¸ å…³é”®æŠ€æœ¯ï¼šmultipart/form-dataç¼–ç æ ¼å¼
ğŸ”¸ ä¸¤ç§å®ç°ï¼šServlet3.0åŸç”Ÿ vs Commons FileUpload
ğŸ”¸ å®‰å…¨è¦ç´ ï¼šç±»å‹éªŒè¯ã€å¤§å°é™åˆ¶ã€è·¯å¾„å®‰å…¨
ğŸ”¸ ç”¨æˆ·ä½“éªŒï¼šè¿›åº¦ç›‘æ§ã€é”™è¯¯å¤„ç†
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆéœ€è¦ç‰¹æ®Šç¼–ç æ ¼å¼**
```
æ™®é€šè¡¨å•ç¼–ç çš„å±€é™ï¼š
â€¢ åªèƒ½å¤„ç†æ–‡æœ¬æ•°æ®
â€¢ æ— æ³•ä¼ è¾“äºŒè¿›åˆ¶æ–‡ä»¶å†…å®¹
â€¢ ä¸æ”¯æŒæ··åˆæ•°æ®ç±»å‹

multipart/form-dataçš„ä¼˜åŠ¿ï¼š
â€¢ æ”¯æŒäºŒè¿›åˆ¶æ•°æ®ä¼ è¾“
â€¢ èƒ½å¤Ÿæ··åˆæ–‡æœ¬å’Œæ–‡ä»¶æ•°æ®
â€¢ é€šè¿‡è¾¹ç•Œçº¿åˆ†éš”ä¸åŒéƒ¨åˆ†
â€¢ ä¿æŒæ–‡ä»¶çš„åŸå§‹æ ¼å¼
```

**ğŸ”¹ ä¸¤ç§å®ç°æ–¹å¼çš„é€‰æ‹©**
```
Servlet3.0åŸç”Ÿæ–¹å¼ï¼š
ä¼˜ç‚¹ï¼šé…ç½®ç®€å•ï¼Œæ³¨è§£é©±åŠ¨ï¼Œè½»é‡çº§
é€‚ç”¨ï¼šç®€å•çš„æ–‡ä»¶ä¸Šä¼ éœ€æ±‚
å±€é™ï¼šåŠŸèƒ½ç›¸å¯¹åŸºç¡€ï¼Œè¿›åº¦ç›‘æ§å›°éš¾

Commons FileUploadæ–¹å¼ï¼š
ä¼˜ç‚¹ï¼šåŠŸèƒ½ä¸°å¯Œï¼Œè¿›åº¦ç›‘æ§ï¼Œç²¾ç»†æ§åˆ¶
é€‚ç”¨ï¼šå¤æ‚çš„æ–‡ä»¶å¤„ç†éœ€æ±‚
ç¼ºç‚¹ï¼šéœ€è¦é¢å¤–ä¾èµ–ï¼Œé…ç½®è¾ƒå¤æ‚
```

**ğŸ”¹ å®‰å…¨æ§åˆ¶çš„é‡è¦æ€§**
```
ä¸ºä»€ä¹ˆéœ€è¦å®‰å…¨æ§åˆ¶ï¼š
â€¢ é˜²æ­¢æ¶æ„æ–‡ä»¶ä¸Šä¼ ï¼ˆç—…æ¯’ã€è„šæœ¬ï¼‰
â€¢ é¿å…æœåŠ¡å™¨å­˜å‚¨ç©ºé—´è€—å°½
â€¢ é˜²æ­¢è·¯å¾„éå†æ”»å‡»
â€¢ ä¿æŠ¤æœåŠ¡å™¨å’Œç”¨æˆ·æ•°æ®å®‰å…¨

å®‰å…¨æ§åˆ¶ç­–ç•¥ï¼š
1. å¤šé‡éªŒè¯ï¼šæ‰©å±•å + MIMEç±»å‹ + æ–‡ä»¶å†…å®¹
2. å¤§å°é™åˆ¶ï¼šé˜²æ­¢æ¶æ„å¤§æ–‡ä»¶æ”»å‡»  
3. è·¯å¾„æ§åˆ¶ï¼šä½¿ç”¨å®‰å…¨çš„å­˜å‚¨ä½ç½®
4. æ–‡ä»¶åè¿‡æ»¤ï¼šç§»é™¤å±é™©å­—ç¬¦
```

### 8.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¸šåŠ¡åœºæ™¯åº”ç”¨**
- **ç”¨æˆ·å¤´åƒä¸Šä¼ **ï¼šä¸ªäººèµ„æ–™ç®¡ç†ï¼Œå¤´åƒå±•ç¤º
- **æ–‡æ¡£ç®¡ç†ç³»ç»Ÿ**ï¼šåˆåŒã€æŠ¥å‘Šæ–‡ä»¶ä¸Šä¼ å­˜å‚¨
- **ç”µå•†å¹³å°**ï¼šå•†å“å›¾ç‰‡ä¸Šä¼ ï¼Œè¯¦æƒ…å±•ç¤º
- **æ•™è‚²ç³»ç»Ÿ**ï¼šä½œä¸šæäº¤ï¼Œè¯¾ä»¶èµ„æºä¸Šä¼ 
- **ç¤¾äº¤åª’ä½“**ï¼šç…§ç‰‡ã€è§†é¢‘å†…å®¹åˆ†äº«

**ğŸ”§ å¼€å‘å®è·µè¦ç‚¹**
```
å‰ç«¯å¼€å‘ï¼š
â€¢ ä½¿ç”¨æ­£ç¡®çš„è¡¨å•ç¼–ç ç±»å‹
â€¢ æä¾›å‹å¥½çš„ç”¨æˆ·ç•Œé¢
â€¢ å®ç°ä¸Šä¼ è¿›åº¦æ˜¾ç¤º
â€¢ æ·»åŠ æ–‡ä»¶é€‰æ‹©éªŒè¯

åç«¯å¼€å‘ï¼š
â€¢ é€‰æ‹©åˆé€‚çš„å®ç°æ–¹å¼
â€¢ å®æ–½å®Œå–„çš„å®‰å…¨æ§åˆ¶
â€¢ è®¾è®¡åˆç†çš„å­˜å‚¨ç­–ç•¥
â€¢ æä¾›å®Œæ•´çš„é”™è¯¯å¤„ç†

è¿ç»´éƒ¨ç½²ï¼š
â€¢ é…ç½®åˆé€‚çš„æœåŠ¡å™¨å‚æ•°
â€¢ è®¾ç½®æ–‡ä»¶å­˜å‚¨ç›®å½•æƒé™
â€¢ ç›‘æ§ç£ç›˜ç©ºé—´ä½¿ç”¨
â€¢ å®šæœŸæ¸…ç†ä¸´æ—¶æ–‡ä»¶
```

### 8.4 å­¦ä¹ è·¯å¾„å»ºè®®


```
ğŸ“š å­¦ä¹ é¡ºåºï¼š
ç¬¬1æ­¥ï¼šç†è§£æ–‡ä»¶ä¸Šä¼ åŸºæœ¬åŸç†
ç¬¬2æ­¥ï¼šæŒæ¡multipartç¼–ç æ ¼å¼
ç¬¬3æ­¥ï¼šå®è·µServlet3.0åŸç”Ÿæ–¹å¼
ç¬¬4æ­¥ï¼šå­¦ä¹ Commons FileUploadä½¿ç”¨
ç¬¬5æ­¥ï¼šå®ç°å®‰å…¨æ§åˆ¶æœºåˆ¶
ç¬¬6æ­¥ï¼šæ·»åŠ è¿›åº¦ç›‘æ§åŠŸèƒ½

ğŸ¯ å®è·µé¡¹ç›®ï¼š
åˆçº§ï¼šç®€å•çš„å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½
ä¸­çº§ï¼šå¸¦è¿›åº¦æ˜¾ç¤ºçš„æ–‡ä»¶ç®¡ç†ç³»ç»Ÿ
é«˜çº§ï¼šä¼ä¸šçº§æ–‡æ¡£ç®¡ç†å¹³å°

â±ï¸ å­¦ä¹ æ—¶é—´è§„åˆ’ï¼š
ç¬¬1å‘¨ï¼šåŸºç¡€æ¦‚å¿µå’ŒåŸç†ç†è§£
ç¬¬2-3å‘¨ï¼šä¸¤ç§å®ç°æ–¹å¼çš„å®è·µ
ç¬¬4å‘¨ï¼šå®‰å…¨æ§åˆ¶å’Œè¿›åº¦ç›‘æ§
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- æ–‡ä»¶ä¸Šä¼ éœ€ç‰¹æ®Šç¼–ç ï¼Œmultipartæ¥å¸®å¿™
- ä¸¤ç§æ–¹å¼å„æœ‰ä¼˜åŠ¿ï¼ŒæŒ‰éœ€é€‰æ‹©ä¸è¿·èŒ«
- å®‰å…¨æ§åˆ¶æ˜¯é‡ä¸­ä¹‹é‡ï¼ŒéªŒè¯é™åˆ¶æ ·æ ·å…¨
- ç”¨æˆ·ä½“éªŒå¾ˆé‡è¦ï¼Œè¿›åº¦ç›‘æ§ä¸èƒ½å¿˜