---
title: 3、Cookie机制详解
---
## 📚 目录

1. [Cookie基础概念](#1-Cookie基础概念)
2. [Cookie的工作原理](#2-Cookie的工作原理)
3. [Cookie的创建和发送](#3-Cookie的创建和发送)
4. [Cookie属性详解](#4-Cookie属性详解)
5. [Cookie的分类与特性](#5-Cookie的分类与特性)
6. [Cookie安全机制](#6-Cookie安全机制)
7. [Cookie跨域限制](#7-Cookie跨域限制)
8. [实际应用场景](#8-实际应用场景)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🍪 Cookie基础概念


### 1.1 什么是Cookie？


**通俗理解**：Cookie就像是网站给你发的"小纸条"，上面记录着一些信息。每次你再访问这个网站时，浏览器会自动把这个"小纸条"带给网站看，网站就知道你是谁了。

**专业定义**：Cookie是服务器发送给浏览器的小段数据，浏览器会将其存储在本地，并在后续请求中自动携带发送给服务器。

### 1.2 为什么需要Cookie？


**核心问题**：HTTP协议是**无状态**的

```
无状态的意思：
客户端第一次请求 → 服务器响应
客户端第二次请求 → 服务器不知道这是同一个用户！
```

**Cookie解决方案**：
- 🎯 **记住用户身份**：登录状态保持
- 🎯 **个性化服务**：用户偏好设置  
- 🎯 **购物车功能**：商品信息保存
- 🎯 **访问统计**：用户行为分析

### 1.3 Cookie的基本特征


| 特征 | 说明 | 举例 |
|------|------|------|
| **自动携带** | 浏览器自动发送Cookie | 用户无感知操作 |
| **域名绑定** | 只能发送给创建它的域名 | `baidu.com`的Cookie不会发给`google.com` |
| **大小限制** | 单个Cookie最大4KB | 不能存储大量数据 |
| **数量限制** | 每个域名最多几十个Cookie | 避免过度占用资源 |

---

## 2. ⚙️ Cookie的工作原理


### 2.1 Cookie工作流程图


```
第一次访问网站：
浏览器                    服务器
   |                        |
   |--[1]发送请求----------->|
   |   GET /login           |
   |                        |
   |<-[2]响应+设置Cookie-----|
   |   Set-Cookie: id=123   |
   |   Set-Cookie: name=张三 |

第二次访问网站：
浏览器                    服务器
   |                        |
   |--[3]自动携带Cookie----->|
   |   Cookie: id=123;      |
   |   Cookie: name=张三     |
   |                        |
   |<-[4]个性化响应----------|
   |   欢迎回来，张三！      |
```

### 2.2 Cookie存储位置


**浏览器存储机制**：
- 💾 **内存存储**：会话Cookie存在内存中
- 💾 **文件存储**：持久Cookie存在硬盘文件中
- 💾 **加密保护**：敏感Cookie会被加密存储

### 2.3 Cookie发送规则


**自动发送条件**：
- ✅ 访问Cookie所属的域名
- ✅ Cookie尚未过期
- ✅ 路径匹配Cookie设置的path
- ✅ 协议匹配Cookie的secure设置

---

## 3. 🛠️ Cookie的创建和发送


### 3.1 服务器端创建Cookie


**基本语法**：
```java
// 创建Cookie对象
Cookie cookie = new Cookie("键名", "值");

// 通过响应对象发送给浏览器
response.addCookie(cookie);
```

**实际案例**：用户登录后保存用户信息
```java
@WebServlet("/login")
public class LoginServlet extends HttpServlet {
    protected void doPost(HttpServletRequest request, HttpServletResponse response) {
        String username = request.getParameter("username");
        
        // 验证用户登录成功后
        if (验证通过) {
            // 创建保存用户名的Cookie
            Cookie userCookie = new Cookie("username", username);
            
            // 创建保存用户ID的Cookie
            Cookie idCookie = new Cookie("userId", "10086");
            
            // 发送Cookie到浏览器
            response.addCookie(userCookie);
            response.addCookie(idCookie);
            
            // 跳转到首页
            response.sendRedirect("index.jsp");
        }
    }
}
```

### 3.2 浏览器端接收Cookie


**服务器端读取Cookie**：
```java
@WebServlet("/welcome")
public class WelcomeServlet extends HttpServlet {
    protected void doGet(HttpServletRequest request, HttpServletResponse response) {
        // 获取所有Cookie
        Cookie[] cookies = request.getCookies();
        
        String username = null;
        if (cookies != null) {
            for (Cookie cookie : cookies) {
                if ("username".equals(cookie.getName())) {
                    username = cookie.getValue();
                    break;
                }
            }
        }
        
        // 个性化响应
        if (username != null) {
            response.getWriter().println("欢迎回来，" + username + "！");
        } else {
            response.getWriter().println("欢迎访问！");
        }
    }
}
```

### 3.3 Cookie创建的注意事项


> ⚠️ **重要提醒**  
> Cookie的值不能包含空格、分号、逗号等特殊字符，如需存储特殊字符需要进行URL编码

**正确的特殊字符处理**：
```java
// 存储包含空格的值
String value = "张 三";
String encodedValue = URLEncoder.encode(value, "UTF-8");
Cookie cookie = new Cookie("name", encodedValue);

// 读取时解码
String decodedValue = URLDecoder.decode(cookie.getValue(), "UTF-8");
```

---

## 4. 📝 Cookie属性详解


### 4.1 基础属性对比表


| 属性名 | 作用 | 默认值 | 示例设置 |
|--------|------|--------|----------|
| **Name** | Cookie名称 | 必须设置 | `username` |
| **Value** | Cookie值 | 必须设置 | `zhangsan` |
| **Domain** | 有效域名 | 当前域名 | `.example.com` |
| **Path** | 有效路径 | 当前路径 | `/user` |
| **MaxAge** | 存活时间(秒) | -1(会话Cookie) | `3600`(1小时) |
| **Secure** | HTTPS传输 | false | true |
| **HttpOnly** | 仅HTTP访问 | false | true |

### 4.2 MaxAge属性详解


**MaxAge的三种情况**：

```java
Cookie cookie = new Cookie("test", "value");

// 情况1：会话Cookie（浏览器关闭就消失）
cookie.setMaxAge(-1); // 默认值

// 情况2：持久Cookie（指定存活时间）
cookie.setMaxAge(3600); // 存活1小时

// 情况3：立即删除Cookie
cookie.setMaxAge(0); // 马上删除
```

**时间计算示例**：
- `60` = 1分钟
- `3600` = 1小时  
- `86400` = 1天
- `2592000` = 30天

### 4.3 Domain和Path属性


**Domain属性**：控制Cookie能发送给哪些域名

```java
Cookie cookie = new Cookie("user", "zhangsan");

// 只能发送给当前域名
cookie.setDomain("www.example.com");

// 可以发送给主域名及所有子域名
cookie.setDomain(".example.com"); // 注意前面的点
```

**Path属性**：控制Cookie能发送给哪些路径

```java
Cookie cookie = new Cookie("data", "info");

// 只在/admin路径下生效
cookie.setPath("/admin");

// 在整个网站生效
cookie.setPath("/");
```

**实际应用场景**：
- 🏠 **全站Cookie**：`setPath("/")`，如用户登录状态
- 🏢 **特定模块Cookie**：`setPath("/admin")`，如管理员权限

---

## 5. 📋 Cookie的分类与特性


### 5.1 按生存时间分类


**会话Cookie（Session Cookie）**：
```java
// 创建会话Cookie
Cookie sessionCookie = new Cookie("temp", "data");
// 不设置MaxAge，或设置为-1
sessionCookie.setMaxAge(-1);
```

**特点**：
- 🔸 **存储位置**：浏览器内存中
- 🔸 **生存时间**：浏览器关闭就消失
- 🔸 **适用场景**：临时数据，如购物车

**持久Cookie（Persistent Cookie）**：
```java
// 创建持久Cookie
Cookie persistentCookie = new Cookie("remember", "user123");
// 设置存活30天
persistentCookie.setMaxAge(30 * 24 * 3600);
```

**特点**：
- 🔸 **存储位置**：硬盘文件中
- 🔸 **生存时间**：指定时间后过期
- 🔸 **适用场景**：记住登录状态、用户偏好

### 5.2 按安全级别分类


**普通Cookie**：
- ✅ 可通过JavaScript访问
- ✅ HTTP和HTTPS都能传输
- ⚠️ 安全性较低

**安全Cookie**：
- 🔒 设置了Secure和HttpOnly属性
- 🔒 只能HTTPS传输
- 🔒 JavaScript无法访问

### 5.3 Cookie分类对比


| 分类维度 | 会话Cookie | 持久Cookie |
|----------|------------|------------|
| **存储位置** | 内存 | 硬盘文件 |
| **生存时间** | 浏览器会话期间 | 指定时间 |
| **设置方式** | `MaxAge=-1`或不设置 | `MaxAge>0` |
| **典型用途** | 购物车、临时状态 | 登录状态、用户偏好 |
| **安全考虑** | 相对安全（自动清除） | 需要考虑过期时间 |

---

## 6. 🔒 Cookie安全机制


### 6.1 HttpOnly属性


**作用**：防止JavaScript访问Cookie，预防XSS攻击

```java
Cookie safeCookie = new Cookie("sessionId", "abc123");
// 设置HttpOnly，JavaScript无法读取此Cookie
safeCookie.setHttpOnly(true);
response.addCookie(safeCookie);
```

**安全对比**：
```javascript
// 普通Cookie：JavaScript可以访问
document.cookie; // 可以看到所有非HttpOnly的Cookie

// HttpOnly Cookie：JavaScript无法访问
// 恶意脚本无法窃取重要的会话Cookie
```

### 6.2 Secure属性


**作用**：只允许在HTTPS连接中传输Cookie

```java
Cookie secureCookie = new Cookie("token", "xyz789");
// 只在HTTPS连接中发送
secureCookie.setSecure(true);
response.addCookie(secureCookie);
```

**传输协议对比**：

| 协议 | Secure=false | Secure=true |
|------|--------------|-------------|
| **HTTP** | ✅ 可以传输 | ❌ 不传输 |
| **HTTPS** | ✅ 可以传输 | ✅ 可以传输 |

### 6.3 安全最佳实践


**敏感Cookie的安全设置**：
```java
// 创建存储用户会话的安全Cookie
Cookie sessionCookie = new Cookie("JSESSIONID", sessionId);

// 安全属性组合设置
sessionCookie.setHttpOnly(true);  // 防XSS攻击
sessionCookie.setSecure(true);    // 仅HTTPS传输
sessionCookie.setPath("/");       // 全站有效
sessionCookie.setMaxAge(1800);    // 30分钟过期

response.addCookie(sessionCookie);
```

**安全等级划分**：
- 🔴 **高安全**：`HttpOnly + Secure + 短过期时间`
- 🟡 **中安全**：`HttpOnly + 适中过期时间`  
- 🟢 **低安全**：普通设置，用于非敏感数据

---

## 7. 🌐 Cookie跨域限制


### 7.1 同源策略基础


**同源定义**：协议、域名、端口完全相同

```
同源示例：
https://www.example.com:443/page1
https://www.example.com:443/page2
↑ 这两个URL是同源的

跨域示例：
https://www.example.com    (HTTPS)
http://www.example.com     (HTTP) → 协议不同
https://sub.example.com    → 子域名不同  
https://www.example.com:8080 → 端口不同
```

### 7.2 Cookie的域名限制


**基本规则**：Cookie只能发送给设置它的域名

```java
// 在 www.siteA.com 设置的Cookie
Cookie cookie = new Cookie("data", "value");
// 这个Cookie只会发送给 www.siteA.com
// 不会发送给 www.siteB.com
```

**子域名共享设置**：
```java
// 主域名设置Cookie，子域名可以访问
Cookie sharedCookie = new Cookie("shared", "data");
sharedCookie.setDomain(".example.com"); // 注意前面的点

// 以下域名都可以接收到这个Cookie：
// - www.example.com
// - api.example.com  
// - admin.example.com
```

### 7.3 跨域限制的实际影响


**限制场景示例**：

| 场景 | 结果 | 原因 |
|------|------|------|
| 从`a.com`访问`b.com` | ❌ Cookie不会发送 | 不同域名 |
| 从`www.a.com`访问`api.a.com` | ❌ Cookie不会发送 | 子域名不同 |
| 设置`Domain=.a.com`后 | ✅ Cookie可以共享 | 明确允许子域名共享 |

**解决跨域Cookie的方法**：
1. **子域名共享**：设置Domain为主域名
2. **代理转发**：通过同域名的代理接口
3. **CORS配置**：配置跨域资源共享（高级话题）

---

## 8. 🎯 实际应用场景


### 8.1 用户登录状态保持


**需求**：用户登录后，关闭浏览器再打开网站时仍保持登录状态

```java
// 登录成功后设置记住登录Cookie
@WebServlet("/login")
public class LoginServlet extends HttpServlet {
    protected void doPost(HttpServletRequest request, HttpServletResponse response) {
        String username = request.getParameter("username");
        String rememberMe = request.getParameter("rememberMe");
        
        if (验证登录成功) {
            Cookie loginCookie = new Cookie("loginUser", username);
            
            if ("true".equals(rememberMe)) {
                // 记住我：设置7天过期
                loginCookie.setMaxAge(7 * 24 * 3600);
            } else {
                // 不记住：会话Cookie
                loginCookie.setMaxAge(-1);
            }
            
            loginCookie.setHttpOnly(true);
            response.addCookie(loginCookie);
        }
    }
}
```

### 8.2 购物车功能实现


**需求**：用户未登录时也能使用购物车，数据临时保存

```java
// 添加商品到购物车
@WebServlet("/addCart")
public class AddCartServlet extends HttpServlet {
    protected void doPost(HttpServletRequest request, HttpServletResponse response) {
        String productId = request.getParameter("productId");
        
        // 获取现有购物车Cookie
        String cartData = "";
        Cookie[] cookies = request.getCookies();
        if (cookies != null) {
            for (Cookie cookie : cookies) {
                if ("cart".equals(cookie.getName())) {
                    cartData = cookie.getValue();
                    break;
                }
            }
        }
        
        // 添加新商品（简化处理）
        if (!cartData.isEmpty()) {
            cartData += "," + productId;
        } else {
            cartData = productId;
        }
        
        // 更新购物车Cookie
        Cookie cartCookie = new Cookie("cart", cartData);
        cartCookie.setMaxAge(24 * 3600); // 1天有效
        cartCookie.setPath("/");
        response.addCookie(cartCookie);
    }
}
```

### 8.3 用户偏好设置


**需求**：记住用户的界面偏好，如主题、语言等

```java
// 保存用户偏好
@WebServlet("/savePreference")
public class PreferenceServlet extends HttpServlet {
    protected void doPost(HttpServletRequest request, HttpServletResponse response) {
        String theme = request.getParameter("theme"); // dark 或 light
        String language = request.getParameter("lang"); // zh 或 en
        
        // 保存主题偏好
        Cookie themeCookie = new Cookie("theme", theme);
        themeCookie.setMaxAge(365 * 24 * 3600); // 1年有效
        themeCookie.setPath("/");
        
        // 保存语言偏好  
        Cookie langCookie = new Cookie("language", language);
        langCookie.setMaxAge(365 * 24 * 3600); // 1年有效
        langCookie.setPath("/");
        
        response.addCookie(themeCookie);
        response.addCookie(langCookie);
    }
}
```

### 8.4 应用场景总结


| 应用场景 | Cookie类型 | 过期时间 | 安全设置 |
|----------|------------|----------|----------|
| **登录状态** | 持久Cookie | 7-30天 | `HttpOnly + Secure` |
| **购物车** | 会话/短期Cookie | 1-7天 | 普通设置 |
| **用户偏好** | 长期Cookie | 1年 | 普通设置 |
| **访问统计** | 长期Cookie | 2年 | 普通设置 |

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的核心概念


```
🔸 Cookie本质：服务器发给浏览器的小数据片段，用于状态保持
🔸 工作原理：服务器设置Cookie → 浏览器存储 → 后续请求自动携带
🔸 基本操作：new Cookie() → response.addCookie() → request.getCookies()
🔸 重要属性：MaxAge(过期时间)、Domain(域名)、Path(路径)、HttpOnly(安全)
🔸 安全机制：HttpOnly防XSS、Secure要求HTTPS、跨域限制保护
```

### 9.2 关键理解要点


**🔹 Cookie与会话的关系**
```
HTTP无状态 → 需要状态保持 → Cookie提供解决方案
会话Cookie：临时状态，浏览器关闭就消失
持久Cookie：长期状态，指定时间后过期
```

**🔹 安全性的重要性**
```
敏感信息Cookie必须设置：
- HttpOnly：防止JavaScript窃取
- Secure：仅在HTTPS中传输
- 合理的过期时间：降低被盗用风险
```

**🔹 跨域限制的合理性**
```
同源策略保护用户隐私和安全：
- Cookie只发送给设置它的域名
- 子域名需要明确设置Domain才能共享
- 防止恶意网站窃取其他网站的Cookie
```

### 9.3 实际应用指导


**Cookie使用最佳实践**：
- ✅ **敏感数据**：使用Session而不是Cookie直接存储
- ✅ **用户体验**：合理设置过期时间
- ✅ **安全防护**：重要Cookie必须设置HttpOnly和Secure
- ✅ **存储限制**：单个Cookie不超过4KB，总数不超过50个

**常见应用模式**：
- 🏠 **登录状态**：Cookie存储用户标识，服务器验证
- 🛒 **购物车**：临时数据用会话Cookie，持久需求用短期Cookie
- ⚙️ **用户偏好**：界面设置用长期Cookie
- 📊 **访问统计**：匿名标识用长期Cookie

### 9.4 核心记忆要点


> 💡 **记忆口诀**  
> Cookie像纸条记状态，服务器发送浏览器带  
> MaxAge设置生存期，HttpOnly安全不可改  
> 跨域限制保安全，同源才能把数据拿

**关键概念对比**：
- **会话Cookie** vs **持久Cookie**：关浏览器消失 vs 定时消失
- **HttpOnly** vs **普通Cookie**：JS无法访问 vs JS可以访问  
- **Secure** vs **普通Cookie**：仅HTTPS传输 vs HTTP/HTTPS都可传输

通过Cookie机制，我们解决了HTTP协议无状态的问题，为Web应用提供了状态保持的基础能力。掌握Cookie的创建、属性设置和安全机制，是开发动态Web应用的重要基础。