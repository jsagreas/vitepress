---
title: 3ã€Servletå®‰å…¨æœºåˆ¶
---
## ğŸ“š ç›®å½•

1. [Webå®‰å…¨åŸºç¡€æ¦‚å¿µ](#1-Webå®‰å…¨åŸºç¡€æ¦‚å¿µ)
2. [HTTPSå®‰å…¨ä¼ è¾“](#2-HTTPSå®‰å…¨ä¼ è¾“)
3. [ç”¨æˆ·è®¤è¯æœºåˆ¶](#3-ç”¨æˆ·è®¤è¯æœºåˆ¶)
4. [è§’è‰²æˆæƒæ§åˆ¶](#4-è§’è‰²æˆæƒæ§åˆ¶)
5. [å¸¸è§æ”»å‡»é˜²æŠ¤](#5-å¸¸è§æ”»å‡»é˜²æŠ¤)
6. [è¾“å…¥éªŒè¯ä¸è¿‡æ»¤](#6-è¾“å…¥éªŒè¯ä¸è¿‡æ»¤)
7. [Servletå®‰å…¨æœ€ä½³å®è·µ](#7-Servletå®‰å…¨æœ€ä½³å®è·µ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ›¡ï¸ Webå®‰å…¨åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Webå®‰å…¨


> **ğŸ’¡ ç®€å•ç†è§£**ï¼šWebå®‰å…¨å°±åƒæ˜¯ç»™ä½ çš„ç½‘ç«™è£…ä¸Šé˜²ç›—é—¨ã€ç›‘æ§å’Œä¿å®‰ï¼Œé˜²æ­¢åäººè¿›æ¥æç ´åæˆ–å·ä¸œè¥¿ã€‚

**Webå®‰å…¨çš„æ ¸å¿ƒç›®æ ‡**ï¼š
- **ä¿å¯†æ€§**ï¼šæ•æ„Ÿä¿¡æ¯ä¸è¢«çªƒå–ï¼ˆæ¯”å¦‚ç”¨æˆ·å¯†ç ï¼‰
- **å®Œæ•´æ€§**ï¼šæ•°æ®ä¸è¢«ç¯¡æ”¹ï¼ˆæ¯”å¦‚è®¢å•é‡‘é¢ä¸è¢«ä¿®æ”¹ï¼‰
- **å¯ç”¨æ€§**ï¼šæœåŠ¡æ­£å¸¸è¿è¡Œä¸è¢«ç ´åï¼ˆç½‘ç«™èƒ½æ­£å¸¸è®¿é—®ï¼‰
- **è®¤è¯æ€§**ï¼šç¡®è®¤ç”¨æˆ·èº«ä»½çš„çœŸå®æ€§ï¼ˆç¡®ä¿æ˜¯æœ¬äººæ“ä½œï¼‰

### 1.2 Webåº”ç”¨é¢ä¸´çš„ä¸»è¦å¨èƒ


```
å¸¸è§å®‰å…¨å¨èƒä¸€è§ˆï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ•°æ®æ³„éœ²   â”‚    â”‚   èº«ä»½ä¼ªé€    â”‚    â”‚   æœåŠ¡ä¸­æ–­   â”‚
â”‚ â€¢ ç”¨æˆ·ä¿¡æ¯   â”‚    â”‚ â€¢ è´¦å·ç›—ç”¨   â”‚    â”‚ â€¢ DDoSæ”»å‡»   â”‚
â”‚ â€¢ å•†ä¸šæœºå¯†   â”‚    â”‚ â€¢ æƒé™æå‡   â”‚    â”‚ â€¢ ç³»ç»Ÿå´©æºƒ   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“                     â†“                     â†“
   æœºå¯†æ€§é£é™©           å®Œæ•´æ€§é£é™©           å¯ç”¨æ€§é£é™©
```

**ä¸ºä»€ä¹ˆWebåº”ç”¨å®¹æ˜“å—æ”»å‡»**ï¼š
- **å¼€æ”¾æ€§**ï¼šé€šè¿‡äº’è”ç½‘å¯¹å¤–å¼€æ”¾ï¼Œä»»ä½•äººéƒ½èƒ½è®¿é—®
- **å¤æ‚æ€§**ï¼šæ¶‰åŠå¤šä¸ªæŠ€æœ¯å±‚æ¬¡ï¼Œä»»ä½•ä¸€å±‚å‡ºé—®é¢˜éƒ½å¯èƒ½è¢«æ”»å‡»
- **äº¤äº’æ€§**ï¼šéœ€è¦å¤„ç†ç”¨æˆ·è¾“å…¥ï¼Œæ¶æ„è¾“å…¥å¯èƒ½é€ æˆå±å®³

---

## 2. ğŸ”’ HTTPSå®‰å…¨ä¼ è¾“


### 2.1 HTTP vs HTTPSçš„åŒºåˆ«


> **ğŸ’­ ç”Ÿæ´»ç±»æ¯”**ï¼šHTTPå°±åƒå¯„æ˜ä¿¡ç‰‡ï¼Œæ‰€æœ‰äººéƒ½èƒ½çœ‹åˆ°å†…å®¹ï¼›HTTPSå°±åƒå¯„å¯†å°ä¿¡ä»¶ï¼Œåªæœ‰æ”¶ä¿¡äººèƒ½çœ‹åˆ°å†…å®¹ã€‚

```
HTTPä¼ è¾“è¿‡ç¨‹ï¼š
å®¢æˆ·ç«¯ â”€â”€[æ˜æ–‡æ•°æ®]â”€â”€â†’ æœåŠ¡å™¨
       â†â”€[æ˜æ–‡æ•°æ®]â”€â”€â”€

HTTPSä¼ è¾“è¿‡ç¨‹ï¼š
å®¢æˆ·ç«¯ â”€â”€[åŠ å¯†æ•°æ®]â”€â”€â†’ æœåŠ¡å™¨
       â†â”€[åŠ å¯†æ•°æ®]â”€â”€â”€
```

**HTTPSçš„æ ¸å¿ƒä½œç”¨**ï¼š
- **åŠ å¯†ä¼ è¾“**ï¼šæ•°æ®åœ¨ç½‘ç»œä¸­ä»¥åŠ å¯†å½¢å¼ä¼ è¾“
- **èº«ä»½éªŒè¯**ï¼šç¡®è®¤æœåŠ¡å™¨èº«ä»½çš„çœŸå®æ€§
- **æ•°æ®å®Œæ•´æ€§**ï¼šé˜²æ­¢æ•°æ®åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­è¢«ç¯¡æ”¹

### 2.2 åœ¨Servletä¸­é…ç½®HTTPS


**æ­¥éª¤1ï¼šç”ŸæˆSSLè¯ä¹¦**
```bash
# ç”Ÿæˆè‡ªç­¾åè¯ä¹¦ï¼ˆä»…ç”¨äºæµ‹è¯•ï¼‰
keytool -genkey -alias tomcat -keyalg RSA -keystore keystore.jks
```

**æ­¥éª¤2ï¼šé…ç½®Tomcatæ”¯æŒHTTPS**

åœ¨`server.xml`ä¸­æ·»åŠ HTTPSè¿æ¥å™¨ï¼š
```xml
<Connector port="8443" protocol="HTTP/1.1" SSLEnabled="true"
           maxThreads="150" scheme="https" secure="true"
           keystoreFile="conf/keystore.jks" 
           keystorePass="your_password"
           clientAuth="false" sslProtocol="TLS" />
```

**æ­¥éª¤3ï¼šå¼ºåˆ¶HTTPSè®¿é—®**

åœ¨`web.xml`ä¸­é…ç½®ï¼š
```xml
<security-constraint>
    <web-resource-collection>
        <web-resource-name>Protected Area</web-resource-name>
        <url-pattern>/*</url-pattern>
    </web-resource-collection>
    <user-data-constraint>
        <transport-guarantee>CONFIDENTIAL</transport-guarantee>
    </user-data-constraint>
</security-constraint>
```

> **ğŸ“Œ é‡è¦æé†’**ï¼šç”Ÿäº§ç¯å¢ƒåº”è¯¥ä½¿ç”¨æƒå¨CAæœºæ„ç­¾å‘çš„è¯ä¹¦ï¼Œä¸è¦ä½¿ç”¨è‡ªç­¾åè¯ä¹¦ã€‚

---

## 3. ğŸ‘¤ ç”¨æˆ·è®¤è¯æœºåˆ¶


### 3.1 ä»€ä¹ˆæ˜¯ç”¨æˆ·è®¤è¯


> **ğŸ’­ ç”Ÿæ´»ç±»æ¯”**ï¼šè®¤è¯å°±åƒè¿›å…¥å…¬å¸å¤§æ¥¼æ—¶åˆ·å·¥å¡ï¼Œç³»ç»Ÿéœ€è¦ç¡®è®¤"ä½ æ˜¯è°"ã€‚

**è®¤è¯çš„æœ¬è´¨**ï¼šéªŒè¯ç”¨æˆ·å£°ç§°çš„èº«ä»½æ˜¯å¦çœŸå®

**å¸¸è§è®¤è¯æ–¹å¼å¯¹æ¯”**ï¼š

| è®¤è¯æ–¹å¼ | **ä¼˜ç‚¹** | **ç¼ºç‚¹** | **é€‚ç”¨åœºæ™¯** |
|---------|---------|---------|-------------|
| åŸºç¡€è®¤è¯ | ç®€å•æ˜“å®ç° | å®‰å…¨æ€§è¾ƒä½ | ç®€å•å†…éƒ¨ç³»ç»Ÿ |
| è¡¨å•è®¤è¯ | ç”¨æˆ·ä½“éªŒå¥½ | éœ€è¦ä¼šè¯ç®¡ç† | å¤§å¤šæ•°Webåº”ç”¨ |
| æ‘˜è¦è®¤è¯ | å¯†ç ä¸æ˜æ–‡ä¼ è¾“ | å®ç°å¤æ‚ | å¯¹å®‰å…¨æœ‰è¦æ±‚çš„ç³»ç»Ÿ |
| Tokenè®¤è¯ | æ— çŠ¶æ€ã€å¯æ‰©å±• | éœ€è¦é¢å¤–å­˜å‚¨ | RESTful API |

### 3.2 åŸºäºSessionçš„è¡¨å•è®¤è¯å®ç°


**ç™»å½•Servletç¤ºä¾‹**ï¼š
```java
@WebServlet("/login")
public class LoginServlet extends HttpServlet {
    
    protected void doPost(HttpServletRequest request, 
                         HttpServletResponse response) throws ServletException, IOException {
        
        String username = request.getParameter("username");
        String password = request.getParameter("password");
        
        // éªŒè¯ç”¨æˆ·èº«ä»½
        if (validateUser(username, password)) {
            // åˆ›å»ºä¼šè¯å¹¶å­˜å‚¨ç”¨æˆ·ä¿¡æ¯
            HttpSession session = request.getSession();
            session.setAttribute("user", username);
            session.setAttribute("loginTime", new Date());
            
            response.sendRedirect("dashboard.jsp");
        } else {
            request.setAttribute("error", "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
            request.getRequestDispatcher("login.jsp").forward(request, response);
        }
    }
    
    private boolean validateUser(String username, String password) {
        // è¿™é‡Œåº”è¯¥æŸ¥è¯¢æ•°æ®åº“éªŒè¯ç”¨æˆ·
        // å¯†ç åº”è¯¥åŠ å¯†å­˜å‚¨å’Œæ¯”è¾ƒ
        return "admin".equals(username) && "123456".equals(password);
    }
}
```

**ç™»å½•æ£€æŸ¥è¿‡æ»¤å™¨**ï¼š
```java
@WebFilter("/*")
public class AuthenticationFilter implements Filter {
    
    public void doFilter(ServletRequest request, ServletResponse response, 
                        FilterChain chain) throws IOException, ServletException {
        
        HttpServletRequest req = (HttpServletRequest) request;
        HttpServletResponse resp = (HttpServletResponse) response;
        
        String path = req.getRequestURI();
        
        // å…è®¸è®¿é—®ç™»å½•é¡µé¢å’Œé™æ€èµ„æº
        if (path.endsWith("login.jsp") || path.endsWith("login") || 
            path.contains("/css/") || path.contains("/js/")) {
            chain.doFilter(request, response);
            return;
        }
        
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
        HttpSession session = req.getSession(false);
        if (session == null || session.getAttribute("user") == null) {
            resp.sendRedirect("login.jsp");
            return;
        }
        
        chain.doFilter(request, response);
    }
}
```

> **ğŸ” æ·±å…¥ç†è§£**ï¼šSessionè®¤è¯çš„å…³é”®æ˜¯åœ¨æœåŠ¡å™¨ç«¯å­˜å‚¨ç”¨æˆ·çŠ¶æ€ï¼Œé€šè¿‡SessionIDå…³è”å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯çš„ä¼šè¯ä¿¡æ¯ã€‚

---

## 4. ğŸ” è§’è‰²æˆæƒæ§åˆ¶


### 4.1 è®¤è¯ vs æˆæƒ


> **ğŸ’­ ç”Ÿæ´»ç±»æ¯”**ï¼š
> - **è®¤è¯**ï¼šç¡®è®¤ä½ æ˜¯å¼ ä¸‰ï¼ˆèº«ä»½éªŒè¯ï¼‰
> - **æˆæƒ**ï¼šç¡®è®¤å¼ ä¸‰å¯ä»¥è¿›å…¥è´¢åŠ¡å®¤ï¼ˆæƒé™æ£€æŸ¥ï¼‰

```
ç”¨æˆ·è®¿é—®æµç¨‹ï¼š
ç”¨æˆ·è¯·æ±‚ â†’ èº«ä»½è®¤è¯ â†’ æƒé™æˆæƒ â†’ èµ„æºè®¿é—®
    â†“          â†“          â†“          â†“
  è°åœ¨è®¿é—®   ç¡®è®¤èº«ä»½   æ£€æŸ¥æƒé™   å…è®¸è®¿é—®
```

### 4.2 åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰


**RBACæ ¸å¿ƒæ¦‚å¿µ**ï¼š
- **ç”¨æˆ·ï¼ˆUserï¼‰**ï¼šç³»ç»Ÿä½¿ç”¨è€…
- **è§’è‰²ï¼ˆRoleï¼‰**ï¼šæƒé™çš„é›†åˆï¼Œå¦‚ç®¡ç†å‘˜ã€æ™®é€šç”¨æˆ·
- **æƒé™ï¼ˆPermissionï¼‰**ï¼šå¯¹èµ„æºçš„æ“ä½œæƒé™ï¼Œå¦‚è¯»å–ã€ä¿®æ”¹ã€åˆ é™¤

```
RBACæ¨¡å‹ç»“æ„ï¼š
ç”¨æˆ· â†â†’ è§’è‰² â†â†’ æƒé™ â†â†’ èµ„æº
å¼ ä¸‰ â†â†’ ç®¡ç†å‘˜ â†â†’ åˆ é™¤æƒé™ â†â†’ ç”¨æˆ·æ•°æ®
æå›› â†â†’ æ™®é€šç”¨æˆ· â†â†’ æŸ¥çœ‹æƒé™ â†â†’ ä¸ªäººèµ„æ–™
```

### 4.3 åœ¨Servletä¸­å®ç°è§’è‰²æ§åˆ¶


**è§’è‰²æ£€æŸ¥æ³¨è§£**ï¼š
```java
// è‡ªå®šä¹‰è§’è‰²æ£€æŸ¥æ³¨è§£
@Target({ElementType.TYPE, ElementType.METHOD})
@Retention(RetentionPolicy.RUNTIME)
public @interface RequireRole {
    String[] value();
}
```

**ç®¡ç†å‘˜åŠŸèƒ½Servlet**ï¼š
```java
@WebServlet("/admin/users")
@RequireRole({"admin"})
public class UserManagementServlet extends HttpServlet {
    
    protected void doGet(HttpServletRequest request, 
                        HttpServletResponse response) throws ServletException, IOException {
        
        // è·å–æ‰€æœ‰ç”¨æˆ·åˆ—è¡¨
        List<User> users = userService.getAllUsers();
        request.setAttribute("users", users);
        request.getRequestDispatcher("/admin/users.jsp").forward(request, response);
    }
}
```

**è§’è‰²æˆæƒè¿‡æ»¤å™¨**ï¼š
```java
@WebFilter("/*")
public class AuthorizationFilter implements Filter {
    
    public void doFilter(ServletRequest request, ServletResponse response, 
                        FilterChain chain) throws IOException, ServletException {
        
        HttpServletRequest req = (HttpServletRequest) request;
        HttpServletResponse resp = (HttpServletResponse) response;
        
        // è·å–å½“å‰ç”¨æˆ·è§’è‰²
        HttpSession session = req.getSession(false);
        String userRole = (String) session.getAttribute("userRole");
        
        String path = req.getRequestURI();
        
        // æ£€æŸ¥ç®¡ç†å‘˜é¡µé¢è®¿é—®æƒé™
        if (path.startsWith("/admin/") && !"admin".equals(userRole)) {
            resp.sendError(HttpServletResponse.SC_FORBIDDEN, "æƒé™ä¸è¶³");
            return;
        }
        
        chain.doFilter(request, response);
    }
}
```

> **ğŸ“‹ æƒé™è®¾è®¡åŸåˆ™**
> - [ ] æœ€å°æƒé™åŸåˆ™ï¼šç”¨æˆ·åªæ‹¥æœ‰å®Œæˆå·¥ä½œæ‰€éœ€çš„æœ€å°æƒé™
> - [ ] æƒé™åˆ†ç¦»ï¼šæ•æ„Ÿæ“ä½œéœ€è¦å¤šé‡éªŒè¯
> - [ ] æƒé™å®¡è®¡ï¼šè®°å½•æ‰€æœ‰æƒé™ç›¸å…³çš„æ“ä½œ

---

## 5. ğŸš¨ å¸¸è§æ”»å‡»é˜²æŠ¤


### 5.1 SQLæ³¨å…¥æ”»å‡»é˜²æŠ¤


> **ğŸ’­ ç”Ÿæ´»ç±»æ¯”**ï¼šSQLæ³¨å…¥å°±åƒåœ¨å¡«å†™è¡¨æ ¼æ—¶ï¼Œæ¶æ„å¡«å…¥ä¸€äº›ç‰¹æ®Šå†…å®¹ï¼Œè®©ç³»ç»Ÿæ‰§è¡Œäº†ä¸è¯¥æ‰§è¡Œçš„æ“ä½œã€‚

**SQLæ³¨å…¥æ”»å‡»ç¤ºä¾‹**ï¼š
```sql
-- æ­£å¸¸æŸ¥è¯¢
SELECT * FROM users WHERE username = 'admin' AND password = '123456';

-- æ¶æ„è¾“å…¥ï¼šç”¨æˆ·åè¾“å…¥ admin'; DROP TABLE users; --
-- å¯¼è‡´çš„SQLï¼š
SELECT * FROM users WHERE username = 'admin'; DROP TABLE users; --' AND password = '123456';
```

**é˜²æŠ¤æ–¹æ³•1ï¼šä½¿ç”¨PreparedStatement**
```java
public class UserDao {
    
    // âŒ é”™è¯¯åšæ³•ï¼šç›´æ¥æ‹¼æ¥SQL
    public User loginUnsafe(String username, String password) {
        String sql = "SELECT * FROM users WHERE username = '" + username + 
                    "' AND password = '" + password + "'";
        // å­˜åœ¨SQLæ³¨å…¥é£é™©
    }
    
    // âœ… æ­£ç¡®åšæ³•ï¼šä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
    public User loginSafe(String username, String password) {
        String sql = "SELECT * FROM users WHERE username = ? AND password = ?";
        try (PreparedStatement ps = connection.prepareStatement(sql)) {
            ps.setString(1, username);
            ps.setString(2, password);
            ResultSet rs = ps.executeQuery();
            // å®‰å…¨çš„æ•°æ®åº“æŸ¥è¯¢
        }
    }
}
```

### 5.2 XSSæ”»å‡»é˜²æŠ¤


> **ğŸ’­ ç”Ÿæ´»ç±»æ¯”**ï¼šXSSå°±åƒåœ¨ç•™è¨€æ¿ä¸Šå†™æ¶æ„ä»£ç ï¼Œå½“åˆ«äººçœ‹åˆ°ç•™è¨€æ—¶ï¼Œæ¶æ„ä»£ç å°±åœ¨ä»–ä»¬çš„æµè§ˆå™¨ä¸­æ‰§è¡Œã€‚

**XSSæ”»å‡»ç±»å‹**ï¼š
- **åå°„å‹XSS**ï¼šæ¶æ„è„šæœ¬é€šè¿‡URLå‚æ•°ä¼ å…¥
- **å­˜å‚¨å‹XSS**ï¼šæ¶æ„è„šæœ¬å­˜å‚¨åœ¨æ•°æ®åº“ä¸­
- **DOMå‹XSS**ï¼šé€šè¿‡JavaScriptåŠ¨æ€ä¿®æ”¹é¡µé¢å†…å®¹

**é˜²æŠ¤æ–¹æ³•**ï¼š
```java
public class XSSUtils {
    
    // HTMLç‰¹æ®Šå­—ç¬¦è½¬ä¹‰
    public static String escapeHtml(String input) {
        if (input == null) return "";
        
        return input.replace("&", "&amp;")
                   .replace("<", "&lt;")
                   .replace(">", "&gt;")
                   .replace("\"", "&quot;")
                   .replace("'", "&#x27;");
    }
    
    // ç§»é™¤HTMLæ ‡ç­¾
    public static String stripHtml(String input) {
        if (input == null) return "";
        return input.replaceAll("<[^>]*>", "");
    }
}

@WebServlet("/comment")
public class CommentServlet extends HttpServlet {
    
    protected void doPost(HttpServletRequest request, 
                         HttpServletResponse response) throws ServletException, IOException {
        
        String comment = request.getParameter("comment");
        
        // å¯¹ç”¨æˆ·è¾“å…¥è¿›è¡Œè½¬ä¹‰
        String safeComment = XSSUtils.escapeHtml(comment);
        
        // å­˜å‚¨åˆ°æ•°æ®åº“
        commentDao.save(safeComment);
        
        response.sendRedirect("comments.jsp");
    }
}
```

### 5.3 CSRFæ”»å‡»é˜²æŠ¤


> **ğŸ’­ ç”Ÿæ´»ç±»æ¯”**ï¼šCSRFå°±åƒæœ‰äººå†’å……ä½ çš„èº«ä»½ï¼Œåœ¨ä½ ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹æ‰§è¡Œäº†ä¸€äº›æ“ä½œã€‚

**CSRFé˜²æŠ¤ï¼šä½¿ç”¨TokenéªŒè¯**
```java
@WebServlet("/transfer")
public class TransferServlet extends HttpServlet {
    
    protected void doGet(HttpServletRequest request, 
                        HttpServletResponse response) throws ServletException, IOException {
        
        // ç”ŸæˆCSRF Token
        String csrfToken = UUID.randomUUID().toString();
        HttpSession session = request.getSession();
        session.setAttribute("csrfToken", csrfToken);
        
        request.setAttribute("csrfToken", csrfToken);
        request.getRequestDispatcher("transfer.jsp").forward(request, response);
    }
    
    protected void doPost(HttpServletRequest request, 
                         HttpServletResponse response) throws ServletException, IOException {
        
        // éªŒè¯CSRF Token
        HttpSession session = request.getSession();
        String sessionToken = (String) session.getAttribute("csrfToken");
        String requestToken = request.getParameter("csrfToken");
        
        if (sessionToken == null || !sessionToken.equals(requestToken)) {
            response.sendError(HttpServletResponse.SC_FORBIDDEN, "CSRF TokenéªŒè¯å¤±è´¥");
            return;
        }
        
        // æ‰§è¡Œè½¬è´¦æ“ä½œ
        String amount = request.getParameter("amount");
        String toAccount = request.getParameter("toAccount");
        
        // å¤„ç†è½¬è´¦é€»è¾‘...
    }
}
```

**å¯¹åº”çš„JSPé¡µé¢**ï¼š
```jsp
<form action="transfer" method="post">
    <input type="hidden" name="csrfToken" value="${csrfToken}">
    è½¬è´¦é‡‘é¢ï¼š<input type="text" name="amount">
    æ”¶æ¬¾è´¦æˆ·ï¼š<input type="text" name="toAccount">
    <input type="submit" value="è½¬è´¦">
</form>
```

---

## 6. ğŸ” è¾“å…¥éªŒè¯ä¸è¿‡æ»¤


### 6.1 ä¸ºä»€ä¹ˆéœ€è¦è¾“å…¥éªŒè¯


> **ğŸ” æ·±å…¥ç†è§£**ï¼šä¸è¦ç›¸ä¿¡ä»»ä½•æ¥è‡ªç”¨æˆ·çš„è¾“å…¥ï¼Œæ‰€æœ‰å¤–éƒ¨è¾“å…¥éƒ½å¯èƒ½æ˜¯æ¶æ„çš„ã€‚

**è¾“å…¥éªŒè¯çš„é‡è¦æ€§**ï¼š
- **æ•°æ®è´¨é‡**ï¼šç¡®ä¿æ•°æ®ç¬¦åˆé¢„æœŸæ ¼å¼
- **å®‰å…¨é˜²æŠ¤**ï¼šé˜²æ­¢å„ç§æ³¨å…¥æ”»å‡»
- **ç³»ç»Ÿç¨³å®š**ï¼šé¿å…å¼‚å¸¸æ•°æ®å¯¼è‡´ç³»ç»Ÿé”™è¯¯

### 6.2 è¾“å…¥éªŒè¯æœ€ä½³å®è·µ


**è¾“å…¥éªŒè¯ç­–ç•¥**ï¼š
```
è¾“å…¥éªŒè¯å±‚æ¬¡ï¼š
å®¢æˆ·ç«¯éªŒè¯ â†’ ä¼ è¾“éªŒè¯ â†’ æœåŠ¡å™¨éªŒè¯ â†’ æ•°æ®åº“çº¦æŸ
    â†“           â†“          â†“           â†“
  ç”¨æˆ·ä½“éªŒ    æ•°æ®å®Œæ•´æ€§   å®‰å…¨é˜²æŠ¤    æœ€åé˜²çº¿
```

**æœåŠ¡å™¨ç«¯éªŒè¯å®ç°**ï¼š
```java
public class ValidationUtils {
    
    // é‚®ç®±æ ¼å¼éªŒè¯
    private static final String EMAIL_PATTERN = 
        "^[a-zA-Z0-9_+&*-]+(?:\\.[a-zA-Z0-9_+&*-]+)*@" +
        "(?:[a-zA-Z0-9-]+\\.)+[a-zA-Z]{2,7}$";
    
    private static final Pattern EMAIL_REGEX = Pattern.compile(EMAIL_PATTERN);
    
    public static boolean isValidEmail(String email) {
        return email != null && EMAIL_REGEX.matcher(email).matches();
    }
    
    // å¯†ç å¼ºåº¦éªŒè¯
    public static boolean isValidPassword(String password) {
        if (password == null || password.length() < 8) {
            return false;
        }
        
        boolean hasUpper = password.matches(".*[A-Z].*");
        boolean hasLower = password.matches(".*[a-z].*");
        boolean hasDigit = password.matches(".*\\d.*");
        boolean hasSpecial = password.matches(".*[!@#$%^&*].*");
        
        return hasUpper && hasLower && hasDigit && hasSpecial;
    }
    
    // é•¿åº¦å’Œå†…å®¹éªŒè¯
    public static boolean isValidUsername(String username) {
        if (username == null) return false;
        
        return username.length() >= 3 && username.length() <= 20 &&
               username.matches("^[a-zA-Z0-9_]+$");
    }
}
```

**æ³¨å†Œè¡¨å•éªŒè¯ç¤ºä¾‹**ï¼š
```java
@WebServlet("/register")
public class RegisterServlet extends HttpServlet {
    
    protected void doPost(HttpServletRequest request, 
                         HttpServletResponse response) throws ServletException, IOException {
        
        String username = request.getParameter("username");
        String email = request.getParameter("email");
        String password = request.getParameter("password");
        
        List<String> errors = new ArrayList<>();
        
        // éªŒè¯ç”¨æˆ·å
        if (!ValidationUtils.isValidUsername(username)) {
            errors.add("ç”¨æˆ·åå¿…é¡»æ˜¯3-20ä½å­—æ¯ã€æ•°å­—æˆ–ä¸‹åˆ’çº¿");
        }
        
        // éªŒè¯é‚®ç®±
        if (!ValidationUtils.isValidEmail(email)) {
            errors.add("è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€");
        }
        
        // éªŒè¯å¯†ç 
        if (!ValidationUtils.isValidPassword(password)) {
            errors.add("å¯†ç å¿…é¡»è‡³å°‘8ä½ï¼ŒåŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦");
        }
        
        if (!errors.isEmpty()) {
            request.setAttribute("errors", errors);
            request.setAttribute("username", username);
            request.setAttribute("email", email);
            request.getRequestDispatcher("register.jsp").forward(request, response);
            return;
        }
        
        // éªŒè¯é€šè¿‡ï¼Œå¤„ç†æ³¨å†Œé€»è¾‘
        userService.register(username, email, password);
        response.sendRedirect("login.jsp");
    }
}
```

---

## 7. âœ… Servletå®‰å…¨æœ€ä½³å®è·µ


### 7.1 å¯†ç å®‰å…¨å¤„ç†


> **âš ï¸ é‡è¦æé†’**ï¼šæ°¸è¿œä¸è¦ä»¥æ˜æ–‡å½¢å¼å­˜å‚¨å¯†ç ï¼

**å¯†ç åŠ å¯†å­˜å‚¨**ï¼š
```java
import java.security.MessageDigest;
import java.security.SecureRandom;

public class PasswordUtils {
    
    // ç”Ÿæˆéšæœºç›å€¼
    public static String generateSalt() {
        SecureRandom random = new SecureRandom();
        byte[] salt = new byte[16];
        random.nextBytes(salt);
        return bytesToHex(salt);
    }
    
    // å¯†ç åŠ ç›å“ˆå¸Œ
    public static String hashPassword(String password, String salt) {
        try {
            MessageDigest md = MessageDigest.getInstance("SHA-256");
            md.update(salt.getBytes());
            byte[] hashedPassword = md.digest(password.getBytes());
            return bytesToHex(hashedPassword);
        } catch (Exception e) {
            throw new RuntimeException("å¯†ç åŠ å¯†å¤±è´¥", e);
        }
    }
    
    // éªŒè¯å¯†ç 
    public static boolean verifyPassword(String password, String salt, String hashedPassword) {
        String newHash = hashPassword(password, salt);
        return newHash.equals(hashedPassword);
    }
    
    private static String bytesToHex(byte[] bytes) {
        StringBuilder result = new StringBuilder();
        for (byte b : bytes) {
            result.append(String.format("%02x", b));
        }
        return result.toString();
    }
}
```

### 7.2 ä¼šè¯å®‰å…¨é…ç½®


**Sessionå®‰å…¨é…ç½®**ï¼š
```java
@WebServlet("/login")
public class SecureLoginServlet extends HttpServlet {
    
    protected void doPost(HttpServletRequest request, 
                         HttpServletResponse response) throws ServletException, IOException {
        
        // éªŒè¯ç”¨æˆ·èº«ä»½å
        if (validateUser(username, password)) {
            
            // é”€æ¯æ—§ä¼šè¯ï¼Œé˜²æ­¢ä¼šè¯å›ºå®šæ”»å‡»
            HttpSession oldSession = request.getSession(false);
            if (oldSession != null) {
                oldSession.invalidate();
            }
            
            // åˆ›å»ºæ–°ä¼šè¯
            HttpSession newSession = request.getSession(true);
            newSession.setAttribute("user", username);
            
            // è®¾ç½®ä¼šè¯è¶…æ—¶ï¼ˆ30åˆ†é’Ÿï¼‰
            newSession.setMaxInactiveInterval(30 * 60);
            
            // è®¾ç½®å®‰å…¨Cookieå±æ€§
            Cookie sessionCookie = new Cookie("JSESSIONID", newSession.getId());
            sessionCookie.setHttpOnly(true);  // é˜²æ­¢XSSæ”»å‡»
            sessionCookie.setSecure(true);    // ä»…HTTPSä¼ è¾“
            sessionCookie.setPath("/");
            response.addCookie(sessionCookie);
        }
    }
}
```

### 7.3 å®‰å…¨å“åº”å¤´é…ç½®


**åœ¨è¿‡æ»¤å™¨ä¸­è®¾ç½®å®‰å…¨å“åº”å¤´**ï¼š
```java
@WebFilter("/*")
public class SecurityHeadersFilter implements Filter {
    
    public void doFilter(ServletRequest request, ServletResponse response, 
                        FilterChain chain) throws IOException, ServletException {
        
        HttpServletResponse httpResponse = (HttpServletResponse) response;
        
        // é˜²æ­¢ç‚¹å‡»åŠ«æŒ
        httpResponse.setHeader("X-Frame-Options", "DENY");
        
        // é˜²æ­¢MIMEç±»å‹å—…æ¢
        httpResponse.setHeader("X-Content-Type-Options", "nosniff");
        
        // å¯ç”¨XSSä¿æŠ¤
        httpResponse.setHeader("X-XSS-Protection", "1; mode=block");
        
        // å†…å®¹å®‰å…¨ç­–ç•¥
        httpResponse.setHeader("Content-Security-Policy", 
            "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';");
        
        // å¼ºåˆ¶HTTPS
        httpResponse.setHeader("Strict-Transport-Security", 
            "max-age=31536000; includeSubDomains");
        
        chain.doFilter(request, response);
    }
}
```

### 7.4 é”™è¯¯å¤„ç†ä¸æ—¥å¿—è®°å½•


**å®‰å…¨çš„é”™è¯¯å¤„ç†**ï¼š
```java
@WebServlet("/secure-operation")
public class SecureOperationServlet extends HttpServlet {
    
    private static final Logger logger = LoggerFactory.getLogger(SecureOperationServlet.class);
    
    protected void doPost(HttpServletRequest request, 
                         HttpServletResponse response) throws ServletException, IOException {
        
        try {
            // æ‰§è¡Œæ•æ„Ÿæ“ä½œ
            performSensitiveOperation(request);
            
            // è®°å½•æˆåŠŸæ—¥å¿—
            logger.info("ç”¨æˆ· {} æ‰§è¡Œäº†æ•æ„Ÿæ“ä½œ", request.getSession().getAttribute("user"));
            
        } catch (SecurityException e) {
            // è®°å½•å®‰å…¨å¼‚å¸¸
            logger.warn("å®‰å…¨å¼‚å¸¸: ç”¨æˆ· {} å°è¯•æ‰§è¡Œæœªæˆæƒæ“ä½œ", 
                       request.getSession().getAttribute("user"));
            
            // ä¸æš´éœ²å…·ä½“é”™è¯¯ä¿¡æ¯ç»™ç”¨æˆ·
            response.sendError(HttpServletResponse.SC_FORBIDDEN, "æ“ä½œè¢«æ‹’ç»");
            
        } catch (Exception e) {
            // è®°å½•ç³»ç»Ÿå¼‚å¸¸
            logger.error("ç³»ç»Ÿå¼‚å¸¸", e);
            
            // è¿”å›é€šç”¨é”™è¯¯ä¿¡æ¯
            response.sendError(HttpServletResponse.SC_INTERNAL_SERVER_ERROR, "ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
        }
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„å®‰å…¨æ¦‚å¿µ


```
ğŸ”¸ Webå®‰å…¨ä¸‰è¦ç´ ï¼šä¿å¯†æ€§ã€å®Œæ•´æ€§ã€å¯ç”¨æ€§
ğŸ”¸ HTTPSä¼ è¾“ï¼šåŠ å¯†æ•°æ®ä¼ è¾“ï¼Œé˜²æ­¢çªƒå¬å’Œç¯¡æ”¹
ğŸ”¸ ç”¨æˆ·è®¤è¯ï¼šéªŒè¯ç”¨æˆ·èº«ä»½çš„çœŸå®æ€§
ğŸ”¸ è§’è‰²æˆæƒï¼šæ§åˆ¶ç”¨æˆ·å¯¹èµ„æºçš„è®¿é—®æƒé™
ğŸ”¸ æ”»å‡»é˜²æŠ¤ï¼šé˜²èŒƒSQLæ³¨å…¥ã€XSSã€CSRFç­‰å¸¸è§æ”»å‡»
ğŸ”¸ è¾“å…¥éªŒè¯ï¼šæ°¸è¿œä¸è¦ç›¸ä¿¡ç”¨æˆ·è¾“å…¥
ğŸ”¸ å¯†ç å®‰å…¨ï¼šåŠ ç›å“ˆå¸Œå­˜å‚¨ï¼Œæ°¸ä¸æ˜æ–‡
```

### 8.2 Servletå®‰å…¨å¼€å‘æ£€æŸ¥æ¸…å•


```
ğŸ“‹ **å®‰å…¨å¼€å‘æ£€æŸ¥æ¸…å•**

æ•°æ®ä¼ è¾“å®‰å…¨ï¼š
- [ ] æ•æ„Ÿé¡µé¢å¼ºåˆ¶ä½¿ç”¨HTTPS
- [ ] è®¾ç½®å®‰å…¨çš„Cookieå±æ€§
- [ ] é…ç½®å®‰å…¨å“åº”å¤´

èº«ä»½è®¤è¯æˆæƒï¼š
- [ ] å®ç°åˆé€‚çš„ç”¨æˆ·è®¤è¯æœºåˆ¶
- [ ] åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶
- [ ] ä¼šè¯å®‰å…¨ç®¡ç†å’Œè¶…æ—¶è®¾ç½®

è¾“å…¥è¾“å‡ºå®‰å…¨ï¼š
- [ ] å¯¹æ‰€æœ‰ç”¨æˆ·è¾“å…¥è¿›è¡ŒéªŒè¯
- [ ] ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢é˜²æ­¢SQLæ³¨å…¥
- [ ] å¯¹è¾“å‡ºå†…å®¹è¿›è¡ŒHTMLç¼–ç é˜²æ­¢XSS
- [ ] å®ç°CSRF TokenéªŒè¯

å¯†ç å’Œæ•æ„Ÿä¿¡æ¯ï¼š
- [ ] å¯†ç åŠ ç›å“ˆå¸Œå­˜å‚¨
- [ ] æ•æ„Ÿä¿¡æ¯åŠ å¯†ä¿å­˜
- [ ] ä¸åœ¨æ—¥å¿—ä¸­è®°å½•æ•æ„Ÿä¿¡æ¯

é”™è¯¯å¤„ç†ï¼š
- [ ] ä¸å‘ç”¨æˆ·æš´éœ²ç³»ç»Ÿé”™è¯¯è¯¦æƒ…
- [ ] è®°å½•å®‰å…¨ç›¸å…³çš„æ“ä½œæ—¥å¿—
- [ ] è®¾ç½®åˆé€‚çš„é”™è¯¯é¡µé¢
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ å®‰å…¨å¼€å‘æ€ç»´**ï¼š
- **é˜²å¾¡å¼ç¼–ç¨‹**ï¼šå‡è®¾æ‰€æœ‰è¾“å…¥éƒ½æ˜¯æ¶æ„çš„
- **æœ€å°æƒé™åŸåˆ™**ï¼šç”¨æˆ·åªæ‹¥æœ‰å¿…éœ€çš„æœ€å°æƒé™
- **çºµæ·±é˜²å¾¡**ï¼šå¤šå±‚å®‰å…¨é˜²æŠ¤ï¼Œä¸ä¾èµ–å•ä¸€é˜²æŠ¤æªæ–½
- **å®‰å…¨å®¡è®¡**ï¼šå®šæœŸæ£€æŸ¥å’Œæµ‹è¯•å®‰å…¨æªæ–½

**ğŸ“Š å®‰å…¨æ€§èƒ½å¹³è¡¡**ï¼š
```
å®‰å…¨çº§åˆ« vs æ€§èƒ½å½±å“ï¼š
é«˜å®‰å…¨ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ æ€§èƒ½æŸè€—å¤§
ä¸­å®‰å…¨ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘ æ€§èƒ½æŸè€—ä¸­ç­‰  
ä½å®‰å…¨ â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ æ€§èƒ½æŸè€—å°

å»ºè®®ï¼šæ ¹æ®åº”ç”¨çš„é‡è¦æ€§å’Œæ•æ„Ÿåº¦é€‰æ‹©åˆé€‚çš„å®‰å…¨çº§åˆ«
```

**ğŸš€ æŒç»­å®‰å…¨æ”¹è¿›**ï¼š
- **å®šæœŸæ›´æ–°**ï¼šåŠæ—¶æ›´æ–°æ¡†æ¶å’Œä¾èµ–åº“
- **å®‰å…¨æµ‹è¯•**ï¼šå®šæœŸè¿›è¡Œæ¸—é€æµ‹è¯•å’Œå®‰å…¨æ‰«æ
- **å›¢é˜ŸåŸ¹è®­**ï¼šæé«˜å¼€å‘å›¢é˜Ÿçš„å®‰å…¨æ„è¯†
- **åº”æ€¥é¢„æ¡ˆ**ï¼šåˆ¶å®šå®‰å…¨äº‹ä»¶çš„åº”å¯¹æªæ–½

**æ ¸å¿ƒè®°å¿†**ï¼š
- å®‰å…¨æ˜¯ç³»ç»Ÿå·¥ç¨‹ï¼Œéœ€è¦ä»è®¾è®¡é˜¶æ®µå°±è€ƒè™‘
- ç”¨æˆ·è¾“å…¥æ°¸è¿œä¸å¯ä¿¡ï¼Œå¿…é¡»éªŒè¯å’Œè¿‡æ»¤
- æ•æ„Ÿä¿¡æ¯å¿…é¡»åŠ å¯†ï¼Œå¯†ç å¿…é¡»åŠ ç›å“ˆå¸Œ
- å¤šå±‚é˜²æŠ¤æ¯”å•ä¸€é˜²æŠ¤æ›´å®‰å…¨å¯é 