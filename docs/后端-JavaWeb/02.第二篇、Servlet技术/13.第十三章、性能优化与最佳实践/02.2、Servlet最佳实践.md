---
title: 2ã€Servletæœ€ä½³å®è·µ
---
## ğŸ“š ç›®å½•


1. [Servletæœ€ä½³å®è·µæ¦‚è¿°](#1-servletæœ€ä½³å®è·µæ¦‚è¿°)
2. [ä»£ç è§„èŒƒéµå¾ª](#2-ä»£ç è§„èŒƒéµå¾ª)
3. [å¼‚å¸¸å¤„ç†è§„èŒƒ](#3-å¼‚å¸¸å¤„ç†è§„èŒƒ)
4. [èµ„æºé‡Šæ”¾ç®¡ç†](#4-èµ„æºé‡Šæ”¾ç®¡ç†)
5. [æ—¥å¿—è®°å½•è§„èŒƒ](#5-æ—¥å¿—è®°å½•è§„èŒƒ)
6. [å®‰å…¨ç¼–ç è§„èŒƒ](#6-å®‰å…¨ç¼–ç è§„èŒƒ)
7. [å¯ç»´æŠ¤æ€§è®¾è®¡](#7-å¯ç»´æŠ¤æ€§è®¾è®¡)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

# ğŸ¯ **å­¦ä¹ è·¯å¾„å¯¼èˆª**


**å‰ç½®çŸ¥è¯†**ï¼šéœ€è¦æŒæ¡ServletåŸºç¡€ã€HTTPåè®®ã€JavaåŸºç¡€è¯­æ³• â†’ **å½“å‰å†…å®¹**ï¼šServletæœ€ä½³å®è·µ â†’ **åç»­å­¦ä¹ **ï¼šå»ºè®®å­¦ä¹ Springæ¡†æ¶ã€å¾®æœåŠ¡æ¶æ„

â±ï¸ **é¢„è®¡å­¦ä¹ æ—¶é—´**ï¼šæœ¬ç« é¢„è®¡90åˆ†é’Ÿ | å®è·µç»ƒä¹ 60åˆ†é’Ÿ

ğŸ“‹ **æœ¬ç« å­¦ä¹ ç›®æ ‡**
- [ ] ç†è§£ä»£ç è§„èŒƒçš„é‡è¦æ€§å’Œå®è·µæ–¹æ³•
- [ ] æŒæ¡å¼‚å¸¸å¤„ç†çš„æœ€ä½³å®è·µæ¨¡å¼
- [ ] å­¦ä¼šæ­£ç¡®ç®¡ç†ç³»ç»Ÿèµ„æº
- [ ] äº†è§£å®‰å…¨ç¼–ç çš„åŸºæœ¬è¦æ±‚
- [ ] èƒ½å¤Ÿè®¾è®¡å¯ç»´æŠ¤çš„Servletåº”ç”¨

---

## 1. ğŸŒŸ Servletæœ€ä½³å®è·µæ¦‚è¿°



### 1.1 ä»€ä¹ˆæ˜¯æœ€ä½³å®è·µ



**ğŸ”¸ æ ¸å¿ƒå®šä¹‰**
```
æœ€ä½³å®è·µï¼šç»è¿‡å®é™…é¡¹ç›®éªŒè¯çš„ã€èƒ½å¤Ÿæé«˜ä»£ç è´¨é‡å’Œç³»ç»Ÿç¨³å®šæ€§çš„ç¼–ç¨‹æ–¹æ³•
ç›®æ ‡ï¼šå†™å‡ºé«˜è´¨é‡ã€æ˜“ç»´æŠ¤ã€å®‰å…¨å¯é çš„Servletä»£ç 
æœ¬è´¨ï¼šæŠŠç»éªŒæ€»ç»“æˆè§„åˆ™ï¼Œé¿å…å¸¸è§çš„å‘
```

**ğŸ’¡ é€šä¿—ç†è§£**
å°±åƒå¼€è½¦æœ‰äº¤é€šè§„åˆ™ä¸€æ ·ï¼š
- **æ²¡æœ‰è§„åˆ™**ï¼šè™½ç„¶èƒ½è·‘ï¼Œä½†å®¹æ˜“å‡ºäº‹æ•…
- **éµå®ˆè§„åˆ™**ï¼šå®‰å…¨ç¨³å®šï¼Œåˆ«äººä¹Ÿèƒ½ç†è§£ä½ çš„è¡Œä¸º
- **æœ€ä½³å®è·µ**ï¼šä¸ä»…éµå®ˆè§„åˆ™ï¼Œè¿˜è¦å¼€å¾—åˆå¥½åˆç¨³

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦æœ€ä½³å®è·µ



**ğŸ¯ å®é™…ä»·å€¼å¯¹æ¯”**

| **æ–¹é¢** | **ä¸éµå¾ªæœ€ä½³å®è·µ** | **éµå¾ªæœ€ä½³å®è·µ** |
|---------|-----------------|----------------|
| **ä»£ç è´¨é‡** | æ··ä¹±éš¾æ‡‚ï¼Œbugé¢‘å‡º | æ¸…æ™°è§„èŒƒï¼Œè´¨é‡ç¨³å®š |
| **å›¢é˜Ÿåä½œ** | å„å†™å„çš„ï¼Œéš¾ä»¥åˆä½œ | ç»Ÿä¸€æ ‡å‡†ï¼Œåä½œé¡ºç•… |
| **ç»´æŠ¤æˆæœ¬** | æ”¹ä¸€å¤„åä¸‰å¤„ | æ˜“äºä¿®æ”¹å’Œæ‰©å±• |
| **é¡¹ç›®è¿›åº¦** | è¿”å·¥é¢‘ç¹ï¼Œè¿›åº¦æ‹–å»¶ | ä¸€æ¬¡åšå¯¹ï¼ŒæŒ‰æ—¶äº¤ä»˜ |

### 1.3 æœ€ä½³å®è·µçš„æ ¸å¿ƒåŸåˆ™



**ğŸ“‹ å…­å¤§æ ¸å¿ƒåŸåˆ™**
```
ğŸ”¸ ç®€å•æ€§åŸåˆ™ï¼šèƒ½ç®€å•å°±ä¸å¤æ‚ï¼Œä»£ç è¶Šç®€å•è¶Šä¸å®¹æ˜“å‡ºé”™
ğŸ”¸ ä¸€è‡´æ€§åŸåˆ™ï¼šé¡¹ç›®å†…ä¿æŒç»Ÿä¸€çš„ç¼–ç é£æ ¼å’Œå‘½åè§„èŒƒ
ğŸ”¸ å®‰å…¨æ€§åŸåˆ™ï¼šä»è®¾è®¡é˜¶æ®µå°±è€ƒè™‘å®‰å…¨é˜²æŠ¤
ğŸ”¸ å¯è¯»æ€§åŸåˆ™ï¼šä»£ç è¦è®©å…¶ä»–äººèƒ½å¤Ÿå¿«é€Ÿç†è§£
ğŸ”¸ å¯æµ‹è¯•åŸåˆ™ï¼šä»£ç ç»“æ„è¦ä¾¿äºç¼–å†™å’Œæ‰§è¡Œæµ‹è¯•
ğŸ”¸ å¯ç»´æŠ¤åŸåˆ™ï¼šè€ƒè™‘æœªæ¥çš„ä¿®æ”¹å’Œæ‰©å±•éœ€æ±‚
```

---

## 2. ğŸ“ ä»£ç è§„èŒƒéµå¾ª



### 2.1 å‘½åè§„èŒƒ



**ğŸ·ï¸ ç»Ÿä¸€å‘½åæ ‡å‡†**

**ç±»åè§„èŒƒ**
```java
// âœ… æ¨èï¼šä½¿ç”¨æœ‰æ„ä¹‰çš„åç§°ï¼Œé¦–å­—æ¯å¤§å†™
public class UserLoginServlet extends HttpServlet
public class ProductSearchServlet extends HttpServlet
public class OrderManagementServlet extends HttpServlet

// âŒ é¿å…ï¼šç¼©å†™ã€æ— æ„ä¹‰å‘½å
public class ULS extends HttpServlet  // ä¸çŸ¥é“æ˜¯ä»€ä¹ˆ
public class MyServlet extends HttpServlet  // å¤ªæ¨¡ç³Š
public class Servlet1 extends HttpServlet   // æ²¡æœ‰æ„ä¹‰
```

**æ–¹æ³•åè§„èŒƒ**
```java
// âœ… æ¨èï¼šåŠ¨è¯å¼€å¤´ï¼Œæè¿°å…·ä½“åŠŸèƒ½
protected void processUserLogin(HttpServletRequest request, ...)
protected void validateUserInput(String username, String password)
protected void sendWelcomeEmail(User user)

// âŒ é¿å…ï¼šæ¨¡ç³Šã€æ‹¼å†™é”™è¯¯
protected void doStuff(HttpServletRequest request, ...)
protected void prosessLogin(...)  // æ‹¼å†™é”™è¯¯
protected void handle(...)        // å¤ªæ¨¡ç³Š
```

**å˜é‡å‘½åè§„èŒƒ**
```java
// âœ… æ¨èï¼šé©¼å³°å‘½åï¼Œæ„ä¹‰æ˜ç¡®
String userName = request.getParameter("username");
int maxRetryCount = 3;
boolean isValidUser = false;
List<Product> productList = new ArrayList<>();

// âŒ é¿å…ï¼šå•å­—æ¯ã€æ— æ„ä¹‰å‘½å
String s = request.getParameter("username");  // ä¸çŸ¥é“sæ˜¯ä»€ä¹ˆ
int n = 3;  // nä»£è¡¨ä»€ä¹ˆï¼Ÿ
boolean flag = false;  // flagè¡¨ç¤ºä»€ä¹ˆçŠ¶æ€ï¼Ÿ
```

### 2.2 ä»£ç ç»“æ„è§„èŒƒ



**ğŸ“ æ ‡å‡†Servletç»“æ„æ¨¡æ¿**
```java
@WebServlet("/user/login")
public class UserLoginServlet extends HttpServlet {
    
    // 1. å¸¸é‡å®šä¹‰åŒº
    private static final String LOGIN_PAGE = "/login.jsp";
    private static final String SUCCESS_PAGE = "/dashboard.jsp";
    private static final int MAX_LOGIN_ATTEMPTS = 3;
    
    // 2. ä¾èµ–æ³¨å…¥åŒºï¼ˆå¦‚æœä½¿ç”¨æ¡†æ¶ï¼‰
    private UserService userService;
    
    // 3. åˆå§‹åŒ–æ–¹æ³•
    @Override
    public void init() throws ServletException {
        // åˆå§‹åŒ–æœåŠ¡å¯¹è±¡
        userService = new UserServiceImpl();
    }
    
    // 4. è¯·æ±‚å¤„ç†æ–¹æ³•
    @Override
    protected void doPost(HttpServletRequest request, 
                         HttpServletResponse response) 
            throws ServletException, IOException {
        
        try {
            // 4.1 å‚æ•°è·å–å’ŒéªŒè¯
            String username = getRequiredParameter(request, "username");
            String password = getRequiredParameter(request, "password");
            
            // 4.2 ä¸šåŠ¡é€»è¾‘å¤„ç†
            User user = authenticateUser(username, password);
            
            // 4.3 å“åº”å¤„ç†
            handleSuccessfulLogin(request, response, user);
            
        } catch (ValidationException e) {
            handleValidationError(request, response, e.getMessage());
        } catch (AuthenticationException e) {
            handleAuthenticationError(request, response, e.getMessage());
        }
    }
    
    // 5. è¾…åŠ©æ–¹æ³•åŒº
    private String getRequiredParameter(HttpServletRequest request, String name) 
            throws ValidationException {
        // å®ç°å‚æ•°è·å–å’ŒéªŒè¯
    }
    
    // 6. æ¸…ç†æ–¹æ³•
    @Override
    public void destroy() {
        // æ¸…ç†èµ„æº
        if (userService != null) {
            userService.cleanup();
        }
    }
}
```

### 2.3 æ³¨é‡Šè§„èŒƒ



**ğŸ“ æœ‰æ•ˆæ³¨é‡Šç­–ç•¥**

**ç±»çº§åˆ«æ³¨é‡Š**
```java
/**
 * ç”¨æˆ·ç™»å½•å¤„ç†Servlet
 * 
 * åŠŸèƒ½è¯´æ˜ï¼š
 * - å¤„ç†ç”¨æˆ·ç™»å½•è¯·æ±‚
 * - éªŒè¯ç”¨æˆ·å‡­æ®
 * - ç®¡ç†ç™»å½•ä¼šè¯
 * 
 * URLæ˜ å°„ï¼š/user/login
 * æ”¯æŒæ–¹æ³•ï¼šPOST
 * 
 * @author å¼ ä¸‰
 * @version 1.0
 * @since 2024-01-01
 */
public class UserLoginServlet extends HttpServlet {
```

**æ–¹æ³•çº§åˆ«æ³¨é‡Š**
```java
/**
 * éªŒè¯ç”¨æˆ·è¾“å…¥çš„ç™»å½•ä¿¡æ¯
 * 
 * @param username ç”¨æˆ·åï¼Œä¸èƒ½ä¸ºç©ºä¸”é•¿åº¦3-20å­—ç¬¦
 * @param password å¯†ç ï¼Œä¸èƒ½ä¸ºç©ºä¸”é•¿åº¦6-30å­—ç¬¦
 * @return éªŒè¯é€šè¿‡è¿”å›trueï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸
 * @throws ValidationException å½“è¾“å…¥ä¸ç¬¦åˆè¦æ±‚æ—¶æŠ›å‡º
 */
private boolean validateLoginInput(String username, String password) 
        throws ValidationException {
    // å…·ä½“å®ç°...
}
```

**å…³é”®ä»£ç æ³¨é‡Š**
```java
// æ£€æŸ¥ç™»å½•å°è¯•æ¬¡æ•°ï¼Œé˜²æ­¢æš´åŠ›ç ´è§£
int attemptCount = getLoginAttemptCount(request.getSession());
if (attemptCount >= MAX_LOGIN_ATTEMPTS) {
    throw new SecurityException("ç™»å½•å°è¯•æ¬¡æ•°è¿‡å¤šï¼Œè¯·ç¨åå†è¯•");
}

// ä½¿ç”¨BCryptåŠ å¯†æ¯”è¾ƒå¯†ç ï¼Œç¡®ä¿å®‰å…¨æ€§
boolean passwordMatch = BCrypt.checkpw(inputPassword, storedPasswordHash);
```

---

## 3. ğŸ›¡ï¸ å¼‚å¸¸å¤„ç†è§„èŒƒ



### 3.1 å¼‚å¸¸å¤„ç†ç­–ç•¥



**ğŸ”„ åˆ†å±‚å¼‚å¸¸å¤„ç†æ¨¡å¼**

```
ç”¨æˆ·æ“ä½œ â†’ Servletå±‚ â†’ Serviceå±‚ â†’ DAOå±‚
    â†“         â†“         â†“         â†“
ç”¨æˆ·å‹å¥½   ç»Ÿä¸€å¤„ç†   ä¸šåŠ¡å¼‚å¸¸   æ•°æ®å¼‚å¸¸
æç¤ºä¿¡æ¯   å’Œè½¬æ¢    å’ŒéªŒè¯    å’Œè¿æ¥
```

**ğŸ’¡ æ ¸å¿ƒæ€æƒ³**
- **DAOå±‚**ï¼šæŠ›å‡ºå…·ä½“çš„æŠ€æœ¯å¼‚å¸¸ï¼ˆæ•°æ®åº“è¿æ¥å¤±è´¥ç­‰ï¼‰
- **Serviceå±‚**ï¼šå°†æŠ€æœ¯å¼‚å¸¸è½¬æ¢ä¸ºä¸šåŠ¡å¼‚å¸¸
- **Servletå±‚**ï¼šå°†ä¸šåŠ¡å¼‚å¸¸è½¬æ¢ä¸ºç”¨æˆ·å‹å¥½çš„æç¤º
- **ç”¨æˆ·ç•Œé¢**ï¼šæ˜¾ç¤ºæ˜“æ‡‚çš„é”™è¯¯ä¿¡æ¯

### 3.2 å¼‚å¸¸åˆ†ç±»å’Œå¤„ç†



**ğŸ“Š å¸¸è§å¼‚å¸¸ç±»å‹å¤„ç†**

```java
@Override
protected void doPost(HttpServletRequest request, 
                     HttpServletResponse response) 
        throws ServletException, IOException {
    
    try {
        // ä¸»è¦ä¸šåŠ¡é€»è¾‘
        processUserRequest(request, response);
        
    } catch (ValidationException e) {
        // è¾“å…¥éªŒè¯å¼‚å¸¸ï¼šç”¨æˆ·è¾“å…¥æœ‰é—®é¢˜
        handleValidationError(request, response, 
            "è¾“å…¥ä¿¡æ¯ä¸æ­£ç¡®ï¼š" + e.getMessage());
        
    } catch (AuthenticationException e) {
        // è®¤è¯å¼‚å¸¸ï¼šç”¨æˆ·åå¯†ç é”™è¯¯
        handleAuthenticationError(request, response, 
            "ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç ");
        
    } catch (AuthorizationException e) {
        // æƒé™å¼‚å¸¸ï¼šæ²¡æœ‰æ“ä½œæƒé™
        handleAuthorizationError(request, response, 
            "æ‚¨æ²¡æœ‰æƒé™æ‰§è¡Œæ­¤æ“ä½œ");
        
    } catch (BusinessException e) {
        // ä¸šåŠ¡å¼‚å¸¸ï¼šä¸šåŠ¡è§„åˆ™ä¸æ»¡è¶³
        handleBusinessError(request, response, 
            "æ“ä½œå¤±è´¥ï¼š" + e.getMessage());
        
    } catch (Exception e) {
        // ç³»ç»Ÿå¼‚å¸¸ï¼šæœªé¢„æœŸçš„é”™è¯¯
        handleSystemError(request, response, 
            "ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•", e);
    }
}
```

### 3.3 ç”¨æˆ·å‹å¥½çš„é”™è¯¯å¤„ç†



**ğŸ¯ é”™è¯¯ä¿¡æ¯è®¾è®¡åŸåˆ™**

```java
/**
 * å¤„ç†éªŒè¯é”™è¯¯çš„ç»Ÿä¸€æ–¹æ³•
 * åŸåˆ™ï¼šé”™è¯¯ä¿¡æ¯è¦å¯¹ç”¨æˆ·æœ‰å¸®åŠ©ï¼Œä¸æš´éœ²ç³»ç»Ÿå†…éƒ¨ç»†èŠ‚
 */
private void handleValidationError(HttpServletRequest request,
                                 HttpServletResponse response,
                                 String userMessage) 
        throws ServletException, IOException {
    
    // 1. è®°å½•è¯¦ç»†çš„é”™è¯¯æ—¥å¿—ï¼ˆç»™å¼€å‘è€…çœ‹ï¼‰
    logger.warn("ç”¨æˆ·è¾“å…¥éªŒè¯å¤±è´¥ï¼š{}, IP: {}, æ—¶é—´: {}", 
                userMessage, 
                request.getRemoteAddr(), 
                new Date());
    
    // 2. è®¾ç½®ç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯ï¼ˆç»™ç”¨æˆ·çœ‹ï¼‰
    request.setAttribute("errorType", "validation");
    request.setAttribute("errorMessage", userMessage);
    request.setAttribute("suggestion", "è¯·æ£€æŸ¥è¾“å…¥ä¿¡æ¯çš„æ ¼å¼å’Œé•¿åº¦");
    
    // 3. ä¿æŒç”¨æˆ·ä¹‹å‰è¾“å…¥çš„æ•°æ®ï¼ˆé¿å…é‡æ–°è¾“å…¥ï¼‰
    request.setAttribute("previousUsername", 
                        request.getParameter("username"));
    
    // 4. è½¬å‘åˆ°é”™è¯¯é¡µé¢æˆ–ç™»å½•é¡µé¢
    RequestDispatcher dispatcher = request.getRequestDispatcher("/login.jsp");
    dispatcher.forward(request, response);
}
```

**ğŸ“‹ é”™è¯¯ä¿¡æ¯å¯¹æ¯”ç¤ºä¾‹**

| **å¼‚å¸¸ç±»å‹** | **âŒ ä¸å¥½çš„æç¤º** | **âœ… å¥½çš„æç¤º** |
|-------------|-----------------|----------------|
| æ•°æ®åº“è¿æ¥å¤±è´¥ | "SQLException: Connection timeout" | "ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•" |
| ç”¨æˆ·åä¸å­˜åœ¨ | "User not found in database" | "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯" |
| å¯†ç æ ¼å¼é”™è¯¯ | "Password validation failed" | "å¯†ç é•¿åº¦åº”ä¸º6-20ä¸ªå­—ç¬¦" |
| æƒé™ä¸è¶³ | "Access denied: role check failed" | "æ‚¨æ²¡æœ‰æƒé™è®¿é—®æ­¤é¡µé¢" |

---

## 4. ğŸ”§ èµ„æºé‡Šæ”¾ç®¡ç†



### 4.1 èµ„æºç®¡ç†çš„é‡è¦æ€§



**âš ï¸ èµ„æºæ³„éœ²çš„å±å®³**
```
æ•°æ®åº“è¿æ¥ä¸å…³é—­ â†’ è¿æ¥æ± è€—å°½ â†’ æ–°ç”¨æˆ·æ— æ³•è®¿é—®
æ–‡ä»¶æµä¸å…³é—­ â†’ æ–‡ä»¶é”å®š â†’ å…¶ä»–ç¨‹åºæ— æ³•è®¿é—®æ–‡ä»¶
å†…å­˜å¯¹è±¡ä¸é‡Šæ”¾ â†’ å†…å­˜æ³„éœ² â†’ ç³»ç»Ÿæ€§èƒ½ä¸‹é™ç”šè‡³å´©æºƒ
```

**ğŸ’¡ ç”Ÿæ´»åŒ–ç±»æ¯”**
èµ„æºç®¡ç†å°±åƒå€Ÿä¹¦ï¼š
- **å€Ÿä¹¦**ï¼šè·å–èµ„æºï¼ˆæ•°æ®åº“è¿æ¥ã€æ–‡ä»¶å¥æŸ„ï¼‰
- **çœ‹ä¹¦**ï¼šä½¿ç”¨èµ„æºï¼ˆæ‰§è¡Œæ•°æ®åº“æ“ä½œã€è¯»å†™æ–‡ä»¶ï¼‰
- **è¿˜ä¹¦**ï¼šé‡Šæ”¾èµ„æºï¼ˆå…³é—­è¿æ¥ã€å…³é—­æµï¼‰
- **ä¸è¿˜ä¹¦çš„åæœ**ï¼šåˆ«äººå€Ÿä¸åˆ°ï¼Œå›¾ä¹¦é¦†èµ„æºè€—å°½

### 4.2 æ•°æ®åº“èµ„æºç®¡ç†



**ğŸ—„ï¸ æ­£ç¡®çš„æ•°æ®åº“èµ„æºç®¡ç†æ¨¡å¼**

```java
/**
 * æ¨èï¼šä½¿ç”¨try-with-resourcesè‡ªåŠ¨ç®¡ç†èµ„æº
 */
private User getUserById(int userId) throws SQLException {
    String sql = "SELECT * FROM users WHERE id = ?";
    
    // try-with-resourcesä¼šè‡ªåŠ¨å…³é—­èµ„æº
    try (Connection conn = getConnection();
         PreparedStatement stmt = conn.prepareStatement(sql)) {
        
        stmt.setInt(1, userId);
        
        try (ResultSet rs = stmt.executeQuery()) {
            if (rs.next()) {
                return mapResultSetToUser(rs);
            }
            return null;
        }
    } // è¿™é‡Œä¼šè‡ªåŠ¨è°ƒç”¨close()æ–¹æ³•
}

/**
 * ä¼ ç»Ÿæ–¹å¼ï¼šæ‰‹åŠ¨ç®¡ç†èµ„æºï¼ˆå®¹æ˜“å¿˜è®°å…³é—­ï¼‰
 */
private User getUserByIdOldWay(int userId) throws SQLException {
    Connection conn = null;
    PreparedStatement stmt = null;
    ResultSet rs = null;
    
    try {
        conn = getConnection();
        stmt = conn.prepareStatement("SELECT * FROM users WHERE id = ?");
        stmt.setInt(1, userId);
        rs = stmt.executeQuery();
        
        if (rs.next()) {
            return mapResultSetToUser(rs);
        }
        return null;
        
    } finally {
        // å¿…é¡»æ‰‹åŠ¨å…³é—­ï¼Œé¡ºåºå¾ˆé‡è¦
        if (rs != null) try { rs.close(); } catch (SQLException e) { /* å¿½ç•¥ */ }
        if (stmt != null) try { stmt.close(); } catch (SQLException e) { /* å¿½ç•¥ */ }
        if (conn != null) try { conn.close(); } catch (SQLException e) { /* å¿½ç•¥ */ }
    }
}
```

### 4.3 æ–‡ä»¶èµ„æºç®¡ç†



**ğŸ“ æ–‡ä»¶æ“ä½œèµ„æºç®¡ç†**

```java
/**
 * å¤„ç†æ–‡ä»¶ä¸Šä¼ çš„æ­£ç¡®æ–¹å¼
 */
protected void handleFileUpload(HttpServletRequest request) 
        throws IOException, ServletException {
    
    Part filePart = request.getPart("uploadFile");
    if (filePart == null || filePart.getSize() == 0) {
        throw new ValidationException("è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶");
    }
    
    String fileName = getFileName(filePart);
    String uploadPath = getServletContext().getRealPath("/uploads/") + fileName;
    
    // ä½¿ç”¨try-with-resourcesç¡®ä¿è¾“å…¥è¾“å‡ºæµæ­£ç¡®å…³é—­
    try (InputStream input = filePart.getInputStream();
         FileOutputStream output = new FileOutputStream(uploadPath)) {
        
        // åˆ†å—è¯»å†™ï¼Œé¿å…å¤§æ–‡ä»¶å ç”¨è¿‡å¤šå†…å­˜
        byte[] buffer = new byte[8192];
        int bytesRead;
        while ((bytesRead = input.read(buffer)) != -1) {
            output.write(buffer, 0, bytesRead);
        }
        
        logger.info("æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼š{}", fileName);
        
    } catch (IOException e) {
        // ä¸Šä¼ å¤±è´¥æ—¶æ¸…ç†å¯èƒ½åˆ›å»ºçš„ä¸å®Œæ•´æ–‡ä»¶
        File uploadedFile = new File(uploadPath);
        if (uploadedFile.exists()) {
            uploadedFile.delete();
        }
        throw new ServletException("æ–‡ä»¶ä¸Šä¼ å¤±è´¥", e);
    }
}
```

### 4.4 å†…å­˜èµ„æºç®¡ç†



**ğŸ§  é¿å…å†…å­˜æ³„éœ²çš„æ–¹æ³•**

```java
public class DataProcessingServlet extends HttpServlet {
    
    // âŒ é”™è¯¯ï¼šé™æ€é›†åˆæŒæœ‰å¤§é‡æ•°æ®ï¼Œæ°¸ä¸é‡Šæ”¾
    private static List<UserSession> allSessions = new ArrayList<>();
    
    // âœ… æ­£ç¡®ï¼šä½¿ç”¨å¼±å¼•ç”¨æˆ–å®šæœŸæ¸…ç†
    private Map<String, WeakReference<UserSession>> sessionCache = 
            new ConcurrentHashMap<>();
    
    @Override
    protected void doPost(HttpServletRequest request, 
                         HttpServletResponse response) 
            throws ServletException, IOException {
        
        // âŒ é”™è¯¯ï¼šåˆ›å»ºå¤§é‡ä¸´æ—¶å¯¹è±¡ä¸é‡Šæ”¾
        List<String> tempData = new ArrayList<>();
        for (int i = 0; i < 100000; i++) {
            tempData.add("ä¸´æ—¶æ•°æ®" + i);
        }
        // tempDataåœ¨æ–¹æ³•ç»“æŸååº”è¯¥è¢«å›æ”¶ï¼Œä½†å¦‚æœè¢«å…¶ä»–å¯¹è±¡å¼•ç”¨å°±å¯èƒ½æ³„éœ²
        
        // âœ… æ­£ç¡®ï¼šåŠæ—¶æ¸…ç†ä¸éœ€è¦çš„æ•°æ®
        List<String> processedData = processLargeDataSet(request);
        try {
            // ä½¿ç”¨æ•°æ®
            generateResponse(response, processedData);
        } finally {
            // æ˜ç¡®æ¸…ç†å¤§å¯¹è±¡
            processedData.clear();
            processedData = null;  // å¸®åŠ©GCå›æ”¶
        }
    }
    
    /**
     * å®šæœŸæ¸…ç†ç¼“å­˜ï¼Œé¿å…å†…å­˜å ç”¨è¿‡å¤š
     */
    @Override
    public void init() throws ServletException {
        // å¯åŠ¨å®šæœŸæ¸…ç†ä»»åŠ¡
        Timer cleanupTimer = new Timer("SessionCleanup", true);
        cleanupTimer.scheduleAtFixedRate(new TimerTask() {
            @Override
            public void run() {
                cleanupExpiredSessions();
            }
        }, 60000, 300000); // æ¯5åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡
    }
    
    private void cleanupExpiredSessions() {
        // ç§»é™¤è¿‡æœŸçš„ä¼šè¯å¼•ç”¨
        sessionCache.entrySet().removeIf(entry -> {
            WeakReference<UserSession> ref = entry.getValue();
            return ref.get() == null; // å·²è¢«GCå›æ”¶
        });
    }
}
```

---

## 5. ğŸ“Š æ—¥å¿—è®°å½•è§„èŒƒ



### 5.1 æ—¥å¿—çº§åˆ«ä½¿ç”¨è§„èŒƒ



**ğŸ¯ æ—¥å¿—çº§åˆ«é€‰æ‹©æŒ‡å—**

```java
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class UserManagementServlet extends HttpServlet {
    private static final Logger logger = LoggerFactory.getLogger(UserManagementServlet.class);
    
    @Override
    protected void doPost(HttpServletRequest request, 
                         HttpServletResponse response) 
            throws ServletException, IOException {
        
        String userId = request.getParameter("userId");
        
        // TRACEï¼šæœ€è¯¦ç»†çš„ä¿¡æ¯ï¼Œé€šå¸¸åªåœ¨å¼€å‘æ—¶ä½¿ç”¨
        logger.trace("å¼€å§‹å¤„ç†ç”¨æˆ·è¯·æ±‚ï¼Œå‚æ•°ï¼šuserId={}", userId);
        
        try {
            // DEBUGï¼šè°ƒè¯•ä¿¡æ¯ï¼Œå¸®åŠ©å®šä½é—®é¢˜
            logger.debug("éªŒè¯ç”¨æˆ·è¾“å…¥ï¼šuserId={}", userId);
            validateUserId(userId);
            
            // INFOï¼šä¸€èˆ¬ä¿¡æ¯ï¼Œè®°å½•é‡è¦çš„ä¸šåŠ¡æ“ä½œ
            logger.info("ç”¨æˆ·{}å¼€å§‹æ›´æ–°ä¸ªäººä¿¡æ¯", userId);
            
            User user = updateUserInfo(request);
            
            // INFOï¼šæˆåŠŸæ“ä½œçš„è®°å½•
            logger.info("ç”¨æˆ·{}ä¸ªäººä¿¡æ¯æ›´æ–°æˆåŠŸ", userId);
            
        } catch (ValidationException e) {
            // WARNï¼šè­¦å‘Šä¿¡æ¯ï¼Œæœ‰é—®é¢˜ä½†ä¸å½±å“ç³»ç»Ÿè¿è¡Œ
            logger.warn("ç”¨æˆ·{}è¾“å…¥éªŒè¯å¤±è´¥ï¼š{}", userId, e.getMessage());
            
        } catch (Exception e) {
            // ERRORï¼šé”™è¯¯ä¿¡æ¯ï¼Œç³»ç»Ÿå¼‚å¸¸
            logger.error("ç”¨æˆ·{}ä¿¡æ¯æ›´æ–°æ—¶å‘ç”Ÿç³»ç»Ÿé”™è¯¯", userId, e);
            throw new ServletException("ç³»ç»Ÿå¼‚å¸¸", e);
        }
    }
}
```

### 5.2 æ—¥å¿—å†…å®¹è§„èŒƒ



**ğŸ“ æœ‰æ•ˆæ—¥å¿—ä¿¡æ¯çš„æ„æˆ**

```java
/**
 * å¥½çš„æ—¥å¿—è®°å½•ç¤ºä¾‹ï¼šåŒ…å«å…³é”®ä¿¡æ¯ï¼Œä¾¿äºé—®é¢˜è¿½è¸ª
 */
public void processPayment(PaymentRequest paymentRequest) {
    // è®°å½•æ“ä½œå¼€å§‹ï¼ŒåŒ…å«å…³é”®ä¸šåŠ¡å‚æ•°
    logger.info("å¼€å§‹å¤„ç†æ”¯ä»˜è¯·æ±‚ - è®¢å•å·:{}, ç”¨æˆ·:{}, é‡‘é¢:{}, IP:{}", 
                paymentRequest.getOrderId(),
                paymentRequest.getUserId(),
                paymentRequest.getAmount(),
                getCurrentUserIP());
    
    long startTime = System.currentTimeMillis();
    
    try {
        // è®°å½•å…³é”®æ­¥éª¤
        logger.debug("è°ƒç”¨ç¬¬ä¸‰æ–¹æ”¯ä»˜æ¥å£ - è®¢å•å·:{}", paymentRequest.getOrderId());
        PaymentResult result = paymentService.processPayment(paymentRequest);
        
        long duration = System.currentTimeMillis() - startTime;
        
        // è®°å½•æˆåŠŸç»“æœï¼ŒåŒ…å«æ€§èƒ½ä¿¡æ¯
        logger.info("æ”¯ä»˜å¤„ç†å®Œæˆ - è®¢å•å·:{}, ç»“æœ:{}, è€—æ—¶:{}ms", 
                    paymentRequest.getOrderId(),
                    result.isSuccess() ? "æˆåŠŸ" : "å¤±è´¥",
                    duration);
        
        // è®°å½•ä¸šåŠ¡æŒ‡æ ‡
        if (result.isSuccess()) {
            logger.info("æ”¯ä»˜æˆåŠŸ - è®¢å•å·:{}, äº¤æ˜“å·:{}", 
                        paymentRequest.getOrderId(), 
                        result.getTransactionId());
        }
        
    } catch (PaymentException e) {
        // è®°å½•ä¸šåŠ¡å¼‚å¸¸ï¼ŒåŒ…å«é”™è¯¯ç å’Œè¯¦ç»†ä¿¡æ¯
        logger.error("æ”¯ä»˜å¤„ç†å¤±è´¥ - è®¢å•å·:{}, é”™è¯¯ç :{}, é”™è¯¯ä¿¡æ¯:{}", 
                     paymentRequest.getOrderId(),
                     e.getErrorCode(),
                     e.getMessage(), e);
                     
    } catch (Exception e) {
        // è®°å½•ç³»ç»Ÿå¼‚å¸¸
        logger.error("æ”¯ä»˜å¤„ç†ç³»ç»Ÿå¼‚å¸¸ - è®¢å•å·:{}", 
                     paymentRequest.getOrderId(), e);
    }
}
```

### 5.3 æ—¥å¿—æ ¼å¼å’Œé…ç½®



**âš™ï¸ æ¨èçš„æ—¥å¿—é…ç½®ï¼ˆlogback.xmlï¼‰**

```xml
<!-- ç”Ÿäº§ç¯å¢ƒæ¨èçš„æ—¥å¿—é…ç½® -->
<configuration>
    <!-- æ§åˆ¶å°è¾“å‡ºï¼Œå¼€å‘æ—¶ä½¿ç”¨ -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>
    
    <!-- æ–‡ä»¶è¾“å‡ºï¼Œç”Ÿäº§ç¯å¢ƒä½¿ç”¨ -->
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>logs/webapp.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <!-- æ¯å¤©ä¸€ä¸ªæ–‡ä»¶ -->
            <fileNamePattern>logs/webapp.%d{yyyy-MM-dd}.log</fileNamePattern>
            <!-- ä¿ç•™30å¤© -->
            <maxHistory>30</maxHistory>
        </rollingPolicy>
        <encoder>
            <!-- åŒ…å«æ›´å¤šä¸Šä¸‹æ–‡ä¿¡æ¯çš„æ ¼å¼ -->
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [%X{userId}] %logger{50} - %msg%n</pattern>
        </encoder>
    </appender>
    
    <!-- é”™è¯¯æ—¥å¿—å•ç‹¬è®°å½• -->
    <appender name="ERROR_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>logs/error.log</file>
        <filter class="ch.qos.logback.classic.filter.LevelFilter">
            <level>ERROR</level>
            <onMatch>ACCEPT</onMatch>
            <onMismatch>DENY</onMismatch>
        </filter>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>logs/error.%d{yyyy-MM-dd}.log</fileNamePattern>
            <maxHistory>90</maxHistory>
        </rollingPolicy>
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [%X{userId}] %logger{50} - %msg%n</pattern>
        </encoder>
    </appender>
    
    <!-- ä¸åŒåŒ…çš„æ—¥å¿—çº§åˆ«è®¾ç½® -->
    <logger name="com.yourcompany.servlet" level="INFO" />
    <logger name="com.yourcompany.service" level="DEBUG" />
    <logger name="org.springframework" level="WARN" />
    
    <!-- æ ¹æ—¥å¿—çº§åˆ« -->
    <root level="INFO">
        <appender-ref ref="CONSOLE" />
        <appender-ref ref="FILE" />
        <appender-ref ref="ERROR_FILE" />
    </root>
</configuration>
```

---

## 6. ğŸ”’ å®‰å…¨ç¼–ç è§„èŒƒ



### 6.1 è¾“å…¥éªŒè¯å’Œè¿‡æ»¤



**ğŸ›¡ï¸ é˜²æ­¢æ³¨å…¥æ”»å‡»**

```java
/**
 * å®‰å…¨çš„ç”¨æˆ·è¾“å…¥å¤„ç†
 */
public class SecureUserServlet extends HttpServlet {
    
    // è¾“å…¥éªŒè¯è§„åˆ™
    private static final Pattern USERNAME_PATTERN = Pattern.compile("^[a-zA-Z0-9_]{3,20}$");
    private static final Pattern EMAIL_PATTERN = Pattern.compile("^[\\w.-]+@[\\w.-]+\\.[A-Za-z]{2,}$");
    
    @Override
    protected void doPost(HttpServletRequest request, 
                         HttpServletResponse response) 
            throws ServletException, IOException {
        
        try {
            // 1. è·å–å’ŒéªŒè¯è¾“å…¥
            String username = validateAndSanitizeInput(
                    request.getParameter("username"), "username");
            String email = validateAndSanitizeInput(
                    request.getParameter("email"), "email");
            String description = sanitizeHtmlInput(
                    request.getParameter("description"));
            
            // 2. ä½¿ç”¨é¢„ç¼–è¯‘SQLé˜²æ­¢SQLæ³¨å…¥
            createUserSecurely(username, email, description);
            
            response.sendRedirect("success.jsp");
            
        } catch (ValidationException e) {
            handleValidationError(request, response, e.getMessage());
        }
    }
    
    /**
     * éªŒè¯å’Œæ¸…ç†ç”¨æˆ·è¾“å…¥
     */
    private String validateAndSanitizeInput(String input, String fieldName) 
            throws ValidationException {
        
        if (input == null || input.trim().isEmpty()) {
            throw new ValidationException(fieldName + "ä¸èƒ½ä¸ºç©º");
        }
        
        // ç§»é™¤å‰åç©ºæ ¼
        input = input.trim();
        
        // æ ¹æ®å­—æ®µç±»å‹éªŒè¯æ ¼å¼
        switch (fieldName) {
            case "username":
                if (!USERNAME_PATTERN.matcher(input).matches()) {
                    throw new ValidationException("ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿ï¼Œé•¿åº¦3-20å­—ç¬¦");
                }
                break;
            case "email":
                if (!EMAIL_PATTERN.matcher(input).matches()) {
                    throw new ValidationException("é‚®ç®±æ ¼å¼ä¸æ­£ç¡®");
                }
                break;
        }
        
        return input;
    }
    
    /**
     * æ¸…ç†HTMLè¾“å…¥ï¼Œé˜²æ­¢XSSæ”»å‡»
     */
    private String sanitizeHtmlInput(String input) {
        if (input == null) return "";
        
        return input
                .replace("<", "&lt;")
                .replace(">", "&gt;")
                .replace("\"", "&quot;")
                .replace("'", "&#x27;")
                .replace("&", "&amp;");
    }
    
    /**
     * å®‰å…¨çš„æ•°æ®åº“æ“ä½œ - ä½¿ç”¨é¢„ç¼–è¯‘è¯­å¥
     */
    private void createUserSecurely(String username, String email, String description) 
            throws SQLException {
        
        String sql = "INSERT INTO users (username, email, description, create_time) VALUES (?, ?, ?, ?)";
        
        try (Connection conn = getConnection();
             PreparedStatement stmt = conn.prepareStatement(sql)) {
            
            stmt.setString(1, username);
            stmt.setString(2, email);
            stmt.setString(3, description);
            stmt.setTimestamp(4, new Timestamp(System.currentTimeMillis()));
            
            stmt.executeUpdate();
            logger.info("ç”¨æˆ·åˆ›å»ºæˆåŠŸï¼š{}", username);
        }
    }
}
```

### 6.2 ä¼šè¯å®‰å…¨ç®¡ç†



**ğŸ” å®‰å…¨çš„ä¼šè¯å¤„ç†**

```java
/**
 * å®‰å…¨çš„ç™»å½•ä¼šè¯ç®¡ç†
 */
public class SecureLoginServlet extends HttpServlet {
    
    private static final int SESSION_TIMEOUT = 30 * 60; // 30åˆ†é’Ÿ
    private static final String LAST_ACTIVITY = "lastActivity";
    
    @Override
    protected void doPost(HttpServletRequest request, 
                         HttpServletResponse response) 
            throws ServletException, IOException {
        
        String username = request.getParameter("username");
        String password = request.getParameter("password");
        
        try {
            // éªŒè¯ç”¨æˆ·å‡­æ®
            User user = authenticateUser(username, password);
            
            if (user != null) {
                // åˆ›å»ºå®‰å…¨çš„ä¼šè¯
                createSecureSession(request, response, user);
                response.sendRedirect("dashboard.jsp");
            } else {
                handleLoginFailure(request, response, "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
            }
            
        } catch (Exception e) {
            logger.error("ç™»å½•è¿‡ç¨‹å‘ç”Ÿé”™è¯¯", e);
            handleLoginFailure(request, response, "ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•");
        }
    }
    
    /**
     * åˆ›å»ºå®‰å…¨çš„ä¼šè¯
     */
    private void createSecureSession(HttpServletRequest request, 
                                   HttpServletResponse response, 
                                   User user) {
        
        // 1. é”€æ¯æ—§ä¼šè¯ï¼Œé˜²æ­¢ä¼šè¯å›ºå®šæ”»å‡»
        HttpSession oldSession = request.getSession(false);
        if (oldSession != null) {
            oldSession.invalidate();
        }
        
        // 2. åˆ›å»ºæ–°ä¼šè¯
        HttpSession session = request.getSession(true);
        
        // 3. è®¾ç½®ä¼šè¯å±æ€§
        session.setAttribute("user", user);
        session.setAttribute("loginTime", System.currentTimeMillis());
        session.setAttribute(LAST_ACTIVITY, System.currentTimeMillis());
        
        // 4. è®¾ç½®ä¼šè¯è¶…æ—¶æ—¶é—´
        session.setMaxInactiveInterval(SESSION_TIMEOUT);
        
        // 5. è®¾ç½®å®‰å…¨çš„Cookieå±æ€§
        if (response instanceof HttpServletResponse) {
            // è®¾ç½®HttpOnlyæ ‡å¿—ï¼Œé˜²æ­¢JavaScriptè®¿é—®
            response.setHeader("Set-Cookie", 
                "JSESSIONID=" + session.getId() + 
                "; Path=/; HttpOnly; Secure; SameSite=Strict");
        }
        
        logger.info("ç”¨æˆ· {} ç™»å½•æˆåŠŸï¼Œä¼šè¯IDï¼š{}", user.getUsername(), session.getId());
    }
    
    /**
     * æ£€æŸ¥ä¼šè¯æœ‰æ•ˆæ€§çš„è¿‡æ»¤å™¨æ–¹æ³•
     */
    public static boolean isSessionValid(HttpServletRequest request) {
        HttpSession session = request.getSession(false);
        
        if (session == null) {
            return false;
        }
        
        // æ£€æŸ¥ä¼šè¯æ˜¯å¦è¿‡æœŸ
        Long lastActivity = (Long) session.getAttribute(LAST_ACTIVITY);
        if (lastActivity != null) {
            long inactiveTime = System.currentTimeMillis() - lastActivity;
            if (inactiveTime > SESSION_TIMEOUT * 1000) {
                session.invalidate();
                return false;
            }
            
            // æ›´æ–°æœ€åæ´»åŠ¨æ—¶é—´
            session.setAttribute(LAST_ACTIVITY, System.currentTimeMillis());
        }
        
        return session.getAttribute("user") != null;
    }
}
```

### 6.3 è·¨ç«™è¯·æ±‚ä¼ªé€ (CSRF)é˜²æŠ¤



**ğŸ›¡ï¸ CSRF Tokenæœºåˆ¶**

```java
/**
 * CSRFé˜²æŠ¤å®ç°
 */
public class CSRFProtectionServlet extends HttpServlet {
    
    private static final String CSRF_TOKEN_ATTR = "csrfToken";
    private static final String CSRF_TOKEN_PARAM = "_csrf";
    
    @Override
    protected void doGet(HttpServletRequest request, 
                        HttpServletResponse response) 
            throws ServletException, IOException {
        
        // ç”Ÿæˆå¹¶è®¾ç½®CSRFä»¤ç‰Œ
        generateCSRFToken(request);
        
        // è½¬å‘åˆ°è¡¨å•é¡µé¢
        RequestDispatcher dispatcher = request.getRequestDispatcher("/form.jsp");
        dispatcher.forward(request, response);
    }
    
    @Override
    protected void doPost(HttpServletRequest request, 
                         HttpServletResponse response) 
            throws ServletException, IOException {
        
        try {
            // éªŒè¯CSRFä»¤ç‰Œ
            if (!validateCSRFToken(request)) {
                throw new SecurityException("CSRFä»¤ç‰ŒéªŒè¯å¤±è´¥ï¼Œå¯èƒ½å­˜åœ¨è·¨ç«™è¯·æ±‚ä¼ªé€ æ”»å‡»");
            }
            
            // å¤„ç†æ­£å¸¸çš„è¡¨å•æäº¤
            processFormSubmission(request, response);
            
        } catch (SecurityException e) {
            logger.warn("CSRFæ”»å‡»å°è¯• - IP: {}, User-Agent: {}", 
                       request.getRemoteAddr(), 
                       request.getHeader("User-Agent"));
            
            response.setStatus(HttpServletResponse.SC_FORBIDDEN);
            response.getWriter().write("è¯·æ±‚è¢«æ‹’ç»ï¼šå®‰å…¨éªŒè¯å¤±è´¥");
        }
    }
    
    /**
     * ç”ŸæˆCSRFä»¤ç‰Œ
     */
    private void generateCSRFToken(HttpServletRequest request) {
        HttpSession session = request.getSession();
        
        // ç”Ÿæˆéšæœºä»¤ç‰Œ
        String token = UUID.randomUUID().toString();
        
        // å­˜å‚¨åœ¨ä¼šè¯ä¸­
        session.setAttribute(CSRF_TOKEN_ATTR, token);
        
        // ä¼ é€’ç»™JSPé¡µé¢
        request.setAttribute(CSRF_TOKEN_ATTR, token);
    }
    
    /**
     * éªŒè¯CSRFä»¤ç‰Œ
     */
    private boolean validateCSRFToken(HttpServletRequest request) {
        HttpSession session = request.getSession(false);
        if (session == null) {
            return false;
        }
        
        String sessionToken = (String) session.getAttribute(CSRF_TOKEN_ATTR);
        String requestToken = request.getParameter(CSRF_TOKEN_PARAM);
        
        // ä»¤ç‰Œå¿…é¡»å­˜åœ¨ä¸”ç›¸ç­‰
        return sessionToken != null && 
               requestToken != null && 
               sessionToken.equals(requestToken);
    }
}
```

---

## 7. ğŸ”§ å¯ç»´æŠ¤æ€§è®¾è®¡



### 7.1 å•ä¸€èŒè´£åŸåˆ™



**ğŸ¯ èŒè´£åˆ†ç¦»è®¾è®¡**

```java
// âŒ ä¸å¥½çš„è®¾è®¡ï¼šä¸€ä¸ªServletåšæ‰€æœ‰äº‹æƒ…
public class UserServlet extends HttpServlet {
    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response) 
            throws ServletException, IOException {
        
        // éªŒè¯è¾“å…¥
        String username = request.getParameter("username");
        if (username == null || username.trim().isEmpty()) {
            // é”™è¯¯å¤„ç†
        }
        
        // æ•°æ®åº“æ“ä½œ
        Connection conn = DriverManager.getConnection("jdbc:mysql://...");
        PreparedStatement stmt = conn.prepareStatement("SELECT * FROM users WHERE username = ?");
        // ... å¤§é‡æ•°æ®åº“ä»£ç 
        
        // ä¸šåŠ¡é€»è¾‘
        if (user.getAge() < 18) {
            // æœªæˆå¹´ç”¨æˆ·é€»è¾‘
        }
        
        // å“åº”ç”Ÿæˆ
        response.setContentType("application/json");
        // ... å¤§é‡JSONç”Ÿæˆä»£ç 
    }
}
```

```java
// âœ… å¥½çš„è®¾è®¡ï¼šèŒè´£åˆ†ç¦»ï¼Œå„å¸å…¶èŒ
@WebServlet("/user")
public class UserServlet extends HttpServlet {
    
    private UserService userService;
    private InputValidator validator;
    private ResponseHelper responseHelper;
    
    @Override
    public void init() throws ServletException {
        userService = new UserServiceImpl();
        validator = new UserInputValidator();
        responseHelper = new JsonResponseHelper();
    }
    
    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response) 
            throws ServletException, IOException {
        
        try {
            // 1. è¾“å…¥éªŒè¯ï¼ˆå§”æ‰˜ç»™ä¸“é—¨çš„éªŒè¯å™¨ï¼‰
            UserRequest userRequest = validator.validateAndParseRequest(request);
            
            // 2. ä¸šåŠ¡å¤„ç†ï¼ˆå§”æ‰˜ç»™ä¸šåŠ¡æœåŠ¡ï¼‰
            UserResponse userResponse = userService.processUserRequest(userRequest);
            
            // 3. å“åº”ç”Ÿæˆï¼ˆå§”æ‰˜ç»™å“åº”åŠ©æ‰‹ï¼‰
            responseHelper.sendSuccessResponse(response, userResponse);
            
        } catch (ValidationException e) {
            responseHelper.sendErrorResponse(response, 400, e.getMessage());
        } catch (BusinessException e) {
            responseHelper.sendErrorResponse(response, 422, e.getMessage());
        } catch (Exception e) {
            logger.error("å¤„ç†ç”¨æˆ·è¯·æ±‚æ—¶å‘ç”Ÿé”™è¯¯", e);
            responseHelper.sendErrorResponse(response, 500, "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯");
        }
    }
}

// ä¸“é—¨çš„è¾“å…¥éªŒè¯ç±»
public class UserInputValidator {
    public UserRequest validateAndParseRequest(HttpServletRequest request) 
            throws ValidationException {
        // ä¸“é—¨è´Ÿè´£è¾“å…¥éªŒè¯å’Œè§£æ
    }
}

// ä¸“é—¨çš„ä¸šåŠ¡æœåŠ¡ç±»
public class UserServiceImpl implements UserService {
    public UserResponse processUserRequest(UserRequest request) 
            throws BusinessException {
        // ä¸“é—¨è´Ÿè´£ä¸šåŠ¡é€»è¾‘å¤„ç†
    }
}

// ä¸“é—¨çš„å“åº”åŠ©æ‰‹ç±»
public class JsonResponseHelper implements ResponseHelper {
    public void sendSuccessResponse(HttpServletResponse response, Object data) 
            throws IOException {
        // ä¸“é—¨è´Ÿè´£å“åº”æ ¼å¼åŒ–å’Œå‘é€
    }
}
```

### 7.2 é…ç½®å¤–éƒ¨åŒ–



**âš™ï¸ é…ç½®ç®¡ç†æœ€ä½³å®è·µ**

```java
/**
 * é…ç½®ç®¡ç†å·¥å…·ç±»
 */
public class ConfigurationManager {
    
    private static final Properties appConfig = new Properties();
    private static final String CONFIG_FILE = "/application.properties";
    
    static {
        loadConfiguration();
    }
    
    private static void loadConfiguration() {
        try (InputStream is = ConfigurationManager.class.getResourceAsStream(CONFIG_FILE)) {
            if (is != null) {
                appConfig.load(is);
                logger.info("é…ç½®æ–‡ä»¶åŠ è½½æˆåŠŸï¼š{}", CONFIG_FILE);
            } else {
                logger.warn("é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼š{}", CONFIG_FILE);
            }
        } catch (IOException e) {
            logger.error("åŠ è½½é…ç½®æ–‡ä»¶å¤±è´¥", e);
        }
    }
    
    public static String getString(String key, String defaultValue) {
        return appConfig.getProperty(key, defaultValue);
    }
    
    public static int getInt(String key, int defaultValue) {
        String value = appConfig.getProperty(key);
        try {
            return value != null ? Integer.parseInt(value) : defaultValue;
        } catch (NumberFormatException e) {
            logger.warn("é…ç½®é¡¹{}çš„å€¼{}ä¸æ˜¯æœ‰æ•ˆæ•°å­—ï¼Œä½¿ç”¨é»˜è®¤å€¼{}", key, value, defaultValue);
            return defaultValue;
        }
    }
    
    public static boolean getBoolean(String key, boolean defaultValue) {
        String value = appConfig.getProperty(key);
        return value != null ? Boolean.parseBoolean(value) : defaultValue;
    }
}
```

```properties
# application.properties - å¤–éƒ¨é…ç½®æ–‡ä»¶

# æ•°æ®åº“é…ç½®

db.url=jdbc:mysql://localhost:3306/webapp
db.username=webapp_user
db.password=secure_password
db.pool.maxSize=20

# ä¸šåŠ¡é…ç½®

app.name=My Web Application
app.version=1.0.0
user.session.timeout=1800
user.login.maxAttempts=5

# æ–‡ä»¶ä¸Šä¼ é…ç½®

upload.maxFileSize=10485760
upload.allowedTypes=jpg,png,pdf,doc

# é‚®ä»¶é…ç½®

mail.smtp.host=smtp.example.com
mail.smtp.port=587
mail.smtp.username=noreply@example.com
```

### 7.3 ä»£ç å¤ç”¨å’Œæ¨¡å—åŒ–



**ğŸ§© å¯å¤ç”¨ç»„ä»¶è®¾è®¡**

```java
/**
 * åŸºç¡€Servletç±»ï¼Œæä¾›é€šç”¨åŠŸèƒ½
 */
public abstract class BaseServlet extends HttpServlet {
    
    protected final Logger logger = LoggerFactory.getLogger(this.getClass());
    protected ConfigurationManager config = ConfigurationManager.getInstance();
    
    /**
     * ç»Ÿä¸€çš„å‚æ•°è·å–æ–¹æ³•
     */
    protected String getRequiredParameter(HttpServletRequest request, String paramName) 
            throws ValidationException {
        String value = request.getParameter(paramName);
        if (value == null || value.trim().isEmpty()) {
            throw new ValidationException("ç¼ºå°‘å¿…éœ€å‚æ•°ï¼š" + paramName);
        }
        return value.trim();
    }
    
    protected String getOptionalParameter(HttpServletRequest request, String paramName, String defaultValue) {
        String value = request.getParameter(paramName);
        return (value != null && !value.trim().isEmpty()) ? value.trim() : defaultValue;
    }
    
    /**
     * ç»Ÿä¸€çš„é”™è¯¯å“åº”æ–¹æ³•
     */
    protected void sendErrorResponse(HttpServletResponse response, int statusCode, String message) 
            throws IOException {
        response.setStatus(statusCode);
        response.setContentType("application/json;charset=UTF-8");
        response.getWriter().write(String.format("{\"error\":\"%s\"}", message));
    }
    
    /**
     * ç»Ÿä¸€çš„æˆåŠŸå“åº”æ–¹æ³•
     */
    protected void sendSuccessResponse(HttpServletResponse response, Object data) 
            throws IOException {
        response.setContentType("application/json;charset=UTF-8");
        // ä½¿ç”¨JSONåº“è½¬æ¢å¯¹è±¡
        String jsonResponse = JsonUtils.toJson(data);
        response.getWriter().write(jsonResponse);
    }
    
    /**
     * è·å–å®¢æˆ·ç«¯IPåœ°å€
     */
    protected String getClientIP(HttpServletRequest request) {
        String ip = request.getHeader("X-Forwarded-For");
        if (ip == null || ip.isEmpty() || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getHeader("X-Real-IP");
        }
        if (ip == null || ip.isEmpty() || "unknown".equalsIgnoreCase(ip)) {
            ip = request.getRemoteAddr();
        }
        return ip;
    }
}

/**
 * å…·ä½“ä¸šåŠ¡Servletç»§æ‰¿åŸºç¡€ç±»
 */
@WebServlet("/product")
public class ProductServlet extends BaseServlet {
    
    private ProductService productService;
    
    @Override
    public void init() throws ServletException {
        productService = new ProductServiceImpl();
    }
    
    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) 
            throws ServletException, IOException {
        
        try {
            String productId = getRequiredParameter(request, "id");
            String format = getOptionalParameter(request, "format", "json");
            
            Product product = productService.getProductById(productId);
            
            if (product != null) {
                sendSuccessResponse(response, product);
                logger.info("äº§å“æŸ¥è¯¢æˆåŠŸ - ID: {}, IP: {}", productId, getClientIP(request));
            } else {
                sendErrorResponse(response, 404, "äº§å“ä¸å­˜åœ¨");
            }
            
        } catch (ValidationException e) {
            sendErrorResponse(response, 400, e.getMessage());
        } catch (Exception e) {
            logger.error("æŸ¥è¯¢äº§å“æ—¶å‘ç”Ÿé”™è¯¯", e);
            sendErrorResponse(response, 500, "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯");
        }
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“



### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ



```
ğŸ”¸ æœ€ä½³å®è·µæœ¬è´¨ï¼šç»è¿‡éªŒè¯çš„é«˜è´¨é‡ç¼–ç¨‹æ–¹æ³•
ğŸ”¸ ä»£ç è§„èŒƒï¼šç»Ÿä¸€çš„å‘½åã€ç»“æ„å’Œæ³¨é‡Šæ ‡å‡†
ğŸ”¸ å¼‚å¸¸å¤„ç†ï¼šåˆ†å±‚å¤„ç†ï¼Œç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯
ğŸ”¸ èµ„æºç®¡ç†ï¼šåŠæ—¶é‡Šæ”¾æ•°æ®åº“è¿æ¥ã€æ–‡ä»¶æµç­‰èµ„æº
ğŸ”¸ æ—¥å¿—è®°å½•ï¼šåˆç†ä½¿ç”¨æ—¥å¿—çº§åˆ«ï¼Œè®°å½•å…³é”®ä¿¡æ¯
ğŸ”¸ å®‰å…¨ç¼–ç ï¼šé˜²æ³¨å…¥ã€é˜²XSSã€å®‰å…¨ä¼šè¯ç®¡ç†
ğŸ”¸ å¯ç»´æŠ¤æ€§ï¼šå•ä¸€èŒè´£ã€é…ç½®å¤–éƒ¨åŒ–ã€ä»£ç å¤ç”¨
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹



**ğŸ”¹ ä¸ºä»€ä¹ˆè¦éµå¾ªæœ€ä½³å®è·µ**
```
ä¸ªäººå¼€å‘ï¼š
- ä»£ç è´¨é‡æ›´é«˜ï¼Œbugæ›´å°‘
- å¼€å‘æ•ˆç‡æå‡ï¼Œå‡å°‘è¿”å·¥

å›¢é˜Ÿåä½œï¼š
- ç»Ÿä¸€æ ‡å‡†ï¼Œä¾¿äºåˆä½œ
- ä»£ç æ˜“è¯»æ˜“æ‡‚ï¼Œé™ä½äº¤æ¥æˆæœ¬

é¡¹ç›®ç»´æŠ¤ï¼š
- ç»“æ„æ¸…æ™°ï¼Œä¾¿äºä¿®æ”¹
- é—®é¢˜å®šä½å¿«é€Ÿï¼Œæ˜“äºè°ƒè¯•
```

**ğŸ”¹ æœ€ä½³å®è·µçš„å±‚æ¬¡ç»“æ„**
```
åŸºç¡€å±‚ï¼šä»£ç è§„èŒƒã€å‘½åçº¦å®š
è´¨é‡å±‚ï¼šå¼‚å¸¸å¤„ç†ã€èµ„æºç®¡ç†ã€æ—¥å¿—è®°å½•
å®‰å…¨å±‚ï¼šè¾“å…¥éªŒè¯ã€ä¼šè¯ç®¡ç†ã€é˜²æ”»å‡»
æ¶æ„å±‚ï¼šèŒè´£åˆ†ç¦»ã€é…ç½®ç®¡ç†ã€å¯æ‰©å±•æ€§
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼



**ğŸ“Š ä¸åŒåœºæ™¯çš„é‡ç‚¹å…³æ³¨**

| **é¡¹ç›®é˜¶æ®µ** | **é‡ç‚¹å…³æ³¨** | **å…·ä½“å®è·µ** |
|-------------|-------------|-------------|
| **å¼€å‘åˆæœŸ** | ä»£ç è§„èŒƒã€åŸºç¡€å®‰å…¨ | ç»Ÿä¸€å‘½åã€è¾“å…¥éªŒè¯ã€åŸºæœ¬å¼‚å¸¸å¤„ç† |
| **åŠŸèƒ½å®Œå–„** | èµ„æºç®¡ç†ã€æ—¥å¿—è®°å½• | è¿æ¥æ± ç®¡ç†ã€å®Œæ•´æ—¥å¿—ã€æ€§èƒ½ç›‘æ§ |
| **ä¸Šçº¿å‡†å¤‡** | å®‰å…¨åŠ å›ºã€å¯ç»´æŠ¤æ€§ | å®‰å…¨æµ‹è¯•ã€ä»£ç é‡æ„ã€æ–‡æ¡£å®Œå–„ |
| **è¿ç»´é˜¶æ®µ** | ç›‘æ§ä¼˜åŒ–ã€é—®é¢˜å®šä½ | æ—¥å¿—åˆ†æã€æ€§èƒ½è°ƒä¼˜ã€æ•…éšœå¤„ç† |

### 8.4 å­¦ä¹ æ£€æŸ¥æ¸…å•



**ğŸ¯ è‡ªæˆ‘æ£€æµ‹æ ‡å‡†**
- [ ] èƒ½å¤Ÿç¼–å†™ç¬¦åˆè§„èŒƒçš„Servletä»£ç 
- [ ] ç†è§£å¹¶èƒ½å®ç°åˆ†å±‚å¼‚å¸¸å¤„ç†
- [ ] æŒæ¡æ•°æ®åº“è¿æ¥ç­‰èµ„æºçš„æ­£ç¡®ç®¡ç†
- [ ] ä¼šé…ç½®å’Œä½¿ç”¨æ—¥å¿—æ¡†æ¶
- [ ] äº†è§£åŸºæœ¬çš„å®‰å…¨ç¼–ç åŸåˆ™
- [ ] èƒ½å¤Ÿè®¾è®¡å¯ç»´æŠ¤çš„ä»£ç ç»“æ„

**ğŸ’¡ æŒç»­æ”¹è¿›å»ºè®®**
- **ä»£ç å®¡æŸ¥**ï¼šå®šæœŸæ£€æŸ¥è‡ªå·±çš„ä»£ç æ˜¯å¦ç¬¦åˆè§„èŒƒ
- **å­¦ä¹ ä¼˜ç§€ä»£ç **ï¼šç ”ç©¶å¼€æºé¡¹ç›®çš„å®ç°æ–¹å¼
- **å®è·µæ€»ç»“**ï¼šé‡åˆ°é—®é¢˜æ—¶æ€è€ƒæœ€ä½³è§£å†³æ–¹æ¡ˆ
- **å›¢é˜Ÿåˆ†äº«**ï¼šä¸åŒäº‹äº¤æµæœ€ä½³å®è·µç»éªŒ

### 8.5 å¸¸è§é”™è¯¯é¿å…



**âš ï¸ æ–°æ‰‹å¸¸çŠ¯çš„é”™è¯¯**
```
å¿˜è®°å…³é—­èµ„æºï¼š
- æ•°æ®åº“è¿æ¥ä¸å…³é—­å¯¼è‡´è¿æ¥æ± è€—å°½
- æ–‡ä»¶æµä¸å…³é—­å¯¼è‡´æ–‡ä»¶é”å®š

å¼‚å¸¸å¤„ç†ä¸å½“ï¼š
- å¼‚å¸¸ä¿¡æ¯æš´éœ²ç³»ç»Ÿå†…éƒ¨ç»†èŠ‚
- å¼‚å¸¸è¢«åæ‰ï¼Œé—®é¢˜éš¾ä»¥å®šä½

å®‰å…¨æ„è¯†è–„å¼±ï¼š
- ä¸éªŒè¯ç”¨æˆ·è¾“å…¥
- æ˜æ–‡å­˜å‚¨å¯†ç 
- ä¼šè¯ç®¡ç†ä¸å®‰å…¨

ä»£ç å¯è¯»æ€§å·®ï¼š
- å˜é‡å‘½åéšæ„
- ç¼ºå°‘å¿…è¦æ³¨é‡Š
- æ–¹æ³•èŒè´£ä¸æ¸…
```

**ğŸ”‘ æ ¸å¿ƒè®°å¿†è¦ç‚¹**
> è§„èŒƒå…ˆè¡Œè´¨é‡é«˜ï¼Œå¼‚å¸¸å¤„ç†è¦åšå¥½
> èµ„æºç®¡ç†åˆ«å¿˜è®°ï¼Œæ—¥å¿—å®‰å…¨å¾ˆé‡è¦
> å•ä¸€èŒè´£æ˜“ç»´æŠ¤ï¼Œé…ç½®å¤–åŒ–æ›´çµæ´»

**ğŸ“ˆ è¿›é˜¶å­¦ä¹ æ–¹å‘**
- **Springæ¡†æ¶**ï¼šå­¦ä¹ æ›´é«˜çº§çš„ä¾èµ–æ³¨å…¥å’ŒAOP
- **å¾®æœåŠ¡æ¶æ„**ï¼šäº†è§£åˆ†å¸ƒå¼ç³»ç»Ÿçš„æœ€ä½³å®è·µ
- **æ€§èƒ½ä¼˜åŒ–**ï¼šæ·±å…¥å­¦ä¹ JVMè°ƒä¼˜å’Œç³»ç»Ÿä¼˜åŒ–
- **DevOpså®è·µ**ï¼šå­¦ä¹ è‡ªåŠ¨åŒ–æµ‹è¯•å’ŒæŒç»­é›†æˆ