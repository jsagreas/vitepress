---
title: 2、数据库CRUD操作
---
## 📚 目录

1. [数据库CRUD操作基础概念](#1-数据库CRUD操作基础概念)
2. [JSP查询数据并显示](#2-JSP查询数据并显示)
3. [数据插入操作详解](#3-数据插入操作详解)
4. [数据更新操作实现](#4-数据更新操作实现)
5. [数据删除操作处理](#5-数据删除操作处理)
6. [PreparedStatement详解](#6-PreparedStatement详解)
7. [SQL注入防护机制](#7-SQL注入防护机制)
8. [事务处理基础](#8-事务处理基础)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 💾 数据库CRUD操作基础概念


### 1.1 什么是CRUD操作


> 💡 **通俗解释**：CRUD就像我们日常管理文件一样 - 创建新文件、查看文件内容、修改文件、删除文件

**CRUD四大基本操作**：
```
┌──────────────┬──────────────┬──────────────────────┐
│   操作类型    │   英文全称    │        实际含义       │
├──────────────┼──────────────┼──────────────────────┤
│ **C**reate   │ 创建/新增    │ 向数据库插入新数据    │
│ **R**ead     │ 读取/查询    │ 从数据库查询数据      │
│ **U**pdate   │ 更新/修改    │ 修改数据库中的数据    │
│ **D**elete   │ 删除        │ 从数据库删除数据      │
└──────────────┴──────────────┴──────────────────────┘
```

### 1.2 JSP中的数据库操作流程


**数据库操作的基本步骤**：
```
用户操作 → JSP页面 → Java代码 → 数据库 → 返回结果 → 显示给用户

①用户在网页上点击按钮
②JSP接收用户请求
③Java代码连接数据库
④执行SQL语句
⑤获取操作结果
⑥在网页上显示结果
```

> 🎯 **关键理解**：JSP就是把用户在网页上的操作，转换成对数据库的增删改查

### 1.3 常用的数据库表结构示例


**用户信息表（users）示例**：
```
用户表（users）结构：
┌─────┬──────────┬──────────┬─────────────┬──────────────┐
│ id  │   name   │  email   │  password   │ create_time  │
├─────┼──────────┼──────────┼─────────────┼──────────────┤
│  1  │  张三    │ z@qq.com │  123456     │ 2024-01-01   │
│  2  │  李四    │ l@qq.com │  abcdef     │ 2024-01-02   │
│  3  │  王五    │ w@qq.com │  qwerty     │ 2024-01-03   │
└─────┴──────────┴──────────┴─────────────┴──────────────┘
```

---

## 2. 🔍 JSP查询数据并显示


### 2.1 基本查询操作


> 💡 **通俗理解**：查询就像在图书馆找书 - 告诉图书管理员你要什么书，他帮你找出来

**查询数据的完整流程**：

```jsp
<%-- userList.jsp - 显示用户列表 --%>
<%@ page import="java.sql.*" %>
<%@ page import="java.util.*" %>

<html>
<head>
    <title>用户列表</title>
</head>
<body>
    <h2>📋 用户信息列表</h2>
    
    <%
        // 数据库连接信息
        String url = "jdbc:mysql://localhost:3306/testdb";
        String username = "root";
        String password = "123456";
        
        Connection conn = null;
        Statement stmt = null;
        ResultSet rs = null;
        
        try {
            // ①加载数据库驱动
            Class.forName("com.mysql.cj.jdbc.Driver");
            
            // ②建立连接
            conn = DriverManager.getConnection(url, username, password);
            
            // ③创建Statement对象
            stmt = conn.createStatement();
            
            // ④执行查询
            String sql = "SELECT id, name, email, create_time FROM users";
            rs = stmt.executeQuery(sql);
    %>
    
    <!-- 显示查询结果 -->
    <table border="1">
        <tr>
            <th>ID</th>
            <th>姓名</th>
            <th>邮箱</th>
            <th>注册时间</th>
        </tr>
        
        <%
            // ⑤处理查询结果
            while(rs.next()) {
                int id = rs.getInt("id");
                String name = rs.getString("name");
                String email = rs.getString("email");
                String createTime = rs.getString("create_time");
        %>
        <tr>
            <td><%= id %></td>
            <td><%= name %></td>
            <td><%= email %></td>
            <td><%= createTime %></td>
        </tr>
        <%
            }
        %>
    </table>
    
    <%
        } catch(Exception e) {
            out.println("❌ 查询出错：" + e.getMessage());
        } finally {
            // ⑥关闭连接（重要！）
            if(rs != null) rs.close();
            if(stmt != null) stmt.close();
            if(conn != null) conn.close();
        }
    %>
</body>
</html>
```

### 2.2 条件查询示例


**根据用户名搜索用户**：

```jsp
<%-- searchUser.jsp - 搜索用户 --%>
<%
    // 获取搜索关键词
    String keyword = request.getParameter("keyword");
    
    if(keyword != null && !keyword.isEmpty()) {
        try {
            conn = DriverManager.getConnection(url, username, password);
            
            // 使用LIKE进行模糊查询
            String sql = "SELECT * FROM users WHERE name LIKE ?";
            PreparedStatement pstmt = conn.prepareStatement(sql);
            pstmt.setString(1, "%" + keyword + "%");
            
            rs = pstmt.executeQuery();
%>

<h3>🔍 搜索结果：包含 "<%= keyword %>" 的用户</h3>

<!-- 显示搜索结果的表格... -->

<%
        } catch(Exception e) {
            out.println("搜索失败：" + e.getMessage());
        }
    }
%>
```

> 📌 **重点提醒**：`%` 是SQL中的通配符，表示任意字符，`LIKE '%张%'` 就是查找名字中包含"张"的所有用户

### 2.3 查询结果的不同显示方式


**① 卡片式显示**：
```jsp
<div style="display: flex; flex-wrap: wrap;">
<%
    while(rs.next()) {
%>
    <div style="border: 1px solid #ccc; margin: 10px; padding: 15px; border-radius: 5px;">
        <h4>👤 <%= rs.getString("name") %></h4>
        <p>📧 <%= rs.getString("email") %></p>
        <p>📅 <%= rs.getString("create_time") %></p>
    </div>
<%
    }
%>
</div>
```

**② 列表式显示**：
```jsp
<ul>
<%
    while(rs.next()) {
%>
    <li>
        <strong><%= rs.getString("name") %></strong> 
        (<%= rs.getString("email") %>) 
        - 注册于 <%= rs.getString("create_time") %>
    </li>
<%
    }
%>
</ul>
```

---

## 3. ➕ 数据插入操作详解


### 3.1 用户注册功能实现


> 💡 **生活类比**：插入数据就像在登记本上写下你的信息 - 姓名、电话、地址等

**注册表单页面（register.html）**：
```html
<!DOCTYPE html>
<html>
<head>
    <title>用户注册</title>
</head>
<body>
    <h2>📝 用户注册</h2>
    
    <form action="registerProcess.jsp" method="post">
        <table>
            <tr>
                <td>用户名：</td>
                <td><input type="text" name="username" required></td>
            </tr>
            <tr>
                <td>邮箱：</td>
                <td><input type="email" name="email" required></td>
            </tr>
            <tr>
                <td>密码：</td>
                <td><input type="password" name="password" required></td>
            </tr>
            <tr>
                <td colspan="2">
                    <input type="submit" value="注册">
                    <input type="reset" value="重置">
                </td>
            </tr>
        </table>
    </form>
</body>
</html>
```

**注册处理页面（registerProcess.jsp）**：
```jsp
<%@ page import="java.sql.*" %>
<%@ page pageEncoding="UTF-8" %>

<%
    // 获取表单数据
    String username = request.getParameter("username");
    String email = request.getParameter("email");
    String password = request.getParameter("password");
    
    // 数据库连接信息
    String url = "jdbc:mysql://localhost:3306/testdb";
    String dbUsername = "root";
    String dbPassword = "123456";
    
    Connection conn = null;
    PreparedStatement pstmt = null;
    
    try {
        Class.forName("com.mysql.cj.jdbc.Driver");
        conn = DriverManager.getConnection(url, dbUsername, dbPassword);
        
        // 插入数据的SQL语句
        String sql = "INSERT INTO users(name, email, password, create_time) VALUES(?, ?, ?, NOW())";
        pstmt = conn.prepareStatement(sql);
        
        // 设置参数（防止SQL注入）
        pstmt.setString(1, username);
        pstmt.setString(2, email);
        pstmt.setString(3, password);
        
        // 执行插入操作
        int result = pstmt.executeUpdate();
        
        if(result > 0) {
%>
            <h2>✅ 注册成功！</h2>
            <p>欢迎 <strong><%= username %></strong>！</p>
            <p><a href="userList.jsp">查看用户列表</a></p>
<%
        } else {
%>
            <h2>❌ 注册失败！</h2>
            <p><a href="register.html">返回重新注册</a></p>
<%
        }
        
    } catch(SQLException e) {
        if(e.getErrorCode() == 1062) { // MySQL重复键错误
%>
            <h2>⚠️ 注册失败：用户名或邮箱已存在！</h2>
<%
        } else {
%>
            <h2>❌ 数据库错误：<%= e.getMessage() %></h2>
<%
        }
    } catch(Exception e) {
%>
        <h2>❌ 系统错误：<%= e.getMessage() %></h2>
<%
    } finally {
        if(pstmt != null) pstmt.close();
        if(conn != null) conn.close();
    }
%>
```

### 3.2 批量插入操作


> 🎯 **实际场景**：比如导入一批学生信息，一次性插入多条记录

```jsp
<%
    // 模拟批量插入多个用户
    String[] names = {"小明", "小红", "小刚"};
    String[] emails = {"xiaoming@qq.com", "xiaohong@qq.com", "xiaogang@qq.com"};
    
    try {
        conn = DriverManager.getConnection(url, username, password);
        
        // 关闭自动提交，开启事务
        conn.setAutoCommit(false);
        
        String sql = "INSERT INTO users(name, email, password, create_time) VALUES(?, ?, '123456', NOW())";
        pstmt = conn.prepareStatement(sql);
        
        // 循环插入
        for(int i = 0; i < names.length; i++) {
            pstmt.setString(1, names[i]);
            pstmt.setString(2, emails[i]);
            pstmt.addBatch(); // 添加到批处理
        }
        
        // 执行批处理
        int[] results = pstmt.executeBatch();
        
        // 提交事务
        conn.commit();
        
        out.println("✅ 批量插入成功，共插入 " + results.length + " 条记录");
        
    } catch(Exception e) {
        conn.rollback(); // 出错时回滚
        out.println("❌ 批量插入失败：" + e.getMessage());
    }
%>
```

---

## 4. ✏️ 数据更新操作实现


### 4.1 用户信息修改功能


> 💡 **生活类比**：更新数据就像修改你的个人资料 - 改个头像、更新电话号码等

**修改用户信息表单**：
```jsp
<%-- editUser.jsp - 修改用户信息 --%>
<%
    // 获取要修改的用户ID
    String userId = request.getParameter("id");
    
    if(userId != null) {
        try {
            conn = DriverManager.getConnection(url, username, password);
            
            // 先查询当前用户信息
            String sql = "SELECT * FROM users WHERE id = ?";
            PreparedStatement pstmt = conn.prepareStatement(sql);
            pstmt.setInt(1, Integer.parseInt(userId));
            ResultSet rs = pstmt.executeQuery();
            
            if(rs.next()) {
%>

<h2>✏️ 修改用户信息</h2>

<form action="updateUser.jsp" method="post">
    <input type="hidden" name="id" value="<%= rs.getInt("id") %>">
    
    <table>
        <tr>
            <td>用户名：</td>
            <td><input type="text" name="username" value="<%= rs.getString("name") %>" required></td>
        </tr>
        <tr>
            <td>邮箱：</td>
            <td><input type="email" name="email" value="<%= rs.getString("email") %>" required></td>
        </tr>
        <tr>
            <td colspan="2">
                <input type="submit" value="保存修改">
                <input type="button" value="取消" onclick="history.back()">
            </td>
        </tr>
    </table>
</form>

<%
            } else {
                out.println("❌ 未找到该用户！");
            }
        } catch(Exception e) {
            out.println("❌ 查询用户信息失败：" + e.getMessage());
        }
    }
%>
```

**更新处理页面（updateUser.jsp）**：
```jsp
<%
    // 获取表单数据
    String id = request.getParameter("id");
    String username = request.getParameter("username");
    String email = request.getParameter("email");
    
    if(id != null && username != null && email != null) {
        try {
            conn = DriverManager.getConnection(url, dbUsername, dbPassword);
            
            // 更新SQL语句
            String sql = "UPDATE users SET name = ?, email = ? WHERE id = ?";
            PreparedStatement pstmt = conn.prepareStatement(sql);
            
            pstmt.setString(1, username);
            pstmt.setString(2, email);
            pstmt.setInt(3, Integer.parseInt(id));
            
            // 执行更新
            int result = pstmt.executeUpdate();
            
            if(result > 0) {
%>
                <h2>✅ 用户信息更新成功！</h2>
                <p>用户 <strong><%= username %></strong> 的信息已更新</p>
                <p><a href="userList.jsp">返回用户列表</a></p>
<%
            } else {
%>
                <h2>❌ 更新失败，用户不存在！</h2>
<%
            }
            
        } catch(Exception e) {
%>
            <h2>❌ 更新失败：<%= e.getMessage() %></h2>
<%
        }
    }
%>
```

### 4.2 批量更新操作


**批量修改用户状态示例**：
```jsp
<%
    // 批量激活用户账户
    String[] userIds = request.getParameterValues("userIds");
    
    if(userIds != null && userIds.length > 0) {
        try {
            conn = DriverManager.getConnection(url, username, password);
            
            String sql = "UPDATE users SET status = '激活' WHERE id = ?";
            PreparedStatement pstmt = conn.prepareStatement(sql);
            
            int updateCount = 0;
            for(String userId : userIds) {
                pstmt.setInt(1, Integer.parseInt(userId));
                updateCount += pstmt.executeUpdate();
            }
            
            out.println("✅ 成功激活 " + updateCount + " 个用户账户");
            
        } catch(Exception e) {
            out.println("❌ 批量更新失败：" + e.getMessage());
        }
    }
%>
```

---

## 5. 🗑️ 数据删除操作处理


### 5.1 单条记录删除


> 💡 **安全提醒**：删除操作要谨慎，就像扔垃圾一样 - 确认不要了再扔，扔了就找不回来了

**删除确认页面**：
```jsp
<%-- deleteConfirm.jsp - 删除确认 --%>
<%
    String userId = request.getParameter("id");
    String userName = request.getParameter("name");
%>

<h2>⚠️ 删除确认</h2>

<div style="border: 2px solid #ff6b6b; padding: 20px; margin: 20px; border-radius: 10px; background-color: #ffe0e0;">
    <h3>🚨 危险操作警告</h3>
    <p>您确定要删除用户 <strong style="color: red;"><%= userName %></strong> 吗？</p>
    <p><strong>注意：此操作无法撤销！</strong></p>
    
    <div style="margin-top: 20px;">
        <a href="deleteUser.jsp?id=<%= userId %>" 
           style="background-color: #ff4757; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px;"
           onclick="return confirm('最后确认：真的要删除吗？')">
           🗑️ 确认删除
        </a>
        
        <a href="userList.jsp" 
           style="background-color: #2ed573; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; margin-left: 10px;">
           ↩️ 取消删除
        </a>
    </div>
</div>
```

**删除处理页面（deleteUser.jsp）**：
```jsp
<%
    String userId = request.getParameter("id");
    
    if(userId != null) {
        try {
            conn = DriverManager.getConnection(url, username, password);
            
            // 先查询用户信息（用于显示删除结果）
            String selectSql = "SELECT name FROM users WHERE id = ?";
            PreparedStatement selectPstmt = conn.prepareStatement(selectSql);
            selectPstmt.setInt(1, Integer.parseInt(userId));
            ResultSet rs = selectPstmt.executeQuery();
            
            String userName = "";
            if(rs.next()) {
                userName = rs.getString("name");
            }
            
            // 执行删除操作
            String deleteSql = "DELETE FROM users WHERE id = ?";
            PreparedStatement deletePstmt = conn.prepareStatement(deleteSql);
            deletePstmt.setInt(1, Integer.parseInt(userId));
            
            int result = deletePstmt.executeUpdate();
            
            if(result > 0) {
%>
                <h2>✅ 删除成功</h2>
                <p>用户 <strong><%= userName %></strong> 已被删除</p>
<%
            } else {
%>
                <h2>❌ 删除失败</h2>
                <p>用户不存在或已被删除</p>
<%
            }
            
        } catch(Exception e) {
%>
            <h2>❌ 删除操作失败：<%= e.getMessage() %></h2>
<%
        }
    }
%>

<p><a href="userList.jsp">🔙 返回用户列表</a></p>
```

### 5.2 条件删除和批量删除


**根据条件删除（清理过期数据）**：
```jsp
<%
    // 删除30天前注册但未激活的用户
    try {
        conn = DriverManager.getConnection(url, username, password);
        
        String sql = "DELETE FROM users WHERE status = '未激活' AND create_time < DATE_SUB(NOW(), INTERVAL 30 DAY)";
        Statement stmt = conn.createStatement();
        
        int deletedCount = stmt.executeUpdate(sql);
        
        out.println("🧹 清理完成：删除了 " + deletedCount + " 个过期未激活账户");
        
    } catch(Exception e) {
        out.println("❌ 清理失败：" + e.getMessage());
    }
%>
```

**批量删除选中用户**：
```jsp
<%
    String[] selectedIds = request.getParameterValues("selectedUsers");
    
    if(selectedIds != null && selectedIds.length > 0) {
        try {
            conn = DriverManager.getConnection(url, username, password);
            conn.setAutoCommit(false); // 开启事务
            
            String sql = "DELETE FROM users WHERE id = ?";
            PreparedStatement pstmt = conn.prepareStatement(sql);
            
            int deleteCount = 0;
            for(String id : selectedIds) {
                pstmt.setInt(1, Integer.parseInt(id));
                deleteCount += pstmt.executeUpdate();
            }
            
            conn.commit(); // 提交事务
            out.println("✅ 批量删除成功：共删除 " + deleteCount + " 个用户");
            
        } catch(Exception e) {
            conn.rollback(); // 出错回滚
            out.println("❌ 批量删除失败：" + e.getMessage());
        }
    }
%>
```

---

## 6. 🛡️ PreparedStatement详解


### 6.1 什么是PreparedStatement


> 💡 **通俗比喻**：PreparedStatement就像填空题的模板 - 先准备好题目框架，再往空格里填答案

**PreparedStatement vs Statement对比**：

```
┌─────────────────┬─────────────────┬─────────────────┐
│     特性        │   Statement     │ PreparedStatement│
├─────────────────┼─────────────────┼─────────────────┤
│ SQL预编译       │     ❌ 否       │     ✅ 是       │
│ 防SQL注入       │     ❌ 否       │     ✅ 是       │
│ 参数化查询      │     ❌ 否       │     ✅ 是       │
│ 执行效率        │     较低        │     较高        │
│ 代码可读性      │     一般        │     较好        │
└─────────────────┴─────────────────┴─────────────────┘
```

### 6.2 PreparedStatement基本用法


**基本语法结构**：
```jsp
<%
    // ①准备SQL模板（用?作占位符）
    String sql = "SELECT * FROM users WHERE name = ? AND age > ?";
    
    // ②创建PreparedStatement对象
    PreparedStatement pstmt = conn.prepareStatement(sql);
    
    // ③设置参数值
    pstmt.setString(1, "张三");    // 第1个?设为"张三"
    pstmt.setInt(2, 18);         // 第2个?设为18
    
    // ④执行SQL
    ResultSet rs = pstmt.executeQuery();
%>
```

> 📌 **重要提醒**：参数编号从1开始，不是从0开始！

### 6.3 不同数据类型的参数设置


**常用参数设置方法**：
```jsp
<%
    PreparedStatement pstmt = conn.prepareStatement(
        "INSERT INTO users(name, age, salary, birthday, is_active) VALUES(?, ?, ?, ?, ?)"
    );
    
    // 字符串类型
    pstmt.setString(1, "李四");
    
    // 整数类型
    pstmt.setInt(2, 25);
    
    // 小数类型
    pstmt.setDouble(3, 5000.50);
    
    // 日期类型
    pstmt.setDate(4, java.sql.Date.valueOf("1998-05-15"));
    
    // 布尔类型
    pstmt.setBoolean(5, true);
    
    int result = pstmt.executeUpdate();
%>
```

### 6.4 PreparedStatement的复用


**提高查询效率的写法**：
```jsp
<%
    // 一次准备，多次使用
    String sql = "SELECT * FROM users WHERE age BETWEEN ? AND ?";
    PreparedStatement pstmt = conn.prepareStatement(sql);
    
    // 查询18-25岁的用户
    pstmt.setInt(1, 18);
    pstmt.setInt(2, 25);
    ResultSet rs1 = pstmt.executeQuery();
    out.println("18-25岁用户数量：" + getRowCount(rs1));
    
    // 查询26-35岁的用户（复用同一个PreparedStatement）
    pstmt.setInt(1, 26);
    pstmt.setInt(2, 35);
    ResultSet rs2 = pstmt.executeQuery();
    out.println("26-35岁用户数量：" + getRowCount(rs2));
    
    pstmt.close(); // 使用完毕后关闭
%>
```

---

## 7. 🔐 SQL注入防护机制


### 7.1 什么是SQL注入攻击


> 💡 **生活比喻**：SQL注入就像有人在你的表单里填入恶意代码，试图控制你的数据库，就像黑客试图骗过门卫进入大楼

**危险的用户输入示例**：
```
正常用户输入：张三
恶意用户输入：' OR '1'='1' --
```

### 7.2 SQL注入攻击示例


**容易被攻击的错误写法**：
```jsp
<%
    // ❌ 危险写法：直接拼接用户输入
    String username = request.getParameter("username");
    String password = request.getParameter("password");
    
    // 如果用户输入：username = "admin' --"
    // SQL就变成了：SELECT * FROM users WHERE name='admin' --' AND password='xxx'
    // --表示注释，后面的密码验证被注释掉了！
    String sql = "SELECT * FROM users WHERE name='" + username + "' AND password='" + password + "'";
    
    Statement stmt = conn.createStatement();
    ResultSet rs = stmt.executeQuery(sql); // 黑客成功登录！
%>
```

### 7.3 使用PreparedStatement防护


**安全的正确写法**：
```jsp
<%
    // ✅ 安全写法：使用参数化查询
    String username = request.getParameter("username");
    String password = request.getParameter("password");
    
    // SQL模板中用?占位符
    String sql = "SELECT * FROM users WHERE name = ? AND password = ?";
    PreparedStatement pstmt = conn.prepareStatement(sql);
    
    // 设置参数（自动转义特殊字符）
    pstmt.setString(1, username);  // 即使输入包含'也会被正确处理
    pstmt.setString(2, password);
    
    ResultSet rs = pstmt.executeQuery(); // 安全执行
%>
```

### 7.4 输入验证和清理


**多层防护策略**：
```jsp
<%
    String username = request.getParameter("username");
    
    // ①输入长度限制
    if(username.length() > 50) {
        out.println("❌ 用户名长度不能超过50个字符");
        return;
    }
    
    // ②检查特殊字符
    if(username.contains("'") || username.contains(";") || username.contains("--")) {
        out.println("❌ 用户名包含非法字符");
        return;
    }
    
    // ③使用正则表达式验证格式
    if(!username.matches("^[a-zA-Z0-9_\\u4e00-\\u9fa5]+$")) {
        out.println("❌ 用户名只能包含字母、数字、下划线和中文");
        return;
    }
    
    // ④使用PreparedStatement
    String sql = "SELECT * FROM users WHERE name = ?";
    PreparedStatement pstmt = conn.prepareStatement(sql);
    pstmt.setString(1, username);
    
    ResultSet rs = pstmt.executeQuery();
%>
```

> 🛡️ **安全建议**：永远不要相信用户的输入，多层验证才能确保安全

---

## 8. 💼 事务处理基础


### 8.1 什么是数据库事务


> 💡 **生活类比**：事务就像银行转账 - 要么全部成功（从A账户扣钱同时B账户加钱），要么全部失败（都不变），不能只做一半

**事务的四大特性（ACID）**：
```
┌───────────────┬──────────────────────────────────────┐
│     特性      │                含义                  │
├───────────────┼──────────────────────────────────────┤
│ A原子性       │ 要么全部成功，要么全部失败            │
│ (Atomicity)   │                                      │
├───────────────┼──────────────────────────────────────┤
│ C一致性       │ 事务前后数据保持一致状态              │
│ (Consistency) │                                      │
├───────────────┼──────────────────────────────────────┤
│ I隔离性       │ 多个事务之间不会相互干扰              │
│ (Isolation)   │                                      │
├───────────────┼──────────────────────────────────────┤
│ D持久性       │ 提交后的修改永久保存到数据库          │
│ (Durability)  │                                      │
└───────────────┴──────────────────────────────────────┘
```

### 8.2 基本事务操作


**转账功能示例**：
```jsp
<%-- transfer.jsp - 转账功能 --%>
<%
    // 获取转账信息
    String fromAccount = request.getParameter("from");     // 转出账户
    String toAccount = request.getParameter("to");         // 转入账户
    double amount = Double.parseDouble(request.getParameter("amount")); // 金额
    
    Connection conn = null;
    PreparedStatement pstmt = null;
    
    try {
        conn = DriverManager.getConnection(url, username, password);
        
        // ①关闭自动提交（开启事务）
        conn.setAutoCommit(false);
        
        // ②检查转出账户余额
        String checkSql = "SELECT balance FROM accounts WHERE account_id = ?";
        pstmt = conn.prepareStatement(checkSql);
        pstmt.setString(1, fromAccount);
        ResultSet rs = pstmt.executeQuery();
        
        if(rs.next()) {
            double balance = rs.getDouble("balance");
            if(balance < amount) {
                throw new Exception("余额不足！当前余额：" + balance);
            }
        } else {
            throw new Exception("转出账户不存在！");
        }
        
        // ③从转出账户扣钱
        String deductSql = "UPDATE accounts SET balance = balance - ? WHERE account_id = ?";
        pstmt = conn.prepareStatement(deductSql);
        pstmt.setDouble(1, amount);
        pstmt.setString(2, fromAccount);
        
        if(pstmt.executeUpdate() != 1) {
            throw new Exception("转出账户扣款失败！");
        }
        
        // ④向转入账户加钱
        String addSql = "UPDATE accounts SET balance = balance + ? WHERE account_id = ?";
        pstmt = conn.prepareStatement(addSql);
        pstmt.setDouble(1, amount);
        pstmt.setString(2, toAccount);
        
        if(pstmt.executeUpdate() != 1) {
            throw new Exception("转入账户加款失败！");
        }
        
        // ⑤提交事务
        conn.commit();
        
%>
        <h2>✅ 转账成功！</h2>
        <p>从账户 <strong><%= fromAccount %></strong> 向账户 <strong><%= toAccount %></strong> 转账 <strong><%= amount %>元</strong></p>
<%
        
    } catch(Exception e) {
        try {
            // ⑥出错时回滚事务
            if(conn != null) {
                conn.rollback();
            }
        } catch(SQLException se) {
            se.printStackTrace();
        }
%>
        <h2>❌ 转账失败！</h2>
        <p>错误原因：<%= e.getMessage() %></p>
<%
    } finally {
        try {
            // ⑦恢复自动提交
            if(conn != null) {
                conn.setAutoCommit(true);
                conn.close();
            }
        } catch(SQLException se) {
            se.printStackTrace();
        }
    }
%>
```

### 8.3 事务的常见应用场景


**① 订单处理事务**：
```jsp
<%
    // 用户下单需要：扣减库存 + 创建订单 + 扣款
    try {
        conn.setAutoCommit(false);
        
        // 扣减商品库存
        String updateStock = "UPDATE products SET stock = stock - ? WHERE product_id = ?";
        // ...执行库存扣减
        
        // 创建订单记录
        String createOrder = "INSERT INTO orders(user_id, product_id, quantity, total_price) VALUES(?, ?, ?, ?)";
        // ...创建订单
        
        // 用户账户扣款
        String deductMoney = "UPDATE user_accounts SET balance = balance - ? WHERE user_id = ?";
        // ...执行扣款
        
        conn.commit(); // 全部成功才提交
        out.println("✅ 订单创建成功！");
        
    } catch(Exception e) {
        conn.rollback(); // 任何步骤失败都回滚
        out.println("❌ 下单失败：" + e.getMessage());
    }
%>
```

**② 用户注册事务**：
```jsp
<%
    // 用户注册需要：创建用户记录 + 创建用户配置 + 发送欢迎邮件记录
    try {
        conn.setAutoCommit(false);
        
        // 创建用户记录
        String createUser = "INSERT INTO users(username, email, password) VALUES(?, ?, ?)";
        // ...
        
        // 创建用户配置
        String createConfig = "INSERT INTO user_configs(user_id, theme, language) VALUES(?, 'default', 'zh-CN')";
        // ...
        
        // 记录欢迎邮件发送
        String logEmail = "INSERT INTO email_logs(user_id, email_type, status) VALUES(?, 'welcome', 'sent')";
        // ...
        
        conn.commit();
        out.println("✅ 注册成功！");
        
    } catch(Exception e) {
        conn.rollback();
        out.println("❌ 注册失败：" + e.getMessage());
    }
%>
```

### 8.4 事务隔离级别


**四种隔离级别说明**：
```
┌─────────────────┬──────────────────────────────────────┐
│   隔离级别       │                 说明                 │
├─────────────────┼──────────────────────────────────────┤
│ READ_UNCOMMITTED│ 最低级别，可能读到未提交的数据        │
│ (读未提交)       │                                      │
├─────────────────┼──────────────────────────────────────┤
│ READ_COMMITTED  │ 只能读到已提交的数据（Oracle默认）    │
│ (读已提交)       │                                      │
├─────────────────┼──────────────────────────────────────┤
│ REPEATABLE_READ │ 同一事务中多次读取结果一致（MySQL默认）│
│ (可重复读)       │                                      │
├─────────────────┼──────────────────────────────────────┤
│ SERIALIZABLE    │ 最高级别，事务串行执行，安全但慢      │
│ (串行化)         │                                      │
└─────────────────┴──────────────────────────────────────┘
```

```jsp
<%
    // 设置事务隔离级别
    conn.setTransactionIsolation(Connection.TRANSACTION_READ_COMMITTED);
    
    // 在需要高一致性的场景中使用更高的隔离级别
    conn.setTransactionIsolation(Connection.TRANSACTION_REPEATABLE_READ);
%>
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的核心概念


```
🔸 CRUD操作：Create创建、Read读取、Update更新、Delete删除
🔸 PreparedStatement：预编译SQL语句，防止SQL注入的利器
🔸 SQL注入防护：永远不要直接拼接用户输入到SQL中
🔸 事务处理：保证数据操作的完整性和一致性
🔸 连接管理：及时关闭数据库连接，避免资源泄漏
```

### 9.2 关键理解要点


**🔹 为什么要使用PreparedStatement**
```
性能优势：
- SQL预编译，重复执行时效率更高
- 数据库可以缓存执行计划

安全优势：
- 自动转义特殊字符，防止SQL注入
- 参数化查询，代码更安全可靠

维护优势：
- 代码更清晰，参数设置更直观
- 减少字符串拼接错误
```

**🔹 事务什么时候必须使用**
```
必须使用事务的场景：
✅ 多个相关操作必须同时成功或失败（转账、订单）
✅ 数据一致性要求很高的业务逻辑
✅ 批量操作需要保证完整性

可以不用事务的场景：
⭕ 单独的查询操作
⭕ 独立的增删改操作
⭕ 日志记录等不重要的操作
```

**🔹 SQL注入防护的层次化策略**
```
第一层：输入验证
- 长度限制、格式检查、特殊字符过滤

第二层：参数化查询
- 使用PreparedStatement，永远不要字符串拼接

第三层：权限控制
- 数据库用户权限最小化
- 不同功能使用不同的数据库用户

第四层：监控告警
- 监控异常SQL执行
- 记录可疑操作日志
```

### 9.3 实际应用指导


**💻 开发最佳实践**
```
连接管理：
- 使用连接池而不是每次创建新连接
- 在finally块中确保连接关闭
- 合理设置连接超时时间

错误处理：
- 详细的异常日志记录
- 用户友好的错误信息显示
- 区分系统错误和业务错误

性能优化：
- 合理使用索引
- 避免在循环中执行数据库操作
- 使用批量操作提高效率
```

**🛡️ 安全注意事项**
```
数据验证：
- 服务端必须进行数据验证
- 不要仅依赖前端验证
- 对所有用户输入进行检查

权限控制：
- 实现细粒度的权限控制
- 定期审查数据库权限
- 使用HTTPS传输敏感数据

日志审计：
- 记录所有数据库操作日志
- 监控异常访问行为
- 定期备份重要数据
```

### 9.4 常见错误和解决方案


**❌ 常见错误列表**：
```
1. 忘记关闭数据库连接 → 导致连接池耗尽
   解决：使用try-with-resources或finally块

2. SQL注入漏洞 → 数据库被攻击
   解决：使用PreparedStatement参数化查询

3. 事务未正确提交或回滚 → 数据不一致
   解决：在finally中确保连接状态恢复

4. 并发访问冲突 → 数据覆盖或丢失
   解决：合理设置事务隔离级别

5. 异常处理不当 → 系统崩溃或信息泄漏
   解决：细致的异常处理和日志记录
```

### 9.5 学习进阶建议


**📈 进阶学习路径**：
```
初级阶段：
✅ 掌握基本CRUD操作
✅ 理解PreparedStatement用法
✅ 学会基本的事务处理

中级阶段：
📚 学习连接池技术（C3P0、Druid）
📚 掌握ORM框架（MyBatis）
📚 了解数据库设计原则

高级阶段：
🚀 分布式事务处理
🚀 数据库性能优化
🚀 缓存技术应用
```

**核心记忆口诀**：
- 增删改查记心间，PreparedStatement保安全
- 事务处理要完整，要么全成要么全败
- 用户输入不可信，层层防护才安心
- 连接资源要管好，及时关闭不能少