---
title: 3ã€äº‹åŠ¡åœºæ™¯å®æˆ˜
---
## ğŸ“š ç›®å½•

1. [äº‹åŠ¡å®æˆ˜æ¦‚è¿°](#1-äº‹åŠ¡å®æˆ˜æ¦‚è¿°)
2. [ä¸‹å•æ‰£åº“å­˜åœºæ™¯](#2-ä¸‹å•æ‰£åº“å­˜åœºæ™¯)
3. [è½¬è´¦ä¸šåŠ¡äº‹åŠ¡](#3-è½¬è´¦ä¸šåŠ¡äº‹åŠ¡)
4. [å¹¶å‘æ§åˆ¶æ¼”ç¤º](#4-å¹¶å‘æ§åˆ¶æ¼”ç¤º)
5. [æ­»é”åœºæ™¯å¤ç°](#5-æ­»é”åœºæ™¯å¤ç°)
6. [éš”ç¦»çº§åˆ«éªŒè¯](#6-éš”ç¦»çº§åˆ«éªŒè¯)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ äº‹åŠ¡å®æˆ˜æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯äº‹åŠ¡åœºæ™¯å®æˆ˜


**é€šä¿—ç†è§£**ï¼š
æƒ³è±¡ä½ åœ¨é“¶è¡ŒåŠç†ä¸šåŠ¡ï¼Œå¦‚æœè½¬è´¦è¿‡ç¨‹ä¸­åœç”µäº†ï¼Œä½ çš„é’±ä¸èƒ½å‡­ç©ºæ¶ˆå¤±ï¼Œä¹Ÿä¸èƒ½é‡å¤æ‰£æ¬¾ã€‚è¿™å°±éœ€è¦äº‹åŠ¡æ¥ä¿è¯æ“ä½œçš„å®Œæ•´æ€§ã€‚

**äº‹åŠ¡çš„ä½œç”¨**ï¼š
```
ç”Ÿæ´»åœºæ™¯                    æ•°æ®åº“äº‹åŠ¡
â”œâ”€ è½¬è´¦æ±‡æ¬¾                â”œâ”€ è´¦æˆ·ä½™é¢ä¿®æ”¹
â”œâ”€ ç½‘è´­ä¸‹å•                â”œâ”€ åº“å­˜æ‰£å‡+è®¢å•ç”Ÿæˆ
â”œâ”€ é€€è´§é€€æ¬¾                â”œâ”€ åº“å­˜æ¢å¤+èµ„é‡‘è¿”è¿˜
â””â”€ ä¼šå‘˜ç§¯åˆ†                â””â”€ ç§¯åˆ†å¢å‡+ç­‰çº§è°ƒæ•´
```

### 1.2 ä¸ºä»€ä¹ˆè¦å­¦äº‹åŠ¡å®æˆ˜


**æ ¸å¿ƒé—®é¢˜**ï¼š
- ğŸ¤” **æ•°æ®ä¸€è‡´æ€§**ï¼šå¦‚ä½•ä¿è¯ç›¸å…³æ•°æ®åŒæ—¶æˆåŠŸæˆ–åŒæ—¶å¤±è´¥ï¼Ÿ
- ğŸ¤” **å¹¶å‘å®‰å…¨**ï¼šå¤šç”¨æˆ·åŒæ—¶æ“ä½œæ—¶å¦‚ä½•é¿å…æ•°æ®æ··ä¹±ï¼Ÿ
- ğŸ¤” **å¼‚å¸¸å¤„ç†**ï¼šå‡ºç°é”™è¯¯æ—¶å¦‚ä½•æ­£ç¡®å›æ»šï¼Ÿ

**å®æˆ˜ä»·å€¼**ï¼š
```
æŒæ¡äº‹åŠ¡ = è§£å†³ä»¥ä¸‹é—®é¢˜ï¼š
âœ… é˜²æ­¢æ•°æ®ä¸ä¸€è‡´
âœ… å¤„ç†å¹¶å‘å†²çª
âœ… ä¿è¯ä¸šåŠ¡å®Œæ•´æ€§
âœ… æå‡ç³»ç»Ÿå¯é æ€§
```

---

## 2. ğŸ›’ ä¸‹å•æ‰£åº“å­˜åœºæ™¯


### 2.1 ä¸šåŠ¡åœºæ™¯åˆ†æ


**å…¸å‹ç”µå•†ä¸‹å•æµç¨‹**ï¼š
```
ç”¨æˆ·æ“ä½œæµç¨‹ï¼š
[é€‰æ‹©å•†å“] â†’ [åŠ å…¥è´­ç‰©è½¦] â†’ [ç¡®è®¤ä¸‹å•] â†’ [æ”¯ä»˜æˆåŠŸ]

åå°æ•°æ®æ“ä½œï¼š
[æ£€æŸ¥åº“å­˜] â†’ [æ‰£å‡åº“å­˜] â†’ [ç”Ÿæˆè®¢å•] â†’ [æ›´æ–°ç”¨æˆ·ç§¯åˆ†]
```

**æ ¸å¿ƒæŒ‘æˆ˜**ï¼š
- åº“å­˜ä¸è¶³æ—¶ä¸èƒ½ä¸‹å•
- æ‰£åº“å­˜å’Œç”Ÿæˆè®¢å•å¿…é¡»åŒæ—¶æˆåŠŸ
- é˜²æ­¢è¶…å–ï¼ˆåº“å­˜å˜è´Ÿæ•°ï¼‰

### 2.2 æ•°æ®è¡¨è®¾è®¡


```sql
-- å•†å“è¡¨
CREATE TABLE products (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL COMMENT 'å•†å“åç§°',
    price DECIMAL(10,2) NOT NULL COMMENT 'å•†å“ä»·æ ¼',
    stock INT NOT NULL DEFAULT 0 COMMENT 'åº“å­˜æ•°é‡'
);

-- è®¢å•è¡¨  
CREATE TABLE orders (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL COMMENT 'ç”¨æˆ·ID',
    product_id INT NOT NULL COMMENT 'å•†å“ID',
    quantity INT NOT NULL COMMENT 'è´­ä¹°æ•°é‡',
    total_price DECIMAL(10,2) NOT NULL COMMENT 'æ€»ä»·',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 2.3 äº‹åŠ¡å®ç°ä»£ç 


```java
public class OrderService {
    private Connection conn;
    
    // ä¸‹å•æ ¸å¿ƒæ–¹æ³•
    public boolean createOrder(int userId, int productId, int quantity) {
        try {
            // å¼€å¯äº‹åŠ¡
            conn.setAutoCommit(false);
            
            // æ­¥éª¤1ï¼šæ£€æŸ¥åº“å­˜
            if (!checkStock(productId, quantity)) {
                throw new RuntimeException("åº“å­˜ä¸è¶³ï¼");
            }
            
            // æ­¥éª¤2ï¼šæ‰£å‡åº“å­˜
            updateStock(productId, quantity);
            
            // æ­¥éª¤3ï¼šåˆ›å»ºè®¢å•
            createOrderRecord(userId, productId, quantity);
            
            // å…¨éƒ¨æˆåŠŸï¼Œæäº¤äº‹åŠ¡
            conn.commit();
            return true;
            
        } catch (Exception e) {
            try {
                // å‘ç”Ÿå¼‚å¸¸ï¼Œå›æ»šäº‹åŠ¡
                conn.rollback();
                System.out.println("ä¸‹å•å¤±è´¥ï¼Œå·²å›æ»šï¼š" + e.getMessage());
            } catch (SQLException rollbackEx) {
                rollbackEx.printStackTrace();
            }
            return false;
        }
    }
    
    // æ£€æŸ¥åº“å­˜æ–¹æ³•
    private boolean checkStock(int productId, int quantity) throws SQLException {
        String sql = "SELECT stock FROM products WHERE id = ?";
        PreparedStatement pstmt = conn.prepareStatement(sql);
        pstmt.setInt(1, productId);
        
        ResultSet rs = pstmt.executeQuery();
        if (rs.next()) {
            int currentStock = rs.getInt("stock");
            return currentStock >= quantity; // åº“å­˜è¶³å¤Ÿè¿”å›true
        }
        return false;
    }
    
    // æ‰£å‡åº“å­˜æ–¹æ³•
    private void updateStock(int productId, int quantity) throws SQLException {
        String sql = "UPDATE products SET stock = stock - ? WHERE id = ?";
        PreparedStatement pstmt = conn.prepareStatement(sql);
        pstmt.setInt(1, quantity);
        pstmt.setInt(2, productId);
        
        int affected = pstmt.executeUpdate();
        if (affected == 0) {
            throw new RuntimeException("åº“å­˜æ›´æ–°å¤±è´¥");
        }
    }
}
```

### 2.4 åœºæ™¯æµ‹è¯•éªŒè¯


**æµ‹è¯•åœºæ™¯1ï¼šæ­£å¸¸ä¸‹å•**
```java
// æµ‹è¯•æ­£å¸¸ä¸‹å•æµç¨‹
@Test
public void testNormalOrder() {
    OrderService service = new OrderService();
    boolean result = service.createOrder(1001, 2001, 5);
    assertTrue("ä¸‹å•åº”è¯¥æˆåŠŸ", result);
}
```

**æµ‹è¯•åœºæ™¯2ï¼šåº“å­˜ä¸è¶³**
```java
// æµ‹è¯•åº“å­˜ä¸è¶³åœºæ™¯
@Test
public void testInsufficientStock() {
    OrderService service = new OrderService();
    // å°è¯•è´­ä¹°è¶…è¿‡åº“å­˜çš„æ•°é‡
    boolean result = service.createOrder(1001, 2001, 1000);
    assertFalse("åº“å­˜ä¸è¶³åº”è¯¥ä¸‹å•å¤±è´¥", result);
}
```

---

## 3. ğŸ’° è½¬è´¦ä¸šåŠ¡äº‹åŠ¡


### 3.1 è½¬è´¦ä¸šåŠ¡åˆ†æ


**è½¬è´¦æ ¸å¿ƒé€»è¾‘**ï¼š
```
è½¬è´¦æ“ä½œ = ä¸¤ä¸ªæ­¥éª¤ï¼š
æ­¥éª¤1ï¼šä»è½¬å‡ºè´¦æˆ·æ‰£é’±
æ­¥éª¤2ï¼šç»™è½¬å…¥è´¦æˆ·åŠ é’±

è¦æ±‚ï¼šä¸¤æ­¥å¿…é¡»éƒ½æˆåŠŸï¼Œå¦åˆ™éƒ½ä¸æ‰§è¡Œ
```

**ä¸šåŠ¡è§„åˆ™**ï¼š
- è½¬å‡ºè´¦æˆ·ä½™é¢å¿…é¡»è¶³å¤Ÿ
- è½¬è´¦é‡‘é¢å¿…é¡»å¤§äº0
- ä¸¤ä¸ªè´¦æˆ·å¿…é¡»éƒ½å­˜åœ¨
- æ“ä½œè¿‡ç¨‹è®°å½•è½¬è´¦æµæ°´

### 3.2 è´¦æˆ·è¡¨è®¾è®¡


```sql
-- è´¦æˆ·è¡¨
CREATE TABLE accounts (
    id INT PRIMARY KEY AUTO_INCREMENT,
    account_no VARCHAR(20) UNIQUE NOT NULL COMMENT 'è´¦æˆ·å·',
    user_name VARCHAR(50) NOT NULL COMMENT 'ç”¨æˆ·å§“å',
    balance DECIMAL(15,2) NOT NULL DEFAULT 0.00 COMMENT 'è´¦æˆ·ä½™é¢'
);

-- è½¬è´¦è®°å½•è¡¨
CREATE TABLE transfer_records (
    id INT PRIMARY KEY AUTO_INCREMENT,
    from_account VARCHAR(20) NOT NULL COMMENT 'è½¬å‡ºè´¦æˆ·',
    to_account VARCHAR(20) NOT NULL COMMENT 'è½¬å…¥è´¦æˆ·', 
    amount DECIMAL(15,2) NOT NULL COMMENT 'è½¬è´¦é‡‘é¢',
    status VARCHAR(10) DEFAULT 'SUCCESS' COMMENT 'çŠ¶æ€',
    transfer_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 3.3 è½¬è´¦äº‹åŠ¡å®ç°


```java
public class TransferService {
    private Connection conn;
    
    /**
     * è½¬è´¦æ ¸å¿ƒæ–¹æ³•
     * @param fromAccount è½¬å‡ºè´¦æˆ·
     * @param toAccount è½¬å…¥è´¦æˆ·  
     * @param amount è½¬è´¦é‡‘é¢
     */
    public boolean transfer(String fromAccount, String toAccount, BigDecimal amount) {
        try {
            // å¼€å¯äº‹åŠ¡
            conn.setAutoCommit(false);
            
            // ç¬¬1æ­¥ï¼šéªŒè¯è½¬è´¦æ¡ä»¶
            validateTransfer(fromAccount, toAccount, amount);
            
            // ç¬¬2æ­¥ï¼šè½¬å‡ºè´¦æˆ·æ‰£æ¬¾
            debitAccount(fromAccount, amount);
            
            // ç¬¬3æ­¥ï¼šè½¬å…¥è´¦æˆ·åŠ æ¬¾
            creditAccount(toAccount, amount);
            
            // ç¬¬4æ­¥ï¼šè®°å½•è½¬è´¦æµæ°´
            recordTransfer(fromAccount, toAccount, amount);
            
            // æäº¤äº‹åŠ¡
            conn.commit();
            System.out.println("è½¬è´¦æˆåŠŸï¼");
            return true;
            
        } catch (Exception e) {
            try {
                conn.rollback();
                System.out.println("è½¬è´¦å¤±è´¥ï¼Œå·²å›æ»šï¼š" + e.getMessage());
            } catch (SQLException ex) {
                ex.printStackTrace();
            }
            return false;
        }
    }
    
    // éªŒè¯è½¬è´¦æ¡ä»¶
    private void validateTransfer(String from, String to, BigDecimal amount) 
            throws SQLException {
        if (amount.compareTo(BigDecimal.ZERO) <= 0) {
            throw new RuntimeException("è½¬è´¦é‡‘é¢å¿…é¡»å¤§äº0");
        }
        
        // æ£€æŸ¥è½¬å‡ºè´¦æˆ·ä½™é¢
        BigDecimal balance = getAccountBalance(from);
        if (balance.compareTo(amount) < 0) {
            throw new RuntimeException("è´¦æˆ·ä½™é¢ä¸è¶³");
        }
    }
    
    // æ‰£æ¬¾æ“ä½œ
    private void debitAccount(String accountNo, BigDecimal amount) 
            throws SQLException {
        String sql = "UPDATE accounts SET balance = balance - ? WHERE account_no = ?";
        PreparedStatement pstmt = conn.prepareStatement(sql);
        pstmt.setBigDecimal(1, amount);
        pstmt.setString(2, accountNo);
        pstmt.executeUpdate();
    }
    
    // åŠ æ¬¾æ“ä½œ  
    private void creditAccount(String accountNo, BigDecimal amount) 
            throws SQLException {
        String sql = "UPDATE accounts SET balance = balance + ? WHERE account_no = ?";
        PreparedStatement pstmt = conn.prepareStatement(sql);
        pstmt.setBigDecimal(1, amount);
        pstmt.setString(2, accountNo);
        pstmt.executeUpdate();
    }
}
```

### 3.4 è½¬è´¦å¼‚å¸¸å¤„ç†


**å¸¸è§å¼‚å¸¸åœºæ™¯**ï¼š

| å¼‚å¸¸æƒ…å†µ | **å¤„ç†æ–¹å¼** | **ç”¨æˆ·æç¤º** |
|---------|------------|-------------|
| ğŸš« **ä½™é¢ä¸è¶³** | `ç«‹å³å›æ»šäº‹åŠ¡` | `"è´¦æˆ·ä½™é¢ä¸è¶³ï¼Œè½¬è´¦å¤±è´¥"` |
| ğŸš« **è´¦æˆ·ä¸å­˜åœ¨** | `ç«‹å³å›æ»šäº‹åŠ¡` | `"ç›®æ ‡è´¦æˆ·ä¸å­˜åœ¨"` |
| ğŸš« **ç½‘ç»œå¼‚å¸¸** | `è‡ªåŠ¨å›æ»šäº‹åŠ¡` | `"ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•"` |
| ğŸš« **æ•°æ®åº“é”è¶…æ—¶** | `å›æ»šå¹¶é‡è¯•` | `"ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•"` |

---

## 4. ğŸ”„ å¹¶å‘æ§åˆ¶æ¼”ç¤º


### 4.1 å¹¶å‘é—®é¢˜åœºæ™¯


**å…¸å‹å¹¶å‘é—®é¢˜**ï¼š
```
åœºæ™¯ï¼šä¸¤ä¸ªç”¨æˆ·åŒæ—¶æŠ¢è´­æœ€å1ä»¶å•†å“

æ—¶é—´çº¿ï¼š
T1: ç”¨æˆ·AæŸ¥è¯¢åº“å­˜ â†’ æ˜¾ç¤ºè¿˜æœ‰1ä»¶
T2: ç”¨æˆ·BæŸ¥è¯¢åº“å­˜ â†’ æ˜¾ç¤ºè¿˜æœ‰1ä»¶  
T3: ç”¨æˆ·Aæäº¤è®¢å• â†’ åº“å­˜å˜ä¸º0
T4: ç”¨æˆ·Bæäº¤è®¢å• â†’ åº“å­˜å˜ä¸º-1 âŒè¶…å–äº†ï¼
```

### 4.2 è§£å†³æ–¹æ¡ˆå¯¹æ¯”


**æ–¹æ¡ˆ1ï¼šæ‚²è§‚é”ï¼ˆSELECT FOR UPDATEï¼‰**
```java
// æŸ¥è¯¢æ—¶å°±é”ä½æ•°æ®
public boolean buyWithPessimisticLock(int productId, int quantity) {
    try {
        conn.setAutoCommit(false);
        
        // æ‚²è§‚é”ï¼šæŸ¥è¯¢æ—¶é”ä½è®°å½•
        String sql = "SELECT stock FROM products WHERE id = ? FOR UPDATE";
        PreparedStatement pstmt = conn.prepareStatement(sql);
        pstmt.setInt(1, productId);
        ResultSet rs = pstmt.executeQuery();
        
        if (rs.next()) {
            int stock = rs.getInt("stock");
            if (stock >= quantity) {
                // åº“å­˜è¶³å¤Ÿï¼Œæ‰§è¡Œæ‰£åº“å­˜
                updateStock(productId, quantity);
                conn.commit();
                return true;
            }
        }
        
        conn.rollback();
        return false;
        
    } catch (SQLException e) {
        e.printStackTrace();
        return false;
    }
}
```

**æ–¹æ¡ˆ2ï¼šä¹è§‚é”ï¼ˆç‰ˆæœ¬å·æ§åˆ¶ï¼‰**
```java
// ä½¿ç”¨ç‰ˆæœ¬å·æ§åˆ¶çš„ä¹è§‚é”
public boolean buyWithOptimisticLock(int productId, int quantity) {
    try {
        conn.setAutoCommit(false);
        
        // ç¬¬1æ­¥ï¼šæŸ¥è¯¢å½“å‰åº“å­˜å’Œç‰ˆæœ¬å·
        String selectSql = "SELECT stock, version FROM products WHERE id = ?";
        PreparedStatement selectStmt = conn.prepareStatement(selectSql);
        selectStmt.setInt(1, productId);
        ResultSet rs = selectStmt.executeQuery();
        
        if (rs.next()) {
            int currentStock = rs.getInt("stock");
            int currentVersion = rs.getInt("version");
            
            if (currentStock >= quantity) {
                // ç¬¬2æ­¥ï¼šåŸºäºç‰ˆæœ¬å·æ›´æ–°
                String updateSql = "UPDATE products SET stock = stock - ?, " +
                        "version = version + 1 WHERE id = ? AND version = ?";
                PreparedStatement updateStmt = conn.prepareStatement(updateSql);
                updateStmt.setInt(1, quantity);
                updateStmt.setInt(2, productId);
                updateStmt.setInt(3, currentVersion);
                
                int affected = updateStmt.executeUpdate();
                if (affected > 0) {
                    conn.commit();
                    return true;
                } else {
                    // ç‰ˆæœ¬å·å˜äº†ï¼Œè¯´æ˜è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹äº†
                    conn.rollback();
                    System.out.println("å¹¶å‘å†²çªï¼Œè´­ä¹°å¤±è´¥");
                    return false;
                }
            }
        }
        
        conn.rollback();
        return false;
        
    } catch (SQLException e) {
        e.printStackTrace();
        return false;
    }
}
```

### 4.3 å¹¶å‘æµ‹è¯•æ¨¡æ‹Ÿ


```java
// æ¨¡æ‹Ÿå¹¶å‘æŠ¢è´­æµ‹è¯•
public class ConcurrencyTest {
    public static void main(String[] args) {
        // åˆ›å»º10ä¸ªçº¿ç¨‹æ¨¡æ‹Ÿç”¨æˆ·æŠ¢è´­
        int threadCount = 10;
        ExecutorService executor = Executors.newFixedThreadPool(threadCount);
        CountDownLatch latch = new CountDownLatch(threadCount);
        
        for (int i = 0; i < threadCount; i++) {
            final int userId = i + 1;
            executor.submit(() -> {
                try {
                    OrderService service = new OrderService();
                    boolean success = service.createOrder(userId, 1001, 1);
                    System.out.println("ç”¨æˆ·" + userId + "ï¼š" + 
                            (success ? "æŠ¢è´­æˆåŠŸ" : "æŠ¢è´­å¤±è´¥"));
                } finally {
                    latch.countDown();
                }
            });
        }
        
        try {
            latch.await(); // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ
            System.out.println("å¹¶å‘æµ‹è¯•å®Œæˆ");
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        
        executor.shutdown();
    }
}
```

---

## 5. âš ï¸ æ­»é”åœºæ™¯å¤ç°


### 5.1 æ­»é”äº§ç”ŸåŸç†


**ä»€ä¹ˆæ˜¯æ­»é”**ï¼š
æƒ³è±¡ä¸¤ä¸ªäººè¿‡ç‹¬æœ¨æ¡¥ï¼Œéƒ½ä¸è‚¯è®©æ­¥ï¼Œç»“æœè°ä¹Ÿè¿‡ä¸å»ã€‚åœ¨æ•°æ®åº“ä¸­ï¼Œå°±æ˜¯ä¸¤ä¸ªäº‹åŠ¡äº’ç›¸ç­‰å¾…å¯¹æ–¹é‡Šæ”¾é”ã€‚

**ç»å…¸æ­»é”åœºæ™¯**ï¼š
```
æ—¶é—´è½´ï¼šæ­»é”æ˜¯æ€æ ·äº§ç”Ÿçš„

äº‹åŠ¡A                    äº‹åŠ¡B
  â†“                        â†“
é”å®šè´¦æˆ·1                é”å®šè´¦æˆ·2
  â†“                        â†“
ç­‰å¾…é”å®šè´¦æˆ·2  â†â†’  ç­‰å¾…é”å®šè´¦æˆ·1
  â†“                        â†“
æ­»é”ï¼è°ä¹Ÿè¿›è¡Œä¸ä¸‹å»äº†
```

### 5.2 æ­»é”å¤ç°ä»£ç 


```java
public class DeadlockDemo {
    
    // æ¨¡æ‹Ÿæ­»é”åœºæ™¯ï¼šAè½¬ç»™Bï¼ŒBè½¬ç»™A
    public void demonstrateDeadlock() {
        // çº¿ç¨‹1ï¼šAå‘Bè½¬è´¦
        Thread thread1 = new Thread(() -> {
            TransferService service = new TransferService();
            service.transfer("A001", "B001", new BigDecimal("100"));
        }, "è½¬è´¦çº¿ç¨‹1");
        
        // çº¿ç¨‹2ï¼šBå‘Aè½¬è´¦  
        Thread thread2 = new Thread(() -> {
            TransferService service = new TransferService();
            service.transfer("B001", "A001", new BigDecimal("200"));
        }, "è½¬è´¦çº¿ç¨‹2");
        
        // åŒæ—¶å¯åŠ¨ä¸¤ä¸ªçº¿ç¨‹
        thread1.start();
        thread2.start();
        
        try {
            thread1.join();
            thread2.join();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
}
```

### 5.3 æ­»é”é¢„é˜²ç­–ç•¥


**ç­–ç•¥1ï¼šæŒ‰é¡ºåºåŠ é”**
```java
// æ€»æ˜¯æŒ‰å›ºå®šé¡ºåºé”å®šèµ„æº
public boolean transferWithOrder(String from, String to, BigDecimal amount) {
    // æŒ‰è´¦æˆ·å·å­—å…¸åºæ’åºï¼Œé¿å…æ­»é”
    String firstAccount = from.compareTo(to) < 0 ? from : to;
    String secondAccount = from.compareTo(to) < 0 ? to : from;
    
    synchronized(getLock(firstAccount)) {
        synchronized(getLock(secondAccount)) {
            // æ‰§è¡Œè½¬è´¦é€»è¾‘
            return doTransfer(from, to, amount);
        }
    }
}
```

**ç­–ç•¥2ï¼šè®¾ç½®è¶…æ—¶æ—¶é—´**
```java
// è®¾ç½®äº‹åŠ¡è¶…æ—¶
try {
    conn.setAutoCommit(false);
    // è®¾ç½®30ç§’è¶…æ—¶
    conn.setNetworkTimeout(Executors.newSingleThreadExecutor(), 30000);
    
    // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
    performBusinessLogic();
    
    conn.commit();
} catch (SQLException e) {
    if (e.getErrorCode() == 1205) { // MySQLæ­»é”é”™è¯¯ç 
        System.out.println("æ£€æµ‹åˆ°æ­»é”ï¼Œäº‹åŠ¡å·²å›æ»š");
    }
    conn.rollback();
}
```

---

## 6. ğŸ”’ éš”ç¦»çº§åˆ«éªŒè¯


### 6.1 éš”ç¦»çº§åˆ«æ¦‚å¿µå›é¡¾


**å››ç§éš”ç¦»çº§åˆ«**ï¼š
```
ğŸ“Š éš”ç¦»çº§åˆ«å¯¹æ¯”ï¼š

çº§åˆ«                 è„è¯»    ä¸å¯é‡å¤è¯»    å¹»è¯»
READ_UNCOMMITTED    å¯èƒ½      å¯èƒ½        å¯èƒ½  (æœ€å¿«ï¼Œæœ€ä¸å®‰å…¨)
READ_COMMITTED      ä¸ä¼š      å¯èƒ½        å¯èƒ½  (Oracleé»˜è®¤)  
REPEATABLE_READ     ä¸ä¼š      ä¸ä¼š        å¯èƒ½  (MySQLé»˜è®¤)
SERIALIZABLE        ä¸ä¼š      ä¸ä¼š        ä¸ä¼š  (æœ€å®‰å…¨ï¼Œæœ€æ…¢)
```

### 6.2 è„è¯»éªŒè¯å®éªŒ


```java
// éªŒè¯è„è¯»ç°è±¡
public class DirtyReadTest {
    
    // äº‹åŠ¡Aï¼šä¿®æ”¹ä½†ä¸æäº¤
    public void transactionA() {
        try {
            Connection conn = getConnection();
            conn.setAutoCommit(false);
            conn.setTransactionIsolation(Connection.TRANSACTION_READ_UNCOMMITTED);
            
            // ä¿®æ”¹è´¦æˆ·ä½™é¢ä½†ä¸æäº¤
            String sql = "UPDATE accounts SET balance = 999999 WHERE account_no = 'A001'";
            PreparedStatement pstmt = conn.prepareStatement(sql);
            pstmt.executeUpdate();
            
            System.out.println("äº‹åŠ¡Aï¼šå·²ä¿®æ”¹ä½™é¢ä¸º999999ï¼Œä½†æœªæäº¤");
            Thread.sleep(5000); // ç­‰å¾…5ç§’
            
            // å›æ»šäº‹åŠ¡
            conn.rollback();
            System.out.println("äº‹åŠ¡Aï¼šå·²å›æ»š");
            
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    // äº‹åŠ¡Bï¼šè¯»å–æ•°æ®
    public void transactionB() {
        try {
            Thread.sleep(2000); // ç­‰å¾…äº‹åŠ¡Aå…ˆæ‰§è¡Œ
            
            Connection conn = getConnection();
            conn.setTransactionIsolation(Connection.TRANSACTION_READ_UNCOMMITTED);
            
            String sql = "SELECT balance FROM accounts WHERE account_no = 'A001'";
            PreparedStatement pstmt = conn.prepareStatement(sql);
            ResultSet rs = pstmt.executeQuery();
            
            if (rs.next()) {
                BigDecimal balance = rs.getBigDecimal("balance");
                System.out.println("äº‹åŠ¡Bè¯»å–åˆ°ä½™é¢ï¼š" + balance);
                // å¦‚æœæ˜¯999999ï¼Œè¯´æ˜è¯»åˆ°äº†è„æ•°æ®
            }
            
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

### 6.3 ä¸å¯é‡å¤è¯»éªŒè¯


```java
// éªŒè¯ä¸å¯é‡å¤è¯»ç°è±¡
public class NonRepeatableReadTest {
    
    // äº‹åŠ¡Aï¼šå¤šæ¬¡è¯»å–åŒä¸€æ•°æ®
    public void transactionA() {
        try {
            Connection conn = getConnection();
            conn.setAutoCommit(false);
            conn.setTransactionIsolation(Connection.TRANSACTION_READ_COMMITTED);
            
            // ç¬¬ä¸€æ¬¡è¯»å–
            BigDecimal balance1 = getBalance(conn, "A001");
            System.out.println("äº‹åŠ¡Aç¬¬ä¸€æ¬¡è¯»å–ä½™é¢ï¼š" + balance1);
            
            Thread.sleep(3000); // ç­‰å¾…å…¶ä»–äº‹åŠ¡ä¿®æ”¹æ•°æ®
            
            // ç¬¬äºŒæ¬¡è¯»å–
            BigDecimal balance2 = getBalance(conn, "A001");  
            System.out.println("äº‹åŠ¡Aç¬¬äºŒæ¬¡è¯»å–ä½™é¢ï¼š" + balance2);
            
            if (!balance1.equals(balance2)) {
                System.out.println("å‘ç”Ÿäº†ä¸å¯é‡å¤è¯»ï¼");
            }
            
            conn.commit();
            
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    // äº‹åŠ¡Bï¼šä¿®æ”¹æ•°æ®
    public void transactionB() {
        try {
            Thread.sleep(1500); // åœ¨Aä¸¤æ¬¡è¯»å–ä¹‹é—´æ‰§è¡Œ
            
            Connection conn = getConnection();
            conn.setAutoCommit(false);
            
            String sql = "UPDATE accounts SET balance = balance + 1000 WHERE account_no = 'A001'";
            PreparedStatement pstmt = conn.prepareStatement(sql);
            pstmt.executeUpdate();
            
            conn.commit();
            System.out.println("äº‹åŠ¡Bï¼šå·²ä¿®æ”¹è´¦æˆ·ä½™é¢");
            
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

### 6.4 éš”ç¦»çº§åˆ«é€‰æ‹©å»ºè®®


**å®é™…åº”ç”¨å»ºè®®**ï¼š

| ä¸šåŠ¡åœºæ™¯ | **æ¨èéš”ç¦»çº§åˆ«** | **åŸå› ** |
|---------|-----------------|----------|
| ğŸ¦ **é“¶è¡Œè½¬è´¦** | `REPEATABLE_READ` | `éœ€è¦å¼ºä¸€è‡´æ€§` |
| ğŸ›’ **ç”µå•†ä¸‹å•** | `READ_COMMITTED` | `å¹³è¡¡æ€§èƒ½å’Œä¸€è‡´æ€§` |
| ğŸ“Š **æŠ¥è¡¨ç»Ÿè®¡** | `READ_COMMITTED` | `å…è®¸è¯»å–æœ€æ–°æ•°æ®` |
| ğŸ“ **ç”¨æˆ·è¯„è®º** | `READ_COMMITTED` | `å¯¹ä¸€è‡´æ€§è¦æ±‚ä¸é«˜` |
| ğŸ“ˆ **ç§’æ€æ´»åŠ¨** | `REPEATABLE_READ` | `é˜²æ­¢è¶…å–` |

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ¯ äº‹åŠ¡å®æˆ˜äº”å¤§æ ¸å¿ƒï¼š

1ï¸âƒ£ ä¸šåŠ¡å®Œæ•´æ€§ï¼šå¤šä¸ªæ“ä½œè¦ä¹ˆå…¨æˆåŠŸï¼Œè¦ä¹ˆå…¨å¤±è´¥
2ï¸âƒ£ å¹¶å‘æ§åˆ¶ï¼šæ‚²è§‚é”vsä¹è§‚é”ï¼Œé€‰æ‹©åˆé€‚çš„ç­–ç•¥  
3ï¸âƒ£ å¼‚å¸¸å¤„ç†ï¼štry-catch-rollbackï¼Œä¿è¯æ•°æ®å®‰å…¨
4ï¸âƒ£ æ­»é”é¢„é˜²ï¼šæŒ‰é¡ºåºåŠ é”ï¼Œè®¾ç½®è¶…æ—¶æ—¶é—´
5ï¸âƒ£ éš”ç¦»çº§åˆ«ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©åˆé€‚çº§åˆ«
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ äº‹åŠ¡è¾¹ç•Œçš„ç¡®å®š**
```
æ­£ç¡®çš„äº‹åŠ¡è¾¹ç•Œï¼š
âœ… ä¸€ä¸ªå®Œæ•´çš„ä¸šåŠ¡æ“ä½œ
âœ… ç›¸å…³çš„æ•°æ®ä¿®æ”¹
âœ… å¿…é¡»ä¿æŒä¸€è‡´çš„æ“ä½œ

é”™è¯¯çš„äº‹åŠ¡è¾¹ç•Œï¼š
âŒ è·¨å¤šä¸ªä¸šåŠ¡æ¨¡å—
âŒ åŒ…å«è€—æ—¶çš„å¤–éƒ¨è°ƒç”¨  
âŒ äº‹åŠ¡æ—¶é—´è¿‡é•¿
```

**ğŸ”¹ æ€§èƒ½ä¸å®‰å…¨çš„å¹³è¡¡**
```
é«˜æ€§èƒ½éœ€æ±‚ï¼š
â€¢ é€‰æ‹©è¾ƒä½çš„éš”ç¦»çº§åˆ«
â€¢ ä½¿ç”¨ä¹è§‚é”
â€¢ ç¼©çŸ­äº‹åŠ¡æ—¶é—´

é«˜å®‰å…¨éœ€æ±‚ï¼š
â€¢ é€‰æ‹©è¾ƒé«˜çš„éš”ç¦»çº§åˆ«
â€¢ ä½¿ç”¨æ‚²è§‚é”  
â€¢ ä¸¥æ ¼çš„å¼‚å¸¸å¤„ç†
```

### 7.3 å®æˆ˜å¼€å‘å»ºè®®


**ğŸ’¡ æœ€ä½³å®è·µ**
```
äº‹åŠ¡è®¾è®¡åŸåˆ™ï¼š
ğŸ”¸ äº‹åŠ¡å°½å¯èƒ½çŸ­ï¼šå‡å°‘é”æ—¶é—´ï¼Œæé«˜å¹¶å‘
ğŸ”¸ å…ˆéªŒè¯åæ‰§è¡Œï¼šé¿å…æ‰§è¡Œåˆ°ä¸€åŠæ‰å‘ç°é”™è¯¯
ğŸ”¸ æŒ‰é¡ºåºè®¿é—®èµ„æºï¼šé¢„é˜²æ­»é”äº§ç”Ÿ
ğŸ”¸ è®¾ç½®åˆç†è¶…æ—¶ï¼šé˜²æ­¢é•¿æ—¶é—´ç­‰å¾…
ğŸ”¸ å®Œå–„å¼‚å¸¸å¤„ç†ï¼šä¿è¯æ•°æ®ä¸€è‡´æ€§
```

**ğŸ› ï¸ å¸¸è§é”™è¯¯é¿å…**
```
âŒ å¿˜è®°è®¾ç½®äº‹åŠ¡è¾¹ç•Œ
âŒ catchå¼‚å¸¸åä¸å›æ»š
âŒ äº‹åŠ¡ä¸­åŒ…å«é•¿æ—¶é—´æ“ä½œ
âŒ æ²¡æœ‰è€ƒè™‘å¹¶å‘åœºæ™¯
âŒ éš”ç¦»çº§åˆ«è®¾ç½®ä¸å½“
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- äº‹åŠ¡ä¿è¯ä¸šåŠ¡å®Œæ•´æ€§ï¼Œå¼€å¯æäº¤è¦é…å¯¹
- å¹¶å‘æ§åˆ¶é˜²å†²çªï¼Œæ‚²è§‚ä¹è§‚é€‰æ‹©å¯¹
- å¼‚å¸¸å¤„ç†å¿…å›æ»šï¼Œæ­»é”é¢„é˜²æœ‰å¥—è·¯
- éš”ç¦»çº§åˆ«çœ‹åœºæ™¯ï¼Œæ€§èƒ½å®‰å…¨è¦å¹³è¡¡