---
title: 4ã€ä¿å­˜ç‚¹ä¸å±€éƒ¨å›æ»š
---
## ğŸ“š ç›®å½•

1. [ä¿å­˜ç‚¹åŸºæœ¬æ¦‚å¿µ](#1-ä¿å­˜ç‚¹åŸºæœ¬æ¦‚å¿µ)
2. [ä¿å­˜ç‚¹çš„å·¥ä½œåŸç†](#2-ä¿å­˜ç‚¹çš„å·¥ä½œåŸç†)
3. [ä¿å­˜ç‚¹æ“ä½œè¯¦è§£](#3-ä¿å­˜ç‚¹æ“ä½œè¯¦è§£)
4. [å®é™…åº”ç”¨åœºæ™¯](#4-å®é™…åº”ç”¨åœºæ™¯)
5. [æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹](#5-æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ ä¿å­˜ç‚¹åŸºæœ¬æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯ä¿å­˜ç‚¹


**ğŸ”¸ ç®€å•ç†è§£**
ä¿å­˜ç‚¹ï¼ˆSavepointï¼‰å°±åƒæ˜¯æ¸¸æˆä¸­çš„**å­˜æ¡£ç‚¹**ï¼Œä½ å¯ä»¥åœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­è®¾ç½®å¤šä¸ª"æ£€æŸ¥ç‚¹"ï¼Œå¦‚æœåé¢å‡ºç°é—®é¢˜ï¼Œå¯ä»¥é€‰æ‹©å›åˆ°æŸä¸ªç‰¹å®šçš„å­˜æ¡£ç‚¹ï¼Œè€Œä¸æ˜¯ä»å¤´å¼€å§‹ã€‚

```
ç”Ÿæ´»ç±»æ¯”ï¼š
å†™è®ºæ–‡æ—¶æ¯å®Œæˆä¸€ä¸ªç« èŠ‚å°±ä¿å­˜ä¸€æ¬¡
å¦‚æœåé¢å†™é”™äº†ï¼Œå¯ä»¥å›åˆ°æŸä¸ªç« èŠ‚é‡æ–°å¼€å§‹
è€Œä¸éœ€è¦æ•´ç¯‡è®ºæ–‡é‡å†™

æ•°æ®åº“äº‹åŠ¡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¼€å§‹äº‹åŠ¡                             â”‚
â”‚ â”œâ”€ æ“ä½œ1ï¼šè½¬è´¦æ‰£æ¬¾                   â”‚
â”‚ â”œâ”€ ä¿å­˜ç‚¹A â† å¯ä»¥å›åˆ°è¿™é‡Œ             â”‚
â”‚ â”œâ”€ æ“ä½œ2ï¼šå¢åŠ ç§¯åˆ†                   â”‚
â”‚ â”œâ”€ ä¿å­˜ç‚¹B â† ä¹Ÿå¯ä»¥å›åˆ°è¿™é‡Œ           â”‚
â”‚ â”œâ”€ æ“ä½œ3ï¼šå‘é€é€šçŸ¥                   â”‚
â”‚ â””â”€ æäº¤äº‹åŠ¡                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦ä¿å­˜ç‚¹


**ğŸ¤” é—®é¢˜åœºæ™¯**
æƒ³è±¡ä½ åœ¨é“¶è¡ŒåŠç†ä¸€ä¸ªå¤æ‚çš„ä¸šåŠ¡ï¼š
1. ä»å‚¨è“„è´¦æˆ·è½¬è´¦åˆ°ä¿¡ç”¨å¡
2. è´­ä¹°ç†è´¢äº§å“  
3. å¼€é€šçŸ­ä¿¡é€šçŸ¥æœåŠ¡

ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜ï¼š
```
å¦‚æœç¬¬3æ­¥å¤±è´¥ â†’ æ•´ä¸ªäº‹åŠ¡å›æ»š
ç»“æœï¼šè½¬è´¦å¤±è´¥ + ç†è´¢æ²¡ä¹°æˆ + çŸ­ä¿¡æ²¡å¼€é€š
ä½†å®é™…ä¸Šï¼šç”¨æˆ·å¯èƒ½åªæƒ³å–æ¶ˆçŸ­ä¿¡æœåŠ¡ï¼Œå…¶ä»–æ“ä½œç»§ç»­
```

ä¿å­˜ç‚¹çš„ä¼˜åŠ¿ï¼š
```
ç¬¬1æ­¥å®Œæˆåè®¾ç½®ä¿å­˜ç‚¹A
ç¬¬2æ­¥å®Œæˆåè®¾ç½®ä¿å­˜ç‚¹B  
ç¬¬3æ­¥å¤±è´¥åï¼Œå¯ä»¥åªå›æ»šåˆ°ä¿å­˜ç‚¹B
ç»“æœï¼šè½¬è´¦æˆåŠŸ + ç†è´¢æˆåŠŸ + åªæ˜¯çŸ­ä¿¡æ²¡å¼€é€š
```

### 1.3 ä¿å­˜ç‚¹ vs æ™®é€šäº‹åŠ¡çš„åŒºåˆ«


| ç‰¹æ€§ | **æ™®é€šäº‹åŠ¡** | **ä¿å­˜ç‚¹äº‹åŠ¡** |
|------|-------------|---------------|
| **å›æ»šç²’åº¦** | `å…¨éƒ¨å›æ»š` | `å¯é€‰æ‹©æ€§å›æ»šåˆ°æŒ‡å®šç‚¹` |
| **çµæ´»æ€§** | `ä½` | `é«˜` |
| **å¤æ‚åº¦** | `ç®€å•` | `ç›¸å¯¹å¤æ‚` |
| **é€‚ç”¨åœºæ™¯** | `ç®€å•ä¸šåŠ¡` | `å¤æ‚å¤šæ­¥éª¤ä¸šåŠ¡` |
| **æ€§èƒ½å¼€é”€** | `ä½` | `ç¨é«˜ï¼ˆéœ€è¦ç»´æŠ¤å¤šä¸ªçŠ¶æ€ï¼‰` |

---

## 2. âš™ï¸ ä¿å­˜ç‚¹çš„å·¥ä½œåŸç†


### 2.1 ä¿å­˜ç‚¹çš„å†…éƒ¨æœºåˆ¶


**ğŸ”§ åº•å±‚åŸç†**
```
æ•°æ®åº“å†…éƒ¨çŠ¶æ€ç®¡ç†ï¼š

äº‹åŠ¡å¼€å§‹æ—¶ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åŸå§‹æ•°æ®çŠ¶æ€     â”‚  â† äº‹åŠ¡å¼€å§‹ç‚¹
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è®¾ç½®ä¿å­˜ç‚¹Aåï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åŸå§‹æ•°æ®çŠ¶æ€     â”‚  â† äº‹åŠ¡å¼€å§‹ç‚¹
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä¿å­˜ç‚¹AçŠ¶æ€     â”‚  â† ç¬¬ä¸€ä¸ªä¿å­˜ç‚¹
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è®¾ç½®ä¿å­˜ç‚¹Båï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åŸå§‹æ•°æ®çŠ¶æ€     â”‚  â† äº‹åŠ¡å¼€å§‹ç‚¹  
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä¿å­˜ç‚¹AçŠ¶æ€     â”‚  â† ç¬¬ä¸€ä¸ªä¿å­˜ç‚¹
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  
â”‚ ä¿å­˜ç‚¹BçŠ¶æ€     â”‚  â† ç¬¬äºŒä¸ªä¿å­˜ç‚¹
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ“Š çŠ¶æ€ç»´æŠ¤æœºåˆ¶**
- **æ¯ä¸ªä¿å­˜ç‚¹**ï¼šæ•°æ®åº“ä¼šè®°å½•å½“å‰çš„æ•°æ®ä¿®æ”¹çŠ¶æ€
- **å›æ»šæ—¶**ï¼šæ•°æ®åº“æ¢å¤åˆ°æŒ‡å®šä¿å­˜ç‚¹çš„çŠ¶æ€
- **åµŒå¥—ç®¡ç†**ï¼šä¿å­˜ç‚¹å¯ä»¥åµŒå¥—ï¼Œæ”¯æŒå¤šå±‚å›æ»š

### 2.2 ä¿å­˜ç‚¹çš„ç”Ÿå‘½å‘¨æœŸ


```
ä¿å­˜ç‚¹ç”Ÿå‘½å‘¨æœŸå›¾ï¼š

åˆ›å»º â†’ ä½¿ç”¨ â†’ é”€æ¯
  â”‚      â”‚      â”‚
  â”‚      â”‚      â”œâ”€ æ­£å¸¸æäº¤ï¼ˆè‡ªåŠ¨é”€æ¯ï¼‰
  â”‚      â”‚      â”œâ”€ å›æ»šé”€æ¯
  â”‚      â”‚      â””â”€ æ‰‹åŠ¨é‡Šæ”¾
  â”‚      â”‚
  â”‚      â”œâ”€ å›æ»šåˆ°è¯¥ç‚¹
  â”‚      â””â”€ ç»§ç»­åç»­æ“ä½œ
  â”‚
  â”œâ”€ setSavepoint()
  â””â”€ setSavepoint(name)
```

**â° é‡è¦æ—¶æœº**
- **åˆ›å»ºæ—¶æœº**ï¼šå…³é”®æ“ä½œå®Œæˆå
- **é”€æ¯æ—¶æœº**ï¼šäº‹åŠ¡æäº¤æˆ–å›æ»šæ—¶è‡ªåŠ¨é”€æ¯
- **ä½œç”¨èŒƒå›´**ï¼šä»…åœ¨å½“å‰äº‹åŠ¡å†…æœ‰æ•ˆ

---

## 3. ğŸ’» ä¿å­˜ç‚¹æ“ä½œè¯¦è§£


### 3.1 åˆ›å»ºä¿å­˜ç‚¹


**ğŸ”¸ åŒ¿åä¿å­˜ç‚¹**
```java
// æ•°æ®åº“ä¼šè‡ªåŠ¨åˆ†é…ä¸€ä¸ªID
Savepoint savepoint = connection.setSavepoint();
```

**ğŸ”¸ å‘½åä¿å­˜ç‚¹**  
```java
// ç»™ä¿å­˜ç‚¹èµ·ä¸ªæœ‰æ„ä¹‰çš„åå­—ï¼Œä¾¿äºç®¡ç†
Savepoint savepoint = connection.setSavepoint("afterPayment");
```

> ğŸ’¡ **é€‰æ‹©å»ºè®®**ï¼šæ¨èä½¿ç”¨å‘½åä¿å­˜ç‚¹ï¼Œä»£ç å¯è¯»æ€§æ›´å¥½

### 3.2 å›æ»šåˆ°ä¿å­˜ç‚¹


```java
// å›æ»šåˆ°æŒ‡å®šçš„ä¿å­˜ç‚¹
connection.rollback(savepoint);
```

**âš ï¸ é‡è¦ç†è§£**ï¼š
- å›æ»šåˆ°ä¿å­˜ç‚¹Aï¼Œä¼š**æ’¤é”€**ä¿å­˜ç‚¹Aä¹‹åçš„æ‰€æœ‰æ“ä½œ
- ä½†**ä¿ç•™**ä¿å­˜ç‚¹Aä¹‹å‰çš„æ‰€æœ‰æ“ä½œ
- ä¿å­˜ç‚¹Aæœ¬èº«**ä»ç„¶å­˜åœ¨**ï¼Œå¯ä»¥ç»§ç»­ä½¿ç”¨

### 3.3 é‡Šæ”¾ä¿å­˜ç‚¹


```java
// æ‰‹åŠ¨é‡Šæ”¾ä¿å­˜ç‚¹ï¼Œé‡Šæ”¾ç›¸å…³èµ„æº
connection.releaseSavepoint(savepoint);
```

**ğŸ¤” ä½•æ—¶éœ€è¦æ‰‹åŠ¨é‡Šæ”¾ï¼Ÿ**
- **é•¿äº‹åŠ¡**ï¼šäº‹åŠ¡æ‰§è¡Œæ—¶é—´å¾ˆé•¿ï¼Œä¿å­˜ç‚¹è¾ƒå¤šæ—¶
- **å†…å­˜ä¼˜åŒ–**ï¼šéœ€è¦åŠæ—¶é‡Šæ”¾ä¸ç”¨çš„ä¿å­˜ç‚¹èµ„æº
- **ä¸€èˆ¬æƒ…å†µ**ï¼šäº‹åŠ¡æäº¤æ—¶ä¼šè‡ªåŠ¨é‡Šæ”¾ï¼Œæ— éœ€æ‰‹åŠ¨å¤„ç†

### 3.4 å®Œæ•´æ“ä½œç¤ºä¾‹


```java
public class SavepointDemo {
    
    public void complexBusinessOperation() {
        Connection conn = null;
        Savepoint savepoint1 = null;
        Savepoint savepoint2 = null;
        
        try {
            conn = getConnection();
            // å…³é—­è‡ªåŠ¨æäº¤
            conn.setAutoCommit(false);
            
            // ç¬¬ä¸€æ­¥ï¼šç”¨æˆ·è½¬è´¦
            transferMoney(conn, "user123", "user456", 1000);
            savepoint1 = conn.setSavepoint("afterTransfer");
            
            // ç¬¬äºŒæ­¥ï¼šå¢åŠ ç§¯åˆ†  
            addPoints(conn, "user123", 100);
            savepoint2 = conn.setSavepoint("afterPoints");
            
            // ç¬¬ä¸‰æ­¥ï¼šå‘é€é€šçŸ¥ï¼ˆå¯èƒ½å¤±è´¥ï¼‰
            sendNotification(conn, "user123", "è½¬è´¦æˆåŠŸ");
            
            // æ‰€æœ‰æ“ä½œæˆåŠŸï¼Œæäº¤äº‹åŠ¡
            conn.commit();
            
        } catch (Exception e) {
            try {
                if (e instanceof NotificationException) {
                    // é€šçŸ¥å¤±è´¥ï¼Œåªå›æ»šé€šçŸ¥æ“ä½œ
                    conn.rollback(savepoint2);
                    conn.commit(); // ä¿ç•™è½¬è´¦å’Œç§¯åˆ†
                } else if (e instanceof PointsException) {
                    // ç§¯åˆ†å¤±è´¥ï¼Œå›æ»šç§¯åˆ†å’Œé€šçŸ¥
                    conn.rollback(savepoint1);  
                    conn.commit(); // ä¿ç•™è½¬è´¦
                } else {
                    // å…¶ä»–é”™è¯¯ï¼Œå…¨éƒ¨å›æ»š
                    conn.rollback();
                }
            } catch (SQLException ex) {
                ex.printStackTrace();
            }
        }
    }
}
```

---

## 4. ğŸš€ å®é™…åº”ç”¨åœºæ™¯


### 4.1 ç”µå•†è®¢å•å¤„ç†


**ğŸ“¦ ä¸šåŠ¡æµç¨‹**
```
ç”µå•†ä¸‹å•å®Œæ•´æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ£€æŸ¥å•†å“åº“å­˜                        â”‚
â”‚ 2. é”å®šå•†å“åº“å­˜ â† ä¿å­˜ç‚¹A              â”‚  
â”‚ 3. åˆ›å»ºè®¢å•è®°å½• â† ä¿å­˜ç‚¹B              â”‚
â”‚ 4. è®¡ç®—ä¼˜æƒ åˆ¸æŠ˜æ‰£ â† ä¿å­˜ç‚¹C            â”‚
â”‚ 5. æ‰£å‡ç”¨æˆ·ä½™é¢ â† ä¿å­˜ç‚¹D              â”‚
â”‚ 6. ç”Ÿæˆå‘è´§å•                          â”‚
â”‚ 7. å‘é€ç¡®è®¤é‚®ä»¶                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ¯ å›æ»šç­–ç•¥**
```java
public void processOrder(Order order) {
    Connection conn = getConnection();
    Savepoint afterInventory = null;
    Savepoint afterOrder = null; 
    Savepoint afterCoupon = null;
    Savepoint afterPayment = null;
    
    try {
        conn.setAutoCommit(false);
        
        // 1. é”å®šåº“å­˜
        lockInventory(conn, order);
        afterInventory = conn.setSavepoint("inventory");
        
        // 2. åˆ›å»ºè®¢å•  
        createOrder(conn, order);
        afterOrder = conn.setSavepoint("order");
        
        // 3. å¤„ç†ä¼˜æƒ åˆ¸
        applyCoupon(conn, order);
        afterCoupon = conn.setSavepoint("coupon");
        
        // 4. æ‰£æ¬¾
        deductPayment(conn, order);
        afterPayment = conn.setSavepoint("payment");
        
        // 5. ç”Ÿæˆå‘è´§å•
        createShippingOrder(conn, order);
        
        // 6. å‘é€é‚®ä»¶
        sendConfirmationEmail(order);
        
        conn.commit();
        
    } catch (Exception e) {
        handleOrderException(conn, e, afterInventory, 
                           afterOrder, afterCoupon, afterPayment);
    }
}

private void handleOrderException(Connection conn, Exception e,
                                Savepoint... savepoints) {
    try {
        if (e instanceof EmailException) {
            // é‚®ä»¶å¤±è´¥ä¸å½±å“è®¢å•ï¼Œç›´æ¥æäº¤
            conn.commit();
        } else if (e instanceof ShippingException) {
            // å‘è´§å¤±è´¥ï¼Œå›æ»šåˆ°ä»˜æ¬¾å
            conn.rollback(savepoints[3]); // afterPayment
            // å¯ä»¥ç¨åé‡è¯•ç”Ÿæˆå‘è´§å•
            conn.commit();
        } else if (e instanceof PaymentException) {
            // ä»˜æ¬¾å¤±è´¥ï¼Œå›æ»šåˆ°ä¼˜æƒ åˆ¸å
            conn.rollback(savepoints[2]); // afterCoupon  
            conn.commit(); // ä¿ç•™è®¢å•ï¼Œç­‰å¾…é‡æ–°ä»˜æ¬¾
        } else {
            // å…¶ä»–ä¸¥é‡é”™è¯¯ï¼Œå…¨éƒ¨å›æ»š
            conn.rollback();
        }
    } catch (SQLException ex) {
        ex.printStackTrace();
    }
}
```

### 4.2 é“¶è¡Œè½¬è´¦ç³»ç»Ÿ


**ğŸ’° è½¬è´¦ä¸šåŠ¡åœºæ™¯**

```java
public class BankTransferService {
    
    public void complexTransfer(String fromAccount, String toAccount, 
                              double amount) {
        Connection conn = getConnection();
        Savepoint afterValidation = null;
        Savepoint afterDebit = null;
        Savepoint afterCredit = null;
        
        try {
            conn.setAutoCommit(false);
            
            // 1. è´¦æˆ·éªŒè¯å’Œé£æ§æ£€æŸ¥
            validateAccounts(conn, fromAccount, toAccount, amount);
            afterValidation = conn.setSavepoint("validation");
            
            // 2. æ‰£æ¬¾æ“ä½œ
            debitAccount(conn, fromAccount, amount);
            afterDebit = conn.setSavepoint("debit");
            
            // 3. åˆ°è´¦æ“ä½œ  
            creditAccount(conn, toAccount, amount);
            afterCredit = conn.setSavepoint("credit");
            
            // 4. è®°å½•äº¤æ˜“æµæ°´
            recordTransaction(conn, fromAccount, toAccount, amount);
            
            // 5. æ›´æ–°è´¦æˆ·ä¿¡æ¯
            updateAccountInfo(conn, fromAccount, toAccount);
            
            conn.commit();
            
        } catch (Exception e) {
            handleTransferError(conn, e, afterValidation, 
                              afterDebit, afterCredit);
        }
    }
    
    private void handleTransferError(Connection conn, Exception e,
                                   Savepoint validation, 
                                   Savepoint debit,
                                   Savepoint credit) {
        try {
            if (e instanceof RecordException) {
                // æµæ°´è®°å½•å¤±è´¥ï¼Œå›æ»šåˆ°è½¬è´¦å®Œæˆå
                // è½¬è´¦æˆåŠŸä½†æ²¡æœ‰æµæ°´è®°å½•
                conn.rollback(credit);
                // å¯ä»¥å¼‚æ­¥è¡¥å……æµæ°´è®°å½•
                conn.commit();
                
            } else if (e instanceof CreditException) {
                // åˆ°è´¦å¤±è´¥ï¼Œå›æ»šåˆ°æ‰£æ¬¾å  
                conn.rollback(debit);
                // æ‰£æ¬¾æˆåŠŸä½†åˆ°è´¦å¤±è´¥ï¼Œéœ€è¦äººå·¥å¤„ç†
                conn.commit();
                notifyManualProcess(fromAccount, toAccount, amount);
                
            } else if (e instanceof DebitException) {
                // æ‰£æ¬¾å¤±è´¥ï¼Œå›æ»šåˆ°éªŒè¯å
                conn.rollback(validation);
                conn.commit(); // ä¿ç•™éªŒè¯ç»“æœï¼Œè®°å½•å¤±è´¥åŸå› 
                
            } else {
                // éªŒè¯å¤±è´¥æˆ–å…¶ä»–é”™è¯¯ï¼Œå…¨éƒ¨å›æ»š
                conn.rollback();
            }
        } catch (SQLException ex) {
            ex.printStackTrace();
        }
    }
}
```

### 4.3 æ‰¹é‡æ•°æ®å¤„ç†


**ğŸ“Š æ•°æ®æ‰¹å¤„ç†åœºæ™¯**
```java
public class BatchDataProcessor {
    
    public void processBatchData(List<DataRecord> records) {
        Connection conn = getConnection();
        Map<Integer, Savepoint> checkpoints = new HashMap<>();
        int processedCount = 0;
        
        try {
            conn.setAutoCommit(false);
            
            for (int i = 0; i < records.size(); i++) {
                DataRecord record = records.get(i);
                
                try {
                    // å¤„ç†å•æ¡è®°å½•
                    processRecord(conn, record);
                    processedCount++;
                    
                    // æ¯å¤„ç†100æ¡è®¾ç½®ä¸€ä¸ªæ£€æŸ¥ç‚¹
                    if (i % 100 == 99) {
                        Savepoint checkpoint = conn.setSavepoint("batch_" + i);
                        checkpoints.put(i, checkpoint);
                    }
                    
                } catch (RecordProcessException e) {
                    // å•æ¡è®°å½•å¤„ç†å¤±è´¥
                    System.out.println("è®°å½• " + i + " å¤„ç†å¤±è´¥: " + e.getMessage());
                    
                    // æ‰¾åˆ°æœ€è¿‘çš„æ£€æŸ¥ç‚¹
                    Savepoint nearestCheckpoint = findNearestCheckpoint(checkpoints, i);
                    if (nearestCheckpoint != null) {
                        conn.rollback(nearestCheckpoint);
                        // é‡æ–°å¤„ç†ä»æ£€æŸ¥ç‚¹åˆ°å½“å‰ä½ç½®çš„è®°å½•
                        reprocessFromCheckpoint(conn, records, 
                                              getNearestCheckpointIndex(checkpoints, i), i);
                    }
                }
            }
            
            conn.commit();
            System.out.println("æ‰¹å¤„ç†å®Œæˆï¼ŒæˆåŠŸå¤„ç† " + processedCount + " æ¡è®°å½•");
            
        } catch (Exception e) {
            try {
                conn.rollback();
                System.out.println("æ‰¹å¤„ç†å¤±è´¥ï¼Œå·²å›æ»šæ‰€æœ‰æ“ä½œ");
            } catch (SQLException ex) {
                ex.printStackTrace();
            }
        }
    }
}
```

---

## 5. âœ… æœ€ä½³å®è·µä¸æ³¨æ„äº‹é¡¹


### 5.1 ä¿å­˜ç‚¹å‘½åè§„èŒƒ


**ğŸ·ï¸ è‰¯å¥½çš„å‘½åä¹ æƒ¯**
```java
// âœ… æ¨èï¼šä½¿ç”¨æœ‰æ„ä¹‰çš„åç§°
Savepoint afterPayment = conn.setSavepoint("afterPayment");
Savepoint beforeRiskCheck = conn.setSavepoint("beforeRiskCheck"); 
Savepoint dataValidated = conn.setSavepoint("dataValidated");

// âŒ ä¸æ¨èï¼šæ— æ„ä¹‰çš„åç§°
Savepoint sp1 = conn.setSavepoint("sp1");
Savepoint point = conn.setSavepoint("point");
```

**ğŸ“ å‘½åå»ºè®®**
- **åŠ¨ä½œå¯¼å‘**ï¼š`after + åŠ¨ä½œ` æˆ– `before + åŠ¨ä½œ`
- **çŠ¶æ€æè¿°**ï¼š`æ•°æ®çŠ¶æ€ + å®Œæˆ`
- **ä¸šåŠ¡ç›¸å…³**ï¼šåæ˜ å®é™…ä¸šåŠ¡å«ä¹‰

### 5.2 ä¿å­˜ç‚¹ç®¡ç†ç­–ç•¥


**ğŸ”§ èµ„æºç®¡ç†**
```java
public class SavepointManager {
    private Map<String, Savepoint> savepoints = new HashMap<>();
    private Connection connection;
    
    public Savepoint createSavepoint(String name) throws SQLException {
        Savepoint sp = connection.setSavepoint(name);
        savepoints.put(name, sp);
        return sp;
    }
    
    public void rollbackTo(String name) throws SQLException {
        Savepoint sp = savepoints.get(name);
        if (sp != null) {
            connection.rollback(sp);
            // ç§»é™¤è¯¥ä¿å­˜ç‚¹ä¹‹åçš„æ‰€æœ‰ä¿å­˜ç‚¹
            removeAfterSavepoint(name);
        }
    }
    
    public void cleanup() throws SQLException {
        // é‡Šæ”¾æ‰€æœ‰ä¿å­˜ç‚¹èµ„æº
        for (Savepoint sp : savepoints.values()) {
            try {
                connection.releaseSavepoint(sp);
            } catch (SQLException e) {
                // å¿½ç•¥é‡Šæ”¾å¼‚å¸¸
            }
        }
        savepoints.clear();
    }
}
```

### 5.3 æ€§èƒ½ä¼˜åŒ–è€ƒè™‘


**âš¡ æ€§èƒ½å½±å“å› ç´ **

| å› ç´  | **å½±å“** | **ä¼˜åŒ–å»ºè®®** |
|------|---------|-------------|
| **ä¿å­˜ç‚¹æ•°é‡** | `è¿‡å¤šå½±å“æ€§èƒ½` | `æ§åˆ¶åœ¨åˆç†èŒƒå›´å†…ï¼ˆ<10ä¸ªï¼‰` |
| **äº‹åŠ¡é•¿åº¦** | `é•¿äº‹åŠ¡æ¶ˆè€—èµ„æºå¤š` | `æ‹†åˆ†ä¸ºå¤šä¸ªè¾ƒçŸ­äº‹åŠ¡` |
| **å›æ»šé¢‘ç‡** | `é¢‘ç¹å›æ»šå½±å“æ€§èƒ½` | `ä¼˜åŒ–ä¸šåŠ¡é€»è¾‘å‡å°‘å›æ»š` |
| **æ•°æ®é‡å¤§å°** | `å¤§æ•°æ®ä¿®æ”¹å¼€é”€å¤§` | `åˆ†æ‰¹å¤„ç†ï¼Œè®¾ç½®åˆç†æ£€æŸ¥ç‚¹` |

**ğŸ“Š æ€§èƒ½ç›‘æ§**
```java
public class PerformanceMonitor {
    
    public void monitorSavepoint(String operation, Runnable task) {
        long startTime = System.currentTimeMillis();
        try {
            task.run();
        } finally {
            long duration = System.currentTimeMillis() - startTime;
            if (duration > 1000) { // è¶…è¿‡1ç§’è®°å½•è­¦å‘Š
                System.out.println("ä¿å­˜ç‚¹æ“ä½œ " + operation + " è€—æ—¶: " + duration + "ms");
            }
        }
    }
}
```

### 5.4 é”™è¯¯å¤„ç†æœ€ä½³å®è·µ


**ğŸ›¡ï¸ å¼‚å¸¸å¤„ç†ç­–ç•¥**
```java
public class SavepointErrorHandler {
    
    public void handleWithGradualRollback(Connection conn, 
                                        List<Savepoint> savepoints,
                                        Exception originalError) {
        // ä»æœ€æ–°çš„ä¿å­˜ç‚¹å¼€å§‹ï¼Œé€çº§å›æ»š
        for (int i = savepoints.size() - 1; i >= 0; i--) {
            try {
                conn.rollback(savepoints.get(i));
                
                // å°è¯•ä»è¿™ä¸ªç‚¹ç»§ç»­æ‰§è¡Œ
                if (canContinueFrom(savepoints.get(i))) {
                    continueExecution(conn, i);
                    return;
                }
                
            } catch (SQLException e) {
                // å½“å‰ä¿å­˜ç‚¹å›æ»šå¤±è´¥ï¼Œå°è¯•æ›´æ—©çš„ä¿å­˜ç‚¹
                continue;
            }
        }
        
        // æ‰€æœ‰ä¿å­˜ç‚¹éƒ½å¤±è´¥ï¼Œæ‰§è¡Œå®Œå…¨å›æ»š
        try {
            conn.rollback();
        } catch (SQLException e) {
            // è®°å½•ä¸¥é‡é”™è¯¯
            logCriticalError(originalError, e);
        }
    }
}
```

### 5.5 æ•°æ®åº“å…¼å®¹æ€§


**ğŸ—ƒï¸ ä¸åŒæ•°æ®åº“æ”¯æŒæƒ…å†µ**

| æ•°æ®åº“ | **ä¿å­˜ç‚¹æ”¯æŒ** | **ç‰¹æ®Šè¯´æ˜** |
|--------|---------------|-------------|
| **MySQL** | `âœ… å®Œå…¨æ”¯æŒ` | `InnoDBå¼•æ“æ”¯æŒï¼ŒMyISAMä¸æ”¯æŒ` |
| **PostgreSQL** | `âœ… å®Œå…¨æ”¯æŒ` | `åŸç”Ÿæ”¯æŒï¼ŒåŠŸèƒ½å®Œæ•´` |
| **Oracle** | `âœ… å®Œå…¨æ”¯æŒ` | `ä¼ä¸šçº§åŠŸèƒ½ï¼Œæ€§èƒ½ä¼˜å¼‚` |
| **SQL Server** | `âœ… å®Œå…¨æ”¯æŒ` | `æ”¯æŒåµŒå¥—äº‹åŠ¡` |
| **SQLite** | `âš ï¸ æœ‰é™æ”¯æŒ` | `æ”¯æŒä½†åŠŸèƒ½ç®€åŒ–` |

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ”¸ ä¿å­˜ç‚¹æœ¬è´¨ï¼šäº‹åŠ¡ä¸­çš„æ£€æŸ¥ç‚¹ï¼Œæ”¯æŒéƒ¨åˆ†å›æ»š
ğŸ”¸ åˆ›å»ºæ–¹å¼ï¼šsetSavepoint() å’Œ setSavepoint(name)
ğŸ”¸ å›æ»šæ“ä½œï¼šrollback(savepoint) å›æ»šåˆ°æŒ‡å®šç‚¹
ğŸ”¸ ç”Ÿå‘½å‘¨æœŸï¼šåœ¨äº‹åŠ¡å†…æœ‰æ•ˆï¼Œæäº¤æˆ–å›æ»šæ—¶è‡ªåŠ¨é”€æ¯
ğŸ”¸ åº”ç”¨åœºæ™¯ï¼šå¤æ‚å¤šæ­¥éª¤ä¸šåŠ¡æµç¨‹çš„ç²¾ç¡®æ§åˆ¶
```

### 6.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¿å­˜ç‚¹çš„ä»·å€¼**
```
çµæ´»æ€§ï¼šå¯ä»¥é€‰æ‹©æ€§å›æ»šï¼Œä¸æ˜¯å…¨æœ‰å…¨æ— 
ç²¾ç¡®æ§åˆ¶ï¼šåœ¨å¤æ‚ä¸šåŠ¡ä¸­å®ç°ç²¾ç¡®çš„é”™è¯¯æ¢å¤
ä¸šåŠ¡å‹å¥½ï¼šæ›´è´´è¿‘å®é™…ä¸šåŠ¡éœ€æ±‚çš„äº‹åŠ¡æ§åˆ¶æ–¹å¼
```

**ğŸ”¹ ä½¿ç”¨åœºæ™¯åˆ¤æ–­**
```
é€‚åˆä½¿ç”¨ä¿å­˜ç‚¹ï¼š
âœ… å¤šæ­¥éª¤å¤æ‚ä¸šåŠ¡æµç¨‹
âœ… éƒ¨åˆ†å¤±è´¥å¯ä»¥æ¥å—çš„åœºæ™¯  
âœ… éœ€è¦ç²¾ç¡®å›æ»šæ§åˆ¶çš„ä¸šåŠ¡

ä¸é€‚åˆä½¿ç”¨ä¿å­˜ç‚¹ï¼š
âŒ ç®€å•çš„å•æ­¥æ“ä½œ
âŒ å…¨éƒ¨æˆåŠŸæˆ–å…¨éƒ¨å¤±è´¥çš„åœºæ™¯
âŒ å¯¹æ€§èƒ½è¦æ±‚æé«˜çš„æ“ä½œ
```

### 6.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ’¡ è®¾è®¡åŸåˆ™**
- **åˆç†åˆ†æ®µ**ï¼šåœ¨å…³é”®ä¸šåŠ¡èŠ‚ç‚¹è®¾ç½®ä¿å­˜ç‚¹
- **æœ‰æ„ä¹‰å‘½å**ï¼šä½¿ç”¨åæ˜ ä¸šåŠ¡å«ä¹‰çš„ä¿å­˜ç‚¹åç§°  
- **å¼‚å¸¸å¤„ç†**ï¼šä¸ºæ¯ä¸ªä¿å­˜ç‚¹è®¾è®¡ç›¸åº”çš„å›æ»šç­–ç•¥
- **èµ„æºç®¡ç†**ï¼šåŠæ—¶é‡Šæ”¾ä¸éœ€è¦çš„ä¿å­˜ç‚¹èµ„æº

**ğŸ¯ å¸¸è§åº”ç”¨æ¨¡å¼**
```java
// æ ‡å‡†æ¨¡å¼ï¼šå…³é”®æ­¥éª¤åè®¾ç½®ä¿å­˜ç‚¹
operation1();
Savepoint sp1 = conn.setSavepoint("step1");

operation2(); 
Savepoint sp2 = conn.setSavepoint("step2");

operation3();
// æ ¹æ®å¼‚å¸¸ç±»å‹é€‰æ‹©å›æ»šç‚¹
```

### 6.4 å­¦ä¹ è¦ç‚¹æé†’


**ğŸ“š æ–°æ‰‹è¦ç‰¹åˆ«æ³¨æ„**
- ä¿å­˜ç‚¹**ä¸æ˜¯**ç‹¬ç«‹çš„äº‹åŠ¡ï¼Œä»åœ¨åŒä¸€äº‹åŠ¡å†…
- å›æ»šåˆ°ä¿å­˜ç‚¹**ä¸ä¼š**è‡ªåŠ¨æäº¤ï¼Œéœ€è¦æ‰‹åŠ¨commit
- ä¿å­˜ç‚¹çš„é¡ºåºå¾ˆé‡è¦ï¼Œä¸èƒ½å›æ»šåˆ°"æœªæ¥"çš„ä¿å­˜ç‚¹
- æ•°æ®åº“è¿æ¥å…³é—­æ—¶ï¼Œæ‰€æœ‰ä¿å­˜ç‚¹è‡ªåŠ¨å¤±æ•ˆ

**ğŸ”§ å®è·µå»ºè®®**
- ä»ç®€å•çš„ä¸¤æ­¥æ“ä½œå¼€å§‹ç»ƒä¹ ä¿å­˜ç‚¹
- é€æ­¥å¢åŠ å¤æ‚åº¦ï¼Œç†è§£ä¸åŒå›æ»šç­–ç•¥çš„æ•ˆæœ
- å¤šæµ‹è¯•å¼‚å¸¸æƒ…å†µï¼Œç¡®ä¿å›æ»šé€»è¾‘æ­£ç¡®
- å…³æ³¨æ€§èƒ½å½±å“ï¼Œåœ¨å®é™…é¡¹ç›®ä¸­åˆç†ä½¿ç”¨

**æ ¸å¿ƒè®°å¿†**ï¼š
- ä¿å­˜ç‚¹æ˜¯äº‹åŠ¡ä¸­çš„æ£€æŸ¥ç‚¹ï¼Œæ”¯æŒç²¾ç¡®å›æ»šæ§åˆ¶
- é€‚ç”¨äºå¤æ‚ä¸šåŠ¡æµç¨‹ï¼Œæä¾›æ¯”å…¨æœ‰å…¨æ— æ›´çµæ´»çš„é€‰æ‹©
- åˆç†è®¾è®¡ä¿å­˜ç‚¹ä½ç½®å’Œå›æ»šç­–ç•¥æ˜¯å…³é”®
- æ³¨æ„æ€§èƒ½å½±å“å’Œèµ„æºç®¡ç†ï¼Œä¸è¦æ»¥ç”¨