---
title: 4、Druid连接池与监控
---
## 📚 目录

1. [连接池基础概念](#1-连接池基础概念)
2. [Druid连接池介绍](#2-druid连接池介绍)
3. [Druid基本配置](#3-druid基本配置)
4. [核心配置参数详解](#4-核心配置参数详解)
5. [监控功能配置](#5-监控功能配置)
6. [实战配置案例](#6-实战配置案例)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 🏊‍♀️ 连接池基础概念


### 1.1 什么是数据库连接池


**🤔 生活类比**
> 想象一下游泳池：如果每次有人想游泳都要临时挖一个池子，用完就填平，这样效率很低。连接池就像一个现成的游泳池，大家排队使用，用完归还，既高效又节约资源。

**📋 核心定义**
```
数据库连接池：提前创建一定数量的数据库连接，放在"池子"里
目的：避免频繁创建和销毁连接，提高程序性能
原理：程序需要时从池中取连接，用完后归还到池中
```

### 1.2 为什么需要连接池


**🚫 没有连接池的问题**
```
传统方式的问题：
┌─────────────────┐    ┌──────────────────┐
│ 每次都要创建连接  │ ─→ │ 耗时：100-200ms   │
├─────────────────┤    ├──────────────────┤
│ 用完立即关闭连接  │ ─→ │ 浪费资源和时间     │
├─────────────────┤    ├──────────────────┤
│ 频繁创建销毁     │ ─→ │ 服务器压力大      │
└─────────────────┘    └──────────────────┘
```

**✅ 使用连接池的好处**

| 优势 | 传统方式 | 连接池方式 |
|-----|---------|-----------|
| **性能** | 每次创建耗时100-200ms | 复用连接，几乎无耗时 |
| **资源占用** | 频繁申请释放资源 | 预先分配，稳定占用 |
| **并发处理** | 连接数不可控 | 可控制最大连接数 |
| **系统稳定性** | 可能造成连接泄露 | 统一管理，更稳定 |

### 1.3 连接池工作原理


**🔄 连接池生命周期**
```
启动阶段：
应用启动 → 初始化连接池 → 创建初始连接 → 连接进入空闲队列

运行阶段：
程序请求连接 → 从空闲队列获取 → 执行数据库操作 → 归还到空闲队列
     ↓
如果没有空闲连接且未达到最大数量 → 创建新连接
     ↓  
如果达到最大连接数 → 等待或抛出异常

关闭阶段：
应用关闭 → 关闭所有连接 → 释放资源
```

---

## 2. 🌟 Druid连接池介绍


### 2.1 Druid是什么


**📖 基本介绍**
```
Druid：阿里巴巴开源的数据库连接池
特点：高性能、功能丰富、监控完善
优势：不仅仅是连接池，还是数据库访问的监控工具
地位：国内使用最广泛的连接池之一
```

**🏆 Druid vs 其他连接池**

| 连接池 | 性能 | 监控功能 | 配置复杂度 | 适用场景 |
|--------|------|----------|------------|----------|
| **Druid** | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | 生产环境首选 |
| **HikariCP** | ⭐⭐⭐⭐⭐ | ⭐⭐ | ⭐⭐ | 追求极致性能 |
| **C3P0** | ⭐⭐ | ⭐ | ⭐⭐⭐⭐ | 老项目维护 |
| **DBCP** | ⭐⭐⭐ | ⭐ | ⭐⭐ | Apache项目 |

### 2.2 Druid核心功能


**🎯 主要特性**
```
🔸 连接池管理：高效的连接创建、分配、回收
🔸 SQL监控：记录SQL执行情况、慢查询统计
🔸 Web监控：提供可视化的监控页面
🔸 防御保护：SQL注入检测、密码加密等安全功能
🔸 扩展过滤：支持自定义过滤器扩展功能
```

**💡 为什么选择Druid**
> 如果把数据库连接池比作汽车，其他连接池就像普通汽车，能跑就行；而Druid就像智能汽车，不仅跑得好，还有仪表盘告诉你油耗、速度、路况等各种信息。

---

## 3. ⚙️ Druid基本配置


### 3.1 添加依赖


**📦 Maven依赖**
```xml
<dependency>
    <groupId>com.alibaba</groupId>
    <artifactId>druid</artifactId>
    <version>1.2.8</version>
</dependency>
```

### 3.2 配置文件方式


**📄 druid.properties文件**
```properties
# 数据库连接基本信息
driverClassName=com.mysql.cj.jdbc.Driver
url=jdbc:mysql://localhost:3306/test?useSSL=false&serverTimezone=Asia/Shanghai
username=root
password=123456

# 连接池核心配置
initialSize=5
maxActive=20
minIdle=5
maxWait=60000

# 连接校验配置
validationQuery=SELECT 1
testWhileIdle=true
testOnBorrow=false
testOnReturn=false
```

### 3.3 Java代码配置


```java
public class DruidUtil {
    private static DataSource dataSource;
    
    // 静态代码块，程序启动时执行一次
    static {
        try {
            // 加载配置文件
            Properties prop = new Properties();
            prop.load(DruidUtil.class.getClassLoader()
                .getResourceAsStream("druid.properties"));
            
            // 创建数据源
            dataSource = DruidDataSourceFactory.createDataSource(prop);
            
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    // 获取连接的方法
    public static Connection getConnection() throws SQLException {
        return dataSource.getConnection();
    }
    
    // 释放资源的方法
    public static void close(ResultSet rs, Statement stmt, Connection conn) {
        if (rs != null) {
            try { rs.close(); } catch (SQLException e) { e.printStackTrace(); }
        }
        if (stmt != null) {
            try { stmt.close(); } catch (SQLException e) { e.printStackTrace(); }
        }
        if (conn != null) {
            try { conn.close(); } catch (SQLException e) { e.printStackTrace(); }
        }
    }
}
```

**🔍 代码解释**
> 这段代码创建了一个工具类，程序启动时自动读取配置文件并初始化连接池。就像在程序启动时就把"游泳池"准备好，需要时直接使用。

---

## 4. 🔧 核心配置参数详解


### 4.1 连接数量控制参数


**📊 连接数配置详解**

| 参数 | 含义 | 推荐值 | 说明 |
|------|------|--------|------|
| **initialSize** | 初始连接数 | 5-10 | 程序启动时创建的连接数 |
| **maxActive** | 最大活跃连接数 | 20-50 | 同时最多能使用的连接数 |
| **minIdle** | 最小空闲连接数 | 5-10 | 空闲时保持的最少连接数 |

**🏠 生活类比解释**
```
想象一个停车场：
┌─────────────────────────────────────┐
│ initialSize=5  │ 开业时准备5个停车位 │
│ maxActive=20   │ 最多能停20辆车      │
│ minIdle=5      │ 至少保留5个空车位   │
└─────────────────────────────────────┘

实际运行中：
高峰期：停车位全满(20个)，有新车来要排队等
低峰期：至少保持5个车位空着，随时可用
```

### 4.2 等待和超时参数


**⏰ 时间控制配置**
```properties
# 获取连接等待超时时间（毫秒）
maxWait=60000

# 连接空闲超时时间（毫秒）  
timeBetweenEvictionRunsMillis=60000

# 连接在池中最小生存时间（毫秒）
minEvictableIdleTimeMillis=300000
```

**💭 参数含义解释**
- **maxWait**: 如果连接池满了，新请求最多等待多长时间（60秒）
- **timeBetweenEvictionRunsMillis**: 每隔多长时间检查一次连接是否需要清理（60秒）
- **minEvictableIdleTimeMillis**: 连接空闲多长时间后可以被清理（5分钟）

### 4.3 连接校验参数


**✅ 连接有效性检查**
```properties
# 校验SQL语句
validationQuery=SELECT 1

# 空闲时检查连接是否有效
testWhileIdle=true

# 获取连接时检查有效性
testOnBorrow=false

# 归还连接时检查有效性  
testOnReturn=false
```

**🔍 校验配置详解**

| 参数 | 推荐值 | 原因说明 |
|------|--------|----------|
| **validationQuery** | `SELECT 1` | 最简单的SQL，验证连接是否可用 |
| **testWhileIdle** | `true` | 空闲时检查，清理无效连接 |
| **testOnBorrow** | `false` | 获取时不检查，影响性能 |
| **testOnReturn** | `false` | 归还时不检查，影响性能 |

**💡 为什么这样配置**
> 就像定期检查游泳池水质，我们在连接空闲时检查是否还能正常使用，但不在每次使用时都检查，这样既保证质量又不影响效率。

---

## 5. 📊 监控功能配置


### 5.1 启用StatViewServlet监控


**🖥️ 监控页面配置**

**web.xml配置方式**
```xml
<servlet>
    <servlet-name>DruidStatView</servlet-name>
    <servlet-class>com.alibaba.druid.support.http.StatViewServlet</servlet-class>
    <init-param>
        <param-name>allow</param-name>
        <param-value>127.0.0.1</param-value>
    </init-param>
    <init-param>
        <param-name>deny</param-name>
        <param-value></param-value>
    </init-param>
    <init-param>
        <param-name>loginUsername</param-name>
        <param-value>admin</param-value>
    </init-param>
    <init-param>
        <param-name>loginPassword</param-name>
        <param-value>admin</param-value>
    </init-param>
</servlet>

<servlet-mapping>
    <servlet-name>DruidStatView</servlet-name>
    <url-pattern>/druid/*</url-pattern>
</servlet-mapping>
```

### 5.2 启用WebStatFilter统计


**📈 SQL统计过滤器**
```xml
<filter>
    <filter-name>DruidWebStatFilter</filter-name>
    <filter-class>com.alibaba.druid.support.http.WebStatFilter</filter-class>
    <init-param>
        <param-name>exclusions</param-name>
        <param-value>*.js,*.gif,*.jpg,*.png,*.css,*.ico,/druid/*</param-value>
    </init-param>
</filter>

<filter-mapping>
    <filter-name>DruidWebStatFilter</filter-name>
    <url-pattern>/*</url-pattern>
</filter-mapping>
```

### 5.3 监控页面功能介绍


**📋 监控面板功能**
```
监控页面访问地址：http://localhost:8080/项目名/druid/

主要功能模块：
├── 数据源监控
│   ├── 连接池状态：活跃连接数、空闲连接数
│   ├── 连接详情：创建时间、最后活跃时间
│   └── 错误统计：连接失败次数、异常信息
├── SQL监控  
│   ├── SQL执行统计：执行次数、平均耗时
│   ├── 慢SQL监控：超过阈值的SQL语句
│   └── SQL防火墙：阻止的SQL注入攻击
├── Web应用监控
│   ├── URL访问统计：各接口调用次数和耗时
│   ├── Session监控：当前活跃会话数
│   └── 错误统计：HTTP错误码统计
└── Spring监控
    ├── Spring Bean监控：Bean创建和调用统计  
    └── 方法调用监控：方法执行次数和耗时
```

---

## 6. 🚀 实战配置案例


### 6.1 完整配置文件示例


**📄 生产环境推荐配置**
```properties
# ===== 数据库连接基本信息 =====
driverClassName=com.mysql.cj.jdbc.Driver
url=jdbc:mysql://localhost:3306/test?useSSL=false&serverTimezone=Asia/Shanghai&useUnicode=true&characterEncoding=utf8
username=root
password=123456

# ===== 连接池核心配置 =====  
# 初始化时建立物理连接的个数
initialSize=5
# 最大连接池数量
maxActive=20
# 最小连接池数量
minIdle=5
# 获取连接时最大等待时间，单位毫秒
maxWait=60000

# ===== 连接保活和回收配置 =====
# 间隔多久进行一次检测，检测需要关闭的空闲连接，单位毫秒
timeBetweenEvictionRunsMillis=60000
# 一个连接在池中最小生存的时间，单位毫秒
minEvictableIdleTimeMillis=300000

# ===== 连接校验配置 =====
# 用于检测连接是否有效的SQL
validationQuery=SELECT 1
# 在空闲时检查有效性
testWhileIdle=true
# 申请连接时不检测（影响性能）
testOnBorrow=false
# 归还连接时不检测（影响性能）
testOnReturn=false

# ===== 监控统计功能 =====
# 监控统计拦截的filters，去掉后监控界面sql无法统计
filters=stat,wall
# 通过connectProperties属性来打开mergeSql功能；慢SQL记录
connectionProperties=druid.stat.mergeSql=true;druid.stat.slowSqlMillis=500
```

### 6.2 实际使用示例


```java
public class UserDao {
    
    // 查询用户信息示例
    public User findById(int id) {
        Connection conn = null;
        PreparedStatement pstmt = null;
        ResultSet rs = null;
        User user = null;
        
        try {
            // 从连接池获取连接
            conn = DruidUtil.getConnection();
            
            String sql = "SELECT * FROM users WHERE id = ?";
            pstmt = conn.prepareStatement(sql);
            pstmt.setInt(1, id);
            
            rs = pstmt.executeQuery();
            
            if (rs.next()) {
                user = new User();
                user.setId(rs.getInt("id"));
                user.setName(rs.getString("name"));
                user.setEmail(rs.getString("email"));
            }
            
        } catch (SQLException e) {
            e.printStackTrace();
        } finally {
            // 释放资源（连接归还到池中）
            DruidUtil.close(rs, pstmt, conn);
        }
        
        return user;
    }
}
```

### 6.3 常见问题和解决方案


**⚠️ 常见问题排查**

| 问题现象 | 可能原因 | 解决方案 |
|---------|---------|---------|
| 获取连接超时 | maxActive设置过小 | 增加最大连接数或检查连接泄露 |
| 连接数不断增长 | 连接没有正确关闭 | 检查代码中是否有连接泄露 |
| 监控页面无数据 | 没有配置统计过滤器 | 添加filters=stat配置 |
| 慢SQL没有记录 | 慢SQL阈值设置不当 | 调整slowSqlMillis参数 |

**🔧 调试技巧**
```properties
# 打开日志，方便调试
druid.stat.logSlowSql=true
druid.stat.slowSqlMillis=1000

# 连接泄露检测
removeAbandoned=true
removeAbandonedTimeout=1800
logAbandoned=true
```

---

## 7. 📋 核心要点总结


### 7.1 必须掌握的核心概念


```
🔸 连接池本质：预先创建连接，重复使用，提高性能
🔸 Druid优势：不仅是连接池，更是监控和管理工具
🔸 核心配置：连接数控制、校验策略、监控启用
🔸 监控价值：实时了解数据库访问情况，优化性能
🔸 最佳实践：合理配置参数，正确管理连接生命周期
```

### 7.2 关键配置参数速记


**🎯 生产环境推荐配置**
```
连接数配置：
initialSize=5    (初始连接数)
maxActive=20     (最大连接数)  
minIdle=5        (最小空闲数)
maxWait=60000    (最大等待时间)

校验配置：
validationQuery=SELECT 1  (校验SQL)
testWhileIdle=true        (空闲时校验)
testOnBorrow=false        (获取时不校验)

监控配置：
filters=stat,wall         (启用监控和防火墙)
```

### 7.3 实际应用指导


**📝 学习检查点**
- [ ] 理解连接池的作用和原理
- [ ] 掌握Druid的基本配置方法
- [ ] 了解核心参数的含义和推荐值
- [ ] 能够配置和使用监控功能
- [ ] 知道如何排查常见问题

**💡 关键洞察**
> 连接池不仅仅是提高性能的工具，更是数据库访问的管理中心。通过监控功能，我们可以及时发现性能瓶颈和问题SQL，这对于系统优化非常重要。

**🚀 下一步学习**
- 深入学习MyBatis框架集成Druid
- 了解Spring Boot中的Druid自动配置
- 学习更高级的监控和调优技巧

**🔑 记忆口诀**
> Druid连接池，性能监控全；五个初始数，二十最大限；校验选空闲，监控stat开；配置要合理，项目跑得欢！

---

**核心记忆**：
- Druid = 连接池 + 监控工具，一箭双雕
- 核心配置记住"5-20-5-60000"（初始-最大-最小-等待）
- 监控页面是调优的重要工具，必须掌握
- 正确的资源管理是避免连接泄露的关键