---
title: 6ã€DAOå±‚å¸¸è§é—®é¢˜ä¸ä¼˜åŒ–
---
## ğŸ“š ç›®å½•

1. [DAOå±‚é—®é¢˜æ¦‚è§ˆ](#1-DAOå±‚é—®é¢˜æ¦‚è§ˆ)
2. [SQLæ³¨å…¥é˜²æŠ¤](#2-SQLæ³¨å…¥é˜²æŠ¤)
3. [N+1æŸ¥è¯¢é—®é¢˜è§£å†³](#3-N+1æŸ¥è¯¢é—®é¢˜è§£å†³)
4. [èµ„æºæ³„æ¼é˜²æ­¢](#4-èµ„æºæ³„æ¼é˜²æ­¢)
5. [æ‰¹é‡æ“ä½œä¼˜åŒ–](#5-æ‰¹é‡æ“ä½œä¼˜åŒ–)
6. [ç¼“å­˜ç­–ç•¥åº”ç”¨](#6-ç¼“å­˜ç­–ç•¥åº”ç”¨)
7. [æ€§èƒ½è°ƒä¼˜å®è·µ](#7-æ€§èƒ½è°ƒä¼˜å®è·µ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸš¨ DAOå±‚é—®é¢˜æ¦‚è§ˆ


### 1.1 ä»€ä¹ˆæ˜¯DAOå±‚é—®é¢˜


**DAOå±‚**å°±åƒæ˜¯ä½ å®¶çš„**æ°´ç®¡ç³»ç»Ÿ**ï¼Œè´Ÿè´£æŠŠæ•°æ®ä»æ•°æ®åº“"è¿è¾“"åˆ°ç¨‹åºä¸­ã€‚å¦‚æœæ°´ç®¡æœ‰é—®é¢˜ï¼Œè¦ä¹ˆæ°´æµä¸å‡ºæ¥ï¼ˆæŸ¥ä¸åˆ°æ•°æ®ï¼‰ï¼Œè¦ä¹ˆæ°´ç®¡çˆ†äº†ï¼ˆç³»ç»Ÿå´©æºƒï¼‰ï¼Œè¦ä¹ˆæ°´è´¨æœ‰é—®é¢˜ï¼ˆæ•°æ®ä¸å®‰å…¨ï¼‰ã€‚

```
ç”¨æˆ·è¯·æ±‚ â†’ Controller â†’ Service â†’ DAO â†’ æ•°æ®åº“
                                  â†‘
                            é—®é¢˜ç»å¸¸å‡ºç°çš„åœ°æ–¹
```

**ğŸ” å¸¸è§é—®é¢˜åˆ†ç±»**
- **ğŸ›¡ï¸ å®‰å…¨é—®é¢˜**ï¼šSQLæ³¨å…¥æ”»å‡»
- **ğŸŒ æ€§èƒ½é—®é¢˜**ï¼šæŸ¥è¯¢æ…¢ã€èµ„æºæµªè´¹
- **ğŸ’§ èµ„æºé—®é¢˜**ï¼šè¿æ¥æ³„æ¼ã€å†…å­˜æº¢å‡º
- **ğŸ”„ è®¾è®¡é—®é¢˜**ï¼šé‡å¤æŸ¥è¯¢ã€æ‰¹é‡å¤„ç†ä¸å½“

### 1.2 ä¸ºä»€ä¹ˆDAOå±‚å®¹æ˜“å‡ºé—®é¢˜


æƒ³è±¡DAOå±‚æ˜¯**é¤å…çš„åå¨**ï¼š
- åå¨ç›´æ¥å¤„ç†"åŸæ–™"ï¼ˆæ•°æ®åº“ï¼‰
- å¦‚æœåå¨ç®¡ç†ä¸å¥½ï¼Œæ•´ä¸ªé¤å…éƒ½ä¼šå‡ºé—®é¢˜
- é¡¾å®¢çœ‹ä¸åˆ°åå¨ï¼Œä½†èƒ½æ„Ÿå—åˆ°æœåŠ¡è´¨é‡

```
å‰ç«¯ç•Œé¢ â† Controller â† Service â† DAO â† æ•°æ®åº“
ç¾è§‚ç•Œé¢   ä¸šåŠ¡é€»è¾‘å¤„ç†   ä¸šåŠ¡è§„åˆ™   æ•°æ®å¤„ç†   åŸå§‹æ•°æ®
   â†‘         â†‘           â†‘         â†‘        â†‘
 ç”¨æˆ·ä½“éªŒ    åŠŸèƒ½å®ç°    è§„åˆ™ç®¡ç†   **é—®é¢˜é«˜å‘**  æ•°æ®å­˜å‚¨
```

---

## 2. ğŸ›¡ï¸ SQLæ³¨å…¥é˜²æŠ¤


### 2.1 ä»€ä¹ˆæ˜¯SQLæ³¨å…¥


**SQLæ³¨å…¥**å°±åƒæ˜¯**"é’¥åŒ™è¢«åäººå¤åˆ¶äº†"**ã€‚æœ¬æ¥ä½ åªæƒ³è®©ç¨‹åºæŒ‰è§„çŸ©æŸ¥æ•°æ®ï¼Œç»“æœåäººé€šè¿‡ç‰¹æ®Šè¾“å…¥ï¼Œè®©ç¨‹åºæ‰§è¡Œäº†ä¸è¯¥æ‰§è¡Œçš„SQLå‘½ä»¤ã€‚

**ğŸ” SQLæ³¨å…¥çš„é€šä¿—ç†è§£**
```
æ­£å¸¸æƒ…å†µï¼ˆå¥½äººç”¨é’¥åŒ™å¼€é—¨ï¼‰ï¼š
ç”¨æˆ·è¾“å…¥ï¼šå¼ ä¸‰
SQLæ‰§è¡Œï¼šSELECT * FROM user WHERE name = 'å¼ ä¸‰'

æ³¨å…¥æ”»å‡»ï¼ˆåäººç”¨ä¸‡èƒ½é’¥åŒ™ï¼‰ï¼š
ç”¨æˆ·è¾“å…¥ï¼š'; DELETE FROM user; --
SQLæ‰§è¡Œï¼šSELECT * FROM user WHERE name = ''; DELETE FROM user; --'
ç»“æœï¼šæ‰€æœ‰ç”¨æˆ·æ•°æ®è¢«åˆ é™¤ï¼
```

### 2.2 å±é™©çš„SQLæ‹¼æ¥æ–¹å¼


**âŒ é”™è¯¯åšæ³•ï¼ˆç›´æ¥æ‹¼æ¥ï¼‰**
```java
// è¿™ç§å†™æ³•éå¸¸å±é™©ï¼
public User findUserByName(String name) {
    String sql = "SELECT * FROM user WHERE name = '" + name + "'";
    // å¦‚æœnameæ˜¯æ¶æ„è¾“å…¥ï¼Œå°±å®Œè›‹äº†
}
```

**ä¸ºä»€ä¹ˆå±é™©ï¼Ÿ**
- ç”¨æˆ·è¾“å…¥ç›´æ¥æ‹¼æ¥åˆ°SQLä¸­
- æ¶æ„ç”¨æˆ·å¯ä»¥æ³¨å…¥SQLå‘½ä»¤
- æ•°æ®åº“æŠŠæ³¨å…¥çš„å†…å®¹å½“ä½œSQLæ‰§è¡Œ

### 2.3 æ­£ç¡®çš„é˜²æŠ¤æ–¹æ³•


**âœ… ä½¿ç”¨PreparedStatementï¼ˆé¢„ç¼–è¯‘è¯­å¥ï¼‰**

```java
public class UserDao {
    // æ­£ç¡®çš„åšæ³•ï¼šä½¿ç”¨å ä½ç¬¦
    public User findUserByName(String name) {
        String sql = "SELECT * FROM user WHERE name = ?";
        try (PreparedStatement ps = connection.prepareStatement(sql)) {
            ps.setString(1, name);  // å®‰å…¨è®¾ç½®å‚æ•°
            ResultSet rs = ps.executeQuery();
            // å¤„ç†ç»“æœ...
        }
    }
    
    // å¤šä¸ªå‚æ•°çš„ä¾‹å­
    public List<User> findUsersByAgeRange(int minAge, int maxAge) {
        String sql = "SELECT * FROM user WHERE age >= ? AND age <= ?";
        try (PreparedStatement ps = connection.prepareStatement(sql)) {
            ps.setInt(1, minAge);
            ps.setInt(2, maxAge);
            // æ‰§è¡ŒæŸ¥è¯¢...
        }
    }
}
```

**ğŸ”’ ä¸ºä»€ä¹ˆPreparedStatementå®‰å…¨ï¼Ÿ**
```
å·¥ä½œåŸç†å›¾è§£ï¼š

æ­¥éª¤1ï¼šSQLæ¨¡æ¿é¢„ç¼–è¯‘
"SELECT * FROM user WHERE name = ?"
      â†“ æ•°æ®åº“é¢„ç¼–è¯‘
SQLæ‰§è¡Œè®¡åˆ’å·²ç¡®å®šï¼Œç»“æ„ä¸å¯æ”¹å˜

æ­¥éª¤2ï¼šå‚æ•°å®‰å…¨æ›¿æ¢
ç”¨æˆ·è¾“å…¥ â†’ å‚æ•°æ£€æŸ¥ â†’ å®‰å…¨æ›¿æ¢åˆ°?ä½ç½®
æ¶æ„ä»£ç æ— æ³•æ”¹å˜SQLç»“æ„
```

### 2.4 å…¶ä»–é˜²æŠ¤æªæ–½


**ğŸ” è¾“å…¥éªŒè¯**
```java
public class InputValidator {
    // éªŒè¯ç”¨æˆ·åæ ¼å¼
    public boolean isValidUsername(String username) {
        if (username == null || username.trim().isEmpty()) {
            return false;
        }
        // åªå…è®¸å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿
        return username.matches("^[a-zA-Z0-9_]{3,20}$");
    }
    
    // éªŒè¯æ•°å­—ç±»å‹
    public boolean isValidAge(String ageStr) {
        try {
            int age = Integer.parseInt(ageStr);
            return age > 0 && age < 150;
        } catch (NumberFormatException e) {
            return false;
        }
    }
}
```

---

## 3. ğŸŒ N+1æŸ¥è¯¢é—®é¢˜è§£å†³


### 3.1 ä»€ä¹ˆæ˜¯N+1æŸ¥è¯¢é—®é¢˜


**N+1æŸ¥è¯¢**å°±åƒæ˜¯**"ä¹°èœæ•ˆç‡ä½"**çš„é—®é¢˜ã€‚æœ¬æ¥å¯ä»¥ä¸€æ¬¡ä¹°å®Œæ‰€æœ‰èœï¼Œç»“æœä½ å…ˆå»èœå¸‚åœºé—®æœ‰ä»€ä¹ˆèœï¼ˆ1æ¬¡ï¼‰ï¼Œç„¶åæ¯ç§èœéƒ½è·‘ä¸€è¶Ÿå»ä¹°ï¼ˆNæ¬¡ï¼‰ï¼Œæ€»å…±è·‘äº†N+1è¶Ÿã€‚

**ğŸ“Š é—®é¢˜æ¼”ç¤º**
```
åœºæ™¯ï¼šæŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·åŠå…¶è®¢å•ä¿¡æ¯

é”™è¯¯åšæ³•ï¼ˆN+1æŸ¥è¯¢ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ· (1æ¬¡æŸ¥è¯¢)          â”‚
â”‚    SELECT * FROM user           â”‚
â”‚                                â”‚
â”‚ 2. ä¸ºæ¯ä¸ªç”¨æˆ·æŸ¥è¯¢è®¢å• (Næ¬¡æŸ¥è¯¢)      â”‚
â”‚    SELECT * FROM order WHERE uid=1 â”‚
â”‚    SELECT * FROM order WHERE uid=2 â”‚
â”‚    SELECT * FROM order WHERE uid=3 â”‚
â”‚    ...                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
æ€»æŸ¥è¯¢æ¬¡æ•°ï¼š1 + N = 101æ¬¡ï¼ˆå¦‚æœæœ‰100ä¸ªç”¨æˆ·ï¼‰
```

### 3.2 N+1é—®é¢˜çš„å±å®³


**æ€§èƒ½å¯¹æ¯”å›¾**
```
æ•°æ®é‡      N+1æŸ¥è¯¢è€—æ—¶    ä¼˜åŒ–åè€—æ—¶    æ€§èƒ½æå‡
10æ¡       50ms          10ms         5å€
100æ¡      500ms         15ms         33å€  
1000æ¡     5000ms        50ms         100å€
10000æ¡    50000ms       200ms        250å€
```

**çœŸå®å½±å“**
- æ•°æ®åº“è¿æ¥æ•°çˆ†æ»¡
- é¡µé¢åŠ è½½è¶…çº§æ…¢
- æœåŠ¡å™¨èµ„æºè€—å°½
- ç”¨æˆ·ä½“éªŒæå·®

### 3.3 è§£å†³æ–¹æ¡ˆï¼šJOINæŸ¥è¯¢


**âœ… æ­£ç¡®åšæ³•ï¼ˆä¸€æ¬¡æŸ¥è¯¢ï¼‰**
```java
public class UserOrderDao {
    // æ–¹æ¡ˆ1ï¼šä½¿ç”¨JOINä¸€æ¬¡æ€§è·å–æ‰€æœ‰æ•°æ®
    public List<UserWithOrders> findUsersWithOrders() {
        String sql = """
            SELECT u.id as user_id, u.name as user_name,
                   o.id as order_id, o.product_name
            FROM user u 
            LEFT JOIN order_table o ON u.id = o.user_id
            ORDER BY u.id
            """;
        
        // æ‰§è¡Œä¸€æ¬¡æŸ¥è¯¢ï¼Œè·å–æ‰€æœ‰æ•°æ®
        // ç„¶ååœ¨Javaä»£ç ä¸­ç»„è£…å¯¹è±¡å…³ç³»
    }
}
```

**ğŸ”„ æ•°æ®ç»„è£…è¿‡ç¨‹**
```
æŸ¥è¯¢ç»“æœï¼ˆæ‰å¹³åŒ–ï¼‰ï¼š
user_id | user_name | order_id | product_name
   1    |   å¼ ä¸‰    |    101   |   æ‰‹æœº
   1    |   å¼ ä¸‰    |    102   |   ç”µè„‘  
   2    |   æå››    |    103   |   ä¹¦ç±

Javaç»„è£…ç»“æœï¼š
ç”¨æˆ·1(å¼ ä¸‰) â†’ [è®¢å•101(æ‰‹æœº), è®¢å•102(ç”µè„‘)]
ç”¨æˆ·2(æå››) â†’ [è®¢å•103(ä¹¦ç±)]
```

### 3.4 åˆ†æ‰¹æŸ¥è¯¢ä¼˜åŒ–


**é€‚ç”¨åœºæ™¯**ï¼šå½“JOINæŸ¥è¯¢ç»“æœè¿‡å¤§æ—¶

```java
public class OptimizedDao {
    // æ–¹æ¡ˆ2ï¼šåˆ†æ‰¹æŸ¥è¯¢ï¼ˆé€‚åˆå¤§æ•°æ®é‡ï¼‰
    public List<UserWithOrders> findUsersWithOrdersBatch() {
        // æ­¥éª¤1ï¼šæŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
        List<User> users = findAllUsers();
        
        // æ­¥éª¤2ï¼šæ‰¹é‡æŸ¥è¯¢æ‰€æœ‰è®¢å•
        List<Integer> userIds = users.stream()
            .map(User::getId)
            .collect(Collectors.toList());
            
        String sql = "SELECT * FROM order_table WHERE user_id IN (?, ?, ?, ...)";
        List<Order> allOrders = findOrdersByUserIds(userIds);
        
        // æ­¥éª¤3ï¼šåœ¨å†…å­˜ä¸­ç»„è£…å…³ç³»
        return assembleUsersWithOrders(users, allOrders);
    }
}
```

---

## 4. ğŸ’§ èµ„æºæ³„æ¼é˜²æ­¢


### 4.1 ä»€ä¹ˆæ˜¯èµ„æºæ³„æ¼


**èµ„æºæ³„æ¼**å°±åƒæ˜¯**"æ°´é¾™å¤´æ²¡å…³"**ã€‚ç¨‹åºæ‰“å¼€äº†æ•°æ®åº“è¿æ¥ã€æ–‡ä»¶ç­‰èµ„æºï¼Œç”¨å®Œåå¿˜è®°å…³é—­ï¼Œæ—¶é—´é•¿äº†å°±æŠŠç³»ç»Ÿ"æ·¹äº†"ã€‚

**ğŸ” èµ„æºæ³„æ¼çš„åæœ**
```
èµ„æºä½¿ç”¨æƒ…å†µå›¾ï¼š
è¿æ¥æ•°
  â†‘
  |  Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—  â† è¿æ¥æ± è€—å°½ï¼Œç³»ç»Ÿå´©æºƒ
  |  Ã—Ã—Ã—Ã—Ã—
  |  Ã—Ã—Ã—Ã—
  |  Ã—Ã—Ã—  â† èµ„æºæ³„æ¼ï¼Œè¿æ¥ä¸æ–­ç´¯ç§¯
  |  Ã—Ã—
  |  Ã—
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ æ—¶é—´
æ­£å¸¸æƒ…å†µåº”è¯¥ï¼šç”¨å®Œå°±é‡Šæ”¾ â†‘â†“â†‘â†“â†‘â†“
```

### 4.2 å¸¸è§çš„èµ„æºæ³„æ¼åœºæ™¯


**âŒ å…¸å‹é”™è¯¯ä»£ç **
```java
public class LeakyDao {
    // é”™è¯¯ç¤ºä¾‹1ï¼šè¿æ¥æ²¡æœ‰å…³é—­
    public User findUser(int id) {
        Connection conn = getConnection();
        PreparedStatement ps = conn.prepareStatement("SELECT * FROM user WHERE id = ?");
        ps.setInt(1, id);
        ResultSet rs = ps.executeQuery();
        
        // å¤„ç†ç»“æœ...
        
        // å¿˜è®°å…³é—­èµ„æºï¼è¿æ¥ä¼šä¸€ç›´å ç”¨
        return user;
    }
    
    // é”™è¯¯ç¤ºä¾‹2ï¼šå¼‚å¸¸æ—¶èµ„æºæ²¡é‡Šæ”¾
    public void updateUser(User user) {
        Connection conn = getConnection();
        PreparedStatement ps = conn.prepareStatement("UPDATE user SET name = ? WHERE id = ?");
        
        ps.setString(1, user.getName());
        ps.setInt(2, user.getId());
        ps.executeUpdate();
        
        // å¦‚æœæ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸ï¼Œä¸‹é¢çš„ä»£ç ä¸ä¼šæ‰§è¡Œ
        ps.close();
        conn.close();
    }
}
```

### 4.3 æ­£ç¡®çš„èµ„æºç®¡ç†


**âœ… ä½¿ç”¨try-with-resourcesï¼ˆæ¨èï¼‰**
```java
public class ProperDao {
    // æ­£ç¡®åšæ³•ï¼štry-with-resourcesè‡ªåŠ¨ç®¡ç†èµ„æº
    public User findUser(int id) {
        String sql = "SELECT * FROM user WHERE id = ?";
        
        try (Connection conn = getConnection();
             PreparedStatement ps = conn.prepareStatement(sql)) {
            
            ps.setInt(1, id);
            
            try (ResultSet rs = ps.executeQuery()) {
                if (rs.next()) {
                    return new User(rs.getInt("id"), rs.getString("name"));
                }
            }
        } catch (SQLException e) {
            throw new DaoException("æŸ¥è¯¢ç”¨æˆ·å¤±è´¥", e);
        }
        
        return null;
        // æ— è®ºæ˜¯å¦å‡ºç°å¼‚å¸¸ï¼Œæ‰€æœ‰èµ„æºéƒ½ä¼šè‡ªåŠ¨å…³é—­
    }
}
```

**ğŸ”„ èµ„æºç®¡ç†æµç¨‹**
```
try-with-resourceså·¥ä½œæµç¨‹ï¼š

å¼€å§‹ â†’ è·å–èµ„æº â†’ æ‰§è¡Œä¸šåŠ¡é€»è¾‘ â†’ æ­£å¸¸ç»“æŸ â†’ è‡ªåŠ¨å…³é—­èµ„æº
         â†“                         â†—
      å‡ºç°å¼‚å¸¸ â†’ è®°å½•å¼‚å¸¸ â†’ è‡ªåŠ¨å…³é—­èµ„æº â†’ æŠ›å‡ºå¼‚å¸¸

æ— è®ºå“ªç§æƒ…å†µï¼Œèµ„æºéƒ½ä¼šè¢«æ­£ç¡®é‡Šæ”¾ï¼
```

### 4.4 è¿æ¥æ± æœ€ä½³å®è·µ


**ğŸŠâ€â™‚ï¸ è¿æ¥æ± å°±åƒæ¸¸æ³³æ± **
```java
public class ConnectionManager {
    private static final int MAX_POOL_SIZE = 20;    // æœ€å¤§è¿æ¥æ•°
    private static final int MIN_POOL_SIZE = 5;     // æœ€å°è¿æ¥æ•°
    private static final int MAX_WAIT_TIME = 30000; // æœ€å¤§ç­‰å¾…æ—¶é—´(æ¯«ç§’)
    
    // é…ç½®è¿æ¥æ± å‚æ•°
    public DataSource createDataSource() {
        HikariConfig config = new HikariConfig();
        config.setMaximumPoolSize(MAX_POOL_SIZE);
        config.setMinimumIdle(MIN_POOL_SIZE);
        config.setConnectionTimeout(MAX_WAIT_TIME);
        config.setIdleTimeout(600000); // ç©ºé—²è¿æ¥è¶…æ—¶æ—¶é—´
        
        return new HikariDataSource(config);
    }
}
```

**ğŸ” è¿æ¥æ± ç›‘æ§**
```
è¿æ¥æ± çŠ¶æ€ç›‘æ§ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ€»è¿æ¥æ•°ï¼š20                â”‚
â”‚ æ´»è·ƒè¿æ¥ï¼š15 (75%)          â”‚  
â”‚ ç©ºé—²è¿æ¥ï¼š5  (25%)          â”‚
â”‚ ç­‰å¾…è¯·æ±‚ï¼š2                 â”‚
â”‚ å¹³å‡å“åº”ï¼š50ms              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âš ï¸ è­¦å‘Šä¿¡å·ï¼š
- æ´»è·ƒè¿æ¥è¶…è¿‡90%
- ç­‰å¾…è¯·æ±‚æ•°é‡å¢åŠ 
- å¹³å‡å“åº”æ—¶é—´å˜é•¿
```

---

## 5. ğŸš€ æ‰¹é‡æ“ä½œä¼˜åŒ–


### 5.1 æ‰¹é‡æ“ä½œçš„é‡è¦æ€§


**æ‰¹é‡æ“ä½œ**å°±åƒæ˜¯**"æ¬å®¶æ‰“åŒ…"**ã€‚ä¸€ä¸ªä¸€ä¸ªæ¬ä¸œè¥¿å¾ˆç´¯ï¼ŒæŠŠä¸œè¥¿è£…ç®±æ‰¹é‡æ¬è¿æ•ˆç‡æ›´é«˜ã€‚

**æ€§èƒ½å¯¹æ¯”**
```
æ“ä½œç±»å‹    å•æ¡å¤„ç†è€—æ—¶    æ‰¹é‡å¤„ç†è€—æ—¶    æ•ˆç‡æå‡
æ’å…¥1000æ¡    5000ms         200ms         25å€
æ›´æ–°1000æ¡    4500ms         180ms         25å€  
åˆ é™¤1000æ¡    3000ms         100ms         30å€
```

### 5.2 æ‰¹é‡æ’å…¥ä¼˜åŒ–


**âŒ æ•ˆç‡ä½çš„åšæ³•**
```java
// é€æ¡æ’å…¥ - å¾ˆæ…¢ï¼
public void addUsers(List<User> users) {
    String sql = "INSERT INTO user (name, age) VALUES (?, ?)";
    
    for (User user : users) {
        try (PreparedStatement ps = connection.prepareStatement(sql)) {
            ps.setString(1, user.getName());
            ps.setInt(2, user.getAge());
            ps.executeUpdate(); // æ¯æ¬¡éƒ½è¦å’Œæ•°æ®åº“é€šä¿¡
        }
    }
    // 1000æ¡æ•°æ® = 1000æ¬¡ç½‘ç»œé€šä¿¡
}
```

**âœ… é«˜æ•ˆçš„æ‰¹é‡å¤„ç†**
```java
public class BatchDao {
    // æ–¹æ³•1ï¼šä½¿ç”¨batchæ‰¹å¤„ç†
    public void addUsersBatch(List<User> users) {
        String sql = "INSERT INTO user (name, age) VALUES (?, ?)";
        
        try (PreparedStatement ps = connection.prepareStatement(sql)) {
            for (User user : users) {
                ps.setString(1, user.getName());
                ps.setInt(2, user.getAge());
                ps.addBatch(); // åŠ å…¥æ‰¹å¤„ç†é˜Ÿåˆ—
                
                // æ¯1000æ¡æäº¤ä¸€æ¬¡ï¼Œé¿å…å†…å­˜æº¢å‡º
                if (users.indexOf(user) % 1000 == 0) {
                    ps.executeBatch();
                    ps.clearBatch();
                }
            }
            
            // å¤„ç†å‰©ä½™æ•°æ®
            ps.executeBatch();
        }
    }
    
    // æ–¹æ³•2ï¼šä½¿ç”¨VALUESè¯­å¥æ‰¹é‡æ’å…¥
    public void addUsersValues(List<User> users) {
        if (users.isEmpty()) return;
        
        StringBuilder sql = new StringBuilder("INSERT INTO user (name, age) VALUES ");
        for (int i = 0; i < users.size(); i++) {
            sql.append("(?, ?)");
            if (i < users.size() - 1) {
                sql.append(", ");
            }
        }
        
        try (PreparedStatement ps = connection.prepareStatement(sql.toString())) {
            int paramIndex = 1;
            for (User user : users) {
                ps.setString(paramIndex++, user.getName());
                ps.setInt(paramIndex++, user.getAge());
            }
            ps.executeUpdate();
        }
    }
}
```

### 5.3 æ‰¹é‡æ“ä½œæœ€ä½³å®è·µ


**ğŸ“Š æ‰¹é‡å¤§å°é€‰æ‹©**
```java
public class BatchConfig {
    // ä¸åŒæ“ä½œçš„æœ€ä½³æ‰¹é‡å¤§å°
    public static final int INSERT_BATCH_SIZE = 1000;  // æ’å…¥æ“ä½œ
    public static final int UPDATE_BATCH_SIZE = 500;   // æ›´æ–°æ“ä½œ  
    public static final int DELETE_BATCH_SIZE = 200;   // åˆ é™¤æ“ä½œ
    
    // æ ¹æ®æ•°æ®å¤§å°åŠ¨æ€è°ƒæ•´
    public int getBatchSize(int totalSize) {
        if (totalSize < 100) {
            return totalSize; // å°é‡æ•°æ®ç›´æ¥å¤„ç†
        } else if (totalSize < 10000) {
            return 500;       // ä¸­ç­‰æ•°æ®é‡
        } else {
            return 1000;      // å¤§æ•°æ®é‡
        }
    }
}
```

---

## 6. ğŸ’¾ ç¼“å­˜ç­–ç•¥åº”ç”¨


### 6.1 ä»€ä¹ˆæ˜¯ç¼“å­˜


**ç¼“å­˜**å°±åƒæ˜¯**"ä¹¦æ¡Œä¸Šçš„å¸¸ç”¨ç‰©å“"**ã€‚ç»å¸¸ç”¨çš„ä¸œè¥¿æ”¾åœ¨ä¼¸æ‰‹å°±èƒ½æ‹¿åˆ°çš„åœ°æ–¹ï¼Œä¸ç”¨æ¯æ¬¡éƒ½å»æŸœå­é‡Œæ‰¾ã€‚

**ğŸ” ç¼“å­˜å·¥ä½œåŸç†**
```
æ•°æ®è·å–æµç¨‹ï¼š

ç”¨æˆ·è¯·æ±‚æ•°æ®
     â†“
æ£€æŸ¥ç¼“å­˜ä¸­æ˜¯å¦å­˜åœ¨
     â†“              â†“
  å­˜åœ¨(å‘½ä¸­)       ä¸å­˜åœ¨(æœªå‘½ä¸­)
     â†“              â†“
  ç›´æ¥è¿”å›        æŸ¥è¯¢æ•°æ®åº“
   (å¾ˆå¿«)           â†“
                å­˜å…¥ç¼“å­˜
                   â†“
                 è¿”å›æ•°æ®
```

### 6.2 DAOå±‚ç¼“å­˜å®ç°


**ç®€å•å†…å­˜ç¼“å­˜**
```java
public class CachedUserDao {
    // ä½¿ç”¨Mapä½œä¸ºç®€å•ç¼“å­˜
    private final Map<Integer, User> userCache = new ConcurrentHashMap<>();
    private final Map<Integer, Long> cacheTime = new ConcurrentHashMap<>();
    private final long CACHE_EXPIRE_TIME = 5 * 60 * 1000; // 5åˆ†é’Ÿè¿‡æœŸ
    
    public User findUserById(int id) {
        // 1. æ£€æŸ¥ç¼“å­˜
        User cachedUser = getUserFromCache(id);
        if (cachedUser != null) {
            return cachedUser; // ç¼“å­˜å‘½ä¸­ï¼Œç›´æ¥è¿”å›
        }
        
        // 2. ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“
        User user = findUserFromDatabase(id);
        if (user != null) {
            // 3. å°†ç»“æœå­˜å…¥ç¼“å­˜
            putUserToCache(id, user);
        }
        
        return user;
    }
    
    private User getUserFromCache(int id) {
        Long time = cacheTime.get(id);
        if (time != null && System.currentTimeMillis() - time < CACHE_EXPIRE_TIME) {
            return userCache.get(id);
        } else {
            // ç¼“å­˜å·²è¿‡æœŸï¼Œæ¸…ç†
            userCache.remove(id);
            cacheTime.remove(id);
            return null;
        }
    }
    
    private void putUserToCache(int id, User user) {
        userCache.put(id, user);
        cacheTime.put(id, System.currentTimeMillis());
    }
}
```

### 6.3 ç¼“å­˜ç­–ç•¥é€‰æ‹©


**ğŸ¯ ä¸åŒåœºæ™¯çš„ç¼“å­˜ç­–ç•¥**

| æ•°æ®ç‰¹ç‚¹ | ç¼“å­˜ç­–ç•¥ | é€‚ç”¨åœºæ™¯ |
|---------|---------|----------|
| **è¯»å¤šå†™å°‘** | `é•¿æ—¶é—´ç¼“å­˜` | å•†å“ä¿¡æ¯ã€é…ç½®æ•°æ® |
| **è¯»å†™é¢‘ç¹** | `çŸ­æ—¶é—´ç¼“å­˜` | ç”¨æˆ·ä¿¡æ¯ã€è®¢å•çŠ¶æ€ |
| **å®æ—¶æ€§é«˜** | `ä¸ä½¿ç”¨ç¼“å­˜` | åº“å­˜æ•°é‡ã€è´¦æˆ·ä½™é¢ |
| **è®¡ç®—å¤æ‚** | `æ°¸ä¹…ç¼“å­˜+æ‰‹åŠ¨æ›´æ–°` | ç»Ÿè®¡æŠ¥è¡¨ã€æ’è¡Œæ¦œ |

**âš ï¸ ç¼“å­˜ä½¿ç”¨æ³¨æ„äº‹é¡¹**
```java
public class CacheManager {
    // ç¼“å­˜æ›´æ–°ç­–ç•¥
    public void updateUser(User user) {
        // 1. å…ˆæ›´æ–°æ•°æ®åº“
        updateUserInDatabase(user);
        
        // 2. æ›´æ–°ç¼“å­˜ï¼ˆæˆ–æ¸…é™¤ç¼“å­˜ï¼‰
        // ç­–ç•¥Aï¼šæ›´æ–°ç¼“å­˜
        userCache.put(user.getId(), user);
        
        // ç­–ç•¥Bï¼šæ¸…é™¤ç¼“å­˜ï¼ˆä¸‹æ¬¡æŸ¥è¯¢æ—¶é‡æ–°åŠ è½½ï¼‰
        // userCache.remove(user.getId());
    }
    
    // é˜²æ­¢ç¼“å­˜é›ªå´©
    private Object getCachedDataSafely(String key) {
        Object data = cache.get(key);
        if (data == null) {
            // ä½¿ç”¨åˆ†å¸ƒå¼é”é˜²æ­¢åŒæ—¶æŸ¥è¯¢æ•°æ®åº“
            synchronized(key.intern()) {
                data = cache.get(key); // åŒé‡æ£€æŸ¥
                if (data == null) {
                    data = loadFromDatabase(key);
                    cache.put(key, data);
                }
            }
        }
        return data;
    }
}
```

---

## 7. âš¡ æ€§èƒ½è°ƒä¼˜å®è·µ


### 7.1 SQLæŸ¥è¯¢ä¼˜åŒ–


**ğŸ” æ…¢æŸ¥è¯¢è¯†åˆ«**
```java
public class PerformanceMonitor {
    private static final long SLOW_QUERY_THRESHOLD = 1000; // 1ç§’
    
    public <T> T executeWithMonitoring(String sql, Supplier<T> queryExecutor) {
        long startTime = System.currentTimeMillis();
        
        try {
            T result = queryExecutor.get();
            
            long executionTime = System.currentTimeMillis() - startTime;
            if (executionTime > SLOW_QUERY_THRESHOLD) {
                // è®°å½•æ…¢æŸ¥è¯¢
                logSlowQuery(sql, executionTime);
            }
            
            return result;
        } catch (Exception e) {
            logQueryError(sql, e);
            throw e;
        }
    }
    
    private void logSlowQuery(String sql, long time) {
        System.out.println("âš ï¸ æ…¢æŸ¥è¯¢è­¦å‘Š:");
        System.out.println("SQL: " + sql);
        System.out.println("è€—æ—¶: " + time + "ms");
    }
}
```

### 7.2 ç´¢å¼•ä¼˜åŒ–å»ºè®®


**ğŸ”‘ ç´¢å¼•è®¾è®¡åŸåˆ™**
```sql
-- ç¤ºä¾‹è¡¨ç»“æ„
CREATE TABLE user (
    id INT PRIMARY KEY,           -- ä¸»é”®è‡ªåŠ¨æœ‰ç´¢å¼•
    username VARCHAR(50),         -- éœ€è¦å•ç‹¬ç´¢å¼•
    email VARCHAR(100),          -- éœ€è¦å”¯ä¸€ç´¢å¼•  
    age INT,                     -- æ ¹æ®æŸ¥è¯¢éœ€æ±‚å†³å®š
    create_time TIMESTAMP,       -- å¯èƒ½éœ€è¦ç´¢å¼•
    status TINYINT              -- ç¦»æ•£åº¦ä½ï¼Œä¸å»ºè®®ç´¢å¼•
);

-- å¸¸ç”¨ç´¢å¼•åˆ›å»º
CREATE INDEX idx_username ON user(username);      -- å•åˆ—ç´¢å¼•
CREATE UNIQUE INDEX idx_email ON user(email);     -- å”¯ä¸€ç´¢å¼•
CREATE INDEX idx_age_status ON user(age, status); -- å¤åˆç´¢å¼•
CREATE INDEX idx_create_time ON user(create_time); -- æ—¶é—´ç´¢å¼•
```

**ğŸ“Š ç´¢å¼•æ•ˆæœå¯¹æ¯”**
```
æŸ¥è¯¢ç±»å‹              æ— ç´¢å¼•è€—æ—¶    æœ‰ç´¢å¼•è€—æ—¶    æ€§èƒ½æå‡
æŒ‰IDæŸ¥è¯¢(ä¸»é”®)         1ms          0.1ms        10å€
æŒ‰ç”¨æˆ·åæŸ¥è¯¢           500ms        2ms          250å€
æŒ‰é‚®ç®±æŸ¥è¯¢(å”¯ä¸€)       300ms        1ms          300å€
èŒƒå›´æŸ¥è¯¢(å¹´é¾„)         800ms        50ms         16å€
```

### 7.3 è¿æ¥æ± è°ƒä¼˜


**ğŸŠâ€â™‚ï¸ è¿æ¥æ± å‚æ•°è°ƒä¼˜**
```java
public class DataSourceConfig {
    public DataSource optimizedDataSource() {
        HikariConfig config = new HikariConfig();
        
        // æ ¸å¿ƒå‚æ•°è°ƒä¼˜
        config.setMaximumPoolSize(20);        // æœ€å¤§è¿æ¥æ•°
        config.setMinimumIdle(5);             // æœ€å°ç©ºé—²è¿æ¥
        config.setConnectionTimeout(30000);   // è·å–è¿æ¥è¶…æ—¶æ—¶é—´
        config.setIdleTimeout(300000);        // ç©ºé—²è¿æ¥å­˜æ´»æ—¶é—´
        config.setMaxLifetime(1800000);       // è¿æ¥æœ€å¤§å­˜æ´»æ—¶é—´
        config.setValidationTimeout(5000);    // è¿æ¥éªŒè¯è¶…æ—¶æ—¶é—´
        
        // æ€§èƒ½ä¼˜åŒ–å‚æ•°
        config.setLeakDetectionThreshold(60000); // è¿æ¥æ³„æ¼æ£€æµ‹é˜ˆå€¼
        config.addDataSourceProperty("cachePrepStmts", "true");
        config.addDataSourceProperty("prepStmtCacheSize", "250");
        config.addDataSourceProperty("prepStmtCacheSqlLimit", "2048");
        
        return new HikariDataSource(config);
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„å…³é”®æ¦‚å¿µ


```
ğŸ”¸ SQLæ³¨å…¥é˜²æŠ¤ï¼šä½¿ç”¨PreparedStatementï¼Œæ°¸è¿œä¸è¦ç›´æ¥æ‹¼æ¥SQL
ğŸ”¸ N+1æŸ¥è¯¢é—®é¢˜ï¼šç”¨JOINæˆ–æ‰¹é‡æŸ¥è¯¢ä»£æ›¿å¾ªç¯æŸ¥è¯¢
ğŸ”¸ èµ„æºæ³„æ¼é˜²æ­¢ï¼šä½¿ç”¨try-with-resourcesè‡ªåŠ¨ç®¡ç†èµ„æº
ğŸ”¸ æ‰¹é‡æ“ä½œä¼˜åŒ–ï¼šå¤§é‡æ•°æ®æ“ä½œæ—¶ä½¿ç”¨æ‰¹å¤„ç†æé«˜æ•ˆç‡
ğŸ”¸ ç¼“å­˜ç­–ç•¥ï¼šåˆç†ä½¿ç”¨ç¼“å­˜å‡å°‘æ•°æ®åº“å‹åŠ›
ğŸ”¸ æ€§èƒ½ç›‘æ§ï¼šè¯†åˆ«å¹¶ä¼˜åŒ–æ…¢æŸ¥è¯¢å’Œèµ„æºç“¶é¢ˆ
```

### 8.2 å®é™…å¼€å‘æŒ‡å¯¼åŸåˆ™


**ğŸ›¡ï¸ å®‰å…¨ç¬¬ä¸€**
```
å®‰å…¨æ£€æŸ¥æ¸…å•ï¼š
âœ… æ‰€æœ‰ç”¨æˆ·è¾“å…¥éƒ½ä½¿ç”¨PreparedStatement
âœ… æ•æ„Ÿæ“ä½œæ·»åŠ æƒé™æ ¡éªŒ
âœ… æ•°æ®åº“è¿æ¥ä¿¡æ¯ä¸è¦ç¡¬ç¼–ç 
âœ… å®šæœŸæ›´æ–°æ•°æ®åº“é©±åŠ¨ç‰ˆæœ¬
```

**âš¡ æ€§èƒ½ä¼˜åŒ–**
```
æ€§èƒ½ä¼˜åŒ–æ¸…å•ï¼š
âœ… ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µæ·»åŠ ç´¢å¼•
âœ… é¿å…N+1æŸ¥è¯¢é—®é¢˜
âœ… å¤§é‡æ•°æ®æ“ä½œä½¿ç”¨æ‰¹å¤„ç†
âœ… åˆç†ä½¿ç”¨ç¼“å­˜ç­–ç•¥
âœ… ç›‘æ§å¹¶ä¼˜åŒ–æ…¢æŸ¥è¯¢
```

**ğŸ”§ èµ„æºç®¡ç†**
```
èµ„æºç®¡ç†æ¸…å•ï¼š
âœ… ä½¿ç”¨try-with-resourcesç®¡ç†è¿æ¥
âœ… åˆç†é…ç½®è¿æ¥æ± å‚æ•°
âœ… ç›‘æ§è¿æ¥æ± ä½¿ç”¨çŠ¶å†µ
âœ… åŠæ—¶é‡Šæ”¾ä¸ç”¨çš„èµ„æº
```

### 8.3 é—®é¢˜æ’æŸ¥æ€è·¯


**ğŸ” æ€§èƒ½é—®é¢˜æ’æŸ¥æµç¨‹**
```
å‘ç°é—®é¢˜
    â†“
æ£€æŸ¥SQLæ‰§è¡Œæ—¶é—´
    â†“
åˆ†ææ˜¯å¦æœ‰æ…¢æŸ¥è¯¢
    â†“              â†“
æœ‰æ…¢æŸ¥è¯¢        æ— æ…¢æŸ¥è¯¢
    â†“              â†“
ä¼˜åŒ–SQL/ç´¢å¼•    æ£€æŸ¥è¿æ¥æ± é…ç½®
    â†“              â†“
æµ‹è¯•éªŒè¯        è°ƒæ•´å‚æ•°
    â†“              â†“
é—®é¢˜è§£å†³ â†â”€â”€â”€â”€â”€â”€â”€â”€ é‡æ–°æµ‹è¯•
```

**ğŸ’¡ è®°å¿†å£è¯€**
- **å®‰å…¨é˜²æŠ¤é é¢„ç¼–è¯‘ï¼ŒSQLæ³¨å…¥æ— å¤„è—**
- **æ‰¹é‡æ“ä½œæ•ˆç‡é«˜ï¼Œå¾ªç¯æŸ¥è¯¢è¦é¿å…**  
- **èµ„æºä½¿ç”¨å®Œå°±å…³ï¼Œè¿æ¥æ³„æ¼æ˜¯å¤§æ‚£**
- **ç¼“å­˜ç­–ç•¥è¦åˆç†ï¼Œæ€§èƒ½ç›‘æ§ä¸èƒ½å°‘**

### 8.4 è¿›é˜¶å­¦ä¹ å»ºè®®


**ğŸ¯ ä¸‹ä¸€æ­¥å­¦ä¹ æ–¹å‘**
- å­¦ä¹ MyBatisç­‰ORMæ¡†æ¶çš„é«˜çº§ç‰¹æ€§
- æŒæ¡åˆ†å¸ƒå¼æ•°æ®åº“çš„è®¾è®¡æ¨¡å¼
- äº†è§£è¯»å†™åˆ†ç¦»å’Œåˆ†åº“åˆ†è¡¨æŠ€æœ¯
- æ·±å…¥å­¦ä¹ æ•°æ®åº“æ€§èƒ½è°ƒä¼˜æŠ€æœ¯

é€šè¿‡æŒæ¡è¿™äº›DAOå±‚çš„å¸¸è§é—®é¢˜å’Œä¼˜åŒ–æŠ€å·§ï¼Œä½ å°±èƒ½å†™å‡º**å®‰å…¨ã€é«˜æ•ˆã€ç¨³å®š**çš„æ•°æ®è®¿é—®ä»£ç ï¼Œä¸ºæ•´ä¸ªJavaWebåº”ç”¨æ‰“ä¸‹åšå®çš„åŸºç¡€ï¼