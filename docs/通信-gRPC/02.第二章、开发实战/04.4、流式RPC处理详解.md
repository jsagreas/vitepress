---
title: 4ã€æµå¼RPCå¤„ç†è¯¦è§£
---
## ğŸ“š ç›®å½•

1. [æµå¼RPCæ¦‚å¿µç†è§£](#1-æµå¼RPCæ¦‚å¿µç†è§£)
2. [Server StreamingæœåŠ¡ç«¯æµ](#2-Server-StreamingæœåŠ¡ç«¯æµ)
3. [Client Streamingå®¢æˆ·ç«¯æµ](#3-Client-Streamingå®¢æˆ·ç«¯æµ)  
4. [Bidirectional StreamingåŒå‘æµ](#4-Bidirectional-StreamingåŒå‘æµ)
5. [EOFåˆ¤æ–­ä¸æµç»“æŸ](#5-EOFåˆ¤æ–­ä¸æµç»“æŸ)
6. [æµå¼åœºæ™¯åº”ç”¨å®æˆ˜](#6-æµå¼åœºæ™¯åº”ç”¨å®æˆ˜)
7. [å¼‚æ­¥æµå¤„ç†é™·é˜±](#7-å¼‚æ­¥æµå¤„ç†é™·é˜±)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒŠ æµå¼RPCæ¦‚å¿µç†è§£


### 1.1 ä»€ä¹ˆæ˜¯æµå¼RPC


**ğŸ”¸ ä¼ ç»ŸRPC vs æµå¼RPC**
```
ä¼ ç»ŸRPCï¼ˆä¸€å…ƒRPCï¼‰ï¼š
å®¢æˆ·ç«¯ ----[è¯·æ±‚]----> æœåŠ¡ç«¯
å®¢æˆ·ç«¯ <---[å“åº”]---- æœåŠ¡ç«¯
ç‰¹ç‚¹ï¼šä¸€é—®ä¸€ç­”ï¼Œè¯·æ±‚å®Œç«‹å³ç­‰å¾…å“åº”

æµå¼RPCï¼š
å®¢æˆ·ç«¯ =====[æ•°æ®æµ]====> æœåŠ¡ç«¯
å®¢æˆ·ç«¯ <====[æ•°æ®æµ]==== æœåŠ¡ç«¯  
ç‰¹ç‚¹ï¼šæŒç»­ä¼ è¾“ï¼Œå¯ä»¥æºæºä¸æ–­æ”¶å‘æ•°æ®
```

> ğŸ’¡ **é€šä¿—ç†è§£**ï¼šä¼ ç»ŸRPCåƒæ‰“ç”µè¯é—®ä¸€ä¸ªé—®é¢˜ï¼Œæµå¼RPCåƒå¼€è§†é¢‘é€šè¯ï¼Œå¯ä»¥æŒç»­äº¤æµ

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦æµå¼RPC


**ğŸ¯ è§£å†³çš„é—®é¢˜**
- **å¤§æ•°æ®ä¼ è¾“**ï¼šä¸€æ¬¡ä¼ è¾“å‡ GBçš„æ–‡ä»¶ï¼Œåˆ†å—æµå¼ä¼ è¾“æ›´é«˜æ•ˆ
- **å®æ—¶æ€§è¦æ±‚**ï¼šè‚¡ç¥¨ä»·æ ¼ã€èŠå¤©æ¶ˆæ¯éœ€è¦å®æ—¶æ¨é€  
- **é•¿æ—¶é—´å¤„ç†**ï¼šæ•°æ®åˆ†æä»»åŠ¡éœ€è¦è¾¹å¤„ç†è¾¹è¿”å›è¿›åº¦
- **å†…å­˜é™åˆ¶**ï¼šé¿å…ä¸€æ¬¡æ€§åŠ è½½å¤§é‡æ•°æ®åˆ°å†…å­˜

**ğŸ“Š æ€§èƒ½å¯¹æ¯”**
```
åœºæ™¯ï¼šä¼ è¾“10ä¸‡æ¡æ•°æ®è®°å½•

ä¸€å…ƒRPCæ–¹å¼ï¼š
- å®¢æˆ·ç«¯ç­‰å¾…æ—¶é—´ï¼š30ç§’ï¼ˆå…¨éƒ¨å¤„ç†å®Œæ‰è¿”å›ï¼‰
- å†…å­˜å ç”¨ï¼šä¸€æ¬¡æ€§åŠ è½½å…¨éƒ¨æ•°æ®
- ç”¨æˆ·ä½“éªŒï¼šé•¿æ—¶é—´ç­‰å¾…ï¼Œæ— è¿›åº¦åé¦ˆ

æµå¼RPCæ–¹å¼ï¼š  
- å®¢æˆ·ç«¯æ¥æ”¶æ—¶é—´ï¼šè¾¹å¤„ç†è¾¹æ¥æ”¶ï¼Œ1ç§’å¼€å§‹æ”¶åˆ°æ•°æ®
- å†…å­˜å ç”¨ï¼šåˆ†æ‰¹å¤„ç†ï¼Œå†…å­˜å ç”¨å¹³ç¨³
- ç”¨æˆ·ä½“éªŒï¼šå®æ—¶åé¦ˆï¼Œå¯æ˜¾ç¤ºè¿›åº¦
```

### 1.3 ä¸‰ç§æµå¼ç±»å‹


```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   gRPCæµå¼ç±»å‹                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  1. Server Streaming (æœåŠ¡ç«¯æµ)                        â”‚
â”‚     å®¢æˆ·ç«¯ ----[è¯·æ±‚]----> æœåŠ¡ç«¯                        â”‚
â”‚     å®¢æˆ·ç«¯ <--[æ•°æ®1]---- æœåŠ¡ç«¯                        â”‚
â”‚     å®¢æˆ·ç«¯ <--[æ•°æ®2]---- æœåŠ¡ç«¯                        â”‚
â”‚     å®¢æˆ·ç«¯ <--[æ•°æ®N]---- æœåŠ¡ç«¯                        â”‚
â”‚                                                         â”‚
â”‚  2. Client Streaming (å®¢æˆ·ç«¯æµ)                        â”‚
â”‚     å®¢æˆ·ç«¯ ----[æ•°æ®1]----> æœåŠ¡ç«¯                      â”‚
â”‚     å®¢æˆ·ç«¯ ----[æ•°æ®2]----> æœåŠ¡ç«¯                      â”‚
â”‚     å®¢æˆ·ç«¯ ----[æ•°æ®N]----> æœåŠ¡ç«¯                      â”‚
â”‚     å®¢æˆ·ç«¯ <---[å“åº”]---- æœåŠ¡ç«¯                        â”‚
â”‚                                                         â”‚
â”‚  3. Bidirectional Streaming (åŒå‘æµ)                   â”‚
â”‚     å®¢æˆ·ç«¯ =====[æ•°æ®æµ]====> æœåŠ¡ç«¯                    â”‚
â”‚     å®¢æˆ·ç«¯ <====[æ•°æ®æµ]==== æœåŠ¡ç«¯                     â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸ“¤ Server StreamingæœåŠ¡ç«¯æµ


### 2.1 æ¦‚å¿µç†è§£


**Server Streaming**ï¼šå®¢æˆ·ç«¯å‘é€ä¸€ä¸ªè¯·æ±‚ï¼ŒæœåŠ¡ç«¯è¿”å›ä¸€ä¸ªæ•°æ®æµ

> ğŸ’¡ **ç”Ÿæ´»æ¯”å–»**ï¼šä½ å»é¤å…ç‚¹äº†ä¸€æ¡Œèœï¼ŒæœåŠ¡å‘˜ä¼šä¸€é“ä¸€é“ä¸Šèœï¼Œè€Œä¸æ˜¯ç­‰å…¨éƒ¨åšå¥½å†ä¸€èµ·ç«¯ä¸Šæ¥

**é€‚ç”¨åœºæ™¯**ï¼š
- **æ•°æ®æŸ¥è¯¢**ï¼šæŸ¥è¯¢å¤§é‡è®°å½•ï¼Œåˆ†æ‰¹è¿”å›  
- **å®æ—¶æ¨é€**ï¼šè‚¡ç¥¨ä»·æ ¼ã€æ–°é—»æ¨é€
- **æ–‡ä»¶ä¸‹è½½**ï¼šå¤§æ–‡ä»¶åˆ†å—ä¸‹è½½
- **è¿›åº¦åé¦ˆ**ï¼šé•¿ä»»åŠ¡æ‰§è¡Œè¿›åº¦å®æ—¶æ›´æ–°

### 2.2 Protoå®šä¹‰


```protobuf
service StreamService {
    // æœåŠ¡ç«¯æµï¼šè·å–ç”¨æˆ·åˆ—è¡¨
    rpc GetUserList(GetUserListRequest) returns (stream User);
    
    // æœåŠ¡ç«¯æµï¼šå®æ—¶è‚¡ä»·æ¨é€  
    rpc GetStockPrices(StockRequest) returns (stream StockPrice);
}

message GetUserListRequest {
    int32 page_size = 1;
}

message User {
    int32 id = 1;
    string name = 2;
    string email = 3;
}

message StockPrice {
    string symbol = 1;
    double price = 2;
    int64 timestamp = 3;
}
```

### 2.3 æœåŠ¡ç«¯å®ç°ï¼šSend()å¾ªç¯å‘é€


```go
// æœåŠ¡ç«¯æµå®ç°
func (s *StreamServiceServer) GetUserList(req *pb.GetUserListRequest, 
    stream pb.StreamService_GetUserListServer) error {
    
    // æ¨¡æ‹Ÿä»æ•°æ®åº“åˆ†æ‰¹æŸ¥è¯¢ç”¨æˆ·
    pageSize := req.PageSize
    if pageSize <= 0 {
        pageSize = 10
    }
    
    // ğŸ”¸ æ ¸å¿ƒï¼šä½¿ç”¨Send()å¾ªç¯å‘é€æ•°æ®
    for page := 0; page < 5; page++ { // å‡è®¾æ€»å…±5é¡µæ•°æ®
        // æ¨¡æ‹ŸæŸ¥è¯¢è¿™ä¸€é¡µçš„ç”¨æˆ·
        users := getUsersFromDB(page, pageSize)
        
        // é€ä¸ªå‘é€ç”¨æˆ·ä¿¡æ¯
        for _, user := range users {
            if err := stream.Send(&pb.User{
                Id:    user.ID,
                Name:  user.Name,
                Email: user.Email,
            }); err != nil {
                return err
            }
        }
        
        // æ¨¡æ‹Ÿå¤„ç†å»¶è¿Ÿ
        time.Sleep(500 * time.Millisecond)
    }
    
    return nil // ğŸ”¸ è¿”å›nilè¡¨ç¤ºæµç»“æŸ
}
```

> âš ï¸ **é‡è¦**ï¼š`stream.Send()`ç”¨äºå‘é€æ¯ä¸€æ¡æ•°æ®ï¼Œ`return nil`è¡¨ç¤ºæµç»“æŸ

### 2.4 å®¢æˆ·ç«¯æ¥æ”¶ï¼šRecv()å¾ªç¯æ¥æ”¶


```go
// å®¢æˆ·ç«¯æ¥æ”¶æœåŠ¡ç«¯æµ
func callServerStream() {
    client := pb.NewStreamServiceClient(conn)
    
    // å‘èµ·æœåŠ¡ç«¯æµè°ƒç”¨
    stream, err := client.GetUserList(context.Background(), 
        &pb.GetUserListRequest{PageSize: 10})
    if err != nil {
        log.Fatal(err)
    }
    
    // ğŸ”¸ æ ¸å¿ƒï¼šä½¿ç”¨Recv()å¾ªç¯æ¥æ”¶æ•°æ®
    for {
        user, err := stream.Recv()
        if err == io.EOF {
            // ğŸ”¸ æ”¶åˆ°EOFè¡¨ç¤ºæµç»“æŸ
            break
        }
        if err != nil {
            log.Fatal(err)
        }
        
        // å¤„ç†æ¥æ”¶åˆ°çš„ç”¨æˆ·æ•°æ®
        fmt.Printf("æ”¶åˆ°ç”¨æˆ·: ID=%d, Name=%s\n", user.Id, user.Name)
    }
    
    fmt.Println("ç”¨æˆ·åˆ—è¡¨æ¥æ”¶å®Œæˆ")
}
```

> ğŸ’¡ **å…³é”®ç†è§£**ï¼šå®¢æˆ·ç«¯ç”¨`Recv()`ä¸æ–­æ¥æ”¶ï¼Œç›´åˆ°æ”¶åˆ°`io.EOF`è¡¨ç¤ºæµç»“æŸ

---

## 3. ğŸ“¥ Client Streamingå®¢æˆ·ç«¯æµ


### 3.1 æ¦‚å¿µç†è§£


**Client Streaming**ï¼šå®¢æˆ·ç«¯å‘é€ä¸€ä¸ªæ•°æ®æµï¼ŒæœåŠ¡ç«¯è¿”å›ä¸€ä¸ªå“åº”

> ğŸ’¡ **ç”Ÿæ´»æ¯”å–»**ï¼šä½ åœ¨è¶…å¸‚è´­ç‰©ï¼ŒæŠŠå•†å“ä¸€ä¸ªä¸ªæ”¾è¿›è´­ç‰©è½¦ï¼Œæœ€åç»“è´¦æ—¶æ”¶é“¶å‘˜ç»™ä½ ä¸€ä¸ªæ€»è´¦å•

**é€‚ç”¨åœºæ™¯**ï¼š
- **æ–‡ä»¶ä¸Šä¼ **ï¼šå¤§æ–‡ä»¶åˆ†å—ä¸Šä¼ 
- **æ•°æ®æ±‡æ€»**ï¼šå¤šæ¡æ•°æ®å‘é€ï¼ŒæœåŠ¡ç«¯ç»Ÿè®¡æ±‡æ€»  
- **æ‰¹é‡æ“ä½œ**ï¼šæ‰¹é‡æ’å…¥æ•°æ®åº“
- **æ—¥å¿—æ”¶é›†**ï¼šå®¢æˆ·ç«¯æŒç»­å‘é€æ—¥å¿—ï¼ŒæœåŠ¡ç«¯æ‰¹é‡å¤„ç†

### 3.2 Protoå®šä¹‰


```protobuf
service StreamService {
    // å®¢æˆ·ç«¯æµï¼šä¸Šä¼ æ–‡ä»¶
    rpc UploadFile(stream FileChunk) returns (UploadResponse);
    
    // å®¢æˆ·ç«¯æµï¼šæ‰¹é‡åˆ›å»ºç”¨æˆ·
    rpc CreateUsers(stream User) returns (CreateUsersResponse);
}

message FileChunk {
    string file_name = 1;
    bytes data = 2;
    int32 chunk_number = 3;
}

message UploadResponse {
    string file_id = 1;
    int64 total_size = 2;
    string message = 3;
}
```

### 3.3 æœåŠ¡ç«¯å®ç°ï¼šRecv()æ¥æ”¶ï¼ŒSendAndClose()ç»“æŸ


```go
// å®¢æˆ·ç«¯æµå®ç°ï¼šæ–‡ä»¶ä¸Šä¼ 
func (s *StreamServiceServer) UploadFile(
    stream pb.StreamService_UploadFileServer) error {
    
    var fileName string
    var totalSize int64
    var fileData []byte
    
    // ğŸ”¸ æ ¸å¿ƒï¼šä½¿ç”¨Recv()å¾ªç¯æ¥æ”¶å®¢æˆ·ç«¯æ•°æ®
    for {
        chunk, err := stream.Recv()
        if err == io.EOF {
            // ğŸ”¸ å®¢æˆ·ç«¯å‘é€å®Œæ¯•ï¼Œå¤„ç†å¹¶å“åº”
            break
        }
        if err != nil {
            return err
        }
        
        // å¤„ç†æ¥æ”¶åˆ°çš„æ–‡ä»¶å—
        if fileName == "" {
            fileName = chunk.FileName
        }
        
        fileData = append(fileData, chunk.Data...)
        totalSize += int64(len(chunk.Data))
        
        fmt.Printf("æ¥æ”¶æ–‡ä»¶å— %d, å¤§å°: %d å­—èŠ‚\n", 
            chunk.ChunkNumber, len(chunk.Data))
    }
    
    // ä¿å­˜æ–‡ä»¶åˆ°ç£ç›˜
    fileID := saveFileToStorage(fileName, fileData)
    
    // ğŸ”¸ æ ¸å¿ƒï¼šä½¿ç”¨SendAndClose()å‘é€å“åº”å¹¶ç»“æŸæµ
    return stream.SendAndClose(&pb.UploadResponse{
        FileId:    fileID,
        TotalSize: totalSize,
        Message:   fmt.Sprintf("æ–‡ä»¶ %s ä¸Šä¼ æˆåŠŸ", fileName),
    })
}
```

> âš ï¸ **é‡è¦**ï¼š
> - `stream.Recv()`æ¥æ”¶å®¢æˆ·ç«¯æ•°æ®æµ
> - `stream.SendAndClose()`å‘é€æœ€ç»ˆå“åº”å¹¶å…³é—­æµ

### 3.4 å®¢æˆ·ç«¯å®ç°ï¼šSend()å‘é€æ•°æ®æµ


```go
// å®¢æˆ·ç«¯å‘é€æ•°æ®æµ
func callClientStream() {
    client := pb.NewStreamServiceClient(conn)
    
    // åˆ›å»ºå®¢æˆ·ç«¯æµ
    stream, err := client.UploadFile(context.Background())
    if err != nil {
        log.Fatal(err)
    }
    
    // æ¨¡æ‹Ÿæ–‡ä»¶æ•°æ®
    fileName := "test.txt"
    fileData := []byte("è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶çš„å†…å®¹...")
    chunkSize := 10 // æ¯å—10å­—èŠ‚
    
    // ğŸ”¸ æ ¸å¿ƒï¼šä½¿ç”¨Send()å¾ªç¯å‘é€æ•°æ®
    for i := 0; i < len(fileData); i += chunkSize {
        end := i + chunkSize
        if end > len(fileData) {
            end = len(fileData)
        }
        
        chunk := &pb.FileChunk{
            FileName:    fileName,
            Data:        fileData[i:end],
            ChunkNumber: int32(i / chunkSize),
        }
        
        if err := stream.Send(chunk); err != nil {
            log.Fatal(err)
        }
        
        fmt.Printf("å‘é€æ–‡ä»¶å— %d\n", chunk.ChunkNumber)
    }
    
    // ğŸ”¸ å…³é”®ï¼šå…³é—­å‘é€å¹¶æ¥æ”¶å“åº”
    response, err := stream.CloseAndRecv()
    if err != nil {
        log.Fatal(err)
    }
    
    fmt.Printf("ä¸Šä¼ å®Œæˆ: %s\n", response.Message)
}
```

> ğŸ’¡ **å…³é”®ç†è§£**ï¼šå®¢æˆ·ç«¯ç”¨`Send()`å‘é€æ•°æ®ï¼Œ`CloseAndRecv()`ç»“æŸå‘é€å¹¶æ¥æ”¶å“åº”

---

## 4. ğŸ”„ Bidirectional StreamingåŒå‘æµ


### 4.1 æ¦‚å¿µç†è§£


**Bidirectional Streaming**ï¼šå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å¯ä»¥åŒæ—¶å‘é€å’Œæ¥æ”¶æ•°æ®æµ

> ğŸ’¡ **ç”Ÿæ´»æ¯”å–»**ï¼šå°±åƒå¾®ä¿¡èŠå¤©ï¼Œä½ å’Œæœ‹å‹å¯ä»¥åŒæ—¶å‘æ¶ˆæ¯ï¼Œäº’ä¸å¹²æ‰°ï¼Œå®æ—¶äº¤æµ

**é€‚ç”¨åœºæ™¯**ï¼š
- **å®æ—¶èŠå¤©ç³»ç»Ÿ**ï¼šç”¨æˆ·ä¹‹é—´å®æ—¶æ”¶å‘æ¶ˆæ¯
- **å®æ—¶åä½œ**ï¼šå¤šäººååŒç¼–è¾‘æ–‡æ¡£
- **æ¸¸æˆé€šä¿¡**ï¼šå®æ—¶æ¸¸æˆçŠ¶æ€åŒæ­¥
- **å®æ—¶æ•°æ®åˆ†æ**ï¼šè¾¹æ¥æ”¶æ•°æ®è¾¹è¿”å›åˆ†æç»“æœ

### 4.2 Protoå®šä¹‰


```protobuf
service ChatService {
    // åŒå‘æµï¼šèŠå¤©å®¤
    rpc Chat(stream ChatMessage) returns (stream ChatMessage);
}

message ChatMessage {
    string user_id = 1;
    string content = 2;
    int64 timestamp = 3;
    string room_id = 4;
}
```

### 4.3 æœåŠ¡ç«¯å®ç°ï¼šå¹¶å‘Sendå’ŒRecv


```go
// åŒå‘æµå®ç°ï¼šèŠå¤©æœåŠ¡
func (s *ChatServiceServer) Chat(stream pb.ChatService_ChatServer) error {
    // ğŸ”¸ æ ¸å¿ƒï¼šä½¿ç”¨goroutineå®ç°å¹¶å‘å¤„ç†
    
    // ç”¨äºé€šçŸ¥goroutineç»“æŸ
    done := make(chan bool)
    
    // ğŸ”¸ goroutine 1: æ¥æ”¶å®¢æˆ·ç«¯æ¶ˆæ¯
    go func() {
        for {
            msg, err := stream.Recv()
            if err == io.EOF {
                done <- true
                return
            }
            if err != nil {
                done <- true
                return
            }
            
            // å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯
            fmt.Printf("æ”¶åˆ°æ¶ˆæ¯: ç”¨æˆ·%sè¯´: %s\n", msg.UserId, msg.Content)
            
            // å¹¿æ’­ç»™å…¶ä»–ç”¨æˆ·ï¼ˆç®€åŒ–å¤„ç†ï¼‰
            broadcastMessage(msg)
        }
    }()
    
    // ğŸ”¸ goroutine 2: å‘é€æ¶ˆæ¯ç»™å®¢æˆ·ç«¯
    go func() {
        // æ¨¡æ‹Ÿä»æ¶ˆæ¯é˜Ÿåˆ—è·å–è¦å‘é€çš„æ¶ˆæ¯
        for {
            select {
            case <-done:
                return
            default:
                // ä»æ¶ˆæ¯é˜Ÿåˆ—è·å–æ¶ˆæ¯
                if msg := getMessageFromQueue(); msg != nil {
                    if err := stream.Send(msg); err != nil {
                        done <- true
                        return
                    }
                }
                time.Sleep(100 * time.Millisecond)
            }
        }
    }()
    
    // ç­‰å¾…ä»»ä¸€goroutineç»“æŸ
    <-done
    return nil
}
```

> âš ï¸ **é‡è¦**ï¼šåŒå‘æµéœ€è¦ç”¨**goroutine**å®ç°å¹¶å‘ï¼Œä¸€ä¸ªè´Ÿè´£æ¥æ”¶ï¼Œä¸€ä¸ªè´Ÿè´£å‘é€

### 4.4 å®¢æˆ·ç«¯å®ç°ï¼šgoroutineé…åˆ


```go
// å®¢æˆ·ç«¯åŒå‘æµå¤„ç†
func callBidirectionalStream() {
    client := pb.NewChatServiceClient(conn)
    
    // åˆ›å»ºåŒå‘æµ
    stream, err := client.Chat(context.Background())
    if err != nil {
        log.Fatal(err)
    }
    
    done := make(chan bool)
    
    // ğŸ”¸ goroutine 1: æ¥æ”¶æœåŠ¡ç«¯æ¶ˆæ¯
    go func() {
        for {
            msg, err := stream.Recv()
            if err == io.EOF {
                done <- true
                return
            }
            if err != nil {
                done <- true
                return
            }
            
            fmt.Printf("æ”¶åˆ°æ¶ˆæ¯: %s\n", msg.Content)
        }
    }()
    
    // ğŸ”¸ goroutine 2: å‘é€æ¶ˆæ¯åˆ°æœåŠ¡ç«¯
    go func() {
        scanner := bufio.NewScanner(os.Stdin)
        for scanner.Scan() {
            text := scanner.Text()
            if text == "quit" {
                stream.CloseSend()
                done <- true
                return
            }
            
            msg := &pb.ChatMessage{
                UserId:    "user123",
                Content:   text,
                Timestamp: time.Now().Unix(),
                RoomId:    "room1",
            }
            
            if err := stream.Send(msg); err != nil {
                done <- true
                return
            }
        }
    }()
    
    // ç­‰å¾…ç»“æŸ
    <-done
}
```

> ğŸ’¡ **å…³é”®ç†è§£**ï¼šå®¢æˆ·ç«¯ä¹Ÿéœ€è¦ä¸¤ä¸ªgoroutineï¼Œä¸€ä¸ªæ”¶æ¶ˆæ¯ï¼Œä¸€ä¸ªå‘æ¶ˆæ¯ï¼Œå®ç°çœŸæ­£çš„åŒå‘é€šä¿¡

---

## 5. ğŸ”š EOFåˆ¤æ–­ä¸æµç»“æŸ


### 5.1 EOFçš„å«ä¹‰


**EOF (End Of File)**ï¼šåœ¨gRPCæµå¼é€šä¿¡ä¸­è¡¨ç¤ºæ•°æ®æµç»“æŸ

```
å‘é€ç«¯è¡Œä¸º                     æ¥æ”¶ç«¯æ”¶åˆ°
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Send(æ•°æ®1)         â”€â”€â†’       Recv() = æ•°æ®1
Send(æ•°æ®2)         â”€â”€â†’       Recv() = æ•°æ®2  
Send(æ•°æ®3)         â”€â”€â†’       Recv() = æ•°æ®3
return nil æˆ– CloseSend()  â”€â”€â†’  Recv() = io.EOF
```

> ğŸ’¡ **é€šä¿—ç†è§£**ï¼šEOFå°±åƒè¯´è¯ç»“æŸæ—¶çš„"å®Œæ¯•"ï¼Œå‘Šè¯‰å¯¹æ–¹æˆ‘è¯´å®Œäº†

### 5.2 ä¸åŒæµç±»å‹çš„EOFå¤„ç†


**ğŸ“Š EOFå¤„ç†å¯¹æ¯”è¡¨**

| æµç±»å‹ | å‘é€ç«¯ç»“æŸæ–¹å¼ | æ¥æ”¶ç«¯åˆ¤æ–­æ–¹å¼ | ç¤ºä¾‹ä»£ç  |
|-------|---------------|---------------|----------|
| **Server Streaming** | `return nil` | `err == io.EOF` | `if err == io.EOF { break }` |
| **Client Streaming** | `CloseAndRecv()` | `err == io.EOF` | `if err == io.EOF { break }` |
| **Bidirectional** | `CloseSend()` | `err == io.EOF` | `if err == io.EOF { return }` |

### 5.3 æ­£ç¡®çš„EOFå¤„ç†æ¨¡å¼


```go
// âœ… æ­£ç¡®çš„æµæ¥æ”¶æ¨¡å¼
func receiveStream(stream SomeStreamClient) {
    for {
        data, err := stream.Recv()
        
        // ğŸ”¸ é¦–å…ˆæ£€æŸ¥EOF
        if err == io.EOF {
            fmt.Println("æµç»“æŸ")
            break // æ­£å¸¸ç»“æŸ
        }
        
        // ğŸ”¸ å†æ£€æŸ¥å…¶ä»–é”™è¯¯
        if err != nil {
            fmt.Printf("æ¥æ”¶é”™è¯¯: %v\n", err)
            return // å¼‚å¸¸ç»“æŸ
        }
        
        // ğŸ”¸ å¤„ç†æ­£å¸¸æ•°æ®
        processData(data)
    }
}

// âŒ é”™è¯¯çš„å¤„ç†æ–¹å¼
func receiveStreamWrong(stream SomeStreamClient) {
    for {
        data, err := stream.Recv()
        if err != nil {
            // é”™è¯¯ï¼šæŠŠEOFå½“ä½œé”™è¯¯å¤„ç†äº†
            log.Fatal(err)
        }
        processData(data)
    }
}
```

> âš ï¸ **å¸¸è§é”™è¯¯**ï¼šæŠŠEOFå½“ä½œé”™è¯¯å¤„ç†ï¼Œå®é™…ä¸ŠEOFæ˜¯æ­£å¸¸çš„æµç»“æŸä¿¡å·

### 5.4 æµç»“æŸçš„æœ€ä½³å®è·µ


```go
// ğŸ”¸ æœ€ä½³å®è·µï¼šç»Ÿä¸€çš„æµå¤„ç†å‡½æ•°
func handleStreamReceive(stream StreamReceiver, handler func(interface{})) error {
    for {
        data, err := stream.Recv()
        
        if err == io.EOF {
            return nil // æ­£å¸¸ç»“æŸ
        }
        
        if err != nil {
            return fmt.Errorf("æµæ¥æ”¶é”™è¯¯: %w", err)
        }
        
        handler(data)
    }
}

// ä½¿ç”¨ç¤ºä¾‹
err := handleStreamReceive(stream, func(data interface{}) {
    user := data.(*pb.User)
    fmt.Printf("å¤„ç†ç”¨æˆ·: %s\n", user.Name)
})

if err != nil {
    log.Printf("æµå¤„ç†å¤±è´¥: %v", err)
}
```

---

## 6. ğŸš€ æµå¼åœºæ™¯åº”ç”¨å®æˆ˜


### 6.1 å®æ—¶æ•°æ®æ¨é€åœºæ™¯


**è‚¡ç¥¨ä»·æ ¼å®æ—¶æ¨é€ç³»ç»Ÿ**

```go
// æœåŠ¡ç«¯ï¼šå®æ—¶æ¨é€è‚¡ç¥¨ä»·æ ¼
func (s *StockService) GetRealTimePrices(req *pb.StockRequest, 
    stream pb.StockService_GetRealTimePricesServer) error {
    
    ticker := time.NewTicker(1 * time.Second)
    defer ticker.Stop()
    
    for {
        select {
        case <-ticker.C:
            // æ¨¡æ‹Ÿè·å–å®æ—¶è‚¡ä»·
            price := &pb.StockPrice{
                Symbol:    req.Symbol,
                Price:     generateRandomPrice(),
                Timestamp: time.Now().Unix(),
            }
            
            if err := stream.Send(price); err != nil {
                return err
            }
            
        case <-stream.Context().Done():
            // å®¢æˆ·ç«¯æ–­å¼€è¿æ¥
            return stream.Context().Err()
        }
    }
}

// å®¢æˆ·ç«¯ï¼šæ¥æ”¶å®æ—¶è‚¡ä»·
func subscribeStockPrices() {
    stream, err := client.GetRealTimePrices(context.Background(), 
        &pb.StockRequest{Symbol: "AAPL"})
    if err != nil {
        log.Fatal(err)
    }
    
    for {
        price, err := stream.Recv()
        if err == io.EOF {
            break
        }
        if err != nil {
            log.Fatal(err)
        }
        
        // æ›´æ–°UIæ˜¾ç¤ºæœ€æ–°ä»·æ ¼
        updatePriceDisplay(price)
    }
}
```

### 6.2 æ–‡ä»¶ä¼ è¾“åœºæ™¯


**å¤§æ–‡ä»¶åˆ†å—ä¸Šä¼ ä¸‹è½½**

```go
// æ–‡ä»¶ä¸Šä¼ ï¼šå®¢æˆ·ç«¯æµ
func uploadLargeFile(filePath string) {
    file, err := os.Open(filePath)
    if err != nil {
        log.Fatal(err)
    }
    defer file.Close()
    
    stream, err := client.UploadFile(context.Background())
    if err != nil {
        log.Fatal(err)
    }
    
    buffer := make([]byte, 1024*1024) // 1MB ç¼“å†²åŒº
    chunkNum := 0
    
    for {
        n, err := file.Read(buffer)
        if err == io.EOF {
            break
        }
        if err != nil {
            log.Fatal(err)
        }
        
        chunk := &pb.FileChunk{
            FileName:    filepath.Base(filePath),
            Data:        buffer[:n],
            ChunkNumber: int32(chunkNum),
        }
        
        if err := stream.Send(chunk); err != nil {
            log.Fatal(err)
        }
        
        chunkNum++
        fmt.Printf("ä¸Šä¼ è¿›åº¦: %d%%\n", chunkNum*100/totalChunks)
    }
    
    response, err := stream.CloseAndRecv()
    if err != nil {
        log.Fatal(err)
    }
    
    fmt.Printf("ä¸Šä¼ å®Œæˆ: %s\n", response.Message)
}
```

### 6.3 èŠå¤©ç³»ç»Ÿåœºæ™¯


**å®æ—¶èŠå¤©å®¤**

```go
// èŠå¤©å®¤ç®¡ç†å™¨
type ChatRoom struct {
    clients map[string]pb.ChatService_ChatServer
    mutex   sync.RWMutex
}

func (room *ChatRoom) AddClient(userID string, stream pb.ChatService_ChatServer) {
    room.mutex.Lock()
    defer room.mutex.Unlock()
    room.clients[userID] = stream
}

func (room *ChatRoom) RemoveClient(userID string) {
    room.mutex.Lock()
    defer room.mutex.Unlock()
    delete(room.clients, userID)
}

func (room *ChatRoom) Broadcast(message *pb.ChatMessage) {
    room.mutex.RLock()
    defer room.mutex.RUnlock()
    
    for userID, stream := range room.clients {
        if userID != message.UserId { // ä¸å‘ç»™è‡ªå·±
            if err := stream.Send(message); err != nil {
                // å‘é€å¤±è´¥ï¼Œç§»é™¤å®¢æˆ·ç«¯
                delete(room.clients, userID)
            }
        }
    }
}

// èŠå¤©æœåŠ¡å®ç°
func (s *ChatServiceServer) Chat(stream pb.ChatService_ChatServer) error {
    userID := getUserIDFromContext(stream.Context())
    
    // æ·»åŠ åˆ°èŠå¤©å®¤
    chatRoom.AddClient(userID, stream)
    defer chatRoom.RemoveClient(userID)
    
    for {
        message, err := stream.Recv()
        if err == io.EOF {
            return nil
        }
        if err != nil {
            return err
        }
        
        // å¹¿æ’­æ¶ˆæ¯ç»™å…¶ä»–ç”¨æˆ·
        chatRoom.Broadcast(message)
    }
}
```

> ğŸ’¡ **å®æˆ˜ç»éªŒ**ï¼š
> - **å®æ—¶æ¨é€**ï¼šç”¨`time.Ticker`å®šæ—¶å‘é€ï¼Œæ£€æŸ¥`Context().Done()`å¤„ç†æ–­è¿
> - **æ–‡ä»¶ä¼ è¾“**ï¼šåˆç†è®¾ç½®ç¼“å†²åŒºå¤§å°ï¼Œæ˜¾ç¤ºè¿›åº¦åé¦ˆ
> - **èŠå¤©ç³»ç»Ÿ**ï¼šç»´æŠ¤å®¢æˆ·ç«¯è¿æ¥æ± ï¼Œå®ç°æ¶ˆæ¯å¹¿æ’­

---

## 7. âš ï¸ å¼‚æ­¥æµå¤„ç†é™·é˜±


### 7.1 å¸¸è§é™·é˜±1ï¼šå¿˜è®°å¤„ç†Contextå–æ¶ˆ


```go
// âŒ é”™è¯¯ï¼šæ²¡æœ‰å¤„ç†Contextå–æ¶ˆ
func badStreamHandler(stream SomeStream) error {
    for {
        // æ­»å¾ªç¯ï¼Œå³ä½¿å®¢æˆ·ç«¯æ–­å¼€ä¹Ÿä¸ä¼šé€€å‡º
        data := generateData()
        if err := stream.Send(data); err != nil {
            return err
        }
        time.Sleep(1 * time.Second)
    }
}

// âœ… æ­£ç¡®ï¼šå¤„ç†Contextå–æ¶ˆ
func goodStreamHandler(stream SomeStream) error {
    ticker := time.NewTicker(1 * time.Second)
    defer ticker.Stop()
    
    for {
        select {
        case <-ticker.C:
            data := generateData()
            if err := stream.Send(data); err != nil {
                return err
            }
            
        case <-stream.Context().Done():
            // ğŸ”¸ å…³é”®ï¼šæ£€æŸ¥Contextæ˜¯å¦è¢«å–æ¶ˆ
            return stream.Context().Err()
        }
    }
}
```

### 7.2 å¸¸è§é™·é˜±2ï¼šgoroutineæ³„éœ²


```go
// âŒ é”™è¯¯ï¼šgoroutineæ²¡æœ‰æ­£ç¡®é€€å‡º
func badBidirectionalStream(stream SomeStream) error {
    // è¿™ä¸ªgoroutineå¯èƒ½æ°¸è¿œä¸ä¼šé€€å‡º
    go func() {
        for {
            data, err := stream.Recv()
            if err != nil {
                return // ğŸ˜± goroutineæ³„éœ²ï¼
            }
            processData(data)
        }
    }()
    
    // ä¸»å‡½æ•°å¯èƒ½å¾ˆå¿«è¿”å›ï¼Œä½†goroutineè¿˜åœ¨è¿è¡Œ
    return nil
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨channelåè°ƒgoroutineé€€å‡º
func goodBidirectionalStream(stream SomeStream) error {
    done := make(chan error, 2) // ç¼“å†²channel
    
    // æ¥æ”¶goroutine
    go func() {
        for {
            data, err := stream.Recv()
            if err == io.EOF {
                done <- nil
                return
            }
            if err != nil {
                done <- err
                return
            }
            processData(data)
        }
    }()
    
    // å‘é€goroutine  
    go func() {
        for {
            select {
            case <-stream.Context().Done():
                done <- stream.Context().Err()
                return
            default:
                data := generateData()
                if err := stream.Send(data); err != nil {
                    done <- err
                    return
                }
                time.Sleep(1 * time.Second)
            }
        }
    }()
    
    // ğŸ”¸ å…³é”®ï¼šç­‰å¾…ä»»ä¸€goroutineç»“æŸ
    return <-done
}
```

### 7.3 å¸¸è§é™·é˜±3ï¼šç¼“å†²åŒºé˜»å¡


```go
// âŒ é”™è¯¯ï¼šå‘é€å¤ªå¿«å¯¼è‡´é˜»å¡
func badRapidSend(stream SomeStream) error {
    for i := 0; i < 1000000; i++ {
        // ğŸ˜± å‘é€å¤ªå¿«ï¼Œå¯èƒ½å¯¼è‡´ç¼“å†²åŒºæ»¡ï¼Œé˜»å¡
        if err := stream.Send(generateLargeData()); err != nil {
            return err
        }
    }
    return nil
}

// âœ… æ­£ç¡®ï¼šæ§åˆ¶å‘é€é€Ÿç‡
func goodControlledSend(stream SomeStream) error {
    limiter := time.NewTicker(10 * time.Millisecond)
    defer limiter.Stop()
    
    for i := 0; i < 1000000; i++ {
        select {
        case <-limiter.C:
            // ğŸ”¸ å…³é”®ï¼šé™åˆ¶å‘é€é€Ÿç‡
            if err := stream.Send(generateData()); err != nil {
                return err
            }
            
        case <-stream.Context().Done():
            return stream.Context().Err()
        }
    }
    return nil
}
```

### 7.4 å¸¸è§é™·é˜±4ï¼šé”™è¯¯å¤„ç†ä¸å½“


```go
// âŒ é”™è¯¯ï¼šæŠŠEOFå½“é”™è¯¯å¤„ç†
func badErrorHandling(stream SomeStream) {
    for {
        data, err := stream.Recv()
        if err != nil {
            // ğŸ˜± EOFä¹Ÿè¢«å½“ä½œé”™è¯¯äº†
            log.Fatal("æµé”™è¯¯:", err)
        }
        processData(data)
    }
}

// âœ… æ­£ç¡®ï¼šåŒºåˆ†EOFå’ŒçœŸæ­£çš„é”™è¯¯
func goodErrorHandling(stream SomeStream) error {
    for {
        data, err := stream.Recv()
        
        if err == io.EOF {
            // ğŸ”¸ EOFæ˜¯æ­£å¸¸ç»“æŸ
            log.Println("æµæ­£å¸¸ç»“æŸ")
            return nil
        }
        
        if err != nil {
            // ğŸ”¸ è¿™æ‰æ˜¯çœŸæ­£çš„é”™è¯¯
            return fmt.Errorf("æµæ¥æ”¶é”™è¯¯: %w", err)
        }
        
        if err := processData(data); err != nil {
            return fmt.Errorf("æ•°æ®å¤„ç†é”™è¯¯: %w", err)
        }
    }
}
```

> âš ï¸ **é™·é˜±æ€»ç»“**ï¼š
> - **Contextå–æ¶ˆ**ï¼šåŠ¡å¿…æ£€æŸ¥`Context().Done()`
> - **Goroutineæ³„éœ²**ï¼šä½¿ç”¨channelåè°ƒé€€å‡º
> - **ç¼“å†²åŒºé˜»å¡**ï¼šæ§åˆ¶å‘é€é€Ÿç‡
> - **é”™è¯¯å¤„ç†**ï¼šåŒºåˆ†EOFå’ŒçœŸæ­£é”™è¯¯

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æµå¼RPCæœ¬è´¨ï¼šæŒç»­çš„æ•°æ®ä¼ è¾“ï¼Œè§£å†³å¤§æ•°æ®ã€å®æ—¶æ€§ã€é•¿æ—¶é—´å¤„ç†é—®é¢˜
ğŸ”¸ ä¸‰ç§æµç±»å‹ï¼šServer Streamingã€Client Streamingã€Bidirectional Streaming
ğŸ”¸ æ ¸å¿ƒAPIï¼šSend()å‘é€æ•°æ®ï¼ŒRecv()æ¥æ”¶æ•°æ®ï¼ŒEOFåˆ¤æ–­ç»“æŸ
ğŸ”¸ åŒå‘æµè¦ç‚¹ï¼šå¿…é¡»ä½¿ç”¨goroutineå®ç°å¹¶å‘æ”¶å‘
ğŸ”¸ é”™è¯¯å¤„ç†ï¼šEOFæ˜¯æ­£å¸¸ç»“æŸï¼Œä¸æ˜¯é”™è¯¯
```

### 8.2 å…³é”®æ“ä½œæ¨¡å¼


**ğŸ“Š æ“ä½œæ¨¡å¼å¯¹æ¯”**

| æµç±»å‹ | æœåŠ¡ç«¯ä¸»è¦æ“ä½œ | å®¢æˆ·ç«¯ä¸»è¦æ“ä½œ | ç»“æŸæ–¹å¼ |
|-------|---------------|---------------|----------|
| **Server Streaming** | `stream.Send()` å¾ªç¯å‘é€ | `stream.Recv()` å¾ªç¯æ¥æ”¶ | æœåŠ¡ç«¯ `return nil` |
| **Client Streaming** | `stream.Recv()` + `SendAndClose()` | `stream.Send()` + `CloseAndRecv()` | å®¢æˆ·ç«¯ `CloseAndRecv()` |
| **Bidirectional** | goroutine å¹¶å‘æ”¶å‘ | goroutine å¹¶å‘æ”¶å‘ | ä»»ä¸€æ–¹ `CloseSend()` |

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ åœºæ™¯é€‰æ‹©æŒ‡å—**

```
é€‰æ‹©Server Streamingï¼š
âœ… æ•°æ®æŸ¥è¯¢åˆ†é¡µè¿”å›
âœ… å®æ—¶æ•°æ®æ¨é€  
âœ… æ–‡ä»¶ä¸‹è½½
âœ… è¿›åº¦åé¦ˆ

é€‰æ‹©Client Streamingï¼š
âœ… æ–‡ä»¶ä¸Šä¼ 
âœ… æ•°æ®æ±‡æ€»ç»Ÿè®¡
âœ… æ‰¹é‡æ“ä½œ
âœ… æ—¥å¿—æ”¶é›†

é€‰æ‹©Bidirectional Streamingï¼š
âœ… å®æ—¶èŠå¤©
âœ… åœ¨çº¿åä½œ
âœ… æ¸¸æˆé€šä¿¡
âœ… å®æ—¶æ•°æ®åˆ†æ
```

### 8.4 æœ€ä½³å®è·µchecklist


> ğŸ“ **å¼€å‘checklist**
> - [ ] æ­£ç¡®å¤„ç†EOFï¼ŒåŒºåˆ†æ­£å¸¸ç»“æŸå’Œé”™è¯¯
> - [ ] åŒå‘æµä½¿ç”¨goroutineå®ç°å¹¶å‘
> - [ ] æ£€æŸ¥Context.Done()å¤„ç†å®¢æˆ·ç«¯æ–­è¿
> - [ ] ä½¿ç”¨channelåè°ƒgoroutineé€€å‡ºï¼Œé¿å…æ³„éœ²
> - [ ] æ§åˆ¶å‘é€é€Ÿç‡ï¼Œé¿å…ç¼“å†²åŒºé˜»å¡
> - [ ] é€‚å½“çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
> - [ ] åˆç†è®¾ç½®è¶…æ—¶å’Œé‡è¯•æœºåˆ¶

### 8.5 è®°å¿†è¦ç‚¹


**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- **æµå¼ä¼ è¾“è§£éš¾é¢˜**ï¼šå¤§æ•°æ®ã€å®æ—¶æ€§ã€é•¿å¤„ç†
- **ä¸‰ç§æ¨¡å¼å„æœ‰ç”¨**ï¼šå•å‘æ¨æ‹‰ã€åŒå‘äº’é€š  
- **EOFæ­£å¸¸ä¸æ˜¯é”™**ï¼šæµç»“æŸæ ‡å¿—è¦è®°æ¸…
- **åŒå‘å¹¶å‘ç”¨åç¨‹**ï¼šSendå’ŒRecvè¦åˆ†ç¦»
- **Contextå–æ¶ˆè¦æ£€æŸ¥**ï¼šå®¢æˆ·ç«¯æ–­è¿åŠæ—¶çŸ¥

**å®æˆ˜ç»éªŒ**ï¼š
- æµå¼RPCè®©æ•°æ®ä¼ è¾“æ›´é«˜æ•ˆã€æ›´å®æ—¶
- é€‰æ‹©åˆé€‚çš„æµç±»å‹æ˜¯å…³é”®ï¼Œä¸åŒåœºæ™¯æœ‰ä¸åŒçš„æœ€ä½³é€‰æ‹©
- å¼‚æ­¥å¤„ç†éœ€è¦ç‰¹åˆ«æ³¨æ„èµ„æºç®¡ç†å’Œé”™è¯¯å¤„ç†
- å®é™…é¡¹ç›®ä¸­è¦è€ƒè™‘ç½‘ç»œå¼‚å¸¸ã€å®¢æˆ·ç«¯æ–­è¿ç­‰è¾¹ç•Œæƒ…å†µ