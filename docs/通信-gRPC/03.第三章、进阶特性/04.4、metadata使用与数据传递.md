---
title: 4ã€metadataä½¿ç”¨ä¸æ•°æ®ä¼ é€’
---
## ğŸ“š ç›®å½•

1. [Metadataæ¦‚å¿µä¸åŸºç¡€ä½¿ç”¨](#1-metadataæ¦‚å¿µä¸åŸºç¡€ä½¿ç”¨)
2. [Metadataæ•°æ®ä¼ é€’è¯¦è§£](#2-metadataæ•°æ®ä¼ é€’è¯¦è§£)
3. [Binary MetadataäºŒè¿›åˆ¶æ•°æ®](#3-binary-metadataäºŒè¿›åˆ¶æ•°æ®)
4. [Metadataå®é™…åº”ç”¨åœºæ™¯](#4-metadataå®é™…åº”ç”¨åœºæ™¯)
5. [æ•°æ®åºåˆ—åŒ–ä¸ååºåˆ—åŒ–æ·±å…¥](#5-æ•°æ®åºåˆ—åŒ–ä¸ååºåˆ—åŒ–æ·±å…¥)
6. [Protobufç¼–è§£ç è¿‡ç¨‹è¯¦è§£](#6-protobufç¼–è§£ç è¿‡ç¨‹è¯¦è§£)
7. [å­—æ®µç±»å‹æ”¯æŒä¸æœ€ä½³å®è·µ](#7-å­—æ®µç±»å‹æ”¯æŒä¸æœ€ä½³å®è·µ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ Metadataæ¦‚å¿µä¸åŸºç¡€ä½¿ç”¨


### 1.1 ä»€ä¹ˆæ˜¯Metadataï¼Ÿ


**ç®€å•ç†è§£**ï¼šMetadataå°±åƒæ˜¯gRPCè¯·æ±‚çš„"å°çº¸æ¡"ï¼Œå¯ä»¥åœ¨ä¸å½±å“ä¸»è¦ä¸šåŠ¡æ•°æ®çš„æƒ…å†µä¸‹ï¼Œä¼ é€’ä¸€äº›é¢å¤–çš„ä¿¡æ¯ã€‚

> ğŸ’¡ **é€šä¿—æ¯”å–»**ï¼šå°±åƒå¯„å¿«é€’æ—¶ï¼ŒåŒ…è£¹é‡Œæ˜¯ä¸»è¦ç‰©å“ï¼ˆä¸šåŠ¡æ•°æ®ï¼‰ï¼Œè€Œå¿«é€’å•ä¸Šçš„æ”¶ä»¶äººã€ç”µè¯ã€å¤‡æ³¨ç­‰ä¿¡æ¯å°±æ˜¯metadata

```
æ™®é€šHTTPè¯·æ±‚çš„å¯¹æ¯”ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ HTTP Header (ç±»ä¼¼metadata)   â”‚ â† Authorization: Bearer xxx
â”‚                            â”‚ â† Content-Type: application/json  
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ HTTP Body (ä¸šåŠ¡æ•°æ®)        â”‚ â† {"name": "å¼ ä¸‰", "age": 25}
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

gRPCè¯·æ±‚çš„ç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ gRPC Metadata               â”‚ â† token: abc123
â”‚                            â”‚ â† trace-id: xyz789
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  
â”‚ Protobuf Message (ä¸šåŠ¡æ•°æ®) â”‚ â† UserInfo {name: "å¼ ä¸‰", age: 25}
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 Metadataçš„åŸºæœ¬ç‰¹ç‚¹


ğŸ”¸ **é”®å€¼å¯¹ç»“æ„**ï¼šæ¯ä¸ªmetadataéƒ½æ˜¯ `key: value` çš„å½¢å¼  
ğŸ”¸ **å­—ç¬¦ä¸²ç±»å‹**ï¼škeyå’Œvalueéƒ½æ˜¯å­—ç¬¦ä¸²ï¼ˆé™¤äº†binary metadataï¼‰  
ğŸ”¸ **å¤§å°å†™ä¸æ•æ„Ÿ**ï¼škeyä¸åŒºåˆ†å¤§å°å†™  
ğŸ”¸ **å¯ä¼ é€’å¤šä¸ª**ï¼šä¸€æ¬¡è¯·æ±‚å¯ä»¥æºå¸¦å¤šä¸ªmetadata  

### 1.3 ç®€å•ä½¿ç”¨ç¤ºä¾‹


**å‘é€æ–¹ï¼ˆå®¢æˆ·ç«¯ï¼‰**ï¼š
```go
// 1. åˆ›å»ºmetadata
md := metadata.New(map[string]string{
    "token":    "abc123",
    "user-id":  "12345",
    "app-name": "my-app",
})

// 2. æŠŠmetadataæ·»åŠ åˆ°è¯·æ±‚ä¸Šä¸‹æ–‡
ctx := metadata.NewOutgoingContext(context.Background(), md)

// 3. æ­£å¸¸è°ƒç”¨gRPCæ–¹æ³•ï¼Œmetadataä¼šè‡ªåŠ¨ä¼ é€’
response, err := client.GetUser(ctx, &pb.UserRequest{Id: 1})
```

**æ¥æ”¶æ–¹ï¼ˆæœåŠ¡ç«¯ï¼‰**ï¼š
```go
func (s *server) GetUser(ctx context.Context, req *pb.UserRequest) (*pb.UserResponse, error) {
    // 1. ä»è¯·æ±‚ä¸Šä¸‹æ–‡ä¸­å–å‡ºmetadata
    md, ok := metadata.FromIncomingContext(ctx)
    if !ok {
        return nil, errors.New("æ²¡æœ‰æ‰¾åˆ°metadata")
    }
    
    // 2. è·å–å…·ä½“çš„å€¼
    token := md.Get("token")
    userID := md.Get("user-id")
    
    fmt.Printf("æ”¶åˆ°token: %v\n", token)
    fmt.Printf("æ”¶åˆ°user-id: %v\n", userID)
    
    // 3. æ­£å¸¸å¤„ç†ä¸šåŠ¡é€»è¾‘
    return &pb.UserResponse{Name: "å¼ ä¸‰"}, nil
}
```

---

## 2. ğŸ”„ Metadataæ•°æ®ä¼ é€’è¯¦è§£


### 2.1 ä¼ é€’æ–¹å‘ç†è§£


```
å®¢æˆ·ç«¯ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” æœåŠ¡ç«¯
      â”‚                                        â”‚
      â”‚  1. å‘é€metadata (OutgoingContext)     â”‚
      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
      â”‚                                        â”‚
      â”‚  2. æ¥æ”¶metadata (IncomingContext)     â”‚
      â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
      â”‚                                        â”‚

åŒå‘ä¼ é€’ï¼š
- å®¢æˆ·ç«¯ â†’ æœåŠ¡ç«¯ï¼šè¯·æ±‚metadata  
- æœåŠ¡ç«¯ â†’ å®¢æˆ·ç«¯ï¼šå“åº”metadata
```

### 2.2 å‘é€Metadataçš„è¯¦ç»†æ­¥éª¤


**æ–¹å¼ä¸€ï¼šä½¿ç”¨metadata.New()**
```go
// åˆ›å»ºä¸€ä¸ªmetadataæ˜ å°„
md := metadata.New(map[string]string{
    "authorization": "Bearer token123",
    "request-id":    "req-001",
    "client-type":   "mobile",
})

ctx := metadata.NewOutgoingContext(context.Background(), md)
```

**æ–¹å¼äºŒï¼šä½¿ç”¨metadata.Pairs()**
```go
// ç”¨é”®å€¼å¯¹çš„æ–¹å¼åˆ›å»ºï¼ˆæ›´ç›´è§‚ï¼‰
md := metadata.Pairs(
    "authorization", "Bearer token123",
    "request-id", "req-001", 
    "client-type", "mobile",
)

ctx := metadata.NewOutgoingContext(context.Background(), md)
```

**æ–¹å¼ä¸‰ï¼šè¿½åŠ metadata**
```go
// åœ¨å·²æœ‰çš„contextåŸºç¡€ä¸Šè¿½åŠ 
ctx := context.Background()
ctx = metadata.AppendToOutgoingContext(ctx, 
    "authorization", "Bearer token123",
    "request-id", "req-001",
)
```

### 2.3 æ¥æ”¶Metadataçš„å¤„ç†æ–¹å¼


**åŸºç¡€æ¥æ”¶**ï¼š
```go
func (s *server) MyMethod(ctx context.Context, req *pb.Request) (*pb.Response, error) {
    // è·å–æ‰€æœ‰metadata
    md, ok := metadata.FromIncomingContext(ctx)
    if !ok {
        return nil, errors.New("æ— æ³•è·å–metadata")
    }
    
    // è·å–ç‰¹å®šå­—æ®µï¼ˆè¿”å›å­—ç¬¦ä¸²åˆ‡ç‰‡ï¼‰
    tokens := md.Get("authorization")
    if len(tokens) > 0 {
        token := tokens[0] // å–ç¬¬ä¸€ä¸ªå€¼
        fmt.Printf("è®¤è¯token: %s\n", token)
    }
    
    return &pb.Response{}, nil
}
```

**å®‰å…¨è·å–ï¼ˆæ¨èï¼‰**ï¼š
```go
func getMetadataValue(md metadata.MD, key string) string {
    values := md.Get(key)
    if len(values) == 0 {
        return ""
    }
    return values[0]
}

// ä½¿ç”¨
token := getMetadataValue(md, "authorization")
userID := getMetadataValue(md, "user-id")
```

### 2.4 æœåŠ¡ç«¯å‘é€Metadataç»™å®¢æˆ·ç«¯


**å‘é€Header Metadata**ï¼š
```go
func (s *server) MyMethod(ctx context.Context, req *pb.Request) (*pb.Response, error) {
    // åˆ›å»ºè¦å‘é€çš„metadata
    header := metadata.Pairs(
        "server-version", "1.0.0",
        "processed-time", time.Now().Format(time.RFC3339),
    )
    
    // å‘é€header metadata
    grpc.SendHeader(ctx, header)
    
    return &pb.Response{}, nil
}
```

**å‘é€Trailer Metadata**ï¼š
```go
func (s *server) MyMethod(ctx context.Context, req *pb.Request) (*pb.Response, error) {
    // trailerä¼šåœ¨å“åº”ç»“æŸåå‘é€
    trailer := metadata.Pairs(
        "request-cost", "100ms",
        "cache-hit", "true",
    )
    
    grpc.SetTrailer(ctx, trailer)
    
    return &pb.Response{}, nil
}
```

---

## 3. ğŸ“¦ Binary MetadataäºŒè¿›åˆ¶æ•°æ®


### 3.1 ä¸ºä»€ä¹ˆéœ€è¦Binary Metadataï¼Ÿ


> ğŸ’¡ **ä½¿ç”¨åœºæ™¯**ï¼šå½“ä½ éœ€è¦ä¼ é€’çš„ä¸æ˜¯æ™®é€šæ–‡å­—ï¼Œè€Œæ˜¯å›¾ç‰‡ã€æ–‡ä»¶ã€åŠ å¯†æ•°æ®ç­‰äºŒè¿›åˆ¶å†…å®¹æ—¶

**æ™®é€šmetadataé™åˆ¶**ï¼š
- âœ… åªèƒ½ä¼ é€’æ–‡æœ¬å­—ç¬¦ä¸²
- âŒ ä¸èƒ½ä¼ é€’äºŒè¿›åˆ¶æ•°æ®
- âŒ ä¸èƒ½ä¼ é€’ç‰¹æ®Šå­—ç¬¦

**Binary metadataä¼˜åŠ¿**ï¼š
- âœ… å¯ä»¥ä¼ é€’ä»»æ„äºŒè¿›åˆ¶æ•°æ®
- âœ… æ”¯æŒåŠ å¯†åçš„æ•°æ®
- âœ… æ”¯æŒåºåˆ—åŒ–çš„å¯¹è±¡

### 3.2 Binary Metadataçš„å‘½åè§„åˆ™


ğŸ”¸ **å…³é”®è§„åˆ™**ï¼šBinary metadataçš„keyå¿…é¡»ä»¥ `-bin` ç»“å°¾

```go
// âœ… æ­£ç¡®çš„binary metadata key
"file-data-bin"
"encrypted-token-bin" 
"user-avatar-bin"

// âŒ é”™è¯¯çš„keyï¼ˆä¸ä¼šè¢«å½“ä½œbinaryå¤„ç†ï¼‰
"file-data"
"encrypted-token"
```

### 3.3 å‘é€Binary Metadata


```go
// å‡è®¾è¦ä¼ é€’ä¸€ä¸ªå°å›¾ç‰‡
imageData := []byte{0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A...} // PNGå›¾ç‰‡æ•°æ®

// å°†äºŒè¿›åˆ¶æ•°æ®ç¼–ç ä¸ºbase64å­—ç¬¦ä¸²
encodedData := base64.StdEncoding.EncodeToString(imageData)

// åˆ›å»ºbinary metadata
md := metadata.Pairs(
    "user-avatar-bin", encodedData,     // binaryæ•°æ®
    "content-type", "image/png",        // æ™®é€šmetadata
)

ctx := metadata.NewOutgoingContext(context.Background(), md)
```

### 3.4 æ¥æ”¶Binary Metadata


```go
func (s *server) UploadProfile(ctx context.Context, req *pb.ProfileRequest) (*pb.ProfileResponse, error) {
    md, ok := metadata.FromIncomingContext(ctx)
    if !ok {
        return nil, errors.New("æ— æ³•è·å–metadata")
    }
    
    // è·å–binaryæ•°æ®
    avatarData := md.Get("user-avatar-bin")
    if len(avatarData) > 0 {
        // è§£ç base64æ•°æ®
        imageBytes, err := base64.StdEncoding.DecodeString(avatarData[0])
        if err != nil {
            return nil, err
        }
        
        fmt.Printf("æ”¶åˆ°å›¾ç‰‡æ•°æ®ï¼Œå¤§å°: %d å­—èŠ‚\n", len(imageBytes))
        
        // ä¿å­˜å›¾ç‰‡æ–‡ä»¶
        err = os.WriteFile("avatar.png", imageBytes, 0644)
        if err != nil {
            return nil, err
        }
    }
    
    return &pb.ProfileResponse{Success: true}, nil
}
```

---

## 4. ğŸ¯ Metadataå®é™…åº”ç”¨åœºæ™¯


### 4.1 èº«ä»½è®¤è¯ä¸æˆæƒ


**JWT Tokenä¼ é€’**ï¼š
```go
// å®¢æˆ·ç«¯å‘é€è®¤è¯ä¿¡æ¯
token := "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
md := metadata.Pairs("authorization", "Bearer "+token)
ctx := metadata.NewOutgoingContext(context.Background(), md)

// æœåŠ¡ç«¯éªŒè¯token
func (s *server) SecureMethod(ctx context.Context, req *pb.Request) (*pb.Response, error) {
    md, _ := metadata.FromIncomingContext(ctx)
    authHeader := getMetadataValue(md, "authorization")
    
    if !strings.HasPrefix(authHeader, "Bearer ") {
        return nil, status.Error(codes.Unauthenticated, "ç¼ºå°‘è®¤è¯ä¿¡æ¯")
    }
    
    token := strings.TrimPrefix(authHeader, "Bearer ")
    if !isValidToken(token) {
        return nil, status.Error(codes.Unauthenticated, "æ— æ•ˆtoken")
    }
    
    // ç»§ç»­å¤„ç†ä¸šåŠ¡é€»è¾‘...
}
```

### 4.2 åˆ†å¸ƒå¼è¿½è¸ª


**Trace IDä¼ é€’**ï¼š
```go
// åœ¨å¾®æœåŠ¡é“¾è·¯ä¸­ä¼ é€’è¿½è¸ªID
traceID := generateTraceID() // ç”Ÿæˆå”¯ä¸€è¿½è¸ªID
md := metadata.Pairs(
    "trace-id", traceID,
    "span-id", generateSpanID(),
    "parent-span-id", getParentSpanID(),
)

ctx := metadata.NewOutgoingContext(context.Background(), md)
```

### 4.3 è¯·æ±‚ä¿¡æ¯ä¼ é€’


**ç”¨æˆ·ä¿¡æ¯ä¸ç¯å¢ƒä¿¡æ¯**ï¼š
```go
md := metadata.Pairs(
    "user-id", "12345",
    "user-role", "admin", 
    "client-ip", "192.168.1.100",
    "user-agent", "MyApp/1.0.0",
    "environment", "production",
    "region", "us-west-1",
)
```

### 4.4 ç‰ˆæœ¬æ§åˆ¶ä¸å…¼å®¹æ€§


**APIç‰ˆæœ¬ç®¡ç†**ï¼š
```go
md := metadata.Pairs(
    "api-version", "v2.1",
    "client-version", "1.5.0",
    "feature-flags", "new-ui,beta-search",
)

// æœåŠ¡ç«¯æ ¹æ®ç‰ˆæœ¬å·å¤„ç†ä¸åŒé€»è¾‘
func (s *server) GetData(ctx context.Context, req *pb.Request) (*pb.Response, error) {
    md, _ := metadata.FromIncomingContext(ctx)
    apiVersion := getMetadataValue(md, "api-version")
    
    switch apiVersion {
    case "v2.1":
        return s.handleV21Request(req)
    case "v2.0":
        return s.handleV20Request(req)  
    default:
        return s.handleLegacyRequest(req)
    }
}
```

---

## 5. ğŸ”„ æ•°æ®åºåˆ—åŒ–ä¸ååºåˆ—åŒ–æ·±å…¥


### 5.1 ä»€ä¹ˆæ˜¯åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Ÿ


> ğŸ’¡ **é€šä¿—ç†è§£**ï¼š
> - **åºåˆ—åŒ–**ï¼šæŠŠå†…å­˜ä¸­çš„å¯¹è±¡å˜æˆå¯ä»¥ä¼ è¾“çš„å­—èŠ‚æµï¼ˆåƒæŠŠä¸œè¥¿æ‰“åŒ…ï¼‰
> - **ååºåˆ—åŒ–**ï¼šæŠŠå­—èŠ‚æµé‡æ–°å˜å›å†…å­˜ä¸­çš„å¯¹è±¡ï¼ˆåƒæŠŠåŒ…è£¹æ‹†å¼€ï¼‰

```
ç¨‹åºå†…å­˜ä¸­çš„å¯¹è±¡ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” ç½‘ç»œä¼ è¾“çš„å­—èŠ‚æµ
                â”‚                                      â”‚
User {          â”‚  åºåˆ—åŒ– (Serialize)                   â”‚  [0x08, 0x01, 0x12, 0x04, 
  id: 1,        â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚   0x4A, 0x6F, 0x68, 0x6E,
  name: "John", â”‚                                      â”‚   0x18, 0x19]
  age: 25       â”‚  ååºåˆ—åŒ– (Deserialize)                â”‚
}               â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
```

### 5.2 gRPCä¸­çš„åºåˆ—åŒ–æµç¨‹


**å®Œæ•´çš„æ•°æ®ä¼ è¾“è¿‡ç¨‹**ï¼š

```
å®¢æˆ·ç«¯                                               æœåŠ¡ç«¯
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Goå¯¹è±¡          â”‚                               â”‚ æ”¶åˆ°å­—èŠ‚æµ       â”‚
â”‚ User{id:1,...}  â”‚                               â”‚ [0x08,0x01...]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                                   â”‚
         â”‚ 1. åºåˆ—åŒ–                                           â”‚ 4. ååºåˆ—åŒ–  
         â–¼                                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    2. ç½‘ç»œä¼ è¾“    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Protobufå­—èŠ‚æµ   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚ ç½‘ç»œæ•°æ®åŒ…       â”‚    â”‚ Goå¯¹è±¡          â”‚
â”‚ [0x08,0x01...]  â”‚                  â”‚                â”‚    â”‚ User{id:1,...}  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                                   â”‚
         â”‚ 3. HTTP/2ä¼ è¾“                                      â”‚ 5. ä¸šåŠ¡å¤„ç†
         â–¼                                                   â–¼
     ç½‘ç»œå‘é€                                           å¤„ç†ä¸šåŠ¡é€»è¾‘
```

### 5.3 å®¢æˆ·ç«¯åºåˆ—åŒ–è¿‡ç¨‹è¯¦è§£


**ç¬¬ä¸€æ­¥ï¼šå®šä¹‰Protoæ¶ˆæ¯**
```protobuf
syntax = "proto3";

message User {
    int32 id = 1;
    string name = 2;
    int32 age = 3;
    repeated string hobbies = 4;
}
```

**ç¬¬äºŒæ­¥ï¼šå®¢æˆ·ç«¯åˆ›å»ºå¯¹è±¡å¹¶åºåˆ—åŒ–**
```go
// 1. åˆ›å»ºGoå¯¹è±¡
user := &pb.User{
    Id:      1,
    Name:    "å¼ ä¸‰", 
    Age:     25,
    Hobbies: []string{"è¯»ä¹¦", "æ¸¸æ³³"},
}

// 2. gRPCè‡ªåŠ¨è°ƒç”¨protobufåºåˆ—åŒ–
// å†…éƒ¨å¤§æ¦‚æ˜¯è¿™æ ·çš„è¿‡ç¨‹ï¼š
data, err := proto.Marshal(user)  // åºåˆ—åŒ–ä¸ºå­—èŠ‚æµ
if err != nil {
    log.Fatal("åºåˆ—åŒ–å¤±è´¥:", err)
}

// 3. é€šè¿‡ç½‘ç»œå‘é€
response, err := client.CreateUser(ctx, user) // gRPCè‡ªåŠ¨å¤„ç†åºåˆ—åŒ–
```

**åºåˆ—åŒ–åçš„å­—èŠ‚æµç»“æ„**ï¼š
```
åŸå§‹æ•°æ®ï¼šUser{id: 1, name: "å¼ ä¸‰", age: 25, hobbies: ["è¯»ä¹¦", "æ¸¸æ³³"]}

åºåˆ—åŒ–åçš„å­—èŠ‚æµï¼ˆåå…­è¿›åˆ¶ï¼‰ï¼š
08 01          // idå­—æ®µï¼štag=1, value=1  
12 06 E5 BC A0 E4 B8 89  // nameå­—æ®µï¼štag=2, value="å¼ ä¸‰"(UTF-8)
18 19          // ageå­—æ®µï¼štag=3, value=25
22 06 E8 AF BB E4 B9 A6  // hobbies[0]ï¼štag=4, value="è¯»ä¹¦"  
22 06 E6 B8 B8 E6 B3 B3  // hobbies[1]ï¼štag=4, value="æ¸¸æ³³"
```

### 5.4 æœåŠ¡ç«¯ååºåˆ—åŒ–è¿‡ç¨‹è¯¦è§£


```go
func (s *server) CreateUser(ctx context.Context, req *pb.User) (*pb.UserResponse, error) {
    // 1. gRPCæ¡†æ¶è‡ªåŠ¨ååºåˆ—åŒ–
    // æ”¶åˆ°çš„reqå·²ç»æ˜¯ååºåˆ—åŒ–åçš„Goå¯¹è±¡äº†
    
    // 2. ç›´æ¥ä½¿ç”¨å¯¹è±¡å±æ€§
    fmt.Printf("ç”¨æˆ·ID: %d\n", req.Id)
    fmt.Printf("ç”¨æˆ·å§“å: %s\n", req.Name)  
    fmt.Printf("ç”¨æˆ·å¹´é¾„: %d\n", req.Age)
    
    // 3. å¤„ç†æ•°ç»„å­—æ®µ
    for i, hobby := range req.Hobbies {
        fmt.Printf("çˆ±å¥½%d: %s\n", i+1, hobby)
    }
    
    // 4. è¿”å›å“åº”ï¼ˆä¼šå†æ¬¡åºåˆ—åŒ–ï¼‰
    return &pb.UserResponse{
        Success: true,
        Message: "ç”¨æˆ·åˆ›å»ºæˆåŠŸ",
    }, nil
}
```

**ååºåˆ—åŒ–çš„å†…éƒ¨è¿‡ç¨‹**ï¼š
```go
// gRPCæ¡†æ¶å†…éƒ¨å¤§æ¦‚åšäº†è¿™äº›äº‹ï¼š
func deserializeRequest(data []byte) (*pb.User, error) {
    user := &pb.User{}
    
    // ä½¿ç”¨protobufè§£ç å™¨
    err := proto.Unmarshal(data, user)
    if err != nil {
        return nil, err
    }
    
    return user, nil
}
```

---

## 6. ğŸ“‹ Protobufç¼–è§£ç è¿‡ç¨‹è¯¦è§£


### 6.1 Protobufç¼–ç åŸç†


**æ ¸å¿ƒæ¦‚å¿µï¼šTag-Length-Value (TLV) ç»“æ„**

> ğŸ’¡ **ç®€å•ç†è§£**ï¼šæ¯ä¸ªå­—æ®µéƒ½æŒ‰ç…§"æ ‡ç­¾-é•¿åº¦-å€¼"çš„æ ¼å¼å­˜å‚¨

```
åŸºæœ¬ç¼–ç æ ¼å¼ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Tag    â”‚ Length  â”‚  Value  â”‚
â”‚ (å­—æ®µå·) â”‚ (é•¿åº¦)   â”‚ (å€¼)    â”‚  
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å®é™…ä¾‹å­ï¼š
å­—æ®µ: int32 id = 1;  å€¼: 123

ç¼–ç ç»“æœ:
08 7B
â”‚  â”‚
â”‚  â””â”€ Value: 123 (åè¿›åˆ¶) = 7B (åå…­è¿›åˆ¶)
â””â”€ Tag: å­—æ®µå·1 + ç±»å‹æ ‡è¯† = 08
```

### 6.2 ä¸åŒæ•°æ®ç±»å‹çš„ç¼–ç æ–¹å¼


**æ•´æ•°ç±»å‹ç¼–ç **ï¼š
```go
// Protoå®šä¹‰
message Example {
    int32 number = 1;     // å°æ•´æ•°
    int64 big_number = 2; // å¤§æ•´æ•°
}

// ç¼–ç ç¤ºä¾‹
number: 150 â†’ ç¼–ç ä¸º: 08 96 01
  08: tag (å­—æ®µ1, varintç±»å‹)
  96 01: 150çš„varintç¼–ç 

big_number: 1000000 â†’ ç¼–ç ä¸º: 10 C0 84 3D  
  10: tag (å­—æ®µ2, varintç±»å‹)
  C0 84 3D: 1000000çš„varintç¼–ç 
```

**å­—ç¬¦ä¸²ç±»å‹ç¼–ç **ï¼š
```go
// Protoå®šä¹‰  
message Example {
    string name = 1;
}

// ç¼–ç ç¤ºä¾‹
name: "hello" â†’ ç¼–ç ä¸º: 0A 05 68 65 6C 6C 6F
  0A: tag (å­—æ®µ1, length-delimitedç±»å‹)
  05: å­—ç¬¦ä¸²é•¿åº¦5
  68 65 6C 6C 6F: "hello"çš„UTF-8ç¼–ç 
```

### 6.3 å¤æ‚ç±»å‹çš„ç¼–ç 


**æ•°ç»„/repeatedå­—æ®µ**ï¼š
```go
// Protoå®šä¹‰
message Example {
    repeated string items = 1;
}

// ç¼–ç ç¤ºä¾‹  
items: ["a", "b"] â†’ ç¼–ç ä¸º: 0A 01 61 0A 01 62
  0A 01 61: ç¬¬ä¸€ä¸ªå…ƒç´ "a"
  0A 01 62: ç¬¬äºŒä¸ªå…ƒç´ "b"
  (æ¯ä¸ªå…ƒç´ ç‹¬ç«‹ç¼–ç )
```

**åµŒå¥—æ¶ˆæ¯**ï¼š
```go
// Protoå®šä¹‰
message Address {
    string city = 1;
    string street = 2;
}

message Person {
    string name = 1;
    Address address = 2;
}

// ç¼–ç ç¤ºä¾‹
person: {
  name: "å¼ ä¸‰",
  address: {city: "åŒ—äº¬", street: "é•¿å®‰è¡—"}
}

ç¼–ç ç»“æœï¼š
0A 06 E5 BC A0 E4 B8 89  // nameå­—æ®µ
12 0E                    // addresså­—æ®µå¼€å§‹ï¼ˆé•¿åº¦14å­—èŠ‚ï¼‰
  0A 06 E5 8C 97 E4 BA AC  // city: "åŒ—äº¬"  
  12 09 E9 95 BF E5 AE 89 E8 A1 97  // street: "é•¿å®‰è¡—"
```

### 6.4 è§£ç è¿‡ç¨‹è¯¦è§£


**è§£ç æ­¥éª¤**ï¼š
```go
func decodeProtobuf(data []byte) (*pb.User, error) {
    user := &pb.User{}
    
    // 1. åˆ›å»ºè§£ç å™¨
    reader := bytes.NewReader(data)
    
    // 2. é€ä¸ªè¯»å–å­—æ®µ
    for reader.Len() > 0 {
        // è¯»å–tag
        tag, err := readVarint(reader)
        if err != nil {
            return nil, err
        }
        
        // è§£æå­—æ®µå·å’Œç±»å‹
        fieldNumber := tag >> 3  // å³ç§»3ä½å¾—åˆ°å­—æ®µå·
        wireType := tag & 0x7    // ä½3ä½æ˜¯ç±»å‹
        
        // 3. æ ¹æ®ç±»å‹è§£ç å€¼
        switch fieldNumber {
        case 1: // idå­—æ®µ
            if wireType == 0 { // varintç±»å‹
                value, err := readVarint(reader)
                user.Id = int32(value)
            }
        case 2: // nameå­—æ®µ  
            if wireType == 2 { // length-delimitedç±»å‹
                length, _ := readVarint(reader)
                nameBytes := make([]byte, length)
                reader.Read(nameBytes)
                user.Name = string(nameBytes)
            }
        }
    }
    
    return user, nil
}
```

### 6.5 ç¼–è§£ç æ€§èƒ½ç‰¹ç‚¹


**Protobufçš„ä¼˜åŠ¿**ï¼š

| ç‰¹æ€§ | Protobuf | JSON | XML |
|------|----------|------|-----|
| **æ•°æ®å¤§å°** | ğŸŸ¢ `å¾ˆå°(äºŒè¿›åˆ¶)` | ğŸŸ¡ `ä¸­ç­‰(æ–‡æœ¬)` | ğŸ”´ `è¾ƒå¤§(æ ‡ç­¾å¤š)` |
| **è§£æé€Ÿåº¦** | ğŸŸ¢ `å¾ˆå¿«` | ğŸŸ¡ `è¾ƒå¿«` | ğŸ”´ `è¾ƒæ…¢` |
| **å¯è¯»æ€§** | ğŸ”´ `ä¸å¯è¯»` | ğŸŸ¢ `æ˜“è¯»` | ğŸŸ¢ `æ˜“è¯»` |
| **å‘åå…¼å®¹** | ğŸŸ¢ `ä¼˜ç§€` | ğŸŸ¡ `ä¸€èˆ¬` | ğŸŸ¡ `ä¸€èˆ¬` |

**å®é™…æ€§èƒ½å¯¹æ¯”**ï¼š
```go
// åŒæ ·çš„æ•°æ®åºåˆ—åŒ–åçš„å¤§å°å¯¹æ¯”
ç”¨æˆ·ä¿¡æ¯: {id: 12345, name: "å¼ ä¸‰", email: "zhangsan@example.com"}

Protobuf: 28 å­—èŠ‚
JSON:     67 å­—èŠ‚  
XML:      156 å­—èŠ‚

å‹ç¼©æ¯”: Protobufæ¯”JSONå°58%ï¼Œæ¯”XMLå°82%
```

---

## 7. ğŸ—ï¸ å­—æ®µç±»å‹æ”¯æŒä¸æœ€ä½³å®è·µ


### 7.1 åŸºç¡€å­—æ®µç±»å‹è¯¦è§£


**æ•°å€¼ç±»å‹æ”¯æŒ**ï¼š
```protobuf
message NumberTypes {
    // æ•´æ•°ç±»å‹
    int32 small_int = 1;      // 32ä½æœ‰ç¬¦å·æ•´æ•° (-2^31 åˆ° 2^31-1)
    int64 big_int = 2;        // 64ä½æœ‰ç¬¦å·æ•´æ•°
    uint32 positive_int = 3;  // 32ä½æ— ç¬¦å·æ•´æ•° (0 åˆ° 2^32-1)
    uint64 big_positive = 4;  // 64ä½æ— ç¬¦å·æ•´æ•°
    
    // æµ®ç‚¹ç±»å‹
    float price = 5;          // 32ä½æµ®ç‚¹æ•°
    double precise_value = 6; // 64ä½æµ®ç‚¹æ•°
    
    // å¸ƒå°”ç±»å‹
    bool is_active = 7;       // true/false
}
```

**å­—ç¬¦ä¸²å’Œå­—èŠ‚ç±»å‹**ï¼š
```protobuf
message TextTypes {
    string name = 1;          // UTF-8å­—ç¬¦ä¸²
    bytes file_data = 2;      // äºŒè¿›åˆ¶æ•°æ®
    string description = 3;   // æ”¯æŒä»»æ„é•¿åº¦çš„æ–‡æœ¬
}
```

### 7.2 åµŒå¥—æ¶ˆæ¯è¯¦è§£


**å®šä¹‰åµŒå¥—ç»“æ„**ï¼š
```protobuf
// åœ°å€ä¿¡æ¯
message Address {
    string country = 1;
    string province = 2;
    string city = 3;
    string street = 4;
    string postal_code = 5;
}

// ç”¨æˆ·ä¿¡æ¯ï¼ˆåŒ…å«åœ°å€ï¼‰
message User {
    int32 id = 1;
    string name = 2;
    Address home_address = 3;    // åµŒå¥—æ¶ˆæ¯
    Address work_address = 4;    // å¯ä»¥æœ‰å¤šä¸ªç›¸åŒç±»å‹çš„åµŒå¥—
}
```

**ä½¿ç”¨åµŒå¥—æ¶ˆæ¯**ï¼š
```go
// åˆ›å»ºåµŒå¥—å¯¹è±¡
user := &pb.User{
    Id:   1,
    Name: "å¼ ä¸‰",
    HomeAddress: &pb.Address{
        Country:    "ä¸­å›½",
        Province:   "åŒ—äº¬å¸‚", 
        City:       "åŒ—äº¬å¸‚",
        Street:     "é•¿å®‰è¡—1å·",
        PostalCode: "100000",
    },
    WorkAddress: &pb.Address{
        Country:  "ä¸­å›½",
        Province: "åŒ—äº¬å¸‚",
        City:     "åŒ—äº¬å¸‚", 
        Street:   "ä¸­å…³æ‘å¤§è¡—2å·",
        PostalCode: "100080",
    },
}

// è®¿é—®åµŒå¥—å­—æ®µ
fmt.Printf("å®¶åº­åœ°å€: %s %s %s\n", 
    user.HomeAddress.Province,
    user.HomeAddress.City,
    user.HomeAddress.Street)
```

### 7.3 æ•°ç»„(repeated)å­—æ®µè¯¦è§£


**åŸºç¡€æ•°ç»„ç±»å‹**ï¼š
```protobuf
message ArrayExample {
    repeated string hobbies = 1;        // å­—ç¬¦ä¸²æ•°ç»„
    repeated int32 scores = 2;          // æ•´æ•°æ•°ç»„
    repeated Address addresses = 3;     // å¯¹è±¡æ•°ç»„
}
```

**ä½¿ç”¨æ•°ç»„å­—æ®µ**ï¼š
```go
// åˆ›å»ºå¸¦æ•°ç»„çš„å¯¹è±¡
example := &pb.ArrayExample{
    Hobbies: []string{"è¯»ä¹¦", "æ¸¸æ³³", "è·‘æ­¥"},
    Scores:  []int32{85, 92, 78, 96},
    Addresses: []*pb.Address{
        {City: "åŒ—äº¬", Street: "é•¿å®‰è¡—"},
        {City: "ä¸Šæµ·", Street: "å—äº¬è·¯"},
    },
}

// éå†æ•°ç»„
for i, hobby := range example.Hobbies {
    fmt.Printf("çˆ±å¥½%d: %s\n", i+1, hobby)
}

for _, addr := range example.Addresses {
    fmt.Printf("åœ°å€: %s %s\n", addr.City, addr.Street)
}

// æ·»åŠ æ–°å…ƒç´ 
example.Hobbies = append(example.Hobbies, "æ‘„å½±")
example.Scores = append(example.Scores, 88)
```

### 7.4 Mapå­—æ®µè¯¦è§£


**Mapå­—æ®µå®šä¹‰**ï¼š
```protobuf
message MapExample {
    map<string, string> properties = 1;      // å­—ç¬¦ä¸²åˆ°å­—ç¬¦ä¸²çš„æ˜ å°„
    map<int32, string> id_to_name = 2;       // æ•´æ•°åˆ°å­—ç¬¦ä¸²çš„æ˜ å°„  
    map<string, Address> locations = 3;      // å­—ç¬¦ä¸²åˆ°å¯¹è±¡çš„æ˜ å°„
    map<string, int32> scores_by_subject = 4; // å­¦ç§‘æˆç»©æ˜ å°„
}
```

**ä½¿ç”¨Mapå­—æ®µ**ï¼š
```go
// åˆ›å»ºå¸¦Mapçš„å¯¹è±¡
example := &pb.MapExample{
    Properties: map[string]string{
        "color":  "çº¢è‰²",
        "size":   "å¤§å·", 
        "brand":  "è‹¹æœ",
        "model":  "iPhone15",
    },
    IdToName: map[int32]string{
        1001: "å¼ ä¸‰",
        1002: "æå››",
        1003: "ç‹äº”",
    },
    Locations: map[string]*pb.Address{
        "home": {City: "åŒ—äº¬", Street: "é•¿å®‰è¡—"},
        "work": {City: "åŒ—äº¬", Street: "ä¸­å…³æ‘"},
    },
    ScoresBySubject: map[string]int32{
        "æ•°å­¦": 95,
        "è‹±è¯­": 87,
        "ç‰©ç†": 92,
    },
}

// è®¿é—®Mapå…ƒç´ 
color := example.Properties["color"]
name := example.IdToName[1001]
homeAddr := example.Locations["home"]
mathScore := example.ScoresBySubject["æ•°å­¦"]

// æ£€æŸ¥keyæ˜¯å¦å­˜åœ¨
if score, exists := example.ScoresBySubject["åŒ–å­¦"]; exists {
    fmt.Printf("åŒ–å­¦æˆç»©: %d\n", score)
} else {
    fmt.Println("æ²¡æœ‰åŒ–å­¦æˆç»©")
}

// æ·»åŠ æ–°çš„æ˜ å°„
example.Properties["weight"] = "è½»é‡"
example.ScoresBySubject["åŒ–å­¦"] = 89
```

### 7.5 å­—æ®µç±»å‹æœ€ä½³å®è·µ


**ç±»å‹é€‰æ‹©å»ºè®®**ï¼š

| ä½¿ç”¨åœºæ™¯ | æ¨èç±»å‹ | åŸå›  |
|---------|----------|------|
| **ç”¨æˆ·ID** | `int64` | `é¿å…IDç”¨å®Œï¼Œæ”¯æŒå¤§æ•°å€¼` |
| **é‡‘é¢** | `int64` | `é¿å…æµ®ç‚¹ç²¾åº¦é—®é¢˜ï¼Œå­˜å‚¨åˆ†ä¸ºå•ä½` |
| **æ—¶é—´æˆ³** | `int64` | `Unixæ—¶é—´æˆ³ï¼Œç²¾ç¡®åˆ°ç§’æˆ–æ¯«ç§’` |
| **ç™¾åˆ†æ¯”** | `float` | `0.0-1.0 è¡¨ç¤º 0%-100%` |
| **çŠ¶æ€ç ** | `int32` | `HTTPçŠ¶æ€ç ç­‰æšä¸¾å€¼` |
| **æ–‡ä»¶å†…å®¹** | `bytes` | `äºŒè¿›åˆ¶æ•°æ®ï¼Œå¦‚å›¾ç‰‡ã€æ–‡æ¡£` |
| **é…ç½®é¡¹** | `map<string,string>` | `çµæ´»çš„é”®å€¼å¯¹é…ç½®` |

**å¸¸è§é”™è¯¯é¿å…**ï¼š
```protobuf
// âŒ é”™è¯¯ç¤ºä¾‹
message BadExample {
    float money = 1;           // æµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜
    string user_id = 2;        // å­—ç¬¦ä¸²ç±»å‹çš„IDæ•ˆç‡ä½  
    repeated string config = 3; // ç”¨æ•°ç»„å­˜å‚¨é…ç½®ä¸å¤Ÿçµæ´»
}

// âœ… æ­£ç¡®ç¤ºä¾‹  
message GoodExample {
    int64 money_cents = 1;               // ç”¨åˆ†ä¸ºå•ä½å­˜å‚¨é‡‘é¢
    int64 user_id = 2;                   // æ•°å€¼å‹ID
    map<string, string> config = 3;      // é”®å€¼å¯¹é…ç½®
}
```

**å­—æ®µéªŒè¯å»ºè®®**ï¼š
```go
// åœ¨ä¸šåŠ¡é€»è¾‘ä¸­æ·»åŠ éªŒè¯
func validateUser(user *pb.User) error {
    // æ£€æŸ¥å¿…å¡«å­—æ®µ
    if user.Id <= 0 {
        return errors.New("ç”¨æˆ·IDå¿…é¡»å¤§äº0")
    }
    
    if len(user.Name) == 0 {
        return errors.New("ç”¨æˆ·åä¸èƒ½ä¸ºç©º")
    }
    
    // æ£€æŸ¥å­—ç¬¦ä¸²é•¿åº¦
    if len(user.Name) > 50 {
        return errors.New("ç”¨æˆ·åé•¿åº¦ä¸èƒ½è¶…è¿‡50ä¸ªå­—ç¬¦")
    }
    
    // æ£€æŸ¥æ•°ç»„å¤§å°
    if len(user.Hobbies) > 10 {
        return errors.New("çˆ±å¥½æ•°é‡ä¸èƒ½è¶…è¿‡10ä¸ª")
    }
    
    return nil
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Metadataæœ¬è´¨ï¼šç±»ä¼¼HTTP Headerçš„é”®å€¼å¯¹æ•°æ®ä¼ é€’æœºåˆ¶
ğŸ”¸ ä¼ é€’æ–¹å‘ï¼šå®¢æˆ·ç«¯â†’æœåŠ¡ç«¯ï¼ˆè¯·æ±‚metadataï¼‰ã€æœåŠ¡ç«¯â†’å®¢æˆ·ç«¯ï¼ˆå“åº”metadataï¼‰  
ğŸ”¸ Binary Metadataï¼škeyä»¥"-bin"ç»“å°¾ï¼Œç”¨äºä¼ é€’äºŒè¿›åˆ¶æ•°æ®
ğŸ”¸ åºåˆ—åŒ–æµç¨‹ï¼šGoå¯¹è±¡ â†’ Protobufå­—èŠ‚æµ â†’ ç½‘ç»œä¼ è¾“ â†’ ååºåˆ—åŒ–
ğŸ”¸ ç¼–ç åŸç†ï¼šTag-Length-Valueç»“æ„ï¼Œç´§å‡‘çš„äºŒè¿›åˆ¶æ ¼å¼
ğŸ”¸ å­—æ®µç±»å‹ï¼šåŸºç¡€ç±»å‹ã€åµŒå¥—æ¶ˆæ¯ã€æ•°ç»„(repeated)ã€æ˜ å°„(map)
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ Metadata vs ä¸šåŠ¡æ•°æ®**
```
ç†è§£è¦ç‚¹ï¼š
- Metadataï¼šä¼ é€’æ§åˆ¶ä¿¡æ¯ã€è®¤è¯ä¿¡æ¯ã€è¿½è¸ªä¿¡æ¯ç­‰
- ä¸šåŠ¡æ•°æ®ï¼šä¼ é€’æ ¸å¿ƒçš„ä¸šåŠ¡é€»è¾‘æ•°æ®
- åˆ†ç¦»åŸåˆ™ï¼šä¸è¦æŠŠä¸šåŠ¡æ•°æ®æ”¾åœ¨metadataä¸­
```

**ğŸ”¹ åºåˆ—åŒ–çš„ä»·å€¼**
```
æ€§èƒ½ä¼˜åŠ¿ï¼š
- æ•°æ®ä½“ç§¯å°ï¼šæ¯”JSONå°50-80%
- è§£æé€Ÿåº¦å¿«ï¼šäºŒè¿›åˆ¶æ ¼å¼ï¼Œæ— éœ€æ–‡æœ¬è§£æ
- ç±»å‹å®‰å…¨ï¼šç¼–è¯‘æ—¶æ£€æŸ¥ï¼Œè¿è¡Œæ—¶é«˜æ•ˆ
- å‘åå…¼å®¹ï¼šå­—æ®µæ–°å¢ä¸å½±å“æ—§ç‰ˆæœ¬
```

**ğŸ”¹ å­—æ®µè®¾è®¡åŸåˆ™**
```
è®¾è®¡å»ºè®®ï¼š
- é€‰æ‹©åˆé€‚çš„æ•°æ®ç±»å‹ï¼ˆé¿å…æµ®ç‚¹æ•°å­˜å‚¨é‡‘é¢ï¼‰
- åˆç†ä½¿ç”¨åµŒå¥—ï¼ˆä¸è¦è¿‡åº¦åµŒå¥—ï¼‰
- æ•°ç»„å¤§å°æ§åˆ¶ï¼ˆé¿å…ä¼ è¾“è¿‡å¤§æ•°ç»„ï¼‰
- Mapé€‚åˆé…ç½®é¡¹ï¼ˆçµæ´»çš„é”®å€¼å¯¹ï¼‰
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


**Metadataä½¿ç”¨åœºæ™¯**ï¼š
- âœ… **èº«ä»½è®¤è¯**ï¼šJWT tokenã€API key
- âœ… **è¯·æ±‚è¿½è¸ª**ï¼štrace-idã€span-id  
- âœ… **ç‰ˆæœ¬æ§åˆ¶**ï¼šAPIç‰ˆæœ¬ã€å®¢æˆ·ç«¯ç‰ˆæœ¬
- âœ… **ç¯å¢ƒä¿¡æ¯**ï¼šå®¢æˆ·ç«¯IPã€ç”¨æˆ·ä»£ç†
- âŒ **ä¸šåŠ¡æ•°æ®**ï¼šä¸è¦æŠŠä¸šåŠ¡é€»è¾‘æ•°æ®æ”¾åœ¨metadata

**åºåˆ—åŒ–ä¼˜åŒ–å»ºè®®**ï¼š
- ğŸ¯ **å­—æ®µé¡ºåº**ï¼šå¸¸ç”¨å­—æ®µæ”¾åœ¨å‰é¢ï¼ˆæ›´å¥½çš„ç¼“å­˜æ•ˆæœï¼‰
- ğŸ¯ **æ•°æ®ç±»å‹**ï¼šé€‰æ‹©æœ€åˆé€‚çš„ç±»å‹ï¼ˆint32 vs int64ï¼‰
- ğŸ¯ **åµŒå¥—æ·±åº¦**ï¼šæ§åˆ¶åœ¨3å±‚ä»¥å†…
- ğŸ¯ **æ•°ç»„å¤§å°**ï¼šå•æ¬¡ä¼ è¾“é¿å…è¶…å¤§æ•°ç»„

**æ ¸å¿ƒè®°å¿†**ï¼š
- MetadataåƒHTTPå¤´éƒ¨ï¼Œä¼ é€’æ§åˆ¶ä¿¡æ¯ä¸ä¼ ä¸šåŠ¡æ•°æ®
- Protobufåºåˆ—åŒ–ä½“ç§¯å°é€Ÿåº¦å¿«ï¼ŒäºŒè¿›åˆ¶æ ¼å¼æ•ˆç‡é«˜
- å­—æ®µç±»å‹é€‰æ‹©è¦åˆç†ï¼Œé¿å…ç²¾åº¦å’Œæ€§èƒ½é—®é¢˜
- åµŒå¥—å’Œæ•°ç»„é€‚åº¦ä½¿ç”¨ï¼Œè¿‡åº¦å¤æ‚å½±å“æ€§èƒ½