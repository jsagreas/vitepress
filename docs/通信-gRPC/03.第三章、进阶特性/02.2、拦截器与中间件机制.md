---
title: 2ã€æ‹¦æˆªå™¨ä¸ä¸­é—´ä»¶æœºåˆ¶
---
## ğŸ“š ç›®å½•

1. [æ‹¦æˆªå™¨åŸºæœ¬æ¦‚å¿µ](#1-æ‹¦æˆªå™¨åŸºæœ¬æ¦‚å¿µ)
2. [ä¸€å…ƒæ‹¦æˆªå™¨è¯¦è§£](#2-ä¸€å…ƒæ‹¦æˆªå™¨è¯¦è§£)
3. [æµæ‹¦æˆªå™¨æœºåˆ¶](#3-æµæ‹¦æˆªå™¨æœºåˆ¶)
4. [æœåŠ¡ç«¯æ‹¦æˆªå™¨å®ç°](#4-æœåŠ¡ç«¯æ‹¦æˆªå™¨å®ç°)
5. [å®¢æˆ·ç«¯æ‹¦æˆªå™¨å®ç°](#5-å®¢æˆ·ç«¯æ‹¦æˆªå™¨å®ç°)
6. [æ‹¦æˆªå™¨é“¾å¼å¤„ç†](#6-æ‹¦æˆªå™¨é“¾å¼å¤„ç†)
7. [å®é™…åº”ç”¨åœºæ™¯](#7-å®é™…åº”ç”¨åœºæ™¯)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ æ‹¦æˆªå™¨åŸºæœ¬æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯æ‹¦æˆªå™¨


**ğŸ’¡ ç®€å•ç†è§£**ï¼šæ‹¦æˆªå™¨å°±åƒæ˜¯**é—¨å«å’Œç®¡å®¶**çš„ç»„åˆ
- **é—¨å«èŒè´£**ï¼šåœ¨è¯·æ±‚è¿›å…¥æœåŠ¡å‰è¿›è¡Œæ£€æŸ¥ï¼ˆè®¤è¯ã€æˆæƒï¼‰
- **ç®¡å®¶èŒè´£**ï¼šåœ¨å¤„ç†è¿‡ç¨‹ä¸­æä¾›æœåŠ¡ï¼ˆæ—¥å¿—ã€ç›‘æ§ï¼‰

> ğŸ“– **æ¦‚å¿µè§£é‡Š**ï¼šæ‹¦æˆªå™¨æ˜¯ä¸€ç§**ä¸­é—´ä»¶æœºåˆ¶**ï¼Œå…è®¸ä½ åœ¨gRPCè°ƒç”¨çš„**å‰å**æ’å…¥è‡ªå®šä¹‰é€»è¾‘ï¼Œå°±åƒåœ¨çœŸå®ä¸šåŠ¡å¤„ç†çš„å¤–é¢åŒ…äº†ä¸€å±‚"ä¿æŠ¤å£³"ã€‚

### 1.2 æ‹¦æˆªå™¨çš„å·¥ä½œåŸç†


```
æ™®é€šgRPCè°ƒç”¨æµç¨‹ï¼š
å®¢æˆ·ç«¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º æœåŠ¡ç«¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º ä¸šåŠ¡é€»è¾‘

ä½¿ç”¨æ‹¦æˆªå™¨çš„è°ƒç”¨æµç¨‹ï¼š
å®¢æˆ·ç«¯ â”€â”€â–º å®¢æˆ·ç«¯æ‹¦æˆªå™¨ â”€â”€â–º ç½‘ç»œä¼ è¾“ â”€â”€â–º æœåŠ¡ç«¯æ‹¦æˆªå™¨ â”€â”€â–º ä¸šåŠ¡é€»è¾‘
       â—„â”€â”€ å®¢æˆ·ç«¯æ‹¦æˆªå™¨ â—„â”€â”€ ç½‘ç»œä¼ è¾“ â—„â”€â”€ æœåŠ¡ç«¯æ‹¦æˆªå™¨ â—„â”€â”€ ä¸šåŠ¡é€»è¾‘
```

**ğŸ”§ æ ¸å¿ƒä½œç”¨**ï¼š
- âœ… **è¯·æ±‚é¢„å¤„ç†**ï¼šåœ¨ä¸šåŠ¡é€»è¾‘æ‰§è¡Œå‰åšå‡†å¤‡å·¥ä½œ
- âœ… **å“åº”åå¤„ç†**ï¼šåœ¨ç»“æœè¿”å›å‰åšæ¸…ç†æˆ–è®°å½•å·¥ä½œ
- âœ… **æ¨ªåˆ‡å…³æ³¨ç‚¹**ï¼šç»Ÿä¸€å¤„ç†æ—¥å¿—ã€è®¤è¯ã€ç›‘æ§ç­‰é€šç”¨éœ€æ±‚

### 1.3 ç±»æ¯”HTTPä¸­é—´ä»¶


å¦‚æœä½ äº†è§£Webå¼€å‘ï¼ŒgRPCæ‹¦æˆªå™¨å°±åƒHTTPæ¡†æ¶ä¸­çš„**ä¸­é—´ä»¶**ï¼š

| **æ¦‚å¿µå¯¹æ¯”** | **HTTPä¸­é—´ä»¶** | **gRPCæ‹¦æˆªå™¨** |
|-------------|---------------|---------------|
| **ä½œç”¨ä½ç½®** | HTTPè¯·æ±‚/å“åº”å¤„ç†é“¾ | gRPCè°ƒç”¨å¤„ç†é“¾ |
| **å…¸å‹ç”¨é€”** | è®¤è¯ã€æ—¥å¿—ã€CORS | è®¤è¯ã€æ—¥å¿—ã€ç›‘æ§ |
| **æ‰§è¡Œæ—¶æœº** | è¯·æ±‚å‰å | è°ƒç”¨å‰å |
| **é“¾å¼å¤„ç†** | æ”¯æŒ | æ”¯æŒ |

---

## 2. âš¡ ä¸€å…ƒæ‹¦æˆªå™¨è¯¦è§£


### 2.1 ä»€ä¹ˆæ˜¯ä¸€å…ƒæ‹¦æˆªå™¨


> ğŸ’¡ **UnaryInterceptorï¼ˆä¸€å…ƒæ‹¦æˆªå™¨ï¼‰**ï¼šä¸“é—¨å¤„ç†**ä¸€æ¥ä¸€å›**çš„ç®€å•è°ƒç”¨ï¼Œå°±åƒæ™®é€šçš„å‡½æ•°è°ƒç”¨ä¸€æ ·ã€‚

**ğŸ“ é€‚ç”¨åœºæ™¯**ï¼š
- æ™®é€šçš„è¯·æ±‚-å“åº”æ¨¡å¼
- å¤§éƒ¨åˆ†å¸¸è§çš„gRPCè°ƒç”¨
- ä¸æ¶‰åŠæµå¼ä¼ è¾“çš„åœºæ™¯

### 2.2 ä¸€å…ƒæ‹¦æˆªå™¨çš„ç»“æ„


```go
// ä¸€å…ƒæ‹¦æˆªå™¨çš„æ ‡å‡†ç­¾å
type UnaryClientInterceptor func(
    ctx context.Context,           // ä¸Šä¸‹æ–‡
    method string,                 // è°ƒç”¨çš„æ–¹æ³•å
    req interface{},              // è¯·æ±‚å‚æ•°
    reply interface{},            // å“åº”ç»“æœ
    cc *ClientConn,               // å®¢æˆ·ç«¯è¿æ¥
    invoker UnaryInvoker,         // çœŸæ­£çš„è°ƒç”¨å‡½æ•°
    opts ...CallOption,           // è°ƒç”¨é€‰é¡¹
) error
```

**ğŸ” å‚æ•°è§£é‡Š**ï¼š
- `ctx`ï¼šæ§åˆ¶è¶…æ—¶ã€å–æ¶ˆç­‰
- `method`ï¼šå‘Šè¯‰ä½ è°ƒç”¨çš„æ˜¯å“ªä¸ªæœåŠ¡æ–¹æ³•
- `req/reply`ï¼šè¯·æ±‚å’Œå“åº”çš„æ•°æ®
- `invoker`ï¼šçœŸæ­£æ‰§è¡Œä¸šåŠ¡é€»è¾‘çš„å‡½æ•°

### 2.3 ç®€å•ç¤ºä¾‹ç†è§£


```go
// ğŸ“ ç®€å•çš„æ—¥å¿—æ‹¦æˆªå™¨
func LoggingInterceptor(
    ctx context.Context,
    method string,
    req interface{},
    reply interface{},
    cc *grpc.ClientConn,
    invoker grpc.UnaryInvoker,
    opts ...grpc.CallOption,
) error {
    // â° è°ƒç”¨å‰ï¼šè®°å½•å¼€å§‹æ—¶é—´
    start := time.Now()
    fmt.Printf("å¼€å§‹è°ƒç”¨æ–¹æ³•: %s\n", method)
    
    // ğŸš€ æ‰§è¡ŒçœŸæ­£çš„gRPCè°ƒç”¨
    err := invoker(ctx, method, req, reply, cc, opts...)
    
    // â° è°ƒç”¨åï¼šè®°å½•è€—æ—¶
    duration := time.Since(start)
    fmt.Printf("æ–¹æ³• %s æ‰§è¡Œå®Œæˆï¼Œè€—æ—¶: %v\n", method, duration)
    
    return err
}
```

> ğŸ”§ **å…³é”®ç†è§£**ï¼š`invoker()` å°±æ˜¯çœŸæ­£çš„ä¸šåŠ¡é€»è¾‘ï¼Œæ‹¦æˆªå™¨åœ¨å®ƒå‰ååŠ äº†è‡ªå·±çš„å¤„ç†é€»è¾‘ã€‚

---

## 3. ğŸŒŠ æµæ‹¦æˆªå™¨æœºåˆ¶


### 3.1 ä»€ä¹ˆæ˜¯æµæ‹¦æˆªå™¨


> ğŸ’¡ **StreamInterceptorï¼ˆæµæ‹¦æˆªå™¨ï¼‰**ï¼šä¸“é—¨å¤„ç†**æµå¼ä¼ è¾“**çš„è°ƒç”¨ï¼Œå°±åƒå¤„ç†ä¸€æ¡æŒç»­æµåŠ¨çš„æ•°æ®æ²³æµã€‚

**ğŸ“Š æµçš„ç±»å‹**ï¼š
- **æœåŠ¡ç«¯æµ**ï¼šæœåŠ¡å™¨æŒç»­å‘é€æ•°æ®ç»™å®¢æˆ·ç«¯
- **å®¢æˆ·ç«¯æµ**ï¼šå®¢æˆ·ç«¯æŒç»­å‘é€æ•°æ®ç»™æœåŠ¡å™¨  
- **åŒå‘æµ**ï¼šåŒæ–¹éƒ½å¯ä»¥æŒç»­å‘é€æ•°æ®

### 3.2 æµæ‹¦æˆªå™¨çš„ç‰¹ç‚¹


```
ä¸€å…ƒè°ƒç”¨ï¼š     å®¢æˆ·ç«¯ â”€â”€[ä¸€æ¬¡è¯·æ±‚]â”€â”€â–º æœåŠ¡ç«¯ â”€â”€[ä¸€æ¬¡å“åº”]â”€â”€â–º å®¢æˆ·ç«¯

æµå¼è°ƒç”¨ï¼š     å®¢æˆ·ç«¯ â”€â”€[æŒç»­æ•°æ®æµ]â”€â”€â–º æœåŠ¡ç«¯
              å®¢æˆ·ç«¯ â—„â”€â”€[æŒç»­æ•°æ®æµ]â”€â”€â”€â”€ æœåŠ¡ç«¯
```

**ğŸ”§ å¤„ç†å·®å¼‚**ï¼š
- ä¸€å…ƒæ‹¦æˆªå™¨ï¼šå¤„ç†**å•æ¬¡**è°ƒç”¨
- æµæ‹¦æˆªå™¨ï¼šå¤„ç†**æŒç»­çš„**æ•°æ®æµ

### 3.3 æµæ‹¦æˆªå™¨ç¤ºä¾‹


```go
// ğŸ“ æµæ‹¦æˆªå™¨ç¤ºä¾‹
func StreamLoggingInterceptor(
    srv interface{},
    ss grpc.ServerStream,
    info *grpc.StreamServerInfo,
    handler grpc.StreamHandler,
) error {
    fmt.Printf("å¼€å§‹å¤„ç†æµæ–¹æ³•: %s\n", info.FullMethod)
    
    // ğŸŒŠ å¤„ç†æµå¼è°ƒç”¨
    err := handler(srv, ss)
    
    fmt.Printf("æµæ–¹æ³• %s å¤„ç†å®Œæˆ\n", info.FullMethod)
    return err
}
```

---

## 4. ğŸ–¥ï¸ æœåŠ¡ç«¯æ‹¦æˆªå™¨å®ç°


### 4.1 æœåŠ¡ç«¯æ‹¦æˆªå™¨çš„ä½œç”¨


**ğŸ’­ å½¢è±¡ç†è§£**ï¼šæœåŠ¡ç«¯æ‹¦æˆªå™¨å°±åƒ**é¤å…çš„æœåŠ¡å‘˜**
- å®¢äººï¼ˆå®¢æˆ·ç«¯è¯·æ±‚ï¼‰è¿›é—¨æ—¶è¦**æ¥å¾…**
- æŠŠéœ€æ±‚ä¼ ç»™**å¨å¸ˆ**ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰
- èœåšå¥½åè¦**ç«¯ç»™å®¢äºº**ï¼ˆè¿”å›å“åº”ï¼‰

### 4.2 æœåŠ¡ç«¯ä¸€å…ƒæ‹¦æˆªå™¨


```go
// ğŸ“ è®¤è¯æ‹¦æˆªå™¨ç¤ºä¾‹
func AuthInterceptor(
    ctx context.Context,
    req interface{},
    info *grpc.UnaryServerInfo,
    handler grpc.UnaryHandler,
) (interface{}, error) {
    // ğŸ” æ­¥éª¤1ï¼šæ£€æŸ¥è®¤è¯ä¿¡æ¯
    token := extractToken(ctx)
    if !isValidToken(token) {
        return nil, status.Error(codes.Unauthenticated, "æ— æ•ˆçš„è®¤è¯ä»¤ç‰Œ")
    }
    
    // âœ… æ­¥éª¤2ï¼šè®¤è¯é€šè¿‡ï¼Œæ‰§è¡Œä¸šåŠ¡é€»è¾‘
    fmt.Printf("ç”¨æˆ·è®¤è¯æˆåŠŸï¼Œè°ƒç”¨æ–¹æ³•: %s\n", info.FullMethod)
    return handler(ctx, req)
}

// ğŸš€ åœ¨æœåŠ¡ç«¯æ³¨å†Œæ‹¦æˆªå™¨
server := grpc.NewServer(
    grpc.UnaryInterceptor(AuthInterceptor),  // æ³¨å†Œæ‹¦æˆªå™¨
)
```

**ğŸ” å…³é”®ç‚¹è§£é‡Š**ï¼š
- `info.FullMethod`ï¼šå‘Šè¯‰ä½ å®¢æˆ·ç«¯è°ƒç”¨çš„å…·ä½“æ–¹æ³•
- `handler(ctx, req)`ï¼šè¿™é‡Œæ‰æ˜¯çœŸæ­£çš„ä¸šåŠ¡é€»è¾‘
- æ‹¦æˆªå™¨å¯ä»¥åœ¨ä¸šåŠ¡é€»è¾‘æ‰§è¡Œå‰**æ‹¦æˆªå’ŒéªŒè¯**

### 4.3 æœåŠ¡ç«¯æµæ‹¦æˆªå™¨


```go
// ğŸ“ ç›‘æ§æµæ‹¦æˆªå™¨
func MonitoringStreamInterceptor(
    srv interface{},
    ss grpc.ServerStream,
    info *grpc.StreamServerInfo,
    handler grpc.StreamHandler,
) error {
    // ğŸ“Š å¼€å§‹ç›‘æ§
    startTime := time.Now()
    activeStreams.Inc()  // å¢åŠ æ´»è·ƒæµè®¡æ•°
    
    // ğŸŒŠ æ‰§è¡Œæµå¤„ç†
    err := handler(srv, ss)
    
    // ğŸ“Š ç»“æŸç›‘æ§
    activeStreams.Dec()  // å‡å°‘æ´»è·ƒæµè®¡æ•°
    duration := time.Since(startTime)
    fmt.Printf("æµå¤„ç†å®Œæˆï¼Œè€—æ—¶: %v\n", duration)
    
    return err
}
```

---

## 5. ğŸ“± å®¢æˆ·ç«¯æ‹¦æˆªå™¨å®ç°


### 4.1 å®¢æˆ·ç«¯æ‹¦æˆªå™¨çš„ä½œç”¨


**ğŸ’­ å½¢è±¡ç†è§£**ï¼šå®¢æˆ·ç«¯æ‹¦æˆªå™¨å°±åƒ**ä¸ªäººåŠ©ç†**
- åœ¨ä½ æ‰“ç”µè¯å‰**å‡†å¤‡å¥½èµ„æ–™**ï¼ˆæ·»åŠ è®¤è¯ä¿¡æ¯ï¼‰
- åœ¨é€šè¯è¿‡ç¨‹ä¸­**è®°å½•è¦ç‚¹**ï¼ˆæ—¥å¿—è®°å½•ï¼‰
- é€šè¯ç»“æŸå**æ•´ç†ç»“æœ**ï¼ˆé”™è¯¯å¤„ç†ï¼‰

### 5.2 å®¢æˆ·ç«¯ä¸€å…ƒæ‹¦æˆªå™¨


```go
// ğŸ“ å®¢æˆ·ç«¯è®¤è¯æ‹¦æˆªå™¨
func ClientAuthInterceptor(
    ctx context.Context,
    method string,
    req interface{},
    reply interface{},
    cc *grpc.ClientConn,
    invoker grpc.UnaryInvoker,
    opts ...grpc.CallOption,
) error {
    // ğŸ” æ­¥éª¤1ï¼šæ·»åŠ è®¤è¯å¤´
    token := getAuthToken()
    ctx = metadata.AppendToOutgoingContext(ctx, "authorization", "Bearer "+token)
    
    // ğŸ“ æ­¥éª¤2ï¼šæ‰§è¡Œè°ƒç”¨
    err := invoker(ctx, method, req, reply, cc, opts...)
    
    // ğŸ” æ­¥éª¤3ï¼šå¤„ç†ç»“æœ
    if err != nil {
        fmt.Printf("è°ƒç”¨å¤±è´¥: %s, é”™è¯¯: %v\n", method, err)
    } else {
        fmt.Printf("è°ƒç”¨æˆåŠŸ: %s\n", method)
    }
    
    return err
}

// ğŸš€ åœ¨å®¢æˆ·ç«¯ä½¿ç”¨æ‹¦æˆªå™¨
conn, err := grpc.Dial(
    "localhost:8080",
    grpc.WithUnaryInterceptor(ClientAuthInterceptor),  // æ³¨å†Œæ‹¦æˆªå™¨
)
```

### 5.3 å®¢æˆ·ç«¯æµæ‹¦æˆªå™¨


```go
// ğŸ“ å®¢æˆ·ç«¯é‡è¯•æµæ‹¦æˆªå™¨
func ClientRetryStreamInterceptor(
    ctx context.Context,
    desc *grpc.StreamDesc,
    cc *grpc.ClientConn,
    method string,
    streamer grpc.Streamer,
    opts ...grpc.CallOption,
) (grpc.ClientStream, error) {
    // ğŸ”„ å°è¯•å»ºç«‹æµè¿æ¥ï¼Œæ”¯æŒé‡è¯•
    for attempt := 1; attempt <= 3; attempt++ {
        stream, err := streamer(ctx, desc, cc, method, opts...)
        if err == nil {
            fmt.Printf("æµè¿æ¥å»ºç«‹æˆåŠŸï¼Œæ–¹æ³•: %s\n", method)
            return stream, nil
        }
        
        fmt.Printf("æµè¿æ¥å¤±è´¥ï¼Œç¬¬%dæ¬¡å°è¯•ï¼Œæ–¹æ³•: %s\n", attempt, method)
        time.Sleep(time.Second * time.Duration(attempt))
    }
    
    return nil, fmt.Errorf("æµè¿æ¥å»ºç«‹å¤±è´¥ï¼Œå·²é‡è¯•3æ¬¡")
}
```

---

## 6. ğŸ”— æ‹¦æˆªå™¨é“¾å¼å¤„ç†


### 6.1 ä»€ä¹ˆæ˜¯é“¾å¼å¤„ç†


**ğŸ’¡ å½¢è±¡ç†è§£**ï¼šå°±åƒ**å·¥å‚æµæ°´çº¿**ï¼Œæ¯ä¸ªå·¥ä½ï¼ˆæ‹¦æˆªå™¨ï¼‰éƒ½æœ‰è‡ªå·±çš„èŒè´£

```
è¯·æ±‚æµå‘ï¼š
å®¢æˆ·ç«¯è¯·æ±‚ â”€â”€â–º æ‹¦æˆªå™¨1 â”€â”€â–º æ‹¦æˆªå™¨2 â”€â”€â–º æ‹¦æˆªå™¨3 â”€â”€â–º ä¸šåŠ¡é€»è¾‘
å®¢æˆ·ç«¯å“åº” â—„â”€â”€ æ‹¦æˆªå™¨1 â—„â”€â”€ æ‹¦æˆªå™¨2 â—„â”€â”€ æ‹¦æˆªå™¨3 â—„â”€â”€ ä¸šåŠ¡é€»è¾‘

å®é™…ä¾‹å­ï¼š
ç”¨æˆ·è¯·æ±‚ â”€â”€â–º æ—¥å¿—è®°å½• â”€â”€â–º è®¤è¯æ£€æŸ¥ â”€â”€â–º æƒé™éªŒè¯ â”€â”€â–º å¤„ç†ä¸šåŠ¡
ç”¨æˆ·å“åº” â—„â”€â”€ æ—¥å¿—è®°å½• â—„â”€â”€ è®¤è¯æ£€æŸ¥ â—„â”€â”€ æƒé™éªŒè¯ â—„â”€â”€ å¤„ç†ä¸šåŠ¡
```

### 6.2 å¤šæ‹¦æˆªå™¨ç»„åˆ


```go
// ğŸ“ æ‹¦æˆªå™¨ç»„åˆç¤ºä¾‹
func main() {
    // ğŸ”§ åˆ›å»ºå¤šä¸ªæ‹¦æˆªå™¨
    logInterceptor := LoggingInterceptor     // æ—¥å¿—è®°å½•
    authInterceptor := AuthInterceptor       // è®¤è¯æ£€æŸ¥
    metricsInterceptor := MetricsInterceptor // æ€§èƒ½ç›‘æ§
    
    // ğŸ”— æŒ‰é¡ºåºç»„åˆæ‹¦æˆªå™¨
    server := grpc.NewServer(
        grpc.ChainUnaryInterceptor(
            logInterceptor,      // ç¬¬1ä¸ªï¼šå…ˆè®°å½•æ—¥å¿—
            authInterceptor,     // ç¬¬2ä¸ªï¼šå†æ£€æŸ¥è®¤è¯
            metricsInterceptor,  // ç¬¬3ä¸ªï¼šæœ€åç›‘æ§æ€§èƒ½
        ),
    )
}
```

**âš ï¸ æ³¨æ„é¡ºåº**ï¼š
- è¯·æ±‚æ—¶ï¼šæŒ‰æ³¨å†Œé¡ºåºæ‰§è¡Œï¼ˆ1â†’2â†’3ï¼‰
- å“åº”æ—¶ï¼šæŒ‰ç›¸åé¡ºåºæ‰§è¡Œï¼ˆ3â†’2â†’1ï¼‰

### 6.3 æ‹¦æˆªå™¨æ‰§è¡Œæ—¶åº


```go
// ğŸ“ æ¼”ç¤ºæ‹¦æˆªå™¨æ‰§è¡Œé¡ºåº
func Demo1Interceptor(...) error {
    fmt.Println("Demo1: è¯·æ±‚å‰å¤„ç†")
    err := invoker(...)  // è°ƒç”¨ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨
    fmt.Println("Demo1: å“åº”åå¤„ç†")
    return err
}

func Demo2Interceptor(...) error {
    fmt.Println("Demo2: è¯·æ±‚å‰å¤„ç†")
    err := invoker(...)  // è°ƒç”¨ä¸šåŠ¡é€»è¾‘
    fmt.Println("Demo2: å“åº”åå¤„ç†")
    return err
}

// è¾“å‡ºé¡ºåºï¼š
// Demo1: è¯·æ±‚å‰å¤„ç†
// Demo2: è¯·æ±‚å‰å¤„ç†
// [ä¸šåŠ¡é€»è¾‘æ‰§è¡Œ]
// Demo2: å“åº”åå¤„ç†  
// Demo1: å“åº”åå¤„ç†
```

---

## 7. ğŸš€ å®é™…åº”ç”¨åœºæ™¯


### 7.1 è®¤è¯æˆæƒåœºæ™¯


**ğŸ” åº”ç”¨éœ€æ±‚**ï¼šç¡®ä¿åªæœ‰åˆæ³•ç”¨æˆ·æ‰èƒ½è°ƒç”¨æœåŠ¡

```go
// ğŸ“ JWTè®¤è¯æ‹¦æˆªå™¨
func JWTAuthInterceptor(
    ctx context.Context,
    req interface{},
    info *grpc.UnaryServerInfo,
    handler grpc.UnaryHandler,
) (interface{}, error) {
    // ğŸš« è·³è¿‡ä¸éœ€è¦è®¤è¯çš„æ–¹æ³•
    if info.FullMethod == "/health/check" {
        return handler(ctx, req)
    }
    
    // ğŸ” æå–JWTä»¤ç‰Œ
    md, ok := metadata.FromIncomingContext(ctx)
    if !ok {
        return nil, status.Error(codes.Unauthenticated, "ç¼ºå°‘è®¤è¯ä¿¡æ¯")
    }
    
    tokens := md.Get("authorization")
    if len(tokens) == 0 {
        return nil, status.Error(codes.Unauthenticated, "ç¼ºå°‘authorizationå¤´")
    }
    
    // âœ… éªŒè¯JWTä»¤ç‰Œ
    userID, err := validateJWT(tokens[0])
    if err != nil {
        return nil, status.Error(codes.Unauthenticated, "æ— æ•ˆçš„JWTä»¤ç‰Œ")
    }
    
    // ğŸ“ å°†ç”¨æˆ·IDæ·»åŠ åˆ°ä¸Šä¸‹æ–‡
    ctx = context.WithValue(ctx, "userID", userID)
    return handler(ctx, req)
}
```

> ğŸ”§ **å®ç”¨æŠ€å·§**ï¼šé€šè¿‡ä¸Šä¸‹æ–‡ä¼ é€’ç”¨æˆ·ä¿¡æ¯ï¼Œåç»­ä¸šåŠ¡é€»è¾‘å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚

### 7.2 æ—¥å¿—è®°å½•åœºæ™¯


**ğŸ“ åº”ç”¨éœ€æ±‚**ï¼šè®°å½•æ‰€æœ‰APIè°ƒç”¨çš„è¯¦ç»†ä¿¡æ¯

```go
// ğŸ“ è¯¦ç»†æ—¥å¿—æ‹¦æˆªå™¨
func DetailedLoggingInterceptor(
    ctx context.Context,
    req interface{},
    info *grpc.UnaryServerInfo,
    handler grpc.UnaryHandler,
) (interface{}, error) {
    start := time.Now()
    
    // ğŸ“Š è®°å½•è¯·æ±‚ä¿¡æ¯
    log.Printf("ğŸ“ [è¯·æ±‚] æ–¹æ³•:%s, å‚æ•°:%+v", info.FullMethod, req)
    
    // ğŸš€ æ‰§è¡Œä¸šåŠ¡é€»è¾‘
    resp, err := handler(ctx, req)
    
    // ğŸ“Š è®°å½•å“åº”ä¿¡æ¯
    duration := time.Since(start)
    if err != nil {
        log.Printf("âŒ [é”™è¯¯] æ–¹æ³•:%s, è€—æ—¶:%v, é”™è¯¯:%v", 
            info.FullMethod, duration, err)
    } else {
        log.Printf("âœ… [æˆåŠŸ] æ–¹æ³•:%s, è€—æ—¶:%v, å“åº”:%+v", 
            info.FullMethod, duration, resp)
    }
    
    return resp, err
}
```

### 7.3 æ€§èƒ½ç›‘æ§åœºæ™¯


**ğŸ“ˆ åº”ç”¨éœ€æ±‚**ï¼šç›‘æ§APIæ€§èƒ½ï¼Œæ”¶é›†æŒ‡æ ‡æ•°æ®

```go
// ğŸ“ æ€§èƒ½ç›‘æ§æ‹¦æˆªå™¨  
func MetricsInterceptor(
    ctx context.Context,
    req interface{},
    info *grpc.UnaryServerInfo,
    handler grpc.UnaryHandler,
) (interface{}, error) {
    start := time.Now()
    
    // ğŸš€ æ‰§è¡Œä¸šåŠ¡é€»è¾‘
    resp, err := handler(ctx, req)
    
    // ğŸ“Š æ”¶é›†æ€§èƒ½æŒ‡æ ‡
    duration := time.Since(start)
    method := info.FullMethod
    
    // è®°å½•è°ƒç”¨æ¬¡æ•°
    apiCallsTotal.WithLabelValues(method).Inc()
    
    // è®°å½•å“åº”æ—¶é—´
    apiDuration.WithLabelValues(method).Observe(duration.Seconds())
    
    // è®°å½•é”™è¯¯ç‡
    if err != nil {
        apiErrorsTotal.WithLabelValues(method).Inc()
    }
    
    return resp, err
}
```

### 7.4 é™æµç†”æ–­åœºæ™¯


**ğŸš¦ åº”ç”¨éœ€æ±‚**ï¼šé˜²æ­¢æœåŠ¡è¿‡è½½ï¼Œå®ç°é™æµå’Œç†”æ–­

```go
// ğŸ“ é™æµæ‹¦æˆªå™¨
func RateLimitInterceptor(
    ctx context.Context,
    req interface{},
    info *grpc.UnaryServerInfo,
    handler grpc.UnaryHandler,
) (interface{}, error) {
    // ğŸš¦ æ£€æŸ¥é™æµ
    if !rateLimiter.Allow() {
        return nil, status.Error(codes.ResourceExhausted, "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•")
    }
    
    // âš¡ æ£€æŸ¥ç†”æ–­å™¨çŠ¶æ€
    if circuitBreaker.State() == circuit.StateOpen {
        return nil, status.Error(codes.Unavailable, "æœåŠ¡æš‚æ—¶ä¸å¯ç”¨")
    }
    
    // ğŸš€ æ‰§è¡Œä¸šåŠ¡é€»è¾‘
    return handler(ctx, req)
}
```

### 7.5 è·¨åœºæ™¯ç»„åˆä½¿ç”¨


```go
// ğŸ“ ç”Ÿäº§ç¯å¢ƒæ‹¦æˆªå™¨é…ç½®
func CreateProductionServer() *grpc.Server {
    return grpc.NewServer(
        grpc.ChainUnaryInterceptor(
            LoggingInterceptor,    // 1. è¯·æ±‚æ—¥å¿—
            MetricsInterceptor,    // 2. æ€§èƒ½ç›‘æ§  
            RateLimitInterceptor,  // 3. é™æµä¿æŠ¤
            JWTAuthInterceptor,    // 4. è®¤è¯éªŒè¯
        ),
        grpc.ChainStreamInterceptor(
            StreamLoggingInterceptor,    // æµæ—¥å¿—
            StreamMetricsInterceptor,    // æµç›‘æ§
        ),
    )
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ‹¦æˆªå™¨æœ¬è´¨ï¼šåœ¨gRPCè°ƒç”¨å‰åæ’å…¥è‡ªå®šä¹‰é€»è¾‘çš„ä¸­é—´ä»¶æœºåˆ¶
ğŸ”¸ ä¸¤ç§ç±»å‹ï¼šä¸€å…ƒæ‹¦æˆªå™¨ï¼ˆæ™®é€šè°ƒç”¨ï¼‰+ æµæ‹¦æˆªå™¨ï¼ˆæµå¼è°ƒç”¨ï¼‰
ğŸ”¸ ä¸¤ä¸ªä½ç½®ï¼šæœåŠ¡ç«¯æ‹¦æˆªå™¨ï¼ˆæœåŠ¡å™¨ç«¯ï¼‰+ å®¢æˆ·ç«¯æ‹¦æˆªå™¨ï¼ˆå®¢æˆ·ç«¯ï¼‰
ğŸ”¸ æ‰§è¡Œé¡ºåºï¼šè¯·æ±‚æ—¶æ­£åºæ‰§è¡Œï¼Œå“åº”æ—¶é€†åºæ‰§è¡Œ
ğŸ”¸ æ ¸å¿ƒä½œç”¨ï¼šè®¤è¯ã€æ—¥å¿—ã€ç›‘æ§ã€é™æµç­‰æ¨ªåˆ‡å…³æ³¨ç‚¹
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ æ‹¦æˆªå™¨çš„æ‰§è¡Œæ—¶æœº**
```
å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚
    â†“
å®¢æˆ·ç«¯æ‹¦æˆªå™¨ï¼ˆè¯·æ±‚å‰å¤„ç†ï¼‰
    â†“  
ç½‘ç»œä¼ è¾“
    â†“
æœåŠ¡ç«¯æ‹¦æˆªå™¨ï¼ˆè¯·æ±‚å‰å¤„ç†ï¼‰
    â†“
ä¸šåŠ¡é€»è¾‘å¤„ç†
    â†“
æœåŠ¡ç«¯æ‹¦æˆªå™¨ï¼ˆå“åº”åå¤„ç†ï¼‰
    â†“
ç½‘ç»œä¼ è¾“
    â†“
å®¢æˆ·ç«¯æ‹¦æˆªå™¨ï¼ˆå“åº”åå¤„ç†ï¼‰
    â†“
å®¢æˆ·ç«¯æ¥æ”¶å“åº”
```

**ğŸ”¹ æ‹¦æˆªå™¨çš„è®¾è®¡åŸåˆ™**
```
å•ä¸€èŒè´£ï¼šæ¯ä¸ªæ‹¦æˆªå™¨åªåšä¸€ä»¶äº‹
é¡ºåºé‡è¦ï¼šåˆç†å®‰æ’æ‹¦æˆªå™¨çš„æ‰§è¡Œé¡ºåº
é”™è¯¯å¤„ç†ï¼šå¦¥å–„å¤„ç†æ‹¦æˆªå™¨ä¸­çš„å¼‚å¸¸æƒ…å†µ
æ€§èƒ½è€ƒè™‘ï¼šé¿å…åœ¨æ‹¦æˆªå™¨ä¸­æ‰§è¡Œè€—æ—¶æ“ä½œ
```

**ğŸ”¹ å¸¸è§ä½¿ç”¨æ¨¡å¼**
```
ğŸ“ æ—¥å¿—æ¨¡å¼ï¼šè®°å½•è¯·æ±‚/å“åº”ä¿¡æ¯
ğŸ” è®¤è¯æ¨¡å¼ï¼šéªŒè¯ç”¨æˆ·èº«ä»½å’Œæƒé™
ğŸ“Š ç›‘æ§æ¨¡å¼ï¼šæ”¶é›†æ€§èƒ½å’Œä¸šåŠ¡æŒ‡æ ‡
ğŸš¦ ä¿æŠ¤æ¨¡å¼ï¼šé™æµã€ç†”æ–­ã€è¶…æ—¶æ§åˆ¶
ğŸ”„ é‡è¯•æ¨¡å¼ï¼šè‡ªåŠ¨é‡è¯•å¤±è´¥çš„è¯·æ±‚
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


> âœ… **æœ€ä½³å®è·µ**
> - ä¼˜å…ˆä½¿ç”¨å®˜æ–¹æä¾›çš„æ‹¦æˆªå™¨ç»„åˆå‡½æ•° `grpc.ChainUnaryInterceptor()`
> - å°†é€šç”¨é€»è¾‘æŠ½å–ä¸ºç‹¬ç«‹çš„æ‹¦æˆªå™¨ï¼Œæé«˜å¤ç”¨æ€§
> - åœ¨æ‹¦æˆªå™¨ä¸­ä½¿ç”¨ä¸Šä¸‹æ–‡ä¼ é€’ä¿¡æ¯ï¼Œé¿å…å…¨å±€å˜é‡

> âš ï¸ **æ³¨æ„äº‹é¡¹**  
> - æ‹¦æˆªå™¨çš„æ‰§è¡Œé¡ºåºå¾ˆé‡è¦ï¼Œè®¤è¯é€šå¸¸æ”¾åœ¨æœ€å‰é¢
> - é¿å…åœ¨æ‹¦æˆªå™¨ä¸­æ‰§è¡Œé˜»å¡æ“ä½œï¼Œä¼šå½±å“æ•´ä½“æ€§èƒ½
> - æµæ‹¦æˆªå™¨å’Œä¸€å…ƒæ‹¦æˆªå™¨éœ€è¦åˆ†åˆ«æ³¨å†Œ

> ğŸš€ **è¿›é˜¶æŠ€å·§**
> - å¯ä»¥åœ¨æ‹¦æˆªå™¨ä¸­å®ç°è‡ªåŠ¨é‡è¯•ã€è¶…æ—¶æ§åˆ¶ç­‰é«˜çº§åŠŸèƒ½
> - ç»“åˆPrometheusç­‰ç›‘æ§ç³»ç»Ÿï¼Œæ„å»ºå®Œæ•´çš„å¯è§‚æµ‹æ€§æ–¹æ¡ˆ
> - åˆ©ç”¨æ‹¦æˆªå™¨å®ç°åˆ†å¸ƒå¼è¿½è¸ªï¼ˆå¦‚Jaegerã€Zipkinï¼‰

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- æ‹¦æˆªå™¨åƒé—¨å«ï¼Œè¯·æ±‚å“åº”éƒ½è¦ç®¡
- ä¸€å…ƒæµå¼ä¸¤å¤§ç±»ï¼Œå®¢æˆ·æœåŠ¡ç«¯éƒ½èƒ½ç”¨  
- é“¾å¼å¤„ç†æœ‰é¡ºåºï¼Œè®¤è¯æ—¥å¿—ç›‘æ§å…¨
- æ¨ªåˆ‡å…³æ³¨ç‚¹ç»Ÿä¸€ï¼Œæå‡ç³»ç»Ÿå¯ç»´æŠ¤