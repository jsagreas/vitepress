---
title: 1、告警-规则配置
---
## 📚 目录

1. [告警系统基本概念](#1-告警系统基本概念)
2. [告警规则创建](#2-告警规则创建)
3. [条件设置与阈值配置](#3-条件设置与阈值配置)
4. [评估频率控制](#4-评估频率控制)
5. [告警状态管理](#5-告警状态管理)
6. [无数据处理策略](#6-无数据处理策略)
7. [实战配置案例](#7-实战配置案例)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🚨 告警系统基本概念


### 1.1 什么是告警规则


**通俗理解**：告警规则就像家里的烟雾报警器，当监测到异常情况时自动发出警报。

```
现实生活中的报警器：
温度传感器 → 检测温度 → 超过阈值 → 发出警报

Grafana告警规则：
数据查询 → 监测指标 → 触发条件 → 发送通知
```

**告警规则核心要素**：
- **📊 数据源**：从哪里获取监控数据
- **⚖️ 判断条件**：什么情况下触发告警
- **⏰ 检查频率**：多久检查一次
- **📱 通知方式**：如何发送告警信息

### 1.2 告警的作用和价值


**🎯 为什么需要告警**：
```
① 主动发现问题：不用人工盯着大屏，系统自动发现异常
② 及时响应处理：第一时间通知运维人员处理问题
③ 减少损失影响：快速响应可以避免问题扩大
④ 提升服务质量：保障系统稳定性和用户体验
```

**💡 实际应用场景**：
- **服务器监控**：CPU使用率超过80%时告警
- **网站监控**：页面响应时间超过3秒时告警
- **业务监控**：订单量异常下降时告警
- **安全监控**：登录失败次数过多时告警

---

## 2. 🛠️ 告警规则创建


### 2.1 创建入口和基本流程


**📍 创建告警规则的步骤**：

```
步骤流程图：
登录Grafana → 侧边栏"Alerting" → "Alert Rules" → "New Rule"
     ↓
设置规则名称 → 选择数据源 → 配置查询条件 → 设置告警条件
     ↓
配置评估参数 → 添加标签和注释 → 测试规则 → 保存规则
```

### 2.2 告警规则的基本信息配置


**🏷️ 规则基本信息**：
```
规则名称：        CPU_Usage_High（建议用英文，见名知意）
所属文件夹：      Infrastructure（按业务分类组织）
规则组：         Server_Monitoring（相关规则分组）
描述信息：        服务器CPU使用率过高告警
```

**💡 命名规范建议**：
- **清晰明确**：一看就知道监控什么
- **分类标识**：添加业务模块前缀
- **严重程度**：可以包含Critical、Warning等级别

### 2.3 数据查询配置


**📈 配置监控查询**：

查询示例（以Prometheus为例）：
```promql
# 查询CPU使用率
100 - (avg(rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)

# 解释：
# - node_cpu_seconds_total: CPU时间统计指标
# - mode="idle": 空闲时间
# - rate([5m]): 计算5分钟内的增长率
# - 100减去空闲时间百分比 = CPU使用率
```

**🔧 查询配置要点**：
- **时间范围**：选择合适的时间窗口（如5m、1h）
- **聚合函数**：avg()平均值、max()最大值、sum()总和
- **标签过滤**：指定具体的服务器或服务

---

## 3. ⚖️ 条件设置与阈值配置


### 3.1 告警条件类型


**🔍 常用的判断条件**：

| 条件类型 | **说明** | **使用场景** | **示例** |
|---------|---------|-------------|---------|
| **`IS ABOVE`** | 数值大于阈值 | CPU、内存使用率告警 | `CPU使用率 > 80%` |
| **`IS BELOW`** | 数值小于阈值 | 服务可用性、业务指标 | `网站可用性 < 95%` |
| **`IS WITHIN RANGE`** | 数值在范围内 | 正常范围监控 | `响应时间在 100-500ms` |
| **`IS OUTSIDE RANGE`** | 数值超出范围 | 异常检测 | `温度不在 20-25度` |
| **`HAS NO VALUE`** | 没有数据 | 服务下线检测 | `5分钟内无心跳数据` |

### 3.2 阈值设置技巧


**📊 如何设置合理的阈值**：

```
阈值设置原则：

① 基于历史数据：观察正常情况下的数值范围
   例：CPU平时在30-50%，设置告警阈值为80%

② 业务需求导向：根据SLA要求设置
   例：承诺响应时间<2秒，告警阈值设为1.8秒

③ 分级告警策略：设置多个级别
   Warning: CPU > 70%  (黄色告警)
   Critical: CPU > 90% (红色告警)

④ 避免误报：不要设置过于敏感的阈值
   错误：CPU > 60% (可能频繁误报)
   正确：CPU > 80% 持续5分钟
```

### 3.3 条件表达式配置


**🔧 告警条件配置界面**：

```
Condition Settings（条件设置）:
┌─────────────────────────────────────┐
│ Query: A                            │
│ Reducer: last()                     │  ← 取最新值
│ Math: > 80                          │  ← 大于80
│ Threshold: 80                       │  ← 阈值为80
└─────────────────────────────────────┘

IS ABOVE 80 FOR 5m  ← 持续5分钟超过80才告警
```

**💡 Reducer函数说明**：
- **`last()`**：取最新的一个值
- **`avg()`**：取平均值
- **`min()`**：取最小值  
- **`max()`**：取最大值
- **`count()`**：计算数量

---

## 4. ⏰ 评估频率控制


### 4.1 评估频率的概念


**⏱️ 什么是评估频率**：
```
简单理解：
评估频率 = 告警规则多久检查一次数据

例如：
设置评估频率为1分钟，告警规则每分钟检查一次CPU使用率
设置评估频率为5分钟，告警规则每5分钟检查一次磁盘空间
```

### 4.2 评估参数配置


**⚙️ 关键评估参数**：

```
Evaluation Settings（评估设置）:
┌─────────────────────────────────────┐
│ Evaluate every: 1m                  │  ← 每1分钟评估一次
│ For: 5m                            │  ← 持续5分钟才告警
│ Configure no data and error handling │  ← 无数据处理设置
└─────────────────────────────────────┐
```

**📊 参数详解**：

| 参数 | **含义** | **建议设置** | **影响** |
|------|---------|-------------|---------|
| **Evaluate every** | 检查频率 | 关键指标：1m<br>一般指标：5m | 太频繁消耗资源<br>太慢发现问题延迟 |
| **For** | 持续时间 | 瞬时告警：0s<br>稳定告警：5m | 避免瞬间抖动误报<br>确保问题持续存在 |

### 4.3 评估频率优化建议


**⚡ 性能与及时性平衡**：
```
高频监控（每30秒-1分钟）:
✅ 适用于：核心业务指标、安全相关
❌ 缺点：消耗更多资源

低频监控（每5-10分钟）:
✅ 适用于：非关键指标、趋势监控  
❌ 缺点：发现问题可能有延迟

智能设置策略：
- 核心服务可用性：30秒
- 系统资源使用率：1分钟  
- 业务数据统计：5分钟
- 日志文件大小：10分钟
```

---

## 5. 📊 告警状态管理


### 5.1 告警状态的生命周期


**🔄 三种基本状态**：

```
告警状态转换图：
        检查数据
            ↓
    ┌─────[OK]─────┐
    │      ↓       │
触发条件 [Pending] │ 恢复正常
    │      ↓       │
    └──[Alerting]──┘
         ↑
    持续满足条件
```

### 5.2 状态详细说明


**🟢 OK状态（正常）**：
```
状态说明：指标数值在正常范围内
显示效果：绿色图标
触发条件：数值低于告警阈值
处理动作：无需处理，继续监控

示例：CPU使用率为45%，告警阈值为80%
```

**🟡 Pending状态（待定）**：
```
状态说明：指标超过阈值，但还未达到持续时间要求
显示效果：黄色图标  
触发条件：数值超过阈值，但持续时间不够
处理动作：继续观察，准备告警

示例：CPU使用率85%，已持续2分钟，设置要求持续5分钟
```

**🔴 Alerting状态（告警中）**：
```
状态说明：指标超过阈值且满足持续时间要求
显示效果：红色图标
触发条件：满足所有告警条件
处理动作：发送通知，需要人工处理

示例：CPU使用率85%，已持续5分钟以上
```

### 5.3 状态转换示例


**📈 实际状态变化过程**：

```
时间轴示例（CPU监控）：
时间    CPU使用率    状态      说明
09:00   45%         OK        正常使用
09:05   85%         Pending   超过阈值，开始计时
09:08   87%         Pending   继续超过，还未满5分钟
09:10   89%         Alerting  持续5分钟，开始告警
09:15   91%         Alerting  继续告警状态
09:20   65%         OK        恢复正常，告警结束
```

---

## 6. 🚫 无数据处理策略


### 6.1 无数据情况分析


**❓ 什么时候会出现无数据**：
```
常见的无数据场景：

① 服务器宕机：监控agent停止工作，无法上报数据
② 网络中断：数据无法传输到监控系统
③ 服务停止：被监控的应用程序停止运行
④ 配置错误：查询语句有误，查不到数据
⑤ 数据源问题：Prometheus等数据源故障
```

### 6.2 无数据处理选项


**⚙️ Grafana无数据处理设置**：

```
No Data & Error Handling（无数据和错误处理）:
┌─────────────────────────────────────┐
│ No Data:                            │
│ ● No Data  (无数据)                  │
│ ○ Alerting (告警)                    │  
│ ○ OK       (正常)                    │
│                                     │
│ Execution Error:                    │
│ ● Alerting (告警)                    │
│ ○ OK       (正常)                    │
└─────────────────────────────────────┘
```

**📋 处理策略对比**：

| 策略 | **适用场景** | **优点** | **缺点** |
|------|-------------|---------|---------|
| **No Data** | 预期会有数据中断 | 避免误报 | 可能错过真实故障 |
| **Alerting** | 数据必须连续存在 | 及时发现故障 | 可能产生误报 |
| **OK** | 数据可有可无 | 减少噪音 | 可能忽略重要问题 |

### 6.3 最佳实践建议


**🎯 针对不同场景的建议**：

```
服务可用性监控：
设置：无数据 → Alerting
原因：服务器宕机时必须立即告警

业务指标监控：
设置：无数据 → No Data  
原因：业务低峰期可能暂时无数据

系统资源监控：
设置：无数据 → Alerting
原因：系统应该持续产生资源数据

批处理任务监控：
设置：无数据 → OK
原因：任务执行完成后确实无数据
```

---

## 7. 💼 实战配置案例


### 7.1 Web服务响应时间告警


**📋 案例背景**：监控网站API响应时间，超过2秒告警

```
告警规则配置：
┌─────────────────────────────────────┐
│ Rule Name: API_Response_Time_High   │
│ Folder: Web_Services               │
│ Group: Performance_Monitoring     │
└─────────────────────────────────────┘

Query Configuration:
┌─────────────────────────────────────┐
│ Data Source: Prometheus            │
│ Query: histogram_quantile(0.95,    │
│   rate(http_request_duration_      │
│   seconds_bucket[5m]))             │
└─────────────────────────────────────┘

Condition Settings:
┌─────────────────────────────────────┐
│ IS ABOVE 2 FOR 3m                 │
│ (响应时间超过2秒持续3分钟)            │
└─────────────────────────────────────┘

Evaluation:
┌─────────────────────────────────────┐
│ Evaluate every: 1m                 │
│ For: 3m                           │
│ No Data: Alerting                 │
└─────────────────────────────────────┘
```

### 7.2 数据库连接数告警


**📋 案例背景**：MySQL连接数超过最大连接数的80%告警

```
查询语句解释：
max_connections = 200 (数据库最大连接数)
告警阈值 = 200 × 0.8 = 160

Query:
mysql_global_status_threads_connected / 
mysql_global_variables_max_connections * 100

Condition: IS ABOVE 80 FOR 5m
```

**⚠️ 注意事项**：
- **预留安全边距**：不要等到100%才告警
- **考虑业务高峰**：根据业务模式调整阈值
- **分级告警**：80%Warning，90%Critical

### 7.3 磁盘空间使用率告警


**📋 案例背景**：服务器磁盘使用率超过85%告警

```
多条件告警配置：
┌─────────────────────────────────────┐
│ Query A: 磁盘使用率                   │
│ (1 - node_filesystem_avail_bytes /  │
│  node_filesystem_size_bytes) * 100  │
│                                     │
│ Query B: 可用空间GB                  │  
│ node_filesystem_avail_bytes/        │
│ 1024/1024/1024                     │
└─────────────────────────────────────┘

告警条件：
(A > 85) AND (B < 5)
既要使用率超过85%，又要剩余空间小于5GB
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心概念


```
🔸 告警规则：定义什么情况下触发告警的规则配置
🔸 条件设置：指标超过阈值的判断逻辑
🔸 阈值配置：触发告警的临界数值
🔸 评估频率：多久检查一次告警条件
🔸 告警状态：OK、Pending、Alerting三种状态
🔸 无数据处理：当监控数据缺失时的处理策略
```

### 8.2 关键理解要点


**🔹 阈值设置的艺术**：
```
不是越敏感越好：
- 阈值太低 → 频繁误报 → 告警疲劳
- 阈值太高 → 发现问题太晚 → 影响业务

最佳实践：
- 基于历史数据分析
- 考虑业务容忍度
- 设置分级告警
- 定期调优阈值
```

**🔹 持续时间的重要性**：
```
为什么需要"FOR"参数：
- 避免瞬间抖动误报
- 确保问题真实存在
- 给系统自愈时间

平衡考虑：
- 太短：容易误报
- 太长：响应延迟
```

**🔹 无数据策略选择**：
```
关键判断标准：
① 这个指标是否应该持续存在？
② 无数据是否意味着故障？
③ 误报的成本是否可接受？

决策流程：
持续型指标(CPU/内存) → 无数据=告警
间歇型指标(批处理) → 无数据=正常
关键业务指标 → 无数据=告警
```

### 8.3 实际应用价值


**🎯 业务场景应用**：
- **基础设施监控**：CPU、内存、磁盘、网络告警
- **应用性能监控**：响应时间、错误率、吞吐量告警  
- **业务指标监控**：订单量、用户活跃度、收入告警
- **安全监控**：异常登录、权限变更、攻击检测告警

**🔧 运维实践指导**：
- **告警规则管理**：按业务分类组织，便于维护
- **阈值调优**：基于实际运行数据持续优化
- **告警降噪**：避免告警风暴，减少无效告警
- **响应流程**：建立标准化的告警处理流程

### 8.4 常见问题与解决


**❗ 告警疲劳问题**：
```
现象：告警太多，运维人员开始忽视
解决：
① 提高阈值，减少敏感度
② 增加持续时间要求  
③ 合并相关告警
④ 设置告警静默期
```

**❗ 误报问题**：
```
现象：告警触发但实际无问题
解决：
① 分析历史数据，调整阈值
② 增加多条件判断
③ 考虑业务场景特殊性
④ 使用趋势判断而非绝对值
```

**❗ 漏报问题**：
```
现象：有问题但没有告警
解决：
① 检查查询语句是否正确
② 确认数据源连接正常
③ 验证告警条件设置
④ 检查通知渠道配置
```

**核心记忆口诀**：
- 告警规则要精准，阈值设置有学问
- 评估频率要适中，持续时间防误报  
- 三种状态要清楚，无数据处理要合理
- 实战配置多练习，持续优化是关键