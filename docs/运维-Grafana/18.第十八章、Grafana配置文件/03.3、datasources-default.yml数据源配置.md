---
title: 3、datasources-default.yml数据源配置
---
## 📚 目录

1. [数据源配置文件概述](#1-数据源配置文件概述)
2. [配置文件基本结构](#2-配置文件基本结构)
3. [核心配置项详解](#3-核心配置项详解)
4. [认证配置详解](#4-认证配置详解)
5. [高级配置选项](#5-高级配置选项)
6. [实际配置示例](#6-实际配置示例)
7. [常见问题与最佳实践](#7-常见问题与最佳实践)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 📊 数据源配置文件概述


### 1.1 什么是数据源配置文件


**🔸 简单理解**
数据源配置文件就像是Grafana的"电话簿"，告诉Grafana怎么连接各种数据库和监控系统。

```
想象一下：
你想看网站的访问数据 → 需要连接到Prometheus
你想看数据库性能 → 需要连接到MySQL
你想看日志信息 → 需要连接到Elasticsearch

数据源配置文件 = 告诉Grafana这些"电话号码"和"联系方式"
```

**🔸 文件作用**
- 🎯 **自动化配置**：启动时自动加载数据源，无需手动添加
- 🔄 **批量管理**：一次配置多个数据源
- 📋 **标准化部署**：确保不同环境的配置一致
- 🔒 **版本控制**：配置文件可以纳入Git管理

### 1.2 配置文件位置和命名


**📁 文件位置**
```
Grafana安装目录结构：
/etc/grafana/
├── grafana.ini          ← 主配置文件
└── provisioning/        ← 自动化配置目录
    ├── dashboards/      ← 仪表板配置
    ├── datasources/     ← 数据源配置 (我们关注的)
    ├── plugins/         ← 插件配置
    └── notifiers/       ← 通知配置
```

**📄 命名规则**
- 文件名：`*.yml` 或 `*.yaml`
- 示例：`datasources.yml`、`prometheus.yml`、`mysql.yml`
- 🟢推荐：按数据源类型分别命名，便于管理

---

## 2. 🏗️ 配置文件基本结构


### 2.1 YAML基础结构


**📋 基本框架**
```yaml
# 这是注释，解释配置的作用
apiVersion: 1          # ← API版本，目前固定为1

datasources:           # ← 数据源列表开始
  - name: "数据源名称"   # ← 第一个数据源
    type: "数据源类型"
    # ... 更多配置
    
  - name: "另一个数据源" # ← 第二个数据源
    type: "另一种类型"
    # ... 更多配置
```

**🔸 结构说明**
- `apiVersion`：告诉Grafana用哪个版本的配置格式
- `datasources`：一个列表，包含所有要配置的数据源
- 每个数据源用 `-` 开头，表示列表中的一项

### 2.2 单个数据源的基本结构


```yaml
datasources:
  - name: "我的数据源"              # 显示名称
    type: "prometheus"             # 数据源类型
    access: "proxy"                # 访问方式
    url: "http://localhost:9090"   # 数据源地址
    isDefault: true                # 是否为默认数据源
```

---

## 3. ⚙️ 核心配置项详解


### 3.1 基础标识配置


#### 🏷️ name - 数据源名称


**含义**：数据源在Grafana中显示的名字
```yaml
name: "生产环境Prometheus"  # ← 这个名字会在数据源列表中显示
```

**🔸 命名建议**
- ✅ 描述性：`生产环境Prometheus`、`测试MySQL数据库`
- ✅ 环境区分：`Prod-Prometheus`、`Test-MySQL`
- ❌ 避免：`db1`、`test`等模糊名称

#### 🔧 type - 数据源类型


**含义**：告诉Grafana这是什么类型的数据源
```yaml
type: "prometheus"     # Prometheus监控系统
type: "mysql"          # MySQL数据库
type: "elasticsearch"  # Elasticsearch搜索引擎
type: "influxdb"       # InfluxDB时序数据库
```

**🔸 常见类型对照表**
| 类型名称 | 用途 | 典型场景 |
|---------|------|---------|
| `prometheus` | 🔍 监控指标 | 服务器监控、应用监控 |
| `mysql` | 🗄️ 关系数据库 | 业务数据查询 |
| `elasticsearch` | 📝 日志搜索 | 日志分析、全文搜索 |
| `influxdb` | 📈 时序数据 | IoT数据、性能指标 |

#### 🆔 uid - 唯一标识符


**含义**：数据源的唯一ID，像身份证号一样
```yaml
uid: "prometheus-prod-001"  # 推荐：有意义的ID
uid: "P1809F7CD0C75ACF3"    # 系统生成：随机字符串
```

**🔸 使用场景**
- 🎯 **仪表板引用**：仪表板通过uid引用数据源
- 🔄 **配置更新**：相同uid的配置会覆盖旧配置
- 📋 **API调用**：程序化操作数据源时使用

### 3.2 连接配置


#### 🌐 url - 数据源地址


**含义**：告诉Grafana去哪里找数据源
```yaml
url: "http://prometheus.company.com:9090"   # 完整URL
url: "http://localhost:9090"                # 本地服务
url: "https://secure-db.com:3306"          # HTTPS加密连接
```

**🔸 URL构成说明**
```
https://prometheus.example.com:9090/metrics
├─────┤ ├─────────────────────┤├──┤├──────┤
协议    主机名/IP地址          端口  路径
```

#### 🔌 access - 访问模式


**含义**：决定Grafana怎么访问数据源

```yaml
access: "proxy"    # 代理模式（推荐）
access: "direct"   # 直连模式（较少用）
```

**🔸 两种模式对比**

```
代理模式 (proxy)：
浏览器 → Grafana服务器 → 数据源
优点：✅ 安全性高，✅ 支持认证，✅ 绕过跨域限制
缺点：❌ 增加服务器负载

直连模式 (direct)：
浏览器 ←→ 数据源
优点：✅ 性能更好，✅ 减少服务器压力
缺点：❌ 安全性差，❌ 可能有跨域问题
```

**🟢 建议**：99%的情况使用`proxy`模式

#### ⭐ isDefault - 默认数据源


**含义**：设置这个数据源为默认选择
```yaml
isDefault: true   # 这是默认数据源
isDefault: false  # 不是默认数据源（可省略）
```

**🔸 作用**
- 🎯 新建面板时自动选择这个数据源
- 📊 导入仪表板时的fallback选择
- ⚠️ **注意**：只能有一个默认数据源

---

## 4. 🔐 认证配置详解


### 4.1 基础认证 (Basic Auth)


**含义**：用用户名和密码登录数据源

```yaml
basicAuth: true                    # 启用基础认证
basicAuthUser: "grafana_user"      # 用户名
basicAuthPassword: "my_password"   # 密码（明文，不推荐）
```

**🔸 安全性说明**
```
明文密码的问题：
配置文件：password: "123456"  ← 🔴 任何人都能看到密码
更安全的方式：使用环境变量或secureJsonData
```

### 4.2 携带凭证配置


```yaml
withCredentials: true   # 跨域请求时携带cookies和认证信息
withCredentials: false  # 不携带（默认值）
```

**🔸 使用场景**
- 🍪 需要使用浏览器中的cookies认证
- 🔒 第三方认证系统集成
- 🌐 跨域访问需要认证信息

### 4.3 安全JSON数据


**含义**：加密存储敏感信息，比明文密码更安全

```yaml
secureJsonData:
  password: "actual_password"    # 加密存储的密码
  apiKey: "secret_api_key"       # API密钥
  accessToken: "oauth_token"     # 访问令牌
```

**🔸 安全优势**
- 🔒 密码加密存储在数据库中
- 👁️ 界面上显示为 `[configured]`
- 🔄 只能设置，不能读取

### 4.4 TLS/SSL认证


```yaml
tlsAuth: true                    # 启用TLS客户端认证
tlsAuthWithCACert: true          # 同时验证CA证书

secureJsonData:
  tlsClientCert: "证书内容"       # 客户端证书
  tlsClientKey: "私钥内容"        # 客户端私钥
  tlsCACert: "CA证书内容"         # CA根证书
```

---

## 5. 🚀 高级配置选项


### 5.1 JSON数据配置


**含义**：传递给数据源插件的额外配置参数

```yaml
jsonData:
  httpMethod: "POST"              # HTTP请求方法
  timeInterval: "30s"             # 数据查询间隔
  queryTimeout: "60s"             # 查询超时时间
  maxConcurrentShardRequests: 5   # 最大并发请求数
```

**🔸 常用配置项**

| 配置项 | 含义 | 示例值 | 适用场景 |
|--------|------|--------|----------|
| `httpMethod` | HTTP方法 | `GET`, `POST` | API调用方式 |
| `timeInterval` | 时间间隔 | `15s`, `1m` | 数据采集频率 |
| `queryTimeout` | 查询超时 | `30s`, `60s` | 大查询保护 |
| `maxDataPoints` | 最大数据点 | `1000` | 图表性能优化 |

### 5.2 组织和权限配置


```yaml
orgId: 1          # 组织ID（1为默认组织）
version: 1        # 配置版本号
editable: true    # 是否允许在界面中编辑
```

**🔸 配置说明**
- `orgId`：多租户环境中指定数据源属于哪个组织
- `version`：配置变更时递增，用于冲突检测
- `editable`：设为`false`可防止误操作修改

---

## 6. 💼 实际配置示例


### 6.1 Prometheus监控配置


```yaml
apiVersion: 1

datasources:
  - name: "生产环境Prometheus"
    type: "prometheus"
    access: "proxy"
    url: "http://prometheus.internal:9090"
    isDefault: true
    uid: "prometheus-prod"
    
    jsonData:
      httpMethod: "POST"
      timeInterval: "15s"
      queryTimeout: "60s"
    
    # 如果Prometheus有认证
    basicAuth: true
    basicAuthUser: "grafana"
    secureJsonData:
      basicAuthPassword: "secure_password"
```

### 6.2 MySQL数据库配置


```yaml
apiVersion: 1

datasources:
  - name: "业务数据库"
    type: "mysql"
    access: "proxy"
    url: "mysql.company.com:3306"
    uid: "mysql-business"
    
    # 数据库连接信息
    database: "business_db"
    user: "grafana_readonly"
    
    secureJsonData:
      password: "db_password"
    
    jsonData:
      maxOpenConns: 10         # 最大连接数
      maxIdleConns: 2          # 最大空闲连接
      connMaxLifetime: 14400   # 连接最大生命周期（秒）
```

### 6.3 多数据源综合配置


```yaml
apiVersion: 1

datasources:
  # 主要监控数据源
  - name: "Prometheus监控"
    type: "prometheus"
    access: "proxy"
    url: "http://prometheus:9090"
    isDefault: true
    uid: "prometheus-main"
    
  # 日志数据源
  - name: "应用日志"
    type: "elasticsearch"
    access: "proxy"
    url: "http://elasticsearch:9200"
    uid: "elasticsearch-logs"
    
    jsonData:
      esVersion: "7.10.0"
      timeField: "@timestamp"
      logMessageField: "message"
      logLevelField: "level"
    
  # 业务数据库
  - name: "MySQL业务数据"
    type: "mysql"
    access: "proxy"
    url: "mysql:3306"
    uid: "mysql-business"
    database: "app_db"
    user: "grafana_user"
    
    secureJsonData:
      password: "mysql_password"
```

---

## 7. ⚠️ 常见问题与最佳实践


### 7.1 常见配置错误


**🔸 错误1：数据源连接失败**
```yaml
# ❌ 错误配置
url: "prometheus:9090"          # 缺少协议
url: "http://prometheus"        # 缺少端口

# ✅ 正确配置  
url: "http://prometheus:9090"   # 完整的URL
```

**🔸 错误2：认证配置不当**
```yaml
# ❌ 不安全
basicAuthPassword: "123456"     # 明文密码

# ✅ 安全
secureJsonData:
  basicAuthPassword: "123456"   # 加密存储
```

**🔸 错误3：YAML格式错误**
```yaml
# ❌ 缩进错误
datasources:
- name: "test"                  # 缺少空格

# ✅ 正确缩进
datasources:
  - name: "test"                # 正确的YAML格式
```

### 7.2 最佳实践建议


**🔸 安全实践**
- 🔒 使用`secureJsonData`存储密码和密钥
- 🌐 生产环境使用HTTPS连接
- 👤 为Grafana创建专用的只读账户
- 🔑 定期轮换密码和API密钥

**🔸 命名规范**
```yaml
# 🟢 推荐的命名方式
name: "Prod-Prometheus-Cluster-01"     # 环境-类型-集群-编号
name: "Dev-MySQL-UserDB"               # 环境-类型-用途
uid: "prom-prod-01"                    # 简短但有意义

# 🔴 避免的命名方式
name: "db1"                            # 太简单
name: "test"                           # 不明确
```

**🔸 性能优化**
```yaml
jsonData:
  timeInterval: "15s"           # 🟢 适中的采集间隔
  queryTimeout: "30s"           # 🟢 合理的超时时间
  maxDataPoints: 1000           # 🟢 限制数据点数量
```

### 7.3 故障排查步骤


**📋 检查清单**

1️⃣ **配置文件语法**
```bash
# 检查YAML语法是否正确
yamllint /etc/grafana/provisioning/datasources/datasources.yml
```

2️⃣ **网络连接**
```bash
# 从Grafana服务器测试连接
curl -I http://prometheus:9090
telnet prometheus 9090
```

3️⃣ **认证信息**
- 检查用户名密码是否正确
- 验证API密钥是否有效
- 确认权限是否足够

4️⃣ **Grafana日志**
```bash
# 查看Grafana日志
tail -f /var/log/grafana/grafana.log
journalctl -u grafana-server -f
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心概念


```
🔸 数据源配置文件：Grafana连接外部数据的"电话簿"
🔸 基本结构：apiVersion + datasources列表
🔸 核心配置：name、type、url、access是必需项
🔸 安全配置：使用secureJsonData保护敏感信息
🔸 访问模式：proxy模式更安全，推荐使用
```

### 8.2 关键配置项记忆


**🔹 必需配置项**
```yaml
name: "显示名称"        # 数据源的显示名
type: "数据源类型"      # 告诉Grafana这是什么
url: "连接地址"         # 数据源在哪里
access: "proxy"        # 99%用proxy模式
```

**🔹 常用可选项**
```yaml
isDefault: true        # 默认数据源（只能有一个）
uid: "唯一标识"        # 用于仪表板引用
basicAuth: true        # 需要用户名密码时
jsonData: {}          # 特殊配置参数
secureJsonData: {}    # 加密的敏感信息
```

### 8.3 实际应用要点


**🔸 配置管理策略**
- 📁 按数据源类型分文件管理
- 🔄 使用版本控制跟踪变更
- 🔒 敏感信息使用加密存储
- 📋 建立标准的命名规范

**🔸 部署最佳实践**
- 🟢 测试环境先验证配置
- 📊 使用uid确保配置一致性
- ⚡ 合理设置超时和间隔参数
- 🔍 配置完成后测试连接

**🔸 故障预防**
- ✅ 定期检查数据源连接状态
- 📝 记录配置变更和原因
- 🔑 建立密码轮换机制
- 📊 监控数据源查询性能

**💡 学习建议**
- 从简单的Prometheus配置开始练习
- 理解proxy和direct访问模式的区别
- 掌握安全配置的重要性
- 多动手实验不同的配置组合

**核心记忆口诀**：
- 数据源配置像电话簿，告诉Grafana找谁聊
- name、type、url、access，四项基础不能少
- 密码认证用secure，安全第一最重要
- proxy模式是首选，direct模式要慎用