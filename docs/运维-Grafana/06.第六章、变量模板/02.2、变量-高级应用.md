---
title: 2、变量-高级应用
---
## 📚 目录

1. [变量高级应用概述](#1-变量高级应用概述)
2. [多值选择与全选功能](#2-多值选择与全选功能)
3. [变量级联依赖](#3-变量级联依赖)
4. [变量刷新策略](#4-变量刷新策略)
5. [隐藏变量的妙用](#5-隐藏变量的妙用)
6. [变量排序与展示](#6-变量排序与展示)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 🎯 变量高级应用概述


### 1.1 什么是变量高级应用


**简单理解**：如果说基础变量是单选题，那么高级应用就是让你可以做**多选题、连锁题、自动题**

```
基础变量应用：
服务器选择: [Web-01] ▼
            单选一台服务器

高级变量应用：
服务器选择: [Web-01, Web-02, DB-01] ▼  ← 可以选多个
环境选择:   [生产环境] ▼              ← 根据上面的选择自动变化
时间范围:   [最近1小时] ▼            ← 可以隐藏起来
```

### 1.2 为什么需要高级应用


**实际工作场景**：
- **批量监控**：同时查看多台服务器的CPU使用率
- **环境联动**：选择了测试环境，服务器列表自动显示测试服务器
- **简化界面**：把一些固定不变的变量隐藏起来，界面更简洁
- **智能排序**：把最常用的选项排在前面

---

## 2. 🔄 多值选择与全选功能


### 2.1 多值选择的基本概念


**什么是多值选择**：一次可以选择多个值的变量，就像购物车可以放多个商品

```
单值选择效果：
服务器: Web-01        ← 只能选一个

多值选择效果：
服务器: Web-01, Web-02, DB-01    ← 可以选多个
```

### 2.2 配置多值选择


**步骤详解**：

```
设置路径：
Dashboard → Settings → Variables → 编辑变量

关键配置项：
┌──────────────────────────┐
│ Multi-value: ✅ 启用      │  ← 打开这个开关
│ Include All: ✅ 启用      │  ← 提供"全选"选项
│ All value: *             │  ← 全选时的值
└──────────────────────────┘
```

**实际配置示例**：
- **Variable name**: `servers`
- **Multi-value**: `启用`
- **Include All option**: `启用`
- **All value**: `.*` 或 `*`

### 2.3 查询中使用多值变量


**在PromQL中的用法**：

```promql
# 错误写法（单值思维）
cpu_usage{instance="$servers"}

# 正确写法（多值适配）
cpu_usage{instance=~"$servers"}    # 注意使用 =~ 而不是 =
```

**为什么要用 `=~`**：
- `=` 是精确匹配，只能匹配一个值
- `=~` 是正则匹配，可以匹配多个值
- 当选择多个服务器时，`$servers` 会变成 `Web-01|Web-02|DB-01`

### 2.4 全选功能的实现


**全选的工作原理**：

```
用户操作: 点击 "All" 选项
变量值变化: $servers = ".*"  (匹配所有)
查询语句: cpu_usage{instance=~".*"}  (查询所有实例)

实际场景：
选择具体服务器: cpu_usage{instance=~"Web-01|Web-02"}
选择全部服务器: cpu_usage{instance=~".*"}
```

---

## 3. 🔗 变量级联依赖


### 3.1 什么是变量级联


**生活类比**：就像买车时，先选品牌，再选车型，最后选配置
- 选择了"丰田" → 车型列表显示：凯美瑞、卡罗拉、汉兰达
- 选择了"本田" → 车型列表显示：雅阁、思域、CRV

**监控场景**：
```
环境选择: [生产环境] ▼
         ↓ 级联影响
服务器列表: [prod-web-01, prod-web-02, prod-db-01] ▼
         ↓ 级联影响  
服务类型: [nginx, mysql, redis] ▼
```

### 3.2 配置级联依赖


**第一步：创建父变量（环境）**

```
变量名: environment
查询语句: label_values(up, environment)
结果: [dev, test, prod]
```

**第二步：创建子变量（服务器）**

```
变量名: servers
查询语句: label_values(up{environment="$environment"}, instance)
说明: 这里的 $environment 会根据第一个变量的选择自动变化
```

**第三步：创建孙变量（服务类型）**

```
变量名: service_type  
查询语句: label_values(up{environment="$environment", instance=~"$servers"}, job)
说明: 同时依赖前两个变量
```

### 3.3 级联的工作流程


```
用户操作流程:
1. 选择环境: "生产环境"
   ↓
2. 服务器列表自动刷新: 显示生产环境的服务器
   ↓  
3. 选择服务器: "prod-web-01, prod-web-02"
   ↓
4. 服务类型自动刷新: 显示这些服务器上的服务类型
   ↓
5. 最终查询: 精确定位到特定环境、服务器、服务的监控数据
```

---

## 4. 🔄 变量刷新策略


### 4.1 刷新策略的重要性


**为什么需要刷新**：监控环境是动态的
- 新服务器上线了，变量列表要更新
- 服务实例重启了，实例列表要刷新
- 标签值发生变化，选项要同步更新

### 4.2 刷新策略类型


| 刷新类型 | **触发时机** | **适用场景** | **优缺点** |
|---------|-------------|-------------|-----------|
| **Never** | `永不刷新` | `固定的标签值` | `性能好，但不能动态更新` |
| **On Dashboard Load** | `仪表板加载时` | `相对固定的环境列表` | `平衡性能与准确性` |
| **On Time Range Change** | `时间范围改变时` | `时间敏感的数据` | `及时更新，开销适中` |
| **On Variable Change** | `其他变量改变时` | `级联依赖的子变量` | `最及时，但开销最大` |

### 4.3 刷新策略的配置


**智能选择刷新策略**：

```
场景1: 环境列表 (dev, test, prod)
建议: "On Dashboard Load"
原因: 环境相对固定，不需要频繁刷新

场景2: 服务器列表 (依赖环境选择)
建议: "On Variable Change"  
原因: 当环境变量改变时，需要立即更新服务器列表

场景3: 时间相关的统计
建议: "On Time Range Change"
原因: 时间范围变化时，可用的数据范围也会变化
```

---

## 5. 👁️ 隐藏变量的妙用


### 5.1 什么时候需要隐藏变量


**隐藏变量的应用场景**：
- **内部计算变量**：只用于计算，用户不需要看到
- **固定配置变量**：值已经确定，不需要用户选择
- **中间过程变量**：作为其他变量的数据源

### 5.2 隐藏变量的配置


**配置方法**：

```
变量设置中:
┌─────────────────────────┐
│ Hide: Variable          │  ← 选择这个选项
│                         │
│ 其他选项:               │
│ - ""(空): 显示变量      │
│ - Label: 只隐藏变量名   │  
│ - Variable: 完全隐藏    │
└─────────────────────────┘
```

### 5.3 隐藏变量的实际应用


**案例：动态阈值计算**

```
隐藏变量: threshold_base
类型: Constant  
值: 0.8
用途: 作为告警阈值的基础值

显示变量: alert_level
选项: [低, 中, 高]
值映射: 低=0.6, 中=0.8, 高=0.9

最终查询: cpu_usage > ($threshold_base * 1.2)
```

**好处**：
- 用户界面简洁，不会被技术细节干扰
- 管理员可以统一控制基础参数
- 便于维护和修改

---

## 6. 📊 变量排序与展示


### 6.1 排序选项详解


| 排序方式 | **效果** | **适用场景** |
|---------|---------|-------------|
| **Disabled** | `保持原始顺序` | `已经按需求排序的数据` |
| **Alphabetical (asc)** | `A-Z排序` | `服务器名称、用户名等` |
| **Alphabetical (desc)** | `Z-A排序` | `需要倒序显示的场景` |
| **Numerical (asc)** | `数字从小到大` | `端口号、ID等数字` |
| **Alphabetical (case-insensitive)** | `忽略大小写的A-Z` | `混合大小写的标签` |

### 6.2 自定义排序技巧


**使用正则表达式控制顺序**：

```
原始数据: [web-03, web-01, web-10, web-02]
问题: 按字母排序会变成 [web-01, web-02, web-10, web-03]

解决方案: 修改查询语句
label_values(up{job=~"web-.*"}, instance) | sort_by_num
```

**优先级排序技巧**：

```
重要性排序: 在标签中加入优先级前缀
原始: [nginx, mysql, redis]  
改进: [1-nginx, 2-mysql, 3-redis]
显示: 使用正则去掉前缀 /^[0-9]+-(.*)$/
```

### 6.3 展示格式优化


**选项文本与值的分离**：

```
内部值: prod-web-01.company.com
显示文本: Web服务器01
配置方法: 使用 regex 和 display name 功能
```

---

## 7. 📋 核心要点总结


### 7.1 必须掌握的核心概念


```
🔸 多值选择: 一次选择多个值，查询时使用 =~ 而不是 =
🔸 变量级联: 父变量影响子变量的可选值，实现智能联动
🔸 刷新策略: 根据使用场景选择合适的刷新时机
🔸 隐藏变量: 把技术细节隐藏，让界面更简洁
🔸 智能排序: 让最重要的选项排在最前面
```

### 7.2 实际应用指导


**🔹 多值选择最佳实践**
```
✅ 记住使用 =~ 正则匹配
✅ 合理设置 All value
✅ 在面板标题中显示选择的值
❌ 不要在不支持多值的地方使用多值变量
```

**🔹 级联设计原则**
```
设计顺序: 从大范围到小范围
环境 → 区域 → 服务器 → 服务类型

刷新策略: 子变量要设置为 "On Variable Change"
```

**🔹 性能优化建议**
```
🔸 不常变的变量: 选择 "On Dashboard Load"
🔸 经常变化的变量: 选择 "On Time Range Change"  
🔸 避免所有变量都设置为实时刷新
🔸 合理使用隐藏变量减少界面复杂度
```

### 7.3 常见问题与解决


**🔸 多值变量查询报错**
```
问题: 查询语句报错 "invalid operator"
原因: 使用了 = 而不是 =~
解决: 将 instance="$servers" 改为 instance=~"$servers"
```

**🔸 级联变量不更新**
```
问题: 子变量选项没有随父变量更新
原因: 刷新策略设置错误
解决: 将子变量刷新策略改为 "On Variable Change"
```

**🔸 变量排序混乱**
```
问题: 数字排序不正确（1, 10, 2, 3）
原因: 按字符串排序而不是数字排序
解决: 选择 "Numerical" 排序，或使用前缀统一位数
```

**核心记忆口诀**：
- 多值选择用正则，级联依赖要刷新
- 隐藏变量藏细节，智能排序提体验
- 性能优化看场景，错误排查有方法