---
title: 6、面板与查询API
---
## 📚 目录

1. [面板与查询API基础概念](#1-面板与查询API基础概念)
2. [查询接口详解](#2-查询接口详解)
3. [数据源代理机制](#3-数据源代理机制)
4. [面板配置管理](#4-面板配置管理)
5. [查询参数与变量](#5-查询参数与变量)
6. [图表样式配置](#6-图表样式配置)
7. [高级功能配置](#7-高级功能配置)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 📊 面板与查询API基础概念


### 1.1 什么是面板与查询API


**🔸 简单理解**
想象你在用手机看股票APP，屏幕上有各种图表显示股价走势。Grafana的面板就像这些图表，而查询API就是获取数据并展示在图表上的"后台助手"。

```
现实场景对比：
📱 手机股票APP     →     🖥️ Grafana面板
📈 股价走势图      →     📊 监控图表  
🔄 刷新获取数据    →     🔌 查询API调用
📋 图表设置       →     ⚙️ 面板配置
```

**💡 核心作用**
- **数据获取**：从各种数据源（数据库、监控系统）拉取数据
- **数据展示**：将数据转换成图表、表格等可视化形式
- **实时更新**：定时刷新数据，保持信息最新
- **交互控制**：通过API动态调整图表配置

### 1.2 API体系架构


**🏗️ 整体架构图**
```
用户界面层
    ↓
┌─────────────────────────────────┐
│        Grafana前端              │
├─────────────────────────────────┤
│     📊 /api/query              │ ← 查询接口
│     🔌 /api/datasources/proxy  │ ← 数据源代理  
│     ⚙️ /api/panels             │ ← 面板管理
├─────────────────────────────────┤
│       Grafana后端服务           │
└─────────────────────────────────┘
    ↓
数据源层（MySQL、InfluxDB、Prometheus等）
```

**🔹 主要API分类**
- **查询类API**：获取监控数据
- **配置类API**：管理面板设置
- **代理类API**：连接外部数据源
- **样式类API**：控制图表外观

---

## 2. 🔍 查询接口详解


### 2.1 /api/query - 核心查询接口


**🎯 接口作用**
这是Grafana最重要的接口，就像是"数据的搬运工"，负责从数据源获取数据并返回给前端展示。

**📋 基本用法**
```bash
# 基础查询示例
curl -X POST \
  http://localhost:3000/api/query \
  -H "Authorization: Bearer your-api-key" \
  -H "Content-Type: application/json" \
  -d '{
    "queries": [
      {
        "refId": "A",
        "datasource": {
          "type": "prometheus",
          "uid": "prometheus-uid"
        },
        "expr": "cpu_usage_percent",
        "format": "time_series"
      }
    ],
    "range": {
      "from": "now-1h",
      "to": "now"
    }
  }'
```

### 2.2 查询参数详解


**🔸 核心参数说明**

| 参数名 | 作用 | 示例值 | 说明 |
|-------|------|--------|------|
| `queries` | 查询配置数组 | `[{refId: "A", ...}]` | 可以同时执行多个查询 |
| `range` | 时间范围 | `{from: "now-1h", to: "now"}` | 指定查询的时间窗口 |
| `maxDataPoints` | 最大数据点 | `1000` | 控制返回数据的密度 |
| `intervalMs` | 时间间隔 | `60000` | 数据点之间的时间间隔(毫秒) |

**💭 参数理解**
- `refId`：就像给查询起个名字，方便识别
- `from/to`：就像设定"从什么时候到什么时候"的数据
- `maxDataPoints`：避免返回太多数据点，保证页面不卡顿

### 2.3 时间范围参数


**⏰ 常用时间表达式**

```javascript
// 相对时间（推荐使用）
{
  "from": "now-5m",     // 5分钟前
  "to": "now"           // 现在
}

// 绝对时间
{
  "from": "2024-01-01T00:00:00Z",
  "to": "2024-01-01T23:59:59Z"
}

// 更多时间表达式
"now-1h"    // 1小时前
"now-1d"    // 1天前  
"now-1w"    // 1周前
"now-1M"    // 1个月前
```

**🎯 实际应用场景**
- **实时监控**：`now-5m` to `now` （最近5分钟）
- **历史分析**：`now-24h` to `now` （最近24小时）
- **故障排查**：指定具体时间段

---

## 3. 🔌 数据源代理机制


### 3.1 /api/datasources/proxy 接口


**🔸 什么是数据源代理**
想象你要从不同的商店买东西，但每个商店的"语言"都不一样。数据源代理就像是"翻译官"，帮你和不同的数据源进行沟通。

```
数据流向图：
Grafana前端 → 数据源代理 → 具体数据源（Prometheus/MySQL等）
     ↑                              ↓
     └──── 统一格式的数据 ←──── 原始数据格式
```

**📋 基本语法**
```bash
# 通过代理查询Prometheus
curl -X GET \
  "http://localhost:3000/api/datasources/proxy/1/api/v1/query?query=up" \
  -H "Authorization: Bearer your-api-key"

# URL结构解释：
# /api/datasources/proxy/{datasource-id}/{datasource-specific-path}
```

### 3.2 代理配置参数


**🔧 常用配置项**

```json
{
  "datasource": {
    "type": "prometheus",        // 数据源类型
    "uid": "prometheus-uid",     // 数据源唯一标识
    "url": "http://prometheus:9090"  // 数据源地址
  },
  "timeout": "30s",              // 超时时间
  "httpHeaderName1": "value1"    // 自定义HTTP头
}
```

**💡 为什么需要代理**
- **统一接口**：不同数据源用统一的方式访问
- **安全控制**：通过Grafana进行权限控制
- **协议转换**：处理不同数据源的协议差异
- **缓存优化**：可以对查询结果进行缓存

---

## 4. ⚙️ 面板配置管理


### 4.1 面板配置JSON结构


**🔸 面板配置的本质**
面板配置就像是"装修图纸"，详细描述了这个图表要长什么样、显示什么数据、用什么颜色等等。

**📋 基础配置结构**
```json
{
  "id": 1,
  "title": "CPU使用率",
  "type": "graph",              // 图表类型
  "targets": [                  // 数据查询配置
    {
      "refId": "A",
      "expr": "cpu_usage_percent",
      "legendFormat": "CPU使用率 {{instance}}"
    }
  ],
  "xAxis": {                    // X轴配置
    "show": true,
    "mode": "time"
  },
  "yAxes": [                    // Y轴配置
    {
      "label": "百分比",
      "min": 0,
      "max": 100,
      "unit": "percent"
    }
  ],
  "legend": {                   // 图例配置
    "show": true,
    "values": true,
    "current": true
  }
}
```

### 4.2 图表类型配置


**📊 常用图表类型对比**

| 图表类型 | 适用场景 | 配置要点 | 示例用途 |
|---------|---------|---------|---------|
| `graph` | 时序数据 | 时间轴、多条线 | CPU使用率趋势 |
| `singlestat` | 单一指标 | 阈值、颜色 | 当前内存使用量 |
| `table` | 列表数据 | 列配置、排序 | 服务器列表 |
| `heatmap` | 热力图 | 颜色映射 | 响应时间分布 |

**🎨 图表类型选择指南**
- **看趋势**：用折线图（graph）
- **看当前值**：用单一指标（singlestat）
- **看列表**：用表格（table）
- **看分布**：用热力图（heatmap）

### 4.3 阈值设置API


**⚠️ 什么是阈值**
阈值就像是"警戒线"，当数值超过这条线时，图表会变色提醒你注意。

```json
{
  "thresholds": [
    {
      "value": 80,              // 阈值
      "color": "orange",        // 超过80%显示橙色
      "op": "gt"                // gt表示"大于"
    },
    {
      "value": 95,
      "color": "red",           // 超过95%显示红色
      "op": "gt"
    }
  ]
}
```

**🚨 阈值应用场景**
- **性能监控**：CPU > 80% 显示警告
- **容量管理**：磁盘使用 > 90% 显示危险
- **业务指标**：订单量 < 100 显示异常

---

## 5. 🔄 查询参数与变量


### 5.1 变量替换API


**🔸 什么是变量**
变量就像是"占位符"，可以让一个查询模板适用于不同的情况。比如同一个CPU监控图表，可以通过变量切换显示不同服务器的数据。

**📋 变量定义示例**
```json
{
  "templating": {
    "list": [
      {
        "name": "server",           // 变量名
        "type": "query",            // 变量类型
        "query": "label_values(instance)",  // 获取所有服务器实例
        "multi": true,              // 允许多选
        "includeAll": true          // 包含"全部"选项
      }
    ]
  }
}
```

**🔧 变量使用方式**
```bash
# 在查询中使用变量
curl -X POST \
  http://localhost:3000/api/query \
  -d '{
    "queries": [
      {
        "expr": "cpu_usage{instance=\"$server\"}",  // $server会被替换
        "refId": "A"
      }
    ]
  }'
```

### 5.2 查询缓存管理


**💾 缓存机制理解**
缓存就像是"备忘录"，把之前查询的结果暂时保存起来，下次相同查询时直接返回结果，不用重新去数据源获取。

**⚙️ 缓存配置参数**

| 参数 | 作用 | 建议值 | 说明 |
|-----|------|--------|------|
| `cacheTimeout` | 缓存过期时间 | `60s` | 数据更新不频繁时可设长一些 |
| `maxCacheSize` | 最大缓存大小 | `100MB` | 根据内存情况调整 |
| `cacheKey` | 缓存键 | 自动生成 | 通常不需要手动设置 |

---

## 6. 🎨 图表样式配置


### 6.1 面板样式配置


**🔸 样式配置的作用**
样式配置就像是给图表"化妆"，让数据展示更美观、更容易理解。

**🎨 基础样式配置**
```json
{
  "fieldConfig": {
    "defaults": {
      "color": {
        "mode": "palette-classic"    // 颜色模式
      },
      "custom": {
        "drawStyle": "line",         // 绘制样式：线条
        "lineInterpolation": "linear", // 线条插值
        "lineWidth": 2,              // 线条宽度
        "fillOpacity": 10,           // 填充透明度
        "pointSize": 5               // 数据点大小
      }
    }
  }
}
```

### 6.2 颜色配置


**🌈 颜色配置选项**

```json
{
  "color": {
    "mode": "palette-classic",       // 经典调色板
    "fixedColor": "green",          // 固定颜色
    "seriesBy": "last"              // 按最后值着色
  }
}
```

**🎯 颜色选择建议**
- **绿色**：正常状态、成功指标
- **黄色/橙色**：警告状态
- **红色**：错误状态、危险指标
- **蓝色**：中性指标、默认颜色

### 6.3 图例配置


**📋 图例配置参数**
```json
{
  "legend": {
    "displayMode": "table",        // 显示模式：table/list
    "placement": "bottom",         // 位置：bottom/right
    "values": ["current", "max", "min"],  // 显示的值
    "calcs": ["mean", "lastNotNull"]      // 计算方式
  }
}
```

### 6.4 轴配置参数


**📊 坐标轴详细配置**
```json
{
  "fieldConfig": {
    "defaults": {
      "custom": {
        "axisPlacement": "left",     // 轴位置
        "axisLabel": "使用率(%)",     // 轴标签
        "scaleDistribution": {
          "type": "linear"           // 刻度分布：linear/log
        }
      },
      "min": 0,                      // 最小值
      "max": 100,                    // 最大值
      "unit": "percent"              // 单位
    }
  }
}
```

---

## 7. 🚀 高级功能配置


### 7.1 面板链接配置


**🔗 什么是面板链接**
面板链接就像是网页中的超链接，点击图表可以跳转到相关的详细页面或其他仪表板。

**📋 链接配置示例**
```json
{
  "links": [
    {
      "title": "查看详细信息",
      "url": "/d/detail-dashboard?var-server=${__field.labels.instance}",
      "targetBlank": true,           // 新窗口打开
      "tooltip": "点击查看服务器详情"
    }
  ]
}
```

### 7.2 重复面板API


**🔄 重复面板的用途**
当你有多台服务器需要监控时，不用手动创建多个相同的面板，可以用重复面板功能自动生成。

**⚙️ 重复配置**
```json
{
  "repeat": "server",              // 基于server变量重复
  "repeatDirection": "h",          // 水平重复：h，垂直重复：v
  "maxPerRow": 4                   // 每行最多4个面板
}
```

### 7.3 单位设置


**📏 常用单位配置**

| 单位类别 | 单位值 | 显示效果 | 使用场景 |
|---------|--------|---------|---------|
| 数据量 | `bytes` | 1024 B | 内存、磁盘使用 |
| 时间 | `ms` | 100 ms | 响应时间 |
| 百分比 | `percent` | 85% | CPU使用率 |
| 频率 | `reqps` | 1000 req/s | 请求量 |

**📋 单位配置示例**
```json
{
  "fieldConfig": {
    "defaults": {
      "unit": "bytes",             // 字节单位
      "decimals": 2                // 小数位数
    }
  }
}
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心概念


```
🔸 查询接口：/api/query是获取数据的核心，掌握查询参数配置
🔸 数据源代理：/api/datasources/proxy统一不同数据源的访问方式
🔸 面板配置：JSON格式定义图表的所有展示效果
🔸 时间范围：now-1h这样的相对时间表达式很实用
🔸 变量系统：$变量名实现查询模板的动态替换
🔸 样式配置：颜色、轴、图例等让图表更美观易读
```

### 8.2 关键理解要点


**🔹 API调用流程**
```
用户操作界面 → 前端发起API请求 → 后端处理查询 → 数据源获取数据 → 返回结果展示
```

**🔹 配置优先级**
```
面板级配置 > 仪表板级配置 > 全局配置
（越具体的配置优先级越高）
```

**🔹 性能优化要点**
- 合理设置`maxDataPoints`避免数据过多
- 使用缓存减少重复查询
- 选择合适的时间范围
- 避免过于复杂的查询表达式

### 8.3 实际应用指导


**🎯 新手入门建议**
1. **先掌握基础查询**：从简单的`/api/query`开始
2. **理解时间参数**：`now-1h`比绝对时间更实用
3. **学会看配置JSON**：理解面板配置的结构
4. **多用变量**：提高仪表板的复用性

**💡 常见应用场景**
- **系统监控**：CPU、内存、网络使用情况
- **业务监控**：订单量、用户活跃度、收入指标  
- **应用监控**：响应时间、错误率、吞吐量
- **基础设施监控**：服务器状态、数据库性能

**🔧 实战技巧**
- **善用变量**：一个模板适配多种场景
- **合理分组**：相关指标放在同一个面板
- **设置阈值**：重要指标必须有告警线
- **优化查询**：避免查询时间过长影响用户体验

**核心记忆**：
- 查询接口获取数据，代理接口连接数据源
- 面板配置决定显示效果，变量实现动态查询
- 样式配置让图表美观，缓存配置提升性能
- 掌握这些API，就能灵活操控Grafana的数据展示