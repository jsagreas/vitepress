---
title: 4、数据源管理API
---
## 📚 目录

1. [数据源管理基础概念](#1-数据源管理基础概念)
2. [数据源基本操作API](#2-数据源基本操作API)
3. [常见数据源类型配置](#3-常见数据源类型配置)
4. [数据源连接与测试](#4-数据源连接与测试)
5. [数据源查询与代理](#5-数据源查询与代理)
6. [权限与安全配置](#6-权限与安全配置)
7. [数据源监控与维护](#7-数据源监控与维护)
8. [实用技巧与最佳实践](#8-实用技巧与最佳实践)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 📊 数据源管理基础概念


### 1.1 什么是Grafana数据源


**通俗理解**：数据源就像是Grafana的"眼睛"，它告诉Grafana去哪里"看"数据。

```
简单比喻：
如果Grafana是一个电视机📺
那么数据源就是电视信号源📡
- 有线电视信号 → Prometheus数据源
- 卫星信号     → InfluxDB数据源  
- 网络信号     → MySQL数据源
```

**数据源的作用**：
- 🔗 **连接桥梁**：连接Grafana和各种数据库或监控系统
- 📈 **数据获取**：从外部系统获取监控数据
- 🔄 **格式转换**：将不同格式的数据转换为Grafana可识别的格式

### 1.2 数据源管理API概述


**API基础路径**：`/api/datasources`

**主要功能类别**：
```
数据源管理架构：
┌─────────────────┐
│   Grafana UI    │ ← 用户界面操作
├─────────────────┤
│   数据源API     │ ← /api/datasources
├─────────────────┤
│   数据源驱动    │ ← 各种数据源插件
├─────────────────┤
│   外部数据系统   │ ← Prometheus/MySQL等
└─────────────────┘
```

### 1.3 为什么需要数据源管理API


**实际应用场景**：

> 💡 **想象场景**：你管理着100台服务器的监控系统，每次新增服务器都要手动在Grafana界面添加数据源，这会很麻烦。有了API，你可以写个脚本自动化完成！

**API的优势**：
- ⚡ **自动化**：批量创建和管理数据源
- 🔧 **集成**：与DevOps流程无缝集成
- 📋 **备份**：通过代码管理数据源配置
- 🚀 **效率**：减少重复手动操作

---

## 2. 🔧 数据源基本操作API


### 2.1 获取数据源列表


**API接口**：`GET /api/datasources`

**用途说明**：获取当前Grafana中所有已配置的数据源信息

```bash
# 获取所有数据源
curl -H "Authorization: Bearer YOUR_API_KEY" \
     http://localhost:3000/api/datasources
```

**响应数据结构**：
```json
[
  {
    "id": 1,
    "name": "prometheus-prod",
    "type": "prometheus",
    "url": "http://localhost:9090",
    "isDefault": true,
    "access": "proxy"
  }
]
```

**字段含义解释**：
- `id`：数据源的唯一标识符（系统自动生成）
- `name`：数据源名称（用户自定义，要见名知意）
- `type`：数据源类型（如prometheus、mysql、influxdb等）
- `url`：数据源的访问地址
- `isDefault`：是否为默认数据源
- `access`：访问模式（proxy代理模式 或 direct直连模式）

### 2.2 创建新数据源


**API接口**：`POST /api/datasources`

**请求示例**：
```bash
curl -X POST \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "my-prometheus",
    "type": "prometheus", 
    "url": "http://prometheus:9090",
    "access": "proxy",
    "isDefault": false
  }' \
  http://localhost:3000/api/datasources
```

> ⚠️ **重要提醒**：数据源名称在同一个Grafana实例中必须唯一，就像人的身份证号一样！

### 2.3 更新数据源配置


**API接口**：`PUT /api/datasources/{id}`

**使用场景**：当你需要修改数据源的地址、认证信息等配置时使用

```bash
curl -X PUT \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "id": 1,
    "name": "prometheus-updated",
    "type": "prometheus",
    "url": "http://new-prometheus:9090"
  }' \
  http://localhost:3000/api/datasources/1
```

### 2.4 删除数据源


**API接口**：`DELETE /api/datasources/{id}`

> ⚠️ **删除警告**：删除数据源会影响所有使用该数据源的仪表板，请谨慎操作！

```bash
curl -X DELETE \
  -H "Authorization: Bearer YOUR_API_KEY" \
  http://localhost:3000/api/datasources/1
```

---

## 3. 🗄️ 常见数据源类型配置


### 3.1 Prometheus数据源配置


**Prometheus简介**：一个开源的监控和警报系统，特别适合监控微服务和容器化应用。

**配置参数详解**：
```json
{
  "name": "prometheus-main",
  "type": "prometheus",
  "url": "http://prometheus:9090",
  "access": "proxy",
  "basicAuth": false,
  "jsonData": {
    "httpMethod": "POST",
    "timeInterval": "30s",
    "queryTimeout": "60s"
  }
}
```

**参数说明**：
- `httpMethod`：查询方法，推荐使用POST（支持长查询）
- `timeInterval`：数据抓取间隔，影响查询精度
- `queryTimeout`：查询超时时间，避免长时间等待

### 3.2 InfluxDB数据源配置


**InfluxDB简介**：专门用于时间序列数据的数据库，常用于IoT设备监控。

```json
{
  "name": "influxdb-sensor",
  "type": "influxdb", 
  "url": "http://influxdb:8086",
  "database": "sensors",
  "user": "grafana",
  "secureJsonData": {
    "password": "your_password"
  },
  "jsonData": {
    "timeInterval": "10s",
    "httpMode": "POST"
  }
}
```

**关键配置项**：
- `database`：InfluxDB数据库名称
- `user`：数据库用户名
- `password`：存储在secureJsonData中，保证安全性

### 3.3 MySQL数据源配置


**MySQL数据源用途**：主要用于业务数据分析，如用户统计、订单趋势等。

```json
{
  "name": "mysql-business",
  "type": "mysql",
  "url": "mysql-server:3306",
  "database": "business_db",
  "user": "grafana_user",
  "secureJsonData": {
    "password": "secure_password"
  },
  "jsonData": {
    "maxOpenConns": 100,
    "maxIdleConns": 10,
    "connMaxLifetime": 14400
  }
}
```

**连接池参数解释**：
- `maxOpenConns`：最大连接数（避免数据库过载）
- `maxIdleConns`：空闲连接数（提高响应速度）
- `connMaxLifetime`：连接生存时间（秒）

---

## 4. 🔍 数据源连接与测试


### 4.1 数据源连接测试API


**API接口**：`POST /api/datasources/proxy/{id}/api/v1/query`

**用途**：验证数据源是否可以正常连接和查询数据

```bash
# 测试Prometheus数据源连接
curl -X POST \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{"query": "up"}' \
  http://localhost:3000/api/datasources/proxy/1/api/v1/query
```

### 4.2 数据源健康检查


**自定义健康检查脚本**：
```bash
#!/bin/bash
# 数据源健康检查脚本

check_datasource() {
    local ds_id=$1
    local ds_name=$2
    
    echo "🔍 检查数据源: $ds_name (ID: $ds_id)"
    
    response=$(curl -s -w "%{http_code}" \
        -H "Authorization: Bearer $API_KEY" \
        "http://localhost:3000/api/datasources/$ds_id")
    
    if [[ "$response" == *"200" ]]; then
        echo "✅ $ds_name 连接正常"
    else
        echo "❌ $ds_name 连接异常"
    fi
}
```

### 4.3 连接问题排查


**常见连接问题及解决方案**：

| 问题现象 | 可能原因 | 解决方法 |
|---------|---------|---------|
| `连接超时` | 网络不通或防火墙阻断 | 检查网络连通性和端口开放 |
| `认证失败` | 用户名密码错误 | 验证认证信息正确性 |
| `SSL错误` | 证书配置问题 | 检查SSL证书配置 |
| `数据库不存在` | 数据库名称错误 | 确认数据库名称正确 |

> 🔧 **排查技巧**：使用Grafana的日志功能，查看详细错误信息来定位问题根源

---

## 5. 📡 数据源查询与代理


### 5.1 数据源代理模式


**代理模式工作原理**：
```
客户端请求流程：
浏览器 → Grafana前端 → Grafana后端 → 数据源
   ↑                                      ↓
   ←─────────── 返回数据 ←─────────────────┘
```

**代理模式的优势**：
- 🔒 **安全性**：数据源不直接暴露给浏览器
- 🎯 **统一认证**：通过Grafana统一管理访问权限
- 🚀 **缓存优化**：Grafana可以缓存查询结果

### 5.2 查询API使用


**通用查询接口**：`POST /api/datasources/proxy/{id}/*`

**Prometheus查询示例**：
```bash
# 查询CPU使用率
curl -X POST \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "query": "cpu_usage_percent",
    "time": "2023-09-21T10:00:00Z"
  }' \
  http://localhost:3000/api/datasources/proxy/1/api/v1/query
```

**MySQL查询示例**：
```bash
# 查询用户数量统计
curl -X POST \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "rawSql": "SELECT COUNT(*) as user_count FROM users WHERE created_at >= NOW() - INTERVAL 1 DAY"
  }' \
  http://localhost:3000/api/datasources/proxy/2/query
```

### 5.3 查询优化建议


**查询性能优化**：

> 💡 **优化技巧**：
> - 使用时间范围限制，避免查询过大数据集
> - 合理使用聚合函数，减少数据传输量
> - 设置合适的查询超时时间
> - 利用Grafana缓存机制

**查询超时配置**：
```json
{
  "jsonData": {
    "queryTimeout": "30s",
    "timeInterval": "15s"
  }
}
```

---

## 6. 🔐 权限与安全配置


### 6.1 认证信息管理


**基础认证配置**：
```json
{
  "basicAuth": true,
  "basicAuthUser": "username",
  "secureJsonData": {
    "basicAuthPassword": "password"
  }
}
```

**Token认证配置**：
```json
{
  "jsonData": {
    "tokenAuth": true
  },
  "secureJsonData": {
    "token": "your_api_token"
  }
}
```

> 🔒 **安全提醒**：敏感信息（如密码、Token）务必使用`secureJsonData`字段，这样信息会被加密存储

### 6.2 SSL证书配置


**启用SSL连接**：
```json
{
  "jsonData": {
    "tlsAuth": true,
    "tlsAuthWithCACert": true,
    "tlsSkipVerify": false
  },
  "secureJsonData": {
    "tlsCACert": "-----BEGIN CERTIFICATE-----\n...",
    "tlsClientCert": "-----BEGIN CERTIFICATE-----\n...",
    "tlsClientKey": "-----BEGIN PRIVATE KEY-----\n..."
  }
}
```

**SSL配置说明**：
- `tlsSkipVerify`：是否跳过证书验证（生产环境建议false）
- `tlsCACert`：CA证书内容
- `tlsClientCert`：客户端证书
- `tlsClientKey`：客户端私钥

### 6.3 数据源权限控制


**权限等级说明**：
```
权限层级：
┌─────────────────┐
│   Admin         │ ← 完全控制（增删改查）
├─────────────────┤
│   Editor        │ ← 编辑权限（改查）
├─────────────────┤
│   Viewer        │ ← 只读权限（查）
└─────────────────┘
```

**API权限要求**：
- 创建/删除数据源：需要`Admin`权限
- 修改数据源配置：需要`Editor`权限  
- 查询数据源：需要`Viewer`权限

---

## 7. 📊 数据源监控与维护


### 7.1 数据源状态监控


**监控脚本示例**：
```bash
#!/bin/bash
# 数据源状态监控脚本

API_KEY="your_api_key"
GRAFANA_URL="http://localhost:3000"

echo "📊 开始检查数据源状态..."

# 获取所有数据源
datasources=$(curl -s -H "Authorization: Bearer $API_KEY" \
    "$GRAFANA_URL/api/datasources")

echo "$datasources" | jq -r '.[] | "\(.id) \(.name) \(.type)"' | \
while read id name type; do
    echo "🔍 检查: $name ($type)"
    
    # 这里可以添加具体的健康检查逻辑
    # 比如发送测试查询，检查响应时间等
done
```

### 7.2 批量数据源管理


**批量创建数据源**：
```bash
#!/bin/bash
# 批量创建Prometheus数据源

declare -a servers=(
    "prometheus-1:9090"
    "prometheus-2:9090" 
    "prometheus-3:9090"
)

for server in "${servers[@]}"; do
    name="prometheus-${server%:*}"
    url="http://$server"
    
    echo "创建数据源: $name"
    curl -X POST \
        -H "Authorization: Bearer $API_KEY" \
        -H "Content-Type: application/json" \
        -d "{
            \"name\": \"$name\",
            \"type\": \"prometheus\",
            \"url\": \"$url\",
            \"access\": \"proxy\"
        }" \
        "$GRAFANA_URL/api/datasources"
done
```

### 7.3 数据源备份与恢复


**备份数据源配置**：
```bash
#!/bin/bash
# 备份所有数据源配置

backup_file="datasources_backup_$(date +%Y%m%d_%H%M%S).json"

curl -H "Authorization: Bearer $API_KEY" \
    "$GRAFANA_URL/api/datasources" > "$backup_file"

echo "✅ 数据源配置已备份到: $backup_file"
```

**恢复数据源配置**：
```bash
#!/bin/bash
# 从备份文件恢复数据源

backup_file="$1"

if [[ ! -f "$backup_file" ]]; then
    echo "❌ 备份文件不存在: $backup_file"
    exit 1
fi

# 读取备份文件并重建数据源
jq -c '.[]' "$backup_file" | while read datasource; do
    # 移除id字段，让系统自动分配新的id
    cleaned=$(echo "$datasource" | jq 'del(.id)')
    
    curl -X POST \
        -H "Authorization: Bearer $API_KEY" \
        -H "Content-Type: application/json" \
        -d "$cleaned" \
        "$GRAFANA_URL/api/datasources"
done
```

---

## 8. 💡 实用技巧与最佳实践


### 8.1 数据源命名规范


**推荐命名格式**：
```
命名模式：{环境}-{类型}-{用途}

示例：
- prod-prometheus-k8s      (生产环境Kubernetes监控)
- test-mysql-orders        (测试环境订单数据库)
- dev-influxdb-sensors     (开发环境传感器数据)
```

**命名规范的好处**：
- 🎯 **易识别**：一眼就能看出数据源用途
- 📋 **好管理**：按环境和类型分类管理
- 🔧 **易维护**：批量操作时便于筛选

### 8.2 环境配置管理


**多环境配置策略**：
```bash
# 配置文件方式管理不同环境
cat > config/dev.json << EOF
{
  "datasources": [
    {
      "name": "dev-prometheus",
      "url": "http://dev-prometheus:9090"
    }
  ]
}
EOF

cat > config/prod.json << EOF  
{
  "datasources": [
    {
      "name": "prod-prometheus", 
      "url": "http://prod-prometheus:9090"
    }
  ]
}
EOF
```

### 8.3 自动化部署脚本


**完整部署脚本**：
```bash
#!/bin/bash
# Grafana数据源自动化部署脚本

set -e  # 遇到错误立即退出

ENVIRONMENT=${1:-dev}
CONFIG_FILE="config/${ENVIRONMENT}.json"

echo "🚀 开始部署 $ENVIRONMENT 环境数据源..."

# 检查配置文件
if [[ ! -f "$CONFIG_FILE" ]]; then
    echo "❌ 配置文件不存在: $CONFIG_FILE"
    exit 1
fi

# 读取并创建数据源
jq -c '.datasources[]' "$CONFIG_FILE" | while read datasource; do
    name=$(echo "$datasource" | jq -r '.name')
    echo "📊 创建数据源: $name"
    
    response=$(curl -s -w "%{http_code}" \
        -X POST \
        -H "Authorization: Bearer $API_KEY" \
        -H "Content-Type: application/json" \
        -d "$datasource" \
        "$GRAFANA_URL/api/datasources")
    
    http_code="${response: -3}"
    
    if [[ "$http_code" == "200" ]]; then
        echo "✅ $name 创建成功"
    else
        echo "❌ $name 创建失败 (HTTP: $http_code)"
    fi
done

echo "🎉 部署完成!"
```

### 8.4 常见问题解决方案


**问题诊断清单**：

> 📋 **连接问题排查步骤**：
> 1. **网络连通性**：`ping` 或 `telnet` 测试目标地址
> 2. **端口开放**：确认防火墙和安全组设置
> 3. **认证信息**：验证用户名、密码、Token等
> 4. **SSL配置**：检查证书有效性和配置正确性
> 5. **Grafana日志**：查看详细错误信息

**性能优化技巧**：
- ⏱️ **查询超时**：根据数据源响应速度合理设置
- 🔄 **连接池**：适当调整连接池大小
- 📊 **查询优化**：避免全表扫描和大范围时间查询
- 💾 **缓存策略**：合理利用Grafana查询缓存

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的核心概念


```
🔸 数据源API：/api/datasources 基础路径
🔸 基本操作：增删改查四大核心功能
🔸 常见类型：Prometheus、InfluxDB、MySQL配置
🔸 安全认证：basicAuth、Token、SSL证书配置
🔸 代理模式：Grafana作为数据查询代理
🔸 健康检查：定期监控数据源连接状态
```

### 9.2 关键理解要点


**🔹 数据源的本质作用**：
```
数据源 = 数据获取的桥梁
- 不是存储数据的地方
- 而是告诉Grafana去哪里取数据
- 类似于电视的信号源选择
```

**🔹 API vs 界面操作的区别**：
```
API操作优势：
✅ 自动化：批量操作，提高效率
✅ 版本控制：配置即代码，便于管理
✅ 集成性：与DevOps流程无缝集成
✅ 一致性：避免手动操作的人为错误
```

**🔹 安全配置的重要性**：
```
安全配置原则：
🔒 敏感信息加密：使用secureJsonData
🔑 最小权限原则：只给必要的访问权限
🛡️ SSL传输：生产环境必须启用
🔍 定期审计：检查数据源访问权限
```

### 9.3 实际应用指导


**初学者使用建议**：
- 🚀 **从简单开始**：先学会基本的增删改查操作
- 📚 **理解概念**：搞清楚数据源的作用和工作原理
- 🔧 **动手实践**：在测试环境多尝试不同配置
- 📊 **监控观察**：学会查看和分析连接状态

**进阶应用方向**：
- 🤖 **自动化脚本**：编写批量管理脚本
- 🔄 **CI/CD集成**：将数据源配置纳入部署流程
- 📈 **监控告警**：建立数据源健康监控机制
- 🔧 **性能调优**：优化查询性能和连接配置

**避免常见错误**：
- ❌ **硬编码密码**：不要在脚本中明文写密码
- ❌ **忽略SSL**：生产环境务必启用安全传输
- ❌ **权限过大**：遵循最小权限原则
- ❌ **缺乏监控**：要定期检查数据源状态

**核心记忆口诀**：
- 数据源管理有门道，API操作效率高
- 安全配置不能少，监控检查要做好
- 自动化脚本是趋势，批量管理显神威