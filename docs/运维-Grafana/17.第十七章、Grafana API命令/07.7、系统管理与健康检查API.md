---
title: 7、系统管理与健康检查API
---
## 📚 目录

1. [健康检查API基础](#1-健康检查API基础)
2. [系统管理核心API](#2-系统管理核心API)
3. [统计信息与监控](#3-统计信息与监控)
4. [插件与许可证管理](#4-插件与许可证管理)
5. [系统配置与维护](#5-系统配置与维护)
6. [性能监控与诊断](#6-性能监控与诊断)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 🏥 健康检查API基础


### 1.1 什么是健康检查API


**简单理解**：健康检查就像给Grafana"量体温"，看看系统是否正常运行。

```
生活类比：
就像医生给病人检查身体一样
- 测量体温、血压、心跳
- 看各个器官是否正常工作
- 发现问题及时处理

Grafana健康检查：
- 检查服务是否启动
- 检查数据库连接是否正常
- 检查内存、CPU使用情况
- 发现异常立即报警
```

### 1.2 基础健康检查端点


**🔸 核心API：`/api/health`**
```bash
# 最简单的健康检查
curl http://localhost:3000/api/health

# 返回结果示例
{
  "commit": "abc123",
  "database": "ok", 
  "version": "9.5.2"
}
```

**响应状态说明**：
```
HTTP 200 ✅ 系统正常
- database: "ok" → 数据库连接正常
- version: "9.5.2" → 当前版本信息

HTTP 503 ❌ 系统异常  
- database: "failing" → 数据库连接失败
- 需要立即检查数据库状态
```

### 1.3 详细健康状态检查


**更详细的健康信息**：
```bash
# 获取详细健康状态
curl http://localhost:3000/api/health/detailed

# 返回详细信息
{
  "status": "ok",
  "checks": {
    "database": {
      "status": "ok",
      "message": "Database connection successful"
    },
    "plugin_health": {
      "status": "ok", 
      "message": "All plugins loaded successfully"
    },
    "alerting": {
      "status": "ok",
      "message": "Alerting service running"
    }
  }
}
```

**健康检查实际应用**：
```
负载均衡器配置：
- 定期调用 /api/health
- 如果返回503，暂停流量转发
- 避免用户访问故障节点

监控系统集成：
- 每30秒检查一次健康状态
- 状态异常时发送告警
- 自动记录故障时间和恢复时间
```

---

## 2. 🔧 系统管理核心API


### 2.1 系统管理权限说明


**管理员权限要求**：
```
系统管理API需要特殊权限：
✅ 需要Admin角色或特定权限
✅ 通常需要API Token认证  
✅ 某些操作需要服务器管理员权限

权限示例：
- 普通用户：只能查看自己的仪表板
- 管理员：可以查看系统统计、管理用户
- 服务器管理员：可以重启服务、修改配置
```

### 2.2 系统信息获取


**🔸 获取版本信息：`/api/admin/settings`**
```bash
# 获取系统配置信息（需要管理员权限）
curl -H "Authorization: Bearer your-api-token" \
     http://localhost:3000/api/admin/settings

# 返回系统配置概要
{
  "DEFAULT": {
    "app_mode": "production",
    "instance_name": "Grafana"
  },
  "server": {
    "http_port": "3000",
    "domain": "localhost"
  }
}
```

**🔸 系统统计信息：`/api/admin/stats`**
```bash
# 获取系统使用统计
curl -H "Authorization: Bearer your-api-token" \
     http://localhost:3000/api/admin/stats

# 统计信息示例
{
  "users": 25,           # 用户总数
  "dashboards": 150,     # 仪表板总数
  "datasources": 8,      # 数据源总数
  "alerts": 45,          # 告警规则总数
  "orgs": 3,            # 组织总数
  "playlists": 2        # 播放列表总数
}
```

### 2.3 用户会话管理


**会话就是用户登录状态**：
```
什么是会话？
- 用户登录后，系统记住用户身份的机制
- 就像进入商场后的临时手环
- 会话过期就需要重新登录

会话管理的作用：
- 查看当前在线用户
- 强制某个用户下线
- 清理过期会话
```

**🔸 查看活跃会话：`/api/admin/user-auth-tokens`**
```bash
# 查看所有用户的登录会话
curl -H "Authorization: Bearer your-api-token" \
     http://localhost:3000/api/admin/user-auth-tokens

# 会话信息示例
[
  {
    "id": 1,
    "userId": 1,
    "clientIp": "192.168.1.100",
    "userAgent": "Mozilla/5.0...",
    "createdAt": "2023-12-01T10:00:00Z",
    "seenAt": "2023-12-01T14:30:00Z"
  }
]
```

---

## 3. 📊 统计信息与监控


### 3.1 系统统计API详解


**🔸 核心统计API：`/api/stats`**
```bash
# 获取基础统计信息（无需特殊权限）
curl http://localhost:3000/api/stats

# 基础统计返回
{
  "dashboards": 150,
  "datasources": 8, 
  "users": 25,
  "admins": 3,
  "orgs": 1,
  "playlists": 2,
  "stars": 89
}
```

**统计信息的实际意义**：
```
dashboards: 150  → 总仪表板数量，反映系统使用规模
users: 25        → 注册用户数，了解用户基数
datasources: 8   → 数据源数量，了解数据接入情况
stars: 89        → 收藏总数，反映内容受欢迎程度
```

### 3.2 详细使用统计


**🔸 详细统计API：`/api/admin/usage-stats`**
```bash
# 获取详细使用统计（管理员权限）
curl -H "Authorization: Bearer your-api-token" \
     http://localhost:3000/api/admin/usage-stats

# 详细统计示例
{
  "stats": {
    "total_dashboards": 150,
    "total_users": 25,
    "total_orgs": 1,
    "total_datasources": 8,
    "total_db_snapshots": 5,
    "total_alerts": 45
  },
  "totals": {
    "dashboard_views_last_30_days": 2500,
    "active_users_last_30_days": 18
  }
}
```

**统计数据的管理价值**：
```
性能评估：
- 仪表板访问频率 → 了解哪些内容最受关注
- 活跃用户数量 → 评估系统实际使用情况

容量规划：
- 数据源增长趋势 → 预估存储需求
- 用户增长速度 → 规划服务器资源

运营决策：
- 低活跃仪表板 → 考虑清理或优化
- 高频访问内容 → 重点维护和优化
```

---

## 4. 🔌 插件与许可证管理


### 4.1 插件管理基础


**什么是Grafana插件**：
```
插件就像手机上的APP：
- 扩展Grafana功能
- 支持新的数据源类型
- 提供新的可视化面板
- 增加特殊功能

常见插件类型：
- 数据源插件：连接各种数据库
- 面板插件：新的图表类型
- 应用插件：完整的功能模块
```

**🔸 查看已安装插件：`/api/plugins`**
```bash
# 获取所有插件列表
curl http://localhost:3000/api/plugins

# 插件信息示例
[
  {
    "id": "prometheus",
    "name": "Prometheus",
    "type": "datasource",
    "enabled": true,
    "pinned": false,
    "info": {
      "version": "1.0.0",
      "description": "Prometheus data source"
    }
  }
]
```

### 4.2 插件详细信息


**🔸 查看特定插件：`/api/plugins/{plugin-id}`**
```bash
# 查看Prometheus插件详情
curl http://localhost:3000/api/plugins/prometheus

# 详细信息返回
{
  "id": "prometheus",
  "name": "Prometheus", 
  "type": "datasource",
  "module": "plugins/prometheus/module",
  "baseUrl": "public/plugins/prometheus",
  "info": {
    "version": "1.0.0",
    "description": "Prometheus monitoring system data source",
    "author": {
      "name": "Grafana Labs"
    },
    "logos": {
      "small": "img/prometheus_logo.svg"
    }
  },
  "enabled": true,
  "pinned": false,
  "state": "stable"
}
```

### 4.3 许可证管理


**企业版功能**：
```
许可证管理主要用于Grafana企业版：
- 控制高级功能使用
- 管理用户数量限制
- 启用企业级特性

开源版本：
- 大部分功能免费使用
- 无需许可证管理
- 功能相对基础但够用
```

**🔸 许可证信息：`/api/admin/licensing`**
```bash
# 查看许可证状态（企业版）
curl -H "Authorization: Bearer your-api-token" \
     http://localhost:3000/api/admin/licensing

# 许可证信息示例
{
  "hasValidLicense": true,
  "licenseExpiry": "2024-12-31T23:59:59Z",
  "stateInfo": "Valid license",
  "edition": "Enterprise"
}
```

---

## 5. ⚙️ 系统配置与维护


### 5.1 系统配置管理


**配置API的作用**：
```
系统配置就像电脑的设置界面：
- 修改系统行为
- 调整性能参数
- 设置安全选项
- 配置外部服务

配置管理的重要性：
- 避免直接修改配置文件
- 提供程序化配置能力
- 便于自动化部署
```

**🔸 获取系统配置：`/api/admin/settings`**
```bash
# 查看当前系统配置
curl -H "Authorization: Bearer your-api-token" \
     http://localhost:3000/api/admin/settings

# 配置信息示例（部分）
{
  "DEFAULT": {
    "app_mode": "production",
    "instance_name": "My Grafana"
  },
  "server": {
    "http_port": "3000",
    "domain": "grafana.example.com",
    "root_url": "https://grafana.example.com/"
  },
  "database": {
    "type": "mysql",
    "host": "localhost:3306"
  }
}
```

### 5.2 数据库状态检查


**为什么要检查数据库**：
```
数据库是Grafana的心脏：
- 存储所有仪表板配置
- 保存用户信息和权限
- 记录告警规则和历史
- 数据库故障会导致系统不可用

检查内容：
- 连接状态是否正常
- 响应时间是否合理
- 存储空间是否充足
```

**🔸 数据库状态：`/api/admin/stats/db`**
```bash
# 检查数据库详细状态
curl -H "Authorization: Bearer your-api-token" \
     http://localhost:3000/api/admin/stats/db

# 数据库状态示例
{
  "stats": {
    "total_dashboards": 150,
    "total_users": 25,
    "total_orgs": 1
  },
  "database": {
    "type": "mysql",
    "version": "8.0.25",
    "migration_lock": false
  }
}
```

### 5.3 日志级别管理


**日志级别的含义**：
```
日志就像系统的"日记本"：
- 记录系统运行情况
- 帮助排查问题
- 监控系统行为

日志级别说明：
🔴 ERROR  → 只记录错误，最少信息
🟡 WARN   → 记录警告和错误
🔵 INFO   → 记录一般信息（推荐）
🟢 DEBUG  → 记录详细调试信息，最多
```

**🔸 设置日志级别：`/api/admin/logger`**
```bash
# 查看当前日志设置
curl -H "Authorization: Bearer your-api-token" \
     http://localhost:3000/api/admin/logger

# 修改日志级别
curl -X PUT \
     -H "Authorization: Bearer your-api-token" \
     -H "Content-Type: application/json" \
     -d '{"level": "info"}' \
     http://localhost:3000/api/admin/logger
```

---

## 6. 📈 性能监控与诊断


### 6.1 系统性能指标


**性能监控的重要性**：
```
就像汽车仪表盘：
- 油量：内存使用情况
- 转速：CPU使用率  
- 水温：系统负载
- 及时发现性能问题

监控指标作用：
- 预防系统崩溃
- 优化资源配置
- 提升用户体验
```

**🔸 性能指标API：`/api/admin/metrics`**
```bash
# 获取系统性能指标
curl -H "Authorization: Bearer your-api-token" \
     http://localhost:3000/api/admin/metrics

# 性能指标示例
{
  "memory": {
    "heap_used": "45MB",
    "heap_total": "128MB",
    "rss": "78MB"
  },
  "process": {
    "cpu_usage": "15%",
    "uptime": "72h30m"
  },
  "requests": {
    "total": 125000,
    "rate": "50/sec"
  }
}
```

### 6.2 资源使用监控


**资源监控维度**：
```
CPU使用率：
- 正常: < 70%
- 警告: 70-85%  
- 危险: > 85%

内存使用：
- 监控堆内存使用
- 关注内存泄漏
- 预留足够空间

网络流量：
- 监控请求速率
- 识别异常流量
- 优化响应时间
```

**监控告警建议**：
```
设置监控阈值：
✅ CPU > 80% 持续5分钟 → 发送警告
✅ 内存使用 > 90% → 立即告警
✅ 响应时间 > 5秒 → 性能告警
✅ 错误率 > 5% → 立即通知

自动化响应：
- 高负载时自动扩容
- 内存不足时重启服务
- 异常流量时启用限流
```

### 6.3 维护模式管理


**什么是维护模式**：
```
维护模式就像商店的"暂停营业"：
- 暂时停止对外服务
- 进行系统维护和升级
- 保护数据完整性
- 避免用户操作干扰

使用场景：
- 系统升级时
- 数据库维护时
- 重大配置变更时
- 紧急故障处理时
```

**🔸 维护模式API：`/api/admin/pause-all-alerts`**
```bash
# 启用维护模式（暂停所有告警）
curl -X POST \
     -H "Authorization: Bearer your-api-token" \
     http://localhost:3000/api/admin/pause-all-alerts

# 恢复正常模式
curl -X POST \
     -H "Authorization: Bearer your-api-token" \
     http://localhost:3000/api/admin/unpause-all-alerts
```

---

## 7. 📋 核心要点总结


### 7.1 必须掌握的核心概念


```
🔸 健康检查：系统状态的快速诊断工具
🔸 系统管理：需要管理员权限的高级操作
🔸 统计信息：了解系统使用情况和规模
🔸 插件管理：扩展Grafana功能的机制
🔸 配置管理：程序化修改系统设置
🔸 性能监控：预防问题和优化系统
```

### 7.2 实际应用场景


**🔹 运维监控场景**
```
日常巡检：
- 每5分钟检查 /api/health
- 每小时获取系统统计
- 每天检查资源使用情况

故障处理：
- 健康检查发现异常
- 查看详细错误信息
- 分析性能指标找根因
- 必要时启用维护模式
```

**🔹 容量规划场景**
```
数据收集：
- 统计API获取使用数据
- 性能API监控资源消耗
- 分析增长趋势

决策支持：
- 用户增长 → 扩容计划
- 访问频率 → 优化重点
- 资源使用 → 硬件升级
```

### 7.3 最佳实践建议


**🔹 监控配置建议**
```
基础监控（必须）：
✅ /api/health → 每30秒检查一次
✅ 系统统计 → 每小时收集一次
✅ 性能指标 → 每5分钟采集一次

高级监控（推荐）：
✅ 用户会话 → 每天检查一次
✅ 插件状态 → 每周检查一次
✅ 日志分析 → 实时监控错误
```

**🔹 安全注意事项**
```
权限控制：
- 管理API需要严格权限控制
- API Token要定期更换
- 限制管理员账号数量

操作审计：
- 记录所有管理操作
- 监控异常API调用
- 设置操作告警
```

**🔹 故障预防策略**
```
预防措施：
- 设置合理的监控阈值
- 建立自动化告警机制
- 定期检查系统健康状态
- 制定应急响应预案

数据备份：
- 定期备份配置信息
- 导出重要仪表板
- 备份用户和权限数据
```

### 7.4 学习路径建议


**新手学习顺序**：
```
第一步：掌握健康检查API
- 理解基本概念
- 学会基础调用方法
- 了解返回结果含义

第二步：学习统计信息API  
- 获取系统使用情况
- 分析数据的含义
- 应用到实际监控

第三步：深入系统管理API
- 学习权限管理
- 掌握配置操作
- 了解维护流程

第四步：实践性能监控
- 建立监控体系
- 设置告警规则
- 优化系统性能
```

**核心记忆要点**：
- **健康检查**是监控的基础，必须优先掌握
- **统计信息**帮助了解系统规模和使用情况  
- **性能监控**是预防问题的关键手段
- **管理权限**要严格控制，确保系统安全
- **实际应用**比理论学习更重要，多动手实践