---
title: 2、prometheus-数据源
---
## 📚 目录

1. [Prometheus数据源基础概念](#1-prometheus数据源基础概念)
2. [数据源添加与基础配置](#2-数据源添加与基础配置)
3. [HTTP设置和认证详解](#3-http设置和认证详解)
4. [PromQL查询预览与调试](#4-promql查询预览与调试)
5. [指标浏览器的使用](#5-指标浏览器的使用)
6. [常用配置选项解析](#6-常用配置选项解析)
7. [性能优化设置实战](#7-性能优化设置实战)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🎯 Prometheus数据源基础概念


### 1.1 什么是Prometheus数据源


**🔸 简单理解**
想象一下，Grafana就像一个超级强大的仪表盘，而Prometheus就像是这个仪表盘的"数据供应商"。

```
现实生活类比：
汽车仪表盘 ← 显示速度、油量等信息
    ↑
传感器系统 ← 收集车辆各种数据

Grafana监控系统：
Grafana仪表盘 ← 显示CPU、内存、网络等监控图表
    ↑
Prometheus ← 收集和存储系统监控数据
```

**💡 核心作用**
- **数据收集者**：Prometheus负责从各种系统收集监控数据
- **数据存储库**：将收集到的数据按时间序列存储
- **查询接口**：提供强大的查询语言（PromQL）让Grafana获取数据

### 1.2 为什么选择Prometheus


| **优势特点** | **通俗解释** | **实际价值** |
|-------------|-------------|-------------|
| **🎯 简单易用** | `配置简单，开箱即用` | `新手友好，快速上手` |
| **⚡ 性能优秀** | `查询速度快，占用资源少` | `适合大规模监控` |
| **🔧 功能强大** | `支持复杂的数据查询和计算` | `满足各种监控需求` |
| **🌐 生态丰富** | `与各种系统都能很好集成` | `一套方案解决所有问题` |

### 1.3 工作原理简图


```
监控对象                 Prometheus服务器              Grafana
┌─────────┐              ┌──────────────┐              ┌─────────┐
│ 服务器A │─────────────→│              │─────────────→│         │
├─────────┤   指标数据    │  数据收集    │   查询请求    │ 图表展示│
│ 服务器B │─────────────→│  数据存储    │─────────────→│         │
├─────────┤              │  查询服务    │   返回数据    │         │
│ 应用程序│─────────────→│              │─────────────→│         │
└─────────┘              └──────────────┘              └─────────┘
    ↑                           ↑                           ↑
定期发送指标              存储时间序列数据              渲染监控图表
```

---

## 2. ⚙️ 数据源添加与基础配置


### 2.1 添加Prometheus数据源的步骤


**🔸 操作流程**
1. **进入配置页面**：左侧菜单 → Configuration → Data Sources
2. **添加数据源**：点击"Add data source"按钮
3. **选择类型**：在列表中找到并点击"Prometheus"
4. **填写配置**：输入必要的连接信息

**💡 界面操作指南**
```
Grafana主界面操作路径：
主页面
  ├── 左侧菜单栏
  │    ├── + (Create)
  │    ├── 📊 Dashboards 
  │    ├── 🔍 Explore
  │    └── ⚙️ Configuration
  │         └── 📡 Data Sources ← 点击这里
  │              └── Add data source ← 然后点击这里
  │                   └── Prometheus ← 最后选择这个
```

### 2.2 基础配置项详解


**🎯 Name（数据源名称）**
- **作用**：给这个数据源起个名字，方便识别
- **建议**：用有意义的名字，比如"生产环境Prometheus"、"测试环境监控"
- **注意**：一个Grafana可以连接多个Prometheus，所以名字要区分清楚

**🌐 URL（连接地址）**
- **格式**：`http://prometheus-server:9090`
- **本地部署**：`http://localhost:9090`
- **Docker环境**：`http://prometheus:9090`（容器名称）
- **云服务**：`https://your-prometheus.example.com`

```
常见URL配置示例：
✅ 正确格式：
   http://192.168.1.100:9090    ← IP地址+端口
   https://prom.company.com     ← 域名+HTTPS
   http://prometheus:9090       ← 容器服务名

❌ 错误格式：
   192.168.1.100:9090          ← 缺少协议
   http://192.168.1.100        ← 缺少端口
   prometheus:9090             ← 缺少协议
```

### 2.3 连接测试


**🔍 测试方法**
配置完基本信息后，点击页面底部的**"Save & Test"**按钮。

**📊 测试结果解读**
```
✅ 成功提示：
   "Data source is working"
   ↳ 说明：连接正常，可以正常获取数据

❌ 失败提示：
   "HTTP Error Bad Gateway"
   ↳ 原因：URL地址错误或Prometheus服务未启动
   
   "Network Error"  
   ↳ 原因：网络不通，检查防火墙和网络设置
   
   "Unauthorized"
   ↳ 原因：需要认证，检查用户名密码设置
```

---

## 3. 🔐 HTTP设置和认证详解


### 3.1 HTTP设置选项


**⏱️ Timeout（超时设置）**
- **默认值**：通常是30秒
- **调优建议**：
  - 网络较慢：设置为60秒
  - 数据量大：设置为120秒
  - 本地环境：可以设置为10秒

**🔄 HTTP Method（请求方法）**
- **GET**：默认选择，适合大多数情况
- **POST**：当查询语句很长时使用，避免URL长度限制

### 3.2 认证方式详解


**🔸 Basic Auth（基础认证）**

最常用的认证方式，就像登录网站时输入用户名和密码。

```
配置步骤：
1. 勾选 "Basic auth" 选项
2. 填写 User（用户名）
3. 填写 Password（密码）

适用场景：
- Prometheus配置了HTTP基础认证
- 需要简单的用户名密码验证
- 内网环境的安全控制
```

**🔸 TLS Client Auth（证书认证）**

使用数字证书进行认证，安全级别更高。

| **配置项** | **说明** | **获取方式** |
|-----------|---------|-------------|
| **CA Cert** | `证书颁发机构证书` | `从Prometheus管理员获取` |
| **Client Cert** | `客户端证书` | `从系统管理员申请` |
| **Client Key** | `客户端私钥` | `与客户端证书配套` |

**🔸 Custom HTTP Headers（自定义请求头）**

用于特殊的认证需求或传递额外信息。

```
常见用法示例：
Header Name: Authorization
Header Value: Bearer your-api-token

Header Name: X-API-Key  
Header Value: your-secret-key

Header Name: X-Scope-OrgID
Header Value: tenant-123
```

### 3.3 认证故障排查


**🔍 常见问题诊断**

```
问题：连接超时
排查步骤：
1. ping prometheus服务器IP ← 检查网络连通性
2. telnet prometheus服务器 9090 ← 检查端口是否开放
3. 浏览器访问Prometheus URL ← 检查服务是否正常

问题：认证失败
排查步骤：
1. 确认用户名密码正确
2. 检查Prometheus是否启用了认证
3. 查看Prometheus日志文件
4. 测试用curl命令验证认证
```

---

## 4. 🔍 PromQL查询预览与调试


### 4.1 什么是PromQL


**🎯 简单理解**
PromQL（Prometheus Query Language）就像是和Prometheus对话的"语言"。就好比你要从图书馆找书，需要告诉图书管理员具体的书名、作者或类别。

**💡 基础语法入门**

```
基础查询语法：
指标名称                    ← 最简单的查询
指标名称{标签="值"}         ← 带条件的查询
指标名称[时间范围]          ← 查询一段时间的数据
```

### 4.2 查询预览功能使用


**🔸 在数据源配置页面测试**

在配置Prometheus数据源时，页面下方有一个**"Query Preview"**区域，这里可以直接测试查询。

```
测试步骤：
1. 在URL配置完成后
2. 滚动到页面底部找到查询预览区域
3. 输入简单的PromQL查询
4. 点击"Run Query"查看结果

简单测试查询：
up                    ← 查看所有监控目标的状态
prometheus_build_info ← 查看Prometheus版本信息
rate(cpu_usage[5m])   ← 查看5分钟内CPU使用率
```

**📊 结果解读**

```
查询结果示例：
up{instance="localhost:9090", job="prometheus"} 1
  ↑      ↑                        ↑           ↑
指标名  实例地址                   任务名      数值

解释：
- up: 监控目标是否正常运行（1=正常，0=异常）
- instance: 具体的监控目标地址
- job: 监控任务的名称
- 1: 当前状态值（正常）
```

### 4.3 调试技巧


**🔧 从简单到复杂**

```
调试顺序建议：
1. 先测试基础指标：up
2. 再测试具体指标：cpu_usage
3. 然后加上标签过滤：cpu_usage{instance="server1"}
4. 最后加上函数：rate(cpu_usage[5m])
```

**⚡ 常见错误排查**

| **错误信息** | **可能原因** | **解决方法** |
|-------------|-------------|-------------|
| `"no data"` | `指标名称错误或数据未上报` | `检查指标名称拼写，确认数据源正常` |
| `"parse error"` | `PromQL语法错误` | `检查括号、引号是否匹配` |
| `"timeout"` | `查询超时或数据量过大` | `缩小时间范围或优化查询` |

---

## 5. 📖 指标浏览器的使用


### 5.1 指标浏览器是什么


**🎯 简单理解**
指标浏览器就像是Prometheus的"菜单目录"，它列出了所有可用的监控指标，就像餐厅菜单列出所有可点的菜品一样。

**💡 作用价值**
- **发现指标**：不知道有什么监控数据时，可以浏览查看
- **学习命名**：了解指标的命名规则和含义
- **快速选择**：不用手动输入，直接点击选择

### 5.2 如何使用指标浏览器


**🔸 访问方式**

```
方法1：在数据源配置页面
配置页面 → 查询预览区域 → "Metrics browser" 按钮

方法2：在Dashboard编辑时
Dashboard → 添加Panel → Query编辑器 → "Metrics" 下拉菜单

方法3：在Explore页面
左侧菜单 → Explore → 选择Prometheus数据源 → Metrics浏览器
```

**📊 指标分类理解**

```
常见指标类型：
📈 系统指标：
   - node_cpu_seconds_total     ← CPU使用时间
   - node_memory_MemTotal_bytes ← 内存总量
   - node_disk_io_now          ← 磁盘IO

🌐 网络指标：
   - node_network_receive_bytes_total ← 网络接收字节数
   - node_network_transmit_bytes_total ← 网络发送字节数

🐳 容器指标：
   - container_cpu_usage_seconds_total ← 容器CPU使用
   - container_memory_usage_bytes      ← 容器内存使用

📊 应用指标：
   - http_requests_total         ← HTTP请求总数
   - database_connections_active ← 数据库连接数
```

### 5.3 指标命名规则理解


**🎯 命名规范解读**

```
指标命名格式：
应用_组件_指标_单位

示例解析：
node_cpu_seconds_total
├── node     ← 应用：节点监控
├── cpu      ← 组件：CPU
├── seconds  ← 单位：秒
└── total    ← 类型：累计值

prometheus_http_requests_total
├── prometheus ← 应用：Prometheus自身
├── http       ← 组件：HTTP服务
├── requests   ← 指标：请求数
└── total      ← 类型：累计值
```

**💡 单位后缀含义**

| **后缀** | **含义** | **示例** |
|---------|---------|---------|
| `_total` | `累计总数` | `http_requests_total（总请求数）` |
| `_bytes` | `字节数` | `memory_usage_bytes（内存字节数）` |
| `_seconds` | `秒数` | `cpu_seconds_total（CPU秒数）` |
| `_ratio` | `比率` | `cpu_usage_ratio（CPU使用率）` |

---

## 6. ⚙️ 常用配置选项解析


### 6.1 查询配置选项


**⏱️ Scrape interval（抓取间隔）**

```
含义：多久从监控目标获取一次数据
默认值：通常是15秒
建议设置：
- 高频监控：5秒（CPU、内存等）
- 一般监控：15秒（大多数指标）
- 低频监控：60秒（磁盘空间等）

配置影响：
间隔太短 → 数据精度高，但占用资源多
间隔太长 → 节省资源，但可能错过重要变化
```

**📊 Query timeout（查询超时）**

```
作用：防止查询时间过长影响系统
推荐设置：
- 简单查询：30秒
- 复杂查询：60秒
- 大数据量：120秒

超时原因排查：
1. 查询时间范围太大
2. 指标数据量太多
3. Prometheus服务器性能不足
4. 网络延迟问题
```

### 6.2 缓存配置


**🗄️ Query cache（查询缓存）**

**简单理解**：就像浏览器缓存网页一样，把查询结果暂时保存起来，下次相同查询直接返回结果，速度更快。

```
缓存设置：
启用缓存：勾选 "Query cache"
缓存时间：设置缓存保持时间

优势：
✅ 查询速度更快
✅ 减少Prometheus服务器压力
✅ 提升用户体验

注意事项：
⚠️ 实时性要求高的场景慎用
⚠️ 缓存时间不宜设置太长
⚠️ 动态数据需要及时更新
```

### 6.3 高级选项


**🔧 Custom Query Parameters（自定义查询参数）**

```
用途：向Prometheus传递额外的查询参数
常用参数：
- timeout=60s          ← 设置查询超时
- max_samples=1000000  ← 限制返回样本数
- step=15s            ← 设置查询步长

配置方法：
参数名: timeout
参数值: 60s
```

**🏷️ HTTP Headers（HTTP请求头）**

```
作用：在请求中添加额外的头信息
常见用法：
- 认证信息传递
- 请求来源标识
- 特殊处理标记

示例配置：
Header: X-Dashboard-ID
Value: production-monitoring
```

---

## 7. ⚡ 性能优化设置实战


### 7.1 查询性能优化


**🎯 优化策略**

```
时间范围优化：
❌ 避免：查询过长时间范围（如1年数据）
✅ 推荐：根据需要选择合适范围（1小时、1天、1周）

步长设置优化：
查询1小时数据：步长15秒
查询1天数据：步长1分钟  
查询1周数据：步长5分钟
查询1月数据：步长1小时
```

**📊 具体配置建议**

| **监控场景** | **查询间隔** | **缓存时间** | **超时设置** |
|-------------|-------------|-------------|-------------|
| **实时监控** | `5秒` | `10秒` | `30秒` |
| **日常监控** | `15秒` | `1分钟` | `60秒` |
| **历史分析** | `1分钟` | `5分钟` | `120秒` |
| **报表生成** | `5分钟` | `30分钟` | `300秒` |

### 7.2 网络优化设置


**🌐 连接池配置**

```
连接复用设置：
Keep-Alive：启用
最大连接数：根据并发需求设置（通常20-50）
连接超时：30秒

配置位置：
HTTP Settings → Advanced → Connection settings
```

**📦 数据压缩**

```
启用压缩：
Accept-Encoding: gzip, deflate
Content-Encoding: gzip

好处：
- 减少网络传输时间
- 降低带宽占用
- 提升查询响应速度

注意：
- 会增加CPU使用
- 小数据量时效果不明显
```

### 7.3 内存优化


**🧠 查询优化建议**

```
避免重资源查询：
❌ 错误示例：
   rate(some_metric[1d])      ← 计算1天的速率，数据量巨大
   
✅ 正确示例：  
   rate(some_metric[5m])      ← 计算5分钟的速率，数据量合理

限制返回数据：
使用topk()函数：topk(10, cpu_usage)  ← 只返回前10个最高值
使用bottomk()函数：bottomk(5, memory_free) ← 只返回最低5个值
```

**📈 监控查询性能**

```
性能指标监控：
prometheus_tsdb_symbol_table_size_bytes ← 符号表大小
prometheus_tsdb_head_series             ← 内存中的时间序列数
prometheus_rule_evaluation_duration_seconds ← 规则评估时间

优化判断：
查询时间 > 10秒 → 需要优化查询语句
内存使用率 > 80% → 需要增加内存或优化数据保留
错误率 > 1% → 需要检查配置和网络
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的基本概念


```
🎯 数据源本质：Prometheus是Grafana的数据供应商，负责收集和存储监控数据
🔗 连接配置：URL地址是最核心的配置，格式必须正确（协议+地址+端口）
🔐 认证方式：Basic Auth最常用，TLS证书认证更安全，根据环境选择
🔍 查询语言：PromQL是查询数据的语言，从简单到复杂逐步学习
📖 指标浏览：通过指标浏览器发现和选择合适的监控指标
⚡ 性能优化：合理设置超时、缓存和查询范围，避免资源浪费
```

### 8.2 关键配置检查清单


**☑️ 基础配置检查**
```
□ 数据源名称有意义且不重复
□ URL地址格式正确（包含协议和端口）
□ 连接测试通过（显示"Data source is working"）
□ 超时设置合理（一般30-60秒）
□ 认证信息正确（如果需要的话）
```

**☑️ 性能配置检查**
```
□ 查询缓存根据实时性需求启用
□ 查询超时设置适当（避免过长等待）
□ HTTP方法选择正确（一般用GET）
□ 自定义参数配置合理（如果使用的话）
```

### 8.3 常见问题快速解决


**🔧 连接问题排查顺序**
```
1. 检查URL格式是否正确
2. 确认Prometheus服务是否运行
3. 测试网络连通性（ping + telnet）
4. 验证认证信息（如果配置了的话）
5. 查看防火墙和安全组设置
```

**💡 查询问题排查方法**
```
1. 先测试简单查询（如 up）
2. 使用指标浏览器确认指标存在
3. 检查PromQL语法是否正确
4. 缩小查询时间范围
5. 查看Prometheus和Grafana日志
```

### 8.4 学习建议和最佳实践


**📚 学习路径建议**
```
🎯 新手阶段：
   - 掌握基础连接配置
   - 学会简单的PromQL查询
   - 熟悉指标浏览器使用

⚡ 进阶阶段：
   - 掌握各种认证方式
   - 学会性能优化配置
   - 理解复杂的PromQL查询

🚀 高级阶段：
   - 自定义查询参数
   - 多数据源管理
   - 监控系统的监控
```

**💪 实践建议**
```
✅ 动手操作：理论结合实践，每个配置都要亲自试试
✅ 逐步深入：从简单配置开始，逐步学习高级功能
✅ 记录问题：遇到问题要记录解决方法，建立知识库
✅ 定期检查：定期检查配置和性能，及时优化调整
```

**核心记忆**
- Prometheus是数据源，Grafana是展示工具，两者配合使用
- URL配置是基础，认证配置是安全，性能配置是优化
- 从简单查询开始学习PromQL，逐步掌握复杂查询
- 合理配置缓存和超时，平衡性能和实时性需求