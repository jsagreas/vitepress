---
title: 3、高可用-部署
---
## 📚 目录


1. [高可用架构概述](#1-高可用架构概述)
2. [负载均衡配置详解](#2-负载均衡配置详解)
3. [数据库集群搭建](#3-数据库集群搭建)
4. [共享存储方案](#4-共享存储方案)
5. [故障转移机制](#5-故障转移机制)
6. [扩容策略与实践](#6-扩容策略与实践)
7. [核心要点总结](#7-核心要点总结)

---

# 1. 🏗️ 高可用架构概述



## 1.1 什么是高可用架构



🔥 **核心概念**
高可用（High Availability，简称HA）就像是给你的监控系统上保险，确保系统不会因为单台服务器出问题而整体瘫痪。

**🧠 生活化理解**：
```
就像医院的急诊科：
- 单台Grafana = 只有一个医生值班
  ↓ 医生生病了，急诊科就关门了

- 高可用Grafana = 多个医生轮班
  ↓ 一个医生生病，其他医生继续工作
```

## 1.2 高可用架构的核心组件



⭐⭐⭐ **必须掌握**

```
高可用Grafana架构图：

用户 → 负载均衡器 → Grafana实例集群 → 共享数据库
  ↓        ↓           ↓              ↓
 浏览器   Nginx    Instance1,2,3   MySQL集群
          ↓           ↓              ↓
      流量分发    处理请求        存储配置
```

**🔸 四大核心组件**：

| 组件 | **作用** | **比喻** |
|------|---------|---------|
| 🌐 **负载均衡器** | `分发用户请求到不同Grafana实例` | `商场的分流指示牌` |
| 🖥️ **Grafana实例集群** | `多个Grafana服务同时工作` | `多个收银台同时服务` |
| 💾 **共享数据库** | `统一存储所有配置和用户数据` | `共同的仓库管理系统` |
| 📁 **共享存储** | `存放图片、插件等文件` | `共享的文件柜` |

## 1.3 高可用的关键指标



**📊 可用性计算**：
```
可用性 = 正常运行时间 ÷ 总时间 × 100%

常见标准：
99.9%（8小时43分钟/年故障时间）
99.99%（52分钟/年故障时间）  ← 企业级标准
99.999%（5分钟/年故障时间） ← 金融级标准
```

**💡 实际意义**：
- **99.9%**：一年宕机不超过9小时
- **99.99%**：一年宕机不超过1小时
- **99.999%**：一年宕机不超过5分钟

---

# 2. ⚖️ 负载均衡配置详解



## 2.1 负载均衡器的作用



🎯 **核心功能**
负载均衡器就像是一个聪明的交通指挥员，把用户的访问请求合理分配给不同的Grafana服务器。

**🔍 详细解释**：
```
没有负载均衡：
用户1 → Grafana服务器1（可能过载）
用户2 → Grafana服务器1（继续增加负担）
用户3 → Grafana服务器1（可能崩溃）

有负载均衡：
用户1 → 负载均衡器 → Grafana服务器1
用户2 → 负载均衡器 → Grafana服务器2
用户3 → 负载均衡器 → Grafana服务器3
```

## 2.2 Nginx负载均衡配置



⭐⭐ **进阶级**

**基础配置示例**：
```nginx
# /etc/nginx/conf.d/grafana-lb.conf

upstream grafana_backend {
#    # 定义后端Grafana服务器组
    server 192.168.1.10:3000 weight=1 max_fails=3 fail_timeout=30s;
    server 192.168.1.11:3000 weight=1 max_fails=3 fail_timeout=30s;
    server 192.168.1.12:3000 weight=1 max_fails=3 fail_timeout=30s;
    
#    # 会话保持（重要！）
    ip_hash;
}

server {
    listen 80;
    server_name grafana.company.com;
    
    location / {
        proxy_pass http://grafana_backend;
        
#        # 必要的请求头
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
#        # WebSocket支持（Grafana实时更新需要）
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

**🔧 配置解释**：

| 参数 | **含义** | **推荐值** |
|------|---------|-----------|
| `weight=1` | `服务器权重，数字越大分配流量越多` | `根据服务器性能设置` |
| `max_fails=3` | `连续失败3次后标记为不可用` | `3-5次` |
| `fail_timeout=30s` | `标记不可用后30秒重新尝试` | `30-60秒` |
| `ip_hash` | `同一用户IP总是访问同一台服务器` | `推荐开启` |

## 2.3 负载均衡算法选择



**📋 常用算法对比**：

| 算法 | **工作方式** | **适用场景** | **优缺点** |
|------|-------------|-------------|-----------|
| 🔄 **轮询** | `依次分配给每台服务器` | `服务器性能相同` | `简单，但不考虑服务器负载` |
| ⚖️ **加权轮询** | `按权重比例分配` | `服务器性能不同` | `灵活，但仍不考虑实时负载` |
| 🎯 **IP哈希** | `根据用户IP分配到固定服务器` | `需要会话保持` | `用户体验好，但可能分布不均` |
| 📊 **最少连接** | `分配给连接数最少的服务器` | `长连接应用` | `负载均衡好，但计算开销大` |

> 💡 **推荐选择**：Grafana建议使用`ip_hash`，因为用户登录状态需要保持在同一台服务器上。

## 2.4 健康检查配置



**🔍 检查Grafana服务状态**：
```nginx
upstream grafana_backend {
    server 192.168.1.10:3000 weight=1;
    server 192.168.1.11:3000 weight=1;
    server 192.168.1.12:3000 weight=1;
    
#    # 健康检查（需要nginx_upstream_check_module）
    check interval=3000 rise=2 fall=3 timeout=1000 type=http;
    check_http_send "GET /api/health HTTP/1.0\r\n\r\n";
    check_http_expect_alive http_2xx http_3xx;
}
```

**参数说明**：
- `interval=3000`：每3秒检查一次
- `rise=2`：连续成功2次标记为健康
- `fall=3`：连续失败3次标记为不健康
- `timeout=1000`：超时时间1秒

---

# 3. 💾 数据库集群搭建



## 3.1 为什么需要数据库集群



🔥 **核心问题**
如果多个Grafana实例都连接同一个数据库，那数据库成了单点故障。就像多个收银台共用一个收银系统，系统坏了所有收银台都用不了。

**🎯 解决方案**：
```
单数据库架构问题：
Grafana1 ↘
Grafana2 → MySQL（单点）← 数据库坏了，全部瘫痪
Grafana3 ↗

数据库集群架构：
Grafana1 ↘
Grafana2 → MySQL集群 ← 一个数据库坏了，其他继续工作
Grafana3 ↗      ↓
              主从复制
```

## 3.2 MySQL主从复制配置



⭐⭐⭐ **必须掌握**

**主库配置（192.168.1.20）**：
```ini
# /etc/mysql/mysql.conf.d/mysqld.cnf

[mysqld]
server-id = 1
log-bin = mysql-bin
binlog-do-db = grafana

# 重启MySQL

sudo systemctl restart mysql
```

**从库配置（192.168.1.21）**：
```ini
# /etc/mysql/mysql.conf.d/mysqld.cnf

[mysqld]
server-id = 2
relay-log = mysql-relay-bin
read-only = 1

# 重启MySQL

sudo systemctl restart mysql
```

**建立主从关系**：
```sql
-- 在主库创建复制用户
CREATE USER 'replication'@'192.168.1.21' IDENTIFIED BY 'password123';
GRANT REPLICATION SLAVE ON *.* TO 'replication'@'192.168.1.21';

-- 在从库设置主库信息
CHANGE MASTER TO
    MASTER_HOST='192.168.1.20',
    MASTER_USER='replication',
    MASTER_PASSWORD='password123',
    MASTER_LOG_FILE='mysql-bin.000001',
    MASTER_LOG_POS=0;

-- 启动从库复制
START SLAVE;

-- 检查状态
SHOW SLAVE STATUS\G
```

## 3.3 Grafana数据库连接配置



**读写分离配置**：
```ini
# grafana.ini

[database]
type = mysql
host = 192.168.1.20:3306  # 主库（写操作）
name = grafana
user = grafana
password = your_password

# 只读连接配置

[database_replica]
type = mysql
host = 192.168.1.21:3306  # 从库（读操作）
name = grafana
user = grafana_read
password = your_read_password
```

**💡 实际效果**：
- 写操作（创建仪表板、修改配置）→ 主库
- 读操作（查看仪表板、用户登录验证）→ 从库
- 主库数据自动同步到从库

---

# 4. 📁 共享存储方案



## 4.1 为什么需要共享存储



🎯 **核心问题**
多个Grafana实例需要共享一些文件，比如上传的图片、安装的插件等。

**🧠 理解方式**：
```
没有共享存储的问题：
Grafana1：有插件A，没有图片X
Grafana2：没有插件A，有图片X  
Grafana3：什么都没有

用户访问不同服务器，看到的内容不一致！

有共享存储：
Grafana1 ↘
Grafana2 → 共享存储 ← 所有文件都在这里
Grafana3 ↗

所有服务器看到的内容完全一致
```

## 4.2 NFS共享存储配置



⭐⭐ **进阶级**

**NFS服务器配置（192.168.1.30）**：
```bash
# 安装NFS服务

sudo apt update
sudo apt install nfs-kernel-server

# 创建共享目录

sudo mkdir -p /nfs/grafana/data
sudo mkdir -p /nfs/grafana/plugins
sudo mkdir -p /nfs/grafana/logs

# 设置权限

sudo chown -R 472:472 /nfs/grafana
sudo chmod -R 755 /nfs/grafana

# 配置共享

echo "/nfs/grafana 192.168.1.0/24(rw,sync,no_subtree_check)" | sudo tee -a /etc/exports

# 重启NFS服务

sudo systemctl restart nfs-kernel-server
```

**客户端挂载（所有Grafana服务器）**：
```bash
# 安装NFS客户端

sudo apt install nfs-common

# 创建挂载点

sudo mkdir -p /var/lib/grafana/shared

# 挂载NFS

sudo mount -t nfs 192.168.1.30:/nfs/grafana /var/lib/grafana/shared

# 开机自动挂载

echo "192.168.1.30:/nfs/grafana /var/lib/grafana/shared nfs defaults 0 0" | sudo tee -a /etc/fstab
```

## 4.3 Grafana共享存储配置



**修改Grafana配置**：
```ini
# grafana.ini

[paths]
data = /var/lib/grafana/shared/data
logs = /var/lib/grafana/shared/logs
plugins = /var/lib/grafana/shared/plugins
```

**🔧 配置验证**：
```bash
# 在任意一台Grafana服务器创建测试文件

echo "test" > /var/lib/grafana/shared/test.txt

# 在其他Grafana服务器查看

cat /var/lib/grafana/shared/test.txt
# 应该能看到"test"内容

```

---

# 5. 🔄 故障转移机制



## 5.1 故障转移的基本概念



🔥 **核心理解**
故障转移就像是备用司机，主司机开不了车了，备用司机立即接手，乘客感觉不到任何中断。

**📊 故障转移类型**：

| 类型 | **切换时间** | **数据丢失** | **适用场景** |
|------|-------------|-------------|-------------|
| 🚀 **自动故障转移** | `秒级` | `极少` | `关键业务系统` |
| 🔧 **手动故障转移** | `分钟级` | `可能有` | `一般业务系统` |
| 📋 **计划性切换** | `可控` | `无` | `维护升级` |

## 5.2 Keepalived自动故障转移



⭐⭐⭐ **必须掌握**

**主节点配置（192.168.1.10）**：
```bash
# 安装keepalived

sudo apt install keepalived

# 配置文件

sudo tee /etc/keepalived/keepalived.conf << EOF
vrrp_script chk_grafana {
    script "/usr/local/bin/check_grafana.sh"
    interval 2
    weight -2
    fall 3
    rise 2
}

vrrp_instance VI_1 {
    state MASTER
    interface eth0
    virtual_router_id 51
    priority 100
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass mypassword
    }
    virtual_ipaddress {
        192.168.1.100/24
    }
    track_script {
        chk_grafana
    }
}
EOF
```

**健康检查脚本**：
```bash
sudo tee /usr/local/bin/check_grafana.sh << 'EOF'
#!/bin/bash

# 检查Grafana是否正常运行

curl -f http://localhost:3000/api/health > /dev/null 2>&1
exit $?
EOF

sudo chmod +x /usr/local/bin/check_grafana.sh
```

**备节点配置（192.168.1.11）**：
```bash
# 配置文件（只修改state和priority）

vrrp_instance VI_1 {
    state BACKUP
    interface eth0
    virtual_router_id 51
    priority 90        # 比主节点低
#    # 其他配置相同
}
```

## 5.3 故障转移测试



**🔍 测试步骤**：
```bash
# 1. 检查虚拟IP状态

ip addr show eth0

# 2. 模拟主节点故障

sudo systemctl stop grafana-server

# 3. 查看keepalived日志

sudo tail -f /var/log/syslog | grep keepalived

# 4. 验证IP转移

ping 192.168.1.100

# 5. 恢复主节点

sudo systemctl start grafana-server
```

**预期结果**：
- 主节点停止→虚拟IP自动转移到备节点
- 用户访问不中断
- 主节点恢复→虚拟IP转移回主节点

---

# 6. 🚀 扩容策略与实践



## 6.1 扩容的时机判断



📊 **扩容指标监控**

**🔍 关键监控指标**：
```
CPU使用率：持续 > 70%
内存使用率：持续 > 80%
响应时间：平均 > 2秒
并发用户数：接近设计上限
数据库连接数：> 最大连接数的70%
```

**📈 扩容决策矩阵**：

| 指标状态 | **轻度压力** | **中度压力** | **重度压力** |
|---------|-------------|-------------|-------------|
| **CPU > 70%** | `🟡 观察` | `🟠 准备扩容` | `🔴 立即扩容` |
| **内存 > 80%** | `🟡 观察` | `🔴 立即扩容` | `🔴 立即扩容` |
| **响应时间 > 2s** | `🟠 准备扩容` | `🔴 立即扩容` | `🔴 立即扩容` |

## 6.2 水平扩容实施步骤



⭐⭐ **进阶级**

**步骤1：准备新服务器**
```bash
# 新服务器（192.168.1.13）安装Grafana

sudo apt update
sudo apt install grafana

# 复制配置文件

scp grafana-server-1:/etc/grafana/grafana.ini /etc/grafana/
```

**步骤2：配置共享存储**
```bash
# 挂载NFS

sudo mount -t nfs 192.168.1.30:/nfs/grafana /var/lib/grafana/shared

# 修改配置文件指向共享存储

sudo vim /etc/grafana/grafana.ini
```

**步骤3：更新负载均衡**
```nginx
upstream grafana_backend {
    server 192.168.1.10:3000 weight=1;
    server 192.168.1.11:3000 weight=1;
    server 192.168.1.12:3000 weight=1;
    server 192.168.1.13:3000 weight=1;  # 新增服务器
}
```

**步骤4：验证扩容效果**
```bash
# 重载nginx配置

sudo nginx -s reload

# 检查新服务器状态

curl http://192.168.1.13:3000/api/health

# 监控流量分发

sudo tail -f /var/log/nginx/access.log
```

## 6.3 垂直扩容实践



**🔧 服务器性能提升**：

**内存扩容**：
```bash
# 检查当前内存

free -h

# 增加内存后调整Grafana配置

[database]
max_open_conns = 100      # 增加数据库连接数
max_idle_conns = 10

[server]
router_logging = false    # 减少日志输出
```

**存储扩容**：
```bash
# 检查磁盘使用

df -h

# 扩展磁盘分区

sudo resize2fs /dev/sda1

# 配置日志轮转

[log]
max_lines = 1000000
max_size_shift = 28      # 256MB轮转
daily_rotate = true
max_days = 7
```

## 6.4 扩容最佳实践



💡 **推荐做法**：

**🔸 渐进式扩容**：
- 先增加1台服务器观察效果
- 确认没问题后再批量扩容
- 避免一次性大幅扩容

**🔸 性能测试**：
```bash
# 使用Apache Bench测试

ab -n 1000 -c 10 http://grafana.company.com/

# 使用wrk测试

wrk -t12 -c400 -d30s http://grafana.company.com/
```

**🔸 监控扩容效果**：
- 扩容前后的响应时间对比
- CPU、内存使用率变化
- 用户并发数支持能力
- 错误率变化

> ⚠️ **重要提醒**：扩容是手段不是目的，要先优化代码和配置，再考虑扩容。

---

# 7. 📋 核心要点总结



## 7.1 必须掌握的核心概念



```
🔥 高可用架构 = 负载均衡 + 服务集群 + 数据库集群 + 共享存储
🔥 故障转移 = 自动检测故障 + 快速切换 + 服务不中断
🔥 扩容策略 = 监控指标 + 水平扩容 + 垂直扩容
🔥 负载均衡 = 流量分发 + 健康检查 + 会话保持
```

## 7.2 关键配置清单



**✅ 部署检查清单**：
- [ ] 负载均衡器配置并测试
- [ ] 至少2个Grafana实例运行
- [ ] 数据库主从复制正常
- [ ] 共享存储挂载成功
- [ ] 故障转移机制测试通过
- [ ] 监控告警配置完成

## 7.3 故障处理指南



**🚨 常见问题解决**：

| 问题现象 | **可能原因** | **解决方法** |
|---------|-------------|-------------|
| 🔴 **页面无法访问** | `负载均衡器故障` | `检查nginx状态，重启服务` |
| 🔴 **登录状态丢失** | `会话保持配置错误` | `配置ip_hash或共享session` |
| 🔴 **数据不同步** | `数据库主从复制中断` | `检查SLAVE STATUS，重新配置` |
| 🔴 **文件上传失败** | `共享存储挂载失败` | `检查NFS服务，重新挂载` |

## 7.4 性能优化建议



**🚀 最佳实践**：

**监控维度**：
- **可用性**：99.9%以上正常运行时间
- **性能**：平均响应时间<2秒
- **并发**：支持100+用户同时在线
- **扩展性**：能够快速增加服务器

**运维建议**：
- 定期备份数据库和配置文件
- 监控服务器资源使用情况
- 建立应急响应流程
- 定期进行故障演练

## 7.5 架构演进路径



**📈 成长路径**：
```
阶段1：单机部署
  ↓ 用户增长
阶段2：负载均衡 + 多实例
  ↓ 数据量增长  
阶段3：数据库集群 + 共享存储
  ↓ 高可用要求
阶段4：自动故障转移 + 监控告警
  ↓ 大规模部署
阶段5：容器化 + 自动扩缩容
```

**核心记忆口诀**：
- 高可用架构四要素：负载、集群、存储、转移
- 扩容三步走：监控、测试、实施
- 故障转移三原则：快速、自动、无感知
- 部署六检查：均衡、实例、数据库、存储、转移、监控

**🎯 学习重点**：
理解每个组件的作用和配置方法，能够独立搭建一个高可用的Grafana监控系统，并具备故障排查和性能优化能力。