---
title: 3ã€APIå®‰å…¨ä¸JWTå®ç°
---
## ğŸ“š ç›®å½•

1. [JWTåŸºç¡€æ¦‚å¿µè¯¦è§£](#1-JWTåŸºç¡€æ¦‚å¿µè¯¦è§£)
2. [JWTç»“æ„æ·±åº¦è§£æ](#2-JWTç»“æ„æ·±åº¦è§£æ)
3. [JWTç­¾åæœºåˆ¶åŸç†](#3-JWTç­¾åæœºåˆ¶åŸç†)
4. [HS256å¯¹ç§°ç­¾åè¯¦è§£](#4-HS256å¯¹ç§°ç­¾åè¯¦è§£)
5. [RS256éå¯¹ç§°ç­¾åè¯¦è§£](#5-RS256éå¯¹ç§°ç­¾åè¯¦è§£)
6. [HS256 vs RS256å¯¹æ¯”åˆ†æ](#6-HS256-vs-RS256å¯¹æ¯”åˆ†æ)
7. [JWTå®‰å…¨æ€§æ·±åº¦åˆ†æ](#7-JWTå®‰å…¨æ€§æ·±åº¦åˆ†æ)
8. [APIç­¾åéªŒè¯æœºåˆ¶](#8-APIç­¾åéªŒè¯æœºåˆ¶)
9. [å®é™…åº”ç”¨æœ€ä½³å®è·µ](#9-å®é™…åº”ç”¨æœ€ä½³å®è·µ)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ JWTåŸºç¡€æ¦‚å¿µè¯¦è§£


### 1.1 ä»€ä¹ˆæ˜¯JWT


**ğŸ”¸ JWTå®šä¹‰**
```
JWT = JSON Web Tokenï¼ˆJSONç½‘ç»œä»¤ç‰Œï¼‰
æœ¬è´¨ï¼šä¸€ç§åœ¨ç½‘ç»œé—´å®‰å…¨ä¼ è¾“ä¿¡æ¯çš„å¼€æ”¾æ ‡å‡†
ç›®çš„ï¼šåœ¨ä¸åŒç³»ç»Ÿé—´ä¼ é€’å¯ä¿¡çš„ç”¨æˆ·ä¿¡æ¯
```

**ğŸ’¡ é€šä¿—ç†è§£**
æƒ³è±¡JWTå°±åƒä¸€å¼ **æ•°å­—èº«ä»½è¯**ï¼š
- ğŸ“„ **å†…å®¹**ï¼šåŒ…å«ä½ çš„èº«ä»½ä¿¡æ¯ï¼ˆç”¨æˆ·IDã€æƒé™ç­‰ï¼‰
- ğŸ”’ **é˜²ä¼ª**ï¼šæœ‰æ•°å­—ç­¾åï¼Œæ— æ³•ä¼ªé€ 
- ğŸŒ **é€šç”¨**ï¼šä»»ä½•ç³»ç»Ÿéƒ½èƒ½è¯†åˆ«å’ŒéªŒè¯
- â° **æœ‰æ•ˆæœŸ**ï¼šå¯ä»¥è®¾ç½®è¿‡æœŸæ—¶é—´

### 1.2 JWTè§£å†³ä»€ä¹ˆé—®é¢˜


**ğŸ”¸ ä¼ ç»ŸSessionçš„é—®é¢˜**
```
é—®é¢˜åœºæ™¯ï¼šç”¨æˆ·ç™»å½•åè¦è®¿é—®å¤šä¸ªæœåŠ¡

ä¼ ç»Ÿæ–¹å¼ï¼š
ç”¨æˆ· â†’ ç™»å½•æœåŠ¡ â†’ ç”ŸæˆSession â†’ å­˜å‚¨åœ¨æœåŠ¡å™¨
é—®é¢˜ï¼š
â€¢ å¤šå°æœåŠ¡å™¨éœ€è¦å…±äº«Session
â€¢ æ‰©å±•å›°éš¾ï¼ŒæœåŠ¡å™¨ä¹‹é—´è¦åŒæ­¥
â€¢ å ç”¨æœåŠ¡å™¨å†…å­˜
```

**âœ… JWTçš„ä¼˜åŠ¿**
```
JWTæ–¹å¼ï¼š
ç”¨æˆ· â†’ ç™»å½•æœåŠ¡ â†’ ç”ŸæˆJWT â†’ è¿”å›ç»™ç”¨æˆ·
ç”¨æˆ·æ‹¿ç€JWT â†’ è®¿é—®ä»»ä½•æœåŠ¡ â†’ æœåŠ¡ç›´æ¥éªŒè¯JWT

ä¼˜åŠ¿ï¼š
â€¢ æ— éœ€æœåŠ¡å™¨å­˜å‚¨Session
â€¢ å¤©ç„¶æ”¯æŒåˆ†å¸ƒå¼ç³»ç»Ÿ
â€¢ å‡å°‘æœåŠ¡å™¨å‹åŠ›
â€¢ è·¨åŸŸå‹å¥½
```

### 1.3 JWTå·¥ä½œæµç¨‹


```
å®Œæ•´è®¤è¯æµç¨‹ï¼š

1. ç”¨æˆ·ç™»å½•
   ç”¨æˆ·åå¯†ç  â†’ è®¤è¯æœåŠ¡å™¨

2. ç”ŸæˆJWT
   è®¤è¯æˆåŠŸ â†’ æœåŠ¡å™¨ç”ŸæˆJWT â†’ è¿”å›ç»™å®¢æˆ·ç«¯

3. æºå¸¦JWTè®¿é—®
   å®¢æˆ·ç«¯è¯·æ±‚ â†’ å¤´éƒ¨æºå¸¦JWT â†’ ä¸šåŠ¡æœåŠ¡å™¨

4. éªŒè¯JWT
   ä¸šåŠ¡æœåŠ¡å™¨ â†’ éªŒè¯JWTç­¾å â†’ æå–ç”¨æˆ·ä¿¡æ¯ â†’ å¤„ç†è¯·æ±‚

5. è¿”å›ç»“æœ
   å¤„ç†å®Œæˆ â†’ è¿”å›æ•°æ®ç»™å®¢æˆ·ç«¯
```

---

## 2. ğŸ“‹ JWTç»“æ„æ·±åº¦è§£æ


### 2.1 JWTä¸‰æ®µå¼ç»“æ„


**ğŸ”¸ ç»“æ„ç»„æˆ**
```
JWTæ ¼å¼ï¼šHeader.Payload.Signature

çœŸå®ç¤ºä¾‹ï¼š
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c

åˆ†è§£ï¼š
Header:     eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9
Payload:    eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ
Signature:  SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c
```

### 2.2 Headerå¤´éƒ¨è¯¦è§£


**ğŸ”¸ Headerä½œç”¨**
```
Headerå‘Šè¯‰æˆ‘ä»¬ï¼š
â€¢ ä½¿ç”¨ä»€ä¹ˆç®—æ³•ç­¾å
â€¢ è¿™æ˜¯ä»€ä¹ˆç±»å‹çš„ä»¤ç‰Œ
```

**ğŸ’» Headerç¤ºä¾‹**
```json
{
  "alg": "HS256",    // ç®—æ³•ï¼šHMAC SHA-256
  "typ": "JWT"       // ç±»å‹ï¼šJWTä»¤ç‰Œ
}
```

**ğŸ”§ å¸¸è§ç®—æ³•ç±»å‹**
```
å¯¹ç§°åŠ å¯†ç®—æ³•ï¼š
â€¢ HS256 - HMAC with SHA-256
â€¢ HS384 - HMAC with SHA-384  
â€¢ HS512 - HMAC with SHA-512

éå¯¹ç§°åŠ å¯†ç®—æ³•ï¼š
â€¢ RS256 - RSA with SHA-256
â€¢ RS384 - RSA with SHA-384
â€¢ RS512 - RSA with SHA-512
â€¢ ES256 - ECDSA with SHA-256
```

### 2.3 Payloadè½½è·è¯¦è§£


**ğŸ”¸ Payloadä½œç”¨**
```
PayloadåŒ…å«å®é™…çš„æ•°æ®ï¼š
â€¢ ç”¨æˆ·ä¿¡æ¯
â€¢ æƒé™ä¿¡æ¯  
â€¢ è¿‡æœŸæ—¶é—´
â€¢ å…¶ä»–è‡ªå®šä¹‰æ•°æ®
```

**ğŸ’» Payloadç¤ºä¾‹**
```json
{
  "sub": "1234567890",        // ä¸»é¢˜ï¼šç”¨æˆ·ID
  "name": "John Doe",         // ç”¨æˆ·å
  "iat": 1516239022,          // ç­¾å‘æ—¶é—´
  "exp": 1516325422,          // è¿‡æœŸæ—¶é—´
  "role": "admin",            // è‡ªå®šä¹‰ï¼šç”¨æˆ·è§’è‰²
  "permissions": ["read", "write"]  // è‡ªå®šä¹‰ï¼šæƒé™åˆ—è¡¨
}
```

**ğŸ“ æ ‡å‡†å£°æ˜å­—æ®µ**
```
iss (issuer)ï¼šç­¾å‘è€…
sub (subject)ï¼šä¸»é¢˜ï¼ˆé€šå¸¸æ˜¯ç”¨æˆ·IDï¼‰
aud (audience)ï¼šå—ä¼—ï¼ˆè°å¯ä»¥ä½¿ç”¨è¿™ä¸ªJWTï¼‰
exp (expiration)ï¼šè¿‡æœŸæ—¶é—´
nbf (not before)ï¼šç”Ÿæ•ˆæ—¶é—´
iat (issued at)ï¼šç­¾å‘æ—¶é—´
jti (JWT ID)ï¼šJWTçš„å”¯ä¸€æ ‡è¯†
```

### 2.4 Signatureç­¾åè¯¦è§£


**ğŸ”¸ ç­¾åä½œç”¨**
```
ç­¾åçš„ç›®çš„ï¼š
â€¢ éªŒè¯JWTæ²¡æœ‰è¢«ç¯¡æ”¹
â€¢ ç¡®è®¤JWTæ˜¯ç”±å¯ä¿¡æœåŠ¡å™¨ç­¾å‘
â€¢ é˜²æ­¢ä¼ªé€ JWT
```

**ğŸ”’ ç­¾åç”Ÿæˆè¿‡ç¨‹**
```
æ­¥éª¤1ï¼šç¼–ç Headerå’ŒPayload
header_encoded = Base64URL(header)
payload_encoded = Base64URL(payload)

æ­¥éª¤2ï¼šç»„åˆæ•°æ®
data = header_encoded + "." + payload_encoded

æ­¥éª¤3ï¼šç”Ÿæˆç­¾å
signature = HMACSHA256(data, secret)

æ­¥éª¤4ï¼šç¼–ç ç­¾å
signature_encoded = Base64URL(signature)

æœ€ç»ˆJWT = header_encoded + "." + payload_encoded + "." + signature_encoded
```

---

## 3. ğŸ” JWTç­¾åæœºåˆ¶åŸç†


### 3.1 ç­¾åçš„æ ¸å¿ƒåŸç†


**ğŸ”¸ ä¸ºä»€ä¹ˆéœ€è¦ç­¾å**
```
é—®é¢˜ï¼šå¦‚æœæ²¡æœ‰ç­¾åä¼šæ€æ ·ï¼Ÿ

æ¶æ„ç”¨æˆ·å¯ä»¥ï¼š
1. è§£ç JWTè·å–Payload
2. ä¿®æ”¹ç”¨æˆ·æƒé™ï¼ˆæ¯”å¦‚æ”¹æˆadminï¼‰
3. é‡æ–°ç¼–ç å‘é€ç»™æœåŠ¡å™¨
4. æœåŠ¡å™¨æ— æ³•è¯†åˆ«JWTè¢«ç¯¡æ”¹

ç»“æœï¼šå®‰å…¨æ¼æ´ï¼
```

**âœ… ç­¾åå¦‚ä½•è§£å†³**
```
ç­¾åæœºåˆ¶ï¼š
1. æœåŠ¡å™¨ç”¨å¯†é’¥å¯¹Header+Payloadè¿›è¡Œç­¾å
2. ä»»ä½•ä¿®æ”¹éƒ½ä¼šå¯¼è‡´ç­¾åéªŒè¯å¤±è´¥
3. åªæœ‰çŸ¥é“å¯†é’¥çš„æœåŠ¡å™¨æ‰èƒ½ç”Ÿæˆæœ‰æ•ˆç­¾å
4. å®¢æˆ·ç«¯æ— æ³•ä¼ªé€ ç­¾å
```

### 3.2 ç­¾åéªŒè¯æµç¨‹


```
JWTéªŒè¯è¿‡ç¨‹ï¼š

æ¥æ”¶JWT â†’ åˆ†ç¦»ä¸‰ä¸ªéƒ¨åˆ† â†’ é‡æ–°è®¡ç®—ç­¾å â†’ å¯¹æ¯”åŸç­¾å

è¯¦ç»†æ­¥éª¤ï¼š
1. è§£æJWTï¼šåˆ†ç¦»Headerã€Payloadã€Signature
2. è§£ç Headerï¼šè·å–ç­¾åç®—æ³•
3. é‡æ–°ç­¾åï¼šç”¨ç›¸åŒç®—æ³•å’Œå¯†é’¥å¯¹Header.Payloadç­¾å
4. å¯¹æ¯”ç­¾åï¼šæ–°ç­¾å == åŸç­¾åï¼Ÿ
   âœ… ç›¸ç­‰ â†’ JWTæœ‰æ•ˆï¼Œæå–Payloadæ•°æ®
   âŒ ä¸ç­‰ â†’ JWTæ— æ•ˆï¼Œæ‹’ç»è¯·æ±‚
```

### 3.3 ç­¾åå®‰å…¨æ€§ä¿éšœ


**ğŸ”¸ é˜²ç¯¡æ”¹æœºåˆ¶**
```
ä»»ä½•å¾®å°çš„ä¿®æ”¹éƒ½ä¼šå¯¼è‡´ç­¾åå®Œå…¨ä¸åŒï¼š

åŸå§‹æ•°æ®ï¼š"admin"
ç­¾åï¼šabc123def456

ä¿®æ”¹æ•°æ®ï¼š"admin " (å¤šäº†ä¸ªç©ºæ ¼)
ç­¾åï¼šxyz789uvw012 (å®Œå…¨ä¸åŒ)

è¿™å°±æ˜¯å¯†ç å­¦çš„é›ªå´©æ•ˆåº”ï¼
```

**âš ï¸ é‡è¦å®‰å…¨æ³¨æ„**
```
ç­¾ååªèƒ½é˜²ç¯¡æ”¹ï¼Œä¸èƒ½é˜²å·çœ‹ï¼

JWTçš„Headerå’ŒPayloadåªæ˜¯Base64ç¼–ç ï¼Œä¸æ˜¯åŠ å¯†
ä»»ä½•äººéƒ½å¯ä»¥è§£ç æŸ¥çœ‹å†…å®¹
æ‰€ä»¥ï¼šæ•æ„Ÿä¿¡æ¯ä¸è¦æ”¾åœ¨JWTä¸­ï¼
```

---

## 4. ğŸ”‘ HS256å¯¹ç§°ç­¾åè¯¦è§£


### 4.1 HS256åŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯HS256**
```
HS256 = HMAC-SHA256
â€¢ HMACï¼šHash-based Message Authentication Codeï¼ˆåŸºäºå“ˆå¸Œçš„æ¶ˆæ¯è®¤è¯ç ï¼‰
â€¢ SHA256ï¼šå®‰å…¨å“ˆå¸Œç®—æ³•256ä½
â€¢ å¯¹ç§°ï¼šç­¾åå’ŒéªŒè¯ä½¿ç”¨åŒä¸€ä¸ªå¯†é’¥
```

**ğŸ’¡ é€šä¿—ç†è§£**
```
HS256å°±åƒï¼š
â€¢ ä¸€æŠŠé”é…ä¸€æŠŠé’¥åŒ™
â€¢ é”é—¨ç”¨è¿™æŠŠé’¥åŒ™ï¼Œå¼€é—¨ä¹Ÿç”¨è¿™æŠŠé’¥åŒ™
â€¢ ç­¾åç”¨è¿™ä¸ªå¯†é’¥ï¼ŒéªŒè¯ä¹Ÿç”¨è¿™ä¸ªå¯†é’¥
```

### 4.2 HS256å·¥ä½œåŸç†


**ğŸ”§ ç­¾åç”Ÿæˆè¿‡ç¨‹**
```javascript
// ä¼ªä»£ç æ¼”ç¤º
function generateHS256Signature(header, payload, secret) {
    // 1. ç¼–ç Headerå’ŒPayload
    const encodedHeader = base64UrlEncode(header);
    const encodedPayload = base64UrlEncode(payload);
    
    // 2. ç»„åˆæ•°æ®
    const data = encodedHeader + "." + encodedPayload;
    
    // 3. HMAC-SHA256ç­¾å
    const signature = hmacSha256(data, secret);
    
    // 4. Base64URLç¼–ç ç­¾å
    return base64UrlEncode(signature);
}
```

**ğŸ” éªŒè¯è¿‡ç¨‹**
```javascript
function verifyHS256JWT(jwt, secret) {
    // 1. åˆ†ç¦»JWTä¸‰éƒ¨åˆ†
    const [header, payload, signature] = jwt.split('.');
    
    // 2. é‡æ–°ç”Ÿæˆç­¾å
    const expectedSignature = generateHS256Signature(
        base64UrlDecode(header),
        base64UrlDecode(payload),
        secret
    );
    
    // 3. å¯¹æ¯”ç­¾å
    return signature === expectedSignature;
}
```

### 4.3 HS256å®é™…åº”ç”¨


**ğŸ’» Node.jsç¤ºä¾‹**
```javascript
const crypto = require('crypto');

// ç”ŸæˆJWT (HS256)
function createJWT(payload, secret) {
    const header = {
        alg: "HS256",
        typ: "JWT"
    };
    
    // Base64URLç¼–ç 
    const encodedHeader = base64UrlEncode(JSON.stringify(header));
    const encodedPayload = base64UrlEncode(JSON.stringify(payload));
    
    // ç”Ÿæˆç­¾å
    const data = `${encodedHeader}.${encodedPayload}`;
    const signature = crypto
        .createHmac('sha256', secret)
        .update(data)
        .digest('base64url');
    
    return `${data}.${signature}`;
}

// éªŒè¯JWT
function verifyJWT(token, secret) {
    const parts = token.split('.');
    if (parts.length !== 3) return false;
    
    const [header, payload, signature] = parts;
    const data = `${header}.${payload}`;
    
    const expectedSignature = crypto
        .createHmac('sha256', secret)
        .update(data)
        .digest('base64url');
    
    return signature === expectedSignature;
}
```

### 4.4 HS256ä¼˜ç¼ºç‚¹åˆ†æ


| æ–¹é¢ | **ä¼˜ç‚¹** | **ç¼ºç‚¹** |
|------|---------|---------|
| ğŸš€ **æ€§èƒ½** | `è®¡ç®—é€Ÿåº¦å¿«ï¼Œèµ„æºæ¶ˆè€—ä½` | `æ— ` |
| ğŸ”§ **å®ç°** | `ç®€å•æ˜“æ‡‚ï¼Œä»£ç é‡å°‘` | `æ— ` |
| ğŸ”‘ **å¯†é’¥ç®¡ç†** | `åªéœ€è¦ä¸€ä¸ªå¯†é’¥` | `å¯†é’¥åˆ†å‘å›°éš¾` |
| ğŸ¢ **åº”ç”¨åœºæ™¯** | `å•ä½“åº”ç”¨ï¼Œå†…éƒ¨ç³»ç»Ÿ` | `ä¸é€‚åˆåˆ†å¸ƒå¼ç³»ç»Ÿ` |
| ğŸ”’ **å®‰å…¨æ€§** | `ç®—æ³•æˆç†Ÿå¯é ` | `å¯†é’¥æ³„éœ²é£é™©è¾ƒå¤§` |

---

## 5. ğŸ”“ RS256éå¯¹ç§°ç­¾åè¯¦è§£


### 5.1 RS256åŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯RS256**
```
RS256 = RSA-SHA256
â€¢ RSAï¼šéå¯¹ç§°åŠ å¯†ç®—æ³•
â€¢ SHA256ï¼šå®‰å…¨å“ˆå¸Œç®—æ³•256ä½
â€¢ éå¯¹ç§°ï¼šç­¾åç”¨ç§é’¥ï¼ŒéªŒè¯ç”¨å…¬é’¥
```

**ğŸ’¡ é€šä¿—ç†è§£**
```
RS256å°±åƒï¼š
â€¢ ä¸€æŠŠé”é…ä¸¤æŠŠé’¥åŒ™
â€¢ ç§é’¥ç”¨æ¥"é”é—¨"ï¼ˆç­¾åï¼‰
â€¢ å…¬é’¥ç”¨æ¥"éªŒè¯é”"ï¼ˆéªŒè¯ç­¾åï¼‰
â€¢ ç§é’¥å¿…é¡»ä¿å¯†ï¼Œå…¬é’¥å¯ä»¥å…¬å¼€
```

### 5.2 RS256å·¥ä½œåŸç†


**ğŸ” å¯†é’¥å¯¹ç”Ÿæˆ**
```
RSAå¯†é’¥å¯¹åŒ…å«ï¼š
â€¢ ç§é’¥ï¼ˆPrivate Keyï¼‰ï¼šç”¨äºç­¾åï¼Œå¿…é¡»ä¿å¯†
â€¢ å…¬é’¥ï¼ˆPublic Keyï¼‰ï¼šç”¨äºéªŒè¯ï¼Œå¯ä»¥å…¬å¼€

å…³ç³»ï¼š
ç§é’¥ç­¾å â†â†’ å…¬é’¥éªŒè¯ï¼ˆé…å¯¹å…³ç³»ï¼‰
```

**ğŸ”§ ç­¾åå’ŒéªŒè¯æµç¨‹**
```
ç­¾åè¿‡ç¨‹ï¼ˆè®¤è¯æœåŠ¡å™¨ï¼‰ï¼š
1. ç”¨ç§é’¥å¯¹Header.Payloadè¿›è¡ŒRSAç­¾å
2. ç”Ÿæˆsignature
3. è¿”å›å®Œæ•´JWT

éªŒè¯è¿‡ç¨‹ï¼ˆä¸šåŠ¡æœåŠ¡å™¨ï¼‰ï¼š
1. è·å–å…¬é’¥
2. ç”¨å…¬é’¥éªŒè¯signature
3. éªŒè¯æˆåŠŸâ†’æå–ç”¨æˆ·ä¿¡æ¯
4. éªŒè¯å¤±è´¥â†’æ‹’ç»è¯·æ±‚
```

### 5.3 RS256å®é™…åº”ç”¨


**ğŸ’» Node.jsç¤ºä¾‹ï¼ˆç”Ÿæˆå¯†é’¥å¯¹ï¼‰**
```javascript
const crypto = require('crypto');
const fs = require('fs');

// ç”ŸæˆRSAå¯†é’¥å¯¹
function generateKeyPair() {
    const { publicKey, privateKey } = crypto.generateKeyPairSync('rsa', {
        modulusLength: 2048,
        publicKeyEncoding: {
            type: 'spki',
            format: 'pem'
        },
        privateKeyEncoding: {
            type: 'pkcs8',
            format: 'pem'
        }
    });
    
    // ä¿å­˜å¯†é’¥
    fs.writeFileSync('private.pem', privateKey);
    fs.writeFileSync('public.pem', publicKey);
    
    return { publicKey, privateKey };
}
```

**ğŸ’» JWTç­¾åç¤ºä¾‹**
```javascript
const jwt = require('jsonwebtoken');
const fs = require('fs');

// è¯»å–ç§é’¥
const privateKey = fs.readFileSync('private.pem', 'utf8');

// åˆ›å»ºJWT (RS256)
function createJWT(payload) {
    return jwt.sign(payload, privateKey, {
        algorithm: 'RS256',
        expiresIn: '1h',
        issuer: 'auth-server'
    });
}

// ç¤ºä¾‹
const token = createJWT({
    sub: '12345',
    name: 'John Doe',
    role: 'admin'
});

console.log('JWT:', token);
```

**ğŸ’» JWTéªŒè¯ç¤ºä¾‹**
```javascript
// è¯»å–å…¬é’¥
const publicKey = fs.readFileSync('public.pem', 'utf8');

// éªŒè¯JWT (RS256)
function verifyJWT(token) {
    try {
        const decoded = jwt.verify(token, publicKey, {
            algorithms: ['RS256'],
            issuer: 'auth-server'
        });
        return { valid: true, payload: decoded };
    } catch (error) {
        return { valid: false, error: error.message };
    }
}

// ç¤ºä¾‹
const result = verifyJWT(token);
console.log('éªŒè¯ç»“æœ:', result);
```

### 5.4 RS256å¯†é’¥ç®¡ç†


**ğŸ”‘ å¯†é’¥åˆ†å‘ç­–ç•¥**
```
è®¤è¯æœåŠ¡å™¨ï¼ˆæœ‰ç§é’¥ï¼‰ï¼š
â€¢ è´Ÿè´£ç”¨æˆ·ç™»å½•è®¤è¯
â€¢ ç”¨ç§é’¥ç­¾å‘JWT
â€¢ ç§é’¥ç»å¯¹ä¿å¯†

ä¸šåŠ¡æœåŠ¡å™¨ï¼ˆæœ‰å…¬é’¥ï¼‰ï¼š
â€¢ è´Ÿè´£ä¸šåŠ¡é€»è¾‘å¤„ç†
â€¢ ç”¨å…¬é’¥éªŒè¯JWT
â€¢ å…¬é’¥å¯ä»¥å…¬å¼€åˆ†å‘

å¯†é’¥è·å–æ–¹å¼ï¼š
â€¢ é…ç½®æ–‡ä»¶
â€¢ ç¯å¢ƒå˜é‡
â€¢ ä¸“é—¨çš„å¯†é’¥ç®¡ç†æœåŠ¡
â€¢ JWKS (JSON Web Key Set) ç«¯ç‚¹
```

---

## 6. âš–ï¸ HS256 vs RS256å¯¹æ¯”åˆ†æ


### 6.1 æ¶æ„é€‚ç”¨æ€§å¯¹æ¯”


```
å•ä½“åº”ç”¨æ¶æ„ï¼š
    ç”¨æˆ· â†’ [è®¤è¯+ä¸šåŠ¡ä¸€ä½“æœåŠ¡] 
    
    é€‚åˆï¼šHS256
    åŸå› ï¼šåŒä¸€ä¸ªæœåŠ¡ç­¾åå’ŒéªŒè¯ï¼Œå¯†é’¥ç®¡ç†ç®€å•

å¾®æœåŠ¡æ¶æ„ï¼š
    ç”¨æˆ· â†’ [è®¤è¯æœåŠ¡] â†’ JWT
          â†“
    [ä¸šåŠ¡æœåŠ¡A] [ä¸šåŠ¡æœåŠ¡B] [ä¸šåŠ¡æœåŠ¡C]
    
    é€‚åˆï¼šRS256  
    åŸå› ï¼šè®¤è¯æœåŠ¡ç§é’¥ç­¾åï¼Œä¸šåŠ¡æœåŠ¡å…¬é’¥éªŒè¯
```

### 6.2 è¯¦ç»†å¯¹æ¯”è¡¨æ ¼


| å¯¹æ¯”ç»´åº¦ | **HS256 (å¯¹ç§°)** | **RS256 (éå¯¹ç§°)** |
|---------|-----------------|-------------------|
| ğŸ”‘ **å¯†é’¥ç±»å‹** | `å•ä¸€å…±äº«å¯†é’¥` | `ç§é’¥+å…¬é’¥å¯¹` |
| ğŸ—ï¸ **é€‚ç”¨æ¶æ„** | `å•ä½“åº”ç”¨` | `åˆ†å¸ƒå¼å¾®æœåŠ¡` |
| âš¡ **æ€§èƒ½è¡¨ç°** | `ğŸš€ å¿«é€Ÿï¼ˆæ¯«ç§’çº§ï¼‰` | `ğŸŒ è¾ƒæ…¢ï¼ˆ10å€å·®è·ï¼‰` |
| ğŸ”§ **å®ç°å¤æ‚åº¦** | `âœ… ç®€å•æ˜“æ‡‚` | `âš ï¸ éœ€è¦å¯†é’¥ç®¡ç†` |
| ğŸ”’ **å®‰å…¨é£é™©** | `âŒ å¯†é’¥æ³„éœ²å½±å“å¤§` | `âœ… ç§é’¥æ³„éœ²å½±å“å¯æ§` |
| ğŸ“ˆ **æ‰©å±•æ€§** | `âŒ éš¾ä»¥æ°´å¹³æ‰©å±•` | `âœ… æ˜“äºæ°´å¹³æ‰©å±•` |
| ğŸ”„ **å¯†é’¥è½®æ¢** | `âŒ éœ€è¦åŒæ­¥æ›´æ–°` | `âœ… ç‹¬ç«‹æ›´æ–°` |
| ğŸ’° **èµ„æºæ¶ˆè€—** | `ğŸ’š ä½` | `ğŸ’› ä¸­ç­‰` |

### 6.3 é€‰æ‹©å†³ç­–æ ‘


```
é€‰æ‹©HS256çš„åœºæ™¯ï¼š
âœ… å•ä½“åº”ç”¨æˆ–å•å›¢é˜Ÿå¼€å‘
âœ… å¯¹æ€§èƒ½è¦æ±‚æé«˜
âœ… å†…éƒ¨ç³»ç»Ÿï¼Œå®‰å…¨è¦æ±‚ä¸å¤ªä¸¥æ ¼
âœ… å¼€å‘å›¢é˜Ÿå¯¹å¯†ç å­¦ä¸å¤ªç†Ÿæ‚‰

é€‰æ‹©RS256çš„åœºæ™¯ï¼š
âœ… å¾®æœåŠ¡æ¶æ„
âœ… å¤šä¸ªå›¢é˜Ÿåä½œå¼€å‘  
âœ… å¯¹å¤–æä¾›APIæœåŠ¡
âœ… é«˜å®‰å…¨è¦æ±‚
âœ… éœ€è¦å¯†é’¥éš”ç¦»
```

### 6.4 æ··åˆä½¿ç”¨ç­–ç•¥


**ğŸ”§ å®é™…é¡¹ç›®ä¸­çš„æ™ºèƒ½é€‰æ‹©**
```javascript
// æ ¹æ®åœºæ™¯é€‰æ‹©ç®—æ³•
class JWTService {
    // å†…éƒ¨æœåŠ¡é—´é€šä¿¡ - ä½¿ç”¨HS256
    createInternalToken(payload) {
        return jwt.sign(payload, process.env.INTERNAL_SECRET, {
            algorithm: 'HS256',
            expiresIn: '15m'
        });
    }
    
    // å¯¹å¤–API - ä½¿ç”¨RS256
    createPublicToken(payload) {
        return jwt.sign(payload, privateKey, {
            algorithm: 'RS256', 
            expiresIn: '1h'
        });
    }
}
```

---

## 7. ğŸ›¡ï¸ JWTå®‰å…¨æ€§æ·±åº¦åˆ†æ


### 7.1 å¸¸è§å®‰å…¨æ¼æ´


**ğŸš¨ æ¼æ´1ï¼šç®—æ³•æ··æ·†æ”»å‡»**
```
æ”»å‡»åŸç†ï¼š
1. æœåŠ¡å™¨é…ç½®æ”¯æŒå¤šç§ç®—æ³•ï¼šHS256, RS256
2. æ”»å‡»è€…è·å–RS256çš„å…¬é’¥ï¼ˆå…¬é’¥æ˜¯å…¬å¼€çš„ï¼‰
3. æ”»å‡»è€…ç”¨å…¬é’¥ä½œä¸ºHS256çš„å¯†é’¥ä¼ªé€ JWT
4. ä¿®æ”¹header: {"alg": "HS256"}
5. æœåŠ¡å™¨ç”¨å…¬é’¥éªŒè¯HS256ç­¾åâ†’éªŒè¯é€šè¿‡ï¼

åæœï¼šJWTä¼ªé€ æˆåŠŸï¼
```

**ğŸ”’ é˜²æŠ¤æªæ–½**
```javascript
// é”™è¯¯åšæ³•ï¼šå…è®¸å¤šç§ç®—æ³•
jwt.verify(token, key); // å±é™©ï¼

// æ­£ç¡®åšæ³•ï¼šæ˜ç¡®æŒ‡å®šç®—æ³•
jwt.verify(token, key, { algorithms: ['RS256'] }); // å®‰å…¨ï¼
```

**ğŸš¨ æ¼æ´2ï¼šæ•æ„Ÿä¿¡æ¯æ³„éœ²**
```
é”™è¯¯ç¤ºä¾‹ï¼š
{
  "sub": "12345",
  "password": "123456",        // âŒ å¯†ç 
  "creditCard": "1234-5678",   // âŒ ä¿¡ç”¨å¡
  "ssn": "123-45-6789"         // âŒ ç¤¾ä¼šä¿é™©å·
}

æ­£ç¡®ç¤ºä¾‹ï¼š
{
  "sub": "12345",
  "name": "John Doe",          // âœ… éæ•æ„Ÿ
  "role": "user",              // âœ… æƒé™ä¿¡æ¯
  "exp": 1640995200            // âœ… è¿‡æœŸæ—¶é—´
}
```

**ğŸš¨ æ¼æ´3ï¼šJWTæ°¸ä¸è¿‡æœŸ**
```
é£é™©ï¼š
â€¢ JWTè¢«ç›—åæ°¸ä¹…æœ‰æ•ˆ
â€¢ æ— æ³•æ’¤é”€ç”¨æˆ·æƒé™
â€¢ è´¦æˆ·æ³¨é”€åä»å¯ä½¿ç”¨

è§£å†³æ–¹æ¡ˆï¼š
â€¢ è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´
â€¢ å®ç°åˆ·æ–°ä»¤ç‰Œæœºåˆ¶
â€¢ ç»´æŠ¤é»‘åå•æœºåˆ¶
```

### 7.2 å®‰å…¨æœ€ä½³å®è·µ


**â° è¿‡æœŸæ—¶é—´è®¾ç½®**
```javascript
// ä¸åŒåœºæ™¯çš„è¿‡æœŸæ—¶é—´å»ºè®®
const tokenConfig = {
    // è®¿é—®ä»¤ç‰Œï¼šçŸ­æœŸæœ‰æ•ˆ
    accessToken: {
        expiresIn: '15m',     // 15åˆ†é’Ÿ
        audience: 'api-service'
    },
    
    // åˆ·æ–°ä»¤ç‰Œï¼šé•¿æœŸæœ‰æ•ˆ
    refreshToken: {
        expiresIn: '7d',      // 7å¤©
        audience: 'auth-service'
    },
    
    // å†…éƒ¨æœåŠ¡ï¼šæçŸ­æœŸ
    internalToken: {
        expiresIn: '5m',      // 5åˆ†é’Ÿ
        audience: 'internal'
    }
};
```

**ğŸ”„ åˆ·æ–°ä»¤ç‰Œæœºåˆ¶**
```javascript
class TokenService {
    // åŒä»¤ç‰Œç­–ç•¥
    generateTokenPair(user) {
        const accessToken = jwt.sign(
            { sub: user.id, role: user.role },
            process.env.ACCESS_SECRET,
            { expiresIn: '15m' }
        );
        
        const refreshToken = jwt.sign(
            { sub: user.id, type: 'refresh' },
            process.env.REFRESH_SECRET,
            { expiresIn: '7d' }
        );
        
        return { accessToken, refreshToken };
    }
    
    // åˆ·æ–°è®¿é—®ä»¤ç‰Œ
    async refreshAccessToken(refreshToken) {
        try {
            const decoded = jwt.verify(refreshToken, process.env.REFRESH_SECRET);
            if (decoded.type !== 'refresh') throw new Error('Invalid token type');
            
            const user = await User.findById(decoded.sub);
            return this.generateTokenPair(user);
        } catch (error) {
            throw new Error('Invalid refresh token');
        }
    }
}
```

### 7.3 JWTé»‘åå•æœºåˆ¶


**ğŸš« å®ç°ä»¤ç‰Œæ’¤é”€**
```javascript
// Rediså®ç°JWTé»‘åå•
class JWTBlacklist {
    constructor(redisClient) {
        this.redis = redisClient;
    }
    
    // æ·»åŠ åˆ°é»‘åå•
    async revoke(token) {
        const decoded = jwt.decode(token);
        const ttl = decoded.exp - Math.floor(Date.now() / 1000);
        
        if (ttl > 0) {
            await this.redis.setex(`blacklist:${decoded.jti}`, ttl, '1');
        }
    }
    
    // æ£€æŸ¥æ˜¯å¦åœ¨é»‘åå•
    async isRevoked(token) {
        const decoded = jwt.decode(token);
        const exists = await this.redis.exists(`blacklist:${decoded.jti}`);
        return exists === 1;
    }
    
    // éªŒè¯ä¸­é—´ä»¶
    async verifyMiddleware(req, res, next) {
        const token = req.headers.authorization?.replace('Bearer ', '');
        
        if (!token) {
            return res.status(401).json({ error: 'No token provided' });
        }
        
        try {
            // 1. éªŒè¯ç­¾å
            const decoded = jwt.verify(token, process.env.JWT_SECRET);
            
            // 2. æ£€æŸ¥é»‘åå•
            if (await this.isRevoked(token)) {
                return res.status(401).json({ error: 'Token revoked' });
            }
            
            req.user = decoded;
            next();
        } catch (error) {
            res.status(401).json({ error: 'Invalid token' });
        }
    }
}
```

---

## 8. ğŸ” APIç­¾åéªŒè¯æœºåˆ¶


### 8.1 APIç­¾ååŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯APIç­¾å**
```
APIç­¾å = å¯¹APIè¯·æ±‚è¿›è¡Œæ•°å­—ç­¾å
ç›®çš„ï¼š
â€¢ éªŒè¯è¯·æ±‚æ¥æºçš„çœŸå®æ€§
â€¢ é˜²æ­¢è¯·æ±‚æ•°æ®è¢«ç¯¡æ”¹
â€¢ é˜²æ­¢é‡æ”¾æ”»å‡»
â€¢ ç¡®ä¿æ•°æ®ä¼ è¾“å®‰å…¨
```

**ğŸ’¡ é€šä¿—ç†è§£**
```
APIç­¾åå°±åƒï¼š
â€¢ ç»™æ¯ä¸ªAPIè¯·æ±‚"ç›–ç« "
â€¢ è¿™ä¸ª"ç« "è¯æ˜è¯·æ±‚æ˜¯çœŸå®çš„
â€¢ ä»»ä½•ä¿®æ”¹éƒ½ä¼šè®©"ç« "å¤±æ•ˆ
â€¢ åªæœ‰æœ‰æƒé™çš„äººæ‰èƒ½"ç›–ç« "
```

### 8.2 APIç­¾åå·¥ä½œæµç¨‹


```
å®Œæ•´çš„APIç­¾åæµç¨‹ï¼š

å®¢æˆ·ç«¯ï¼š
1. å‡†å¤‡è¯·æ±‚å‚æ•°
2. æŒ‰è§„åˆ™æ’åºå‚æ•°
3. æ‹¼æ¥æˆå­—ç¬¦ä¸²
4. ç”¨å¯†é’¥è¿›è¡Œç­¾å
5. å°†ç­¾åæ·»åŠ åˆ°è¯·æ±‚ä¸­
6. å‘é€è¯·æ±‚

æœåŠ¡å™¨ï¼š
1. æ¥æ”¶è¯·æ±‚
2. æå–ç­¾å
3. æŒ‰ç›¸åŒè§„åˆ™é‡æ–°è®¡ç®—ç­¾å
4. å¯¹æ¯”ç­¾åæ˜¯å¦ä¸€è‡´
5. ä¸€è‡´â†’å¤„ç†è¯·æ±‚ï¼Œä¸ä¸€è‡´â†’æ‹’ç»
```

### 8.3 å¸¸è§ç­¾åç®—æ³•å®ç°


**ğŸ”§ HMAC-SHA256ç­¾åç¤ºä¾‹**
```javascript
const crypto = require('crypto');

class APISignature {
    constructor(secretKey) {
        this.secretKey = secretKey;
    }
    
    // ç”Ÿæˆç­¾å
    generateSignature(method, url, params, timestamp) {
        // 1. å‚æ•°æ’åº
        const sortedParams = Object.keys(params)
            .sort()
            .map(key => `${key}=${params[key]}`)
            .join('&');
        
        // 2. æ„é€ ç­¾åå­—ç¬¦ä¸²
        const signString = [
            method.toUpperCase(),
            url,
            sortedParams,
            timestamp
        ].join('\n');
        
        // 3. HMAC-SHA256ç­¾å
        return crypto
            .createHmac('sha256', this.secretKey)
            .update(signString)
            .digest('hex');
    }
    
    // éªŒè¯ç­¾å
    verifySignature(signature, method, url, params, timestamp) {
        const expectedSignature = this.generateSignature(method, url, params, timestamp);
        return signature === expectedSignature;
    }
}

// ä½¿ç”¨ç¤ºä¾‹
const apiSigner = new APISignature('your-secret-key');

// å®¢æˆ·ç«¯ç”Ÿæˆç­¾å
const params = { userId: '123', amount: '100' };
const timestamp = Date.now();
const signature = apiSigner.generateSignature('POST', '/api/payment', params, timestamp);

console.log('ç­¾å:', signature);
```

### 8.4 é˜²é‡æ”¾æ”»å‡»æœºåˆ¶


**â° æ—¶é—´æˆ³éªŒè¯**
```javascript
class ReplayProtection {
    constructor(maxTimeDiff = 300000) { // 5åˆ†é’Ÿ
        this.maxTimeDiff = maxTimeDiff;
        this.usedNonces = new Set();
    }
    
    // éªŒè¯æ—¶é—´æˆ³
    validateTimestamp(timestamp) {
        const now = Date.now();
        const diff = Math.abs(now - timestamp);
        return diff <= this.maxTimeDiff;
    }
    
    // éªŒè¯éšæœºæ•°ï¼ˆé˜²æ­¢é‡å¤è¯·æ±‚ï¼‰
    validateNonce(nonce) {
        if (this.usedNonces.has(nonce)) {
            return false; // é‡å¤çš„nonce
        }
        
        this.usedNonces.add(nonce);
        
        // æ¸…ç†è¿‡æœŸçš„nonceï¼ˆç®€å•å®ç°ï¼‰
        if (this.usedNonces.size > 10000) {
            this.usedNonces.clear();
        }
        
        return true;
    }
    
    // å®Œæ•´éªŒè¯
    validateRequest(timestamp, nonce) {
        return this.validateTimestamp(timestamp) && this.validateNonce(nonce);
    }
}
```

### 8.5 å®Œæ•´çš„APIç­¾åä¸­é—´ä»¶


**ğŸ”§ Expressä¸­é—´ä»¶å®ç°**
```javascript
const express = require('express');
const crypto = require('crypto');

function createSignatureMiddleware(secretKey) {
    return (req, res, next) => {
        try {
            // 1. æå–ç­¾åç›¸å…³ä¿¡æ¯
            const signature = req.headers['x-signature'];
            const timestamp = req.headers['x-timestamp'];
            const nonce = req.headers['x-nonce'];
            
            if (!signature || !timestamp || !nonce) {
                return res.status(401).json({ error: 'Missing signature headers' });
            }
            
            // 2. éªŒè¯æ—¶é—´æˆ³ï¼ˆé˜²é‡æ”¾ï¼‰
            const now = Date.now();
            if (Math.abs(now - parseInt(timestamp)) > 300000) { // 5åˆ†é’Ÿ
                return res.status(401).json({ error: 'Request expired' });
            }
            
            // 3. æ„é€ ç­¾åå­—ç¬¦ä¸²
            const method = req.method;
            const url = req.originalUrl;
            const params = { ...req.query, ...req.body };
            
            const signString = [
                method,
                url,
                JSON.stringify(params),
                timestamp,
                nonce
            ].join('\n');
            
            // 4. è®¡ç®—æœŸæœ›ç­¾å
            const expectedSignature = crypto
                .createHmac('sha256', secretKey)
                .update(signString)
                .digest('hex');
            
            // 5. éªŒè¯ç­¾å
            if (signature !== expectedSignature) {
                return res.status(401).json({ error: 'Invalid signature' });
            }
            
            next();
        } catch (error) {
            res.status(500).json({ error: 'Signature verification failed' });
        }
    };
}

// ä½¿ç”¨ç­¾åä¸­é—´ä»¶
const app = express();
app.use('/api/secure', createSignatureMiddleware('your-secret-key'));
```

---

## 9. ğŸš€ å®é™…åº”ç”¨æœ€ä½³å®è·µ


### 9.1 JWT + APIç­¾åç»„åˆä½¿ç”¨


**ğŸ”§ å¤šå±‚å®‰å…¨æ¶æ„**
```javascript
class SecurityService {
    constructor() {
        this.jwtSecret = process.env.JWT_SECRET;
        this.apiSecret = process.env.API_SECRET;
    }
    
    // ç¬¬ä¸€å±‚ï¼šJWTèº«ä»½éªŒè¯
    async verifyJWT(token) {
        try {
            return jwt.verify(token, this.jwtSecret);
        } catch (error) {
            throw new Error('Invalid JWT token');
        }
    }
    
    // ç¬¬äºŒå±‚ï¼šAPIç­¾åéªŒè¯
    verifyAPISignature(req) {
        const signature = req.headers['x-signature'];
        const timestamp = req.headers['x-timestamp'];
        
        // æ„é€ ç­¾åå­—ç¬¦ä¸²
        const signString = `${req.method}${req.url}${timestamp}`;
        const expectedSignature = crypto
            .createHmac('sha256', this.apiSecret)
            .update(signString)
            .digest('hex');
        
        return signature === expectedSignature;
    }
    
    // ç»¼åˆéªŒè¯ä¸­é—´ä»¶
    createSecurityMiddleware() {
        return async (req, res, next) => {
            try {
                // 1. JWTéªŒè¯
                const token = req.headers.authorization?.replace('Bearer ', '');
                const user = await this.verifyJWT(token);
                
                // 2. APIç­¾åéªŒè¯
                if (!this.verifyAPISignature(req)) {
                    return res.status(401).json({ error: 'Invalid API signature' });
                }
                
                req.user = user;
                next();
            } catch (error) {
                res.status(401).json({ error: error.message });
            }
        };
    }
}
```

### 9.2 ä¸åŒåœºæ™¯çš„å®‰å…¨ç­–ç•¥


**ğŸ“± ç§»åŠ¨åº”ç”¨å®‰å…¨ç­–ç•¥**
```javascript
// ç§»åŠ¨ç«¯ä¸“ç”¨é…ç½®
const mobileJWTConfig = {
    // çŸ­æœŸè®¿é—®ä»¤ç‰Œ
    accessToken: {
        expiresIn: '30m',
        algorithm: 'HS256',    // ç§»åŠ¨ç«¯ä½¿ç”¨HS256å³å¯
        audience: 'mobile-app'
    },
    
    // é•¿æœŸåˆ·æ–°ä»¤ç‰Œ
    refreshToken: {
        expiresIn: '30d',
        algorithm: 'HS256',
        audience: 'mobile-app'
    }
};

// ç§»åŠ¨ç«¯å®‰å…¨ä¸­é—´ä»¶
function mobileSecurityMiddleware(req, res, next) {
    // 1. æ£€æŸ¥è®¾å¤‡æŒ‡çº¹
    const deviceId = req.headers['x-device-id'];
    if (!deviceId) {
        return res.status(401).json({ error: 'Device ID required' });
    }
    
    // 2. JWTéªŒè¯
    const token = req.headers.authorization?.replace('Bearer ', '');
    try {
        const decoded = jwt.verify(token, process.env.MOBILE_SECRET);
        req.user = decoded;
        req.deviceId = deviceId;
        next();
    } catch (error) {
        res.status(401).json({ error: 'Invalid token' });
    }
}
```

**ğŸŒ Webåº”ç”¨å®‰å…¨ç­–ç•¥**
```javascript
// Webç«¯é…ç½®ï¼ˆæ›´ä¸¥æ ¼ï¼‰
const webJWTConfig = {
    accessToken: {
        expiresIn: '15m',      // æ›´çŸ­çš„æœ‰æ•ˆæœŸ
        algorithm: 'RS256',    // ä½¿ç”¨éå¯¹ç§°åŠ å¯†
        audience: 'web-app'
    }
};

// Webç«¯å®‰å…¨ä¸­é—´ä»¶
function webSecurityMiddleware(req, res, next) {
    // 1. CSRFæ£€æŸ¥
    const csrfToken = req.headers['x-csrf-token'];
    if (!csrfToken || !validateCSRF(csrfToken, req.session)) {
        return res.status(403).json({ error: 'CSRF token invalid' });
    }
    
    // 2. IPç™½åå•æ£€æŸ¥
    const clientIP = req.ip;
    if (!isIPAllowed(clientIP)) {
        return res.status(403).json({ error: 'IP not allowed' });
    }
    
    // 3. JWTéªŒè¯
    const token = req.headers.authorization?.replace('Bearer ', '');
    try {
        const decoded = jwt.verify(token, publicKey, { algorithms: ['RS256'] });
        req.user = decoded;
        next();
    } catch (error) {
        res.status(401).json({ error: 'Invalid token' });
    }
}
```

### 9.3 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


**ğŸš€ ç¼“å­˜ä¼˜åŒ–**
```javascript
const Redis = require('redis');
const redis = Redis.createClient();

class OptimizedJWTService {
    // ç¼“å­˜å…¬é’¥ï¼ˆé¿å…é‡å¤è¯»å–æ–‡ä»¶ï¼‰
    async getPublicKey() {
        const cacheKey = 'jwt:public-key';
        let publicKey = await redis.get(cacheKey);
        
        if (!publicKey) {
            publicKey = fs.readFileSync('public.pem', 'utf8');
            await redis.setex(cacheKey, 3600, publicKey); // ç¼“å­˜1å°æ—¶
        }
        
        return publicKey;
    }
    
    // ç¼“å­˜éªŒè¯ç»“æœï¼ˆçŸ­æ—¶é—´å†…ç›¸åŒtokenä¸é‡å¤éªŒè¯ï¼‰
    async verifyTokenWithCache(token) {
        const cacheKey = `jwt:verified:${crypto.createHash('md5').update(token).digest('hex')}`;
        let result = await redis.get(cacheKey);
        
        if (result) {
            return JSON.parse(result);
        }
        
        try {
            const publicKey = await this.getPublicKey();
            const decoded = jwt.verify(token, publicKey);
            
            // ç¼“å­˜éªŒè¯ç»“æœï¼ˆç¼“å­˜æ—¶é—´ä¸ºtokenå‰©ä½™æ—¶é—´çš„ä¸€åŠï¼‰
            const ttl = Math.max(60, Math.floor((decoded.exp - Date.now() / 1000) / 2));
            await redis.setex(cacheKey, ttl, JSON.stringify(decoded));
            
            return decoded;
        } catch (error) {
            throw error;
        }
    }
}
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ JWTæœ¬è´¨ï¼šæ— çŠ¶æ€çš„æ•°å­—èº«ä»½è¯ï¼ŒåŒ…å«ç”¨æˆ·ä¿¡æ¯å’Œæ•°å­—ç­¾å
ğŸ”¸ ä¸‰æ®µç»“æ„ï¼šHeaderï¼ˆç®—æ³•ä¿¡æ¯ï¼‰+ Payloadï¼ˆç”¨æˆ·æ•°æ®ï¼‰+ Signatureï¼ˆé˜²ç¯¡æ”¹ç­¾åï¼‰
ğŸ”¸ ç­¾åä½œç”¨ï¼šé˜²æ­¢JWTè¢«ç¯¡æ”¹ï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§å’Œæ¥æºå¯ä¿¡
ğŸ”¸ å¯¹ç§°vséå¯¹ç§°ï¼šHS256ç”¨å…±äº«å¯†é’¥ï¼ŒRS256ç”¨å…¬ç§é’¥å¯¹
ğŸ”¸ APIç­¾åï¼šå¯¹æ•´ä¸ªAPIè¯·æ±‚è¿›è¡Œç­¾åï¼Œé˜²ç¯¡æ”¹å’Œé‡æ”¾æ”»å‡»
```

### 10.2 å…³é”®å®‰å…¨è¦ç‚¹


**ğŸ”¹ JWTå®‰å…¨ä½¿ç”¨åŸåˆ™**
```
âœ… å¿…é¡»åšçš„ï¼š
â€¢ è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´
â€¢ æ˜ç¡®æŒ‡å®šç­¾åç®—æ³•
â€¢ æ•æ„Ÿä¿¡æ¯ç»ä¸æ”¾å…¥JWT
â€¢ ä½¿ç”¨HTTPSä¼ è¾“
â€¢ å®ç°åˆ·æ–°ä»¤ç‰Œæœºåˆ¶

âŒ ç»ä¸èƒ½åšçš„ï¼š
â€¢ åœ¨JWTä¸­å­˜å‚¨å¯†ç ç­‰æ•æ„Ÿä¿¡æ¯
â€¢ å…è®¸ç®—æ³•æ··æ·†æ”»å‡»
â€¢ ä½¿ç”¨æ°¸ä¸è¿‡æœŸçš„JWT
â€¢ å¿½ç•¥æ—¶é—´æˆ³éªŒè¯
â€¢ åœ¨å®¢æˆ·ç«¯å­˜å‚¨ç§é’¥
```

**ğŸ”¹ ç®—æ³•é€‰æ‹©ç­–ç•¥**
```
é€‰æ‹©HS256çš„åœºæ™¯ï¼š
â€¢ å•ä½“åº”ç”¨æˆ–å†…éƒ¨ç³»ç»Ÿ
â€¢ å¯¹æ€§èƒ½è¦æ±‚æé«˜
â€¢ å¯†é’¥ç®¡ç†ç›¸å¯¹ç®€å•

é€‰æ‹©RS256çš„åœºæ™¯ï¼š
â€¢ å¾®æœåŠ¡æ¶æ„
â€¢ å¤šå›¢é˜Ÿåä½œå¼€å‘
â€¢ å¯¹å¤–æä¾›APIæœåŠ¡
â€¢ éœ€è¦å¯†é’¥éš”ç¦»
```

### 10.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ ä¸åŒåœºæ™¯çš„æœ€ä½³å®è·µ**
```
ç§»åŠ¨åº”ç”¨ï¼š
â€¢ ä½¿ç”¨HS256ï¼ˆæ€§èƒ½ä¼˜å…ˆï¼‰
â€¢ è¾ƒé•¿çš„åˆ·æ–°ä»¤ç‰Œå‘¨æœŸ
â€¢ ç»“åˆè®¾å¤‡æŒ‡çº¹éªŒè¯

Webåº”ç”¨ï¼š
â€¢ ä½¿ç”¨RS256ï¼ˆå®‰å…¨ä¼˜å…ˆï¼‰
â€¢ çŸ­æœŸè®¿é—®ä»¤ç‰Œ
â€¢ ç»“åˆCSRFé˜²æŠ¤

APIæœåŠ¡ï¼š
â€¢ JWT + APIç­¾ååŒé‡éªŒè¯
â€¢ ä¸¥æ ¼çš„æ—¶é—´æˆ³æ£€æŸ¥
â€¢ IPç™½åå•ç­‰é¢å¤–é˜²æŠ¤
```

**ğŸ”§ æ€§èƒ½ä¼˜åŒ–å»ºè®®**
```
â€¢ ç¼“å­˜å…¬é’¥é¿å…é‡å¤è¯»å–
â€¢ ç¼“å­˜éªŒè¯ç»“æœå‡å°‘è®¡ç®—
â€¢ åˆç†è®¾ç½®ä»¤ç‰Œè¿‡æœŸæ—¶é—´
â€¢ ä½¿ç”¨Redisç­‰é«˜æ€§èƒ½ç¼“å­˜
â€¢ ç›‘æ§å’Œæ—¥å¿—è®°å½•å®‰å…¨äº‹ä»¶
```

### 10.4 å¸¸è§é”™è¯¯é¿å…


**âš ï¸ å…¸å‹å®‰å…¨é™·é˜±**
```
1. ç®—æ³•æ··æ·†æ¼æ´ï¼š
   é”™è¯¯ï¼šjwt.verify(token, key)
   æ­£ç¡®ï¼šjwt.verify(token, key, {algorithms: ['RS256']})

2. æ•æ„Ÿä¿¡æ¯æ³„éœ²ï¼š
   é”™è¯¯ï¼š{password: "123456", creditCard: "1234"}
   æ­£ç¡®ï¼š{sub: "12345", role: "user"}

3. æ— è¿‡æœŸæ—¶é—´ï¼š
   é”™è¯¯ï¼šjwt.sign(payload, secret)
   æ­£ç¡®ï¼šjwt.sign(payload, secret, {expiresIn: '1h'})

4. ç¼ºå°‘é‡æ”¾ä¿æŠ¤ï¼š
   é”™è¯¯ï¼šåªéªŒè¯ç­¾å
   æ­£ç¡®ï¼šéªŒè¯ç­¾å+æ—¶é—´æˆ³+éšæœºæ•°
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- JWTä¸‰æ®µå¼ï¼Œç­¾åé˜²ç¯¡æ”¹
- å¯¹ç§°å¿«é€Ÿå†…éƒ¨ç”¨ï¼Œéå¯¹ç§°å®‰å…¨åˆ†å¸ƒå¼
- æ•æ„Ÿä¿¡æ¯ä¸èƒ½æ”¾ï¼Œè¿‡æœŸæ—¶é—´å¿…é¡»è®¾
- APIç­¾åé˜²é‡æ”¾ï¼Œå¤šå±‚é˜²æŠ¤æ›´å®‰å…¨

**å­¦ä¹ å»ºè®®**ï¼š
- ğŸ¯ å…ˆç†è§£JWTåŸºæœ¬åŸç†å’Œç»“æ„
- ğŸ”§ é€šè¿‡ç®€å•ç¤ºä¾‹æŒæ¡HS256å’ŒRS256
- ğŸ›¡ï¸ é‡ç‚¹å­¦ä¹ å„ç§å®‰å…¨æ¼æ´å’Œé˜²æŠ¤æªæ–½
- ğŸš€ ç»“åˆå®é™…é¡¹ç›®ç»ƒä¹ æœ€ä½³å®è·µ