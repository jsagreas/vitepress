---
title: 7ã€DaemonSetå®ˆæŠ¤è¿›ç¨‹
---
## ğŸ“š ç›®å½•

1. [DaemonSetåŸºæœ¬æ¦‚å¿µ](#1-daemonsetåŸºæœ¬æ¦‚å¿µ)
2. [DaemonSetå·¥ä½œåŸç†](#2-daemonsetå·¥ä½œåŸç†)
3. [èŠ‚ç‚¹é€‰æ‹©å™¨é…ç½®](#3-èŠ‚ç‚¹é€‰æ‹©å™¨é…ç½®)
4. [å®ˆæŠ¤è¿›ç¨‹æ›´æ–°ç­–ç•¥](#4-å®ˆæŠ¤è¿›ç¨‹æ›´æ–°ç­–ç•¥)
5. [å…¸å‹åº”ç”¨åœºæ™¯](#5-å…¸å‹åº”ç”¨åœºæ™¯)
6. [å®æˆ˜æ¡ˆä¾‹æ¼”ç»ƒ](#6-å®æˆ˜æ¡ˆä¾‹æ¼”ç»ƒ)
7. [æœ€ä½³å®è·µæŒ‡å—](#7-æœ€ä½³å®è·µæŒ‡å—)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” DaemonSetåŸºæœ¬æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯DaemonSet


**é€šä¿—ç†è§£**ï¼šDaemonSetå°±åƒæ˜¯**ä¿å®‰å®ˆå¤œ**ï¼Œæ¯æ ‹æ¥¼éƒ½è¦æœ‰ä¸€ä¸ªä¿å®‰ï¼Œä¸èƒ½å¤šä¹Ÿä¸èƒ½å°‘ã€‚

```
ä¼ ç»Ÿéƒ¨ç½²æ¨¡å¼ï¼š                DaemonSetæ¨¡å¼ï¼š
  åº”ç”¨éšæ„éƒ¨ç½²                  æ¯ä¸ªèŠ‚ç‚¹å›ºå®šä¸€ä¸ª
     
é›†ç¾¤èŠ‚ç‚¹:                     é›†ç¾¤èŠ‚ç‚¹:
Node1: [App][App]            Node1: [DaemonSet Pod]
Node2: []                    Node2: [DaemonSet Pod] 
Node3: [App]                 Node3: [DaemonSet Pod]

é—®é¢˜ï¼šåˆ†å¸ƒä¸å‡                 ä¼˜åŠ¿ï¼šè¦†ç›–å®Œæ•´
```

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š
- ğŸ¯ **å…¨èŠ‚ç‚¹è¦†ç›–**ï¼šæ¯ä¸ªç¬¦åˆæ¡ä»¶çš„èŠ‚ç‚¹éƒ½è¿è¡Œä¸€ä¸ªPod
- ğŸ”„ **è‡ªåŠ¨è°ƒåº¦**ï¼šæ–°èŠ‚ç‚¹åŠ å…¥æ—¶è‡ªåŠ¨éƒ¨ç½²
- ğŸ—‘ï¸ **è‡ªåŠ¨æ¸…ç†**ï¼šèŠ‚ç‚¹ç§»é™¤æ—¶è‡ªåŠ¨åˆ é™¤Pod
- ğŸ“ **ä½ç½®å›ºå®š**ï¼šPodä¸èŠ‚ç‚¹ç»‘å®šï¼Œä¸ä¼šéšæ„è¿ç§»

### 1.2 DaemonSet vs Deploymentå¯¹æ¯”


| ç‰¹æ€§å¯¹æ¯” | **DaemonSet** | **Deployment** |
|---------|--------------|----------------|
| ğŸ¯ **éƒ¨ç½²ç›®æ ‡** | `æ¯ä¸ªèŠ‚ç‚¹ä¸€ä¸ªPod` | `æ€»å…±Nä¸ªPodï¼Œéšæ„åˆ†å¸ƒ` |
| ğŸ“Š **å‰¯æœ¬æ§åˆ¶** | `èŠ‚ç‚¹æ•°é‡å†³å®š` | `æ‰‹åŠ¨æŒ‡å®šå‰¯æœ¬æ•°` |
| ğŸ”„ **è°ƒåº¦ç­–ç•¥** | `ç»‘å®šèŠ‚ç‚¹è°ƒåº¦` | `é›†ç¾¤æœ€ä¼˜è°ƒåº¦` |
| ğŸ“ˆ **æ‰©å®¹æ–¹å¼** | `å¢åŠ èŠ‚ç‚¹è‡ªåŠ¨æ‰©å®¹` | `æ‰‹åŠ¨ä¿®æ”¹å‰¯æœ¬æ•°` |
| ğŸª **å…¸å‹ç”¨é€”** | `ç³»ç»ŸæœåŠ¡ã€ç›‘æ§` | `ä¸šåŠ¡åº”ç”¨` |

### 1.3 é€‚ç”¨åœºæ™¯åˆ¤æ–­


**âœ… é€‚åˆç”¨DaemonSetçš„åœºæ™¯**ï¼š
```
ğŸ” ç›‘æ§åœºæ™¯ï¼šæ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦ç›‘æ§ä»£ç†
ğŸ“Š æ—¥å¿—æ”¶é›†ï¼šæ¯ä¸ªèŠ‚ç‚¹éƒ½è¦æ”¶é›†ç³»ç»Ÿæ—¥å¿—  
ğŸ›¡ï¸ å®‰å…¨æ‰«æï¼šæ¯ä¸ªèŠ‚ç‚¹éƒ½è¦è¿è¡Œå®‰å…¨å·¥å…·
ğŸŒ ç½‘ç»œå·¥å…·ï¼šæ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦ç½‘ç»œä»£ç†
ğŸ—„ï¸ å­˜å‚¨æœåŠ¡ï¼šåˆ†å¸ƒå¼å­˜å‚¨æ¯èŠ‚ç‚¹ä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹
```

**âŒ ä¸é€‚åˆç”¨DaemonSetçš„åœºæ™¯**ï¼š
```
ğŸŒ Webåº”ç”¨ï¼šç”¨æˆ·è®¿é—®é‡å†³å®šå‰¯æœ¬æ•°ï¼Œä¸æ˜¯èŠ‚ç‚¹æ•°
ğŸ’¾ æ•°æ®åº“ï¼šé€šå¸¸åªéœ€è¦å°‘é‡å®ä¾‹ï¼Œä¸éœ€è¦æ¯èŠ‚ç‚¹éƒ½æœ‰
ğŸ”„ ä»»åŠ¡å¤„ç†ï¼šæ ¹æ®é˜Ÿåˆ—é•¿åº¦åŠ¨æ€æ‰©å®¹ï¼Œä¸èŠ‚ç‚¹æ— å…³
```

---

## 2. âš™ï¸ DaemonSetå·¥ä½œåŸç†


### 2.1 æ§åˆ¶å™¨å·¥ä½œæµç¨‹


```
DaemonSetæ§åˆ¶å™¨ç›‘æ§æµç¨‹ï¼š

                    Kubernetes API
                         |
                 [DaemonSet Controller]
                         |
        ç›‘æ§èŠ‚ç‚¹çŠ¶æ€ + ç›‘æ§PodçŠ¶æ€
                         |
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼                   â–¼
        èŠ‚ç‚¹å¢åŠ /åˆ é™¤         Podå¼‚å¸¸/åˆ é™¤
              |                   |
        è‡ªåŠ¨åˆ›å»º/åˆ é™¤Pod      è‡ªåŠ¨é‡æ–°åˆ›å»ºPod
              |                   |
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â–¼
                ä¿æŒ"æ¯èŠ‚ç‚¹ä¸€ä¸ªPod"çŠ¶æ€
```

### 2.2 Podåˆ›å»ºæœºåˆ¶è¯¦è§£


**åˆ›å»ºè¿‡ç¨‹**ï¼š
1. **èŠ‚ç‚¹æ‰«æ**ï¼šæ§åˆ¶å™¨æ‰«ææ‰€æœ‰èŠ‚ç‚¹
2. **åŒ¹é…æ£€æŸ¥**ï¼šæ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦ç¬¦åˆé€‰æ‹©å™¨æ¡ä»¶
3. **Podæ£€æŸ¥**ï¼šæ£€æŸ¥è¯¥èŠ‚ç‚¹æ˜¯å¦å·²æœ‰å¯¹åº”Pod
4. **è‡ªåŠ¨åˆ›å»º**ï¼šç¼ºå¤±Podæ—¶è‡ªåŠ¨åˆ›å»ºå¹¶ç»‘å®šåˆ°èŠ‚ç‚¹

**å®é™…å·¥ä½œç¤ºä¾‹**ï¼š
```
å‡è®¾æœ‰3ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤ï¼š

åˆå§‹çŠ¶æ€ï¼š
Node1: worker-node-1  [æ— Pod]
Node2: worker-node-2  [æ— Pod]  
Node3: worker-node-3  [æ— Pod]

DaemonSetåˆ›å»ºåï¼š
Node1: worker-node-1  [monitoring-pod-abc]
Node2: worker-node-2  [monitoring-pod-def]
Node3: worker-node-3  [monitoring-pod-ghi]

æ–°å¢èŠ‚ç‚¹åï¼š
Node1: worker-node-1  [monitoring-pod-abc]
Node2: worker-node-2  [monitoring-pod-def]
Node3: worker-node-3  [monitoring-pod-ghi]
Node4: worker-node-4  [monitoring-pod-new] â† è‡ªåŠ¨åˆ›å»º
```

### 2.3 è°ƒåº¦æœºåˆ¶ç‰¹ç‚¹


**ç‰¹æ®Šè°ƒåº¦è¡Œä¸º**ï¼š
- ğŸ¯ **ç›´æ¥è°ƒåº¦**ï¼šè·³è¿‡é»˜è®¤è°ƒåº¦å™¨ï¼Œç›´æ¥ç»‘å®šèŠ‚ç‚¹
- ğŸš« **å¿½ç•¥æ±¡ç‚¹**ï¼šå¯ä»¥å®¹å¿èŠ‚ç‚¹æ±¡ç‚¹ï¼Œè¿è¡Œåœ¨ç‰¹æ®ŠèŠ‚ç‚¹
- ğŸ”’ **èŠ‚ç‚¹ç»‘å®š**ï¼šPodä¸èŠ‚ç‚¹å¼ºç»‘å®šï¼Œä¸ä¼šé‡æ–°è°ƒåº¦

---

## 3. ğŸ“ èŠ‚ç‚¹é€‰æ‹©å™¨é…ç½®


### 3.1 åŸºç¡€èŠ‚ç‚¹é€‰æ‹©


**nodeSelector - ç®€å•é€‰æ‹©æ–¹å¼**ï¼š
```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: monitoring-daemon
spec:
  selector:
    matchLabels:
      app: monitoring
  template:
    metadata:
      labels:
        app: monitoring
    spec:
      # åªåœ¨æœ‰disk=ssdæ ‡ç­¾çš„èŠ‚ç‚¹ä¸Šè¿è¡Œ
      nodeSelector:
        disk: ssd
      containers:
      - name: monitoring
        image: monitoring:v1.0
```

**æ ‡ç­¾èŠ‚ç‚¹ç¤ºä¾‹**ï¼š
```bash
# ç»™èŠ‚ç‚¹æ‰“æ ‡ç­¾
kubectl label nodes worker-1 disk=ssd
kubectl label nodes worker-2 disk=hdd  
kubectl label nodes worker-3 disk=ssd

# ç»“æœï¼šåªæœ‰worker-1å’Œworker-3ä¼šè¿è¡ŒPod
```

### 3.2 é«˜çº§èŠ‚ç‚¹äº²å’Œæ€§


**nodeAffinity - çµæ´»é€‰æ‹©æ–¹å¼**ï¼š
```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: log-collector
spec:
  selector:
    matchLabels:
      app: log-collector
  template:
    metadata:
      labels:
        app: log-collector
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              # é€‰æ‹©CPUæ ¸å¿ƒæ•°å¤§äºç­‰äº4çš„èŠ‚ç‚¹
              - key: "node.kubernetes.io/instance-type"
                operator: In
                values: ["m5.xlarge", "m5.2xlarge"]
              # æ’é™¤masterèŠ‚ç‚¹
              - key: "node-role.kubernetes.io/master"
                operator: DoesNotExist
      containers:
      - name: log-collector
        image: fluent-bit:latest
```

### 3.3 èŠ‚ç‚¹é€‰æ‹©å™¨å¯¹æ¯”


| é€‰æ‹©æ–¹å¼ | **è¯­æ³•å¤æ‚åº¦** | **çµæ´»æ€§** | **é€‚ç”¨åœºæ™¯** |
|---------|------------|----------|-------------|
| ğŸ”§ **nodeSelector** | `ç®€å•` | `åŸºç¡€åŒ¹é…` | `ç®€å•æ ‡ç­¾é€‰æ‹©` |
| ğŸ¯ **nodeAffinity** | `å¤æ‚` | `é«˜åº¦çµæ´»` | `å¤æ‚æ¡ä»¶ç­›é€‰` |

**é€‰æ‹©å»ºè®®**ï¼š
- ğŸ¯ **ç®€å•éœ€æ±‚**ï¼šç”¨nodeSelectorï¼Œå¦‚`env: prod`
- ğŸ”§ **å¤æ‚éœ€æ±‚**ï¼šç”¨nodeAffinityï¼Œå¦‚å¤šæ¡ä»¶ç»„åˆ

---

## 4. ğŸ”„ å®ˆæŠ¤è¿›ç¨‹æ›´æ–°ç­–ç•¥


### 4.1 æ»šåŠ¨æ›´æ–°ç­–ç•¥


**RollingUpdate - é€ä¸ªæ›´æ–°æ¨¡å¼**ï¼š
```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: network-daemon
spec:
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      # æœ€å¤šæœ‰20%çš„èŠ‚ç‚¹åŒæ—¶æ›´æ–°
      maxUnavailable: 20%
      # æˆ–è€…æŒ‡å®šå…·ä½“æ•°é‡ï¼šmaxUnavailable: 2
  selector:
    matchLabels:
      app: network-daemon
  template:
    metadata:
      labels:
        app: network-daemon
    spec:
      containers:
      - name: network-agent
        image: network-agent:v2.0
```

**æ›´æ–°è¿‡ç¨‹å¯è§†åŒ–**ï¼š
```
æ»šåŠ¨æ›´æ–°è¿‡ç¨‹æ¼”ç¤ºï¼ˆ5ä¸ªèŠ‚ç‚¹ï¼ŒmaxUnavailable: 20%ï¼‰:

æ­¥éª¤1ï¼šåœæ­¢1ä¸ªPodæ›´æ–°ï¼ˆ20% = 1ä¸ªèŠ‚ç‚¹ï¼‰
Node1: [Old Pod] â†’ [åœæ­¢] â†’ [New Pod]
Node2: [Old Pod]
Node3: [Old Pod]  
Node4: [Old Pod]
Node5: [Old Pod]

æ­¥éª¤2ï¼šç¬¬ä¸€ä¸ªæ›´æ–°å®Œæˆï¼Œç»§ç»­ä¸‹ä¸€ä¸ª
Node1: [New Pod] âœ…
Node2: [Old Pod] â†’ [åœæ­¢] â†’ [New Pod]
Node3: [Old Pod]
Node4: [Old Pod]
Node5: [Old Pod]

...ä¾æ¬¡ç±»æ¨ï¼Œç¡®ä¿æœåŠ¡è¿ç»­æ€§
```

### 4.2 ç«‹å³æ›´æ–°ç­–ç•¥


**OnDelete - æ‰‹åŠ¨æ§åˆ¶æ¨¡å¼**ï¼š
```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: security-daemon
spec:
  updateStrategy:
    type: OnDelete  # åªæœ‰æ‰‹åŠ¨åˆ é™¤Podæ‰ä¼šæ›´æ–°
  template:
    metadata:
      labels:
        app: security-daemon
    spec:
      containers:
      - name: security-agent
        image: security-agent:v3.0
```

**æ‰‹åŠ¨æ›´æ–°æ“ä½œ**ï¼š
```bash
# æ›´æ–°DaemonSeté…ç½®åï¼ŒPodä¸ä¼šè‡ªåŠ¨æ›´æ–°
kubectl apply -f security-daemon.yaml

# éœ€è¦æ‰‹åŠ¨åˆ é™¤Podè§¦å‘æ›´æ–°
kubectl delete pod security-daemon-node1-xyz
# åˆ é™¤åä¼šè‡ªåŠ¨åˆ›å»ºæ–°ç‰ˆæœ¬Pod

# æ‰¹é‡åˆ é™¤æ›´æ–°ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
kubectl delete pods -l app=security-daemon
```

### 4.3 æ›´æ–°ç­–ç•¥é€‰æ‹©æŒ‡å—


| æ›´æ–°ç­–ç•¥ | **è‡ªåŠ¨åŒ–ç¨‹åº¦** | **é£é™©æ§åˆ¶** | **é€‚ç”¨åœºæ™¯** |
|---------|-------------|------------|-------------|
| ğŸ”„ **RollingUpdate** | `å…¨è‡ªåŠ¨` | `æ¸è¿›å¼é£é™©` | `ä¸€èˆ¬ç³»ç»ŸæœåŠ¡` |
| ğŸ‘¤ **OnDelete** | `æ‰‹åŠ¨æ§åˆ¶` | `é£é™©å¯æ§` | `å…³é”®ç³»ç»ŸæœåŠ¡` |

---

## 5. ğŸª å…¸å‹åº”ç”¨åœºæ™¯


### 5.1 æ—¥å¿—æ”¶é›†åº”ç”¨åœºæ™¯


**åœºæ™¯æè¿°**ï¼šæ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦æ”¶é›†æœ¬èŠ‚ç‚¹çš„ç³»ç»Ÿæ—¥å¿—å’Œåº”ç”¨æ—¥å¿—ã€‚

```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: log-collector
  namespace: logging
spec:
  selector:
    matchLabels:
      name: log-collector
  template:
    metadata:
      labels:
        name: log-collector
    spec:
      containers:
      - name: fluent-bit
        image: fluent/fluent-bit:latest
        volumeMounts:
        # æŒ‚è½½èŠ‚ç‚¹æ—¥å¿—ç›®å½•
        - name: varlog
          mountPath: /var/log
          readOnly: true
        - name: containers-log
          mountPath: /var/lib/docker/containers
          readOnly: true
        env:
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
      volumes:
      # èŠ‚ç‚¹æ—¥å¿—ç›®å½•
      - name: varlog
        hostPath:
          path: /var/log
      - name: containers-log
        hostPath:
          path: /var/lib/docker/containers
```

**ä¸ºä»€ä¹ˆç”¨DaemonSet**ï¼š
- ğŸ“‚ æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰è‡ªå·±çš„æ—¥å¿—æ–‡ä»¶
- ğŸ”„ æ—¥å¿—æ”¶é›†å™¨å¿…é¡»åœ¨æœ¬åœ°è¿è¡Œæ‰èƒ½è®¿é—®æ–‡ä»¶
- ğŸ“Š æ–°èŠ‚ç‚¹åŠ å…¥æ—¶è‡ªåŠ¨å¼€å§‹æ”¶é›†æ—¥å¿—

### 5.2 ç›‘æ§ä»£ç†éƒ¨ç½²åœºæ™¯


**åœºæ™¯æè¿°**ï¼šåœ¨æ¯ä¸ªèŠ‚ç‚¹éƒ¨ç½²ç›‘æ§ä»£ç†ï¼Œæ”¶é›†èŠ‚ç‚¹çš„CPUã€å†…å­˜ã€ç£ç›˜ç­‰æŒ‡æ ‡ã€‚

```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: node-exporter
  namespace: monitoring
spec:
  selector:
    matchLabels:
      app: node-exporter
  template:
    metadata:
      labels:
        app: node-exporter
    spec:
      # ä½¿ç”¨ä¸»æœºç½‘ç»œï¼Œç›´æ¥è®¿é—®èŠ‚ç‚¹èµ„æº
      hostNetwork: true
      hostPID: true
      containers:
      - name: node-exporter
        image: prom/node-exporter:latest
        ports:
        - containerPort: 9100
          name: metrics
        args:
        - '--path.procfs=/host/proc'
        - '--path.sysfs=/host/sys'
        volumeMounts:
        - name: proc
          mountPath: /host/proc
          readOnly: true
        - name: sys
          mountPath: /host/sys
          readOnly: true
      volumes:
      - name: proc
        hostPath:
          path: /proc
      - name: sys
        hostPath:
          path: /sys
```

**ç›‘æ§æ¶æ„å›¾**ï¼š
```
                    Prometheus Server
                           |
                    æ”¶é›†æ‰€æœ‰èŠ‚ç‚¹æŒ‡æ ‡
                           |
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼         â–¼        â–¼        â–¼         â–¼
    Node1     Node2    Node3    Node4     Node5
   [ç›‘æ§Pod] [ç›‘æ§Pod] [ç›‘æ§Pod] [ç›‘æ§Pod] [ç›‘æ§Pod]
      |         |        |        |         |
   æœ¬åœ°æŒ‡æ ‡   æœ¬åœ°æŒ‡æ ‡   æœ¬åœ°æŒ‡æ ‡   æœ¬åœ°æŒ‡æ ‡   æœ¬åœ°æŒ‡æ ‡
```

### 5.3 ç½‘ç»œä»£ç†åœºæ™¯


**åœºæ™¯æè¿°**ï¼šä¸ºæ¯ä¸ªèŠ‚ç‚¹æä¾›ç½‘ç»œä»£ç†æœåŠ¡ï¼Œå¤„ç†å…¥å£æµé‡ã€‚

```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: ingress-proxy
spec:
  selector:
    matchLabels:
      app: ingress-proxy
  template:
    metadata:
      labels:
        app: ingress-proxy
    spec:
      # é€‰æ‹©è¾¹ç¼˜èŠ‚ç‚¹éƒ¨ç½²
      nodeSelector:
        node-role.kubernetes.io/edge: "true"
      hostNetwork: true  # ä½¿ç”¨ä¸»æœºç½‘ç»œ
      containers:
      - name: nginx-proxy
        image: nginx:alpine
        ports:
        - containerPort: 80
        - containerPort: 443
        volumeMounts:
        - name: nginx-config
          mountPath: /etc/nginx/nginx.conf
          subPath: nginx.conf
      volumes:
      - name: nginx-config
        configMap:
          name: nginx-proxy-config
```

---

## 6. ğŸ› ï¸ å®æˆ˜æ¡ˆä¾‹æ¼”ç»ƒ


### 6.1 éƒ¨ç½²ç³»ç»Ÿç›‘æ§DaemonSet


**æ­¥éª¤1ï¼šåˆ›å»ºç›‘æ§DaemonSet**ï¼š
```yaml
# monitoring-daemon.yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: system-monitor
  labels:
    app: system-monitor
spec:
  selector:
    matchLabels:
      name: system-monitor
  template:
    metadata:
      labels:
        name: system-monitor
    spec:
      containers:
      - name: monitor
        image: alpine:latest
        command: 
        - sh
        - -c
        - |
          while true; do
            echo "$(date): ç›‘æ§èŠ‚ç‚¹ $NODE_NAME"
            echo "CPUä½¿ç”¨ç‡: $(cat /proc/loadavg)"
            echo "å†…å­˜ä¿¡æ¯: $(free -h | head -2)"
            echo "ç£ç›˜ä½¿ç”¨: $(df -h / | tail -1)"
            echo "---"
            sleep 30
          done
        env:
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        volumeMounts:
        - name: proc
          mountPath: /proc
          readOnly: true
      volumes:
      - name: proc
        hostPath:
          path: /proc
```

**æ­¥éª¤2ï¼šéƒ¨ç½²å’ŒéªŒè¯**ï¼š
```bash
# éƒ¨ç½²DaemonSet
kubectl apply -f monitoring-daemon.yaml

# æŸ¥çœ‹DaemonSetçŠ¶æ€
kubectl get daemonset system-monitor

# æŸ¥çœ‹åœ¨æ‰€æœ‰èŠ‚ç‚¹çš„Pod
kubectl get pods -l name=system-monitor -o wide

# æŸ¥çœ‹æŸä¸ªPodçš„æ—¥å¿—
kubectl logs system-monitor-xxxxx
```

### 6.2 ä½¿ç”¨æ ‡ç­¾é€‰æ‹©ç‰¹å®šèŠ‚ç‚¹


**æ­¥éª¤1ï¼šç»™èŠ‚ç‚¹æ‰“æ ‡ç­¾**ï¼š
```bash
# æ ‡è®°ç”Ÿäº§ç¯å¢ƒèŠ‚ç‚¹
kubectl label nodes worker-1 env=production
kubectl label nodes worker-2 env=production
kubectl label nodes worker-3 env=development

# æŸ¥çœ‹èŠ‚ç‚¹æ ‡ç­¾
kubectl get nodes --show-labels
```

**æ­¥éª¤2ï¼šåˆ›å»ºé€‰æ‹©æ€§DaemonSet**ï¼š
```yaml
# selective-daemon.yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: production-monitor
spec:
  selector:
    matchLabels:
      app: production-monitor
  template:
    metadata:
      labels:
        app: production-monitor
    spec:
      # åªåœ¨ç”Ÿäº§ç¯å¢ƒèŠ‚ç‚¹éƒ¨ç½²
      nodeSelector:
        env: production
      containers:
      - name: prod-monitor
        image: alpine:latest
        command: ["sh", "-c", "echo 'ç”Ÿäº§ç›‘æ§å¯åŠ¨'; sleep 3600"]
```

**æ­¥éª¤3ï¼šéªŒè¯é€‰æ‹©æ€§éƒ¨ç½²**ï¼š
```bash
# éƒ¨ç½²
kubectl apply -f selective-daemon.yaml

# éªŒè¯åªåœ¨productionèŠ‚ç‚¹æœ‰Pod
kubectl get pods -l app=production-monitor -o wide
# åº”è¯¥åªåœ¨worker-1å’Œworker-2æœ‰Podï¼Œworker-3æ²¡æœ‰
```

### 6.3 æ›´æ–°ç­–ç•¥å®æˆ˜


**æ­¥éª¤1ï¼šåˆ›å»ºå¸¦æ›´æ–°ç­–ç•¥çš„DaemonSet**ï¼š
```yaml
# update-daemon.yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: update-test
spec:
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1  # ä¸€æ¬¡åªæ›´æ–°1ä¸ªPod
  selector:
    matchLabels:
      app: update-test
  template:
    metadata:
      labels:
        app: update-test
    spec:
      containers:
      - name: test-container
        image: alpine:latest
        command: ["sh", "-c", "echo 'Version 1.0'; sleep 3600"]
```

**æ­¥éª¤2ï¼šæ¨¡æ‹Ÿæ›´æ–°è¿‡ç¨‹**ï¼š
```bash
# éƒ¨ç½²åˆå§‹ç‰ˆæœ¬
kubectl apply -f update-daemon.yaml

# ç›‘æ§PodçŠ¶æ€
kubectl get pods -l app=update-test --watch

# ä¿®æ”¹é•œåƒç‰ˆæœ¬è§¦å‘æ›´æ–°
kubectl patch daemonset update-test -p='{"spec":{"template":{"spec":{"containers":[{"name":"test-container","command":["sh","-c","echo \"Version 2.0\"; sleep 3600"]}]}}}}'

# è§‚å¯Ÿæ»šåŠ¨æ›´æ–°è¿‡ç¨‹
kubectl rollout status daemonset/update-test
```

---

## 7. ğŸ“‹ æœ€ä½³å®è·µæŒ‡å—


### 7.1 èµ„æºé…ç½®æœ€ä½³å®è·µ


**åˆç†è®¾ç½®èµ„æºé™åˆ¶**ï¼š
```yaml
spec:
  template:
    spec:
      containers:
      - name: daemon-container
        image: your-daemon:latest
        resources:
          requests:
            # å®ˆæŠ¤è¿›ç¨‹é€šå¸¸èµ„æºéœ€æ±‚ç¨³å®šï¼Œè®¾ç½®åˆç†è¯·æ±‚å€¼
            memory: "64Mi"
            cpu: "100m"
          limits:
            # è®¾ç½®é™åˆ¶é˜²æ­¢å½±å“èŠ‚ç‚¹å…¶ä»–æœåŠ¡
            memory: "128Mi" 
            cpu: "200m"
```

**èµ„æºé…ç½®åŸåˆ™**ï¼š
- ğŸ¯ **ä¿å®ˆé…ç½®**ï¼šå®ˆæŠ¤è¿›ç¨‹å½±å“æ•´ä¸ªé›†ç¾¤ï¼Œå®å¯ä¿å®ˆ
- ğŸ“Š **ç›‘æ§è°ƒä¼˜**ï¼šæ ¹æ®å®é™…ä½¿ç”¨æƒ…å†µè°ƒæ•´
- âš–ï¸ **å¹³è¡¡è€ƒè™‘**ï¼šæ—¢è¦æ»¡è¶³åŠŸèƒ½éœ€æ±‚ï¼Œåˆä¸èƒ½å½±å“ä¸šåŠ¡Pod

### 7.2 å¥åº·æ£€æŸ¥é…ç½®


**é…ç½®å¥åº·æ£€æŸ¥**ï¼š
```yaml
spec:
  template:
    spec:
      containers:
      - name: daemon-container
        image: your-daemon:latest
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready  
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
```

### 7.3 å®‰å…¨é…ç½®å»ºè®®


**æœ€å°æƒé™åŸåˆ™**ï¼š
```yaml
spec:
  template:
    spec:
      # ä½¿ç”¨ä¸“ç”¨æœåŠ¡è´¦å·
      serviceAccountName: daemon-service-account
      securityContext:
        # éç‰¹æƒæ¨¡å¼è¿è¡Œ
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 2000
      containers:
      - name: daemon-container
        securityContext:
          # é™åˆ¶å®¹å™¨æƒé™
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
            - ALL
```

### 7.4 æ•…éšœæ’æŸ¥æŒ‡å—


**å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ³•**ï¼š

| é—®é¢˜ç°è±¡ | **å¯èƒ½åŸå› ** | **æ’æŸ¥æ–¹æ³•** |
|---------|------------|-------------|
| ğŸš« **Podä¸åˆ›å»º** | `èŠ‚ç‚¹é€‰æ‹©å™¨ä¸åŒ¹é…` | `æ£€æŸ¥èŠ‚ç‚¹æ ‡ç­¾å’Œé€‰æ‹©å™¨` |
| â¸ï¸ **Podå¯åŠ¨å¤±è´¥** | `é•œåƒæ‹‰å–å¤±è´¥` | `æ£€æŸ¥é•œåƒåç§°å’Œç½‘ç»œ` |
| ğŸ”„ **é¢‘ç¹é‡å¯** | `èµ„æºä¸è¶³æˆ–å¥åº·æ£€æŸ¥å¤±è´¥` | `æŸ¥çœ‹Podæ—¥å¿—å’Œèµ„æºä½¿ç”¨` |
| ğŸ“ **éƒ¨åˆ†èŠ‚ç‚¹æ— Pod** | `èŠ‚ç‚¹æ±¡ç‚¹æˆ–èµ„æºä¸è¶³` | `æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€å’Œæ±¡ç‚¹é…ç½®` |

**æ’æŸ¥å‘½ä»¤é›†åˆ**ï¼š
```bash
# æŸ¥çœ‹DaemonSetçŠ¶æ€
kubectl describe daemonset <name>

# æŸ¥çœ‹Podåˆ†å¸ƒæƒ…å†µ  
kubectl get pods -l <label-selector> -o wide

# æŸ¥çœ‹Podè¯¦ç»†ä¿¡æ¯
kubectl describe pod <pod-name>

# æŸ¥çœ‹èŠ‚ç‚¹æ ‡ç­¾å’Œæ±¡ç‚¹
kubectl describe node <node-name>

# æŸ¥çœ‹äº‹ä»¶
kubectl get events --sort-by=.metadata.creationTimestamp
```

---

## 8. ğŸ“ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ DaemonSetæœ¬è´¨ï¼šä¿è¯æ¯ä¸ªèŠ‚ç‚¹è¿è¡Œä¸€ä¸ªæŒ‡å®šPodçš„æ§åˆ¶å™¨
ğŸ”¸ é€‚ç”¨åœºæ™¯ï¼šç³»ç»ŸæœåŠ¡ã€ç›‘æ§ä»£ç†ã€æ—¥å¿—æ”¶é›†ã€ç½‘ç»œå·¥å…·
ğŸ”¸ è°ƒåº¦ç‰¹ç‚¹ï¼šè·³è¿‡è°ƒåº¦å™¨ï¼Œç›´æ¥ç»‘å®šèŠ‚ç‚¹ï¼Œå¯å®¹å¿æ±¡ç‚¹
ğŸ”¸ æ›´æ–°ç­–ç•¥ï¼šRollingUpdateæ»šåŠ¨æ›´æ–°ã€OnDeleteæ‰‹åŠ¨æ§åˆ¶
ğŸ”¸ èŠ‚ç‚¹é€‰æ‹©ï¼šnodeSelectorç®€å•é€‰æ‹©ã€nodeAffinityçµæ´»é€‰æ‹©
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä»€ä¹ˆæ—¶å€™ç”¨DaemonSet**ï¼š
```
åˆ¤æ–­æ ‡å‡†ï¼š
- è¿™ä¸ªæœåŠ¡æ˜¯å¦éœ€è¦åœ¨æ¯ä¸ªèŠ‚ç‚¹éƒ½è¿è¡Œï¼Ÿ
- æœåŠ¡åŠŸèƒ½æ˜¯å¦ä¸èŠ‚ç‚¹æœ¬åœ°èµ„æºç›¸å…³ï¼Ÿ
- æ˜¯å¦éœ€è¦å®Œæ•´çš„é›†ç¾¤è¦†ç›–ï¼Ÿ

å¦‚æœç­”æ¡ˆæ˜¯"æ˜¯"ï¼Œå°±è€ƒè™‘ç”¨DaemonSet
```

**ğŸ”¹ DaemonSet vs Deploymentçš„é€‰æ‹©**ï¼š
```
ç”¨DaemonSetï¼š
âœ… ç›‘æ§æ¯ä¸ªèŠ‚ç‚¹çš„èµ„æºä½¿ç”¨æƒ…å†µ
âœ… æ”¶é›†æ¯ä¸ªèŠ‚ç‚¹çš„æ—¥å¿—æ–‡ä»¶
âœ… åœ¨æ¯ä¸ªèŠ‚ç‚¹è¿è¡Œå®‰å…¨ä»£ç†

ç”¨Deploymentï¼š  
âœ… éƒ¨ç½²Webåº”ç”¨ç¨‹åº
âœ… è¿è¡Œæ•°æ®åº“æœåŠ¡
âœ… å¤„ç†ä¸šåŠ¡é€»è¾‘çš„å¾®æœåŠ¡
```

**ğŸ”¹ èŠ‚ç‚¹é€‰æ‹©çš„é‡è¦æ€§**ï¼š
```
åˆç†ä½¿ç”¨èŠ‚ç‚¹é€‰æ‹©å™¨ï¼š
- é¿å…åœ¨ä¸åˆé€‚çš„èŠ‚ç‚¹è¿è¡Œå®ˆæŠ¤è¿›ç¨‹
- æé«˜èµ„æºåˆ©ç”¨æ•ˆç‡
- å‡å°‘ä¸å¿…è¦çš„èµ„æºæ¶ˆè€—
```

### 8.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ç”Ÿäº§ç¯å¢ƒåº”ç”¨**ï¼š
- **æ—¥å¿—ç³»ç»Ÿ**ï¼šFluentdã€Filebeatç­‰æ—¥å¿—æ”¶é›†å™¨
- **ç›‘æ§ç³»ç»Ÿ**ï¼šNode Exporterã€Datadog Agentç­‰
- **ç½‘ç»œç»„ä»¶**ï¼šCalicoã€Flannelç­‰ç½‘ç»œæ’ä»¶
- **å­˜å‚¨ç³»ç»Ÿ**ï¼šCephã€GlusterFSç­‰åˆ†å¸ƒå¼å­˜å‚¨

**ğŸ”§ è¿ç»´å®è·µ**ï¼š
- **æ¸è¿›å¼éƒ¨ç½²**ï¼šä½¿ç”¨æ»šåŠ¨æ›´æ–°ç­–ç•¥å®‰å…¨æ›´æ–°
- **èµ„æºç®¡æ§**ï¼šåˆç†è®¾ç½®èµ„æºé™åˆ¶ä¿æŠ¤èŠ‚ç‚¹
- **æ•…éšœéš”ç¦»**ï¼šé€šè¿‡èŠ‚ç‚¹é€‰æ‹©å™¨æ§åˆ¶å½±å“èŒƒå›´
- **ç›‘æ§å‘Šè­¦**ï¼šç›‘æ§DaemonSetå¥åº·çŠ¶æ€

**æ ¸å¿ƒè®°å¿†**ï¼š
- DaemonSetåƒä¿å®‰å®ˆå¤œï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½è¦æœ‰
- ç³»ç»ŸæœåŠ¡ç”¨DaemonSetï¼Œä¸šåŠ¡åº”ç”¨ç”¨Deployment  
- èŠ‚ç‚¹é€‰æ‹©å™¨å¾ˆé‡è¦ï¼Œé¿å…ä¹±éƒ¨ç½²
- æ›´æ–°è¦è°¨æ…ï¼Œå½±å“çš„æ˜¯æ•´ä¸ªé›†ç¾¤