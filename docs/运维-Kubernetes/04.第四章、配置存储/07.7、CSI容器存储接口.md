---
title: 7ã€CSIå®¹å™¨å­˜å‚¨æ¥å£
---
## ğŸ“¦ CSIå®¹å™¨å­˜å‚¨æ¥å£å®Œå…¨å­¦ä¹ æŒ‡å—

### ğŸ“š ç›®å½•
1. [ä»€ä¹ˆæ˜¯CSIå®¹å™¨å­˜å‚¨æ¥å£](#1-ä»€ä¹ˆæ˜¯CSIå®¹å™¨å­˜å‚¨æ¥å£)
2. [CSIè§£å†³äº†ä»€ä¹ˆé—®é¢˜](#2-CSIè§£å†³äº†ä»€ä¹ˆé—®é¢˜)
3. [CSIæ ¸å¿ƒæ¶æ„è¯¦è§£](#3-CSIæ ¸å¿ƒæ¶æ„è¯¦è§£)
4. [CSIé©±åŠ¨ç¨‹åºç»„ä»¶](#4-CSIé©±åŠ¨ç¨‹åºç»„ä»¶)
5. [åŠ¨æ€å·ä¾›åº”æœºåˆ¶](#5-åŠ¨æ€å·ä¾›åº”æœºåˆ¶)
6. [å·ç”Ÿå‘½å‘¨æœŸç®¡ç†](#6-å·ç”Ÿå‘½å‘¨æœŸç®¡ç†)
7. [å­˜å‚¨æ‹“æ‰‘æ„ŸçŸ¥](#7-å­˜å‚¨æ‹“æ‰‘æ„ŸçŸ¥)
8. [CSIé©±åŠ¨éƒ¨ç½²å®è·µ](#8-CSIé©±åŠ¨éƒ¨ç½²å®è·µ)
9. [ç¬¬ä¸‰æ–¹å­˜å‚¨é›†æˆ](#9-ç¬¬ä¸‰æ–¹å­˜å‚¨é›†æˆ)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

### 1. ğŸ¯ ä»€ä¹ˆæ˜¯CSIå®¹å™¨å­˜å‚¨æ¥å£

#### 1.1 CSIçš„é€šä¿—ç†è§£

æƒ³è±¡ä¸€ä¸‹ï¼Œä½ è¦åœ¨ä¸åŒçš„å•†åº—ä¹°ä¸œè¥¿ï¼Œæ¯ä¸ªå•†åº—éƒ½æœ‰è‡ªå·±çš„è´­ä¹°æµç¨‹å’Œè§„åˆ™ã€‚å¦‚æœæ¯æ¬¡éƒ½è¦å­¦ä¹ æ–°çš„è´­ä¹°æ–¹å¼ï¼Œæ˜¯ä¸æ˜¯å¾ˆéº»çƒ¦ï¼Ÿ

**CSIå°±æ˜¯ä¸ºå­˜å‚¨åˆ¶å®šçš„"ç»Ÿä¸€è´­ä¹°æ ‡å‡†"**ï¼š

```
ä¼ ç»Ÿæ–¹å¼ï¼ˆæ²¡æœ‰CSIï¼‰ï¼š
Kubernetes â†â†’ é˜¿é‡Œäº‘å­˜å‚¨ï¼ˆä¸“ç”¨æ¥å£ï¼‰
Kubernetes â†â†’ AWSå­˜å‚¨ï¼ˆä¸“ç”¨æ¥å£ï¼‰  
Kubernetes â†â†’ æœ¬åœ°å­˜å‚¨ï¼ˆä¸“ç”¨æ¥å£ï¼‰
æ¯ç§å­˜å‚¨éƒ½è¦å•ç‹¬å¼€å‘æ¥å£

CSIæ–¹å¼ï¼š
Kubernetes â†â†’ CSIæ ‡å‡†æ¥å£ â†â†’ å„ç§å­˜å‚¨
ç»Ÿä¸€çš„æ¥å£æ ‡å‡†ï¼Œå­˜å‚¨å‚å•†åªéœ€æŒ‰æ ‡å‡†å¼€å‘
```

#### 1.2 CSIçš„å®˜æ–¹å®šä¹‰

**CSIï¼ˆContainer Storage Interfaceï¼‰** æ˜¯å®¹å™¨ç¼–æ’ç³»ç»Ÿçš„å­˜å‚¨æ¥å£æ ‡å‡†ï¼Œè®©å­˜å‚¨å‚å•†èƒ½å¤Ÿå¼€å‘ä¸€æ¬¡é©±åŠ¨ç¨‹åºï¼Œå°±èƒ½åœ¨å¤šä¸ªå®¹å™¨å¹³å°ä¸Šä½¿ç”¨ã€‚

**ğŸ”¸ æ ¸å¿ƒç‰¹ç‚¹ï¼š**
- **ç»Ÿä¸€æ ‡å‡†**ï¼šæ‰€æœ‰å­˜å‚¨éƒ½éµå¾ªç›¸åŒæ¥å£
- **å‚å•†ä¸­ç«‹**ï¼šä¸ä¾èµ–ç‰¹å®šçš„å­˜å‚¨æä¾›å•†
- **æ’ä»¶åŒ–**ï¼šå­˜å‚¨åŠŸèƒ½ä»¥æ’ä»¶æ–¹å¼æä¾›
- **è·¨å¹³å°**ï¼šæ”¯æŒKubernetesã€Dockerç­‰å¤šä¸ªå¹³å°

#### 1.3 ä¸ºä»€ä¹ˆéœ€è¦CSIï¼Ÿ

**ğŸ“Š å¯¹æ¯”åˆ†æï¼š**

| ç»´åº¦ | **ä¼ ç»Ÿå†…ç½®é©±åŠ¨** | **CSIæ ‡å‡†** |
|------|------------------|-------------|
| ğŸ”§ **å¼€å‘å¤æ‚åº¦** | `æ¯ä¸ªå¹³å°éƒ½è¦é‡æ–°å¼€å‘` | `å¼€å‘ä¸€æ¬¡ï¼Œå¤šå¹³å°ä½¿ç”¨` |
| ğŸš€ **æ›´æ–°é€Ÿåº¦** | `è·ŸéšKuberneteså‘å¸ƒ` | `ç‹¬ç«‹å‘å¸ƒæ›´æ–°` |
| ğŸ¯ **åŠŸèƒ½æ”¯æŒ** | `åŸºç¡€åŠŸèƒ½ä¸ºä¸»` | `å‚å•†ç‰¹æ€§å…¨é¢æ”¯æŒ` |
| ğŸ”„ **ç»´æŠ¤æˆæœ¬** | `å¹³å°æ–¹ç»´æŠ¤` | `å­˜å‚¨å‚å•†è‡ªç»´æŠ¤` |
| ğŸ“ˆ **æ‰©å±•æ€§** | `å—é™åˆ¶` | `é«˜åº¦å¯æ‰©å±•` |

---

### 2. ğŸš« CSIè§£å†³äº†ä»€ä¹ˆé—®é¢˜

#### 2.1 ä¼ ç»Ÿå­˜å‚¨é›†æˆçš„ç—›ç‚¹

åœ¨CSIå‡ºç°ä¹‹å‰ï¼ŒKubernetesé›†æˆå­˜å‚¨å°±åƒè¿™æ ·ï¼š

```
ç—›ç‚¹ç¤ºæ„å›¾ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Kubernetes    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å†…ç½®EBSé©±åŠ¨     â”‚ â† Amazonä¸“ç”¨
â”‚ å†…ç½®GCEé©±åŠ¨     â”‚ â† Googleä¸“ç”¨  
â”‚ å†…ç½®Cephé©±åŠ¨    â”‚ â† Cephä¸“ç”¨
â”‚ å†…ç½®NFSé©±åŠ¨     â”‚ â† NFSä¸“ç”¨
â”‚ ...æ›´å¤šé©±åŠ¨...  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é—®é¢˜ï¼š
âŒ æ¯ç§å­˜å‚¨éƒ½è¦ä¿®æ”¹Kubernetesæ ¸å¿ƒä»£ç 
âŒ æ–°å­˜å‚¨æ”¯æŒè¦ç­‰Kubernetesç‰ˆæœ¬å‘å¸ƒ
âŒ å­˜å‚¨å‚å•†æ— æ³•å¿«é€Ÿè¿­ä»£åŠŸèƒ½
âŒ Kubernetesä»£ç è¶Šæ¥è¶Šè‡ƒè‚¿
```

**ğŸ” å…·ä½“é—®é¢˜ä¸¾ä¾‹ï¼š**

```yaml
## ä¼ ç»Ÿæ–¹å¼æ·»åŠ æ–°å­˜å‚¨çš„å›°éš¾
apiVersion: v1
kind: PersistentVolume
metadata:
  name: my-storage
spec:
#  # æ¯ç§å­˜å‚¨é…ç½®éƒ½ä¸åŒï¼Œæ²¡æœ‰ç»Ÿä¸€æ ‡å‡†
  awsElasticBlockStore:  # AWSä¸“ç”¨é…ç½®
    volumeID: "vol-12345"
#  # æˆ–è€…
  gcePersistentDisk:     # GCPä¸“ç”¨é…ç½®  
    pdName: "my-disk"
#  # æˆ–è€…  
  cephfs:                # Cephä¸“ç”¨é…ç½®
    monitors: ["10.0.0.1:6789"]
```

#### 2.2 CSIå¦‚ä½•è§£å†³è¿™äº›é—®é¢˜

**ğŸ¯ è§£å†³æ–¹æ¡ˆæ¶æ„ï¼š**

```
CSIè§£å†³æ–¹æ¡ˆï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Kubernetes    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  CSIç»Ÿä¸€æ¥å£    â”‚ â† æ ‡å‡†åŒ–æ¥å£
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚ CSIæ ‡å‡† â”‚ â† ç»Ÿä¸€çš„APIè§„èŒƒ
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å­˜å‚¨é©±åŠ¨æ’ä»¶   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ AWS-EBS-CSI     â”‚ â† ç‹¬ç«‹å¼€å‘
â”‚ GCP-Disk-CSI    â”‚ â† ç‹¬ç«‹æ›´æ–°  
â”‚ Ceph-CSI        â”‚ â† å‚å•†ç»´æŠ¤
â”‚ Local-CSI       â”‚ â† å¿«é€Ÿè¿­ä»£
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**âœ… CSIå¸¦æ¥çš„å¥½å¤„ï¼š**
- **ç»Ÿä¸€é…ç½®**ï¼šæ‰€æœ‰å­˜å‚¨ä½¿ç”¨ç›¸åŒçš„é…ç½®æ ¼å¼
- **ç‹¬ç«‹è¿­ä»£**ï¼šå­˜å‚¨å‚å•†å¯ä»¥ç‹¬ç«‹å‘å¸ƒé©±åŠ¨æ›´æ–°
- **å¿«é€Ÿæ”¯æŒ**ï¼šæ–°å­˜å‚¨æ— éœ€ç­‰å¾…Kuberneteså‘å¸ƒ
- **åŠŸèƒ½å®Œæ•´**ï¼šæ”¯æŒå‚å•†ç‰¹æœ‰çš„é«˜çº§åŠŸèƒ½

---

### 3. ğŸ—ï¸ CSIæ ¸å¿ƒæ¶æ„è¯¦è§£

#### 3.1 CSIæ¶æ„æ€»è§ˆ

CSIå°±åƒä¸€ä¸ª"ç¿»è¯‘å®˜"ï¼Œè®©Kuberneteså’Œå„ç§å­˜å‚¨èƒ½å¤Ÿé¡ºç•…å¯¹è¯ï¼š

```
CSIæ¶æ„å›¾ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Kubernetesé›†ç¾¤           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚     Pod (åº”ç”¨å®¹å™¨)          â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚     Kubelet (èŠ‚ç‚¹ä»£ç†)      â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  Controller Manager        â”‚â”‚  
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ CSIæ¥å£è°ƒç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         CSIé©±åŠ¨ç¨‹åº             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Controller  â”‚  Node Plugin  â”‚â”‚
â”‚  â”‚   Service   â”‚   Service     â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ å­˜å‚¨æ“ä½œ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        å®é™…å­˜å‚¨ç³»ç»Ÿ             â”‚
â”‚  äº‘å­˜å‚¨ / æœ¬åœ°å­˜å‚¨ / ç½‘ç»œå­˜å‚¨   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.2 CSIæ¥å£è§„èŒƒ

CSIå®šä¹‰äº†ä¸‰ä¸ªæ ¸å¿ƒæœåŠ¡æ¥å£ï¼Œå°±åƒé¤å…çš„ä¸‰ä¸ªæœåŠ¡çª—å£ï¼š

**ğŸ½ï¸ ä¸‰ä¸ªæœåŠ¡çª—å£ç±»æ¯”ï¼š**

| æœåŠ¡çª—å£ | è´Ÿè´£å†…å®¹ | å®é™…å¯¹åº” |
|----------|----------|----------|
| ğŸ¯ **èº«ä»½æœåŠ¡** | `"æˆ‘æ˜¯è°ï¼Ÿèƒ½åšä»€ä¹ˆï¼Ÿ"` | `Identity Service` |
| ğŸ›ï¸ **æ§åˆ¶æœåŠ¡** | `"ç®¡ç†èœå•ï¼Œå‡†å¤‡èœå“"` | `Controller Service` |  
| ğŸšš **èŠ‚ç‚¹æœåŠ¡** | `"ä¸Šèœåˆ°æ¡Œï¼Œæ”¶æ‹¾ç¢—ç­·"` | `Node Service` |

```protobuf
// CSIæ¥å£å®šä¹‰ç¤ºä¾‹ï¼ˆç®€åŒ–ç‰ˆï¼‰
service Identity {
  // è·å–é©±åŠ¨ä¿¡æ¯
  rpc GetPluginInfo() returns (GetPluginInfoResponse);
  // è·å–æ”¯æŒçš„åŠŸèƒ½
  rpc GetPluginCapabilities() returns (GetPluginCapabilitiesResponse);
  // å¥åº·æ£€æŸ¥
  rpc Probe() returns (ProbeResponse);
}

service Controller {
  // åˆ›å»ºå·
  rpc CreateVolume() returns (CreateVolumeResponse);
  // åˆ é™¤å·  
  rpc DeleteVolume() returns (DeleteVolumeResponse);
  // é™„åŠ å·åˆ°èŠ‚ç‚¹
  rpc ControllerPublishVolume() returns (ControllerPublishVolumeResponse);
}

service Node {
  // åœ¨èŠ‚ç‚¹ä¸ŠæŒ‚è½½å·
  rpc NodePublishVolume() returns (NodePublishVolumeResponse);
  // åœ¨èŠ‚ç‚¹ä¸Šå¸è½½å·
  rpc NodeUnpublishVolume() returns (NodeUnpublishVolumeResponse);
}
```

#### 3.3 CSIé€šä¿¡æµç¨‹

**ğŸ“ å®Œæ•´çš„å­˜å‚¨è¯·æ±‚æµç¨‹ï¼š**

```
å·åˆ›å»ºå’ŒæŒ‚è½½æµç¨‹ï¼š
ç”¨æˆ·åˆ›å»ºPVC â†’ Kubernetes Controller Manager â†’ CSI Controller Service
     â†“                      â†“                        â†“
  1.ç”³è¯·å­˜å‚¨              2.è°ƒç”¨CSIæ¥å£            3.åˆ›å»ºå®é™…å­˜å‚¨å·
     â†“                      â†“                        â†“
Podéœ€è¦æŒ‚è½½ â†’ Kubelet â†’ CSI Node Service â†’ æŒ‚è½½åˆ°Pod
     â†“           â†“           â†“              â†“
  4.è°ƒåº¦åˆ°èŠ‚ç‚¹  5.CSIè°ƒç”¨  6.èŠ‚ç‚¹æ“ä½œ    7.æŒ‚è½½å®Œæˆ
```

---

### 4. ğŸ”§ CSIé©±åŠ¨ç¨‹åºç»„ä»¶

#### 4.1 Controller Serviceè¯¦è§£

**Controller Serviceå°±åƒ"ä»“åº“ç®¡ç†å‘˜"**ï¼Œè´Ÿè´£å­˜å‚¨å·çš„é›†ä¸­ç®¡ç†ï¼š

**ğŸ¯ ä¸»è¦èŒè´£ï¼š**
```
ä»“åº“ç®¡ç†å‘˜çš„å·¥ä½œï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Controller Service      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“¦ åˆ›å»ºæ–°çš„å­˜å‚¨å·           â”‚ â† CreateVolume
â”‚ ğŸ—‘ï¸ åˆ é™¤ä¸éœ€è¦çš„å­˜å‚¨å·       â”‚ â† DeleteVolume  
â”‚ ğŸ”— å°†å·åˆ†é…ç»™ç‰¹å®šèŠ‚ç‚¹       â”‚ â† ControllerPublishVolume
â”‚ âš¡ å·å¿«ç…§å’Œå…‹éš†æ“ä½œ         â”‚ â† CreateSnapshot
â”‚ ğŸ“Š æ”¶é›†å­˜å‚¨ä½¿ç”¨ç»Ÿè®¡         â”‚ â† GetCapacity
â”‚ ğŸ”„ å·æ‰©å®¹æ“ä½œ               â”‚ â† ControllerExpandVolume
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ’¡ å®é™…é…ç½®ç¤ºä¾‹ï¼š**
```yaml
## CSI Controller éƒ¨ç½²é…ç½®
apiVersion: apps/v1
kind: Deployment
metadata:
  name: csi-controller
spec:
  replicas: 1
  template:
    spec:
      containers:
      - name: csi-provisioner
        image: k8s.gcr.io/sig-storage/csi-provisioner:v2.1.0
        args:
        - --csi-address=/var/lib/csi/sockets/pluginproxy/csi.sock
        - --v=5
      - name: storage-driver
        image: my-storage/csi-driver:latest
        args:
        - --endpoint=/var/lib/csi/sockets/pluginproxy/csi.sock
        - --mode=controller
```

#### 4.2 Node Serviceè¯¦è§£

**Node Serviceå°±åƒ"å¿«é€’é…é€å‘˜"**ï¼Œè´Ÿè´£åœ¨å…·ä½“èŠ‚ç‚¹ä¸Šæ“ä½œå­˜å‚¨ï¼š

**ğŸšš ä¸»è¦èŒè´£ï¼š**
```
å¿«é€’é…é€å‘˜çš„å·¥ä½œï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       Node Service          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ”Œ æŒ‚è½½å·åˆ°PodæŒ‡å®šè·¯å¾„      â”‚ â† NodePublishVolume
â”‚ ğŸ”§ å¸è½½Podä½¿ç”¨çš„å·          â”‚ â† NodeUnpublishVolume
â”‚ ğŸ“ åˆ›å»ºæŒ‚è½½ç‚¹ç›®å½•           â”‚ â† NodeStageVolume  
â”‚ ğŸ” æ£€æŸ¥å·åœ¨èŠ‚ç‚¹ä¸Šçš„çŠ¶æ€     â”‚ â† NodeGetVolumeStats
â”‚ ğŸ’¾ æ ¼å¼åŒ–æ–°åˆ›å»ºçš„å·         â”‚ â† æ–‡ä»¶ç³»ç»Ÿæ“ä½œ
â”‚ ğŸ›¡ï¸ æƒé™å’Œå®‰å…¨æ£€æŸ¥           â”‚ â† è®¿é—®æ§åˆ¶
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”§ Node Serviceéƒ¨ç½²ï¼š**
```yaml
## CSI Node éƒ¨ç½²é…ç½®ï¼ˆDaemonSetï¼‰
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: csi-node
spec:
  template:
    spec:
      hostNetwork: true
      containers:
      - name: node-driver-registrar
        image: k8s.gcr.io/sig-storage/csi-node-driver-registrar:v2.1.0
        args:
        - --csi-address=/csi/csi.sock
        - --kubelet-registration-path=/var/lib/kubelet/plugins/my-csi-driver/csi.sock
      - name: storage-driver  
        image: my-storage/csi-driver:latest
        args:
        - --endpoint=/csi/csi.sock
        - --mode=node
        securityContext:
          privileged: true  # éœ€è¦ç‰¹æƒæ¨¡å¼è¿›è¡ŒæŒ‚è½½æ“ä½œ
        volumeMounts:
        - name: kubelet-dir
          mountPath: /var/lib/kubelet
          mountPropagation: Bidirectional
```

#### 4.3 Identity Serviceè¯¦è§£

**Identity Serviceå°±åƒ"å®¢æœä»£è¡¨"**ï¼Œæä¾›é©±åŠ¨ç¨‹åºçš„åŸºæœ¬ä¿¡æ¯ï¼š

```yaml
## Identity Service å“åº”ç¤ºä¾‹
GetPluginInfo:
  name: "my-storage.csi.k8s.io"    # é©±åŠ¨åç§°
  vendor_version: "v1.2.0"         # ç‰ˆæœ¬ä¿¡æ¯
  
GetPluginCapabilities:
  service:
  - type: CONTROLLER_SERVICE       # æ”¯æŒæ§åˆ¶å™¨æœåŠ¡
  - type: VOLUME_ACCESSIBILITY_CONSTRAINTS  # æ”¯æŒæ‹“æ‰‘æ„ŸçŸ¥
  
  volume_expansion:
  - type: ONLINE                   # æ”¯æŒåœ¨çº¿æ‰©å®¹
  - type: OFFLINE                  # æ”¯æŒç¦»çº¿æ‰©å®¹
```

---

### 5. âš¡ åŠ¨æ€å·ä¾›åº”æœºåˆ¶

#### 5.1 ä»€ä¹ˆæ˜¯åŠ¨æ€å·ä¾›åº”

**åŠ¨æ€å·ä¾›åº”å°±åƒ"è‡ªåŠ¨ç‚¹é¤ç³»ç»Ÿ"**ï¼š

```
ä¼ ç»Ÿé™æ€æ–¹å¼ï¼ˆæ‰‹å·¥ç‚¹é¤ï¼‰ï¼š
ç®¡ç†å‘˜æå‰å‡†å¤‡ â†’ åˆ›å»ºPV â†’ ç”¨æˆ·ç”³è¯·PVC â†’ æ‰‹åŠ¨ç»‘å®š
     â†“              â†“         â†“           â†“
  ğŸ“¦å‡†å¤‡å­˜å‚¨      ğŸ·ï¸è´´æ ‡ç­¾   ğŸ“å¡«ç”³è¯·å•   ğŸ”—æ‰‹åŠ¨åŒ¹é…

åŠ¨æ€ä¾›åº”æ–¹å¼ï¼ˆè‡ªåŠ¨ç‚¹é¤ï¼‰ï¼š  
ç”¨æˆ·ç”³è¯·PVC â†’ ç³»ç»Ÿè‡ªåŠ¨åˆ›å»ºPV â†’ è‡ªåŠ¨ç»‘å®šä½¿ç”¨
     â†“              â†“              â†“
  ğŸ“æäº¤éœ€æ±‚      ğŸ¤–æ™ºèƒ½åˆ›å»º      âœ…å³æ—¶å¯ç”¨
```

#### 5.2 StorageClasså­˜å‚¨ç±»

**StorageClasså°±åƒ"èœå•æ¨¡æ¿"**ï¼Œå®šä¹‰äº†å­˜å‚¨çš„è§„æ ¼å’Œé…ç½®ï¼š

```yaml
## é«˜æ€§èƒ½SSDå­˜å‚¨ç±»
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: fast-ssd
provisioner: my-storage.csi.k8s.io  # ä½¿ç”¨çš„CSIé©±åŠ¨
parameters:
  type: "ssd"                        # å­˜å‚¨ç±»å‹
  replication: "3"                   # å‰¯æœ¬æ•°é‡
  encryption: "true"                 # å¯ç”¨åŠ å¯†
reclaimPolicy: Delete                # å›æ”¶ç­–ç•¥
allowVolumeExpansion: true           # å…è®¸æ‰©å®¹
volumeBindingMode: WaitForFirstConsumer  # å»¶è¿Ÿç»‘å®š
```

**ğŸ“Š å¸¸è§å­˜å‚¨ç±»é…ç½®å¯¹æ¯”ï¼š**

| å­˜å‚¨ç±»å‹ | **æ€§èƒ½** | **æˆæœ¬** | **é€‚ç”¨åœºæ™¯** | **é…ç½®ç¤ºä¾‹** |
|----------|----------|----------|-------------|-------------|
| ğŸš€ **é«˜æ€§èƒ½SSD** | `æé«˜` | `æ˜‚è´µ` | `æ•°æ®åº“ã€é«˜IOåº”ç”¨` | `type: premium-ssd` |
| ğŸ’° **æ ‡å‡†HDD** | `ä¸€èˆ¬` | `ä¾¿å®œ` | `æ–‡ä»¶å­˜å‚¨ã€å¤‡ä»½` | `type: standard-hdd` |
| âš–ï¸ **å¹³è¡¡å‹** | `ä¸­ç­‰` | `é€‚ä¸­` | `ä¸€èˆ¬åº”ç”¨` | `type: balanced-ssd` |

#### 5.3 åŠ¨æ€ä¾›åº”æµç¨‹

```
åŠ¨æ€å·ä¾›åº”å®Œæ•´æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ç”¨æˆ·åˆ›å»ºPVC  â”‚ â† æŒ‡å®šStorageClass
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. CSIé©±åŠ¨æ¥æ”¶  â”‚ â† Controller Service
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. åˆ›å»ºå®é™…å­˜å‚¨ â”‚ â† è°ƒç”¨å­˜å‚¨API
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  
          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. åˆ›å»ºPVå¯¹è±¡   â”‚ â† è‡ªåŠ¨ç»‘å®šPVC
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Podä½¿ç”¨å·    â”‚ â† æŒ‚è½½åˆ°å®¹å™¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ’» å®é™…ä½¿ç”¨ç¤ºä¾‹ï¼š**
```yaml
## ç”¨æˆ·åªéœ€è¦åˆ›å»ºPVCï¼Œå­˜å‚¨ä¼šè‡ªåŠ¨åˆ›å»º
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: my-app-storage
spec:
  accessModes:
  - ReadWriteOnce
  storageClassName: fast-ssd  # æŒ‡å®šå­˜å‚¨ç±»
  resources:
    requests:
      storage: 100Gi          # éœ€è¦100GBç©ºé—´

## ç³»ç»Ÿè‡ªåŠ¨åˆ›å»ºçš„PVï¼ˆç”¨æˆ·æ— éœ€å…³å¿ƒï¼‰
apiVersion: v1  
kind: PersistentVolume
metadata:
  name: pvc-12345-auto-generated
spec:
  capacity:
    storage: 100Gi
  csi:
    driver: my-storage.csi.k8s.io
    volumeHandle: vol-abcd-1234-auto  # CSIé©±åŠ¨ç”Ÿæˆçš„å·ID
```

---

### 6. ğŸ”„ å·ç”Ÿå‘½å‘¨æœŸç®¡ç†

#### 6.1 å·çš„ç”Ÿå‘½å‘¨æœŸé˜¶æ®µ

å·çš„ç”Ÿå‘½å‘¨æœŸå°±åƒ"ç§Ÿæˆ¿è¿‡ç¨‹"ï¼š

```
å·ç”Ÿå‘½å‘¨æœŸç±»æ¯”ï¼š
ğŸ“ ç”³è¯·é˜¶æ®µ  â†’ ğŸ  åˆ›å»ºé˜¶æ®µ  â†’ ğŸ”‘ é™„åŠ é˜¶æ®µ  â†’ ğŸ¡ ä½¿ç”¨é˜¶æ®µ  â†’ ğŸšš å›æ”¶é˜¶æ®µ
  (Pending)    (Available)   (Attached)    (InUse)      (Released)
     â†“              â†“            â†“            â†“             â†“
  æäº¤ç§Ÿæˆ¿ç”³è¯·    æˆ¿æºå‡†å¤‡å¥½    é’¥åŒ™åˆ°æ‰‹      æ­£å¸¸å±…ä½      é€€æˆ¿æ¸…ç†
```

#### 6.2 å·é™„åŠ åˆ†ç¦»æ“ä½œ

**ğŸ”— Attach/Detachè¿‡ç¨‹è¯¦è§£ï¼š**

```yaml
## å·é™„åŠ åˆ°èŠ‚ç‚¹ï¼ˆControllerPublishVolumeï¼‰
é™„åŠ æ“ä½œæµç¨‹ï¼š
å­˜å‚¨å· â†’ è¿æ¥åˆ°èŠ‚ç‚¹ â†’ åœ¨èŠ‚ç‚¹ä¸Šå¯è§ â†’ ç­‰å¾…æŒ‚è½½
  â†“         â†“          â†“           â†“
vol-123  attach to  /dev/sdb    ready to mount
        node-worker1
```

**âš¡ å®é™…æ“ä½œç¤ºä¾‹ï¼š**
```bash
## CSI Controller æ‰§è¡Œçš„é™„åŠ æ“ä½œï¼ˆæ¦‚å¿µç¤ºä¾‹ï¼‰
## å®é™…ç”±CSIé©±åŠ¨è‡ªåŠ¨å®Œæˆ
csi-controller-call:
  method: ControllerPublishVolume
  volume_id: "vol-abc123"
  node_id: "worker-node-1"  
  access_mode: "single-writer"

## æ“ä½œç»“æœï¼šå­˜å‚¨å·è¢«"è¿æ¥"åˆ°æŒ‡å®šèŠ‚ç‚¹
## ç±»ä¼¼äºï¼šUSBè®¾å¤‡æ’å…¥ç”µè„‘ï¼Œä½†è¿˜æœªæŒ‚è½½åˆ°æ–‡ä»¶ç³»ç»Ÿ
```

#### 6.3 å·æŒ‚è½½è¿‡ç¨‹

**ğŸ“ Node ServiceæŒ‚è½½æ“ä½œï¼š**

```
æŒ‚è½½æ“ä½œä¸¤é˜¶æ®µï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stageé˜¶æ®µ       â”‚ â†’  â”‚ Publishé˜¶æ®µ     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  
â”‚ è®¾å¤‡ â†’ ä¸´æ—¶è·¯å¾„ â”‚    â”‚ ä¸´æ—¶è·¯å¾„ â†’ Pod â”‚
â”‚ /dev/sdb        â”‚    â”‚ /tmp/vol â†’     â”‚
â”‚      â†“          â”‚    â”‚    /app/data    â”‚
â”‚ /tmp/vol-stagingâ”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

## Stageï¼šå‡†å¤‡æŒ‚è½½ç‚¹ï¼Œæ ¼å¼åŒ–æ–‡ä»¶ç³»ç»Ÿ
## Publishï¼šæŒ‚è½½åˆ°Podçš„æœ€ç»ˆè·¯å¾„
```

#### 6.4 å·å¿«ç…§åŠŸèƒ½

**ğŸ“¸ å¿«ç…§å°±åƒ"ç…§ç‰‡å¤‡ä»½"**ï¼š

```yaml
## åˆ›å»ºå·å¿«ç…§ç±»
apiVersion: snapshot.storage.k8s.io/v1
kind: VolumeSnapshotClass
metadata:
  name: csi-snapclass
driver: my-storage.csi.k8s.io
deletionPolicy: Delete

---
## åˆ›å»ºå®é™…å¿«ç…§
apiVersion: snapshot.storage.k8s.io/v1  
kind: VolumeSnapshot
metadata:
  name: my-app-snapshot
spec:
  volumeSnapshotClassName: csi-snapclass
  source:
    persistentVolumeClaimName: my-app-storage  # è¦å¿«ç…§çš„PVC

## å¿«ç…§åˆ›å»ºåçš„çŠ¶æ€
status:
  boundVolumeSnapshotContentName: snapcontent-abc123
  creationTime: "2025-09-19T10:30:00Z"
  readyToUse: true
  restoreSize: 100Gi
```

**ğŸ”„ ä»å¿«ç…§æ¢å¤æ•°æ®ï¼š**
```yaml  
## ä»å¿«ç…§åˆ›å»ºæ–°çš„PVC
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: restored-from-snapshot
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 100Gi
  dataSource:                    # æŒ‡å®šæ•°æ®æºä¸ºå¿«ç…§
    name: my-app-snapshot
    kind: VolumeSnapshot
    apiGroup: snapshot.storage.k8s.io
```

#### 6.5 å·å…‹éš†æ“ä½œ

**ğŸ”„ å·å…‹éš†å°±åƒ"å¤åˆ¶ç²˜è´´"**ï¼š

```yaml
## å…‹éš†ç°æœ‰PVCåˆ›å»ºæ–°PVC  
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: cloned-volume
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 100Gi
  dataSource:
    name: original-pvc    # æºPVCåç§°
    kind: PersistentVolumeClaim
    
## å…‹éš†è¿‡ç¨‹ï¼š
åŸå§‹æ•°æ®å· â†’ CSIå…‹éš†æ“ä½œ â†’ æ–°æ•°æ®å·ï¼ˆæ•°æ®ç›¸åŒï¼‰
  100GB         å¤åˆ¶          100GB
```

---

### 7. ğŸŒ å­˜å‚¨æ‹“æ‰‘æ„ŸçŸ¥

#### 7.1 ä»€ä¹ˆæ˜¯å­˜å‚¨æ‹“æ‰‘

**æ‹“æ‰‘æ„ŸçŸ¥å°±åƒ"å°±è¿‘åŸåˆ™"**ï¼š

```
æ²¡æœ‰æ‹“æ‰‘æ„ŸçŸ¥çš„é—®é¢˜ï¼š
Podåœ¨åŒ—äº¬æœºæˆ¿ â†â”€ç½‘ç»œä¼ è¾“â”€â†’ å­˜å‚¨åœ¨ä¸Šæµ·æœºæˆ¿
     â†‘                        â†‘  
   è®¿é—®æ…¢                   å»¶è¿Ÿé«˜

æœ‰æ‹“æ‰‘æ„ŸçŸ¥çš„ä¼˜åŒ–ï¼š
Podåœ¨åŒ—äº¬æœºæˆ¿ â†â”€æœ¬åœ°è¿æ¥â”€â†’ å­˜å‚¨åœ¨åŒ—äº¬æœºæˆ¿  
     â†‘                        â†‘
   è®¿é—®å¿«                   å»¶è¿Ÿä½
```

#### 7.2 æ‹“æ‰‘æ ‡ç­¾é…ç½®

**ğŸ·ï¸ èŠ‚ç‚¹æ‹“æ‰‘æ ‡ç­¾ï¼š**
```yaml
## èŠ‚ç‚¹è‡ªåŠ¨æ·»åŠ çš„æ‹“æ‰‘æ ‡ç­¾
apiVersion: v1
kind: Node  
metadata:
  name: worker-node-1
  labels:
    topology.kubernetes.io/zone: "zone-a"      # å¯ç”¨åŒº
    topology.kubernetes.io/region: "us-east-1" # åœ°åŒº
    topology.csi.io/rack: "rack-1"             # æœºæ¶ï¼ˆè‡ªå®šä¹‰ï¼‰
```

#### 7.3 æ‹“æ‰‘æ„ŸçŸ¥çš„StorageClass

```yaml
## æ”¯æŒæ‹“æ‰‘æ„ŸçŸ¥çš„å­˜å‚¨ç±»
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: topology-aware-storage
provisioner: my-storage.csi.k8s.io
parameters:
  type: "ssd"
## å…è®¸çš„æ‹“æ‰‘èŒƒå›´
allowedTopologies:
- matchLabelExpressions:
  - key: topology.kubernetes.io/zone
    values: ["zone-a", "zone-b"]  # åªåœ¨è¿™äº›åŒºåŸŸåˆ›å»ºå­˜å‚¨
volumeBindingMode: WaitForFirstConsumer  # ç­‰å¾…Podè°ƒåº¦åå†åˆ›å»º
```

**â±ï¸ å»¶è¿Ÿç»‘å®šçš„å¥½å¤„ï¼š**
```
ç«‹å³ç»‘å®šæ¨¡å¼ï¼š
PVCåˆ›å»º â†’ ç«‹å³åˆ›å»ºPV â†’ Podè°ƒåº¦å¯èƒ½åˆ°å…¶ä»–åŒºåŸŸ â†’ è·¨åŒºåŸŸè®¿é—®æ…¢

å»¶è¿Ÿç»‘å®šæ¨¡å¼ï¼š  
PVCåˆ›å»º â†’ ç­‰å¾… â†’ Podç¡®å®šè°ƒåº¦ä½ç½® â†’ åœ¨åŒåŒºåŸŸåˆ›å»ºPV â†’ æœ¬åœ°è®¿é—®å¿«
```

---

### 8. ğŸš€ CSIé©±åŠ¨éƒ¨ç½²å®è·µ

#### 8.1 CSIé©±åŠ¨å®‰è£…æ­¥éª¤

**ğŸ“‹ éƒ¨ç½²æ¸…å•ï¼š**

```bash
## 1. åˆ›å»ºRBACæƒé™
kubectl apply -f rbac.yaml

## 2. éƒ¨ç½²CSI Controller (é›†ä¸­ç®¡ç†)  
kubectl apply -f csi-controller.yaml

## 3. éƒ¨ç½²CSI Node Plugin (æ¯ä¸ªèŠ‚ç‚¹)
kubectl apply -f csi-node-daemonset.yaml

## 4. åˆ›å»ºStorageClass
kubectl apply -f storageclass.yaml

## 5. éªŒè¯å®‰è£…
kubectl get csidrivers
kubectl get pods -n kube-system | grep csi
```

#### 8.2 å®Œæ•´çš„RBACé…ç½®

```yaml
## CSIé©±åŠ¨éœ€è¦çš„æƒé™é…ç½®
apiVersion: v1
kind: ServiceAccount
metadata:
  name: csi-controller-sa
  namespace: kube-system

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: csi-controller-role
rules:
## ç®¡ç†PVçš„æƒé™
- apiGroups: [""]
  resources: ["persistentvolumes"]
  verbs: ["get", "list", "watch", "create", "delete"]
## ç®¡ç†PVCçš„æƒé™  
- apiGroups: [""]
  resources: ["persistentvolumeclaims"]
  verbs: ["get", "list", "watch", "update"]
## ç®¡ç†StorageClassçš„æƒé™
- apiGroups: ["storage.k8s.io"]  
  resources: ["storageclasses"]
  verbs: ["get", "list", "watch"]
## ç®¡ç†å¿«ç…§çš„æƒé™
- apiGroups: ["snapshot.storage.k8s.io"]
  resources: ["volumesnapshots", "volumesnapshotcontents"]
  verbs: ["get", "list", "watch", "create", "delete"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: csi-controller-binding
subjects:
- kind: ServiceAccount
  name: csi-controller-sa
  namespace: kube-system
roleRef:
  kind: ClusterRole
  name: csi-controller-role
  apiGroup: rbac.authorization.k8s.io
```

#### 8.3 CSIé©±åŠ¨æ³¨å†Œ

**ğŸ“ CSIDriverå¯¹è±¡æ³¨å†Œï¼š**
```yaml
apiVersion: storage.k8s.io/v1
kind: CSIDriver
metadata:  
  name: my-storage.csi.k8s.io
spec:
#  # æ”¯æŒå·é™„åŠ æ“ä½œ
  attachRequired: true
#  # æ”¯æŒPodä¿¡æ¯ä¼ é€’ç»™é©±åŠ¨
  podInfoOnMount: true  
#  # æ”¯æŒçš„è®¿é—®æ¨¡å¼
  volumeLifecycleModes:
  - Persistent      # æŒä¹…å·
  - Ephemeral      # ä¸´æ—¶å·
#  # æ”¯æŒæ–‡ä»¶ç³»ç»Ÿç»„å˜æ›´
  fsGroupPolicy: "ReadWriteOnceWithFSType"
```

#### 8.4 å¥åº·æ£€æŸ¥å’Œç›‘æ§

```yaml
## CSIé©±åŠ¨å¥åº·æ£€æŸ¥é…ç½®
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: csi-driver
    image: my-storage/csi-driver:latest
    livenessProbe:
      httpGet:
        path: /healthz
        port: 8080
      initialDelaySeconds: 10
      periodSeconds: 30
    readinessProbe:
      httpGet:
        path: /ready  
        port: 8080
      initialDelaySeconds: 5
      periodSeconds: 10
```

**ğŸ“Š ç›‘æ§æŒ‡æ ‡æ”¶é›†ï¼š**
```yaml
## Prometheusç›‘æ§é…ç½®ç¤ºä¾‹
- job_name: 'csi-driver'
  kubernetes_sd_configs:
  - role: pod
  relabel_configs:
  - source_labels: [__meta_kubernetes_pod_label_app]
    action: keep
    regex: csi-driver
  - source_labels: [__meta_kubernetes_pod_container_port_name]
    action: keep  
    regex: metrics
```

---

### 9. ğŸ”— ç¬¬ä¸‰æ–¹å­˜å‚¨é›†æˆ

#### 9.1 ä¸»æµå­˜å‚¨å‚å•†CSIé©±åŠ¨

**ğŸ¢ ä¼ä¸šçº§å­˜å‚¨å‚å•†ï¼š**

| å‚å•† | **CSIé©±åŠ¨åç§°** | **æ”¯æŒåŠŸèƒ½** | **å…¸å‹ç”¨é€”** |
|------|----------------|-------------|-------------|
| ğŸ”· **AWS** | `ebs.csi.aws.com` | `åŠ¨æ€ä¾›åº”ã€å¿«ç…§ã€åŠ å¯†` | `äº‘åŸç”Ÿåº”ç”¨` |
| ğŸ”µ **Google** | `pd.csi.storage.gke.io` | `å¤šåŒºåŸŸå¤åˆ¶ã€è‡ªåŠ¨æ‰©å®¹` | `GKEé›†ç¾¤` |
| âš¡ **Azure** | `disk.csi.azure.com` | `Premium SSDã€Ultra Disk` | `AKSé›†ç¾¤` |
| ğŸ™ **Ceph** | `rook-ceph.rbd.csi.ceph.com` | `åˆ†å¸ƒå¼å­˜å‚¨ã€é«˜å¯ç”¨` | `ç§æœ‰äº‘å­˜å‚¨` |
| ğŸ”¸ **NetApp** | `trident.netapp.io` | `ä¼ä¸šçº§ç‰¹æ€§ã€QoS` | `ä¼ ç»Ÿæ•°æ®ä¸­å¿ƒ` |

#### 9.2 AWS EBS CSIé©±åŠ¨ç¤ºä¾‹

```yaml
## AWS EBS CSIé©±åŠ¨StorageClass
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: ebs-gp3
provisioner: ebs.csi.aws.com
parameters:
  type: gp3                    # EBSå·ç±»å‹
  iops: "3000"                # IOPSè®¾ç½®
  throughput: "125"           # ååé‡MB/s
  encrypted: "true"           # å¯ç”¨åŠ å¯†
  kmsKeyId: "arn:aws:kms:..."  # KMSå¯†é’¥
allowVolumeExpansion: true
volumeBindingMode: WaitForFirstConsumer
```

**ğŸ’» ä½¿ç”¨AWS EBSå­˜å‚¨ï¼š**
```yaml
## ä½¿ç”¨AWS EBSçš„PVC
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: aws-ebs-claim
spec:
  accessModes:
  - ReadWriteOnce
  storageClassName: ebs-gp3
  resources:
    requests:
      storage: 100Gi

## å®é™…åˆ›å»ºçš„EBSå·ä¼šè‡ªåŠ¨æ ‡ç­¾åŒ–
## AWSä¸­ä¼šçœ‹åˆ°ï¼š
## Volume ID: vol-1234567890abcdef0
## Tags: 
##   kubernetes.io/cluster/my-cluster: owned
##   kubernetes.io/created-for/pvc/name: aws-ebs-claim
```

#### 9.3 Ceph CSIé©±åŠ¨ç¤ºä¾‹

```yaml
## Ceph RBDå­˜å‚¨ç±»é…ç½®
apiVersion: storage.k8s.io/v1
kind: StorageClass  
metadata:
  name: ceph-rbd
provisioner: rook-ceph.rbd.csi.ceph.com
parameters:
  clusterID: rook-ceph                 # Cephé›†ç¾¤ID
  pool: kubernetes                     # å­˜å‚¨æ± åç§°
  imageFeatures: layering              # RBDé•œåƒç‰¹æ€§
  csi.storage.k8s.io/provisioner-secret-name: rook-csi-rbd-provisioner
  csi.storage.k8s.io/provisioner-secret-namespace: rook-ceph
  csi.storage.k8s.io/node-stage-secret-name: rook-csi-rbd-node
  csi.storage.k8s.io/node-stage-secret-namespace: rook-ceph
reclaimPolicy: Delete
allowVolumeExpansion: true
```

#### 9.4 æœ¬åœ°å­˜å‚¨CSIé©±åŠ¨

```yaml
## æœ¬åœ°å­˜å‚¨é©±åŠ¨é…ç½®
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: local-storage
provisioner: kubernetes.io/no-provisioner  # é™æ€ä¾›åº”
volumeBindingMode: WaitForFirstConsumer

---
## æœ¬åœ°PVå®šä¹‰
apiVersion: v1
kind: PersistentVolume
metadata:
  name: local-pv-1
spec:
  capacity:
    storage: 100Gi
  accessModes:
  - ReadWriteOnce
  persistentVolumeReclaimPolicy: Delete
  storageClassName: local-storage
  local:
    path: /data/local-pv-1           # æœ¬åœ°è·¯å¾„
  nodeAffinity:                      # èŠ‚ç‚¹äº²å’Œæ€§
    required:
      nodeSelectorTerms:
      - matchExpressions:
        - key: kubernetes.io/hostname
          operator: In
          values:
          - worker-node-1           # ç»‘å®šåˆ°ç‰¹å®šèŠ‚ç‚¹
```

---

### 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“

#### 10.1 CSIæ ¸å¿ƒæ¦‚å¿µå›é¡¾

**ğŸ¯ å¿…é¡»ç†è§£çš„æ ¸å¿ƒæ¦‚å¿µï¼š**

```
CSIä¸‰å¤§æœåŠ¡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Identity       â”‚   Controller    â”‚     Node        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é©±åŠ¨èº«ä»½ä¿¡æ¯    â”‚   å·çš„ç®¡ç†      â”‚   å·çš„æŒ‚è½½      â”‚
â”‚ åŠŸèƒ½èƒ½åŠ›æŸ¥è¯¢    â”‚   åˆ›å»º/åˆ é™¤     â”‚   æœ¬åœ°æ“ä½œ      â”‚
â”‚ å¥åº·çŠ¶æ€æ£€æŸ¥    â”‚   å¿«ç…§/å…‹éš†     â”‚   æ–‡ä»¶ç³»ç»Ÿ      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

CSI vs ä¼ ç»Ÿæ–¹å¼ï¼š
ä¼ ç»Ÿï¼šå­˜å‚¨åŠŸèƒ½å†…ç½®åœ¨Kubernetes â†’ æ›´æ–°æ…¢ã€æ‰©å±•éš¾
CSIï¼š  å­˜å‚¨åŠŸèƒ½ç‹¬ç«‹æ’ä»¶åŒ–      â†’ æ›´æ–°å¿«ã€æ‰©å±•æ˜“
```

#### 10.2 å®é™…åº”ç”¨å»ºè®®

**âœ… é€‰æ‹©CSIé©±åŠ¨çš„è€ƒè™‘å› ç´ ï¼š**

```markdown
å­˜å‚¨é€‰å‹å†³ç­–æ ‘ï¼š
ä½ çš„ç¯å¢ƒæ˜¯ï¼Ÿ
â”œâ”€ å…¬æœ‰äº‘ç¯å¢ƒ
â”‚   â”œâ”€ AWS â†’ é€‰æ‹©EBS CSI
â”‚   â”œâ”€ Azure â†’ é€‰æ‹©Azure Disk CSI  
â”‚   â””â”€ GCP â†’ é€‰æ‹©GCE PD CSI
â”œâ”€ ç§æœ‰äº‘ç¯å¢ƒ
â”‚   â”œâ”€ æœ‰Ceph â†’ é€‰æ‹©Ceph RBD CSI
â”‚   â”œâ”€ æœ‰å­˜å‚¨è®¾å¤‡ â†’ å‚å•†CSIé©±åŠ¨
â”‚   â””â”€ ç®€å•éœ€æ±‚ â†’ Local Path CSI
â””â”€ æ··åˆäº‘ç¯å¢ƒ
    â””â”€ è€ƒè™‘æ”¯æŒå¤šäº‘çš„CSIé©±åŠ¨
```

**âš¡ æ€§èƒ½ä¼˜åŒ–å»ºè®®ï¼š**

| åœºæ™¯ | **å»ºè®®é…ç½®** | **å…³é”®å‚æ•°** |
|------|-------------|-------------|
| ğŸ“ˆ **é«˜IOPSéœ€æ±‚** | `Premium SSD + å¤šå‰¯æœ¬` | `type: premium-ssd` |
| ğŸ’¾ **å¤§å®¹é‡å­˜å‚¨** | `æ ‡å‡†HDD + å‹ç¼©` | `type: standard, compression: true` |
| ğŸ”’ **å®‰å…¨æ•æ„Ÿ** | `åŠ å¯†å­˜å‚¨ + å¯†é’¥ç®¡ç†` | `encrypted: true, kmsKeyId: xxx` |
| ğŸŒ **å¤šåŒºåŸŸ** | `æ‹“æ‰‘æ„ŸçŸ¥ + å»¶è¿Ÿç»‘å®š` | `volumeBindingMode: WaitForFirstConsumer` |

#### 10.3 å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

**â“ å¸¸è§é—®é¢˜è¯Šæ–­ï¼š**

```bash
## 1. CSIé©±åŠ¨æœªæ­£ç¡®æ³¨å†Œ
kubectl get csidrivers
## å¦‚æœæ²¡æœ‰çœ‹åˆ°ä½ çš„é©±åŠ¨ï¼Œæ£€æŸ¥CSIDriverå¯¹è±¡

## 2. PVCä¸€ç›´å¤„äºPendingçŠ¶æ€
kubectl describe pvc my-pvc
## æŸ¥çœ‹Eventséƒ¨åˆ†çš„é”™è¯¯ä¿¡æ¯

## 3. Podæ— æ³•æŒ‚è½½å·
kubectl describe pod my-pod
## æŸ¥çœ‹å·æŒ‚è½½ç›¸å…³çš„é”™è¯¯

## 4. CSIé©±åŠ¨PodçŠ¶æ€å¼‚å¸¸
kubectl logs -n kube-system csi-controller-xxx -c driver
## æŸ¥çœ‹é©±åŠ¨å®¹å™¨æ—¥å¿—
```

**ğŸ› ï¸ æ•…éšœæ’æŸ¥æ¸…å•ï¼š**

- [ ] æ£€æŸ¥CSIé©±åŠ¨Podè¿è¡ŒçŠ¶æ€
- [ ] éªŒè¯RBACæƒé™é…ç½®æ­£ç¡®
- [ ] ç¡®è®¤StorageClassé…ç½®æ— è¯¯
- [ ] æ£€æŸ¥èŠ‚ç‚¹æ ‡ç­¾å’Œæ‹“æ‰‘é…ç½®
- [ ] æŸ¥çœ‹CSIé©±åŠ¨æ—¥å¿—è¾“å‡º
- [ ] éªŒè¯å­˜å‚¨åç«¯è¿é€šæ€§

#### 10.4 æœ€ä½³å®è·µå»ºè®®

**ğŸ¯ ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µï¼š**

```yaml
## 1. å§‹ç»ˆé…ç½®èµ„æºé™åˆ¶
resources:
  limits:
    cpu: 200m
    memory: 200Mi
  requests:
    cpu: 100m  
    memory: 100Mi

## 2. é…ç½®é€‚å½“çš„å­˜å‚¨å›æ”¶ç­–ç•¥
reclaimPolicy: Retain  # ç”Ÿäº§ç¯å¢ƒå»ºè®®ä¿ç•™æ•°æ®

## 3. å¯ç”¨å·ç›‘æ§
csi.storage.k8s.io/fstype: ext4
## å®šæœŸæ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿå¥åº·çŠ¶æ€

## 4. ä½¿ç”¨å¿«ç…§è¿›è¡Œå¤‡ä»½
apiVersion: snapshot.storage.k8s.io/v1
kind: VolumeSnapshotClass
metadata:
  name: daily-backup
driver: your.csi.driver
deletionPolicy: Retain
```

**ğŸ’¡ å®‰å…¨é…ç½®å»ºè®®ï¼š**

```yaml
## 1. å¯ç”¨å­˜å‚¨åŠ å¯†
parameters:
  encrypted: "true"
  kmsKeyId: "your-kms-key-id"

## 2. é…ç½®ç½‘ç»œç­–ç•¥é™åˆ¶CSIé©±åŠ¨è®¿é—®
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: csi-driver-policy
spec:
  podSelector:
    matchLabels:
      app: csi-driver
  policyTypes:
  - Ingress
  - Egress

## 3. ä½¿ç”¨Secretç®¡ç†æ•æ„Ÿä¿¡æ¯
csi.storage.k8s.io/provisioner-secret-name: storage-credentials
csi.storage.k8s.io/provisioner-secret-namespace: kube-system
```

---

**ğŸ“ å­¦ä¹ å»ºè®®ï¼š**

1. **ç†è®ºåŸºç¡€** - å…ˆç†è§£CSIæ ‡å‡†å’Œæ¶æ„
2. **åŠ¨æ‰‹å®è·µ** - éƒ¨ç½²ç®€å•çš„CSIé©±åŠ¨æµ‹è¯•
3. **åœºæ™¯åº”ç”¨** - åœ¨å®é™…é¡¹ç›®ä¸­é€‰æ‹©åˆé€‚çš„å­˜å‚¨æ–¹æ¡ˆ
4. **é—®é¢˜è§£å†³** - å­¦ä¼šè¯Šæ–­å’Œè§£å†³å¸¸è§å­˜å‚¨é—®é¢˜
5. **æŒç»­å­¦ä¹ ** - å…³æ³¨CSIæ ‡å‡†æ›´æ–°å’Œæ–°ç‰¹æ€§

**ğŸ’¬ è®°å¿†å£è¯€ï¼š**
```
"CSIä¸‰æœåŠ¡ï¼Œèº«ä»½æ§åˆ¶èŠ‚ç‚¹æ¸…ï¼Œ
åŠ¨æ€ä¾›åº”å¿«ï¼Œæ‹“æ‰‘æ„ŸçŸ¥å»¶è¿Ÿç»‘ï¼Œ
å¿«ç…§å…‹éš†å…¨ï¼Œç›‘æ§æ—¥å¿—æ’æ•…éšœï¼"
```

CSIå®¹å™¨å­˜å‚¨æ¥å£æ˜¯ç°ä»£Kuberneteså­˜å‚¨çš„åŸºç¡€ï¼ŒæŒæ¡å®ƒèƒ½è®©ä½ åœ¨å®¹å™¨åŒ–å­˜å‚¨ç®¡ç†æ–¹é¢æ¸¸åˆƒæœ‰ä½™ï¼