---
title: 6、认证授权机制
---
## 📚 目录

1. [Kubernetes安全机制概述](#1-Kubernetes安全机制概述)
2. [用户认证流程详解](#2-用户认证流程详解)
3. [TLS证书认证实战](#3-TLS证书认证实战)
4. [kubeconfig配置文件管理](#4-kubeconfig配置文件管理)
5. [Token令牌认证机制](#5-Token令牌认证机制)
6. [授权策略模式深入](#6-授权策略模式深入)
7. [审计日志记录与监控](#7-审计日志记录与监控)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🔒 Kubernetes安全机制概述


### 1.1 为什么需要安全机制


想象一下，Kubernetes集群就像一个大型的公司办公楼：

```
🏢 办公楼类比 Kubernetes 集群
├─ 🚪 大门安保     ← API Server 入口控制
├─ 🆔 门禁卡认证   ← 用户身份认证(Authentication)
├─ 🔑 权限管理     ← 访问授权(Authorization)  
├─ 👮‍♂️ 准入检查     ← 准入控制(Admission)
└─ 📹 监控录像     ← 审计日志(Auditing)
```

**🎯 安全的三道防线**

| 防线层级 | 作用说明 | 生活类比 |
|---------|---------|---------|
| **🆔 认证** | 你是谁？ | 刷门禁卡验证身份 |
| **🔑 授权** | 你能做什么？ | 检查你的权限等级 |
| **🚫 准入** | 这样做合规吗？ | 安保最后检查 |

### 1.2 Kubernetes安全架构全景


```
用户/应用程序
       ↓
   API Server
       ↓
┌─────────────────┐
│  🆔 Authentication │ ← 身份认证
│  (认证阶段)        │
├─────────────────┤
│  🔑 Authorization  │ ← 权限授权  
│  (授权阶段)        │
├─────────────────┤
│  🚫 Admission     │ ← 准入控制
│  (准入阶段)        │
└─────────────────┘
       ↓
   访问资源
       ↓
   📹 审计记录
```

**💡 新手理解要点**
- 认证解决"身份验证"问题 - 就像检查你的身份证
- 授权解决"权限控制"问题 - 就像检查你的会员等级
- 准入解决"合规检查"问题 - 就像最后的安全检查

### 1.3 认证授权的实际应用场景


**🏷️ 常见使用场景**

```markdown
👨‍💻 **开发人员**
- 需要：部署应用、查看日志、调试Pod
- 权限：对特定namespace的读写权限

👩‍💼 **运维人员** 
- 需要：管理集群、监控资源、故障排查
- 权限：集群级别的管理权限

🤖 **自动化服务**
- 需要：CI/CD流水线、监控告警、自动扩缩容
- 权限：基于Token的服务账户权限
```

---

## 2. 🆔 用户认证流程详解


### 2.1 Kubernetes中的"用户"概念


在Kubernetes中，用户分为两大类，就像公司里有正式员工和访客：

**👥 用户类型对比**

| 用户类型 | 说明 | 管理方式 | 使用场景 |
|---------|------|---------|----------|
| **🧑 User(用户)** | 真实的人 | 外部系统管理 | kubectl操作、开发调试 |
| **🤖 ServiceAccount(服务账户)** | 程序/服务 | K8s内部管理 | Pod内程序、CI/CD |

**🔍 用户认证流程图**

```
客户端请求                 API Server               认证结果
     │                        │                      │
     │──[1]发送请求+凭证────────→│                      │
     │   (证书/Token/密码)      │                      │
     │                        │─[2]验证凭证───────────→│认证插件
     │                        │←[3]返回用户信息────────│(多种方式)
     │                        │                      │
     │←─[4]认证成功/失败────────│                      │
     │                        │                      │
```

### 2.2 认证方式详解


**🔐 主要认证方式**

```markdown
📋 **认证方式优先级排序**
1️⃣ **X509客户端证书** ⭐⭐⭐⭐⭐
   - 最安全、最常用
   - 适合：管理员、长期访问
   
2️⃣ **Bearer Token** ⭐⭐⭐⭐
   - 简单易用、适合自动化
   - 适合：ServiceAccount、CI/CD
   
3️⃣ **静态密码文件** ⭐⭐
   - 简单但不够安全
   - 适合：测试环境、临时使用
   
4️⃣ **Bootstrap Token** ⭐⭐⭐
   - 节点加入集群专用
   - 适合：新节点自动加入
```

### 2.3 认证失败常见问题诊断


**🚨 认证问题诊断指南**

| 错误信息 | 原因分析 | 解决方案 |
|---------|---------|---------|
| `Unauthorized` | 认证凭证无效 | 检查证书/Token是否正确 |
| `certificate signed by unknown authority` | 证书不被信任 | 更新CA证书或kubeconfig |
| `User cannot be found` | 用户不存在 | 检查用户名拼写或创建用户 |

---

## 3. 🔐 TLS证书认证实战


### 3.1 证书认证原理简介


TLS证书认证就像身份证的概念，每个人都有独特的身份标识：

**🆔 证书认证类比**
```
身份证系统                    TLS证书系统
├─ 🏛️ 公安局(颁发机构)      ←→  CA(证书颁发机构)
├─ 📄 身份证(证件)          ←→  客户端证书  
├─ 🔍 验证真伪(过程)        ←→  证书链验证
└─ ✅ 确认身份(结果)        ←→  认证成功
```

### 3.2 创建用户证书实战演练


**🎯 实战目标：为开发人员小王创建访问证书**

**步骤 1️⃣：生成私钥**
```bash
# 为用户xiaowang生成私钥
openssl genrsa -out xiaowang.key 2048
```

**步骤 2️⃣：创建证书签名请求**
```bash
# 创建CSR (Certificate Signing Request)
openssl req -new -key xiaowang.key -out xiaowang.csr -subj "/CN=xiaowang/O=developers"
```

> 💡 **参数说明**
> - `CN=xiaowang`: 用户名为xiaowang  
> - `O=developers`: 用户组为developers

**步骤 3️⃣：使用集群CA签署证书**
```bash
# 使用K8s集群的CA签署证书
sudo openssl x509 -req -in xiaowang.csr \
  -CA /etc/kubernetes/pki/ca.crt \
  -CAkey /etc/kubernetes/pki/ca.key \
  -CAcreateserial \
  -out xiaowang.crt -days 365
```

**步骤 4️⃣：验证证书信息**
```bash
# 查看证书详情
openssl x509 -in xiaowang.crt -text -noout
```

### 3.3 证书文件管理最佳实践


**📂 证书文件组织结构**
```
kubernetes-certs/
├── 📁 users/
│   ├── 📄 xiaowang.key     # 私钥 (保密!)
│   ├── 📄 xiaowang.crt     # 证书
│   └── 📄 xiaowang.csr     # 签名请求
├── 📁 ca/
│   ├── 📄 ca.crt          # CA证书
│   └── 📄 ca.key          # CA私钥 (极机密!)
└── 📄 README.md           # 说明文档
```

**🔒 证书安全管理**
- ✅ 私钥文件权限设为 `600` (仅所有者可读写)
- ✅ 定期轮换证书（建议1年更换）
- ✅ 备份重要证书到安全存储
- ❌ 绝不在代码仓库中提交私钥

---

## 4. ⚙️ kubeconfig配置文件管理


### 4.1 kubeconfig文件结构解析


kubeconfig就像你手机里的通讯录，记录了所有重要的联系方式：

**📱 通讯录类比 kubeconfig**
```
手机通讯录                   kubeconfig配置
├─ 📞 联系人信息          ←→  clusters (集群信息)
├─ 👤 个人资料            ←→  users (用户认证)  
├─ 💼 工作群组            ←→  contexts (上下文)
└─ ⚙️ 默认设置            ←→  current-context
```

### 4.2 kubeconfig文件详细配置


**📋 完整的kubeconfig示例**

```yaml
# kubeconfig 配置文件示例
apiVersion: v1
kind: Config
preferences: {}

# 🏢 集群信息 - 告诉kubectl去哪里连接
clusters:
- cluster:
    certificate-authority-data: LS0tLS1CRU... # CA证书(base64编码)
    server: https://192.168.1.100:6443      # API Server地址
  name: kubernetes                          # 集群名称

# 👤 用户信息 - 告诉kubectl用什么身份
users:
- name: xiaowang
  user:
    client-certificate-data: LS0tLS1CRU...  # 用户证书
    client-key-data: LS0tLS1CRU...          # 用户私钥

# 🔗 上下文 - 将集群、用户、namespace组合
contexts:
- context:
    cluster: kubernetes    # 使用哪个集群
    user: xiaowang        # 使用哪个用户
    namespace: default    # 默认namespace
  name: xiaowang@kubernetes

# 🎯 当前上下文
current-context: xiaowang@kubernetes
```

### 4.3 kubeconfig管理实战技巧


**🛠️ 常用kubeconfig操作**

```bash
# 查看当前配置
kubectl config view

# 查看所有上下文
kubectl config get-contexts

# 切换上下文
kubectl config use-context xiaowang@kubernetes

# 设置默认namespace
kubectl config set-context --current --namespace=development
```

**🎯 多环境管理策略**

| 环境类型 | 配置文件路径 | 使用方式 |
|---------|-------------|---------|
| **🏠 个人开发** | `~/.kube/config` | 默认配置 |
| **🧪 测试环境** | `~/.kube/test-config` | `export KUBECONFIG=~/.kube/test-config` |
| **🚀 生产环境** | `~/.kube/prod-config` | `kubectl --kubeconfig=prod-config` |

**💡 配置文件合并技巧**
```bash
# 合并多个配置文件
export KUBECONFIG=~/.kube/config:~/.kube/test-config:~/.kube/prod-config
kubectl config view --flatten > ~/.kube/merged-config
```

---

## 5. 🎫 Token令牌认证机制


### 5.1 Token认证基本概念


Token就像是电影票或者门票，有了它就可以进入特定的场所：

**🎫 Token类比说明**
```
电影票系统                   Token认证系统
├─ 🎬 电影院(服务方)       ←→  Kubernetes集群
├─ 🎫 电影票(凭证)         ←→  JWT Token
├─ 🕒 有效期(时限)         ←→  Token过期时间  
└─ 🔍 验票员(验证)         ←→  API Server验证
```

### 5.2 ServiceAccount与Token


**🤖 ServiceAccount工作原理**

```
Pod启动流程                        Token获取流程
     ↓                                   ↓
┌─────────────┐                   ┌─────────────┐
│  创建Pod     │────────────────→│  自动挂载    │
│            │                   │ Secret卷    │
└─────────────┘                   └─────────────┘
     ↓                                   ↓
┌─────────────┐                   ┌─────────────┐  
│ Pod内应用   │←─────────────────│ 读取Token   │
│ 调用API     │                   │ 文件        │
└─────────────┘                   └─────────────┘
```

### 5.3 ServiceAccount实战操作


**🎯 创建专用ServiceAccount**

```bash
# 创建ServiceAccount
kubectl create serviceaccount app-monitor -n monitoring

# 查看自动创建的Secret
kubectl get secrets -n monitoring | grep app-monitor

# 获取Token内容  
kubectl get secret $(kubectl get sa app-monitor -n monitoring -o jsonpath='{.secrets[0].name}') \
  -n monitoring -o jsonpath='{.data.token}' | base64 -d
```

**📋 在Pod中使用ServiceAccount**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: monitoring-app
  namespace: monitoring
spec:
  serviceAccountName: app-monitor  # 指定使用的ServiceAccount
  containers:
  - name: app
    image: monitoring:latest
    volumeMounts:
    - name: token-volume
      mountPath: /var/run/secrets/kubernetes.io/serviceaccount
      readOnly: true
```

> 💡 **Pod内Token位置**
> - Token文件：`/var/run/secrets/kubernetes.io/serviceaccount/token`
> - CA证书：`/var/run/secrets/kubernetes.io/serviceaccount/ca.crt`
> - Namespace：`/var/run/secrets/kubernetes.io/serviceaccount/namespace`

### 5.4 Token安全管理


**🔒 Token安全最佳实践**

| 安全原则 | 具体做法 | 为什么重要 |
|---------|---------|-----------|
| **🕒 最短生命周期** | 设置合理过期时间 | 减少Token泄露风险 |
| **🎯 最小权限原则** | 只给必需权限 | 限制潜在损害范围 |
| **🔄 定期轮换** | 定期更新Token | 降低长期暴露风险 |
| **📱 安全存储** | 使用Secret存储 | 避免明文暴露 |

**⚠️ Token泄露应急处理**
```bash
# 1. 立即删除泄露的ServiceAccount
kubectl delete serviceaccount compromised-sa -n namespace

# 2. 创建新的ServiceAccount  
kubectl create serviceaccount new-sa -n namespace

# 3. 重新部署相关应用
kubectl rollout restart deployment/app -n namespace
```

---

## 6. 🔑 授权策略模式深入


### 6.1 授权模式对比分析


Kubernetes的授权就像公司的权限管理系统，不同岗位有不同的权限：

**🏢 公司权限 vs K8s授权模式**

| 授权模式 | 公司类比 | 适用场景 | 推荐指数 |
|---------|---------|---------|----------|
| **🚫 AlwaysDeny** | 禁止所有人进入 | 紧急安全模式 | ⭐ |
| **✅ AlwaysAllow** | 所有人随便进 | 开发测试环境 | ⭐⭐ |
| **📊 ABAC** | 复杂规则系统 | 特殊需求场景 | ⭐⭐⭐ |
| **🎭 RBAC** | 角色权限管理 | **生产环境推荐** | ⭐⭐⭐⭐⭐ |

### 6.2 RBAC核心概念详解


**🎭 RBAC四大核心概念**

```
RBAC权限模型
├─ 👤 Subject (主体)      ← 谁要访问？
├─ 🎭 Role (角色)         ← 什么职位？  
├─ 🔗 Binding (绑定)      ← 谁是什么职位？
└─ 🎯 Resource (资源)     ← 能访问什么？
```

**🔍 RBAC工作流程**
```
用户xiaowang                 RBAC系统                 资源访问
      │                        │                        │
      │─[1]请求访问Pod─────────→│                        │
      │                        │─[2]查找用户角色─────────│
      │                        │  (developer role)      │
      │                        │─[3]检查角色权限─────────│  
      │                        │  (可读写dev namespace)  │
      │                        │─[4]授权决策─────────────│
      │←─[5]允许/拒绝访问──────│                        │
      │                        │                        │
      │─────[6]执行操作─────────────────────────────────→│
```

### 6.3 Role和ClusterRole详解


**📋 权限级别对比**

| 权限类型 | 作用范围 | 使用场景 | 配置示例 |
|---------|---------|---------|----------|
| **🏠 Role** | 单个namespace | 项目内权限管理 | 开发team访问dev空间 |
| **🌍 ClusterRole** | 整个集群 | 集群级管理 | 运维访问所有节点 |

**🎯 创建Role实战示例**

```yaml
# 开发人员角色 - 只能在development namespace操作
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: development
  name: developer
rules:
- apiGroups: [""]           # 核心API组
  resources: ["pods", "services", "configmaps"]
  verbs: ["get", "list", "create", "update", "patch", "delete"]
- apiGroups: ["apps"]       # apps API组  
  resources: ["deployments", "replicasets"]
  verbs: ["get", "list", "create", "update", "patch"]
```

**🌍 创建ClusterRole实战示例**

```yaml  
# 集群监控角色 - 可以查看整个集群状态
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: cluster-monitor
rules:
- apiGroups: [""]
  resources: ["nodes", "pods", "services"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["metrics.k8s.io"]
  resources: ["nodes", "pods"]  
  verbs: ["get", "list"]
```

### 6.4 权限绑定实战


**🔗 权限绑定类型**

```markdown
**RoleBinding vs ClusterRoleBinding**

🏠 **RoleBinding**
- 绑定对象：Role + 用户/组/ServiceAccount
- 作用范围：指定namespace内
- 使用场景：项目内权限管理

🌍 **ClusterRoleBinding** 
- 绑定对象：ClusterRole + 用户/组/ServiceAccount
- 作用范围：整个集群
- 使用场景：集群级权限管理
```

**🎯 权限绑定示例**

```yaml
# 将developer角色绑定给xiaowang用户
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: developer-binding
  namespace: development
subjects:
- kind: User
  name: xiaowang
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: Role
  name: developer
  apiGroup: rbac.authorization.k8s.io
```

**🔍 权限检查与调试**

```bash
# 检查用户权限
kubectl auth can-i create pods --as=xiaowang -n development

# 检查ServiceAccount权限  
kubectl auth can-i list nodes --as=system:serviceaccount:monitoring:app-monitor

# 查看用户所有权限
kubectl auth can-i --list --as=xiaowang -n development
```

### 6.5 常用权限配置模板


**👨‍💻 开发人员权限模板**
```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: developer
  namespace: development
rules:
- apiGroups: [""]
  resources: ["pods", "pods/log", "pods/exec"]
  verbs: ["get", "list", "create", "delete"]
- apiGroups: [""]  
  resources: ["services", "configmaps", "secrets"]
  verbs: ["get", "list", "create", "update", "patch"]
- apiGroups: ["apps"]
  resources: ["deployments", "replicasets"]
  verbs: ["get", "list", "create", "update", "patch", "delete"]
```

**👩‍💼 运维人员权限模板**
```yaml
apiVersion: rbac.authorization.k8s.io/v1  
kind: ClusterRole
metadata:
  name: ops-admin
rules:
- apiGroups: [""]
  resources: ["*"]
  verbs: ["*"]
- apiGroups: ["apps", "extensions", "networking.k8s.io"]
  resources: ["*"] 
  verbs: ["*"]
- apiGroups: ["rbac.authorization.k8s.io"]
  resources: ["*"]
  verbs: ["get", "list"] # 只读RBAC配置
```

---

## 7. 📹 审计日志记录与监控


### 7.1 审计日志的重要性


审计日志就像银行的交易记录，记录了所有重要操作：

**🏦 银行系统 vs K8s审计**
```
银行交易记录                 Kubernetes审计日志
├─ 👤 谁操作了              ←→  用户信息(user)
├─ 🕒 什么时间              ←→  时间戳(timestamp)  
├─ 💰 操作什么              ←→  资源对象(resource)
├─ 🔄 做了什么              ←→  操作动作(verb)
└─ ✅ 结果如何              ←→  响应状态(response)
```

### 7.2 审计策略配置


**📋 审计策略示例配置**

```yaml
# 审计策略配置文件
apiVersion: audit.k8s.io/v1
kind: Policy
rules:
# 记录所有认证失败
- level: Request
  omitStages:
    - RequestReceived
  users: ["system:anonymous"]
  verbs: ["get", "list", "create", "update", "patch", "delete"]

# 记录重要资源的所有操作
- level: Metadata
  resources:
  - group: ""
    resources: ["secrets", "configmaps"]
  - group: "rbac.authorization.k8s.io"
    resources: ["roles", "rolebindings", "clusterroles", "clusterrolebindings"]

# 记录Pod相关操作  
- level: Request
  resources:
  - group: ""
    resources: ["pods", "pods/exec", "pods/log"]
  verbs: ["create", "delete", "update", "patch"]
```

### 7.3 审计日志分析实战


**🔍 日志分析示例**

```json
{
  "kind": "Event",
  "apiVersion": "audit.k8s.io/v1",
  "level": "Request",
  "auditID": "36ef2853-5ec3-4f3e-9ff6-82dc4e18d7b5",
  "stage": "ResponseComplete",
  "requestURI": "/api/v1/namespaces/default/pods",
  "verb": "create",
  "user": {
    "username": "xiaowang",
    "groups": ["developers"]
  },
  "sourceIPs": ["192.168.1.50"],
  "userAgent": "kubectl/v1.28.0",
  "objectRef": {
    "resource": "pods",
    "namespace": "default",
    "name": "test-pod"
  },
  "responseStatus": {
    "code": 201
  },
  "requestReceivedTimestamp": "2024-01-21T10:30:00.000Z",
  "stageTimestamp": "2024-01-21T10:30:00.123Z"
}
```

**📊 关键审计指标监控**

| 监控指标 | 含义 | 告警阈值 | 处理建议 |
|---------|------|---------|----------|
| **🚨 认证失败率** | 无效认证尝试 | >5%/小时 | 检查暴力破解攻击 |
| **⚠️ 权限拒绝** | 授权失败操作 | >10次/分钟 | 检查权限配置 |
| **🔍 敏感资源访问** | Secret/ConfigMap操作 | 任何异常 | 立即调查 |
| **💥 Pod删除** | Pod被删除操作 | 批量删除 | 确认是否正常维护 |

### 7.4 安全监控最佳实践


**🛡️ 安全监控体系**

```
安全监控层级
├─ 🚨 实时告警
│   ├─ 认证失败激增
│   ├─ 异常IP访问  
│   └─ 权限提升操作
├─ 📊 趋势分析
│   ├─ 用户行为模式
│   ├─ 资源访问热点
│   └─ 操作时间分布  
└─ 🔍 深度调查
    ├─ 安全事件回溯
    ├─ 行为关联分析
    └─ 威胁情报匹配
```

**📱 监控工具推荐**

| 工具名称 | 功能特点 | 适用场景 |
|---------|---------|----------|
| **Prometheus + Grafana** | 指标监控可视化 | 性能监控、告警 |
| **ELK Stack** | 日志聚合分析 | 审计日志分析 |
| **Falco** | 运行时安全监控 | 异常行为检测 |
| **OPA Gatekeeper** | 策略合规检查 | 准入控制 |

---

## 8. 📋 核心要点总结


### 8.1 认证授权知识地图


```
🔒 Kubernetes安全体系
├─ 🆔 认证(Authentication)
│   ├─ TLS证书认证 ⭐⭐⭐⭐⭐
│   ├─ Token认证 ⭐⭐⭐⭐
│   ├─ 密码认证 ⭐⭐  
│   └─ Bootstrap Token ⭐⭐⭐
├─ 🔑 授权(Authorization)  
│   ├─ RBAC模式 ⭐⭐⭐⭐⭐
│   ├─ ABAC模式 ⭐⭐⭐
│   ├─ AlwaysAllow ⭐⭐
│   └─ AlwaysDeny ⭐
├─ 🚫 准入控制(Admission)
│   ├─ ResourceQuota ⭐⭐⭐⭐
│   ├─ PodSecurityPolicy ⭐⭐⭐⭐
│   └─ OPA Gatekeeper ⭐⭐⭐⭐⭐
└─ 📹 审计监控(Auditing)
    ├─ 审计日志 ⭐⭐⭐⭐⭐
    ├─ 实时监控 ⭐⭐⭐⭐
    └─ 安全分析 ⭐⭐⭐⭐⭐
```

### 8.2 新手学习路径


**🎯 建议学习顺序**

```
第一阶段：理解概念 (1-2天)
├─ ✅ 安全三道防线概念
├─ ✅ 用户vs ServiceAccount区别  
├─ ✅ RBAC基本概念
└─ ✅ kubeconfig文件结构

第二阶段：动手实践 (3-5天)  
├─ ✅ 创建用户证书
├─ ✅ 配置kubeconfig
├─ ✅ 创建Role和RoleBinding
└─ ✅ 测试权限验证

第三阶段：生产应用 (1周)
├─ ✅ 设计权限模型
├─ ✅ 配置审计日志
├─ ✅ 建立监控告警  
└─ ✅ 制定安全策略
```

### 8.3 常用命令速查表


**🔖 认证授权常用命令**

| 操作类别 | 命令示例 | 功能说明 |
|---------|---------|---------|
| **🆔 查看认证** | `kubectl config view` | 查看当前配置 |
| **🔄 切换上下文** | `kubectl config use-context` | 切换集群/用户 |
| **🔍 权限检查** | `kubectl auth can-i create pods` | 检查操作权限 |
| **👥 查看角色** | `kubectl get roles,rolebindings` | 查看RBAC配置 |
| **🎫 Token操作** | `kubectl create token sa-name` | 创建ServiceAccount Token |

### 8.4 安全最佳实践清单


**✅ 生产环境安全检查清单**

```markdown
🔒 **认证安全**
- [ ] 使用TLS证书而非密码认证
- [ ] 定期轮换证书和Token  
- [ ] 禁用匿名访问
- [ ] 配置强密码策略

🔑 **授权安全**  
- [ ] 实施最小权限原则
- [ ] 使用namespace隔离
- [ ] 定期审查权限配置
- [ ] 禁用AlwaysAllow模式

🚫 **准入控制**
- [ ] 启用ResourceQuota
- [ ] 配置PodSecurityPolicy  
- [ ] 使用准入控制器
- [ ] 限制特权容器

📹 **审计监控**
- [ ] 启用审计日志
- [ ] 配置实时告警
- [ ] 定期分析日志
- [ ] 建立事件响应流程
```

### 8.5 故障排查指南


**🚨 常见问题快速定位**

| 问题现象 | 可能原因 | 排查命令 | 解决思路 |
|---------|---------|---------|----------|
| **无法连接集群** | kubeconfig错误 | `kubectl config view` | 检查服务器地址和证书 |
| **认证失败** | 证书过期/无效 | `openssl x509 -in cert.crt -text` | 检查证书有效期和CN |
| **权限被拒绝** | RBAC配置错误 | `kubectl auth can-i --list` | 检查角色和绑定关系 |
| **Token无效** | Token过期 | `kubectl get secret` | 重新生成Token |

**🔧 问题解决工具箱**
```bash
# 权限调试工具集
alias k='kubectl'
alias kgp='kubectl get pods'  
alias kgs='kubectl get svc'
alias kgn='kubectl get nodes'
alias kaf='kubectl apply -f'
alias kdel='kubectl delete'

# 权限检查脚本
function check-rbac() {
  echo "检查用户 $1 的权限:"
  kubectl auth can-i --list --as=$1
}

# 快速权限测试
function test-permissions() {
  kubectl auth can-i create pods --as=$1 -n $2
  kubectl auth can-i delete pods --as=$1 -n $2  
  kubectl auth can-i get secrets --as=$1 -n $2
}
```

**💡 学习建议**
- 认证授权是K8s安全的核心，需要反复练习理解
- 建议在测试环境多做实验，熟悉各种配置
- 生产环境务必遵循最小权限和纵深防御原则
- 定期关注K8s安全更新和最佳实践

**核心记忆口诀**：
```
🎵 认证授权三步走，身份权限要看清
   证书Token两把钥，RBAC角色管得严  
   审计日志不能少，安全监控保平安
```