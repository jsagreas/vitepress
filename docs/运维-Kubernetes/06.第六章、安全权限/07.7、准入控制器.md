---
title: 7ã€å‡†å…¥æ§åˆ¶å™¨
---
## ğŸ“š ç›®å½•

1. [å‡†å…¥æ§åˆ¶å™¨åŸºæœ¬æ¦‚å¿µ](#1-å‡†å…¥æ§åˆ¶å™¨åŸºæœ¬æ¦‚å¿µ)
2. [å‡†å…¥æ§åˆ¶çš„å·¥ä½œæµç¨‹](#2-å‡†å…¥æ§åˆ¶çš„å·¥ä½œæµç¨‹)
3. [å†…ç½®å‡†å…¥æ§åˆ¶å™¨è¯¦è§£](#3-å†…ç½®å‡†å…¥æ§åˆ¶å™¨è¯¦è§£)
4. [Mutating Webhookå˜æ›´å‡†å…¥](#4-mutating-webhookå˜æ›´å‡†å…¥)
5. [Validating WebhookéªŒè¯å‡†å…¥](#5-validating-webhookéªŒè¯å‡†å…¥)
6. [å‡†å…¥æ§åˆ¶é“¾é…ç½®](#6-å‡†å…¥æ§åˆ¶é“¾é…ç½®)
7. [Webhooké…ç½®ç®¡ç†](#7-webhooké…ç½®ç®¡ç†)
8. [å®æˆ˜æ“ä½œæŒ‡å—](#8-å®æˆ˜æ“ä½œæŒ‡å—)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ›¡ï¸ å‡†å…¥æ§åˆ¶å™¨åŸºæœ¬æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯å‡†å…¥æ§åˆ¶å™¨


**ğŸ”¸ é€šä¿—ç†è§£**
æƒ³è±¡ä¸€ä¸‹æœºåœºå®‰æ£€ï¼šå½“ä½ è¦ç™»æœºæ—¶ï¼Œéœ€è¦é€šè¿‡å¤šé“æ£€æŸ¥å…³å¡ã€‚Kubernetesçš„å‡†å…¥æ§åˆ¶å™¨å°±åƒè¿™äº›å®‰æ£€å…³å¡ï¼Œ**æ¯ä¸ªæƒ³è¦è¿›å…¥é›†ç¾¤çš„èµ„æºè¯·æ±‚éƒ½å¿…é¡»é€šè¿‡è¿™äº›"å…³å¡"çš„æ£€æŸ¥**ã€‚

```
ç”¨æˆ·è¯·æ±‚ â†’ API Server â†’ è®¤è¯ â†’ æˆæƒ â†’ å‡†å…¥æ§åˆ¶ â†’ å­˜å‚¨åˆ°etcd
                                    â†‘
                               è¿™é‡Œå°±æ˜¯å‡†å…¥æ§åˆ¶å™¨å·¥ä½œçš„åœ°æ–¹
```

**ğŸ”¸ å‡†ç¡®å®šä¹‰**
å‡†å…¥æ§åˆ¶å™¨ï¼ˆAdmission Controllerï¼‰æ˜¯Kubernetes API Serverä¸­çš„ä¸€ä¸ª**æ’ä»¶åŒ–ç»„ä»¶**ï¼Œå®ƒåœ¨APIè¯·æ±‚è¢«æŒä¹…åŒ–åˆ°etcdä¹‹å‰è¿›è¡Œæœ€åçš„**æ‹¦æˆªã€éªŒè¯å’Œä¿®æ”¹**ã€‚

**ğŸ’¡ æ ¸å¿ƒä½œç”¨**
- **å®‰å…¨å®ˆé—¨å‘˜**ï¼šç¡®ä¿åªæœ‰ç¬¦åˆè§„èŒƒçš„èµ„æºèƒ½è¿›å…¥é›†ç¾¤
- **ç­–ç•¥æ‰§è¡Œå™¨**ï¼šè‡ªåŠ¨æ‰§è¡Œé›†ç¾¤çš„å®‰å…¨å’Œç®¡ç†ç­–ç•¥
- **èµ„æºä¿®æ”¹å™¨**ï¼šè‡ªåŠ¨ä¸ºèµ„æºæ·»åŠ å¿…è¦çš„é…ç½®å’Œæ ‡ç­¾

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦å‡†å…¥æ§åˆ¶å™¨


**ğŸ¯ è§£å†³çš„é—®é¢˜**

| é—®é¢˜åœºæ™¯ | ä¼ ç»Ÿæ–¹å¼ | å‡†å…¥æ§åˆ¶å™¨æ–¹å¼ |
|---------|---------|---------------|
| ğŸš« **é˜»æ­¢ä¸å®‰å…¨çš„é•œåƒ** | `äººå·¥å®¡æ ¸æ¯ä¸ªéƒ¨ç½²` | `è‡ªåŠ¨æ£€æŸ¥é•œåƒæ¥æºå’Œå®‰å…¨æ€§` |
| ğŸ·ï¸ **å¼ºåˆ¶æ·»åŠ æ ‡ç­¾** | `æé†’å¼€å‘è€…æ‰‹åŠ¨æ·»åŠ ` | `è‡ªåŠ¨æ·»åŠ å¿…éœ€çš„æ ‡ç­¾` |
| ğŸ’¾ **é™åˆ¶èµ„æºä½¿ç”¨** | `äº‹åå‘ç°èµ„æºè¶…é™` | `éƒ¨ç½²å‰å°±æ£€æŸ¥èµ„æºé…é¢` |
| ğŸ“ **ç­–ç•¥åˆè§„æ€§** | `å®šæœŸäººå·¥æ£€æŸ¥` | `å®æ—¶è‡ªåŠ¨éªŒè¯åˆè§„æ€§` |

### 1.3 å‡†å…¥æ§åˆ¶å™¨çš„ç±»å‹


**ğŸ”„ ä¸¤å¤§ç±»å‹**

```
å‡†å…¥æ§åˆ¶å™¨åˆ†ç±»ï¼š

å˜æ›´å‡†å…¥æ§åˆ¶å™¨ (Mutating)ï¼š
â”Œâ”€ å¯ä»¥ä¿®æ”¹è¯·æ±‚å¯¹è±¡
â”œâ”€ æ·»åŠ é»˜è®¤å€¼
â”œâ”€ æ³¨å…¥Sidecarå®¹å™¨
â””â”€ æ·»åŠ æ ‡ç­¾å’Œæ³¨è§£

éªŒè¯å‡†å…¥æ§åˆ¶å™¨ (Validating)ï¼š
â”Œâ”€ åªèƒ½éªŒè¯è¯·æ±‚
â”œâ”€ æ£€æŸ¥ç­–ç•¥åˆè§„æ€§
â”œâ”€ éªŒè¯èµ„æºé…ç½®
â””â”€ æ‹’ç»ä¸ç¬¦åˆè¦æ±‚çš„è¯·æ±‚
```

**âš¡ æ‰§è¡Œé¡ºåº**
```
APIè¯·æ±‚ â†’ Mutatingæ§åˆ¶å™¨ â†’ Validatingæ§åˆ¶å™¨ â†’ å­˜å‚¨
           â†“                â†“
         ä¿®æ”¹å¯¹è±¡          éªŒè¯å¯¹è±¡
        (å¯ä»¥æ”¹)          (åªèƒ½æŸ¥)
```

---

## 2. âš™ï¸ å‡†å…¥æ§åˆ¶çš„å·¥ä½œæµç¨‹


### 2.1 å®Œæ•´çš„è¯·æ±‚å¤„ç†æµç¨‹


**ğŸ”„ è¯¦ç»†æµç¨‹å›¾**

```
ç”¨æˆ·/ç³»ç»Ÿ
    â†“ [kubectl apply]
API Serveræ¥æ”¶è¯·æ±‚
    â†“ [HTTPè¯·æ±‚è§£æ]
è®¤è¯ (Authentication)
    â†“ [éªŒè¯èº«ä»½]
æˆæƒ (Authorization)  
    â†“ [æ£€æŸ¥æƒé™]
å‡†å…¥æ§åˆ¶ (Admission Control) â†â”€â”€ æˆ‘ä»¬åœ¨è¿™é‡Œï¼
    â”œâ”€ Mutating Admission
    â”‚   â”œâ”€ å†…ç½®å˜æ›´æ§åˆ¶å™¨
    â”‚   â””â”€ Mutating Webhook
    â””â”€ Validating Admission
        â”œâ”€ å†…ç½®éªŒè¯æ§åˆ¶å™¨  
        â””â”€ Validating Webhook
    â†“ [æ‰€æœ‰æ£€æŸ¥é€šè¿‡]
å­˜å‚¨åˆ°etcd
    â†“ [æŒä¹…åŒ–]
è¿”å›å“åº”ç»™å®¢æˆ·ç«¯
```

### 2.2 å‡†å…¥æ§åˆ¶é˜¶æ®µè¯¦è§£


**ğŸ”§ ç¬¬ä¸€é˜¶æ®µï¼šå˜æ›´å‡†å…¥ï¼ˆMutating Admissionï¼‰**

```
ç›®çš„ï¼šä¿®æ”¹å’Œå®Œå–„èµ„æºå¯¹è±¡
ç‰¹ç‚¹ï¼šå¯ä»¥æ”¹å˜è¯·æ±‚å†…å®¹

å…¸å‹æ“ä½œï¼š
â€¢ æ·»åŠ é»˜è®¤èµ„æºé™åˆ¶
â€¢ æ³¨å…¥ç¯å¢ƒå˜é‡
â€¢ æ·»åŠ å¿…éœ€çš„æ ‡ç­¾
â€¢ æŒ‚è½½Secretå’ŒConfigMap
â€¢ æ³¨å…¥Sidecarå®¹å™¨
```

**âœ… ç¬¬äºŒé˜¶æ®µï¼šéªŒè¯å‡†å…¥ï¼ˆValidating Admissionï¼‰**

```
ç›®çš„ï¼šéªŒè¯èµ„æºå¯¹è±¡çš„åˆæ³•æ€§
ç‰¹ç‚¹ï¼šåªè¯»æ£€æŸ¥ï¼Œä¸èƒ½ä¿®æ”¹

å…¸å‹æ“ä½œï¼š  
â€¢ æ£€æŸ¥èµ„æºé…é¢
â€¢ éªŒè¯å®‰å…¨ç­–ç•¥
â€¢ æ£€æŸ¥å‘½åè§„èŒƒ
â€¢ éªŒè¯ç½‘ç»œç­–ç•¥
â€¢ ç¡®ä¿æ ‡ç­¾å®Œæ•´æ€§
```

### 2.3 å‡†å…¥æ§åˆ¶å†³ç­–


**ğŸ“Š å†³ç­–é€»è¾‘**

```
æ¯ä¸ªå‡†å…¥æ§åˆ¶å™¨çš„å†³ç­–ï¼š

âœ… ALLOW (å…è®¸)ï¼š
   â””â”€ ç»§ç»­ä¸‹ä¸€ä¸ªæ§åˆ¶å™¨

âŒ DENY (æ‹’ç»)ï¼š  
   â””â”€ ç«‹å³ç»ˆæ­¢è¯·æ±‚ï¼Œè¿”å›é”™è¯¯

ğŸ”„ MODIFY (ä¿®æ”¹)ï¼š
   â””â”€ ä¿®æ”¹å¯¹è±¡åç»§ç»­
```

**âš ï¸ é‡è¦è§„åˆ™**
> ğŸ’¡ **å…³é”®ç†è§£**ï¼šåªè¦æœ‰**ä»»ä½•ä¸€ä¸ª**å‡†å…¥æ§åˆ¶å™¨æ‹’ç»äº†è¯·æ±‚ï¼Œæ•´ä¸ªè¯·æ±‚å°±ä¼šè¢«æ‹’ç»ï¼Œå‰é¢æ‰€æœ‰çš„ä¿®æ”¹éƒ½ä¼šè¢«ä¸¢å¼ƒï¼

---

## 3. ğŸ”§ å†…ç½®å‡†å…¥æ§åˆ¶å™¨è¯¦è§£


### 3.1 æ ¸å¿ƒå†…ç½®æ§åˆ¶å™¨


**ğŸ“‹ å¸¸ç”¨å†…ç½®å‡†å…¥æ§åˆ¶å™¨**

| æ§åˆ¶å™¨åç§° | **ç±»å‹** | **ä¸»è¦åŠŸèƒ½** | **ä½¿ç”¨åœºæ™¯** |
|-----------|---------|-------------|-------------|
| `NamespaceLifecycle` | `Validating` | `é˜²æ­¢åœ¨ç»ˆæ­¢ä¸­çš„å‘½åç©ºé—´åˆ›å»ºèµ„æº` | `åŸºç¡€å®‰å…¨` |
| `LimitRanger` | `Validating` | `å¼ºåˆ¶æ‰§è¡Œèµ„æºé™åˆ¶` | `èµ„æºç®¡ç†` |
| `ServiceAccount` | `Mutating` | `è‡ªåŠ¨åˆ†é…ServiceAccount` | `èº«ä»½è®¤è¯` |
| `DefaultStorageClass` | `Mutating` | `ä¸ºPVCåˆ†é…é»˜è®¤å­˜å‚¨ç±»` | `å­˜å‚¨ç®¡ç†` |
| `ResourceQuota` | `Validating` | `å¼ºåˆ¶æ‰§è¡Œèµ„æºé…é¢` | `èµ„æºæ§åˆ¶` |
| `PodSecurityPolicy` | `Validating` | `æ‰§è¡ŒPodå®‰å…¨ç­–ç•¥` | `å®‰å…¨åˆè§„` |

### 3.2 é‡ç‚¹æ§åˆ¶å™¨è¯¦è§£


**ğŸ”’ NamespaceLifecycleæ§åˆ¶å™¨**

```yaml
# è¿™ä¸ªæ§åˆ¶å™¨ä¼šé˜»æ­¢è¿™ç§å±é™©æ“ä½œ
apiVersion: v1
kind: Pod
metadata:
  name: test-pod
  namespace: terminating-namespace  # âŒ å‘½åç©ºé—´æ­£åœ¨åˆ é™¤ä¸­
spec:
  containers:
  - name: test
    image: nginx
```

**ğŸ’¡ å·¥ä½œåŸç†**
- **æ£€æŸ¥å‘½åç©ºé—´çŠ¶æ€**ï¼šç¡®ä¿ç›®æ ‡å‘½åç©ºé—´å­˜åœ¨ä¸”å¤„äºæ´»è·ƒçŠ¶æ€
- **é˜»æ­¢å±é™©æ“ä½œ**ï¼šé˜²æ­¢åœ¨åˆ é™¤ä¸­çš„å‘½åç©ºé—´åˆ›å»ºæ–°èµ„æº
- **ä¿æŠ¤ç³»ç»Ÿå‘½åç©ºé—´**ï¼šé˜»æ­¢åˆ é™¤kube-systemç­‰å…³é”®å‘½åç©ºé—´

**ğŸ’¾ LimitRangeræ§åˆ¶å™¨**

```yaml
# LimitRangeå®šä¹‰
apiVersion: v1
kind: LimitRange
metadata:
  name: pod-limit-range
spec:
  limits:
  - default:
      cpu: "1"        # é»˜è®¤CPUé™åˆ¶
      memory: "512Mi"  # é»˜è®¤å†…å­˜é™åˆ¶
    defaultRequest:
      cpu: "100m"     # é»˜è®¤CPUè¯·æ±‚
      memory: "128Mi"  # é»˜è®¤å†…å­˜è¯·æ±‚
    type: Container
```

**ğŸ¯ è‡ªåŠ¨ç”Ÿæ•ˆ**
å½“ä½ åˆ›å»ºPodæ—¶ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šèµ„æºé™åˆ¶ï¼ŒLimitRangerä¼š**è‡ªåŠ¨æ·»åŠ **ä¸Šé¢å®šä¹‰çš„é»˜è®¤å€¼ã€‚

### 3.3 æŸ¥çœ‹å¯ç”¨çš„å‡†å…¥æ§åˆ¶å™¨


```bash
# æŸ¥çœ‹API Serverå¯ç”¨çš„å‡†å…¥æ§åˆ¶å™¨
kubectl exec -n kube-system kube-apiserver-master -it -- \
  kube-apiserver --help | grep enable-admission-plugins
```

**ğŸ“‹ å…¸å‹è¾“å‡ºç¤ºä¾‹**
```
--enable-admission-plugins strings
Default: CertificateApproval,CertificateSigningRequestApproval,
DefaultStorageClass,DefaultTolerationSeconds,LimitRanger,
MutatingAdmissionWebhook,NamespaceLifecycle,PersistentVolumeLabel,
PodSecurityPolicy,Priority,ResourceQuota,ServiceAccount,
StorageObjectInUseProtection,TaintNodesByCondition,
ValidatingAdmissionWebhook
```

---

## 4. ğŸ”„ Mutating Webhookå˜æ›´å‡†å…¥


### 4.1 ä»€ä¹ˆæ˜¯Mutating Webhook


**ğŸ”¸ é€šä¿—ç†è§£**
æŠŠMutating Webhookæƒ³è±¡æˆä¸€ä¸ª**è‡ªåŠ¨åŒ–çš„åŠ©æ‰‹**ã€‚å½“æœ‰æ–°çš„èµ„æºè¦éƒ¨ç½²åˆ°é›†ç¾¤æ—¶ï¼Œè¿™ä¸ªåŠ©æ‰‹ä¼šè¯´ï¼š"è®©æˆ‘å…ˆå¸®ä½ å®Œå–„ä¸€ä¸‹è¿™ä¸ªé…ç½®"ï¼Œç„¶åè‡ªåŠ¨æ·»åŠ ä¸€äº›å¿…è¦çš„è®¾ç½®ã€‚

```
ç”¨æˆ·æäº¤çš„Podï¼š
apiVersion: v1
kind: Pod  
metadata:
  name: my-app
spec:
  containers:
  - name: app
    image: nginx

ç»è¿‡Mutating Webhookåï¼š
apiVersion: v1
kind: Pod
metadata:
  name: my-app
  labels:
    app: my-app           # â† è‡ªåŠ¨æ·»åŠ 
    version: "1.0"        # â† è‡ªåŠ¨æ·»åŠ 
spec:
  containers:
  - name: app
    image: nginx
  - name: sidecar         # â† è‡ªåŠ¨æ³¨å…¥
    image: istio/proxy    # â† è‡ªåŠ¨æ³¨å…¥
```

### 4.2 å…¸å‹ä½¿ç”¨åœºæ™¯


**ğŸ¯ å®é™…åº”ç”¨åœºæ™¯**

```
æœåŠ¡ç½‘æ ¼æ³¨å…¥ï¼š
åŸå§‹Pod â†’ Webhook â†’ æ³¨å…¥Istio Sidecar â†’ æœ€ç»ˆPod

é…ç½®æ ‡å‡†åŒ–ï¼š
åŸå§‹é…ç½® â†’ Webhook â†’ æ·»åŠ æ ‡å‡†æ ‡ç­¾ â†’ è§„èŒƒé…ç½®

å®‰å…¨åŠ å›ºï¼š
ç”¨æˆ·Pod â†’ Webhook â†’ æ·»åŠ å®‰å…¨ä¸Šä¸‹æ–‡ â†’ å®‰å…¨Pod

èµ„æºä¼˜åŒ–ï¼š
åŸºç¡€é…ç½® â†’ Webhook â†’ æ·»åŠ èµ„æºé™åˆ¶ â†’ ä¼˜åŒ–é…ç½®
```

### 4.3 åˆ›å»ºMutating Webhook


**ğŸ“ WebhookæœåŠ¡ç¤ºä¾‹**

```yaml
# mutating-webhook-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: webhook-service
  namespace: webhook-system
spec:
  selector:
    app: mutating-webhook
  ports:
  - port: 443
    targetPort: 8443
    protocol: TCP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mutating-webhook
  namespace: webhook-system
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mutating-webhook
  template:
    metadata:
      labels:
        app: mutating-webhook
    spec:
      containers:
      - name: webhook
        image: webhook-server:latest
        ports:
        - containerPort: 8443
        volumeMounts:
        - name: certs
          mountPath: /etc/certs
          readOnly: true
      volumes:
      - name: certs
        secret:
          secretName: webhook-certs
```

### 4.4 é…ç½®Mutating Webhook


**ğŸ”§ MutatingAdmissionWebhooké…ç½®**

```yaml
apiVersion: admissionregistration.k8s.io/v1
kind: MutatingAdmissionWebhook
metadata:
  name: pod-labeler.example.com
webhooks:
- name: pod-labeler.example.com
  clientConfig:
    service:
      name: webhook-service
      namespace: webhook-system
      path: "/mutate"
  rules:
  - operations: ["CREATE"]
    apiGroups: [""]
    apiVersions: ["v1"]
    resources: ["pods"]
  admissionReviewVersions: ["v1", "v1beta1"]
```

**ğŸ’¡ é…ç½®è¯´æ˜**
- **clientConfig**ï¼šæŒ‡å®šWebhookæœåŠ¡çš„ä½ç½®
- **rules**ï¼šå®šä¹‰ä»€ä¹ˆæ—¶å€™è§¦å‘Webhook
- **operations**ï¼šç›‘å¬çš„æ“ä½œç±»å‹ï¼ˆCREATEã€UPDATEã€DELETEï¼‰

---

## 5. âœ… Validating WebhookéªŒè¯å‡†å…¥


### 5.1 ä»€ä¹ˆæ˜¯Validating Webhook


**ğŸ”¸ é€šä¿—ç†è§£**  
å¦‚æœè¯´Mutating Webhookæ˜¯"åŠ©æ‰‹"ï¼Œé‚£ä¹ˆValidating Webhookå°±æ˜¯"æ£€æŸ¥å‘˜"ã€‚å®ƒçš„å·¥ä½œæ˜¯**ä¸¥æ ¼æ£€æŸ¥**èµ„æºé…ç½®ï¼Œç¡®ä¿ä¸€åˆ‡éƒ½ç¬¦åˆå…¬å¸æˆ–ç»„ç»‡çš„å®‰å…¨å’Œç®¡ç†è¦æ±‚ã€‚

```
æ£€æŸ¥å‘˜çš„å·¥ä½œæµç¨‹ï¼š

ç”¨æˆ·æäº¤èµ„æº
    â†“
æ£€æŸ¥é•œåƒå®‰å…¨æ€§ âœ“
æ£€æŸ¥èµ„æºé™åˆ¶ âœ“  
æ£€æŸ¥æ ‡ç­¾è§„èŒƒ âœ“
æ£€æŸ¥ç½‘ç»œç­–ç•¥ âœ— â† å‘ç°é—®é¢˜ï¼
    â†“
æ‹’ç»è¯·æ±‚ï¼š"é•œåƒæ¥æºä¸å®‰å…¨ï¼Œè¯·ä½¿ç”¨å†…éƒ¨é•œåƒä»“åº“"
```

### 5.2 å¸¸è§éªŒè¯åœºæ™¯


**ğŸ›¡ï¸ å®‰å…¨éªŒè¯**
```yaml
# âŒ è¿™ç§é…ç½®ä¼šè¢«æ‹’ç»
apiVersion: v1
kind: Pod
metadata:
  name: insecure-pod
spec:
  containers:
  - name: app
    image: docker.io/untrusted/app:latest  # ä¸å®‰å…¨çš„é•œåƒæº
    securityContext:
      runAsUser: 0                         # ä¸èƒ½ä»¥rootè¿è¡Œ
      privileged: true                     # ä¸èƒ½ä½¿ç”¨ç‰¹æƒæ¨¡å¼
```

**ğŸ“ åˆè§„éªŒè¯**
```yaml
# âœ… è¿™ç§é…ç½®ä¼šé€šè¿‡éªŒè¯  
apiVersion: v1
kind: Pod
metadata:
  name: secure-pod
  labels:
    app: my-app          # å¿…éœ€çš„æ ‡ç­¾
    environment: prod    # ç¯å¢ƒæ ‡ç­¾
    team: backend        # å›¢é˜Ÿæ ‡ç­¾
spec:
  containers:
  - name: app
    image: internal-registry.com/my-app:v1.0  # å†…éƒ¨é•œåƒ
    securityContext:
      runAsUser: 1000                         # érootç”¨æˆ·
      runAsNonRoot: true                      # å¼ºåˆ¶éroot
    resources:
      limits:
        cpu: "500m"                           # å¿…é¡»è®¾ç½®é™åˆ¶
        memory: "512Mi"
```

### 5.3 åˆ›å»ºValidating Webhook


**ğŸ”§ ValidatingAdmissionWebhooké…ç½®**

```yaml
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingAdmissionWebhook
metadata:
  name: security-policy.example.com
webhooks:
- name: security-policy.example.com
  clientConfig:
    service:
      name: webhook-service
      namespace: webhook-system
      path: "/validate"
  rules:
  - operations: ["CREATE", "UPDATE"]
    apiGroups: [""]
    apiVersions: ["v1"] 
    resources: ["pods"]
  failurePolicy: Fail  # é‡è¦ï¼šWebhookå¤±è´¥æ—¶æ‹’ç»è¯·æ±‚
  admissionReviewVersions: ["v1", "v1beta1"]
```

### 5.4 Webhookå“åº”æ ¼å¼


**ğŸ“‹ æ ‡å‡†å“åº”æ ¼å¼**

```json
{
  "apiVersion": "admission.k8s.io/v1",
  "kind": "AdmissionReview",
  "response": {
    "uid": "è¯·æ±‚çš„å”¯ä¸€æ ‡è¯†ç¬¦",
    "allowed": false,
    "status": {
      "code": 403,
      "message": "Podä½¿ç”¨äº†ä¸å®‰å…¨çš„é•œåƒæºã€‚è¯·ä½¿ç”¨internal-registry.comçš„é•œåƒã€‚"
    }
  }
}
```

---

## 6. ğŸ”— å‡†å…¥æ§åˆ¶é“¾é…ç½®


### 6.1 å‡†å…¥æ§åˆ¶é“¾æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯å‡†å…¥æ§åˆ¶é“¾**
å‡†å…¥æ§åˆ¶é“¾å°±åƒå·¥å‚çš„**æµæ°´çº¿**ï¼Œæ¯ä¸ªå·¥ç«™ï¼ˆå‡†å…¥æ§åˆ¶å™¨ï¼‰è´Ÿè´£ä¸åŒçš„å¤„ç†ä»»åŠ¡ã€‚èµ„æºè¯·æ±‚å¿…é¡»**é¡ºåºé€šè¿‡**æ‰€æœ‰å·¥ç«™çš„æ£€æŸ¥ã€‚

```
å‡†å…¥æ§åˆ¶é“¾æ‰§è¡Œé¡ºåºï¼š

è¯·æ±‚è¿›å…¥
    â†“
ã€ç¬¬1é˜¶æ®µï¼šå˜æ›´æ§åˆ¶å™¨ã€‘
å†…ç½®Mutatingæ§åˆ¶å™¨1 â†’ å†…ç½®Mutatingæ§åˆ¶å™¨2 â†’ ... â†’ Mutating Webhooks
    â†“
ã€ç¬¬2é˜¶æ®µï¼šéªŒè¯æ§åˆ¶å™¨ã€‘  
å†…ç½®Validatingæ§åˆ¶å™¨1 â†’ å†…ç½®Validatingæ§åˆ¶å™¨2 â†’ ... â†’ Validating Webhooks
    â†“
ã€ç»“æœã€‘
âœ… å…¨éƒ¨é€šè¿‡ â†’ å­˜å‚¨åˆ°etcd
âŒ ä»»ä¸€æ‹’ç» â†’ è¿”å›é”™è¯¯
```

### 6.2 é…ç½®å‡†å…¥æ§åˆ¶å™¨


**âš™ï¸ API Serverå¯åŠ¨å‚æ•°**

```bash
# åœ¨kube-apiserverå¯åŠ¨å‚æ•°ä¸­é…ç½®
kube-apiserver \
  --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,MutatingAdmissionWebhook,ValidatingAdmissionWebhook \
  --disable-admission-plugins=AlwaysPullImages \
  --admission-control-config-file=/etc/kubernetes/admission-control.yaml
```

**ğŸ“ å‡†å…¥æ§åˆ¶é…ç½®æ–‡ä»¶ç¤ºä¾‹**

```yaml
# admission-control.yaml
apiVersion: apiserver.config.k8s.io/v1
kind: AdmissionConfiguration
plugins:
- name: ResourceQuota
  configuration:
    apiVersion: resourcequota.admission.k8s.io/v1beta1
    kind: Configuration
    limitedResources:
    - resource: pods
    - resource: persistentvolumeclaims
- name: LimitRanger
  configuration:
    apiVersion: limitranger.admission.k8s.io/v1beta1  
    kind: Configuration
```

### 6.3 æ§åˆ¶å™¨æ‰§è¡Œé¡ºåºçš„é‡è¦æ€§


**âš ï¸ é¡ºåºå½±å“ç»“æœ**

```
é”™è¯¯çš„é¡ºåºï¼š
éªŒè¯æ§åˆ¶å™¨ â†’ å˜æ›´æ§åˆ¶å™¨
     â†“           â†“
   æ£€æŸ¥èµ„æº   â†’  æ·»åŠ èµ„æºé™åˆ¶
   (å¯èƒ½å¤±è´¥)    (æ£€æŸ¥å·²å®Œæˆ)

æ­£ç¡®çš„é¡ºåºï¼š  
å˜æ›´æ§åˆ¶å™¨ â†’ éªŒè¯æ§åˆ¶å™¨
     â†“           â†“
  æ·»åŠ èµ„æºé™åˆ¶ â†’  æ£€æŸ¥èµ„æº
  (å…ˆå®Œå–„)      (åéªŒè¯)
```

**ğŸ’¡ æœ€ä½³å®è·µ**
> å§‹ç»ˆç¡®ä¿**Mutatingåœ¨å‰ï¼ŒValidatingåœ¨å**ï¼Œè¿™æ ·éªŒè¯æ§åˆ¶å™¨æ£€æŸ¥çš„æ˜¯å®Œæ•´ã€ä¿®æ”¹åçš„èµ„æºå¯¹è±¡ã€‚

---

## 7. âš™ï¸ Webhooké…ç½®ç®¡ç†


### 7.1 Webhooké…ç½®è¦ç´ 


**ğŸ”§ å…³é”®é…ç½®é¡¹è§£æ**

```yaml
apiVersion: admissionregistration.k8s.io/v1
kind: MutatingAdmissionWebhook  # æˆ– ValidatingAdmissionWebhook
metadata:
  name: my-webhook.example.com
webhooks:
- name: my-webhook.example.com
  clientConfig:               # WebhookæœåŠ¡é…ç½®
    service:
      name: webhook-service   # æœåŠ¡åç§°
      namespace: webhook-ns   # æœåŠ¡å‘½åç©ºé—´  
      path: "/webhook"        # è¯·æ±‚è·¯å¾„
    # æˆ–è€…ä½¿ç”¨å¤–éƒ¨URL
    # url: https://external-webhook.example.com/webhook
  rules:                      # è§¦å‘è§„åˆ™
  - operations: ["CREATE", "UPDATE"]
    apiGroups: ["apps"]
    apiVersions: ["v1"]
    resources: ["deployments"]
  failurePolicy: Fail         # å¤±è´¥ç­–ç•¥
  timeoutSeconds: 10          # è¶…æ—¶æ—¶é—´
  admissionReviewVersions: ["v1", "v1beta1"]
```

### 7.2 è§„åˆ™é…ç½®è¯¦è§£


**ğŸ“‹ Rulesè§„åˆ™é…ç½®**

| å­—æ®µ | **è¯´æ˜** | **ç¤ºä¾‹** |
|------|---------|---------|
| `operations` | `è§¦å‘æ“ä½œç±»å‹` | `["CREATE", "UPDATE", "DELETE"]` |
| `apiGroups` | `APIç»„` | `["", "apps", "extensions"]` |
| `apiVersions` | `APIç‰ˆæœ¬` | `["v1", "v1beta1"]` |
| `resources` | `èµ„æºç±»å‹` | `["pods", "deployments", "services"]` |
| `scope` | `ä½œç”¨åŸŸ` | `"Cluster"` æˆ– `"Namespaced"` |

**ğŸ¯ è§„åˆ™åŒ¹é…ç¤ºä¾‹**

```yaml
# ç›‘å¬æ‰€æœ‰Podçš„åˆ›å»ºå’Œæ›´æ–°
rules:
- operations: ["CREATE", "UPDATE"]
  apiGroups: [""]
  apiVersions: ["v1"]
  resources: ["pods"]

# ç›‘å¬ç‰¹å®šå‘½åç©ºé—´çš„Deployment
rules:
- operations: ["CREATE"]
  apiGroups: ["apps"]
  apiVersions: ["v1"]
  resources: ["deployments"]
  namespaceSelector:
    matchLabels:
      webhook: "enabled"
```

### 7.3 æ•…éšœå¤„ç†ç­–ç•¥


**âš ï¸ failurePolicyé…ç½®**

```yaml
# Failç­–ç•¥ï¼šWebhookå¤±è´¥æ—¶æ‹’ç»è¯·æ±‚ï¼ˆæ¨èç”¨äºå®‰å…¨éªŒè¯ï¼‰
failurePolicy: Fail

# Ignoreç­–ç•¥ï¼šWebhookå¤±è´¥æ—¶å…è®¸è¯·æ±‚ï¼ˆç”¨äºéå…³é”®åŠŸèƒ½ï¼‰  
failurePolicy: Ignore
```

**ğŸ’¡ é€‰æ‹©å»ºè®®**
- **å®‰å…¨ç›¸å…³çš„Webhook**ï¼šä½¿ç”¨`Fail`ç­–ç•¥ï¼Œç¡®ä¿å®‰å…¨æ£€æŸ¥ä¸èƒ½è¢«ç»•è¿‡
- **åŠŸèƒ½å¢å¼ºçš„Webhook**ï¼šä½¿ç”¨`Ignore`ç­–ç•¥ï¼Œé¿å…å½±å“ä¸šåŠ¡è¿ç»­æ€§

### 7.4 è¯ä¹¦ç®¡ç†


**ğŸ” TLSè¯ä¹¦é…ç½®**

```yaml
# åˆ›å»ºè‡ªç­¾åè¯ä¹¦çš„ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: webhook-ca
data:
  ca.crt: |
    -----BEGIN CERTIFICATE-----
    MIICljCCAX4CCQDQw...
    -----END CERTIFICATE-----
---
apiVersion: admissionregistration.k8s.io/v1
kind: MutatingAdmissionWebhook
metadata:
  name: my-webhook
webhooks:
- name: my-webhook
  clientConfig:
    service:
      name: webhook-service
      namespace: webhook-system
      path: "/mutate"
    caBundle: LS0tLS1CRUdJTi... # Base64ç¼–ç çš„CAè¯ä¹¦
```

---

## 8. ğŸ› ï¸ å®æˆ˜æ“ä½œæŒ‡å—


### 8.1 éƒ¨ç½²ç®€å•çš„æ ‡ç­¾æ³¨å…¥Webhook


**ğŸ¯ å®æˆ˜ç›®æ ‡**ï¼šåˆ›å»ºä¸€ä¸ªWebhookï¼Œè‡ªåŠ¨ä¸ºæ‰€æœ‰Podæ·»åŠ ç¯å¢ƒæ ‡ç­¾ã€‚

**æ­¥éª¤1ï¼šåˆ›å»ºWebhookæœåŠ¡**

```bash
# åˆ›å»ºå‘½åç©ºé—´
kubectl create namespace webhook-system

# ç”Ÿæˆè¯ä¹¦ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
openssl req -new -newkey rsa:2048 -days 365 -nodes -x509 \
    -subj "/C=US/ST=CA/L=San Francisco/O=Example/CN=webhook-service.webhook-system.svc" \
    -keyout webhook.key -out webhook.crt
```

**æ­¥éª¤2ï¼šåˆ›å»ºWebhookåº”ç”¨**

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pod-labeler-webhook
  namespace: webhook-system
spec:
  replicas: 1
  selector:
    matchLabels:
      app: pod-labeler-webhook
  template:
    metadata:
      labels:
        app: pod-labeler-webhook
    spec:
      containers:
      - name: webhook
        image: simple-webhook:latest
        ports:
        - containerPort: 8443
        env:
        - name: TLS_CERT_FILE
          value: "/etc/certs/tls.crt"
        - name: TLS_PRIVATE_KEY_FILE
          value: "/etc/certs/tls.key"
        volumeMounts:
        - name: certs
          mountPath: /etc/certs
          readOnly: true
      volumes:
      - name: certs
        secret:
          secretName: webhook-certs
```

**æ­¥éª¤3ï¼šé…ç½®MutatingAdmissionWebhook**

```yaml
apiVersion: admissionregistration.k8s.io/v1
kind: MutatingAdmissionWebhook
metadata:
  name: pod-labeler.example.com
webhooks:
- name: pod-labeler.example.com
  clientConfig:
    service:
      name: webhook-service
      namespace: webhook-system
      path: "/mutate"
  rules:
  - operations: ["CREATE"]
    apiGroups: [""]
    apiVersions: ["v1"]
    resources: ["pods"]
  failurePolicy: Fail
  admissionReviewVersions: ["v1"]
```

### 8.2 æµ‹è¯•WebhookåŠŸèƒ½


**ğŸ§ª åˆ›å»ºæµ‹è¯•Pod**

```yaml
# test-pod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: test-pod
spec:
  containers:
  - name: nginx
    image: nginx:latest
```

```bash
# åº”ç”¨æµ‹è¯•Pod
kubectl apply -f test-pod.yaml

# æ£€æŸ¥æ˜¯å¦è‡ªåŠ¨æ·»åŠ äº†æ ‡ç­¾
kubectl get pod test-pod -o yaml
```

**âœ… é¢„æœŸç»“æœ**
```yaml
apiVersion: v1
kind: Pod  
metadata:
  name: test-pod
  labels:
    environment: "production"    # â† Webhookè‡ªåŠ¨æ·»åŠ 
    managed-by: "webhook"        # â† Webhookè‡ªåŠ¨æ·»åŠ 
spec:
  containers:
  - name: nginx
    image: nginx:latest
```

### 8.3 æ•…éšœæ’æŸ¥


**ğŸ” å¸¸è§é—®é¢˜è¯Šæ–­**

```bash
# æ£€æŸ¥Webhooké…ç½®çŠ¶æ€
kubectl get mutatingadmissionwebhooks
kubectl describe mutatingadmissionwebhook pod-labeler.example.com

# æ£€æŸ¥WebhookæœåŠ¡çŠ¶æ€  
kubectl get pods -n webhook-system
kubectl logs -n webhook-system deployment/pod-labeler-webhook

# æ£€æŸ¥API Serveræ—¥å¿—
kubectl logs -n kube-system kube-apiserver-master
```

**âš ï¸ å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ**

| é”™è¯¯ä¿¡æ¯ | **åŸå› ** | **è§£å†³æ–¹æ¡ˆ** |
|---------|---------|-------------|
| `connection refused` | `WebhookæœåŠ¡æœªè¿è¡Œ` | `æ£€æŸ¥PodçŠ¶æ€å’Œç«¯å£é…ç½®` |
| `certificate verify failed` | `è¯ä¹¦é—®é¢˜` | `é‡æ–°ç”Ÿæˆè¯ä¹¦æˆ–æ£€æŸ¥caBundle` |
| `timeout waiting for response` | `å“åº”è¶…æ—¶` | `æ£€æŸ¥ç½‘ç»œè¿é€šæ€§å’ŒæœåŠ¡æ€§èƒ½` |

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ”¸ å‡†å…¥æ§åˆ¶å™¨ï¼šAPIè¯·æ±‚è¿›å…¥etcdå‰çš„æœ€åä¸€é“æ£€æŸ¥å…³å¡
ğŸ”¸ ä¸¤å¤§ç±»å‹ï¼šMutating(ä¿®æ”¹) + Validating(éªŒè¯)
ğŸ”¸ æ‰§è¡Œé¡ºåºï¼šè®¤è¯ â†’ æˆæƒ â†’ Mutating â†’ Validating â†’ å­˜å‚¨
ğŸ”¸ å†³ç­–æœºåˆ¶ï¼šä»»ä¸€æ‹’ç»åˆ™æ•´ä½“æ‹’ç»ï¼Œå…¨éƒ¨é€šè¿‡æ‰æˆåŠŸ
ğŸ”¸ å†…ç½®æ§åˆ¶å™¨ï¼šæä¾›åŸºç¡€çš„å®‰å…¨å’Œç®¡ç†åŠŸèƒ½
ğŸ”¸ Webhookæœºåˆ¶ï¼šè‡ªå®šä¹‰çš„å‡†å…¥æ§åˆ¶é€»è¾‘
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å‡†å…¥æ§åˆ¶çš„ä»·å€¼**
```
å®‰å…¨ä»·å€¼ï¼š
â€¢ é˜²æ­¢ä¸å®‰å…¨é…ç½®è¿›å…¥é›†ç¾¤
â€¢ å¼ºåˆ¶æ‰§è¡Œå®‰å…¨ç­–ç•¥å’Œåˆè§„è¦æ±‚
â€¢ è‡ªåŠ¨åŒ–å®‰å…¨æ£€æŸ¥ï¼Œå‡å°‘äººå·¥é”™è¯¯

ç®¡ç†ä»·å€¼ï¼š
â€¢ è‡ªåŠ¨æ ‡å‡†åŒ–èµ„æºé…ç½®
â€¢ å¼ºåˆ¶èµ„æºé…é¢å’Œé™åˆ¶
â€¢ ç®€åŒ–å¼€å‘è€…çš„é…ç½®å·¥ä½œ
```

**ğŸ”¹ Mutating vs Validating**
```
Mutating Webhookï¼š
â€¢ æ—¶æœºï¼šå‡†å…¥æ§åˆ¶çš„ç¬¬ä¸€é˜¶æ®µ
â€¢ ä½œç”¨ï¼šä¿®æ”¹å’Œå®Œå–„èµ„æºå¯¹è±¡
â€¢ åœºæ™¯ï¼šæ³¨å…¥é…ç½®ã€æ·»åŠ æ ‡ç­¾ã€æ ‡å‡†åŒ–

Validating Webhookï¼š  
â€¢ æ—¶æœºï¼šå‡†å…¥æ§åˆ¶çš„ç¬¬äºŒé˜¶æ®µ
â€¢ ä½œç”¨ï¼šéªŒè¯èµ„æºå¯¹è±¡çš„åˆæ³•æ€§
â€¢ åœºæ™¯ï¼šå®‰å…¨æ£€æŸ¥ã€åˆè§„éªŒè¯ã€ç­–ç•¥æ‰§è¡Œ
```

**ğŸ”¹ é…ç½®ç®¡ç†è¦ç‚¹**
```
è§„åˆ™é…ç½®ï¼š
â€¢ operationsï¼šå®šä¹‰è§¦å‘çš„æ“ä½œç±»å‹
â€¢ resourcesï¼šæŒ‡å®šç›‘å¬çš„èµ„æºç±»å‹
â€¢ namespaceSelectorï¼šæ§åˆ¶ä½œç”¨åŸŸ

æ•…éšœå¤„ç†ï¼š
â€¢ Failç­–ç•¥ï¼šå®‰å…¨ç¬¬ä¸€ï¼Œæ‹’ç»è¯·æ±‚
â€¢ Ignoreç­–ç•¥ï¼šå¯ç”¨æ€§ç¬¬ä¸€ï¼Œå…è®¸è¯·æ±‚
â€¢ è¶…æ—¶é…ç½®ï¼šå¹³è¡¡å®‰å…¨å’Œæ€§èƒ½
```

### 9.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¼ä¸šçº§åº”ç”¨åœºæ™¯**
- **å®‰å…¨åˆè§„**ï¼šè‡ªåŠ¨æ£€æŸ¥é•œåƒå®‰å…¨ã€è¿è¡Œæƒé™ã€ç½‘ç»œç­–ç•¥
- **æˆæœ¬æ§åˆ¶**ï¼šå¼ºåˆ¶èµ„æºé™åˆ¶ã€é˜²æ­¢èµ„æºæ»¥ç”¨
- **æ ‡å‡†åŒ–ç®¡ç†**ï¼šè‡ªåŠ¨æ·»åŠ æ ‡ç­¾ã€æ³¨å…¥é…ç½®ã€ç»Ÿä¸€è§„èŒƒ
- **æœåŠ¡ç½‘æ ¼**ï¼šè‡ªåŠ¨æ³¨å…¥Sidecarä»£ç†ã€é…ç½®æµé‡ç®¡ç†

**ğŸ”§ è¿ç»´å®è·µå»ºè®®**
- **æ¸è¿›éƒ¨ç½²**ï¼šå…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯WebhookåŠŸèƒ½
- **ç›‘æ§å‘Šè­¦**ï¼šç›‘æ§Webhookçš„å¯ç”¨æ€§å’Œå“åº”æ—¶é—´
- **å¤‡ä»½ç­–ç•¥**ï¼šé‡è¦çš„Webhookéœ€è¦é«˜å¯ç”¨éƒ¨ç½²
- **æ–‡æ¡£è®°å½•**ï¼šè¯¦ç»†è®°å½•æ¯ä¸ªWebhookçš„åŠŸèƒ½å’Œé…ç½®

### 9.4 å­¦ä¹ è·¯å¾„å»ºè®®


```
åˆçº§é˜¶æ®µï¼š
âœ“ ç†è§£å‡†å…¥æ§åˆ¶åœ¨APIè¯·æ±‚æµç¨‹ä¸­çš„ä½ç½®
âœ“ æŒæ¡å¸¸è§å†…ç½®å‡†å…¥æ§åˆ¶å™¨çš„åŠŸèƒ½
âœ“ å­¦ä¼šæŸ¥çœ‹å’Œé…ç½®å¯ç”¨çš„å‡†å…¥æ§åˆ¶å™¨

ä¸­çº§é˜¶æ®µï¼š  
âœ“ åˆ›å»ºç®€å•çš„Mutatingå’ŒValidating Webhook
âœ“ ç†è§£Webhookçš„é…ç½®å’Œæ•…éšœå¤„ç†
âœ“ æŒæ¡è¯ä¹¦ç®¡ç†å’Œå®‰å…¨é…ç½®

é«˜çº§é˜¶æ®µï¼š
âœ“ è®¾è®¡å¤æ‚çš„å‡†å…¥æ§åˆ¶ç­–ç•¥
âœ“ å®ç°é«˜å¯ç”¨çš„WebhookæœåŠ¡
âœ“ ä¸å…¶ä»–K8sç»„ä»¶é›†æˆï¼ˆå¦‚OPAã€Istioï¼‰
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- å‡†å…¥æ§åˆ¶æ˜¯K8så®‰å…¨å’Œç®¡ç†çš„**æœ€åä¸€é“é˜²çº¿**
- **Mutatingå…ˆä¿®æ”¹ï¼ŒValidatingåéªŒè¯**ï¼Œé¡ºåºä¸èƒ½é¢ å€’
- Webhookè®©å‡†å…¥æ§åˆ¶**å¯æ‰©å±•å¯å®šåˆ¶**ï¼Œæ»¡è¶³ä¼ä¸šç‰¹å®šéœ€æ±‚
- **å®‰å…¨ä¼˜å…ˆ**çš„åŸåˆ™ï¼šå…³é”®Webhookä½¿ç”¨Failç­–ç•¥