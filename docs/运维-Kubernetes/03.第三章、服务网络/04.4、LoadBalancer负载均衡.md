---
title: 4ã€LoadBalancerè´Ÿè½½å‡è¡¡
---
## ðŸ“š ç›®å½•

1. [LoadBalanceråŸºæœ¬æ¦‚å¿µ](#1-LoadBalanceråŸºæœ¬æ¦‚å¿µ)
2. [äº‘åŽ‚å•†é›†æˆåŽŸç†](#2-äº‘åŽ‚å•†é›†æˆåŽŸç†)
3. [å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨é…ç½®](#3-å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨é…ç½®)
4. [IPåœ°å€åˆ†é…æœºåˆ¶](#4-IPåœ°å€åˆ†é…æœºåˆ¶)
5. [å¥åº·æ£€æŸ¥é…ç½®è¯¦è§£](#5-å¥åº·æ£€æŸ¥é…ç½®è¯¦è§£)
6. [æˆæœ¬ä¼˜åŒ–ç­–ç•¥](#6-æˆæœ¬ä¼˜åŒ–ç­–ç•¥)
7. [é«˜å¯ç”¨éƒ¨ç½²å®žè·µ](#7-é«˜å¯ç”¨éƒ¨ç½²å®žè·µ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ðŸŒ LoadBalanceråŸºæœ¬æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯LoadBalancer


**ç®€å•ç†è§£**ï¼šLoadBalancerå°±åƒæ˜¯ä½ å®¶å°åŒºé—¨å£çš„ä¿å®‰ï¼Œè´Ÿè´£æŠŠå¤–é¢æ¥è®¿çš„å®¢äººï¼ˆç”¨æˆ·è¯·æ±‚ï¼‰åˆç†åˆ†é…åˆ°ä¸åŒçš„ä½æˆ·å®¶é‡Œï¼ˆPodï¼‰ã€‚

```
ä¼ ç»Ÿæ–¹å¼è®¿é—®åº”ç”¨ï¼š
ç”¨æˆ· â†’ ç›´æŽ¥è®¿é—®æŸå°æœåŠ¡å™¨IP â†’ åº”ç”¨

LoadBalanceræ–¹å¼ï¼š
ç”¨æˆ· â†’ LoadBalancerå¤–éƒ¨IP â†’ æ™ºèƒ½åˆ†é… â†’ å¤šä¸ªPod
```

**æ ¸å¿ƒä½œç”¨**ï¼š
- **å¯¹å¤–æš´éœ²**ï¼šç»™é›†ç¾¤å†…çš„åº”ç”¨ä¸€ä¸ªå›ºå®šçš„å¤–ç½‘IPåœ°å€
- **æµé‡åˆ†é…**ï¼šæŠŠç”¨æˆ·è¯·æ±‚å‡åŒ€åˆ†æ•£åˆ°å¤šä¸ªPodä¸Š
- **æ•…éšœéš”ç¦»**ï¼šæŸä¸ªPodæŒ‚äº†ï¼Œè‡ªåŠ¨ä¸å†åˆ†é…æµé‡ç»™å®ƒ

### 1.2 LoadBalancer vs å…¶ä»–Serviceç±»åž‹


**ä¸‰ç§Serviceç±»åž‹å¯¹æ¯”**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç±»åž‹       â”‚   è®¿é—®èŒƒå›´   â”‚    IPåœ°å€æ¥æº    â”‚   ä½¿ç”¨åœºæ™¯   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ClusterIP    â”‚  é›†ç¾¤å†…éƒ¨   â”‚  é›†ç¾¤å†…è™šæ‹ŸIP   â”‚  å†…éƒ¨é€šä¿¡   â”‚
â”‚ NodePort     â”‚  é›†ç¾¤å¤–éƒ¨   â”‚  èŠ‚ç‚¹IP+ç«¯å£    â”‚  æµ‹è¯•çŽ¯å¢ƒ   â”‚
â”‚ LoadBalancer â”‚  é›†ç¾¤å¤–éƒ¨   â”‚  äº‘åŽ‚å•†åˆ†é…IP   â”‚  ç”Ÿäº§çŽ¯å¢ƒ   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸ºä»€ä¹ˆéœ€è¦LoadBalancer**ï¼š
- **NodePortçš„é—®é¢˜**ï¼šç”¨æˆ·éœ€è¦è®°ä½ç«¯å£å·ï¼Œä¸å¤Ÿä¸“ä¸š
- **åŸŸåè§£æžéœ€æ±‚**ï¼šéœ€è¦å›ºå®šIPæ¥ç»‘å®šåŸŸå
- **é«˜å¯ç”¨è¦æ±‚**ï¼šå•ä¸ªèŠ‚ç‚¹æ•…éšœæ—¶ï¼ŒLoadBalancerèƒ½è‡ªåŠ¨åˆ‡æ¢

### 1.3 LoadBalancerå·¥ä½œåŽŸç†


**å®Œæ•´æµç¨‹å›¾**ï¼š
```
å¤–ç½‘ç”¨æˆ·
    â†“
[äº‘åŽ‚å•†è´Ÿè½½å‡è¡¡å™¨] â† è‡ªåŠ¨åˆ›å»ºï¼Œåˆ†é…å…¬ç½‘IP
    â†“ 
[Kubernetesé›†ç¾¤]
    â†“
[Service: LoadBalancer]
    â†“
[Pod1] [Pod2] [Pod3] â† è‡ªåŠ¨è´Ÿè½½å‡è¡¡
```

**èƒŒåŽå‘ç”Ÿäº†ä»€ä¹ˆ**ï¼š
1. **åˆ›å»ºè¯·æ±‚**ï¼šä½ åˆ›å»ºLoadBalancer Service
2. **äº‘åŽ‚å•†å“åº”**ï¼šKubernetesè°ƒç”¨äº‘åŽ‚å•†API
3. **èµ„æºåˆ†é…**ï¼šäº‘åŽ‚å•†åˆ›å»ºè´Ÿè½½å‡è¡¡å™¨ï¼Œåˆ†é…å…¬ç½‘IP
4. **è§„åˆ™é…ç½®**ï¼šè‡ªåŠ¨é…ç½®è½¬å‘è§„åˆ™åˆ°é›†ç¾¤èŠ‚ç‚¹
5. **å¥åº·æ£€æŸ¥**ï¼šæŒç»­ç›‘æŽ§Podå¥åº·çŠ¶æ€

---

## 2. â˜ï¸ äº‘åŽ‚å•†é›†æˆåŽŸç†


### 2.1 äº‘åŽ‚å•†é›†æˆæœºåˆ¶


**ä¸åŒäº‘åŽ‚å•†çš„LoadBalancer**ï¼š
- **é˜¿é‡Œäº‘**ï¼šSLBï¼ˆServer Load Balancerï¼‰
- **è…¾è®¯äº‘**ï¼šCLBï¼ˆCloud Load Balancerï¼‰  
- **AWS**ï¼šELBï¼ˆElastic Load Balancerï¼‰
- **Azure**ï¼šAzure Load Balancer

**é›†æˆå·¥ä½œåŽŸç†**ï¼š
```
ä½ åˆ›å»ºLoadBalancer Service
         â†“
Kubernetes Controller Manager
         â†“
è°ƒç”¨äº‘åŽ‚å•†APIæŽ¥å£
         â†“
äº‘åŽ‚å•†åˆ›å»ºè´Ÿè½½å‡è¡¡å™¨å®žä¾‹
         â†“
è¿”å›žå¤–éƒ¨IPåœ°å€
         â†“
æ›´æ–°ServiceçŠ¶æ€
```

### 2.2 Cloud Controller Manager


**ä»€ä¹ˆæ˜¯Cloud Controller Manager**ï¼š
> ðŸ’¡ **é€šä¿—è§£é‡Š**ï¼šå®ƒå°±åƒKuberneteså’Œäº‘åŽ‚å•†ä¹‹é—´çš„"ç¿»è¯‘å®˜"ï¼ŒæŠŠKubernetesçš„éœ€æ±‚ç¿»è¯‘æˆäº‘åŽ‚å•†èƒ½ç†è§£çš„APIè°ƒç”¨ã€‚

**ä¸»è¦èŒè´£**ï¼š
- **èµ„æºç®¡ç†**ï¼šåˆ›å»ºã€æ›´æ–°ã€åˆ é™¤äº‘åŽ‚å•†çš„è´Ÿè½½å‡è¡¡å™¨
- **çŠ¶æ€åŒæ­¥**ï¼šæŠŠäº‘åŽ‚å•†çš„èµ„æºçŠ¶æ€åŒæ­¥å›žKubernetes
- **æ•…éšœå¤„ç†**ï¼šå¤„ç†äº‘åŽ‚å•†APIè°ƒç”¨å¤±è´¥çš„æƒ…å†µ

**é…ç½®ç¤ºä¾‹**ï¼š
```yaml
# åœ¨é›†ç¾¤éƒ¨ç½²æ—¶æŒ‡å®šäº‘åŽ‚å•†
apiVersion: kubeadm.k8s.io/v1beta3
kind: ClusterConfiguration
metadata:
  name: config
cloudProvider: aws  # æŒ‡å®šäº‘åŽ‚å•†ç±»åž‹
```

### 2.3 ä¸åŒäº‘åŽ‚å•†çš„ç‰¹ç‚¹


**é˜¿é‡Œäº‘SLBç‰¹ç‚¹**ï¼š
- **ç½‘ç»œç±»åž‹**ï¼šæ”¯æŒå…¬ç½‘å’Œå†…ç½‘SLB
- **è®¡è´¹æ–¹å¼**ï¼šæŒ‰é‡ä»˜è´¹æˆ–åŒ…å¹´åŒ…æœˆ
- **æ€§èƒ½è§„æ ¼**ï¼šæ”¯æŒä¸åŒæ€§èƒ½ç­‰çº§é€‰æ‹©

**AWS ELBç‰¹ç‚¹**ï¼š
- **ç±»åž‹ä¸°å¯Œ**ï¼šClassicã€Applicationã€Networkä¸‰ç§
- **å¯ç”¨åŒº**ï¼šè‡ªåŠ¨è·¨å¤šä¸ªå¯ç”¨åŒºéƒ¨ç½²
- **å®‰å…¨é›†æˆ**ï¼šä¸ŽAWSå®‰å…¨ç»„æ— ç¼é›†æˆ

**é€šç”¨é…ç½®æ–¹æ³•**ï¼š
```yaml
apiVersion: v1
kind: Service
metadata:
  name: my-app-lb
  annotations:
    # é˜¿é‡Œäº‘æ³¨è§£
    service.beta.kubernetes.io/alicloud-loadbalancer-spec: "slb.s2.small"
    # AWSæ³¨è§£  
    service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
spec:
  type: LoadBalancer
  selector:
    app: my-app
  ports:
  - port: 80
    targetPort: 8080
```

---

## 3. âš–ï¸ å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨é…ç½®


### 3.1 åŸºç¡€LoadBalanceré…ç½®


**æœ€ç®€å•çš„LoadBalanceré…ç½®**ï¼š
```yaml
apiVersion: v1
kind: Service
metadata:
  name: web-app-lb
spec:
  type: LoadBalancer
  selector:
    app: web-app
  ports:
  - name: http
    port: 80        # å¤–éƒ¨è®¿é—®ç«¯å£
    targetPort: 8080 # Podå†…åº”ç”¨ç«¯å£
    protocol: TCP
```

**é…ç½®è¯¦è§£**ï¼š
- `type: LoadBalancer`ï¼šå£°æ˜Žè¿™æ˜¯LoadBalancerç±»åž‹Service
- `selector`ï¼šé€‰æ‹©è¦è´Ÿè½½å‡è¡¡çš„Pod
- `port`ï¼šå¤–ç½‘ç”¨æˆ·è®¿é—®çš„ç«¯å£ï¼ˆé€šå¸¸80æˆ–443ï¼‰
- `targetPort`ï¼šPodå†…åº”ç”¨ç›‘å¬çš„ç«¯å£

### 3.2 å¤šç«¯å£é…ç½®


**Webåº”ç”¨åŒæ—¶æ”¯æŒHTTPå’ŒHTTPS**ï¼š
```yaml
apiVersion: v1
kind: Service
metadata:
  name: web-app-multi-port
spec:
  type: LoadBalancer
  selector:
    app: web-app
  ports:
  - name: http
    port: 80
    targetPort: 8080
    protocol: TCP
  - name: https  
    port: 443
    targetPort: 8443
    protocol: TCP
```

> âš ï¸ **æ³¨æ„**ï¼šå¤šç«¯å£æ—¶ï¼Œæ¯ä¸ªç«¯å£éƒ½å¿…é¡»æœ‰`name`å­—æ®µ

### 3.3 é«˜çº§é…ç½®é€‰é¡¹


**æŒ‡å®šè´Ÿè½½å‡è¡¡å™¨ç±»åž‹**ï¼š
```yaml
apiVersion: v1
kind: Service
metadata:
  name: advanced-lb
  annotations:
    # æŒ‡å®šè´Ÿè½½å‡è¡¡å™¨ç±»åž‹ï¼ˆä»¥é˜¿é‡Œäº‘ä¸ºä¾‹ï¼‰
    service.beta.kubernetes.io/alicloud-loadbalancer-spec: "slb.s3.medium"
    # æŒ‡å®šç½‘ç»œç±»åž‹
    service.beta.kubernetes.io/alicloud-loadbalancer-address-type: "internet"
    # å¯ç”¨ä¼šè¯ä¿æŒ
    service.beta.kubernetes.io/alicloud-loadbalancer-persistence-timeout: "1800"
spec:
  type: LoadBalancer
  selector:
    app: my-app
  ports:
  - port: 80
    targetPort: 8080
  sessionAffinity: ClientIP  # ä¼šè¯äº²å’Œæ€§
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 3600   # ä¼šè¯è¶…æ—¶æ—¶é—´
```

**å¸¸ç”¨æ³¨è§£è¯´æ˜Ž**ï¼š
- **è§„æ ¼é€‰æ‹©**ï¼šæ ¹æ®é¢„æœŸæµé‡é€‰æ‹©åˆé€‚è§„æ ¼
- **ç½‘ç»œç±»åž‹**ï¼šå…¬ç½‘æˆ–å†…ç½‘è®¿é—®
- **ä¼šè¯ä¿æŒ**ï¼šåŒä¸€ç”¨æˆ·çš„è¯·æ±‚åˆ†é…åˆ°åŒä¸€Pod

---

## 4. ðŸ“ IPåœ°å€åˆ†é…æœºåˆ¶


### 4.1 åŠ¨æ€IPåˆ†é…


**é»˜è®¤è¡Œä¸º**ï¼š
```yaml
apiVersion: v1
kind: Service
metadata:
  name: dynamic-ip-lb
spec:
  type: LoadBalancer
  selector:
    app: my-app
  ports:
  - port: 80
    targetPort: 8080
```

**IPåˆ†é…è¿‡ç¨‹**ï¼š
```
1. åˆ›å»ºService
2. Kuberneteså‘äº‘åŽ‚å•†è¯·æ±‚è´Ÿè½½å‡è¡¡å™¨
3. äº‘åŽ‚å•†ä»ŽIPæ± ä¸­åˆ†é…ä¸€ä¸ªå¯ç”¨IP
4. IPåœ°å€å†™å…¥Serviceçš„status.loadBalancer.ingress
```

**æŸ¥çœ‹åˆ†é…çš„IP**ï¼š
```bash
kubectl get service dynamic-ip-lb -o wide
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
NAME              TYPE           EXTERNAL-IP     PORT(S)
dynamic-ip-lb     LoadBalancer   47.96.123.45    80:31234/TCP
```

### 4.2 é™æ€IPåˆ†é…


**ä¸ºä»€ä¹ˆéœ€è¦é™æ€IP**ï¼š
- **åŸŸåç»‘å®š**ï¼šåŸŸåè§£æžéœ€è¦å›ºå®šIPåœ°å€
- **é˜²ç«å¢™è§„åˆ™**ï¼šå®‰å…¨ç­–ç•¥éœ€è¦ç™½åå•å›ºå®šIP
- **è¯ä¹¦ç»‘å®š**ï¼šSSLè¯ä¹¦å¯èƒ½ç»‘å®šç‰¹å®šIP

**é™æ€IPé…ç½®ç¤ºä¾‹**ï¼š
```yaml
apiVersion: v1
kind: Service
metadata:
  name: static-ip-lb
  annotations:
    # é˜¿é‡Œäº‘æŒ‡å®šé™æ€IP
    service.beta.kubernetes.io/alicloud-loadbalancer-ip: "47.96.123.100"
    # AWSæŒ‡å®šé¢„åˆ†é…çš„EIP
    service.beta.kubernetes.io/aws-load-balancer-eip-allocations: "eipalloc-12345678"
spec:
  type: LoadBalancer
  loadBalancerIP: 47.96.123.100  # æŒ‡å®šIPåœ°å€
  selector:
    app: my-app
  ports:
  - port: 80
    targetPort: 8080
```

**æ³¨æ„äº‹é¡¹**ï¼š
- é™æ€IPéœ€è¦æå‰åœ¨äº‘åŽ‚å•†æŽ§åˆ¶å°åˆ›å»º
- IPåœ°å€å¿…é¡»åœ¨äº‘åŽ‚å•†çš„å¯ç”¨IPèŒƒå›´å†…
- åˆ é™¤Serviceæ—¶ï¼Œé™æ€IPä¸ä¼šè‡ªåŠ¨é‡Šæ”¾

### 4.3 IPåœ°å€ç®¡ç†æœ€ä½³å®žè·µ


**IPåœ°å€è§„åˆ’å»ºè®®**ï¼š

| çŽ¯å¢ƒç±»åž‹ | IPåˆ†é…ç­–ç•¥ | åŽŸå›  |
|---------|------------|------|
| å¼€å‘çŽ¯å¢ƒ | åŠ¨æ€IP | èŠ‚çœæˆæœ¬ï¼ŒIPéœ€æ±‚ä¸å›ºå®š |
| æµ‹è¯•çŽ¯å¢ƒ | åŠ¨æ€IP | çŽ¯å¢ƒç»å¸¸é‡å»ºï¼Œä¸éœ€è¦å›ºå®šIP |
| ç”Ÿäº§çŽ¯å¢ƒ | é™æ€IP | éœ€è¦åŸŸåç»‘å®šå’Œå›ºå®šè®¿é—®åœ°å€ |

**IPåœ°å€ç›‘æŽ§**ï¼š
```bash
# å®šæœŸæ£€æŸ¥LoadBalancerçŠ¶æ€
kubectl get svc -o wide | grep LoadBalancer

# æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
kubectl describe svc your-loadbalancer-service
```

---

## 5. ðŸ¥ å¥åº·æ£€æŸ¥é…ç½®è¯¦è§£


### 5.1 å¥åº·æ£€æŸ¥åŸºæœ¬æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯å¥åº·æ£€æŸ¥**ï¼š
> ðŸ’¡ **å½¢è±¡æ¯”å–»**ï¼šå¥åº·æ£€æŸ¥å°±åƒåŒ»ç”Ÿå®šæœŸç»™ç—…äººé‡ä½“æ¸©ï¼ŒLoadBalancerå®šæœŸæ£€æŸ¥Podæ˜¯å¦è¿˜èƒ½æ­£å¸¸å·¥ä½œã€‚

**å¥åº·æ£€æŸ¥çš„ä½œç”¨**ï¼š
- **æ•…éšœå‘çŽ°**ï¼šåŠæ—¶å‘çŽ°ä¸å¥åº·çš„Pod
- **æµé‡åˆ‡æ¢**ï¼šåœæ­¢å‘æ•…éšœPodå‘é€è¯·æ±‚
- **è‡ªåŠ¨æ¢å¤**ï¼šPodæ¢å¤åŽè‡ªåŠ¨åŠ å…¥è´Ÿè½½å‡è¡¡

### 5.2 é…ç½®å¥åº·æ£€æŸ¥


**åœ¨Podä¸­é…ç½®å¥åº·æ£€æŸ¥**ï¼š
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: web-app
spec:
  replicas: 3
  selector:
    matchLabels:
      app: web-app
  template:
    metadata:
      labels:
        app: web-app
    spec:
      containers:
      - name: app
        image: nginx
        ports:
        - containerPort: 80
        # å­˜æ´»æ£€æŸ¥ï¼šPodæ˜¯å¦è¿˜æ´»ç€
        livenessProbe:
          httpGet:
            path: /health
            port: 80
          initialDelaySeconds: 30  # å¯åŠ¨åŽ30ç§’å¼€å§‹æ£€æŸ¥
          periodSeconds: 10        # æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡
          timeoutSeconds: 5        # è¶…æ—¶æ—¶é—´5ç§’
          failureThreshold: 3      # è¿žç»­å¤±è´¥3æ¬¡è®¤ä¸ºä¸å¥åº·
        # å°±ç»ªæ£€æŸ¥ï¼šPodæ˜¯å¦å‡†å¤‡å¥½æŽ¥æ”¶æµé‡  
        readinessProbe:
          httpGet:
            path: /ready
            port: 80
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 3
          successThreshold: 1      # æˆåŠŸ1æ¬¡è®¤ä¸ºå°±ç»ª
          failureThreshold: 3
```

**å¥åº·æ£€æŸ¥ç±»åž‹å¯¹æ¯”**ï¼š

| æ£€æŸ¥ç±»åž‹ | ä½œç”¨ | å¤±è´¥åŽæžœ | ä½¿ç”¨åœºæ™¯ |
|---------|------|----------|----------|
| livenessProbe | æ£€æŸ¥Podæ˜¯å¦å­˜æ´» | é‡å¯Pod | æ£€æµ‹æ­»é”ã€å†…å­˜æ³„éœ² |
| readinessProbe | æ£€æŸ¥Podæ˜¯å¦å°±ç»ª | ä»ŽServiceç§»é™¤ | æ£€æµ‹ä¾èµ–æœåŠ¡è¿žæŽ¥ |
| startupProbe | æ£€æŸ¥Podæ˜¯å¦å¯åŠ¨å®Œæˆ | é‡å¯Pod | æ…¢å¯åŠ¨åº”ç”¨ |

### 5.3 å¥åº·æ£€æŸ¥é…ç½®ä¼˜åŒ–


**é’ˆå¯¹ä¸åŒåº”ç”¨çš„å¥åº·æ£€æŸ¥ç­–ç•¥**ï¼š

```yaml
# æ•°æ®åº“åº”ç”¨å¥åº·æ£€æŸ¥
livenessProbe:
  exec:
    command:
    - /bin/sh
    - -c  
    - "pg_isready -U postgres"
  initialDelaySeconds: 60  # æ•°æ®åº“å¯åŠ¨è¾ƒæ…¢
  periodSeconds: 30
  timeoutSeconds: 10

# Webåº”ç”¨å¥åº·æ£€æŸ¥  
readinessProbe:
  httpGet:
    path: /api/health
    port: 8080
    httpHeaders:
    - name: Accept
      value: application/json
  initialDelaySeconds: 10
  periodSeconds: 5
```

**å¥åº·æ£€æŸ¥æœ€ä½³å®žè·µ**ï¼š
- **è½»é‡çº§ç«¯ç‚¹**ï¼šå¥åº·æ£€æŸ¥æŽ¥å£è¦å¿«é€Ÿå“åº”
- **åˆç†è¶…æ—¶**ï¼šæ ¹æ®åº”ç”¨ç‰¹ç‚¹è®¾ç½®è¶…æ—¶æ—¶é—´  
- **åŒºåˆ†æ£€æŸ¥**ï¼šå­˜æ´»æ£€æŸ¥å’Œå°±ç»ªæ£€æŸ¥ç”¨ä¸åŒç«¯ç‚¹
- **ç›‘æŽ§å‘Šè­¦**ï¼šå¥åº·æ£€æŸ¥å¤±è´¥è¦åŠæ—¶å‘Šè­¦

---

## 6. ðŸ’° æˆæœ¬ä¼˜åŒ–ç­–ç•¥


### 6.1 æˆæœ¬æž„æˆåˆ†æž


**LoadBalancerçš„ä¸»è¦æˆæœ¬**ï¼š
```
æ€»æˆæœ¬ = è´Ÿè½½å‡è¡¡å™¨è´¹ç”¨ + å…¬ç½‘IPè´¹ç”¨ + æµé‡è´¹ç”¨
```

**æˆæœ¬æ˜Žç»†**ï¼š
- **è´Ÿè½½å‡è¡¡å™¨å®žä¾‹è´¹**ï¼šæŒ‰è§„æ ¼å’Œæ—¶é•¿æ”¶è´¹
- **å…¬ç½‘IPè´¹ç”¨**ï¼šé™æ€IPé€šå¸¸æ¯”åŠ¨æ€IPè´µ
- **å‡ºç½‘æµé‡è´¹**ï¼šç”¨æˆ·ä¸‹è½½äº§ç”Ÿçš„æµé‡è´¹ç”¨
- **å¥åº·æ£€æŸ¥è´¹ç”¨**ï¼šæŸäº›äº‘åŽ‚å•†æŒ‰æ£€æŸ¥æ¬¡æ•°æ”¶è´¹

### 6.2 æˆæœ¬ä¼˜åŒ–ç­–ç•¥


**ç­–ç•¥ä¸€ï¼šåˆç†é€‰æ‹©è§„æ ¼**
```yaml
# å¼€å‘çŽ¯å¢ƒï¼šé€‰æ‹©æœ€å°è§„æ ¼
metadata:
  annotations:
    service.beta.kubernetes.io/alicloud-loadbalancer-spec: "slb.s1.small"

# ç”Ÿäº§çŽ¯å¢ƒï¼šæ ¹æ®å®žé™…éœ€æ±‚é€‰æ‹©
metadata:
  annotations:
    service.beta.kubernetes.io/alicloud-loadbalancer-spec: "slb.s3.medium"
```

**ç­–ç•¥äºŒï¼šå…±äº«LoadBalancer**
```yaml
# å¤šä¸ªåº”ç”¨å…±äº«ä¸€ä¸ªLoadBalancer
apiVersion: v1
kind: Service
metadata:
  name: shared-lb
spec:
  type: LoadBalancer
  selector:
    tier: frontend  # å…±åŒçš„æ ‡ç­¾
  ports:
  - name: app1
    port: 80
    targetPort: 8080
  - name: app2  
    port: 8080
    targetPort: 8080
```

**ç­–ç•¥ä¸‰ï¼šä½¿ç”¨Ingressæ›¿ä»£LoadBalancer**
```yaml
# ä¸€ä¸ªLoadBalancer + Ingress æ”¯æŒå¤šä¸ªåŸŸå
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: multi-domain-ingress
spec:
  ingressClassName: nginx
  rules:
  - host: app1.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: app1-service
            port:
              number: 80
  - host: app2.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: app2-service
            port:
              number: 80
```

### 6.3 æˆæœ¬ç›‘æŽ§å’Œå‘Šè­¦


**æˆæœ¬ç›‘æŽ§æŒ‡æ ‡**ï¼š
- **å®žä¾‹æ•°é‡**ï¼šå½“å‰æ´»è·ƒçš„LoadBalanceræ•°é‡
- **æµé‡ç»Ÿè®¡**ï¼šæ¯ä¸ªLoadBalancerçš„æµé‡ä½¿ç”¨æƒ…å†µ
- **è§„æ ¼åˆ©ç”¨çŽ‡**ï¼šæ˜¯å¦è¿‡åº¦é…ç½®

**è‡ªåŠ¨åŒ–æˆæœ¬æŽ§åˆ¶**ï¼š
```bash
#!/bin/bash
# å®šæœŸæ¸…ç†æœªä½¿ç”¨çš„LoadBalancer
kubectl get svc -o json | jq -r '
  .items[] | 
  select(.spec.type=="LoadBalancer") |
  select(.status.loadBalancer.ingress == null) |
  .metadata.name
' | while read svc; do
  echo "å‘çŽ°æœªåˆ†é…IPçš„LoadBalancer: $svc"
  # å¯ä»¥å‘é€å‘Šè­¦æˆ–è‡ªåŠ¨åˆ é™¤
done
```

---

## 7. ðŸ¢ é«˜å¯ç”¨éƒ¨ç½²å®žè·µ


### 7.1 é«˜å¯ç”¨æž¶æž„è®¾è®¡


**å¤šå¯ç”¨åŒºéƒ¨ç½²**ï¼š
```
            Internet
               â†“
        [LoadBalancer]
        /      |      \
   Zone-A   Zone-B   Zone-C
   [Node1]  [Node2]  [Node3]
   [Pod1]   [Pod2]   [Pod3]
```

**é…ç½®ç¤ºä¾‹**ï¼š
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ha-web-app
spec:
  replicas: 6  # è¶³å¤Ÿçš„å‰¯æœ¬æ•°
  selector:
    matchLabels:
      app: ha-web-app
  template:
    metadata:
      labels:
        app: ha-web-app
    spec:
      # Podåäº²å’Œæ€§ï¼šé¿å…Podé›†ä¸­åœ¨åŒä¸€èŠ‚ç‚¹
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - ha-web-app
              topologyKey: kubernetes.io/hostname
      containers:
      - name: app
        image: nginx:1.21
        ports:
        - containerPort: 80
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
```

### 7.2 æ•…éšœåˆ‡æ¢é…ç½®


**LoadBalancerå¥åº·æ£€æŸ¥ä¼˜åŒ–**ï¼š
```yaml
apiVersion: v1
kind: Service
metadata:
  name: ha-loadbalancer
  annotations:
    # å¥åº·æ£€æŸ¥é—´éš”ä¼˜åŒ–ï¼ˆé˜¿é‡Œäº‘ç¤ºä¾‹ï¼‰
    service.beta.kubernetes.io/alicloud-loadbalancer-healthy-threshold: "2"
    service.beta.kubernetes.io/alicloud-loadbalancer-unhealthy-threshold: "2"
    service.beta.kubernetes.io/alicloud-loadbalancer-health-check-interval: "5"
spec:
  type: LoadBalancer
  selector:
    app: ha-web-app
  ports:
  - port: 80
    targetPort: 80
    protocol: TCP
  sessionAffinity: None  # ä¸ä½¿ç”¨ä¼šè¯äº²å’Œï¼Œæé«˜å®¹é”™æ€§
```

### 7.3 ç›‘æŽ§å’Œå‘Šè­¦é…ç½®


**å…³é”®ç›‘æŽ§æŒ‡æ ‡**ï¼š
```yaml
# Prometheusç›‘æŽ§è§„åˆ™ç¤ºä¾‹
groups:
- name: loadbalancer-alerts
  rules:
  - alert: LoadBalancerDown
    expr: up{job="kubernetes-service-endpoints"} == 0
    for: 1m
    annotations:
      summary: "LoadBalancer endpoint is down"
      
  - alert: HighErrorRate
    expr: |
      sum(rate(nginx_http_requests_total{status=~"5.."}[5m])) /
      sum(rate(nginx_http_requests_total[5m])) > 0.1
    for: 5m
    annotations:
      summary: "High error rate detected"

  - alert: LowHealthyBackends  
    expr: kube_service_status_load_balancer_ingress < 1
    for: 2m
    annotations:
      summary: "No healthy backends available"
```

**è‡ªåŠ¨åŒ–è¿ç»´è„šæœ¬**ï¼š
```bash
#!/bin/bash
# æ£€æŸ¥LoadBalancerçŠ¶æ€çš„è„šæœ¬
check_loadbalancer_health() {
  local service_name=$1
  local namespace=${2:-default}
  
  # æ£€æŸ¥å¤–éƒ¨IPæ˜¯å¦åˆ†é…
  external_ip=$(kubectl get svc $service_name -n $namespace -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
  
  if [ -z "$external_ip" ]; then
    echo "è­¦å‘Š: $service_name æ²¡æœ‰åˆ†é…åˆ°å¤–éƒ¨IP"
    return 1
  fi
  
  # æ£€æŸ¥ç«¯å£è¿žé€šæ€§
  local port=$(kubectl get svc $service_name -n $namespace -o jsonpath='{.spec.ports[0].port}')
  if ! nc -z $external_ip $port; then
    echo "é”™è¯¯: $service_name ($external_ip:$port) æ— æ³•è¿žé€š"
    return 1
  fi
  
  echo "æ­£å¸¸: $service_name ($external_ip:$port) è¿è¡Œæ­£å¸¸"
  return 0
}

# æ‰¹é‡æ£€æŸ¥æ‰€æœ‰LoadBalanceræœåŠ¡
kubectl get svc --all-namespaces -o json | \
jq -r '.items[] | select(.spec.type=="LoadBalancer") | "\(.metadata.namespace) \(.metadata.name)"' | \
while read namespace name; do
  check_loadbalancer_health $name $namespace
done
```

---

## 8. ðŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŽŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ðŸ”¸ LoadBalanceræœ¬è´¨ï¼šäº‘åŽ‚å•†æä¾›çš„å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨æœåŠ¡
ðŸ”¸ å·¥ä½œåŽŸç†ï¼šKubernetesé€šè¿‡Cloud Controller Managerè°ƒç”¨äº‘åŽ‚å•†API
ðŸ”¸ IPåˆ†é…ï¼šæ”¯æŒåŠ¨æ€åˆ†é…å’Œé™æ€æŒ‡å®šä¸¤ç§æ–¹å¼
ðŸ”¸ å¥åº·æ£€æŸ¥ï¼šé€šè¿‡livenessProbeå’ŒreadinessProbeä¿è¯æœåŠ¡è´¨é‡
ðŸ”¸ æˆæœ¬æŽ§åˆ¶ï¼šåˆç†é€‰æ‹©è§„æ ¼ï¼Œè€ƒè™‘ä½¿ç”¨Ingressæ›¿ä»£æ–¹æ¡ˆ
ðŸ”¸ é«˜å¯ç”¨è®¾è®¡ï¼šå¤šå¯ç”¨åŒºéƒ¨ç½²ï¼ŒPodåäº²å’Œæ€§ï¼Œåˆç†çš„å‰¯æœ¬æ•°
```

### 8.2 å…³é”®é…ç½®æ¨¡æ¿


**ç”Ÿäº§çŽ¯å¢ƒæŽ¨èé…ç½®**ï¼š
```yaml
apiVersion: v1
kind: Service
metadata:
  name: production-lb
  annotations:
    # æ ¹æ®äº‘åŽ‚å•†è°ƒæ•´
    service.beta.kubernetes.io/alicloud-loadbalancer-spec: "slb.s3.large"
    service.beta.kubernetes.io/alicloud-loadbalancer-health-check-interval: "5"
spec:
  type: LoadBalancer
  loadBalancerIP: "your-static-ip"  # ç”Ÿäº§çŽ¯å¢ƒå»ºè®®é™æ€IP
  selector:
    app: your-app
    tier: production
  ports:
  - name: http
    port: 80
    targetPort: 8080
  - name: https
    port: 443
    targetPort: 8443
  sessionAffinity: None  # æé«˜å®¹é”™æ€§
```

### 8.3 æ•…éšœæŽ’æŸ¥æ¸…å•


**å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ³•**ï¼š

| é—®é¢˜çŽ°è±¡ | å¯èƒ½åŽŸå›  | è§£å†³æ–¹æ³• |
|---------|---------|----------|
| å¤–éƒ¨IPä¸€ç›´Pending | äº‘åŽ‚å•†é…ç½®é—®é¢˜ | æ£€æŸ¥Cloud Controller Manageré…ç½® |
| æ— æ³•è®¿é—®æœåŠ¡ | å®‰å…¨ç»„/é˜²ç«å¢™é™åˆ¶ | æ£€æŸ¥äº‘åŽ‚å•†å®‰å…¨ç»„è§„åˆ™ |
| éƒ¨åˆ†è¯·æ±‚å¤±è´¥ | Podå¥åº·æ£€æŸ¥å¤±è´¥ | ä¼˜åŒ–å¥åº·æ£€æŸ¥é…ç½® |
| å“åº”æ—¶é—´é•¿ | è´Ÿè½½å‡è¡¡å™¨è§„æ ¼ä¸è¶³ | å‡çº§è´Ÿè½½å‡è¡¡å™¨è§„æ ¼ |

### 8.4 å®žé™…åº”ç”¨æŒ‡å¯¼


**é€‰æ‹©LoadBalancerçš„åœºæ™¯**ï¼š
âœ… **é€‚ç”¨åœºæ™¯**ï¼š
- éœ€è¦å›ºå®šå¤–ç½‘IPçš„ç”Ÿäº§åº”ç”¨
- éœ€è¦äº‘åŽ‚å•†æä¾›çš„é«˜å¯ç”¨ä¿éšœ
- å¯¹ç½‘ç»œå»¶è¿Ÿæœ‰ä¸¥æ ¼è¦æ±‚çš„åº”ç”¨
- éœ€è¦å››å±‚è´Ÿè½½å‡è¡¡çš„TCP/UDPæœåŠ¡

âŒ **ä¸é€‚ç”¨åœºæ™¯**ï¼š
- å¼€å‘æµ‹è¯•çŽ¯å¢ƒï¼ˆæˆæœ¬è€ƒè™‘ï¼‰
- éœ€è¦å¤æ‚è·¯ç”±è§„åˆ™çš„HTTPåº”ç”¨ï¼ˆæŽ¨èIngressï¼‰
- é›†ç¾¤å†…éƒ¨æœåŠ¡é€šä¿¡ï¼ˆä½¿ç”¨ClusterIPï¼‰
- ä¸´æ—¶æ€§çš„æœåŠ¡æš´éœ²ï¼ˆä½¿ç”¨NodePortï¼‰

**æœ€ä½³å®žè·µchecklist**ï¼š
- [ ] ç”Ÿäº§çŽ¯å¢ƒä½¿ç”¨é™æ€IP
- [ ] é…ç½®åˆé€‚çš„å¥åº·æ£€æŸ¥å‚æ•°
- [ ] è®¾ç½®èµ„æºé™åˆ¶å’Œåäº²å’Œæ€§
- [ ] å»ºç«‹ç›‘æŽ§å’Œå‘Šè­¦æœºåˆ¶
- [ ] å®šæœŸæ£€æŸ¥æˆæœ¬ä½¿ç”¨æƒ…å†µ
- [ ] å‡†å¤‡æ•…éšœåº”æ€¥é¢„æ¡ˆ

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- LoadBalanceræ˜¯ç”Ÿäº§çŽ¯å¢ƒæš´éœ²æœåŠ¡çš„é¦–é€‰æ–¹æ¡ˆ
- éœ€è¦é…åˆäº‘åŽ‚å•†ä½¿ç”¨ï¼Œä¼šäº§ç”Ÿé¢å¤–è´¹ç”¨  
- å¥åº·æ£€æŸ¥æ˜¯ä¿è¯æœåŠ¡è´¨é‡çš„å…³é”®é…ç½®
- é«˜å¯ç”¨éƒ¨ç½²éœ€è¦è€ƒè™‘å¤šä¸ªç»´åº¦çš„å†—ä½™è®¾è®¡