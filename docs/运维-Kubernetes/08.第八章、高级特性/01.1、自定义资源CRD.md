---
title: 1ã€è‡ªå®šä¹‰èµ„æºCRD
---
## ğŸ“š ç›®å½•

1. [ä»€ä¹ˆæ˜¯CRDè‡ªå®šä¹‰èµ„æº](#1-ä»€ä¹ˆæ˜¯CRDè‡ªå®šä¹‰èµ„æº)
2. [ä¸ºä»€ä¹ˆéœ€è¦CRD](#2-ä¸ºä»€ä¹ˆéœ€è¦CRD)
3. [CRDçš„æ ¸å¿ƒæ¦‚å¿µ](#3-CRDçš„æ ¸å¿ƒæ¦‚å¿µ)
4. [åˆ›å»ºç¬¬ä¸€ä¸ªCRD](#4-åˆ›å»ºç¬¬ä¸€ä¸ªCRD)
5. [APIç‰ˆæœ¬ç®¡ç†](#5-APIç‰ˆæœ¬ç®¡ç†)
6. [OpenAPIæ¨¡å¼å®šä¹‰](#6-OpenAPIæ¨¡å¼å®šä¹‰)
7. [èµ„æºéªŒè¯è§„åˆ™](#7-èµ„æºéªŒè¯è§„åˆ™)
8. [é»˜è®¤å€¼è®¾ç½®](#8-é»˜è®¤å€¼è®¾ç½®)
9. [å­èµ„æºæ”¯æŒ](#9-å­èµ„æºæ”¯æŒ)
10. [å®é™…åº”ç”¨åœºæ™¯](#10-å®é™…åº”ç”¨åœºæ™¯)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ ä»€ä¹ˆæ˜¯CRDè‡ªå®šä¹‰èµ„æº


### 1.1 é€šä¿—ç†è§£CRD


**ğŸ”¸ CRDå°±åƒæ˜¯"è‡ªå®šä¹‰ç§¯æœ¨"**
```
æƒ³è±¡ä¸€ä¸‹ï¼š
Kubernetes = ç§¯æœ¨æ¸¸æˆ
Podã€Serviceç­‰ = å®˜æ–¹æä¾›çš„æ ‡å‡†ç§¯æœ¨å—
CRD = ä½ å¯ä»¥è‡ªå·±è®¾è®¡çš„ç‰¹æ®Šç§¯æœ¨å—

æœ‰äº†CRDï¼Œä½ å°±èƒ½åˆ›é€ å‡ºKubernetesåŸæœ¬æ²¡æœ‰çš„æ–°ç±»å‹èµ„æºï¼
```

**ğŸ’¡ ç®€å•å®šä¹‰**
- **CRD**ï¼šCustom Resource Definitionï¼ˆè‡ªå®šä¹‰èµ„æºå®šä¹‰ï¼‰
- **ä½œç”¨**ï¼šè®©ä½ åœ¨Kubernetesä¸­åˆ›å»ºå…¨æ–°çš„èµ„æºç±»å‹
- **æœ¬è´¨**ï¼šæ‰©å±•Kubernetes APIï¼Œæ·»åŠ æ–°çš„èµ„æºç§ç±»

### 1.2 CRDçš„å·¥ä½œåŸç†


**ğŸ”„ å·¥ä½œæµç¨‹å›¾ç¤º**
```
å¼€å‘è€…               Kubernetesé›†ç¾¤
   |                      |
   |--[1]åˆ›å»ºCRDå®šä¹‰------>|
   |                      |--[2]æ³¨å†Œæ–°èµ„æºç±»å‹
   |                      |
   |--[3]åˆ›å»ºCRå®ä¾‹------->|
   |                      |--[4]å­˜å‚¨å’Œç®¡ç†CR
   |                      |
   |--[5]æŸ¥è¯¢å’Œæ“ä½œ------->|
   |                      |--[6]è¿”å›CRçŠ¶æ€
```

**ğŸ” æ ¸å¿ƒç»„ä»¶å…³ç³»**
- **CRD**ï¼šå®šä¹‰æ–°èµ„æºçš„"æ¨¡æ¿" 
- **CR**ï¼šæ ¹æ®CRDåˆ›å»ºçš„å…·ä½“"å®ä¾‹"
- **Controller**ï¼šç®¡ç†CRçš„"å¤§ç®¡å®¶"ï¼ˆå¯é€‰ï¼‰

---

## 2. ğŸ¤” ä¸ºä»€ä¹ˆéœ€è¦CRD


### 2.1 è§£å†³å®é™…é—®é¢˜


**ğŸ”¸ åœºæ™¯1ï¼šç®¡ç†æ•°æ®åº“**
```
ä¼ ç»Ÿæ–¹å¼ï¼š
- æ‰‹åŠ¨å®‰è£…MySQL
- æ‰‹åŠ¨é…ç½®ä¸»ä»å¤åˆ¶
- æ‰‹åŠ¨å¤‡ä»½å’Œæ¢å¤
âŒ é—®é¢˜ï¼šå¤æ‚ã€æ˜“é”™ã€éš¾ç»´æŠ¤

CRDæ–¹å¼ï¼š
- å®šä¹‰MySQLèµ„æºç±»å‹
- å£°æ˜å¼é…ç½®ï¼šæˆ‘è¦ä¸€ä¸ªMySQLé›†ç¾¤
- Controllerè‡ªåŠ¨å¤„ç†æ‰€æœ‰ç»†èŠ‚
âœ… ç»“æœï¼šç®€å•ã€å¯é ã€æ˜“ç»´æŠ¤
```

**ğŸ”¸ åœºæ™¯2ï¼šåº”ç”¨éƒ¨ç½²**
```
ä½ çš„åº”ç”¨å¯èƒ½éœ€è¦ï¼š
- WebæœåŠ¡å™¨ + æ•°æ®åº“ + ç¼“å­˜ + æ¶ˆæ¯é˜Ÿåˆ—
- å¤æ‚çš„é…ç½®å’Œä¾èµ–å…³ç³»

ç”¨CRDå¯ä»¥å®šä¹‰ä¸€ä¸ª"MyApp"èµ„æºç±»å‹ï¼š
- ä¸€ä¸ªYAMLæ–‡ä»¶æè¿°æ•´ä¸ªåº”ç”¨
- Controllerè‡ªåŠ¨åˆ›å»ºæ‰€æœ‰ç»„ä»¶
- ç»Ÿä¸€ç®¡ç†ç”Ÿå‘½å‘¨æœŸ
```

### 2.2 CRDçš„ä¼˜åŠ¿


| ä¼˜åŠ¿ | è¯´æ˜ | ä¸¾ä¾‹ |
|------|------|------|
| **ğŸ¯ ç®€åŒ–æ“ä½œ** | å¤æ‚æ“ä½œå˜æˆç®€å•å£°æ˜ | `kubectl apply -f mysql-cluster.yaml` |
| **ğŸ”„ è‡ªåŠ¨åŒ–** | Controllerå¤„ç†æ‰€æœ‰ç»†èŠ‚ | è‡ªåŠ¨æ‰©ç¼©å®¹ã€æ•…éšœæ¢å¤ |
| **ğŸ“‹ æ ‡å‡†åŒ–** | ç»Ÿä¸€çš„APIå’Œæ“ä½œæ–¹å¼ | ç”¨kubectlç®¡ç†æ‰€æœ‰èµ„æº |
| **ğŸ”§ å¯å¤ç”¨** | ä¸€æ¬¡å®šä¹‰ï¼Œåˆ°å¤„ä½¿ç”¨ | ä¸åŒç¯å¢ƒéƒ¨ç½²ç›¸åŒåº”ç”¨ |

---

## 3. ğŸ“– CRDçš„æ ¸å¿ƒæ¦‚å¿µ


### 3.1 åŸºæœ¬æœ¯è¯­è§£é‡Š


**ğŸ”¸ CRDï¼ˆCustom Resource Definitionï¼‰**
```
å®šä¹‰ï¼šè‡ªå®šä¹‰èµ„æºçš„"è®¾è®¡å›¾çº¸"
ä½œç”¨ï¼šå‘Šè¯‰Kubernetesè¿™ä¸ªæ–°èµ„æºé•¿ä»€ä¹ˆæ ·
ç±»æ¯”ï¼šå°±åƒå»ºæˆ¿å­çš„å›¾çº¸ï¼Œè§„å®šæˆ¿å­çš„ç»“æ„
```

**ğŸ”¸ CRï¼ˆCustom Resourceï¼‰**
```
å®šä¹‰ï¼šæ ¹æ®CRDåˆ›å»ºçš„å…·ä½“"å®ä¾‹"
ä½œç”¨ï¼šå®é™…çš„èµ„æºå¯¹è±¡ï¼Œå¯ä»¥è¢«åˆ›å»ºã€æŸ¥è¯¢ã€ä¿®æ”¹
ç±»æ¯”ï¼šæ ¹æ®å›¾çº¸å»ºé€ çš„å…·ä½“æˆ¿å­
```

**ğŸ”¸ Controllerï¼ˆæ§åˆ¶å™¨ï¼‰**
```
å®šä¹‰ï¼šç®¡ç†CRç”Ÿå‘½å‘¨æœŸçš„"ç®¡ç†å‘˜"
ä½œç”¨ï¼šç›‘æ§CRçŠ¶æ€ï¼Œæ‰§è¡Œå®é™…çš„ä¸šåŠ¡é€»è¾‘
ç±»æ¯”ï¼šæˆ¿å­çš„ç‰©ä¸šç®¡ç†å‘˜ï¼Œè´Ÿè´£ç»´æŠ¤
```

### 3.2 CRDçš„ç»„æˆç»“æ„


**ğŸ“‹ CRDå®šä¹‰çš„ä¸»è¦éƒ¨åˆ†**
```
CRDåŒ…å«ä»€ä¹ˆï¼Ÿ
â”œâ”€â”€ èµ„æºåç§°ï¼ˆå¤æ•°å½¢å¼ï¼‰
â”œâ”€â”€ èµ„æºç»„ï¼ˆgroupï¼‰
â”œâ”€â”€ ç‰ˆæœ¬ä¿¡æ¯ï¼ˆversionï¼‰
â”œâ”€â”€ èŒƒå›´ï¼ˆé›†ç¾¤çº§åˆ«æˆ–å‘½åç©ºé—´çº§åˆ«ï¼‰
â”œâ”€â”€ å­—æ®µå®šä¹‰ï¼ˆschemaï¼‰
â”œâ”€â”€ éªŒè¯è§„åˆ™
â””â”€â”€ å­èµ„æºé…ç½®
```

**ğŸ¨ ç»“æ„ç¤ºæ„å›¾**
```
MyAppCRD
â”œâ”€â”€ metadata
â”‚   â”œâ”€â”€ name: myapps.example.com
â”‚   â””â”€â”€ ...
â”œâ”€â”€ spec
â”‚   â”œâ”€â”€ group: example.com
â”‚   â”œâ”€â”€ versions: [v1, v1beta1]
â”‚   â”œâ”€â”€ scope: Namespaced
â”‚   â””â”€â”€ schema
â”‚       â””â”€â”€ openAPIV3Schema
â””â”€â”€ status: {}
```

---

## 4. ğŸ› ï¸ åˆ›å»ºç¬¬ä¸€ä¸ªCRD


### 4.1 ç®€å•çš„CRDç¤ºä¾‹


è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç®¡ç†"ç½‘ç«™"çš„CRDï¼š

```yaml
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: websites.example.com
spec:
  group: example.com
  versions:
  - name: v1
    served: true
    storage: true
    schema:
      openAPIV3Schema:
        type: object
        properties:
          spec:
            type: object
            properties:
              url:
                type: string
              replicas:
                type: integer
                minimum: 1
                maximum: 10
  scope: Namespaced
  names:
    plural: websites
    singular: website
    kind: Website
```

### 4.2 å­—æ®µè¯¦è§£


**ğŸ” å…³é”®å­—æ®µè¯´æ˜**

| å­—æ®µ | å«ä¹‰ | ç¤ºä¾‹å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `group` | èµ„æºç»„å | `example.com` | ç±»ä¼¼å‘½åç©ºé—´ï¼Œé¿å…å†²çª |
| `versions` | APIç‰ˆæœ¬ | `v1`, `v1beta1` | æ”¯æŒç‰ˆæœ¬æ¼”è¿› |
| `scope` | ä½œç”¨èŒƒå›´ | `Namespaced` | é›†ç¾¤çº§åˆ«æˆ–å‘½åç©ºé—´çº§åˆ« |
| `names.plural` | å¤æ•°åç§° | `websites` | kubectlå‘½ä»¤ä¸­ä½¿ç”¨ |
| `names.kind` | èµ„æºç±»å‹ | `Website` | YAMLä¸­çš„kindå­—æ®µ |

### 4.3 åˆ›å»ºå’Œä½¿ç”¨CRD


**æ­¥éª¤1ï¼šåˆ›å»ºCRD**
```bash
# åº”ç”¨CRDå®šä¹‰
kubectl apply -f website-crd.yaml

# éªŒè¯CRDæ˜¯å¦åˆ›å»ºæˆåŠŸ
kubectl get crd websites.example.com
```

**æ­¥éª¤2ï¼šåˆ›å»ºCRå®ä¾‹**
```yaml
apiVersion: example.com/v1
kind: Website
metadata:
  name: my-website
  namespace: default
spec:
  url: "https://example.com"
  replicas: 3
```

**æ­¥éª¤3ï¼šç®¡ç†CR**
```bash
# åˆ›å»ºç½‘ç«™å®ä¾‹
kubectl apply -f my-website.yaml

# æŸ¥çœ‹æ‰€æœ‰ç½‘ç«™
kubectl get websites

# æŸ¥çœ‹ç‰¹å®šç½‘ç«™è¯¦æƒ…
kubectl describe website my-website
```

---

## 5. ğŸ“Š APIç‰ˆæœ¬ç®¡ç†


### 5.1 ä¸ºä»€ä¹ˆéœ€è¦ç‰ˆæœ¬ç®¡ç†


**ğŸ”„ ç‰ˆæœ¬æ¼”è¿›çš„å¿…è¦æ€§**
```
è½¯ä»¶å¼€å‘ä¸­çš„ç°å®ï¼š
- éœ€æ±‚ä¼šå˜åŒ– âœ¨
- åŠŸèƒ½è¦å‡çº§ ğŸš€  
- å­—æ®µéœ€è¦ä¿®æ”¹ ğŸ”§
- è¦ä¿æŒå‘åå…¼å®¹ â¬…ï¸

ç‰ˆæœ¬ç®¡ç†è®©ä½ å¯ä»¥å¹³æ»‘å‡çº§ï¼Œä¸å½±å“ç°æœ‰ç”¨æˆ·ï¼
```

### 5.2 ç‰ˆæœ¬é…ç½®è¯¦è§£


**ğŸ¯ å¤šç‰ˆæœ¬CRDç¤ºä¾‹**
```yaml
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: websites.example.com
spec:
  group: example.com
  versions:
  # v1ç‰ˆæœ¬ï¼ˆå½“å‰ç¨³å®šç‰ˆï¼‰
  - name: v1
    served: true      # æ˜¯å¦æä¾›APIæœåŠ¡
    storage: true     # æ˜¯å¦ä½œä¸ºå­˜å‚¨ç‰ˆæœ¬
    schema:
      openAPIV3Schema:
        type: object
        properties:
          spec:
            type: object
            properties:
              url:
                type: string
              replicas:
                type: integer
              healthCheck:  # v1æ–°å¢å­—æ®µ
                type: object
                properties:
                  enabled:
                    type: boolean
  
  # v1beta1ç‰ˆæœ¬ï¼ˆæµ‹è¯•ç‰ˆï¼‰
  - name: v1beta1
    served: true      # ä»ç„¶æœåŠ¡ï¼Œå‘åå…¼å®¹
    storage: false    # ä¸ä½œä¸ºå­˜å‚¨ç‰ˆæœ¬
    schema:
      openAPIV3Schema:
        type: object
        properties:
          spec:
            type: object
            properties:
              url:
                type: string
              replicas:
                type: integer
```

### 5.3 ç‰ˆæœ¬ç®¡ç†æœ€ä½³å®è·µ


**ğŸ“‹ ç‰ˆæœ¬å‘½åè§„èŒƒ**
- **`v1alpha1`** â†’ æ—©æœŸæµ‹è¯•ç‰ˆæœ¬ï¼ŒAPIå¯èƒ½å¤§å¹…å˜åŒ–
- **`v1beta1`** â†’ åŠŸèƒ½åŸºæœ¬ç¨³å®šï¼Œå¯èƒ½æœ‰å°è°ƒæ•´  
- **`v1`** â†’ æ­£å¼ç¨³å®šç‰ˆæœ¬ï¼Œä¿è¯å‘åå…¼å®¹

**âš¡ å­˜å‚¨ç‰ˆæœ¬è§„åˆ™**
> ğŸ’¡ **é‡è¦æé†’**ï¼šåŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªç‰ˆæœ¬è®¾ç½® `storage: true`
> 
> è¿™ä¸ªç‰ˆæœ¬å†³å®šäº†æ•°æ®åœ¨etcdä¸­çš„å­˜å‚¨æ ¼å¼

---

## 6. ğŸ”§ OpenAPIæ¨¡å¼å®šä¹‰


### 6.1 ä»€ä¹ˆæ˜¯OpenAPI Schema


**ğŸ¯ é€šä¿—ç†è§£**
```
OpenAPI Schema = æ•°æ®çš„"æ ¼å¼è¯´æ˜ä¹¦"

å°±åƒå¡«è¡¨æ ¼æ—¶çš„è¯´æ˜ï¼š
- å§“åï¼šå¿…é¡»å¡«å†™ï¼Œæ–‡æœ¬ç±»å‹
- å¹´é¾„ï¼šå¯é€‰ï¼Œæ•°å­—ç±»å‹ï¼Œ1-120ä¹‹é—´
- é‚®ç®±ï¼šå¿…é¡»å¡«å†™ï¼Œç¬¦åˆé‚®ç®±æ ¼å¼

OpenAPI Schemaå‘Šè¯‰Kubernetesï¼š
- è¿™ä¸ªå­—æ®µæ˜¯ä»€ä¹ˆç±»å‹
- æ˜¯å¦å¿…é¡»å¡«å†™
- æœ‰ä»€ä¹ˆé™åˆ¶æ¡ä»¶
```

### 6.2 å¸¸ç”¨å­—æ®µç±»å‹


**ğŸ“Š åŸºç¡€æ•°æ®ç±»å‹**

| ç±»å‹ | æè¿° | ç¤ºä¾‹ |
|------|------|------|
| `string` | æ–‡æœ¬å­—ç¬¦ä¸² | `"hello world"` |
| `integer` | æ•´æ•° | `42` |
| `number` | æ•°å­—ï¼ˆæ•´æ•°æˆ–å°æ•°ï¼‰ | `3.14` |
| `boolean` | å¸ƒå°”å€¼ | `true` / `false` |
| `array` | æ•°ç»„åˆ—è¡¨ | `["a", "b", "c"]` |
| `object` | å¯¹è±¡ï¼ˆåŒ…å«å¤šä¸ªå­—æ®µï¼‰ | `{"key": "value"}` |

### 6.3 å¤æ‚Schemaç¤ºä¾‹


**ğŸ”§ å®é™…åº”ç”¨çš„Schema**
```yaml
schema:
  openAPIV3Schema:
    type: object
    required:
    - spec
    properties:
      spec:
        type: object
        required:
        - url
        - replicas
        properties:
          # ç½‘ç«™URLï¼Œå¿…å¡«å­—ç¬¦ä¸²
          url:
            type: string
            pattern: '^https?://.+'  # æ­£åˆ™è¡¨è¾¾å¼éªŒè¯
          
          # å‰¯æœ¬æ•°é‡ï¼Œå¿…å¡«æ•´æ•°
          replicas:
            type: integer
            minimum: 1
            maximum: 100
            default: 1
          
          # èµ„æºé™åˆ¶ï¼Œå¯é€‰å¯¹è±¡
          resources:
            type: object
            properties:
              cpu:
                type: string
                pattern: '^[0-9]+m?$'  # å¦‚ï¼š100m, 1
              memory:
                type: string
                pattern: '^[0-9]+[MGT]i?$'  # å¦‚ï¼š512Mi, 1Gi
          
          # æ ‡ç­¾åˆ—è¡¨ï¼Œå¯é€‰æ•°ç»„
          labels:
            type: array
            items:
              type: string
          
          # å¥åº·æ£€æŸ¥ï¼Œå¯é€‰å¯¹è±¡
          healthCheck:
            type: object
            properties:
              enabled:
                type: boolean
                default: true
              path:
                type: string
                default: "/health"
              intervalSeconds:
                type: integer
                minimum: 10
                maximum: 300
                default: 30
```

### 6.4 SchemaéªŒè¯çš„å¥½å¤„


**âœ… è‡ªåŠ¨éªŒè¯**
- ç”¨æˆ·åˆ›å»ºCRæ—¶ï¼ŒKubernetesè‡ªåŠ¨æ£€æŸ¥æ ¼å¼
- ä¸ç¬¦åˆè¦æ±‚çš„ç›´æ¥æ‹’ç»ï¼Œé¿å…é”™è¯¯æ•°æ®

**ğŸ“‹ è‡ªåŠ¨è¡¥å…¨**
- kubectlå¯ä»¥æä¾›å­—æ®µè¡¥å…¨å»ºè®®
- IDEæ’ä»¶å¯ä»¥æ˜¾ç¤ºå­—æ®µè¯´æ˜

---

## 7. âœ… èµ„æºéªŒè¯è§„åˆ™


### 7.1 éªŒè¯è§„åˆ™çš„ä½œç”¨


**ğŸ›¡ï¸ ä¸ºä»€ä¹ˆéœ€è¦éªŒè¯**
```
æ²¡æœ‰éªŒè¯çš„åæœï¼š
âŒ ç”¨æˆ·è¾“å…¥é”™è¯¯æ•°æ®
âŒ Controllerå¤„ç†å¼‚å¸¸
âŒ ç³»ç»Ÿè¿è¡Œä¸ç¨³å®š

æœ‰éªŒè¯çš„å¥½å¤„ï¼š
âœ… æ•°æ®æ ¼å¼æ­£ç¡®
âœ… ä¸šåŠ¡é€»è¾‘å¯é 
âœ… ç”¨æˆ·ä½“éªŒå‹å¥½
```

### 7.2 å¸¸ç”¨éªŒè¯è§„åˆ™


**ğŸ”¢ æ•°å€¼éªŒè¯**
```yaml
replicas:
  type: integer
  minimum: 1        # æœ€å°å€¼
  maximum: 100      # æœ€å¤§å€¼
  multipleOf: 2     # å¿…é¡»æ˜¯2çš„å€æ•°
```

**ğŸ“ å­—ç¬¦ä¸²éªŒè¯**
```yaml
url:
  type: string
  minLength: 10     # æœ€çŸ­é•¿åº¦
  maxLength: 200    # æœ€é•¿é•¿åº¦
  pattern: '^https?://.+'  # æ­£åˆ™è¡¨è¾¾å¼

name:
  type: string
  enum:             # æšä¸¾å€¼
  - "dev"
  - "test"
  - "prod"
```

**ğŸ“Š æ•°ç»„éªŒè¯**
```yaml
ports:
  type: array
  minItems: 1       # è‡³å°‘1ä¸ªå…ƒç´ 
  maxItems: 10      # æœ€å¤š10ä¸ªå…ƒç´ 
  items:
    type: integer
    minimum: 1
    maximum: 65535
```

### 7.3 å¤æ‚éªŒè¯ç¤ºä¾‹


**ğŸ¯ å®é™…ä¸šåŠ¡éªŒè¯è§„åˆ™**
```yaml
schema:
  openAPIV3Schema:
    type: object
    properties:
      spec:
        type: object
        properties:
          # ç¯å¢ƒéªŒè¯ï¼šåªèƒ½æ˜¯æŒ‡å®šå€¼
          environment:
            type: string
            enum: ["dev", "test", "staging", "prod"]
          
          # ç«¯å£å·éªŒè¯ï¼šèŒƒå›´å’Œå”¯ä¸€æ€§
          ports:
            type: array
            minItems: 1
            maxItems: 5
            uniqueItems: true  # æ•°ç»„å…ƒç´ å¿…é¡»å”¯ä¸€
            items:
              type: integer
              minimum: 1024
              maximum: 65535
          
          # èµ„æºé…ç½®éªŒè¯
          resources:
            type: object
            properties:
              cpu:
                type: string
                # CPUæ ¼å¼ï¼š100m, 0.5, 1, 2ç­‰
                pattern: '^(\d+m|\d*\.?\d+)$'
              memory:
                type: string
                # å†…å­˜æ ¼å¼ï¼š512Mi, 1Gi, 2Tiç­‰
                pattern: '^[1-9][0-9]*[KMGT]i?$'
        
        # å¿…å¡«å­—æ®µéªŒè¯
        required:
        - environment
        - ports
        
        # æ¡ä»¶éªŒè¯ï¼šå¦‚æœæ˜¯ç”Ÿäº§ç¯å¢ƒï¼Œèµ„æºé…ç½®å¿…é¡»å¡«å†™
        if:
          properties:
            environment:
              const: "prod"
        then:
          required:
          - resources
```

---

## 8. ğŸ¯ é»˜è®¤å€¼è®¾ç½®


### 8.1 é»˜è®¤å€¼çš„ä½œç”¨


**ğŸ’¡ ä¸ºä»€ä¹ˆè®¾ç½®é»˜è®¤å€¼**
```
ç”¨æˆ·å‹å¥½æ€§ï¼š
- å‡å°‘ç”¨æˆ·é…ç½®å·¥ä½œ âš¡
- é¿å…å¿˜è®°é‡è¦é…ç½® ğŸ›¡ï¸
- æä¾›æœ€ä½³å®è·µå»ºè®® âœ¨

ç³»ç»Ÿç¨³å®šæ€§ï¼š
- ç¡®ä¿å…³é”®é…ç½®æœ‰å€¼ ğŸ”§
- å‡å°‘è¿è¡Œæ—¶é”™è¯¯ âš ï¸
- æé«˜ç³»ç»Ÿå¯é æ€§ ğŸš€
```

### 8.2 è®¾ç½®é»˜è®¤å€¼çš„æ–¹æ³•


**ğŸ”§ åœ¨Schemaä¸­è®¾ç½®é»˜è®¤å€¼**
```yaml
schema:
  openAPIV3Schema:
    type: object
    properties:
      spec:
        type: object
        properties:
          # å‰¯æœ¬æ•°é»˜è®¤ä¸º1
          replicas:
            type: integer
            minimum: 1
            default: 1
          
          # å¥åº·æ£€æŸ¥é»˜è®¤å¯ç”¨
          healthCheck:
            type: object
            properties:
              enabled:
                type: boolean
                default: true
              path:
                type: string
                default: "/health"
              intervalSeconds:
                type: integer
                default: 30
          
          # èµ„æºé™åˆ¶é»˜è®¤å€¼
          resources:
            type: object
            default:
              cpu: "100m"
              memory: "128Mi"
            properties:
              cpu:
                type: string
                default: "100m"
              memory:
                type: string
                default: "128Mi"
```

### 8.3 é»˜è®¤å€¼æœ€ä½³å®è·µ


**ğŸ“‹ æ¨èçš„é»˜è®¤å€¼ç­–ç•¥**

| é…ç½®ç±»å‹ | é»˜è®¤å€¼å»ºè®® | åŸå›  |
|----------|------------|------|
| **å‰¯æœ¬æ•°** | `1` | å•å®ä¾‹é€‚åˆå¼€å‘æµ‹è¯• |
| **èµ„æºé™åˆ¶** | è¾ƒå°å€¼ | é¿å…èµ„æºæµªè´¹ |
| **å¥åº·æ£€æŸ¥** | å¯ç”¨ | æé«˜å¯é æ€§ |
| **æ—¥å¿—çº§åˆ«** | `INFO` | å¹³è¡¡ä¿¡æ¯é‡å’Œæ€§èƒ½ |
| **è¶…æ—¶æ—¶é—´** | é€‚ä¸­å€¼ | é¿å…è¿‡é•¿ç­‰å¾… |

**âš ï¸ æ³¨æ„äº‹é¡¹**
> ğŸ’¡ **é‡è¦æé†’**ï¼šé»˜è®¤å€¼è¦è€ƒè™‘å®‰å…¨æ€§
> 
> - ä¸è¦è®¾ç½®è¿‡é«˜çš„èµ„æºé™åˆ¶
> - æ•æ„Ÿé…ç½®ä¸è¦æœ‰é»˜è®¤å€¼
> - ç”Ÿäº§ç¯å¢ƒç›¸å…³çš„é…ç½®è¦è°¨æ…

---

## 9. ğŸ”— å­èµ„æºæ”¯æŒ


### 9.1 ä»€ä¹ˆæ˜¯å­èµ„æº


**ğŸ¯ é€šä¿—ç†è§£å­èµ„æº**
```
ä¸»èµ„æº = æˆ¿å­
å­èµ„æº = æˆ¿å­çš„ç‰¹å®šåŠŸèƒ½

æ¯”å¦‚ï¼š
- /status å­èµ„æº = æˆ¿å­çš„çŠ¶æ€ä¿¡æ¯ï¼ˆæ¸©åº¦ã€æ¹¿åº¦ç­‰ï¼‰
- /scale å­èµ„æº = æˆ¿å­çš„è§„æ¨¡è°ƒæ•´ï¼ˆæˆ¿é—´æ•°é‡ï¼‰

å­èµ„æºè®©ä½ å¯ä»¥å•ç‹¬æ“ä½œèµ„æºçš„ç‰¹å®šéƒ¨åˆ†ï¼
```

### 9.2 å¸¸ç”¨å­èµ„æºç±»å‹


**ğŸ“Š Statuså­èµ„æº**
```yaml
# åœ¨CRDä¸­å¯ç”¨statuså­èµ„æº
spec:
  versions:
  - name: v1
    served: true
    storage: true
    subresources:
      status: {}  # å¯ç”¨statuså­èµ„æº
    schema:
      openAPIV3Schema:
        type: object
        properties:
          spec:
            # ... specå®šä¹‰
          status:
            type: object
            properties:
              phase:
                type: string
                enum: ["Pending", "Running", "Failed"]
              conditions:
                type: array
                items:
                  type: object
                  properties:
                    type:
                      type: string
                    status:
                      type: string
                    lastTransitionTime:
                      type: string
                      format: date-time
```

**ğŸ“ˆ Scaleå­èµ„æº**
```yaml
subresources:
  # å¯ç”¨æ‰©ç¼©å®¹å­èµ„æº
  scale:
    # specä¸­è¡¨ç¤ºå‰¯æœ¬æ•°çš„å­—æ®µè·¯å¾„
    specReplicasPath: .spec.replicas
    # statusä¸­è¡¨ç¤ºå½“å‰å‰¯æœ¬æ•°çš„å­—æ®µè·¯å¾„
    statusReplicasPath: .status.replicas
    # statusä¸­è¡¨ç¤ºé€‰æ‹©å™¨çš„å­—æ®µè·¯å¾„ï¼ˆå¯é€‰ï¼‰
    labelSelectorPath: .status.selector
```

### 9.3 å­èµ„æºçš„ä½¿ç”¨æ–¹æ³•


**ğŸ”§ æ“ä½œStatuså­èµ„æº**
```bash
# æŸ¥çœ‹èµ„æºçŠ¶æ€
kubectl get website my-website -o yaml

# æ›´æ–°çŠ¶æ€ï¼ˆé€šå¸¸ç”±Controllerå®Œæˆï¼‰
kubectl patch website my-website \
  --subresource=status \
  --type=merge \
  --patch='{"status":{"phase":"Running"}}'
```

**ğŸ“Š æ“ä½œScaleå­èµ„æº**
```bash
# æŸ¥çœ‹æ‰©ç¼©å®¹ä¿¡æ¯
kubectl get website my-website --subresource=scale

# æ‰©ç¼©å®¹æ“ä½œ
kubectl scale website my-website --replicas=5

# ä½¿ç”¨HPAè‡ªåŠ¨æ‰©ç¼©å®¹
kubectl autoscale website my-website --min=2 --max=10 --cpu-percent=50
```

### 9.4 å­èµ„æºçš„å¥½å¤„


**âœ… æƒé™æ§åˆ¶æ›´ç²¾ç»†**
```yaml
# RBACè§„åˆ™ç¤ºä¾‹ï¼šåªå…è®¸æ›´æ–°status
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: website-status-updater
rules:
- apiGroups: ["example.com"]
  resources: ["websites/status"]  # åªèƒ½æ“ä½œstatuså­èµ„æº
  verbs: ["get", "update", "patch"]
```

**ğŸš€ æ“ä½œæ›´é«˜æ•ˆ**
- æ›´æ–°statusä¸ä¼šè§¦å‘specçš„éªŒè¯
- æ‰©ç¼©å®¹æ“ä½œæ›´å¿«é€Ÿ
- å‡å°‘ä¸å¿…è¦çš„å­—æ®µä¼ è¾“

---

## 10. ğŸ¬ å®é™…åº”ç”¨åœºæ™¯


### 10.1 æ•°æ®åº“ç®¡ç†


**ğŸ—„ï¸ MySQLé›†ç¾¤CRDç¤ºä¾‹**
```yaml
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: mysqlclusters.database.example.com
spec:
  group: database.example.com
  versions:
  - name: v1
    served: true
    storage: true
    subresources:
      status: {}
      scale:
        specReplicasPath: .spec.replicas
        statusReplicasPath: .status.replicas
    schema:
      openAPIV3Schema:
        type: object
        properties:
          spec:
            type: object
            required:
            - version
            - replicas
            properties:
              version:
                type: string
                enum: ["5.7", "8.0"]
                default: "8.0"
              replicas:
                type: integer
                minimum: 1
                maximum: 9
                default: 3
              storage:
                type: object
                properties:
                  size:
                    type: string
                    pattern: '^[1-9][0-9]*[KMGT]i?$'
                    default: "10Gi"
                  storageClass:
                    type: string
          status:
            type: object
            properties:
              phase:
                type: string
                enum: ["Creating", "Running", "Scaling", "Failed"]
              readyReplicas:
                type: integer
  scope: Namespaced
  names:
    plural: mysqlclusters
    singular: mysqlcluster
    kind: MySQLCluster
```

### 10.2 åº”ç”¨éƒ¨ç½²


**ğŸš€ å¾®æœåŠ¡åº”ç”¨CRD**
```yaml
# ä½¿ç”¨CRDå®šä¹‰çš„åº”ç”¨
apiVersion: apps.example.com/v1
kind: MicroService
metadata:
  name: user-service
spec:
  image: "user-service:v1.2.0"
  replicas: 3
  database:
    type: "mysql"
    host: "mysql-cluster"
  cache:
    type: "redis"
    host: "redis-cluster"
  monitoring:
    enabled: true
    metrics:
      - "http_requests_total"
      - "http_request_duration_seconds"
```

### 10.3 é…ç½®ç®¡ç†


**âš™ï¸ ç¯å¢ƒé…ç½®CRD**
```yaml
apiVersion: config.example.com/v1
kind: Environment
metadata:
  name: production
spec:
  region: "us-west-2"
  resources:
    defaultCpu: "500m"
    defaultMemory: "1Gi"
  security:
    networkPolicy: "strict"
    podSecurityStandard: "restricted"
  monitoring:
    prometheus:
      enabled: true
      retention: "30d"
    grafana:
      enabled: true
```

---

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ CRDæœ¬è´¨ï¼šæ‰©å±•Kubernetes APIï¼Œåˆ›å»ºæ–°èµ„æºç±»å‹
ğŸ”¸ æ ¸å¿ƒç»„ä»¶ï¼šCRDå®šä¹‰ + CRå®ä¾‹ + Controllerç®¡ç†
ğŸ”¸ ç‰ˆæœ¬ç®¡ç†ï¼šæ”¯æŒAPIæ¼”è¿›ï¼Œä¿æŒå‘åå…¼å®¹
ğŸ”¸ Schemaå®šä¹‰ï¼šè§„èŒƒæ•°æ®æ ¼å¼ï¼Œæä¾›éªŒè¯å’Œé»˜è®¤å€¼
ğŸ”¸ å­èµ„æºï¼šç²¾ç»†åŒ–æ“ä½œï¼Œæé«˜æ•ˆç‡å’Œå®‰å…¨æ€§
```

### 11.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ CRD vs åŸç”Ÿèµ„æº**
```
åŸç”Ÿèµ„æºï¼ˆPodã€Serviceï¼‰ï¼š
- Kuberneteså®˜æ–¹æä¾›
- åŠŸèƒ½é€šç”¨ä½†æœ‰é™åˆ¶
- æ— æ³•æ»¡è¶³ç‰¹æ®Šéœ€æ±‚

CRDè‡ªå®šä¹‰èµ„æºï¼š
- ç”¨æˆ·è‡ªå·±å®šä¹‰
- é’ˆå¯¹ç‰¹å®šä¸šåŠ¡åœºæ™¯
- çµæ´»å¼ºå¤§ï¼Œå¯æ‰©å±•
```

**ğŸ”¹ CRDçš„ä»·å€¼**
```
æŠ€æœ¯ä»·å€¼ï¼š
âœ… APIæ ‡å‡†åŒ–ï¼šç»Ÿä¸€çš„æ“ä½œæ–¹å¼
âœ… å£°æ˜å¼ç®¡ç†ï¼šæè¿°æœŸæœ›çŠ¶æ€
âœ… è‡ªåŠ¨åŒ–è¿ç»´ï¼šControllerå¤„ç†ç»†èŠ‚

ä¸šåŠ¡ä»·å€¼ï¼š
âœ… æé«˜æ•ˆç‡ï¼šå¤æ‚æ“ä½œç®€å•åŒ–
âœ… é™ä½é—¨æ§›ï¼šè¿ç»´äººå‘˜æ˜“ä¸Šæ‰‹
âœ… è§„èŒƒç»Ÿä¸€ï¼šå›¢é˜Ÿåä½œæ›´é¡ºç•…
```

### 11.3 æœ€ä½³å®è·µå»ºè®®


**ğŸ¯ è®¾è®¡CRDçš„åŸåˆ™**
- **ç®€å•æ˜“ç”¨**ï¼šå­—æ®µåç§°è¦ç›´è§‚
- **å‘åå…¼å®¹**ï¼šç‰ˆæœ¬å‡çº§è¦å¹³æ»‘
- **éªŒè¯å®Œæ•´**ï¼šé˜²æ­¢é”™è¯¯æ•°æ®
- **æ–‡æ¡£å®Œå–„**ï¼šå­—æ®µè¯´æ˜è¦æ¸…æ™°

**âš¡ å¼€å‘å»ºè®®**
- ä»ç®€å•åœºæ™¯å¼€å§‹
- é€æ­¥æ·»åŠ å¤æ‚åŠŸèƒ½
- é‡è§†ç”¨æˆ·ä½“éªŒ
- åšå¥½é”™è¯¯å¤„ç†

**ğŸ”§ è¿ç»´å»ºè®®**
- åšå¥½ç‰ˆæœ¬è§„åˆ’
- ç›‘æ§CRDä½¿ç”¨æƒ…å†µ
- åŠæ—¶æ›´æ–°æ–‡æ¡£
- æ”¶é›†ç”¨æˆ·åé¦ˆ

### 11.4 å­¦ä¹ è·¯çº¿å»ºè®®


**ğŸ“ˆ è¿›é˜¶å­¦ä¹ è·¯å¾„**
```
ç¬¬1æ­¥ï¼šæŒæ¡CRDåŸºç¡€ âœ…
â”œâ”€â”€ ç†è§£æ¦‚å¿µå’ŒåŸç†
â”œâ”€â”€ åˆ›å»ºç®€å•çš„CRD
â””â”€â”€ å­¦ä¼šåŸºæœ¬æ“ä½œ

ç¬¬2æ­¥ï¼šå­¦ä¹ Controllerå¼€å‘
â”œâ”€â”€ ç†è§£Controlleræ¨¡å¼
â”œâ”€â”€ ä½¿ç”¨Operator SDK
â””â”€â”€ å®ç°ä¸šåŠ¡é€»è¾‘

ç¬¬3æ­¥ï¼šå®é™…é¡¹ç›®åº”ç”¨
â”œâ”€â”€ åˆ†æä¸šåŠ¡éœ€æ±‚
â”œâ”€â”€ è®¾è®¡CRDæ–¹æ¡ˆ
â””â”€â”€ å®Œæ•´é¡¹ç›®å®æ–½
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- CRDè®©ä½ æ‰©å±•Kubernetesï¼Œåˆ›é€ æ–°çš„èµ„æºç±»å‹
- Schemaå®šä¹‰ç¡®ä¿æ•°æ®æ ¼å¼æ­£ç¡®å’Œç”¨æˆ·ä½“éªŒå‹å¥½
- ç‰ˆæœ¬ç®¡ç†æ”¯æŒAPIå¹³æ»‘å‡çº§å’Œå‘åå…¼å®¹
- å­èµ„æºæä¾›æ›´ç²¾ç»†çš„æ“ä½œæ§åˆ¶å’Œæƒé™ç®¡ç†
- å®é™…åº”ç”¨ä¸­è¦æ³¨é‡ç®€å•æ˜“ç”¨å’Œä¸šåŠ¡ä»·å€¼