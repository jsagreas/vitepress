---
title: 3ã€kube-proxyç½‘ç»œä»£ç†é…ç½®
---
## ðŸ“š ç›®å½•

1. [kube-proxyæ˜¯ä»€ä¹ˆ](#1-kube-proxyæ˜¯ä»€ä¹ˆ)
2. [é…ç½®æ–‡ä»¶ä½ç½®ä¸Žç»“æž„](#2-é…ç½®æ–‡ä»¶ä½ç½®ä¸Žç»“æž„)
3. [åŸºç¡€ç½‘ç»œé…ç½®è¯¦è§£](#3-åŸºç¡€ç½‘ç»œé…ç½®è¯¦è§£)
4. [ä»£ç†æ¨¡å¼æ·±å…¥ç†è§£](#4-ä»£ç†æ¨¡å¼æ·±å…¥ç†è§£)
5. [æ€§èƒ½è°ƒä¼˜é…ç½®](#5-æ€§èƒ½è°ƒä¼˜é…ç½®)
6. [å®žæˆ˜é…ç½®ç¤ºä¾‹](#6-å®žæˆ˜é…ç½®ç¤ºä¾‹)
7. [å¸¸è§é—®é¢˜æŽ’æŸ¥](#7-å¸¸è§é—®é¢˜æŽ’æŸ¥)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ðŸŒ kube-proxyæ˜¯ä»€ä¹ˆ


### 1.1 é€šä¿—ç†è§£kube-proxy


**ðŸ¤” ç”¨ç”Ÿæ´»æ¯”å–»æ¥ç†è§£**
```
æƒ³è±¡ä½ åœ¨ä¸€ä¸ªå¤§åž‹è´­ç‰©ä¸­å¿ƒï¼š
ðŸ¢ è´­ç‰©ä¸­å¿ƒ = Kubernetesé›†ç¾¤
ðŸª å„ä¸ªå•†åº— = Podï¼ˆåº”ç”¨å®¹å™¨ï¼‰
ðŸšª å•†åº—é—¨ç‰Œå· = Serviceï¼ˆæœåŠ¡ï¼‰
ðŸ‘¨â€ðŸ’¼ å¯¼è´­å‘˜ = kube-proxy

å½“é¡¾å®¢æƒ³æ‰¾"æ˜Ÿå·´å…‹"æ—¶ï¼š
é¡¾å®¢ä¸éœ€è¦çŸ¥é“æ˜Ÿå·´å…‹åœ¨3æ¥¼ä¸œä¾§ç¬¬5ä¸ªåº—é“º
åªéœ€è¦é—®å¯¼è´­å‘˜"æ˜Ÿå·´å…‹åœ¨å“ª"
å¯¼è´­å‘˜ä¼šæŠŠé¡¾å®¢æ­£ç¡®å¼•å¯¼åˆ°æ˜Ÿå·´å…‹åº—é“º

kube-proxyå°±æ˜¯è¿™ä¸ª"å¯¼è´­å‘˜"ï¼Œè´Ÿè´£æŠŠç½‘ç»œè¯·æ±‚æ­£ç¡®è½¬å‘åˆ°å¯¹åº”çš„Pod
```

**ðŸ” æŠ€æœ¯è§’åº¦çš„å®šä¹‰**
```
kube-proxyæ˜¯Kubernetesé›†ç¾¤ä¸­çš„ç½‘ç»œä»£ç†ç»„ä»¶ï¼š
âœ… è¿è¡Œåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Š
âœ… è´Ÿè´£å®žçŽ°Serviceçš„ç½‘ç»œä»£ç†å’Œè´Ÿè½½å‡è¡¡
âœ… ç»´æŠ¤ç½‘ç»œè§„åˆ™ï¼Œè®©å¤–éƒ¨èƒ½å¤Ÿè®¿é—®åˆ°Pod
âœ… æ˜¯Podç½‘ç»œé€šä¿¡çš„"äº¤é€šè­¦å¯Ÿ"
```

### 1.2 kube-proxyçš„å·¥ä½œåŽŸç†å›¾ç¤º


```
å®¢æˆ·ç«¯è¯·æ±‚æµç¨‹ï¼š

å®¢æˆ·ç«¯                    kube-proxy                   Pod
 |                          |                          |
 |--[1] è®¿é—®Service IP----->|                          |
 |    (10.96.0.10:80)      |                          |
 |                          |--[2] æŸ¥æ‰¾Serviceè§„åˆ™---->|
 |                          |                          |
 |                          |--[3] è´Ÿè½½å‡è¡¡é€‰æ‹©Pod---->|Pod1 (192.168.1.10)
 |<--[4] è½¬å‘åˆ°å®žé™…Pod-----|                          |Pod2 (192.168.1.11)
 |    (192.168.1.10:8080)  |                          |Pod3 (192.168.1.12)
```

**ðŸ’¡ å…³é”®ç†è§£**
- Service IPæ˜¯"è™šæ‹ŸIP"ï¼Œä¸æ˜¯çœŸå®žå­˜åœ¨çš„
- kube-proxyè´Ÿè´£æŠŠè™šæ‹ŸIPè½¬æ¢ä¸ºçœŸå®žçš„Pod IP
- æ”¯æŒå¤šç§è½¬å‘æ¨¡å¼ï¼šiptablesã€IPVSã€userspace

---

## 2. ðŸ“ é…ç½®æ–‡ä»¶ä½ç½®ä¸Žç»“æž„


### 2.1 ä¸»è¦é…ç½®æ–‡ä»¶ä½ç½®


**ðŸ“ é…ç½®æ–‡ä»¶åˆ†å¸ƒ**
```
KubernetesèŠ‚ç‚¹æ–‡ä»¶ç»“æž„ï¼š

/etc/kubernetes/
â”œâ”€â”€ ðŸ“„ kube-proxy.yaml          â† ä¸»é…ç½®æ–‡ä»¶
â”œâ”€â”€ ðŸ“ pki/
â””â”€â”€ ðŸ“ manifests/

/var/lib/kube-proxy/
â”œâ”€â”€ ðŸ“„ config.conf              â† ä»£ç†é…ç½®æ–‡ä»¶
â””â”€â”€ ðŸ“„ kubeconfig.conf          â† è®¤è¯é…ç½®

/var/log/
â””â”€â”€ ðŸ“„ kube-proxy.log           â† æ—¥å¿—æ–‡ä»¶
```

### 2.2 é…ç½®æ–‡ä»¶çš„å±‚æ¬¡å…³ç³»


```
é…ç½®ä¼˜å…ˆçº§å…³ç³»ï¼š

å‘½ä»¤è¡Œå‚æ•° (æœ€é«˜ä¼˜å…ˆçº§)
    â†“
/etc/kubernetes/kube-proxy.yaml
    â†“  
/var/lib/kube-proxy/config.conf (æœ€ä½Žä¼˜å…ˆçº§)
```

**ðŸ”§ å®žé™…æŸ¥çœ‹é…ç½®æ–‡ä»¶**
```bash
# æŸ¥çœ‹ä¸»é…ç½®æ–‡ä»¶
sudo cat /etc/kubernetes/kube-proxy.yaml

# æŸ¥çœ‹è¿è¡Œæ—¶é…ç½®
sudo cat /var/lib/kube-proxy/config.conf

# æŸ¥çœ‹è¿è¡ŒçŠ¶æ€
sudo systemctl status kube-proxy
```

### 2.3 é…ç½®æ–‡ä»¶åŸºæœ¬ç»“æž„é¢„è§ˆ


**ðŸ“‹ å…¸åž‹é…ç½®æ–‡ä»¶ç»“æž„**
```yaml
# /etc/kubernetes/kube-proxy.yaml
apiVersion: kubeproxy.config.k8s.io/v1alpha1
kind: KubeProxyConfiguration
# åŸºç¡€é…ç½®åŒºåŸŸ
bindAddress: 0.0.0.0
clientConnection: {...}
# é›†ç¾¤ç½‘ç»œé…ç½®åŒºåŸŸ  
clusterCIDR: "10.244.0.0/16"
configSyncPeriod: 15m0s
# ä»£ç†æ¨¡å¼é…ç½®åŒºåŸŸ
mode: "iptables"
iptables: {...}
ipvs: {...}
# æ€§èƒ½è°ƒä¼˜åŒºåŸŸ
conntrack: {...}
nodePortAddresses: [...]
```

---

## 3. ðŸ”§ åŸºç¡€ç½‘ç»œé…ç½®è¯¦è§£


### 3.1 bindAddress - ç»‘å®šåœ°å€é…ç½®


**ðŸ“ ä»€ä¹ˆæ˜¯bindAddress**
```
bindAddresså†³å®škube-proxyç›‘å¬åœ¨å“ªä¸ªç½‘ç»œæŽ¥å£ä¸Š

ç”Ÿæ´»æ¯”å–»ï¼š
ðŸ  ä½ å®¶æœ‰å¤šä¸ªé—¨ï¼ˆå‰é—¨ã€åŽé—¨ã€ä¾§é—¨ï¼‰
ðŸšª bindAddresså°±æ˜¯å†³å®škube-proxyåœ¨å“ªä¸ª"é—¨"ç­‰å®¢æˆ·
ðŸ“¬ 0.0.0.0 = åœ¨æ‰€æœ‰é—¨éƒ½ç­‰ç€
ðŸ  192.168.1.100 = åªåœ¨å‰é—¨ç­‰ç€
```

**âš™ï¸ é…ç½®è¯¦è§£**

| bindAddresså€¼ | å«ä¹‰ | é€‚ç”¨åœºæ™¯ | å®‰å…¨æ€§ |
|---------------|------|----------|---------|
| `0.0.0.0` | ç›‘å¬æ‰€æœ‰ç½‘ç»œæŽ¥å£ | **é€šç”¨é…ç½®** | âš ï¸ ä¸­ç­‰ |
| `127.0.0.1` | åªç›‘å¬æœ¬æœºå›žçŽ¯ | æµ‹è¯•çŽ¯å¢ƒ | ðŸ”’ é«˜ |
| `192.168.1.100` | ç›‘å¬æŒ‡å®šIP | å¤šç½‘å¡çŽ¯å¢ƒ | ðŸ”’ é«˜ |

**ðŸ’» å®žé™…é…ç½®ç¤ºä¾‹**
```yaml
# æŽ¨èé…ç½®ï¼šç›‘å¬æ‰€æœ‰æŽ¥å£ï¼ˆç”Ÿäº§çŽ¯å¢ƒå¸¸ç”¨ï¼‰
bindAddress: 0.0.0.0

# å®‰å…¨é…ç½®ï¼šåªç›‘å¬å†…ç½‘æŽ¥å£
bindAddress: 192.168.1.100  # æ›¿æ¢ä¸ºå®žé™…å†…ç½‘IP

# æµ‹è¯•é…ç½®ï¼šåªç›‘å¬æœ¬æœº
bindAddress: 127.0.0.1
```

### 3.2 clusterCIDR - é›†ç¾¤ç½‘ç»œæ®µé…ç½®


**ðŸŒ ä»€ä¹ˆæ˜¯CIDR**
```
CIDR = æ— ç±»åˆ«åŸŸé—´è·¯ç”±ï¼ˆClassless Inter-Domain Routingï¼‰

é€šä¿—ç†è§£ï¼š
ðŸ˜ï¸ æƒ³è±¡ä¸€ä¸ªå¤§åž‹ä½å®…åŒºï¼ˆKubernetesé›†ç¾¤ï¼‰
ðŸ  æ¯æ ‹æˆ¿å­éƒ½æœ‰åœ°å€ï¼ˆPod IPï¼‰
ðŸ“® clusterCIDRå°±æ˜¯æ•´ä¸ªä½å®…åŒºçš„åœ°å€èŒƒå›´

ç¤ºä¾‹ï¼š10.244.0.0/16
â”œâ”€ 10.244.0.0 æ˜¯èµ·å§‹åœ°å€
â”œâ”€ /16 è¡¨ç¤ºå‰16ä½å›ºå®šï¼ŒåŽ16ä½å¯å˜
â””â”€ æ€»å…±å¯å®¹çº³ 65534 ä¸ªåœ°å€
```

**ðŸ“Š å¸¸ç”¨CIDRé…ç½®å¯¹æ¯”**

| CIDRèŒƒå›´ | å¯ç”¨IPæ•°é‡ | é€‚ç”¨è§„æ¨¡ | ä½¿ç”¨åœºæ™¯ |
|----------|------------|----------|----------|
| `10.244.0.0/16` | 65,534 | å¤§åž‹é›†ç¾¤ | ç”Ÿäº§çŽ¯å¢ƒ |
| `172.16.0.0/16` | 65,534 | å¤§åž‹é›†ç¾¤ | ä¼ä¸šå†…ç½‘ |
| `192.168.0.0/16` | 65,534 | ä¸­åž‹é›†ç¾¤ | æµ‹è¯•çŽ¯å¢ƒ |
| `10.0.0.0/8` | 16,777,214 | è¶…å¤§é›†ç¾¤ | äº‘åŽŸç”Ÿå¹³å° |

**âš™ï¸ é…ç½®æ³¨æ„äº‹é¡¹**
```yaml
# åŸºæœ¬é…ç½®
clusterCIDR: "10.244.0.0/16"

# âš ï¸ é‡è¦æé†’
# 1. CIDRå¿…é¡»ä¸ŽCNIç½‘ç»œæ’ä»¶é…ç½®ä¸€è‡´
# 2. ä¸èƒ½ä¸ŽçŽ°æœ‰ç½‘ç»œå†²çª
# 3. ä¿®æ”¹éœ€è¦é‡å¯æ•´ä¸ªé›†ç¾¤
```

### 3.3 clientConnection - å®¢æˆ·ç«¯è¿žæŽ¥é…ç½®


**ðŸ”— è¿žæŽ¥é…ç½®å‚æ•°è¯¦è§£**
```yaml
clientConnection:
  # è¿žæŽ¥API Serverçš„é…ç½®æ–‡ä»¶ä½ç½®
  kubeconfig: "/var/lib/kube-proxy/kubeconfig.conf"
  # åŒæ—¶æŽ¥å—çš„è¯·æ±‚æ•°é‡
  acceptContentTypes: ""
  # å†…å®¹ç±»åž‹
  contentType: "application/vnd.kubernetes.protobuf"  
  # QPSé™åˆ¶ï¼ˆæ¯ç§’æŸ¥è¯¢æ•°ï¼‰
  qps: 5
  # çªå‘è¯·æ±‚æ•°
  burst: 10
```

**âš¡ æ€§èƒ½è°ƒä¼˜å»ºè®®**

| é›†ç¾¤è§„æ¨¡ | QPSæŽ¨èå€¼ | BurstæŽ¨èå€¼ | è¯´æ˜Ž |
|----------|-----------|-------------|------|
| å°åž‹(< 50èŠ‚ç‚¹) | 5 | 10 | é»˜è®¤é…ç½® |
| ä¸­åž‹(50-200èŠ‚ç‚¹) | 10 | 20 | é€‚åº¦æå‡ |
| å¤§åž‹(200+èŠ‚ç‚¹) | 20 | 30 | é«˜æ€§èƒ½é…ç½® |

---

## 4. ðŸš€ ä»£ç†æ¨¡å¼æ·±å…¥ç†è§£


### 4.1 ä¸‰ç§ä»£ç†æ¨¡å¼å¯¹æ¯”


**ðŸ“Š ä»£ç†æ¨¡å¼å…¨é¢å¯¹æ¯”**

| ç‰¹æ€§å¯¹æ¯” | userspace | iptables | IPVS |
|----------|-----------|----------|------|
| **æ€§èƒ½** | â­â­ è¾ƒæ…¢ | â­â­â­â­ å¿« | â­â­â­â­â­ æœ€å¿« |
| **ç¨³å®šæ€§** | â­â­â­ ä¸€èˆ¬ | â­â­â­â­â­ å¾ˆç¨³å®š | â­â­â­â­ ç¨³å®š |
| **è´Ÿè½½å‡è¡¡** | éšæœº | éšæœº | å¤šç§ç®—æ³• |
| **é€‚ç”¨è§„æ¨¡** | å°åž‹ | ä¸­å¤§åž‹ | å¤§åž‹/è¶…å¤§åž‹ |
| **K8sæŽ¨è** | âŒ å·²å¼ƒç”¨ | âœ… é»˜è®¤æŽ¨è | ðŸš€ é«˜æ€§èƒ½é¦–é€‰ |

### 4.2 iptablesæ¨¡å¼è¯¦è§£ï¼ˆæŽ¨èï¼‰


**ðŸ”§ iptablesæ¨¡å¼åŽŸç†å›¾**
```
iptablesè§„åˆ™é“¾è·¯å›¾ï¼š

å®¢æˆ·ç«¯è¯·æ±‚ â†’ PREROUTINGé“¾ â†’ KUBE-SERVICESé“¾ â†’ KUBE-SVC-XXXé“¾ â†’ KUBE-SEP-XXXé“¾ â†’ Pod

å…·ä½“æµç¨‹ï¼š
1ï¸âƒ£ å®¢æˆ·ç«¯è®¿é—® Service IP:Port
2ï¸âƒ£ PREROUTING æ•èŽ·æ•°æ®åŒ…
3ï¸âƒ£ KUBE-SERVICES åŒ¹é…Serviceè§„åˆ™  
4ï¸âƒ£ KUBE-SVC-XXX é€‰æ‹©Endpoint
5ï¸âƒ£ KUBE-SEP-XXX è½¬å‘åˆ°å…·ä½“Pod
6ï¸âƒ£ æ•°æ®åŒ…åˆ°è¾¾ç›®æ ‡Pod
```

**âš™ï¸ iptablesæ¨¡å¼é…ç½®**
```yaml
mode: "iptables"
iptables:
  # ä¼ªè£…æ‰€æœ‰æµé‡ï¼ˆé‡è¦ï¼ï¼‰
  masqueradeAll: false
  # ä¼ªè£…ä½æ ‡è®°
  masqueradeBit: 14  
  # æœ€å°åŒæ­¥å‘¨æœŸ
  minSyncPeriod: 0s
  # å®Œæ•´åŒæ­¥å‘¨æœŸ  
  syncPeriod: 30s
```

**ðŸ’¡ å…³é”®å‚æ•°è¯´æ˜Ž**

| å‚æ•° | ä½œç”¨ | æŽ¨èå€¼ | æ³¨æ„äº‹é¡¹ |
|------|------|--------|----------|
| `masqueradeAll` | æ˜¯å¦ä¼ªè£…æ‰€æœ‰æµé‡ | `false` | trueä¼šå¢žåŠ å¼€é”€ |
| `masqueradeBit` | MARKæ ‡è®°ä½ | `14` | é¿å…ä¸Žå…¶ä»–ç¨‹åºå†²çª |
| `syncPeriod` | è§„åˆ™åŒæ­¥å‘¨æœŸ | `30s` | å¤ªçŸ­å½±å“æ€§èƒ½ |

### 4.3 IPVSæ¨¡å¼è¯¦è§£ï¼ˆé«˜æ€§èƒ½ï¼‰


**ðŸš€ IPVSæ¨¡å¼ä¼˜åŠ¿**
```
IPVS = IP Virtual Serverï¼ˆIPè™šæ‹ŸæœåŠ¡å™¨ï¼‰

ç›¸æ¯”iptablesçš„ä¼˜åŠ¿ï¼š
âœ… æ›´å¥½çš„æ€§èƒ½ï¼šåŸºäºŽå†…æ ¸Hashè¡¨ï¼ŒO(1)å¤æ‚åº¦
âœ… ä¸°å¯Œçš„è´Ÿè½½å‡è¡¡ç®—æ³•ï¼šrr/lc/dh/sh/sed/nq
âœ… æ›´å¥½çš„æ‰©å±•æ€§ï¼šæ”¯æŒæ•°ä¸‡ä¸ªService
âœ… æ›´å¹³æ»‘çš„è´Ÿè½½å‡è¡¡
```

**âš™ï¸ IPVSé…ç½®è¯¦è§£**
```yaml
mode: "ipvs"
ipvs:
  # è´Ÿè½½å‡è¡¡ç®—æ³•
  scheduler: "rr"          # è½®è¯¢ï¼ˆæŽ¨èï¼‰
  # æŽ’é™¤çš„ç½‘æ®µ
  excludeCIDRs: []         # é€šå¸¸ä¸ºç©º
  # ä¸¥æ ¼ARPæ¨¡å¼
  strictARP: false
  # TCPè¶…æ—¶æ—¶é—´
  tcpTimeout: 0s
  # TCPå…³é—­è¶…æ—¶
  tcpFinTimeout: 0s  
  # UDPè¶…æ—¶æ—¶é—´
  udpTimeout: 0s
```

**ðŸŽ¯ IPVSè´Ÿè½½å‡è¡¡ç®—æ³•é€‰æ‹©**

| ç®—æ³•ä»£ç  | ç®—æ³•åç§° | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|----------|----------|------|----------|
| `rr` | è½®è¯¢ | å¹³å‡åˆ†é… | **é€šç”¨æŽ¨è** |
| `lc` | æœ€å°‘è¿žæŽ¥ | æ™ºèƒ½åˆ†é… | é•¿è¿žæŽ¥åº”ç”¨ |
| `dh` | ç›®æ ‡å“ˆå¸Œ | ä¼šè¯ä¿æŒ | æœ‰çŠ¶æ€åº”ç”¨ |
| `sh` | æºå“ˆå¸Œ | å®¢æˆ·ç«¯å›ºå®š | ç¼“å­˜åº”ç”¨ |

---

## 5. âš¡ æ€§èƒ½è°ƒä¼˜é…ç½®


### 5.1 è¿žæŽ¥è·Ÿè¸ªä¼˜åŒ–


**ðŸ” conntrackå‚æ•°è¯¦è§£**
```yaml
conntrack:
  # æœ€å¤§è¿žæŽ¥è·Ÿè¸ªæ•°
  maxPerCore: 32768
  # æœ€å°å€¼
  min: 131072  
  # TCPè¿žæŽ¥å»ºç«‹è¶…æ—¶
  tcpEstablishedTimeout: 24h0m0s
  # TCPå…³é—­ç­‰å¾…è¶…æ—¶
  tcpCloseWaitTimeout: 1h0m0s
```

**ðŸ“Š ä¸åŒè§„æ¨¡çš„conntracké…ç½®å»ºè®®**

| é›†ç¾¤è§„æ¨¡ | maxPerCore | min | tcpEstablishedTimeout |
|----------|------------|-----|----------------------|
| å°åž‹ | 16384 | 65536 | 12h |
| ä¸­åž‹ | 32768 | 131072 | 24h |
| å¤§åž‹ | 65536 | 262144 | 24h |

### 5.2 ç«¯å£å’Œåœ°å€é…ç½®


**ðŸ”Œ nodePortAddressesé…ç½®**
```yaml
# é™åˆ¶NodePortç›‘å¬çš„åœ°å€èŒƒå›´
nodePortAddresses: 
  - "0.0.0.0/0"          # ç›‘å¬æ‰€æœ‰åœ°å€ï¼ˆé»˜è®¤ï¼‰
  # - "192.168.1.0/24"   # åªç›‘å¬å†…ç½‘æ®µ
  # - "10.0.0.0/8"       # åªç›‘å¬æŒ‡å®šç½‘æ®µ
```

**ðŸ“Š ç«¯å£èŒƒå›´é…ç½®**
```yaml
# NodePortç«¯å£èŒƒå›´
portRange: "30000-32767"     # é»˜è®¤èŒƒå›´
# portRange: "30000-40000"   # æ‰©å¤§èŒƒå›´ï¼ˆå¦‚éœ€è¦ï¼‰
```

### 5.3 ç³»ç»Ÿä¼˜åŒ–å‚æ•°


**ðŸ”§ ç³»ç»Ÿçº§åˆ«ä¼˜åŒ–**
```yaml
# OOMåˆ†æ•°è°ƒæ•´ï¼ˆæ•°å€¼è¶Šä½Žè¶Šä¸å®¹æ˜“è¢«æ€æ­»ï¼‰
oomScoreAdj: -999

# é…ç½®åŒæ­¥å‘¨æœŸ
configSyncPeriod: 15m0s      # é»˜è®¤15åˆ†é’Ÿ

# UDPç©ºé—²è¶…æ—¶
udpIdleTimeout: 250ms        # UDPè¿žæŽ¥è¶…æ—¶
```

---

## 6. ðŸ› ï¸ å®žæˆ˜é…ç½®ç¤ºä¾‹


### 6.1 ç”Ÿäº§çŽ¯å¢ƒæŽ¨èé…ç½®


```yaml
# /etc/kubernetes/kube-proxy.yaml
apiVersion: kubeproxy.config.k8s.io/v1alpha1
kind: KubeProxyConfiguration

# åŸºç¡€ç½‘ç»œé…ç½®
bindAddress: 0.0.0.0
clusterCIDR: "10.244.0.0/16"

# å®¢æˆ·ç«¯è¿žæŽ¥ä¼˜åŒ–
clientConnection:
  kubeconfig: "/var/lib/kube-proxy/kubeconfig.conf"
  qps: 10                    # ä¸­ç­‰QPS
  burst: 20                  # é€‚å½“çªå‘

# ä½¿ç”¨IPVSé«˜æ€§èƒ½æ¨¡å¼
mode: "ipvs"
ipvs:
  scheduler: "rr"            # è½®è¯¢ç®—æ³•
  strictARP: true            # å¯ç”¨ä¸¥æ ¼ARP

# è¿žæŽ¥è·Ÿè¸ªä¼˜åŒ–
conntrack:
  maxPerCore: 32768
  min: 131072
  tcpEstablishedTimeout: 24h0m0s

# NodePorté…ç½®
nodePortAddresses: ["0.0.0.0/0"]
portRange: "30000-32767"

# ç³»ç»Ÿä¼˜åŒ–
oomScoreAdj: -999
configSyncPeriod: 15m0s
udpIdleTimeout: 250ms
```

### 6.2 å°åž‹é›†ç¾¤é…ç½®


```yaml
# é€‚åˆæµ‹è¯•çŽ¯å¢ƒæˆ–å°åž‹é›†ç¾¤
apiVersion: kubeproxy.config.k8s.io/v1alpha1
kind: KubeProxyConfiguration

bindAddress: 0.0.0.0
clusterCIDR: "192.168.0.0/16"

clientConnection:
  kubeconfig: "/var/lib/kube-proxy/kubeconfig.conf"
  qps: 5                     # è¾ƒä½ŽQPS
  burst: 10

# ä½¿ç”¨iptablesæ¨¡å¼ï¼ˆæ›´ç¨³å®šï¼‰
mode: "iptables"
iptables:
  masqueradeAll: false
  syncPeriod: 30s

# è¾ƒå°çš„è¿žæŽ¥è·Ÿè¸ª
conntrack:
  maxPerCore: 16384
  min: 65536

nodePortAddresses: ["0.0.0.0/0"]
oomScoreAdj: -999
```

### 6.3 é«˜æ€§èƒ½å¤§åž‹é›†ç¾¤é…ç½®


```yaml
# é€‚åˆå¤§åž‹ç”Ÿäº§é›†ç¾¤
apiVersion: kubeproxy.config.k8s.io/v1alpha1
kind: KubeProxyConfiguration

bindAddress: 0.0.0.0
clusterCIDR: "10.0.0.0/8"    # æ›´å¤§çš„åœ°å€ç©ºé—´

clientConnection:
  kubeconfig: "/var/lib/kube-proxy/kubeconfig.conf"
  qps: 20                    # é«˜QPS
  burst: 30                  # å¤§çªå‘

# IPVSé«˜æ€§èƒ½æ¨¡å¼
mode: "ipvs"
ipvs:
  scheduler: "rr"
  strictARP: true
  tcpTimeout: 900s           # 15åˆ†é’ŸTCPè¶…æ—¶
  udpTimeout: 300s           # 5åˆ†é’ŸUDPè¶…æ—¶

# å¤§åž‹é›†ç¾¤è¿žæŽ¥è·Ÿè¸ª
conntrack:
  maxPerCore: 65536          # æ›´å¤§çš„è·Ÿè¸ªè¡¨
  min: 262144
  tcpEstablishedTimeout: 24h0m0s

nodePortAddresses: ["0.0.0.0/0"]
portRange: "30000-40000"     # æ›´å¤§çš„ç«¯å£èŒƒå›´
oomScoreAdj: -999
configSyncPeriod: 10m0s      # æ›´é¢‘ç¹çš„åŒæ­¥
```

---

## 7. ðŸš¨ å¸¸è§é—®é¢˜æŽ’æŸ¥


### 7.1 Serviceæ— æ³•è®¿é—®é—®é¢˜


**ðŸ” é—®é¢˜è¯Šæ–­æ­¥éª¤**

**æ­¥éª¤ 1ï¸âƒ£ï¼š** æ£€æŸ¥kube-proxyè¿è¡ŒçŠ¶æ€
```bash
# æ£€æŸ¥kube-proxy PodçŠ¶æ€
kubectl get pods -n kube-system | grep kube-proxy

# æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
kubectl describe pod kube-proxy-xxxxx -n kube-system

# æŸ¥çœ‹æ—¥å¿—
kubectl logs kube-proxy-xxxxx -n kube-system
```

**æ­¥éª¤ 2ï¸âƒ£ï¼š** éªŒè¯Serviceå’ŒEndpoints
```bash
# æ£€æŸ¥Serviceé…ç½®
kubectl get svc my-service -o yaml

# æ£€æŸ¥Endpoints
kubectl get endpoints my-service

# åº”è¯¥çœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼š
# NAME         ENDPOINTS                     AGE
# my-service   10.244.1.10:8080,10.244.2.11:8080   5m
```

**æ­¥éª¤ 3ï¸âƒ£ï¼š** æ£€æŸ¥ç½‘ç»œè§„åˆ™
```bash
# æ£€æŸ¥iptablesè§„åˆ™ï¼ˆiptablesæ¨¡å¼ï¼‰
sudo iptables -t nat -L | grep my-service

# æ£€æŸ¥IPVSè§„åˆ™ï¼ˆIPVSæ¨¡å¼ï¼‰
sudo ipvsadm -L -n
```

### 7.2 é…ç½®æ–‡ä»¶é”™è¯¯å¤„ç†


**âš ï¸ å¸¸è§é…ç½®é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ**

| é”™è¯¯çŽ°è±¡ | å¯èƒ½åŽŸå›  | è§£å†³æ–¹æ¡ˆ |
|----------|----------|----------|
| Podæ— æ³•å¯åŠ¨ | YAMLè¯­æ³•é”™è¯¯ | `kubectl apply --dry-run=client` |
| ç½‘ç»œä¸é€š | CIDRé…ç½®é”™è¯¯ | æ£€æŸ¥ä¸ŽCNIæ’ä»¶ä¸€è‡´æ€§ |
| æ€§èƒ½é—®é¢˜ | QPSè®¾ç½®è¿‡ä½Ž | é€‚å½“è°ƒæ•´qpså’Œburst |
| è¿žæŽ¥è¶…æ—¶ | conntrackå‚æ•°ä¸å½“ | å¢žå¤§è¿žæŽ¥è·Ÿè¸ªæ•°é‡ |

### 7.3 æ—¥å¿—åˆ†æžæŒ‡å—


**ðŸ“‹ é‡è¦æ—¥å¿—å…³é”®è¯**
```bash
# æŸ¥çœ‹kube-proxyæ—¥å¿—
kubectl logs kube-proxy-xxxxx -n kube-system | grep -E "(ERROR|WARNING)"

# é‡è¦æ—¥å¿—æ¨¡å¼ï¼š
âœ… "Successfully retrieved node IP"     # èŠ‚ç‚¹IPèŽ·å–æˆåŠŸ
âš ï¸  "Failed to list services"          # Serviceåˆ—è¡¨èŽ·å–å¤±è´¥  
âŒ "Error updating iptables"            # iptablesæ›´æ–°å¤±è´¥
ðŸ” "Syncing proxy rules"               # ä»£ç†è§„åˆ™åŒæ­¥
```

---

## 8. ðŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŽŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ðŸ”¸ kube-proxyä½œç”¨ï¼šKubernetesé›†ç¾¤çš„"ç½‘ç»œäº¤é€šè­¦å¯Ÿ"
ðŸ”¸ ä¸‰ç§ä»£ç†æ¨¡å¼ï¼šuserspace(å¼ƒç”¨) < iptables(æŽ¨è) < IPVS(é«˜æ€§èƒ½)  
ðŸ”¸ æ ¸å¿ƒé…ç½®ï¼šbindAddressã€clusterCIDRã€modeã€è¿žæŽ¥å‚æ•°
ðŸ”¸ æ€§èƒ½è°ƒä¼˜ï¼šconntrackã€QPSã€åŒæ­¥å‘¨æœŸã€ç«¯å£èŒƒå›´
ðŸ”¸ æ•…éšœæŽ’æŸ¥ï¼šæ—¥å¿—åˆ†æžã€è§„åˆ™æ£€æŸ¥ã€è¿žé€šæ€§æµ‹è¯•
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ðŸ”¹ ä»£ç†æ¨¡å¼é€‰æ‹©ç­–ç•¥**
```
å°åž‹é›†ç¾¤ï¼ˆ<50èŠ‚ç‚¹ï¼‰ï¼š
â†’ iptablesæ¨¡å¼ï¼Œç¨³å®šå¯é 

ä¸­åž‹é›†ç¾¤ï¼ˆ50-200èŠ‚ç‚¹ï¼‰ï¼š  
â†’ iptablesæˆ–IPVSï¼Œæ ¹æ®éœ€æ±‚é€‰æ‹©

å¤§åž‹é›†ç¾¤ï¼ˆ200+èŠ‚ç‚¹ï¼‰ï¼š
â†’ IPVSæ¨¡å¼ï¼Œæ€§èƒ½æœ€ä½³
```

**ðŸ”¹ é…ç½®ä¼˜åŒ–åŽŸåˆ™**
```
å®‰å…¨ä¼˜å…ˆï¼š
- åˆç†è®¾ç½®bindAddress
- é™åˆ¶nodePortAddressesèŒƒå›´

æ€§èƒ½ä¼˜åŒ–ï¼š
- æ ¹æ®è§„æ¨¡è°ƒæ•´QPSå’Œburst  
- ä¼˜åŒ–conntrackå‚æ•°
- é€‰æ‹©åˆé€‚çš„åŒæ­¥å‘¨æœŸ

ç¨³å®šä¿éšœï¼š
- è®¾ç½®åˆç†çš„OOMåˆ†æ•°
- ç›‘æŽ§æ—¥å¿—å’ŒæŒ‡æ ‡
- å®šæœŸå¤‡ä»½é…ç½®æ–‡ä»¶
```

### 8.3 ç”Ÿäº§çŽ¯å¢ƒæœ€ä½³å®žè·µ


**ðŸŽ¯ éƒ¨ç½²å»ºè®®**
- **é…ç½®å¤‡ä»½**ï¼šå®šæœŸå¤‡ä»½é…ç½®æ–‡ä»¶åˆ°ç‰ˆæœ¬æŽ§åˆ¶ç³»ç»Ÿ
- **æ¸è¿›æ›´æ–°**ï¼šé…ç½®å˜æ›´å…ˆåœ¨æµ‹è¯•çŽ¯å¢ƒéªŒè¯
- **ç›‘æŽ§å‘Šè­¦**ï¼šè®¾ç½®kube-proxyå¥åº·æ£€æŸ¥å’Œå‘Šè­¦
- **æ–‡æ¡£è®°å½•**ï¼šè®°å½•æ¯æ¬¡é…ç½®å˜æ›´çš„åŽŸå› å’Œå½±å“

**ðŸ”§ è¿ç»´è¦ç‚¹**
- **å®šæœŸå·¡æ£€**ï¼šæ£€æŸ¥kube-proxyè¿è¡ŒçŠ¶æ€å’Œæ€§èƒ½æŒ‡æ ‡
- **æ—¥å¿—æ¸…ç†**ï¼šå®šæœŸæ¸…ç†å’Œè½®è½¬æ—¥å¿—æ–‡ä»¶
- **ç‰ˆæœ¬ç®¡ç†**ï¼šè·Ÿè¸ªKubernetesç‰ˆæœ¬å¯¹kube-proxyçš„å½±å“
- **åº”æ€¥é¢„æ¡ˆ**ï¼šå‡†å¤‡kube-proxyæ•…éšœçš„åº”æ€¥å¤„ç†æ–¹æ¡ˆ

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- *kube-proxyç½‘ç»œä»£ç†ï¼Œä¸‰ç§æ¨¡å¼è¦é€‰å¯¹*
- *iptablesç¨³å®šIPVSå¿«ï¼Œé…ç½®å‚æ•°è°ƒä¼˜åŒ–*  
- *ç»‘å®šåœ°å€CIDRæ®µï¼Œè¿žæŽ¥è·Ÿè¸ªæ€§èƒ½å…³*
- *ç”Ÿäº§çŽ¯å¢ƒé‡ç›‘æŽ§ï¼Œæ—¥å¿—åˆ†æžæŽ’æ•…éšœ*