---
title: 2、kubelet节点配置文件
---
## 📚 目录

1. [kubelet是什么](#1-kubelet是什么)
2. [kubelet配置文件位置与作用](#2-kubelet配置文件位置与作用)
3. [核心网络通信配置](#3-核心网络通信配置)
4. [安全认证与授权配置](#4-安全认证与授权配置)
5. [集群DNS与网络配置](#5-集群dns与网络配置)
6. [资源限制与性能配置](#6-资源限制与性能配置)
7. [镜像管理与垃圾回收](#7-镜像管理与垃圾回收)
8. [节点健康监控配置](#8-节点健康监控配置)
9. [完整配置示例](#9-完整配置示例)
10. [核心要点总结](#10-核心要点总结)

---

## 1. 🤖 kubelet是什么


### 1.1 kubelet的通俗理解

想象一下，Kubernetes集群就像一个大型的**物业管理公司**，每个节点（服务器）就是一栋**公寓楼**，而kubelet就是这栋楼的**楼管大爷**。

```
Kubernetes集群架构：
┌─────────────────────────────────────────────────┐
│                  Master节点                     │
│              （总管理中心）                      │ 
└─────────────────┬───────────────────────────────┘
                  │
      ┌───────────┼───────────┐
      │           │           │
  ┌───▼───┐   ┌───▼───┐   ┌───▼───┐
  │Node1  │   │Node2  │   │Node3  │
  │kubelet│   │kubelet│   │kubelet│
  │(楼管) │   │(楼管) │   │(楼管) │
  └───────┘   └───────┘   └───────┘
```

**kubelet的主要职责**：
- 🏠 **管理Pod** - 就像楼管负责管理每个房间的住户
- 📡 **与Master通信** - 定期向总部汇报楼内情况
- 🔍 **健康检查** - 检查住户（容器）是否正常
- 📦 **拉取镜像** - 为新住户准备房间设施
- 🧹 **垃圾回收** - 清理不用的镜像和容器

### 1.2 kubelet工作原理

kubelet是每个Node节点上的**核心组件**，它：

| 职能 | **具体作用** | **类比说明** |
|------|-------------|-------------|
| 🎯 **Pod管理** | `创建、启动、停止Pod` | `楼管安排住户入住和搬离` |
| 📊 **状态汇报** | `向Master汇报节点和Pod状态` | `向总部报告楼内情况` |
| 🔄 **健康监控** | `执行存活性和就绪性探针` | `定期巡查住户安全` |
| 💾 **资源管理** | `管理节点的CPU、内存、存储` | `分配楼内水电资源` |

---

## 2. 📁 kubelet配置文件位置与作用


### 2.1 配置文件的位置

kubelet配置文件就像楼管的**工作手册**，告诉它该如何工作。

**🔸 常见配置文件路径**：
```bash
# 主要配置文件位置
/var/lib/kubelet/config.yaml                    # 最常用位置
/etc/kubernetes/kubelet/kubelet-config.yaml     # 有些发行版使用
/etc/kubelet/kubelet-config.yaml               # 另一种常见位置
```

**🔸 配置文件的作用**：
- 📋 **定义工作规则** - 告诉kubelet如何工作
- 🔧 **设置参数** - 配置各种工作参数
- 🛡️ **安全设置** - 配置认证和授权
- 🌐 **网络配置** - 设置网络相关参数

### 2.2 配置文件的重要性

```
没有配置文件的kubelet = 没有工作手册的楼管
✗ 不知道管理规则
✗ 不知道安全要求  
✗ 不知道联系方式
✗ 不知道工作标准

有配置文件的kubelet = 有完整手册的楼管
✓ 明确工作职责
✓ 清楚安全规范
✓ 知道汇报流程
✓ 了解服务标准
```

---

## 3. 🌐 核心网络通信配置


### 3.1 监听地址配置 - address

**通俗解释**：就像给楼管安排一个**固定的办公室地址**，其他人知道去哪里找他。

```yaml
# kubelet监听地址配置
apiVersion: kubelet.config.k8s.io/v1beta1
kind: KubeletConfiguration
address: "0.0.0.0"  # 监听所有网络接口
# address: "192.168.1.100"  # 只监听特定IP
```

**🔸 配置说明**：
- `0.0.0.0` - 监听所有网络接口（**最常用**）
- `127.0.0.1` - 只接受本机连接（**安全但限制大**）
- `192.168.1.100` - 只监听特定IP（**适合多网卡环境**）

### 3.2 端口配置 - port

**通俗解释**：就像楼管办公室的**房间号**，别人要找楼管就去这个房间号。

```yaml
# 端口配置
port: 10250        # kubelet主要服务端口
readOnlyPort: 10255  # 只读信息端口（可选）
```

**🔸 端口用途对比**：

| 端口 | **用途** | **权限** | **访问内容** |
|------|---------|----------|-------------|
| `10250` | **主服务端口** | `需要认证` | `完整的kubelet API` |
| `10255` | **只读端口** | `无需认证` | `基本状态信息` |

> **⚠️ 安全提醒**：生产环境通常禁用只读端口，因为它不需要认证就能访问节点信息。

### 3.3 网络通信流程图

```
Master节点                     Worker节点
┌─────────┐                   ┌─────────────┐
│kube-api │                   │   kubelet   │
│ server  │ ──── 指令 ────────▶│ :10250     │
│         │◀──── 状态汇报 ──── │             │
└─────────┘                   └─────────────┘
                               ┌─────────────┐
                               │   容器运行   │
                               │    环境     │
                               └─────────────┘
```

---

## 4. 🔐 安全认证与授权配置


### 4.1 认证配置 - authentication

**通俗解释**：就像楼管要**验证身份**，确认来人是不是真的物业工作人员。

```yaml
# 认证配置
authentication:
  anonymous:
    enabled: false      # 禁止匿名访问
  webhook:
    enabled: true       # 启用webhook认证
    cacheTTL: "2m"      # 认证结果缓存时间
  x509:
    clientCAFile: "/etc/kubernetes/pki/ca.crt"  # CA证书文件
```

**🔸 认证方式解释**：
- **匿名认证** - 不验证身份（**不安全，生产禁用**）
- **X509证书认证** - 使用证书验证身份（**最安全**）
- **Webhook认证** - 通过外部服务验证（**灵活**）

### 4.2 授权配置 - authorization

**通俗解释**：验证身份后，还要检查这个人**有没有权限**做这件事。

```yaml
# 授权配置
authorization:
  mode: "Webhook"     # 使用webhook方式授权
  webhook:
    cacheAuthorizedTTL: "5m"      # 授权成功缓存时间
    cacheUnauthorizedTTL: "30s"   # 授权失败缓存时间
```

### 4.3 TLS证书配置

**通俗解释**：就像楼管的**工作证**和**印章**，证明自己的身份和权威。

```yaml
# TLS证书配置
tlsCertFile: "/var/lib/kubelet/pki/kubelet.crt"      # kubelet证书
tlsPrivateKeyFile: "/var/lib/kubelet/pki/kubelet.key" # kubelet私钥
```

**🔸 证书的作用**：
- 🔒 **加密通信** - 确保数据传输安全
- 🆔 **身份验证** - 证明kubelet的身份
- ✅ **防篡改** - 防止通信被恶意修改

### 4.4 安全配置最佳实践

```
🛡️ 生产环境安全检查清单：
☑️ 禁用匿名访问
☑️ 启用X509证书认证
☑️ 配置正确的CA证书
☑️ 使用Webhook授权
☑️ 定期更新证书
☑️ 监控认证失败日志
```

---

## 5. 🌍 集群DNS与网络配置


### 5.1 集群域名 - clusterDomain

**通俗解释**：就像给整个**小区起个名字**，比如"阳光花园"，这样住户之间可以用简短的地址互相找到。

```yaml
# 集群域名配置
clusterDomain: "cluster.local"  # 默认集群域名
```

**🔸 域名的作用**：
在Kubernetes中，Pod之间可以通过域名相互访问：
```
完整域名格式：
<service-name>.<namespace>.svc.cluster.local

实际例子：
mysql.default.svc.cluster.local     # 访问default命名空间的mysql服务
redis.cache.svc.cluster.local       # 访问cache命名空间的redis服务
```

### 5.2 集群DNS服务器 - clusterDNS

**通俗解释**：就像小区的**电话查号台**，告诉大家某个住户住在哪个房间号。

```yaml
# DNS服务器配置
clusterDNS:
  - "10.96.0.10"      # 集群DNS服务的IP地址
  - "8.8.8.8"         # 备用DNS（可选）
```

**🔸 DNS解析流程**：
```
Pod想访问mysql服务
       ↓
询问DNS服务器(10.96.0.10)
       ↓  
"mysql.default.svc.cluster.local在哪里？"
       ↓
DNS回答："在10.96.1.100"
       ↓
Pod连接到10.96.1.100
```

### 5.3 Pod网络配置 - podCIDR

**通俗解释**：就是给这栋楼分配一个**门牌号段**，比如101-199房间都属于这栋楼。

```yaml
# Pod网络配置
podCIDR: "10.244.1.0/24"  # 该节点Pod的IP地址段
```

**🔸 CIDR解释**：
- `10.244.1.0/24` 表示这个节点上的Pod可以使用 `10.244.1.1` 到 `10.244.1.254` 这些IP地址
- `/24` 表示前24位是网络部分，后8位是主机部分（可容纳254个Pod）

### 5.4 网络配置示意图

```
集群网络布局：
┌─────────────────────────────────────────────┐
│              集群域：cluster.local           │
├─────────────┬─────────────┬─────────────────┤
│  Node1      │   Node2     │     Node3       │
│ 10.244.1.0  │ 10.244.2.0  │   10.244.3.0   │
│    /24      │    /24      │      /24        │
├─────────────┼─────────────┼─────────────────┤
│ Pod1        │  Pod5       │    Pod9         │
│10.244.1.10  │10.244.2.15  │  10.244.3.8    │
│             │             │                 │
│ Pod2        │  Pod6       │    Pod10        │ 
│10.244.1.20  │10.244.2.25  │  10.244.3.18   │
└─────────────┴─────────────┴─────────────────┘
```

---

## 6. 🏠 资源限制与性能配置


### 6.1 最大Pod数量 - maxPods

**通俗解释**：就像限制一栋楼**最多能住多少户人家**，避免过度拥挤。

```yaml
# 节点最大Pod数配置
maxPods: 110  # 该节点最多运行110个Pod（默认值）
```

**🔸 Pod数量规划**：

| 节点规格 | **推荐maxPods** | **考虑因素** |
|---------|----------------|-------------|
| `小型节点(2核4G)` | `30-50` | `资源限制，避免过载` |
| `中型节点(4核8G)` | `50-80` | `平衡性能与密度` |
| `大型节点(8核16G)` | `80-110` | `充分利用资源` |
| `超大节点(16核32G)` | `100-200` | `可适当增加上限` |

### 6.2 节点状态更新频率 - nodeStatusUpdateFrequency

**通俗解释**：就像楼管**多久向物业总部汇报一次**楼内情况。

```yaml
# 节点状态更新配置
nodeStatusUpdateFrequency: "10s"  # 每10秒向Master汇报一次状态
```

**🔸 更新频率的影响**：
- **频率太高**（1s）- 网络压力大，API Server负载重
- **频率适中**（10s）- 平衡性能与及时性 ⭐**推荐**
- **频率太低**（60s）- 节点状态更新延迟，故障发现慢

### 6.3 资源配置最佳实践

```yaml
# 生产环境推荐配置
maxPods: 110                           # 合理的Pod数量上限
nodeStatusUpdateFrequency: "10s"       # 平衡的状态更新频率
nodeStatusReportFrequency: "5m"        # 节点详细报告频率
nodeLeaseDurationSeconds: 40           # 节点租约持续时间
nodeLeaseRenewIntervalSeconds: 10      # 租约续期间隔
```

---

## 7. 🗑️ 镜像管理与垃圾回收


### 7.1 镜像垃圾回收机制

**通俗解释**：就像楼管要定期**清理废品**，当存储空间不够时，删除不用的旧镜像。

```yaml
# 镜像垃圾回收配置
imageGCHighThresholdPercent: 85  # 磁盘使用率达到85%时开始清理
imageGCLowThresholdPercent: 80   # 清理到磁盘使用率80%时停止
```

### 7.2 垃圾回收工作原理

```
镜像存储监控流程：
┌─────────────────┐
│   磁盘空间监控   │
└─────────┬───────┘
          │
    磁盘使用率 < 80% ────▶ 正常运行，无需清理
          │
    磁盘使用率 ≥ 85% ────▶ 触发垃圾回收
          │                    ↓
          │              ┌─────────────┐
          │              │  开始清理   │
          │              │  旧镜像     │
          │              └─────┬───────┘
          │                    │
    磁盘使用率 ≤ 80% ◀─────── 清理完成
          │
          ▼
    继续监控
```

### 7.3 垃圾回收配置详解

```yaml
# 完整的镜像管理配置
imageGCHighThresholdPercent: 85      # 开始清理的阈值
imageGCLowThresholdPercent: 80       # 停止清理的阈值
imageMinimumGCAge: "2m"              # 镜像至少存在2分钟才能被清理
imageMaximumGCAge: "0s"              # 0表示不设置最大存在时间
```

**🔸 清理策略说明**：
- 🕐 **按时间清理** - 优先清理最久未使用的镜像
- 📦 **保护正在使用** - 绝不删除正在运行的容器使用的镜像
- ⏰ **最小存在时间** - 刚下载的镜像不会立即被清理

### 7.4 容器垃圾回收配置

```yaml
# 容器垃圾回收配置
evictionHard:
  memory.available: "100Mi"          # 可用内存低于100Mi时强制驱逐
  nodefs.available: "10%"            # 磁盘可用空间低于10%时驱逐
  nodefs.inodesFree: "5%"           # inode使用率超过95%时驱逐
  imagefs.available: "15%"          # 镜像存储可用空间低于15%时驱逐
```

---

## 8. ⚡ 节点健康监控配置


### 8.1 驱逐策略 - evictionHard

**通俗解释**：就像楼管在楼内资源紧张时，必须**让一些住户搬走**来保证大楼正常运转。

```yaml
# 硬驱逐配置（立即生效，无宽限期）
evictionHard:
  memory.available: "100Mi"     # 可用内存少于100Mi时立即驱逐Pod
  nodefs.available: "10%"       # 节点磁盘可用空间少于10%时驱逐
  nodefs.inodesFree: "5%"       # inode使用超过95%时驱逐
  imagefs.available: "15%"      # 镜像存储可用空间少于15%时驱逐
```

### 8.2 软驱逐配置

```yaml
# 软驱逐配置（有宽限期）
evictionSoft:
  memory.available: "200Mi"           # 内存不足阈值
  nodefs.available: "15%"            # 磁盘空间阈值
evictionSoftGracePeriod:
  memory.available: "2m"             # 内存不足持续2分钟后驱逐
  nodefs.available: "2m"             # 磁盘不足持续2分钟后驱逐
evictionMaxPodGracePeriod: 60        # Pod被驱逐时的最大宽限期（秒）
```

### 8.3 驱逐策略对比

| 驱逐类型 | **触发条件** | **宽限期** | **使用场景** |
|---------|-------------|-----------|-------------|
| `硬驱逐` | **资源严重不足** | `无宽限期` | `紧急情况，立即处理` |
| `软驱逐` | **资源持续不足** | `有宽限期` | `预警处理，温和清理` |

### 8.4 健康检查流程图

```
节点资源监控流程：
┌─────────────────┐
│    资源监控     │
│ (内存/磁盘/CPU) │
└─────────┬───────┘
          │
    资源充足 ────▶ 正常运行
          │
    资源不足
          │
          ▼
┌─────────────────┐
│  触发软驱逐？    │ ──是──▶ 等待宽限期 ──▶ 温和驱逐Pod
└─────────┬───────┘
          │ 否
          ▼
┌─────────────────┐
│  触发硬驱逐？    │ ──是──▶ 立即强制驱逐Pod
└─────────┬───────┘
          │ 否
          ▼
    继续监控
```

---

## 9. 📋 完整配置示例


### 9.1 生产环境标准配置

```yaml
apiVersion: kubelet.config.k8s.io/v1beta1
kind: KubeletConfiguration

# ===== 网络通信配置 =====
address: "0.0.0.0"                    # 监听所有网络接口
port: 10250                           # kubelet服务端口
# readOnlyPort: 0                     # 禁用只读端口（安全）

# ===== 认证授权配置 =====
authentication:
  anonymous:
    enabled: false                     # 禁用匿名访问
  webhook:
    enabled: true                      # 启用webhook认证
    cacheTTL: "2m"                    # 认证缓存时间
  x509:
    clientCAFile: "/etc/kubernetes/pki/ca.crt"

authorization:
  mode: "Webhook"                      # 使用webhook授权
  webhook:
    cacheAuthorizedTTL: "5m"          # 授权成功缓存5分钟
    cacheUnauthorizedTTL: "30s"       # 授权失败缓存30秒

# ===== TLS证书配置 =====
tlsCertFile: "/var/lib/kubelet/pki/kubelet.crt"
tlsPrivateKeyFile: "/var/lib/kubelet/pki/kubelet.key"

# ===== 集群DNS配置 =====
clusterDomain: "cluster.local"        # 集群域名
clusterDNS:
  - "10.96.0.10"                     # 集群DNS服务IP

# ===== 网络配置 =====
podCIDR: "10.244.0.0/16"             # Pod网络CIDR

# ===== 资源限制配置 =====
maxPods: 110                          # 节点最大Pod数量
nodeStatusUpdateFrequency: "10s"      # 状态更新频率

# ===== 镜像管理配置 =====
imageGCHighThresholdPercent: 85       # 镜像清理高阈值
imageGCLowThresholdPercent: 80        # 镜像清理低阈值
imageMinimumGCAge: "2m"               # 镜像最小存在时间

# ===== 驱逐策略配置 =====
evictionHard:
  memory.available: "100Mi"           # 硬驱逐内存阈值
  nodefs.available: "10%"             # 硬驱逐磁盘阈值
  nodefs.inodesFree: "5%"            # 硬驱逐inode阈值
  imagefs.available: "15%"           # 硬驱逐镜像存储阈值

evictionSoft:
  memory.available: "200Mi"           # 软驱逐内存阈值
  nodefs.available: "15%"             # 软驱逐磁盘阈值

evictionSoftGracePeriod:
  memory.available: "2m"              # 内存软驱逐宽限期
  nodefs.available: "2m"              # 磁盘软驱逐宽限期

evictionMaxPodGracePeriod: 60         # Pod驱逐最大宽限期

# ===== 其他重要配置 =====
cgroupDriver: "systemd"               # cgroup驱动（与Docker保持一致）
containerLogMaxSize: "10Mi"           # 单个容器日志最大大小
containerLogMaxFiles: 5               # 容器日志文件最大数量
kubeReserved:                         # 为kubelet预留资源
  cpu: "100m"
  memory: "100Mi"
systemReserved:                       # 为系统预留资源
  cpu: "100m" 
  memory: "100Mi"
```

### 9.2 开发环境简化配置

```yaml
apiVersion: kubelet.config.k8s.io/v1beta1
kind: KubeletConfiguration

# 基础配置（开发环境可以简化）
address: "0.0.0.0"
port: 10250
clusterDomain: "cluster.local"
clusterDNS: ["10.96.0.10"]
maxPods: 50                           # 开发环境Pod数量较少

# 宽松的资源配置
evictionHard:
  memory.available: "50Mi"            # 开发环境内存要求可以低一些
  nodefs.available: "5%"
imageGCHighThresholdPercent: 90       # 开发环境清理阈值可以高一些
imageGCLowThresholdPercent: 85
```

---

## 10. 📋 核心要点总结


### 10.1 必须掌握的核心概念


```
🔸 kubelet职责：Kubernetes节点上的"楼管大爷"，管理Pod生命周期
🔸 配置文件位置：/var/lib/kubelet/config.yaml 或 /etc/kubernetes/kubelet/
🔸 网络配置：address、port设置kubelet的通信地址
🔸 安全配置：authentication、authorization、TLS证书保障集群安全
🔸 DNS配置：clusterDomain、clusterDNS支持Pod间域名访问
🔸 资源管理：maxPods、驱逐策略防止节点资源耗尽
🔸 垃圾回收：imageGC配置自动清理不用的镜像节省存储
```

### 10.2 关键配置参数速查


| 配置项 | **推荐值** | **作用说明** | **重要程度** |
|--------|-----------|-------------|-------------|
| `address` | `"0.0.0.0"` | **kubelet监听地址** | ⭐⭐⭐ |
| `port` | `10250` | **kubelet服务端口** | ⭐⭐⭐ |
| `clusterDomain` | `"cluster.local"` | **集群域名** | ⭐⭐⭐ |
| `clusterDNS` | `["10.96.0.10"]` | **DNS服务器IP** | ⭐⭐⭐ |
| `maxPods` | `110` | **节点最大Pod数** | ⭐⭐ |
| `nodeStatusUpdateFrequency` | `"10s"` | **状态更新频率** | ⭐⭐ |
| `imageGCHighThresholdPercent` | `85` | **镜像清理阈值** | ⭐⭐ |
| `evictionHard.memory.available` | `"100Mi"` | **内存硬驱逐阈值** | ⭐⭐⭐ |

### 10.3 配置文件管理最佳实践


**🔧 配置管理建议**：
```bash
# 1. 备份原始配置
sudo cp /var/lib/kubelet/config.yaml /var/lib/kubelet/config.yaml.backup

# 2. 验证配置语法
sudo kubelet --config=/var/lib/kubelet/config.yaml --dry-run

# 3. 重启kubelet服务
sudo systemctl restart kubelet

# 4. 检查服务状态
sudo systemctl status kubelet
```

**🛡️ 安全配置检查清单**：
```
☑️ 禁用匿名访问 (authentication.anonymous.enabled: false)
☑️ 配置正确的CA证书路径
☑️ 启用TLS证书 (tlsCertFile, tlsPrivateKeyFile)
☑️ 使用Webhook授权模式
☑️ 关闭只读端口 (readOnlyPort: 0)
☑️ 设置合理的资源预留
☑️ 配置适当的驱逐策略
```

### 10.4 故障排除要点


**🔍 常见问题诊断**：
- **kubelet启动失败** → 检查配置文件语法和证书路径
- **Pod无法调度** → 检查maxPods设置和资源预留
- **网络连接问题** → 检查address、port和DNS配置
- **磁盘空间不足** → 检查镜像垃圾回收和驱逐策略
- **认证失败** → 检查证书文件权限和CA配置

**核心记忆**：
- kubelet是节点管理者，配置文件是工作手册
- 网络配置决定通信，安全配置保护集群
- DNS配置支持服务发现，资源配置防止过载
- 垃圾回收节省空间，驱逐策略保障稳定
- 生产环境重安全，开发环境重便利