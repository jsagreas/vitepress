---
title: 17ã€æ—¥å¿—èšåˆé…ç½®æ–‡ä»¶
---
## ğŸ“š ç›®å½•

1. [æ—¥å¿—èšåˆæ¦‚è¿°](#1-æ—¥å¿—èšåˆæ¦‚è¿°)
2. [æ ¸å¿ƒæ—¥å¿—æ”¶é›†ç»„ä»¶](#2-æ ¸å¿ƒæ—¥å¿—æ”¶é›†ç»„ä»¶)
3. [ELKæ—¥å¿—æ ˆé…ç½®](#3-ELKæ—¥å¿—æ ˆé…ç½®)
4. [Lokiè½»é‡æ—¥å¿—æ–¹æ¡ˆ](#4-Lokiè½»é‡æ—¥å¿—æ–¹æ¡ˆ)
5. [å®¹å™¨æ—¥å¿—ç®¡ç†](#5-å®¹å™¨æ—¥å¿—ç®¡ç†)
6. [ç³»ç»Ÿä¸å®¡è®¡æ—¥å¿—](#6-ç³»ç»Ÿä¸å®¡è®¡æ—¥å¿—)
7. [æ—¥å¿—é…ç½®æœ€ä½³å®è·µ](#7-æ—¥å¿—é…ç½®æœ€ä½³å®è·µ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ—ï¸ æ—¥å¿—èšåˆæ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯æ—¥å¿—èšåˆ


**é€šä¿—ç†è§£**ï¼šå°±åƒæŠŠæ•£è½åœ¨å„ä¸ªæˆ¿é—´çš„ä¿¡ä»¶éƒ½æ”¶é›†åˆ°ä¸€ä¸ªé‚®ç®±é‡Œç»Ÿä¸€ç®¡ç†

```
æ²¡æœ‰æ—¥å¿—èšåˆçš„æƒ…å†µï¼š
Pod-Açš„æ—¥å¿— â†’ æ•£è½åœ¨Node-1ä¸Š
Pod-Bçš„æ—¥å¿— â†’ æ•£è½åœ¨Node-2ä¸Š  
Pod-Cçš„æ—¥å¿— â†’ æ•£è½åœ¨Node-3ä¸Š
è¿ç»´äººå‘˜éœ€è¦åˆ°å„ä¸ªèŠ‚ç‚¹å»æŸ¥çœ‹æ—¥å¿— ğŸ˜°

æœ‰äº†æ—¥å¿—èšåˆï¼š
Pod-Aã€Bã€Cçš„æ—¥å¿— â†’ ç»Ÿä¸€æ”¶é›†åˆ°æ—¥å¿—ä¸­å¿ƒ ğŸ“Š
è¿ç»´äººå‘˜åœ¨ä¸€ä¸ªåœ°æ–¹å°±èƒ½æŸ¥çœ‹æ‰€æœ‰æ—¥å¿— ğŸ˜Š
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦æ—¥å¿—èšåˆ


**å®é™…é—®é¢˜åœºæ™¯**ï¼š
- **Podé‡å¯**ï¼šå®¹å™¨é‡å¯åï¼Œä¹‹å‰çš„æ—¥å¿—å°±ä¸¢å¤±äº†
- **èŠ‚ç‚¹æ•…éšœ**ï¼šèŠ‚ç‚¹å®•æœºï¼Œè¯¥èŠ‚ç‚¹ä¸Šçš„æ—¥å¿—æ— æ³•è®¿é—®
- **æ‰©å®¹ç¼©å®¹**ï¼šPodåŠ¨æ€åˆ›å»ºé”€æ¯ï¼Œæ—¥å¿—åˆ†æ•£éš¾ä»¥è¿½è¸ª
- **æ•…éšœæ’æŸ¥**ï¼šéœ€è¦è·¨å¤šä¸ªPodæŸ¥çœ‹æ—¥å¿—æ‰èƒ½å®šä½é—®é¢˜

**æ—¥å¿—èšåˆçš„ä»·å€¼**ï¼š
```
é›†ä¸­ç®¡ç†ï¼šæ‰€æœ‰æ—¥å¿—ç»Ÿä¸€å­˜å‚¨ï¼Œä¾¿äºç®¡ç†
æŒä¹…ä¿å­˜ï¼šå³ä½¿Podé‡å¯ï¼Œæ—¥å¿—ä¾ç„¶ä¿ç•™
æœç´¢åˆ†æï¼šå¯ä»¥å¿«é€Ÿæœç´¢å’Œåˆ†ææ—¥å¿—å†…å®¹
å¯è§†åŒ–ï¼šé€šè¿‡å›¾è¡¨å±•ç¤ºæ—¥å¿—è¶‹åŠ¿å’Œå¼‚å¸¸
å‘Šè­¦ç›‘æ§ï¼šåŸºäºæ—¥å¿—å†…å®¹è®¾ç½®å‘Šè­¦è§„åˆ™
```

### 1.3 æ—¥å¿—èšåˆæ¶æ„å…¨æ™¯


```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Kubernetesé›†ç¾¤                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     Node-1      â”‚     Node-2      â”‚      Node-3         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚   â”‚  Pod-A  â”‚   â”‚   â”‚  Pod-B  â”‚   â”‚   â”‚  Pod-C  â”‚       â”‚
â”‚   â”‚ åº”ç”¨æ—¥å¿— â”‚   â”‚   â”‚ åº”ç”¨æ—¥å¿— â”‚   â”‚   â”‚ åº”ç”¨æ—¥å¿— â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚   â”‚æ—¥å¿—é‡‡é›†å™¨â”‚   â”‚   â”‚æ—¥å¿—é‡‡é›†å™¨â”‚   â”‚   â”‚æ—¥å¿—é‡‡é›†å™¨â”‚       â”‚
â”‚   â”‚(Fluent) â”‚   â”‚   â”‚(Fluent) â”‚   â”‚   â”‚(Fluent) â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                 â”‚                 â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                æ—¥å¿—å¤„ç†å±‚                             â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚  Logstash   â”‚  â”‚ Fluent Bit  â”‚  â”‚  Promtail   â”‚  â”‚
    â”‚  â”‚ æ—¥å¿—å¤„ç†è½¬æ¢  â”‚  â”‚ è½»é‡é‡‡é›†å™¨   â”‚  â”‚  Lokié‡‡é›†   â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                æ—¥å¿—å­˜å‚¨å±‚                             â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚  â”‚Elasticsearch â”‚         â”‚      Loki           â”‚   â”‚
    â”‚  â”‚ å…¨æ–‡æ£€ç´¢å­˜å‚¨  â”‚         â”‚   è½»é‡æ—¥å¿—å­˜å‚¨       â”‚   â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                å¯è§†åŒ–å±•ç¤ºå±‚                           â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚  â”‚    Kibana    â”‚         â”‚      Grafana        â”‚   â”‚
    â”‚  â”‚ æ—¥å¿—æœç´¢åˆ†æ  â”‚         â”‚   æ—¥å¿—å›¾è¡¨å±•ç¤º       â”‚   â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸ”§ æ ¸å¿ƒæ—¥å¿—æ”¶é›†ç»„ä»¶


### 2.1 Fluentd - é‡é‡çº§æ—¥å¿—å¤„ç†å™¨


**ä»€ä¹ˆæ˜¯Fluentd**ï¼š
- æƒ³è±¡æˆä¸€ä¸ª**å¼ºåŠ›çš„æ—¥å¿—å¤„ç†å·¥å‚**
- å¯ä»¥æ¥æ”¶å„ç§æ ¼å¼çš„æ—¥å¿—ï¼Œå¤„ç†åè¾“å‡ºåˆ°ä¸åŒåœ°æ–¹
- åŠŸèƒ½ä¸°å¯Œä½†æ¶ˆè€—èµ„æºè¾ƒå¤š

**Fluentdçš„ç‰¹ç‚¹**ï¼š
```
ä¼˜åŠ¿ï¼š
âœ… åŠŸèƒ½å¼ºå¤§ï¼šæ”¯æŒå¤æ‚çš„æ—¥å¿—å¤„ç†é€»è¾‘
âœ… æ’ä»¶ä¸°å¯Œï¼šæœ‰500+æ’ä»¶å¯æ‰©å±•åŠŸèƒ½
âœ… æ•°æ®è·¯ç”±ï¼šå¯ä»¥å°†ä¸åŒæ—¥å¿—å‘é€åˆ°ä¸åŒç›®çš„åœ°
âœ… ç¼“å†²æœºåˆ¶ï¼šç½‘ç»œå¼‚å¸¸æ—¶å¯ä»¥æš‚å­˜æ—¥å¿—

åŠ£åŠ¿ï¼š
âŒ èµ„æºå ç”¨ï¼šå†…å­˜å’ŒCPUæ¶ˆè€—è¾ƒé«˜
âŒ å­¦ä¹ æˆæœ¬ï¼šé…ç½®ç›¸å¯¹å¤æ‚
âŒ å¯åŠ¨æ…¢ï¼šæ’ä»¶å¤šå¯¼è‡´å¯åŠ¨æ—¶é—´é•¿
```

**Fluentd DaemonSeté…ç½®**ï¼š
```yaml
# fluentd-daemonset.yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: fluentd
  namespace: kube-system
spec:
  selector:
    matchLabels:
      app: fluentd
  template:
    metadata:
      labels:
        app: fluentd
    spec:
      containers:
      - name: fluentd
        image: fluent/fluentd-kubernetes-daemonset:v1.16-debian-elasticsearch7-1
        env:
        - name: FLUENT_ELASTICSEARCH_HOST
          value: "elasticsearch.logging.svc.cluster.local"
        - name: FLUENT_ELASTICSEARCH_PORT
          value: "9200"
        # æŒ‚è½½å®¹å™¨æ—¥å¿—ç›®å½•
        volumeMounts:
        - name: varlog
          mountPath: /var/log
        - name: dockercontainers
          mountPath: /var/lib/docker/containers
          readOnly: true
        # èµ„æºé™åˆ¶
        resources:
          limits:
            memory: 500Mi
          requests:
            memory: 200Mi
            cpu: 100m
      volumes:
      - name: varlog
        hostPath:
          path: /var/log
      - name: dockercontainers
        hostPath:
          path: /var/lib/docker/containers
```

### 2.2 Fluent Bit - è½»é‡çº§æ—¥å¿—æ”¶é›†å™¨


**ä»€ä¹ˆæ˜¯Fluent Bit**ï¼š
- å¯ä»¥ç†è§£ä¸º**Fluentdçš„è½»é‡ç‰ˆå…„å¼Ÿ**
- ä¸“æ³¨äºæ—¥å¿—æ”¶é›†ï¼ŒåŠŸèƒ½ç²¾ç®€ä½†æ€§èƒ½æ›´å¥½
- ç‰¹åˆ«é€‚åˆèµ„æºå—é™çš„ç¯å¢ƒ

**ä¸ºä»€ä¹ˆé€‰æ‹©Fluent Bit**ï¼š
```
èµ„æºæ¶ˆè€—å¯¹æ¯”ï¼š
Fluentdï¼šå†…å­˜ ~200-500MBï¼ŒCPUè¾ƒé«˜
Fluent Bitï¼šå†…å­˜ ~10-50MBï¼ŒCPUè¾ƒä½

é€‚ç”¨åœºæ™¯ï¼š
è¾¹ç¼˜è®¡ç®— â†’ Fluent Bit (èµ„æºæœ‰é™)
æ•°æ®ä¸­å¿ƒ â†’ Fluentd (å¤„ç†å¤æ‚)
IoTè®¾å¤‡ â†’ Fluent Bit (è½»é‡éƒ¨ç½²)
```

**Fluent Bité…ç½®ç¤ºä¾‹**ï¼š
```yaml
# fluent-bit-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: fluent-bit-config
  namespace: logging
data:
  fluent-bit.conf: |
    [SERVICE]
        Flush         1
        Log_Level     info
        Daemon        off
        HTTP_Server   On
        HTTP_Listen   0.0.0.0
        HTTP_Port     2020

    [INPUT]
        Name              tail
        Path              /var/log/containers/*.log
        multiline.parser  cri
        Tag               kube.*
        Mem_Buf_Limit     50MB
        Skip_Long_Lines   On

    [FILTER]
        Name                kubernetes
        Match               kube.*
        Kube_URL            https://kubernetes.default.svc:443
        Kube_CA_File        /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        Kube_Token_File     /var/run/secrets/kubernetes.io/serviceaccount/token

    [OUTPUT]
        Name  es
        Match *
        Host  elasticsearch.logging.svc.cluster.local
        Port  9200
        Index fluentbit
---
# Fluent Bit DaemonSet
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: fluent-bit
  namespace: logging
spec:
  selector:
    matchLabels:
      app: fluent-bit
  template:
    spec:
      containers:
      - name: fluent-bit
        image: fluent/fluent-bit:2.2
        volumeMounts:
        - name: config
          mountPath: /fluent-bit/etc/
        - name: varlog
          mountPath: /var/log
          readOnly: true
        resources:
          limits:
            memory: 100Mi
          requests:
            memory: 50Mi
            cpu: 50m
      volumes:
      - name: config
        configMap:
          name: fluent-bit-config
      - name: varlog
        hostPath:
          path: /var/log
```

### 2.3 Filebeat - Elasticç”Ÿæ€æ—¥å¿—æ”¶é›†å™¨


**ä»€ä¹ˆæ˜¯Filebeat**ï¼š
- **Elasticå…¬å¸ä¸“é—¨åšçš„æ—¥å¿—æ”¶é›†å·¥å…·**
- å¤©ç„¶ä¸Elasticsearché›†æˆï¼Œé…ç½®ç®€å•
- é‡ç‚¹å…³æ³¨æ—¥å¿—æ–‡ä»¶çš„å¯é ä¼ è¾“

**Filebeatçš„ç‰¹è‰²åŠŸèƒ½**ï¼š
```
æ–­ç‚¹ç»­ä¼ ï¼š
- è®°å½•è¯»å–ä½ç½®ï¼Œé‡å¯åä»ä¸Šæ¬¡ä½ç½®ç»§ç»­
- é¿å…æ—¥å¿—é‡å¤æˆ–ä¸¢å¤±

å¤šè¡Œåˆå¹¶ï¼š
- Javaå †æ ˆå¼‚å¸¸é€šå¸¸è·¨å¤šè¡Œ
- Filebeatå¯ä»¥æ™ºèƒ½åˆå¹¶ç›¸å…³è¡Œ

è¾“å‡ºç¼“å†²ï¼š
- ç½‘ç»œå¼‚å¸¸æ—¶åœ¨æœ¬åœ°ç¼“å­˜
- ç½‘ç»œæ¢å¤åç»§ç»­å‘é€
```

**Filebeaté…ç½®æ–‡ä»¶**ï¼š
```yaml
# filebeat-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: filebeat-config
data:
  filebeat.yml: |
    filebeat.inputs:
    - type: container
      paths:
        - /var/log/containers/*.log
      processors:
      - add_kubernetes_metadata:
          host: ${NODE_NAME}
          matchers:
          - logs_path:
              logs_path: "/var/log/containers/"

    # å¤šè¡Œæ—¥å¿—å¤„ç† (Javaå¼‚å¸¸å †æ ˆ)
    - type: log
      paths:
        - /var/log/containers/*java*.log
      multiline.pattern: '^\d{4}-\d{2}-\d{2}'
      multiline.negate: true
      multiline.match: after

    output.elasticsearch:
      hosts: ['elasticsearch.logging.svc.cluster.local:9200']
      index: "filebeat-k8s-%{+yyyy.MM.dd}"

    setup.template.name: "filebeat-k8s"
    setup.template.pattern: "filebeat-k8s-*"
```

---

## 3. ğŸ“Š ELKæ—¥å¿—æ ˆé…ç½®


### 3.1 ELKæ¶æ„ç†è§£


**ELKæ˜¯ä»€ä¹ˆ**ï¼š
- **E**lasticsearchï¼šå­˜å‚¨å’Œæœç´¢æ—¥å¿—æ•°æ®
- **L**ogstashï¼šå¤„ç†å’Œè½¬æ¢æ—¥å¿—æ•°æ®  
- **K**ibanaï¼šå±•ç¤ºå’Œåˆ†ææ—¥å¿—æ•°æ®

**é€šä¿—æ¯”å–»**ï¼š
```
Elasticsearch = å›¾ä¹¦é¦† ğŸ“š
- å­˜å‚¨æ‰€æœ‰çš„"æ—¥å¿—ä¹¦ç±"
- æä¾›å¿«é€ŸæŸ¥æ‰¾åŠŸèƒ½

Logstash = å›¾ä¹¦ç®¡ç†å‘˜ ğŸ‘¨â€ğŸ’¼  
- æ•´ç†æ–°æ¥çš„ä¹¦ç±
- åˆ†ç±»æ ‡è®°åæ”¾åˆ°åˆé€‚ä½ç½®

Kibana = é˜…è¯»å®¤ ğŸ“–
- æä¾›èˆ’é€‚çš„é˜…è¯»ç¯å¢ƒ
- å„ç§æŸ¥è¯¢å’Œåˆ†æå·¥å…·
```

### 3.2 Elasticsearché›†ç¾¤é…ç½®


**Elasticsearchæ ¸å¿ƒé…ç½®**ï¼š
```yaml
# elasticsearch-cluster.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: elasticsearch
  namespace: logging
spec:
  serviceName: elasticsearch
  replicas: 3
  selector:
    matchLabels:
      app: elasticsearch
  template:
    metadata:
      labels:
        app: elasticsearch
    spec:
      initContainers:
      # ç³»ç»Ÿå‚æ•°ä¼˜åŒ–
      - name: sysctl
        image: busybox
        command:
        - sysctl
        - -w
        - vm.max_map_count=262144
        securityContext:
          privileged: true
      containers:
      - name: elasticsearch
        image: docker.elastic.co/elasticsearch/elasticsearch:7.17.0
        env:
        # é›†ç¾¤é…ç½®
        - name: cluster.name
          value: "k8s-logs"
        - name: node.name
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        # å‘ç°é…ç½®
        - name: discovery.seed_hosts
          value: "elasticsearch-0.elasticsearch,elasticsearch-1.elasticsearch,elasticsearch-2.elasticsearch"
        - name: cluster.initial_master_nodes
          value: "elasticsearch-0,elasticsearch-1,elasticsearch-2"
        # JVMå†…å­˜è®¾ç½®
        - name: ES_JAVA_OPTS
          value: "-Xms2g -Xmx2g"
        ports:
        - containerPort: 9200
          name: http
        - containerPort: 9300
          name: transport
        # æ•°æ®æŒä¹…åŒ–
        volumeMounts:
        - name: data
          mountPath: /usr/share/elasticsearch/data
        resources:
          limits:
            memory: 4Gi
          requests:
            memory: 2Gi
            cpu: 1000m
  # æŒä¹…åŒ–å­˜å‚¨
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 100Gi
---
# Elasticsearch Service
apiVersion: v1
kind: Service
metadata:
  name: elasticsearch
  namespace: logging
spec:
  selector:
    app: elasticsearch
  ports:
  - port: 9200
    name: http
  - port: 9300
    name: transport
  clusterIP: None  # Headless service for StatefulSet
```

### 3.3 Logstashæ—¥å¿—å¤„ç†é…ç½®


**Logstashçš„ä½œç”¨**ï¼š
- **æ¥æ”¶**ï¼šä»å„ç§æ¥æºæ¥æ”¶æ—¥å¿—
- **å¤„ç†**ï¼šè§£æã€è¿‡æ»¤ã€è½¬æ¢æ—¥å¿—æ ¼å¼
- **è¾“å‡º**ï¼šå‘é€åˆ°Elasticsearchæˆ–å…¶ä»–ç›®çš„åœ°

**Logstashå¤„ç†æµç¨‹**ï¼š
```
Input â†’ Filter â†’ Output

Inputé˜¶æ®µï¼š
- ä»Filebeatæ¥æ”¶æ—¥å¿—
- ä»Kafkaæ¥æ”¶æ—¥å¿—
- ä»æ•°æ®åº“è¯»å–æ•°æ®

Filteré˜¶æ®µï¼š
- è§£æJSONæ ¼å¼æ—¥å¿—
- æå–æ—¶é—´æˆ³
- æ·»åŠ åœ°ç†ä½ç½®ä¿¡æ¯
- åˆ é™¤æ•æ„Ÿä¿¡æ¯

Outputé˜¶æ®µï¼š  
- å‘é€åˆ°Elasticsearch
- å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ
- å†™å…¥æ–‡ä»¶å¤‡ä»½
```

**Logstashé…ç½®ç¤ºä¾‹**ï¼š
```yaml
# logstash-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: logstash-config
data:
  logstash.yml: |
    http.host: "0.0.0.0"
    xpack.monitoring.elasticsearch.hosts: ["http://elasticsearch:9200"]
  
  pipeline.yml: |
    - pipeline.id: k8s-logs
      path.config: "/usr/share/logstash/pipeline/k8s-logs.conf"

  k8s-logs.conf: |
    input {
      beats {
        port => 5044
      }
    }
    
    filter {
      # è§£æKubernetesæ—¥å¿—
      if [kubernetes] {
        # æå–Podä¿¡æ¯
        mutate {
          add_field => {
            "pod_name" => "%{[kubernetes][pod][name]}"
            "namespace" => "%{[kubernetes][namespace]}"
            "container" => "%{[kubernetes][container][name]}"
          }
        }
        
        # è§£æJSONæ ¼å¼çš„åº”ç”¨æ—¥å¿—
        if [message] =~ /^\{.*\}$/ {
          json {
            source => "message"
          }
        }
        
        # è§£ææ—¶é—´æˆ³
        date {
          match => [ "@timestamp", "ISO8601" ]
        }
      }
      
      # è¿‡æ»¤å¥åº·æ£€æŸ¥æ—¥å¿—(å‡å°‘å™ªéŸ³)
      if [message] =~ /health.*check/ {
        drop { }
      }
    }
    
    output {
      elasticsearch {
        hosts => ["elasticsearch:9200"]
        # æŒ‰æ—¥æœŸåˆ›å»ºç´¢å¼•
        index => "k8s-logs-%{+YYYY.MM.dd}"
      }
      
      # è°ƒè¯•è¾“å‡º(å¯é€‰)
      stdout {
        codec => rubydebug
      }
    }
---
# Logstash Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: logstash
spec:
  replicas: 2
  selector:
    matchLabels:
      app: logstash
  template:
    spec:
      containers:
      - name: logstash
        image: docker.elastic.co/logstash/logstash:7.17.0
        ports:
        - containerPort: 5044
        - containerPort: 9600
        volumeMounts:
        - name: config
          mountPath: /usr/share/logstash/config/
        - name: pipeline
          mountPath: /usr/share/logstash/pipeline/
        resources:
          limits:
            memory: 2Gi
          requests:
            memory: 1Gi
      volumes:
      - name: config
        configMap:
          name: logstash-config
          items:
          - key: logstash.yml
            path: logstash.yml
      - name: pipeline
        configMap:
          name: logstash-config
          items:
          - key: k8s-logs.conf
            path: k8s-logs.conf
```

### 3.4 Kibanaå¯è§†åŒ–é…ç½®


**Kibanaçš„ä»·å€¼**ï¼š
- **æœç´¢ç•Œé¢**ï¼šåƒGoogleä¸€æ ·æœç´¢æ—¥å¿—
- **æ•°æ®å¯è§†åŒ–**ï¼šå°†æ—¥å¿—è½¬æ¢ä¸ºå›¾è¡¨
- **Dashboard**ï¼šåˆ›å»ºç›‘æ§é¢æ¿
- **å‘Šè­¦åŠŸèƒ½**ï¼šåŸºäºæ—¥å¿—å†…å®¹è®¾ç½®å‘Šè­¦

**Kibanaéƒ¨ç½²é…ç½®**ï¼š
```yaml
# kibana-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kibana
  namespace: logging
spec:
  replicas: 1
  selector:
    matchLabels:
      app: kibana
  template:
    metadata:
      labels:
        app: kibana
    spec:
      containers:
      - name: kibana
        image: docker.elastic.co/kibana/kibana:7.17.0
        env:
        - name: ELASTICSEARCH_HOSTS
          value: "http://elasticsearch:9200"
        - name: SERVER_NAME
          value: "kibana"
        - name: SERVER_HOST
          value: "0.0.0.0"
        ports:
        - containerPort: 5601
        resources:
          limits:
            memory: 2Gi
          requests:
            memory: 1Gi
            cpu: 500m
---
# Kibana Service
apiVersion: v1
kind: Service
metadata:
  name: kibana
  namespace: logging
spec:
  selector:
    app: kibana
  ports:
  - port: 80
    targetPort: 5601
  type: NodePort  # æˆ–è€…ä½¿ç”¨Ingress
```

---

## 4. ğŸ” Lokiè½»é‡æ—¥å¿—æ–¹æ¡ˆ


### 4.1 Loki vs ELKå¯¹æ¯”


**ä¸ºä»€ä¹ˆå‡ºç°Loki**ï¼š
- ELKåŠŸèƒ½å¼ºå¤§ä½†èµ„æºæ¶ˆè€—é«˜
- å¾ˆå¤šåœºæ™¯ä¸éœ€è¦å…¨æ–‡æ£€ç´¢ï¼Œåªéœ€è¦æŒ‰æ ‡ç­¾æŸ¥è¯¢
- Lokiä¸“æ³¨äºæ—¥å¿—èšåˆè€Œéæœç´¢

**æ ¸å¿ƒå·®å¼‚å¯¹æ¯”**ï¼š

| ç‰¹æ€§ | **ELKæ–¹æ¡ˆ** | **Lokiæ–¹æ¡ˆ** |
|------|------------|-------------|
| **ç´¢å¼•æ–¹å¼** | å…¨æ–‡ç´¢å¼• | ä»…ç´¢å¼•æ ‡ç­¾ |
| **å­˜å‚¨æˆæœ¬** | é«˜(éœ€è¦ç´¢å¼•å­˜å‚¨) | ä½(å‹ç¼©å­˜å‚¨åŸæ–‡) |
| **æŸ¥è¯¢èƒ½åŠ›** | å…¨æ–‡æ£€ç´¢ | æ ‡ç­¾è¿‡æ»¤+æ­£åˆ™ |
| **èµ„æºæ¶ˆè€—** | é«˜ | ä½ |
| **å­¦ä¹ æˆæœ¬** | è¾ƒé«˜ | è¾ƒä½ |
| **é€‚ç”¨åœºæ™¯** | å¤æ‚æ—¥å¿—åˆ†æ | æ—¥å¿—èšåˆæŸ¥çœ‹ |

### 4.2 Lokiæ¶æ„ç†è§£


**Lokiç»„ä»¶æ„æˆ**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Lokiæ¶æ„                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚Promtail â”‚    â”‚Promtail â”‚    â”‚Promtail â”‚     â”‚
â”‚  â”‚é‡‡é›†å™¨-1 â”‚    â”‚é‡‡é›†å™¨-2 â”‚    â”‚é‡‡é›†å™¨-3 â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â”‚
â”‚       â”‚              â”‚              â”‚          â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                      â–¼                         â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚              â”‚    Loki     â”‚                   â”‚
â”‚              â”‚  æ—¥å¿—æœåŠ¡å™¨  â”‚                   â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                      â”‚                         â”‚
â”‚                      â–¼                         â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚              â”‚   Grafana   â”‚                   â”‚
â”‚              â”‚  æŸ¥è¯¢å±•ç¤º   â”‚                   â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 Promtailæ—¥å¿—é‡‡é›†å™¨é…ç½®


**ä»€ä¹ˆæ˜¯Promtail**ï¼š
- Lokiä¸“ç”¨çš„æ—¥å¿—é‡‡é›†å·¥å…·
- è´Ÿè´£å‘ç°æ—¥å¿—æ–‡ä»¶ï¼Œæå–æ ‡ç­¾ï¼Œå‘é€åˆ°Loki
- ç±»ä¼¼äºFilebeatï¼Œä½†ä¸“é—¨ä¸ºLokiè®¾è®¡

**Promtailé…ç½®ç¤ºä¾‹**ï¼š
```yaml
# promtail-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: promtail-config
data:
  config.yml: |
    server:
      http_listen_port: 3101
      grpc_listen_port: 0

    positions:
      filename: /tmp/positions.yaml

    clients:
      - url: http://loki:3100/loki/api/v1/push

    scrape_configs:
    # Kubernetes Podæ—¥å¿—
    - job_name: kubernetes-pods
      kubernetes_sd_configs:
        - role: pod
      
      pipeline_stages:
      # è§£æCRIæ—¥å¿—æ ¼å¼
      - cri: {}
      
      # æå–Kubernetesæ ‡ç­¾
      - labelallow:
          - __meta_kubernetes_pod_node_name
          - __meta_kubernetes_namespace_name
          - __meta_kubernetes_pod_name
          - __meta_kubernetes_pod_container_name
      
      # é‡æ–°æ ‡è®°
      - labeldrop:
          - __meta_kubernetes_pod_uid
          - __meta_kubernetes_pod_controller_kind
      
      relabel_configs:
      # åªæ”¶é›†è¿è¡Œä¸­çš„Podæ—¥å¿—
      - source_labels:
          - __meta_kubernetes_pod_phase
        regex: Pending|Succeeded|Failed|Completed
        action: drop
      
      # è®¾ç½®æ—¥å¿—æ–‡ä»¶è·¯å¾„
      - source_labels:
          - __meta_kubernetes_pod_uid
          - __meta_kubernetes_pod_container_name
        target_label: __path__
        separator: /
        replacement: /var/log/pods/*$1/*.log
      
      # æ·»åŠ å‘½åç©ºé—´æ ‡ç­¾
      - source_labels:
          - __meta_kubernetes_namespace_name
        target_label: namespace
      
      # æ·»åŠ Podåç§°æ ‡ç­¾
      - source_labels:
          - __meta_kubernetes_pod_name
        target_label: pod
      
      # æ·»åŠ å®¹å™¨åç§°æ ‡ç­¾
      - source_labels:
          - __meta_kubernetes_pod_container_name
        target_label: container

    # ç³»ç»Ÿæ—¥å¿—æ”¶é›†
    - job_name: system-logs
      static_configs:
      - targets:
          - localhost
        labels:
          job: system-logs
          __path__: /var/log/syslog
---
# Promtail DaemonSet
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: promtail
  namespace: logging
spec:
  selector:
    matchLabels:
      app: promtail
  template:
    metadata:
      labels:
        app: promtail
    spec:
      containers:
      - name: promtail
        image: grafana/promtail:2.9.0
        args:
        - -config.file=/etc/promtail/config.yml
        - -client.url=http://loki:3100/loki/api/v1/push
        volumeMounts:
        - name: config
          mountPath: /etc/promtail
        - name: varlog
          mountPath: /var/log
          readOnly: true
        - name: varlibdockercontainers
          mountPath: /var/lib/docker/containers
          readOnly: true
        resources:
          limits:
            memory: 200Mi
          requests:
            memory: 100Mi
            cpu: 100m
      volumes:
      - name: config
        configMap:
          name: promtail-config
      - name: varlog
        hostPath:
          path: /var/log
      - name: varlibdockercontainers
        hostPath:
          path: /var/lib/docker/containers
```

### 4.4 LokiæœåŠ¡å™¨é…ç½®


**Lokié…ç½®è¦ç‚¹**ï¼š
```yaml
# loki-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: loki-config
data:
  loki.yaml: |
    auth_enabled: false

    server:
      http_listen_port: 3100
      grpc_listen_port: 9096

    ingester:
      wal:
        enabled: true
        dir: /loki/wal
      lifecycler:
        address: 127.0.0.1
        ring:
          kvstore:
            store: inmemory
          replication_factor: 1
        final_sleep: 0s
      chunk_idle_period: 1h
      max_chunk_age: 1h
      chunk_target_size: 1048576
      chunk_retain_period: 30s

    schema_config:
      configs:
        - from: 2020-10-24
          store: boltdb-shipper
          object_store: filesystem
          schema: v11
          index:
            prefix: index_
            period: 24h

    storage_config:
      boltdb_shipper:
        active_index_directory: /loki/boltdb-shipper-active
        cache_location: /loki/boltdb-shipper-cache
        cache_ttl: 24h
        shared_store: filesystem
      filesystem:
        directory: /loki/chunks

    compactor:
      working_directory: /loki/boltdb-shipper-compactor
      shared_store: filesystem

    limits_config:
      reject_old_samples: true
      reject_old_samples_max_age: 168h

    chunk_store_config:
      max_look_back_period: 0s

    table_manager:
      retention_deletes_enabled: false
      retention_period: 0s

    ruler:
      storage:
        type: local
        local:
          directory: /loki/rules
      rule_path: /loki/rules-temp
      alertmanager_url: http://localhost:9093
      ring:
        kvstore:
          store: inmemory
      enable_api: true
---
# Loki Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: loki
  namespace: logging
spec:
  replicas: 1
  selector:
    matchLabels:
      app: loki
  template:
    metadata:
      labels:
        app: loki
    spec:
      containers:
      - name: loki
        image: grafana/loki:2.9.0
        args:
        - -config.file=/etc/loki/loki.yaml
        ports:
        - containerPort: 3100
        volumeMounts:
        - name: config
          mountPath: /etc/loki
        - name: storage
          mountPath: /loki
        resources:
          limits:
            memory: 2Gi
          requests:
            memory: 1Gi
            cpu: 500m
      volumes:
      - name: config
        configMap:
          name: loki-config
      - name: storage
        persistentVolumeClaim:
          claimName: loki-storage
```

---

## 5. ğŸ“¦ å®¹å™¨æ—¥å¿—ç®¡ç†


### 5.1 å®¹å™¨æ—¥å¿—ç±»å‹ç†è§£


**å®¹å™¨äº§ç”Ÿçš„æ—¥å¿—åˆ†ç±»**ï¼š
```
åº”ç”¨æ—¥å¿—ï¼ˆApplication Logsï¼‰ï¼š
â”œâ”€ æ ‡å‡†è¾“å‡ºæ—¥å¿— (stdout)
â”œâ”€ æ ‡å‡†é”™è¯¯æ—¥å¿— (stderr)  
â””â”€ åº”ç”¨å†…éƒ¨æ—¥å¿—æ–‡ä»¶

ç³»ç»Ÿæ—¥å¿—ï¼ˆSystem Logsï¼‰ï¼š
â”œâ”€ å®¹å™¨è¿è¡Œæ—¶æ—¥å¿— (containerd/docker)
â”œâ”€ kubeletæ—¥å¿—
â””â”€ ç³»ç»ŸæœåŠ¡æ—¥å¿—

å®¡è®¡æ—¥å¿—ï¼ˆAudit Logsï¼‰ï¼š
â”œâ”€ Kubernetes APIå®¡è®¡
â”œâ”€ èŠ‚ç‚¹è®¿é—®å®¡è®¡
â””â”€ ç½‘ç»œè®¿é—®å®¡è®¡
```

**å®¹å™¨æ—¥å¿—å­˜å‚¨ä½ç½®**ï¼š
```
# Dockerè¿è¡Œæ—¶
/var/lib/docker/containers/<container-id>/<container-id>-json.log

# Containerdè¿è¡Œæ—¶  
/var/log/pods/<namespace>_<pod-name>_<pod-uid>/<container-name>/*.log

# å®é™…è·¯å¾„ç¤ºä¾‹
/var/log/pods/default_nginx-deployment-7d8b49ccf7-x8k9p_a1b2c3d4-e5f6-7g8h-9i0j-k1l2m3n4o5p6/nginx/0.log
```

### 5.2 å®¹å™¨æ—¥å¿—è½®è½¬é…ç½®


**ä¸ºä»€ä¹ˆéœ€è¦æ—¥å¿—è½®è½¬**ï¼š
- é˜²æ­¢å•ä¸ªæ—¥å¿—æ–‡ä»¶è¿‡å¤§å æ»¡ç£ç›˜
- ä¿æŒä¸€å®šçš„å†å²æ—¥å¿—ç”¨äºæ’æŸ¥é—®é¢˜
- å®šæœŸæ¸…ç†è¿‡æœŸæ—¥å¿—é‡Šæ”¾ç©ºé—´

**å®¹å™¨è¿è¡Œæ—¶æ—¥å¿—é…ç½®**ï¼š
```yaml
# é€šè¿‡kubeleté…ç½®å®¹å™¨æ—¥å¿—è½®è½¬
apiVersion: v1
kind: ConfigMap
metadata:
  name: kubelet-config
  namespace: kube-system
data:
  config.yaml: |
    apiVersion: kubelet.config.k8s.io/v1beta1
    kind: KubeletConfiguration
    
    # å®¹å™¨æ—¥å¿—è½®è½¬é…ç½®
    containerLogMaxSize: "10Mi"      # å•ä¸ªæ—¥å¿—æ–‡ä»¶æœ€å¤§10MB
    containerLogMaxFiles: 5          # ä¿ç•™æœ€æ–°5ä¸ªæ—¥å¿—æ–‡ä»¶
    
    # ç­‰ä»·äºï¼šæ€»æ—¥å¿—å¤§å°é™åˆ¶ = 10MB * 5 = 50MB perå®¹å™¨
```

**Podçº§åˆ«æ—¥å¿—é…ç½®**ï¼š
```yaml
# åœ¨Podä¸­é…ç½®æ—¥å¿—ç›¸å…³å‚æ•°
apiVersion: v1
kind: Pod
metadata:
  name: app-with-log-config
spec:
  containers:
  - name: app
    image: nginx
    # åº”ç”¨æ—¥å¿—è¾“å‡ºåˆ°stdout/stderrä¼šè¢«è‡ªåŠ¨æ”¶é›†
    # å¦‚æœåº”ç”¨å†™æ—¥å¿—æ–‡ä»¶ï¼Œéœ€è¦æŒ‚è½½volume
    volumeMounts:
    - name: app-logs
      mountPath: /var/log/nginx
  
  # è¾¹è½¦å®¹å™¨æ¨¡å¼ï¼šä¸“é—¨å¤„ç†æ—¥å¿—æ–‡ä»¶
  - name: log-sidecar
    image: busybox
    command: ["sh", "-c"]
    args:
    - |
      # å°†æ—¥å¿—æ–‡ä»¶å†…å®¹è¾“å‡ºåˆ°stdout
      tail -F /var/log/nginx/access.log /var/log/nginx/error.log
    volumeMounts:
    - name: app-logs
      mountPath: /var/log/nginx
  
  volumes:
  - name: app-logs
    emptyDir: {}
```

### 5.3 å¤šå®¹å™¨Podæ—¥å¿—ç­–ç•¥


**å¤šå®¹å™¨æ—¥å¿—å¤„ç†æ¨¡å¼**ï¼š

**æ¨¡å¼1ï¼šè¾¹è½¦å®¹å™¨æ¨¡å¼**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             Pod                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  åº”ç”¨å®¹å™¨    â”‚  â”‚  è¾¹è½¦å®¹å™¨    â”‚   â”‚
â”‚  â”‚             â”‚  â”‚             â”‚   â”‚
â”‚  â”‚ å†™æ—¥å¿—æ–‡ä»¶   â”‚  â”‚ tailæ—¥å¿—æ–‡ä»¶ â”‚   â”‚
â”‚  â”‚     â†“       â”‚  â”‚     â†“       â”‚   â”‚
â”‚  â”‚ /app/logs/  â”‚  â”‚  è¾“å‡ºstdout â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚               â”‚           â”‚
â”‚         â””â”€â”€â”€å…±äº«Volumeâ”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
              æ—¥å¿—æ”¶é›†å™¨æ”¶é›†stdout
```

**æ¨¡å¼2ï¼šæ—¥å¿—ä»£ç†æ¨¡å¼**
```yaml
# ä½¿ç”¨Fluent Bitä½œä¸ºè¾¹è½¦å®¹å™¨
apiVersion: v1
kind: Pod
metadata:
  name: app-with-fluent-bit-sidecar
spec:
  containers:
  # ä¸»åº”ç”¨å®¹å™¨
  - name: app
    image: myapp:latest
    volumeMounts:
    - name: app-logs
      mountPath: /app/logs

  # Fluent Bitè¾¹è½¦å®¹å™¨
  - name: fluent-bit
    image: fluent/fluent-bit:2.2
    volumeMounts:
    - name: app-logs
      mountPath: /app/logs
      readOnly: true
    - name: fluent-bit-config
      mountPath: /fluent-bit/etc/

  volumes:
  - name: app-logs
    emptyDir: {}
  - name: fluent-bit-config
    configMap:
      name: fluent-bit-sidecar-config
```

---

## 6. ğŸ›¡ï¸ ç³»ç»Ÿä¸å®¡è®¡æ—¥å¿—


### 6.1 systemdæ—¥å¿—ç®¡ç†(journald)


**ä»€ä¹ˆæ˜¯journald**ï¼š
- systemdçš„æ—¥å¿—ç®¡ç†ç»„ä»¶
- æ”¶é›†ç³»ç»ŸæœåŠ¡ã€å†…æ ¸ã€åº”ç”¨ç¨‹åºçš„æ—¥å¿—
- æä¾›ç»“æ„åŒ–çš„æ—¥å¿—å­˜å‚¨å’ŒæŸ¥è¯¢

**journaldé…ç½®**ï¼š
```yaml
# é€šè¿‡ConfigMapç®¡ç†journaldé…ç½®
apiVersion: v1
kind: ConfigMap
metadata:
  name: journald-config
data:
  journald.conf: |
    [Journal]
    # å­˜å‚¨æ¨¡å¼
    Storage=persistent
    # å‹ç¼©å†å²æ—¥å¿—
    Compress=yes
    # æœ€å¤§å ç”¨ç©ºé—´
    SystemMaxUse=1G
    SystemMaxFileSize=100M
    # æ—¥å¿—ä¿ç•™æ—¶é—´
    MaxRetentionSec=1month
    # åŒæ­¥åˆ°ç£ç›˜çš„é¢‘ç‡
    SyncIntervalSec=5min
```

**æ”¶é›†journaldæ—¥å¿—**ï¼š
```yaml
# Fluent Bitæ”¶é›†systemdæ—¥å¿—
apiVersion: v1
kind: ConfigMap
metadata:
  name: fluent-bit-system-config
data:
  fluent-bit.conf: |
    [INPUT]
        Name                systemd
        Tag                 systemd.*
        Read_From_Tail      On
        Strip_Underscores   On
        
    [FILTER]
        Name                modify
        Match               systemd.*
        Add                 source systemd
        
    [OUTPUT]
        Name                forward
        Match               systemd.*
        Host                loki
        Port                3100
```

### 6.2 Kuberneteså®¡è®¡æ—¥å¿—


**ä»€ä¹ˆæ˜¯å®¡è®¡æ—¥å¿—**ï¼š
- è®°å½•å¯¹Kubernetes APIçš„æ‰€æœ‰è®¿é—®
- åŒ…æ‹¬ç”¨æˆ·æ“ä½œã€ç³»ç»Ÿç»„ä»¶æ“ä½œ
- ç”¨äºå®‰å…¨å®¡è®¡å’Œæ•…éšœæ’æŸ¥

**å®¡è®¡ç­–ç•¥é…ç½®**ï¼š
```yaml
# audit-policy.yaml
apiVersion: audit.k8s.io/v1
kind: Policy
omitStages:
  - RequestReceived
rules:
# è®°å½•é‡è¦èµ„æºçš„æ“ä½œ
- level: Metadata
  namespaces: ["default", "kube-system"]
  verbs: ["create", "update", "delete"]
  resources:
  - group: ""
    resources: ["pods", "services"]
  - group: "apps"
    resources: ["deployments", "replicasets"]

# è®°å½•Secretæ“ä½œ(ä½†ä¸è®°å½•å†…å®¹)
- level: Metadata
  resources:
  - group: ""
    resources: ["secrets"]

# å¿½ç•¥åªè¯»æ“ä½œ
- level: None
  verbs: ["get", "list", "watch"]

# è®°å½•æ‰€æœ‰å…¶ä»–æ“ä½œçš„åŸºæœ¬ä¿¡æ¯
- level: Request
  omitStages:
  - RequestReceived
```

**API Serverå®¡è®¡é…ç½®**ï¼š
```yaml
# åœ¨kube-apiserverå¯åŠ¨å‚æ•°ä¸­æ·»åŠ 
apiVersion: v1
kind: Pod
metadata:
  name: kube-apiserver
spec:
  containers:
  - name: kube-apiserver
    image: k8s.gcr.io/kube-apiserver:v1.28.0
    command:
    - kube-apiserver
    # å®¡è®¡æ—¥å¿—ç›¸å…³å‚æ•°
    - --audit-log-path=/var/log/audit.log
    - --audit-log-maxage=30
    - --audit-log-maxbackup=10
    - --audit-log-maxsize=100
    - --audit-policy-file=/etc/kubernetes/audit-policy.yaml
    
    volumeMounts:
    - name: audit-policy
      mountPath: /etc/kubernetes/audit-policy.yaml
      readOnly: true
    - name: audit-logs
      mountPath: /var/log
      
  volumes:
  - name: audit-policy
    configMap:
      name: audit-policy
  - name: audit-logs
    hostPath:
      path: /var/log/kubernetes/audit
```

### 6.3 èŠ‚ç‚¹ç³»ç»Ÿæ—¥å¿—æ”¶é›†


**æ”¶é›†èŠ‚ç‚¹å…³é”®æ—¥å¿—**ï¼š
```yaml
# èŠ‚ç‚¹æ—¥å¿—æ”¶é›†DaemonSet
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: node-log-collector
spec:
  selector:
    matchLabels:
      app: node-log-collector
  template:
    spec:
      containers:
      - name: collector
        image: fluent/fluent-bit:2.2
        env:
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
              
        volumeMounts:
        # ç³»ç»Ÿæ—¥å¿—ç›®å½•
        - name: varlog
          mountPath: /var/log
          readOnly: true
        # journalæ—¥å¿—  
        - name: journald
          mountPath: /run/log/journal
          readOnly: true
        # å†…æ ¸æ—¥å¿—
        - name: kmsg
          mountPath: /dev/kmsg
          readOnly: true
          
        # Fluent Bité…ç½®
        - name: config
          mountPath: /fluent-bit/etc/
          
      volumes:
      - name: varlog
        hostPath:
          path: /var/log
      - name: journald
        hostPath:
          path: /run/log/journal
      - name: kmsg
        hostPath:
          path: /dev/kmsg
      - name: config
        configMap:
          name: node-log-collector-config
```

**èŠ‚ç‚¹æ—¥å¿—æ”¶é›†é…ç½®**ï¼š
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: node-log-collector-config
data:
  fluent-bit.conf: |
    [INPUT]
        Name              tail
        Tag               node.syslog
        Path              /var/log/syslog
        Parser            syslog-rfc3164
        DB                /tmp/syslog.db
        
    [INPUT]
        Name              tail  
        Tag               node.auth
        Path              /var/log/auth.log
        Parser            syslog-rfc3164
        DB                /tmp/auth.db
        
    [INPUT]
        Name              kmsg
        Tag               node.kernel
        
    [INPUT]
        Name              systemd
        Tag               node.systemd
        Read_From_Tail    On
        
    [FILTER]
        Name              kubernetes
        Match             node.*
        Kube_URL          https://kubernetes.default.svc:443
        
    [OUTPUT]
        Name              loki
        Match             node.*
        Host              loki.logging.svc.cluster.local
        Port              3100
        Labels            job=node-logs,node=${NODE_NAME}
```

---

## 7. ğŸ¯ æ—¥å¿—é…ç½®æœ€ä½³å®è·µ


### 7.1 æ—¥å¿—çº§åˆ«ä¸æ ¼å¼è§„èŒƒ


**åº”ç”¨æ—¥å¿—çº§åˆ«æ ‡å‡†**ï¼š
```
FATALï¼šç³»ç»Ÿä¸å¯ç”¨ï¼Œéœ€è¦ç«‹å³å¤„ç†
ERRORï¼šå‘ç”Ÿé”™è¯¯ï¼Œä½†ç³»ç»Ÿå¯ä»¥ç»§ç»­è¿è¡Œ  
WARNï¼š è­¦å‘Šä¿¡æ¯ï¼Œå¯èƒ½å­˜åœ¨æ½œåœ¨é—®é¢˜
INFOï¼š ä¸€èˆ¬ä¿¡æ¯ï¼Œè®°å½•é‡è¦çš„ä¸šåŠ¡æµç¨‹
DEBUGï¼šè°ƒè¯•ä¿¡æ¯ï¼Œå¼€å‘é˜¶æ®µä½¿ç”¨
TRACEï¼šè·Ÿè¸ªä¿¡æ¯ï¼Œéå¸¸è¯¦ç»†çš„æ‰§è¡Œæµç¨‹
```

**ç»“æ„åŒ–æ—¥å¿—æ ¼å¼**ï¼š
```json
{
  "timestamp": "2024-01-19T15:30:45.123Z",
  "level": "INFO",
  "service": "user-api",
  "version": "v1.2.3",
  "traceId": "abc123def456",
  "message": "User login successful",
  "userId": 12345,
  "clientIP": "192.168.1.100",
  "duration": 156,
  "tags": ["auth", "login"]
}
```

**åº”ç”¨æ—¥å¿—é…ç½®ç¤ºä¾‹**ï¼š
```yaml
# åº”ç”¨å®¹å™¨çš„ç¯å¢ƒå˜é‡é…ç½®
apiVersion: v1
kind: Deployment
metadata:
  name: user-api
spec:
  template:
    spec:
      containers:
      - name: user-api
        image: mycompany/user-api:v1.2.3
        env:
        # æ—¥å¿—é…ç½®ç¯å¢ƒå˜é‡
        - name: LOG_LEVEL
          value: "INFO"
        - name: LOG_FORMAT
          value: "json"          # ç»“æ„åŒ–æ—¥å¿—
        - name: LOG_OUTPUT
          value: "stdout"        # è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡º
        - name: LOG_TIMESTAMP_FORMAT
          value: "rfc3339"       # ISO 8601æ—¶é—´æ ¼å¼
```

### 7.2 èµ„æºé™åˆ¶ä¸æ€§èƒ½ä¼˜åŒ–


**æ—¥å¿—æ”¶é›†å™¨èµ„æºé…ç½®åŸåˆ™**ï¼š
```yaml
# ä¸åŒè§„æ¨¡é›†ç¾¤çš„èµ„æºé…ç½®å»ºè®®
apiVersion: v1
kind: ConfigMap
metadata:
  name: log-collector-sizing
data:
  small-cluster.yaml: |
    # å°é›†ç¾¤ (< 10èŠ‚ç‚¹)
    resources:
      requests:
        memory: 64Mi
        cpu: 50m
      limits:
        memory: 128Mi
        cpu: 200m
        
  medium-cluster.yaml: |
    # ä¸­ç­‰é›†ç¾¤ (10-50èŠ‚ç‚¹)  
    resources:
      requests:
        memory: 128Mi
        cpu: 100m
      limits:
        memory: 256Mi
        cpu: 500m
        
  large-cluster.yaml: |
    # å¤§é›†ç¾¤ (50+èŠ‚ç‚¹)
    resources:
      requests:
        memory: 256Mi
        cpu: 200m
      limits:
        memory: 512Mi
        cpu: 1000m
```

**æ—¥å¿—è½®è½¬å’Œä¿ç•™ç­–ç•¥**ï¼š
```yaml
# æ—¥å¿—ä¿ç•™ç­–ç•¥é…ç½®
apiVersion: v1
kind: ConfigMap
metadata:
  name: log-retention-policy
data:
  policy.yaml: |
    # åº”ç”¨æ—¥å¿—ä¿ç•™ç­–ç•¥
    application_logs:
      retention_days: 30        # ä¿ç•™30å¤©
      max_size_per_file: 100MB  # å•æ–‡ä»¶æœ€å¤§100MB
      max_files: 10             # æœ€å¤šä¿ç•™10ä¸ªæ–‡ä»¶
      compress_after_days: 7    # 7å¤©åå‹ç¼©
      
    # ç³»ç»Ÿæ—¥å¿—ä¿ç•™ç­–ç•¥  
    system_logs:
      retention_days: 90        # ä¿ç•™90å¤©
      max_size_per_file: 50MB
      max_files: 20
      compress_after_days: 3
      
    # å®¡è®¡æ—¥å¿—ä¿ç•™ç­–ç•¥
    audit_logs:
      retention_days: 365       # ä¿ç•™1å¹´
      max_size_per_file: 200MB
      max_files: 50
      compress_after_days: 1    # ç«‹å³å‹ç¼©
```

### 7.3 æ—¥å¿—å®‰å…¨ä¸åˆè§„


**æ•æ„Ÿä¿¡æ¯è¿‡æ»¤**ï¼š
```yaml
# Logstashæ•æ„Ÿä¿¡æ¯è¿‡æ»¤é…ç½®
apiVersion: v1
kind: ConfigMap
metadata:
  name: log-security-config
data:
  security-filter.conf: |
    filter {
      # è¿‡æ»¤å¯†ç å­—æ®µ
      mutate {
        gsub => [
          "message", "password=[^&\s]+", "password=***FILTERED***",
          "message", "passwd=[^&\s]+", "passwd=***FILTERED***",
          "message", "secret=[^&\s]+", "secret=***FILTERED***"
        ]
      }
      
      # è¿‡æ»¤ä¿¡ç”¨å¡å·
      mutate {
        gsub => [
          "message", "\b\d{4}[\s-]?\d{4}[\s-]?\d{4}[\s-]?\d{4}\b", "****-****-****-****"
        ]
      }
      
      # è¿‡æ»¤èº«ä»½è¯å·  
      mutate {
        gsub => [
          "message", "\b\d{18}|\d{17}X\b", "***FILTERED_ID***"
        ]
      }
      
      # åˆ é™¤åŒ…å«æ•æ„Ÿä¿¡æ¯çš„æ•´è¡Œæ—¥å¿—
      if [message] =~ /Authorization:\s*Bearer/ {
        drop { }
      }
    }
```

**è®¿é—®æ§åˆ¶é…ç½®**ï¼š
```yaml
# Elasticsearchè®¿é—®æ§åˆ¶
apiVersion: v1
kind: Secret
metadata:
  name: elasticsearch-auth
type: Opaque
data:
  # åŸºç¡€è®¤è¯
  username: bG9nX3VzZXI=  # log_user
  password: c2VjdXJlX3Bhc3M=  # secure_pass
---
# åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶
apiVersion: v1
kind: ConfigMap
metadata:
  name: elasticsearch-rbac
data:
  roles.yml: |
    # åªè¯»ç”¨æˆ·è§’è‰²
    log_reader:
      cluster: ["monitor"]
      indices:
        - names: ["logs-*"]
          privileges: ["read"]
          
    # æ—¥å¿—ç®¡ç†å‘˜è§’è‰²  
    log_admin:
      cluster: ["monitor", "manage"]
      indices:
        - names: ["logs-*"]
          privileges: ["all"]
```

### 7.4 ç›‘æ§ä¸å‘Šè­¦é…ç½®


**åŸºäºæ—¥å¿—çš„å‘Šè­¦è§„åˆ™**ï¼š
```yaml
# Prometheusè§„åˆ™é…ç½®
apiVersion: v1
kind: ConfigMap
metadata:
  name: log-based-alerts
data:
  alerts.yml: |
    groups:
    - name: application-logs
      rules:
      # é”™è¯¯æ—¥å¿—é¢‘ç‡å‘Šè­¦
      - alert: HighErrorRate
        expr: |
          (
            rate(loki_log_entries_total{level="ERROR"}[5m]) * 60 > 10
          )
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "åº”ç”¨é”™è¯¯æ—¥å¿—é¢‘ç‡è¿‡é«˜"
          description: "{{ $labels.service }} åœ¨è¿‡å»5åˆ†é’Ÿå†…ERRORæ—¥å¿—è¶…è¿‡10æ¡/åˆ†é’Ÿ"
          
      # è‡´å‘½é”™è¯¯å‘Šè­¦
      - alert: FatalError
        expr: |
          increase(loki_log_entries_total{level="FATAL"}[1m]) > 0
        for: 0m
        labels:
          severity: critical
        annotations:
          summary: "æ£€æµ‹åˆ°è‡´å‘½é”™è¯¯"
          description: "{{ $labels.service }} å‡ºç°FATALçº§åˆ«é”™è¯¯"
          
    - name: infrastructure-logs  
      rules:
      # èŠ‚ç‚¹ç£ç›˜ç©ºé—´å‘Šè­¦
      - alert: NodeDiskSpaceLow
        expr: |
          (
            node_filesystem_avail_bytes{mountpoint="/"} / 
            node_filesystem_size_bytes{mountpoint="/"} * 100 < 20
          )
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "èŠ‚ç‚¹ç£ç›˜ç©ºé—´ä¸è¶³"
          description: "èŠ‚ç‚¹ {{ $labels.instance }} æ ¹åˆ†åŒºå¯ç”¨ç©ºé—´ä½äº20%"
```

**æ—¥å¿—æ”¶é›†å™¨å¥åº·ç›‘æ§**ï¼š
```yaml
# ç›‘æ§æ—¥å¿—æ”¶é›†å™¨çŠ¶æ€
apiVersion: v1
kind: ServiceMonitor
metadata:
  name: fluent-bit-metrics
spec:
  selector:
    matchLabels:
      app: fluent-bit
  endpoints:
  - port: metrics
    interval: 30s
    path: /api/v1/metrics/prometheus
---
# Fluent Bitå¥åº·æ£€æŸ¥
apiVersion: v1
kind: Service
metadata:
  name: fluent-bit-metrics
  labels:
    app: fluent-bit
spec:
  selector:
    app: fluent-bit
  ports:
  - name: metrics
    port: 2020
    targetPort: 2020
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ”¸ æ—¥å¿—èšåˆæœ¬è´¨ï¼šå°†åˆ†æ•£çš„æ—¥å¿—ç»Ÿä¸€æ”¶é›†ã€å­˜å‚¨ã€å±•ç¤º
ğŸ”¸ æ ¸å¿ƒç»„ä»¶ä½œç”¨ï¼šé‡‡é›†å™¨â†’å¤„ç†å™¨â†’å­˜å‚¨â†’å¯è§†åŒ–çš„å®Œæ•´é“¾è·¯
ğŸ”¸ æŠ€æœ¯æ ˆé€‰æ‹©ï¼šELKé€‚åˆå¤æ‚åˆ†æï¼ŒLokié€‚åˆè½»é‡èšåˆ
ğŸ”¸ å®¹å™¨æ—¥å¿—ç‰¹ç‚¹ï¼šä¸´æ—¶æ€§å¼ºï¼Œéœ€è¦å¤–éƒ¨æŒä¹…åŒ–å­˜å‚¨
ğŸ”¸ é…ç½®å…³é”®ç‚¹ï¼šèµ„æºé™åˆ¶ã€æ—¥å¿—è½®è½¬ã€å®‰å…¨è¿‡æ»¤
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆéœ€è¦æ—¥å¿—èšåˆ**ï¼š
```
é—®é¢˜æ ¹æºï¼š
- Podé‡å¯æ—¥å¿—ä¸¢å¤±
- èŠ‚ç‚¹æ•…éšœæ—¥å¿—æ— æ³•è®¿é—®  
- å¤šèŠ‚ç‚¹æ—¥å¿—åˆ†æ•£éš¾æŸ¥æ‰¾
- ç¼ºä¹ç»Ÿä¸€çš„åˆ†æèƒ½åŠ›

è§£å†³ä»·å€¼ï¼š
- é›†ä¸­ç®¡ç†ï¼šä¸€å¤„æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—
- æŒä¹…ä¿å­˜ï¼šæ—¥å¿—ä¸éšPodé”€æ¯è€Œä¸¢å¤±
- å¿«é€Ÿæœç´¢ï¼šåŸºäºå…³é”®è¯å¿«é€Ÿå®šä½é—®é¢˜
- è¶‹åŠ¿åˆ†æï¼šé€šè¿‡å›¾è¡¨å‘ç°å¼‚å¸¸æ¨¡å¼
```

**ğŸ”¹ æŠ€æœ¯æ–¹æ¡ˆå¦‚ä½•é€‰æ‹©**ï¼š
```
ELKæ–¹æ¡ˆï¼š
é€‚ç”¨ï¼šéœ€è¦å¤æ‚æ—¥å¿—åˆ†æã€å…¨æ–‡æ£€ç´¢
æˆæœ¬ï¼šèµ„æºæ¶ˆè€—é«˜ï¼Œå­¦ä¹ æˆæœ¬é«˜
åœºæ™¯ï¼šå¤§å‹ä¼ä¸šã€å¤æ‚ä¸šåŠ¡åˆ†æ

Lokiæ–¹æ¡ˆï¼š  
é€‚ç”¨ï¼šæ—¥å¿—èšåˆæŸ¥çœ‹ã€æ ‡ç­¾è¿‡æ»¤
æˆæœ¬ï¼šèµ„æºæ¶ˆè€—ä½ï¼Œé…ç½®ç®€å•
åœºæ™¯ï¼šä¸­å°ä¼ä¸šã€åŸºç¡€æ—¥å¿—ç®¡ç†

é€‰æ‹©åŸåˆ™ï¼š
- éœ€æ±‚é©±åŠ¨ï¼šæ ¹æ®å®é™…ä½¿ç”¨åœºæ™¯é€‰æ‹©
- èµ„æºè€ƒè™‘ï¼šè¯„ä¼°é›†ç¾¤èµ„æºæ‰¿å—èƒ½åŠ›
- æˆæœ¬å¹³è¡¡ï¼šåŠŸèƒ½éœ€æ±‚vsè¿ç»´æˆæœ¬
```

**ğŸ”¹ é…ç½®è¦ç‚¹ç†è§£**ï¼š
```
èµ„æºé…ç½®ï¼š
- é‡‡é›†å™¨ï¼šè½»é‡é…ç½®ï¼Œå¤šå®ä¾‹éƒ¨ç½²
- å¤„ç†å™¨ï¼šä¸­ç­‰é…ç½®ï¼Œå¤„ç†èƒ½åŠ›è¦åŒ¹é…
- å­˜å‚¨ï¼šé‡ç‚¹é…ç½®ï¼Œå½±å“æŸ¥è¯¢æ€§èƒ½

å®‰å…¨é…ç½®ï¼š
- æ•æ„Ÿä¿¡æ¯è¿‡æ»¤ï¼šé˜²æ­¢å¯†ç ç­‰æ³„éœ²
- è®¿é—®æƒé™æ§åˆ¶ï¼šä¸åŒè§’è‰²ä¸åŒæƒé™
- ç½‘ç»œå®‰å…¨ï¼šå†…éƒ¨é€šä¿¡åŠ å¯†

æ€§èƒ½ä¼˜åŒ–ï¼š
- æ—¥å¿—è½®è½¬ï¼šé˜²æ­¢ç£ç›˜æ’‘æ»¡
- æ‰¹é‡å¤„ç†ï¼šæé«˜ä¼ è¾“æ•ˆç‡
- ç´¢å¼•ä¼˜åŒ–ï¼šå¹³è¡¡å­˜å‚¨å’ŒæŸ¥è¯¢æ€§èƒ½
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ éƒ¨ç½²é¡ºåºå»ºè®®**ï¼š
```
ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©æŠ€æœ¯æ–¹æ¡ˆ
- è¯„ä¼°æ—¥å¿—é‡å’ŒæŸ¥è¯¢éœ€æ±‚
- ç¡®å®šELKè¿˜æ˜¯Lokiæ–¹æ¡ˆ

ç¬¬äºŒæ­¥ï¼šéƒ¨ç½²å­˜å‚¨ç»„ä»¶
- Elasticsearché›†ç¾¤æˆ–LokiæœåŠ¡
- é…ç½®æŒä¹…åŒ–å­˜å‚¨

ç¬¬ä¸‰æ­¥ï¼šéƒ¨ç½²é‡‡é›†å™¨
- åœ¨æ¯ä¸ªèŠ‚ç‚¹éƒ¨ç½²æ—¥å¿—é‡‡é›†å™¨
- é…ç½®æ—¥å¿—è·¯å¾„å’Œæ ‡ç­¾

ç¬¬å››æ­¥ï¼šéƒ¨ç½²å¯è§†åŒ–
- Kibanaæˆ–Grafanaç•Œé¢
- åˆ›å»ºå¸¸ç”¨æŸ¥è¯¢å’Œä»ªè¡¨æ¿

ç¬¬äº”æ­¥ï¼šé…ç½®å‘Šè­¦
- åŸºäºæ—¥å¿—å†…å®¹è®¾ç½®å‘Šè­¦
- é›†æˆåˆ°ç°æœ‰ç›‘æ§ç³»ç»Ÿ
```

**ğŸ”§ å¸¸è§é—®é¢˜è§£å†³**ï¼š
```
æ—¥å¿—ä¸¢å¤±ï¼š
- æ£€æŸ¥é‡‡é›†å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œ
- ç¡®è®¤æ—¥å¿—è·¯å¾„é…ç½®æ­£ç¡®
- éªŒè¯ç½‘ç»œè¿æ¥å’Œè®¤è¯

æŸ¥è¯¢ç¼“æ…¢ï¼š
- ä¼˜åŒ–ç´¢å¼•é…ç½®
- é™åˆ¶æ—¶é—´èŒƒå›´æŸ¥è¯¢
- ä½¿ç”¨æ ‡ç­¾è¿‡æ»¤å‡å°‘æ•°æ®é‡

èµ„æºä¸è¶³ï¼š
- è°ƒæ•´èµ„æºé™åˆ¶é…ç½®
- ä¼˜åŒ–æ—¥å¿—è½®è½¬ç­–ç•¥  
- è€ƒè™‘ä½¿ç”¨æ›´è½»é‡çš„æ–¹æ¡ˆ

å­˜å‚¨ç©ºé—´ï¼š
- é…ç½®åˆç†çš„ä¿ç•™ç­–ç•¥
- å¯ç”¨æ—¥å¿—å‹ç¼©
- å®šæœŸæ¸…ç†å†å²æ•°æ®
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- æ—¥å¿—èšåˆè§£å†³åˆ†æ•£ç®¡ç†éš¾é¢˜ï¼Œæä¾›ç»Ÿä¸€è§†å›¾
- é€‰æ‹©æ–¹æ¡ˆè¦å¹³è¡¡åŠŸèƒ½éœ€æ±‚å’Œèµ„æºæˆæœ¬
- é…ç½®é‡ç‚¹åœ¨èµ„æºæ§åˆ¶ã€å®‰å…¨è¿‡æ»¤ã€æ€§èƒ½ä¼˜åŒ–
- éƒ¨ç½²è¦å¾ªåºæ¸è¿›ï¼Œå…ˆå­˜å‚¨å†é‡‡é›†æœ€åå¯è§†åŒ–