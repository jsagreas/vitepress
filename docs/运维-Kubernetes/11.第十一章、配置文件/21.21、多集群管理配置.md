---
title: 21ã€å¤šé›†ç¾¤ç®¡ç†é…ç½®
---
## ğŸ“š ç›®å½•

1. [å¤šé›†ç¾¤ç®¡ç†åŸºç¡€æ¦‚å¿µ](#1-å¤šé›†ç¾¤ç®¡ç†åŸºç¡€æ¦‚å¿µ)
2. [Admiralå¤šé›†ç¾¤ç®¡ç†é…ç½®](#2-Admiralå¤šé›†ç¾¤ç®¡ç†é…ç½®)
3. [Submarinerå¤šé›†ç¾¤ç½‘ç»œé…ç½®](#3-Submarinerå¤šé›†ç¾¤ç½‘ç»œé…ç½®)
4. [Clusternetå¤šé›†ç¾¤ç®¡ç†é…ç½®](#4-Clusternetå¤šé›†ç¾¤ç®¡ç†é…ç½®)
5. [Open Cluster Managementé…ç½®](#5-Open-Cluster-Managementé…ç½®)
6. [Rancherå¤šé›†ç¾¤ç®¡ç†é…ç½®](#6-Rancherå¤šé›†ç¾¤ç®¡ç†é…ç½®)
7. [Cluster APIé›†ç¾¤ç®¡ç†é…ç½®](#7-Cluster-APIé›†ç¾¤ç®¡ç†é…ç½®)
8. [Virtual Kubeleté…ç½®](#8-Virtual-Kubeleté…ç½®)
9. [è·¨é›†ç¾¤æœåŠ¡å‘ç°é…ç½®](#9-è·¨é›†ç¾¤æœåŠ¡å‘ç°é…ç½®)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ å¤šé›†ç¾¤ç®¡ç†åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯å¤šé›†ç¾¤ç®¡ç†

ğŸ¯ **ç”Ÿæ´»åŒ–ç†è§£**ï¼šå¤šé›†ç¾¤ç®¡ç†å°±åƒç®¡ç†å¤šä¸ªåˆ†å…¬å¸

```
ä¼ ç»Ÿå•é›†ç¾¤ï¼š
å°±åƒåªæœ‰ä¸€ä¸ªæ€»éƒ¨ï¼Œæ‰€æœ‰ä¸šåŠ¡éƒ½åœ¨è¿™é‡Œå¤„ç†
ä¼˜ç‚¹ï¼šç®¡ç†ç®€å•ï¼Œå†…éƒ¨æ²Ÿé€šå®¹æ˜“
ç¼ºç‚¹ï¼šå‹åŠ›é›†ä¸­ï¼Œæ•…éšœå½±å“å…¨å±€

å¤šé›†ç¾¤æ¶æ„ï¼š
å°±åƒåœ¨ä¸åŒåŸå¸‚å¼€è®¾åˆ†å…¬å¸
ä¼˜ç‚¹ï¼šåˆ†æ•£é£é™©ï¼Œå°±è¿‘æœåŠ¡ï¼Œçµæ´»æ‰©å±•
ç¼ºç‚¹ï¼šç®¡ç†å¤æ‚ï¼Œéœ€è¦ç»Ÿä¸€åè°ƒ
```

**ğŸ”¸ å¤šé›†ç¾¤çš„æ ¸å¿ƒä»·å€¼**
```
ä¸šåŠ¡è¿ç»­æ€§ä¿éšœï¼š
- æŸä¸ªé›†ç¾¤æ•…éšœä¸å½±å“æ•´ä½“æœåŠ¡
- æ”¯æŒè·¨åœ°åŸŸçš„ç¾å¤‡æ–¹æ¡ˆ
- å®ç°çœŸæ­£çš„é«˜å¯ç”¨æ¶æ„

èµ„æºä¼˜åŒ–é…ç½®ï¼š
- æ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹é€‰æ‹©æœ€é€‚åˆçš„é›†ç¾¤
- é¿å…å•é›†ç¾¤èµ„æºæµªè´¹
- æ”¯æŒå¼¹æ€§ä¼¸ç¼©å’Œæˆæœ¬æ§åˆ¶

åˆè§„æ€§è¦æ±‚ï¼š
- æ•°æ®ä¸»æƒï¼šæŸäº›æ•°æ®å¿…é¡»å­˜å‚¨åœ¨ç‰¹å®šåŒºåŸŸ
- ç›‘ç®¡è¦æ±‚ï¼šä¸åŒå›½å®¶çš„åˆè§„æ€§è¦æ±‚
- å®‰å…¨éš”ç¦»ï¼šæ•æ„Ÿä¸šåŠ¡ä¸æ™®é€šä¸šåŠ¡åˆ†ç¦»
```

### 1.2 å¤šé›†ç¾¤æ¶æ„æ¨¡å¼

**ğŸ—ï¸ å¸¸è§çš„å¤šé›†ç¾¤ç»„ç»‡æ–¹å¼**

```
æ¨¡å¼1ï¼šä¸»ä»æ¨¡å¼ï¼ˆHub-Spokeï¼‰
          ç®¡ç†é›†ç¾¤
             |
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”
   é›†ç¾¤A    é›†ç¾¤B    é›†ç¾¤C
   
ç‰¹ç‚¹ï¼šæœ‰ä¸€ä¸ªä¸­å¤®ç®¡ç†é›†ç¾¤ç»Ÿä¸€ç®¡ç†å…¶ä»–é›†ç¾¤
é€‚ç”¨ï¼šä¸­å°å‹ä¼ä¸šï¼Œéœ€è¦é›†ä¸­ç®¡æ§

æ¨¡å¼2ï¼šè”é‚¦æ¨¡å¼ï¼ˆFederationï¼‰
   é›†ç¾¤A â†â†’ é›†ç¾¤B â†â†’ é›†ç¾¤C
      â†‘         â†“
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      
ç‰¹ç‚¹ï¼šå„é›†ç¾¤åœ°ä½å¹³ç­‰ï¼Œç›¸äº’åè°ƒ
é€‚ç”¨ï¼šå¤§å‹ä¼ä¸šï¼Œéœ€è¦åˆ†å¸ƒå¼ç®¡ç†

æ¨¡å¼3ï¼šç½‘çŠ¶æ¨¡å¼ï¼ˆMeshï¼‰
   é›†ç¾¤A â”€â”€â”€â”€ é›†ç¾¤B
     |   \  /   |
     |    Ã—     |
     |   / \    |
   é›†ç¾¤D â”€â”€â”€â”€ é›†ç¾¤C
   
ç‰¹ç‚¹ï¼šä»»æ„é›†ç¾¤é—´éƒ½å¯ä»¥ç›´æ¥é€šä¿¡
é€‚ç”¨ï¼šå¤æ‚ä¸šåŠ¡åœºæ™¯ï¼Œéœ€è¦çµæ´»äº¤äº’
```

### 1.3 å¤šé›†ç¾¤ç®¡ç†çš„æ ¸å¿ƒæŒ‘æˆ˜

**âš¡ ä¸»è¦æŠ€æœ¯æŒ‘æˆ˜å’Œè§£å†³æ€è·¯**

| æŒ‘æˆ˜é¢†åŸŸ | **å…·ä½“é—®é¢˜** | **è§£å†³æ–¹æ¡ˆ** | **å·¥å…·ç¤ºä¾‹** |
|---------|-------------|-------------|-------------|
| ğŸŒ **ç½‘ç»œè¿é€š** | `é›†ç¾¤é—´ç½‘ç»œéš”ç¦»` | `VPN/ä¸“çº¿/Service Mesh` | `Submariner, Istio` |
| ğŸ” **å®‰å…¨è®¤è¯** | `ç»Ÿä¸€èº«ä»½ç®¡ç†` | `OIDC/RBACç»Ÿä¸€é…ç½®` | `Dex, Keycloak` |
| ğŸ“Š **ç»Ÿä¸€ç›‘æ§** | `åˆ†æ•£çš„ç›‘æ§æ•°æ®` | `è”é‚¦ç›‘æ§/ä¸­å¤®æ”¶é›†` | `Prometheusè”é‚¦` |
| âš–ï¸ **è´Ÿè½½å‡è¡¡** | `è·¨é›†ç¾¤æµé‡åˆ†å‘` | `å…¨å±€è´Ÿè½½å‡è¡¡` | `Admiral, Istio` |
| ğŸ“¦ **åº”ç”¨éƒ¨ç½²** | `å¤šé›†ç¾¤ç»Ÿä¸€éƒ¨ç½²` | `GitOps/å£°æ˜å¼ç®¡ç†` | `ArgoCD, Flux` |

---

## 2. âš“ Admiralå¤šé›†ç¾¤ç®¡ç†é…ç½®


### 2.1 Admiralç®€ä»‹å’Œæ ¸å¿ƒåŠŸèƒ½

**ğŸ¯ Admiralæ˜¯ä»€ä¹ˆ**

Admiralå°±åƒå¤šé›†ç¾¤ç¯å¢ƒä¸­çš„"äº¤é€šç®¡åˆ¶ä¸­å¿ƒ"ï¼Œå®ƒçš„ä¸»è¦å·¥ä½œæ˜¯ï¼š

```
æ ¸å¿ƒèŒè´£ï¼š
1. æœåŠ¡å‘ç°ï¼šå¸®åŠ©ä¸åŒé›†ç¾¤çš„æœåŠ¡ç›¸äº’æ‰¾åˆ°å¯¹æ–¹
2. æµé‡ç®¡ç†ï¼šå†³å®šæœåŠ¡è¯·æ±‚åº”è¯¥å‘å¾€å“ªä¸ªé›†ç¾¤
3. æ•…éšœè½¬ç§»ï¼šå½“æŸä¸ªé›†ç¾¤å‡ºé—®é¢˜æ—¶ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°å…¶ä»–é›†ç¾¤

ç”Ÿæ´»ç±»æ¯”ï¼š
å°±åƒè¿é”åº—çš„æ€»éƒ¨è°ƒåº¦ç³»ç»Ÿ
- é¡¾å®¢æƒ³ä¹°å•†å“æ—¶ï¼Œç³»ç»Ÿä¼šæ¨èæœ€è¿‘çš„é—¨åº—
- æŸä¸ªé—¨åº—ç¼ºè´§æ—¶ï¼Œè‡ªåŠ¨æ¨èå…¶ä»–æœ‰è´§çš„é—¨åº—
- æŸä¸ªé—¨åº—å…³é—¨æ—¶ï¼Œå°†é¡¾å®¢å¼•å¯¼åˆ°æ­£å¸¸è¥ä¸šçš„é—¨åº—
```

### 2.2 AdmiralåŸºç¡€å®‰è£…é…ç½®

**ğŸ”§ å¿«é€Ÿéƒ¨ç½²Admiral**

```yaml
# admiral-install.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: admiral-system
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: admiral-controller
  namespace: admiral-system
spec:
  replicas: 1
  selector:
    matchLabels:
      app: admiral
  template:
    metadata:
      labels:
        app: admiral
    spec:
      containers:
      - name: admiral
        image: istio/admiral:latest
        env:
        - name: CLUSTER_NAME
          value: "cluster-1"  # å½“å‰é›†ç¾¤åç§°
        - name: LOG_LEVEL
          value: "info"
        ports:
        - containerPort: 8080
```

**ğŸŒŸ å¤šé›†ç¾¤æœåŠ¡å‘ç°é…ç½®**
```yaml
# service-discovery.yaml
apiVersion: admiral.io/v1
kind: GlobalTrafficPolicy
metadata:
  name: webapp-policy
  namespace: default
spec:
  # é€‰æ‹©è¦ç®¡ç†çš„æœåŠ¡
  selector:
    identity: webapp
  # å®šä¹‰æµé‡åˆ†å‘ç­–ç•¥
  policy:
  - dns: webapp.global
    lbType: 1  # 1=è½®è¯¢, 2=æƒé‡, 3=åœ°ç†ä½ç½®
    targets:
    - region: us-west
      weight: 50
      endpoint: webapp.cluster-west.local
    - region: us-east  
      weight: 50
      endpoint: webapp.cluster-east.local
```

### 2.3 Admiralæµé‡ç®¡ç†å®æˆ˜

**âš–ï¸ æ™ºèƒ½æµé‡åˆ†å‘é…ç½®**

```yaml
# traffic-management.yaml
apiVersion: admiral.io/v1
kind: DestinationRule
metadata:
  name: webapp-destinations
spec:
  host: webapp.global
  trafficPolicy:
    # è¿æ¥æ± è®¾ç½®
    connectionPool:
      tcp:
        maxConnections: 100
      http:
        http1MaxPendingRequests: 10
        maxRequestsPerConnection: 2
    # å¥åº·æ£€æŸ¥
    healthCheck:
      path: /health
      interval: 30s
      timeout: 3s
      unhealthyThreshold: 3
  # ä¸åŒé›†ç¾¤çš„é…ç½®
  subsets:
  - name: cluster-west
    labels:
      region: us-west
    trafficPolicy:
      portLevelSettings:
      - port:
          number: 80
        loadBalancer:
          simple: LEAST_CONN  # æœ€å°‘è¿æ¥
  - name: cluster-east
    labels:
      region: us-east
    trafficPolicy:
      portLevelSettings:
      - port:
          number: 80
        loadBalancer:
          simple: ROUND_ROBIN  # è½®è¯¢
```

**ğŸ’¡ æ•…éšœè½¬ç§»é…ç½®**
```yaml
# failover-config.yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: webapp-failover
spec:
  hosts:
  - webapp.global
  http:
  - match:
    - headers:
        region:
          exact: us-west
    route:
    - destination:
        host: webapp.global
        subset: cluster-west
      weight: 100
    # æ•…éšœè½¬ç§»é…ç½®
    fault:
      abort:
        percentage:
          value: 0.1  # 0.1%çš„è¯·æ±‚ä¼šè¢«æ•…æ„ä¸­æ–­ï¼Œç”¨äºæµ‹è¯•
        httpStatus: 500
    retries:
      attempts: 3
      perTryTimeout: 2s
    # å½“ä¸»é›†ç¾¤å¤±è´¥æ—¶ï¼Œè½¬ç§»åˆ°å¤‡ç”¨é›†ç¾¤
    mirror:
      host: webapp.global
      subset: cluster-east
```

---

## 3. ğŸŒŠ Submarinerå¤šé›†ç¾¤ç½‘ç»œé…ç½®


### 3.1 Submarinerç½‘ç»œè¿é€šåŸç†

**ğŸ¯ Submarinerè§£å†³ä»€ä¹ˆé—®é¢˜**

```
ç½‘ç»œè¿é€šæŒ‘æˆ˜ï¼š
æƒ³è±¡ä½ æœ‰ä¸¤ä¸ªç‹¬ç«‹çš„å±€åŸŸç½‘ï¼ˆå®¶åº­ç½‘ç»œï¼‰
å®¶åº­Aï¼š192.168.1.x
å®¶åº­Bï¼š192.168.2.x

é—®é¢˜ï¼šä¸¤ä¸ªå®¶åº­çš„è®¾å¤‡æ— æ³•ç›´æ¥é€šä¿¡

Submarinerçš„è§£å†³æ–¹æ¡ˆï¼š
å°±åƒåœ¨ä¸¤ä¸ªå®¶åº­ä¹‹é—´æ‹‰äº†ä¸€æ¡ä¸“ç”¨ç½‘çº¿
- è‡ªåŠ¨å»ºç«‹å®‰å…¨éš§é“è¿æ¥
- å¤„ç†IPåœ°å€å†²çªé—®é¢˜  
- æä¾›ç»Ÿä¸€çš„æœåŠ¡å‘ç°
- ç¡®ä¿ç½‘ç»œæµé‡åŠ å¯†ä¼ è¾“
```

**ğŸ”¸ Submarineræ ¸å¿ƒç»„ä»¶**
```
ç»„ä»¶æ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   é›†ç¾¤A     â”‚    â”‚   é›†ç¾¤B     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚Gateway  â”‚â—„â”¼â”€â”€â”€â”€â”¼â–ºâ”‚Gateway  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚Route    â”‚ â”‚    â”‚ â”‚Route    â”‚ â”‚
â”‚ â”‚Agent    â”‚ â”‚    â”‚ â”‚Agent    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Gatewayï¼šè´Ÿè´£å»ºç«‹é›†ç¾¤é—´çš„ç½‘ç»œéš§é“
Route Agentï¼šè´Ÿè´£é›†ç¾¤å†…çš„è·¯ç”±ç®¡ç†
Brokerï¼šåè°ƒå¤šé›†ç¾¤é—´çš„è¿æ¥ä¿¡æ¯
```

### 3.2 Submarinerå®‰è£…é…ç½®

**ğŸš€ å¿«é€Ÿéƒ¨ç½²Submariner**

```bash
# 1. å®‰è£…subctlå‘½ä»¤è¡Œå·¥å…·
curl -Ls https://get.submariner.io | bash
export PATH=$PATH:~/.local/bin

# 2. å‡†å¤‡é›†ç¾¤ç¯å¢ƒ
subctl deploy-broker --kubeconfig cluster-a.yaml
```

```yaml
# submariner-broker.yaml
apiVersion: submariner.io/v1alpha1
kind: Broker
metadata:
  name: submariner-broker
  namespace: submariner-broker
spec:
  # brokeré…ç½®
  globalnetEnabled: true  # å¯ç”¨å…¨å±€ç½‘ç»œ
  defaultGlobalnetClusterSize: 8192  # æ¯ä¸ªé›†ç¾¤çš„IPèŒƒå›´
  # å®‰å…¨é…ç½®
  components:
  - connectivity
  - service-discovery
  - globalnet
```

**ğŸ”§ é›†ç¾¤åŠ å…¥é…ç½®**
```bash
# åŠ å…¥é›†ç¾¤Aåˆ°broker
subctl join --kubeconfig cluster-a.yaml \
  --clusterid cluster-a \
  --repository quay.io/submariner \
  --cable-driver libreswan \
  --nat-traversal

# åŠ å…¥é›†ç¾¤Båˆ°broker  
subctl join --kubeconfig cluster-b.yaml \
  --clusterid cluster-b \
  --repository quay.io/submariner \
  --cable-driver libreswan \
  --nat-traversal
```

### 3.3 è·¨é›†ç¾¤æœåŠ¡è®¿é—®é…ç½®

**ğŸŒ æœåŠ¡å¯¼å‡ºå’Œå‘ç°**

```yaml
# service-export.yaml - åœ¨é›†ç¾¤Aä¸­å¯¼å‡ºæœåŠ¡
apiVersion: multicluster.x-k8s.io/v1alpha1
kind: ServiceExport
metadata:
  name: webapp-service
  namespace: default
spec:
  # è‡ªåŠ¨å¯¼å‡ºï¼Œæ— éœ€é¢å¤–é…ç½®
---
# åŸå§‹æœåŠ¡å®šä¹‰
apiVersion: v1
kind: Service
metadata:
  name: webapp-service
  namespace: default
  labels:
    app: webapp
spec:
  ports:
  - port: 80
    targetPort: 8080
    protocol: TCP
  selector:
    app: webapp
  type: ClusterIP
```

**ğŸ” è·¨é›†ç¾¤æœåŠ¡å‘ç°**
```yaml
# service-discovery.yaml - åœ¨é›†ç¾¤Bä¸­è®¿é—®é›†ç¾¤Açš„æœåŠ¡
apiVersion: v1
kind: Pod
metadata:
  name: client-pod
  namespace: default
spec:
  containers:
  - name: client
    image: curlimages/curl
    command:
    - sleep
    - "3600"
    env:
    # Submarinerä¼šè‡ªåŠ¨åˆ›å»ºè¿™ä¸ªDNSè®°å½•
    - name: REMOTE_SERVICE_URL
      value: "http://webapp-service.default.svc.clusterset.local"
  restartPolicy: Always
```

**ğŸ“Š ç½‘ç»œè¿é€šæ€§éªŒè¯**
```yaml
# connectivity-test.yaml
apiVersion: v1
kind: Pod
metadata:
  name: nettest
  namespace: default
  labels:
    app: nettest
spec:
  containers:
  - name: nettest
    image: quay.io/submariner/nettest:latest
    env:
    - name: TARGET_CLUSTER
      value: "cluster-b"
    - name: TARGET_SERVICE  
      value: "webapp-service.default.svc.clusterset.local"
    command:
    - /bin/sh
    - -c
    - |
      # æµ‹è¯•DNSè§£æ
      nslookup $TARGET_SERVICE
      
      # æµ‹è¯•è¿æ¥æ€§
      curl -v http://$TARGET_SERVICE/health
      
      # æŒç»­ç›‘æ§
      while true; do
        curl -s $TARGET_SERVICE && echo "âœ“ è¿æ¥æ­£å¸¸" || echo "âœ— è¿æ¥å¤±è´¥"
        sleep 30
      done
```

---

## 4. ğŸ”— Clusternetå¤šé›†ç¾¤ç®¡ç†é…ç½®


### 4.1 Clusternetæ¶æ„ç†è§£

**ğŸ¯ Clusternetçš„è®¾è®¡æ€è·¯**

```
Clusternetçš„æ ¸å¿ƒç†å¿µï¼š
æŠŠå¤šä¸ªKubernetesé›†ç¾¤å½“ä½œ"è¶…çº§è®¡ç®—æœº"çš„ä¸åŒèŠ‚ç‚¹æ¥ç®¡ç†

ç±»æ¯”ç†è§£ï¼š
å•æœºæ—¶ä»£ï¼šä¸€å°ç”µè„‘å¤„ç†æ‰€æœ‰ä»»åŠ¡
é›†ç¾¤æ—¶ä»£ï¼šå¤šå°ç”µè„‘ç»„æˆé›†ç¾¤ï¼Œä½†éœ€è¦æ‰‹åŠ¨ç®¡ç†
Clusternetæ—¶ä»£ï¼šåƒä½¿ç”¨ä¸€å°è¶…çº§ç”µè„‘ä¸€æ ·ä½¿ç”¨å¤šä¸ªé›†ç¾¤

å·¥ä½œæ–¹å¼ï¼š
1. ä¸­å¿ƒåŒ–ç®¡ç†ï¼šæœ‰ä¸€ä¸ª"æ¯èˆ°"é›†ç¾¤è´Ÿè´£ç®¡ç†
2. ç»Ÿä¸€APIï¼šåƒæ“ä½œå•é›†ç¾¤ä¸€æ ·æ“ä½œå¤šé›†ç¾¤
3. è‡ªåŠ¨è°ƒåº¦ï¼šåº”ç”¨ä¼šè‡ªåŠ¨åˆ†å‘åˆ°åˆé€‚çš„é›†ç¾¤
4. ç»Ÿä¸€ç›‘æ§ï¼šæ‰€æœ‰é›†ç¾¤çš„çŠ¶æ€é›†ä¸­å±•ç¤º
```

### 4.2 Clusternetæ§åˆ¶å¹³é¢é…ç½®

**ğŸš€ éƒ¨ç½²Clusternetç®¡ç†é›†ç¾¤**

```yaml
# clusternet-hub.yaml - ç®¡ç†é›†ç¾¤é…ç½®
apiVersion: v1
kind: Namespace
metadata:
  name: clusternet-system
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: clusternet-controller-manager
  namespace: clusternet-system
spec:
  replicas: 1
  selector:
    matchLabels:
      app: clusternet-controller-manager
  template:
    metadata:
      labels:
        app: clusternet-controller-manager
    spec:
      serviceAccountName: clusternet-controller-manager
      containers:
      - name: manager
        image: ghcr.io/clusternet/clusternet-controller-manager:latest
        args:
        - --leader-elect=true
        - --feature-gates=SocketConnection=true
        - --controllers=cluster,subscription,manifest,work
        env:
        - name: SYSTEM_NAMESPACE
          value: clusternet-system
        ports:
        - containerPort: 8080
          name: metrics
        - containerPort: 9443
          name: webhook
```

**ğŸ”§ å­é›†ç¾¤æ³¨å†Œé…ç½®**
```yaml
# cluster-registration.yaml
apiVersion: clusters.clusternet.io/v1beta1
kind: ManagedCluster
metadata:
  name: child-cluster-1
  labels:
    environment: production
    region: us-west
    provider: aws
spec:
  # é›†ç¾¤åŸºæœ¬ä¿¡æ¯
  syncMode: Dual  # åŒå‘åŒæ­¥æ¨¡å¼
  useSocket: true # ä½¿ç”¨WebSocketè¿æ¥
  
  # é›†ç¾¤èƒ½åŠ›å£°æ˜
  taints:
  - key: "special-workload"
    value: "gpu"
    effect: "NoSchedule"
  
  # ç½‘ç»œé…ç½®
  networkSetting:
    types:
    - GlobalNet
    - ServiceExport
    - ServiceImport
```

### 4.3 åº”ç”¨å¤šé›†ç¾¤åˆ†å‘é…ç½®

**ğŸ“¦ ç»Ÿä¸€åº”ç”¨ç®¡ç†**

```yaml
# multi-cluster-deployment.yaml
apiVersion: apps.clusternet.io/v1alpha1  
kind: Subscription
metadata:
  name: webapp-subscription
  namespace: default
spec:
  # åº”ç”¨æ¨¡æ¿
  feeds:
  - apiVersion: apps.clusternet.io/v1alpha1
    kind: HelmChart
    name: webapp-chart
    namespace: default
  
  # é›†ç¾¤é€‰æ‹©ç­–ç•¥
  scheduling:
    # é›†ç¾¤é€‰æ‹©å™¨
    clusterSelector:
      matchLabels:
        environment: production
      matchExpressions:
      - key: region
        operator: In
        values: ["us-west", "us-east"]
    
    # åˆ†å‘ç­–ç•¥
    schedulingStrategy: Dividing
    
    # å‰¯æœ¬åˆ†é…
    replicas:
      staticReplicas:
      - clusters:
        - name: child-cluster-1
        replicas: 3
      - clusters:
        - name: child-cluster-2  
        replicas: 2
  
  # å·®å¼‚åŒ–é…ç½®
  overrides:
  - clusterSelector:
      matchLabels:
        region: us-west
    patches:
    - path: "/spec/template/spec/containers/0/env"
      value:
      - name: REGION
        value: "us-west"
      - name: REPLICAS
        value: "3"
```

**âš™ï¸ é›†ç¾¤ç‰¹å®šé…ç½®è¦†ç›–**
```yaml
# cluster-overrides.yaml
apiVersion: apps.clusternet.io/v1alpha1
kind: Localization
metadata:
  name: webapp-localization
  namespace: default
spec:
  # ç›®æ ‡é›†ç¾¤
  clusterSelector:
    matchLabels:
      region: us-east
  
  # é…ç½®è¦†ç›–
  overrides:
  # ç¯å¢ƒå˜é‡è¦†ç›–
  - type: "env"
    path: "/spec/template/spec/containers/0/env"
    value:
    - name: DATABASE_URL
      value: "postgres://db.us-east.example.com:5432/webapp"
    - name: REDIS_URL
      value: "redis://cache.us-east.example.com:6379"
  
  # èµ„æºé™åˆ¶è¦†ç›–
  - type: "resources"
    path: "/spec/template/spec/containers/0/resources"
    value:
      limits:
        memory: "1Gi"    # ä¸œéƒ¨é›†ç¾¤å†…å­˜è¾ƒå°‘
        cpu: "500m"
      requests:
        memory: "512Mi"
        cpu: "250m"
```

---

## 5. ğŸ›ï¸ Open Cluster Managementé…ç½®


### 5.1 OCMæ¶æ„å’Œç»„ä»¶

**ğŸ—ï¸ OCMçš„è®¾è®¡æ¶æ„**

OCMï¼ˆOpen Cluster Managementï¼‰å°±åƒä¸€ä¸ª"é›†ç¾¤ç®¡ç†æ“ä½œç³»ç»Ÿ"ï¼š

```
ç»„ä»¶æ¶æ„ï¼š
         Hubé›†ç¾¤ï¼ˆæ§åˆ¶ä¸­å¿ƒï¼‰
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”      â”‚
    â”‚  â”‚ API â”‚ â”‚ Web â”‚      â”‚
    â”‚  â”‚ æœåŠ¡â”‚ â”‚ æ§åˆ¶å°â”‚    â”‚  
    â”‚  â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜      â”‚
    â”‚                       â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚   ç­–ç•¥å¼•æ“      â”‚  â”‚  â† ç®¡ç†å¤§è„‘
    â”‚  â”‚   åº”ç”¨ç®¡ç†      â”‚  â”‚
    â”‚  â”‚   é›†ç¾¤ç”Ÿå‘½å‘¨æœŸ  â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         â”‚         â”‚
 Spoke-A   Spoke-B   Spoke-C  â† è¢«ç®¡ç†é›†ç¾¤
ï¼ˆä»£ç†ï¼‰   ï¼ˆä»£ç†ï¼‰   ï¼ˆä»£ç†ï¼‰

æ¯ä¸ªè¢«ç®¡ç†çš„é›†ç¾¤éƒ½æœ‰ä¸€ä¸ª"ä»£ç†"(Spoke Agent)
è¿™ä¸ªä»£ç†è´Ÿè´£æ‰§è¡ŒHubé›†ç¾¤ä¸‹å‘çš„æŒ‡ä»¤
```

### 5.2 OCM Hubé›†ç¾¤éƒ¨ç½²

**ğŸš€ éƒ¨ç½²æ§åˆ¶ä¸­å¿ƒ**

```yaml
# ocm-hub-install.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: open-cluster-management
---
apiVersion: operator.open-cluster-management.io/v1
kind: MultiClusterHub
metadata:
  name: multiclusterhub
  namespace: open-cluster-management
spec:
  # åŸºç¡€ç»„ä»¶é…ç½®
  availabilityConfig: Basic  # å¯é€‰: Basic, High
  
  # å¯ç”¨çš„åŠŸèƒ½ç‰¹æ€§
  enableClusterProxyAddon: true    # é›†ç¾¤ä»£ç†
  enableClusterBackup: true        # é›†ç¾¤å¤‡ä»½
  enableVolcano: false              # Volcanoè°ƒåº¦å™¨
  
  # Webæ§åˆ¶å°é…ç½®  
  overrides:
    components:
    - name: console
      enabled: true
    - name: insights
      enabled: true      # é›†ç¾¤æ´å¯Ÿ
    - name: grc
      enabled: true      # æ²»ç†é£é™©åˆè§„
    - name: submariner-addon
      enabled: true      # ç½‘ç»œè¿é€š
```

### 5.3 é›†ç¾¤æ³¨å†Œå’Œç®¡ç†

**ğŸ”— æ·»åŠ è¢«ç®¡ç†é›†ç¾¤**

```yaml
# managed-cluster-import.yaml
apiVersion: cluster.open-cluster-management.io/v1
kind: ManagedCluster
metadata:
  name: production-west
  labels:
    # é›†ç¾¤åˆ†ç±»æ ‡ç­¾
    environment: production
    region: us-west
    cloud: aws
    # è‡ªåŠ¨å®¡æ‰¹åŠ å…¥
    cluster.open-cluster-management.io/clusterset: default
spec:
  # é›†ç¾¤è¿æ¥é…ç½®
  hubAcceptsClient: true
  # é›†ç¾¤æ ‡è¯†
  leaseDurationSeconds: 60
```

**ğŸ”§ é›†ç¾¤å¯¼å…¥è„šæœ¬ç”Ÿæˆ**
```bash
# åœ¨Hubé›†ç¾¤ç”Ÿæˆå¯¼å…¥å‘½ä»¤
kubectl get secret production-west-import -n production-west -o jsonpath='{.data.import\.yaml}' | base64 -d > import-command.yaml

# åœ¨ç›®æ ‡é›†ç¾¤æ‰§è¡Œå¯¼å…¥
kubectl apply -f import-command.yaml
```

```yaml
# cluster-addon-config.yaml - é›†ç¾¤åŠŸèƒ½æ’ä»¶é…ç½®
apiVersion: addon.open-cluster-management.io/v1alpha1
kind: ManagedClusterAddOn
metadata:
  name: application-manager
  namespace: production-west
spec:
  installNamespace: open-cluster-management-agent-addon
---
apiVersion: addon.open-cluster-management.io/v1alpha1  
kind: ManagedClusterAddOn
metadata:
  name: governance-policy-framework
  namespace: production-west
spec:
  installNamespace: open-cluster-management-agent-addon
```

### 5.4 ç­–ç•¥ç®¡ç†å’Œåº”ç”¨åˆ†å‘

**ğŸ“‹ é›†ç¾¤æ²»ç†ç­–ç•¥**

```yaml
# security-policy.yaml
apiVersion: policy.open-cluster-management.io/v1
kind: Policy
metadata:
  name: security-baseline-policy
  namespace: default
spec:
  # ç­–ç•¥æ‰§è¡Œæ¨¡å¼
  remediationAction: enforce  # inform(ä»…æŠ¥å‘Š) æˆ– enforce(å¼ºåˆ¶æ‰§è¡Œ)
  disabled: false
  
  policy-templates:
  # Podå®‰å…¨æ ‡å‡†
  - objectDefinition:
      apiVersion: policy.open-cluster-management.io/v1
      kind: ConfigurationPolicy
      metadata:
        name: pod-security-policy
      spec:
        severity: high
        object-templates:
        - complianceType: musthave
          objectDefinition:
            apiVersion: v1
            kind: Namespace
            metadata:
              name: default
              labels:
                pod-security.kubernetes.io/enforce: restricted
                pod-security.kubernetes.io/audit: restricted
                pod-security.kubernetes.io/warn: restricted
  
  # ç½‘ç»œç­–ç•¥
  - objectDefinition:
      apiVersion: policy.open-cluster-management.io/v1
      kind: ConfigurationPolicy
      metadata:
        name: network-policy
      spec:
        severity: medium
        object-templates:
        - complianceType: musthave
          objectDefinition:
            apiVersion: networking.k8s.io/v1
            kind: NetworkPolicy
            metadata:
              name: default-deny-all
              namespace: default
            spec:
              podSelector: {}
              policyTypes:
              - Ingress
              - Egress
```

**ğŸ“¦ åº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†**
```yaml
# application-deployment.yaml
apiVersion: app.k8s.io/v1beta1
kind: Application
metadata:
  name: multi-cluster-webapp
  namespace: default
spec:
  # åº”ç”¨é€‰æ‹©å™¨
  componentKinds:
  - group: apps.open-cluster-management.io
    kind: Subscription
  
  descriptor:
    type: "webapp"
    version: "1.0.0"
    description: "å¤šé›†ç¾¤Webåº”ç”¨"
    
  selector:
    matchExpressions:
    - key: app
      operator: In  
      values:
      - webapp
---
apiVersion: apps.open-cluster-management.io/v1
kind: Subscription
metadata:
  name: webapp-subscription
  namespace: default
spec:
  # Gitä»“åº“æº
  channel: default/webapp-channel
  packageFilter:
    version: ">=1.0.0"
  
  # é›†ç¾¤éƒ¨ç½²é…ç½®
  placement:
    clusterSelector:
      matchLabels:
        environment: production
  
  # éƒ¨ç½²é’©å­
  packageOverrides:
  - packageName: webapp
    packageOverrides:
    - path: spec.replicas
      value: 3
```

---

## 6. ğŸ¤  Rancherå¤šé›†ç¾¤ç®¡ç†é…ç½®


### 6.1 Rancherç®¡ç†å¹³å°éƒ¨ç½²

**ğŸ¯ Rancheræ˜¯ä»€ä¹ˆ**

Rancherå°±åƒKubernetesçš„"å¯è§†åŒ–ç®¡ç†åå°"ï¼š

```
ä¼ ç»ŸK8sç®¡ç†æ–¹å¼ï¼š
å¼€å‘è€…ï¼škubectlå‘½ä»¤è¡Œ â†’ å­¦ä¹ æˆæœ¬é«˜ï¼Œæ“ä½œå¤æ‚
è¿ç»´ï¼šYAMLæ–‡ä»¶ â†’ æ‰‹å·¥ç¼–å†™é…ç½®ï¼Œå®¹æ˜“å‡ºé”™
ç®¡ç†å‘˜ï¼šå¤šä¸ªé›†ç¾¤ â†’ åˆ‡æ¢contextï¼Œç®¡ç†æ··ä¹±

Rancheræä¾›çš„ä»·å€¼ï¼š
ğŸ–¥ï¸ Webç•Œé¢ï¼šç‚¹å‡»æ“ä½œï¼Œé™ä½ä½¿ç”¨é—¨æ§›
ğŸ›ï¸ ç»Ÿä¸€æ§åˆ¶å°ï¼šä¸€ä¸ªç•Œé¢ç®¡ç†æ‰€æœ‰é›†ç¾¤  
ğŸ“Š å¯è§†åŒ–ç›‘æ§ï¼šå›¾è¡¨å±•ç¤ºï¼Œç›´è§‚äº†è§£çŠ¶æ€
ğŸ›¡ï¸ æƒé™ç®¡ç†ï¼šç»†ç²’åº¦æ§åˆ¶ç”¨æˆ·è®¿é—®
ğŸš€ åº”ç”¨å¸‚åœºï¼šä¸€é”®éƒ¨ç½²å¸¸ç”¨åº”ç”¨
```

### 6.2 Rancher Serverå®‰è£…é…ç½®

**ğŸš€ å¿«é€Ÿéƒ¨ç½²Rancher**

```yaml
# rancher-namespace.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: cattle-system
---
# rancher-deployment.yaml  
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rancher
  namespace: cattle-system
spec:
  replicas: 1
  selector:
    matchLabels:
      app: rancher
  template:
    metadata:
      labels:
        app: rancher
    spec:
      serviceAccountName: rancher
      containers:
      - name: rancher
        image: rancher/rancher:latest
        env:
        # ç®¡ç†å‘˜å¯†ç ï¼ˆé¦–æ¬¡ç™»å½•ç”¨ï¼‰
        - name: CATTLE_BOOTSTRAP_PASSWORD
          value: "admin123456"
        # SSLé…ç½®
        - name: CATTLE_TLS_MODE  
          value: "acme"  # è‡ªåŠ¨HTTPSè¯ä¹¦
        ports:
        - containerPort: 80
        - containerPort: 443
        volumeMounts:
        - name: rancher-data
          mountPath: /var/lib/rancher
      volumes:
      - name: rancher-data
        persistentVolumeClaim:
          claimName: rancher-data-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: rancher-service
  namespace: cattle-system
spec:
  selector:
    app: rancher
  ports:
  - name: http
    port: 80
    targetPort: 80
  - name: https
    port: 443
    targetPort: 443
  type: LoadBalancer
```

### 6.3 é›†ç¾¤å¯¼å…¥å’Œç®¡ç†

**ğŸ”— æ·»åŠ å·²æœ‰é›†ç¾¤åˆ°Rancher**

é€šè¿‡Webç•Œé¢å¯¼å…¥é›†ç¾¤çš„æ­¥éª¤ï¼š
1. ç™»å½•Rancheræ§åˆ¶å° â†’ é›†ç¾¤ç®¡ç†
2. ç‚¹å‡»"å¯¼å…¥é›†ç¾¤" â†’ é€‰æ‹©"é€šç”¨"
3. å¡«å†™é›†ç¾¤åç§° â†’ ç”Ÿæˆå¯¼å…¥å‘½ä»¤  
4. åœ¨ç›®æ ‡é›†ç¾¤æ‰§è¡Œç”Ÿæˆçš„kubectlå‘½ä»¤

```bash
# Rancherè‡ªåŠ¨ç”Ÿæˆçš„å¯¼å…¥å‘½ä»¤ç¤ºä¾‹
curl --insecure -sfL https://rancher.example.com/v3/import/xxx.yaml | kubectl apply -f -
```

**ğŸ›ï¸ é›†ç¾¤é…ç½®ç®¡ç†**
```yaml
# cluster-config.yaml
apiVersion: management.cattle.io/v3
kind: Cluster
metadata:
  name: production-cluster
spec:
  # é›†ç¾¤æ˜¾ç¤ºåç§°
  displayName: "ç”Ÿäº§ç¯å¢ƒé›†ç¾¤"
  
  # é›†ç¾¤åˆ†ç»„
  labels:
    environment: production
    region: us-west
    team: platform
    
  # å¯¼å…¥é›†ç¾¤é…ç½®
  importedConfig:
    # é›†ç¾¤endpoint
    kubernetesVersion: "v1.28.0"
    
  # ç›‘æ§é…ç½®
  enableClusterMonitoring: true
  enableNetworkPolicy: true
  
  # é»˜è®¤é¡¹ç›®é…ç½®
  defaultPodSecurityPolicyTemplateId: "restricted"
  
  # èŠ‚ç‚¹ç›¸å…³é…ç½®
  localClusterAuthEndpoint:
    enabled: true
    caCerts: ""
    fqdn: "rancher.example.com"
```

### 6.4 é¡¹ç›®å’Œå‘½åç©ºé—´ç®¡ç†

**ğŸ“ Rancherçš„å±‚çº§ç®¡ç†**

```
Rancherçš„ç»„ç»‡ç»“æ„ï¼š
é›†ç¾¤(Cluster)
â””â”€â”€ é¡¹ç›®(Project)  â† Rancherç‹¬æœ‰æ¦‚å¿µï¼Œç”¨äºæƒé™åˆ†ç»„
    â””â”€â”€ å‘½åç©ºé—´(Namespace)  â† K8såŸç”Ÿæ¦‚å¿µ
        â””â”€â”€ å·¥ä½œè´Ÿè½½(Workload)

é¡¹ç›®çš„ä½œç”¨ï¼š
- æƒé™éš”ç¦»ï¼šä¸åŒå›¢é˜Ÿç®¡ç†ä¸åŒé¡¹ç›®
- èµ„æºé…é¢ï¼šé™åˆ¶é¡¹ç›®ä½¿ç”¨çš„èµ„æºæ€»é‡  
- ç½‘ç»œç­–ç•¥ï¼šé¡¹ç›®é—´ç½‘ç»œè®¿é—®æ§åˆ¶
- ç›‘æ§åˆ†ç»„ï¼šæŒ‰é¡¹ç›®æŸ¥çœ‹ç›‘æ§æ•°æ®
```

```yaml
# project-definition.yaml
apiVersion: management.cattle.io/v3
kind: Project
metadata:
  name: frontend-project
  namespace: c-cluster-id  # é›†ç¾¤ID
spec:
  displayName: "å‰ç«¯åº”ç”¨é¡¹ç›®"
  description: "å‰ç«¯å›¢é˜Ÿçš„æ‰€æœ‰åº”ç”¨"
  
  # æ‰€å±é›†ç¾¤
  clusterId: "c-cluster-id"
  
  # é¡¹ç›®æˆå‘˜å’Œæƒé™
  projectMembers:
  - userPrincipalId: "local://u-frontend-lead"
    roleTemplateIds: 
    - "project-owner"
  - userPrincipalId: "local://u-frontend-dev"  
    roleTemplateIds:
    - "project-member"
    
  # èµ„æºé…é¢
  resourceQuota:
    limit:
      limitsCpu: "10"        # æœ€å¤§10æ ¸CPU
      limitsMemory: "20Gi"   # æœ€å¤§20Gå†…å­˜
      persistentVolumeClaims: "10"  # æœ€å¤§10ä¸ªPVC
      pods: "50"             # æœ€å¤§50ä¸ªPod
    used: {}  # å½“å‰ä½¿ç”¨é‡ï¼Œç³»ç»Ÿè‡ªåŠ¨è®¡ç®—
  
  # å‘½åç©ºé—´é…é¢
  namespaceDefaultResourceQuota:
    limit:
      limitsCpu: "2"
      limitsMemory: "4Gi"
      pods: "10"
```

**ğŸ‘¥ ç”¨æˆ·æƒé™ç®¡ç†**
```yaml
# rbac-configuration.yaml
apiVersion: management.cattle.io/v3
kind: GlobalRole
metadata:
  name: cluster-viewer
spec:
  displayName: "é›†ç¾¤æŸ¥çœ‹è€…"
  description: "åªèƒ½æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯ï¼Œä¸èƒ½ä¿®æ”¹"
  rules:
  - apiGroups: [""]
    resources: ["clusters", "nodes", "namespaces"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["apps"]
    resources: ["deployments", "services"]
    verbs: ["get", "list", "watch"]
---
apiVersion: management.cattle.io/v3
kind: RoleTemplate  
metadata:
  name: app-deployer
spec:
  displayName: "åº”ç”¨éƒ¨ç½²è€…"
  description: "å¯ä»¥éƒ¨ç½²å’Œç®¡ç†åº”ç”¨"
  context: "project"  # é¡¹ç›®çº§åˆ«æƒé™
  rules:
  - apiGroups: ["apps"]
    resources: ["deployments", "replicasets"]
    verbs: ["*"]
  - apiGroups: [""]
    resources: ["services", "configmaps", "secrets"]
    verbs: ["*"]
  - apiGroups: ["networking.k8s.io"]
    resources: ["ingresses"]
    verbs: ["*"]
```

---

## 7. ğŸ—ï¸ Cluster APIé›†ç¾¤ç®¡ç†é…ç½®


### 7.1 Cluster APIæ¦‚å¿µå’Œæ¶æ„

**ğŸ¯ Cluster APIæ˜¯ä»€ä¹ˆ**

```
ä¼ ç»Ÿé›†ç¾¤ç®¡ç†ç—›ç‚¹ï¼š
æ‰‹åŠ¨å®‰è£…ï¼šéœ€è¦ç™»å½•æ¯å°æœºå™¨æ‰‹åŠ¨é…ç½®
é…ç½®å¤æ‚ï¼šå„ç§å‚æ•°è®¾ç½®å®¹æ˜“å‡ºé”™
æ‰©å®¹å›°éš¾ï¼šå¢åŠ èŠ‚ç‚¹éœ€è¦é‡å¤å¤§é‡å·¥ä½œ
ä¸ä¸€è‡´ï¼šä¸åŒç¯å¢ƒçš„é…ç½®å¯èƒ½ä¸åŒ

Cluster APIè§£å†³æ–¹æ¡ˆï¼š
å£°æ˜å¼ç®¡ç†ï¼šç”¨YAMLæè¿°æœŸæœ›çš„é›†ç¾¤çŠ¶æ€
è‡ªåŠ¨åŒ–ï¼šç³»ç»Ÿè‡ªåŠ¨åˆ›å»ºå’Œé…ç½®é›†ç¾¤
æ ‡å‡†åŒ–ï¼šç»Ÿä¸€çš„é›†ç¾¤é…ç½®æ¨¡æ¿
å¯é‡å¤ï¼šç›¸åŒçš„é…ç½®å¯ä»¥é‡å¤ä½¿ç”¨

ç”Ÿæ´»ç±»æ¯”ï¼š
ä¼ ç»Ÿæ–¹å¼ï¼šåƒæ‰‹å·¥è£…é…æ±½è½¦ï¼Œæ¯ä¸ªé›¶ä»¶éƒ½è¦æ‰‹åŠ¨å®‰è£…
Cluster APIï¼šåƒæ±½è½¦ç”Ÿäº§çº¿ï¼Œæœ‰æ ‡å‡†æµç¨‹è‡ªåŠ¨ç»„è£…
```

### 7.2 ç®¡ç†é›†ç¾¤åˆå§‹åŒ–

**ğŸš€ éƒ¨ç½²Cluster APIç®¡ç†ç»„ä»¶**

```yaml
# cluster-api-components.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: capi-system
---
# Cluster API Controller Manager
apiVersion: apps/v1
kind: Deployment
metadata:
  name: capi-controller-manager
  namespace: capi-system
spec:
  replicas: 1
  selector:
    matchLabels:
      cluster.x-k8s.io/provider: cluster-api
      control-plane: controller-manager
  template:
    metadata:
      labels:
        cluster.x-k8s.io/provider: cluster-api
        control-plane: controller-manager
    spec:
      containers:
      - name: manager
        image: k8s.gcr.io/cluster-api/cluster-api-controller:v1.6.0
        args:
        - --leader-elect
        - --metrics-bind-addr=127.0.0.1:8080
        env:
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
```

**âš™ï¸ åŸºç¡€è®¾æ–½æä¾›å•†é…ç½®**
```yaml
# aws-provider-config.yaml
apiVersion: v1
kind: Secret
metadata:
  name: aws-credentials
  namespace: capa-system
type: Opaque
data:
  # AWSè®¿é—®å¯†é’¥ï¼ˆbase64ç¼–ç ï¼‰
  AccessKeyId: <base64-encoded-access-key>
  SecretAccessKey: <base64-encoded-secret-key>
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta2
kind: AWSClusterTemplate
metadata:
  name: aws-cluster-template
  namespace: default
spec:
  template:
    spec:
      # AWSåŒºåŸŸ
      region: us-west-2
      
      # VPCé…ç½®
      network:
        vpc:
          cidrBlock: "10.0.0.0/16"
        subnets:
        - availabilityZone: us-west-2a
          cidrBlock: "10.0.1.0/24"
          isPublic: true
        - availabilityZone: us-west-2b  
          cidrBlock: "10.0.2.0/24"
          isPublic: true
          
      # SSHå¯†é’¥
      sshKeyName: "my-cluster-key"
```

### 7.3 å·¥ä½œé›†ç¾¤å®šä¹‰å’Œåˆ›å»º

**ğŸ­ å£°æ˜å¼é›†ç¾¤é…ç½®**

```yaml
# workload-cluster.yaml
apiVersion: cluster.x-k8s.io/v1beta1
kind: Cluster
metadata:
  name: workload-cluster-1
  namespace: default
spec:
  # é›†ç¾¤ç½‘ç»œé…ç½®
  clusterNetwork:
    services:
      cidrBlocks: ["10.96.0.0/12"]
    pods:
      cidrBlocks: ["192.168.0.0/16"]
  
  # æ§åˆ¶å¹³é¢å¼•ç”¨
  controlPlaneRef:
    apiVersion: controlplane.cluster.x-k8s.io/v1beta1
    kind: KubeadmControlPlane
    name: workload-cluster-1-control-plane
    
  # åŸºç¡€è®¾æ–½å¼•ç”¨  
  infrastructureRef:
    apiVersion: infrastructure.cluster.x-k8s.io/v1beta2
    kind: AWSCluster
    name: workload-cluster-1-aws
---
# æ§åˆ¶å¹³é¢é…ç½®
apiVersion: controlplane.cluster.x-k8s.io/v1beta1
kind: KubeadmControlPlane
metadata:
  name: workload-cluster-1-control-plane
  namespace: default
spec:
  # æ§åˆ¶å¹³é¢èŠ‚ç‚¹æ•°é‡
  replicas: 3
  
  # Kubernetesç‰ˆæœ¬
  version: v1.28.0
  
  # æœºå™¨æ¨¡æ¿
  machineTemplate:
    infrastructureRef:
      apiVersion: infrastructure.cluster.x-k8s.io/v1beta2
      kind: AWSMachineTemplate
      name: workload-cluster-1-control-plane-machine
      
  # kubeadmé…ç½®
  kubeadmConfigSpec:
    initConfiguration:
      nodeRegistration:
        kubeletExtraArgs:
          cloud-provider: aws
    joinConfiguration:
      nodeRegistration:
        kubeletExtraArgs:
          cloud-provider: aws
    clusterConfiguration:
      apiServer:
        extraArgs:
          cloud-provider: aws
      controllerManager:
        extraArgs:
          cloud-provider: aws
```

**ğŸ–¥ï¸ å·¥ä½œèŠ‚ç‚¹é…ç½®**
```yaml
# worker-nodes.yaml
apiVersion: cluster.x-k8s.io/v1beta1
kind: MachineDeployment
metadata:
  name: workload-cluster-1-workers
  namespace: default
spec:
  # å·¥ä½œèŠ‚ç‚¹æ•°é‡
  replicas: 3
  
  # é›†ç¾¤å…³è”
  clusterName: workload-cluster-1
  
  selector:
    matchLabels:
      cluster.x-k8s.io/cluster-name: workload-cluster-1
      cluster.x-k8s.io/deployment-name: workload-cluster-1-workers
      
  template:
    metadata:
      labels:
        cluster.x-k8s.io/cluster-name: workload-cluster-1
        cluster.x-k8s.io/deployment-name: workload-cluster-1-workers
    spec:
      clusterName: workload-cluster-1
      version: v1.28.0
      
      # å¯åŠ¨é…ç½®
      bootstrap:
        configRef:
          apiVersion: bootstrap.cluster.x-k8s.io/v1beta1
          kind: KubeadmConfigTemplate
          name: workload-cluster-1-worker-config
          
      # åŸºç¡€è®¾æ–½é…ç½®
      infrastructureRef:
        apiVersion: infrastructure.cluster.x-k8s.io/v1beta2
        kind: AWSMachineTemplate  
        name: workload-cluster-1-worker-machine
---
# å·¥ä½œèŠ‚ç‚¹æœºå™¨æ¨¡æ¿
apiVersion: infrastructure.cluster.x-k8s.io/v1beta2
kind: AWSMachineTemplate
metadata:
  name: workload-cluster-1-worker-machine
  namespace: default
spec:
  template:
    spec:
      # EC2å®ä¾‹ç±»å‹
      instanceType: m5.large
      
      # AMI ID
      ami:
        id: ami-12345678  # Ubuntu 20.04 LTS
        
      # å®‰å…¨ç»„
      additionalSecurityGroups:
      - id: sg-worker-nodes
      
      # ç”¨æˆ·æ•°æ®è„šæœ¬
      userData: |
        #!/bin/bash
        # å®‰è£…Docker
        apt-get update
        apt-get install -y docker.io
        systemctl enable docker
        systemctl start docker
        
        # é…ç½®kubelet
        echo "Environment=KUBELET_EXTRA_ARGS=--cloud-provider=aws" >> /etc/systemd/system/kubelet.service.d/10-kubeadm.conf
```

---

## 8. ğŸŒ Virtual Kubeleté…ç½®


### 8.1 Virtual Kubeletæ¦‚å¿µç†è§£

**ğŸ¯ Virtual Kubeletæ˜¯ä»€ä¹ˆ**

```
ä¼ ç»ŸKubeleté™åˆ¶ï¼š
- æ¯ä¸ªèŠ‚ç‚¹å¿…é¡»æ˜¯çœŸå®çš„ç‰©ç†æœºæˆ–è™šæ‹Ÿæœº
- èŠ‚ç‚¹èµ„æºå›ºå®šï¼Œæ— æ³•åŠ¨æ€è°ƒæ•´
- è·¨äº‘å¹³å°ç®¡ç†å¤æ‚

Virtual Kubeletçªç ´ï¼š
å°±åƒç»™Kubernetesè£…ä¸Šäº†"ä¸‡èƒ½é€‚é…å™¨"
- å¯ä»¥æŠŠä»»ä½•è®¡ç®—å¹³å°å½“ä½œK8sèŠ‚ç‚¹
- æ— æœåŠ¡å™¨è®¡ç®—å¹³å°ï¼ˆå¦‚AWS Fargateï¼‰
- è¾¹ç¼˜è®¡ç®—èŠ‚ç‚¹
- IoTè®¾å¤‡é›†ç¾¤
- å…¶ä»–å®¹å™¨å¹³å°

å®é™…åº”ç”¨åœºæ™¯ï¼š
ğŸ¢ æ··åˆäº‘ï¼šæœ¬åœ°K8s + äº‘ç«¯æ— æœåŠ¡å™¨
ğŸŒ è¾¹ç¼˜è®¡ç®—ï¼šä¸­å¿ƒé›†ç¾¤ç®¡ç†è¾¹ç¼˜èŠ‚ç‚¹  
ğŸ’° æˆæœ¬ä¼˜åŒ–ï¼šæŒ‰éœ€ä½¿ç”¨äº‘èµ„æº
ğŸš€ å¼¹æ€§æ‰©å±•ï¼šçªå‘æµé‡æ—¶å¿«é€Ÿæ‰©å®¹åˆ°äº‘ç«¯
```

### 8.2 Virtual Kubeletéƒ¨ç½²é…ç½®

**ğŸš€ åŸºç¡€ç»„ä»¶å®‰è£…**

```yaml
# virtual-kubelet-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: virtual-kubelet
  namespace: kube-system
  labels:
    app: virtual-kubelet
spec:
  replicas: 1
  selector:
    matchLabels:
      app: virtual-kubelet
  template:
    metadata:
      labels:
        app: virtual-kubelet
    spec:
      serviceAccountName: virtual-kubelet
      nodeSelector:
        type: virtual-kubelet
      containers:
      - name: virtual-kubelet
        image: virtual-kubelet/virtual-kubelet:latest
        env:
        # è™šæ‹ŸèŠ‚ç‚¹åç§°
        - name: KUBELET_NODE_NAME
          value: "virtual-node-1"
        # æä¾›å•†ç±»å‹  
        - name: VIRTUAL_KUBELET_PROVIDER
          value: "aws-fargate"  # æˆ– "azure-aci", "mock"
        # é…ç½®æ–‡ä»¶è·¯å¾„
        - name: VIRTUAL_KUBELET_CONFIG
          value: "/etc/virtual-kubelet/config.yaml"
        # æ—¥å¿—çº§åˆ«
        - name: LOG_LEVEL
          value: "info"
        volumeMounts:
        - name: config
          mountPath: /etc/virtual-kubelet
        - name: kubeconfig
          mountPath: /root/.kube
      volumes:
      - name: config
        configMap:
          name: virtual-kubelet-config
      - name: kubeconfig
        secret:
          secretName: virtual-kubelet-kubeconfig
```

**âš™ï¸ æä¾›å•†ç‰¹å®šé…ç½®**
```yaml
# virtual-kubelet-config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: virtual-kubelet-config
  namespace: kube-system
data:
  config.yaml: |
    # è™šæ‹ŸèŠ‚ç‚¹é…ç½®
    nodeName: virtual-node-1
    operatingSystem: linux
    architecture: amd64
    
    # èŠ‚ç‚¹æ ‡ç­¾å’Œæ±¡ç‚¹
    nodeLabels:
      kubernetes.io/role: agent
      type: virtual-kubelet
      provider: aws-fargate
      zone: us-west-2a
      
    nodeTaints:
    - key: "virtual-kubelet.io/provider"
      value: "aws-fargate"  
      effect: "NoSchedule"
    
    # èµ„æºé…ç½®
    cpu: "1000"      # 1000æ ¸CPUï¼ˆè™šæ‹Ÿæ— é™ï¼‰
    memory: "1000Gi" # 1000Gå†…å­˜ï¼ˆè™šæ‹Ÿæ— é™ï¼‰
    pods: "1000"     # æœ€å¤§Podæ•°
    
    # æä¾›å•†ç‰¹å®šé…ç½®
    providers:
      aws:
        region: us-west-2
        clusterName: my-fargate-cluster
        subnets:
        - subnet-12345678
        - subnet-87654321
        securityGroups:
        - sg-virtual-kubelet
        executionRoleArn: arn:aws:iam::123456789:role/fargateTaskExecutionRole
        taskRoleArn: arn:aws:iam::123456789:role/fargateTaskRole
```

### 8.3 å·¥ä½œè´Ÿè½½è°ƒåº¦åˆ°Virtual Kubelet

**ğŸ“¦ åº”ç”¨éƒ¨ç½²é…ç½®**

```yaml
# fargate-workload.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fargate-web-app
  namespace: default
spec:
  replicas: 3
  selector:
    matchLabels:
      app: fargate-web-app
  template:
    metadata:
      labels:
        app: fargate-web-app
    spec:
      # èŠ‚ç‚¹é€‰æ‹©ï¼šåªè°ƒåº¦åˆ°virtual-kubeletèŠ‚ç‚¹
      nodeSelector:
        type: virtual-kubelet
        provider: aws-fargate
        
      # å®¹å¿æ±¡ç‚¹
      tolerations:
      - key: "virtual-kubelet.io/provider"
        operator: Equal
        value: "aws-fargate"
        effect: NoSchedule
        
      containers:
      - name: web-app
        image: nginx:latest
        ports:
        - containerPort: 80
        resources:
          # Fargateéœ€è¦æ˜ç¡®çš„èµ„æºè§„æ ¼
          requests:
            cpu: 250m      # 0.25 vCPU
            memory: 512Mi  # 512MB
          limits:
            cpu: 500m      # 0.5 vCPU  
            memory: 1Gi    # 1GB
            
        # Fargateç‰¹å®šé…ç½®
        env:
        - name: FARGATE_EXECUTION
          value: "true"
        
      # Fargateä»»åŠ¡å®šä¹‰ç›¸å…³
      restartPolicy: Always
      
      # ç½‘ç»œæ¨¡å¼ï¼ˆFargateä½¿ç”¨awsvpcï¼‰
      dnsPolicy: Default
```

**ğŸ”§ è¾¹ç¼˜èŠ‚ç‚¹Virtual Kubeleté…ç½®**
```yaml
# edge-virtual-kubelet.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: edge-virtual-kubelet-config
  namespace: kube-system
data:
  config.yaml: |
    nodeName: edge-node-1
    operatingSystem: linux
    architecture: arm64  # è¾¹ç¼˜è®¾å¤‡é€šå¸¸æ˜¯ARMæ¶æ„
    
    nodeLabels:
      kubernetes.io/role: agent
      type: virtual-kubelet
      provider: edge-computing
      location: factory-floor-1
      
    # è¾¹ç¼˜èŠ‚ç‚¹èµ„æºé€šå¸¸æœ‰é™
    cpu: "4"         # 4æ ¸CPU
    memory: "8Gi"    # 8Gå†…å­˜
    pods: "50"       # æœ€å¤§50ä¸ªPod
    
    # è¾¹ç¼˜è®¡ç®—ç‰¹å®šé…ç½®
    providers:
      edge:
        # è¾¹ç¼˜èŠ‚ç‚¹è¿æ¥ä¿¡æ¯
        endpoint: "https://edge-node-1.factory.example.com"
        # è¯ä¹¦é…ç½®
        tlsConfig:
          certFile: "/etc/certs/edge.crt"
          keyFile: "/etc/certs/edge.key"
          caFile: "/etc/certs/ca.crt"
        # ç½‘ç»œé…ç½®
        networkConfig:
          subnet: "192.168.100.0/24"
          gateway: "192.168.100.1"
---
# è¾¹ç¼˜å·¥ä½œè´Ÿè½½ç¤ºä¾‹
apiVersion: apps/v1
kind: Deployment
metadata:
  name: edge-sensor-processor
  namespace: default
spec:
  replicas: 2
  selector:
    matchLabels:
      app: sensor-processor
  template:
    metadata:
      labels:
        app: sensor-processor
    spec:
      nodeSelector:
        type: virtual-kubelet
        provider: edge-computing
        location: factory-floor-1
        
      containers:
      - name: processor
        image: sensor-processor:v1.0
        resources:
          requests:
            cpu: 100m     # è¾¹ç¼˜è®¾å¤‡èµ„æºæœ‰é™
            memory: 128Mi
          limits:
            cpu: 200m
            memory: 256Mi
        env:
        - name: SENSOR_ENDPOINT
          value: "tcp://192.168.100.50:1883"  # æœ¬åœ°ä¼ æ„Ÿå™¨
        - name: UPLOAD_INTERVAL
          value: "300"  # 5åˆ†é’Ÿä¸Šä¼ ä¸€æ¬¡æ•°æ®
```

---

## 9. ğŸ” è·¨é›†ç¾¤æœåŠ¡å‘ç°é…ç½®


### 9.1 æœåŠ¡å‘ç°æœºåˆ¶åŸç†

**ğŸ¯ è·¨é›†ç¾¤æœåŠ¡å‘ç°çš„æŒ‘æˆ˜**

```
å•é›†ç¾¤æœåŠ¡å‘ç°ï¼š
åº”ç”¨Aæƒ³è°ƒç”¨åº”ç”¨B
â†’ æŸ¥è¯¢é›†ç¾¤å†…DNS
â†’ è·å¾—åº”ç”¨Bçš„ClusterIP
â†’ ç›´æ¥é€šä¿¡

è·¨é›†ç¾¤æœåŠ¡å‘ç°æŒ‘æˆ˜ï¼š
åº”ç”¨Aï¼ˆé›†ç¾¤1ï¼‰æƒ³è°ƒç”¨åº”ç”¨Bï¼ˆé›†ç¾¤2ï¼‰
â†’ é›†ç¾¤1çš„DNSä¸çŸ¥é“é›†ç¾¤2çš„æœåŠ¡
â†’ ç½‘ç»œä¸äº’é€š
â†’ æœåŠ¡æ³¨å†Œä¿¡æ¯ä¸åŒæ­¥

è§£å†³æ–¹æ¡ˆæ€è·¯ï¼š
1. ç»Ÿä¸€æœåŠ¡æ³¨å†Œä¸­å¿ƒ
2. è·¨é›†ç¾¤ç½‘ç»œè¿é€š
3. DNSè”é‚¦æˆ–æœåŠ¡ç½‘æ ¼
4. APIç½‘å…³èšåˆ
```

### 9.2 åŸºäºDNSçš„æœåŠ¡å‘ç°

**ğŸŒ DNSè”é‚¦é…ç½®**

```yaml
# coredns-federation.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: coredns-custom
  namespace: kube-system
data:
  Corefile: |
    .:53 {
        errors
        health {
           lameduck 5s
        }
        ready
        
        # Kubernetesé›†ç¾¤å†…æœåŠ¡å‘ç°
        kubernetes cluster.local in-addr.arpa ip6.arpa {
           pods insecure
           fallthrough in-addr.arpa ip6.arpa
           ttl 30
        }
        
        # è·¨é›†ç¾¤æœåŠ¡å‘ç°
        federation cluster.local {
            # é›†ç¾¤Açš„æœåŠ¡
            cluster-a cluster-a.example.com:53
            # é›†ç¾¤Bçš„æœåŠ¡  
            cluster-b cluster-b.example.com:53
            # é›†ç¾¤Cçš„æœåŠ¡
            cluster-c cluster-c.example.com:53
        }
        
        # å¤–éƒ¨DNSæŸ¥è¯¢
        forward . /etc/resolv.conf {
           max_concurrent 1000
        }
        
        cache 30
        loop
        reload
        loadbalance
    }
```

**ğŸ”§ è·¨é›†ç¾¤ServiceExporté…ç½®**
```yaml
# multi-cluster-service-export.yaml
# åœ¨æä¾›æœåŠ¡çš„é›†ç¾¤ä¸­å¯¼å‡ºæœåŠ¡
apiVersion: multicluster.x-k8s.io/v1alpha1
kind: ServiceExport
metadata:
  name: user-service
  namespace: backend
spec:
  # ç©ºçš„specï¼Œè¡¨ç¤ºå¯¼å‡ºæ•´ä¸ªæœåŠ¡
---
# åŸå§‹æœåŠ¡å®šä¹‰
apiVersion: v1
kind: Service
metadata:
  name: user-service
  namespace: backend
  labels:
    app: user-service
    cluster: cluster-a
  annotations:
    multicluster.kubernetes.io/service-export: "true"
spec:
  selector:
    app: user-service
  ports:
  - name: http
    port: 80
    targetPort: 8080
    protocol: TCP
  - name: grpc
    port: 9090
    targetPort: 9090
    protocol: TCP
  type: ClusterIP
---
# åœ¨æ¶ˆè´¹æœåŠ¡çš„é›†ç¾¤ä¸­å¯¼å…¥æœåŠ¡
apiVersion: multicluster.x-k8s.io/v1alpha1
kind: ServiceImport
metadata:
  name: user-service
  namespace: backend
spec:
  type: ClusterSetIP  # è·¨é›†ç¾¤æœåŠ¡ç±»å‹
  ports:
  - name: http
    port: 80
    protocol: TCP
  - name: grpc
    port: 9090
    protocol: TCP
```

### 9.3 åŸºäºæœåŠ¡ç½‘æ ¼çš„è·¨é›†ç¾¤é€šä¿¡

**ğŸ•¸ï¸ Istioè·¨é›†ç¾¤é…ç½®**

```yaml
# istio-multicluster-secret.yaml
# åœ¨æ¯ä¸ªé›†ç¾¤ä¸­åˆ›å»ºå…¶ä»–é›†ç¾¤çš„è®¿é—®å‡­è¯
apiVersion: v1
kind: Secret
metadata:
  name: istio-remote-secret-cluster-b
  namespace: istio-system
  labels:
    istio/cluster: cluster-b
  annotations:
    networking.istio.io/cluster: cluster-b
type: Opaque
data:
  # cluster-bçš„kubeconfigï¼ˆbase64ç¼–ç ï¼‰
  cluster-b: <base64-encoded-kubeconfig>
---
# è·¨é›†ç¾¤ç½‘ç»œé…ç½®
apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
metadata:
  name: cross-cluster-config
spec:
  values:
    pilot:
      env:
        # å¯ç”¨è·¨é›†ç¾¤æœåŠ¡å‘ç°
        ENABLE_CROSS_CLUSTER_WORKLOAD_ENTRY: true
        PILOT_ENABLE_WORKLOAD_ENTRY_AUTOREGISTRATION: true
    global:
      # é›†ç¾¤ç½‘ç»œé…ç½®
      network: "network-1"  # å½“å‰é›†ç¾¤çš„ç½‘ç»œæ ‡è¯†
      remotePilotAddress: "istio-pilot.cluster-b.example.com"
      
      # è·¨é›†ç¾¤è´Ÿè½½å‡è¡¡
      defaultConfig:
        proxyStatsMatcher:
          inclusionRegexps:
          - ".*_cx_.*"
          - ".*_rq_.*"
          - ".*_rbac_.*"
```

**ğŸŒ è·¨é›†ç¾¤æµé‡ç­–ç•¥**
```yaml
# cross-cluster-traffic-policy.yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: user-service-routing
  namespace: backend
spec:
  hosts:
  - user-service.backend.svc.cluster.local
  http:
  - match:
    - headers:
        cluster-preference:
          exact: local
    route:
    - destination:
        host: user-service.backend.svc.cluster.local
        subset: local-cluster
      weight: 100
      
  - match:
    - uri:
        prefix: "/api/v1"
    route:
    # 70%æµé‡åˆ°æœ¬åœ°é›†ç¾¤
    - destination:
        host: user-service.backend.svc.cluster.local
        subset: local-cluster
      weight: 70
    # 30%æµé‡åˆ°è¿œç¨‹é›†ç¾¤  
    - destination:
        host: user-service.backend.svc.cluster.local
        subset: remote-cluster-b
      weight: 30
      
  # é»˜è®¤è·¯ç”±åˆ°æœ¬åœ°é›†ç¾¤
  - route:
    - destination:
        host: user-service.backend.svc.cluster.local
        subset: local-cluster
---
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: user-service-destination
  namespace: backend
spec:
  host: user-service.backend.svc.cluster.local
  trafficPolicy:
    # è¿æ¥æ± é…ç½®
    connectionPool:
      tcp:
        maxConnections: 50
      http:
        http1MaxPendingRequests: 10
        maxRequestsPerConnection: 2
    # è´Ÿè½½å‡è¡¡ç­–ç•¥
    loadBalancer:
      simple: LEAST_CONN
    # å¼‚å¸¸æ£€æµ‹
    outlierDetection:
      consecutiveErrors: 3
      interval: 30s
      baseEjectionTime: 30s
      
  subsets:
  # æœ¬åœ°é›†ç¾¤å­é›†
  - name: local-cluster
    labels:
      cluster: cluster-a
    trafficPolicy:
      connectionPool:
        tcp:
          maxConnections: 100
          
  # è¿œç¨‹é›†ç¾¤å­é›†
  - name: remote-cluster-b
    labels:
      cluster: cluster-b
    trafficPolicy:
      connectionPool:
        tcp:
          maxConnections: 20  # è¿œç¨‹è¿æ¥æ•°é™åˆ¶æ›´ä¸¥æ ¼
      outlierDetection:
        consecutiveErrors: 2  # è¿œç¨‹é›†ç¾¤æ›´æ•æ„Ÿçš„å¼‚å¸¸æ£€æµ‹
```

### 9.4 é›†ç¾¤æ³¨å†Œè¡¨ç®¡ç†

**ğŸ“‹ ç»Ÿä¸€æœåŠ¡æ³¨å†Œä¸­å¿ƒ**

```yaml
# cluster-registry.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: cluster-registry-system
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cluster-registry
  namespace: cluster-registry-system
spec:
  replicas: 3  # é«˜å¯ç”¨éƒ¨ç½²
  selector:
    matchLabels:
      app: cluster-registry
  template:
    metadata:
      labels:
        app: cluster-registry
    spec:
      containers:
      - name: registry
        image: cluster-registry:v1.0.0
        env:
        - name: REGISTRY_MODE
          value: "multi-cluster"
        - name: DATABASE_URL
          value: "postgres://registry:password@postgres:5432/registry"
        - name: SYNC_INTERVAL
          value: "30s"  # æœåŠ¡ä¿¡æ¯åŒæ­¥é—´éš”
        ports:
        - containerPort: 8080
          name: api
        - containerPort: 8090
          name: metrics
        volumeMounts:
        - name: config
          mountPath: /etc/registry
      volumes:
      - name: config
        configMap:
          name: registry-config
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: registry-config
  namespace: cluster-registry-system
data:
  config.yaml: |
    # é›†ç¾¤æ³¨å†Œè¡¨é…ç½®
    clusters:
    - name: "cluster-a"
      endpoint: "https://cluster-a.example.com:6443"
      region: "us-west"
      environment: "production"
      capabilities:
      - "compute"
      - "storage"
      - "networking"
      
    - name: "cluster-b"
      endpoint: "https://cluster-b.example.com:6443" 
      region: "us-east"
      environment: "production"
      capabilities:
      - "compute"
      - "storage"
      - "gpu-compute"
      
    - name: "cluster-c"
      endpoint: "https://cluster-c.example.com:6443"
      region: "eu-west"
      environment: "production"  
      capabilities:
      - "compute"
      - "storage"
      
    # æœåŠ¡å‘ç°é…ç½®
    serviceDiscovery:
      enabled: true
      syncInterval: "30s"
      healthCheckInterval: "10s"
      
    # è´Ÿè½½å‡è¡¡é…ç½®
    loadBalancing:
      strategy: "weighted-round-robin"
      healthyThreshold: 2
      unhealthyThreshold: 3
---
# æœåŠ¡æ³¨å†Œé…ç½®
apiVersion: v1
kind: Service
metadata:
  name: user-service
  namespace: backend
  annotations:
    cluster-registry.io/export: "true"
    cluster-registry.io/load-balance: "true"
    cluster-registry.io/health-check-path: "/health"
spec:
  selector:
    app: user-service
  ports:
  - name: http
    port: 80
    targetPort: 8080
  - name: metrics
    port: 9090
    targetPort: 9090
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å¤šé›†ç¾¤ç®¡ç†ï¼šä¼ä¸šçº§Kubernetesçš„å¿…ç„¶é€‰æ‹©ï¼Œè§£å†³å•é›†ç¾¤å±€é™æ€§
ğŸ”¸ ç½‘ç»œè¿é€šï¼šSubmarinerç­‰å·¥å…·å®ç°é›†ç¾¤é—´å®‰å…¨ç½‘ç»œéš§é“
ğŸ”¸ æœåŠ¡å‘ç°ï¼šè·¨é›†ç¾¤æœåŠ¡è°ƒç”¨çš„DNSå’ŒæœåŠ¡ç½‘æ ¼è§£å†³æ–¹æ¡ˆ
ğŸ”¸ ç»Ÿä¸€ç®¡ç†ï¼šRancherã€OCMç­‰å¹³å°æä¾›å¯è§†åŒ–é›†ç¾¤ç®¡ç†
ğŸ”¸ å£°æ˜å¼åˆ›å»ºï¼šCluster APIå®ç°é›†ç¾¤çš„ä»£ç åŒ–ç®¡ç†
ğŸ”¸ æ··åˆè®¡ç®—ï¼šVirtual Kubeletè¿æ¥å¤šç§è®¡ç®—å¹³å°
ğŸ”¸ æµé‡ç®¡ç†ï¼šAdmiralã€Istioå®ç°æ™ºèƒ½è·¨é›†ç¾¤è´Ÿè½½å‡è¡¡
ğŸ”¸ ç­–ç•¥æ²»ç†ï¼šç»Ÿä¸€çš„å®‰å…¨ç­–ç•¥å’Œåˆè§„æ€§ç®¡ç†
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å¤šé›†ç¾¤æ¶æ„çš„ä»·å€¼**
```
ä¸šåŠ¡è¿ç»­æ€§ï¼š
- å•é›†ç¾¤æ•…éšœä¸å½±å“æ•´ä½“æœåŠ¡
- æ”¯æŒç¾å¤‡å’Œå¤šæ´»éƒ¨ç½²
- æé«˜ç³»ç»Ÿæ•´ä½“å¯ç”¨æ€§

èµ„æºä¼˜åŒ–ï¼š
- å°±è¿‘éƒ¨ç½²é™ä½å»¶è¿Ÿ
- è·¨äº‘å¹³å°é¿å…å‚å•†é”å®š
- å¼¹æ€§æ‰©å±•ä¼˜åŒ–æˆæœ¬

åˆè§„è¦æ±‚ï¼š
- æ•°æ®ä¸»æƒå’Œåœ°åŸŸè¦æ±‚
- ä¸åŒç¯å¢ƒçš„éš”ç¦»éœ€æ±‚
- å®‰å…¨ç­‰çº§åˆ†å±‚ç®¡ç†
```

**ğŸ”¹ æŠ€æœ¯é€‰æ‹©ç­–ç•¥**
```
Admiralï¼šé€‚åˆæœåŠ¡ç½‘æ ¼ç¯å¢ƒçš„æµé‡ç®¡ç†
Submarinerï¼šä¸“æ³¨è·¨é›†ç¾¤ç½‘ç»œè¿é€š
Clusternetï¼šç»Ÿä¸€APIçš„å¤šé›†ç¾¤æ“ä½œ
OCMï¼šä¼ä¸šçº§æ²»ç†å’Œç­–ç•¥ç®¡ç†
Rancherï¼šç”¨æˆ·å‹å¥½çš„å¯è§†åŒ–ç®¡ç†
Cluster APIï¼šåŸºç¡€è®¾æ–½å³ä»£ç çš„é›†ç¾¤ç®¡ç†
Virtual Kubeletï¼šæ··åˆäº‘å’Œè¾¹ç¼˜è®¡ç®—åœºæ™¯
```

**ğŸ”¹ å®æ–½éš¾ç‚¹å’Œè§£å†³æ€è·¯**
```
ç½‘ç»œå¤æ‚æ€§ï¼š
- ä½¿ç”¨ä¸“ä¸šç½‘ç»œå·¥å…·ï¼ˆSubmarinerï¼‰
- è§„åˆ’å¥½IPåœ°å€åˆ†é…
- å»ºç«‹ç½‘ç»œè¿é€šæµ‹è¯•æœºåˆ¶

ç®¡ç†å¤æ‚æ€§ï¼š
- é€‰æ‹©åˆé€‚çš„ç®¡ç†å¹³å°
- å»ºç«‹æ ‡å‡†åŒ–æ“ä½œæµç¨‹
- æŠ•èµ„å›¢é˜ŸåŸ¹è®­å’Œæ–‡æ¡£

å®‰å…¨æŒ‘æˆ˜ï¼š
- ç»Ÿä¸€èº«ä»½è®¤è¯ç³»ç»Ÿ
- ç½‘ç»œæµé‡åŠ å¯†ä¼ è¾“
- å®šæœŸå®‰å…¨å®¡è®¡å’Œæ¼æ´æ‰«æ
```

### 10.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¼ä¸šåº”ç”¨åœºæ™¯**
- **é‡‘èè¡Œä¸š**ï¼šå¤šæ•°æ®ä¸­å¿ƒéƒ¨ç½²æ»¡è¶³ç›‘ç®¡è¦æ±‚
- **ç”µå•†å¹³å°**ï¼šå…¨çƒåŒ–ä¸šåŠ¡çš„å°±è¿‘æœåŠ¡éƒ¨ç½²
- **åˆ¶é€ ä¸š**ï¼šå·¥å‚è¾¹ç¼˜è®¡ç®—ä¸äº‘ç«¯æ•°æ®ä¸­å¿ƒååŒ
- **æ¸¸æˆè¡Œä¸š**ï¼šå…¨çƒå¤šåŒºåŸŸä½å»¶è¿ŸæœåŠ¡éƒ¨ç½²

**ğŸ”§ è¿ç»´æœ€ä½³å®è·µ**
- **æ¸è¿›å¼è¿ç§»**ï¼šä»å•é›†ç¾¤é€æ­¥æ¼”è¿›åˆ°å¤šé›†ç¾¤
- **æ ‡å‡†åŒ–ç®¡ç†**ï¼šå»ºç«‹ç»Ÿä¸€çš„é›†ç¾¤ç®¡ç†è§„èŒƒ
- **ç›‘æ§å‘Šè­¦**ï¼šå®Œå–„çš„è·¨é›†ç¾¤ç›‘æ§ä½“ç³»
- **åº”æ€¥é¢„æ¡ˆ**ï¼šå®Œæ•´çš„æ•…éšœè½¬ç§»å’Œæ¢å¤æµç¨‹

**ğŸ“ˆ å‘å±•è¶‹åŠ¿å±•æœ›**
- **Service Meshæ ‡å‡†åŒ–**ï¼šIstioç­‰æˆä¸ºè·¨é›†ç¾¤é€šä¿¡æ ‡å‡†
- **GitOpsé›†æˆ**ï¼šå¤šé›†ç¾¤åº”ç”¨éƒ¨ç½²çš„æ ‡å‡†åŒ–
- **AIè¾…åŠ©ç®¡ç†**ï¼šæ™ºèƒ½åŒ–çš„èµ„æºè°ƒåº¦å’Œæ•…éšœé¢„æµ‹
- **è¾¹ç¼˜è®¡ç®—èåˆ**ï¼šäº‘è¾¹ååŒçš„ç»Ÿä¸€ç®¡ç†å¹³å°

**ğŸŒŸ å­¦ä¹ è¿›é˜¶å»ºè®®**
```
åŸºç¡€é˜¶æ®µï¼š
â–¡ ç†è§£å¤šé›†ç¾¤æ¶æ„ä»·å€¼å’ŒæŒ‘æˆ˜
â–¡ æŒæ¡ä¸€ç§ç½‘ç»œè¿é€šæ–¹æ¡ˆï¼ˆSubmarinerï¼‰
â–¡ ç†Ÿæ‚‰ä¸€ç§ç®¡ç†å¹³å°ï¼ˆRancheræˆ–OCMï¼‰

è¿›é˜¶é˜¶æ®µï¼š
â–¡ æ·±å…¥å­¦ä¹ æœåŠ¡ç½‘æ ¼è·¨é›†ç¾¤é…ç½®
â–¡ æŒæ¡Cluster APIå£°æ˜å¼é›†ç¾¤ç®¡ç†
â–¡ ç†è§£Virtual Kubeletæ··åˆäº‘åº”ç”¨

é«˜çº§é˜¶æ®µï¼š
â–¡ è®¾è®¡ä¼ä¸šçº§å¤šé›†ç¾¤æ¶æ„æ–¹æ¡ˆ
â–¡ å»ºç«‹å®Œæ•´çš„ç›‘æ§å’Œæ²»ç†ä½“ç³»
â–¡ ä¼˜åŒ–è·¨é›†ç¾¤åº”ç”¨æ€§èƒ½å’Œå®‰å…¨
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- å¤šé›†ç¾¤ç®¡ç†è§£ç—›ç‚¹ï¼Œç½‘ç»œè¿é€šæ˜¯åŸºç¡€
- æœåŠ¡å‘ç°è¦ç»Ÿä¸€ï¼Œæµé‡ç®¡ç†éœ€æ™ºèƒ½
- å¯è§†åŒ–å¹³å°é™é—¨æ§›ï¼Œå£°æ˜å¼åˆ›å»ºæ ‡å‡†åŒ–
- æ··åˆäº‘è¾¹ä¸€ä½“åŒ–ï¼Œä¼ä¸šçº§æ²»ç†ä¸å¯å°‘