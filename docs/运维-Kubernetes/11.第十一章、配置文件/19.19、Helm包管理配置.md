---
title: 19ã€HelmåŒ…ç®¡ç†é…ç½®
---
## ğŸ“š ç›®å½•

1. [HelmåŒ…ç®¡ç†å™¨æ¦‚è¿°](#1-helmåŒ…ç®¡ç†å™¨æ¦‚è¿°)
2. [Chartæ ¸å¿ƒé…ç½®æ–‡ä»¶](#2-chartæ ¸å¿ƒé…ç½®æ–‡ä»¶)
3. [æ¨¡æ¿ç³»ç»Ÿè¯¦è§£](#3-æ¨¡æ¿ç³»ç»Ÿè¯¦è§£)
4. [å¤šç¯å¢ƒé…ç½®ç®¡ç†](#4-å¤šç¯å¢ƒé…ç½®ç®¡ç†)
5. [ä¾èµ–ä¸é’©å­é…ç½®](#5-ä¾èµ–ä¸é’©å­é…ç½®)
6. [å®æˆ˜é…ç½®ç¤ºä¾‹](#6-å®æˆ˜é…ç½®ç¤ºä¾‹)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ HelmåŒ…ç®¡ç†å™¨æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯Helm


**ç®€å•ç†è§£**ï¼šHelmå°±åƒæ˜¯Kubernetesçš„"åº”ç”¨å•†åº—ç®¡ç†å™¨"

```
ä¼ ç»Ÿæ–¹å¼éƒ¨ç½²åº”ç”¨ï¼š
kubectl apply -f deployment.yaml
kubectl apply -f service.yaml  
kubectl apply -f configmap.yaml
kubectl apply -f ingress.yaml
...ï¼ˆå¯èƒ½æœ‰åå‡ ä¸ªé…ç½®æ–‡ä»¶ï¼‰

ä½¿ç”¨Helméƒ¨ç½²åº”ç”¨ï¼š
helm install my-app ./my-chart
ï¼ˆä¸€æ¡å‘½ä»¤æå®šæ‰€æœ‰é…ç½®ï¼‰
```

**æ ¸å¿ƒä½œç”¨**ï¼š
- ğŸ”¸ **æ‰“åŒ…ç®¡ç†**ï¼šæŠŠå¤æ‚çš„K8såº”ç”¨æ‰“åŒ…æˆä¸€ä¸ªæ•´ä½“
- ğŸ”¸ **ç‰ˆæœ¬æ§åˆ¶**ï¼šåƒGitä¸€æ ·ç®¡ç†åº”ç”¨çš„ä¸åŒç‰ˆæœ¬
- ğŸ”¸ **é…ç½®æ¨¡æ¿**ï¼šä¸€å¥—æ¨¡æ¿é€‚é…å¤šç§ç¯å¢ƒï¼ˆå¼€å‘/æµ‹è¯•/ç”Ÿäº§ï¼‰
- ğŸ”¸ **ä¾èµ–ç®¡ç†**ï¼šè‡ªåŠ¨å¤„ç†åº”ç”¨é—´çš„ä¾èµ–å…³ç³»

### 1.2 æ ¸å¿ƒæ¦‚å¿µè§£é‡Š


**Chartï¼ˆå›¾è¡¨åŒ…ï¼‰**ï¼š
```
Chart = åº”ç”¨çš„"å®‰è£…åŒ…"
åŒ…å«ï¼šé…ç½®æ–‡ä»¶ + æ¨¡æ¿ + è¯´æ˜æ–‡æ¡£ + ä¾èµ–ä¿¡æ¯

å°±åƒï¼š
- Androidçš„APKå®‰è£…åŒ…
- Windowsçš„exeå®‰è£…ç¨‹åº
- npmçš„è½¯ä»¶åŒ…
```

**Releaseï¼ˆå‘å¸ƒå®ä¾‹ï¼‰**ï¼š
```
Release = Chartçš„"è¿è¡Œå®ä¾‹"
ä¸€ä¸ªChartå¯ä»¥åˆ›å»ºå¤šä¸ªRelease

ä¾‹å¦‚ï¼š
Chart: wordpressï¼ˆWordPressåšå®¢ç³»ç»Ÿï¼‰
Release1: blog-prodï¼ˆç”Ÿäº§ç¯å¢ƒåšå®¢ï¼‰
Release2: blog-devï¼ˆå¼€å‘ç¯å¢ƒåšå®¢ï¼‰
```

**Repositoryï¼ˆä»“åº“ï¼‰**ï¼š
```
Repository = Chartçš„"å­˜å‚¨ä»“åº“"
ç±»ä¼¼ï¼š
- Docker Hubï¼ˆå­˜å‚¨Dockeré•œåƒï¼‰
- GitHubï¼ˆå­˜å‚¨ä»£ç ï¼‰
- Helm Hubï¼ˆå­˜å‚¨ChartåŒ…ï¼‰
```

### 1.3 Helmç›®å½•ç»“æ„


```
my-app-chart/                    # Chartæ ¹ç›®å½•
â”œâ”€â”€ Chart.yaml                  # ChartåŸºæœ¬ä¿¡æ¯
â”œâ”€â”€ values.yaml                 # é»˜è®¤é…ç½®å€¼
â”œâ”€â”€ values-prod.yaml           # ç”Ÿäº§ç¯å¢ƒé…ç½®
â”œâ”€â”€ values-dev.yaml            # å¼€å‘ç¯å¢ƒé…ç½®
â”œâ”€â”€ requirements.yaml          # ä¾èµ–é…ç½®ï¼ˆHelm 2ï¼‰
â”œâ”€â”€ Chart.lock                 # ä¾èµ–é”æ–‡ä»¶
â”œâ”€â”€ .helmignore               # å¿½ç•¥æ–‡ä»¶åˆ—è¡¨
â”œâ”€â”€ templates/                 # æ¨¡æ¿æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ deployment.yaml        # éƒ¨ç½²é…ç½®æ¨¡æ¿
â”‚   â”œâ”€â”€ service.yaml          # æœåŠ¡é…ç½®æ¨¡æ¿
â”‚   â”œâ”€â”€ ingress.yaml          # å…¥å£é…ç½®æ¨¡æ¿
â”‚   â”œâ”€â”€ configmap.yaml        # é…ç½®æ˜ å°„æ¨¡æ¿
â”‚   â”œâ”€â”€ _helpers.tpl          # åŠ©æ‰‹æ¨¡æ¿
â”‚   â”œâ”€â”€ NOTES.txt             # å®‰è£…è¯´æ˜
â”‚   â”œâ”€â”€ tests/                # æµ‹è¯•æ–‡ä»¶
â”‚   â””â”€â”€ hooks/                # é’©å­æ–‡ä»¶
â””â”€â”€ crds/                     # è‡ªå®šä¹‰èµ„æºå®šä¹‰
    â””â”€â”€ my-crd.yaml
```

---

## 2. ğŸ“‹ Chartæ ¸å¿ƒé…ç½®æ–‡ä»¶


### 2.1 Chart.yaml - Chartå…ƒæ•°æ®


**ä½œç”¨**ï¼šå®šä¹‰Chartçš„åŸºæœ¬ä¿¡æ¯ï¼Œå°±åƒè½¯ä»¶çš„"èº«ä»½è¯"

```yaml
# Chart.yaml - å¿…éœ€æ–‡ä»¶
apiVersion: v2                    # Helm APIç‰ˆæœ¬
name: my-web-app                  # Chartåç§°ï¼ˆå¿…éœ€ï¼‰
description: æˆ‘çš„Webåº”ç”¨ç¨‹åº        # ç®€çŸ­æè¿°
type: application                 # Chartç±»å‹ï¼šapplication æˆ– library
version: 1.2.3                   # Chartç‰ˆæœ¬ï¼ˆå¿…éœ€ï¼‰
appVersion: "2.1.0"              # åº”ç”¨ç¨‹åºç‰ˆæœ¬

# ç»´æŠ¤è€…ä¿¡æ¯
maintainers:
  - name: å¼ ä¸‰                    # ç»´æŠ¤è€…å§“å
    email: zhangsan@company.com   # è”ç³»é‚®ç®±
    url: https://blog.zhangsan.com # ä¸ªäººç½‘ç«™

# é¡¹ç›®ä¿¡æ¯
home: https://my-web-app.com      # é¡¹ç›®ä¸»é¡µ
sources:                          # æºç åœ°å€
  - https://github.com/user/my-web-app
  
keywords:                         # æœç´¢å…³é”®è¯
  - web
  - nginx
  - frontend
  
# ä¾èµ–ç®¡ç†ï¼ˆHelm 3æ¨èæ–¹å¼ï¼‰
dependencies:
  - name: mysql                   # ä¾èµ–çš„Chartåç§°
    version: "9.4.0"             # ä¾èµ–ç‰ˆæœ¬
    repository: https://charts.bitnami.com/bitnami
    condition: mysql.enabled      # æ¡ä»¶å®‰è£…
  - name: redis
    version: "17.3.0" 
    repository: https://charts.bitnami.com/bitnami
    condition: redis.enabled

# æ³¨è§£ä¿¡æ¯
annotations:
  category: web                   # åˆ†ç±»
  licenses: Apache-2.0           # å¼€æºåè®®
```

> ğŸ’¡ **æ–°æ‰‹æç¤º**  
> `version` æ˜¯ChartåŒ…çš„ç‰ˆæœ¬ï¼Œ`appVersion` æ˜¯ä½ åº”ç”¨ç¨‹åºçš„ç‰ˆæœ¬ã€‚æ¯”å¦‚ä½ çš„åº”ç”¨æ˜¯v2.1.0ï¼Œä½†Charté…ç½®æ˜¯ç¬¬3æ¬¡ä¿®æ”¹ï¼Œé‚£ä¹ˆChartç‰ˆæœ¬å°±æ˜¯0.3.0

### 2.2 values.yaml - é»˜è®¤é…ç½®æ–‡ä»¶


**ä½œç”¨**ï¼šå®šä¹‰Chartçš„é»˜è®¤é…ç½®å€¼ï¼Œç›¸å½“äº"å‡ºå‚è®¾ç½®"

```yaml
# values.yaml - é»˜è®¤é…ç½®å€¼
# é•œåƒé…ç½®
image:
  repository: nginx               # é•œåƒä»“åº“åœ°å€
  tag: "1.21.6"                  # é•œåƒæ ‡ç­¾
  pullPolicy: IfNotPresent       # æ‹‰å–ç­–ç•¥

# å‰¯æœ¬æ•°é‡
replicaCount: 1

# æœåŠ¡é…ç½®  
service:
  type: ClusterIP                # æœåŠ¡ç±»å‹
  port: 80                       # æœåŠ¡ç«¯å£
  targetPort: 8080               # ç›®æ ‡ç«¯å£

# å…¥å£é…ç½®
ingress:
  enabled: false                 # æ˜¯å¦å¯ç”¨Ingress
  className: "nginx"             # Ingressç±»å
  annotations: {}                # æ³¨è§£é…ç½®
  hosts:
    - host: my-app.example.com   # åŸŸå
      paths:
        - path: /
          pathType: Prefix

# èµ„æºé™åˆ¶
resources:
  limits:                        # èµ„æºä¸Šé™
    cpu: 500m                    # CPUé™åˆ¶
    memory: 512Mi                # å†…å­˜é™åˆ¶
  requests:                      # èµ„æºè¯·æ±‚
    cpu: 250m
    memory: 256Mi

# ç¯å¢ƒå˜é‡
env:
  - name: APP_ENV
    value: "production"
  - name: DATABASE_URL
    value: "mysql://localhost:3306/myapp"

# é…ç½®æ˜ å°„
config:
  app.properties: |              # é…ç½®æ–‡ä»¶å†…å®¹
    server.port=8080
    logging.level.root=INFO
    
# å­˜å‚¨é…ç½®
persistence:
  enabled: false                 # æ˜¯å¦å¯ç”¨æŒä¹…åŒ–
  storageClass: "standard"       # å­˜å‚¨ç±»
  size: 10Gi                     # å­˜å‚¨å¤§å°

# å®‰å…¨ä¸Šä¸‹æ–‡
securityContext:
  runAsNonRoot: true             # érootç”¨æˆ·è¿è¡Œ
  runAsUser: 1000               # è¿è¡Œç”¨æˆ·ID
```

### 2.3 .helmignore - å¿½ç•¥æ–‡ä»¶


**ä½œç”¨**ï¼šæŒ‡å®šæ‰“åŒ…æ—¶è¦å¿½ç•¥çš„æ–‡ä»¶ï¼Œç±»ä¼¼`.gitignore`

```bash
# .helmignore
# å¼€å‘æ–‡ä»¶
*.tmp
*.orig
*.rej
*~

# ç‰ˆæœ¬æ§åˆ¶
.git/
.gitignore
.bzr/
.hg/

# IDEæ–‡ä»¶
.vscode/
.idea/
*.swp
*.swo

# æ–‡æ¡£å’Œè¯´æ˜
README.md
docs/
examples/

# æµ‹è¯•æ–‡ä»¶
test/
tests/

# CI/CDæ–‡ä»¶  
.travis.yml
.gitlab-ci.yml
Jenkinsfile

# æœ¬åœ°é…ç½®
values-local.yaml
secrets.yaml
```

---

## 3. ğŸ”§ æ¨¡æ¿ç³»ç»Ÿè¯¦è§£


### 3.1 templates/ æ¨¡æ¿ç›®å½•


**ä½œç”¨**ï¼šå­˜æ”¾Kubernetesèµ„æºçš„æ¨¡æ¿æ–‡ä»¶ï¼Œé€šè¿‡å˜é‡å®ç°åŠ¨æ€é…ç½®

**åŸºç¡€æ¨¡æ¿ç¤ºä¾‹**ï¼š

```yaml
# templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Chart.Name }}-deployment     # ä½¿ç”¨Chartåç§°
  labels:
    app: {{ .Chart.Name }}
    version: {{ .Chart.AppVersion }}
spec:
  replicas: {{ .Values.replicaCount }}   # ä½¿ç”¨values.yamlä¸­çš„å€¼
  selector:
    matchLabels:
      app: {{ .Chart.Name }}
  template:
    metadata:
      labels:
        app: {{ .Chart.Name }}
    spec:
      containers:
      - name: {{ .Chart.Name }}
        image: {{ .Values.image.repository }}:{{ .Values.image.tag }}
        ports:
        - containerPort: {{ .Values.service.targetPort }}
        resources:
          {{- toYaml .Values.resources | nindent 12 }}
```

### 3.2 _helpers.tpl - åŠ©æ‰‹æ¨¡æ¿


**ä½œç”¨**ï¼šå®šä¹‰å¯é‡ç”¨çš„æ¨¡æ¿ç‰‡æ®µï¼Œé¿å…é‡å¤ä»£ç 

```yaml
{{/*
# templates/_helpers.tpl
# ç”Ÿæˆåº”ç”¨æ ‡ç­¾
*/}}
{{- define "myapp.labels" -}}
app.kubernetes.io/name: {{ .Chart.Name }}
app.kubernetes.io/instance: {{ .Release.Name }}
app.kubernetes.io/version: {{ .Chart.AppVersion }}
app.kubernetes.io/managed-by: {{ .Release.Service }}
helm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version }}
{{- end }}

{{/*
ç”Ÿæˆé€‰æ‹©å™¨æ ‡ç­¾
*/}}
{{- define "myapp.selectorLabels" -}}
app.kubernetes.io/name: {{ .Chart.Name }}
app.kubernetes.io/instance: {{ .Release.Name }}
{{- end }}

{{/*
ç”Ÿæˆå®Œæ•´çš„åº”ç”¨åç§°
*/}}
{{- define "myapp.fullname" -}}
{{- if .Values.fullnameOverride }}
{{- .Values.fullnameOverride | trunc 63 | trimSuffix "-" }}
{{- else }}
{{- printf "%s-%s" .Release.Name .Chart.Name | trunc 63 | trimSuffix "-" }}
{{- end }}
{{- end }}
```

**åœ¨å…¶ä»–æ¨¡æ¿ä¸­ä½¿ç”¨åŠ©æ‰‹**ï¼š

```yaml
# templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: {{ include "myapp.fullname" . }}    # ä½¿ç”¨åŠ©æ‰‹æ¨¡æ¿
  labels:
    {{- include "myapp.labels" . | nindent 4 }}
spec:
  selector:
    {{- include "myapp.selectorLabels" . | nindent 4 }}
  ports:
    - port: {{ .Values.service.port }}
      targetPort: {{ .Values.service.targetPort }}
```

### 3.3 NOTES.txt - å®‰è£…è¯´æ˜


**ä½œç”¨**ï¼šå®‰è£…å®Œæˆåæ˜¾ç¤ºç»™ç”¨æˆ·çš„ä½¿ç”¨è¯´æ˜

```text
# templates/NOTES.txt
ğŸ‰ {{ .Chart.Name }} å®‰è£…æˆåŠŸï¼

ğŸ“‹ åº”ç”¨ä¿¡æ¯:
- åº”ç”¨åç§°: {{ .Chart.Name }}
- ç‰ˆæœ¬: {{ .Chart.AppVersion }}
- å‘½åç©ºé—´: {{ .Release.Namespace }}

ğŸŒ è®¿é—®åº”ç”¨:
{{- if .Values.ingress.enabled }}
  å¤–éƒ¨è®¿é—®: http://{{ (index .Values.ingress.hosts 0).host }}
{{- else }}
  å†…éƒ¨è®¿é—®: kubectl port-forward svc/{{ include "myapp.fullname" . }} {{ .Values.service.port }}:{{ .Values.service.port }}
  ç„¶åè®¿é—®: http://localhost:{{ .Values.service.port }}
{{- end }}

ğŸ“Š æŸ¥çœ‹çŠ¶æ€:
  kubectl get pods -l app={{ .Chart.Name }}
  kubectl get svc {{ include "myapp.fullname" . }}

ğŸ”§ å¸¸ç”¨å‘½ä»¤:
  å‡çº§: helm upgrade {{ .Release.Name }} .
  åˆ é™¤: helm uninstall {{ .Release.Name }}
  çŠ¶æ€: helm status {{ .Release.Name }}
```

---

## 4. ğŸ—ï¸ å¤šç¯å¢ƒé…ç½®ç®¡ç†


### 4.1 ç¯å¢ƒé…ç½®æ–‡ä»¶æ¦‚å¿µ


**ä¸ºä»€ä¹ˆéœ€è¦å¤šç¯å¢ƒé…ç½®**ï¼š
```
å¼€å‘ç¯å¢ƒ: 1ä¸ªå‰¯æœ¬ï¼Œå°èµ„æºï¼Œå¼€å¯è°ƒè¯•
æµ‹è¯•ç¯å¢ƒ: 2ä¸ªå‰¯æœ¬ï¼Œä¸­ç­‰èµ„æºï¼Œå¯ç”¨ç›‘æ§  
ç”Ÿäº§ç¯å¢ƒ: 5ä¸ªå‰¯æœ¬ï¼Œå¤§èµ„æºï¼Œé«˜å¯ç”¨é…ç½®

ä¸åŒç¯å¢ƒéœ€æ±‚ä¸åŒï¼Œä½†åº”ç”¨æ ¸å¿ƒé€»è¾‘ç›¸åŒ
```

### 4.2 values-dev.yaml - å¼€å‘ç¯å¢ƒé…ç½®


```yaml
# values-dev.yaml - å¼€å‘ç¯å¢ƒä¸“ç”¨é…ç½®
# è¦†ç›–é»˜è®¤values.yamlä¸­çš„å€¼

replicaCount: 1                    # å¼€å‘ç¯å¢ƒåªéœ€1ä¸ªå‰¯æœ¬

image:
  tag: "dev-latest"                # ä½¿ç”¨å¼€å‘ç‰ˆé•œåƒ
  pullPolicy: Always               # æ¯æ¬¡éƒ½æ‹‰å–æœ€æ–°é•œåƒ

service:
  type: NodePort                   # å¼€å‘ç¯å¢ƒä½¿ç”¨NodePortä¾¿äºè®¿é—®
  port: 80
  nodePort: 30080                  # å›ºå®šç«¯å£ä¾¿äºè°ƒè¯•

# å¼€å‘ç¯å¢ƒèµ„æºé…ç½®
resources:
  limits:
    cpu: 200m                      # è¾ƒå°çš„CPUé™åˆ¶
    memory: 256Mi                  # è¾ƒå°çš„å†…å­˜é™åˆ¶
  requests:
    cpu: 100m
    memory: 128Mi

# å¼€å‘ç¯å¢ƒå˜é‡
env:
  - name: APP_ENV
    value: "development"           # å¼€å‘ç¯å¢ƒæ ‡è¯†
  - name: DEBUG
    value: "true"                  # å¯ç”¨è°ƒè¯•æ¨¡å¼
  - name: DATABASE_URL
    value: "mysql://dev-db:3306/myapp_dev"

# å¼€å‘ç¯å¢ƒé…ç½®
config:
  app.properties: |
    server.port=8080
    logging.level.root=DEBUG       # å¼€å‘ç¯å¢ƒè¯¦ç»†æ—¥å¿—
    spring.profiles.active=dev

# ç¦ç”¨ç”Ÿäº§ç¯å¢ƒåŠŸèƒ½
ingress:
  enabled: false                   # å¼€å‘ç¯å¢ƒä¸éœ€è¦Ingress

persistence:
  enabled: false                   # å¼€å‘ç¯å¢ƒä¸éœ€è¦æŒä¹…åŒ–
```

### 4.3 values-prod.yaml - ç”Ÿäº§ç¯å¢ƒé…ç½®


```yaml
# values-prod.yaml - ç”Ÿäº§ç¯å¢ƒé…ç½®
replicaCount: 3                    # ç”Ÿäº§ç¯å¢ƒå¤šå‰¯æœ¬

image:
  tag: "1.2.3"                     # ä½¿ç”¨ç¨³å®šç‰ˆæœ¬æ ‡ç­¾
  pullPolicy: IfNotPresent         # ç”Ÿäº§ç¯å¢ƒä¸é¢‘ç¹æ‹‰å–

service:
  type: ClusterIP                  # ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ClusterIP
  port: 80

# ç”Ÿäº§ç¯å¢ƒèµ„æºé…ç½®
resources:
  limits:
    cpu: 1000m                     # æ›´é«˜çš„èµ„æºé™åˆ¶
    memory: 1Gi
  requests:
    cpu: 500m
    memory: 512Mi

# ç”Ÿäº§ç¯å¢ƒå˜é‡
env:
  - name: APP_ENV
    value: "production"
  - name: DATABASE_URL
    valueFrom:                     # ä»Secretè·å–æ•°æ®åº“è¿æ¥
      secretKeyRef:
        name: db-secret
        key: database-url

# å¯ç”¨Ingress
ingress:
  enabled: true
  className: "nginx"
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
  hosts:
    - host: myapp.company.com
      paths:
        - path: /
          pathType: Prefix
  tls:                             # HTTPSé…ç½®
    - secretName: myapp-tls
      hosts:
        - myapp.company.com

# å¯ç”¨æŒä¹…åŒ–å­˜å‚¨
persistence:
  enabled: true
  storageClass: "ssd"              # ä½¿ç”¨SSDå­˜å‚¨ç±»
  size: 20Gi

# ç”Ÿäº§ç¯å¢ƒå®‰å…¨é…ç½®
securityContext:
  runAsNonRoot: true
  runAsUser: 1000
  fsGroup: 2000

# å¥åº·æ£€æŸ¥
livenessProbe:
  httpGet:
    path: /health
    port: 8080
  initialDelaySeconds: 30
  periodSeconds: 10

readinessProbe:
  httpGet:
    path: /ready  
    port: 8080
  initialDelaySeconds: 5
  periodSeconds: 5
```

### 4.4 å¤šç¯å¢ƒéƒ¨ç½²å‘½ä»¤


```bash
# å¼€å‘ç¯å¢ƒéƒ¨ç½²
helm install my-app-dev ./my-chart \
  -f values-dev.yaml \
  --namespace dev \
  --create-namespace

# ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²  
helm install my-app-prod ./my-chart \
  -f values-prod.yaml \
  --namespace production \
  --create-namespace

# ä¹Ÿå¯ä»¥ç»„åˆå¤šä¸ªé…ç½®æ–‡ä»¶
helm install my-app ./my-chart \
  -f values.yaml \
  -f values-prod.yaml \
  -f values-custom.yaml
```

---

## 5. ğŸ”— ä¾èµ–ä¸é’©å­é…ç½®


### 5.1 Chart.lock - ä¾èµ–é”æ–‡ä»¶


**ä½œç”¨**ï¼šé”å®šå…·ä½“çš„ä¾èµ–ç‰ˆæœ¬ï¼Œç¡®ä¿éƒ¨ç½²ä¸€è‡´æ€§

```yaml
# Chart.lock - è‡ªåŠ¨ç”Ÿæˆçš„ä¾èµ–é”æ–‡ä»¶
dependencies:
- name: mysql
  repository: https://charts.bitnami.com/bitnami
  version: 9.4.6                  # é”å®šçš„å…·ä½“ç‰ˆæœ¬
- name: redis  
  repository: https://charts.bitnami.com/bitnami
  version: 17.3.7

digest: sha256:f9b67b72bf9b0e3c7e1a4b5c4d2a1b0f8g9h6j5k4l3m2n1o0p9q8r7s6t5u4v3w2x1
generated: "2024-01-20T10:30:00.123456789Z"
```

**ä¾èµ–ç®¡ç†å‘½ä»¤**ï¼š
```bash
# æ›´æ–°ä¾èµ–
helm dependency update

# æ„å»ºä¾èµ–  
helm dependency build

# æŸ¥çœ‹ä¾èµ–çŠ¶æ€
helm dependency list
```

### 5.2 hooks - é’©å­é…ç½®


**ä½œç”¨**ï¼šåœ¨ç‰¹å®šæ—¶æœºæ‰§è¡Œé¢å¤–çš„æ“ä½œï¼Œæ¯”å¦‚æ•°æ®åº“åˆå§‹åŒ–ã€å¤‡ä»½ç­‰

**å¸¸è§é’©å­ç±»å‹**ï¼š
- `pre-install`: å®‰è£…å‰æ‰§è¡Œ
- `post-install`: å®‰è£…åæ‰§è¡Œ  
- `pre-upgrade`: å‡çº§å‰æ‰§è¡Œ
- `post-upgrade`: å‡çº§åæ‰§è¡Œ
- `pre-delete`: åˆ é™¤å‰æ‰§è¡Œ

```yaml
# templates/hooks/db-init.yaml - æ•°æ®åº“åˆå§‹åŒ–é’©å­
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Chart.Name }}-db-init
  annotations:
    "helm.sh/hook": post-install           # å®‰è£…åæ‰§è¡Œ
    "helm.sh/hook-weight": "1"             # æ‰§è¡Œé¡ºåº
    "helm.sh/hook-delete-policy": hook-succeeded  # æˆåŠŸååˆ é™¤
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: db-init
        image: mysql:8.0
        command:
          - /bin/bash
          - -c
          - |
            echo "åˆå§‹åŒ–æ•°æ®åº“..."
            mysql -h {{ .Values.mysql.host }} -u root -p$MYSQL_ROOT_PASSWORD << 'EOF'
            CREATE DATABASE IF NOT EXISTS myapp;
            USE myapp;
            CREATE TABLE IF NOT EXISTS users (
              id INT AUTO_INCREMENT PRIMARY KEY,
              username VARCHAR(50) NOT NULL,
              email VARCHAR(100) NOT NULL
            );
            EOF
            echo "æ•°æ®åº“åˆå§‹åŒ–å®Œæˆï¼"
        env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-secret
              key: mysql-root-password
```

### 5.3 tests - æµ‹è¯•é…ç½®


**ä½œç”¨**ï¼šå®šä¹‰Chartçš„æµ‹è¯•ç”¨ä¾‹ï¼ŒéªŒè¯éƒ¨ç½²æ˜¯å¦æˆåŠŸ

```yaml
# templates/tests/app-test.yaml
apiVersion: v1
kind: Pod
metadata:
  name: "{{ .Chart.Name }}-test"
  annotations:
    "helm.sh/hook": test             # æ ‡è®°ä¸ºæµ‹è¯•é’©å­
spec:
  restartPolicy: Never
  containers:
  - name: test
    image: curlimages/curl:latest
    command:
      - /bin/sh
      - -c
      - |
        echo "å¼€å§‹æµ‹è¯•åº”ç”¨è¿æ¥..."
        
        # æµ‹è¯•æœåŠ¡æ˜¯å¦å¯è®¿é—®
        if curl -f http://{{ include "myapp.fullname" . }}:{{ .Values.service.port }}/health; then
          echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
        else
          echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥"
          exit 1
        fi
        
        # æµ‹è¯•APIæ¥å£
        if curl -f http://{{ include "myapp.fullname" . }}:{{ .Values.service.port }}/api/version; then
          echo "âœ… APIæ¥å£æ­£å¸¸"
        else
          echo "âŒ APIæ¥å£å¼‚å¸¸"
          exit 1
        fi
        
        echo "ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼"
```

**è¿è¡Œæµ‹è¯•**ï¼š
```bash
# è¿è¡ŒChartæµ‹è¯•
helm test my-app

# æŸ¥çœ‹æµ‹è¯•æ—¥å¿—
kubectl logs my-app-test
```

---

## 6. ğŸ’¼ å®æˆ˜é…ç½®ç¤ºä¾‹


### 6.1 å®Œæ•´çš„Webåº”ç”¨Chart


**é¡¹ç›®ç»“æ„**ï¼š
```
nginx-chart/
â”œâ”€â”€ Chart.yaml
â”œâ”€â”€ values.yaml  
â”œâ”€â”€ values-prod.yaml
â”œâ”€â”€ .helmignore
â”œâ”€â”€ templates/
â”‚   â”œâ”€â”€ deployment.yaml
â”‚   â”œâ”€â”€ service.yaml
â”‚   â”œâ”€â”€ configmap.yaml
â”‚   â”œâ”€â”€ _helpers.tpl
â”‚   â”œâ”€â”€ NOTES.txt
â”‚   â””â”€â”€ tests/
â”‚       â””â”€â”€ connection-test.yaml
â””â”€â”€ crds/
    â””â”€â”€ custom-resource.yaml
```

**å®é™…çš„éƒ¨ç½²æ¨¡æ¿**ï¼š

```yaml
# templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "nginx.fullname" . }}-config
  labels:
    {{- include "nginx.labels" . | nindent 4 }}
data:
  nginx.conf: |
    server {
        listen {{ .Values.service.targetPort }};
        server_name _;
        
        location / {
            root /usr/share/nginx/html;
            index index.html index.htm;
            try_files $uri $uri/ /index.html;
        }
        
        location /api/ {
            proxy_pass {{ .Values.backend.url }};
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
        
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }
  index.html: |
    <!DOCTYPE html>
    <html>
    <head>
        <title>{{ .Chart.Name }} - {{ .Values.env }}</title>
    </head>
    <body>
        <h1>æ¬¢è¿ä½¿ç”¨ {{ .Chart.Name }}</h1>
        <p>å½“å‰ç¯å¢ƒ: {{ .Values.env }}</p>
        <p>ç‰ˆæœ¬: {{ .Chart.AppVersion }}</p>
    </body>
    </html>
```

### 6.2 crds - è‡ªå®šä¹‰èµ„æºå®šä¹‰


**ä½œç”¨**ï¼šå®šä¹‰è‡ªå®šä¹‰çš„Kubernetesèµ„æºç±»å‹

```yaml
# crds/webapp-crd.yaml
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: webapps.example.com
spec:
  group: example.com
  versions:
  - name: v1
    served: true
    storage: true
    schema:
      openAPIV3Schema:
        type: object
        properties:
          spec:
            type: object
            properties:
              replicas:
                type: integer
                minimum: 1
                maximum: 10
              image:
                type: string
              port:
                type: integer
                minimum: 1
                maximum: 65535
          status:
            type: object
  scope: Namespaced
  names:
    plural: webapps
    singular: webapp
    kind: WebApp
```

### 6.3 å®ç”¨çš„éƒ¨ç½²è„šæœ¬


```bash
#!/bin/bash
# deploy.sh - éƒ¨ç½²è„šæœ¬

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

CHART_NAME="nginx-chart"
RELEASE_NAME="my-nginx"
NAMESPACE="default"
ENV="dev"

# è§£æå‘½ä»¤è¡Œå‚æ•°
while [[ $# -gt 0 ]]; do
  case $1 in
    --env)
      ENV="$2"
      shift 2
      ;;
    --namespace)
      NAMESPACE="$2"
      shift 2
      ;;
    *)
      echo "æœªçŸ¥å‚æ•°: $1"
      exit 1
      ;;
  esac
done

echo "ğŸš€ å¼€å§‹éƒ¨ç½² $RELEASE_NAME åˆ° $ENV ç¯å¢ƒ..."

# æ£€æŸ¥Chartè¯­æ³•
echo "ğŸ“‹ æ£€æŸ¥Charté…ç½®..."
helm lint $CHART_NAME

# æ¨¡æ‹Ÿéƒ¨ç½²ï¼ˆdry-runï¼‰
echo "ğŸ” æ¨¡æ‹Ÿéƒ¨ç½²æ£€æŸ¥..."
helm install $RELEASE_NAME $CHART_NAME \
  -f values-$ENV.yaml \
  --namespace $NAMESPACE \
  --dry-run --debug

# å®é™…éƒ¨ç½²
echo "âš¡ æ‰§è¡Œå®é™…éƒ¨ç½²..."
helm install $RELEASE_NAME $CHART_NAME \
  -f values-$ENV.yaml \
  --namespace $NAMESPACE \
  --create-namespace \
  --wait --timeout=300s

# è¿è¡Œæµ‹è¯•
echo "ğŸ§ª è¿è¡Œéƒ¨ç½²æµ‹è¯•..."
helm test $RELEASE_NAME --namespace $NAMESPACE

echo "âœ… éƒ¨ç½²å®Œæˆï¼"
echo "ğŸ“Š æŸ¥çœ‹çŠ¶æ€: kubectl get pods -n $NAMESPACE"
echo "ğŸŒ è®¿é—®åº”ç”¨: kubectl port-forward svc/$RELEASE_NAME 8080:80 -n $NAMESPACE"
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Helmæœ¬è´¨ï¼šKubernetesçš„åº”ç”¨åŒ…ç®¡ç†å™¨ï¼Œç®€åŒ–å¤æ‚åº”ç”¨éƒ¨ç½²
ğŸ”¸ Chartç»“æ„ï¼šé…ç½®æ–‡ä»¶ + æ¨¡æ¿æ–‡ä»¶ + è¯´æ˜æ–‡æ¡£çš„å®Œæ•´æ‰“åŒ…
ğŸ”¸ å¤šç¯å¢ƒç®¡ç†ï¼šä¸€å¥—æ¨¡æ¿é€‚é…å¼€å‘/æµ‹è¯•/ç”Ÿäº§å¤šç§ç¯å¢ƒ
ğŸ”¸ æ¨¡æ¿ç³»ç»Ÿï¼šé€šè¿‡å˜é‡å’Œå‡½æ•°å®ç°é…ç½®çš„åŠ¨æ€åŒ–
ğŸ”¸ ä¾èµ–ç®¡ç†ï¼šè‡ªåŠ¨å¤„ç†åº”ç”¨é—´çš„ä¾èµ–å…³ç³»å’Œç‰ˆæœ¬æ§åˆ¶
```

### 7.2 å…³é”®æ–‡ä»¶ä½œç”¨ç†è§£


| æ–‡ä»¶å | **æ ¸å¿ƒä½œç”¨** | **ç±»æ¯”ç†è§£** | **æ˜¯å¦å¿…éœ€** |
|--------|------------|-------------|-------------|
| `Chart.yaml` | `ChartåŸºæœ¬ä¿¡æ¯` | `è½¯ä»¶çš„èº«ä»½è¯` | âœ… **å¿…éœ€** |
| `values.yaml` | `é»˜è®¤é…ç½®å€¼` | `å‡ºå‚é»˜è®¤è®¾ç½®` | âœ… **å¿…éœ€** |
| `values-env.yaml` | `ç¯å¢ƒç‰¹å®šé…ç½®` | `ä¸åŒåœºæ™¯çš„è®¾ç½®` | ğŸ“ **æ¨è** |
| `_helpers.tpl` | `å¯é‡ç”¨æ¨¡æ¿` | `å…¬å…±ä»£ç åº“` | ğŸ“ **æ¨è** |
| `NOTES.txt` | `ä½¿ç”¨è¯´æ˜` | `è½¯ä»¶ä½¿ç”¨æ‰‹å†Œ` | ğŸ“ **æ¨è** |
| `.helmignore` | `å¿½ç•¥æ–‡ä»¶åˆ—è¡¨` | `.gitignoreæ–‡ä»¶` | ğŸ“ **å¯é€‰** |

### 7.3 å®é™…åº”ç”¨æœ€ä½³å®è·µ


**ğŸ”¹ Chartè®¾è®¡åŸåˆ™**
```
ç®€å•æ€§ï¼šé…ç½®æ–‡ä»¶ç®€æ´æ˜äº†ï¼Œä¸è¿‡åº¦å¤æ‚åŒ–
çµæ´»æ€§ï¼šé€šè¿‡valuesæ–‡ä»¶æ”¯æŒå¤šç¯å¢ƒéƒ¨ç½²
å¯ç»´æŠ¤æ€§ï¼šä½¿ç”¨_helpers.tplé¿å…é‡å¤ä»£ç 
å¯æµ‹è¯•æ€§ï¼šç¼–å†™æµ‹è¯•ç”¨ä¾‹éªŒè¯éƒ¨ç½²æ•ˆæœ
```

**ğŸ”¹ å¤šç¯å¢ƒç®¡ç†ç­–ç•¥**
```
å¼€å‘ç¯å¢ƒï¼š
- å•å‰¯æœ¬ï¼Œå°èµ„æºé…ç½®
- å¯ç”¨è°ƒè¯•æ¨¡å¼ï¼Œè¯¦ç»†æ—¥å¿—
- ä½¿ç”¨NodePortä¾¿äºæœ¬åœ°è®¿é—®

ç”Ÿäº§ç¯å¢ƒï¼š
- å¤šå‰¯æœ¬ï¼Œé«˜å¯ç”¨é…ç½®
- å¯ç”¨Ingresså’ŒHTTPS
- ä¸¥æ ¼çš„èµ„æºé™åˆ¶å’Œå®‰å…¨ç­–ç•¥
```

**ğŸ”¹ å¸¸è§ä½¿ç”¨åœºæ™¯**
- **å¾®æœåŠ¡éƒ¨ç½²**ï¼šæ¯ä¸ªæœåŠ¡ä¸€ä¸ªChartï¼Œç»Ÿä¸€ç®¡ç†
- **ç¯å¢ƒè¿ç§»**ï¼šå¼€å‘å®Œæˆåå¿«é€Ÿéƒ¨ç½²åˆ°æµ‹è¯•/ç”Ÿäº§ç¯å¢ƒ  
- **ç‰ˆæœ¬å›æ»š**ï¼šå‡ºç°é—®é¢˜æ—¶å¿«é€Ÿå›æ»šåˆ°ç¨³å®šç‰ˆæœ¬
- **é…ç½®ç®¡ç†**ï¼šé›†ä¸­ç®¡ç†åº”ç”¨çš„æ‰€æœ‰é…ç½®ä¿¡æ¯

### 7.4 å­¦ä¹ è¿›é˜¶è·¯å¾„


- [x] **åŸºç¡€ç†è§£**ï¼šæŒæ¡HelmåŸºæœ¬æ¦‚å¿µå’ŒChartç»“æ„
- [x] **é…ç½®æ–‡ä»¶**ï¼šç†Ÿç»ƒç¼–å†™å„ç§é…ç½®æ–‡ä»¶å’Œæ¨¡æ¿
- [ ] **è¿›é˜¶ç‰¹æ€§**ï¼šå­¦ä¹ é’©å­ã€æµ‹è¯•ã€è‡ªå®šä¹‰èµ„æº
- [ ] **æœ€ä½³å®è·µ**ï¼šæŒæ¡ä¼ä¸šçº§Helmä½¿ç”¨è§„èŒƒ
- [ ] **è¿ç»´é›†æˆ**ï¼šä¸CI/CDæµæ°´çº¿é›†æˆè‡ªåŠ¨åŒ–éƒ¨ç½²

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- Helmè®©å¤æ‚çš„K8såº”ç”¨éƒ¨ç½²å˜å¾—ç®€å•
- Chart = é…ç½® + æ¨¡æ¿ + æ–‡æ¡£çš„åº”ç”¨æ‰“åŒ…
- valuesæ–‡ä»¶å®ç°ä¸€å¥—ä»£ç å¤šç¯å¢ƒéƒ¨ç½²
- æ¨¡æ¿ç³»ç»Ÿæä¾›å¼ºå¤§çš„é…ç½®åŠ¨æ€åŒ–èƒ½åŠ›