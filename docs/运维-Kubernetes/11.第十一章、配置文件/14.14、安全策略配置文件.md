---
title: 14、安全策略配置文件
---
## 📚 目录

1. [Kubernetes安全基础概念](#1-Kubernetes安全基础概念)
2. [Pod安全策略配置](#2-Pod安全策略配置)
3. [网络安全策略配置](#3-网络安全策略配置)
4. [准入控制器配置](#4-准入控制器配置)
5. [运行时安全工具配置](#5-运行时安全工具配置)
6. [系统级安全配置](#6-系统级安全配置)
7. [实战配置示例](#7-实战配置示例)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🛡️ Kubernetes安全基础概念


### 1.1 什么是Kubernetes安全配置


**通俗解释**：就像给你的房子装防盗门、监控摄像头一样，Kubernetes安全配置就是给你的容器集群装"安全设备"，防止坏人进来搞破坏。

```
传统服务器安全：
物理服务器 → 防火墙 → 操作系统权限 → 应用程序

Kubernetes安全：
集群网络 → 节点安全 → Pod安全策略 → 容器运行时安全
     ↓         ↓          ↓             ↓
   防火墙    主机防护   容器权限控制   应用程序安全
```

### 1.2 为什么需要安全配置


**现实问题**：
- 🔥 **权限滥用**：容器获得过高权限，可能危害整个系统
- 🌐 **网络攻击**：恶意流量在集群内部传播
- 📦 **恶意镜像**：不安全的容器镜像被部署
- 🔓 **数据泄露**：敏感信息被非法访问

**安全配置的作用**：
```
✅ 限制容器权限 - 就像给每个房客分配不同的钥匙
✅ 控制网络流量 - 就像小区门禁系统
✅ 检查镜像安全 - 就像安检系统
✅ 监控异常行为 - 就像监控摄像头
```

---

## 2. 🔐 Pod安全策略配置


### 2.1 PodSecurityPolicy 基本概念


> 💡 **核心概念**：PodSecurityPolicy（PSP）就像是给每个Pod制定的"行为准则"
> 
> 简单理解：就像学校给学生制定校规一样，PSP给Pod制定运行规则

**PSP的作用**：
- 🚫 **限制特权模式**：防止容器获得过高权限
- 👤 **控制运行用户**：指定容器以什么身份运行
- 📁 **文件系统控制**：限制对系统文件的修改
- 🔒 **安全上下文**：配置各种安全参数

### 2.2 特权模式控制（privileged）


**什么是特权模式**：
- 普通模式：容器就像普通用户，只能做被允许的事
- 特权模式：容器就像管理员，几乎什么都能做

**配置示例**：
```yaml
# 基础的Pod安全策略
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: basic-security-policy
spec:
  # 🚫 禁止特权模式
  privileged: false
  
  # ✅ 允许的安全配置
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: true
  
  # 👤 运行用户控制
  runAsUser:
    rule: 'MustRunAsNonRoot'
  
  # 📁 卷类型限制
  volumes:
    - 'configMap'
    - 'emptyDir'
    - 'projected'
    - 'secret'
```

### 2.3 权限提升控制（allowPrivilegeEscalation）


**通俗解释**：就像防止普通员工偷偷获得管理员权限

| 配置项 | **含义** | **风险等级** | **建议设置** |
|--------|----------|-------------|-------------|
| `true` | `允许权限提升` | `🔴 高风险` | `❌ 不推荐` |
| `false` | `禁止权限提升` | `🟢 安全` | `✅ 推荐` |

### 2.4 只读根文件系统（readOnlyRootFilesystem）


**实际意义**：
- **开启**：容器不能修改系统文件，就像只读U盘
- **关闭**：容器可以随意修改文件，存在安全隐患

```yaml
spec:
  # 🔒 强制只读根文件系统
  readOnlyRootFilesystem: true
  
  # 📝 如果应用需要写入，使用临时卷
  containers:
  - name: app
    image: nginx
    volumeMounts:
    - name: tmp-volume
      mountPath: /tmp
  volumes:
  - name: tmp-volume
    emptyDir: {}
```

---

## 3. 🌐 网络安全策略配置


### 3.1 NetworkPolicy 网络策略


> 🔍 **核心理解**：NetworkPolicy就像小区的门禁系统
> 
> - 可以控制哪些人能进来（Ingress）
> - 可以控制居民能去哪里（Egress）

### 3.2 网络隔离基础配置


```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: web-app-network-policy
  namespace: production
spec:
  # 🎯 作用于哪些Pod
  podSelector:
    matchLabels:
      app: web-app
  
  # 📥 入站规则：谁能访问我
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: frontend
    ports:
    - protocol: TCP
      port: 8080
  
  # 📤 出站规则：我能访问谁  
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: database
    ports:
    - protocol: TCP
      port: 3306
```

**规则解释**：
- 🎯 只有来自`frontend`命名空间的Pod能访问8080端口
- 🎯 只能访问`database`命名空间的3306端口
- 🚫 其他所有网络连接都被禁止

### 3.3 常见网络策略模式


**完全隔离模式**：
```yaml
# 🔒 拒绝所有流量的"默认拒绝"策略
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: deny-all
spec:
  podSelector: {}  # 匹配所有Pod
  policyTypes:
  - Ingress
  - Egress
```

**选择性开放模式**：
```yaml
# ✅ 只允许特定服务间通信
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-specific
spec:
  podSelector:
    matchLabels:
      tier: backend
  ingress:
  - from:
    - podSelector:
        matchLabels:
          tier: frontend
```

---

## 4. 🚪 准入控制器配置


### 4.1 什么是准入控制器（admission-controllers）


**通俗比喻**：就像机场安检，每个要"登机"（部署）的Pod都要先通过安检

```
Pod创建流程：
开发者提交 → API Server → 认证 → 授权 → 准入控制 → 创建Pod
    ↓           ↓         ↓      ↓       ↓          ↓
  kubectl    接收请求   身份验证  权限检查  安全检查   实际部署
```

### 4.2 核心准入控制器


| 控制器名称 | **作用** | **重要程度** | **推荐启用** |
|-----------|----------|-------------|-------------|
| `PodSecurityPolicy` | `Pod安全策略检查` | `⭐⭐⭐` | `✅ 必需` |
| `ResourceQuota` | `资源配额限制` | `⭐⭐⭐` | `✅ 必需` |
| `LimitRanger` | `资源限制范围` | `⭐⭐` | `✅ 推荐` |
| `AlwaysPullImages` | `强制拉取镜像` | `⭐⭐` | `✅ 推荐` |

### 4.3 准入控制器配置


```yaml
# kube-apiserver 启动参数配置
apiVersion: v1
kind: Pod
metadata:
  name: kube-apiserver
spec:
  containers:
  - command:
    - kube-apiserver
    # 🔧 启用准入控制器
    - --enable-admission-plugins=NodeRestriction,ResourceQuota,PodSecurityPolicy,LimitRanger,AlwaysPullImages
    # 🚫 禁用危险的控制器
    - --disable-admission-plugins=AlwaysAdmit
```

---

## 5. 🛠️ 运行时安全工具配置


### 5.1 OPA（Open Policy Agent）配置


**什么是OPA**：就像一个"智能保安"，根据你制定的规则自动做决策

> 🎯 **OPA的作用**：
> - 统一的策略管理平台
> - 支持复杂的策略规则
> - 实时决策和审计

**基础OPA配置**：
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: opa-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: opa
  template:
    metadata:
      labels:
        app: opa
    spec:
      containers:
      - name: opa
        image: openpolicyagent/opa:latest
        args:
          - "run"
          - "--server"
          - "--config-file=/config/config.yaml"
        ports:
        - containerPort: 8181
```

### 5.2 Falco 运行时安全配置


**Falco是什么**：就像给你的集群装了个"24小时监控摄像头"，发现可疑行为立即报警

```yaml
# Falco DaemonSet 配置
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: falco
spec:
  selector:
    matchLabels:
      app: falco
  template:
    metadata:
      labels:
        app: falco
    spec:
      containers:
      - name: falco
        image: falcosecurity/falco:latest
        # 🔍 监控系统调用
        securityContext:
          privileged: true
        volumeMounts:
        - mountPath: /host/proc
          name: proc-fs
          readOnly: true
        - mountPath: /host/etc
          name: etc-fs
          readOnly: true
```

### 5.3 容器安全平台对比


```
安全工具特点对比：

🔧 Falco（开源）:
优势: 免费、社区活跃、规则灵活
适用: 中小型项目、开发测试环境

💼 Twistlock（商业）:
优势: 功能全面、企业支持、界面友好  
适用: 大型企业、生产环境

🌊 Aqua（商业）:
优势: 全生命周期安全、合规支持
适用: 金融、医疗等高合规要求行业
```

---

## 6. ⚙️ 系统级安全配置


### 6.1 SELinux 配置


**什么是SELinux**：就像给每个程序戴上"身份标签"，严格控制它们能做什么

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: selinux-pod
spec:
  # 🏷️ SELinux 标签配置
  securityContext:
    seLinuxOptions:
      level: "s0:c123,c456"  # 安全级别
      role: "object_r"        # 角色
      type: "container_t"     # 类型
      user: "system_u"        # 用户
  containers:
  - name: app
    image: nginx
```

**SELinux 模式**：
- `enforcing`：强制模式，违规直接阻止 🔴
- `permissive`：宽松模式，违规记录但允许 🟡  
- `disabled`：禁用模式，不进行检查 🔴

### 6.2 AppArmor 配置


**AppArmor vs SELinux**：
- **AppArmor**：像"白名单"，只能做列表上的事
- **SELinux**：像"多重身份验证"，基于标签和规则

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: apparmor-pod
  annotations:
    # 🛡️ 指定AppArmor配置文件
    container.apparmor.security.beta.kubernetes.io/app: localhost/k8s-apparmor-example
spec:
  containers:
  - name: app
    image: nginx
```

### 6.3 Seccomp 安全配置


**Seccomp是什么**：就像给程序安装"行为监控器"，限制它能调用的系统功能

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: seccomp-pod
spec:
  # 🔒 Seccomp 配置
  securityContext:
    seccompProfile:
      type: Localhost
      localhostProfile: profiles/audit.json
  containers:
  - name: app
    image: nginx
```

**Seccomp 配置文件示例**：
```json
{
  "defaultAction": "SCMP_ACT_ERRNO",
  "architectures": ["SCMP_ARCH_X86_64"],
  "syscalls": [
    {
      "names": ["read", "write", "open", "close"],
      "action": "SCMP_ACT_ALLOW"
    }
  ]
}
```

---

## 7. 🎯 实战配置示例


### 7.1 生产级安全Pod配置


```yaml
apiVersion: v1
kind: Pod
metadata:
  name: secure-web-app
  labels:
    app: web-app
    tier: frontend
spec:
  # 🔐 Pod级别安全配置
  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
    runAsGroup: 3000
    fsGroup: 2000
    seccompProfile:
      type: RuntimeDefault
  
  containers:
  - name: web-app
    image: nginx:1.20-alpine
    
    # 🛡️ 容器级别安全配置
    securityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
      runAsNonRoot: true
      runAsUser: 1000
      capabilities:
        drop:
        - ALL
        add:
        - NET_BIND_SERVICE
    
    # 📊 资源限制
    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 100m
        memory: 128Mi
    
    # 📁 只读根文件系统 + 临时卷
    volumeMounts:
    - name: tmp-volume
      mountPath: /tmp
    - name: var-cache-nginx
      mountPath: /var/cache/nginx
    
  volumes:
  - name: tmp-volume
    emptyDir: {}
  - name: var-cache-nginx
    emptyDir: {}
```

### 7.2 完整的安全策略组合


```yaml
# 1️⃣ Pod安全策略
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: production-psp
spec:
  privileged: false
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: true
  
  runAsUser:
    rule: 'MustRunAsNonRoot'
  
  supplementalGroups:
    rule: 'RunAsAny'
  
  volumes:
  - 'configMap'
  - 'emptyDir'
  - 'projected'
  - 'secret'
  - 'downwardAPI'
  - 'persistentVolumeClaim'

---
# 2️⃣ 网络策略
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: production-network-policy
spec:
  podSelector:
    matchLabels:
      tier: frontend
  
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    ports:
    - protocol: TCP
      port: 8080
  
  egress:
  - to:
    - podSelector:
        matchLabels:
          tier: backend
    ports:
    - protocol: TCP
      port: 3000

---
# 3️⃣ 资源配额
apiVersion: v1
kind: ResourceQuota
metadata:
  name: production-quota
spec:
  hard:
    requests.cpu: "4"
    requests.memory: 8Gi
    limits.cpu: "8"
    limits.memory: 16Gi
    pods: "10"
```

### 7.3 安全检查清单


> ✅ **部署前安全检查清单**
>
> **基础安全**：
> - [ ] 禁用特权模式（privileged: false）
> - [ ] 禁止权限提升（allowPrivilegeEscalation: false）
> - [ ] 启用只读根文件系统（readOnlyRootFilesystem: true）
> - [ ] 非root用户运行（runAsNonRoot: true）
>
> **网络安全**：
> - [ ] 配置网络策略（NetworkPolicy）
> - [ ] 限制入站流量（Ingress规则）
> - [ ] 限制出站流量（Egress规则）
>
> **资源控制**：
> - [ ] 设置CPU/内存限制（resources.limits）
> - [ ] 设置资源请求（resources.requests）
> - [ ] 配置资源配额（ResourceQuota）
>
> **监控安全**：
> - [ ] 部署安全监控工具（Falco/OPA）
> - [ ] 配置安全告警规则
> - [ ] 设置日志审计

---

## 8. 📋 核心要点总结


### 8.1 安全配置核心原则


```
🔐 最小权限原则：只给必需的权限，多余的一概不给
🚫 默认拒绝原则：先禁止所有，再按需开放
🔍 深度防御原则：多层安全机制，一层失效其他层兜底
📊 持续监控原则：实时监控异常，快速响应处理
```

### 8.2 必须掌握的核心配置


**Pod安全策略**：
- `privileged: false` - 🚫 禁用特权模式
- `allowPrivilegeEscalation: false` - 🚫 禁止权限提升
- `readOnlyRootFilesystem: true` - 🔒 只读根文件系统
- `runAsNonRoot: true` - 👤 非root用户运行

**网络策略**：
- **NetworkPolicy** - 🌐 控制Pod间网络流量
- **Ingress规则** - 📥 控制入站连接
- **Egress规则** - 📤 控制出站连接

**监控工具**：
- **Falco** - 🔍 运行时异常检测
- **OPA** - 🎯 策略管理和决策
- **准入控制器** - 🚪 部署时安全检查

### 8.3 新手学习路径


**第一阶段：基础安全** ⭐
1. 理解Pod安全上下文概念
2. 掌握基本的安全配置参数
3. 练习禁用特权模式和权限提升

**第二阶段：网络安全** ⭐⭐
1. 学习NetworkPolicy基本语法
2. 实践简单的网络隔离场景
3. 理解Ingress和Egress规则

**第三阶段：高级安全** ⭐⭐⭐
1. 掌握准入控制器配置
2. 学习OPA或Falco的使用
3. 整合完整的安全策略

### 8.4 常见问题和解决方案


**问题1：Pod启动失败，提示权限不足**
```
解决方案：
1. 检查是否设置了runAsNonRoot但没有指定用户ID
2. 确认镜像是否支持非root用户运行
3. 检查挂载的卷权限是否正确
```

**问题2：网络策略配置后Pod无法通信**
```
解决方案：
1. 确认podSelector标签匹配正确
2. 检查端口和协议配置
3. 验证命名空间选择器
```

**问题3：安全工具占用过多资源**
```
解决方案：
1. 合理设置资源限制
2. 调整监控规则减少误报
3. 考虑只在生产环境启用全量监控
```

**实用记忆口诀**：
- 权限最小化，特权要禁掉
- 网络要隔离，流量管控好
- 监控不能少，异常早发现
- 配置要规范，安全第一条