---
title: 9、网络插件配置文件
---
## 📚 目录

1. [网络插件基础概念](#1-网络插件基础概念)
2. [CNI配置核心目录](#2-CNI配置核心目录)
3. [CNI配置文件详解](#3-CNI配置文件详解)
4. [主流网络插件配置](#4-主流网络插件配置)
5. [实际部署配置案例](#5-实际部署配置案例)
6. [网络配置故障排查](#6-网络配置故障排查)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 🌐 网络插件基础概念


### 1.1 什么是网络插件


**🔸 白话解释**
网络插件就像是K8s集群的"网络管理员"，负责让集群中的Pod（容器组）之间能够相互通信。

```
简单比喻：
如果把K8s集群比作一个大楼，网络插件就是：
┌─────────────────────────────────────────┐
│         K8s集群大楼                      │
│  ┌─────┐  ┌─────┐  ┌─────┐  ┌─────┐     │
│  │Pod1 │  │Pod2 │  │Pod3 │  │Pod4 │     │
│  │办公室│  │办公室│  │办公室│  │办公室│     │
│  └──┬──┘  └──┬──┘  └──┬──┘  └──┬──┘     │
│     │       │       │       │         │
│  ┌──▼───────▼───────▼───────▼──────┐   │
│  │      网络插件（网络交换机）       │   │
│  │   负责Pod之间的通信连接          │   │
│  └─────────────────────────────────┘   │
└─────────────────────────────────────────┘
```

**🔸 核心作用**
- **Pod间通信**：让不同节点上的Pod能相互访问
- **服务发现**：为Service分配IP地址
- **网络策略**：控制Pod之间的访问权限
- **负载均衡**：分发网络流量

### 1.2 CNI是什么


**🔸 CNI全称**：Container Network Interface（容器网络接口）

**🔸 通俗理解**
CNI就是一套**标准规范**，规定了网络插件应该如何工作：

```
CNI标准化流程：
K8s创建Pod → 调用CNI插件 → 为Pod分配IP → 配置网络路由

就像：
订餐系统 → 调用配送接口 → 分配配送员 → 规划配送路线
```

**🔸 CNI的好处**
- **标准化**：不同厂商的插件都遵循同一套规范
- **可替换**：可以轻松更换网络插件
- **兼容性**：确保插件与K8s良好配合

### 1.3 网络插件的分类


| 插件类型 | **代表产品** | **适用场景** | **特点** |
|---------|------------|-------------|---------|
| 🌉 **覆盖网络** | `Flannel`、`Weave` | `简单集群` | `配置简单，性能一般` |
| 🚀 **路由网络** | `Calico`、`Cilium` | `大型集群` | `性能优秀，功能丰富` |
| 🏢 **企业级** | `Antrea`、`Contrail` | `生产环境` | `安全性高，管理完善` |

---

## 2. 📁 CNI配置核心目录


### 2.1 关键目录结构


**🔸 核心目录图解**
```
Kubernetes节点文件系统
│
├── /etc/cni/net.d/           ← CNI配置文件存放目录
│   ├── 10-flannel.conflist   ← Flannel网络配置
│   ├── 10-calico.conflist    ← Calico网络配置
│   └── 99-loopback.conf      ← 本地回环配置
│
├── /opt/cni/bin/             ← CNI插件可执行文件目录
│   ├── flannel               ← Flannel插件程序
│   ├── calico                ← Calico插件程序  
│   ├── bridge                ← 网桥插件
│   └── host-local            ← IP地址管理插件
│
└── /var/lib/cni/             ← CNI运行时数据目录
    └── networks/             ← 网络状态信息
```

### 2.2 配置文件目录详解


**🔸 /etc/cni/net.d/ 目录**

> 💡 **重要**：这是CNI的"大脑"，存放所有网络配置规则

**目录特点：**
- **按优先级排序**：文件名数字越小，优先级越高
- **JSON格式**：配置文件采用JSON格式
- **自动加载**：kubelet会自动读取此目录下的配置

```bash
# 查看CNI配置目录
ls -la /etc/cni/net.d/

# 典型输出：
# -rw-r--r-- 1 root root  10-flannel.conflist
# -rw-r--r-- 1 root root  99-loopback.conf
```

**🔸 /opt/cni/bin/ 目录**

> 💡 **理解**：这是CNI的"工具箱"，存放各种网络插件程序

**常见插件文件：**
- `bridge`：创建网桥连接
- `host-local`：分配IP地址
- `portmap`：端口映射
- `flannel`：Flannel网络插件
- `calico`：Calico网络插件

---

## 3. 📋 CNI配置文件详解


### 3.1 配置文件基本结构


**🔸 标准CNI配置格式**

```json
{
  "cniVersion": "0.3.1",          // CNI版本规范
  "name": "mynetwork",            // 网络名称
  "type": "bridge",               // 插件类型
  "bridge": "cni0",               // 网桥名称
  "subnet": "10.244.0.0/16",      // 子网范围
  "gateway": "10.244.0.1",        // 网关地址
  "dns": {                        // DNS配置
    "nameservers": ["8.8.8.8"]
  }
}
```

### 3.2 核心配置参数解释


**🔸 cniVersion（CNI版本）**

> 📖 **含义**：指定使用的CNI规范版本

```
常用版本：
├── 0.3.1  ← 稳定版本，广泛支持
├── 0.4.0  ← 增强版本，新特性
└── 1.0.0  ← 最新版本，推荐使用

选择原则：
✅ 生产环境：使用0.3.1（稳定可靠）
🚀 测试环境：可尝试1.0.0（新功能）
```

**🔸 name（网络名称）**

> 📖 **含义**：为网络配置起一个唯一的名字

```
命名建议：
✅ 好的命名：k8s-pod-network、cluster-network
❌ 差的命名：network1、test
```

**🔸 type（插件类型）**

> 📖 **含义**：指定使用哪个CNI插件程序

```
插件类型对应关系：
┌─────────────┬──────────────────┬─────────────────┐
│   type值    │    插件程序      │      作用       │
├─────────────┼──────────────────┼─────────────────┤
│   bridge    │  /opt/cni/bin/bridge  │  创建网桥  │
│   flannel   │  /opt/cni/bin/flannel │  Flannel网络│
│   calico    │  /opt/cni/bin/calico  │  Calico网络 │
│   host-local│  /opt/cni/bin/host-local│ IP地址管理│
└─────────────┴──────────────────┴─────────────────┘
```

### 3.3 网络参数配置


**🔸 subnet（子网配置）**

> 📖 **含义**：定义Pod可以使用的IP地址范围

```
子网配置示例：
├── "10.244.0.0/16"    ← 可用IP：10.244.0.1 - 10.244.255.254
├── "192.168.0.0/24"   ← 可用IP：192.168.0.1 - 192.168.0.254  
└── "172.16.0.0/12"    ← 可用IP：172.16.0.1 - 172.31.255.254

选择建议：
🎯 小集群：/24（254个IP）
🚀 大集群：/16（65534个IP）
```

**🔸 gateway（网关配置）**

> 📖 **含义**：指定网络的出入口地址，通常是子网的第一个IP

```
网关设置规则：
子网：10.244.1.0/24  → 网关：10.244.1.1
子网：192.168.1.0/24 → 网关：192.168.1.1

作用说明：
Pod发送数据 → 通过网关 → 到达其他网络
```

### 3.4 高级配置选项


**🔸 ipam（IP地址管理）**

> 📖 **含义**：控制如何为Pod分配IP地址

```json
{
  "ipam": {
    "type": "host-local",           // IP分配插件
    "subnet": "10.244.1.0/24",      // IP分配范围
    "rangeStart": "10.244.1.10",    // 起始IP
    "rangeEnd": "10.244.1.100",     // 结束IP
    "gateway": "10.244.1.1"         // 网关地址
  }
}
```

**🔸 routes（路由配置）**

> 📖 **含义**：定义数据包的转发路径

```json
{
  "routes": [
    {
      "dst": "0.0.0.0/0",           // 目标网络（所有网络）
      "gw": "10.244.1.1"            // 通过此网关转发
    }
  ]
}
```

---

## 4. 🚀 主流网络插件配置


### 4.1 Flannel网络插件


**🔸 Flannel简介**

> 💡 **特点**：最简单的K8s网络插件，适合入门学习

```
Flannel工作原理：
┌─────────────┐    ┌─────────────┐
│   Node1     │    │   Node2     │
│ ┌─────────┐ │    │ ┌─────────┐ │
│ │  Pod A  │ │    │ │  Pod B  │ │
│ │10.244.1.│ │    │ │10.244.2.│ │
│ └────┬────┘ │    │ └────┬────┘ │
│      │      │    │      │      │
│ ┌────▼────┐ │    │ ┌────▼────┐ │
│ │ flannel │ │    │ │ flannel │ │
│ └─────────┘ │    │ └─────────┘ │
└──────┬──────┘    └──────┬──────┘
       │                  │
       └────── 网络通信 ────┘
```

**🔸 Flannel配置文件**

```json
{
  "name": "cbr0",
  "cniVersion": "0.3.1",
  "plugins": [
    {
      "type": "flannel",
      "delegate": {
        "hairpinMode": true,
        "isDefaultGateway": true
      }
    },
    {
      "type": "portmap",
      "capabilities": {
        "portMappings": true
      }
    }
  ]
}
```

**🔸 配置参数解释**

- **`hairpinMode`**: 允许Pod访问自己的Service
- **`isDefaultGateway`**: 设为默认网关
- **`portmap`**: 支持端口映射功能

### 4.2 Calico网络插件


**🔸 Calico简介**

> 💡 **特点**：高性能网络插件，支持网络策略，适合生产环境

```
Calico vs Flannel对比：
┌───────────┬─────────┬─────────┐
│   特性    │ Flannel │ Calico  │
├───────────┼─────────┼─────────┤
│   性能    │   一般  │   优秀  │
│ 网络策略  │  不支持 │   支持  │
│ 配置复杂度│   简单  │  中等   │
│ 生产使用  │   较少  │   广泛  │
└───────────┴─────────┴─────────┘
```

**🔸 Calico配置文件**

```json
{
  "name": "k8s-pod-network",
  "cniVersion": "0.3.1", 
  "plugins": [
    {
      "type": "calico",
      "log_level": "info",
      "datastore_type": "kubernetes",
      "mtu": 1440,
      "ipam": {
        "type": "calico-ipam"
      },
      "policy": {
        "type": "k8s"
      }
    },
    {
      "type": "portmap",
      "snat": true,
      "capabilities": {"portMappings": true}
    }
  ]
}
```

**🔸 关键参数说明**

- **`datastore_type`**: 数据存储类型（kubernetes/etcd）
- **`mtu`**: 最大传输单元，影响网络性能
- **`calico-ipam`**: 使用Calico的IP地址管理
- **`policy`**: 启用Kubernetes网络策略

### 4.3 Weave网络插件


**🔸 Weave特点**

> 💡 **优势**：自动发现、加密通信、操作简单

**🔸 Weave配置示例**

```json
{
  "name": "weave",
  "cniVersion": "0.3.0",
  "plugins": [
    {
      "name": "weave",
      "type": "weave-net",
      "hairpinMode": true
    },
    {
      "type": "portmap",
      "capabilities": {"portMappings": true},
      "snat": true
    }
  ]
}
```

### 4.4 其他网络插件对比


| 插件名称 | **性能** | **安全性** | **易用性** | **适用场景** |
|---------|---------|-----------|-----------|-------------|
| 🔵 **Flannel** | `⭐⭐⭐☆☆` | `⭐⭐☆☆☆` | `⭐⭐⭐⭐⭐` | `学习测试` |
| 🟢 **Calico** | `⭐⭐⭐⭐⭐` | `⭐⭐⭐⭐⭐` | `⭐⭐⭐☆☆` | `生产环境` |
| 🟡 **Weave** | `⭐⭐⭐⭐☆` | `⭐⭐⭐⭐☆` | `⭐⭐⭐⭐☆` | `中小集群` |
| 🔴 **Cilium** | `⭐⭐⭐⭐⭐` | `⭐⭐⭐⭐⭐` | `⭐⭐☆☆☆` | `大型集群` |

---

## 5. 🛠️ 实际部署配置案例


### 5.1 Flannel部署配置


**🔸 部署步骤**

```bash
# 步骤1：下载Flannel配置文件
kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml

# 步骤2：验证CNI配置文件
cat /etc/cni/net.d/10-flannel.conflist
```

**🔸 配置文件内容**

```json
{
  "name": "cbr0",
  "cniVersion": "0.3.1",
  "plugins": [
    {
      "type": "flannel",
      "delegate": {
        "hairpinMode": true,
        "isDefaultGateway": true
      }
    },
    {
      "type": "portmap", 
      "capabilities": {
        "portMappings": true
      }
    }
  ]
}
```

### 5.2 Calico部署配置


**🔸 部署命令**

```bash
# 安装Calico
kubectl create -f https://docs.projectcalico.org/manifests/tigera-operator.yaml
kubectl create -f https://docs.projectcalico.org/manifests/custom-resources.yaml
```

**🔸 自定义配置**

```json
{
  "name": "k8s-pod-network",
  "cniVersion": "0.3.1",
  "plugins": [
    {
      "type": "calico",
      "log_level": "info",
      "datastore_type": "kubernetes", 
      "mtu": 1440,
      "ipam": {
        "type": "calico-ipam"
      },
      "policy": {
        "type": "k8s"
      },
      "kubernetes": {
        "kubeconfig": "/etc/cni/net.d/calico-kubeconfig"
      }
    }
  ]
}
```

### 5.3 网络策略配置示例


**🔸 基础网络策略**

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: deny-all
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
```

> ⚠️ **注意**：只有支持网络策略的插件（如Calico）才能使用此功能

---

## 6. 🔧 网络配置故障排查


### 6.1 常见问题诊断


**🔸 Pod无法获取IP地址**

```bash
# 检查CNI配置文件
ls -la /etc/cni/net.d/

# 检查CNI插件文件
ls -la /opt/cni/bin/

# 查看kubelet日志
journalctl -u kubelet -f
```

**🔸 Pod间无法通信**

```bash
# 测试Pod网络连通性
kubectl exec -it pod1 -- ping <pod2-ip>

# 检查路由表
kubectl exec -it pod1 -- route -n

# 查看网络接口
kubectl exec -it pod1 -- ip addr show
```

### 6.2 配置文件验证


**🔸 JSON格式检查**

```bash
# 使用jq验证JSON格式
cat /etc/cni/net.d/10-flannel.conflist | jq .

# 输出正常说明格式正确
# 报错则需要检查JSON语法
```

**🔸 权限检查**

```bash
# 检查文件权限
ls -la /etc/cni/net.d/
ls -la /opt/cni/bin/

# 确保kubelet可以读取配置文件
# 确保CNI插件可执行
```

### 6.3 网络插件状态检查


**🔸 查看网络插件Pod状态**

```bash
# Flannel状态检查
kubectl get pods -n kube-system | grep flannel

# Calico状态检查  
kubectl get pods -n calico-system

# 查看详细信息
kubectl describe pod <网络插件pod名称> -n <命名空间>
```

---

## 7. 📋 核心要点总结


### 7.1 必须掌握的基础概念


```
🔸 CNI是什么：容器网络接口标准，规定网络插件如何工作
🔸 核心目录：/etc/cni/net.d/（配置） + /opt/cni/bin/（插件程序）
🔸 配置结构：cniVersion + name + type + 网络参数
🔸 主流插件：Flannel（简单）、Calico（生产）、Weave（平衡）
🔸 关键参数：subnet（IP范围）、gateway（网关）、ipam（IP管理）
```

### 7.2 实践要点


**🔹 插件选择策略**
```
学习测试环境：
→ 选择Flannel，配置简单，快速上手

生产环境：
→ 选择Calico，性能优秀，支持网络策略

中等规模：
→ 选择Weave，功能平衡，易于管理
```

**🔹 配置文件管理**
```
命名规范：
✅ 10-flannel.conflist  （优先级高）
✅ 20-calico.conflist   （优先级低）

文件格式：
✅ JSON格式正确
✅ 权限设置合理（644）
✅ 路径位置准确
```

### 7.3 故障排查思路


```
网络问题排查步骤：
1️⃣ 检查配置文件是否存在且格式正确
2️⃣ 验证CNI插件程序是否存在且可执行  
3️⃣ 查看kubelet和网络插件日志
4️⃣ 测试Pod间网络连通性
5️⃣ 检查网络策略是否阻止了通信
```

**核心记忆**：
- CNI配置在`/etc/cni/net.d/`，插件在`/opt/cni/bin/`
- Flannel简单易用，Calico功能强大，按需选择
- 配置文件必须是有效的JSON格式，权限正确
- 网络问题先查配置，再查日志，最后测连通性