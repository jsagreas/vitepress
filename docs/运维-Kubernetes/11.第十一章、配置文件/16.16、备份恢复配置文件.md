---
title: 16ã€å¤‡ä»½æ¢å¤é…ç½®æ–‡ä»¶
---
## ğŸ“š ç›®å½•

1. [ä»€ä¹ˆæ˜¯Kuberneteså¤‡ä»½æ¢å¤](#1-ä»€ä¹ˆæ˜¯kuberneteså¤‡ä»½æ¢å¤)
2. [ä¸ºä»€ä¹ˆéœ€è¦å¤‡ä»½æ¢å¤](#2-ä¸ºä»€ä¹ˆéœ€è¦å¤‡ä»½æ¢å¤)
3. [etcdé›†ç¾¤å¤‡ä»½é…ç½®](#3-etcdé›†ç¾¤å¤‡ä»½é…ç½®)
4. [Veleroå¤‡ä»½å·¥å…·è¯¦è§£](#4-veleroå¤‡ä»½å·¥å…·è¯¦è§£)
5. [å¤‡ä»½ç­–ç•¥ä¸è°ƒåº¦é…ç½®](#5-å¤‡ä»½ç­–ç•¥ä¸è°ƒåº¦é…ç½®)
6. [å­˜å‚¨ä½ç½®ä¸å¿«ç…§é…ç½®](#6-å­˜å‚¨ä½ç½®ä¸å¿«ç…§é…ç½®)
7. [å¤‡ä»½èŒƒå›´æ§åˆ¶é…ç½®](#7-å¤‡ä»½èŒƒå›´æ§åˆ¶é…ç½®)
8. [å¤‡ä»½æ¢å¤é’©å­é…ç½®](#8-å¤‡ä»½æ¢å¤é’©å­é…ç½®)
9. [å®æˆ˜é…ç½®ç¤ºä¾‹](#9-å®æˆ˜é…ç½®ç¤ºä¾‹)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ—ï¸ ä»€ä¹ˆæ˜¯Kuberneteså¤‡ä»½æ¢å¤


### 1.1 å¤‡ä»½æ¢å¤çš„åŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯å¤‡ä»½**
```
ç®€å•ç†è§£ï¼šå°±åƒç»™ä½ çš„æ‰‹æœºåšå¤‡ä»½ä¸€æ ·
- æŠŠé‡è¦çš„æ•°æ®å¤åˆ¶ä¸€ä»½å­˜èµ·æ¥
- é˜²æ­¢åŸå§‹æ•°æ®ä¸¢å¤±æˆ–æŸå
- éœ€è¦æ—¶å¯ä»¥ä»å¤‡ä»½ä¸­æ¢å¤

K8så¤‡ä»½ï¼šæŠŠé›†ç¾¤ä¸­çš„æ‰€æœ‰é‡è¦æ•°æ®ä¿å­˜èµ·æ¥
åŒ…æ‹¬ï¼šåº”ç”¨é…ç½®ã€æ•°æ®åº“å†…å®¹ã€é›†ç¾¤çŠ¶æ€ç­‰
```

**ğŸ”¸ ä»€ä¹ˆæ˜¯æ¢å¤**
```
æ¢å¤å°±æ˜¯ä»å¤‡ä»½ä¸­æŠŠæ•°æ®æ‰¾å›æ¥
- åƒä»å›æ”¶ç«™æ¢å¤åˆ é™¤çš„æ–‡ä»¶
- ä»å¤‡ä»½ä¸­é‡æ–°åˆ›å»ºä¸¢å¤±çš„èµ„æº
- è®©ç³»ç»Ÿå›åˆ°ä¹‹å‰çš„æ­£å¸¸çŠ¶æ€
```

### 1.2 K8sä¸­éœ€è¦å¤‡ä»½ä»€ä¹ˆ


```
K8sé›†ç¾¤å¤‡ä»½å†…å®¹æ¶æ„å›¾ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            K8sé›†ç¾¤                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ etcdå­˜å‚¨      â”‚ é›†ç¾¤é…ç½®ä¿¡æ¯          â”‚ â† æœ€é‡è¦çš„éƒ¨åˆ†
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  
â”‚ åº”ç”¨æ•°æ®      â”‚ Podä¸­çš„æŒä¹…åŒ–æ•°æ®      â”‚ â† ä¸šåŠ¡æ•°æ®
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é…ç½®æ–‡ä»¶      â”‚ YAMLæ–‡ä»¶ã€Secretç­‰    â”‚ â† åº”ç”¨é…ç½®
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é•œåƒæ•°æ®      â”‚ Dockeré•œåƒ           â”‚ â† åº”ç”¨ç¨‹åº
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ’¡ å¤‡ä»½ä¼˜å…ˆçº§**
- ğŸ”¥**æœ€é‡è¦**ï¼šetcdæ•°æ®ï¼ˆé›†ç¾¤çš„"å¤§è„‘"ï¼‰
- â­**å¾ˆé‡è¦**ï¼šæŒä¹…åŒ–å·æ•°æ®ï¼ˆä¸šåŠ¡æ•°æ®ï¼‰
- ğŸŸ¡**é‡è¦**ï¼šé…ç½®æ–‡ä»¶å’ŒSecret
- ğŸŸ¢**ä¸€èˆ¬**ï¼šé•œåƒæ–‡ä»¶ï¼ˆå¯ä»¥é‡æ–°æ‹‰å–ï¼‰

---

## 2. ğŸ¯ ä¸ºä»€ä¹ˆéœ€è¦å¤‡ä»½æ¢å¤


### 2.1 å¸¸è§çš„ç¾éš¾åœºæ™¯


**ğŸ˜± å¯èƒ½å‘ç”Ÿçš„é—®é¢˜**

| é—®é¢˜ç±»å‹ | å…·ä½“æƒ…å†µ | åæœ | è§£å†³åŠæ³• |
|---------|---------|------|---------|
| **ç¡¬ä»¶æ•…éšœ** | `æœåŠ¡å™¨çªç„¶åäº†` | `æ•´ä¸ªé›†ç¾¤æ— æ³•è®¿é—®` | `ä»å¤‡ä»½æ¢å¤` |
| **äººä¸ºè¯¯æ“ä½œ** | `è¯¯åˆ äº†é‡è¦åº”ç”¨` | `ä¸šåŠ¡ä¸­æ–­` | `ä»å¤‡ä»½æ¢å¤ç‰¹å®šåº”ç”¨` |
| **è½¯ä»¶bug** | `æ›´æ–°åç³»ç»Ÿå¼‚å¸¸` | `åŠŸèƒ½ä¸æ­£å¸¸` | `å›æ»šåˆ°ä¹‹å‰çš„çŠ¶æ€` |
| **ç½‘ç»œæ”»å‡»** | `æ•°æ®è¢«æ¶æ„åˆ é™¤` | `æ•°æ®ä¸¢å¤±` | `ä»å¤‡ä»½ä¸­æ‰¾å›æ•°æ®` |

### 2.2 å¤‡ä»½çš„å®é™…ä»·å€¼


**ğŸ’° å¤‡ä»½å°±åƒä¿é™©**
```
æ²¡å‡ºé—®é¢˜æ—¶ï¼šè§‰å¾—æ˜¯é¢å¤–å¼€é”€
å‡ºé—®é¢˜æ—¶ï¼šæ•‘å‘½ç¨»è‰ï¼Œä»·å€¼æ— é™

å®é™…æ¡ˆä¾‹ï¼š
æŸå…¬å¸å› ä¸ºç¡¬ä»¶æ•…éšœä¸¢å¤±äº†æ•´ä¸ªK8sé›†ç¾¤
- æ²¡æœ‰å¤‡ä»½ï¼šéœ€è¦3å¤©é‡æ–°æ­å»ºï¼ŒæŸå¤±300ä¸‡
- æœ‰å¤‡ä»½ï¼š2å°æ—¶æ¢å¤ï¼ŒæŸå¤±å¯æ§
```

---

## 3. ğŸ’¾ etcdé›†ç¾¤å¤‡ä»½é…ç½®


### 3.1 ä»€ä¹ˆæ˜¯etcd


**ğŸ”¸ etcdæ˜¯ä»€ä¹ˆ**
```
etcdå°±åƒK8sçš„"è®°äº‹æœ¬"
- è®°å½•äº†é›†ç¾¤ä¸­æ‰€æœ‰çš„é…ç½®ä¿¡æ¯
- å“ªäº›Podåœ¨å“ªä¸ªèŠ‚ç‚¹è¿è¡Œ
- æœ‰å“ªäº›Serviceå’Œé…ç½®
- å°±åƒæ‰‹æœºçš„é€šè®¯å½•å’Œè®¾ç½®

å¦‚æœetcdä¸¢äº†ï¼Œæ•´ä¸ªé›†ç¾¤å°±"å¤±å¿†"äº†
```

### 3.2 etcdå¤‡ä»½é…ç½®


**âš¡ è‡ªåŠ¨å¤‡ä»½è„šæœ¬é…ç½®**

```bash
#!/bin/bash
# etcdå¤‡ä»½è„šæœ¬ - æ¯å¤©è‡ªåŠ¨æ‰§è¡Œ

# è®¾ç½®åŸºæœ¬å‚æ•°
ETCD_ENDPOINTS="https://127.0.0.1:2379"
BACKUP_DIR="/backup/etcd"
DATE=$(date +%Y%m%d_%H%M%S)

# åˆ›å»ºå¤‡ä»½
etcdctl snapshot save ${BACKUP_DIR}/etcd_backup_${DATE}.db \
  --endpoints=${ETCD_ENDPOINTS} \
  --cacert=/etc/kubernetes/pki/etcd/ca.crt \
  --cert=/etc/kubernetes/pki/etcd/server.crt \
  --key=/etc/kubernetes/pki/etcd/server.key

# éªŒè¯å¤‡ä»½æ˜¯å¦æˆåŠŸ
etcdctl snapshot status ${BACKUP_DIR}/etcd_backup_${DATE}.db
```

**ğŸ“‹ CronJobè‡ªåŠ¨å¤‡ä»½é…ç½®**

```yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: etcd-backup
  namespace: kube-system
spec:
  schedule: "0 2 * * *"  # æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: etcd-backup
            image: k8s.gcr.io/etcd:3.5.0
            command:
            - /bin/sh
            - -c
            - |
              etcdctl snapshot save /backup/etcd_$(date +%Y%m%d).db \
                --endpoints=https://127.0.0.1:2379 \
                --cacert=/etc/kubernetes/pki/etcd/ca.crt \
                --cert=/etc/kubernetes/pki/etcd/server.crt \
                --key=/etc/kubernetes/pki/etcd/server.key
            volumeMounts:
            - name: backup-storage
              mountPath: /backup
          volumes:
          - name: backup-storage
            hostPath:
              path: /opt/backup/etcd
          restartPolicy: OnFailure
```

### 3.3 etcdæ¢å¤é…ç½®


**ğŸ”„ æ¢å¤æ­¥éª¤è¯´æ˜**
```
æ¢å¤etcdå°±åƒä»å¤‡ä»½ä¸­æ¢å¤æ‰‹æœºæ•°æ®ï¼š

æ­¥éª¤ â‘ ï¼šåœæ­¢ç°æœ‰çš„etcdæœåŠ¡
æ­¥éª¤ â‘¡ï¼šä»å¤‡ä»½æ–‡ä»¶æ¢å¤æ•°æ®
æ­¥éª¤ â‘¢ï¼šé‡æ–°å¯åŠ¨etcdæœåŠ¡
æ­¥éª¤ â‘£ï¼šéªŒè¯æ¢å¤æ˜¯å¦æˆåŠŸ
```

---

## 4. ğŸ›¡ï¸ Veleroå¤‡ä»½å·¥å…·è¯¦è§£


### 4.1 Veleroæ˜¯ä»€ä¹ˆ


**ğŸ”¸ Veleroç®€å•ç†è§£**
```
Veleroå°±åƒä¸“ä¸šçš„"æ¬å®¶å…¬å¸"
- ä¸“é—¨è´Ÿè´£K8sé›†ç¾¤çš„å¤‡ä»½å’Œæ¢å¤
- å¯ä»¥å¤‡ä»½æ•´ä¸ªé›†ç¾¤ï¼Œä¹Ÿå¯ä»¥åªå¤‡ä»½éƒ¨åˆ†åº”ç”¨
- æ”¯æŒå®šæ—¶å¤‡ä»½ï¼Œå°±åƒè‡ªåŠ¨ä¿å­˜åŠŸèƒ½
- åŸæ¥å«ARKï¼Œåæ¥æ”¹åä¸ºVelero

æ¯”æ‰‹å·¥å¤‡ä»½æ›´æ™ºèƒ½æ›´å¯é 
```

### 4.2 Veleroå®‰è£…é…ç½®


**ğŸ“¦ Veleroéƒ¨ç½²é…ç½®**

```yaml
# velero-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: velero
  namespace: velero
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: velero
  template:
    metadata:
      labels:
        app.kubernetes.io/name: velero
    spec:
      serviceAccountName: velero
      containers:
      - name: velero
        image: velero/velero:v1.12.0
        command:
        - /velero
        args:
        - server
        - --log-level=info
        - --default-backup-storage-location=default
        - --default-volume-snapshot-locations=default
        env:
        - name: AWS_SHARED_CREDENTIALS_FILE
          value: /credentials/cloud
        volumeMounts:
        - name: credentials
          mountPath: /credentials
        - name: plugins
          mountPath: /plugins
      volumes:
      - name: credentials
        secret:
          secretName: cloud-credentials
      - name: plugins
        emptyDir: {}
```

### 4.3 å­˜å‚¨åç«¯é…ç½®


**â˜ï¸ AWS S3å­˜å‚¨é…ç½®**

```yaml
# aws-backup-location.yaml
apiVersion: velero.io/v1
kind: BackupStorageLocation
metadata:
  name: aws-s3-backup
  namespace: velero
spec:
  provider: aws
  objectStorage:
    bucket: my-k8s-backups  # S3å­˜å‚¨æ¡¶åç§°
    prefix: cluster-backups  # å¤‡ä»½æ–‡ä»¶å‰ç¼€
  config:
    region: us-west-2  # AWSåŒºåŸŸ
    s3ForcePathStyle: "false"
```

**ğŸ—„ï¸ MinIOå­˜å‚¨é…ç½®**

```yaml
# minio-backup-location.yaml
apiVersion: velero.io/v1
kind: BackupStorageLocation
metadata:
  name: minio-backup
  namespace: velero
spec:
  provider: aws
  objectStorage:
    bucket: velero-backups
    prefix: k8s
  config:
    region: minio
    s3Url: http://minio.example.com:9000
    s3ForcePathStyle: "true"
    insecureSkipTLSVerify: "true"
```

---

## 5. â° å¤‡ä»½ç­–ç•¥ä¸è°ƒåº¦é…ç½®


### 5.1 å¤‡ä»½è°ƒåº¦çš„åŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯å¤‡ä»½è°ƒåº¦**
```
å°±åƒè®¾ç½®æ‰‹æœºè‡ªåŠ¨å¤‡ä»½ä¸€æ ·ï¼š
- è®¾å®šä»€ä¹ˆæ—¶é—´è‡ªåŠ¨å¤‡ä»½
- å¤šé•¿æ—¶é—´å¤‡ä»½ä¸€æ¬¡
- å¤‡ä»½æ–‡ä»¶ä¿ç•™å¤šä¹…
- åœ¨ç³»ç»Ÿç©ºé—²æ—¶è‡ªåŠ¨æ‰§è¡Œ

è¿™æ ·å°±ä¸ç”¨æ¯æ¬¡æ‰‹åŠ¨å»å¤‡ä»½äº†
```

### 5.2 å¤‡ä»½è°ƒåº¦é…ç½®


**ğŸ“… å®šæ—¶å¤‡ä»½é…ç½®**

```yaml
# backup-schedule.yaml
apiVersion: velero.io/v1
kind: Schedule
metadata:
  name: daily-backup
  namespace: velero
spec:
  schedule: "0 2 * * *"  # Cronè¡¨è¾¾å¼ï¼šæ¯å¤©å‡Œæ™¨2ç‚¹
  template:
    metadata:
      labels:
        backup-type: scheduled
    spec:
      # åŒ…å«æ‰€æœ‰å‘½åç©ºé—´
      includedNamespaces:
      - "*"
      # æ’é™¤ç³»ç»Ÿå‘½åç©ºé—´
      excludedNamespaces:
      - kube-system
      - kube-public
      # å¤‡ä»½æŒä¹…åŒ–å·
      defaultVolumesToRestic: true
      # å¤‡ä»½ä¿ç•™æ—¶é—´
      ttl: 720h  # 30å¤©
```

**â±ï¸ ä¸åŒé¢‘ç‡çš„å¤‡ä»½ç­–ç•¥**

| å¤‡ä»½ç±»å‹ | å¤‡ä»½é¢‘ç‡ | Cronè¡¨è¾¾å¼ | ä¿ç•™æ—¶é—´ | é€‚ç”¨åœºæ™¯ |
|---------|---------|-----------|---------|----------|
| **æ¯æ—¥å¤‡ä»½** | `æ¯å¤©å‡Œæ™¨2ç‚¹` | `0 2 * * *` | `30å¤©` | `æ—¥å¸¸è¿ç»´å¤‡ä»½` |
| **æ¯å‘¨å¤‡ä»½** | `æ¯å‘¨æ—¥å‡Œæ™¨1ç‚¹` | `0 1 * * 0` | `12å‘¨` | `é•¿æœŸå­˜æ¡£å¤‡ä»½` |
| **æ¯æœˆå¤‡ä»½** | `æ¯æœˆ1å·å‡Œæ™¨3ç‚¹` | `0 3 1 * *` | `12ä¸ªæœˆ` | `åˆè§„æ€§å¤‡ä»½` |
| **ä¸´æ—¶å¤‡ä»½** | `æ‰‹åŠ¨è§¦å‘` | `æ— ` | `7å¤©` | `å‘å¸ƒå‰å¤‡ä»½` |

### 5.3 ä¿ç•™ç­–ç•¥é…ç½®


**ğŸ—‚ï¸ æ™ºèƒ½ä¿ç•™ç­–ç•¥**

```yaml
# retention-policy.yaml
apiVersion: velero.io/v1
kind: Schedule
metadata:
  name: tiered-backup
spec:
  schedule: "0 1 * * *"
  template:
    spec:
      # 7å¤©å†…ï¼šæ¯å¤©ä¿ç•™1ä¸ªå¤‡ä»½
      # 4å‘¨å†…ï¼šæ¯å‘¨ä¿ç•™1ä¸ªå¤‡ä»½  
      # 12æœˆå†…ï¼šæ¯æœˆä¿ç•™1ä¸ªå¤‡ä»½
      ttl: 168h  # 7å¤©åŸºç¡€ä¿ç•™
      metadata:
        labels:
          retention-tier: daily
```

---

## 6. ğŸ—„ï¸ å­˜å‚¨ä½ç½®ä¸å¿«ç…§é…ç½®


### 6.1 å­˜å‚¨ä½ç½®é…ç½®è¯¦è§£


**ğŸ”¸ å­˜å‚¨ä½ç½®æ˜¯ä»€ä¹ˆ**
```
å­˜å‚¨ä½ç½®å°±åƒé€‰æ‹©å¤‡ä»½å­˜æ”¾çš„"ä¿é™©æŸœ"ï¼š
- æœ¬åœ°å­˜å‚¨ï¼šæ”¾åœ¨è‡ªå·±å®¶é‡Œï¼ˆå¿«ä½†ä¸å®‰å…¨ï¼‰
- äº‘å­˜å‚¨ï¼šæ”¾åœ¨é“¶è¡Œä¿é™©æŸœï¼ˆå®‰å…¨ä½†å¯èƒ½æ…¢ä¸€äº›ï¼‰
- å¤šåœ°å­˜å‚¨ï¼šåŒæ—¶æ”¾å¤šä¸ªåœ°æ–¹ï¼ˆæœ€å®‰å…¨ä½†æˆæœ¬é«˜ï¼‰

é€‰æ‹©åˆé€‚çš„å­˜å‚¨ä½ç½®å¾ˆé‡è¦
```

### 6.2 å¤šå­˜å‚¨ä½ç½®é…ç½®


**ğŸ¢ ä¸»å¤‡å­˜å‚¨é…ç½®**

```yaml
# primary-storage-location.yaml
apiVersion: velero.io/v1
kind: BackupStorageLocation
metadata:
  name: primary-storage
  namespace: velero
spec:
  provider: aws
  objectStorage:
    bucket: primary-backups
    prefix: production
  config:
    region: us-east-1
---
# secondary-storage-location.yaml
apiVersion: velero.io/v1
kind: BackupStorageLocation
metadata:
  name: secondary-storage  
  namespace: velero
spec:
  provider: gcp
  objectStorage:
    bucket: secondary-backups
    prefix: production
  config:
    project: my-project-id
```

### 6.3 å·å¿«ç…§ä½ç½®é…ç½®


**ğŸ’¿ å¿«ç…§é…ç½®è¯´æ˜**
```
å·å¿«ç…§å°±åƒç»™ç¡¬ç›˜åš"ç¬é—´æ‹·è´"ï¼š
- å¿«ç…§é€Ÿåº¦å¾ˆå¿«ï¼Œå‡ ä¹ç¬é—´å®Œæˆ
- åªè®°å½•æ•°æ®çš„å˜åŒ–ï¼ŒèŠ‚çœç©ºé—´
- å¯ä»¥å¿«é€Ÿæ¢å¤åˆ°å¿«ç…§æ—¶çš„çŠ¶æ€

é€‚åˆé¢‘ç¹å¤‡ä»½çš„åœºæ™¯
```

**ğŸ“¸ å·å¿«ç…§é…ç½®**

```yaml
# volume-snapshot-location.yaml
apiVersion: velero.io/v1
kind: VolumeSnapshotLocation
metadata:
  name: aws-ebs-snapshots
  namespace: velero
spec:
  provider: aws
  config:
    region: us-west-2
    # å¿«ç…§åŠ å¯†
    encrypted: "true"
    # å¿«ç…§æ ‡ç­¾
    tags:
      Environment: production
      BackupTool: velero
```

---

## 7. ğŸ¯ å¤‡ä»½èŒƒå›´æ§åˆ¶é…ç½®


### 7.1 å‘½åç©ºé—´é€‰æ‹©é…ç½®


**ğŸ”¸ ä¸ºä»€ä¹ˆè¦é€‰æ‹©å¤‡ä»½èŒƒå›´**
```
å°±åƒæ•´ç†æˆ¿é—´æ—¶åˆ†ç±»æ”¶æ‹¾ï¼š
- é‡è¦çš„ä¸œè¥¿ï¼šä¸€å®šè¦å¤‡ä»½ï¼ˆç”Ÿäº§åº”ç”¨ï¼‰
- ä¸´æ—¶çš„ä¸œè¥¿ï¼šä¸éœ€è¦å¤‡ä»½ï¼ˆæµ‹è¯•æ•°æ®ï¼‰
- ç³»ç»Ÿçš„ä¸œè¥¿ï¼šçœ‹æƒ…å†µå¤‡ä»½ï¼ˆç³»ç»Ÿç»„ä»¶ï¼‰

åˆç†é€‰æ‹©å¯ä»¥èŠ‚çœæ—¶é—´å’Œå­˜å‚¨ç©ºé—´
```

**ğŸ“ åŒ…å«å‘½åç©ºé—´é…ç½®**

```yaml
# include-namespaces-backup.yaml
apiVersion: velero.io/v1
kind: Backup
metadata:
  name: production-apps-backup
  namespace: velero
spec:
  # åªå¤‡ä»½è¿™äº›é‡è¦çš„å‘½åç©ºé—´
  includedNamespaces:
  - production      # ç”Ÿäº§ç¯å¢ƒ
  - monitoring      # ç›‘æ§ç³»ç»Ÿ
  - logging         # æ—¥å¿—ç³»ç»Ÿ
  - database        # æ•°æ®åº“
  
  # å¤‡ä»½æŒä¹…åŒ–å·
  defaultVolumesToRestic: true
  
  # å¤‡ä»½æ ‡ç­¾
  metadata:
    labels:
      backup-scope: production-only
```

**ğŸš« æ’é™¤å‘½åç©ºé—´é…ç½®**

```yaml
# exclude-namespaces-backup.yaml
apiVersion: velero.io/v1
kind: Backup
metadata:
  name: full-cluster-backup
spec:
  # å¤‡ä»½æ‰€æœ‰å‘½åç©ºé—´ï¼Œé™¤äº†è¿™äº›
  excludedNamespaces:
  - kube-system     # ç³»ç»Ÿå‘½åç©ºé—´
  - kube-public     # å…¬å…±å‘½åç©ºé—´
  - velero          # å¤‡ä»½å·¥å…·æœ¬èº«
  - test-*          # æ‰€æœ‰æµ‹è¯•å‘½åç©ºé—´
  
  # æ’é™¤ä¸´æ—¶èµ„æº
  excludedResources:
  - events          # äº‹ä»¶æ—¥å¿—
  - logs            # ä¸´æ—¶æ—¥å¿—
```

### 7.2 èµ„æºç±»å‹é€‰æ‹©é…ç½®


**ğŸ”§ èµ„æºè¿‡æ»¤é…ç½®**

```yaml
# resource-filter-backup.yaml
apiVersion: velero.io/v1
kind: Backup
metadata:
  name: config-only-backup
spec:
  # åªå¤‡ä»½é…ç½®ç›¸å…³çš„èµ„æº
  includedResources:
  - configmaps      # é…ç½®æ˜ å°„
  - secrets         # å¯†é’¥
  - deployments     # éƒ¨ç½²é…ç½®
  - services        # æœåŠ¡é…ç½®
  - ingresses       # å…¥å£é…ç½®
  
  # ä¸å¤‡ä»½ä¸´æ—¶æ•°æ®
  excludedResources:
  - pods            # Podå®ä¾‹ï¼ˆä¼šé‡æ–°åˆ›å»ºï¼‰
  - replicasets     # å‰¯æœ¬é›†ï¼ˆç”±Deploymentç®¡ç†ï¼‰
  - events          # äº‹ä»¶ï¼ˆä¸´æ—¶ä¿¡æ¯ï¼‰
```

### 7.3 æ ‡ç­¾é€‰æ‹©å™¨é…ç½®


**ğŸ·ï¸ æ ‡ç­¾è¿‡æ»¤è¯´æ˜**
```
æ ‡ç­¾é€‰æ‹©å™¨å°±åƒç»™ç‰©å“è´´æ ‡ç­¾åˆ†ç±»ï¼š
- environment=productionï¼šç”Ÿäº§ç¯å¢ƒçš„åº”ç”¨
- backup=enabledï¼šéœ€è¦å¤‡ä»½çš„èµ„æº
- tier=databaseï¼šæ•°æ®åº“å±‚çš„ç»„ä»¶

é€šè¿‡æ ‡ç­¾å¯ä»¥ç²¾ç¡®æ§åˆ¶å¤‡ä»½èŒƒå›´
```

**ğŸ¯ æ ‡ç­¾é€‰æ‹©é…ç½®**

```yaml
# label-selector-backup.yaml
apiVersion: velero.io/v1
kind: Backup
metadata:
  name: critical-apps-backup
spec:
  # ä½¿ç”¨æ ‡ç­¾é€‰æ‹©å™¨
  labelSelector:
    matchLabels:
      backup: "enabled"        # å¿…é¡»æœ‰backup=enabledæ ‡ç­¾
      environment: "production" # å¿…é¡»æ˜¯ç”Ÿäº§ç¯å¢ƒ
    matchExpressions:
    - key: tier
      operator: In
      values: ["web", "database", "cache"]  # åªå¤‡ä»½è¿™äº›å±‚çº§
    - key: temporary
      operator: DoesNotExist    # æ’é™¤ä¸´æ—¶èµ„æº
```

---

## 8. ğŸ”— å¤‡ä»½æ¢å¤é’©å­é…ç½®


### 8.1 å¤‡ä»½é’©å­åŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯é’©å­(Hook)**
```
é’©å­å°±åƒ"é¢„çº¦æé†’"ï¼š
- å¤‡ä»½å‰é’©å­ï¼šå°±åƒå‡ºé—¨å‰æ£€æŸ¥é—¨çª—
- å¤‡ä»½åé’©å­ï¼šå°±åƒå‡ºé—¨åç¡®è®¤é”å¥½é—¨

åœ¨å…³é”®æ—¶åˆ»è‡ªåŠ¨æ‰§è¡Œç‰¹å®šæ“ä½œ
ç¡®ä¿å¤‡ä»½å’Œæ¢å¤çš„å®Œæ•´æ€§
```

### 8.2 å¤‡ä»½å‰é’©å­é…ç½®


**âš¡ æ•°æ®åº“å¤‡ä»½å‰é’©å­**

```yaml
# pre-backup-hooks.yaml
apiVersion: velero.io/v1
kind: Backup
metadata:
  name: database-backup-with-hooks
spec:
  hooks:
    resources:
    - name: mysql-backup-hook
      # é’ˆå¯¹MySQLæ•°æ®åº“Pod
      includedNamespaces: ["database"]
      labelSelector:
        matchLabels:
          app: mysql
      # å¤‡ä»½å‰æ‰§è¡Œçš„å‘½ä»¤
      pre:
      - exec:
          container: mysql
          command: ["/bin/bash", "-c"]
          args:
          - |
            echo "å¼€å§‹æ•°æ®åº“å¤‡ä»½å‰çš„å‡†å¤‡..."
            # åˆ·æ–°æ•°æ®åº“ç¼“å­˜
            mysql -u root -p$MYSQL_ROOT_PASSWORD -e "FLUSH TABLES WITH READ LOCK;"
            # ç­‰å¾…æ‰€æœ‰äº‹åŠ¡å®Œæˆ
            sleep 5
            echo "æ•°æ®åº“å·²å‡†å¤‡å¥½å¤‡ä»½"
          onError: Fail  # å¦‚æœå¤±è´¥åˆ™åœæ­¢å¤‡ä»½
```

**ğŸ“ æ–‡ä»¶ç³»ç»Ÿå‡†å¤‡é’©å­**

```yaml
# filesystem-prepare-hook.yaml
apiVersion: velero.io/v1
kind: Backup
metadata:
  name: app-backup-with-prep
spec:
  hooks:
    resources:
    - name: app-prepare-hook
      includedNamespaces: ["applications"]
      pre:
      - exec:
          container: app-container
          command: ["/bin/sh", "-c"]
          args:
          - |
            # åˆ›å»ºåº”ç”¨çŠ¶æ€å¿«ç…§
            echo "ä¿å­˜åº”ç”¨å½“å‰çŠ¶æ€..."
            /app/bin/create-snapshot
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            echo "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
            rm -rf /tmp/*
            echo "å¤‡ä»½å‡†å¤‡å®Œæˆ"
```

### 8.3 å¤‡ä»½åé’©å­é…ç½®


**ğŸ”„ å¤‡ä»½åæ¸…ç†é’©å­**

```yaml
# post-backup-hooks.yaml  
apiVersion: velero.io/v1
kind: Backup
metadata:
  name: backup-with-cleanup
spec:
  hooks:
    resources:
    - name: cleanup-hook
      includedNamespaces: ["database"]
      labelSelector:
        matchLabels:
          app: mysql
      # å¤‡ä»½åæ‰§è¡Œçš„æ¸…ç†
      post:
      - exec:
          container: mysql
          command: ["/bin/bash", "-c"]
          args:
          - |
            echo "å¤‡ä»½å®Œæˆï¼Œå¼€å§‹æ¸…ç†..."
            # é‡Šæ”¾æ•°æ®åº“é”
            mysql -u root -p$MYSQL_ROOT_PASSWORD -e "UNLOCK TABLES;"
            echo "æ•°æ®åº“é”å·²é‡Šæ”¾ï¼Œæ¢å¤æ­£å¸¸æ“ä½œ"
          onError: Continue  # å³ä½¿å¤±è´¥ä¹Ÿç»§ç»­
```

### 8.4 æ¢å¤é’©å­é…ç½®


**ğŸ”§ æ¢å¤ååˆå§‹åŒ–é’©å­**

```yaml
# restore-hooks.yaml
apiVersion: velero.io/v1
kind: Restore  
metadata:
  name: restore-with-init-hooks
spec:
  backupName: production-backup-20240119
  hooks:
    resources:
    - name: database-init-hook
      includedNamespaces: ["database"]
      # æ¢å¤åæ‰§è¡Œåˆå§‹åŒ–
      post:
      - exec:
          container: mysql
          command: ["/bin/bash", "-c"]
          args:
          - |
            echo "ç­‰å¾…æ•°æ®åº“å¯åŠ¨..."
            until mysql -u root -p$MYSQL_ROOT_PASSWORD -e "SELECT 1"; do
              echo "ç­‰å¾…æ•°æ®åº“å“åº”..."
              sleep 5
            done
            echo "æ•°æ®åº“å·²å¯åŠ¨ï¼Œå¼€å§‹åˆå§‹åŒ–..."
            # è¿è¡Œæ•°æ®åº“å‡çº§è„šæœ¬
            mysql -u root -p$MYSQL_ROOT_PASSWORD < /scripts/upgrade.sql
            echo "æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ"
```

---

## 9. ğŸ’» å®æˆ˜é…ç½®ç¤ºä¾‹


### 9.1 å®Œæ•´ç”Ÿäº§ç¯å¢ƒå¤‡ä»½é…ç½®


**ğŸ­ ç”Ÿäº§ç¯å¢ƒå®Œæ•´å¤‡ä»½æ–¹æ¡ˆ**

```yaml
# production-backup-complete.yaml
apiVersion: velero.io/v1
kind: Schedule
metadata:
  name: production-complete-backup
  namespace: velero
  labels:
    backup-tier: production
    schedule-type: complete
spec:
  # æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
  schedule: "0 2 * * *"
  template:
    metadata:
      labels:
        backup-type: production-daily
        retention: "30d"
    spec:
      # å¤‡ä»½ç”Ÿäº§ç›¸å…³å‘½åç©ºé—´
      includedNamespaces:
      - production
      - monitoring  
      - logging
      - ingress-nginx
      
      # æ’é™¤ä¸éœ€è¦çš„å‘½åç©ºé—´
      excludedNamespaces:
      - kube-system
      - test-*
      - dev-*
      
      # èµ„æºè¿‡æ»¤
      includedResources: []  # ç©ºæ•°ç»„è¡¨ç¤ºåŒ…å«æ‰€æœ‰èµ„æº
      excludedResources:
      - events
      - pods  # Podä¼šè‡ªåŠ¨é‡å»º
      
      # æ ‡ç­¾é€‰æ‹©
      labelSelector:
        matchLabels:
          backup: "enabled"
      
      # å­˜å‚¨é…ç½®
      storageLocation: aws-s3-backup
      volumeSnapshotLocations:
      - aws-ebs-snapshots
      
      # å¤‡ä»½è®¾ç½®
      defaultVolumesToRestic: true
      ttl: 720h  # ä¿ç•™30å¤©
      
      # å¤‡ä»½é’©å­
      hooks:
        resources:
        - name: database-backup-hook
          includedNamespaces: ["production"]
          labelSelector:
            matchLabels:
              component: database
          pre:
          - exec:
              container: db
              command: ["/scripts/pre-backup.sh"]
              onError: Fail
          post:
          - exec:
              container: db  
              command: ["/scripts/post-backup.sh"]
              onError: Continue
```

### 9.2 åº”ç”¨çº§åˆ«ç²¾å‡†å¤‡ä»½


**ğŸ¯ å•åº”ç”¨ç²¾å‡†å¤‡ä»½é…ç½®**

```yaml
# app-specific-backup.yaml
apiVersion: velero.io/v1
kind: Backup
metadata:
  name: webapp-backup-$(date +%Y%m%d-%H%M%S)
  namespace: velero
spec:
  # ç²¾ç¡®æŒ‡å®šè¦å¤‡ä»½çš„åº”ç”¨
  includedNamespaces:
  - webapp-prod
  
  # ä½¿ç”¨æ ‡ç­¾ç²¾ç¡®é€‰æ‹©
  labelSelector:
    matchLabels:
      app.kubernetes.io/name: my-webapp
      app.kubernetes.io/instance: production
  
  # åŒ…å«é…ç½®å’Œæ•°æ®
  includedResources:
  - deployments
  - services  
  - configmaps
  - secrets
  - persistentvolumeclaims
  - persistentvolumes
  
  # å­˜å‚¨ä½ç½®
  storageLocation: primary-storage
  volumeSnapshotLocations:
  - aws-ebs-snapshots
  
  # å¤‡ä»½å·æ•°æ®
  defaultVolumesToRestic: true
  
  # ä¿ç•™7å¤©ï¼ˆä¸´æ—¶å¤‡ä»½ï¼‰
  ttl: 168h
```

### 9.3 ç¾éš¾æ¢å¤å®Œæ•´æµç¨‹


**ğŸš¨ ç´§æ€¥æ¢å¤é…ç½®æ¨¡æ¿**

```yaml
# disaster-recovery.yaml
# ç¬¬ä¸€æ­¥ï¼šæ¢å¤æ ¸å¿ƒåŸºç¡€è®¾æ–½
apiVersion: velero.io/v1
kind: Restore
metadata:
  name: disaster-recovery-step1-infrastructure
  namespace: velero
spec:
  backupName: production-complete-backup-latest
  
  # å…ˆæ¢å¤åŸºç¡€è®¾æ–½
  includedNamespaces:
  - ingress-nginx
  - cert-manager
  - monitoring
  
  # æ¢å¤è®¾ç½®
  restorePVs: true
  existingResourcePolicy: update
  
  # æ¢å¤é’©å­ - ç­‰å¾…åŸºç¡€è®¾æ–½å°±ç»ª
  hooks:
    resources:
    - name: wait-for-infrastructure
      postHooks:
      - exec:
          container: kubectl-container
          command: ["/bin/bash", "-c"]
          args:
          - |
            echo "ç­‰å¾…åŸºç¡€è®¾æ–½ç»„ä»¶å°±ç»ª..."
            kubectl wait --for=condition=available --timeout=300s deployment/nginx-ingress-controller -n ingress-nginx
            kubectl wait --for=condition=available --timeout=300s deployment/cert-manager -n cert-manager
            echo "åŸºç¡€è®¾æ–½å·²å°±ç»ª"

---
# ç¬¬äºŒæ­¥ï¼šæ¢å¤ä¸šåŠ¡åº”ç”¨
apiVersion: velero.io/v1  
kind: Restore
metadata:
  name: disaster-recovery-step2-applications
  namespace: velero
spec:
  backupName: production-complete-backup-latest
  
  # æ¢å¤ä¸šåŠ¡åº”ç”¨
  includedNamespaces:
  - production
  
  # æ¢å¤ç­–ç•¥
  restorePVs: true
  existingResourcePolicy: update
  
  # åº”ç”¨å¯åŠ¨åéªŒè¯
  hooks:
    resources:
    - name: verify-applications
      postHooks:
      - exec:
          container: verification-container
          command: ["/scripts/verify-recovery.sh"]
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å¤‡ä»½æ¢å¤æœ¬è´¨ï¼šä¸ºK8sé›†ç¾¤åš"ä¿é™©"ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±
ğŸ”¸ etcdå¤‡ä»½ï¼šé›†ç¾¤çš„"è®°å¿†"ï¼Œæœ€é‡è¦çš„å¤‡ä»½å†…å®¹
ğŸ”¸ Veleroå·¥å…·ï¼šä¸“ä¸šçš„K8så¤‡ä»½æ¢å¤å·¥å…·ï¼ŒåŠŸèƒ½å¼ºå¤§
ğŸ”¸ å¤‡ä»½ç­–ç•¥ï¼šå®šæ—¶è‡ªåŠ¨å¤‡ä»½ï¼Œåˆç†è®¾ç½®ä¿ç•™æ—¶é—´
ğŸ”¸ å­˜å‚¨ä½ç½®ï¼šé€‰æ‹©å®‰å…¨å¯é çš„å¤‡ä»½å­˜å‚¨ä½ç½®
ğŸ”¸ å¤‡ä»½èŒƒå›´ï¼šç²¾ç¡®æ§åˆ¶å¤‡ä»½å†…å®¹ï¼Œé¿å…æµªè´¹ç©ºé—´
ğŸ”¸ é’©å­æœºåˆ¶ï¼šå¤‡ä»½å‰åè‡ªåŠ¨æ‰§è¡Œå¿…è¦æ“ä½œ
```

### 10.2 å…³é”®é…ç½®è¦ç‚¹


**ğŸ”¹ å¤‡ä»½é¢‘ç‡å»ºè®®**
```
æ—¥å¸¸è¿ç»´ï¼šæ¯å¤©å‡Œæ™¨2ç‚¹è‡ªåŠ¨å¤‡ä»½
é‡è¦å˜æ›´ï¼šå˜æ›´å‰æ‰‹åŠ¨å¤‡ä»½
é•¿æœŸå­˜æ¡£ï¼šæ¯å‘¨/æ¯æœˆå¤‡ä»½ï¼Œé•¿æœŸä¿ç•™
ç´§æ€¥æƒ…å†µï¼šéšæ—¶å¯ä»¥æ‰‹åŠ¨è§¦å‘å¤‡ä»½
```

**ğŸ”¹ å­˜å‚¨ç­–ç•¥å»ºè®®**
```
æœ¬åœ°å­˜å‚¨ï¼šå¿«é€Ÿæ¢å¤ï¼Œä½†ä¸å¤Ÿå®‰å…¨
äº‘å­˜å‚¨ï¼šå®‰å…¨å¯é ï¼Œæ¨èä½¿ç”¨  
å¤šåœ°å­˜å‚¨ï¼šæœ€é«˜å®‰å…¨çº§åˆ«ï¼Œæˆæœ¬è¾ƒé«˜
æ··åˆå­˜å‚¨ï¼šæœ¬åœ°+äº‘ç«¯ï¼Œå…¼é¡¾é€Ÿåº¦å’Œå®‰å…¨
```

**ğŸ”¹ æ¢å¤ç­–ç•¥å»ºè®®**
```
å®Œæ•´æ¢å¤ï¼šæ•´ä¸ªé›†ç¾¤æ¢å¤ï¼Œç”¨äºç¾éš¾åœºæ™¯
éƒ¨åˆ†æ¢å¤ï¼šç‰¹å®šåº”ç”¨æ¢å¤ï¼Œç”¨äºè¯¯æ“ä½œåœºæ™¯
æ—¶é—´ç‚¹æ¢å¤ï¼šæ¢å¤åˆ°ç‰¹å®šæ—¶é—´çŠ¶æ€
å¢é‡æ¢å¤ï¼šåªæ¢å¤å˜åŒ–çš„éƒ¨åˆ†
```

### 10.3 æœ€ä½³å®è·µå»ºè®®


**ğŸ’¡ å¤‡ä»½æœ€ä½³å®è·µ**
- âœ… **å®šæœŸæµ‹è¯•**ï¼šå®šæœŸéªŒè¯å¤‡ä»½æ˜¯å¦å¯ç”¨
- âœ… **ç›‘æ§å‘Šè­¦**ï¼šå¤‡ä»½å¤±è´¥æ—¶åŠæ—¶é€šçŸ¥
- âœ… **æ–‡æ¡£è®°å½•**ï¼šè®°å½•å¤‡ä»½æ¢å¤æµç¨‹
- âœ… **æƒé™æ§åˆ¶**ï¼šé™åˆ¶å¤‡ä»½æ“ä½œæƒé™
- âœ… **å­˜å‚¨ç®¡ç†**ï¼šå®šæœŸæ¸…ç†è¿‡æœŸå¤‡ä»½

**âš ï¸ å¸¸è§æ³¨æ„äº‹é¡¹**
- å¤‡ä»½å‰ç¡®ä¿åº”ç”¨å¤„äºä¸€è‡´æ€§çŠ¶æ€
- é€‰æ‹©åˆé€‚çš„å¤‡ä»½æ—¶é—´çª—å£ï¼Œé¿å…ä¸šåŠ¡é«˜å³°
- å®šæœŸæ£€æŸ¥å­˜å‚¨ç©ºé—´ï¼Œé¿å…å¤‡ä»½å¤±è´¥
- å¤‡ä»½é…ç½®æ–‡ä»¶æœ¬èº«ä¹Ÿè¦å¦¥å–„ä¿ç®¡
- å»ºç«‹å®Œæ•´çš„ç¾éš¾æ¢å¤æ¼”ç»ƒè®¡åˆ’

**ğŸ¯ æ ¸å¿ƒè®°å¿†è¦ç‚¹**
- **é¢„é˜²èƒœäºæ²»ç–—**ï¼šæå‰åšå¥½å¤‡ä»½æ¯”å‡ºé—®é¢˜åä¿®å¤æ›´é‡è¦
- **æµ‹è¯•æ˜¯å…³é”®**ï¼šæ²¡æœ‰ç»è¿‡æµ‹è¯•çš„å¤‡ä»½ç­‰äºæ²¡æœ‰å¤‡ä»½
- **è‡ªåŠ¨åŒ–ä¼˜å…ˆ**ï¼šæ‰‹åŠ¨æ“ä½œå®¹æ˜“å‡ºé”™ï¼Œè‡ªåŠ¨åŒ–æ›´å¯é 
- **åˆ†å±‚å¤‡ä»½**ï¼šä¸åŒé‡è¦ç¨‹åº¦çš„æ•°æ®ä½¿ç”¨ä¸åŒå¤‡ä»½ç­–ç•¥