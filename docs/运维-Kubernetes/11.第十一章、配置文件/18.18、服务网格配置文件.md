---
title: 18ã€æœåŠ¡ç½‘æ ¼é…ç½®æ–‡ä»¶
---
## ğŸ“š ç›®å½•

1. [æœåŠ¡ç½‘æ ¼æ¦‚å¿µä¸æ ¸å¿ƒä»·å€¼](#1-æœåŠ¡ç½‘æ ¼æ¦‚å¿µä¸æ ¸å¿ƒä»·å€¼)
2. [IstioæœåŠ¡ç½‘æ ¼å®Œæ•´é…ç½®](#2-istioæœåŠ¡ç½‘æ ¼å®Œæ•´é…ç½®)
3. [æµé‡ç®¡ç†æ ¸å¿ƒé…ç½®](#3-æµé‡ç®¡ç†æ ¸å¿ƒé…ç½®)
4. [å®‰å…¨ç­–ç•¥é…ç½®è¯¦è§£](#4-å®‰å…¨ç­–ç•¥é…ç½®è¯¦è§£)
5. [å¯è§‚æµ‹æ€§é…ç½®å®è·µ](#5-å¯è§‚æµ‹æ€§é…ç½®å®è·µ)
6. [Linkerdè½»é‡çº§æœåŠ¡ç½‘æ ¼](#6-linkerdè½»é‡çº§æœåŠ¡ç½‘æ ¼)
7. [Consul Connectä¼ä¸šçº§æ–¹æ¡ˆ](#7-consul-connectä¼ä¸šçº§æ–¹æ¡ˆ)
8. [å®æˆ˜éƒ¨ç½²ä¸æ•…éšœæ’æŸ¥](#8-å®æˆ˜éƒ¨ç½²ä¸æ•…éšœæ’æŸ¥)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ æœåŠ¡ç½‘æ ¼æ¦‚å¿µä¸æ ¸å¿ƒä»·å€¼


### 1.1 ä»€ä¹ˆæ˜¯æœåŠ¡ç½‘æ ¼

**é€šä¿—ç†è§£**ï¼šæœåŠ¡ç½‘æ ¼å°±åƒæ˜¯ç»™å¾®æœåŠ¡ä¹‹é—´æ­å»ºäº†ä¸€ä¸ª"æ™ºèƒ½äº¤é€šç³»ç»Ÿ"

```
æ²¡æœ‰æœåŠ¡ç½‘æ ¼çš„å¾®æœåŠ¡ï¼š           æœ‰æœåŠ¡ç½‘æ ¼çš„å¾®æœåŠ¡ï¼š
    
  æœåŠ¡A â†â†’ æœåŠ¡B                   æœåŠ¡A â†â†’ ä»£ç†A â†â†’ ä»£ç†B â†â†’ æœåŠ¡B
    â†•       â†•                         â†•         â†•
  æœåŠ¡C â†â†’ æœåŠ¡D                   æœåŠ¡C â†â†’ ä»£ç†C â†â†’ ä»£ç†D â†â†’ æœåŠ¡D

ç›´æ¥é€šä¿¡ï¼Œéš¾ä»¥ç®¡æ§                 é€šè¿‡ä»£ç†é€šä¿¡ï¼Œç»Ÿä¸€ç®¡ç†
```

**ğŸ”¸ æ ¸å¿ƒæ¦‚å¿µè§£é‡Š**
```
æœåŠ¡ç½‘æ ¼ï¼ˆService Meshï¼‰ï¼š
â€¢ å®šä¹‰ï¼šä¸“é—¨å¤„ç†æœåŠ¡é—´é€šä¿¡çš„åŸºç¡€è®¾æ–½å±‚
â€¢ æœ¬è´¨ï¼šåœ¨æ¯ä¸ªæœåŠ¡æ—è¾¹æ”¾ä¸€ä¸ª"æ™ºèƒ½ä»£ç†"
â€¢ ç›®çš„ï¼šè®©æœåŠ¡ä¸“æ³¨ä¸šåŠ¡é€»è¾‘ï¼Œé€šä¿¡é—®é¢˜äº¤ç»™ç½‘æ ¼å¤„ç†
â€¢ ç±»æ¯”ï¼šå°±åƒåŸå¸‚çš„äº¤é€šç®¡ç†ç³»ç»Ÿï¼Œç®¡ç†è½¦è¾†ï¼ˆæœåŠ¡ï¼‰å¦‚ä½•é€šè¡Œ
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦æœåŠ¡ç½‘æ ¼


**ğŸ¯ è§£å†³çš„æ ¸å¿ƒé—®é¢˜**
```
å¾®æœåŠ¡é€šä¿¡çš„æŒ‘æˆ˜ï¼š

1ï¸âƒ£ æœåŠ¡å‘ç°éš¾é¢˜ï¼š
   é—®é¢˜ï¼šæœåŠ¡Aå¦‚ä½•æ‰¾åˆ°æœåŠ¡Bï¼Ÿ
   ä¼ ç»Ÿï¼šç¡¬ç¼–ç IPåœ°å€ï¼Œç»´æŠ¤å›°éš¾
   ç½‘æ ¼ï¼šè‡ªåŠ¨å‘ç°ï¼ŒåŠ¨æ€æ›´æ–°

2ï¸âƒ£ è´Ÿè½½å‡è¡¡å¤æ‚ï¼š
   é—®é¢˜ï¼šå¤šä¸ªæœåŠ¡å®ä¾‹å¦‚ä½•åˆ†é…æµé‡ï¼Ÿ
   ä¼ ç»Ÿï¼šæ¯ä¸ªæœåŠ¡è‡ªå·±å®ç°
   ç½‘æ ¼ï¼šç»Ÿä¸€çš„è´Ÿè½½å‡è¡¡ç­–ç•¥

3ï¸âƒ£ æ•…éšœå¤„ç†æ··ä¹±ï¼š
   é—®é¢˜ï¼šæœåŠ¡å®•æœºå¦‚ä½•å¿«é€Ÿæ¢å¤ï¼Ÿ
   ä¼ ç»Ÿï¼šå„æœåŠ¡è‡ªå·±å¤„ç†ï¼Œä¸ä¸€è‡´
   ç½‘æ ¼ï¼šç»Ÿä¸€çš„ç†”æ–­ã€é‡è¯•æœºåˆ¶

4ï¸âƒ£ å®‰å…¨ç®¡ç†å›°éš¾ï¼š
   é—®é¢˜ï¼šæœåŠ¡é—´å¦‚ä½•å®‰å…¨é€šä¿¡ï¼Ÿ
   ä¼ ç»Ÿï¼šå„æœåŠ¡è‡ªå·±åŠ å¯†ï¼Œç®¡ç†å¤æ‚
   ç½‘æ ¼ï¼šç»Ÿä¸€çš„å®‰å…¨ç­–ç•¥å’Œè¯ä¹¦ç®¡ç†
```

### 1.3 æœåŠ¡ç½‘æ ¼çš„æ ¸å¿ƒä»·å€¼


**ğŸ’¡ ä¸šåŠ¡ä»·å€¼**
- **ğŸš€ å¼€å‘æ•ˆç‡**ï¼šå¼€å‘è€…ä¸“æ³¨ä¸šåŠ¡é€»è¾‘ï¼Œä¸ç”¨å…³å¿ƒé€šä¿¡ç»†èŠ‚
- **ğŸ”’ å®‰å…¨ä¿éšœ**ï¼šç»Ÿä¸€çš„å®‰å…¨ç­–ç•¥ï¼Œè‡ªåŠ¨åŠ å¯†é€šä¿¡
- **ğŸ“Š å¯è§‚æµ‹æ€§**ï¼šè‡ªåŠ¨æ”¶é›†æ‰€æœ‰æœåŠ¡é—´é€šä¿¡æ•°æ®
- **âš¡ æ€§èƒ½ä¼˜åŒ–**ï¼šæ™ºèƒ½æµé‡ç®¡ç†ï¼Œæå‡æ•´ä½“æ€§èƒ½

### 1.4 ä¸»æµæœåŠ¡ç½‘æ ¼å¯¹æ¯”


| ç‰¹æ€§å¯¹æ¯” | **Istio** | **Linkerd** | **Consul Connect** |
|---------|-----------|-------------|-------------------|
| ğŸ¯ **å®šä½** | `åŠŸèƒ½å…¨é¢çš„ä¼ä¸šçº§æ–¹æ¡ˆ` | `è½»é‡çº§é«˜æ€§èƒ½æ–¹æ¡ˆ` | `HashiCorpç”Ÿæ€é›†æˆ` |
| âš–ï¸ **å¤æ‚åº¦** | `é«˜ - é…ç½®å¤æ‚ä½†åŠŸèƒ½å¼ºå¤§` | `ä½ - å¼€ç®±å³ç”¨` | `ä¸­ - éœ€è¦ConsulåŸºç¡€` |
| ğŸ“ˆ **æ€§èƒ½å¼€é”€** | `è¾ƒé«˜ - åŠŸèƒ½å¤šä»£ä»·å¤§` | `æœ€ä½ - Rustç¼–å†™é«˜æ•ˆ` | `ä¸­ç­‰ - Goè¯­è¨€å®ç°` |
| ğŸ”§ **å­¦ä¹ éš¾åº¦** | `éš¾ - æ¦‚å¿µå¤šé…ç½®å¤æ‚` | `æ˜“ - é…ç½®ç®€å•ç›´è§‚` | `ä¸­ - éœ€è¦äº†è§£Consul` |
| ğŸ¢ **é€‚ç”¨åœºæ™¯** | `å¤§å‹ä¼ä¸šå¤æ‚ç¯å¢ƒ` | `ä¸­å°å›¢é˜Ÿå¿«é€Ÿä¸Šæ‰‹` | `å·²ä½¿ç”¨HashiCorpæ ˆ` |

---

## 2. ğŸ› ï¸ IstioæœåŠ¡ç½‘æ ¼å®Œæ•´é…ç½®


### 2.1 Istioæ¶æ„æ ¸å¿ƒç»„ä»¶


**ğŸ—ï¸ Istioæ§åˆ¶å¹³é¢ç»„ä»¶è¯¦è§£**

```
Istioæ¶æ„å›¾ï¼š
                                    
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚          æ§åˆ¶å¹³é¢ï¼ˆIstiodï¼‰        â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
        â”‚  â”‚  Pilot  â”‚ Citadel â”‚ Galley  â”‚ â”‚  
        â”‚  â”‚ æµé‡ç®¡ç†  â”‚  å®‰å…¨   â”‚ é…ç½®éªŒè¯ â”‚ â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚               â”‚               â”‚
    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”       â”Œâ”€â”€â”€â–¼â”€â”€â”€â”       â”Œâ”€â”€â”€â–¼â”€â”€â”€â”
    â”‚æœåŠ¡A + â”‚       â”‚æœåŠ¡B + â”‚       â”‚æœåŠ¡C + â”‚
    â”‚Envoy   â”‚â—„â”€â”€â”€â”€â”€â–ºâ”‚Envoy   â”‚â—„â”€â”€â”€â”€â”€â–ºâ”‚Envoy   â”‚
    â”‚Sidecar â”‚       â”‚Sidecar â”‚       â”‚Sidecar â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”¸ ç»„ä»¶åŠŸèƒ½è¯´æ˜**
- **Pilotï¼ˆé£è¡Œå‘˜ï¼‰**ï¼šè´Ÿè´£æµé‡ç®¡ç†ï¼Œå°±åƒç©ºä¸­äº¤é€šç®¡åˆ¶å‘˜
- **Citadelï¼ˆåŸå ¡ï¼‰**ï¼šè´Ÿè´£å®‰å…¨è®¤è¯ï¼Œå°±åƒå®‰æ£€ç³»ç»Ÿ
- **Galleyï¼ˆå¨æˆ¿ï¼‰**ï¼šè´Ÿè´£é…ç½®éªŒè¯ï¼Œå°±åƒè´¨æ£€å‘˜
- **Envoy Sidecar**ï¼šæ¯ä¸ªæœåŠ¡çš„ä¸“å±ä»£ç†ï¼Œå°±åƒè´´èº«ä¿é•–

### 2.2 Istioå®‰è£…é…ç½®


```yaml
# istio-installation.yaml - Istioå®‰è£…é…ç½®æ–‡ä»¶
apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
metadata:
  name: control-plane
  namespace: istio-system
spec:
  # ğŸ¯ é€‰æ‹©å®‰è£…é…ç½®æ¡£æ¡ˆ
  profile: demo  # æ¼”ç¤ºç¯å¢ƒï¼šåŠŸèƒ½å…¨å¼€ï¼Œé€‚åˆå­¦ä¹ 
  # profile: minimal    # æœ€å°å®‰è£…ï¼šä»…æ ¸å¿ƒåŠŸèƒ½
  # profile: production # ç”Ÿäº§ç¯å¢ƒï¼šæ€§èƒ½ä¼˜åŒ–
  
  values:
    global:
      # ğŸŒ å…¨å±€é…ç½®
      meshID: mesh1                    # ç½‘æ ¼æ ‡è¯†
      multiCluster:
        clusterName: cluster1          # é›†ç¾¤åç§°
      network: network1                # ç½‘ç»œæ ‡è¯†
      
    pilot:
      # ğŸ›ï¸ Piloté…ç½® - æµé‡ç®¡ç†æ ¸å¿ƒ
      env:
        EXTERNAL_ISTIOD: false         # æ˜¯å¦ä½¿ç”¨å¤–éƒ¨æ§åˆ¶é¢
        PILOT_ENABLE_WORKLOAD_ENTRY: true  # å¯ç”¨å·¥ä½œè´Ÿè½½æ¡ç›®
        
    gateways:
      # ğŸšª ç½‘å…³é…ç½®
      istio-ingressgateway:
        type: LoadBalancer             # ç½‘å…³ç±»å‹
        ports:
        - port: 80
          targetPort: 8080
          name: http2
        - port: 443
          targetPort: 8443
          name: https
          
  components:
    pilot:
      k8s:
        resources:
          # ğŸ“Š èµ„æºé™åˆ¶ - æ ¹æ®ç¯å¢ƒè°ƒæ•´
          requests:
            cpu: 200m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
```

**ğŸ’¡ å®‰è£…å‘½ä»¤è¯¦è§£**

```bash
# 1ï¸âƒ£ ä¸‹è½½å¹¶å®‰è£…Istio
curl -L https://istio.io/downloadIstio | sh-
cd istio-1.20.0

# 2ï¸âƒ£ æ·»åŠ istioctlåˆ°PATH
export PATH=$PWD/bin:$PATH

# 3ï¸âƒ£ å®‰è£…Istioï¼ˆä½¿ç”¨ä¸Šé¢çš„é…ç½®æ–‡ä»¶ï¼‰
istioctl install -f istio-installation.yaml

# 4ï¸âƒ£ å¯ç”¨è‡ªåŠ¨Sidecaræ³¨å…¥
kubectl label namespace default istio-injection=enabled

# âœ… éªŒè¯å®‰è£…æ˜¯å¦æˆåŠŸ
kubectl get pods -n istio-system
```

### 2.3 Sidecaræ³¨å…¥å™¨é…ç½®


```yaml
# sidecar-injector-config.yaml - æ³¨å…¥å™¨è¯¦ç»†é…ç½®
apiVersion: v1
kind: ConfigMap
metadata:
  name: istio-sidecar-injector
  namespace: istio-system
data:
  config: |
    # ğŸ”§ æ³¨å…¥ç­–ç•¥é…ç½®
    policy: enabled                    # é»˜è®¤å¯ç”¨æ³¨å…¥
    alwaysInjectSelector:              # æ€»æ˜¯æ³¨å…¥çš„æ ‡ç­¾é€‰æ‹©å™¨
    - matchLabels:
        istio-injection: enabled
    neverInjectSelector:               # æ°¸ä¸æ³¨å…¥çš„æ ‡ç­¾é€‰æ‹©å™¨
    - matchLabels:
        istio-injection: disabled
        
    # ğŸ“¦ Sidecarå®¹å™¨é…ç½®æ¨¡æ¿
    template: |
      spec:
        initContainers:
        - name: istio-init
          image: docker.io/istio/proxyv2:1.20.0
          # ğŸ”— åˆå§‹åŒ–å®¹å™¨ï¼šé…ç½®iptablesè§„åˆ™æ‹¦æˆªæµé‡
          command:
          - istio-iptables
          - -p
          - "15001"                    # Envoyç›‘å¬ç«¯å£
          - -u
          - "1337"                     # Envoyç”¨æˆ·ID
          
        containers:
        - name: istio-proxy
          image: docker.io/istio/proxyv2:1.20.0
          # âš™ï¸ Envoyä»£ç†é…ç½®
          args:
          - proxy
          - sidecar
          - --domain
          - $(POD_NAMESPACE).svc.cluster.local
          - --proxyLogLevel=warning
          - --proxyComponentLogLevel=misc:error
          
          env:
          - name: PILOT_CERT_PROVIDER
            value: istiod                # è¯ä¹¦æä¾›è€…
          - name: CA_ADDR
            value: istiod.istio-system.svc:15010  # CAåœ°å€
            
          ports:
          - containerPort: 15090
            name: http-monitoring        # ç›‘æ§ç«¯å£
            protocol: TCP
            
          resources:
            # ğŸ“Š èµ„æºé…ç½® - æ ¹æ®æœåŠ¡è§„æ¨¡è°ƒæ•´
            limits:
              cpu: 200m
              memory: 128Mi
            requests:
              cpu: 100m
              memory: 64Mi
```

---

## 3. ğŸŒŠ æµé‡ç®¡ç†æ ¸å¿ƒé…ç½®


### 3.1 è™šæ‹ŸæœåŠ¡é…ç½®è¯¦è§£


**ğŸ¯ è™šæ‹ŸæœåŠ¡æ¦‚å¿µç†è§£**
è™šæ‹ŸæœåŠ¡å°±åƒæ˜¯"äº¤é€šæŒ‡æŒ¥å®˜"ï¼Œå†³å®šæµé‡å¦‚ä½•åœ¨æœåŠ¡ä¹‹é—´æµåŠ¨ã€‚

```yaml
# virtual-service-example.yaml - è™šæ‹ŸæœåŠ¡é…ç½®å®ä¾‹
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: bookinfo-virtual-service
  namespace: default
spec:
  # ğŸ¯ ä¸»æœºé…ç½® - æŒ‡å®šè™šæ‹ŸæœåŠ¡ä½œç”¨çš„ä¸»æœº
  hosts:
  - bookinfo.example.com               # å¤–éƒ¨è®¿é—®åŸŸå
  - productpage.default.svc.cluster.local  # é›†ç¾¤å†…éƒ¨æœåŠ¡å
  
  # ğŸšª ç½‘å…³ç»‘å®š - ä»å“ªä¸ªç½‘å…³æ¥æ”¶æµé‡
  gateways:
  - bookinfo-gateway                   # ç»‘å®šåˆ°æŒ‡å®šç½‘å…³
  - mesh                              # meshè¡¨ç¤ºé›†ç¾¤å†…éƒ¨æµé‡
  
  # ğŸ›£ï¸ HTTPè·¯ç”±è§„åˆ™
  http:
  # è·¯ç”±è§„åˆ™1ï¼šåŸºäºè·¯å¾„çš„è·¯ç”±
  - match:
    - uri:
        prefix: "/api/v1/"             # åŒ¹é…ä»¥/api/v1/å¼€å¤´çš„è¯·æ±‚
    route:
    - destination:
        host: productpage-service      # ç›®æ ‡æœåŠ¡
        subset: v1                     # æœåŠ¡å­é›†ï¼ˆç‰ˆæœ¬ï¼‰
      weight: 80                       # æµé‡æƒé‡80%
    - destination:
        host: productpage-service
        subset: v2                     # æ–°ç‰ˆæœ¬æœåŠ¡
      weight: 20                       # æµé‡æƒé‡20%
    
    # â±ï¸ è¶…æ—¶é…ç½®
    timeout: 30s                       # è¯·æ±‚è¶…æ—¶æ—¶é—´
    
    # ğŸ” é‡è¯•é…ç½®
    retries:
      attempts: 3                      # æœ€å¤§é‡è¯•æ¬¡æ•°
      perTryTimeout: 10s               # æ¯æ¬¡é‡è¯•è¶…æ—¶
      retryOn: 5xx                     # é‡åˆ°5xxé”™è¯¯æ‰é‡è¯•
      
    # ğŸ’‰ æ•…éšœæ³¨å…¥ï¼ˆç”¨äºæµ‹è¯•ï¼‰
    fault:
      delay:
        percentage:
          value: 0.1                   # 10%çš„è¯·æ±‚å»¶è¿Ÿ
        fixedDelay: 5s                 # å»¶è¿Ÿ5ç§’
      abort:
        percentage:
          value: 0.01                  # 1%çš„è¯·æ±‚ç›´æ¥å¤±è´¥
        httpStatus: 500                # è¿”å›500é”™è¯¯

  # è·¯ç”±è§„åˆ™2ï¼šåŸºäºè¯·æ±‚å¤´çš„è·¯ç”±
  - match:
    - headers:
        user-type:
          exact: premium               # ç²¾ç¡®åŒ¹é…header
    route:
    - destination:
        host: productpage-service
        subset: premium                # é«˜çº§ç”¨æˆ·ä¸“ç”¨ç‰ˆæœ¬
        
  # è·¯ç”±è§„åˆ™3ï¼šé»˜è®¤è·¯ç”±
  - route:
    - destination:
        host: productpage-service
        subset: v1                     # é»˜è®¤è·¯ç”±åˆ°v1ç‰ˆæœ¬
```

### 3.2 ç›®æ ‡è§„åˆ™é…ç½®è¯¦è§£


**ğŸ¯ ç›®æ ‡è§„åˆ™æ¦‚å¿µç†è§£**
ç›®æ ‡è§„åˆ™å°±åƒæ˜¯"æœåŠ¡åˆ†ç»„ç®¡ç†å™¨"ï¼Œå®šä¹‰å¦‚ä½•å°†æœåŠ¡åˆ†æˆä¸åŒçš„å­é›†ã€‚

```yaml
# destination-rule-example.yaml - ç›®æ ‡è§„åˆ™é…ç½®å®ä¾‹
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: productpage-destination-rule
  namespace: default
spec:
  # ğŸ¯ ç›®æ ‡ä¸»æœº
  host: productpage-service
  
  # âš–ï¸ æµé‡ç­–ç•¥ - åº”ç”¨äºæ‰€æœ‰å­é›†çš„é€šç”¨ç­–ç•¥
  trafficPolicy:
    # è´Ÿè½½å‡è¡¡ç®—æ³•
    loadBalancer:
      simple: LEAST_CONN               # æœ€å°‘è¿æ¥æ•°ç®—æ³•
      # simple: ROUND_ROBIN            # è½®è¯¢ç®—æ³•  
      # simple: RANDOM                 # éšæœºç®—æ³•
      # simple: PASSTHROUGH            # é€ä¼ ç®—æ³•
      
    # ğŸ”— è¿æ¥æ± é…ç½®
    connectionPool:
      tcp:
        maxConnections: 10             # æœ€å¤§è¿æ¥æ•°
        connectTimeout: 30s            # è¿æ¥è¶…æ—¶
      http:
        http1MaxPendingRequests: 64    # HTTP1æœ€å¤§ç­‰å¾…è¯·æ±‚æ•°
        http2MaxRequests: 100          # HTTP2æœ€å¤§è¯·æ±‚æ•°
        maxRequestsPerConnection: 2    # æ¯è¿æ¥æœ€å¤§è¯·æ±‚æ•°
        maxRetries: 3                  # æœ€å¤§é‡è¯•æ¬¡æ•°
        consecutiveGatewayErrors: 5    # è¿ç»­ç½‘å…³é”™è¯¯é˜ˆå€¼
        
    # ğŸš¨ å¼‚å¸¸æ£€æµ‹ï¼ˆç†”æ–­å™¨ï¼‰
    outlierDetection:
      consecutive5xxErrors: 3          # è¿ç»­5xxé”™è¯¯3æ¬¡è§¦å‘ç†”æ–­
      consecutiveGatewayErrors: 3      # è¿ç»­ç½‘å…³é”™è¯¯3æ¬¡è§¦å‘ç†”æ–­  
      interval: 30s                    # æ£€æµ‹é—´éš”
      baseEjectionTime: 30s            # åŸºç¡€å¼¹å‡ºæ—¶é—´
      maxEjectionPercent: 10           # æœ€å¤§å¼¹å‡ºå®ä¾‹ç™¾åˆ†æ¯”
      minHealthPercent: 60             # æœ€å°å¥åº·å®ä¾‹ç™¾åˆ†æ¯”

  # ğŸ“‹ å­é›†å®šä¹‰ - æ ¹æ®æ ‡ç­¾å°†æœåŠ¡åˆ†ç»„
  subsets:
  # ç‰ˆæœ¬1å­é›†
  - name: v1
    labels:
      version: v1                      # æ ¹æ®versionæ ‡ç­¾åˆ†ç»„
    trafficPolicy:
      # å­é›†ç‰¹å®šçš„æµé‡ç­–ç•¥
      connectionPool:
        tcp:
          maxConnections: 5            # v1ç‰ˆæœ¬æœ€å¤§è¿æ¥æ•°æ›´å°
          
  # ç‰ˆæœ¬2å­é›†  
  - name: v2
    labels:
      version: v2
    trafficPolicy:
      loadBalancer:
        simple: ROUND_ROBIN            # v2ç‰ˆæœ¬ä½¿ç”¨è½®è¯¢ç®—æ³•
        
  # é«˜çº§ç”¨æˆ·å­é›†
  - name: premium
    labels:
      tier: premium
    trafficPolicy:
      connectionPool:
        tcp:
          maxConnections: 20           # é«˜çº§ç”¨æˆ·æ›´é«˜è¿æ¥é™åˆ¶
```

### 3.3 ç½‘å…³é…ç½®è¯¦è§£


**ğŸšª ç½‘å…³æ¦‚å¿µç†è§£**
ç½‘å…³å°±åƒæ˜¯"å¤§é—¨å®ˆå«"ï¼Œç®¡ç†å¤–éƒ¨æµé‡å¦‚ä½•è¿›å…¥æœåŠ¡ç½‘æ ¼ã€‚

```yaml
# gateway-example.yaml - ç½‘å…³é…ç½®å®ä¾‹
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: bookinfo-gateway
  namespace: default
spec:
  # ğŸ¯ é€‰æ‹©å™¨ - æŒ‡å®šå“ªä¸ªç½‘å…³å®ä¾‹å¤„ç†æµé‡
  selector:
    istio: ingressgateway              # ä½¿ç”¨é»˜è®¤çš„å…¥å£ç½‘å…³
    
  # ğŸ”Œ æœåŠ¡å™¨é…ç½® - å®šä¹‰ç›‘å¬çš„ç«¯å£å’Œåè®®
  servers:
  # HTTPé…ç½®
  - port:
      number: 80                       # ç›‘å¬ç«¯å£
      name: http                       # ç«¯å£åç§°
      protocol: HTTP                   # åè®®ç±»å‹
    hosts:
    - bookinfo.example.com             # å…è®¸çš„ä¸»æœºå
    - "*.bookinfo.com"                 # æ”¯æŒé€šé…ç¬¦
    
  # HTTPSé…ç½®
  - port:
      number: 443
      name: https
      protocol: HTTPS
    tls:
      mode: SIMPLE                     # TLSæ¨¡å¼
      credentialName: bookinfo-cert    # è¯ä¹¦å¯†é’¥åç§°
    hosts:
    - bookinfo.example.com
    
  # TCPé…ç½®ï¼ˆç”¨äºéHTTPåè®®ï¼‰
  - port:
      number: 9999
      name: tcp
      protocol: TCP
    hosts:
    - "*"                              # æ‰€æœ‰ä¸»æœº
```

---

## 4. ğŸ”’ å®‰å…¨ç­–ç•¥é…ç½®è¯¦è§£


### 4.1 æœåŠ¡é—´è®¤è¯é…ç½®


**ğŸ›¡ï¸ mTLSï¼ˆåŒå‘TLSï¼‰é…ç½®**
mTLSå°±åƒæ˜¯"åŒå‘èº«ä»½è¯æ£€æŸ¥"ï¼Œç¡®ä¿é€šä¿¡åŒæ–¹éƒ½æ˜¯å¯ä¿¡çš„ã€‚

```yaml
# peer-authentication.yaml - æœåŠ¡é—´è®¤è¯é…ç½®
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default-peer-auth
  namespace: default
spec:
  # ğŸ¯ åº”ç”¨èŒƒå›´ï¼ˆä¸æŒ‡å®šselectorè¡¨ç¤ºåº”ç”¨äºæ•´ä¸ªå‘½åç©ºé—´ï¼‰
  # selector:
  #   matchLabels:
  #     app: productpage              # ä»…åº”ç”¨äºç‰¹å®šæœåŠ¡
  
  # ğŸ” mTLSæ¨¡å¼é…ç½®
  mtls:
    mode: STRICT                       # ä¸¥æ ¼æ¨¡å¼ï¼šå¼ºåˆ¶è¦æ±‚mTLS
    # mode: PERMISSIVE                 # å®½æ¾æ¨¡å¼ï¼šåŒæ—¶æ”¯æŒæ˜æ–‡å’ŒmTLS
    # mode: DISABLE                    # ç¦ç”¨æ¨¡å¼ï¼šç¦ç”¨mTLS
    
  # ğŸ”Œ ç«¯å£çº§åˆ«é…ç½®ï¼ˆå¯é€‰ï¼‰
  portLevelMtls:
    8080:
      mode: STRICT                     # 8080ç«¯å£å¼ºåˆ¶mTLS
    9090:
      mode: DISABLE                    # 9090ç«¯å£ç¦ç”¨mTLSï¼ˆå¦‚ç›‘æ§ç«¯å£ï¼‰
```

**ğŸ”‘ è¯·æ±‚è®¤è¯é…ç½®**
```yaml
# request-authentication.yaml - è¯·æ±‚è®¤è¯é…ç½®
apiVersion: security.istio.io/v1beta1
kind: RequestAuthentication
metadata:
  name: jwt-auth
  namespace: default
spec:
  # ğŸ¯ é€‰æ‹©å™¨ - æŒ‡å®šåº”ç”¨çš„å·¥ä½œè´Ÿè½½
  selector:
    matchLabels:
      app: productpage
      
  # ğŸ« JWTè§„åˆ™é…ç½®
  jwtRules:
  - issuer: "https://auth.example.com"         # JWTç­¾å‘è€…
    jwksUri: "https://auth.example.com/.well-known/jwks.json"  # å…¬é’¥åœ°å€
    audiences:
    - "bookinfo-api"                           # é¢„æœŸå—ä¼—
    
    # ğŸ“ JWTä½ç½®é…ç½®
    fromHeaders:
    - name: Authorization                      # ä»Authorizationå¤´è·å–
      prefix: "Bearer "                        # å‰ç¼€
    fromParams:
    - "access_token"                          # ä»URLå‚æ•°è·å–
    fromCookies:
    - "auth-token"                            # ä»Cookieè·å–
    
    # â° JWTéªŒè¯é…ç½®
    forwardOriginalToken: true                # è½¬å‘åŸå§‹tokenç»™åç«¯
```

### 4.2 æˆæƒç­–ç•¥é…ç½®


**ğŸ‘® æˆæƒç­–ç•¥è¯¦è§£**
æˆæƒç­–ç•¥å°±åƒæ˜¯"æƒé™ç®¡ç†å‘˜"ï¼Œå†³å®šå“ªäº›è¯·æ±‚å¯ä»¥è®¿é—®å“ªäº›æœåŠ¡ã€‚

```yaml
# authorization-policy.yaml - æˆæƒç­–ç•¥é…ç½®
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: productpage-authz
  namespace: default
spec:
  # ğŸ¯ åº”ç”¨ç›®æ ‡
  selector:
    matchLabels:
      app: productpage
      
  # ğŸ“œ æˆæƒè§„åˆ™
  rules:
  # è§„åˆ™1ï¼šå…è®¸ç‰¹å®šæ¥æºè®¿é—®
  - from:
    - source:
        principals: ["cluster.local/ns/default/sa/reviews-service"]  # ç‰¹å®šæœåŠ¡è´¦å·
    - source:
        namespaces: ["frontend"]       # ç‰¹å®šå‘½åç©ºé—´
    to:
    - operation:
        methods: ["GET", "POST"]       # å…è®¸çš„HTTPæ–¹æ³•
        paths: ["/api/*"]              # å…è®¸çš„è·¯å¾„
    when:
    - key: request.headers[version]    # æ¡ä»¶ï¼šè¯·æ±‚å¤´ä¸­çš„version
      values: ["v1", "v2"]             # å€¼ä¸ºv1æˆ–v2
      
  # è§„åˆ™2ï¼šåŸºäºJWTå£°æ˜çš„æˆæƒ
  - from:
    - source:
        requestPrincipals: ["https://auth.example.com/user123"]  # JWTä¸»ä½“
    to:
    - operation:
        methods: ["DELETE", "PUT"]     # å…è®¸ç®¡ç†æ“ä½œ
    when:
    - key: request.auth.claims[role]   # JWTä¸­çš„è§’è‰²å£°æ˜
      values: ["admin"]                # å¿…é¡»æ˜¯adminè§’è‰²

  # è§„åˆ™3ï¼šæ—¶é—´çª—å£é™åˆ¶
  - from:
    - source:
        principals: ["*"]              # æ‰€æœ‰æ¥æº
    to:
    - operation:
        methods: ["GET"]               # ä»…GETè¯·æ±‚
    when:
    - key: request.time               # åŸºäºè¯·æ±‚æ—¶é—´
      values: ["09:00-17:00"]         # å·¥ä½œæ—¶é—´å†…
```

### 4.3 å®‰å…¨ç­–ç•¥æœ€ä½³å®è·µ


**ğŸ”§ å®‰å…¨é…ç½®å»ºè®®**
```yaml
# security-best-practices.yaml - å®‰å…¨æœ€ä½³å®è·µé…ç½®
apiVersion: v1
kind: Namespace
metadata:
  name: production
  labels:
    # ğŸ·ï¸ å‘½åç©ºé—´æ ‡ç­¾ - ç”¨äºç­–ç•¥é€‰æ‹©
    security-level: high
    istio-injection: enabled
---
# ğŸ›¡ï¸ å‘½åç©ºé—´çº§åˆ«çš„ä¸¥æ ¼mTLS
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: namespace-mtls
  namespace: production
spec:
  mtls:
    mode: STRICT                       # æ•´ä¸ªå‘½åç©ºé—´å¼ºåˆ¶mTLS
---
# ğŸš« é»˜è®¤æ‹’ç»ç­–ç•¥ï¼ˆç™½åå•æ¨¡å¼ï¼‰
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: default-deny
  namespace: production
spec:
  # ç©ºè§„åˆ™ = æ‹’ç»æ‰€æœ‰è¯·æ±‚
  # å¿…é¡»æ˜¾å¼æ·»åŠ å…è®¸è§„åˆ™æ‰èƒ½è®¿é—®
---
# âœ… å¥åº·æ£€æŸ¥ä¾‹å¤–
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-health-checks
  namespace: production
spec:
  rules:
  - to:
    - operation:
        paths: ["/health", "/ready", "/metrics"]  # å¥åº·æ£€æŸ¥ç«¯ç‚¹
```

---

## 5. ğŸ“Š å¯è§‚æµ‹æ€§é…ç½®å®è·µ


### 5.1 åˆ†å¸ƒå¼è¿½è¸ªé…ç½®


**ğŸ” è¿½è¸ªæ¦‚å¿µç†è§£**
åˆ†å¸ƒå¼è¿½è¸ªå°±åƒæ˜¯"å¿«é€’åŒ…è£¹è·Ÿè¸ª"ï¼Œè®°å½•è¯·æ±‚åœ¨å„ä¸ªæœåŠ¡é—´çš„å®Œæ•´è·¯å¾„ã€‚

```yaml
# tracing-config.yaml - åˆ†å¸ƒå¼è¿½è¸ªé…ç½®
apiVersion: v1
kind: ConfigMap
metadata:
  name: istio-tracing-config
  namespace: istio-system
data:
  mesh: |
    # ğŸ¯ è¿½è¸ªé…ç½®
    defaultConfig:
      # ğŸ·ï¸ è¿½è¸ªé‡‡æ ·ç‡
      tracing:
        sampling: 100.0                # 100%é‡‡æ ·ï¼ˆç”Ÿäº§ç¯å¢ƒå»ºè®®1-10%ï¼‰
        custom_tags:
          user_id:
            header:
              name: "x-user-id"        # ä»è¯·æ±‚å¤´æå–ç”¨æˆ·ID
          request_id:
            header:
              name: "x-request-id"     # è¯·æ±‚è¿½è¸ªID
              
      # ğŸ“Š æŒ‡æ ‡é…ç½®
      proxyMetadata:
        PILOT_ENABLE_WORKLOAD_ENTRY: true
        BOOTSTRAP_XDS_AGENT: true
        
    # ğŸ”Œ æ‰©å±•æä¾›å•†é…ç½®
    extensionProviders:
    # Jaegerè¿½è¸ª
    - name: jaeger
      envoyOtelAls:
        service: jaeger-collector.istio-system.svc.cluster.local
        port: 14268
        
    # Zipkinè¿½è¸ª  
    - name: zipkin
      zipkin:
        service: zipkin.istio-system.svc.cluster.local
        port: 9411
        
    # PrometheusæŒ‡æ ‡
    - name: prometheus
      prometheus:
        service: prometheus.istio-system.svc.cluster.local
        port: 9090
```

**ğŸ“ˆ Jaegeréƒ¨ç½²é…ç½®**
```yaml
# jaeger-deployment.yaml - Jaegerè¿½è¸ªç³»ç»Ÿéƒ¨ç½²
apiVersion: apps/v1
kind: Deployment
metadata:
  name: jaeger
  namespace: istio-system
spec:
  replicas: 1
  selector:
    matchLabels:
      app: jaeger
  template:
    metadata:
      labels:
        app: jaeger
    spec:
      containers:
      - name: jaeger
        image: jaegertracing/all-in-one:1.50
        env:
        # ğŸ—„ï¸ å­˜å‚¨é…ç½®
        - name: COLLECTOR_ZIPKIN_HOST_PORT
          value: ":9411"               # Zipkinå…¼å®¹ç«¯å£
        - name: MEMORY_MAX_TRACES
          value: "50000"               # å†…å­˜ä¸­æœ€å¤§è¿½è¸ªæ•°
        - name: QUERY_BASE_PATH
          value: "/jaeger"             # Web UIåŸºç¡€è·¯å¾„
        ports:
        - containerPort: 16686        # Web UIç«¯å£
          name: http-query
        - containerPort: 14268        # HTTPæ”¶é›†ç«¯å£
          name: http-collector
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "200m"
---
apiVersion: v1
kind: Service
metadata:
  name: jaeger-collector
  namespace: istio-system
spec:
  ports:
  - port: 14268
    targetPort: 14268
    name: http-collector
  - port: 9411
    targetPort: 9411
    name: zipkin
  selector:
    app: jaeger
```

### 5.2 æŒ‡æ ‡ç›‘æ§é…ç½®


**ğŸ“Š Prometheusç›‘æ§é…ç½®**
```yaml
# telemetry-v2.yaml - é¥æµ‹v2é…ç½®
apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
metadata:
  name: telemetry-config
spec:
  values:
    telemetry:
      v2:
        # ğŸ“Š æŒ‡æ ‡é…ç½®
        prometheus:
          configOverride:
            # ğŸ¯ è‡ªå®šä¹‰æŒ‡æ ‡
            metric_relabeling_configs:
            - source_labels: [__name__]
              regex: 'istio_request_total'
              target_label: __name__
              replacement: 'my_request_total'
              
            # ğŸ“ˆ æŒ‡æ ‡ç»´åº¦
            inbound_metric_labels:
              request_protocol: "true"     # è¯·æ±‚åè®®
              response_code: "true"        # å“åº”ç 
              grpc_response_status: "true" # gRPCçŠ¶æ€
              
            outbound_metric_labels:
              request_protocol: "true"
              response_code: "true"
              destination_service_name: "true"  # ç›®æ ‡æœåŠ¡å
              
        # ğŸ” è®¿é—®æ—¥å¿—é…ç½®
        accessLogFile: "/dev/stdout"       # è®¿é—®æ—¥å¿—è¾“å‡ºä½ç½®
        accessLogFormat: |
          [%START_TIME%] "%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%"
          %RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT%
          %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% "%REQ(X-FORWARDED-FOR)%"
          "%REQ(USER-AGENT)%" "%REQ(X-REQUEST-ID)%" "%REQ(:AUTHORITY)%" "%UPSTREAM_HOST%"
```

**ğŸ“Š Grafanaä»ªè¡¨æ¿é…ç½®**
```yaml
# grafana-dashboard-configmap.yaml - Grafanaä»ªè¡¨æ¿
apiVersion: v1
kind: ConfigMap
metadata:
  name: istio-dashboard
  namespace: istio-system
  labels:
    grafana_dashboard: "1"             # Grafanaè‡ªåŠ¨å‘ç°æ ‡ç­¾
data:
  istio-mesh-dashboard.json: |
    {
      "dashboard": {
        "title": "IstioæœåŠ¡ç½‘æ ¼ç›‘æ§",
        "panels": [
          {
            "title": "è¯·æ±‚æˆåŠŸç‡",
            "type": "stat",
            "targets": [
              {
                "expr": "sum(rate(istio_request_total{response_code!~\"5.*\"}[5m])) / sum(rate(istio_request_total[5m])) * 100",
                "legendFormat": "æˆåŠŸç‡"
              }
            ]
          },
          {
            "title": "æœåŠ¡å“åº”æ—¶é—´",
            "type": "graph", 
            "targets": [
              {
                "expr": "histogram_quantile(0.50, sum(rate(istio_request_duration_milliseconds_bucket[5m])) by (le, destination_service_name))",
                "legendFormat": "P50 - {{destination_service_name}}"
              },
              {
                "expr": "histogram_quantile(0.95, sum(rate(istio_request_duration_milliseconds_bucket[5m])) by (le, destination_service_name))",
                "legendFormat": "P95 - {{destination_service_name}}"
              }
            ]
          }
        ]
      }
    }
```

---

## 6. ğŸ¦‹ Linkerdè½»é‡çº§æœåŠ¡ç½‘æ ¼


### 6.1 Linkerdæ ¸å¿ƒç‰¹ç‚¹


**ğŸš€ ä¸ºä»€ä¹ˆé€‰æ‹©Linkerd**
- **âš¡ æè‡´æ€§èƒ½**ï¼šRustç¼–å†™ï¼Œèµ„æºå ç”¨æä½
- **ğŸ¯ ç®€å•æ˜“ç”¨**ï¼šé…ç½®ç®€å•ï¼Œå¼€ç®±å³ç”¨  
- **ğŸ”’ å®‰å…¨é»˜è®¤**ï¼šé»˜è®¤å¯ç”¨mTLSï¼Œé›¶é…ç½®å®‰å…¨
- **ğŸ“Š å¯è§†åŒ–å¼º**ï¼šå†…ç½®ä»ªè¡¨æ¿ï¼Œç›‘æ§ç›´è§‚

### 6.2 Linkerdå®‰è£…é…ç½®


```yaml
# linkerd-installation.yaml - Linkerdå®‰è£…é…ç½®
apiVersion: v1
kind: Namespace
metadata:
  name: linkerd
  labels:
    config.linkerd.io/admission-webhooks: disabled
---
# ğŸ”§ Linkerdæ§åˆ¶å¹³é¢é…ç½®
apiVersion: linkerd.io/v1alpha1
kind: LinkerdConfig
metadata:
  name: linkerd-config
  namespace: linkerd
spec:
  # ğŸŒ å…¨å±€é…ç½®
  global:
    linkerdNamespace: linkerd
    cniEnabled: false                  # æ˜¯å¦å¯ç”¨CNIæ’ä»¶
    identityContext:
      trustDomain: cluster.local       # ä¿¡ä»»åŸŸ
      trustAnchorsPEM: |               # ä¿¡ä»»é”šç‚¹è¯ä¹¦
        -----BEGIN CERTIFICATE-----
        # æ ¹è¯ä¹¦å†…å®¹
        -----END CERTIFICATE-----
        
  # ğŸ›ï¸ ä»£ç†é…ç½®
  proxy:
    image: 
      name: "cr.l5d.io/linkerd/proxy"
      version: "stable-2.14.1"
    resources:
      # ğŸ“Š èµ„æºé™åˆ¶ï¼ˆLinkerdèµ„æºå ç”¨å¾ˆä½ï¼‰
      cpu:
        limit: "1"
        request: "100m"
      memory:
        limit: "250Mi" 
        request: "20Mi"
    # ğŸ” æ—¥å¿—çº§åˆ«
    logLevel: "warn,linkerd=info"
    # ğŸšª ç¦ç”¨ç«¯å£ï¼ˆè·³è¿‡ä»£ç†ï¼‰
    ignoreInboundPorts: "25,443"
    ignoreOutboundPorts: "25,443"
```

### 6.3 Linkerdæµé‡ç®¡ç†


```yaml
# linkerd-traffic-split.yaml - Linkerdé‡‘ä¸é›€éƒ¨ç½²
apiVersion: split.smi-spec.io/v1alpha1
kind: TrafficSplit
metadata:
  name: webapp-canary
  namespace: default
spec:
  # ğŸ¯ ç›®æ ‡æœåŠ¡
  service: webapp
  # âš–ï¸ æµé‡åˆ†é…
  backends:
  - service: webapp-v1
    weight: 90                         # 90%æµé‡åˆ°ç¨³å®šç‰ˆæœ¬
  - service: webapp-v2  
    weight: 10                         # 10%æµé‡åˆ°é‡‘ä¸é›€ç‰ˆæœ¬
---
# ğŸ” æœåŠ¡é…ç½®æ–‡ä»¶ï¼ˆæ€§èƒ½è°ƒä¼˜ï¼‰
apiVersion: linkerd.io/v1alpha2
kind: ServiceProfile
metadata:
  name: webapp.default.svc.cluster.local
  namespace: default
spec:
  # ğŸ›£ï¸ è·¯ç”±é…ç½®
  routes:
  - name: api
    condition:
      method: GET
      pathRegex: "/api/.*"
    # â±ï¸ è¶…æ—¶é…ç½®
    timeout: 30s
    # ğŸ” é‡è¯•é…ç½®
    retryBudget:
      retryRatio: 0.2                  # é‡è¯•ç‡20%
      minRetriesPerSecond: 10          # æœ€å°é‡è¯•æ¬¡æ•°
      ttl: 10s                         # é‡è¯•é¢„ç®—TTL
      
  - name: health
    condition:
      method: GET
      pathRegex: "/health"
    # å¥åº·æ£€æŸ¥è·¯ç”±ä¸é‡è¯•
    isRetryable: false
```

---

## 7. ğŸ¢ Consul Connectä¼ä¸šçº§æ–¹æ¡ˆ


### 7.1 Consul Connectæ¶æ„


**ğŸ—ï¸ Consul Connectç»„ä»¶æ¶æ„**

```
Consul Connectæ¶æ„ï¼š
                    
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         Consulé›†ç¾¤              â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚  â”‚ Server1 â”‚ Server2 â”‚ Server3 â”‚ â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚           â”‚           â”‚
    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”
    â”‚æœåŠ¡A + â”‚   â”‚æœåŠ¡B + â”‚   â”‚æœåŠ¡C + â”‚
    â”‚Envoy   â”‚â—„â”€â”€â–ºEnvoy   â”‚â—„â”€â”€â–ºEnvoy   â”‚
    â”‚Sidecar â”‚   â”‚Sidecar â”‚   â”‚Sidecar â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 Consul Connecté…ç½®


```yaml
# consul-connect-config.yaml - Consul Connecté…ç½®
apiVersion: v1
kind: ConfigMap
metadata:
  name: consul-config
  namespace: consul
data:
  server.hcl: |
    # ğŸŒ ConsulæœåŠ¡å™¨é…ç½®
    datacenter = "dc1"
    data_dir = "/consul/data"
    log_level = "INFO"
    server = true
    
    # ğŸ”— é›†ç¾¤é…ç½®
    bootstrap_expect = 3               # æœŸæœ›æœåŠ¡å™¨æ•°é‡
    retry_join = [
      "consul-0.consul-headless.consul.svc.cluster.local",
      "consul-1.consul-headless.consul.svc.cluster.local", 
      "consul-2.consul-headless.consul.svc.cluster.local"
    ]
    
    # ğŸŒ ç½‘ç»œé…ç½®
    bind_addr = "0.0.0.0"
    client_addr = "0.0.0.0"
    
    # ğŸ”’ Connecté…ç½®
    connect {
      enabled = true                   # å¯ç”¨Connect
      ca_provider = "consul"           # CAæä¾›å•†
      ca_config {
        private_key_type = "ec"        # ç§é’¥ç±»å‹
        private_key_bits = 256         # ç§é’¥ä½æ•°
      }
    }
    
    # ğŸ“Š UIé…ç½®
    ui_config {
      enabled = true                   # å¯ç”¨Web UI
    }
    
    # ğŸ” ACLé…ç½®ï¼ˆå¯é€‰ï¼‰
    acl = {
      enabled = true
      default_policy = "allow"         # é»˜è®¤ç­–ç•¥
      enable_token_persistence = true
    }
```

### 7.3 ConnectæœåŠ¡é…ç½®


```yaml
# consul-connect-service.yaml - ConnectæœåŠ¡æ³¨å†Œ
apiVersion: v1
kind: ConfigMap
metadata:
  name: web-service-config
  namespace: default
data:
  config.hcl: |
    # ğŸ“‹ æœåŠ¡æ³¨å†Œé…ç½®
    services {
      name = "web"
      id = "web-1"
      port = 8080
      
      # ğŸ·ï¸ æœåŠ¡æ ‡ç­¾
      tags = ["v1", "web", "frontend"]
      
      # ğŸ’Š å¥åº·æ£€æŸ¥
      check {
        http = "http://localhost:8080/health"
        interval = "10s"
        timeout = "3s"
      }
      
      # ğŸ”— Connecté…ç½®
      connect {
        sidecar_service {
          port = 20000                 # Envoyç›‘å¬ç«¯å£
          
          # ğŸ¯ ä¸Šæ¸¸æœåŠ¡é…ç½®
          proxy {
            upstreams {
              destination_name = "api"  # ä¸Šæ¸¸æœåŠ¡å
              local_bind_port = 8081   # æœ¬åœ°ç»‘å®šç«¯å£
              
              # âš–ï¸ è´Ÿè½½å‡è¡¡é…ç½®
              config {
                protocol = "http"
                balance_mode = "least_request"
              }
              
              # ğŸ”¥ é™æµé…ç½®
              limits {
                max_connections = 100
                max_pending_requests = 200
                max_requests = 1000
                max_retries = 5
              }
            }
          }
        }
      }
    }
---
# K8sæœåŠ¡å®šä¹‰
apiVersion: v1
kind: Service
metadata:
  name: web-service
  annotations:
    # ğŸ·ï¸ Consul Connectæ³¨è§£
    consul.hashicorp.com/connect-inject: "true"
    consul.hashicorp.com/connect-service-protocol: "http"
    consul.hashicorp.com/connect-service-upstreams: "api:8081"
spec:
  selector:
    app: web
  ports:
  - port: 8080
    targetPort: 8080
```

---

## 8. ğŸ”§ å®æˆ˜éƒ¨ç½²ä¸æ•…éšœæ’æŸ¥


### 8.1 æœåŠ¡ç½‘æ ¼éƒ¨ç½²æ£€æŸ¥æ¸…å•


**âœ… éƒ¨ç½²å‰æ£€æŸ¥**
```bash
# ğŸ” 1. æ£€æŸ¥Kubernetesé›†ç¾¤çŠ¶æ€
kubectl cluster-info
kubectl get nodes
kubectl get pods --all-namespaces

# ğŸ” 2. æ£€æŸ¥èµ„æºé™åˆ¶
kubectl describe nodes | grep -A 5 "Allocated resources"

# ğŸ” 3. æ£€æŸ¥ç½‘ç»œæ’ä»¶
kubectl get pods -n kube-system | grep -E "(flannel|calico|weave|cilium)"

# ğŸ” 4. æ£€æŸ¥å­˜å‚¨ç±»
kubectl get storageclass

# ğŸ” 5. æ£€æŸ¥DNSè§£æ
kubectl run test-pod --image=busybox --restart=Never -- nslookup kubernetes.default
```

**ğŸš€ Istioéƒ¨ç½²æ­¥éª¤**
```bash
# 1ï¸âƒ£ ä¸‹è½½å¹¶å®‰è£…Istio CLI
curl -L https://istio.io/downloadIstio | sh-
cd istio-1.20.0
export PATH=$PWD/bin:$PATH

# 2ï¸âƒ£ é¢„æ£€æŸ¥
istioctl x precheck

# 3ï¸âƒ£ å®‰è£…Istio
istioctl install --set values.defaultRevision=default -y

# 4ï¸âƒ£ éªŒè¯å®‰è£…
kubectl get pods -n istio-system
istioctl proxy-status

# 5ï¸âƒ£ å¯ç”¨æ³¨å…¥
kubectl label namespace default istio-injection=enabled

# 6ï¸âƒ£ éƒ¨ç½²ç¤ºä¾‹åº”ç”¨éªŒè¯
kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml
```

### 8.2 å¸¸è§é—®é¢˜æ’æŸ¥


**ğŸš¨ Sidecaræ³¨å…¥é—®é¢˜**
```bash
# â“ é—®é¢˜ï¼šPodä¸­æ²¡æœ‰Sidecarå®¹å™¨
# ğŸ” æ’æŸ¥æ­¥éª¤ï¼š

# 1. æ£€æŸ¥å‘½åç©ºé—´æ ‡ç­¾
kubectl get namespace default --show-labels

# 2. æ£€æŸ¥æ³¨å…¥å™¨é…ç½®
kubectl get mutatingwebhookconfiguration istio-sidecar-injector -o yaml

# 3. æ£€æŸ¥Podæ³¨è§£
kubectl get pod <pod-name> -o yaml | grep -A 5 -B 5 annotations

# 4. æ‰‹åŠ¨æ³¨å…¥æµ‹è¯•
istioctl kube-inject -f deployment.yaml | kubectl apply -f -

# 5. æŸ¥çœ‹æ³¨å…¥å™¨æ—¥å¿—
kubectl logs -n istio-system deployment/istiod | grep inject
```

**ğŸ”— æœåŠ¡é—´é€šä¿¡é—®é¢˜**
```bash
# â“ é—®é¢˜ï¼šæœåŠ¡æ— æ³•äº’ç›¸è®¿é—®
# ğŸ” æ’æŸ¥æ­¥éª¤ï¼š

# 1. æ£€æŸ¥Envoyé…ç½®åŒæ­¥
istioctl proxy-config cluster <pod-name> -n <namespace>

# 2. æ£€æŸ¥ç«¯ç‚¹å‘ç°
istioctl proxy-config endpoints <pod-name> -n <namespace>

# 3. æ£€æŸ¥ç›‘å¬å™¨
istioctl proxy-config listeners <pod-name> -n <namespace>

# 4. æ£€æŸ¥è·¯ç”±
istioctl proxy-config routes <pod-name> -n <namespace>

# 5. æŸ¥çœ‹Envoyè®¿é—®æ—¥å¿—
kubectl logs <pod-name> -c istio-proxy -f
```

### 8.3 æ€§èƒ½è°ƒä¼˜å»ºè®®


**âš¡ Istioæ€§èƒ½ä¼˜åŒ–é…ç½®**
```yaml
# istio-performance-tuning.yaml - æ€§èƒ½ä¼˜åŒ–é…ç½®
apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
metadata:
  name: performance-config
spec:
  values:
    pilot:
      # ğŸ¯ Pilotæ€§èƒ½è°ƒä¼˜
      env:
        PILOT_PUSH_THROTTLE: 100           # æ¨é€é™æµ
        PILOT_DEBOUNCE_AFTER: 100ms        # é˜²æŠ–å»¶è¿Ÿ
        PILOT_DEBOUNCE_MAX: 10s            # æœ€å¤§é˜²æŠ–æ—¶é—´
        
    proxy:
      # ğŸ”§ ä»£ç†æ€§èƒ½è°ƒä¼˜
      resources:
        requests:
          cpu: 100m
          memory: 128Mi
        limits:
          cpu: 2000m                       # å¢åŠ CPUé™åˆ¶
          memory: 1Gi                      # å¢åŠ å†…å­˜é™åˆ¶
          
  components:
    pilot:
      k8s:
        env:
        # ğŸš€ å¹¶å‘é…ç½®
        - name: PILOT_MAX_WORKLOAD_ENTRIES
          value: "99999"                   # æœ€å¤§å·¥ä½œè´Ÿè½½æ¡ç›®
        - name: PILOT_PUSH_BURST
          value: "100"                     # æ¨é€çªå‘æ•°
        - name: PILOT_PUSH_QPS  
          value: "25"                      # æ¨é€QPSé™åˆ¶
        
        resources:
          requests:
            cpu: 500m                      # å¢åŠ Pilotèµ„æº
            memory: 2Gi
          limits:
            cpu: 1000m
            memory: 4Gi
```

**ğŸ“Š ç›‘æ§å‘Šè­¦é…ç½®**
```yaml
# istio-monitoring-alerts.yaml - ç›‘æ§å‘Šè­¦è§„åˆ™
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: istio-alerts
  namespace: istio-system
spec:
  groups:
  - name: istio.rules
    rules:
    # ğŸš¨ æœåŠ¡å¯ç”¨æ€§å‘Šè­¦
    - alert: IstioServiceUnavailable
      expr: |
        (
          sum(rate(istio_request_total{response_code!~"5.*"}[5m])) 
          / 
          sum(rate(istio_request_total[5m]))
        ) < 0.95
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "æœåŠ¡{{ $labels.destination_service_name }}å¯ç”¨æ€§ä½äº95%"
        
    # â° å“åº”æ—¶é—´å‘Šè­¦  
    - alert: IstioHighResponseTime
      expr: |
        histogram_quantile(0.95, 
          sum(rate(istio_request_duration_milliseconds_bucket[5m])) 
          by (le, destination_service_name)
        ) > 1000
      for: 2m
      labels:
        severity: warning
      annotations:
        summary: "æœåŠ¡{{ $labels.destination_service_name }}å“åº”æ—¶é—´è¿‡é•¿"
        
    # ğŸ”„ PilotåŒæ­¥å‘Šè­¦
    - alert: IstioPilotSyncError
      expr: |
        rate(pilot_k8s_cfg_events_total{event="update", resource="virtualservices"}[5m]) > 10
      for: 1m
      labels:
        severity: warning
      annotations:
        summary: "Piloté…ç½®åŒæ­¥å¼‚å¸¸"
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æœåŠ¡ç½‘æ ¼æœ¬è´¨ï¼šä¸ºå¾®æœåŠ¡é—´é€šä¿¡æä¾›ç»Ÿä¸€çš„åŸºç¡€è®¾æ–½å±‚
ğŸ”¸ Sidecaræ¨¡å¼ï¼šæ¯ä¸ªæœåŠ¡é…å¤‡ä¸“å±ä»£ç†ï¼Œé€æ˜å¤„ç†é€šä¿¡
ğŸ”¸ æ§åˆ¶å¹³é¢ï¼šç»Ÿä¸€ç®¡ç†é…ç½®ï¼Œæ•°æ®å¹³é¢ï¼šå®é™…å¤„ç†æµé‡
ğŸ”¸ æµé‡ç®¡ç†ï¼šé€šè¿‡è™šæ‹ŸæœåŠ¡ã€ç›®æ ‡è§„åˆ™å®ç°æ™ºèƒ½è·¯ç”±
ğŸ”¸ å®‰å…¨ç­–ç•¥ï¼šmTLSè®¤è¯ã€JWTéªŒè¯ã€ç»†ç²’åº¦æˆæƒ
ğŸ”¸ å¯è§‚æµ‹æ€§ï¼šåˆ†å¸ƒå¼è¿½è¸ªã€æŒ‡æ ‡ç›‘æ§ã€è®¿é—®æ—¥å¿—
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ é€‰æ‹©åˆé€‚çš„æœåŠ¡ç½‘æ ¼**
```
Istioé€‚ç”¨åœºæ™¯ï¼š
âœ… å¤§å‹ä¼ä¸šç¯å¢ƒï¼ŒåŠŸèƒ½éœ€æ±‚å¤æ‚
âœ… éœ€è¦ä¸°å¯Œçš„æµé‡ç®¡ç†åŠŸèƒ½  
âœ… æœ‰ä¸“é—¨çš„å¹³å°å·¥ç¨‹å›¢é˜Ÿç»´æŠ¤

Linkerdé€‚ç”¨åœºæ™¯ï¼š
âœ… ä¸­å°å›¢é˜Ÿï¼Œè¿½æ±‚ç®€å•æ˜“ç”¨
âœ… å¯¹æ€§èƒ½æœ‰æè‡´è¦æ±‚
âœ… å¸Œæœ›å¿«é€Ÿä¸Šæ‰‹ï¼Œå‡å°‘ç»´æŠ¤æˆæœ¬

Consul Connecté€‚ç”¨åœºæ™¯ï¼š
âœ… å·²ä½¿ç”¨HashiCorpæŠ€æœ¯æ ˆ
âœ… éœ€è¦è·¨å¹³å°ï¼ˆVM+å®¹å™¨ï¼‰æ”¯æŒ
âœ… ä¼ä¸šçº§æœåŠ¡å‘ç°éœ€æ±‚
```

**ğŸ”¹ æ¸è¿›å¼éƒ¨ç½²ç­–ç•¥**
```
æœåŠ¡ç½‘æ ¼éƒ¨ç½²è·¯å¾„ï¼š
1ï¸âƒ£ å•ä¸ªå‘½åç©ºé—´è¯•ç‚¹ â†’ éªŒè¯å¯è¡Œæ€§
2ï¸âƒ£ éå…³é”®æœåŠ¡æ‰©å±• â†’ ç§¯ç´¯ç»éªŒ  
3ï¸âƒ£ å…³é”®æœåŠ¡ä¸Šçº¿ â†’ å®Œå–„ç›‘æ§
4ï¸âƒ£ å…¨é‡éƒ¨ç½² â†’ ä¼˜åŒ–æ€§èƒ½

é£é™©æ§åˆ¶è¦ç‚¹ï¼š
- ä¿æŒåŸæœ‰ç›‘æ§ç³»ç»Ÿä½œä¸ºå¤‡ä»½
- åˆ¶å®šè¯¦ç»†çš„å›æ»šè®¡åˆ’
- è®¾ç½®åˆç†çš„è¶…æ—¶å’Œé‡è¯•å‚æ•°
- å»ºç«‹å®Œå–„çš„å‘Šè­¦æœºåˆ¶
```

### 9.3 å®è·µåº”ç”¨æŒ‡å¯¼


**ğŸ¯ é…ç½®æœ€ä½³å®è·µ**
- **ğŸ“Š ç›‘æ§ä¼˜å…ˆ**ï¼šéƒ¨ç½²æœåŠ¡ç½‘æ ¼å‰å…ˆå®Œå–„ç›‘æ§ä½“ç³»
- **ğŸ”„ æ¸è¿›è¿­ä»£**ï¼šå…ˆå¯ç”¨åŸºç¡€åŠŸèƒ½ï¼Œå†é€æ­¥æ·»åŠ é«˜çº§ç‰¹æ€§  
- **ğŸ”’ å®‰å…¨é»˜è®¤**ï¼šé»˜è®¤å¯ç”¨mTLSï¼Œæœ€å°æƒé™åŸåˆ™
- **âš–ï¸ æ€§èƒ½å¹³è¡¡**ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚è°ƒæ•´èµ„æºé…ç½®
- **ğŸ“š æ–‡æ¡£å®Œå¤‡**ï¼šè¯¦ç»†è®°å½•é…ç½®å˜æ›´å’Œæ•…éšœå¤„ç†

**ğŸš¨ å¸¸è§é™·é˜±é¿å…**
- **é¿å…è¿‡åº¦é…ç½®**ï¼šä¸è¦ä¸€æ¬¡æ€§å¯ç”¨æ‰€æœ‰åŠŸèƒ½
- **æ³¨æ„ç‰ˆæœ¬å…¼å®¹**ï¼šç¡®ä¿å„ç»„ä»¶ç‰ˆæœ¬åŒ¹é…
- **èµ„æºé¢„ç•™å……è¶³**ï¼šSidecarä¼šå¢åŠ èµ„æºå¼€é”€
- **ç½‘ç»œç­–ç•¥å…¼å®¹**ï¼šä¸ç°æœ‰ç½‘ç»œç­–ç•¥å¯èƒ½å†²çª
- **è¯ä¹¦ç®¡ç†**ï¼šå»ºç«‹å®Œå–„çš„è¯ä¹¦è½®æ¢æœºåˆ¶

### 9.4 æœªæ¥å‘å±•è¶‹åŠ¿


**ğŸš€ æŠ€æœ¯æ¼”è¿›æ–¹å‘**
- **ğŸ¯ æ›´è½»é‡åŒ–**ï¼šå‡å°‘èµ„æºå¼€é”€ï¼Œæå‡æ€§èƒ½
- **ğŸ¤– æ›´æ™ºèƒ½åŒ–**ï¼šAIé©±åŠ¨çš„æµé‡ç®¡ç†å’Œæ•…éšœå¤„ç†
- **ğŸ”— æ›´æ ‡å‡†åŒ–**ï¼šService Mesh Interface(SMI)æ ‡å‡†æ™®åŠ
- **â˜ï¸ æ›´äº‘åŸç”Ÿ**ï¼šä¸Kubernetesæ›´æ·±åº¦é›†æˆ
- **ğŸŒ æ›´å¤šå…ƒåŒ–**ï¼šæ”¯æŒæ›´å¤šåè®®å’Œå¹³å°

**æ ¸å¿ƒè®°å¿†**ï¼š
- æœåŠ¡ç½‘æ ¼è§£å†³å¾®æœåŠ¡é€šä¿¡å¤æ‚åº¦ï¼Œæä¾›ç»Ÿä¸€ç®¡ç†
- Sidecarä»£ç†æ¨¡å¼å®ç°é€æ˜åŒ–æœåŠ¡æ²»ç†
- æ§åˆ¶å¹³é¢ç®¡é…ç½®ï¼Œæ•°æ®å¹³é¢å¤„ç†æµé‡
- å®‰å…¨ã€æµé‡ç®¡ç†ã€å¯è§‚æµ‹æ€§æ˜¯ä¸‰å¤§æ ¸å¿ƒèƒ½åŠ›
- é€‰å‹éœ€è¦ç»“åˆå›¢é˜ŸæŠ€æœ¯æ ˆå’Œä¸šåŠ¡å¤æ‚åº¦
- æ¸è¿›å¼éƒ¨ç½²ï¼Œç›‘æ§å‘Šè­¦ä¸å¯å°‘