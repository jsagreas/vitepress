---
title: 7、Deployment基础操作
---
## 📚 目录

1. [Deployment基础概念](#1-deployment基础概念)
2. [Deployment核心操作命令](#2-deployment核心操作命令)
3. [扩缩容管理](#3-扩缩容管理)
4. [滚动更新与状态查看](#4-滚动更新与状态查看)
5. [服务暴露与网络访问](#5-服务暴露与网络访问)
6. [实践场景与最佳实践](#6-实践场景与最佳实践)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 🚢 Deployment基础概念


### 1.1 什么是Deployment

**通俗理解**：Deployment就像是一个"应用程序管理员"，它负责管理你的应用在Kubernetes集群中的运行状态。

```
现实比喻：
Deployment = 餐厅经理
Pod = 服务员
ReplicaSet = 班次安排表

餐厅经理负责：
- 确保有足够的服务员在工作
- 服务员生病了就找替代的
- 客人多了就增加服务员
- 客人少了就减少服务员
```

### 1.2 Deployment的核心作用

**🎯 主要功能**：
- **副本管理**：确保指定数量的Pod始终运行
- **故障恢复**：Pod挂掉时自动重新创建
- **滚动更新**：无缝升级应用版本
- **回滚支持**：出问题时快速回到上一个版本

### 1.3 Deployment架构关系图

```
Deployment (部署控制器)
    ↓ 管理
ReplicaSet (副本集)
    ↓ 创建
Pod → Pod → Pod (实际运行的应用实例)

工作流程：
1. 你创建Deployment，告诉它要运行什么应用
2. Deployment创建ReplicaSet来管理Pod副本
3. ReplicaSet负责创建和维护指定数量的Pod
4. Pod里运行你的实际应用程序
```

---

## 2. ⚙️ Deployment核心操作命令


### 2.1 创建Deployment

**🔸 基础创建命令**
```bash
kubectl create deployment nginx-app --image=nginx:latest
```

**命令解析**：
- `create deployment`：创建一个新的Deployment
- `nginx-app`：给这个Deployment起个名字
- `--image=nginx:latest`：指定要运行的镜像

> 💡 **新手提示**：这就像告诉Kubernetes"请帮我运行一个叫nginx-app的应用，使用nginx最新版本的镜像"

**🔸 指定副本数创建**
```bash
kubectl create deployment web-server --image=nginx:1.20 --replicas=3
```

**为什么要指定副本数**：
- **高可用**：一个Pod挂了，其他Pod继续服务
- **负载分担**：多个Pod分担用户请求
- **性能提升**：并发处理更多请求

### 2.2 查看Deployment状态


**🔍 列出所有Deployment**
```bash
kubectl get deployments
```

**输出示例**：
```
NAME         READY   UP-TO-DATE   AVAILABLE   AGE
nginx-app    1/1     1            1           5m
web-server   3/3     3            3           2m
```

**字段含义解释**：
- **READY**：`当前运行的Pod数/期望的Pod数`
- **UP-TO-DATE**：已更新到最新版本的Pod数量
- **AVAILABLE**：可用于服务用户请求的Pod数量
- **AGE**：Deployment创建多长时间了

**🔍 查看详细信息**
```bash
kubectl describe deployment nginx-app
```

> 📝 **学习建议**：`describe`命令是调试问题的好帮手，它会告诉你Deployment的所有详细信息，包括事件日志

### 2.3 删除Deployment


**🗑️ 删除指定Deployment**
```bash
kubectl delete deployment nginx-app
```

**⚠️ 重要提醒**：删除Deployment会同时删除它管理的所有Pod，应用就彻底停止了！

---

## 3. 📈 扩缩容管理


### 3.1 手动扩缩容


**🔧 扩容操作**
```bash
# 将nginx-app扩容到5个副本
kubectl scale deployment nginx-app --replicas=5
```

**通俗理解**：
- 原来只有1个"服务员"(Pod)在工作
- 现在客人多了，需要5个"服务员"同时工作
- Kubernetes会自动创建4个新的Pod

**🔧 缩容操作**
```bash
# 将web-server缩容到2个副本
kubectl scale deployment web-server --replicas=2
```

### 3.2 自动扩缩容(HPA)


**🤖 设置自动扩缩容**
```bash
kubectl autoscale deployment nginx-app --cpu-percent=50 --min=1 --max=10
```

**参数详解**：
- `--cpu-percent=50`：当CPU使用率超过50%时触发扩容
- `--min=1`：最少保持1个Pod运行
- `--max=10`：最多扩容到10个Pod

**自动扩缩容工作原理**：
```
CPU使用率监控流程：
用户请求增加 → CPU使用率上升 → 超过50%阈值 
→ HPA自动创建新Pod → 负载分散 → CPU使用率下降

用户请求减少 → CPU使用率下降 → 低于阈值一段时间
→ HPA自动删除多余Pod → 节省资源
```

**🔍 查看自动扩缩器状态**
```bash
kubectl get hpa
```

**输出示例**：
```
NAME        REFERENCE              TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
nginx-app   Deployment/nginx-app   45%/50%   1         10        3          5m
```

> 💡 **实用技巧**：TARGETS显示`当前CPU使用率/目标CPU使用率`，可以看出是否需要扩缩容

---

## 4. 🔄 滚动更新与状态查看


### 4.1 滚动更新状态监控


**📊 查看滚动更新进度**
```bash
kubectl rollout status deployment/nginx-app
```

**输出示例**：
```
Waiting for deployment "nginx-app" rollout to finish: 2 of 3 updated replicas are available...
deployment "nginx-app" successfully rolled out
```

**滚动更新过程图解**：
```
更新前：Pod1 Pod2 Pod3 (旧版本)
        ↓
更新中：Pod1 Pod2 Pod3新 Pod4新 (新旧并存)
        ↓
更新后：Pod1新 Pod2新 Pod3新 (全新版本)

特点：
✅ 服务不中断
✅ 逐步替换旧Pod
✅ 出问题可快速回滚
```

### 4.2 版本管理与注释


**🏷️ 添加版本注释**
```bash
kubectl annotate deployment nginx-app deployment.kubernetes.io/revision=1
```

**注释的实用价值**：
- **版本追踪**：记录每次更新的版本信息
- **回滚参考**：知道要回滚到哪个版本
- **团队协作**：其他人能看懂这个版本的特点

**📋 查看版本历史**
```bash
kubectl rollout history deployment/nginx-app
```

---

## 5. 🌐 服务暴露与网络访问


### 5.1 服务暴露基础


**🔗 暴露Deployment为服务**
```bash
kubectl expose deployment nginx-app --port=80 --type=LoadBalancer
```

**参数解释**：
- `--port=80`：服务监听80端口
- `--type=LoadBalancer`：创建负载均衡器类型的服务

**服务类型对比表**：

| 服务类型 | **使用场景** | **访问方式** | **适用环境** |
|---------|------------|-------------|-------------|
| **ClusterIP** | `集群内部通信` | `集群内IP访问` | `微服务间调用` |
| **NodePort** | `集群外部访问` | `节点IP:端口访问` | `开发测试环境` |
| **LoadBalancer** | `生产环境外部访问` | `云厂商负载均衡器` | `生产环境` |

### 5.2 网络访问验证


**🔍 查看创建的服务**
```bash
kubectl get services
```

**服务访问流程图**：
```
外部用户请求
    ↓
LoadBalancer (云厂商提供)
    ↓
Service (Kubernetes服务)
    ↓
Pod1  Pod2  Pod3 (实际应用)
```

> 📝 **新手常见问题**：如果是本地环境(minikube等)，LoadBalancer类型可能不会分配外部IP，建议使用NodePort类型

---

## 6. 🛠️ 实践场景与最佳实践


### 6.1 常见使用场景


**🎯 场景一：Web应用部署**
```bash
# 1. 创建Web应用
kubectl create deployment webapp --image=nginx:1.20 --replicas=3

# 2. 设置自动扩缩容
kubectl autoscale deployment webapp --cpu-percent=70 --min=2 --max=8

# 3. 暴露服务
kubectl expose deployment webapp --port=80 --type=LoadBalancer
```

**🎯 场景二：微服务架构**
```bash
# API服务
kubectl create deployment api-service --image=node:16 --replicas=2
kubectl expose deployment api-service --port=3000 --type=ClusterIP

# 前端服务  
kubectl create deployment frontend --image=nginx:latest --replicas=3
kubectl expose deployment frontend --port=80 --type=LoadBalancer
```

### 6.2 运维最佳实践


**✅ 推荐做法**：
- **合理设置副本数**：根据实际负载确定初始副本数
- **配置健康检查**：确保Pod状态正常才接收流量
- **使用标签管理**：方便筛选和管理相关资源
- **定期备份配置**：重要应用配置要有备份

**❌ 避免错误**：
- 不要将副本数设置过高浪费资源
- 不要频繁手动扩缩容，优先使用自动扩缩容
- 删除前要确认影响范围

### 6.3 故障排查指南


**🔧 常用排查命令组合**：
```bash
# 1. 查看Deployment状态
kubectl get deployments

# 2. 查看Pod详情
kubectl get pods -l app=nginx-app

# 3. 查看具体错误
kubectl describe deployment nginx-app

# 4. 查看Pod日志
kubectl logs deployment/nginx-app
```

---

## 7. 📋 核心要点总结


### 7.1 命令速查表


| 操作类型 | **命令** | **作用** |
|---------|---------|---------|
| **创建** | `kubectl create deployment [name] --image=[image]` | `创建新的Deployment` |
| **查看** | `kubectl get deployments` | `列出所有Deployment` |
| **详情** | `kubectl describe deployment [name]` | `查看详细信息` |
| **扩缩容** | `kubectl scale deployment [name] --replicas=[number]` | `手动调整副本数` |
| **自动扩缩** | `kubectl autoscale deployment [name] --cpu-percent=50 --min=1 --max=10` | `设置自动扩缩容` |
| **更新状态** | `kubectl rollout status deployment/[name]` | `查看滚动更新进度` |
| **暴露服务** | `kubectl expose deployment [name] --port=80 --type=LoadBalancer` | `创建服务供外部访问` |
| **删除** | `kubectl delete deployment [name]` | `删除Deployment` |

### 7.2 核心概念记忆


**🎯 Deployment三要素**：
- **镜像**：决定运行什么应用
- **副本数**：决定运行多少个实例  
- **更新策略**：决定如何升级应用

**🔄 管理层级关系**：
```
你 → Deployment → ReplicaSet → Pod
指挥   管理员      班次表      工人
```

### 7.3 新手学习路径


**📚 学习顺序建议**：
1. **先理解概念**：搞清楚Deployment是做什么的
2. **基础操作练习**：create、get、describe、delete
3. **扩缩容实践**：手动和自动扩缩容都要试试
4. **服务暴露**：让外部能访问你的应用
5. **故障排查**：学会看日志和状态信息

> 💡 **学习小贴士**：每个命令都要实际操作一遍，理论结合实践才能真正掌握

**🚀 进阶方向**：
- 学习YAML配置文件管理Deployment
- 了解滚动更新和回滚操作
- 掌握多环境部署策略
- 学习监控和日志收集

**核心记忆**：
- Deployment管理应用生命周期，确保服务稳定运行
- 扩缩容解决负载变化，自动化比手动更智能  
- 服务暴露让外部访问应用，选对类型很重要
- 掌握基础命令是运维Kubernetes的第一步