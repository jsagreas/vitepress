---
title: 25、Pod故障诊断
---
## 📚 目录


1. [Pod故障概述](#1-Pod故障概述)
2. [Pod状态诊断基础](#2-Pod状态诊断基础)
3. [获取故障Pod信息](#3-获取故障Pod信息)
4. [Pod事件与日志分析](#4-Pod事件与日志分析)
5. [容器内部调试](#5-容器内部调试)
6. [常见故障场景排查](#6-常见故障场景排查)
7. [故障排查最佳实践](#7-故障排查最佳实践)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🚨 Pod故障概述



### 1.1 什么是Pod故障诊断



**简单理解**：Pod故障诊断就是当你的应用在Kubernetes中运行出问题时，找出问题原因并解决的过程。

```
生活类比：
Pod故障诊断 = 汽车故障检修
┌─────────────────────────┐
│ 汽车抛锚了怎么办？       │
│ 1. 看仪表盘(Pod状态)    │
│ 2. 听发动机声音(日志)   │
│ 3. 检查各个部件(容器)   │
│ 4. 查找问题根源         │
└─────────────────────────┘
```

### 1.2 Pod故障的常见表现



**🔸 Pod状态异常**
- **Pending**：Pod创建了但没有调度到节点上
- **Failed**：Pod启动失败或运行过程中崩溃
- **CrashLoopBackOff**：Pod反复重启失败

**🔸 应用行为异常**
- 服务无法访问
- 响应时间过长
- 数据处理错误

**🔸 资源相关问题**
- CPU/内存使用率异常
- 存储空间不足
- 网络连接问题

### 1.3 故障排查思路



```
Pod故障排查金字塔：

        应用层面
       (日志、进程)
      /           \
    容器层面      网络层面
   (状态、配置)  (连通性、端口)
   /           \           \
 调度层面      资源层面    节点层面
(events)      (CPU/内存)  (节点状态)
```

---

## 2. 📊 Pod状态诊断基础



### 2.1 Pod生命周期状态详解



**Pod状态机制**：
```
Pod创建 → Pending → Running → Succeeded/Failed
           ↓         ↓           ↓
        等待调度   正在运行     已完成/失败
```

**🔸 各状态含义**

| 状态 | 含义 | 常见原因 |
|-----|------|---------|
| **Pending** | `Pod已创建但未运行` | `资源不足、节点选择器不匹配` |
| **Running** | `Pod正在运行` | `正常状态或部分容器异常` |
| **Succeeded** | `Pod成功完成` | `Job类型Pod正常完成` |
| **Failed** | `Pod执行失败` | `容器启动失败、应用崩溃` |
| **Unknown** | `Pod状态未知` | `节点通信异常` |

### 2.2 获取不同状态的Pod



**🔍 获取失败的Pod**
```bash
kubectl get pods --field-selector status.phase=Failed
```
> 💡 **作用**：快速找到所有失败的Pod，是故障排查的第一步

**🔍 获取待调度的Pod**
```bash
kubectl get pods --field-selector status.phase=Pending
```
> 💡 **作用**：找出无法调度的Pod，通常是资源不足或调度约束问题

**🔍 获取所有异常Pod**
```bash
kubectl get pods --field-selector status.phase!=Running,status.phase!=Succeeded
```

### 2.3 Pod详细状态查看



**查看Pod最近状态变化**
```bash
kubectl describe pod [pod-name] | tail -20
```

**🎯 实际应用场景**：
```
问题：开发同事说他的应用启动不了
解决步骤：
1. kubectl get pods  # 看整体状态
2. kubectl describe pod my-app | tail -20  # 看最新事件
3. 根据输出定位具体问题
```

---

## 3. 🔍 获取故障Pod信息



### 3.1 Pod基本信息获取



**快速查看Pod概况**
```bash
# 查看所有Pod状态

kubectl get pods -o wide

# 查看指定Pod详细信息

kubectl get pod [pod-name] -o yaml
```

**🔸 重点关注的信息**
- **Status字段**：Pod当前状态
- **Events字段**：最近发生的事件
- **Containers字段**：容器状态和配置

### 3.2 容器状态精确获取



**获取容器详细状态**
```bash
kubectl get pod [pod-name] -o jsonpath='{.status.containerStatuses[*].state}'
```

**获取Pod条件状态**
```bash
kubectl get pod [pod-name] -o jsonpath='{.status.conditions[*]}'
```

> ⚠️ **新手提示**
> 
> `jsonpath`是一个查询语言，用来从复杂的数据结构中提取特定信息
> 就像在超市里用条形码扫描器，快速找到你要的商品信息

### 3.3 等待Pod状态变化



**等待Pod就绪**
```bash
kubectl wait --for=condition=Ready pod/[pod-name] --timeout=300s
```

**🎬 应用场景剧场**：

**场景：部署新版本应用**
```bash
# 1. 部署应用

kubectl apply -f my-app.yaml

# 2. 等待Pod就绪（最多等5分钟）

kubectl wait --for=condition=Ready pod/my-app --timeout=300s

# 3. 如果超时，立即开始故障排查

if [ $? -ne 0 ]; then
    echo "Pod启动失败，开始排查..."
    kubectl describe pod my-app
fi
```

---

## 4. 📋 Pod事件与日志分析



### 4.1 事件系统理解



**什么是Kubernetes事件**：
> 🏭 **工厂类比**：事件就像工厂里的生产日志，记录每个环节发生了什么

```
Pod生命周期事件链：
创建Pod → 调度事件 → 拉取镜像 → 启动容器 → 健康检查
   ↓         ↓         ↓         ↓         ↓
Scheduled  Pulling   Pulled    Started   Ready
```

### 4.2 查看Pod相关事件



**获取特定Pod的事件**
```bash
kubectl get events --field-selector involvedObject.name=[pod-name]
```

**🔸 事件类型解读**

| 事件类型 | 含义 | 处理建议 |
|---------|------|----------|
| **Scheduled** | `Pod成功调度到节点` | `正常，继续观察` |
| **Pulling** | `正在拉取镜像` | `等待，检查网络` |
| **Failed** | `操作失败` | `重点关注，查看详细信息` |
| **Warning** | `警告信息` | `需要注意，可能影响运行` |

### 4.3 日志分析核心命令



**查看Pod当前日志**
```bash
kubectl logs [pod-name]
```

**查看崩溃容器的日志**
```bash
kubectl logs [pod-name] --previous
```

> 💡 **关键理解**
> 
> `--previous`参数很重要！当容器崩溃重启后，没有这个参数你只能看到新容器的日志，
> 而真正的错误信息在之前崩溃的容器里

**🧪 动手验证**：
```bash
# 1. 找一个经常重启的Pod

kubectl get pods | grep CrashLoop

# 2. 对比两种日志输出的区别

kubectl logs [pod-name]           # 当前容器日志
kubectl logs [pod-name] --previous # 崩溃容器日志
```

### 4.4 多容器Pod日志处理



**指定容器查看日志**
```bash
kubectl logs [pod-name] -c [container-name]
```

**实时跟踪日志**
```bash
kubectl logs -f [pod-name]
```

---

## 5. 🔧 容器内部调试



### 5.1 进入容器内部检查



**进入容器执行命令**
```bash
kubectl exec -it [pod-name] -- /bin/bash
```

> 🎯 **一句话精华**
> 
> `kubectl exec`就像远程桌面，让你可以直接进入容器内部操作

### 5.2 容器内部状态检查



**查看容器内进程**
```bash
kubectl exec -it [pod-name] -- ps aux
```

**查看网络连接状态**
```bash
kubectl exec -it [pod-name] -- netstat -tlnp
```

**🔸 网络连接状态解读**
- **LISTEN**：端口正在监听，应用启动正常
- **ESTABLISHED**：有活跃连接
- **TIME_WAIT**：连接关闭中

### 5.3 容器资源使用情况



**查看容器内存使用**
```bash
kubectl exec -it [pod-name] -- free -h
```

**查看磁盘使用情况**
```bash
kubectl exec -it [pod-name] -- df -h
```

**🤔 思考题**：
- 如果容器内存使用率很高，但Pod没有被OOMKilled，可能是什么原因？
- 容器内磁盘满了会导致什么问题？

---

## 6. 🚨 常见故障场景排查



### 6.1 Pod一直处于Pending状态



**🔸 故障现象**：
```bash
NAME     READY   STATUS    RESTARTS   AGE
my-app   0/1     Pending   0          5m
```

**🔍 排查步骤**：

```
排查流程：
kubectl describe pod my-app
     ↓
查看Events部分
     ↓
常见原因分析：
├── 资源不足 → 检查CPU/内存限制
├── 节点选择器不匹配 → 检查nodeSelector
├── 存储挂载问题 → 检查PVC状态
└── 亲和性规则冲突 → 检查affinity配置
```

### 6.2 Pod频繁重启 (CrashLoopBackOff)



**🔸 故障现象**：
```bash
NAME     READY   STATUS             RESTARTS   AGE
my-app   0/1     CrashLoopBackOff   5          10m
```

**🔍 排查思路**：
1. **查看崩溃前的日志**
   ```bash
   kubectl logs my-app --previous
   ```

2. **检查容器配置问题**
   - 镜像是否正确
   - 启动命令是否正确
   - 环境变量是否缺失

3. **资源限制检查**
   - 内存是否超限
   - CPU配额是否合理

### 6.3 Pod Running但服务不可访问



**🔍 系统化排查法**：

```
网络连通性检查清单：
□ Pod IP是否可访问
□ Service配置是否正确  
□ 端口映射是否匹配
□ 防火墙规则检查
□ DNS解析是否正常
```

**实用检查命令组合**：
```bash
# 1. 检查Pod网络

kubectl get pod my-app -o wide

# 2. 检查Service配置

kubectl get svc my-service -o yaml

# 3. 测试网络连通性

kubectl exec -it test-pod -- curl http://my-app:8080
```

### 6.4 资源配额相关问题



**检查资源使用情况**
```bash
kubectl top pod [pod-name]
kubectl describe node [node-name]
```

**❌ 常见误区**：
- 误区1：认为设置很高的资源限制就万无一失
- ✅ 正确理解：合理设置限制，避免资源浪费和调度问题

---

## 7. 🛠️ 故障排查最佳实践



### 7.1 故障排查工具链



**🔧 基础工具包**：
```bash
# 快速状态检查

alias kgp='kubectl get pods'
alias kgs='kubectl get svc'
alias kgn='kubectl get nodes'

# 快速描述资源

alias kdp='kubectl describe pod'
alias kds='kubectl describe svc'

# 快速查看日志

alias klf='kubectl logs -f'
```

### 7.2 系统化排查流程



```
标准故障排查SOP：

第1步：快速评估
├── kubectl get pods -o wide
├── kubectl get events --sort-by=.metadata.creationTimestamp
└── kubectl get nodes

第2步：深入分析  
├── kubectl describe pod [问题pod]
├── kubectl logs [问题pod] --previous
└── kubectl exec -it [问题pod] -- [检查命令]

第3步：定位根因
├── 检查配置文件
├── 检查依赖服务
└── 检查基础设施

第4步：验证修复
├── 重新部署
├── 监控状态
└── 功能测试
```

### 7.3 预防性措施



**🔴 必须掌握**：
- 设置合理的资源限制
- 配置健康检查
- 使用多副本部署
- 监控关键指标

**📊 掌握度自评**：
```
理论理解：⭐⭐⭐⭐⭐ (5/5)
实践能力：⭐⭐⭐⭐☆ (4/5)
```

### 7.4 故障记录与总结



**建议记录格式**：
```markdown
# 故障报告


- **时间**：2024-01-15 10:30
- **现象**：Pod无法启动，一直Pending
- **原因**：节点CPU资源不足
- **解决**：调整资源请求值
- **预防**：增加节点监控告警
```

---

## 8. 📋 核心要点总结



### 8.1 必须掌握的核心命令



```
🔸 状态检查命令
kubectl get pods --field-selector status.phase=Failed
kubectl get pods --field-selector status.phase=Pending
kubectl describe pod [pod-name] | tail -20

🔸 事件和日志命令
kubectl get events --field-selector involvedObject.name=[pod-name]
kubectl logs [pod-name] --previous
kubectl logs -f [pod-name]

🔸 容器调试命令
kubectl exec -it [pod-name] -- /bin/bash
kubectl exec -it [pod-name] -- ps aux
kubectl exec -it [pod-name] -- netstat -tlnp

🔸 状态监控命令
kubectl wait --for=condition=Ready pod/[pod-name] --timeout=300s
kubectl get pod [pod-name] -o jsonpath='{.status.containerStatuses[*].state}'
```

### 8.2 关键理解要点



**🔹 Pod状态理解**
- Pending = 等待调度，检查资源和约束
- CrashLoopBackOff = 反复崩溃，查看--previous日志
- Running但不可访问 = 网络或配置问题

**🔹 日志分析技巧**
- 当前日志 vs 崩溃前日志的区别
- 事件时间线分析方法
- 多容器Pod的日志分离

**🔹 系统化排查思路**
- 从现象到根因的逻辑链条
- 工具组合使用的效率
- 预防性措施的重要性

### 8.3 实际应用价值



**🎯 业务场景应用**：
- **生产环境故障**：快速定位问题，减少停机时间
- **开发调试**：提高开发效率，快速验证修改
- **运维监控**：建立完善的故障处理流程
- **团队协作**：标准化的排查方法，提升团队效率

### 8.4 学习进阶路径



**📖 相关知识连接**：
- 深入学习：[Kubernetes网络原理](#)
- 实践项目：[搭建监控告警系统](#)
- 高级技巧：[性能调优与优化](#)

**✅ 本节检查清单**：
- [ ] 能快速找到异常状态的Pod
- [ ] 会分析Pod事件和日志信息
- [ ] 能进入容器内部进行调试
- [ ] 掌握常见故障的排查方法
- [ ] 建立系统化的故障处理流程

**🧠 记忆锚点**：
- 看到Pod异常先describe，Events和Status是关键
- 容器崩溃看--previous日志，当前日志可能没用
- 网络问题分层检查：Pod → Service → Ingress
- 排查故障要系统化，不能头痛医头脚痛医脚

**🎯 一句话精华**：
Pod故障排查就是当个"数字侦探"，用kubectl命令收集线索，用逻辑思维找出真相！