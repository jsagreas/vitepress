---
title: 27、应用性能分析
---
## 📚 目录

1. [性能监控基础概念](#1-性能监控基础概念)
2. [容器资源使用监控](#2-容器资源使用监控)
3. [Pod内部性能分析](#3-pod内部性能分析)
4. [节点资源监控与分析](#4-节点资源监控与分析)
5. [自动扩缩容配置与监控](#5-自动扩缩容配置与监控)
6. [故障排查实战技巧](#6-故障排查实战技巧)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 🔍 性能监控基础概念


### 1.1 什么是应用性能分析


**通俗理解**：就像体检一样，我们要定期检查应用程序的"身体状况"

```
现实生活类比：
体检项目          →    Kubernetes性能监控
血压心率          →    CPU使用率
体重身高          →    内存占用
血液检查          →    网络IO状态
肺活量            →    磁盘读写性能
```

**🔸 核心监控指标**
- **CPU使用率**：应用程序占用处理器的百分比
- **内存占用**：应用使用的RAM内存大小
- **磁盘IO**：读写磁盘文件的速度和频率
- **网络IO**：网络数据传输的速度和流量
- **Pod状态**：容器运行是否正常

> 💡 **新手要点**：性能分析就是找出应用程序"不舒服"的地方，然后对症下药

### 1.2 为什么需要性能分析


**实际场景举例**：
- 网站突然变慢 → 可能CPU占用过高
- 应用经常崩溃 → 可能内存不够用
- 数据保存失败 → 可能磁盘空间满了
- 用户访问超时 → 可能网络有问题

**性能分析的价值**：
```
📊 及时发现问题    ⇒    避免系统故障
📈 优化资源配置    ⇒    节省服务器成本  
🎯 提升用户体验    ⇒    网站响应更快
🔧 预防性维护      ⇒    问题未发生先解决
```

---

## 2. 📊 容器资源使用监控


### 2.1 查看Pod整体资源使用


**核心命令**：`kubectl top pod`

```bash
# 查看所有Pod的资源使用情况
kubectl top pod

# 查看特定Pod的资源使用
kubectl top pod my-app-pod

# 查看所有命名空间的Pod资源使用
kubectl top pod --all-namespaces
```

**命令输出解读**：
```
NAME           CPU(cores)   MEMORY(bytes)
nginx-pod      10m          64Mi
mysql-pod      150m         512Mi
redis-pod      5m           32Mi
```

**🔸 输出含义说明**：
- **CPU(cores)**：CPU使用量，`10m`表示0.01个CPU核心
- **MEMORY(bytes)**：内存使用量，`64Mi`表示64兆字节
- **m单位**：millicore，1000m = 1个完整CPU核心
- **Mi单位**：Mebibyte，1Mi = 1024KB

> 💭 **理解技巧**：把CPU想象成工人，1个core就是1个工人，100m就是0.1个工人的工作量

### 2.2 查看容器级别资源使用


**核心命令**：`kubectl top pod --containers`

```bash
# 查看Pod内每个容器的资源使用
kubectl top pod my-app-pod --containers

# 实时监控容器资源变化
watch kubectl top pod my-app-pod --containers
```

**实际使用场景**：
```
多容器Pod结构：
┌─────────────────┐
│   my-app-pod    │
├─────────────────┤
│  nginx容器      │ ← Web服务器
│  php容器        │ ← 应用逻辑  
│  mysql容器      │ ← 数据库
└─────────────────┘

通过容器级监控，能发现哪个容器最耗资源
```

### 2.3 查看Pod资源限制配置


**核心命令**：`kubectl get pod -o jsonpath`

```bash
# 查看Pod的资源限制配置
kubectl get pod my-app-pod -o jsonpath='{.spec.containers[*].resources}'

# 更友好的格式显示
kubectl get pod my-app-pod -o yaml | grep -A 10 resources
```

**配置示例解读**：
```yaml
resources:
  requests:      # 最小资源保证
    cpu: 100m    # 保证0.1个CPU核心
    memory: 128Mi # 保证128MB内存
  limits:        # 最大资源限制
    cpu: 500m    # 最多用0.5个CPU核心  
    memory: 512Mi # 最多用512MB内存
```

**🔸 requests vs limits 通俗解释**：
- **requests**：就像预定座位，系统保证给你这么多资源
- **limits**：就像限速标志，超过这个限制就会被约束

---

## 3. 🖥️ Pod内部性能分析


### 3.1 进入容器查看系统状态


**核心命令**：`kubectl exec -it`

```bash
# 进入Pod内部执行命令
kubectl exec -it my-app-pod -- bash

# 如果Pod有多个容器，指定容器名
kubectl exec -it my-app-pod -c nginx-container -- bash

# 直接执行单个命令不进入交互模式
kubectl exec my-app-pod -- ps aux
```

> 💡 **新手提醒**：`-it`参数很重要，`-i`表示交互模式，`-t`表示分配伪终端

### 3.2 查看容器内进程状态


**核心命令**：`kubectl exec -it [pod-name] -- top`

```bash
# 查看Pod内CPU使用最高的进程
kubectl exec -it nginx-pod -- top

# 按内存使用排序
kubectl exec -it nginx-pod -- top -o %MEM

# 只显示前5个进程
kubectl exec -it nginx-pod -- top -n 1 -b | head -12
```

**top命令输出解读**：
```
PID  USER  %CPU %MEM    VSZ    RSS  COMMAND
1    root   0.1  0.5   2048   1024  nginx
15   root   0.0  0.2   1024    512  bash
```

**字段含义**：
- **PID**：进程ID号
- **%CPU**：CPU使用百分比
- **%MEM**：内存使用百分比  
- **VSZ**：虚拟内存大小
- **RSS**：实际物理内存使用
- **COMMAND**：进程名称

### 3.3 查看内存使用详情


**核心命令**：`kubectl exec -it [pod-name] -- free -h`

```bash
# 以人类可读格式显示内存使用
kubectl exec -it mysql-pod -- free -h

# 持续监控内存变化
kubectl exec -it mysql-pod -- watch -n 2 'free -h'
```

**输出示例解读**：
```
              total        used        free      shared
Mem:          2.0Gi       1.2Gi       800Mi        16Mi
Swap:         1.0Gi       100Mi       900Mi
```

**通俗解释**：
- **total**：总内存 = 服务器总共有多少内存
- **used**：已用内存 = 正在使用的内存  
- **free**：空闲内存 = 还没使用的内存
- **Swap**：交换分区 = 硬盘当内存用（比较慢）

### 3.4 查看磁盘使用情况


**核心命令**：`kubectl exec -it [pod-name] -- df -h`

```bash
# 查看磁盘空间使用
kubectl exec -it app-pod -- df -h

# 查看inode使用情况（文件数量限制）
kubectl exec -it app-pod -- df -i
```

**输出解读**：
```
Filesystem      Size  Used Avail Use% Mounted on
/dev/sda1       20G   12G   8.0G  60%  /
tmpfs           1.0G     0  1.0G   0%  /tmp
```

**🔸 关键指标说明**：
- **Size**：分区总大小
- **Used**：已使用空间
- **Avail**：可用空间
- **Use%**：使用百分比（超过80%需要注意）

### 3.5 查看IO统计信息


**核心命令**：`kubectl exec -it [pod-name] -- iostat`

```bash
# 查看IO统计（需要先安装sysstat包）
kubectl exec -it database-pod -- iostat -x 1 5

# 简单查看IO状态
kubectl exec -it database-pod -- iotop -o
```

**IO指标含义**：
- **r/s**：每秒读取次数
- **w/s**：每秒写入次数  
- **rkB/s**：每秒读取KB数
- **wkB/s**：每秒写入KB数
- **%util**：设备利用率（接近100%说明很忙）

---

## 4. 🖧 节点资源监控与分析


### 4.1 查看节点资源使用


**核心命令**：`kubectl top node`

```bash
# 查看所有节点资源使用
kubectl top node

# 查看特定节点
kubectl top node worker-node-1

# 按CPU使用率排序
kubectl top node --sort-by=cpu
```

**节点监控架构图**：
```
Kubernetes集群架构
┌──────────────────────────────────────┐
│             Master Node              │
├──────────────────────────────────────┤
│         Worker Node 1                │
│  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐    │
│  │Pod1 │ │Pod2 │ │Pod3 │ │Pod4 │    │ ← 监控所有Pod资源
│  └─────┘ └─────┘ └─────┘ └─────┘    │
├──────────────────────────────────────┤
│         Worker Node 2                │
│  ┌─────┐ ┌─────┐ ┌─────┐             │
│  │Pod5 │ │Pod6 │ │Pod7 │             │
│  └─────┘ └─────┘ └─────┘             │
└──────────────────────────────────────┘
```

### 4.2 查看节点上运行的Pod


**核心命令**：`kubectl describe node`

```bash
# 查看节点详细信息，包括运行的Pod
kubectl describe node worker-node-1 | grep -A 10 "Non-terminated Pods"

# 更简洁的显示
kubectl get pod --all-namespaces -o wide --field-selector spec.nodeName=worker-node-1
```

**节点Pod分布示例**：
```
Node: worker-node-1 (Total: 4 Pods)
├── kube-system/
│   ├── kube-proxy-abc123      (CPU: 10m, Memory: 64Mi)
│   └── coredns-def456         (CPU: 5m,  Memory: 32Mi)
├── default/
│   ├── nginx-789              (CPU: 50m, Memory: 128Mi)
│   └── mysql-101112           (CPU: 200m, Memory: 512Mi)
```

### 4.3 节点资源分配分析


**资源分配计算公式**：
```
节点总资源 = 系统预留 + Pod请求资源 + 可分配资源

实例分析：
节点总CPU: 4核心 (4000m)
├── 系统预留: 500m      (Kubelet、系统进程)
├── Pod requests: 2000m  (所有Pod的requests总和)  
└── 可分配: 1500m       (还能调度的资源)
```

**🔸 资源压力等级**：
- **🟢 健康**：资源使用 < 60%
- **🟡 注意**：资源使用 60% - 80%  
- **🔴 告警**：资源使用 > 80%
- **⚫ 危险**：资源使用 > 95%

---

## 5. 📈 自动扩缩容配置与监控


### 5.1 查看水平Pod自动扩缩器


**核心命令**：`kubectl get hpa`

```bash
# 查看所有HPA配置
kubectl get hpa

# 查看特定应用的HPA
kubectl get hpa my-app-hpa

# 实时监控HPA状态变化
watch kubectl get hpa
```

**HPA状态解读**：
```
NAME         REFERENCE             TARGETS   MINPODS   MAXPODS   REPLICAS
my-app-hpa   Deployment/my-app     15%/50%   2         10        3

解释：
- REFERENCE: 监控的目标(my-app这个Deployment)
- TARGETS: 当前CPU使用15%，目标50% 
- MINPODS: 最少保持2个Pod
- MAXPODS: 最多扩到10个Pod
- REPLICAS: 当前运行3个Pod
```

### 5.2 查看HPA详细信息


**核心命令**：`kubectl describe hpa`

```bash
# 查看HPA详细配置和事件
kubectl describe hpa my-app-hpa

# 查看HPA扩缩容历史事件
kubectl get events --field-selector involvedObject.name=my-app-hpa
```

**HPA工作原理图**：
```
自动扩缩容工作流程

监控指标 → HPA控制器 → 调整副本数 → 重新分布负载
    ↑                                      ↓
    │                                      ▼
CPU>50% ←─── 负载增加 ←─── 更多Pod ←─── 扩容决策
    │                          │
    │                          ▼
CPU<30% ←─── 负载减少 ←─── 更少Pod ←─── 缩容决策
```

### 5.3 HPA配置示例解读


**基本HPA配置**：
```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: my-app-hpa
spec:
  scaleTargetRef:           # 要扩缩容的目标
    apiVersion: apps/v1
    kind: Deployment
    name: my-app
  minReplicas: 2            # 最少Pod数量
  maxReplicas: 10           # 最多Pod数量  
  metrics:                  # 扩缩容指标
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 50  # CPU使用率50%时触发扩容
```

**🔸 扩缩容触发条件**：
```
扩容触发：当前CPU使用率 > 50%
缩容触发：当前CPU使用率 < 30% (通常是目标值的60%)
冷却时间：扩容后等待3分钟，缩容后等待5分钟
```

---

## 6. 🔧 故障排查实战技巧


### 6.1 调度失败问题排查


**核心命令**：`kubectl get events --field-selector`

```bash
# 查看调度失败的事件
kubectl get events --field-selector reason=FailedScheduling

# 查看特定Pod的调度事件
kubectl get events --field-selector involvedObject.name=my-pod

# 按时间排序查看事件
kubectl get events --sort-by='.lastTimestamp'
```

**常见调度失败原因**：

| 错误信息 | **通俗解释** | **解决方法** |
|---------|-------------|-------------|
| `Insufficient cpu` | CPU不够用了 | 增加节点或减少CPU请求 |
| `Insufficient memory` | 内存不够用了 | 增加节点或减少内存请求 |
| `No nodes available` | 没有可用节点 | 检查节点状态，移除污点 |
| `MatchNodeSelector` | 节点选择器不匹配 | 修改nodeSelector或节点标签 |

### 6.2 Pod性能问题诊断流程


**🔸 标准诊断流程**：
```
Step 1: 查看Pod状态
└── kubectl get pod -o wide

Step 2: 查看Pod事件  
└── kubectl describe pod [pod-name]

Step 3: 查看资源使用
└── kubectl top pod [pod-name] --containers

Step 4: 进入容器诊断
└── kubectl exec -it [pod-name] -- bash

Step 5: 查看应用日志
└── kubectl logs [pod-name] -f
```

### 6.3 性能瓶颈快速定位


**🎯 快速检查清单**：

```
① CPU瓶颈检查：
kubectl top pod --sort-by=cpu | head -10

② 内存瓶颈检查：  
kubectl top pod --sort-by=memory | head -10

③ 磁盘空间检查：
kubectl exec -it [pod] -- df -h | grep -E "(9[0-9]%|100%)"

④ 网络连接检查：
kubectl exec -it [pod] -- netstat -tlnp

⑤ 进程状态检查：
kubectl exec -it [pod] -- ps aux --sort=-%cpu | head -10
```

### 6.4 常见性能问题与解决方案


**问题场景分析**：

**🔸 场景1：Pod启动慢**
```
诊断步骤：
1. kubectl describe pod → 查看镜像拉取时间
2. kubectl get events → 查看调度耗时
3. kubectl logs → 查看应用启动日志

常见原因：
- 镜像太大，拉取时间长
- 资源限制太低，启动缓慢  
- 依赖服务未就绪
```

**🔸 场景2：应用响应慢**
```
诊断步骤：
1. kubectl top pod → 查看资源使用
2. kubectl exec -- top → 查看进程状态
3. kubectl exec -- netstat → 查看网络连接

优化建议：
- 增加CPU/内存limits
- 优化应用代码逻辑
- 配置健康检查探针
```

---

## 7. 📋 核心要点总结


### 7.1 必须掌握的监控命令


**🔸 基础监控三剑客**：
```bash
kubectl top pod          # Pod资源使用概览
kubectl top node         # 节点资源使用概览  
kubectl describe pod     # Pod详细状态和事件
```

**🔸 深入分析必备**：
```bash
kubectl exec -it [pod] -- top      # 容器内进程状态
kubectl exec -it [pod] -- free -h  # 内存使用详情
kubectl exec -it [pod] -- df -h    # 磁盘空间使用
kubectl get events                 # 集群事件历史
```

### 7.2 性能分析关键指标


**🎯 CPU监控要点**：
- **requests**: 保证分配的CPU资源
- **limits**: 限制最大CPU使用
- **实际使用**: 通过`top`命令查看
- **告警阈值**: >80%需要关注

**🎯 内存监控要点**：  
- **requests**: 保证分配的内存
- **limits**: 限制最大内存使用
- **OOM风险**: 超过limits会被杀掉
- **告警阈值**: >85%需要关注

**🎯 磁盘监控要点**：
- **存储空间**: 磁盘使用率>80%告警
- **inode数量**: 文件数量限制
- **IO性能**: 读写速度和IOPS
- **持久化存储**: PV/PVC使用情况

### 7.3 故障排查思维导图


```
性能问题排查路径

Pod异常 → 查看状态 → 正常运行？
    ↓           ↙        ↘
资源不足    事件检查    进入容器
    ↓           ↓        ↓
扩容/优化   调度问题    系统诊断
    ↓           ↓        ↓
HPA配置    节点状态    应用优化
```

### 7.4 实战最佳实践


**🔸 监控设置建议**：
```
生产环境必备：
✅ 设置合理的requests和limits
✅ 配置HPA自动扩缩容
✅ 监控关键指标（CPU、内存、磁盘）
✅ 设置告警阈值和通知
✅ 定期检查节点资源分配
```

**🔸 性能优化策略**：
```
应用层优化：
- 代码逻辑优化
- 数据库查询优化  
- 缓存策略配置
- 连接池调优

资源层优化：
- 合理设置资源limits
- 使用Node亲和性调度
- 配置Pod反亲和性
- 优化镜像大小
```

### 7.5 新手学习建议


**📚 学习路径**：
```
第一步：掌握基本命令
├── kubectl top (资源监控)
├── kubectl describe (状态查看)
└── kubectl exec (进入诊断)

第二步：理解监控指标
├── CPU/内存/磁盘概念
├── requests/limits含义  
└── 性能瓶颈识别

第三步：实践故障排查
├── 模拟性能问题
├── 使用诊断命令
└── 分析解决方案

第四步：优化和自动化
├── HPA配置
├── 监控告警
└── 持续优化
```

**💡 记忆要点**：
- 性能监控是预防问题，不是解决问题
- 先看整体再看细节，先看状态再看指标  
- 诊断要有步骤，解决要有依据
- 优化要基于监控数据，不能靠猜测

**核心记忆口诀**：
- 监控先看top命令，状态要用describe  
- 进入容器查细节，事件日志找根源
- CPU内存磁盘网络，四大指标要齐全
- 问题诊断有步骤，解决优化靠数据