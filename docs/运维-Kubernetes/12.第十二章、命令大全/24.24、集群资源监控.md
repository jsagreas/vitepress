---
title: 24、集群资源监控
---
## 📚 目录

1. [集群监控概述](#1-集群监控概述)
2. [节点资源监控](#2-节点资源监控)
3. [Pod资源监控](#3-Pod资源监控)
4. [API资源查询](#4-API资源查询)
5. [资源字段说明](#5-资源字段说明)
6. [全局资源查看](#6-全局资源查看)
7. [监控最佳实践](#7-监控最佳实践)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🔍 集群监控概述


### 1.1 什么是Kubernetes集群监控


**通俗理解**：就像医生给病人做体检一样，我们需要定期检查Kubernetes集群的"健康状况"

```
现实生活类比：
医生体检 → 测量血压、心率、体温
集群监控 → 查看CPU、内存、网络使用情况

目的都是：及时发现问题，预防故障
```

**🎯 监控的核心价值**：
- **及时发现问题**：在故障发生前就能察觉异常
- **资源优化**：了解哪些节点负载高，哪些资源浪费了
- **容量规划**：知道什么时候需要扩容或缩容
- **性能调优**：找出性能瓶颈所在

### 1.2 Kubernetes监控体系架构


```
监控数据来源层次图：
┌─────────────────────────────────────┐
│           用户查询层                │ ← kubectl top, Dashboard
├─────────────────────────────────────┤
│         Metrics API层              │ ← /apis/metrics.k8s.io
├─────────────────────────────────────┤
│       Metrics Server层            │ ← 收集和聚合指标
├─────────────────────────────────────┤
│         kubelet层                  │ ← 节点代理收集数据
├─────────────────────────────────────┤
│       容器运行时层                  │ ← Docker, containerd
└─────────────────────────────────────┘
```

**💡 数据流程**：
1. **容器运行时**收集容器资源使用情况
2. **kubelet**从运行时获取数据并暴露API
3. **Metrics Server**定期从所有kubelet收集数据
4. **Metrics API**提供标准化的查询接口
5. **kubectl**通过API获取数据展示给用户

---

## 2. 📊 节点资源监控


### 2.1 基础节点监控命令


**🔸 查看所有节点资源使用情况**

```bash
# 基础查看命令 - 就像看所有服务器的"任务管理器"
kubectl top nodes
```

**输出示例解读**：
```
NAME           CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%   
master-node    250m         12%    1.2Gi           30%       
worker-1       1.5          75%    3.1Gi           77%       
worker-2       500m         25%    2.0Gi           50%       
```

**📖 字段含义通俗解释**：
- **CPU(cores)**：正在使用的CPU核心数（250m = 0.25核）
- **CPU%**：占总CPU的百分比
- **MEMORY(bytes)**：正在使用的内存大小  
- **MEMORY%**：占总内存的百分比

### 2.2 按资源使用排序


**🔸 按CPU使用率排序** - 找出CPU最忙的节点

```bash
# 按CPU使用量排序 - 找出"最忙"的服务器
kubectl top nodes --sort-by=cpu

# 实际场景：当系统变慢时，快速找出CPU瓶颈在哪个节点
```

**🔸 按内存使用率排序** - 找出内存消耗最大的节点

```bash
# 按内存使用量排序 - 找出"最耗内存"的服务器  
kubectl top nodes --sort-by=memory

# 实际场景：当收到内存告警时，快速定位哪个节点内存不够了
```

**💡 实用技巧**：
```bash
# 组合使用：先看整体，再看具体
kubectl top nodes                    # 1. 总览所有节点状态
kubectl top nodes --sort-by=cpu      # 2. 找出CPU最高的
kubectl top nodes --sort-by=memory   # 3. 找出内存最高的
```

### 2.3 获取原始节点指标数据


**🔸 访问原始Metrics API**

```bash
# 获取节点原始指标数据 - 就像直接看"体检报告"原始数据
kubectl get --raw /apis/metrics.k8s.io/v1beta1/nodes
```

**实际用途**：
- **自动化脚本**：程序需要解析精确的数值数据
- **深度分析**：需要更详细的指标信息
- **故障排查**：当top命令显示异常时，查看原始数据确认

**输出数据结构**：
```json
{
  "items": [
    {
      "metadata": {"name": "worker-1"},
      "usage": {
        "cpu": "1500m",     // 精确的CPU使用量
        "memory": "3Gi"     // 精确的内存使用量
      }
    }
  ]
}
```

---

## 3. 🚀 Pod资源监控


### 3.1 Pod监控基础命令


**🔸 查看所有Pod资源使用**

```bash
# 查看所有Pod的资源使用 - 就像看每个应用程序的资源占用
kubectl top pods

# 查看指定命名空间的Pod
kubectl top pods -n default
kubectl top pods -n kube-system
```

**📊 输出示例**：
```
NAME                    CPU(cores)   MEMORY(bytes)   
nginx-7d8b49557c-abc123  10m         32Mi            
mysql-6b8c7d4f5a-def456  50m         256Mi           
redis-8a9b6c5d4e-ghi789  15m         64Mi            
```

**🎯 理解要点**：
- **10m**：表示使用0.01个CPU核心（很少）
- **50m**：表示使用0.05个CPU核心（中等）
- **256Mi**：表示使用256MB内存

### 3.2 Pod监控进阶用法


**🔸 按资源使用排序Pod**

```bash
# 找出CPU使用最高的Pod - 找出"最耗CPU"的应用
kubectl top pods --sort-by=cpu

# 找出内存使用最高的Pod - 找出"最耗内存"的应用  
kubectl top pods --sort-by=memory

# 查看所有命名空间的Pod并排序
kubectl top pods --all-namespaces --sort-by=cpu
```

**🔸 获取Pod原始指标**

```bash
# 获取Pod原始监控数据
kubectl get --raw /apis/metrics.k8s.io/v1beta1/pods

# 获取特定命名空间的Pod数据
kubectl get --raw /apis/metrics.k8s.io/v1beta1/namespaces/default/pods
```

**💼 实际应用场景**：
```
场景1 - 性能问题排查：
1. 用户反馈网站很慢
2. kubectl top pods --sort-by=cpu  # 找出CPU占用高的Pod
3. 定位到具体应用进行优化

场景2 - 内存泄漏检测：
1. 定期运行 kubectl top pods --sort-by=memory
2. 观察某个Pod内存使用是否持续增长
3. 及时发现内存泄漏问题
```

---

## 4. 🔧 API资源查询


### 4.1 查看可用API资源


**🔸 列出所有API资源**

```bash
# 查看集群支持的所有资源类型 - 就像查看"功能清单"
kubectl api-resources
```

**📋 输出示例和解读**：
```
NAME         SHORTNAMES   APIGROUP                    NAMESPACED   KIND
pods         po                                       true         Pod
services     svc                                      true         Service
deployments  deploy       apps                        true         Deployment
nodes                                                 false        Node
```

**🔹 字段含义**：
- **NAME**：资源的完整名称
- **SHORTNAMES**：简写名称（po代表pods，svc代表services）
- **APIGROUP**：所属的API组
- **NAMESPACED**：是否属于某个命名空间
- **KIND**：资源的类型名称

**💡 实用价值**：
- **学习资源**：了解Kubernetes有哪些资源类型
- **编写脚本**：知道可以用哪些简写命令
- **故障排查**：确认某个资源类型是否存在

### 4.2 查看API版本信息


**🔸 列出API版本**

```bash
# 查看所有可用的API版本 - 就像查看"软件版本号"
kubectl api-versions
```

**输出示例**：
```
v1                    # 核心API组
apps/v1              # 应用相关API  
networking.k8s.io/v1 # 网络相关API
storage.k8s.io/v1    # 存储相关API
```

**🎯 版本含义**：
- **v1**：稳定版本，生产环境可放心使用
- **v1beta1**：测试版本，功能相对稳定但可能变化
- **v1alpha1**：早期版本，功能不稳定，不建议生产使用

---

## 5. 📖 资源字段说明


### 5.1 查看资源字段定义


**🔸 解释资源结构**

```bash
# 查看Pod的所有字段说明 - 就像查看"使用手册"
kubectl explain pod

# 查看具体字段的详细说明
kubectl explain pod.spec
kubectl explain pod.spec.containers
kubectl explain deployment.spec.replicas
```

**💡 使用场景**：
```
学习场景：
- 新手不知道YAML怎么写 → kubectl explain deployment
- 不确定字段名称 → kubectl explain pod.spec

工作场景：
- 写配置文件时忘记字段名 → 快速查询
- API版本升级时检查字段变化 → 对比说明
```

**📚 输出示例**：
```bash
kubectl explain pod.spec.containers
```

```
KIND:     Pod
VERSION:  v1

RESOURCE: containers <[]Object>

DESCRIPTION:
     List of containers belonging to the pod.
     
FIELDS:
   name    <string> -required-    # 容器名称（必填）
   image   <string> -required-    # 镜像名称（必填）  
   ports   <[]Object>             # 端口配置
   env     <[]Object>             # 环境变量
```

### 5.2 递归查看字段结构


**🔸 深入查看嵌套字段**

```bash
# 逐级深入查看字段结构
kubectl explain deployment                    # 查看顶级字段
kubectl explain deployment.spec             # 查看spec字段
kubectl explain deployment.spec.template    # 查看模板字段
kubectl explain deployment.spec.replicas    # 查看副本数字段
```

**🎯 学习技巧**：
```
从简单到复杂的学习路径：
1. kubectl explain pod              # 先看整体结构
2. kubectl explain pod.spec        # 再看规格配置  
3. kubectl explain pod.spec.containers  # 最后看具体细节

这样循序渐进，不会被复杂的结构吓到
```

---

## 6. 🌐 全局资源查看


### 6.1 查看常见资源


**🔸 获取所有常见资源**

```bash
# 查看当前命名空间的所有常见资源 - 就像"总体检查"
kubectl get all

# 实际等价于查看这些资源类型：
# pods, services, deployments, replicasets
```

**📊 输出示例**：
```
NAME                         READY   STATUS    RESTARTS   AGE
pod/nginx-7d8b49557c-abc123   1/1     Running   0          1d

NAME                 TYPE        CLUSTER-IP     PORT(S)    AGE
service/nginx-svc    ClusterIP   10.96.1.100    80/TCP     1d

NAME                    READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/nginx   1/1     1            1           1d

NAME                               DESIRED   CURRENT   READY   AGE
replicaset.apps/nginx-7d8b49557c   1         1         1       1d
```

### 6.2 全集群资源查看


**🔸 查看所有命名空间资源**

```bash
# 查看整个集群的所有常见资源 - "全院大检查"
kubectl get all -A
# 或者
kubectl get all --all-namespaces
```

**💡 实际用途**：
- **集群健康检查**：快速了解整个集群的运行状态
- **问题排查**：系统异常时全面检查所有组件
- **资源盘点**：了解集群中运行了哪些应用

### 6.3 显示资源详细信息


**🔸 显示资源类型和标签**

```bash
# 显示资源类型和标签信息
kubectl get pods --show-kind --show-labels

# 显示所有资源的类型和标签
kubectl get all --show-kind --show-labels
```

**📋 输出效果对比**：
```bash
# 普通输出
kubectl get pods
NAME                     READY   STATUS    RESTARTS   AGE
nginx-7d8b49557c-abc123   1/1     Running   0          1d

# 带类型和标签的输出  
kubectl get pods --show-kind --show-labels
NAME                     READY   STATUS    RESTARTS   AGE   KIND   LABELS
nginx-7d8b49557c-abc123   1/1     Running   0          1d    Pod    app=nginx,version=1.0
```

**🎯 标签的作用**：
- **资源筛选**：根据标签快速找到相关资源
- **批量操作**：对具有相同标签的资源执行操作
- **管理组织**：用标签对资源进行分类管理

---

## 7. 🛠️ 监控最佳实践


### 7.1 日常监控工作流


**📋 每日监控检查清单**：

```bash
# 1. 检查集群整体健康状态
kubectl get nodes                        # 节点状态检查
kubectl get all -A                      # 全局资源检查

# 2. 检查资源使用情况  
kubectl top nodes                       # 节点资源使用
kubectl top pods --all-namespaces       # Pod资源使用

# 3. 查找资源使用异常
kubectl top nodes --sort-by=cpu         # CPU热点节点
kubectl top pods --sort-by=memory -A    # 内存使用排行
```

### 7.2 性能问题排查流程


**🔍 系统性能问题排查步骤**：

```
步骤1：确定问题范围
kubectl top nodes  # 是节点问题还是应用问题？

步骤2：定位具体资源
kubectl top pods --sort-by=cpu -A  # 找出CPU占用高的Pod

步骤3：深入分析
kubectl describe pod [pod-name]     # 查看Pod详细状态
kubectl logs [pod-name]            # 查看应用日志

步骤4：查看资源配置
kubectl get pod [pod-name] -o yaml # 检查资源限制配置
```

### 7.3 容量规划建议


**📊 资源使用阈值参考**：

| 资源类型 | **警告阈值** | **危险阈值** | **建议操作** |
|---------|-------------|-------------|-------------|
| 🖥️ **节点CPU** | 70% | 85% | 考虑扩容或负载均衡 |
| 💾 **节点内存** | 75% | 90% | 增加节点或优化应用 |
| 🚀 **Pod CPU** | 500m | 1000m | 调整资源限制 |
| 📱 **Pod内存** | 512Mi | 1Gi | 检查内存泄漏 |

**🎯 预防性监控策略**：
```bash
# 定期执行的监控脚本示例
#!/bin/bash
echo "=== 节点资源使用情况 ==="
kubectl top nodes --sort-by=cpu

echo "=== CPU使用最高的5个Pod ==="  
kubectl top pods --sort-by=cpu -A | head -6

echo "=== 内存使用最高的5个Pod ==="
kubectl top pods --sort-by=memory -A | head -6
```

### 7.4 常见监控误区与纠正


**❌ 常见误区** vs **✅ 正确做法**：

❌ 只看当前时刻的数据 → ✅ 观察一段时间内的趋势变化
❌ 只关注CPU和内存 → ✅ 同时关注网络、存储、Pod状态
❌ 发现问题才去监控 → ✅ 建立定期监控的习惯
❌ 只监控应用Pod → ✅ 同时监控系统组件（kube-system）

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心命令


```bash
🔸 节点监控核心命令：
kubectl top nodes                    # 节点资源总览
kubectl top nodes --sort-by=cpu      # CPU使用排序  
kubectl top nodes --sort-by=memory   # 内存使用排序

🔸 Pod监控核心命令：
kubectl top pods                     # Pod资源使用
kubectl top pods -A --sort-by=cpu    # 全集群CPU排序
kubectl top pods -A --sort-by=memory # 全集群内存排序

🔸 API查询核心命令：  
kubectl api-resources                # 可用资源类型
kubectl explain [resource]           # 资源字段说明
kubectl get all                      # 常见资源查看
```

### 8.2 关键理解要点


**🔹 监控的本质目的**：
```
不是为了监控而监控，而是：
• 预防问题：在故障发生前发现异常
• 优化资源：合理配置CPU和内存  
• 容量规划：知道何时需要扩容
• 性能调优：找出系统瓶颈所在
```

**🔹 数据解读技巧**：
```
看懂监控数据的关键：
• CPU单位：1000m = 1核，250m = 0.25核
• 内存单位：1Gi = 1024Mi，1Mi = 1024Ki
• 百分比含义：占节点总资源的比例
• 趋势比数值重要：持续增长比瞬时高值更危险
```

**🔹 命令组合使用**：
```
单独命令有限，组合使用才强大：
1. kubectl get nodes           # 先看节点状态
2. kubectl top nodes          # 再看资源使用  
3. kubectl top pods -A        # 最后看应用情况
4. kubectl describe node xxx  # 深入分析问题节点
```

### 8.3 实际应用价值


**💼 日常运维场景**：
- **早晨检查**：执行监控命令了解集群夜间运行情况
- **性能优化**：根据资源使用数据调整应用配置
- **故障排查**：系统异常时快速定位资源瓶颈
- **容量规划**：根据趋势数据制定扩容计划

**🎯 学习进阶路径**：
- **初级**：熟练使用top命令查看资源使用
- **中级**：理解API资源结构，会用explain命令
- **高级**：编写监控脚本，建立自动化监控体系
- **专家**：结合Prometheus等专业监控系统

**🧠 核心记忆口诀**：
```
"节点Pod要监控，top命令是基础
CPU内存要排序，异常问题早发现  
API资源要熟悉，explain说明很详细
全局查看用get all，标签类型要显示"
```

**核心理念**：
- Kubernetes监控不是高深技术，而是日常运维的基本功
- 监控数据要结合实际业务场景来解读，不是数字越低越好
- 定期监控比临时检查更有价值，趋势比瞬时值更重要
- 监控是为了更好地管理和优化集群，而不是增加运维负担