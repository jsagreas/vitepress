---
title: 5、Pod日志与调试
---
## 📚 目录

1. [Pod日志基础概念](#1-pod日志基础概念)
2. [基本日志查看命令](#2-基本日志查看命令)
3. [高级日志过滤与筛选](#3-高级日志过滤与筛选)
4. [Pod内部调试技巧](#4-pod内部调试技巧)
5. [多容器Pod管理](#5-多容器pod管理)
6. [端口转发与网络调试](#6-端口转发与网络调试)
7. [故障排查实战技巧](#7-故障排查实战技巧)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🔍 Pod日志基础概念


### 1.1 什么是Pod日志


**通俗理解**：就像查看应用程序的运行记录一样，Pod日志记录了容器内应用的所有输出信息。

```
现实类比：
📱 手机应用日志 → 记录APP运行状态、错误信息
🏗️  Pod日志     → 记录容器应用运行状态、错误信息

作用都是：帮助我们了解程序到底在干什么，哪里出了问题
```

**Pod日志的本质**：
- **标准输出流**：应用通过`stdout`输出的内容
- **标准错误流**：应用通过`stderr`输出的错误信息
- **容器日志**：Docker容器层面的日志记录

### 1.2 为什么要查看Pod日志


| 使用场景 | 具体说明 | 实际例子 |
|---------|---------|---------|
| 🐛 **问题排查** | 应用出错时定位问题 | 网站打不开，查日志看是数据库连接失败 |
| 📊 **运行监控** | 观察应用运行状态 | 查看API请求量、响应时间等指标 |
| 🔧 **开发调试** | 开发过程中验证逻辑 | 新功能部署后查看是否正常工作 |
| 📈 **性能分析** | 分析应用性能瓶颈 | 查看SQL执行时间、内存使用情况 |

### 1.3 日志存储机制


**Kubernetes日志架构**：
```
应用程序输出
     ↓
容器运行时收集
     ↓
节点本地存储
     ↓
日志聚合系统（可选）
```

**🔸 存储位置**：
- 节点路径：`/var/log/containers/`
- 文件格式：`[pod-name]_[namespace]_[container-name]-[container-id].log`

---

## 2. 📋 基本日志查看命令


### 2.1 查看实时日志


**🔸 基本语法**：`kubectl logs [pod-name]`

**实际操作示例**：
```bash
# 查看名为nginx-pod的Pod日志
kubectl logs nginx-pod

# 实时跟踪日志输出（类似tail -f）
kubectl logs -f nginx-pod
```

**通俗解释**：
- `logs`：告诉kubectl我要看日志
- `nginx-pod`：指定要看哪个Pod的日志  
- `-f`：follow的意思，实时跟踪新产生的日志

### 2.2 指定命名空间


```bash
# 查看特定命名空间下的Pod日志
kubectl logs nginx-pod -n production

# 如果不指定-n，默认查看default命名空间
kubectl logs nginx-pod
```

**💡 新手提示**：命名空间就像文件夹，不同的应用可能放在不同的"文件夹"里。

### 2.3 查看历史日志


**🔸 查看前一个容器的日志**：
```bash
# 当Pod重启后，查看重启前的日志
kubectl logs nginx-pod --previous
```

**使用场景**：
- Pod突然重启了，想看重启前发生了什么
- 容器崩溃重启，需要查看崩溃原因

**实际案例**：
```bash
# 网站应用突然重启，查看重启前的错误日志
kubectl logs web-app --previous | grep -i error
```

---

## 3. ⚡ 高级日志过滤与筛选


### 3.1 时间范围筛选


**🔸 查看指定时间范围的日志**：

```bash
# 查看最近1小时的日志
kubectl logs nginx-pod --since=1h

# 查看最近30分钟的日志
kubectl logs nginx-pod --since=30m

# 查看最近1天的日志
kubectl logs nginx-pod --since=24h
```

**时间单位对照表**：
| 单位 | 含义 | 示例 |
|-----|------|------|
| `s` | 秒 | `--since=30s` |
| `m` | 分钟 | `--since=10m` |
| `h` | 小时 | `--since=2h` |

### 3.2 限制日志行数


**🔸 显示最后N行日志**：

```bash
# 显示最后100行日志
kubectl logs nginx-pod --tail=100

# 显示最后50行日志
kubectl logs nginx-pod --tail=50

# 显示最后10行并实时跟踪
kubectl logs nginx-pod --tail=10 -f
```

**💡 实用技巧**：
```bash
# 组合使用：查看最近1小时的最后20行日志
kubectl logs nginx-pod --since=1h --tail=20
```

### 3.3 时间戳显示


```bash
# 显示时间戳
kubectl logs nginx-pod --timestamps=true

# 简写形式
kubectl logs nginx-pod --timestamps
```

**输出效果对比**：
```
# 不显示时间戳
GET /api/users 200 OK

# 显示时间戳  
2024-01-20T10:30:15.123456Z GET /api/users 200 OK
```

---

## 4. 🔧 Pod内部调试技巧


### 4.1 进入Pod执行命令


**🔸 基本语法**：`kubectl exec -it [pod-name] -- [command]`

**常用操作示例**：

```bash
# 进入Pod内部的bash终端
kubectl exec -it nginx-pod -- /bin/bash

# 如果没有bash，尝试sh
kubectl exec -it nginx-pod -- /bin/sh

# 查看Pod内部的文件系统
kubectl exec -it nginx-pod -- ls -la /

# 查看Pod内部的进程
kubectl exec -it nginx-pod -- ps aux
```

**🔸 参数解释**：
- `-i`：interactive（交互式），保持输入流开启
- `-t`：tty，分配一个伪终端
- `--`：分隔kubectl参数和容器内命令

### 4.2 在Pod内执行单个命令


```bash
# 查看容器内的环境变量
kubectl exec nginx-pod -- env

# 查看容器内的网络配置
kubectl exec nginx-pod -- ip addr show

# 测试网络连通性
kubectl exec nginx-pod -- ping google.com

# 查看容器内的磁盘使用
kubectl exec nginx-pod -- df -h
```

### 4.3 文件操作


```bash
# 查看配置文件内容
kubectl exec nginx-pod -- cat /etc/nginx/nginx.conf

# 查看应用日志（容器内部的日志文件）
kubectl exec nginx-pod -- tail -f /var/log/app.log

# 检查文件权限
kubectl exec nginx-pod -- ls -la /app/config/
```

**⚠️ 常见问题解决**：

| 问题 | 原因 | 解决方案 |
|-----|------|---------|
| `command not found` | 容器内没有该命令 | 尝试其他命令或安装工具 |
| `Permission denied` | 权限不足 | 检查容器的用户权限设置 |
| `No such file` | 文件路径错误 | 先用`ls`确认文件位置 |

---

## 5. 📦 多容器Pod管理


### 5.1 查看多容器Pod日志


**🔸 查看指定容器的日志**：
```bash
# 查看Pod中特定容器的日志
kubectl logs web-pod -c nginx-container

# 查看另一个容器的日志
kubectl logs web-pod -c app-container
```

**多容器Pod结构示例**：
```
web-pod
├── nginx-container    ← 负责处理HTTP请求
└── app-container      ← 负责业务逻辑处理
```

### 5.2 查看所有容器日志


```bash
# 查看Pod中所有容器的日志
kubectl logs web-pod --all-containers=true

# 显示容器名称前缀
kubectl logs web-pod --all-containers=true --prefix=true
```

**输出格式**：
```
[nginx-container] 192.168.1.100 - GET /api/users
[app-container] Processing user request...
[nginx-container] 192.168.1.100 - 200 OK
```

### 5.3 进入多容器Pod


```bash
# 进入指定容器
kubectl exec -it web-pod -c nginx-container -- /bin/bash

# 在指定容器中执行命令
kubectl exec web-pod -c app-container -- ps aux
```

**💡 多容器调试策略**：
1. **先查看所有容器日志** - 了解整体状况
2. **分别查看各容器** - 定位具体问题
3. **进入问题容器** - 深入排查

---

## 6. 🌐 端口转发与网络调试


### 6.1 端口转发基础


**🔸 基本语法**：`kubectl port-forward [pod-name] [local-port]:[pod-port]`

**实际操作**：
```bash
# 将本地8080端口转发到Pod的80端口
kubectl port-forward nginx-pod 8080:80

# 转发到指定IP（允许外部访问）
kubectl port-forward nginx-pod 8080:80 --address 0.0.0.0

# 后台运行端口转发
kubectl port-forward nginx-pod 8080:80 &
```

### 6.2 实际应用场景


**🔸 Web应用调试**：
```bash
# 转发Web应用端口，然后在浏览器访问 http://localhost:8080
kubectl port-forward web-app 8080:3000
```

**🔸 数据库连接调试**：
```bash
# 转发数据库端口，使用本地工具连接
kubectl port-forward mysql-pod 3306:3306
```

**🔸 API接口测试**：
```bash
# 转发API服务端口
kubectl port-forward api-server 9000:8000

# 然后可以用curl测试
curl http://localhost:9000/api/health
```

### 6.3 网络连通性测试


```bash
# 在Pod内测试外部网络
kubectl exec nginx-pod -- curl -I http://www.google.com

# 测试Pod之间的连通性
kubectl exec pod-a -- wget -q --spider http://pod-b-service:8080

# 查看Pod的网络接口
kubectl exec nginx-pod -- ip addr show
```

---

## 7. 🚨 故障排查实战技巧


### 7.1 Pod状态诊断流程


**🔸 标准排查步骤**：

```
第1步：查看Pod状态
kubectl get pods

第2步：查看详细信息  
kubectl describe pod [pod-name]

第3步：查看日志
kubectl logs [pod-name]

第4步：进入容器调试
kubectl exec -it [pod-name] -- /bin/bash
```

### 7.2 常见问题排查


**🐛 Pod无法启动**：

```bash
# 查看Pod事件信息
kubectl describe pod problem-pod

# 查看创建失败的原因
kubectl get events --field-selector involvedObject.name=problem-pod
```

**🐛 应用无法访问**：

```bash
# 检查服务是否正常
kubectl get svc

# 检查端点是否正确
kubectl get endpoints

# 测试服务连通性
kubectl exec test-pod -- curl http://service-name:port/health
```

**🐛 容器频繁重启**：

```bash
# 查看重启前的日志
kubectl logs problem-pod --previous

# 查看重启次数和原因
kubectl describe pod problem-pod | grep -A 5 "Restart Count"
```

### 7.3 性能问题排查


**🔸 资源使用情况**：

```bash
# 查看Pod资源使用（需要metrics-server）
kubectl top pod

# 查看特定Pod的资源使用
kubectl top pod nginx-pod

# 进入Pod查看内存使用
kubectl exec nginx-pod -- free -h

# 查看CPU使用情况
kubectl exec nginx-pod -- top
```

### 7.4 日志分析技巧


**🔸 错误日志筛选**：

```bash
# 筛选错误日志
kubectl logs nginx-pod | grep -i error

# 筛选警告日志
kubectl logs nginx-pod | grep -i warn

# 统计错误数量
kubectl logs nginx-pod | grep -i error | wc -l

# 查看最近的错误（结合时间筛选）
kubectl logs nginx-pod --since=10m | grep -i error
```

**🔸 日志模式识别**：

```bash
# 查找特定IP的访问日志
kubectl logs nginx-pod | grep "192.168.1.100"

# 查找慢请求（响应时间>1000ms）
kubectl logs api-pod | grep "response_time:[0-9][0-9][0-9][0-9]"

# 统计请求状态码分布
kubectl logs nginx-pod | grep -o "HTTP/[0-9.]* [0-9]*" | sort | uniq -c
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心命令


```
🔸 基础日志查看：kubectl logs [pod-name]
🔸 实时日志跟踪：kubectl logs -f [pod-name]  
🔸 多容器日志：kubectl logs [pod-name] -c [container-name]
🔸 历史日志查看：kubectl logs [pod-name] --previous
🔸 时间范围筛选：kubectl logs [pod-name] --since=1h
🔸 行数限制：kubectl logs [pod-name] --tail=100
🔸 进入Pod调试：kubectl exec -it [pod-name] -- /bin/bash
🔸 端口转发：kubectl port-forward [pod-name] [local-port]:[pod-port]
```

### 8.2 实用调试技巧总结


| 场景 | 命令组合 | 说明 |
|-----|---------|------|
| **快速问题定位** | `kubectl describe pod + kubectl logs` | 先看状态再看日志 |
| **性能问题排查** | `kubectl top pod + kubectl exec -- top` | 资源使用情况分析 |
| **网络问题调试** | `kubectl port-forward + curl测试` | 本地测试Pod服务 |
| **应用崩溃分析** | `kubectl logs --previous + grep error` | 查看崩溃前错误信息 |

### 8.3 故障排查最佳实践


**🔹 排查思路**：
```
1. 现象确认：Pod状态是什么？
2. 日志分析：应用输出了什么信息？  
3. 环境检查：容器内环境是否正常？
4. 网络测试：服务间通信是否正常？
5. 资源分析：是否存在资源瓶颈？
```

**🔹 常用命令组合**：
```bash
# 一键获取Pod完整信息
kubectl get pod [pod-name] -o wide && \
kubectl describe pod [pod-name] && \
kubectl logs [pod-name] --tail=50

# 快速网络调试
kubectl port-forward [pod-name] 8080:80 &
curl http://localhost:8080/health
```

### 8.4 学习要点记忆


**💡 记忆口诀**：
```
logs看日志，exec进容器
port-forward做转发，describe看详情
-f跟踪实时，--previous看历史
-c指定容器，--tail限行数
```

**🎯 核心理解**：
- **Pod日志** = 应用的"黑匣子"，记录运行轨迹
- **kubectl exec** = "远程桌面"，直接操作容器
- **port-forward** = "VPN隧道"，本地访问远程服务  
- **调试思维** = 从现象到本质，层层深入排查

**⚠️ 新手注意事项**：
- 日志命令会消耗网络带宽，生产环境谨慎使用`-f`
- `kubectl exec`会创建新进程，不要长时间占用
- 端口转发仅用于调试，不能作为生产访问方式
- 多容器Pod必须用`-c`指定容器名称