---
title: 31、备份与迁移命令
---
## 📚 目录

1. [备份与迁移基础概念](#1-备份与迁移基础概念)
2. [资源导出备份命令](#2-资源导出备份命令)
3. [数据备份与恢复](#3-数据备份与恢复)
4. [集群级别备份](#4-集群级别备份)
5. [迁移策略与实践](#5-迁移策略与实践)
6. [自动化备份方案](#6-自动化备份方案)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 🎯 备份与迁移基础概念


### 1.1 什么是Kubernetes备份


> 💡 **通俗理解**  
> 就像给电脑做系统备份一样，Kubernetes备份就是把集群中的应用、配置、数据等重要信息保存起来，防止意外丢失

**核心备份内容**：
```
🔸 应用定义文件 → 你的应用怎么运行的"说明书"
🔸 配置信息 → 应用需要的各种设置参数  
🔸 存储数据 → 应用产生的重要数据
🔸 集群状态 → 整个Kubernetes环境的配置
```

### 1.2 为什么需要备份


**现实场景对比**：
```
没备份的风险：
❌ 服务器故障 → 应用全部丢失
❌ 误删配置 → 服务无法启动
❌ 数据损坏 → 用户数据丢失

有备份的安心：
✅ 快速恢复 → 几分钟重建服务
✅ 版本回退 → 出问题立即回到正常状态
✅ 灾难恢复 → 换个环境继续运行
```

### 1.3 备份的三个层次


```
应用层备份：                集群层备份：              数据层备份：
    📱                         ⚙️                       💾
应用配置文件                集群组件配置               持久化数据
服务定义                   节点信息                   数据库内容
网络策略                   权限设置                   文件存储
```

**🧠 记忆技巧**：应用（App）、集群（Cluster）、数据（Data）→ **ACD三层备份法**

---

## 2. 📋 资源导出备份命令


### 2.1 单个资源导出


**基础导出命令**：
```bash
# 导出一个Pod的完整定义
kubectl get pod my-app -o yaml > my-app-backup.yaml

# 导出一个Service
kubectl get svc my-service -o yaml > my-service-backup.yaml

# 导出Deployment
kubectl get deployment my-app -o yaml > my-app-deploy-backup.yaml
```

> 📖 **命令解释**  
> `get` = 获取资源，`-o yaml` = 输出为YAML格式，`>` = 保存到文件

### 2.2 批量资源导出


**🔥 核心必知命令**：
```bash
# 导出命名空间内所有资源（最常用）
kubectl get all -o yaml > all-resources-backup.yaml

# 导出指定命名空间的所有资源
kubectl get all -n production -o yaml > production-backup.yaml

# 导出多种资源类型
kubectl get deployment,service,configmap -o yaml > app-backup.yaml
```

**📊 资源类型对照表**：

| 资源简写 | 完整名称 | 用途说明 |
|---------|----------|----------|
| `po` | `pods` | 运行的应用实例 |
| `svc` | `services` | 网络访问入口 |
| `deploy` | `deployments` | 应用部署管理 |
| `cm` | `configmaps` | 配置文件存储 |
| `secret` | `secrets` | 敏感信息存储 |

### 2.3 配置信息专项备份


**ConfigMap和Secret备份**：
```bash
# 备份所有ConfigMap
kubectl get configmaps --all-namespaces -o yaml > configmaps-backup.yaml

# 备份所有Secret（注意安全性）
kubectl get secrets --all-namespaces -o yaml > secrets-backup.yaml

# 只备份非系统Secret
kubectl get secrets --field-selector type!=kubernetes.io/service-account-token -o yaml > user-secrets.yaml
```

> ⚠️ **安全提醒**  
> Secret包含敏感信息（密码、证书等），备份文件要妥善保管，不要提交到代码仓库

---

## 3. 💾 数据备份与恢复


### 3.1 持久卷备份


**持久卷相关备份**：
```bash
# 备份所有PersistentVolume
kubectl get pv -o yaml > pv-backup.yaml

# 备份所有PVC
kubectl get pvc --all-namespaces -o yaml > pvc-backup.yaml

# 查看存储类配置
kubectl get storageclass -o yaml > storageclass-backup.yaml
```

**🔍 理解PV和PVC**：
```
现实类比：
PV（持久卷） = 仓库空间
PVC（持久卷声明） = 租用仓库的合同
StorageClass = 仓库类型（普通仓库、冷藏仓库等）

关系图：
应用 ←使用→ PVC ←绑定→ PV ←创建→ StorageClass
```

### 3.2 Pod数据备份


**从Pod复制文件**：
```bash
# 从Pod复制文件到本地
kubectl cp my-app-pod:/app/data/important.db ./backup/important.db

# 复制整个目录
kubectl cp my-app-pod:/app/data/ ./backup/data/

# 从本地复制到Pod（恢复数据）
kubectl cp ./backup/important.db my-app-pod:/app/data/important.db
```

**📋 实用复制场景**：
- ✅ 数据库文件备份
- ✅ 日志文件收集  
- ✅ 配置文件同步
- ✅ 应用数据迁移

---

## 4. 🏗️ 集群级别备份


### 4.1 集群信息完整备份


**🔥 集群信息转储**：
```bash
# 完整集群信息备份
kubectl cluster-info dump --output-directory=/backup/cluster-dump

# 指定命名空间的集群信息
kubectl cluster-info dump --namespaces default,kube-system --output-directory=/backup/specific-dump
```

**备份内容包括**：
```
📁 cluster-dump/
├── 📄 cluster-info.txt          ← 集群基本信息
├── 📁 namespaces/              ← 各命名空间详情
├── 📁 nodes/                   ← 节点状态信息
├── 📁 events/                  ← 集群事件记录
└── 📁 logs/                    ← 系统组件日志
```

### 4.2 命名空间管理


**创建和备份命名空间**：
```bash
# 生成命名空间定义（不实际创建）
kubectl create namespace production --dry-run=client -o yaml > namespace-production.yaml

# 导出现有命名空间
kubectl get namespace production -o yaml > existing-namespace.yaml

# 导出所有命名空间
kubectl get namespaces -o yaml > all-namespaces.yaml
```

> 💡 **dry-run参数说明**  
> `--dry-run=client` = 只生成配置，不实际执行，常用于生成模板文件

---

## 5. 🚀 迁移策略与实践


### 5.1 完整应用迁移流程


**Step-by-Step迁移步骤**：

```
源集群 ────备份────> 文件 ────恢复────> 目标集群

详细流程：
🎯 步骤1：导出应用资源
🎯 步骤2：备份配置数据  
🎯 步骤3：准备目标环境
🎯 步骤4：恢复应用资源
🎯 步骤5：验证迁移结果
```

**实际操作命令序列**：
```bash
# 步骤1：完整备份源应用
kubectl get all,configmap,secret -l app=myapp -o yaml > myapp-complete-backup.yaml

# 步骤2：备份存储相关
kubectl get pvc -l app=myapp -o yaml > myapp-storage-backup.yaml

# 步骤3：在目标集群恢复
kubectl apply -f myapp-complete-backup.yaml
kubectl apply -f myapp-storage-backup.yaml

# 步骤4：验证应用状态
kubectl get pods -l app=myapp
kubectl get svc -l app=myapp
```

### 5.2 跨集群资源对比


**迁移前后对比检查**：
```bash
# 对比资源数量
echo "源集群资源："
kubectl get all --no-headers | wc -l

echo "目标集群资源："
kubectl get all --no-headers | wc -l

# 对比具体应用状态
kubectl get deployment myapp -o wide
kubectl get svc myapp -o wide
```

---

## 6. 🔄 自动化备份方案


### 6.1 定时备份脚本


**简单备份脚本示例**：
```bash
#!/bin/bash
# k8s-backup.sh - Kubernetes自动备份脚本

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup/k8s-${DATE}"

# 创建备份目录
mkdir -p ${BACKUP_DIR}

# 备份所有应用资源
kubectl get all --all-namespaces -o yaml > ${BACKUP_DIR}/all-resources.yaml

# 备份配置信息
kubectl get configmaps --all-namespaces -o yaml > ${BACKUP_DIR}/configmaps.yaml
kubectl get secrets --all-namespaces -o yaml > ${BACKUP_DIR}/secrets.yaml

# 备份存储信息
kubectl get pv,pvc --all-namespaces -o yaml > ${BACKUP_DIR}/storage.yaml

echo "备份完成：${BACKUP_DIR}"
```

### 6.2 恢复验证脚本


**恢复操作模板**：
```bash
#!/bin/bash
# k8s-restore.sh - Kubernetes恢复脚本

BACKUP_DIR=$1

if [ -z "$BACKUP_DIR" ]; then
    echo "使用方法: $0 <备份目录>"
    exit 1
fi

# 恢复资源（按顺序）
echo "恢复命名空间..."
kubectl apply -f ${BACKUP_DIR}/namespaces.yaml

echo "恢复配置..."
kubectl apply -f ${BACKUP_DIR}/configmaps.yaml
kubectl apply -f ${BACKUP_DIR}/secrets.yaml

echo "恢复应用..."
kubectl apply -f ${BACKUP_DIR}/all-resources.yaml

echo "恢复完成，请检查应用状态"
```

---

## 7. 📋 核心要点总结


### 7.1 必须掌握的核心命令


```
🔸 资源导出：kubectl get [resource] -o yaml > backup.yaml
🔸 批量备份：kubectl get all -o yaml > all-backup.yaml  
🔸 文件复制：kubectl cp pod:/path/file ./local/file
🔸 集群备份：kubectl cluster-info dump --output-directory=/backup
🔸 资源恢复：kubectl apply -f backup.yaml
```

### 7.2 备份策略最佳实践


**🎯 日常备份检查清单**：
- [ ] **应用配置备份**：Deployment、Service、ConfigMap
- [ ] **存储数据备份**：PV、PVC、实际数据文件
- [ ] **安全信息备份**：Secret（注意安全存储）
- [ ] **集群状态备份**：Node、Namespace、RBAC配置
- [ ] **定期恢复测试**：验证备份文件可用性

**💡 备份频率建议**：
```
生产环境：
🔥 每日备份 → 关键应用配置
⭐ 每周备份 → 完整集群状态  
💫 每月备份 → 长期归档存储

开发环境：
⭐ 每周备份 → 主要应用配置
💫 按需备份 → 重要变更前备份
```

### 7.3 迁移场景应用指导


**常见迁移场景**：
- **🏢 环境迁移**：开发→测试→生产
- **🌐 跨云迁移**：从A云厂商迁移到B云厂商  
- **⚡ 版本升级**：Kubernetes版本升级前备份
- **🔄 灾难恢复**：主集群故障时快速恢复

**迁移成功标准**：
```
✅ 应用正常启动
✅ 数据完整性验证
✅ 网络访问正常  
✅ 存储挂载成功
✅ 日志输出正常
```

### 7.4 故障处理要点


**🔍 常见备份恢复问题**：

| 问题现象 | 可能原因 | 解决方案 |
|---------|----------|----------|
| `资源创建失败` | 命名空间不存在 | 先创建命名空间 |
| `PVC绑定失败` | StorageClass不匹配 | 检查存储类配置 |
| `Secret无法使用` | 编码格式问题 | 重新创建Secret |
| `应用无法访问` | Service配置错误 | 检查标签选择器 |

**🧠 核心记忆口诀**：
- **备份三要素**：应用配置、存储数据、集群状态
- **迁移五步骤**：备份、传输、准备、恢复、验证
- **安全三原则**：定期备份、测试恢复、安全存储

> 💡 **新手提醒**  
> 备份不是一次性的事情，而是一个持续的过程。建议先在开发环境练习备份恢复操作，熟悉后再应用到生产环境。记住：**最好的备份是那个你验证过可以成功恢复的备份**！