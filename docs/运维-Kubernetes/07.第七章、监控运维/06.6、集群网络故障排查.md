---
title: 6ã€é›†ç¾¤ç½‘ç»œæ•…éšœæ’æŸ¥
---
## ğŸ“š ç›®å½•

1. [ç½‘ç»œæ•…éšœæ’æŸ¥æ¦‚è¿°](#1-ç½‘ç»œæ•…éšœæ’æŸ¥æ¦‚è¿°)
2. [ç½‘ç»œè¿é€šæ€§åŸºç¡€æµ‹è¯•](#2-ç½‘ç»œè¿é€šæ€§åŸºç¡€æµ‹è¯•)
3. [Podé—´é€šä¿¡æ•…éšœè¯Šæ–­](#3-Podé—´é€šä¿¡æ•…éšœè¯Šæ–­)
4. [Serviceè®¿é—®é—®é¢˜æ’æŸ¥](#4-Serviceè®¿é—®é—®é¢˜æ’æŸ¥)
5. [DNSè§£ææ•…éšœåˆ†æ](#5-DNSè§£ææ•…éšœåˆ†æ)
6. [CNIç½‘ç»œæ’ä»¶é—®é¢˜](#6-CNIç½‘ç»œæ’ä»¶é—®é¢˜)
7. [ç½‘ç»œç­–ç•¥é…ç½®é—®é¢˜](#7-ç½‘ç»œç­–ç•¥é…ç½®é—®é¢˜)
8. [ç«¯å£å’Œé˜²ç«å¢™é—®é¢˜](#8-ç«¯å£å’Œé˜²ç«å¢™é—®é¢˜)
9. [è·¯ç”±å’Œæ€§èƒ½é—®é¢˜](#9-è·¯ç”±å’Œæ€§èƒ½é—®é¢˜)
10. [ç½‘ç»œç›‘æ§å·¥å…·](#10-ç½‘ç»œç›‘æ§å·¥å…·)
11. [å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ](#11-å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ)
12. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#12-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ ç½‘ç»œæ•…éšœæ’æŸ¥æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯Kubernetesç½‘ç»œæ•…éšœ


**ç®€å•ç†è§£**ï¼šå°±åƒæˆ‘ä»¬å®¶é‡Œçš„WiFiç½‘ç»œä¸€æ ·ï¼ŒKubernetesé›†ç¾¤å†…éƒ¨ä¹Ÿæœ‰ä¸€å¥—å¤æ‚çš„ç½‘ç»œç³»ç»Ÿï¼Œè®©å„ä¸ªPodï¼ˆå°±åƒä¸åŒçš„è®¾å¤‡ï¼‰èƒ½å¤Ÿç›¸äº’é€šä¿¡ã€‚å½“è¿™å¥—ç½‘ç»œç³»ç»Ÿå‡ºç°é—®é¢˜æ—¶ï¼ŒPodä¹‹é—´å°±æ— æ³•æ­£å¸¸"èŠå¤©"äº†ã€‚

**æ ¸å¿ƒæ¦‚å¿µè§£é‡Š**ï¼š
- **Podé€šä¿¡**ï¼šPodå°±åƒå°æˆ¿é—´ï¼Œé‡Œé¢è¿è¡Œç€åº”ç”¨ç¨‹åºï¼Œå®ƒä»¬éœ€è¦é€šè¿‡ç½‘ç»œäº’ç›¸äº¤æµ
- **Service**ï¼šåƒæ˜¯ä¸€ä¸ª"æ¥å¾…å¤„"ï¼Œå¸®åŠ©å¤–éƒ¨æ‰¾åˆ°æ­£ç¡®çš„Pod
- **ç½‘ç»œæ’ä»¶**ï¼šå°±æ˜¯æ­å»ºç½‘ç»œçš„"å·¥ç¨‹é˜Ÿ"ï¼Œè´Ÿè´£é“ºè®¾ç½‘ç»œçº¿è·¯

### 1.2 ç½‘ç»œæ•…éšœçš„å¸¸è§ç—‡çŠ¶


**ğŸ”¸ ç”¨æˆ·èƒ½æ„Ÿå—åˆ°çš„é—®é¢˜**ï¼š
- ç½‘é¡µæ‰“ä¸å¼€æˆ–åŠ è½½å¾ˆæ…¢
- åº”ç”¨ç¨‹åºæŠ¥é”™"è¿æ¥è¶…æ—¶"
- æ•°æ®åº“è¿æ¥å¤±è´¥
- APIæ¥å£è°ƒç”¨å¤±è´¥

**ğŸ”¸ æŠ€æœ¯å±‚é¢çš„è¡¨ç°**ï¼š
```
PodçŠ¶æ€å¼‚å¸¸ï¼š
- Runningä½†æ— æ³•è®¿é—®
- CrashLoopBackOffå¾ªç¯é‡å¯
- ReadyçŠ¶æ€ä¸º0/1

Serviceé—®é¢˜ï¼š
- Endpointsåˆ—è¡¨ä¸ºç©º
- ClusterIPæ— æ³•è®¿é—®
- NodePortç«¯å£ä¸é€š
```

### 1.3 ç½‘ç»œæ•…éšœæ’æŸ¥æ€è·¯


```
æ•…éšœæ’æŸ¥çš„å±‚æ¬¡ç»“æ„ï¼š

ç‰©ç†å±‚é¢ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
                      â”ƒ
ç½‘ç»œæ’ä»¶å±‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”« ä»åº•å±‚åˆ°ä¸Šå±‚
                      â”ƒ é€æ­¥æ’æŸ¥
Kubernetesç½‘ç»œå±‚ â”â”â”â”â”â”â”â”«
                      â”ƒ
åº”ç”¨å±‚é¢ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›

æ’æŸ¥åŸåˆ™ï¼š
1ï¸âƒ£ å…ˆç®€å•åå¤æ‚
2ï¸âƒ£ å…ˆåŸºç¡€åé«˜çº§
3ï¸âƒ£ å…ˆæœ¬åœ°åè¿œç¨‹
4ï¸âƒ£ å…ˆå†…éƒ¨åå¤–éƒ¨
```

---

## 2. ğŸ” ç½‘ç»œè¿é€šæ€§åŸºç¡€æµ‹è¯•


### 2.1 ç†è§£ç½‘ç»œè¿é€šæ€§æµ‹è¯•çš„é‡è¦æ€§


**ä¸ºä»€ä¹ˆè¦åšè¿é€šæ€§æµ‹è¯•**ï¼Ÿ
å°±åƒæ£€æŸ¥å®¶é‡Œçš„ç”µè·¯ä¸€æ ·ï¼Œæˆ‘ä»¬éœ€è¦ç¡®è®¤ç½‘ç»œçš„"çº¿è·¯"æ˜¯å¦ç•…é€šã€‚è¿™æ˜¯æ’æŸ¥æ‰€æœ‰ç½‘ç»œé—®é¢˜çš„ç¬¬ä¸€æ­¥ã€‚

**ğŸ”¸ æµ‹è¯•çš„å±‚æ¬¡**ï¼š
- **èŠ‚ç‚¹çº§åˆ«**ï¼šæœåŠ¡å™¨ä¹‹é—´èƒ½å¦é€šä¿¡
- **Podçº§åˆ«**ï¼šå®¹å™¨ä¹‹é—´èƒ½å¦é€šä¿¡  
- **æœåŠ¡çº§åˆ«**ï¼šåº”ç”¨ä¹‹é—´èƒ½å¦é€šä¿¡

### 2.2 èŠ‚ç‚¹é—´è¿é€šæ€§æµ‹è¯•


**æµ‹è¯•ç›®çš„**ï¼šç¡®è®¤é›†ç¾¤ä¸­çš„æœåŠ¡å™¨ï¼ˆNodeï¼‰ä¹‹é—´ç½‘ç»œæ­£å¸¸

```bash
# åœ¨ä»»æ„èŠ‚ç‚¹æ‰§è¡Œï¼Œæµ‹è¯•åˆ°å…¶ä»–èŠ‚ç‚¹çš„è¿é€šæ€§
ping <å…¶ä»–èŠ‚ç‚¹IP>

# ç¤ºä¾‹è¾“å‡ºï¼ˆæ­£å¸¸ï¼‰
PING 192.168.1.102 (192.168.1.102) 56(84) bytes of data.
64 bytes from 192.168.1.102: icmp_seq=1 ttl=64 time=0.234 ms
64 bytes from 192.168.1.102: icmp_seq=2 ttl=64 time=0.198 ms

# æµ‹è¯•ç«¯å£è¿é€šæ€§
telnet <ç›®æ ‡èŠ‚ç‚¹IP> <ç«¯å£å·>
# æˆ–ä½¿ç”¨ncå‘½ä»¤
nc -zv <ç›®æ ‡èŠ‚ç‚¹IP> <ç«¯å£å·>
```

**ğŸ”§ å…³é”®ç«¯å£æ£€æŸ¥**ï¼š

| ç«¯å£å· | **ç”¨é€”è¯´æ˜** | **æµ‹è¯•æ–¹æ³•** |
|--------|-------------|-------------|
| `6443` | API Serveré€šä¿¡ç«¯å£ | `nc -zv <master-ip> 6443` |
| `10250` | kubelet APIç«¯å£ | `nc -zv <node-ip> 10250` |
| `2379-2380` | etcdé€šä¿¡ç«¯å£ | `nc -zv <master-ip> 2379` |
| `10251` | kube-scheduler | `nc -zv <master-ip> 10251` |
| `10252` | kube-controller-manager | `nc -zv <master-ip> 10252` |

### 2.3 Podå†…éƒ¨ç½‘ç»œæµ‹è¯•


**è¿›å…¥Podè¿›è¡Œç½‘ç»œæµ‹è¯•**ï¼š

```bash
# è¿›å…¥è¿è¡Œä¸­çš„Pod
kubectl exec -it <pod-name> -- /bin/bash

# åœ¨Podå†…æµ‹è¯•ç½‘ç»œè¿é€šæ€§
ping www.baidu.com
nslookup kubernetes.default.svc.cluster.local

# å¦‚æœPodå†…æ²¡æœ‰pingå‘½ä»¤ï¼Œå¯ä»¥ç”¨è¿™ä¸ªä¸€æ¬¡æ€§æµ‹è¯•Pod
kubectl run test-pod --image=busybox --rm -it --restart=Never -- ping www.baidu.com
```

**âš ï¸ å¸¸è§é—®é¢˜å’Œè§£å†³**ï¼š
- **é—®é¢˜**ï¼šPodå†…pingå‘½ä»¤ä¸å­˜åœ¨
- **è§£å†³**ï¼šä½¿ç”¨busyboxé•œåƒæˆ–å®‰è£…ç½‘ç»œå·¥å…·
- **åŸå› **ï¼šå¾ˆå¤šåº”ç”¨é•œåƒä¸ºäº†å®‰å…¨å’Œä½“ç§¯è€ƒè™‘ï¼Œä¸åŒ…å«è°ƒè¯•å·¥å…·

---

## 3. ğŸ  Podé—´é€šä¿¡æ•…éšœè¯Šæ–­


### 3.1 ç†è§£Podé—´é€šä¿¡çš„å·¥ä½œåŸç†


**ç®€å•æ¯”å–»**ï¼šPodé—´é€šä¿¡å°±åƒå°åŒºå†…ä¸åŒæˆ¿é—´çš„ä½æˆ·äº’ç›¸ä¸²é—¨ã€‚æ¯ä¸ªPodéƒ½æœ‰è‡ªå·±çš„"é—¨ç‰Œå·"ï¼ˆIPåœ°å€ï¼‰ï¼Œé€šè¿‡å°åŒºå†…éƒ¨çš„"é“è·¯ç³»ç»Ÿ"ï¼ˆç½‘ç»œæ’ä»¶ï¼‰æ¥è®¿é—®å½¼æ­¤ã€‚

### 3.2 Pod IPåœ°å€åˆ†é…é—®é¢˜


**æ£€æŸ¥Podçš„IPåœ°å€åˆ†é…**ï¼š

```bash
# æŸ¥çœ‹Podçš„IPåœ°å€å’ŒçŠ¶æ€
kubectl get pods -o wide

# è¯¦ç»†æŸ¥çœ‹Podç½‘ç»œä¿¡æ¯
kubectl describe pod <pod-name>

# æŸ¥çœ‹Podçš„ç½‘ç»œå‘½åç©ºé—´
kubectl exec <pod-name> -- ip addr show
```

**ğŸ”¸ IPåœ°å€é—®é¢˜çš„å…¸å‹ç—‡çŠ¶**ï¼š
```
æ­£å¸¸æƒ…å†µï¼š
NAME    READY   STATUS    IP           NODE
app-1   1/1     Running   10.244.1.5   worker1
app-2   1/1     Running   10.244.2.3   worker2

å¼‚å¸¸æƒ…å†µï¼š
NAME    READY   STATUS    IP         NODE
app-1   0/1     Pending   <none>     <none>
app-2   1/1     Running   <none>     worker1  # IPä¸ºç©º
```

### 3.3 åŒèŠ‚ç‚¹Podé€šä¿¡æµ‹è¯•


**æµ‹è¯•åŒä¸€èŠ‚ç‚¹ä¸Šçš„Podäº’ç›¸è®¿é—®**ï¼š

```bash
# åˆ›å»ºä¸¤ä¸ªæµ‹è¯•Podåœ¨åŒä¸€èŠ‚ç‚¹
kubectl run pod1 --image=busybox --command -- sleep 3600
kubectl run pod2 --image=busybox --command -- sleep 3600

# ç­‰å¾…Podå¯åŠ¨å®Œæˆ
kubectl wait --for=condition=Ready pod/pod1 pod/pod2

# è·å–Pod IP
kubectl get pods -o wide

# ä»pod1 ping pod2
kubectl exec pod1 -- ping <pod2-IP>
```

### 3.4 è·¨èŠ‚ç‚¹Podé€šä¿¡æµ‹è¯•


**ç†è§£è·¨èŠ‚ç‚¹é€šä¿¡**ï¼š
å°±åƒä¸åŒæ¥¼æ ‹çš„ä½æˆ·è¦ä¸²é—¨ï¼Œéœ€è¦é€šè¿‡å°åŒºçš„ä¸»å¹²é“è·¯ã€‚è¿™æ—¶å°±éœ€è¦ç½‘ç»œæ’ä»¶æ¥"ä¿®è·¯æ­æ¡¥"ã€‚

```bash
# å¼ºåˆ¶å°†Podè°ƒåº¦åˆ°ä¸åŒèŠ‚ç‚¹
apiVersion: v1
kind: Pod
metadata:
  name: pod-node1
spec:
  nodeSelector:
    kubernetes.io/hostname: worker1
  containers:
  - name: busybox
    image: busybox
    command: ["sleep", "3600"]

---
apiVersion: v1
kind: Pod
metadata:
  name: pod-node2  
spec:
  nodeSelector:
    kubernetes.io/hostname: worker2
  containers:
  - name: busybox
    image: busybox
    command: ["sleep", "3600"]
```

**æµ‹è¯•è·¨èŠ‚ç‚¹é€šä¿¡**ï¼š

```bash
# åº”ç”¨ä¸Šè¿°é…ç½®
kubectl apply -f cross-node-pods.yaml

# æµ‹è¯•è·¨èŠ‚ç‚¹Podé€šä¿¡
kubectl exec pod-node1 -- ping <pod-node2çš„IP>
```

### 3.5 Podé€šä¿¡æ•…éšœçš„å¸¸è§åŸå› 


**ğŸ”¸ ç½‘ç»œæ’ä»¶é—®é¢˜**ï¼š
- CNIæ’ä»¶æœªæ­£ç¡®å®‰è£…æˆ–é…ç½®
- ç½‘ç»œæ’ä»¶Podå¤„äºå¼‚å¸¸çŠ¶æ€
- IPåœ°å€æ± è€—å°½

**ğŸ”¸ èŠ‚ç‚¹ç½‘ç»œé—®é¢˜**ï¼š
- èŠ‚ç‚¹é—´è·¯ç”±é…ç½®é”™è¯¯
- é˜²ç«å¢™è§„åˆ™é˜»å¡
- ç½‘ç»œæ¥å£é…ç½®é—®é¢˜

**æ’æŸ¥å‘½ä»¤æ±‡æ€»**ï¼š

```bash
# æ£€æŸ¥ç½‘ç»œæ’ä»¶PodçŠ¶æ€
kubectl get pods -n kube-system | grep -E "(calico|flannel|weave)"

# æŸ¥çœ‹èŠ‚ç‚¹ç½‘ç»œæ¥å£
kubectl get nodes -o wide
ip route show  # åœ¨èŠ‚ç‚¹ä¸Šæ‰§è¡Œ

# æ£€æŸ¥iptablesè§„åˆ™
iptables -L -n  # åœ¨èŠ‚ç‚¹ä¸Šæ‰§è¡Œ
```

---

## 4. ğŸ¯ Serviceè®¿é—®é—®é¢˜æ’æŸ¥


### 4.1 ç†è§£Serviceçš„ä½œç”¨


**ç®€å•æ¯”å–»**ï¼šServiceå°±åƒå°åŒºçš„"å‰å°æ¥å¾…"ï¼Œå¤–é¢çš„äººä¸éœ€è¦çŸ¥é“å…·ä½“ä½æˆ·çš„æˆ¿é—´å·ï¼Œåªè¦å‘Šè¯‰å‰å°è¦æ‰¾è°ï¼Œå‰å°ä¼šå¸®å¿™è½¬æ¥åˆ°æ­£ç¡®çš„æˆ¿é—´ã€‚

**ğŸ”¸ Serviceçš„æ ¸å¿ƒä½œç”¨**ï¼š
- **è´Ÿè½½å‡è¡¡**ï¼šå°†è¯·æ±‚åˆ†å‘åˆ°å¤šä¸ªPod
- **æœåŠ¡å‘ç°**ï¼šæä¾›ç¨³å®šçš„è®¿é—®å…¥å£
- **æ•…éšœè½¬ç§»**ï¼šè‡ªåŠ¨å‰”é™¤ä¸å¥åº·çš„Pod

### 4.2 ServiceåŸºç¡€çŠ¶æ€æ£€æŸ¥


```bash
# æŸ¥çœ‹Serviceåˆ—è¡¨
kubectl get services
kubectl get svc  # ç®€å†™

# è¯¦ç»†æŸ¥çœ‹Serviceé…ç½®
kubectl describe svc <service-name>

# æŸ¥çœ‹Serviceçš„Endpointsï¼ˆé‡è¦ï¼ï¼‰
kubectl get endpoints <service-name>
kubectl get ep <service-name>  # ç®€å†™
```

**ğŸ”¸ æ­£å¸¸Serviceçš„çŠ¶æ€ç¤ºä¾‹**ï¼š
```
NAME         TYPE        CLUSTER-IP      PORT(S)   AGE
web-service  ClusterIP   10.96.100.150   80/TCP    5m

ENDPOINTS:
NAME         ENDPOINTS                          AGE  
web-service  10.244.1.5:80,10.244.2.3:80      5m
```

**âŒ å¼‚å¸¸Serviceçš„çŠ¶æ€**ï¼š
```
NAME         TYPE        CLUSTER-IP      PORT(S)   AGE
web-service  ClusterIP   10.96.100.150   80/TCP    5m

ENDPOINTS:
NAME         ENDPOINTS   AGE  
web-service  <none>      5m    # æ²¡æœ‰å¯ç”¨çš„Pod
```

### 4.3 ClusterIPç±»å‹Serviceé—®é¢˜æ’æŸ¥


**ClusterIPæ˜¯ä»€ä¹ˆ**ï¼š
å°±åƒå°åŒºå†…éƒ¨çš„å†…çº¿ç”µè¯ï¼Œåªèƒ½åœ¨å°åŒºå†…éƒ¨ä½¿ç”¨ï¼Œå¤–é¢çš„äººæ‰“ä¸è¿›æ¥ã€‚

**æµ‹è¯•ClusterIPè®¿é—®**ï¼š

```bash
# åœ¨é›†ç¾¤å†…åˆ›å»ºæµ‹è¯•Pod
kubectl run test-pod --image=busybox --rm -it --restart=Never -- /bin/sh

# åœ¨æµ‹è¯•Podå†…è®¿é—®Service
wget -O- <service-cluster-ip>:<port>
# æˆ–è€…
nslookup <service-name>.<namespace>.svc.cluster.local
```

**ğŸ”§ ClusterIPé—®é¢˜æ’æŸ¥æ­¥éª¤**ï¼š

```
ç¬¬1æ­¥ï¼šæ£€æŸ¥Serviceé…ç½®
      â†“
ç¬¬2æ­¥ï¼šæ£€æŸ¥Endpointsæ˜¯å¦æœ‰Pod
      â†“  
ç¬¬3æ­¥ï¼šæ£€æŸ¥Podæ ‡ç­¾æ˜¯å¦åŒ¹é…
      â†“
ç¬¬4æ­¥ï¼šæµ‹è¯•Podç«¯å£æ˜¯å¦æ­£å¸¸
      â†“
ç¬¬5æ­¥ï¼šæ£€æŸ¥kube-proxyçŠ¶æ€
```

### 4.4 NodePortç±»å‹Serviceé—®é¢˜æ’æŸ¥


**NodePortæ˜¯ä»€ä¹ˆ**ï¼š
å°±åƒåœ¨å°åŒºå¤§é—¨å®‰è£…å¯¹è®²æœºï¼Œå¤–é¢çš„äººå¯ä»¥é€šè¿‡å¤§é—¨çš„å¯¹è®²æœºè”ç³»åˆ°é‡Œé¢çš„ä½æˆ·ã€‚

**æµ‹è¯•NodePortè®¿é—®**ï¼š

```bash
# æŸ¥çœ‹NodePortç«¯å£å·
kubectl get svc <service-name>

# ä»é›†ç¾¤å¤–éƒ¨è®¿é—®
curl <ä»»æ„èŠ‚ç‚¹IP>:<NodePortç«¯å£>

# åœ¨èŠ‚ç‚¹ä¸Šæ£€æŸ¥ç«¯å£ç›‘å¬
netstat -tlnp | grep <NodePortç«¯å£>
```

**å¸¸è§NodePorté—®é¢˜**ï¼š

| é—®é¢˜ç°è±¡ | **å¯èƒ½åŸå› ** | **è§£å†³æ–¹æ³•** |
|---------|-------------|-------------|
| ç«¯å£æ— æ³•è®¿é—® | é˜²ç«å¢™é˜»å¡ | `firewall-cmd --add-port=<ç«¯å£>/tcp --permanent` |
| è¿æ¥è¶…æ—¶ | kube-proxyå¼‚å¸¸ | `kubectl get pods -n kube-system \| grep proxy` |
| ç«¯å£å†²çª | ç«¯å£è¢«å ç”¨ | `netstat -tlnp \| grep <ç«¯å£>` æ£€æŸ¥å ç”¨è¿›ç¨‹ |

### 4.5 LoadBalancerç±»å‹Serviceé—®é¢˜


**LoadBalancerçš„å·¥ä½œåŸç†**ï¼š
å°±åƒå°åŒºè¯·äº†ä¸“ä¸šçš„ç‰©ä¸šå…¬å¸ï¼Œç”±ç‰©ä¸šæ¥ç»Ÿä¸€ç®¡ç†å¤–éƒ¨è®¿é—®ï¼Œæ¯”è‡ªå·±ç®¡ç†æ›´ä¸“ä¸šå¯é ã€‚

**æ£€æŸ¥LoadBalancerçŠ¶æ€**ï¼š

```bash
# æŸ¥çœ‹LoadBalancerçš„å¤–éƒ¨IPåˆ†é…
kubectl get svc <loadbalancer-service>

# æ­£å¸¸çŠ¶æ€åº”è¯¥æ˜¾ç¤ºEXTERNAL-IP
NAME              TYPE           EXTERNAL-IP     PORT(S)
web-loadbalancer  LoadBalancer   203.0.113.123   80:31234/TCP

# å¼‚å¸¸çŠ¶æ€ä¼šæ˜¾ç¤º<pending>
NAME              TYPE           EXTERNAL-IP   PORT(S)
web-loadbalancer  LoadBalancer   <pending>     80:31234/TCP
```

---

## 5. ğŸ” DNSè§£ææ•…éšœåˆ†æ


### 5.1 ç†è§£Kubernetesä¸­çš„DNSæœåŠ¡


**ç®€å•æ¯”å–»**ï¼šDNSå°±åƒå°åŒºçš„"ç”µè¯é»„é¡µ"ï¼Œä½æˆ·ä¸éœ€è¦è®°ä½æ¯ä¸ªé‚»å±…çš„å…·ä½“æˆ¿é—´å·ï¼Œåªè¦çŸ¥é“é‚»å±…çš„åå­—ï¼Œé€šè¿‡"é»„é¡µ"å°±èƒ½æ‰¾åˆ°å¯¹åº”çš„æˆ¿é—´ã€‚

**ğŸ”¸ DNSåœ¨Kubernetesä¸­çš„ä½œç”¨**ï¼š
- **æœåŠ¡å‘ç°**ï¼šé€šè¿‡æœåŠ¡åè®¿é—®ï¼Œæ— éœ€è®°ä½IPåœ°å€
- **è´Ÿè½½å‡è¡¡**ï¼šDNSè¿”å›çš„å¯èƒ½æ˜¯å¤šä¸ªPodçš„IP
- **è·¨å‘½åç©ºé—´é€šä¿¡**ï¼šæ”¯æŒå…¨é™å®šåŸŸåè®¿é—®

### 5.2 DNSæœåŠ¡çŠ¶æ€æ£€æŸ¥


```bash
# æ£€æŸ¥DNSæœåŠ¡PodçŠ¶æ€
kubectl get pods -n kube-system | grep -E "(dns|coredns)"

# æŸ¥çœ‹DNSæœåŠ¡çš„è¯¦ç»†ä¿¡æ¯
kubectl describe pods -n kube-system -l k8s-app=kube-dns

# æ£€æŸ¥DNSæœåŠ¡é…ç½®
kubectl get configmap -n kube-system coredns -o yaml
```

**ğŸ”¸ æ­£å¸¸DNSæœåŠ¡çŠ¶æ€**ï¼š
```
NAME                      READY   STATUS    RESTARTS   AGE
coredns-558bd4d5db-abc12  1/1     Running   0          2d
coredns-558bd4d5db-def34  1/1     Running   0          2d
```

### 5.3 DNSè§£ææµ‹è¯•æ–¹æ³•


**åœ¨Podå†…æµ‹è¯•DNSè§£æ**ï¼š

```bash
# åˆ›å»ºæµ‹è¯•Pod
kubectl run dns-test --image=busybox --rm -it --restart=Never -- /bin/sh

# åœ¨æµ‹è¯•Podå†…æ‰§è¡ŒDNSè§£ææµ‹è¯•
nslookup kubernetes.default.svc.cluster.local
nslookup <service-name>.<namespace>.svc.cluster.local

# æµ‹è¯•å¤–éƒ¨åŸŸåè§£æ
nslookup www.baidu.com
```

**ğŸ”¸ Kubernetes DNSè§£æè§„åˆ™**ï¼š

```
æœåŠ¡å‘ç°çš„åŸŸåæ ¼å¼ï¼š

åŒå‘½åç©ºé—´å†…ï¼š
<service-name>

è·¨å‘½åç©ºé—´ï¼š  
<service-name>.<namespace>

å®Œæ•´åŸŸåï¼š
<service-name>.<namespace>.svc.cluster.local

ç¤ºä¾‹ï¼š
web-service.default.svc.cluster.local
database.production.svc.cluster.local
```

### 5.4 å¸¸è§DNSé—®é¢˜åŠè§£å†³æ–¹æ¡ˆ


**ğŸ”¸ DNSæœåŠ¡æ— å“åº”**ï¼š

```bash
# æ£€æŸ¥DNSæœåŠ¡Podæ—¥å¿—
kubectl logs -n kube-system -l k8s-app=kube-dns

# é‡å¯DNSæœåŠ¡
kubectl delete pods -n kube-system -l k8s-app=kube-dns

# DNSæœåŠ¡ä¼šè‡ªåŠ¨é‡æ–°åˆ›å»ºPod
```

**ğŸ”¸ åŸŸåè§£æå¤±è´¥**ï¼š

```bash
# æ£€æŸ¥Podçš„DNSé…ç½®
kubectl exec <pod-name> -- cat /etc/resolv.conf

# æ­£å¸¸é…ç½®åº”è¯¥ç±»ä¼¼ï¼š
nameserver 10.96.0.10    # DNSæœåŠ¡çš„ClusterIP
search default.svc.cluster.local svc.cluster.local cluster.local
options ndots:5
```

**ğŸ”¸ DNSé…ç½®ä¿®å¤**ï¼š

```yaml
# å¦‚æœPodçš„DNSé…ç½®å¼‚å¸¸ï¼Œå¯ä»¥åœ¨Podå®šä¹‰ä¸­æ˜ç¡®æŒ‡å®š
apiVersion: v1
kind: Pod
metadata:
  name: dns-fix-pod
spec:
  dnsPolicy: ClusterFirst  # ä½¿ç”¨é›†ç¾¤DNS
  containers:
  - name: app
    image: nginx
```

---

## 6. ğŸ”Œ CNIç½‘ç»œæ’ä»¶é—®é¢˜


### 6.1 ç†è§£CNIç½‘ç»œæ’ä»¶çš„ä½œç”¨


**ç®€å•æ¯”å–»**ï¼šCNIç½‘ç»œæ’ä»¶å°±åƒå°åŒºçš„"ç½‘ç»œå·¥ç¨‹é˜Ÿ"ï¼Œè´Ÿè´£åœ¨ä¸åŒæ¥¼æ ‹ä¹‹é—´é“ºè®¾ç½‘çº¿ï¼Œç¡®ä¿æ¯ä¸ªæˆ¿é—´éƒ½èƒ½ä¸Šç½‘ï¼Œè€Œä¸”å„ä¸ªæˆ¿é—´ä¹‹é—´èƒ½å¤Ÿç›¸äº’é€šä¿¡ã€‚

**ğŸ”¸ å¸¸è§çš„CNIæ’ä»¶**ï¼š
- **Flannel**ï¼šç®€å•æ˜“ç”¨ï¼Œé€‚åˆåˆå­¦è€…
- **Calico**ï¼šåŠŸèƒ½ä¸°å¯Œï¼Œæ”¯æŒç½‘ç»œç­–ç•¥
- **Weave**ï¼šè‡ªåŠ¨åŠ å¯†ï¼Œå®‰å…¨æ€§å¥½

### 6.2 æ£€æŸ¥CNIæ’ä»¶çŠ¶æ€


```bash
# æŸ¥çœ‹ç½‘ç»œæ’ä»¶PodçŠ¶æ€
kubectl get pods -n kube-system | grep -E "(calico|flannel|weave|canal)"

# æŸ¥çœ‹CNIé…ç½®æ–‡ä»¶
ls -la /etc/cni/net.d/

# æŸ¥çœ‹CNIäºŒè¿›åˆ¶æ–‡ä»¶
ls -la /opt/cni/bin/
```

**ğŸ”¸ å¥åº·çš„CNIæ’ä»¶çŠ¶æ€ç¤ºä¾‹**ï¼š
```
# Flannelç¤ºä¾‹
NAME                    READY   STATUS    RESTARTS   AGE
kube-flannel-ds-abc12   1/1     Running   0          2d
kube-flannel-ds-def34   1/1     Running   0          2d

# Calicoç¤ºä¾‹  
NAME                     READY   STATUS    RESTARTS   AGE
calico-node-xyz89        1/1     Running   0          2d
calico-kube-controllers  1/1     Running   0          2d
```

### 6.3 CNIæ’ä»¶æ•…éšœæ’æŸ¥


**ğŸ”¸ æ’ä»¶Podå¼‚å¸¸å¤„ç†**ï¼š

```bash
# æŸ¥çœ‹æ’ä»¶Podæ—¥å¿—
kubectl logs -n kube-system <ç½‘ç»œæ’ä»¶Podåç§°>

# å¸¸è§é”™è¯¯æ—¥å¿—å…³é”®å­—ï¼š
# "failed to create pod sandbox"
# "network plugin is not ready"  
# "failed to find plugin"

# é‡å¯ç½‘ç»œæ’ä»¶ï¼ˆä»¥Flannelä¸ºä¾‹ï¼‰
kubectl delete pods -n kube-system -l app=flannel
```

**ğŸ”¸ ç½‘ç»œæ¥å£æ£€æŸ¥**ï¼š

```bash
# åœ¨èŠ‚ç‚¹ä¸Šæ£€æŸ¥ç½‘ç»œæ¥å£
ip link show

# æŸ¥çœ‹è·¯ç”±è¡¨
ip route show

# æ£€æŸ¥ç½‘æ¡¥é…ç½®ï¼ˆå¦‚æœä½¿ç”¨bridgeç½‘ç»œï¼‰
brctl show
```

### 6.4 IPåœ°å€æ± è€—å°½é—®é¢˜


**ä»€ä¹ˆæ˜¯IPåœ°å€æ± è€—å°½**ï¼š
å°±åƒå°åŒºçš„æˆ¿é—´å·ç”¨å®Œäº†ï¼Œæ–°ä½æˆ·æ¥äº†æ²¡æœ‰æˆ¿é—´å·å¯ä»¥åˆ†é…ã€‚

**æ£€æŸ¥å’Œè§£å†³IPæ± é—®é¢˜**ï¼š

```bash
# æŸ¥çœ‹å½“å‰Podæ•°é‡å’ŒIPä½¿ç”¨æƒ…å†µ
kubectl get pods --all-namespaces | wc -l

# æŸ¥çœ‹èŠ‚ç‚¹IPåˆ†é…æƒ…å†µï¼ˆFlannelç¤ºä¾‹ï¼‰
kubectl get nodes -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.spec.podCIDR}{"\n"}{end}'

# å¦‚æœIPæ± ä¸è¶³ï¼Œéœ€è¦é‡æ–°é…ç½®ç½‘ç»œæ’ä»¶çš„IPæ®µ
# ä¿®æ”¹ç½‘ç»œæ’ä»¶çš„é…ç½®æ–‡ä»¶ï¼Œæ‰©å¤§IPåœ°å€èŒƒå›´
```

---

## 7. ğŸ›¡ï¸ ç½‘ç»œç­–ç•¥é…ç½®é—®é¢˜


### 7.1 ç†è§£ç½‘ç»œç­–ç•¥çš„ä½œç”¨


**ç®€å•æ¯”å–»**ï¼šç½‘ç»œç­–ç•¥å°±åƒå°åŒºçš„"é—¨ç¦ç³»ç»Ÿ"ï¼Œå†³å®šå“ªäº›äººå¯ä»¥ä¸²é—¨ï¼Œå“ªäº›äººä¸èƒ½ä¸²é—¨ï¼Œä»¥åŠä»€ä¹ˆæ—¶å€™å¯ä»¥ä¸²é—¨ã€‚

**ğŸ”¸ ç½‘ç»œç­–ç•¥çš„æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- **å…¥ç«™è§„åˆ™ï¼ˆIngressï¼‰**ï¼šè°å¯ä»¥è®¿é—®æˆ‘
- **å‡ºç«™è§„åˆ™ï¼ˆEgressï¼‰**ï¼šæˆ‘å¯ä»¥è®¿é—®è°
- **æ ‡ç­¾é€‰æ‹©å™¨**ï¼šæ ¹æ®æ ‡ç­¾å†³å®šç­–ç•¥é€‚ç”¨èŒƒå›´

### 7.2 æ£€æŸ¥ç½‘ç»œç­–ç•¥é…ç½®


```bash
# æŸ¥çœ‹æ‰€æœ‰ç½‘ç»œç­–ç•¥
kubectl get networkpolicies --all-namespaces
kubectl get netpol --all-namespaces  # ç®€å†™

# æŸ¥çœ‹ç‰¹å®šç½‘ç»œç­–ç•¥è¯¦æƒ…
kubectl describe networkpolicy <policy-name> -n <namespace>
```

**ğŸ”¸ ç½‘ç»œç­–ç•¥ç¤ºä¾‹ç†è§£**ï¼š

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: web-netpol
spec:
  podSelector:
    matchLabels:
      app: web  # è¿™ä¸ªç­–ç•¥é€‚ç”¨äºæ ‡ç­¾ä¸ºapp=webçš„Pod
  policyTypes:
  - Ingress    # åªæ§åˆ¶å…¥ç«™æµé‡
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: frontend  # åªå…è®¸æ ‡ç­¾ä¸ºapp=frontendçš„Podè®¿é—®
    ports:
    - protocol: TCP
      port: 80
```

**ç”¨äººè¯è§£é‡Šä¸Šé¢çš„é…ç½®**ï¼š
åªæœ‰è´´ç€"frontend"æ ‡ç­¾çš„Podæ‰èƒ½é€šè¿‡80ç«¯å£è®¿é—®è´´ç€"web"æ ‡ç­¾çš„Podï¼Œå…¶ä»–æ‰€æœ‰Podéƒ½è¢«æ‹’ç»è®¿é—®ã€‚

### 7.3 ç½‘ç»œç­–ç•¥æ•…éšœæ’æŸ¥


**ğŸ”¸ è¿æ¥è¢«æ‹’ç»çš„æ’æŸ¥**ï¼š

```bash
# 1. æ£€æŸ¥Podæ ‡ç­¾æ˜¯å¦æ­£ç¡®
kubectl get pods --show-labels

# 2. æ£€æŸ¥ç½‘ç»œç­–ç•¥æ˜¯å¦åŒ¹é…
kubectl get networkpolicy -o yaml

# 3. æµ‹è¯•ç½‘ç»œè¿é€šæ€§
kubectl run test-pod --image=busybox --labels="app=frontend" --rm -it --restart=Never
# åœ¨Podå†…æµ‹è¯•è®¿é—®
wget -O- <target-pod-ip>:80
```

**ğŸ”¸ ç½‘ç»œç­–ç•¥ä¸ç”Ÿæ•ˆçš„åŸå› **ï¼š

| é—®é¢˜ | **åŸå› ** | **è§£å†³æ–¹æ³•** |
|------|---------|-------------|
| ç­–ç•¥ä¸ç”Ÿæ•ˆ | CNIæ’ä»¶ä¸æ”¯æŒNetworkPolicy | ä½¿ç”¨Calicoç­‰æ”¯æŒç­–ç•¥çš„æ’ä»¶ |
| è¿æ¥è¢«è¯¯æ‹’ | æ ‡ç­¾é€‰æ‹©å™¨é…ç½®é”™è¯¯ | æ£€æŸ¥Podæ ‡ç­¾å’Œç­–ç•¥é€‰æ‹©å™¨åŒ¹é… |
| æ— æ³•è®¿é—®å¤–éƒ¨ | ç¼ºå°‘Egressè§„åˆ™ | æ·»åŠ å…è®¸å¤–éƒ¨è®¿é—®çš„å‡ºç«™è§„åˆ™ |

### 7.4 å¸¸è§ç½‘ç»œç­–ç•¥åœºæ™¯


**ğŸ”¸ æ‹’ç»æ‰€æœ‰æµé‡ï¼ˆé»˜è®¤æ‹’ç»ï¼‰**ï¼š

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy  
metadata:
  name: deny-all
spec:
  podSelector: {}  # ç©ºé€‰æ‹©å™¨è¡¨ç¤ºæ‰€æœ‰Pod
  policyTypes:
  - Ingress
  - Egress
  # æ²¡æœ‰ä»»ä½•å…è®¸è§„åˆ™ï¼Œç›¸å½“äºæ‹’ç»æ‰€æœ‰
```

**ğŸ”¸ åªå…è®¸åŒå‘½åç©ºé—´é€šä¿¡**ï¼š

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-same-namespace
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: production  # åªå…è®¸æ¥è‡ªproductionå‘½åç©ºé—´çš„æµé‡
```

---

## 8. ğŸšª ç«¯å£å’Œé˜²ç«å¢™é—®é¢˜


### 8.1 ç†è§£ç«¯å£åœ¨Kubernetesä¸­çš„ä½œç”¨


**ç®€å•æ¯”å–»**ï¼šç«¯å£å°±åƒæˆ¿é—´çš„ä¸åŒé—¨ï¼Œæœ‰çš„æ˜¯å‰é—¨ï¼ˆWebæœåŠ¡ï¼‰ï¼Œæœ‰çš„æ˜¯åé—¨ï¼ˆæ•°æ®åº“ï¼‰ï¼Œæœ‰çš„æ˜¯ä¾§é—¨ï¼ˆAPIæ¥å£ï¼‰ã€‚æ¯ä¸ªæœåŠ¡éƒ½éœ€è¦ç‰¹å®šçš„"é—¨"æ¥æä¾›æœåŠ¡ã€‚

### 8.2 ç«¯å£å†²çªé—®é¢˜æ’æŸ¥


**ä»€ä¹ˆæ˜¯ç«¯å£å†²çª**ï¼š
å°±åƒä¸¤ä¸ªæœåŠ¡éƒ½æƒ³ä½¿ç”¨åŒä¸€ä¸ª"é—¨"ï¼Œç»“æœè°éƒ½è¿›ä¸å»ã€‚

```bash
# æ£€æŸ¥èŠ‚ç‚¹ä¸Šç«¯å£å ç”¨æƒ…å†µ
netstat -tlnp | grep <ç«¯å£å·>

# æŸ¥çœ‹è¿›ç¨‹å ç”¨ç«¯å£
lsof -i :<ç«¯å£å·>

# æ£€æŸ¥KubernetesæœåŠ¡ç«¯å£ä½¿ç”¨
kubectl get svc --all-namespaces | grep <ç«¯å£å·>
```

**ğŸ”¸ NodePortç«¯å£å†²çªç¤ºä¾‹**ï¼š
```
# é”™è¯¯æƒ…å†µï¼šä¸¤ä¸ªæœåŠ¡å°è¯•ä½¿ç”¨åŒä¸€ä¸ªNodePort
service1: NodePort 30080
service2: NodePort 30080  # å†²çªï¼

# è§£å†³æ–¹æ³•ï¼šä½¿ç”¨ä¸åŒç«¯å£æˆ–è®©Kubernetesè‡ªåŠ¨åˆ†é…
apiVersion: v1
kind: Service
metadata:
  name: web-service
spec:
  type: NodePort
  ports:
  - port: 80
    targetPort: 8080
    # nodePort: 30080  # æ³¨é‡Šæ‰ï¼Œè®©ç³»ç»Ÿè‡ªåŠ¨åˆ†é…
  selector:
    app: web
```

### 8.3 é˜²ç«å¢™è§„åˆ™æ£€æŸ¥


**ä¸ºä»€ä¹ˆé˜²ç«å¢™ä¼šå½±å“Kubernetes**ï¼š
é˜²ç«å¢™å°±åƒå°åŒºçš„ä¿å®‰ï¼Œå¦‚æœä¿å®‰å¤ªä¸¥æ ¼ï¼Œè¿æ­£å¸¸çš„è®¿å®¢éƒ½ä¸è®©è¿›ï¼Œå°±ä¼šå½±å“æ­£å¸¸çš„æœåŠ¡ã€‚

```bash
# CentOS/RHELç³»ç»Ÿæ£€æŸ¥é˜²ç«å¢™
systemctl status firewalld
firewall-cmd --list-all

# Ubuntuç³»ç»Ÿæ£€æŸ¥é˜²ç«å¢™  
ufw status verbose

# æŸ¥çœ‹iptablesè§„åˆ™ï¼ˆKubernetesä¼šå¤§é‡ä½¿ç”¨iptablesï¼‰
iptables -L -n | head -20
```

**ğŸ”¸ å¸¸è§é˜²ç«å¢™é—®é¢˜è§£å†³**ï¼š

```bash
# å¼€æ”¾Kuberneteså¿…éœ€ç«¯å£ï¼ˆåœ¨æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œï¼‰

# MasterèŠ‚ç‚¹ç«¯å£
firewall-cmd --permanent --add-port=6443/tcp    # API Server
firewall-cmd --permanent --add-port=2379-2380/tcp  # etcd
firewall-cmd --permanent --add-port=10250/tcp   # kubelet
firewall-cmd --permanent --add-port=10251/tcp   # kube-scheduler
firewall-cmd --permanent --add-port=10252/tcp   # kube-controller

# WorkerèŠ‚ç‚¹ç«¯å£
firewall-cmd --permanent --add-port=10250/tcp   # kubelet
firewall-cmd --permanent --add-port=30000-32767/tcp  # NodePortæœåŠ¡

# é‡è½½é˜²ç«å¢™è§„åˆ™
firewall-cmd --reload
```

### 8.4 Serviceç«¯å£æ˜ å°„é—®é¢˜


**ç†è§£ç«¯å£æ˜ å°„**ï¼š
- **port**ï¼šServiceè‡ªå·±çš„ç«¯å£ï¼ˆå°åŒºå‰å°çš„ç”µè¯å·ç ï¼‰
- **targetPort**ï¼šPodå†…åº”ç”¨çš„ç«¯å£ï¼ˆä½æˆ·æˆ¿é—´å†…çš„ç”µè¯ï¼‰  
- **nodePort**ï¼šèŠ‚ç‚¹å¯¹å¤–æš´éœ²çš„ç«¯å£ï¼ˆå°åŒºå¤§é—¨çš„é—¨ç‰Œå·ï¼‰

```yaml
# ç«¯å£æ˜ å°„é…ç½®ç¤ºä¾‹
apiVersion: v1
kind: Service
metadata:
  name: web-service
spec:
  type: NodePort
  ports:
  - name: web
    port: 80        # Serviceç«¯å£ï¼ˆé›†ç¾¤å†…è®¿é—®ç”¨è¿™ä¸ªç«¯å£ï¼‰
    targetPort: 8080  # Podå†…åº”ç”¨ç«¯å£ï¼ˆåº”ç”¨å®é™…ç›‘å¬çš„ç«¯å£ï¼‰
    nodePort: 30080   # èŠ‚ç‚¹ç«¯å£ï¼ˆå¤–éƒ¨è®¿é—®ç”¨è¿™ä¸ªç«¯å£ï¼‰
  selector:
    app: web
```

**ç«¯å£é—®é¢˜æ’æŸ¥æ­¥éª¤**ï¼š

```
1. æ£€æŸ¥Podå†…åº”ç”¨æ˜¯å¦æ­£åœ¨ç›‘å¬targetPort
   kubectl exec <pod> -- netstat -tlnp

2. æ£€æŸ¥Serviceçš„porté…ç½®æ˜¯å¦æ­£ç¡®
   kubectl describe svc <service-name>

3. æ£€æŸ¥nodePortæ˜¯å¦è¢«å…¶ä»–æœåŠ¡å ç”¨
   kubectl get svc --all-namespaces | grep 30080

4. æµ‹è¯•å„å±‚ç«¯å£è¿é€šæ€§
   Podå†…æµ‹è¯• â†’ Serviceæµ‹è¯• â†’ NodePortæµ‹è¯•
```

---

## 9. ğŸ›£ï¸ è·¯ç”±å’Œæ€§èƒ½é—®é¢˜


### 9.1 ç†è§£Kubernetesä¸­çš„è·¯ç”±


**ç®€å•æ¯”å–»**ï¼šè·¯ç”±å°±åƒåŸå¸‚çš„äº¤é€šæŒ‡ç¤ºç‰Œï¼Œå‘Šè¯‰æ•°æ®åŒ…åº”è¯¥èµ°å“ªæ¡è·¯æ‰èƒ½åˆ°è¾¾ç›®çš„åœ°ã€‚å¦‚æœæŒ‡ç¤ºç‰Œé”™äº†æˆ–è€…é“è·¯å µå¡ï¼Œæ•°æ®å°±åˆ°ä¸äº†ç›®çš„åœ°ã€‚

### 9.2 è·¯ç”±è¡¨åˆ†æ


```bash
# åœ¨èŠ‚ç‚¹ä¸ŠæŸ¥çœ‹è·¯ç”±è¡¨
ip route show

# æŸ¥çœ‹ç‰¹å®šç›®æ ‡çš„è·¯ç”±
ip route get <ç›®æ ‡IP>

# è·Ÿè¸ªæ•°æ®åŒ…è·¯å¾„
traceroute <ç›®æ ‡IP>
```

**ğŸ”¸ æ­£å¸¸è·¯ç”±è¡¨ç¤ºä¾‹**ï¼š
```
default via 192.168.1.1 dev eth0              # é»˜è®¤ç½‘å…³
10.244.0.0/16 via 10.244.1.1 dev flannel.1    # Podç½‘æ®µè·¯ç”±  
10.96.0.0/12 dev kube-ipvs0 scope link         # Serviceç½‘æ®µ
192.168.1.0/24 dev eth0 scope link             # èŠ‚ç‚¹ç½‘æ®µ
```

### 9.3 ç½‘ç»œæ€§èƒ½é—®é¢˜è¯Šæ–­


**ğŸ”¸ å»¶è¿Ÿæµ‹è¯•**ï¼š

```bash
# æµ‹è¯•Podé—´å»¶è¿Ÿ
kubectl exec <pod1> -- ping -c 10 <pod2-ip>

# æµ‹è¯•åˆ°å¤–éƒ¨æœåŠ¡çš„å»¶è¿Ÿ  
kubectl exec <pod> -- ping -c 10 www.baidu.com

# åˆ†æå»¶è¿Ÿç»Ÿè®¡
# æ­£å¸¸æƒ…å†µï¼šå»¶è¿Ÿåº”è¯¥åœ¨å‡ æ¯«ç§’ä»¥å†…ï¼ˆåŒæœºæˆ¿ï¼‰
# å¼‚å¸¸æƒ…å†µï¼šå»¶è¿Ÿè¶…è¿‡100msæˆ–æ³¢åŠ¨å¾ˆå¤§
```

**ğŸ”¸ å¸¦å®½æµ‹è¯•**ï¼š

```bash
# ä½¿ç”¨iperfæµ‹è¯•ç½‘ç»œå¸¦å®½
# åœ¨ç›®æ ‡Podå¯åŠ¨æœåŠ¡ç«¯
kubectl exec <server-pod> -- iperf3 -s

# åœ¨å®¢æˆ·ç«¯Podæµ‹è¯•å¸¦å®½
kubectl exec <client-pod> -- iperf3 -c <server-pod-ip>

# æ­£å¸¸æƒ…å†µï¼šå¸¦å®½æ¥è¿‘ç‰©ç†ç½‘å¡å¸¦å®½
# å¼‚å¸¸æƒ…å†µï¼šå¸¦å®½æ˜æ˜¾ä½äºé¢„æœŸ
```

### 9.4 DNSæŸ¥è¯¢æ€§èƒ½é—®é¢˜


**DNSæŸ¥è¯¢æ…¢çš„æ’æŸ¥**ï¼š

```bash
# æµ‹è¯•DNSæŸ¥è¯¢æ—¶é—´
kubectl exec <pod> -- time nslookup kubernetes.default.svc.cluster.local

# æ­£å¸¸æƒ…å†µï¼šæŸ¥è¯¢æ—¶é—´åœ¨æ¯«ç§’çº§
# å¼‚å¸¸æƒ…å†µï¼šæŸ¥è¯¢æ—¶é—´è¶…è¿‡1ç§’

# æ£€æŸ¥DNSæœåŠ¡è´Ÿè½½
kubectl top pods -n kube-system | grep dns

# å¦‚æœDNSæœåŠ¡è´Ÿè½½è¿‡é«˜ï¼Œè€ƒè™‘ï¼š
# 1. å¢åŠ DNSæœåŠ¡å‰¯æœ¬æ•°
# 2. è°ƒæ•´DNSç¼“å­˜ç­–ç•¥
# 3. ä½¿ç”¨æœ¬åœ°DNSç¼“å­˜
```

---

## 10. ğŸ”§ ç½‘ç»œç›‘æ§å·¥å…·


### 10.1 åŸºæœ¬ç½‘ç»œè°ƒè¯•å·¥å…·


**åœ¨Podå†…å¯ç”¨çš„è°ƒè¯•å·¥å…·**ï¼š

```bash
# åˆ›å»ºä¸€ä¸ªåŒ…å«ç½‘ç»œå·¥å…·çš„è°ƒè¯•Pod
kubectl run netshoot --image=nicolaka/netshoot --rm -it --restart=Never

# è¿™ä¸ªé•œåƒåŒ…å«äº†å¤§é‡ç½‘ç»œè°ƒè¯•å·¥å…·ï¼š
# ping, traceroute, nslookup, dig, curl, wget
# tcpdump, iftop, netstat, ss, lsof
# iperf3, mtr, nmap ç­‰
```

**ğŸ”¸ å¸¸ç”¨è°ƒè¯•å‘½ä»¤**ï¼š

| å·¥å…· | **ç”¨é€”** | **ç¤ºä¾‹å‘½ä»¤** |
|------|---------|-------------|
| `ping` | æµ‹è¯•è¿é€šæ€§ | `ping <ç›®æ ‡IP>` |
| `nslookup` | DNSæŸ¥è¯¢ | `nslookup <åŸŸå>` |
| `curl` | HTTPæµ‹è¯• | `curl -v http://<service>` |
| `tcpdump` | æŠ“åŒ…åˆ†æ | `tcpdump -i any port 80` |
| `netstat` | ç«¯å£ç›‘å¬ | `netstat -tlnp` |

### 10.2 æŠ“åŒ…åˆ†æ


**ä»€ä¹ˆæ—¶å€™éœ€è¦æŠ“åŒ…**ï¼š
å½“å…¶ä»–æ–¹æ³•éƒ½æ— æ³•å®šä½é—®é¢˜æ—¶ï¼ŒæŠ“åŒ…å°±åƒ"ç›‘æ§å½•åƒ"ï¼Œèƒ½çœ‹åˆ°ç½‘ç»œæ•°æ®åŒ…çš„è¯¦ç»†ä¼ è¾“è¿‡ç¨‹ã€‚

```bash
# åœ¨èŠ‚ç‚¹ä¸ŠæŠ“åŒ…
tcpdump -i any host <pod-ip> -w /tmp/capture.pcap

# æŠ“å–ç‰¹å®šç«¯å£çš„åŒ…
tcpdump -i any port 80 -w /tmp/http.pcap

# å®æ—¶æŸ¥çœ‹åŒ…å†…å®¹
tcpdump -i any host <pod-ip> -A

# åœ¨Podå†…æŠ“åŒ…ï¼ˆéœ€è¦ç‰¹æƒå®¹å™¨ï¼‰
kubectl exec <netshoot-pod> -- tcpdump -i eth0 -c 10
```

### 10.3 ç½‘ç»œæ€§èƒ½ç›‘æ§


**æŒç»­ç›‘æ§ç½‘ç»œçŠ¶æ€**ï¼š

```bash
# ä½¿ç”¨iftopæŸ¥çœ‹å®æ—¶ç½‘ç»œæµé‡
kubectl exec <netshoot-pod> -- iftop -i eth0

# ä½¿ç”¨ssæŸ¥çœ‹è¿æ¥çŠ¶æ€
kubectl exec <pod> -- ss -tunlp

# æŸ¥çœ‹ç½‘ç»œæ¥å£ç»Ÿè®¡
kubectl exec <pod> -- cat /proc/net/dev
```

**ğŸ”¸ å»ºç«‹ç›‘æ§æŒ‡æ ‡**ï¼š
- **å»¶è¿Ÿç›‘æ§**ï¼šPodé—´pingå“åº”æ—¶é—´
- **å¸¦å®½ç›‘æ§**ï¼šç½‘ç»œæ¥å£æµé‡ç»Ÿè®¡
- **é”™è¯¯ç‡ç›‘æ§**ï¼šä¸¢åŒ…ç‡ã€è¿æ¥å¤±è´¥ç‡
- **DNSç›‘æ§**ï¼šDNSæŸ¥è¯¢å“åº”æ—¶é—´

---

## 11. âš¡ å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ


### 11.1 Podæ— æ³•å¯åŠ¨çš„ç½‘ç»œé—®é¢˜


**ğŸ”¸ é—®é¢˜ç°è±¡**ï¼š
```
NAME        READY   STATUS              RESTARTS   AGE
my-app      0/1     ContainerCreating   0          5m
```

**æ’æŸ¥å’Œè§£å†³æ­¥éª¤**ï¼š

```bash
# 1. æŸ¥çœ‹Podè¯¦ç»†äº‹ä»¶
kubectl describe pod <pod-name>

# å¸¸è§é”™è¯¯ä¿¡æ¯ï¼š
# "network plugin is not ready"
# "failed to create pod sandbox"

# 2. æ£€æŸ¥ç½‘ç»œæ’ä»¶çŠ¶æ€
kubectl get pods -n kube-system | grep -E "(calico|flannel|weave)"

# 3. å¦‚æœç½‘ç»œæ’ä»¶å¼‚å¸¸ï¼Œé‡å¯ç½‘ç»œæ’ä»¶
kubectl delete pods -n kube-system -l k8s-app=<ç½‘ç»œæ’ä»¶å>

# 4. æ£€æŸ¥èŠ‚ç‚¹ç½‘ç»œé…ç½®
ip addr show
ip route show
```

### 11.2 Serviceæ— æ³•è®¿é—®çš„é—®é¢˜


**ğŸ”¸ ç³»ç»Ÿæ€§æ’æŸ¥æµç¨‹**ï¼š

```
æ­¥éª¤1ï¼šæ£€æŸ¥Endpoints
       kubectl get ep <service-name>
       â†“
æ­¥éª¤2ï¼šæ£€æŸ¥Podæ ‡ç­¾åŒ¹é…
       kubectl get pods --show-labels
       â†“
æ­¥éª¤3ï¼šæ£€æŸ¥Podç«¯å£ç›‘å¬
       kubectl exec <pod> -- netstat -tlnp
       â†“
æ­¥éª¤4ï¼šæ£€æŸ¥kube-proxyçŠ¶æ€
       kubectl get pods -n kube-system | grep proxy
       â†“
æ­¥éª¤5ï¼šæµ‹è¯•ç›´æ¥Podè®¿é—®
       kubectl exec <test-pod> -- curl <pod-ip>:<port>
```

### 11.3 DNSè§£æå¤±è´¥é—®é¢˜


**ğŸ”¸ å¿«é€Ÿä¿®å¤æ–¹æ¡ˆ**ï¼š

```bash
# 1. é‡å¯DNSæœåŠ¡
kubectl delete pods -n kube-system -l k8s-app=kube-dns

# 2. æ¸…ç†DNSç¼“å­˜ï¼ˆåœ¨Podå†…ï¼‰
kubectl exec <pod> -- nscd -i hosts

# 3. æ£€æŸ¥DNSé…ç½®æ–‡ä»¶
kubectl exec <pod> -- cat /etc/resolv.conf

# 4. æ‰‹åŠ¨æŒ‡å®šDNSæœåŠ¡å™¨ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰
apiVersion: v1
kind: Pod
spec:
  dnsPolicy: None
  dnsConfig:
    nameservers:
    - 8.8.8.8
    - 8.8.4.4
```

### 11.4 ç½‘ç»œç­–ç•¥å¯¼è‡´çš„è®¿é—®é—®é¢˜


**ğŸ”¸ ä¸´æ—¶è§£é™¤ç½‘ç»œç­–ç•¥**ï¼š

```bash
# 1. æŸ¥çœ‹å½“å‰ç½‘ç»œç­–ç•¥
kubectl get networkpolicy

# 2. ä¸´æ—¶åˆ é™¤ç½‘ç»œç­–ç•¥è¿›è¡Œæµ‹è¯•
kubectl delete networkpolicy <policy-name>

# 3. æµ‹è¯•è¿é€šæ€§
kubectl exec <pod1> -- curl <pod2-ip>

# 4. å¦‚æœåˆ é™¤ç­–ç•¥åæ­£å¸¸ï¼Œè¯´æ˜æ˜¯ç­–ç•¥é…ç½®é—®é¢˜
# é‡æ–°åˆ›å»ºæ­£ç¡®çš„ç½‘ç»œç­–ç•¥
```

### 11.5 æ€§èƒ½é—®é¢˜è§£å†³


**ğŸ”¸ ç½‘ç»œæ€§èƒ½ä¼˜åŒ–å»ºè®®**ï¼š

| é—®é¢˜ç±»å‹ | **ä¼˜åŒ–æ–¹æ¡ˆ** | **é¢„æœŸæ•ˆæœ** |
|---------|-------------|-------------|
| å»¶è¿Ÿé«˜ | è°ƒæ•´Podäº²å’Œæ€§ï¼Œå°†é€šä¿¡é¢‘ç¹çš„Podè°ƒåº¦åˆ°åŒä¸€èŠ‚ç‚¹ | å»¶è¿Ÿé™ä½50-80% |
| å¸¦å®½ä½ | æ£€æŸ¥ç½‘ç»œæ’ä»¶é…ç½®ï¼Œå¯ç”¨ç¡¬ä»¶åŠ é€Ÿ | å¸¦å®½æå‡2-3å€ |
| DNSæ…¢ | éƒ¨ç½²æœ¬åœ°DNSç¼“å­˜ï¼ˆNodeLocal DNSCacheï¼‰ | DNSæŸ¥è¯¢æ—¶é—´å‡å°‘90% |
| è¿æ¥æ•°å¤š | è°ƒæ•´å†…æ ¸å‚æ•°ï¼Œå¢åŠ è¿æ¥æ•°é™åˆ¶ | æ”¯æŒæ›´å¤šå¹¶å‘è¿æ¥ |

---

## 12. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 12.1 å¿…é¡»æŒæ¡çš„åŸºç¡€æ¦‚å¿µ


```
ğŸ”¸ ç½‘ç»œè¿é€šæ€§ï¼šPodé—´ã€Serviceé—´ã€å†…å¤–éƒ¨é€šä¿¡çš„åŸºæœ¬åŸç†
ğŸ”¸ DNSæœåŠ¡ï¼šKuberneteså†…éƒ¨æœåŠ¡å‘ç°çš„æ ¸å¿ƒæœºåˆ¶
ğŸ”¸ CNIæ’ä»¶ï¼šè´Ÿè´£Podç½‘ç»œé…ç½®çš„æ ¸å¿ƒç»„ä»¶
ğŸ”¸ ç½‘ç»œç­–ç•¥ï¼šæ§åˆ¶Podé—´é€šä¿¡çš„å®‰å…¨æœºåˆ¶
ğŸ”¸ ç«¯å£æ˜ å°„ï¼šServiceå°†å¤–éƒ¨è®¿é—®å¯¼å‘å†…éƒ¨Podçš„æ–¹å¼
```

### 12.2 æ•…éšœæ’æŸ¥çš„é»„é‡‘æ³•åˆ™


**ğŸ”¹ å±‚æ¬¡åŒ–æ’æŸ¥**ï¼š
```
ä»ä¸‹å¾€ä¸Šé€å±‚æ’æŸ¥ï¼š
ç‰©ç†ç½‘ç»œ â†’ èŠ‚ç‚¹ç½‘ç»œ â†’ CNIç½‘ç»œ â†’ Kubernetesç½‘ç»œ â†’ åº”ç”¨ç½‘ç»œ

ä»ç®€å•åˆ°å¤æ‚ï¼š
è¿é€šæ€§æµ‹è¯• â†’ ç«¯å£æ£€æŸ¥ â†’ é…ç½®éªŒè¯ â†’ æ—¥å¿—åˆ†æ â†’ æŠ“åŒ…åˆ†æ
```

**ğŸ”¹ å¸¸ç”¨æ’æŸ¥å‘½ä»¤é€ŸæŸ¥**ï¼š
```bash
# åŸºç¡€è¿é€šæ€§
ping <ç›®æ ‡IP>
telnet <IP> <ç«¯å£>

# Kubernetesèµ„æº
kubectl get pods/svc/ep -o wide
kubectl describe pod/svc <åç§°>
kubectl logs <podåç§°>

# ç³»ç»Ÿç½‘ç»œ
ip addr show
ip route show  
netstat -tlnp
iptables -L -n
```

### 12.3 æœ€ä½³å®è·µå»ºè®®


**ğŸ”¹ é¢„é˜²æ€§æªæ–½**ï¼š
- **ç›‘æ§è®¾ç½®**ï¼šå»ºç«‹ç½‘ç»œå»¶è¿Ÿã€å¸¦å®½ã€é”™è¯¯ç‡ç›‘æ§
- **æ—¥å¿—æ”¶é›†**ï¼šé›†ä¸­æ”¶é›†ç½‘ç»œç»„ä»¶æ—¥å¿—
- **æ–‡æ¡£ç»´æŠ¤**ï¼šè®°å½•ç½‘ç»œæ‹“æ‰‘å’Œé…ç½®å˜æ›´
- **å®šæœŸæ£€æŸ¥**ï¼šå®šæœŸæ£€æŸ¥ç½‘ç»œæ’ä»¶å’ŒDNSæœåŠ¡çŠ¶æ€

**ğŸ”¹ æ•…éšœå¤„ç†åŸåˆ™**ï¼š
- **å¿«é€Ÿå®šä½**ï¼šä½¿ç”¨ç³»ç»ŸåŒ–çš„æ’æŸ¥æ–¹æ³•
- **æœ€å°å½±å“**ï¼šä¼˜å…ˆä½¿ç”¨å¯¹ä¸šåŠ¡å½±å“æœ€å°çš„æ–¹æ¡ˆ
- **æ ¹å› åˆ†æ**ï¼šè§£å†³é—®é¢˜ååˆ†ææ ¹æœ¬åŸå› 
- **é¢„é˜²å¤å‘**ï¼šå»ºç«‹ç›‘æ§å’Œé¢„è­¦æœºåˆ¶

**ğŸ”¹ å·¥å…·å‡†å¤‡**ï¼š
```bash
# å‡†å¤‡å¸¸ç”¨çš„ç½‘ç»œè°ƒè¯•é•œåƒ
kubectl run netshoot --image=nicolaka/netshoot --rm -it --restart=Never

# åœ¨é›†ç¾¤ä¸­ä¿ç•™ä¸€ä¸ªä¸“ç”¨çš„è°ƒè¯•å‘½åç©ºé—´
kubectl create namespace debug-tools
```

### 12.4 è®°å¿†è¦ç‚¹


**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
ç½‘ç»œæ•…éšœè«æ…Œå¼ ï¼Œåˆ†å±‚æ’æŸ¥æœ‰æ–¹æ³•
è¿é€šæµ‹è¯•ç¬¬ä¸€æ­¥ï¼ŒDNSè§£æç´§è·Ÿä¸Š  
ServiceæŸ¥Endpointsï¼ŒPodæ ‡ç­¾è¦åŒ¹é…
ç½‘ç»œæ’ä»¶çŠ¶æ€æŸ¥ï¼Œè·¯ç”±é˜²ç«å¢™åˆ«å¿˜
å·¥å…·å‡†å¤‡è¦å……åˆ†ï¼Œæ—¥å¿—ç›‘æ§å»ºç«‹å¥½
```

**ğŸ¯ å…³é”®ç†è§£**ï¼š
- Kubernetesç½‘ç»œæ˜¯"è½¯ä»¶å®šä¹‰ç½‘ç»œ"ï¼Œé—®é¢˜å¤šåœ¨é…ç½®è€Œéç¡¬ä»¶
- ç½‘ç»œæ•…éšœå¾€å¾€æ˜¯"è¿é”ååº”"ï¼Œè¦æ‰¾åˆ°æ ¹æœ¬åŸå› 
- å·¥å…·å’Œæ–¹æ³•æ¯”å…·ä½“æŠ€æœ¯æ›´é‡è¦ï¼ŒæŒæ¡ç³»ç»ŸåŒ–çš„æ’æŸ¥æ€è·¯
- é¢„é˜²èƒœäºæ²»ç–—ï¼Œè‰¯å¥½çš„ç›‘æ§æ¯”äº‹åæ’æŸ¥æ›´æœ‰ä»·å€¼

è¿™ä»½ç½‘ç»œæ•…éšœæ’æŸ¥æŒ‡å—æ¶µç›–äº†ä»åŸºç¡€è¿é€šæ€§æµ‹è¯•åˆ°å¤æ‚ç½‘ç»œç­–ç•¥é—®é¢˜çš„å®Œæ•´è§£å†³æ–¹æ¡ˆã€‚ä½œä¸ºæ–°æ‰‹ï¼Œå»ºè®®å…ˆæŒæ¡åŸºç¡€çš„è¿é€šæ€§æµ‹è¯•å’Œå¸¸è§é—®é¢˜è§£å†³æ–¹æ³•ï¼Œç„¶åé€æ­¥æ·±å…¥å­¦ä¹ é«˜çº§çš„ç½‘ç»œé…ç½®å’Œæ€§èƒ½ä¼˜åŒ–æŠ€å·§ã€‚