---
title: 5、故障排查诊断
---
## 📚 目录

1. [故障排查基础概念](#1-故障排查基础概念)
2. [kubectl诊断工具详解](#2-kubectl诊断工具详解)
3. [常见Pod故障分析](#3-常见Pod故障分析)
4. [网络连通性排查](#4-网络连通性排查)
5. [调试技巧与工具](#5-调试技巧与工具)
6. [实战故障处理流程](#6-实战故障处理流程)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 🔍 故障排查基础概念


### 1.1 什么是Kubernetes故障排查


**通俗理解**：就像医生给病人看病一样，当你的应用在K8s集群里出问题时，我们需要通过各种"检查工具"来找出问题所在，然后对症下药。

```
现实类比：
医生看病流程          K8s故障排查流程
询问症状       →     查看Pod状态
体格检查       →     检查资源详情  
化验检查       →     查看日志事件
确诊病情       →     定位根本原因
开药治疗       →     修复配置问题
```

### 1.2 故障排查的核心思路


**🎯 排查原则**：从外到内，从简单到复杂

```
故障排查金字塔：

    ┌─────────────────┐
    │   应用层问题     │ ← 代码bug、配置错误
    ├─────────────────┤
    │   Pod层问题     │ ← 资源不足、镜像问题  
    ├─────────────────┤
    │   网络层问题     │ ← 服务发现、连通性
    ├─────────────────┤
    │   节点层问题     │ ← 资源耗尽、硬件故障
    └─────────────────┘
```

**🔸 基本排查步骤**：
1. **看状态** - Pod是否正常运行
2. **看事件** - 系统告诉我们什么异常
3. **看日志** - 应用程序输出什么错误
4. **看资源** - CPU、内存是否充足
5. **看网络** - 服务间是否能正常通信

---

## 2. 🛠️ kubectl诊断工具详解


### 2.1 kubectl describe - 详细诊断神器


**核心作用**：describe就像是给资源对象做"全身体检"，告诉你这个对象的详细状态和发生的所有事件。

```bash
# 查看Pod详细信息（最常用）
kubectl describe pod <pod-name>

# 查看Node节点详细信息
kubectl describe node <node-name>

# 查看Service详细信息
kubectl describe service <service-name>
```

**💡 describe输出解读**：

```
Name:         my-app-123                    # Pod名称
Namespace:    default                       # 命名空间
Status:       Running                       # 当前状态
IP:           10.244.1.5                   # Pod IP
Containers:                                 # 容器信息
  my-app:
    Image:          nginx:1.20              # 镜像版本
    State:          Running                 # 容器状态
    Ready:          True                    # 是否就绪
Events:                                     # 重要！事件记录
  Type    Reason     Message
  ----    ------     -------
  Normal  Scheduled  Successfully assigned to node1
  Normal  Pulled     Container image pulled successfully
  Normal  Created    Container created
  Normal  Started    Container started
```

> 💡 **新手提示**：Events（事件）部分最重要！它记录了Pod生命周期中发生的所有重要事情，大多数问题都能在这里找到线索。

### 2.2 kubectl get - 快速状态检查


```bash
# 查看所有Pod状态
kubectl get pods

# 查看详细状态（包含更多列信息）
kubectl get pods -o wide

# 持续监控Pod状态变化
kubectl get pods -w
```

**状态含义解释**：

| 状态 | **含义** | **通俗解释** |
|------|---------|-------------|
| `Running` | `正在运行` | `一切正常，应用在工作` |
| `Pending` | `等待中` | `还在排队，等待资源分配` |
| `Failed` | `失败` | `启动失败或运行出错` |
| `Succeeded` | `成功完成` | `任务型Pod正常执行完毕` |
| `Unknown` | `状态未知` | `与Pod失去联系，可能网络问题` |

### 2.3 kubectl logs - 查看应用日志


**作用**：就像查看应用程序的"运行日记"，看看程序内部发生了什么。

```bash
# 查看Pod日志
kubectl logs <pod-name>

# 查看多容器Pod中指定容器的日志
kubectl logs <pod-name> -c <container-name>

# 实时跟踪日志（类似tail -f）
kubectl logs -f <pod-name>

# 查看前一个容器的日志（Pod重启后）
kubectl logs <pod-name> --previous
```

> ⚠️ **注意**：如果Pod一直重启，用 `--previous` 参数查看上一次运行的日志，往往能找到崩溃原因。

---

## 3. 🚨 常见Pod故障分析


### 3.1 ImagePullBackOff - 镜像拉取失败


**问题现象**：
```bash
$ kubectl get pods
NAME        READY   STATUS             RESTARTS   AGE
my-app      0/1     ImagePullBackOff   0          5m
```

**通俗解释**：就像你想下载一个软件，但是下载地址错了或者网络不通，导致下载失败。

**🔍 排查步骤**：

```bash
# 1. 查看详细信息
kubectl describe pod my-app
```

**典型Events信息**：
```
Events:
  Type     Reason     Message
  ----     ------     -------
  Warning  Failed     Failed to pull image "nginx:wrong-tag": 
                      pull access denied or repository does not exist
```

**🔧 常见原因及解决方案**：

| 原因 | **解决方法** |
|------|-------------|
| `镜像名称或标签错误` | `检查YAML中的image字段，确认名称和标签正确` |
| `私有仓库认证问题` | `创建imagePullSecrets，配置仓库密钥` |
| `网络问题` | `检查节点是否能访问镜像仓库` |
| `镜像不存在` | `确认镜像已推送到仓库` |

### 3.2 CrashLoopBackOff - 容器启动失败


**问题现象**：
```bash
NAME        READY   STATUS             RESTARTS   AGE
my-app      0/1     CrashLoopBackOff   5          10m
```

**通俗解释**：容器启动后马上就崩溃了，K8s尝试重启它，但每次都失败，就像一个坏掉的开关，按下去就跳开。

**🔍 排查流程**：

```
排查思路图：
    
容器崩溃 → 查看日志 → 查看Events → 检查配置
    ↓           ↓          ↓           ↓
   什么错误？  为什么崩溃？ 资源够吗？  参数对吗？
```

**实际排查命令**：
```bash
# 1. 查看当前日志
kubectl logs my-app

# 2. 如果重启了，查看前一次的日志
kubectl logs my-app --previous

# 3. 查看详细事件
kubectl describe pod my-app
```

**🔧 常见原因**：

```
应用配置错误：
- 启动参数不正确
- 配置文件路径错误
- 环境变量缺失

资源限制问题：
- 内存不足被OOMKilled
- CPU限制过低
- 存储空间不够

应用程序问题：
- 代码bug导致启动失败
- 依赖服务不可用
- 端口冲突
```

### 3.3 Pending - 调度失败


**问题现象**：
```bash
NAME        READY   STATUS    RESTARTS   AGE
my-app      0/1     Pending   0          10m
```

**通俗解释**：Pod就像在排队等位置，但是一直排不上，可能是没有合适的"座位"（节点资源不足）。

**🔍 排查重点**：
```bash
kubectl describe pod my-app
```

**典型Events信息**：
```
Events:
  Type     Reason            Message
  ----     ------            -------
  Warning  FailedScheduling  0/3 nodes are available: 
                             1 node(s) had memory pressure,
                             2 node(s) had insufficient memory
```

**🔧 解决方案**：

```
资源不足类：
→ 增加集群节点
→ 释放其他Pod资源
→ 调整资源请求量

调度约束类：
→ 检查nodeSelector配置
→ 确认污点容忍配置
→ 验证亲和性规则
```

---

## 4. 🌐 网络连通性排查


### 4.1 网络问题的表现


**常见症状**：
- 服务间调用超时
- 外部无法访问应用
- Pod内部无法联网
- DNS解析失败

### 4.2 网络连通性测试工具


**🔧 创建测试Pod**：
```bash
# 创建一个带网络工具的调试Pod
kubectl run test-pod --image=nicolaka/netshoot -it --rm
```

**基础连通性测试**：
```bash
# 在调试Pod内执行
# 1. ping测试基础连通性
ping google.com
ping 10.96.0.1  # 集群DNS服务IP

# 2. 测试DNS解析
nslookup kubernetes.default.svc.cluster.local
nslookup my-service.default.svc.cluster.local

# 3. 测试端口连通性
telnet my-service 80
nc -zv my-service 80
```

**🌍 网络层次排查**：

```
网络测试层次图：

Pod内部网络
    ↓ ping localhost
Pod → Node网络  
    ↓ ping 节点IP
Node → Service网络
    ↓ curl service-ip:port
Service → 外部网络
    ↓ curl external-api
```

### 4.3 Service网络排查


**🔍 Service连通性检查**：
```bash
# 1. 检查Service是否存在
kubectl get svc

# 2. 检查Service详情
kubectl describe svc my-service

# 3. 检查Endpoints（Service后端Pod列表）
kubectl get endpoints my-service
```

**Service排查要点**：

| 检查项 | **命令** | **关注点** |
|--------|---------|-----------|
| `Service配置` | `kubectl describe svc` | `端口映射是否正确` |
| `后端Pod` | `kubectl get endpoints` | `是否有可用的后端Pod` |
| `标签选择` | `对比Pod和Service标签` | `selector是否匹配` |
| `端口测试` | `curl service-ip:port` | `服务是否响应` |

---

## 5. 🔧 调试技巧与工具


### 5.1 kubectl exec - 进入容器调试


**核心作用**：就像"远程桌面"一样，让你进入容器内部，直接操作和检查。

```bash
# 进入Pod内的shell（单容器）
kubectl exec -it <pod-name> -- /bin/bash

# 进入多容器Pod中的指定容器
kubectl exec -it <pod-name> -c <container-name> -- /bin/bash

# 在容器内执行单个命令
kubectl exec <pod-name> -- ls /app
kubectl exec <pod-name> -- cat /etc/hosts
```

**🔍 容器内常用调试命令**：
```bash
# 检查进程状态
ps aux

# 查看网络配置  
ip addr show
netstat -tulpn

# 检查文件系统
df -h
ls -la /app

# 测试网络连通性
curl http://other-service:8080/health
wget -qO- http://api-service/status
```

### 5.2 kubectl port-forward - 端口转发调试


**通俗理解**：在你的电脑和Pod之间建立一个"隧道"，让你可以直接访问Pod内的服务，就像服务就运行在你本地一样。

```bash
# 将Pod的8080端口转发到本地8080
kubectl port-forward pod/my-app 8080:8080

# 将Service的80端口转发到本地3000
kubectl port-forward svc/my-service 3000:80

# 后台运行端口转发
kubectl port-forward pod/my-app 8080:8080 &
```

**使用场景**：
```
调试场景示意：

本地浏览器 → localhost:8080 → kubectl隧道 → Pod:8080
     ↑                                          ↑
  直接访问                                Pod内的服务

这样就能：
✅ 绕过Service直接测试Pod
✅ 访问集群内部服务进行调试  
✅ 测试应用功能是否正常
```

### 5.3 资源使用情况检查


```bash
# 查看Node资源使用情况
kubectl top nodes

# 查看Pod资源使用情况  
kubectl top pods

# 查看特定命名空间的资源使用
kubectl top pods -n kube-system
```

**资源问题诊断**：

```
资源问题诊断流程：

应用响应慢/崩溃
        ↓
   检查资源使用
        ↓
  CPU/内存是否过高？
        ↓
     ┌─────────┬─────────┐
     ↓         ↓         ↓
  增加资源   优化代码   扩容Pod
```

---

## 6. 🎯 实战故障处理流程


### 6.1 标准故障排查流程


```
故障报告
    ↓
┌─────────────┐
│ 1. 快速定位 │ ← kubectl get pods
└─────────────┘
    ↓
┌─────────────┐  
│ 2. 详细检查 │ ← kubectl describe  
└─────────────┘
    ↓
┌─────────────┐
│ 3. 日志分析 │ ← kubectl logs
└─────────────┘
    ↓
┌─────────────┐
│ 4. 深入调试 │ ← kubectl exec
└─────────────┘
    ↓  
┌─────────────┐
│ 5. 问题修复 │ ← 修改配置/重新部署
└─────────────┘
```

### 6.2 常见问题速查手册


**🚨 Pod启动问题**：
```bash
# 问题：Pod一直Pending
kubectl describe pod <name> | grep -A 10 Events
# 查找：资源不足、调度约束

# 问题：镜像拉取失败  
kubectl describe pod <name> | grep -i image
# 解决：检查镜像名称、认证、网络

# 问题：容器崩溃重启
kubectl logs <name> --previous
# 分析：启动错误、配置问题、资源限制
```

**🌐 网络问题**：
```bash
# Service无法访问
kubectl get svc,endpoints <service-name>
# 检查：端点列表、端口配置、标签匹配

# DNS解析问题
kubectl exec -it <pod> -- nslookup <service-name>
# 测试：服务发现、域名解析

# 端口连通性测试
kubectl port-forward pod/<name> 8080:8080
# 验证：绕过Service直接测试Pod
```

### 6.3 故障处理最佳实践


**📋 处理原则**：

> 🎯 **快速定位**：先看现象，再找原因
> 
> 🔍 **系统排查**：按层次逐步深入
>
> 📝 **记录过程**：记录排查步骤和解决方案
>
> 🔄 **验证修复**：确认问题彻底解决

**🛠️ 预防措施**：
- 设置合理的资源限制
- 配置健康检查探针
- 使用多副本部署
- 监控关键指标
- 定期备份重要配置

---

## 7. 📋 核心要点总结


### 7.1 必须掌握的诊断命令


```
🔸 快速状态检查：kubectl get pods -o wide
🔸 详细信息诊断：kubectl describe pod <name>  
🔸 应用日志查看：kubectl logs <name> [--previous]
🔸 容器内部调试：kubectl exec -it <name> -- /bin/bash
🔸 端口转发测试：kubectl port-forward pod/<name> 8080:8080
🔸 资源使用监控：kubectl top pods
```

### 7.2 关键故障状态理解


**🔹 Pod状态含义**：
```
Running：正常运行，一切OK
Pending：等待调度，通常是资源或约束问题
CrashLoopBackOff：启动失败反复重启
ImagePullBackOff：镜像下载失败
Error/Failed：执行失败，需要查看具体原因
```

**🔹 问题定位思路**：
```
状态异常 → 查看Events → 分析日志 → 检查配置 → 修复问题
```

### 7.3 实用排查技巧


- **先看Event，再看Log**：Events记录了关键时间点，Log记录了详细过程
- **善用--previous参数**：Pod重启后查看前一次的日志
- **port-forward是调试神器**：可以绕过Service直接测试Pod
- **describe命令最全面**：几乎包含了所有需要的诊断信息
- **网络问题分层测试**：从Pod内部到外部逐层验证

### 7.4 故障预防建议


**⚠️ 运维最佳实践**：
- 合理设置资源请求和限制
- 配置存活性和就绪性探针  
- 使用多副本提高可用性
- 定期检查集群资源使用情况
- 建立监控告警机制

**核心记忆**：
- 故障排查遵循"快速定位→深入分析→验证修复"的流程
- kubectl describe和logs是最常用的诊断工具
- Pod状态和Events信息包含了大部分问题线索  
- 网络问题需要分层次系统性排查
- 预防胜于治疗，合理配置可避免大多数问题