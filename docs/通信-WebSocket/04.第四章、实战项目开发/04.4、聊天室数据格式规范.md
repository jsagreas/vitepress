---
title: 4ã€èŠå¤©å®¤æ•°æ®æ ¼å¼è§„èŒƒ
---
## ğŸ“š ç›®å½•


1. [ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®æ ¼å¼è§„èŒƒ](#1-ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®æ ¼å¼è§„èŒƒ)
2. [ç»Ÿä¸€æ¶ˆæ¯æ•°æ®ç»“æ„è®¾è®¡](#2-ç»Ÿä¸€æ¶ˆæ¯æ•°æ®ç»“æ„è®¾è®¡)
3. [JSONæ¶ˆæ¯æ ¼å¼æ ‡å‡†](#3-jsonæ¶ˆæ¯æ ¼å¼æ ‡å‡†)
4. [æ¶ˆæ¯ç±»å‹æšä¸¾å®šä¹‰](#4-æ¶ˆæ¯ç±»å‹æšä¸¾å®šä¹‰)
5. [æ•°æ®éªŒè¯ä¸æ ¼å¼æ£€æŸ¥](#5-æ•°æ®éªŒè¯ä¸æ ¼å¼æ£€æŸ¥)
6. [å‰åç«¯æ•°æ®æ ¼å¼ä¸€è‡´æ€§](#6-å‰åç«¯æ•°æ®æ ¼å¼ä¸€è‡´æ€§)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¤” ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®æ ¼å¼è§„èŒƒ



### 1.1 æ²¡æœ‰è§„èŒƒä¼šæ€æ ·ï¼Ÿ



æƒ³è±¡ä¸€ä¸‹ä½ å’Œæœ‹å‹èŠå¤©ï¼Œå¦‚æœå¤§å®¶è¯´è¯çš„"æ ¼å¼"éƒ½ä¸ä¸€æ ·ï¼š

```
å¼ ä¸‰å‘æ¶ˆæ¯ï¼š{"msg":"ä½ å¥½","from":"å¼ ä¸‰"}
æå››å‘æ¶ˆæ¯ï¼š{content:"å—¨",user:"æå››",time:123456}
ç‹äº”å‘æ¶ˆæ¯ï¼š["ç‹äº”","å¤§å®¶å¥½"]
```

è¿™æ ·ä¹±ä¸ƒå…«ç³Ÿçš„æ ¼å¼ï¼Œç¨‹åºæ€ä¹ˆçŸ¥é“è°å‘çš„ä»€ä¹ˆæ¶ˆæ¯ï¼Ÿå°±åƒå¤§å®¶ç”¨ä¸åŒè¯­è¨€è¯´è¯ï¼Œæ ¹æœ¬æ²¡æ³•æ­£å¸¸äº¤æµï¼

### 1.2 ç»Ÿä¸€æ ¼å¼çš„å¥½å¤„



> ğŸ’¡ **ç®€å•ç†è§£**ï¼šå°±åƒå¿«é€’å•æœ‰å›ºå®šæ ¼å¼ä¸€æ ·ï¼ŒèŠå¤©æ¶ˆæ¯ä¹Ÿéœ€è¦ç»Ÿä¸€çš„"æ¨¡æ¿"

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- âœ… **ç¨‹åºå¥½å¤„ç†**ï¼šå‰ç«¯åç«¯éƒ½çŸ¥é“æ•°æ®é•¿ä»€ä¹ˆæ ·
- âœ… **å®¹æ˜“æ‰©å±•**ï¼šè¦åŠ æ–°åŠŸèƒ½æ—¶ä¸ä¼šä¹±å¥—
- âœ… **å‡å°‘bug**ï¼šæ ¼å¼å›ºå®šï¼Œå‡ºé”™æ¦‚ç‡å°
- âœ… **å›¢é˜Ÿåä½œ**ï¼šå¤§å®¶æŒ‰åŒæ ·çš„è§„åˆ™å†™ä»£ç 

### 1.3 èŠå¤©å®¤éœ€è¦ä¼ ä»€ä¹ˆæ•°æ®ï¼Ÿ



```
æ—¥å¸¸èŠå¤©åœºæ™¯åˆ†æï¼š

ç”¨æˆ·è¡Œä¸º                éœ€è¦ä¼ é€’çš„æ•°æ®
ğŸ‘¤ ç”¨æˆ·è¿›å…¥èŠå¤©å®¤  â†’    ç”¨æˆ·ä¿¡æ¯ã€è¿›å…¥é€šçŸ¥
ğŸ’¬ å‘é€èŠå¤©æ¶ˆæ¯    â†’    æ¶ˆæ¯å†…å®¹ã€å‘é€è€…ã€æ—¶é—´
ğŸ‘¥ æŸ¥çœ‹åœ¨çº¿ç”¨æˆ·    â†’    ç”¨æˆ·åˆ—è¡¨ã€åœ¨çº¿çŠ¶æ€
ğŸšª ç”¨æˆ·ç¦»å¼€èŠå¤©å®¤  â†’    ç¦»å¼€é€šçŸ¥ã€æ›´æ–°ç”¨æˆ·åˆ—è¡¨
âŒ å‘ç”Ÿé”™è¯¯       â†’    é”™è¯¯ä¿¡æ¯ã€é”™è¯¯ç±»å‹
```

---

## 2. ğŸ—ï¸ ç»Ÿä¸€æ¶ˆæ¯æ•°æ®ç»“æ„è®¾è®¡



### 2.1 è®¾è®¡æ€è·¯



æ‰€æœ‰æ¶ˆæ¯éƒ½åº”è¯¥æœ‰è¿™äº›**åŸºæœ¬ä¿¡æ¯**ï¼š
- **ç±»å‹**ï¼šè¿™æ˜¯ä»€ä¹ˆç±»å‹çš„æ¶ˆæ¯ï¼Ÿï¼ˆèŠå¤©ã€é€šçŸ¥ã€é”™è¯¯...ï¼‰
- **æ•°æ®**ï¼šå…·ä½“çš„æ¶ˆæ¯å†…å®¹
- **æ—¶é—´**ï¼šä»€ä¹ˆæ—¶å€™å‘çš„ï¼Ÿ
- **æ¥æº**ï¼šè°å‘çš„ï¼Ÿï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰

### 2.2 åŸºç¡€æ¶ˆæ¯ç»“æ„



```javascript
// è¿™å°±æ˜¯æˆ‘ä»¬çš„"æ¶ˆæ¯æ¨¡æ¿"
{
  "type": "æ¶ˆæ¯ç±»å‹",        // å¿…é¡»æœ‰ï¼Œå‘Šè¯‰ç¨‹åºè¿™æ˜¯ä»€ä¹ˆæ¶ˆæ¯
  "data": {},              // å¿…é¡»æœ‰ï¼Œå…·ä½“çš„æ¶ˆæ¯å†…å®¹
  "timestamp": 123456789,  // å¿…é¡»æœ‰ï¼Œæ¶ˆæ¯å‘é€æ—¶é—´
  "from": "å‘é€è€…"         // å¯é€‰ï¼ŒæŸäº›æ¶ˆæ¯éœ€è¦çŸ¥é“æ˜¯è°å‘çš„
}
```

> ğŸ“ **ç†è§£è¦ç‚¹**ï¼šå°±åƒå¡«è¡¨æ ¼ä¸€æ ·ï¼Œæ¯ä¸ªæ¶ˆæ¯éƒ½è¦å¡«å†™è¿™å‡ ä¸ªå›ºå®šçš„"æ ç›®"

### 2.3 ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ



**ğŸ” å„å­—æ®µçš„ä½œç”¨**ï¼š

```javascript
{
  // type - æ¶ˆæ¯åˆ†ç±»å™¨
  "type": "chat",  // ç¨‹åºä¸€çœ‹å°±çŸ¥é“ï¼š"å“¦ï¼Œè¿™æ˜¯èŠå¤©æ¶ˆæ¯ï¼"
  
  // data - æ¶ˆæ¯çš„"è‚šå­"ï¼Œè£…ç€çœŸæ­£çš„å†…å®¹
  "data": {
    "message": "å¤§å®¶å¥½ï¼",
    "username": "å°æ˜"
  },
  
  // timestamp - æ—¶é—´æˆ³ï¼Œè®°å½•ä»€ä¹ˆæ—¶å€™å‘çš„
  "timestamp": 1691234567890,
  
  // from - æ¶ˆæ¯æ¥æºï¼ˆæœåŠ¡å™¨å‘çš„é€šçŸ¥å°±ä¸éœ€è¦è¿™ä¸ªï¼‰
  "from": "client"
}
```

---

## 3. ğŸ“‹ JSONæ¶ˆæ¯æ ¼å¼æ ‡å‡†



### 3.1 ç”¨æˆ·æ¶ˆæ¯æ ¼å¼



**ç”¨æˆ·å‘èŠå¤©æ¶ˆæ¯**æ—¶çš„æ•°æ®æ ¼å¼ï¼š

```javascript
// ç”¨æˆ·å‘é€ï¼š"å¤§å®¶å¥½ï¼æˆ‘æ˜¯æ–°æ¥çš„"
{
  "type": "chat",                    // ç±»å‹ï¼šèŠå¤©æ¶ˆæ¯
  "data": {
    "message": "å¤§å®¶å¥½ï¼æˆ‘æ˜¯æ–°æ¥çš„",   // æ¶ˆæ¯å†…å®¹
    "username": "å°æ˜",              // ç”¨æˆ·å
    "avatar": "avatar1.jpg"          // ç”¨æˆ·å¤´åƒï¼ˆå¯é€‰ï¼‰
  },
  "timestamp": 1691234567890,        // å‘é€æ—¶é—´
  "from": "client"                   // æ¥è‡ªå®¢æˆ·ç«¯
}
```

> ğŸ’¡ **è§£é‡Š**ï¼š`data`é‡Œé¢è£…çš„æ˜¯èŠå¤©ç›¸å…³çš„å…·ä½“ä¿¡æ¯ï¼Œå°±åƒä¿¡å°é‡Œè£…ç€çœŸæ­£çš„ä¿¡ä»¶å†…å®¹

### 3.2 ç³»ç»Ÿé€šçŸ¥æ ¼å¼



**ç³»ç»Ÿå‘é€šçŸ¥**ï¼ˆæ¯”å¦‚ç”¨æˆ·åŠ å…¥ã€ç¦»å¼€ï¼‰æ—¶ï¼š

```javascript
// ç³»ç»Ÿé€šçŸ¥ï¼š"å°æ˜åŠ å…¥äº†èŠå¤©å®¤"
{
  "type": "notification",            // ç±»å‹ï¼šç³»ç»Ÿé€šçŸ¥
  "data": {
    "message": "å°æ˜åŠ å…¥äº†èŠå¤©å®¤",     // é€šçŸ¥å†…å®¹
    "notifyType": "user_join",       // é€šçŸ¥å­ç±»å‹
    "username": "å°æ˜"               // ç›¸å…³ç”¨æˆ·
  },
  "timestamp": 1691234567890,        // é€šçŸ¥æ—¶é—´
  "from": "server"                   // æ¥è‡ªæœåŠ¡å™¨
}
```

**å¸¸è§é€šçŸ¥ç±»å‹**ï¼š
```javascript
// ç”¨æˆ·è¿›å…¥
{
  "type": "notification",
  "data": {
    "message": "ç”¨æˆ·å°æ˜è¿›å…¥äº†èŠå¤©å®¤",
    "notifyType": "user_join",
    "username": "å°æ˜"
  }
}

// ç”¨æˆ·ç¦»å¼€
{
  "type": "notification", 
  "data": {
    "message": "ç”¨æˆ·å°æç¦»å¼€äº†èŠå¤©å®¤",
    "notifyType": "user_leave",
    "username": "å°æ"
  }
}
```

### 3.3 é”™è¯¯æ¶ˆæ¯æ ¼å¼



å½“å‡ºç°é—®é¢˜æ—¶ï¼ŒæœåŠ¡å™¨å‘é€é”™è¯¯æ¶ˆæ¯ï¼š

```javascript
// æ¯”å¦‚ï¼šç”¨æˆ·åå·²è¢«å ç”¨
{
  "type": "error",                   // ç±»å‹ï¼šé”™è¯¯æ¶ˆæ¯
  "data": {
    "message": "ç”¨æˆ·åå·²è¢«å ç”¨",        // é”™è¯¯æè¿°
    "errorCode": "USERNAME_TAKEN",    // é”™è¯¯ä»£ç 
    "details": "è¯·é€‰æ‹©å…¶ä»–ç”¨æˆ·å"      // è¯¦ç»†è¯´æ˜
  },
  "timestamp": 1691234567890,        // é”™è¯¯å‘ç”Ÿæ—¶é—´
  "from": "server"                   // æ¥è‡ªæœåŠ¡å™¨
}
```

**å¸¸è§é”™è¯¯ç±»å‹**ï¼š
```javascript
// ç”¨æˆ·åé”™è¯¯
{
  "type": "error",
  "data": {
    "message": "ç”¨æˆ·åä¸èƒ½ä¸ºç©º",
    "errorCode": "EMPTY_USERNAME"
  }
}

// æ¶ˆæ¯å¤ªé•¿
{
  "type": "error", 
  "data": {
    "message": "æ¶ˆæ¯é•¿åº¦è¶…è¿‡é™åˆ¶",
    "errorCode": "MESSAGE_TOO_LONG",
    "details": "æ¶ˆæ¯ä¸èƒ½è¶…è¿‡500å­—ç¬¦"
  }
}
```

### 3.4 ç”¨æˆ·åˆ—è¡¨æ ¼å¼



è·å–åœ¨çº¿ç”¨æˆ·åˆ—è¡¨æ—¶ï¼š

```javascript
// åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
{
  "type": "user_list",              // ç±»å‹ï¼šç”¨æˆ·åˆ—è¡¨
  "data": {
    "users": [                      // ç”¨æˆ·æ•°ç»„
      {
        "username": "å°æ˜",
        "avatar": "avatar1.jpg",
        "joinTime": 1691234567890
      },
      {
        "username": "å°çº¢", 
        "avatar": "avatar2.jpg",
        "joinTime": 1691234567891
      }
    ],
    "total": 2                      // æ€»ç”¨æˆ·æ•°
  },
  "timestamp": 1691234567892,       // åˆ—è¡¨ç”Ÿæˆæ—¶é—´
  "from": "server"                  // æ¥è‡ªæœåŠ¡å™¨
}
```

---

## 4. ğŸ·ï¸ æ¶ˆæ¯ç±»å‹æšä¸¾å®šä¹‰



### 4.1 ä¸ºä»€ä¹ˆè¦å®šä¹‰æ¶ˆæ¯ç±»å‹ï¼Ÿ



æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœæ¯ä¸ªç¨‹åºå‘˜éƒ½éšä¾¿èµ·åå­—ï¼š
- å¼ ä¸‰å†™ï¼š`"type": "chat"`
- æå››å†™ï¼š`"type": "message"`  
- ç‹äº”å†™ï¼š`"type": "talk"`

ä¸‰ä¸ªäººè¯´çš„å…¶å®æ˜¯ä¸€å›äº‹ï¼Œä½†ç¨‹åºä¸çŸ¥é“ï¼æ‰€ä»¥éœ€è¦**ç»Ÿä¸€çš„"å­—å…¸"**ã€‚

### 4.2 æ¶ˆæ¯ç±»å‹å¸¸é‡å®šä¹‰



**å‰ç«¯å®šä¹‰**ï¼ˆJavaScriptï¼‰ï¼š
```javascript
// æ¶ˆæ¯ç±»å‹å¸¸é‡ - å°±åƒç»™æ¯ç§æ¶ˆæ¯ç±»å‹èµ·ä¸ªç»Ÿä¸€çš„åå­—
const MESSAGE_TYPES = {
  CHAT: 'chat',                    // èŠå¤©æ¶ˆæ¯
  NOTIFICATION: 'notification',    // ç³»ç»Ÿé€šçŸ¥  
  ERROR: 'error',                  // é”™è¯¯æ¶ˆæ¯
  USER_LIST: 'user_list',         // ç”¨æˆ·åˆ—è¡¨
  HEARTBEAT: 'heartbeat'          // å¿ƒè·³æ£€æµ‹
};

// é€šçŸ¥å­ç±»å‹
const NOTIFY_TYPES = {
  USER_JOIN: 'user_join',         // ç”¨æˆ·åŠ å…¥
  USER_LEAVE: 'user_leave'        // ç”¨æˆ·ç¦»å¼€
};
```

**åç«¯å®šä¹‰**ï¼ˆNode.jsï¼‰ï¼š
```javascript
// ä¿æŒå’Œå‰ç«¯å®Œå…¨ä¸€æ ·çš„å®šä¹‰
const MESSAGE_TYPES = {
  CHAT: 'chat',
  NOTIFICATION: 'notification', 
  ERROR: 'error',
  USER_LIST: 'user_list',
  HEARTBEAT: 'heartbeat'
};

module.exports = { MESSAGE_TYPES, NOTIFY_TYPES };
```

### 4.3 ç±»å‹ä½¿ç”¨ç¤ºä¾‹



**å‘é€æ¶ˆæ¯æ—¶**ï¼š
```javascript
// âŒ é”™è¯¯å†™æ³• - ç›´æ¥å†™å­—ç¬¦ä¸²ï¼Œå®¹æ˜“å†™é”™
const message = {
  type: "chat",  // å¦‚æœä¸å°å¿ƒå†™æˆ"caht"æ€ä¹ˆåŠï¼Ÿ
  data: { ... }
};

// âœ… æ­£ç¡®å†™æ³• - ä½¿ç”¨å¸¸é‡
const message = {
  type: MESSAGE_TYPES.CHAT,  // ç”¨å¸¸é‡ï¼ŒIDEè¿˜èƒ½æç¤ºï¼Œä¸å®¹æ˜“é”™
  data: { ... }
};
```

**å¤„ç†æ¶ˆæ¯æ—¶**ï¼š
```javascript
// æ¥æ”¶åˆ°æ¶ˆæ¯åçš„å¤„ç†
function handleMessage(message) {
  switch(message.type) {
    case MESSAGE_TYPES.CHAT:
      displayChatMessage(message.data);
      break;
      
    case MESSAGE_TYPES.NOTIFICATION:
      showNotification(message.data);
      break;
      
    case MESSAGE_TYPES.ERROR:
      showError(message.data);
      break;
  }
}
```

---

## 5. âœ… æ•°æ®éªŒè¯ä¸æ ¼å¼æ£€æŸ¥



### 5.1 ä¸ºä»€ä¹ˆè¦éªŒè¯æ•°æ®ï¼Ÿ



å°±åƒæ”¶å¿«é€’è¦æ£€æŸ¥åŒ…è£…æ˜¯å¦å®Œå¥½ä¸€æ ·ï¼Œç¨‹åºæ”¶åˆ°æ¶ˆæ¯ä¹Ÿè¦æ£€æŸ¥æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼š

```javascript
// å¦‚æœæ”¶åˆ°è¿™æ ·çš„"å"æ•°æ®æ€ä¹ˆåŠï¼Ÿ
{
  // ç¼ºå°‘typeå­—æ®µï¼ç¨‹åºä¸çŸ¥é“è¿™æ˜¯ä»€ä¹ˆæ¶ˆæ¯
  "data": "hello",
  "timestamp": "ä¸æ˜¯æ•°å­—è€Œæ˜¯å­—ç¬¦ä¸²"  // æ—¶é—´æ ¼å¼é”™è¯¯
}
```

### 5.2 å‰ç«¯æ•°æ®éªŒè¯



**å‘é€å‰éªŒè¯**ï¼š
```javascript
// ç®€å•çš„æ¶ˆæ¯éªŒè¯å‡½æ•°
function validateMessage(message) {
  // æ£€æŸ¥å¿…å¡«å­—æ®µ
  if (!message.type) {
    console.error('æ¶ˆæ¯ç¼ºå°‘typeå­—æ®µ');
    return false;
  }
  
  if (!message.data) {
    console.error('æ¶ˆæ¯ç¼ºå°‘dataå­—æ®µ'); 
    return false;
  }
  
  // æ£€æŸ¥æ¶ˆæ¯å†…å®¹
  if (message.type === MESSAGE_TYPES.CHAT) {
    if (!message.data.message || !message.data.username) {
      console.error('èŠå¤©æ¶ˆæ¯æ ¼å¼ä¸æ­£ç¡®');
      return false;
    }
    
    // æ£€æŸ¥æ¶ˆæ¯é•¿åº¦
    if (message.data.message.length > 500) {
      console.error('æ¶ˆæ¯å¤ªé•¿äº†');
      return false;
    }
  }
  
  return true;  // éªŒè¯é€šè¿‡
}

// å‘é€æ¶ˆæ¯å‰å…ˆéªŒè¯
function sendMessage(messageData) {
  const message = {
    type: MESSAGE_TYPES.CHAT,
    data: messageData,
    timestamp: Date.now(),
    from: 'client'
  };
  
  if (validateMessage(message)) {
    websocket.send(JSON.stringify(message));  // éªŒè¯é€šè¿‡æ‰å‘é€
  }
}
```

### 5.3 åç«¯æ•°æ®éªŒè¯



**æ¥æ”¶åéªŒè¯**ï¼š
```javascript
// åç«¯æ”¶åˆ°æ¶ˆæ¯åçš„éªŒè¯
function validateIncomingMessage(messageStr) {
  try {
    // å…ˆæ£€æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆçš„JSON
    const message = JSON.parse(messageStr);
    
    // æ£€æŸ¥åŸºæœ¬ç»“æ„
    if (!message.type || !message.data) {
      return { valid: false, error: 'æ¶ˆæ¯æ ¼å¼ä¸æ­£ç¡®' };
    }
    
    // æ ¹æ®æ¶ˆæ¯ç±»å‹åšå…·ä½“éªŒè¯
    switch(message.type) {
      case MESSAGE_TYPES.CHAT:
        if (!message.data.message || !message.data.username) {
          return { valid: false, error: 'èŠå¤©æ¶ˆæ¯ç¼ºå°‘å¿…è¦å­—æ®µ' };
        }
        break;
    }
    
    return { valid: true, message: message };
    
  } catch(error) {
    return { valid: false, error: 'JSONè§£æå¤±è´¥' };
  }
}

// WebSocketæ¶ˆæ¯å¤„ç†
ws.on('message', (data) => {
  const validation = validateIncomingMessage(data.toString());
  
  if (!validation.valid) {
    // å‘é€é”™è¯¯æ¶ˆæ¯ç»™å®¢æˆ·ç«¯
    ws.send(JSON.stringify({
      type: MESSAGE_TYPES.ERROR,
      data: {
        message: validation.error,
        errorCode: 'INVALID_FORMAT'
      },
      timestamp: Date.now(),
      from: 'server'
    }));
    return;
  }
  
  // éªŒè¯é€šè¿‡ï¼Œå¤„ç†æ¶ˆæ¯
  handleValidMessage(validation.message);
});
```

### 5.4 å®ç”¨éªŒè¯æŠ€å·§



> ğŸ’¡ **éªŒè¯çš„å±‚æ¬¡**ï¼š
> 1. **æ ¼å¼éªŒè¯** - æ£€æŸ¥JSONæ ¼å¼ã€å¿…å¡«å­—æ®µ
> 2. **ç±»å‹éªŒè¯** - æ£€æŸ¥å­—æ®µæ•°æ®ç±»å‹  
> 3. **ä¸šåŠ¡éªŒè¯** - æ£€æŸ¥ä¸šåŠ¡é€»è¾‘ï¼ˆç”¨æˆ·åæ˜¯å¦é‡å¤ç­‰ï¼‰

```javascript
// åˆ›å»ºä¸€ä¸ªé€šç”¨çš„éªŒè¯å·¥å…·
const MessageValidator = {
  // éªŒè¯åŸºæœ¬æ ¼å¼
  validateBasic(message) {
    const required = ['type', 'data', 'timestamp'];
    return required.every(field => message.hasOwnProperty(field));
  },
  
  // éªŒè¯èŠå¤©æ¶ˆæ¯
  validateChat(data) {
    return data.message && 
           data.username && 
           typeof data.message === 'string' &&
           data.message.length <= 500;
  },
  
  // ç»Ÿä¸€éªŒè¯å…¥å£
  validate(message) {
    if (!this.validateBasic(message)) {
      return { valid: false, error: 'ç¼ºå°‘å¿…å¡«å­—æ®µ' };
    }
    
    if (message.type === MESSAGE_TYPES.CHAT) {
      if (!this.validateChat(message.data)) {
        return { valid: false, error: 'èŠå¤©æ¶ˆæ¯æ ¼å¼é”™è¯¯' };
      }
    }
    
    return { valid: true };
  }
};
```

---

## 6. ğŸ”„ å‰åç«¯æ•°æ®æ ¼å¼ä¸€è‡´æ€§



### 6.1 ä¸ºä»€ä¹ˆè¦ä¿æŒä¸€è‡´æ€§ï¼Ÿ



æƒ³è±¡ä¸€ä¸‹ä¸¤ä¸ªäººæ‰“ç”µè¯ï¼š
- Aè¯´ï¼š"æˆ‘è¯´ä¸­æ–‡"
- Bè¯´ï¼š"I speak English"  

ç»“æœå°±æ˜¯é¸¡åŒé¸­è®²ï¼å‰ç«¯å’Œåç«¯ä¹Ÿæ˜¯è¿™æ ·ï¼Œå¿…é¡»**è¯´åŒä¸€ç§"è¯­è¨€"**ã€‚

### 6.2 ä¿æŒä¸€è‡´æ€§çš„æ–¹æ³•



**æ–¹æ³•ä¸€ï¼šå…±äº«é…ç½®æ–‡ä»¶**

åˆ›å»ºä¸€ä¸ªé€šç”¨çš„é…ç½®ï¼š
```javascript
// shared/message-types.js - å‰åç«¯å…±ç”¨
const MESSAGE_TYPES = {
  CHAT: 'chat',
  NOTIFICATION: 'notification',
  ERROR: 'error',
  USER_LIST: 'user_list',
  HEARTBEAT: 'heartbeat'
};

const MESSAGE_SCHEMA = {
  [MESSAGE_TYPES.CHAT]: {
    required: ['message', 'username'],
    optional: ['avatar']
  },
  [MESSAGE_TYPES.NOTIFICATION]: {
    required: ['message', 'notifyType'],
    optional: ['username']
  }
};

// å‰ç«¯å’Œåç«¯éƒ½å¼•å…¥è¿™ä¸ªæ–‡ä»¶
```

**æ–¹æ³•äºŒï¼šæ¥å£æ–‡æ¡£**

```markdown
# èŠå¤©æ¶ˆæ¯APIæ–‡æ¡£



## å‘é€èŠå¤©æ¶ˆæ¯


**æ ¼å¼**ï¼š
{
  "type": "chat",
  "data": {
    "message": "string, å¿…å¡«, 1-500å­—ç¬¦",
    "username": "string, å¿…å¡«, 2-20å­—ç¬¦", 
    "avatar": "string, å¯é€‰"
  },
  "timestamp": "number, å¿…å¡«",
  "from": "string, å›ºå®šä¸ºclient"
}

## ç³»ç»Ÿé€šçŸ¥


**æ ¼å¼**ï¼š
{
  "type": "notification",
  ...
}
```

### 6.3 å‰åç«¯åä½œç¤ºä¾‹



**å‰ç«¯å‘é€æ¶ˆæ¯**ï¼š
```javascript
// å‰ç«¯ - å‘é€èŠå¤©æ¶ˆæ¯
function sendChatMessage(message, username) {
  const chatMessage = {
    type: MESSAGE_TYPES.CHAT,      // ä½¿ç”¨å…±åŒçš„å¸¸é‡
    data: {
      message: message,
      username: username,
      avatar: getCurrentUserAvatar()
    },
    timestamp: Date.now(),
    from: 'client'
  };
  
  websocket.send(JSON.stringify(chatMessage));
}
```

**åç«¯å¤„ç†æ¶ˆæ¯**ï¼š
```javascript
// åç«¯ - å¤„ç†èŠå¤©æ¶ˆæ¯
function handleChatMessage(message, ws) {
  // ä½¿ç”¨ç›¸åŒçš„æ¶ˆæ¯æ ¼å¼å¹¿æ’­ç»™å…¶ä»–ç”¨æˆ·
  const broadcastMessage = {
    type: MESSAGE_TYPES.CHAT,      // åŒæ ·çš„å¸¸é‡
    data: {
      message: message.data.message,
      username: message.data.username,
      avatar: message.data.avatar
    },
    timestamp: Date.now(),
    from: 'server'
  };
  
  // å¹¿æ’­ç»™æ‰€æœ‰å®¢æˆ·ç«¯
  broadcastToAll(JSON.stringify(broadcastMessage));
}
```

### 6.4 ç‰ˆæœ¬å…¼å®¹å¤„ç†



å½“éœ€è¦å‡çº§æ¶ˆæ¯æ ¼å¼æ—¶ï¼š

```javascript
// æ”¯æŒå¤šç‰ˆæœ¬çš„æ¶ˆæ¯å¤„ç†
function handleMessage(messageStr) {
  const message = JSON.parse(messageStr);
  
  // æ£€æŸ¥æ¶ˆæ¯ç‰ˆæœ¬ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
  const version = message.version || '1.0';
  
  switch(version) {
    case '1.0':
      return handleV1Message(message);
    case '2.0':
      return handleV2Message(message);
    default:
      // é»˜è®¤æŒ‰æœ€æ–°ç‰ˆæœ¬å¤„ç†
      return handleV2Message(message);
  }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“



### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ



```
ğŸ”¸ æ•°æ®æ ¼å¼è§„èŒƒï¼šå‰åç«¯å¿…é¡»ç»Ÿä¸€æ¶ˆæ¯ç»“æ„
ğŸ”¸ æ¶ˆæ¯ç±»å‹åˆ†ç±»ï¼šèŠå¤©ã€é€šçŸ¥ã€é”™è¯¯ã€ç”¨æˆ·åˆ—è¡¨ç­‰
ğŸ”¸ JSONæ ‡å‡†æ ¼å¼ï¼štypeã€dataã€timestampã€fromå››è¦ç´ 
ğŸ”¸ æ•°æ®éªŒè¯æœºåˆ¶ï¼šå‘é€å‰éªŒè¯ã€æ¥æ”¶åéªŒè¯
ğŸ”¸ å‰åç«¯ä¸€è‡´æ€§ï¼šä½¿ç”¨å…±åŒçš„ç±»å‹å®šä¹‰å’ŒéªŒè¯è§„åˆ™
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹



**ğŸ”¹ ä¸ºä»€ä¹ˆéœ€è¦è§„èŒƒ**ï¼š
```
ç»Ÿä¸€æ ¼å¼çš„ä»·å€¼ï¼š
- ç¨‹åºå¥½å¤„ç†ï¼šå‰ç«¯åç«¯éƒ½çŸ¥é“æ•°æ®ç»“æ„
- å‡å°‘å‡ºé”™ï¼šæ ¼å¼å›ºå®šï¼Œä¸å®¹æ˜“å†™é”™
- ä¾¿äºæ‰©å±•ï¼šæ–°åŠŸèƒ½å¯ä»¥å¤ç”¨ç°æœ‰ç»“æ„
- å›¢é˜Ÿåä½œï¼šå¤§å®¶éµå¾ªåŒæ ·çš„è§„åˆ™
```

**ğŸ”¹ æ¶ˆæ¯ç»“æ„è®¾è®¡åŸåˆ™**ï¼š
```
è®¾è®¡è¦ç‚¹ï¼š
- ç®€å•æ˜äº†ï¼šä¸€çœ‹å°±æ‡‚ï¼Œä¸éœ€è¦å¤æ‚è¯´æ˜
- æ‰©å±•æ€§å¥½ï¼šå°†æ¥åŠ æ–°å­—æ®µä¸å½±å“ç°æœ‰åŠŸèƒ½  
- ç±»å‹æ˜ç¡®ï¼šæ¯ç§æ¶ˆæ¯éƒ½æœ‰æ˜ç¡®çš„ç”¨é€”
- éªŒè¯å‹å¥½ï¼šå®¹æ˜“æ£€æŸ¥æ ¼å¼æ˜¯å¦æ­£ç¡®
```

**ğŸ”¹ å‰åç«¯ä¸€è‡´æ€§çš„é‡è¦æ€§**ï¼š
```
ä¸€è‡´æ€§ä¿éšœï¼š
- ä½¿ç”¨å…±åŒçš„ç±»å‹å¸¸é‡æ–‡ä»¶
- éµå¾ªç›¸åŒçš„éªŒè¯è§„åˆ™
- ç»´æŠ¤ç»Ÿä¸€çš„æ¥å£æ–‡æ¡£
- ç‰ˆæœ¬å‡çº§æ—¶åšå¥½å…¼å®¹å¤„ç†
```

### 7.3 å®é™…åº”ç”¨ä»·å€¼



**ğŸ’» å¼€å‘å®è·µ**ï¼š
- **æ¶ˆæ¯å‘é€**ï¼šæŒ‰ç»Ÿä¸€æ ¼å¼æ„é€ æ¶ˆæ¯å¯¹è±¡
- **æ¶ˆæ¯æ¥æ”¶**ï¼šæ ¹æ®typeå­—æ®µåˆ†ç±»å¤„ç†
- **é”™è¯¯å¤„ç†**ï¼šç”¨æ ‡å‡†çš„é”™è¯¯æ¶ˆæ¯æ ¼å¼
- **è°ƒè¯•æ’æŸ¥**ï¼šæ ¼å¼ç»Ÿä¸€ä¾¿äºå®šä½é—®é¢˜

**ğŸ”§ ä»£ç ç»„ç»‡**ï¼š
- **å¸¸é‡å®šä¹‰**ï¼šç»Ÿä¸€çš„æ¶ˆæ¯ç±»å‹å¸¸é‡
- **éªŒè¯å‡½æ•°**ï¼šå¯å¤ç”¨çš„æ•°æ®éªŒè¯é€»è¾‘
- **å·¥å…·å‡½æ•°**ï¼šæ¶ˆæ¯æ„é€ å’Œè§£æå·¥å…·
- **æµ‹è¯•ç”¨ä¾‹**ï¼šåŸºäºæ ‡å‡†æ ¼å¼çš„æµ‹è¯•æ•°æ®

**ğŸ¯ å›¢é˜Ÿåä½œ**ï¼š
- **æ¥å£çº¦å®š**ï¼šå‰åç«¯å¼€å‘çš„æ¡¥æ¢
- **ä»£ç å¤ç”¨**ï¼šç›¸åŒçš„æ ¼å¼å¤„ç†é€»è¾‘
- **é—®é¢˜æ’æŸ¥**ï¼šæ ‡å‡†åŒ–çš„é”™è¯¯ä¿¡æ¯
- **åŠŸèƒ½æ‰©å±•**ï¼šåœ¨ç°æœ‰æ ¼å¼åŸºç¡€ä¸Šå¢å¼º

**æ ¸å¿ƒè®°å¿†**ï¼š
- æ•°æ®æ ¼å¼è¦ç»Ÿä¸€ï¼Œå‰åç«¯è¯´åŒç§è¯
- æ¶ˆæ¯ç±»å‹è¦æ˜ç¡®ï¼Œå¤„ç†é€»è¾‘ä¸ä¼šä¹±
- éªŒè¯æ£€æŸ¥è¦åˆ°ä½ï¼Œé”™è¯¯æ¶ˆæ¯æ—©å‘ç°
- å›¢é˜Ÿåä½œæœ‰è§„èŒƒï¼Œå¼€å‘æ•ˆç‡å¤§æå‡