---
title: 3ã€ç»¼åˆå®æˆ˜é¡¹ç›®æ‰©å±•
---
## ğŸ“š ç›®å½•

1. [èŠå¤©å®¤é¡µé¢ç»“æ„è®¾è®¡](#1-èŠå¤©å®¤é¡µé¢ç»“æ„è®¾è®¡)
2. [å¤šæˆ¿é—´èŠå¤©ç³»ç»Ÿå®ç°](#2-å¤šæˆ¿é—´èŠå¤©ç³»ç»Ÿå®ç°)
3. [ç§èŠåŠŸèƒ½å¼€å‘](#3-ç§èŠåŠŸèƒ½å¼€å‘)
4. [æ–‡ä»¶ä¼ è¾“åŠŸèƒ½å®ç°](#4-æ–‡ä»¶ä¼ è¾“åŠŸèƒ½å®ç°)
5. [è¡¨æƒ…åŒ…ä¸å¯Œæ–‡æœ¬æ¶ˆæ¯](#5-è¡¨æƒ…åŒ…ä¸å¯Œæ–‡æœ¬æ¶ˆæ¯)
6. [æ¶ˆæ¯æ ¼å¼å°è£…](#6-æ¶ˆæ¯æ ¼å¼å°è£…)
7. [æ¶ˆæ¯æœç´¢ä¸å†å²è®°å½•](#7-æ¶ˆæ¯æœç´¢ä¸å†å²è®°å½•)
8. [ç”¨æˆ·æƒé™ç®¡ç†ç³»ç»Ÿ](#8-ç”¨æˆ·æƒé™ç®¡ç†ç³»ç»Ÿ)
9. [å‰ç«¯æ¶ˆæ¯å¤„ç†æµç¨‹](#9-å‰ç«¯æ¶ˆæ¯å¤„ç†æµç¨‹)
10. [åç«¯å¹¿æ’­å®ç°](#10-åç«¯å¹¿æ’­å®ç°)
11. [åœ¨çº¿ç”¨æˆ·æ˜¾ç¤ºä¸æç¤º](#11-åœ¨çº¿ç”¨æˆ·æ˜¾ç¤ºä¸æç¤º)
12. [ç”¨æˆ·ä½“éªŒä¼˜åŒ–åŠŸèƒ½](#12-ç”¨æˆ·ä½“éªŒä¼˜åŒ–åŠŸèƒ½)
13. [é¡¹ç›®éƒ¨ç½²ä¸ä¸Šçº¿](#13-é¡¹ç›®éƒ¨ç½²ä¸ä¸Šçº¿)
14. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#14-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¨ èŠå¤©å®¤é¡µé¢ç»“æ„è®¾è®¡


### 1.1 ç»å…¸èŠå¤©å®¤å¸ƒå±€ç†è§£


> **èŠå¤©å®¤å¸ƒå±€å°±åƒæˆ‘ä»¬çš„å¾®ä¿¡ç•Œé¢**ï¼šå·¦è¾¹æ˜¯å¥½å‹åˆ—è¡¨ï¼Œä¸­é—´æ˜¯èŠå¤©å†…å®¹ï¼Œä¸‹é¢æ˜¯è¾“å…¥æ¡†

```
å…¸å‹èŠå¤©å®¤é¡µé¢ç»“æ„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   èŠå¤©å®¤æ ‡é¢˜æ                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ç”¨æˆ·åˆ—è¡¨   â”‚                         â”‚    æˆ¿é—´åˆ—è¡¨      â”‚
â”‚             â”‚        èŠå¤©æ¶ˆæ¯åŒº        â”‚                â”‚
â”‚  ğŸ‘¤ å¼ ä¸‰     â”‚                         â”‚  ğŸ  å¤§å…        â”‚
â”‚  ğŸ‘¤ æå››     â”‚                         â”‚  ğŸ  æŠ€æœ¯è®¨è®º     â”‚
â”‚  ğŸ‘¤ ç‹äº”     â”‚                         â”‚  ğŸ  é—²èŠ        â”‚
â”‚             â”‚                         â”‚                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   åœ¨çº¿: 15   â”‚    æ¶ˆæ¯è¾“å…¥æ¡† [å‘é€]     â”‚   å½“å‰æˆ¿é—´ä¿¡æ¯   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ ¸å¿ƒåŒºåŸŸåŠŸèƒ½è¯´æ˜


**ğŸ’¬ èŠå¤©æ¶ˆæ¯åŒº**ï¼š
- **ä½œç”¨**ï¼šæ˜¾ç¤ºæ‰€æœ‰çš„èŠå¤©æ¶ˆæ¯ï¼Œè¿™æ˜¯æœ€é‡è¦çš„åŒºåŸŸ
- **ç‰¹ç‚¹**ï¼šæ¶ˆæ¯æŒ‰æ—¶é—´é¡ºåºæ’åˆ—ï¼Œæ–°æ¶ˆæ¯å‡ºç°åœ¨åº•éƒ¨
- **äº¤äº’**ï¼šæ”¯æŒæ»šåŠ¨æŸ¥çœ‹å†å²æ¶ˆæ¯ï¼Œè‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯

**âŒ¨ï¸ è¾“å…¥æ¡†åŒºåŸŸ**ï¼š
- **ä½œç”¨**ï¼šç”¨æˆ·è¾“å…¥æ¶ˆæ¯çš„åœ°æ–¹ï¼Œå°±åƒå¾®ä¿¡çš„è¾“å…¥æ¡†
- **åŠŸèƒ½**ï¼šè¾“å…¥æ–‡å­—ã€é€‰æ‹©è¡¨æƒ…ã€å‘é€æ–‡ä»¶
- **ä½“éªŒ**ï¼šæŒ‰å›è½¦å‘é€ï¼ŒShift+å›è½¦æ¢è¡Œ

**ğŸ‘¥ ç”¨æˆ·åˆ—è¡¨åŒºåŸŸ**ï¼š
- **ä½œç”¨**ï¼šæ˜¾ç¤ºå½“å‰åœ¨çº¿çš„æ‰€æœ‰ç”¨æˆ·
- **ä¿¡æ¯**ï¼šç”¨æˆ·æ˜µç§°ã€åœ¨çº¿çŠ¶æ€ã€å¤´åƒ
- **äº¤äº’**ï¼šç‚¹å‡»ç”¨æˆ·åå¯ä»¥ç§èŠ

### 1.3 ç®€å•é¡µé¢ç»“æ„ä»£ç 


```html
<!-- èŠå¤©å®¤åŸºæœ¬ç»“æ„ -->
<div class="chat-container">
    <!-- å¤´éƒ¨æ ‡é¢˜ -->
    <div class="chat-header">
        <h2>ğŸ’¬ åœ¨çº¿èŠå¤©å®¤</h2>
        <span class="online-count">åœ¨çº¿äººæ•°ï¼š<span id="userCount">0</span></span>
    </div>
    
    <!-- ä¸»ä½“åŒºåŸŸ -->
    <div class="chat-body">
        <!-- æ¶ˆæ¯æ˜¾ç¤ºåŒº -->
        <div class="message-area" id="messageArea">
            <!-- æ¶ˆæ¯ä¼šåŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
        </div>
        
        <!-- ç”¨æˆ·åˆ—è¡¨ -->
        <div class="user-list">
            <h3>åœ¨çº¿ç”¨æˆ·</h3>
            <ul id="userList">
                <!-- ç”¨æˆ·åˆ—è¡¨ä¼šåŠ¨æ€æ›´æ–° -->
            </ul>
        </div>
    </div>
    
    <!-- è¾“å…¥åŒºåŸŸ -->
    <div class="input-area">
        <input type="text" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯...">
        <button id="sendButton">å‘é€</button>
    </div>
</div>
```

---

## 2. ğŸ  å¤šæˆ¿é—´èŠå¤©ç³»ç»Ÿå®ç°


### 2.1 å¤šæˆ¿é—´ç³»ç»Ÿçš„æ¦‚å¿µ


> **å¤šæˆ¿é—´ç³»ç»Ÿå°±åƒQQç¾¤**ï¼šæ¯ä¸ªæˆ¿é—´æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„èŠå¤©ç©ºé—´ï¼Œç”¨æˆ·å¯ä»¥åŠ å…¥ä¸åŒçš„æˆ¿é—´èŠå¤©

```
æˆ¿é—´ç³»ç»Ÿç»“æ„ï¼š

æœåŠ¡å™¨ç»´æŠ¤å¤šä¸ªæˆ¿é—´ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¤§å…(é»˜è®¤)  â”‚  â”‚  æŠ€æœ¯è®¨è®º   â”‚  â”‚   æ¸¸æˆäº¤æµ   â”‚
â”‚             â”‚  â”‚             â”‚  â”‚             â”‚
â”‚ ğŸ‘¤ å¼ ä¸‰     â”‚  â”‚ ğŸ‘¤ æå››     â”‚  â”‚ ğŸ‘¤ ç‹äº”     â”‚
â”‚ ğŸ‘¤ å°æ˜     â”‚  â”‚ ğŸ‘¤ å°çº¢     â”‚  â”‚ ğŸ‘¤ å°åˆš     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æˆ¿é—´ç³»ç»Ÿæ ¸å¿ƒåŠŸèƒ½


**ğŸ”¸ æˆ¿é—´ç®¡ç†**ï¼š
- **åˆ›å»ºæˆ¿é—´**ï¼šç”¨æˆ·å¯ä»¥åˆ›å»ºæ–°çš„èŠå¤©æˆ¿é—´
- **åŠ å…¥æˆ¿é—´**ï¼šç”¨æˆ·é€‰æ‹©è¦è¿›å…¥çš„æˆ¿é—´
- **ç¦»å¼€æˆ¿é—´**ï¼šç”¨æˆ·å¯ä»¥é€€å‡ºå½“å‰æˆ¿é—´
- **æˆ¿é—´åˆ—è¡¨**ï¼šæ˜¾ç¤ºæ‰€æœ‰å¯ç”¨çš„æˆ¿é—´

**ğŸ”¸ æ¶ˆæ¯éš”ç¦»**ï¼š
```
æˆ¿é—´æ¶ˆæ¯éš”ç¦»åŸç†ï¼š
å¤§å…æˆ¿é—´çš„æ¶ˆæ¯ â†’ åªå‘ç»™å¤§å…çš„ç”¨æˆ·
æŠ€æœ¯è®¨è®ºçš„æ¶ˆæ¯ â†’ åªå‘ç»™æŠ€æœ¯è®¨è®ºæˆ¿é—´çš„ç”¨æˆ·
æ¯ä¸ªæˆ¿é—´éƒ½æ˜¯ç‹¬ç«‹çš„èŠå¤©ç©ºé—´
```

### 2.3 æˆ¿é—´åˆ‡æ¢å®ç°


**å‰ç«¯æˆ¿é—´åˆ‡æ¢**ï¼š
```javascript
// æˆ¿é—´åˆ‡æ¢åŠŸèƒ½
function joinRoom(roomName) {
    // å‘Šè¯‰æœåŠ¡å™¨è¦åŠ å…¥æ–°æˆ¿é—´
    websocket.send(JSON.stringify({
        type: 'join_room',
        room: roomName,
        user: currentUser
    }));
    
    // æ›´æ–°ç•Œé¢æ˜¾ç¤ºå½“å‰æˆ¿é—´
    document.getElementById('currentRoom').textContent = roomName;
    
    // æ¸…ç©ºæ¶ˆæ¯æ˜¾ç¤ºåŒºï¼ˆå› ä¸ºåˆ‡æ¢åˆ°æ–°æˆ¿é—´äº†ï¼‰
    document.getElementById('messageArea').innerHTML = '';
}
```

**åç«¯æˆ¿é—´ç®¡ç†**ï¼š
```javascript
// æœåŠ¡å™¨ç»´æŠ¤æˆ¿é—´ä¿¡æ¯
const rooms = {
    'å¤§å…': new Set(),      // å­˜å‚¨å¤§å…çš„ç”¨æˆ·
    'æŠ€æœ¯è®¨è®º': new Set(),  // å­˜å‚¨æŠ€æœ¯è®¨è®ºæˆ¿é—´çš„ç”¨æˆ·
    'æ¸¸æˆäº¤æµ': new Set()   // å­˜å‚¨æ¸¸æˆäº¤æµæˆ¿é—´çš„ç”¨æˆ·
};

// ç”¨æˆ·åŠ å…¥æˆ¿é—´
function joinUserToRoom(ws, roomName, userName) {
    // ä»æ—§æˆ¿é—´ç§»é™¤ç”¨æˆ·
    removeUserFromAllRooms(ws);
    
    // æ·»åŠ åˆ°æ–°æˆ¿é—´
    rooms[roomName].add(ws);
    ws.currentRoom = roomName;
    ws.userName = userName;
    
    // é€šçŸ¥æˆ¿é—´å…¶ä»–ç”¨æˆ·
    broadcastToRoom(roomName, `${userName} åŠ å…¥äº†æˆ¿é—´`);
}
```

---

## 3. ğŸ’Œ ç§èŠåŠŸèƒ½å¼€å‘


### 3.1 ç§èŠåŠŸèƒ½çš„æ¦‚å¿µ


> **ç§èŠå°±åƒå¾®ä¿¡çš„ä¸€å¯¹ä¸€èŠå¤©**ï¼šåªæœ‰ä½ å’Œå¯¹æ–¹èƒ½çœ‹åˆ°æ¶ˆæ¯ï¼Œå…¶ä»–äººçœ‹ä¸åˆ°

```
ç§èŠvsç¾¤èŠçš„åŒºåˆ«ï¼š

ç¾¤èŠæ¶ˆæ¯ï¼š
å‘é€è€… â†’ æœåŠ¡å™¨ â†’ æˆ¿é—´æ‰€æœ‰ç”¨æˆ·
æ‰€æœ‰äººéƒ½èƒ½çœ‹åˆ°

ç§èŠæ¶ˆæ¯ï¼š  
å‘é€è€… â†’ æœåŠ¡å™¨ â†’ æŒ‡å®šæ¥æ”¶è€…
åªæœ‰ä¸¤ä¸ªäººèƒ½çœ‹åˆ°
```

### 3.2 ç§èŠæ¶ˆæ¯æ ¼å¼


**ğŸ”¸ ç§èŠæ¶ˆæ¯ç»“æ„**ï¼š
```javascript
// ç§èŠæ¶ˆæ¯æ ¼å¼
const privateMessage = {
    type: 'private_message',    // æ¶ˆæ¯ç±»å‹ï¼šç§èŠ
    from: 'å¼ ä¸‰',               // å‘é€è€…
    to: 'æå››',                 // æ¥æ”¶è€…  
    content: 'ä½ å¥½ï¼Œåœ¨å—ï¼Ÿ',     // æ¶ˆæ¯å†…å®¹
    timestamp: '2024-01-01 10:30:00'
};
```

### 3.3 ç§èŠåŠŸèƒ½å®ç°


**å‰ç«¯å‘é€ç§èŠ**ï¼š
```javascript
// å‘é€ç§èŠæ¶ˆæ¯
function sendPrivateMessage(targetUser, message) {
    const privateMsg = {
        type: 'private_message',
        to: targetUser,           // å‘ç»™è°
        content: message,         // æ¶ˆæ¯å†…å®¹
        from: currentUser         // æˆ‘æ˜¯è°
    };
    
    websocket.send(JSON.stringify(privateMsg));
    
    // åœ¨è‡ªå·±çš„èŠå¤©ç•Œé¢æ˜¾ç¤ºå‘é€çš„æ¶ˆæ¯
    displayPrivateMessage(targetUser, message, 'sent');
}

// ç‚¹å‡»ç”¨æˆ·åå¼€å§‹ç§èŠ
function startPrivateChat(userName) {
    // åˆ‡æ¢åˆ°ç§èŠç•Œé¢
    showPrivateChatWindow(userName);
}
```

**åç«¯ç§èŠè½¬å‘**ï¼š
```javascript
// æœåŠ¡å™¨å¤„ç†ç§èŠæ¶ˆæ¯
function handlePrivateMessage(ws, message) {
    const { to, content, from } = message;
    
    // æ‰¾åˆ°ç›®æ ‡ç”¨æˆ·çš„è¿æ¥
    const targetUser = findUserConnection(to);
    
    if (targetUser) {
        // å‘ç»™ç›®æ ‡ç”¨æˆ·
        targetUser.send(JSON.stringify({
            type: 'private_message',
            from: from,
            content: content,
            timestamp: new Date().toLocaleString()
        }));
        
        // å‘Šè¯‰å‘é€è€…æ¶ˆæ¯å·²é€è¾¾
        ws.send(JSON.stringify({
            type: 'message_sent',
            status: 'delivered'
        }));
    } else {
        // ç”¨æˆ·ä¸åœ¨çº¿ï¼Œå‘Šè¯‰å‘é€è€…
        ws.send(JSON.stringify({
            type: 'message_failed',
            reason: 'ç”¨æˆ·ä¸åœ¨çº¿'
        }));
    }
}
```

---

## 4. ğŸ“ æ–‡ä»¶ä¼ è¾“åŠŸèƒ½å®ç°


### 4.1 æ–‡ä»¶ä¼ è¾“çš„æ¦‚å¿µ


> **æ–‡ä»¶ä¼ è¾“å°±åƒå¾®ä¿¡å‘å›¾ç‰‡ã€å‘æ–‡ä»¶**ï¼šæŠŠæœ¬åœ°æ–‡ä»¶å‘ç»™å…¶ä»–ç”¨æˆ·

```
æ–‡ä»¶ä¼ è¾“è¿‡ç¨‹ï¼š
é€‰æ‹©æ–‡ä»¶ â†’ è¯»å–æ–‡ä»¶ â†’ è½¬æ¢æ ¼å¼ â†’ é€šè¿‡WebSocketå‘é€ â†’ å¯¹æ–¹æ¥æ”¶ â†’ æ˜¾ç¤º/ä¸‹è½½
```

### 4.2 æ–‡ä»¶ä¼ è¾“çš„æŠ€æœ¯è¦ç‚¹


**ğŸ”¸ æ–‡ä»¶å¤§å°é™åˆ¶**ï¼š
- WebSocketä¸é€‚åˆä¼ è¾“å¤§æ–‡ä»¶ï¼ˆè¶…è¿‡å‡ MBï¼‰
- é€‚åˆä¼ è¾“ï¼šå›¾ç‰‡ã€å°æ–‡æ¡£ã€éŸ³é¢‘ç‰‡æ®µ
- å¤§æ–‡ä»¶å»ºè®®ä½¿ç”¨HTTPä¸Šä¼ ï¼ŒWebSocketå‘é€é“¾æ¥

**ğŸ”¸ æ–‡ä»¶æ ¼å¼å¤„ç†**ï¼š
```javascript
// æ–‡ä»¶è½¬æ¢ä¸ºBase64æ ¼å¼ä¼ è¾“
function readFileAsBase64(file) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = () => {
            // æ–‡ä»¶å†…å®¹è½¬æ¢ä¸ºBase64å­—ç¬¦ä¸²
            const base64 = reader.result.split(',')[1];
            resolve(base64);
        };
        reader.readAsDataURL(file);
    });
}
```

### 4.3 å›¾ç‰‡ä¼ è¾“å®ç°


**å‰ç«¯å›¾ç‰‡å‘é€**ï¼š
```javascript
// é€‰æ‹©å›¾ç‰‡å¹¶å‘é€
document.getElementById('imageInput').addEventListener('change', async function(e) {
    const file = e.target.files[0];
    
    if (file && file.type.startsWith('image/')) {
        // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶2MBï¼‰
        if (file.size > 2 * 1024 * 1024) {
            alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡2MB');
            return;
        }
        
        // è½¬æ¢ä¸ºBase64
        const base64 = await readFileAsBase64(file);
        
        // å‘é€å›¾ç‰‡æ¶ˆæ¯
        const imageMessage = {
            type: 'image_message',
            fileName: file.name,
            fileSize: file.size,
            imageData: base64,
            from: currentUser
        };
        
        websocket.send(JSON.stringify(imageMessage));
    }
});
```

**å‰ç«¯å›¾ç‰‡æ˜¾ç¤º**ï¼š
```javascript
// æ¥æ”¶å¹¶æ˜¾ç¤ºå›¾ç‰‡
function displayImageMessage(message) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message image-message';
    
    messageDiv.innerHTML = `
        <div class="message-header">
            <span class="user">${message.from}</span>
            <span class="time">${message.timestamp}</span>
        </div>
        <div class="image-content">
            <img src="data:image/jpeg;base64,${message.imageData}" 
                 alt="${message.fileName}" 
                 style="max-width: 300px; border-radius: 8px;">
        </div>
    `;
    
    document.getElementById('messageArea').appendChild(messageDiv);
}
```

---

## 5. ğŸ˜€ è¡¨æƒ…åŒ…ä¸å¯Œæ–‡æœ¬æ¶ˆæ¯


### 5.1 è¡¨æƒ…åŒ…åŠŸèƒ½çš„æ¦‚å¿µ


> **è¡¨æƒ…åŒ…å°±åƒå¾®ä¿¡èŠå¤©çš„emojiå’Œè‡ªå®šä¹‰è¡¨æƒ…**ï¼šè®©èŠå¤©æ›´ç”ŸåŠ¨æœ‰è¶£

```
è¡¨æƒ…ç±»å‹ï¼š
ğŸ˜€ğŸ˜ƒğŸ˜„ğŸ˜ â†’ ç³»ç»Ÿemojiè¡¨æƒ…
[å¾®ç¬‘][å“­æ³£] â†’ æ–‡å­—è¡¨æƒ…è½¬æ¢
ğŸ‰.gif      â†’ åŠ¨æ€è¡¨æƒ…åŒ…
```

### 5.2 Emojiè¡¨æƒ…å®ç°


**å‰ç«¯è¡¨æƒ…é€‰æ‹©**ï¼š
```javascript
// å¸¸ç”¨è¡¨æƒ…åˆ—è¡¨
const emojiList = [
    'ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ˜‚', 'ğŸ¤£',
    'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Œ', 'ğŸ˜', 'ğŸ¥°',
    'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š', 'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜', 'ğŸ˜œ'
];

// åˆ›å»ºè¡¨æƒ…é€‰æ‹©é¢æ¿
function createEmojiPicker() {
    const emojiPicker = document.createElement('div');
    emojiPicker.className = 'emoji-picker';
    
    emojiList.forEach(emoji => {
        const emojiBtn = document.createElement('button');
        emojiBtn.textContent = emoji;
        emojiBtn.onclick = () => insertEmoji(emoji);
        emojiPicker.appendChild(emojiBtn);
    });
    
    return emojiPicker;
}

// æ’å…¥è¡¨æƒ…åˆ°è¾“å…¥æ¡†
function insertEmoji(emoji) {
    const input = document.getElementById('messageInput');
    input.value += emoji;
    input.focus();
}
```

### 5.3 å¯Œæ–‡æœ¬æ¶ˆæ¯å¤„ç†


**ğŸ”¸ æ”¯æŒçš„å¯Œæ–‡æœ¬æ ¼å¼**ï¼š
- **ç²—ä½“**ï¼š`**æ–‡å­—**` â†’ **æ–‡å­—**
- **æ–œä½“**ï¼š`*æ–‡å­—*` â†’ *æ–‡å­—*
- **é“¾æ¥**ï¼š`[æ ‡é¢˜](ç½‘å€)` â†’ å¯ç‚¹å‡»é“¾æ¥
- **ä»£ç **ï¼š`` `ä»£ç ` `` â†’ `ä»£ç `

**å‰ç«¯å¯Œæ–‡æœ¬æ¸²æŸ“**ï¼š
```javascript
// ç®€å•çš„å¯Œæ–‡æœ¬å¤„ç†
function formatMessage(text) {
    return text
        // å¤„ç†ç²—ä½“
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        // å¤„ç†æ–œä½“
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        // å¤„ç†ä»£ç 
        .replace(/`(.*?)`/g, '<code>$1</code>')
        // å¤„ç†é“¾æ¥ï¼ˆç®€åŒ–ç‰ˆï¼‰
        .replace(/https?:\/\/[^\s]+/g, '<a href="$&" target="_blank">$&</a>');
}

// æ˜¾ç¤ºå¯Œæ–‡æœ¬æ¶ˆæ¯
function displayFormattedMessage(message) {
    const messageDiv = document.createElement('div');
    messageDiv.innerHTML = `
        <div class="message">
            <span class="user">${message.from}</span>: 
            <span class="content">${formatMessage(message.content)}</span>
        </div>
    `;
    document.getElementById('messageArea').appendChild(messageDiv);
}
```

---

## 6. ğŸ“¦ æ¶ˆæ¯æ ¼å¼å°è£…


### 6.1 ç»Ÿä¸€æ¶ˆæ¯æ ¼å¼çš„é‡è¦æ€§


> **ç»Ÿä¸€æ¶ˆæ¯æ ¼å¼å°±åƒå¿«é€’åŒ…è£…æ ‡å‡†**ï¼šæ‰€æœ‰æ¶ˆæ¯éƒ½æŒ‰åŒä¸€ä¸ªæ ¼å¼æ‰“åŒ…ï¼Œæ–¹ä¾¿å¤„ç†

```
ä¸ºä»€ä¹ˆéœ€è¦ç»Ÿä¸€æ ¼å¼ï¼š
- å‰ç«¯çŸ¥é“å¦‚ä½•è§£ææ¶ˆæ¯
- åç«¯çŸ¥é“å¦‚ä½•å¤„ç†æ¶ˆæ¯  
- ä¾¿äºæ‰©å±•æ–°çš„æ¶ˆæ¯ç±»å‹
- æ–¹ä¾¿è°ƒè¯•å’Œç»´æŠ¤
```

### 6.2 æ ‡å‡†æ¶ˆæ¯æ ¼å¼è®¾è®¡


**ğŸ”¸ åŸºç¡€æ¶ˆæ¯ç»“æ„**ï¼š
```javascript
// æ ‡å‡†æ¶ˆæ¯æ ¼å¼
const messageFormat = {
    id: 'æ¶ˆæ¯å”¯ä¸€ID',           // ç”¨äºå»é‡å’Œç¡®è®¤
    type: 'æ¶ˆæ¯ç±»å‹',           // text/image/file/system
    from: 'å‘é€è€…ä¿¡æ¯',         // ç”¨æˆ·æ˜µç§°æˆ–ID
    to: 'æ¥æ”¶è€…ä¿¡æ¯',           // ç§èŠæ—¶çš„ç›®æ ‡ç”¨æˆ·
    room: 'æˆ¿é—´åç§°',           // ç¾¤èŠæ—¶çš„æˆ¿é—´
    content: 'æ¶ˆæ¯å†…å®¹',        // æ–‡æœ¬/å›¾ç‰‡æ•°æ®/æ–‡ä»¶ä¿¡æ¯
    timestamp: 'å‘é€æ—¶é—´',      // 2024-01-01 10:30:00
    extra: {}                   // æ‰©å±•ä¿¡æ¯
};
```

### 6.3 ä¸åŒç±»å‹æ¶ˆæ¯ç¤ºä¾‹


**æ–‡æœ¬æ¶ˆæ¯**ï¼š
```javascript
const textMessage = {
    id: generateId(),
    type: 'text',
    from: 'å¼ ä¸‰',
    room: 'å¤§å…',
    content: 'å¤§å®¶å¥½ï¼',
    timestamp: '2024-01-01 10:30:00',
    extra: {
        formatted: true  // æ˜¯å¦æ”¯æŒå¯Œæ–‡æœ¬
    }
};
```

**ç³»ç»Ÿæ¶ˆæ¯**ï¼š
```javascript
const systemMessage = {
    id: generateId(),
    type: 'system',
    from: 'system',
    room: 'å¤§å…',
    content: 'å¼ ä¸‰ åŠ å…¥äº†èŠå¤©å®¤',
    timestamp: '2024-01-01 10:30:00',
    extra: {
        action: 'user_join',  // ç³»ç»Ÿæ¶ˆæ¯ç±»å‹
        user: 'å¼ ä¸‰'
    }
};
```

**å›¾ç‰‡æ¶ˆæ¯**ï¼š
```javascript
const imageMessage = {
    id: generateId(),
    type: 'image',
    from: 'æå››',
    room: 'å¤§å…',
    content: 'data:image/jpeg;base64,/9j/4AAQSkZJRgABA...',
    timestamp: '2024-01-01 10:30:00',
    extra: {
        fileName: 'photo.jpg',
        fileSize: 245678
    }
};
```

### 6.4 æ¶ˆæ¯å¤„ç†å·¥å…·å‡½æ•°


```javascript
// æ¶ˆæ¯å·¥å…·ç±»
class MessageUtils {
    // åˆ›å»ºæ–‡æœ¬æ¶ˆæ¯
    static createTextMessage(from, content, room = null) {
        return {
            id: this.generateId(),
            type: 'text',
            from: from,
            room: room,
            content: content,
            timestamp: this.getCurrentTime(),
            extra: {}
        };
    }
    
    // åˆ›å»ºç³»ç»Ÿæ¶ˆæ¯
    static createSystemMessage(content, room, action = null) {
        return {
            id: this.generateId(),
            type: 'system',
            from: 'system',
            room: room,
            content: content,
            timestamp: this.getCurrentTime(),
            extra: { action: action }
        };
    }
    
    // ç”Ÿæˆå”¯ä¸€ID
    static generateId() {
        return Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
    
    // è·å–å½“å‰æ—¶é—´
    static getCurrentTime() {
        return new Date().toLocaleString();
    }
}
```

---

## 7. ğŸ” æ¶ˆæ¯æœç´¢ä¸å†å²è®°å½•


### 7.1 å†å²è®°å½•çš„æ¦‚å¿µ


> **å†å²è®°å½•å°±åƒå¾®ä¿¡èŠå¤©è®°å½•**ï¼šèƒ½æŸ¥çœ‹ä»¥å‰çš„èŠå¤©å†…å®¹ï¼Œæ”¯æŒæœç´¢å…³é”®è¯

```
å†å²è®°å½•åŠŸèƒ½ï¼š
ğŸ“š å­˜å‚¨èŠå¤©è®°å½•
ğŸ” æœç´¢èŠå¤©å†…å®¹  
ğŸ“… æŒ‰æ—¥æœŸæŸ¥çœ‹
ğŸ‘¤ æŒ‰ç”¨æˆ·ç­›é€‰
```

### 7.2 æ¶ˆæ¯å­˜å‚¨æ–¹æ¡ˆ


**ğŸ”¸ å‰ç«¯ä¸´æ—¶å­˜å‚¨**ï¼š
```javascript
// å‰ç«¯æ¶ˆæ¯ç¼“å­˜
class MessageStorage {
    constructor() {
        this.messages = [];           // å½“å‰ä¼šè¯æ¶ˆæ¯
        this.maxMessages = 1000;      // æœ€å¤šä¿å­˜1000æ¡
    }
    
    // æ·»åŠ æ¶ˆæ¯
    addMessage(message) {
        this.messages.push(message);
        
        // è¶…è¿‡é™åˆ¶åˆ é™¤æ—§æ¶ˆæ¯
        if (this.messages.length > this.maxMessages) {
            this.messages.shift();
        }
        
        // ä¿å­˜åˆ°localStorage
        this.saveToLocal();
    }
    
    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    saveToLocal() {
        localStorage.setItem('chatHistory', JSON.stringify(this.messages));
    }
    
    // ä»æœ¬åœ°å­˜å‚¨åŠ è½½
    loadFromLocal() {
        const saved = localStorage.getItem('chatHistory');
        if (saved) {
            this.messages = JSON.parse(saved);
        }
    }
}
```

### 7.3 æ¶ˆæ¯æœç´¢åŠŸèƒ½


**å‰ç«¯æœç´¢å®ç°**ï¼š
```javascript
// æœç´¢æ¶ˆæ¯åŠŸèƒ½
class MessageSearch {
    // æŒ‰å…³é”®è¯æœç´¢
    static searchByKeyword(messages, keyword) {
        return messages.filter(msg => 
            msg.content.toLowerCase().includes(keyword.toLowerCase())
        );
    }
    
    // æŒ‰ç”¨æˆ·æœç´¢
    static searchByUser(messages, userName) {
        return messages.filter(msg => msg.from === userName);
    }
    
    // æŒ‰æ—¥æœŸæœç´¢
    static searchByDate(messages, date) {
        return messages.filter(msg => 
            msg.timestamp.startsWith(date)
        );
    }
    
    // ç»¼åˆæœç´¢
    static advancedSearch(messages, options) {
        let results = messages;
        
        if (options.keyword) {
            results = this.searchByKeyword(results, options.keyword);
        }
        
        if (options.user) {
            results = this.searchByUser(results, options.user);
        }
        
        if (options.date) {
            results = this.searchByDate(results, options.date);
        }
        
        return results;
    }
}
```

**æœç´¢ç•Œé¢å®ç°**ï¼š
```javascript
// æ˜¾ç¤ºæœç´¢ç»“æœ
function showSearchResults() {
    const keyword = document.getElementById('searchInput').value;
    const results = MessageSearch.searchByKeyword(messageStorage.messages, keyword);
    
    const resultsDiv = document.getElementById('searchResults');
    resultsDiv.innerHTML = '';
    
    if (results.length === 0) {
        resultsDiv.innerHTML = '<p>æ²¡æœ‰æ‰¾åˆ°ç›¸å…³æ¶ˆæ¯</p>';
        return;
    }
    
    results.forEach(msg => {
        const msgDiv = document.createElement('div');
        msgDiv.innerHTML = `
            <div class="search-result">
                <span class="user">${msg.from}</span>
                <span class="time">${msg.timestamp}</span>
                <div class="content">${highlightKeyword(msg.content, keyword)}</div>
            </div>
        `;
        resultsDiv.appendChild(msgDiv);
    });
}

// é«˜äº®å…³é”®è¯
function highlightKeyword(text, keyword) {
    const regex = new RegExp(`(${keyword})`, 'gi');
    return text.replace(regex, '<mark>$1</mark>');
}
```

---

## 8. ğŸ‘‘ ç”¨æˆ·æƒé™ç®¡ç†ç³»ç»Ÿ


### 8.1 æƒé™ç³»ç»Ÿçš„æ¦‚å¿µ


> **æƒé™ç³»ç»Ÿå°±åƒQQç¾¤çš„ç®¡ç†å‘˜å’Œç¾¤ä¸»**ï¼šä¸åŒç”¨æˆ·æœ‰ä¸åŒçš„æƒé™ï¼Œèƒ½åšçš„æ“ä½œä¸ä¸€æ ·

```
ç”¨æˆ·è§’è‰²å±‚çº§ï¼š
ğŸ‘‘ è¶…çº§ç®¡ç†å‘˜ - æœ€é«˜æƒé™ï¼Œç®¡ç†æ•´ä¸ªç³»ç»Ÿ
ğŸ‘® æˆ¿é—´ç®¡ç†å‘˜ - ç®¡ç†ç‰¹å®šæˆ¿é—´
ğŸ‘¤ æ™®é€šç”¨æˆ·   - åŸºæœ¬èŠå¤©æƒé™
ğŸ”‡ å—é™ç”¨æˆ·   - éƒ¨åˆ†åŠŸèƒ½å—é™
```

### 8.2 æƒé™ç±»å‹å®šä¹‰


**ğŸ”¸ åŸºæœ¬æƒé™ç±»å‹**ï¼š
```javascript
// æƒé™å®šä¹‰
const PERMISSIONS = {
    SEND_MESSAGE: 'send_message',      // å‘é€æ¶ˆæ¯
    CREATE_ROOM: 'create_room',        // åˆ›å»ºæˆ¿é—´
    DELETE_MESSAGE: 'delete_message',  // åˆ é™¤æ¶ˆæ¯
    KICK_USER: 'kick_user',           // è¸¢å‡ºç”¨æˆ·
    BAN_USER: 'ban_user',             // å°ç¦ç”¨æˆ·
    MANAGE_ROOM: 'manage_room'        // ç®¡ç†æˆ¿é—´
};

// ç”¨æˆ·è§’è‰²æƒé™é…ç½®
const ROLE_PERMISSIONS = {
    admin: [
        PERMISSIONS.SEND_MESSAGE,
        PERMISSIONS.CREATE_ROOM,
        PERMISSIONS.DELETE_MESSAGE,
        PERMISSIONS.KICK_USER,
        PERMISSIONS.BAN_USER,
        PERMISSIONS.MANAGE_ROOM
    ],
    moderator: [
        PERMISSIONS.SEND_MESSAGE,
        PERMISSIONS.DELETE_MESSAGE,
        PERMISSIONS.KICK_USER,
        PERMISSIONS.MANAGE_ROOM
    ],
    user: [
        PERMISSIONS.SEND_MESSAGE
    ],
    banned: []  // è¢«å°ç¦ç”¨æˆ·æ²¡æœ‰ä»»ä½•æƒé™
};
```

### 8.3 æƒé™æ£€æŸ¥æœºåˆ¶


**å‰ç«¯æƒé™æ£€æŸ¥**ï¼š
```javascript
// ç”¨æˆ·æƒé™ç®¡ç†
class UserPermissions {
    constructor(userRole) {
        this.userRole = userRole;
        this.permissions = ROLE_PERMISSIONS[userRole] || [];
    }
    
    // æ£€æŸ¥æ˜¯å¦æœ‰æŒ‡å®šæƒé™
    hasPermission(permission) {
        return this.permissions.includes(permission);
    }
    
    // æ£€æŸ¥æ˜¯å¦èƒ½å‘é€æ¶ˆæ¯
    canSendMessage() {
        return this.hasPermission(PERMISSIONS.SEND_MESSAGE);
    }
    
    // æ£€æŸ¥æ˜¯å¦èƒ½åˆ é™¤æ¶ˆæ¯
    canDeleteMessage() {
        return this.hasPermission(PERMISSIONS.DELETE_MESSAGE);
    }
    
    // æ£€æŸ¥æ˜¯å¦èƒ½è¸¢å‡ºç”¨æˆ·
    canKickUser() {
        return this.hasPermission(PERMISSIONS.KICK_USER);
    }
}

// ä½¿ç”¨æƒé™æ£€æŸ¥
function sendMessage() {
    if (!userPermissions.canSendMessage()) {
        alert('æ‚¨è¢«ç¦è¨€äº†ï¼Œæ— æ³•å‘é€æ¶ˆæ¯');
        return;
    }
    
    // å‘é€æ¶ˆæ¯é€»è¾‘...
}
```

### 8.4 ç®¡ç†å‘˜æ“ä½œåŠŸèƒ½


**ç®¡ç†å‘˜ç•Œé¢**ï¼š
```javascript
// æ˜¾ç¤ºç®¡ç†å‘˜æ“ä½œæŒ‰é’®
function showAdminControls(message) {
    if (!userPermissions.canDeleteMessage()) {
        return; // ä¸æ˜¯ç®¡ç†å‘˜ï¼Œä¸æ˜¾ç¤ºæ“ä½œæŒ‰é’®
    }
    
    const controlsDiv = document.createElement('div');
    controlsDiv.className = 'admin-controls';
    controlsDiv.innerHTML = `
        <button onclick="deleteMessage('${message.id}')">ğŸ—‘ï¸ åˆ é™¤</button>
        <button onclick="banUser('${message.from}')">ğŸ”‡ ç¦è¨€</button>
    `;
    
    return controlsDiv;
}

// åˆ é™¤æ¶ˆæ¯
function deleteMessage(messageId) {
    if (!userPermissions.canDeleteMessage()) {
        alert('æƒé™ä¸è¶³');
        return;
    }
    
    websocket.send(JSON.stringify({
        type: 'delete_message',
        messageId: messageId,
        admin: currentUser
    }));
}

// ç¦è¨€ç”¨æˆ·
function banUser(userName) {
    if (!userPermissions.canKickUser()) {
        alert('æƒé™ä¸è¶³');
        return;
    }
    
    if (confirm(`ç¡®å®šè¦ç¦è¨€ç”¨æˆ· ${userName} å—ï¼Ÿ`)) {
        websocket.send(JSON.stringify({
            type: 'ban_user',
            targetUser: userName,
            admin: currentUser
        }));
    }
}
```

---

## 9. ğŸ”„ å‰ç«¯æ¶ˆæ¯å¤„ç†æµç¨‹


### 9.1 å‰ç«¯æ¶ˆæ¯å¤„ç†çš„å®Œæ•´æµç¨‹


> **å‰ç«¯æ¶ˆæ¯å¤„ç†å°±åƒå¿«é€’æ”¶å‘ç«™**ï¼šæ”¶åˆ°æ¶ˆæ¯è¦åˆ†ç±»å¤„ç†ï¼Œå‘é€æ¶ˆæ¯è¦æ‰“åŒ…å‘å‡º

```
å‰ç«¯æ¶ˆæ¯å¤„ç†æµç¨‹ï¼š

å‘é€æ¶ˆæ¯ï¼š
ç”¨æˆ·è¾“å…¥ â†’ æ ¼å¼æ£€æŸ¥ â†’ æƒé™æ£€æŸ¥ â†’ æ¶ˆæ¯å°è£… â†’ WebSocketå‘é€

æ¥æ”¶æ¶ˆæ¯ï¼š
WebSocketæ¥æ”¶ â†’ æ¶ˆæ¯è§£æ â†’ ç±»å‹åˆ¤æ–­ â†’ å¯¹åº”å¤„ç† â†’ ç•Œé¢æ›´æ–°
```

### 9.2 å‘é€æ¶ˆæ¯æµç¨‹å®ç°


**å®Œæ•´çš„å‘é€æµç¨‹**ï¼š
```javascript
// æ¶ˆæ¯å‘é€ç®¡ç†å™¨
class MessageSender {
    constructor(websocket, userPermissions) {
        this.ws = websocket;
        this.permissions = userPermissions;
    }
    
    // å‘é€æ–‡æœ¬æ¶ˆæ¯
    sendTextMessage(content, room = null) {
        // 1. æƒé™æ£€æŸ¥
        if (!this.permissions.canSendMessage()) {
            this.showError('æ‚¨æ²¡æœ‰å‘é€æ¶ˆæ¯çš„æƒé™');
            return false;
        }
        
        // 2. å†…å®¹æ£€æŸ¥
        if (!this.validateContent(content)) {
            return false;
        }
        
        // 3. æ¶ˆæ¯å°è£…
        const message = MessageUtils.createTextMessage(
            currentUser, 
            content, 
            room
        );
        
        // 4. å‘é€æ¶ˆæ¯
        this.sendMessage(message);
        
        // 5. ç•Œé¢æ›´æ–°ï¼ˆæ˜¾ç¤ºè‡ªå·±å‘é€çš„æ¶ˆæ¯ï¼‰
        this.displaySentMessage(message);
        
        return true;
    }
    
    // å†…å®¹éªŒè¯
    validateContent(content) {
        if (!content || content.trim().length === 0) {
            this.showError('æ¶ˆæ¯å†…å®¹ä¸èƒ½ä¸ºç©º');
            return false;
        }
        
        if (content.length > 1000) {
            this.showError('æ¶ˆæ¯é•¿åº¦ä¸èƒ½è¶…è¿‡1000å­—ç¬¦');
            return false;
        }
        
        return true;
    }
    
    // å‘é€åˆ°æœåŠ¡å™¨
    sendMessage(message) {
        try {
            this.ws.send(JSON.stringify(message));
        } catch (error) {
            this.showError('å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
        }
    }
    
    // æ˜¾ç¤ºå‘é€çš„æ¶ˆæ¯
    displaySentMessage(message) {
        this.addMessageToUI(message, 'sent');
        this.scrollToBottom();
    }
    
    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
    showError(message) {
        alert(message);
    }
}
```

### 9.3 æ¥æ”¶æ¶ˆæ¯æµç¨‹å®ç°


**å®Œæ•´çš„æ¥æ”¶æµç¨‹**ï¼š
```javascript
// æ¶ˆæ¯æ¥æ”¶ç®¡ç†å™¨
class MessageReceiver {
    constructor() {
        this.handlers = {
            'text': this.handleTextMessage,
            'image': this.handleImageMessage,
            'system': this.handleSystemMessage,
            'private_message': this.handlePrivateMessage,
            'user_list': this.handleUserListUpdate
        };
    }
    
    // ä¸»è¦æ¶ˆæ¯å¤„ç†å…¥å£
    processMessage(rawMessage) {
        try {
            // 1. è§£æJSON
            const message = JSON.parse(rawMessage);
            
            // 2. éªŒè¯æ¶ˆæ¯æ ¼å¼
            if (!this.validateMessage(message)) {
                console.error('æ— æ•ˆæ¶ˆæ¯æ ¼å¼:', message);
                return;
            }
            
            // 3. æ ¹æ®ç±»å‹è°ƒç”¨å¯¹åº”å¤„ç†å™¨
            const handler = this.handlers[message.type];
            if (handler) {
                handler.call(this, message);
            } else {
                console.warn('æœªçŸ¥æ¶ˆæ¯ç±»å‹:', message.type);
            }
            
            // 4. ä¿å­˜åˆ°å†å²è®°å½•
            messageStorage.addMessage(message);
            
        } catch (error) {
            console.error('æ¶ˆæ¯å¤„ç†é”™è¯¯:', error);
        }
    }
    
    // éªŒè¯æ¶ˆæ¯æ ¼å¼
    validateMessage(message) {
        return message && message.type && message.timestamp;
    }
    
    // å¤„ç†æ–‡æœ¬æ¶ˆæ¯
    handleTextMessage(message) {
        this.displayTextMessage(message);
        this.showNotification(message);
    }
    
    // å¤„ç†å›¾ç‰‡æ¶ˆæ¯
    handleImageMessage(message) {
        this.displayImageMessage(message);
        this.showNotification(message);
    }
    
    // å¤„ç†ç³»ç»Ÿæ¶ˆæ¯
    handleSystemMessage(message) {
        this.displaySystemMessage(message);
    }
    
    // æ˜¾ç¤ºé€šçŸ¥
    showNotification(message) {
        if (document.hidden) {  // é¡µé¢ä¸å¯è§æ—¶æ˜¾ç¤ºé€šçŸ¥
            new Notification(`${message.from}`, {
                body: message.content,
                icon: '/favicon.ico'
            });
        }
    }
}
```

### 9.4 æ¶ˆæ¯æ¸²æŸ“ä¼˜åŒ–


**é«˜æ•ˆçš„æ¶ˆæ¯æ¸²æŸ“**ï¼š
```javascript
// æ¶ˆæ¯æ¸²æŸ“ç®¡ç†å™¨
class MessageRenderer {
    constructor() {
        this.messageContainer = document.getElementById('messageArea');
        this.maxMessages = 100;  // æœ€å¤šæ˜¾ç¤º100æ¡æ¶ˆæ¯
    }
    
    // æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢
    addMessage(message, type = 'received') {
        const messageElement = this.createMessageElement(message, type);
        
        // é™åˆ¶æ¶ˆæ¯æ•°é‡
        this.limitMessageCount();
        
        // æ·»åŠ åˆ°å®¹å™¨
        this.messageContainer.appendChild(messageElement);
        
        // è‡ªåŠ¨æ»šåŠ¨
        this.scrollToBottom();
        
        // æ·»åŠ åŠ¨ç”»æ•ˆæœ
        this.animateNewMessage(messageElement);
    }
    
    // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
    createMessageElement(message, type) {
        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${type} ${message.type}-message`;
        msgDiv.setAttribute('data-id', message.id);
        
        msgDiv.innerHTML = this.getMessageHTML(message, type);
        
        return msgDiv;
    }
    
    // é™åˆ¶æ¶ˆæ¯æ•°é‡
    limitMessageCount() {
        const messages = this.messageContainer.children;
        if (messages.length >= this.maxMessages) {
            // åˆ é™¤æœ€æ—§çš„æ¶ˆæ¯
            this.messageContainer.removeChild(messages[0]);
        }
    }
    
    // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
    scrollToBottom() {
        this.messageContainer.scrollTop = this.messageContainer.scrollHeight;
    }
}
```

---

## 10. ğŸ“¢ åç«¯å¹¿æ’­å®ç°


### 10.1 å¹¿æ’­æœºåˆ¶çš„æ¦‚å¿µ


> **å¹¿æ’­å°±åƒå­¦æ ¡çš„å¹¿æ’­ç«™**ï¼šä¸€ä¸ªäººè¯´è¯ï¼Œæ‰€æœ‰äººéƒ½èƒ½å¬åˆ°

```
å¹¿æ’­çš„ç±»å‹ï¼š
ğŸ“¢ å…¨å±€å¹¿æ’­ - å‘ç»™æ‰€æœ‰åœ¨çº¿ç”¨æˆ·
ğŸ  æˆ¿é—´å¹¿æ’­ - åªå‘ç»™æˆ¿é—´å†…çš„ç”¨æˆ·  
ğŸ‘¥ ç¾¤ç»„å¹¿æ’­ - å‘ç»™ç‰¹å®šç”¨æˆ·ç¾¤ç»„
ğŸ“§ ç§èŠæ¶ˆæ¯ - åªå‘ç»™æŒ‡å®šç”¨æˆ·
```

### 10.2 Node.js WebSocketæœåŠ¡å™¨åŸºç¡€


**ç®€å•çš„WebSocketæœåŠ¡å™¨**ï¼š
```javascript
const WebSocket = require('ws');

// åˆ›å»ºWebSocketæœåŠ¡å™¨
const wss = new WebSocket.Server({ port: 8080 });

// å­˜å‚¨æ‰€æœ‰è¿æ¥çš„ç”¨æˆ·
const clients = new Map();  // å­˜å‚¨è¿æ¥ä¿¡æ¯
const rooms = new Map();    // å­˜å‚¨æˆ¿é—´ä¿¡æ¯

// å¤„ç†æ–°è¿æ¥
wss.on('connection', function connection(ws) {
    console.log('æ–°ç”¨æˆ·è¿æ¥');
    
    // å¤„ç†æ¶ˆæ¯
    ws.on('message', function incoming(data) {
        try {
            const message = JSON.parse(data);
            handleMessage(ws, message);
        } catch (error) {
            console.error('æ¶ˆæ¯è§£æé”™è¯¯:', error);
        }
    });
    
    // å¤„ç†æ–­å¼€è¿æ¥
    ws.on('close', function() {
        handleDisconnection(ws);
    });
});
```

### 10.3 æˆ¿é—´å¹¿æ’­å®ç°


**æˆ¿é—´ç®¡ç†å’Œå¹¿æ’­**ï¼š
```javascript
// æˆ¿é—´ç®¡ç†å™¨
class RoomManager {
    constructor() {
        this.rooms = new Map();  // æˆ¿é—´åˆ—è¡¨
        this.users = new Map();  // ç”¨æˆ·ä¿¡æ¯
    }
    
    // ç”¨æˆ·åŠ å…¥æˆ¿é—´
    joinRoom(ws, roomName, userName) {
        // ä»æ—§æˆ¿é—´ç§»é™¤
        this.leaveCurrentRoom(ws);
        
        // è·å–æˆ–åˆ›å»ºæˆ¿é—´
        if (!this.rooms.has(roomName)) {
            this.rooms.set(roomName, new Set());
        }
        
        const room = this.rooms.get(roomName);
        room.add(ws);
        
        // è®°å½•ç”¨æˆ·ä¿¡æ¯
        this.users.set(ws, {
            name: userName,
            room: roomName,
            joinTime: new Date()
        });
        
        // é€šçŸ¥æˆ¿é—´å…¶ä»–ç”¨æˆ·
        this.broadcastToRoom(roomName, {
            type: 'system',
            content: `${userName} åŠ å…¥äº†æˆ¿é—´`,
            timestamp: new Date().toLocaleString()
        }, ws); // æ’é™¤è‡ªå·±
        
        // å‘é€æˆ¿é—´ç”¨æˆ·åˆ—è¡¨ç»™æ–°ç”¨æˆ·
        this.sendRoomUserList(ws, roomName);
    }
    
    // æˆ¿é—´å¹¿æ’­
    broadcastToRoom(roomName, message, excludeWs = null) {
        const room = this.rooms.get(roomName);
        if (!room) return;
        
        const messageStr = JSON.stringify(message);
        
        room.forEach(ws => {
            // æ’é™¤æŒ‡å®šè¿æ¥ï¼ˆæ¯”å¦‚å‘é€è€…è‡ªå·±ï¼‰
            if (ws !== excludeWs && ws.readyState === WebSocket.OPEN) {
                ws.send(messageStr);
            }
        });
    }
    
    // å…¨å±€å¹¿æ’­
    broadcastToAll(message) {
        const messageStr = JSON.stringify(message);
        
        wss.clients.forEach(ws => {
            if (ws.readyState === WebSocket.OPEN) {
                ws.send(messageStr);
            }
        });
    }
    
    // å‘é€æˆ¿é—´ç”¨æˆ·åˆ—è¡¨
    sendRoomUserList(ws, roomName) {
        const room = this.rooms.get(roomName);
        if (!room) return;
        
        const userList = [];
        room.forEach(userWs => {
            const user = this.users.get(userWs);
            if (user) {
                userList.push({
                    name: user.name,
                    joinTime: user.joinTime
                });
            }
        });
        
        ws.send(JSON.stringify({
            type: 'user_list',
            room: roomName,
            users: userList
        }));
    }
}
```

### 10.4 æ¶ˆæ¯å¤„ç†å’Œè½¬å‘


**å®Œæ•´çš„æ¶ˆæ¯å¤„ç†é€»è¾‘**ï¼š
```javascript
const roomManager = new RoomManager();

// å¤„ç†æ”¶åˆ°çš„æ¶ˆæ¯
function handleMessage(ws, message) {
    const user = roomManager.users.get(ws);
    
    switch (message.type) {
        case 'join_room':
            roomManager.joinRoom(ws, message.room, message.user);
            break;
            
        case 'text':
            handleTextMessage(ws, message, user);
            break;
            
        case 'private_message':
            handlePrivateMessage(ws, message);
            break;
            
        case 'image':
            handleImageMessage(ws, message, user);
            break;
            
        default:
            console.log('æœªçŸ¥æ¶ˆæ¯ç±»å‹:', message.type);
    }
}

// å¤„ç†æ–‡æœ¬æ¶ˆæ¯
function handleTextMessage(ws, message, user) {
    if (!user) {
        ws.send(JSON.stringify({
            type: 'error',
            message: 'è¯·å…ˆåŠ å…¥æˆ¿é—´'
        }));
        return;
    }
    
    // æ„é€ å®Œæ•´æ¶ˆæ¯
    const fullMessage = {
        id: generateId(),
        type: 'text',
        from: user.name,
        room: user.room,
        content: message.content,
        timestamp: new Date().toLocaleString()
    };
    
    // å¹¿æ’­ç»™æˆ¿é—´æ‰€æœ‰ç”¨æˆ·ï¼ˆåŒ…æ‹¬å‘é€è€…ï¼‰
    roomManager.broadcastToRoom(user.room, fullMessage);
}

// å¤„ç†ç§èŠæ¶ˆæ¯
function handlePrivateMessage(ws, message) {
    const sender = roomManager.users.get(ws);
    if (!sender) return;
    
    // æ‰¾åˆ°ç›®æ ‡ç”¨æˆ·
    const targetWs = findUserByName(message.to);
    if (targetWs) {
        const privateMsg = {
            id: generateId(),
            type: 'private_message',
            from: sender.name,
            content: message.content,
            timestamp: new Date().toLocaleString()
        };
        
        // å‘ç»™ç›®æ ‡ç”¨æˆ·
        targetWs.send(JSON.stringify(privateMsg));
        
        // å‘é€ç¡®è®¤ç»™å‘é€è€…
        ws.send(JSON.stringify({
            type: 'message_sent',
            to: message.to
        }));
    } else {
        // ç”¨æˆ·ä¸åœ¨çº¿
        ws.send(JSON.stringify({
            type: 'error',
            message: 'ç”¨æˆ·ä¸åœ¨çº¿'
        }));
    }
}
```

---

## 11. ğŸ‘¥ åœ¨çº¿ç”¨æˆ·æ˜¾ç¤ºä¸æç¤º


### 11.1 åœ¨çº¿ç”¨æˆ·åŠŸèƒ½çš„ä»·å€¼


> **åœ¨çº¿ç”¨æˆ·æ˜¾ç¤ºå°±åƒQQå¥½å‹åˆ—è¡¨**ï¼šçœ‹åˆ°è°åœ¨çº¿ï¼Œè°ç¦»çº¿ï¼Œå¢åŠ äº’åŠ¨æ€§

```
åœ¨çº¿ç”¨æˆ·åŠŸèƒ½åŒ…æ‹¬ï¼š
ğŸ‘¤ æ˜¾ç¤ºåœ¨çº¿ç”¨æˆ·åˆ—è¡¨
âœ… ç”¨æˆ·ä¸Šçº¿æç¤º
âŒ ç”¨æˆ·ç¦»çº¿æç¤º  
ğŸ‘‘ æ˜¾ç¤ºç”¨æˆ·è§’è‰²/çŠ¶æ€
ğŸ“Š åœ¨çº¿äººæ•°ç»Ÿè®¡
```

### 11.2 ç”¨æˆ·çŠ¶æ€ç®¡ç†


**ç”¨æˆ·çŠ¶æ€å®šä¹‰**ï¼š
```javascript
// ç”¨æˆ·çŠ¶æ€ç±»å‹
const USER_STATUS = {
    ONLINE: 'online',      // åœ¨çº¿
    AWAY: 'away',         // ç¦»å¼€
    BUSY: 'busy',         // å¿™ç¢Œ
    OFFLINE: 'offline'    // ç¦»çº¿
};

// ç”¨æˆ·ä¿¡æ¯ç»“æ„
class UserInfo {
    constructor(name, ws) {
        this.name = name;
        this.ws = ws;
        this.status = USER_STATUS.ONLINE;
        this.room = null;
        this.joinTime = new Date();
        this.lastActiveTime = new Date();
        this.role = 'user';  // user, moderator, admin
    }
    
    // æ›´æ–°æœ€åæ´»è·ƒæ—¶é—´
    updateActivity() {
        this.lastActiveTime = new Date();
        if (this.status === USER_STATUS.AWAY) {
            this.status = USER_STATUS.ONLINE;
        }
    }
    
    // æ£€æŸ¥æ˜¯å¦é•¿æ—¶é—´æœªæ´»è·ƒ
    isAway() {
        const now = new Date();
        const diff = now - this.lastActiveTime;
        return diff > 5 * 60 * 1000; // 5åˆ†é’Ÿæœªæ´»è·ƒç®—ä½œç¦»å¼€
    }
}
```

### 11.3 ç”¨æˆ·åˆ—è¡¨å®æ—¶æ›´æ–°


**å‰ç«¯ç”¨æˆ·åˆ—è¡¨ç®¡ç†**ï¼š
```javascript
// åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ç®¡ç†
class OnlineUserList {
    constructor() {
        this.users = [];
        this.userListElement = document.getElementById('userList');
        this.userCountElement = document.getElementById('userCount');
    }
    
    // æ›´æ–°ç”¨æˆ·åˆ—è¡¨
    updateUserList(users) {
        this.users = users;
        this.renderUserList();
        this.updateUserCount();
    }
    
    // æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨
    renderUserList() {
        this.userListElement.innerHTML = '';
        
        this.users.forEach(user => {
            const userItem = this.createUserItem(user);
            this.userListElement.appendChild(userItem);
        });
    }
    
    // åˆ›å»ºç”¨æˆ·é¡¹
    createUserItem(user) {
        const li = document.createElement('li');
        li.className = `user-item ${user.status}`;
        li.setAttribute('data-user', user.name);
        
        const statusIcon = this.getStatusIcon(user.status);
        const roleIcon = this.getRoleIcon(user.role);
        
        li.innerHTML = `
            <span class="status-icon">${statusIcon}</span>
            <span class="user-name">${user.name}</span>
            <span class="role-icon">${roleIcon}</span>
        `;
        
        // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ˆç§èŠï¼‰
        li.onclick = () => this.startPrivateChat(user.name);
        
        return li;
    }
    
    // è·å–çŠ¶æ€å›¾æ ‡
    getStatusIcon(status) {
        const icons = {
            'online': 'ğŸŸ¢',
            'away': 'ğŸŸ¡',
            'busy': 'ğŸ”´',
            'offline': 'âš«'
        };
        return icons[status] || 'âš«';
    }
    
    // è·å–è§’è‰²å›¾æ ‡
    getRoleIcon(role) {
        const icons = {
            'admin': 'ğŸ‘‘',
            'moderator': 'ğŸ›¡ï¸',
            'user': ''
        };
        return icons[role] || '';
    }
    
    // æ›´æ–°åœ¨çº¿äººæ•°
    updateUserCount() {
        const onlineUsers = this.users.filter(user => user.status === 'online');
        this.userCountElement.textContent = onlineUsers.length;
    }
    
    // å¼€å§‹ç§èŠ
    startPrivateChat(userName) {
        if (userName === currentUser) return;
        
        // åˆ‡æ¢åˆ°ç§èŠç•Œé¢
        showPrivateChatWindow(userName);
    }
}
```

### 11.4 ç”¨æˆ·ä¸Šçº¿/ç¦»çº¿æç¤º


**ç³»ç»Ÿæ¶ˆæ¯æç¤º**ï¼š
```javascript
// ç”¨æˆ·çŠ¶æ€å˜åŒ–å¤„ç†
class UserStatusHandler {
    // å¤„ç†ç”¨æˆ·åŠ å…¥
    static handleUserJoin(userName, room) {
        // æ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯
        const joinMessage = {
            type: 'system',
            content: `${userName} åŠ å…¥äº†èŠå¤©å®¤`,
            timestamp: new Date().toLocaleString(),
            extra: {
                action: 'user_join',
                user: userName
            }
        };
        
        this.displaySystemMessage(joinMessage);
        
        // æ’­æ”¾æç¤ºéŸ³
        this.playNotificationSound();
        
        // æ˜¾ç¤ºä¸´æ—¶æç¤º
        this.showTemporaryNotification(`${userName} ä¸Šçº¿äº†`, 'success');
    }
    
    // å¤„ç†ç”¨æˆ·ç¦»å¼€
    static handleUserLeave(userName, room) {
        const leaveMessage = {
            type: 'system',
            content: `${userName} ç¦»å¼€äº†èŠå¤©å®¤`,
            timestamp: new Date().toLocaleString(),
            extra: {
                action: 'user_leave',
                user: userName
            }
        };
        
        this.displaySystemMessage(leaveMessage);
        this.showTemporaryNotification(`${userName} ä¸‹çº¿äº†`, 'info');
    }
    
    // æ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯
    static displaySystemMessage(message) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message system-message';
        messageDiv.innerHTML = `
            <div class="system-content">
                <span class="system-icon">â„¹ï¸</span>
                <span class="system-text">${message.content}</span>
                <span class="system-time">${message.timestamp}</span>
            </div>
        `;
        
        document.getElementById('messageArea').appendChild(messageDiv);
        this.scrollToBottom();
    }
    
    // æ˜¾ç¤ºä¸´æ—¶é€šçŸ¥
    static showTemporaryNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
    
    // æ’­æ”¾æç¤ºéŸ³
    static playNotificationSound() {
        const audio = new Audio('/sounds/notification.mp3');
        audio.volume = 0.3;
        audio.play().catch(() => {
            // å¿½ç•¥æ’­æ”¾å¤±è´¥
        });
    }
}
```

### 11.5 å®šæœŸæ›´æ–°ç”¨æˆ·çŠ¶æ€


**åç«¯çŠ¶æ€æ£€æŸ¥**ï¼š
```javascript
// å®šæœŸæ£€æŸ¥ç”¨æˆ·çŠ¶æ€
class UserStatusMonitor {
    constructor(roomManager) {
        this.roomManager = roomManager;
        this.checkInterval = 30000; // 30ç§’æ£€æŸ¥ä¸€æ¬¡
        this.startMonitoring();
    }
    
    startMonitoring() {
        setInterval(() => {
            this.checkUserStatus();
        }, this.checkInterval);
    }
    
    // æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
    checkUserStatus() {
        const now = new Date();
        
        this.roomManager.users.forEach((user, ws) => {
            // æ£€æŸ¥è¿æ¥æ˜¯å¦æ­£å¸¸
            if (ws.readyState !== WebSocket.OPEN) {
                this.handleUserDisconnect(ws);
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦é•¿æ—¶é—´æœªæ´»è·ƒ
            if (user.isAway() && user.status === USER_STATUS.ONLINE) {
                user.status = USER_STATUS.AWAY;
                this.broadcastUserStatusChange(user);
            }
        });
    }
    
    // å¹¿æ’­ç”¨æˆ·çŠ¶æ€å˜åŒ–
    broadcastUserStatusChange(user) {
        if (user.room) {
            this.roomManager.broadcastToRoom(user.room, {
                type: 'user_status_change',
                user: user.name,
                status: user.status,
                timestamp: new Date().toLocaleString()
            });
        }
    }
    
    // å¤„ç†ç”¨æˆ·æ–­å¼€è¿æ¥
    handleUserDisconnect(ws) {
        const user = this.roomManager.users.get(ws);
        if (user) {
            this.roomManager.leaveRoom(ws);
        }
    }
}
```

---

## 12. âš¡ ç”¨æˆ·ä½“éªŒä¼˜åŒ–åŠŸèƒ½


### 12.1 è¾“å…¥é˜²æŠ–åŠŸèƒ½


> **è¾“å…¥é˜²æŠ–å°±åƒç”µæ¢¯ç­‰äºº**ï¼šä¸ä¼šæ¯æŒ‰ä¸€æ¬¡æŒ‰é’®å°±å¼€é—¨ï¼Œè€Œæ˜¯ç­‰ä¸€æ®µæ—¶é—´æ²¡äººæŒ‰äº†å†å¼€é—¨

```
ä¸ºä»€ä¹ˆéœ€è¦é˜²æŠ–ï¼š
- ç”¨æˆ·å¿«é€Ÿè¾“å…¥æ—¶ï¼Œä¸è¦é¢‘ç¹å‘é€è¯·æ±‚
- èŠ‚çœç½‘ç»œèµ„æºå’ŒæœåŠ¡å™¨å‹åŠ›  
- æä¾›æ›´æµç•…çš„ç”¨æˆ·ä½“éªŒ
```

**è¾“å…¥é˜²æŠ–å®ç°**ï¼š
```javascript
// é˜²æŠ–å·¥å…·å‡½æ•°
function debounce(func, delay) {
    let timeoutId;
    return function(...args) {
        // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
        clearTimeout(timeoutId);
        
        // è®¾ç½®æ–°çš„å®šæ—¶å™¨
        timeoutId = setTimeout(() => {
            func.apply(this, args);
        }, delay);
    };
}

// è¾“å…¥çŠ¶æ€æç¤ºé˜²æŠ–
class TypingIndicator {
    constructor(websocket) {
        this.ws = websocket;
        this.isTyping = false;
        
        // åˆ›å»ºé˜²æŠ–å‡½æ•°
        this.debouncedStopTyping = debounce(() => {
            this.stopTyping();
        }, 2000); // 2ç§’ååœæ­¢è¾“å…¥çŠ¶æ€
    }
    
    // å¼€å§‹è¾“å…¥
    startTyping() {
        if (!this.isTyping) {
            this.isTyping = true;
            this.sendTypingStatus(true);
        }
        
        // é‡ç½®åœæ­¢è¾“å…¥çš„å®šæ—¶å™¨
        this.debouncedStopTyping();
    }
    
    // åœæ­¢è¾“å…¥
    stopTyping() {
        if (this.isTyping) {
            this.isTyping = false;
            this.sendTypingStatus(false);
        }
    }
    
    // å‘é€è¾“å…¥çŠ¶æ€
    sendTypingStatus(typing) {
        this.ws.send(JSON.stringify({
            type: 'typing_status',
            user: currentUser,
            typing: typing
        }));
    }
}

// ä½¿ç”¨è¾“å…¥é˜²æŠ–
const typingIndicator = new TypingIndicator(websocket);
const messageInput = document.getElementById('messageInput');

messageInput.addEventListener('input', () => {
    typingIndicator.startTyping();
});

messageInput.addEventListener('blur', () => {
    typingIndicator.stopTyping();
});
```

### 12.2 è‡ªåŠ¨æ»šåŠ¨ä¼˜åŒ–


**æ™ºèƒ½æ»šåŠ¨åŠŸèƒ½**ï¼š
```javascript
// æ™ºèƒ½æ»šåŠ¨ç®¡ç†å™¨
class SmartScroller {
    constructor(container) {
        this.container = container;
        this.isUserScrolling = false;
        this.scrollThreshold = 100; // è·ç¦»åº•éƒ¨100pxå†…è®¤ä¸ºåœ¨åº•éƒ¨
        
        this.setupScrollListener();
    }
    
    // è®¾ç½®æ»šåŠ¨ç›‘å¬
    setupScrollListener() {
        this.container.addEventListener('scroll', () => {
            this.updateScrollState();
        });
    }
    
    // æ›´æ–°æ»šåŠ¨çŠ¶æ€
    updateScrollState() {
        const { scrollTop, scrollHeight, clientHeight } = this.container;
        const distanceFromBottom = scrollHeight - scrollTop - clientHeight;
        
        // åˆ¤æ–­ç”¨æˆ·æ˜¯å¦åœ¨æŸ¥çœ‹å†å²æ¶ˆæ¯
        this.isUserScrolling = distanceFromBottom > this.scrollThreshold;
    }
    
    // æ·»åŠ æ–°æ¶ˆæ¯æ—¶çš„æ»šåŠ¨å¤„ç†
    onNewMessage() {
        if (!this.isUserScrolling) {
            // ç”¨æˆ·åœ¨åº•éƒ¨ï¼Œè‡ªåŠ¨æ»šåŠ¨
            this.scrollToBottom();
        } else {
            // ç”¨æˆ·åœ¨æŸ¥çœ‹å†å²æ¶ˆæ¯ï¼Œæ˜¾ç¤ºæ–°æ¶ˆæ¯æç¤º
            this.showNewMessageIndicator();
        }
    }
    
    // æ»šåŠ¨åˆ°åº•éƒ¨
    scrollToBottom(smooth = true) {
        this.container.scrollTo({
            top: this.container.scrollHeight,
            behavior: smooth ? 'smooth' : 'instant'
        });
    }
    
    // æ˜¾ç¤ºæ–°æ¶ˆæ¯æŒ‡ç¤ºå™¨
    showNewMessageIndicator() {
        let indicator = document.getElementById('newMessageIndicator');
        
        if (!indicator) {
            indicator = document.createElement('div');
            indicator.id = 'newMessageIndicator';
            indicator.className = 'new-message-indicator';
            indicator.innerHTML = `
                <span>æœ‰æ–°æ¶ˆæ¯</span>
                <button onclick="scrollToBottom()">ğŸ‘‡</button>
            `;
            this.container.parentElement.appendChild(indicator);
        }
        
        indicator.style.display = 'flex';
    }
    
    // éšè—æ–°æ¶ˆæ¯æŒ‡ç¤ºå™¨
    hideNewMessageIndicator() {
        const indicator = document.getElementById('newMessageIndicator');
        if (indicator) {
            indicator.style.display = 'none';
        }
    }
}

// å…¨å±€æ»šåŠ¨åˆ°åº•éƒ¨å‡½æ•°
function scrollToBottom() {
    smartScroller.scrollToBottom();
    smartScroller.hideNewMessageIndicator();
}
```

### 12.3 æ–­çº¿é‡è¿æœºåˆ¶


**è‡ªåŠ¨é‡è¿åŠŸèƒ½**ï¼š
```javascript
// æ–­çº¿é‡è¿ç®¡ç†å™¨
class ConnectionManager {
    constructor(url) {
        this.url = url;
        this.ws = null;
        this.reconnectAttempts = 0;
        this.maxReconnectAttempts = 5;
        this.reconnectDelay = 1000; // åˆå§‹é‡è¿å»¶è¿Ÿ1ç§’
        this.isReconnecting = false;
        
        this.connect();
    }
    
    // å»ºç«‹è¿æ¥
    connect() {
        try {
            this.ws = new WebSocket(this.url);
            this.setupEventHandlers();
        } catch (error) {
            console.error('WebSocketè¿æ¥å¤±è´¥:', error);
            this.handleReconnect();
        }
    }
    
    // è®¾ç½®äº‹ä»¶å¤„ç†
    setupEventHandlers() {
        this.ws.onopen = () => {
            console.log('WebSocketè¿æ¥æˆåŠŸ');
            this.onConnected();
        };
        
        this.ws.onmessage = (event) => {
            this.onMessage(event);
        };
        
        this.ws.onclose = (event) => {
            console.log('WebSocketè¿æ¥å…³é—­:', event);
            this.onDisconnected();
        };
        
        this.ws.onerror = (error) => {
            console.error('WebSocketé”™è¯¯:', error);
        };
    }
    
    // è¿æ¥æˆåŠŸå¤„ç†
    onConnected() {
        this.reconnectAttempts = 0;
        this.isReconnecting = false;
        
        // éšè—é‡è¿æç¤º
        this.hideReconnectIndicator();
        
        // é‡æ–°åŠ å…¥æˆ¿é—´
        this.rejoinRoom();
        
        // æ˜¾ç¤ºè¿æ¥æˆåŠŸæç¤º
        this.showConnectionStatus('å·²è¿æ¥', 'success');
    }
    
    // è¿æ¥æ–­å¼€å¤„ç†
    onDisconnected() {
        this.showConnectionStatus('è¿æ¥å·²æ–­å¼€', 'error');
        this.handleReconnect();
    }
    
    // å¤„ç†é‡è¿
    handleReconnect() {
        if (this.reconnectAttempts >= this.maxReconnectAttempts) {
            this.showConnectionStatus('è¿æ¥å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢', 'error');
            return;
        }
        
        if (this.isReconnecting) return;
        
        this.isReconnecting = true;
        this.reconnectAttempts++;
        
        const delay = this.reconnectDelay * Math.pow(2, this.reconnectAttempts - 1);
        
        this.showReconnectIndicator(delay);
        
        setTimeout(() => {
            console.log(`å°è¯•é‡è¿ (${this.reconnectAttempts}/${this.maxReconnectAttempts})`);
            this.connect();
        }, delay);
    }
    
    // æ˜¾ç¤ºé‡è¿æŒ‡ç¤ºå™¨
    showReconnectIndicator(delay) {
        let indicator = document.getElementById('reconnectIndicator');
        
        if (!indicator) {
            indicator = document.createElement('div');
            indicator.id = 'reconnectIndicator';
            indicator.className = 'reconnect-indicator';
            document.body.appendChild(indicator);
        }
        
        let countdown = Math.ceil(delay / 1000);
        indicator.innerHTML = `
            <div class="reconnect-content">
                <span>è¿æ¥æ–­å¼€ï¼Œ${countdown}ç§’åé‡è¿...</span>
                <div class="loading-spinner"></div>
            </div>
        `;
        
        const countdownTimer = setInterval(() => {
            countdown--;
            if (countdown > 0) {
                indicator.querySelector('span').textContent = 
                    `è¿æ¥æ–­å¼€ï¼Œ${countdown}ç§’åé‡è¿...`;
            } else {
                clearInterval(countdownTimer);
            }
        }, 1000);
    }
    
    // éšè—é‡è¿æŒ‡ç¤ºå™¨
    hideReconnectIndicator() {
        const indicator = document.getElementById('reconnectIndicator');
        if (indicator) {
            indicator.remove();
        }
    }
    
    // æ˜¾ç¤ºè¿æ¥çŠ¶æ€
    showConnectionStatus(message, type) {
        const statusDiv = document.getElementById('connectionStatus') || 
            this.createConnectionStatusDiv();
        
        statusDiv.className = `connection-status ${type}`;
        statusDiv.textContent = message;
        statusDiv.style.display = 'block';
        
        // æˆåŠŸæ¶ˆæ¯3ç§’åè‡ªåŠ¨éšè—
        if (type === 'success') {
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }
    }
    
    // åˆ›å»ºè¿æ¥çŠ¶æ€æ˜¾ç¤ºå…ƒç´ 
    createConnectionStatusDiv() {
        const statusDiv = document.createElement('div');
        statusDiv.id = 'connectionStatus';
        statusDiv.className = 'connection-status';
        document.body.appendChild(statusDiv);
        return statusDiv;
    }
    
    // é‡æ–°åŠ å…¥æˆ¿é—´
    rejoinRoom() {
        if (currentUser && currentRoom) {
            this.send({
                type: 'join_room',
                user: currentUser,
                room: currentRoom
            });
        }
    }
    
    // å‘é€æ¶ˆæ¯
    send(message) {
        if (this.ws && this.ws.readyState === WebSocket.OPEN) {
            this.ws.send(JSON.stringify(message));
            return true;
        } else {
            console.warn('WebSocketæœªè¿æ¥ï¼Œæ¶ˆæ¯å‘é€å¤±è´¥');
            return false;
        }
    }
    
    // å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯
    onMessage(event) {
        try {
            const message = JSON.parse(event.data);
            messageReceiver.processMessage(event.data);
        } catch (error) {
            console.error('æ¶ˆæ¯å¤„ç†é”™è¯¯:', error);
        }
    }
    
    // æ‰‹åŠ¨æ–­å¼€è¿æ¥
    disconnect() {
        if (this.ws) {
            this.ws.close();
        }
    }
}
```

### 12.4 æ¶ˆæ¯å‘é€çŠ¶æ€åé¦ˆ


**æ¶ˆæ¯çŠ¶æ€ç®¡ç†**ï¼š
```javascript
// æ¶ˆæ¯çŠ¶æ€ç®¡ç†å™¨
class MessageStatusManager {
    constructor() {
        this.pendingMessages = new Map(); // å¾…ç¡®è®¤çš„æ¶ˆæ¯
        this.messageTimeout = 10000; // 10ç§’è¶…æ—¶
    }
    
    // å‘é€æ¶ˆæ¯å¹¶è·Ÿè¸ªçŠ¶æ€
    sendMessageWithStatus(message) {
        // ç”Ÿæˆæ¶ˆæ¯ID
        message.id = this.generateMessageId();
        
        // æ·»åŠ åˆ°å¾…ç¡®è®¤åˆ—è¡¨
        this.pendingMessages.set(message.id, {
            message: message,
            timestamp: Date.now(),
            element: null
        });
        
        // åœ¨ç•Œé¢æ˜¾ç¤ºå‘é€ä¸­çŠ¶æ€
        const messageElement = this.displayPendingMessage(message);
        this.pendingMessages.get(message.id).element = messageElement;
        
        // å‘é€æ¶ˆæ¯
        const sent = connectionManager.send(message);
        
        if (!sent) {
            // å‘é€å¤±è´¥ï¼Œç«‹å³æ ‡è®°ä¸ºå¤±è´¥
            this.markMessageFailed(message.id, 'ç½‘ç»œè¿æ¥å¤±è´¥');
            return;
        }
        
        // è®¾ç½®è¶…æ—¶å¤„ç†
        setTimeout(() => {
            if (this.pendingMessages.has(message.id)) {
                this.markMessageFailed(message.id, 'å‘é€è¶…æ—¶');
            }
        }, this.messageTimeout);
    }
    
    // æ˜¾ç¤ºå¾…å‘é€æ¶ˆæ¯
    displayPendingMessage(message) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message sent pending';
        messageDiv.setAttribute('data-id', message.id);
        
        messageDiv.innerHTML = `
            <div class="message-content">
                <span class="user">${message.from}</span>
                <span class="content">${message.content}</span>
                <span class="status sending">ğŸ“¤ å‘é€ä¸­...</span>
            </div>
        `;
        
        document.getElementById('messageArea').appendChild(messageDiv);
        smartScroller.onNewMessage();
        
        return messageDiv;
    }
    
    // ç¡®è®¤æ¶ˆæ¯å‘é€æˆåŠŸ
    confirmMessageSent(messageId) {
        const pending = this.pendingMessages.get(messageId);
        if (pending) {
            // æ›´æ–°çŠ¶æ€ä¸ºå·²å‘é€
            const statusSpan = pending.element.querySelector('.status');
            statusSpan.textContent = 'âœ“ å·²å‘é€';
            statusSpan.className = 'status sent';
            
            // 2ç§’åç§»é™¤çŠ¶æ€æ˜¾ç¤º
            setTimeout(() => {
                statusSpan.style.display = 'none';
            }, 2000);
            
            this.pendingMessages.delete(messageId);
        }
    }
    
    // æ ‡è®°æ¶ˆæ¯å‘é€å¤±è´¥
    markMessageFailed(messageId, reason) {
        const pending = this.pendingMessages.get(messageId);
        if (pending) {
            const statusSpan = pending.element.querySelector('.status');
            statusSpan.innerHTML = `âŒ å‘é€å¤±è´¥ <button onclick="resendMessage('${messageId}')">é‡å‘</button>`;
            statusSpan.className = 'status failed';
            
            this.pendingMessages.delete(messageId);
        }
    }
    
    // é‡å‘æ¶ˆæ¯
    resendMessage(messageId) {
        // ä»å¤±è´¥å…ƒç´ ä¸­è·å–æ¶ˆæ¯å†…å®¹
        const messageElement = document.querySelector(`[data-id="${messageId}"]`);
        if (messageElement) {
            const content = messageElement.querySelector('.content').textContent;
            
            // é‡æ–°å‘é€
            messageSender.sendTextMessage(content, currentRoom);
            
            // ç§»é™¤å¤±è´¥çš„æ¶ˆæ¯å…ƒç´ 
            messageElement.remove();
        }
    }
    
    // ç”Ÿæˆæ¶ˆæ¯ID
    generateMessageId() {
        return Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
}
```

### 12.5 ç”¨æˆ·ä½“éªŒç»†èŠ‚ä¼˜åŒ–


**è¾“å…¥æ¡†å¢å¼ºåŠŸèƒ½**ï¼š
```javascript
// è¾“å…¥æ¡†å¢å¼ºç®¡ç†å™¨
class InputEnhancer {
    constructor(inputElement) {
        this.input = inputElement;
        this.setupEnhancements();
    }
    
    setupEnhancements() {
        // å›è½¦å‘é€ï¼ŒShift+å›è½¦æ¢è¡Œ
        this.input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.handleSendMessage();
            }
        });
        
        // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
        this.input.addEventListener('input', () => {
            this.autoResize();
        });
        
        // ç²˜è´´å›¾ç‰‡å¤„ç†
        this.input.addEventListener('paste', (e) => {
            this.handlePaste(e);
        });
        
        // è¡¨æƒ…å¿«æ·é”® :) :( :D ç­‰
        this.input.addEventListener('input', () => {
            this.replaceEmoticonShortcuts();
        });
    }
    
    // å‘é€æ¶ˆæ¯
    handleSendMessage() {
        const content = this.input.value.trim();
        if (content) {
            messageStatusManager.sendMessageWithStatus({
                type: 'text',
                from: currentUser,
                room: currentRoom,
                content: content
            });
            
            this.input.value = '';
            this.autoResize();
        }
    }
    
    // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
    autoResize() {
        this.input.style.height = 'auto';
        const maxHeight = 120; // æœ€å¤§é«˜åº¦120px
        const newHeight = Math.min(this.input.scrollHeight, maxHeight);
        this.input.style.height = newHeight + 'px';
    }
    
    // å¤„ç†ç²˜è´´äº‹ä»¶
    handlePaste(e) {
        const items = e.clipboardData.items;
        
        for (let item of items) {
            if (item.type.indexOf('image') !== -1) {
                e.preventDefault();
                const file = item.getAsFile();
                this.handleImagePaste(file);
                break;
            }
        }
    }
    
    // å¤„ç†ç²˜è´´çš„å›¾ç‰‡
    handleImagePaste(file) {
        if (file.size > 2 * 1024 * 1024) {
            alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡2MB');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
            const base64 = e.target.result.split(',')[1];
            
            messageStatusManager.sendMessageWithStatus({
                type: 'image',
                from: currentUser,
                room: currentRoom,
                content: base64,
                extra: {
                    fileName: file.name || 'pasted-image.png',
                    fileSize: file.size
                }
            });
        };
        reader.readAsDataURL(file);
    }
    
    // æ›¿æ¢è¡¨æƒ…å¿«æ·é”®
    replaceEmoticonShortcuts() {
        const shortcuts = {
            ':)': 'ğŸ˜Š',
            ':(': 'ğŸ˜¢',
            ':D': 'ğŸ˜„',
            ':P': 'ğŸ˜›',
            ';)': 'ğŸ˜‰',
            ':|': 'ğŸ˜',
            ':o': 'ğŸ˜®',
            '<3': 'â¤ï¸'
        };
        
        let value = this.input.value;
        let replaced = false;
        
        for (let shortcut in shortcuts) {
            const emoji = shortcuts[shortcut];
            if (value.includes(shortcut)) {
                value = value.replace(new RegExp(shortcut.replace(/[.*+?^${}()|[\]\\]/g, '\\    // æ˜¾ç¤ºé‡è¿æŒ‡ç¤ºå™¨
    showReconnectIndicator(delay) {
        let indicator = document.getElementById('reconnectIndicator');
        
        if (!indicator) {
            indicator = document.createElement('div');
            indicator.id = 'reconnectIndicator';
            indicator.className = 'reconnect-indicator';
            document.body.appendChild(indicator);
        }
        
        let countdown = Math.ceil(delay / 1000);
        indicator.innerHTML = `
            <div class="reconnect-content">
                <span>è¿æ¥æ–­å¼€ï¼Œ${countdown}ç§’åé‡è¿...</span>
                <div class="loading-spinner"></div>
            </div>
        `;
        
        const countdownTimer = setInterval(() => {
            countdown--;
            if (countdown > 0) {
                indicator.querySelector('span').textContent = 
                    `è¿æ¥æ–­å¼€ï¼Œ${countdown}ç§’åé‡è¿...`;
            } else {
                clearInterval(countdownTimer);
            }
        }, 1000);
    }'), 'g'), emoji);
                replaced = true;
            }
        }
        
        if (replaced) {
            const cursorPos = this.input.selectionStart;
            this.input.value = value;
            this.input.setSelectionRange(cursorPos, cursorPos);
        }
    }
}
```

---

## 13. ğŸš€ é¡¹ç›®éƒ¨ç½²ä¸ä¸Šçº¿


### 13.1 éƒ¨ç½²å‡†å¤‡å·¥ä½œ


> **é¡¹ç›®éƒ¨ç½²å°±åƒæ¬å®¶**ï¼šè¦æŠŠæ‰€æœ‰ä¸œè¥¿ä»å¼€å‘ç¯å¢ƒæ¬åˆ°æ­£å¼ç¯å¢ƒï¼Œç¡®ä¿ä¸€åˆ‡æ­£å¸¸è¿è¡Œ

```
éƒ¨ç½²å‡†å¤‡æ¸…å•ï¼š
ğŸ“‹ ä»£ç æ•´ç†å’Œä¼˜åŒ–
ğŸ”§ ç¯å¢ƒé…ç½®æ–‡ä»¶
ğŸ›¡ï¸ å®‰å…¨è®¾ç½®æ£€æŸ¥
ğŸ“Š æ€§èƒ½ä¼˜åŒ–
ğŸ§ª åŠŸèƒ½æµ‹è¯•
```

### 13.2 å‰ç«¯é¡¹ç›®æ„å»º


**é¡¹ç›®æ–‡ä»¶ç»“æ„**ï¼š
```
chat-frontend/
â”œâ”€â”€ index.html              # ä¸»é¡µé¢
â”œâ”€â”€ css/
â”‚   â”œâ”€â”€ style.css          # æ ·å¼æ–‡ä»¶
â”‚   â””â”€â”€ responsive.css     # å“åº”å¼æ ·å¼
â”œâ”€â”€ js/
â”‚   â”œâ”€â”€ main.js           # ä¸»è¦é€»è¾‘
â”‚   â”œâ”€â”€ websocket.js      # WebSocketå¤„ç†
â”‚   â”œâ”€â”€ ui.js             # ç•Œé¢ç®¡ç†
â”‚   â””â”€â”€ utils.js          # å·¥å…·å‡½æ•°
â”œâ”€â”€ images/
â”‚   â”œâ”€â”€ favicon.ico       # ç½‘ç«™å›¾æ ‡
â”‚   â””â”€â”€ emoji/            # è¡¨æƒ…åŒ…
â”œâ”€â”€ sounds/
â”‚   â””â”€â”€ notification.mp3  # æç¤ºéŸ³
â””â”€â”€ config/
    â””â”€â”€ config.js         # é…ç½®æ–‡ä»¶
```

**ç”Ÿäº§ç¯å¢ƒé…ç½®**ï¼š
```javascript
// config/config.prod.js
const CONFIG = {
    // WebSocketæœåŠ¡å™¨åœ°å€ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
    WEBSOCKET_URL: 'wss://your-domain.com:443/ws',
    
    // APIåŸºç¡€åœ°å€
    API_BASE_URL: 'https://your-domain.com/api',
    
    // åŠŸèƒ½å¼€å…³
    FEATURES: {
        fileUpload: true,
        voiceMessage: false,
        videoCall: false
    },
    
    // é™åˆ¶è®¾ç½®
    LIMITS: {
        messageLength: 1000,
        fileSize: 2 * 1024 * 1024, // 2MB
        reconnectAttempts: 5
    },
    
    // è°ƒè¯•æ¨¡å¼
    DEBUG: false
};
```

### 13.3 åç«¯æœåŠ¡å™¨éƒ¨ç½²


**Node.jsæœåŠ¡å™¨ä»£ç ä¼˜åŒ–**ï¼š
```javascript
// server.js - ç”Ÿäº§ç¯å¢ƒç‰ˆæœ¬
const WebSocket = require('ws');
const https = require('https');
const fs = require('fs');
const express = require('express');

// åˆ›å»ºExpressåº”ç”¨
const app = express();

// é™æ€æ–‡ä»¶æœåŠ¡
app.use(express.static('public'));

// å¥åº·æ£€æŸ¥æ¥å£
app.get('/health', (req, res) => {
    res.json({ status: 'ok', timestamp: new Date().toISOString() });
});

// HTTPSæœåŠ¡å™¨é…ç½®
const server = https.createServer({
    cert: fs.readFileSync('path/to/cert.pem'),
    key: fs.readFileSync('path/to/key.pem')
}, app);

// WebSocketæœåŠ¡å™¨
const wss = new WebSocket.Server({ 
    server,
    path: '/ws'
});

// ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–
const PRODUCTION_CONFIG = {
    maxConnections: 1000,        // æœ€å¤§è¿æ¥æ•°
    heartbeatInterval: 30000,    // å¿ƒè·³é—´éš”
    messageRateLimit: 10,        // æ¯ç§’æœ€å¤§æ¶ˆæ¯æ•°
    roomMaxUsers: 100            // æˆ¿é—´æœ€å¤§ç”¨æˆ·æ•°
};

// è¿æ¥ç®¡ç†
const connectionManager = new ConnectionManager(PRODUCTION_CONFIG);

// å¯åŠ¨æœåŠ¡å™¨
const PORT = process.env.PORT || 443;
server.listen(PORT, () => {
    console.log(`WebSocketæœåŠ¡å™¨å¯åŠ¨æˆåŠŸï¼Œç«¯å£: ${PORT}`);
});

// ä¼˜é›…å…³é—­
process.on('SIGTERM', () => {
    console.log('æ”¶åˆ°SIGTERMä¿¡å·ï¼Œæ­£åœ¨å…³é—­æœåŠ¡å™¨...');
    server.close(() => {
        console.log('æœåŠ¡å™¨å·²å…³é—­');
        process.exit(0);
    });
});
```

### 13.4 SSLè¯ä¹¦é…ç½®


**HTTPSå’ŒWSSé…ç½®**ï¼š
```bash
# ä½¿ç”¨Let's Encryptå…è´¹SSLè¯ä¹¦
# 1. å®‰è£…Certbot
sudo apt update
sudo apt install certbot

# 2. è·å–SSLè¯ä¹¦
sudo certbot certonly --standalone -d your-domain.com

# 3. è¯ä¹¦æ–‡ä»¶ä½ç½®
# è¯ä¹¦: /etc/letsencrypt/live/your-domain.com/fullchain.pem  
# ç§é’¥: /etc/letsencrypt/live/your-domain.com/privkey.pem

# 4. è‡ªåŠ¨ç»­æœŸè®¾ç½®
sudo crontab -e
# æ·»åŠ : 0 12 * * * /usr/bin/certbot renew --quiet
```

### 13.5 Nginxåå‘ä»£ç†é…ç½®


**Nginxé…ç½®æ–‡ä»¶**ï¼š
```nginx
# /etc/nginx/sites-available/chatroom
server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;

    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
    
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;

    # é™æ€æ–‡ä»¶
    location / {
        root /var/www/chatroom;
        index index.html;
        try_files $uri $uri/ =404;
    }

    # WebSocketä»£ç†
    location /ws {
        proxy_pass http://localhost:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocketè¶…æ—¶è®¾ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # APIæ¥å£ä»£ç†
    location /api {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 13.6 è¿›ç¨‹ç®¡ç†å’Œç›‘æ§


**ä½¿ç”¨PM2ç®¡ç†Node.jsè¿›ç¨‹**ï¼š
```bash
# å®‰è£…PM2
npm install -g pm2

# PM2é…ç½®æ–‡ä»¶ ecosystem.config.js
module.exports = {
  apps: [{
    name: 'chatroom-server',
    script: './server.js',
    instances: 'max',
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 8080
    },
    error_file: './logs/err.log',
    out_file: './logs/out.log',
    log_file: './logs/combined.log',
    time: true
  }]
};

# å¯åŠ¨åº”ç”¨
pm2 start ecosystem.config.js

# æŸ¥çœ‹çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs

# é‡å¯åº”ç”¨
pm2 restart chatroom-server

# è®¾ç½®å¼€æœºè‡ªå¯åŠ¨
pm2 startup
pm2 save
```

### 13.7 æ€§èƒ½ç›‘æ§å’Œæ—¥å¿—


**æœåŠ¡å™¨ç›‘æ§è„šæœ¬**ï¼š
```javascript
// monitor.js - æ€§èƒ½ç›‘æ§
const fs = require('fs');

class ServerMonitor {
    constructor() {
        this.startTime = Date.now();
        this.stats = {
            totalConnections: 0,
            currentConnections: 0,
            totalMessages: 0,
            totalDataTransfer: 0
        };
        
        this.startMonitoring();
    }
    
    // å¼€å§‹ç›‘æ§
    startMonitoring() {
        setInterval(() => {
            this.logStatus();
        }, 60000); // æ¯åˆ†é’Ÿè®°å½•ä¸€æ¬¡
    }
    
    // è®°å½•çŠ¶æ€
    logStatus() {
        const uptime = Date.now() - this.startTime;
        const memUsage = process.memoryUsage();
        
        const status = {
            timestamp: new Date().toISOString(),
            uptime: Math.floor(uptime / 1000),
            connections: this.stats.currentConnections,
            totalMessages: this.stats.totalMessages,
            memory: {
                rss: Math.floor(memUsage.rss / 1024 / 1024) + 'MB',
                heapUsed: Math.floor(memUsage.heapUsed / 1024 / 1024) + 'MB'
            }
        };
        
        // å†™å…¥æ—¥å¿—æ–‡ä»¶
        fs.appendFileSync('logs/monitor.log', JSON.stringify(status) + '\n');
        
        console.log('æœåŠ¡å™¨çŠ¶æ€:', status);
    }
    
    // æ›´æ–°ç»Ÿè®¡
    updateStats(type, value = 1) {
        if (this.stats.hasOwnProperty(type)) {
            this.stats[type] += value;
        }
    }
}

// å¯¼å‡ºç›‘æ§å®ä¾‹
module.exports = new ServerMonitor();
```

### 13.8 éƒ¨ç½²æ£€æŸ¥æ¸…å•


**ä¸Šçº¿å‰æ£€æŸ¥**ï¼š
```
ğŸ” åŠŸèƒ½æµ‹è¯•ï¼š
âœ… WebSocketè¿æ¥æ­£å¸¸
âœ… æ¶ˆæ¯å‘é€æ¥æ”¶æ­£å¸¸
âœ… æ–‡ä»¶ä¸Šä¼ ä¸‹è½½æ­£å¸¸
âœ… ç”¨æˆ·æƒé™æ§åˆ¶æ­£å¸¸
âœ… æ–­çº¿é‡è¿åŠŸèƒ½æ­£å¸¸

ğŸ›¡ï¸ å®‰å…¨æ£€æŸ¥ï¼š
âœ… HTTPS/WSSåè®®å¯ç”¨
âœ… è¾“å…¥å†…å®¹è¿‡æ»¤
âœ… æ–‡ä»¶ç±»å‹é™åˆ¶
âœ… ä¸Šä¼ å¤§å°é™åˆ¶
âœ… é¢‘ç‡é™åˆ¶é…ç½®

âš¡ æ€§èƒ½æ£€æŸ¥ï¼š
âœ… é™æ€èµ„æºå‹ç¼©
âœ… å›¾ç‰‡ä¼˜åŒ–
âœ… ä»£ç å‹ç¼©æ··æ·†
âœ… ç¼“å­˜ç­–ç•¥é…ç½®
âœ… CDNé…ç½®ï¼ˆå¯é€‰ï¼‰

ğŸ”§ é…ç½®æ£€æŸ¥ï¼š
âœ… ç”Ÿäº§ç¯å¢ƒé…ç½®
âœ… é”™è¯¯å¤„ç†æœºåˆ¶
âœ… æ—¥å¿—è®°å½•é…ç½®
âœ… ç›‘æ§å‘Šè­¦è®¾ç½®
âœ… å¤‡ä»½ç­–ç•¥åˆ¶å®š
```

---

## 14. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 14.1 é¡¹ç›®æ ¸å¿ƒåŠŸèƒ½æ¶æ„


```
ğŸ”¸ é¡µé¢ç»“æ„ï¼šèŠå¤©åŒº+è¾“å…¥æ¡†+ç”¨æˆ·åˆ—è¡¨çš„ç»å…¸ä¸‰æ å¸ƒå±€
ğŸ”¸ å¤šæˆ¿é—´ç³»ç»Ÿï¼šç‹¬ç«‹çš„èŠå¤©ç©ºé—´ï¼Œæ¶ˆæ¯éš”ç¦»ï¼Œç”¨æˆ·è‡ªç”±åˆ‡æ¢
ğŸ”¸ ç§èŠåŠŸèƒ½ï¼šç‚¹å¯¹ç‚¹é€šä¿¡ï¼Œæ¶ˆæ¯åªåœ¨ä¸¤äººé—´ä¼ é€’
ğŸ”¸ æ–‡ä»¶ä¼ è¾“ï¼šæ”¯æŒå›¾ç‰‡å’Œå°æ–‡ä»¶ï¼ŒBase64ç¼–ç ä¼ è¾“
ğŸ”¸ è¡¨æƒ…å¯Œæ–‡æœ¬ï¼šemojiè¡¨æƒ…å’Œç®€å•å¯Œæ–‡æœ¬æ ¼å¼æ”¯æŒ
ğŸ”¸ æ¶ˆæ¯å°è£…ï¼šç»Ÿä¸€çš„æ¶ˆæ¯æ ¼å¼ï¼Œä¾¿äºæ‰©å±•å’Œç»´æŠ¤
ğŸ”¸ æœç´¢å†å²ï¼šæœ¬åœ°å­˜å‚¨èŠå¤©è®°å½•ï¼Œæ”¯æŒå…³é”®è¯æœç´¢
ğŸ”¸ æƒé™ç®¡ç†ï¼šå¤šè§’è‰²æƒé™æ§åˆ¶ï¼Œç®¡ç†å‘˜æ“ä½œåŠŸèƒ½
```

### 14.2 æŠ€æœ¯å®ç°è¦ç‚¹


**ğŸ”¹ å‰ç«¯æ¶æ„è®¾è®¡**ï¼š
```
æ¨¡å—åŒ–è®¾è®¡ï¼š
- MessageSenderï¼šæ¶ˆæ¯å‘é€ç®¡ç†
- MessageReceiverï¼šæ¶ˆæ¯æ¥æ”¶å¤„ç†  
- ConnectionManagerï¼šè¿æ¥ç®¡ç†
- UserPermissionsï¼šæƒé™æ§åˆ¶
- UIç»„ä»¶ï¼šç•Œé¢æ¸²æŸ“å’Œäº¤äº’
```

**ğŸ”¹ åç«¯æ¶æ„è®¾è®¡**ï¼š
```
æœåŠ¡ç«¯æ¶æ„ï¼š
- RoomManagerï¼šæˆ¿é—´ç®¡ç†
- UserStatusMonitorï¼šç”¨æˆ·çŠ¶æ€ç›‘æ§
- MessageHandlerï¼šæ¶ˆæ¯å¤„ç†åˆ†å‘
- PermissionCheckerï¼šæƒé™éªŒè¯
- ConnectionPoolï¼šè¿æ¥æ± ç®¡ç†
```

**ğŸ”¹ æ•°æ®æµè®¾è®¡**ï¼š
```
æ¶ˆæ¯æµå‘ï¼š
ç”¨æˆ·è¾“å…¥ â†’ å‰ç«¯éªŒè¯ â†’ WebSocketå‘é€ â†’ åç«¯å¤„ç† â†’ å¹¿æ’­è½¬å‘ â†’ å‰ç«¯æ¸²æŸ“
```

### 14.3 ç”¨æˆ·ä½“éªŒä¼˜åŒ–


**âš¡ æ€§èƒ½ä¼˜åŒ–è¦ç‚¹**ï¼š
- **é˜²æŠ–å¤„ç†**ï¼šè¾“å…¥çŠ¶æ€æç¤ºï¼Œé¿å…é¢‘ç¹è¯·æ±‚
- **æ™ºèƒ½æ»šåŠ¨**ï¼šæ–°æ¶ˆæ¯è‡ªåŠ¨æ»šåŠ¨ï¼Œå†å²æŸ¥çœ‹ä¸æ‰“æ–­
- **æ–­çº¿é‡è¿**ï¼šç½‘ç»œä¸­æ–­è‡ªåŠ¨é‡è¿ï¼Œç”¨æˆ·æ— æ„ŸçŸ¥
- **çŠ¶æ€åé¦ˆ**ï¼šæ¶ˆæ¯å‘é€çŠ¶æ€å®æ—¶æ˜¾ç¤º
- **æ¶ˆæ¯é™åˆ¶**ï¼šé˜²æ­¢åˆ·å±ï¼Œé™åˆ¶æ¶ˆæ¯é¢‘ç‡å’Œé•¿åº¦

**ğŸ¨ ç•Œé¢ä½“éªŒä¼˜åŒ–**ï¼š
- **å“åº”å¼è®¾è®¡**ï¼šé€‚é…æ‰‹æœºå’Œæ¡Œé¢è®¾å¤‡
- **åŠ è½½çŠ¶æ€**ï¼šè¿æ¥ä¸­ã€é‡è¿ä¸­ç­‰çŠ¶æ€æç¤º
- **é”™è¯¯å¤„ç†**ï¼šå‹å¥½çš„é”™è¯¯æç¤ºå’Œæ“ä½œå»ºè®®
- **å¿«æ·æ“ä½œ**ï¼šå›è½¦å‘é€ã€å¿«æ·é”®æ”¯æŒ
- **è§†è§‰åé¦ˆ**ï¼šæ¶ˆæ¯åŠ¨ç”»ã€çŠ¶æ€å›¾æ ‡

### 14.4 éƒ¨ç½²è¿ç»´è¦ç‚¹


**ğŸš€ éƒ¨ç½²æ¶æ„**ï¼š
```
å…¸å‹éƒ¨ç½²æ¶æ„ï¼š
ç”¨æˆ·æµè§ˆå™¨ â†’ Nginx(åå‘ä»£ç†) â†’ Node.jsæœåŠ¡å™¨ â†’ WebSocketè¿æ¥
HTTPS/WSSåŠ å¯† â†’ SSLè¯ä¹¦é…ç½® â†’ åŸŸåè§£æ
```

**ğŸ›¡ï¸ å®‰å…¨æªæ–½**ï¼š
- **HTTPSå¼ºåˆ¶**ï¼šæ‰€æœ‰è¿æ¥ä½¿ç”¨SSLåŠ å¯†
- **è¾“å…¥éªŒè¯**ï¼šé˜²æ­¢XSSå’Œæ³¨å…¥æ”»å‡»
- **é¢‘ç‡é™åˆ¶**ï¼šé˜²æ­¢æ¶æ„åˆ·å±å’ŒDDoS
- **æ–‡ä»¶å®‰å…¨**ï¼šé™åˆ¶æ–‡ä»¶ç±»å‹å’Œå¤§å°
- **æƒé™æ§åˆ¶**ï¼šä¸¥æ ¼çš„ç”¨æˆ·æƒé™ç®¡ç†

**ğŸ“Š ç›‘æ§è¿ç»´**ï¼š
- **æ€§èƒ½ç›‘æ§**ï¼šè¿æ¥æ•°ã€æ¶ˆæ¯é‡ã€å†…å­˜ä½¿ç”¨
- **é”™è¯¯ç›‘æ§**ï¼šå¼‚å¸¸æ—¥å¿—è®°å½•å’Œå‘Šè­¦
- **ä¸šåŠ¡ç›‘æ§**ï¼šç”¨æˆ·æ´»è·ƒåº¦ã€åŠŸèƒ½ä½¿ç”¨ç»Ÿè®¡
- **è‡ªåŠ¨åŒ–**ï¼šPM2è¿›ç¨‹ç®¡ç†ã€è‡ªåŠ¨é‡å¯
- **å¤‡ä»½ç­–ç•¥**ï¼šèŠå¤©è®°å½•å®šæœŸå¤‡ä»½

### 14.5 åŠŸèƒ½æ‰©å±•æ–¹å‘


**ğŸ“ˆ è¿›é˜¶åŠŸèƒ½**ï¼š
- **è¯­éŸ³æ¶ˆæ¯**ï¼šå½•éŸ³å’Œæ’­æ”¾åŠŸèƒ½
- **è§†é¢‘é€šè¯**ï¼šWebRTCä¸€å¯¹ä¸€é€šè¯
- **å±å¹•å…±äº«**ï¼šåœ¨çº¿æ¼”ç¤ºå’Œåä½œ
- **æœºå™¨äºº**ï¼šè‡ªåŠ¨å›å¤å’Œæ™ºèƒ½åŠ©æ‰‹
- **å¤šè¯­è¨€**ï¼šå›½é™…åŒ–å’Œæœ¬åœ°åŒ–æ”¯æŒ

**ğŸ”§ æŠ€æœ¯å‡çº§**ï¼š
- **æ•°æ®åº“é›†æˆ**ï¼šæŒä¹…åŒ–å­˜å‚¨èŠå¤©è®°å½•
- **Redisç¼“å­˜**ï¼šæé«˜å¹¶å‘æ€§èƒ½
- **æ¶ˆæ¯é˜Ÿåˆ—**ï¼šå¤„ç†å¤§é‡å¹¶å‘æ¶ˆæ¯
- **å¾®æœåŠ¡æ¶æ„**ï¼šæ‹†åˆ†åŠŸèƒ½æ¨¡å—
- **å®¹å™¨åŒ–éƒ¨ç½²**ï¼šDockerå’ŒKubernetes

### 14.6 å¼€å‘æœ€ä½³å®è·µ


**ğŸ’¡ ä»£ç è´¨é‡**ï¼š
- æ¨¡å—åŒ–è®¾è®¡ï¼ŒèŒè´£åˆ†ç¦»
- ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶
- å®Œå–„çš„æ³¨é‡Šå’Œæ–‡æ¡£
- å•å…ƒæµ‹è¯•è¦†ç›–æ ¸å¿ƒåŠŸèƒ½

**ğŸ¯ é¡¹ç›®ç®¡ç†**ï¼š
- ç‰ˆæœ¬æ§åˆ¶ï¼ŒåŠŸèƒ½åˆ†æ”¯å¼€å‘
- ä»£ç å®¡æŸ¥ï¼Œä¿è¯ä»£ç è´¨é‡
- æŒç»­é›†æˆï¼Œè‡ªåŠ¨åŒ–æµ‹è¯•éƒ¨ç½²
- æ–‡æ¡£ç»´æŠ¤ï¼Œä¾¿äºå›¢é˜Ÿåä½œ

**æ ¸å¿ƒè®°å¿†**ï¼š
```
èŠå¤©å®¤é¡¹ç›®æ ¸å¿ƒï¼š
é¡µé¢å¸ƒå±€ä¸‰æ å¼ï¼Œæ¶ˆæ¯æ ¼å¼è¦ç»Ÿä¸€
æˆ¿é—´éš”ç¦»ç§èŠé€šï¼Œæƒé™ç®¡ç†åˆ†è§’è‰²
ä½“éªŒä¼˜åŒ–é‡ç»†èŠ‚ï¼Œéƒ¨ç½²å®‰å…¨ä¿ç¨³å®š
æ¨¡å—è®¾è®¡èŒè´£æ¸…ï¼Œæ‰©å±•ç»´æŠ¤éƒ½ä¸éš¾
```