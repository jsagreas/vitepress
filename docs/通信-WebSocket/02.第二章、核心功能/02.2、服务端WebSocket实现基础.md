---
title: 2ã€æœåŠ¡ç«¯WebSocketå®ç°åŸºç¡€
---
## ğŸ“š ç›®å½•

1. [æ­å»ºWebSocketæœåŠ¡å™¨ç¯å¢ƒ](#1-æ­å»ºWebSocketæœåŠ¡å™¨ç¯å¢ƒ)
2. [åˆ›å»ºåŸºç¡€WebSocketæœåŠ¡å™¨](#2-åˆ›å»ºåŸºç¡€WebSocketæœåŠ¡å™¨)
3. [æœåŠ¡ç«¯æ ¸å¿ƒäº‹ä»¶å¤„ç†](#3-æœåŠ¡ç«¯æ ¸å¿ƒäº‹ä»¶å¤„ç†)
4. [æ¶ˆæ¯å‘é€ä¸å¹¿æ’­](#4-æ¶ˆæ¯å‘é€ä¸å¹¿æ’­)
5. [è¿æ¥ç®¡ç†ä¸å¼‚å¸¸å¤„ç†](#5-è¿æ¥ç®¡ç†ä¸å¼‚å¸¸å¤„ç†)
6. [å®æˆ˜æ¡ˆä¾‹ï¼šç®€å•ç¾¤èŠåŠŸèƒ½](#6-å®æˆ˜æ¡ˆä¾‹ç®€å•ç¾¤èŠåŠŸèƒ½)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ—ï¸ æ­å»ºWebSocketæœåŠ¡å™¨ç¯å¢ƒ


### 1.1 å®‰è£…wsæ¨¡å—


**ä»€ä¹ˆæ˜¯wsæ¨¡å—ï¼Ÿ**
```
wsæ¨¡å—æ˜¯Node.jsä¸­æœ€å¸¸ç”¨çš„WebSocketåº“
å°±åƒjQueryç®€åŒ–äº†DOMæ“ä½œï¼Œwsç®€åŒ–äº†WebSocketæœåŠ¡å™¨çš„åˆ›å»º
å®ƒå¸®æˆ‘ä»¬å¤„ç†äº†å¤æ‚çš„åº•å±‚åè®®ï¼Œæˆ‘ä»¬åªéœ€è¦å…³æ³¨ä¸šåŠ¡é€»è¾‘
```

**å®‰è£…å‘½ä»¤ï¼š**
```bash
npm install ws
```

> ğŸ’¡ **æ–°æ‰‹æç¤º**ï¼šwsæ¨¡å—å°±æ˜¯ä¸€ä¸ªå·¥å…·åŒ…ï¼Œä¸“é—¨ç”¨æ¥åœ¨Node.jsä¸­åˆ›å»ºWebSocketæœåŠ¡å™¨ï¼Œå°±åƒç›–æˆ¿å­éœ€è¦å·¥å…·ç®±ä¸€æ ·

### 1.2 é¡¹ç›®åˆå§‹åŒ–


**åˆ›å»ºé¡¹ç›®ç»“æ„ï¼š**
```
websocket-demo/
â”œâ”€â”€ package.json     â† é¡¹ç›®é…ç½®æ–‡ä»¶
â”œâ”€â”€ server.js        â† WebSocketæœåŠ¡å™¨ä»£ç 
â””â”€â”€ client.html      â† æµ‹è¯•ç”¨çš„ç½‘é¡µå®¢æˆ·ç«¯
```

**package.json åŸºç¡€é…ç½®ï¼š**
```json
{
  "name": "websocket-demo",
  "version": "1.0.0",
  "main": "server.js",
  "dependencies": {
    "ws": "^8.0.0"
  }
}
```

---

## 2. ğŸš€ åˆ›å»ºåŸºç¡€WebSocketæœåŠ¡å™¨


### 2.1 WebSocket.Server æ˜¯ä»€ä¹ˆ


**é€šä¿—ç†è§£ï¼š**
```
WebSocket.Server å°±åƒä¸€ä¸ª"æ¥å¾…å‘˜"
- å®ƒåœ¨æœåŠ¡å™¨ä¸Šå¼€ä¸€ä¸ªé—¨ï¼ˆç«¯å£ï¼‰
- ç­‰ç€å®¢æˆ·ç«¯æ¥æ•²é—¨ï¼ˆè¿æ¥è¯·æ±‚ï¼‰
- å®¢æˆ·ç«¯æ¥äº†å°±å»ºç«‹è¿æ¥ï¼Œå¯ä»¥äº’ç›¸èŠå¤©ï¼ˆå‘æ¶ˆæ¯ï¼‰
```

### 2.2 æœ€ç®€å•çš„WebSocketæœåŠ¡å™¨


```javascript
// server.js - æœ€åŸºç¡€çš„WebSocketæœåŠ¡å™¨
const WebSocket = require('ws');

// åˆ›å»ºWebSocketæœåŠ¡å™¨ï¼Œç›‘å¬8080ç«¯å£
const wss = new WebSocket.Server({ port: 8080 });

console.log('WebSocketæœåŠ¡å™¨å¯åŠ¨åœ¨ç«¯å£ 8080');
console.log('ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥...');

// ç›‘å¬å®¢æˆ·ç«¯è¿æ¥
wss.on('connection', (ws) => {
    console.log('æœ‰æ–°çš„å®¢æˆ·ç«¯è¿æ¥äº†ï¼');
    
    // å‘æ–°è¿æ¥çš„å®¢æˆ·ç«¯å‘é€æ¬¢è¿æ¶ˆæ¯
    ws.send('æ¬¢è¿è¿æ¥åˆ°WebSocketæœåŠ¡å™¨ï¼');
});
```

**ä»£ç è§£é‡Šï¼š**
- `new WebSocket.Server({ port: 8080 })`ï¼šåœ¨8080ç«¯å£å¼€å¯WebSocketæœåŠ¡å™¨
- `wss.on('connection', ...)`ï¼šç›‘å¬å®¢æˆ·ç«¯è¿æ¥äº‹ä»¶ï¼Œæœ‰äººè¿æ¥å°±æ‰§è¡Œå›è°ƒå‡½æ•°
- `ws.send(...)`ï¼šå‘è¿æ¥çš„å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯

> ğŸ¤” **æ€è€ƒé¢˜**ï¼šä¸ºä»€ä¹ˆè¦æŒ‡å®šç«¯å£å·ï¼Ÿç«¯å£å·å°±åƒæˆ¿å­çš„é—¨ç‰Œå·ï¼Œå®¢æˆ·ç«¯éœ€è¦çŸ¥é“å»å“ªé‡Œæ‰¾æœåŠ¡å™¨

---

## 3. ğŸ¯ æœåŠ¡ç«¯æ ¸å¿ƒäº‹ä»¶å¤„ç†


### 3.1 å››å¤§æ ¸å¿ƒäº‹ä»¶


```
WebSocketæœåŠ¡å™¨çš„å››ä¸ªé‡è¦æ—¶åˆ»ï¼š
ğŸ“ connection - æœ‰äººè¿æ¥è¿›æ¥äº†
ğŸ“¨ message   - æ”¶åˆ°å®¢æˆ·ç«¯çš„æ¶ˆæ¯äº†  
ğŸ‘‹ close     - æœ‰äººæ–­å¼€è¿æ¥äº†
âŒ error     - å‡ºé”™äº†
```

### 3.2 connectionäº‹ä»¶ï¼šå®¢æˆ·ç«¯è¿æ¥


**äº‹ä»¶å«ä¹‰ï¼š**
```
å½“æœ‰å®¢æˆ·ç«¯è¿æ¥åˆ°æœåŠ¡å™¨æ—¶è§¦å‘
å°±åƒæœ‰å®¢äººæ•²é—¨è¿›æ¥ä¸€æ ·
æ¯ä¸ªè¿æ¥éƒ½ä¼šåˆ†é…ä¸€ä¸ªwså¯¹è±¡ï¼Œä»£è¡¨è¿™ä¸ªå®¢æˆ·ç«¯
```

```javascript
wss.on('connection', (ws, request) => {
    // è·å–å®¢æˆ·ç«¯ä¿¡æ¯
    const clientIP = request.socket.remoteAddress;
    console.log(`æ–°å®¢æˆ·ç«¯è¿æ¥ï¼ŒIP: ${clientIP}`);
    
    // è¿æ¥æˆåŠŸåçš„å¤„ç†
    console.log('å½“å‰è¿æ¥æ•°:', wss.clients.size);
});
```

### 3.3 messageäº‹ä»¶ï¼šæ¥æ”¶å®¢æˆ·ç«¯æ¶ˆæ¯


**äº‹ä»¶å«ä¹‰ï¼š**
```
å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯åˆ°æœåŠ¡å™¨æ—¶è§¦å‘
messageå‚æ•°åŒ…å«å®¢æˆ·ç«¯å‘é€çš„æ•°æ®
å¯ä»¥æ˜¯æ–‡æœ¬ã€JSONæˆ–äºŒè¿›åˆ¶æ•°æ®
```

```javascript
ws.on('message', (data) => {
    // å°†æ¥æ”¶åˆ°çš„æ•°æ®è½¬ä¸ºå­—ç¬¦ä¸²
    const message = data.toString();
    console.log('æ”¶åˆ°æ¶ˆæ¯:', message);
    
    // ç®€å•çš„æ¶ˆæ¯å¤„ç†
    if (message === 'ping') {
        ws.send('pong'); // å›åº”å®¢æˆ·ç«¯
    } else {
        ws.send(`æœåŠ¡å™¨æ”¶åˆ°: ${message}`);
    }
});
```

### 3.4 closeäº‹ä»¶ï¼šå®¢æˆ·ç«¯æ–­å¼€è¿æ¥


**äº‹ä»¶å«ä¹‰ï¼š**
```
å®¢æˆ·ç«¯æ–­å¼€è¿æ¥æ—¶è§¦å‘
å¯èƒ½æ˜¯ä¸»åŠ¨å…³é—­ï¼Œä¹Ÿå¯èƒ½æ˜¯ç½‘ç»œæ–­å¼€
éœ€è¦æ¸…ç†ç›¸å…³èµ„æº
```

```javascript
ws.on('close', (code, reason) => {
    console.log('å®¢æˆ·ç«¯æ–­å¼€è¿æ¥');
    console.log('æ–­å¼€ä»£ç :', code);
    console.log('æ–­å¼€åŸå› :', reason.toString());
    console.log('å‰©ä½™è¿æ¥æ•°:', wss.clients.size);
});
```

### 3.5 erroräº‹ä»¶ï¼šé”™è¯¯å¤„ç†


**äº‹ä»¶å«ä¹‰ï¼š**
```
WebSocketè¿æ¥å‡ºç°é”™è¯¯æ—¶è§¦å‘
æ¯”å¦‚ç½‘ç»œå¼‚å¸¸ã€æ•°æ®æ ¼å¼é”™è¯¯ç­‰
å¿…é¡»å¤„ç†ï¼Œå¦åˆ™ç¨‹åºå¯èƒ½å´©æºƒ
```

```javascript
ws.on('error', (error) => {
    console.error('WebSocketé”™è¯¯:', error.message);
    // å¯ä»¥æ ¹æ®é”™è¯¯ç±»å‹åšä¸åŒå¤„ç†
});
```

### 3.6 å®Œæ•´äº‹ä»¶å¤„ç†ç¤ºä¾‹


```javascript
const WebSocket = require('ws');
const wss = new WebSocket.Server({ port: 8080 });

wss.on('connection', (ws, request) => {
    console.log('ğŸ”— æ–°å®¢æˆ·ç«¯è¿æ¥');
    
    // å‘é€æ¬¢è¿æ¶ˆæ¯
    ws.send('ğŸ‰ è¿æ¥æˆåŠŸï¼');
    
    // ç›‘å¬æ¶ˆæ¯
    ws.on('message', (data) => {
        const message = data.toString();
        console.log('ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯:', message);
        ws.send(`âœ… æ”¶åˆ°ä½ çš„æ¶ˆæ¯: ${message}`);
    });
    
    // ç›‘å¬æ–­å¼€
    ws.on('close', () => {
        console.log('ğŸ‘‹ å®¢æˆ·ç«¯æ–­å¼€è¿æ¥');
    });
    
    // ç›‘å¬é”™è¯¯
    ws.on('error', (error) => {
        console.error('âŒ è¿æ¥é”™è¯¯:', error.message);
    });
});

console.log('ğŸš€ WebSocketæœåŠ¡å™¨è¿è¡Œåœ¨ ws://localhost:8080');
```

---

## 4. ğŸ“¡ æ¶ˆæ¯å‘é€ä¸å¹¿æ’­


### 4.1 å‘å•ä¸ªå®¢æˆ·ç«¯å‘é€æ¶ˆæ¯


**ä»€ä¹ˆæ˜¯å‘é€æ¶ˆæ¯ï¼Ÿ**
```
å°±åƒç»™ç‰¹å®šçš„äººå‘å¾®ä¿¡ä¸€æ ·
ä½¿ç”¨ ws.send() æ–¹æ³•
åªæœ‰è¿™ä¸ªè¿æ¥çš„å®¢æˆ·ç«¯èƒ½æ”¶åˆ°
```

```javascript
// åŸºæœ¬å‘é€
ws.send('Helloå®¢æˆ·ç«¯ï¼');

// å‘é€JSONæ•°æ®
const data = { type: 'greeting', message: 'ä½ å¥½' };
ws.send(JSON.stringify(data));

// æ£€æŸ¥è¿æ¥çŠ¶æ€å†å‘é€
if (ws.readyState === WebSocket.OPEN) {
    ws.send('æ¶ˆæ¯å†…å®¹');
}
```

### 4.2 å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰å®¢æˆ·ç«¯


**ä»€ä¹ˆæ˜¯å¹¿æ’­ï¼Ÿ**
```
å°±åƒç”¨å¤§å–‡å­å–Šè¯ï¼Œæ‰€æœ‰äººéƒ½èƒ½å¬åˆ°
éå†æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯ï¼Œé€ä¸ªå‘é€æ¶ˆæ¯
å¸¸ç”¨äºç¾¤èŠã€ç³»ç»Ÿå…¬å‘Šç­‰åœºæ™¯
```

```javascript
// å¹¿æ’­å‡½æ•°
function broadcast(message) {
    wss.clients.forEach((client) => {
        // åªç»™æ­£å¸¸è¿æ¥çš„å®¢æˆ·ç«¯å‘é€
        if (client.readyState === WebSocket.OPEN) {
            client.send(message);
        }
    });
}

// ä½¿ç”¨å¹¿æ’­
broadcast('ğŸ“¢ ç³»ç»Ÿå…¬å‘Šï¼šæœåŠ¡å™¨é‡å¯ä¸­...');
```

### 4.3 å‘ç‰¹å®šå®¢æˆ·ç«¯å‘é€æ¶ˆæ¯


**å®é™…åœºæ™¯ï¼š**
```
æ¯”å¦‚ç§èŠåŠŸèƒ½ï¼Œåªç»™æŒ‡å®šçš„ç”¨æˆ·å‘æ¶ˆæ¯
éœ€è¦ç»™æ¯ä¸ªè¿æ¥åˆ†é…IDæˆ–æ ‡è¯†
é€šè¿‡IDæ‰¾åˆ°å¯¹åº”çš„è¿æ¥å‘é€æ¶ˆæ¯
```

```javascript
// å­˜å‚¨å®¢æˆ·ç«¯è¿æ¥å’ŒIDçš„æ˜ å°„
const clients = new Map();

wss.on('connection', (ws) => {
    // ç”Ÿæˆå®¢æˆ·ç«¯ID
    const clientId = generateId();
    clients.set(clientId, ws);
    
    // å‘Šè¯‰å®¢æˆ·ç«¯ä»–çš„ID
    ws.send(JSON.stringify({
        type: 'your-id',
        id: clientId
    }));
    
    // ç›‘å¬æ¶ˆæ¯
    ws.on('message', (data) => {
        const message = JSON.parse(data.toString());
        
        // å¦‚æœæ˜¯ç§èŠæ¶ˆæ¯
        if (message.type === 'private' && message.to) {
            const targetClient = clients.get(message.to);
            if (targetClient && targetClient.readyState === WebSocket.OPEN) {
                targetClient.send(JSON.stringify({
                    type: 'private-message',
                    from: clientId,
                    content: message.content
                }));
            }
        }
    });
    
    // è¿æ¥å…³é—­æ—¶æ¸…ç†
    ws.on('close', () => {
        clients.delete(clientId);
    });
});

function generateId() {
    return Math.random().toString(36).substring(2, 9);
}
```

---

## 5. ğŸ”§ è¿æ¥ç®¡ç†ä¸å¼‚å¸¸å¤„ç†


### 5.1 è¿æ¥æ•°ç»Ÿè®¡


**ä¸ºä»€ä¹ˆè¦ç»Ÿè®¡è¿æ¥æ•°ï¼Ÿ**
```
äº†è§£æœåŠ¡å™¨è´Ÿè½½æƒ…å†µ
æ§åˆ¶æœ€å¤§è¿æ¥æ•°ï¼Œé˜²æ­¢æœåŠ¡å™¨è¿‡è½½
ç›‘æ§ç”¨æˆ·æ´»è·ƒåº¦
```

```javascript
// å®æ—¶è¿æ¥æ•°ç»Ÿè®¡
function getConnectionCount() {
    return wss.clients.size;
}

// å®šæ—¶è¾“å‡ºè¿æ¥æ•°
setInterval(() => {
    console.log(`ğŸ“Š å½“å‰åœ¨çº¿ç”¨æˆ·: ${getConnectionCount()} äºº`);
}, 10000); // æ¯10ç§’è¾“å‡ºä¸€æ¬¡

// è®¾ç½®æœ€å¤§è¿æ¥æ•°é™åˆ¶
const MAX_CONNECTIONS = 100;

wss.on('connection', (ws) => {
    if (wss.clients.size > MAX_CONNECTIONS) {
        ws.send('âš ï¸ æœåŠ¡å™¨è¿æ¥æ•°å·²æ»¡ï¼Œè¯·ç¨åå†è¯•');
        ws.close(1008, 'æœåŠ¡å™¨è¿æ¥æ•°å·²æ»¡');
        return;
    }
    
    console.log(`âœ… æ–°ç”¨æˆ·åŠ å…¥ï¼Œåœ¨çº¿äººæ•°: ${wss.clients.size}`);
});
```

### 5.2 è¿æ¥æ¸…ç†æœºåˆ¶


**ä¸ºä»€ä¹ˆéœ€è¦æ¸…ç†ï¼Ÿ**
```
ç½‘ç»œæ–­å¼€æ—¶å®¢æˆ·ç«¯å¯èƒ½æ²¡æœ‰æ­£å¸¸å…³é—­è¿æ¥
è¿™äº›"åƒµå°¸è¿æ¥"ä¼šå ç”¨æœåŠ¡å™¨èµ„æº
éœ€è¦å®šæœŸæ£€æŸ¥å¹¶æ¸…ç†æ— æ•ˆè¿æ¥
```

```javascript
// å¿ƒè·³æ£€æµ‹æœºåˆ¶
function heartbeat() {
    this.isAlive = true;
}

wss.on('connection', (ws) => {
    ws.isAlive = true;
    ws.on('pong', heartbeat); // æ”¶åˆ°pongå“åº”è¡¨ç¤ºè¿æ¥æ­£å¸¸
});

// å®šæœŸæ£€æŸ¥è¿æ¥çŠ¶æ€
setInterval(() => {
    wss.clients.forEach((ws) => {
        if (ws.isAlive === false) {
            console.log('ğŸ§¹ æ¸…ç†æ— æ•ˆè¿æ¥');
            return ws.terminate(); // å¼ºåˆ¶å…³é—­è¿æ¥
        }
        
        ws.isAlive = false;
        ws.ping(); // å‘é€pingæµ‹è¯•è¿æ¥
    });
}, 30000); // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
```

### 5.3 æœåŠ¡ç«¯å¼‚å¸¸å¤„ç†


**å¸¸è§å¼‚å¸¸æƒ…å†µï¼š**
```
å®¢æˆ·ç«¯çªç„¶æ–­å¼€
å‘é€æ— æ•ˆæ•°æ®æ ¼å¼
å†…å­˜ä¸è¶³
ç«¯å£è¢«å ç”¨
```

```javascript
const WebSocket = require('ws');

// æœåŠ¡å™¨å¯åŠ¨å¼‚å¸¸å¤„ç†
try {
    const wss = new WebSocket.Server({ port: 8080 });
    console.log('âœ… WebSocketæœåŠ¡å™¨å¯åŠ¨æˆåŠŸ');
    
    wss.on('connection', (ws) => {
        ws.on('message', (data) => {
            try {
                // å°è¯•è§£æJSONæ¶ˆæ¯
                const message = JSON.parse(data.toString());
                handleMessage(ws, message);
            } catch (error) {
                // JSONè§£æå¤±è´¥
                console.error('âŒ æ¶ˆæ¯æ ¼å¼é”™è¯¯:', error.message);
                ws.send(JSON.stringify({
                    type: 'error',
                    message: 'æ¶ˆæ¯æ ¼å¼ä¸æ­£ç¡®'
                }));
            }
        });
        
        ws.on('error', (error) => {
            console.error('âŒ å®¢æˆ·ç«¯è¿æ¥é”™è¯¯:', error.message);
        });
    });
    
    // æœåŠ¡å™¨çº§åˆ«é”™è¯¯å¤„ç†
    wss.on('error', (error) => {
        console.error('âŒ WebSocketæœåŠ¡å™¨é”™è¯¯:', error.message);
    });
    
} catch (error) {
    console.error('âŒ æœåŠ¡å™¨å¯åŠ¨å¤±è´¥:', error.message);
    process.exit(1);
}

function handleMessage(ws, message) {
    // æ¶ˆæ¯å¤„ç†é€»è¾‘
    console.log('å¤„ç†æ¶ˆæ¯:', message);
}
```

---

## 6. ğŸ’¬ å®æˆ˜æ¡ˆä¾‹ï¼šç®€å•ç¾¤èŠåŠŸèƒ½


### 6.1 åŠŸèƒ½éœ€æ±‚


```
ğŸ“‹ ç¾¤èŠåŠŸèƒ½æ¸…å•ï¼š
âœ… ç”¨æˆ·è¿æ¥æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯
âœ… ç”¨æˆ·å‘è¨€å¹¿æ’­ç»™æ‰€æœ‰äºº
âœ… æ˜¾ç¤ºå½“å‰åœ¨çº¿äººæ•°
âœ… ç”¨æˆ·ç¦»å¼€æ—¶é€šçŸ¥å…¶ä»–äºº
âœ… æ¶ˆæ¯åŒ…å«æ—¶é—´æˆ³
```

### 6.2 å®Œæ•´æœåŠ¡ç«¯ä»£ç 


```javascript
const WebSocket = require('ws');

// åˆ›å»ºWebSocketæœåŠ¡å™¨
const wss = new WebSocket.Server({ port: 8080 });

// ç”¨æˆ·ç®¡ç†
const users = new Map(); // å­˜å‚¨ç”¨æˆ·ä¿¡æ¯
let userIdCounter = 1;   // ç”¨æˆ·IDè®¡æ•°å™¨

console.log('ğŸš€ ç¾¤èŠæœåŠ¡å™¨å¯åŠ¨åœ¨ ws://localhost:8080');

// å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰ç”¨æˆ·
function broadcast(message, excludeUser = null) {
    wss.clients.forEach((client) => {
        if (client.readyState === WebSocket.OPEN && client !== excludeUser) {
            client.send(JSON.stringify(message));
        }
    });
}

// è·å–å½“å‰æ—¶é—´
function getCurrentTime() {
    return new Date().toLocaleTimeString('zh-CN');
}

// å®¢æˆ·ç«¯è¿æ¥å¤„ç†
wss.on('connection', (ws) => {
    // åˆ†é…ç”¨æˆ·IDå’Œæ˜µç§°
    const userId = userIdCounter++;
    const userName = `ç”¨æˆ·${userId}`;
    
    // å­˜å‚¨ç”¨æˆ·ä¿¡æ¯
    users.set(ws, { id: userId, name: userName });
    
    console.log(`ğŸ‘‹ ${userName} åŠ å…¥èŠå¤©å®¤`);
    
    // å‘æ–°ç”¨æˆ·å‘é€æ¬¢è¿æ¶ˆæ¯
    ws.send(JSON.stringify({
        type: 'welcome',
        message: `æ¬¢è¿ ${userName} è¿›å…¥èŠå¤©å®¤ï¼`,
        userName: userName,
        time: getCurrentTime()
    }));
    
    // é€šçŸ¥å…¶ä»–ç”¨æˆ·æœ‰æ–°äººåŠ å…¥
    broadcast({
        type: 'user-join',
        message: `${userName} åŠ å…¥äº†èŠå¤©å®¤`,
        onlineCount: users.size,
        time: getCurrentTime()
    }, ws);
    
    // ç›‘å¬ç”¨æˆ·æ¶ˆæ¯
    ws.on('message', (data) => {
        try {
            const message = data.toString();
            const user = users.get(ws);
            
            console.log(`ğŸ’¬ ${user.name}: ${message}`);
            
            // å¹¿æ’­ç”¨æˆ·æ¶ˆæ¯ç»™æ‰€æœ‰äºº
            broadcast({
                type: 'chat-message',
                userName: user.name,
                message: message,
                time: getCurrentTime()
            });
            
        } catch (error) {
            console.error('âŒ æ¶ˆæ¯å¤„ç†é”™è¯¯:', error.message);
        }
    });
    
    // ç”¨æˆ·æ–­å¼€è¿æ¥
    ws.on('close', () => {
        const user = users.get(ws);
        if (user) {
            console.log(`ğŸ‘‹ ${user.name} ç¦»å¼€èŠå¤©å®¤`);
            
            // ä»ç”¨æˆ·åˆ—è¡¨ä¸­ç§»é™¤
            users.delete(ws);
            
            // é€šçŸ¥å…¶ä»–ç”¨æˆ·æœ‰äººç¦»å¼€
            broadcast({
                type: 'user-leave',
                message: `${user.name} ç¦»å¼€äº†èŠå¤©å®¤`,
                onlineCount: users.size,
                time: getCurrentTime()
            });
        }
    });
    
    // è¿æ¥é”™è¯¯å¤„ç†
    ws.on('error', (error) => {
        console.error('âŒ ç”¨æˆ·è¿æ¥é”™è¯¯:', error.message);
        const user = users.get(ws);
        if (user) {
            users.delete(ws);
        }
    });
});

// æœåŠ¡å™¨é”™è¯¯å¤„ç†
wss.on('error', (error) => {
    console.error('âŒ æœåŠ¡å™¨é”™è¯¯:', error.message);
});

// å®šæ—¶æ˜¾ç¤ºåœ¨çº¿äººæ•°
setInterval(() => {
    if (users.size > 0) {
        console.log(`ğŸ“Š å½“å‰åœ¨çº¿: ${users.size} äºº`);
    }
}, 30000);
```

### 6.3 é…å¥—çš„ç®€å•å®¢æˆ·ç«¯æµ‹è¯•é¡µé¢


```html
<!DOCTYPE html>
<html>
<head>
    <title>WebSocketç¾¤èŠæµ‹è¯•</title>
    <meta charset="utf-8">
</head>
<body>
    <div id="messages" style="height: 300px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px;"></div>
    <input type="text" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." style="width: 300px;">
    <button onclick="sendMessage()">å‘é€</button>
    
    <script>
        // è¿æ¥WebSocketæœåŠ¡å™¨
        const ws = new WebSocket('ws://localhost:8080');
        const messages = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        
        // è¿æ¥æˆåŠŸ
        ws.onopen = function() {
            addMessage('ğŸ”— è¿æ¥æœåŠ¡å™¨æˆåŠŸ');
        };
        
        // æ¥æ”¶æ¶ˆæ¯
        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            let message = '';
            
            switch(data.type) {
                case 'welcome':
                    message = `ğŸ‰ ${data.message}`;
                    break;
                case 'chat-message':
                    message = `[${data.time}] ${data.userName}: ${data.message}`;
                    break;
                case 'user-join':
                case 'user-leave':
                    message = `[${data.time}] ğŸ“¢ ${data.message} (åœ¨çº¿: ${data.onlineCount}äºº)`;
                    break;
            }
            
            addMessage(message);
        };
        
        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            const message = messageInput.value.trim();
            if (message && ws.readyState === WebSocket.OPEN) {
                ws.send(message);
                messageInput.value = '';
            }
        }
        
        // æ·»åŠ æ¶ˆæ¯åˆ°é¡µé¢
        function addMessage(message) {
            const div = document.createElement('div');
            div.textContent = message;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }
        
        // å›è½¦å‘é€æ¶ˆæ¯
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„åŸºç¡€æ¦‚å¿µ


```
ğŸ”¸ wsæ¨¡å—ï¼šNode.jsä¸­åˆ›å»ºWebSocketæœåŠ¡å™¨çš„å·¥å…·åŒ…
ğŸ”¸ WebSocket.Serverï¼šWebSocketæœåŠ¡å™¨ç±»ï¼Œç›‘å¬ç«¯å£ç­‰å¾…è¿æ¥
ğŸ”¸ å››å¤§æ ¸å¿ƒäº‹ä»¶ï¼šconnectionã€messageã€closeã€error
ğŸ”¸ æ¶ˆæ¯å‘é€ï¼šws.send() å‘é€ç»™å•ä¸ªå®¢æˆ·ç«¯
ğŸ”¸ æ¶ˆæ¯å¹¿æ’­ï¼šéå†æ‰€æœ‰å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯
ğŸ”¸ è¿æ¥ç®¡ç†ï¼šç»Ÿè®¡è¿æ¥æ•°ã€æ¸…ç†æ— æ•ˆè¿æ¥
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ WebSocketæœåŠ¡å™¨çš„æœ¬è´¨**
```
ç†è§£è¦ç‚¹ï¼š
- æœåŠ¡å™¨å°±åƒä¸€ä¸ª"æˆ¿é—´"ï¼Œå®¢æˆ·ç«¯å¯ä»¥è¿›æ¥èŠå¤©
- æ¯ä¸ªè¿æ¥éƒ½æ˜¯ä¸€ä¸ª"é€šè¯é€šé“"
- æœåŠ¡å™¨è´Ÿè´£æ¥æ”¶æ¶ˆæ¯å¹¶è½¬å‘ç»™å…¶ä»–äºº
```

**ğŸ”¹ äº‹ä»¶é©±åŠ¨ç¼–ç¨‹**
```
æ ¸å¿ƒæ€è·¯ï¼š
- ä¸æ˜¯ä¸»åŠ¨è¯¢é—®ï¼Œè€Œæ˜¯ç­‰å¾…äº‹ä»¶å‘ç”Ÿ
- æœ‰äººè¿æ¥â†’è§¦å‘connectionäº‹ä»¶
- æ”¶åˆ°æ¶ˆæ¯â†’è§¦å‘messageäº‹ä»¶
- åƒè®¾ç½®é—¹é’Ÿï¼Œæ—¶é—´åˆ°äº†è‡ªåŠ¨å“é“ƒ
```

**ğŸ”¹ å¹¿æ’­ä¸å•æ’­çš„åŒºåˆ«**
```
å•æ’­ï¼šws.send() â†’ å‘ç»™ç‰¹å®šçš„ä¸€ä¸ªäºº
å¹¿æ’­ï¼šéå†æ‰€æœ‰è¿æ¥ â†’ å‘ç»™æ‰€æœ‰äºº
å°±åƒç§èŠå’Œç¾¤èŠçš„åŒºåˆ«
```

### 7.3 å®é™…å¼€å‘è¦ç‚¹


```
âœ… å¿…åšäº‹é¡¹ï¼š
- å§‹ç»ˆå¤„ç†erroräº‹ä»¶ï¼Œé˜²æ­¢ç¨‹åºå´©æºƒ
- å‘é€æ¶ˆæ¯å‰æ£€æŸ¥è¿æ¥çŠ¶æ€
- å®šæœŸæ¸…ç†æ— æ•ˆè¿æ¥
- è®°å½•æ—¥å¿—æ–¹ä¾¿è°ƒè¯•

âš ï¸ æ³¨æ„äº‹é¡¹ï¼š
- JSON.parseå¯èƒ½æŠ›å¼‚å¸¸ï¼Œè¦ç”¨try-catchåŒ…å›´
- å¤§é‡è¿æ¥æ—¶è¦è€ƒè™‘å†…å­˜ä½¿ç”¨
- ç”Ÿäº§ç¯å¢ƒéœ€è¦æ›´å®Œå–„çš„é”™è¯¯å¤„ç†

ğŸš€ ä¼˜åŒ–å»ºè®®ï¼š
- ä½¿ç”¨å¿ƒè·³æ£€æµ‹ä¿æŒè¿æ¥æ´»è·ƒ
- é™åˆ¶æœ€å¤§è¿æ¥æ•°é˜²æ­¢æœåŠ¡å™¨è¿‡è½½
- æ¶ˆæ¯æ ¼å¼ç»Ÿä¸€ä½¿ç”¨JSON
```

### 7.4 å­¦ä¹ è·¯å¾„å»ºè®®


```
ğŸ“– å­¦ä¹ é¡ºåºï¼š
ç¬¬ä¸€æ­¥ï¼šæ­å»ºåŸºç¡€æœåŠ¡å™¨ï¼Œå®ç°è¿æ¥å’Œæ¶ˆæ¯å‘é€
ç¬¬äºŒæ­¥ï¼šæŒæ¡å››å¤§æ ¸å¿ƒäº‹ä»¶çš„å¤„ç†
ç¬¬ä¸‰æ­¥ï¼šå®ç°æ¶ˆæ¯å¹¿æ’­åŠŸèƒ½
ç¬¬å››æ­¥ï¼šæ·»åŠ è¿æ¥ç®¡ç†å’Œé”™è¯¯å¤„ç†
ç¬¬äº”æ­¥ï¼šå¼€å‘å®Œæ•´çš„ç¾¤èŠåŠŸèƒ½

ğŸ¤” æ€è€ƒç»ƒä¹ ï¼š
1. å¦‚ä½•å®ç°ç§èŠåŠŸèƒ½ï¼Ÿ
2. å¦‚ä½•é™åˆ¶æ¶ˆæ¯å‘é€é¢‘ç‡ï¼Ÿ
3. å¦‚ä½•å®ç°èŠå¤©è®°å½•ä¿å­˜ï¼Ÿ
4. å¦‚ä½•å¤„ç†å¤§é‡å¹¶å‘è¿æ¥ï¼Ÿ
```

**ğŸ§  è®°å¿†è¦ç‚¹**ï¼š
- WebSocketæœåŠ¡å™¨åƒæˆ¿é—´ï¼Œå®¢æˆ·ç«¯è¿›æ¥èŠå¤©
- å››å¤§äº‹ä»¶è¦ç‰¢è®°ï¼šè¿æ¥ã€æ¶ˆæ¯ã€å…³é—­ã€é”™è¯¯
- å‘æ¶ˆæ¯æœ‰å•æ’­å’Œå¹¿æ’­ï¼Œæ ¹æ®éœ€æ±‚æ¥é€‰æ‹©
- è¿æ¥ç®¡ç†å¾ˆé‡è¦ï¼Œæ¸…ç†åƒµå°¸ä¿æ€§èƒ½