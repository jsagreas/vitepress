---
title: 3ã€æ¶ˆæ¯æ ¼å¼ä¸æ•°æ®ä¼ è¾“è§„èŒƒ
---
## ğŸ“š ç›®å½•


1. [WebSocketæ•°æ®ç±»å‹æ·±å…¥ç†è§£](#1-WebSocketæ•°æ®ç±»å‹æ·±å…¥ç†è§£)
2. [JSONæ•°æ®ä¼ è¾“æœ€ä½³å®è·µ](#2-JSONæ•°æ®ä¼ è¾“æœ€ä½³å®è·µ)
3. [æ¶ˆæ¯åºåˆ—åŒ–ä¸ååºåˆ—åŒ–å¤„ç†](#3-æ¶ˆæ¯åºåˆ—åŒ–ä¸ååºåˆ—åŒ–å¤„ç†)
4. [ç»“æ„åŒ–æ¶ˆæ¯æ ¼å¼è®¾è®¡](#4-ç»“æ„åŒ–æ¶ˆæ¯æ ¼å¼è®¾è®¡)
5. [æ•°æ®å¸§ç»“æ„åŸºç¡€](#5-æ•°æ®å¸§ç»“æ„åŸºç¡€)
6. [æ¶ˆæ¯å¤§å°é™åˆ¶ä¸ä¼˜åŒ–](#6-æ¶ˆæ¯å¤§å°é™åˆ¶ä¸ä¼˜åŒ–)
7. [å¤šç§ç±»å‹æ¶ˆæ¯å¤„ç†å®è·µ](#7-å¤šç§ç±»å‹æ¶ˆæ¯å¤„ç†å®è·µ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

# 1. ğŸ“¨ WebSocketæ•°æ®ç±»å‹æ·±å…¥ç†è§£



## 1.1 ä¸ºä»€ä¹ˆWebSocketæ”¯æŒå¤šç§æ•°æ®ç±»å‹ï¼Ÿ



æƒ³è±¡ä¸€ä¸‹ä½ åœ¨å¾®ä¿¡èŠå¤©ï¼š
- å‘é€**æ–‡å­—æ¶ˆæ¯** â†’ éœ€è¦æ–‡æœ¬æ•°æ®
- å‘é€**å›¾ç‰‡** â†’ éœ€è¦äºŒè¿›åˆ¶æ•°æ®  
- å‘é€**è¯­éŸ³** â†’ éœ€è¦äºŒè¿›åˆ¶æ•°æ®
- å‘é€**è¡¨æƒ…åŒ…** â†’ éœ€è¦äºŒè¿›åˆ¶æ•°æ®

WebSocketå°±åƒä¸€ä¸ªä¸‡èƒ½çš„ä¿¡ä½¿ï¼Œå¯ä»¥ä¼ é€’å„ç§ç±»å‹çš„"åŒ…è£¹"ï¼

## 1.2 æ–‡æœ¬æ¶ˆæ¯ï¼ˆUTF-8å­—ç¬¦ä¸²ï¼‰



**ğŸ”¸ ä»€ä¹ˆæ˜¯æ–‡æœ¬æ¶ˆæ¯ï¼Ÿ**
- å°±æ˜¯æˆ‘ä»¬å¹³å¸¸çœ‹åˆ°çš„**æ–‡å­—å†…å®¹**
- ä½¿ç”¨UTF-8ç¼–ç ï¼Œ**æ”¯æŒä¸­æ–‡ã€è‹±æ–‡ã€è¡¨æƒ…ç¬¦å·**
- æœ€å¸¸ç”¨çš„æ¶ˆæ¯ç±»å‹

```javascript
// ğŸ“ å‘é€æ–‡æœ¬æ¶ˆæ¯ - å°±åƒå‘å¾®ä¿¡æ–‡å­—
const socket = new WebSocket('ws://localhost:3000');

socket.onopen = function() {
    // ç›´æ¥å‘é€å­—ç¬¦ä¸²ï¼Œå°±æ˜¯æ–‡æœ¬æ¶ˆæ¯
    socket.send('ä½ å¥½ï¼ŒWebSocketï¼');
    socket.send('Hello World!');
    socket.send('ğŸ‰ æ”¯æŒè¡¨æƒ…ç¬¦å·');
};

// ğŸ“¨ æ¥æ”¶æ–‡æœ¬æ¶ˆæ¯
socket.onmessage = function(event) {
    console.log('æ”¶åˆ°æ–‡æœ¬æ¶ˆæ¯ï¼š', event.data);
    // è¾“å‡ºï¼šä½ å¥½ï¼ŒWebSocketï¼
};
```

## 1.3 äºŒè¿›åˆ¶æ•°æ®ç±»å‹è¯¦è§£



### ArrayBuffer - åŸå§‹äºŒè¿›åˆ¶æ•°æ®



**ğŸ”¸ ä»€ä¹ˆæ˜¯ArrayBufferï¼Ÿ**
- æƒ³è±¡æˆä¸€ä¸ª**è£…æ»¡å­—èŠ‚çš„ç®±å­**
- å­˜å‚¨åŸå§‹çš„äºŒè¿›åˆ¶æ•°æ®
- é€‚åˆä¼ è¾“æ–‡ä»¶ã€å›¾ç‰‡ã€éŸ³é¢‘ç­‰

```javascript
// ğŸ“¦ åˆ›å»ºå¹¶å‘é€ArrayBuffer
const buffer = new ArrayBuffer(16); // åˆ›å»º16å­—èŠ‚çš„æ•°æ®ç®±å­
const view = new Uint8Array(buffer);

// å¾€ç®±å­é‡Œè£…æ•°æ®
for(let i = 0; i < 16; i++) {
    view[i] = i; // 0,1,2,3...15
}

// å‘é€äºŒè¿›åˆ¶æ•°æ®
socket.send(buffer);

// ğŸ“¨ æ¥æ”¶ArrayBufferæ•°æ®
socket.onmessage = function(event) {
    if (event.data instanceof ArrayBuffer) {
        console.log('æ”¶åˆ°ArrayBufferï¼Œå¤§å°ï¼š', event.data.byteLength);
        const view = new Uint8Array(event.data);
        console.log('æ•°æ®å†…å®¹ï¼š', Array.from(view));
    }
};
```

### Blob - æ–‡ä»¶å‹äºŒè¿›åˆ¶æ•°æ®



**ğŸ”¸ ä»€ä¹ˆæ˜¯Blobï¼Ÿ**
- æƒ³è±¡æˆä¸€ä¸ª**å¸¦æ ‡ç­¾çš„æ–‡ä»¶è¢‹**
- ä¸ä»…æœ‰æ•°æ®ï¼Œè¿˜çŸ¥é“æ•°æ®çš„ç±»å‹ï¼ˆå¦‚å›¾ç‰‡ã€éŸ³é¢‘ï¼‰
- é€‚åˆå¤„ç†æ–‡ä»¶ä¸Šä¼ ä¸‹è½½

```javascript
// ğŸ“ åˆ›å»ºå¹¶å‘é€Blob
const textData = 'è¿™æ˜¯ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶çš„å†…å®¹';
const blob = new Blob([textData], {type: 'text/plain'});

socket.send(blob);

// ğŸ“¨ æ¥æ”¶Blobæ•°æ®
socket.onmessage = function(event) {
    if (event.data instanceof Blob) {
        console.log('æ”¶åˆ°Blobï¼Œç±»å‹ï¼š', event.data.type);
        console.log('å¤§å°ï¼š', event.data.size);
        
        // è¯»å–Blobå†…å®¹
        const reader = new FileReader();
        reader.onload = function() {
            console.log('Blobå†…å®¹ï¼š', reader.result);
        };
        reader.readAsText(event.data);
    }
};
```

## 1.4 æ•°æ®ç±»å‹å¯¹æ¯”å›¾



```
æ•°æ®ç±»å‹ä¼ è¾“å¯¹æ¯”ï¼š

æ–‡æœ¬æ¶ˆæ¯ï¼š
å®¢æˆ·ç«¯ â†’ "Hello" â†’ æœåŠ¡å™¨
        (UTF-8ç¼–ç )

ArrayBufferï¼š
å®¢æˆ·ç«¯ â†’ [01010101...] â†’ æœåŠ¡å™¨
        (åŸå§‹å­—èŠ‚æ•°æ®)

Blobï¼š
å®¢æˆ·ç«¯ â†’ [æ•°æ®+ç±»å‹ä¿¡æ¯] â†’ æœåŠ¡å™¨
        (å¸¦å…ƒæ•°æ®çš„æ–‡ä»¶)
```

---

# 2. ğŸ¯ JSONæ•°æ®ä¼ è¾“æœ€ä½³å®è·µ



## 2.1 ä¸ºä»€ä¹ˆé€‰æ‹©JSONï¼Ÿ



**ğŸ¤” æƒ³è±¡ä¸€ä¸ªåœºæ™¯ï¼š**
ä½ è¦å‘Šè¯‰æœ‹å‹ä½ çš„ä¿¡æ¯ï¼š
- âŒ æ··ä¹±æ–¹å¼ï¼š`å¼ ä¸‰25ç”·åŒ—äº¬ç¨‹åºå‘˜`
- âœ… ç»“æ„åŒ–æ–¹å¼ï¼š`{"name":"å¼ ä¸‰", "age":25, "gender":"ç”·", "city":"åŒ—äº¬", "job":"ç¨‹åºå‘˜"}`

JSONå°±åƒç»™æ•°æ®ç©¿ä¸Šäº†**æ ‡å‡†åˆ¶æœ**ï¼Œè®©ä»»ä½•äººéƒ½èƒ½çœ‹æ‡‚ï¼

## 2.2 JSONæ¶ˆæ¯ä¼ è¾“å®è·µ



```javascript
// ğŸ“‹ æ ‡å‡†JSONæ¶ˆæ¯ç»“æ„
const messageData = {
    type: 'chat',           // æ¶ˆæ¯ç±»å‹
    content: 'ä½ å¥½ï¼',       // æ¶ˆæ¯å†…å®¹  
    sender: 'user123',      // å‘é€è€…
    timestamp: Date.now()   // æ—¶é—´æˆ³
};

// ğŸš€ å‘é€JSONæ¶ˆæ¯
function sendJsonMessage(socket, data) {
    // JSONå¯¹è±¡ â†’ å­—ç¬¦ä¸² â†’ å‘é€
    const jsonString = JSON.stringify(data);
    socket.send(jsonString);
    console.log('å‘é€æ¶ˆæ¯ï¼š', data);
}

// ğŸ“¨ æ¥æ”¶JSONæ¶ˆæ¯
socket.onmessage = function(event) {
    try {
        // å­—ç¬¦ä¸² â†’ JSONå¯¹è±¡
        const message = JSON.parse(event.data);
        console.log('æ”¶åˆ°æ¶ˆæ¯ï¼š', message);
        
        // æ ¹æ®æ¶ˆæ¯ç±»å‹å¤„ç†
        handleMessage(message);
    } catch (error) {
        console.error('JSONè§£æå¤±è´¥ï¼š', error);
    }
};

// ğŸ“ ä½¿ç”¨ç¤ºä¾‹
sendJsonMessage(socket, {
    type: 'user_login',
    content: {
        username: 'å¼ ä¸‰',
        room: 'room001'
    },
    sender: 'system',
    timestamp: Date.now()
});
```

## 2.3 JSONä¼ è¾“çš„æ³¨æ„äº‹é¡¹



| æ³¨æ„ç‚¹ | è¯´æ˜ | è§£å†³æ–¹æ¡ˆ |
|--------|------|----------|
| **æ•°æ®å¤§å°** | JSONæ¯”äºŒè¿›åˆ¶æ•°æ®å¤§ | é‡è¦æ•°æ®ç”¨JSONï¼Œå¤§æ–‡ä»¶ç”¨äºŒè¿›åˆ¶ |
| **ç±»å‹å®‰å…¨** | æ•°å­—å¯èƒ½å˜æˆå­—ç¬¦ä¸² | æ¥æ”¶åéªŒè¯æ•°æ®ç±»å‹ |
| **ç‰¹æ®Šå­—ç¬¦** | æŸäº›å­—ç¬¦éœ€è¦è½¬ä¹‰ | ä½¿ç”¨`JSON.stringify()`è‡ªåŠ¨å¤„ç† |
| **å¾ªç¯å¼•ç”¨** | å¯¹è±¡äº’ç›¸å¼•ç”¨ä¼šæŠ¥é”™ | é¿å…å¤æ‚çš„å¯¹è±¡ç»“æ„ |

---

# 3. ğŸ”„ æ¶ˆæ¯åºåˆ—åŒ–ä¸ååºåˆ—åŒ–å¤„ç†



## 3.1 ä»€ä¹ˆæ˜¯åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Ÿ



**ğŸ¯ ç”Ÿæ´»åŒ–ç†è§£ï¼š**
```
åºåˆ—åŒ– = æ‰“åŒ…é‚®å¯„
ä½ çš„ç‰©å“ â†’ è£…è¿›ç›’å­ â†’ è´´ä¸Šæ ‡ç­¾ â†’ å¯ä»¥é‚®å¯„

ååºåˆ—åŒ– = æ‹†åŒ…å–è´§  
æ”¶åˆ°åŒ…è£¹ â†’ æ‹†å¼€ç›’å­ â†’ å–å‡ºç‰©å“ â†’ å¯ä»¥ä½¿ç”¨
```

**ğŸ”¸ åœ¨WebSocketä¸­ï¼š**
- **åºåˆ—åŒ–**ï¼šJavaScriptå¯¹è±¡ â†’ å­—ç¬¦ä¸²ï¼ˆå¯ä¼ è¾“ï¼‰
- **ååºåˆ—åŒ–**ï¼šå­—ç¬¦ä¸² â†’ JavaScriptå¯¹è±¡ï¼ˆå¯ä½¿ç”¨ï¼‰

## 3.2 å®‰å…¨çš„åºåˆ—åŒ–å¤„ç†



```javascript
// ğŸ›¡ï¸ å®‰å…¨çš„æ¶ˆæ¯åºåˆ—åŒ–å·¥å…·
class MessageSerializer {
    
    // ğŸ“¦ åºåˆ—åŒ–æ¶ˆæ¯ï¼ˆå¯¹è±¡è½¬å­—ç¬¦ä¸²ï¼‰
    static serialize(data) {
        try {
            // æ·»åŠ åŸºç¡€ä¿¡æ¯
            const message = {
                ...data,
                timestamp: Date.now(),
                version: '1.0'
            };
            
            return JSON.stringify(message);
        } catch (error) {
            console.error('åºåˆ—åŒ–å¤±è´¥ï¼š', error);
            throw new Error('æ¶ˆæ¯åºåˆ—åŒ–å¤±è´¥');
        }
    }
    
    // ğŸ“¨ ååºåˆ—åŒ–æ¶ˆæ¯ï¼ˆå­—ç¬¦ä¸²è½¬å¯¹è±¡ï¼‰
    static deserialize(jsonString) {
        try {
            const data = JSON.parse(jsonString);
            
            // éªŒè¯å¿…è¦å­—æ®µ
            if (!data.type) {
                throw new Error('æ¶ˆæ¯ç¼ºå°‘typeå­—æ®µ');
            }
            
            return data;
        } catch (error) {
            console.error('ååºåˆ—åŒ–å¤±è´¥ï¼š', error);
            throw new Error('æ¶ˆæ¯ååºåˆ—åŒ–å¤±è´¥');
        }
    }
    
    // âœ… éªŒè¯æ¶ˆæ¯æ ¼å¼
    static validate(message) {
        const required = ['type', 'timestamp'];
        for (const field of required) {
            if (!message[field]) {
                return false;
            }
        }
        return true;
    }
}

// ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹
const originalMessage = {
    type: 'chat',
    content: 'ä½ å¥½',
    sender: 'user123'
};

// åºåˆ—åŒ–
const serialized = MessageSerializer.serialize(originalMessage);
socket.send(serialized);

// ååºåˆ—åŒ–
socket.onmessage = function(event) {
    try {
        const message = MessageSerializer.deserialize(event.data);
        
        if (MessageSerializer.validate(message)) {
            console.log('æ”¶åˆ°æœ‰æ•ˆæ¶ˆæ¯ï¼š', message);
        } else {
            console.error('æ¶ˆæ¯æ ¼å¼æ— æ•ˆ');
        }
    } catch (error) {
        console.error('å¤„ç†æ¶ˆæ¯å¤±è´¥ï¼š', error);
    }
};
```

## 3.3 åºåˆ—åŒ–æµç¨‹å›¾



```
å‘é€æµç¨‹ï¼š
JavaScriptå¯¹è±¡ â†’ åºåˆ—åŒ– â†’ JSONå­—ç¬¦ä¸² â†’ WebSocketå‘é€ â†’ ç½‘ç»œä¼ è¾“

{                    JSON.stringify()         "{"type":"chat",...}"
  type: "chat",  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  ç½‘ç»œ
  content: "hi"
}

æ¥æ”¶æµç¨‹ï¼š
ç½‘ç»œä¼ è¾“ â†’ WebSocketæ¥æ”¶ â†’ JSONå­—ç¬¦ä¸² â†’ ååºåˆ—åŒ– â†’ JavaScriptå¯¹è±¡

ç½‘ç»œ  â”€â”€â”€â”€â†’  "{"type":"chat",...}"  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  {
                                      JSON.parse()         type: "chat",
                                                          content: "hi"
                                                        }
```

---

# 4. ğŸ—ï¸ ç»“æ„åŒ–æ¶ˆæ¯æ ¼å¼è®¾è®¡



## 4.1 ä¸ºä»€ä¹ˆéœ€è¦ç»Ÿä¸€çš„æ¶ˆæ¯æ ¼å¼ï¼Ÿ



**ğŸ¯ åœºæ™¯å¯¹æ¯”ï¼š**

âŒ **æ— è§„èŒƒçš„æ··ä¹±çŠ¶æ€ï¼š**
```javascript
// æ¯ä¸ªäººéƒ½æœ‰è‡ªå·±çš„æ ¼å¼
socket.send('hello');                    // çº¯æ–‡æœ¬
socket.send({msg: 'hi', from: 'tom'});   // ç®€å•å¯¹è±¡
socket.send({message: 'hey', user: 'jerry', time: '2024-01-01'}); // åˆä¸€ç§æ ¼å¼
```

âœ… **ç»Ÿä¸€è§„èŒƒçš„æ¸…æ™°çŠ¶æ€ï¼š**
```javascript
// æ‰€æœ‰æ¶ˆæ¯éƒ½éµå¾ªç›¸åŒæ ¼å¼
const message = {
    type: 'chat',
    content: 'hello',  
    sender: 'tom',
    timestamp: 1609459200000
};
```

## 4.2 æ ‡å‡†æ¶ˆæ¯ç»“æ„è®¾è®¡



```javascript
// ğŸ¯ æ ‡å‡†æ¶ˆæ¯ç»“æ„æ¨¡æ¿
const MessageTemplate = {
    type: '',        // ğŸ·ï¸ æ¶ˆæ¯ç±»å‹ï¼ˆå¿…éœ€ï¼‰
    content: {},     // ğŸ“ æ¶ˆæ¯å†…å®¹ï¼ˆå¿…éœ€ï¼‰
    sender: '',      // ğŸ‘¤ å‘é€è€…ä¿¡æ¯ï¼ˆå¿…éœ€ï¼‰
    timestamp: 0,    // â° å‘é€æ—¶é—´ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
    id: '',         // ğŸ†” æ¶ˆæ¯å”¯ä¸€æ ‡è¯†ï¼ˆå¯é€‰ï¼‰
    target: ''      // ğŸ¯ ç›®æ ‡æ¥æ”¶è€…ï¼ˆå¯é€‰ï¼‰
};
```

### 4.2.1 æ¶ˆæ¯ç±»å‹å®šä¹‰ï¼ˆtypeå­—æ®µï¼‰



**ğŸ”¸ ä¸ºä»€ä¹ˆéœ€è¦typeå­—æ®µï¼Ÿ**
å°±åƒå¿«é€’åŒ…è£¹è¦è´´æ ‡ç­¾ä¸€æ ·ï¼Œä¸åŒç±»å‹çš„æ¶ˆæ¯éœ€è¦ä¸åŒçš„å¤„ç†æ–¹å¼ï¼

```javascript
// ğŸ“‹ æ¶ˆæ¯ç±»å‹æšä¸¾
const MessageTypes = {
    // èŠå¤©ç›¸å…³
    CHAT: 'chat',                    // æ™®é€šèŠå¤©æ¶ˆæ¯
    PRIVATE_CHAT: 'private_chat',    // ç§èŠæ¶ˆæ¯
    
    // ç³»ç»Ÿç›¸å…³  
    USER_JOIN: 'user_join',          // ç”¨æˆ·åŠ å…¥
    USER_LEAVE: 'user_leave',        // ç”¨æˆ·ç¦»å¼€
    SYSTEM_NOTICE: 'system_notice',  // ç³»ç»Ÿé€šçŸ¥
    
    // åŠŸèƒ½ç›¸å…³
    HEARTBEAT: 'heartbeat',          // å¿ƒè·³æ£€æµ‹
    FILE_UPLOAD: 'file_upload',      // æ–‡ä»¶ä¸Šä¼ 
    TYPING: 'typing'                 // æ­£åœ¨è¾“å…¥
};

// ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹
function createChatMessage(content, sender) {
    return {
        type: MessageTypes.CHAT,
        content: content,
        sender: sender,
        timestamp: Date.now()
    };
}
```

### 4.2.2 æ¶ˆæ¯å†…å®¹å°è£…ï¼ˆcontentå­—æ®µï¼‰



**ğŸ”¸ contentå­—æ®µçš„çµæ´»è®¾è®¡ï¼š**

```javascript
// ğŸ“ ä¸åŒç±»å‹æ¶ˆæ¯çš„contentç»“æ„

// 1ï¸âƒ£ æ–‡æœ¬èŠå¤©æ¶ˆæ¯
const textMessage = {
    type: 'chat',
    content: {
        text: 'ä½ å¥½ï¼Œå¤§å®¶ï¼',
        mentions: ['@å¼ ä¸‰', '@æå››']  // æåŠçš„ç”¨æˆ·
    },
    sender: 'user123',
    timestamp: Date.now()
};

// 2ï¸âƒ£ å›¾ç‰‡æ¶ˆæ¯
const imageMessage = {
    type: 'chat',
    content: {
        type: 'image',
        url: 'https://example.com/image.jpg',
        thumbnail: 'https://example.com/thumb.jpg',
        size: 1024000,
        width: 800,
        height: 600
    },
    sender: 'user123',
    timestamp: Date.now()
};

// 3ï¸âƒ£ ç³»ç»Ÿé€šçŸ¥æ¶ˆæ¯
const systemMessage = {
    type: 'system_notice',
    content: {
        level: 'info',           // info, warning, error
        title: 'ç³»ç»Ÿç»´æŠ¤é€šçŸ¥',
        message: 'ç³»ç»Ÿå°†åœ¨ä»Šæ™š22:00è¿›è¡Œç»´æŠ¤',
        action: {
            text: 'æŸ¥çœ‹è¯¦æƒ…',
            url: '/maintenance-info'
        }
    },
    sender: 'system',
    timestamp: Date.now()
};
```

### 4.2.3 å‘é€è€…ä¿¡æ¯ï¼ˆsenderå­—æ®µï¼‰



```javascript
// ğŸ‘¤ å‘é€è€…ä¿¡æ¯çš„ä¸åŒå±‚æ¬¡

// ç®€å•æ¨¡å¼ï¼šåªæœ‰ç”¨æˆ·ID
const simpleMessage = {
    type: 'chat',
    content: {text: 'å¤§å®¶å¥½ï¼'},
    sender: 'user123',
    timestamp: Date.now()
};

// è¯¦ç»†æ¨¡å¼ï¼šåŒ…å«ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
const detailedMessage = {
    type: 'chat', 
    content: {text: 'å¤§å®¶å¥½ï¼'},
    sender: {
        id: 'user123',
        name: 'å¼ ä¸‰',
        avatar: 'https://example.com/avatar.jpg',
        role: 'member'           // member, admin, owner
    },
    timestamp: Date.now()
};
```

### 4.2.4 æ—¶é—´æˆ³å¤„ç†ï¼ˆtimestampå­—æ®µï¼‰



```javascript
// â° æ—¶é—´æˆ³çš„æ ‡å‡†åŒ–å¤„ç†
class MessageBuilder {
    
    static createMessage(type, content, sender) {
        return {
            type: type,
            content: content,
            sender: sender,
            timestamp: Date.now(),           // 13ä½æ—¶é—´æˆ³
            id: this.generateId()            // ç”Ÿæˆå”¯ä¸€ID
        };
    }
    
    static generateId() {
        return Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
    
    // ğŸ“… æ—¶é—´æ ¼å¼åŒ–å·¥å…·
    static formatTimestamp(timestamp) {
        const date = new Date(timestamp);
        return {
            full: date.toISOString(),                    // 2024-01-15T10:30:00.000Z
            date: date.toLocaleDateString(),             // 2024/1/15
            time: date.toLocaleTimeString(),             // 10:30:00
            relative: this.getRelativeTime(timestamp)    // 5åˆ†é’Ÿå‰
        };
    }
    
    static getRelativeTime(timestamp) {
        const now = Date.now();
        const diff = now - timestamp;
        const minutes = Math.floor(diff / 60000);
        
        if (minutes < 1) return 'åˆšåˆš';
        if (minutes < 60) return `${minutes}åˆ†é’Ÿå‰`;
        if (minutes < 1440) return `${Math.floor(minutes/60)}å°æ—¶å‰`;
        return `${Math.floor(minutes/1440)}å¤©å‰`;
    }
}

// ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹
const message = MessageBuilder.createMessage(
    'chat',
    {text: 'ä½ å¥½ä¸–ç•Œï¼'},
    'user123'
);

console.log('æ¶ˆæ¯ï¼š', message);
console.log('æ ¼å¼åŒ–æ—¶é—´ï¼š', MessageBuilder.formatTimestamp(message.timestamp));
```

---

# 5. ğŸ“¡ æ•°æ®å¸§ç»“æ„åŸºç¡€



## 5.1 ä»€ä¹ˆæ˜¯WebSocketæ•°æ®å¸§ï¼Ÿ



**ğŸ¯ ç”Ÿæ´»åŒ–æ¯”å–»ï¼š**
æƒ³è±¡WebSocketæ•°æ®å¸§å°±åƒ**é‚®æ”¿åŒ…è£¹**ï¼š

```
ğŸ“¦ åŒ…è£¹ç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“® é‚®æ”¿æ ‡ç­¾ï¼ˆå¸§å¤´ä¿¡æ¯ï¼‰        â”‚ â† å‘Šè¯‰é‚®é€’å‘˜è¿™æ˜¯ä»€ä¹ˆåŒ…è£¹
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“‹ æ”¶ä»¶äººä¿¡æ¯ï¼ˆæ§åˆ¶ä¿¡æ¯ï¼‰      â”‚ â† è¦å‘ç»™è°ï¼Œæ€ä¹ˆå¤„ç†
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“„ åŒ…è£¹å†…å®¹ï¼ˆå®é™…æ•°æ®ï¼‰        â”‚ â† ä½ è¦ä¼ é€’çš„çœŸæ­£å†…å®¹
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 5.2 WebSocketå¸§ç»“æ„ç®€åŒ–ç†è§£



```
WebSocketæ•°æ®å¸§ç»“æ„ï¼ˆä¸éœ€è¦æ·±å…¥ï¼Œäº†è§£å³å¯ï¼‰ï¼š

 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-------+-+-------------+-------------------------------+
|F|R|R|R| opcode|M| Payload len |    Extended payload length    |
|I|S|S|S|  (4)  |A|     (7)     |             (16/64)           |
|N|V|V|V|       |S|             |   (if payload len==126/127)   |
| |1|2|3|       |K|             |                               |
+-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +

ç®€åŒ–ç†è§£ï¼š
ğŸ“Œ FINä½ï¼šæ˜¯å¦æ˜¯æœ€åä¸€ä¸ªåˆ†ç‰‡ï¼ˆ1=å®Œæ•´æ¶ˆæ¯ï¼Œ0=è¿˜æœ‰åç»­åˆ†ç‰‡ï¼‰
ğŸ“Œ opcodeï¼šæ•°æ®ç±»å‹ï¼ˆ1=æ–‡æœ¬ï¼Œ2=äºŒè¿›åˆ¶ï¼Œ8=å…³é—­è¿æ¥ï¼‰
ğŸ“Œ MASKï¼šæ˜¯å¦åŠ å¯†ï¼ˆå®¢æˆ·ç«¯åˆ°æœåŠ¡å™¨å¿…é¡»åŠ å¯†ï¼‰
ğŸ“Œ Payload lengthï¼šæ•°æ®é•¿åº¦
ğŸ“Œ Payload dataï¼šå®é™…æ•°æ®å†…å®¹
```

## 5.3 ä¸åŒç±»å‹æ¶ˆæ¯çš„å¸§ç¤ºä¾‹



```javascript
// ğŸ”¸ è¿™äº›ç»†èŠ‚æµè§ˆå™¨ä¼šè‡ªåŠ¨å¤„ç†ï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“æ¦‚å¿µ

// æ–‡æœ¬æ¶ˆæ¯å¸§
socket.send('Hello');
// æµè§ˆå™¨è‡ªåŠ¨åˆ›å»ºï¼š
// FIN=1, opcode=1(æ–‡æœ¬), æ•°æ®='Hello'

// äºŒè¿›åˆ¶æ¶ˆæ¯å¸§  
const buffer = new ArrayBuffer(8);
socket.send(buffer);
// æµè§ˆå™¨è‡ªåŠ¨åˆ›å»ºï¼š
// FIN=1, opcode=2(äºŒè¿›åˆ¶), æ•°æ®=bufferå†…å®¹

// Pingå¸§ï¼ˆå¿ƒè·³æ£€æµ‹ï¼‰
// æµè§ˆå™¨è‡ªåŠ¨å‘é€ï¼š
// FIN=1, opcode=9(ping)

// Pongå¸§ï¼ˆå¿ƒè·³å“åº”ï¼‰
// æµè§ˆå™¨è‡ªåŠ¨å“åº”ï¼š
// FIN=1, opcode=10(pong)
```

**ğŸ¯ é‡ç‚¹ç†è§£ï¼š**
- æˆ‘ä»¬**ä¸éœ€è¦æ‰‹åŠ¨æ„å»ºå¸§**ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨å¤„ç†
- åªéœ€è¦çŸ¥é“ä¸åŒæ•°æ®ç±»å‹å¯¹åº”ä¸åŒçš„å¸§ç±»å‹
- ä¸»è¦å…³æ³¨**åº”ç”¨å±‚çš„æ¶ˆæ¯æ ¼å¼**è®¾è®¡

---

# 6. âš¡ æ¶ˆæ¯å¤§å°é™åˆ¶ä¸ä¼˜åŒ–



## 6.1 æ¶ˆæ¯å¤§å°é™åˆ¶äº†è§£



**ğŸ”¸ å„å±‚é¢çš„é™åˆ¶ï¼š**

| é™åˆ¶å±‚é¢ | å…¸å‹é™åˆ¶ | å½±å“ |
|----------|----------|------|
| **æµè§ˆå™¨** | æ— æ˜ç¡®é™åˆ¶ï¼Œä½†å—å†…å­˜å½±å“ | å¤§æ¶ˆæ¯å¯èƒ½å¯¼è‡´é¡µé¢å¡é¡¿ |
| **æœåŠ¡å™¨** | é€šå¸¸1MB-16MB | ç”±æœåŠ¡å™¨é…ç½®å†³å®š |
| **ç½‘ç»œ** | å—ç½‘ç»œMTUå½±å“ | å¤§æ¶ˆæ¯ä¼šè‡ªåŠ¨åˆ†ç‰‡ |
| **åº”ç”¨å±‚** | å»ºè®®å•æ¶ˆæ¯<1MB | ç”¨æˆ·ä½“éªŒè€ƒè™‘ |

```javascript
// ğŸ“ æ¶ˆæ¯å¤§å°æ£€æµ‹å·¥å…·
class MessageSizeManager {
    
    static getMessageSize(data) {
        if (typeof data === 'string') {
            // å­—ç¬¦ä¸²å¤§å°ï¼ˆUTF-8ç¼–ç ï¼‰
            return new Blob([data]).size;
        } else if (data instanceof ArrayBuffer) {
            return data.byteLength;
        } else if (data instanceof Blob) {
            return data.size;
        } else {
            // JSONå¯¹è±¡å¤§å°
            return new Blob([JSON.stringify(data)]).size;
        }
    }
    
    static formatSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }
    
    static checkSize(data, maxSize = 1024 * 1024) { // é»˜è®¤1MB
        const size = this.getMessageSize(data);
        return {
            size: size,
            sizeFormatted: this.formatSize(size),
            isValid: size <= maxSize,
            maxSize: this.formatSize(maxSize)
        };
    }
}

// ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹
const message = {
    type: 'chat',
    content: 'ä½ å¥½'.repeat(1000), // é‡å¤1000æ¬¡
    sender: 'user123',
    timestamp: Date.now()
};

const sizeInfo = MessageSizeManager.checkSize(message);
console.log('æ¶ˆæ¯å¤§å°ï¼š', sizeInfo);
// è¾“å‡ºï¼š{size: 3024, sizeFormatted: "2.95 KB", isValid: true, maxSize: "1.0 MB"}
```

## 6.2 å¤§æ¶ˆæ¯ä¼˜åŒ–ç­–ç•¥



### 6.2.1 æ¶ˆæ¯åˆ†ç‰‡å‘é€



```javascript
// ğŸ“¦ å¤§æ¶ˆæ¯åˆ†ç‰‡å·¥å…·
class MessageChunker {
    
    static chunkMessage(data, chunkSize = 64 * 1024) { // 64KBä¸€ç‰‡
        const messageId = Date.now() + '_' + Math.random().toString(36).substr(2);
        const serialized = JSON.stringify(data);
        const chunks = [];
        
        // è®¡ç®—åˆ†ç‰‡
        for (let i = 0; i < serialized.length; i += chunkSize) {
            const chunk = serialized.slice(i, i + chunkSize);
            chunks.push({
                type: 'chunk',
                messageId: messageId,
                chunkIndex: chunks.length,
                totalChunks: Math.ceil(serialized.length / chunkSize),
                data: chunk,
                isLast: i + chunkSize >= serialized.length
            });
        }
        
        return chunks;
    }
    
    static reassembleMessage(chunks) {
        // æŒ‰é¡ºåºæ’åˆ—åˆ†ç‰‡
        chunks.sort((a, b) => a.chunkIndex - b.chunkIndex);
        
        // æ‹¼æ¥æ•°æ®
        const fullData = chunks.map(chunk => chunk.data).join('');
        
        // è§£æåŸå§‹æ¶ˆæ¯
        return JSON.parse(fullData);
    }
}

// ğŸš€ åˆ†ç‰‡å‘é€ç¤ºä¾‹
function sendLargeMessage(socket, data) {
    const sizeCheck = MessageSizeManager.checkSize(data);
    
    if (sizeCheck.isValid) {
        // ç›´æ¥å‘é€å°æ¶ˆæ¯
        socket.send(JSON.stringify(data));
    } else {
        // åˆ†ç‰‡å‘é€å¤§æ¶ˆæ¯
        const chunks = MessageChunker.chunkMessage(data);
        console.log(`å¤§æ¶ˆæ¯åˆ†æˆ${chunks.length}ç‰‡å‘é€`);
        
        chunks.forEach((chunk, index) => {
            setTimeout(() => {
                socket.send(JSON.stringify(chunk));
            }, index * 50); // 50msé—´éš”å‘é€
        });
    }
}
```

### 6.2.2 æ¶ˆæ¯å‹ç¼©ä¼˜åŒ–



```javascript
// ğŸ—œï¸ æ¶ˆæ¯å‹ç¼©å·¥å…·ï¼ˆç®€åŒ–ç‰ˆï¼‰
class MessageCompressor {
    
    // ç®€å•çš„é‡å¤å­—ç¬¦å‹ç¼©
    static compress(text) {
        return text.replace(/(.)\1+/g, (match, char) => {
            return char + '{' + match.length + '}';
        });
    }
    
    // è§£å‹ç¼©
    static decompress(compressedText) {
        return compressedText.replace(/(.)\{(\d+)\}/g, (match, char, count) => {
            return char.repeat(parseInt(count));
        });
    }
    
    // å‹ç¼©JSONæ•°æ®
    static compressJson(obj) {
        const jsonString = JSON.stringify(obj);
        const compressed = this.compress(jsonString);
        
        return {
            original: jsonString,
            compressed: compressed,
            ratio: (compressed.length / jsonString.length * 100).toFixed(1) + '%'
        };
    }
}

// ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹
const repetitiveData = {
    type: 'bulk_data',
    content: 'A'.repeat(1000) + 'B'.repeat(500),
    sender: 'user123'
};

const compressed = MessageCompressor.compressJson(repetitiveData);
console.log('å‹ç¼©æ•ˆæœï¼š', compressed);
// åŸå§‹å¤§å° vs å‹ç¼©åå¤§å°
```

---

# 7. ğŸ­ å¤šç§ç±»å‹æ¶ˆæ¯å¤„ç†å®è·µ



## 7.1 æ¶ˆæ¯å¤„ç†å™¨æ¶æ„è®¾è®¡



```javascript
// ğŸ—ï¸ æ¶ˆæ¯å¤„ç†å™¨åŸºç±»
class MessageHandler {
    
    constructor() {
        this.handlers = new Map();
        this.setupDefaultHandlers();
    }
    
    // ğŸ“ æ³¨å†Œæ¶ˆæ¯å¤„ç†å™¨
    register(type, handler) {
        this.handlers.set(type, handler);
    }
    
    // ğŸ“¨ å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯
    handle(message) {
        try {
            const handler = this.handlers.get(message.type);
            if (handler) {
                handler(message);
            } else {
                console.warn('æœªçŸ¥æ¶ˆæ¯ç±»å‹ï¼š', message.type);
                this.handleUnknown(message);
            }
        } catch (error) {
            console.error('æ¶ˆæ¯å¤„ç†å¤±è´¥ï¼š', error);
        }
    }
    
    // ğŸ”§ è®¾ç½®é»˜è®¤å¤„ç†å™¨
    setupDefaultHandlers() {
        // æ–‡æœ¬æ¶ˆæ¯å¤„ç†å™¨
        this.register('chat', (message) => {
            this.displayChatMessage(message);
        });
        
        // ç³»ç»Ÿé€šçŸ¥å¤„ç†å™¨
        this.register('system_notice', (message) => {
            this.showSystemNotice(message);
        });
        
        // ç”¨æˆ·çŠ¶æ€å¤„ç†å™¨
        this.register('user_status', (message) => {
            this.updateUserStatus(message);
        });
        
        // å¿ƒè·³å¤„ç†å™¨
        this.register('heartbeat', (message) => {
            this.handleHeartbeat(message);
        });
    }
    
    // ğŸ’¬ æ˜¾ç¤ºèŠå¤©æ¶ˆæ¯
    displayChatMessage(message) {
        const chatArea = document.getElementById('chat-messages');
        const messageElement = document.createElement('div');
        messageElement.className = 'chat-message';
        messageElement.innerHTML = `
            <div class="message-header">
                <span class="sender">${message.sender}</span>
                <span class="time">${this.formatTime(message.timestamp)}</span>
            </div>
            <div class="message-content">${message.content.text}</div>
        `;
        chatArea.appendChild(messageElement);
        chatArea.scrollTop = chatArea.scrollHeight;
    }
    
    // ğŸ“¢ æ˜¾ç¤ºç³»ç»Ÿé€šçŸ¥
    showSystemNotice(message) {
        const notice = document.createElement('div');
        notice.className = `system-notice notice-${message.content.level}`;
        notice.innerHTML = `
            <strong>${message.content.title}</strong>
            <p>${message.content.message}</p>
        `;
        
        document.body.appendChild(notice);
        
        // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
        setTimeout(() => {
            notice.remove();
        }, 3000);
    }
    
    // ğŸ‘¥ æ›´æ–°ç”¨æˆ·çŠ¶æ€
    updateUserStatus(message) {
        const userList = document.getElementById('user-list');
        const userId = message.content.userId;
        const status = message.content.status; // online, offline, away
        
        const userElement = userList.querySelector(`[data-user-id="${userId}"]`);
        if (userElement) {
            userElement.className = `user-item status-${status}`;
        }
    }
    
    // ğŸ’“ å¤„ç†å¿ƒè·³
    handleHeartbeat(message) {
        // å›åº”å¿ƒè·³
        if (this.socket && this.socket.readyState === WebSocket.OPEN) {
            this.socket.send(JSON.stringify({
                type: 'heartbeat_response',
                timestamp: Date.now()
            }));
        }
    }
    
    // â“ å¤„ç†æœªçŸ¥æ¶ˆæ¯
    handleUnknown(message) {
        console.log('æ”¶åˆ°æœªçŸ¥æ¶ˆæ¯ï¼š', message);
    }
    
    // â° æ—¶é—´æ ¼å¼åŒ–
    formatTime(timestamp) {
        return new Date(timestamp).toLocaleTimeString();
    }
}
```

## 7.2 ä¸åŒç±»å‹æ¶ˆæ¯çš„å®é™…åº”ç”¨



### 7.2.1 èŠå¤©æ¶ˆæ¯å¤„ç†



```javascript
// ğŸ’¬ èŠå¤©æ¶ˆæ¯çš„å®Œæ•´å¤„ç†
class ChatMessageHandler extends MessageHandler {
    
    constructor() {
        super();
        this.setupChatHandlers();
    }
    
    setupChatHandlers() {
        // æ™®é€šèŠå¤©
        this.register('chat', (message) => {
            this.handleChatMessage(message);
        });
        
        // ç§èŠæ¶ˆæ¯
        this.register('private_chat', (message) => {
            this.handlePrivateMessage(message);
        });
        
        // å›¾ç‰‡æ¶ˆæ¯
        this.register('image', (message) => {
            this.handleImageMessage(message);
        });
        
        // æ–‡ä»¶æ¶ˆæ¯
        this.register('file', (message) => {
            this.handleFileMessage(message);
        });
    }
    
    handleChatMessage(message) {
        const messageDiv = this.createMessageElement({
            type: 'chat',
            sender: message.sender,
            content: message.content.text,
            timestamp: message.timestamp,
            mentions: message.content.mentions || []
        });
        
        this.appendToChat(messageDiv);
        this.highlightMentions(messageDiv, message.content.mentions);
    }
    
    handleImageMessage(message) {
        const messageDiv = this.createMessageElement({
            type: 'image',
            sender: message.sender,
            timestamp: message.timestamp
        });
        
        const img = document.createElement('img');
        img.src = message.content.thumbnail || message.content.url;
        img.alt = 'å›¾ç‰‡æ¶ˆæ¯';
        img.className = 'chat-image';
        
        // ç‚¹å‡»æŸ¥çœ‹å¤§å›¾
        img.onclick = () => {
            this.showImageModal(message.content.url);
        };
        
        messageDiv.querySelector('.message-content').appendChild(img);
        this.appendToChat(messageDiv);
    }
    
    createMessageElement(data) {
        const div = document.createElement('div');
        div.className = `message message-${data.type}`;
        div.innerHTML = `
            <div class="message-header">
                <span class="sender">${data.sender}</span>
                <span class="timestamp">${this.formatTime(data.timestamp)}</span>
            </div>
            <div class="message-content">${data.content || ''}</div>
        `;
        return div;
    }
}
```

### 7.2.2 ç³»ç»Ÿæ¶ˆæ¯å¤„ç†



```javascript
// ğŸ“¢ ç³»ç»Ÿæ¶ˆæ¯å¤„ç†å™¨
class SystemMessageHandler {
    
    static handleUserJoin(message) {
        const notification = `ğŸ‰ ${message.content.username} åŠ å…¥äº†èŠå¤©å®¤`;
        this.showToast(notification, 'success');
        this.updateUserList('add', message.content);
    }
    
    static handleUserLeave(message) {
        const notification = `ğŸ‘‹ ${message.content.username} ç¦»å¼€äº†èŠå¤©å®¤`;
        this.showToast(notification, 'info');
        this.updateUserList('remove', message.content);
    }
    
    static handleSystemMaintenance(message) {
        const modal = document.createElement('div');
        modal.className = 'maintenance-modal';
        modal.innerHTML = `
            <div class="modal-content">
                <h3>ğŸ”§ ${message.content.title}</h3>
                <p>${message.content.message}</p>
                <p>é¢„è®¡ç»´æŠ¤æ—¶é—´ï¼š${message.content.duration}</p>
                <button onclick="this.parentElement.parentElement.remove()">
                    æˆ‘çŸ¥é“äº†
                </button>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    static showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        
        document.body.appendChild(toast);
        
        // åŠ¨ç”»æ˜¾ç¤º
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
}
```

## 7.3 æ¶ˆæ¯ç±»å‹è·¯ç”±è¡¨



```javascript
// ğŸ—ºï¸ æ¶ˆæ¯è·¯ç”±é…ç½®
const MessageRoutes = {
    // èŠå¤©ç±»æ¶ˆæ¯
    'chat': ChatMessageHandler.handleChat,
    'private_chat': ChatMessageHandler.handlePrivateChat,
    'group_chat': ChatMessageHandler.handleGroupChat,
    
    // å¤šåª’ä½“æ¶ˆæ¯
    'image': MediaHandler.handleImage,
    'video': MediaHandler.handleVideo,
    'audio': MediaHandler.handleAudio,
    'file': MediaHandler.handleFile,
    
    // ç³»ç»Ÿæ¶ˆæ¯
    'user_join': SystemMessageHandler.handleUserJoin,
    'user_leave': SystemMessageHandler.handleUserLeave,
    'system_notice': SystemMessageHandler.handleSystemNotice,
    'maintenance': SystemMessageHandler.handleMaintenance,
    
    // çŠ¶æ€æ¶ˆæ¯
    'typing': StatusHandler.handleTyping,
    'online': StatusHandler.handleOnline,
    'offline': StatusHandler.handleOffline,
    
    // æ§åˆ¶æ¶ˆæ¯
    'heartbeat': ControlHandler.handleHeartbeat,
    'reconnect': ControlHandler.handleReconnect,
    'error': ControlHandler.handleError
};

// ğŸš€ ç»Ÿä¸€æ¶ˆæ¯åˆ†å‘å™¨
class MessageDispatcher {
    static dispatch(message) {
        const handler = MessageRoutes[message.type];
        if (handler) {
            handler(message);
        } else {
            console.warn(`æœªæ‰¾åˆ°æ¶ˆæ¯ç±»å‹ "${message.type}" çš„å¤„ç†å™¨`);
        }
    }
}
```

---

# 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“



## 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ



```
ğŸ”¸ æ•°æ®ç±»å‹ç†è§£ï¼šæ–‡æœ¬(å­—ç¬¦ä¸²) vs äºŒè¿›åˆ¶(ArrayBuffer/Blob)
ğŸ”¸ JSONä¼ è¾“ï¼šå¯¹è±¡â†”å­—ç¬¦ä¸²çš„åºåˆ—åŒ–/ååºåˆ—åŒ–è¿‡ç¨‹
ğŸ”¸ æ¶ˆæ¯ç»“æ„ï¼štype + content + sender + timestampçš„æ ‡å‡†æ ¼å¼  
ğŸ”¸ å¤§å°é™åˆ¶ï¼šäº†è§£é™åˆ¶ï¼ŒæŒæ¡åˆ†ç‰‡å’Œå‹ç¼©ä¼˜åŒ–æ–¹æ¡ˆ
ğŸ”¸ ç±»å‹å¤„ç†ï¼šä¸åŒæ¶ˆæ¯ç±»å‹éœ€è¦ä¸åŒçš„å¤„ç†é€»è¾‘
```

## 8.2 å…³é”®ç†è§£è¦ç‚¹



**ğŸ”¹ ä¸ºä»€ä¹ˆéœ€è¦æ ‡å‡†åŒ–æ¶ˆæ¯æ ¼å¼ï¼Ÿ**
```
ç»Ÿä¸€æ€§ â†’ æ‰€æœ‰æ¶ˆæ¯éµå¾ªç›¸åŒç»“æ„ï¼Œä¾¿äºå¤„ç†
æ‰©å±•æ€§ â†’ æ–°å¢å­—æ®µä¸å½±å“ç°æœ‰åŠŸèƒ½  
ç»´æŠ¤æ€§ â†’ ä»£ç æ¸…æ™°ï¼ŒBugå®¹æ˜“å®šä½
åä½œæ€§ â†’ å›¢é˜Ÿæˆå‘˜éƒ½èƒ½ç†è§£æ¶ˆæ¯ç»“æ„
```

**ğŸ”¹ JSON vs äºŒè¿›åˆ¶æ•°æ®çš„é€‰æ‹©ï¼Ÿ**
```
JSONé€‚ç”¨åœºæ™¯ï¼š
âœ… èŠå¤©æ–‡æœ¬ã€ç³»ç»Ÿé€šçŸ¥ã€çŠ¶æ€æ›´æ–°
âœ… éœ€è¦äººç±»å¯è¯»çš„è°ƒè¯•ä¿¡æ¯
âœ… ç»“æ„åŒ–æ•°æ®ä¼ è¾“

äºŒè¿›åˆ¶é€‚ç”¨åœºæ™¯ï¼š
âœ… å›¾ç‰‡ã€éŸ³é¢‘ã€è§†é¢‘æ–‡ä»¶
âœ… å¤§æ•°æ®é‡ä¼ è¾“
âœ… å¯¹ä¼ è¾“æ•ˆç‡è¦æ±‚é«˜çš„åœºæ™¯
```

**ğŸ”¹ æ¶ˆæ¯å¤§å°ä¼˜åŒ–çš„æ ¸å¿ƒæ€è·¯ï¼Ÿ**
```
é¢„é˜²ä¸ºä¸»ï¼šè®¾è®¡æ—¶æ§åˆ¶æ¶ˆæ¯å¤§å°
ç›‘æ§æ£€æµ‹ï¼šå®æ—¶ç›‘æµ‹æ¶ˆæ¯å¤§å°
åˆ†ç‰‡å¤„ç†ï¼šå¤§æ¶ˆæ¯è‡ªåŠ¨åˆ†ç‰‡ä¼ è¾“
å‹ç¼©ä¼˜åŒ–ï¼šé‡å¤æ•°æ®è¿›è¡Œå‹ç¼©
```

## 8.3 å®é™…åº”ç”¨å»ºè®®



**ğŸ’¡ æ¶ˆæ¯æ ¼å¼è®¾è®¡åŸåˆ™ï¼š**
- **ä¸€è‡´æ€§**ï¼šæ‰€æœ‰æ¶ˆæ¯ä½¿ç”¨ç›¸åŒçš„åŸºç¡€ç»“æ„
- **å¯æ‰©å±•**ï¼šé¢„ç•™æ‰©å±•å­—æ®µï¼Œä¾¿äºåŠŸèƒ½å‡çº§
- **ç±»å‹æ˜ç¡®**ï¼štypeå­—æ®µå¿…é¡»æ¸…æ™°è¡¨è¾¾æ¶ˆæ¯ç”¨é€”
- **å¤§å°å¯æ§**ï¼šå•ä¸ªæ¶ˆæ¯å»ºè®®ä¸è¶…è¿‡1MB

**ğŸ”§ ä»£ç å®ç°å»ºè®®ï¼š**
- **å·¥å…·ç±»å°è£…**ï¼šåˆ›å»ºMessageBuilderã€MessageHandlerç­‰å·¥å…·ç±»
- **é”™è¯¯å¤„ç†**ï¼šåºåˆ—åŒ–/ååºåˆ—åŒ–å¿…é¡»æœ‰é”™è¯¯å¤„ç†
- **ç±»å‹æ£€æŸ¥**ï¼šæ¥æ”¶æ¶ˆæ¯æ—¶éªŒè¯å¿…è¦å­—æ®µ
- **æ€§èƒ½ç›‘æ§**ï¼šè®°å½•æ¶ˆæ¯å¤§å°å’Œå¤„ç†æ—¶é—´

**ğŸš€ æ€§èƒ½ä¼˜åŒ–è¦ç‚¹ï¼š**
- **åˆç†ä½¿ç”¨JSON**ï¼šç®€å•æ•°æ®ç”¨JSONï¼Œå¤æ‚æ•°æ®è€ƒè™‘äºŒè¿›åˆ¶
- **æ¶ˆæ¯æ‰¹å¤„ç†**ï¼šå¤šä¸ªå°æ¶ˆæ¯å¯ä»¥åˆå¹¶å‘é€
- **ç¼“å­˜å¸¸ç”¨æ•°æ®**ï¼šé¿å…é‡å¤åºåˆ—åŒ–ç›¸åŒå†…å®¹
- **å¼‚æ­¥å¤„ç†**ï¼šå¤§æ¶ˆæ¯å¤„ç†ä¸è¦é˜»å¡UIçº¿ç¨‹

## 8.4 å¸¸è§é—®é¢˜è§£å†³



| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| **JSONè§£æå¤±è´¥** | æ•°æ®æ ¼å¼é”™è¯¯æˆ–åŒ…å«ç‰¹æ®Šå­—ç¬¦ | ä½¿ç”¨try-catchï¼ŒéªŒè¯æ•°æ®æ ¼å¼ |
| **æ¶ˆæ¯ä¸¢å¤±** | æ¶ˆæ¯è¿‡å¤§æˆ–ç½‘ç»œé—®é¢˜ | å®ç°æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼Œæ”¯æŒé‡å‘ |
| **ç±»å‹æ··ä¹±** | æ²¡æœ‰ç»Ÿä¸€çš„æ¶ˆæ¯æ ¼å¼ | åˆ¶å®šæ¶ˆæ¯è§„èŒƒï¼Œå¼ºåˆ¶ç±»å‹æ£€æŸ¥ |
| **æ€§èƒ½å¡é¡¿** | æ¶ˆæ¯è¿‡å¤§æˆ–å¤„ç†é€»è¾‘å¤æ‚ | åˆ†ç‰‡ä¼ è¾“ï¼Œå¼‚æ­¥å¤„ç† |

**ğŸ¯ æ ¸å¿ƒè®°å¿†ï¼š**
- WebSocketæ”¯æŒæ–‡æœ¬å’ŒäºŒè¿›åˆ¶ä¸¤å¤§ç±»æ•°æ®
- JSONæ˜¯æœ€å¸¸ç”¨çš„ç»“æ„åŒ–æ•°æ®ä¼ è¾“æ ¼å¼  
- æ ‡å‡†æ¶ˆæ¯æ ¼å¼ï¼štype + content + sender + timestamp
- å¤§æ¶ˆæ¯éœ€è¦åˆ†ç‰‡å¤„ç†å’Œä¼˜åŒ–ç­–ç•¥
- ä¸åŒç±»å‹æ¶ˆæ¯éœ€è¦å¯¹åº”çš„å¤„ç†å™¨
- åºåˆ—åŒ–å®‰å…¨å’Œé”™è¯¯å¤„ç†å¾ˆé‡è¦