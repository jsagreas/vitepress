---
title: 3ã€Optionalç±»
---
## ğŸ“š ç›®å½•

1. [OptionalåŸºç¡€æ¦‚å¿µ](#1-OptionalåŸºç¡€æ¦‚å¿µ)
2. [Optionalæ ¸å¿ƒæ–¹æ³•](#2-Optionalæ ¸å¿ƒæ–¹æ³•)
3. [Optionalæœ€ä½³å®è·µ](#3-Optionalæœ€ä½³å®è·µ)

---

## 1. ğŸ’ OptionalåŸºç¡€æ¦‚å¿µ


### 1.1 Optionalæ˜¯ä»€ä¹ˆï¼Ÿè§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ


**ğŸ˜± ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼šç¨‹åºå‘˜çš„å™©æ¢¦**

```java
// ä¼ ç»Ÿæ–¹å¼ï¼šåˆ°å¤„éƒ½æ˜¯ç©ºæŒ‡é’ˆé™·é˜±
public class TraditionalWay {
    public static void main(String[] args) {
        String name = getName();  // å¯èƒ½è¿”å›null
        
        // âŒ å±é™©ï¼šæ²¡æ£€æŸ¥nullå°±ä½¿ç”¨
        System.out.println(name.length());  // ğŸ’¥ NullPointerException!
        
        // âœ… å®‰å…¨ï¼šä½†ä»£ç å¾ˆå•°å—¦
        if (name != null) {
            System.out.println("å§“åé•¿åº¦ï¼š" + name.length());
        } else {
            System.out.println("å§“åä¸ºç©º");
        }
    }
    
    // è¿™ä¸ªæ–¹æ³•å¯èƒ½è¿”å›nullï¼Œä½†ä»æ–¹æ³•ç­¾åçœ‹ä¸å‡ºæ¥
    public static String getName() {
        // æ¨¡æ‹Ÿï¼šæœ‰æ—¶æœ‰æ•°æ®ï¼Œæœ‰æ—¶æ²¡æ•°æ®
        return Math.random() > 0.5 ? "å¼ ä¸‰" : null;
    }
}
```

**ğŸ’¡ Optionalï¼šä¼˜é›…çš„è§£å†³æ–¹æ¡ˆ**

```java
// Optionalæ–¹å¼ï¼šæ˜ç¡®è¡¨ç¤º"å¯èƒ½æœ‰å€¼ï¼Œä¹Ÿå¯èƒ½æ²¡æœ‰"
public class OptionalWay {
    public static void main(String[] args) {
        Optional<String> nameOpt = getName();  // æ˜ç¡®å‘Šè¯‰ä½ ï¼šå¯èƒ½æ²¡æœ‰å€¼
        
        // å„ç§å®‰å…¨çš„ä½¿ç”¨æ–¹å¼
        nameOpt.ifPresent(name -> System.out.println("å§“åé•¿åº¦ï¼š" + name.length()));
        
        String actualName = nameOpt.orElse("æ— åæ°");
        System.out.println("å®é™…å§“åï¼š" + actualName);
    }
    
    // ä»æ–¹æ³•ç­¾åå°±èƒ½çœ‹å‡ºï¼šå¯èƒ½è¿”å›ç©º
    public static Optional<String> getName() {
        return Math.random() > 0.5 ? 
            Optional.of("å¼ ä¸‰") :      // æœ‰å€¼
            Optional.empty();         // æ²¡å€¼
    }
}
```

**ğŸ¯ Optionalçš„æ ¸å¿ƒä»·å€¼ï¼š**
```
1. æ˜ç¡®è¡¨è¾¾"å¯èƒ½ä¸ºç©º" - ä»æ–¹æ³•ç­¾åå°±èƒ½çœ‹å‡ºæ¥
2. å¼ºåˆ¶å¤„ç†ç©ºå€¼æƒ…å†µ - ç¼–è¯‘å™¨å¸®ä½ æ£€æŸ¥
3. é“¾å¼è°ƒç”¨æ›´ä¼˜é›… - é¿å…å¤§é‡if-elseåµŒå¥—
4. å‡å°‘ç©ºæŒ‡é’ˆå¼‚å¸¸ - ä»æ ¹æºä¸Šè§£å†³é—®é¢˜
```

### 1.2 Optionalæ˜¯ä»€ä¹ˆï¼šå®¹å™¨çš„æ¦‚å¿µ


**ğŸ“¦ Optionalå°±åƒä¸€ä¸ªç›’å­**

```java
// Optionalå°±åƒä¸€ä¸ªç‰¹æ®Šçš„ç›’å­ï¼Œé‡Œé¢è¦ä¹ˆæœ‰ä¸œè¥¿ï¼Œè¦ä¹ˆæ˜¯ç©ºçš„

// ç©ºç›’å­
Optional<String> emptyBox = Optional.empty();
System.out.println("ç©ºç›’å­ï¼š" + emptyBox);  // Optional.empty

// æœ‰ä¸œè¥¿çš„ç›’å­
Optional<String> fullBox = Optional.of("è‹¹æœ");
System.out.println("æœ‰ä¸œè¥¿çš„ç›’å­ï¼š" + fullBox);  // Optional[è‹¹æœ]

// å¯èƒ½æœ‰ä¸œè¥¿çš„ç›’å­ï¼ˆå¦‚æœä¼ å…¥nullå°±æ˜¯ç©ºç›’å­ï¼‰
Optional<String> maybeBox = Optional.ofNullable(null);
System.out.println("å¯èƒ½çš„ç›’å­ï¼š" + maybeBox);  // Optional.empty

// æ£€æŸ¥ç›’å­é‡Œæœ‰æ²¡æœ‰ä¸œè¥¿
System.out.println("ç©ºç›’å­æœ‰ä¸œè¥¿å—ï¼š" + emptyBox.isPresent());    // false
System.out.println("æ»¡ç›’å­æœ‰ä¸œè¥¿å—ï¼š" + fullBox.isPresent());     // true
System.out.println("ç©ºç›’å­æ˜¯ç©ºçš„å—ï¼š" + emptyBox.isEmpty());      // trueï¼ˆJava 11+ï¼‰
```

**ğŸ’¡ åˆ›å»ºOptionalçš„ä¸‰ç§æ–¹å¼ï¼š**

```java
// æ–¹å¼1ï¼šOptional.of() - æ˜ç¡®çŸ¥é“æœ‰å€¼ï¼ˆå€¼ä¸èƒ½ä¸ºnullï¼‰
Optional<String> opt1 = Optional.of("Hello");
// Optional<String> opt1 = Optional.of(null);  // ğŸ’¥ æŠ›å¼‚å¸¸ï¼

// æ–¹å¼2ï¼šOptional.empty() - æ˜ç¡®çŸ¥é“æ²¡å€¼
Optional<String> opt2 = Optional.empty();

// æ–¹å¼3ï¼šOptional.ofNullable() - ä¸ç¡®å®šæ˜¯å¦æœ‰å€¼ï¼ˆæœ€å¸¸ç”¨ï¼‰
String possibleNull = Math.random() > 0.5 ? "æœ‰å€¼" : null;
Optional<String> opt3 = Optional.ofNullable(possibleNull);  // å®‰å…¨çš„åˆ›å»ºæ–¹å¼
```

### 1.3 ä¸ºä»€ä¹ˆéœ€è¦Optionalï¼šå¯¹æ¯”ä¼ ç»Ÿæ–¹å¼


**ğŸ” æŸ¥æ‰¾ç”¨æˆ·çš„çœŸå®åœºæ™¯å¯¹æ¯”**

```java
// ç”¨æˆ·ç±»
class User {
    private String name;
    private String email;
    
    public User(String name, String email) {
        this.name = name;
        this.email = email;
    }
    
    public String getName() { return name; }
    public String getEmail() { return email; }
}

// ä¼ ç»Ÿæ–¹å¼ï¼šåˆ°å¤„éƒ½æ˜¯nullæ£€æŸ¥
class TraditionalUserService {
    private List<User> users = Arrays.asList(
        new User("å¼ ä¸‰", "zhangsan@email.com"),
        new User("æå››", "lisi@email.com")
    );
    
    // æ–¹æ³•1ï¼šè¿”å›nullï¼ˆå±é™©ï¼‰
    public User findUserByName(String name) {
        for (User user : users) {
            if (user.getName().equals(name)) {
                return user;
            }
        }
        return null;  // æ²¡æ‰¾åˆ°è¿”å›null
    }
    
    // ä½¿ç”¨æ—¶å¿…é¡»æ£€æŸ¥nullï¼ˆå®¹æ˜“å¿˜è®°ï¼‰
    public void printUserEmail(String name) {
        User user = findUserByName(name);
        if (user != null) {  // å¿…é¡»æ£€æŸ¥ï¼Œä½†å®¹æ˜“å¿˜è®°
            String email = user.getEmail();
            if (email != null) {  // åˆè¦æ£€æŸ¥email
                System.out.println("é‚®ç®±ï¼š" + email);
            } else {
                System.out.println("é‚®ç®±ä¸ºç©º");
            }
        } else {
            System.out.println("ç”¨æˆ·ä¸å­˜åœ¨");
        }
    }
}

// Optionalæ–¹å¼ï¼šä¼˜é›…å¤„ç†
class OptionalUserService {
    private List<User> users = Arrays.asList(
        new User("å¼ ä¸‰", "zhangsan@email.com"),
        new User("æå››", "lisi@email.com")
    );
    
    // æ–¹æ³•ç­¾åæ˜ç¡®è¡¨ç¤ºï¼šå¯èƒ½æ‰¾ä¸åˆ°ç”¨æˆ·
    public Optional<User> findUserByName(String name) {
        return users.stream()
            .filter(user -> user.getName().equals(name))
            .findFirst();  // è¿”å›Optional<User>
    }
    
    // ä½¿ç”¨æ—¶å¼ºåˆ¶å¤„ç†"æ²¡æ‰¾åˆ°"çš„æƒ…å†µ
    public void printUserEmail(String name) {
        findUserByName(name)
            .map(User::getEmail)                     // å¦‚æœæœ‰ç”¨æˆ·ï¼Œå–é‚®ç®±
            .ifPresentOrElse(                        // Java 9+
                email -> System.out.println("é‚®ç®±ï¼š" + email),    // æœ‰é‚®ç®±æ—¶
                () -> System.out.println("ç”¨æˆ·ä¸å­˜åœ¨æˆ–é‚®ç®±ä¸ºç©º")     // æ²¡æœ‰æ—¶
            );
    }
    
    // æˆ–è€…æ›´ç®€å•çš„å¤„ç†
    public void printUserEmail2(String name) {
        String result = findUserByName(name)
            .map(User::getEmail)
            .orElse("ç”¨æˆ·ä¸å­˜åœ¨");
        System.out.println(result);
    }
}
```

---

## 2. ğŸ”§ Optionalæ ¸å¿ƒæ–¹æ³•


### 2.1 åˆ›å»ºOptionalï¼šä¸‰ç§æ–¹å¼


**ğŸ—ï¸ å¦‚ä½•åˆ›å»ºOptionalå¯¹è±¡**

```java
// 1. Optional.of() - ç¡®å®šæœ‰å€¼æ—¶ä½¿ç”¨
Optional<String> certain = Optional.of("ç¡®å®šæœ‰å€¼");
System.out.println(certain);  // Optional[ç¡®å®šæœ‰å€¼]

// æ³¨æ„ï¼šä¸èƒ½ä¼ nullç»™of()
try {
    Optional<String> willFail = Optional.of(null);  // ğŸ’¥ æŠ›å‡ºå¼‚å¸¸
} catch (NullPointerException e) {
    System.out.println("of()ä¸èƒ½æ¥å—null");
}

// 2. Optional.empty() - ç¡®å®šæ²¡å€¼æ—¶ä½¿ç”¨
Optional<String> empty = Optional.empty();
System.out.println(empty);  // Optional.empty

// 3. Optional.ofNullable() - ä¸ç¡®å®šæ—¶ä½¿ç”¨ï¼ˆæœ€å¸¸ç”¨ï¼‰
String maybeNull = Math.random() > 0.5 ? "éšæœºå€¼" : null;
Optional<String> maybe = Optional.ofNullable(maybeNull);
System.out.println(maybe);  // å¯èƒ½æ˜¯Optional[éšæœºå€¼]æˆ–Optional.empty

// å®é™…ä½¿ç”¨åœºæ™¯
public Optional<String> getConfigValue(String key) {
    // ä»é…ç½®æ–‡ä»¶è¯»å–ï¼Œå¯èƒ½æ²¡æœ‰è¿™ä¸ªé…ç½®é¡¹
    String value = properties.getProperty(key);  // å¯èƒ½è¿”å›null
    return Optional.ofNullable(value);  // å®‰å…¨åŒ…è£…
}
```

### 2.2 æ£€æŸ¥å€¼çš„å­˜åœ¨ï¼šisPresent() å’Œ isEmpty()


**âœ… æ£€æŸ¥ç›’å­é‡Œæœ‰æ²¡æœ‰ä¸œè¥¿**

```java
Optional<String> full = Optional.of("æœ‰å†…å®¹");
Optional<String> empty = Optional.empty();

// isPresent() - æ£€æŸ¥æ˜¯å¦æœ‰å€¼
System.out.println("fullæœ‰å€¼å—ï¼š" + full.isPresent());    // true
System.out.println("emptyæœ‰å€¼å—ï¼š" + empty.isPresent());  // false

// isEmpty() - æ£€æŸ¥æ˜¯å¦ä¸ºç©ºï¼ˆJava 11å¼•å…¥ï¼‰
System.out.println("fullæ˜¯ç©ºå—ï¼š" + full.isEmpty());     // false
System.out.println("emptyæ˜¯ç©ºå—ï¼š" + empty.isEmpty());   // true

// ä¼ ç»Ÿçš„ä½¿ç”¨æ–¹å¼ï¼ˆä¸æ¨èï¼Œå¤±å»äº†Optionalçš„æ„ä¹‰ï¼‰
if (full.isPresent()) {
    String value = full.get();  // è·å–å€¼
    System.out.println("å€¼æ˜¯ï¼š" + value);
}

// æ›´ä¼˜é›…çš„æ–¹å¼ï¼ˆæ¨èï¼‰
full.ifPresent(value -> System.out.println("å€¼æ˜¯ï¼š" + value));
```

### 2.3 è·å–å€¼ï¼šget() å’Œå®‰å…¨çš„æ›¿ä»£æ–¹æ¡ˆ


**âš ï¸ get()æ–¹æ³•ï¼šå±é™©ä½†ç›´æ¥**

```java
Optional<String> full = Optional.of("æœ‰å€¼");
Optional<String> empty = Optional.empty();

// get() - ç›´æ¥è·å–å€¼ï¼ˆå±é™©ï¼ï¼‰
String value1 = full.get();  // æ­£å¸¸è·å–ï¼š"æœ‰å€¼"
System.out.println(value1);

try {
    String value2 = empty.get();  // ğŸ’¥ æŠ›å‡ºå¼‚å¸¸ï¼
} catch (NoSuchElementException e) {
    System.out.println("empty.get()æŠ›å‡ºå¼‚å¸¸ï¼š" + e.getMessage());
}

// ğŸ’¡ å»ºè®®ï¼šæ°¸è¿œä¸è¦ç›´æ¥ä½¿ç”¨get()ï¼Œé™¤éä½ ç¡®å®šæœ‰å€¼
// å¦‚æœä½ ç¡®å®šæœ‰å€¼ï¼Œä¸ºä»€ä¹ˆè¦ç”¨Optionalå‘¢ï¼Ÿ
```

**âœ… å®‰å…¨çš„è·å–å€¼æ–¹å¼**

```java
Optional<String> maybe = Optional.ofNullable(Math.random() > 0.5 ? "å¹¸è¿" : null);

// 1. orElse() - æä¾›é»˜è®¤å€¼
String result1 = maybe.orElse("é»˜è®¤å€¼");
System.out.println("ç»“æœ1ï¼š" + result1);  // è¦ä¹ˆæ˜¯"å¹¸è¿"ï¼Œè¦ä¹ˆæ˜¯"é»˜è®¤å€¼"

// 2. orElseGet() - æä¾›é»˜è®¤å€¼çš„ç”Ÿæˆå‡½æ•°
String result2 = maybe.orElseGet(() -> "ç”Ÿæˆçš„é»˜è®¤å€¼");
System.out.println("ç»“æœ2ï¼š" + result2);

// 3. orElseThrow() - æ²¡å€¼æ—¶æŠ›å‡ºå¼‚å¸¸
try {
    String result3 = maybe.orElseThrow(() -> new RuntimeException("æ²¡æœ‰å€¼ï¼"));
    System.out.println("ç»“æœ3ï¼š" + result3);
} catch (RuntimeException e) {
    System.out.println("æ•è·å¼‚å¸¸ï¼š" + e.getMessage());
}

// orElse vs orElseGet çš„åŒºåˆ«
Optional<String> hasValue = Optional.of("æœ‰å€¼");

// orElseï¼šæ— è®ºæ˜¯å¦æœ‰å€¼ï¼Œéƒ½ä¼šæ‰§è¡Œé»˜è®¤å€¼é€»è¾‘
String result4 = hasValue.orElse(expensiveOperation());  // expensiveOperationæ€»æ˜¯æ‰§è¡Œ

// orElseGetï¼šåªæœ‰æ²¡å€¼æ—¶æ‰æ‰§è¡Œ
String result5 = hasValue.orElseGet(() -> expensiveOperation());  // æœ‰å€¼æ—¶ä¸æ‰§è¡Œ

private static String expensiveOperation() {
    System.out.println("æ‰§è¡Œäº†æ˜‚è´µçš„æ“ä½œ");
    return "æ˜‚è´µçš„ç»“æœ";
}
```

### 2.4 æ¡ä»¶æ‰§è¡Œï¼šifPresent() å’Œ ifPresentOrElse()


**ğŸ¯ æœ‰å€¼æ—¶æ‰æ‰§è¡ŒæŸäº›æ“ä½œ**

```java
Optional<String> userName = Optional.ofNullable(getCurrentUserName());

// ifPresent() - æœ‰å€¼æ—¶æ‰§è¡Œ
userName.ifPresent(name -> {
    System.out.println("æ¬¢è¿ï¼Œ" + name);
    logUserActivity(name);
});

// ç›¸å½“äºä¼ ç»Ÿçš„ï¼š
if (userName.isPresent()) {
    String name = userName.get();
    System.out.println("æ¬¢è¿ï¼Œ" + name);
    logUserActivity(name);
}

// ifPresentOrElse() - æœ‰å€¼æ‰§è¡Œç¬¬ä¸€ä¸ªï¼Œæ²¡å€¼æ‰§è¡Œç¬¬äºŒä¸ªï¼ˆJava 9+ï¼‰
userName.ifPresentOrElse(
    name -> System.out.println("æ¬¢è¿ï¼Œ" + name),           // æœ‰å€¼æ—¶
    () -> System.out.println("è¯·å…ˆç™»å½•")                    // æ²¡å€¼æ—¶
);

// å®é™…åº”ç”¨ï¼šå¤„ç†ç”¨æˆ·å¤´åƒ
Optional<String> avatarUrl = getUserAvatarUrl();
avatarUrl.ifPresentOrElse(
    url -> displayAvatar(url),                    // æœ‰å¤´åƒå°±æ˜¾ç¤º
    () -> displayDefaultAvatar()                  // æ²¡å¤´åƒæ˜¾ç¤ºé»˜è®¤
);
```

### 2.5 è½¬æ¢æ“ä½œï¼šmap() å’Œ flatMap()


**ğŸ”„ å¯¹Optionalä¸­çš„å€¼è¿›è¡Œè½¬æ¢**

```java
// map() - è½¬æ¢Optionalä¸­çš„å€¼
Optional<String> name = Optional.of("å¼ ä¸‰");

// è½¬æ¢ï¼šå§“å â†’ å§“åé•¿åº¦
Optional<Integer> nameLength = name.map(String::length);
System.out.println("å§“åé•¿åº¦ï¼š" + nameLength.orElse(0));  // 2

// è½¬æ¢ï¼šå§“å â†’ é—®å€™è¯­
Optional<String> greeting = name.map(n -> "ä½ å¥½ï¼Œ" + n);
System.out.println(greeting.orElse("ä½ å¥½ï¼Œé™Œç”Ÿäºº"));  // ä½ å¥½ï¼Œå¼ ä¸‰

// é“¾å¼è½¬æ¢
Optional<String> upperGreeting = Optional.of("å¼ ä¸‰")
    .map(n -> "ä½ å¥½ï¼Œ" + n)      // String â†’ String  
    .map(String::toUpperCase);   // String â†’ String
System.out.println(upperGreeting.orElse(""));  // ä½ å¥½ï¼Œå¼ ä¸‰

// å¦‚æœOptionalæ˜¯ç©ºçš„ï¼Œmapä¸ä¼šæ‰§è¡Œ
Optional<String> empty = Optional.empty();
Optional<Integer> emptyLength = empty.map(String::length);  // ä¸ä¼šæ‰§è¡Œmap
System.out.println("ç©ºçš„é•¿åº¦ï¼š" + emptyLength.orElse(-1));  // -1
```

**ğŸ”— flatMap() - å¤„ç†åµŒå¥—Optional**

```java
// ç”¨æˆ·ä¿¡æ¯ç±»
class User {
    private String name;
    private Optional<String> email;  // é‚®ç®±å¯èƒ½æ²¡æœ‰
    
    public User(String name, String email) {
        this.name = name;
        this.email = Optional.ofNullable(email);
    }
    
    public String getName() { return name; }
    public Optional<String> getEmail() { return email; }
}

// ç”¨æˆ·æœåŠ¡
class UserService {
    public Optional<User> findUser(String name) {
        // æ¨¡æ‹ŸæŸ¥æ‰¾ç”¨æˆ·
        if ("å¼ ä¸‰".equals(name)) {
            return Optional.of(new User("å¼ ä¸‰", "zhangsan@email.com"));
        } else if ("æå››".equals(name)) {
            return Optional.of(new User("æå››", null));  // æå››æ²¡æœ‰é‚®ç®±
        } else {
            return Optional.empty();  // æ‰¾ä¸åˆ°ç”¨æˆ·
        }
    }
}

UserService service = new UserService();

// ä½¿ç”¨mapä¼šäº§ç”ŸåµŒå¥—Optional
Optional<Optional<String>> nestedEmail = service.findUser("å¼ ä¸‰")
    .map(User::getEmail);  // Optional<User> â†’ Optional<Optional<String>>

// ä½¿ç”¨flatMapé¿å…åµŒå¥—
Optional<String> flatEmail = service.findUser("å¼ ä¸‰")
    .flatMap(User::getEmail);  // Optional<User> â†’ Optional<String>

System.out.println("å¼ ä¸‰çš„é‚®ç®±ï¼š" + flatEmail.orElse("æ— é‚®ç®±"));

// å¤æ‚çš„é“¾å¼è°ƒç”¨
String result = service.findUser("å¼ ä¸‰")
    .flatMap(User::getEmail)           // è·å–é‚®ç®±Optional
    .map(email -> email.toUpperCase()) // è½¬å¤§å†™
    .map(email -> "é‚®ç®±ï¼š" + email)     // åŠ å‰ç¼€
    .orElse("ç”¨æˆ·ä¸å­˜åœ¨æˆ–æ— é‚®ç®±");

System.out.println(result);  // é‚®ç®±ï¼šZHANGSAN@EMAIL.COM
```

### 2.6 è¿‡æ»¤æ“ä½œï¼šfilter()


**ğŸ” æŒ‰æ¡ä»¶è¿‡æ»¤Optionalä¸­çš„å€¼**

```java
Optional<Integer> age = Optional.of(25);

// filter() - è¿‡æ»¤å‡ºæ»¡è¶³æ¡ä»¶çš„å€¼
Optional<Integer> adultAge = age.filter(a -> a >= 18);
System.out.println("æˆå¹´äººå¹´é¾„ï¼š" + adultAge.orElse(-1));  // 25

// å¦‚æœä¸æ»¡è¶³æ¡ä»¶ï¼Œè¿”å›ç©ºOptional
Optional<Integer> childAge = age.filter(a -> a < 18);
System.out.println("å„¿ç«¥å¹´é¾„ï¼š" + childAge.orElse(-1));   // -1

// å®é™…åº”ç”¨ï¼šéªŒè¯ç”¨æˆ·è¾“å…¥
Optional<String> userInput = Optional.ofNullable(getUserInput());
String validInput = userInput
    .filter(input -> input.length() >= 3)        // é•¿åº¦è‡³å°‘3ä½
    .filter(input -> input.matches("[a-zA-Z]+")) // åªèƒ½æ˜¯å­—æ¯
    .orElse("è¾“å…¥æ— æ•ˆ");

System.out.println("æœ‰æ•ˆè¾“å…¥ï¼š" + validInput);

// é“¾å¼è¿‡æ»¤ï¼šéªŒè¯é‚®ç®±
Optional<String> email = Optional.of("test@example.com");
String validEmail = email
    .filter(e -> e.contains("@"))           // å¿…é¡»åŒ…å«@
    .filter(e -> e.length() > 5)           // é•¿åº¦å¤§äº5
    .filter(e -> !e.startsWith("@"))       // ä¸èƒ½ä»¥@å¼€å¤´
    .orElse("é‚®ç®±æ ¼å¼é”™è¯¯");

System.out.println("æœ‰æ•ˆé‚®ç®±ï¼š" + validEmail);
```

---

## 3. ğŸ¯ Optionalæœ€ä½³å®è·µ


### 3.1 ä»€ä¹ˆæ—¶å€™ä½¿ç”¨Optional


**âœ… æ¨èä½¿ç”¨Optionalçš„åœºæ™¯**

```java
// 1. æ–¹æ³•è¿”å›å€¼å¯èƒ½ä¸ºç©ºæ—¶
public Optional<User> findUserById(Long id) {
    User user = database.findById(id);  // å¯èƒ½æ‰¾ä¸åˆ°
    return Optional.ofNullable(user);
}

// 2. é…ç½®é¡¹å¯èƒ½ä¸å­˜åœ¨æ—¶
public Optional<String> getConfigValue(String key) {
    String value = properties.getProperty(key);
    return Optional.ofNullable(value);
}

// 3. è®¡ç®—ç»“æœå¯èƒ½æ— æ•ˆæ—¶
public Optional<Double> divide(double a, double b) {
    if (b == 0) {
        return Optional.empty();  // é™¤æ•°ä¸º0ï¼Œæ— æ•ˆ
    }
    return Optional.of(a / b);
}

// 4. è§£æå¯èƒ½å¤±è´¥æ—¶
public Optional<Integer> parseInteger(String str) {
    try {
        return Optional.of(Integer.parseInt(str));
    } catch (NumberFormatException e) {
        return Optional.empty();
    }
}
```

**âŒ ä¸æ¨èä½¿ç”¨Optionalçš„åœºæ™¯**

```java
// âŒ ä¸è¦åœ¨å­—æ®µä¸­ä½¿ç”¨Optional
class BadUser {
    private Optional<String> name;  // ä¸å¥½ï¼Œå¢åŠ å¤æ‚æ€§
    private Optional<String> email; // ä¸å¥½ï¼Œåºåˆ—åŒ–é—®é¢˜
}

// âœ… æ­£ç¡®ï¼šç›´æ¥ä½¿ç”¨å¯ç©ºå­—æ®µ
class GoodUser {
    private String name;   // å¯ä»¥ä¸ºnull
    private String email;  // å¯ä»¥ä¸ºnull
    
    // åœ¨getterä¸­è¿”å›Optional
    public Optional<String> getName() {
        return Optional.ofNullable(name);
    }
}

// âŒ ä¸è¦ç”¨Optionalä½œä¸ºæ–¹æ³•å‚æ•°
public void badMethod(Optional<String> name) {  // ä¸å¥½
    // è°ƒç”¨è€…è¿˜è¦åŒ…è£…å‚æ•°
}

// âœ… æ­£ç¡®ï¼šç›´æ¥æ¥å—å¯ç©ºå‚æ•°
public void goodMethod(String name) {  // å¥½
    Optional<String> nameOpt = Optional.ofNullable(name);
    // æ–¹æ³•å†…éƒ¨å¤„ç†
}

// âŒ ä¸è¦ç”¨OptionalåŒ…è£…é›†åˆ
public Optional<List<String>> getNames() {  // ä¸å¥½
    return Optional.ofNullable(names);
}

// âœ… æ­£ç¡®ï¼šè¿”å›ç©ºé›†åˆ
public List<String> getNames() {  // å¥½
    return names != null ? names : Collections.emptyList();
}
```

### 3.2 Optionalä¸Streamçš„ç»“åˆä½¿ç”¨


**ğŸŒŠ Optionalå’ŒStreamæ˜¯å¥½æ­æ¡£**

```java
List<User> users = Arrays.asList(
    new User("å¼ ä¸‰", "zhangsan@email.com"),
    new User("æå››", null),
    new User("ç‹äº”", "wangwu@email.com")
);

// ä»åˆ—è¡¨ä¸­æŸ¥æ‰¾ç”¨æˆ·
Optional<User> foundUser = users.stream()
    .filter(user -> "å¼ ä¸‰".equals(user.getName()))
    .findFirst();  // è¿”å›Optional<User>

foundUser.ifPresent(user -> System.out.println("æ‰¾åˆ°ç”¨æˆ·ï¼š" + user.getName()));

// è·å–æ‰€æœ‰æœ‰æ•ˆé‚®ç®±
List<String> validEmails = users.stream()
    .map(User::getEmail)        // Stream<Optional<String>>
    .filter(Optional::isPresent) // è¿‡æ»¤å‡ºæœ‰å€¼çš„Optional
    .map(Optional::get)         // æå–å€¼
    .collect(Collectors.toList());

// æ›´ä¼˜é›…çš„æ–¹å¼ï¼ˆJava 9+ï¼‰
List<String> validEmails2 = users.stream()
    .map(User::getEmail)        // Stream<Optional<String>>
    .flatMap(Optional::stream)  // æ‰å¹³åŒ–ï¼šOptional â†’ Stream
    .collect(Collectors.toList());

System.out.println("æœ‰æ•ˆé‚®ç®±ï¼š" + validEmails2);

// æŸ¥æ‰¾æœ€é«˜åˆ†å­¦ç”Ÿ
class Student {
    String name;
    int score;
    Student(String name, int score) { this.name = name; this.score = score; }
    public String getName() { return name; }
    public int getScore() { return score; }
}

List<Student> students = Arrays.asList(
    new Student("å°æ˜", 85),
    new Student("å°çº¢", 92),
    new Student("å°æ", 78)
);

Optional<Student> topStudent = students.stream()
    .max(Comparator.comparing(Student::getScore));

String topStudentName = topStudent
    .map(Student::getName)
    .orElse("æ²¡æœ‰å­¦ç”Ÿ");

System.out.println("æœ€é«˜åˆ†å­¦ç”Ÿï¼š" + topStudentName);
```

### 3.3 é“¾å¼è°ƒç”¨çš„æœ€ä½³å®è·µ


**â›“ï¸ ä¼˜é›…çš„é“¾å¼è°ƒç”¨**

```java
// å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ï¼šè·å–ç”¨æˆ·çš„ä¸»é‚®ç®±åŸŸå
class UserProfile {
    private String userId;
    private List<String> emails;
    
    public UserProfile(String userId, List<String> emails) {
        this.userId = userId;
        this.emails = emails;
    }
    
    public Optional<String> getPrimaryEmail() {
        return emails != null && !emails.isEmpty() ? 
            Optional.of(emails.get(0)) : Optional.empty();
    }
}

class UserService {
    public Optional<UserProfile> getUserProfile(String userId) {
        // æ¨¡æ‹Ÿæ•°æ®åº“æŸ¥è¯¢
        if ("user123".equals(userId)) {
            return Optional.of(new UserProfile(userId, 
                Arrays.asList("user@company.com", "user@gmail.com")));
        }
        return Optional.empty();
    }
}

UserService userService = new UserService();

// ä¼ ç»Ÿæ–¹å¼ï¼šåµŒå¥—çš„if-else
String domain1 = null;
UserProfile profile = userService.getUserProfile("user123").orElse(null);
if (profile != null) {
    String email = profile.getPrimaryEmail().orElse(null);
    if (email != null && email.contains("@")) {
        domain1 = email.substring(email.indexOf("@") + 1);
    }
}
System.out.println("åŸŸå1ï¼š" + (domain1 != null ? domain1 : "æœªçŸ¥"));

// Optionalé“¾å¼è°ƒç”¨ï¼šä¼˜é›…ç®€æ´
String domain2 = userService.getUserProfile("user123")
    .flatMap(UserProfile::getPrimaryEmail)    // è·å–ä¸»é‚®ç®±
    .filter(email -> email.contains("@"))     // éªŒè¯é‚®ç®±æ ¼å¼
    .map(email -> email.substring(email.indexOf("@") + 1))  // æå–åŸŸå
    .orElse("æœªçŸ¥");

System.out.println("åŸŸå2ï¼š" + domain2);  // company.com

// æ›´å¤æ‚çš„ä¾‹å­ï¼šè·å–ç”¨æˆ·è®¾ç½®çš„ä¸»é¢˜è‰²
Optional<String> themeColor = userService.getUserProfile("user123")
    .flatMap(this::getUserSettings)          // è·å–ç”¨æˆ·è®¾ç½®
    .flatMap(this::getThemeSettings)         // è·å–ä¸»é¢˜è®¾ç½®
    .map(theme -> theme.getPrimaryColor())   // è·å–ä¸»è‰²è°ƒ
    .filter(color -> !color.isEmpty())       // éªŒè¯éç©º
    .map(String::toLowerCase);               // è½¬å°å†™

themeColor.ifPresentOrElse(
    color -> System.out.println("ç”¨æˆ·ä¸»é¢˜è‰²ï¼š" + color),
    () -> System.out.println("ä½¿ç”¨é»˜è®¤ä¸»é¢˜è‰²")
);
```

### 3.4 å¼‚å¸¸å¤„ç†ä¸Optional


**âš¡ ä¼˜é›…å¤„ç†å¯èƒ½æŠ›å¼‚å¸¸çš„æ“ä½œ**

```java
// ä¼ ç»Ÿæ–¹å¼ï¼šåˆ°å¤„éƒ½æ˜¯try-catch
public String traditionalParseAndFormat(String input) {
    try {
        int number = Integer.parseInt(input);
        if (number > 0) {
            return "æ­£æ•°ï¼š" + number;
        } else {
            return "éæ­£æ•°";
        }
    } catch (NumberFormatException e) {
        return "æ— æ•ˆæ•°å­—";
    }
}

// Optionalæ–¹å¼ï¼šæ›´æ¸…æ™°çš„é€»è¾‘
public Optional<Integer> safeParse(String input) {
    try {
        return Optional.of(Integer.parseInt(input));
    } catch (NumberFormatException e) {
        return Optional.empty();
    }
}

public String optionalParseAndFormat(String input) {
    return safeParse(input)
        .filter(number -> number > 0)           // åªè¦æ­£æ•°
        .map(number -> "æ­£æ•°ï¼š" + number)        // æ ¼å¼åŒ–
        .orElse("æ— æ•ˆè¾“å…¥æˆ–éæ­£æ•°");
}

// æµ‹è¯•
Arrays.asList("123", "-5", "abc", "0").forEach(input -> {
    System.out.println(input + " â†’ " + optionalParseAndFormat(input));
});
// 123 â†’ æ­£æ•°ï¼š123
// -5 â†’ æ— æ•ˆè¾“å…¥æˆ–éæ­£æ•°  
// abc â†’ æ— æ•ˆè¾“å…¥æˆ–éæ­£æ•°
// 0 â†’ æ— æ•ˆè¾“å…¥æˆ–éæ­£æ•°

// å·¥å…·æ–¹æ³•ï¼šå®‰å…¨æ‰§è¡Œå¯èƒ½æŠ›å¼‚å¸¸çš„æ“ä½œ
public static <T> Optional<T> safeExecute(Supplier<T> supplier) {
    try {
        return Optional.ofNullable(supplier.get());
    } catch (Exception e) {
        return Optional.empty();
    }
}

// ä½¿ç”¨å·¥å…·æ–¹æ³•
Optional<Date> parseDate = safeExecute(() -> 
    new SimpleDateFormat("yyyy-MM-dd").parse("2024-01-15"));

parseDate.ifPresentOrElse(
    date -> System.out.println("è§£ææˆåŠŸï¼š" + date),
    () -> System.out.println("æ—¥æœŸè§£æå¤±è´¥")
);
```

### 3.5 Optionalæ€§èƒ½è€ƒè™‘


**âš¡ Optionalçš„æ€§èƒ½ç‰¹ç‚¹**

```java
// Optionalçš„å¼€é”€åˆ†æ
public class OptionalPerformance {
    
    // 1. Optionalåˆ›å»ºæœ‰å°‘é‡å¼€é”€
    public void createOptionals() {
        // æ¯æ¬¡è°ƒç”¨éƒ½åˆ›å»ºæ–°å¯¹è±¡
        Optional<String> opt1 = Optional.of("value");      // åˆ›å»ºå¯¹è±¡
        Optional<String> opt2 = Optional.empty();          // ä½¿ç”¨å•ä¾‹
        Optional<String> opt3 = Optional.ofNullable(null); // è¿”å›å•ä¾‹
    }
    
    // 2. é¢‘ç¹è°ƒç”¨çš„çƒ­ç‚¹ä»£ç è¦æ³¨æ„
    public String hotPathMethod(String input) {
        // âŒ åœ¨çƒ­ç‚¹ä»£ç ä¸­é¢‘ç¹åˆ›å»ºOptional
        return Optional.ofNullable(input)
            .map(String::trim)
            .filter(s -> !s.isEmpty())
            .orElse("default");
        
        // âœ… çƒ­ç‚¹ä»£ç ç”¨ä¼ ç»Ÿæ–¹å¼å¯èƒ½æ›´å¥½
        // if (input != null) {
        //     String trimmed = input.trim();
        //     return trimmed.isEmpty() ? "default" : trimmed;
        // }
        // return "default";
    }
    
    // 3. åˆç†ä½¿ç”¨ç¼“å­˜
    private static final Optional<String> CACHED_EMPTY = Optional.empty();
    
    public Optional<String> getCachedResult(boolean hasValue) {
        return hasValue ? Optional.of("result") : CACHED_EMPTY;
    }
}

// æ€§èƒ½æµ‹è¯•ï¼ˆç®€åŒ–ç‰ˆï¼‰
public void performanceTest() {
    int iterations = 1_000_000;
    
    // æµ‹è¯•ä¼ ç»Ÿnullæ£€æŸ¥
    long start = System.currentTimeMillis();
    for (int i = 0; i < iterations; i++) {
        String result = traditionalNullCheck("test");
    }
    long traditional = System.currentTimeMillis() - start;
    
    // æµ‹è¯•Optionalæ–¹å¼
    start = System.currentTimeMillis();
    for (int i = 0; i < iterations; i++) {
        String result = optionalWay("test");
    }
    long optional = System.currentTimeMillis() - start;
    
    System.out.println("ä¼ ç»Ÿæ–¹å¼ï¼š" + traditional + "ms");
    System.out.println("Optionalæ–¹å¼ï¼š" + optional + "ms");
}

private String traditionalNullCheck(String input) {
    return input != null ? input.toUpperCase() : "DEFAULT";
}

private String optionalWay(String input) {
    return Optional.ofNullable(input)
        .map(String::toUpperCase)
        .orElse("DEFAULT");
}
```

### 3.6 Optionalå¸¸è§è¯¯åŒº


**âŒ é¿å…è¿™äº›å¸¸è§é”™è¯¯**

```java
// è¯¯åŒº1ï¼šæŠŠOptionalå½“ä½œnullçš„æ›¿ä»£å“
// âŒ é”™è¯¯
Optional<String> name = Optional.ofNullable(getName());
if (name.isPresent()) {
    return name.get().toUpperCase();
} else {
    return "UNKNOWN";
}

// âœ… æ­£ç¡®
return Optional.ofNullable(getName())
    .map(String::toUpperCase)
    .orElse("UNKNOWN");

// è¯¯åŒº2ï¼šè¿‡åº¦ä½¿ç”¨Optional
// âŒ é”™è¯¯ï¼šç®€å•çš„nullæ£€æŸ¥ä¸éœ€è¦Optional
Optional<String> input = Optional.ofNullable(userInput);
if (input.isPresent()) {
    process(input.get());
}

// âœ… æ­£ç¡®ï¼šç®€å•æƒ…å†µç”¨ä¼ ç»Ÿæ–¹å¼
if (userInput != null) {
    process(userInput);
}

// è¯¯åŒº3ï¼šå¿˜è®°Optionalä¹Ÿå¯èƒ½æ˜¯null
// âŒ å±é™©
public Optional<String> badMethod() {
    return null;  // è¿”å›nullè€Œä¸æ˜¯Optional.empty()
}

// âœ… æ­£ç¡®
public Optional<String> goodMethod() {
    return Optional.empty();  // æ˜ç¡®è¿”å›ç©ºOptional
}

// è¯¯åŒº4ï¼šé“¾å¼è°ƒç”¨è¿‡é•¿å½±å“å¯è¯»æ€§
// âŒ å¯è¯»æ€§å·®
String result = Optional.ofNullable(getUser())
    .flatMap(user -> Optional.ofNullable(user.getProfile()))
    .flatMap(profile -> Optional.ofNullable(profile.getSettings()))
    .flatMap(settings -> Optional.ofNullable(settings.getTheme()))
    .map(theme -> theme.getColor())
    .filter(color -> !color.isEmpty())
    .map(String::toUpperCase)
    .orElse("DEFAULT");

// âœ… å¯è¯»æ€§å¥½ï¼šåˆ†æ­¥éª¤æˆ–æå–æ–¹æ³•
Optional<User> userOpt = Optional.ofNullable(getUser());
Optional<String> colorOpt = userOpt
    .flatMap(this::getUserThemeColor)
    .filter(color -> !color.isEmpty())
    .map(String::toUpperCase);
String result2 = colorOpt.orElse("DEFAULT");
```

### 3.7 Optionalæ€»ç»“


**ğŸ¯ Optionalæ ¸å¿ƒè¦ç‚¹**

| **æ–¹é¢** | **è¦ç‚¹** | **ç¤ºä¾‹** |
|---------|---------|---------|
| **åˆ›å»º** | ä¼˜å…ˆä½¿ç”¨`ofNullable()` | `Optional.ofNullable(value)` |
| **æ£€æŸ¥** | ç”¨`ifPresent()`è€Œä¸æ˜¯`isPresent()` | `opt.ifPresent(System.out::println)` |
| **è·å–** | ç”¨`orElse()`è€Œä¸æ˜¯`get()` | `opt.orElse("default")` |
| **è½¬æ¢** | ç”¨`map()`å’Œ`flatMap()` | `opt.map(String::length)` |
| **è¿‡æ»¤** | ç”¨`filter()`éªŒè¯æ¡ä»¶ | `opt.filter(s -> s.length() > 3)` |
| **é“¾å¼** | ä¿æŒé“¾å¼è°ƒç”¨ç®€æ´ | ä¸è¦è¿‡é•¿ï¼Œå½±å“å¯è¯»æ€§ |

**ğŸ’¡ ä½¿ç”¨åŸåˆ™**

```java
// âœ… å¥½çš„ä½¿ç”¨æ–¹å¼
public Optional<User> findUser(String id) {
    return users.stream()
        .filter(user -> user.getId().equals(id))
        .findFirst();
}

public String getUserDisplayName(String userId) {
    return findUser(userId)
        .map(User::getName)
        .filter(name -> !name.trim().isEmpty())
        .orElse("åŒ¿åç”¨æˆ·");
}

// âœ… ä¸Streamç»“åˆ
public List<String> getActiveUserEmails() {
    return users.stream()
        .filter(User::isActive)
        .map(User::getEmail)
        .flatMap(Optional::stream)  // Java 9+
        .collect(Collectors.toList());
}
```

**ğŸš€ æ ¸å¿ƒä»·å€¼å›é¡¾**

```
1. æ˜ç¡®è¡¨è¾¾ç©ºå€¼å¯èƒ½æ€§ - ä»APIè®¾è®¡å°±é¿å…ç©ºæŒ‡é’ˆ
2. å¼ºåˆ¶å¤„ç†ç©ºå€¼æƒ…å†µ - ç¼–è¯‘æœŸæ£€æŸ¥ï¼Œè¿è¡ŒæœŸå®‰å…¨
3. é“¾å¼è°ƒç”¨æ›´ä¼˜é›… - å‡å°‘if-elseåµŒå¥—
4. ä¸å‡½æ•°å¼ç¼–ç¨‹ç»“åˆ - é…åˆStreamä½¿ç”¨æ›´å¼ºå¤§
5. æå‡ä»£ç å¯è¯»æ€§ - æ„å›¾æ›´æ˜ç¡®ï¼Œé€»è¾‘æ›´æ¸…æ™°
```

**ğŸ“ è®°å¿†å£è¯€**

```
Optionalç›’å­è£…å¯èƒ½ï¼Œç©ºå€¼é—®é¢˜å®ƒæ¥è§£
ofNullableæœ€å¸¸ç”¨ï¼Œåˆ›å»ºå®‰å…¨ä¸å‡ºé”™
ifPresentæœ‰å€¼æ‰§è¡Œï¼ŒorElseæ²¡å€¼ç»™é»˜è®¤
mapè½¬æ¢filterè¿‡æ»¤ï¼ŒflatMapå¤„ç†åµŒå¥—å±‚
é“¾å¼è°ƒç”¨è¦ç®€æ´ï¼Œå¯è¯»æ€§æ˜¯ç¬¬ä¸€æ¡
ä¸è¦æ»¥ç”¨è¦é€‚åº¦ï¼Œç®€å•æƒ…å†µä¼ ç»Ÿå¥½
```
