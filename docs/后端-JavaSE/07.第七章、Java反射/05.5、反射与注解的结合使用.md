---
title: 5ã€åå°„ä¸æ³¨è§£çš„ç»“åˆä½¿ç”¨
---
## ğŸ“š ç›®å½•

1. [åŸºç¡€è®¤çŸ¥ï¼šä¸ºä»€ä¹ˆéœ€è¦"åå°„+æ³¨è§£"ç»“åˆ](#1-åŸºç¡€è®¤çŸ¥ä¸ºä»€ä¹ˆéœ€è¦åå°„æ³¨è§£ç»“åˆ)
2. [æ³¨è§£ä¿¡æ¯è·å–æ ¸å¿ƒæ–¹æ³•](#2-æ³¨è§£ä¿¡æ¯è·å–æ ¸å¿ƒæ–¹æ³•)
3. [æ³¨è§£ä¸åå°„ç»“åˆçš„å…¸å‹æ“ä½œ](#3-æ³¨è§£ä¸åå°„ç»“åˆçš„å…¸å‹æ“ä½œ)
4. [æ³¨è§£è§£æå™¨è¯¦è§£](#4-æ³¨è§£è§£æå™¨è¯¦è§£)
5. [æ³¨è§£çš„ç»§æ‰¿æ€§ä¸åå°„å¤„ç†](#5-æ³¨è§£çš„ç»§æ‰¿æ€§ä¸åå°„å¤„ç†)
6. [è¿è¡Œæ—¶æ³¨è§£vsç¼–è¯‘æ—¶æ³¨è§£](#6-è¿è¡Œæ—¶æ³¨è§£vsç¼–è¯‘æ—¶æ³¨è§£)
7. [å¸¸è§åº”ç”¨åœºæ™¯](#7-å¸¸è§åº”ç”¨åœºæ™¯)
8. [SPIæœºåˆ¶è¯¦è§£](#8-SPIæœºåˆ¶è¯¦è§£)
9. [å…¸å‹é™·é˜±ä¸æ³¨æ„äº‹é¡¹](#9-å…¸å‹é™·é˜±ä¸æ³¨æ„äº‹é¡¹)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¤” åŸºç¡€è®¤çŸ¥ï¼šä¸ºä»€ä¹ˆéœ€è¦"åå°„+æ³¨è§£"ç»“åˆ


### 1.1 äºŒè€…èŒè´£äº’è¡¥åŸç†


**ğŸ”¸ æ³¨è§£ä¸åå°„çš„åˆ†å·¥åä½œ**
```
åå°„+æ³¨è§£ç»“åˆçš„å¿…è¦æ€§ä¸ç¼–ç¨‹æ¨¡å¼
â”œâ”€â”€ ä¸€ã€åŸºç¡€è®¤çŸ¥ï¼šäºŒè€…èŒè´£äº’è¡¥
â”‚   â”œâ”€â”€ 1. æ³¨è§£çš„ä½œç”¨ï¼šå£°æ˜å…ƒæ•°æ®
â”‚   â”‚   â”œâ”€â”€ æ³¨è§£æ˜¯ç¼–è¯‘å™¨å’Œè¿è¡Œæ—¶å¯ä»¥è¯»å–çš„ä¿¡æ¯
â”‚   â”‚   â”œâ”€â”€ æ³¨è§£æœ¬èº«ä¸å…·å¤‡é€»è¾‘æ‰§è¡Œèƒ½åŠ›
â”‚   â”‚   â””â”€â”€ æœ¬è´¨æ˜¯"æ ‡ç­¾"ï¼Œç”¨äºæè¿°ç»“æ„ç”¨é€”æˆ–è¡Œä¸ºæ„å›¾
â”‚   â”œâ”€â”€ 2. åå°„çš„ä½œç”¨ï¼šè¿è¡Œæ—¶è§£æä¸æ‰§è¡Œ
â”‚   â”‚   â”œâ”€â”€ å¯ä»¥è®¿é—®ç±»çš„ç»“æ„ï¼ˆå­—æ®µã€æ–¹æ³•ã€æ„é€ å™¨ç­‰ï¼‰
â”‚   â”‚   â”œâ”€â”€ å¯ä»¥è·å–å¹¶è§£ææ³¨è§£å†…å®¹
â”‚   â”‚   â””â”€â”€ èƒ½æ ¹æ®æ³¨è§£å†…å®¹åŠ¨æ€æ‰§è¡Œå¯¹åº”é€»è¾‘
â”‚   â””â”€â”€ 3. ç»“åˆåçš„æ ¸å¿ƒä»·å€¼
â”‚       â””â”€â”€ æ³¨è§£æä¾›"å£°æ˜"ï¼Œåå°„å®ç°"è§£é‡Š+æ‰§è¡Œ"
```

### 1.2 å½¢æˆå£°æ˜å¼ç¼–ç¨‹æ¨¡å¼


**ğŸ¯ ç¼–ç¨‹èŒƒå¼çš„è½¬å˜**
```
å£°æ˜å¼ç¼–ç¨‹æ¨¡å¼å®ç°
â”œâ”€â”€ äºŒã€ç»“åˆä½¿ç”¨å½¢æˆçš„å£°æ˜å¼ç¼–ç¨‹æ¨¡å¼
â”‚   â”œâ”€â”€ æ³¨è§£è´Ÿè´£å®šä¹‰è§„åˆ™æˆ–é…ç½®
â”‚   â”‚   â””â”€â”€ å¦‚ï¼š@Autowired è¡¨ç¤ºæŸå­—æ®µéœ€è¦è‡ªåŠ¨æ³¨å…¥
â”‚   â”œâ”€â”€ åå°„è´Ÿè´£å®ç°è¡Œä¸ºæˆ–å“åº”
â”‚   â”‚   â””â”€â”€ è¿è¡Œæ—¶æ‰«æç±»â†’è·å–å­—æ®µâ†’åˆ¤æ–­æ˜¯å¦è¢«æ³¨è§£â†’è¿›è¡Œæ³¨å…¥æ“ä½œ
â”‚   â””â”€â”€ å¯¹å¼€å‘è€…è€Œè¨€åªéœ€"æ ‡æ³¨"ï¼Œä¸å…³å¿ƒåº•å±‚"æ‰§è¡Œé€»è¾‘"
â”‚
â”œâ”€â”€ ä¸‰ã€åå°„+æ³¨è§£ç»“åˆçš„å…¸å‹ä¼˜åŠ¿
â”‚   â”œâ”€â”€ 1. è§£è€¦ä¸šåŠ¡é€»è¾‘ä¸æ§åˆ¶é€»è¾‘
â”‚   â”‚   â””â”€â”€ å¼€å‘è€…åªå†™æ³¨è§£ï¼Œç³»ç»Ÿè‡ªåŠ¨å“åº”æ³¨è§£è¡Œä¸º
â”‚   â”œâ”€â”€ 2. å®ç°é›¶é…ç½®æˆ–è½»é…ç½®å¼€å‘
â”‚   â”‚   â””â”€â”€ æ›¿ä»£XMLé…ç½®ï¼Œå¦‚Spring Bootä½¿ç”¨@Configuration
â”‚   â”œâ”€â”€ 3. æ”¯æŒæ‰©å±•æ€§å¼ºçš„æ’ä»¶å¼æ¶æ„
â”‚   â”‚   â””â”€â”€ æ‰«ææ³¨è§£æ³¨å†Œæ‰©å±•ç‚¹ã€æœåŠ¡æ¥å£ç­‰
â”‚   â”œâ”€â”€ 4. æé«˜ä»£ç å¯è¯»æ€§ä¸ç»´æŠ¤æ€§
â”‚   â”‚   â””â”€â”€ æ³¨è§£å°±æ˜¯æ–‡æ¡£ï¼Œæ ‡æ˜æ¯ä¸ªç»“æ„çš„ç”¨é€”
â”‚   â””â”€â”€ 5. æ›´é€‚åˆæ„å»º"å£°æ˜å¼æ¡†æ¶"
â”‚       â””â”€â”€ å¦‚ï¼šäº‹åŠ¡æ§åˆ¶ã€éªŒè¯é€»è¾‘ã€æƒé™æ£€æŸ¥ç­‰éƒ½å¯å£°æ˜å¼æ³¨å…¥
```

### 1.3 ç¼–ç¨‹èŒƒå¼å¯¹æ¯”


**ğŸ“Š å‘½ä»¤å¼vså£°æ˜å¼ç¼–ç¨‹å¯¹æ¯”**

| ç¼–ç¨‹æ–¹å¼ | **å‘½ä»¤å¼** | **å£°æ˜å¼ï¼ˆæ³¨è§£+åå°„ï¼‰** |
|---------|-----------|---------------------|
| **ä»£ç é£æ ¼** | æ‰‹åŠ¨è°ƒç”¨é…ç½®æ–¹æ³• | åªå£°æ˜æ„å›¾ï¼Œæ¡†æ¶è´Ÿè´£æ‰§è¡Œ |
| **ç¤ºä¾‹** | `service.setUser(user)` | `@Autowired private UserService service;` |
| **å¯è¯»æ€§** | é€»è¾‘åˆ†æ•£ï¼Œéœ€è¦æŸ¥çœ‹å®ç° | æ„å›¾æ˜ç¡®ï¼Œæ³¨è§£å³æ–‡æ¡£ |
| **ç»´æŠ¤æ€§** | é…ç½®ä»£ç ä¸ä¸šåŠ¡è€¦åˆ | é…ç½®ä¸ä¸šåŠ¡åˆ†ç¦» |
| **æ‰©å±•æ€§** | ä¿®æ”¹éœ€è¦æ”¹ä»£ç  | å¢åŠ æ³¨è§£å³å¯æ‰©å±• |

### 1.4 å…¸å‹åº”ç”¨åœºæ™¯ä¸¾ä¾‹


**ğŸŒŸ æ¡†æ¶ä¸­çš„ç»å…¸åº”ç”¨**

| æ¡†æ¶/æŠ€æœ¯ | **æ³¨è§£** | **åå°„å¤„ç†** | **å®ç°æ•ˆæœ** |
|---------|---------|-------------|-------------|
| **Spring** | `@Component/@Service` | åå°„æ‰«æå®ä¾‹åŒ–Bean | è‡ªåŠ¨ç»„ä»¶æ³¨å†Œ |
| **JPA** | `@Entity/@Column` | åå°„å®Œæˆå­—æ®µä¸è¡¨æ˜ å°„ | ORMè‡ªåŠ¨æ˜ å°„ |
| **Swagger** | `@Api/@ApiOperation` | åå°„ç”Ÿæˆæ¥å£æ–‡æ¡£ | APIæ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆ |
| **æ ¡éªŒæ¡†æ¶** | `@NotNull/@Size` | åå°„è¯»å–å¹¶éªŒè¯å­—æ®µå€¼ | æ•°æ®æ ¡éªŒè‡ªåŠ¨åŒ– |
| **æµ‹è¯•æ¡†æ¶** | `@Test/@Before` | åå°„æ‰«ææ–¹æ³•å¹¶æ‰§è¡Œæµ‹è¯• | æµ‹è¯•è‡ªåŠ¨æ‰§è¡Œ |

---

## 2. ğŸ” æ³¨è§£ä¿¡æ¯è·å–æ ¸å¿ƒæ–¹æ³•


### 2.1 åˆ¤æ–­æ³¨è§£æ˜¯å¦å­˜åœ¨


**ğŸ“‹ æ³¨è§£å­˜åœ¨æ€§æ£€æŸ¥æ–¹æ³•**

| æ–¹æ³• | **è¯´æ˜** | **é€‚ç”¨å¯¹è±¡** |
|-----|---------|-------------|
| `isAnnotationPresent(Class<? extends Annotation>)` | åˆ¤æ–­ç±»ã€æ–¹æ³•ã€å­—æ®µç­‰æ˜¯å¦è¢«æŸæ³¨è§£æ ‡è®° | Classã€Methodã€Fieldã€Constructor |

**ğŸ’» ä½¿ç”¨ç¤ºä¾‹**
```java
// æ£€æŸ¥æ–¹æ³•æ˜¯å¦è¢«æ³¨è§£æ ‡è®°
if (method.isAnnotationPresent(MyAnno.class)) {
    System.out.println("æ–¹æ³•è¢«@MyAnnoæ³¨è§£æ ‡è®°");
}

// æ£€æŸ¥å­—æ®µæ˜¯å¦è¢«æ³¨è§£æ ‡è®°
if (field.isAnnotationPresent(Autowired.class)) {
    System.out.println("å­—æ®µéœ€è¦è‡ªåŠ¨æ³¨å…¥");
}

// æ£€æŸ¥ç±»æ˜¯å¦è¢«æ³¨è§£æ ‡è®°
if (clazz.isAnnotationPresent(Component.class)) {
    System.out.println("è¿™æ˜¯ä¸€ä¸ªç»„ä»¶ç±»");
}
```

### 2.2 è·å–æ³¨è§£å¯¹è±¡


**ğŸ“‹ æ³¨è§£è·å–æ–¹æ³•è¡¨**

| æ–¹æ³• | **è¯´æ˜** | **è¿”å›ç±»å‹** |
|-----|---------|-------------|
| `getAnnotation(Class<T>)` | è·å–æŒ‡å®šç±»å‹çš„æ³¨è§£å¯¹è±¡ | `T extends Annotation` |
| `getAnnotations()` | è·å–æ‰€æœ‰æ³¨è§£ï¼ˆåŒ…å«ç»§æ‰¿æ³¨è§£ï¼‰ | `Annotation[]` |
| `getDeclaredAnnotations()` | è·å–å½“å‰å…ƒç´ ç›´æ¥å£°æ˜çš„æ³¨è§£ | `Annotation[]` |

**ğŸ’» ä½¿ç”¨ç¤ºä¾‹**
```java
// è·å–ç‰¹å®šæ³¨è§£å¹¶è¯»å–å±æ€§
MyAnno anno = method.getAnnotation(MyAnno.class);
if (anno != null) {
    String value = anno.value(); // è·å–æ³¨è§£å±æ€§å€¼
    int level = anno.level();
    System.out.println("æ³¨è§£å€¼: " + value + ", çº§åˆ«: " + level);
}

// è·å–æ‰€æœ‰æ³¨è§£
Annotation[] annotations = clazz.getAnnotations();
for (Annotation annotation : annotations) {
    System.out.println("æ³¨è§£ç±»å‹: " + annotation.annotationType().getSimpleName());
}
```

---

## 3. ğŸ”— æ³¨è§£ä¸åå°„ç»“åˆçš„å…¸å‹æ“ä½œ


### 3.1 åŸºæœ¬æ“ä½œæ¨¡å¼


**ğŸ”§ æ ‡å‡†æ“ä½œæµç¨‹**
```java
// 1. è·å–ç±»/æ–¹æ³•/å­—æ®µçš„æ³¨è§£å±æ€§å€¼
Class<?> clazz = Person.class;
Field field = clazz.getDeclaredField("name");

if (field.isAnnotationPresent(MyFieldAnno.class)) {
    MyFieldAnno anno = field.getAnnotation(MyFieldAnno.class);
    System.out.println("å­—æ®µæ ‡ç­¾: " + anno.label());
    System.out.println("æ˜¯å¦å¿…éœ€: " + anno.required());
}

// 2. æ³¨è§£ç”¨äºè¡Œä¸ºæ§åˆ¶ï¼ˆåå°„é©±åŠ¨æ‰§è¡Œï¼‰
Method method = clazz.getMethod("process");
if (method.isAnnotationPresent(Log.class)) {
    Log logAnno = method.getAnnotation(Log.class);
    System.out.println("æ‰§è¡Œå‰è®°å½•æ—¥å¿—ï¼Œçº§åˆ«: " + logAnno.level());
    method.invoke(instance); // æ‰§è¡Œæ–¹æ³•
    System.out.println("æ‰§è¡Œåè®°å½•æ—¥å¿—");
}
```

### 3.2 å®Œæ•´åº”ç”¨ç¤ºä¾‹


**ğŸ’» æ³¨è§£é©±åŠ¨çš„ä¾èµ–æ³¨å…¥ç¤ºä¾‹**
```java
import java.lang.annotation.*;
import java.lang.reflect.*;
import java.util.*;

// 1. å®šä¹‰æ³¨è§£
@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.FIELD)
@interface Inject {
    String value() default "";
    boolean required() default true;
}

@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.TYPE)
@interface Component {
    String value() default "";
}

@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.METHOD)
@interface PostConstruct {
}

// 2. å®šä¹‰æœåŠ¡ç±»
@Component("userService")
class UserService {
    public void findUser(String id) {
        System.out.println("æŸ¥æ‰¾ç”¨æˆ·: " + id);
    }
    
    @PostConstruct
    public void init() {
        System.out.println("UserService åˆå§‹åŒ–å®Œæˆ");
    }
}

@Component("orderService")
class OrderService {
    public void createOrder(String userId) {
        System.out.println("ä¸ºç”¨æˆ· " + userId + " åˆ›å»ºè®¢å•");
    }
}

// 3. ä½¿ç”¨æ³¨è§£çš„ä¸šåŠ¡ç±»
@Component("userController")
class UserController {
    @Inject("userService")
    private UserService userService;
    
    @Inject(value = "orderService", required = true)
    private OrderService orderService;
    
    public void handleRequest(String userId) {
        userService.findUser(userId);
        orderService.createOrder(userId);
    }
    
    @PostConstruct
    public void init() {
        System.out.println("UserController åˆå§‹åŒ–å®Œæˆ");
    }
}

// 4. ç®€å•çš„IoCå®¹å™¨å®ç°
class SimpleIoCContainer {
    private Map<String, Object> beans = new HashMap<>();
    
    // æ³¨å†Œç»„ä»¶
    public void registerComponents(String packageName) throws Exception {
        // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥æ‰«æåŒ…è·¯å¾„
        Class<?>[] classes = {UserService.class, OrderService.class, UserController.class};
        
        for (Class<?> clazz : classes) {
            if (clazz.isAnnotationPresent(Component.class)) {
                Component component = clazz.getAnnotation(Component.class);
                String beanName = component.value().isEmpty() ? 
                    clazz.getSimpleName().toLowerCase() : component.value();
                
                // åˆ›å»ºå®ä¾‹
                Object instance = clazz.getDeclaredConstructor().newInstance();
                beans.put(beanName, instance);
                System.out.println("æ³¨å†Œç»„ä»¶: " + beanName + " -> " + clazz.getSimpleName());
            }
        }
    }
    
    // ä¾èµ–æ³¨å…¥
    public void injectDependencies() throws Exception {
        for (Object bean : beans.values()) {
            Class<?> clazz = bean.getClass();
            
            // å¤„ç†å­—æ®µæ³¨å…¥
            for (Field field : clazz.getDeclaredFields()) {
                if (field.isAnnotationPresent(Inject.class)) {
                    Inject inject = field.getAnnotation(Inject.class);
                    String beanName = inject.value();
                    
                    Object dependency = beans.get(beanName);
                    if (dependency != null) {
                        field.setAccessible(true);
                        field.set(bean, dependency);
                        System.out.println("æ³¨å…¥ä¾èµ–: " + clazz.getSimpleName() + 
                            "." + field.getName() + " <- " + beanName);
                    } else if (inject.required()) {
                        throw new RuntimeException("å¿…éœ€çš„ä¾èµ–æœªæ‰¾åˆ°: " + beanName);
                    }
                }
            }
        }
    }
    
    // æ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•
    public void executePostConstruct() throws Exception {
        for (Object bean : beans.values()) {
            Class<?> clazz = bean.getClass();
            
            for (Method method : clazz.getDeclaredMethods()) {
                if (method.isAnnotationPresent(PostConstruct.class)) {
                    method.setAccessible(true);
                    method.invoke(bean);
                }
            }
        }
    }
    
    public <T> T getBean(String name, Class<T> type) {
        return type.cast(beans.get(name));
    }
}

// 5. æµ‹è¯•ä½¿ç”¨
public class AnnotationReflectionDemo {
    public static void main(String[] args) throws Exception {
        SimpleIoCContainer container = new SimpleIoCContainer();
        
        // æ³¨å†Œç»„ä»¶
        container.registerComponents("com.example");
        
        // ä¾èµ–æ³¨å…¥
        container.injectDependencies();
        
        // æ‰§è¡Œåˆå§‹åŒ–
        container.executePostConstruct();
        
        // ä½¿ç”¨
        UserController controller = container.getBean("userController", UserController.class);
        controller.handleRequest("user123");
    }
}
```

---

## 4. ğŸ”§ æ³¨è§£è§£æå™¨è¯¦è§£


### 4.1 ç¼–è¯‘æœŸæ³¨è§£è§£æå™¨ï¼ˆAPTï¼‰


**ğŸ”¸ APTåŸºæœ¬æ¦‚å¿µ**
ç¼–è¯‘æœŸæ³¨è§£è§£æå™¨ï¼ˆAnnotation Processing Toolï¼‰æ˜¯ä¸€ç§åœ¨Javaç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œæ‰«æå¹¶å¤„ç†æºç ä¸­çš„æ³¨è§£ï¼Œå¯ä»¥ç”Ÿæˆé¢å¤–çš„ç±»ã€èµ„æºã€æ ¡éªŒè§„åˆ™ç­‰å†…å®¹ã€‚

**ğŸ“‹ APTæ ¸å¿ƒåŠŸèƒ½è¡¨**

| åŠŸèƒ½ | **è¯´æ˜** | **å…¸å‹åº”ç”¨** |
|-----|---------|-------------|
| **åˆ†ææºä»£ç ä¸­çš„æ³¨è§£** | è¯»å–`@Entity`ã€`@AutoService`ç­‰æ³¨è§£ä¿¡æ¯ | Lombokè¯»å–@Dataç”Ÿæˆgetter/setter |
| **ç”Ÿæˆæ–°ä»£ç ** | è‡ªåŠ¨ç”ŸæˆJavaç±»ã€é…ç½®æ–‡ä»¶ã€è¾…åŠ©ç±» | Daggerç”Ÿæˆä¾èµ–æ³¨å…¥ä»£ç  |
| **æ³¨è§£æ ¡éªŒ** | æ£€æŸ¥æ³¨è§£æ˜¯å¦ä½¿ç”¨æ­£ç¡® | æ£€æŸ¥å¿…å¡«å­—æ®µã€æ ¼å¼æ ¡éªŒ |

**ğŸ—ï¸ APTå·¥ä½œæµç¨‹**
```
APTå·¥ä½œæµç¨‹å›¾
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Javaæºæ–‡ä»¶   â”‚ â”€â†’ â”‚ ç¼–è¯‘å™¨javac   â”‚ â”€â†’ â”‚ æ³¨è§£å¤„ç†å™¨(APT)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â–¼                     â–¼                     â–¼
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚ æ–°Javaæºæ–‡ä»¶  â”‚    â”‚ è¯­æ³•/æ³¨è§£é”™è¯¯ â”‚    â”‚ ç¼–è¯‘ä¸º.class â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ’» APTå®ç°ç¤ºä¾‹**
```java
// APTæ ¸å¿ƒç±»/æ¥å£
@SupportedAnnotationTypes("com.example.MyAnno")
@SupportedSourceVersion(SourceVersion.RELEASE_17)
public class MyAnnoProcessor extends AbstractProcessor {
    
    @Override
    public boolean process(Set<? extends TypeElement> annotations, 
                          RoundEnvironment roundEnv) {
        // å¤„ç†æ³¨è§£å¹¶ç”Ÿæˆä»£ç 
        for (Element element : roundEnv.getElementsAnnotatedWith(MyAnno.class)) {
            // è¯»å–æ³¨è§£ä¿¡æ¯
            MyAnno annotation = element.getAnnotation(MyAnno.class);
            
            // ç”Ÿæˆä»£ç é€»è¾‘
            generateCode(element, annotation);
        }
        return true;
    }
    
    private void generateCode(Element element, MyAnno annotation) {
        // ä»£ç ç”Ÿæˆé€»è¾‘
        try {
            JavaFileObject sourceFile = processingEnv.getFiler()
                .createSourceFile(element.getSimpleName() + "Generated");
            
            try (PrintWriter writer = new PrintWriter(sourceFile.openWriter())) {
                writer.println("// è‡ªåŠ¨ç”Ÿæˆçš„ä»£ç ");
                writer.println("public class " + element.getSimpleName() + "Generated {");
                writer.println("    // æ ¹æ®æ³¨è§£ç”Ÿæˆçš„å†…å®¹");
                writer.println("}");
            }
        } catch (IOException e) {
            processingEnv.getMessager().printMessage(Diagnostic.Kind.ERROR, 
                "ä»£ç ç”Ÿæˆå¤±è´¥: " + e.getMessage());
        }
    }
}

// æ³¨å†Œå¤„ç†å™¨ï¼ˆåœ¨META-INF/services/javax.annotation.processing.Processoræ–‡ä»¶ä¸­ï¼‰
// com.example.MyAnnoProcessor
```

**ğŸ“Š APTå…¸å‹åº”ç”¨åœºæ™¯**

| æ¡†æ¶/å·¥å…· | **æ³¨è§£å¤„ç†å™¨ç”¨é€”** | **ç”Ÿæˆå†…å®¹** |
|----------|------------------|-------------|
| **Lombok** | è‡ªåŠ¨ç”Ÿæˆgetter/setterã€æ„é€ å™¨ç­‰ä»£ç  | Javaæ–¹æ³•å’Œæ„é€ å™¨ |
| **MapStruct** | è‡ªåŠ¨ç”ŸæˆJava Beanæ˜ å°„ç±» | æ˜ å°„å®ç°ç±» |
| **Dagger2** | ç¼–è¯‘æ—¶ä¾èµ–æ³¨å…¥å®ç° | ä¾èµ–æ³¨å…¥ä»£ç  |
| **AutoService** | è‡ªåŠ¨æ³¨å†ŒSPIå®ç°ç±» | META-INF/servicesæ–‡ä»¶ |
| **ARouter** | è·¯ç”±è¡¨ç”Ÿæˆï¼ˆé˜¿é‡Œè·¯ç”±æ¡†æ¶ï¼‰ | è·¯ç”±æ˜ å°„ä»£ç  |

### 4.2 è¿è¡Œæ—¶æ³¨è§£è§£æå™¨


**ğŸ”¸ è¿è¡Œæ—¶å¤„ç†åŸç†**
åœ¨ç¨‹åºè¿è¡Œæ—¶ï¼Œé€šè¿‡åå°„æœºåˆ¶è¯»å–æ³¨è§£ã€è§£æå…¶å±æ€§å€¼ï¼Œå¹¶æ‰§è¡Œç›¸åº”é€»è¾‘çš„ä»£ç ï¼Œé€šå¸¸ç§°ä¸ºè¿è¡Œæ—¶æ³¨è§£è§£æå™¨ã€‚

**ğŸ“‹ è¿è¡Œæ—¶å¤„ç†åŠŸèƒ½è¡¨**

| åŠŸèƒ½ | **è¯´æ˜** | **APIæ–¹æ³•** |
|-----|---------|------------|
| **åˆ¤æ–­æ˜¯å¦æ ‡æ³¨äº†æ³¨è§£** | æ£€æŸ¥å…ƒç´ æ˜¯å¦æœ‰ç‰¹å®šæ³¨è§£ | `isAnnotationPresent(...)` |
| **è·å–æ³¨è§£å¯¹è±¡** | è·å–æ³¨è§£å®ä¾‹ | `getAnnotation(...)` |
| **è¯»å–å±æ€§å€¼** | è·å–æ³¨è§£çš„å±æ€§å€¼ | `anno.value()` |
| **æ§åˆ¶è¡Œä¸º** | åå°„è°ƒç”¨æ–¹æ³•ã€æ³¨å…¥ä¾èµ–ã€æƒé™æ§åˆ¶ç­‰ | `invoke()`, `set()` |

**ğŸ¯ è¿è¡Œæ—¶å¤„ç†åº”ç”¨åœºæ™¯**

| æ¡†æ¶ | **ç”¨é€”** | **å…¸å‹æ³¨è§£** |
|-----|---------|-------------|
| **Spring** | è¯»å–æ³¨è§£è¿›è¡ŒIOCã€AOPå¤„ç† | `@Autowired`, `@Transactional`, `@Controller` |
| **JUnit** | æ‰§è¡Œå¸¦æœ‰æµ‹è¯•æ³¨è§£çš„æ–¹æ³• | `@Test`, `@Before`, `@After` |
| **MyBatis** | æ˜ å°„æ³¨è§£SQLåˆ°æ–¹æ³• | `@Select`, `@Insert`, `@Update` |
| **è‡ªå®šä¹‰æ¡†æ¶** | é€šè¿‡åå°„æ‰«ææ³¨è§£å¹¶æ‰§è¡Œæ³¨å†Œã€åˆå§‹åŒ–ã€æ‹¦æˆªç­‰é€»è¾‘ | è‡ªå®šä¹‰æ³¨è§£ |

**ğŸ’» è¿è¡Œæ—¶å¤„ç†åŸºæœ¬æ­¥éª¤**
```java
// è¿è¡Œæ—¶æ³¨è§£è§£æå™¨æ ‡å‡†æµç¨‹
public class RuntimeAnnotationProcessor {
    
    public void processAnnotations(Class<?> clazz) throws Exception {
        // 1. è·å–Class/Method/Fieldå¯¹è±¡ï¼ˆé€šè¿‡åå°„ï¼‰
        Method[] methods = clazz.getDeclaredMethods();
        
        for (Method method : methods) {
            // 2. åˆ¤æ–­æ˜¯å¦æœ‰ç›®æ ‡æ³¨è§£
            if (method.isAnnotationPresent(Log.class)) {
                // 3. è·å–æ³¨è§£å¯¹è±¡
                Log logAnno = method.getAnnotation(Log.class);
                
                // 4. è¯»å–å±æ€§å€¼
                String level = logAnno.level();
                String message = logAnno.message();
                
                // 5. æ ¹æ®æ³¨è§£å±æ€§æ‰§è¡Œé€»è¾‘
                System.out.println("æ–¹æ³• " + method.getName() + 
                    " éœ€è¦è®°å½•æ—¥å¿—ï¼Œçº§åˆ«: " + level + ", æ¶ˆæ¯: " + message);
                
                // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å®é™…çš„æ—¥å¿—è®°å½•é€»è¾‘
                executeWithLogging(method, level, message);
            }
        }
    }
    
    private void executeWithLogging(Method method, String level, String message) {
        // å®é™…çš„æ—¥å¿—è®°å½•å’Œæ–¹æ³•æ‰§è¡Œé€»è¾‘
        System.out.println("[" + level + "] " + message + " - å¼€å§‹æ‰§è¡Œ");
        // method.invoke(instance, args); // å®é™…æ–¹æ³•è°ƒç”¨
        System.out.println("[" + level + "] " + message + " - æ‰§è¡Œå®Œæˆ");
    }
}
```

### 4.3 ç¼–è¯‘æœŸvsè¿è¡Œæ—¶å¯¹æ¯”


**ğŸ“Š ä¸¤ç§å¤„ç†æ–¹å¼è¯¦ç»†å¯¹æ¯”**

| å¯¹æ¯”é¡¹ | **ç¼–è¯‘æœŸæ³¨è§£è§£æå™¨** | **è¿è¡Œæ—¶æ³¨è§£è§£æå™¨** |
|-------|------------------|-------------------|
| **ç”Ÿå‘½å‘¨æœŸ** | ç¼–è¯‘æ—¶ | ç¨‹åºè¿è¡Œæ—¶ |
| **æŠ€æœ¯åŸºç¡€** | APTï¼ˆæ³¨è§£å¤„ç†å™¨ï¼‰ | åå°„ |
| **æ ¸å¿ƒç”¨é€”** | ç”Ÿæˆä»£ç ã€æ ¡éªŒã€é…ç½® | æ§åˆ¶é€»è¾‘ã€ä¾èµ–æ³¨å…¥ã€æƒé™ã€è·¯ç”± |
| **å¸¸è§åœºæ™¯** | Lombokã€Dagger | Springã€JUnitã€MyBatis |
| **å®ç°æ–¹å¼** | `AbstractProcessor` | `getAnnotation()` + `invoke()` |
| **æ€§èƒ½å½±å“** | ç¼–è¯‘æ—¶å¤„ç†ï¼Œè¿è¡Œæ—¶æ— å¼€é”€ | è¿è¡Œæ—¶åå°„ï¼Œæœ‰æ€§èƒ½å¼€é”€ |
| **çµæ´»æ€§** | ç¼–è¯‘æ—¶ç¡®å®šï¼Œè¿è¡Œæ—¶ä¸å¯å˜ | è¿è¡Œæ—¶åŠ¨æ€ï¼Œå¯æ ¹æ®æ¡ä»¶å¤„ç† |
| **è°ƒè¯•éš¾åº¦** | ç”Ÿæˆçš„ä»£ç è¾ƒéš¾è°ƒè¯• | å¯ä»¥è¿è¡Œæ—¶è°ƒè¯• |

---

## 5. ğŸ”„ æ³¨è§£çš„ç»§æ‰¿æ€§ä¸åå°„å¤„ç†


### 5.1 æ³¨è§£ç»§æ‰¿æœºåˆ¶


**ğŸ“‹ æ³¨è§£ç»§æ‰¿ç‰¹æ€§è¡¨**

| æ³¨è§£ç‰¹æ€§ | **æè¿°** | **é€‚ç”¨èŒƒå›´** |
|---------|---------|-------------|
| `@Inherited` | å…è®¸å­ç±»ç»§æ‰¿çˆ¶ç±»ä¸Šçš„æ³¨è§£ | **ä»…å¯¹ç±»æœ‰æ•ˆ**ï¼ˆæ–¹æ³•ã€å­—æ®µæ— æ•ˆï¼‰ |
| `getAnnotations()` | ä¼šè¿”å›ç»§æ‰¿çš„æ³¨è§£ | åŒ…å«çˆ¶ç±»ç»§æ‰¿çš„æ³¨è§£ |
| `getDeclaredAnnotations()` | åªè¿”å›å½“å‰ç±»ä¸Šå£°æ˜çš„æ³¨è§£ | ä¸åŒ…å«ç»§æ‰¿çš„æ³¨è§£ |

### 5.2 æ³¨è§£ç»§æ‰¿ç¤ºä¾‹


**ğŸ’» æ³¨è§£ç»§æ‰¿å®Œæ•´ç¤ºä¾‹**
```java
import java.lang.annotation.*;
import java.lang.reflect.*;

// 1. å®šä¹‰å¯ç»§æ‰¿çš„æ³¨è§£
@Inherited
@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.TYPE)
@interface Auth {
    String role() default "user";
    int level() default 1;
}

// 2. å®šä¹‰ä¸å¯ç»§æ‰¿çš„æ³¨è§£
@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.TYPE)
@interface Component {
    String value() default "";
}

// 3. çˆ¶ç±»ä½¿ç”¨æ³¨è§£
@Auth(role = "admin", level = 5)
@Component("baseService")
class BaseService {
    public void baseMethod() {
        System.out.println("BaseService method");
    }
}

// 4. å­ç±»ï¼ˆæµ‹è¯•ç»§æ‰¿ï¼‰
@Component("userService")
class UserService extends BaseService {
    public void userMethod() {
        System.out.println("UserService method");
    }
}

// 5. æ³¨è§£ç»§æ‰¿æµ‹è¯•
public class AnnotationInheritanceDemo {
    public static void main(String[] args) {
        Class<UserService> userServiceClass = UserService.class;
        Class<BaseService> baseServiceClass = BaseService.class;
        
        System.out.println("=== çˆ¶ç±»æ³¨è§£åˆ†æ ===");
        analyzeAnnotations(baseServiceClass);
        
        System.out.println("\n=== å­ç±»æ³¨è§£åˆ†æ ===");
        analyzeAnnotations(userServiceClass);
        
        System.out.println("\n=== ç»§æ‰¿æ€§éªŒè¯ ===");
        // @Inheritedæ³¨è§£ä¼šè¢«ç»§æ‰¿
        System.out.println("å­ç±»æ˜¯å¦æœ‰@Authæ³¨è§£: " + 
            userServiceClass.isAnnotationPresent(Auth.class));
        
        // é@Inheritedæ³¨è§£ä¸ä¼šè¢«ç»§æ‰¿
        System.out.println("å­ç±»æ˜¯å¦æœ‰@Componentæ³¨è§£: " + 
            userServiceClass.isAnnotationPresent(Component.class));
        
        // è·å–ç»§æ‰¿çš„@Authæ³¨è§£
        if (userServiceClass.isAnnotationPresent(Auth.class)) {
            Auth auth = userServiceClass.getAnnotation(Auth.class);
            System.out.println("ç»§æ‰¿çš„æƒé™è§’è‰²: " + auth.role());
            System.out.println("ç»§æ‰¿çš„æƒé™çº§åˆ«: " + auth.level());
        }
    }
    
    private static void analyzeAnnotations(Class<?> clazz) {
        System.out.println("ç±»: " + clazz.getSimpleName());
        
        // è·å–æ‰€æœ‰æ³¨è§£ï¼ˆåŒ…æ‹¬ç»§æ‰¿çš„ï¼‰
        Annotation[] allAnnotations = clazz.getAnnotations();
        System.out.println("æ‰€æœ‰æ³¨è§£æ•°é‡: " + allAnnotations.length);
        for (Annotation annotation : allAnnotations) {
            System.out.println("  - " + annotation.annotationType().getSimpleName());
        }
        
        // è·å–ç›´æ¥å£°æ˜çš„æ³¨è§£
        Annotation[] declaredAnnotations = clazz.getDeclaredAnnotations();
        System.out.println("ç›´æ¥å£°æ˜çš„æ³¨è§£æ•°é‡: " + declaredAnnotations.length);
        for (Annotation annotation : declaredAnnotations) {
            System.out.println("  - " + annotation.annotationType().getSimpleName());
        }
    }
}
```

### 5.3 æ³¨è§£ç»§æ‰¿æœ€ä½³å®è·µ


**ğŸ’¡ æ³¨è§£ç»§æ‰¿ä½¿ç”¨å»ºè®®**
```java
// 1. è®¾è®¡å¯ç»§æ‰¿çš„æ³¨è§£æ—¶è¦è°¨æ…
@Inherited  // åªæœ‰ç¡®å®éœ€è¦ç»§æ‰¿æ—¶æ‰åŠ ä¸Šè¿™ä¸ªæ³¨è§£
@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.TYPE)
@interface BusinessComponent {
    String domain() default "";
    boolean transactional() default false;
}

// 2. å¤„ç†æ³¨è§£æ—¶è¦åŒºåˆ†ç»§æ‰¿å’Œå£°æ˜
public class AnnotationInheritanceHelper {
    
    // è·å–ç±»çš„æ‰€æœ‰æ³¨è§£ï¼ˆåŒ…æ‹¬ç»§æ‰¿çš„ï¼‰
    public static <T extends Annotation> T getInheritedAnnotation(
            Class<?> clazz, Class<T> annotationType) {
        return clazz.getAnnotation(annotationType);
    }
    
    // ä»…è·å–ç›´æ¥å£°æ˜çš„æ³¨è§£
    public static <T extends Annotation> T getDeclaredAnnotation(
            Class<?> clazz, Class<T> annotationType) {
        return clazz.getDeclaredAnnotation(annotationType);
    }
    
    // æ£€æŸ¥æ³¨è§£æ˜¯æ¥è‡ªç»§æ‰¿è¿˜æ˜¯ç›´æ¥å£°æ˜
    public static boolean isAnnotationInherited(Class<?> clazz, 
            Class<? extends Annotation> annotationType) {
        return clazz.isAnnotationPresent(annotationType) && 
               !clazz.getDeclaredAnnotation(annotationType).equals(
                   clazz.getAnnotation(annotationType));
    }
}
```

---

## 6. â° è¿è¡Œæ—¶æ³¨è§£vsç¼–è¯‘æ—¶æ³¨è§£


### 6.1 ä¿ç•™ç­–ç•¥å¯¹æ¯”


**ğŸ“‹ æ³¨è§£ä¿ç•™ç­–ç•¥è¯¦ç»†å¯¹æ¯”**

| å¯¹æ¯”é¡¹ | **è¿è¡Œæ—¶æ³¨è§£**<br>`@Retention(RUNTIME)` | **ç¼–è¯‘æ—¶æ³¨è§£**<br>`@Retention(CLASS/SOURCE)` |
|-------|---------------------------------------|---------------------------------------------|
| **å¤„ç†æ–¹å¼** | é€šè¿‡åå°„å¤„ç† | é€šè¿‡æ³¨è§£å¤„ç†å™¨ï¼ˆAPTï¼‰ |
| **ä½¿ç”¨é˜¶æ®µ** | ç¨‹åºè¿è¡Œæ—¶ | ç¼–è¯‘æœŸ |
| **å…¸å‹åº”ç”¨** | Springã€JUnitã€MyBatis | Lombokã€Daggerã€AutoService |
| **åå°„å¯è§æ€§** | âœ… å¯è·å– | âŒ è¿è¡Œæ—¶ä¸å¯è§ |
| **æ€§èƒ½å½±å“** | è¿è¡Œæ—¶æœ‰åå°„å¼€é”€ | ç¼–è¯‘åæ— è¿è¡Œæ—¶å¼€é”€ |
| **çµæ´»æ€§** | å¯åŠ¨æ€å¤„ç† | ç¼–è¯‘æ—¶å›ºåŒ– |

### 6.2 ä¸åŒä¿ç•™ç­–ç•¥ç¤ºä¾‹


**ğŸ’» ä¸‰ç§ä¿ç•™ç­–ç•¥å¯¹æ¯”ç¤ºä¾‹**
```java
import java.lang.annotation.*;
import java.lang.reflect.*;

// 1. SOURCEçº§åˆ«æ³¨è§£ï¼ˆç¼–è¯‘åä¸¢å¼ƒï¼‰
@Retention(RetentionPolicy.SOURCE)
@Target(ElementType.METHOD)
@interface SourceAnno {
    String value() default "";
}

// 2. CLASSçº§åˆ«æ³¨è§£ï¼ˆä¿ç•™åˆ°.classæ–‡ä»¶ï¼Œè¿è¡Œæ—¶ä¸å¯è§ï¼‰
@Retention(RetentionPolicy.CLASS)
@Target(ElementType.FIELD)
@interface ClassAnno {
    String value() default "";
}

// 3. RUNTIMEçº§åˆ«æ³¨è§£ï¼ˆè¿è¡Œæ—¶å¯è§ï¼‰
@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.TYPE)
@interface RuntimeAnno {
    String value() default "";
}

// 4. æµ‹è¯•ç±»
@RuntimeAnno("è¿è¡Œæ—¶æ³¨è§£")
class TestClass {
    @ClassAnno("ç±»çº§åˆ«æ³¨è§£")
    private String field;
    
    @SourceAnno("æºç çº§åˆ«æ³¨è§£")
    public void method() {
        System.out.println("Test method");
    }
}

// 5. æ³¨è§£å¯è§æ€§æµ‹è¯•
public class AnnotationRetentionDemo {
    public static void main(String[] args) throws Exception {
        Class<TestClass> clazz = TestClass.class;
        
        // æµ‹è¯•ç±»çº§åˆ«æ³¨è§£
        System.out.println("=== ç±»æ³¨è§£æµ‹è¯• ===");
        if (clazz.isAnnotationPresent(RuntimeAnno.class)) {
            RuntimeAnno anno = clazz.getAnnotation(RuntimeAnno.class);
            System.out.println("RUNTIMEæ³¨è§£å¯è§: " + anno.value());
        } else {
            System.out.println("RUNTIMEæ³¨è§£ä¸å¯è§");
        }
        
        // æµ‹è¯•å­—æ®µçº§åˆ«æ³¨è§£
        System.out.println("\n=== å­—æ®µæ³¨è§£æµ‹è¯• ===");
        Field field = clazz.getDeclaredField("field");
        if (field.isAnnotationPresent(ClassAnno.class)) {
            System.out.println("CLASSæ³¨è§£åœ¨è¿è¡Œæ—¶å¯è§");
        } else {
            System.out.println("CLASSæ³¨è§£åœ¨è¿è¡Œæ—¶ä¸å¯è§");
        }
        
        // æµ‹è¯•æ–¹æ³•çº§åˆ«æ³¨è§£
        System.out.println("\n=== æ–¹æ³•æ³¨è§£æµ‹è¯• ===");
        Method method = clazz.getMethod("method");
        if (method.isAnnotationPresent(SourceAnno.class)) {
            System.out.println("SOURCEæ³¨è§£åœ¨è¿è¡Œæ—¶å¯è§");
        } else {
            System.out.println("SOURCEæ³¨è§£åœ¨è¿è¡Œæ—¶ä¸å¯è§");
        }
        
        // æ˜¾ç¤ºæ‰€æœ‰å¯è§çš„æ³¨è§£
        System.out.println("\n=== æ‰€æœ‰è¿è¡Œæ—¶å¯è§çš„æ³¨è§£ ===");
        showAllRuntimeAnnotations(clazz);
    }
    
    private static void showAllRuntimeAnnotations(Class<?> clazz) {
        // ç±»æ³¨è§£
        Annotation[] classAnnotations = clazz.getAnnotations();
        System.out.println("ç±»æ³¨è§£æ•°é‡: " + classAnnotations.length);
        
        // å­—æ®µæ³¨è§£
        for (Field field : clazz.getDeclaredFields()) {
            Annotation[] fieldAnnotations = field.getAnnotations();
            System.out.println("å­—æ®µ " + field.getName() + " æ³¨è§£æ•°é‡: " + fieldAnnotations.length);
        }
        
        // æ–¹æ³•æ³¨è§£
        for (Method method : clazz.getDeclaredMethods()) {
            Annotation[] methodAnnotations = method.getAnnotations();
            System.out.println("æ–¹æ³• " + method.getName() + " æ³¨è§£æ•°é‡: " + methodAnnotations.length);
        }
    }
}
```

### 6.3 é€‰æ‹©ä¿ç•™ç­–ç•¥çš„æŒ‡å¯¼åŸåˆ™


**ğŸ’¡ ä¿ç•™ç­–ç•¥é€‰æ‹©æŒ‡å—**

| ä½¿ç”¨åœºæ™¯ | **æ¨èç­–ç•¥** | **åŸå› ** |
|---------|-------------|---------|
| **ä»£ç ç”Ÿæˆ** | `SOURCE` | ç¼–è¯‘åä¸éœ€è¦ä¿ç•™ï¼Œé¿å….classæ–‡ä»¶è†¨èƒ€ |
| **ç¼–è¯‘æœŸæ£€æŸ¥** | `SOURCE` | ä»…ç¼–è¯‘æ—¶éªŒè¯ï¼Œè¿è¡Œæ—¶æ— ç”¨ |
| **å­—èŠ‚ç å·¥å…·åˆ†æ** | `CLASS` | éœ€è¦åœ¨.classæ–‡ä»¶ä¸­ä¿ç•™ï¼Œä½†è¿è¡Œæ—¶ä¸è®¿é—® |
| **è¿è¡Œæ—¶æ¡†æ¶** | `RUNTIME` | éœ€è¦è¿è¡Œæ—¶é€šè¿‡åå°„è®¿é—® |
| **ä¾èµ–æ³¨å…¥** | `RUNTIME` | Springç­‰æ¡†æ¶éœ€è¦è¿è¡Œæ—¶å¤„ç† |
| **æµ‹è¯•æ¡†æ¶** | `RUNTIME` | JUnitéœ€è¦è¿è¡Œæ—¶è¯†åˆ«æµ‹è¯•æ–¹æ³• |

---

## 7. ğŸ¯ å¸¸è§åº”ç”¨åœºæ™¯


### 7.1 æ³¨è§£+åå°„åº”ç”¨åœºæ™¯æ€»è§ˆ


**ğŸ“‹ å…¸å‹åº”ç”¨åœºæ™¯è¡¨**

| åœºæ™¯ | **æè¿°** | **æ³¨è§£ç¤ºä¾‹** | **åå°„å¤„ç†** |
|-----|---------|-------------|-------------|
| **æ§åˆ¶è®¿é—®** | é€šè¿‡`@Permission(level=3)`æ§åˆ¶æ–¹æ³•æ˜¯å¦æ‰§è¡Œ | `@Permission`, `@Role` | æ–¹æ³•è°ƒç”¨å‰æ£€æŸ¥æƒé™ |
| **è‡ªåŠ¨æ³¨å…¥** | æ‰«æ`@Inject`å­—æ®µï¼Œé€šè¿‡åå°„è®¾ç½®å€¼ | `@Autowired`, `@Resource` | å­—æ®µèµ‹å€¼ |
| **æ³¨å†Œç»„ä»¶** | ç±»ä¸Š`@Component("name")`è‡ªåŠ¨æ³¨å†Œåˆ°Map | `@Component`, `@Service` | å®ä¾‹åŒ–å¹¶æ³¨å†Œ |
| **è¡¨å­—æ®µæ˜ å°„** | `@Column("user_name")`æ˜ å°„æ•°æ®åº“å­—æ®µ | `@Entity`, `@Table`, `@Column` | ORMå­—æ®µæ˜ å°„ |
| **æ¥å£æš´éœ²** | `@Endpoint("/api/user")`é…åˆåå°„æ³¨å†Œè·¯ç”± | `@RequestMapping`, `@GetMapping` | è·¯ç”±æ³¨å†Œ |

### 7.2 æƒé™æ§åˆ¶æ¡†æ¶ç¤ºä¾‹


**ğŸ’» æ³¨è§£é©±åŠ¨çš„æƒé™æ§åˆ¶å®ç°**
```java
import java.lang.annotation.*;
import java.lang.reflect.*;

// 1. å®šä¹‰æƒé™æ³¨è§£
@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.METHOD)
@interface RequirePermission {
    String value();
    int level() default 1;
    String[] roles() default {};
}

@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.TYPE)
@interface SecureController {
    String module() default "";
}

// 2. ç”¨æˆ·ä¸Šä¸‹æ–‡
class UserContext {
    private static final ThreadLocal<User> currentUser = new ThreadLocal<>();
    
    public static void setCurrentUser(User user) {
        currentUser.set(user);
    }
    
    public static User getCurrentUser() {
        return currentUser.get();
    }
    
    public static void clear() {
        currentUser.remove();
    }
}

class User {
    private String username;
    private String[] roles;
    private int permissionLevel;
    
    public User(String username, String[] roles, int permissionLevel) {
        this.username = username;
        this.roles = roles;
        this.permissionLevel = permissionLevel;
    }
    
    // getters
    public String getUsername() { return username; }
    public String[] getRoles() { return roles; }
    public int getPermissionLevel() { return permissionLevel; }
}

// 3. ä¸šåŠ¡æ§åˆ¶å™¨
@SecureController(module = "user")
class UserController {
    
    @RequirePermission(value = "user:read", level = 1)
    public String getUserInfo(String userId) {
        return "ç”¨æˆ·ä¿¡æ¯: " + userId;
    }
    
    @RequirePermission(value = "user:write", level = 3, roles = {"admin", "manager"})
    public String updateUser(String userId, String data) {
        return "æ›´æ–°ç”¨æˆ·: " + userId + " with " + data;
    }
    
    @RequirePermission(value = "user:delete", level = 5, roles = {"admin"})
    public String deleteUser(String userId) {
        return "åˆ é™¤ç”¨æˆ·: " + userId;
    }
    
    // æ— æƒé™è¦æ±‚çš„æ–¹æ³•
    public String publicInfo() {
        return "å…¬å¼€ä¿¡æ¯";
    }
}

// 4. æƒé™æ£€æŸ¥å™¨
class PermissionChecker {
    
    public static boolean checkPermission(Method method, Object target) {
        // æ£€æŸ¥ç±»çº§åˆ«æƒé™
        Class<?> clazz = target.getClass();
        if (clazz.isAnnotationPresent(SecureController.class)) {
            SecureController secureController = clazz.getAnnotation(SecureController.class);
            System.out.println("è®¿é—®å®‰å…¨æ¨¡å—: " + secureController.module());
        }
        
        // æ£€æŸ¥æ–¹æ³•çº§åˆ«æƒé™
        if (method.isAnnotationPresent(RequirePermission.class)) {
            RequirePermission permission = method.getAnnotation(RequirePermission.class);
            return validatePermission(permission);
        }
        
        return true; // æ— æƒé™è¦æ±‚ï¼Œå…è®¸è®¿é—®
    }
    
    private static boolean validatePermission(RequirePermission permission) {
        User currentUser = UserContext.getCurrentUser();
        if (currentUser == null) {
            System.out.println("æƒé™æ£€æŸ¥å¤±è´¥: ç”¨æˆ·æœªç™»å½•");
            return false;
        }
        
        // æ£€æŸ¥æƒé™çº§åˆ«
        if (currentUser.getPermissionLevel() < permission.level()) {
            System.out.printf("æƒé™æ£€æŸ¥å¤±è´¥: éœ€è¦çº§åˆ« %d, å½“å‰çº§åˆ« %d%n", 
                permission.level(), currentUser.getPermissionLevel());
            return false;
        }
        
        // æ£€æŸ¥è§’è‰²
        String[] requiredRoles = permission.roles();
        if (requiredRoles.length > 0) {
            boolean hasRole = false;
            for (String requiredRole : requiredRoles) {
                for (String userRole : currentUser.getRoles()) {
                    if (requiredRole.equals(userRole)) {
                        hasRole = true;
                        break;
                    }
                }
                if (hasRole) break;
            }
            
            if (!hasRole) {
                System.out.println("æƒé™æ£€æŸ¥å¤±è´¥: ç¼ºå°‘å¿…è¦è§’è‰² " + 
                    java.util.Arrays.toString(requiredRoles));
                return false;
            }
        }
        
        System.out.println("æƒé™æ£€æŸ¥é€šè¿‡: " + permission.value());
        return true;
    }
}

// 5. æ–¹æ³•è°ƒç”¨ä»£ç†
class SecureMethodInvoker {
    
    public static Object invokeSecurely(Object target, String methodName, 
            Class<?>[] paramTypes, Object[] args) throws Exception {
        Method method = target.getClass().getMethod(methodName, paramTypes);
        
        // æƒé™æ£€æŸ¥
        if (!PermissionChecker.checkPermission(method, target)) {
            throw new SecurityException("æƒé™ä¸è¶³ï¼Œæ— æ³•è°ƒç”¨æ–¹æ³•: " + methodName);
        }
        
        // æ‰§è¡Œæ–¹æ³•
        return method.invoke(target, args);
    }
}

// 6. æµ‹è¯•æƒé™æ§åˆ¶
public class PermissionControlDemo {
    public static void main(String[] args) throws Exception {
        UserController controller = new UserController();
        
        // æµ‹è¯•1: æœªç™»å½•ç”¨æˆ·
        System.out.println("=== æµ‹è¯•1: æœªç™»å½•ç”¨æˆ· ===");
        try {
            SecureMethodInvoker.invokeSecurely(controller, "getUserInfo", 
                new Class[]{String.class}, new Object[]{"user123"});
        } catch (SecurityException e) {
            System.out.println("å¼‚å¸¸: " + e.getMessage());
        }
        
        // æµ‹è¯•2: æ™®é€šç”¨æˆ·
        System.out.println("\n=== æµ‹è¯•2: æ™®é€šç”¨æˆ· ===");
        UserContext.setCurrentUser(new User("alice", new String[]{"user"}, 2));
        try {
            Object result = SecureMethodInvoker.invokeSecurely(controller, "getUserInfo", 
                new Class[]{String.class}, new Object[]{"user123"});
            System.out.println("ç»“æœ: " + result);
        } catch (SecurityException e) {
            System.out.println("å¼‚å¸¸: " + e.getMessage());
        }
        
        // æµ‹è¯•3: ç®¡ç†å‘˜ç”¨æˆ·
        System.out.println("\n=== æµ‹è¯•3: ç®¡ç†å‘˜ç”¨æˆ· ===");
        UserContext.setCurrentUser(new User("admin", new String[]{"admin", "manager"}, 5));
        try {
            Object result1 = SecureMethodInvoker.invokeSecurely(controller, "updateUser", 
                new Class[]{String.class, String.class}, new Object[]{"user123", "newData"});
            System.out.println("ç»“æœ: " + result1);
            
            Object result2 = SecureMethodInvoker.invokeSecurely(controller, "deleteUser", 
                new Class[]{String.class}, new Object[]{"user123"});
            System.out.println("ç»“æœ: " + result2);
        } catch (SecurityException e) {
            System.out.println("å¼‚å¸¸: " + e.getMessage());
        }
        
        // æ¸…ç†ä¸Šä¸‹æ–‡
        UserContext.clear();
    }
}
```

---

## 8. ğŸ”Œ SPIæœºåˆ¶è¯¦è§£


### 8.1 SPIåŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ SPIç»„æˆè¦ç´ **
SPIï¼ˆService Provider Interfaceï¼‰= æ¥å£ + å®ç° + é…ç½® + åå°„

| ç»„æˆ | **è¯´æ˜** | **ç¤ºä¾‹** |
|-----|---------|---------|
| **æ¥å£ï¼ˆService Interfaceï¼‰** | æ ‡å‡†æœåŠ¡æ¥å£ | `java.sql.Driver` |
| **å®ç°ç±»ï¼ˆProviderï¼‰** | æ¥å£çš„ä¸€ä¸ªæˆ–å¤šä¸ªå®ç° | `MySQLDriver` |
| **é…ç½®æ–‡ä»¶** | æ”¾åœ¨`META-INF/services/`ç›®å½•ä¸‹ï¼Œæ–‡ä»¶åä¸ºæ¥å£å…¨ç±»åï¼Œå†…å®¹æ˜¯å®ç°ç±»çš„å…¨ç±»å | `META-INF/services/java.sql.Driver` |
| **åå°„åŠ è½½æœºåˆ¶** | ä½¿ç”¨`java.util.ServiceLoader`åœ¨è¿è¡Œæ—¶è¯»å–é…ç½®ï¼Œé€šè¿‡åå°„åˆ›å»ºå®ç°å¯¹è±¡ | `ServiceLoader.load()` |

### 8.2 SPIå·¥ä½œåŸç†


**ğŸ”§ SPIåº•å±‚æµç¨‹**
```
SPIå·¥ä½œæµç¨‹
â”œâ”€â”€ 1. æŒ‡å®šæ¥å£ï¼Œå¦‚MyService
â”œâ”€â”€ 2. åœ¨META-INF/services/ä¸‹æ–°å»ºæ–‡ä»¶ï¼šcom.xxx.MyService
â”œâ”€â”€ 3. å†™å…¥å®ç°ç±»å…¨åï¼Œå¦‚com.xxx.impl.MyServiceImpl
â”œâ”€â”€ 4. ä½¿ç”¨ServiceLoaderåŠ è½½æ¥å£å®ç°ï¼š
â”‚   â””â”€â”€ ServiceLoader.load(MyService.class)
â””â”€â”€ 5. ServiceLoaderä¼šè¯»å–æ–‡ä»¶â†’åå°„åˆ›å»ºå®ç°å¯¹è±¡
```

### 8.3 SPIå®Œæ•´å®ç°ç¤ºä¾‹


**ğŸ’» è‡ªå®šä¹‰SPIå®ç°**
```java
// 1. å®šä¹‰æœåŠ¡æ¥å£
package com.example.spi;

public interface MessageService {
    void sendMessage(String message, String recipient);
    String getProviderName();
}

// 2. å®ç°ç±»1ï¼šé‚®ä»¶æœåŠ¡
package com.example.spi.impl;

import com.example.spi.MessageService;

public class EmailMessageService implements MessageService {
    @Override
    public void sendMessage(String message, String recipient) {
        System.out.println("é€šè¿‡é‚®ä»¶å‘é€æ¶ˆæ¯:");
        System.out.println("æ”¶ä»¶äºº: " + recipient);
        System.out.println("å†…å®¹: " + message);
    }
    
    @Override
    public String getProviderName() {
        return "Email Provider";
    }
}

// 3. å®ç°ç±»2ï¼šçŸ­ä¿¡æœåŠ¡
package com.example.spi.impl;

import com.example.spi.MessageService;

public class SmsMessageService implements MessageService {
    @Override
    public void sendMessage(String message, String recipient) {
        System.out.println("é€šè¿‡çŸ­ä¿¡å‘é€æ¶ˆæ¯:");
        System.out.println("æ‰‹æœºå·: " + recipient);
        System.out.println("å†…å®¹: " + message);
    }
    
    @Override
    public String getProviderName() {
        return "SMS Provider";
    }
}

// 4. é…ç½®æ–‡ä»¶
// æ–‡ä»¶è·¯å¾„: src/main/resources/META-INF/services/com.example.spi.MessageService
// æ–‡ä»¶å†…å®¹:
com.example.spi.impl.EmailMessageService
com.example.spi.impl.SmsMessageService

// 5. SPIä½¿ç”¨ç¤ºä¾‹
package com.example.spi;

import java.util.ServiceLoader;

public class SPIDemo {
    public static void main(String[] args) {
        System.out.println("=== SPIæœåŠ¡å‘ç°ä¸åŠ è½½æ¼”ç¤º ===");
        
        // åŠ è½½æ‰€æœ‰MessageServiceå®ç°
        ServiceLoader<MessageService> serviceLoader = 
            ServiceLoader.load(MessageService.class);
        
        System.out.println("å‘ç°çš„æœåŠ¡æä¾›è€…:");
        for (MessageService service : serviceLoader) {
            System.out.println("- " + service.getProviderName() + 
                " (" + service.getClass().getName() + ")");
        }
        
        System.out.println("\n=== ä½¿ç”¨å„ä¸ªæœåŠ¡æä¾›è€… ===");
        // ä½¿ç”¨æ‰€æœ‰æœåŠ¡å‘é€æ¶ˆæ¯
        for (MessageService service : serviceLoader) {
            System.out.println("\nä½¿ç”¨ " + service.getProviderName() + ":");
            service.sendMessage("Hello SPI!", "user@example.com");
        }
        
        // é€‰æ‹©ç‰¹å®šçš„æœåŠ¡æä¾›è€…
        System.out.println("\n=== é€‰æ‹©ç‰¹å®šæœåŠ¡æä¾›è€… ===");
        MessageService preferredService = findServiceByName("Email Provider");
        if (preferredService != null) {
            preferredService.sendMessage("é‡è¦é€šçŸ¥", "admin@company.com");
        }
    }
    
    private static MessageService findServiceByName(String providerName) {
        ServiceLoader<MessageService> serviceLoader = 
            ServiceLoader.load(MessageService.class);
        
        for (MessageService service : serviceLoader) {
            if (providerName.equals(service.getProviderName())) {
                return service;
            }
        }
        return null;
    }
}
```

### 8.4 SPIä¸»è¦ä½œç”¨ä¸åº”ç”¨


**ğŸ“‹ SPIæ ¸å¿ƒä»·å€¼è¡¨**

| ç”¨é€” | **è¯´æ˜** | **å…¸å‹åº”ç”¨** |
|-----|---------|-------------|
| **æ¨¡å—è§£è€¦** | æ¥å£å’Œå®ç°å®Œå…¨è§£è€¦ï¼Œç¬¦åˆå¼€é—­åŸåˆ™ | JDBCé©±åŠ¨åˆ‡æ¢ |
| **æ’ä»¶æœºåˆ¶** | å¯é€šè¿‡é…ç½®åŠ¨æ€åŠ è½½ä»»æ„å®ç° | IDEæ’ä»¶ç³»ç»Ÿ |
| **æ‰©å±•æ€§å¥½** | å¢åŠ æ–°å®ç°ä¸éœ€ä¿®æ”¹ä»£ç  | æ—¥å¿—æ¡†æ¶SLF4J |
| **æœåŠ¡å‘ç°** | è‡ªåŠ¨å‘ç°å’ŒåŠ è½½æœåŠ¡å®ç° | DubboæœåŠ¡å‘ç° |

**ğŸ”§ SPIç»å…¸åº”ç”¨æ¡ˆä¾‹**
```java
// JDBCå°±æ˜¯ç»å…¸çš„SPIåº”ç”¨
// æ¥å£ï¼šjava.sql.Driver
// MySQLå®ç°ï¼šcom.mysql.cj.jdbc.Driver
// PostgreSQLå®ç°ï¼šorg.postgresql.Driver

// SPIé…ç½®æ–‡ä»¶ï¼šMETA-INF/services/java.sql.Driver
// MySQLçš„é…ç½®å†…å®¹ï¼š
// com.mysql.cj.jdbc.Driver

// åŠ è½½æ–¹å¼ï¼š
ServiceLoader<Driver> loader = ServiceLoader.load(Driver.class);
for (Driver driver : loader) {
    System.out.println("å‘ç°æ•°æ®åº“é©±åŠ¨: " + driver.getClass().getName());
}
// ç¨‹åºå¯åŠ¨æ—¶è‡ªåŠ¨åŠ è½½æ‰€æœ‰Driverå®ç°ç±»ï¼Œè€Œæ— éœ€å†™æ­»ä¾èµ–
```

### 8.5 SPIä¸Springå¯¹æ¯”


**âš–ï¸ SPI vs Springæ¡†æ¶å¯¹æ¯”**

| æ¯”è¾ƒé¡¹ | **SPI** | **Spring** |
|-------|---------|-----------|
| **æœ¬è´¨** | JDKæä¾›çš„æœåŠ¡å‘ç°æœºåˆ¶ | IoCå®¹å™¨+Beanç”Ÿå‘½å‘¨æœŸç®¡ç† |
| **é…ç½®æ–¹å¼** | `META-INF/services/` | æ³¨è§£ã€XMLã€JavaConfig |
| **åŠ è½½æœºåˆ¶** | `ServiceLoader`+åå°„ | æ³¨è§£æ‰«æã€ä¾èµ–æ³¨å…¥ |
| **æ‰©å±•èƒ½åŠ›** | æ’ä»¶åŒ–ã€åŠ¨æ€åŠ è½½ | åº”ç”¨çº§ä¾èµ–ç®¡ç†ã€è‡ªåŠ¨è£…é… |
| **å¤æ‚åº¦** | ç®€å•è½»é‡ | åŠŸèƒ½ä¸°å¯Œä½†å¤æ‚ |
| **é€‚ç”¨åœºæ™¯** | æœåŠ¡å‘ç°ã€æ’ä»¶ç³»ç»Ÿ | ä¼ä¸šçº§åº”ç”¨å¼€å‘ |

---

## 9. âš ï¸ å…¸å‹é™·é˜±ä¸æ³¨æ„äº‹é¡¹


### 9.1 å¸¸è§é—®é¢˜æ±‡æ€»


**ğŸ“‹ æ³¨è§£+åå°„å¸¸è§é™·é˜±è¡¨**

| é—®é¢˜ | **æè¿°** | **è§£å†³æ–¹æ¡ˆ** |
|-----|---------|-------------|
| **æ³¨è§£å±æ€§å€¼è¯»å–å¼‚å¸¸** | å±æ€§åæ‹¼é”™ã€é»˜è®¤å€¼æœªç†è§£æ¸…æ¥š | ä»”ç»†æ£€æŸ¥æ³¨è§£å®šä¹‰å’Œå±æ€§å |
| **æ³›å‹ä¿¡æ¯ä¸¢å¤±** | åå°„è¯»ä¸åˆ°æ³¨è§£ä¸­æ³›å‹ä¿¡æ¯ | ä½¿ç”¨ParameterizedTypeæˆ–TypeToken |
| **`@Inherited`ä»…æ”¯æŒç±»æ³¨è§£ç»§æ‰¿** | æ–¹æ³•ã€å­—æ®µæ— æ•ˆ | æ˜ç¡®ç»§æ‰¿è§„åˆ™ï¼Œå¿…è¦æ—¶æ‰‹åŠ¨å¤„ç† |
| **æ¨¡å—åŒ–é™åˆ¶è®¿é—®æ³¨è§£** | Java 9+æ¨¡å—æœªå¼€æ”¾åŒ…ä¼šæŠ›å¼‚å¸¸ | ä½¿ç”¨--add-opensæˆ–module-info.java |
| **ç¼–è¯‘æœŸæ³¨è§£æ— æ³•ç”¨åå°„è¯»å–** | `@Retention(SOURCE)`æ³¨è§£åœ¨è¿è¡Œæ—¶ä¸å¯è§ | ä½¿ç”¨RUNTIMEä¿ç•™ç­–ç•¥ |

### 9.2 è¯¦ç»†é—®é¢˜è§£å†³æ–¹æ¡ˆ


**ğŸ’» å¸¸è§é—®é¢˜è§£å†³ç¤ºä¾‹**
```java
// 1. æ³¨è§£å±æ€§è¯»å–å¼‚å¸¸å¤„ç†
public class AnnotationSafetyUtils {
    
    public static <T extends Annotation> T getAnnotationSafely(
            AnnotatedElement element, Class<T> annotationType) {
        try {
            return element.getAnnotation(annotationType);
        } catch (Exception e) {
            System.err.println("è·å–æ³¨è§£å¤±è´¥: " + annotationType.getName() + 
                ", é”™è¯¯: " + e.getMessage());
            return null;
        }
    }
    
    public static String getAnnotationValue(Annotation annotation, String propertyName) {
        try {
            Method method = annotation.annotationType().getMethod(propertyName);
            Object value = method.invoke(annotation);
            return value != null ? value.toString() : "";
        } catch (NoSuchMethodException e) {
            System.err.println("æ³¨è§£å±æ€§ä¸å­˜åœ¨: " + propertyName);
            return "";
        } catch (Exception e) {
            System.err.println("è¯»å–æ³¨è§£å±æ€§å¤±è´¥: " + e.getMessage());
            return "";
        }
    }
}

// 2. æ³›å‹ä¿¡æ¯å¤„ç†
@Retention(RetentionPolicy.RUNTIME)
@Target(ElementType.FIELD)
@interface GenericInject {
    Class<?> type() default Object.class;
    String value() default "";
}

public class GenericAnnotationHandler {
    
    @GenericInject(type = List.class, value = "userList")
    private List<String> users;
    
    public static void handleGenericAnnotation() throws Exception {
        Field field = GenericAnnotationHandler.class.getDeclaredField("users");
        GenericInject annotation = field.getAnnotation(GenericInject.class);
        
        if (annotation != null) {
            Class<?> declaredType = annotation.type();
            System.out.println("å£°æ˜çš„ç±»å‹: " + declaredType.getName());
            
            // è·å–å­—æ®µçš„æ³›å‹ç±»å‹
            Type genericType = field.getGenericType();
            if (genericType instanceof ParameterizedType) {
                ParameterizedType paramType = (ParameterizedType) genericType;
                Type[] actualTypes = paramType.getActualTypeArguments();
                System.out.println("æ³›å‹å‚æ•°: " + java.util.Arrays.toString(actualTypes));
            }
        }
    }
}

// 3. æ¨¡å—åŒ–è®¿é—®å¤„ç†
public class ModuleCompatibilityHandler {
    
    public static boolean canAccessAnnotation(Class<?> clazz, 
            Class<? extends Annotation> annotationType) {
        try {
            // å°è¯•è®¿é—®æ³¨è§£
            return clazz.isAnnotationPresent(annotationType);
        } catch (IllegalAccessError | SecurityException e) {
            System.err.println("æ¨¡å—åŒ–é™åˆ¶: æ— æ³•è®¿é—®æ³¨è§£ " + annotationType.getName());
            System.err.println("å»ºè®®æ·»åŠ JVMå‚æ•°: --add-opens " + 
                clazz.getModule().getName() + "/" + clazz.getPackageName() + "=ALL-UNNAMED");
            return false;
        }
    }
    
    public static <T extends Annotation> T getAnnotationWithModuleCheck(
            Class<?> clazz, Class<T> annotationType) {
        if (canAccessAnnotation(clazz, annotationType)) {
            return clazz.getAnnotation(annotationType);
        }
        return null;
    }
}
```

### 9.3 æ€§èƒ½ä¼˜åŒ–å»ºè®®


**âš¡ æ³¨è§£å¤„ç†æ€§èƒ½ä¼˜åŒ–**
```java
public class AnnotationPerformanceOptimizer {
    
    // æ³¨è§£ä¿¡æ¯ç¼“å­˜
    private static final Map<Class<?>, Map<Class<? extends Annotation>, Annotation>> 
        ANNOTATION_CACHE = new ConcurrentHashMap<>();
    
    // æ–¹æ³•æ³¨è§£ç¼“å­˜
    private static final Map<Method, Map<Class<? extends Annotation>, Annotation>> 
        METHOD_ANNOTATION_CACHE = new ConcurrentHashMap<>();
    
    /**
     * ç¼“å­˜å¼è·å–ç±»æ³¨è§£
     */
    @SuppressWarnings("unchecked")
    public static <T extends Annotation> T getCachedAnnotation(
            Class<?> clazz, Class<T> annotationType) {
        Map<Class<? extends Annotation>, Annotation> classAnnotations = 
            ANNOTATION_CACHE.computeIfAbsent(clazz, k -> {
                Map<Class<? extends Annotation>, Annotation> map = new HashMap<>();
                for (Annotation annotation : k.getAnnotations()) {
                    map.put(annotation.annotationType(), annotation);
                }
                return map;
            });
        
        return (T) classAnnotations.get(annotationType);
    }
    
    /**
     * ç¼“å­˜å¼è·å–æ–¹æ³•æ³¨è§£
     */
    @SuppressWarnings("unchecked")
    public static <T extends Annotation> T getCachedMethodAnnotation(
            Method method, Class<T> annotationType) {
        Map<Class<? extends Annotation>, Annotation> methodAnnotations = 
            METHOD_ANNOTATION_CACHE.computeIfAbsent(method, k -> {
                Map<Class<? extends Annotation>, Annotation> map = new HashMap<>();
                for (Annotation annotation : k.getAnnotations()) {
                    map.put(annotation.annotationType(), annotation);
                }
                return map;
            });
        
        return (T) methodAnnotations.get(annotationType);
    }
    
    /**
     * æ‰¹é‡å¤„ç†æ³¨è§£ï¼Œå‡å°‘åå°„è°ƒç”¨
     */
    public static void batchProcessAnnotations(Class<?> clazz, 
            AnnotationProcessor processor) {
        // ä¸€æ¬¡æ€§è·å–æ‰€æœ‰æ³¨è§£ï¼Œé¿å…å¤šæ¬¡åå°„è°ƒç”¨
        Annotation[] annotations = clazz.getAnnotations();
        Field[] fields = clazz.getDeclaredFields();
        Method[] methods = clazz.getDeclaredMethods();
        
        // æ‰¹é‡å¤„ç†
        processor.processClassAnnotations(annotations);
        processor.processFieldAnnotations(fields);
        processor.processMethodAnnotations(methods);
    }
    
    // æ³¨è§£å¤„ç†æ¥å£
    public interface AnnotationProcessor {
        void processClassAnnotations(Annotation[] annotations);
        void processFieldAnnotations(Field[] fields);
        void processMethodAnnotations(Method[] methods);
    }
}
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ”¸ åå°„+æ³¨è§£ç»“åˆï¼šæ³¨è§£å£°æ˜æ„å›¾ï¼Œåå°„å®ç°è§£é‡Šå’Œæ‰§è¡Œ
ğŸ”¸ å£°æ˜å¼ç¼–ç¨‹ï¼šé€šè¿‡æ³¨è§£æ ‡è®°ï¼Œæ¡†æ¶è‡ªåŠ¨å“åº”ï¼Œæå‡å¼€å‘æ•ˆç‡
ğŸ”¸ æ³¨è§£ä¿ç•™ç­–ç•¥ï¼šSOURCEã€CLASSã€RUNTIMEä¸‰ç§ï¼Œåªæœ‰RUNTIMEå¯è¢«åå°„è®¿é—®
ğŸ”¸ æ³¨è§£ç»§æ‰¿æ€§ï¼šåªæœ‰@Inheritedä¿®é¥°çš„ç±»çº§åˆ«æ³¨è§£å¯ä»¥è¢«ç»§æ‰¿
ğŸ”¸ ä¸¤ç§å¤„ç†æ–¹å¼ï¼šç¼–è¯‘æœŸAPTå’Œè¿è¡Œæ—¶åå°„ï¼Œå„æœ‰é€‚ç”¨åœºæ™¯
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ æ³¨è§£ä¸åå°„çš„åˆ†å·¥åä½œ**
```
åä½œæ¨¡å¼ï¼š
â€¢ æ³¨è§£ï¼šå£°æ˜å¼çš„å…ƒæ•°æ®ï¼Œæè¿°"æ˜¯ä»€ä¹ˆ"å’Œ"è¦ä»€ä¹ˆ"
â€¢ åå°„ï¼šè¿è¡Œæ—¶çš„æ‰§è¡Œæœºåˆ¶ï¼Œå®ç°"æ€ä¹ˆåš"
â€¢ ç»“åˆæ•ˆæœï¼šå¼€å‘è€…åªéœ€å£°æ˜ï¼Œæ¡†æ¶è‡ªåŠ¨æ‰§è¡Œ

æŠ€æœ¯ä»·å€¼ï¼š
â€¢ è§£è€¦ï¼šä¸šåŠ¡é€»è¾‘ä¸æ¡†æ¶é€»è¾‘åˆ†ç¦»
â€¢ ç®€åŒ–ï¼šå‡å°‘æ ·æ¿ä»£ç ï¼Œæé«˜å¼€å‘æ•ˆç‡
â€¢ æ‰©å±•ï¼šæ˜“äºæ·»åŠ æ–°åŠŸèƒ½ï¼Œç¬¦åˆå¼€é—­åŸåˆ™
â€¢ ç»´æŠ¤ï¼šæ³¨è§£å³æ–‡æ¡£ï¼Œä»£ç æ„å›¾æ¸…æ™°
```

**ğŸ”¹ å¤„ç†æ–¹å¼çš„é€‰æ‹©ç­–ç•¥**
```
ç¼–è¯‘æœŸAPTé€‚ç”¨åœºæ™¯ï¼š
â€¢ ä»£ç ç”Ÿæˆï¼ˆå¦‚Lombokã€MapStructï¼‰
â€¢ ç¼–è¯‘æœŸæ ¡éªŒå’Œä¼˜åŒ–
â€¢ å‡å°‘è¿è¡Œæ—¶å¼€é”€çš„åœºæ™¯

è¿è¡Œæ—¶åå°„é€‚ç”¨åœºæ™¯ï¼š
â€¢ ä¾èµ–æ³¨å…¥å’ŒIoCå®¹å™¨
â€¢ AOPå’ŒåŠ¨æ€ä»£ç†
â€¢ é…ç½®é©±åŠ¨çš„è¡Œä¸ºæ§åˆ¶
â€¢ éœ€è¦è¿è¡Œæ—¶åŠ¨æ€å†³ç­–çš„åœºæ™¯
```

### 10.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ’¡ å¼€å‘æœ€ä½³å®è·µ**

| å®è·µåœºæ™¯ | **å»ºè®®åšæ³•** | **é¿å…é—®é¢˜** |
|---------|-------------|-------------|
| **è‡ªå®šä¹‰æ³¨è§£** | æ˜ç¡®ä¿ç•™ç­–ç•¥ï¼Œåˆç†è®¾è®¡å±æ€§ | é¿å…è¿‡åº¦å¤æ‚çš„æ³¨è§£è®¾è®¡ |
| **æ³¨è§£å¤„ç†** | ä½¿ç”¨ç¼“å­˜æå‡æ€§èƒ½ï¼Œç»Ÿä¸€å¼‚å¸¸å¤„ç† | é¿å…é‡å¤çš„åå°„è°ƒç”¨ |
| **æ¡†æ¶è®¾è®¡** | æ¸…æ™°çš„å¤„ç†æµç¨‹ï¼Œè‰¯å¥½çš„æ‰©å±•æ€§ | é¿å…è¿‡åº¦ä¾èµ–åå°„ |
| **æ€§èƒ½ä¼˜åŒ–** | å¯åŠ¨æ—¶é›†ä¸­å¤„ç†æ³¨è§£ï¼Œè¿è¡Œæ—¶ä½¿ç”¨ç¼“å­˜ | é¿å…é¢‘ç¹çš„åå°„æ“ä½œ |

**ğŸ¯ å®ç”¨å·¥å…·ç±»æ¨¡æ¿**
```java
// æ³¨è§£å¤„ç†å·¥å…·ç±»æ¨¡æ¿
public class AnnotationReflectionUtils {
    
    // é€šç”¨æ³¨è§£æ‰«æå™¨
    public static <T extends Annotation> List<AnnotatedElement> findElementsWithAnnotation(
            Class<?> clazz, Class<T> annotationType) {
        List<AnnotatedElement> elements = new ArrayList<>();
        
        // æ‰«æç±»
        if (clazz.isAnnotationPresent(annotationType)) {
            elements.add(clazz);
        }
        
        // æ‰«æå­—æ®µ
        for (Field field : clazz.getDeclaredFields()) {
            if (field.isAnnotationPresent(annotationType)) {
                elements.add(field);
            }
        }
        
        // æ‰«ææ–¹æ³•
        for (Method method : clazz.getDeclaredMethods()) {
            if (method.isAnnotationPresent(annotationType)) {
                elements.add(method);
            }
        }
        
        return elements;
    }
    
    // å®‰å…¨çš„æ³¨è§£å±æ€§è¯»å–
    public static Object getAnnotationProperty(Annotation annotation, String propertyName, Object defaultValue) {
        try {
            Method method = annotation.annotationType().getMethod(propertyName);
            return method.invoke(annotation);
        } catch (Exception e) {
            return defaultValue;
        }
    }
}
```

### 10.4 å‘å±•è¶‹åŠ¿ä¸æ›¿ä»£æŠ€æœ¯


**ğŸš€ æŠ€æœ¯æ¼”è¿›æ–¹å‘**
```
æ³¨è§£+åå°„æŠ€æœ¯å‘å±•è¶‹åŠ¿
â”œâ”€â”€ 1. æ€§èƒ½ä¼˜åŒ–æ–¹å‘
â”‚   â”œâ”€â”€ MethodHandleï¼šJDK 7+çš„é«˜æ€§èƒ½æ–¹æ³•è°ƒç”¨
â”‚   â”œâ”€â”€ VarHandleï¼šJDK 9+çš„å˜é‡è®¿é—®ä¼˜åŒ–
â”‚   â””â”€â”€ ç¼–è¯‘æœŸä¼˜åŒ–ï¼šæ›´å¤šé€»è¾‘å‰ç§»åˆ°ç¼–è¯‘æœŸ
â”‚
â”œâ”€â”€ 2. å¼€å‘ä½“éªŒæ”¹è¿›
â”‚   â”œâ”€â”€ è®°å½•ç±»ï¼ˆRecordï¼‰ï¼šç®€åŒ–æ•°æ®ç±»çš„æ³¨è§£å¤„ç†
â”‚   â”œâ”€â”€ æ¨¡å¼åŒ¹é…ï¼šç®€åŒ–ç±»å‹åˆ¤æ–­å’Œæ•°æ®æå–
â”‚   â””â”€â”€ æ–‡æœ¬å—ï¼šæ”¹å–„æ³¨è§£ä¸­çš„å­—ç¬¦ä¸²å¤„ç†
â”‚
â”œâ”€â”€ 3. å·¥å…·é“¾å¢å¼º
â”‚   â”œâ”€â”€ IDEæ”¯æŒï¼šæ›´å¥½çš„æ³¨è§£å¼€å‘ä½“éªŒ
â”‚   â”œâ”€â”€ é™æ€åˆ†æï¼šç¼–è¯‘æœŸæ³¨è§£ä½¿ç”¨æ£€æŸ¥
â”‚   â””â”€â”€ è°ƒè¯•å·¥å…·ï¼šåå°„è°ƒç”¨çš„å¯è§†åŒ–è°ƒè¯•
â”‚
â””â”€â”€ 4. æ›¿ä»£æ–¹æ¡ˆ
    â”œâ”€â”€ ä»£ç ç”Ÿæˆï¼šç¼–è¯‘æ—¶ç”Ÿæˆä»£ç æ›¿ä»£è¿è¡Œæ—¶åå°„
    â”œâ”€â”€ å­—èŠ‚ç æ“ä½œï¼šASMã€Javassistç­‰åº•å±‚æ“ä½œ
    â””â”€â”€ åŸç”Ÿç¼–è¯‘ï¼šGraalVM Native Imageçš„åå°„é™åˆ¶æ¨åŠ¨æ–°æ–¹æ¡ˆ
```

### 10.5 å­¦ä¹ å»ºè®®ä¸è¿›é˜¶è·¯å¾„


**ğŸ“š å­¦ä¹ è·¯å¾„è§„åˆ’**

| å­¦ä¹ é˜¶æ®µ | **é‡ç‚¹å†…å®¹** | **å®è·µé¡¹ç›®** |
|---------|-------------|-------------|
| **åŸºç¡€é˜¶æ®µ** | æ³¨è§£å®šä¹‰ã€åå°„APIã€åŸºæœ¬ç»“åˆä½¿ç”¨ | ç®€å•çš„ä¾èµ–æ³¨å…¥å®¹å™¨ |
| **è¿›é˜¶é˜¶æ®µ** | APTå¼€å‘ã€SPIæœºåˆ¶ã€æ€§èƒ½ä¼˜åŒ– | è‡ªå®šä¹‰ORMæ¡†æ¶ |
| **é«˜çº§é˜¶æ®µ** | æ¡†æ¶è®¾è®¡ã€æ¨¡å—åŒ–é€‚é…ã€åŸç”Ÿç¼–è¯‘ | å®Œæ•´çš„Webæ¡†æ¶ |

**ğŸ’¡ å®è·µå»ºè®®**
- **ä»ç®€å•å¼€å§‹**ï¼šå…ˆæŒæ¡åŸºæœ¬çš„æ³¨è§£å®šä¹‰å’Œåå°„è¯»å–
- **æ¨¡ä»¿ä¼˜ç§€æ¡†æ¶**ï¼šç ”ç©¶Springã€MyBatisç­‰æ¡†æ¶çš„å®ç°
- **æ³¨é‡æ€§èƒ½**ï¼šäº†è§£åå°„çš„æ€§èƒ½å½±å“ï¼Œå­¦ä¼šä¼˜åŒ–
- **å…³æ³¨å®‰å…¨**ï¼šç†è§£åå°„çš„å®‰å…¨é£é™©ï¼Œåˆç†ä½¿ç”¨
- **è·Ÿä¸Šå‘å±•**ï¼šå…³æ³¨æ–°æŠ€æœ¯ï¼Œé€‚æ—¶å¼•å…¥æ›¿ä»£æ–¹æ¡ˆ

### 10.6 æ€»ç»“è¡¨æ ¼


**ğŸ“Š åå°„ä¸æ³¨è§£ç»“åˆä½¿ç”¨æ€»ç»“è¡¨**

| åŠ¨ä½œ | **æ–¹æ³•** | **åœºæ™¯ç”¨é€”** |
|-----|---------|-------------|
| **åˆ¤æ–­æ³¨è§£æ˜¯å¦å­˜åœ¨** | `isAnnotationPresent()` | æ˜¯å¦éœ€è¦æ‰§è¡Œæ³¨è§£é€»è¾‘ |
| **è·å–æ³¨è§£å¯¹è±¡** | `getAnnotation()` | è·å–æ³¨è§£å±æ€§ |
| **è·å–æ‰€æœ‰æ³¨è§£** | `getAnnotations()` | æ‰¹é‡å¤„ç†å¤šä¸ªæ³¨è§£ |
| **è·å–æ³¨è§£å±æ€§** | `anno.value()`ç­‰ | æ§åˆ¶æ‰§è¡Œå‚æ•° |
| **æ³¨è§£é©±åŠ¨é€»è¾‘** | è‡ªå®šä¹‰é€»è¾‘æ§åˆ¶ | åŠ¨æ€è¡Œä¸ºæ‰§è¡Œã€é…ç½®é©±åŠ¨ |
| **å®ç°å¤„ç†å™¨** | å†™åå°„å·¥å…·ç±» | æ‰«ææ³¨è§£+æ‰§è¡Œè¡Œä¸º |

**æ ¸å¿ƒè®°å¿†**ï¼š
- **æ³¨è§£æ˜¯å£°æ˜ï¼Œåå°„æ˜¯æ‰§è¡Œ**ï¼šä¸¤è€…åˆ†å·¥æ˜ç¡®ï¼Œåä½œå®Œæˆå£°æ˜å¼ç¼–ç¨‹
- **ä¿ç•™ç­–ç•¥è¦é€‰å¯¹**ï¼šåªæœ‰RUNTIMEç­–ç•¥çš„æ³¨è§£æ‰èƒ½è¢«åå°„è®¿é—®
- **ç»§æ‰¿è§„åˆ™è¦æ¸…æ¥š**ï¼šåªæœ‰@Inheritedçš„ç±»æ³¨è§£å¯ä»¥è¢«ç»§æ‰¿
- **æ€§èƒ½å®‰å…¨è¦å…¼é¡¾**ï¼šåˆç†ä½¿ç”¨ç¼“å­˜ï¼Œæ³¨æ„å®‰å…¨é£é™©
- **å·¥å…·æ¡†æ¶è¦å–„ç”¨**ï¼šSpringç­‰æˆç†Ÿæ¡†æ¶æä¾›äº†æœ€ä½³å®è·µå‚è€ƒ