---
title: 4ã€å¤šçº¿ç¨‹ç½‘ç»œç¼–ç¨‹
---
## ğŸ“š ç›®å½•

1. [ä¸ºä»€ä¹ˆéœ€è¦å¤šçº¿ç¨‹](#1-ä¸ºä»€ä¹ˆéœ€è¦å¤šçº¿ç¨‹)
2. [åŸºç¡€å¤šçº¿ç¨‹ç¼–ç¨‹](#2-åŸºç¡€å¤šçº¿ç¨‹ç¼–ç¨‹)
3. [çº¿ç¨‹æ± å¤„ç†è¿æ¥](#3-çº¿ç¨‹æ± å¤„ç†è¿æ¥)
4. [å¹¶å‘å®‰å…¨é—®é¢˜](#4-å¹¶å‘å®‰å…¨é—®é¢˜)
5. [å®ç”¨å¹¶å‘æŠ€å·§](#5-å®ç”¨å¹¶å‘æŠ€å·§)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. â“ ä¸ºä»€ä¹ˆéœ€è¦å¤šçº¿ç¨‹


### 1.1 å•çº¿ç¨‹çš„é—®é¢˜


**ğŸ”¸ ç”Ÿæ´»åŒ–ç†è§£**
```
å•çº¿ç¨‹ç½‘ç»œç¼–ç¨‹åƒé“¶è¡Œåªæœ‰ä¸€ä¸ªæŸœå°ï¼š
ğŸª é“¶è¡ŒæŸœå°                    ğŸ–¥ï¸ å•çº¿ç¨‹æœåŠ¡å™¨
â”œâ”€ ç¬¬ä¸€ä¸ªå®¢æˆ·åŠä¸šåŠ¡            â”œâ”€ ç¬¬ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥
â”œâ”€ å…¶ä»–å®¢æˆ·æ’é˜Ÿç­‰å¾…            â”œâ”€ å…¶ä»–å®¢æˆ·ç«¯ç­‰å¾…
â”œâ”€ åŠå®Œä¸€ä¸ªæ‰èƒ½åŠä¸‹ä¸€ä¸ª        â”œâ”€ å¤„ç†å®Œä¸€ä¸ªæ‰èƒ½å¤„ç†ä¸‹ä¸€ä¸ª
â””â”€ æ•ˆç‡ä½ï¼Œå®¢æˆ·ä¸æ»¡æ„          â””â”€ å“åº”æ…¢ï¼Œç”¨æˆ·ä½“éªŒå·®

é—®é¢˜ï¼š
â€¢ ä¸€ä¸ªå®¢æˆ·ç«¯å¡ä½ï¼Œæ‰€æœ‰å®¢æˆ·ç«¯éƒ½å¡ä½
â€¢ æœåŠ¡å™¨èµ„æºåˆ©ç”¨ç‡ä½
â€¢ ç”¨æˆ·ç­‰å¾…æ—¶é—´é•¿
```

### 1.2 å•çº¿ç¨‹æœåŠ¡å™¨çš„å±€é™


**ğŸ’» å•çº¿ç¨‹æœåŠ¡å™¨ç¤ºä¾‹**
```java
import java.io.*;
import java.net.*;

public class SingleThreadServer {
    public static void main(String[] args) {
        try {
            ServerSocket server = new ServerSocket(8080);
            System.out.println("æœåŠ¡å™¨å¯åŠ¨ï¼Œä½†åªèƒ½ä¸€æ¬¡å¤„ç†ä¸€ä¸ªå®¢æˆ·ç«¯...");
            
            while (true) {
                // ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥
                Socket client = server.accept();
                System.out.println("å®¢æˆ·ç«¯è¿æ¥: " + client.getRemoteSocketAddress());
                
                // å¤„ç†è¿™ä¸ªå®¢æˆ·ç«¯ï¼ˆé˜»å¡ç‚¹ï¼‰
                handleClient(client);
                // åœ¨è¿™é‡Œå¤„ç†å®Œä¹‹å‰ï¼Œå…¶ä»–å®¢æˆ·ç«¯éƒ½è¦ç­‰å¾…ï¼
            }
            
        } catch (Exception e) {
            System.out.println("æœåŠ¡å™¨å‡ºé”™: " + e.getMessage());
        }
    }
    
    private static void handleClient(Socket client) {
        try {
            BufferedReader in = new BufferedReader(
                new InputStreamReader(client.getInputStream()));
            PrintWriter out = new PrintWriter(client.getOutputStream(), true);
            
            String message;
            while ((message = in.readLine()) != null) {
                System.out.println("æ”¶åˆ°: " + message);
                out.println("Echo: " + message);
                
                // æ¨¡æ‹Ÿå¤„ç†æ—¶é—´ï¼ˆè¿™æ—¶å…¶ä»–å®¢æˆ·ç«¯éƒ½åœ¨ç­‰å¾…ï¼‰
                Thread.sleep(2000);
            }
            
            client.close();
            
        } catch (Exception e) {
            System.out.println("å¤„ç†å®¢æˆ·ç«¯å‡ºé”™: " + e.getMessage());
        }
    }
}
```

### 1.3 å¤šçº¿ç¨‹çš„å¥½å¤„


**âš¡ å¤šçº¿ç¨‹å°±åƒé“¶è¡Œå¼€å¤šä¸ªæŸœå°**
```
å¤šçº¿ç¨‹ç½‘ç»œç¼–ç¨‹åƒé“¶è¡Œå¼€å¤šä¸ªæŸœå°ï¼š
ğŸª é“¶è¡Œå¤šä¸ªæŸœå°                ğŸ–¥ï¸ å¤šçº¿ç¨‹æœåŠ¡å™¨
â”œâ”€ æ¯ä¸ªæŸœå°ç‹¬ç«‹æœåŠ¡å®¢æˆ·        â”œâ”€ æ¯ä¸ªçº¿ç¨‹ç‹¬ç«‹å¤„ç†å®¢æˆ·ç«¯
â”œâ”€ å¤šä¸ªå®¢æˆ·åŒæ—¶åŠä¸šåŠ¡          â”œâ”€ å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶è¿æ¥
â”œâ”€ ä¸€ä¸ªæŸœå°å‡ºé—®é¢˜ä¸å½±å“å…¶ä»–    â”œâ”€ ä¸€ä¸ªçº¿ç¨‹å‡ºé”™ä¸å½±å“å…¶ä»–
â””â”€ æ•ˆç‡é«˜ï¼Œå®¢æˆ·æ»¡æ„            â””â”€ å“åº”å¿«ï¼Œç”¨æˆ·ä½“éªŒå¥½

å¥½å¤„ï¼š
âœ… å¤šä¸ªå®¢æˆ·ç«¯å¯ä»¥åŒæ—¶è¿æ¥
âœ… ä¸€ä¸ªå®¢æˆ·ç«¯æ–­å¼€ä¸å½±å“å…¶ä»–
âœ… å……åˆ†åˆ©ç”¨æœåŠ¡å™¨èµ„æº
âœ… æé«˜æ•´ä½“å¤„ç†èƒ½åŠ›
```

---

## 2. ğŸ§µ åŸºç¡€å¤šçº¿ç¨‹ç¼–ç¨‹


### 2.1 ä¸ºæ¯ä¸ªå®¢æˆ·ç«¯åˆ›å»ºçº¿ç¨‹


**ğŸ‘¥ å¤šçº¿ç¨‹æœåŠ¡å™¨**
```java
import java.io.*;
import java.net.*;

public class MultiThreadServer {
    public static void main(String[] args) {
        try {
            ServerSocket server = new ServerSocket(8080);
            System.out.println("å¤šçº¿ç¨‹æœåŠ¡å™¨å¯åŠ¨ï¼Œå¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªå®¢æˆ·ç«¯ï¼");
            
            while (true) {
                // ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥
                Socket client = server.accept();
                System.out.println("æ–°å®¢æˆ·ç«¯è¿æ¥: " + client.getRemoteSocketAddress());
                
                // ä¸ºæ¯ä¸ªå®¢æˆ·ç«¯åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹
                new Thread(new ClientHandler(client)).start();
                // é©¬ä¸Šå›åˆ°è¿™é‡Œç­‰å¾…ä¸‹ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œä¸ä¼šé˜»å¡ï¼
            }
            
        } catch (Exception e) {
            System.out.println("æœåŠ¡å™¨å‡ºé”™: " + e.getMessage());
        }
    }
}

// å®¢æˆ·ç«¯å¤„ç†å™¨
class ClientHandler implements Runnable {
    private Socket client;
    
    public ClientHandler(Socket client) {
        this.client = client;
    }
    
    @Override
    public void run() {
        String clientInfo = client.getRemoteSocketAddress().toString();
        System.out.println("å¼€å§‹å¤„ç†å®¢æˆ·ç«¯: " + clientInfo);
        
        try {
            BufferedReader in = new BufferedReader(
                new InputStreamReader(client.getInputStream()));
            PrintWriter out = new PrintWriter(client.getOutputStream(), true);
            
            String message;
            while ((message = in.readLine()) != null) {
                System.out.println(clientInfo + " è¯´: " + message);
                out.println("æ”¶åˆ°: " + message);
                
                // å³ä½¿è¿™é‡Œsleepï¼Œä¹Ÿä¸ä¼šå½±å“å…¶ä»–å®¢æˆ·ç«¯
                Thread.sleep(1000);
            }
            
        } catch (Exception e) {
            System.out.println(clientInfo + " å‡ºé”™: " + e.getMessage());
        } finally {
            try {
                client.close();
                System.out.println(clientInfo + " æ–­å¼€è¿æ¥");
            } catch (Exception e) {
                // å¿½ç•¥å…³é—­å¼‚å¸¸
            }
        }
    }
}
```

### 2.2 ç®€å•çš„èŠå¤©æœåŠ¡å™¨


**ğŸ’¬ å¤šç”¨æˆ·èŠå¤©æœåŠ¡å™¨**
```java
import java.io.*;
import java.net.*;
import java.util.*;

public class ChatServer {
    // å­˜å‚¨æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯
    private static List<ClientHandler> clients = new ArrayList<>();
    
    public static void main(String[] args) {
        try {
            ServerSocket server = new ServerSocket(8080);
            System.out.println("èŠå¤©æœåŠ¡å™¨å¯åŠ¨ï¼Œç­‰å¾…ç”¨æˆ·è¿æ¥...");
            
            while (true) {
                Socket client = server.accept();
                ClientHandler handler = new ClientHandler(client);
                clients.add(handler);
                new Thread(handler).start();
            }
            
        } catch (Exception e) {
            System.out.println("èŠå¤©æœåŠ¡å™¨å‡ºé”™: " + e.getMessage());
        }
    }
    
    // å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰ç”¨æˆ·
    public static void broadcast(String message, ClientHandler sender) {
        System.out.println("å¹¿æ’­æ¶ˆæ¯: " + message);
        for (ClientHandler client : clients) {
            if (client != sender) {  // ä¸å‘ç»™è‡ªå·±
                client.sendMessage(message);
            }
        }
    }
    
    // ç§»é™¤æ–­å¼€çš„ç”¨æˆ·
    public static void removeClient(ClientHandler client) {
        clients.remove(client);
        System.out.println("ç”¨æˆ·ç¦»å¼€ï¼Œå½“å‰åœ¨çº¿: " + clients.size());
    }
}

class ClientHandler implements Runnable {
    private Socket client;
    private PrintWriter out;
    private String username;
    
    public ClientHandler(Socket client) {
        this.client = client;
    }
    
    @Override
    public void run() {
        try {
            BufferedReader in = new BufferedReader(
                new InputStreamReader(client.getInputStream()));
            out = new PrintWriter(client.getOutputStream(), true);
            
            // è·å–ç”¨æˆ·å
            out.println("æ¬¢è¿æ¥åˆ°èŠå¤©å®¤ï¼è¯·è¾“å…¥ä½ çš„æ˜µç§°:");
            username = in.readLine();
            System.out.println(username + " åŠ å…¥èŠå¤©å®¤");
            ChatServer.broadcast(username + " åŠ å…¥äº†èŠå¤©å®¤", this);
            
            // å¤„ç†èŠå¤©æ¶ˆæ¯
            String message;
            while ((message = in.readLine()) != null) {
                if ("bye".equals(message)) {
                    break;
                }
                ChatServer.broadcast(username + ": " + message, this);
            }
            
        } catch (Exception e) {
            System.out.println(username + " è¿æ¥å¼‚å¸¸: " + e.getMessage());
        } finally {
            ChatServer.removeClient(this);
            ChatServer.broadcast(username + " ç¦»å¼€äº†èŠå¤©å®¤", this);
            try {
                client.close();
            } catch (Exception e) {
                // å¿½ç•¥å…³é—­å¼‚å¸¸
            }
        }
    }
    
    public void sendMessage(String message) {
        if (out != null) {
            out.println(message);
        }
    }
}
```

### 2.3 å¤šçº¿ç¨‹å®¢æˆ·ç«¯


**ğŸ“± å¯ä»¥åŒæ—¶æ”¶å‘æ¶ˆæ¯çš„å®¢æˆ·ç«¯**
```java
import java.io.*;
import java.net.*;
import java.util.Scanner;

public class ChatClient {
    public static void main(String[] args) {
        try {
            Socket socket = new Socket("localhost", 8080);
            System.out.println("è¿æ¥åˆ°èŠå¤©æœåŠ¡å™¨æˆåŠŸï¼");
            
            // åˆ›å»ºæ¥æ”¶æ¶ˆæ¯çš„çº¿ç¨‹
            new Thread(new MessageReceiver(socket)).start();
            
            // ä¸»çº¿ç¨‹è´Ÿè´£å‘é€æ¶ˆæ¯
            PrintWriter out = new PrintWriter(socket.getOutputStream(), true);
            Scanner scanner = new Scanner(System.in);
            
            String input;
            while ((input = scanner.nextLine()) != null) {
                out.println(input);
                if ("bye".equals(input)) {
                    break;
                }
            }
            
            socket.close();
            
        } catch (Exception e) {
            System.out.println("å®¢æˆ·ç«¯å‡ºé”™: " + e.getMessage());
        }
    }
}

// æ¶ˆæ¯æ¥æ”¶çº¿ç¨‹
class MessageReceiver implements Runnable {
    private Socket socket;
    
    public MessageReceiver(Socket socket) {
        this.socket = socket;
    }
    
    @Override
    public void run() {
        try {
            BufferedReader in = new BufferedReader(
                new InputStreamReader(socket.getInputStream()));
            
            String message;
            while ((message = in.readLine()) != null) {
                System.out.println(message);
            }
            
        } catch (Exception e) {
            System.out.println("æ¥æ”¶æ¶ˆæ¯å‡ºé”™: " + e.getMessage());
        }
    }
}
```

---

## 3. âš–ï¸ çº¿ç¨‹æ± å¤„ç†è¿æ¥


### 3.1 ä¸ºä»€ä¹ˆéœ€è¦çº¿ç¨‹æ± 


**âš ï¸ æ— é™åˆ¶åˆ›å»ºçº¿ç¨‹çš„é—®é¢˜**
```
é—®é¢˜åœºæ™¯ï¼š
å¦‚æœæœ‰1000ä¸ªå®¢æˆ·ç«¯åŒæ—¶è¿æ¥ï¼Œå°±è¦åˆ›å»º1000ä¸ªçº¿ç¨‹
å¦‚æœæœ‰10000ä¸ªå®¢æˆ·ç«¯è¿æ¥ï¼Œå°±è¦åˆ›å»º10000ä¸ªçº¿ç¨‹

ç»“æœï¼š
ğŸ’¥ å†…å­˜ä¸å¤Ÿç”¨ï¼ˆæ¯ä¸ªçº¿ç¨‹çº¦1MBå†…å­˜ï¼‰
ğŸ’¥ CPUå¿™äºåˆ‡æ¢çº¿ç¨‹ï¼Œæ²¡æ—¶é—´å¹²æ­£äº‹
ğŸ’¥ æœåŠ¡å™¨å¯èƒ½å´©æºƒ

è§£å†³æ–¹æ¡ˆï¼šçº¿ç¨‹æ± 
ğŸŠâ€â™‚ï¸ å°±åƒæ¸¸æ³³æ± ä¸€æ ·ï¼Œé¢„å…ˆå‡†å¤‡å¥½å›ºå®šæ•°é‡çš„çº¿ç¨‹
ğŸ”„ å®¢æˆ·ç«¯æ¥äº†å°±ä»æ± é‡Œå–ä¸€ä¸ªçº¿ç¨‹å¤„ç†
â™»ï¸ å¤„ç†å®Œäº†æŠŠçº¿ç¨‹è¿˜å›æ± é‡Œï¼Œç»™ä¸‹ä¸€ä¸ªå®¢æˆ·ç«¯ç”¨
```

### 3.2 ä½¿ç”¨çº¿ç¨‹æ± çš„æœåŠ¡å™¨


**ğŸŠâ€â™‚ï¸ çº¿ç¨‹æ± æœåŠ¡å™¨**
```java
import java.io.*;
import java.net.*;
import java.util.concurrent.*;

public class ThreadPoolServer {
    public static void main(String[] args) {
        // åˆ›å»ºä¸€ä¸ªå›ºå®šå¤§å°çš„çº¿ç¨‹æ± ï¼ˆ5ä¸ªçº¿ç¨‹ï¼‰
        ExecutorService threadPool = Executors.newFixedThreadPool(5);
        
        try {
            ServerSocket server = new ServerSocket(8080);
            System.out.println("çº¿ç¨‹æ± æœåŠ¡å™¨å¯åŠ¨ï¼Œçº¿ç¨‹æ± å¤§å°: 5");
            
            while (true) {
                Socket client = server.accept();
                System.out.println("æ–°å®¢æˆ·ç«¯è¿æ¥: " + client.getRemoteSocketAddress());
                
                // æŠŠä»»åŠ¡æäº¤ç»™çº¿ç¨‹æ± ï¼Œè€Œä¸æ˜¯åˆ›å»ºæ–°çº¿ç¨‹
                threadPool.submit(new ClientTask(client));
            }
            
        } catch (Exception e) {
            System.out.println("æœåŠ¡å™¨å‡ºé”™: " + e.getMessage());
        } finally {
            threadPool.shutdown(); // å…³é—­çº¿ç¨‹æ± 
        }
    }
}

class ClientTask implements Runnable {
    private Socket client;
    
    public ClientTask(Socket client) {
        this.client = client;
    }
    
    @Override
    public void run() {
        String threadName = Thread.currentThread().getName();
        String clientInfo = client.getRemoteSocketAddress().toString();
        
        System.out.println("[çº¿ç¨‹" + threadName + "] å¼€å§‹å¤„ç†: " + clientInfo);
        
        try {
            BufferedReader in = new BufferedReader(
                new InputStreamReader(client.getInputStream()));
            PrintWriter out = new PrintWriter(client.getOutputStream(), true);
            
            String message;
            while ((message = in.readLine()) != null) {
                System.out.println("[çº¿ç¨‹" + threadName + "] æ”¶åˆ°: " + message);
                out.println("[çº¿ç¨‹" + threadName + "] å›å¤: " + message);
                
                // æ¨¡æ‹Ÿå¤„ç†æ—¶é—´
                Thread.sleep(1000);
            }
            
        } catch (Exception e) {
            System.out.println("[çº¿ç¨‹" + threadName + "] å¤„ç†å‡ºé”™: " + e.getMessage());
        } finally {
            try {
                client.close();
                System.out.println("[çº¿ç¨‹" + threadName + "] å¤„ç†å®Œæˆ: " + clientInfo);
            } catch (Exception e) {
                // å¿½ç•¥å…³é—­å¼‚å¸¸
            }
        }
    }
}
```

### 3.3 ä¸åŒç±»å‹çš„çº¿ç¨‹æ± 


**ğŸŠâ€â™‚ï¸ é€‰æ‹©åˆé€‚çš„çº¿ç¨‹æ± **
```java
import java.util.concurrent.*;

public class ThreadPoolTypes {
    public static void main(String[] args) {
        // 1. å›ºå®šå¤§å°çº¿ç¨‹æ± ï¼ˆæ¨èï¼‰
        ExecutorService fixedPool = Executors.newFixedThreadPool(10);
        System.out.println("å›ºå®šçº¿ç¨‹æ± ï¼šå§‹ç»ˆä¿æŒ10ä¸ªçº¿ç¨‹");
        
        // 2. å¯å˜å¤§å°çº¿ç¨‹æ± ï¼ˆå°å¿ƒä½¿ç”¨ï¼‰
        ExecutorService cachedPool = Executors.newCachedThreadPool();
        System.out.println("å¯å˜çº¿ç¨‹æ± ï¼šæ ¹æ®éœ€è¦åˆ›å»ºçº¿ç¨‹");
        
        // 3. å•çº¿ç¨‹æ± 
        ExecutorService singlePool = Executors.newSingleThreadExecutor();
        System.out.println("å•çº¿ç¨‹æ± ï¼šæ‰€æœ‰ä»»åŠ¡æ’é˜Ÿå¤„ç†");
        
        // ä½¿ç”¨å»ºè®®ï¼š
        System.out.println("\nä½¿ç”¨å»ºè®®ï¼š");
        System.out.println("- è¿æ¥æ•°ç¨³å®šï¼šç”¨å›ºå®šçº¿ç¨‹æ± ");
        System.out.println("- è¿æ¥æ•°å˜åŒ–å¤§ï¼šç”¨å¯å˜çº¿ç¨‹æ± ");
        System.out.println("- éœ€è¦é¡ºåºå¤„ç†ï¼šç”¨å•çº¿ç¨‹æ± ");
        
        // è®°å¾—å…³é—­çº¿ç¨‹æ± 
        fixedPool.shutdown();
        cachedPool.shutdown();
        singlePool.shutdown();
    }
}
```

---

## 4. â˜¢ï¸ å¹¶å‘å®‰å…¨é—®é¢˜


### 4.1 ä»€ä¹ˆæ˜¯å¹¶å‘å®‰å…¨é—®é¢˜


**âš ï¸ ç”Ÿæ´»åŒ–ç†è§£**
```
å¹¶å‘å®‰å…¨é—®é¢˜å°±åƒå¤šäººåŒæ—¶å¾€é“¶è¡Œè´¦æˆ·å­˜é’±ï¼š

ä¸å®‰å…¨çš„æƒ…å†µï¼š
ğŸ‘¤ ç”¨æˆ·AæŸ¥çœ‹ä½™é¢ï¼š1000å…ƒ
ğŸ‘¤ ç”¨æˆ·BæŸ¥çœ‹ä½™é¢ï¼š1000å…ƒ  
ğŸ‘¤ ç”¨æˆ·Aå­˜å…¥500å…ƒï¼Œå†™å…¥ä½™é¢ï¼š1500å…ƒ
ğŸ‘¤ ç”¨æˆ·Bå­˜å…¥300å…ƒï¼Œå†™å…¥ä½™é¢ï¼š1300å…ƒ

ç»“æœï¼šé’±ä¸¢äº†ï¼åº”è¯¥æ˜¯1800å…ƒï¼Œå®é™…åªæœ‰1300å…ƒ

åŸå› ï¼šä¸¤ä¸ªäººåŒæ—¶æ“ä½œï¼Œåé¢çš„æ“ä½œè¦†ç›–äº†å‰é¢çš„
```

### 4.2 çº¿ç¨‹å®‰å…¨é—®é¢˜ç¤ºä¾‹


**ğŸ’¥ ä¸å®‰å…¨çš„è®¡æ•°å™¨**
```java
public class UnsafeCounter {
    private int count = 0;
    
    // ä¸å®‰å…¨çš„æ–¹æ³•
    public void add() {
        count++;  // è¿™ä¸ªæ“ä½œä¸æ˜¯åŸå­çš„ï¼
        // å®é™…ä¸Šæ˜¯ï¼šè¯»å–count â†’ åŠ 1 â†’ å†™å›count
    }
    
    public int getCount() {
        return count;
    }
    
    public static void main(String[] args) throws Exception {
        UnsafeCounter counter = new UnsafeCounter();
        
        // åˆ›å»º10ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹åŠ 1000æ¬¡
        Thread[] threads = new Thread[10];
        for (int i = 0; i < 10; i++) {
            threads[i] = new Thread(() -> {
                for (int j = 0; j < 1000; j++) {
                    counter.add();
                }
            });
            threads[i].start();
        }
        
        // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ
        for (Thread thread : threads) {
            thread.join();
        }
        
        System.out.println("æœŸæœ›ç»“æœ: 10000");
        System.out.println("å®é™…ç»“æœ: " + counter.getCount()); // ç»“æœä¼šå°äº10000
    }
}
```

### 4.3 ä½¿ç”¨synchronizedè§£å†³é—®é¢˜


**ğŸ”’ å®‰å…¨çš„è®¡æ•°å™¨**
```java
public class SafeCounter {
    private int count = 0;
    
    // åŠ ä¸Šsynchronizedå…³é”®å­—ï¼ŒåŒä¸€æ—¶é—´åªå…è®¸ä¸€ä¸ªçº¿ç¨‹è¿›å…¥
    public synchronized void add() {
        count++;
    }
    
    public synchronized int getCount() {
        return count;
    }
    
    public static void main(String[] args) throws Exception {
        SafeCounter counter = new SafeCounter();
        
        Thread[] threads = new Thread[10];
        for (int i = 0; i < 10; i++) {
            threads[i] = new Thread(() -> {
                for (int j = 0; j < 1000; j++) {
                    counter.add();
                }
            });
            threads[i].start();
        }
        
        for (Thread thread : threads) {
            thread.join();
        }
        
        System.out.println("æœŸæœ›ç»“æœ: 10000");
        System.out.println("å®é™…ç»“æœ: " + counter.getCount()); // ç°åœ¨ç»“æœæ­£ç¡®äº†
    }
}
```

### 4.4 çº¿ç¨‹å®‰å…¨çš„é›†åˆç±»


**ğŸ“¦ ä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„é›†åˆ**
```java
import java.util.*;
import java.util.concurrent.*;

public class ThreadSafeCollections {
    public static void main(String[] args) {
        // ä¸å®‰å…¨çš„é›†åˆï¼ˆå¤šçº¿ç¨‹ä½¿ç”¨ä¼šå‡ºé—®é¢˜ï¼‰
        List<String> unsafeList = new ArrayList<>();
        Map<String, String> unsafeMap = new HashMap<>();
        
        // å®‰å…¨çš„é›†åˆï¼ˆå¤šçº¿ç¨‹ä½¿ç”¨æ²¡é—®é¢˜ï¼‰
        List<String> safeList = Collections.synchronizedList(new ArrayList<>());
        Map<String, String> safeMap = new ConcurrentHashMap<>();
        
        System.out.println("å¤šçº¿ç¨‹ç¯å¢ƒæ¨èä½¿ç”¨ï¼š");
        System.out.println("- ConcurrentHashMap ä»£æ›¿ HashMap");
        System.out.println("- Collections.synchronizedList() åŒ…è£… ArrayList");
        System.out.println("- Vector ä»£æ›¿ ArrayListï¼ˆä½†æ€§èƒ½è¾ƒå·®ï¼‰");
        
        // ä½¿ç”¨ç¤ºä¾‹
        safeMap.put("user1", "å¼ ä¸‰");
        safeMap.put("user2", "æå››");
        safeList.add("æ¶ˆæ¯1");
        safeList.add("æ¶ˆæ¯2");
        
        System.out.println("å®‰å…¨æ“ä½œå®Œæˆ");
    }
}
```

---

## 5. ğŸš€ å®ç”¨å¹¶å‘æŠ€å·§


### 5.1 ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ


**â° CountDownLatchç”¨æ³•**
```java
import java.util.concurrent.*;

public class WaitAllTasks {
    public static void main(String[] args) throws Exception {
        // åˆ›å»ºä¸€ä¸ªè®¡æ•°å™¨ï¼Œåˆå§‹å€¼ä¸º3ï¼ˆè¡¨ç¤ºè¦ç­‰3ä¸ªä»»åŠ¡å®Œæˆï¼‰
        CountDownLatch latch = new CountDownLatch(3);
        
        // å¯åŠ¨3ä¸ªä»»åŠ¡
        for (int i = 1; i <= 3; i++) {
            final int taskId = i;
            new Thread(() -> {
                try {
                    System.out.println("ä»»åŠ¡" + taskId + " å¼€å§‹æ‰§è¡Œ");
                    Thread.sleep(taskId * 1000); // æ¨¡æ‹Ÿä¸åŒçš„æ‰§è¡Œæ—¶é—´
                    System.out.println("ä»»åŠ¡" + taskId + " æ‰§è¡Œå®Œæˆ");
                } catch (Exception e) {
                    e.printStackTrace();
                } finally {
                    latch.countDown(); // ä»»åŠ¡å®Œæˆï¼Œè®¡æ•°å™¨å‡1
                }
            }).start();
        }
        
        System.out.println("ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ...");
        latch.await(); // ç­‰å¾…è®¡æ•°å™¨å˜ä¸º0
        System.out.println("æ‰€æœ‰ä»»åŠ¡éƒ½å®Œæˆäº†ï¼");
    }
}
```

### 5.2 ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼


**ğŸ­ æ¶ˆæ¯é˜Ÿåˆ—ç¤ºä¾‹**
```java
import java.util.concurrent.*;

public class MessageQueue {
    public static void main(String[] args) {
        // åˆ›å»ºä¸€ä¸ªé˜»å¡é˜Ÿåˆ—ï¼ˆçº¿ç¨‹å®‰å…¨çš„ï¼‰
        BlockingQueue<String> queue = new LinkedBlockingQueue<>();
        
        // å¯åŠ¨ç”Ÿäº§è€…ï¼ˆå‘é€æ¶ˆæ¯ï¼‰
        new Thread(() -> {
            try {
                for (int i = 1; i <= 10; i++) {
                    String message = "æ¶ˆæ¯" + i;
                    queue.put(message); // æ”¾å…¥é˜Ÿåˆ—
                    System.out.println("ç”Ÿäº§: " + message);
                    Thread.sleep(500);
                }
            } catch (Exception e) {
                e.printStackTrace();
            }
        }, "ç”Ÿäº§è€…").start();
        
        // å¯åŠ¨æ¶ˆè´¹è€…ï¼ˆå¤„ç†æ¶ˆæ¯ï¼‰
        new Thread(() -> {
            try {
                while (true) {
                    String message = queue.take(); // ä»é˜Ÿåˆ—å–å‡ºï¼ˆä¼šé˜»å¡ç­‰å¾…ï¼‰
                    System.out.println("æ¶ˆè´¹: " + message);
                    Thread.sleep(1000); // æ¨¡æ‹Ÿå¤„ç†æ—¶é—´
                }
            } catch (Exception e) {
                e.printStackTrace();
            }
        }, "æ¶ˆè´¹è€…").start();
        
        System.out.println("ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…éƒ½å¯åŠ¨äº†");
    }
}
```

### 5.3 ä¼˜é›…å…³é—­æœåŠ¡å™¨


**ğŸ›‘ æ­£ç¡®å…³é—­çº¿ç¨‹æ± **
```java
import java.util.concurrent.*;

public class GracefulShutdown {
    private static ExecutorService threadPool = Executors.newFixedThreadPool(5);
    
    public static void main(String[] args) {
        // æ³¨å†Œå…³é—­é’©å­ï¼ˆç¨‹åºé€€å‡ºæ—¶æ‰§è¡Œï¼‰
        Runtime.getRuntime().addShutdownHook(new Thread(() -> {
            System.out.println("ç¨‹åºæ­£åœ¨å…³é—­ï¼Œæ¸…ç†èµ„æº...");
            shutdownThreadPool();
        }));
        
        // æ¨¡æ‹Ÿæäº¤ä¸€äº›ä»»åŠ¡
        for (int i = 1; i <= 5; i++) {
            final int taskId = i;
            threadPool.submit(() -> {
                try {
                    System.out.println("ä»»åŠ¡" + taskId + " å¼€å§‹");
                    Thread.sleep(3000);
                    System.out.println("ä»»åŠ¡" + taskId + " å®Œæˆ");
                } catch (Exception e) {
                    System.out.println("ä»»åŠ¡" + taskId + " è¢«ä¸­æ–­");
                }
            });
        }
        
        System.out.println("ä»»åŠ¡å·²æäº¤ï¼ŒæŒ‰Ctrl+Cé€€å‡ºç¨‹åº");
        
        // ä¸»çº¿ç¨‹ç­‰å¾…
        try {
            Thread.sleep(10000);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }
    
    private static void shutdownThreadPool() {
        threadPool.shutdown(); // ä¸æ¥å—æ–°ä»»åŠ¡ï¼Œç­‰å¾…ç°æœ‰ä»»åŠ¡å®Œæˆ
        
        try {
            // ç­‰å¾…60ç§’è®©ä»»åŠ¡å®Œæˆ
            if (!threadPool.awaitTermination(60, TimeUnit.SECONDS)) {
                threadPool.shutdownNow(); // å¼ºåˆ¶å…³é—­
                System.out.println("å¼ºåˆ¶å…³é—­çº¿ç¨‹æ± ");
            } else {
                System.out.println("çº¿ç¨‹æ± æ­£å¸¸å…³é—­");
            }
        } catch (InterruptedException e) {
            threadPool.shutdownNow();
        }
    }
}
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„åŸºç¡€æ¦‚å¿µ


```
ğŸ”¸ å¤šçº¿ç¨‹å¿…è¦æ€§ = å•çº¿ç¨‹æ— æ³•åŒæ—¶å¤„ç†å¤šä¸ªå®¢æˆ·ç«¯
ğŸ”¸ Thread-per-Connection = æ¯ä¸ªå®¢æˆ·ç«¯ä¸€ä¸ªçº¿ç¨‹
ğŸ”¸ çº¿ç¨‹æ±  = é¢„å…ˆåˆ›å»ºå›ºå®šæ•°é‡çº¿ç¨‹ï¼Œé¿å…æ— é™åˆ›å»º
ğŸ”¸ å¹¶å‘å®‰å…¨ = å¤šçº¿ç¨‹åŒæ—¶æ“ä½œå…±äº«æ•°æ®ä¼šå‡ºé—®é¢˜
ğŸ”¸ synchronized = åŒä¸€æ—¶é—´åªå…è®¸ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œ
```

### 6.2 ç¼–ç¨‹æ¨¡å¼


**ğŸ”¹ å¤šçº¿ç¨‹æœåŠ¡å™¨å¥—è·¯**
```
1. ServerSocketç›‘å¬ç«¯å£
2. accept()ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥
3. ä¸ºæ¯ä¸ªå®¢æˆ·ç«¯åˆ›å»ºæ–°çº¿ç¨‹ï¼ˆæˆ–æäº¤ç»™çº¿ç¨‹æ± ï¼‰
4. åœ¨æ–°çº¿ç¨‹ä¸­å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚
5. å¤„ç†å®Œæˆåå…³é—­è¿æ¥

è®°ä½ï¼šä¸»çº¿ç¨‹åªè´Ÿè´£æ¥å—è¿æ¥ï¼Œå¤„ç†äº¤ç»™å·¥ä½œçº¿ç¨‹
```

**ğŸ”¹ çº¿ç¨‹æ± ä½¿ç”¨å¥—è·¯**
```
1. åˆ›å»ºçº¿ç¨‹æ± ï¼šExecutors.newFixedThreadPool(æ•°é‡)
2. æäº¤ä»»åŠ¡ï¼šthreadPool.submit(task)
3. å…³é—­çº¿ç¨‹æ± ï¼šthreadPool.shutdown()

å¥½å¤„ï¼šæ§åˆ¶çº¿ç¨‹æ•°é‡ï¼Œé¿å…ç³»ç»Ÿèµ„æºè€—å°½
```

### 6.3 é‡è¦æ³¨æ„äº‹é¡¹


**ğŸ”¹ å¹¶å‘å®‰å…¨**
```
âœ… å…±äº«æ•°æ®è¦ç”¨synchronizedä¿æŠ¤
âœ… ä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„é›†åˆç±»ï¼ˆConcurrentHashMapï¼‰
âœ… èƒ½ç”¨çº¿ç¨‹å±€éƒ¨å˜é‡å°±ä¸ç”¨å…±äº«å˜é‡
âŒ å¤šçº¿ç¨‹ç›´æ¥æ“ä½œåŒä¸€ä¸ªå˜é‡
âŒ ä½¿ç”¨ArrayListã€HashMapç­‰éçº¿ç¨‹å®‰å…¨é›†åˆ
```

**ğŸ”¹ æ€§èƒ½è€ƒè™‘**
```
çº¿ç¨‹æ•°é‡é€‰æ‹©ï¼š
â€¢ CPUå¯†é›†å‹ï¼šçº¿ç¨‹æ•° = CPUæ ¸å¿ƒæ•°
â€¢ IOå¯†é›†å‹ï¼šçº¿ç¨‹æ•° = CPUæ ¸å¿ƒæ•° Ã— 2
â€¢ ç½‘ç»œæœåŠ¡ï¼šæ ¹æ®å®é™…æƒ…å†µæµ‹è¯•è°ƒæ•´

å†…å­˜è€ƒè™‘ï¼š
â€¢ æ¯ä¸ªçº¿ç¨‹çº¦å 1MBå†…å­˜
â€¢ 1000ä¸ªçº¿ç¨‹ â‰ˆ 1GBå†…å­˜
â€¢ çº¿ç¨‹æ± å¯ä»¥æœ‰æ•ˆæ§åˆ¶å†…å­˜ä½¿ç”¨
```

**ğŸ”¹ èµ„æºç®¡ç†**
```
âœ… ä½¿ç”¨try-with-resourcesè‡ªåŠ¨å…³é—­èµ„æº
âœ… ç¨‹åºé€€å‡ºæ—¶å…³é—­çº¿ç¨‹æ± 
âœ… å®¢æˆ·ç«¯æ–­å¼€æ—¶åŠæ—¶æ¸…ç†
âŒ å¿˜è®°å…³é—­Socketå’Œæµ
âŒ çº¿ç¨‹æ± ä½¿ç”¨å®Œä¸å…³é—­
```

### 6.4 å­¦ä¹ å»ºè®®


**ğŸ¯ å¾ªåºæ¸è¿›**
```
ç¬¬1æ­¥ï¼šç†è§£å•çº¿ç¨‹çš„é—®é¢˜
ç¬¬2æ­¥ï¼šå†™ç®€å•çš„å¤šçº¿ç¨‹æœåŠ¡å™¨
ç¬¬3æ­¥ï¼šå­¦ä¼šä½¿ç”¨çº¿ç¨‹æ± 
ç¬¬4æ­¥ï¼šå¤„ç†å¹¶å‘å®‰å…¨é—®é¢˜
ç¬¬5æ­¥ï¼šæŒæ¡å¸¸ç”¨çš„å¹¶å‘å·¥å…·
```

**ğŸ’¡ è°ƒè¯•æŠ€å·§**
```
â€¢ åœ¨å…³é”®ä½ç½®æ‰“å°çº¿ç¨‹åç§°
â€¢ è§‚å¯Ÿçº¿ç¨‹æ•°é‡å˜åŒ–
â€¢ æµ‹è¯•é«˜å¹¶å‘æƒ…å†µ
â€¢ æ£€æŸ¥æ˜¯å¦æœ‰å†…å­˜æ³„æ¼
â€¢ æ¨¡æ‹Ÿå®¢æˆ·ç«¯å¼‚å¸¸æ–­å¼€
```

**ğŸ”§ å®ç”¨å·¥å…·**
```
ç›‘æ§å·¥å…·ï¼š
â€¢ jconsoleï¼šè§‚å¯Ÿçº¿ç¨‹çŠ¶æ€
â€¢ jstackï¼šæŸ¥çœ‹çº¿ç¨‹å †æ ˆ
â€¢ top/htopï¼šæŸ¥çœ‹ç³»ç»Ÿèµ„æºä½¿ç”¨

æµ‹è¯•å·¥å…·ï¼š
â€¢ telnetï¼šæ¨¡æ‹Ÿå¤šä¸ªå®¢æˆ·ç«¯è¿æ¥
â€¢ ç¼–å†™å®¢æˆ·ç«¯ç¨‹åºæ‰¹é‡è¿æ¥æµ‹è¯•
```
