---
title: 7ã€WebSocketç¼–ç¨‹
---
## ğŸ“š ç›®å½•

1. [WebSocketæ˜¯ä»€ä¹ˆ](#1-WebSocketæ˜¯ä»€ä¹ˆ)
2. [Java WebSocketç¼–ç¨‹](#2-Java-WebSocketç¼–ç¨‹)
3. [WebSocketæœåŠ¡å™¨å®ç°](#3-WebSocketæœåŠ¡å™¨å®ç°)
4. [å®æ—¶é€šä¿¡åº”ç”¨æ¡ˆä¾‹](#4-å®æ—¶é€šä¿¡åº”ç”¨æ¡ˆä¾‹)
5. [WebSocketè¿›é˜¶æŠ€å·§](#5-WebSocketè¿›é˜¶æŠ€å·§)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” WebSocketæ˜¯ä»€ä¹ˆ


### 1.1 WebSocketçš„å®šä¹‰å’Œä½œç”¨


**ğŸ”¸ WebSocketçš„å«ä¹‰**
```
WebSocket = Webï¼ˆç½‘é¡µï¼‰+ Socketï¼ˆæ’åº§/è¿æ¥ï¼‰
ç®€å•ç†è§£ï¼šç½‘é¡µä¸Šçš„"ç”µè¯çº¿"ï¼Œå¯ä»¥å®æ—¶åŒå‘é€šè¯

ä¼ ç»ŸHTTPï¼šåƒå‘çŸ­ä¿¡
â€¢ ä½ å‘ä¸€æ¡ï¼ŒæœåŠ¡å™¨å›ä¸€æ¡
â€¢ å‘å®Œå°±æ–­å¼€è¿æ¥
â€¢ è¦å†å‘æ¶ˆæ¯ï¼Œé‡æ–°å»ºç«‹è¿æ¥

WebSocketï¼šåƒæ‰“ç”µè¯
â€¢ å»ºç«‹è¿æ¥åï¼ŒåŒæ–¹å¯ä»¥éšæ—¶è¯´è¯
â€¢ è¿æ¥ä¸€ç›´ä¿æŒç€
â€¢ çœŸæ­£çš„å®æ—¶å¯¹è¯
```

### 1.2 ç”Ÿæ´»åŒ–ç†è§£WebSocket


**ğŸ“ WebSocketå°±åƒç”µè¯é€šè¯**
```
HTTPæ–¹å¼ï¼š                   WebSocketæ–¹å¼ï¼š
ğŸƒâ€â™‚ï¸ é¡¾å®¢è·‘åˆ°åº—é‡Œé—®ä»·æ ¼         ğŸ“ é¡¾å®¢å’Œåº—ä¸»é€šç”µè¯
ğŸª åº—ä¸»å‘Šè¯‰ä»·æ ¼              ğŸ“ åŒæ–¹å¯ä»¥éšæ—¶äº¤æµ
ğŸƒâ€â™‚ï¸ é¡¾å®¢ç¦»å¼€                 ğŸ“ ä¸€ç›´ä¿æŒé€šè¯
ğŸƒâ€â™‚ï¸ æƒ³é—®åˆ«çš„åˆè¦è·‘ä¸€è¶Ÿ       ğŸ“ æœ‰äº‹ç›´æ¥è¯´ï¼Œæ— éœ€é‡æ‹¨

WebSocketçš„å¥½å¤„ï¼š
âœ… å®æ—¶åŒå‘é€šä¿¡ï¼šåŒæ–¹éƒ½èƒ½ä¸»åŠ¨å‘æ¶ˆæ¯
âœ… è¿æ¥æŒä¹…ï¼šä¸€æ¬¡è¿æ¥ï¼Œå¤šæ¬¡ä½¿ç”¨
âœ… ä½å»¶è¿Ÿï¼šæ— éœ€é‡æ–°å»ºç«‹è¿æ¥
âœ… æœåŠ¡å™¨æ¨é€ï¼šæœåŠ¡å™¨å¯ä»¥ä¸»åŠ¨å‘æ¶ˆæ¯ç»™å®¢æˆ·ç«¯
```

### 1.3 WebSocket vs HTTPå¯¹æ¯”


**ğŸ“Š ç›´è§‚å¯¹æ¯”**

| ç‰¹æ€§ | **HTTP** | **WebSocket** |
|------|----------|---------------|
| ğŸ—£ï¸ **é€šä¿¡æ–¹å¼** | `ä¸€é—®ä¸€ç­”ï¼ˆå•å‘ï¼‰` | `è‡ªç”±å¯¹è¯ï¼ˆåŒå‘ï¼‰` |
| ğŸ”— **è¿æ¥ä¿æŒ** | `ç”¨å®Œå°±æ–­` | `ä¸€ç›´ä¿æŒ` |
| âš¡ **å®æ—¶æ€§** | `éœ€è¦åå¤è¯¢é—®` | `å³æ—¶é€šçŸ¥` |
| ğŸ“Š **æ•°æ®å¼€é”€** | `æ¯æ¬¡éƒ½è¦é‡æ–°æ¡æ‰‹` | `æ¡æ‰‹ä¸€æ¬¡å³å¯` |
| ğŸ¯ **é€‚ç”¨åœºæ™¯** | `ç½‘é¡µæµè§ˆã€APIè°ƒç”¨` | `èŠå¤©ã€æ¸¸æˆã€æ¨é€` |

### 1.4 WebSocketçš„è¿æ¥è¿‡ç¨‹


**ğŸ¤ è¿æ¥å»ºç«‹è¿‡ç¨‹**
```
ç¬¬1æ­¥ï¼šå®¢æˆ·ç«¯è¯·æ±‚å‡çº§è¿æ¥
æµè§ˆå™¨å‘é€ï¼šæˆ‘æƒ³è¦WebSocketè¿æ¥
GET /chat HTTP/1.1
Upgrade: websocket
Connection: Upgrade

ç¬¬2æ­¥ï¼šæœåŠ¡å™¨åŒæ„å‡çº§
æœåŠ¡å™¨å›å¤ï¼šå¥½çš„ï¼Œå‡çº§æˆåŠŸ
HTTP/1.1 101 Switching Protocols
Upgrade: websocket
Connection: Upgrade

ç¬¬3æ­¥ï¼šWebSocketè¿æ¥å»ºç«‹
ç°åœ¨å¯ä»¥è‡ªç”±åŒå‘é€šä¿¡äº†ï¼
å®¢æˆ·ç«¯ â†â”€â”€â”€â”€â†’ æœåŠ¡å™¨
```

### 1.5 WebSocketçš„çŠ¶æ€


**ğŸ”„ è¿æ¥çŠ¶æ€è¯´æ˜**
```
CONNECTINGï¼ˆè¿æ¥ä¸­ï¼‰ï¼šæ­£åœ¨å»ºç«‹è¿æ¥
â€¢ å°±åƒæ­£åœ¨æ‹¨ç”µè¯å·ç 

OPENï¼ˆå·²è¿æ¥ï¼‰ï¼šè¿æ¥æˆåŠŸï¼Œå¯ä»¥é€šä¿¡
â€¢ å°±åƒç”µè¯æ¥é€šäº†ï¼Œå¯ä»¥è¯´è¯

CLOSINGï¼ˆå…³é—­ä¸­ï¼‰ï¼šæ­£åœ¨å…³é—­è¿æ¥
â€¢ å°±åƒæ­£åœ¨æŒ‚ç”µè¯

CLOSEDï¼ˆå·²å…³é—­ï¼‰ï¼šè¿æ¥å·²æ–­å¼€
â€¢ å°±åƒç”µè¯å·²æŒ‚æ–­
```

---

## 2. â˜ï¸ Java WebSocketç¼–ç¨‹


### 2.1 æœ€ç®€å•çš„WebSocketæœåŠ¡å™¨


**ğŸ–¥ï¸ åˆ›å»ºWebSocketæœåŠ¡å™¨**
```java
import javax.websocket.*;
import javax.websocket.server.ServerEndpoint;

// è¿™ä¸ªæ³¨è§£è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªWebSocketç«¯ç‚¹ï¼Œè·¯å¾„æ˜¯/chat
@ServerEndpoint("/chat")
public class SimpleWebSocketServer {
    
    // å½“æœ‰äººè¿æ¥æ—¶æ‰§è¡Œ
    @OnOpen
    public void onOpen(Session session) {
        System.out.println("æœ‰äººè¿æ¥äº†ï¼è¿æ¥ID: " + session.getId());
    }
    
    // å½“æ”¶åˆ°æ¶ˆæ¯æ—¶æ‰§è¡Œ
    @OnMessage
    public void onMessage(String message, Session session) {
        System.out.println("æ”¶åˆ°æ¶ˆæ¯: " + message);
        
        try {
            // å›å¤æ¶ˆæ¯
            session.getBasicRemote().sendText("æ”¶åˆ°ä½ çš„æ¶ˆæ¯: " + message);
        } catch (Exception e) {
            System.out.println("å‘é€æ¶ˆæ¯å¤±è´¥: " + e.getMessage());
        }
    }
    
    // å½“è¿æ¥å…³é—­æ—¶æ‰§è¡Œ
    @OnClose
    public void onClose(Session session) {
        System.out.println("è¿æ¥å…³é—­äº†ï¼è¿æ¥ID: " + session.getId());
    }
    
    // å½“å‡ºé”™æ—¶æ‰§è¡Œ
    @OnError
    public void onError(Session session, Throwable error) {
        System.out.println("å‡ºé”™äº†: " + error.getMessage());
    }
}
```

### 2.2 WebSocketå®¢æˆ·ç«¯


**ğŸ“± Javaå®¢æˆ·ç«¯è¿æ¥WebSocket**
```java
import javax.websocket.*;
import java.net.URI;

@ClientEndpoint
public class SimpleWebSocketClient {
    
    @OnOpen
    public void onOpen(Session session) {
        System.out.println("å®¢æˆ·ç«¯è¿æ¥æˆåŠŸï¼");
        
        try {
            // è¿æ¥æˆåŠŸåå‘é€ä¸€æ¡æ¶ˆæ¯
            session.getBasicRemote().sendText("Hello Server!");
        } catch (Exception e) {
            System.out.println("å‘é€æ¶ˆæ¯å¤±è´¥: " + e.getMessage());
        }
    }
    
    @OnMessage
    public void onMessage(String message) {
        System.out.println("æ”¶åˆ°æœåŠ¡å™¨æ¶ˆæ¯: " + message);
    }
    
    @OnClose
    public void onClose(Session session) {
        System.out.println("å®¢æˆ·ç«¯è¿æ¥å…³é—­");
    }
    
    public static void main(String[] args) {
        try {
            // åˆ›å»ºWebSocketå®¢æˆ·ç«¯
            WebSocketContainer container = ContainerProvider.getWebSocketContainer();
            SimpleWebSocketClient client = new SimpleWebSocketClient();
            
            // è¿æ¥åˆ°æœåŠ¡å™¨
            Session session = container.connectToServer(client, 
                new URI("ws://localhost:8080/chat"));
            
            // ä¿æŒè¿æ¥5ç§’
            Thread.sleep(5000);
            
            // å…³é—­è¿æ¥
            session.close();
            
        } catch (Exception e) {
            System.out.println("å®¢æˆ·ç«¯å‡ºé”™: " + e.getMessage());
        }
    }
}
```

### 2.3 å‘é€ä¸åŒç±»å‹çš„æ¶ˆæ¯


**ğŸ“ æ–‡æœ¬å’ŒäºŒè¿›åˆ¶æ¶ˆæ¯**
```java
@ServerEndpoint("/message")
public class MessageTypeServer {
    
    // å¤„ç†æ–‡æœ¬æ¶ˆæ¯
    @OnMessage
    public void onTextMessage(String message, Session session) {
        System.out.println("æ”¶åˆ°æ–‡æœ¬æ¶ˆæ¯: " + message);
        
        try {
            // å‘é€æ–‡æœ¬å›å¤
            session.getBasicRemote().sendText("æ–‡æœ¬å›å¤: " + message);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    // å¤„ç†äºŒè¿›åˆ¶æ¶ˆæ¯
    @OnMessage
    public void onBinaryMessage(byte[] data, Session session) {
        System.out.println("æ”¶åˆ°äºŒè¿›åˆ¶æ¶ˆæ¯ï¼Œé•¿åº¦: " + data.length);
        
        try {
            // å‘é€äºŒè¿›åˆ¶å›å¤
            String reply = "æ”¶åˆ° " + data.length + " å­—èŠ‚æ•°æ®";
            session.getBasicRemote().sendBinary(
                java.nio.ByteBuffer.wrap(reply.getBytes()));
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    @OnOpen
    public void onOpen(Session session) {
        System.out.println("è¿æ¥å»ºç«‹: " + session.getId());
    }
    
    @OnClose
    public void onClose(Session session) {
        System.out.println("è¿æ¥å…³é—­: " + session.getId());
    }
}
```

### 2.4 Sessionç®¡ç†


**ğŸ‘¥ ç®¡ç†ç”¨æˆ·è¿æ¥**
```java
import java.util.*;
import java.util.concurrent.ConcurrentHashMap;

@ServerEndpoint("/user")
public class UserManagementServer {
    
    // å­˜å‚¨æ‰€æœ‰åœ¨çº¿ç”¨æˆ·çš„è¿æ¥
    private static Map<String, Session> userSessions = new ConcurrentHashMap<>();
    
    @OnOpen
    public void onOpen(Session session) {
        // å¯ä»¥ä»URLå‚æ•°ä¸­è·å–ç”¨æˆ·å
        String username = getUsername(session);
        if (username != null) {
            userSessions.put(username, session);
            System.out.println("ç”¨æˆ· " + username + " ä¸Šçº¿äº†ï¼Œå½“å‰åœ¨çº¿: " + userSessions.size());
        }
    }
    
    @OnMessage
    public void onMessage(String message, Session session) {
        String username = getUsername(session);
        System.out.println("ç”¨æˆ· " + username + " è¯´: " + message);
        
        // å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰åœ¨çº¿ç”¨æˆ·
        broadcastMessage(username + ": " + message);
    }
    
    @OnClose
    public void onClose(Session session) {
        String username = getUsername(session);
        if (username != null) {
            userSessions.remove(username);
            System.out.println("ç”¨æˆ· " + username + " ä¸‹çº¿äº†ï¼Œå½“å‰åœ¨çº¿: " + userSessions.size());
        }
    }
    
    // å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰ç”¨æˆ·
    private void broadcastMessage(String message) {
        List<String> disconnectedUsers = new ArrayList<>();
        
        for (Map.Entry<String, Session> entry : userSessions.entrySet()) {
            try {
                Session session = entry.getValue();
                if (session.isOpen()) {
                    session.getBasicRemote().sendText(message);
                } else {
                    disconnectedUsers.add(entry.getKey());
                }
            } catch (Exception e) {
                disconnectedUsers.add(entry.getKey());
            }
        }
        
        // æ¸…ç†æ–­å¼€çš„è¿æ¥
        for (String user : disconnectedUsers) {
            userSessions.remove(user);
        }
    }
    
    // è·å–ç”¨æˆ·åï¼ˆç®€åŒ–å®ç°ï¼‰
    private String getUsername(Session session) {
        // å®é™…é¡¹ç›®ä¸­å¯ä»¥ä»URLå‚æ•°æˆ–è®¤è¯ä¿¡æ¯ä¸­è·å–
        return "ç”¨æˆ·" + session.getId().substring(0, 4);
    }
}
```

---

## 3. ğŸ”§ WebSocketæœåŠ¡å™¨å®ç°


### 3.1 åˆ›å»ºå®Œæ•´çš„WebSocketåº”ç”¨


**ğŸ—ï¸ åµŒå…¥å¼WebSocketæœåŠ¡å™¨**
```java
import org.eclipse.jetty.server.Server;
import org.eclipse.jetty.servlet.ServletContextHandler;
import org.eclipse.jetty.websocket.jsr356.server.deploy.WebSocketServerContainerInitializer;

public class WebSocketServerApp {
    public static void main(String[] args) {
        try {
            // åˆ›å»ºJettyæœåŠ¡å™¨
            Server server = new Server(8080);
            
            // åˆ›å»ºä¸Šä¸‹æ–‡å¤„ç†å™¨
            ServletContextHandler context = new ServletContextHandler();
            context.setContextPath("/");
            server.setHandler(context);
            
            // é…ç½®WebSocket
            WebSocketServerContainerInitializer.configure(context, 
                (servletContext, wsContainer) -> {
                    // æ·»åŠ WebSocketç«¯ç‚¹
                    wsContainer.addEndpoint(SimpleWebSocketServer.class);
                    wsContainer.addEndpoint(UserManagementServer.class);
                });
            
            // å¯åŠ¨æœåŠ¡å™¨
            server.start();
            System.out.println("WebSocketæœåŠ¡å™¨å¯åŠ¨æˆåŠŸï¼");
            System.out.println("è®¿é—®: ws://localhost:8080/chat");
            
            // ç­‰å¾…æœåŠ¡å™¨åœæ­¢
            server.join();
            
        } catch (Exception e) {
            System.out.println("æœåŠ¡å™¨å¯åŠ¨å¤±è´¥: " + e.getMessage());
        }
    }
}
```

### 3.2 ç®€å•çš„ç½‘é¡µå®¢æˆ·ç«¯


**ğŸŒ HTML + JavaScriptå®¢æˆ·ç«¯**
```html
<!DOCTYPE html>
<html>
<head>
    <title>WebSocketæµ‹è¯•</title>
    <meta charset="UTF-8">
</head>
<body>
    <h1>WebSocketèŠå¤©æµ‹è¯•</h1>
    
    <div id="messages" style="border:1px solid #ccc; height:300px; overflow-y:scroll; padding:10px;">
        <!-- æ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸ -->
    </div>
    
    <div style="margin-top:10px;">
        <input type="text" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." style="width:70%;">
        <button onclick="sendMessage()">å‘é€</button>
        <button onclick="disconnect()">æ–­å¼€è¿æ¥</button>
    </div>
    
    <script>
        let websocket = null;
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿æ¥
        window.onload = function() {
            connect();
        };
        
        function connect() {
            try {
                // è¿æ¥WebSocketæœåŠ¡å™¨
                websocket = new WebSocket("ws://localhost:8080/chat");
                
                // è¿æ¥æˆåŠŸ
                websocket.onopen = function(event) {
                    addMessage("ç³»ç»Ÿ: è¿æ¥æˆåŠŸï¼");
                };
                
                // æ”¶åˆ°æ¶ˆæ¯
                websocket.onmessage = function(event) {
                    addMessage("æœåŠ¡å™¨: " + event.data);
                };
                
                // è¿æ¥å…³é—­
                websocket.onclose = function(event) {
                    addMessage("ç³»ç»Ÿ: è¿æ¥å·²å…³é—­");
                };
                
                // è¿æ¥å‡ºé”™
                websocket.onerror = function(event) {
                    addMessage("ç³»ç»Ÿ: è¿æ¥å‡ºé”™");
                };
                
            } catch (e) {
                addMessage("ç³»ç»Ÿ: è¿æ¥å¤±è´¥ - " + e.message);
            }
        }
        
        function sendMessage() {
            const input = document.getElementById("messageInput");
            const message = input.value.trim();
            
            if (message && websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(message);
                addMessage("æˆ‘: " + message);
                input.value = "";
            } else {
                addMessage("ç³»ç»Ÿ: æ— æ³•å‘é€æ¶ˆæ¯ï¼Œè¯·æ£€æŸ¥è¿æ¥çŠ¶æ€");
            }
        }
        
        function disconnect() {
            if (websocket) {
                websocket.close();
            }
        }
        
        function addMessage(message) {
            const messagesDiv = document.getElementById("messages");
            const messageElement = document.createElement("div");
            messageElement.innerHTML = new Date().toLocaleTimeString() + " - " + message;
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        // æŒ‰å›è½¦å‘é€æ¶ˆæ¯
        document.getElementById("messageInput").addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                sendMessage();
            }
        });
    </script>
</body>
</html>
```

---

## 4. ğŸš€ å®æ—¶é€šä¿¡åº”ç”¨æ¡ˆä¾‹


### 4.1 ç®€å•çš„èŠå¤©å®¤


**ğŸ’¬ å¤šäººèŠå¤©å®¤æœåŠ¡å™¨**
```java
import java.util.concurrent.CopyOnWriteArraySet;

@ServerEndpoint("/chatroom")
public class ChatRoomServer {
    
    // å­˜å‚¨æ‰€æœ‰åœ¨çº¿ç”¨æˆ·
    private static Set<ChatRoomServer> clients = new CopyOnWriteArraySet<>();
    private Session session;
    private String username;
    
    @OnOpen
    public void onOpen(Session session) {
        this.session = session;
        this.username = "ç”¨æˆ·" + session.getId().substring(0, 4);
        
        // æ·»åŠ åˆ°åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
        clients.add(this);
        
        // é€šçŸ¥æ‰€æœ‰äººæœ‰æ–°ç”¨æˆ·åŠ å…¥
        broadcastMessage("ç³»ç»Ÿæ¶ˆæ¯: " + username + " åŠ å…¥äº†èŠå¤©å®¤");
        
        System.out.println(username + " åŠ å…¥èŠå¤©å®¤ï¼Œå½“å‰åœ¨çº¿: " + clients.size());
    }
    
    @OnMessage
    public void onMessage(String message) {
        // å¹¿æ’­ç”¨æˆ·æ¶ˆæ¯
        broadcastMessage(username + ": " + message);
        System.out.println(username + " è¯´: " + message);
    }
    
    @OnClose
    public void onClose() {
        // ä»åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ç§»é™¤
        clients.remove(this);
        
        // é€šçŸ¥æ‰€æœ‰äººç”¨æˆ·ç¦»å¼€
        broadcastMessage("ç³»ç»Ÿæ¶ˆæ¯: " + username + " ç¦»å¼€äº†èŠå¤©å®¤");
        
        System.out.println(username + " ç¦»å¼€èŠå¤©å®¤ï¼Œå½“å‰åœ¨çº¿: " + clients.size());
    }
    
    @OnError
    public void onError(Session session, Throwable error) {
        System.out.println("ç”¨æˆ· " + username + " è¿æ¥å‡ºé”™: " + error.getMessage());
        clients.remove(this);
    }
    
    // å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰åœ¨çº¿ç”¨æˆ·
    private void broadcastMessage(String message) {
        // ä½¿ç”¨è¿­ä»£å™¨å®‰å…¨åœ°éå†é›†åˆ
        for (ChatRoomServer client : clients) {
            try {
                if (client.session.isOpen()) {
                    client.session.getBasicRemote().sendText(message);
                }
            } catch (Exception e) {
                // å‘é€å¤±è´¥ï¼Œç§»é™¤è¯¥å®¢æˆ·ç«¯
                clients.remove(client);
            }
        }
    }
}
```

### 4.2 å®æ—¶æ•°æ®æ¨é€


**ğŸ“Š è‚¡ç¥¨ä»·æ ¼æ¨é€æœåŠ¡å™¨**
```java
import java.util.concurrent.Executors;
import java.util.concurrent.ScheduledExecutorService;
import java.util.concurrent.TimeUnit;

@ServerEndpoint("/stocks")
public class StockPriceServer {
    
    private static Set<StockPriceServer> subscribers = new CopyOnWriteArraySet<>();
    private static ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(1);
    private static boolean isStarted = false;
    
    private Session session;
    
    @OnOpen
    public void onOpen(Session session) {
        this.session = session;
        subscribers.add(this);
        
        System.out.println("æ–°ç”¨æˆ·è®¢é˜…è‚¡ç¥¨ä»·æ ¼æ¨é€ï¼Œå½“å‰è®¢é˜…è€…: " + subscribers.size());
        
        // å‘é€å½“å‰ä»·æ ¼
        sendCurrentPrice();
        
        // å¯åŠ¨ä»·æ ¼æ¨é€ï¼ˆåªå¯åŠ¨ä¸€æ¬¡ï¼‰
        startPricePush();
    }
    
    @OnClose
    public void onClose() {
        subscribers.remove(this);
        System.out.println("ç”¨æˆ·å–æ¶ˆè®¢é˜…ï¼Œå½“å‰è®¢é˜…è€…: " + subscribers.size());
    }
    
    @OnError
    public void onError(Session session, Throwable error) {
        System.out.println("æ¨é€å‡ºé”™: " + error.getMessage());
        subscribers.remove(this);
    }
    
    // å‘é€å½“å‰ä»·æ ¼
    private void sendCurrentPrice() {
        try {
            String priceData = getCurrentStockData();
            session.getBasicRemote().sendText(priceData);
        } catch (Exception e) {
            System.out.println("å‘é€ä»·æ ¼å¤±è´¥: " + e.getMessage());
        }
    }
    
    // å¯åŠ¨ä»·æ ¼æ¨é€
    private synchronized void startPricePush() {
        if (!isStarted) {
            isStarted = true;
            
            // æ¯5ç§’æ¨é€ä¸€æ¬¡ä»·æ ¼æ›´æ–°
            scheduler.scheduleAtFixedRate(() -> {
                if (!subscribers.isEmpty()) {
                    String priceData = getCurrentStockData();
                    broadcastPrice(priceData);
                }
            }, 0, 5, TimeUnit.SECONDS);
            
            System.out.println("è‚¡ç¥¨ä»·æ ¼æ¨é€æœåŠ¡å¯åŠ¨");
        }
    }
    
    // å¹¿æ’­ä»·æ ¼ç»™æ‰€æœ‰è®¢é˜…è€…
    private void broadcastPrice(String priceData) {
        for (StockPriceServer subscriber : subscribers) {
            try {
                if (subscriber.session.isOpen()) {
                    subscriber.session.getBasicRemote().sendText(priceData);
                }
            } catch (Exception e) {
                subscribers.remove(subscriber);
            }
        }
    }
    
    // æ¨¡æ‹Ÿè·å–è‚¡ç¥¨æ•°æ®
    private String getCurrentStockData() {
        double applePrice = 150 + (Math.random() - 0.5) * 10; // 145-155ä¹‹é—´éšæœº
        double googlePrice = 2800 + (Math.random() - 0.5) * 100; // 2750-2850ä¹‹é—´éšæœº
        
        return String.format("{\"AAPL\": %.2f, \"GOOGL\": %.2f, \"timestamp\": %d}", 
                            applePrice, googlePrice, System.currentTimeMillis());
    }
}
```

### 4.3 ç®€å•çš„é€šçŸ¥æ¨é€


**ğŸ”” ç³»ç»Ÿé€šçŸ¥æ¨é€**
```java
@ServerEndpoint("/notifications")
public class NotificationServer {
    
    private static Set<NotificationServer> clients = new CopyOnWriteArraySet<>();
    private Session session;
    private String userId;
    
    @OnOpen
    public void onOpen(Session session) {
        this.session = session;
        this.userId = "ç”¨æˆ·" + session.getId().substring(0, 4);
        clients.add(this);
        
        System.out.println(userId + " è¿æ¥é€šçŸ¥æœåŠ¡");
        
        // å‘é€æ¬¢è¿é€šçŸ¥
        sendNotification("æ¬¢è¿ä½¿ç”¨é€šçŸ¥æœåŠ¡ï¼");
    }
    
    @OnMessage
    public void onMessage(String message) {
        // å¯ä»¥å¤„ç†å®¢æˆ·ç«¯å‘é€çš„å‘½ä»¤
        if ("get_notifications".equals(message)) {
            sendNotification("è¿™æ˜¯ä¸€æ¡æµ‹è¯•é€šçŸ¥");
        }
    }
    
    @OnClose
    public void onClose() {
        clients.remove(this);
        System.out.println(userId + " æ–­å¼€é€šçŸ¥æœåŠ¡");
    }
    
    // å‘é€é€šçŸ¥ç»™å½“å‰ç”¨æˆ·
    private void sendNotification(String notification) {
        try {
            String notificationData = String.format(
                "{\"type\": \"notification\", \"message\": \"%s\", \"time\": \"%s\"}", 
                notification, new java.util.Date());
            
            session.getBasicRemote().sendText(notificationData);
        } catch (Exception e) {
            System.out.println("å‘é€é€šçŸ¥å¤±è´¥: " + e.getMessage());
        }
    }
    
    // é™æ€æ–¹æ³•ï¼šå‘æ‰€æœ‰åœ¨çº¿ç”¨æˆ·æ¨é€é€šçŸ¥
    public static void pushToAll(String notification) {
        System.out.println("å‘æ‰€æœ‰ç”¨æˆ·æ¨é€é€šçŸ¥: " + notification);
        
        for (NotificationServer client : clients) {
            client.sendNotification(notification);
        }
    }
    
    // æµ‹è¯•æ¨é€çš„ä¸»æ–¹æ³•
    public static void main(String[] args) {
        // å¯ä»¥åœ¨å…¶ä»–åœ°æ–¹è°ƒç”¨è¿™ä¸ªæ–¹æ³•æ¥æ¨é€é€šçŸ¥
        new Thread(() -> {
            try {
                Thread.sleep(10000); // ç­‰å¾…10ç§’
                pushToAll("è¿™æ˜¯ä¸€æ¡ç³»ç»Ÿå¹¿æ’­é€šçŸ¥ï¼");
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }).start();
    }
}
```

---

## 5. ğŸ›¡ï¸ WebSocketè¿›é˜¶æŠ€å·§


### 5.1 å¿ƒè·³æ£€æµ‹æœºåˆ¶


**ğŸ’“ ä¿æŒè¿æ¥æ´»è·ƒ**
```java
@ServerEndpoint("/heartbeat")
public class HeartbeatServer {
    
    private Session session;
    private ScheduledExecutorService scheduler = Executors.newSingleThreadScheduledExecutor();
    private ScheduledFuture<?> heartbeatTask;
    
    @OnOpen
    public void onOpen(Session session) {
        this.session = session;
        startHeartbeat();
        System.out.println("å¿ƒè·³æ£€æµ‹è¿æ¥å»ºç«‹");
    }
    
    @OnMessage
    public void onMessage(String message) {
        if ("ping".equals(message)) {
            // æ”¶åˆ°å®¢æˆ·ç«¯å¿ƒè·³ï¼Œå›å¤pong
            try {
                session.getBasicRemote().sendText("pong");
            } catch (Exception e) {
                System.out.println("å›å¤å¿ƒè·³å¤±è´¥: " + e.getMessage());
            }
        } else {
            System.out.println("æ”¶åˆ°æ¶ˆæ¯: " + message);
        }
    }
    
    @OnClose
    public void onClose() {
        stopHeartbeat();
        System.out.println("å¿ƒè·³æ£€æµ‹è¿æ¥å…³é—­");
    }
    
    @OnError
    public void onError(Session session, Throwable error) {
        System.out.println("å¿ƒè·³æ£€æµ‹å‡ºé”™: " + error.getMessage());
        stopHeartbeat();
    }
    
    // å¯åŠ¨å¿ƒè·³æ£€æµ‹
    private void startHeartbeat() {
        heartbeatTask = scheduler.scheduleAtFixedRate(() -> {
            try {
                if (session.isOpen()) {
                    // æ¯30ç§’å‘é€ä¸€æ¬¡å¿ƒè·³
                    session.getBasicRemote().sendText("ping");
                    System.out.println("å‘é€å¿ƒè·³æ£€æµ‹");
                } else {
                    stopHeartbeat();
                }
            } catch (Exception e) {
                System.out.println("å¿ƒè·³æ£€æµ‹å¤±è´¥: " + e.getMessage());
                stopHeartbeat();
            }
        }, 30, 30, TimeUnit.SECONDS);
    }
    
    // åœæ­¢å¿ƒè·³æ£€æµ‹
    private void stopHeartbeat() {
        if (heartbeatTask != null && !heartbeatTask.isCancelled()) {
            heartbeatTask.cancel(true);
        }
    }
}
```

### 5.2 è¿æ¥é‡è¯•æœºåˆ¶


**ğŸ”„ JavaScriptå®¢æˆ·ç«¯é‡è¿**
```javascript
class ReconnectingWebSocket {
    constructor(url) {
        this.url = url;
        this.reconnectAttempts = 0;
        this.maxReconnectAttempts = 5;
        this.reconnectInterval = 3000; // 3ç§’
        this.connect();
    }
    
    connect() {
        try {
            this.websocket = new WebSocket(this.url);
            
            this.websocket.onopen = (event) => {
                console.log('WebSocketè¿æ¥æˆåŠŸ');
                this.reconnectAttempts = 0; // é‡ç½®é‡è¿æ¬¡æ•°
                this.onOpen(event);
            };
            
            this.websocket.onmessage = (event) => {
                this.onMessage(event);
            };
            
            this.websocket.onclose = (event) => {
                console.log('WebSocketè¿æ¥å…³é—­');
                this.onClose(event);
                this.tryReconnect();
            };
            
            this.websocket.onerror = (event) => {
                console.log('WebSocketè¿æ¥å‡ºé”™');
                this.onError(event);
            };
            
        } catch (e) {
            console.log('WebSocketè¿æ¥å¤±è´¥:', e.message);
            this.tryReconnect();
        }
    }
    
    tryReconnect() {
        if (this.reconnectAttempts < this.maxReconnectAttempts) {
            this.reconnectAttempts++;
            console.log(`ç¬¬${this.reconnectAttempts}æ¬¡é‡è¿å°è¯•...`);
            
            setTimeout(() => {
                this.connect();
            }, this.reconnectInterval);
        } else {
            console.log('é‡è¿æ¬¡æ•°å·²è¾¾ä¸Šé™ï¼Œåœæ­¢é‡è¿');
        }
    }
    
    send(message) {
        if (this.websocket && this.websocket.readyState === WebSocket.OPEN) {
            this.websocket.send(message);
        } else {
            console.log('WebSocketæœªè¿æ¥ï¼Œæ— æ³•å‘é€æ¶ˆæ¯');
        }
    }
    
    close() {
        this.maxReconnectAttempts = 0; // åœæ­¢é‡è¿
        if (this.websocket) {
            this.websocket.close();
        }
    }
    
    // è¿™äº›æ–¹æ³•å¯ä»¥è¢«é‡å†™
    onOpen(event) {}
    onMessage(event) {}
    onClose(event) {}
    onError(event) {}
}

// ä½¿ç”¨ç¤ºä¾‹
const ws = new ReconnectingWebSocket('ws://localhost:8080/chat');

ws.onMessage = function(event) {
    console.log('æ”¶åˆ°æ¶ˆæ¯:', event.data);
};

// å‘é€æ¶ˆæ¯
ws.send('Hello Server!');
```

### 5.3 æ¶ˆæ¯ç¡®è®¤æœºåˆ¶


**âœ… ç¡®ä¿æ¶ˆæ¯é€è¾¾**
```java
@ServerEndpoint("/reliable")
public class ReliableMessageServer {
    
    private Session session;
    private Map<String, String> pendingMessages = new ConcurrentHashMap<>();
    
    @OnOpen
    public void onOpen(Session session) {
        this.session = session;
        System.out.println("å¯é æ¶ˆæ¯æœåŠ¡è¿æ¥å»ºç«‹");
    }
    
    @OnMessage
    public void onMessage(String message) {
        try {
            // è§£ææ¶ˆæ¯
            if (message.startsWith("ACK:")) {
                // æ”¶åˆ°ç¡®è®¤æ¶ˆæ¯
                String messageId = message.substring(4);
                handleAck(messageId);
            } else {
                // æ™®é€šæ¶ˆæ¯ï¼Œéœ€è¦ç¡®è®¤
                String messageId = generateMessageId();
                String response = "æ¶ˆæ¯å·²æ”¶åˆ°: " + message;
                
                // å‘é€å¸¦IDçš„æ¶ˆæ¯
                String messageWithId = messageId + ":" + response;
                session.getBasicRemote().sendText(messageWithId);
                
                // å­˜å‚¨å¾…ç¡®è®¤æ¶ˆæ¯
                pendingMessages.put(messageId, messageWithId);
                
                System.out.println("å‘é€æ¶ˆæ¯: " + response + "ï¼Œç­‰å¾…ç¡®è®¤");
            }
        } catch (Exception e) {
            System.out.println("å¤„ç†æ¶ˆæ¯å¤±è´¥: " + e.getMessage());
        }
    }
    
    @OnClose
    public void onClose() {
        System.out.println("å¯é æ¶ˆæ¯æœåŠ¡è¿æ¥å…³é—­");
    }
    
    // å¤„ç†ç¡®è®¤æ¶ˆæ¯
    private void handleAck(String messageId) {
        if (pendingMessages.remove(messageId) != null) {
            System.out.println("æ¶ˆæ¯ " + messageId + " ç¡®è®¤æ”¶åˆ°");
        } else {
            System.out.println("æ”¶åˆ°æœªçŸ¥æ¶ˆæ¯çš„ç¡®è®¤: " + messageId);
        }
    }
    
    // ç”Ÿæˆæ¶ˆæ¯ID
    private String generateMessageId() {
        return "MSG_" + System.currentTimeMillis();
    }
}
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„åŸºç¡€æ¦‚å¿µ


```
ğŸ”¸ WebSocket = ç½‘é¡µä¸Šçš„"ç”µè¯çº¿"ï¼Œå¯ä»¥å®æ—¶åŒå‘é€šä¿¡
ğŸ”¸ å››ä¸ªæ³¨è§£ = @OnOpenï¼ˆè¿æ¥æ—¶ï¼‰ã€@OnMessageï¼ˆæ”¶æ¶ˆæ¯æ—¶ï¼‰ã€@OnCloseï¼ˆæ–­å¼€æ—¶ï¼‰ã€@OnErrorï¼ˆå‡ºé”™æ—¶ï¼‰
ğŸ”¸ Session = ä»£è¡¨ä¸€ä¸ªç”¨æˆ·è¿æ¥ï¼Œç”¨æ¥å‘é€æ¶ˆæ¯
ğŸ”¸ è¿æ¥çŠ¶æ€ = CONNECTING â†’ OPEN â†’ CLOSING â†’ CLOSED
ğŸ”¸ é€‚ç”¨åœºæ™¯ = èŠå¤©ã€æ¨é€ã€å®æ—¶æ¸¸æˆã€åä½œç¼–è¾‘
```

### 6.2 ç¼–ç¨‹è¦ç‚¹


**ğŸ”¹ WebSocketæœåŠ¡å™¨å¥—è·¯**
```
åˆ›å»ºWebSocketæœåŠ¡å™¨çš„æ­¥éª¤ï¼š
1. åˆ›å»ºç±»å¹¶æ·»åŠ @ServerEndpointæ³¨è§£
2. å®ç°å››ä¸ªå…³é”®æ–¹æ³•ï¼ˆ@OnOpenã€@OnMessageã€@OnCloseã€@OnErrorï¼‰
3. åœ¨@OnMessageä¸­å¤„ç†æ”¶åˆ°çš„æ¶ˆæ¯
4. ä½¿ç”¨session.getBasicRemote().sendText()å‘é€æ¶ˆæ¯
5. ç®¡ç†æ‰€æœ‰è¿æ¥çš„Session

è®°ä½ï¼šWebSocketæ˜¯åŒå‘çš„ï¼ŒæœåŠ¡å™¨å¯ä»¥ä¸»åŠ¨å‘æ¶ˆæ¯ï¼
```

**ğŸ”¹ å®¢æˆ·ç«¯ç¼–ç¨‹å¥—è·¯**
```
JavaScriptå®¢æˆ·ç«¯çš„åŸºæœ¬æ­¥éª¤ï¼š
1. new WebSocket(url)åˆ›å»ºè¿æ¥
2. è®¾ç½®onopenã€onmessageã€oncloseã€onerroräº‹ä»¶
3. ä½¿ç”¨websocket.send()å‘é€æ¶ˆæ¯
4. åœ¨onmessageä¸­å¤„ç†æ”¶åˆ°çš„æ¶ˆæ¯
5. è®°å¾—å¤„ç†è¿æ¥æ–­å¼€å’Œé‡è¿

è®°ä½ï¼šæ£€æŸ¥readyStateçŠ¶æ€å†å‘é€æ¶ˆæ¯ï¼
```

### 6.3 é‡è¦æ³¨æ„äº‹é¡¹


**âš ï¸ å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ**
```
è¿æ¥ç®¡ç†ï¼š
â€¢ ä¿å­˜æ‰€æœ‰Sessionåˆ°é›†åˆä¸­
â€¢ å®šæœŸæ¸…ç†æ–­å¼€çš„è¿æ¥
â€¢ å‘é€æ¶ˆæ¯å‰æ£€æŸ¥Session.isOpen()

å¼‚å¸¸å¤„ç†ï¼š
â€¢ å‘é€æ¶ˆæ¯è¦try-catch
â€¢ è¿æ¥æ–­å¼€è¦ä»é›†åˆä¸­ç§»é™¤
â€¢ ç½‘ç»œé—®é¢˜è¦å®ç°é‡è¿æœºåˆ¶

æ€§èƒ½ä¼˜åŒ–ï¼š
â€¢ ä½¿ç”¨CopyOnWriteArraySetå­˜å‚¨è¿æ¥
â€¢ å¤§é‡æ¶ˆæ¯æ—¶ä½¿ç”¨å¼‚æ­¥å‘é€
â€¢ å®ç°å¿ƒè·³æ£€æµ‹é˜²æ­¢è¿æ¥è¶…æ—¶
```

### 6.4 é€‚ç”¨åœºæ™¯åˆ¤æ–­


**ğŸ¯ ä»€ä¹ˆæ—¶å€™ç”¨WebSocket**
```
âœ… é€‚åˆWebSocketçš„åœºæ™¯ï¼š
â€¢ èŠå¤©åº”ç”¨ï¼šQQã€å¾®ä¿¡ã€åœ¨çº¿å®¢æœ
â€¢ å®æ—¶æ¨é€ï¼šè‚¡ç¥¨ä»·æ ¼ã€æ–°é—»æ¨é€ã€ç³»ç»Ÿé€šçŸ¥
â€¢ åœ¨çº¿æ¸¸æˆï¼šå®æ—¶å¯¹æˆ˜ã€çŠ¶æ€åŒæ­¥
â€¢ åä½œå·¥å…·ï¼šåœ¨çº¿æ–‡æ¡£ç¼–è¾‘ã€å…±äº«ç™½æ¿
â€¢ ç›‘æ§ç³»ç»Ÿï¼šå®æ—¶æ•°æ®ç›‘æ§ã€æ—¥å¿—æ¨é€

âŒ ä¸é€‚åˆWebSocketçš„åœºæ™¯ï¼š
â€¢ æ™®é€šç½‘é¡µæµè§ˆ
â€¢ æ–‡ä»¶ä¸Šä¼ ä¸‹è½½
â€¢ RESTful APIè°ƒç”¨
â€¢ æœç´¢å¼•æ“çˆ¬è™«
â€¢ ä¸€æ¬¡æ€§æ•°æ®è·å–
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- WebSocketè®©ç½‘é¡µèƒ½å¤Ÿå®æ—¶åŒå‘é€šä¿¡ï¼Œåƒæ‰“ç”µè¯ä¸€æ ·
- æœåŠ¡å™¨ç”¨@ServerEndpointæ³¨è§£ï¼Œå®¢æˆ·ç«¯ç”¨JavaScript WebSocket API
- ç®¡ç†å¥½æ‰€æœ‰ç”¨æˆ·çš„Sessionï¼Œå°±èƒ½å®ç°ç¾¤èŠå’Œæ¨é€
- è®°å¾—å¤„ç†è¿æ¥æ–­å¼€ã€å¼‚å¸¸æƒ…å†µå’Œé‡è¿æœºåˆ¶
- é€‚åˆå®æ—¶æ€§è¦æ±‚é«˜çš„åº”ç”¨ï¼Œä¸é€‚åˆæ™®é€šçš„ç½‘é¡µè¯·æ±‚