---
title: 6ã€JVMè°ƒä¼˜ä¸ç”Ÿäº§å®è·µ
---
## ğŸ“š ç›®å½•

1. [JVMå‚æ•°ä¸é…ç½®](#1-JVMå‚æ•°ä¸é…ç½®)
2. [æ€§èƒ½ç›‘æ§ä¸è¯Šæ–­å·¥å…·](#2-æ€§èƒ½ç›‘æ§ä¸è¯Šæ–­å·¥å…·)
3. [å†…å­˜é—®é¢˜æ’æŸ¥ä¸è°ƒä¼˜](#3-å†…å­˜é—®é¢˜æ’æŸ¥ä¸è°ƒä¼˜)

---

## 1. âš™ï¸ JVMå‚æ•°ä¸é…ç½®


### 1.1 JVMå‚æ•°åˆ†ç±»ï¼šæ ‡å‡†å‚æ•°ã€Xå‚æ•°ã€XXå‚æ•°


**ğŸ“‹ JVMå‚æ•°åˆ†ç±»æ¦‚è§ˆ**

| å‚æ•°ç±»å‹ | **æ ¼å¼** | **ç¨³å®šæ€§** | **ç¤ºä¾‹** | **è¯´æ˜** |
|---------|---------|-----------|---------|---------|
| ğŸ”¸ **æ ‡å‡†å‚æ•°** | `-å‚æ•°å` | `ç¨³å®šï¼Œæ‰€æœ‰JVMæ”¯æŒ` | `-serverã€-client` | `æ ‡å‡†åŒ–å‚æ•°ï¼Œè·¨ç‰ˆæœ¬å…¼å®¹` |
| ğŸ”¹ **Xå‚æ•°** | `-Xå‚æ•°å` | `ç›¸å¯¹ç¨³å®šï¼Œå¯èƒ½å˜åŒ–` | `-Xmsã€-Xmxã€-Xss` | `æ‰©å±•å‚æ•°ï¼Œå¸¸ç”¨å†…å­˜è®¾ç½®` |
| ğŸ”º **XXå‚æ•°** | `-XX:å‚æ•°å` | `ä¸ç¨³å®šï¼Œç‰ˆæœ¬é—´å¯èƒ½å˜åŒ–` | `-XX:+UseG1GC` | `é«˜çº§å‚æ•°ï¼Œç»†ç²’åº¦æ§åˆ¶` |

**ğŸ”¸ æ ‡å‡†å‚æ•°ï¼ˆStandard Optionsï¼‰**
```bash
# æ ‡å‡†å‚æ•°ç¤ºä¾‹
java -server MyApp                    # æœåŠ¡å™¨æ¨¡å¼
java -client MyApp                    # å®¢æˆ·ç«¯æ¨¡å¼
java -version                         # æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
java -help                           # æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
java -cp /path/to/classes MyApp      # è®¾ç½®ç±»è·¯å¾„

# ç‰¹ç‚¹ï¼š
# âœ… æ‰€æœ‰JVMå®ç°éƒ½å¿…é¡»æ”¯æŒ
# âœ… è·¨ç‰ˆæœ¬ç¨³å®šï¼Œå‘åå…¼å®¹
# âœ… é€šå¸¸ç”¨äºåŸºæœ¬é…ç½®
```

**ğŸ”¹ Xå‚æ•°ï¼ˆNon-Standard Optionsï¼‰**
```bash
# Xå‚æ•°ç¤ºä¾‹ï¼ˆå†…å­˜ç›¸å…³ï¼‰
java -Xms512m MyApp                  # åˆå§‹å †å¤§å°512MB
java -Xmx2g MyApp                    # æœ€å¤§å †å¤§å°2GB
java -Xss256k MyApp                  # æ ˆå¤§å°256KB
java -Xmn512m MyApp                  # æ–°ç”Ÿä»£å¤§å°512MB

# å…¶ä»–Xå‚æ•°
java -Xint MyApp                     # ä»…è§£é‡Šæ¨¡å¼
java -Xcomp MyApp                    # ä»…ç¼–è¯‘æ¨¡å¼
java -Xmixed MyApp                   # æ··åˆæ¨¡å¼ï¼ˆé»˜è®¤ï¼‰

# ç‰¹ç‚¹ï¼š
# âœ… éæ ‡å‡†ä½†å¸¸ç”¨çš„å‚æ•°
# âœ… å¤§éƒ¨åˆ†JVMå®ç°æ”¯æŒ
# âŒ ä¸ä¿è¯è·¨ç‰ˆæœ¬å…¼å®¹
```

**ğŸ”º XXå‚æ•°ï¼ˆAdvanced Optionsï¼‰**
```bash
# XXå‚æ•°æ ¼å¼
-XX:+<option>                        # å¯ç”¨å¸ƒå°”é€‰é¡¹
-XX:-<option>                        # ç¦ç”¨å¸ƒå°”é€‰é¡¹
-XX:<option>=<value>                 # è®¾ç½®æ•°å€¼é€‰é¡¹

# åƒåœ¾æ”¶é›†å™¨é€‰æ‹©
java -XX:+UseG1GC MyApp              # ä½¿ç”¨G1æ”¶é›†å™¨
java -XX:+UseZGC MyApp               # ä½¿ç”¨ZGCæ”¶é›†å™¨
java -XX:+UseConcMarkSweepGC MyApp   # ä½¿ç”¨CMSæ”¶é›†å™¨

# æ€§èƒ½è°ƒä¼˜å‚æ•°
java -XX:MaxGCPauseMillis=200 MyApp  # æœ€å¤§GCæš‚åœæ—¶é—´
java -XX:NewRatio=2 MyApp            # æ–°ç”Ÿä»£ä¸è€å¹´ä»£æ¯”ä¾‹
java -XX:SurvivorRatio=8 MyApp       # Edenä¸Survivoræ¯”ä¾‹

# è°ƒè¯•è¯Šæ–­å‚æ•°
java -XX:+PrintGCDetails MyApp       # æ‰“å°GCè¯¦ç»†ä¿¡æ¯
java -XX:+HeapDumpOnOutOfMemoryError MyApp  # OOMæ—¶ç”Ÿæˆå †è½¬å‚¨
```

### 1.2 å†…å­˜ç›¸å…³å‚æ•°ï¼š-Xmsã€-Xmxã€-Xmnã€-XX:NewRatio


**ğŸ’¾ å †å†…å­˜å¤§å°è®¾ç½®**
```bash
# åŸºæœ¬å †å†…å­˜å‚æ•°
-Xms<size>          # åˆå§‹å †å¤§å°
-Xmx<size>          # æœ€å¤§å †å¤§å°
-Xmn<size>          # æ–°ç”Ÿä»£å¤§å°

# ç¤ºä¾‹é…ç½®
java -Xms1g -Xmx4g -Xmn1g MyApp

# å¤§å°å•ä½ï¼š
# k/K = KB (1024å­—èŠ‚)
# m/M = MB (1024KB)  
# g/G = GB (1024MB)
```

**ğŸ“Š å†…å­˜å‚æ•°æœ€ä½³å®è·µ**
```java
// ç”Ÿäº§ç¯å¢ƒå†…å­˜é…ç½®ç¤ºä¾‹
public class MemoryConfiguration {
    public static void main(String[] args) {
        // Webåº”ç”¨é…ç½®ï¼ˆ8GBç‰©ç†å†…å­˜æœºå™¨ï¼‰
        // -Xms4g -Xmx4g -Xmn1536m
        
        // æ‰¹å¤„ç†åº”ç”¨é…ç½®ï¼ˆ16GBç‰©ç†å†…å­˜æœºå™¨ï¼‰
        // -Xms8g -Xmx12g -Xmn3g
        
        // å¾®æœåŠ¡é…ç½®ï¼ˆ2GBç‰©ç†å†…å­˜æœºå™¨ï¼‰
        // -Xms512m -Xmx1g -Xmn256m
    }
}

// å†…å­˜è®¾ç½®åŸåˆ™ï¼š
// âœ… Xms = Xmxï¼šé¿å…å †æ‰©å®¹å¼€é”€
// âœ… å †å¤§å° â‰¤ ç‰©ç†å†…å­˜çš„75%ï¼šç•™ç»™æ“ä½œç³»ç»Ÿå’Œå…¶ä»–è¿›ç¨‹
// âœ… æ–°ç”Ÿä»£å¤§å° = å †å¤§å°çš„25-40%ï¼šæ ¹æ®å¯¹è±¡ç”Ÿå‘½å‘¨æœŸè°ƒæ•´
// âŒ é¿å…è®¾ç½®è¿‡å¤§ï¼šGCæ—¶é—´è¿‡é•¿
// âŒ é¿å…è®¾ç½®è¿‡å°ï¼šé¢‘ç¹GCå½±å“æ€§èƒ½
```

**ğŸ—ï¸ æ–°ç”Ÿä»£ä¸è€å¹´ä»£æ¯”ä¾‹è°ƒæ•´**
```bash
# æ–¹å¼1ï¼šç›´æ¥è®¾ç½®æ–°ç”Ÿä»£å¤§å°
-Xmn<size>                           # æ–°ç”Ÿä»£å¤§å°

# æ–¹å¼2ï¼šè®¾ç½®æ–°ç”Ÿä»£ä¸è€å¹´ä»£æ¯”ä¾‹
-XX:NewRatio=<ratio>                 # è€å¹´ä»£ä¸æ–°ç”Ÿä»£æ¯”ä¾‹

# æ–¹å¼3ï¼šè®¾ç½®æ–°ç”Ÿä»£å å †çš„æ¯”ä¾‹
-XX:NewSize=<size>                   # æ–°ç”Ÿä»£åˆå§‹å¤§å°
-XX:MaxNewSize=<size>                # æ–°ç”Ÿä»£æœ€å¤§å¤§å°

# SurvivoråŒºæ¯”ä¾‹è®¾ç½®
-XX:SurvivorRatio=<ratio>            # Edenä¸å•ä¸ªSurvivoræ¯”ä¾‹

# ç¤ºä¾‹é…ç½®
java -Xmx4g -XX:NewRatio=2 MyApp     # è€å¹´ä»£:æ–°ç”Ÿä»£ = 2:1
java -Xmx4g -XX:SurvivorRatio=8 MyApp # Eden:S0:S1 = 8:1:1
```

**ğŸ“ˆ å†…å­˜æ¯”ä¾‹è®¡ç®—ç¤ºä¾‹**
```
å †å†…å­˜åˆ†é…è®¡ç®—ï¼ˆä»¥4GBå †ä¸ºä¾‹ï¼‰ï¼š

é…ç½®ï¼š-Xmx4g -XX:NewRatio=2 -XX:SurvivorRatio=8

è®¡ç®—è¿‡ç¨‹ï¼š
æ€»å †å¤§å°ï¼š4GB
æ–°ç”Ÿä»£å¤§å°ï¼š4GB Ã· (2+1) = 1.33GB
è€å¹´ä»£å¤§å°ï¼š4GB - 1.33GB = 2.67GB

æ–°ç”Ÿä»£å†…éƒ¨åˆ†é…ï¼š
EdenåŒºï¼š1.33GB Ã— (8Ã·10) = 1.07GB
Survivor0ï¼š1.33GB Ã— (1Ã·10) = 0.13GB
Survivor1ï¼š1.33GB Ã— (1Ã·10) = 0.13GB

å†…å­˜å¸ƒå±€ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            4GB å †å†…å­˜               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   1.33GB       â”‚      2.67GB       â”‚
â”‚   æ–°ç”Ÿä»£        â”‚      è€å¹´ä»£        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚                  â”‚
â”‚ â”‚Eden â”‚S0â”‚ S1 â”‚â”‚                  â”‚
â”‚ â”‚1.07Gâ”‚.13â”‚.13â”‚â”‚                  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 GCç›¸å…³å‚æ•°ï¼š-XX:+UseG1GCã€-XX:MaxGCPauseMillis


**ğŸ—‘ï¸ åƒåœ¾æ”¶é›†å™¨é€‰æ‹©å‚æ•°**
```bash
# é€‰æ‹©åƒåœ¾æ”¶é›†å™¨
-XX:+UseSerialGC                     # Serialæ”¶é›†å™¨ï¼ˆå•çº¿ç¨‹ï¼‰
-XX:+UseParallelGC                   # Parallelæ”¶é›†å™¨ï¼ˆå¤šçº¿ç¨‹ï¼‰
-XX:+UseParNewGC                     # ParNewæ”¶é›†å™¨ï¼ˆé…åˆCMSï¼‰
-XX:+UseConcMarkSweepGC              # CMSæ”¶é›†å™¨ï¼ˆä½å»¶è¿Ÿï¼‰
-XX:+UseG1GC                         # G1æ”¶é›†å™¨ï¼ˆå¤§å †ä½å»¶è¿Ÿï¼‰
-XX:+UseZGC                          # ZGCæ”¶é›†å™¨ï¼ˆè¶…ä½å»¶è¿Ÿï¼‰
-XX:+UseShenandoahGC                 # Shenandoahæ”¶é›†å™¨

# Java 11+é»˜è®¤G1ï¼ŒJava 8é»˜è®¤Parallel
```

**ğŸ¯ G1æ”¶é›†å™¨å‚æ•°è¯¦è§£**
```bash
# G1åŸºç¡€å‚æ•°
-XX:+UseG1GC                         # å¯ç”¨G1æ”¶é›†å™¨
-XX:MaxGCPauseMillis=200             # æœ€å¤§GCæš‚åœæ—¶é—´ç›®æ ‡ï¼ˆæ¯«ç§’ï¼‰
-XX:G1HeapRegionSize=16m             # G1åŒºåŸŸå¤§å°ï¼ˆ1MB-32MBï¼‰

# G1é«˜çº§å‚æ•°
-XX:G1NewSizePercent=20              # æ–°ç”Ÿä»£åˆå§‹å æ¯”ï¼ˆé»˜è®¤5%ï¼‰
-XX:G1MaxNewSizePercent=40           # æ–°ç”Ÿä»£æœ€å¤§å æ¯”ï¼ˆé»˜è®¤60%ï¼‰
-XX:G1MixedGCCountTarget=8           # æ··åˆGCæ¬¡æ•°ç›®æ ‡
-XX:G1OldCSetRegionThreshold=10      # è€å¹´ä»£åŒºåŸŸå›æ”¶é˜ˆå€¼

# G1è°ƒä¼˜ç¤ºä¾‹
java -XX:+UseG1GC \
     -XX:MaxGCPauseMillis=100 \
     -XX:G1HeapRegionSize=32m \
     -Xmx8g MyApp
```

**âš¡ å…¶ä»–æ”¶é›†å™¨å…³é”®å‚æ•°**
```bash
# Parallelæ”¶é›†å™¨å‚æ•°
-XX:+UseParallelGC                   # å¯ç”¨Parallelæ”¶é›†å™¨
-XX:ParallelGCThreads=8              # å¹¶è¡ŒGCçº¿ç¨‹æ•°
-XX:MaxGCPauseMillis=200             # æœ€å¤§GCæš‚åœæ—¶é—´
-XX:GCTimeRatio=99                   # GCæ—¶é—´å æ¯”ç›®æ ‡ï¼ˆ1%ï¼‰

# CMSæ”¶é›†å™¨å‚æ•°
-XX:+UseConcMarkSweepGC              # å¯ç”¨CMSæ”¶é›†å™¨
-XX:+UseParNewGC                     # æ–°ç”Ÿä»£ä½¿ç”¨ParNew
-XX:CMSInitiatingOccupancyFraction=70 # è€å¹´ä»£ä½¿ç”¨ç‡è¾¾åˆ°70%æ—¶è§¦å‘CMS
-XX:+UseCMSInitiatingOccupancyOnly   # åªæŒ‰å ç”¨ç‡è§¦å‘ï¼Œä¸è‡ªåŠ¨è°ƒæ•´

# ZGCæ”¶é›†å™¨å‚æ•°ï¼ˆJava 11+ï¼‰
-XX:+UnlockExperimentalVMOptions     # è§£é”å®éªŒç‰¹æ€§
-XX:+UseZGC                          # å¯ç”¨ZGC
-XX:+UseLargePages                   # ä½¿ç”¨å¤§é¡µå†…å­˜
```

### 1.4 è°ƒè¯•å‚æ•°ï¼š-XX:+PrintGCDetailsã€-XX:+HeapDumpOnOutOfMemoryError


**ğŸ“Š GCæ—¥å¿—å‚æ•°**
```bash
# åŸºç¡€GCæ—¥å¿—å‚æ•°
-XX:+PrintGC                         # æ‰“å°åŸºæœ¬GCä¿¡æ¯
-XX:+PrintGCDetails                  # æ‰“å°è¯¦ç»†GCä¿¡æ¯
-XX:+PrintGCTimeStamps               # æ‰“å°GCæ—¶é—´æˆ³
-XX:+PrintGCDateStamps               # æ‰“å°GCæ—¥æœŸæ—¶é—´

# GCæ—¥å¿—æ–‡ä»¶é…ç½®
-Xloggc:/path/to/gc.log              # GCæ—¥å¿—æ–‡ä»¶è·¯å¾„
-XX:+UseGCLogFileRotation            # å¯ç”¨æ—¥å¿—æ–‡ä»¶è½®è½¬
-XX:NumberOfGCLogFiles=5             # ä¿ç•™æ—¥å¿—æ–‡ä»¶æ•°é‡
-XX:GCLogFileSize=100M               # å•ä¸ªæ—¥å¿—æ–‡ä»¶å¤§å°

# Java 9+ç»Ÿä¸€æ—¥å¿—æ ¼å¼
-Xlog:gc*:gc.log:time,tags           # æ–°ç‰ˆæœ¬GCæ—¥å¿—æ ¼å¼
```

**ğŸ’» GCæ—¥å¿—ç¤ºä¾‹åˆ†æ**
```java
// GCæ—¥å¿—é…ç½®ç¤ºä¾‹
public class GCLoggingExample {
    public static void main(String[] args) {
        // JVMå‚æ•°ï¼š
        // -XX:+UseG1GC
        // -XX:+PrintGCDetails
        // -XX:+PrintGCTimeStamps
        // -Xloggc:gc.log
        
        List<byte[]> memory = new ArrayList<>();
        
        // åˆ›å»ºå¯¹è±¡è§¦å‘GC
        for (int i = 0; i < 1000; i++) {
            memory.add(new byte[1024 * 1024]); // 1MBå¯¹è±¡
            
            if (i % 100 == 0) {
                System.out.println("Allocated: " + i + "MB");
            }
        }
    }
}

// GCæ—¥å¿—è¾“å‡ºç¤ºä¾‹ï¼š
// 2024-01-27T10:30:15.123+0800: [GC pause (G1 Evacuation Pause) (young)
//  [Parallel Time: 25.0 ms, GC Workers: 4]
//  [Eden: 512.0M(512.0M)->0.0B(256.0M) Survivors: 0.0B->64.0M Heap: 512.0M(2048.0M)->128.0M(2048.0M)]
//  [Times: user=0.08 sys=0.01, real=0.03 secs]
```

**ğŸš¨ å†…å­˜æº¢å‡ºè¯Šæ–­å‚æ•°**
```bash
# å†…å­˜æº¢å‡ºæ—¶è‡ªåŠ¨ç”Ÿæˆå †è½¬å‚¨
-XX:+HeapDumpOnOutOfMemoryError      # OOMæ—¶ç”Ÿæˆheap dump
-XX:HeapDumpPath=/path/to/dumps/     # heap dumpä¿å­˜è·¯å¾„

# é”™è¯¯å¤„ç†å‚æ•°
-XX:OnOutOfMemoryError="kill -9 %p"  # OOMæ—¶æ‰§è¡Œçš„å‘½ä»¤
-XX:+ExitOnOutOfMemoryError          # OOMæ—¶é€€å‡ºJVM

# å†…å­˜ä½¿ç”¨æƒ…å†µç›‘æ§
-XX:+PrintGCApplicationStoppedTime   # æ‰“å°åº”ç”¨æš‚åœæ—¶é—´
-XX:+PrintGCApplicationConcurrentTime # æ‰“å°åº”ç”¨è¿è¡Œæ—¶é—´
-XX:+PrintStringDeduplicationStatistics # å­—ç¬¦ä¸²å»é‡ç»Ÿè®¡

# JFRï¼ˆJava Flight Recorderï¼‰å‚æ•°
-XX:+FlightRecorder                  # å¯ç”¨JFR
-XX:StartFlightRecording=duration=60s,filename=app.jfr # è®°å½•60ç§’
```

### 1.5 å‚æ•°è®¾ç½®çš„æœ€ä½³å®è·µå’Œå¸¸è§è¯¯åŒº


**âœ… æœ€ä½³å®è·µ**
```bash
# 1. ç”Ÿäº§ç¯å¢ƒæ ‡å‡†é…ç½®æ¨¡æ¿
# Webåº”ç”¨ï¼ˆ8GBå†…å­˜æœåŠ¡å™¨ï¼‰
java -server \
     -Xms4g -Xmx4g \
     -XX:+UseG1GC \
     -XX:MaxGCPauseMillis=200 \
     -XX:+HeapDumpOnOutOfMemoryError \
     -XX:HeapDumpPath=/var/log/heapdump/ \
     -Xloggc:/var/log/gc.log \
     -XX:+PrintGCDetails \
     -XX:+PrintGCDateStamps \
     -XX:+UseGCLogFileRotation \
     -XX:NumberOfGCLogFiles=5 \
     -XX:GCLogFileSize=100M \
     -jar myapp.jar

# 2. å¾®æœåŠ¡é…ç½®æ¨¡æ¿
# å®¹å™¨åŒ–å¾®æœåŠ¡ï¼ˆ2GBå†…å­˜é™åˆ¶ï¼‰
java -server \
     -Xms1g -Xmx1g \
     -XX:+UseG1GC \
     -XX:MaxGCPauseMillis=100 \
     -XX:+ExitOnOutOfMemoryError \
     -jar microservice.jar

# 3. æ‰¹å¤„ç†é…ç½®æ¨¡æ¿
# å¤§æ•°æ®æ‰¹å¤„ç†ï¼ˆ16GBå†…å­˜æœåŠ¡å™¨ï¼‰
java -server \
     -Xms8g -Xmx12g \
     -XX:+UseParallelGC \
     -XX:ParallelGCThreads=8 \
     -XX:+HeapDumpOnOutOfMemoryError \
     -jar batch-job.jar
```

**âŒ å¸¸è§è¯¯åŒºå’Œè§£å†³æ–¹æ¡ˆ**

| è¯¯åŒº | **é—®é¢˜** | **æ­£ç¡®åšæ³•** |
|------|---------|-------------|
| ğŸš« **Xms â‰  Xmx** | `å †æ‰©å®¹é€ æˆæ€§èƒ½æŠ–åŠ¨` | `è®¾ç½®Xms = Xmxé¿å…æ‰©å®¹` |
| ğŸš« **å †è¿‡å¤§** | `GCæš‚åœæ—¶é—´è¿‡é•¿` | `æ ¹æ®åº”ç”¨ç‰¹ç‚¹åˆç†è®¾ç½®ï¼Œè€ƒè™‘GCå½±å“` |
| ğŸš« **æ–°ç”Ÿä»£è¿‡å°** | `é¢‘ç¹Minor GC` | `æ–°ç”Ÿä»£è®¾ä¸ºå †å¤§å°çš„25-40%` |
| ğŸš« **å‚æ•°å†²çª** | `æŸäº›å‚æ•°ç»„åˆæ— æ•ˆ` | `äº†è§£å‚æ•°é—´çš„ä¾èµ–å…³ç³»` |
| ğŸš« **ç›²ç›®è°ƒä¼˜** | `æ— é’ˆå¯¹æ€§è°ƒæ•´å‚æ•°` | `å…ˆç›‘æ§åˆ†æï¼Œå†æœ‰é’ˆå¯¹æ€§è°ƒä¼˜` |

**ğŸ“‹ å‚æ•°è®¾ç½®æ£€æŸ¥æ¸…å•**
```java
// å‚æ•°è®¾ç½®è‡ªæ£€ä»£ç 
public class JVMParameterCheck {
    public static void main(String[] args) {
        Runtime runtime = Runtime.getRuntime();
        
        // æ£€æŸ¥å†…å­˜è®¾ç½®
        long maxMemory = runtime.maxMemory();
        long totalMemory = runtime.totalMemory();
        long freeMemory = runtime.freeMemory();
        
        System.out.println("æœ€å¤§å †å†…å­˜: " + (maxMemory / 1024 / 1024) + "MB");
        System.out.println("å½“å‰å †å†…å­˜: " + (totalMemory / 1024 / 1024) + "MB");
        System.out.println("ç©ºé—²å †å†…å­˜: " + (freeMemory / 1024 / 1024) + "MB");
        
        // æ£€æŸ¥GCé…ç½®
        List<GarbageCollectorMXBean> gcBeans = ManagementFactory.getGarbageCollectorMXBeans();
        for (GarbageCollectorMXBean gcBean : gcBeans) {
            System.out.println("GCåç§°: " + gcBean.getName());
            System.out.println("å›æ”¶æ¬¡æ•°: " + gcBean.getCollectionCount());
            System.out.println("å›æ”¶æ—¶é—´: " + gcBean.getCollectionTime() + "ms");
        }
        
        // æ£€æŸ¥JVMå‚æ•°
        RuntimeMXBean runtimeBean = ManagementFactory.getRuntimeMXBean();
        List<String> jvmArgs = runtimeBean.getInputArguments();
        System.out.println("JVMå‚æ•°: " + jvmArgs);
    }
}
```

---

## 2. ğŸ” æ€§èƒ½ç›‘æ§ä¸è¯Šæ–­å·¥å…·


### 2.1 å‘½ä»¤è¡Œå·¥å…·ï¼šjpsã€jstatã€jinfoã€jmapã€jhatã€jstack


**ğŸ” jps - Javaè¿›ç¨‹çŠ¶æ€å·¥å…·**
```bash
# åŸºæœ¬ç”¨æ³•
jps                                  # æ˜¾ç¤ºæ‰€æœ‰Javaè¿›ç¨‹
jps -l                               # æ˜¾ç¤ºä¸»ç±»å®Œæ•´åç§°
jps -v                               # æ˜¾ç¤ºJVMå‚æ•°
jps -m                               # æ˜¾ç¤ºmainæ–¹æ³•å‚æ•°

# ç¤ºä¾‹è¾“å‡º
$ jps -l
12345 com.example.MyApplication
12346 org.apache.tomcat.startup.Bootstrap  
12347 org.elasticsearch.bootstrap.Elasticsearch

# å®é™…åº”ç”¨
jps | grep MyApp                     # æŸ¥æ‰¾ç‰¹å®šåº”ç”¨è¿›ç¨‹
```

**ğŸ“Š jstat - JVMç»Ÿè®¡ä¿¡æ¯ç›‘æ§**
```bash
# åŸºæœ¬è¯­æ³•
jstat -<option> <pid> [interval] [count]

# å¸¸ç”¨é€‰é¡¹
jstat -gc <pid>                      # æŸ¥çœ‹GCæƒ…å†µ
jstat -gcutil <pid>                  # æŸ¥çœ‹GCä½¿ç”¨ç‡
jstat -gccapacity <pid>              # æŸ¥çœ‹å„ä»£å®¹é‡
jstat -gcnew <pid>                   # æŸ¥çœ‹æ–°ç”Ÿä»£GC
jstat -gcold <pid>                   # æŸ¥çœ‹è€å¹´ä»£GC

# å®æ—¶ç›‘æ§ç¤ºä¾‹
jstat -gc 12345 250 4                # æ¯250msè¾“å‡ºä¸€æ¬¡ï¼Œå…±4æ¬¡
jstat -gcutil 12345 1s               # æ¯ç§’è¾“å‡ºGCä½¿ç”¨ç‡

# è¾“å‡ºç¤ºä¾‹è§£è¯»
$ jstat -gc 12345
 S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT
512.0  512.0   0.0   48.0  8192.0   7024.0   16384.0    3072.0  21248.0 20000.0 2560.0 2304.0    95    0.750     3    0.090    0.840

# å­—æ®µå«ä¹‰ï¼š
# S0C/S1C: SurvivoråŒºå®¹é‡  S0U/S1U: SurvivoråŒºä½¿ç”¨é‡
# EC: EdenåŒºå®¹é‡          EU: EdenåŒºä½¿ç”¨é‡  
# OC: è€å¹´ä»£å®¹é‡          OU: è€å¹´ä»£ä½¿ç”¨é‡
# YGC: Minor GCæ¬¡æ•°       YGCT: Minor GCæ€»æ—¶é—´
# FGC: Full GCæ¬¡æ•°        FGCT: Full GCæ€»æ—¶é—´
```

**â„¹ï¸ jinfo - Javaé…ç½®ä¿¡æ¯**
```bash
# æŸ¥çœ‹JVMå‚æ•°
jinfo <pid>                          # æ˜¾ç¤ºæ‰€æœ‰å‚æ•°
jinfo -flags <pid>                   # æ˜¾ç¤ºå‘½ä»¤è¡Œå‚æ•°
jinfo -sysprops <pid>                # æ˜¾ç¤ºç³»ç»Ÿå±æ€§

# åŠ¨æ€ä¿®æ”¹å‚æ•°ï¼ˆéƒ¨åˆ†å‚æ•°æ”¯æŒï¼‰
jinfo -flag +PrintGC <pid>           # å¯ç”¨PrintGC
jinfo -flag -PrintGC <pid>           # ç¦ç”¨PrintGC
jinfo -flag PrintGCDetails <pid>     # æŸ¥çœ‹PrintGCDetailsçŠ¶æ€

# å®ç”¨ç¤ºä¾‹
jinfo -flag UseG1GC 12345            # æ£€æŸ¥æ˜¯å¦ä½¿ç”¨G1GC
jinfo -flag MaxHeapSize 12345        # æŸ¥çœ‹æœ€å¤§å †å¤§å°
```

**ğŸ—ºï¸ jmap - å†…å­˜æ˜ åƒå·¥å…·**
```bash
# ç”Ÿæˆå †è½¬å‚¨æ–‡ä»¶
jmap -dump:format=b,file=heap.hprof <pid>    # ç”ŸæˆäºŒè¿›åˆ¶heap dump
jmap -dump:live,format=b,file=heap.hprof <pid> # åªè½¬å‚¨å­˜æ´»å¯¹è±¡

# æŸ¥çœ‹å †ä¿¡æ¯
jmap -heap <pid>                     # æ˜¾ç¤ºå †é…ç½®å’Œä½¿ç”¨æƒ…å†µ
jmap -histo <pid>                    # æ˜¾ç¤ºå¯¹è±¡ç»Ÿè®¡ä¿¡æ¯
jmap -histo:live <pid>               # åªç»Ÿè®¡å­˜æ´»å¯¹è±¡

# æŸ¥çœ‹ç±»åŠ è½½å™¨ä¿¡æ¯
jmap -clstats <pid>                  # æ˜¾ç¤ºç±»åŠ è½½å™¨ç»Ÿè®¡

# å®é™…ä½¿ç”¨ç¤ºä¾‹
$ jmap -histo:live 12345 | head -20
 num     #instances         #bytes  class name
----------------------------------------------
   1:         12847        2051024  [C
   2:         12847         308328  java.lang.String
   3:          4414         385632  java.lang.reflect.Method
   4:          6549         209568  java.util.HashMap$Node
```

**ğŸ“š jstack - Javaå †æ ˆè·Ÿè¸ªå·¥å…·**
```bash
# ç”Ÿæˆçº¿ç¨‹å †æ ˆ
jstack <pid>                         # æ˜¾ç¤ºæ‰€æœ‰çº¿ç¨‹å †æ ˆ
jstack -l <pid>                      # æ˜¾ç¤ºé”ä¿¡æ¯
jstack -m <pid>                      # æ˜¾ç¤ºnativeå †æ ˆ

# æ­»é”æ£€æµ‹
jstack <pid> | grep -A 5 -B 5 "deadlock" # æŸ¥æ‰¾æ­»é”ä¿¡æ¯

# å®é™…ä½¿ç”¨åœºæ™¯
jstack 12345 > thread_dump.txt       # ä¿å­˜å †æ ˆä¿¡æ¯åˆ°æ–‡ä»¶

# çº¿ç¨‹çŠ¶æ€åˆ†æ
grep "java.lang.Thread.State" thread_dump.txt | sort | uniq -c
#   45 java.lang.Thread.State: RUNNABLE
#   12 java.lang.Thread.State: WAITING
#    3 java.lang.Thread.State: TIMED_WAITING
```

### 2.2 å¯è§†åŒ–å·¥å…·ï¼šJConsoleã€VisualVMã€JProfiler


**ğŸ–¥ï¸ JConsole - å†…ç½®ç›‘æ§å·¥å…·**
```bash
# å¯åŠ¨JConsole
jconsole                             # å›¾å½¢ç•Œé¢é€‰æ‹©è¿›ç¨‹
jconsole <pid>                       # ç›´æ¥è¿æ¥æŒ‡å®šè¿›ç¨‹
jconsole <hostname>:<port>           # è¿æ¥è¿œç¨‹JMX

# è¿œç¨‹ç›‘æ§é…ç½®
java -Dcom.sun.management.jmxremote \
     -Dcom.sun.management.jmxremote.port=9999 \
     -Dcom.sun.management.jmxremote.authenticate=false \
     -Dcom.sun.management.jmxremote.ssl=false \
     -jar myapp.jar

# JConsoleåŠŸèƒ½ï¼š
# âœ… å†…å­˜ä½¿ç”¨ç›‘æ§ï¼šå †ã€éå †å†…å­˜å®æ—¶å›¾è¡¨
# âœ… çº¿ç¨‹ç›‘æ§ï¼šçº¿ç¨‹æ•°é‡ã€çŠ¶æ€ã€æ­»é”æ£€æµ‹
# âœ… ç±»åŠ è½½ç›‘æ§ï¼šå·²åŠ è½½ç±»æ•°é‡å˜åŒ–
# âœ… GCç›‘æ§ï¼šGCæ¬¡æ•°ã€æ—¶é—´ç»Ÿè®¡
# âœ… MBeanç®¡ç†ï¼šç³»ç»Ÿå±æ€§ã€é…ç½®ä¿®æ”¹
```

**ğŸ‘ï¸ VisualVM - å¤šåˆä¸€æ€§èƒ½å·¥å…·**
```bash
# å¯åŠ¨VisualVM
jvisualvm                            # å¯åŠ¨å›¾å½¢ç•Œé¢

# ä¸»è¦åŠŸèƒ½ï¼š
# ğŸ” CPUæ€§èƒ½åˆ†æï¼šæ–¹æ³•è°ƒç”¨çƒ­ç‚¹ã€è°ƒç”¨æ ‘
# ğŸ’¾ å†…å­˜åˆ†æï¼šå¯¹è±¡ç»Ÿè®¡ã€å†…å­˜æ³„æ¼æ£€æµ‹
# ğŸ§µ çº¿ç¨‹åˆ†æï¼šçº¿ç¨‹çŠ¶æ€ã€åŒæ­¥é—®é¢˜
# ğŸ”„ GCåˆ†æï¼šGCæ€§èƒ½ã€æš‚åœæ—¶é—´åˆ†æ
# ğŸ“Š æ’ä»¶æ‰©å±•ï¼šMBeansã€JConsoleæ’ä»¶ç­‰

# å‘½ä»¤è¡Œç”Ÿæˆæ€§èƒ½å¿«ç…§
jvisualvm --jdkhome $JAVA_HOME \
          --userdir /tmp/visualvm \
          --snapshot /path/to/snapshot.nps
```

**âš¡ JProfiler - å•†ä¸šæ€§èƒ½åˆ†æå·¥å…·**
```java
// JProfileré›†æˆç¤ºä¾‹
public class JProfilerExample {
    public static void main(String[] args) {
        // JProfilerå¯åŠ¨å‚æ•°
        // -agentpath:/path/to/jprofiler/bin/linux-x64/libjprofilerti.so=port=8849
        
        // æ€§èƒ½åˆ†æä»£ç 
        for (int i = 0; i < 1000000; i++) {
            processData(i);
        }
    }
    
    static void processData(int data) {
        // æ¨¡æ‹Ÿä¸šåŠ¡é€»è¾‘
        List<String> list = new ArrayList<>();
        for (int i = 0; i < 100; i++) {
            list.add("data_" + data + "_" + i);
        }
    }
}

// JProfileråŠŸèƒ½ç‰¹ç‚¹ï¼š
// âœ… CPUçƒ­ç‚¹åˆ†æï¼šæ–¹æ³•çº§æ€§èƒ½ç»Ÿè®¡
// âœ… å†…å­˜åˆ†æï¼šå¯¹è±¡åˆ†é…ã€GCåˆ†æ
// âœ… çº¿ç¨‹åˆ†æï¼šå¹¶å‘é—®é¢˜ã€é”ç«äº‰
// âœ… æ•°æ®åº“åˆ†æï¼šJDBCè°ƒç”¨æ€§èƒ½
// âœ… å®æ—¶ç›‘æ§ï¼šç”Ÿäº§ç¯å¢ƒæ€§èƒ½ç›‘æ§
```

### 2.3 ç¬¬ä¸‰æ–¹å·¥å…·ï¼šMATï¼ˆMemory Analyzer Toolï¼‰ã€Arthas


**ğŸ”¬ MAT - å†…å­˜åˆ†æå·¥å…·**
```bash
# MATä¸»è¦åŠŸèƒ½
# ğŸ“Š Heap Dumpåˆ†æï¼šå†…å­˜ä½¿ç”¨è¯¦æƒ…
# ğŸ” å†…å­˜æ³„æ¼æ£€æµ‹ï¼šè‡ªåŠ¨æ£€æµ‹æ³„æ¼å«Œç–‘
# ğŸ“ˆ å¯¹è±¡å¼•ç”¨åˆ†æï¼šGC Rootè·¯å¾„åˆ†æ  
# ğŸ¯ å¤§å¯¹è±¡æŸ¥æ‰¾ï¼šå ç”¨å†…å­˜æœ€å¤šçš„å¯¹è±¡
# ğŸ“‹ ç±»åŠ è½½å™¨åˆ†æï¼šç±»åŠ è½½æƒ…å†µç»Ÿè®¡

# MATåˆ†ææ­¥éª¤
# 1. ç”Ÿæˆheap dump
jmap -dump:live,format=b,file=heap.hprof <pid>

# 2. ç”¨MATæ‰“å¼€heap.hprofæ–‡ä»¶
# 3. è¿è¡Œå†…å­˜æ³„æ¼æ£€æµ‹æŠ¥å‘Š
# 4. åˆ†ææ”¯é…æ ‘ï¼ˆDominator Treeï¼‰
# 5. æŸ¥çœ‹ç›´æ–¹å›¾ï¼ˆHistogramï¼‰
# 6. åˆ†æGC Roots

# MATå‘½ä»¤è¡Œåˆ†æ
java -jar org.eclipse.mat.parser.jar -application org.eclipse.mat.api.parse \
     heap.hprof org.eclipse.mat.api:suspects
```

**ğŸ¯ Arthas - é˜¿é‡Œå¼€æºè¯Šæ–­å·¥å…·**
```bash
# å®‰è£…å’Œå¯åŠ¨Arthas
curl -O https://arthas.aliyun.com/arthas-boot.jar
java -jar arthas-boot.jar           # é€‰æ‹©è¦è¯Šæ–­çš„Javaè¿›ç¨‹

# å¸¸ç”¨å‘½ä»¤
dashboard                            # å®æ—¶æ•°æ®é¢æ¿
thread                              # æŸ¥çœ‹çº¿ç¨‹ä¿¡æ¯
thread -b                           # æŸ¥æ‰¾é˜»å¡çº¿ç¨‹
thread <tid>                        # æŸ¥çœ‹æŒ‡å®šçº¿ç¨‹å †æ ˆ

# æ€§èƒ½ç›‘æ§
monitor -c 5 com.example.Service method  # ç›‘æ§æ–¹æ³•è°ƒç”¨
trace com.example.Service method     # è¿½è¸ªæ–¹æ³•è°ƒç”¨è·¯å¾„
stack com.example.Service method     # æŸ¥çœ‹æ–¹æ³•è°ƒç”¨å †æ ˆ

# å†…å­˜åˆ†æ
memory                              # æŸ¥çœ‹å†…å­˜ä½¿ç”¨æƒ…å†µ
heapdump /tmp/dump.hprof            # ç”Ÿæˆheap dump
gc                                  # è§¦å‘GC

# ç±»å’Œæ–¹æ³•åˆ†æ
sc com.example.*                    # æŸ¥æ‰¾ç±»
sm com.example.Service              # æŸ¥çœ‹æ–¹æ³•
jad com.example.Service             # åç¼–è¯‘ç±»

# çƒ­æ›´æ–°ä»£ç 
redefine /path/to/new/Service.class # çƒ­æ›´æ–°ç±»
```

### 2.4 GCæ—¥å¿—åˆ†æï¼šæ—¥å¿—æ ¼å¼è§£è¯»ã€å…³é”®æŒ‡æ ‡è¯†åˆ«


**ğŸ“„ GCæ—¥å¿—æ ¼å¼è§£è¯»**
```bash
# G1 GCæ—¥å¿—ç¤ºä¾‹
2024-01-27T10:15:30.123+0800: [GC pause (G1 Evacuation Pause) (young)
 [Parallel Time: 25.3 ms, GC Workers: 4]
    [GC Worker Start (ms): Min: 0.0, Avg: 0.1, Max: 0.2, Diff: 0.2]
    [Eden: 1024.0M(1024.0M)->0.0B(768.0M) Survivors: 128.0M->384.0M Heap: 2048.0M(4096.0M)->1152.0M(4096.0M)]
 [Times: user=0.08 sys=0.02, real=0.03 secs]

# æ—¥å¿—å­—æ®µè§£æï¼š
# æ—¶é—´æˆ³: 2024-01-27T10:15:30.123+0800
# GCç±»å‹: G1 Evacuation Pause (young) - å¹´è½»ä»£å›æ”¶
# å¹¶è¡Œæ—¶é—´: 25.3ms
# GCå·¥ä½œçº¿ç¨‹: 4ä¸ª
# EdenåŒº: 1024M -> 0B (å®¹é‡è°ƒæ•´ä¸º768M)
# Survivors: 128M -> 384M  
# å †ä½¿ç”¨: 2048M -> 1152M (æ€»å®¹é‡4096M)
# CPUæ—¶é—´: user=0.08s sys=0.02s real=0.03s
```

**ğŸ“Š å…³é”®GCæŒ‡æ ‡åˆ†æ**
```java
// GCåˆ†æå·¥å…·ç±»
public class GCLogAnalyzer {
    
    // å…³é”®æŒ‡æ ‡è®¡ç®—
    public void analyzeGCMetrics() {
        // 1. ååé‡ = åº”ç”¨è¿è¡Œæ—¶é—´ / æ€»è¿è¡Œæ—¶é—´
        double throughput = calculateThroughput();
        
        // 2. å¹³å‡GCæš‚åœæ—¶é—´
        double avgPauseTime = calculateAveragePauseTime();
        
        // 3. GCé¢‘ç‡ = GCæ¬¡æ•° / æ—¶é—´æ®µ
        double gcFrequency = calculateGCFrequency();
        
        // 4. å†…å­˜å›æ”¶æ•ˆç‡ = å›æ”¶å†…å­˜é‡ / GCæ—¶é—´
        double efficiency = calculateRecyclingEfficiency();
        
        System.out.println("ååé‡: " + throughput + "%");
        System.out.println("å¹³å‡æš‚åœæ—¶é—´: " + avgPauseTime + "ms");
        System.out.println("GCé¢‘ç‡: " + gcFrequency + " æ¬¡/åˆ†é’Ÿ");
        System.out.println("å›æ”¶æ•ˆç‡: " + efficiency + " MB/ms");
    }
    
    // ç¤ºä¾‹ï¼šä»GCæ—¥å¿—æå–å…³é”®æ•°æ®
    public void parseGCLog(String logLine) {
        // è§£ææ—¶é—´æˆ³
        // è§£æGCç±»å‹
        // è§£æå†…å­˜å˜åŒ–
        // è§£ææš‚åœæ—¶é—´
        // ç»Ÿè®¡åˆ†ææŒ‡æ ‡
    }
}

// GCæ€§èƒ½è¯„ä¼°æ ‡å‡†ï¼š
// âœ… ååé‡ > 95%ï¼šåº”ç”¨è¿è¡Œæ—¶é—´å æ¯”
// âœ… å¹³å‡æš‚åœ < 100msï¼šç”¨æˆ·ä½“éªŒå¯æ¥å—  
// âœ… æœ€å¤§æš‚åœ < 500msï¼šé¿å…æ˜æ˜¾å¡é¡¿
// âœ… GCé¢‘ç‡é€‚ä¸­ï¼šä¸è¿‡äºé¢‘ç¹æˆ–ç¨€å°‘
```

### 2.5 å·¥å…·çš„ä½¿ç”¨åœºæ™¯å’Œé€‰æ‹©ç­–ç•¥


**ğŸ¯ å·¥å…·é€‰æ‹©å†³ç­–çŸ©é˜µ**

| ä½¿ç”¨åœºæ™¯ | **æ¨èå·¥å…·** | **å·¥å…·ç‰¹ç‚¹** | **é€‚ç”¨æ¡ä»¶** |
|---------|-------------|-------------|-------------|
| ğŸ” **å¿«é€Ÿé—®é¢˜å®šä½** | `jps + jstat + jstack` | `è½»é‡çº§å‘½ä»¤è¡Œå·¥å…·` | `ç”Ÿäº§ç¯å¢ƒï¼Œè¿œç¨‹è¯Šæ–­` |
| ğŸ“Š **å®æ—¶æ€§èƒ½ç›‘æ§** | `JConsole + VisualVM` | `å›¾å½¢åŒ–å®æ—¶ç›‘æ§` | `æµ‹è¯•ç¯å¢ƒï¼Œæœ¬åœ°å¼€å‘` |
| ğŸ§  **å†…å­˜æ³„æ¼åˆ†æ** | `jmap + MAT` | `æ·±åº¦å†…å­˜åˆ†æ` | `ç¦»çº¿åˆ†æï¼Œdumpæ–‡ä»¶` |
| âš¡ **çƒ­ç‚¹æ–¹æ³•åˆ†æ** | `JProfiler + Arthas` | `æ–¹æ³•çº§æ€§èƒ½åˆ†æ` | `æ€§èƒ½è°ƒä¼˜ï¼Œä»£ç ä¼˜åŒ–` |
| ğŸš¨ **ç”Ÿäº§é—®é¢˜æ’æŸ¥** | `Arthas + GCæ—¥å¿—` | `æ— ä¾µå…¥åœ¨çº¿è¯Šæ–­` | `çº¿ä¸Šç¯å¢ƒï¼Œç´§æ€¥é—®é¢˜` |

**ğŸ”§ å·¥å…·ç»„åˆä½¿ç”¨ç­–ç•¥**
```bash
# å®Œæ•´çš„æ€§èƒ½åˆ†ææµç¨‹

# 1. å¿«é€Ÿå®šä½é—®é¢˜ï¼ˆ5åˆ†é’Ÿå†…ï¼‰
jps -l | grep MyApp                  # æ‰¾åˆ°è¿›ç¨‹ID
jstat -gc <pid> 1s 10               # è§‚å¯ŸGCæƒ…å†µ
jstack <pid> > thread.dump          # è·å–çº¿ç¨‹å¿«ç…§

# 2. æ·±å…¥åˆ†æé—®é¢˜ï¼ˆ30åˆ†é’Ÿå†…ï¼‰
jmap -dump:live,format=b,file=heap.hprof <pid>  # ç”Ÿæˆå†…å­˜å¿«ç…§
# ç”¨MATåˆ†æheap.hprofæ–‡ä»¶

# 3. æŒç»­ç›‘æ§ä¼˜åŒ–ï¼ˆé•¿æœŸï¼‰
# å¯ç”¨è¯¦ç»†GCæ—¥å¿—
# ä½¿ç”¨APMå·¥å…·ç›‘æ§
# å®šæœŸæ€§èƒ½æµ‹è¯•

# ç´§æ€¥é—®é¢˜æ’æŸ¥è„šæœ¬
#!/bin/bash
PID=$(jps -l | grep $1 | awk '{print $1}')
echo "åˆ†æè¿›ç¨‹: $PID"

echo "=== åŸºæœ¬ä¿¡æ¯ ==="
jinfo -flags $PID

echo "=== GCçŠ¶å†µ ==="  
jstat -gc $PID

echo "=== çº¿ç¨‹çŠ¶æ€ ==="
jstack $PID | grep "java.lang.Thread.State" | sort | uniq -c

echo "=== å†…å­˜ä½¿ç”¨TOP10 ==="
jmap -histo $PID | head -20
```

---

## 3. ğŸ”§ å†…å­˜é—®é¢˜æ’æŸ¥ä¸è°ƒä¼˜


### 3.1 å¸¸è§å†…å­˜å¼‚å¸¸ï¼šOutOfMemoryErrorçš„å„ç§ç±»å‹


**ğŸš¨ OutOfMemoryErrorç±»å‹è¯¦è§£**

| OOMç±»å‹ | **é”™è¯¯ä¿¡æ¯** | **åŸå› ** | **è§£å†³æ–¹æ¡ˆ** |
|---------|-------------|---------|-------------|
| ğŸ”´ **Java heap space** | `OutOfMemoryError: Java heap space` | `å †å†…å­˜ä¸è¶³` | `å¢å¤§-Xmxï¼Œæ£€æŸ¥å†…å­˜æ³„æ¼` |
| ğŸ”´ **Metaspace** | `OutOfMemoryError: Metaspace` | `å…ƒç©ºé—´ä¸è¶³` | `å¢å¤§-XX:MaxMetaspaceSize` |
| ğŸ”´ **Direct buffer memory** | `OutOfMemoryError: Direct buffer memory` | `ç›´æ¥å†…å­˜ä¸è¶³` | `å¢å¤§-XX:MaxDirectMemorySize` |
| ğŸ”´ **unable to create native thread** | `OutOfMemoryError: unable to create new native thread` | `æ— æ³•åˆ›å»ºçº¿ç¨‹` | `å‡å°‘çº¿ç¨‹æ•°ï¼Œå¢åŠ ç³»ç»Ÿé™åˆ¶` |
| ğŸ”´ **GC overhead limit** | `OutOfMemoryError: GC overhead limit exceeded` | `GCæ—¶é—´è¿‡é•¿` | `ä¼˜åŒ–GCç­–ç•¥ï¼Œå¢å¤§å †å†…å­˜` |

**ğŸ’¥ Java heap spaceç¤ºä¾‹**
```java
// å †å†…å­˜æº¢å‡ºç¤ºä¾‹
public class HeapOOMExample {
    static class OOMObject {}
    
    public static void main(String[] args) {
        List<OOMObject> list = new ArrayList<>();
        
        while (true) {
            list.add(new OOMObject());  // ä¸æ–­åˆ›å»ºå¯¹è±¡
            // æœ€ç»ˆå¯¼è‡´ï¼šjava.lang.OutOfMemoryError: Java heap space
        }
    }
}

// æ’æŸ¥æ­¥éª¤ï¼š
// 1. jstat -gc <pid> è§‚å¯Ÿå †ä½¿ç”¨æƒ…å†µ
// 2. jmap -histo <pid> æŸ¥çœ‹å¯¹è±¡åˆ†å¸ƒ
// 3. jmap -dumpç”Ÿæˆheap dump
// 4. MATåˆ†æå†…å­˜æ³„æ¼
```

**ğŸ’¾ Metaspaceæº¢å‡ºç¤ºä¾‹**
```java
// å…ƒç©ºé—´æº¢å‡ºç¤ºä¾‹
public class MetaspaceOOMExample {
    public static void main(String[] args) throws Exception {
        // è®¾ç½®å°çš„å…ƒç©ºé—´ï¼š-XX:MaxMetaspaceSize=50m
        
        while (true) {
            // åŠ¨æ€ç”Ÿæˆç±»ï¼Œå ç”¨å…ƒç©ºé—´
            Enhancer enhancer = new Enhancer();
            enhancer.setSuperclass(Object.class);
            enhancer.setUseCache(false);  // ä¸ä½¿ç”¨ç¼“å­˜
            enhancer.setCallback(NoOp.INSTANCE);
            enhancer.create();
            // æœ€ç»ˆå¯¼è‡´ï¼šjava.lang.OutOfMemoryError: Metaspace
        }
    }
}
```

**ğŸ§µ çº¿ç¨‹åˆ›å»ºæº¢å‡ºç¤ºä¾‹**
```java
// æ— æ³•åˆ›å»ºçº¿ç¨‹ç¤ºä¾‹
public class ThreadOOMExample {
    public static void main(String[] args) {
        while (true) {
            new Thread(() -> {
                try {
                    Thread.sleep(Long.MAX_VALUE);  // çº¿ç¨‹é•¿æœŸå­˜æ´»
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                }
            }).start();
            // æœ€ç»ˆå¯¼è‡´ï¼šunable to create new native thread
        }
    }
}

// è§£å†³æ–¹æ³•ï¼š
// 1. å¢åŠ ç³»ç»Ÿçº¿ç¨‹é™åˆ¶ï¼šulimit -u 4096
// 2. å‡å°‘çº¿ç¨‹æ ˆå¤§å°ï¼š-Xss256k
// 3. ä½¿ç”¨çº¿ç¨‹æ± ç®¡ç†çº¿ç¨‹
// 4. æ£€æŸ¥çº¿ç¨‹æ³„æ¼é—®é¢˜
```

### 3.2 å†…å­˜æ³„æ¼ vs å†…å­˜æº¢å‡ºï¼šæ¦‚å¿µåŒºåˆ«å’Œæ’æŸ¥æ–¹æ³•


**ğŸ” æ¦‚å¿µåŒºåˆ«å¯¹æ¯”**

| é—®é¢˜ç±»å‹ | **å®šä¹‰** | **è¡¨ç°** | **æ ¹æœ¬åŸå› ** |
|---------|---------|---------|-------------|
| ğŸ’§ **å†…å­˜æ³„æ¼** | `åº”è¯¥è¢«å›æ”¶çš„å¯¹è±¡æ— æ³•å›æ”¶` | `å†…å­˜ä½¿ç”¨æŒç»­å¢é•¿` | `å¯¹è±¡å¼•ç”¨æœªæ­£ç¡®é‡Šæ”¾` |
| ğŸ’¥ **å†…å­˜æº¢å‡º** | `å†…å­˜éœ€æ±‚è¶…è¿‡å¯ç”¨å†…å­˜` | `OutOfMemoryErrorå¼‚å¸¸` | `å¯¹è±¡è¿‡å¤šæˆ–å†…å­˜è®¾ç½®ä¸å½“` |

**ğŸ’§ å†…å­˜æ³„æ¼æ’æŸ¥ç¤ºä¾‹**
```java
// å…¸å‹å†…å­˜æ³„æ¼åœºæ™¯
public class MemoryLeakExample {
    private static List<Object> cache = new ArrayList<>();
    private Map<String, Object> listeners = new HashMap<>();
    
    // 1. é™æ€é›†åˆæŒæœ‰å¯¹è±¡å¼•ç”¨
    public void addToCache(Object obj) {
        cache.add(obj);  // å¯¹è±¡æ°¸è¿œä¸ä¼šè¢«ç§»é™¤
    }
    
    // 2. ç›‘å¬å™¨æœªæ³¨é”€
    public void addListener(String key, Object listener) {
        listeners.put(key, listener);  // ç›‘å¬å™¨ç´¯ç§¯
    }
    
    // 3. å†…éƒ¨ç±»æŒæœ‰å¤–éƒ¨ç±»å¼•ç”¨
    public class InnerClass {
        public void doSomething() {
            // å†…éƒ¨ç±»æŒæœ‰MemoryLeakExample.thiså¼•ç”¨
            // å¦‚æœInnerClasså®ä¾‹è¢«é•¿æœŸæŒæœ‰ï¼Œå¤–éƒ¨ç±»æ— æ³•å›æ”¶
        }
    }
    
    // 4. ThreadLocalæœªæ¸…ç†
    private static ThreadLocal<Object> threadLocal = new ThreadLocal<>();
    
    public void setThreadLocalValue(Object value) {
        threadLocal.set(value);  // çº¿ç¨‹ç»“æŸå‰æœªremove()
    }
}

// å†…å­˜æ³„æ¼æ’æŸ¥æ–¹æ³•ï¼š
// âœ… å¯¹æ¯”å¤šä¸ªæ—¶é—´ç‚¹çš„heap dump
// âœ… åˆ†æå¯¹è±¡å¢é•¿è¶‹åŠ¿
// âœ… æŸ¥æ‰¾GC Rootå¼•ç”¨é“¾
// âœ… æ£€æŸ¥å®¹å™¨å’Œç¼“å­˜çš„å¤§å°å˜åŒ–
```

**ğŸ”§ å†…å­˜æ³„æ¼æ£€æµ‹å·¥å…·**
```bash
# MATå†…å­˜æ³„æ¼æ£€æµ‹æ­¥éª¤

# 1. ç”Ÿæˆä¸¤ä¸ªæ—¶é—´ç‚¹çš„heap dump
jmap -dump:live,format=b,file=heap1.hprof <pid>
# ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œæ‰§è¡Œä¸šåŠ¡æ“ä½œ
jmap -dump:live,format=b,file=heap2.hprof <pid>

# 2. MATå¯¹æ¯”åˆ†æ
# File -> Open Snapshot -> é€‰æ‹©heap1.hprof
# File -> Open Snapshot -> é€‰æ‹©heap2.hprof  
# å³é”®heap2.hprof -> Compare To -> é€‰æ‹©heap1.hprof

# 3. åˆ†æå¢é•¿çš„å¯¹è±¡
# æŸ¥çœ‹Histogramå¯¹æ¯”
# åˆ†æå¢é•¿æœ€å¤šçš„ç±»
# è¿½è¸ªGC Rootå¼•ç”¨è·¯å¾„

# 4. Eclipse MATå‘½ä»¤è¡Œåˆ†æ
./ParseHeapDump.sh heap.hprof org.eclipse.mat.api:suspects
./ParseHeapDump.sh heap.hprof org.eclipse.mat.api:overview
```

### 3.3 Heap Dumpåˆ†æï¼šç”Ÿæˆã€åˆ†æã€å®šä½é—®é¢˜å¯¹è±¡


**ğŸ“Š Heap Dumpç”Ÿæˆæ–¹æ³•**
```bash
# æ–¹æ³•1ï¼šjmapç”Ÿæˆï¼ˆæ¨èï¼‰
jmap -dump:live,format=b,file=heap.hprof <pid>

# æ–¹æ³•2ï¼šJVMå‚æ•°è‡ªåŠ¨ç”Ÿæˆ
-XX:+HeapDumpOnOutOfMemoryError
-XX:HeapDumpPath=/var/log/heapdump/

# æ–¹æ³•3ï¼šjcmdç”Ÿæˆ
jcmd <pid> GC.run_finalization
jcmd <pid> VM.dump heap.hprof

# æ–¹æ³•4ï¼šç¨‹åºå†…ç”Ÿæˆ
public class HeapDumpGenerator {
    public static void generateHeapDump() {
        try {
            MBeanServer server = ManagementFactory.getPlatformMBeanServer();
            HotSpotDiagnosticMXBean mxBean = ManagementFactory.newPlatformMXBeanProxy(
                server, "com.sun.management:type=HotSpotDiagnostic", HotSpotDiagnosticMXBean.class);
            mxBean.dumpHeap("/tmp/heap.hprof", true);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

**ğŸ”¬ MATæ·±åº¦åˆ†ææµç¨‹**
```bash
# MATåˆ†ææ­¥éª¤è¯¦è§£

# 1. æ‰“å¼€Heap Dump
# File -> Open Heap Dump -> é€‰æ‹©.hprofæ–‡ä»¶

# 2. æ¦‚è§ˆåˆ†æ
# Overview -> Details -> æŸ¥çœ‹åŸºæœ¬ä¿¡æ¯
# - å †å¤§å°ã€å¯¹è±¡æ•°é‡ã€ç±»æ•°é‡
# - æ”¶é›†æ—¶é—´ã€JVMç‰ˆæœ¬

# 3. å†…å­˜æ³„æ¼æ£€æµ‹
# Leak Suspects Report -> è‡ªåŠ¨æ£€æµ‹å¯ç–‘å†…å­˜æ³„æ¼
# - æ”¯é…å¯¹è±¡åˆ†æ
# - å¤§å¯¹è±¡è¯†åˆ«
# - é‡å¤å¯¹è±¡æ£€æµ‹

# 4. å¯¹è±¡ç»Ÿè®¡åˆ†æ
# Histogram -> æŒ‰ç±»ç»Ÿè®¡å¯¹è±¡
# - Objects: å®ä¾‹æ•°é‡
# - Shallow Heap: å¯¹è±¡è‡ªèº«å¤§å°
# - Retained Heap: å¯¹è±¡ä¿æŒçš„å†…å­˜å¤§å°

# 5. æ”¯é…æ ‘åˆ†æ
# Dominator Tree -> æŒ‰å†…å­˜å ç”¨æ’åº
# - æ‰¾åˆ°å ç”¨å†…å­˜æœ€å¤šçš„å¯¹è±¡
# - åˆ†æå¯¹è±¡å¼•ç”¨å…³ç³»

# 6. GC Rootåˆ†æ
# å³é”®å¯¹è±¡ -> Path to GC Roots
# - æŸ¥çœ‹å¯¹è±¡ä¸ºä»€ä¹ˆæ— æ³•å›æ”¶
# - åˆ†æå¼•ç”¨é“¾è·¯å¾„
```

**ğŸ’» MATåˆ†æå®æˆ˜ç¤ºä¾‹**
```java
// é—®é¢˜ä»£ç ï¼šå¤§é‡Stringå¯¹è±¡
public class StringLeakExample {
    private static Set<String> stringCache = new HashSet<>();
    
    public static void main(String[] args) {
        // æ¨¡æ‹Ÿä¸šåŠ¡é€»è¾‘ï¼Œäº§ç”Ÿå¤§é‡ä¸åŒçš„å­—ç¬¦ä¸²
        for (int i = 0; i < 1000000; i++) {
            String data = "business_data_" + i + "_" + System.currentTimeMillis();
            stringCache.add(data);  // å­—ç¬¦ä¸²æ°¸è¿œä¸è¢«æ¸…ç†
            
            if (i % 10000 == 0) {
                System.out.println("Generated " + i + " strings");
            }
        }
    }
}

// MATåˆ†æç»“æœï¼š
// 1. Histogramæ˜¾ç¤ºStringå¯¹è±¡å ç”¨æœ€å¤šå†…å­˜
// 2. Dominator Treeä¸­stringCacheå ä¸»å¯¼åœ°ä½
// 3. GC Rootè·¯å¾„ï¼šstatic field -> HashSet -> String[]
// 4. è§£å†³æ–¹æ¡ˆï¼šå®šæœŸæ¸…ç†cacheï¼Œä½¿ç”¨WeakHashMapï¼Œé™åˆ¶cacheå¤§å°
```

### 3.4 å†…å­˜è°ƒä¼˜ç­–ç•¥ï¼šå †å¤§å°è®¾ç½®ã€GCç­–ç•¥é€‰æ‹©


**ğŸ“ å †å¤§å°è®¾ç½®ç­–ç•¥**
```bash
# å †å¤§å°è®¾ç½®åŸåˆ™

# 1. åŸºç¡€è®¡ç®—å…¬å¼
# å †å¤§å° = æ´»è·ƒæ•°æ®å¤§å° Ã— (1 + æ•°æ®å¢é•¿ç‡) Ã— å®‰å…¨ç³»æ•°
# å®‰å…¨ç³»æ•°é€šå¸¸ä¸º3-4å€

# 2. ä¸åŒåº”ç”¨åœºæ™¯çš„è®¾ç½®

# Webåº”ç”¨ï¼ˆ8GBç‰©ç†å†…å­˜ï¼‰
-Xms4g -Xmx4g -Xmn1536m
# ç†ç”±ï¼šç•™4GBç»™OSå’Œå…¶ä»–è¿›ç¨‹ï¼Œæ–°ç”Ÿä»£å 38%

# æ‰¹å¤„ç†åº”ç”¨ï¼ˆ16GBç‰©ç†å†…å­˜ï¼‰  
-Xms8g -Xmx12g -Xmn3g
# ç†ç”±ï¼šå¯ä»¥ä½¿ç”¨æ›´å¤šå†…å­˜ï¼Œå‡å°‘GCé¢‘ç‡

# å¾®æœåŠ¡ï¼ˆå®¹å™¨2GBé™åˆ¶ï¼‰
-Xms1g -Xmx1536m -Xmn512m  
# ç†ç”±ï¼šå®¹å™¨ç¯å¢ƒè¦é¢„ç•™å†…å­˜ç»™JVMè‡ªèº«

# 3. éªŒè¯å’Œè°ƒæ•´
jstat -gc <pid> 5s           # è§‚å¯Ÿå†…å­˜ä½¿ç”¨æ¨¡å¼
# å¦‚æœè€å¹´ä»£ä½¿ç”¨ç‡æŒç»­ä¸Šå‡ -> å¢å¤§å †
# å¦‚æœMinor GCè¿‡äºé¢‘ç¹ -> å¢å¤§æ–°ç”Ÿä»£
# å¦‚æœFull GCé¢‘ç¹ -> æ£€æŸ¥å†…å­˜æ³„æ¼æˆ–å¢å¤§å †
```

**âš™ï¸ GCç­–ç•¥é€‰æ‹©çŸ©é˜µ**

| åº”ç”¨ç‰¹ç‚¹ | **æ¨èGC** | **å…³é”®å‚æ•°** | **è°ƒä¼˜é‡ç‚¹** |
|---------|-----------|-------------|-------------|
| ğŸŒ **Webåº”ç”¨** | `G1 GC` | `MaxGCPauseMillis=200` | `å“åº”æ—¶é—´ä¼˜å…ˆ` |
| ğŸ“Š **æ‰¹å¤„ç†** | `Parallel GC` | `GCTimeRatio=99` | `ååé‡ä¼˜å…ˆ` |
| âš¡ **å®æ—¶ç³»ç»Ÿ** | `ZGC/Shenandoah` | `æœ€ä½å»¶è¿Ÿé…ç½®` | `å»¶è¿Ÿä¼˜å…ˆ` |
| ğŸ’¾ **å¤§å †åº”ç”¨** | `G1/ZGC` | `å¤§Regionè®¾ç½®` | `ç®¡ç†å¤§å†…å­˜` |
| ğŸ”¬ **ç§‘å­¦è®¡ç®—** | `Parallel GC` | `å¤§å †+é•¿æ—¶é—´è¿è¡Œ` | `ååé‡æœ€å¤§åŒ–` |

**ğŸ¯ GCè°ƒä¼˜å®æˆ˜æ¡ˆä¾‹**
```java
// Webåº”ç”¨GCè°ƒä¼˜æ¡ˆä¾‹
public class WebAppGCTuning {
    
    // è°ƒä¼˜å‰é…ç½®ï¼š
    // -Xms2g -Xmx2g -XX:+UseParallelGC
    // é—®é¢˜ï¼šGCæš‚åœæ—¶é—´è¿‡é•¿ï¼Œç”¨æˆ·ä½“éªŒå·®
    
    // è°ƒä¼˜åé…ç½®ï¼š
    // -Xms4g -Xmx4g
    // -XX:+UseG1GC  
    // -XX:MaxGCPauseMillis=100
    // -XX:G1HeapRegionSize=16m
    // -XX:NewRatio=2
    
    // è°ƒä¼˜æ•ˆæœå¯¹æ¯”ï¼š
    // è°ƒä¼˜å‰ï¼šå¹³å‡GCæš‚åœ200msï¼Œæœ€å¤§æš‚åœ800ms
    // è°ƒä¼˜åï¼šå¹³å‡GCæš‚åœ50msï¼Œæœ€å¤§æš‚åœ150ms
    
    public static void simulateWebLoad() {
        // æ¨¡æ‹ŸWebè¯·æ±‚å¤„ç†
        for (int i = 0; i < 100000; i++) {
            processRequest();
            
            if (i % 1000 == 0) {
                // æ¨¡æ‹Ÿä¼šè¯æ•°æ®
                createSessionData();
            }
        }
    }
    
    static void processRequest() {
        // åˆ›å»ºå¤§é‡ä¸´æ—¶å¯¹è±¡ï¼ˆæ–°ç”Ÿä»£ï¼‰
        StringBuilder response = new StringBuilder();
        for (int i = 0; i < 100; i++) {
            response.append("data_").append(i);
        }
    }
    
    static void createSessionData() {
        // åˆ›å»ºé•¿æœŸå¯¹è±¡ï¼ˆè€å¹´ä»£ï¼‰
        Map<String, Object> session = new HashMap<>();
        session.put("user", "user_" + System.currentTimeMillis());
        session.put("data", new byte[1024]); // 1KBä¼šè¯æ•°æ®
    }
}
```

### 3.5 åº”ç”¨å±‚ä¼˜åŒ–ï¼šå¯¹è±¡é‡ç”¨ã€ç¼“å­˜ç­–ç•¥ã€è¿æ¥æ± é…ç½®


**ğŸ”„ å¯¹è±¡é‡ç”¨ä¼˜åŒ–**
```java
// å¯¹è±¡é‡ç”¨æœ€ä½³å®è·µ
public class ObjectReuseOptimization {
    
    // 1. StringBuilderé‡ç”¨
    private static final ThreadLocal<StringBuilder> STRING_BUILDER = 
        ThreadLocal.withInitial(() -> new StringBuilder(1024));
    
    public String buildString(String... parts) {
        StringBuilder sb = STRING_BUILDER.get();
        sb.setLength(0);  // é‡ç½®è€Œä¸æ˜¯åˆ›å»ºæ–°å¯¹è±¡
        
        for (String part : parts) {
            sb.append(part).append(",");
        }
        
        return sb.toString();
    }
    
    // 2. å¯¹è±¡æ± æ¨¡å¼
    public static class ObjectPool<T> {
        private final Queue<T> pool = new ConcurrentLinkedQueue<>();
        private final Supplier<T> factory;
        private final Consumer<T> resetFunction;
        
        public ObjectPool(Supplier<T> factory, Consumer<T> resetFunction) {
            this.factory = factory;
            this.resetFunction = resetFunction;
        }
        
        public T borrow() {
            T object = pool.poll();
            return object != null ? object : factory.get();
        }
        
        public void release(T object) {
            resetFunction.accept(object);
            pool.offer(object);
        }
    }
    
    // 3. ä½¿ç”¨å¯¹è±¡æ± 
    private static final ObjectPool<List<String>> LIST_POOL = 
        new ObjectPool<>(ArrayList::new, List::clear);
    
    public void processData() {
        List<String> list = LIST_POOL.borrow();
        try {
            // ä½¿ç”¨listå¤„ç†æ•°æ®
            list.add("data1");
            list.add("data2");
            // ä¸šåŠ¡é€»è¾‘...
        } finally {
            LIST_POOL.release(list);  // å½’è¿˜å¯¹è±¡æ± 
        }
    }
}
```

**ğŸ’¾ ç¼“å­˜ç­–ç•¥ä¼˜åŒ–**
```java
// ç¼“å­˜ç­–ç•¥æœ€ä½³å®è·µ
public class CacheOptimization {
    
    // 1. ä½¿ç”¨Caffeineç¼“å­˜ï¼ˆæ¯”Guava Cacheæ€§èƒ½æ›´å¥½ï¼‰
    private final Cache<String, Object> cache = Caffeine.newBuilder()
        .maximumSize(10000)
        .expireAfterWrite(Duration.ofMinutes(30))
        .recordStats()  // å¯ç”¨ç»Ÿè®¡
        .build();
    
    // 2. åˆ†çº§ç¼“å­˜ç­–ç•¥
    private final Cache<String, Object> l1Cache = Caffeine.newBuilder()
        .maximumSize(1000)
        .expireAfterWrite(Duration.ofMinutes(5))
        .build();
    
    private final Cache<String, Object> l2Cache = Caffeine.newBuilder()
        .maximumSize(5000)
        .expireAfterWrite(Duration.ofMinutes(30))
        .build();
    
    public Object getData(String key) {
        // L1ç¼“å­˜æŸ¥æ‰¾
        Object value = l1Cache.getIfPresent(key);
        if (value != null) {
            return value;
        }
        
        // L2ç¼“å­˜æŸ¥æ‰¾
        value = l2Cache.getIfPresent(key);
        if (value != null) {
            l1Cache.put(key, value);  // æå‡åˆ°L1
            return value;
        }
        
        // ä»æ•°æ®æºåŠ è½½
        value = loadFromDataSource(key);
        l2Cache.put(key, value);
        return value;
    }
    
    // 3. ç¼“å­˜é¢„çƒ­
    @PostConstruct
    public void warmupCache() {
        // é¢„åŠ è½½çƒ­ç‚¹æ•°æ®
        List<String> hotKeys = getHotKeys();
        hotKeys.parallelStream().forEach(key -> {
            try {
                getData(key);  // é¢„åŠ è½½åˆ°ç¼“å­˜
            } catch (Exception e) {
                log.warn("é¢„çƒ­ç¼“å­˜å¤±è´¥: " + key, e);
            }
        });
    }
    
    private Object loadFromDataSource(String key) {
        // æ¨¡æ‹Ÿä»æ•°æ®åº“åŠ è½½
        return "data_" + key;
    }
    
    private List<String> getHotKeys() {
        return Arrays.asList("hot_key_1", "hot_key_2", "hot_key_3");
    }
}
```

**ğŸ”— è¿æ¥æ± é…ç½®ä¼˜åŒ–**
```java
// è¿æ¥æ± é…ç½®æœ€ä½³å®è·µ
public class ConnectionPoolOptimization {
    
    // 1. æ•°æ®åº“è¿æ¥æ± é…ç½®
    @Bean
    public DataSource dataSource() {
        HikariConfig config = new HikariConfig();
        
        // åŸºç¡€é…ç½®
        config.setJdbcUrl("jdbc:mysql://localhost:3306/mydb");
        config.setUsername("user");
        config.setPassword("password");
        
        // è¿æ¥æ± å¤§å°é…ç½®
        config.setMinimumIdle(5);           // æœ€å°ç©ºé—²è¿æ¥
        config.setMaximumPoolSize(20);      // æœ€å¤§è¿æ¥æ•°
        
        // è¿æ¥è¶…æ—¶é…ç½®
        config.setConnectionTimeout(30000); // 30ç§’è¿æ¥è¶…æ—¶
        config.setIdleTimeout(600000);      // 10åˆ†é’Ÿç©ºé—²è¶…æ—¶
        config.setMaxLifetime(1800000);     // 30åˆ†é’Ÿæœ€å¤§ç”Ÿå‘½å‘¨æœŸ
        
        // è¿æ¥æµ‹è¯•é…ç½®
        config.setConnectionTestQuery("SELECT 1");
        config.setValidationTimeout(5000);
        
        // æ€§èƒ½é…ç½®
        config.setLeakDetectionThreshold(60000); // 1åˆ†é’Ÿæ³„æ¼æ£€æµ‹
        
        return new HikariDataSource(config);
    }
    
    // 2. HTTPè¿æ¥æ± é…ç½®
    @Bean
    public CloseableHttpClient httpClient() {
        PoolingHttpClientConnectionManager connectionManager = 
            new PoolingHttpClientConnectionManager();
        
        // è¿æ¥æ± é…ç½®
        connectionManager.setMaxTotal(200);      // æ€»è¿æ¥æ•°
        connectionManager.setDefaultMaxPerRoute(20); // æ¯ä¸ªè·¯ç”±æœ€å¤§è¿æ¥æ•°
        
        // è¶…æ—¶é…ç½®
        RequestConfig requestConfig = RequestConfig.custom()
            .setConnectTimeout(5000)        // è¿æ¥è¶…æ—¶5ç§’
            .setSocketTimeout(10000)        // è¯»å–è¶…æ—¶10ç§’
            .setConnectionRequestTimeout(3000) // ä»è¿æ¥æ± è·å–è¿æ¥è¶…æ—¶3ç§’
            .build();
        
        return HttpClients.custom()
            .setConnectionManager(connectionManager)
            .setDefaultRequestConfig(requestConfig)
            .setConnectionTimeToLive(30, TimeUnit.SECONDS)
            .build();
    }
    
    // 3. çº¿ç¨‹æ± é…ç½®
    @Bean
    public ThreadPoolExecutor taskExecutor() {
        return new ThreadPoolExecutor(
            10,                           // æ ¸å¿ƒçº¿ç¨‹æ•°
            50,                          // æœ€å¤§çº¿ç¨‹æ•°  
            60L, TimeUnit.SECONDS,       // çº¿ç¨‹ç©ºé—²æ—¶é—´
            new LinkedBlockingQueue<>(1000), // ä»»åŠ¡é˜Ÿåˆ—
            new ThreadFactoryBuilder()
                .setNameFormat("task-pool-%d")
                .build(),
            new ThreadPoolExecutor.CallerRunsPolicy() // æ‹’ç»ç­–ç•¥
        );
    }
}

// è¿æ¥æ± ç›‘æ§
@Component
public class ConnectionPoolMonitor {
    
    @Autowired
    private HikariDataSource dataSource;
    
    @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    public void monitorConnectionPool() {
        HikariPoolMXBean poolMXBean = dataSource.getHikariPoolMXBean();
        
        int totalConnections = poolMXBean.getTotalConnections();
        int activeConnections = poolMXBean.getActiveConnections();
        int idleConnections = poolMXBean.getIdleConnections();
        
        System.out.println("è¿æ¥æ± çŠ¶æ€ - æ€»è¿æ¥æ•°: " + totalConnections + 
                          ", æ´»è·ƒè¿æ¥: " + activeConnections + 
                          ", ç©ºé—²è¿æ¥: " + idleConnections);
        
        // è¿æ¥æ± å¥åº·æ£€æŸ¥
        if (activeConnections > totalConnections * 0.8) {
            System.out.println("è­¦å‘Šï¼šè¿æ¥æ± ä½¿ç”¨ç‡è¿‡é«˜ï¼");
        }
    }
}
```

### 3.6 ç”Ÿäº§ç¯å¢ƒé—®é¢˜æ’æŸ¥å®æˆ˜æ¡ˆä¾‹


**ğŸš¨ æ¡ˆä¾‹1ï¼šWebåº”ç”¨å“åº”æ…¢é—®é¢˜æ’æŸ¥**
```bash
# é—®é¢˜ç°è±¡ï¼šWebåº”ç”¨å“åº”æ—¶é—´çªç„¶å˜æ…¢ï¼Œä»100mså¢åŠ åˆ°2ç§’

# æ’æŸ¥æ­¥éª¤1ï¼šå¿«é€Ÿå®šä½è¿›ç¨‹
jps -l | grep MyWebApp
# è¾“å‡ºï¼š12345 com.example.MyWebApp

# æ’æŸ¥æ­¥éª¤2ï¼šæ£€æŸ¥GCæƒ…å†µ
jstat -gc 12345 1s 10
# å‘ç°ï¼šFull GCé¢‘ç¹ï¼Œæ¯æ¬¡æš‚åœ1.5ç§’

# æ’æŸ¥æ­¥éª¤3ï¼šåˆ†æçº¿ç¨‹çŠ¶æ€
jstack 12345 > thread_dump.txt
grep "java.lang.Thread.State" thread_dump.txt | sort | uniq -c
# å‘ç°ï¼šå¤§é‡çº¿ç¨‹å¤„äºBLOCKEDçŠ¶æ€

# æ’æŸ¥æ­¥éª¤4ï¼šç”Ÿæˆå†…å­˜å¿«ç…§
jmap -dump:live,format=b,file=heap_slow.hprof 12345

# æ’æŸ¥æ­¥éª¤5ï¼šMATåˆ†æ
# å‘ç°ï¼šæŸä¸ªç¼“å­˜Mapå ç”¨2GBå†…å­˜ï¼ŒåŒ…å«500ä¸‡ä¸ªå¯¹è±¡
# æ ¹å› ï¼šç¼“å­˜æ²¡æœ‰è¿‡æœŸç­–ç•¥ï¼Œæ— é™å¢é•¿

# è§£å†³æ–¹æ¡ˆï¼š
# 1. ç«‹å³é‡å¯åº”ç”¨é‡Šæ”¾å†…å­˜
# 2. æ·»åŠ ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼šexpireAfterWrite(1, TimeUnit.HOURS)
# 3. é™åˆ¶ç¼“å­˜å¤§å°ï¼šmaximumSize(100000)
# 4. å¢åŠ ç¼“å­˜ç›‘æ§ï¼šrecordStats()
```

**ğŸ’¥ æ¡ˆä¾‹2ï¼šå†…å­˜æº¢å‡ºé—®é¢˜æ’æŸ¥**
```java
// é—®é¢˜ç°è±¡ï¼šåº”ç”¨æ¯è¿è¡Œ2å°æ—¶å°±OutOfMemoryError
public class OOMCase {
    // é—®é¢˜ä»£ç ï¼ˆå·²ä¿®å¤ï¼‰
    private static Map<String, Object> cache = new HashMap<>();
    
    // åŸé—®é¢˜ï¼šæ¯ä¸ªè¯·æ±‚éƒ½å¾€é™æ€Mapä¸­æ”¾æ•°æ®ï¼Œä»ä¸æ¸…ç†
    public void handleRequest(String requestId, Object data) {
        cache.put(requestId, data);  // é—®é¢˜æ‰€åœ¨
        // å¤„ç†ä¸šåŠ¡é€»è¾‘...
    }
}

// æ’æŸ¥è¿‡ç¨‹ï¼š
// 1. jmap -histo å‘ç°HashMap$Nodeå¯¹è±¡æœ€å¤š
// 2. jmap -dumpç”Ÿæˆheap dump
// 3. MATåˆ†ææ˜¾ç¤ºcacheå ç”¨80%å†…å­˜
// 4. GC Rootè·¯å¾„ï¼šstatic field -> HashMap -> Entry[]

// ä¿®å¤æ–¹æ¡ˆï¼š
public class OOMCaseFixed {
    // ä½¿ç”¨å¸¦è¿‡æœŸçš„ç¼“å­˜æ›¿ä»£é™æ€Map
    private final Cache<String, Object> cache = Caffeine.newBuilder()
        .maximumSize(10000)
        .expireAfterWrite(Duration.ofMinutes(30))
        .removalListener((key, value, cause) -> {
            System.out.println("Cache removed: " + key + ", cause: " + cause);
        })
        .build();
    
    public void handleRequest(String requestId, Object data) {
        cache.put(requestId, data);  // è‡ªåŠ¨è¿‡æœŸå’Œé™åˆ¶å¤§å°
        // å¤„ç†ä¸šåŠ¡é€»è¾‘...
    }
}
```

**ğŸŒ æ¡ˆä¾‹3ï¼šGCè°ƒä¼˜å®æˆ˜**
```bash
# é—®é¢˜ç°è±¡ï¼šæ‰¹å¤„ç†åº”ç”¨GCæš‚åœæ—¶é—´è¿‡é•¿ï¼Œå½±å“å¤„ç†æ•ˆç‡

# åŸé…ç½®ï¼š
# -Xms8g -Xmx8g -XX:+UseParallelGC

# é—®é¢˜åˆ†æï¼š
# 1. GCæ—¥å¿—æ˜¾ç¤ºFull GCæš‚åœæ—¶é—´5-8ç§’
# 2. jstatæ˜¾ç¤ºè€å¹´ä»£ä½¿ç”¨ç‡æŒç»­90%+
# 3. åº”ç”¨ç‰¹ç‚¹ï¼šå¤§é‡ä¸­ç­‰ç”Ÿå‘½å‘¨æœŸå¯¹è±¡

# è°ƒä¼˜æ–¹æ¡ˆ1ï¼šåˆ‡æ¢åˆ°G1æ”¶é›†å™¨
java -Xms8g -Xmx8g \
     -XX:+UseG1GC \
     -XX:MaxGCPauseMillis=500 \
     -XX:G1HeapRegionSize=32m \
     -jar batch-app.jar

# æ•ˆæœï¼šæš‚åœæ—¶é—´é™åˆ°200-500msï¼Œä½†ååé‡ä¸‹é™15%

# è°ƒä¼˜æ–¹æ¡ˆ2ï¼šå¢å¤§å †å†…å­˜+ä¼˜åŒ–Parallel GC
java -Xms12g -Xmx12g \
     -XX:+UseParallelGC \
     -XX:ParallelGCThreads=8 \
     -XX:NewRatio=1 \
     -jar batch-app.jar

# æ•ˆæœï¼šFull GCé¢‘ç‡é™ä½ï¼Œæš‚åœæ—¶é—´2-3ç§’ï¼Œååé‡æå‡

# æœ€ç»ˆæ–¹æ¡ˆï¼šæ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹é€‰æ‹©æ–¹æ¡ˆ2
# æ‰¹å¤„ç†å¯ä»¥å®¹å¿è¾ƒé•¿æš‚åœï¼Œæ›´çœ‹é‡ååé‡
```

**ğŸ“Š æ¡ˆä¾‹4ï¼šç”Ÿäº§ç¯å¢ƒç»¼åˆç›‘æ§æ–¹æ¡ˆ**
```bash
#!/bin/bash
# ç”Ÿäº§ç¯å¢ƒJVMç›‘æ§è„šæœ¬

APP_NAME="MyWebApp"
LOG_DIR="/var/log/jvm-monitor"
ALERT_THRESHOLD=80

# åˆ›å»ºæ—¥å¿—ç›®å½•
mkdir -p $LOG_DIR

# è·å–è¿›ç¨‹ID
PID=$(jps -l | grep $APP_NAME | awk '{print $1}')

if [ -z "$PID" ]; then
    echo "åº”ç”¨ $APP_NAME æœªè¿è¡Œ"
    exit 1
fi

echo "ç›‘æ§è¿›ç¨‹: $PID ($APP_NAME)"

# 1. å†…å­˜ä½¿ç”¨ç›‘æ§
echo "=== å†…å­˜ä½¿ç”¨æƒ…å†µ ===" | tee -a $LOG_DIR/memory_$(date +%Y%m%d).log
jstat -gc $PID | tee -a $LOG_DIR/memory_$(date +%Y%m%d).log

# æå–è€å¹´ä»£ä½¿ç”¨ç‡
OLD_USED=$(jstat -gc $PID | tail -1 | awk '{print $8}')
OLD_CAPACITY=$(jstat -gc $PID | tail -1 | awk '{print $7}')
OLD_USAGE=$(echo "scale=2; $OLD_USED * 100 / $OLD_CAPACITY" | bc)

if (( $(echo "$OLD_USAGE > $ALERT_THRESHOLD" | bc -l) )); then
    echo "è­¦å‘Šï¼šè€å¹´ä»£ä½¿ç”¨ç‡ ${OLD_USAGE}% è¶…è¿‡é˜ˆå€¼ ${ALERT_THRESHOLD}%"
    # å‘é€å‘Šè­¦é‚®ä»¶æˆ–é’‰é’‰æ¶ˆæ¯
fi

# 2. çº¿ç¨‹çŠ¶æ€ç›‘æ§
echo "=== çº¿ç¨‹çŠ¶æ€ç»Ÿè®¡ ===" | tee -a $LOG_DIR/thread_$(date +%Y%m%d).log
jstack $PID | grep "java.lang.Thread.State" | sort | uniq -c | tee -a $LOG_DIR/thread_$(date +%Y%m%d).log

# 3. æ£€æŸ¥æ­»é”
DEADLOCK_COUNT=$(jstack $PID | grep -c "Found Java-level deadlock")
if [ $DEADLOCK_COUNT -gt 0 ]; then
    echo "å‘ç°æ­»é”ï¼ç”Ÿæˆå®Œæ•´çº¿ç¨‹è½¬å‚¨"
    jstack $PID > $LOG_DIR/deadlock_$(date +%Y%m%d_%H%M%S).dump
fi

# 4. GCé¢‘ç‡ç›‘æ§
echo "=== GCç»Ÿè®¡ ===" | tee -a $LOG_DIR/gc_$(date +%Y%m%d).log
jstat -gcutil $PID | tee -a $LOG_DIR/gc_$(date +%Y%m%d).log

# 5. åº”ç”¨å±‚é¢ç›‘æ§
echo "=== åº”ç”¨æŒ‡æ ‡ ===" | tee -a $LOG_DIR/app_$(date +%Y%m%d).log

# HTTPè¿æ¥æ± çŠ¶æ€
curl -s http://localhost:8080/actuator/metrics/hikaricp.connections.active | \
  jq '.measurements[0].value' 2>/dev/null || echo "æ— æ³•è·å–è¿æ¥æ± æŒ‡æ ‡"

# å†…å­˜ä¸­å¯¹è±¡Top10
echo "å†…å­˜å¯¹è±¡Top10:" >> $LOG_DIR/app_$(date +%Y%m%d).log
jmap -histo $PID | head -20 >> $LOG_DIR/app_$(date +%Y%m%d).log

echo "ç›‘æ§å®Œæˆï¼Œæ—¥å¿—ä¿å­˜åœ¨ $LOG_DIR"
```

**ğŸ“ˆ æ€§èƒ½åŸºçº¿å»ºç«‹å’Œè¶‹åŠ¿åˆ†æ**
```java
// æ€§èƒ½åŸºçº¿ç›‘æ§ä»£ç 
@Component
public class PerformanceBaseline {
    
    private final MeterRegistry meterRegistry;
    private final Timer httpRequestTimer;
    private final Gauge heapUsageGauge;
    private final Counter gcCounter;
    
    public PerformanceBaseline(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        
        // HTTPè¯·æ±‚å“åº”æ—¶é—´
        this.httpRequestTimer = Timer.builder("http.request.duration")
            .description("HTTPè¯·æ±‚å“åº”æ—¶é—´")
            .register(meterRegistry);
        
        // å †å†…å­˜ä½¿ç”¨ç‡
        this.heapUsageGauge = Gauge.builder("jvm.memory.heap.usage")
            .description("å †å†…å­˜ä½¿ç”¨ç‡")
            .register(meterRegistry, this, PerformanceBaseline::getHeapUsage);
        
        // GCæ¬¡æ•°
        this.gcCounter = Counter.builder("jvm.gc.count")
            .description("GCæ€»æ¬¡æ•°")
            .register(meterRegistry);
    }
    
    public double getHeapUsage() {
        MemoryMXBean memoryBean = ManagementFactory.getMemoryMXBean();
        MemoryUsage heapUsage = memoryBean.getHeapMemoryUsage();
        return (double) heapUsage.getUsed() / heapUsage.getMax();
    }
    
    @EventListener
    public void handleHttpRequest(HttpRequestEvent event) {
        httpRequestTimer.record(event.getDuration(), TimeUnit.MILLISECONDS);
    }
    
    @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    public void checkPerformanceBaseline() {
        // æ£€æŸ¥å“åº”æ—¶é—´åŸºçº¿
        double avgResponseTime = httpRequestTimer.mean(TimeUnit.MILLISECONDS);
        if (avgResponseTime > 500) { // åŸºçº¿ï¼š500ms
            System.out.println("è­¦å‘Šï¼šå¹³å‡å“åº”æ—¶é—´ " + avgResponseTime + "ms è¶…è¿‡åŸºçº¿");
        }
        
        // æ£€æŸ¥å†…å­˜ä½¿ç”¨åŸºçº¿
        double heapUsage = getHeapUsage();
        if (heapUsage > 0.8) { // åŸºçº¿ï¼š80%
            System.out.println("è­¦å‘Šï¼šå †å†…å­˜ä½¿ç”¨ç‡ " + (heapUsage * 100) + "% è¶…è¿‡åŸºçº¿");
        }
        
        // æ£€æŸ¥GCé¢‘ç‡åŸºçº¿
        long gcCount = getGCCount();
        // æ ¹æ®å†å²æ•°æ®å»ºç«‹GCé¢‘ç‡åŸºçº¿
    }
    
    private long getGCCount() {
        return ManagementFactory.getGarbageCollectorMXBeans()
            .stream()
            .mapToLong(GarbageCollectorMXBean::getCollectionCount)
            .sum();
    }
}
```

**ğŸ¯ è°ƒä¼˜æ•ˆæœéªŒè¯**
```bash
# è°ƒä¼˜å‰åå¯¹æ¯”è„šæœ¬
#!/bin/bash

echo "=== JVMè°ƒä¼˜æ•ˆæœå¯¹æ¯” ==="

# è°ƒä¼˜å‰åŸºçº¿æ•°æ®ï¼ˆä¿å­˜åœ¨æ–‡ä»¶ä¸­ï¼‰
BASELINE_FILE="/tmp/performance_baseline.txt"

# å½“å‰æ€§èƒ½æ•°æ®
CURRENT_FILE="/tmp/performance_current.txt"

# æ”¶é›†å½“å‰æ•°æ®
PID=$(jps -l | grep MyApp | awk '{print $1}')

echo "æ”¶é›†å½“å‰æ€§èƒ½æ•°æ®..."
echo "timestamp: $(date)" > $CURRENT_FILE
echo "heap_usage: $(jstat -gc $PID | tail -1 | awk '{print ($8+$6)/($7+$5)*100}')" >> $CURRENT_FILE
echo "gc_count: $(jstat -gc $PID | tail -1 | awk '{print $13+$14}')" >> $CURRENT_FILE
echo "gc_time: $(jstat -gc $PID | tail -1 | awk '{print $15+$16}')" >> $CURRENT_FILE

# å¯¹æ¯”åˆ†æ
if [ -f "$BASELINE_FILE" ]; then
    echo "=== æ€§èƒ½å¯¹æ¯”ç»“æœ ==="
    
    BASELINE_HEAP=$(grep heap_usage $BASELINE_FILE | cut -d: -f2)
    CURRENT_HEAP=$(grep heap_usage $CURRENT_FILE | cut -d: -f2)
    
    echo "å †å†…å­˜ä½¿ç”¨ç‡ï¼š"
    echo "  è°ƒä¼˜å‰: ${BASELINE_HEAP}%"
    echo "  è°ƒä¼˜å: ${CURRENT_HEAP}%"
    
    BASELINE_GC_COUNT=$(grep gc_count $BASELINE_FILE | cut -d: -f2)
    CURRENT_GC_COUNT=$(grep gc_count $CURRENT_FILE | cut -d: -f2)
    
    echo "GCæ¬¡æ•°ï¼š"
    echo "  è°ƒä¼˜å‰: $BASELINE_GC_COUNT"
    echo "  è°ƒä¼˜å: $CURRENT_GC_COUNT"
    
    # è®¡ç®—æ”¹å–„æ¯”ä¾‹
    HEAP_IMPROVEMENT=$(echo "scale=2; ($BASELINE_HEAP - $CURRENT_HEAP) / $BASELINE_HEAP * 100" | bc)
    echo "å †å†…å­˜ä½¿ç”¨æ”¹å–„: ${HEAP_IMPROVEMENT}%"
else
    echo "æœªæ‰¾åˆ°åŸºçº¿æ•°æ®ï¼Œå°†å½“å‰æ•°æ®ä¿å­˜ä¸ºåŸºçº¿"
    cp $CURRENT_FILE $BASELINE_FILE
fi
```

---

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- JVMå‚æ•°åˆ†ä¸ºæ ‡å‡†å‚æ•°ã€Xå‚æ•°ã€XXå‚æ•°ï¼Œè¦æ ¹æ®åº”ç”¨ç‰¹ç‚¹åˆç†è®¾ç½®å†…å­˜å’ŒGCå‚æ•°
- æ€§èƒ½ç›‘æ§å·¥å…·å„æœ‰ç‰¹è‰²ï¼šå‘½ä»¤è¡Œå·¥å…·å¿«é€Ÿå®šä½é—®é¢˜ï¼Œå¯è§†åŒ–å·¥å…·æ·±å…¥åˆ†æï¼Œç¬¬ä¸‰æ–¹å·¥å…·ä¸“ä¸šè¯Šæ–­
- å†…å­˜é—®é¢˜æ’æŸ¥è¦åŒºåˆ†å†…å­˜æ³„æ¼å’Œå†…å­˜æº¢å‡ºï¼Œä½¿ç”¨MATåˆ†æheap dumpæ˜¯å…³é”®æŠ€èƒ½
- å†…å­˜è°ƒä¼˜éœ€è¦ç»¼åˆè€ƒè™‘å †å¤§å°ã€GCç­–ç•¥ã€åº”ç”¨å±‚ä¼˜åŒ–ï¼Œå»ºç«‹æ€§èƒ½åŸºçº¿å’Œç›‘æ§ä½“ç³»
- ç”Ÿäº§ç¯å¢ƒé—®é¢˜æ’æŸ¥è¦æœ‰ç³»ç»Ÿæ€§æ–¹æ³•ï¼Œä»å¿«é€Ÿå®šä½åˆ°æ·±å…¥åˆ†æå†åˆ°æ•ˆæœéªŒè¯çš„å®Œæ•´æµç¨‹