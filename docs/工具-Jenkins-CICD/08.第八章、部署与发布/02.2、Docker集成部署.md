---
title: 2ã€Dockeré›†æˆéƒ¨ç½²
---
## ğŸ“š ç›®å½•

1. [Dockeré›†æˆéƒ¨ç½²æ¦‚è¿°](#1-Dockeré›†æˆéƒ¨ç½²æ¦‚è¿°)
2. [Dockeræ’ä»¶é…ç½®](#2-Dockeræ’ä»¶é…ç½®)
3. [Dockerfileæ„å»ºè¯¦è§£](#3-Dockerfileæ„å»ºè¯¦è§£)
4. [é•œåƒæ„å»ºæµç¨‹](#4-é•œåƒæ„å»ºæµç¨‹)
5. [é•œåƒæ¨é€é…ç½®](#5-é•œåƒæ¨é€é…ç½®)
6. [å®¹å™¨éƒ¨ç½²è„šæœ¬](#6-å®¹å™¨éƒ¨ç½²è„šæœ¬)
7. [é•œåƒç‰ˆæœ¬ç®¡ç†](#7-é•œåƒç‰ˆæœ¬ç®¡ç†)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ³ Dockeré›†æˆéƒ¨ç½²æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯Dockeré›†æˆéƒ¨ç½²


**ç®€å•ç†è§£**ï¼šå°±æ˜¯è®©Jenkinsè‡ªåŠ¨å¸®ä½ æŠŠä»£ç æ‰“åŒ…æˆDockeré•œåƒï¼Œç„¶åéƒ¨ç½²åˆ°æœåŠ¡å™¨ä¸Šè¿è¡Œ

```
ä¼ ç»Ÿéƒ¨ç½²æ–¹å¼ï¼š
å¼€å‘è€… â†’ æ‰‹åŠ¨æ‰“åŒ… â†’ æ‰‹åŠ¨ä¸Šä¼ æœåŠ¡å™¨ â†’ æ‰‹åŠ¨å¯åŠ¨åº”ç”¨

Dockeré›†æˆéƒ¨ç½²ï¼š
å¼€å‘è€…æäº¤ä»£ç  â†’ Jenkinsè‡ªåŠ¨æ„å»º â†’ è‡ªåŠ¨æ‰“åŒ…é•œåƒ â†’ è‡ªåŠ¨éƒ¨ç½²è¿è¡Œ
```

### 1.2 ä¸ºä»€ä¹ˆè¦ç”¨Dockeréƒ¨ç½²


**ğŸ¯ ä¸»è¦å¥½å¤„**ï¼š
- **ç¯å¢ƒä¸€è‡´æ€§**ï¼šå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒå®Œå…¨ç›¸åŒ
- **éƒ¨ç½²ç®€å•**ï¼šä¸€ä¸ªå‘½ä»¤å°±èƒ½å¯åŠ¨æ•´ä¸ªåº”ç”¨
- **ç‰ˆæœ¬å›æ»š**ï¼šå‡ºé—®é¢˜ç«‹å³å›åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
- **èµ„æºéš”ç¦»**ï¼šä¸åŒåº”ç”¨äº’ä¸å¹²æ‰°

**ğŸ’¡ å®é™…åœºæ™¯ä¸¾ä¾‹**ï¼š
```
æ²¡æœ‰Dockeræ—¶çš„ç—›ç‚¹ï¼š
- å¼€å‘ç¯å¢ƒJava 8ï¼Œç”Ÿäº§ç¯å¢ƒJava 11 â†’ åº”ç”¨è·‘ä¸èµ·æ¥
- ç¼ºå°‘ä¾èµ–åŒ… â†’ å„ç§æŠ¥é”™
- é…ç½®æ–‡ä»¶ä¸åŒ â†’ åŠŸèƒ½å¼‚å¸¸

æœ‰äº†Dockeråï¼š
- æ‰“åŒ…æ—¶å°±æŠŠç¯å¢ƒã€ä¾èµ–ã€é…ç½®éƒ½åŒ…è¿›å»
- åœ¨å“ªé‡Œè¿è¡Œéƒ½ä¸€æ ·
- å‡ºé—®é¢˜ç›´æ¥æ¢ä¸ªé•œåƒç‰ˆæœ¬
```

### 1.3 Dockeré›†æˆéƒ¨ç½²æ¶æ„


```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä»£ç ä»“åº“        â”‚    â”‚   Jenkins       â”‚    â”‚  Dockerä»“åº“     â”‚
â”‚  (GitLab/GitHub)â”‚    â”‚                 â”‚    â”‚  (Harbor/DockerHub)â”‚
â”‚                 â”‚    â”‚  1.æ‹‰å–ä»£ç      â”‚    â”‚                 â”‚
â”‚  â”œâ”€ src/        â”‚â”€â”€â”€â–¶â”‚  2.æ„å»ºé•œåƒ     â”‚â”€â”€â”€â–¶â”‚  â”œâ”€ app:v1.0    â”‚
â”‚  â”œâ”€ Dockerfile  â”‚    â”‚  3.æ¨é€é•œåƒ     â”‚    â”‚  â”œâ”€ app:v1.1    â”‚
â”‚  â””â”€ Jenkinsfile â”‚    â”‚  4.éƒ¨ç½²åº”ç”¨     â”‚    â”‚  â””â”€ app:latest  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚  ç›®æ ‡æœåŠ¡å™¨      â”‚
                       â”‚                 â”‚
                       â”‚  ğŸ³ å®¹å™¨1       â”‚
                       â”‚  ğŸ³ å®¹å™¨2       â”‚
                       â”‚  ğŸ³ å®¹å™¨3       â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸ”§ Dockeræ’ä»¶é…ç½®


### 2.1 å®‰è£…Dockeræ’ä»¶


**ç¬¬ä¸€æ­¥ï¼šå®‰è£…å¿…è¦æ’ä»¶**

åœ¨Jenkinsç®¡ç†ç•Œé¢å®‰è£…è¿™äº›æ’ä»¶ï¼š
- `Docker Plugin` - DockeråŸºç¡€åŠŸèƒ½
- `Docker Pipeline Plugin` - ç®¡é“ä¸­ä½¿ç”¨Docker
- `Docker Build Step Plugin` - æ„å»ºæ­¥éª¤æ”¯æŒ

**ğŸ” å®‰è£…è·¯å¾„**ï¼š
```
Jenkinsç®¡ç† â†’ æ’ä»¶ç®¡ç† â†’ å¯é€‰æ’ä»¶ â†’ æœç´¢"Docker"
```

### 2.2 é…ç½®Dockerç¯å¢ƒ


**ç¬¬äºŒæ­¥ï¼šé…ç½®Dockerè¿æ¥**

> **ğŸš¨ é‡è¦è¯´æ˜**ï¼šJenkinséœ€è¦èƒ½å¤Ÿè®¿é—®DockeræœåŠ¡

**æœ¬åœ°Dockeré…ç½®**ï¼š
```bash
# 1. ç¡®ä¿Jenkinsç”¨æˆ·æœ‰Dockeræƒé™
sudo usermod -aG docker jenkins

# 2. é‡å¯JenkinsæœåŠ¡
sudo systemctl restart jenkins

# 3. éªŒè¯è¿æ¥
docker ps
```

**è¿œç¨‹Dockeré…ç½®**ï¼š
```
Jenkinsç®¡ç† â†’ ç³»ç»Ÿé…ç½® â†’ Cloud â†’ æ·»åŠ Docker
- Name: docker-local
- Docker Host URI: unix:///var/run/docker.sock (æœ¬åœ°)
- Docker Host URI: tcp://192.168.1.100:2376 (è¿œç¨‹)
```

### 2.3 å…¨å±€å·¥å…·é…ç½®


**ç¬¬ä¸‰æ­¥ï¼šé…ç½®Dockerå·¥å…·**

```
Jenkinsç®¡ç† â†’ å…¨å±€å·¥å…·é…ç½® â†’ Docker â†’ æ–°å¢Docker
- Name: docker-latest
- è‡ªåŠ¨å®‰è£…: âœ“
- ç‰ˆæœ¬: latest
```

**ğŸ’­ å°è´´å£«**ï¼šå¦‚æœæœåŠ¡å™¨å·²å®‰è£…Dockerï¼Œé€‰æ‹©"æ‰‹åŠ¨å®‰è£…"å¹¶å¡«å†™Dockerè·¯å¾„ï¼š`/usr/bin/docker`

---

## 3. ğŸ“„ Dockerfileæ„å»ºè¯¦è§£


### 3.1 ä»€ä¹ˆæ˜¯Dockerfile


**é€šä¿—è§£é‡Š**ï¼šDockerfileå°±åƒæ˜¯ä¸€ä¸ª"è£…ä¿®å›¾çº¸"ï¼Œå‘Šè¯‰Dockeræ€ä¹ˆæ­å»ºä½ çš„åº”ç”¨ç¯å¢ƒ

```dockerfile
# è¿™æ˜¯ä¸€ä¸ªç®€å•çš„Javaåº”ç”¨Dockerfileç¤ºä¾‹
FROM openjdk:8-jre-alpine    # é€‰æ‹©åŸºç¡€ç¯å¢ƒï¼ˆJava 8ï¼‰
COPY app.jar /app.jar        # æŠŠåº”ç”¨æ–‡ä»¶å¤åˆ¶è¿›å»
EXPOSE 8080                  # å‘Šè¯‰å¤–ç•Œåº”ç”¨ç”¨8080ç«¯å£
CMD ["java", "-jar", "/app.jar"]  # å¯åŠ¨å‘½ä»¤
```

### 3.2 DockerfileåŸºæœ¬ç»“æ„


**ğŸ—ï¸ æ ¸å¿ƒæŒ‡ä»¤è¯´æ˜**ï¼š

| æŒ‡ä»¤ | **ä½œç”¨** | **é€šä¿—è§£é‡Š** | **ç¤ºä¾‹** |
|------|---------|-------------|----------|
| `FROM` | `æŒ‡å®šåŸºç¡€é•œåƒ` | `é€‰æ‹©"æ¯›å¯æˆ¿"ç±»å‹` | `FROM node:14` |
| `COPY` | `å¤åˆ¶æ–‡ä»¶` | `æŠŠä¸œè¥¿æ¬è¿›"æˆ¿å­"` | `COPY . /app` |
| `RUN` | `æ‰§è¡Œå‘½ä»¤` | `å®‰è£…è½¯ä»¶ã€é…ç½®ç¯å¢ƒ` | `RUN npm install` |
| `EXPOSE` | `æš´éœ²ç«¯å£` | `å¼€ä¸ª"é—¨"è®©å¤–é¢èƒ½è®¿é—®` | `EXPOSE 3000` |
| `CMD` | `å¯åŠ¨å‘½ä»¤` | `æˆ¿å­è£…ä¿®å¥½åæ€ä¹ˆ"å…¥ä½"` | `CMD ["npm", "start"]` |

### 3.3 å®é™…åº”ç”¨ç¤ºä¾‹


**ğŸŒŸ Spring Bootåº”ç”¨Dockerfile**ï¼š
```dockerfile
# ç¬¬ä¸€é˜¶æ®µï¼šæ„å»ºåº”ç”¨
FROM maven:3.8.4-openjdk-8 as builder
WORKDIR /app
COPY pom.xml .
RUN mvn dependency:go-offline
COPY src ./src
RUN mvn clean package -DskipTests

# ç¬¬äºŒé˜¶æ®µï¼šè¿è¡Œåº”ç”¨
FROM openjdk:8-jre-alpine
VOLUME /tmp
COPY --from=builder /app/target/*.jar app.jar
EXPOSE 8080
ENTRYPOINT ["java","-jar","/app.jar"]
```

**ğŸ’¡ ä¸ºä»€ä¹ˆåˆ†ä¸¤ä¸ªé˜¶æ®µ**ï¼š
- **æ„å»ºé˜¶æ®µ**ï¼šéœ€è¦Mavenã€æºç  â†’ ä½“ç§¯å¤§
- **è¿è¡Œé˜¶æ®µ**ï¼šåªéœ€è¦jaråŒ… â†’ ä½“ç§¯å°ã€å®‰å…¨

**ğŸŒŸ Node.jsåº”ç”¨Dockerfile**ï¼š
```dockerfile
FROM node:14-alpine
WORKDIR /usr/src/app
COPY package*.json ./
RUN npm ci --only=production
COPY . .
EXPOSE 3000
CMD ["node", "index.js"]
```

### 3.4 Dockerfileæœ€ä½³å®è·µ


**âš¡ ä¼˜åŒ–å»ºè®®**ï¼š

```dockerfile
# âœ… å¥½çš„åšæ³•
FROM node:14-alpine                    # ä½¿ç”¨è½»é‡çº§é•œåƒ
WORKDIR /app                          # è®¾ç½®å·¥ä½œç›®å½•
COPY package.json package-lock.json ./  # å…ˆå¤åˆ¶ä¾èµ–æ–‡ä»¶
RUN npm ci --only=production          # åˆ©ç”¨ç¼“å­˜æœºåˆ¶
COPY . .                              # æœ€åå¤åˆ¶æºç 
USER node                             # ä½¿ç”¨érootç”¨æˆ·
EXPOSE 3000
CMD ["node", "index.js"]

# âŒ ä¸å¥½çš„åšæ³•
FROM node:14                          # ä½“ç§¯å¤ªå¤§
COPY . .                              # ä¸€æ¬¡æ€§å¤åˆ¶ï¼Œæ— æ³•åˆ©ç”¨ç¼“å­˜
RUN npm install                       # å®‰è£…å¼€å‘ä¾èµ–
# æ²¡æœ‰æŒ‡å®šç”¨æˆ·ï¼Œé»˜è®¤rootè¿è¡Œ
```

---

## 4. ğŸ”„ é•œåƒæ„å»ºæµç¨‹


### 4.1 Jenkins Pipelineæ„å»ºæµç¨‹


**ğŸš€ å®Œæ•´æ„å»ºæµç¨‹å›¾**ï¼š

```
å¼€å§‹
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. æ‹‰å–ä»£ç      â”‚
â”‚  git checkout   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. æ„å»ºé•œåƒ     â”‚
â”‚  docker build   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. æµ‹è¯•é•œåƒ     â”‚
â”‚  docker run testâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. æ¨é€é•œåƒ     â”‚
â”‚  docker push    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. éƒ¨ç½²åº”ç”¨     â”‚
â”‚  docker deploy  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â–¼
ç»“æŸ
```

### 4.2 Pipelineè„šæœ¬ç¤ºä¾‹


**ğŸ“ åŸºç¡€Pipelineè„šæœ¬**ï¼š

```groovy
pipeline {
    agent any
    
    environment {
        DOCKER_IMAGE = "myapp"
        DOCKER_TAG = "${BUILD_NUMBER}"
        REGISTRY = "harbor.company.com"
    }
    
    stages {
        stage('æ‹‰å–ä»£ç ') {
            steps {
                git 'https://github.com/username/myapp.git'
            }
        }
        
        stage('æ„å»ºé•œåƒ') {
            steps {
                script {
                    // æ„å»ºDockeré•œåƒ
                    def image = docker.build("${DOCKER_IMAGE}:${DOCKER_TAG}")
                    
                    // ä¹Ÿç»™latestæ ‡ç­¾
                    image.tag("latest")
                }
            }
        }
        
        stage('æ¨é€é•œåƒ') {
            steps {
                script {
                    docker.withRegistry("https://${REGISTRY}", 'harbor-credentials') {
                        docker.image("${DOCKER_IMAGE}:${DOCKER_TAG}").push()
                        docker.image("${DOCKER_IMAGE}:latest").push()
                    }
                }
            }
        }
        
        stage('éƒ¨ç½²åº”ç”¨') {
            steps {
                sh '''
                    docker stop myapp || true
                    docker rm myapp || true
                    docker run -d --name myapp -p 8080:8080 ${REGISTRY}/${DOCKER_IMAGE}:${DOCKER_TAG}
                '''
            }
        }
    }
}
```

### 4.3 æ„å»ºå‚æ•°é…ç½®


**ğŸ›ï¸ å¸¸ç”¨æ„å»ºå‚æ•°**ï¼š

```groovy
pipeline {
    agent any
    
    parameters {
        choice(
            name: 'ENVIRONMENT',
            choices: ['dev', 'test', 'prod'],
            description: 'é€‰æ‹©éƒ¨ç½²ç¯å¢ƒ'
        )
        string(
            name: 'TAG_VERSION',
            defaultValue: 'latest',
            description: 'é•œåƒç‰ˆæœ¬æ ‡ç­¾'
        )
        booleanParam(
            name: 'SKIP_TESTS',
            defaultValue: false,
            description: 'æ˜¯å¦è·³è¿‡æµ‹è¯•'
        )
    }
    
    stages {
        // ... æ„å»ºæ­¥éª¤
    }
}
```

---

## 5. ğŸ“¤ é•œåƒæ¨é€é…ç½®


### 5.1 Dockerä»“åº“ç±»å‹


**ğŸª å¸¸è§ä»“åº“é€‰æ‹©**ï¼š

| ä»“åº“ç±»å‹ | **ä½¿ç”¨åœºæ™¯** | **ä¼˜ç¼ºç‚¹** | **é…ç½®éš¾åº¦** |
|---------|-------------|-----------|-------------|
| `Docker Hub` | `ä¸ªäººé¡¹ç›®ã€å¼€æºé¡¹ç›®` | `å…è´¹ã€ç®€å•ï¼Œä½†ç½‘é€Ÿæ…¢` | `â­` |
| `Harbor` | `ä¼ä¸šå†…éƒ¨é¡¹ç›®` | `åŠŸèƒ½å¼ºå¤§ã€ç§æœ‰éƒ¨ç½²` | `â­â­â­` |
| `é˜¿é‡Œäº‘ACR` | `å›½å†…é¡¹ç›®` | `é€Ÿåº¦å¿«ã€æ”¶è´¹åˆç†` | `â­â­` |
| `AWS ECR` | `AWSäº‘ä¸Šé¡¹ç›®` | `ä¸AWSé›†æˆå¥½` | `â­â­â­` |

### 5.2 é…ç½®æ¨é€å‡­æ®


**ğŸ” ç¬¬ä¸€æ­¥ï¼šæ·»åŠ ä»“åº“å‡­æ®**

```
Jenkinsç®¡ç† â†’ å‡­æ®ç®¡ç† â†’ å…¨å±€å‡­æ® â†’ æ·»åŠ å‡­æ®
- ç±»å‹: Username with password
- ç”¨æˆ·å: your-username
- å¯†ç : your-password
- ID: docker-registry-credentials
```

**ğŸ” ç¬¬äºŒæ­¥ï¼šåœ¨Pipelineä¸­ä½¿ç”¨**

```groovy
stage('æ¨é€é•œåƒ') {
    steps {
        script {
            // ä½¿ç”¨å‡­æ®ç™»å½•
            docker.withRegistry(
                'https://your-registry.com', 
                'docker-registry-credentials'
            ) {
                // æ¨é€é•œåƒ
                def image = docker.image("myapp:${BUILD_NUMBER}")
                image.push()
                image.push("latest")
            }
        }
    }
}
```

### 5.3 å¤šç¯å¢ƒæ¨é€ç­–ç•¥


**ğŸŒ ä¸åŒç¯å¢ƒæ¨é€ä¸åŒä»“åº“**ï¼š

```groovy
stage('æ¨é€é•œåƒ') {
    steps {
        script {
            def registry = ""
            def credentials = ""
            
            // æ ¹æ®åˆ†æ”¯é€‰æ‹©ä»“åº“
            if (env.BRANCH_NAME == 'master') {
                registry = "https://prod-registry.com"
                credentials = "prod-registry-creds"
            } else if (env.BRANCH_NAME == 'develop') {
                registry = "https://test-registry.com"
                credentials = "test-registry-creds"
            } else {
                registry = "https://dev-registry.com"
                credentials = "dev-registry-creds"
            }
            
            docker.withRegistry(registry, credentials) {
                docker.image("myapp:${BUILD_NUMBER}").push()
            }
        }
    }
}
```

---

## 6. ğŸš€ å®¹å™¨éƒ¨ç½²è„šæœ¬


### 6.1 åŸºç¡€éƒ¨ç½²è„šæœ¬


**ğŸ“œ ç®€å•éƒ¨ç½²è„šæœ¬**ï¼š

```bash
#!/bin/bash
# deploy.sh - åŸºç¡€éƒ¨ç½²è„šæœ¬

APP_NAME="myapp"
IMAGE_NAME="myapp:latest"
CONTAINER_PORT=8080
HOST_PORT=8080

echo "ğŸš€ å¼€å§‹éƒ¨ç½² $APP_NAME..."

# 1. åœæ­¢æ—§å®¹å™¨
echo "ğŸ“¤ åœæ­¢æ—§å®¹å™¨..."
docker stop $APP_NAME || true
docker rm $APP_NAME || true

# 2. æ‹‰å–æœ€æ–°é•œåƒ
echo "ğŸ“¥ æ‹‰å–æœ€æ–°é•œåƒ..."
docker pull $IMAGE_NAME

# 3. å¯åŠ¨æ–°å®¹å™¨
echo "ğŸ”„ å¯åŠ¨æ–°å®¹å™¨..."
docker run -d \
  --name $APP_NAME \
  -p $HOST_PORT:$CONTAINER_PORT \
  --restart=unless-stopped \
  $IMAGE_NAME

# 4. æ£€æŸ¥éƒ¨ç½²çŠ¶æ€
echo "ğŸ” æ£€æŸ¥éƒ¨ç½²çŠ¶æ€..."
sleep 5
if docker ps | grep $APP_NAME; then
    echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
else
    echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
    exit 1
fi
```

### 6.2 é«˜çº§éƒ¨ç½²è„šæœ¬


**ğŸ”§ å¸¦å¥åº·æ£€æŸ¥çš„éƒ¨ç½²è„šæœ¬**ï¼š

```bash
#!/bin/bash
# advanced-deploy.sh - é«˜çº§éƒ¨ç½²è„šæœ¬

APP_NAME="myapp"
IMAGE_NAME="$1"  # ä»å‚æ•°è·å–é•œåƒå
HEALTH_CHECK_URL="http://localhost:8080/health"
MAX_WAIT_TIME=60

echo "ğŸš€ å¼€å§‹éƒ¨ç½² $APP_NAME ä½¿ç”¨é•œåƒ $IMAGE_NAME..."

# 1. å¤‡ä»½å½“å‰å®¹å™¨
if docker ps | grep $APP_NAME; then
    echo "ğŸ’¾ å¤‡ä»½å½“å‰å®¹å™¨ä¸º ${APP_NAME}_backup..."
    docker rename $APP_NAME ${APP_NAME}_backup
fi

# 2. å¯åŠ¨æ–°å®¹å™¨
echo "ğŸ”„ å¯åŠ¨æ–°å®¹å™¨..."
docker run -d \
  --name $APP_NAME \
  -p 8080:8080 \
  -e SPRING_PROFILES_ACTIVE=prod \
  --restart=unless-stopped \
  --memory=512m \
  --cpus=0.5 \
  $IMAGE_NAME

# 3. å¥åº·æ£€æŸ¥
echo "ğŸ” ç­‰å¾…åº”ç”¨å¯åŠ¨..."
for i in $(seq 1 $MAX_WAIT_TIME); do
    if curl -f $HEALTH_CHECK_URL > /dev/null 2>&1; then
        echo "âœ… åº”ç”¨å¯åŠ¨æˆåŠŸï¼"
        
        # åˆ é™¤å¤‡ä»½å®¹å™¨
        docker rm ${APP_NAME}_backup || true
        exit 0
    fi
    echo "â³ ç­‰å¾…ä¸­... ($i/$MAX_WAIT_TIME)"
    sleep 1
done

# 4. éƒ¨ç½²å¤±è´¥ï¼Œå›æ»š
echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œå¼€å§‹å›æ»š..."
docker stop $APP_NAME
docker rm $APP_NAME
docker rename ${APP_NAME}_backup $APP_NAME
docker start $APP_NAME
echo "ğŸ”„ å·²å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬"
exit 1
```

### 6.3 Docker Composeéƒ¨ç½²


**ğŸ³ ä½¿ç”¨Docker Composeç®¡ç†å¤šå®¹å™¨**ï¼š

```yaml
# docker-compose.yml
version: '3.8'
services:
  app:
    image: myapp:${TAG:-latest}
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - DB_HOST=db
    depends_on:
      - db
    restart: unless-stopped
    
  db:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=root123
      - MYSQL_DATABASE=myapp
    volumes:
      - db_data:/var/lib/mysql
    restart: unless-stopped

volumes:
  db_data:
```

**éƒ¨ç½²è„šæœ¬**ï¼š
```bash
#!/bin/bash
# docker-compose-deploy.sh

export TAG=$1
echo "ğŸš€ ä½¿ç”¨Docker Composeéƒ¨ç½²ï¼Œé•œåƒæ ‡ç­¾: $TAG"

# æ‹‰å–æœ€æ–°é•œåƒ
docker-compose pull

# é‡æ–°åˆ›å»ºå¹¶å¯åŠ¨å®¹å™¨
docker-compose up -d

# æ£€æŸ¥çŠ¶æ€
docker-compose ps
```

---

## 7. ğŸ·ï¸ é•œåƒç‰ˆæœ¬ç®¡ç†


### 7.1 ç‰ˆæœ¬æ ‡ç­¾ç­–ç•¥


**ğŸ·ï¸ å¸¸ç”¨æ ‡ç­¾è§„èŒƒ**ï¼š

```
è¯­ä¹‰åŒ–ç‰ˆæœ¬ (æ¨è)ï¼š
- myapp:1.0.0      # æ­£å¼ç‰ˆæœ¬
- myapp:1.0.1      # è¡¥ä¸ç‰ˆæœ¬  
- myapp:1.1.0      # å°ç‰ˆæœ¬æ›´æ–°
- myapp:2.0.0      # å¤§ç‰ˆæœ¬æ›´æ–°

åŸºäºæ„å»ºçš„æ ‡ç­¾ï¼š
- myapp:build-123  # Jenkinsæ„å»ºå·
- myapp:20240119   # æ—¥æœŸæ ‡ç­¾
- myapp:commit-abc123  # Gitæäº¤ID

ç¯å¢ƒæ ‡ç­¾ï¼š
- myapp:dev-latest    # å¼€å‘ç¯å¢ƒæœ€æ–°ç‰ˆ
- myapp:test-v1.0     # æµ‹è¯•ç¯å¢ƒç‰ˆæœ¬
- myapp:prod-stable   # ç”Ÿäº§ç¯å¢ƒç¨³å®šç‰ˆ
```

### 7.2 è‡ªåŠ¨ç‰ˆæœ¬ç®¡ç†


**ğŸ¤– Pipelineä¸­çš„è‡ªåŠ¨ç‰ˆæœ¬æ§åˆ¶**ï¼š

```groovy
pipeline {
    agent any
    
    environment {
        APP_NAME = "myapp"
        REGISTRY = "harbor.company.com"
    }
    
    stages {
        stage('ç”Ÿæˆç‰ˆæœ¬æ ‡ç­¾') {
            steps {
                script {
                    // è·å–Gitä¿¡æ¯
                    def gitCommit = sh(returnStdout: true, script: 'git rev-parse --short HEAD').trim()
                    def gitBranch = env.BRANCH_NAME
                    def buildNumber = env.BUILD_NUMBER
                    
                    // ç”Ÿæˆæ ‡ç­¾
                    if (gitBranch == 'master') {
                        env.IMAGE_TAG = "prod-${buildNumber}"
                    } else if (gitBranch == 'develop') {
                        env.IMAGE_TAG = "test-${buildNumber}"
                    } else {
                        env.IMAGE_TAG = "dev-${gitCommit}"
                    }
                    
                    env.FULL_IMAGE_NAME = "${REGISTRY}/${APP_NAME}:${IMAGE_TAG}"
                    
                    echo "ğŸ“‹ é•œåƒæ ‡ç­¾: ${env.IMAGE_TAG}"
                    echo "ğŸ“‹ å®Œæ•´é•œåƒå: ${env.FULL_IMAGE_NAME}"
                }
            }
        }
        
        stage('æ„å»ºå’Œæ¨é€') {
            steps {
                script {
                    def image = docker.build(env.FULL_IMAGE_NAME)
                    
                    docker.withRegistry("https://${REGISTRY}", 'harbor-credentials') {
                        image.push()
                        
                        // ä¸ºä¸»åˆ†æ”¯æ·»åŠ latestæ ‡ç­¾
                        if (env.BRANCH_NAME == 'master') {
                            image.push('latest')
                        }
                    }
                }
            }
        }
    }
}
```

### 7.3 ç‰ˆæœ¬æ¸…ç†ç­–ç•¥


**ğŸ§¹ è‡ªåŠ¨æ¸…ç†æ—§ç‰ˆæœ¬**ï¼š

```bash
#!/bin/bash
# cleanup-images.sh - æ¸…ç†æ—§é•œåƒè„šæœ¬

APP_NAME="myapp"
KEEP_IMAGES=10  # ä¿ç•™æœ€æ–°çš„10ä¸ªé•œåƒ

echo "ğŸ§¹ å¼€å§‹æ¸…ç† $APP_NAME çš„æ—§é•œåƒ..."

# è·å–æ‰€æœ‰é•œåƒï¼ŒæŒ‰æ—¶é—´æ’åº
IMAGES=$(docker images $APP_NAME --format "table {{.Repository}}:{{.Tag}}\t{{.CreatedAt}}" | \
         tail -n +2 | sort -k2 -r | awk '{print $1}')

# è®¡ç®—éœ€è¦åˆ é™¤çš„é•œåƒ
TOTAL_IMAGES=$(echo "$IMAGES" | wc -l)
if [ $TOTAL_IMAGES -gt $KEEP_IMAGES ]; then
    DELETE_COUNT=$((TOTAL_IMAGES - KEEP_IMAGES))
    DELETE_IMAGES=$(echo "$IMAGES" | tail -n $DELETE_COUNT)
    
    echo "ğŸ“Š æ€»é•œåƒæ•°: $TOTAL_IMAGES, ä¿ç•™: $KEEP_IMAGES, åˆ é™¤: $DELETE_COUNT"
    
    for image in $DELETE_IMAGES; do
        echo "ğŸ—‘ï¸  åˆ é™¤é•œåƒ: $image"
        docker rmi $image || true
    done
else
    echo "âœ… é•œåƒæ•°é‡æœªè¶…è¿‡é™åˆ¶ï¼Œæ— éœ€æ¸…ç†"
fi

# æ¸…ç†æ‚¬ç©ºé•œåƒ
echo "ğŸ§¹ æ¸…ç†æ‚¬ç©ºé•œåƒ..."
docker image prune -f

echo "âœ… æ¸…ç†å®Œæˆï¼"
```

### 7.4 ç‰ˆæœ¬å›æ»šæœºåˆ¶


**â†©ï¸ å¿«é€Ÿå›æ»šè„šæœ¬**ï¼š

```bash
#!/bin/bash
# rollback.sh - ç‰ˆæœ¬å›æ»šè„šæœ¬

APP_NAME="myapp"
REGISTRY="harbor.company.com"

# æ˜¾ç¤ºå¯ç”¨ç‰ˆæœ¬
echo "ğŸ“‹ å¯ç”¨çš„é•œåƒç‰ˆæœ¬ï¼š"
docker images ${REGISTRY}/${APP_NAME} --format "table {{.Tag}}\t{{.CreatedAt}}" | head -10

# è·å–ç”¨æˆ·è¾“å…¥
read -p "ğŸ”„ è¯·è¾“å…¥è¦å›æ»šåˆ°çš„ç‰ˆæœ¬æ ‡ç­¾: " ROLLBACK_TAG

if [ -z "$ROLLBACK_TAG" ]; then
    echo "âŒ ç‰ˆæœ¬æ ‡ç­¾ä¸èƒ½ä¸ºç©º"
    exit 1
fi

ROLLBACK_IMAGE="${REGISTRY}/${APP_NAME}:${ROLLBACK_TAG}"

# æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨
if ! docker images | grep "${APP_NAME}" | grep "${ROLLBACK_TAG}"; then
    echo "âŒ é•œåƒ $ROLLBACK_IMAGE ä¸å­˜åœ¨"
    exit 1
fi

echo "ğŸ”„ å¼€å§‹å›æ»šåˆ°ç‰ˆæœ¬: $ROLLBACK_TAG"

# åœæ­¢å½“å‰å®¹å™¨
docker stop $APP_NAME || true
docker rm $APP_NAME || true

# å¯åŠ¨æŒ‡å®šç‰ˆæœ¬
docker run -d \
  --name $APP_NAME \
  -p 8080:8080 \
  --restart=unless-stopped \
  $ROLLBACK_IMAGE

# æ£€æŸ¥çŠ¶æ€
sleep 5
if docker ps | grep $APP_NAME; then
    echo "âœ… å›æ»šæˆåŠŸï¼å½“å‰è¿è¡Œç‰ˆæœ¬: $ROLLBACK_TAG"
else
    echo "âŒ å›æ»šå¤±è´¥ï¼"
    exit 1
fi
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Dockeré›†æˆï¼šè®©Jenkinsè‡ªåŠ¨æ„å»ºã€æ¨é€ã€éƒ¨ç½²Dockeré•œåƒ
ğŸ”¸ Dockerfileï¼šå®šä¹‰å¦‚ä½•æ„å»ºé•œåƒçš„"è£…ä¿®å›¾çº¸"
ğŸ”¸ é•œåƒä»“åº“ï¼šå­˜å‚¨å’Œç®¡ç†é•œåƒç‰ˆæœ¬çš„"ä»“åº“"
ğŸ”¸ å®¹å™¨éƒ¨ç½²ï¼šæŠŠé•œåƒè¿è¡Œæˆå®é™…çš„åº”ç”¨å®¹å™¨
ğŸ”¸ ç‰ˆæœ¬ç®¡ç†ï¼šåˆç†çš„æ ‡ç­¾ç­–ç•¥å’Œç‰ˆæœ¬æ§åˆ¶æœºåˆ¶
```

### 8.2 å®é™…æ“ä½œè¦ç‚¹


**ğŸ”§ ç¯å¢ƒé…ç½®æ£€æŸ¥æ¸…å•**ï¼š
```
âœ… Jenkinså®‰è£…äº†Dockerç›¸å…³æ’ä»¶
âœ… JenkinsæœåŠ¡å™¨å¯ä»¥è®¿é—®DockeræœåŠ¡
âœ… é…ç½®äº†é•œåƒä»“åº“çš„è®¿é—®å‡­æ®
âœ… ç›®æ ‡æœåŠ¡å™¨å®‰è£…äº†Docker
âœ… ç½‘ç»œèƒ½å¤Ÿæ­£å¸¸æ‹‰å–å’Œæ¨é€é•œåƒ
```

**ğŸš€ éƒ¨ç½²æµç¨‹æ ¸å¿ƒæ­¥éª¤**ï¼š
```
1ï¸âƒ£ ä»£ç æäº¤è§¦å‘æ„å»º
2ï¸âƒ£ Jenkinsæ‹‰å–ä»£ç 
3ï¸âƒ£ æ ¹æ®Dockerfileæ„å»ºé•œåƒ
4ï¸âƒ£ ç»™é•œåƒæ‰“ä¸Šç‰ˆæœ¬æ ‡ç­¾
5ï¸âƒ£ æ¨é€é•œåƒåˆ°ä»“åº“
6ï¸âƒ£ åœ¨ç›®æ ‡æœåŠ¡å™¨éƒ¨ç½²å®¹å™¨
7ï¸âƒ£ å¥åº·æ£€æŸ¥ç¡®è®¤éƒ¨ç½²æˆåŠŸ
```

### 8.3 æœ€ä½³å®è·µå»ºè®®


**âš¡ Dockerfileä¼˜åŒ–**ï¼š
- ä½¿ç”¨è½»é‡çº§åŸºç¡€é•œåƒï¼ˆalpineç‰ˆæœ¬ï¼‰
- åˆç†åˆ©ç”¨æ„å»ºç¼“å­˜ï¼ˆä¾èµ–æ–‡ä»¶å…ˆå¤åˆ¶ï¼‰
- å¤šé˜¶æ®µæ„å»ºå‡å°‘é•œåƒä½“ç§¯
- ä½¿ç”¨érootç”¨æˆ·è¿è¡Œåº”ç”¨

**ğŸ·ï¸ ç‰ˆæœ¬ç®¡ç†ç­–ç•¥**ï¼š
- é‡‡ç”¨è¯­ä¹‰åŒ–ç‰ˆæœ¬å·
- ä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒæ ‡ç­¾
- å®šæœŸæ¸…ç†æ—§ç‰ˆæœ¬é•œåƒ
- ä¿ç•™å›æ»šèƒ½åŠ›

**ğŸ”’ å®‰å…¨è€ƒè™‘**ï¼š
- ä¸åœ¨é•œåƒä¸­åŒ…å«æ•æ„Ÿä¿¡æ¯
- ä½¿ç”¨ç§æœ‰é•œåƒä»“åº“
- å®šæœŸæ›´æ–°åŸºç¡€é•œåƒ
- é™åˆ¶å®¹å™¨èµ„æºä½¿ç”¨

**ğŸ” ç›‘æ§å’Œæ—¥å¿—**ï¼š
- å®ç°å¥åº·æ£€æŸ¥æœºåˆ¶
- æ”¶é›†å®¹å™¨è¿è¡Œæ—¥å¿—
- ç›‘æ§èµ„æºä½¿ç”¨æƒ…å†µ
- è®¾ç½®å‘Šè­¦é€šçŸ¥

### 8.4 å¸¸è§é—®é¢˜è§£å†³


**â“ é•œåƒæ„å»ºå¤±è´¥**ï¼š
- æ£€æŸ¥Dockerfileè¯­æ³•
- éªŒè¯åŸºç¡€é•œåƒæ˜¯å¦å¯ç”¨
- ç¡®è®¤æ„å»ºä¸Šä¸‹æ–‡è·¯å¾„
- æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—

**â“ æ¨é€é•œåƒå¤±è´¥**ï¼š
- éªŒè¯ä»“åº“å‡­æ®æ˜¯å¦æ­£ç¡®
- æ£€æŸ¥ç½‘ç»œè¿æ¥
- ç¡®è®¤é•œåƒæ ‡ç­¾æ ¼å¼
- éªŒè¯ä»“åº“æƒé™

**â“ å®¹å™¨å¯åŠ¨å¤±è´¥**ï¼š
- æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
- éªŒè¯ç¯å¢ƒå˜é‡é…ç½®
- æŸ¥çœ‹å®¹å™¨å¯åŠ¨æ—¥å¿—
- ç¡®è®¤é•œåƒå®Œæ•´æ€§

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- Dockeré›†æˆéƒ¨ç½²è¦é…å¥½æ’ä»¶
- Dockerfileå°±æ˜¯è£…ä¿®å›¾çº¸
- é•œåƒæ¨é€éœ€è¦å‡­æ®å’Œä»“åº“
- å®¹å™¨éƒ¨ç½²è¦æœ‰å¥åº·æ£€æŸ¥
- ç‰ˆæœ¬ç®¡ç†ç­–ç•¥å¾ˆé‡è¦