---
title: 4ã€Pipelineé«˜çº§ç‰¹æ€§
---
## ğŸ“š ç›®å½•

1. [å¹¶è¡Œæ‰§è¡Œparallel](#1-å¹¶è¡Œæ‰§è¡Œparallel)
2. [æ¡ä»¶åˆ¤æ–­when](#2-æ¡ä»¶åˆ¤æ–­when)
3. [å‚æ•°åŒ–Pipeline](#3-å‚æ•°åŒ–Pipeline)
4. [åŠ¨æ€é˜¶æ®µç”Ÿæˆ](#4-åŠ¨æ€é˜¶æ®µç”Ÿæˆ)
5. [é”™è¯¯å¤„ç†ä¸é‡è¯•](#5-é”™è¯¯å¤„ç†ä¸é‡è¯•)
6. [Pipelineåº“ä½¿ç”¨](#6-Pipelineåº“ä½¿ç”¨)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. âš¡ å¹¶è¡Œæ‰§è¡Œparallel


### 1.1 ä»€ä¹ˆæ˜¯å¹¶è¡Œæ‰§è¡Œ


**ğŸ”¸ åŸºæœ¬æ¦‚å¿µ**
```
å¹¶è¡Œæ‰§è¡Œå°±æ˜¯åŒæ—¶è¿è¡Œå¤šä¸ªä»»åŠ¡ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªæ¥ä¸€ä¸ªåœ°æ‰§è¡Œ
å°±åƒä½ å¯ä»¥ä¸€è¾¹ç…®é¥­ä¸€è¾¹ç‚’èœï¼Œè€Œä¸ç”¨ç­‰ç…®å¥½é¥­å†ç‚’èœ

ä¸²è¡Œæ‰§è¡Œï¼ˆä¸€ä¸ªæ¥ä¸€ä¸ªï¼‰ï¼š
æµ‹è¯• â†’ æ„å»º â†’ éƒ¨ç½²   ï¼ˆæ€»è€—æ—¶ï¼š6åˆ†é’Ÿï¼‰

å¹¶è¡Œæ‰§è¡Œï¼ˆåŒæ—¶è¿›è¡Œï¼‰ï¼š
æµ‹è¯• â”
     â”œâ†’ æœ€ç»ˆéƒ¨ç½²     ï¼ˆæ€»è€—æ—¶ï¼š3åˆ†é’Ÿï¼‰
æ„å»º â”˜
```

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦å¹¶è¡Œæ‰§è¡Œ**
- **æé«˜æ•ˆç‡**ï¼šå¤šä¸ªç‹¬ç«‹ä»»åŠ¡åŒæ—¶æ‰§è¡Œï¼ŒèŠ‚çœæ—¶é—´
- **èµ„æºåˆ©ç”¨**ï¼šå……åˆ†åˆ©ç”¨å¤šæ ¸CPUå’Œå¤šå°æœåŠ¡å™¨
- **å¿«é€Ÿåé¦ˆ**ï¼šæ›´å¿«å‘ç°é—®é¢˜ï¼Œç¼©çŸ­å¼€å‘å‘¨æœŸ

### 1.2 parallelè¯­æ³•è¯¦è§£


**ğŸ”§ åŸºç¡€è¯­æ³•ç»“æ„**
```groovy
pipeline {
    agent any
    stages {
        stage('å¹¶è¡Œé˜¶æ®µ') {
            parallel {
                stage('ä»»åŠ¡A') {
                    steps {
                        echo 'æ‰§è¡Œä»»åŠ¡A'
                        sleep 30  // æ¨¡æ‹Ÿ30ç§’çš„å·¥ä½œ
                    }
                }
                stage('ä»»åŠ¡B') {
                    steps {
                        echo 'æ‰§è¡Œä»»åŠ¡B'
                        sleep 20  // æ¨¡æ‹Ÿ20ç§’çš„å·¥ä½œ
                    }
                }
            }
        }
    }
}
```

### 1.3 å®é™…åº”ç”¨åœºæ™¯


**ğŸ¯ å¤šç¯å¢ƒéƒ¨ç½²**
```groovy
stage('éƒ¨ç½²åˆ°å¤šç¯å¢ƒ') {
    parallel {
        stage('éƒ¨ç½²æµ‹è¯•ç¯å¢ƒ') {
            steps {
                echo 'éƒ¨ç½²åˆ°æµ‹è¯•æœåŠ¡å™¨'
                // éƒ¨ç½²å‘½ä»¤
                sh 'deploy-to-test.sh'
            }
        }
        stage('éƒ¨ç½²é¢„å‘ç¯å¢ƒ') {
            steps {
                echo 'éƒ¨ç½²åˆ°é¢„å‘æœåŠ¡å™¨'
                // éƒ¨ç½²å‘½ä»¤
                sh 'deploy-to-staging.sh'
            }
        }
    }
}
```

**ğŸ§ª å¤šç±»å‹æµ‹è¯•**
```groovy
stage('å¹¶è¡Œæµ‹è¯•') {
    parallel {
        stage('å•å…ƒæµ‹è¯•') {
            steps {
                sh 'npm run test:unit'
                publishTestResults testResultsPattern: 'test-results/unit/*.xml'
            }
        }
        stage('é›†æˆæµ‹è¯•') {
            steps {
                sh 'npm run test:integration'
                publishTestResults testResultsPattern: 'test-results/integration/*.xml'
            }
        }
        stage('æ€§èƒ½æµ‹è¯•') {
            steps {
                sh 'npm run test:performance'
                publishTestResults testResultsPattern: 'test-results/performance/*.xml'
            }
        }
    }
}
```

### 1.4 å¹¶è¡Œæ‰§è¡Œæœ€ä½³å®è·µ


**âš¡ æ€§èƒ½ä¼˜åŒ–å»ºè®®**
```
èµ„æºåˆ†é…åŸåˆ™ï¼š
â€¢ ç¡®ä¿æœ‰è¶³å¤Ÿçš„æ‰§è¡Œå™¨ï¼ˆexecutorï¼‰
â€¢ åˆç†åˆ†é…CPUå’Œå†…å­˜èµ„æº
â€¢ é¿å…ç£ç›˜IOå†²çª

ä»»åŠ¡åˆ’åˆ†åŸåˆ™ï¼š
â€¢ é€‰æ‹©ç›¸äº’ç‹¬ç«‹çš„ä»»åŠ¡
â€¢ é¿å…å…±äº«èµ„æºå†²çª
â€¢ è€ƒè™‘ä»»åŠ¡æ‰§è¡Œæ—¶é—´å¹³è¡¡
```

---

## 2. ğŸ¯ æ¡ä»¶åˆ¤æ–­when


### 2.1 whenæŒ‡ä»¤åŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯whenæŒ‡ä»¤**
```
whenæŒ‡ä»¤å°±åƒç”Ÿæ´»ä¸­çš„"å¦‚æœ...é‚£ä¹ˆ..."åˆ¤æ–­
åªæœ‰æ»¡è¶³ç‰¹å®šæ¡ä»¶æ—¶ï¼Œæ‰æ‰§è¡ŒæŸä¸ªé˜¶æ®µ

æ¯”å¦‚ï¼š
- å¦‚æœæ˜¯ä¸»åˆ†æ”¯ï¼Œæ‰éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
- å¦‚æœæ˜¯å·¥ä½œæ—¥ï¼Œæ‰å‘é€é€šçŸ¥
- å¦‚æœæµ‹è¯•é€šè¿‡ï¼Œæ‰è¿›è¡Œä¸‹ä¸€æ­¥
```

**ğŸ’¡ whenæŒ‡ä»¤çš„ä½œç”¨**
- **æ¡ä»¶æ‰§è¡Œ**ï¼šæ ¹æ®ä¸åŒæƒ…å†µæ‰§è¡Œä¸åŒé€»è¾‘
- **èµ„æºèŠ‚çº¦**ï¼šè·³è¿‡ä¸éœ€è¦çš„æ­¥éª¤
- **æµç¨‹æ§åˆ¶**ï¼šå®ç°å¤æ‚çš„æ„å»ºé€»è¾‘

### 2.2 å¸¸ç”¨whenæ¡ä»¶


**ğŸŒ¿ åˆ†æ”¯æ¡ä»¶åˆ¤æ–­**
```groovy
stage('ç”Ÿäº§éƒ¨ç½²') {
    when {
        branch 'main'  // åªåœ¨mainåˆ†æ”¯æ‰§è¡Œ
    }
    steps {
        echo 'éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ'
        sh 'deploy-to-production.sh'
    }
}

stage('å¼€å‘ç¯å¢ƒéƒ¨ç½²') {
    when {
        not { branch 'main' }  // émainåˆ†æ”¯æ‰§è¡Œ
    }
    steps {
        echo 'éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ'
        sh 'deploy-to-dev.sh'
    }
}
```

**ğŸ·ï¸ æ ‡ç­¾æ¡ä»¶åˆ¤æ–­**
```groovy
stage('å‘å¸ƒç‰ˆæœ¬') {
    when {
        tag 'v*'  // åªæœ‰æ‰“äº†ç‰ˆæœ¬æ ‡ç­¾æ‰æ‰§è¡Œ
    }
    steps {
        echo 'åˆ›å»ºæ­£å¼å‘å¸ƒç‰ˆæœ¬'
        sh 'create-release.sh'
    }
}
```

**ğŸŒ ç¯å¢ƒå˜é‡åˆ¤æ–­**
```groovy
stage('å‘é€é€šçŸ¥') {
    when {
        environment name: 'DEPLOY_ENV', value: 'production'
    }
    steps {
        echo 'å‘é€ç”Ÿäº§éƒ¨ç½²é€šçŸ¥'
        sh 'send-notification.sh'
    }
}
```

### 2.3 å¤åˆæ¡ä»¶åˆ¤æ–­


**ğŸ”— å¤šæ¡ä»¶ç»„åˆ**
```groovy
stage('å®‰å…¨æ£€æŸ¥') {
    when {
        allOf {
            branch 'main'
            environment name: 'SECURITY_SCAN', value: 'true'
        }
    }
    steps {
        echo 'æ‰§è¡Œå®‰å…¨æ‰«æ'
        sh 'security-scan.sh'
    }
}

stage('å¿«é€Ÿæ„å»º') {
    when {
        anyOf {
            branch 'develop'
            branch 'feature/*'
        }
    }
    steps {
        echo 'æ‰§è¡Œå¿«é€Ÿæ„å»º'
        sh 'quick-build.sh'
    }
}
```

### 2.4 whenæ¡ä»¶ç±»å‹å¯¹æ¯”


| æ¡ä»¶ç±»å‹ | **è¯­æ³•ç¤ºä¾‹** | **ä½¿ç”¨åœºæ™¯** | **è¯´æ˜** |
|---------|------------|-------------|----------|
| `branch` | `branch 'main'` | ç‰¹å®šåˆ†æ”¯æ‰§è¡Œ | æœ€å¸¸ç”¨çš„æ¡ä»¶ |
| `tag` | `tag 'v*'` | ç‰ˆæœ¬å‘å¸ƒ | æ ¹æ®Gitæ ‡ç­¾åˆ¤æ–­ |
| `environment` | `environment name: 'ENV', value: 'prod'` | ç¯å¢ƒå˜é‡åˆ¤æ–­ | çµæ´»çš„æ¡ä»¶æ§åˆ¶ |
| `expression` | `expression { return params.DEPLOY }` | è‡ªå®šä¹‰é€»è¾‘ | æœ€çµæ´»çš„æ¡ä»¶ |
| `changeRequest` | `changeRequest()` | PR/MRè§¦å‘ | ä»£ç å®¡æŸ¥æµç¨‹ |

---

## 3. âš™ï¸ å‚æ•°åŒ–Pipeline


### 3.1 å‚æ•°åŒ–çš„åŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯å‚æ•°åŒ–Pipeline**
```
å‚æ•°åŒ–å°±æ˜¯è®©Pipelineå¯ä»¥æ¥æ”¶å¤–éƒ¨è¾“å…¥ï¼Œå°±åƒå‡½æ•°å¯ä»¥æ¥æ”¶å‚æ•°ä¸€æ ·

æ²¡æœ‰å‚æ•°åŒ–ï¼š
æ¯æ¬¡æ„å»ºéƒ½åšç›¸åŒçš„äº‹æƒ…

æœ‰äº†å‚æ•°åŒ–ï¼š
å¯ä»¥é€‰æ‹©éƒ¨ç½²ç¯å¢ƒã€ç‰ˆæœ¬å·ã€æ˜¯å¦è·³è¿‡æµ‹è¯•ç­‰
è®©Pipelineæ›´åŠ çµæ´»å’Œå¯å¤ç”¨
```

**ğŸ’¡ å‚æ•°åŒ–çš„å¥½å¤„**
- **çµæ´»æ€§**ï¼šåŒä¸€ä¸ªPipelineé€‚ç”¨äºä¸åŒåœºæ™¯
- **ç”¨æˆ·å‹å¥½**ï¼šæä¾›ç•Œé¢é€‰æ‹©ï¼Œæ— éœ€ä¿®æ”¹ä»£ç 
- **å¯å¤ç”¨**ï¼šä¸€å¥—ä»£ç ï¼Œå¤šç§ç”¨æ³•

### 3.2 å‚æ•°ç±»å‹è¯¦è§£


**ğŸ“ å­—ç¬¦ä¸²å‚æ•°**
```groovy
pipeline {
    agent any
    parameters {
        string(
            name: 'DEPLOY_ENV',
            defaultValue: 'dev',
            description: 'éƒ¨ç½²ç¯å¢ƒï¼ˆdev/test/prodï¼‰'
        )
        string(
            name: 'VERSION',
            defaultValue: '1.0.0',
            description: 'ç‰ˆæœ¬å·'
        )
    }
    
    stages {
        stage('éƒ¨ç½²') {
            steps {
                echo "éƒ¨ç½²ç‰ˆæœ¬ ${params.VERSION} åˆ° ${params.DEPLOY_ENV} ç¯å¢ƒ"
                sh "deploy.sh ${params.VERSION} ${params.DEPLOY_ENV}"
            }
        }
    }
}
```

**â˜‘ï¸ å¸ƒå°”å‚æ•°**
```groovy
parameters {
    booleanParam(
        name: 'SKIP_TESTS',
        defaultValue: false,
        description: 'æ˜¯å¦è·³è¿‡æµ‹è¯•'
    )
    booleanParam(
        name: 'SEND_NOTIFICATION',
        defaultValue: true,
        description: 'æ˜¯å¦å‘é€é€šçŸ¥'
    )
}

stages {
    stage('æµ‹è¯•') {
        when {
            not { params.SKIP_TESTS }
        }
        steps {
            echo 'æ‰§è¡Œæµ‹è¯•'
            sh 'npm test'
        }
    }
}
```

**ğŸ“‹ é€‰æ‹©å‚æ•°**
```groovy
parameters {
    choice(
        name: 'DEPLOY_STRATEGY',
        choices: ['rolling', 'blue-green', 'canary'],
        description: 'éƒ¨ç½²ç­–ç•¥'
    )
}

stages {
    stage('éƒ¨ç½²') {
        steps {
            script {
                switch(params.DEPLOY_STRATEGY) {
                    case 'rolling':
                        sh 'rolling-deploy.sh'
                        break
                    case 'blue-green':
                        sh 'blue-green-deploy.sh'
                        break
                    case 'canary':
                        sh 'canary-deploy.sh'
                        break
                }
            }
        }
    }
}
```

### 3.3 å‚æ•°éªŒè¯ä¸å¤„ç†


**âœ… è¾“å…¥éªŒè¯**
```groovy
stage('å‚æ•°éªŒè¯') {
    steps {
        script {
            // éªŒè¯ç¯å¢ƒå‚æ•°
            if (!['dev', 'test', 'prod'].contains(params.DEPLOY_ENV)) {
                error "æ— æ•ˆçš„éƒ¨ç½²ç¯å¢ƒ: ${params.DEPLOY_ENV}"
            }
            
            // éªŒè¯ç‰ˆæœ¬å·æ ¼å¼
            if (!params.VERSION.matches(/^\d+\.\d+\.\d+$/)) {
                error "ç‰ˆæœ¬å·æ ¼å¼é”™è¯¯: ${params.VERSION}ï¼Œåº”è¯¥æ˜¯ x.y.z æ ¼å¼"
            }
            
            echo "å‚æ•°éªŒè¯é€šè¿‡"
        }
    }
}
```

---

## 4. ğŸ”„ åŠ¨æ€é˜¶æ®µç”Ÿæˆ


### 4.1 åŠ¨æ€é˜¶æ®µçš„æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯åŠ¨æ€é˜¶æ®µç”Ÿæˆ**
```
åŠ¨æ€é˜¶æ®µå°±æ˜¯æ ¹æ®å®é™…æƒ…å†µè‡ªåŠ¨åˆ›å»ºPipelineé˜¶æ®µ
å°±åƒæ ¹æ®ä»Šå¤©æœ‰å‡ ä¸ªå¿«é€’ï¼ŒåŠ¨æ€å†³å®šè·‘å‡ è¶Ÿä¸€æ ·

é™æ€é˜¶æ®µï¼š
å†™æ­»äº†3ä¸ªéƒ¨ç½²é˜¶æ®µï¼ˆdevã€testã€prodï¼‰

åŠ¨æ€é˜¶æ®µï¼š
æ ¹æ®é…ç½®æ–‡ä»¶æˆ–å‚æ•°ï¼Œè‡ªåŠ¨ç”Ÿæˆéœ€è¦çš„é˜¶æ®µ
å¯èƒ½æ˜¯2ä¸ªç¯å¢ƒï¼Œä¹Ÿå¯èƒ½æ˜¯5ä¸ªç¯å¢ƒ
```

**ğŸ’¡ åŠ¨æ€é˜¶æ®µçš„ä¼˜åŠ¿**
- **çµæ´»æ€§**ï¼šæ ¹æ®é¡¹ç›®éœ€æ±‚è‡ªåŠ¨è°ƒæ•´
- **å¯ç»´æŠ¤æ€§**ï¼šå‡å°‘é‡å¤ä»£ç 
- **æ‰©å±•æ€§**ï¼šæ–°å¢ç¯å¢ƒæ— éœ€ä¿®æ”¹Pipeline

### 4.2 åŸºäºåˆ—è¡¨çš„åŠ¨æ€ç”Ÿæˆ


**ğŸ“‹ å¤šç¯å¢ƒåŠ¨æ€éƒ¨ç½²**
```groovy
pipeline {
    agent any
    
    stages {
        stage('åŠ¨æ€éƒ¨ç½²') {
            steps {
                script {
                    // å®šä¹‰è¦éƒ¨ç½²çš„ç¯å¢ƒåˆ—è¡¨
                    def environments = ['dev', 'test', 'staging', 'prod']
                    
                    // ä¸ºæ¯ä¸ªç¯å¢ƒåˆ›å»ºéƒ¨ç½²ä»»åŠ¡
                    def deployStages = [:]
                    
                    environments.each { env ->
                        deployStages["éƒ¨ç½²åˆ°${env}"] = {
                            echo "å¼€å§‹éƒ¨ç½²åˆ° ${env} ç¯å¢ƒ"
                            sh "deploy-to-${env}.sh"
                            echo "${env} ç¯å¢ƒéƒ¨ç½²å®Œæˆ"
                        }
                    }
                    
                    // å¹¶è¡Œæ‰§è¡Œæ‰€æœ‰éƒ¨ç½²
                    parallel deployStages
                }
            }
        }
    }
}
```

### 4.3 åŸºäºé…ç½®æ–‡ä»¶çš„åŠ¨æ€ç”Ÿæˆ


**ğŸ“„ é…ç½®é©±åŠ¨çš„Pipeline**
```groovy
stage('é…ç½®é©±åŠ¨éƒ¨ç½²') {
    steps {
        script {
            // è¯»å–é…ç½®æ–‡ä»¶
            def config = readJSON file: 'deploy-config.json'
            
            def deployStages = [:]
            
            config.environments.each { envConfig ->
                deployStages["${envConfig.name}éƒ¨ç½²"] = {
                    echo "éƒ¨ç½²åˆ° ${envConfig.name}"
                    echo "æœåŠ¡å™¨: ${envConfig.server}"
                    echo "ç«¯å£: ${envConfig.port}"
                    
                    sh """
                        deploy.sh \\
                            --env ${envConfig.name} \\
                            --server ${envConfig.server} \\
                            --port ${envConfig.port}
                    """
                }
            }
            
            parallel deployStages
        }
    }
}
```

**é…ç½®æ–‡ä»¶ç¤ºä¾‹ (deploy-config.json)**
```json
{
    "environments": [
        {
            "name": "development",
            "server": "dev.company.com",
            "port": 8080
        },
        {
            "name": "testing",
            "server": "test.company.com",
            "port": 8081
        }
    ]
}
```

---

## 5. ğŸ›¡ï¸ é”™è¯¯å¤„ç†ä¸é‡è¯•


### 5.1 é”™è¯¯å¤„ç†åŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ ä¸ºä»€ä¹ˆéœ€è¦é”™è¯¯å¤„ç†**
```
åœ¨ç°å®ä¸­ï¼Œäº‹æƒ…ä¸æ€»æ˜¯æŒ‰è®¡åˆ’è¿›è¡Œï¼š
- ç½‘ç»œå¯èƒ½çªç„¶æ–­å¼€
- æœåŠ¡å™¨å¯èƒ½ä¸´æ—¶ç¹å¿™
- ä¾èµ–æœåŠ¡å¯èƒ½æš‚æ—¶ä¸å¯ç”¨

æ²¡æœ‰é”™è¯¯å¤„ç†ï¼šä¸€å‡ºé”™å°±å¤±è´¥ï¼Œéœ€è¦æ‰‹åŠ¨é‡æ–°å¼€å§‹
æœ‰äº†é”™è¯¯å¤„ç†ï¼šè‡ªåŠ¨é‡è¯•ï¼Œä¼˜é›…é™çº§ï¼Œæä¾›è¯¦ç»†ä¿¡æ¯
```

### 5.2 try-catché”™è¯¯æ•è·


**ğŸ¯ åŸºç¡€é”™è¯¯å¤„ç†**
```groovy
stage('å¯èƒ½å¤±è´¥çš„ä»»åŠ¡') {
    steps {
        script {
            try {
                // å¯èƒ½å¤±è´¥çš„æ“ä½œ
                sh 'risky-operation.sh'
                echo 'æ“ä½œæˆåŠŸå®Œæˆ'
            } catch (Exception e) {
                // å¤„ç†é”™è¯¯
                echo "æ“ä½œå¤±è´¥: ${e.getMessage()}"
                echo 'å°è¯•å¤‡ç”¨æ–¹æ¡ˆ'
                sh 'backup-operation.sh'
            }
        }
    }
}
```

**ğŸ“§ é”™è¯¯é€šçŸ¥å¤„ç†**
```groovy
stage('éƒ¨ç½²') {
    steps {
        script {
            try {
                sh 'deploy.sh'
                // æˆåŠŸé€šçŸ¥
                sh 'send-success-notification.sh'
            } catch (Exception e) {
                // å¤±è´¥é€šçŸ¥
                echo "éƒ¨ç½²å¤±è´¥: ${e.getMessage()}"
                sh """
                    echo "éƒ¨ç½²å¤±è´¥åŸå› : ${e.getMessage()}" | \\
                    mail -s "éƒ¨ç½²å¤±è´¥" team@company.com
                """
                // é‡æ–°æŠ›å‡ºé”™è¯¯ï¼Œè®©Pipelineå¤±è´¥
                throw e
            }
        }
    }
}
```

### 5.3 é‡è¯•æœºåˆ¶


**ğŸ”„ ç®€å•é‡è¯•**
```groovy
stage('é‡è¯•ç¤ºä¾‹') {
    steps {
        retry(3) {
            // æœ€å¤šé‡è¯•3æ¬¡
            sh 'unreliable-command.sh'
        }
    }
}
```

**â° å¸¦å»¶è¿Ÿçš„é‡è¯•**
```groovy
stage('æ™ºèƒ½é‡è¯•') {
    steps {
        script {
            def maxRetries = 3
            def retryCount = 0
            def success = false
            
            while (retryCount < maxRetries && !success) {
                try {
                    retryCount++
                    echo "å°è¯•ç¬¬ ${retryCount} æ¬¡"
                    
                    sh 'flaky-service-call.sh'
                    success = true
                    echo 'æ“ä½œæˆåŠŸ'
                    
                } catch (Exception e) {
                    echo "ç¬¬ ${retryCount} æ¬¡å°è¯•å¤±è´¥: ${e.getMessage()}"
                    
                    if (retryCount < maxRetries) {
                        echo "ç­‰å¾… ${retryCount * 10} ç§’åé‡è¯•"
                        sleep(retryCount * 10)  // é€’å¢å»¶è¿Ÿ
                    } else {
                        echo 'é‡è¯•æ¬¡æ•°ç”¨å°½ï¼Œæ“ä½œå¤±è´¥'
                        throw e
                    }
                }
            }
        }
    }
}
```

### 5.4 é”™è¯¯å¤„ç†ç­–ç•¥å¯¹æ¯”


| ç­–ç•¥ç±»å‹ | **é€‚ç”¨åœºæ™¯** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** |
|---------|-------------|---------|---------|
| **å¿½ç•¥é”™è¯¯** | éå…³é”®æ­¥éª¤ | æµç¨‹ç»§ç»­æ‰§è¡Œ | å¯èƒ½æ©ç›–é—®é¢˜ |
| **ç«‹å³å¤±è´¥** | å…³é”®æ­¥éª¤ | é—®é¢˜æš´éœ²åŠæ—¶ | ç¼ºä¹çµæ´»æ€§ |
| **é‡è¯•æœºåˆ¶** | ç½‘ç»œè°ƒç”¨ã€ä¸´æ—¶æ•…éšœ | æé«˜æˆåŠŸç‡ | å¯èƒ½å»¶é•¿æ‰§è¡Œæ—¶é—´ |
| **é™çº§å¤„ç†** | æœ‰å¤‡ç”¨æ–¹æ¡ˆ | ä¿è¯åŸºæœ¬åŠŸèƒ½ | åŠŸèƒ½å¯èƒ½å—é™ |

---

## 6. ğŸ“š Pipelineåº“ä½¿ç”¨


### 6.1 Pipelineåº“çš„æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯Pipelineåº“**
```
Pipelineåº“å°±åƒæ˜¯ä¸€ä¸ªå·¥å…·ç®±ï¼Œé‡Œé¢è£…ç€å¸¸ç”¨çš„å·¥å…·ï¼ˆå‡½æ•°ï¼‰
ä½ å¯ä»¥åœ¨ä¸åŒçš„é¡¹ç›®ä¸­é‡å¤ä½¿ç”¨è¿™äº›å·¥å…·ï¼Œè€Œä¸ç”¨æ¯æ¬¡éƒ½é‡æ–°åˆ¶é€ 

æ²¡æœ‰åº“ï¼šæ¯ä¸ªé¡¹ç›®éƒ½è¦å†™ä¸€ééƒ¨ç½²ã€æµ‹è¯•ã€é€šçŸ¥çš„ä»£ç 
æœ‰äº†åº“ï¼šå†™ä¸€æ¬¡ï¼Œåˆ°å¤„ä½¿ç”¨ï¼Œè¿˜èƒ½é›†ä¸­ç»´æŠ¤å’Œæ›´æ–°
```

**ğŸ’¡ ä½¿ç”¨Pipelineåº“çš„å¥½å¤„**
- **ä»£ç å¤ç”¨**ï¼šé¿å…é‡å¤é€ è½®å­
- **æ ‡å‡†åŒ–**ï¼šç»Ÿä¸€çš„æ“ä½œæµç¨‹
- **ç»´æŠ¤æ€§**ï¼šé›†ä¸­ç»´æŠ¤ï¼Œç»Ÿä¸€æ›´æ–°
- **å›¢é˜Ÿåä½œ**ï¼šå…±äº«æœ€ä½³å®è·µ

### 6.2 åˆ›å»ºå…±äº«åº“


**ğŸ“ åº“æ–‡ä»¶ç»“æ„**
```
jenkins-shared-library/
â”œâ”€â”€ vars/                    # å…¨å±€å˜é‡å’Œå‡½æ•°
â”‚   â”œâ”€â”€ deployApp.groovy     # éƒ¨ç½²å‡½æ•°
â”‚   â”œâ”€â”€ sendNotification.groovy  # é€šçŸ¥å‡½æ•°
â”‚   â””â”€â”€ runTests.groovy      # æµ‹è¯•å‡½æ•°
â”œâ”€â”€ src/                     # å¤æ‚ç±»æ–‡ä»¶
â”‚   â””â”€â”€ com/company/
â”‚       â””â”€â”€ jenkins/
â”‚           â””â”€â”€ DeployUtils.groovy
â””â”€â”€ resources/               # èµ„æºæ–‡ä»¶
    â””â”€â”€ templates/
        â””â”€â”€ notification.html
```

### 6.3 ç¼–å†™åº“å‡½æ•°


**ğŸ”§ éƒ¨ç½²å‡½æ•°ç¤ºä¾‹ (vars/deployApp.groovy)**
```groovy
def call(Map config) {
    // å‚æ•°éªŒè¯
    if (!config.environment) {
        error 'å¿…é¡»æŒ‡å®šéƒ¨ç½²ç¯å¢ƒ'
    }
    
    echo "å¼€å§‹éƒ¨ç½²åº”ç”¨åˆ° ${config.environment} ç¯å¢ƒ"
    
    // éƒ¨ç½²å‰æ£€æŸ¥
    stage('éƒ¨ç½²å‰æ£€æŸ¥') {
        sh 'health-check.sh'
    }
    
    // æ‰§è¡Œéƒ¨ç½²
    stage('æ‰§è¡Œéƒ¨ç½²') {
        sh """
            deploy.sh \\
                --env ${config.environment} \\
                --version ${config.version ?: 'latest'} \\
                --timeout ${config.timeout ?: 300}
        """
    }
    
    // éƒ¨ç½²åéªŒè¯
    stage('éƒ¨ç½²éªŒè¯') {
        sh 'verify-deployment.sh'
        echo "éƒ¨ç½²åˆ° ${config.environment} å®Œæˆ"
    }
}
```

**ğŸ“§ é€šçŸ¥å‡½æ•°ç¤ºä¾‹ (vars/sendNotification.groovy)**
```groovy
def call(String status, String message = '') {
    def color = status == 'SUCCESS' ? 'green' : 'red'
    def emoji = status == 'SUCCESS' ? 'âœ…' : 'âŒ'
    
    def notification = """
        ${emoji} Pipeline ${status}
        
        é¡¹ç›®: ${env.JOB_NAME}
        åˆ†æ”¯: ${env.BRANCH_NAME}
        æ„å»ºå·: ${env.BUILD_NUMBER}
        
        ${message}
        
        æŸ¥çœ‹è¯¦æƒ…: ${env.BUILD_URL}
    """
    
    // å‘é€åˆ°Slack
    sh """
        curl -X POST -H 'Content-type: application/json' \\
            --data '{"text":"${notification}"}' \\
            ${env.SLACK_WEBHOOK_URL}
    """
}
```

### 6.4 åœ¨Pipelineä¸­ä½¿ç”¨åº“


**ğŸ“– åº“çš„åŠ è½½å’Œä½¿ç”¨**
```groovy
@Library('jenkins-shared-library') _

pipeline {
    agent any
    
    stages {
        stage('æµ‹è¯•') {
            steps {
                runTests(type: 'unit')
            }
        }
        
        stage('éƒ¨ç½²') {
            steps {
                deployApp(
                    environment: 'production',
                    version: '1.2.3',
                    timeout: 600
                )
            }
        }
    }
    
    post {
        success {
            sendNotification('SUCCESS', 'åº”ç”¨æˆåŠŸéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ')
        }
        failure {
            sendNotification('FAILURE', 'éƒ¨ç½²è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯')
        }
    }
}
```

### 6.5 åº“çš„ç‰ˆæœ¬ç®¡ç†


**ğŸ·ï¸ ä½¿ç”¨ç‰¹å®šç‰ˆæœ¬**
```groovy
// ä½¿ç”¨ç‰¹å®šåˆ†æ”¯
@Library('jenkins-shared-library@develop') _

// ä½¿ç”¨ç‰¹å®šæ ‡ç­¾
@Library('jenkins-shared-library@v1.2.0') _

// ä½¿ç”¨ç‰¹å®šæäº¤
@Library('jenkins-shared-library@a1b2c3d') _
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å¹¶è¡Œæ‰§è¡Œï¼šåŒæ—¶è¿è¡Œå¤šä¸ªç‹¬ç«‹ä»»åŠ¡ï¼Œæé«˜æ•ˆç‡
ğŸ”¸ æ¡ä»¶åˆ¤æ–­ï¼šæ ¹æ®ä¸åŒæƒ…å†µæ‰§è¡Œä¸åŒé€»è¾‘ï¼Œå®ç°çµæ´»æ§åˆ¶
ğŸ”¸ å‚æ•°åŒ–ï¼šè®©Pipelineæ¥æ”¶å¤–éƒ¨è¾“å…¥ï¼Œæé«˜å¤ç”¨æ€§
ğŸ”¸ åŠ¨æ€é˜¶æ®µï¼šæ ¹æ®å®é™…æƒ…å†µè‡ªåŠ¨ç”ŸæˆPipelineé˜¶æ®µ
ğŸ”¸ é”™è¯¯å¤„ç†ï¼šä¼˜é›…å¤„ç†å¼‚å¸¸æƒ…å†µï¼Œæé«˜Pipelineç¨³å®šæ€§
ğŸ”¸ Pipelineåº“ï¼šä»£ç å¤ç”¨å’Œæ ‡å‡†åŒ–çš„æœ€ä½³å®è·µ
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å¹¶è¡Œæ‰§è¡Œçš„ä½¿ç”¨æ—¶æœº**
```
é€‚ç”¨åœºæ™¯ï¼š
âœ… ç‹¬ç«‹çš„æµ‹è¯•ä»»åŠ¡ï¼ˆå•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ï¼‰
âœ… å¤šç¯å¢ƒéƒ¨ç½²ï¼ˆå¼€å‘ã€æµ‹è¯•ç¯å¢ƒï¼‰
âœ… ä¸åŒç±»å‹çš„ä»£ç æ£€æŸ¥

é¿å…åœºæ™¯ï¼š
âŒ æœ‰ä¾èµ–å…³ç³»çš„ä»»åŠ¡
âŒ å…±äº«èµ„æºçš„æ“ä½œ
âŒ é¡ºåºæ•æ„Ÿçš„æµç¨‹
```

**ğŸ”¹ whenæ¡ä»¶çš„é€‰æ‹©åŸåˆ™**
```
åˆ†æ”¯åˆ¤æ–­ï¼šç”¨äºä¸åŒåˆ†æ”¯çš„å·®å¼‚åŒ–å¤„ç†
ç¯å¢ƒå˜é‡ï¼šç”¨äºé…ç½®é©±åŠ¨çš„æµç¨‹æ§åˆ¶
è¡¨è¾¾å¼ï¼šç”¨äºå¤æ‚çš„è‡ªå®šä¹‰é€»è¾‘
æ ‡ç­¾åˆ¤æ–­ï¼šç”¨äºç‰ˆæœ¬å‘å¸ƒæµç¨‹
```

**ğŸ”¹ é”™è¯¯å¤„ç†çš„å±‚æ¬¡**
```
é¢„é˜²ä¸ºä¸»ï¼š
- å‚æ•°éªŒè¯
- ç¯å¢ƒæ£€æŸ¥
- ä¾èµ–ç¡®è®¤

å¤„ç†å¼‚å¸¸ï¼š
- try-catchæ•è·
- é‡è¯•æœºåˆ¶
- é™çº§æ–¹æ¡ˆ

äº‹åé€šçŸ¥ï¼š
- é”™è¯¯æ—¥å¿—
- å›¢é˜Ÿé€šçŸ¥
- çŠ¶æ€æ›´æ–°
```

### 7.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ æ€§èƒ½ä¼˜åŒ–å»ºè®®**
- **åˆç†ä½¿ç”¨å¹¶è¡Œ**ï¼šè¯†åˆ«å¯ä»¥å¹¶è¡Œçš„ä»»åŠ¡
- **æ¡ä»¶ä¼˜åŒ–**ï¼šé¿å…ä¸å¿…è¦çš„æ­¥éª¤æ‰§è¡Œ
- **èµ„æºç®¡ç†**ï¼šåˆç†åˆ†é…æ‰§è¡Œå™¨èµ„æº
- **ç¼“å­˜åˆ©ç”¨**ï¼šé‡ç”¨æ„å»ºäº§ç‰©å’Œä¾èµ–

**ğŸ› ï¸ æœ€ä½³å®è·µ**
- **å‚æ•°éªŒè¯**ï¼šå§‹ç»ˆéªŒè¯è¾“å…¥å‚æ•°çš„æœ‰æ•ˆæ€§
- **é”™è¯¯ä¿¡æ¯**ï¼šæä¾›æ¸…æ™°çš„é”™è¯¯æè¿°
- **æ—¥å¿—è®°å½•**ï¼šè®°å½•å…³é”®æ“ä½œçš„è¯¦ç»†ä¿¡æ¯
- **æ–‡æ¡£ç»´æŠ¤**ï¼šä¸ºå…±äº«åº“ç¼–å†™ä½¿ç”¨æ–‡æ¡£

**ğŸ“ˆ è¿›é˜¶æŠ€å·§**
- **åŠ¨æ€æµç¨‹**ï¼šæ ¹æ®é¡¹ç›®ç‰¹ç‚¹åŠ¨æ€è°ƒæ•´Pipeline
- **åº“çš„ç‰ˆæœ¬ç®¡ç†**ï¼šä¸ºä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒç‰ˆæœ¬çš„åº“
- **ç›‘æ§é›†æˆ**ï¼šé›†æˆç›‘æ§å’Œå‘Šè­¦ç³»ç»Ÿ
- **å®‰å…¨è€ƒè™‘**ï¼šæ•æ„Ÿä¿¡æ¯çš„å®‰å…¨å¤„ç†

### 7.4 å­¦ä¹ è·¯å¾„å»ºè®®


**ğŸ“š å¾ªåºæ¸è¿›çš„å­¦ä¹ æ–¹æ³•**
```
1. åŸºç¡€ç»ƒä¹ ï¼š
   - åˆ›å»ºç®€å•çš„å¹¶è¡Œä»»åŠ¡
   - ä½¿ç”¨åŸºæœ¬çš„whenæ¡ä»¶
   - æ·»åŠ ç®€å•çš„å‚æ•°

2. è¿›é˜¶å®è·µï¼š
   - ç»„åˆä½¿ç”¨å¤šç§ç‰¹æ€§
   - åˆ›å»ºå¤æ‚çš„æ¡ä»¶é€»è¾‘
   - å®ç°é”™è¯¯å¤„ç†æœºåˆ¶

3. é«˜çº§åº”ç”¨ï¼š
   - å¼€å‘å…±äº«åº“
   - å®ç°åŠ¨æ€Pipeline
   - é›†æˆç›‘æ§å’Œé€šçŸ¥
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- Pipelineé«˜çº§ç‰¹æ€§è®©è‡ªåŠ¨åŒ–æ›´æ™ºèƒ½æ›´é«˜æ•ˆ
- å¹¶è¡Œæ‰§è¡ŒèŠ‚çœæ—¶é—´ï¼Œæ¡ä»¶åˆ¤æ–­å¢åŠ çµæ´»æ€§
- å‚æ•°åŒ–å’ŒåŠ¨æ€ç”Ÿæˆæé«˜å¤ç”¨æ€§å’Œé€‚åº”æ€§
- é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶æé«˜ç¨³å®šæ€§å’Œå¯é æ€§
- å…±äº«åº“æ˜¯å›¢é˜Ÿåä½œå’Œæ ‡å‡†åŒ–çš„åŸºç¡€