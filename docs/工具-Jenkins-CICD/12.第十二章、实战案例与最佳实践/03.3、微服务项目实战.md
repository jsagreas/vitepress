---
title: 3ã€å¾®æœåŠ¡é¡¹ç›®å®æˆ˜
---
## ğŸ“š ç›®å½•

1. [å¾®æœåŠ¡CI/CDæ¦‚è¿°](#1-å¾®æœåŠ¡CICDæ¦‚è¿°)
2. [å¤šæ¨¡å—é¡¹ç›®æ„å»ºç­–ç•¥](#2-å¤šæ¨¡å—é¡¹ç›®æ„å»ºç­–ç•¥)
3. [æœåŠ¡ä¾èµ–ç®¡ç†](#3-æœåŠ¡ä¾èµ–ç®¡ç†)
4. [ç‹¬ç«‹éƒ¨ç½²ç­–ç•¥](#4-ç‹¬ç«‹éƒ¨ç½²ç­–ç•¥)
5. [æœåŠ¡æ³¨å†Œå‘ç°é›†æˆ](#5-æœåŠ¡æ³¨å†Œå‘ç°é›†æˆ)
6. [é…ç½®ä¸­å¿ƒé›†æˆ](#6-é…ç½®ä¸­å¿ƒé›†æˆ)
7. [ç›‘æ§é“¾è·¯è¿½è¸ª](#7-ç›‘æ§é“¾è·¯è¿½è¸ª)
8. [å®æˆ˜æ€»ç»“ä¸æœ€ä½³å®è·µ](#8-å®æˆ˜æ€»ç»“ä¸æœ€ä½³å®è·µ)

---

## 1. ğŸ—ï¸ å¾®æœåŠ¡CI/CDæ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯å¾®æœåŠ¡CI/CD


**ğŸ”¸ é€šä¿—ç†è§£**
```
ä¼ ç»Ÿå•ä½“åº”ç”¨ï¼š
å°±åƒä¸€ä¸ªå¤§å·¥å‚ï¼Œæ‰€æœ‰åŠŸèƒ½åœ¨ä¸€ä¸ªå»ºç­‘é‡Œ
- ä¿®æ”¹ä»»ä½•åŠŸèƒ½éƒ½è¦é‡æ–°å‘å¸ƒæ•´ä¸ªåº”ç”¨
- ä¸€ä¸ªåœ°æ–¹å‡ºé—®é¢˜ï¼Œæ•´ä¸ªç³»ç»Ÿéƒ½å—å½±å“

å¾®æœåŠ¡æ¶æ„ï¼š
å°±åƒä¸€ä¸ªå·¥ä¸šå›­åŒºï¼Œæ¯ä¸ªæœåŠ¡æ˜¯ç‹¬ç«‹çš„å°å·¥å‚
- æ¯ä¸ªæœåŠ¡å¯ä»¥ç‹¬ç«‹å¼€å‘ã€æµ‹è¯•ã€éƒ¨ç½²
- æŸä¸ªæœåŠ¡å‡ºé—®é¢˜ä¸ä¼šå½±å“å…¶ä»–æœåŠ¡
```

**ğŸ¯ æ ¸å¿ƒæŒ‘æˆ˜**
```
å•ä½“åº”ç”¨ vs å¾®æœåŠ¡éƒ¨ç½²å¯¹æ¯”ï¼š

å•ä½“åº”ç”¨ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ä¸€ä¸ªå¤§åº”ç”¨       â”‚ â†’ ä¸€æ¬¡éƒ¨ç½²
â”‚  ç”¨æˆ·+è®¢å•+æ”¯ä»˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¾®æœåŠ¡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·æœåŠ¡ â”‚ â”‚ è®¢å•æœåŠ¡ â”‚ â”‚ æ”¯ä»˜æœåŠ¡ â”‚ â†’ ä¸‰æ¬¡ç‹¬ç«‹éƒ¨ç½²
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“           â†“           â†“
   éœ€è¦åè°ƒ    éœ€è¦åè°ƒ    éœ€è¦åè°ƒ
```

### 1.2 å¾®æœåŠ¡CI/CDç‰¹ç‚¹


**âœ… ç‹¬ç«‹æ€§è¦æ±‚**
- **ç‹¬ç«‹æ„å»º**ï¼šæ¯ä¸ªæœåŠ¡æœ‰è‡ªå·±çš„ä»£ç ä»“åº“å’Œæ„å»ºæµç¨‹
- **ç‹¬ç«‹æµ‹è¯•**ï¼šæœåŠ¡å†…éƒ¨æµ‹è¯• + æ¥å£å¥‘çº¦æµ‹è¯•
- **ç‹¬ç«‹éƒ¨ç½²**ï¼šä¸åŒæœåŠ¡å¯ä»¥ä¸åŒèŠ‚å¥å‘å¸ƒ
- **ç‹¬ç«‹å›æ»š**ï¼šæŸä¸ªæœåŠ¡æœ‰é—®é¢˜å¯ä»¥å•ç‹¬å›æ»š

**âš ï¸ å¤æ‚æ€§æŒ‘æˆ˜**
- **æœåŠ¡é—´ä¾èµ–**ï¼šAæœåŠ¡è°ƒç”¨BæœåŠ¡ï¼Œç‰ˆæœ¬è¦åŒ¹é…
- **æ•°æ®ä¸€è‡´æ€§**ï¼šåˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†
- **ç¯å¢ƒç®¡ç†**ï¼šå¤šä¸ªæœåŠ¡çš„ç¯å¢ƒé…ç½®
- **ç›‘æ§å¤æ‚**ï¼šè¦ç›‘æ§å¤šä¸ªæœåŠ¡çš„çŠ¶æ€

---

## 2. ğŸ”§ å¤šæ¨¡å—é¡¹ç›®æ„å»ºç­–ç•¥


### 2.1 é¡¹ç›®ç»“æ„è®¾è®¡


**ğŸ—ï¸ å…¸å‹å¾®æœåŠ¡é¡¹ç›®ç»“æ„**
```
ç”µå•†å¾®æœåŠ¡é¡¹ç›®ç»“æ„ï¼š
ecommerce-platform/
â”œâ”€â”€ user-service/              â† ç”¨æˆ·æœåŠ¡
â”‚   â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”œâ”€â”€ pom.xml
â”‚   â””â”€â”€ Jenkinsfile
â”œâ”€â”€ order-service/             â† è®¢å•æœåŠ¡
â”‚   â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ Dockerfile  
â”‚   â”œâ”€â”€ pom.xml
â”‚   â””â”€â”€ Jenkinsfile
â”œâ”€â”€ payment-service/           â† æ”¯ä»˜æœåŠ¡
â”‚   â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”œâ”€â”€ pom.xml
â”‚   â””â”€â”€ Jenkinsfile
â”œâ”€â”€ gateway-service/           â† ç½‘å…³æœåŠ¡
â”œâ”€â”€ config-center/             â† é…ç½®ä¸­å¿ƒ
â””â”€â”€ docker-compose.yml         â† æœ¬åœ°æµ‹è¯•ç¯å¢ƒ
```

### 2.2 Jenkinså¤šæ¨¡å—æ„å»ºé…ç½®


**ğŸ”¸ æ–¹æ¡ˆä¸€ï¼šå•ä¸€Pipelineå¤„ç†æ‰€æœ‰æœåŠ¡**

> ğŸ’¡ **é€‚ç”¨åœºæ™¯**ï¼šæœåŠ¡è¾ƒå°‘ï¼Œå‘å¸ƒèŠ‚å¥ä¸€è‡´çš„é¡¹ç›®

```groovy
// ä¸»Jenkinsfile - ç®¡ç†æ‰€æœ‰å¾®æœåŠ¡
pipeline {
    agent any
    
    parameters {
        // è®©ç”¨æˆ·é€‰æ‹©è¦æ„å»ºå“ªäº›æœåŠ¡
        booleanParam(name: 'BUILD_USER_SERVICE', defaultValue: true, description: 'æ„å»ºç”¨æˆ·æœåŠ¡')
        booleanParam(name: 'BUILD_ORDER_SERVICE', defaultValue: true, description: 'æ„å»ºè®¢å•æœåŠ¡')
        booleanParam(name: 'BUILD_PAYMENT_SERVICE', defaultValue: false, description: 'æ„å»ºæ”¯ä»˜æœåŠ¡')
    }
    
    stages {
        stage('æ£€æµ‹å˜æ›´') {
            steps {
                script {
                    // æ£€æµ‹å“ªäº›æœåŠ¡çš„ä»£ç æœ‰å˜æ›´
                    def changes = sh(
                        script: "git diff --name-only HEAD~1",
                        returnStdout: true
                    ).trim()
                    
                    env.USER_CHANGED = changes.contains('user-service/') ? 'true' : 'false'
                    env.ORDER_CHANGED = changes.contains('order-service/') ? 'true' : 'false'
                }
            }
        }
        
        stage('å¹¶è¡Œæ„å»ºæœåŠ¡') {
            parallel {
                stage('ç”¨æˆ·æœåŠ¡') {
                    when {
                        anyOf {
                            environment name: 'USER_CHANGED', value: 'true'
                            params.BUILD_USER_SERVICE
                        }
                    }
                    steps {
                        dir('user-service') {
                            sh 'mvn clean package'
                            sh 'docker build -t user-service:${BUILD_NUMBER} .'
                        }
                    }
                }
                
                stage('è®¢å•æœåŠ¡') {
                    when {
                        anyOf {
                            environment name: 'ORDER_CHANGED', value: 'true'
                            params.BUILD_ORDER_SERVICE
                        }
                    }
                    steps {
                        dir('order-service') {
                            sh 'mvn clean package'
                            sh 'docker build -t order-service:${BUILD_NUMBER} .'
                        }
                    }
                }
            }
        }
    }
}
```

**ğŸ”¸ æ–¹æ¡ˆäºŒï¼šæ¯ä¸ªæœåŠ¡ç‹¬ç«‹Pipeline**

> ğŸ’¡ **æ¨èæ–¹æ¡ˆ**ï¼šæœåŠ¡è¾ƒå¤šï¼Œç‹¬ç«‹å‘å¸ƒé¢‘ç‡é«˜çš„é¡¹ç›®

```groovy
// user-service/Jenkinsfile - ç”¨æˆ·æœåŠ¡ä¸“ç”¨
pipeline {
    agent any
    
    triggers {
        // åªæœ‰ç”¨æˆ·æœåŠ¡ä»£ç å˜æ›´æ—¶æ‰è§¦å‘
        pollSCM('H/5 * * * *')
    }
    
    stages {
        stage('æ„å»º') {
            steps {
                sh '''
                    echo "å¼€å§‹æ„å»ºç”¨æˆ·æœåŠ¡..."
                    mvn clean package -DskipTests=false
                '''
            }
        }
        
        stage('å•å…ƒæµ‹è¯•') {
            steps {
                sh 'mvn test'
                publishTestResults testResultsPattern: 'target/surefire-reports/*.xml'
            }
        }
        
        stage('é›†æˆæµ‹è¯•') {
            steps {
                sh '''
                    # å¯åŠ¨ä¾èµ–çš„æœåŠ¡è¿›è¡Œé›†æˆæµ‹è¯•
                    docker-compose -f ../test-compose.yml up -d database redis
                    mvn verify
                    docker-compose -f ../test-compose.yml down
                '''
            }
        }
        
        stage('æ„å»ºé•œåƒ') {
            steps {
                script {
                    def image = docker.build("user-service:${env.BUILD_NUMBER}")
                    docker.withRegistry('https://your-registry.com', 'registry-credentials') {
                        image.push()
                        image.push('latest')
                    }
                }
            }
        }
        
        stage('éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ') {
            steps {
                sh '''
                    # æ›´æ–°æµ‹è¯•ç¯å¢ƒçš„ç”¨æˆ·æœåŠ¡
                    kubectl set image deployment/user-service user-service=your-registry.com/user-service:${BUILD_NUMBER}
                    kubectl rollout status deployment/user-service
                '''
            }
        }
    }
}
```

### 2.3 æ„å»ºä¼˜åŒ–ç­–ç•¥


**âš¡ å¢é‡æ„å»º**
```groovy
stage('æ™ºèƒ½æ„å»º') {
    steps {
        script {
            // æ£€æŸ¥Mavenä¾èµ–æ˜¯å¦å˜æ›´
            def pomChanged = sh(
                script: "git diff --name-only HEAD~1 | grep pom.xml",
                returnStatus: true
            ) == 0
            
            if (pomChanged) {
                echo "ä¾èµ–å˜æ›´ï¼Œæ‰§è¡Œå®Œæ•´æ„å»º"
                sh 'mvn clean compile'
            } else {
                echo "ä»…ä»£ç å˜æ›´ï¼Œæ‰§è¡Œå¢é‡æ„å»º"
                sh 'mvn compile'
            }
        }
    }
}
```

---

## 3. ğŸ”— æœåŠ¡ä¾èµ–ç®¡ç†


### 3.1 ä¾èµ–å…³ç³»æ¢³ç†


**ğŸ¯ æœåŠ¡ä¾èµ–å›¾ç¤º**
```
å…¸å‹ç”µå•†å¾®æœåŠ¡ä¾èµ–å…³ç³»ï¼š

APIç½‘å…³
    â”œâ”€â”€ ç”¨æˆ·æœåŠ¡ â”€â”€â”€â”€â”
    â”œâ”€â”€ è®¢å•æœåŠ¡ â”€â”€â”€â”€â”¤
    â””â”€â”€ æ”¯ä»˜æœåŠ¡ â”€â”€â”€â”€â”¤
                    â”œâ”€â”€ æ•°æ®åº“é›†ç¾¤
                    â”œâ”€â”€ Redisç¼“å­˜
                    â””â”€â”€ æ¶ˆæ¯é˜Ÿåˆ—

ä¾èµ–è¯´æ˜ï¼š
â€¢ è®¢å•æœåŠ¡ä¾èµ–ç”¨æˆ·æœåŠ¡ï¼ˆè·å–ç”¨æˆ·ä¿¡æ¯ï¼‰
â€¢ æ”¯ä»˜æœåŠ¡ä¾èµ–è®¢å•æœåŠ¡ï¼ˆè·å–è®¢å•è¯¦æƒ…ï¼‰
â€¢ æ‰€æœ‰æœåŠ¡éƒ½ä¾èµ–åŸºç¡€è®¾æ–½ï¼ˆæ•°æ®åº“ã€ç¼“å­˜ã€MQï¼‰
```

### 3.2 APIå¥‘çº¦æµ‹è¯•


**ğŸ”¸ ä»€ä¹ˆæ˜¯å¥‘çº¦æµ‹è¯•**
```
é€šä¿—ç†è§£ï¼š
å°±åƒä¸¤ä¸ªäººçº¦å®šå¥½æš—å·ï¼Œç¡®ä¿èƒ½æ­£ç¡®æ²Ÿé€š

è®¢å•æœåŠ¡è°ƒç”¨ç”¨æˆ·æœåŠ¡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   GET /users/123    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®¢å•æœåŠ¡ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ ç”¨æˆ·æœåŠ¡ â”‚
â”‚         â”‚ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   {id:123,name:"å¼ ä¸‰"}  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¥‘çº¦æµ‹è¯•ç¡®ä¿ï¼š
âœ… è¯·æ±‚æ ¼å¼æ­£ç¡®ï¼ˆè·¯å¾„ã€å‚æ•°ï¼‰
âœ… å“åº”æ ¼å¼æ­£ç¡®ï¼ˆå­—æ®µã€ç±»å‹ï¼‰
âœ… é”™è¯¯å¤„ç†ä¸€è‡´ï¼ˆçŠ¶æ€ç ã€é”™è¯¯ä¿¡æ¯ï¼‰
```

**ğŸ”§ å¥‘çº¦æµ‹è¯•å®ç°**
```groovy
stage('APIå¥‘çº¦æµ‹è¯•') {
    steps {
        script {
            // å¯åŠ¨ç”¨æˆ·æœåŠ¡çš„æ¡©æœåŠ¡(Stub)
            sh '''
                # ä½¿ç”¨WireMockæˆ–Pactå¯åŠ¨æ¡©æœåŠ¡
                java -jar wiremock-standalone.jar --port 8080 &
                
                # é…ç½®ç”¨æˆ·æœåŠ¡çš„æ¨¡æ‹Ÿå“åº”
                curl -X POST http://localhost:8080/__admin/mappings \
                     -H "Content-Type: application/json" \
                     -d '{
                         "request": {
                             "method": "GET",
                             "url": "/users/123"
                         },
                         "response": {
                             "status": 200,
                             "headers": {"Content-Type": "application/json"},
                             "body": "{\\"id\\": 123, \\"name\\": \\"å¼ ä¸‰\\"}"
                         }
                     }'
            '''
            
            // è¿è¡Œè®¢å•æœåŠ¡çš„å¥‘çº¦æµ‹è¯•
            sh '''
                # é…ç½®è®¢å•æœåŠ¡è¿æ¥åˆ°æ¡©æœåŠ¡
                export USER_SERVICE_URL=http://localhost:8080
                mvn test -Dtest=UserServiceContractTest
            '''
        }
    }
}
```

### 3.3 ç‰ˆæœ¬å…¼å®¹æ€§ç®¡ç†


**ğŸ”¸ è¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶**
```
ç‰ˆæœ¬å·è§„åˆ™ï¼šä¸»ç‰ˆæœ¬.æ¬¡ç‰ˆæœ¬.ä¿®è®¢ç‰ˆæœ¬
ä¾‹å¦‚ï¼šuser-service:2.1.3

ä¸»ç‰ˆæœ¬ (2)ï¼šä¸å…¼å®¹çš„APIä¿®æ”¹
â”œâ”€â”€ 2.0.0ï¼šå…¨æ–°APIè®¾è®¡
â””â”€â”€ 3.0.0ï¼šç§»é™¤æ—§ç‰ˆæœ¬æ¥å£

æ¬¡ç‰ˆæœ¬ (1)ï¼šå‘ä¸‹å…¼å®¹çš„åŠŸèƒ½å¢åŠ   
â”œâ”€â”€ 2.1.0ï¼šæ–°å¢è·å–ç”¨æˆ·å¤´åƒæ¥å£
â””â”€â”€ 2.2.0ï¼šæ–°å¢ç”¨æˆ·åå¥½è®¾ç½®æ¥å£

ä¿®è®¢ç‰ˆæœ¬ (3)ï¼šå‘ä¸‹å…¼å®¹çš„é—®é¢˜ä¿®æ­£
â”œâ”€â”€ 2.1.1ï¼šä¿®å¤ç”¨æˆ·åéªŒè¯bug
â”œâ”€â”€ 2.1.2ï¼šä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
â””â”€â”€ 2.1.3ï¼šä¿®å¤å†…å­˜æ³„æ¼
```

**ğŸ”§ ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥**
```groovy
stage('å…¼å®¹æ€§æ£€æŸ¥') {
    steps {
        script {
            // æ£€æŸ¥APIå˜æ›´
            sh '''
                # ç”Ÿæˆå½“å‰ç‰ˆæœ¬çš„APIæ–‡æ¡£
                mvn spring-boot:run -Dspring-boot.run.arguments="--spring.profiles.active=doc-gen" &
                sleep 30
                curl http://localhost:8080/v3/api-docs > current-api.json
                
                # ä¸ä¸Šä¸€ç‰ˆæœ¬å¯¹æ¯”
                api-diff-tool compare previous-api.json current-api.json
            '''
            
            // æ ¹æ®å˜æ›´ç±»å‹å†³å®šç‰ˆæœ¬å·
            def apiChanges = readFile('api-changes.txt')
            if (apiChanges.contains('BREAKING_CHANGE')) {
                env.VERSION_TYPE = 'major'
            } else if (apiChanges.contains('NEW_FEATURE')) {
                env.VERSION_TYPE = 'minor'
            } else {
                env.VERSION_TYPE = 'patch'
            }
        }
    }
}
```

---

## 4. ğŸš€ ç‹¬ç«‹éƒ¨ç½²ç­–ç•¥


### 4.1 è“ç»¿éƒ¨ç½²


**ğŸ”¸ è“ç»¿éƒ¨ç½²åŸç†**
```
è“ç»¿éƒ¨ç½²å°±åƒä¸¤ä¸ªèˆå°è½®æµè¡¨æ¼”ï¼š

å½“å‰çŠ¶æ€ï¼ˆè“ç¯å¢ƒåœ¨çº¿ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è´Ÿè½½å‡è¡¡ â”‚â”€â”€â”€â–¶â”‚ è“ç¯å¢ƒ  â”‚ â† ç”¨æˆ·è®¿é—®
â”‚         â”‚    â”‚ v1.0    â”‚
â”‚         â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚         â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         â”‚    â”‚ ç»¿ç¯å¢ƒ  â”‚ â† å‡†å¤‡æ–°ç‰ˆæœ¬
â”‚         â”‚    â”‚ v2.0    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åˆ‡æ¢åï¼ˆç»¿ç¯å¢ƒåœ¨çº¿ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è´Ÿè½½å‡è¡¡ â”‚    â”‚ è“ç¯å¢ƒ  â”‚ â† ä¿ç•™ä½œä¸ºå›æ»šå¤‡ä»½
â”‚         â”‚    â”‚ v1.0    â”‚
â”‚         â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚         â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         â”‚â”€â”€â”€â–¶â”‚ ç»¿ç¯å¢ƒ  â”‚ â† ç”¨æˆ·è®¿é—®
â”‚         â”‚    â”‚ v2.0    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”§ Jenkinsè“ç»¿éƒ¨ç½²å®ç°**
```groovy
stage('è“ç»¿éƒ¨ç½²') {
    steps {
        script {
            // æ£€æŸ¥å½“å‰æ´»è·ƒç¯å¢ƒ
            def currentEnv = sh(
                script: "kubectl get service user-service -o jsonpath='{.spec.selector.version}'",
                returnStdout: true
            ).trim()
            
            def targetEnv = currentEnv == 'blue' ? 'green' : 'blue'
            
            echo "å½“å‰ç¯å¢ƒï¼š${currentEnv}ï¼Œç›®æ ‡ç¯å¢ƒï¼š${targetEnv}"
            
            // éƒ¨ç½²åˆ°ç›®æ ‡ç¯å¢ƒ
            sh """
                # æ›´æ–°ç›®æ ‡ç¯å¢ƒçš„é•œåƒ
                kubectl set image deployment/user-service-${targetEnv} \\
                    user-service=user-service:${BUILD_NUMBER}
                
                # ç­‰å¾…éƒ¨ç½²å®Œæˆ
                kubectl rollout status deployment/user-service-${targetEnv}
                
                # å¥åº·æ£€æŸ¥
                sleep 30
                kubectl get pods -l app=user-service,version=${targetEnv}
            """
            
            // åˆ‡æ¢æµé‡
            timeout(time: 5, unit: 'MINUTES') {
                input message: 'å¥åº·æ£€æŸ¥é€šè¿‡ï¼Œæ˜¯å¦åˆ‡æ¢æµé‡åˆ°æ–°ç¯å¢ƒï¼Ÿ', ok: 'ç¡®è®¤åˆ‡æ¢'
            }
            
            sh """
                # æ›´æ–°Serviceé€‰æ‹©å™¨ï¼Œåˆ‡æ¢æµé‡
                kubectl patch service user-service -p \\
                    '{"spec":{"selector":{"version":"${targetEnv}"}}}'
                echo "æµé‡å·²åˆ‡æ¢åˆ°${targetEnv}ç¯å¢ƒ"
            """
        }
    }
}
```

### 4.2 é‡‘ä¸é›€éƒ¨ç½²


**ğŸ”¸ é‡‘ä¸é›€éƒ¨ç½²åŸç†**
```
é‡‘ä¸é›€éƒ¨ç½²å°±åƒå…ˆæ´¾ä¸€åªå°é¸Ÿè¯•æ¢ï¼š

ç¬¬ä¸€é˜¶æ®µï¼š10%æµé‡åˆ°æ–°ç‰ˆæœ¬
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    90%    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è´Ÿè½½å‡è¡¡ â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ v1.0    â”‚ â† ç¨³å®šç‰ˆæœ¬
â”‚         â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚         â”‚    10%    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ v2.0    â”‚ â† æ–°ç‰ˆæœ¬æµ‹è¯•
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è§‚å¯Ÿæ— é—®é¢˜åï¼Œé€æ­¥å¢åŠ æ–°ç‰ˆæœ¬æµé‡ï¼š
50% â†’ 80% â†’ 100%
```

**ğŸ”§ é‡‘ä¸é›€éƒ¨ç½²å®ç°**
```groovy
stage('é‡‘ä¸é›€éƒ¨ç½²') {
    steps {
        script {
            // éƒ¨ç½²é‡‘ä¸é›€ç‰ˆæœ¬ï¼ˆå‰¯æœ¬æ•°è¾ƒå°‘ï¼‰
            sh """
                kubectl apply -f - <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: user-service-canary
spec:
  replicas: 1
  selector:
    matchLabels:
      app: user-service
      version: canary
  template:
    metadata:
      labels:
        app: user-service
        version: canary
    spec:
      containers:
      - name: user-service
        image: user-service:${BUILD_NUMBER}
EOF
            """
            
            // é…ç½®æµé‡åˆ†å‰²ï¼ˆ10%æµé‡åˆ°é‡‘ä¸é›€ï¼‰
            sh """
                kubectl apply -f - <<EOF
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: user-service-vs
spec:
  http:
  - match:
    - headers:
        canary:
          exact: "true"
    route:
    - destination:
        host: user-service
        subset: canary
  - route:
    - destination:
        host: user-service
        subset: stable
      weight: 90
    - destination:
        host: user-service
        subset: canary
      weight: 10
EOF
            """
            
            // ç›‘æ§é‡‘ä¸é›€ç‰ˆæœ¬
            echo "é‡‘ä¸é›€ç‰ˆæœ¬å·²éƒ¨ç½²ï¼Œå¼€å§‹ç›‘æ§..."
            sleep 300  // ç›‘æ§5åˆ†é’Ÿ
            
            // æ£€æŸ¥é”™è¯¯ç‡
            def errorRate = sh(
                script: """
                    # ä»ç›‘æ§ç³»ç»Ÿè·å–é”™è¯¯ç‡
                    curl -s 'http://prometheus:9090/api/v1/query' \\
                         --data-urlencode 'query=rate(http_requests_total{job="user-service",version="canary",status=~"5.."}[5m])' \\
                         | jq -r '.data.result[0].value[1]'
                """,
                returnStdout: true
            ).trim().toDouble()
            
            if (errorRate > 0.01) {  // é”™è¯¯ç‡è¶…è¿‡1%
                echo "é‡‘ä¸é›€ç‰ˆæœ¬é”™è¯¯ç‡è¿‡é«˜: ${errorRate * 100}%ï¼Œå¼€å§‹å›æ»š"
                sh "kubectl delete deployment user-service-canary"
                error("é‡‘ä¸é›€éƒ¨ç½²å¤±è´¥ï¼Œå·²å›æ»š")
            } else {
                echo "é‡‘ä¸é›€ç‰ˆæœ¬è¿è¡Œè‰¯å¥½ï¼Œç»§ç»­æ¨å¹¿"
            }
        }
    }
}
```

### 4.3 æ»šåŠ¨æ›´æ–°


**ğŸ”¸ æ»šåŠ¨æ›´æ–°åŸç†**
```
æ»šåŠ¨æ›´æ–°å°±åƒé€æ­¥æ¢å²—ï¼š

åˆå§‹çŠ¶æ€ï¼š3ä¸ªv1.0å®ä¾‹
â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”
â”‚v1.0 â”‚ â”‚v1.0 â”‚ â”‚v1.0 â”‚
â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜

ç¬¬1æ­¥ï¼šå¯åŠ¨1ä¸ªv2.0ï¼Œåœæ­¢1ä¸ªv1.0
â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”
â”‚v2.0 â”‚ â”‚v1.0 â”‚ â”‚v1.0 â”‚
â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜

ç¬¬2æ­¥ï¼šå†å¯åŠ¨1ä¸ªv2.0ï¼Œå†åœæ­¢1ä¸ªv1.0
â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”
â”‚v2.0 â”‚ â”‚v2.0 â”‚ â”‚v1.0 â”‚
â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜

ç¬¬3æ­¥ï¼šå…¨éƒ¨å®Œæˆ
â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”
â”‚v2.0 â”‚ â”‚v2.0 â”‚ â”‚v2.0 â”‚
â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜
```

**ğŸ”§ æ»šåŠ¨æ›´æ–°é…ç½®**
```groovy
stage('æ»šåŠ¨æ›´æ–°') {
    steps {
        script {
            sh """
                # é…ç½®æ»šåŠ¨æ›´æ–°ç­–ç•¥
                kubectl patch deployment user-service -p '{
                    "spec": {
                        "strategy": {
                            "type": "RollingUpdate",
                            "rollingUpdate": {
                                "maxSurge": "25%",
                                "maxUnavailable": "25%"
                            }
                        }
                    }
                }'
                
                # æ›´æ–°é•œåƒç‰ˆæœ¬
                kubectl set image deployment/user-service \\
                    user-service=user-service:${BUILD_NUMBER}
                
                # ç›‘æ§æ»šåŠ¨æ›´æ–°è¿›åº¦
                kubectl rollout status deployment/user-service --timeout=300s
            """
        }
    }
}
```

---

## 5. ğŸ” æœåŠ¡æ³¨å†Œå‘ç°é›†æˆ


### 5.1 æœåŠ¡æ³¨å†Œå‘ç°åŸç†


**ğŸ”¸ ä»€ä¹ˆæ˜¯æœåŠ¡æ³¨å†Œå‘ç°**
```
é€šä¿—ç†è§£ï¼š
å°±åƒç”µè¯é»„é¡µï¼ŒæœåŠ¡å¯åŠ¨æ—¶ç™»è®°è‡ªå·±çš„"ç”µè¯å·ç "

ä¼ ç»Ÿæ–¹å¼ï¼ˆç¡¬ç¼–ç ï¼‰ï¼š
è®¢å•æœåŠ¡ç›´æ¥è°ƒç”¨ï¼šhttp://192.168.1.100:8080/users/123
é—®é¢˜ï¼šIPå˜äº†æœåŠ¡å°±æ‰¾ä¸åˆ°äº†

æœåŠ¡å‘ç°æ–¹å¼ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    1.æ³¨å†Œ    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·æœåŠ¡ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ æ³¨å†Œä¸­å¿ƒ    â”‚
â”‚ IP:100  â”‚              â”‚ (Eureka)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â–²
                          2.æŸ¥è¯¢ â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚ è®¢å•æœåŠ¡ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚         â”‚  3.è¿”å›: user-service â†’ 192.168.1.100:8080
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 Eurekaé›†æˆéƒ¨ç½²


**ğŸ”§ Eureka Serveréƒ¨ç½²**
```groovy
stage('éƒ¨ç½²Eurekaæ³¨å†Œä¸­å¿ƒ') {
    steps {
        script {
            sh """
                # éƒ¨ç½²Eureka Server
                kubectl apply -f - <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: eureka-server
spec:
  replicas: 2  # é«˜å¯ç”¨éƒ¨ç½²
  selector:
    matchLabels:
      app: eureka-server
  template:
    metadata:
      labels:
        app: eureka-server
    spec:
      containers:
      - name: eureka-server
        image: eureka-server:latest
        ports:
        - containerPort: 8761
        env:
        - name: EUREKA_INSTANCE_HOSTNAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE
          value: "http://eureka-server-0.eureka-server:8761/eureka,http://eureka-server-1.eureka-server:8761/eureka"
---
apiVersion: v1
kind: Service
metadata:
  name: eureka-server
spec:
  selector:
    app: eureka-server
  ports:
  - port: 8761
    targetPort: 8761
  type: ClusterIP
EOF
            """
        }
    }
}
```

**ğŸ”§ å¾®æœåŠ¡æ³¨å†Œé…ç½®**
```groovy
stage('é…ç½®æœåŠ¡æ³¨å†Œ') {
    steps {
        script {
            // ä¸ºæ¯ä¸ªå¾®æœåŠ¡é…ç½®æ³¨å†Œå‘ç°
            sh """
                # ç”¨æˆ·æœåŠ¡é…ç½®
                kubectl create configmap user-service-config --from-literal=eureka.client.service-url.defaultZone=http://eureka-server:8761/eureka
                
                # æ›´æ–°éƒ¨ç½²é…ç½®ï¼Œæ³¨å…¥æ³¨å†Œä¸­å¿ƒåœ°å€
                kubectl patch deployment user-service -p '{
                    "spec": {
                        "template": {
                            "spec": {
                                "containers": [{
                                    "name": "user-service",
                                    "env": [
                                        {"name": "EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE", "value": "http://eureka-server:8761/eureka"},
                                        {"name": "EUREKA_INSTANCE_HOSTNAME", "valueFrom": {"fieldRef": {"fieldPath": "status.podIP"}}},
                                        {"name": "EUREKA_INSTANCE_PREFER_IP_ADDRESS", "value": "true"}
                                    ]
                                }]
                            }
                        }
                    }
                }'
            """
        }
    }
}
```

### 5.3 æœåŠ¡å¥åº·æ£€æŸ¥


**ğŸ”§ å¥åº·æ£€æŸ¥é…ç½®**
```groovy
stage('é…ç½®å¥åº·æ£€æŸ¥') {
    steps {
        script {
            sh """
                # ä¸ºå¾®æœåŠ¡æ·»åŠ å¥åº·æ£€æŸ¥ç«¯ç‚¹
                kubectl patch deployment user-service -p '{
                    "spec": {
                        "template": {
                            "spec": {
                                "containers": [{
                                    "name": "user-service",
                                    "livenessProbe": {
                                        "httpGet": {
                                            "path": "/actuator/health",
                                            "port": 8080
                                        },
                                        "initialDelaySeconds": 60,
                                        "periodSeconds": 30
                                    },
                                    "readinessProbe": {
                                        "httpGet": {
                                            "path": "/actuator/health/readiness",
                                            "port": 8080
                                        },
                                        "initialDelaySeconds": 30,
                                        "periodSeconds": 10
                                    }
                                }]
                            }
                        }
                    }
                }'
            """
        }
    }
}
```

---

## 6. âš™ï¸ é…ç½®ä¸­å¿ƒé›†æˆ


### 6.1 é…ç½®ä¸­å¿ƒçš„ä½œç”¨


**ğŸ”¸ ä¸ºä»€ä¹ˆéœ€è¦é…ç½®ä¸­å¿ƒ**
```
ä¼ ç»Ÿé…ç½®ç®¡ç†é—®é¢˜ï¼š
application.properties
â”œâ”€â”€ æ•°æ®åº“è¿æ¥é…ç½®
â”œâ”€â”€ ç¼“å­˜é…ç½®  
â”œâ”€â”€ ç¬¬ä¸‰æ–¹APIé…ç½®
â””â”€â”€ ä¸šåŠ¡å‚æ•°é…ç½®

é—®é¢˜ï¼š
âŒ é…ç½®æ•£è½åœ¨å„ä¸ªæœåŠ¡ä¸­
âŒ ä¿®æ”¹é…ç½®éœ€è¦é‡æ–°æ‰“åŒ…éƒ¨ç½²
âŒ ä¸åŒç¯å¢ƒé…ç½®å®¹æ˜“æ··ä¹±
âŒ æ•æ„Ÿä¿¡æ¯å®¹æ˜“æ³„éœ²

é…ç½®ä¸­å¿ƒè§£å†³æ–¹æ¡ˆï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é…ç½®ä¸­å¿ƒ    â”‚ â† ç»Ÿä¸€ç®¡ç†æ‰€æœ‰é…ç½®
â”‚ (Config)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“ åŠ¨æ€æ‹‰å–é…ç½®
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·æœåŠ¡ â”‚ â”‚ è®¢å•æœåŠ¡ â”‚ â”‚ æ”¯ä»˜æœåŠ¡ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 Spring Cloud Configéƒ¨ç½²


**ğŸ”§ Config Serveréƒ¨ç½²**
```groovy
stage('éƒ¨ç½²é…ç½®ä¸­å¿ƒ') {
    steps {
        script {
            sh """
                # åˆ›å»ºé…ç½®å­˜å‚¨çš„Gitä»“åº“è®¿é—®å¯†é’¥
                kubectl create secret generic git-credentials \\
                    --from-literal=username=${GIT_USERNAME} \\
                    --from-literal=password=${GIT_PASSWORD}
                
                # éƒ¨ç½²é…ç½®ä¸­å¿ƒæœåŠ¡å™¨
                kubectl apply -f - <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: config-server
spec:
  replicas: 2
  selector:
    matchLabels:
      app: config-server
  template:
    metadata:
      labels:
        app: config-server
    spec:
      containers:
      - name: config-server
        image: config-server:latest
        ports:
        - containerPort: 8888
        env:
        - name: SPRING_CLOUD_CONFIG_SERVER_GIT_URI
          value: "https://github.com/your-org/microservice-configs.git"
        - name: SPRING_CLOUD_CONFIG_SERVER_GIT_USERNAME
          valueFrom:
            secretKeyRef:
              name: git-credentials
              key: username
        - name: SPRING_CLOUD_CONFIG_SERVER_GIT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: git-credentials
              key: password
EOF
            """
        }
    }
}
```

### 6.3 é…ç½®åŠ¨æ€åˆ·æ–°


**ğŸ”¸ é…ç½®åˆ·æ–°åŸç†**
```
é…ç½®å˜æ›´æµç¨‹ï¼š

1. å¼€å‘è€…ä¿®æ”¹é…ç½®æ–‡ä»¶
   â”œâ”€â”€ user-service-dev.yml
   â”œâ”€â”€ user-service-test.yml  
   â””â”€â”€ user-service-prod.yml

2. æäº¤åˆ°Gitä»“åº“
   Git Repository â†â”€â”€â”€ push

3. è§¦å‘é…ç½®åˆ·æ–°
   Config Server â”€â”€â”€â”€â”€â”€â†’ Webhook
   
4. é€šçŸ¥å„ä¸ªæœåŠ¡
   Message Bus (RabbitMQ) â”€â”€â”€â†’ å¹¿æ’­åˆ·æ–°äº‹ä»¶
   
5. æœåŠ¡é‡æ–°åŠ è½½é…ç½®
   å„å¾®æœåŠ¡ â†â”€â”€â”€ æ‹‰å–æ–°é…ç½®
```

**ğŸ”§ é…ç½®åˆ·æ–°å®ç°**
```groovy
stage('é…ç½®åŠ¨æ€åˆ·æ–°') {
    steps {
        script {
            // æ£€æŸ¥é…ç½®æ˜¯å¦æœ‰å˜æ›´
            def configChanged = sh(
                script: "git diff --name-only HEAD~1 | grep 'config/'",
                returnStatus: true
            ) == 0
            
            if (configChanged) {
                echo "æ£€æµ‹åˆ°é…ç½®å˜æ›´ï¼Œè§¦å‘åŠ¨æ€åˆ·æ–°"
                
                // é€šçŸ¥é…ç½®ä¸­å¿ƒåˆ·æ–°Gitä»“åº“
                sh """
                    curl -X POST http://config-server:8888/actuator/bus-refresh \\
                         -H "Content-Type: application/json"
                """
                
                // ç­‰å¾…é…ç½®ä¼ æ’­åˆ°æ‰€æœ‰æœåŠ¡
                sleep 30
                
                // éªŒè¯é…ç½®æ˜¯å¦ç”Ÿæ•ˆ
                sh """
                    # æ£€æŸ¥å„æœåŠ¡çš„é…ç½®æ˜¯å¦æ›´æ–°
                    for service in user-service order-service payment-service; do
                        echo "æ£€æŸ¥ \$service é…ç½®æ›´æ–°çŠ¶æ€..."
                        kubectl exec deployment/\$service -- curl -s http://localhost:8080/actuator/env | jq '.propertySources[0].name'
                    done
                """
            }
        }
    }
}
```

### 6.4 æ•æ„Ÿé…ç½®ç®¡ç†


**ğŸ”§ æ•æ„Ÿä¿¡æ¯åŠ å¯†**
```groovy
stage('å¤„ç†æ•æ„Ÿé…ç½®') {
    steps {
        script {
            // åŠ å¯†æ•æ„Ÿé…ç½®
            sh """
                # ä½¿ç”¨é…ç½®ä¸­å¿ƒçš„åŠ å¯†åŠŸèƒ½
                DB_PASSWORD=\$(curl -X POST http://config-server:8888/encrypt \\
                              -H "Content-Type: text/plain" \\
                              -d "${DATABASE_PASSWORD}")
                
                # æ›´æ–°é…ç½®æ–‡ä»¶ä¸­çš„å¯†ç ä¸ºåŠ å¯†å€¼
                sed -i "s/spring.datasource.password=.*/spring.datasource.password={cipher}\$DB_PASSWORD/" \\
                    config-repo/user-service-prod.yml
                
                # æäº¤åŠ å¯†åçš„é…ç½®
                cd config-repo
                git add .
                git commit -m "Update encrypted database password"
                git push origin main
            """
        }
    }
}
```

---

## 7. ğŸ“Š ç›‘æ§é“¾è·¯è¿½è¸ª


### 7.1 ç›‘æ§ä½“ç³»æ¶æ„


**ğŸ”¸ å¾®æœåŠ¡ç›‘æ§æŒ‘æˆ˜**
```
å•ä½“åº”ç”¨ç›‘æ§ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    åº”ç”¨     â”‚ â† ç›‘æ§ä¸€ä¸ªåº”ç”¨å°±å¤Ÿäº†
â”‚  æ—¥å¿—+æŒ‡æ ‡  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¾®æœåŠ¡ç›‘æ§ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·æœåŠ¡ â”‚ â”‚ è®¢å•æœåŠ¡ â”‚ â”‚ æ”¯ä»˜æœåŠ¡ â”‚
â”‚ æ—¥å¿—+æŒ‡æ ‡â”‚ â”‚ æ—¥å¿—+æŒ‡æ ‡â”‚ â”‚ æ—¥å¿—+æŒ‡æ ‡â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“           â†“           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ç›‘æ§ç³»ç»Ÿæ•´åˆ               â”‚
â”‚ æ—¥å¿—èšåˆ + æŒ‡æ ‡ç›‘æ§ + é“¾è·¯è¿½è¸ª     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 æ—¥å¿—èšåˆéƒ¨ç½²


**ğŸ”§ ELK Stackéƒ¨ç½²**
```groovy
stage('éƒ¨ç½²æ—¥å¿—èšåˆç³»ç»Ÿ') {
    steps {
        script {
            sh """
                # éƒ¨ç½²Elasticsearch
                kubectl apply -f - <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: elasticsearch
spec:
  replicas: 1
  selector:
    matchLabels:
      app: elasticsearch
  template:
    metadata:
      labels:
        app: elasticsearch
    spec:
      containers:
      - name: elasticsearch
        image: elasticsearch:7.15.0
        ports:
        - containerPort: 9200
        env:
        - name: discovery.type
          value: single-node
        - name: ES_JAVA_OPTS
          value: "-Xms512m -Xmx512m"
---
# éƒ¨ç½²Kibana
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kibana
spec:
  replicas: 1
  selector:
    matchLabels:
      app: kibana
  template:
    metadata:
      labels:
        app: kibana
    spec:
      containers:
      - name: kibana
        image: kibana:7.15.0
        ports:
        - containerPort: 5601
        env:
        - name: ELASTICSEARCH_HOSTS
          value: "http://elasticsearch:9200"
EOF
            """
            
            // é…ç½®å„å¾®æœåŠ¡çš„æ—¥å¿—è¾“å‡º
            sh """
                # ä¸ºæ¯ä¸ªå¾®æœåŠ¡æ·»åŠ Logstashé…ç½®
                kubectl create configmap logstash-config --from-file=logstash.conf
                
                # æ›´æ–°å¾®æœåŠ¡éƒ¨ç½²ï¼Œæ·»åŠ æ—¥å¿—æ”¶é›†è¾¹è½¦å®¹å™¨
                kubectl patch deployment user-service -p '{
                    "spec": {
                        "template": {
                            "spec": {
                                "containers": [
                                    {
                                        "name": "filebeat",
                                        "image": "filebeat:7.15.0",
                                        "volumeMounts": [
                                            {"name": "app-logs", "mountPath": "/var/log/app"}
                                        ]
                                    }
                                ],
                                "volumes": [
                                    {"name": "app-logs", "emptyDir": {}}
                                ]
                            }
                        }
                    }
                }'
            """
        }
    }
}
```

### 7.3 æŒ‡æ ‡ç›‘æ§éƒ¨ç½²


**ğŸ”§ Prometheus + Grafanaéƒ¨ç½²**
```groovy
stage('éƒ¨ç½²æŒ‡æ ‡ç›‘æ§') {
    steps {
        script {
            sh """
                # éƒ¨ç½²Prometheus
                kubectl apply -f - <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: prometheus
spec:
  replicas: 1
  selector:
    matchLabels:
      app: prometheus
  template:
    metadata:
      labels:
        app: prometheus
    spec:
      containers:
      - name: prometheus
        image: prometheus:latest
        ports:
        - containerPort: 9090
        volumeMounts:
        - name: config-volume
          mountPath: /etc/prometheus
      volumes:
      - name: config-volume
        configMap:
          name: prometheus-config
---
# Prometheusé…ç½®
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
    scrape_configs:
    - job_name: 'microservices'
      kubernetes_sd_configs:
      - role: pod
      relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
EOF
            """
            
            // éƒ¨ç½²Grafanaä»ªè¡¨æ¿
            sh """
                kubectl apply -f - <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana
spec:
  replicas: 1
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
    spec:
      containers:
      - name: grafana
        image: grafana/grafana:latest
        ports:
        - containerPort: 3000
        env:
        - name: GF_SECURITY_ADMIN_PASSWORD
          value: "admin123"
EOF
            """
        }
    }
}
```

### 7.4 åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª


**ğŸ”¸ é“¾è·¯è¿½è¸ªåŸç†**
```
åˆ†å¸ƒå¼è¯·æ±‚è°ƒç”¨é“¾ï¼š

ç”¨æˆ·è¯·æ±‚ â”€â”€1â”€â”€â†’ APIç½‘å…³ â”€â”€2â”€â”€â†’ è®¢å•æœåŠ¡ â”€â”€3â”€â”€â†’ ç”¨æˆ·æœåŠ¡
   â†“                â†“              â†“              â†“
TraceID:123    TraceID:123    TraceID:123    TraceID:123
SpanID:001     SpanID:002     SpanID:003     SpanID:004
               Parent:001     Parent:002     Parent:003

è¿½è¸ªé“¾è·¯å¯ä»¥çœ‹åˆ°ï¼š
âœ… æ•´ä¸ªè¯·æ±‚èŠ±è´¹äº†å¤šé•¿æ—¶é—´
âœ… æ¯ä¸ªæœåŠ¡å¤„ç†è€—æ—¶
âœ… å“ªä¸ªç¯èŠ‚å‡ºç°äº†é—®é¢˜
âœ… æœåŠ¡é—´çš„ä¾èµ–å…³ç³»
```

**ğŸ”§ Jaegeréƒ¨ç½²**
```groovy
stage('éƒ¨ç½²é“¾è·¯è¿½è¸ª') {
    steps {
        script {
            sh """
                # éƒ¨ç½²Jaeger
                kubectl apply -f - <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: jaeger
spec:
  replicas: 1
  selector:
    matchLabels:
      app: jaeger
  template:
    metadata:
      labels:
        app: jaeger
    spec:
      containers:
      - name: jaeger
        image: jaegertracing/all-in-one:latest
        ports:
        - containerPort: 16686  # UIç«¯å£
        - containerPort: 14268  # æ¥æ”¶è¿½è¸ªæ•°æ®ç«¯å£
        env:
        - name: COLLECTOR_ZIPKIN_HTTP_PORT
          value: "9411"
EOF
            """
            
            // é…ç½®å¾®æœåŠ¡å‘é€è¿½è¸ªæ•°æ®
            sh """
                # ä¸ºå„å¾®æœåŠ¡æ·»åŠ Jaegeré…ç½®
                kubectl create configmap jaeger-config \\
                    --from-literal=jaeger.agent.host=jaeger \\
                    --from-literal=jaeger.agent.port=6831
                
                # æ›´æ–°å¾®æœåŠ¡ç¯å¢ƒå˜é‡
                for service in user-service order-service payment-service; do
                    kubectl patch deployment \$service -p '{
                        "spec": {
                            "template": {
                                "spec": {
                                    "containers": [{
                                        "name": "'"\$service"'",
                                        "env": [
                                            {"name": "JAEGER_AGENT_HOST", "value": "jaeger"},
                                            {"name": "JAEGER_AGENT_PORT", "value": "6831"},
                                            {"name": "JAEGER_SAMPLER_TYPE", "value": "const"},
                                            {"name": "JAEGER_SAMPLER_PARAM", "value": "1"}
                                        ]
                                    }]
                                }
                            }
                        }
                    }'
                done
            """
        }
    }
}
```

### 7.5 ç›‘æ§å‘Šè­¦é…ç½®


**ğŸ”§ å‘Šè­¦è§„åˆ™è®¾ç½®**
```groovy
stage('é…ç½®ç›‘æ§å‘Šè­¦') {
    steps {
        script {
            sh """
                # åˆ›å»ºå‘Šè­¦è§„åˆ™
                kubectl apply -f - <<EOF
apiVersion: v1
kind: ConfigMap
metadata:
  name: alert-rules
data:
  alerts.yml: |
    groups:
    - name: microservice-alerts
      rules:
      # æœåŠ¡å¯ç”¨æ€§å‘Šè­¦
      - alert: ServiceDown
        expr: up{job="microservices"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "æœåŠ¡ {{ \$labels.instance }} å·²åœæ­¢"
          description: "å¾®æœåŠ¡å®ä¾‹ {{ \$labels.instance }} å·²ç»åœæ­¢è¶…è¿‡1åˆ†é’Ÿ"
      
      # é«˜é”™è¯¯ç‡å‘Šè­¦
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "æœåŠ¡ {{ \$labels.job }} é”™è¯¯ç‡è¿‡é«˜"
          description: "5åˆ†é’Ÿå†…é”™è¯¯ç‡è¶…è¿‡10%"
      
      # å“åº”æ—¶é—´å‘Šè­¦
      - alert: HighLatency
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 1
        for: 3m
        labels:
          severity: warning
        annotations:
          summary: "æœåŠ¡ {{ \$labels.job }} å“åº”æ—¶é—´è¿‡é•¿"
          description: "95%è¯·æ±‚å“åº”æ—¶é—´è¶…è¿‡1ç§’"
EOF
            """
        }
    }
}
```

---

## 8. ğŸ“‹ å®æˆ˜æ€»ç»“ä¸æœ€ä½³å®è·µ


### 8.1 æ ¸å¿ƒè¦ç‚¹æ€»ç»“


**ğŸ¯ å¾®æœåŠ¡CI/CDå…³é”®è¦ç´ **
```
ğŸ”¸ ç‹¬ç«‹æ€§åŸåˆ™ï¼šæ¯ä¸ªæœåŠ¡ç‹¬ç«‹æ„å»ºã€æµ‹è¯•ã€éƒ¨ç½²
ğŸ”¸ è‡ªåŠ¨åŒ–ç¨‹åº¦ï¼šå‡å°‘äººå·¥å¹²é¢„ï¼Œæé«˜æ•ˆç‡å’Œä¸€è‡´æ€§
ğŸ”¸ å¯è§‚æµ‹æ€§ï¼šå®Œå–„çš„ç›‘æ§ã€æ—¥å¿—ã€è¿½è¸ªä½“ç³»
ğŸ”¸ æ¸è¿›å¼å‘å¸ƒï¼šè“ç»¿ã€é‡‘ä¸é›€ã€æ»šåŠ¨æ›´æ–°ç­‰ç­–ç•¥
ğŸ”¸ å¿«é€Ÿå›æ»šï¼šå‡ºç°é—®é¢˜èƒ½å¤Ÿå¿«é€Ÿæ¢å¤åˆ°ç¨³å®šç‰ˆæœ¬
```

### 8.2 æœ€ä½³å®è·µå»ºè®®


**âœ… æ„å»ºç­–ç•¥æœ€ä½³å®è·µ**
- **ä»“åº“ç­–ç•¥**ï¼šæ¨èæ¯ä¸ªæœåŠ¡ç‹¬ç«‹ä»“åº“ï¼Œä¾¿äºç‹¬ç«‹å‘å¸ƒ
- **æ„å»ºè§¦å‘**ï¼šåŸºäºå˜æ›´æ£€æµ‹ï¼Œé¿å…ä¸å¿…è¦çš„æ„å»º
- **å¹¶è¡Œæ„å»º**ï¼šå……åˆ†åˆ©ç”¨Jenkinså¹¶è¡Œèƒ½åŠ›ï¼Œæé«˜æ•ˆç‡
- **ç¼“å­˜ä¼˜åŒ–**ï¼šDockerå±‚ç¼“å­˜ã€Mavenä¾èµ–ç¼“å­˜ç­‰

**âœ… éƒ¨ç½²ç­–ç•¥æœ€ä½³å®è·µ**
- **ç¯å¢ƒä¸€è‡´æ€§**ï¼šå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒä¿æŒä¸€è‡´
- **æ¸è¿›å¼å‘å¸ƒ**ï¼šä»é‡‘ä¸é›€åˆ°å…¨é‡ï¼Œé€æ­¥éªŒè¯
- **å¥åº·æ£€æŸ¥**ï¼šå®Œå–„çš„å°±ç»ªæ€§å’Œå­˜æ´»æ€§æ£€æŸ¥
- **å›æ»šæœºåˆ¶**ï¼šè‡ªåŠ¨æ£€æµ‹é—®é¢˜å¹¶å¿«é€Ÿå›æ»š

**âœ… ç›‘æ§è¿ç»´æœ€ä½³å®è·µ**
- **åˆ†å±‚ç›‘æ§**ï¼šåŸºç¡€è®¾æ–½ã€åº”ç”¨æœåŠ¡ã€ä¸šåŠ¡æŒ‡æ ‡
- **å‘Šè­¦ç­–ç•¥**ï¼šé¿å…å‘Šè­¦ç–²åŠ³ï¼Œé‡è¦å‘Šè­¦åŠæ—¶å“åº”
- **æ—¥å¿—è§„èŒƒ**ï¼šç»Ÿä¸€æ—¥å¿—æ ¼å¼ï¼Œä¾¿äºæŸ¥è¯¢åˆ†æ
- **æ€§èƒ½ä¼˜åŒ–**ï¼šåŸºäºç›‘æ§æ•°æ®æŒç»­ä¼˜åŒ–

### 8.3 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ


**â“ é—®é¢˜ï¼šæœåŠ¡é—´ä¾èµ–å¯¼è‡´çš„æ„å»ºå¤±è´¥**
```
è§£å†³æ–¹æ¡ˆï¼š
1. ä½¿ç”¨APIå¥‘çº¦æµ‹è¯•ï¼Œè€Œä¸æ˜¯ä¾èµ–çœŸå®æœåŠ¡
2. æ„å»ºæ¡©æœåŠ¡(Mock Service)è¿›è¡Œæµ‹è¯•
3. åˆç†è®¾è®¡APIç‰ˆæœ¬å…¼å®¹æ€§ç­–ç•¥
```

**â“ é—®é¢˜ï¼šé…ç½®ç®¡ç†æ··ä¹±**
```
è§£å†³æ–¹æ¡ˆï¼š
1. ç»Ÿä¸€ä½¿ç”¨é…ç½®ä¸­å¿ƒç®¡ç†é…ç½®
2. æ•æ„Ÿä¿¡æ¯åŠ å¯†å­˜å‚¨
3. é…ç½®å˜æ›´è¦æœ‰å®¡æ‰¹æµç¨‹
4. é…ç½®ç‰ˆæœ¬åŒ–ç®¡ç†
```

**â“ é—®é¢˜ï¼šç›‘æ§æ•°æ®è¿‡å¤šï¼Œéš¾ä»¥åˆ†æ**
```
è§£å†³æ–¹æ¡ˆï¼š
1. å»ºç«‹ç›‘æ§æŒ‡æ ‡ä½“ç³»ï¼Œå…³æ³¨æ ¸å¿ƒæŒ‡æ ‡
2. ä½¿ç”¨ä»ªè¡¨æ¿åˆ†å±‚å±•ç¤ºä¸åŒç»´åº¦æ•°æ®
3. è®¾ç½®åˆç†çš„å‘Šè­¦é˜ˆå€¼
4. å®šæœŸå›é¡¾å’Œä¼˜åŒ–ç›‘æ§è§„åˆ™
```

### 8.4 å‘å±•è¶‹åŠ¿


**ğŸš€ æŠ€æœ¯è¶‹åŠ¿**
- **äº‘åŸç”Ÿ**ï¼šKubernetesã€æœåŠ¡ç½‘æ ¼(Service Mesh)
- **GitOps**ï¼šåŸºäºGitçš„å£°æ˜å¼è¿ç»´
- **AIè¿ç»´**ï¼šæ™ºèƒ½æ•…éšœè¯Šæ–­ã€è‡ªåŠ¨åŒ–è¿ç»´
- **è¾¹ç¼˜è®¡ç®—**ï¼šå¾®æœåŠ¡åœ¨è¾¹ç¼˜èŠ‚ç‚¹çš„éƒ¨ç½²

**ğŸ¯ å®è·µå»ºè®®**
- **æŒç»­å­¦ä¹ **ï¼šè·Ÿä¸ŠæŠ€æœ¯å‘å±•è¶‹åŠ¿
- **æ¸è¿›æ”¹è¿›**ï¼šä¸è¦ä¸€æ¬¡æ€§å¼•å…¥å¤ªå¤šæ–°æŠ€æœ¯
- **å›¢é˜Ÿåä½œ**ï¼šå¼€å‘å’Œè¿ç»´å›¢é˜Ÿç´§å¯†åˆä½œ
- **æ–‡æ¡£å®Œå–„**ï¼šè®°å½•å’Œåˆ†äº«æœ€ä½³å®è·µ

---

> ğŸ’¡ **æ€»ç»“**ï¼šå¾®æœåŠ¡CI/CDæ˜¯ä¸€ä¸ªå¤æ‚ä½†æœ‰åºçš„å·¥ç¨‹ä½“ç³»ã€‚é€šè¿‡åˆç†çš„æ¶æ„è®¾è®¡ã€è‡ªåŠ¨åŒ–å·¥å…·é“¾å’Œç›‘æ§ä½“ç³»ï¼Œå¯ä»¥å®ç°é«˜æ•ˆã€å¯é çš„å¾®æœåŠ¡äº¤ä»˜ã€‚å…³é”®æ˜¯è¦ä»é¡¹ç›®å®é™…æƒ…å†µå‡ºå‘ï¼Œå¾ªåºæ¸è¿›åœ°å»ºè®¾å’Œå®Œå–„æ•´ä¸ªä½“ç³»ã€‚

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- ğŸ—ï¸ **ç‹¬ç«‹æ„å»ºéƒ¨ç½²**ï¼šæ¯ä¸ªæœåŠ¡éƒ½æ˜¯ç‹¬ç«‹ä¸ªä½“
- ğŸ”— **æœåŠ¡ä¾èµ–ç®¡ç†**ï¼šå¥‘çº¦æµ‹è¯•ä¿è¯åä½œ
- ğŸš€ **æ¸è¿›å¼å‘å¸ƒ**ï¼šè“ç»¿é‡‘ä¸é›€å®‰å…¨å¯é   
- ğŸ“Š **å…¨æ–¹ä½ç›‘æ§**ï¼šæ—¥å¿—æŒ‡æ ‡è¿½è¸ªä¸€ä½“åŒ–