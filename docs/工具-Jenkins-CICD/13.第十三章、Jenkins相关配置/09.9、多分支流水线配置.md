---
title: 9、多分支流水线配置
---
## 📚 目录

1. [多分支流水线基础概念](#1-多分支流水线基础概念)
2. [Pipeline配置文件详解](#2-Pipeline配置文件详解)
3. [分支发现策略配置](#3-分支发现策略配置)
4. [Webhook自动触发配置](#4-Webhook自动触发配置)
5. [分支过滤与管理规则](#5-分支过滤与管理规则)
6. [构建策略与触发器](#6-构建策略与触发器)
7. [PR构建配置详解](#7-PR构建配置详解)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🌳 多分支流水线基础概念


### 1.1 什么是多分支流水线


**🔸 简单理解**
```
想象你有一个软件项目，就像一棵大树：
主干(main分支) ← 这是稳定的生产版本
 ├── 开发分支(dev) ← 日常开发工作
 ├── 功能分支(feature/user-login) ← 新功能开发
 └── 修复分支(hotfix/bug123) ← 紧急修复

传统方式：需要为每个分支手动创建Jenkins任务
多分支流水线：Jenkins自动为每个分支创建构建任务！
```

**💡 核心价值**
- **自动发现**：新建分支时，Jenkins自动创建对应的构建任务
- **统一管理**：一个配置管理所有分支的构建流程
- **分支隔离**：每个分支独立构建，互不影响

### 1.2 多分支流水线 vs 普通流水线


```
普通流水线工作方式：
一个Jenkins任务 → 固定的一个分支 → 手动配置

多分支流水线工作方式：
一个Jenkins项目 → 自动扫描所有分支 → 为每个分支创建任务

实际对比：
项目有10个分支
├── 普通方式：需要手动创建10个Jenkins任务
└── 多分支方式：只需配置1个多分支项目，自动生成10个任务
```

### 1.3 适用场景


**✅ 最适合的情况**
- 团队开发，经常创建新分支
- Git Flow 或 GitHub Flow 开发模式
- 需要对每个分支进行CI/CD
- 希望分支合并前进行自动测试

**❌ 不太适合的情况**
- 只有单一主分支的项目
- 分支变化很少的项目
- 简单的个人项目

---

## 2. 📋 Pipeline配置文件详解


### 2.1 Jenkinsfile 基础结构


**🔸 什么是Jenkinsfile**
> Jenkinsfile就像是给Jenkins写的"说明书"，告诉它如何构建你的项目。这个文件要放在代码仓库的根目录下。

**基础模板解析**
```groovy
pipeline {
    agent any  // 在任何可用的Jenkins节点上运行
    
    stages {   // 构建阶段定义
        stage('检出代码') {
            steps {
                echo '正在获取最新代码...'
            }
        }
        
        stage('编译构建') {
            steps {
                echo '正在编译项目...'
            }
        }
        
        stage('运行测试') {
            steps {
                echo '正在执行测试...'
            }
        }
        
        stage('部署') {
            steps {
                echo '正在部署应用...'
            }
        }
    }
}
```

### 2.2 多分支特定配置


**环境变量使用**
```groovy
pipeline {
    agent any
    
    environment {
        // Jenkins自动提供的分支信息
        BRANCH_NAME = "${env.BRANCH_NAME}"     // 当前分支名
        BUILD_NUMBER = "${env.BUILD_NUMBER}"   // 构建编号
    }
    
    stages {
        stage('信息显示') {
            steps {
                echo "当前构建分支: ${BRANCH_NAME}"
                echo "构建编号: ${BUILD_NUMBER}"
            }
        }
    }
}
```

**条件构建配置**
```groovy
stage('部署到生产') {
    when {
        branch 'main'  // 只有main分支才部署到生产
    }
    steps {
        echo '部署到生产环境'
    }
}

stage('部署到测试') {
    when {
        not { branch 'main' }  // 非main分支部署到测试
    }
    steps {
        echo '部署到测试环境'
    }
}
```

### 2.3 实用配置示例


**Java项目Jenkinsfile**
```groovy
pipeline {
    agent any
    
    tools {
        maven 'Maven-3.8'  // 使用指定版本的Maven
        jdk 'JDK-11'       // 使用JDK 11
    }
    
    stages {
        stage('代码检出') {
            steps {
                echo "构建分支: ${env.BRANCH_NAME}"
            }
        }
        
        stage('Maven构建') {
            steps {
                sh 'mvn clean compile'
            }
        }
        
        stage('单元测试') {
            steps {
                sh 'mvn test'
            }
            post {
                always {
                    junit 'target/surefire-reports/*.xml'
                }
            }
        }
        
        stage('打包') {
            steps {
                sh 'mvn package'
            }
        }
    }
}
```

---

## 3. 🔍 分支发现策略配置


### 3.1 分支发现策略概述


**🔸 什么是分支发现策略**
> 就像告诉Jenkins："你要关注哪些分支，忽略哪些分支"。比如你可能只想构建main、develop分支，而忽略临时的实验分支。

### 3.2 发现策略类型


**📊 主要策略对比**

| 策略类型 | **作用范围** | **适用场景** | **配置难度** |
|---------|------------|-------------|-------------|
| `所有分支` | `扫描仓库中的所有分支` | `小团队，分支少` | `简单` |
| `指定分支` | `只扫描指定的分支` | `只关注主要分支` | `中等` |
| `正则表达式` | `按规则匹配分支名` | `分支命名规范统一` | `复杂` |
| `包含/排除模式` | `灵活的包含排除规则` | `复杂的分支管理` | `中等` |

### 3.3 配置方法详解


**基础配置界面**
```
Jenkins项目配置页面：
┌─ Branch Sources ─────────────────┐
│ ✓ 发现所有分支                    │
│ ✓ 发现所有拉取请求(PR)            │
│ ✓ 从原始仓库发现拉取请求          │
└─────────────────────────────────┘
```

**高级过滤配置**
```
分支过滤器配置：
包含分支：main develop feature/*
排除分支：experimental/* temp/*

实际效果：
✅ main → 会被发现并构建
✅ develop → 会被发现并构建  
✅ feature/user-login → 会被发现并构建
❌ experimental/test123 → 被排除
❌ temp/backup → 被排除
```

### 3.4 实际配置示例


**🔧 通过界面配置**
1. 进入Jenkins项目配置页面
2. 找到"Branch Sources"部分
3. 点击"Add"添加Git源
4. 在"Behaviors"中添加过滤规则

**常用过滤规则**
- **主要分支**：`main develop release/*`
- **功能分支**：`feature/*`
- **修复分支**：`hotfix/* bugfix/*`
- **排除临时分支**：`temp/* test/* experimental/*`

---

## 4. 🔗 Webhook自动触发配置


### 4.1 Webhook基础概念


**🔸 什么是Webhook**
> Webhook就像一个"通知员"。当你往Git仓库推送代码时，Git服务器立即通知Jenkins："嘿，有新代码了，快去构建！"

```
传统方式（轮询）：
Jenkins每隔5分钟问Git："有新代码吗？"
Git："没有"
Jenkins：好的，5分钟后再问

Webhook方式：
开发者推送代码 → Git立即告诉Jenkins → Jenkins立即开始构建
效果：实时响应，不浪费资源！
```

### 4.2 GitHub Webhook配置


**📋 GitHub端配置步骤**
1. **进入仓库设置**
   - 打开GitHub仓库
   - 点击 `Settings` → `Webhooks`

2. **添加Webhook**
   ```
   Payload URL: http://你的Jenkins地址/github-webhook/
   Content type: application/json
   触发事件: 选择 "Just the push event"
   ```

3. **验证配置**
   - 推送一个小改动
   - 查看Webhook是否成功触发

**🔧 Jenkins端配置**
```
Jenkins多分支项目配置：
┌─ Build Triggers ──────────────────┐
│ ☑ GitHub hook trigger for        │
│   GITScm polling                  │
└───────────────────────────────────┘
```

### 4.3 GitLab Webhook配置


**GitLab配置示例**
```
GitLab项目设置 → Webhooks：
URL: http://Jenkins地址/project/项目名
触发器:
☑ Push events
☑ Merge request events  
☑ Branch deletion events
```

### 4.4 常见问题解决


**❓ Webhook不生效**
```
检查清单：
1. Jenkins地址是否可以从外网访问？
2. 防火墙是否开放了Jenkins端口？
3. Webhook URL是否正确？
4. Jenkins是否安装了相应插件？
```

**💡 调试技巧**
- 查看GitHub/GitLab的Webhook历史记录
- 检查Jenkins的系统日志
- 先用简单的推送测试

---

## 5. 🎯 分支过滤与管理规则


### 5.1 分支过滤基础


**🔸 为什么需要分支过滤**
> 想象你的项目有100个分支，但你只关心其中的10个重要分支。如果不过滤，Jenkins会为所有100个分支创建构建任务，浪费资源且难以管理。

### 5.2 过滤规则配置


**包含模式设置**
```
场景：只构建重要分支
包含规则：main develop release/* hotfix/*

效果：
✅ main → 构建
✅ develop → 构建
✅ release/v1.0 → 构建
✅ hotfix/urgent-fix → 构建
❌ feature/experimental → 不构建
❌ temp/backup → 不构建
```

**排除模式设置**
```
场景：排除临时和实验分支
排除规则：temp/* experimental/* test/*

效果：除了匹配排除规则的分支，其他都构建
```

### 5.3 自动分支删除配置


**🔸 什么是自动分支删除**
> 当Git仓库中的分支被删除后，Jenkins自动删除对应的构建任务，保持同步。

**配置方法**
```
Jenkins项目配置 → Branch Sources → Behaviors：
添加：Clean up stale branches
设置：删除周期 = 1天

实际效果：
1. 开发者删除了feature/old-feature分支
2. Jenkins在下次扫描时发现分支已删除
3. 自动删除对应的Jenkins构建任务
```

### 5.4 分支索引触发器


**定期扫描配置**
```
触发器设置：
☑ Periodically if not otherwise run
间隔：15分钟

作用：
- 每15分钟检查一次Git仓库
- 发现新分支时自动创建构建任务
- 发现分支删除时自动清理任务
```

**⚠️ 注意事项**
> 扫描间隔不要设置太频繁（建议15分钟以上），否则会给Git服务器造成压力。

---

## 6. ⚙️ 构建策略与触发器


### 6.1 分支构建策略


**🔸 构建策略类型对比**

| 策略名称 | **触发条件** | **适用场景** | **资源消耗** |
|---------|-------------|-------------|-------------|
| `所有分支构建` | `每次推送都构建` | `小项目，分支少` | `高` |
| `仅主分支构建` | `只有main/master构建` | `只关注生产代码` | `低` |
| `按需构建` | `手动触发或特定事件` | `大项目，资源有限` | `中` |
| `智能构建` | `基于代码变化判断` | `复杂项目优化` | `中` |

### 6.2 构建触发条件配置


**基础触发设置**
```
Build Triggers配置：
☑ Build when a change is pushed to GitHub
☑ GitHub hook trigger for GITScm polling

高级选项：
☑ Ignore changes in certain paths：忽略文档变更
路径：README.md docs/* *.md
```

**条件构建示例**
```groovy
// 在Jenkinsfile中设置条件
when {
    anyOf {
        branch 'main'
        branch 'develop'  
        branch pattern: 'release/.*', comparator: 'REGEXP'
    }
}
```

### 6.3 构建优化策略


**并发构建控制**
```
项目配置 → General：
☑ Do not allow concurrent builds
原因：避免同一分支多个构建同时进行，防止资源冲突
```

**构建历史管理**
```
设置构建保留策略：
保留天数：30天
保留构建数：最多50个

效果：自动清理旧的构建记录，节省磁盘空间
```

---

## 7. 🔄 PR构建配置详解


### 7.1 Pull Request构建基础


**🔸 什么是PR构建**
> PR（Pull Request）构建就是当有人提交合并请求时，Jenkins自动构建和测试这个请求的代码，确保代码质量后才允许合并。

```
开发流程：
1. 开发者创建功能分支：feature/new-login
2. 完成开发后创建PR：feature/new-login → main  
3. Jenkins自动构建PR代码
4. 测试通过 → 允许合并
5. 测试失败 → 阻止合并，要求修复
```

### 7.2 GitHub PR配置


**GitHub端配置**
```
GitHub仓库设置 → Settings → Branches：
分支保护规则：
☑ Require status checks before merging
☑ Require branches to be up to date
选择状态检查：continuous-integration/jenkins
```

**Jenkins端配置**
```
多分支项目 → Branch Sources → Behaviors：
添加：Discover pull requests from origin
模式：
☑ The current pull request revision
☑ Both the current pull request revision and the target branch
```

### 7.3 PR构建策略


**构建触发配置**
```groovy
// Jenkinsfile中的PR特殊处理
pipeline {
    agent any
    
    stages {
        stage('PR验证') {
            when {
                changeRequest()  // 只在PR时执行
            }
            steps {
                echo "这是PR构建: ${env.CHANGE_ID}"
                echo "目标分支: ${env.CHANGE_TARGET}"
            }
        }
        
        stage('正常构建') {
            when {
                not { changeRequest() }  // 非PR时执行
            }
            steps {
                echo "这是普通分支构建"
            }
        }
    }
}
```

### 7.4 PR状态报告


**状态反馈机制**
```
Jenkins构建完成后自动在GitHub PR页面显示：
✅ continuous-integration/jenkins/pr-merge — 构建成功
❌ continuous-integration/jenkins/pr-merge — 构建失败

开发者和审核者可以直接看到构建状态
```

**自定义状态报告**
```groovy
// 在Jenkinsfile中自定义状态
post {
    success {
        publishChecks name: 'Jenkins Build', 
                    status: 'COMPLETED', 
                    conclusion: 'SUCCESS'
    }
    failure {
        publishChecks name: 'Jenkins Build', 
                    status: 'COMPLETED', 
                    conclusion: 'FAILURE'
    }
}
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心概念


```
🔸 多分支流水线：一个项目自动管理多个分支的构建
🔸 Jenkinsfile：存放在代码仓库中的构建配置文件
🔸 分支发现：Jenkins自动扫描和发现新分支的机制
🔸 Webhook：Git服务器向Jenkins实时推送事件的机制
🔸 分支过滤：控制哪些分支需要构建，哪些忽略
🔸 PR构建：在代码合并前自动验证代码质量
```

### 8.2 关键配置要点


**🔹 项目初始化检查清单**
```
✅ Jenkinsfile是否放在仓库根目录
✅ 分支发现策略是否正确配置
✅ Webhook是否正常工作
✅ 分支过滤规则是否合理
✅ 构建触发器是否设置正确
✅ PR构建是否按预期工作
```

**🔹 日常维护要点**
```
定期检查：
- 分支是否正常同步
- 构建历史是否及时清理
- Webhook是否正常响应
- 资源使用是否合理
```

### 8.3 最佳实践建议


**🎯 分支策略建议**
```
推荐分支模式：
main/master → 生产环境自动部署
develop → 开发环境自动部署  
feature/* → 只构建和测试，不部署
release/* → 预生产环境部署
hotfix/* → 紧急修复，直接部署生产
```

**⚡ 性能优化技巧**
```
优化建议：
- 合理设置分支扫描频率（推荐15-30分钟）
- 使用分支过滤减少不必要的构建
- 设置构建历史清理策略
- 避免同一分支并发构建
- 使用缓存加速构建过程
```

**🔧 故障排查思路**
```
常见问题解决步骤：
1. 检查Webhook是否配置正确
2. 查看Jenkins系统日志
3. 验证Jenkinsfile语法
4. 确认分支权限和网络连接
5. 测试Git仓库连接性
```

### 8.4 实际应用价值


- **团队协作**：多人开发时自动化分支管理，提高效率
- **代码质量**：每个分支都经过自动化测试，保证质量
- **持续集成**：代码推送即触发构建，快速发现问题
- **部署安全**：通过PR构建确保合并代码的可靠性

**核心记忆口诀**：
- 多分支自动化，一个配置管全局
- Webhook实时推，分支过滤要合理
- PR构建质量关，合并之前先验证
- 策略配置要精准，监控维护不能停