---
title: 10、主从节点配置
---
## 📚 目录

1. [Jenkins节点架构概述](#1-Jenkins节点架构概述)
2. [主从节点基本概念](#2-主从节点基本概念)
3. [SSH从节点配置详解](#3-SSH从节点配置详解)
4. [JNLP连接配置选项](#4-JNLP连接配置选项)
5. [节点标签与容量管理](#5-节点标签与容量管理)
6. [节点环境与工具配置](#6-节点环境与工具配置)
7. [节点监控与故障排查](#7-节点监控与故障排查)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🏗️ Jenkins节点架构概述


### 1.1 什么是Jenkins节点


**通俗理解**：把Jenkins想象成一个建筑工地的总包工头
```
建筑工地类比：
总包工头（Master） ─┬─ 木工班组（Node1）
                  ├─ 水电班组（Node2）  
                  ├─ 瓦工班组（Node3）
                  └─ 油漆班组（Node4）

Jenkins架构：
Jenkins Master ─┬─ Linux构建节点
               ├─ Windows测试节点
               ├─ Docker部署节点
               └─ 移动端打包节点
```

### 1.2 为什么需要多节点


**🔸 解决的核心问题**
- **负载分担**：一个人干活太累，多人协作效率高
- **环境隔离**：不同系统需要不同的"专业工具"
- **并发执行**：同时进行多个任务，节省时间
- **资源优化**：合理利用不同机器的计算资源

**💡 实际场景举例**
```
场景1：多平台应用开发
┌─ 需要Linux环境编译后端代码
├─ 需要Windows环境测试桌面客户端  
├─ 需要macOS环境打包iOS应用
└─ 需要Docker环境部署容器应用

场景2：流水线并发处理  
并行任务：
├─ 代码静态检查（轻量级节点）
├─ 单元测试（CPU密集型节点）
├─ 集成测试（大内存节点）
└─ 性能测试（高配置节点）
```

### 1.3 节点架构图解


```
Jenkins集群架构：

                    ┌─────────────────┐
                    │  Jenkins Master │ ← 调度中心，管理所有节点
                    │   (管理节点)     │
                    └─────────┬───────┘
                              │
            ┌─────────────────┼─────────────────┐
            │                 │                 │
    ┌───────▼──────┐  ┌──────▼──────┐  ┌──────▼──────┐
    │ Linux Worker │  │Windows Worker│  │Docker Worker│
    │   (构建节点)  │  │  (测试节点)   │  │  (部署节点)  │
    └──────────────┘  └─────────────┘  └─────────────┘

工作流程：
1. Master接收构建请求
2. 根据任务需求选择合适节点
3. 分发任务到对应节点执行
4. 收集执行结果并展示
```

---

## 2. 🤝 主从节点基本概念


### 2.1 Master节点（主节点）


**🔸 核心职责**
```
就像公司的项目经理：

任务调度：决定哪个任务分配给谁
资源管理：监控各个节点的工作状态  
结果汇总：收集各节点的执行结果
用户界面：提供Web界面供用户操作
```

**Master节点主要功能**
- **任务调度器**：根据节点标签和可用性分配任务
- **配置中心**：存储所有Jenkins配置和任务定义  
- **结果收集器**：汇总各节点的构建结果和日志
- **用户交互界面**：提供Web界面进行任务管理

### 2.2 Worker节点（工作节点）


**🔸 核心职责**
```
就像公司的执行员工：

接受任务：从Master获取具体的构建任务
执行工作：在本地环境中运行构建脚本
汇报进度：实时向Master报告执行状态
提交结果：将构建产物和日志发送回Master
```

**Worker节点分类**
- **专用节点**：只执行特定类型的任务
- **通用节点**：可以执行多种类型的任务
- **临时节点**：按需创建，用完即销毁
- **永久节点**：长期存在的固定节点

### 2.3 节点通信方式对比


| 通信方式 | **SSH连接** | **JNLP连接** | **适用场景** |
|---------|------------|-------------|-------------|
| **连接方向** | `Master → Worker` | `Worker → Master` | `网络环境要求` |
| **安全性** | `SSH密钥认证` | `Token认证` | `认证方式` |
| **网络要求** | `Master能访问Worker` | `Worker能访问Master` | `防火墙配置` |
| **配置复杂度** | `中等` | `简单` | `运维难度` |
| **稳定性** | `高` | `较高` | `连接可靠性` |

---

## 3. 🔐 SSH从节点配置详解


### 3.1 SSH连接原理


**工作机制说明**
```
SSH连接就像远程遥控：

1. Master作为"遥控器"
   ├─ 保存Worker的SSH连接信息
   ├─ 主动连接到Worker机器
   └─ 通过SSH协议发送命令

2. Worker作为"被控设备"  
   ├─ 运行SSH服务等待连接
   ├─ 验证Master的访问权限
   └─ 执行收到的构建命令
```

### 3.2 SSH节点配置步骤


**🔸 第一步：准备Worker环境**
```bash
# 在Worker机器上安装Java（Jenkins必需）
sudo apt update
sudo apt install openjdk-11-jdk

# 创建Jenkins专用用户
sudo useradd -m -s /bin/bash jenkins
sudo passwd jenkins

# 创建工作目录
sudo mkdir -p /var/jenkins_workspace
sudo chown jenkins:jenkins /var/jenkins_workspace
```

**🔸 第二步：配置SSH密钥认证**
```bash
# 在Master节点生成SSH密钥对
ssh-keygen -t rsa -b 4096 -f ~/.ssh/jenkins_worker_key

# 将公钥复制到Worker节点
ssh-copy-id -i ~/.ssh/jenkins_worker_key.pub jenkins@worker-ip

# 测试SSH连接
ssh -i ~/.ssh/jenkins_worker_key jenkins@worker-ip
```

**🔸 第三步：Jenkins界面配置**

进入 **系统管理 → 节点管理 → 新建节点**

```
节点配置关键参数：

节点名称：build-server-01
描述：Linux构建专用节点

执行器数量：2          ← 同时运行的任务数
远程工作目录：/var/jenkins_workspace
标签：linux java maven  ← 节点标识标签
用法：只允许运行绑定到这台机器的Job

启动方法：通过SSH启动agents
主机：192.168.1.100    ← Worker机器IP
凭据：jenkins_ssh_key  ← SSH私钥凭据
主机密钥验证策略：已知主机文件验证策略
```

### 3.3 SSH配置文件详解


**节点配置文件位置**：`$JENKINS_HOME/nodes/[节点名]/config.xml`

```xml
<?xml version='1.0' encoding='UTF-8'?>
<slave>
  <!-- 节点基本信息 -->
  <name>build-server-01</name>
  <description>Linux构建专用节点</description>
  <remoteFS>/var/jenkins_workspace</remoteFS>
  <numExecutors>2</numExecutors>
  
  <!-- 节点模式设置 -->
  <mode>EXCLUSIVE</mode>  <!-- NORMAL: 通用模式, EXCLUSIVE: 专用模式 -->
  
  <!-- 节点标签配置 -->
  <label>linux java maven docker</label>
  
  <!-- SSH启动器配置 -->
  <launcher class="hudson.plugins.sshslaves.SSHLauncher">
    <host>192.168.1.100</host>
    <port>22</port>
    <credentialsId>jenkins-ssh-key</credentialsId>
    
    <!-- 连接超时设置 -->
    <launchTimeoutSeconds>60</launchTimeoutSeconds>
    <maxNumRetries>10</maxNumRetries>
    <retryWaitTime>15</retryWaitTime>
    
    <!-- SSH会话保持 -->
    <sshHostKeyVerificationStrategy class="hudson.plugins.sshslaves.verifiers.KnownHostsFileKeyVerificationStrategy"/>
  </launcher>
</slave>
```

### 3.4 SSH连接常见问题


**🔸 问题1：SSH连接超时**
```bash
# 检查网络连通性
ping worker-ip

# 检查SSH服务状态
ssh -v jenkins@worker-ip

# 解决方案：调整超时参数
launchTimeoutSeconds: 60 → 120
```

**🔸 问题2：权限不足**
```bash
# 确保jenkins用户有执行权限
sudo usermod -aG sudo jenkins

# 检查工作目录权限
ls -la /var/jenkins_workspace
# 应该显示 drwxr-xr-x jenkins jenkins
```

---

## 4. 🌐 JNLP连接配置选项


### 4.1 JNLP连接原理


**什么是JNLP？**
- **全称**：Java Network Launch Protocol（Java网络启动协议）
- **通俗理解**：Worker主动"打电话"给Master的连接方式

```
JNLP连接流程：

1. Master准备"接听电话"
   ├─ 开放JNLP端口（默认50000）
   ├─ 生成连接密钥（Agent Secret）
   └─ 等待Worker连接

2. Worker"拨打电话"连接
   ├─ 下载agent.jar程序
   ├─ 使用密钥认证身份
   └─ 建立长连接通道

3. 建立稳定通信
   ├─ Master分发任务
   ├─ Worker执行并回传结果
   └─ 保持心跳检测
```

### 4.2 JNLP节点配置步骤


**🔸 第一步：Master端配置**

进入 **系统管理 → 全局安全配置**

```
代理设置：
✅ 启用代理
TCP端口：50000（固定端口）或 随机（动态端口）
代理协议：启用JNLP4协议
```

**🔸 第二步：创建JNLP节点**

```
新建节点配置：

节点名称：windows-test-01
执行器数量：1
远程工作目录：C:\jenkins_workspace
标签：windows dotnet msbuild

启动方法：通过Java Web Start启动代理
✅ 允许并发构建
```

**🔸 第三步：Worker端连接**

在节点详情页面获取连接命令：

```bash
# 方式1：直接运行Java命令
java -jar agent.jar -jnlpUrl http://jenkins-master:8080/computer/windows-test-01/slave-agent.jnlp -secret 1234567890abcdef -workDir "C:\jenkins_workspace"

# 方式2：使用批处理脚本
@echo off
cd /d C:\jenkins_workspace
java -jar agent.jar -jnlpUrl http://jenkins-master:8080/computer/windows-test-01/slave-agent.jnlp -secret 1234567890abcdef -workDir "C:\jenkins_workspace"
pause
```

### 4.3 JNLP配置文件详解


```xml
<slave>
  <name>windows-test-01</name>
  <description>Windows测试环境节点</description>
  <remoteFS>C:\jenkins_workspace</remoteFS>
  <numExecutors>1</numExecutors>
  
  <!-- JNLP启动器配置 -->
  <launcher class="hudson.slaves.JNLPLauncher">
    <!-- Web Start文件URL -->
    <webStart>true</webStart>
    
    <!-- 隧道连接设置 -->
    <tunnel></tunnel>
    <vmargs>-Xmx512m</vmargs>  <!-- JVM内存设置 -->
  </launcher>
  
  <!-- 节点保留策略 -->
  <retentionStrategy class="hudson.slaves.RetentionStrategy$Always"/>
</slave>
```

### 4.4 JNLP vs SSH对比选择


**🔸 选择SSH的场景**
```
✅ Linux/Unix环境居多
✅ 网络环境稳定
✅ 有SSH管理经验
✅ 需要更高安全性
```

**🔸 选择JNLP的场景**  
```
✅ Windows环境
✅ 防火墙限制较多（Worker在内网）
✅ 动态IP环境
✅ 需要更简单的配置
```

---

## 5. 🏷️ 节点标签与容量管理


### 5.1 节点标签系统


**标签的作用**
```
标签就像员工的"技能标签"：

员工小张的技能标签：
├─ Java开发 ✅
├─ Python开发 ✅  
├─ 前端开发 ❌
└─ 运维部署 ✅

对应Jenkins节点标签：
├─ java ✅
├─ python ✅
├─ nodejs ❌  
└─ docker ✅
```

### 5.2 标签配置策略


**🔸 按技术栈分类**
```
后端开发节点：java spring maven gradle
前端开发节点：nodejs npm webpack vue react
移动开发节点：android ios flutter
运维部署节点：docker kubernetes ansible
```

**🔸 按环境分类**
```
开发环境节点：dev development testing
预发布环境：staging pre-prod
生产环境节点：prod production deploy
```

**🔸 按性能分类**
```
高性能节点：high-cpu high-memory ssd
标准配置节点：standard medium
轻量级节点：low-resource quick-build
```

### 5.3 执行器数量配置


**什么是执行器？**
```
执行器 = 节点同时处理任务的"车道数"

单车道（执行器=1）：
任务A → 任务B → 任务C  （串行执行）

双车道（执行器=2）：
任务A → 任务C  
任务B → 任务D     （并行执行）
```

**执行器数量计算公式**
```
推荐配置：
轻量级任务：执行器数 = CPU核心数 × 2
CPU密集型：执行器数 = CPU核心数 × 1
内存密集型：执行器数 = 内存GB / 任务平均内存需求

示例：
4核8G服务器 → 2-4个执行器（根据任务类型）
8核16G服务器 → 4-8个执行器  
16核32G服务器 → 8-16个执行器
```

### 5.4 节点使用模式


**🔸 使用模式对比**

| 模式 | **含义** | **适用场景** | **优缺点** |
|------|---------|-------------|-----------|
| **尽量使用这个节点** | `优先分配任务到此节点` | `高性能专用节点` | `充分利用资源，可能过载` |
| **只允许绑定任务** | `只运行指定标签的任务` | `专用环境节点` | `资源专用，利用率可能低` |

```
配置示例：

通用构建节点：
使用策略：尽量使用这个节点
标签：linux java maven

专用部署节点：  
使用策略：只允许绑定任务
标签：production deploy kubernetes
```

---

## 6. 🔧 节点环境与工具配置


### 6.1 环境变量配置


**全局环境变量 vs 节点环境变量**
```
全局环境变量（所有节点共享）：
COMPANY_NAME=MyCompany
BUILD_VERSION=1.0.0

节点专用环境变量：
JAVA_HOME=/usr/lib/jvm/java-11
MAVEN_HOME=/opt/maven
DOCKER_HOST=unix:///var/run/docker.sock
```

**在Jenkins界面配置**
```
节点配置 → 节点属性 → 环境变量：

名称：JAVA_HOME
值：/usr/lib/jvm/java-11-openjdk

名称：PATH+MAVEN  
值：/opt/maven/bin

名称：ANDROID_HOME
值：/opt/android-sdk
```

### 6.2 工具自动安装配置


**配置路径**：**系统管理 → 全局工具配置**

**🔸 JDK配置**
```
JDK安装：
名称：JDK11
✅ 自动安装
安装器：从Oracle网站安装
版本：Java SE Development Kit 11.0.12

或者：
✅ 取消自动安装  
JAVA_HOME：/usr/lib/jvm/java-11-openjdk
```

**🔸 Maven配置**
```
Maven安装：
名称：Maven-3.8.1
✅ 自动安装
安装器：从Apache安装
版本：3.8.1
```

**🔸 Git配置**
```
Git安装：
名称：Default
路径：git  （系统PATH中的git命令）

或者指定路径：
路径：/usr/bin/git
```

### 6.3 节点工作目录结构


**推荐目录结构**
```
Jenkins工作目录：/var/jenkins_workspace/
├─ workspace/           ← 任务工作空间
│  ├─ project-A/       ← 项目A的构建空间
│  ├─ project-B/       ← 项目B的构建空间  
│  └─ project-C/       ← 项目C的构建空间
├─ tools/              ← 自动安装的工具
│  ├─ jdk/            ← JDK安装目录
│  ├─ maven/          ← Maven安装目录
│  └─ gradle/         ← Gradle安装目录
└─ logs/               ← 节点日志文件
```

**磁盘空间管理**
- **工作空间清理**：定期清理旧的构建文件
- **日志轮转**：设置日志文件大小和保留时间
- **构建产物归档**：及时移动构建产物到存储系统

---

## 7. 📊 节点监控与故障排查


### 7.1 节点状态监控


**节点状态指标**
```
节点健康状态检查：

🟢 在线（Online）：节点正常工作
🟡 暂时离线（Temporarily Offline）：人工暂停
🔴 离线（Offline）：连接断开
⚠️  同步问题（Sync Issues）：时钟不同步
```

**监控关键指标**
- **CPU使用率**：避免长期高负载
- **内存使用率**：防止内存泄漏
- **磁盘空间**：确保足够的构建空间
- **网络延迟**：Master与Worker通信质量

### 7.2 常见问题排查


**🔸 问题1：节点频繁离线**
```bash
# 检查网络连接
ping jenkins-master-ip

# 查看节点日志
tail -f $JENKINS_HOME/logs/slaves/[节点名]/slave.log

# 检查防火墙设置
sudo ufw status
sudo firewall-cmd --list-all
```

**🔸 问题2：构建失败**
```bash
# 检查工作目录权限
ls -la /var/jenkins_workspace/

# 检查环境变量
env | grep -E "(JAVA|MAVEN|PATH)"

# 查看具体错误日志
cat /var/jenkins_workspace/workspace/[项目名]/[构建号]/log
```

**🔸 问题3：性能问题**
```bash
# 检查系统负载
top
htop

# 检查磁盘使用
df -h
du -sh /var/jenkins_workspace/*

# 检查内存使用
free -h
```

### 7.3 节点维护最佳实践


**🔸 定期维护任务**
```
每日检查：
├─ 节点在线状态
├─ 磁盘空间使用情况  
├─ 错误日志检查
└─ 构建队列状态

每周维护：
├─ 清理旧的工作空间
├─ 更新系统补丁
├─ 检查工具版本
└─ 备份重要配置

每月维护：
├─ 性能数据分析
├─ 容量规划评估
├─ 安全更新检查
└─ 配置优化调整
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心概念


```
🔸 节点架构：Master负责调度，Worker负责执行
🔸 连接方式：SSH（Master→Worker）vs JNLP（Worker→Master）
🔸 标签系统：通过标签实现任务与节点的精确匹配
🔸 执行器：控制节点并发处理任务的能力
🔸 环境配置：工具、环境变量、工作目录的合理设置
🔸 监控维护：持续监控节点状态，及时处理问题
```

### 8.2 关键理解要点


**🔹 什么时候需要添加节点？**
```
需要添加节点的信号：
├─ 构建队列经常排队等待
├─ 需要不同操作系统环境
├─ 需要隔离不同类型的任务  
└─ 单节点性能成为瓶颈
```

**🔹 如何选择连接方式？**
```
选择SSH：
✅ Linux/Unix环境
✅ 网络环境稳定
✅ 需要更高安全性

选择JNLP：
✅ Windows环境
✅ Worker在防火墙内网
✅ 配置要求简单
```

**🔹 标签设计原则**
```
标签命名规范：
├─ 技术栈：java, python, nodejs
├─ 环境：dev, test, prod
├─ 性能：high-cpu, high-memory
└─ 特殊能力：docker, kubernetes, mobile
```

### 8.3 实际应用价值


**🎯 业务场景应用**
- **多平台开发**：iOS、Android、Web不同环境构建
- **微服务架构**：不同服务使用专门的构建节点
- **CI/CD流水线**：测试、构建、部署使用不同节点
- **资源优化**：根据任务特点分配合适的硬件资源

**🔧 运维实践**
- **弹性扩容**：根据构建负载动态添加节点
- **故障隔离**：单个节点故障不影响整体服务
- **成本控制**：按需使用云服务器作为临时节点
- **安全隔离**：敏感任务在专用安全节点执行

**🚨 常见陷阱避免**
- ❌ **不要**在Master节点运行大量构建任务
- ❌ **不要**让所有节点使用相同标签
- ❌ **不要**忽视节点的资源监控
- ❌ **不要**在生产环境使用未经测试的节点

**核心记忆口诀**：
- 主从分工明确职责，SSH和JNLP选连接
- 标签分类巧匹配，执行器数量要合理  
- 环境工具配置好，监控维护不能少
- 多节点协作效率高，故障隔离更可靠