---
title: 23ã€ç¾éš¾æ¢å¤é…ç½®
---
## ğŸ“š ç›®å½•

1. [ç¾éš¾æ¢å¤åŸºç¡€æ¦‚å¿µ](#1-ç¾éš¾æ¢å¤åŸºç¡€æ¦‚å¿µ)
2. [æ¢å¤ç­–ç•¥é…ç½®](#2-æ¢å¤ç­–ç•¥é…ç½®)
3. [æ•°æ®æ¢å¤å®æ–½æ­¥éª¤](#3-æ•°æ®æ¢å¤å®æ–½æ­¥éª¤)
4. [é…ç½®æ–‡ä»¶æ¢å¤æ–¹æ³•](#4-é…ç½®æ–‡ä»¶æ¢å¤æ–¹æ³•)
5. [æ’ä»¶æ¢å¤é…ç½®](#5-æ’ä»¶æ¢å¤é…ç½®)
6. [ä»»åŠ¡æ¢å¤æµç¨‹é…ç½®](#6-ä»»åŠ¡æ¢å¤æµç¨‹é…ç½®)
7. [èŠ‚ç‚¹æ¢å¤é…ç½®](#7-èŠ‚ç‚¹æ¢å¤é…ç½®)
8. [å¿«é€Ÿæ¢å¤é…ç½®](#8-å¿«é€Ÿæ¢å¤é…ç½®)
9. [æ¢å¤æµ‹è¯•é…ç½®](#9-æ¢å¤æµ‹è¯•é…ç½®)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸš¨ ç¾éš¾æ¢å¤åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Jenkinsç¾éš¾æ¢å¤


**é€šä¿—ç†è§£**ï¼šå°±åƒä½ çš„ç”µè„‘çªç„¶åäº†ï¼Œéœ€è¦åœ¨æ–°ç”µè„‘ä¸Šå¿«é€Ÿæ¢å¤æ‰€æœ‰å·¥ä½œç¯å¢ƒä¸€æ ·

```
æ—¥å¸¸åœºæ™¯ç±»æ¯”ï¼š
å®¶é‡Œå¤±ç« â†’ éœ€è¦é‡å»ºå®¶å›­ â†’ ä»å¤‡ä»½ä¸­æ¢å¤é‡è¦ç‰©å“
Jenkinsæ•…éšœ â†’ éœ€è¦é‡å»ºç¯å¢ƒ â†’ ä»å¤‡ä»½ä¸­æ¢å¤é…ç½®å’Œæ•°æ®
```

**ğŸ”¸ æ ¸å¿ƒæ¦‚å¿µè§£é‡Š**
- **ç¾éš¾æ¢å¤**ï¼šå½“Jenkinså®Œå…¨æ— æ³•å·¥ä½œæ—¶ï¼Œå¿«é€Ÿæ¢å¤åˆ°æ­£å¸¸çŠ¶æ€çš„è¿‡ç¨‹
- **RTO (æ¢å¤æ—¶é—´ç›®æ ‡)**ï¼šä»æ•…éšœå‘ç”Ÿåˆ°ç³»ç»Ÿæ¢å¤æ­£å¸¸çš„æœ€å¤§å…è®¸æ—¶é—´
- **RPO (æ¢å¤ç‚¹ç›®æ ‡)**ï¼šèƒ½å¤Ÿæ¥å—çš„æœ€å¤§æ•°æ®ä¸¢å¤±æ—¶é—´

### 1.2 å¸¸è§ç¾éš¾åœºæ™¯


**ğŸ’¥ å…¸å‹æ•…éšœæƒ…å†µ**
```
ç¡¬ä»¶æ•…éšœï¼š
- æœåŠ¡å™¨ç£ç›˜æŸå
- å†…å­˜æ•…éšœå¯¼è‡´ç³»ç»Ÿå´©æºƒ
- ç½‘ç»œè®¾å¤‡æ•…éšœ

è½¯ä»¶æ•…éšœï¼š
- Jenkinsç¨‹åºæŸå
- æ“ä½œç³»ç»Ÿå´©æºƒ
- æ•°æ®åº“æ–‡ä»¶æŸå

äººä¸ºé”™è¯¯ï¼š
- è¯¯åˆ é™¤é‡è¦é…ç½®
- é”™è¯¯çš„ç³»ç»Ÿæ›´æ–°
- è¯¯æ“ä½œå¯¼è‡´çš„æ•°æ®ä¸¢å¤±

ç¯å¢ƒç¾éš¾ï¼š
- æœºæˆ¿æ–­ç”µ/ç«ç¾
- ç½‘ç»œä¸­æ–­
- äº‘æœåŠ¡å•†æ•…éšœ
```

### 1.3 æ¢å¤ç­–ç•¥ç±»å‹


**ğŸ¯ æ¢å¤ç­–ç•¥åˆ†ç±»**

| ç­–ç•¥ç±»å‹ | æ¢å¤æ—¶é—´ | æˆæœ¬ | é€‚ç”¨åœºæ™¯ |
|---------|---------|-----|----------|
| **å†·å¤‡ä»½** | æ•°å°æ—¶-æ•°å¤© | ä½ | æµ‹è¯•ç¯å¢ƒï¼Œéå…³é”®ä¸šåŠ¡ |
| **æ¸©å¤‡ä»½** | 1-4å°æ—¶ | ä¸­ | ä¸€èˆ¬ç”Ÿäº§ç¯å¢ƒ |
| **çƒ­å¤‡ä»½** | åˆ†é’Ÿçº§ | é«˜ | å…³é”®ç”Ÿäº§ç¯å¢ƒ |
| **å®æ—¶åŒæ­¥** | ç§’çº§ | å¾ˆé«˜ | é‡‘èç­‰å…³é”®è¡Œä¸š |

---

## 2. ğŸ“‹ æ¢å¤ç­–ç•¥é…ç½®


### 2.1 åˆ¶å®šæ¢å¤ç­–ç•¥


**ğŸ¯ ç­–ç•¥åˆ¶å®šæµç¨‹å›¾**
```
ä¸šåŠ¡å½±å“åˆ†æ
       â†“
ç¡®å®šRTO/RPOç›®æ ‡
       â†“
é€‰æ‹©æ¢å¤ç­–ç•¥
       â†“
è®¾è®¡æ¢å¤æµç¨‹
       â†“
å‡†å¤‡æ¢å¤èµ„æº
       â†“
åˆ¶å®šæ¢å¤æ–‡æ¡£
```

**ğŸ“Š æ¢å¤ä¼˜å…ˆçº§çŸ©é˜µ**
```
â”Œâ”€é«˜å½±å“â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        â”‚   é«˜é¢‘ä½¿ç”¨   â”‚   ä½é¢‘ä½¿ç”¨   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å…³é”®ä¸šåŠ¡ â”‚  ğŸ”¥ æœ€é«˜ä¼˜å…ˆ  â”‚  âš¡ é«˜ä¼˜å…ˆ   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä¸€èˆ¬ä¸šåŠ¡ â”‚  ğŸ“ˆ ä¸­ä¼˜å…ˆ   â”‚  ğŸ“‹ ä½ä¼˜å…ˆ   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ¢å¤ç­–ç•¥é…ç½®æ–‡ä»¶


**ğŸ“ åˆ›å»ºæ¢å¤ç­–ç•¥é…ç½®**
```bash
# åˆ›å»ºæ¢å¤ç­–ç•¥ç›®å½•
mkdir -p /opt/jenkins-recovery/strategy

# æ¢å¤ç­–ç•¥é…ç½®æ–‡ä»¶
cat > /opt/jenkins-recovery/strategy/recovery-plan.yml << 'EOF'
# Jenkinsç¾éš¾æ¢å¤ç­–ç•¥é…ç½®
recovery_strategy:
  # æ¢å¤ç›®æ ‡è®¾å®š
  targets:
    rto: "2å°æ—¶"          # æ¢å¤æ—¶é—´ç›®æ ‡
    rpo: "4å°æ—¶"          # æ¢å¤ç‚¹ç›®æ ‡
    availability: "99.5%" # å¯ç”¨æ€§ç›®æ ‡
  
  # æ¢å¤ä¼˜å…ˆçº§
  priorities:
    - name: "æ ¸å¿ƒCI/CDæµæ°´çº¿"
      level: 1
      description: "ä¸»è¦äº§å“çš„æ„å»ºéƒ¨ç½²æµæ°´çº¿"
    - name: "ç”¨æˆ·æƒé™é…ç½®"
      level: 2 
      description: "ç”¨æˆ·è´¦æˆ·å’Œæƒé™è®¾ç½®"
    - name: "æ’ä»¶é…ç½®"
      level: 3
      description: "å·²å®‰è£…æ’ä»¶å’Œé…ç½®"
    - name: "å†å²æ„å»ºè®°å½•"
      level: 4
      description: "æ„å»ºå†å²å’Œæ—¥å¿—"

  # æ¢å¤èµ„æº
  resources:
    primary_server: "jenkins-prod-01"
    backup_server: "jenkins-backup-01"
    storage: "/backup/jenkins"
    network: "10.0.1.0/24"
EOF
```

### 2.3 è‡ªåŠ¨åŒ–æ¢å¤è„šæœ¬é…ç½®


**ğŸ”§ æ¢å¤æ‰§è¡Œè„šæœ¬**
```bash
#!/bin/bash
# Jenkinsè‡ªåŠ¨æ¢å¤è„šæœ¬

# æ¢å¤é…ç½®æ–‡ä»¶
RECOVERY_CONFIG="/opt/jenkins-recovery/strategy/recovery-plan.yml"
LOG_FILE="/var/log/jenkins-recovery.log"

# æ—¥å¿—è®°å½•å‡½æ•°
log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a $LOG_FILE
}

# æ¢å¤ç­–ç•¥æ‰§è¡Œ
execute_recovery() {
    local strategy=$1
    
    case $strategy in
        "quick")
            log_message "æ‰§è¡Œå¿«é€Ÿæ¢å¤ç­–ç•¥"
            quick_recovery
            ;;
        "full")
            log_message "æ‰§è¡Œå®Œæ•´æ¢å¤ç­–ç•¥"
            full_recovery
            ;;
        "minimal")
            log_message "æ‰§è¡Œæœ€å°æ¢å¤ç­–ç•¥"
            minimal_recovery
            ;;
    esac
}

# éªŒè¯æ¢å¤ç»“æœ
verify_recovery() {
    log_message "éªŒè¯æ¢å¤ç»“æœ..."
    
    # æ£€æŸ¥JenkinsæœåŠ¡çŠ¶æ€
    if systemctl is-active --quiet jenkins; then
        log_message "âœ… JenkinsæœåŠ¡è¿è¡Œæ­£å¸¸"
    else
        log_message "âŒ JenkinsæœåŠ¡æœªæ­£å¸¸å¯åŠ¨"
        return 1
    fi
    
    # æ£€æŸ¥Webç•Œé¢è®¿é—®
    if curl -s http://localhost:8080 > /dev/null; then
        log_message "âœ… Webç•Œé¢å¯è®¿é—®"
    else
        log_message "âŒ Webç•Œé¢æ— æ³•è®¿é—®"
        return 1
    fi
}
```

---

## 3. ğŸ”„ æ•°æ®æ¢å¤å®æ–½æ­¥éª¤


### 3.1 æ¢å¤å‰å‡†å¤‡å·¥ä½œ


**ğŸ“‹ å‡†å¤‡å·¥ä½œæ¸…å•**
- [ ] ç¡®è®¤æ•…éšœèŒƒå›´å’Œå½±å“
- [ ] å‡†å¤‡æ¢å¤ç¯å¢ƒå’Œèµ„æº
- [ ] é€šçŸ¥ç›¸å…³äººå‘˜å’Œç”¨æˆ·
- [ ] è·å–æœ€æ–°å¤‡ä»½æ–‡ä»¶
- [ ] æ£€æŸ¥å¤‡ä»½æ–‡ä»¶å®Œæ•´æ€§

**ğŸ› ï¸ ç¯å¢ƒå‡†å¤‡**
```bash
# 1. åœæ­¢å¯èƒ½å­˜åœ¨çš„JenkinsæœåŠ¡
sudo systemctl stop jenkins 2>/dev/null || true

# 2. æ¸…ç†ç°æœ‰æ•°æ®ç›®å½•ï¼ˆæ³¨æ„ï¼šè¿™ä¼šåˆ é™¤ç°æœ‰æ•°æ®ï¼‰
sudo rm -rf /var/lib/jenkins/*

# 3. åˆ›å»ºå¿…è¦ç›®å½•
sudo mkdir -p /var/lib/jenkins
sudo mkdir -p /var/log/jenkins

# 4. è®¾ç½®æƒé™
sudo chown jenkins:jenkins /var/lib/jenkins
sudo chown jenkins:jenkins /var/log/jenkins
```

### 3.2 æ•°æ®æ¢å¤æ‰§è¡Œæ­¥éª¤


**ğŸ”¢ æ­¥éª¤åŒ–æ¢å¤æµç¨‹**
```
æ­¥éª¤1: ç¯å¢ƒå‡†å¤‡
       â†“
æ­¥éª¤2: æ¢å¤JENKINS_HOME
       â†“  
æ­¥éª¤3: æ¢å¤é…ç½®æ–‡ä»¶
       â†“
æ­¥éª¤4: æ¢å¤æ’ä»¶
       â†“
æ­¥éª¤5: æ¢å¤ä»»åŠ¡é…ç½®
       â†“
æ­¥éª¤6: å¯åŠ¨æœåŠ¡éªŒè¯
```

**ğŸ’¾ æ ¸å¿ƒæ•°æ®æ¢å¤**
```bash
#!/bin/bash
# Jenkinsæ•°æ®æ¢å¤è„šæœ¬

BACKUP_DIR="/backup/jenkins"
JENKINS_HOME="/var/lib/jenkins"
DATE=$(date +%Y%m%d)

# æ¢å¤JENKINS_HOMEç›®å½•
restore_jenkins_home() {
    echo "å¼€å§‹æ¢å¤Jenkinsä¸»ç›®å½•..."
    
    # æŸ¥æ‰¾æœ€æ–°å¤‡ä»½
    LATEST_BACKUP=$(ls -t $BACKUP_DIR/jenkins_home_*.tar.gz | head -1)
    
    if [ -f "$LATEST_BACKUP" ]; then
        echo "ä½¿ç”¨å¤‡ä»½æ–‡ä»¶: $LATEST_BACKUP"
        
        # è§£å‹å¤‡ä»½åˆ°ä¸´æ—¶ç›®å½•
        TEMP_DIR="/tmp/jenkins_restore_$$"
        mkdir -p $TEMP_DIR
        
        tar -xzf $LATEST_BACKUP -C $TEMP_DIR
        
        # ç§»åŠ¨æ–‡ä»¶åˆ°ç›®æ ‡ç›®å½•
        cp -r $TEMP_DIR/var/lib/jenkins/* $JENKINS_HOME/
        
        # æ¸…ç†ä¸´æ—¶ç›®å½•
        rm -rf $TEMP_DIR
        
        echo "âœ… JENKINS_HOMEæ¢å¤å®Œæˆ"
    else
        echo "âŒ æœªæ‰¾åˆ°JENKINS_HOMEå¤‡ä»½æ–‡ä»¶"
        exit 1
    fi
}

# æ¢å¤æƒé™è®¾ç½®
restore_permissions() {
    echo "æ¢å¤æ–‡ä»¶æƒé™..."
    chown -R jenkins:jenkins $JENKINS_HOME
    chmod -R 755 $JENKINS_HOME
    echo "âœ… æƒé™æ¢å¤å®Œæˆ"
}
```

### 3.3 æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥


**ğŸ” ä¸€è‡´æ€§éªŒè¯**
```bash
# æ£€æŸ¥å…³é”®é…ç½®æ–‡ä»¶
check_config_integrity() {
    local config_file="$JENKINS_HOME/config.xml"
    
    if [ -f "$config_file" ]; then
        # æ£€æŸ¥XMLæ ¼å¼æ˜¯å¦æ­£ç¡®
        if xmllint --noout "$config_file" 2>/dev/null; then
            echo "âœ… ä¸»é…ç½®æ–‡ä»¶æ ¼å¼æ­£ç¡®"
        else
            echo "âŒ ä¸»é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯"
            return 1
        fi
    else
        echo "âŒ ä¸»é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
        return 1
    fi
}

# æ£€æŸ¥æ’ä»¶å®Œæ•´æ€§
check_plugins_integrity() {
    local plugins_dir="$JENKINS_HOME/plugins"
    
    if [ -d "$plugins_dir" ]; then
        local plugin_count=$(ls $plugins_dir/*.jpi $plugins_dir/*.hpi 2>/dev/null | wc -l)
        echo "å‘ç° $plugin_count ä¸ªæ’ä»¶æ–‡ä»¶"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æŸåçš„æ’ä»¶æ–‡ä»¶
        for plugin in $plugins_dir/*.{jpi,hpi}; do
            if [ -f "$plugin" ]; then
                if ! file "$plugin" | grep -q "Zip archive"; then
                    echo "âŒ æ’ä»¶æ–‡ä»¶å¯èƒ½æŸå: $(basename $plugin)"
                fi
            fi
        done
    fi
}
```

---

## 4. âš™ï¸ é…ç½®æ–‡ä»¶æ¢å¤æ–¹æ³•


### 4.1 ä¸»è¦é…ç½®æ–‡ä»¶è¯´æ˜


**ğŸ“ é‡è¦é…ç½®æ–‡ä»¶æ¸…å•**
```
Jenkinsæ ¸å¿ƒé…ç½®æ–‡ä»¶ç»“æ„ï¼š
$JENKINS_HOME/
â”œâ”€â”€ config.xml              â† ä¸»é…ç½®æ–‡ä»¶
â”œâ”€â”€ users/                  â† ç”¨æˆ·é…ç½®ç›®å½•
â”‚   â””â”€â”€ admin/config.xml    â† ç”¨æˆ·é…ç½®æ–‡ä»¶
â”œâ”€â”€ jobs/                   â† ä»»åŠ¡é…ç½®ç›®å½•
â”‚   â””â”€â”€ my-job/config.xml   â† ä»»åŠ¡é…ç½®æ–‡ä»¶
â”œâ”€â”€ nodes/                  â† èŠ‚ç‚¹é…ç½®ç›®å½•
â”œâ”€â”€ secrets/                â† å¯†é’¥æ–‡ä»¶ç›®å½•
â”œâ”€â”€ plugins/                â† æ’ä»¶ç›®å½•
â””â”€â”€ credentials.xml         â† å‡­æ®é…ç½®æ–‡ä»¶
```

**ğŸ”§ é…ç½®æ–‡ä»¶æ¢å¤ä¼˜å…ˆçº§**
```
ä¼˜å…ˆçº§1: config.xml (ä¸»é…ç½®)
       â†“
ä¼˜å…ˆçº§2: users/ (ç”¨æˆ·é…ç½®)
       â†“  
ä¼˜å…ˆçº§3: jobs/ (ä»»åŠ¡é…ç½®)
       â†“
ä¼˜å…ˆçº§4: credentials.xml (å‡­æ®)
       â†“
ä¼˜å…ˆçº§5: nodes/ (èŠ‚ç‚¹é…ç½®)
```

### 4.2 åˆ†ç±»æ¢å¤é…ç½®æ–‡ä»¶


**ğŸ—ï¸ ä¸»é…ç½®æ–‡ä»¶æ¢å¤**
```bash
# æ¢å¤ä¸»é…ç½®æ–‡ä»¶
restore_main_config() {
    local backup_config="$BACKUP_DIR/config.xml"
    local target_config="$JENKINS_HOME/config.xml"
    
    if [ -f "$backup_config" ]; then
        echo "æ¢å¤ä¸»é…ç½®æ–‡ä»¶..."
        
        # å¤‡ä»½å½“å‰é…ç½®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if [ -f "$target_config" ]; then
            cp "$target_config" "$target_config.bak.$(date +%s)"
        fi
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶
        cp "$backup_config" "$target_config"
        
        # éªŒè¯XMLæ ¼å¼
        if xmllint --noout "$target_config" 2>/dev/null; then
            echo "âœ… ä¸»é…ç½®æ–‡ä»¶æ¢å¤æˆåŠŸ"
        else
            echo "âŒ é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œæ¢å¤å¤±è´¥"
            return 1
        fi
    else
        echo "âŒ æœªæ‰¾åˆ°ä¸»é…ç½®æ–‡ä»¶å¤‡ä»½"
        return 1
    fi
}
```

**ğŸ‘¥ ç”¨æˆ·é…ç½®æ¢å¤**
```bash
# æ¢å¤ç”¨æˆ·é…ç½®
restore_user_configs() {
    local backup_users="$BACKUP_DIR/users"
    local target_users="$JENKINS_HOME/users"
    
    if [ -d "$backup_users" ]; then
        echo "æ¢å¤ç”¨æˆ·é…ç½®..."
        
        # åˆ›å»ºç”¨æˆ·ç›®å½•
        mkdir -p "$target_users"
        
        # å¤åˆ¶æ‰€æœ‰ç”¨æˆ·é…ç½®
        cp -r "$backup_users"/* "$target_users/" 2>/dev/null
        
        # è®¾ç½®æƒé™
        chown -R jenkins:jenkins "$target_users"
        
        echo "âœ… ç”¨æˆ·é…ç½®æ¢å¤å®Œæˆ"
    else
        echo "âš ï¸ æœªæ‰¾åˆ°ç”¨æˆ·é…ç½®å¤‡ä»½"
    fi
}
```

### 4.3 é…ç½®æ–‡ä»¶éªŒè¯å’Œä¿®å¤


**ğŸ” é…ç½®éªŒè¯è„šæœ¬**
```bash
# éªŒè¯é…ç½®æ–‡ä»¶å®Œæ•´æ€§
validate_configs() {
    echo "éªŒè¯é…ç½®æ–‡ä»¶..."
    
    local error_count=0
    
    # æ£€æŸ¥ä¸»é…ç½®æ–‡ä»¶
    if [ -f "$JENKINS_HOME/config.xml" ]; then
        if ! xmllint --noout "$JENKINS_HOME/config.xml" 2>/dev/null; then
            echo "âŒ ä¸»é…ç½®æ–‡ä»¶XMLæ ¼å¼é”™è¯¯"
            ((error_count++))
        fi
    else
        echo "âŒ ä¸»é…ç½®æ–‡ä»¶ç¼ºå¤±"
        ((error_count++))
    fi
    
    # æ£€æŸ¥ç”¨æˆ·é…ç½®æ–‡ä»¶
    if [ -d "$JENKINS_HOME/users" ]; then
        for user_config in "$JENKINS_HOME/users"/*/config.xml; do
            if [ -f "$user_config" ]; then
                if ! xmllint --noout "$user_config" 2>/dev/null; then
                    echo "âŒ ç”¨æˆ·é…ç½®æ–‡ä»¶é”™è¯¯: $user_config"
                    ((error_count++))
                fi
            fi
        done
    fi
    
    # æ£€æŸ¥ä»»åŠ¡é…ç½®æ–‡ä»¶
    if [ -d "$JENKINS_HOME/jobs" ]; then
        for job_config in "$JENKINS_HOME/jobs"/*/config.xml; do
            if [ -f "$job_config" ]; then
                if ! xmllint --noout "$job_config" 2>/dev/null; then
                    echo "âŒ ä»»åŠ¡é…ç½®æ–‡ä»¶é”™è¯¯: $job_config"
                    ((error_count++))
                fi
            fi
        done
    fi
    
    if [ $error_count -eq 0 ]; then
        echo "âœ… æ‰€æœ‰é…ç½®æ–‡ä»¶éªŒè¯é€šè¿‡"
        return 0
    else
        echo "âŒ å‘ç° $error_count ä¸ªé…ç½®æ–‡ä»¶é”™è¯¯"
        return 1
    fi
}
```

---

## 5. ğŸ”Œ æ’ä»¶æ¢å¤é…ç½®


### 5.1 æ’ä»¶æ¢å¤ç­–ç•¥


**ğŸ¯ æ’ä»¶æ¢å¤æ–¹æ³•å¯¹æ¯”**

| æ¢å¤æ–¹æ³• | é€Ÿåº¦ | å¯é æ€§ | é€‚ç”¨åœºæ™¯ |
|---------|-----|-------|----------|
| **ç›´æ¥å¤åˆ¶æ’ä»¶æ–‡ä»¶** | å¿« | é«˜ | åŒç‰ˆæœ¬Jenkinsæ¢å¤ |
| **æ‰¹é‡å®‰è£…æ’ä»¶** | æ…¢ | ä¸­ | è·¨ç‰ˆæœ¬æ¢å¤ |
| **æ··åˆæ–¹å¼** | ä¸­ | é«˜ | å¤§å¤šæ•°æƒ…å†µ |

### 5.2 æ’ä»¶æ–‡ä»¶æ¢å¤


**ğŸ“¦ ç›´æ¥æ¢å¤æ’ä»¶æ–‡ä»¶**
```bash
# æ¢å¤æ’ä»¶æ–‡ä»¶
restore_plugins() {
    local backup_plugins="$BACKUP_DIR/plugins"
    local target_plugins="$JENKINS_HOME/plugins"
    
    echo "å¼€å§‹æ¢å¤Jenkinsæ’ä»¶..."
    
    if [ -d "$backup_plugins" ]; then
        # åˆ›å»ºæ’ä»¶ç›®å½•
        mkdir -p "$target_plugins"
        
        # å¤åˆ¶æ’ä»¶æ–‡ä»¶
        echo "å¤åˆ¶æ’ä»¶æ–‡ä»¶..."
        cp -r "$backup_plugins"/* "$target_plugins/" 2>/dev/null
        
        # è®¾ç½®æƒé™
        chown -R jenkins:jenkins "$target_plugins"
        
        # ç»Ÿè®¡æ’ä»¶æ•°é‡
        local plugin_count=$(ls "$target_plugins"/*.{jpi,hpi} 2>/dev/null | wc -l)
        echo "æ¢å¤äº† $plugin_count ä¸ªæ’ä»¶"
        
        echo "âœ… æ’ä»¶æ¢å¤å®Œæˆ"
    else
        echo "âŒ æœªæ‰¾åˆ°æ’ä»¶å¤‡ä»½ç›®å½•"
        return 1
    fi
}
```

### 5.3 æ’ä»¶åˆ—è¡¨æ¢å¤


**ğŸ“‹ ä»æ’ä»¶åˆ—è¡¨é‡æ–°å®‰è£…**
```bash
# ä»æ’ä»¶åˆ—è¡¨é‡æ–°å®‰è£…
reinstall_plugins_from_list() {
    local plugin_list="$BACKUP_DIR/installed-plugins.txt"
    
    if [ -f "$plugin_list" ]; then
        echo "ä»æ’ä»¶åˆ—è¡¨é‡æ–°å®‰è£…..."
        
        # å¯åŠ¨JenkinsæœåŠ¡ï¼ˆå¦‚æœæœªå¯åŠ¨ï¼‰
        systemctl start jenkins
        
        # ç­‰å¾…Jenkinså¯åŠ¨å®Œæˆ
        wait_for_jenkins_startup
        
        # è¯»å–æ’ä»¶åˆ—è¡¨å¹¶å®‰è£…
        while IFS= read -r plugin; do
            if [ -n "$plugin" ] && [[ ! "$plugin" =~ ^# ]]; then
                echo "å®‰è£…æ’ä»¶: $plugin"
                install_plugin_via_cli "$plugin"
            fi
        done < "$plugin_list"
        
        echo "âœ… æ’ä»¶é‡æ–°å®‰è£…å®Œæˆ"
    else
        echo "âŒ æœªæ‰¾åˆ°æ’ä»¶åˆ—è¡¨æ–‡ä»¶"
        return 1
    fi
}

# é€šè¿‡CLIå®‰è£…æ’ä»¶
install_plugin_via_cli() {
    local plugin_name=$1
    local jenkins_cli="java -jar jenkins-cli.jar"
    
    # ä½¿ç”¨Jenkins CLIå®‰è£…æ’ä»¶
    $jenkins_cli -s http://localhost:8080 install-plugin "$plugin_name"
}
```

### 5.4 æ’ä»¶å…¼å®¹æ€§æ£€æŸ¥


**ğŸ” æ’ä»¶å…¼å®¹æ€§éªŒè¯**
```bash
# æ£€æŸ¥æ’ä»¶å…¼å®¹æ€§
check_plugin_compatibility() {
    echo "æ£€æŸ¥æ’ä»¶å…¼å®¹æ€§..."
    
    local plugins_dir="$JENKINS_HOME/plugins"
    local incompatible_count=0
    
    # è·å–Jenkinsç‰ˆæœ¬
    local jenkins_version=$(java -jar /usr/share/jenkins/jenkins.war --version)
    echo "å½“å‰Jenkinsç‰ˆæœ¬: $jenkins_version"
    
    # æ£€æŸ¥æ¯ä¸ªæ’ä»¶
    for plugin_file in "$plugins_dir"/*.{jpi,hpi}; do
        if [ -f "$plugin_file" ]; then
            local plugin_name=$(basename "$plugin_file" | sed 's/\.[^.]*$//')
            
            # ç®€å•çš„å…¼å®¹æ€§æ£€æŸ¥ï¼ˆå®é™…åº”è¯¥æ›´å¤æ‚ï¼‰
            if check_plugin_manifest "$plugin_file" "$jenkins_version"; then
                echo "âœ… $plugin_name å…¼å®¹"
            else
                echo "âš ï¸ $plugin_name å¯èƒ½ä¸å…¼å®¹"
                ((incompatible_count++))
            fi
        fi
    done
    
    if [ $incompatible_count -gt 0 ]; then
        echo "âš ï¸ å‘ç° $incompatible_count ä¸ªå¯èƒ½ä¸å…¼å®¹çš„æ’ä»¶"
    else
        echo "âœ… æ‰€æœ‰æ’ä»¶å…¼å®¹æ€§æ£€æŸ¥é€šè¿‡"
    fi
}
```

---

## 6. ğŸ”§ ä»»åŠ¡æ¢å¤æµç¨‹é…ç½®


### 6.1 ä»»åŠ¡æ¢å¤ç­–ç•¥


**ğŸ“Š ä»»åŠ¡æ¢å¤ä¼˜å…ˆçº§åˆ†æ**
```
å…³é”®ä»»åŠ¡æ¢å¤æµç¨‹ï¼š
â”Œâ”€ç”Ÿäº§éƒ¨ç½²ä»»åŠ¡â”€â”     ä¼˜å…ˆçº§: ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥
â”œâ”€æ ¸å¿ƒæµ‹è¯•ä»»åŠ¡â”€â”¤     ä¼˜å…ˆçº§: ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥
â”œâ”€åŠŸèƒ½æµ‹è¯•ä»»åŠ¡â”€â”¤     ä¼˜å…ˆçº§: ğŸ”¥ğŸ”¥ğŸ”¥  
â”œâ”€ä»£ç æ‰«æä»»åŠ¡â”€â”¤     ä¼˜å…ˆçº§: ğŸ”¥ğŸ”¥
â””â”€å®éªŒæ€§ä»»åŠ¡â”€â”€â”˜     ä¼˜å…ˆçº§: ğŸ”¥
```

### 6.2 ä»»åŠ¡é…ç½®æ¢å¤


**ğŸ—ï¸ æ‰¹é‡æ¢å¤ä»»åŠ¡**
```bash
# æ¢å¤Jenkinsä»»åŠ¡
restore_jobs() {
    local backup_jobs="$BACKUP_DIR/jobs"
    local target_jobs="$JENKINS_HOME/jobs"
    
    echo "å¼€å§‹æ¢å¤Jenkinsä»»åŠ¡..."
    
    if [ -d "$backup_jobs" ]; then
        # åˆ›å»ºä»»åŠ¡ç›®å½•
        mkdir -p "$target_jobs"
        
        # æ¢å¤æ¯ä¸ªä»»åŠ¡
        for job_backup in "$backup_jobs"/*; do
            if [ -d "$job_backup" ]; then
                local job_name=$(basename "$job_backup")
                echo "æ¢å¤ä»»åŠ¡: $job_name"
                
                # å¤åˆ¶ä»»åŠ¡é…ç½®
                cp -r "$job_backup" "$target_jobs/"
                
                # éªŒè¯ä»»åŠ¡é…ç½®
                if validate_job_config "$target_jobs/$job_name/config.xml"; then
                    echo "âœ… ä»»åŠ¡ $job_name æ¢å¤æˆåŠŸ"
                else
                    echo "âŒ ä»»åŠ¡ $job_name é…ç½®éªŒè¯å¤±è´¥"
                fi
            fi
        done
        
        # è®¾ç½®æƒé™
        chown -R jenkins:jenkins "$target_jobs"
        
        echo "âœ… ä»»åŠ¡æ¢å¤å®Œæˆ"
    else
        echo "âŒ æœªæ‰¾åˆ°ä»»åŠ¡å¤‡ä»½ç›®å½•"
        return 1
    fi
}

# éªŒè¯ä»»åŠ¡é…ç½®
validate_job_config() {
    local config_file=$1
    
    if [ -f "$config_file" ]; then
        # æ£€æŸ¥XMLæ ¼å¼
        if xmllint --noout "$config_file" 2>/dev/null; then
            return 0
        else
            return 1
        fi
    else
        return 1
    fi
}
```

### 6.3 ä»»åŠ¡ä¾èµ–å…³ç³»æ¢å¤


**ğŸ”— æ¢å¤ä»»åŠ¡é—´ä¾èµ–**
```bash
# åˆ†æå’Œæ¢å¤ä»»åŠ¡ä¾èµ–å…³ç³»
restore_job_dependencies() {
    echo "åˆ†æä»»åŠ¡ä¾èµ–å…³ç³»..."
    
    local jobs_dir="$JENKINS_HOME/jobs"
    local dependency_map="/tmp/job_dependencies.txt"
    
    # æ¸…ç©ºä¾èµ–æ˜ å°„æ–‡ä»¶
    > "$dependency_map"
    
    # æ‰«ææ‰€æœ‰ä»»åŠ¡çš„ä¾èµ–å…³ç³»
    for job_dir in "$jobs_dir"/*; do
        if [ -d "$job_dir" ]; then
            local job_name=$(basename "$job_dir")
            local config_file="$job_dir/config.xml"
            
            if [ -f "$config_file" ]; then
                # æŸ¥æ‰¾ä¸Šæ¸¸ä»»åŠ¡ä¾èµ–
                local upstream_jobs=$(grep -o '<upstreamProjects>[^<]*</upstreamProjects>' "$config_file" | sed 's/<[^>]*>//g')
                
                if [ -n "$upstream_jobs" ]; then
                    echo "$job_name ä¾èµ–: $upstream_jobs" >> "$dependency_map"
                fi
                
                # æŸ¥æ‰¾ä¸‹æ¸¸ä»»åŠ¡ä¾èµ–
                local downstream_jobs=$(grep -o '<downstreamProjects>[^<]*</downstreamProjects>' "$config_file" | sed 's/<[^>]*>//g')
                
                if [ -n "$downstream_jobs" ]; then
                    echo "$job_name è§¦å‘: $downstream_jobs" >> "$dependency_map"
                fi
            fi
        fi
    done
    
    echo "ä»»åŠ¡ä¾èµ–å…³ç³»åˆ†æå®Œæˆ"
    echo "ä¾èµ–å…³ç³»è¯¦æƒ…è¯·æŸ¥çœ‹: $dependency_map"
}
```

---

## 7. ğŸ–¥ï¸ èŠ‚ç‚¹æ¢å¤é…ç½®


### 7.1 èŠ‚ç‚¹æ¢å¤æ¦‚è¿°


**ğŸŒ JenkinsèŠ‚ç‚¹æ¶æ„å›¾**
```
Jenkinsé›†ç¾¤æ¢å¤æ¶æ„ï¼š
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   MasterèŠ‚ç‚¹    â”‚  â† ä¸»æ§åˆ¶å™¨
        â”‚   (Controller)  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                 â”‚
 â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
 â”‚   Agent-1   â”‚   â”‚   Agent-2   â”‚  â† æ‰§è¡ŒèŠ‚ç‚¹
 â”‚  (æ„å»ºèŠ‚ç‚¹)  â”‚   â”‚  (æµ‹è¯•èŠ‚ç‚¹)  â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 ä¸»èŠ‚ç‚¹æ¢å¤é…ç½®


**ğŸ¯ MasterèŠ‚ç‚¹æ¢å¤**
```bash
# æ¢å¤Jenkinsä¸»èŠ‚ç‚¹
restore_master_node() {
    echo "å¼€å§‹æ¢å¤Jenkinsä¸»èŠ‚ç‚¹..."
    
    # 1. æ¢å¤ä¸»èŠ‚ç‚¹é…ç½®
    restore_main_config
    
    # 2. æ¢å¤å¯†é’¥æ–‡ä»¶
    restore_secrets
    
    # 3. æ¢å¤èŠ‚ç‚¹é…ç½®
    restore_node_configs
    
    # 4. å¯åŠ¨æœåŠ¡
    systemctl start jenkins
    
    # 5. ç­‰å¾…å¯åŠ¨å®Œæˆ
    wait_for_jenkins_startup
    
    echo "âœ… ä¸»èŠ‚ç‚¹æ¢å¤å®Œæˆ"
}

# æ¢å¤å¯†é’¥æ–‡ä»¶
restore_secrets() {
    local backup_secrets="$BACKUP_DIR/secrets"
    local target_secrets="$JENKINS_HOME/secrets"
    
    if [ -d "$backup_secrets" ]; then
        echo "æ¢å¤å¯†é’¥æ–‡ä»¶..."
        
        mkdir -p "$target_secrets"
        cp -r "$backup_secrets"/* "$target_secrets/"
        
        # è®¾ç½®ä¸¥æ ¼æƒé™
        chown -R jenkins:jenkins "$target_secrets"
        chmod -R 600 "$target_secrets"/*
        
        echo "âœ… å¯†é’¥æ–‡ä»¶æ¢å¤å®Œæˆ"
    else
        echo "âš ï¸ æœªæ‰¾åˆ°å¯†é’¥æ–‡ä»¶å¤‡ä»½"
    fi
}
```

### 7.3 AgentèŠ‚ç‚¹æ¢å¤é…ç½®


**ğŸ”§ AgentèŠ‚ç‚¹é‡æ–°è¿æ¥**
```bash
# æ¢å¤å¹¶é‡æ–°è¿æ¥AgentèŠ‚ç‚¹
restore_agent_nodes() {
    echo "æ¢å¤AgentèŠ‚ç‚¹é…ç½®..."
    
    local nodes_dir="$JENKINS_HOME/nodes"
    local backup_nodes="$BACKUP_DIR/nodes"
    
    if [ -d "$backup_nodes" ]; then
        # åˆ›å»ºèŠ‚ç‚¹ç›®å½•
        mkdir -p "$nodes_dir"
        
        # æ¢å¤æ¯ä¸ªèŠ‚ç‚¹é…ç½®
        for node_backup in "$backup_nodes"/*; do
            if [ -d "$node_backup" ]; then
                local node_name=$(basename "$node_backup")
                echo "æ¢å¤èŠ‚ç‚¹: $node_name"
                
                # å¤åˆ¶èŠ‚ç‚¹é…ç½®
                cp -r "$node_backup" "$nodes_dir/"
                
                # é‡æ–°è¿æ¥èŠ‚ç‚¹
                reconnect_agent_node "$node_name"
            fi
        done
        
        # è®¾ç½®æƒé™
        chown -R jenkins:jenkins "$nodes_dir"
        
        echo "âœ… AgentèŠ‚ç‚¹æ¢å¤å®Œæˆ"
    else
        echo "âŒ æœªæ‰¾åˆ°èŠ‚ç‚¹é…ç½®å¤‡ä»½"
        return 1
    fi
}

# é‡æ–°è¿æ¥å•ä¸ªAgentèŠ‚ç‚¹
reconnect_agent_node() {
    local node_name=$1
    
    echo "é‡æ–°è¿æ¥èŠ‚ç‚¹: $node_name"
    
    # é€šè¿‡Jenkins CLIé‡æ–°è¿æ¥
    java -jar jenkins-cli.jar -s http://localhost:8080 connect-node "$node_name"
    
    # æ£€æŸ¥è¿æ¥çŠ¶æ€
    sleep 5
    local status=$(java -jar jenkins-cli.jar -s http://localhost:8080 get-node "$node_name" | grep -o 'online="[^"]*"' | cut -d'"' -f2)
    
    if [ "$status" = "true" ]; then
        echo "âœ… èŠ‚ç‚¹ $node_name è¿æ¥æˆåŠŸ"
    else
        echo "âŒ èŠ‚ç‚¹ $node_name è¿æ¥å¤±è´¥"
    fi
}
```

---

## 8. âš¡ å¿«é€Ÿæ¢å¤é…ç½®


### 8.1 å¿«é€Ÿæ¢å¤ç­–ç•¥


**ğŸš€ å¿«é€Ÿæ¢å¤ç›®æ ‡**
- **æ¢å¤æ—¶é—´**: < 30åˆ†é’Ÿ
- **åŸºæœ¬åŠŸèƒ½**: æ ¸å¿ƒCI/CDæµæ°´çº¿
- **æ•°æ®ä¸¢å¤±**: < 4å°æ—¶å¤‡ä»½é—´éš”

### 8.2 å¿«é€Ÿæ¢å¤è„šæœ¬


**âš¡ ä¸€é”®å¿«é€Ÿæ¢å¤**
```bash
#!/bin/bash
# Jenkinså¿«é€Ÿæ¢å¤è„šæœ¬

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LOG_FILE="/var/log/jenkins-quick-recovery.log"

# å¿«é€Ÿæ¢å¤ä¸»å‡½æ•°
quick_recovery() {
    echo "=== Jenkinså¿«é€Ÿæ¢å¤å¼€å§‹ ===" | tee -a $LOG_FILE
    local start_time=$(date +%s)
    
    # æ­¥éª¤1: åœæ­¢ç°æœ‰æœåŠ¡
    echo "æ­¥éª¤1: åœæ­¢JenkinsæœåŠ¡..." | tee -a $LOG_FILE
    systemctl stop jenkins 2>/dev/null || true
    
    # æ­¥éª¤2: å¿«é€Ÿæ¢å¤æ ¸å¿ƒé…ç½®
    echo "æ­¥éª¤2: æ¢å¤æ ¸å¿ƒé…ç½®..." | tee -a $LOG_FILE
    restore_core_config
    
    # æ­¥éª¤3: æ¢å¤å…³é”®ä»»åŠ¡
    echo "æ­¥éª¤3: æ¢å¤å…³é”®ä»»åŠ¡..." | tee -a $LOG_FILE
    restore_critical_jobs
    
    # æ­¥éª¤4: å¯åŠ¨æœåŠ¡
    echo "æ­¥éª¤4: å¯åŠ¨JenkinsæœåŠ¡..." | tee -a $LOG_FILE
    systemctl start jenkins
    
    # æ­¥éª¤5: éªŒè¯æ¢å¤
    echo "æ­¥éª¤5: éªŒè¯æ¢å¤ç»“æœ..." | tee -a $LOG_FILE
    if verify_quick_recovery; then
        local end_time=$(date +%s)
        local duration=$((end_time - start_time))
        echo "âœ… å¿«é€Ÿæ¢å¤æˆåŠŸï¼è€—æ—¶: ${duration}ç§’" | tee -a $LOG_FILE
    else
        echo "âŒ å¿«é€Ÿæ¢å¤å¤±è´¥ï¼" | tee -a $LOG_FILE
        return 1
    fi
}

# æ¢å¤æ ¸å¿ƒé…ç½®ï¼ˆæœ€å°é›†åˆï¼‰
restore_core_config() {
    local backup_dir="/backup/jenkins/latest"
    
    # åªæ¢å¤æœ€å…³é”®çš„é…ç½®æ–‡ä»¶
    local core_files=(
        "config.xml"
        "credentials.xml" 
        "users/admin/config.xml"
    )
    
    for file in "${core_files[@]}"; do
        local backup_file="$backup_dir/$file"
        local target_file="$JENKINS_HOME/$file"
        
        if [ -f "$backup_file" ]; then
            mkdir -p "$(dirname "$target_file")"
            cp "$backup_file" "$target_file"
            echo "âœ… æ¢å¤: $file"
        else
            echo "âš ï¸ è·³è¿‡: $file (å¤‡ä»½ä¸å­˜åœ¨)"
        fi
    done
}

# æ¢å¤å…³é”®ä»»åŠ¡ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰
restore_critical_jobs() {
    local critical_jobs=(
        "production-deploy"
        "main-branch-build"
        "integration-test"
    )
    
    for job in "${critical_jobs[@]}"; do
        restore_single_job "$job"
    done
}

# æ¢å¤å•ä¸ªä»»åŠ¡
restore_single_job() {
    local job_name=$1
    local backup_job="/backup/jenkins/latest/jobs/$job_name"
    local target_job="$JENKINS_HOME/jobs/$job_name"
    
    if [ -d "$backup_job" ]; then
        mkdir -p "$target_job"
        cp -r "$backup_job"/* "$target_job/"
        echo "âœ… æ¢å¤ä»»åŠ¡: $job_name"
    else
        echo "âš ï¸ è·³è¿‡ä»»åŠ¡: $job_name (å¤‡ä»½ä¸å­˜åœ¨)"
    fi
}
```

### 8.3 å¿«é€ŸéªŒè¯æœºåˆ¶


**ğŸ” å¿«é€ŸéªŒè¯è„šæœ¬**
```bash
# å¿«é€ŸéªŒè¯æ¢å¤ç»“æœ
verify_quick_recovery() {
    local checks_passed=0
    local total_checks=4
    
    echo "å¼€å§‹å¿«é€ŸéªŒè¯..."
    
    # æ£€æŸ¥1: JenkinsæœåŠ¡çŠ¶æ€
    if systemctl is-active --quiet jenkins; then
        echo "âœ… JenkinsæœåŠ¡è¿è¡Œæ­£å¸¸"
        ((checks_passed++))
    else
        echo "âŒ JenkinsæœåŠ¡æœªå¯åŠ¨"
    fi
    
    # æ£€æŸ¥2: Webç•Œé¢å“åº”
    if wait_for_jenkins_startup 60; then
        echo "âœ… Webç•Œé¢å“åº”æ­£å¸¸"
        ((checks_passed++))
    else
        echo "âŒ Webç•Œé¢æ— å“åº”"
    fi
    
    # æ£€æŸ¥3: æ ¸å¿ƒä»»åŠ¡å­˜åœ¨
    local critical_job="production-deploy"
    if [ -d "$JENKINS_HOME/jobs/$critical_job" ]; then
        echo "âœ… å…³é”®ä»»åŠ¡é…ç½®å­˜åœ¨"
        ((checks_passed++))
    else
        echo "âŒ å…³é”®ä»»åŠ¡é…ç½®ç¼ºå¤±"
    fi
    
    # æ£€æŸ¥4: ç”¨æˆ·å¯ä»¥ç™»å½•
    if check_admin_login; then
        echo "âœ… ç®¡ç†å‘˜å¯ä»¥ç™»å½•"
        ((checks_passed++))
    else
        echo "âŒ ç®¡ç†å‘˜ç™»å½•å¤±è´¥"
    fi
    
    echo "éªŒè¯å®Œæˆ: $checks_passed/$total_checks é¡¹é€šè¿‡"
    
    if [ $checks_passed -ge 3 ]; then
        return 0
    else
        return 1
    fi
}

# ç­‰å¾…Jenkinså¯åŠ¨
wait_for_jenkins_startup() {
    local timeout=${1:-120}
    local count=0
    
    while [ $count -lt $timeout ]; do
        if curl -s -f http://localhost:8080/login >/dev/null 2>&1; then
            return 0
        fi
        sleep 2
        ((count += 2))
    done
    
    return 1
}
```

---

## 9. ğŸ§ª æ¢å¤æµ‹è¯•é…ç½®


### 9.1 æµ‹è¯•ç¯å¢ƒå‡†å¤‡


**ğŸ”¬ æµ‹è¯•ç¯å¢ƒæ¶æ„**
```
ç”Ÿäº§ç¯å¢ƒ          æµ‹è¯•ç¯å¢ƒ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Jenkins-Prod â”‚   â”‚Jenkins-Test â”‚
â”‚   (ä¸»ç¯å¢ƒ)   â”‚   â”‚  (æµ‹è¯•ç¯å¢ƒ)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                  â–²
        â”‚ å¤‡ä»½æ•°æ®          â”‚ æ¢å¤æµ‹è¯•
        â–¼                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¤‡ä»½å­˜å‚¨   â”‚   â”‚  æµ‹è¯•ç»“æœ   â”‚
â”‚  (Backup)   â”‚   â”‚ (Results)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.2 æ¢å¤æµ‹è¯•è„šæœ¬


**ğŸ§ª è‡ªåŠ¨åŒ–æ¢å¤æµ‹è¯•**
```bash
#!/bin/bash
# Jenkinsæ¢å¤æµ‹è¯•è„šæœ¬

TEST_ENV="/opt/jenkins-test"
TEST_LOG="/var/log/jenkins-recovery-test.log"

# ä¸»æµ‹è¯•å‡½æ•°
run_recovery_test() {
    echo "=== Jenkinsæ¢å¤æµ‹è¯•å¼€å§‹ ===" | tee -a $TEST_LOG
    
    # å‡†å¤‡æµ‹è¯•ç¯å¢ƒ
    prepare_test_environment
    
    # æ‰§è¡Œæ¢å¤æµ‹è¯•
    execute_recovery_tests
    
    # ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
    generate_test_report
    
    echo "=== Jenkinsæ¢å¤æµ‹è¯•å®Œæˆ ===" | tee -a $TEST_LOG
}

# å‡†å¤‡æµ‹è¯•ç¯å¢ƒ
prepare_test_environment() {
    echo "å‡†å¤‡æµ‹è¯•ç¯å¢ƒ..." | tee -a $TEST_LOG
    
    # åˆ›å»ºæµ‹è¯•ç›®å½•
    mkdir -p $TEST_ENV
    
    # æ¨¡æ‹Ÿå…¨æ–°å®‰è£…ç¯å¢ƒ
    if [ -d "$TEST_ENV/jenkins_home" ]; then
        rm -rf "$TEST_ENV/jenkins_home"
    fi
    
    mkdir -p "$TEST_ENV/jenkins_home"
    
    echo "âœ… æµ‹è¯•ç¯å¢ƒå‡†å¤‡å®Œæˆ" | tee -a $TEST_LOG
}

# æ‰§è¡Œæ¢å¤æµ‹è¯•
execute_recovery_tests() {
    echo "æ‰§è¡Œæ¢å¤æµ‹è¯•..." | tee -a $TEST_LOG
    
    local test_results=()
    
    # æµ‹è¯•1: é…ç½®æ–‡ä»¶æ¢å¤
    echo "æµ‹è¯•1: é…ç½®æ–‡ä»¶æ¢å¤..." | tee -a $TEST_LOG
    if test_config_recovery; then
        test_results+=("é…ç½®æ–‡ä»¶æ¢å¤: âœ…")
    else
        test_results+=("é…ç½®æ–‡ä»¶æ¢å¤: âŒ")
    fi
    
    # æµ‹è¯•2: ä»»åŠ¡æ¢å¤
    echo "æµ‹è¯•2: ä»»åŠ¡æ¢å¤..." | tee -a $TEST_LOG
    if test_jobs_recovery; then
        test_results+=("ä»»åŠ¡æ¢å¤: âœ…")
    else
        test_results+=("ä»»åŠ¡æ¢å¤: âŒ")
    fi
    
    # æµ‹è¯•3: æ’ä»¶æ¢å¤
    echo "æµ‹è¯•3: æ’ä»¶æ¢å¤..." | tee -a $TEST_LOG
    if test_plugins_recovery; then
        test_results+=("æ’ä»¶æ¢å¤: âœ…")
    else
        test_results+=("æ’ä»¶æ¢å¤: âŒ")
    fi
    
    # æµ‹è¯•4: ç”¨æˆ·æ¢å¤
    echo "æµ‹è¯•4: ç”¨æˆ·æ¢å¤..." | tee -a $TEST_LOG
    if test_users_recovery; then
        test_results+=("ç”¨æˆ·æ¢å¤: âœ…")
    else
        test_results+=("ç”¨æˆ·æ¢å¤: âŒ")
    fi
    
    # ä¿å­˜æµ‹è¯•ç»“æœ
    printf '%s\n' "${test_results[@]}" > "$TEST_ENV/test_results.txt"
}

# æµ‹è¯•é…ç½®æ–‡ä»¶æ¢å¤
test_config_recovery() {
    local test_backup="/backup/jenkins/test-data/config.xml"
    local test_target="$TEST_ENV/jenkins_home/config.xml"
    
    # æ¨¡æ‹Ÿæ¢å¤é…ç½®æ–‡ä»¶
    if [ -f "$test_backup" ]; then
        cp "$test_backup" "$test_target"
        
        # éªŒè¯æ–‡ä»¶å®Œæ•´æ€§
        if xmllint --noout "$test_target" 2>/dev/null; then
            return 0
        else
            return 1
        fi
    else
        return 1
    fi
}
```

### 9.3 æµ‹è¯•ç»“æœåˆ†æ


**ğŸ“Š æµ‹è¯•æŠ¥å‘Šç”Ÿæˆ**
```bash
# ç”Ÿæˆè¯¦ç»†æµ‹è¯•æŠ¥å‘Š
generate_test_report() {
    local report_file="$TEST_ENV/recovery_test_report.html"
    
    cat > "$report_file" << 'EOF'
<!DOCTYPE html>
<html>
<head>
    <title>Jenkinsæ¢å¤æµ‹è¯•æŠ¥å‘Š</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .success { color: green; }
        .failure { color: red; }
        .warning { color: orange; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>Jenkinsç¾éš¾æ¢å¤æµ‹è¯•æŠ¥å‘Š</h1>
    
    <h2>æµ‹è¯•æ¦‚è§ˆ</h2>
    <table>
        <tr><th>æµ‹è¯•é¡¹ç›®</th><th>ç»“æœ</th><th>å¤‡æ³¨</th></tr>
EOF

    # è¯»å–æµ‹è¯•ç»“æœå¹¶ç”Ÿæˆè¡¨æ ¼
    while IFS= read -r result; do
        if [[ $result == *"âœ…"* ]]; then
            echo "        <tr><td>${result%: *}</td><td class='success'>é€šè¿‡</td><td>-</td></tr>" >> "$report_file"
        else
            echo "        <tr><td>${result%: *}</td><td class='failure'>å¤±è´¥</td><td>éœ€è¦æ£€æŸ¥</td></tr>" >> "$report_file"
        fi
    done < "$TEST_ENV/test_results.txt"
    
    cat >> "$report_file" << 'EOF'
    </table>
    
    <h2>æµ‹è¯•è¯¦æƒ…</h2>
    <p>æµ‹è¯•æ—¶é—´: $(date)</p>
    <p>æµ‹è¯•ç¯å¢ƒ: $TEST_ENV</p>
    <p>è¯¦ç»†æ—¥å¿—: $TEST_LOG</p>
    
</body>
</html>
EOF

    echo "âœ… æµ‹è¯•æŠ¥å‘Šç”Ÿæˆå®Œæˆ: $report_file" | tee -a $TEST_LOG
}
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ ç¾éš¾æ¢å¤æœ¬è´¨ï¼šåœ¨Jenkinså®Œå…¨æ•…éšœæ—¶å¿«é€Ÿæ¢å¤åˆ°å¯ç”¨çŠ¶æ€
ğŸ”¸ æ¢å¤ç­–ç•¥åˆ¶å®šï¼šåŸºäºRTO/RPOç›®æ ‡é€‰æ‹©åˆé€‚çš„æ¢å¤æ–¹æ³•  
ğŸ”¸ æ•°æ®æ¢å¤é¡ºåºï¼šé…ç½®æ–‡ä»¶ â†’ æ’ä»¶ â†’ ä»»åŠ¡ â†’ èŠ‚ç‚¹ â†’ éªŒè¯
ğŸ”¸ å¿«é€Ÿæ¢å¤é‡ç‚¹ï¼šå…ˆæ¢å¤æ ¸å¿ƒåŠŸèƒ½ï¼Œå†è¡¥å……å®Œæ•´åŠŸèƒ½
ğŸ”¸ æµ‹è¯•éªŒè¯é‡è¦æ€§ï¼šå®šæœŸæµ‹è¯•æ¢å¤æµç¨‹ç¡®ä¿æœ‰æ•ˆæ€§
```

### 10.2 æ¢å¤æµç¨‹è¦ç‚¹


**ğŸ”¹ æ¢å¤å‰å‡†å¤‡**
```
ç¯å¢ƒè¯„ä¼°ï¼š
- ç¡®è®¤æ•…éšœèŒƒå›´å’Œå½±å“ç¨‹åº¦
- è¯„ä¼°å¯ç”¨çš„æ¢å¤èµ„æº
- é€šçŸ¥ç›¸å…³äººå‘˜å’Œç”¨æˆ·

å¤‡ä»½éªŒè¯ï¼š
- æ£€æŸ¥å¤‡ä»½æ–‡ä»¶å®Œæ•´æ€§
- ç¡®è®¤å¤‡ä»½æ•°æ®çš„æ—¶æ•ˆæ€§
- å‡†å¤‡æ¢å¤æ‰€éœ€çš„å·¥å…·å’Œæƒé™
```

**ğŸ”¹ æ¢å¤æ‰§è¡Œè¦ç‚¹**
```
åˆ†é˜¶æ®µæ¢å¤ï¼š
1. æ ¸å¿ƒé…ç½®æ¢å¤ï¼ˆconfig.xmlç­‰ï¼‰
2. ç”¨æˆ·å’Œæƒé™æ¢å¤
3. å…³é”®ä»»åŠ¡æ¢å¤
4. æ’ä»¶å’Œå®Œæ•´åŠŸèƒ½æ¢å¤
5. èŠ‚ç‚¹å’Œé›†ç¾¤æ¢å¤

éªŒè¯æœºåˆ¶ï¼š
- æ¯ä¸ªé˜¶æ®µéƒ½è¦éªŒè¯ç»“æœ
- è®°å½•æ¢å¤è¿‡ç¨‹å’Œé—®é¢˜
- ç¡®ä¿åŠŸèƒ½æ­£å¸¸åå†è¿›è¡Œä¸‹ä¸€æ­¥
```

### 10.3 æœ€ä½³å®è·µå»ºè®®


**ğŸ’¡ æ¢å¤ç­–ç•¥å»ºè®®**
- **åˆ¶å®šå¤šå¥—æ–¹æ¡ˆ**ï¼šå¿«é€Ÿæ¢å¤ã€å®Œæ•´æ¢å¤ã€æœ€å°æ¢å¤
- **å®šæœŸæ¼”ç»ƒ**ï¼šè‡³å°‘æ¯å­£åº¦è¿›è¡Œä¸€æ¬¡æ¢å¤æ¼”ç»ƒ
- **æ–‡æ¡£åŒ–æµç¨‹**ï¼šè¯¦ç»†è®°å½•æ¢å¤æ­¥éª¤å’Œæ³¨æ„äº‹é¡¹
- **è‡ªåŠ¨åŒ–è„šæœ¬**ï¼šå‡†å¤‡è‡ªåŠ¨åŒ–æ¢å¤è„šæœ¬å‡å°‘äººå·¥é”™è¯¯

**âš ï¸ æ³¨æ„äº‹é¡¹**
- **æ•°æ®å®‰å…¨**ï¼šæ¢å¤è¿‡ç¨‹ä¸­ä¿æŠ¤æ•æ„Ÿæ•°æ®
- **ç‰ˆæœ¬å…¼å®¹**ï¼šæ³¨æ„Jenkinsç‰ˆæœ¬å’Œæ’ä»¶å…¼å®¹æ€§
- **æƒé™ç®¡ç†**ï¼šæ¢å¤ååŠæ—¶æ£€æŸ¥ç”¨æˆ·æƒé™è®¾ç½®
- **ç›‘æ§å‘Šè­¦**ï¼šæ¢å¤ååŠ å¼ºç›‘æ§ç¡®ä¿ç¨³å®šè¿è¡Œ

**ğŸ¯ æˆåŠŸæŒ‡æ ‡**
- **æ¢å¤æ—¶é—´**ï¼šæ˜¯å¦åœ¨é¢„å®šRTOæ—¶é—´å†…å®Œæˆ
- **æ•°æ®å®Œæ•´æ€§**ï¼šå…³é”®é…ç½®å’Œä»»åŠ¡æ˜¯å¦å®Œå…¨æ¢å¤
- **åŠŸèƒ½æ­£å¸¸**ï¼šæ ¸å¿ƒCI/CDæµç¨‹æ˜¯å¦æ­£å¸¸å·¥ä½œ
- **ç”¨æˆ·æ»¡æ„åº¦**ï¼šå¯¹æ¢å¤ç»“æœçš„æ»¡æ„ç¨‹åº¦

**æ ¸å¿ƒè®°å¿†**ï¼š
- ç¾éš¾æ¢å¤è¦å¿«é€Ÿæœ‰æ•ˆï¼Œé‡ç‚¹å…ˆæ¢å¤æ ¸å¿ƒåŠŸèƒ½
- åˆ†é˜¶æ®µéªŒè¯ç¡®ä¿æ¯æ­¥éƒ½æˆåŠŸå†ç»§ç»­
- å®šæœŸæµ‹è¯•æ¼”ç»ƒï¼Œç¡®ä¿å…³é”®æ—¶åˆ»èƒ½å¤ŸæˆåŠŸ
- è‡ªåŠ¨åŒ–è„šæœ¬å’Œè¯¦ç»†æ–‡æ¡£æ˜¯æˆåŠŸçš„å…³é”®