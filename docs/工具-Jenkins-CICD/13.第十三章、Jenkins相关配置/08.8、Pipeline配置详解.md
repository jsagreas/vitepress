---
title: 8ã€Pipelineé…ç½®è¯¦è§£
---
## ğŸ“š ç›®å½•

1. [PipelineåŸºç¡€æ¦‚å¿µ](#1-PipelineåŸºç¡€æ¦‚å¿µ)
2. [Jenkinsfileé…ç½®è¯­æ³•](#2-Jenkinsfileé…ç½®è¯­æ³•)
3. [å£°æ˜å¼Pipelineè¯¦è§£](#3-å£°æ˜å¼Pipelineè¯¦è§£)
4. [è„šæœ¬å¼Pipelineé…ç½®](#4-è„šæœ¬å¼Pipelineé…ç½®)
5. [Pipelineå…±äº«åº“é…ç½®](#5-Pipelineå…±äº«åº“é…ç½®)
6. [Pipelineè§¦å‘å™¨ä¸agenté…ç½®](#6-Pipelineè§¦å‘å™¨ä¸agenté…ç½®)
7. [Pipelineå¹¶è¡Œæ‰§è¡Œé…ç½®](#7-Pipelineå¹¶è¡Œæ‰§è¡Œé…ç½®)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸš€ PipelineåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Pipeline


**ç®€å•ç†è§£**ï¼šPipelineå°±åƒå·¥å‚çš„æµæ°´çº¿ï¼Œä»£ç ä»å¼€å‘åˆ°éƒ¨ç½²è¦ç»è¿‡å¤šä¸ªæ­¥éª¤ï¼Œæ¯ä¸ªæ­¥éª¤éƒ½æœ‰ç‰¹å®šçš„å·¥ä½œè¦åšã€‚

```
ä¼ ç»Ÿæ–¹å¼ï¼šæ‰‹å·¥æ“ä½œï¼Œå®¹æ˜“å‡ºé”™
å¼€å‘å®Œæˆ â†’ æ‰‹åŠ¨æµ‹è¯• â†’ æ‰‹åŠ¨æ‰“åŒ… â†’ æ‰‹åŠ¨éƒ¨ç½²

Pipelineæ–¹å¼ï¼šè‡ªåŠ¨åŒ–æµæ°´çº¿
å¼€å‘å®Œæˆ â†’ è‡ªåŠ¨æµ‹è¯• â†’ è‡ªåŠ¨æ‰“åŒ… â†’ è‡ªåŠ¨éƒ¨ç½²
```

ğŸ”¸ **Pipelineçš„æœ¬è´¨**
- **ä»£ç åŒ–é…ç½®**ï¼šç”¨ä»£ç æè¿°æ•´ä¸ªCI/CDæµç¨‹ï¼Œä¸å†æ˜¯ç‚¹å‡»ç•Œé¢é…ç½®
- **ç‰ˆæœ¬æ§åˆ¶**ï¼šPipelineé…ç½®å¯ä»¥å’Œä»£ç ä¸€èµ·ç®¡ç†ï¼Œæ”¯æŒç‰ˆæœ¬å›é€€
- **å¯å¤ç”¨æ€§**ï¼šä¸€æ¬¡ç¼–å†™ï¼Œå¤šä¸ªé¡¹ç›®å¯ä»¥å¤ç”¨ç›¸åŒçš„æµç¨‹
- **å¯è§†åŒ–å±•ç¤º**ï¼šJenkinsä¼šæŠŠæ•´ä¸ªæµç¨‹ä»¥å›¾å½¢æ–¹å¼å±•ç¤ºå‡ºæ¥

### 1.2 Pipelineçš„ä»·å€¼


ğŸ’¡ **è§£å†³çš„æ ¸å¿ƒé—®é¢˜**
```
é—®é¢˜1ï¼šé‡å¤æ€§å·¥ä½œ
ä¼ ç»Ÿï¼šæ¯æ¬¡å‘å¸ƒéƒ½è¦æ‰‹åŠ¨æ‰§è¡Œç›¸åŒæ­¥éª¤
Pipelineï¼šä¸€æ¬¡é…ç½®ï¼Œè‡ªåŠ¨é‡å¤æ‰§è¡Œ

é—®é¢˜2ï¼šäººä¸ºé”™è¯¯
ä¼ ç»Ÿï¼šæ‰‹å·¥æ“ä½œå®¹æ˜“é—æ¼æ­¥éª¤æˆ–é…ç½®é”™è¯¯
Pipelineï¼šæ ‡å‡†åŒ–æµç¨‹ï¼Œå‡å°‘äººä¸ºå¤±è¯¯

é—®é¢˜3ï¼šæµç¨‹ä¸é€æ˜
ä¼ ç»Ÿï¼šä¸çŸ¥é“å½“å‰æ‰§è¡Œåˆ°å“ªä¸€æ­¥ï¼Œå‡ºé”™äº†ä¸çŸ¥é“åŸå› 
Pipelineï¼šæ¯ä¸€æ­¥éƒ½æœ‰è¯¦ç»†æ—¥å¿—ï¼Œé—®é¢˜ä¸€ç›®äº†ç„¶
```

### 1.3 Pipelineçš„ä¸¤ç§å†™æ³•


ğŸ”¸ **å£°æ˜å¼Pipelineï¼ˆæ¨èæ–°æ‰‹ä½¿ç”¨ï¼‰**
- ç»“æ„å›ºå®šï¼Œè¯­æ³•ç®€å•
- åƒå¡«ç©ºé¢˜ä¸€æ ·ï¼Œåœ¨å›ºå®šæ ¼å¼ä¸­å¡«å…¥å…·ä½“å†…å®¹
- é”™è¯¯æç¤ºå‹å¥½ï¼Œå®¹æ˜“è°ƒè¯•

ğŸ”¸ **è„šæœ¬å¼Pipelineï¼ˆé«˜çº§ç”¨æˆ·ä½¿ç”¨ï¼‰**
- è‡ªç”±åº¦é«˜ï¼Œå¯ä»¥å†™å¤æ‚é€»è¾‘
- åƒç¼–ç¨‹ä¸€æ ·ï¼Œå¯ä»¥ä½¿ç”¨å„ç§æ§åˆ¶è¯­å¥
- éœ€è¦æ›´å¤šç¼–ç¨‹åŸºç¡€

---

## 2. ğŸ“ Jenkinsfileé…ç½®è¯­æ³•


### 2.1 ä»€ä¹ˆæ˜¯Jenkinsfile


**é€šä¿—è§£é‡Š**ï¼šJenkinsfileå°±æ˜¯å‘Šè¯‰Jenkins"æ€ä¹ˆåšäº‹æƒ…"çš„è¯´æ˜ä¹¦ï¼Œå°±åƒèœè°±å‘Šè¯‰å¨å¸ˆæ€ä¹ˆåšèœä¸€æ ·ã€‚

ğŸ”¸ **Jenkinsfileçš„ç‰¹ç‚¹**
```
æ–‡ä»¶åï¼šå›ºå®šå« Jenkinsfileï¼ˆæ²¡æœ‰æ‰©å±•åï¼‰
ä½ç½®ï¼šæ”¾åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹
è¯­è¨€ï¼šä½¿ç”¨Groovyè¯­æ³•ï¼ˆç±»ä¼¼Javaï¼Œä½†æ›´ç®€å•ï¼‰
ä½œç”¨ï¼šå®šä¹‰æ•´ä¸ªCI/CDæµç¨‹çš„æ¯ä¸€ä¸ªæ­¥éª¤
```

### 2.2 JenkinsfileåŸºæœ¬ç»“æ„


**å£°æ˜å¼PipelineåŸºæœ¬æ¨¡æ¿**ï¼š
```groovy
pipeline {
    agent any  // åœ¨ä»»æ„å¯ç”¨çš„æœºå™¨ä¸Šè¿è¡Œ
    
    stages {   // å®šä¹‰æ‰€æœ‰é˜¶æ®µ
        stage('é˜¶æ®µåç§°') {
            steps {  // å®šä¹‰å…·ä½“æ­¥éª¤
                // å…·ä½“è¦æ‰§è¡Œçš„å‘½ä»¤
            }
        }
    }
}
```

ğŸ”¸ **ç»“æ„è§£æ**
- **pipeline { }**ï¼šæœ€å¤–å±‚å®¹å™¨ï¼Œæ‰€æœ‰å†…å®¹éƒ½è¦å†™åœ¨é‡Œé¢
- **agent**ï¼šæŒ‡å®šåœ¨å“ªå°æœºå™¨ä¸Šè¿è¡Œï¼ˆanyè¡¨ç¤ºä»»æ„æœºå™¨ï¼‰
- **stages { }**ï¼šåŒ…å«æ‰€æœ‰çš„é˜¶æ®µ
- **stage('åç§°') { }**ï¼šä¸€ä¸ªå…·ä½“çš„é˜¶æ®µï¼Œæ¯”å¦‚"ç¼–è¯‘"ã€"æµ‹è¯•"
- **steps { }**ï¼šè¿™ä¸ªé˜¶æ®µè¦æ‰§è¡Œçš„å…·ä½“æ­¥éª¤

### 2.3 ç¬¬ä¸€ä¸ªç®€å•çš„Jenkinsfile


```groovy
pipeline {
    agent any
    
    stages {
        stage('Hello World') {
            steps {
                echo 'Hello, Jenkins Pipeline!'
                echo 'è¿™æ˜¯æˆ‘çš„ç¬¬ä¸€ä¸ªPipeline'
            }
        }
        
        stage('æ˜¾ç¤ºä¿¡æ¯') {
            steps {
                echo "å½“å‰æ—¶é—´: ${new Date()}"
                echo "æ„å»ºç¼–å·: ${BUILD_NUMBER}"
            }
        }
    }
}
```

ğŸ¯ **ä»£ç è¯´æ˜**
- `echo`ï¼šåœ¨æ§åˆ¶å°è¾“å‡ºä¿¡æ¯ï¼Œç±»ä¼¼ç¼–ç¨‹ä¸­çš„print
- `${BUILD_NUMBER}`ï¼šJenkinså†…ç½®å˜é‡ï¼Œè¡¨ç¤ºå½“å‰æ„å»ºç¼–å·
- æ¯ä¸ªstageä¼šåœ¨Jenkinsç•Œé¢ä¸­æ˜¾ç¤ºä¸ºä¸€ä¸ªæ­¥éª¤

---

## 3. ğŸ› ï¸ å£°æ˜å¼Pipelineè¯¦è§£


### 3.1 Pipelineå—ç»“æ„è¯¦è§£


```groovy
pipeline {
    // 1. æŒ‡å®šè¿è¡Œç¯å¢ƒ
    agent {
        label 'linux'  // æŒ‡å®šæ ‡ç­¾ä¸ºlinuxçš„æœºå™¨
    }
    
    // 2. å…¨å±€å·¥å…·é…ç½®
    tools {
        maven 'Maven-3.8'     // ä½¿ç”¨åä¸ºMaven-3.8çš„å·¥å…·
        jdk 'JDK-11'          // ä½¿ç”¨JDK 11
    }
    
    // 3. ç¯å¢ƒå˜é‡
    environment {
        APP_NAME = 'my-app'
        APP_VERSION = '1.0.0'
    }
    
    // 4. å‚æ•°å®šä¹‰
    parameters {
        string(name: 'BRANCH', defaultValue: 'master', description: 'é€‰æ‹©åˆ†æ”¯')
        choice(name: 'ENVIRONMENT', choices: ['dev', 'test', 'prod'], description: 'éƒ¨ç½²ç¯å¢ƒ')
    }
    
    // 5. è§¦å‘æ¡ä»¶
    triggers {
        cron('H 2 * * *')  // æ¯å¤©å‡Œæ™¨2ç‚¹è§¦å‘
    }
    
    // 6. å…·ä½“é˜¶æ®µ
    stages {
        // é˜¶æ®µå®šä¹‰...
    }
}
```

### 3.2 agenté…ç½®è¯¦è§£


**agentå°±æ˜¯"åœ¨å“ªé‡Œå¹²æ´»"çš„æ„æ€**

| é…ç½®æ–¹å¼ | **å«ä¹‰** | **ä½¿ç”¨åœºæ™¯** | **ç¤ºä¾‹** |
|---------|----------|-------------|----------|
| `agent any` | `ä»»æ„å¯ç”¨æœºå™¨` | `ä¸æŒ‘æœºå™¨ï¼Œæœ‰ç©ºé—²å°±è¡Œ` | `å°é¡¹ç›®å¿«é€Ÿå¼€å§‹` |
| `agent none` | `ä¸åˆ†é…æœºå™¨` | `æ¯ä¸ªé˜¶æ®µå•ç‹¬æŒ‡å®š` | `å¤æ‚é¡¹ç›®ç²¾ç¡®æ§åˆ¶` |
| `agent { label 'linux' }` | `æŒ‡å®šæ ‡ç­¾æœºå™¨` | `éœ€è¦ç‰¹å®šç¯å¢ƒ` | `éœ€è¦Linuxç¯å¢ƒç¼–è¯‘` |
| `agent { docker 'maven:3.8' }` | `Dockerå®¹å™¨` | `ç»Ÿä¸€ç¯å¢ƒï¼Œé¿å…å†²çª` | `Javaé¡¹ç›®ç¼–è¯‘` |

### 3.3 environmentç¯å¢ƒå˜é‡


**ç¯å¢ƒå˜é‡å°±æ˜¯ç»™æ•´ä¸ªPipelineè®¾ç½®çš„"å…¨å±€è®¾ç½®"**

```groovy
pipeline {
    agent any
    
    environment {
        // å…¨å±€ç¯å¢ƒå˜é‡ï¼ˆæ‰€æœ‰stageéƒ½èƒ½ç”¨ï¼‰
        APP_NAME = 'my-application'
        BUILD_VERSION = "${BUILD_NUMBER}"
        DOCKER_REGISTRY = 'registry.company.com'
        
        // ä½¿ç”¨credentials()è·å–æ•æ„Ÿä¿¡æ¯
        DOCKER_CREDENTIALS = credentials('docker-hub-credentials')
        DB_PASSWORD = credentials('database-password')
    }
    
    stages {
        stage('æ˜¾ç¤ºç¯å¢ƒå˜é‡') {
            steps {
                echo "åº”ç”¨åç§°: ${APP_NAME}"
                echo "æ„å»ºç‰ˆæœ¬: ${BUILD_VERSION}"
                // æ³¨æ„ï¼šå¯†ç ç±»çš„å˜é‡ä¸ä¼šç›´æ¥æ˜¾ç¤ºå†…å®¹
            }
        }
        
        stage('å•ç‹¬è®¾ç½®ç¯å¢ƒå˜é‡') {
            environment {
                // åªåœ¨è¿™ä¸ªstageä¸­æœ‰æ•ˆçš„ç¯å¢ƒå˜é‡
                STAGE_SPECIFIC = 'only-for-this-stage'
            }
            steps {
                echo "é˜¶æ®µä¸“ç”¨å˜é‡: ${STAGE_SPECIFIC}"
            }
        }
    }
}
```

### 3.4 parameterså‚æ•°é…ç½®


**å‚æ•°å°±æ˜¯è®©ç”¨æˆ·åœ¨è¿è¡Œæ—¶å¯ä»¥"è‡ªå®šä¹‰é€‰æ‹©"çš„è®¾ç½®**

```groovy
pipeline {
    agent any
    
    parameters {
        // æ–‡æœ¬è¾“å…¥æ¡†
        string(
            name: 'TARGET_BRANCH',
            defaultValue: 'master',
            description: 'è¯·è¾“å…¥è¦æ„å»ºçš„åˆ†æ”¯å'
        )
        
        // ä¸‹æ‹‰é€‰æ‹©æ¡†
        choice(
            name: 'DEPLOY_ENV',
            choices: ['dev', 'staging', 'production'],
            description: 'é€‰æ‹©éƒ¨ç½²ç¯å¢ƒ'
        )
        
        // å¤šè¡Œæ–‡æœ¬
        text(
            name: 'RELEASE_NOTES',
            defaultValue: '',
            description: 'è¯·è¾“å…¥ç‰ˆæœ¬è¯´æ˜'
        )
        
        // å¸ƒå°”é€‰æ‹©
        booleanParam(
            name: 'SKIP_TESTS',
            defaultValue: false,
            description: 'æ˜¯å¦è·³è¿‡æµ‹è¯•'
        )
    }
    
    stages {
        stage('ä½¿ç”¨å‚æ•°') {
            steps {
                echo "æ„å»ºåˆ†æ”¯: ${params.TARGET_BRANCH}"
                echo "éƒ¨ç½²ç¯å¢ƒ: ${params.DEPLOY_ENV}"
                echo "è·³è¿‡æµ‹è¯•: ${params.SKIP_TESTS}"
            }
        }
    }
}
```

ğŸ¯ **å‚æ•°ä½¿ç”¨è¯´æ˜**
- å‚æ•°é€šè¿‡`${params.å‚æ•°å}`çš„æ–¹å¼ä½¿ç”¨
- ç¬¬ä¸€æ¬¡è¿è¡Œæ—¶ä½¿ç”¨é»˜è®¤å€¼
- ä¹‹åæ¯æ¬¡è¿è¡Œéƒ½ä¼šæ˜¾ç¤ºå‚æ•°é€‰æ‹©ç•Œé¢

---

## 4. âš™ï¸ è„šæœ¬å¼Pipelineé…ç½®


### 4.1 è„šæœ¬å¼vså£°æ˜å¼å¯¹æ¯”


```
å£°æ˜å¼Pipelineï¼ˆåƒå¡«è¡¨æ ¼ï¼‰ï¼š
- æœ‰å›ºå®šæ ¼å¼ï¼Œå¡«ç©ºå³å¯
- è¯­æ³•é”™è¯¯æ£€æŸ¥ä¸¥æ ¼
- é€‚åˆæ ‡å‡†åŒ–æµç¨‹
- æ–°æ‰‹å‹å¥½

è„šæœ¬å¼Pipelineï¼ˆåƒå†™ç¨‹åºï¼‰ï¼š
- è‡ªç”±ç¼–å†™é€»è¾‘
- å¯ä»¥ä½¿ç”¨å¤æ‚æ§åˆ¶è¯­å¥
- é€‚åˆå¤æ‚å®šåˆ¶éœ€æ±‚
- éœ€è¦ç¼–ç¨‹åŸºç¡€
```

### 4.2 è„šæœ¬å¼PipelineåŸºæœ¬è¯­æ³•


```groovy
node('linux') {  // æŒ‡å®šåœ¨linuxèŠ‚ç‚¹è¿è¡Œ
    
    // ç¬¬ä¸€é˜¶æ®µï¼šæ£€å‡ºä»£ç 
    stage('Checkout') {
        echo 'æ­£åœ¨æ£€å‡ºä»£ç ...'
        checkout scm
    }
    
    // ç¬¬äºŒé˜¶æ®µï¼šç¼–è¯‘
    stage('Build') {
        echo 'æ­£åœ¨ç¼–è¯‘é¡¹ç›®...'
        sh 'mvn clean compile'
    }
    
    // ç¬¬ä¸‰é˜¶æ®µï¼šæµ‹è¯•
    stage('Test') {
        try {
            echo 'æ­£åœ¨è¿è¡Œæµ‹è¯•...'
            sh 'mvn test'
        } catch (Exception e) {
            echo "æµ‹è¯•å¤±è´¥: ${e.getMessage()}"
            // å¯ä»¥é€‰æ‹©ç»§ç»­æˆ–è€…ç»ˆæ­¢
            throw e
        }
    }
}
```

### 4.3 è„šæœ¬å¼Pipelineé«˜çº§ç”¨æ³•


```groovy
node {
    // ä½¿ç”¨å˜é‡
    def buildVersion = env.BUILD_NUMBER
    def gitCommit = ''
    
    stage('å‡†å¤‡é˜¶æ®µ') {
        // è·å–Gitæäº¤ä¿¡æ¯
        gitCommit = sh(
            script: 'git rev-parse HEAD',
            returnStdout: true
        ).trim()
        
        echo "æ„å»ºç‰ˆæœ¬: ${buildVersion}"
        echo "Gitæäº¤: ${gitCommit}"
    }
    
    stage('æ¡ä»¶æ‰§è¡Œ') {
        // æ ¹æ®åˆ†æ”¯åå†³å®šæ˜¯å¦éƒ¨ç½²
        if (env.BRANCH_NAME == 'master') {
            echo 'ä¸»åˆ†æ”¯ï¼Œå‡†å¤‡éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ'
            // éƒ¨ç½²é€»è¾‘
        } else {
            echo 'éä¸»åˆ†æ”¯ï¼Œè·³è¿‡éƒ¨ç½²'
        }
    }
    
    stage('å¹¶è¡Œæ‰§è¡Œ') {
        parallel(
            'å•å…ƒæµ‹è¯•': {
                sh 'mvn test'
            },
            'é™æ€ä»£ç æ£€æŸ¥': {
                sh 'mvn checkstyle:check'
            },
            'å®‰å…¨æ‰«æ': {
                sh 'mvn dependency-check:check'
            }
        )
    }
}
```

---

## 5. ğŸ“š Pipelineå…±äº«åº“é…ç½®


### 5.1 ä»€ä¹ˆæ˜¯å…±äº«åº“


**é€šä¿—ç†è§£**ï¼šå…±äº«åº“å°±åƒ"å…¬å…±å·¥å…·ç®±"ï¼ŒæŠŠå¸¸ç”¨çš„åŠŸèƒ½å†™æˆå¯é‡ç”¨çš„ç»„ä»¶ï¼Œå¤šä¸ªé¡¹ç›®éƒ½èƒ½ä½¿ç”¨ã€‚

ğŸ”¸ **å…±äº«åº“çš„ä»·å€¼**
```
é—®é¢˜ï¼šæ¯ä¸ªé¡¹ç›®éƒ½è¦å†™ç›¸ä¼¼çš„Pipelineä»£ç 
- é¡¹ç›®Aéœ€è¦ï¼šæ£€å‡ºä»£ç â†’ç¼–è¯‘â†’æµ‹è¯•â†’éƒ¨ç½²
- é¡¹ç›®Béœ€è¦ï¼šæ£€å‡ºä»£ç â†’ç¼–è¯‘â†’æµ‹è¯•â†’éƒ¨ç½²
- é¡¹ç›®Céœ€è¦ï¼šæ£€å‡ºä»£ç â†’ç¼–è¯‘â†’æµ‹è¯•â†’éƒ¨ç½²
ä»£ç é‡å¤ï¼Œç»´æŠ¤å›°éš¾

è§£å†³ï¼šæŠŠé€šç”¨é€»è¾‘æå–åˆ°å…±äº«åº“
- å…±äº«åº“æä¾›ï¼šbuildJavaApp()ã€deployToK8s()ç­‰é€šç”¨å‡½æ•°
- å„é¡¹ç›®è°ƒç”¨ï¼šbuildJavaApp('my-app')
ä»£ç å¤ç”¨ï¼Œç»Ÿä¸€ç»´æŠ¤
```

### 5.2 Global Libraryé…ç½®


**åœ¨Jenkinså…¨å±€é…ç½®ä¸­è®¾ç½®**

ğŸ”§ **é…ç½®æ­¥éª¤**
```
1. è¿›å…¥ Manage Jenkins â†’ Configure System
2. æ‰¾åˆ° Global Pipeline Libraries
3. æ·»åŠ åº“é…ç½®ï¼š
   - Name: my-shared-libraryï¼ˆåº“çš„åç§°ï¼‰
   - Default version: masterï¼ˆé»˜è®¤åˆ†æ”¯ï¼‰
   - Retrieval method: Modern SCM
   - Source Code Management: Git
   - Repository URL: git@github.com:company/jenkins-shared-library.git
```

**å…±äº«åº“ç›®å½•ç»“æ„**
```
jenkins-shared-library/
â”œâ”€â”€ vars/                    # å…¨å±€å˜é‡å’Œå‡½æ•°
â”‚   â”œâ”€â”€ buildJavaApp.groovy  # Javaåº”ç”¨æ„å»ºå‡½æ•°
â”‚   â”œâ”€â”€ deployToK8s.groovy   # K8séƒ¨ç½²å‡½æ•°
â”‚   â””â”€â”€ sendNotification.groovy  # é€šçŸ¥å‡½æ•°
â”œâ”€â”€ src/                     # å¤æ‚çš„ç±»åº“
â”‚   â””â”€â”€ com/company/jenkins/
â”‚       â””â”€â”€ Utils.groovy
â””â”€â”€ resources/               # èµ„æºæ–‡ä»¶
    â”œâ”€â”€ scripts/
    â””â”€â”€ templates/
```

### 5.3 ä½¿ç”¨å…±äº«åº“


```groovy
// å¼•ç”¨å…±äº«åº“
@Library('my-shared-library') _

pipeline {
    agent any
    
    stages {
        stage('æ„å»ºJavaåº”ç”¨') {
            steps {
                // è°ƒç”¨å…±äº«åº“ä¸­çš„å‡½æ•°
                buildJavaApp(
                    appName: 'my-service',
                    jdkVersion: '11',
                    mavenGoals: 'clean package'
                )
            }
        }
        
        stage('éƒ¨ç½²åˆ°K8s') {
            steps {
                deployToK8s(
                    appName: 'my-service',
                    namespace: 'production',
                    replicas: 3
                )
            }
        }
        
        stage('å‘é€é€šçŸ¥') {
            steps {
                sendNotification(
                    channel: '#deployment',
                    message: 'åº”ç”¨éƒ¨ç½²æˆåŠŸ'
                )
            }
        }
    }
}
```

### 5.4 ç¼–å†™å…±äº«åº“å‡½æ•°


**vars/buildJavaApp.groovyç¤ºä¾‹**
```groovy
def call(Map config) {
    // è®¾ç½®é»˜è®¤å€¼
    def appName = config.appName ?: 'unknown-app'
    def jdkVersion = config.jdkVersion ?: '8'
    def mavenGoals = config.mavenGoals ?: 'clean package'
    
    echo "å¼€å§‹æ„å»ºJavaåº”ç”¨: ${appName}"
    
    // è®¾ç½®JDKç¯å¢ƒ
    tool name: "JDK-${jdkVersion}", type: 'jdk'
    
    // æ‰§è¡ŒMavenæ„å»º
    sh """
        echo 'é…ç½®Mavenç¯å¢ƒ...'
        mvn --version
        
        echo 'å¼€å§‹æ„å»º...'
        mvn ${mavenGoals}
        
        echo 'æ„å»ºå®Œæˆ'
    """
    
    // ä¿å­˜æ„å»ºäº§ç‰©
    archiveArtifacts artifacts: 'target/*.jar', allowEmptyArchive: false
    
    echo "Javaåº”ç”¨ ${appName} æ„å»ºæˆåŠŸ"
}
```

---

## 6. ğŸ¯ Pipelineè§¦å‘å™¨ä¸agenté…ç½®


### 6.1 Pipelineè§¦å‘å™¨è¯¦è§£


**è§¦å‘å™¨å°±æ˜¯"ä»€ä¹ˆæ—¶å€™è‡ªåŠ¨è¿è¡ŒPipeline"çš„è§„åˆ™**

### 6.1.1 æ—¶é—´è§¦å‘å™¨ï¼ˆcronï¼‰


```groovy
pipeline {
    agent any
    
    triggers {
        // æ¯å¤©å‡Œæ™¨2ç‚¹30åˆ†æ‰§è¡Œ
        cron('30 2 * * *')
        
        // æ¯å‘¨ä¸€åˆ°å‘¨äº”çš„ä¸Šåˆ9ç‚¹æ‰§è¡Œ
        cron('0 9 * * 1-5')
        
        // æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡
        cron('H * * * *')  // Hè¡¨ç¤ºJenkinsåˆ†æ•£æ‰§è¡Œï¼Œé¿å…åŒæ—¶æ‰§è¡Œ
    }
    
    stages {
        stage('å®šæ—¶ä»»åŠ¡') {
            steps {
                echo 'è¿™æ˜¯å®šæ—¶æ‰§è¡Œçš„ä»»åŠ¡'
            }
        }
    }
}
```

ğŸ”¸ **cronè¡¨è¾¾å¼è¯´æ˜**
```
æ ¼å¼ï¼šåˆ† æ—¶ æ—¥ æœˆ å‘¨
ç¤ºä¾‹ï¼š
'0 8 * * *'     # æ¯å¤©8ç‚¹
'0 8 * * 1'     # æ¯å‘¨ä¸€8ç‚¹
'0 8 1 * *'     # æ¯æœˆ1å·8ç‚¹
'H/15 * * * *'  # æ¯15åˆ†é’Ÿä¸€æ¬¡ï¼ˆHè¡¨ç¤ºéšæœºåˆ†æ•£ï¼‰
```

### 6.1.2 ä»£ç å˜æ›´è§¦å‘å™¨


```groovy
pipeline {
    agent any
    
    triggers {
        // æ£€æŸ¥ä»£ç å˜æ›´ï¼Œæœ‰å˜æ›´å°±è§¦å‘æ„å»º
        pollSCM('H/5 * * * *')  // æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ä»£ç å˜æ›´
        
        // ä¸Šæ¸¸ä»»åŠ¡å®Œæˆåè§¦å‘
        upstream(upstreamProjects: 'upstream-job', threshold: hudson.model.Result.SUCCESS)
    }
    
    stages {
        stage('ä»£ç å˜æ›´æ„å»º') {
            steps {
                echo 'æ£€æµ‹åˆ°ä»£ç å˜æ›´ï¼Œå¼€å§‹æ„å»º'
            }
        }
    }
}
```

### 6.2 agenté…ç½®è¯¦è§£


### 6.2.1 Docker agenté…ç½®


```groovy
pipeline {
    agent {
        docker {
            image 'maven:3.8-openjdk-11'  // ä½¿ç”¨Dockeré•œåƒ
            args '-v /root/.m2:/root/.m2'  // æŒ‚è½½Mavenæœ¬åœ°ä»“åº“
        }
    }
    
    stages {
        stage('åœ¨Dockerä¸­æ„å»º') {
            steps {
                sh 'mvn --version'
                sh 'java --version'
                sh 'mvn clean package'
            }
        }
    }
}
```

### 6.2.2 ä¸åŒé˜¶æ®µä½¿ç”¨ä¸åŒagent


```groovy
pipeline {
    agent none  // ä¸æŒ‡å®šå…¨å±€agent
    
    stages {
        stage('Linuxç¯å¢ƒç¼–è¯‘') {
            agent {
                label 'linux'
            }
            steps {
                echo 'åœ¨Linuxæœºå™¨ä¸Šç¼–è¯‘'
                sh 'make build'
            }
        }
        
        stage('Windowsç¯å¢ƒæµ‹è¯•') {
            agent {
                label 'windows'
            }
            steps {
                echo 'åœ¨Windowsæœºå™¨ä¸Šæµ‹è¯•'
                bat 'run-tests.bat'
            }
        }
        
        stage('Dockerç¯å¢ƒéƒ¨ç½²') {
            agent {
                docker 'nginx:alpine'
            }
            steps {
                echo 'åœ¨Dockerå®¹å™¨ä¸­éƒ¨ç½²'
                sh 'nginx -t'
            }
        }
    }
}
```

### 6.3 agenté«˜çº§é…ç½®é€‰é¡¹


```groovy
pipeline {
    agent {
        docker {
            image 'node:16-alpine'
            label 'docker-host'              // æŒ‡å®šè¿è¡ŒDockerçš„æœºå™¨
            args '-v /tmp:/tmp'             // Dockerè¿è¡Œå‚æ•°
            alwaysPull true                 // æ€»æ˜¯æ‹‰å–æœ€æ–°é•œåƒ
            reuseNode false                 // ä¸é‡ç”¨workspace
        }
    }
    
    stages {
        stage('Node.jsåº”ç”¨æ„å»º') {
            steps {
                sh '''
                    node --version
                    npm --version
                    npm install
                    npm run build
                '''
            }
        }
    }
}
```

---

## 7. ğŸ”„ Pipelineå¹¶è¡Œæ‰§è¡Œé…ç½®


### 7.1 ä»€ä¹ˆæ˜¯å¹¶è¡Œæ‰§è¡Œ


**é€šä¿—ç†è§£**ï¼šå¹¶è¡Œæ‰§è¡Œå°±åƒ"åŒæ—¶åšå¤šä»¶äº‹æƒ…"ï¼Œæ¯”å¦‚ä¸€è¾¹ç…®é¥­ä¸€è¾¹ç‚’èœï¼Œæé«˜æ•ˆç‡ã€‚

```
ä¸²è¡Œæ‰§è¡Œï¼ˆä¸€ä¸ªæ¥ä¸€ä¸ªï¼‰ï¼š
æµ‹è¯•é˜¶æ®µ â†’ ä»£ç æ£€æŸ¥ â†’ å®‰å…¨æ‰«æ
æ€»æ—¶é—´ï¼š5åˆ†é’Ÿ + 3åˆ†é’Ÿ + 4åˆ†é’Ÿ = 12åˆ†é’Ÿ

å¹¶è¡Œæ‰§è¡Œï¼ˆåŒæ—¶è¿›è¡Œï¼‰ï¼š
æµ‹è¯•é˜¶æ®µ    â”
ä»£ç æ£€æŸ¥    â”œâ”€ åŒæ—¶æ‰§è¡Œ
å®‰å…¨æ‰«æ    â”˜
æ€»æ—¶é—´ï¼šmax(5åˆ†é’Ÿ, 3åˆ†é’Ÿ, 4åˆ†é’Ÿ) = 5åˆ†é’Ÿ
```

### 7.2 å£°æ˜å¼Pipelineå¹¶è¡Œé…ç½®


```groovy
pipeline {
    agent any
    
    stages {
        stage('å¹¶è¡Œè´¨é‡æ£€æŸ¥') {
            parallel {
                stage('å•å…ƒæµ‹è¯•') {
                    steps {
                        echo 'æ­£åœ¨è¿è¡Œå•å…ƒæµ‹è¯•...'
                        sh 'mvn test'
                        publishTestResults testResultsPattern: 'target/surefire-reports/*.xml'
                    }
                }
                
                stage('ä»£ç è´¨é‡æ£€æŸ¥') {
                    steps {
                        echo 'æ­£åœ¨è¿›è¡Œä»£ç è´¨é‡æ£€æŸ¥...'
                        sh 'mvn sonar:sonar'
                    }
                }
                
                stage('å®‰å…¨æ¼æ´æ‰«æ') {
                    steps {
                        echo 'æ­£åœ¨è¿›è¡Œå®‰å…¨æ‰«æ...'
                        sh 'mvn dependency-check:check'
                    }
                }
                
                stage('Dockeré•œåƒæ‰«æ') {
                    steps {
                        echo 'æ­£åœ¨æ‰«æDockeré•œåƒ...'
                        sh 'docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image my-app:latest'
                    }
                }
            }
        }
        
        stage('å¹¶è¡Œéƒ¨ç½²') {
            parallel {
                stage('éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ') {
                    steps {
                        echo 'éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ...'
                        sh 'kubectl apply -f k8s/test/ --namespace=test'
                    }
                }
                
                stage('éƒ¨ç½²åˆ°é¢„ç”Ÿäº§ç¯å¢ƒ') {
                    steps {
                        echo 'éƒ¨ç½²åˆ°é¢„ç”Ÿäº§ç¯å¢ƒ...'
                        sh 'kubectl apply -f k8s/staging/ --namespace=staging'
                    }
                }
            }
        }
    }
}
```

### 7.3 å¹¶è¡Œæ‰§è¡Œé«˜çº§é…ç½®


```groovy
pipeline {
    agent any
    
    stages {
        stage('å¤šç¯å¢ƒå¹¶è¡Œæµ‹è¯•') {
            parallel {
                stage('Chromeæµè§ˆå™¨æµ‹è¯•') {
                    agent {
                        docker 'selenium/standalone-chrome'
                    }
                    steps {
                        sh 'npm run test:chrome'
                    }
                }
                
                stage('Firefoxæµè§ˆå™¨æµ‹è¯•') {
                    agent {
                        docker 'selenium/standalone-firefox'
                    }
                    steps {
                        sh 'npm run test:firefox'
                    }
                }
                
                stage('ç§»åŠ¨ç«¯æµ‹è¯•') {
                    steps {
                        sh 'npm run test:mobile'
                    }
                }
            }
        }
        
        stage('å¤šå¹³å°å¹¶è¡Œæ„å»º') {
            parallel {
                stage('Linuxæ„å»º') {
                    agent {
                        label 'linux'
                    }
                    steps {
                        sh 'make build-linux'
                        archiveArtifacts 'dist/linux/*'
                    }
                }
                
                stage('Windowsæ„å»º') {
                    agent {
                        label 'windows'
                    }
                    steps {
                        bat 'make build-windows'
                        archiveArtifacts 'dist/windows/*'
                    }
                }
                
                stage('macOSæ„å»º') {
                    agent {
                        label 'macos'
                    }
                    steps {
                        sh 'make build-macos'
                        archiveArtifacts 'dist/macos/*'
                    }
                }
            }
        }
    }
}
```

### 7.4 å¹¶è¡Œæ‰§è¡Œæ³¨æ„äº‹é¡¹


âš ï¸ **é‡è¦æé†’**
```
èµ„æºå†²çªé—®é¢˜ï¼š
- å¤šä¸ªå¹¶è¡Œä»»åŠ¡å¯èƒ½è®¿é—®ç›¸åŒæ–‡ä»¶
- æ•°æ®åº“è¿æ¥æ•°é™åˆ¶
- ç½‘ç»œå¸¦å®½å ç”¨

è§£å†³æ–¹æ¡ˆï¼š
- ä½¿ç”¨ä¸åŒçš„å·¥ä½œç›®å½•
- é…ç½®ç‹¬ç«‹çš„æ•°æ®åº“
- æ§åˆ¶å¹¶è¡Œä»»åŠ¡æ•°é‡
```

**æ§åˆ¶å¹¶è¡Œåº¦é…ç½®**
```groovy
pipeline {
    agent any
    
    options {
        parallelsAlwaysFailFast()  // ä»»ä½•ä¸€ä¸ªå¹¶è¡Œä»»åŠ¡å¤±è´¥å°±åœæ­¢æ‰€æœ‰ä»»åŠ¡
    }
    
    stages {
        stage('å—æ§å¹¶è¡Œæ‰§è¡Œ') {
            parallel {
                stage('ä»»åŠ¡1') {
                    steps {
                        echo 'ä»»åŠ¡1æ‰§è¡Œä¸­'
                        sh 'sleep 30'
                    }
                }
                stage('ä»»åŠ¡2') {
                    steps {
                        echo 'ä»»åŠ¡2æ‰§è¡Œä¸­'
                        sh 'sleep 20'
                    }
                }
            }
        }
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


ğŸ”¸ **Pipelineæ ¸å¿ƒç†è§£**
```
Pipeline = è‡ªåŠ¨åŒ–æµæ°´çº¿
- ç”¨ä»£ç æè¿°CI/CDæµç¨‹
- ç‰ˆæœ¬åŒ–ç®¡ç†é…ç½®
- å¯è§†åŒ–å±•ç¤ºæ‰§è¡Œè¿‡ç¨‹
- æé«˜å¼€å‘æ•ˆç‡å’Œè´¨é‡
```

ğŸ”¸ **ä¸¤ç§Pipelineå†™æ³•**
```
å£°æ˜å¼Pipelineï¼š
âœ… ç»“æ„å›ºå®šï¼Œè¯­æ³•ç®€å•
âœ… é€‚åˆæ–°æ‰‹å’Œæ ‡å‡†æµç¨‹
âœ… é”™è¯¯æç¤ºå‹å¥½

è„šæœ¬å¼Pipelineï¼š
âœ… è‡ªç”±åº¦é«˜ï¼Œé€»è¾‘å¤æ‚
âœ… é€‚åˆé«˜çº§ç”¨æˆ·
âœ… éœ€è¦ç¼–ç¨‹åŸºç¡€
```

### 8.2 å…³é”®é…ç½®è¦ç‚¹


ğŸ”¹ **Jenkinsfileé…ç½®åŸåˆ™**
```
æ–‡ä»¶ä½ç½®ï¼šé¡¹ç›®æ ¹ç›®å½•
æ–‡ä»¶åç§°ï¼šJenkinsfileï¼ˆæ— æ‰©å±•åï¼‰
è¯­æ³•åŸºç¡€ï¼šGroovyè¯­æ³•
ç‰ˆæœ¬ç®¡ç†ï¼šä¸ä»£ç ä¸€èµ·ç®¡ç†
```

ğŸ”¹ **agenté€‰æ‹©ç­–ç•¥**
```
agent anyï¼šå¿«é€Ÿå¼€å§‹ï¼Œä¸æŒ‘æœºå™¨
agent { label 'xxx' }ï¼šæŒ‡å®šç¯å¢ƒ
agent { docker 'image' }ï¼šç»Ÿä¸€ç¯å¢ƒ
agent noneï¼šç²¾ç¡®æ§åˆ¶æ¯ä¸ªé˜¶æ®µ
```

ğŸ”¹ **å¹¶è¡Œæ‰§è¡Œä½¿ç”¨åœºæ™¯**
```
é€‚åˆå¹¶è¡Œï¼š
- ä¸åŒç±»å‹çš„æµ‹è¯•ï¼ˆå•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ï¼‰
- ä¸åŒå¹³å°çš„æ„å»ºï¼ˆLinuxã€Windowsã€macOSï¼‰
- ä¸åŒç¯å¢ƒçš„éƒ¨ç½²ï¼ˆæµ‹è¯•ã€é¢„ç”Ÿäº§ï¼‰

ä¸é€‚åˆå¹¶è¡Œï¼š
- æœ‰ä¾èµ–å…³ç³»çš„æ­¥éª¤
- èµ„æºå†²çªçš„æ“ä½œ
- é¡ºåºæ•æ„Ÿçš„ä»»åŠ¡
```

### 8.3 æœ€ä½³å®è·µå»ºè®®


ğŸ’¡ **Pipelineè®¾è®¡åŸåˆ™**
```
1. é˜¶æ®µå‘½åæ¸…æ™°ï¼šç”¨æœ‰æ„ä¹‰çš„åç§°
2. å¤±è´¥å¿«é€Ÿåé¦ˆï¼šæµ‹è¯•æ”¾åœ¨å‰é¢
3. å¹¶è¡Œæé«˜æ•ˆç‡ï¼šåˆç†ä½¿ç”¨å¹¶è¡Œæ‰§è¡Œ
4. å‚æ•°åŒ–é…ç½®ï¼šé€šè¿‡å‚æ•°æ§åˆ¶è¡Œä¸º
5. é”™è¯¯å¤„ç†ï¼šæ·»åŠ try-catchå’Œé€šçŸ¥
```

ğŸ¯ **æ–°æ‰‹å­¦ä¹ è·¯å¾„**
```
ç¬¬1æ­¥ï¼šç†è§£PipelineåŸºæœ¬æ¦‚å¿µ
ç¬¬2æ­¥ï¼šç¼–å†™ç®€å•çš„å£°æ˜å¼Pipeline
ç¬¬3æ­¥ï¼šå­¦ä¹ ä½¿ç”¨å‚æ•°å’Œç¯å¢ƒå˜é‡
ç¬¬4æ­¥ï¼šæŒæ¡agentå’Œè§¦å‘å™¨é…ç½®
ç¬¬5æ­¥ï¼šå°è¯•å¹¶è¡Œæ‰§è¡Œä¼˜åŒ–æ•ˆç‡
ç¬¬6æ­¥ï¼šä½¿ç”¨å…±äº«åº“å¤ç”¨ä»£ç 
```

âš ï¸ **å¸¸è§é™·é˜±æé†’**
```
è¯­æ³•é”™è¯¯ï¼šæ³¨æ„Groovyè¯­æ³•è§„èŒƒ
èµ„æºå†²çªï¼šå¹¶è¡Œä»»åŠ¡é¿å…å†²çª
æƒé™é—®é¢˜ï¼šç¡®ä¿Jenkinsæœ‰å¿…è¦æƒé™
ç½‘ç»œé—®é¢˜ï¼šæ³¨æ„é˜²ç«å¢™å’Œä»£ç†è®¾ç½®
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- Pipelineæ˜¯ç”¨ä»£ç æè¿°çš„è‡ªåŠ¨åŒ–æµæ°´çº¿
- å£°æ˜å¼è¯­æ³•é€‚åˆæ–°æ‰‹ï¼Œç»“æ„æ¸…æ™°æ˜“æ‡‚
- agentå†³å®šåœ¨å“ªé‡Œæ‰§è¡Œï¼Œparallelæé«˜æ•ˆç‡
- Jenkinsfileä¸ä»£ç ä¸€èµ·ç®¡ç†ï¼Œå®ç°DevOps