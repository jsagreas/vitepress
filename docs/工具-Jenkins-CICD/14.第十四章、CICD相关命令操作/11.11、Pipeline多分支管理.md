---
title: 11ã€Pipelineå¤šåˆ†æ”¯ç®¡ç†
---
## ğŸ“š ç›®å½•

1. [å¤šåˆ†æ”¯PipelineåŸºç¡€æ¦‚å¿µ](#1-å¤šåˆ†æ”¯PipelineåŸºç¡€æ¦‚å¿µ)
2. [å¤šåˆ†æ”¯Pipelineåˆ›å»ºä¸é…ç½®](#2-å¤šåˆ†æ”¯Pipelineåˆ›å»ºä¸é…ç½®)
3. [åˆ†æ”¯å‘ç°ç­–ç•¥é…ç½®](#3-åˆ†æ”¯å‘ç°ç­–ç•¥é…ç½®)
4. [Jenkinsfileè·¯å¾„ç®¡ç†](#4-Jenkinsfileè·¯å¾„ç®¡ç†)
5. [åˆ†æ”¯æ„å»ºç­–ç•¥è®¾ç½®](#5-åˆ†æ”¯æ„å»ºç­–ç•¥è®¾ç½®)
6. [PR/MRæ„å»ºé…ç½®](#6-PRMRæ„å»ºé…ç½®)
7. [åˆ†æ”¯ä¿æŠ¤ä¸åˆå¹¶ç­–ç•¥](#7-åˆ†æ”¯ä¿æŠ¤ä¸åˆå¹¶ç­–ç•¥)
8. [è‡ªåŠ¨åˆ†æ”¯æ¸…ç†æœºåˆ¶](#8-è‡ªåŠ¨åˆ†æ”¯æ¸…ç†æœºåˆ¶)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒŸ å¤šåˆ†æ”¯PipelineåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯å¤šåˆ†æ”¯Pipeline

ğŸ¯ **ç”Ÿæ´»åŒ–ç†è§£**ï¼šå¤šåˆ†æ”¯Pipelineå°±åƒä¸€ä¸ªæ™ºèƒ½å·¥å‚çš„å¤šæ¡ç”Ÿäº§çº¿

```
æƒ³è±¡ä¸€ä¸ªæ‰‹æœºåˆ¶é€ å·¥å‚ï¼š
ä¸»ç”Ÿäº§çº¿ï¼ˆmasteråˆ†æ”¯ï¼‰ï¼šç”Ÿäº§æ­£å¼ç‰ˆæ‰‹æœºï¼Œè´¨é‡è¦æ±‚æœ€é«˜
æµ‹è¯•ç”Ÿäº§çº¿ï¼ˆdevelopåˆ†æ”¯ï¼‰ï¼šç”Ÿäº§æµ‹è¯•ç‰ˆï¼Œç”¨äºå†…éƒ¨éªŒè¯
å®éªŒç”Ÿäº§çº¿ï¼ˆfeatureåˆ†æ”¯ï¼‰ï¼šè¯•éªŒæ–°åŠŸèƒ½ï¼Œå¯èƒ½æœ‰å¤šæ¡åŒæ—¶è¿è¡Œ

Jenkinså¤šåˆ†æ”¯Pipelineï¼š
æ¯ä¸ªä»£ç åˆ†æ”¯ = ä¸€æ¡ç‹¬ç«‹çš„ç”Ÿäº§çº¿
æ¯æ¡ç”Ÿäº§çº¿éƒ½æœ‰è‡ªå·±çš„æ„å»ºæµç¨‹
æ ¹æ®åˆ†æ”¯ä¸åŒï¼Œæ‰§è¡Œä¸åŒçš„æ„å»ºç­–ç•¥
```

**ğŸ”¸ å¤šåˆ†æ”¯Pipelineçš„æ ¸å¿ƒä»·å€¼**
```
è‡ªåŠ¨åŒ–ç®¡ç†ï¼š
- Gitä»“åº“ä¸­æ¯ä¸ªåˆ†æ”¯è‡ªåŠ¨åˆ›å»ºå¯¹åº”çš„Pipeline
- æ–°åˆ†æ”¯æ¨é€æ—¶è‡ªåŠ¨å¼€å§‹æ„å»º
- åˆ†æ”¯åˆ é™¤æ—¶è‡ªåŠ¨æ¸…ç†å¯¹åº”Pipeline

å¹¶è¡Œå¼€å‘æ”¯æŒï¼š
- ä¸åŒå¼€å‘å›¢é˜Ÿå¯ä»¥åœ¨ä¸åŒåˆ†æ”¯å¹¶è¡Œå·¥ä½œ
- æ¯ä¸ªåŠŸèƒ½åˆ†æ”¯éƒ½æœ‰ç‹¬ç«‹çš„æ„å»ºéªŒè¯
- é¿å…ä¸åŒåˆ†æ”¯ä¹‹é—´çš„ç›¸äº’å¹²æ‰°

è´¨é‡ä¿è¯ï¼š
- æ¯ä¸ªåˆ†æ”¯çš„ä»£ç éƒ½ç»è¿‡è‡ªåŠ¨åŒ–æµ‹è¯•
- åˆå¹¶å‰å¿…é¡»é€šè¿‡PipelineéªŒè¯
- ä¿è¯ä¸»åˆ†æ”¯ä»£ç è´¨é‡
```

### 1.2 ä¼ ç»ŸPipeline vs å¤šåˆ†æ”¯Pipeline

**ğŸ“Š å¯¹æ¯”åˆ†æå¸®åŠ©ç†è§£**

| ç‰¹æ€§å¯¹æ¯” | **ä¼ ç»ŸPipeline** | **å¤šåˆ†æ”¯Pipeline** |
|---------|----------------|-------------------|
| ğŸ”¸ **ç®¡ç†æ–¹å¼** | `æ‰‹åŠ¨ä¸ºæ¯ä¸ªåˆ†æ”¯åˆ›å»ºJob` | `è‡ªåŠ¨å‘ç°å¹¶åˆ›å»ºåˆ†æ”¯Job` |
| ğŸ”¸ **ç»´æŠ¤æˆæœ¬** | `æ¯ä¸ªåˆ†æ”¯éƒ½è¦å•ç‹¬é…ç½®` | `ä¸€æ¬¡é…ç½®ï¼Œè‡ªåŠ¨åº”ç”¨æ‰€æœ‰åˆ†æ”¯` |
| ğŸ”¸ **åˆ†æ”¯æ”¯æŒ** | `æœ‰é™ï¼Œéœ€è¦æ‰‹åŠ¨æ·»åŠ ` | `æ— é™ï¼Œè‡ªåŠ¨æ”¯æŒæ–°åˆ†æ”¯` |
| ğŸ”¸ **é…ç½®åŒæ­¥** | `éš¾ä»¥ä¿æŒä¸€è‡´` | `æ‰€æœ‰åˆ†æ”¯é…ç½®è‡ªåŠ¨åŒæ­¥` |
| ğŸ”¸ **æ¸…ç†æœºåˆ¶** | `éœ€è¦æ‰‹åŠ¨åˆ é™¤` | `åˆ†æ”¯åˆ é™¤æ—¶è‡ªåŠ¨æ¸…ç†` |

### 1.3 å¤šåˆ†æ”¯Pipelineçš„å·¥ä½œåŸç†

**ğŸ”„ è‡ªåŠ¨åŒ–å·¥ä½œæµç¨‹è§£æ**

```
Gitä»“åº“åˆ†æ”¯ç»“æ„ï¼š
master â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ (ç”Ÿäº§åˆ†æ”¯)
   â”‚
   â”œâ”€ develop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ (å¼€å‘ä¸»åˆ†æ”¯)
   â”‚     â”‚
   â”‚     â”œâ”€ feature/user-login â”€ (åŠŸèƒ½åˆ†æ”¯1)
   â”‚     â”‚
   â”‚     â””â”€ feature/payment â”€â”€â”€â”€ (åŠŸèƒ½åˆ†æ”¯2)
   â”‚
   â””â”€ hotfix/security-fix â”€â”€â”€â”€â”€â”€ (ä¿®å¤åˆ†æ”¯)

Jenkinsè‡ªåŠ¨å‘ç°è¿‡ç¨‹ï¼š
1. å®šæ—¶æ‰«æGitä»“åº“ â†’ å‘ç°æ‰€æœ‰åˆ†æ”¯
2. ä¸ºæ¯ä¸ªåˆ†æ”¯åˆ›å»ºç‹¬ç«‹Pipeline â†’ è‡ªåŠ¨é…ç½®æ„å»º
3. ç›‘æ§åˆ†æ”¯å˜åŒ– â†’ æ–°åˆ†æ”¯è‡ªåŠ¨æ·»åŠ ï¼Œåˆ é™¤åˆ†æ”¯è‡ªåŠ¨æ¸…ç†
4. æ‰§è¡Œå¯¹åº”æ„å»ºç­–ç•¥ â†’ ä¸åŒåˆ†æ”¯å¯ä»¥æœ‰ä¸åŒçš„æ„å»ºè§„åˆ™
```

**ğŸ’¡ å®é™…åº”ç”¨åœºæ™¯**
```
å¼€å‘å›¢é˜Ÿæ—¥å¸¸å·¥ä½œï¼š
1. å¼€å‘è€…åˆ›å»ºfeature/new-apiåˆ†æ”¯
2. Jenkinsè‡ªåŠ¨æ£€æµ‹åˆ°æ–°åˆ†æ”¯ï¼Œåˆ›å»ºå¯¹åº”Pipeline
3. å¼€å‘è€…æäº¤ä»£ç ï¼Œè§¦å‘è‡ªåŠ¨æ„å»ºå’Œæµ‹è¯•
4. åŠŸèƒ½å¼€å‘å®Œæˆï¼Œåˆ›å»ºPull Request
5. PRè§¦å‘ç‰¹æ®Šçš„åˆå¹¶å‰éªŒè¯æµç¨‹
6. åˆå¹¶å®Œæˆåï¼Œfeatureåˆ†æ”¯åˆ é™¤ï¼ŒJenkinsè‡ªåŠ¨æ¸…ç†å¯¹åº”Pipeline
```

---

## 2. âš™ï¸ å¤šåˆ†æ”¯Pipelineåˆ›å»ºä¸é…ç½®


### 2.1 åˆ›å»ºå¤šåˆ†æ”¯Pipelineé¡¹ç›®

ğŸ› ï¸ **ç¬¬ä¸€æ­¥ï¼šåœ¨Jenkinsä¸­åˆ›å»ºé¡¹ç›®**

**æ–°å»ºé¡¹ç›®æ­¥éª¤ï¼š**
1. **ç™»å½•Jenkinsé¦–é¡µ** â†’ ç‚¹å‡»"æ–°å»ºItem"
2. **é€‰æ‹©é¡¹ç›®ç±»å‹** â†’ é€‰æ‹©"Multibranch Pipeline"
3. **è¾“å…¥é¡¹ç›®åç§°** â†’ ä¾‹å¦‚ï¼š`my-app-multibranch`
4. **ç‚¹å‡»ç¡®å®š** â†’ è¿›å…¥é…ç½®ç•Œé¢

**ğŸ¯ é¡¹ç›®å‘½åæœ€ä½³å®è·µ**
```
æ¨èå‘½åæ ¼å¼ï¼š
- åº”ç”¨å-multibranchï¼šå¦‚ user-service-multibranch
- å›¢é˜Ÿå-åº”ç”¨å-mbï¼šå¦‚ frontend-webapp-mb
- é¡¹ç›®ä»£å·-åˆ†æ”¯ï¼šå¦‚ project-alpha-branches

é¿å…çš„å‘½åï¼š
- è¿‡é•¿çš„åç§°ï¼ˆè¶…è¿‡30ä¸ªå­—ç¬¦ï¼‰
- åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼ˆé™¤äº†-å’Œ_ï¼‰
- ä¸ç°æœ‰é¡¹ç›®é‡å
```

### 2.2 Gitä»“åº“é…ç½®

**ğŸ”— è¿æ¥ä½ çš„ä»£ç ä»“åº“**

**Gitä»“åº“è®¾ç½®æ­¥éª¤ï¼š**
1. **åœ¨Branch SourcesåŒºåŸŸ** â†’ ç‚¹å‡»"Add source"
2. **é€‰æ‹©Gité€‰é¡¹** â†’ é…ç½®ä»“åº“è¿æ¥
3. **å¡«å†™ä»“åº“URL** â†’ ä¾‹å¦‚ï¼š`https://github.com/username/my-app.git`
4. **é…ç½®è®¿é—®å‡­æ®** â†’ æ·»åŠ ç”¨æˆ·åå¯†ç æˆ–SSHå¯†é’¥

**ğŸ”‘ å‡­æ®é…ç½®è¯´æ˜**
```
å…¬å¼€ä»“åº“ï¼š
- æ— éœ€é…ç½®å‡­æ®
- ç›´æ¥ä½¿ç”¨HTTPS URLå³å¯

ç§æœ‰ä»“åº“é€‰é¡¹1ï¼ˆç”¨æˆ·åå¯†ç ï¼‰ï¼š
- Credentials â†’ Add â†’ Username with password
- è¾“å…¥Gitè´¦å·ç”¨æˆ·åå’Œå¯†ç 
- æˆ–ä½¿ç”¨Personal Access Token

ç§æœ‰ä»“åº“é€‰é¡¹2ï¼ˆSSHå¯†é’¥ï¼‰ï¼š
- Credentials â†’ Add â†’ SSH Username with private key
- ä¸Šä¼ ä½ çš„SSHç§é’¥æ–‡ä»¶
- ä½¿ç”¨SSHæ ¼å¼URLï¼šgit@github.com:username/repo.git
```

**âš ï¸ å®‰å…¨æé†’**
```
å‡­æ®å®‰å…¨æœ€ä½³å®è·µï¼š
âœ… ä½¿ç”¨Personal Access Tokenä»£æ›¿å¯†ç 
âœ… è®¾ç½®æœ€å°æƒé™ï¼ˆåªè¯»ä»£ç ä»“åº“ï¼‰
âœ… å®šæœŸè½®æ¢è®¿é—®å‡­æ®
âœ… ä¸è¦åœ¨Pipelineä»£ç ä¸­ç¡¬ç¼–ç å‡­æ®
âŒ é¿å…ä½¿ç”¨ä¸ªäººè´¦å·å¯†ç 
âŒ ä¸è¦å…±äº«å‡­æ®ç»™å¤šä¸ªé¡¹ç›®
```

### 2.3 åŸºç¡€æ„å»ºé…ç½®

**âš¡ Pipelineè„šæœ¬æ¥æºè®¾ç½®**

**æ„å»ºé…ç½®é€‰é¡¹ï¼š**

```
Build Configurationè®¾ç½®ï¼š
Mode: by Jenkinsfile
Script Path: Jenkinsfile (é»˜è®¤å€¼ï¼Œå¯è‡ªå®šä¹‰)

é«˜çº§é€‰é¡¹ï¼š
â–¡ Suppress automatic SCM triggering
â–¡ Override Jenkins URL for BlueOcean
â–¡ Pipeline libraries
```

**ğŸ“ Jenkinsfileä½ç½®è¯´æ˜**
```
æ ‡å‡†ä½ç½®ï¼ˆæ¨èï¼‰ï¼š
ä»“åº“æ ¹ç›®å½•/Jenkinsfile

è‡ªå®šä¹‰ä½ç½®ç¤ºä¾‹ï¼š
ci/Jenkinsfile           (CIé…ç½®ç›®å½•ä¸‹)
.jenkins/pipeline        (éšè—ç›®å½•ä¸‹)
build/Jenkinsfile        (æ„å»ºé…ç½®ç›®å½•)

å¤šJenkinsfileåœºæ™¯ï¼š
Jenkinsfile.dev          (å¼€å‘ç¯å¢ƒ)
Jenkinsfile.prod         (ç”Ÿäº§ç¯å¢ƒ)
Jenkinsfile.test         (æµ‹è¯•ç¯å¢ƒ)
```

### 2.4 æ‰«æé¢‘ç‡é…ç½®

**â° æ§åˆ¶Jenkinsæ£€æŸ¥ä»“åº“çš„é¢‘ç‡**

```
æ‰«æè§¦å‘å™¨é€‰é¡¹ï¼š

1. å®šæ—¶æ‰«æï¼ˆScan Multibranch Pipeline Triggersï¼‰
   - è®¾ç½®å®šæ—¶è§„åˆ™ï¼šH/15 * * * * (æ¯15åˆ†é’Ÿæ‰«æä¸€æ¬¡)
   - é€‚åˆï¼šæ›´æ–°é¢‘ç¹çš„å¼€å‘é¡¹ç›®
   
2. Webhookè§¦å‘ï¼ˆæ¨èï¼‰
   - å®æ—¶å“åº”Gitä»“åº“å˜åŒ–
   - éœ€è¦åœ¨Gitä»“åº“é…ç½®Webhook
   - URLæ ¼å¼ï¼šhttp://jenkins-url/multibranch-webhook-trigger/invoke?token=YOUR_TOKEN

3. æ‰‹åŠ¨æ‰«æ
   - åªåœ¨éœ€è¦æ—¶æ‰‹åŠ¨è§¦å‘
   - é€‚åˆï¼šæ›´æ–°ä¸é¢‘ç¹çš„é¡¹ç›®
```

**ğŸ”§ Webhooké…ç½®æŒ‡å—**
```
GitHub Webhookè®¾ç½®ï¼š
1. è¿›å…¥ä»“åº“ Settings â†’ Webhooks
2. Payload URL: http://your-jenkins.com/github-webhook/
3. Content type: application/json
4. Events: Push events, Pull requests
5. Active: âœ“

GitLab Webhookè®¾ç½®ï¼š
1. è¿›å…¥é¡¹ç›® Settings â†’ Integrations
2. URL: http://your-jenkins.com/project/PROJECT_NAME
3. Trigger: Push events, Merge request events
4. Enable SSL verification: æ ¹æ®ç¯å¢ƒå†³å®š
```

---

## 3. ğŸ” åˆ†æ”¯å‘ç°ç­–ç•¥é…ç½®


### 3.1 åˆ†æ”¯å‘ç°ç­–ç•¥ç±»å‹

ğŸ¯ **ç†è§£ä¸åŒçš„åˆ†æ”¯å‘ç°æ¨¡å¼**

```
æƒ³è±¡ä½ æ˜¯ä¸€ä¸ªå›¾ä¹¦é¦†ç®¡ç†å‘˜ï¼š
å‘ç°æ‰€æœ‰ä¹¦ç± = å‘ç°æ‰€æœ‰åˆ†æ”¯ï¼ˆAll branchesï¼‰
åªå…³æ³¨æ–°ä¹¦ = åªæ„å»ºæœ‰å˜åŒ–çš„åˆ†æ”¯ï¼ˆOnly branches with changesï¼‰
ç‰¹å®šç±»å‹ä¹¦ç± = æŒ‰è§„åˆ™è¿‡æ»¤åˆ†æ”¯ï¼ˆFilter by nameï¼‰
```

**ğŸ“‹ åˆ†æ”¯å‘ç°ç­–ç•¥è¯¦è§£**

| ç­–ç•¥ç±»å‹ | **é€‚ç”¨åœºæ™¯** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** |
|---------|-------------|---------|---------|
| ğŸ”¸ **All branches** | `å°å‹å›¢é˜Ÿï¼Œåˆ†æ”¯ä¸å¤š` | `ç®€å•ç›´æ¥ï¼Œä¸é—æ¼` | `èµ„æºæ¶ˆè€—å¤§` |
| ğŸ”¸ **Only with PR** | `ä¸¥æ ¼ä»£ç å®¡æŸ¥æµç¨‹` | `èŠ‚çœèµ„æºï¼Œè´¨é‡é«˜` | `é…ç½®å¤æ‚` |
| ğŸ”¸ **Regular branches only** | `åªå…³æ³¨æ™®é€šåˆ†æ”¯` | `æ’é™¤ä¸´æ—¶åˆ†æ”¯` | `å¯èƒ½é”™è¿‡é‡è¦åˆ†æ”¯` |
| ğŸ”¸ **Filter by name** | `å¤§å‹é¡¹ç›®ï¼Œåˆ†æ”¯ä¼—å¤š` | `ç²¾ç¡®æ§åˆ¶ï¼Œé«˜æ•ˆ` | `éœ€è¦ç»´æŠ¤è§„åˆ™` |

### 3.2 é…ç½®åˆ†æ”¯åŒ…å«å’Œæ’é™¤è§„åˆ™

**ğŸ¯ ç²¾ç¡®æ§åˆ¶å“ªäº›åˆ†æ”¯è¦æ„å»º**

**åŒ…å«è§„åˆ™é…ç½®ï¼š**
```
Property strategyè®¾ç½®ï¼š

Named branches get different properties:
- Branch name: master
- Properties: è®¾ç½®ç‰¹æ®Šæ„å»ºå±æ€§

Include branches:
- master          (ä¸»åˆ†æ”¯å¿…é¡»åŒ…å«)
- develop         (å¼€å‘åˆ†æ”¯)
- release/*       (æ‰€æœ‰å‘å¸ƒåˆ†æ”¯)
- feature/*       (æ‰€æœ‰åŠŸèƒ½åˆ†æ”¯)
- hotfix/*        (æ‰€æœ‰ä¿®å¤åˆ†æ”¯)

Exclude branches:
- experimental/*  (æ’é™¤å®éªŒæ€§åˆ†æ”¯)
- temp/*          (æ’é™¤ä¸´æ—¶åˆ†æ”¯)
- backup/*        (æ’é™¤å¤‡ä»½åˆ†æ”¯)
- */wip           (æ’é™¤è¿›è¡Œä¸­çš„åˆ†æ”¯)
```

**ğŸ”§ é«˜çº§è¿‡æ»¤è§„åˆ™**
```
æ­£åˆ™è¡¨è¾¾å¼è¿‡æ»¤ï¼š
^(master|develop)$                    åªåŒ…å«masterå’Œdevelop
^feature/[A-Z]+-[0-9]+$              åªåŒ…å«ç¬¦åˆæ ¼å¼çš„featureåˆ†æ”¯
^(release|hotfix)/v[0-9]+\.[0-9]+$   åªåŒ…å«ç‰ˆæœ¬å·æ ¼å¼çš„å‘å¸ƒåˆ†æ”¯

é€šé…ç¬¦è¿‡æ»¤ï¼š
release-*         æ‰€æœ‰ä»¥release-å¼€å¤´çš„åˆ†æ”¯
*-stable          æ‰€æœ‰ä»¥-stableç»“å°¾çš„åˆ†æ”¯
v[0-9].[0-9].*    ç‰ˆæœ¬å·æ ¼å¼çš„åˆ†æ”¯

æ’é™¤ç¤ºä¾‹ï¼š
^(?!.*(temp|backup|experimental)).*$ æ’é™¤åŒ…å«ç‰¹å®šå…³é”®è¯çš„åˆ†æ”¯
```

### 3.3 åˆ†æ”¯å±æ€§é…ç½®

**âš™ï¸ ä¸ºä¸åŒåˆ†æ”¯è®¾ç½®ä¸åŒçš„æ„å»ºè¡Œä¸º**

```
åˆ†æ”¯å±æ€§é…ç½®ç­–ç•¥ï¼š

ä¸»åˆ†æ”¯ï¼ˆmaster/mainï¼‰å±æ€§ï¼š
- æ„å»ºé¢‘ç‡ï¼šæ¯æ¬¡æäº¤éƒ½æ„å»º
- æµ‹è¯•çº§åˆ«ï¼šå®Œæ•´æµ‹è¯•å¥—ä»¶
- éƒ¨ç½²ç›®æ ‡ï¼šç”Ÿäº§ç¯å¢ƒ
- é€šçŸ¥è®¾ç½®ï¼šå¤±è´¥æ—¶ç«‹å³é€šçŸ¥

å¼€å‘åˆ†æ”¯ï¼ˆdevelopï¼‰å±æ€§ï¼š
- æ„å»ºé¢‘ç‡ï¼šæ¯æ¬¡æäº¤éƒ½æ„å»º
- æµ‹è¯•çº§åˆ«ï¼šå®Œæ•´æµ‹è¯• + é›†æˆæµ‹è¯•
- éƒ¨ç½²ç›®æ ‡ï¼šæµ‹è¯•ç¯å¢ƒ
- é€šçŸ¥è®¾ç½®ï¼šå¤±è´¥æ—¶é€šçŸ¥å›¢é˜Ÿ

åŠŸèƒ½åˆ†æ”¯ï¼ˆfeature/*ï¼‰å±æ€§ï¼š
- æ„å»ºé¢‘ç‡ï¼šPushæ—¶æ„å»º
- æµ‹è¯•çº§åˆ«ï¼šå•å…ƒæµ‹è¯• + ä»£ç æ£€æŸ¥
- éƒ¨ç½²ç›®æ ‡ï¼šå¼€å‘ç¯å¢ƒ
- é€šçŸ¥è®¾ç½®ï¼šåªé€šçŸ¥å¼€å‘è€…æœ¬äºº

å‘å¸ƒåˆ†æ”¯ï¼ˆrelease/*ï¼‰å±æ€§ï¼š
- æ„å»ºé¢‘ç‡ï¼šæ¯æ¬¡æäº¤éƒ½æ„å»º
- æµ‹è¯•çº§åˆ«ï¼šå®Œæ•´æµ‹è¯• + æ€§èƒ½æµ‹è¯•
- éƒ¨ç½²ç›®æ ‡ï¼šé¢„ç”Ÿäº§ç¯å¢ƒ
- é€šçŸ¥è®¾ç½®ï¼šå¤±è´¥æ—¶é€šçŸ¥å‘å¸ƒå›¢é˜Ÿ
```

### 3.4 åˆ†æ”¯ç”Ÿå‘½å‘¨æœŸç®¡ç†

**â™»ï¸ è‡ªåŠ¨åŒ–åˆ†æ”¯ç”Ÿå‘½å‘¨æœŸ**

**åˆ†æ”¯ç”Ÿå‘½å‘¨æœŸé˜¶æ®µï¼š**
```
1. åˆ†æ”¯åˆ›å»ºé˜¶æ®µ
   Jenkinsè¡Œä¸ºï¼š
   - è‡ªåŠ¨å‘ç°æ–°åˆ†æ”¯
   - åˆ›å»ºå¯¹åº”Pipeline
   - æ‰§è¡Œé¦–æ¬¡æ„å»º
   - å‘é€åˆ›å»ºé€šçŸ¥

2. åˆ†æ”¯æ´»è·ƒé˜¶æ®µ  
   Jenkinsè¡Œä¸ºï¼š
   - ç›‘æ§ä»£ç æäº¤
   - è§¦å‘è‡ªåŠ¨æ„å»º
   - æ‰§è¡Œæµ‹è¯•æµç¨‹
   - æŠ¥å‘Šæ„å»ºç»“æœ

3. åˆ†æ”¯åˆå¹¶é˜¶æ®µ
   Jenkinsè¡Œä¸ºï¼š
   - æ‰§è¡Œåˆå¹¶å‰éªŒè¯
   - è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
   - æ£€æŸ¥ä»£ç è´¨é‡
   - ç¡®è®¤åˆå¹¶æ¡ä»¶

4. åˆ†æ”¯æ¸…ç†é˜¶æ®µ
   Jenkinsè¡Œä¸ºï¼š
   - æ£€æµ‹åˆ†æ”¯åˆ é™¤
   - åœæ­¢ç›¸å…³æ„å»º
   - æ¸…ç†å·¥ä½œç©ºé—´
   - å½’æ¡£æ„å»ºå†å²
```

**ğŸ”„ ç”Ÿå‘½å‘¨æœŸè‡ªåŠ¨åŒ–é…ç½®**
```
Orphaned Item Strategyè®¾ç½®ï¼š

Days to keep old items: 7
- åˆ†æ”¯åˆ é™¤åä¿ç•™Pipeline 7å¤©
- ä¾¿äºæ’æŸ¥å†å²é—®é¢˜

Max # of old items to keep: 10  
- æœ€å¤šä¿ç•™10ä¸ªå·²åˆ é™¤åˆ†æ”¯çš„Pipeline
- é˜²æ­¢æ— é™ç´¯ç§¯

Discard old builds strategy:
- Days to keep builds: 30
- Max # of builds to keep: 100
- è‡ªåŠ¨æ¸…ç†æ—§çš„æ„å»ºè®°å½•
```

---

## 4. ğŸ“‚ Jenkinsfileè·¯å¾„ç®¡ç†


### 4.1 Jenkinsfileè·¯å¾„ç­–ç•¥

ğŸ—‚ï¸ **ä¸ºä¸åŒåˆ†æ”¯é…ç½®ä¸åŒçš„Pipelineè„šæœ¬**

```
å•ä¸€Jenkinsfileç­–ç•¥ï¼ˆæ¨èæ–°æ‰‹ï¼‰ï¼š
ä»“åº“æ ¹ç›®å½•/Jenkinsfile

ä¼˜ç‚¹ï¼š
- é…ç½®ç®€å•ï¼Œæ‰€æœ‰åˆ†æ”¯ä½¿ç”¨ç›¸åŒæµç¨‹
- ç»´æŠ¤æˆæœ¬ä½ï¼Œåªéœ€è¦ç®¡ç†ä¸€ä¸ªæ–‡ä»¶
- å­¦ä¹ æˆæœ¬ä½ï¼Œæ–°æ‰‹å®¹æ˜“ç†è§£

ç¼ºç‚¹ï¼š
- çµæ´»æ€§æœ‰é™ï¼Œéš¾ä»¥ä¸ºä¸åŒåˆ†æ”¯å®šåˆ¶
- å¤æ‚é¡¹ç›®å¯èƒ½éœ€è¦å¾ˆå¤šæ¡ä»¶åˆ¤æ–­
```

**ğŸ¯ å¤šJenkinsfileç­–ç•¥ï¼ˆé€‚åˆå¤æ‚é¡¹ç›®ï¼‰**
```
ç›®å½•ç»“æ„ç¤ºä¾‹ï¼š
project-root/
â”œâ”€â”€ Jenkinsfile                 (é»˜è®¤Pipeline)
â”œâ”€â”€ ci/
â”‚   â”œâ”€â”€ Jenkinsfile.dev        (å¼€å‘ç¯å¢ƒPipeline)
â”‚   â”œâ”€â”€ Jenkinsfile.staging    (æµ‹è¯•ç¯å¢ƒPipeline)
â”‚   â””â”€â”€ Jenkinsfile.prod       (ç”Ÿäº§ç¯å¢ƒPipeline)
â”œâ”€â”€ src/
â””â”€â”€ tests/

è·¯å¾„é…ç½®åœ¨Jenkinsä¸­ï¼š
- masteråˆ†æ”¯ï¼šci/Jenkinsfile.prod
- developåˆ†æ”¯ï¼šci/Jenkinsfile.staging  
- feature/*åˆ†æ”¯ï¼šci/Jenkinsfile.dev
```

### 4.2 æ¡ä»¶åŒ–Pipelineé…ç½®

**ğŸ”€ æ ¹æ®åˆ†æ”¯åç§°æ‰§è¡Œä¸åŒçš„æ„å»ºé€»è¾‘**

```groovy
// åœ¨å•ä¸€Jenkinsfileä¸­æ ¹æ®åˆ†æ”¯æ‰§è¡Œä¸åŒé€»è¾‘
pipeline {
    agent any
    
    stages {
        stage('Build') {
            steps {
                script {
                    // æ ¹æ®åˆ†æ”¯åç§°é€‰æ‹©ä¸åŒçš„æ„å»ºæ–¹å¼
                    if (env.BRANCH_NAME == 'master') {
                        echo "æ­£åœ¨ä¸ºç”Ÿäº§ç¯å¢ƒæ„å»º..."
                        // ç”Ÿäº§ç¯å¢ƒæ„å»ºé€»è¾‘
                        sh 'npm run build:prod'
                    } else if (env.BRANCH_NAME == 'develop') {
                        echo "æ­£åœ¨ä¸ºæµ‹è¯•ç¯å¢ƒæ„å»º..."
                        // æµ‹è¯•ç¯å¢ƒæ„å»ºé€»è¾‘  
                        sh 'npm run build:staging'
                    } else if (env.BRANCH_NAME.startsWith('feature/')) {
                        echo "æ­£åœ¨ä¸ºåŠŸèƒ½åˆ†æ”¯æ„å»º..."
                        // å¼€å‘ç¯å¢ƒæ„å»ºé€»è¾‘
                        sh 'npm run build:dev'
                    }
                }
            }
        }
        
        stage('Test') {
            steps {
                script {
                    // ä¸åŒåˆ†æ”¯æ‰§è¡Œä¸åŒçº§åˆ«çš„æµ‹è¯•
                    if (env.BRANCH_NAME == 'master') {
                        echo "æ‰§è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶..."
                        sh 'npm run test:full'
                        sh 'npm run test:e2e'
                    } else {
                        echo "æ‰§è¡Œå¿«é€Ÿæµ‹è¯•..."
                        sh 'npm run test:unit'
                    }
                }
            }
        }
    }
}
```

### 4.3 Jenkinsfileæ¨¡æ¿åŒ–ç®¡ç†

**ğŸ“‹ æé«˜Pipelineå¤ç”¨æ€§å’Œç»´æŠ¤æ€§**

**å…±äº«åº“æ–¹å¼ï¼ˆæ¨èï¼‰ï¼š**
```groovy
// vars/standardPipeline.groovyï¼ˆå…±äº«åº“æ–‡ä»¶ï¼‰
def call(Map config) {
    pipeline {
        agent any
        
        stages {
            stage('Checkout') {
                steps {
                    checkout scm
                }
            }
            
            stage('Build') {
                steps {
                    script {
                        // æ ¹æ®é…ç½®æ‰§è¡Œä¸åŒçš„æ„å»ºå‘½ä»¤
                        sh config.buildCommand
                    }
                }
            }
            
            stage('Test') {
                steps {
                    script {
                        sh config.testCommand
                    }
                }
            }
            
            stage('Deploy') {
                when {
                    branch config.deployBranch
                }
                steps {
                    script {
                        sh config.deployCommand
                    }
                }
            }
        }
    }
}

// é¡¹ç›®ä¸­çš„Jenkinsfile
@Library('shared-pipeline-library') _

standardPipeline([
    buildCommand: 'mvn clean compile',
    testCommand: 'mvn test',
    deployCommand: 'mvn deploy',
    deployBranch: 'master'
])
```

**ğŸ’¡ æ¨¡æ¿åŒ–çš„ä¼˜åŠ¿**
```
ä»£ç å¤ç”¨ï¼š
- å¤šä¸ªé¡¹ç›®å¯ä»¥ä½¿ç”¨ç›¸åŒçš„Pipelineæ¨¡æ¿
- å‡å°‘é‡å¤ä»£ç ï¼Œæé«˜å¼€å‘æ•ˆç‡

ç»Ÿä¸€æ ‡å‡†ï¼š
- æ‰€æœ‰é¡¹ç›®éµå¾ªç›¸åŒçš„CI/CDæµç¨‹
- ä¾¿äºå›¢é˜Ÿåä½œå’ŒçŸ¥è¯†ä¼ æ‰¿

ç»´æŠ¤ä¾¿åˆ©ï¼š
- ä¿®æ”¹æ¨¡æ¿å¯ä»¥å½±å“æ‰€æœ‰ä½¿ç”¨è¯¥æ¨¡æ¿çš„é¡¹ç›®
- é›†ä¸­ç®¡ç†ï¼Œé™ä½ç»´æŠ¤æˆæœ¬

ç‰ˆæœ¬æ§åˆ¶ï¼š
- æ¨¡æ¿å˜æ›´æœ‰ç‰ˆæœ¬è®°å½•
- å¯ä»¥å›æ»šåˆ°ä¹‹å‰çš„æ¨¡æ¿ç‰ˆæœ¬
```

### 4.4 åŠ¨æ€Jenkinsfileç”Ÿæˆ

**ğŸ¤– æ ¹æ®é¡¹ç›®ç‰¹å¾è‡ªåŠ¨ç”ŸæˆPipeline**

```groovy
// åŠ¨æ€æ£€æµ‹é¡¹ç›®ç±»å‹å¹¶ç”Ÿæˆç›¸åº”Pipeline
pipeline {
    agent any
    
    stages {
        stage('Detect Project Type') {
            steps {
                script {
                    // æ£€æµ‹é¡¹ç›®ç±»å‹
                    def projectType = 'unknown'
                    
                    if (fileExists('package.json')) {
                        projectType = 'nodejs'
                    } else if (fileExists('pom.xml')) {
                        projectType = 'maven'
                    } else if (fileExists('build.gradle')) {
                        projectType = 'gradle'
                    } else if (fileExists('requirements.txt')) {
                        projectType = 'python'
                    }
                    
                    env.PROJECT_TYPE = projectType
                    echo "æ£€æµ‹åˆ°é¡¹ç›®ç±»å‹: ${projectType}"
                }
            }
        }
        
        stage('Build') {
            steps {
                script {
                    switch(env.PROJECT_TYPE) {
                        case 'nodejs':
                            sh 'npm install'
                            sh 'npm run build'
                            break
                        case 'maven':
                            sh 'mvn clean compile'
                            break
                        case 'gradle':
                            sh './gradlew build'
                            break
                        case 'python':
                            sh 'pip install -r requirements.txt'
                            sh 'python setup.py build'
                            break
                        default:
                            error "ä¸æ”¯æŒçš„é¡¹ç›®ç±»å‹: ${env.PROJECT_TYPE}"
                    }
                }
            }
        }
    }
}
```

---

## 5. ğŸ¯ åˆ†æ”¯æ„å»ºç­–ç•¥è®¾ç½®


### 5.1 æ„å»ºè§¦å‘ç­–ç•¥

âš¡ **æ§åˆ¶ä»€ä¹ˆæ—¶å€™è§¦å‘æ„å»º**

```
æ„å»ºè§¦å‘æ—¶æœºé€‰æ‹©ï¼š

ç«‹å³è§¦å‘ï¼ˆImmediateï¼‰ï¼š
- é€‚ç”¨åˆ†æ”¯ï¼šmaster, develop
- è§¦å‘æ¡ä»¶ï¼šæ¯æ¬¡ä»£ç æ¨é€
- ä¼˜ç‚¹ï¼šå¿«é€Ÿåé¦ˆï¼ŒåŠæ—¶å‘ç°é—®é¢˜
- ç¼ºç‚¹ï¼šèµ„æºæ¶ˆè€—å¤§ï¼Œå¯èƒ½é¢‘ç¹æ‰“æ–­

å»¶è¿Ÿè§¦å‘ï¼ˆDelayedï¼‰ï¼š
- é€‚ç”¨åˆ†æ”¯ï¼šfeatureåˆ†æ”¯
- è§¦å‘æ¡ä»¶ï¼šä»£ç æ¨é€åç­‰å¾…5-10åˆ†é’Ÿ
- ä¼˜ç‚¹ï¼šé¿å…é¢‘ç¹æ„å»ºï¼ŒèŠ‚çœèµ„æº
- ç¼ºç‚¹ï¼šåé¦ˆå»¶è¿Ÿï¼Œå¯èƒ½é”™è¿‡æ—©æœŸé—®é¢˜å‘ç°

æ‰¹é‡è§¦å‘ï¼ˆBatchedï¼‰ï¼š
- é€‚ç”¨åˆ†æ”¯ï¼šä¸é‡è¦çš„å®éªŒåˆ†æ”¯
- è§¦å‘æ¡ä»¶ï¼šç§¯ç´¯å¤šä¸ªæäº¤åä¸€èµ·æ„å»º
- ä¼˜ç‚¹ï¼šæœ€èŠ‚çœèµ„æº
- ç¼ºç‚¹ï¼šåé¦ˆæ›´æ…¢ï¼Œä¸é€‚åˆå…³é”®åˆ†æ”¯
```

### 5.2 å¹¶å‘æ„å»ºæ§åˆ¶

ğŸš¦ **ç®¡ç†æ„å»ºèµ„æºå’Œé¿å…å†²çª**

**å¹¶å‘æ§åˆ¶é…ç½®ï¼š**
```
Pipelineçº§åˆ«å¹¶å‘æ§åˆ¶ï¼š

properties([
    // é™åˆ¶åŒæ—¶åªèƒ½æœ‰2ä¸ªè¯¥Pipelineå®ä¾‹è¿è¡Œ
    pipelineTriggers([]),
    buildDiscarder(logRotator(numToKeepStr: '10')),
    // ç¦ç”¨å¹¶å‘æ„å»º
    disableConcurrentBuilds()
])

åˆ†æ”¯çº§åˆ«å¹¶å‘æ§åˆ¶ï¼š
pipeline {
    agent any
    
    options {
        // æ ¹æ®åˆ†æ”¯è®¾ç½®ä¸åŒçš„å¹¶å‘ç­–ç•¥
        script {
            if (env.BRANCH_NAME == 'master') {
                // ä¸»åˆ†æ”¯ç¦æ­¢å¹¶å‘
                disableConcurrentBuilds()
            } else {
                // å…¶ä»–åˆ†æ”¯å…è®¸å¹¶å‘ï¼Œä½†é™åˆ¶æ•°é‡
                timeout(time: 30, unit: 'MINUTES')
            }
        }
    }
}
```

**ğŸ›ï¸ èµ„æºæ± ç®¡ç†**
```
JenkinsèŠ‚ç‚¹èµ„æºåˆ†é…ï¼š

é«˜ä¼˜å…ˆçº§åˆ†æ”¯ï¼ˆmaster, release/*ï¼‰ï¼š
- ä½¿ç”¨ä¸“ç”¨çš„é«˜æ€§èƒ½æ„å»ºèŠ‚ç‚¹
- ä¿è¯èµ„æºå……è¶³ï¼Œæ„å»ºé€Ÿåº¦å¿«

ä¸­ä¼˜å…ˆçº§åˆ†æ”¯ï¼ˆdevelop, hotfix/*ï¼‰ï¼š
- ä½¿ç”¨å…±äº«çš„ä¸­ç­‰æ€§èƒ½èŠ‚ç‚¹
- å¹³è¡¡èµ„æºä½¿ç”¨å’Œæ„å»ºé€Ÿåº¦

ä½ä¼˜å…ˆçº§åˆ†æ”¯ï¼ˆfeature/*, experimental/*ï¼‰ï¼š
- ä½¿ç”¨å…±äº«çš„åŸºç¡€æ€§èƒ½èŠ‚ç‚¹
- å¯ä»¥æ’é˜Ÿç­‰å¾…ï¼Œä¸å½±å“å…³é”®åˆ†æ”¯
```

### 5.3 æ„å»ºè¶…æ—¶å’Œé‡è¯•æœºåˆ¶

â° **é˜²æ­¢æ„å»ºå¡æ­»å’Œæé«˜æ„å»ºå¯é æ€§**

```groovy
pipeline {
    agent any
    
    options {
        // è®¾ç½®æ„å»ºè¶…æ—¶æ—¶é—´
        timeout(time: 1, unit: 'HOURS')
        
        // è®¾ç½®é‡è¯•æ¬¡æ•°
        retry(3)
        
        // ä¿ç•™æ„å»ºè®°å½•æ•°é‡
        buildDiscarder(logRotator(
            numToKeepStr: '50',        // ä¿ç•™50ä¸ªæ„å»º
            daysToKeepStr: '30',       // ä¿ç•™30å¤©
            artifactNumToKeepStr: '10' // ä¿ç•™10ä¸ªæ„å»ºäº§ç‰©
        ))
    }
    
    stages {
        stage('Build with Retry') {
            steps {
                script {
                    // å¯¹ç‰¹å®šæ­¥éª¤è¿›è¡Œé‡è¯•
                    retry(3) {
                        sh 'npm install'  // ç½‘ç»œé—®é¢˜å¯èƒ½éœ€è¦é‡è¯•
                    }
                    
                    // é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡è®¾ç½®è¶…æ—¶
                    timeout(time: 30, unit: 'MINUTES') {
                        sh 'npm run build'
                    }
                }
            }
        }
    }
}
```

### 5.4 åˆ†æ”¯ç‰¹å®šçš„æ„å»ºç¯å¢ƒ

ğŸ—ï¸ **ä¸ºä¸åŒåˆ†æ”¯é…ç½®ä¸“é—¨çš„æ„å»ºç¯å¢ƒ**

```groovy
pipeline {
    agent {
        // æ ¹æ®åˆ†æ”¯é€‰æ‹©ä¸åŒçš„æ„å»ºç¯å¢ƒ
        label "${getBuildLabel()}"
    }
    
    stages {
        stage('Environment Setup') {
            steps {
                script {
                    // æ ¹æ®åˆ†æ”¯è®¾ç½®ä¸åŒçš„ç¯å¢ƒå˜é‡
                    if (env.BRANCH_NAME == 'master') {
                        env.BUILD_ENV = 'production'
                        env.NODE_ENV = 'production'
                        env.API_URL = 'https://api.prod.example.com'
                    } else if (env.BRANCH_NAME == 'develop') {
                        env.BUILD_ENV = 'staging'
                        env.NODE_ENV = 'staging'
                        env.API_URL = 'https://api.staging.example.com'
                    } else {
                        env.BUILD_ENV = 'development'
                        env.NODE_ENV = 'development'
                        env.API_URL = 'https://api.dev.example.com'
                    }
                    
                    echo "æ„å»ºç¯å¢ƒ: ${env.BUILD_ENV}"
                    echo "APIåœ°å€: ${env.API_URL}"
                }
            }
        }
    }
}

// è¾…åŠ©å‡½æ•°ï¼šæ ¹æ®åˆ†æ”¯é€‰æ‹©æ„å»ºæ ‡ç­¾
def getBuildLabel() {
    if (env.BRANCH_NAME == 'master') {
        return 'production-builder'  // é«˜æ€§èƒ½ä¸“ç”¨èŠ‚ç‚¹
    } else if (env.BRANCH_NAME.startsWith('release/')) {
        return 'staging-builder'     // æµ‹è¯•ç¯å¢ƒä¸“ç”¨èŠ‚ç‚¹
    } else {
        return 'general-builder'     // é€šç”¨æ„å»ºèŠ‚ç‚¹
    }
}
```

---

## 6. ğŸ”„ PR/MRæ„å»ºé…ç½®


### 6.1 Pull Requestæ„å»ºåŸºç¡€

ğŸ¤ **ç†è§£PRæ„å»ºçš„é‡è¦æ€§**

```
ä»€ä¹ˆæ˜¯PRæ„å»ºï¼Ÿ
æƒ³è±¡ä¸€ä¸‹ä»£ç åˆå¹¶å°±åƒä¸¤æ¡æ²³æµæ±‡èšï¼š
ä¸»æ²³æµï¼ˆä¸»åˆ†æ”¯ï¼‰ï¼šæ°´è´¨æ¸…æ¾ˆï¼Œä¸èƒ½è¢«æ±¡æŸ“
æ”¯æµï¼ˆåŠŸèƒ½åˆ†æ”¯ï¼‰ï¼šå¯èƒ½æºå¸¦æ³¥æ²™ï¼Œéœ€è¦è¿‡æ»¤
PRæ„å»º = æ±‡èšå‰çš„æ°´è´¨æ£€æµ‹

PRæ„å»ºçš„ä»·å€¼ï¼š
1. åˆå¹¶å‰éªŒè¯ - ç¡®ä¿æ–°ä»£ç ä¸ä¼šç ´åç°æœ‰åŠŸèƒ½
2. å†²çªæ£€æµ‹ - æå‰å‘ç°ä»£ç åˆå¹¶å†²çª
3. è´¨é‡ä¿è¯ - è¿è¡Œå®Œæ•´çš„æµ‹è¯•å¥—ä»¶
4. å›¢é˜Ÿåä½œ - ä¸ºä»£ç å®¡æŸ¥æä¾›æ„å»ºçŠ¶æ€
```

### 6.2 GitHub PRæ„å»ºé…ç½®

ğŸ™ **é…ç½®GitHub Pull Requestçš„è‡ªåŠ¨æ„å»º**

**GitHub Branch Sourceé…ç½®ï¼š**
```
Discover pull requests from origin:
â˜‘ Merging the pull request with the current target branch revision
â˜‘ The current pull request revision  
â˜‘ Both the current pull request revision and the pull request merged with the current target branch revision

Trust strategy:
â—‹ Nobody (æ¨èå®‰å…¨è®¾ç½®)
â—‹ Contributors  
â—‹ Everyone
â—‹ From users with Admin or Write permission

Additional behaviours:
â˜‘ Check out to matching local branch
â˜‘ Clean before checkout
â˜‘ Prune stale remote-tracking branches
```

**ğŸ’¡ Trustç­–ç•¥è¯´æ˜**
```
Nobodyï¼š
- æœ€å®‰å…¨çš„é€‰é¡¹
- åªæ„å»ºä»“åº“ç»´æŠ¤è€…åˆ›å»ºçš„PR
- é€‚åˆå¼€æºé¡¹ç›®

Contributorsï¼š
- æ„å»ºè´¡çŒ®è€…çš„PR
- éœ€è¦ä¹‹å‰æœ‰è¿‡è´¡çŒ®è®°å½•
- å¹³è¡¡å®‰å…¨æ€§å’Œä¾¿åˆ©æ€§

Everyoneï¼š
- æ„å»ºæ‰€æœ‰PRï¼ŒåŒ…æ‹¬é¦–æ¬¡è´¡çŒ®è€…
- å®‰å…¨é£é™©è¾ƒé«˜
- ä»…é€‚åˆå†…éƒ¨é¡¹ç›®

Admin/Write permissionï¼š
- åªæ„å»ºæœ‰å†™æƒé™ç”¨æˆ·çš„PR
- é€‚åˆä¼ä¸šå†…éƒ¨ä½¿ç”¨
- å®‰å…¨æ€§è¾ƒé«˜
```

### 6.3 GitLab MRæ„å»ºé…ç½®

ğŸ¦Š **é…ç½®GitLab Merge Requestçš„è‡ªåŠ¨æ„å»º**

```
GitLab Branch Sourceé…ç½®ï¼š

Discover merge requests from origin:
â˜‘ Merging the merge request with the current target branch revision
â˜‘ The current merge request revision

Merge request filter:
- All merge requests
- Only merge requests targeting specific branches
- Exclude merge requests targeting specific branches

Strategy for building merge requests:
â—‹ Build merge requests targeting this branch
â—‹ Build merge requests from origin with a different target branch
â—‹ Build all merge requests
```

**ğŸ”§ GitLab Webhooké…ç½®**
```groovy
// Jenkinsfileä¸­å¤„ç†GitLab MRäº‹ä»¶
pipeline {
    agent any
    
    stages {
        stage('MR Validation') {
            when {
                // åªåœ¨MRæ—¶æ‰§è¡Œç‰¹æ®ŠéªŒè¯
                changeRequest()
            }
            steps {
                script {
                    // è·å–MRä¿¡æ¯
                    def mrTitle = env.CHANGE_TITLE
                    def mrAuthor = env.CHANGE_AUTHOR
                    def targetBranch = env.CHANGE_TARGET
                    
                    echo "æ­£åœ¨éªŒè¯MR: ${mrTitle}"
                    echo "ä½œè€…: ${mrAuthor}"
                    echo "ç›®æ ‡åˆ†æ”¯: ${targetBranch}"
                    
                    // æ‰§è¡ŒMRç‰¹å®šçš„æ£€æŸ¥
                    sh 'npm run lint'
                    sh 'npm run test:integration'
                    sh 'npm run security:scan'
                }
            }
        }
        
        stage('Quality Gate') {
            when {
                changeRequest()
            }
            steps {
                script {
                    // è´¨é‡é—¨æ£€æŸ¥
                    def qualityGate = sh(
                        script: 'npm run quality:check',
                        returnStatus: true
                    )
                    
                    if (qualityGate != 0) {
                        error "è´¨é‡æ£€æŸ¥å¤±è´¥ï¼ŒPRä¸èƒ½åˆå¹¶"
                    }
                }
            }
        }
    }
    
    post {
        success {
            script {
                if (env.CHANGE_ID) {
                    // PRæ„å»ºæˆåŠŸï¼Œæ·»åŠ è¯„è®º
                    githubPRComment comment: 'âœ… æ„å»ºæˆåŠŸï¼ŒPRå¯ä»¥åˆå¹¶ï¼'
                }
            }
        }
        failure {
            script {
                if (env.CHANGE_ID) {
                    // PRæ„å»ºå¤±è´¥ï¼Œæ·»åŠ è¯„è®º
                    githubPRComment comment: 'âŒ æ„å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥ä»£ç å¹¶ä¿®å¤é—®é¢˜ã€‚'
                }
            }
        }
    }
}
```

### 6.4 PRæ„å»ºé«˜çº§åŠŸèƒ½

âš¡ **å¢å¼ºPRæ„å»ºçš„æ™ºèƒ½åŒ–ç¨‹åº¦**

**ä»£ç å˜æ›´æ£€æµ‹ï¼š**
```groovy
pipeline {
    agent any
    
    stages {
        stage('Change Detection') {
            when {
                changeRequest()
            }
            steps {
                script {
                    // æ£€æµ‹å“ªäº›æ–‡ä»¶å‘ç”Ÿäº†å˜åŒ–
                    def changedFiles = sh(
                        script: 'git diff --name-only origin/${CHANGE_TARGET}...HEAD',
                        returnStdout: true
                    ).trim().split('\n')
                    
                    def frontendChanged = changedFiles.any { it.startsWith('frontend/') }
                    def backendChanged = changedFiles.any { it.startsWith('backend/') }
                    def docsChanged = changedFiles.any { it.startsWith('docs/') }
                    
                    // åªæ„å»ºå˜æ›´çš„éƒ¨åˆ†
                    if (frontendChanged) {
                        env.BUILD_FRONTEND = 'true'
                        echo "æ£€æµ‹åˆ°å‰ç«¯ä»£ç å˜æ›´ï¼Œå°†æ„å»ºå‰ç«¯"
                    }
                    
                    if (backendChanged) {
                        env.BUILD_BACKEND = 'true'
                        echo "æ£€æµ‹åˆ°åç«¯ä»£ç å˜æ›´ï¼Œå°†æ„å»ºåç«¯"
                    }
                    
                    if (docsChanged && !frontendChanged && !backendChanged) {
                        env.DOCS_ONLY = 'true'
                        echo "ä»…æ–‡æ¡£å˜æ›´ï¼Œè·³è¿‡ä»£ç æ„å»º"
                    }
                }
            }
        }
        
        stage('Conditional Build') {
            parallel {
                stage('Frontend Build') {
                    when {
                        environment name: 'BUILD_FRONTEND', value: 'true'
                    }
                    steps {
                        dir('frontend') {
                            sh 'npm install'
                            sh 'npm run build'
                            sh 'npm run test'
                        }
                    }
                }
                
                stage('Backend Build') {
                    when {
                        environment name: 'BUILD_BACKEND', value: 'true'  
                    }
                    steps {
                        dir('backend') {
                            sh 'mvn clean compile'
                            sh 'mvn test'
                        }
                    }
                }
            }
        }
    }
}
```

**è‡ªåŠ¨åŒ–ä»£ç å®¡æŸ¥ï¼š**
```groovy
stage('Automated Code Review') {
    when {
        changeRequest()
    }
    steps {
        script {
            // è¿è¡Œé™æ€ä»£ç åˆ†æ
            sh 'sonar-scanner'
            
            // æ£€æŸ¥ä»£ç è¦†ç›–ç‡
            def coverage = sh(
                script: 'cat coverage/lcov-report/index.html | grep "Functions" | grep -o "[0-9]*\.[0-9]*%"',
                returnStdout: true
            ).trim()
            
            def coverageValue = coverage.replace('%', '') as Double
            
            if (coverageValue < 80.0) {
                githubPRComment comment: "âš ï¸ ä»£ç è¦†ç›–ç‡ ${coverage} ä½äºè¦æ±‚çš„80%ï¼Œè¯·å¢åŠ æµ‹è¯•ç”¨ä¾‹ã€‚"
                currentBuild.result = 'UNSTABLE'
            } else {
                githubPRComment comment: "âœ… ä»£ç è¦†ç›–ç‡ ${coverage} ç¬¦åˆè¦æ±‚ã€‚"
            }
        }
    }
}
```

---

## 7. ğŸ›¡ï¸ åˆ†æ”¯ä¿æŠ¤ä¸åˆå¹¶ç­–ç•¥


### 7.1 åˆ†æ”¯ä¿æŠ¤è§„åˆ™

ğŸ”’ **ä¿æŠ¤é‡è¦åˆ†æ”¯å…å—ç ´å**

```
åˆ†æ”¯ä¿æŠ¤çš„é‡è¦æ€§ï¼š
æƒ³è±¡ä¸»åˆ†æ”¯æ˜¯é“¶è¡Œçš„é‡‘åº“ï¼š
- ä¸æ˜¯æ‰€æœ‰äººéƒ½èƒ½éšæ„è¿›å…¥
- å¿…é¡»ç»è¿‡ä¸¥æ ¼çš„éªŒè¯ç¨‹åº
- éœ€è¦å¤šé‡å®‰å…¨æ£€æŸ¥
- æœ‰å®Œæ•´çš„æ“ä½œè®°å½•

åˆ†æ”¯ä¿æŠ¤è§„åˆ™ç±»å‹ï¼š
1. æ„å»ºçŠ¶æ€æ£€æŸ¥ - å¿…é¡»é€šè¿‡CI/CDæµç¨‹
2. ä»£ç å®¡æŸ¥è¦æ±‚ - å¿…é¡»æœ‰äººå®¡æŸ¥ä»£ç 
3. ç®¡ç†å‘˜æƒé™ - æŸäº›æ“ä½œéœ€è¦ç‰¹æ®Šæƒé™
4. ç­¾åéªŒè¯ - ç¡®ä¿æäº¤æ¥æºå¯ä¿¡
```

### 7.2 GitHubåˆ†æ”¯ä¿æŠ¤è®¾ç½®

ğŸ™ **é…ç½®GitHubä»“åº“çš„åˆ†æ”¯ä¿æŠ¤**

**GitHub Branch Protection Rulesï¼š**
```
ä¿æŠ¤è§„åˆ™é…ç½®è·¯å¾„ï¼š
GitHubä»“åº“ â†’ Settings â†’ Branches â†’ Add rule

Branch name pattern: master
â˜‘ Require a pull request before merging
  â˜‘ Require approvals (è‡³å°‘1ä¸ªå®¡æŸ¥è€…)
  â˜‘ Dismiss stale PR approvals when new commits are pushed
  â˜‘ Require review from code owners

â˜‘ Require status checks to pass before merging
  â˜‘ Require branches to be up to date before merging
  Status checks found in the last week:
  â˜‘ continuous-integration/jenkins/pr-head
  â˜‘ continuous-integration/jenkins/pr-merge

â˜‘ Require conversation resolution before merging
â˜‘ Require signed commits
â˜‘ Require linear history
â˜‘ Include administrators (ç®¡ç†å‘˜ä¹Ÿå—è§„åˆ™çº¦æŸ)
```

### 7.3 åˆå¹¶ç­–ç•¥é…ç½®

ğŸ”€ **é€‰æ‹©åˆé€‚çš„ä»£ç åˆå¹¶æ–¹å¼**

**åˆå¹¶ç­–ç•¥å¯¹æ¯”ï¼š**

| åˆå¹¶æ–¹å¼ | **ç‰¹ç‚¹** | **é€‚ç”¨åœºæ™¯** | **å†å²è®°å½•** |
|---------|---------|-------------|-------------|
| ğŸ”¸ **Merge commit** | `ä¿ç•™å®Œæ•´åˆ†æ”¯å†å²` | `é‡è¦åŠŸèƒ½å¼€å‘` | `å¤æ‚ä½†å®Œæ•´` |
| ğŸ”¸ **Squash and merge** | `å¤šä¸ªæäº¤åˆå¹¶ä¸ºä¸€ä¸ª` | `å°åŠŸèƒ½ä¿®å¤` | `ç®€æ´æ¸…æ™°` |
| ğŸ”¸ **Rebase and merge** | `çº¿æ€§å†å²è®°å½•` | `ä¿æŒå†å²æ•´æ´` | `ç®€æ´çº¿æ€§` |

```groovy
// Jenkinsfileä¸­å¤„ç†ä¸åŒåˆå¹¶ç­–ç•¥
pipeline {
    agent any
    
    stages {
        stage('Pre-merge Validation') {
            when {
                changeRequest()
            }
            steps {
                script {
                    // æ ¹æ®PRæ ‡ç­¾å†³å®šåˆå¹¶ç­–ç•¥
                    def prLabels = env.CHANGE_TITLE.toLowerCase()
                    
                    if (prLabels.contains('[squash]')) {
                        env.MERGE_STRATEGY = 'squash'
                        echo "ä½¿ç”¨Squashåˆå¹¶ç­–ç•¥"
                    } else if (prLabels.contains('[rebase]')) {
                        env.MERGE_STRATEGY = 'rebase'
                        echo "ä½¿ç”¨Rebaseåˆå¹¶ç­–ç•¥"
                    } else {
                        env.MERGE_STRATEGY = 'merge'
                        echo "ä½¿ç”¨æ ‡å‡†Mergeåˆå¹¶ç­–ç•¥"
                    }
                }
            }
        }
        
        stage('Merge Validation') {
            when {
                changeRequest()
            }
            steps {
                script {
                    // æ¨¡æ‹Ÿåˆå¹¶æµ‹è¯•
                    sh '''
                        git fetch origin ${CHANGE_TARGET}
                        git checkout origin/${CHANGE_TARGET}
                        git merge --no-commit --no-ff origin/${CHANGE_BRANCH}
                        
                        if [ $? -eq 0 ]; then
                            echo "âœ… åˆå¹¶æµ‹è¯•é€šè¿‡ï¼Œæ— å†²çª"
                            git merge --abort
                        else
                            echo "âŒ æ£€æµ‹åˆ°åˆå¹¶å†²çªï¼Œéœ€è¦è§£å†³"
                            exit 1
                        fi
                    '''
                }
            }
        }
    }
}
```

### 7.4 è‡ªåŠ¨åŒ–åˆå¹¶å·¥ä½œæµ

ğŸ¤– **é…ç½®è‡ªåŠ¨åˆå¹¶ç¬¦åˆæ¡ä»¶çš„PR**

```groovy
// è‡ªåŠ¨åˆå¹¶Pipeline
pipeline {
    agent any
    
    triggers {
        // ç›‘å¬PRçŠ¶æ€å˜åŒ–
        githubPullRequests events: [
            githubPRLabelAddedEvent(label: 'auto-merge'),
            githubPRReviewEvent()
        ]
    }
    
    stages {
        stage('Auto Merge Check') {
            when {
                changeRequest()
            }
            steps {
                script {
                    // æ£€æŸ¥è‡ªåŠ¨åˆå¹¶æ¡ä»¶
                    def canAutoMerge = true
                    def reasons = []
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰auto-mergeæ ‡ç­¾
                    if (!env.CHANGE_TITLE.contains('[auto-merge]')) {
                        canAutoMerge = false
                        reasons.add("ç¼ºå°‘auto-mergeæ ‡ç­¾")
                    }
                    
                    // æ£€æŸ¥CIçŠ¶æ€
                    def ciStatus = sh(
                        script: 'curl -s "https://api.github.com/repos/owner/repo/commits/${GIT_COMMIT}/status"',
                        returnStdout: true
                    )
                    
                    if (!ciStatus.contains('"state":"success"')) {
                        canAutoMerge = false
                        reasons.add("CIæ£€æŸ¥æœªé€šè¿‡")
                    }
                    
                    // æ£€æŸ¥å®¡æŸ¥çŠ¶æ€
                    def reviewStatus = sh(
                        script: 'gh pr view ${CHANGE_ID} --json reviewDecision',
                        returnStdout: true
                    )
                    
                    if (!reviewStatus.contains('"reviewDecision":"APPROVED"')) {
                        canAutoMerge = false
                        reasons.add("ä»£ç å®¡æŸ¥æœªé€šè¿‡")
                    }
                    
                    if (canAutoMerge) {
                        echo "âœ… æ»¡è¶³è‡ªåŠ¨åˆå¹¶æ¡ä»¶ï¼Œå¼€å§‹åˆå¹¶..."
                        sh "gh pr merge ${CHANGE_ID} --squash --delete-branch"
                        githubPRComment comment: 'ğŸ¤– è‡ªåŠ¨åˆå¹¶å®Œæˆï¼'
                    } else {
                        echo "âŒ ä¸æ»¡è¶³è‡ªåŠ¨åˆå¹¶æ¡ä»¶ï¼š"
                        reasons.each { echo "  - ${it}" }
                        githubPRComment comment: "â³ è‡ªåŠ¨åˆå¹¶æ¡ä»¶æœªæ»¡è¶³ï¼š${reasons.join(', ')}"
                    }
                }
            }
        }
    }
}
```

---

## 8. ğŸ§¹ è‡ªåŠ¨åˆ†æ”¯æ¸…ç†æœºåˆ¶


### 8.1 åˆ†æ”¯æ¸…ç†ç­–ç•¥

â™»ï¸ **è‡ªåŠ¨æ¸…ç†æ— ç”¨åˆ†æ”¯å’Œæ„å»ºè®°å½•**

```
ä¸ºä»€ä¹ˆéœ€è¦åˆ†æ”¯æ¸…ç†ï¼Ÿ
æƒ³è±¡Jenkinsæ˜¯ä¸€ä¸ªå·¥å‚çš„ä»“åº“ï¼š
- æ—§çš„äº§å“å ç”¨å‚¨å­˜ç©ºé—´
- è¿‡æœŸçš„åº“å­˜å½±å“æ•ˆç‡
- å®šæœŸæ¸…ç†ä¿æŒä»“åº“æ•´æ´
- é‡Šæ”¾èµ„æºç»™æ–°çš„ç”Ÿäº§ä»»åŠ¡

åˆ†æ”¯æ¸…ç†çš„å¥½å¤„ï¼š
1. èŠ‚çœå­˜å‚¨ç©ºé—´ - åˆ é™¤æ—§çš„æ„å»ºäº§ç‰©å’Œæ—¥å¿—
2. æé«˜æ€§èƒ½ - å‡å°‘Jenkinsæ‰«æçš„åˆ†æ”¯æ•°é‡
3. ç®€åŒ–ç®¡ç† - é¿å…åˆ†æ”¯åˆ—è¡¨è¿‡äºå¤æ‚
4. é™ä½ç»´æŠ¤æˆæœ¬ - è‡ªåŠ¨åŒ–æ¸…ç†å‡å°‘äººå·¥æ“ä½œ
```

### 8.2 Jenkinså†…ç½®æ¸…ç†é…ç½®

ğŸ”§ **é…ç½®Jenkinsçš„è‡ªåŠ¨æ¸…ç†è§„åˆ™**

**Orphaned Item Strategyé…ç½®ï¼š**
```
å¤šåˆ†æ”¯Pipelineé¡¹ç›®è®¾ç½®ï¼š

Orphaned Item Strategy:
â˜‘ Discard old items
Days to keep old items: 7
Max # of old items to keep: 20

è¯´æ˜ï¼š
- åˆ†æ”¯è¢«åˆ é™¤åï¼Œå¯¹åº”çš„Pipeline Jobä¼šä¿ç•™7å¤©
- æœ€å¤šä¿ç•™20ä¸ªå·²åˆ é™¤åˆ†æ”¯çš„Pipeline Job
- 7å¤©åè‡ªåŠ¨æ¸…ç†ï¼Œé‡Šæ”¾Jenkinså­˜å‚¨ç©ºé—´
```

**Build Historyæ¸…ç†ï¼š**
```
Build Record Settings:

Strategy: Log Rotation
Days to keep builds: 30      (ä¿ç•™30å¤©çš„æ„å»ºè®°å½•)
Max # of builds to keep: 100 (æœ€å¤šä¿ç•™100ä¸ªæ„å»º)

Strategy: Artifact Rotation  
Days to keep artifacts: 7    (ä¿ç•™7å¤©çš„æ„å»ºäº§ç‰©)
Max # of builds to keep artifacts: 10 (æœ€å¤š10ä¸ªæ„å»ºä¿ç•™äº§ç‰©)

é«˜çº§é€‰é¡¹ï¼š
â˜‘ Delete workspace when build is done (æ„å»ºå®Œæˆååˆ é™¤å·¥ä½œç©ºé—´)
â˜‘ Delete workspace before build starts (æ„å»ºå¼€å§‹å‰æ¸…ç†å·¥ä½œç©ºé—´)
```

### 8.3 Gitä»“åº“åˆ†æ”¯æ¸…ç†

ğŸŒ¿ **æ¸…ç†Gitä»“åº“ä¸­çš„é™ˆæ—§åˆ†æ”¯**

```bash
#!/bin/bash
# åˆ†æ”¯æ¸…ç†è„šæœ¬ï¼šcleanup-branches.sh

echo "å¼€å§‹æ¸…ç†Gitä»“åº“åˆ†æ”¯..."

# 1. æ›´æ–°è¿œç¨‹åˆ†æ”¯ä¿¡æ¯
git fetch --prune origin

# 2. åˆ—å‡ºå·²åˆå¹¶åˆ°masterçš„åˆ†æ”¯
merged_branches=$(git branch -r --merged origin/master | \
    grep -v 'origin/master' | \
    grep -v 'origin/develop' | \
    sed 's/origin\///')

if [ ! -z "$merged_branches" ]; then
    echo "å‘ç°ä»¥ä¸‹å·²åˆå¹¶çš„åˆ†æ”¯ï¼š"
    echo "$merged_branches"
    
    # 3. ç¡®è®¤æ˜¯å¦åˆ é™¤
    read -p "æ˜¯å¦åˆ é™¤è¿™äº›åˆ†æ”¯ï¼Ÿ(y/N): " confirm
    if [ "$confirm" = "y" ] || [ "$confirm" = "Y" ]; then
        for branch in $merged_branches; do
            echo "åˆ é™¤åˆ†æ”¯: $branch"
            git push origin --delete $branch
        done
    fi
else
    echo "æ²¡æœ‰å‘ç°éœ€è¦æ¸…ç†çš„å·²åˆå¹¶åˆ†æ”¯"
fi

# 4. æ¸…ç†æœ¬åœ°åˆ†æ”¯
echo "æ¸…ç†æœ¬åœ°è¿½è¸ªå·²åˆ é™¤è¿œç¨‹åˆ†æ”¯çš„æœ¬åœ°åˆ†æ”¯..."
git remote prune origin

# 5. åˆ—å‡ºè¶…è¿‡30å¤©æœªæ›´æ–°çš„åˆ†æ”¯
echo "æ£€æŸ¥é•¿æœŸæœªæ›´æ–°çš„åˆ†æ”¯..."
old_branches=$(git for-each-ref --format='%(refname:short) %(committerdate)' refs/remotes/origin | \
    awk '$2 < "'$(date -d '30 days ago' +%Y-%m-%d)'"' | \
    cut -d' ' -f1 | \
    sed 's/origin\///')

if [ ! -z "$old_branches" ]; then
    echo "å‘ç°ä»¥ä¸‹è¶…è¿‡30å¤©æœªæ›´æ–°çš„åˆ†æ”¯ï¼š"
    echo "$old_branches"
    echo "å»ºè®®æ‰‹åŠ¨æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ é™¤"
fi
```

### 8.4 è‡ªåŠ¨åŒ–æ¸…ç†Pipeline

ğŸ¤– **åˆ›å»ºä¸“é—¨çš„æ¸…ç†Pipeline**

```groovy
// æ¸…ç†Pipelineï¼šcleanup-pipeline.groovy
pipeline {
    agent any
    
    // æ¯å‘¨æ—¥å‡Œæ™¨2ç‚¹æ‰§è¡Œæ¸…ç†
    triggers {
        cron('0 2 * * 0')
    }
    
    parameters {
        choice(
            name: 'CLEANUP_TYPE',
            choices: ['dry-run', 'execute'],
            description: 'é€‰æ‹©æ¸…ç†ç±»å‹ï¼šdry-runï¼ˆé¢„è§ˆï¼‰æˆ–executeï¼ˆæ‰§è¡Œï¼‰'
        )
        string(
            name: 'DAYS_TO_KEEP',
            defaultValue: '30',
            description: 'ä¿ç•™å¤šå°‘å¤©å†…çš„åˆ†æ”¯'
        )
    }
    
    stages {
        stage('Preparation') {
            steps {
                script {
                    echo "å¼€å§‹åˆ†æ”¯æ¸…ç†ä»»åŠ¡"
                    echo "æ¸…ç†æ¨¡å¼: ${params.CLEANUP_TYPE}"
                    echo "ä¿ç•™å¤©æ•°: ${params.DAYS_TO_KEEP}"
                    
                    // è®¾ç½®Gité…ç½®
                    sh '''
                        git config --global user.name "Jenkins Cleanup Bot"
                        git config --global user.email "jenkins@company.com"
                    '''
                }
            }
        }
        
        stage('Scan Repositories') {
            steps {
                script {
                    // æ‰«ææ‰€æœ‰å¤šåˆ†æ”¯Pipelineé¡¹ç›®
                    def projects = Jenkins.instance.getAllItems(
                        org.jenkinsci.plugins.workflow.multibranch.WorkflowMultiBranchProject.class
                    )
                    
                    env.PROJECT_COUNT = projects.size().toString()
                    echo "å‘ç° ${env.PROJECT_COUNT} ä¸ªå¤šåˆ†æ”¯é¡¹ç›®"
                    
                    // ä¿å­˜é¡¹ç›®åˆ—è¡¨ä¾›åç»­ä½¿ç”¨
                    def projectNames = projects.collect { it.name }.join('\n')
                    writeFile file: 'projects.txt', text: projectNames
                }
            }
        }
        
        stage('Cleanup Analysis') {
            steps {
                script {
                    def projectNames = readFile('projects.txt').split('\n')
                    def cleanupReport = []
                    
                    projectNames.each { projectName ->
                        if (projectName.trim()) {
                            echo "åˆ†æé¡¹ç›®: ${projectName}"
                            
                            // è·å–é¡¹ç›®çš„Gitä»“åº“URL
                            def project = Jenkins.instance.getItem(projectName)
                            def gitUrl = getGitUrl(project)
                            
                            if (gitUrl) {
                                // å…‹éš†ä»“åº“å¹¶åˆ†æåˆ†æ”¯
                                sh """
                                    rm -rf temp_repo
                                    git clone ${gitUrl} temp_repo
                                    cd temp_repo
                                    
                                    # åˆ—å‡ºéœ€è¦æ¸…ç†çš„åˆ†æ”¯
                                    git for-each-ref --format='%(refname:short) %(committerdate)' refs/remotes/origin | \\
                                        awk '\$2 < "'$(date -d '${params.DAYS_TO_KEEP} days ago' +%Y-%m-%d)'"' > ../cleanup_${projectName}.txt
                                """
                                
                                def cleanupBranches = readFile("cleanup_${projectName}.txt")
                                if (cleanupBranches.trim()) {
                                    cleanupReport.add("${projectName}:\n${cleanupBranches}")
                                }
                            }
                        }
                    }
                    
                    // ç”Ÿæˆæ¸…ç†æŠ¥å‘Š
                    def reportContent = cleanupReport.join('\n\n')
                    writeFile file: 'cleanup_report.txt', text: reportContent
                    
                    if (reportContent) {
                        echo "æ¸…ç†æŠ¥å‘Š:"
                        echo reportContent
                    } else {
                        echo "æ²¡æœ‰å‘ç°éœ€è¦æ¸…ç†çš„åˆ†æ”¯"
                    }
                }
            }
        }
        
        stage('Execute Cleanup') {
            when {
                expression { params.CLEANUP_TYPE == 'execute' }
            }
            steps {
                script {
                    def reportContent = readFile('cleanup_report.txt')
                    if (reportContent.trim()) {
                        echo "å¼€å§‹æ‰§è¡Œåˆ†æ”¯æ¸…ç†..."
                        
                        // è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„æ¸…ç†é€»è¾‘
                        // æ³¨æ„ï¼šå®é™…ç¯å¢ƒä¸­éœ€è¦éå¸¸å°å¿ƒï¼Œå»ºè®®å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯
                        
                        echo "åˆ†æ”¯æ¸…ç†å®Œæˆ"
                        
                        // å‘é€æ¸…ç†æŠ¥å‘Šé‚®ä»¶
                        emailext (
                            subject: "Jenkinsåˆ†æ”¯æ¸…ç†æŠ¥å‘Š - ${new Date()}",
                            body: reportContent,
                            to: 'devops@company.com'
                        )
                    } else {
                        echo "æ²¡æœ‰éœ€è¦æ¸…ç†çš„åˆ†æ”¯ï¼Œè·³è¿‡æ¸…ç†æ­¥éª¤"
                    }
                }
            }
        }
    }
    
    post {
        always {
            // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            sh 'rm -rf temp_repo cleanup_*.txt projects.txt cleanup_report.txt'
        }
        success {
            echo "åˆ†æ”¯æ¸…ç†ä»»åŠ¡å®Œæˆ"
        }
        failure {
            echo "åˆ†æ”¯æ¸…ç†ä»»åŠ¡å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
        }
    }
}

// è¾…åŠ©å‡½æ•°ï¼šè·å–é¡¹ç›®çš„Git URL
def getGitUrl(project) {
    // è¿™ä¸ªå‡½æ•°éœ€è¦æ ¹æ®å®é™…çš„Jenkinsé…ç½®æ¥å®ç°
    // è¿”å›é¡¹ç›®å¯¹åº”çš„Gitä»“åº“URL
    return null
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å¤šåˆ†æ”¯Pipelineæœ¬è´¨ï¼šä¸€ä¸ªä»“åº“çš„æ¯ä¸ªåˆ†æ”¯éƒ½æœ‰è‡ªå·±çš„æ„å»ºæµæ°´çº¿
ğŸ”¸ è‡ªåŠ¨åŒ–åˆ†æ”¯ç®¡ç†ï¼šæ–°åˆ†æ”¯è‡ªåŠ¨åˆ›å»ºPipelineï¼Œåˆ é™¤åˆ†æ”¯è‡ªåŠ¨æ¸…ç†
ğŸ”¸ åˆ†æ”¯å‘ç°ç­–ç•¥ï¼šæ§åˆ¶å“ªäº›åˆ†æ”¯éœ€è¦æ„å»ºï¼Œå“ªäº›å¯ä»¥å¿½ç•¥
ğŸ”¸ æ„å»ºè§¦å‘æœºåˆ¶ï¼šä¸åŒåˆ†æ”¯å¯ä»¥æœ‰ä¸åŒçš„æ„å»ºé¢‘ç‡å’Œæ¡ä»¶
ğŸ”¸ PR/MRæ„å»ºï¼šåˆå¹¶å‰çš„è´¨é‡é—¨ï¼Œç¡®ä¿ä»£ç è´¨é‡
ğŸ”¸ åˆ†æ”¯ä¿æŠ¤è§„åˆ™ï¼šé˜²æ­¢ç ´åæ€§æ“ä½œï¼Œä¿æŠ¤é‡è¦åˆ†æ”¯
ğŸ”¸ åˆå¹¶ç­–ç•¥ï¼šé€‰æ‹©åˆé€‚çš„ä»£ç åˆå¹¶æ–¹å¼ä¿æŒå†å²æ•´æ´
ğŸ”¸ æ¸…ç†æœºåˆ¶ï¼šè‡ªåŠ¨æ¸…ç†æ— ç”¨åˆ†æ”¯å’Œæ„å»ºè®°å½•ï¼ŒèŠ‚çœèµ„æº
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å¤šåˆ†æ”¯Pipelineçš„æ ¸å¿ƒä»·å€¼**
```
å¼€å‘æ•ˆç‡æå‡ï¼š
- æ¯ä¸ªåŠŸèƒ½åˆ†æ”¯éƒ½æœ‰ç‹¬ç«‹çš„æ„å»ºéªŒè¯
- å¹¶è¡Œå¼€å‘ä¸ç›¸äº’å¹²æ‰°
- è‡ªåŠ¨åŒ–å‡å°‘æ‰‹åŠ¨é…ç½®å·¥ä½œ

ä»£ç è´¨é‡ä¿è¯ï¼š
- PR/MRæ„å»ºç¡®ä¿åˆå¹¶å‰ä»£ç è´¨é‡
- åˆ†æ”¯ä¿æŠ¤è§„åˆ™é˜²æ­¢æœ‰é—®é¢˜çš„ä»£ç è¿›å…¥ä¸»åˆ†æ”¯
- è‡ªåŠ¨åŒ–æµ‹è¯•è¦†ç›–æ‰€æœ‰åˆ†æ”¯

å›¢é˜Ÿåä½œä¼˜åŒ–ï¼š
- æ¸…æ™°çš„åˆ†æ”¯æ„å»ºçŠ¶æ€
- æ ‡å‡†åŒ–çš„ä»£ç åˆå¹¶æµç¨‹
- è‡ªåŠ¨åŒ–çš„åˆ†æ”¯ç”Ÿå‘½å‘¨æœŸç®¡ç†
```

**ğŸ”¹ åˆ†æ”¯ç­–ç•¥çš„è®¾è®¡åŸåˆ™**
```
åˆ†å±‚ä¿æŠ¤ç­–ç•¥ï¼š
- ä¸»åˆ†æ”¯ï¼šæœ€ä¸¥æ ¼çš„ä¿æŠ¤å’Œå®Œæ•´çš„æµ‹è¯•
- å¼€å‘åˆ†æ”¯ï¼šå¹³è¡¡é€Ÿåº¦å’Œè´¨é‡
- åŠŸèƒ½åˆ†æ”¯ï¼šå¿«é€Ÿåé¦ˆï¼ŒåŸºç¡€éªŒè¯

èµ„æºä¼˜åŒ–åŸåˆ™ï¼š
- é‡è¦åˆ†æ”¯ä¼˜å…ˆåˆ†é…èµ„æº
- å¹¶å‘æ§åˆ¶é¿å…èµ„æºç«äº‰
- å®šæœŸæ¸…ç†é‡Šæ”¾å­˜å‚¨ç©ºé—´

å®‰å…¨æ€§è€ƒè™‘ï¼š
- PRæ„å»ºçš„Trustç­–ç•¥
- åˆ†æ”¯ä¿æŠ¤è§„åˆ™çš„åˆç†é…ç½®
- æ•æ„Ÿæ“ä½œçš„æƒé™æ§åˆ¶
```

**ğŸ”¹ PR/MRæ„å»ºçš„æœ€ä½³å®è·µ**
```
æ„å»ºç­–ç•¥ï¼š
- åˆå¹¶å‰å¿…é¡»é€šè¿‡æ‰€æœ‰æ£€æŸ¥
- ä»£ç å®¡æŸ¥å’Œè‡ªåŠ¨åŒ–æµ‹è¯•å¹¶é‡
- æ™ºèƒ½åŒ–çš„å˜æ›´æ£€æµ‹å’Œæ„å»º

è´¨é‡é—¨è®¾ç½®ï¼š
- ä»£ç è¦†ç›–ç‡è¦æ±‚
- é™æ€ä»£ç åˆ†æé€šè¿‡
- å®‰å…¨æ¼æ´æ‰«ææ¸…æ´

åé¦ˆæœºåˆ¶ï¼š
- åŠæ—¶çš„æ„å»ºçŠ¶æ€é€šçŸ¥
- è¯¦ç»†çš„å¤±è´¥åŸå› è¯´æ˜
- è‡ªåŠ¨åŒ–çš„è¯„è®ºå’Œæ ‡ç­¾
```

### 9.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¼ä¸šçº§åº”ç”¨åœºæ™¯**
- **æ•æ·å¼€å‘å›¢é˜Ÿ**ï¼šæ”¯æŒå¿«é€Ÿè¿­ä»£å’Œå¹¶è¡ŒåŠŸèƒ½å¼€å‘
- **å¼€æºé¡¹ç›®**ï¼šç®¡ç†ä¼—å¤šè´¡çŒ®è€…çš„PRï¼Œä¿è¯ä»£ç è´¨é‡
- **å¾®æœåŠ¡æ¶æ„**ï¼šæ¯ä¸ªæœåŠ¡çš„å¤šä¸ªåˆ†æ”¯ç‹¬ç«‹æ„å»ºå’Œéƒ¨ç½²
- **å¤§å‹äº§å“**ï¼šå¤æ‚çš„åˆ†æ”¯ç­–ç•¥å’Œå‘å¸ƒæµç¨‹ç®¡ç†

**ğŸ”§ è¿ç»´å®è·µå»ºè®®**
- **åˆ†æ­¥å®æ–½**ï¼šä»ç®€å•çš„å•åˆ†æ”¯å¼€å§‹ï¼Œé€æ­¥å¢åŠ å¤æ‚åº¦
- **ç›‘æ§ä¼˜åŒ–**ï¼šå®šæœŸæ£€æŸ¥æ„å»ºèµ„æºä½¿ç”¨æƒ…å†µï¼Œä¼˜åŒ–é…ç½®
- **å›¢é˜ŸåŸ¹è®­**ï¼šç¡®ä¿å›¢é˜Ÿç†è§£åˆ†æ”¯ç­–ç•¥å’Œæ“ä½œæµç¨‹
- **æ–‡æ¡£ç»´æŠ¤**ï¼šè®°å½•åˆ†æ”¯å‘½åè§„èŒƒå’Œæ„å»ºæµç¨‹

**ğŸ“ˆ æŠ€æœ¯å‘å±•è¶‹åŠ¿**
- **AIè¾…åŠ©**ï¼šæ™ºèƒ½åˆ†æä»£ç å˜æ›´ï¼Œä¼˜åŒ–æ„å»ºç­–ç•¥
- **äº‘åŸç”Ÿ**ï¼šå®¹å™¨åŒ–æ„å»ºç¯å¢ƒï¼Œå¼¹æ€§èµ„æºåˆ†é…
- **å®‰å…¨é›†æˆ**ï¼šå†…ç½®çš„å®‰å…¨æ‰«æå’Œåˆè§„æ£€æŸ¥
- **å¯è§†åŒ–å¢å¼º**ï¼šæ›´ç›´è§‚çš„åˆ†æ”¯æ„å»ºçŠ¶æ€å±•ç¤º

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- å¤šåˆ†æ”¯Pipelineè‡ªåŠ¨ç®¡ï¼Œæ¯ä¸ªåˆ†æ”¯ç‹¬ç«‹å»º
- å‘ç°ç­–ç•¥æ§åˆ†æ”¯ï¼Œæ„å»ºè§¦å‘æœ‰è§„å¾‹
- PRæ„å»ºè´¨é‡é—¨ï¼Œåˆå¹¶ä¹‹å‰å…ˆéªŒè¯
- ä¿æŠ¤è§„åˆ™å®ˆé‡è¦ï¼Œæ¸…ç†æœºåˆ¶çœèµ„æº