---
title: 26、Jenkins性能优化
---
## 📚 目录

1. [Jenkins性能基础概念](#1-Jenkins性能基础概念)
2. [JVM内存配置优化](#2-JVM内存配置优化)
3. [构建并发数控制](#3-构建并发数控制)
4. [磁盘I/O优化](#4-磁盘IO优化)
5. [网络连接优化](#5-网络连接优化)
6. [插件性能影响分析](#6-插件性能影响分析)
7. [数据库性能调优](#7-数据库性能调优)
8. [缓存机制使用](#8-缓存机制使用)
9. [资源使用监控](#9-资源使用监控)
10. [常见故障处理](#10-常见故障处理)
11. [核心要点总结](#11-核心要点总结)

---

## 1. 🚀 Jenkins性能基础概念


### 1.1 什么是Jenkins性能优化


**简单理解**：就像你给汽车调试发动机、清理积碳、换好机油让车跑得更快更稳一样，Jenkins性能优化就是让你的CI/CD流水线跑得更快、更稳定、更省资源。

**核心目标**：
```
🎯 构建速度更快    ← 减少等待时间，提高开发效率
🎯 系统更稳定      ← 避免卡死、崩溃等问题
🎯 资源消耗更少    ← 节省服务器成本
🎯 并发能力更强    ← 支持更多团队同时使用
```

### 1.2 性能问题的典型表现


**常见的"慢"现象**：
```
构建启动慢：点击构建后要等很久才开始
构建执行慢：代码编译、测试、部署时间过长
页面响应慢：打开Jenkins界面卡顿
任务排队长：多个构建任务排长队等待
系统卡死：Jenkins偶尔无响应需要重启
```

**性能瓶颈的根源**：
- **内存不足**：就像电脑内存小了会卡一样
- **CPU过载**：同时处理太多任务超出能力
- **磁盘读写慢**：存储设备跟不上需求
- **网络延迟**：下载依赖、传输文件慢
- **配置不当**：设置不合理导致资源浪费

---

## 2. 💾 JVM内存配置优化


### 2.1 理解JVM内存模型


**简单比喻**：把JVM想象成一个工厂，内存就是工厂里的不同车间：

```
JVM内存结构示意：
┌─────────────────────────────────────┐
│            JVM 总内存               │
├─────────────────┬───────────────────┤
│   堆内存(Heap)   │  非堆内存(Non-Heap) │
│                │                   │
│ ┌─────────────┐ │ ┌───────────────┐ │
│ │  新生代     │ │ │   方法区      │ │
│ │ (Young Gen) │ │ │ (Method Area) │ │
│ └─────────────┘ │ └───────────────┘ │
│ ┌─────────────┐ │ ┌───────────────┐ │
│ │  老年代     │ │ │   直接内存    │ │
│ │ (Old Gen)   │ │ │ (Direct Mem)  │ │
│ └─────────────┘ │ └───────────────┘ │
└─────────────────┴───────────────────┘
```

**各部分的作用**：
- **新生代**：新创建的对象住这里，就像新员工宿舍
- **老年代**：长期使用的对象住这里，就像老员工宿舍  
- **方法区**：存放类信息和常量，就像公司的档案室
- **直接内存**：高效的缓存空间，就像快递中转站

### 2.2 Jenkins内存配置实战


**🔧 基础内存配置**

Linux系统下的配置方式：
```bash
# 编辑Jenkins启动配置文件
sudo vim /etc/default/jenkins

# 添加或修改内存配置
JAVA_ARGS="-Xms2g -Xmx4g -XX:MaxPermSize=512m"
```

**各参数的含义**：
- `Xms2g`：启动时分配2GB内存（就像预订房间）
- `Xmx4g`：最大可用4GB内存（房间最大容量）
- `MaxPermSize=512m`：方法区最大512MB（档案室大小）

**💡 内存大小选择建议**：

| 团队规模 | 项目数量 | 推荐配置 | 说明 |
|---------|---------|---------|------|
| 小团队 | 1-10个项目 | `-Xms1g -Xmx2g` | 够用就行，不浪费 |
| 中团队 | 10-50个项目 | `-Xms2g -Xmx4g` | 平衡性能和成本 |
| 大团队 | 50+个项目 | `-Xms4g -Xmx8g` | 确保高并发稳定 |

### 2.3 垃圾回收优化


**什么是垃圾回收**：就像定期清理房间，把不用的东西扔掉，释放空间给新东西。

**推荐的GC配置**：
```bash
# G1垃圾回收器 - 适合大内存场景
JAVA_ARGS="-Xms4g -Xmx8g 
           -XX:+UseG1GC 
           -XX:MaxGCPauseMillis=100
           -XX:G1HeapRegionSize=16m"
```

**参数解释**：
- `UseG1GC`：使用G1垃圾回收器（比较智能的清洁工）
- `MaxGCPauseMillis=100`：每次清理暂停不超过100毫秒
- `G1HeapRegionSize=16m`：把内存分成16MB的小块管理

---

## 3. ⚡ 构建并发数控制


### 3.1 理解并发构建


**生活化比喻**：想象Jenkins是一个洗车店，并发数就是同时工作的洗车工人数量。工人太少，车排长队；工人太多，互相干扰效率反而低。

**并发数设置原理**：
```
服务器状况评估：
┌─────────────────┐
│   CPU: 8核心    │ → 建议并发数: 4-6
├─────────────────┤
│   内存: 16GB    │ → 每个构建约需: 1-2GB
├─────────────────┤
│   磁盘: SSD     │ → 可支持更高并发
└─────────────────┘

计算公式：
最优并发数 = CPU核心数 × 0.5~0.75
```

### 3.2 配置并发数


**🔧 在Jenkins中设置**：

1. **全局并发数设置**：
   - 进入 `系统管理` → `系统配置`
   - 找到 `执行器数量` 设置
   - 建议值：CPU核心数的一半

2. **节点级并发数**：
```
主节点建议：
- 仅做调度：并发数 = 1-2
- 混合使用：并发数 = CPU核心数 × 0.3

从节点建议：
- 专门构建：并发数 = CPU核心数 × 0.7
- 资源充足：可适当增加
```

### 3.3 动态并发调整策略


**📊 根据负载动态调整**：

```
监控指标判断：
CPU使用率 < 60%  → 可以增加并发数
CPU使用率 > 80%  → 应该减少并发数
内存使用率 > 85% → 立即减少并发数
构建排队 > 5个   → 考虑增加节点或并发数
```

**⚠️ 并发数设置注意事项**：
- 不是越多越好，要根据实际资源情况
- 构建类型不同，资源需求也不同
- 定期检查和调整，不要设置后不管

---

## 4. 💿 磁盘I/O优化


### 4.1 磁盘I/O瓶颈识别


**什么是磁盘I/O**：简单说就是读写硬盘的速度。就像你翻书找资料，如果书很厚、字很小，找起来就慢。

**常见的磁盘瓶颈表现**：
```
🐌 构建日志写入慢
🐌 代码检出时间长
🐌 编译产物存储慢
🐌 工作空间清理耗时
🐌 插件安装更新慢
```

### 4.2 磁盘优化策略


**💾 存储设备选择**：

| 存储类型 | 读写速度 | 适用场景 | 成本 |
|---------|---------|---------|------|
| 机械硬盘(HDD) | 100-200 MB/s | 大容量存储 | 低 |
| 固态硬盘(SSD) | 500-600 MB/s | 系统和工作空间 | 中 |
| NVMe SSD | 2000+ MB/s | 高性能需求 | 高 |

**🎯 推荐的存储架构**：
```
Jenkins存储布局：
┌─────────────────────────────────┐
│         NVMe SSD (系统盘)        │
├─────────────────────────────────┤
│ • Jenkins程序文件               │
│ • JVM和操作系统                 │
│ • 临时文件和缓存                │
└─────────────────────────────────┘
┌─────────────────────────────────┐
│         SATA SSD (工作盘)       │
├─────────────────────────────────┤
│ • 工作空间 (workspace)          │
│ • 构建产物                      │
│ • 插件数据                      │
└─────────────────────────────────┘
┌─────────────────────────────────┐
│         大容量HDD (存档盘)       │
├─────────────────────────────────┤
│ • 构建历史存档                  │
│ • 长期日志存储                  │
│ • 备份文件                      │
└─────────────────────────────────┘
```

### 4.3 文件系统优化


**🔧 工作空间管理**：

定期清理策略：
```bash
# 设置工作空间自动清理
# 在Pipeline中添加
pipeline {
    agent any
    options {
        // 只保留最近10次构建的工作空间
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }
    post {
        always {
            // 构建后清理工作空间
            cleanWs()
        }
    }
}
```

**📁 目录结构优化**：
- 将`JENKINS_HOME`放在SSD上
- 大型构建产物单独存储
- 定期归档老旧数据
- 使用软链接分离热点数据

---

## 5. 🌐 网络连接优化


### 5.1 网络性能问题识别


**网络慢的典型表现**：
```
🐌 代码下载慢    ← Git clone/pull耗时长
🐌 依赖下载慢    ← Maven/npm包下载超时
🐌 镜像拉取慢    ← Docker镜像下载失败
🐌 部署上传慢    ← 构建产物传输耗时
🐌 插件安装慢    ← Jenkins插件更新超时
```

### 5.2 网络优化实战


**🔧 配置国内镜像源**：

Maven配置优化：
```xml
<!-- 在settings.xml中配置阿里云镜像 -->
<mirrors>
    <mirror>
        <id>aliyun-maven</id>
        <name>阿里云公共仓库</name>
        <url>https://maven.aliyun.com/repository/public</url>
        <mirrorOf>central</mirrorOf>
    </mirror>
</mirrors>
```

npm配置优化：
```bash
# 设置淘宝镜像源
npm config set registry https://registry.npmmirror.com/

# 在Jenkins构建脚本中使用
npm install --registry=https://registry.npmmirror.com/
```

**🐳 Docker镜像优化**：
```bash
# 配置Docker镜像加速器
sudo vim /etc/docker/daemon.json

{
    "registry-mirrors": [
        "https://docker.mirrors.ustc.edu.cn",
        "https://hub-mirror.c.163.com"
    ]
}
```

### 5.3 网络连接池优化


**HTTP连接池配置**：
```groovy
// 在Jenkins系统脚本中配置
System.setProperty("http.maxConnections", "50")
System.setProperty("http.maxConnectionsPerDestination", "10")
System.setProperty("http.connectionTimeout", "30000")
System.setProperty("http.readTimeout", "60000")
```

**Git连接优化**：
```bash
# 全局Git配置优化
git config --global http.postBuffer 524288000
git config --global http.lowSpeedLimit 0
git config --global http.lowSpeedTime 999999
```

---

## 6. 🔌 插件性能影响分析


### 6.1 插件对性能的影响


**插件就像手机上的APP**：装得太多会让手机变慢，Jenkins也是如此。

**插件影响性能的方式**：
```
启动阶段：
插件多 → 启动时间长 → Jenkins重启慢

运行阶段：
后台任务多 → CPU占用高 → 页面响应慢

构建阶段：
功能复杂 → 内存消耗大 → 构建变慢
```

### 6.2 插件性能评估


**🔍 识别问题插件**：

通过监控页面查看：
```
访问路径：
系统管理 → 系统信息 → 线程转储

关注指标：
- CPU使用率高的线程
- 长时间运行的任务
- 内存占用异常的进程
```

**📊 常见高耗能插件类型**：

| 插件类型 | 性能影响 | 优化建议 |
|---------|---------|---------|
| 代码扫描类 | CPU密集 | 限制扫描范围，异步执行 |
| 测试报告类 | 内存密集 | 控制报告大小，及时清理 |
| 通知类 | 网络密集 | 批量发送，错误重试 |
| 监控类 | 持续后台运行 | 调整监控频率 |

### 6.3 插件优化策略


**🎯 插件精简原则**：
```
✅ 保留核心功能插件
✅ 删除重复功能插件  
✅ 禁用不常用插件
✅ 定期评估插件使用情况
```

**⚙️ 插件配置优化**：
- 调整插件执行频率
- 限制插件资源使用
- 配置插件缓存策略
- 启用插件异步执行

---

## 7. 🗄️ 数据库性能调优


### 7.1 Jenkins数据存储机制


**Jenkins的"记忆方式"**：Jenkins主要用文件存储数据，但也会用到一些轻量级数据库。

```
Jenkins数据存储架构：
┌─────────────────────────────────┐
│           JENKINS_HOME          │
├─────────────────────────────────┤
│ jobs/           ← 任务配置文件  │
│ builds/         ← 构建历史记录  │
│ plugins/        ← 插件数据      │
│ users/          ← 用户信息      │
│ config.xml      ← 全局配置      │
│ queue.xml       ← 构建队列      │
└─────────────────────────────────┘
```

### 7.2 文件系统优化


**🗂️ 数据清理策略**：

自动清理配置：
```groovy
// 全局构建保留策略
properties([
    buildDiscarder(
        logRotator(
            numToKeepStr: '30',        // 保留30次构建
            daysToKeepStr: '7',        // 保留7天
            artifactNumToKeepStr: '10', // 保留10个构建产物
            artifactDaysToKeepStr: '3'  // 构建产物保留3天
        )
    )
])
```

**📁 大文件处理**：
- 构建日志超过10MB时压缩存储
- 构建产物超过100MB时移至外部存储
- 定期归档6个月以上的历史数据

### 7.3 外部数据库集成


**🔧 使用外部数据库的场景**：
```
何时需要外部数据库：
- 团队规模 > 100人
- 任务数量 > 1000个
- 构建历史需要复杂查询
- 需要高可用架构
```

MySQL配置示例：
```sql
-- 创建Jenkins数据库
CREATE DATABASE jenkins_db CHARACTER SET utf8mb4;

-- 优化MySQL配置
-- 在my.cnf中添加
[mysqld]
innodb_buffer_pool_size = 2G
innodb_log_file_size = 256M
max_connections = 200
```

---

## 8. 🚀 缓存机制使用


### 8.1 缓存的作用原理


**缓存就像你的书桌**：常用的东西放在手边，用的时候不用跑到书柜去找，大大提高效率。

```
Jenkins缓存层次：
┌─────────────────────────────────┐
│        浏览器缓存(最快)          │ ← 静态资源
├─────────────────────────────────┤
│        应用缓存(很快)           │ ← 页面数据
├─────────────────────────────────┤
│        构建缓存(快)             │ ← 依赖包
├─────────────────────────────────┤
│        磁盘缓存(中等)           │ ← 临时文件
└─────────────────────────────────┘
```

### 8.2 构建缓存配置


**🔧 Maven依赖缓存**：
```xml
<!-- 在Pipeline中配置本地仓库缓存 -->
pipeline {
    agent any
    tools {
        maven 'Maven-3.8'
    }
    stages {
        stage('Build') {
            steps {
                // 使用本地缓存的Maven仓库
                sh 'mvn clean compile -Dmaven.repo.local=./m2-cache'
            }
        }
    }
}
```

**📦 Node.js依赖缓存**：
```bash
# 在构建脚本中配置npm缓存
export NPM_CONFIG_CACHE=/var/jenkins_home/npm-cache
npm ci --cache /var/jenkins_home/npm-cache
```

### 8.3 Docker构建缓存


**🐳 镜像层缓存优化**：
```dockerfile
# 优化Dockerfile缓存效率
FROM node:16-alpine

# 先复制依赖文件（变化少，缓存命中率高）
COPY package*.json ./
RUN npm ci --only=production

# 再复制源代码（变化多，但不影响上层缓存）
COPY . .
RUN npm run build
```

**💡 缓存使用技巧**：
- 频繁变化的文件放在后面复制
- 依赖安装和代码构建分层进行
- 使用`.dockerignore`减少上下文大小

---

## 9. 📊 资源使用监控


### 9.1 监控指标体系


**核心监控维度**：
```
系统资源监控：
├─ CPU使用率      ← 处理能力监控
├─ 内存使用率     ← 存储资源监控  
├─ 磁盘I/O       ← 读写性能监控
├─ 网络带宽      ← 传输能力监控
└─ 磁盘空间      ← 存储容量监控

Jenkins业务监控：
├─ 构建队列长度   ← 任务积压情况
├─ 构建成功率     ← 稳定性指标
├─ 构建平均耗时   ← 效率指标
├─ 并发构建数量   ← 负载指标
└─ 插件运行状态   ← 组件健康度
```

### 9.2 监控工具配置


**🔧 Jenkins内置监控**：

安装监控插件：
```
推荐插件组合：
- Monitoring Plugin     ← 系统资源监控
- Build Time Trend     ← 构建时间趋势
- Performance Plugin   ← 性能测试结果
- Disk Usage Plugin    ← 磁盘使用情况
```

**📈 外部监控集成**：

Prometheus + Grafana配置：
```yaml
# prometheus.yml配置
scrape_configs:
  - job_name: 'jenkins'
    static_configs:
      - targets: ['jenkins:8080']
    metrics_path: '/prometheus'
    scrape_interval: 30s
```

### 9.3 告警机制设置


**⚠️ 关键告警规则**：

| 监控项 | 告警阈值 | 紧急程度 | 处理建议 |
|-------|---------|---------|---------|
| CPU使用率 | >85% 持续5分钟 | 高 | 增加节点或减少并发 |
| 内存使用率 | >90% | 紧急 | 立即重启或扩容 |
| 磁盘空间 | >90% | 高 | 清理文件或扩容 |
| 构建队列 | >10个任务等待 | 中 | 检查节点状态 |
| 构建失败率 | >20% | 中 | 检查环境配置 |

**📱 告警通知配置**：
```groovy
// 在Pipeline中配置告警
post {
    failure {
        emailext (
            subject: "构建失败告警: ${env.JOB_NAME} - ${env.BUILD_NUMBER}",
            body: "构建失败，请及时处理！",
            to: "devops@company.com"
        )
    }
}
```

---

## 10. 🔧 常见故障处理


### 10.1 内存不足问题


**故障现象**：
```
💥 Jenkins页面加载缓慢或超时
💥 构建过程中出现OutOfMemoryError
💥 系统自动重启或崩溃
💥 插件功能异常或无响应
```

**🔍 诊断方法**：
```bash
# 查看Java进程内存使用
jstat -gc [jenkins_pid] 250 4

# 生成内存转储文件
jmap -dump:live,format=b,file=jenkins_heap.hprof [jenkins_pid]

# 分析GC日志
-XX:+PrintGC -XX:+PrintGCDetails -Xloggc:gc.log
```

**💊 解决方案**：
1. **增加堆内存**：`-Xmx4g` → `-Xmx8g`
2. **优化GC参数**：使用G1收集器
3. **清理历史数据**：删除老旧构建记录
4. **禁用非必要插件**：减少内存占用

### 10.2 构建排队问题


**问题表现**：
```
🚫 构建任务长时间排队等待
🚫 执行器显示忙碌但无实际任务
🚫 节点离线或标记为暂时离线
🚫 构建卡在特定步骤无法继续
```

**🔍 排查步骤**：
```
1. 检查执行器状态
   系统管理 → 管理节点 → 查看各节点状态

2. 查看构建队列
   Jenkins首页左侧 → 构建队列 → 分析等待原因

3. 检查节点标签
   确认任务标签与节点标签匹配

4. 查看系统日志
   系统管理 → 系统日志 → 搜索相关错误
```

**💊 解决方案**：
- 增加执行器数量或添加新节点
- 重启僵死的构建任务
- 检查并修复节点连接问题
- 优化任务标签分配策略

### 10.3 磁盘空间不足


**故障征象**：
```
💿 构建失败，提示磁盘空间不足
💿 无法保存构建产物
💿 日志文件写入异常
💿 插件安装或更新失败
```

**🧹 清理策略**：
```bash
# 清理Jenkins工作空间
find $JENKINS_HOME/workspace -type d -mtime +7 -exec rm -rf {} \;

# 清理旧的构建记录
find $JENKINS_HOME/jobs/*/builds -type d -mtime +30 -exec rm -rf {} \;

# 清理临时文件
find /tmp -name "jenkins*" -mtime +1 -delete

# 压缩大日志文件
find $JENKINS_HOME -name "*.log" -size +100M -exec gzip {} \;
```

---

## 11. 📋 核心要点总结


### 11.1 性能优化核心原则


```
🎯 性能优化的"四个维度"：
├─ 硬件资源     ← CPU、内存、磁盘、网络
├─ 软件配置     ← JVM参数、并发数、缓存
├─ 架构设计     ← 分布式、负载均衡、高可用
└─ 运维管理     ← 监控、告警、故障处理
```

### 11.2 优化实施步骤


**📈 渐进式优化路径**：
```
第一阶段：基础优化 (立竿见影)
✅ 调整JVM内存参数
✅ 设置合理的并发数
✅ 清理历史数据和无用插件
✅ 配置国内镜像源

第二阶段：深度优化 (中期收益)  
✅ 部署分布式节点
✅ 配置构建缓存
✅ 优化存储架构
✅ 建立监控体系

第三阶段：架构优化 (长期稳定)
✅ 高可用集群部署
✅ 自动扩缩容
✅ 智能负载均衡
✅ 持续性能调优
```

### 11.3 关键配置参考


**💡 推荐配置模板**：

```bash
# JVM优化配置 (8GB内存服务器)
JAVA_ARGS="-Xms4g -Xmx6g 
           -XX:+UseG1GC 
           -XX:MaxGCPauseMillis=100 
           -XX:+PrintGCDetails 
           -Xloggc:gc.log"

# 系统参数优化
echo "vm.swappiness=1" >> /etc/sysctl.conf
echo "fs.file-max=1000000" >> /etc/sysctl.conf

# 并发数配置原则
执行器数量 = CPU核心数 × 0.5~0.75

# 磁盘清理策略  
构建保留策略：30天或50次构建
工作空间清理：每次构建后自动清理
日志归档：7天后压缩，30天后删除
```

### 11.4 性能监控指标


**📊 关键性能指标 (KPI)**：

| 指标类别 | 关键指标 | 目标值 | 监控频率 |
|---------|---------|--------|---------|
| 系统性能 | CPU使用率 | <70% | 实时 |
| 系统性能 | 内存使用率 | <80% | 实时 |
| 业务性能 | 构建平均耗时 | <10分钟 | 每日 |
| 业务性能 | 构建成功率 | >95% | 每日 |
| 资源效率 | 队列等待时间 | <2分钟 | 实时 |

### 11.5 故障应对手册


**🚨 快速故障处理清单**：

```
服务无响应：
□ 检查进程状态 (ps aux | grep jenkins)
□ 查看内存使用 (free -h)  
□ 重启Jenkins服务
□ 检查日志文件

构建异常缓慢：
□ 查看当前构建队列
□ 检查节点资源使用情况
□ 分析构建日志错误信息
□ 临时增加构建节点

磁盘空间告警：
□ 立即清理工作空间
□ 删除过期构建记录
□ 压缩或移动大文件
□ 检查日志轮转配置
```

**核心记忆要点**：
- **性能优化是个系统工程**：硬件、软件、配置、运维缺一不可
- **监控是优化的前提**：没有监控数据就是盲人摸象  
- **渐进式优化最有效**：一步步来，每次解决最突出的问题
- **预防胜过治疗**：建立完善的监控告警比事后处理更重要
- **定期维护很关键**：性能优化不是一次性工作，需要持续关注