---
title: 14、Docker Swarm配置文件
---
## 📚 目录

1. [Docker Swarm配置概述](#1-docker-swarm配置概述)
2. [daemon.json中的Swarm配置](#2-daemonjson中的swarm配置)
3. [集群存储与发现配置](#3-集群存储与发现配置)
4. [Swarm模式核心配置](#4-swarm模式核心配置)
5. [节点与资源管理配置](#5-节点与资源管理配置)
6. [性能与监控配置](#6-性能与监控配置)
7. [实战配置示例](#7-实战配置示例)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🐳 Docker Swarm配置概述


### 1.1 什么是Docker Swarm


**简单理解**：Docker Swarm就像是把多台电脑组成一个"超级电脑团队"
```
单机Docker：        Docker Swarm集群：
   电脑A                 电脑A ←→ 电脑B
   运行容器               ↑        ↓
                       电脑C ←→ 电脑D
                      所有电脑协同工作

好处：容错性强、资源共享、自动负载均衡
```

**💡 核心作用**：
- **集群管理**：把多台Docker主机组织成一个集群
- **服务编排**：自动在集群中部署和管理容器
- **负载均衡**：智能分配工作负载到不同节点
- **高可用性**：某台机器挂了，服务还能继续运行

### 1.2 Swarm配置文件的位置


**主要配置文件**：`/etc/docker/daemon.json`
```
Docker配置文件结构：
/etc/docker/
├── daemon.json      ← 🎯 主配置文件（我们重点关注）
├── key.json         ← 密钥文件
└── certs.d/         ← 证书目录
```

> 💡 **新手提示**：daemon.json就是Docker守护进程的"设置面板"，所有重要配置都在这里

---

## 2. ⚙️ daemon.json中的Swarm配置


### 2.1 基础配置结构


**配置文件基本格式**：
```json
{
  "swarm-default-advertise-addr": "192.168.1.100",
  "cluster-store": "etcd://192.168.1.10:2379",
  "cluster-store-opts": {
    "discovery.heartbeat": 10,
    "discovery.ttl": 20
  },
  "cluster-advertise": "192.168.1.100:2376"
}
```

### 2.2 swarm-default-advertise-addr：默认广告地址


**🔸 作用说明**：告诉其他节点"我在哪里，怎么联系我"

```json
{
  "swarm-default-advertise-addr": "192.168.1.100"
}
```

**通俗解释**：
- 就像留电话号码一样，其他Docker节点通过这个地址找到你
- 通常使用本机的内网IP地址
- **注意**：不要用127.0.0.1（本地回环），其他机器访问不到

**实际应用场景**：
```
场景：公司内网搭建Docker集群
机器A：192.168.1.100  ← 管理节点
机器B：192.168.1.101  ← 工作节点  
机器C：192.168.1.102  ← 工作节点

机器A的配置：
"swarm-default-advertise-addr": "192.168.1.100"
```

### 2.3 cluster-store：集群存储后端


**🔸 作用说明**：为集群提供"共享记忆"，存储集群状态信息

```json
{
  "cluster-store": "etcd://192.168.1.10:2379"
}
```

**通俗解释**：
- 想象集群是一个团队，需要一个"公告板"记录谁在做什么
- 常用存储后端：`etcd`、`consul`、`zookeeper`
- **etcd**是最常用的，轻量且可靠

**支持的存储类型**：
```
etcd://IP:PORT        ← 🌟 推荐使用
consul://IP:PORT      ← 也很不错
zk://IP:PORT          ← ZooKeeper
```

**⚠️ 重要提醒**：生产环境建议部署高可用的etcd集群

### 2.4 cluster-store-opts：集群存储选项


**🔸 作用说明**：微调存储后端的工作参数

```json
{
  "cluster-store-opts": {
    "discovery.heartbeat": 10,
    "discovery.ttl": 20,
    "kv.path": "/docker/cluster"
  }
}
```

**常用选项详解**：

| 选项 | **含义** | **默认值** | **建议设置** |
|------|----------|-----------|-------------|
| `discovery.heartbeat` | 心跳间隔(秒) | `20` | `10-30` |
| `discovery.ttl` | 超时时间(秒) | `60` | `30-120` |
| `kv.path` | 存储路径前缀 | `/docker` | 可自定义 |

**通俗解释**：
- **heartbeat**：每隔几秒"报平安"一次
- **ttl**：多久没消息就认为节点"失联"了
- **kv.path**：在存储系统中的"文件夹路径"

### 2.5 cluster-advertise：集群广告地址


**🔸 作用说明**：向集群存储系统注册自己的地址

```json
{
  "cluster-advertise": "192.168.1.100:2376"
}
```

**通俗解释**：
- 在"公告板"上贴出自己的联系方式
- 包含IP地址和Docker daemon端口（通常是2376）
- 其他节点通过这个地址与你的Docker daemon通信

**格式说明**：
```
完整格式：IP:PORT
示例：192.168.1.100:2376

端口说明：
2375 - HTTP端口（不安全）
2376 - HTTPS端口（安全，推荐）
```

---

## 3. 🔍 集群存储与发现配置


### 3.1 集群发现机制


**发现流程图**：
```
新节点加入集群的过程：
节点A                    集群存储               现有集群
  |                        |                     |
  |--[1]注册自己----------->|                     |
  |   IP:192.168.1.100     |                     |
  |                        |<--[2]查询现有节点----| 
  |                        |                     |
  |<--[3]返回节点列表-------|                     |
  |   [节点B, 节点C...]     |                     |
  |                        |                     |
  |--[4]建立连接----------------------->|节点B,C|
```

### 3.2 存储后端对比


| 存储类型 | **优点** | **缺点** | **适用场景** |
|---------|----------|----------|-------------|
| **etcd** | 轻量、高性能、易部署 | 需要单独安装 | 🌟 **推荐首选** |
| **consul** | 功能丰富、服务发现强 | 相对复杂 | 大型企业环境 |
| **zookeeper** | 成熟稳定 | 重量级、复杂 | 已有ZK环境 |

### 3.3 实际部署示例


**步骤1：部署etcd存储**
```bash
# 启动etcd容器
docker run -d --name etcd \
  -p 2379:2379 -p 2380:2380 \
  quay.io/coreos/etcd:latest \
  etcd --advertise-client-urls http://0.0.0.0:2379 \
       --listen-client-urls http://0.0.0.0:2379
```

**步骤2：配置Docker节点**
```json
{
  "cluster-store": "etcd://192.168.1.10:2379",
  "cluster-advertise": "192.168.1.100:2376"
}
```

---

## 4. 🚀 Swarm模式核心配置


### 4.1 node-generic-resources：节点通用资源


**🔸 作用说明**：为节点定义特殊资源标签，用于任务调度

```json
{
  "node-generic-resources": [
    "gpu=2",
    "ssd=1TB",
    "region=east"
  ]
}
```

**通俗解释**：
- 给节点贴"标签"，说明这台机器有什么特殊能力
- 调度器可以根据需求把任务分配到合适的节点
- 比如：需要GPU的AI任务会分配到有GPU的节点

**实际应用示例**：
```
场景：混合集群资源管理

节点A配置：["gpu=4", "type=compute"]     ← AI计算节点
节点B配置：["ssd=2TB", "type=storage"]   ← 存储节点  
节点C配置：["cpu=high", "type=web"]      ← Web服务节点

任务部署时：
docker service create --generic-resource gpu=2 ai-model
↑ 会自动调度到节点A
```

### 4.2 swarm：Swarm模式详细配置


```json
{
  "swarm": {
    "advertise-addr": "192.168.1.100:2377",
    "listen-addr": "0.0.0.0:2377",
    "data-path-addr": "192.168.1.100"
  }
}
```

### 4.3 advertise-addr：广告地址


**🔸 作用说明**：告诉其他节点通过什么地址连接到我

```json
{
  "swarm": {
    "advertise-addr": "192.168.1.100:2377"
  }
}
```

**通俗解释**：
- Swarm集群内部通信地址
- 端口2377是Swarm专用管理端口
- 其他节点通过这个地址加入集群

**地址格式选择**：
```
推荐格式：
"advertise-addr": "192.168.1.100:2377"    ← 指定端口
"advertise-addr": "192.168.1.100"         ← 使用默认端口

不推荐：
"advertise-addr": "0.0.0.0:2377"          ← 其他节点无法访问
```

### 4.4 listen-addr：监听地址


**🔸 作用说明**：Docker Swarm在本机监听的网络接口

```json
{
  "swarm": {
    "listen-addr": "0.0.0.0:2377"
  }
}
```

**通俗解释**：
- `0.0.0.0`表示监听所有网络接口
- `2377`是Swarm管理端口
- 相当于"开门迎客"，接受其他节点连接

### 4.5 data-path-addr：数据路径地址


**🔸 作用说明**：容器间通信使用的网络地址

```json
{
  "swarm": {
    "data-path-addr": "192.168.1.100"
  }
}
```

**通俗解释**：
- 专门用于容器数据传输的网络
- 可以与管理网络分离，提高性能
- 在多网卡环境下很有用

**使用场景图示**：
```
双网卡服务器配置：
管理网络：192.168.1.100  (eth0) ← advertise-addr使用
数据网络：10.0.0.100     (eth1) ← data-path-addr使用

好处：管理和数据流量分离，避免互相影响
```

---

## 5. 📊 节点与资源管理配置


### 5.1 task-history-limit：任务历史限制


**🔸 作用说明**：控制每个服务保留多少个历史任务记录

```json
{
  "swarm": {
    "task-history-limit": 10
  }
}
```

**通俗解释**：
- 就像手机通话记录，只保留最近的几条
- 防止历史记录占用太多内存
- 默认值通常是5，可以根据需要调整

**设置建议**：
```
小集群（<10节点）：5-10个历史任务
中等集群（10-50节点）：3-8个历史任务  
大集群（>50节点）：2-5个历史任务

原则：节点越多，单个节点保存的历史越少
```

### 5.2 调度器心跳配置


### 5.3 dispatcher-heartbeat-period：调度器心跳周期


**🔸 作用说明**：管理节点向工作节点发送心跳的时间间隔

```json
{
  "swarm": {
    "dispatcher-heartbeat-period": "5s"
  }
}
```

**通俗解释**：
- 管理者每隔5秒问工作者："你还好吗？"
- 时间太短：网络负担重
- 时间太长：故障发现慢

**时间设置参考**：
```
网络环境好：3-5秒      ← 局域网环境
网络环境一般：5-10秒   ← 跨机房网络
网络环境差：10-15秒    ← 公网连接

⚠️ 不建议超过30秒，会影响故障恢复速度
```

---

## 6. 🔧 性能与监控配置


### 6.1 max-snapshots：最大快照数


**🔸 作用说明**：Raft日志系统保留的快照数量

```json
{
  "swarm": {
    "max-snapshots": 3
  }
}
```

**通俗解释**：
- 快照就像"系统还原点"
- 保留太多占存储，太少不安全
- 默认3个通常够用

**快照机制图示**：
```
时间线：
快照1    快照2    快照3    当前状态
 |        |        |         |
 ○--------○--------○---------●
 ↑                           ↑
保留的历史状态              最新状态

当生成快照4时，快照1会被删除
```

### 6.2 snapshot-interval：快照间隔


**🔸 作用说明**：多长时间创建一次集群状态快照

```json
{
  "swarm": {
    "snapshot-interval": 10000
  }
}
```

**通俗解释**：
- 数值表示Raft日志条目数量
- 每10000条日志创建一次快照
- 快照可以加快节点恢复速度

**设置策略**：
```
集群规模小：5000-10000   ← 变化不频繁
集群规模中：10000-20000  ← 平衡性能和存储
集群规模大：20000-50000  ← 减少快照频率
```

### 6.3 log-entries-for-slow-followers：慢跟随者日志条目


**🔸 作用说明**：为跟不上集群节奏的节点保留多少日志

```json
{
  "swarm": {
    "log-entries-for-slow-followers": 500
  }
}
```

**通俗解释**：
- 有些节点网络慢或性能差，跟不上"大部队"
- 为它们多保留一些日志，帮助它们"补课"
- 如果超出这个数量，慢节点可能需要重新同步

**慢节点处理流程**：
```
正常节点进度：[====90%====]
慢节点进度：  [==60%==    ]
              ↑
         保留额外日志帮助追赶

如果差距过大：
慢节点需要完整快照重新同步
```

---

## 7. 🛠️ 实战配置示例


### 7.1 小型开发环境配置


**适用场景**：2-3台开发机组成的测试集群

```json
{
  "swarm-default-advertise-addr": "192.168.1.100",
  "swarm": {
    "advertise-addr": "192.168.1.100:2377",
    "listen-addr": "0.0.0.0:2377",
    "task-history-limit": 5,
    "dispatcher-heartbeat-period": "5s",
    "max-snapshots": 2,
    "snapshot-interval": 5000
  },
  "node-generic-resources": ["env=dev"]
}
```

**配置说明**：
- 心跳频率较高（5秒）：开发环境网络好
- 历史任务少（5个）：节省内存
- 快照较频繁（5000条）：快速恢复测试环境

### 7.2 中型生产环境配置


**适用场景**：10-20台服务器的生产集群

```json
{
  "cluster-store": "etcd://192.168.1.10:2379,192.168.1.11:2379,192.168.1.12:2379",
  "cluster-store-opts": {
    "discovery.heartbeat": 10,
    "discovery.ttl": 30
  },
  "cluster-advertise": "192.168.1.100:2376",
  "swarm": {
    "advertise-addr": "192.168.1.100:2377", 
    "listen-addr": "0.0.0.0:2377",
    "data-path-addr": "10.0.0.100",
    "task-history-limit": 8,
    "dispatcher-heartbeat-period": "8s",
    "max-snapshots": 3,
    "snapshot-interval": 15000,
    "log-entries-for-slow-followers": 800
  },
  "node-generic-resources": [
    "rack=A01", 
    "zone=east",
    "type=production"
  ]
}
```

**配置亮点**：
- **高可用etcd**：3个etcd节点防止单点故障
- **网络分离**：管理网络和数据网络分开
- **合理参数**：平衡性能和资源消耗

### 7.3 大型企业环境配置


**适用场景**：50+台服务器的大规模集群

```json
{
  "cluster-store": "etcd://etcd-cluster.internal:2379",
  "cluster-store-opts": {
    "discovery.heartbeat": 15,
    "discovery.ttl": 45,
    "kv.path": "/docker/prod-cluster"
  },
  "cluster-advertise": "192.168.1.100:2376",
  "swarm": {
    "advertise-addr": "192.168.1.100:2377",
    "listen-addr": "0.0.0.0:2377", 
    "data-path-addr": "10.0.0.100",
    "task-history-limit": 3,
    "dispatcher-heartbeat-period": "12s",
    "max-snapshots": 5,
    "snapshot-interval": 25000,
    "log-entries-for-slow-followers": 1000
  },
  "node-generic-resources": [
    "gpu=4",
    "storage=nvme", 
    "region=us-east-1",
    "availability-zone=us-east-1a"
  ]
}
```

**企业级特点**：
- **域名解析**：使用内部DNS而不是IP
- **保守参数**：心跳间隔较长，减少网络负担
- **丰富标签**：支持复杂的资源调度需求

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心概念


```
🔸 Swarm配置核心：daemon.json是所有配置的中心
🔸 网络通信：advertise-addr告诉别人怎么找到我
🔸 集群存储：cluster-store是集群的"共享记忆"  
🔸 资源管理：node-generic-resources为节点贴标签
🔸 性能调优：心跳、快照、历史记录的平衡配置
```

### 8.2 关键配置项速查表


| 配置项 | **作用** | **建议值** | **重要性** |
|-------|----------|-----------|-----------|
| `swarm-default-advertise-addr` | 默认通信地址 | 本机内网IP | ★★★★★ |
| `cluster-store` | 集群存储后端 | etcd集群 | ★★★★☆ |
| `advertise-addr` | Swarm通信地址 | IP:2377 | ★★★★★ |
| `task-history-limit` | 历史任务数量 | 3-10个 | ★★★☆☆ |
| `dispatcher-heartbeat-period` | 心跳间隔 | 5-15秒 | ★★★★☆ |

### 8.3 配置最佳实践


**🔹 网络配置原则**：
```
单网卡环境：
- advertise-addr和data-path-addr使用相同IP
- 确保防火墙开放2377端口

多网卡环境：  
- 管理流量和数据流量分离
- 选择最稳定的网络接口做管理网络
```

**🔹 性能优化策略**：
```
开发环境：快速响应，参数设置较小
测试环境：模拟生产，参数适中  
生产环境：稳定第一，参数保守

核心原则：宁可稳定也不要激进
```

**🔹 故障排除要点**：
```
常见问题：
1. 节点无法加入 → 检查advertise-addr和防火墙
2. 服务调度异常 → 检查node-generic-resources标签
3. 性能问题 → 调整心跳间隔和快照参数
4. 存储问题 → 检查cluster-store连接状态
```

### 8.4 学习建议


> 💡 **新手学习路径**：
> 1. **先理解概念**：什么是Swarm，为什么需要这些配置
> 2. **动手实践**：搭建2-3节点的测试环境
> 3. **逐项测试**：修改一个参数，观察效果
> 4. **场景应用**：根据实际需求选择合适配置

**🔹 实践建议**：
- 从简单配置开始，不要一次性配置所有项目
- 每次只改一个参数，便于发现问题
- 在测试环境验证后再应用到生产环境
- 做好配置备份，方便回滚

**核心记忆口诀**：
- **通信靠地址，存储靠后端**
- **心跳保联系，快照保安全** 
- **标签助调度，参数要适中**
- **测试先行动，生产要稳妥**