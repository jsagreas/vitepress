---
title: 9、Docker镜像仓库配置
---
## 📚 目录

1. [Docker镜像仓库配置概述](#1-Docker镜像仓库配置概述)
2. [系统级配置 - daemon.json详解](#2-系统级配置-daemon.json详解)
3. [用户级配置 - config.json详解](#3-用户级配置-config.json详解)
4. [镜像加速器配置实战](#4-镜像加速器配置实战)
5. [私有仓库认证配置](#5-私有仓库认证配置)
6. [代理与网络配置](#6-代理与网络配置)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 🐳 Docker镜像仓库配置概述


### 1.1 什么是Docker镜像仓库配置


**通俗理解**：就像手机需要设置应用商店一样，Docker需要告诉它去哪里下载镜像

```
生活类比：
手机应用商店 = Docker镜像仓库
下载APP = 拉取Docker镜像
应用商店设置 = Docker仓库配置

就像你可以设置手机从不同应用商店下载APP，
Docker也可以配置从不同仓库下载镜像
```

### 1.2 配置文件的作用和位置


**核心概念**：Docker有两个重要的配置文件位置

```
系统级配置（全局生效）:
/etc/docker/daemon.json
├── 所有用户都生效
├── Docker守护进程启动时读取
└── 需要root权限修改

用户级配置（当前用户）:
~/.docker/config.json
├── 只对当前用户生效
├── 主要存储认证信息
└── 普通用户可以修改
```

### 1.3 为什么需要配置镜像仓库


**实际问题解决**：

🔸 **网络访问问题**
- Docker Hub在国外，访问速度慢
- 需要配置国内镜像加速器提升速度

🔸 **私有仓库使用**
- 公司内部有私有镜像仓库
- 需要配置认证信息才能访问

🔸 **安全性考虑**
- 某些仓库使用HTTP而非HTTPS
- 需要配置允许非安全连接

---

## 2. ⚙️ 系统级配置 - daemon.json详解


### 2.1 daemon.json文件基础


**文件位置和作用**：

```bash
配置文件位置：/etc/docker/daemon.json
作用：Docker守护进程的全局配置
格式：JSON格式
权限：需要root权限修改
```

💡 **新手提示**：这个文件默认不存在，需要手动创建

### 2.2 镜像加速器配置 - registry-mirrors


**核心功能**：设置镜像下载的加速源

```json
{
  "registry-mirrors": [
    "https://docker.mirrors.ustc.edu.cn",
    "https://hub-mirror.c.163.com",
    "https://mirror.baidubce.com"
  ]
}
```

**工作原理图示**：
```
没有加速器：
你的电脑 ──慢──> Docker Hub(美国) ──> 下载镜像

有加速器：  
你的电脑 ──快──> 国内镜像源 ──> 下载镜像
             ↑
        自动同步 Docker Hub 内容
```

**配置步骤**：
1️⃣ 创建配置文件：`sudo nano /etc/docker/daemon.json`
2️⃣ 添加加速器地址
3️⃣ 重启Docker服务：`sudo systemctl restart docker`

### 2.3 非安全仓库配置 - insecure-registries


**使用场景**：当你需要连接使用HTTP(而非HTTPS)的私有仓库时

```json
{
  "insecure-registries": [
    "192.168.1.100:5000",
    "myregistry.company.com:8080"
  ]
}
```

🚨 **安全提醒**：只在内部网络或测试环境使用，生产环境建议使用HTTPS

**实际应用**：
```
公司内网场景：
├── 内网私有仓库：192.168.1.100:5000
├── 使用HTTP协议（节省SSL证书成本）
└── 需要添加到insecure-registries才能访问
```

### 2.4 完整的daemon.json配置示例


```json
{
  "registry-mirrors": [
    "https://docker.mirrors.ustc.edu.cn",
    "https://hub-mirror.c.163.com"
  ],
  "insecure-registries": [
    "192.168.1.100:5000"
  ],
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  }
}
```

---

## 3. 👤 用户级配置 - config.json详解


### 3.1 config.json文件基础


**文件特点**：

| 特性 | daemon.json | config.json |
|------|-------------|-------------|
| **作用范围** | 所有用户 | 当前用户 |
| **主要用途** | Docker守护进程配置 | 用户认证信息 |
| **文件位置** | `/etc/docker/` | `~/.docker/` |
| **修改权限** | 需要root | 普通用户即可 |

### 3.2 认证信息存储 - auths配置


**核心概念**：auths存储各个仓库的登录信息

```json
{
  "auths": {
    "https://index.docker.io/v1/": {
      "username": "your-username",
      "password": "your-password",
      "email": "your-email@example.com"
    },
    "192.168.1.100:5000": {
      "username": "admin",
      "password": "admin123"
    }
  }
}
```

**结构解析**：
```
auths 对象
├── "仓库地址1": {认证信息1}
├── "仓库地址2": {认证信息2}
└── "仓库地址N": {认证信息N}

每个认证信息包含：
├── username: 用户名
├── password: 密码
└── email: 邮箱（可选）
```

### 3.3 认证字段详解


**username - 用户名配置**
```json
"username": "your-docker-username"
```
- 作用：登录仓库的用户名
- 来源：注册Docker Hub或私有仓库时设置

**password - 密码配置**  
```json
"password": "your-password"
```
⚠️ **安全注意**：密码以明文存储，注意文件权限

**email - 邮箱配置**
```json
"email": "your-email@example.com"
```
- 作用：关联的邮箱地址
- 状态：现在大多数仓库不再要求

**serveraddress - 服务器地址**
```json
"serveraddress": "https://index.docker.io/v1/"
```
- Docker Hub默认地址：`https://index.docker.io/v1/`
- 私有仓库：使用实际的仓库地址

### 3.4 高级认证配置


**registrytoken - 仓库令牌**
```json
{
  "auths": {
    "myregistry.com": {
      "registrytoken": "eyJhbGciOiJSUzI1NiIs..."
    }
  }
}
```
- 用途：某些仓库使用token认证而非用户名密码
- 获取：通过仓库提供的API获取

**identitytoken - 身份令牌**  
```json
{
  "auths": {
    "gcr.io": {
      "identitytoken": "ya29.GlwcBsT..."
    }
  }
}
```
- 用途：Google Container Registry等使用OAuth认证
- 特点：有时效性，需要定期更新

### 3.5 凭证管理 - credStore和credHelpers


**credStore - 凭证存储后端**
```json
{
  "credStore": "osxkeychain"
}
```

**常用凭证存储后端**：
- macOS：`osxkeychain`
- Windows：`wincred`  
- Linux：`pass`

**credHelpers - 凭证助手配置**
```json
{
  "credHelpers": {
    "gcr.io": "gcr",
    "us.gcr.io": "gcr",
    "amazonaws.com": "ecr-login"
  }
}
```

💡 **通俗理解**：
```
credStore = 系统密码管理器
credHelpers = 专用密码助手

就像：
├── 系统密码管理器存储所有密码
├── 专用助手处理特定网站（如银行网站）
└── Docker同样可以使用系统或专用密码管理
```

---

## 4. 🚀 镜像加速器配置实战


### 4.1 国内主流镜像加速器


**推荐镜像源对比**：

| 提供商 | 镜像源地址 | 特点 | 推荐程度 |
|--------|------------|------|----------|
| **中科大** | `https://docker.mirrors.ustc.edu.cn` | 稳定性好，速度快 | ⭐⭐⭐⭐⭐ |
| **网易** | `https://hub-mirror.c.163.com` | 老牌服务商 | ⭐⭐⭐⭐ |
| **百度云** | `https://mirror.baidubce.com` | 速度较快 | ⭐⭐⭐⭐ |
| **阿里云** | 需要注册获取个人地址 | 需要登录阿里云 | ⭐⭐⭐ |

### 4.2 配置镜像加速器完整流程


**步骤一：创建配置文件**
```bash
# 创建docker配置目录（如果不存在）
sudo mkdir -p /etc/docker

# 编辑配置文件
sudo nano /etc/docker/daemon.json
```

**步骤二：添加配置内容**
```json
{
  "registry-mirrors": [
    "https://docker.mirrors.ustc.edu.cn",
    "https://hub-mirror.c.163.com",
    "https://mirror.baidubce.com"
  ]
}
```

**步骤三：重启Docker服务**
```bash
# 重新加载配置
sudo systemctl daemon-reload

# 重启Docker服务
sudo systemctl restart docker

# 检查服务状态
sudo systemctl status docker
```

**步骤四：验证配置**
```bash
# 查看Docker信息，确认镜像源配置
docker info | grep -A 10 "Registry Mirrors"
```

### 4.3 加速效果对比


**配置前后速度对比**：
```
配置前：
docker pull nginx
├── 连接 Docker Hub (美国)
├── 下载速度: 50-200 KB/s
└── 耗时: 5-10分钟

配置后：
docker pull nginx  
├── 连接 中科大镜像源 (中国)
├── 下载速度: 2-10 MB/s
└── 耗时: 30秒-2分钟
```

📊 **速度提升**: 通常可提升 10-50 倍下载速度

### 4.4 故障排除


**常见问题及解决方案**：

🔸 **配置不生效**
```bash
# 检查JSON格式是否正确
cat /etc/docker/daemon.json | python -m json.tool

# 查看Docker服务日志
sudo journalctl -u docker.service
```

🔸 **镜像源无法访问**
```bash
# 测试镜像源连通性
curl -I https://docker.mirrors.ustc.edu.cn

# 尝试其他镜像源
```

---

## 5. 🔐 私有仓库认证配置


### 5.1 私有仓库认证基础


**什么是私有仓库认证**？

```
公开仓库 (Docker Hub公开镜像):
├── 无需认证
├── 直接 docker pull nginx
└── 任何人都可以下载

私有仓库 (公司内部或付费仓库):
├── 需要认证
├── 先登录: docker login
├── 再下载: docker pull private-image
└── 只有授权用户可以访问
```

### 5.2 Docker登录命令详解


**基本登录命令**：
```bash
# 登录Docker Hub
docker login

# 登录指定仓库
docker login 192.168.1.100:5000

# 登录时指定用户名
docker login -u username 192.168.1.100:5000
```

**登录过程**：
```
1. 输入用户名和密码
2. Docker验证认证信息
3. 认证成功后保存到 ~/.docker/config.json
4. 后续操作自动使用保存的认证信息
```

### 5.3 手动配置认证信息


**直接编辑config.json**：
```json
{
  "auths": {
    "192.168.1.100:5000": {
      "username": "admin",
      "password": "admin123"
    },
    "harbor.company.com": {
      "username": "developer",
      "password": "dev123456",
      "email": "dev@company.com"
    }
  }
}
```

**配置多个仓库认证**：
```
支持同时配置多个仓库：
├── Docker Hub: https://index.docker.io/v1/
├── 公司Harbor: harbor.company.com
├── 内网仓库: 192.168.1.100:5000
└── 云服务商仓库: gcr.io, ecr.amazonaws.com等
```

### 5.4 认证信息安全管理


🚨 **安全提醒**：

**文件权限设置**：
```bash
# 设置config.json文件权限，只有所有者可读写
chmod 600 ~/.docker/config.json

# 查看文件权限
ls -la ~/.docker/config.json
```

**使用凭证存储**：
```json
{
  "credStore": "osxkeychain",
  "auths": {
    "harbor.company.com": {}
  }
}
```
- 密码存储在系统密钥链中，不明文保存
- auths中只保留服务器地址，不保存密码

### 5.5 企业级认证配置示例


**Harbor私有仓库配置**：
```json
{
  "auths": {
    "harbor.company.com": {
      "username": "developer",
      "password": "P@ssw0rd123"
    }
  },
  "HttpHeaders": {
    "User-Agent": "Docker-Client/19.03.0 (linux)"
  }
}
```

**AWS ECR认证配置**：
```bash
# 使用AWS CLI获取登录令牌
aws ecr get-login-password --region us-west-2 | docker login --username AWS --password-stdin 123456789012.dkr.ecr.us-west-2.amazonaws.com
```

---

## 6. 🌐 代理与网络配置


### 6.1 HTTP代理配置 - proxies


**使用场景**：公司网络需要通过代理服务器访问外网

```json
{
  "proxies": {
    "default": {
      "httpProxy": "http://proxy.company.com:8080",
      "httpsProxy": "http://proxy.company.com:8080",
      "noProxy": "localhost,127.0.0.1,::1,192.168.0.0/16"
    }
  }
}
```

**配置说明**：
- `httpProxy`: HTTP请求代理地址
- `httpsProxy`: HTTPS请求代理地址  
- `noProxy`: 不使用代理的地址列表

### 6.2 HTTP头配置 - HttpHeaders


**自定义请求头**：
```json
{
  "HttpHeaders": {
    "User-Agent": "Docker-Client/20.10.0",
    "X-Registry-Auth": "custom-auth-header"
  }
}
```

**常用场景**：
- 某些仓库要求特定的User-Agent
- 企业级仓库需要自定义认证头
- API调用统计和监控

### 6.3 网络故障排除


**连接测试命令**：
```bash
# 测试仓库连通性
curl -v https://index.docker.io/v2/

# 测试代理连接
curl --proxy http://proxy.company.com:8080 https://docker.io

# 查看Docker网络配置
docker info | grep -i proxy
```

**常见网络问题**：

🔸 **代理认证失败**
```
错误：Proxy Authentication Required
解决：在代理URL中包含用户名密码
http://username:password@proxy.company.com:8080
```

🔸 **SSL证书问题**
```
错误：x509: certificate signed by unknown authority
解决：添加到insecure-registries或安装证书
```

---

## 7. 📋 核心要点总结


### 7.1 必须掌握的配置文件


```
🔸 /etc/docker/daemon.json - 系统级配置
   ├── registry-mirrors: 镜像加速器
   ├── insecure-registries: 非安全仓库
   └── proxies: 代理配置

🔸 ~/.docker/config.json - 用户级配置  
   ├── auths: 认证信息
   ├── credStore: 凭证存储
   └── HttpHeaders: HTTP头配置
```

### 7.2 配置优先级和生效规则


**配置优先级**：
```
命令行参数 > 环境变量 > config.json > daemon.json > 默认值

例如：
docker login 命令 > DOCKER_CONFIG环境变量 > ~/.docker/config.json
```

### 7.3 必知必会的实用技巧


🔸 **配置验证**
```bash
# 检查JSON格式
python -m json.tool /etc/docker/daemon.json

# 查看当前配置
docker info
```

🔸 **快速重置配置**
```bash
# 清空用户认证信息
rm ~/.docker/config.json

# 重启Docker服务
sudo systemctl restart docker
```

🔸 **多环境配置管理**
```bash
# 备份当前配置
cp ~/.docker/config.json ~/.docker/config.json.bak

# 切换配置环境
export DOCKER_CONFIG=/path/to/other/config
```

### 7.4 最佳实践建议


**安全实践**：
- ✅ 使用credStore存储密码，避免明文
- ✅ 设置适当的文件权限 (600)
- ✅ 定期更新认证信息
- ❌ 不要在脚本中硬编码密码

**性能优化**：
- ✅ 配置国内镜像加速器
- ✅ 使用多个镜像源做备份
- ✅ 合理配置代理和网络

**维护管理**：
- ✅ 定期备份配置文件
- ✅ 监控配置是否生效
- ✅ 及时更新过期的认证信息

### 7.5 故障排除检查清单


📋 **问题诊断步骤**：

**1. 配置文件检查**
- [ ] JSON格式是否正确
- [ ] 文件路径是否正确
- [ ] 文件权限是否合适

**2. 网络连接测试**  
- [ ] 仓库地址是否可达
- [ ] 代理配置是否正确
- [ ] DNS解析是否正常

**3. 认证信息验证**
- [ ] 用户名密码是否正确
- [ ] 令牌是否过期
- [ ] 权限是否足够

**4. 服务状态确认**
- [ ] Docker服务是否正常运行
- [ ] 配置是否已重新加载
- [ ] 日志中是否有错误信息

### 7.6 学习路径建议


**新手学习顺序**：
1️⃣ **基础配置**：先配置镜像加速器，解决下载慢的问题
2️⃣ **认证登录**：学会使用docker login登录各种仓库  
3️⃣ **高级配置**：掌握代理、凭证管理等高级特性
4️⃣ **故障排除**：学会诊断和解决常见配置问题

🎯 **核心记忆**：
- daemon.json管全局，config.json管用户
- 镜像加速器解决慢，认证配置解决权限  
- JSON格式要正确，重启服务才生效
- 安全第一不明文，权限设置要牢记