---
title: 1、Docker守护进程配置文件
---
## 📚 目录

1. [Docker守护进程配置基础](#1-docker守护进程配置基础)
2. [daemon.json核心配置项](#2-daemon-json核心配置项)
3. [存储与数据管理配置](#3-存储与数据管理配置)
4. [网络配置详解](#4-网络配置详解)
5. [镜像仓库与加速配置](#5-镜像仓库与加速配置)
6. [日志与调试配置](#6-日志与调试配置)
7. [安全与性能优化配置](#7-安全与性能优化配置)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🐳 Docker守护进程配置基础


### 1.1 什么是Docker守护进程配置


**简单理解**：就像给Docker这个"管家"制定工作规则

```
类比理解：
Docker守护进程 = 酒店管家
daemon.json = 管家工作手册

管家工作手册规定：
- 客房数据存放在哪里 (data-root)
- 怎么记录工作日志 (log-driver)  
- 如何处理网络通信 (dns, bip)
- 从哪里获取服务资源 (registry-mirrors)
```

**核心概念**：
- **`dockerd`**：Docker的后台服务程序，24小时运行管理容器
- **`daemon.json`**：告诉dockerd怎么工作的配置文件
- **配置生效**：修改配置后需要重启Docker服务

### 1.2 配置文件位置与作用


**配置文件路径**：
```bash
Linux系统：   /etc/docker/daemon.json
Windows系统： C:\ProgramData\docker\config\daemon.json
macOS系统：   ~/.docker/daemon.json
```

**为什么需要配置文件**？
```
默认Docker就像新买的手机：
❌ 存储空间可能不够用
❌ 下载速度可能很慢  
❌ 网络设置可能不合适
❌ 日志可能占用太多空间

通过daemon.json配置：
✅ 指定合适的存储位置
✅ 配置国内镜像加速
✅ 优化网络设置
✅ 控制日志大小
```

### 1.3 配置文件基本结构


**标准JSON格式**：
```json
{
  "配置项名称": "配置值",
  "另一个配置项": ["数组", "值"],
  "对象配置": {
    "子配置": "值"
  }
}
```

> 💡 **新手提示**：JSON格式要求严格，注意逗号、引号、括号的使用，最后一项后面不能有逗号。

---

## 2. ⚙️ daemon.json核心配置项


### 2.1 数据根目录配置 (data-root)


**作用**：告诉Docker把所有数据存放在哪里

```
现实类比：
就像告诉管家把所有酒店资料放在哪个档案柜里
- 客房信息（镜像文件）
- 客人资料（容器数据）  
- 服务记录（日志文件）
```

**配置示例**：
```json
{
  "data-root": "/var/lib/docker"
}
```

**实际应用场景**：
```json
{
  "data-root": "/data/docker"
}
```

> **为什么要修改**：默认路径`/var/lib/docker`可能在系统盘，容易空间不足。改到数据盘更安全。

**目录结构说明**：
```
/data/docker/
├── containers/     ← 容器数据
├── image/         ← 镜像文件
├── volumes/       ← 数据卷
├── network/       ← 网络配置
└── tmp/          ← 临时文件
```

### 2.2 存储驱动配置 (storage-driver)


**作用**：决定Docker怎么存储镜像和容器文件

```
简单理解：
就像选择用什么方式整理文件
- overlay2：像用透明胶片叠加，效率最高（推荐）
- devicemapper：像用独立文件夹，比较稳定但较慢
- aufs：老式方法，现在很少用
```

**推荐配置**：
```json
{
  "storage-driver": "overlay2"
}
```

> ⚠️ **重要**：大多数情况下Docker会自动选择最佳驱动，除非有特殊需求，不建议手动设置。

### 2.3 监听地址配置 (hosts)


**作用**：设置Docker服务监听哪些地址，允许谁连接

```json
{
  "hosts": [
    "unix:///var/run/docker.sock",
    "tcp://0.0.0.0:2376"
  ]
}
```

**配置说明**：
- **`unix://`**：本地socket连接，最安全
- **`tcp://`**：网络连接，可以远程管理但需要配置安全认证

> 🔒 **安全提示**：开启TCP连接前务必配置TLS认证，否则任何人都能控制你的Docker。

---

## 3. 💾 存储与数据管理配置


### 3.1 容器存活恢复 (live-restore)


**作用**：Docker服务重启时，容器不停止运行

```
现实场景：
酒店管家请假了，但客人还在房间里住着
- live-restore: true  → 客人继续住，不受影响
- live-restore: false → 客人被迫退房（容器停止）
```

**推荐配置**：
```json
{
  "live-restore": true
}
```

**适用场景**：
- ✅ 生产环境服务器
- ✅ 需要高可用性的应用
- ❌ 开发测试环境（可能需要完全重启）

### 3.2 用户态代理 (userland-proxy)


**作用**：控制Docker如何处理端口映射

```
技术解释：
- userland-proxy: true  → 使用Go程序做端口转发
- userland-proxy: false → 使用iptables规则做端口映射（更高效）
```

**性能优化配置**：
```json
{
  "userland-proxy": false
}
```

> 💡 **性能提示**：设为false可以减少内存使用，提高网络性能，但要确保系统支持iptables。

---

## 4. 🌐 网络配置详解


### 4.1 默认网桥IP (bip)


**作用**：设置Docker默认网络的IP地址段

```
网络规划示意：
宿主机：192.168.1.100
Docker网桥：172.17.0.1/16
├── 容器1：172.17.0.2
├── 容器2：172.17.0.3  
└── 容器3：172.17.0.4
```

**配置示例**：
```json
{
  "bip": "172.17.0.1/16"
}
```

**什么时候需要修改**：
- 当Docker默认网段与公司网络冲突时
- 需要特定的IP规划时

### 4.2 固定IP段配置 (fixed-cidr)


**作用**：限制容器可使用的IP范围

```json
{
  "fixed-cidr": "172.17.0.0/25"
}
```

**配置效果**：
```
完整网段：172.17.0.1/16 (可用IP: 172.17.0.1-172.17.255.254)
固定范围：172.17.0.0/25 (可用IP: 172.17.0.1-172.17.0.126)
```

### 4.3 DNS配置 (dns)


**作用**：设置容器内部使用的DNS服务器

```json
{
  "dns": ["8.8.8.8", "114.114.114.114"]
}
```

**常用DNS服务器**：

| DNS服务商 | **主DNS** | **备DNS** | **特点** |
|-----------|-----------|-----------|----------|
| 🌍 **Google** | `8.8.8.8` | `8.8.4.4` | `全球通用，速度稳定` |
| 🇨🇳 **114DNS** | `114.114.114.114` | `114.114.115.115` | `国内优化，访问快` |
| ☁️ **阿里DNS** | `223.5.5.5` | `223.6.6.6` | `阿里云提供，可靠性高` |

---

## 5. 🚀 镜像仓库与加速配置


### 5.1 镜像加速器 (registry-mirrors)


**为什么需要镜像加速**：
```
下载镜像就像网购：
Docker Hub（官方） = 海外购物网站
- 商品齐全但速度慢
- 有时可能访问不了

国内镜像站 = 本地代购仓库  
- 速度快，访问稳定
- 商品同步及时
```

**推荐加速器配置**：
```json
{
  "registry-mirrors": [
    "https://docker.mirrors.ustc.edu.cn",
    "https://hub-mirror.c.163.com",
    "https://mirror.baidubce.com"
  ]
}
```

**主流镜像加速器对比**：

| 加速器名称 | **地址** | **维护方** | **稳定性** |
|-----------|----------|-----------|------------|
| 🎓 **中科大** | `docker.mirrors.ustc.edu.cn` | `中科大` | `⭐⭐⭐⭐⭐` |
| 📮 **网易** | `hub-mirror.c.163.com` | `网易` | `⭐⭐⭐⭐` |
| ☁️ **百度云** | `mirror.baidubce.com` | `百度` | `⭐⭐⭐⭐` |

### 5.2 非安全镜像仓库 (insecure-registries)


**作用**：允许使用HTTP协议（非HTTPS）的私有镜像仓库

```
安全类比：
HTTPS镜像仓库 = 银行金库（安全但手续复杂）
HTTP镜像仓库 = 家里保险柜（方便但安全性较低）
```

**配置示例**：
```json
{
  "insecure-registries": [
    "192.168.1.100:5000",
    "harbor.company.local"
  ]
}
```

> ⚠️ **安全警告**：仅在内网环境或测试环境使用，生产环境务必使用HTTPS。

**使用场景**：
- 🏢 公司内部私有镜像仓库
- 🧪 开发测试环境
- 📚 学习练习搭建的仓库

---

## 6. 📋 日志与调试配置


### 6.1 日志驱动配置 (log-driver)


**作用**：决定Docker怎么记录容器日志

```
日志就像监控摄像头的录像：
- json-file：存本地文件（默认）
- syslog：发送到系统日志服务  
- none：不记录日志（节省空间）
```

**基础配置**：
```json
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "100m",
    "max-file": "3"
  }
}
```

**日志驱动对比**：

| 驱动类型 | **存储位置** | **查看方式** | **适用场景** |
|---------|-------------|-------------|-------------|
| 📄 **json-file** | `本地文件` | `docker logs` | `开发调试` |
| 📨 **syslog** | `系统日志` | `journalctl` | `系统集成` |
| 🚫 **none** | `不存储` | `无法查看` | `性能要求高` |

### 6.2 调试模式 (debug)


**作用**：开启详细的调试日志输出

```json
{
  "debug": true
}
```

**使用建议**：
- ✅ 开发测试时开启，方便排查问题
- ❌ 生产环境关闭，避免日志过多

---

## 7. 🔒 安全与性能优化配置


### 7.1 完整生产环境配置示例


```json
{
  "data-root": "/data/docker",
  "storage-driver": "overlay2",
  "registry-mirrors": [
    "https://docker.mirrors.ustc.edu.cn",
    "https://hub-mirror.c.163.com"
  ],
  "dns": ["114.114.114.114", "8.8.8.8"],
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "100m",
    "max-file": "3"
  },
  "live-restore": true,
  "userland-proxy": false,
  "bip": "172.17.0.1/16"
}
```

### 7.2 开发环境配置示例


```json
{
  "registry-mirrors": [
    "https://docker.mirrors.ustc.edu.cn"
  ],
  "dns": ["114.114.114.114"],
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "2"
  },
  "debug": true,
  "insecure-registries": ["localhost:5000"]
}
```

### 7.3 配置应用步骤


**第一步：创建配置文件**
```bash
# 创建配置目录（如果不存在）
sudo mkdir -p /etc/docker

# 创建配置文件
sudo nano /etc/docker/daemon.json
```

**第二步：验证配置格式**
```bash
# 验证JSON格式是否正确
cat /etc/docker/daemon.json | python -m json.tool
```

**第三步：重启Docker服务**
```bash
# 重新加载系统服务
sudo systemctl daemon-reload

# 重启Docker服务
sudo systemctl restart docker

# 验证服务状态
sudo systemctl status docker
```

**第四步：验证配置生效**
```bash
# 查看Docker系统信息
docker info
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心概念


```
🔸 daemon.json：Docker守护进程的工作手册
🔸 data-root：Docker数据存放位置，默认在系统盘要注意空间
🔸 registry-mirrors：镜像加速器，国内必备配置  
🔸 log-driver：日志记录方式，要控制大小避免占满硬盘
🔸 live-restore：服务重启时容器不停止，生产环境推荐开启
```

### 8.2 新手常见问题与解决


**🔹 配置文件格式错误**
```
常见错误：
- 最后一项后面多了逗号
- 引号使用错误（中文引号）
- 括号不匹配

解决方法：
使用 python -m json.tool 验证格式
```

**🔹 配置不生效**
```
可能原因：
- 忘记重启Docker服务
- 配置文件路径错误
- JSON格式有误

解决步骤：
1. 验证配置文件格式
2. 确认文件路径正确  
3. 重启Docker服务
4. 查看 docker info 确认
```

**🔹 镜像拉取还是很慢**
```
排查步骤：
1. 确认镜像加速器配置正确
2. 测试加速器地址是否可访问
3. 尝试更换其他加速器
4. 检查网络连接是否正常
```

### 8.3 实际应用建议


**🎯 配置优先级**
```
必须配置：
✅ registry-mirrors（镜像加速）
✅ log-opts（日志大小控制）

推荐配置：  
⭐ data-root（数据目录优化）
⭐ dns（DNS服务器）
⭐ live-restore（高可用）

可选配置：
🔧 debug（调试时开启）
🔧 insecure-registries（内网仓库）
```

**🔧 维护建议**
- **定期检查**：磁盘空间、日志大小
- **备份配置**：重要配置文件要备份
- **监控服务**：确保Docker服务运行正常
- **更新维护**：定期更新镜像加速器地址

### 8.4 核心记忆要点


> 🧠 **记忆口诀**：
> 配置Docker守护进程，三个关键要记清
> 数据位置要规划，日志大小要限制  
> 镜像加速不可少，重启服务才生效

**关键配置文件路径**：`/etc/docker/daemon.json`

**必备操作流程**：修改配置 → 验证格式 → 重启服务 → 确认生效

**生产环境要点**：数据目录、日志控制、镜像加速、容器存活恢复