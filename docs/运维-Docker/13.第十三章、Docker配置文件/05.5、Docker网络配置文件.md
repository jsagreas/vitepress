---
title: 5、Docker网络配置文件
---
## 📚 目录

1. [Docker网络配置概述](#1-Docker网络配置概述)
2. [daemon.json网络配置详解](#2-daemon-json网络配置详解)
3. [Docker网络类型深入理解](#3-Docker网络类型深入理解)
4. [网络配置实战案例](#4-网络配置实战案例)
5. [常见问题与最佳实践](#5-常见问题与最佳实践)
6. [核心要点总结](#6-核心要点总结)

---

## 1. 🌐 Docker网络配置概述


### 1.1 什么是Docker网络配置


**🔸 简单理解**
```
Docker网络配置 = 告诉Docker如何让容器之间互相通信
就像给每个容器安排"住址"和"邮递路线"

现实类比：
公司办公楼 = Docker主机
每个办公室 = 每个容器  
楼内电话系统 = Docker网络
电话分机号 = 容器IP地址
```

**💡 为什么需要网络配置**
- **容器隔离**：默认情况下容器是相互隔离的
- **通信需求**：应用往往需要多个容器协作
- **外网访问**：容器内服务需要被外部访问
- **安全控制**：不同应用需要网络隔离

### 1.2 Docker网络配置的核心文件


**📁 主要配置位置**
```
/etc/docker/daemon.json  ← 这是最重要的配置文件！
```

> 💡 **新手提醒**：这个文件控制整个Docker守护进程的行为，包括网络设置

**🔧 配置文件结构预览**
```json
{
  "bridge": "docker0",
  "default-address-pools": [...],
  "dns": ["8.8.8.8"],
  "storage-driver": "overlay2"
}
```

---

## 2. 📋 daemon.json网络配置详解


### 2.1 核心网络配置项目


**🌟 最重要的网络配置选项**

#### bridge - 桥接网络配置

```json
{
  "bridge": "docker0",
  "bip": "172.17.0.1/16"
}
```

> 📌 **通俗解释**：
> - `bridge`：指定默认网桥名称，就像给大楼的内部网络起个名字
> - `bip`：设置桥接网络的IP段，相当于规定内部网络地址范围

**🎯 实际含义**
- **docker0**：Docker默认创建的虚拟网桥
- **172.17.0.1/16**：这个网段内可以分配65534个IP地址给容器

#### default-address-pools - 默认地址池

```json
{
  "default-address-pools": [
    {
      "base": "172.20.0.0/16",
      "size": 24
    }
  ]
}
```

> 🏊‍♂️ **游泳池类比**：
> - `base`：整个游泳池的范围（大池子）
> - `size`：每次分配的小池子大小（24表示256个地址）

#### DNS配置

```json
{
  "dns": ["8.8.8.8", "8.8.4.4"],
  "dns-search": ["example.com"]
}
```

**💭 简单理解**：告诉容器"找不到网址时问谁"

### 2.2 完整的daemon.json网络配置示例


```json
{
  "bridge": "docker0",
  "bip": "172.17.0.1/16",
  "default-address-pools": [
    {
      "base": "172.20.0.0/16", 
      "size": 24
    }
  ],
  "dns": ["8.8.8.8", "8.8.4.4"],
  "dns-search": ["company.local"],
  "userland-proxy": false,
  "ip-forward": true,
  "storage-driver": "overlay2"
}
```

> ⚠️ **重要提醒**：修改这个文件后需要重启Docker服务才生效！

**🔄 重启Docker服务**
```bash
sudo systemctl restart docker
```

---

## 3. 🏗️ Docker网络类型深入理解


### 3.1 bridge - 桥接网络（最常用）


**🌉 桥接网络原理图**
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ 容器A       │    │ 容器B       │    │ 容器C       │
│172.17.0.2   │    │172.17.0.3   │    │172.17.0.4   │
└──────┬──────┘    └──────┬──────┘    └──────┬──────┘
       │                  │                  │
       └──────────────────┼──────────────────┘
                          │
                ┌─────────┴─────────┐
                │   docker0网桥     │
                │   172.17.0.1      │
                └─────────┬─────────┘
                          │
                ┌─────────┴─────────┐
                │   宿主机网卡      │
                │   192.168.1.100   │
                └───────────────────┘
```

**🔸 桥接网络配置参数**
```json
{
  "bridge": "docker0",
  "bip": "172.17.0.1/16",
  "fixed-cidr": "172.17.0.0/24",
  "mtu": 1500
}
```

| 参数 | **含义** | **通俗解释** |
|------|----------|-------------|
| `bridge` | 网桥名称 | 内部网络的"总机"名字 |
| `bip` | 网桥IP地址 | "总机"的地址 |
| `fixed-cidr` | 容器IP范围 | 给容器分配地址的范围 |
| `mtu` | 最大传输单元 | 一次能传输的最大数据包大小 |

### 3.2 host - 主机网络


**🏠 主机网络示意图**
```
宿主机网络环境
┌─────────────────────────────────────┐
│  192.168.1.100                      │
│  ┌─────────────┐  ┌─────────────┐   │
│  │    应用A    │  │    应用B    │   │
│  │   容器内    │  │   容器内    │   │
│  │直接使用宿主机│  │直接使用宿主机│   │
│  │   网络      │  │   网络      │   │
│  └─────────────┘  └─────────────┘   │
└─────────────────────────────────────┘
```

> 💡 **简单理解**：容器直接"住进"宿主机，共享宿主机的网络地址

**🎯 使用场景**
- **高性能需求**：网络性能要求极高的应用
- **端口冲突注意**：多个容器不能使用相同端口

### 3.3 overlay - 覆盖网络（集群用）


**☁️ 覆盖网络架构**
```
Docker Swarm 集群
┌────────────────┐  ┌────────────────┐  ┌────────────────┐
│   节点A        │  │   节点B        │  │   节点C        │
│  ┌─────────┐   │  │  ┌─────────┐   │  │  ┌─────────┐   │
│  │ 容器1   │   │  │  │ 容器2   │   │  │  │ 容器3   │   │
│  │10.0.1.2 │   │  │  │10.0.1.3 │   │  │  │10.0.1.4 │   │
│  └─────────┘   │  │  └─────────┘   │  │  └─────────┘   │
└────────────────┘  └────────────────┘  └────────────────┘
       │                    │                    │
       └────────────────────┼────────────────────┘
                            │
                      虚拟overlay网络
                      (10.0.1.0/24)
```

**🌐 覆盖网络配置**
```json
{
  "cluster-store": "consul://localhost:8500",
  "cluster-advertise": "eth0:2376"
}
```

> 🔗 **集群网络**：让不同机器上的容器像在同一个局域网内通信

### 3.4 macvlan - MAC虚拟局域网


**📡 MACVLAN网络示意**
```
物理网络 192.168.1.0/24
         │
    ┌────┴─────────────────────────┐
    │        宿主机               │
    │    192.168.1.100            │
    │                             │
    │ ┌─────────┐  ┌─────────┐    │
    │ │ 容器A   │  │ 容器B   │    │
    │ │192.168. │  │192.168. │    │
    │ │  1.101  │  │  1.102  │    │
    │ └─────────┘  └─────────┘    │
    └─────────────────────────────┘
```

> 🎭 **独立身份**：每个容器都有自己的MAC地址，在网络中表现为独立设备

---

## 4. 🛠️ 网络配置实战案例


### 4.1 企业内网隔离配置


**🏢 需求场景**：公司有开发、测试、生产三套环境，需要网络隔离

```json
{
  "default-address-pools": [
    {
      "base": "172.16.0.0/16",
      "size": 24
    },
    {
      "base": "172.17.0.0/16", 
      "size": 24
    },
    {
      "base": "172.18.0.0/16",
      "size": 24
    }
  ],
  "dns": ["192.168.1.53"],
  "dns-search": ["company.local"]
}
```

**🎯 配置解释**
- **三个网段**：分别给开发、测试、生产环境
- **内网DNS**：使用公司内部DNS服务器
- **域名后缀**：自动补全公司域名

### 4.2 高性能Web服务配置


**⚡ 需求**：Web服务需要最高网络性能

```json
{
  "userland-proxy": false,
  "ip-forward": true,
  "iptables": true,
  "mtu": 9000
}
```

**📊 配置说明**

| 配置项 | **作用** | **性能影响** |
|--------|----------|-------------|
| `userland-proxy: false` | 禁用用户态代理 | 减少网络延迟 |
| `ip-forward: true` | 启用IP转发 | 提高路由效率 |
| `mtu: 9000` | 巨型帧 | 减少网络开销 |

### 4.3 多网卡环境配置


**🔌 场景**：服务器有多块网卡，需要指定Docker使用特定网卡

```json
{
  "bridge": "docker0",
  "bip": "172.17.0.1/16", 
  "default-gateway": "192.168.1.1",
  "ip": "192.168.1.100"
}
```

> 🎯 **指定网卡**：确保Docker流量走指定的网络接口

---

## 5. 🔧 常见问题与最佳实践


### 5.1 网络冲突问题


**❌ 常见问题**：Docker默认网段与公司网络冲突

```
公司网络：172.17.0.0/16
Docker默认：172.17.0.0/16  ← 冲突！
```

**✅ 解决方案**：修改Docker网段
```json
{
  "bip": "172.19.0.1/16",
  "default-address-pools": [
    {
      "base": "172.19.0.0/16",
      "size": 24  
    }
  ]
}
```

### 5.2 DNS解析问题


**🔍 问题现象**：容器内无法解析域名

**🛠️ 解决配置**
```json
{
  "dns": ["8.8.8.8", "114.114.114.114"],
  "dns-opts": ["timeout:3", "attempts:2"]
}
```

> 💡 **经验分享**：设置多个DNS服务器，提高解析成功率

### 5.3 性能优化配置


**🚀 生产环境推荐配置**
```json
{
  "bridge": "docker0",
  "bip": "172.17.0.1/16",
  "userland-proxy": false,
  "ip-forward": true, 
  "iptables": true,
  "mtu": 1500,
  "dns": ["8.8.8.8", "8.8.4.4"],
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  }
}
```

### 5.4 安全性配置建议


**🔒 安全配置要点**

```json
{
  "icc": false,
  "iptables": true,
  "ip-forward": false,
  "bridge": "none"
}
```

| 配置 | **安全作用** | **影响** |
|------|-------------|----------|
| `icc: false` | 禁止容器间通信 | 提高隔离性 |
| `iptables: true` | 启用防火墙规则 | 增强安全控制 |
| `ip-forward: false` | 禁用IP转发 | 防止网络穿透 |

---

## 6. 📋 核心要点总结


### 6.1 必须掌握的核心概念


```
🔸 daemon.json：Docker网络配置的核心文件
🔸 bridge网络：最常用的网络类型，适合单机容器通信
🔸 host网络：高性能场景，容器直接使用宿主机网络  
🔸 overlay网络：集群环境，跨主机容器通信
🔸 IP地址池：合理规划避免网络冲突
```

### 6.2 关键配置理解


**🔹 网络类型选择原则**
```
单机开发环境：bridge网络
高性能需求：host网络  
微服务集群：overlay网络
需要独立MAC：macvlan网络
```

**🔹 配置修改流程**
```
1️⃣ 备份现有配置
2️⃣ 编辑 /etc/docker/daemon.json
3️⃣ 验证JSON格式正确性
4️⃣ 重启Docker服务
5️⃣ 测试网络连通性
```

**🔹 故障排查思路**
```
网络不通 → 检查IP地址分配
DNS解析失败 → 检查DNS配置  
性能问题 → 检查MTU和代理设置
端口冲突 → 检查网络模式选择
```

### 6.3 实际应用指导


**🎯 开发环境配置**
- 使用bridge网络，简单易用
- 设置合适的IP段避免冲突
- 配置公司DNS服务器

**🏭 生产环境配置**  
- 关注性能和安全性
- 禁用不必要的用户态代理
- 设置合理的日志轮转
- 规划好网络地址分配

**🔧 运维最佳实践**
- 定期备份配置文件
- 监控网络连通性
- 记录配置变更历史
- 测试配置后再应用

### 6.4 学习检查清单


**📝 自我检测**
- [ ] 理解Docker网络基本概念
- [ ] 掌握daemon.json配置格式
- [ ] 会选择合适的网络类型
- [ ] 能解决基本网络问题
- [ ] 了解安全和性能配置

**🔗 相关知识扩展**
- Docker容器端口映射
- Docker Compose网络配置  
- Kubernetes网络模型
- 容器网络监控工具

**核心记忆口诀**：
- 🏗️ daemon.json管全局，网络配置它最大
- 🌉 bridge桥接最常用，host性能overlay集群
- 🎯 IP规划要合理，DNS配置别忘记
- 🔧 修改配置重启服务，测试验证保安全