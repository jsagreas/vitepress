---
title: 13、Docker监控配置文件
---
## 📚 目录

1. [Docker监控配置概述](#1-Docker监控配置概述)
2. [daemon.json核心配置文件](#2-daemonjson核心配置文件)
3. [监控相关配置详解](#3-监控相关配置详解)
4. [集群配置选项](#4-集群配置选项)
5. [日志和调试配置](#5-日志和调试配置)
6. [实战配置示例](#6-实战配置示例)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 🔍 Docker监控配置概述


### 1.1 什么是Docker监控配置


**简单理解**：就像给汽车装仪表盘一样，Docker监控配置让我们能够观察Docker运行状态

```
传统情况：不知道Docker内部发生了什么
             ┌─────────────┐
             │   Docker    │  ← 黑盒子，看不见内部
             │   运行中    │
             └─────────────┘

配置监控后：可以看到详细的运行信息
             ┌─────────────┐
             │   Docker    │  ← 有了"仪表盘"
             │  CPU: 50%   │
             │  内存: 2GB  │
             │  容器: 10个 │
             └─────────────┘
```

**核心作用**：
- 🔸 **性能监控**：CPU、内存、磁盘使用情况
- 🔸 **容器状态**：运行中、停止、错误的容器数量
- 🔸 **网络流量**：数据传输量和连接状态
- 🔸 **资源使用**：帮助优化服务器资源分配

### 1.2 为什么需要监控配置


**实际场景**：
```
场景1：网站突然变慢
没有监控 → 只能瞎猜："可能是服务器问题？"
有了监控 → 明确知道："Docker容器内存占用99%，需要扩容"

场景2：服务突然挂了
没有监控 → 用户投诉后才知道服务停了
有了监控 → 服务停止1分钟内就收到告警通知
```

**监控的价值**：
- ✅ **提前发现问题**：在用户感知之前就能发现异常
- ✅ **快速定位故障**：精确知道问题出在哪个容器
- ✅ **优化资源使用**：避免资源浪费或不足
- ✅ **制定扩容计划**：基于真实数据做决策

---

## 2. 📁 daemon.json核心配置文件


### 2.1 配置文件位置和作用


**配置文件路径**：`/etc/docker/daemon.json`

**通俗理解**：这个文件就像Docker的"设置面板"，所有Docker的行为都可以在这里调整

```
类比：手机设置
┌────────────────────┐     ┌─────────────────────┐
│     手机设置       │     │   daemon.json      │
├────────────────────┤     ├─────────────────────┤
│ 🔊 音量调节        │  ←→ │ 📊 监控配置        │
│ 📶 网络设置        │     │ 🌐 网络设置        │
│ 🔋 电源管理        │     │ 💾 存储配置        │
│ 📱 显示设置        │     │ 🔍 日志设置        │
└────────────────────┘     └─────────────────────┘
```

### 2.2 基础配置结构


**标准格式**：JSON格式，注意语法规范
```json
{
  "配置项1": "值1",
  "配置项2": "值2",
  "配置项3": {
    "子配置1": "子值1",
    "子配置2": "子值2"
  }
}
```

**重要提醒**：
> ⚠️ **JSON语法要求**
> - 最后一项后面不能有逗号
> - 所有字符串必须用双引号
> - 大括号和中括号要配对

### 2.3 文件创建和编辑


**创建配置文件**：
```bash
# 1. 检查文件是否存在
ls -la /etc/docker/daemon.json

# 2. 如果不存在，创建文件
sudo touch /etc/docker/daemon.json

# 3. 编辑配置文件
sudo nano /etc/docker/daemon.json
```

**编辑完成后的重启流程**：
```
第1步：保存配置文件
第2步：重启Docker服务 → sudo systemctl restart docker
第3步：验证配置生效 → docker info
```

---

## 3. 📊 监控相关配置详解


### 3.1 metrics-addr - 指标监听地址


**什么是metrics-addr**：
告诉Docker在哪个地址提供监控数据，就像告诉朋友你住在哪个地址一样

**配置示例**：
```json
{
  "metrics-addr": "127.0.0.1:9323"
}
```

**参数解释**：
- `127.0.0.1` → 只允许本机访问（安全）
- `0.0.0.0` → 允许外部访问（需谨慎）
- `9323` → 监控数据的端口号

**实际应用场景**：
```
场景：运维团队要监控Docker服务器
配置：metrics-addr: "10.0.1.100:9323"
结果：运维人员在监控系统中输入 http://10.0.1.100:9323/metrics
     就能看到这台服务器的Docker运行数据
```

### 3.2 experimental - 实验性功能


**什么是experimental**：
开启Docker的实验性功能，就像手机的"开发者模式"

**配置方式**：
```json
{
  "experimental": true
}
```

**开启后的效果**：
- ✅ 解锁更多监控指标
- ✅ 支持新的API功能
- ⚠️ 可能有稳定性风险

**使用建议**：
```
测试环境：可以开启，用来体验新功能
生产环境：谨慎开启，稳定性优先
```

### 3.3 live-restore - 实时恢复


**什么是live-restore**：
Docker服务重启时，运行中的容器是否继续运行

**配置示例**：
```json
{
  "live-restore": true
}
```

**工作原理对比**：
```
live-restore: false (默认)
Docker重启 → 所有容器停止 → 用户服务中断

live-restore: true
Docker重启 → 容器继续运行 → 用户无感知
```

**实际价值**：
- 🔸 **减少服务中断**：升级Docker时业务不受影响
- 🔸 **提高可用性**：维护期间用户体验更好
- 🔸 **运维友好**：可以放心进行Docker升级

---

## 4. 🌐 集群配置选项


### 4.1 cluster-store - 集群存储


**什么是集群存储**：
多台Docker服务器之间共享信息的"通讯录"

**配置示例**：
```json
{
  "cluster-store": "etcd://192.168.1.10:2379"
}
```

**通俗理解**：
```
单机模式：每台服务器都是"独行侠"
    Server1     Server2     Server3
      📦          📦          📦
   独自工作    独自工作    独自工作

集群模式：服务器之间可以"通话"
    Server1 ←──→ Server2 ←──→ Server3
      📦            📦            📦
   共享信息      共享信息      共享信息
```

### 4.2 cluster-store-opts - 集群存储选项


**作用**：配置集群存储的详细参数

**配置示例**：
```json
{
  "cluster-store": "etcd://192.168.1.10:2379",
  "cluster-store-opts": {
    "kv.cacertfile": "/path/to/ca.pem",
    "kv.certfile": "/path/to/cert.pem", 
    "kv.keyfile": "/path/to/key.pem"
  }
}
```

**参数说明**：
| 参数 | 作用 | 通俗理解 |
|------|------|----------|
| `kv.cacertfile` | CA证书文件 | 验证身份的"身份证" |
| `kv.certfile` | 客户端证书 | 自己的"通行证" |
| `kv.keyfile` | 私钥文件 | 解锁"通行证"的钥匙 |

### 4.3 cluster-advertise - 集群广告地址


**什么是广告地址**：
告诉其他服务器"我在这里，可以找我"

**配置示例**：
```json
{
  "cluster-advertise": "192.168.1.100:2376"
}
```

**实际场景**：
```
场景：3台服务器组成Docker集群

Server1广告地址：192.168.1.100:2376
Server2广告地址：192.168.1.101:2376  
Server3广告地址：192.168.1.102:2376

结果：每台服务器都知道其他服务器的联系方式
```

---

## 5. 📝 日志和调试配置


### 5.1 log-level - 日志级别设置


**什么是日志级别**：
控制Docker记录多少详细信息，就像调节收音机音量

**可选级别**：
```
debug   → 🔍 最详细，所有信息都记录（调试用）
info    → ℹ️  重要信息（默认推荐）  
warn    → ⚠️  只记录警告和错误
error   → ❌ 只记录错误信息
fatal   → 💥 只记录致命错误
```

**配置示例**：
```json
{
  "log-level": "info"
}
```

**选择建议**：
| 环境 | 推荐级别 | 原因 |
|------|----------|------|
| 开发环境 | `debug` | 需要详细信息排查问题 |
| 测试环境 | `info` | 平衡信息量和性能 |
| 生产环境 | `warn` | 减少日志量，关注问题 |

### 5.2 debug - 调试模式


**什么是调试模式**：
开启后Docker会输出更多技术细节，帮助解决问题

**配置示例**：
```json
{
  "debug": true,
  "log-level": "debug"
}
```

**开启后的效果**：
- ✅ 显示详细的API调用信息
- ✅ 记录容器创建的每个步骤
- ✅ 输出网络配置的详细过程
- ⚠️ 日志量大大增加，影响性能

### 5.3 raw-logs - 原始日志输出


**什么是原始日志**：
不经过Docker处理的原生日志格式

**配置示例**：
```json
{
  "raw-logs": true
}
```

**效果对比**：
```
raw-logs: false (默认)
[2024-01-20 10:30:15] INFO: Container started successfully

raw-logs: true  
2024-01-20T10:30:15.123456789Z container_id=abc123 status=started
```

### 5.4 pidfile - PID文件路径


**什么是PID文件**：
记录Docker进程ID的文件，系统管理用

**配置示例**：
```json
{
  "pidfile": "/var/run/docker.pid"
}
```

**实际用途**：
- 🔸 **系统监控**：监控工具通过PID文件检查Docker是否运行
- 🔸 **进程管理**：系统重启时自动管理Docker进程
- 🔸 **故障排查**：出问题时快速找到Docker进程

---

## 6. ⚙️ 实战配置示例


### 6.1 基础监控配置


**适用场景**：小型项目，基础监控需求

```json
{
  "metrics-addr": "127.0.0.1:9323",
  "log-level": "info",
  "live-restore": true
}
```

**配置说明**：
- 开启本地监控端口
- 记录重要日志信息  
- 支持Docker重启时容器继续运行

### 6.2 生产环境配置


**适用场景**：生产服务器，高可用要求

```json
{
  "metrics-addr": "0.0.0.0:9323",
  "experimental": false,
  "live-restore": true,
  "log-level": "warn",
  "raw-logs": false,
  "pidfile": "/var/run/docker.pid"
}
```

**配置特点**：
- ✅ 允许外部监控系统访问
- ✅ 关闭实验性功能确保稳定
- ✅ 只记录警告级别以上日志
- ✅ 标准化的PID文件管理

### 6.3 集群环境配置


**适用场景**：多服务器集群部署

```json
{
  "metrics-addr": "0.0.0.0:9323",
  "cluster-store": "etcd://10.0.1.10:2379,10.0.1.11:2379,10.0.1.12:2379",
  "cluster-advertise": "10.0.1.100:2376",
  "cluster-store-opts": {
    "kv.cacertfile": "/etc/docker/ca.pem",
    "kv.certfile": "/etc/docker/cert.pem",
    "kv.keyfile": "/etc/docker/key.pem"
  },
  "live-restore": true,
  "log-level": "info"
}
```

**配置说明**：
- 🔸 配置多个etcd节点确保高可用
- 🔸 使用SSL证书保障集群通信安全
- 🔸 设置本机广告地址供其他节点连接

### 6.4 开发调试配置


**适用场景**：开发环境，需要详细调试信息

```json
{
  "metrics-addr": "127.0.0.1:9323",
  "experimental": true,
  "debug": true,
  "log-level": "debug",
  "raw-logs": true
}
```

**配置特点**：
- 🔍 开启所有调试功能
- 🔍 记录最详细的日志信息
- 🔍 启用实验性功能测试新特性

---

## 7. 📋 核心要点总结


### 7.1 必须掌握的核心配置


```
🔸 daemon.json文件：Docker的"设置面板"，位于/etc/docker/
🔸 metrics-addr：监控数据地址，让监控系统知道去哪里取数据
🔸 live-restore：Docker重启时容器是否继续运行
🔸 log-level：控制日志详细程度，平衡信息量和性能
🔸 集群配置：多台服务器协同工作的通信设置
```

### 7.2 配置最佳实践


**🔹 安全性原则**：
```
本地监控：metrics-addr设置为127.0.0.1
远程监控：配置防火墙限制访问来源
集群通信：必须使用SSL证书加密
```

**🔹 性能优化**：
```
生产环境：log-level设置为warn，减少日志量
开发环境：可以设置为debug，便于排查问题
日志轮转：配置logrotate避免日志文件过大
```

**🔹 运维友好**：
```
标准化PID文件路径：便于系统管理
开启live-restore：减少维护期间的服务中断
合理的集群广告地址：确保节点间正常通信
```

### 7.3 常见问题和解决


**🔧 配置不生效**：
```
检查点：
1. JSON格式是否正确（注意逗号和引号）
2. 是否重启了Docker服务
3. 查看docker info确认配置已生效
```

**🔧 监控数据获取不到**：
```
排查步骤：
1. 检查metrics-addr地址是否可访问
2. 防火墙是否阻止了监控端口
3. experimental是否开启（某些指标需要）
```

**🔧 集群节点无法通信**：
```
检查项：
1. cluster-advertise地址是否正确
2. 网络连通性是否正常
3. SSL证书是否配置正确
```

### 7.4 实际应用价值


**监控配置的业务价值**：
- 📈 **提升服务稳定性**：及时发现和解决问题
- 💰 **降低运维成本**：自动化监控减少人工投入
- 🚀 **支持业务扩展**：基于监控数据制定扩容策略
- 🛡️ **增强安全性**：异常行为及时告警

**核心记忆**：
- daemon.json是Docker的总开关，配置要谨慎
- 监控配置让Docker从黑盒变透明，运维更轻松  
- 不同环境用不同配置，开发详细生产精简
- 集群配置重在通信，安全认证不可缺少