---
title: 1、容器生命周期
---
## 📚 目录

1. [容器生命周期概述](#1-容器生命周期概述)
2. [容器创建过程详解](#2-容器创建过程详解)
3. [容器启动与停止操作](#3-容器启动与停止操作)
4. [容器暂停与恢复管理](#4-容器暂停与恢复管理)
5. [容器删除与清理策略](#5-容器删除与清理策略)
6. [容器状态管理监控](#6-容器状态管理监控)
7. [自动重启策略配置](#7-自动重启策略配置)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🔄 容器生命周期概述


### 1.1 什么是容器生命周期


**简单理解**：容器生命周期就像一个应用程序的**完整生存过程**，从创建到销毁的整个流程。

```
生活类比：就像养宠物的过程
准备笼子 → 把宠物放进去 → 喂食照料 → 宠物休息 → 最终告别

Docker容器：
创建容器 → 启动运行 → 正常工作 → 暂停休眠 → 删除清理
```

### 1.2 容器状态全景图


```
容器状态流转图：

    [镜像]
      ↓ create
   [Created]────────┐
      ↓ start      │
   [Running]       │ rm
      ↓ ↑         │
   [Paused]        │
      ↓ ↑         │
   [Stopped]───────┘
      ↓ rm
   [Deleted]
```

**状态含义解释**：
- **🎯 Created**：容器已创建但未启动，就像**准备好的空房间**
- **⚡ Running**：容器正在运行，就像**正在工作的程序**
- **⏸️ Paused**：容器暂停，就像**按了暂停键的视频**  
- **⏹️ Stopped**：容器停止，就像**关闭的程序**
- **🗑️ Deleted**：容器被删除，就像**清空回收站**

### 1.3 生命周期管理的重要性


**为什么要管理容器生命周期？**

| 场景 | 不管理的后果 | 管理后的好处 |
|------|-------------|-------------|
| **开发测试** | 容器越来越多，占用资源 | 及时清理，保持环境整洁 |
| **生产部署** | 容器异常无法自动恢复 | 自动重启，保证服务稳定 |
| **资源管理** | 内存磁盘空间不足 | 合理回收，优化资源使用 |
| **故障排查** | 不知道容器出了什么问题 | 状态监控，快速定位问题 |

---

## 2. 🏗️ 容器创建过程详解


### 2.1 创建容器的本质


**容器创建 ≠ 容器启动**

```
理解要点：
创建容器 = 准备一个空房间，但还没有人住进去
启动容器 = 让房间里的程序开始工作

docker create：只创建，不启动
docker run：创建 + 启动（一步到位）
```

### 2.2 create命令详解


**基础语法**：
```bash
docker create [选项] 镜像名 [命令]
```

**实际操作示例**：

```bash
# 创建一个nginx容器（但不启动）
docker create --name my-nginx -p 8080:80 nginx

# 查看容器状态（显示Created）
docker ps -a
```

**输出结果解读**：
```
CONTAINER ID   IMAGE   COMMAND                  CREATED         STATUS    NAMES
abc123...      nginx   "/docker-entrypoint.…"   5 seconds ago   Created   my-nginx
```

**关键信息说明**：
- **STATUS: Created** - 表示容器已创建但未运行
- **COMMAND** - 显示容器启动时会执行的命令
- **NAMES** - 我们给容器起的名字

### 2.3 创建过程内部机制


**Docker创建容器时发生了什么？**

```
创建过程分解：

1. 检查镜像 ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   │ 本地有吗？没有就下载
   
2. 分配资源 ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   │ 分配CPU、内存、网络等资源
   
3. 创建文件系统 ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   │ 基于镜像创建容器的文件系统层
   
4. 配置网络 ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   │ 设置容器的网络环境
   
5. 记录元数据 ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   │ 容器ID、名称、配置等信息
```

### 2.4 创建时常用参数


| 参数 | 作用 | 示例 |
|------|------|------|
| `--name` | **给容器起名字** | `--name web-server` |
| `-p` | **端口映射** | `-p 8080:80` |
| `-v` | **挂载数据卷** | `-v /data:/app/data` |
| `-e` | **设置环境变量** | `-e NODE_ENV=production` |
| `--network` | **指定网络** | `--network my-network` |

---

## 3. ⚡ 容器启动与停止操作


### 3.1 启动容器的两种方式


**方式对比**：

```
方式一：分步操作
docker create nginx    # 先创建
docker start 容器名     # 再启动

方式二：一步到位  
docker run nginx       # 创建并启动

选择建议：
新手学习：用 run，简单直接
生产环境：用 create + start，更灵活控制
```

### 3.2 start命令详解


**基础启动**：
```bash
# 启动已创建的容器
docker start my-nginx

# 启动并查看日志
docker start -a my-nginx  # -a 显示输出

# 启动多个容器
docker start container1 container2 container3
```

**启动状态验证**：
```bash
# 查看运行中的容器
docker ps

# 查看容器详细信息
docker inspect my-nginx | grep Status
```

### 3.3 停止容器详解


**优雅停止 vs 强制停止**：

```bash
# 优雅停止（推荐）- 给容器10秒时间保存数据
docker stop my-nginx

# 立即停止 - 直接杀死进程（危险）
docker kill my-nginx

# 设置停止等待时间
docker stop -t 30 my-nginx  # 等待30秒再强制停止
```

**停止原理解释**：
```
优雅停止过程：

1. 发送SIGTERM信号 ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   │ 告诉容器："请准备关闭"
   
2. 等待容器处理 ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   │ 容器保存数据、关闭连接等
   
3. 超时则强制停止 ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   │ 发送SIGKILL信号，立即终止
```

### 3.4 重启容器


**重启操作**：
```bash
# 重启容器
docker restart my-nginx

# 批量重启
docker restart $(docker ps -aq)  # 重启所有容器

# 设置重启等待时间
docker restart -t 20 my-nginx
```

**重启 = 停止 + 启动**，会保持原有配置。

---

## 4. ⏸️ 容器暂停与恢复管理


### 4.1 暂停功能的实际意义


**什么时候需要暂停？**

```
实际使用场景：

📊 系统维护
   系统需要维护时，暂停非关键容器释放资源

🔧 调试程序  
   程序出现问题，暂停后分析状态

⚡ 资源紧张
   临时释放CPU和内存给其他容器使用

🎯 测试环境
   快速暂停测试容器，避免干扰
```

### 4.2 暂停与恢复操作


**基本操作**：
```bash
# 暂停容器
docker pause my-nginx
echo "容器已暂停，但进程还在内存中"

# 查看暂停状态
docker ps  # STATUS显示为Paused

# 恢复容器
docker unpause my-nginx
echo "容器恢复运行"
```

**状态查看示例**：
```
暂停前：
CONTAINER ID   STATUS          NAMES
abc123...      Up 2 minutes    my-nginx

暂停后：
CONTAINER ID   STATUS                 NAMES  
abc123...      Up 2 minutes(Paused)   my-nginx
```

### 4.3 暂停 vs 停止的区别


| 操作 | 暂停(pause) | 停止(stop) |
|------|-------------|------------|
| **进程状态** | 进程冻结，留在内存 | 进程完全关闭 |
| **恢复速度** | 极快（毫秒级） | 较慢（需要重新启动） |
| **资源占用** | 占用内存，不占CPU | 释放所有资源 |
| **适用场景** | 临时暂停，快速恢复 | 长期停止，彻底清理 |

**选择建议**：
- **短暂中断** → 使用pause
- **长期停止** → 使用stop

---

## 5. 🗑️ 容器删除与清理策略


### 5.1 删除操作详解


**基础删除操作**：
```bash
# 删除已停止的容器
docker rm my-nginx

# 强制删除运行中的容器
docker rm -f my-nginx

# 删除多个容器
docker rm container1 container2 container3
```

**⚠️ 重要提醒**：删除容器会**永久丢失容器内的数据**，除非数据存储在挂载的数据卷中。

### 5.2 批量清理策略


**清理停止的容器**：
```bash
# 清理所有停止的容器
docker container prune

# 清理30天前停止的容器  
docker container prune --filter "until=720h"
```

**一键清理命令**：
```bash
# 删除所有停止的容器
docker rm $(docker ps -aq --filter "status=exited")

# 删除所有容器（危险操作）
docker rm -f $(docker ps -aq)
```

### 5.3 安全删除检查清单


**删除前必须检查**：

```
安全检查清单：

□ 数据是否已备份？
   重要数据是否已保存到数据卷或外部存储？

□ 容器是否还在使用？
   其他服务是否依赖这个容器？

□ 网络连接影响？  
   删除后是否影响其他容器的网络通信？

□ 删除范围确认？
   是删除单个容器还是批量删除？
```

### 5.4 自动清理配置


**定时清理脚本**：
```bash
#!/bin/bash
# 每天凌晨2点清理停止超过24小时的容器
0 2 * * * docker container prune -f --filter "until=24h"
```

---

## 6. 📊 容器状态管理监控


### 6.1 查看容器状态


**基础状态查询**：
```bash
# 查看运行中的容器
docker ps

# 查看所有容器（包括停止的）
docker ps -a

# 只显示容器ID
docker ps -q

# 自定义显示格式
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
```

**输出结果解读**：
```
CONTAINER ID   IMAGE    COMMAND   CREATED   STATUS       PORTS     NAMES
abc123...      nginx    "nginx"   1 hour    Up 1 hour    80/tcp    web-server

字段含义：
- STATUS: Up 1 hour     → 运行了1小时
- STATUS: Exited (0)    → 正常退出
- STATUS: Exited (1)    → 异常退出  
- PORTS: 0.0.0.0:8080→80/tcp → 端口映射信息
```

### 6.2 详细状态信息


**深入查看容器信息**：
```bash
# 查看容器详细配置
docker inspect my-nginx

# 只查看状态信息
docker inspect my-nginx | grep -A 10 '"State"'

# 查看资源使用情况  
docker stats my-nginx
```

**资源监控输出**：
```
CONTAINER ID   NAME       CPU %   MEM USAGE/LIMIT   MEM %   NET I/O     BLOCK I/O
abc123...      my-nginx   0.05%   12.5MiB/1.9GiB    0.64%   1.2kB/648B  0B/0B

关键指标解释：
- CPU %: CPU使用率
- MEM %: 内存使用率  
- NET I/O: 网络输入输出
- BLOCK I/O: 磁盘读写
```

### 6.3 日志监控


**查看容器日志**：
```bash
# 查看最新日志
docker logs my-nginx

# 实时查看日志（类似tail -f）
docker logs -f my-nginx

# 查看最后50行日志
docker logs --tail 50 my-nginx

# 查看特定时间的日志
docker logs --since "2024-01-01T10:00:00" my-nginx
```

### 6.4 健康检查


**设置健康检查**：
```bash
# 创建带健康检查的容器
docker run -d \
  --name web-app \
  --health-cmd="curl -f http://localhost/ || exit 1" \
  --health-interval=30s \
  --health-timeout=3s \
  --health-retries=3 \
  nginx
```

**健康状态查看**：
```bash
# 查看健康状态
docker inspect web-app | grep -A 5 '"Health"'

# 状态含义：
# healthy: 健康
# unhealthy: 不健康  
# starting: 启动中
```

---

## 7. 🔄 自动重启策略配置


### 7.1 重启策略概述


**为什么需要自动重启？**

```
实际问题场景：

💥 程序崩溃
   应用程序出现bug导致容器停止

🔌 网络故障  
   网络中断导致服务异常退出

⚡ 系统重启
   服务器重启后容器需要自动启动

🏥 依赖故障
   数据库等依赖服务故障影响应用
```

### 7.2 重启策略类型


| 策略 | 说明 | 适用场景 |
|------|------|----------|
| `no` | **永不重启（默认）** | 开发测试环境 |
| `always` | **总是重启** | 生产环境关键服务 |
| `unless-stopped` | **除非手动停止** | 大部分生产服务 |  
| `on-failure` | **只在失败时重启** | 可能正常结束的任务 |

### 7.3 重启策略配置实践


**创建时设置重启策略**：
```bash
# 总是重启
docker run -d --restart always --name web-server nginx

# 失败时重启，最多重试3次  
docker run -d --restart on-failure:3 --name app python:3.9

# 除非手动停止
docker run -d --restart unless-stopped --name database mysql:8.0
```

**修改已有容器的重启策略**：
```bash
# 修改容器重启策略
docker update --restart always my-container

# 批量修改多个容器
docker update --restart unless-stopped container1 container2
```

### 7.4 重启策略选择指南


**选择决策树**：

```
选择重启策略：

服务类型？
├─ 关键业务服务 → always
├─ 一般业务服务 → unless-stopped  
├─ 定时任务     → on-failure:3
└─ 开发测试     → no

运行环境？
├─ 生产环境 → unless-stopped 或 always
├─ 测试环境 → on-failure
└─ 开发环境 → no

故障容忍度？  
├─ 零容忍 → always
├─ 可接受短暂中断 → unless-stopped
└─ 允许手动处理 → on-failure
```

**最佳实践建议**：
- **Web服务**：使用 `unless-stopped`
- **数据库**：使用 `unless-stopped` 
- **缓存服务**：使用 `always`
- **批处理任务**：使用 `on-failure:3`

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的关键概念


```
🔸 容器生命周期：Created → Running → Paused → Stopped → Deleted
🔸 操作区别：create vs run, pause vs stop, rm vs prune
🔸 状态监控：ps、inspect、stats、logs命令的使用
🔸 重启策略：no、always、unless-stopped、on-failure的选择
🔸 清理维护：定期清理停止容器，避免资源浪费
```

### 8.2 实际操作记忆口诀


```
容器生命有规律，创建启动停删除
状态监控要常看，日志错误早发现  
重启策略保稳定，清理维护好习惯
暂停恢复应急用，批量操作效率高
```

### 8.3 常用命令速查表


| 操作类型 | 命令 | 作用 |
|----------|------|------|
| **创建** | `docker create` | 创建容器但不启动 |
| **启动** | `docker start` | 启动已创建的容器 |
| **运行** | `docker run` | 创建并启动容器 |
| **停止** | `docker stop` | 优雅停止容器 |
| **暂停** | `docker pause` | 暂停容器运行 |
| **恢复** | `docker unpause` | 恢复暂停的容器 |
| **删除** | `docker rm` | 删除容器 |
| **查看** | `docker ps` | 查看容器状态 |
| **监控** | `docker stats` | 查看资源使用 |
| **日志** | `docker logs` | 查看容器日志 |

### 8.4 生产环境最佳实践


**🎯 核心原则**：
- **明确命名**：给容器起有意义的名字
- **合理重启**：根据业务选择重启策略  
- **定期清理**：避免无用容器占用资源
- **状态监控**：及时发现和处理异常
- **日志管理**：保留足够的故障诊断信息

**⚠️ 注意事项**：
- 删除容器前确保数据已备份
- 生产环境慎用强制删除（`rm -f`）
- 重启策略设置要考虑依赖关系
- 定期检查容器健康状态

**💡 效率提升技巧**：
- 使用别名简化常用命令
- 编写脚本自动化常规操作
- 利用标签和过滤器批量管理
- 配置日志轮转避免日志过大