---
title: 3、私有仓库搭建
---
## 📚 目录

1. [私有仓库基础概念](#1-私有仓库基础概念)
2. [Docker Registry基础搭建](#2-Docker-Registry基础搭建)
3. [Registry安全配置](#3-Registry安全配置)
4. [Harbor企业级仓库](#4-Harbor企业级仓库)
5. [存储与同步机制](#5-存储与同步机制)
6. [用户权限管理](#6-用户权限管理)
7. [运维与监控](#7-运维与监控)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🏗️ 私有仓库基础概念


### 1.1 什么是Docker私有仓库


**💡 通俗理解**
```
想象一下：
公有仓库（Docker Hub）= 公共图书馆，所有人都能借阅
私有仓库 = 企业内部图书馆，只有内部员工能使用

Docker私有仓库就是企业自己搭建的"镜像存储中心"
```

**🔸 私有仓库的核心价值**：
- **数据安全**：企业敏感代码不会暴露在公网
- **访问控制**：只有授权用户才能拉取/推送镜像  
- **网络效率**：内网访问，速度更快
- **合规要求**：满足企业安全合规标准

### 1.2 私有仓库架构组成


**🏗️ 基础架构图**
```
┌─────────────────┐    ┌─────────────────┐
│   开发人员       │────│   Docker客户端   │
└─────────────────┘    └─────────────────┘
                              │
                              │ docker push/pull
                              ▼
                    ┌─────────────────┐
                    │   负载均衡器     │
                    └─────────────────┘
                              │
                    ┌─────────────────┐
                    │  私有仓库服务    │
                    │  (Registry)     │
                    └─────────────────┘
                              │
                    ┌─────────────────┐
                    │   存储后端       │
                    │ (本地/云存储)    │
                    └─────────────────┘
```

**🔧 核心组件说明**：
- **Registry服务**：处理镜像上传下载的核心服务
- **认证系统**：控制用户访问权限
- **存储后端**：实际保存镜像数据的地方
- **Web界面**：提供可视化管理功能

### 1.3 私有仓库vs公有仓库对比


| 对比维度 | **公有仓库(Docker Hub)** | **私有仓库** |
|---------|----------------------|-------------|
| 🔐 **安全性** | 公开可见（除私有镜像） | 完全内部控制 |
| 🚀 **访问速度** | 取决于网络带宽 | 内网高速访问 |
| 💰 **成本** | 免费+付费套餐 | 硬件+维护成本 |
| 🛠️ **维护** | 平台负责维护 | 企业自行维护 |
| 📊 **统计分析** | 基础统计功能 | 详细的使用分析 |
| ⚖️ **合规性** | 依赖第三方 | 完全符合企业要求 |

---

## 2. 🐳 Docker Registry基础搭建


### 2.1 Registry快速部署


**🚀 最简单的部署方式**
```bash
# 1. 拉取官方Registry镜像
docker pull registry:2

# 2. 启动Registry容器
docker run -d \
  --name my-registry \
  -p 5000:5000 \
  registry:2

# 验证是否启动成功
curl http://localhost:5000/v2/_catalog
```

> 💡 **解释**：这个命令启动了一个最基础的私有仓库，监听5000端口，任何人都可以推送拉取镜像

### 2.2 数据持久化配置


**📁 挂载本地存储**
```bash
# 创建存储目录
mkdir -p /opt/docker-registry/data

# 启动带数据持久化的Registry
docker run -d \
  --name my-registry \
  -p 5000:5000 \
  -v /opt/docker-registry/data:/var/lib/registry \
  --restart=always \
  registry:2
```

**🔸 为什么需要数据持久化？**
- 容器重启后镜像数据不会丢失
- 可以备份整个镜像仓库
- 便于数据迁移和恢复

### 2.3 基础配置文件


**📝 创建配置文件**
```yaml
# /opt/docker-registry/config.yml
version: 0.1
log:
  fields:
    service: registry
storage:
  cache:
    blobdescriptor: inmemory
  filesystem:
    rootdirectory: /var/lib/registry
http:
  addr: :5000
  headers:
    X-Content-Type-Options: [nosniff]
health:
  storagedriver:
    enabled: true
    interval: 10s
    threshold: 3
```

**使用配置文件启动**：
```bash
docker run -d \
  --name my-registry \
  -p 5000:5000 \
  -v /opt/docker-registry/config.yml:/etc/docker/registry/config.yml \
  -v /opt/docker-registry/data:/var/lib/registry \
  registry:2
```

### 2.4 测试私有仓库


**🧪 推送镜像到私有仓库**
```bash
# 1. 拉取一个测试镜像
docker pull nginx:alpine

# 2. 给镜像打标签（指向私有仓库）
docker tag nginx:alpine localhost:5000/nginx:alpine

# 3. 推送到私有仓库
docker push localhost:5000/nginx:alpine

# 4. 验证推送成功
curl http://localhost:5000/v2/_catalog
# 返回：{"repositories":["nginx"]}
```

---

## 3. 🔐 Registry安全配置


### 3.1 HTTPS证书配置


**🔒 为什么需要HTTPS？**
- Docker默认只允许HTTPS或本地仓库
- 保护镜像传输过程中的安全
- 防止中间人攻击

**📜 生成自签名证书**
```bash
# 创建证书目录
mkdir -p /opt/docker-registry/certs

# 生成私钥
openssl genrsa -out /opt/docker-registry/certs/domain.key 2048

# 生成证书
openssl req -new -x509 -key /opt/docker-registry/certs/domain.key \
  -out /opt/docker-registry/certs/domain.crt -days 365 \
  -subj "/CN=registry.example.com"
```

**启动带HTTPS的Registry**：
```bash
docker run -d \
  --name secure-registry \
  -p 443:5000 \
  -v /opt/docker-registry/certs:/certs \
  -v /opt/docker-registry/data:/var/lib/registry \
  -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt \
  -e REGISTRY_HTTP_TLS_KEY=/certs/domain.key \
  registry:2
```

### 3.2 基础认证配置


**👤 用户名密码认证**
```bash
# 安装htpasswd工具
apt-get install apache2-utils

# 创建认证目录
mkdir -p /opt/docker-registry/auth

# 创建用户（用户名：admin）
htpasswd -Bbn admin mypassword > /opt/docker-registry/auth/htpasswd
```

**启动带认证的Registry**：
```bash
docker run -d \
  --name auth-registry \
  -p 5000:5000 \
  -v /opt/docker-registry/auth:/auth \
  -v /opt/docker-registry/data:/var/lib/registry \
  -e REGISTRY_AUTH=htpasswd \
  -e REGISTRY_AUTH_HTPASSWD_REALM="Registry Realm" \
  -e REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd \
  registry:2
```

**🔑 客户端登录使用**：
```bash
# 登录私有仓库
docker login localhost:5000
# 输入用户名：admin
# 输入密码：mypassword

# 现在可以推送拉取镜像
docker push localhost:5000/nginx:alpine
```

### 3.3 网络访问控制


**🛡️ IP白名单配置**
```yaml
# config.yml中添加
http:
  addr: :5000
  net: tcp
  host: 0.0.0.0
  # 允许访问的IP段
  x-forwarded-for: true
middleware:
  registry:
    - name: cloudfront
  repository:
    - name: cloudfront
  storage:
    - name: cloudfront
```

---

## 4. 🚢 Harbor企业级仓库


### 4.1 Harbor简介


**🏢 Harbor是什么？**
> Harbor是VMware开源的企业级Docker仓库管理工具，相当于Registry的豪华升级版

**✨ Harbor核心优势**：
- **Web管理界面**：可视化管理镜像和用户
- **RBAC权限控制**：基于角色的访问控制
- **镜像扫描**：集成安全漏洞扫描
- **镜像复制**：多仓库间自动同步
- **审计日志**：详细的操作记录

### 4.2 Harbor快速安装


**📦 安装准备**
```bash
# 下载Harbor离线安装包
wget https://github.com/goharbor/harbor/releases/download/v2.7.0/harbor-offline-installer-v2.7.0.tgz

# 解压安装包
tar xvf harbor-offline-installer-v2.7.0.tgz
cd harbor
```

**⚙️ 配置Harbor**
```yaml
# harbor.yml配置文件关键部分
hostname: harbor.example.com
http:
  port: 80
https:
  port: 443
  certificate: /your/certificate/path
  private_key: /your/private/key/path
harbor_admin_password: Harbor12345
database:
  password: root123
  max_idle_conns: 50
  max_open_conns: 1000
data_volume: /data
```

**🚀 一键安装**：
```bash
# 安装Harbor（包含所有组件）
sudo ./install.sh --with-trivy --with-chartmuseum
```

### 4.3 Harbor Web管理


**🌐 登录Harbor管理界面**
```
访问地址：https://harbor.example.com
默认用户：admin
默认密码：Harbor12345
```

**📋 主要功能模块**：
- **项目管理**：创建和管理镜像项目
- **用户管理**：添加用户和分配权限
- **仓库浏览**：查看镜像列表和标签
- **复制管理**：配置镜像同步规则
- **系统配置**：全局设置和参数调优

### 4.4 Harbor项目和权限


**📁 创建项目示例**
```
项目配置：
- 项目名称：my-app
- 访问级别：私有
- 存储配额：10GB
- 漏洞扫描：启用
```

**👥 用户角色说明**：

| 角色 | **权限说明** |
|------|------------|
| 🎯 **项目管理员** | 完全控制项目，管理成员 |
| 👨‍💻 **开发者** | 推送拉取镜像，查看项目 |
| 👀 **访客** | 只能拉取镜像，只读权限 |
| 🚫 **受限访客** | 仅能查看项目信息 |

---

## 5. 💾 存储与同步机制


### 5.1 存储后端配置


**📁 本地文件系统存储**
```yaml
storage:
  filesystem:
    rootdirectory: /var/lib/registry
    maxthreads: 100
```

**☁️ 对象存储配置（以阿里云OSS为例）**
```yaml
storage:
  oss:
    accesskeyid: your-access-key
    accesskeysecret: your-secret-key
    region: oss-cn-hangzhou
    bucket: my-registry-bucket
    rootdirectory: /docker-registry
```

**🗃️ 存储方案对比**：

| 存储类型 | **优点** | **缺点** | **适用场景** |
|---------|----------|----------|-------------|
| 📂 **本地存储** | 简单快速，无额外费用 | 单点故障，扩展困难 | 小团队，测试环境 |
| ☁️ **云存储** | 高可用，自动扩展 | 有网络延迟，产生费用 | 生产环境，大规模使用 |
| 🔄 **分布式存储** | 高性能，高可用 | 配置复杂，维护成本高 | 大型企业，高并发场景 |

### 5.2 镜像同步机制


**🔄 Harbor复制规则配置**

创建同步规则流程：
```
源仓库配置：
- 名称：production-harbor
- 端点URL：https://prod.harbor.com
- 用户名：replication-user
- 密码：secure-password

同步规则：
- 规则名：sync-to-backup
- 触发条件：手动触发
- 过滤器：nginx*（只同步nginx相关镜像）
- 目标仓库：backup-harbor
```

**⚡ 同步策略类型**：
- **🕐 定时同步**：每天凌晨自动同步
- **📡 事件触发**：镜像推送时自动同步  
- **👆 手动同步**：管理员手动触发
- **🔄 双向同步**：两个仓库互相同步

### 5.3 垃圾清理机制


**🗑️ Registry垃圾清理**
```bash
# 1. 停止Registry服务
docker stop my-registry

# 2. 执行垃圾回收
docker run --rm \
  -v /opt/docker-registry/data:/var/lib/registry \
  registry:2 \
  registry garbage-collect /etc/docker/registry/config.yml

# 3. 重新启动Registry
docker start my-registry
```

**🧹 Harbor自动清理配置**：
- **保留规则**：保留最近30天的镜像
- **清理频率**：每周执行一次  
- **空间阈值**：存储空间超过80%时触发清理

---

## 6. 👥 用户权限管理


### 6.1 Registry基础认证


**🔐 htpasswd文件管理**
```bash
# 添加新用户
htpasswd /opt/docker-registry/auth/htpasswd developer

# 删除用户
htpasswd -D /opt/docker-registry/auth/htpasswd developer

# 查看所有用户
cat /opt/docker-registry/auth/htpasswd
```

### 6.2 Harbor RBAC权限体系


**🏗️ Harbor权限架构**
```
系统管理员
    ├── 用户管理
    ├── 项目创建
    └── 系统配置
        │
        └── 项目级别
            ├── 项目管理员
            │   ├── 成员管理
            │   ├── 权限分配
            │   └── 项目配置
            │
            ├── 开发者
            │   ├── 推送镜像
            │   ├── 拉取镜像
            │   └── 查看日志
            │
            └── 访客
                └── 拉取镜像（只读）
```

**👤 用户创建和权限分配**：
```
创建用户步骤：
1. 登录Harbor管理界面
2. 用户管理 → 新建用户
3. 填写用户信息（用户名、邮箱、密码）
4. 项目 → 成员 → 添加成员
5. 选择用户和分配角色
```

### 6.3 LDAP集成认证


**🏢 企业级用户管理**
```yaml
# Harbor配置LDAP
auth_mode: ldap_auth
ldap:
  url: ldap://ldap.company.com
  searchdn: cn=admin,dc=company,dc=com
  search_password: ldap-password
  basedn: ou=users,dc=company,dc=com
  filter: (objectClass=person)
  uid: uid
  scope: subtree
```

**✅ LDAP集成优势**：
- **统一认证**：使用公司现有账号系统
- **自动同步**：用户信息自动更新
- **安全管理**：集中的密码策略
- **审计跟踪**：统一的登录日志

---

## 7. 📊 运维与监控


### 7.1 健康检查


**💓 Registry健康检查**
```bash
# API健康检查
curl -f http://localhost:5000/v2/ || exit 1

# 存储健康检查  
curl -f http://localhost:5000/v2/_catalog || exit 1

# 详细健康状态
curl http://localhost:5000/debug/health
```

**🩺 Harbor健康监控**
```bash
# Harbor服务状态检查
docker-compose ps

# Harbor组件健康检查
curl -k https://harbor.example.com/api/v2.0/health
```

### 7.2 日志管理


**📝 Registry日志配置**
```yaml
log:
  level: info
  formatter: text
  fields:
    service: registry
    environment: production
  hooks:
    - type: mail
      disabled: false
      levels:
        - panic
      options:
        smtp:
          addr: smtp.company.com:587
          username: alert@company.com
          password: smtp-password
        to: ["admin@company.com"]
        subject: "Registry Alert"
```

**🔍 Harbor审计日志**：
- **操作记录**：谁在什么时候做了什么操作
- **镜像追踪**：镜像的推送、拉取历史
- **权限变更**：用户权限修改记录
- **系统事件**：系统配置变更记录

### 7.3 性能监控


**📈 关键监控指标**

| 监控项 | **正常阈值** | **告警阈值** | **说明** |
|--------|-------------|-------------|----------|
| 🔄 **镜像拉取成功率** | >98% | <95% | 拉取请求成功比例 |
| ⏱️ **平均响应时间** | <2s | >5s | API请求响应时间 |
| 💾 **存储使用率** | <80% | >90% | 存储空间占用率 |
| 🔗 **并发连接数** | <1000 | >1500 | 同时连接数 |
| 📊 **网络带宽** | <100MB/s | >500MB/s | 网络流量使用 |

**📊 Prometheus监控配置**
```yaml
# prometheus.yml
- job_name: 'harbor'
  static_configs:
    - targets: ['harbor.example.com:8080']
  metrics_path: '/api/v2.0/metrics'
  scheme: https
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心概念


```
🔸 私有仓库作用：企业内部镜像存储和分发中心
🔸 Registry vs Harbor：基础版 vs 企业级解决方案
🔸 安全三要素：HTTPS + 认证 + 权限控制
🔸 存储策略：本地存储 vs 云存储的选择
🔸 用户管理：RBAC权限体系的重要性
```

### 8.2 关键理解要点


**🔹 为什么需要私有仓库？**
```
数据安全：
- 企业代码不外泄
- 符合合规要求
- 控制访问权限

网络效率：
- 内网高速访问
- 减少外网依赖
- 节省带宽成本

管理便利：
- 统一镜像管理
- 版本控制
- 自动化集成
```

**🔹 Registry vs Harbor如何选择？**
```
选择Registry适用于：
✅ 小团队使用（<20人）
✅ 基础功能需求
✅ 技术资源有限
✅ 快速搭建测试

选择Harbor适用于：
✅ 企业级使用（>50人）
✅ 需要Web界面
✅ 复杂权限管理
✅ 安全扫描需求
✅ 镜像复制需求
```

**🔹 存储方案选择原则**
```
本地存储适用：
• 小规模团队
• 网络环境封闭
• 预算限制

云存储适用：
• 大规模使用
• 多地点访问
• 高可用要求
```

### 8.3 实际应用指导


**🎯 部署最佳实践**
- **规划先行**：确定用户数量和存储需求
- **安全第一**：必须配置HTTPS和认证
- **备份策略**：制定数据备份和恢复方案
- **监控告警**：建立完善的监控体系
- **版本管理**：制定镜像标签规范

**🔧 运维关键点**
- **定期清理**：避免存储空间耗尽
- **权限审计**：定期检查用户权限
- **安全扫描**：及时发现镜像漏洞
- **性能调优**：根据使用情况调整配置
- **故障恢复**：制定应急处理流程

**⚠️ 常见问题避免**
- **不要**：使用HTTP协议（不安全）
- **不要**：忽略权限管理（安全风险）
- **不要**：不做备份（数据丢失风险）
- **不要**：忽略监控（故障难以发现）
- **不要**：不清理垃圾（存储空间浪费）

### 8.4 进阶学习路径


**📈 技能提升建议**：
1. **熟练掌握**：Registry和Harbor的基本操作
2. **深入理解**：Docker镜像存储原理
3. **实践经验**：搭建生产级私有仓库
4. **安全加固**：掌握企业级安全配置
5. **自动化运维**：集成CI/CD流水线

**🚀 扩展知识点**：
- **分布式存储**：了解Ceph、GlusterFS等
- **容器安全**：镜像安全扫描和策略
- **服务网格**：Istio中的镜像管理
- **云原生**：Kubernetes中的镜像策略
- **DevOps实践**：GitOps和镜像自动化

**核心记忆口诀**：
> 私有仓库保安全，Registry基础Harbor全  
> HTTPS认证权限控，存储监控运维先  
> 企业级别选Harbor，小团队用Registry便  
> 备份清理不可忘，安全第一记心间