---
title: 5ã€APIæƒé™æ§åˆ¶æ‰©å±•
---
## ğŸ“š ç›®å½•

1. [APIç­¾åç®—æ³•](#1-APIç­¾åç®—æ³•)
2. [æ¥å£æƒé™è®¾è®¡](#2-æ¥å£æƒé™è®¾è®¡)
3. [Rate Limitingé™æµ](#3-Rate-Limitingé™æµ)
4. [APIå®‰å…¨ç½‘å…³](#4-APIå®‰å…¨ç½‘å…³)
5. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#5-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” APIç­¾åç®—æ³•


### 1.1 ä»€ä¹ˆæ˜¯APIç­¾å


**ç®€å•ç†è§£**ï¼šAPIç­¾åå°±åƒæ˜¯ç»™æ¯ä¸ªAPIè¯·æ±‚ç›–ä¸€ä¸ª"ä¸“å±å°ç« "ï¼Œç”¨æ¥è¯æ˜è¿™ä¸ªè¯·æ±‚ç¡®å®æ˜¯ä½ å‘å‡ºçš„ï¼Œè€Œä¸æ˜¯åˆ«äººä¼ªé€ çš„ã€‚

```
ç”Ÿæ´»ä¸­çš„ç±»æ¯”ï¼š
å¯„å¿«é€’æ—¶çš„ç­¾å â†’ è¯æ˜åŒ…è£¹æ˜¯ä½ å¯„çš„
é“¶è¡Œè½¬è´¦æ—¶çš„å¯†ç  â†’ è¯æ˜æ“ä½œæ˜¯ä½ åšçš„
APIç­¾å â†’ è¯æ˜è¯·æ±‚æ˜¯ä½ çš„ç¨‹åºå‘çš„
```

**æ ¸å¿ƒä½œç”¨**ï¼š
- **ğŸ›¡ï¸ é˜²ä¼ªé€ **ï¼šåˆ«äººæ— æ³•ä¼ªé€ ä½ çš„è¯·æ±‚
- **ğŸ” é˜²ç¯¡æ”¹**ï¼šè¯·æ±‚åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­è¢«ä¿®æ”¹ä¼šè¢«å‘ç°
- **ğŸ‘¤ èº«ä»½ç¡®è®¤**ï¼šæœåŠ¡å™¨çŸ¥é“æ˜¯è°åœ¨è°ƒç”¨API

### 1.2 ç­¾åå·¥ä½œåŸç†


**åŸºæœ¬æµç¨‹**ï¼š
```
å®¢æˆ·ç«¯å‡†å¤‡è¯·æ±‚ â†’ ç”Ÿæˆç­¾å â†’ å‘é€è¯·æ±‚+ç­¾å â†’ æœåŠ¡å™¨éªŒè¯ç­¾å â†’ è¿”å›ç»“æœ
```

**è¯¦ç»†æ­¥éª¤**ï¼š

```
æ­¥éª¤1ï¼šå‡†å¤‡ç­¾åææ–™
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¯·æ±‚æ–¹æ³•ï¼šPOST                       â”‚
â”‚ è¯·æ±‚è·¯å¾„ï¼š/api/user/create          â”‚
â”‚ è¯·æ±‚å‚æ•°ï¼šname=å¼ ä¸‰&age=25          â”‚
â”‚ æ—¶é—´æˆ³ï¼š1642665600                  â”‚
â”‚ å¯†é’¥ï¼šyour_secret_key               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ­¥éª¤2ï¼šç»„åˆå¾…ç­¾åå­—ç¬¦ä¸²
POST&/api/user/create&age=25&name=å¼ ä¸‰&timestamp=1642665600&key=your_secret_key

æ­¥éª¤3ï¼šç”Ÿæˆç­¾å
SHA256(å¾…ç­¾åå­—ç¬¦ä¸²) = abc123def456...

æ­¥éª¤4ï¼šå‘é€è¯·æ±‚
POST /api/user/create?name=å¼ ä¸‰&age=25&timestamp=1642665600&sign=abc123def456
```

### 1.3 å¸¸ç”¨ç­¾åç®—æ³•


#### ğŸ”¹ HMAC-SHA256ç­¾å


**ç‰¹ç‚¹**ï¼šæœ€å¸¸ç”¨ï¼Œå®‰å…¨æ€§é«˜ï¼Œå®ç°ç®€å•

```java
// ç®€å•ç­¾åç¤ºä¾‹
public class ApiSigner {
    
    // ç”Ÿæˆç­¾å
    public static String generateSignature(Map<String, String> params, String secretKey) {
        // 1. å‚æ•°æ’åº
        TreeMap<String, String> sortedParams = new TreeMap<>(params);
        
        // 2. æ‹¼æ¥å‚æ•°
        StringBuilder signStr = new StringBuilder();
        for (Map.Entry<String, String> entry : sortedParams.entrySet()) {
            signStr.append(entry.getKey()).append("=").append(entry.getValue()).append("&");
        }
        signStr.append("key=").append(secretKey);
        
        // 3. è®¡ç®—ç­¾å
        return hmacSha256(signStr.toString(), secretKey);
    }
    
    // éªŒè¯ç­¾å
    public static boolean verifySignature(Map<String, String> params, String signature, String secretKey) {
        String expectedSign = generateSignature(params, secretKey);
        return signature.equals(expectedSign);
    }
}
```

#### ğŸ”¹ RSAéå¯¹ç§°ç­¾å


**ç‰¹ç‚¹**ï¼šæ›´å®‰å…¨ï¼Œä½†å¤æ‚åº¦æ›´é«˜ï¼Œé€‚åˆé«˜å®‰å…¨è¦æ±‚åœºæ™¯

```
RSAç­¾åæµç¨‹ï¼š
å®¢æˆ·ç«¯ç”¨ç§é’¥ç­¾å â†’ æœåŠ¡å™¨ç”¨å…¬é’¥éªŒè¯

ä¼˜ç‚¹ï¼šç§é’¥ä¸éœ€è¦åœ¨ç½‘ç»œä¼ è¾“
ç¼ºç‚¹ï¼šè®¡ç®—å¤æ‚ï¼Œæ€§èƒ½è¾ƒä½
```

### 1.4 ç­¾åé˜²æŠ¤æœºåˆ¶


#### â° æ—¶é—´æˆ³é˜²é‡æ”¾


**é—®é¢˜**ï¼šæ”»å‡»è€…æˆªè·è¯·æ±‚åé‡å¤å‘é€æ€ä¹ˆåŠï¼Ÿ

**è§£å†³**ï¼šåŠ å…¥æ—¶é—´æˆ³ï¼Œè¿‡æœŸè¯·æ±‚æ‹’ç»

```java
public class TimestampValidator {
    private static final long VALID_TIME_WINDOW = 300; // 5åˆ†é’Ÿæœ‰æ•ˆæœŸ
    
    public static boolean isValidTimestamp(long timestamp) {
        long currentTime = System.currentTimeMillis() / 1000;
        long diff = Math.abs(currentTime - timestamp);
        
        return diff <= VALID_TIME_WINDOW; // 5åˆ†é’Ÿå†…æœ‰æ•ˆ
    }
}
```

#### ğŸ² éšæœºæ•°é˜²é‡æ”¾


**æ›´ä¸¥æ ¼çš„é˜²æŠ¤**ï¼šåŠ å…¥éšæœºæ•°ï¼Œç¡®ä¿æ¯æ¬¡è¯·æ±‚éƒ½ä¸åŒ

```
è¯·æ±‚ç¤ºä¾‹ï¼š
/api/user?name=å¼ ä¸‰&timestamp=1642665600&nonce=abc123&sign=...

æœåŠ¡å™¨é€»è¾‘ï¼š
1. æ£€æŸ¥timestampæ˜¯å¦åœ¨æœ‰æ•ˆæœŸå†…
2. æ£€æŸ¥nonceæ˜¯å¦å·²ç»ä½¿ç”¨è¿‡
3. éªŒè¯ç­¾åæ˜¯å¦æ­£ç¡®
```

---

## 2. ğŸ¯ æ¥å£æƒé™è®¾è®¡


### 2.1 æƒé™è®¾è®¡åŸºæœ¬æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯æ¥å£æƒé™**ï¼šå°±æ˜¯æ§åˆ¶å“ªäº›äººå¯ä»¥è°ƒç”¨å“ªäº›APIæ¥å£ï¼Œå°±åƒé—¨å«æ§åˆ¶è°èƒ½è¿›å…¥å“ªäº›æˆ¿é—´ä¸€æ ·ã€‚

```
æƒé™è®¾è®¡çš„ä¸‰ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š
1. ä½ æ˜¯è°ï¼Ÿ(èº«ä»½è®¤è¯ Authentication)
2. ä½ èƒ½åšä»€ä¹ˆï¼Ÿ(æˆæƒ Authorization)  
3. ä½ åšäº†ä»€ä¹ˆï¼Ÿ(å®¡è®¡ Audit)
```

### 2.2 æƒé™æ¨¡å‹è®¾è®¡


#### ğŸ—ï¸ RBACæƒé™æ¨¡å‹


**åŸºæœ¬æ€è·¯**ï¼šç”¨æˆ·â†’è§’è‰²â†’æƒé™ï¼Œä¸‰å±‚ç»“æ„

```
æƒé™è®¾è®¡ç¤ºä¾‹ï¼š
ç”¨æˆ·è¡¨ï¼šå¼ ä¸‰ã€æå››ã€ç‹äº”
è§’è‰²è¡¨ï¼šç®¡ç†å‘˜ã€æ™®é€šç”¨æˆ·ã€è®¿å®¢
æƒé™è¡¨ï¼šç”¨æˆ·æŸ¥è¯¢ã€ç”¨æˆ·åˆ›å»ºã€ç”¨æˆ·åˆ é™¤

å…³ç³»æ˜ å°„ï¼š
å¼ ä¸‰ â†’ ç®¡ç†å‘˜ â†’ [ç”¨æˆ·æŸ¥è¯¢, ç”¨æˆ·åˆ›å»º, ç”¨æˆ·åˆ é™¤]
æå›› â†’ æ™®é€šç”¨æˆ· â†’ [ç”¨æˆ·æŸ¥è¯¢, ç”¨æˆ·åˆ›å»º]
ç‹äº” â†’ è®¿å®¢ â†’ [ç”¨æˆ·æŸ¥è¯¢]
```

**æ•°æ®åº“è®¾è®¡**ï¼š
```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE users (
    id INT PRIMARY KEY,
    username VARCHAR(50),
    password VARCHAR(100)
);

-- è§’è‰²è¡¨
CREATE TABLE roles (
    id INT PRIMARY KEY,
    role_name VARCHAR(50)
);

-- æƒé™è¡¨
CREATE TABLE permissions (
    id INT PRIMARY KEY,
    permission_name VARCHAR(100),
    api_path VARCHAR(200)
);

-- ç”¨æˆ·è§’è‰²å…³è”è¡¨
CREATE TABLE user_roles (
    user_id INT,
    role_id INT
);

-- è§’è‰²æƒé™å…³è”è¡¨
CREATE TABLE role_permissions (
    role_id INT,
    permission_id INT
);
```

#### ğŸ¨ æ¥å£æƒé™æ³¨è§£


**å®ç°æ€è·¯**ï¼šç”¨æ³¨è§£æ ‡è®°æ¥å£éœ€è¦çš„æƒé™ï¼Œæ‹¦æˆªå™¨è‡ªåŠ¨æ£€æŸ¥

```java
// æƒé™æ³¨è§£å®šä¹‰
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface RequirePermission {
    String value(); // éœ€è¦çš„æƒé™åç§°
}

// æ§åˆ¶å™¨ä½¿ç”¨ç¤ºä¾‹
@RestController
public class UserController {
    
    @RequirePermission("user:query")
    @GetMapping("/api/user/{id}")
    public User getUser(@PathVariable Long id) {
        return userService.findById(id);
    }
    
    @RequirePermission("user:create")
    @PostMapping("/api/user")
    public User createUser(@RequestBody User user) {
        return userService.create(user);
    }
    
    @RequirePermission("user:delete")
    @DeleteMapping("/api/user/{id}")
    public void deleteUser(@PathVariable Long id) {
        userService.deleteById(id);
    }
}
```

### 2.3 æƒé™éªŒè¯å®ç°


#### ğŸ” æƒé™æ‹¦æˆªå™¨


```java
@Component
public class PermissionInterceptor implements HandlerInterceptor {
    
    @Autowired
    private UserService userService;
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler) throws Exception {
        
        // 1. è·å–æ–¹æ³•ä¸Šçš„æƒé™æ³¨è§£
        if (!(handler instanceof HandlerMethod)) {
            return true;
        }
        
        HandlerMethod method = (HandlerMethod) handler;
        RequirePermission annotation = method.getMethodAnnotation(RequirePermission.class);
        
        if (annotation == null) {
            return true; // æ²¡æœ‰æƒé™è¦æ±‚ï¼Œç›´æ¥é€šè¿‡
        }
        
        // 2. è·å–å½“å‰ç”¨æˆ·
        String token = request.getHeader("Authorization");
        if (token == null) {
            response.setStatus(401);
            return false;
        }
        
        Long userId = parseTokenToUserId(token);
        if (userId == null) {
            response.setStatus(401);
            return false;
        }
        
        // 3. æ£€æŸ¥ç”¨æˆ·æƒé™
        boolean hasPermission = userService.hasPermission(userId, annotation.value());
        if (!hasPermission) {
            response.setStatus(403);
            return false;
        }
        
        return true;
    }
}
```

#### ğŸ“Š æƒé™æ£€æŸ¥é€»è¾‘


```java
@Service
public class UserService {
    
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æŒ‡å®šæƒé™
    public boolean hasPermission(Long userId, String requiredPermission) {
        // 1. æŸ¥è¯¢ç”¨æˆ·çš„æ‰€æœ‰è§’è‰²
        List<Role> userRoles = getUserRoles(userId);
        
        // 2. æŸ¥è¯¢è¿™äº›è§’è‰²çš„æ‰€æœ‰æƒé™
        Set<String> userPermissions = new HashSet<>();
        for (Role role : userRoles) {
            List<Permission> rolePermissions = getRolePermissions(role.getId());
            for (Permission permission : rolePermissions) {
                userPermissions.add(permission.getName());
            }
        }
        
        // 3. æ£€æŸ¥æ˜¯å¦åŒ…å«æ‰€éœ€æƒé™
        return userPermissions.contains(requiredPermission);
    }
}
```

---

## 3. âš¡ Rate Limitingé™æµ


### 3.1 ä»€ä¹ˆæ˜¯é™æµ


**ç®€å•ç†è§£**ï¼šé™æµå°±åƒæ˜¯ç»™æ°´é¾™å¤´è£…ä¸ªé˜€é—¨ï¼Œæ§åˆ¶æ°´æµé€Ÿåº¦ï¼Œé˜²æ­¢æ°´ç®¡çˆ†è£‚ã€‚å¯¹APIæ¥è¯´ï¼Œå°±æ˜¯æ§åˆ¶è¯·æ±‚é¢‘ç‡ï¼Œé˜²æ­¢æœåŠ¡å™¨è¢«å‹å®ã€‚

```
ç”Ÿæ´»ä¸­çš„é™æµä¾‹å­ï¼š
ğŸš— é«˜é€Ÿå…¬è·¯æ”¶è´¹ç«™ â†’ æ§åˆ¶è½¦æµé‡ï¼Œé˜²æ­¢æ‹¥å µ
ğŸ¦ é“¶è¡Œæ’é˜Ÿå–å· â†’ æ§åˆ¶æœåŠ¡äººæ•°ï¼Œä¿è¯æœåŠ¡è´¨é‡  
ğŸ« æ¼”å”±ä¼šé™åˆ¶å…¥åœºäººæ•° â†’ é˜²æ­¢åœºåœ°è¶…è½½
```

**ä¸ºä»€ä¹ˆéœ€è¦é™æµ**ï¼š
- **ğŸ›¡ï¸ ä¿æŠ¤æœåŠ¡å™¨**ï¼šé˜²æ­¢æ¶æ„æ”»å‡»æˆ–æ„å¤–æµé‡å†²å‡»
- **âš–ï¸ å…¬å¹³ä½¿ç”¨**ï¼šç¡®ä¿æ‰€æœ‰ç”¨æˆ·éƒ½èƒ½æ­£å¸¸ä½¿ç”¨æœåŠ¡
- **ğŸ’° æ§åˆ¶æˆæœ¬**ï¼šé¿å…å› çªå‘æµé‡äº§ç”Ÿè¿‡é«˜è´¹ç”¨

### 3.2 å¸¸ç”¨é™æµç®—æ³•


#### ğŸª£ ä»¤ç‰Œæ¡¶ç®—æ³•


**å½¢è±¡æ¯”å–»**ï¼šæƒ³è±¡ä¸€ä¸ªæ¡¶ï¼Œä»¥å›ºå®šé€Ÿåº¦å¾€é‡Œé¢æ”¾ä»¤ç‰Œï¼Œæ¯ä¸ªè¯·æ±‚éœ€è¦å–ä¸€ä¸ªä»¤ç‰Œæ‰èƒ½é€šè¿‡ã€‚

```
ä»¤ç‰Œæ¡¶å·¥ä½œæµç¨‹ï¼š
           ä»¤ç‰Œä»¥å›ºå®šé€Ÿç‡åŠ å…¥
                â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ğŸª™ğŸª™ğŸª™ğŸª™ğŸª™ğŸª™ğŸª™ğŸª™        â”‚ â† ä»¤ç‰Œæ¡¶
    â”‚  ğŸª™ğŸª™ğŸª™ğŸª™ğŸª™             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†‘
        è¯·æ±‚æ¥äº†å–ä»¤ç‰Œï¼Œå–åˆ°äº†å°±é€šè¿‡
```

**ä»£ç å®ç°**ï¼š
```java
public class TokenBucketLimiter {
    private final long capacity;        // æ¡¶å®¹é‡
    private final long refillRate;      // ä»¤ç‰Œç”Ÿæˆé€Ÿç‡(æ¯ç§’)
    private long tokens;                // å½“å‰ä»¤ç‰Œæ•°
    private long lastRefillTime;        // ä¸Šæ¬¡è¡¥å……ä»¤ç‰Œæ—¶é—´
    
    public TokenBucketLimiter(long capacity, long refillRate) {
        this.capacity = capacity;
        this.refillRate = refillRate;
        this.tokens = capacity;
        this.lastRefillTime = System.currentTimeMillis();
    }
    
    public synchronized boolean tryAcquire() {
        // 1. è¡¥å……ä»¤ç‰Œ
        refillTokens();
        
        // 2. æ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨ä»¤ç‰Œ
        if (tokens > 0) {
            tokens--;
            return true;    // è·å–æˆåŠŸ
        }
        
        return false;       // æ²¡æœ‰ä»¤ç‰Œï¼Œé™æµ
    }
    
    private void refillTokens() {
        long now = System.currentTimeMillis();
        long timePassed = now - lastRefillTime;
        long tokensToAdd = (timePassed / 1000) * refillRate;
        
        if (tokensToAdd > 0) {
            tokens = Math.min(capacity, tokens + tokensToAdd);
            lastRefillTime = now;
        }
    }
}
```

#### ğŸªŸ æ»‘åŠ¨çª—å£ç®—æ³•


**åŸºæœ¬æ€è·¯**ï¼šç»Ÿè®¡æœ€è¿‘ä¸€æ®µæ—¶é—´å†…çš„è¯·æ±‚æ¬¡æ•°ï¼Œè¶…è¿‡é™åˆ¶å°±æ‹’ç»ã€‚

```
æ»‘åŠ¨çª—å£ç¤ºä¾‹ï¼ˆæ¯åˆ†é’Ÿæœ€å¤š100æ¬¡è¯·æ±‚ï¼‰ï¼š
æ—¶é—´çª—å£ï¼š     [------ 1åˆ†é’Ÿ ------]
å½“å‰æ—¶é—´ï¼š                        â†‘
è¯·æ±‚ç»Ÿè®¡ï¼š     ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´ğŸ”´   95æ¬¡
åˆ¤æ–­ï¼šè¿˜å¯ä»¥æ¥å—5æ¬¡è¯·æ±‚
```

```java
public class SlidingWindowLimiter {
    private final int limit;               // é™åˆ¶æ¬¡æ•°
    private final long windowSizeMs;       // æ—¶é—´çª—å£å¤§å°
    private final Queue<Long> requestTimes; // è¯·æ±‚æ—¶é—´é˜Ÿåˆ—
    
    public SlidingWindowLimiter(int limit, long windowSizeMs) {
        this.limit = limit;
        this.windowSizeMs = windowSizeMs;
        this.requestTimes = new ConcurrentLinkedQueue<>();
    }
    
    public synchronized boolean tryAcquire() {
        long now = System.currentTimeMillis();
        
        // 1. æ¸…ç†è¿‡æœŸçš„è¯·æ±‚è®°å½•
        while (!requestTimes.isEmpty() && 
               now - requestTimes.peek() > windowSizeMs) {
            requestTimes.poll();
        }
        
        // 2. æ£€æŸ¥æ˜¯å¦è¶…è¿‡é™åˆ¶
        if (requestTimes.size() < limit) {
            requestTimes.offer(now);
            return true;    // é€šè¿‡
        }
        
        return false;       // é™æµ
    }
}
```

### 3.3 é™æµç­–ç•¥è®¾è®¡


#### ğŸ¯ åˆ†çº§é™æµç­–ç•¥


**ä¸åŒç”¨æˆ·ä¸åŒé™åˆ¶**ï¼š
```java
public enum UserLevel {
    FREE(100),      // å…è´¹ç”¨æˆ·ï¼šæ¯åˆ†é’Ÿ100æ¬¡
    VIP(1000),      // VIPç”¨æˆ·ï¼šæ¯åˆ†é’Ÿ1000æ¬¡
    PREMIUM(5000);  // é«˜çº§ç”¨æˆ·ï¼šæ¯åˆ†é’Ÿ5000æ¬¡
    
    private final int limitPerMinute;
    
    UserLevel(int limitPerMinute) {
        this.limitPerMinute = limitPerMinute;
    }
    
    public int getLimit() {
        return limitPerMinute;
    }
}

@Service
public class RateLimitService {
    private final Map<String, TokenBucketLimiter> userLimiters = new ConcurrentHashMap<>();
    
    public boolean checkRateLimit(String userId, UserLevel level) {
        String key = userId + "_" + level.name();
        
        TokenBucketLimiter limiter = userLimiters.computeIfAbsent(key, 
            k -> new TokenBucketLimiter(level.getLimit(), level.getLimit() / 60));
        
        return limiter.tryAcquire();
    }
}
```

#### ğŸ“Š é™æµç»Ÿè®¡å’Œç›‘æ§


```java
@Component
public class RateLimitInterceptor implements HandlerInterceptor {
    
    @Autowired
    private RateLimitService rateLimitService;
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler) throws Exception {
        
        // 1. è·å–ç”¨æˆ·ä¿¡æ¯
        String userId = getCurrentUserId(request);
        UserLevel userLevel = getUserLevel(userId);
        
        // 2. æ£€æŸ¥é™æµ
        if (!rateLimitService.checkRateLimit(userId, userLevel)) {
            // 3. è¿”å›é™æµå“åº”
            response.setStatus(429); // Too Many Requests
            response.setContentType("application/json;charset=UTF-8");
            
            String errorMsg = "{\\"error\\": \\"è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•\\", \\"code\\": 429}";
            response.getWriter().write(errorMsg);
            
            return false;
        }
        
        return true;
    }
}
```

---

## 4. ğŸšª APIå®‰å…¨ç½‘å…³


### 4.1 ä»€ä¹ˆæ˜¯APIç½‘å…³


**ç®€å•ç†è§£**ï¼šAPIç½‘å…³å°±åƒæ˜¯ä¸€ä¸ªæ™ºèƒ½é—¨å«ï¼Œæ‰€æœ‰æƒ³è¦è®¿é—®ä½ ç³»ç»Ÿçš„è¯·æ±‚éƒ½å¿…é¡»å…ˆé€šè¿‡å®ƒçš„æ£€æŸ¥ã€‚

```
ä¼ ç»Ÿæ¶æ„ï¼š
å®¢æˆ·ç«¯ â†’ ç›´æ¥è®¿é—®å„ä¸ªæœåŠ¡
é—®é¢˜ï¼šæ¯ä¸ªæœåŠ¡éƒ½è¦å¤„ç†è®¤è¯ã€é™æµç­‰

ç½‘å…³æ¶æ„ï¼š
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
å®¢æˆ·ç«¯ â†’ APIç½‘å…³ â†’ â”‚   æœåŠ¡A     â”‚
                    â”‚   æœåŠ¡B     â”‚
                    â”‚   æœåŠ¡C     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ä¼˜åŠ¿ï¼šç»Ÿä¸€å¤„ç†å®‰å…¨ã€é™æµã€ç›‘æ§ç­‰
```

**ç½‘å…³çš„æ ¸å¿ƒåŠŸèƒ½**ï¼š
- **ğŸ” ç»Ÿä¸€è®¤è¯**ï¼šä¸€ä¸ªåœ°æ–¹å¤„ç†æ‰€æœ‰è®¤è¯é€»è¾‘
- **âš¡ ç»Ÿä¸€é™æµ**ï¼šä¿æŠ¤åç«¯æœåŠ¡ä¸è¢«å‹å®
- **ğŸ“Š ç»Ÿä¸€ç›‘æ§**ï¼šæ”¶é›†æ‰€æœ‰APIè°ƒç”¨æ•°æ®
- **ğŸ”„ è·¯ç”±è½¬å‘**ï¼šå°†è¯·æ±‚è½¬å‘åˆ°æ­£ç¡®çš„æœåŠ¡

### 4.2 ç½‘å…³å®‰å…¨åŠŸèƒ½


#### ğŸ›¡ï¸ è¯·æ±‚è¿‡æ»¤å’ŒéªŒè¯


```java
@Component
public class SecurityGatewayFilter implements GlobalFilter {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        ServerHttpRequest request = exchange.getRequest();
        String path = request.getURI().getPath();
        
        // 1. IPé»‘åå•æ£€æŸ¥
        String clientIp = getClientIp(request);
        if (isBlacklisted(clientIp)) {
            return createErrorResponse(exchange, "IPå·²è¢«æ‹‰é»‘");
        }
        
        // 2. è¯·æ±‚é¢‘ç‡æ£€æŸ¥
        if (!checkRateLimit(clientIp)) {
            return createErrorResponse(exchange, "è¯·æ±‚è¿‡äºé¢‘ç¹");
        }
        
        // 3. TokenéªŒè¯
        String token = request.getHeaders().getFirst("Authorization");
        if (!isValidToken(token)) {
            return createErrorResponse(exchange, "è®¤è¯å¤±è´¥");
        }
        
        // 4. æƒé™æ£€æŸ¥
        String userId = parseUserId(token);
        if (!hasPermission(userId, path)) {
            return createErrorResponse(exchange, "æƒé™ä¸è¶³");
        }
        
        // é€šè¿‡æ‰€æœ‰æ£€æŸ¥ï¼Œç»§ç»­å¤„ç†
        return chain.filter(exchange);
    }
}
```

#### ğŸ“ è¯·æ±‚æ—¥å¿—å’Œå®¡è®¡


```java
@Component  
public class AuditLogFilter implements GlobalFilter {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        ServerHttpRequest request = exchange.getRequest();
        long startTime = System.currentTimeMillis();
        
        return chain.filter(exchange).then(Mono.fromRunnable(() -> {
            // è®°å½•è¯·æ±‚æ—¥å¿—
            long endTime = System.currentTimeMillis();
            AuditLog log = AuditLog.builder()
                .userId(getCurrentUserId(request))
                .method(request.getMethodValue())
                .path(request.getURI().getPath())
                .clientIp(getClientIp(request))
                .responseTime(endTime - startTime)
                .timestamp(new Date())
                .build();
            
            // å¼‚æ­¥ä¿å­˜æ—¥å¿—
            auditLogService.saveAsync(log);
        }));
    }
}
```

### 4.3 ç½‘å…³é…ç½®ç®¡ç†


#### âš™ï¸ è·¯ç”±é…ç½®


```yaml
# application.yml
spring:
  cloud:
    gateway:
      routes:
        # ç”¨æˆ·æœåŠ¡è·¯ç”±
        - id: user-service
          uri: http://localhost:8081
          predicates:
            - Path=/api/user/**
          filters:
            - name: RateLimitFilter
              args:
                limit: 100
                window: 60
        
        # è®¢å•æœåŠ¡è·¯ç”±  
        - id: order-service
          uri: http://localhost:8082
          predicates:
            - Path=/api/order/**
          filters:
            - name: AuthFilter
            - name: RateLimitFilter
              args:
                limit: 200
                window: 60
```

#### ğŸ”§ åŠ¨æ€é…ç½®


```java
@RestController
@RequestMapping("/gateway/config")
public class GatewayConfigController {
    
    @Autowired
    private GatewayConfigService configService;
    
    // åŠ¨æ€æ·»åŠ è·¯ç”±
    @PostMapping("/route")
    public ResponseEntity<String> addRoute(@RequestBody RouteConfig config) {
        try {
            configService.addRoute(config);
            return ResponseEntity.ok("è·¯ç”±æ·»åŠ æˆåŠŸ");
        } catch (Exception e) {
            return ResponseEntity.badRequest().body("è·¯ç”±æ·»åŠ å¤±è´¥ï¼š" + e.getMessage());
        }
    }
    
    // æ›´æ–°é™æµé…ç½®
    @PutMapping("/ratelimit/{serviceId}")
    public ResponseEntity<String> updateRateLimit(@PathVariable String serviceId, 
                                                 @RequestParam int limit) {
        configService.updateRateLimit(serviceId, limit);
        return ResponseEntity.ok("é™æµé…ç½®æ›´æ–°æˆåŠŸ");
    }
}
```

### 4.4 ç½‘å…³ç›‘æ§å’Œå‘Šè­¦


#### ğŸ“Š æ€§èƒ½ç›‘æ§


```java
@Component
public class MetricsCollector {
    private final MeterRegistry meterRegistry;
    private final Counter requestCounter;
    private final Timer responseTimer;
    
    public MetricsCollector(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.requestCounter = Counter.builder("gateway.requests.total")
                .description("ç½‘å…³è¯·æ±‚æ€»æ•°")
                .register(meterRegistry);
        this.responseTimer = Timer.builder("gateway.response.time")
                .description("ç½‘å…³å“åº”æ—¶é—´")
                .register(meterRegistry);
    }
    
    public void recordRequest(String path, String method) {
        requestCounter.increment(
            Tags.of("path", path, "method", method)
        );
    }
    
    public void recordResponseTime(long timeMs, String path) {
        responseTimer.record(timeMs, TimeUnit.MILLISECONDS,
            Tags.of("path", path)
        );
    }
}
```

#### ğŸš¨ å¼‚å¸¸å‘Šè­¦


```java
@Component
public class AlertService {
    
    // é”™è¯¯ç‡è¿‡é«˜å‘Šè­¦
    @EventListener
    public void handleHighErrorRate(HighErrorRateEvent event) {
        if (event.getErrorRate() > 0.05) { // é”™è¯¯ç‡è¶…è¿‡5%
            sendAlert("APIé”™è¯¯ç‡è¿‡é«˜", 
                     String.format("æœåŠ¡%sé”™è¯¯ç‡è¾¾åˆ°%.2f%%", 
                                 event.getServiceName(), 
                                 event.getErrorRate() * 100));
        }
    }
    
    // å“åº”æ—¶é—´è¿‡é•¿å‘Šè­¦
    @EventListener  
    public void handleSlowResponse(SlowResponseEvent event) {
        if (event.getResponseTime() > 5000) { // å“åº”æ—¶é—´è¶…è¿‡5ç§’
            sendAlert("APIå“åº”ç¼“æ…¢",
                     String.format("æ¥å£%så“åº”æ—¶é—´%dms", 
                                 event.getPath(), 
                                 event.getResponseTime()));
        }
    }
    
    private void sendAlert(String title, String message) {
        // å‘é€é‚®ä»¶ã€çŸ­ä¿¡æˆ–é’‰é’‰æ¶ˆæ¯
        alertChannel.send(AlertMessage.builder()
            .title(title)
            .content(message)
            .level(AlertLevel.HIGH)
            .timestamp(LocalDateTime.now())
            .build());
    }
}
```

---

## 5. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 5.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ” APIç­¾åç®—æ³•ï¼š
â€¢ ä½œç”¨ï¼šé˜²æ­¢è¯·æ±‚è¢«ä¼ªé€ å’Œç¯¡æ”¹
â€¢ å¸¸ç”¨ç®—æ³•ï¼šHMAC-SHA256ã€RSA
â€¢ é˜²é‡æ”¾ï¼šæ—¶é—´æˆ³+éšæœºæ•°

ğŸ¯ æ¥å£æƒé™è®¾è®¡ï¼š
â€¢ æ ¸å¿ƒï¼šèº«ä»½è®¤è¯ + æˆæƒéªŒè¯ + æ“ä½œå®¡è®¡
â€¢ æ¨¡å‹ï¼šRBACï¼ˆç”¨æˆ·-è§’è‰²-æƒé™ï¼‰
â€¢ å®ç°ï¼šæ³¨è§£+æ‹¦æˆªå™¨

âš¡ Rate Limitingé™æµï¼š
â€¢ ç›®çš„ï¼šä¿æŠ¤æœåŠ¡å™¨ï¼Œä¿è¯æœåŠ¡è´¨é‡
â€¢ ç®—æ³•ï¼šä»¤ç‰Œæ¡¶ã€æ»‘åŠ¨çª—å£
â€¢ ç­–ç•¥ï¼šåˆ†çº§é™æµã€åŠ¨æ€è°ƒæ•´

ğŸšª APIå®‰å…¨ç½‘å…³ï¼š
â€¢ å®šä½ï¼šç»Ÿä¸€å…¥å£ï¼Œé›†ä¸­ç®¡æ§
â€¢ åŠŸèƒ½ï¼šè®¤è¯ã€é™æµã€ç›‘æ§ã€è·¯ç”±
â€¢ ä»·å€¼ï¼šç®€åŒ–æ¶æ„ï¼Œæå‡å®‰å…¨æ€§
```

### 5.2 å®é™…åº”ç”¨å»ºè®®


**ğŸ”¹ APIç­¾åä½¿ç”¨åœºæ™¯**ï¼š
```
âœ… é€‚ç”¨åœºæ™¯ï¼š
â€¢ å¼€æ”¾APIæ¥å£ï¼ˆå¦‚æ”¯ä»˜ã€åœ°å›¾æœåŠ¡ï¼‰
â€¢ æ•æ„Ÿæ•°æ®ä¼ è¾“ï¼ˆç”¨æˆ·ä¿¡æ¯ã€äº¤æ˜“æ•°æ®ï¼‰
â€¢ éœ€è¦é˜²é‡æ”¾æ”»å‡»çš„åœºæ™¯

âš ï¸ æ³¨æ„äº‹é¡¹ï¼š
â€¢ å¯†é’¥è¦å®šæœŸè½®æ¢
â€¢ ç­¾åç®—æ³•è¦é€‰æ‹©è¶³å¤Ÿå®‰å…¨çš„
â€¢ è¦ç»“åˆHTTPSä½¿ç”¨
```

**ğŸ”¹ é™æµç­–ç•¥é€‰æ‹©**ï¼š
```
ä»¤ç‰Œæ¡¶ç®—æ³•ï¼š
â€¢ ä¼˜ç‚¹ï¼šå…è®¸çªå‘æµé‡ï¼Œå®ç°ç®€å•
â€¢ é€‚ç”¨ï¼šä¸€èˆ¬ä¸šåŠ¡åœºæ™¯ï¼Œç”¨æˆ·ä½“éªŒè¦æ±‚é«˜

æ»‘åŠ¨çª—å£ç®—æ³•ï¼š  
â€¢ ä¼˜ç‚¹ï¼šç»Ÿè®¡ç²¾ç¡®ï¼Œå†…å­˜ä½¿ç”¨å¯æ§
â€¢ é€‚ç”¨ï¼šä¸¥æ ¼é™æµåœºæ™¯ï¼Œèµ„æºç´§å¼ ç¯å¢ƒ
```

**ğŸ”¹ ç½‘å…³éƒ¨ç½²å»ºè®®**ï¼š
```
ğŸ¯ æ¶æ„è®¾è®¡ï¼š
â€¢ ç½‘å…³è¦åšåˆ°é«˜å¯ç”¨ï¼ˆè‡³å°‘2ä¸ªå®ä¾‹ï¼‰
â€¢ è¦æœ‰é™çº§ç­–ç•¥ï¼ˆç½‘å…³æ•…éšœæ—¶çš„å¤‡ç”¨æ–¹æ¡ˆï¼‰
â€¢ é…ç½®è¦æ”¯æŒçƒ­æ›´æ–°ï¼ˆä¸é‡å¯æ›´æ–°è§„åˆ™ï¼‰

ğŸ“Š ç›‘æ§æŒ‡æ ‡ï¼š
â€¢ è¯·æ±‚é‡ã€é”™è¯¯ç‡ã€å“åº”æ—¶é—´
â€¢ é™æµè§¦å‘æ¬¡æ•°ã€è®¤è¯å¤±è´¥æ¬¡æ•°
â€¢ ç½‘å…³è‡ªèº«çš„CPUã€å†…å­˜ä½¿ç”¨æƒ…å†µ
```

### 5.3 å®‰å…¨é˜²æŠ¤æ¸…å•


**â˜‘ï¸ åŸºç¡€é˜²æŠ¤**ï¼š
```
â–¡ APIç­¾åéªŒè¯å·²å¯ç”¨
â–¡ è¯·æ±‚é¢‘ç‡é™åˆ¶å·²é…ç½®
â–¡ å¼‚å¸¸è¯·æ±‚ç›‘æ§å·²éƒ¨ç½²
â–¡ æ•æ„Ÿæ¥å£æƒé™æ£€æŸ¥å·²å®ç°
```

**â˜‘ï¸ é«˜çº§é˜²æŠ¤**ï¼š
```
â–¡ IPé»‘ç™½åå•æœºåˆ¶å·²å»ºç«‹  
â–¡ å¼‚å¸¸æµé‡è‡ªåŠ¨å‘Šè­¦å·²é…ç½®
â–¡ APIè°ƒç”¨æ—¥å¿—å®¡è®¡å·²å¯ç”¨
â–¡ å®‰å…¨äº‹ä»¶åº”æ€¥é¢„æ¡ˆå·²åˆ¶å®š
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- **ç­¾åç®—æ³•ä¿çœŸå®**ï¼šé˜²ä¼ªé€ ï¼Œé˜²ç¯¡æ”¹ï¼ŒåŠ æ—¶é—´æˆ³é˜²é‡æ”¾
- **æƒé™è®¾è®¡è¦åˆ†å±‚**ï¼šç”¨æˆ·è§’è‰²æƒé™ï¼Œæ³¨è§£æ‹¦æˆªå™¨éªŒè¯
- **é™æµä¿æŠ¤å¾ˆé‡è¦**ï¼šä»¤ç‰Œæ¡¶çª—å£æ»‘åŠ¨ï¼Œåˆ†çº§ç­–ç•¥çµæ´»è°ƒ
- **ç½‘å…³ç»Ÿä¸€æ˜¯è¶‹åŠ¿**ï¼šä¸€å¤„ç®¡æ§ï¼Œå…¨å±€ç”Ÿæ•ˆï¼Œç›‘æ§å‘Šè­¦ä¸å¯å°‘