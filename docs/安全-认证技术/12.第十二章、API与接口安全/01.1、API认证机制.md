---
title: 1ã€APIè®¤è¯æœºåˆ¶
---
## ğŸ“š ç›®å½•

1. [APIè®¤è¯åŸºç¡€æ¦‚å¿µ](#1-APIè®¤è¯åŸºç¡€æ¦‚å¿µ)
2. [API Keyè®¤è¯æœºåˆ¶è¯¦è§£](#2-API-Keyè®¤è¯æœºåˆ¶è¯¦è§£)
3. [Tokenç±»å‹ä¸åº”ç”¨](#3-Tokenç±»å‹ä¸åº”ç”¨)
4. [API Keyç”Ÿæˆç­–ç•¥](#4-API-Keyç”Ÿæˆç­–ç•¥)
5. [è®¤è¯æœºåˆ¶å®æˆ˜åº”ç”¨](#5-è®¤è¯æœºåˆ¶å®æˆ˜åº”ç”¨)
6. [å®‰å…¨æœ€ä½³å®è·µ](#6-å®‰å…¨æœ€ä½³å®è·µ)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” APIè®¤è¯åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯APIè®¤è¯ï¼Ÿ


> **APIè®¤è¯**ï¼šå°±åƒé—¨å«æ£€æŸ¥èº«ä»½è¯ä¸€æ ·ï¼Œç¡®è®¤"ä½ æ˜¯è°"æ‰èƒ½è®©ä½ è¿›å…¥ç³»ç»Ÿä½¿ç”¨APIæœåŠ¡
> 
> **é€šä¿—ç†è§£**ï¼šæƒ³è±¡ä½ å»é“¶è¡ŒåŠäº‹ï¼Œå¿…é¡»å…ˆå‡ºç¤ºèº«ä»½è¯è¯æ˜ä½ çš„èº«ä»½ï¼Œé“¶è¡Œç¡®è®¤ä½ æ˜¯æœ¬äººåæ‰èƒ½ä¸ºä½ æä¾›æœåŠ¡

**ğŸ” ä¸ºä»€ä¹ˆéœ€è¦APIè®¤è¯ï¼Ÿ**

```
æ²¡æœ‰è®¤è¯çš„APIï¼ˆå±é™©ï¼‰ï¼š
ä»»ä½•äºº â†’ ç›´æ¥è°ƒç”¨API â†’ è·å–æ•°æ®/æ‰§è¡Œæ“ä½œ
é—®é¢˜ï¼šæ•°æ®æ³„éœ²ã€æ¶æ„æ”»å‡»ã€èµ„æºæ»¥ç”¨

æœ‰è®¤è¯çš„APIï¼ˆå®‰å…¨ï¼‰ï¼š
è°ƒç”¨è€… â†’ æä¾›èº«ä»½å‡­è¯ â†’ APIéªŒè¯èº«ä»½ â†’ å…è®¸/æ‹’ç»è¯·æ±‚
å¥½å¤„ï¼šåªæœ‰æˆæƒç”¨æˆ·æ‰èƒ½è®¿é—®ï¼Œä¿æŠ¤æ•°æ®å’Œç³»ç»Ÿå®‰å…¨
```

### 1.2 APIè®¤è¯çš„æœ¬è´¨ç†è§£


**ğŸ¯ è®¤è¯è§£å†³çš„ä¸‰ä¸ªåŸºæœ¬é—®é¢˜**

| **æ ¸å¿ƒé—®é¢˜** | **è§£å†³æ–¹æ¡ˆ** | **å®é™…æ•ˆæœ** |
|-------------|-------------|-------------|
| **èº«ä»½è¯†åˆ«** | `éªŒè¯è°ƒç”¨è€…èº«ä»½` | `ç¡®è®¤"ä½ æ˜¯è°"` |
| **æƒé™æ§åˆ¶** | `é™åˆ¶è®¿é—®èŒƒå›´` | `æ§åˆ¶"ä½ èƒ½åšä»€ä¹ˆ"` |
| **ä½¿ç”¨ç›‘æ§** | `è®°å½•è°ƒç”¨è¡Œä¸º` | `è¿½è¸ª"ä½ åšäº†ä»€ä¹ˆ"` |

**ğŸ’¡ ç”Ÿæ´»åŒ–ç±»æ¯”ç†è§£**

```
APIè®¤è¯å°±åƒï¼š

é—¨ç¦å¡ç³»ç»Ÿï¼š
- æ¯ä¸ªå‘˜å·¥æœ‰ç‹¬ç‰¹çš„é—¨ç¦å¡ï¼ˆAPI Keyï¼‰
- åˆ·å¡è¿›å…¥åŠå…¬åŒºåŸŸï¼ˆè°ƒç”¨APIï¼‰
- ç³»ç»Ÿè®°å½•è¿›å‡ºæ—¶é—´ï¼ˆè®¿é—®æ—¥å¿—ï¼‰
- ä¸åŒå‘˜å·¥æœ‰ä¸åŒæƒé™ï¼ˆæƒé™æ§åˆ¶ï¼‰

ä¼šå‘˜å¡ç³»ç»Ÿï¼š
- ä¼šå‘˜æœ‰ä¸“å±ä¼šå‘˜å·ï¼ˆAPI Keyï¼‰
- æ¶ˆè´¹æ—¶å‡ºç¤ºä¼šå‘˜å¡ï¼ˆAPIè®¤è¯ï¼‰
- äº«å—ä¼šå‘˜ä¼˜æƒ ï¼ˆAPIæœåŠ¡ï¼‰
- ç§¯åˆ†å’Œæ¶ˆè´¹è®°å½•ï¼ˆä½¿ç”¨ç»Ÿè®¡ï¼‰
```

### 1.3 å¸¸è§APIè®¤è¯æ–¹å¼æ¦‚è§ˆ


**ğŸ›¡ï¸ ä¸»æµè®¤è¯æ–¹å¼å¯¹æ¯”**

```
APIè®¤è¯æ–¹å¼åˆ†ç±»ï¼š

åŸºç¡€è®¤è¯ï¼š
â”œâ”€â”€ æ— è®¤è¯ï¼ˆä¸æ¨èï¼‰
â”œâ”€â”€ åŸºæœ¬è®¤è¯ï¼ˆBasic Authï¼‰
â””â”€â”€ API Keyè®¤è¯ï¼ˆä¸»æµï¼‰

ä»¤ç‰Œè®¤è¯ï¼š  
â”œâ”€â”€ Bearer Token
â”œâ”€â”€ JWTä»¤ç‰Œ
â””â”€â”€ OAuth2ä»¤ç‰Œ

é«˜çº§è®¤è¯ï¼š
â”œâ”€â”€ ç­¾åè®¤è¯
â”œâ”€â”€ è¯ä¹¦è®¤è¯
â””â”€â”€ å¤šå› ç´ è®¤è¯
```

| **è®¤è¯æ–¹å¼** | **å®‰å…¨çº§åˆ«** | **å®ç°å¤æ‚åº¦** | **é€‚ç”¨åœºæ™¯** |
|-------------|-------------|---------------|-------------|
| **API Key** | `ğŸŸ¡ ä¸­ç­‰` | `ğŸŸ¢ ç®€å•` | `å†…éƒ¨ç³»ç»Ÿã€ç¬¬ä¸‰æ–¹é›†æˆ` |
| **Bearer Token** | `ğŸŸ¡ ä¸­ç­‰` | `ğŸŸ¡ ä¸­ç­‰` | `Webåº”ç”¨ã€ç§»åŠ¨åº”ç”¨` |
| **JWTä»¤ç‰Œ** | `ğŸŸ  è¾ƒé«˜` | `ğŸŸ¡ ä¸­ç­‰` | `å¾®æœåŠ¡ã€å•é¡µåº”ç”¨` |
| **OAuth2** | `ğŸŸ  è¾ƒé«˜` | `ğŸ”´ å¤æ‚` | `ç¬¬ä¸‰æ–¹æˆæƒã€å¼€æ”¾å¹³å°` |
| **ç­¾åè®¤è¯** | `ğŸ”´ æœ€é«˜` | `ğŸ”´ å¤æ‚` | `é‡‘èæ”¯ä»˜ã€æ ¸å¿ƒä¸šåŠ¡` |

---

## 2. ğŸ”‘ API Keyè®¤è¯æœºåˆ¶è¯¦è§£


### 2.1 API Keyæ˜¯ä»€ä¹ˆï¼Ÿ


> **API Key**ï¼šå°±åƒä½ çš„ä¸“å±"é€šè¡Œè¯"ï¼Œæ˜¯ä¸€ä¸²ç‹¬ç‰¹çš„å­—ç¬¦ä¸²ï¼Œç”¨æ¥è¯æ˜ä½ æœ‰æƒé™ä½¿ç”¨æŸä¸ªAPIæœåŠ¡
> 
> **é€šä¿—æ¯”å–»**ï¼šå°±åƒä½ çš„é“¶è¡Œå¡å·ï¼Œæ¯ä¸ªäººéƒ½ä¸ä¸€æ ·ï¼Œé“¶è¡Œé€šè¿‡å¡å·è¯†åˆ«ä½ çš„èº«ä»½

**ğŸ” API Keyçš„åŸºæœ¬å½¢å¼**

```
å¸¸è§API Keyæ ¼å¼ç¤ºä¾‹ï¼š

éšæœºå­—ç¬¦ä¸²ï¼š
sk_live_4eC39HqLyjWDarjtT1zdp7dc
AIzaSyDxKJmLp7R8vQ2kN5tY9XcW1bE3fH6gI2j

Base64ç¼–ç ï¼š  
YWRtaW46cGFzc3dvcmQ=

UUIDæ ¼å¼ï¼š
550e8400-e29b-41d4-a716-446655440000

è‡ªå®šä¹‰æ ¼å¼ï¼š
myapp_prod_abc123def456ghi789
```

### 2.2 API Keyè®¤è¯çš„å·¥ä½œåŸç†


**ğŸ”„ API Keyè®¤è¯æµç¨‹**

```
API Keyè®¤è¯å®Œæ•´æµç¨‹ï¼š

ç¬¬ä¸€æ­¥ï¼šè·å–API Key
å¼€å‘è€… â†’ æ³¨å†Œåº”ç”¨ â†’ å¹³å°ç”ŸæˆAPI Key â†’ å¼€å‘è€…ä¿å­˜

ç¬¬äºŒæ­¥ï¼šAPIè°ƒç”¨  
å®¢æˆ·ç«¯ â†’ åœ¨è¯·æ±‚ä¸­æºå¸¦API Key â†’ å‘é€åˆ°APIæœåŠ¡å™¨

ç¬¬ä¸‰æ­¥ï¼šæœåŠ¡ç«¯éªŒè¯
APIæœåŠ¡å™¨ â†’ æå–API Key â†’ éªŒè¯æœ‰æ•ˆæ€§ â†’ è¿”å›ç»“æœ

ç¬¬å››æ­¥ï¼šå“åº”å¤„ç†
éªŒè¯é€šè¿‡ â†’ è¿”å›æ­£å¸¸æ•°æ®
éªŒè¯å¤±è´¥ â†’ è¿”å›é”™è¯¯ä¿¡æ¯
```

**ğŸ’» å®é™…è¯·æ±‚ç¤ºä¾‹**

```bash
# æ–¹å¼1ï¼šåœ¨URLå‚æ•°ä¸­ä¼ é€’
curl "https://api.example.com/users?api_key=sk_live_abc123"

# æ–¹å¼2ï¼šåœ¨è¯·æ±‚å¤´ä¸­ä¼ é€’  
curl -H "X-API-Key: sk_live_abc123" \
     "https://api.example.com/users"

# æ–¹å¼3ï¼šåœ¨Authorizationå¤´ä¸­ä¼ é€’
curl -H "Authorization: ApiKey sk_live_abc123" \
     "https://api.example.com/users"
```

### 2.3 API Keyè®¤è¯çš„ä¼˜ç¼ºç‚¹


**âœ… API Keyè®¤è¯çš„ä¼˜åŠ¿**

```
ç®€å•æ˜“ç”¨ï¼š
- å®ç°ç®€å•ï¼Œå¼€å‘æˆæœ¬ä½
- å®¢æˆ·ç«¯é›†æˆå®¹æ˜“
- è°ƒè¯•å’Œæµ‹è¯•æ–¹ä¾¿

ç®¡ç†ä¾¿æ·ï¼š
- å¯ä»¥éšæ—¶ç”Ÿæˆæ–°çš„Key
- å¯ä»¥è®¾ç½®è¿‡æœŸæ—¶é—´
- å¯ä»¥è½»æ¾æ’¤é”€æƒé™

ç›‘æ§å‹å¥½ï¼š
- å®¹æ˜“è¿½è¸ªAPIä½¿ç”¨æƒ…å†µ
- å¯ä»¥æŒ‰Keyç»Ÿè®¡è°ƒç”¨é‡
- æ–¹ä¾¿åšè®¿é—®æ§åˆ¶å’Œé™æµ
```

**âŒ API Keyè®¤è¯çš„é™åˆ¶**

```
å®‰å…¨æ€§ä¸€èˆ¬ï¼š
- Keyä¸€æ—¦æ³„éœ²ï¼Œä»»ä½•äººéƒ½èƒ½ä½¿ç”¨
- æ²¡æœ‰æ—¶é—´é™åˆ¶ï¼ˆé™¤éè®¾ç½®è¿‡æœŸï¼‰
- éš¾ä»¥åŒºåˆ†å…·ä½“ç”¨æˆ·èº«ä»½

ä¼ è¾“é£é™©ï¼š
- åœ¨URLä¸­å®¹æ˜“è¢«æ—¥å¿—è®°å½•
- å¯èƒ½åœ¨æµè§ˆå™¨å†å²ä¸­æš´éœ²
- ç½‘ç»œä¼ è¾“ä¸­å¯èƒ½è¢«æˆªè·
```

### 2.4 API Keyçš„å­˜å‚¨å’Œä¼ è¾“


**ğŸ” API Keyä¼ è¾“æ–¹å¼å¯¹æ¯”**

```
ä¸‰ç§ä¼ è¾“æ–¹å¼å®‰å…¨æ€§åˆ†æï¼š

1. URLå‚æ•°ä¼ è¾“ï¼ˆä¸æ¨èï¼‰
GET /api/users?api_key=abc123
é£é™©ï¼šæ—¥å¿—è®°å½•ã€æµè§ˆå™¨å†å²ã€ä»£ç†æœåŠ¡å™¨ç¼“å­˜

2. è¯·æ±‚å¤´ä¼ è¾“ï¼ˆæ¨èï¼‰
Headers: X-API-Key: abc123
ä¼˜ç‚¹ï¼šä¸ä¼šè¢«ç¼“å­˜ã€ç›¸å¯¹å®‰å…¨

3. POSTè¯·æ±‚ä½“ï¼ˆé€‚ç”¨äºPOSTè¯·æ±‚ï¼‰
Body: {"api_key": "abc123", "data": "..."}
ä¼˜ç‚¹ï¼šä¸ä¼šå‡ºç°åœ¨URLä¸­ï¼Œå®‰å…¨æ€§è¾ƒå¥½
```

**ğŸ’¾ API Keyå®‰å…¨å­˜å‚¨**

```java
// Javaç¤ºä¾‹ï¼šAPI Keyå®‰å…¨å­˜å‚¨
@Configuration
public class ApiConfig {
    
    // âŒ é”™è¯¯åšæ³•ï¼šç¡¬ç¼–ç åœ¨ä»£ç ä¸­
    private String apiKey = "sk_live_abc123";
    
    // âœ… æ­£ç¡®åšæ³•ï¼šä½¿ç”¨ç¯å¢ƒå˜é‡
    @Value("${app.api.key}")
    private String apiKey;
    
    // âœ… æ­£ç¡®åšæ³•ï¼šä»é…ç½®æ–‡ä»¶è¯»å–
    @ConfigurationProperties(prefix = "app.api")
    public class ApiProperties {
        private String key;
        // getter/setter
    }
}

// application.ymlï¼ˆä¸æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ï¼‰
app:
  api:
    key: ${API_KEY:default_key}
```

---

## 3. ğŸ« Tokenç±»å‹ä¸åº”ç”¨


### 3.1 Tokenæ˜¯ä»€ä¹ˆï¼Ÿç†è§£Tokençš„æœ¬è´¨


> **Token**ï¼šå°±åƒç”µå½±ç¥¨ã€å…¬äº¤ç¥¨ä¸€æ ·çš„"ç¥¨æ®"ï¼Œè¯æ˜ä½ æœ‰æƒé™åšæŸä»¶äº‹æƒ…
> 
> **æ ¸å¿ƒåŒºåˆ«**ï¼šAPI Keyåƒèº«ä»½è¯ï¼ˆé•¿æœŸæœ‰æ•ˆï¼‰ï¼ŒTokenåƒé—¨ç¥¨ï¼ˆä¸´æ—¶æœ‰æ•ˆï¼‰

**ğŸ¯ Tokenä¸API Keyçš„æœ¬è´¨åŒºåˆ«**

```
API Keyï¼ˆèº«ä»½è¯æ¨¡å¼ï¼‰ï¼š
- é•¿æœŸæœ‰æ•ˆï¼Œé™¤éä¸»åŠ¨æ’¤é”€
- ç›´æ¥æ ‡è¯†ç”¨æˆ·æˆ–åº”ç”¨èº«ä»½
- ç®€å•ç›´æ¥ï¼Œæƒé™ç›¸å¯¹å›ºå®š

Tokenï¼ˆé—¨ç¥¨æ¨¡å¼ï¼‰ï¼š
- ä¸´æ—¶æœ‰æ•ˆï¼Œæœ‰æ˜ç¡®è¿‡æœŸæ—¶é—´
- å¯ä»¥æºå¸¦æ›´å¤šæƒé™ä¿¡æ¯
- æ”¯æŒåˆ·æ–°ã€æ’¤é”€ç­‰é«˜çº§åŠŸèƒ½
```

### 3.2 Bearer Tokenè¯¦è§£


**ğŸ”– ä»€ä¹ˆæ˜¯Bearer Tokenï¼Ÿ**

> **Bearer Token**ï¼šBeareræ˜¯"æŒæœ‰è€…"çš„æ„æ€ï¼ŒBearer Tokenå°±æ˜¯"è°æŒæœ‰è°å°±èƒ½ä½¿ç”¨çš„ä»¤ç‰Œ"
> 
> **é€šä¿—ç†è§£**ï¼šå°±åƒç°é‡‘ï¼Œä¸ç®¡è°æ‹¿åˆ°éƒ½èƒ½èŠ±ï¼Œæ‰€ä»¥éœ€è¦å¦¥å–„ä¿ç®¡

**ğŸ’» Bearer Tokenä½¿ç”¨ç¤ºä¾‹**

```bash
# Bearer Tokençš„æ ‡å‡†ç”¨æ³•
curl -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
     "https://api.example.com/profile"

# æ³¨æ„ï¼šBeareråé¢æœ‰ä¸€ä¸ªç©ºæ ¼
Authorization: Bearer <token_value>
```

**ğŸ”§ Bearer Tokenå®ç°**

```java
@RestController
public class ApiController {
    
    @Autowired
    private TokenService tokenService;
    
    @GetMapping("/profile")
    public ResponseEntity<?> getProfile(HttpServletRequest request) {
        // ä»è¯·æ±‚å¤´è·å–Token
        String authHeader = request.getHeader("Authorization");
        
        if (authHeader == null || !authHeader.startsWith("Bearer ")) {
            return ResponseEntity.status(401).body("Missing or invalid token");
        }
        
        // æå–Tokenå€¼ï¼ˆå»æ‰"Bearer "å‰ç¼€ï¼‰
        String token = authHeader.substring(7);
        
        // éªŒè¯Token
        if (!tokenService.validateToken(token)) {
            return ResponseEntity.status(401).body("Invalid or expired token");
        }
        
        // ä»Tokenä¸­æå–ç”¨æˆ·ä¿¡æ¯
        String userId = tokenService.getUserIdFromToken(token);
        UserProfile profile = userService.getProfile(userId);
        
        return ResponseEntity.ok(profile);
    }
}
```

### 3.3 API Key vs Bearer Token è¯¦ç»†å¯¹æ¯”


**ğŸ“Š ä¸¤ç§Tokençš„å®é™…åº”ç”¨åœºæ™¯**

| **å¯¹æ¯”ç»´åº¦** | **API Key** | **Bearer Token** |
|-------------|-------------|------------------|
| **é€‚ç”¨åœºæ™¯** | `æœåŠ¡é—´è°ƒç”¨ã€ç¬¬ä¸‰æ–¹é›†æˆ` | `ç”¨æˆ·ç™»å½•ã€ä¼šè¯ç®¡ç†` |
| **æœ‰æ•ˆæœŸ** | `é•¿æœŸæœ‰æ•ˆï¼ˆæœˆ/å¹´ï¼‰` | `çŸ­æœŸæœ‰æ•ˆï¼ˆå°æ—¶/å¤©ï¼‰` |
| **ä¿¡æ¯æ‰¿è½½** | `ä»…æ ‡è¯†èº«ä»½` | `å¯æ‰¿è½½ç”¨æˆ·ä¿¡æ¯å’Œæƒé™` |
| **ç”Ÿæˆæ—¶æœº** | `æ³¨å†Œæ—¶ç”Ÿæˆï¼Œé•¿æœŸä½¿ç”¨` | `ç™»å½•æ—¶ç”Ÿæˆï¼Œå®šæœŸæ›´æ–°` |
| **åˆ·æ–°æœºåˆ¶** | `æ‰‹åŠ¨é‡æ–°ç”Ÿæˆ` | `æ”¯æŒè‡ªåŠ¨åˆ·æ–°` |
| **æ’¤é”€æ–¹å¼** | `åˆ é™¤Keyè®°å½•` | `è®¾ç½®é»‘åå•æˆ–è¿‡æœŸ` |

**ğŸ¯ å®é™…ä½¿ç”¨å»ºè®®**

```
é€‰æ‹©API Keyçš„åœºæ™¯ï¼š
âœ… ç³»ç»Ÿé—´çš„æœåŠ¡è°ƒç”¨
âœ… ç¬¬ä¸‰æ–¹å¼€å‘è€…æ¥å…¥
âœ… æ‰¹å¤„ç†ä»»åŠ¡ã€å®šæ—¶ä»»åŠ¡
âœ… é•¿æœŸç¨³å®šçš„é›†æˆéœ€æ±‚

é€‰æ‹©Bearer Tokençš„åœºæ™¯ï¼š  
âœ… ç”¨æˆ·ç™»å½•åçš„APIè°ƒç”¨
âœ… ç§»åŠ¨Appã€å•é¡µé¢åº”ç”¨
âœ… éœ€è¦ä¼šè¯ç®¡ç†çš„åœºæ™¯
âœ… éœ€è¦ç»†ç²’åº¦æƒé™æ§åˆ¶
```

### 3.4 Tokençš„ç”Ÿå‘½å‘¨æœŸç®¡ç†


**ğŸ”„ Tokenç”Ÿå‘½å‘¨æœŸå®Œæ•´æµç¨‹**

```
Tokenç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼š

åˆ›å»ºé˜¶æ®µï¼š
ç”¨æˆ·ç™»å½• â†’ éªŒè¯å‡­æ® â†’ ç”ŸæˆToken â†’ è¿”å›ç»™å®¢æˆ·ç«¯

ä½¿ç”¨é˜¶æ®µï¼š
å®¢æˆ·ç«¯æºå¸¦Token â†’ APIéªŒè¯Token â†’ å¤„ç†è¯·æ±‚

åˆ·æ–°é˜¶æ®µï¼š
Tokenå³å°†è¿‡æœŸ â†’ å®¢æˆ·ç«¯è¯·æ±‚åˆ·æ–° â†’ ç”Ÿæˆæ–°Token

é”€æ¯é˜¶æ®µï¼š
ç”¨æˆ·ç™»å‡º â†’ TokenåŠ å…¥é»‘åå• â†’ ç¦æ­¢ç»§ç»­ä½¿ç”¨
Tokenè¿‡æœŸ â†’ è‡ªåŠ¨å¤±æ•ˆ â†’ éœ€è¦é‡æ–°è·å–
```

**ğŸ’» Tokenåˆ·æ–°æœºåˆ¶å®ç°**

```java
@Service
public class TokenService {
    
    private final int ACCESS_TOKEN_EXPIRE = 2 * 60 * 60; // 2å°æ—¶
    private final int REFRESH_TOKEN_EXPIRE = 7 * 24 * 60 * 60; // 7å¤©
    
    public TokenPair generateTokens(String userId) {
        // ç”Ÿæˆè®¿é—®ä»¤ç‰Œï¼ˆçŸ­æœŸï¼‰
        String accessToken = createJwtToken(userId, ACCESS_TOKEN_EXPIRE);
        
        // ç”Ÿæˆåˆ·æ–°ä»¤ç‰Œï¼ˆé•¿æœŸï¼‰
        String refreshToken = createJwtToken(userId, REFRESH_TOKEN_EXPIRE);
        
        return new TokenPair(accessToken, refreshToken);
    }
    
    public TokenPair refreshToken(String refreshToken) {
        if (!validateToken(refreshToken)) {
            throw new SecurityException("Invalid refresh token");
        }
        
        String userId = getUserIdFromToken(refreshToken);
        
        // ç”Ÿæˆæ–°çš„è®¿é—®ä»¤ç‰Œ
        String newAccessToken = createJwtToken(userId, ACCESS_TOKEN_EXPIRE);
        
        return new TokenPair(newAccessToken, refreshToken);
    }
    
    // éªŒè¯Tokenæ˜¯å¦æœ‰æ•ˆ
    public boolean validateToken(String token) {
        try {
            // æ£€æŸ¥Tokenæ ¼å¼å’Œç­¾å
            Claims claims = parseToken(token);
            
            // æ£€æŸ¥æ˜¯å¦åœ¨é»‘åå•ä¸­
            if (tokenBlacklistService.isBlacklisted(token)) {
                return false;
            }
            
            // æ£€æŸ¥è¿‡æœŸæ—¶é—´
            return claims.getExpiration().after(new Date());
            
        } catch (Exception e) {
            return false;
        }
    }
}

// Tokenå¯¹è±¡
@Data
public class TokenPair {
    private String accessToken;
    private String refreshToken;
    private long expiresIn; // è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
}
```

---

## 4. ğŸ”§ API Keyç”Ÿæˆç­–ç•¥


### 4.1 API Keyç”Ÿæˆçš„æ ¸å¿ƒè¦æ±‚


> **API Keyç”Ÿæˆ**ï¼šå°±åƒåˆ¶é€ ç‹¬ä¸€æ— äºŒçš„é’¥åŒ™ï¼Œæ¯æŠŠé’¥åŒ™éƒ½è¦ç‹¬ç‰¹ã€å¤æ‚ã€éš¾ä»¥ä¼ªé€ 
> 
> **ä¸‰ä¸ªé»„é‡‘æ³•åˆ™**ï¼šéšæœºæ€§ï¼ˆä¸å¯é¢„æµ‹ï¼‰ã€å”¯ä¸€æ€§ï¼ˆä¸ä¼šé‡å¤ï¼‰ã€å¤æ‚åº¦ï¼ˆéš¾ä»¥ç ´è§£ï¼‰

**ğŸ¯ API Keyç”Ÿæˆçš„ä¸‰å¤§è¦ç´ **

```
API Keyç”Ÿæˆè¦ç´ ï¼š

éšæœºæ€§ï¼ˆRandomnessï¼‰ï¼š
- ä½¿ç”¨å¼ºéšæœºæ•°ç”Ÿæˆå™¨
- é¿å…ä½¿ç”¨æ—¶é—´ã€ç”¨æˆ·IDç­‰å¯é¢„æµ‹ä¿¡æ¯
- ç¡®ä¿æ— æ³•é€šè¿‡å·²çŸ¥Keyæ¨ç®—å‡ºå…¶ä»–Key

å”¯ä¸€æ€§ï¼ˆUniquenessï¼‰ï¼š
- å…¨å±€å”¯ä¸€ï¼Œæ°¸ä¸é‡å¤
- æ£€æŸ¥æ•°æ®åº“ç¡®ä¿ä¸å†²çª
- å†²çªæ—¶é‡æ–°ç”Ÿæˆ

å¤æ‚åº¦ï¼ˆComplexityï¼‰ï¼š
- è¶³å¤Ÿé•¿åº¦ï¼ˆå»ºè®®32ä½ä»¥ä¸Šï¼‰
- åŒ…å«å¤šç§å­—ç¬¦ç±»å‹
- æŠµæŠ—æš´åŠ›ç ´è§£æ”»å‡»
```

### 4.2 éšæœºæ€§ä¿è¯ç­–ç•¥


**ğŸ² å¼ºéšæœºæ•°ç”Ÿæˆæœ€ä½³å®è·µ**

```java
@Service
public class ApiKeyGenerator {
    
    // âŒ é”™è¯¯åšæ³•ï¼šä½¿ç”¨æ™®é€šRandom
    private Random random = new Random();
    
    // âœ… æ­£ç¡®åšæ³•ï¼šä½¿ç”¨å¯†ç å­¦å®‰å…¨çš„éšæœºæ•°ç”Ÿæˆå™¨
    private SecureRandom secureRandom = new SecureRandom();
    
    /**
     * ç”Ÿæˆé«˜è´¨é‡éšæœºAPI Key
     */
    public String generateApiKey() {
        // ä½¿ç”¨å¯†ç å­¦å®‰å…¨çš„éšæœºæ•°
        byte[] randomBytes = new byte[32];
        secureRandom.nextBytes(randomBytes);
        
        // è½¬æ¢ä¸ºBase64ç¼–ç ï¼Œå»æ‰ç‰¹æ®Šå­—ç¬¦
        String key = Base64.getEncoder().encodeToString(randomBytes)
                .replace("+", "")
                .replace("/", "")
                .replace("=", "");
        
        return "sk_live_" + key;
    }
    
    /**
     * ç”ŸæˆæŒ‡å®šé•¿åº¦çš„éšæœºå­—ç¬¦ä¸²
     */
    public String generateRandomString(int length) {
        String chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
        StringBuilder result = new StringBuilder();
        
        for (int i = 0; i < length; i++) {
            int index = secureRandom.nextInt(chars.length());
            result.append(chars.charAt(index));
        }
        
        return result.toString();
    }
}
```

**âš ï¸ éšæœºæ€§å¸¸è§è¯¯åŒº**

```java
// âŒ å±é™©åšæ³•æ±‡æ€»

// 1. ä½¿ç”¨æ—¶é—´æˆ³ï¼ˆå¯é¢„æµ‹ï¼‰
String apiKey = "key_" + System.currentTimeMillis();

// 2. ä½¿ç”¨ç”¨æˆ·IDï¼ˆå¯æ¨æµ‹ï¼‰  
String apiKey = "user_" + userId + "_" + randomPart;

// 3. ä½¿ç”¨Math.random()ï¼ˆä¼ªéšæœºï¼‰
String apiKey = String.valueOf(Math.random());

// 4. å›ºå®šç§å­çš„Randomï¼ˆå¯é‡ç°ï¼‰
Random random = new Random(12345);

// âœ… æ­£ç¡®åšæ³•
SecureRandom secureRandom = new SecureRandom();
byte[] bytes = new byte[32];
secureRandom.nextBytes(bytes);
String apiKey = Base64.getEncoder().encodeToString(bytes);
```

### 4.3 å”¯ä¸€æ€§ä¿è¯æœºåˆ¶


**ğŸ” ç¡®ä¿API Keyå…¨å±€å”¯ä¸€**

```java
@Service
public class UniqueApiKeyService {
    
    @Autowired
    private ApiKeyRepository apiKeyRepository;
    
    @Autowired  
    private ApiKeyGenerator keyGenerator;
    
    /**
     * ç”Ÿæˆå”¯ä¸€çš„API Key
     */
    public String generateUniqueApiKey() {
        String apiKey;
        int maxAttempts = 10; // æœ€å¤šé‡è¯•10æ¬¡
        
        do {
            apiKey = keyGenerator.generateApiKey();
            maxAttempts--;
            
            if (maxAttempts <= 0) {
                throw new RuntimeException("æ— æ³•ç”Ÿæˆå”¯ä¸€API Keyï¼Œè¯·ç¨åé‡è¯•");
            }
            
        } while (apiKeyRepository.existsByApiKey(apiKey));
        
        return apiKey;
    }
    
    /**
     * æ‰¹é‡ç”Ÿæˆå”¯ä¸€API Key
     */
    public List<String> generateBatchApiKeys(int count) {
        Set<String> keySet = new HashSet<>();
        List<String> existingKeys = apiKeyRepository.findAllActiveKeys();
        
        while (keySet.size() < count) {
            String key = keyGenerator.generateApiKey();
            
            // æ£€æŸ¥æ˜¯å¦ä¸ç°æœ‰Keyå†²çª
            if (!existingKeys.contains(key) && !keySet.contains(key)) {
                keySet.add(key);
            }
        }
        
        return new ArrayList<>(keySet);
    }
}
```

### 4.4 å¤æ‚åº¦è¦æ±‚ä¸å®ç°


**ğŸ” API Keyå¤æ‚åº¦æ ‡å‡†**

| **å¤æ‚åº¦çº§åˆ«** | **é•¿åº¦è¦æ±‚** | **å­—ç¬¦ç±»å‹** | **é€‚ç”¨åœºæ™¯** |
|---------------|-------------|-------------|-------------|
| **åŸºç¡€** | `16-24å­—ç¬¦` | `å­—æ¯+æ•°å­—` | `å†…éƒ¨æµ‹è¯•ã€å¼€å‘ç¯å¢ƒ` |
| **æ ‡å‡†** | `32-40å­—ç¬¦` | `å¤§å°å†™å­—æ¯+æ•°å­—` | `ä¸€èˆ¬ä¸šåŠ¡åº”ç”¨` |
| **é«˜å¼ºåº¦** | `48-64å­—ç¬¦` | `å­—æ¯+æ•°å­—+ç¬¦å·` | `é‡‘èã€æ”¯ä»˜ç­‰æ ¸å¿ƒä¸šåŠ¡` |

**ğŸ’» ä¸åŒå¤æ‚åº¦ç”Ÿæˆå®ç°**

```java
public class ApiKeyComplexityGenerator {
    
    private SecureRandom random = new SecureRandom();
    
    /**
     * åŸºç¡€å¤æ‚åº¦ï¼š32ä½å­—æ¯æ•°å­—
     */
    public String generateBasicKey() {
        String chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
        return generateKey(chars, 32, "ak_basic_");
    }
    
    /**
     * æ ‡å‡†å¤æ‚åº¦ï¼š48ä½å¤§å°å†™å­—æ¯+æ•°å­—
     */
    public String generateStandardKey() {
        String chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
        return generateKey(chars, 48, "ak_std_");
    }
    
    /**
     * é«˜å¼ºåº¦ï¼š64ä½å­—æ¯+æ•°å­—+ç¬¦å·
     */
    public String generateHighSecurityKey() {
        String chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*";
        return generateKey(chars, 64, "ak_sec_");
    }
    
    private String generateKey(String charSet, int length, String prefix) {
        StringBuilder key = new StringBuilder(prefix);
        
        for (int i = 0; i < length; i++) {
            int index = random.nextInt(charSet.length());
            key.append(charSet.charAt(index));
        }
        
        return key.toString();
    }
    
    /**
     * éªŒè¯Keyå¤æ‚åº¦
     */
    public boolean validateKeyComplexity(String apiKey) {
        if (apiKey.length() < 32) {
            return false; // é•¿åº¦ä¸è¶³
        }
        
        boolean hasUpper = apiKey.matches(".*[A-Z].*");
        boolean hasLower = apiKey.matches(".*[a-z].*");
        boolean hasDigit = apiKey.matches(".*\\d.*");
        
        return hasUpper && hasLower && hasDigit;
    }
}
```

### 4.5 API Keyæ ¼å¼è®¾è®¡æœ€ä½³å®è·µ


**ğŸ“ API Keyæ ¼å¼è®¾è®¡åŸåˆ™**

```
API Keyæ ¼å¼è®¾è®¡è¦ç‚¹ï¼š

å‰ç¼€æ ‡è¯†ï¼ˆæ¨èï¼‰ï¼š
sk_live_...    # ç”Ÿäº§ç¯å¢ƒå¯†é’¥
sk_test_...    # æµ‹è¯•ç¯å¢ƒå¯†é’¥  
pk_...         # å…¬å¼€å¯†é’¥
ak_...         # APIå¯†é’¥

ç‰ˆæœ¬æ ‡è¯†ï¼š
v1_ak_...      # ç‰ˆæœ¬1æ ¼å¼
v2_ak_...      # ç‰ˆæœ¬2æ ¼å¼

ç¯å¢ƒæ ‡è¯†ï¼š
prod_...       # ç”Ÿäº§ç¯å¢ƒ
dev_...        # å¼€å‘ç¯å¢ƒ
staging_...    # æµ‹è¯•ç¯å¢ƒ

å®é™…ç¤ºä¾‹ï¼š
sk_live_v2_Np8GK7qP3zX9fR2wY5tV8bE1mQ6dS4cF7hJ9nL3xZ8vB2nM5pQ1rT6yU4wE7rT
```

**ğŸ¯ æ ¼å¼è®¾è®¡ä»£ç å®ç°**

```java
@Component
public class ApiKeyFormatter {
    
    public enum Environment {
        PRODUCTION("prod"),
        STAGING("staging"), 
        DEVELOPMENT("dev");
        
        private String code;
        Environment(String code) { this.code = code; }
        public String getCode() { return code; }
    }
    
    public enum KeyType {
        SECRET("sk"),      // ç§å¯†å¯†é’¥
        PUBLIC("pk"),      // å…¬å¼€å¯†é’¥
        API("ak");         // APIå¯†é’¥
        
        private String prefix;
        KeyType(String prefix) { this.prefix = prefix; }
        public String getPrefix() { return prefix; }
    }
    
    /**
     * ç”Ÿæˆæ ¼å¼åŒ–çš„API Key
     */
    public String formatApiKey(KeyType type, Environment env, String rawKey) {
        return String.format("%s_%s_v1_%s", 
            type.getPrefix(), 
            env.getCode(), 
            rawKey);
    }
    
    /**
     * è§£æAPI Keyä¿¡æ¯
     */
    public ApiKeyInfo parseApiKey(String apiKey) {
        String[] parts = apiKey.split("_");
        
        if (parts.length < 4) {
            throw new IllegalArgumentException("Invalid API Key format");
        }
        
        return ApiKeyInfo.builder()
            .type(parts[0])
            .environment(parts[1])  
            .version(parts[2])
            .key(String.join("_", Arrays.copyOfRange(parts, 3, parts.length)))
            .build();
    }
}

@Data
@Builder
public class ApiKeyInfo {
    private String type;        // sk, pk, ak
    private String environment; // prod, staging, dev
    private String version;     // v1, v2
    private String key;         // å®é™…å¯†é’¥éƒ¨åˆ†
}
```

---

## 5. ğŸ› ï¸ è®¤è¯æœºåˆ¶å®æˆ˜åº”ç”¨


### 5.1 å®Œæ•´APIè®¤è¯ç³»ç»Ÿå®ç°


**ğŸ—ï¸ è®¤è¯ç³»ç»Ÿæ¶æ„**

```
APIè®¤è¯ç³»ç»Ÿå®Œæ•´æ¶æ„ï¼š

å®¢æˆ·ç«¯è¯·æ±‚
    â†“
è¯·æ±‚æ‹¦æˆªå™¨ (éªŒè¯API Key/Token)
    â†“
è®¤è¯æœåŠ¡ (è§£æå’ŒéªŒè¯å‡­è¯)
    â†“
æƒé™æ£€æŸ¥ (éªŒè¯è®¿é—®æƒé™)
    â†“
ä¸šåŠ¡å¤„ç† (æ‰§è¡ŒAPIé€»è¾‘)
    â†“
è¿”å›å“åº”
```

**ğŸ’» Spring Bootè®¤è¯æ‹¦æˆªå™¨**

```java
@Component
public class ApiAuthInterceptor implements HandlerInterceptor {
    
    @Autowired
    private ApiKeyService apiKeyService;
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler) throws Exception {
        
        // è·³è¿‡ä¸éœ€è¦è®¤è¯çš„ç«¯ç‚¹
        if (isPublicEndpoint(request.getRequestURI())) {
            return true;
        }
        
        // æå–API Key
        String apiKey = extractApiKey(request);
        if (apiKey == null) {
            sendError(response, 401, "API Key is required");
            return false;
        }
        
        // éªŒè¯API Key
        ApiKeyInfo keyInfo = apiKeyService.validateApiKey(apiKey);
        if (keyInfo == null) {
            sendError(response, 401, "Invalid API Key");
            return false;
        }
        
        // æ£€æŸ¥æƒé™
        if (!hasPermission(keyInfo, request)) {
            sendError(response, 403, "Access denied");
            return false;
        }
        
        // å°†ç”¨æˆ·ä¿¡æ¯å­˜å…¥è¯·æ±‚ä¸Šä¸‹æ–‡
        request.setAttribute("apiKeyInfo", keyInfo);
        request.setAttribute("userId", keyInfo.getUserId());
        
        return true;
    }
    
    private String extractApiKey(HttpServletRequest request) {
        // 1. ä»Headerä¸­è·å–
        String apiKey = request.getHeader("X-API-Key");
        if (apiKey != null) {
            return apiKey;
        }
        
        // 2. ä»Authorization Headerä¸­è·å–
        String authHeader = request.getHeader("Authorization");
        if (authHeader != null && authHeader.startsWith("ApiKey ")) {
            return authHeader.substring(7);
        }
        
        // 3. ä»URLå‚æ•°ä¸­è·å–ï¼ˆä¸æ¨èï¼Œä»…å…¼å®¹ï¼‰
        return request.getParameter("api_key");
    }
    
    private boolean isPublicEndpoint(String uri) {
        String[] publicPaths = {"/health", "/docs", "/login"};
        return Arrays.stream(publicPaths).anyMatch(uri::startsWith);
    }
    
    private void sendError(HttpServletResponse response, int status, String message) 
            throws IOException {
        response.setStatus(status);
        response.setContentType("application/json");
        response.getWriter().write("{\"error\":\"" + message + "\"}");
    }
}
```

### 5.2 API Keyç®¡ç†æœåŠ¡


**ğŸ”§ API Keyç”Ÿå‘½å‘¨æœŸç®¡ç†**

```java
@Service
@Transactional
public class ApiKeyService {
    
    @Autowired
    private ApiKeyRepository apiKeyRepository;
    
    @Autowired
    private UniqueApiKeyService keyGenerator;
    
    /**
     * ä¸ºç”¨æˆ·åˆ›å»ºAPI Key
     */
    public ApiKeyDto createApiKey(Long userId, ApiKeyRequest request) {
        // æ£€æŸ¥ç”¨æˆ·å·²æœ‰Keyæ•°é‡é™åˆ¶
        long existingCount = apiKeyRepository.countByUserIdAndActive(userId, true);
        if (existingCount >= MAX_KEYS_PER_USER) {
            throw new BusinessException("å·²è¾¾åˆ°API Keyæ•°é‡ä¸Šé™");
        }
        
        // ç”Ÿæˆå”¯ä¸€çš„API Key
        String apiKeyValue = keyGenerator.generateUniqueApiKey();
        
        // åˆ›å»ºAPI Keyè®°å½•
        ApiKey apiKey = ApiKey.builder()
            .userId(userId)
            .keyValue(apiKeyValue)
            .name(request.getName())
            .description(request.getDescription())
            .permissions(request.getPermissions())
            .rateLimit(request.getRateLimit())
            .expiresAt(calculateExpiryDate(request.getValidDays()))
            .active(true)
            .createdAt(LocalDateTime.now())
            .build();
        
        ApiKey saved = apiKeyRepository.save(apiKey);
        
        // è®°å½•åˆ›å»ºæ—¥å¿—
        logApiKeyOperation(saved, "CREATED");
        
        return convertToDto(saved);
    }
    
    /**
     * éªŒè¯API Keyå¹¶è¿”å›Keyä¿¡æ¯
     */
    public ApiKeyInfo validateApiKey(String apiKeyValue) {
        ApiKey apiKey = apiKeyRepository.findByKeyValueAndActive(apiKeyValue, true);
        
        if (apiKey == null) {
            logFailedAttempt(apiKeyValue, "KEY_NOT_FOUND");
            return null;
        }
        
        // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
        if (isExpired(apiKey)) {
            logFailedAttempt(apiKeyValue, "KEY_EXPIRED");
            return null;
        }
        
        // æ£€æŸ¥æ˜¯å¦è¢«æš‚åœ
        if (isSuspended(apiKey)) {
            logFailedAttempt(apiKeyValue, "KEY_SUSPENDED");
            return null;
        }
        
        // æ›´æ–°æœ€åä½¿ç”¨æ—¶é—´
        updateLastUsed(apiKey);
        
        // è®°å½•æˆåŠŸä½¿ç”¨
        logSuccessfulUse(apiKey);
        
        return buildApiKeyInfo(apiKey);
    }
    
    /**
     * æ’¤é”€API Key
     */
    public void revokeApiKey(Long keyId, Long userId) {
        ApiKey apiKey = apiKeyRepository.findByIdAndUserId(keyId, userId);
        if (apiKey == null) {
            throw new NotFoundException("API Key not found");
        }
        
        apiKey.setActive(false);
        apiKey.setRevokedAt(LocalDateTime.now());
        apiKeyRepository.save(apiKey);
        
        logApiKeyOperation(apiKey, "REVOKED");
    }
    
    private boolean isExpired(ApiKey apiKey) {
        return apiKey.getExpiresAt() != null && 
               apiKey.getExpiresAt().isBefore(LocalDateTime.now());
    }
    
    private void updateLastUsed(ApiKey apiKey) {
        // å¼‚æ­¥æ›´æ–°ï¼Œé¿å…å½±å“APIå“åº”æ€§èƒ½
        CompletableFuture.runAsync(() -> {
            apiKeyRepository.updateLastUsed(apiKey.getId(), LocalDateTime.now());
        });
    }
}
```

### 5.3 æƒé™æ§åˆ¶ä¸é™æµ


**ğŸš¦ APIæƒé™æ§åˆ¶å®ç°**

```java
@Component
public class ApiPermissionChecker {
    
    /**
     * æ£€æŸ¥API Keyæ˜¯å¦æœ‰æƒé™è®¿é—®æŒ‡å®šèµ„æº
     */
    public boolean hasPermission(ApiKeyInfo keyInfo, HttpServletRequest request) {
        String endpoint = getEndpoint(request);
        String method = request.getMethod();
        
        // æ£€æŸ¥åŸºæœ¬æƒé™
        if (!hasBasicPermission(keyInfo, endpoint, method)) {
            return false;
        }
        
        // æ£€æŸ¥èµ„æºçº§æƒé™
        return hasResourcePermission(keyInfo, request);
    }
    
    private boolean hasBasicPermission(ApiKeyInfo keyInfo, String endpoint, String method) {
        Set<String> permissions = keyInfo.getPermissions();
        
        // æ£€æŸ¥é€šç”¨æƒé™
        if (permissions.contains("*")) {
            return true; // è¶…çº§æƒé™
        }
        
        // æ£€æŸ¥å…·ä½“ç«¯ç‚¹æƒé™
        String requiredPermission = method.toLowerCase() + ":" + endpoint;
        if (permissions.contains(requiredPermission)) {
            return true;
        }
        
        // æ£€æŸ¥ç«¯ç‚¹ç»„æƒé™
        String endpointGroup = extractEndpointGroup(endpoint);
        String groupPermission = method.toLowerCase() + ":" + endpointGroup + "/*";
        
        return permissions.contains(groupPermission);
    }
    
    private String extractEndpointGroup(String endpoint) {
        // ä¾‹å¦‚ï¼š/api/users/123 -> /api/users
        String[] parts = endpoint.split("/");
        if (parts.length >= 3) {
            return "/" + parts[1] + "/" + parts[2];
        }
        return endpoint;
    }
}

/**
 * APIé™æµå®ç°
 */
@Component
public class ApiRateLimiter {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    /**
     * æ£€æŸ¥æ˜¯å¦è¶…è¿‡é€Ÿç‡é™åˆ¶
     */
    public boolean isRateLimited(String apiKey, int limitPerMinute) {
        String key = "rate_limit:" + apiKey;
        String currentMinute = String.valueOf(System.currentTimeMillis() / 60000);
        String redisKey = key + ":" + currentMinute;
        
        try {
            String countStr = redisTemplate.opsForValue().get(redisKey);
            int currentCount = countStr != null ? Integer.parseInt(countStr) : 0;
            
            if (currentCount >= limitPerMinute) {
                return true; // è¶…è¿‡é™åˆ¶
            }
            
            // å¢åŠ è®¡æ•°
            redisTemplate.opsForValue().increment(redisKey);
            redisTemplate.expire(redisKey, Duration.ofMinutes(2)); // 2åˆ†é’Ÿè¿‡æœŸ
            
            return false;
            
        } catch (Exception e) {
            log.error("Rate limit check failed", e);
            return false; // å¼‚å¸¸æ—¶ä¸é™åˆ¶ï¼Œä¿è¯å¯ç”¨æ€§
        }
    }
    
    /**
     * è·å–å‰©ä½™è°ƒç”¨æ¬¡æ•°
     */
    public int getRemainingCalls(String apiKey, int limitPerMinute) {
        String key = "rate_limit:" + apiKey;
        String currentMinute = String.valueOf(System.currentTimeMillis() / 60000);
        String redisKey = key + ":" + currentMinute;
        
        String countStr = redisTemplate.opsForValue().get(redisKey);
        int currentCount = countStr != null ? Integer.parseInt(countStr) : 0;
        
        return Math.max(0, limitPerMinute - currentCount);
    }
}
```

---

## 6. ğŸ›¡ï¸ å®‰å…¨æœ€ä½³å®è·µ


### 6.1 API Keyå®‰å…¨å­˜å‚¨


**ğŸ” æœåŠ¡ç«¯å®‰å…¨å­˜å‚¨ç­–ç•¥**

```java
@Service
public class SecureApiKeyStorage {
    
    @Autowired
    private PasswordEncoder passwordEncoder; // BCryptåŠ å¯†
    
    /**
     * å­˜å‚¨API Keyï¼ˆåªå­˜å‚¨å“ˆå¸Œå€¼ï¼‰
     */
    public void storeApiKey(ApiKey apiKey) {
        // åªå­˜å‚¨API Keyçš„å“ˆå¸Œå€¼ï¼Œä¸å­˜å‚¨æ˜æ–‡
        String hashedKey = passwordEncoder.encode(apiKey.getKeyValue());
        apiKey.setKeyHash(hashedKey);
        
        // æ¸…é™¤æ˜æ–‡ï¼Œé˜²æ­¢å†…å­˜æ³„éœ²
        apiKey.setKeyValue(null);
        
        apiKeyRepository.save(apiKey);
    }
    
    /**
     * éªŒè¯API Key
     */
    public boolean validateApiKey(String rawApiKey, String storedHash) {
        return passwordEncoder.matches(rawApiKey, storedHash);
    }
    
    /**
     * å®‰å…¨çš„API KeyæŸ¥æ‰¾
     */
    public ApiKey findByApiKey(String rawApiKey) {
        // è·å–æ‰€æœ‰æ´»è·ƒçš„API Keyå“ˆå¸Œå€¼è¿›è¡Œæ¯”å¯¹
        List<ApiKey> activeKeys = apiKeyRepository.findAllActive();
        
        for (ApiKey key : activeKeys) {
            if (passwordEncoder.matches(rawApiKey, key.getKeyHash())) {
                return key;
            }
        }
        
        return null;
    }
}
```

**ğŸ’¾ å®¢æˆ·ç«¯å®‰å…¨å­˜å‚¨æŒ‡å¯¼**

```javascript
// âŒ ä¸å®‰å…¨çš„å­˜å‚¨æ–¹å¼
localStorage.setItem('api_key', 'sk_live_abc123'); // æ˜æ–‡å­˜å‚¨
window.apiKey = 'sk_live_abc123'; // å…¨å±€å˜é‡

// âœ… ç›¸å¯¹å®‰å…¨çš„å­˜å‚¨æ–¹å¼
// 1. ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼ˆNode.jsï¼‰
const API_KEY = process.env.API_KEY;

// 2. ä½¿ç”¨åŠ å¯†å­˜å‚¨ï¼ˆæµè§ˆå™¨ï¼‰
const encryptedKey = CryptoJS.AES.encrypt(apiKey, userPassword).toString();
localStorage.setItem('encrypted_api_key', encryptedKey);

// 3. ä½¿ç”¨å®‰å…¨çš„HTTP-only Cookie
// æœåŠ¡ç«¯è®¾ç½®ï¼š
// Set-Cookie: api_key=sk_live_abc123; HttpOnly; Secure; SameSite=Strict

// âœ… æœ€ä½³å®è·µï¼šä½¿ç”¨çŸ­æœŸTokenä»£æ›¿é•¿æœŸAPI Key
fetch('/auth/login', {
    method: 'POST',
    body: JSON.stringify({ username, password })
}).then(response => response.json())
  .then(data => {
      // è·å–çŸ­æœŸè®¿é—®ä»¤ç‰Œï¼Œé¿å…é•¿æœŸå­˜å‚¨API Key
      sessionStorage.setItem('access_token', data.accessToken);
  });
```

### 6.2 ä¼ è¾“å®‰å…¨ä¿æŠ¤


**ğŸ”’ HTTPSå¼ºåˆ¶ä½¿ç”¨**

```java
@Configuration
@EnableWebSecurity
public class ApiSecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            // å¼ºåˆ¶HTTPS
            .requiresChannel(channel -> 
                channel.anyRequest().requiresSecure())
            
            // è®¾ç½®å®‰å…¨å¤´
            .headers(headers -> headers
                .httpStrictTransportSecurity(hstsConfig -> hstsConfig
                    .maxAgeInSeconds(31536000) // 1å¹´
                    .includeSubdomains(true))
                .contentTypeOptions(Customizer.withDefaults())
                .frameOptions().deny()
            );
        
        return http.build();
    }
}

// Nginxé…ç½®ç¤ºä¾‹
/*
server {
    listen 80;
    server_name api.example.com;
    
    # å¼ºåˆ¶è·³è½¬åˆ°HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name api.example.com;
    
    # SSLé…ç½®
    ssl_certificate /path/to/certificate.crt;
    ssl_certificate_key /path/to/private.key;
    
    # å®‰å…¨å¤´è®¾ç½®
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Content-Type-Options nosniff always;
    add_header X-Frame-Options DENY always;
    
    location /api/ {
        proxy_pass http://backend;
        
        # ä¸è®°å½•åŒ…å«API Keyçš„è¯·æ±‚åˆ°è®¿é—®æ—¥å¿—
        access_log off;
    }
}
*/
```

### 6.3 ç›‘æ§ä¸å‘Šè­¦


**ğŸ“Š APIå®‰å…¨ç›‘æ§**

```java
@Component
public class ApiSecurityMonitor {
    
    @Autowired
    private AlertService alertService;
    
    @EventListener
    public void handleFailedAuth(ApiAuthFailureEvent event) {
        String apiKey = event.getApiKey();
        String clientIp = event.getClientIp();
        
        // ç»Ÿè®¡å¤±è´¥æ¬¡æ•°
        String key = "auth_failures:" + clientIp;
        int failures = incrementFailureCount(key);
        
        // è¾¾åˆ°é˜ˆå€¼æ—¶å‘é€å‘Šè­¦
        if (failures >= 5) {
            alertService.sendAlert(
                "å¯ç–‘APIè®¿é—®", 
                "IP " + clientIp + " åœ¨5åˆ†é’Ÿå†…APIè®¤è¯å¤±è´¥ " + failures + " æ¬¡"
            );
            
            // ä¸´æ—¶å°é”IP
            blockIpTemporarily(clientIp);
        }
    }
    
    @Scheduled(fixedRate = 300000) // æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    public void checkApiKeyUsage() {
        List<ApiKeyUsageStats> stats = apiKeyService.getUsageStats();
        
        for (ApiKeyUsageStats stat : stats) {
            // æ£€æŸ¥å¼‚å¸¸ä½¿ç”¨æ¨¡å¼
            if (isAbnormalUsage(stat)) {
                alertService.sendAlert(
                    "API Keyå¼‚å¸¸ä½¿ç”¨",
                    "API Key " + stat.getKeyId() + " å­˜åœ¨å¼‚å¸¸ä½¿ç”¨æ¨¡å¼"
                );
            }
        }
    }
    
    private boolean isAbnormalUsage(ApiKeyUsageStats stats) {
        // æ£€æŸ¥å¼‚å¸¸æ¨¡å¼
        return stats.getCallsPerMinute() > 1000 || // è¶…é«˜é¢‘è°ƒç”¨
               stats.getErrorRate() > 0.5 ||       // é«˜é”™è¯¯ç‡
               stats.getUniqueIpCount() > 100;     // å¤šIPä½¿ç”¨åŒä¸€Key
    }
}
```

### 6.4 API Keyè½®æ¢ç­–ç•¥


**ğŸ”„ è‡ªåŠ¨è½®æ¢æœºåˆ¶**

```java
@Service
public class ApiKeyRotationService {
    
    @Scheduled(cron = "0 0 2 * * ?") // æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
    public void rotateExpiringKeys() {
        LocalDateTime threshold = LocalDateTime.now().plusDays(7); // 7å¤©å†…è¿‡æœŸ
        List<ApiKey> expiringKeys = apiKeyRepository.findExpiringKeys(threshold);
        
        for (ApiKey key : expiringKeys) {
            if (key.getAutoRotate()) {
                rotateApiKey(key);
            } else {
                notifyUserAboutExpiration(key);
            }
        }
    }
    
    private void rotateApiKey(ApiKey oldKey) {
        try {
            // ç”Ÿæˆæ–°çš„API Key
            String newKeyValue = keyGenerator.generateUniqueApiKey();
            
            // åˆ›å»ºæ–°Keyè®°å½•
            ApiKey newKey = oldKey.copy();
            newKey.setKeyValue(newKeyValue);
            newKey.setExpiresAt(LocalDateTime.now().plusMonths(3));
            newKey.setCreatedAt(LocalDateTime.now());
            
            apiKeyRepository.save(newKey);
            
            // è®¾ç½®é‡å æœŸï¼šæ–°æ—§Keyéƒ½èƒ½ä½¿ç”¨30å¤©
            oldKey.setExpiresAt(LocalDateTime.now().plusDays(30));
            oldKey.setRotatedTo(newKey.getId());
            apiKeyRepository.save(oldKey);
            
            // é€šçŸ¥ç”¨æˆ·æ›´æ–°API Key
            notifyUserAboutRotation(oldKey, newKey);
            
            log.info("API Key rotated successfully. Old: {}, New: {}", 
                oldKey.getId(), newKey.getId());
                
        } catch (Exception e) {
            log.error("Failed to rotate API Key: {}", oldKey.getId(), e);
            alertService.sendAlert("API Keyè½®æ¢å¤±è´¥", 
                "Key ID: " + oldKey.getId() + ", Error: " + e.getMessage());
        }
    }
    
    private void notifyUserAboutRotation(ApiKey oldKey, ApiKey newKey) {
        EmailTemplate template = EmailTemplate.builder()
            .to(oldKey.getUser().getEmail())
            .subject("API Keyå³å°†è¿‡æœŸï¼Œè¯·æ›´æ–°")
            .template("api_key_rotation")
            .variable("oldKeyId", oldKey.getId())
            .variable("newKeyValue", newKey.getKeyValue())
            .variable("expirationDate", oldKey.getExpiresAt())
            .build();
            
        emailService.sendEmail(template);
    }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ APIè®¤è¯æœ¬è´¨ï¼šéªŒè¯è°ƒç”¨è€…èº«ä»½çš„é—¨å«ç³»ç»Ÿ
ğŸ”¸ API Keyç‰¹ç‚¹ï¼šé•¿æœŸæœ‰æ•ˆçš„èº«ä»½æ ‡è¯†ï¼Œç®€å•ä½†éœ€å¦¥å–„ä¿ç®¡
ğŸ”¸ Bearer Tokenï¼šä¸´æ—¶æœ‰æ•ˆçš„è®¿é—®å‡­è¯ï¼Œæ”¯æŒæƒé™æ§åˆ¶
ğŸ”¸ ç”Ÿæˆä¸‰è¦ç´ ï¼šéšæœºæ€§ã€å”¯ä¸€æ€§ã€å¤æ‚åº¦ç¼ºä¸€ä¸å¯
ğŸ”¸ å®‰å…¨ä¼ è¾“ï¼šå¿…é¡»ä½¿ç”¨HTTPSï¼Œæ¨èHeaderä¼ é€’
ğŸ”¸ æƒé™æ§åˆ¶ï¼šæœ€å°æƒé™åŸåˆ™ï¼Œç»†ç²’åº¦è®¿é—®æ§åˆ¶
ğŸ”¸ ç›‘æ§å‘Šè­¦ï¼šå¼‚å¸¸æ£€æµ‹ï¼ŒåŠæ—¶å‘ç°å®‰å…¨å¨èƒ
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ API Key vs Tokençš„é€‰æ‹©é€»è¾‘**
```
API Keyé€‚ç”¨åœºæ™¯ï¼š
- ç³»ç»Ÿé—´è°ƒç”¨ï¼ˆæœåŠ¡åˆ°æœåŠ¡ï¼‰
- é•¿æœŸç¨³å®šçš„é›†æˆéœ€æ±‚
- ç®€å•çš„èº«ä»½è¯†åˆ«éœ€æ±‚

Tokené€‚ç”¨åœºæ™¯ï¼š
- ç”¨æˆ·ä¼šè¯ç®¡ç†ï¼ˆç”¨æˆ·åˆ°ç³»ç»Ÿï¼‰
- éœ€è¦æƒé™ç»†åˆ†çš„åœºæ™¯
- æœ‰å®‰å…¨è¿‡æœŸè¦æ±‚çš„åœºæ™¯
```

**ğŸ”¹ å®‰å…¨æ€§çš„å±‚æ¬¡ç†è§£**
```
ä¼ è¾“å®‰å…¨ï¼šHTTPSåŠ å¯†ï¼Œé˜²æ­¢ç½‘ç»œæˆªè·
å­˜å‚¨å®‰å…¨ï¼šå“ˆå¸Œå­˜å‚¨ï¼Œé˜²æ­¢æ•°æ®æ³„éœ²
ä½¿ç”¨å®‰å…¨ï¼šæƒé™æ§åˆ¶ï¼Œé˜²æ­¢æ»¥ç”¨
ç›‘æ§å®‰å…¨ï¼šå¼‚å¸¸æ£€æµ‹ï¼Œé˜²æ­¢æ”»å‡»
```

**ğŸ”¹ è®¤è¯æœºåˆ¶çš„å®ç°æ€è·¯**
```
æ‹¦æˆªè¯·æ±‚ â†’ æå–å‡­è¯ â†’ éªŒè¯æœ‰æ•ˆæ€§ â†’ æ£€æŸ¥æƒé™ â†’ è®°å½•æ—¥å¿—
æ¯ä¸ªç¯èŠ‚éƒ½è¦è€ƒè™‘å¼‚å¸¸æƒ…å†µå’Œå®‰å…¨é£é™©
```

### 7.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ’¼ ä¼ä¸šåº”ç”¨åœºæ™¯**
- **å¾®æœåŠ¡è®¤è¯**ï¼šæœåŠ¡é—´è°ƒç”¨çš„èº«ä»½éªŒè¯
- **ç¬¬ä¸‰æ–¹é›†æˆ**ï¼šåˆä½œä¼™ä¼´ç³»ç»Ÿæ¥å…¥è®¤è¯
- **ç§»åŠ¨åº”ç”¨**ï¼šAppä¸åç«¯APIçš„è®¤è¯
- **å¼€æ”¾å¹³å°**ï¼šä¸ºå¼€å‘è€…æä¾›APIè®¿é—®æ§åˆ¶

**ğŸ”§ æŠ€æœ¯åº”ç”¨åœºæ™¯**
- **Spring Booté¡¹ç›®**ï¼šé›†æˆè®¤è¯æ‹¦æˆªå™¨å’Œæƒé™æ§åˆ¶
- **ç½‘å…³å±‚è®¤è¯**ï¼šåœ¨APIç½‘å…³ç»Ÿä¸€å¤„ç†è®¤è¯
- **å¾®æœåŠ¡æ¶æ„**ï¼šæœåŠ¡é—´çš„å®‰å…¨é€šä¿¡
- **DevOpså·¥å…·**ï¼šè‡ªåŠ¨åŒ–å·¥å…·çš„APIè®¿é—®æ§åˆ¶

### 7.4 å®‰å…¨æœ€ä½³å®è·µchecklist


**âœ… å¼€å‘é˜¶æ®µ**
```
- ä½¿ç”¨å¼ºéšæœºæ•°ç”ŸæˆAPI Key
- å®ç°API Keyå”¯ä¸€æ€§æ£€æŸ¥
- è®¾ç½®åˆç†çš„å¤æ‚åº¦è¦æ±‚
- æ·»åŠ å‰ç¼€ä¾¿äºç®¡ç†å’Œè¯†åˆ«
```

**âœ… éƒ¨ç½²é˜¶æ®µ**
```
- å¼ºåˆ¶ä½¿ç”¨HTTPSä¼ è¾“
- é…ç½®å®‰å…¨çš„å­˜å‚¨æ–¹å¼
- è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´
- å®ç°æƒé™ç»†åˆ†æ§åˆ¶
```

**âœ… è¿ç»´é˜¶æ®µ**
```
- ç›‘æ§APIè°ƒç”¨å¼‚å¸¸
- è®¾ç½®å‘Šè­¦æœºåˆ¶
- å®šæœŸè½®æ¢API Key
- è®°å½•å’Œå®¡è®¡è®¿é—®æ—¥å¿—
```

### 7.5 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ


**âš ï¸ æ–°æ‰‹å¸¸è§é”™è¯¯**
```
API Keyç¡¬ç¼–ç  â†’ ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶
ä½¿ç”¨å¼±éšæœºæ•° â†’ ä½¿ç”¨SecureRandom
æ˜æ–‡å­˜å‚¨Key â†’ å­˜å‚¨å“ˆå¸Œå€¼
HTTPä¼ è¾“ â†’ å¼ºåˆ¶HTTPS
æƒé™è¿‡å¤§ â†’ æœ€å°æƒé™åŸåˆ™
```

**ğŸ’¡ è¿›é˜¶ä¼˜åŒ–å»ºè®®**
```
å®ç°API Keyåˆ†çº§ç®¡ç†
æ·»åŠ ä½¿ç”¨é¢‘ç‡é™åˆ¶
æ”¯æŒIPç™½åå•åŠŸèƒ½
å®ç°è‡ªåŠ¨è½®æ¢æœºåˆ¶
é›†æˆå¨èƒæ£€æµ‹ç³»ç»Ÿ
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
APIè®¤è¯é—¨å«ä¸¥ï¼Œèº«ä»½éªŒè¯ä¿å®‰å…¨
éšæœºå”¯ä¸€å¤æ‚åº¦ï¼Œä¸‰è¦ç´ ç¼ºä¸€ä¸å…¨
HTTPSä¼ è¾“Headerå­˜ï¼Œæ˜æ–‡ä¼ è¾“é£é™©å¤§
æƒé™æœ€å°ç›‘æ§å…¨ï¼Œå¼‚å¸¸å‘Šè­¦è¦åŠæ—¶
è½®æ¢æ›´æ–°å‹¤ä¿å…»ï¼Œå®‰å…¨ä¹‹è·¯æ­¥æ­¥é«˜
```