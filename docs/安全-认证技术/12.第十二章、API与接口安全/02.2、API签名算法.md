---
title: 2ã€APIç­¾åç®—æ³•
---
## ğŸ“š ç›®å½•

1. [APIç­¾åç®—æ³•åŸºç¡€æ¦‚å¿µ](#1-APIç­¾åç®—æ³•åŸºç¡€æ¦‚å¿µ)
2. [HMAC-SHA256ç­¾åç®—æ³•è¯¦è§£](#2-HMAC-SHA256ç­¾åç®—æ³•è¯¦è§£)
3. [RSAæ•°å­—ç­¾åç®—æ³•](#3-RSAæ•°å­—ç­¾åç®—æ³•)
4. [æ—¶é—´æˆ³é˜²é‡æ”¾æ”»å‡»æœºåˆ¶](#4-æ—¶é—´æˆ³é˜²é‡æ”¾æ”»å‡»æœºåˆ¶)
5. [ç­¾åéªŒè¯å®Œæ•´æµç¨‹](#5-ç­¾åéªŒè¯å®Œæ•´æµç¨‹)
6. [å®é™…åº”ç”¨ä¸æœ€ä½³å®è·µ](#6-å®é™…åº”ç”¨ä¸æœ€ä½³å®è·µ)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” APIç­¾åç®—æ³•åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯APIç­¾å


**é€šä¿—ç†è§£**ï¼šAPIç­¾åå°±åƒæ˜¯ç»™ä½ çš„è¯·æ±‚**åŠ ç›–å°ç« **ï¼Œè¯æ˜è¿™ä¸ªè¯·æ±‚ç¡®å®æ˜¯ä½ å‘é€çš„ï¼Œæ²¡æœ‰è¢«åˆ«äººç¯¡æ”¹è¿‡ã€‚

```
ç”Ÿæ´»ä¸­çš„ç±»æ¯”ï¼š
é“¶è¡Œè½¬è´¦æ—¶éœ€è¦è¾“å…¥å¯†ç  â†’ è¯æ˜æ˜¯ä½ æœ¬äººæ“ä½œ
å¯„å¿«é€’éœ€è¦ç­¾åç¡®è®¤ â†’ è¯æ˜åŒ…è£¹å†…å®¹æ— è¯¯
APIç­¾å â†’ è¯æ˜è¯·æ±‚æ¥æºå¯ä¿¡ä¸”æœªè¢«ç¯¡æ”¹
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦APIç­¾å


**ğŸ¯ æ ¸å¿ƒé—®é¢˜è§£å†³**ï¼š
- **èº«ä»½éªŒè¯** - ç¡®è®¤è¯·æ±‚ç¡®å®æ¥è‡ªåˆæ³•çš„å®¢æˆ·ç«¯
- **æ•°æ®å®Œæ•´æ€§** - ä¿è¯ä¼ è¾“è¿‡ç¨‹ä¸­æ•°æ®æ²¡æœ‰è¢«ä¿®æ”¹
- **é˜²é‡æ”¾æ”»å‡»** - é¿å…æ¶æ„ç”¨æˆ·é‡å¤å‘é€ç›¸åŒè¯·æ±‚
- **é˜²æŠµèµ–** - æä¾›ä¸å¯å¦è®¤çš„æ“ä½œè¯æ®

**ç°å®åœºæ™¯ä¸¾ä¾‹**ï¼š
```
âŒ æ²¡æœ‰ç­¾åçš„APIï¼š
å®¢æˆ·ç«¯ â†’ "è½¬è´¦100å…ƒç»™å¼ ä¸‰" â†’ æœåŠ¡å™¨
é—®é¢˜ï¼šä»»ä½•äººéƒ½å¯ä»¥å‘é€è¿™ä¸ªè¯·æ±‚

âœ… æœ‰ç­¾åçš„APIï¼š
å®¢æˆ·ç«¯ â†’ "è½¬è´¦100å…ƒç»™å¼ ä¸‰ + æ•°å­—ç­¾åxyz123" â†’ æœåŠ¡å™¨
å¥½å¤„ï¼šæœåŠ¡å™¨å¯ä»¥éªŒè¯è¯·æ±‚çš„çœŸå®æ€§å’Œå®Œæ•´æ€§
```

### 1.3 ç­¾åç®—æ³•çš„åŸºæœ¬å·¥ä½œåŸç†


**æ ¸å¿ƒæ€è·¯**ï¼šä½¿ç”¨**å¯†é’¥**å’Œ**ç®—æ³•**å¯¹è¯·æ±‚æ•°æ®ç”Ÿæˆå”¯ä¸€çš„**æŒ‡çº¹**

```
ç­¾åç”Ÿæˆè¿‡ç¨‹ï¼š
åŸå§‹æ•°æ® + å¯†é’¥ â†’ [ç­¾åç®—æ³•] â†’ æ•°å­—ç­¾å

éªŒè¯è¿‡ç¨‹ï¼š
æ”¶åˆ°çš„æ•°æ® + å¯†é’¥ â†’ [ç›¸åŒç®—æ³•] â†’ é‡æ–°ç”Ÿæˆç­¾å â†’ å¯¹æ¯”æ˜¯å¦ä¸€è‡´
```

**ğŸ”„ å®Œæ•´æµç¨‹å›¾ç¤º**ï¼š
```
å®¢æˆ·ç«¯                           æœåŠ¡å™¨ç«¯
  |                               |
  | 1.å‡†å¤‡è¯·æ±‚æ•°æ®                  |
  |   data = "amount=100&to=å¼ ä¸‰"  |
  |                               |
  | 2.ä½¿ç”¨å¯†é’¥ç”Ÿæˆç­¾å               |
  |   sign = HMAC(data, secret)   |
  |                               |
  | 3.å‘é€æ•°æ®+ç­¾å                 |
  |---[data + sign]-------------->|
  |                               | 4.æ¥æ”¶è¯·æ±‚
  |                               | 5.ç”¨ç›¸åŒå¯†é’¥é‡æ–°è®¡ç®—ç­¾å
  |                               |   expected = HMAC(data, secret)
  |                               | 6.å¯¹æ¯”ç­¾åæ˜¯å¦ä¸€è‡´
  |<--[success/failure]-----------|   if(sign == expected) âœ…
```

---

## 2. ğŸ”’ HMAC-SHA256ç­¾åç®—æ³•è¯¦è§£


### 2.1 ä»€ä¹ˆæ˜¯HMAC-SHA256


**HMAC** = `Hash-based Message Authentication Code`ï¼ˆåŸºäºå“ˆå¸Œçš„æ¶ˆæ¯è®¤è¯ç ï¼‰
**SHA256** = ä¸€ç§å®‰å…¨çš„å“ˆå¸Œç®—æ³•

**é€šä¿—è§£é‡Š**ï¼šHMAC-SHA256å°±æ˜¯ç”¨SHA256å“ˆå¸Œç®—æ³•ï¼Œç»“åˆå¯†é’¥ï¼Œç»™ä½ çš„æ•°æ®ç”Ÿæˆä¸€ä¸ª**å›ºå®šé•¿åº¦çš„æŒ‡çº¹**ã€‚

### 2.2 HMAC-SHA256çš„ç‰¹ç‚¹


| ç‰¹æ€§ | **è¯´æ˜** | **å®é™…æ„ä¹‰** |
|------|---------|-------------|
| `ğŸ” éœ€è¦å¯†é’¥` | `å¿…é¡»çŸ¥é“å¯†é’¥æ‰èƒ½ç”Ÿæˆç­¾å` | `ä¿è¯åªæœ‰åˆæ³•ç”¨æˆ·èƒ½ç­¾å` |
| `ğŸ“ å›ºå®šé•¿åº¦` | `æ— è®ºæ•°æ®å¤šé•¿ï¼Œç­¾åéƒ½æ˜¯64ä½` | `ä¾¿äºå¤„ç†å’Œå­˜å‚¨` |
| `âš¡ å•å‘æ€§` | `æ— æ³•ä»ç­¾åæ¨å‡ºåŸå§‹æ•°æ®` | `ä¿æŠ¤æ•°æ®éšç§` |
| `ğŸ¯ é›ªå´©æ•ˆåº”` | `æ•°æ®å¾®å°å˜åŒ–å¯¼è‡´ç­¾åå®Œå…¨ä¸åŒ` | `ç¡®ä¿æ•°æ®å®Œæ•´æ€§` |

### 2.3 HMAC-SHA256å®ç°ç¤ºä¾‹


**Javaå®ç°**ï¼š
```java
public class HmacSha256Demo {
    // ç”ŸæˆHMAC-SHA256ç­¾å
    public static String generateSignature(String data, String secret) {
        try {
            Mac mac = Mac.getInstance("HmacSHA256");
            SecretKeySpec keySpec = new SecretKeySpec(secret.getBytes(), "HmacSHA256");
            mac.init(keySpec);
            
            byte[] signBytes = mac.doFinal(data.getBytes());
            return bytesToHex(signBytes);
        } catch (Exception e) {
            throw new RuntimeException("ç­¾åç”Ÿæˆå¤±è´¥", e);
        }
    }
    
    // å­—èŠ‚æ•°ç»„è½¬åå…­è¿›åˆ¶å­—ç¬¦ä¸²
    private static String bytesToHex(byte[] bytes) {
        StringBuilder result = new StringBuilder();
        for (byte b : bytes) {
            result.append(String.format("%02x", b));
        }
        return result.toString();
    }
}
```

**Pythonå®ç°**ï¼š
```python
import hmac
import hashlib

def generate_signature(data, secret):
    """ç”ŸæˆHMAC-SHA256ç­¾å"""
    # å°†å­—ç¬¦ä¸²è½¬ä¸ºå­—èŠ‚
    message = data.encode('utf-8')
    secret_bytes = secret.encode('utf-8')
    
    # ç”Ÿæˆç­¾å
    signature = hmac.new(secret_bytes, message, hashlib.sha256)
    return signature.hexdigest()

# ä½¿ç”¨ç¤ºä¾‹
data = "amount=100&to=å¼ ä¸‰&timestamp=1642694400"
secret = "my_secret_key_123"
sign = generate_signature(data, secret)
print(f"ç­¾åç»“æœ: {sign}")
```

### 2.4 HMAC-SHA256å®é™…åº”ç”¨åœºæ™¯


**ğŸ“± APIè¯·æ±‚ç­¾å**ï¼š
```
GET /api/transfer?amount=100&to=å¼ ä¸‰&timestamp=1642694400&sign=abc123def

è®¡ç®—è¿‡ç¨‹ï¼š
1. å‡†å¤‡å¾…ç­¾åå­—ç¬¦ä¸²: "amount=100&to=å¼ ä¸‰&timestamp=1642694400"
2. ä½¿ç”¨å¯†é’¥: "my_secret_key"  
3. ç”Ÿæˆç­¾å: HMAC-SHA256("amount=100&to=å¼ ä¸‰&timestamp=1642694400", "my_secret_key")
4. ç»“æœ: abc123def456...
```

**ğŸ” ç­¾åéªŒè¯è¿‡ç¨‹**ï¼š
```
æœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚å:

1. æå–å‚æ•°ï¼šamount=100, to=å¼ ä¸‰, timestamp=1642694400
2. æŒ‰ç›¸åŒè§„åˆ™æ‹¼æ¥ï¼šå¾…ç­¾åå­—ç¬¦ä¸²
3. ç”¨ä¿å­˜çš„å¯†é’¥é‡æ–°è®¡ç®—ç­¾å
4. å¯¹æ¯”è®¡ç®—ç»“æœä¸æ”¶åˆ°çš„signå‚æ•°
5. ä¸€è‡´ â†’ éªŒè¯é€šè¿‡ âœ…
   ä¸ä¸€è‡´ â†’ æ‹’ç»è¯·æ±‚ âŒ
```

---

## 3. ğŸ”‘ RSAæ•°å­—ç­¾åç®—æ³•


### 3.1 ä»€ä¹ˆæ˜¯RSAç­¾å


**RSAç­¾å**ä½¿ç”¨**éå¯¹ç§°åŠ å¯†**çš„æ€è·¯ï¼šç”¨**ç§é’¥ç­¾å**ï¼Œ**å…¬é’¥éªŒè¯**ã€‚

**ä¸HMACçš„åŒºåˆ«**ï¼š
```
HMAC-SHA256ï¼ˆå¯¹ç§°ï¼‰ï¼š
å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ â†’ å…±äº«ç›¸åŒå¯†é’¥ â†’ éƒ½èƒ½ç”Ÿæˆå’ŒéªŒè¯ç­¾å

RSAç­¾åï¼ˆéå¯¹ç§°ï¼‰ï¼š  
å®¢æˆ·ç«¯ â†’ ç§é’¥ç­¾å â†’ åªèƒ½ç”Ÿæˆç­¾å
æœåŠ¡å™¨ â†’ å…¬é’¥éªŒè¯ â†’ åªèƒ½éªŒè¯ç­¾å
```

### 3.2 RSAç­¾åçš„ä¼˜åŠ¿


**ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- **å¯†é’¥åˆ†ç¦»** - ç­¾åå¯†é’¥å’ŒéªŒè¯å¯†é’¥ä¸åŒ
- **ä¸å¯ä¼ªé€ ** - æ²¡æœ‰ç§é’¥æ— æ³•ç”Ÿæˆæœ‰æ•ˆç­¾å  
- **å…¬é’¥å…¬å¼€** - ä»»ä½•äººéƒ½å¯ä»¥éªŒè¯ç­¾åçœŸå®æ€§
- **ä¸å¯å¦è®¤** - ç­¾åè€…æ— æ³•å¦è®¤è‡ªå·±çš„æ“ä½œ

**é€‚ç”¨åœºæ™¯**ï¼š
```
âœ… å¤šæ–¹éªŒè¯ï¼šå¤šä¸ªæœåŠ¡éƒ½éœ€è¦éªŒè¯ç­¾å
âœ… ç¬¬ä¸‰æ–¹é›†æˆï¼šå¤–éƒ¨ç³»ç»Ÿéœ€è¦éªŒè¯ä½ çš„ç­¾å
âœ… å®¡è®¡è¿½è¸ªï¼šéœ€è¦æ˜ç¡®çš„æ“ä½œè´£ä»»äºº
âŒ é«˜æ€§èƒ½è¦æ±‚ï¼šRSAè®¡ç®—ç›¸å¯¹è¾ƒæ…¢
```

### 3.3 RSAç­¾åå®ç°ç¤ºä¾‹


**Javaå®ç°**ï¼š
```java
public class RsaSignatureDemo {
    
    // ç”ŸæˆRSAç­¾å
    public static String signWithRSA(String data, PrivateKey privateKey) {
        try {
            Signature signature = Signature.getInstance("SHA256withRSA");
            signature.initSign(privateKey);
            signature.update(data.getBytes("UTF-8"));
            
            byte[] signBytes = signature.sign();
            return Base64.getEncoder().encodeToString(signBytes);
        } catch (Exception e) {
            throw new RuntimeException("RSAç­¾åå¤±è´¥", e);
        }
    }
    
    // éªŒè¯RSAç­¾å
    public static boolean verifyRSA(String data, String signStr, PublicKey publicKey) {
        try {
            Signature signature = Signature.getInstance("SHA256withRSA");
            signature.initVerify(publicKey);
            signature.update(data.getBytes("UTF-8"));
            
            byte[] signBytes = Base64.getDecoder().decode(signStr);
            return signature.verify(signBytes);
        } catch (Exception e) {
            return false;
        }
    }
}
```

### 3.4 HMAC vs RSAé€‰æ‹©æŒ‡å—


| åœºæ™¯ | **æ¨èç®—æ³•** | **ç†ç”±** |
|------|-------------|----------|
| `å†…éƒ¨ç³»ç»ŸAPI` | `HMAC-SHA256` | `æ€§èƒ½å¥½ï¼Œå®ç°ç®€å•` |
| `å¯¹å¤–å¼€æ”¾API` | `RSAç­¾å` | `å¯†é’¥ç®¡ç†å®‰å…¨` |
| `é«˜å¹¶å‘åœºæ™¯` | `HMAC-SHA256` | `è®¡ç®—é€Ÿåº¦å¿«` |
| `å¤šæ–¹éªŒè¯` | `RSAç­¾å` | `å…¬é’¥å¯ä»¥å…¬å¼€åˆ†äº«` |
| `ç§»åŠ¨ç«¯APP` | `HMAC-SHA256` | `å‡å°‘è®¡ç®—è´Ÿæ‹…` |

---

## 4. â° æ—¶é—´æˆ³é˜²é‡æ”¾æ”»å‡»æœºåˆ¶


### 4.1 ä»€ä¹ˆæ˜¯é‡æ”¾æ”»å‡»


**é‡æ”¾æ”»å‡»**ï¼šæ¶æ„ç”¨æˆ·**æˆªè·åˆæ³•è¯·æ±‚**ï¼Œç„¶å**é‡å¤å‘é€**è¿™ä¸ªè¯·æ±‚æ¥è·å–éæ³•æ”¶ç›Šã€‚

**ğŸš¨ æ”»å‡»åœºæ™¯ä¸¾ä¾‹**ï¼š
```
æ­£å¸¸æµç¨‹ï¼š
ç”¨æˆ·A â†’ "è½¬è´¦100å…ƒç»™B" â†’ é“¶è¡Œç³»ç»Ÿ â†’ è½¬è´¦æˆåŠŸ

é‡æ”¾æ”»å‡»ï¼š
é»‘å®¢ â†’ æˆªè·ä¸Šé¢çš„è¯·æ±‚ â†’ é‡å¤å‘é€100æ¬¡ â†’ é“¶è¡Œç³»ç»Ÿæ‰§è¡Œ100æ¬¡è½¬è´¦ï¼
```

**ç°å®ä¸­çš„ç±»æ¯”**ï¼š
- ç”µå½±ç¥¨åªèƒ½ç”¨ä¸€æ¬¡ï¼Œé˜²æ­¢é‡å¤å…¥åœº
- éªŒè¯ç æœ‰æ—¶æ•ˆæ€§ï¼Œé˜²æ­¢è¢«å¤šæ¬¡ä½¿ç”¨
- APIè¯·æ±‚åŠ æ—¶é—´æˆ³ï¼Œé˜²æ­¢è¢«é‡å¤æ‰§è¡Œ

### 4.2 æ—¶é—´æˆ³é˜²æŠ¤åŸç†


**æ ¸å¿ƒæ€è·¯**ï¼šç»™æ¯ä¸ªè¯·æ±‚åŠ ä¸Š**æ—¶é—´æˆ³**ï¼ŒæœåŠ¡å™¨åªæ¥å—**æ—¶é—´çª—å£å†…**çš„è¯·æ±‚ã€‚

**ğŸ”„ é˜²æŠ¤æµç¨‹**ï¼š
```
å®¢æˆ·ç«¯å‘é€è¯·æ±‚ï¼š
æ•°æ® = "amount=100&timestamp=1642694400"
ç­¾å = HMAC(æ•°æ®, å¯†é’¥)

æœåŠ¡å™¨éªŒè¯ï¼š
1. æ£€æŸ¥ç­¾åæ˜¯å¦æ­£ç¡® âœ“
2. æ£€æŸ¥æ—¶é—´æˆ³æ˜¯å¦åœ¨å…è®¸èŒƒå›´å†… âœ“
3. æ£€æŸ¥è¿™ä¸ªè¯·æ±‚æ˜¯å¦å·²ç»å¤„ç†è¿‡ âœ“
```

### 4.3 æ—¶é—´çª—å£éªŒè¯å®ç°


**æ—¶é—´çª—å£è®¾ç½®**ï¼š
```
å½“å‰æ—¶é—´ï¼š2024-01-15 10:30:00
æ—¶é—´çª—å£ï¼šÂ±300ç§’ï¼ˆ5åˆ†é’Ÿï¼‰

æœ‰æ•ˆæ—¶é—´èŒƒå›´ï¼š
æœ€æ—©ï¼š2024-01-15 10:25:00
æœ€æ™šï¼š2024-01-15 10:35:00

è¶…å‡ºèŒƒå›´çš„è¯·æ±‚ â†’ ç›´æ¥æ‹’ç»
```

**Javaå®ç°ç¤ºä¾‹**ï¼š
```java
public class TimestampValidator {
    private static final long TIME_WINDOW = 300; // 5åˆ†é’Ÿæ—¶é—´çª—å£
    
    // éªŒè¯æ—¶é—´æˆ³æ˜¯å¦åœ¨æœ‰æ•ˆèŒƒå›´å†…
    public static boolean isValidTimestamp(long requestTimestamp) {
        long currentTime = System.currentTimeMillis() / 1000; // å½“å‰æ—¶é—´æˆ³(ç§’)
        long timeDiff = Math.abs(currentTime - requestTimestamp);
        
        return timeDiff <= TIME_WINDOW;
    }
    
    // å®Œæ•´çš„è¯·æ±‚éªŒè¯
    public static boolean validateRequest(String data, String signature, String secret) {
        // 1. ä»æ•°æ®ä¸­æå–æ—¶é—´æˆ³
        long timestamp = extractTimestamp(data);
        
        // 2. éªŒè¯æ—¶é—´æˆ³æœ‰æ•ˆæ€§
        if (!isValidTimestamp(timestamp)) {
            System.out.println("è¯·æ±‚è¶…æ—¶ï¼Œæ‹’ç»å¤„ç†");
            return false;
        }
        
        // 3. éªŒè¯ç­¾å
        String expectedSignature = HmacUtil.generate(data, secret);
        if (!signature.equals(expectedSignature)) {
            System.out.println("ç­¾åéªŒè¯å¤±è´¥");
            return false;
        }
        
        return true;
    }
}
```

### 4.4 é˜²é‡æ”¾æ”»å‡»çš„å®Œæ•´æ–¹æ¡ˆ


**ğŸ›¡ï¸ å¤šå±‚é˜²æŠ¤æœºåˆ¶**ï¼š

**æ–¹æ¡ˆ1ï¼šæ—¶é—´æˆ³ + éšæœºæ•°**
```
è¯·æ±‚å‚æ•°ï¼š
- timestamp: 1642694400
- nonce: abc123def456 (éšæœºå­—ç¬¦ä¸²)
- ç­¾åï¼šHMAC(æ‰€æœ‰å‚æ•°, å¯†é’¥)

æœåŠ¡å™¨éªŒè¯ï¼š
1. æ—¶é—´æˆ³åœ¨æœ‰æ•ˆèŒƒå›´å†… âœ“
2. nonceå€¼ä¹‹å‰æ²¡æœ‰ä½¿ç”¨è¿‡ âœ“  
3. ç­¾åéªŒè¯é€šè¿‡ âœ“
```

**æ–¹æ¡ˆ2ï¼šè¯·æ±‚åºåˆ—å·**
```java
public class RequestValidator {
    // å­˜å‚¨å·²å¤„ç†çš„è¯·æ±‚IDï¼ˆå¯ç”¨Rediså®ç°ï¼‰
    private Set<String> processedRequests = new HashSet<>();
    
    public boolean validateRequest(String requestId, String data, String signature) {
        // 1. æ£€æŸ¥è¯·æ±‚æ˜¯å¦å·²å¤„ç†
        if (processedRequests.contains(requestId)) {
            return false; // é‡å¤è¯·æ±‚
        }
        
        // 2. éªŒè¯ç­¾åå’Œæ—¶é—´æˆ³
        if (!validateSignatureAndTimestamp(data, signature)) {
            return false;
        }
        
        // 3. è®°å½•å·²å¤„ç†çš„è¯·æ±‚
        processedRequests.add(requestId);
        return true;
    }
}
```

---

## 5. âœ… ç­¾åéªŒè¯å®Œæ•´æµç¨‹


### 5.1 æ ‡å‡†ç­¾åç”Ÿæˆæµç¨‹


**ğŸ“‹ å®¢æˆ·ç«¯ç­¾åæ­¥éª¤**ï¼š

**æ­¥éª¤1ï¼šå‚æ•°æ’åº**
```
åŸå§‹å‚æ•°ï¼š
- amount: 100
- to: å¼ ä¸‰  
- timestamp: 1642694400

æŒ‰é”®åæ’åºï¼š
amount=100&timestamp=1642694400&to=å¼ ä¸‰
```

**æ­¥éª¤2ï¼šæ‹¼æ¥å¾…ç­¾åå­—ç¬¦ä¸²**
```java
public class SignatureBuilder {
    public static String buildSignString(Map<String, String> params) {
        // 1. æ’é™¤ç­¾åå­—æ®µæœ¬èº«
        params.remove("sign");
        
        // 2. æŒ‰é”®åæ’åº
        TreeMap<String, String> sortedParams = new TreeMap<>(params);
        
        // 3. æ‹¼æ¥é”®å€¼å¯¹
        StringBuilder sb = new StringBuilder();
        for (Map.Entry<String, String> entry : sortedParams.entrySet()) {
            if (sb.length() > 0) {
                sb.append("&");
            }
            sb.append(entry.getKey()).append("=").append(entry.getValue());
        }
        
        return sb.toString();
    }
}
```

**æ­¥éª¤3ï¼šç”Ÿæˆç­¾å**
```java
// å®Œæ•´çš„ç­¾åç”Ÿæˆç¤ºä¾‹
public class ApiClient {
    private String secretKey = "my_secret_key_123";
    
    public String callApi(String endpoint, Map<String, String> params) {
        // 1. æ·»åŠ æ—¶é—´æˆ³
        params.put("timestamp", String.valueOf(System.currentTimeMillis() / 1000));
        
        // 2. æ„å»ºå¾…ç­¾åå­—ç¬¦ä¸²
        String signString = SignatureBuilder.buildSignString(params);
        
        // 3. ç”Ÿæˆç­¾å
        String signature = HmacUtil.generate(signString, secretKey);
        params.put("sign", signature);
        
        // 4. å‘é€è¯·æ±‚
        return HttpUtil.post(endpoint, params);
    }
}
```

### 5.2 æœåŠ¡å™¨ç«¯éªŒè¯æµç¨‹


**ğŸ” éªŒè¯æ­¥éª¤è¯¦è§£**ï¼š

```java
public class ApiValidator {
    
    public boolean validateRequest(HttpServletRequest request) {
        try {
            // 1. æå–æ‰€æœ‰å‚æ•°
            Map<String, String> params = extractParams(request);
            String receivedSign = params.get("sign");
            
            // 2. éªŒè¯å¿…è¦å‚æ•°
            if (!hasRequiredParams(params)) {
                return false;
            }
            
            // 3. éªŒè¯æ—¶é—´æˆ³
            if (!isValidTimestamp(params.get("timestamp"))) {
                return false;
            }
            
            // 4. é‡æ–°è®¡ç®—ç­¾å
            String expectedSign = calculateSignature(params);
            
            // 5. å¯¹æ¯”ç­¾å
            return receivedSign.equals(expectedSign);
            
        } catch (Exception e) {
            log.error("ç­¾åéªŒè¯å¼‚å¸¸", e);
            return false;
        }
    }
    
    private String calculateSignature(Map<String, String> params) {
        String signString = SignatureBuilder.buildSignString(params);
        return HmacUtil.generate(signString, getSecretKey());
    }
}
```

### 5.3 é”™è¯¯å¤„ç†å’Œå®‰å…¨å»ºè®®


**âš ï¸ å¸¸è§éªŒè¯å¤±è´¥åŸå› **ï¼š

| é”™è¯¯ç±»å‹ | **åŸå› ** | **è§£å†³æ–¹æ¡ˆ** |
|----------|---------|-------------|
| `ç­¾åä¸åŒ¹é…` | `å‚æ•°é¡ºåºã€ç¼–ç æ ¼å¼ä¸ä¸€è‡´` | `ç»Ÿä¸€ç­¾åè§„åˆ™ï¼Œæ³¨æ„URLç¼–ç ` |
| `æ—¶é—´æˆ³è¿‡æœŸ` | `å®¢æˆ·ç«¯æ—¶é—´ä¸å‡†ç¡®` | `å…è®¸é€‚å½“æ—¶é—´åå·®` |
| `é‡å¤è¯·æ±‚` | `ç½‘ç»œé‡è¯•å¯¼è‡´` | `å®ç°å¹‚ç­‰æ€§å¤„ç†` |
| `å¯†é’¥é”™è¯¯` | `ä½¿ç”¨äº†é”™è¯¯çš„å¯†é’¥` | `ç¡®è®¤å¯†é’¥é…ç½®æ­£ç¡®` |

**ğŸ›¡ï¸ å®‰å…¨å»ºè®®**ï¼š

```
âœ… DOï¼ˆæ¨èåšæ³•ï¼‰ï¼š
- ä½¿ç”¨HTTPSä¼ è¾“ï¼Œé˜²æ­¢å¯†é’¥æ³„éœ²
- å®šæœŸæ›´æ¢ç­¾åå¯†é’¥
- è®°å½•æ‰€æœ‰éªŒè¯å¤±è´¥çš„è¯·æ±‚
- å¯¹å¼‚å¸¸è¯·æ±‚è¿›è¡Œé™æµ

âŒ DON'Tï¼ˆé¿å…åšæ³•ï¼‰ï¼š
- ä¸è¦åœ¨å®¢æˆ·ç«¯ç¡¬ç¼–ç å¯†é’¥
- ä¸è¦ä½¿ç”¨è¿‡é•¿çš„æ—¶é—´çª—å£
- ä¸è¦å¿½ç•¥ç­¾åéªŒè¯å¤±è´¥
- ä¸è¦åœ¨æ—¥å¿—ä¸­è®°å½•æ•æ„Ÿä¿¡æ¯
```

---

## 6. ğŸš€ å®é™…åº”ç”¨ä¸æœ€ä½³å®è·µ


### 6.1 å¾®ä¿¡æ”¯ä»˜ç­¾åæ¡ˆä¾‹


**å¾®ä¿¡æ”¯ä»˜çš„ç­¾åè§„åˆ™**ï¼š
```
æ­¥éª¤1ï¼šå‚æ•°æ’åºæ‹¼æ¥
appId=wx123&body=å•†å“æè¿°&mchId=å•†æˆ·å·&timestamp=1642694400

æ­¥éª¤2ï¼šåŠ ä¸Šå¯†é’¥
å¾…ç­¾åå­—ç¬¦ä¸² + "&key=" + å•†æˆ·å¯†é’¥

æ­¥éª¤3ï¼šMD5/SHA256ç­¾å
sign = MD5(å¾…ç­¾åå­—ç¬¦ä¸²)

æ­¥éª¤4ï¼šæ·»åŠ åˆ°è¯·æ±‚ä¸­
æœ€ç»ˆè¯·æ±‚åŒ…å«æ‰€æœ‰å‚æ•° + signå­—æ®µ
```

### 6.2 é˜¿é‡Œäº‘APIç­¾åæ¡ˆä¾‹


**é˜¿é‡Œäº‘çš„ç­¾åæ–¹æ³•**ï¼š
```java
public class AliyunSignature {
    public static String sign(String method, String uri, Map<String, String> params, String accessKeySecret) {
        // 1. æ„é€ è§„èŒƒåŒ–è¯·æ±‚å­—ç¬¦ä¸²
        String canonicalizedQueryString = buildQueryString(params);
        
        // 2. æ„é€ å¾…ç­¾åå­—ç¬¦ä¸²  
        String stringToSign = method + "&" + 
                             percentEncode(uri) + "&" +
                             percentEncode(canonicalizedQueryString);
        
        // 3. HMAC-SHA1ç­¾å
        return hmacSha1(stringToSign, accessKeySecret + "&");
    }
}
```

### 6.3 å¼€å‘ä¸­çš„æœ€ä½³å®è·µ


**ğŸ”§ å®ç°å»ºè®®**ï¼š

**1. ç»Ÿä¸€ç­¾åå·¥å…·ç±»**
```java
public class SignatureUtil {
    // æ”¯æŒå¤šç§ç­¾åç®—æ³•
    public static String sign(String data, String key, SignType type) {
        switch (type) {
            case HMAC_SHA256:
                return hmacSha256(data, key);
            case RSA:
                return rsaSign(data, loadPrivateKey(key));
            default:
                throw new IllegalArgumentException("ä¸æ”¯æŒçš„ç­¾åç±»å‹");
        }
    }
    
    // ç»Ÿä¸€éªŒè¯æ¥å£
    public static boolean verify(String data, String signature, String key, SignType type) {
        String expected = sign(data, key, type);
        return signature.equals(expected);
    }
}
```

**2. é…ç½®åŒ–ç®¡ç†**
```yaml
# application.yml
api:
  signature:
    algorithm: HMAC_SHA256
    time-window: 300  # 5åˆ†é’Ÿ
    secret-key: ${API_SECRET_KEY:default_key}
    enable-replay-protection: true
```

**3. ä¸­é—´ä»¶é›†æˆ**
```java
@Component
public class SignatureInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
        // åªå¯¹éœ€è¦ç­¾åçš„æ¥å£è¿›è¡ŒéªŒè¯
        if (needSignature(request)) {
            return validateSignature(request, response);
        }
        return true;
    }
    
    private boolean validateSignature(HttpServletRequest request, HttpServletResponse response) {
        try {
            // æå–å‚æ•°å¹¶éªŒè¯
            Map<String, String> params = getParameters(request);
            boolean valid = signatureService.validate(params);
            
            if (!valid) {
                response.setStatus(401);
                response.getWriter().write("ç­¾åéªŒè¯å¤±è´¥");
                return false;
            }
            
            return true;
        } catch (Exception e) {
            log.error("ç­¾åéªŒè¯å¼‚å¸¸", e);
            return false;
        }
    }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ APIç­¾åæœ¬è´¨ï¼šä¸ºè¯·æ±‚æ•°æ®ç”Ÿæˆå”¯ä¸€æŒ‡çº¹ï¼Œç¡®ä¿æ¥æºå¯ä¿¡å’Œæ•°æ®å®Œæ•´
ğŸ”¸ HMAC-SHA256ï¼šå¯¹ç§°åŠ å¯†ç­¾åï¼Œæ€§èƒ½å¥½ï¼Œé€‚åˆå†…éƒ¨ç³»ç»Ÿ
ğŸ”¸ RSAç­¾åï¼šéå¯¹ç§°ç­¾åï¼Œç§é’¥ç­¾åå…¬é’¥éªŒè¯ï¼Œé€‚åˆå¼€æ”¾åœºæ™¯
ğŸ”¸ æ—¶é—´æˆ³é˜²é‡æ”¾ï¼šé™åˆ¶è¯·æ±‚æ—¶æ•ˆæ€§ï¼Œé˜²æ­¢æ¶æ„é‡å¤æäº¤
ğŸ”¸ å®Œæ•´éªŒè¯æµç¨‹ï¼šå‚æ•°æ’åºâ†’æ‹¼æ¥å­—ç¬¦ä¸²â†’ç”Ÿæˆç­¾åâ†’å¯¹æ¯”éªŒè¯
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ç­¾åç®—æ³•é€‰æ‹©**
```
å†…éƒ¨APIï¼šHMAC-SHA256 â†’ æ€§èƒ½å¥½ï¼Œå®ç°ç®€å•
å¯¹å¤–APIï¼šRSAç­¾å â†’ å®‰å…¨æ€§é«˜ï¼Œå¯†é’¥éš”ç¦»
é«˜å¹¶å‘ï¼šHMAC-SHA256 â†’ è®¡ç®—å¼€é”€å°  
å¤šæ–¹éªŒè¯ï¼šRSAç­¾å â†’ å…¬é’¥å¯å…¬å¼€
```

**ğŸ”¹ é˜²é‡æ”¾æ”»å‡»ç­–ç•¥**
```
æ—¶é—´æˆ³ï¼šè®¾ç½®åˆç†æ—¶é—´çª—å£(5-15åˆ†é’Ÿ)
éšæœºæ•°ï¼šæ¯æ¬¡è¯·æ±‚ç”Ÿæˆå”¯ä¸€nonce
è¯·æ±‚IDï¼šè®°å½•å·²å¤„ç†è¯·æ±‚ï¼Œé¿å…é‡å¤
å¹‚ç­‰æ€§ï¼šç›¸åŒè¯·æ±‚å¤šæ¬¡æ‰§è¡Œç»“æœä¸€è‡´
```

**ğŸ”¹ å®‰å…¨å®æ–½è¦ç‚¹**
```
å¯†é’¥ç®¡ç†ï¼šå®šæœŸæ›´æ¢ï¼Œå®‰å…¨å­˜å‚¨
ä¼ è¾“å®‰å…¨ï¼šå¿…é¡»ä½¿ç”¨HTTPS
å¼‚å¸¸å¤„ç†ï¼šè®°å½•å¤±è´¥æ—¥å¿—ï¼Œé™æµä¿æŠ¤
å‚æ•°è§„èŒƒï¼šç»Ÿä¸€æ’åºè§„åˆ™ï¼Œæ³¨æ„ç¼–ç 
```

### 7.3 å®é™…å¼€å‘æŒ‡å¯¼


**ğŸ“Š ç­¾åæ–¹æ¡ˆå¯¹æ¯”**ï¼š

| ç‰¹æ€§ | **HMAC-SHA256** | **RSAç­¾å** |
|------|----------------|-------------|
| `å®‰å…¨æ€§` | `é«˜ï¼ˆéœ€ä¿æŠ¤å¯†é’¥ï¼‰` | `æé«˜ï¼ˆç§é’¥ç‹¬æœ‰ï¼‰` |
| `æ€§èƒ½` | `å¿«` | `ç›¸å¯¹è¾ƒæ…¢` |
| `å®ç°å¤æ‚åº¦` | `ç®€å•` | `ä¸­ç­‰` |
| `å¯†é’¥ç®¡ç†` | `éœ€è¦å®‰å…¨å…±äº«` | `å…¬ç§é’¥åˆ†ç¦»` |
| `é€‚ç”¨åœºæ™¯` | `å†…éƒ¨ç³»ç»ŸAPI` | `å¼€æ”¾å¹³å°API` |

**ğŸ› ï¸ å¼€å‘æ£€æŸ¥æ¸…å•**ï¼š
```
âœ… ç­¾åç®—æ³•é€‰æ‹©åˆé€‚
âœ… å‚æ•°æ’åºè§„åˆ™ç»Ÿä¸€
âœ… æ—¶é—´æˆ³éªŒè¯å®ç°
âœ… é‡æ”¾æ”»å‡»é˜²æŠ¤
âœ… é”™è¯¯æ—¥å¿—è®°å½•å®Œå–„
âœ… HTTPSä¼ è¾“ä¿æŠ¤
âœ… å¯†é’¥å®‰å…¨ç®¡ç†
âœ… å¼‚å¸¸æƒ…å†µé™æµ
```

**ğŸ¯ æ€§èƒ½ä¼˜åŒ–å»ºè®®**ï¼š
```
ç¼“å­˜ç­–ç•¥ï¼šç¼“å­˜è®¡ç®—ç»“æœï¼Œé¿å…é‡å¤è®¡ç®—
æ‰¹é‡éªŒè¯ï¼šå¤šä¸ªè¯·æ±‚æ‰¹é‡å¤„ç†ç­¾åéªŒè¯  
å¼‚æ­¥éªŒè¯ï¼šéå…³é”®åœºæ™¯å¯å¼‚æ­¥éªŒè¯ç­¾å
ç¡¬ä»¶åŠ é€Ÿï¼šä½¿ç”¨ç¡¬ä»¶åŠ å¯†æ¨¡å—æå‡æ€§èƒ½
```

### 7.4 æ•…éšœæ’æŸ¥æŒ‡å—


**ğŸ” å¸¸è§é—®é¢˜è¯Šæ–­**ï¼š
```
ç­¾åä¸åŒ¹é…ï¼š
â†’ æ£€æŸ¥å‚æ•°æ’åºæ˜¯å¦ä¸€è‡´
â†’ ç¡®è®¤å­—ç¬¦ç¼–ç æ ¼å¼(UTF-8)
â†’ éªŒè¯å¯†é’¥é…ç½®æ­£ç¡®æ€§
â†’ å¯¹æ¯”å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„ç­¾åå­—ç¬¦ä¸²

æ—¶é—´æˆ³éªŒè¯å¤±è´¥ï¼š
â†’ æ£€æŸ¥å®¢æˆ·ç«¯æœåŠ¡å™¨æ—¶é—´æ˜¯å¦åŒæ­¥
â†’ ç¡®è®¤æ—¶é—´æˆ³æ ¼å¼(ç§’/æ¯«ç§’)
â†’ è°ƒæ•´æ—¶é—´çª—å£å¤§å°
â†’ è€ƒè™‘ç½‘ç»œå»¶è¿Ÿå½±å“

é‡æ”¾æ”»å‡»é˜²æŠ¤å¤±æ•ˆï¼š
â†’ æ£€æŸ¥nonceç”Ÿæˆæ˜¯å¦å”¯ä¸€
â†’ ç¡®è®¤å·²å¤„ç†è¯·æ±‚è®°å½•æœºåˆ¶
â†’ éªŒè¯æ—¶é—´çª—å£è®¾ç½®åˆç†æ€§
â†’ æ£€æŸ¥å¹‚ç­‰æ€§å®ç°æ­£ç¡®æ€§
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- ç­¾åå¦‚å°ç« ï¼Œè¯æ˜èº«ä»½çœŸ
- HMACé€Ÿåº¦å¿«ï¼ŒRSAæ›´å®‰å…¨  
- æ—¶é—´æˆ³é˜²é‡æ”¾ï¼Œçª—å£è¦åˆç†
- å‚æ•°è¦æ’åºï¼Œç¼–ç éœ€ç»Ÿä¸€