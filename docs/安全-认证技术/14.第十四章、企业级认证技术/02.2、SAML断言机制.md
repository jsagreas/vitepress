---
title: 2ã€SAMLæ–­è¨€æœºåˆ¶
---
## ğŸ“š ç›®å½•

1. [SAMLæ–­è¨€æœºåˆ¶æ¦‚è¿°](#1-SAMLæ–­è¨€æœºåˆ¶æ¦‚è¿°)
2. [SAMLæ–­è¨€è¯¦è§£](#2-SAMLæ–­è¨€è¯¦è§£)
3. [SAMLè®¤è¯æµç¨‹æ·±åº¦è§£æ](#3-SAMLè®¤è¯æµç¨‹æ·±åº¦è§£æ)
4. [SSOå•ç‚¹ç™»å½•ä¸‰ç§æ¨¡å¼](#4-SSOå•ç‚¹ç™»å½•ä¸‰ç§æ¨¡å¼)
5. [SAMLå®‰å…¨æœºåˆ¶è¯¦è§£](#5-SAMLå®‰å…¨æœºåˆ¶è¯¦è§£)
6. [SAMLå®æˆ˜åº”ç”¨åœºæ™¯](#6-SAMLå®æˆ˜åº”ç”¨åœºæ™¯)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” SAMLæ–­è¨€æœºåˆ¶æ¦‚è¿°


### 1.1 SAMLæ˜¯ä»€ä¹ˆï¼Ÿé€šä¿—ç†è§£


> **SAML**ï¼šSecurity Assertion Markup Languageï¼ˆå®‰å…¨æ–­è¨€æ ‡è®°è¯­è¨€ï¼‰
> 
> **é€šä¿—è§£é‡Š**ï¼šå°±åƒæ˜¯ä¸€å¼ **æ•°å­—èº«ä»½è¯**ï¼Œå‘Šè¯‰åˆ«çš„ç³»ç»Ÿ"è¿™ä¸ªäººæ˜¯è°ã€èƒ½åšä»€ä¹ˆäº‹"ã€‚æƒ³è±¡ä¸€ä¸‹ä½ æ‹¿ç€èº«ä»½è¯å»é“¶è¡Œï¼Œé“¶è¡Œçœ‹åˆ°èº«ä»½è¯å°±çŸ¥é“ä½ æ˜¯è°ï¼Œä¸éœ€è¦å†æ¬¡éªŒè¯èº«ä»½ã€‚

**ğŸ¯ SAMLè§£å†³çš„æ ¸å¿ƒé—®é¢˜**

```
æ²¡æœ‰SAMLçš„ç—›è‹¦åœºæ™¯ï¼š
å‘˜å·¥å¼ ä¸‰çš„ä¸€å¤©ï¼š
8:00 - ç™»å½•å…¬å¸é‚®ç®±ï¼šzhang.san / password123
8:30 - ç™»å½•OAç³»ç»Ÿï¼šzhangsan / oa456  
9:00 - ç™»å½•CRMç³»ç»Ÿï¼šzs001 / crm789
10:00 - ç™»å½•è´¢åŠ¡ç³»ç»Ÿï¼šå¼ ä¸‰ / finance012
...æ¯ä¸ªç³»ç»Ÿéƒ½è¦é‡æ–°è¾“å…¥ç”¨æˆ·åå¯†ç ï¼

æœ‰äº†SAMLçš„èˆ’é€‚ä½“éªŒï¼š
8:00 - ç™»å½•å…¬å¸é—¨æˆ·ï¼šzhang.san@company.com / ç»Ÿä¸€å¯†ç 
8:01 - ç‚¹å‡»é‚®ç®±ï¼šè‡ªåŠ¨ç™»å½•ï¼Œæ— éœ€è¾“å…¥å¯†ç ï¼
8:02 - ç‚¹å‡»OAï¼šè‡ªåŠ¨ç™»å½•ï¼Œæ— éœ€è¾“å…¥å¯†ç ï¼
8:03 - ç‚¹å‡»CRMï¼šè‡ªåŠ¨ç™»å½•ï¼Œæ— éœ€è¾“å…¥å¯†ç ï¼
...ä¸€æ¬¡ç™»å½•ï¼Œç•…é€šæ— é˜»ï¼
```

### 1.2 SAMLçš„åŸºæœ¬è§’è‰²


**ğŸ­ SAMLä¸‰ä¸ªæ ¸å¿ƒè§’è‰²**

```
SAMLè§’è‰²å…³ç³»å›¾ï¼š

                  ç”¨æˆ·(User)
                      â†“
              "æˆ‘è¦è®¿é—®è´¢åŠ¡ç³»ç»Ÿ"
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            SP (Service Provider)                    â”‚
â”‚              æœåŠ¡æä¾›å•†                              â”‚
â”‚         (è´¢åŠ¡ç³»ç»Ÿã€OAç³»ç»Ÿç­‰)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
              "è¿™ä¸ªç”¨æˆ·æ˜¯è°ï¼Ÿ"
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           IdP (Identity Provider)                   â”‚
â”‚              èº«ä»½æä¾›å•†                              â”‚
â”‚         (å…¬å¸ç»Ÿä¸€è®¤è¯ä¸­å¿ƒ)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
         "å¼ ä¸‰ï¼ŒæŠ€æœ¯éƒ¨ï¼Œæœ‰è´¢åŠ¡æŸ¥çœ‹æƒé™"
                  â†“
              è¿”å›æ–­è¨€(Assertion)
```

**ğŸ’¡ è§’è‰²è¯¦è§£**

| **è§’è‰²** | **é€šä¿—ç†è§£** | **å®é™…ä¾‹å­** | **ä¸»è¦èŒè´£** |
|---------|-------------|-------------|-------------|
| **User(ç”¨æˆ·)** | `æƒ³è¦è®¿é—®ç³»ç»Ÿçš„äºº` | `å‘˜å·¥å¼ ä¸‰` | `å‘èµ·è®¿é—®è¯·æ±‚` |
| **SP(æœåŠ¡æä¾›å•†)** | `æä¾›å…·ä½“æœåŠ¡çš„ç³»ç»Ÿ` | `è´¢åŠ¡ç³»ç»Ÿã€OAç³»ç»Ÿ` | `æä¾›ä¸šåŠ¡åŠŸèƒ½ï¼Œä½†ä¸è´Ÿè´£è®¤è¯` |
| **IdP(èº«ä»½æä¾›å•†)** | `è´Ÿè´£éªŒè¯èº«ä»½çš„ç³»ç»Ÿ` | `å…¬å¸ADã€ç»Ÿä¸€è®¤è¯ä¸­å¿ƒ` | `éªŒè¯ç”¨æˆ·èº«ä»½ï¼Œé¢å‘èº«ä»½è¯æ˜` |

### 1.3 SAMLçš„æ ¸å¿ƒä»·å€¼


**ğŸŒŸ ä¸ºä»€ä¹ˆä¼ä¸šè¦ç”¨SAMLï¼Ÿ**

```
ä¼ä¸šä»·å€¼åˆ†æï¼š

ğŸ‘¤ ç”¨æˆ·è§’åº¦ï¼š
âœ… ä¸€æ¬¡ç™»å½•ï¼Œåˆ°å¤„é€šè¡Œ
âœ… å‡å°‘å¯†ç è®°å¿†è´Ÿæ‹…
âœ… æå‡å·¥ä½œæ•ˆç‡

ğŸ’¼ ä¼ä¸šè§’åº¦ï¼š
âœ… ç»Ÿä¸€èº«ä»½ç®¡ç†
âœ… é™ä½è¿ç»´æˆæœ¬
âœ… æé«˜å®‰å…¨æ€§
âœ… ä¾¿äºå®¡è®¡ç›‘æ§

ğŸ”§ æŠ€æœ¯è§’åº¦ï¼š
âœ… æ ‡å‡†åŒ–åè®®ï¼Œå…¼å®¹æ€§å¥½
âœ… åŸºäºXMLï¼Œæ˜“äºé›†æˆ
âœ… æ”¯æŒè·¨åŸŸè®¤è¯
âœ… å®‰å…¨æœºåˆ¶å®Œå–„
```

---

## 2. ğŸ“‹ SAMLæ–­è¨€è¯¦è§£


### 2.1 ä»€ä¹ˆæ˜¯SAMLæ–­è¨€ï¼Ÿ


> **SAMLæ–­è¨€(Assertion)**ï¼šå°±åƒä¸€å¼ **è¯¦ç»†çš„èº«ä»½è¯æ˜ä¹¦**ï¼ŒåŒ…å«äº†ç”¨æˆ·æ˜¯è°ã€æœ‰ä»€ä¹ˆæƒé™ã€è¯æ˜æœ‰æ•ˆæœŸç­‰ä¿¡æ¯
> 
> **é€šä¿—æ¯”å–»**ï¼šæ–­è¨€å°±åƒæ˜¯åŒ»é™¢å¼€çš„è¯Šæ–­è¯æ˜ä¹¦ï¼Œä¸Šé¢å†™ç€"å¼ ä¸‰ç¡®å®ç”Ÿç—…äº†ï¼Œéœ€è¦è¯·å‡3å¤©ï¼ŒåŒ»ç”Ÿæå››è¯æ˜"

**ğŸ« æ–­è¨€çš„æœ¬è´¨ç»“æ„**

```
SAMLæ–­è¨€å°±åƒä¸€å¼ è¯æ˜ä¹¦ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            èº«ä»½è¯æ˜ä¹¦                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¯æ˜å¯¹è±¡ï¼šå¼ ä¸‰ (zhangsan@company.com)    â”‚
â”‚ è¯æ˜å†…å®¹ï¼šæ­¤äººç¡®å®æ˜¯æˆ‘ä»¬å…¬å¸å‘˜å·¥          â”‚
â”‚ èŒä½æƒé™ï¼šæŠ€æœ¯éƒ¨Javaå·¥ç¨‹å¸ˆ              â”‚
â”‚ ç³»ç»Ÿæƒé™ï¼šå¯ä»¥è®¿é—®å¼€å‘ç³»ç»Ÿå’Œæµ‹è¯•ç³»ç»Ÿ     â”‚
â”‚ æœ‰æ•ˆæ—¶é—´ï¼š2025-01-15 åˆ° 2025-01-16     â”‚
â”‚ è¯æ˜æœºæ„ï¼šå…¬å¸äººäº‹éƒ¨                    â”‚
â”‚ è¯æ˜äººç­¾åï¼š[æ•°å­—ç­¾å]                  â”‚
â”‚ è¯æ˜æ—¶é—´ï¼š2025-01-15 08:30:00          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ–­è¨€çš„ä¸‰ç§ç±»å‹


**ğŸ” è®¤è¯æ–­è¨€(Authentication Assertion)**

> **ä½œç”¨**ï¼šè¯æ˜ç”¨æˆ·å·²ç»é€šè¿‡äº†èº«ä»½éªŒè¯
> **é€šä¿—ç†è§£**ï¼šå°±åƒé—¨å«ç¡®è®¤"è¿™ä¸ªäººç¡®å®æ˜¯æˆ‘ä»¬å…¬å¸å‘˜å·¥"

```xml
<!-- è®¤è¯æ–­è¨€ç¤ºä¾‹ï¼ˆç®€åŒ–ç‰ˆï¼‰ -->
<saml:Assertion>
    <saml:Subject>
        <saml:NameID>zhangsan@company.com</saml:NameID>
    </saml:Subject>
    
    <!-- è®¤è¯å£°æ˜ -->
    <saml:AuthnStatement AuthnInstant="2025-01-15T08:30:00Z">
        <saml:AuthnContext>
            <saml:AuthnContextClassRef>
                PasswordProtectedTransport
            </saml:AuthnContextClassRef>
        </saml:AuthnContext>
    </saml:AuthnStatement>
</saml:Assertion>
```

**è§£é‡Šè¯´æ˜**ï¼š
- `NameID`ï¼šç”¨æˆ·æ ‡è¯†ï¼ˆå¼ ä¸‰çš„é‚®ç®±ï¼‰
- `AuthnInstant`ï¼šè®¤è¯æ—¶é—´ï¼ˆ8ç‚¹30åˆ†è®¤è¯çš„ï¼‰
- `AuthnContextClassRef`ï¼šè®¤è¯æ–¹å¼ï¼ˆç”¨æˆ·åå¯†ç è®¤è¯ï¼‰

**ğŸ›¡ï¸ æˆæƒæ–­è¨€(Authorization Assertion)**

> **ä½œç”¨**ï¼šè¯´æ˜ç”¨æˆ·æœ‰å“ªäº›æƒé™å’Œè®¿é—®æ§åˆ¶
> **é€šä¿—ç†è§£**ï¼šå°±åƒå·¥ä½œè¯ä¸Šå†™ç€"æ­¤äººæœ‰æƒè¿›å…¥è´¢åŠ¡éƒ¨é—¨"

```xml
<!-- æˆæƒæ–­è¨€ç¤ºä¾‹ -->
<saml:Assertion>
    <saml:Subject>
        <saml:NameID>zhangsan@company.com</saml:NameID>
    </saml:Subject>
    
    <!-- æˆæƒå†³ç­–å£°æ˜ -->
    <saml:AuthzDecisionStatement 
         Resource="https://finance.company.com/reports">
        <saml:Action>Read</saml:Action>
        <saml:Decision>Permit</saml:Decision>
    </saml:AuthzDecisionStatement>
</saml:Assertion>
```

**è§£é‡Šè¯´æ˜**ï¼š
- `Resource`ï¼šèµ„æºåœ°å€ï¼ˆè´¢åŠ¡æŠ¥è¡¨é¡µé¢ï¼‰
- `Action`ï¼šæ“ä½œç±»å‹ï¼ˆåªèƒ½è¯»å–ï¼‰
- `Decision`ï¼šå†³ç­–ç»“æœï¼ˆå…è®¸è®¿é—®ï¼‰

**ğŸ“Š å±æ€§æ–­è¨€(Attribute Assertion)**

> **ä½œç”¨**ï¼šæä¾›ç”¨æˆ·çš„è¯¦ç»†å±æ€§ä¿¡æ¯
> **é€šä¿—ç†è§£**ï¼šå°±åƒèº«ä»½è¯ä¸Šçš„è¯¦ç»†ä¿¡æ¯ï¼ˆå§“åã€å¹´é¾„ã€åœ°å€ç­‰ï¼‰

```xml
<!-- å±æ€§æ–­è¨€ç¤ºä¾‹ -->
<saml:Assertion>
    <saml:Subject>
        <saml:NameID>zhangsan@company.com</saml:NameID>
    </saml:Subject>
    
    <!-- å±æ€§å£°æ˜ -->
    <saml:AttributeStatement>
        <saml:Attribute Name="DisplayName">
            <saml:AttributeValue>å¼ ä¸‰</saml:AttributeValue>
        </saml:Attribute>
        
        <saml:Attribute Name="Department">
            <saml:AttributeValue>æŠ€æœ¯éƒ¨</saml:AttributeValue>
        </saml:Attribute>
        
        <saml:Attribute Name="JobTitle">
            <saml:AttributeValue>Javaå·¥ç¨‹å¸ˆ</saml:AttributeValue>
        </saml:Attribute>
        
        <saml:Attribute Name="Email">
            <saml:AttributeValue>zhangsan@company.com</saml:AttributeValue>
        </saml:Attribute>
    </saml:AttributeStatement>
</saml:Assertion>
```

**è§£é‡Šè¯´æ˜**ï¼š
- `DisplayName`ï¼šæ˜¾ç¤ºåç§°ï¼ˆå¼ ä¸‰ï¼‰
- `Department`ï¼šéƒ¨é—¨ï¼ˆæŠ€æœ¯éƒ¨ï¼‰
- `JobTitle`ï¼šèŒä½ï¼ˆJavaå·¥ç¨‹å¸ˆï¼‰
- `Email`ï¼šé‚®ç®±åœ°å€

### 2.3 æ–­è¨€çš„å…³é”®ç»„æˆéƒ¨åˆ†


**ğŸ“ æ–­è¨€ç»“æ„è¯¦è§£**

```
SAMLæ–­è¨€çš„å®Œæ•´ç»“æ„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ–­è¨€å¤´éƒ¨                    â”‚
â”‚ â€¢ ç‰ˆæœ¬ä¿¡æ¯ï¼ˆVersion="2.0"ï¼‰            â”‚
â”‚ â€¢ å”¯ä¸€IDï¼ˆID="assertion_123"ï¼‰         â”‚  
â”‚ â€¢ ç­¾å‘æ—¶é—´ï¼ˆIssueInstantï¼‰             â”‚
â”‚ â€¢ ç­¾å‘è€…ï¼ˆIssuerï¼‰                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              ä¸»é¢˜ä¿¡æ¯                    â”‚
â”‚ â€¢ ç”¨æˆ·æ ‡è¯†ï¼ˆNameIDï¼‰                   â”‚
â”‚ â€¢ ä¸»é¢˜ç¡®è®¤ï¼ˆSubjectConfirmationï¼‰      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              æ¡ä»¶é™åˆ¶                    â”‚
â”‚ â€¢ ç”Ÿæ•ˆæ—¶é—´ï¼ˆNotBeforeï¼‰                â”‚
â”‚ â€¢ å¤±æ•ˆæ—¶é—´ï¼ˆNotOnOrAfterï¼‰             â”‚
â”‚ â€¢ å—ä¼—é™åˆ¶ï¼ˆAudienceRestrictionï¼‰      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              å£°æ˜å†…å®¹                    â”‚
â”‚ â€¢ è®¤è¯å£°æ˜ï¼ˆAuthnStatementï¼‰           â”‚
â”‚ â€¢ å±æ€§å£°æ˜ï¼ˆAttributeStatementï¼‰       â”‚
â”‚ â€¢ æˆæƒå£°æ˜ï¼ˆAuthzDecisionStatementï¼‰   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              æ•°å­—ç­¾å                    â”‚
â”‚ â€¢ ç­¾åç®—æ³•                             â”‚
â”‚ â€¢ ç­¾åå€¼                               â”‚
â”‚ â€¢ è¯ä¹¦ä¿¡æ¯                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**â° æ—¶é—´æ§åˆ¶æœºåˆ¶**

```xml
<!-- æ–­è¨€æœ‰æ•ˆæœŸæ§åˆ¶ -->
<saml:Conditions 
    NotBefore="2025-01-15T08:30:00Z"
    NotOnOrAfter="2025-01-15T20:30:00Z">
    
    <!-- åªå…è®¸ç‰¹å®šç³»ç»Ÿä½¿ç”¨è¿™ä¸ªæ–­è¨€ -->
    <saml:AudienceRestriction>
        <saml:Audience>https://finance.company.com</saml:Audience>
    </saml:AudienceRestriction>
</saml:Conditions>
```

**è§£é‡Šè¯´æ˜**ï¼š
- `NotBefore`ï¼šæ–­è¨€ç”Ÿæ•ˆæ—¶é—´ï¼ˆæ—©ä¸Š8ç‚¹30åˆ†å¼€å§‹ç”Ÿæ•ˆï¼‰
- `NotOnOrAfter`ï¼šæ–­è¨€å¤±æ•ˆæ—¶é—´ï¼ˆæ™šä¸Š8ç‚¹30åˆ†å¤±æ•ˆï¼‰
- `Audience`ï¼šåªæœ‰è´¢åŠ¡ç³»ç»Ÿå¯ä»¥ä½¿ç”¨è¿™ä¸ªæ–­è¨€

---

## 3. ğŸ”„ SAMLè®¤è¯æµç¨‹æ·±åº¦è§£æ


### 3.1 SAMLè®¤è¯æµç¨‹æ¦‚è§ˆ


**ğŸ¯ æ•´ä½“æµç¨‹ç†è§£**

```
SAMLè®¤è¯æµç¨‹ï¼ˆç”Ÿæ´»åŒ–æ¯”å–»ï¼‰ï¼š

1. ç”¨æˆ·æƒ³å»é“¶è¡ŒåŠäº‹ï¼ˆè®¿é—®è´¢åŠ¡ç³»ç»Ÿï¼‰
2. é“¶è¡Œè¯´ï¼š"è¯·å‡ºç¤ºèº«ä»½è¯"ï¼ˆé‡å®šå‘åˆ°è®¤è¯ä¸­å¿ƒï¼‰
3. ç”¨æˆ·åˆ°æ´¾å‡ºæ‰€åŠèº«ä»½è¯ï¼ˆåœ¨IdPç™»å½•è®¤è¯ï¼‰  
4. æ´¾å‡ºæ‰€å¼€å…·èº«ä»½è¯æ˜ï¼ˆç”ŸæˆSAMLæ–­è¨€ï¼‰
5. ç”¨æˆ·æ‹¿ç€è¯æ˜å›åˆ°é“¶è¡Œï¼ˆæµè§ˆå™¨é‡å®šå‘åˆ°SPï¼‰
6. é“¶è¡ŒéªŒè¯è¯æ˜æ— è¯¯ï¼ˆSPéªŒè¯æ–­è¨€ï¼‰
7. é“¶è¡Œä¸ºç”¨æˆ·åŠç†ä¸šåŠ¡ï¼ˆå…è®¸è®¿é—®ç³»ç»Ÿï¼‰
```

### 3.2 è¯¦ç»†è®¤è¯æµç¨‹æ­¥éª¤


**ğŸ“Š å®Œæ•´æµç¨‹å›¾è§£**

```
SAMLè®¤è¯è¯¦ç»†æµç¨‹ï¼š

ç”¨æˆ·æµè§ˆå™¨          æœåŠ¡æä¾›å•†(SP)         èº«ä»½æä¾›å•†(IdP)
     |                    |                      |
  1. |--è®¿é—®å—ä¿æŠ¤èµ„æº---->|                      |
     |                    |                      |
  2. |<--é‡å®šå‘åˆ°IdP------|                      |
     |   (AuthnRequest)   |                      |
     |                    |                      |
  3. |----------ç™»å½•è®¤è¯è¯·æ±‚------------------->|
     |                    |                      |
  4. |<---------æ˜¾ç¤ºç™»å½•é¡µé¢------------------|
     |                    |                      |
  5. |----------æäº¤ç”¨æˆ·åå¯†ç ----------------->|
     |                    |                      |
  6. |<---------é‡å®šå‘åˆ°SP-------------------|
     |   (SAML Response)  |                      |
     |                    |                      |
  7. |--æäº¤SAML Response->|                      |
     |                    |                      |
  8. |                    |--éªŒè¯æ–­è¨€ç­¾å-------->|
     |                    |<--éªŒè¯ç»“æœ------------|
     |                    |                      |
  9. |<--è¿”å›å—ä¿æŠ¤èµ„æº----|                      |
     |                    |                      |
```

**ğŸ” æ¯ä¸ªæ­¥éª¤è¯¦ç»†è¯´æ˜**

```java
// æ­¥éª¤1ï¼šç”¨æˆ·è®¿é—®å—ä¿æŠ¤èµ„æº
GET https://finance.company.com/reports
// ç”¨æˆ·æƒ³è®¿é—®è´¢åŠ¡æŠ¥è¡¨

// æ­¥éª¤2ï¼šSPæ£€æŸ¥ç”¨æˆ·æœªè®¤è¯ï¼Œç”ŸæˆAuthnRequest
public String generateAuthnRequest() {
    AuthnRequest authnRequest = new AuthnRequestBuilder()
        .setID(generateUniqueId())
        .setIssuer("https://finance.company.com")
        .setDestination("https://sso.company.com/saml/login")
        .setAssertionConsumerServiceURL("https://finance.company.com/saml/acs")
        .build();
        
    // é‡å®šå‘åˆ°IdP
    return "redirect:https://sso.company.com/saml/login?SAMLRequest=" + 
           base64Encode(authnRequest);
}

// æ­¥éª¤3-5ï¼šç”¨æˆ·åœ¨IdPå®Œæˆè®¤è¯
// (è¿™éƒ¨åˆ†ç”±IdPç³»ç»Ÿå¤„ç†ï¼Œé€šå¸¸æ˜¯ç”¨æˆ·åå¯†ç ç™»å½•)

// æ­¥éª¤6ï¼šIdPç”ŸæˆSAML Response  
public String generateSamlResponse(User user) {
    Assertion assertion = new AssertionBuilder()
        .setSubject(user.getEmail())
        .addAuthenticationStatement()
        .addAttributeStatement(user.getAttributes())
        .setValidUntil(new Date(System.currentTimeMillis() + 3600000))
        .sign(privateKey)
        .build();
        
    Response response = new ResponseBuilder()
        .setAssertion(assertion)
        .setDestination("https://finance.company.com/saml/acs")
        .build();
        
    // é‡å®šå‘å›SP
    return "redirect:https://finance.company.com/saml/acs?SAMLResponse=" + 
           base64Encode(response);
}

// æ­¥éª¤7-8ï¼šSPéªŒè¯SAML Response
@PostMapping("/saml/acs")
public String processAssertions(@RequestParam String SAMLResponse) {
    Response response = parseSamlResponse(SAMLResponse);
    Assertion assertion = response.getAssertion();
    
    // éªŒè¯ç­¾å
    if (!validateSignature(assertion, idpPublicKey)) {
        throw new SecurityException("æ–­è¨€ç­¾åéªŒè¯å¤±è´¥");
    }
    
    // éªŒè¯æ—¶é—´
    if (!assertion.isValid()) {
        throw new SecurityException("æ–­è¨€å·²è¿‡æœŸ");
    }
    
    // æå–ç”¨æˆ·ä¿¡æ¯
    String userId = assertion.getSubject().getNameID();
    Map<String, String> attributes = assertion.getAttributes();
    
    // åˆ›å»ºç”¨æˆ·ä¼šè¯
    createUserSession(userId, attributes);
    
    // é‡å®šå‘åˆ°åŸå§‹è¯·æ±‚çš„èµ„æº
    return "redirect:/reports";
}
```

---

## 4. ğŸ” SSOå•ç‚¹ç™»å½•ä¸‰ç§æ¨¡å¼


### 4.1 SPå‘èµ·çš„SSOæµç¨‹


> **SPå‘èµ·æ¨¡å¼**ï¼šç”¨æˆ·å…ˆè®¿é—®å…·ä½“çš„ä¸šåŠ¡ç³»ç»Ÿï¼Œç„¶åè¢«å¼•å¯¼åˆ°è®¤è¯ä¸­å¿ƒç™»å½•
> **é€šä¿—ç†è§£**ï¼šå°±åƒä½ ç›´æ¥å»é“¶è¡ŒåŠäº‹ï¼Œé“¶è¡Œè¯´"å…ˆå»å¼€è¯æ˜"

**ğŸ¯ SPå‘èµ·æµç¨‹è¯¦è§£**

```
SPå‘èµ·çš„SSOæµç¨‹ï¼š

ç”¨æˆ·æƒ³æ³•ï¼š"æˆ‘è¦çœ‹è´¢åŠ¡æŠ¥è¡¨"
       â†“
1. ç›´æ¥è®¿é—®ï¼šhttps://finance.company.com/reports
       â†“
2. è´¢åŠ¡ç³»ç»Ÿæ£€æŸ¥ï¼šç”¨æˆ·æ²¡ç™»å½•
       â†“  
3. è´¢åŠ¡ç³»ç»Ÿè¯´ï¼š"è¯·å…ˆå»è®¤è¯ä¸­å¿ƒç™»å½•"
       â†“
4. è‡ªåŠ¨è·³è½¬åˆ°ï¼šhttps://sso.company.com/login?returnTo=finance
       â†“
5. ç”¨æˆ·åœ¨è®¤è¯ä¸­å¿ƒè¾“å…¥ç”¨æˆ·åå¯†ç 
       â†“
6. è®¤è¯æˆåŠŸåè‡ªåŠ¨è·³å›è´¢åŠ¡ç³»ç»Ÿ
       â†“
7. è´¢åŠ¡ç³»ç»ŸéªŒè¯èº«ä»½ï¼Œæ˜¾ç¤ºæŠ¥è¡¨
```

**ğŸ’» SPå‘èµ·æ¨¡å¼ä»£ç ç¤ºä¾‹**

```java
@Controller
public class FinanceController {
    
    @GetMapping("/reports")
    public String viewReports(HttpServletRequest request) {
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²è®¤è¯
        if (!isUserAuthenticated(request)) {
            // ç”Ÿæˆè®¤è¯è¯·æ±‚
            String authnRequest = createAuthnRequest();
            String idpUrl = "https://sso.company.com/login";
            
            // é‡å®šå‘åˆ°IdP
            return "redirect:" + idpUrl + "?SAMLRequest=" + authnRequest + 
                   "&RelayState=" + getCurrentUrl(request);
        }
        
        // ç”¨æˆ·å·²è®¤è¯ï¼Œæ˜¾ç¤ºæŠ¥è¡¨
        return "reports";
    }
    
    @PostMapping("/saml/acs")
    public String handleSamlResponse(@RequestParam String SAMLResponse,
                                    @RequestParam String RelayState) {
        // å¤„ç†SAMLå“åº”
        User user = processAssertions(SAMLResponse);
        
        // åˆ›å»ºæœ¬åœ°ä¼šè¯
        createSession(user);
        
        // é‡å®šå‘åˆ°åŸå§‹è¯·æ±‚çš„é¡µé¢
        return "redirect:" + RelayState;
    }
}
```

### 4.2 IdPå‘èµ·çš„SSOæµç¨‹


> **IdPå‘èµ·æ¨¡å¼**ï¼šç”¨æˆ·å…ˆç™»å½•è®¤è¯ä¸­å¿ƒï¼Œç„¶åé€‰æ‹©è¦è®¿é—®çš„ç³»ç»Ÿ
> **é€šä¿—ç†è§£**ï¼šå°±åƒä½ å…ˆå»æ´¾å‡ºæ‰€å¼€è¯æ˜ï¼Œç„¶åæ‹¿ç€è¯æ˜å»å„ä¸ªé“¶è¡ŒåŠäº‹

**ğŸ¯ IdPå‘èµ·æµç¨‹è¯¦è§£**

```
IdPå‘èµ·çš„SSOæµç¨‹ï¼š

ç”¨æˆ·æƒ³æ³•ï¼š"æˆ‘å…ˆç™»å½•å…¬å¸é—¨æˆ·"
       â†“
1. ç›´æ¥è®¿é—®ï¼šhttps://sso.company.com
       â†“
2. è¾“å…¥ç”¨æˆ·åå¯†ç ç™»å½•æˆåŠŸ
       â†“
3. çœ‹åˆ°ç³»ç»Ÿèœå•ï¼š[è´¢åŠ¡ç³»ç»Ÿ] [OAç³»ç»Ÿ] [é‚®ä»¶ç³»ç»Ÿ]
       â†“
4. ç‚¹å‡»"è´¢åŠ¡ç³»ç»Ÿ"
       â†“
5. è®¤è¯ä¸­å¿ƒç”Ÿæˆæ–­è¨€ï¼Œè‡ªåŠ¨è·³è½¬åˆ°è´¢åŠ¡ç³»ç»Ÿ
       â†“
6. è´¢åŠ¡ç³»ç»ŸéªŒè¯æ–­è¨€ï¼Œç›´æ¥æ˜¾ç¤ºæŠ¥è¡¨ï¼ˆæ— éœ€å†æ¬¡ç™»å½•ï¼‰
```

**ğŸŒ IdPå‘èµ·æ¨¡å¼ä»£ç ç¤ºä¾‹**

```java
@Controller
public class SsoPortalController {
    
    @GetMapping("/")
    public String showPortal(Model model, HttpServletRequest request) {
        User user = getCurrentUser(request);
        if (user == null) {
            return "login";  // æ˜¾ç¤ºç™»å½•é¡µé¢
        }
        
        // æ˜¾ç¤ºç”¨æˆ·å¯è®¿é—®çš„ç³»ç»Ÿåˆ—è¡¨
        List<Application> apps = getAuthorizedApps(user);
        model.addAttribute("applications", apps);
        return "portal";
    }
    
    @GetMapping("/launch/{appId}")
    public String launchApplication(@PathVariable String appId,
                                   HttpServletRequest request) {
        User user = getCurrentUser(request);
        Application app = getApplication(appId);
        
        // ç”ŸæˆSAMLæ–­è¨€
        Assertion assertion = createAssertion(user, app);
        
        // ç”Ÿæˆè‡ªåŠ¨æäº¤çš„è¡¨å•é¡µé¢
        String samlResponse = base64Encode(assertion);
        String targetUrl = app.getAcsUrl();
        
        model.addAttribute("targetUrl", targetUrl);
        model.addAttribute("samlResponse", samlResponse);
        
        // è¿”å›è‡ªåŠ¨æäº¤è¡¨å•çš„é¡µé¢
        return "auto-submit-form";
    }
}
```

**ğŸ“„ è‡ªåŠ¨æäº¤è¡¨å•æ¨¡æ¿**

```html
<!-- auto-submit-form.html -->
<!DOCTYPE html>
<html>
<head>
    <title>æ­£åœ¨è·³è½¬åˆ°ç³»ç»Ÿ...</title>
</head>
<body onload="document.forms[0].submit()">
    <form method="post" action="${targetUrl}">
        <input type="hidden" name="SAMLResponse" value="${samlResponse}"/>
        <p>æ­£åœ¨è·³è½¬åˆ°ç›®æ ‡ç³»ç»Ÿï¼Œè¯·ç¨å€™...</p>
        <noscript>
            <p>æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒJavaScriptï¼Œè¯·ç‚¹å‡»ä¸‹é¢çš„æŒ‰é’®ï¼š</p>
            <input type="submit" value="ç»§ç»­"/>
        </noscript>
    </form>
</body>
</html>
```

### 4.3 æ··åˆæ¨¡å¼SSO


> **æ··åˆæ¨¡å¼**ï¼šç»“åˆSPå‘èµ·å’ŒIdPå‘èµ·çš„ä¼˜ç‚¹ï¼Œæä¾›æ›´çµæ´»çš„ç”¨æˆ·ä½“éªŒ
> **é€šä¿—ç†è§£**ï¼šæ—¢å¯ä»¥ç›´æ¥å»é“¶è¡Œï¼ˆè¢«å¼•å¯¼å»å¼€è¯æ˜ï¼‰ï¼Œä¹Ÿå¯ä»¥å…ˆå¼€å¥½è¯æ˜å†å»é“¶è¡Œ

**ğŸ”— æ··åˆæ¨¡å¼ç‰¹ç‚¹**

```
æ··åˆæ¨¡å¼çš„çµæ´»æ€§ï¼š

åœºæ™¯1ï¼šç”¨æˆ·æ”¶è—äº†è´¢åŠ¡ç³»ç»Ÿç½‘å€
      â†’ ç›´æ¥è®¿é—®è´¢åŠ¡ç³»ç»Ÿï¼ˆSPå‘èµ·æ¨¡å¼ï¼‰
      â†’ è‡ªåŠ¨è·³è½¬è®¤è¯ï¼Œç™»å½•åå›åˆ°è´¢åŠ¡ç³»ç»Ÿ

åœºæ™¯2ï¼šç”¨æˆ·ä¹ æƒ¯ä»å…¬å¸é—¨æˆ·è¿›å…¥
      â†’ å…ˆç™»å½•é—¨æˆ·ï¼ˆIdPå‘èµ·æ¨¡å¼ï¼‰  
      â†’ ç‚¹å‡»åº”ç”¨å›¾æ ‡ç›´æ¥è¿›å…¥ç³»ç»Ÿ

åœºæ™¯3ï¼šç”¨æˆ·é€šè¿‡é‚®ä»¶é“¾æ¥è®¿é—®
      â†’ ç‚¹å‡»é‚®ä»¶ä¸­çš„ç³»ç»Ÿé“¾æ¥ï¼ˆSPå‘èµ·æ¨¡å¼ï¼‰
      â†’ å¦‚æœå·²åœ¨é—¨æˆ·ç™»å½•è¿‡ï¼Œç›´æ¥è¿›å…¥
      â†’ å¦‚æœæœªç™»å½•ï¼Œå¼•å¯¼è®¤è¯åè¿›å…¥
```

**âš™ï¸ æ··åˆæ¨¡å¼å®ç°è¦ç‚¹**

```java
@Component
public class SsoModeDetector {
    
    public SsoMode detectMode(HttpServletRequest request) {
        // æ£€æŸ¥æ˜¯å¦æ¥è‡ªIdPé—¨æˆ·
        String referer = request.getHeader("Referer");
        if (referer != null && referer.contains("sso.company.com")) {
            return SsoMode.IDP_INITIATED;
        }
        
        // æ£€æŸ¥æ˜¯å¦å·²æœ‰SSOä¼šè¯
        if (hasSsoSession(request)) {
            return SsoMode.EXISTING_SESSION;
        }
        
        // é»˜è®¤SPå‘èµ·æ¨¡å¼
        return SsoMode.SP_INITIATED;
    }
    
    public String handleSsoRequest(SsoMode mode, HttpServletRequest request) {
        switch (mode) {
            case IDP_INITIATED:
                return handleIdpInitiated(request);
            case EXISTING_SESSION:
                return handleExistingSession(request);
            case SP_INITIATED:
            default:
                return handleSpInitiated(request);
        }
    }
}
```

---

## 5. ğŸ”’ SAMLå®‰å…¨æœºåˆ¶è¯¦è§£


### 5.1 XMLæ•°å­—ç­¾åæœºåˆ¶


> **XMLæ•°å­—ç­¾å**ï¼šå°±åƒåœ¨é‡è¦æ–‡ä»¶ä¸Šç›–å…¬ç« ï¼Œè¯æ˜æ–‡ä»¶æ˜¯çœŸçš„ï¼Œæ²¡è¢«ç¯¡æ”¹è¿‡
> **é€šä¿—ç†è§£**ï¼šé“¶è¡Œæ”¯ç¥¨ä¸Šçš„å°ç« ï¼Œåˆ«äººæ— æ³•ä¼ªé€ 

**ğŸ” æ•°å­—ç­¾åçš„ä½œç”¨**

```
æ•°å­—ç­¾åè§£å†³çš„å®‰å…¨é—®é¢˜ï¼š

é—®é¢˜1ï¼šå¦‚ä½•è¯æ˜æ–­è¨€æ˜¯IdPå‘å‡ºçš„ï¼Ÿ
è§£å†³ï¼šIdPç”¨ç§é’¥ç­¾åï¼ŒSPç”¨å…¬é’¥éªŒè¯

é—®é¢˜2ï¼šå¦‚ä½•ç¡®ä¿æ–­è¨€æ²¡è¢«ç¯¡æ”¹ï¼Ÿ
è§£å†³ï¼šä»»ä½•å†…å®¹æ”¹åŠ¨éƒ½ä¼šå¯¼è‡´ç­¾åéªŒè¯å¤±è´¥

é—®é¢˜3ï¼šå¦‚ä½•é˜²æ­¢å¦è®¤ï¼Ÿ
è§£å†³ï¼šåªæœ‰IdPæœ‰ç§é’¥ï¼Œæ— æ³•å¦è®¤ç­¾è¿‡åçš„æ–­è¨€
```

**ğŸ”§ æ•°å­—ç­¾åå®ç°**

```java
public class SamlSignatureUtil {
    
    // å¯¹æ–­è¨€è¿›è¡Œæ•°å­—ç­¾å
    public Assertion signAssertion(Assertion assertion, PrivateKey privateKey) {
        try {
            // åˆ›å»ºç­¾åé…ç½®
            SignatureBuilder signatureBuilder = new SignatureBuilder();
            Signature signature = signatureBuilder
                .setSigningCredential(privateKey)
                .setSignatureAlgorithm("http://www.w3.org/2001/04/xmldsig-more#rsa-sha256")
                .setCanonicalizationAlgorithm("http://www.w3.org/2001/10/xml-exc-c14n#")
                .build();
            
            // æ·»åŠ ç­¾ååˆ°æ–­è¨€
            assertion.setSignature(signature);
            
            // æ‰§è¡Œç­¾å
            Marshaller marshaller = Configuration.getMarshallerFactory()
                .getMarshaller(assertion);
            Element assertionElement = marshaller.marshall(assertion);
            Signer.signObject(signature);
            
            return assertion;
            
        } catch (Exception e) {
            throw new SecurityException("æ–­è¨€ç­¾åå¤±è´¥", e);
        }
    }
    
    // éªŒè¯æ–­è¨€ç­¾å
    public boolean verifySignature(Assertion assertion, PublicKey publicKey) {
        try {
            Signature signature = assertion.getSignature();
            if (signature == null) {
                return false;  // æ²¡æœ‰ç­¾å
            }
            
            // åˆ›å»ºéªŒè¯å‡­æ®
            BasicCredential credential = new BasicCredential();
            credential.setPublicKey(publicKey);
            
            // éªŒè¯ç­¾å
            SignatureValidator validator = new SignatureValidator(credential);
            validator.validate(signature);
            
            return true;
            
        } catch (ValidationException e) {
            log.warn("æ–­è¨€ç­¾åéªŒè¯å¤±è´¥: {}", e.getMessage());
            return false;
        }
    }
}
```

### 5.2 XMLåŠ å¯†æœºåˆ¶


> **XMLåŠ å¯†**ï¼šæŠŠæ•æ„Ÿä¿¡æ¯ç”¨å¯†ç é”èµ·æ¥ï¼Œåªæœ‰æœ‰é’¥åŒ™çš„äººæ‰èƒ½çœ‹åˆ°
> **é€šä¿—ç†è§£**ï¼šå°±åƒæŠŠé‡è¦æ–‡ä»¶æ”¾åœ¨ä¿é™©ç®±é‡Œï¼Œåªæœ‰çŸ¥é“å¯†ç çš„äººèƒ½æ‰“å¼€

**ğŸ”’ åŠ å¯†çš„åº”ç”¨åœºæ™¯**

```
ä»€ä¹ˆæ—¶å€™éœ€è¦åŠ å¯†ï¼Ÿ

åœºæ™¯1ï¼šä¼ è¾“ç”¨æˆ·æ•æ„Ÿå±æ€§
- èº«ä»½è¯å·ã€æ‰‹æœºå·ã€å®¶åº­åœ°å€ç­‰
- åŠ å¯†åå³ä½¿è¢«æˆªè·ä¹Ÿæ— æ³•è¯»å–

åœºæ™¯2ï¼šè·¨ä¸å®‰å…¨ç½‘ç»œä¼ è¾“
- é€šè¿‡äº’è”ç½‘ä¼ è¾“æ–­è¨€
- å³ä½¿HTTPSä¹Ÿè¦é¢å¤–ä¿æŠ¤æ•æ„Ÿæ•°æ®

åœºæ™¯3ï¼šåˆè§„è¦æ±‚
- è¡Œä¸šæ³•è§„è¦æ±‚æ•æ„Ÿæ•°æ®å¿…é¡»åŠ å¯†
- å¦‚åŒ»ç–—ã€é‡‘èç­‰è¡Œä¸š
```

**ğŸ›¡ï¸ XMLåŠ å¯†å®ç°**

```java
public class SamlEncryptionUtil {
    
    // åŠ å¯†æ–­è¨€ä¸­çš„æ•æ„Ÿå±æ€§
    public Assertion encryptSensitiveAttributes(Assertion assertion, 
                                               PublicKey encryptionKey) {
        try {
            // æ‰¾åˆ°éœ€è¦åŠ å¯†çš„å±æ€§
            AttributeStatement attributeStatement = assertion.getAttributeStatements().get(0);
            List<Attribute> attributes = attributeStatement.getAttributes();
            
            for (Attribute attribute : attributes) {
                if (isSensitiveAttribute(attribute.getName())) {
                    // åŠ å¯†å±æ€§å€¼
                    EncryptedAttribute encryptedAttr = encryptAttribute(attribute, encryptionKey);
                    
                    // æ›¿æ¢åŸå±æ€§
                    attributeStatement.getAttributes().remove(attribute);
                    attributeStatement.getEncryptedAttributes().add(encryptedAttr);
                }
            }
            
            return assertion;
            
        } catch (Exception e) {
            throw new SecurityException("å±æ€§åŠ å¯†å¤±è´¥", e);
        }
    }
    
    // è§£å¯†æ–­è¨€ä¸­çš„åŠ å¯†å±æ€§
    public Assertion decryptAttributes(Assertion assertion, PrivateKey decryptionKey) {
        try {
            AttributeStatement attributeStatement = assertion.getAttributeStatements().get(0);
            List<EncryptedAttribute> encryptedAttrs = attributeStatement.getEncryptedAttributes();
            
            for (EncryptedAttribute encryptedAttr : encryptedAttrs) {
                // è§£å¯†å±æ€§
                Attribute decryptedAttr = decryptAttribute(encryptedAttr, decryptionKey);
                
                // æ·»åŠ åˆ°æ™®é€šå±æ€§åˆ—è¡¨
                attributeStatement.getAttributes().add(decryptedAttr);
            }
            
            // æ¸…é™¤åŠ å¯†å±æ€§åˆ—è¡¨
            encryptedAttrs.clear();
            
            return assertion;
            
        } catch (Exception e) {
            throw new SecurityException("å±æ€§è§£å¯†å¤±è´¥", e);
        }
    }
    
    private boolean isSensitiveAttribute(String attributeName) {
        // å®šä¹‰æ•æ„Ÿå±æ€§åˆ—è¡¨
        Set<String> sensitiveAttrs = Set.of("SSN", "Phone", "Address", "Salary");
        return sensitiveAttrs.contains(attributeName);
    }
}
```

### 5.3 æ—¶é—´æˆ³å®‰å…¨æœºåˆ¶


> **æ—¶é—´æˆ³æœºåˆ¶**ï¼šç»™æ–­è¨€è®¾ç½®"æœ‰æ•ˆæœŸ"ï¼Œå°±åƒé£Ÿå“ä¸Šçš„ä¿è´¨æœŸ
> **é€šä¿—ç†è§£**ï¼šè¿‡æœŸçš„æ–­è¨€å°±åƒè¿‡æœŸçš„ç‰›å¥¶ï¼Œä¸èƒ½å†ç”¨äº†

**â° æ—¶é—´æˆ³çš„å®‰å…¨ä½œç”¨**

```
æ—¶é—´æˆ³é˜²æŠ¤çš„æ”»å‡»ï¼š

æ”»å‡»1ï¼šé‡æ”¾æ”»å‡»
- æ”»å‡»è€…æˆªè·æœ‰æ•ˆæ–­è¨€
- ç¨åé‡å¤ä½¿ç”¨è¿™ä¸ªæ–­è¨€
- é˜²æŠ¤ï¼šè®¾ç½®çŸ­æš‚æœ‰æ•ˆæœŸï¼Œè¿‡æœŸè‡ªåŠ¨å¤±æ•ˆ

æ”»å‡»2ï¼šé•¿æœŸæ½œä¼
- æ”»å‡»è€…è·å¾—æ–­è¨€åé•¿æœŸä¿å­˜
- ç­‰å¾…æ—¶æœºä½¿ç”¨
- é˜²æŠ¤ï¼šæ–­è¨€åªåœ¨çŸ­æ—¶é—´å†…æœ‰æ•ˆ

æ—¶é—´çª—å£è®¾ç½®ï¼š
âœ… å¤ªçŸ­ï¼šç”¨æˆ·ä½“éªŒå·®ï¼Œå¯èƒ½æ¥ä¸åŠä½¿ç”¨
âœ… å¤ªé•¿ï¼šå®‰å…¨é£é™©é«˜ï¼Œè¢«æ”»å‡»æ¦‚ç‡å¢åŠ   
âœ… æ¨èï¼š5-10åˆ†é’Ÿï¼Œå¹³è¡¡å®‰å…¨æ€§å’Œç”¨æˆ·ä½“éªŒ
```

**ğŸ• æ—¶é—´æˆ³éªŒè¯å®ç°**

```java
public class SamlTimeValidator {
    
    private static final long DEFAULT_CLOCK_SKEW = 300; // 5åˆ†é’Ÿæ—¶é’Ÿåå·®
    private static final long DEFAULT_VALIDITY_PERIOD = 600; // 10åˆ†é’Ÿæœ‰æ•ˆæœŸ
    
    public boolean validateTimestamp(Assertion assertion) {
        Conditions conditions = assertion.getConditions();
        if (conditions == null) {
            return false;  // æ²¡æœ‰æ—¶é—´æ¡ä»¶ï¼Œæ‹’ç»
        }
        
        DateTime now = new DateTime();
        DateTime notBefore = conditions.getNotBefore();
        DateTime notOnOrAfter = conditions.getNotOnOrAfter();
        
        // æ£€æŸ¥ç”Ÿæ•ˆæ—¶é—´ï¼ˆè€ƒè™‘æ—¶é’Ÿåå·®ï¼‰
        if (notBefore != null) {
            DateTime earliestValid = notBefore.minusSeconds((int) DEFAULT_CLOCK_SKEW);
            if (now.isBefore(earliestValid)) {
                log.warn("æ–­è¨€å°šæœªç”Ÿæ•ˆ: notBefore={}, now={}", notBefore, now);
                return false;
            }
        }
        
        // æ£€æŸ¥è¿‡æœŸæ—¶é—´ï¼ˆè€ƒè™‘æ—¶é’Ÿåå·®ï¼‰
        if (notOnOrAfter != null) {
            DateTime latestValid = notOnOrAfter.plusSeconds((int) DEFAULT_CLOCK_SKEW);
            if (now.isAfter(latestValid)) {
                log.warn("æ–­è¨€å·²è¿‡æœŸ: notOnOrAfter={}, now={}", notOnOrAfter, now);
                return false;
            }
        }
        
        return true;
    }
    
    public Conditions createTimeConditions() {
        DateTime now = new DateTime();
        DateTime notBefore = now;  // ç«‹å³ç”Ÿæ•ˆ
        DateTime notOnOrAfter = now.plusSeconds((int) DEFAULT_VALIDITY_PERIOD);
        
        ConditionsBuilder builder = new ConditionsBuilder();
        return builder
            .setNotBefore(notBefore)
            .setNotOnOrAfter(notOnOrAfter)
            .build();
    }
    
    // æ£€æŸ¥æ–­è¨€æ˜¯å¦æ¥è¿‘è¿‡æœŸ
    public boolean isNearExpiry(Assertion assertion, long warningSeconds) {
        Conditions conditions = assertion.getConditions();
        if (conditions == null || conditions.getNotOnOrAfter() == null) {
            return false;
        }
        
        DateTime notOnOrAfter = conditions.getNotOnOrAfter();
        DateTime warningTime = notOnOrAfter.minusSeconds((int) warningSeconds);
        DateTime now = new DateTime();
        
        return now.isAfter(warningTime);
    }
}
```

### 5.4 ç»¼åˆå®‰å…¨é˜²æŠ¤ç­–ç•¥


**ğŸ›¡ï¸ å¤šå±‚å®‰å…¨é˜²æŠ¤**

```java
@Component  
public class SamlSecurityValidator {
    
    @Autowired
    private SamlSignatureUtil signatureUtil;
    
    @Autowired
    private SamlTimeValidator timeValidator;
    
    // ç»¼åˆå®‰å…¨éªŒè¯
    public ValidationResult validateAssertion(Assertion assertion, 
                                            SecurityContext context) {
        ValidationResult result = new ValidationResult();
        
        // 1. ç­¾åéªŒè¯
        if (!signatureUtil.verifySignature(assertion, context.getIdpPublicKey())) {
            result.addError("æ•°å­—ç­¾åéªŒè¯å¤±è´¥");
            return result;
        }
        
        // 2. æ—¶é—´æˆ³éªŒè¯
        if (!timeValidator.validateTimestamp(assertion)) {
            result.addError("æ—¶é—´æˆ³éªŒè¯å¤±è´¥");
            return result;
        }
        
        // 3. å—ä¼—éªŒè¯
        if (!validateAudience(assertion, context.getExpectedAudience())) {
            result.addError("å—ä¼—éªŒè¯å¤±è´¥");
            return result;
        }
        
        // 4. é‡æ”¾æ”»å‡»æ£€æµ‹
        if (isReplayAttack(assertion)) {
            result.addError("æ£€æµ‹åˆ°é‡æ”¾æ”»å‡»");
            return result;
        }
        
        // 5. é¢å‘è€…éªŒè¯
        if (!validateIssuer(assertion, context.getTrustedIssuers())) {
            result.addError("é¢å‘è€…éªŒè¯å¤±è´¥");
            return result;
        }
        
        result.setValid(true);
        return result;
    }
    
    private boolean validateAudience(Assertion assertion, String expectedAudience) {
        Conditions conditions = assertion.getConditions();
        if (conditions == null) return false;
        
        List<AudienceRestriction> restrictions = conditions.getAudienceRestrictions();
        if (restrictions.isEmpty()) return false;
        
        return restrictions.stream()
            .flatMap(r -> r.getAudiences().stream())
            .anyMatch(audience -> expectedAudience.equals(audience.getAudienceURI()));
    }
    
    private boolean isReplayAttack(Assertion assertion) {
        String assertionId = assertion.getID();
        
        // æ£€æŸ¥æ˜¯å¦å·²ç»å¤„ç†è¿‡è¿™ä¸ªæ–­è¨€
        if (processedAssertions.containsKey(assertionId)) {
            log.warn("æ£€æµ‹åˆ°é‡æ”¾æ”»å‡»ï¼Œæ–­è¨€ID: {}", assertionId);
            return true;
        }
        
        // è®°å½•å·²å¤„ç†çš„æ–­è¨€ï¼ˆè®¾ç½®è¿‡æœŸæ—¶é—´ï¼‰
        processedAssertions.put(assertionId, System.currentTimeMillis());
        
        return false;
    }
}
```

---

## 6. ğŸ’¼ SAMLå®æˆ˜åº”ç”¨åœºæ™¯


### 6.1 ä¼ä¸šå†…éƒ¨ç³»ç»Ÿé›†æˆ


**ğŸ¢ å…¸å‹ä¼ä¸šåº”ç”¨æ¶æ„**

```
ä¼ä¸šSAMLé›†æˆæ¶æ„ï¼š

                    å‘˜å·¥æµè§ˆå™¨
                         |
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚    ä¼ä¸šé—¨æˆ·ç½‘ç«™      â”‚
              â”‚  (https://portal    â”‚  
              â”‚   .company.com)     â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         |
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   ç»Ÿä¸€è®¤è¯ä¸­å¿ƒ       â”‚
              â”‚     (IdP)          â”‚ â† Active Directory
              â”‚  SAML Tokenç­¾å‘     â”‚   ç”¨æˆ·ç›®å½•
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         |
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        |                |                |
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”
   â”‚OAåŠå…¬  â”‚      â”‚è´¢åŠ¡    â”‚      â”‚äººäº‹    â”‚
   â”‚ç³»ç»Ÿ(SP)â”‚      â”‚ç³»ç»Ÿ(SP)â”‚      â”‚ç³»ç»Ÿ(SP)â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ’» ä¼ä¸šé—¨æˆ·é›†æˆä»£ç **

```java
@Controller
public class EnterprisePortalController {
    
    @GetMapping("/")
    public String showPortal(HttpServletRequest request, Model model) {
        // æ£€æŸ¥ç”¨æˆ·è®¤è¯çŠ¶æ€
        String samlToken = getSamlTokenFromSession(request);
        if (samlToken == null) {
            return "redirect:/login";
        }
        
        // è§£æç”¨æˆ·ä¿¡æ¯
        User user = parseUserFromSaml(samlToken);
        
        // è·å–ç”¨æˆ·æœ‰æƒé™è®¿é—®çš„ç³»ç»Ÿ
        List<Application> authorizedApps = getAuthorizedApplications(user);
        
        model.addAttribute("user", user);
        model.addAttribute("applications", authorizedApps);
        
        return "portal-dashboard";
    }
    
    @GetMapping("/launch/{appCode}")  
    public String launchApplication(@PathVariable String appCode,
                                   HttpServletRequest request) {
        User user = getCurrentUser(request);
        Application app = applicationService.findByCode(appCode);
        
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®è¯¥åº”ç”¨
        if (!hasPermission(user, app)) {
            throw new AccessDeniedException("æ— æƒé™è®¿é—®è¯¥ç³»ç»Ÿ");
        }
        
        // ç”Ÿæˆåº”ç”¨ä¸“ç”¨çš„SAMLæ–­è¨€
        String assertion = samlService.createAssertionForApp(user, app);
        
        // é‡å®šå‘åˆ°ç›®æ ‡åº”ç”¨
        return buildAutoSubmitForm(app.getSamlEndpoint(), assertion);
    }
    
    private List<Application> getAuthorizedApplications(User user) {
        // æ ¹æ®ç”¨æˆ·è§’è‰²å’Œæƒé™è·å–å¯è®¿é—®çš„åº”ç”¨åˆ—è¡¨
        return applicationService.findByUserRoles(user.getRoles());
    }
}
```

### 6.2 è·¨åŸŸä¼ä¸šåˆä½œ


**ğŸ¤ ä¼ä¸šé—´SAMLè”é‚¦**

```
ä¼ä¸šAä¸ä¼ä¸šBçš„SAMLè”é‚¦ï¼š

ä¼ä¸šAå‘˜å·¥                ä¼ä¸šBç³»ç»Ÿ
    |                       |
    |--è®¿é—®ä¼ä¸šBçš„CRMç³»ç»Ÿ--->|
    |                       |
    |<--é‡å®šå‘åˆ°ä¼ä¸šA IdP----|
    |                       |
ä¼ä¸šA IdP                   |
    |                       |
    |<--ç”¨æˆ·ç™»å½•è®¤è¯-----å‘˜å·¥  |
    |                       |
    |--é¢å‘è”é‚¦æ–­è¨€--------->|ä¼ä¸šB SP
    |                       |
    |                   éªŒè¯æ–­è¨€
    |                   åˆ›å»ºä¸´æ—¶è´¦æˆ·
    |                   æˆäºˆè®¿é—®æƒé™
```

**ğŸ”— è”é‚¦ä¿¡ä»»é…ç½®**

```java
@Configuration
public class FederationTrustConfig {
    
    // ä¿¡ä»»çš„è”é‚¦ä¼™ä¼´é…ç½®
    @Bean
    public Map<String, FederationPartner> trustedPartners() {
        Map<String, FederationPartner> partners = new HashMap<>();
        
        // ä¼ä¸šBä½œä¸ºè”é‚¦ä¼™ä¼´
        FederationPartner partnerB = FederationPartner.builder()
            .entityId("https://company-b.com/saml/metadata")
            .idpSsoUrl("https://sso.company-b.com/saml/login")
            .publicKey(loadPartnerPublicKey("partner-b-cert.pem"))
            .attributeMapping(createAttributeMapping())
            .trustLevel(TrustLevel.HIGH)
            .build();
            
        partners.put("company-b", partnerB);
        return partners;
    }
    
    private AttributeMapping createAttributeMapping() {
        // å±æ€§æ˜ å°„ï¼šä¼ä¸šBçš„å±æ€§å -> æœ¬ä¼ä¸šå±æ€§å
        return AttributeMapping.builder()
            .map("companyB.email", "email")
            .map("companyB.department", "department")  
            .map("companyB.role", "externalRole")
            .build();
    }
    
    // è”é‚¦ç”¨æˆ·å¤„ç†
    @Component
    public class FederatedUserProcessor {
        
        public User processFederatedAssertion(Assertion assertion, 
                                            FederationPartner partner) {
            // æå–è”é‚¦ç”¨æˆ·å±æ€§
            Map<String, String> attributes = extractAttributes(assertion);
            
            // å±æ€§æ˜ å°„è½¬æ¢
            Map<String, String> mappedAttrs = partner.getAttributeMapping()
                .transform(attributes);
            
            // åˆ›å»ºæˆ–æ›´æ–°è”é‚¦ç”¨æˆ·
            User federatedUser = createFederatedUser(mappedAttrs, partner);
            
            // åº”ç”¨è”é‚¦ç”¨æˆ·æƒé™ç­–ç•¥
            applyFederatedPermissions(federatedUser, partner);
            
            return federatedUser;
        }
        
        private void applyFederatedPermissions(User user, FederationPartner partner) {
            // è”é‚¦ç”¨æˆ·é€šå¸¸åªç»™äºˆå—é™æƒé™
            Set<String> federatedRoles = Set.of("FEDERATED_USER", "READ_ONLY");
            user.setRoles(federatedRoles);
            
            // è®¾ç½®è®¿é—®é™åˆ¶
            user.setAccessRestrictions(partner.getAccessPolicy());
            
            // è®¾ç½®ä¼šè¯æœ‰æ•ˆæœŸï¼ˆé€šå¸¸æ¯”å†…éƒ¨ç”¨æˆ·çŸ­ï¼‰
            user.setSessionTimeout(partner.getSessionTimeout());
        }
    }
}
```

### 6.3 äº‘æœåŠ¡SAMLé›†æˆ


**â˜ï¸ ä¸SaaSæœåŠ¡é›†æˆ**

```java
@Service
public class CloudServiceIntegration {
    
    // å¸¸è§äº‘æœåŠ¡SAMLé›†æˆé…ç½®
    @PostConstruct
    public void initializeCloudServices() {
        // Salesforce SAMLé…ç½®
        configureService("salesforce", CloudServiceConfig.builder()
            .serviceProviderUrl("https://company.my.salesforce.com")
            .acsUrl("https://company.my.salesforce.com/saml/acs")
            .issuer("https://sso.company.com")
            .nameIdFormat("urn:oasis:names:tc:SAML:2.0:nameid-format:persistent")
            .attributeMapping(Map.of(
                "email", "Email",
                "firstName", "FirstName", 
                "lastName", "LastName",
                "department", "Department"
            ))
            .build());
            
        // Office 365 SAMLé…ç½®  
        configureService("office365", CloudServiceConfig.builder()
            .serviceProviderUrl("https://login.microsoftonline.com")
            .acsUrl("https://login.microsoftonline.com/login.srf")
            .issuer("https://sso.company.com")
            .nameIdFormat("urn:oasis:names:tc:SAML:2.0:nameid-format:persistent")
            .attributeMapping(Map.of(
                "email", "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name",
                "firstName", "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/givenname",
                "lastName", "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/surname"
            ))
            .build());
    }
    
    // ä¸ºäº‘æœåŠ¡ç”Ÿæˆç‰¹å®šæ ¼å¼çš„æ–­è¨€
    public String generateCloudServiceAssertion(String serviceId, User user) {
        CloudServiceConfig config = getServiceConfig(serviceId);
        
        AssertionBuilder builder = new AssertionBuilder()
            .setIssuer(config.getIssuer())
            .setSubject(user.getEmail(), config.getNameIdFormat())
            .setAudience(config.getServiceProviderUrl())
            .setDestination(config.getAcsUrl());
            
        // æ·»åŠ äº‘æœåŠ¡è¦æ±‚çš„å±æ€§
        config.getAttributeMapping().forEach((localAttr, cloudAttr) -> {
            String value = user.getAttribute(localAttr);
            if (value != null) {
                builder.addAttribute(cloudAttr, value);
            }
        });
        
        return builder.build().toXmlString();
    }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ SAMLæœ¬è´¨ï¼šä¼ä¸šçº§"æ•°å­—èº«ä»½è¯"ï¼Œå®ç°è·¨ç³»ç»Ÿèº«ä»½ä¼ é€’
ğŸ”¸ ä¸‰ç§æ–­è¨€ï¼šè®¤è¯æ–­è¨€ï¼ˆè¯æ˜èº«ä»½ï¼‰ã€æˆæƒæ–­è¨€ï¼ˆè¯´æ˜æƒé™ï¼‰ã€å±æ€§æ–­è¨€ï¼ˆç”¨æˆ·ä¿¡æ¯ï¼‰
ğŸ”¸ ä¸¤ä¸ªè§’è‰²ï¼šSPæä¾›æœåŠ¡ä½†ä¸ç®¡è®¤è¯ï¼ŒIdPä¸“é—¨è´Ÿè´£èº«ä»½éªŒè¯
ğŸ”¸ ä¸‰ç§æ¨¡å¼ï¼šSPå‘èµ·ï¼ˆä»æœåŠ¡è¿›å…¥ï¼‰ã€IdPå‘èµ·ï¼ˆä»é—¨æˆ·è¿›å…¥ï¼‰ã€æ··åˆæ¨¡å¼
ğŸ”¸ å®‰å…¨æœºåˆ¶ï¼šæ•°å­—ç­¾åï¼ˆé˜²ç¯¡æ”¹ï¼‰ã€XMLåŠ å¯†ï¼ˆä¿æŠ¤éšç§ï¼‰ã€æ—¶é—´æˆ³ï¼ˆé˜²é‡æ”¾ï¼‰
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ SAML vs å…¶ä»–è®¤è¯æ–¹å¼**
```
Session/Cookieï¼šé€‚åˆå•ç³»ç»Ÿï¼Œç®€å•ä½†ä¸èƒ½è·¨åŸŸ
JWT Tokenï¼šè½»é‡çº§ï¼Œé€‚åˆAPIï¼Œä½†ç¼ºä¹ä¼ä¸šçº§å®‰å…¨ç‰¹æ€§  
SAMLï¼šä¼ä¸šçº§æ ‡å‡†ï¼ŒåŠŸèƒ½å®Œæ•´ï¼Œå®‰å…¨æ€§é«˜ï¼Œé€‚åˆè·¨åŸŸè·¨ç»„ç»‡
```

**ğŸ”¹ æ–­è¨€çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†**
```
ç”Ÿæˆ â†’ ç­¾å â†’ ä¼ è¾“ â†’ éªŒè¯ â†’ ä½¿ç”¨ â†’ è¿‡æœŸ
æ¯ä¸ªç¯èŠ‚éƒ½æœ‰å®‰å…¨æ§åˆ¶æªæ–½
```

**ğŸ”¹ ä¼ä¸šéƒ¨ç½²çš„å…³é”®å†³ç­–**
```
é€‰æ‹©SPå‘èµ· vs IdPå‘èµ·ï¼š
- ç”¨æˆ·ä¹ æƒ¯ï¼šå–œæ¬¢ä¹¦ç­¾ç›´è¾¾ â†’ SPå‘èµ·
- å®‰å…¨è¦æ±‚ï¼šé›†ä¸­æ§åˆ¶å…¥å£ â†’ IdPå‘èµ·  
- ç”¨æˆ·ä½“éªŒï¼šä¸¤è€…éƒ½æ”¯æŒ â†’ æ··åˆæ¨¡å¼
```

### 7.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ’¼ ä¼ä¸šåº”ç”¨åœºæ™¯**
- **å†…éƒ¨ç³»ç»Ÿæ•´åˆ**ï¼šä¸€æ¬¡ç™»å½•è®¿é—®æ‰€æœ‰å†…éƒ¨ç³»ç»Ÿ
- **ä¾›åº”å•†ç³»ç»Ÿå¯¹æ¥**ï¼šåˆä½œä¼™ä¼´ç³»ç»Ÿçš„å®‰å…¨è®¿é—®
- **äº‘æœåŠ¡é›†æˆ**ï¼šSalesforceã€Office365ç­‰SaaSæœåŠ¡æ¥å…¥
- **åˆè§„è¦æ±‚**ï¼šæ»¡è¶³ä¼ä¸šå®‰å…¨å®¡è®¡å’Œåˆè§„è¦æ±‚

**ğŸ”§ æŠ€æœ¯åº”ç”¨ä¼˜åŠ¿**
- **æ ‡å‡†åŒ–**ï¼šéµå¾ªå›½é™…æ ‡å‡†ï¼Œå…¼å®¹æ€§å¥½
- **å®‰å…¨æ€§**ï¼šå¤šå±‚å®‰å…¨æœºåˆ¶ï¼Œé€‚åˆä¼ä¸šç¯å¢ƒ
- **å¯æ‰©å±•æ€§**ï¼šæ˜“äºé›†æˆæ–°ç³»ç»Ÿå’ŒæœåŠ¡
- **å¯å®¡è®¡æ€§**ï¼šå®Œæ•´çš„è®¤è¯å’Œè®¿é—®æ—¥å¿—

### 7.4 å®æ–½æœ€ä½³å®è·µ


**ğŸ† éƒ¨ç½²å»ºè®®**
```
å¼€å‘é˜¶æ®µï¼š
âœ… å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯é…ç½®
âœ… ä½¿ç”¨æ ‡å‡†SAMLæµ‹è¯•å·¥å…·éªŒè¯æ–­è¨€æ ¼å¼
âœ… å‡†å¤‡è¯¦ç»†çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

å®‰å…¨é…ç½®ï¼š
âœ… å¯ç”¨æ•°å­—ç­¾åï¼ŒéªŒè¯æ‰€æœ‰æ–­è¨€
âœ… è®¾ç½®åˆç†çš„æ–­è¨€æœ‰æ•ˆæœŸï¼ˆ5-10åˆ†é’Ÿï¼‰
âœ… é…ç½®HTTPSï¼Œä¿æŠ¤ä¼ è¾“å®‰å…¨
âœ… å®šæœŸè½®æ¢ç­¾åè¯ä¹¦

è¿ç»´ç›‘æ§ï¼š
âœ… ç›‘æ§è®¤è¯å¤±è´¥ç‡å’Œå“åº”æ—¶é—´
âœ… è®¾ç½®æ–­è¨€éªŒè¯å¤±è´¥å‘Šè­¦
âœ… å®šæœŸå®‰å…¨å®¡è®¡å’Œæ¼æ´æ‰«æ
```

**ğŸ”§ å¸¸è§é—®é¢˜é¢„é˜²**
```
æ—¶é’ŸåŒæ­¥ï¼šç¡®ä¿IdPå’ŒSPæœåŠ¡å™¨æ—¶é—´åŒæ­¥
è¯ä¹¦ç®¡ç†ï¼šå»ºç«‹è¯ä¹¦æ›´æ–°å’Œåˆ†å‘æœºåˆ¶
é”™è¯¯å¤„ç†ï¼šæä¾›å‹å¥½çš„é”™è¯¯é¡µé¢å’Œæ—¥å¿—
æ€§èƒ½ä¼˜åŒ–ï¼šç¼“å­˜è¯ä¹¦éªŒè¯ç»“æœï¼Œæé«˜æ€§èƒ½
```

### 7.5 å­¦ä¹ è¿›é˜¶æ–¹å‘


**ğŸ“ˆ æŠ€æœ¯æ·±åŒ–è·¯å¾„**
```
åŸºç¡€æŒæ¡ â†’ å®‰å…¨åŠ å›º â†’ æ€§èƒ½ä¼˜åŒ– â†’ ä¼ä¸šé›†æˆ
    â†“           â†“           â†“           â†“
é…ç½®è°ƒé€š    ç­¾åéªŒè¯    ç¼“å­˜ä¼˜åŒ–    è”é‚¦é…ç½®
æ–­è¨€è§£æ    åŠ å¯†ä¼ è¾“    è´Ÿè½½å‡è¡¡    äº‘æœåŠ¡é›†æˆ
æµç¨‹ç†è§£    ç›‘æ§å‘Šè­¦    é«˜å¯ç”¨     è·¨åŸŸè®¤è¯
```

**ğŸ› ï¸ ç›¸å…³æŠ€èƒ½å»ºè®®**
- **XMLå¤„ç†**ï¼šç†Ÿç»ƒå¤„ç†XMLæ ¼å¼çš„æ–­è¨€å’Œé…ç½®
- **å¯†ç å­¦åŸºç¡€**ï¼šç†è§£æ•°å­—ç­¾åå’ŒåŠ å¯†åŸç†
- **Webå®‰å…¨**ï¼šæŒæ¡å¸¸è§Webæ”»å‡»å’Œé˜²æŠ¤æªæ–½
- **ä¼ä¸šæ¶æ„**ï¼šç†è§£ä¼ä¸šITæ¶æ„å’Œé›†æˆæ¨¡å¼

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
SAMLæ–­è¨€åƒèº«ä»½è¯ï¼Œè·¨åŸŸè®¤è¯æœ€é€‚åˆ
ä¸‰ç§æ–­è¨€è¯´æ˜ç™½ï¼Œè®¤è¯æˆæƒåŠ å±æ€§
SPå‘èµ·å’ŒIdPå‘èµ·ï¼Œæ··åˆæ¨¡å¼æ›´çµæ´»
æ•°å­—ç­¾åé˜²ç¯¡æ”¹ï¼ŒåŠ å¯†ä¼ è¾“ä¿éšç§
æ—¶é—´æˆ³é˜²é‡æ”¾æ”»å‡»ï¼Œä¼ä¸šå®‰å…¨æœ‰ä¿éšœ
```