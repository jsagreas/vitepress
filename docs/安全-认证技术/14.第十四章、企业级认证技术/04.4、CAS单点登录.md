---
title: 4ã€CASå•ç‚¹ç™»å½•
---
## ğŸ“š ç›®å½•

1. [CASå•ç‚¹ç™»å½•æ¦‚è¿°](#1-CASå•ç‚¹ç™»å½•æ¦‚è¿°)
2. [CASæ ¸å¿ƒæ¶æ„è¯¦è§£](#2-CASæ ¸å¿ƒæ¶æ„è¯¦è§£)
3. [ç¥¨æ®æœºåˆ¶æ·±å…¥è§£æ](#3-ç¥¨æ®æœºåˆ¶æ·±å…¥è§£æ)
4. [CASè®¤è¯æµç¨‹è¯¦è§£](#4-CASè®¤è¯æµç¨‹è¯¦è§£)
5. [CASåè®®ç‰ˆæœ¬æ¼”è¿›](#5-CASåè®®ç‰ˆæœ¬æ¼”è¿›)
6. [å¤šåè®®æ”¯æŒä¸é›†æˆ](#6-å¤šåè®®æ”¯æŒä¸é›†æˆ)
7. [å®æ–½éƒ¨ç½²è¦ç‚¹](#7-å®æ–½éƒ¨ç½²è¦ç‚¹)
8. [é«˜å¯ç”¨æ¶æ„è®¾è®¡](#8-é«˜å¯ç”¨æ¶æ„è®¾è®¡)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ CASå•ç‚¹ç™»å½•æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯CASï¼Ÿ


**CASï¼ˆCentral Authentication Serviceï¼‰** æ˜¯ä¸€ä¸ªå¼€æºçš„ã€åŸºäºWebçš„å•ç‚¹ç™»å½•åè®®å’Œæ¡†æ¶ã€‚ç®€å•æ¥è¯´ï¼ŒCASå°±åƒä¸€ä¸ª**ç»Ÿä¸€çš„é—¨å«ç³»ç»Ÿ**ã€‚

```
ä¼ ç»Ÿç™»å½•æ–¹å¼ï¼š
ç”¨æˆ· â†’ ç³»ç»ŸA (è¾“å…¥è´¦å·å¯†ç )
ç”¨æˆ· â†’ ç³»ç»ŸB (å†æ¬¡è¾“å…¥è´¦å·å¯†ç )  
ç”¨æˆ· â†’ ç³»ç»ŸC (åˆè¦è¾“å…¥è´¦å·å¯†ç )

CASå•ç‚¹ç™»å½•ï¼š
ç”¨æˆ· â†’ CASé—¨å« (åªè¾“å…¥ä¸€æ¬¡è´¦å·å¯†ç )
      â†“
   è·å¾—é€šè¡Œè¯
      â†“
ç³»ç»ŸAã€Bã€Céƒ½è®¤å¯è¿™ä¸ªé€šè¡Œè¯ï¼Œç›´æ¥è¿›å…¥
```

> ğŸ’¡ **é€šä¿—ç†è§£**
> 
> CASå°±åƒé…’åº—çš„æ€»å‰å°ï¼Œä½ åœ¨æ€»å‰å°åŠç†å…¥ä½æ‰‹ç»­åï¼Œæ‹¿ç€æˆ¿å¡å¯ä»¥è¿›å…¥å¥èº«æˆ¿ã€é¤å…ã€ä¼šè®®å®¤ç­‰å„ä¸ªåœ°æ–¹ï¼Œä¸éœ€è¦åœ¨æ¯ä¸ªåœ°æ–¹éƒ½é‡æ–°ç™»è®°èº«ä»½ã€‚

### 1.2 CASè§£å†³çš„æ ¸å¿ƒé—®é¢˜


**ğŸ”¸ ç”¨æˆ·ä½“éªŒé—®é¢˜**
- **é‡å¤ç™»å½•çƒ¦æ¼**ï¼šé¿å…åœ¨å¤šä¸ªç³»ç»Ÿé—´é‡å¤è¾“å…¥ç”¨æˆ·åå¯†ç 
- **å¯†ç è®°å¿†è´Ÿæ‹…**ï¼šç”¨æˆ·åªéœ€è®°ä½ä¸€å¥—ç™»å½•å‡­è¯
- **ç™»å½•çŠ¶æ€ç»Ÿä¸€**ï¼šä¸€æ¬¡ç™»å½•ï¼Œå¤„å¤„å¯ç”¨

**ğŸ”¸ ä¼ä¸šç®¡ç†é—®é¢˜**
- **è´¦æˆ·ç®¡ç†å¤æ‚**ï¼šç»Ÿä¸€ç”¨æˆ·èº«ä»½ç®¡ç†
- **å®‰å…¨é£é™©åˆ†æ•£**ï¼šé›†ä¸­è®¤è¯ï¼Œé™ä½å®‰å…¨é£é™©
- **å¼€å‘æˆæœ¬é«˜**ï¼šå„ç³»ç»Ÿä¸éœ€è¦é‡å¤å¼€å‘è®¤è¯åŠŸèƒ½

---

## 2. ğŸ—ï¸ CASæ ¸å¿ƒæ¶æ„è¯¦è§£


### 2.1 CASæ¶æ„ä¸‰å¤§ç»„ä»¶


```
CASæ¶æ„å…¨æ™¯å›¾ï¼š

    ç”¨æˆ·æµè§ˆå™¨              CAS Server               å„ä¸šåŠ¡ç³»ç»Ÿ
        |                     |                        |
   [1] è®¿é—®ç³»ç»ŸA          [ç»Ÿä¸€è®¤è¯ä¸­å¿ƒ]           [ç³»ç»ŸA - CAS Client]
        |                     |                        |
   [2] é‡å®šå‘è®¤è¯      [è®¤è¯ã€é¢å‘ç¥¨æ®]           [ç³»ç»ŸB - CAS Client] 
        |                     |                        |
   [3] è¾“å…¥ç”¨æˆ·åå¯†ç     [éªŒè¯ç”¨æˆ·èº«ä»½]           [ç³»ç»ŸC - CAS Client]
        |                     |                        |
   [4] è·å¾—ç¥¨æ®            [ç¥¨æ®ç®¡ç†]                   |
        |                     |                        |
   [5] å‡­ç¥¨æ®è®¿é—®ç³»ç»Ÿ    [ç¥¨æ®éªŒè¯æœåŠ¡]           [éªŒè¯ç¥¨æ®æœ‰æ•ˆæ€§]
```

### 2.2 CAS Serverï¼ˆè®¤è¯æœåŠ¡å™¨ï¼‰


**ğŸ”¸ æ ¸å¿ƒèŒè´£**
```
CAS Serverå°±åƒä¸€ä¸ªä¸“ä¸šçš„èº«ä»½éªŒè¯ä¸­å¿ƒï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           CAS Server                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ” ç”¨æˆ·èº«ä»½éªŒè¯                    â”‚
â”‚      - ç”¨æˆ·åå¯†ç éªŒè¯               â”‚
â”‚      - LDAP/æ•°æ®åº“é›†æˆ              â”‚
â”‚      - å¤šå› ç´ è®¤è¯æ”¯æŒ               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ« ç¥¨æ®ç”Ÿå‘½å‘¨æœŸç®¡ç†                â”‚
â”‚      - TGTç”Ÿæˆä¸ç®¡ç†                â”‚
â”‚      - STé¢å‘ä¸éªŒè¯                 â”‚
â”‚      - ç¥¨æ®è¿‡æœŸæ§åˆ¶                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸŒ ç»Ÿä¸€ç™»å½•ç•Œé¢                    â”‚
â”‚      - ç™»å½•é¡µé¢å±•ç¤º                 â”‚
â”‚      - ç™»å‡ºé¡µé¢å¤„ç†                 â”‚
â”‚      - é”™è¯¯ä¿¡æ¯å±•ç¤º                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”§ æ ¸å¿ƒé…ç½®ç¤ºä¾‹**
```xml
<!-- CAS Server åŸºç¡€é…ç½® -->
<cas-server>
    <!-- è®¤è¯ç­–ç•¥é…ç½® -->
    <authentication-handlers>
        <handler class="DatabaseAuthenticationHandler">
            <property name="dataSource" ref="userDataSource"/>
            <property name="sql" value="SELECT password FROM users WHERE username=?"/>
        </handler>
    </authentication-handlers>
    
    <!-- ç¥¨æ®ç­–ç•¥é…ç½® -->
    <ticket-registry class="DefaultTicketRegistry">
        <property name="tgtTimeout" value="7200"/> <!-- TGT 2å°æ—¶è¿‡æœŸ -->
        <property name="stTimeout" value="300"/>   <!-- ST 5åˆ†é’Ÿè¿‡æœŸ -->
    </ticket-registry>
</cas-server>
```

### 2.3 CAS Clientï¼ˆå®¢æˆ·ç«¯åº”ç”¨ï¼‰


**ğŸ”¸ å®¢æˆ·ç«¯èŒè´£**
```
CAS Clientå°±åƒå„ä¸ªç³»ç»Ÿçš„é—¨å«ï¼š

ç³»ç»ŸAä¸­çš„CAS Clientï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ç³»ç»ŸA (CAS Client)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸšª æ‹¦æˆªç”¨æˆ·è®¿é—®è¯·æ±‚        â”‚
â”‚  ğŸ« æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æœ‰æ•ˆç¥¨æ®  â”‚
â”‚  â†—ï¸  æ— ç¥¨æ®â†’é‡å®šå‘åˆ°CASç™»å½•  â”‚
â”‚  âœ… æœ‰ç¥¨æ®â†’å‘CASéªŒè¯ç¥¨æ®     â”‚
â”‚  ğŸ  éªŒè¯é€šè¿‡â†’å…è®¸è®¿é—®ç³»ç»Ÿ    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”§ Javaå®¢æˆ·ç«¯é›†æˆç¤ºä¾‹**
```java
// Spring Bootä¸­é›†æˆCASå®¢æˆ·ç«¯
@Configuration
public class CasConfig {
    
    @Bean
    public FilterRegistrationBean casAuthenticationFilter() {
        FilterRegistrationBean registration = new FilterRegistrationBean();
        
        // CASè®¤è¯è¿‡æ»¤å™¨
        AuthenticationFilter authFilter = new AuthenticationFilter();
        authFilter.setCasServerLoginUrl("https://cas-server.com/login");
        authFilter.setServerName("https://app-a.com");
        
        registration.setFilter(authFilter);
        registration.setUrlPatterns(Arrays.asList("/*"));
        registration.setOrder(1);
        
        return registration;
    }
    
    @Bean
    public FilterRegistrationBean casValidationFilter() {
        FilterRegistrationBean registration = new FilterRegistrationBean();
        
        // ç¥¨æ®éªŒè¯è¿‡æ»¤å™¨
        Cas20ProxyReceivingTicketValidationFilter validationFilter 
            = new Cas20ProxyReceivingTicketValidationFilter();
        validationFilter.setCasServerUrlPrefix("https://cas-server.com");
        validationFilter.setServerName("https://app-a.com");
        
        registration.setFilter(validationFilter);
        registration.setUrlPatterns(Arrays.asList("/*"));
        registration.setOrder(2);
        
        return registration;
    }
}
```

### 2.4 ç¥¨æ®ç³»ç»Ÿï¼ˆTicket Systemï¼‰


**ğŸ”¸ ç¥¨æ®ç³»ç»Ÿæ¶æ„**
```
ç¥¨æ®ç³»ç»Ÿå°±åƒä¸€ä¸ªå®Œæ•´çš„é€šè¡Œè¯ç®¡ç†ä½“ç³»ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CASç¥¨æ®ç³»ç»Ÿ                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ« TGT (Ticket Granting Ticket) - æ€»é€šè¡Œè¯             â”‚
â”‚      - ç”¨æˆ·æˆåŠŸç™»å½•åé¢å‘                               â”‚
â”‚      - é•¿æœŸæœ‰æ•ˆï¼ˆå¦‚2å°æ—¶ï¼‰                              â”‚
â”‚      - ç”¨äºè·å–å…¶ä»–ç¥¨æ®                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸŸï¸ ST (Service Ticket) - æœåŠ¡ç¥¨æ®                     â”‚
â”‚      - é’ˆå¯¹ç‰¹å®šæœåŠ¡çš„ä¸´æ—¶ç¥¨æ®                           â”‚
â”‚      - çŸ­æœŸæœ‰æ•ˆï¼ˆå¦‚5åˆ†é’Ÿï¼‰                              â”‚
â”‚      - ä¸€æ¬¡æ€§ä½¿ç”¨                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸª PGT (Proxy Granting Ticket) - ä»£ç†æˆæƒç¥¨æ®         â”‚
â”‚      - æ”¯æŒä»£ç†è®¤è¯åœºæ™¯                                 â”‚
â”‚      - ç”¨äºåç«¯æœåŠ¡é—´è°ƒç”¨                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. ğŸ« ç¥¨æ®æœºåˆ¶æ·±å…¥è§£æ


### 3.1 TGTï¼ˆTicket Granting Ticketï¼‰è¯¦è§£


**ğŸ”¸ TGTçš„æœ¬è´¨**
TGTå°±åƒæ˜¯ä¸€å¼ **VIPä¼šå‘˜å¡**ï¼Œè¯æ˜ä½ å·²ç»é€šè¿‡äº†èº«ä»½éªŒè¯ï¼Œå¯ä»¥ç”¨è¿™å¼ å¡å»è·å–è¿›å…¥å„ä¸ªå…·ä½“åœºæ‰€çš„é—¨ç¥¨ã€‚

```
TGTçš„ç”Ÿå‘½å‘¨æœŸï¼š

ç”¨æˆ·ç™»å½•æˆåŠŸ
    â†“
CAS Serverç”ŸæˆTGT
    â†“
TGTå­˜å‚¨åœ¨CAS Serverä¸­
    â†“
TGT-Cookieå‘é€ç»™ç”¨æˆ·æµè§ˆå™¨
    â†“
ç”¨æˆ·è®¿é—®å…¶ä»–ç³»ç»Ÿæ—¶æºå¸¦TGT-Cookie
    â†“
CAS Serveræ ¹æ®TGTé¢å‘ST
    â†“
TGTè¿‡æœŸæˆ–ç”¨æˆ·ç™»å‡ºæ—¶é”€æ¯
```

**ğŸ”§ TGTæ•°æ®ç»“æ„**
```java
public class TicketGrantingTicket {
    private String id;                    // TGTå”¯ä¸€æ ‡è¯†
    private Authentication authentication; // è®¤è¯ä¿¡æ¯
    private long creationTime;            // åˆ›å»ºæ—¶é—´
    private long expirationTime;          // è¿‡æœŸæ—¶é—´
    private Map<String, Service> services; // å·²è®¿é—®çš„æœåŠ¡åˆ—è¡¨
    
    // ç”ŸæˆæœåŠ¡ç¥¨æ®
    public ServiceTicket grantServiceTicket(String serviceId) {
        ServiceTicket st = new ServiceTicket(serviceId, this);
        services.put(serviceId, st);
        return st;
    }
}
```

### 3.2 STï¼ˆService Ticketï¼‰è¯¦è§£


**ğŸ”¸ STçš„æœ¬è´¨**  
STå°±åƒæ˜¯**ä¸´æ—¶é€šè¡Œè¯**ï¼Œæ˜¯TGTæ¢å–çš„é’ˆå¯¹ç‰¹å®šæœåŠ¡çš„ä¸€æ¬¡æ€§ç¥¨æ®ã€‚

```
STçš„ç‰¹ç‚¹ï¼š
âœ… ä¸€æ¬¡æ€§ä½¿ç”¨    - ç”¨å®Œå³ä½œåºŸï¼Œé˜²æ­¢é‡æ”¾æ”»å‡»
âœ… çŸ­æœŸæœ‰æ•ˆ      - é€šå¸¸5åˆ†é’Ÿå†…è¿‡æœŸ
âœ… æœåŠ¡ç»‘å®š      - åªèƒ½ç”¨äºç‰¹å®šçš„æœåŠ¡
âœ… ä¼ è¾“å®‰å…¨      - é€šè¿‡HTTPSä¼ è¾“
```

**ğŸ”§ STéªŒè¯æµç¨‹**
```java
// CAS ClientéªŒè¯STçš„è¿‡ç¨‹
public class ServiceTicketValidator {
    
    public Assertion validate(String ticket, String service) {
        // 1. æ„å»ºéªŒè¯è¯·æ±‚
        String validationUrl = casServerUrl + "/serviceValidate?" +
            "ticket=" + ticket + "&service=" + service;
            
        // 2. å‘CAS Serverå‘é€éªŒè¯è¯·æ±‚
        String response = httpClient.get(validationUrl);
        
        // 3. è§£æCAS Serverè¿”å›çš„XMLå“åº”
        if (response.contains("<cas:authenticationSuccess>")) {
            // éªŒè¯æˆåŠŸï¼Œæå–ç”¨æˆ·ä¿¡æ¯
            String username = extractUsername(response);
            return new AssertionImpl(username);
        } else {
            // éªŒè¯å¤±è´¥
            throw new TicketValidationException("STéªŒè¯å¤±è´¥");
        }
    }
}
```

### 3.3 PGTä¸PGTIOUæœºåˆ¶


**ğŸ”¸ ä»£ç†è®¤è¯åœºæ™¯**
åœ¨å¤æ‚çš„ä¼ä¸šç¯å¢ƒä¸­ï¼Œç»å¸¸å­˜åœ¨**æœåŠ¡é“¾è°ƒç”¨**çš„æƒ…å†µï¼š

```
ç”¨æˆ·è®¿é—®åœºæ™¯ï¼š
ç”¨æˆ· â†’ Webåº”ç”¨ â†’ åç«¯API â†’ æ•°æ®åº“æœåŠ¡

é—®é¢˜ï¼šåç«¯APIå¦‚ä½•ä»£è¡¨ç”¨æˆ·è®¿é—®æ•°æ®åº“æœåŠ¡ï¼Ÿ
è§£å†³ï¼šPGTä»£ç†æˆæƒæœºåˆ¶
```

**ğŸ”¸ PGTå·¥ä½œåŸç†**
```
PGTä»£ç†è®¤è¯æµç¨‹ï¼š

1. ç”¨æˆ·é€šè¿‡CASç™»å½•Webåº”ç”¨
2. Webåº”ç”¨è·å¾—PGTï¼ˆä»£ç†æˆæƒç¥¨æ®ï¼‰  
3. Webåº”ç”¨éœ€è¦è°ƒç”¨åç«¯APIæ—¶ï¼š
   - ä½¿ç”¨PGTå‘CASç”³è¯·é’ˆå¯¹APIçš„ST
   - æºå¸¦STè°ƒç”¨åç«¯API
   - åç«¯APIéªŒè¯STæœ‰æ•ˆæ€§

è¿™æ ·åç«¯APIå°±çŸ¥é“è¿™ä¸ªè¯·æ±‚æ˜¯ä»£è¡¨å“ªä¸ªç”¨æˆ·çš„ï¼
```

**ğŸ”§ PGTIOUå®‰å…¨æœºåˆ¶**
```java
// PGTIOUç¡®ä¿PGTå®‰å…¨ä¼ è¾“
public class ProxyGrantingTicketIOUImpl {
    private String pgtiou;  // PGT IOUæ ‡è¯†ç¬¦
    private String pgtId;   // å®é™…PGTæ ‡è¯†ç¬¦
    
    // CAS Serveré€šè¿‡å›è°ƒURLå®‰å…¨ä¼ é€’PGT
    public void handlePgtCallback(String pgtIou, String pgtId) {
        // 1. éªŒè¯å›è°ƒæ¥æºçš„åˆæ³•æ€§
        if (isValidCallback()) {
            // 2. å»ºç«‹PGTIOUä¸PGTçš„æ˜ å°„å…³ç³»
            pgtRegistry.put(pgtIou, pgtId);
        }
    }
}
```

---

## 4. ğŸ”„ CASè®¤è¯æµç¨‹è¯¦è§£


### 4.1 å®Œæ•´è®¤è¯æµç¨‹å›¾


```
CASå®Œæ•´è®¤è¯æµç¨‹ï¼š

   ç”¨æˆ·æµè§ˆå™¨           CAS Server            åº”ç”¨ç³»ç»ŸA
        |                   |                    |
   [1] è®¿é—®ç³»ç»ŸA              |                    |
   GET /app-a/dashboard       |                    |
        |                   |                    |
        |              [2] æ£€æŸ¥ç™»å½•çŠ¶æ€            |
        |                   |               ç³»ç»ŸAå‘ç°ç”¨æˆ·
        |                   |               æœªç™»å½•ï¼Œé‡å®šå‘
        |                   |               åˆ°CAS Server
        |                   |                    |
   [3] é‡å®šå‘åˆ°CASç™»å½•é¡µé¢     |                    |
   GET /cas/login?           |                    |
   service=http://app-a.com  |                    |
        |                   |                    |
   [4] æ˜¾ç¤ºç™»å½•è¡¨å•          |                    |
   è¾“å…¥ç”¨æˆ·åå¯†ç              |                    |
        |                   |                    |
   [5] æäº¤è®¤è¯è¯·æ±‚          |                    |
   POST /cas/login           |                    |
   username=john&password=*  |                    |
        |                   |                    |
        |              [6] éªŒè¯ç”¨æˆ·å‡­è¯            |
        |              åˆ›å»ºTGTï¼Œç”ŸæˆST             |
        |                   |                    |
   [7] é‡å®šå‘å›ç³»ç»ŸA          |                    |
   æºå¸¦STå‚æ•°                 |                    |
   GET /app-a/dashboard?     |                    |
   ticket=ST-123456          |                    |
        |                   |                    |
        |                   |               [8] æ¥æ”¶ST
        |                   |               å‘CASéªŒè¯ST
        |              [9] STéªŒè¯è¯·æ±‚             |
        |              GET /cas/serviceValidate  |
        |              ?ticket=ST-123456&        |
        |              service=http://app-a.com  |
        |                   |                    |
        |              [10] è¿”å›éªŒè¯ç»“æœ          |
        |              <cas:authenticationSuccess>|
        |              <cas:user>john</cas:user>  |
        |                   |                    |
   [11] è®¿é—®ç³»ç»ŸAæˆåŠŸ         |               [12] STéªŒè¯é€šè¿‡
   æ˜¾ç¤ºdashboardé¡µé¢          |               åˆ›å»ºæœ¬åœ°ä¼šè¯
        |                   |               å…è®¸ç”¨æˆ·è®¿é—®
```

### 4.2 å…³é”®æµç¨‹èŠ‚ç‚¹è§£æ


**ğŸ”¸ æ­¥éª¤1-2ï¼šè®¿é—®æ£€æµ‹**
```java
// åº”ç”¨ç³»ç»ŸAçš„æ‹¦æˆªå™¨
@Component
public class CasAuthenticationInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response) {
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç»åœ¨æœ¬åœ°ç™»å½•
        if (request.getSession().getAttribute("user") == null) {
            // æœªç™»å½•ï¼Œæ„å»ºCASç™»å½•URL
            String casLoginUrl = "https://cas-server.com/login?service=" 
                               + URLEncoder.encode(getCurrentUrl(request));
            response.sendRedirect(casLoginUrl);
            return false;
        }
        return true;
    }
}
```

**ğŸ”¸ æ­¥éª¤3-6ï¼šCASè®¤è¯**
```java
// CAS Serverè®¤è¯æ§åˆ¶å™¨
@Controller
public class LoginController {
    
    @PostMapping("/login")
    public String authenticate(@RequestParam String username,
                             @RequestParam String password,
                             @RequestParam String service) {
        
        // 1. éªŒè¯ç”¨æˆ·å‡­è¯
        if (authenticationService.authenticate(username, password)) {
            
            // 2. åˆ›å»ºTGTï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            TicketGrantingTicket tgt = getOrCreateTGT(username);
            
            // 3. ç”Ÿæˆé’ˆå¯¹ç›®æ ‡æœåŠ¡çš„ST
            ServiceTicket st = tgt.grantServiceTicket(service);
            
            // 4. é‡å®šå‘å›ç›®æ ‡æœåŠ¡ï¼Œæºå¸¦ST
            return "redirect:" + service + "?ticket=" + st.getId();
        }
        
        return "login"; // è®¤è¯å¤±è´¥ï¼Œé‡æ–°æ˜¾ç¤ºç™»å½•é¡µ
    }
}
```

**ğŸ”¸ æ­¥éª¤7-12ï¼šç¥¨æ®éªŒè¯**
```java
// CAS ClientéªŒè¯ST
@Service
public class TicketValidationService {
    
    public UserInfo validateServiceTicket(String ticket, String service) {
        
        // 1. å‘CAS ServeréªŒè¯ST
        String validationUrl = casServerUrl + "/serviceValidate?" +
                              "ticket=" + ticket + "&service=" + service;
        
        String xmlResponse = httpClient.get(validationUrl);
        
        // 2. è§£æCASè¿”å›çš„XML
        if (xmlResponse.contains("<cas:authenticationSuccess>")) {
            String username = parseUsername(xmlResponse);
            
            // 3. åˆ›å»ºæœ¬åœ°ç”¨æˆ·ä¼šè¯
            UserInfo userInfo = new UserInfo(username);
            return userInfo;
        }
        
        throw new AuthenticationException("STéªŒè¯å¤±è´¥");
    }
}
```

### 4.3 ç™»å‡ºæµç¨‹è¯¦è§£


**ğŸ”¸ å•ç‚¹ç™»å‡ºï¼ˆSingle Logoutï¼‰**
```
CASå•ç‚¹ç™»å‡ºæµç¨‹ï¼š

ç”¨æˆ·åœ¨ä»»ä¸€ç³»ç»Ÿç‚¹å‡»ç™»å‡º
        â†“
é‡å®šå‘åˆ°CAS Serverç™»å‡ºURL
        â†“
CAS Serveré”€æ¯ç”¨æˆ·çš„TGT
        â†“
CAS Serverå‘æ‰€æœ‰ç›¸å…³ç³»ç»Ÿå‘é€ç™»å‡ºè¯·æ±‚
        â†“
å„ç³»ç»Ÿæ¸…ç†æœ¬åœ°ä¼šè¯
        â†“
ç”¨æˆ·ä»æ‰€æœ‰ç³»ç»Ÿç™»å‡ºå®Œæˆ
```

**ğŸ”§ ç™»å‡ºå®ç°**
```java
// CAS Serverç™»å‡ºå¤„ç†
@GetMapping("/logout")
public String logout(HttpServletRequest request) {
    
    // 1. è·å–ç”¨æˆ·çš„TGT
    String tgtId = getTgtFromRequest(request);
    TicketGrantingTicket tgt = ticketRegistry.getTicket(tgtId);
    
    if (tgt != null) {
        // 2. å‘æ‰€æœ‰å·²è®¿é—®çš„æœåŠ¡å‘é€ç™»å‡ºé€šçŸ¥
        for (Service service : tgt.getServices().values()) {
            sendSingleLogoutRequest(service.getId());
        }
        
        // 3. é”€æ¯TGT
        ticketRegistry.deleteTicket(tgtId);
    }
    
    // 4. æ¸…é™¤æµè§ˆå™¨ä¸­çš„TGT Cookie
    Cookie tgtCookie = new Cookie("TGC", null);
    tgtCookie.setMaxAge(0);
    response.addCookie(tgtCookie);
    
    return "logout-success";
}
```

---

## 5. ğŸ“ˆ CASåè®®ç‰ˆæœ¬æ¼”è¿›


### 5.1 ç‰ˆæœ¬å¯¹æ¯”æ¦‚è§ˆ


| ğŸ†š å¯¹æ¯”é¡¹ | CAS 1.0 | CAS 2.0 | CAS 3.0 |
|-----------|---------|---------|---------|
| **å‘å¸ƒæ—¶é—´** | 2004å¹´ | 2006å¹´ | 2008å¹´ |
| **éªŒè¯å“åº”** | ç®€å•æ–‡æœ¬ | XMLæ ¼å¼ | XMLæ ¼å¼ |
| **å±æ€§ä¼ é€’** | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒ | âœ… å¢å¼ºæ”¯æŒ |
| **ä»£ç†è®¤è¯** | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒ | âœ… å®Œå–„æ”¯æŒ |
| **å•ç‚¹ç™»å‡º** | âŒ ä¸æ”¯æŒ | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒ |
| **å®‰å…¨æ€§** | â­â­ | â­â­â­ | â­â­â­â­ |

### 5.2 CAS 1.0ï¼šèµ·æ­¥ç‰ˆæœ¬


**ğŸ”¸ æ ¸å¿ƒç‰¹ç‚¹**
```
CAS 1.0çš„éªŒè¯å“åº”ï¼š
æˆåŠŸï¼šyes\nusername
å¤±è´¥ï¼šno\n

ä¼˜ç‚¹ï¼š
âœ… å®ç°ç®€å•
âœ… åè®®è½»é‡

ç¼ºç‚¹ï¼š
âŒ åŠŸèƒ½æœ‰é™
âŒ æ— æ³•ä¼ é€’ç”¨æˆ·å±æ€§
âŒ ä¸æ”¯æŒä»£ç†è®¤è¯
```

**ğŸ”§ CAS 1.0éªŒè¯ç¤ºä¾‹**
```java
// CAS 1.0 STéªŒè¯
public boolean validateTicket(String ticket, String service) {
    String url = casServer + "/validate?ticket=" + ticket + "&service=" + service;
    String response = httpClient.get(url);
    
    // è§£æç®€å•çš„æ–‡æœ¬å“åº”
    String[] lines = response.split("\n");
    if ("yes".equals(lines[0])) {
        String username = lines[1];
        return true;
    }
    return false;
}
```

### 5.3 CAS 2.0ï¼šXMLå¢å¼º


**ğŸ”¸ ä¸»è¦æ”¹è¿›**
```xml
<!-- CAS 2.0 éªŒè¯æˆåŠŸå“åº” -->
<cas:serviceResponse xmlns:cas="http://www.yale.edu/tp/cas">
    <cas:authenticationSuccess>
        <cas:user>john.doe</cas:user>
        <cas:attributes>
            <cas:email>john@example.com</cas:email>
            <cas:department>IT</cas:department>
            <cas:roles>admin,user</cas:roles>
        </cas:attributes>
    </cas:authenticationSuccess>
</cas:serviceResponse>
```

**ğŸ”§ å±æ€§ä¼ é€’é…ç½®**
```java
// CAS 2.0 å±æ€§æå–
@Service  
public class AttributeExtractor {
    
    public UserAttributes extractAttributes(String casResponse) {
        Document doc = parseXML(casResponse);
        UserAttributes attrs = new UserAttributes();
        
        // æå–åŸºæœ¬ç”¨æˆ·ä¿¡æ¯
        attrs.setUsername(getElementText(doc, "cas:user"));
        
        // æå–æ‰©å±•å±æ€§
        Node attributesNode = getElement(doc, "cas:attributes");
        if (attributesNode != null) {
            attrs.setEmail(getElementText(attributesNode, "cas:email"));
            attrs.setDepartment(getElementText(attributesNode, "cas:department"));
            attrs.setRoles(getElementText(attributesNode, "cas:roles").split(","));
        }
        
        return attrs;
    }
}
```

### 5.4 CAS 3.0ï¼šä¼ä¸šçº§å®Œå–„


**ğŸ”¸ æ–°å¢é‡è¦ç‰¹æ€§**

> â­ **å•ç‚¹ç™»å‡ºæ”¯æŒ**
> 
> ç”¨æˆ·ä»ä»»ä¸€ç³»ç»Ÿç™»å‡ºï¼Œè‡ªåŠ¨ä»æ‰€æœ‰å·²ç™»å½•ç³»ç»Ÿç™»å‡º

> ğŸ”„ **ä»£ç†è®¤è¯å¢å¼º**  
> 
> å®Œå–„çš„PGT/PGTIOUæœºåˆ¶ï¼Œæ”¯æŒå¤æ‚çš„æœåŠ¡é“¾è°ƒç”¨

> ğŸ›¡ï¸ **å®‰å…¨æ€§æå‡**
> 
> æ›´ä¸¥æ ¼çš„ç¥¨æ®éªŒè¯ï¼Œé˜²æ­¢å„ç±»æ”»å‡»

**ğŸ”§ CAS 3.0å•ç‚¹ç™»å‡ºé…ç½®**
```xml
<!-- CAS Serverå•ç‚¹ç™»å‡ºé…ç½® -->
<bean id="singleLogoutAction" class="org.jasig.cas.web.flow.SingleLogoutAction">
    <property name="servicesManager" ref="servicesManager"/>
    <property name="logoutManager" ref="logoutManager"/>
</bean>

<!-- å®¢æˆ·ç«¯å•ç‚¹ç™»å‡ºç›‘å¬å™¨ -->
<listener>
    <listener-class>
        org.jasig.cas.client.session.SingleSignOutHttpSessionListener
    </listener-class>
</listener>
```

---

## 6. ğŸŒ å¤šåè®®æ”¯æŒä¸é›†æˆ


### 6.1 CASä¸OAuthé›†æˆ


**ğŸ”¸ ä¸ºä»€ä¹ˆéœ€è¦OAuthæ”¯æŒï¼Ÿ**
```
åœºæ™¯éœ€æ±‚ï¼š
- ç§»åŠ¨APPéœ€è¦è°ƒç”¨API
- ç¬¬ä¸‰æ–¹åº”ç”¨éœ€è¦æœ‰é™æˆæƒ  
- RESTful APIéœ€è¦æ— çŠ¶æ€è®¤è¯

CASä¼ ç»Ÿæ–¹å¼ï¼šåŸºäºWebé‡å®šå‘ï¼Œä¸é€‚åˆAPIè°ƒç”¨
OAuthæ–¹å¼ï¼šåŸºäºTokenï¼Œé€‚åˆAPIè°ƒç”¨
```

**ğŸ”§ CAS OAuthé›†æˆé…ç½®**
```java
// CAS Server OAuthé…ç½®
@Configuration
@EnableAuthorizationServer
public class OAuthConfiguration extends AuthorizationServerConfigurerAdapter {
    
    @Override
    public void configure(ClientDetailsServiceConfigurer clients) throws Exception {
        clients.inMemory()
            .withClient("mobile-app")
            .secret("app-secret")
            .authorizedGrantTypes("authorization_code", "refresh_token")
            .scopes("read", "write")
            .redirectUris("https://mobile-app.com/callback");
    }
    
    // CASè®¤è¯ä¸OAuth Tokenæ˜ å°„
    @Bean
    public TokenStore casTokenStore() {
        return new CasTokenStore(ticketRegistry);
    }
}
```

### 6.2 CASä¸SAMLé›†æˆ


**ğŸ”¸ SAMLé›†æˆåœºæ™¯**
```
ä¼ä¸šçº§å•ç‚¹ç™»å½•éœ€æ±‚ï¼š
- ä¸å¤–éƒ¨åˆä½œä¼™ä¼´ç³»ç»Ÿé›†æˆ
- æ”¯æŒè·¨åŸŸè®¤è¯è”é‚¦
- æ»¡è¶³ä¼ä¸šå®‰å…¨æ ‡å‡†ï¼ˆå¦‚SAML 2.0ï¼‰

CASä½œä¸ºSAML IdPï¼ˆèº«ä»½æä¾›å•†ï¼‰ï¼š
CAS Server â†â†’ SAMLåè®® â†â†’ å¤–éƒ¨ç³»ç»Ÿ
```

**ğŸ”§ SAMLé›†æˆç¤ºä¾‹**
```xml
<!-- CAS SAML IdPé…ç½® -->
<util:map id="samlArgumentExtractors">
    <entry key="samlValidate" value-ref="samlArgumentExtractor"/>
</util:map>

<bean id="samlArgumentExtractor" 
      class="org.jasig.cas.support.saml.web.support.SamlArgumentExtractor"/>

<!-- SAML Responseæ„å»ºå™¨ -->
<bean id="samlResponseBuilder" 
      class="org.jasig.cas.support.saml.util.SamlResponseBuilder">
    <property name="samlObjectBuilder" ref="samlObjectBuilder"/>
</bean>
```

### 6.3 OpenID Connectæ”¯æŒ


**ğŸ”¸ OIDCç°ä»£åŒ–éœ€æ±‚**
```
ç°ä»£åº”ç”¨åœºæ™¯ï¼š
- å•é¡µåº”ç”¨ï¼ˆSPAï¼‰è®¤è¯
- ç§»åŠ¨åŸç”Ÿåº”ç”¨è®¤è¯  
- äº‘åŸç”Ÿå¾®æœåŠ¡æ¶æ„
- ç°ä»£Webæ ‡å‡†æ”¯æŒ

CAS + OpenID Connect = ç°ä»£åŒ–çš„CAS
```

**ğŸ”§ OIDCé›†æˆå®ç°**
```java
// CAS OpenID Connecté…ç½®
@Configuration
public class OidcConfiguration {
    
    @Bean
    public OidcIdTokenGenerator oidcIdTokenGenerator() {
        return new OidcIdTokenGenerator(
            signingKey(),
            servicesManager(),
            claimsGenerator()
        );
    }
    
    // JWT ID Tokenç”Ÿæˆ
    @Bean
    public OidcClaimsGenerator claimsGenerator() {
        return new OidcClaimsGenerator() {
            @Override
            public Map<String, Object> generate(Principal principal, 
                                               RegisteredService service) {
                Map<String, Object> claims = new HashMap<>();
                claims.put("sub", principal.getId());
                claims.put("email", getEmail(principal));
                claims.put("name", getName(principal));
                return claims;
            }
        };
    }
}
```

---

## 7. âš™ï¸ å®æ–½éƒ¨ç½²è¦ç‚¹


### 7.1 ç¯å¢ƒè§„åˆ’ä¸å‡†å¤‡


**ğŸ”¸ æœåŠ¡å™¨è§„åˆ’**
```
ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®ï¼š

CAS ServeræœåŠ¡å™¨ï¼š
â”œâ”€ CPU: 4æ ¸ä»¥ä¸Š
â”œâ”€ å†…å­˜: 8GBä»¥ä¸Š  
â”œâ”€ ç£ç›˜: SSD 100GBä»¥ä¸Š
â”œâ”€ ç½‘ç»œ: åƒå…†ç½‘å¡
â””â”€ æ“ä½œç³»ç»Ÿ: CentOS 7+/Ubuntu 18+

æ•°æ®åº“æœåŠ¡å™¨ï¼š
â”œâ”€ MySQL 5.7+ æˆ– PostgreSQL 10+
â”œâ”€ å†…å­˜: 16GBä»¥ä¸Š
â”œâ”€ ç£ç›˜: SSD RAID10
â””â”€ é«˜å¯ç”¨é…ç½®ï¼ˆä¸»ä»å¤åˆ¶ï¼‰
```

**ğŸ”¸ ç½‘ç»œæ¶æ„è®¾è®¡**
```
ç½‘ç»œæ‹“æ‰‘å›¾ï¼š

Internet
    â†“
[è´Ÿè½½å‡è¡¡å™¨]
    â†“
[CAS Serveré›†ç¾¤]
    â”œâ”€ CAS Server 1
    â”œâ”€ CAS Server 2  
    â””â”€ CAS Server 3
    â†“
[æ•°æ®åº“é›†ç¾¤]
    â”œâ”€ MySQL Master
    â””â”€ MySQL Slave
```

### 7.2 æ•°æ®åº“è®¾è®¡ä¸é…ç½®


**ğŸ”§ CASæ•°æ®è¡¨ç»“æ„**
```sql
-- ç”¨æˆ·è®¤è¯è¡¨
CREATE TABLE cas_users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    email VARCHAR(100),
    enabled BOOLEAN DEFAULT TRUE,
    created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç¥¨æ®å­˜å‚¨è¡¨  
CREATE TABLE cas_tickets (
    id VARCHAR(255) PRIMARY KEY,
    ticket_type VARCHAR(50) NOT NULL,
    ticket_body LONGTEXT NOT NULL,
    principal_id VARCHAR(100),
    creation_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expiration_time TIMESTAMP,
    INDEX idx_expiration (expiration_time),
    INDEX idx_principal (principal_id)
);

-- æœåŠ¡æ³¨å†Œè¡¨
CREATE TABLE cas_services (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    service_url VARCHAR(512) NOT NULL,
    enabled BOOLEAN DEFAULT TRUE,
    sso_enabled BOOLEAN DEFAULT TRUE,
    created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**ğŸ”§ CAS Serveræ•°æ®æºé…ç½®**
```properties
# application.properties
cas.authn.jdbc.query[0].driver-class=com.mysql.cj.jdbc.Driver
cas.authn.jdbc.query[0].url=jdbc:mysql://localhost:3306/cas_db?useSSL=false
cas.authn.jdbc.query[0].user=cas_user
cas.authn.jdbc.query[0].password=cas_password
cas.authn.jdbc.query[0].sql=SELECT password FROM cas_users WHERE username=?
cas.authn.jdbc.query[0].field-password=password
cas.authn.jdbc.query[0].password-encoder.type=BCRYPT
```

### 7.3 SSL/HTTPSé…ç½®


> âš ï¸ **é‡è¦æé†’**
> 
> CASå¿…é¡»è¿è¡Œåœ¨HTTPSç¯å¢ƒä¸‹ï¼ŒHTTPç¯å¢ƒä»…ç”¨äºå¼€å‘æµ‹è¯•ï¼

**ğŸ”§ SSLè¯ä¹¦é…ç½®**
```bash
# 1. ç”Ÿæˆè¯ä¹¦ï¼ˆç”Ÿäº§ç¯å¢ƒä½¿ç”¨CAç­¾å‘çš„è¯ä¹¦ï¼‰
keytool -genkeypair -alias cas-server -keyalg RSA -keysize 2048 \
        -validity 365 -keystore cas-server.keystore \
        -dname "CN=cas-server.com,OU=IT,O=Company,L=City,ST=State,C=CN"

# 2. å¯¼å‡ºè¯ä¹¦åˆ°å®¢æˆ·ç«¯ä¿¡ä»»åº“
keytool -exportcert -alias cas-server -keystore cas-server.keystore \
        -file cas-server.crt

# 3. å®¢æˆ·ç«¯å¯¼å…¥è¯ä¹¦
keytool -importcert -alias cas-server -keystore client-truststore.jks \
        -file cas-server.crt
```

**ğŸ”§ CAS Server HTTPSé…ç½®**
```properties
# SSLé…ç½®
server.ssl.key-store=classpath:cas-server.keystore
server.ssl.key-store-password=changeit
server.ssl.key-password=changeit
server.ssl.enabled=true
server.port=8443

# å¼ºåˆ¶HTTPS
cas.tgc.secure=true
cas.service-registry.init-from-json=true
```

---

## 8. ğŸš€ é«˜å¯ç”¨æ¶æ„è®¾è®¡


### 8.1 é›†ç¾¤éƒ¨ç½²æ¶æ„


**ğŸ”¸ é›†ç¾¤æ¶æ„å›¾**
```
é«˜å¯ç”¨CASé›†ç¾¤æ¶æ„ï¼š

                [Internet]
                     â†“
            [è´Ÿè½½å‡è¡¡å™¨ - HAProxy/Nginx]
                     â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â†“                               â†“
   [CAS Server 1]                [CAS Server 2]
         â†“                               â†“
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
              [å…±äº«ç¥¨æ®å­˜å‚¨]
                  â†™        â†˜
           [Redis Cluster]  [MySQL Cluster]
```

**ğŸ”§ è´Ÿè½½å‡è¡¡é…ç½®**
```nginx
# Nginxè´Ÿè½½å‡è¡¡é…ç½®
upstream cas_cluster {
    # IPå“ˆå¸Œç¡®ä¿ä¼šè¯ç²˜æ€§
    ip_hash;
    
    server cas-server-1.com:8443 max_fails=3 fail_timeout=30s;
    server cas-server-2.com:8443 max_fails=3 fail_timeout=30s;
    server cas-server-3.com:8443 max_fails=3 fail_timeout=30s backup;
}

server {
    listen 443 ssl;
    server_name cas.company.com;
    
    ssl_certificate /etc/nginx/ssl/cas.crt;
    ssl_certificate_key /etc/nginx/ssl/cas.key;
    
    location / {
        proxy_pass https://cas_cluster;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        
        # å¥åº·æ£€æŸ¥
        proxy_next_upstream error timeout invalid_header http_500;
    }
}
```

### 8.2 å…±äº«ä¼šè¯å­˜å‚¨


**ğŸ”¸ Redisé›†ç¾¤ç¥¨æ®å­˜å‚¨**
```java
// Redisç¥¨æ®æ³¨å†Œè¡¨é…ç½®
@Configuration
public class RedisTicketRegistryConfiguration {
    
    @Bean
    public TicketRegistry ticketRegistry() {
        RedisTicketRegistry registry = new RedisTicketRegistry();
        registry.setRedisTemplate(redisTemplate());
        return registry;
    }
    
    @Bean
    public RedisTemplate<String, Object> redisTemplate() {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(redisConnectionFactory());
        
        // åºåˆ—åŒ–é…ç½®
        template.setKeySerializer(new StringRedisSerializer());
        template.setValueSerializer(new GenericJackson2JsonRedisSerializer());
        
        return template;
    }
    
    @Bean
    public LettuceConnectionFactory redisConnectionFactory() {
        // Redisé›†ç¾¤é…ç½®
        RedisClusterConfiguration clusterConfig = new RedisClusterConfiguration();
        clusterConfig.clusterNode("redis-1.com", 6379);
        clusterConfig.clusterNode("redis-2.com", 6379);
        clusterConfig.clusterNode("redis-3.com", 6379);
        
        return new LettuceConnectionFactory(clusterConfig);
    }
}
```

### 8.3 æ•…éšœè½¬ç§»ç­–ç•¥


**ğŸ”¸ è‡ªåŠ¨æ•…éšœæ£€æµ‹**
```bash
# å¥åº·æ£€æŸ¥è„šæœ¬
#!/bin/bash
CAS_HEALTH_URL="https://cas-server.com/cas/status/health"

# æ£€æŸ¥CAS Serverå¥åº·çŠ¶æ€
response=$(curl -s -o /dev/null -w "%{http_code}" $CAS_HEALTH_URL)

if [ $response -eq 200 ]; then
    echo "CAS Serverå¥åº·"
    exit 0
else
    echo "CAS Serverå¼‚å¸¸ï¼ŒHTTPçŠ¶æ€ç : $response"
    # è§¦å‘æ•…éšœè½¬ç§»
    /scripts/failover.sh
    exit 1
fi
```

**ğŸ”§ æ•…éšœè½¬ç§»é…ç½®**
```properties
# CASé«˜å¯ç”¨é…ç½®
cas.monitor.endpoints.enabled=true
cas.monitor.endpoints.sensitive=false

# é›†ç¾¤èŠ‚ç‚¹å‘ç°
cas.discovery.enabled=true
cas.discovery.nodes=cas-1.com:8443,cas-2.com:8443,cas-3.com:8443

# æ•…éšœè½¬ç§»è¶…æ—¶
cas.ticket.registry.redis.timeout=2000
cas.ticket.registry.redis.retry-attempts=3
```

### 8.4 æ€§èƒ½ç›‘æ§ä¸è°ƒä¼˜


**ğŸ”¸ å…³é”®ç›‘æ§æŒ‡æ ‡**
```
ğŸ“Š CASæ€§èƒ½ç›‘æ§æŒ‡æ ‡ï¼š

ç³»ç»Ÿçº§æŒ‡æ ‡ï¼š
â”œâ”€ CPUä½¿ç”¨ç‡ < 80%
â”œâ”€ å†…å­˜ä½¿ç”¨ç‡ < 85%  
â”œâ”€ ç£ç›˜IO < 80%
â””â”€ ç½‘ç»œå¸¦å®½ä½¿ç”¨æƒ…å†µ

åº”ç”¨çº§æŒ‡æ ‡ï¼š
â”œâ”€ è®¤è¯æˆåŠŸç‡ > 99.5%
â”œâ”€ å¹³å‡å“åº”æ—¶é—´ < 500ms
â”œâ”€ TGTåˆ›å»ºé€Ÿç‡
â”œâ”€ STéªŒè¯é€Ÿç‡  
â””â”€ æ´»è·ƒç”¨æˆ·æ•°é‡

é”™è¯¯æŒ‡æ ‡ï¼š
â”œâ”€ è®¤è¯å¤±è´¥ç‡ < 0.5%
â”œâ”€ ç¥¨æ®éªŒè¯å¤±è´¥ç‡ < 0.1%
â”œâ”€ ç³»ç»Ÿå¼‚å¸¸ç‡ < 0.01%
â””â”€ è¶…æ—¶é”™è¯¯ç‡ < 0.1%
```

**ğŸ”§ JVMè°ƒä¼˜å‚æ•°**
```bash
# CAS Server JVMä¼˜åŒ–å‚æ•°
JAVA_OPTS="
-Xms4g -Xmx8g
-XX:+UseG1GC
-XX:MaxGCPauseMillis=200
-XX:+UnlockExperimentalVMOptions
-XX:+UseStringDeduplication
-XX:+PrintGCDetails
-XX:+PrintGCTimeStamps
-Xloggc:/var/log/cas/gc.log
-Djava.awt.headless=true
-Djava.security.egd=file:/dev/./urandom
"
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ CASæ ¸å¿ƒæ¶æ„ï¼šCAS Server + CAS Client + ç¥¨æ®ç³»ç»Ÿ
ğŸ”¸ ç¥¨æ®æœºåˆ¶ï¼šTGT(æ€»é€šè¡Œè¯) + ST(æœåŠ¡ç¥¨æ®) + PGT(ä»£ç†ç¥¨æ®)
ğŸ”¸ è®¤è¯æµç¨‹ï¼šé‡å®šå‘ç™»å½• â†’ ç¥¨æ®é¢å‘ â†’ ç¥¨æ®éªŒè¯ â†’ è®¿é—®æˆæƒ
ğŸ”¸ åè®®æ¼”è¿›ï¼šCAS 1.0(æ–‡æœ¬) â†’ CAS 2.0(XML+å±æ€§) â†’ CAS 3.0(SLO+å¢å¼º)
ğŸ”¸ å¤šåè®®é›†æˆï¼šOAuthã€SAMLã€OpenID Connectåè®®æ”¯æŒ
ğŸ”¸ é«˜å¯ç”¨éƒ¨ç½²ï¼šé›†ç¾¤ã€è´Ÿè½½å‡è¡¡ã€å…±äº«å­˜å‚¨ã€æ•…éšœè½¬ç§»
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ CASçš„æœ¬è´¨ä»·å€¼**
```
ç”¨æˆ·è§†è§’ï¼šä¸€æ¬¡ç™»å½•ï¼Œå¤„å¤„é€šè¡Œ
ä¼ä¸šè§†è§’ï¼šç»Ÿä¸€èº«ä»½ç®¡ç†ï¼Œé™ä½å®‰å…¨é£é™©
å¼€å‘è§†è§’ï¼šæ ‡å‡†åŒ–è®¤è¯ï¼Œå‡å°‘é‡å¤å¼€å‘
è¿ç»´è§†è§’ï¼šé›†ä¸­åŒ–ç®¡ç†ï¼Œç®€åŒ–ç»´æŠ¤å·¥ä½œ
```

**ğŸ”¹ ç¥¨æ®æœºåˆ¶çš„è®¾è®¡æ™ºæ…§**
```
TGTè®¾è®¡ï¼šé•¿æœŸæœ‰æ•ˆï¼Œå‡å°‘ç”¨æˆ·é‡å¤ç™»å½•
STè®¾è®¡ï¼šçŸ­æœŸä¸€æ¬¡æ€§ï¼Œä¿éšœä¼ è¾“å®‰å…¨
PGTè®¾è®¡ï¼šä»£ç†æˆæƒï¼Œæ”¯æŒæœåŠ¡é“¾è°ƒç”¨
è¿‡æœŸæœºåˆ¶ï¼šå¹³è¡¡å®‰å…¨æ€§ä¸ç”¨æˆ·ä½“éªŒ
```

**ğŸ”¹ åè®®ç‰ˆæœ¬é€‰æ‹©ç­–ç•¥**
```
CAS 1.0ï¼šç®€å•åœºæ™¯ï¼Œå¿«é€Ÿé›†æˆ
CAS 2.0ï¼šä¼ä¸šåº”ç”¨ï¼Œéœ€è¦ç”¨æˆ·å±æ€§
CAS 3.0ï¼šå¤æ‚ç¯å¢ƒï¼Œéœ€è¦å•ç‚¹ç™»å‡º
ç°ä»£åº”ç”¨ï¼šè€ƒè™‘OAuth/OIDCé›†æˆ
```

### 9.3 å®æ–½æœ€ä½³å®è·µ


> ğŸ’¡ **å®‰å…¨æœ€ä½³å®è·µ**
> 
> - å¼ºåˆ¶HTTPSé€šä¿¡
> - ä½¿ç”¨å¼ºå¯†ç ç­–ç•¥  
> - å¯ç”¨ä¼šè¯è¶…æ—¶æ§åˆ¶
> - å®šæœŸæ›´æ–°å®‰å…¨è¡¥ä¸
> - å®æ–½è®¿é—®æ—¥å¿—å®¡è®¡

> ğŸš€ **æ€§èƒ½ä¼˜åŒ–å»ºè®®**
> 
> - ä½¿ç”¨Redisç¼“å­˜ç¥¨æ®
> - å¯ç”¨è¿æ¥æ± ä¼˜åŒ–
> - åˆç†è®¾ç½®ç¥¨æ®è¿‡æœŸæ—¶é—´
> - å®æ–½é›†ç¾¤è´Ÿè½½å‡è¡¡
> - ç›‘æ§å…³é”®æ€§èƒ½æŒ‡æ ‡

> ğŸ”§ **è¿ç»´ç®¡ç†è¦ç‚¹**
> 
> - å»ºç«‹å®Œå–„çš„ç›‘æ§ä½“ç³»
> - åˆ¶å®šæ•…éšœå¤„ç†é¢„æ¡ˆ  
> - å®šæœŸå¤‡ä»½é…ç½®å’Œæ•°æ®
> - æ–‡æ¡£åŒ–éƒ¨ç½²å’Œé…ç½®è¿‡ç¨‹
> - åŸ¹è®­ç›¸å…³æŠ€æœ¯äººå‘˜

### 9.4 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ


| ğŸ” é—®é¢˜åœºæ™¯ | ğŸ¯ è§£å†³æ–¹æ¡ˆ | ğŸ’¡ é¢„é˜²æªæ–½ |
|-------------|-------------|-------------|
| **ç¥¨æ®éªŒè¯å¤±è´¥** | æ£€æŸ¥æ—¶é—´åŒæ­¥ã€ç½‘ç»œè¿é€šæ€§ | é…ç½®NTPæ—¶é—´åŒæ­¥ |
| **å¾ªç¯é‡å®šå‘** | æ£€æŸ¥serviceå‚æ•°é…ç½® | ç»Ÿä¸€URLæ ¼å¼è§„èŒƒ |
| **å•ç‚¹ç™»å‡ºå¤±æ•ˆ** | æ£€æŸ¥SLOé…ç½®å’Œç½‘ç»œ | æµ‹è¯•ç™»å‡ºå›è°ƒæ¥å£ |
| **æ€§èƒ½ç“¶é¢ˆ** | å¯ç”¨ç¼“å­˜ã€ä¼˜åŒ–æ•°æ®åº“ | æ€§èƒ½æµ‹è¯•å’Œç›‘æ§ |
| **è¯ä¹¦é—®é¢˜** | æ›´æ–°SSLè¯ä¹¦é…ç½® | è¯ä¹¦è¿‡æœŸæå‰é¢„è­¦ |

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- CASæ¶æ„ä¸‰ç»„ä»¶ï¼šServerã€ClientåŠ ç¥¨æ®
- ç¥¨æ®æœºåˆ¶è¦è®°ç‰¢ï¼šTGTæ¢STéªŒè¯å¥½  
- è®¤è¯æµç¨‹å¾ˆæ¸…æ™°ï¼šé‡å®šå‘ã€é¢å‘ã€éªŒè¯é½
- é«˜å¯ç”¨è¦è§„åˆ’ï¼šé›†ç¾¤ã€ç¼“å­˜ã€ç›‘æ§ä½³