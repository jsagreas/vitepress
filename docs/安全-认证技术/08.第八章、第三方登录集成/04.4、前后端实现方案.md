---
title: 4ã€å‰åç«¯å®ç°æ–¹æ¡ˆ
---
## ğŸ“š ç›®å½•

1. [æ ¸å¿ƒæ¦‚å¿µç†è§£](#1-æ ¸å¿ƒæ¦‚å¿µç†è§£)
2. [åç«¯æ ¸å¿ƒå®ç°é€»è¾‘](#2-åç«¯æ ¸å¿ƒå®ç°é€»è¾‘)
3. [å‰ç«¯ç™»å½•æ–¹å¼é€‰æ‹©](#3-å‰ç«¯ç™»å½•æ–¹å¼é€‰æ‹©)
4. [ç™»å½•æŒ‰é’®ä¸è·³è½¬å¤„ç†](#4-ç™»å½•æŒ‰é’®ä¸è·³è½¬å¤„ç†)
5. [å›è°ƒåœ°å€å‰ç«¯å¤„ç†é€»è¾‘](#5-å›è°ƒåœ°å€å‰ç«¯å¤„ç†é€»è¾‘)
6. [Vue/Reacté›†æˆå°è£…æ–¹æ¡ˆ](#6-Vue-Reacté›†æˆå°è£…æ–¹æ¡ˆ)
7. [ç™»å½•çŠ¶æ€æç¤ºå¤„ç†](#7-ç™»å½•çŠ¶æ€æç¤ºå¤„ç†)
8. [å‰åç«¯åä½œæµç¨‹](#8-å‰åç«¯åä½œæµç¨‹)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ æ ¸å¿ƒæ¦‚å¿µç†è§£


### 1.1 ç¬¬ä¸‰æ–¹ç™»å½•æ˜¯ä»€ä¹ˆ


> **é€šä¿—è§£é‡Š**ï¼šå°±åƒä½ å»ä¸€ä¸ªæ–°å•†åœºï¼Œä¸éœ€è¦é‡æ–°åŠä¼šå‘˜å¡ï¼Œç›´æ¥ç”¨æ”¯ä»˜å®æˆ–å¾®ä¿¡æ‰«ç å°±èƒ½äº«å—ä¼šå‘˜æœåŠ¡ã€‚ç¬¬ä¸‰æ–¹ç™»å½•è®©ç”¨æˆ·ç”¨å·²æœ‰çš„å¤§å¹³å°è´¦å·ï¼ˆå¦‚å¾®ä¿¡ã€QQã€GitHubï¼‰å¿«é€Ÿç™»å½•ä½ çš„ç½‘ç«™ï¼Œå…å»é‡å¤æ³¨å†Œçš„éº»çƒ¦ã€‚

**æ ¸å¿ƒå¥½å¤„**ï¼š
- ğŸš€ **ç”¨æˆ·æ–¹ä¾¿**ï¼šä¸ç”¨è®°ä½åˆä¸€ä¸ªè´¦å·å¯†ç 
- ğŸ“ˆ **é™ä½é—¨æ§›**ï¼šæ³¨å†Œæµç¨‹ä»5æ­¥ç®€åŒ–åˆ°1æ­¥
- ğŸ”’ **æ›´å®‰å…¨**ï¼šå€Ÿç”¨å¤§å¹³å°çš„å®‰å…¨æœºåˆ¶
- ğŸ“Š **è·å–ä¿¡æ¯**ï¼šå¯ä»¥è·å–ç”¨æˆ·çš„åŸºæœ¬èµ„æ–™

### 1.2 åŸºæœ¬å·¥ä½œåŸç†


```
ç”¨æˆ·æƒ³ç™»å½•ä½ çš„ç½‘ç«™
      â†“
ç‚¹å‡»"å¾®ä¿¡ç™»å½•"æŒ‰é’®
      â†“  
è·³è½¬åˆ°å¾®ä¿¡æˆæƒé¡µé¢ â†â€”â€”â€”â€”â€”â€” ä½ çš„ç½‘ç«™æ„é€ æˆæƒé“¾æ¥
      â†“
ç”¨æˆ·åŒæ„æˆæƒ
      â†“
å¾®ä¿¡è¿”å›æˆæƒç (code) â€”â€”â€”â€”â€”â€”â†’ ä½ çš„ç½‘ç«™æ¥æ”¶code
      â†“
ä½ çš„æœåŠ¡å™¨ç”¨codeæ¢å–token â†â€”â€”â€” å‘å¾®ä¿¡æœåŠ¡å™¨è¯·æ±‚
      â†“
ç”¨codeè·å–ç”¨æˆ·ä¿¡æ¯ â†â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” å†æ¬¡è¯·æ±‚å¾®ä¿¡API
      â†“
ä¿å­˜ç”¨æˆ·ä¿¡æ¯ï¼Œå®Œæˆç™»å½• â€”â€”â€”â€”â€”â€”â€”â†’ è¿”å›ç»™å‰ç«¯ç™»å½•æˆåŠŸ
```

---

## 2. âš™ï¸ åç«¯æ ¸å¿ƒå®ç°é€»è¾‘


### 2.1 æ„é€ æˆæƒè¯·æ±‚URL


**è¿™ä¸€æ­¥æ˜¯ä»€ä¹ˆ**ï¼šå°±æ˜¯ç”Ÿæˆä¸€ä¸ªç‰¹æ®Šçš„é“¾æ¥ï¼Œç”¨æˆ·ç‚¹å‡»åä¼šè·³è½¬åˆ°ç¬¬ä¸‰æ–¹å¹³å°ï¼ˆå¦‚å¾®ä¿¡ï¼‰è¿›è¡Œæˆæƒã€‚

```javascript
// ä»¥å¾®ä¿¡ç™»å½•ä¸ºä¾‹
function buildWechatAuthUrl() {
    const config = {
        appId: 'your_app_id',           // ä½ åœ¨å¾®ä¿¡å¼€æ”¾å¹³å°ç”³è¯·çš„åº”ç”¨ID
        redirectUri: 'your_callback_url', // æˆæƒåè·³è½¬å›ä½ ç½‘ç«™çš„åœ°å€
        scope: 'snsapi_login',          // ç”³è¯·çš„æƒé™èŒƒå›´
        state: 'random_string'          // é˜²æ­¢æ”»å‡»çš„éšæœºå­—ç¬¦ä¸²
    };
    
    // æ‹¼æ¥æˆå¾®ä¿¡è¦æ±‚çš„URLæ ¼å¼
    const authUrl = `https://open.weixin.qq.com/connect/qrconnect?` +
        `appid=${config.appId}` +
        `&redirect_uri=${encodeURIComponent(config.redirectUri)}` +
        `&response_type=code` +
        `&scope=${config.scope}` +
        `&state=${config.state}`;
    
    return authUrl;
}
```

**ğŸ“‹ å…³é”®å‚æ•°è¯´æ˜**ï¼š
- `appId`ï¼šä½ çš„åº”ç”¨åœ¨ç¬¬ä¸‰æ–¹å¹³å°çš„èº«ä»½è¯å·
- `redirectUri`ï¼šç”¨æˆ·æˆæƒåè¦è·³è½¬å›å“ªä¸ªé¡µé¢
- `scope`ï¼šä½ æƒ³è¦ä»€ä¹ˆæƒé™ï¼ˆè·å–åŸºæœ¬ä¿¡æ¯ã€å¥½å‹åˆ—è¡¨ç­‰ï¼‰
- `state`ï¼šé˜²æ­¢è¢«æ”»å‡»çš„å®‰å…¨å‚æ•°

### 2.2 æ¥æ”¶æˆæƒç ï¼ˆcodeï¼‰å›è°ƒ


**è¿™ä¸€æ­¥æ˜¯ä»€ä¹ˆ**ï¼šç”¨æˆ·åœ¨ç¬¬ä¸‰æ–¹å¹³å°åŒæ„æˆæƒåï¼Œä¼šå¸¦ç€ä¸€ä¸ªä¸´æ—¶çš„"æˆæƒç "å›åˆ°ä½ çš„ç½‘ç«™ã€‚

```javascript
// Express.js ç¤ºä¾‹
app.get('/auth/wechat/callback', (req, res) => {
    const { code, state } = req.query;
    
    // 1. æ£€æŸ¥å¿…è¦å‚æ•°
    if (!code) {
        return res.status(400).json({ error: 'æˆæƒå¤±è´¥ï¼Œæœªè·å–åˆ°æˆæƒç ' });
    }
    
    // 2. éªŒè¯stateå‚æ•°ï¼ˆé˜²æ­¢æ”»å‡»ï¼‰
    if (state !== expectedState) {
        return res.status(400).json({ error: 'å®‰å…¨éªŒè¯å¤±è´¥' });
    }
    
    // 3. ç»§ç»­åç»­å¤„ç†
    exchangeCodeForToken(code);
});
```

**ğŸ’¡ å…³é”®ç†è§£**ï¼š
- `code`æ˜¯ä¸´æ—¶çš„ï¼Œé€šå¸¸å‡ åˆ†é’Ÿåå°±å¤±æ•ˆ
- å¿…é¡»ç«‹å³ç”¨å®ƒæ¢å–çœŸæ­£çš„è®¿é—®ä»¤ç‰Œ
- `state`å‚æ•°ç”¨æ¥é˜²æ­¢CSRFæ”»å‡»

### 2.3 ç”¨codeæ¢å–Access Token


**è¿™ä¸€æ­¥æ˜¯ä»€ä¹ˆ**ï¼šæ‹¿ç€ä¸´æ—¶çš„æˆæƒç ï¼Œå‘ç¬¬ä¸‰æ–¹å¹³å°æ¢å–çœŸæ­£çš„è®¿é—®ä»¤ç‰Œï¼Œå°±åƒæ‹¿ç€ä¸´æ—¶é€šè¡Œè¯æ¢å–æ­£å¼å·¥ä½œè¯ã€‚

```javascript
async function exchangeCodeForToken(code) {
    const tokenUrl = 'https://api.weixin.qq.com/sns/oauth2/access_token';
    
    const params = {
        appid: 'your_app_id',
        secret: 'your_app_secret',     // åº”ç”¨å¯†é’¥ï¼Œç»ä¸èƒ½æ³„éœ²
        code: code,
        grant_type: 'authorization_code'
    };
    
    try {
        const response = await fetch(`${tokenUrl}?${new URLSearchParams(params)}`);
        const data = await response.json();
        
        if (data.access_token) {
            // æˆåŠŸè·å–åˆ°token
            return {
                accessToken: data.access_token,
                refreshToken: data.refresh_token,
                openid: data.openid          // ç”¨æˆ·åœ¨è¯¥åº”ç”¨ä¸‹çš„å”¯ä¸€æ ‡è¯†
            };
        } else {
            throw new Error(data.errmsg || 'è·å–tokenå¤±è´¥');
        }
    } catch (error) {
        console.error('æ¢å–tokenå¤±è´¥:', error);
        throw error;
    }
}
```

### 2.4 è°ƒç”¨ç”¨æˆ·ä¿¡æ¯API


**è¿™ä¸€æ­¥æ˜¯ä»€ä¹ˆ**ï¼šç”¨è·å–åˆ°çš„ä»¤ç‰Œï¼Œå‘ç¬¬ä¸‰æ–¹å¹³å°è¯·æ±‚ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯ï¼ˆå¤´åƒã€æ˜µç§°ç­‰ï¼‰ã€‚

```javascript
async function getUserInfo(accessToken, openid) {
    const userInfoUrl = 'https://api.weixin.qq.com/sns/userinfo';
    
    const params = {
        access_token: accessToken,
        openid: openid,
        lang: 'zh_CN'
    };
    
    try {
        const response = await fetch(`${userInfoUrl}?${new URLSearchParams(params)}`);
        const userInfo = await response.json();
        
        return {
            openid: userInfo.openid,
            nickname: userInfo.nickname,
            avatar: userInfo.headimgurl,
            gender: userInfo.sex,
            city: userInfo.city
        };
    } catch (error) {
        console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
        throw error;
    }
}
```

### 2.5 ç”¨æˆ·æ•°æ®å­˜å‚¨ä¸ç™»å½•çŠ¶æ€ç®¡ç†


**è¿™ä¸€æ­¥æ˜¯ä»€ä¹ˆ**ï¼šæŠŠä»ç¬¬ä¸‰æ–¹å¹³å°è·å–çš„ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ°ä½ çš„æ•°æ®åº“ï¼Œå¹¶ä¸ºç”¨æˆ·åˆ›å»ºç™»å½•ä¼šè¯ã€‚

```javascript
async function handleUserLogin(userInfo) {
    // 1. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨
    let user = await User.findOne({ wechatOpenid: userInfo.openid });
    
    if (!user) {
        // 2. æ–°ç”¨æˆ·ï¼Œåˆ›å»ºè´¦å·
        user = await User.create({
            wechatOpenid: userInfo.openid,
            nickname: userInfo.nickname,
            avatar: userInfo.avatar,
            loginType: 'wechat',
            createdAt: new Date()
        });
    } else {
        // 3. è€ç”¨æˆ·ï¼Œæ›´æ–°ä¿¡æ¯
        await User.updateOne(
            { _id: user._id },
            {
                nickname: userInfo.nickname,
                avatar: userInfo.avatar,
                lastLoginAt: new Date()
            }
        );
    }
    
    // 4. ç”Ÿæˆç™»å½•å‡­è¯ï¼ˆJWT tokenï¼‰
    const jwtToken = jwt.sign(
        { userId: user._id, loginType: 'wechat' },
        'your_secret_key',
        { expiresIn: '7d' }
    );
    
    return {
        user: user,
        token: jwtToken
    };
}
```

---

## 3. ğŸ–¥ï¸ å‰ç«¯ç™»å½•æ–¹å¼é€‰æ‹©


### 3.1 å¼¹çª—ç™»å½• vs é¡µé¢è·³è½¬å¯¹æ¯”


**ä¸¤ç§æ–¹å¼çš„åŒºåˆ«**ï¼š

| ç‰¹æ€§ | **å¼¹çª—ç™»å½•** | **é¡µé¢è·³è½¬** |
|------|-------------|-------------|
| **ç”¨æˆ·ä½“éªŒ** | âœ… æ— ç¼ä½“éªŒï¼Œä¸ç¦»å¼€å½“å‰é¡µé¢ | âŒ éœ€è¦ç¦»å¼€å½“å‰é¡µé¢ |
| **å®ç°å¤æ‚åº¦** | âŒ è¾ƒå¤æ‚ï¼Œéœ€è¦å¤„ç†è·¨çª—å£é€šä¿¡ | âœ… ç®€å•ï¼Œç›´æ¥è·³è½¬å³å¯ |
| **ç§»åŠ¨ç«¯å…¼å®¹æ€§** | âŒ æŸäº›æ‰‹æœºæµè§ˆå™¨é™åˆ¶å¼¹çª— | âœ… å…¼å®¹æ€§å¥½ |
| **å¼€å‘è°ƒè¯•** | âŒ è°ƒè¯•ç›¸å¯¹å›°éš¾ | âœ… å®¹æ˜“è°ƒè¯• |
| **é€‚ç”¨åœºæ™¯** | ğŸ¢ PCç«¯ç½‘ç«™ã€ç®¡ç†åå° | ğŸ“± ç§»åŠ¨ç«¯ã€ç®€å•åº”ç”¨ |

### 3.2 å¼¹çª—ç™»å½•å®ç°ï¼ˆwindow.open + postMessageï¼‰


**åŸç†è¯´æ˜**ï¼šåœ¨å½“å‰é¡µé¢æ‰“å¼€ä¸€ä¸ªå°çª—å£è¿›è¡Œæˆæƒï¼Œæˆæƒå®Œæˆåé€šè¿‡`postMessage`é€šçŸ¥çˆ¶çª—å£ã€‚

```javascript
class ThirdPartyLogin {
    constructor() {
        this.popup = null;
        this.checkTimer = null;
    }
    
    // å‘èµ·å¾®ä¿¡ç™»å½•
    startWechatLogin() {
        return new Promise((resolve, reject) => {
            // 1. è·å–æˆæƒURL
            const authUrl = this.getAuthUrl();
            
            // 2. æ‰“å¼€å¼¹çª—
            this.popup = window.open(
                authUrl,
                'wechat_login',
                'width=500,height=600,scrollbars=yes,resizable=yes'
            );
            
            // 3. ç›‘å¬æ¶ˆæ¯
            window.addEventListener('message', (event) => {
                this.handleMessage(event, resolve, reject);
            });
            
            // 4. æ£€æŸ¥å¼¹çª—çŠ¶æ€
            this.checkTimer = setInterval(() => {
                if (this.popup.closed) {
                    clearInterval(this.checkTimer);
                    reject(new Error('ç”¨æˆ·å–æ¶ˆäº†ç™»å½•'));
                }
            }, 1000);
        });
    }
    
    // å¤„ç†æ¥è‡ªå¼¹çª—çš„æ¶ˆæ¯
    handleMessage(event, resolve, reject) {
        // å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿æ¶ˆæ¯æ¥è‡ªå¯ä¿¡åŸŸå
        if (event.origin !== 'https://yourdomain.com') {
            return;
        }
        
        if (event.data.type === 'LOGIN_SUCCESS') {
            // ç™»å½•æˆåŠŸ
            this.cleanup();
            resolve(event.data.user);
        } else if (event.data.type === 'LOGIN_ERROR') {
            // ç™»å½•å¤±è´¥
            this.cleanup();
            reject(new Error(event.data.message));
        }
    }
    
    // æ¸…ç†èµ„æº
    cleanup() {
        if (this.popup) {
            this.popup.close();
            this.popup = null;
        }
        if (this.checkTimer) {
            clearInterval(this.checkTimer);
            this.checkTimer = null;
        }
    }
}
```

**åœ¨å›è°ƒé¡µé¢ä¸­å‘é€æ¶ˆæ¯**ï¼š

```javascript
// è¿™æ®µä»£ç åœ¨æˆæƒå›è°ƒé¡µé¢æ‰§è¡Œ
window.onload = function() {
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    
    if (code) {
        // å‘åç«¯å‘é€codeï¼Œå®Œæˆç™»å½•
        fetch('/api/auth/wechat/callback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // é€šçŸ¥çˆ¶çª—å£ç™»å½•æˆåŠŸ
                window.opener.postMessage({
                    type: 'LOGIN_SUCCESS',
                    user: data.user,
                    token: data.token
                }, 'https://yourdomain.com');
            } else {
                // é€šçŸ¥çˆ¶çª—å£ç™»å½•å¤±è´¥
                window.opener.postMessage({
                    type: 'LOGIN_ERROR',
                    message: data.message
                }, 'https://yourdomain.com');
            }
            window.close(); // å…³é—­å¼¹çª—
        });
    }
};
```

### 3.3 ç§»åŠ¨ç«¯WebViewå¤„ç†æ–¹æ¡ˆ


**ç§»åŠ¨ç«¯çš„ç‰¹æ®Šé—®é¢˜**ï¼š
- æŸäº›APPå†…ç½®æµè§ˆå™¨ä¸æ”¯æŒå¼¹çª—
- éœ€è¦è€ƒè™‘å¾®ä¿¡å†…ç½®æµè§ˆå™¨çš„ç‰¹æ®Šæƒ…å†µ
- iOS Safariå¯¹å¼¹çª—æœ‰é™åˆ¶

```javascript
class MobileThirdPartyLogin {
    detectEnvironment() {
        const ua = navigator.userAgent.toLowerCase();
        
        return {
            isWechat: ua.includes('micromessenger'),
            isMobile: /android|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(ua),
            isIOS: /iphone|ipad|ipod/i.test(ua),
            isAndroid: ua.includes('android')
        };
    }
    
    startLogin() {
        const env = this.detectEnvironment();
        
        if (env.isWechat) {
            // åœ¨å¾®ä¿¡å†…ç½®æµè§ˆå™¨ä¸­ï¼Œç›´æ¥è·³è½¬
            this.redirectLogin();
        } else if (env.isMobile) {
            // ç§»åŠ¨ç«¯ä¼˜å…ˆä½¿ç”¨è·³è½¬æ–¹å¼
            this.redirectLogin();
        } else {
            // PCç«¯ä½¿ç”¨å¼¹çª—æ–¹å¼
            this.popupLogin();
        }
    }
    
    redirectLogin() {
        // ä¿å­˜å½“å‰é¡µé¢çŠ¶æ€
        sessionStorage.setItem('returnUrl', window.location.href);
        // ç›´æ¥è·³è½¬åˆ°æˆæƒé¡µé¢
        window.location.href = this.getAuthUrl();
    }
}
```

---

## 4. ğŸ¯ ç™»å½•æŒ‰é’®ä¸è·³è½¬å¤„ç†


### 4.1 ç™»å½•æŒ‰é’®è®¾è®¡


**å¥½çš„ç™»å½•æŒ‰é’®åº”è¯¥**ï¼š
- æ¸…æ¥šè¡¨æ˜æ˜¯ç¬¬ä¸‰æ–¹ç™»å½•
- ä½¿ç”¨å¯¹åº”å¹³å°çš„å“ç‰Œè‰²å½©
- æä¾›loadingçŠ¶æ€åé¦ˆ

```html
<!-- å¾®ä¿¡ç™»å½•æŒ‰é’®ç¤ºä¾‹ -->
<button 
    class="wechat-login-btn" 
    @click="handleWechatLogin"
    :disabled="isLogging"
>
    <img src="/icons/wechat.png" alt="å¾®ä¿¡">
    {{ isLogging ? 'ç™»å½•ä¸­...' : 'å¾®ä¿¡ç™»å½•' }}
</button>

<style>
.wechat-login-btn {
    background-color: #07C160;  /* å¾®ä¿¡ç»¿ */
    color: white;
    border: none;
    border-radius: 6px;
    padding: 12px 20px;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    transition: background-color 0.2s;
}

.wechat-login-btn:hover {
    background-color: #06B050;
}

.wechat-login-btn:disabled {
    background-color: #ccc;
    cursor: not-allowed;
}
</style>
```

### 4.2 å¤šç§ç™»å½•æ–¹å¼æ•´åˆ


```javascript
export default {
    data() {
        return {
            loginMethods: [
                { name: 'wechat', label: 'å¾®ä¿¡ç™»å½•', icon: '/icons/wechat.png', color: '#07C160' },
                { name: 'qq', label: 'QQç™»å½•', icon: '/icons/qq.png', color: '#12B7F5' },
                { name: 'github', label: 'GitHubç™»å½•', icon: '/icons/github.png', color: '#333' }
            ],
            currentLogging: null  // å½“å‰æ­£åœ¨ç™»å½•çš„æ–¹å¼
        };
    },
    
    methods: {
        async handleLogin(method) {
            this.currentLogging = method;
            
            try {
                let result;
                switch (method) {
                    case 'wechat':
                        result = await this.wechatLogin();
                        break;
                    case 'qq':
                        result = await this.qqLogin();
                        break;
                    case 'github':
                        result = await this.githubLogin();
                        break;
                }
                
                // ç™»å½•æˆåŠŸå¤„ç†
                this.onLoginSuccess(result);
                
            } catch (error) {
                // ç™»å½•å¤±è´¥å¤„ç†
                this.onLoginError(error);
            } finally {
                this.currentLogging = null;
            }
        }
    }
};
```

---

## 5. ğŸ”„ å›è°ƒåœ°å€å‰ç«¯å¤„ç†é€»è¾‘


### 5.1 å›è°ƒé¡µé¢çš„èŒè´£


**å›è°ƒé¡µé¢è¦åšä»€ä¹ˆ**ï¼š
1. æ¥æ”¶æˆæƒç ï¼ˆcodeï¼‰
2. å‘è‡ªå·±çš„åç«¯å‘é€codeå®Œæˆç™»å½•
3. å¤„ç†ç™»å½•ç»“æœ
4. å¼•å¯¼ç”¨æˆ·å›åˆ°åŸæ¥çš„é¡µé¢

### 5.2 é€šç”¨å›è°ƒå¤„ç†æ–¹æ¡ˆ


```javascript
// callback.js - ä¸“é—¨å¤„ç†æˆæƒå›è°ƒçš„é¡µé¢
class AuthCallback {
    constructor() {
        this.init();
    }
    
    init() {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        this.showLoading('æ­£åœ¨ç™»å½•ä¸­...');
        
        // è§£æURLå‚æ•°
        const params = this.parseUrlParams();
        
        if (params.code) {
            this.processAuthCode(params.code, params.state);
        } else if (params.error) {
            this.handleAuthError(params.error, params.error_description);
        } else {
            this.handleAuthError('unknown_error', 'æœªçŸ¥é”™è¯¯');
        }
    }
    
    parseUrlParams() {
        const urlParams = new URLSearchParams(window.location.search);
        return {
            code: urlParams.get('code'),
            state: urlParams.get('state'),
            error: urlParams.get('error'),
            error_description: urlParams.get('error_description')
        };
    }
    
    async processAuthCode(code, state) {
        try {
            // å‘åç«¯å‘é€æˆæƒç 
            const response = await fetch('/api/auth/callback', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    code: code,
                    state: state,
                    platform: this.detectPlatform() // æ£€æµ‹æ˜¯å“ªä¸ªå¹³å°çš„å›è°ƒ
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                this.handleLoginSuccess(result.data);
            } else {
                this.handleLoginError(result.message);
            }
            
        } catch (error) {
            this.handleLoginError('ç½‘ç»œè¯·æ±‚å¤±è´¥');
        }
    }
    
    handleLoginSuccess(data) {
        // ä¿å­˜ç™»å½•çŠ¶æ€
        localStorage.setItem('userToken', data.token);
        localStorage.setItem('userInfo', JSON.stringify(data.user));
        
        if (this.isPopupMode()) {
            // å¼¹çª—æ¨¡å¼ï¼šé€šçŸ¥çˆ¶çª—å£
            window.opener.postMessage({
                type: 'LOGIN_SUCCESS',
                data: data
            }, window.location.origin);
            window.close();
        } else {
            // è·³è½¬æ¨¡å¼ï¼šå›åˆ°åŸé¡µé¢
            const returnUrl = sessionStorage.getItem('returnUrl') || '/';
            sessionStorage.removeItem('returnUrl');
            
            this.showSuccess('ç™»å½•æˆåŠŸ', () => {
                window.location.href = returnUrl;
            });
        }
    }
    
    handleLoginError(message) {
        if (this.isPopupMode()) {
            window.opener.postMessage({
                type: 'LOGIN_ERROR',
                message: message
            }, window.location.origin);
            window.close();
        } else {
            this.showError(message, () => {
                const returnUrl = sessionStorage.getItem('returnUrl') || '/';
                window.location.href = returnUrl;
            });
        }
    }
    
    isPopupMode() {
        return window.opener && window.opener !== window;
    }
    
    detectPlatform() {
        // æ ¹æ®URLè·¯å¾„æˆ–å‚æ•°æ£€æµ‹å¹³å°
        const path = window.location.pathname;
        if (path.includes('wechat')) return 'wechat';
        if (path.includes('qq')) return 'qq';
        if (path.includes('github')) return 'github';
        return 'unknown';
    }
    
    showLoading(message) {
        document.body.innerHTML = `
            <div style="display: flex; justify-content: center; align-items: center; height: 100vh; flex-direction: column;">
                <div class="loading-spinner"></div>
                <p>${message}</p>
            </div>
        `;
    }
    
    showSuccess(message, callback) {
        document.body.innerHTML = `
            <div style="display: flex; justify-content: center; align-items: center; height: 100vh; flex-direction: column;">
                <div style="color: green; font-size: 24px;">âœ“</div>
                <p>${message}</p>
                <p>æ­£åœ¨è·³è½¬...</p>
            </div>
        `;
        setTimeout(callback, 2000);
    }
    
    showError(message, callback) {
        document.body.innerHTML = `
            <div style="display: flex; justify-content: center; align-items: center; height: 100vh; flex-direction: column;">
                <div style="color: red; font-size: 24px;">âœ—</div>
                <p>ç™»å½•å¤±è´¥ï¼š${message}</p>
                <button onclick="callback()">è¿”å›</button>
            </div>
        `;
        window.callback = callback;
    }
}

// é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ‰§è¡Œ
document.addEventListener('DOMContentLoaded', () => {
    new AuthCallback();
});
```

---

## 6. ğŸ“± Vue/Reacté›†æˆå°è£…æ–¹æ¡ˆ


### 6.1 Vueç»„ä»¶å°è£…


```vue
<!-- ThirdPartyLogin.vue -->
<template>
    <div class="third-party-login">
        <div class="login-title">é€‰æ‹©ç™»å½•æ–¹å¼</div>
        
        <div class="login-methods">
            <button
                v-for="method in loginMethods"
                :key="method.name"
                class="login-btn"
                :style="{ backgroundColor: method.color }"
                :disabled="currentLogging === method.name"
                @click="handleLogin(method.name)"
            >
                <img :src="method.icon" :alt="method.label">
                <span v-if="currentLogging === method.name">ç™»å½•ä¸­...</span>
                <span v-else>{{ method.label }}</span>
            </button>
        </div>
        
        <!-- é”™è¯¯æç¤º -->
        <div v-if="errorMessage" class="error-message">
            {{ errorMessage }}
        </div>
    </div>
</template>

<script>
import { ThirdPartyAuthService } from '@/services/auth'

export default {
    name: 'ThirdPartyLogin',
    
    data() {
        return {
            loginMethods: [
                { name: 'wechat', label: 'å¾®ä¿¡ç™»å½•', icon: '/icons/wechat.png', color: '#07C160' },
                { name: 'qq', label: 'QQç™»å½•', icon: '/icons/qq.png', color: '#12B7F5' }
            ],
            currentLogging: null,
            errorMessage: ''
        }
    },
    
    methods: {
        async handleLogin(platform) {
            this.currentLogging = platform
            this.errorMessage = ''
            
            try {
                const authService = new ThirdPartyAuthService()
                const result = await authService.login(platform)
                
                // ç™»å½•æˆåŠŸï¼Œè§¦å‘äº‹ä»¶ç»™çˆ¶ç»„ä»¶
                this.$emit('login-success', result)
                
                // ä¿å­˜ç™»å½•çŠ¶æ€
                this.$store.commit('setUser', result.user)
                this.$store.commit('setToken', result.token)
                
            } catch (error) {
                this.errorMessage = error.message || 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•'
                this.$emit('login-error', error)
            } finally {
                this.currentLogging = null
            }
        }
    }
}
</script>
```

**å¯¹åº”çš„æœåŠ¡ç±»**ï¼š

```javascript
// services/auth.js
export class ThirdPartyAuthService {
    constructor() {
        this.baseURL = process.env.VUE_APP_API_BASE_URL
    }
    
    // ç»Ÿä¸€çš„ç¬¬ä¸‰æ–¹ç™»å½•æ–¹æ³•
    async login(platform) {
        const isMobile = this.detectMobile()
        
        if (isMobile) {
            return this.redirectLogin(platform)
        } else {
            return this.popupLogin(platform)
        }
    }
    
    // å¼¹çª—ç™»å½•
    popupLogin(platform) {
        return new Promise((resolve, reject) => {
            // è·å–æˆæƒURL
            const authUrl = this.getAuthUrl(platform)
            
            // æ‰“å¼€å¼¹çª—
            const popup = window.open(authUrl, 'auth_popup', 'width=500,height=600')
            
            // ç›‘å¬æ¶ˆæ¯
            const messageHandler = (event) => {
                if (event.origin !== window.location.origin) return
                
                if (event.data.type === 'LOGIN_SUCCESS') {
                    window.removeEventListener('message', messageHandler)
                    resolve(event.data.data)
                } else if (event.data.type === 'LOGIN_ERROR') {
                    window.removeEventListener('message', messageHandler)
                    reject(new Error(event.data.message))
                }
            }
            
            window.addEventListener('message', messageHandler)
            
            // æ£€æŸ¥å¼¹çª—çŠ¶æ€
            const checkTimer = setInterval(() => {
                if (popup.closed) {
                    clearInterval(checkTimer)
                    window.removeEventListener('message', messageHandler)
                    reject(new Error('ç”¨æˆ·å–æ¶ˆäº†ç™»å½•'))
                }
            }, 1000)
        })
    }
    
    // è·³è½¬ç™»å½•
    redirectLogin(platform) {
        sessionStorage.setItem('returnUrl', window.location.href)
        window.location.href = this.getAuthUrl(platform)
    }
    
    getAuthUrl(platform) {
        const params = {
            platform: platform,
            redirect_uri: `${window.location.origin}/auth/callback`,
            state: this.generateState()
        }
        
        return `${this.baseURL}/auth/${platform}/url?${new URLSearchParams(params)}`
    }
    
    detectMobile() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)
    }
    
    generateState() {
        return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15)
    }
}
```

### 6.2 React Hookå°è£…


```jsx
// hooks/useThirdPartyLogin.js
import { useState, useCallback } from 'react'
import { ThirdPartyAuthService } from '../services/auth'

export const useThirdPartyLogin = () => {
    const [loading, setLoading] = useState(false)
    const [error, setError] = useState(null)
    
    const login = useCallback(async (platform) => {
        setLoading(true)
        setError(null)
        
        try {
            const authService = new ThirdPartyAuthService()
            const result = await authService.login(platform)
            
            // ä¿å­˜åˆ°localStorageæˆ–Redux
            localStorage.setItem('userToken', result.token)
            localStorage.setItem('userInfo', JSON.stringify(result.user))
            
            return result
        } catch (err) {
            setError(err.message)
            throw err
        } finally {
            setLoading(false)
        }
    }, [])
    
    return { login, loading, error }
}
```

**Reactç»„ä»¶ä½¿ç”¨ç¤ºä¾‹**ï¼š

```jsx
// components/ThirdPartyLogin.jsx
import React from 'react'
import { useThirdPartyLogin } from '../hooks/useThirdPartyLogin'

const ThirdPartyLogin = ({ onSuccess, onError }) => {
    const { login, loading, error } = useThirdPartyLogin()
    
    const loginMethods = [
        { name: 'wechat', label: 'å¾®ä¿¡ç™»å½•', icon: '/icons/wechat.png', color: '#07C160' },
        { name: 'qq', label: 'QQç™»å½•', icon: '/icons/qq.png', color: '#12B7F5' }
    ]
    
    const handleLogin = async (platform) => {
        try {
            const result = await login(platform)
            onSuccess && onSuccess(result)
        } catch (err) {
            onError && onError(err)
        }
    }
    
    return (
        <div className="third-party-login">
            <h3>é€‰æ‹©ç™»å½•æ–¹å¼</h3>
            
            <div className="login-methods">
                {loginMethods.map(method => (
                    <button
                        key={method.name}
                        className="login-btn"
                        style={{ backgroundColor: method.color }}
                        disabled={loading}
                        onClick={() => handleLogin(method.name)}
                    >
                        <img src={method.icon} alt={method.label} />
                        <span>{loading ? 'ç™»å½•ä¸­...' : method.label}</span>
                    </button>
                ))}
            </div>
            
            {error && (
                <div className="error-message">{error}</div>
            )}
        </div>
    )
}

export default ThirdPartyLogin
```

---

## 7. ğŸ’¬ ç™»å½•çŠ¶æ€æç¤ºå¤„ç†


### 7.1 ç”¨æˆ·ä½“éªŒä¼˜åŒ–çš„æç¤ºè®¾è®¡


**å¥½çš„æç¤ºåº”è¯¥åŒ…æ‹¬**ï¼š
- ğŸ”„ **åŠ è½½çŠ¶æ€**ï¼šè®©ç”¨æˆ·çŸ¥é“æ­£åœ¨å¤„ç†
- âœ… **æˆåŠŸæç¤º**ï¼šç¡®è®¤ç™»å½•æˆåŠŸ
- âŒ **é”™è¯¯æç¤º**ï¼šæ¸…æ¥šè¯´æ˜å¤±è´¥åŸå› 
- ğŸ” **é‡è¯•é€‰é¡¹**ï¼šæä¾›é‡æ–°å°è¯•çš„æ–¹å¼

### 7.2 æç¤ºç»„ä»¶å°è£…


```vue
<!-- LoginStatus.vue -->
<template>
    <div class="login-status-overlay" v-if="show">
        <div class="login-status-modal">
            <!-- åŠ è½½çŠ¶æ€ -->
            <div v-if="status === 'loading'" class="status-content">
                <div class="loading-spinner"></div>
                <h3>{{ loadingText }}</h3>
                <p>è¯·ç¨ç­‰...</p>
            </div>
            
            <!-- æˆåŠŸçŠ¶æ€ -->
            <div v-else-if="status === 'success'" class="status-content success">
                <div class="success-icon">âœ“</div>
                <h3>ç™»å½•æˆåŠŸ</h3>
                <p>æ¬¢è¿ {{ userName }}ï¼</p>
                <p class="countdown">{{ countdown }}ç§’åè‡ªåŠ¨è·³è½¬...</p>
            </div>
            
            <!-- é”™è¯¯çŠ¶æ€ -->
            <div v-else-if="status === 'error'" class="status-content error">
                <div class="error-icon">âœ—</div>
                <h3>ç™»å½•å¤±è´¥</h3>
                <p>{{ errorMessage }}</p>
                <div class="error-actions">
                    <button @click="retry" class="retry-btn">é‡è¯•</button>
                    <button @click="close" class="close-btn">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>
</template>

<script>
export default {
    name: 'LoginStatus',
    
    props: {
        show: { type: Boolean, default: false },
        status: { type: String, default: 'loading' }, // loading, success, error
        loadingText: { type: String, default: 'æ­£åœ¨ç™»å½•' },
        errorMessage: { type: String, default: 'ç™»å½•å¤±è´¥' },
        userName: { type: String, default: '' }
    },
    
    data() {
        return {
            countdown: 3
        }
    },
    
    watch: {
        status(newStatus) {
            if (newStatus === 'success') {
                this.startCountdown()
            }
        }
    },
    
    methods: {
        startCountdown() {
            const timer = setInterval(() => {
                this.countdown--
                if (this.countdown <= 0) {
                    clearInterval(timer)
                    this.$emit('auto-redirect')
                }
            }, 1000)
        },
        
        retry() {
            this.$emit('retry')
        },
        
        close() {
            this.$emit('close')
        }
    }
}
</script>

<style scoped>
.login-status-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.login-status-modal {
    background: white;
    border-radius: 8px;
    padding: 30px;
    text-align: center;
    min-width: 300px;
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #07C160;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.success-icon, .error-icon {
    font-size: 48px;
    margin-bottom: 16px;
}

.success-icon { color: #07C160; }
.error-icon { color: #ff4757; }

.error-actions {
    margin-top: 20px;
}

.retry-btn, .close-btn {
    margin: 0 5px;
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.retry-btn {
    background-color: #07C160;
    color: white;
}

.close-btn {
    background-color: #ccc;
    color: #333;
}
</style>
```

### 7.3 æç¤ºé€»è¾‘é›†æˆ


```javascript
// åœ¨ä¸»ç™»å½•ç»„ä»¶ä¸­ä½¿ç”¨
export default {
    data() {
        return {
            showStatus: false,
            statusType: 'loading',
            statusMessage: '',
            currentUser: null
        }
    },
    
    methods: {
        async handleLogin(platform) {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            this.showStatus = true
            this.statusType = 'loading'
            
            try {
                const result = await this.thirdPartyLogin(platform)
                
                // æ˜¾ç¤ºæˆåŠŸçŠ¶æ€
                this.statusType = 'success'
                this.currentUser = result.user
                
            } catch (error) {
                // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                this.statusType = 'error'
                this.statusMessage = this.getErrorMessage(error)
            }
        },
        
        getErrorMessage(error) {
            const errorMap = {
                'access_denied': 'ç”¨æˆ·æ‹’ç»äº†æˆæƒ',
                'network_error': 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•',
                'server_error': 'æœåŠ¡å™¨ç¹å¿™ï¼Œè¯·ç¨åé‡è¯•',
                'invalid_request': 'è¯·æ±‚å‚æ•°é”™è¯¯'
            }
            
            return errorMap[error.code] || error.message || 'æœªçŸ¥é”™è¯¯'
        },
        
        onRetry() {
            this.showStatus = false
            // å¯ä»¥è®°ä½ä¸Šæ¬¡é€‰æ‹©çš„ç™»å½•æ–¹å¼
            if (this.lastLoginMethod) {
                this.handleLogin(this.lastLoginMethod)
            }
        },
        
        onAutoRedirect() {
            this.showStatus = false
            // è·³è½¬åˆ°ç”¨æˆ·ä¸­å¿ƒæˆ–åŸæ¥çš„é¡µé¢
            this.$router.push('/dashboard')
        }
    }
}
```

---

## 8. ğŸ¤ å‰åç«¯åä½œæµç¨‹


### 8.1 å®Œæ•´çš„åä½œæ—¶åºå›¾


```
å‰ç«¯é¡µé¢              åç«¯æœåŠ¡              ç¬¬ä¸‰æ–¹å¹³å°
    |                    |                      |
    |--[1]è¯·æ±‚ç™»å½•URL---->|                      |
    |                    |--[2]æ„é€ æˆæƒURL------>|
    |<---[3]è¿”å›æˆæƒURL---|<--[4]è¿”å›URL--------|
    |                    |                      |
    |--[5]ç”¨æˆ·ç‚¹å‡»è·³è½¬--->|                      |
    |                    |                      |
ç”¨æˆ·æˆæƒé¡µé¢              |                  ç¬¬ä¸‰æ–¹æˆæƒé¡µé¢
    |                    |                      |
    |<---------------[6]ç”¨æˆ·æˆæƒæ“ä½œ------------>|
    |                    |                      |
å›è°ƒé¡µé¢                 |                      |
    |                    |                      |
    |--[7]å‘é€code------>|                      |
    |                    |--[8]codeæ¢token----->|
    |                    |<--[9]è¿”å›token-------|
    |                    |--[10]è·å–ç”¨æˆ·ä¿¡æ¯---->|
    |                    |<--[11]è¿”å›ç”¨æˆ·ä¿¡æ¯----|
    |<--[12]ç™»å½•ç»“æœ-----|                      |
    |                    |                      |
    |--[13]ä¿å­˜çŠ¶æ€----->|                      |
```

### 8.2 APIæ¥å£è®¾è®¡è§„èŒƒ


**è·å–æˆæƒURLæ¥å£**ï¼š
```http
GET /api/auth/{platform}/url?redirect_uri=xxx&state=xxx
```

```javascript
// å“åº”æ ¼å¼
{
    "success": true,
    "data": {
        "authUrl": "https://open.weixin.qq.com/connect/qrconnect?appid=xxx...",
        "state": "random_string_for_security"
    }
}
```

**å¤„ç†å›è°ƒæ¥å£**ï¼š
```http
POST /api/auth/{platform}/callback
Content-Type: application/json

{
    "code": "authorization_code_from_platform",
    "state": "security_state_string"
}
```

```javascript
// æˆåŠŸå“åº”
{
    "success": true,
    "data": {
        "token": "jwt_token_string",
        "user": {
            "id": "user_id",
            "nickname": "ç”¨æˆ·æ˜µç§°",
            "avatar": "å¤´åƒURL",
            "email": "é‚®ç®±",
            "platform": "wechat"
        }
    }
}

// é”™è¯¯å“åº”
{
    "success": false,
    "code": "INVALID_CODE",
    "message": "æˆæƒç å·²è¿‡æœŸæˆ–æ— æ•ˆ"
}
```

### 8.3 é”™è¯¯å¤„ç†æ ‡å‡†åŒ–


**é”™è¯¯ç å®šä¹‰**ï¼š

```javascript
const AUTH_ERROR_CODES = {
    // ç”¨æˆ·ç›¸å…³é”™è¯¯
    USER_DENIED: { code: 'USER_DENIED', message: 'ç”¨æˆ·æ‹’ç»æˆæƒ' },
    USER_CANCELLED: { code: 'USER_CANCELLED', message: 'ç”¨æˆ·å–æ¶ˆç™»å½•' },
    
    // å‚æ•°ç›¸å…³é”™è¯¯
    INVALID_CODE: { code: 'INVALID_CODE', message: 'æˆæƒç æ— æ•ˆæˆ–å·²è¿‡æœŸ' },
    INVALID_STATE: { code: 'INVALID_STATE', message: 'çŠ¶æ€å‚æ•°éªŒè¯å¤±è´¥' },
    MISSING_PARAMS: { code: 'MISSING_PARAMS', message: 'ç¼ºå°‘å¿…è¦å‚æ•°' },
    
    // å¹³å°ç›¸å…³é”™è¯¯
    PLATFORM_ERROR: { code: 'PLATFORM_ERROR', message: 'ç¬¬ä¸‰æ–¹å¹³å°è¿”å›é”™è¯¯' },
    TOKEN_EXPIRED: { code: 'TOKEN_EXPIRED', message: 'è®¿é—®ä»¤ç‰Œå·²è¿‡æœŸ' },
    
    // æœåŠ¡ç›¸å…³é”™è¯¯
    NETWORK_ERROR: { code: 'NETWORK_ERROR', message: 'ç½‘ç»œè¿æ¥å¤±è´¥' },
    SERVER_ERROR: { code: 'SERVER_ERROR', message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯' },
    DATABASE_ERROR: { code: 'DATABASE_ERROR', message: 'æ•°æ®åº“æ“ä½œå¤±è´¥' }
}
```

### 8.4 å®‰å…¨æ³¨æ„äº‹é¡¹


**å‰ç«¯å®‰å…¨è¦ç‚¹**ï¼š

> **ğŸ”’ é‡è¦æé†’**ï¼šå‰ç«¯ä»£ç å¯¹ç”¨æˆ·æ˜¯é€æ˜çš„ï¼Œä»»ä½•æ•æ„Ÿä¿¡æ¯éƒ½ä¸èƒ½æ”¾åœ¨å‰ç«¯ï¼

```javascript
// âŒ é”™è¯¯åšæ³•ï¼šåœ¨å‰ç«¯å­˜å‚¨åº”ç”¨å¯†é’¥
const config = {
    appId: 'your_app_id',
    appSecret: 'your_app_secret'  // ç»å¯¹ä¸èƒ½è¿™æ ·åšï¼
}

// âœ… æ­£ç¡®åšæ³•ï¼šå‰ç«¯åªå­˜å‚¨å…¬å¼€ä¿¡æ¯
const config = {
    appId: 'your_app_id',  // åº”ç”¨IDæ˜¯å…¬å¼€çš„ï¼Œå¯ä»¥æ”¾å‰ç«¯
    redirectUri: 'https://yourdomain.com/callback'
}
```

**åç«¯å®‰å…¨è¦ç‚¹**ï¼š

```javascript
// éªŒè¯çŠ¶æ€å‚æ•°é˜²æ­¢CSRFæ”»å‡»
function validateState(receivedState, expectedState) {
    return receivedState === expectedState && receivedState.length >= 16
}

// éªŒè¯å›è°ƒåŸŸå
function validateRedirectUri(redirectUri) {
    const allowedDomains = ['yourdomain.com', 'www.yourdomain.com']
    const url = new URL(redirectUri)
    return allowedDomains.includes(url.hostname)
}

// è®¾ç½®Tokenè¿‡æœŸæ—¶é—´
const token = jwt.sign(payload, secret, {
    expiresIn: '7d',  // 7å¤©åè¿‡æœŸ
    issuer: 'your_app_name'
})
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æˆæƒæµç¨‹ï¼šç”¨æˆ·æˆæƒ â†’ è·å–code â†’ æ¢å–token â†’ è·å–ç”¨æˆ·ä¿¡æ¯
ğŸ”¸ å‰ç«¯æ–¹å¼ï¼šå¼¹çª—ç™»å½•ï¼ˆPCç«¯æ¨èï¼‰vs é¡µé¢è·³è½¬ï¼ˆç§»åŠ¨ç«¯æ¨èï¼‰
ğŸ”¸ å›è°ƒå¤„ç†ï¼šæ¥æ”¶code â†’ è°ƒç”¨åç«¯API â†’ å¤„ç†ç™»å½•ç»“æœ
ğŸ”¸ çŠ¶æ€ç®¡ç†ï¼šä¿å­˜ç”¨æˆ·ä¿¡æ¯å’Œç™»å½•çŠ¶æ€åˆ°å‰ç«¯å­˜å‚¨
ğŸ”¸ é”™è¯¯å¤„ç†ï¼šç½‘ç»œé”™è¯¯ã€ç”¨æˆ·å–æ¶ˆã€å‚æ•°é”™è¯¯ç­‰åœºæ™¯
```

### 9.2 å…³é”®å®ç°è¦ç‚¹


**ğŸ”¹ åç«¯æ ¸å¿ƒèŒè´£**ï¼š
```
1. æ„é€ æ­£ç¡®çš„æˆæƒURLï¼ˆåŒ…å«æ‰€æœ‰å¿…è¦å‚æ•°ï¼‰
2. å®‰å…¨åœ°å¤„ç†æˆæƒç å›è°ƒï¼ˆéªŒè¯stateå‚æ•°ï¼‰
3. ä¸ç¬¬ä¸‰æ–¹å¹³å°APIäº¤äº’ï¼ˆæ¢tokenã€è·å–ç”¨æˆ·ä¿¡æ¯ï¼‰
4. ç”¨æˆ·æ•°æ®çš„å­˜å‚¨å’Œä¼šè¯ç®¡ç†
5. ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œå“åº”æ ¼å¼
```

**ğŸ”¹ å‰ç«¯æ ¸å¿ƒèŒè´£**ï¼š
```
1. æä¾›è‰¯å¥½çš„ç™»å½•æŒ‰é’®å’Œç”¨æˆ·ç•Œé¢
2. æ ¹æ®è®¾å¤‡ç¯å¢ƒé€‰æ‹©åˆé€‚çš„ç™»å½•æ–¹å¼
3. å¤„ç†æˆæƒå›è°ƒå’Œç»“æœå±•ç¤º
4. ä¸åç«¯APIåä½œå®Œæˆå®Œæ•´ç™»å½•æµç¨‹
5. ç™»å½•çŠ¶æ€çš„æœ¬åœ°å­˜å‚¨å’Œç®¡ç†
```

### 9.3 æœ€ä½³å®è·µå»ºè®®


**ğŸš€ ç”¨æˆ·ä½“éªŒä¼˜åŒ–**ï¼š
- åœ¨æŒ‰é’®ä¸Šæ˜ç¡®æ ‡è¯†æ˜¯ç¬¬ä¸‰æ–¹ç™»å½•
- æä¾›åŠ è½½çŠ¶æ€å’Œè¿›åº¦åé¦ˆ
- é”™è¯¯æç¤ºè¦å‹å¥½ä¸”æä¾›é‡è¯•é€‰é¡¹
- ç§»åŠ¨ç«¯ä¼˜å…ˆä½¿ç”¨é¡µé¢è·³è½¬æ–¹å¼

**ğŸ”’ å®‰å…¨å®è·µ**ï¼š
- å‰ç«¯ç»ä¸å­˜å‚¨åº”ç”¨å¯†é’¥
- ä½¿ç”¨stateå‚æ•°é˜²æ­¢CSRFæ”»å‡»
- éªŒè¯å›è°ƒåŸŸåçš„åˆæ³•æ€§
- Tokenè®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´

**âš¡ æ€§èƒ½ä¼˜åŒ–**ï¼š
- æˆæƒURLå¯ä»¥é¢„å…ˆç”Ÿæˆå‡å°‘ç­‰å¾…æ—¶é—´
- åˆç†è®¾ç½®å¼¹çª—è¶…æ—¶æ£€æµ‹é—´éš”
- é¿å…ä¸å¿…è¦çš„é‡å¤APIè°ƒç”¨

**æ ¸å¿ƒè®°å¿†**ï¼š
- ç¬¬ä¸‰æ–¹ç™»å½•æœ¬è´¨æ˜¯OAuth2æˆæƒæµç¨‹çš„åº”ç”¨
- å‰ç«¯è´Ÿè´£ç”¨æˆ·äº¤äº’ï¼Œåç«¯è´Ÿè´£å®‰å…¨éªŒè¯
- å¼¹çª—å’Œè·³è½¬ä¸¤ç§æ–¹å¼å„æœ‰é€‚ç”¨åœºæ™¯
- å›è°ƒå¤„ç†æ˜¯æ•´ä¸ªæµç¨‹çš„å…³é”®èŠ‚ç‚¹