---
title: 8ã€RBACåç«¯ä»£ç å®ç°
---
## ğŸ“š ç›®å½•

1. [Java/Spring Bootä¸­å®ç°RBACçš„æ€è·¯](#1-JavaSpring-Bootä¸­å®ç°RBACçš„æ€è·¯)
2. [Spring Securityä¸­çš„è§’è‰²ä¸æƒé™ç®¡ç†](#2-Spring-Securityä¸­çš„è§’è‰²ä¸æƒé™ç®¡ç†)
3. [è‡ªå®šä¹‰æƒé™æ‹¦æˆªå™¨/è¿‡æ»¤å™¨](#3-è‡ªå®šä¹‰æƒé™æ‹¦æˆªå™¨è¿‡æ»¤å™¨)
4. [ç»Ÿä¸€å¼‚å¸¸å¤„ç†ï¼ˆæ— æƒé™è¿”å›403ï¼‰](#4-ç»Ÿä¸€å¼‚å¸¸å¤„ç†æ— æƒé™è¿”å›403)
5. [ç¼“å­˜ç”¨æˆ·æƒé™ï¼ˆRedisï¼‰](#5-ç¼“å­˜ç”¨æˆ·æƒé™Redis)
6. [æ•°æ®æƒé™ç»“åˆæ¡ˆä¾‹](#6-æ•°æ®æƒé™ç»“åˆæ¡ˆä¾‹)
7. [åç«¯å®ç°å®Œæ•´ç¤ºä¾‹](#7-åç«¯å®ç°å®Œæ•´ç¤ºä¾‹)
8. [ä¼ä¸šåå°ç®¡ç†ç³»ç»ŸRBACå®ç°ç¤ºä¾‹](#8-ä¼ä¸šåå°ç®¡ç†ç³»ç»ŸRBACå®ç°ç¤ºä¾‹)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ Java/Spring Bootä¸­å®ç°RBACçš„æ€è·¯


### 1.1 RBACå®ç°æ ¸å¿ƒæ€è·¯


**ä»€ä¹ˆæ˜¯å®ç°RBACçš„æ ¸å¿ƒæ€è·¯ï¼Ÿ**

ç®€å•è¯´ï¼Œå°±æ˜¯æŠŠ"è°èƒ½åšä»€ä¹ˆ"è¿™ä¸ªé—®é¢˜ï¼Œé€šè¿‡ä»£ç æ¥ç®¡æ§ã€‚æƒ³è±¡ä¸€ä¸‹å…¬å¸çš„é—¨ç¦ç³»ç»Ÿï¼š

```
å‘˜å·¥å°ç‹ â†’ æœ‰"è´¢åŠ¡éƒ¨é—¨"è§’è‰² â†’ èƒ½è¿›è´¢åŠ¡åŠå…¬å®¤
å‘˜å·¥å°æ â†’ æœ‰"æŠ€æœ¯éƒ¨é—¨"è§’è‰² â†’ ä¸èƒ½è¿›è´¢åŠ¡åŠå…¬å®¤

ä»£ç å®ç°å°±æ˜¯æ¨¡æ‹Ÿè¿™ä¸ªè¿‡ç¨‹ï¼š
ç”¨æˆ·ç™»å½• â†’ æŸ¥çœ‹ä»–æœ‰ä»€ä¹ˆè§’è‰² â†’ è§’è‰²æœ‰ä»€ä¹ˆæƒé™ â†’ å†³å®šèƒ½è®¿é—®ä»€ä¹ˆåŠŸèƒ½
```

### 1.2 Spring Bootå®ç°RBACçš„æ•´ä½“æ¶æ„


```
ç”¨æˆ·è¯·æ±‚ â†’ æƒé™è¿‡æ»¤å™¨ â†’ æ£€æŸ¥ç”¨æˆ·è§’è‰²æƒé™ â†’ å…è®¸/æ‹’ç»è®¿é—®

è¯¦ç»†æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·ç™»å½• â”‚â”€â”€â†’ â”‚ è·å–ç”¨æˆ·è§’è‰² â”‚â”€â”€â†’ â”‚ æ£€æŸ¥æ¥å£æƒé™è¦æ±‚ â”‚â”€â”€â†’ â”‚ æ”¾è¡Œ/æ‹’ç» â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚               â”‚                   â”‚              â”‚
     â–¼               â–¼                   â–¼              â–¼
  JWTè§£æ        æŸ¥è¯¢æ•°æ®åº“           æ³¨è§£/é…ç½®        è¿”å›ç»“æœ
```

### 1.3 æ ¸å¿ƒå®ç°ç»„ä»¶


**éœ€è¦å“ªäº›æ ¸å¿ƒç»„ä»¶ï¼Ÿ**

1. **ç”¨æˆ·è®¤è¯** - éªŒè¯"ä½ æ˜¯è°"
2. **è§’è‰²ç®¡ç†** - å®šä¹‰"ä½ æ˜¯ä»€ä¹ˆèº«ä»½" 
3. **æƒé™æ§åˆ¶** - å†³å®š"ä½ èƒ½åšä»€ä¹ˆ"
4. **æ‹¦æˆªæ£€æŸ¥** - åœ¨æ¯æ¬¡æ“ä½œå‰æ£€æŸ¥æƒé™

```java
// æœ€ç®€å•çš„æƒé™æ£€æŸ¥æ€è·¯
public boolean hasPermission(String userId, String resource) {
    // 1. æ ¹æ®ç”¨æˆ·IDæŸ¥æ‰¾ç”¨æˆ·è§’è‰²
    List<String> userRoles = getUserRoles(userId);
    
    // 2. æ ¹æ®è§’è‰²æŸ¥æ‰¾æƒé™
    List<String> permissions = getPermissionsByRoles(userRoles);
    
    // 3. æ£€æŸ¥æ˜¯å¦æœ‰è®¿é—®è¯¥èµ„æºçš„æƒé™
    return permissions.contains(resource);
}
```

---

## 2. ğŸ›¡ï¸ Spring Securityä¸­çš„è§’è‰²ä¸æƒé™ç®¡ç†


### 2.1 Spring SecurityåŸºç¡€æ¦‚å¿µ


**Spring Securityæ˜¯ä»€ä¹ˆï¼Ÿ**

Spring Securityå°±åƒæ˜¯ä½ å®¶çš„å®‰ä¿ç³»ç»Ÿï¼Œå®ƒè´Ÿè´£ï¼š
- **è®¤è¯ï¼ˆAuthenticationï¼‰**ï¼šç¡®è®¤æ¥è®¿è€…èº«ä»½ï¼ˆæ˜¯ä¸æ˜¯å®¶äººï¼‰
- **æˆæƒï¼ˆAuthorizationï¼‰**ï¼šå†³å®šèƒ½è¿›å“ªä¸ªæˆ¿é—´ï¼ˆå®¢å…å¯ä»¥ï¼Œå§å®¤ä¸è¡Œï¼‰

### 2.2 è§’è‰²ä¸æƒé™çš„åŒºåˆ«


```
è§’è‰²ï¼ˆRoleï¼‰ï¼šèº«ä»½æ ‡è¯†
- ROLE_ADMINï¼ˆç®¡ç†å‘˜ï¼‰
- ROLE_USERï¼ˆæ™®é€šç”¨æˆ·ï¼‰
- ROLE_MANAGERï¼ˆç»ç†ï¼‰

æƒé™ï¼ˆAuthorityï¼‰ï¼šå…·ä½“æ“ä½œæƒé™
- user:readï¼ˆæŸ¥çœ‹ç”¨æˆ·ï¼‰
- user:writeï¼ˆä¿®æ”¹ç”¨æˆ·ï¼‰
- order:deleteï¼ˆåˆ é™¤è®¢å•ï¼‰

å…³ç³»ï¼šä¸€ä¸ªè§’è‰²åŒ…å«å¤šä¸ªæƒé™
ç®¡ç†å‘˜è§’è‰² = user:read + user:write + order:delete + ...
```

### 2.3 Spring Securityé…ç½®å®ç°


```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            // é…ç½®è®¿é—®æ§åˆ¶
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/public/**").permitAll()  // å…¬å¼€æ¥å£
                .requestMatchers("/admin/**").hasRole("ADMIN")  // ç®¡ç†å‘˜æ¥å£
                .requestMatchers("/user/**").hasAnyRole("USER", "ADMIN")  // ç”¨æˆ·æ¥å£
                .anyRequest().authenticated()  // å…¶ä»–æ¥å£éœ€è¦è®¤è¯
            )
            // JWTé…ç½®
            .sessionManagement(session -> 
                session.sessionCreationPolicy(SessionCreationPolicy.STATELESS)
            );
        
        return http.build();
    }
}
```

### 2.4 ç”¨æˆ·è¯¦æƒ…æœåŠ¡å®ç°


```java
@Service
public class CustomUserDetailsService implements UserDetailsService {
    
    @Autowired
    private UserService userService;
    
    @Override
    public UserDetails loadUserByUsername(String username) {
        // 1. æŸ¥è¯¢ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
        User user = userService.findByUsername(username);
        if (user == null) {
            throw new UsernameNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨");
        }
        
        // 2. æŸ¥è¯¢ç”¨æˆ·è§’è‰²å’Œæƒé™
        List<String> roles = userService.getUserRoles(user.getId());
        List<String> permissions = userService.getUserPermissions(user.getId());
        
        // 3. æ„å»ºæƒé™åˆ—è¡¨ï¼ˆè§’è‰²å’Œæƒé™éƒ½è¦åŠ å…¥ï¼‰
        List<GrantedAuthority> authorities = new ArrayList<>();
        
        // æ·»åŠ è§’è‰²ï¼ˆSpring Securityè¦æ±‚è§’è‰²ä»¥ROLE_å¼€å¤´ï¼‰
        roles.forEach(role -> 
            authorities.add(new SimpleGrantedAuthority("ROLE_" + role))
        );
        
        // æ·»åŠ å…·ä½“æƒé™
        permissions.forEach(permission -> 
            authorities.add(new SimpleGrantedAuthority(permission))
        );
        
        return new org.springframework.security.core.userdetails.User(
            user.getUsername(), 
            user.getPassword(), 
            authorities
        );
    }
}
```

---

## 3. ğŸ”’ è‡ªå®šä¹‰æƒé™æ‹¦æˆªå™¨/è¿‡æ»¤å™¨


### 3.1 ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰æ‹¦æˆªå™¨ï¼Ÿ


**Spring Securityçš„é»˜è®¤æ–¹å¼æœ‰ä»€ä¹ˆä¸è¶³ï¼Ÿ**

Spring Securityé»˜è®¤çš„æƒé™æ§åˆ¶æ¯”è¾ƒç²—ç³™ï¼Œåªèƒ½é…ç½®"è¿™ä¸ªURLéœ€è¦ä»€ä¹ˆè§’è‰²"ã€‚ä½†å®é™…ä¸šåŠ¡ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ›´çµæ´»çš„æ§åˆ¶ï¼š

- åŒä¸€ä¸ªæ¥å£ï¼Œä¸åŒç”¨æˆ·èƒ½çœ‹åˆ°ä¸åŒæ•°æ®
- æ ¹æ®ä¸šåŠ¡æ¡ä»¶åŠ¨æ€åˆ¤æ–­æƒé™
- éœ€è¦è®°å½•æƒé™æ£€æŸ¥æ—¥å¿—

### 3.2 è‡ªå®šä¹‰æƒé™æ³¨è§£


```java
@Target({ElementType.METHOD})
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface RequirePermission {
    /**
     * éœ€è¦çš„æƒé™ç 
     */
    String value();
    
    /**
     * æƒé™åç§°æè¿°
     */
    String name() default "";
}
```

### 3.3 æƒé™æ‹¦æˆªå™¨å®ç°


```java
@Component
public class PermissionInterceptor implements HandlerInterceptor {
    
    @Autowired
    private PermissionService permissionService;
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler) throws Exception {
        
        // 1. æ£€æŸ¥æ˜¯å¦æ˜¯Controlleræ–¹æ³•
        if (!(handler instanceof HandlerMethod)) {
            return true;
        }
        
        HandlerMethod method = (HandlerMethod) handler;
        
        // 2. æ£€æŸ¥æ–¹æ³•æ˜¯å¦æœ‰æƒé™æ³¨è§£
        RequirePermission annotation = method.getMethodAnnotation(RequirePermission.class);
        if (annotation == null) {
            return true; // æ²¡æœ‰æƒé™è¦æ±‚ï¼Œç›´æ¥æ”¾è¡Œ
        }
        
        // 3. è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
        String currentUser = getCurrentUser(request);
        if (currentUser == null) {
            response.setStatus(HttpStatus.UNAUTHORIZED.value());
            return false;
        }
        
        // 4. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰è¯¥æƒé™
        String requiredPermission = annotation.value();
        boolean hasPermission = permissionService.hasPermission(currentUser, requiredPermission);
        
        if (!hasPermission) {
            response.setStatus(HttpStatus.FORBIDDEN.value());
            return false;
        }
        
        return true;
    }
    
    private String getCurrentUser(HttpServletRequest request) {
        // ä»JWT tokenæˆ–sessionä¸­è·å–ç”¨æˆ·ä¿¡æ¯
        String token = request.getHeader("Authorization");
        if (token != null && token.startsWith("Bearer ")) {
            return JwtUtil.getUsernameFromToken(token.substring(7));
        }
        return null;
    }
}
```

### 3.4 æ³¨å†Œæ‹¦æˆªå™¨


```java
@Configuration
public class WebConfig implements WebMvcConfigurer {
    
    @Autowired
    private PermissionInterceptor permissionInterceptor;
    
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(permissionInterceptor)
                .addPathPatterns("/api/**")  // æ‹¦æˆªAPIæ¥å£
                .excludePathPatterns("/api/login", "/api/register");  // æ’é™¤ç™»å½•æ³¨å†Œ
    }
}
```

### 3.5 åœ¨Controllerä¸­ä½¿ç”¨


```java
@RestController
@RequestMapping("/api/user")
public class UserController {
    
    @GetMapping("/list")
    @RequirePermission(value = "user:read", name = "æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨")
    public List<User> getUserList() {
        return userService.getAllUsers();
    }
    
    @PostMapping
    @RequirePermission(value = "user:create", name = "åˆ›å»ºç”¨æˆ·")
    public User createUser(@RequestBody User user) {
        return userService.createUser(user);
    }
    
    @DeleteMapping("/{id}")
    @RequirePermission(value = "user:delete", name = "åˆ é™¤ç”¨æˆ·")
    public void deleteUser(@PathVariable Long id) {
        userService.deleteUser(id);
    }
}
```

---

## 4. âš ï¸ ç»Ÿä¸€å¼‚å¸¸å¤„ç†ï¼ˆæ— æƒé™è¿”å›403ï¼‰


### 4.1 ä¸ºä»€ä¹ˆéœ€è¦ç»Ÿä¸€å¼‚å¸¸å¤„ç†ï¼Ÿ


**æ²¡æœ‰ç»Ÿä¸€å¼‚å¸¸å¤„ç†ä¼šæ€æ ·ï¼Ÿ**

```
ç”¨æˆ·è®¿é—®æ²¡æƒé™çš„æ¥å£ï¼š
æƒ…å†µ1ï¼šè¿”å›500é”™è¯¯ + ä¸€å †æŠ€æœ¯é”™è¯¯ä¿¡æ¯ï¼ˆç”¨æˆ·çœ‹ä¸æ‡‚ï¼‰
æƒ…å†µ2ï¼šè¿”å›404é”™è¯¯ï¼ˆè¯¯å¯¼ç”¨æˆ·ä»¥ä¸ºæ¥å£ä¸å­˜åœ¨ï¼‰
æƒ…å†µ3ï¼šä¸åŒæ¥å£è¿”å›ä¸åŒæ ¼å¼çš„é”™è¯¯ï¼ˆå‰ç«¯å¤„ç†å›°éš¾ï¼‰

æœ‰äº†ç»Ÿä¸€å¼‚å¸¸å¤„ç†ï¼š
æ‰€æœ‰æƒé™é—®é¢˜éƒ½è¿”å›403 + ç»Ÿä¸€æ ¼å¼çš„é”™è¯¯ä¿¡æ¯
```

### 4.2 è‡ªå®šä¹‰æƒé™å¼‚å¸¸ç±»


```java
public class PermissionDeniedException extends RuntimeException {
    private String permission;
    private String resource;
    
    public PermissionDeniedException(String permission, String resource) {
        super(String.format("æ²¡æœ‰æƒé™è®¿é—®èµ„æºï¼š%sï¼Œéœ€è¦æƒé™ï¼š%s", resource, permission));
        this.permission = permission;
        this.resource = resource;
    }
    
    // getters...
}
```

### 4.3 å…¨å±€å¼‚å¸¸å¤„ç†å™¨


```java
@RestControllerAdvice
public class GlobalExceptionHandler {
    
    private static final Logger logger = LoggerFactory.getLogger(GlobalExceptionHandler.class);
    
    /**
     * å¤„ç†æƒé™ä¸è¶³å¼‚å¸¸
     */
    @ExceptionHandler(PermissionDeniedException.class)
    public ResponseEntity<ApiResponse> handlePermissionDenied(PermissionDeniedException ex) {
        logger.warn("æƒé™ä¸è¶³ï¼š{}", ex.getMessage());
        
        ApiResponse response = ApiResponse.builder()
                .code(403)
                .message("æƒé™ä¸è¶³ï¼š" + ex.getMessage())
                .success(false)
                .timestamp(System.currentTimeMillis())
                .build();
                
        return ResponseEntity.status(HttpStatus.FORBIDDEN).body(response);
    }
    
    /**
     * å¤„ç†è®¤è¯å¤±è´¥å¼‚å¸¸
     */
    @ExceptionHandler(AuthenticationException.class)
    public ResponseEntity<ApiResponse> handleAuthenticationException(AuthenticationException ex) {
        logger.warn("è®¤è¯å¤±è´¥ï¼š{}", ex.getMessage());
        
        ApiResponse response = ApiResponse.builder()
                .code(401)
                .message("è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•")
                .success(false)
                .timestamp(System.currentTimeMillis())
                .build();
                
        return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(response);
    }
    
    /**
     * å¤„ç†Spring Securityè®¿é—®æ‹’ç»å¼‚å¸¸
     */
    @ExceptionHandler(AccessDeniedException.class)
    public ResponseEntity<ApiResponse> handleAccessDenied(AccessDeniedException ex) {
        logger.warn("è®¿é—®è¢«æ‹’ç»ï¼š{}", ex.getMessage());
        
        ApiResponse response = ApiResponse.builder()
                .code(403)
                .message("è®¿é—®è¢«æ‹’ç»ï¼Œæƒé™ä¸è¶³")
                .success(false)
                .timestamp(System.currentTimeMillis())
                .build();
                
        return ResponseEntity.status(HttpStatus.FORBIDDEN).body(response);
    }
}
```

### 4.4 ç»Ÿä¸€å“åº”æ ¼å¼


```java
@Data
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class ApiResponse<T> {
    private boolean success;      // æ˜¯å¦æˆåŠŸ
    private int code;            // çŠ¶æ€ç 
    private String message;      // æ¶ˆæ¯
    private T data;             // æ•°æ®
    private long timestamp;     // æ—¶é—´æˆ³
    
    public static <T> ApiResponse<T> success(T data) {
        return ApiResponse.<T>builder()
                .success(true)
                .code(200)
                .message("æ“ä½œæˆåŠŸ")
                .data(data)
                .timestamp(System.currentTimeMillis())
                .build();
    }
    
    public static <T> ApiResponse<T> error(int code, String message) {
        return ApiResponse.<T>builder()
                .success(false)
                .code(code)
                .message(message)
                .timestamp(System.currentTimeMillis())
                .build();
    }
}
```

### 4.5 æ”¹è¿›æƒé™æ£€æŸ¥é€»è¾‘


```java
@Service
public class PermissionService {
    
    public void checkPermission(String userId, String permission, String resource) {
        if (!hasPermission(userId, permission)) {
            // æŠ›å‡ºè‡ªå®šä¹‰å¼‚å¸¸ï¼Œç”±å…¨å±€å¼‚å¸¸å¤„ç†å™¨ç»Ÿä¸€å¤„ç†
            throw new PermissionDeniedException(permission, resource);
        }
    }
    
    public boolean hasPermission(String userId, String permission) {
        // å®é™…çš„æƒé™æ£€æŸ¥é€»è¾‘
        List<String> userPermissions = getUserPermissions(userId);
        return userPermissions.contains(permission);
    }
}
```

---

## 5. ğŸš€ ç¼“å­˜ç”¨æˆ·æƒé™ï¼ˆRedisï¼‰


### 5.1 ä¸ºä»€ä¹ˆè¦ç¼“å­˜ç”¨æˆ·æƒé™ï¼Ÿ


**ä¸ä½¿ç”¨ç¼“å­˜çš„é—®é¢˜ï¼š**

```
æ¯æ¬¡è¯·æ±‚éƒ½æŸ¥æ•°æ®åº“ï¼š
ç”¨æˆ·è®¿é—® â†’ æŸ¥æ•°æ®åº“è·å–è§’è‰² â†’ æŸ¥æ•°æ®åº“è·å–æƒé™ â†’ æƒé™æ£€æŸ¥

é—®é¢˜ï¼š
- æ•°æ®åº“å‹åŠ›å¤§ï¼ˆæ¯ä¸ªè¯·æ±‚éƒ½æŸ¥è¯¢ï¼‰
- å“åº”é€Ÿåº¦æ…¢ï¼ˆç­‰å¾…æ•°æ®åº“æŸ¥è¯¢ï¼‰
- ç³»ç»Ÿå¹¶å‘èƒ½åŠ›å·®
```

**ä½¿ç”¨Redisç¼“å­˜åï¼š**

```
é¦–æ¬¡è¯·æ±‚ï¼šæŸ¥æ•°æ®åº“ â†’ å­˜å…¥Redisç¼“å­˜
åç»­è¯·æ±‚ï¼šç›´æ¥ä»Redisè¯»å– â†’ æƒé™æ£€æŸ¥ï¼ˆé€Ÿåº¦å¿«100å€ï¼‰
```

### 5.2 Redisç¼“å­˜é…ç½®


```java
@Configuration
@EnableCaching
public class RedisConfig {
    
    @Bean
    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory factory) {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(factory);
        
        // è®¾ç½®åºåˆ—åŒ–æ–¹å¼
        template.setKeySerializer(new StringRedisSerializer());
        template.setHashKeySerializer(new StringRedisSerializer());
        template.setValueSerializer(new GenericJackson2JsonRedisSerializer());
        template.setHashValueSerializer(new GenericJackson2JsonRedisSerializer());
        
        return template;
    }
    
    @Bean
    public CacheManager cacheManager(RedisConnectionFactory factory) {
        RedisCacheConfiguration config = RedisCacheConfiguration.defaultCacheConfig()
                .entryTtl(Duration.ofMinutes(30))  // ç¼“å­˜30åˆ†é’Ÿ
                .disableCachingNullValues();       // ä¸ç¼“å­˜nullå€¼
                
        return RedisCacheManager.builder(factory)
                .cacheDefaults(config)
                .build();
    }
}
```

### 5.3 æƒé™ç¼“å­˜æœåŠ¡


```java
@Service
public class PermissionCacheService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private UserService userService;
    
    private static final String USER_PERMISSIONS_KEY = "user:permissions:";
    private static final String USER_ROLES_KEY = "user:roles:";
    
    /**
     * è·å–ç”¨æˆ·æƒé™ï¼ˆå¸¦ç¼“å­˜ï¼‰
     */
    public List<String> getUserPermissions(String userId) {
        String cacheKey = USER_PERMISSIONS_KEY + userId;
        
        // 1. å…ˆä»ç¼“å­˜æŸ¥è¯¢
        @SuppressWarnings("unchecked")
        List<String> cachedPermissions = (List<String>) redisTemplate.opsForValue().get(cacheKey);
        
        if (cachedPermissions != null) {
            return cachedPermissions;  // å‘½ä¸­ç¼“å­˜ï¼Œç›´æ¥è¿”å›
        }
        
        // 2. ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“
        List<String> permissions = userService.getUserPermissionsFromDB(userId);
        
        // 3. å­˜å…¥ç¼“å­˜ï¼ˆ30åˆ†é’Ÿè¿‡æœŸï¼‰
        redisTemplate.opsForValue().set(cacheKey, permissions, Duration.ofMinutes(30));
        
        return permissions;
    }
    
    /**
     * è·å–ç”¨æˆ·è§’è‰²ï¼ˆå¸¦ç¼“å­˜ï¼‰
     */
    public List<String> getUserRoles(String userId) {
        String cacheKey = USER_ROLES_KEY + userId;
        
        @SuppressWarnings("unchecked")
        List<String> cachedRoles = (List<String>) redisTemplate.opsForValue().get(cacheKey);
        
        if (cachedRoles != null) {
            return cachedRoles;
        }
        
        List<String> roles = userService.getUserRolesFromDB(userId);
        redisTemplate.opsForValue().set(cacheKey, roles, Duration.ofMinutes(30));
        
        return roles;
    }
    
    /**
     * æ¸…é™¤ç”¨æˆ·æƒé™ç¼“å­˜ï¼ˆè§’è‰²æƒé™å˜æ›´æ—¶è°ƒç”¨ï¼‰
     */
    public void clearUserPermissionCache(String userId) {
        redisTemplate.delete(USER_PERMISSIONS_KEY + userId);
        redisTemplate.delete(USER_ROLES_KEY + userId);
    }
    
    /**
     * æ‰¹é‡æ¸…é™¤æƒé™ç¼“å­˜
     */
    public void clearAllUserPermissionCache() {
        Set<String> permissionKeys = redisTemplate.keys(USER_PERMISSIONS_KEY + "*");
        Set<String> roleKeys = redisTemplate.keys(USER_ROLES_KEY + "*");
        
        if (!permissionKeys.isEmpty()) {
            redisTemplate.delete(permissionKeys);
        }
        if (!roleKeys.isEmpty()) {
            redisTemplate.delete(roleKeys);
        }
    }
}
```

### 5.4 æ”¹è¿›æƒé™æ£€æŸ¥æœåŠ¡


```java
@Service
public class PermissionService {
    
    @Autowired
    private PermissionCacheService cacheService;
    
    /**
     * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æŒ‡å®šæƒé™ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰
     */
    public boolean hasPermission(String userId, String permission) {
        // ä»ç¼“å­˜è·å–ç”¨æˆ·æƒé™
        List<String> userPermissions = cacheService.getUserPermissions(userId);
        return userPermissions.contains(permission);
    }
    
    /**
     * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æŒ‡å®šè§’è‰²ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰
     */
    public boolean hasRole(String userId, String role) {
        List<String> userRoles = cacheService.getUserRoles(userId);
        return userRoles.contains(role);
    }
    
    /**
     * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰ä»»ä¸€è§’è‰²
     */
    public boolean hasAnyRole(String userId, String... roles) {
        List<String> userRoles = cacheService.getUserRoles(userId);
        return Arrays.stream(roles).anyMatch(userRoles::contains);
    }
}
```

### 5.5 æƒé™å˜æ›´æ—¶æ›´æ–°ç¼“å­˜


```java
@Service
public class UserRoleService {
    
    @Autowired
    private UserRoleMapper userRoleMapper;
    
    @Autowired
    private PermissionCacheService cacheService;
    
    /**
     * ç»™ç”¨æˆ·åˆ†é…è§’è‰²
     */
    public void assignRoleToUser(String userId, String roleId) {
        // 1. æ›´æ–°æ•°æ®åº“
        userRoleMapper.insertUserRole(userId, roleId);
        
        // 2. æ¸…é™¤ç”¨æˆ·æƒé™ç¼“å­˜
        cacheService.clearUserPermissionCache(userId);
    }
    
    /**
     * ç§»é™¤ç”¨æˆ·è§’è‰²
     */
    public void removeRoleFromUser(String userId, String roleId) {
        userRoleMapper.deleteUserRole(userId, roleId);
        cacheService.clearUserPermissionCache(userId);
    }
    
    /**
     * æ›´æ–°è§’è‰²æƒé™æ—¶ï¼Œæ¸…é™¤æ‰€æœ‰ç›¸å…³ç”¨æˆ·çš„ç¼“å­˜
     */
    public void updateRolePermissions(String roleId, List<String> permissionIds) {
        // 1. æ›´æ–°è§’è‰²æƒé™
        rolePermissionMapper.updateRolePermissions(roleId, permissionIds);
        
        // 2. è·å–æ‹¥æœ‰è¯¥è§’è‰²çš„æ‰€æœ‰ç”¨æˆ·
        List<String> userIds = userRoleMapper.getUserIdsByRoleId(roleId);
        
        // 3. æ¸…é™¤è¿™äº›ç”¨æˆ·çš„æƒé™ç¼“å­˜
        userIds.forEach(userId -> cacheService.clearUserPermissionCache(userId));
    }
}
```

---

## 6. ğŸ“Š æ•°æ®æƒé™ç»“åˆæ¡ˆä¾‹


### 6.1 ä»€ä¹ˆæ˜¯æ•°æ®æƒé™ï¼Ÿ


**åŠŸèƒ½æƒé™ vs æ•°æ®æƒé™çš„åŒºåˆ«ï¼š**

```
åŠŸèƒ½æƒé™ï¼šèƒ½ä¸èƒ½ä½¿ç”¨æŸä¸ªåŠŸèƒ½
- èƒ½ä¸èƒ½æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨ âœ“
- èƒ½ä¸èƒ½åˆ é™¤è®¢å• âœ“

æ•°æ®æƒé™ï¼šèƒ½çœ‹åˆ°å“ªäº›æ•°æ®
- æ™®é€šå‘˜å·¥ï¼šåªèƒ½çœ‹è‡ªå·±çš„æ•°æ®
- éƒ¨é—¨ç»ç†ï¼šèƒ½çœ‹éƒ¨é—¨å†…æ‰€æœ‰æ•°æ®  
- æ€»ç»ç†ï¼šèƒ½çœ‹å…¨å…¬å¸æ•°æ®
```

**å®é™…ä¸šåŠ¡åœºæ™¯ï¼š**
```
åŒæ ·æ˜¯"æŸ¥çœ‹è®¢å•"åŠŸèƒ½ï¼š
- é”€å”®å‘˜Aï¼šåªèƒ½çœ‹è‡ªå·±è´Ÿè´£çš„è®¢å•
- é”€å”®ä¸»ç®¡ï¼šèƒ½çœ‹æ•´ä¸ªé”€å”®ç»„çš„è®¢å•
- åŒºåŸŸç»ç†ï¼šèƒ½çœ‹æ•´ä¸ªåŒºåŸŸçš„è®¢å•
- æ€»ç»ç†ï¼šèƒ½çœ‹æ‰€æœ‰è®¢å•
```

### 6.2 æ•°æ®æƒé™å®ç°æ–¹æ¡ˆ


```java
@Component
public class DataPermissionHelper {
    
    /**
     * æ ¹æ®ç”¨æˆ·æƒé™æ„å»ºæ•°æ®è¿‡æ»¤æ¡ä»¶
     */
    public String buildDataFilter(String userId, String tableName) {
        List<String> userRoles = getUserRoles(userId);
        
        StringBuilder filter = new StringBuilder();
        
        for (String role : userRoles) {
            switch (role) {
                case "EMPLOYEE":
                    // æ™®é€šå‘˜å·¥ï¼šåªèƒ½çœ‹è‡ªå·±çš„æ•°æ®
                    filter.append(tableName).append(".create_user = '").append(userId).append("'");
                    break;
                    
                case "MANAGER":
                    // éƒ¨é—¨ç»ç†ï¼šçœ‹éƒ¨é—¨å†…æ•°æ®
                    String deptId = getUserDeptId(userId);
                    filter.append(tableName).append(".dept_id = '").append(deptId).append("'");
                    break;
                    
                case "ADMIN":
                    // ç®¡ç†å‘˜ï¼šçœ‹æ‰€æœ‰æ•°æ®
                    filter.append("1=1");  // ä¸é™åˆ¶
                    break;
            }
        }
        
        return filter.toString();
    }
}
```

### 6.3 MyBatisæ‹¦æˆªå™¨å®ç°æ•°æ®æƒé™


```java
@Intercepts({
    @Signature(type = Executor.class, method = "query", 
               args = {MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class})
})
public class DataPermissionInterceptor implements Interceptor {
    
    @Override
    public Object intercept(Invocation invocation) throws Throwable {
        MappedStatement ms = (MappedStatement) invocation.getArgs()[0];
        Object parameter = invocation.getArgs()[1];
        
        // è·å–å½“å‰ç”¨æˆ·
        String currentUser = getCurrentUser();
        if (currentUser == null) {
            return invocation.proceed();
        }
        
        // è·å–åŸå§‹SQL
        BoundSql boundSql = ms.getBoundSql(parameter);
        String originalSql = boundSql.getSql();
        
        // æ„å»ºæ•°æ®æƒé™è¿‡æ»¤æ¡ä»¶
        String dataFilter = buildDataFilter(currentUser, originalSql);
        
        if (StringUtils.isNotEmpty(dataFilter)) {
            // ä¿®æ”¹SQLï¼Œæ·»åŠ æƒé™è¿‡æ»¤
            String newSql = addDataFilter(originalSql, dataFilter);
            
            // åˆ›å»ºæ–°çš„BoundSql
            BoundSql newBoundSql = new BoundSql(ms.getConfiguration(), newSql, 
                                               boundSql.getParameterMappings(), parameter);
            
            // åˆ›å»ºæ–°çš„MappedStatement
            MappedStatement newMs = copyMappedStatement(ms, new BoundSqlSource(newBoundSql));
            invocation.getArgs()[0] = newMs;
        }
        
        return invocation.proceed();
    }
    
    private String addDataFilter(String originalSql, String dataFilter) {
        // ç®€å•å®ç°ï¼šåœ¨WHEREå­å¥ä¸­æ·»åŠ æ•°æ®æƒé™è¿‡æ»¤
        if (originalSql.toLowerCase().contains("where")) {
            return originalSql + " AND (" + dataFilter + ")";
        } else {
            return originalSql + " WHERE " + dataFilter;
        }
    }
}
```

### 6.4 æ³¨è§£æ–¹å¼çš„æ•°æ®æƒé™æ§åˆ¶


```java
@Target({ElementType.METHOD})
@Retention(RetentionPolicy.RUNTIME)
public @interface DataPermission {
    /**
     * è¡¨åˆ«å
     */
    String tableAlias() default "";
    
    /**
     * æ•°æ®æƒé™ç±»å‹
     */
    DataScopeType type() default DataScopeType.DEPT;
}

public enum DataScopeType {
    ALL,      // å…¨éƒ¨æ•°æ®
    DEPT,     // éƒ¨é—¨æ•°æ®
    DEPT_SUB, // éƒ¨é—¨åŠä¸‹çº§æ•°æ®
    SELF      // ä»…æœ¬äººæ•°æ®
}
```

### 6.5 å®é™…ä½¿ç”¨ç¤ºä¾‹


```java
@RestController
@RequestMapping("/api/order")
public class OrderController {
    
    @GetMapping("/list")
    @RequirePermission("order:read")
    @DataPermission(tableAlias = "o", type = DataScopeType.DEPT)
    public List<Order> getOrderList(@RequestParam Map<String, Object> params) {
        // æŸ¥è¯¢ä¼šè‡ªåŠ¨æ·»åŠ æ•°æ®æƒé™è¿‡æ»¤
        return orderService.getOrderList(params);
    }
}
```

---

## 7. ğŸ’» åç«¯å®ç°å®Œæ•´ç¤ºä¾‹


### 7.1 æ•°æ®åº“è¡¨ç»“æ„


```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE sys_user (
    id VARCHAR(32) PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password VARCHAR(100) NOT NULL,
    email VARCHAR(100),
    dept_id VARCHAR(32),
    status TINYINT DEFAULT 1,
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- è§’è‰²è¡¨
CREATE TABLE sys_role (
    id VARCHAR(32) PRIMARY KEY,
    role_name VARCHAR(50) NOT NULL,
    role_code VARCHAR(50) UNIQUE NOT NULL,
    description VARCHAR(200),
    status TINYINT DEFAULT 1,
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- æƒé™è¡¨
CREATE TABLE sys_permission (
    id VARCHAR(32) PRIMARY KEY,
    permission_name VARCHAR(50) NOT NULL,
    permission_code VARCHAR(100) UNIQUE NOT NULL,
    resource_type VARCHAR(20),  -- menu/button/api
    parent_id VARCHAR(32),
    sort_order INT DEFAULT 0,
    status TINYINT DEFAULT 1
);

-- ç”¨æˆ·è§’è‰²å…³è”è¡¨
CREATE TABLE sys_user_role (
    user_id VARCHAR(32),
    role_id VARCHAR(32),
    PRIMARY KEY (user_id, role_id)
);

-- è§’è‰²æƒé™å…³è”è¡¨
CREATE TABLE sys_role_permission (
    role_id VARCHAR(32),
    permission_id VARCHAR(32),
    PRIMARY KEY (role_id, permission_id)
);
```

### 7.2 å®ä½“ç±»å®šä¹‰


```java
@Data
@TableName("sys_user")
public class SysUser {
    @TableId(type = IdType.ASSIGN_UUID)
    private String id;
    
    private String username;
    private String password;
    private String email;
    private String deptId;
    private Integer status;
    
    @TableField(exist = false)
    private List<String> roleIds;  // ç”¨æˆ·è§’è‰²IDåˆ—è¡¨
    
    @TableField(exist = false)
    private List<String> permissions;  // ç”¨æˆ·æƒé™åˆ—è¡¨
}

@Data
@TableName("sys_role")
public class SysRole {
    @TableId(type = IdType.ASSIGN_UUID)
    private String id;
    
    private String roleName;
    private String roleCode;
    private String description;
    private Integer status;
    
    @TableField(exist = false)
    private List<String> permissionIds;  // è§’è‰²æƒé™IDåˆ—è¡¨
}

@Data
@TableName("sys_permission")
public class SysPermission {
    @TableId(type = IdType.ASSIGN_UUID)
    private String id;
    
    private String permissionName;
    private String permissionCode;
    private String resourceType;
    private String parentId;
    private Integer sortOrder;
    private Integer status;
}
```

### 7.3 Mapperå±‚å®ç°


```java
@Mapper
public interface SysUserMapper extends BaseMapper<SysUser> {
    
    /**
     * æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼ˆåŒ…å«è§’è‰²æƒé™ï¼‰
     */
    SysUser selectUserWithRoles(@Param("username") String username);
    
    /**
     * æŸ¥è¯¢ç”¨æˆ·æƒé™åˆ—è¡¨
     */
    List<String> selectUserPermissions(@Param("userId") String userId);
    
    /**
     * æŸ¥è¯¢ç”¨æˆ·è§’è‰²åˆ—è¡¨
     */
    List<String> selectUserRoles(@Param("userId") String userId);
}
```

### 7.4 Serviceå±‚å®ç°


```java
@Service
@Transactional
public class SysUserService {
    
    @Autowired
    private SysUserMapper userMapper;
    
    @Autowired
    private PermissionCacheService cacheService;
    
    /**
     * æ ¹æ®ç”¨æˆ·åè·å–ç”¨æˆ·ä¿¡æ¯
     */
    public SysUser getUserByUsername(String username) {
        SysUser user = userMapper.selectUserWithRoles(username);
        if (user != null) {
            // è·å–ç”¨æˆ·æƒé™ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰
            user.setPermissions(cacheService.getUserPermissions(user.getId()));
        }
        return user;
    }
    
    /**
     * åˆ›å»ºç”¨æˆ·å¹¶åˆ†é…è§’è‰²
     */
    public void createUser(SysUser user, List<String> roleIds) {
        // 1. å¯†ç åŠ å¯†
        user.setPassword(passwordEncoder.encode(user.getPassword()));
        
        // 2. ä¿å­˜ç”¨æˆ·
        userMapper.insert(user);
        
        // 3. åˆ†é…è§’è‰²
        if (roleIds != null && !roleIds.isEmpty()) {
            assignRolesToUser(user.getId(), roleIds);
        }
    }
    
    /**
     * ç»™ç”¨æˆ·åˆ†é…è§’è‰²
     */
    public void assignRolesToUser(String userId, List<String> roleIds) {
        // 1. åˆ é™¤åŸæœ‰è§’è‰²
        userRoleMapper.deleteByUserId(userId);
        
        // 2. åˆ†é…æ–°è§’è‰²
        roleIds.forEach(roleId -> 
            userRoleMapper.insert(new SysUserRole(userId, roleId))
        );
        
        // 3. æ¸…é™¤æƒé™ç¼“å­˜
        cacheService.clearUserPermissionCache(userId);
    }
    
    /**
     * æ£€æŸ¥ç”¨æˆ·æƒé™
     */
    public boolean hasPermission(String userId, String permission) {
        List<String> userPermissions = cacheService.getUserPermissions(userId);
        return userPermissions.contains(permission);
    }
}
```

### 7.5 Controllerå±‚å®ç°


```java
@RestController
@RequestMapping("/api/system/user")
@Slf4j
public class SysUserController {
    
    @Autowired
    private SysUserService userService;
    
    /**
     * è·å–ç”¨æˆ·åˆ—è¡¨
     */
    @GetMapping("/list")
    @RequirePermission(value = "system:user:list", name = "æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨")
    public ApiResponse<PageResult<SysUser>> getUserList(
            @RequestParam(defaultValue = "1") int pageNum,
            @RequestParam(defaultValue = "10") int pageSize,
            @RequestParam(required = false) String username) {
        
        // æ„å»ºæŸ¥è¯¢æ¡ä»¶
        LambdaQueryWrapper<SysUser> wrapper = Wrappers.lambdaQueryWrapper();
        if (StringUtils.isNotBlank(username)) {
            wrapper.like(SysUser::getUsername, username);
        }
        
        // åˆ†é¡µæŸ¥è¯¢
        Page<SysUser> page = new Page<>(pageNum, pageSize);
        Page<SysUser> result = userService.page(page, wrapper);
        
        return ApiResponse.success(PageResult.of(result));
    }
    
    /**
     * åˆ›å»ºç”¨æˆ·
     */
    @PostMapping
    @RequirePermission(value = "system:user:create", name = "åˆ›å»ºç”¨æˆ·")
    public ApiResponse<Void> createUser(@RequestBody @Valid CreateUserRequest request) {
        userService.createUser(request.toEntity(), request.getRoleIds());
        return ApiResponse.success();
    }
    
    /**
     * æ›´æ–°ç”¨æˆ·
     */
    @PutMapping("/{id}")
    @RequirePermission(value = "system:user:update", name = "æ›´æ–°ç”¨æˆ·")
    public ApiResponse<Void> updateUser(@PathVariable String id, 
                                       @RequestBody @Valid UpdateUserRequest request) {
        userService.updateUser(id, request);
        return ApiResponse.success();
    }
    
    /**
     * åˆ é™¤ç”¨æˆ·
     */
    @DeleteMapping("/{id}")
    @RequirePermission(value = "system:user:delete", name = "åˆ é™¤ç”¨æˆ·")
    public ApiResponse<Void> deleteUser(@PathVariable String id) {
        userService.deleteUser(id);
        return ApiResponse.success();
    }
    
    /**
     * åˆ†é…è§’è‰²
     */
    @PostMapping("/{id}/roles")
    @RequirePermission(value = "system:user:assign", name = "åˆ†é…ç”¨æˆ·è§’è‰²")
    public ApiResponse<Void> assignRoles(@PathVariable String id, 
                                        @RequestBody List<String> roleIds) {
        userService.assignRolesToUser(id, roleIds);
        return ApiResponse.success();
    }
}
```

---

## 8. ğŸ¢ ä¼ä¸šåå°ç®¡ç†ç³»ç»ŸRBACå®ç°ç¤ºä¾‹


### 8.1 ç³»ç»Ÿæ¶æ„è®¾è®¡


```
ä¼ä¸šåå°ç®¡ç†ç³»ç»ŸRBACæ¶æ„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯Vue   â”‚    â”‚  ç½‘å…³Gateway â”‚    â”‚   è®¤è¯ä¸­å¿ƒ   â”‚
â”‚    Admin    â”‚â”€â”€â†’ â”‚    Nginx    â”‚â”€â”€â†’ â”‚   Auth      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                   â”‚                 â”‚
       â–¼                   â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·ç®¡ç†   â”‚    â”‚   æƒé™ç®¡ç†   â”‚    â”‚   è§’è‰²ç®¡ç†   â”‚
â”‚ UserService â”‚    â”‚  PermServiceâ”‚    â”‚ RoleService â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                   â”‚                 â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  MySQLæ•°æ®åº“ â”‚
                  â”‚  + Redisç¼“å­˜ â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 å…¸å‹ä¼ä¸šè§’è‰²æƒé™è®¾è®¡


```java
/**
 * ä¼ä¸šå¸¸è§è§’è‰²æƒé™é…ç½®
 */
public class EnterpriseRoleConfig {
    
    public static final Map<String, List<String>> ROLE_PERMISSIONS = Map.of(
        
        // è¶…çº§ç®¡ç†å‘˜ï¼šæ‰€æœ‰æƒé™
        "SUPER_ADMIN", Arrays.asList(
            "system:*",  // ç³»ç»Ÿç®¡ç†æ‰€æœ‰æƒé™
            "user:*",    // ç”¨æˆ·ç®¡ç†æ‰€æœ‰æƒé™  
            "order:*",   // è®¢å•ç®¡ç†æ‰€æœ‰æƒé™
            "finance:*"  // è´¢åŠ¡ç®¡ç†æ‰€æœ‰æƒé™
        ),
        
        // ç³»ç»Ÿç®¡ç†å‘˜ï¼šç³»ç»Ÿç®¡ç†æƒé™
        "SYS_ADMIN", Arrays.asList(
            "system:user:read", "system:user:create", "system:user:update",
            "system:role:read", "system:role:create", "system:role:update",
            "system:log:read"
        ),
        
        // ä¸šåŠ¡ç®¡ç†å‘˜ï¼šä¸šåŠ¡æ•°æ®ç®¡ç†
        "BIZ_ADMIN", Arrays.asList(
            "order:read", "order:create", "order:update", "order:export",
            "customer:read", "customer:create", "customer:update"
        ),
        
        // è´¢åŠ¡äººå‘˜ï¼šè´¢åŠ¡ç›¸å…³æƒé™
        "FINANCE", Arrays.asList(
            "finance:read", "finance:export",
            "order:read",  // åªèƒ½æŸ¥çœ‹è®¢å•
            "customer:read"  // åªèƒ½æŸ¥çœ‹å®¢æˆ·
        ),
        
        // æ™®é€šå‘˜å·¥ï¼šåŸºç¡€æŸ¥çœ‹æƒé™
        "EMPLOYEE", Arrays.asList(
            "order:read",     // æŸ¥çœ‹è®¢å•ï¼ˆä»…è‡ªå·±çš„ï¼‰
            "customer:read",  // æŸ¥çœ‹å®¢æˆ·ï¼ˆä»…è‡ªå·±çš„ï¼‰
            "profile:update"  // ä¿®æ”¹ä¸ªäººä¿¡æ¯
        )
    );
}
```

### 8.3 èœå•æƒé™æ§åˆ¶


```java
@RestController
@RequestMapping("/api/system/menu")
public class MenuController {
    
    @Autowired
    private MenuService menuService;
    
    /**
     * è·å–ç”¨æˆ·èœå•æ ‘ï¼ˆæ ¹æ®æƒé™è¿‡æ»¤ï¼‰
     */
    @GetMapping("/tree")
    public ApiResponse<List<MenuTreeVO>> getUserMenuTree() {
        String userId = SecurityContextHolder.getCurrentUserId();
        
        // 1. è·å–ç”¨æˆ·æƒé™
        List<String> userPermissions = permissionService.getUserPermissions(userId);
        
        // 2. è·å–æ‰€æœ‰èœå•
        List<SysMenu> allMenus = menuService.getAllMenus();
        
        // 3. æ ¹æ®æƒé™è¿‡æ»¤èœå•
        List<SysMenu> accessibleMenus = allMenus.stream()
                .filter(menu -> hasMenuPermission(menu, userPermissions))
                .collect(Collectors.toList());
        
        // 4. æ„å»ºèœå•æ ‘
        List<MenuTreeVO> menuTree = menuService.buildMenuTree(accessibleMenus);
        
        return ApiResponse.success(menuTree);
    }
    
    private boolean hasMenuPermission(SysMenu menu, List<String> userPermissions) {
        // å…¬å…±èœå•ï¼Œæ— éœ€æƒé™
        if (StringUtils.isEmpty(menu.getPermissionCode())) {
            return true;
        }
        
        // æ£€æŸ¥æ˜¯å¦æœ‰èœå•æƒé™
        return userPermissions.contains(menu.getPermissionCode());
    }
}
```

### 8.4 æŒ‰é’®æƒé™æ§åˆ¶


```java
/**
 * æŒ‰é’®æƒé™VO
 */
@Data
public class ButtonPermissionVO {
    private String code;        // æƒé™ç 
    private String name;        // æƒé™åç§°
    private boolean visible;    // æ˜¯å¦å¯è§
    private boolean disabled;   // æ˜¯å¦ç¦ç”¨
}

@RestController
@RequestMapping("/api/system/permission")
public class PermissionController {
    
    /**
     * è·å–é¡µé¢æŒ‰é’®æƒé™
     */
    @GetMapping("/buttons")
    public ApiResponse<Map<String, ButtonPermissionVO>> getButtonPermissions(
            @RequestParam String pageCode) {
        
        String userId = SecurityContextHolder.getCurrentUserId();
        List<String> userPermissions = permissionService.getUserPermissions(userId);
        
        // è·å–é¡µé¢æ‰€æœ‰æŒ‰é’®æƒé™é…ç½®
        List<SysPermission> pageButtons = permissionService.getPageButtons(pageCode);
        
        Map<String, ButtonPermissionVO> buttonMap = new HashMap<>();
        
        pageButtons.forEach(button -> {
            boolean hasPermission = userPermissions.contains(button.getPermissionCode());
            
            ButtonPermissionVO buttonVO = new ButtonPermissionVO();
            buttonVO.setCode(button.getPermissionCode());
            buttonVO.setName(button.getPermissionName());
            buttonVO.setVisible(hasPermission);
            buttonVO.setDisabled(!hasPermission);
            
            buttonMap.put(button.getPermissionCode(), buttonVO);
        });
        
        return ApiResponse.success(buttonMap);
    }
}
```

### 8.5 æ•°æ®æƒé™åœ¨ä¼ä¸šç³»ç»Ÿä¸­çš„åº”ç”¨


```java
/**
 * ä¼ä¸šæ•°æ®æƒé™é…ç½®
 */
@Component
public class EnterpriseDataPermission {
    
    /**
     * è®¢å•æ•°æ®æƒé™è¿‡æ»¤
     */
    public String buildOrderDataFilter(String userId) {
        List<String> userRoles = getUserRoles(userId);
        String userDeptId = getUserDeptId(userId);
        
        StringBuilder filter = new StringBuilder();
        
        if (userRoles.contains("SUPER_ADMIN") || userRoles.contains("BIZ_ADMIN")) {
            // ç®¡ç†å‘˜ï¼šçœ‹æ‰€æœ‰è®¢å•
            filter.append("1=1");
            
        } else if (userRoles.contains("DEPT_MANAGER")) {
            // éƒ¨é—¨ç»ç†ï¼šçœ‹éƒ¨é—¨æ‰€æœ‰è®¢å•
            filter.append("dept_id = '").append(userDeptId).append("'");
            
        } else if (userRoles.contains("EMPLOYEE")) {
            // æ™®é€šå‘˜å·¥ï¼šåªçœ‹è‡ªå·±åˆ›å»ºçš„è®¢å•
            filter.append("create_user = '").append(userId).append("'");
            
        } else {
            // æ— æƒé™ï¼šçœ‹ä¸åˆ°ä»»ä½•æ•°æ®
            filter.append("1=0");
        }
        
        return filter.toString();
    }
    
    /**
     * å®¢æˆ·æ•°æ®æƒé™è¿‡æ»¤
     */
    public String buildCustomerDataFilter(String userId) {
        List<String> userRoles = getUserRoles(userId);
        
        if (userRoles.contains("SUPER_ADMIN")) {
            return "1=1";  // çœ‹æ‰€æœ‰å®¢æˆ·
        } else if (userRoles.contains("SALES_MANAGER")) {
            // é”€å”®ç»ç†ï¼šçœ‹åŒºåŸŸå†…å®¢æˆ·
            String regionId = getUserRegionId(userId);
            return "region_id = '" + regionId + "'";
        } else {
            // é”€å”®å‘˜ï¼šçœ‹è‡ªå·±è´Ÿè´£çš„å®¢æˆ·
            return "sales_user = '" + userId + "'";
        }
    }
}
```

### 8.6 å®Œæ•´çš„æƒé™æ£€æŸ¥æµç¨‹


```java
/**
 * ä¼ä¸šçº§æƒé™æ£€æŸ¥æœåŠ¡
 */
@Service
public class EnterprisePermissionService {
    
    /**
     * ç»¼åˆæƒé™æ£€æŸ¥ï¼ˆåŠŸèƒ½æƒé™ + æ•°æ®æƒé™ + ä¸šåŠ¡è§„åˆ™ï¼‰
     */
    public boolean checkFullPermission(String userId, String operation, Object resourceId) {
        
        // 1. åŠŸèƒ½æƒé™æ£€æŸ¥
        if (!hasFunctionPermission(userId, operation)) {
            log.warn("ç”¨æˆ·{}æ²¡æœ‰{}çš„åŠŸèƒ½æƒé™", userId, operation);
            return false;
        }
        
        // 2. æ•°æ®æƒé™æ£€æŸ¥
        if (resourceId != null && !hasDataPermission(userId, operation, resourceId)) {
            log.warn("ç”¨æˆ·{}æ²¡æœ‰èµ„æº{}çš„æ•°æ®æƒé™", userId, resourceId);
            return false;
        }
        
        // 3. ä¸šåŠ¡è§„åˆ™æ£€æŸ¥
        if (!checkBusinessRules(userId, operation, resourceId)) {
            log.warn("ç”¨æˆ·{}çš„æ“ä½œ{}ä¸ç¬¦åˆä¸šåŠ¡è§„åˆ™", userId, operation);
            return false;
        }
        
        // 4. æ—¶é—´å’ŒIPé™åˆ¶æ£€æŸ¥
        if (!checkTimeAndIpRestrictions(userId)) {
            log.warn("ç”¨æˆ·{}è®¿é—®æ—¶é—´æˆ–IPå—é™", userId);
            return false;
        }
        
        return true;
    }
    
    private boolean checkBusinessRules(String userId, String operation, Object resourceId) {
        // ä¾‹ï¼šè®¢å•åªèƒ½ç”±åˆ›å»ºäººæˆ–å…¶ä¸Šçº§ä¿®æ”¹
        if ("order:update".equals(operation) && resourceId != null) {
            Order order = orderService.getById((String) resourceId);
            return order.getCreateUser().equals(userId) 
                   || isUserSuperior(userId, order.getCreateUser());
        }
        return true;
    }
    
    private boolean checkTimeAndIpRestrictions(String userId) {
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨å…è®¸çš„æ—¶é—´æ®µè®¿é—®
        // æ£€æŸ¥ç”¨æˆ·IPæ˜¯å¦åœ¨ç™½åå•å†…
        return true;
    }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ RBACå®ç°æ€è·¯ï¼šç”¨æˆ·â†’è§’è‰²â†’æƒé™çš„ä¸‰çº§æ¨¡å‹
ğŸ”¸ Spring Securityï¼šè®¤è¯å’Œæˆæƒçš„æ¡†æ¶åŸºç¡€
ğŸ”¸ æƒé™æ‹¦æˆªå™¨ï¼šåœ¨è¯·æ±‚åˆ°è¾¾Controllerå‰è¿›è¡Œæƒé™æ£€æŸ¥
ğŸ”¸ å¼‚å¸¸å¤„ç†ï¼šç»Ÿä¸€å¤„ç†æƒé™å¼‚å¸¸ï¼Œè¿”å›è§„èŒƒçš„é”™è¯¯ä¿¡æ¯
ğŸ”¸ æƒé™ç¼“å­˜ï¼šä½¿ç”¨Redisæå‡æƒé™æ£€æŸ¥æ€§èƒ½
ğŸ”¸ æ•°æ®æƒé™ï¼šä¸ä»…æ§åˆ¶åŠŸèƒ½ï¼Œè¿˜è¦æ§åˆ¶æ•°æ®å¯è§æ€§
ğŸ”¸ ä¼ä¸šçº§åº”ç”¨ï¼šèœå•æƒé™ã€æŒ‰é’®æƒé™ã€ä¸šåŠ¡è§„åˆ™ç­‰ç»¼åˆæ§åˆ¶
```

### 9.2 å…³é”®å®ç°è¦ç‚¹


**ğŸ”¹ æƒé™æ£€æŸ¥çš„å±‚æ¬¡åŒ–è®¾è®¡**
```
ç¬¬ä¸€å±‚ï¼šè®¤è¯æ£€æŸ¥ - ç¡®è®¤ç”¨æˆ·èº«ä»½
ç¬¬äºŒå±‚ï¼šåŠŸèƒ½æƒé™ - èƒ½ä¸èƒ½ä½¿ç”¨åŠŸèƒ½
ç¬¬ä¸‰å±‚ï¼šæ•°æ®æƒé™ - èƒ½çœ‹åˆ°å“ªäº›æ•°æ®  
ç¬¬å››å±‚ï¼šä¸šåŠ¡è§„åˆ™ - ä¸šåŠ¡å±‚é¢çš„é™åˆ¶
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–çš„æ ¸å¿ƒç­–ç•¥**
```
ç¼“å­˜ç­–ç•¥ï¼šæƒé™ä¿¡æ¯ç¼“å­˜åˆ°Redisï¼Œé¿å…é¢‘ç¹æŸ¥æ•°æ®åº“
æ‰¹é‡æ“ä½œï¼šä¸€æ¬¡åŠ è½½ç”¨æˆ·çš„æ‰€æœ‰æƒé™ï¼Œé¿å…å¤šæ¬¡æŸ¥è¯¢
å¼‚æ­¥æ›´æ–°ï¼šæƒé™å˜æ›´æ—¶å¼‚æ­¥æ›´æ–°ç¼“å­˜
åˆç†è¿‡æœŸï¼šè®¾ç½®åˆé€‚çš„ç¼“å­˜è¿‡æœŸæ—¶é—´
```

**ğŸ”¹ ç³»ç»Ÿè®¾è®¡çš„å…³é”®åŸåˆ™**
```
èŒè´£åˆ†ç¦»ï¼šè®¤è¯ã€æˆæƒã€ä¸šåŠ¡é€»è¾‘åˆ†åˆ«å¤„ç†
ç»Ÿä¸€ç®¡ç†ï¼šå¼‚å¸¸å¤„ç†ã€å“åº”æ ¼å¼ã€æ—¥å¿—è®°å½•ç»Ÿä¸€
çµæ´»æ‰©å±•ï¼šæ”¯æŒæ³¨è§£ã€é…ç½®å¤šç§æƒé™å®šä¹‰æ–¹å¼
å®‰å…¨ä¼˜å…ˆï¼šé»˜è®¤æ‹’ç»ï¼Œæ˜ç¡®æˆæƒæ‰å…è®¸è®¿é—®
```

### 9.3 å®é™…åº”ç”¨ä»·å€¼


- **ğŸ¯ ä¸šåŠ¡ä»·å€¼**ï¼šç²¾ç¡®æ§åˆ¶ç³»ç»ŸåŠŸèƒ½å’Œæ•°æ®è®¿é—®ï¼Œä¿éšœä¸šåŠ¡å®‰å…¨
- **âš¡ æ€§èƒ½ä»·å€¼**ï¼šé€šè¿‡ç¼“å­˜æœºåˆ¶å¤§å¹…æå‡æƒé™æ£€æŸ¥æ•ˆç‡  
- **ğŸ”§ å¼€å‘ä»·å€¼**ï¼šç»Ÿä¸€çš„æƒé™æ¡†æ¶ï¼Œç®€åŒ–æƒé™åŠŸèƒ½å¼€å‘
- **ğŸ›¡ï¸ å®‰å…¨ä»·å€¼**ï¼šå¤šå±‚æ¬¡æƒé™é˜²æŠ¤ï¼Œé˜²æ­¢è¶Šæƒè®¿é—®
- **ğŸ“Š è¿ç»´ä»·å€¼**ï¼šå®Œå–„çš„æ—¥å¿—å’Œç›‘æ§ï¼Œä¾¿äºæƒé™é—®é¢˜æ’æŸ¥

### 9.4 å·¥ç¨‹å®è·µå»ºè®®


**å¼€å‘é˜¶æ®µï¼š**
- å…ˆè®¾è®¡æƒé™æ¨¡å‹ï¼Œå†ç¼–å†™ä¸šåŠ¡ä»£ç 
- ä½¿ç”¨æ³¨è§£æ–¹å¼å®šä¹‰æƒé™ï¼Œä»£ç æ›´æ¸…æ™°
- ç¼–å†™æƒé™ç›¸å…³çš„å•å…ƒæµ‹è¯•

**éƒ¨ç½²é˜¶æ®µï¼š**
- é…ç½®Redisé›†ç¾¤ä¿è¯ç¼“å­˜é«˜å¯ç”¨
- è®¾ç½®åˆç†çš„ç¼“å­˜è¿‡æœŸæ—¶é—´
- ç›‘æ§æƒé™æ£€æŸ¥çš„æ€§èƒ½æŒ‡æ ‡

**è¿ç»´é˜¶æ®µï¼š**
- å®šæœŸå¤‡ä»½æƒé™é…ç½®æ•°æ®
- ç›‘æ§å¼‚å¸¸æƒé™è®¿é—®å°è¯•
- å»ºç«‹æƒé™å˜æ›´çš„å®¡æ ¸æµç¨‹

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- RBACä¸‰è¦ç´ ï¼šç”¨æˆ·è§’è‰²å’Œæƒé™
- ç¼“å­˜ææ€§èƒ½ï¼Œæ‹¦æˆªä¿å®‰å…¨
- æ•°æ®æƒé™ç»†ï¼Œä¸šåŠ¡è§„åˆ™å…¨
- ç»Ÿä¸€å¤„ç†å¼‚å¸¸ï¼Œä¼ä¸šçº§åº”ç”¨