---
title: 7ã€RBACæƒé™æ ¡éªŒæœºåˆ¶
---
## ğŸ“š ç›®å½•

1. [ä»€ä¹ˆæ˜¯RBACæƒé™æ ¡éªŒ](#1-ä»€ä¹ˆæ˜¯RBACæƒé™æ ¡éªŒ)
2. [åç«¯æƒé™æ ¡éªŒæµç¨‹](#2-åç«¯æƒé™æ ¡éªŒæµç¨‹)
3. [Session/Tokenä¿å­˜è§’è‰²ä¸æƒé™](#3-Session/Tokenä¿å­˜è§’è‰²ä¸æƒé™)
4. [æ³¨è§£å¼æƒé™æ§åˆ¶](#4-æ³¨è§£å¼æƒé™æ§åˆ¶)
5. [æ‹¦æˆªå™¨/è¿‡æ»¤å™¨ç»Ÿä¸€æ ¡éªŒ](#5-æ‹¦æˆªå™¨/è¿‡æ»¤å™¨ç»Ÿä¸€æ ¡éªŒ)
6. [403æ— æƒé™å¤„ç†](#6-403æ— æƒé™å¤„ç†)
7. [ç™½åå•ä¸é»‘åå•æœºåˆ¶](#7-ç™½åå•ä¸é»‘åå•æœºåˆ¶)
8. [è¶…çº§ç®¡ç†å‘˜ä¸é»˜è®¤æƒé™](#8-è¶…çº§ç®¡ç†å‘˜ä¸é»˜è®¤æƒé™)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” ä»€ä¹ˆæ˜¯RBACæƒé™æ ¡éªŒ


### 1.1 æƒé™æ ¡éªŒçš„æœ¬è´¨

æƒé™æ ¡éªŒå°±åƒæ˜¯**é—¨å«æ£€æŸ¥è¯ä»¶**ä¸€æ ·ï¼Œç¡®ä¿åªæœ‰æœ‰æƒé™çš„äººæ‰èƒ½è¿›å…¥ç‰¹å®šåŒºåŸŸæˆ–æ‰§è¡Œç‰¹å®šæ“ä½œã€‚

```
ç°å®ç”Ÿæ´»æ¯”å–»ï¼š
å…¬å¸å¤§æ¥¼è¿›å…¥æµç¨‹
    ğŸ‘¤ç”¨æˆ· â†’ ğŸ¢å‰å° â†’ ğŸ“‹æ£€æŸ¥æƒé™ â†’ âœ…å…è®¸/âŒæ‹’ç»

ç³»ç»Ÿæƒé™æ ¡éªŒæµç¨‹
    ğŸŒè¯·æ±‚ â†’ ğŸ›¡ï¸æƒé™æ£€æŸ¥ â†’ ğŸ“ŠéªŒè¯è§’è‰² â†’ âœ…é€šè¿‡/âŒæ‹’ç»
```

### 1.2 RBACæƒé™æ ¡éªŒçš„æ ¸å¿ƒæ€æƒ³

**RBACæƒé™æ ¡éªŒ**ï¼šåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶æ ¡éªŒæœºåˆ¶
- ğŸ­ **è§’è‰²å†³å®šæƒé™**ï¼šç”¨æˆ·é€šè¿‡è§’è‰²è·å¾—æƒé™
- ğŸ” **åŠ¨æ€æ£€æŸ¥**ï¼šæ¯æ¬¡æ“ä½œéƒ½è¦æ£€æŸ¥æƒé™
- ğŸš« **ä¸¥æ ¼æ‹¦æˆª**ï¼šæ— æƒé™ç«‹å³æ‹’ç»

**ç®€å•ç†è§£**ï¼š
```
ä¼ ç»Ÿæ–¹å¼ï¼šç›´æ¥ç»™ç”¨æˆ·åˆ†é…æƒé™ï¼ˆç¹çï¼‰
ğŸ‘¤å¼ ä¸‰ â†â†’ ğŸ“æŸ¥çœ‹ç”¨æˆ·ã€ğŸ“åˆ é™¤ç”¨æˆ·ã€ğŸ“ä¿®æ”¹è®¢å•...

RBACæ–¹å¼ï¼šç»™ç”¨æˆ·åˆ†é…è§’è‰²ï¼Œè§’è‰²åŒ…å«æƒé™ï¼ˆç®€æ´ï¼‰
ğŸ‘¤å¼ ä¸‰ â†â†’ ğŸ­ç®¡ç†å‘˜è§’è‰² â†â†’ ğŸ“¦æƒé™åŒ…ï¼ˆåŒ…å«æ‰€æœ‰ç®¡ç†æƒé™ï¼‰
```

---

## 2. ğŸ”„ åç«¯æƒé™æ ¡éªŒæµç¨‹


### 2.1 å®Œæ•´çš„æƒé™æ ¡éªŒæµç¨‹

```
ç”¨æˆ·å‘èµ·è¯·æ±‚çš„å®Œæ•´æµç¨‹ï¼š

å®¢æˆ·ç«¯                     æœåŠ¡å™¨ç«¯                    æ•°æ®åº“
   |                          |                         |
   |--[1]å‘é€è¯·æ±‚------------->|                         |
   |  (å¸¦Token/Session)       |                         |
   |                          |--[2]è§£æèº«ä»½ä¿¡æ¯-------->|
   |                          |<-[3]è¿”å›ç”¨æˆ·è§’è‰²--------|
   |                          |                         |
   |                          |--[4]æ£€æŸ¥æƒé™----------->|
   |                          |<-[5]è¿”å›æƒé™åˆ—è¡¨--------|
   |                          |                         |
   |                          |ğŸ›¡ï¸[6]æƒé™æ ¡éªŒåˆ¤æ–­         |
   |                          |                         |
   |<--[7]è¿”å›ç»“æœ-------------|                         |
   |  (æˆåŠŸ/403æ— æƒé™)         |                         |
```

### 2.2 æƒé™æ ¡éªŒçš„ä¸‰ä¸ªå…³é”®æ­¥éª¤


**Step 1ï¸âƒ£ èº«ä»½è¯†åˆ«**
```java
// ä»è¯·æ±‚ä¸­è·å–ç”¨æˆ·èº«ä»½
String token = request.getHeader("Authorization");
Long userId = JwtUtil.getUserId(token);
```

**Step 2ï¸âƒ£ æƒé™æŸ¥è¯¢**
```java
// æ ¹æ®ç”¨æˆ·IDæŸ¥è¯¢è§’è‰²å’Œæƒé™
User user = userService.getUserById(userId);
List<String> permissions = permissionService.getUserPermissions(userId);
```

**Step 3ï¸âƒ£ æƒé™åˆ¤æ–­**
```java
// åˆ¤æ–­å½“å‰æ“ä½œæ˜¯å¦è¢«å…è®¸
String requiredPermission = "user:delete";
boolean hasPermission = permissions.contains(requiredPermission);
```

### 2.3 æ ¡éªŒæµç¨‹çš„å®é™…åº”ç”¨

```java
/**
 * æƒé™æ ¡éªŒæœåŠ¡
 */
@Service
public class PermissionCheckService {
    
    /**
     * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æŒ‡å®šæƒé™
     */
    public boolean checkPermission(Long userId, String permission) {
        // 1. è·å–ç”¨æˆ·è§’è‰²
        List<String> roles = getUserRoles(userId);
        
        // 2. è·å–è§’è‰²å¯¹åº”çš„æƒé™
        List<String> permissions = getRolePermissions(roles);
        
        // 3. æ£€æŸ¥æ˜¯å¦åŒ…å«æ‰€éœ€æƒé™
        return permissions.contains(permission);
    }
}
```

---

## 3. ğŸ’¾ Session/Tokenä¿å­˜è§’è‰²ä¸æƒé™


### 3.1 Sessionæ–¹å¼ä¿å­˜æƒé™ä¿¡æ¯


**ä»€ä¹ˆæ˜¯Sessionä¿å­˜æƒé™**ï¼š
å°±åƒåœ¨**ä¼šå‘˜å¡é‡Œå­˜å‚¨ä¼šå‘˜ç­‰çº§**ä¸€æ ·ï¼Œç”¨æˆ·ç™»å½•åï¼ŒæŠŠè§’è‰²å’Œæƒé™ä¿¡æ¯å­˜åœ¨æœåŠ¡å™¨çš„Sessionä¸­ã€‚

```java
/**
 * Sessionä¸­ä¿å­˜ç”¨æˆ·æƒé™ä¿¡æ¯
 */
@Service
public class SessionPermissionService {
    
    /**
     * ç”¨æˆ·ç™»å½•æ—¶ä¿å­˜æƒé™åˆ°Session
     */
    public void savePermissionsToSession(HttpSession session, Long userId) {
        // æŸ¥è¯¢ç”¨æˆ·è§’è‰²
        List<String> roles = userService.getUserRoles(userId);
        
        // æŸ¥è¯¢è§’è‰²å¯¹åº”æƒé™
        List<String> permissions = permissionService.getPermissionsByRoles(roles);
        
        // ä¿å­˜åˆ°Session
        session.setAttribute("USER_ROLES", roles);
        session.setAttribute("USER_PERMISSIONS", permissions);
    }
    
    /**
     * ä»Sessionè·å–ç”¨æˆ·æƒé™
     */
    @SuppressWarnings("unchecked")
    public List<String> getPermissionsFromSession(HttpSession session) {
        return (List<String>) session.getAttribute("USER_PERMISSIONS");
    }
}
```

**Sessionæ–¹å¼çš„ç‰¹ç‚¹**ï¼š
- âœ… **ç®€å•ç›´æ¥**ï¼šæ•°æ®å­˜åœ¨æœåŠ¡å™¨å†…å­˜ä¸­
- âœ… **å®‰å…¨æ€§é«˜**ï¼šç”¨æˆ·æ— æ³•ç›´æ¥ä¿®æ”¹
- âŒ **ä¸é€‚åˆåˆ†å¸ƒå¼**ï¼šå¤šå°æœåŠ¡å™¨æ— æ³•å…±äº«
- âŒ **å ç”¨å†…å­˜**ï¼šå¤§é‡ç”¨æˆ·æ—¶æ¶ˆè€—æœåŠ¡å™¨å†…å­˜

### 3.2 Tokenæ–¹å¼ä¿å­˜æƒé™ä¿¡æ¯


**ä»€ä¹ˆæ˜¯Tokenä¿å­˜æƒé™**ï¼š
å°±åƒ**èº«ä»½è¯ä¸Šå°ç€ä¸ªäººä¿¡æ¯**ä¸€æ ·ï¼ŒæŠŠè§’è‰²å’Œæƒé™ä¿¡æ¯ç›´æ¥ç¼–ç åœ¨Tokenä¸­ã€‚

```java
/**
 * JWT Tokenä¸­ä¿å­˜ç”¨æˆ·æƒé™ä¿¡æ¯
 */
@Service
public class JwtPermissionService {
    
    /**
     * ç”ŸæˆåŒ…å«æƒé™ä¿¡æ¯çš„JWT Token
     */
    public String generateTokenWithPermissions(Long userId) {
        // æŸ¥è¯¢ç”¨æˆ·è§’è‰²å’Œæƒé™
        List<String> roles = userService.getUserRoles(userId);
        List<String> permissions = permissionService.getUserPermissions(userId);
        
        // æ„å»ºJWT Claims
        Map<String, Object> claims = new HashMap<>();
        claims.put("userId", userId);
        claims.put("roles", roles);
        claims.put("permissions", permissions);
        
        // ç”ŸæˆToken
        return JwtUtil.generateToken(claims);
    }
    
    /**
     * ä»Tokenè§£ææƒé™ä¿¡æ¯
     */
    public List<String> getPermissionsFromToken(String token) {
        Claims claims = JwtUtil.parseToken(token);
        return (List<String>) claims.get("permissions");
    }
}
```

**Tokenæ–¹å¼çš„ç‰¹ç‚¹**ï¼š
- âœ… **æ— çŠ¶æ€**ï¼šæœåŠ¡å™¨ä¸éœ€è¦å­˜å‚¨ä¿¡æ¯
- âœ… **åˆ†å¸ƒå¼å‹å¥½**ï¼šä»»ä½•æœåŠ¡å™¨éƒ½èƒ½éªŒè¯
- âœ… **å‡å°‘æ•°æ®åº“æŸ¥è¯¢**ï¼šæƒé™ä¿¡æ¯åœ¨Tokenä¸­
- âŒ **Tokenè¾ƒå¤§**ï¼šåŒ…å«æƒé™ä¿¡æ¯åä½“ç§¯å¢åŠ 
- âŒ **æƒé™æ›´æ–°å»¶è¿Ÿ**ï¼šéœ€ç­‰Tokenè¿‡æœŸæ‰èƒ½æ›´æ–°

### 3.3 Session vs Token å¯¹æ¯”


| ç‰¹æ€§ | **Sessionæ–¹å¼** | **Tokenæ–¹å¼** |
|------|---------------|--------------|
| ğŸ—„ï¸ **å­˜å‚¨ä½ç½®** | `æœåŠ¡å™¨å†…å­˜/Redis` | `å®¢æˆ·ç«¯(Tokenä¸­)` |
| ğŸ”„ **çŠ¶æ€ç®¡ç†** | `æœ‰çŠ¶æ€` | `æ— çŠ¶æ€` |
| ğŸŒ **åˆ†å¸ƒå¼æ”¯æŒ** | `éœ€è¦å…±äº«å­˜å‚¨` | `å¤©ç„¶æ”¯æŒ` |
| ğŸ’¾ **æœåŠ¡å™¨å†…å­˜** | `å ç”¨è¾ƒå¤š` | `å‡ ä¹ä¸å ç”¨` |
| âš¡ **æ€§èƒ½** | `éœ€è¦æŸ¥è¯¢Session` | `ç›´æ¥è§£æToken` |
| ğŸ”„ **æƒé™æ›´æ–°** | `ç«‹å³ç”Ÿæ•ˆ` | `éœ€ç­‰Tokenè¿‡æœŸ` |

---

## 4. ğŸ“ æ³¨è§£å¼æƒé™æ§åˆ¶


### 4.1 ä»€ä¹ˆæ˜¯æ³¨è§£å¼æƒé™æ§åˆ¶


**æ³¨è§£å¼æƒé™æ§åˆ¶**å°±åƒåœ¨**æ–¹æ³•ä¸Šè´´æ ‡ç­¾**ä¸€æ ·ï¼Œç›´æ¥åœ¨éœ€è¦æƒé™æ§åˆ¶çš„æ–¹æ³•ä¸ŠåŠ ä¸ªæ³¨è§£ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æŸ¥æƒé™ã€‚

```java
// ä¼ ç»Ÿæ–¹å¼ï¼šåœ¨æ–¹æ³•å†…æ‰‹åŠ¨æ£€æŸ¥æƒé™
@GetMapping("/users")
public List<User> getUsers() {
    // æ‰‹åŠ¨æ£€æŸ¥æƒé™ï¼ˆç¹çï¼‰
    if (!hasPermission("user:view")) {
        throw new AccessDeniedException("æ— æƒé™");
    }
    return userService.getAllUsers();
}

// æ³¨è§£æ–¹å¼ï¼šè‡ªåŠ¨æ£€æŸ¥æƒé™
@GetMapping("/users")
@PreAuthorize("hasPermission('user:view')")  // ğŸ‘ˆ ä¸€ä¸ªæ³¨è§£æå®š
public List<User> getUsers() {
    return userService.getAllUsers();  // åªä¸“æ³¨ä¸šåŠ¡é€»è¾‘
}
```

### 4.2 @PreAuthorize æ³¨è§£è¯¦è§£


**@PreAuthorize**ï¼šæ–¹æ³•æ‰§è¡Œ**ä¹‹å‰**æ£€æŸ¥æƒé™

```java
/**
 * ç”¨æˆ·ç®¡ç†æ§åˆ¶å™¨
 */
@RestController
@RequestMapping("/api/users")
public class UserController {
    
    // æ£€æŸ¥æ˜¯å¦æœ‰æŸ¥çœ‹ç”¨æˆ·çš„æƒé™
    @GetMapping
    @PreAuthorize("hasPermission('user:view')")
    public List<User> getAllUsers() {
        return userService.getAllUsers();
    }
    
    // æ£€æŸ¥æ˜¯å¦æœ‰åˆ é™¤ç”¨æˆ·çš„æƒé™
    @DeleteMapping("/{id}")
    @PreAuthorize("hasPermission('user:delete')")
    public void deleteUser(@PathVariable Long id) {
        userService.deleteUser(id);
    }
    
    // æ£€æŸ¥æ˜¯å¦æœ‰ç®¡ç†å‘˜è§’è‰²
    @PostMapping
    @PreAuthorize("hasRole('ADMIN')")
    public User createUser(@RequestBody User user) {
        return userService.createUser(user);
    }
    
    // å¤æ‚æƒé™è¡¨è¾¾å¼ï¼šç®¡ç†å‘˜æˆ–è€…æ˜¯ç”¨æˆ·æœ¬äºº
    @GetMapping("/{id}")
    @PreAuthorize("hasRole('ADMIN') or authentication.principal.id == #id")
    public User getUser(@PathVariable Long id) {
        return userService.getUser(id);
    }
}
```

### 4.3 @RolesAllowed æ³¨è§£è¯¦è§£


**@RolesAllowed**ï¼šåŸºäºè§’è‰²çš„æƒé™æ§åˆ¶

```java
/**
 * è®¢å•ç®¡ç†æ§åˆ¶å™¨
 */
@RestController
@RequestMapping("/api/orders")
public class OrderController {
    
    // åªæœ‰ç®¡ç†å‘˜å’Œé”€å”®å¯ä»¥æŸ¥çœ‹æ‰€æœ‰è®¢å•
    @GetMapping
    @RolesAllowed({"ADMIN", "SALES"})
    public List<Order> getAllOrders() {
        return orderService.getAllOrders();
    }
    
    // åªæœ‰ç®¡ç†å‘˜å¯ä»¥åˆ é™¤è®¢å•
    @DeleteMapping("/{id}")
    @RolesAllowed("ADMIN")
    public void deleteOrder(@PathVariable Long id) {
        orderService.deleteOrder(id);
    }
}
```

### 4.4 å¸¸ç”¨æƒé™è¡¨è¾¾å¼


```java
// åŸºæœ¬æƒé™æ£€æŸ¥
@PreAuthorize("hasPermission('resource:action')")

// è§’è‰²æ£€æŸ¥
@PreAuthorize("hasRole('ADMIN')")
@PreAuthorize("hasAnyRole('ADMIN', 'USER')")

// å¤åˆæ¡ä»¶
@PreAuthorize("hasRole('ADMIN') and hasPermission('user:delete')")
@PreAuthorize("hasRole('ADMIN') or authentication.principal.id == #userId")

// è‡ªå®šä¹‰æƒé™æ£€æŸ¥
@PreAuthorize("@customPermissionEvaluator.canAccess(authentication, #resourceId)")
```

---

## 5. ğŸ›¡ï¸ æ‹¦æˆªå™¨/è¿‡æ»¤å™¨ç»Ÿä¸€æ ¡éªŒ


### 5.1 ä¸ºä»€ä¹ˆéœ€è¦ç»Ÿä¸€æ ¡éªŒ


æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœæ¯ä¸ªæˆ¿é—´éƒ½è¦**å•ç‹¬é…ä¸ªé—¨å«**ï¼Œæˆæœ¬å¾ˆé«˜ã€‚æ›´å¥½çš„æ–¹å¼æ˜¯åœ¨**å¤§æ¥¼å…¥å£è®¾ç½®ç»Ÿä¸€å®‰æ£€**ã€‚

```
åˆ†æ•£æ ¡éªŒï¼ˆä¸æ¨èï¼‰ï¼š
Controller1 â†’ ğŸ”æƒé™æ£€æŸ¥ â†’ ä¸šåŠ¡é€»è¾‘
Controller2 â†’ ğŸ”æƒé™æ£€æŸ¥ â†’ ä¸šåŠ¡é€»è¾‘  
Controller3 â†’ ğŸ”æƒé™æ£€æŸ¥ â†’ ä¸šåŠ¡é€»è¾‘  (é‡å¤ä»£ç )

ç»Ÿä¸€æ ¡éªŒï¼ˆæ¨èï¼‰ï¼š
ğŸŒè¯·æ±‚ â†’ ğŸ›¡ï¸ç»Ÿä¸€æ‹¦æˆªå™¨ â†’ ğŸ”æƒé™æ£€æŸ¥ â†’ Controller â†’ ä¸šåŠ¡é€»è¾‘
```

### 5.2 è¿‡æ»¤å™¨å®ç°ç»Ÿä¸€æƒé™æ ¡éªŒ


```java
/**
 * æƒé™æ ¡éªŒè¿‡æ»¤å™¨
 * åœ¨æ‰€æœ‰è¯·æ±‚æ‰§è¡Œå‰ç»Ÿä¸€æ£€æŸ¥æƒé™
 */
@Component
public class PermissionFilter implements Filter {
    
    @Autowired
    private PermissionService permissionService;
    
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, 
                        FilterChain chain) throws IOException, ServletException {
        
        HttpServletRequest httpRequest = (HttpServletRequest) request;
        HttpServletResponse httpResponse = (HttpServletResponse) response;
        
        // 1. è·å–è¯·æ±‚è·¯å¾„
        String requestPath = httpRequest.getRequestURI();
        
        // 2. æ£€æŸ¥æ˜¯å¦åœ¨ç™½åå•ä¸­ï¼ˆç™»å½•ã€æ³¨å†Œç­‰ä¸éœ€è¦æƒé™ï¼‰
        if (isWhitelist(requestPath)) {
            chain.doFilter(request, response);
            return;
        }
        
        // 3. è·å–ç”¨æˆ·Token
        String token = httpRequest.getHeader("Authorization");
        if (token == null || token.isEmpty()) {
            sendUnauthorizedResponse(httpResponse, "æœªç™»å½•");
            return;
        }
        
        // 4. è§£æç”¨æˆ·èº«ä»½
        Long userId = JwtUtil.getUserId(token);
        if (userId == null) {
            sendUnauthorizedResponse(httpResponse, "Tokenæ— æ•ˆ");
            return;
        }
        
        // 5. æ£€æŸ¥æƒé™
        if (!hasPermission(userId, requestPath)) {
            sendForbiddenResponse(httpResponse, "æ— æƒé™è®¿é—®");
            return;
        }
        
        // 6. æƒé™æ£€æŸ¥é€šè¿‡ï¼Œç»§ç»­æ‰§è¡Œ
        chain.doFilter(request, response);
    }
    
    /**
     * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®æŒ‡å®šè·¯å¾„
     */
    private boolean hasPermission(Long userId, String requestPath) {
        // æ ¹æ®è·¯å¾„è·å–éœ€è¦çš„æƒé™
        String requiredPermission = getRequiredPermission(requestPath);
        if (requiredPermission == null) {
            return true; // ä¸éœ€è¦ç‰¹æ®Šæƒé™
        }
        
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰è¯¥æƒé™
        return permissionService.hasPermission(userId, requiredPermission);
    }
    
    /**
     * æ ¹æ®è¯·æ±‚è·¯å¾„ç¡®å®šéœ€è¦çš„æƒé™
     */
    private String getRequiredPermission(String requestPath) {
        if (requestPath.startsWith("/api/users")) {
            if (requestPath.contains("DELETE")) return "user:delete";
            if (requestPath.contains("POST")) return "user:create";
            return "user:view";
        }
        // å…¶ä»–è·¯å¾„çš„æƒé™æ˜ å°„...
        return null;
    }
}
```

### 5.3 æ‹¦æˆªå™¨å®ç°ç»Ÿä¸€æƒé™æ ¡éªŒ


```java
/**
 * æƒé™æ ¡éªŒæ‹¦æˆªå™¨
 * æ¯”è¿‡æ»¤å™¨æ›´è½»é‡ï¼Œä¸“æ³¨äºæƒé™æ§åˆ¶
 */
@Component
public class PermissionInterceptor implements HandlerInterceptor {
    
    @Autowired
    private PermissionService permissionService;
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler) throws Exception {
        
        // 1. å¦‚æœä¸æ˜¯Controlleræ–¹æ³•ï¼Œç›´æ¥é€šè¿‡
        if (!(handler instanceof HandlerMethod)) {
            return true;
        }
        
        HandlerMethod handlerMethod = (HandlerMethod) handler;
        
        // 2. æ£€æŸ¥æ–¹æ³•æ˜¯å¦æœ‰æƒé™æ³¨è§£
        PreAuthorize preAuthorize = handlerMethod.getMethodAnnotation(PreAuthorize.class);
        RolesAllowed rolesAllowed = handlerMethod.getMethodAnnotation(RolesAllowed.class);
        
        // 3. å¦‚æœæ²¡æœ‰æƒé™æ³¨è§£ï¼Œç›´æ¥é€šè¿‡
        if (preAuthorize == null && rolesAllowed == null) {
            return true;
        }
        
        // 4. è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
        Long userId = getCurrentUserId(request);
        if (userId == null) {
            response.setStatus(HttpStatus.UNAUTHORIZED.value());
            response.getWriter().write("{\"message\":\"æœªç™»å½•\"}");
            return false;
        }
        
        // 5. æƒé™æ ¡éªŒ
        if (!checkPermission(userId, preAuthorize, rolesAllowed)) {
            response.setStatus(HttpStatus.FORBIDDEN.value());
            response.getWriter().write("{\"message\":\"æ— æƒé™\"}");
            return false;
        }
        
        return true;
    }
    
    /**
     * æ£€æŸ¥æƒé™
     */
    private boolean checkPermission(Long userId, PreAuthorize preAuthorize, RolesAllowed rolesAllowed) {
        if (rolesAllowed != null) {
            // æ£€æŸ¥è§’è‰²æƒé™
            return permissionService.hasAnyRole(userId, rolesAllowed.value());
        }
        
        if (preAuthorize != null) {
            // è§£æå¹¶æ£€æŸ¥æƒé™è¡¨è¾¾å¼
            return permissionService.evaluateExpression(userId, preAuthorize.value());
        }
        
        return false;
    }
}
```

### 5.4 è¿‡æ»¤å™¨ vs æ‹¦æˆªå™¨ é€‰æ‹©


| ç‰¹æ€§ | **è¿‡æ»¤å™¨(Filter)** | **æ‹¦æˆªå™¨(Interceptor)** |
|------|-------------------|----------------------|
| ğŸ”§ **æ‰§è¡Œæ—¶æœº** | `Servletå®¹å™¨çº§åˆ«` | `Spring MVCçº§åˆ«` |
| ğŸ¯ **ä½œç”¨èŒƒå›´** | `æ‰€æœ‰è¯·æ±‚` | `Controlleræ–¹æ³•` |
| ğŸ“ **é…ç½®æ–¹å¼** | `web.xmlæˆ–@Component` | `WebMvcConfigurer` |
| âš¡ **æ€§èƒ½** | `ç¨é‡` | `æ›´è½»é‡` |
| ğŸ” **æƒé™æ£€æŸ¥** | `é€‚åˆç²—ç²’åº¦æ§åˆ¶` | `é€‚åˆç»†ç²’åº¦æ§åˆ¶` |

**æ¨èä½¿ç”¨åœºæ™¯**ï¼š
- ğŸŒ **ç²—ç²’åº¦æƒé™æ§åˆ¶**ï¼šä½¿ç”¨è¿‡æ»¤å™¨
- ğŸ¯ **ç»†ç²’åº¦æƒé™æ§åˆ¶**ï¼šä½¿ç”¨æ‹¦æˆªå™¨
- ğŸ“± **RESTful API**ï¼šä¸¤è€…ç»“åˆä½¿ç”¨

---

## 6. ğŸš« 403æ— æƒé™å¤„ç†


### 6.1 ä»€ä¹ˆæ˜¯403æ— æƒé™


**HTTP 403 Forbidden**ï¼šæœåŠ¡å™¨ç†è§£è¯·æ±‚ï¼Œä½†æ‹’ç»æ‰§è¡Œã€‚ç®€å•è¯´å°±æ˜¯**"æˆ‘çŸ¥é“ä½ è¦åšä»€ä¹ˆï¼Œä½†ä½ æ²¡æƒé™"**ã€‚

```
ç”Ÿæ´»ä¸­çš„ä¾‹å­ï¼š
ğŸ‘¤ç”¨æˆ·ï¼š"æˆ‘è¦è¿›VIPåŒ…å¢"
ğŸ›¡ï¸ä¿å®‰ï¼š"æˆ‘çŸ¥é“ä½ è¦å»å“ªï¼Œä½†ä½ ä¸æ˜¯VIPä¼šå‘˜ï¼Œä¸èƒ½è¿›"
ğŸ“‹ç»“æœï¼š403 ç¦æ­¢è®¿é—®

ç³»ç»Ÿä¸­çš„ä¾‹å­ï¼š
ğŸŒè¯·æ±‚ï¼š"DELETE /api/users/123"
ğŸ›¡ï¸ç³»ç»Ÿï¼š"æˆ‘çŸ¥é“ä½ è¦åˆ é™¤ç”¨æˆ·ï¼Œä½†ä½ æ²¡æœ‰åˆ é™¤æƒé™"
ğŸ“‹ç»“æœï¼š403 Forbidden
```

### 6.2 ç»Ÿä¸€çš„403é”™è¯¯å¤„ç†


```java
/**
 * å…¨å±€å¼‚å¸¸å¤„ç†å™¨
 * ç»Ÿä¸€å¤„ç†æƒé™å¼‚å¸¸
 */
@RestControllerAdvice
public class GlobalExceptionHandler {
    
    /**
     * å¤„ç†æƒé™ä¸è¶³å¼‚å¸¸
     */
    @ExceptionHandler(AccessDeniedException.class)
    public ResponseEntity<ErrorResponse> handleAccessDenied(AccessDeniedException e) {
        ErrorResponse error = ErrorResponse.builder()
            .code(403)
            .message("æƒé™ä¸è¶³ï¼š" + e.getMessage())
            .timestamp(LocalDateTime.now())
            .build();
            
        return ResponseEntity.status(HttpStatus.FORBIDDEN).body(error);
    }
    
    /**
     * å¤„ç†è®¤è¯å¼‚å¸¸ï¼ˆæœªç™»å½•ï¼‰
     */
    @ExceptionHandler(AuthenticationException.class)
    public ResponseEntity<ErrorResponse> handleAuthenticationException(AuthenticationException e) {
        ErrorResponse error = ErrorResponse.builder()
            .code(401)
            .message("è¯·å…ˆç™»å½•")
            .timestamp(LocalDateTime.now())
            .build();
            
        return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(error);
    }
}

/**
 * é”™è¯¯å“åº”å®ä½“
 */
@Data
@Builder
public class ErrorResponse {
    private Integer code;
    private String message;
    private LocalDateTime timestamp;
    private String path;
    private Object data;
}
```

### 6.3 å‹å¥½çš„é”™è¯¯æç¤º


```java
/**
 * æƒé™å¼‚å¸¸å¤„ç†æœåŠ¡
 * æä¾›æ›´å‹å¥½çš„é”™è¯¯ä¿¡æ¯
 */
@Service
public class PermissionExceptionService {
    
    /**
     * æ ¹æ®æƒé™ç±»å‹è¿”å›å‹å¥½çš„é”™è¯¯ä¿¡æ¯
     */
    public String getFriendlyMessage(String permission) {
        Map<String, String> messageMap = Map.of(
            "user:view", "æ‚¨æ²¡æœ‰æŸ¥çœ‹ç”¨æˆ·çš„æƒé™ï¼Œè¯·è”ç³»ç®¡ç†å‘˜",
            "user:create", "æ‚¨æ²¡æœ‰åˆ›å»ºç”¨æˆ·çš„æƒé™",
            "user:update", "æ‚¨æ²¡æœ‰ä¿®æ”¹ç”¨æˆ·çš„æƒé™", 
            "user:delete", "æ‚¨æ²¡æœ‰åˆ é™¤ç”¨æˆ·çš„æƒé™ï¼Œæ­¤æ“ä½œéœ€è¦é«˜çº§æƒé™",
            "order:view", "æ‚¨æ²¡æœ‰æŸ¥çœ‹è®¢å•çš„æƒé™",
            "system:config", "æ‚¨æ²¡æœ‰ç³»ç»Ÿé…ç½®æƒé™ï¼Œæ­¤åŠŸèƒ½ä»…é™è¶…çº§ç®¡ç†å‘˜"
        );
        
        return messageMap.getOrDefault(permission, "æƒé™ä¸è¶³ï¼Œæ— æ³•æ‰§è¡Œæ­¤æ“ä½œ");
    }
    
    /**
     * è®°å½•æƒé™å¼‚å¸¸æ—¥å¿—
     */
    public void logPermissionDenied(Long userId, String permission, String resource) {
        log.warn("ç”¨æˆ·æƒé™ä¸è¶³ - ç”¨æˆ·ID: {}, å°è¯•æƒé™: {}, è®¿é—®èµ„æº: {}", 
                userId, permission, resource);
        
        // å¯ä»¥è€ƒè™‘å‘é€å‘Šè­¦æˆ–ç»Ÿè®¡å¼‚å¸¸è®¿é—®
        alertService.sendSecurityAlert("æ£€æµ‹åˆ°æƒé™å¼‚å¸¸è®¿é—®", userId, permission);
    }
}
```

### 6.4 å‰ç«¯403å¤„ç†


```javascript
// axioså“åº”æ‹¦æˆªå™¨å¤„ç†403
axios.interceptors.response.use(
    response => response,
    error => {
        if (error.response?.status === 403) {
            // æ˜¾ç¤ºå‹å¥½çš„æƒé™ä¸è¶³æç¤º
            ElMessage.error(error.response.data.message || 'æƒé™ä¸è¶³');
            
            // å¯é€‰ï¼šè·³è½¬åˆ°æƒé™è¯´æ˜é¡µé¢
            router.push('/no-permission');
        }
        return Promise.reject(error);
    }
);
```

---

## 7. ğŸ“‹ ç™½åå•ä¸é»‘åå•æœºåˆ¶


### 7.1 ç™½åå•ä¸é»‘åå•çš„æ¦‚å¿µ


**ç™½åå•**ï¼š**å…è®¸é€šè¡Œçš„åå•**ï¼ŒåƒVIPé€šé“ï¼Œåå•ä¸Šçš„ç›´æ¥æ”¾è¡Œ
**é»‘åå•**ï¼š**ç¦æ­¢é€šè¡Œçš„åå•**ï¼Œåƒé»‘åå•ç”¨æˆ·ï¼Œç›´æ¥æ‹’ç»

```
ç™½åå•æœºåˆ¶ï¼ˆé»˜è®¤æ‹’ç»ï¼Œåå•å†…å…è®¸ï¼‰ï¼š
ğŸšªå…¥å£ â†’ ğŸ“‹æ£€æŸ¥ç™½åå• â†’ âœ…åœ¨åå•å†…â†’æ”¾è¡Œ / âŒä¸åœ¨åå•â†’æ‹’ç»

é»‘åå•æœºåˆ¶ï¼ˆé»˜è®¤å…è®¸ï¼Œåå•å†…æ‹’ç»ï¼‰ï¼š
ğŸšªå…¥å£ â†’ ğŸ“‹æ£€æŸ¥é»‘åå• â†’ âŒåœ¨é»‘åå•â†’æ‹’ç» / âœ…ä¸åœ¨é»‘åå•â†’æ”¾è¡Œ
```

### 7.2 ç™½åå•æœºåˆ¶å®ç°


```java
/**
 * ç™½åå•é…ç½®
 */
@Component
@ConfigurationProperties(prefix = "security.whitelist")
@Data
public class WhitelistConfig {
    
    /**
     * ä¸éœ€è¦ç™»å½•çš„è·¯å¾„
     */
    private List<String> noAuth = Arrays.asList(
        "/api/auth/login",      // ç™»å½•æ¥å£
        "/api/auth/register",   // æ³¨å†Œæ¥å£
        "/api/captcha",         // éªŒè¯ç 
        "/api/public/**",       // å…¬å¼€API
        "/health/**",           // å¥åº·æ£€æŸ¥
        "/actuator/**"          // ç›‘æ§ç«¯ç‚¹
    );
    
    /**
     * ä¸éœ€è¦æƒé™æ£€æŸ¥çš„è·¯å¾„ï¼ˆå·²ç™»å½•å³å¯è®¿é—®ï¼‰
     */
    private List<String> noPermission = Arrays.asList(
        "/api/user/profile",    // ä¸ªäººä¿¡æ¯
        "/api/user/password",   // ä¿®æ”¹å¯†ç 
        "/api/common/**"        // é€šç”¨æ¥å£
    );
}

/**
 * ç™½åå•æ£€æŸ¥æœåŠ¡
 */
@Service
public class WhitelistService {
    
    @Autowired
    private WhitelistConfig whitelistConfig;
    
    /**
     * æ£€æŸ¥è·¯å¾„æ˜¯å¦åœ¨å…ç™»å½•ç™½åå•ä¸­
     */
    public boolean isNoAuthPath(String path) {
        return whitelistConfig.getNoAuth().stream()
            .anyMatch(pattern -> pathMatches(path, pattern));
    }
    
    /**
     * æ£€æŸ¥è·¯å¾„æ˜¯å¦åœ¨å…æƒé™ç™½åå•ä¸­
     */
    public boolean isNoPermissionPath(String path) {
        return whitelistConfig.getNoPermission().stream()
            .anyMatch(pattern -> pathMatches(path, pattern));
    }
    
    /**
     * è·¯å¾„åŒ¹é…ï¼ˆæ”¯æŒé€šé…ç¬¦ï¼‰
     */
    private boolean pathMatches(String path, String pattern) {
        // ç®€å•é€šé…ç¬¦åŒ¹é…
        if (pattern.endsWith("/**")) {
            String prefix = pattern.substring(0, pattern.length() - 3);
            return path.startsWith(prefix);
        }
        return path.equals(pattern);
    }
}
```

### 7.3 é»‘åå•æœºåˆ¶å®ç°


```java
/**
 * é»‘åå•ç®¡ç†æœåŠ¡
 */
@Service
public class BlacklistService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    private static final String BLACKLIST_KEY = "security:blacklist:";
    
    /**
     * å°†ç”¨æˆ·åŠ å…¥é»‘åå•
     */
    public void addToBlacklist(Long userId, String reason, Duration duration) {
        String key = BLACKLIST_KEY + userId;
        
        BlacklistInfo info = BlacklistInfo.builder()
            .userId(userId)
            .reason(reason)
            .blacklistTime(LocalDateTime.now())
            .expireTime(LocalDateTime.now().plus(duration))
            .build();
            
        redisTemplate.opsForValue().set(key, info, duration);
        
        log.info("ç”¨æˆ· {} è¢«åŠ å…¥é»‘åå•ï¼ŒåŸå› ï¼š{}, æ—¶é•¿ï¼š{}", userId, reason, duration);
    }
    
    /**
     * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨é»‘åå•ä¸­
     */
    public boolean isInBlacklist(Long userId) {
        String key = BLACKLIST_KEY + userId;
        BlacklistInfo info = (BlacklistInfo) redisTemplate.opsForValue().get(key);
        
        if (info != null) {
            log.warn("é»‘åå•ç”¨æˆ·å°è¯•è®¿é—®ï¼šç”¨æˆ·ID={}, é»‘åå•åŸå› ={}", userId, info.getReason());
            return true;
        }
        
        return false;
    }
    
    /**
     * ç§»é™¤é»‘åå•
     */
    public void removeFromBlacklist(Long userId) {
        String key = BLACKLIST_KEY + userId;
        redisTemplate.delete(key);
        log.info("ç”¨æˆ· {} å·²ä»é»‘åå•ç§»é™¤", userId);
    }
}

/**
 * é»‘åå•ä¿¡æ¯
 */
@Data
@Builder
public class BlacklistInfo {
    private Long userId;
    private String reason;
    private LocalDateTime blacklistTime;
    private LocalDateTime expireTime;
}
```

### 7.4 ç™½åå•ä¸é»‘åå•çš„åº”ç”¨åœºæ™¯


**ç™½åå•é€‚ç”¨åœºæ™¯**ï¼š
- ğŸ” **é«˜å®‰å…¨è¦æ±‚**ï¼šé»˜è®¤æ‹’ç»ï¼Œæ˜ç¡®å…è®¸
- ğŸ“± **APIæ¥å£ä¿æŠ¤**ï¼šåªå…è®¸ç‰¹å®šæ¥å£å…¬å¼€è®¿é—®
- ğŸ¢ **ä¼ä¸šå†…éƒ¨ç³»ç»Ÿ**ï¼šåªå…è®¸å†…éƒ¨IPè®¿é—®

```java
// åœ¨æ‹¦æˆªå™¨ä¸­ä½¿ç”¨ç™½åå•
if (whitelistService.isNoAuthPath(requestPath)) {
    return true; // ç™½åå•ç›´æ¥æ”¾è¡Œ
}
```

**é»‘åå•é€‚ç”¨åœºæ™¯**ï¼š
- ğŸš« **æ¶æ„ç”¨æˆ·å°ç¦**ï¼šä¸´æ—¶æˆ–æ°¸ä¹…ç¦æ­¢ç‰¹å®šç”¨æˆ·
- ğŸ›¡ï¸ **å®‰å…¨é˜²æŠ¤**ï¼šé˜²æ­¢æš´åŠ›ç ´è§£æˆ–å¼‚å¸¸è®¿é—®
- âš¡ **é™æµä¿æŠ¤**ï¼šå¯¹é¢‘ç¹è®¿é—®çš„ç”¨æˆ·é™åˆ¶

```java
// åœ¨æ‹¦æˆªå™¨ä¸­ä½¿ç”¨é»‘åå•
if (blacklistService.isInBlacklist(userId)) {
    response.setStatus(403);
    response.getWriter().write("{\"message\":\"è´¦å·å·²è¢«é™åˆ¶è®¿é—®\"}");
    return false;
}
```

---

## 8. ğŸ‘‘ è¶…çº§ç®¡ç†å‘˜ä¸é»˜è®¤æƒé™


### 8.1 è¶…çº§ç®¡ç†å‘˜çš„æ¦‚å¿µ


**è¶…çº§ç®¡ç†å‘˜**å°±åƒ**ä¸‡èƒ½é’¥åŒ™**ï¼Œå¯ä»¥æ‰“å¼€æ‰€æœ‰é—¨ï¼Œæ‹¥æœ‰ç³»ç»Ÿçš„æœ€é«˜æƒé™ã€‚

```
æ™®é€šæƒé™ä½“ç³»ï¼š
ğŸ‘¤ç”¨æˆ· â†’ ğŸ­è§’è‰² â†’ ğŸ“¦æƒé™åŒ… â†’ âœ…/âŒ å…·ä½“æ“ä½œ

è¶…çº§ç®¡ç†å‘˜ï¼š
ğŸ‘‘è¶…çº§ç®¡ç†å‘˜ â†’ ğŸ”“ä¸‡èƒ½æƒé™ â†’ âœ… æ‰€æœ‰æ“ä½œï¼ˆç»•è¿‡æƒé™æ£€æŸ¥ï¼‰
```

### 8.2 è¶…çº§ç®¡ç†å‘˜å®ç°


```java
/**
 * è¶…çº§ç®¡ç†å‘˜é…ç½®
 */
@Component
@ConfigurationProperties(prefix = "security.super-admin")
@Data
public class SuperAdminConfig {
    
    /**
     * è¶…çº§ç®¡ç†å‘˜ç”¨æˆ·IDåˆ—è¡¨
     */
    private List<Long> userIds = Arrays.asList(1L); // é»˜è®¤ç”¨æˆ·IDä¸º1çš„æ˜¯è¶…çº§ç®¡ç†å‘˜
    
    /**
     * è¶…çº§ç®¡ç†å‘˜è§’è‰²æ ‡è¯†
     */
    private String roleCode = "SUPER_ADMIN";
    
    /**
     * æ˜¯å¦å¯ç”¨è¶…çº§ç®¡ç†å‘˜åŠŸèƒ½
     */
    private boolean enabled = true;
}

/**
 * è¶…çº§ç®¡ç†å‘˜æ£€æŸ¥æœåŠ¡
 */
@Service
public class SuperAdminService {
    
    @Autowired
    private SuperAdminConfig superAdminConfig;
    
    /**
     * æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ˜¯è¶…çº§ç®¡ç†å‘˜
     */
    public boolean isSuperAdmin(Long userId) {
        if (!superAdminConfig.isEnabled()) {
            return false;
        }
        
        // æ–¹å¼1ï¼šé€šè¿‡ç”¨æˆ·IDåˆ¤æ–­
        if (superAdminConfig.getUserIds().contains(userId)) {
            return true;
        }
        
        // æ–¹å¼2ï¼šé€šè¿‡è§’è‰²åˆ¤æ–­
        List<String> userRoles = getUserRoles(userId);
        return userRoles.contains(superAdminConfig.getRoleCode());
    }
    
    /**
     * ä¸ºè¶…çº§ç®¡ç†å‘˜åˆ›å»ºç‰¹æ®ŠToken
     */
    public String generateSuperAdminToken(Long userId) {
        Map<String, Object> claims = new HashMap<>();
        claims.put("userId", userId);
        claims.put("superAdmin", true); // æ ‡è®°ä¸ºè¶…çº§ç®¡ç†å‘˜
        claims.put("roles", Arrays.asList("SUPER_ADMIN"));
        
        return JwtUtil.generateToken(claims, Duration.ofDays(30)); // æ›´é•¿çš„æœ‰æ•ˆæœŸ
    }
}
```

### 8.3 æƒé™æ£€æŸ¥ä¸­çš„è¶…çº§ç®¡ç†å‘˜é€»è¾‘


```java
/**
 * å¢å¼ºç‰ˆæƒé™æ£€æŸ¥æœåŠ¡
 */
@Service
public class EnhancedPermissionService {
    
    @Autowired
    private SuperAdminService superAdminService;
    
    /**
     * æƒé™æ£€æŸ¥ï¼ˆè€ƒè™‘è¶…çº§ç®¡ç†å‘˜ï¼‰
     */
    public boolean hasPermission(Long userId, String permission) {
        // 1. è¶…çº§ç®¡ç†å‘˜æ£€æŸ¥ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
        if (superAdminService.isSuperAdmin(userId)) {
            log.debug("ç”¨æˆ· {} æ˜¯è¶…çº§ç®¡ç†å‘˜ï¼Œå…è®¸æ‰€æœ‰æ“ä½œ", userId);
            return true; // è¶…çº§ç®¡ç†å‘˜æ‹¥æœ‰æ‰€æœ‰æƒé™
        }
        
        // 2. æ™®é€šæƒé™æ£€æŸ¥
        List<String> userPermissions = getUserPermissions(userId);
        boolean hasPermission = userPermissions.contains(permission);
        
        log.debug("ç”¨æˆ· {} æƒé™æ£€æŸ¥ç»“æœï¼š{} -> {}", userId, permission, hasPermission);
        return hasPermission;
    }
    
    /**
     * è§’è‰²æ£€æŸ¥ï¼ˆè€ƒè™‘è¶…çº§ç®¡ç†å‘˜ï¼‰
     */
    public boolean hasRole(Long userId, String role) {
        // è¶…çº§ç®¡ç†å‘˜æ‹¥æœ‰æ‰€æœ‰è§’è‰²
        if (superAdminService.isSuperAdmin(userId)) {
            return true;
        }
        
        List<String> userRoles = getUserRoles(userId);
        return userRoles.contains(role);
    }
}
```

### 8.4 é»˜è®¤æƒé™æœºåˆ¶


**ä»€ä¹ˆæ˜¯é»˜è®¤æƒé™**ï¼š**æ–°ç”¨æˆ·æ³¨å†Œåè‡ªåŠ¨è·å¾—çš„åŸºæœ¬æƒé™**ï¼Œå°±åƒæ–°å‘˜å·¥å…¥èŒæ—¶çš„åŸºç¡€æƒé™ã€‚

```java
/**
 * é»˜è®¤æƒé™é…ç½®
 */
@Component
@ConfigurationProperties(prefix = "security.default-permissions")
@Data
public class DefaultPermissionsConfig {
    
    /**
     * æ–°ç”¨æˆ·é»˜è®¤è§’è‰²
     */
    private List<String> defaultRoles = Arrays.asList("USER");
    
    /**
     * æ–°ç”¨æˆ·é»˜è®¤æƒé™
     */
    private List<String> defaultPermissions = Arrays.asList(
        "profile:view",      // æŸ¥çœ‹ä¸ªäººä¿¡æ¯
        "profile:update",    // ä¿®æ”¹ä¸ªäººä¿¡æ¯
        "password:change"    // ä¿®æ”¹å¯†ç 
    );
    
    /**
     * è®¿å®¢é»˜è®¤æƒé™ï¼ˆæœªç™»å½•ç”¨æˆ·ï¼‰
     */
    private List<String> guestPermissions = Arrays.asList(
        "public:view",       // æŸ¥çœ‹å…¬å¼€å†…å®¹
        "captcha:generate"   // ç”ŸæˆéªŒè¯ç 
    );
}

/**
 * é»˜è®¤æƒé™ç®¡ç†æœåŠ¡
 */
@Service
public class DefaultPermissionService {
    
    @Autowired
    private DefaultPermissionsConfig defaultConfig;
    
    /**
     * ä¸ºæ–°ç”¨æˆ·åˆ†é…é»˜è®¤æƒé™
     */
    public void assignDefaultPermissions(Long userId) {
        // åˆ†é…é»˜è®¤è§’è‰²
        for (String role : defaultConfig.getDefaultRoles()) {
            userRoleService.assignRole(userId, role);
        }
        
        // åˆ†é…é»˜è®¤æƒé™
        for (String permission : defaultConfig.getDefaultPermissions()) {
            userPermissionService.grantPermission(userId, permission);
        }
        
        log.info("ä¸ºç”¨æˆ· {} åˆ†é…é»˜è®¤æƒé™å®Œæˆ", userId);
    }
    
    /**
     * è·å–è®¿å®¢æƒé™
     */
    public List<String> getGuestPermissions() {
        return new ArrayList<>(defaultConfig.getGuestPermissions());
    }
    
    /**
     * æ£€æŸ¥æ˜¯å¦æ˜¯é»˜è®¤æƒé™
     */
    public boolean isDefaultPermission(String permission) {
        return defaultConfig.getDefaultPermissions().contains(permission) ||
               defaultConfig.getGuestPermissions().contains(permission);
    }
}
```

### 8.5 æƒé™å±‚çº§å…³ç³»


```
æƒé™æ£€æŸ¥ä¼˜å…ˆçº§ï¼š

1ï¸âƒ£ è¶…çº§ç®¡ç†å‘˜æ£€æŸ¥
   â†“
2ï¸âƒ£ é»‘åå•æ£€æŸ¥
   â†“  
3ï¸âƒ£ ç™½åå•æ£€æŸ¥
   â†“
4ï¸âƒ£ å…·ä½“æƒé™æ£€æŸ¥
   â†“
5ï¸âƒ£ é»˜è®¤æƒé™æ£€æŸ¥
   â†“
6ï¸âƒ£ æ‹’ç»è®¿é—®
```

```java
/**
 * å®Œæ•´çš„æƒé™æ£€æŸ¥æµç¨‹
 */
public boolean checkAccess(Long userId, String permission, String path) {
    // 1. è¶…çº§ç®¡ç†å‘˜ï¼šå…¨éƒ¨å…è®¸
    if (userId != null && superAdminService.isSuperAdmin(userId)) {
        return true;
    }
    
    // 2. é»‘åå•ï¼šç›´æ¥æ‹’ç»
    if (userId != null && blacklistService.isInBlacklist(userId)) {
        return false;
    }
    
    // 3. ç™½åå•ï¼šç‰¹å®šè·¯å¾„å…è®¸
    if (whitelistService.isNoPermissionPath(path)) {
        return true;
    }
    
    // 4. å…·ä½“æƒé™æ£€æŸ¥
    if (userId != null && hasSpecificPermission(userId, permission)) {
        return true;
    }
    
    // 5. é»˜è®¤æƒé™æ£€æŸ¥
    if (defaultPermissionService.isDefaultPermission(permission)) {
        return true;
    }
    
    // 6. é»˜è®¤æ‹’ç»
    return false;
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æƒé™æ ¡éªŒæœ¬è´¨ï¼šç¡®ä¿ç”¨æˆ·åªèƒ½è®¿é—®æœ‰æƒé™çš„èµ„æº
ğŸ”¸ æ ¡éªŒæµç¨‹ï¼šèº«ä»½è¯†åˆ« â†’ æƒé™æŸ¥è¯¢ â†’ æƒé™åˆ¤æ–­  
ğŸ”¸ å­˜å‚¨æ–¹å¼ï¼šSession(æœ‰çŠ¶æ€) vs Token(æ— çŠ¶æ€)
ğŸ”¸ å®ç°æ–¹å¼ï¼šæ³¨è§£å¼æ§åˆ¶ vs æ‹¦æˆªå™¨ç»Ÿä¸€æ ¡éªŒ
ğŸ”¸ å¼‚å¸¸å¤„ç†ï¼šå‹å¥½çš„403é”™è¯¯æç¤ºå’Œæ—¥å¿—è®°å½•
ğŸ”¸ è®¿é—®æ§åˆ¶ï¼šç™½åå•(é»˜è®¤æ‹’ç») vs é»‘åå•(é»˜è®¤å…è®¸)
ğŸ”¸ ç‰¹æ®Šæƒé™ï¼šè¶…çº§ç®¡ç†å‘˜ä¸‡èƒ½æƒé™ + æ–°ç”¨æˆ·é»˜è®¤æƒé™
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ æƒé™æ ¡éªŒçš„æ—¶æœº**ï¼š
```
è¿‡æ»¤å™¨ â†’ æ‹¦æˆªå™¨ â†’ æ³¨è§£æ£€æŸ¥ â†’ æ–¹æ³•æ‰§è¡Œ
ğŸŒè¯·æ±‚  ğŸ›¡ï¸ç»Ÿä¸€æ ¡éªŒ  ğŸ“ç»†ç²’åº¦æ§åˆ¶  ğŸ’¼ä¸šåŠ¡é€»è¾‘
```

**ğŸ”¹ Session vs Token çš„é€‰æ‹©**ï¼š
```
å°å‹å•ä½“åº”ç”¨ï¼šSessionæ›´ç®€å•
åˆ†å¸ƒå¼å¾®æœåŠ¡ï¼šTokenæ›´é€‚åˆ
é«˜å®‰å…¨è¦æ±‚ï¼šToken + çŸ­æœŸæœ‰æ•ˆæœŸ
å¿«é€Ÿå¼€å‘ï¼šSession + Redisé›†ä¸­å­˜å‚¨
```

**ğŸ”¹ æƒé™ç²’åº¦çš„å¹³è¡¡**ï¼š
```
è¿‡ç»†ï¼šç»´æŠ¤æˆæœ¬é«˜ï¼Œæ€§èƒ½å½±å“å¤§
è¿‡ç²—ï¼šå®‰å…¨æ€§ä¸è¶³ï¼Œæ§åˆ¶ä¸å¤Ÿç²¾ç¡®
å»ºè®®ï¼šæ ¸å¿ƒåŠŸèƒ½ç»†ç²’åº¦ï¼Œè¾…åŠ©åŠŸèƒ½ç²—ç²’åº¦
```

### 9.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ’¼ ä¸šåŠ¡åœºæ™¯åº”ç”¨**ï¼š
- **ä¼ä¸šç®¡ç†ç³»ç»Ÿ**ï¼šå‘˜å·¥è§’è‰²æƒé™æ§åˆ¶
- **ç”µå•†å¹³å°**ï¼šç”¨æˆ·ã€å•†å®¶ã€ç®¡ç†å‘˜æƒé™åˆ†ç¦»
- **å†…å®¹ç®¡ç†**ï¼šç¼–è¾‘ã€å®¡æ ¸ã€å‘å¸ƒæƒé™æµç¨‹
- **é‡‘èç³»ç»Ÿ**ï¼šä¸¥æ ¼çš„æƒé™å®¡æ‰¹æœºåˆ¶

**ğŸ”§ æŠ€æœ¯å®ç°å»ºè®®**ï¼š
- **å¼€å‘é˜¶æ®µ**ï¼šå…ˆç”¨æ³¨è§£å¿«é€Ÿå®ç°ï¼Œåç»­ä¼˜åŒ–ç»Ÿä¸€æ ¡éªŒ
- **æµ‹è¯•é˜¶æ®µ**ï¼šé‡ç‚¹æµ‹è¯•è¾¹ç•Œæƒ…å†µå’Œå¼‚å¸¸æµç¨‹
- **ä¸Šçº¿é˜¶æ®µ**ï¼šç›‘æ§æƒé™å¼‚å¸¸ï¼ŒåŠæ—¶å‘ç°å®‰å…¨é—®é¢˜
- **ç»´æŠ¤é˜¶æ®µ**ï¼šå®šæœŸå®¡è®¡æƒé™é…ç½®ï¼Œæ¸…ç†å†—ä½™æƒé™

**âš¡ æ€§èƒ½ä¼˜åŒ–è¦ç‚¹**ï¼š
```
ç¼“å­˜ç”¨æˆ·æƒé™ï¼šé¿å…é‡å¤æ•°æ®åº“æŸ¥è¯¢
åˆç†çš„Tokenæœ‰æ•ˆæœŸï¼šå¹³è¡¡å®‰å…¨æ€§å’Œç”¨æˆ·ä½“éªŒ  
æƒé™ä¿¡æ¯é¢„åŠ è½½ï¼šç™»å½•æ—¶ä¸€æ¬¡æ€§è·å–
å¼‚æ­¥æ—¥å¿—è®°å½•ï¼šé¿å…å½±å“æ­£å¸¸ä¸šåŠ¡æµç¨‹
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- æƒé™æ ¡éªŒå¦‚é—¨å«ï¼Œèº«ä»½æƒé™è¦æŸ¥æ¸…
- SessionçŠ¶æ€Tokenæ— çŠ¶æ€ï¼Œæ ¹æ®åœºæ™¯æ¥é€‰æ‹©  
- æ³¨è§£ç®€å•æ‹¦æˆªå™¨å¼ºï¼Œç»Ÿä¸€æ ¡éªŒä¿å®‰å…¨
- ç™½åå•ä¸¥æ ¼é»‘åå•æ¾ï¼Œè¶…ç®¡é»˜è®¤è¦é…å¥½