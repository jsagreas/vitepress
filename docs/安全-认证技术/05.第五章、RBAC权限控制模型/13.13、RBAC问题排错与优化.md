---
title: 13ã€RBACé—®é¢˜æ’é”™ä¸ä¼˜åŒ–
---
## ğŸ“š ç›®å½•

1. [æ–°å¢è§’è‰²åæƒé™ä¸ç”Ÿæ•ˆé—®é¢˜](#1-æ–°å¢è§’è‰²åæƒé™ä¸ç”Ÿæ•ˆé—®é¢˜)
2. [å‰ç«¯èœå•ä¸æ›´æ–°å¤„ç†æ–¹æ³•](#2-å‰ç«¯èœå•ä¸æ›´æ–°å¤„ç†æ–¹æ³•)
3. [æ•°æ®æƒé™é…ç½®å†²çªè§£å†³](#3-æ•°æ®æƒé™é…ç½®å†²çªè§£å†³)
4. [Tokenè¿‡æœŸåæƒé™åŒæ­¥é—®é¢˜](#4-Tokenè¿‡æœŸåæƒé™åŒæ­¥é—®é¢˜)
5. [æƒé™æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–](#5-æƒé™æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”§ æ–°å¢è§’è‰²åæƒé™ä¸ç”Ÿæ•ˆé—®é¢˜


### 1.1 é—®é¢˜ç°è±¡æè¿°


**ğŸ¯ ä»€ä¹ˆæ˜¯æƒé™ä¸ç”Ÿæ•ˆ**ï¼š
```
ç®€å•ç†è§£ï¼šç»™ç”¨æˆ·åˆ†é…äº†æ–°è§’è‰²ï¼Œä½†æ˜¯ç”¨æˆ·ä»ç„¶æ— æ³•è®¿é—®è¯¥è§’è‰²å¯¹åº”çš„åŠŸèƒ½
å°±åƒç»™å‘˜å·¥å‘äº†æ–°çš„é—¨å¡ï¼Œä½†æ˜¯é—¨ç¦ç³»ç»Ÿè¿˜æ˜¯ä¸è®©ä»–è¿›å…¥æ–°çš„åŠå…¬åŒºåŸŸ
```

**å¸¸è§ç—‡çŠ¶**ï¼š
- âœ… æ•°æ®åº“ä¸­è§’è‰²åˆ†é…æˆåŠŸ
- âŒ ç”¨æˆ·ç™»å½•åçœ‹ä¸åˆ°æ–°åŠŸèƒ½èœå•
- âŒ è®¿é—®æ–°åŠŸèƒ½æ—¶æç¤º"æƒé™ä¸è¶³"
- âŒ APIæ¥å£è¿”å›403ç¦æ­¢è®¿é—®

### 1.2 æ ¹æœ¬åŸå› åˆ†æ


**ğŸ” æƒé™ä¸ç”Ÿæ•ˆçš„å¸¸è§åŸå› **ï¼š

```
ç”¨æˆ·æƒé™è·å–æµç¨‹ï¼š
ç™»å½• â†’ ç”ŸæˆToken â†’ Tokenä¸­åŒ…å«æƒé™ä¿¡æ¯ â†’ å‰ç«¯æ ¹æ®æƒé™æ˜¾ç¤ºèœå•

é—®é¢˜å‡ºç°ç¯èŠ‚ï¼š
1ï¸âƒ£ ç¼“å­˜æœªæ›´æ–° - æƒé™ä¿¡æ¯è¿˜åœ¨ä½¿ç”¨æ—§ç¼“å­˜
2ï¸âƒ£ Tokenæœªåˆ·æ–° - Tokenä¸­çš„æƒé™ä¿¡æ¯æ˜¯æ—§çš„
3ï¸âƒ£ æƒé™ç»§æ‰¿é—®é¢˜ - è§’è‰²å±‚çº§å…³ç³»é…ç½®é”™è¯¯
4ï¸âƒ£ æ•°æ®åº“åŒæ­¥å»¶è¿Ÿ - æƒé™åˆ†é…è¿˜æœªçœŸæ­£ç”Ÿæ•ˆ
```

**ğŸ’¡ ç¼“å­˜é—®é¢˜è¯¦è§£**ï¼š
```
ä»€ä¹ˆæ˜¯æƒé™ç¼“å­˜ï¼š
ä¸ºäº†æé«˜æ€§èƒ½ï¼Œç³»ç»Ÿä¼šæŠŠç”¨æˆ·çš„æƒé™ä¿¡æ¯æš‚æ—¶å­˜å‚¨åœ¨å†…å­˜ä¸­
å°±åƒæŠŠå¸¸ç”¨çš„æ–‡ä»¶æ”¾åœ¨æ¡Œé¢ä¸Šï¼Œä¸ç”¨æ¯æ¬¡éƒ½å»æ–‡ä»¶æŸœæ‰¾

ç¼“å­˜å¯¼è‡´çš„é—®é¢˜ï¼š
- æ–°åˆ†é…çš„æƒé™å­˜åœ¨æ•°æ®åº“é‡Œ
- ä½†æ˜¯ç¨‹åºè¿˜åœ¨ä½¿ç”¨å†…å­˜ä¸­çš„æ—§æƒé™ä¿¡æ¯
- é€ æˆ"æ•°æ®åº“æœ‰æƒé™ï¼Œä½†æ˜¯ç”¨ä¸äº†"çš„æƒ…å†µ
```

### 1.3 é—®é¢˜æ’æŸ¥æ­¥éª¤


**ğŸ” ç³»ç»Ÿæ€§æ’æŸ¥æ–¹æ³•**ï¼š

```
ç¬¬ä¸€æ­¥ï¼šç¡®è®¤æ•°æ®åº“çŠ¶æ€
æŸ¥è¯¢SQLï¼š
SELECT u.username, r.role_name, p.permission_name
FROM users u
JOIN user_roles ur ON u.user_id = ur.user_id
JOIN roles r ON ur.role_id = r.role_id
JOIN role_permissions rp ON r.role_id = rp.role_id
JOIN permissions p ON rp.permission_id = p.permission_id
WHERE u.username = 'ç›®æ ‡ç”¨æˆ·';

ç¡®è®¤ï¼šæ•°æ®åº“ä¸­æƒé™åˆ†é…æ˜¯å¦æ­£ç¡®
```

```
ç¬¬äºŒæ­¥ï¼šæ£€æŸ¥ç¼“å­˜çŠ¶æ€
// æ£€æŸ¥Redisç¼“å­˜ä¸­çš„ç”¨æˆ·æƒé™
redis-cli
GET "user:permissions:ç”¨æˆ·ID"

ç¡®è®¤ï¼šç¼“å­˜ä¸­çš„æƒé™ä¿¡æ¯æ˜¯å¦å·²æ›´æ–°
```

```
ç¬¬ä¸‰æ­¥ï¼šéªŒè¯Tokenå†…å®¹
// è§£æJWT TokenæŸ¥çœ‹æƒé™ä¿¡æ¯
const jwt = require('jsonwebtoken');
const decoded = jwt.decode(token);
console.log(decoded.permissions);

ç¡®è®¤ï¼šTokenä¸­æ˜¯å¦åŒ…å«æ–°æƒé™
```

### 1.4 è§£å†³æ–¹æ¡ˆ


**âš¡ ç«‹å³ç”Ÿæ•ˆè§£å†³æ–¹æ¡ˆ**ï¼š

```java
// æ–¹æ¡ˆ1ï¼šæ¸…é™¤ç”¨æˆ·æƒé™ç¼“å­˜
@Service
public class UserPermissionService {
    
    @Autowired
    private RedisTemplate redisTemplate;
    
    // åˆ†é…æ–°è§’è‰²åç«‹å³æ¸…é™¤ç¼“å­˜
    public void assignRoleToUser(Long userId, Long roleId) {
        // 1. æ•°æ®åº“æ“ä½œ
        userRoleMapper.insert(userId, roleId);
        
        // 2. ç«‹å³æ¸…é™¤è¯¥ç”¨æˆ·çš„æƒé™ç¼“å­˜
        String cacheKey = "user:permissions:" + userId;
        redisTemplate.delete(cacheKey);
        
        // 3. å¯é€‰ï¼šä¸»åŠ¨åˆ·æ–°ç¼“å­˜
        loadUserPermissions(userId);
    }
}
```

```javascript
// æ–¹æ¡ˆ2ï¼šå‰ç«¯ä¸»åŠ¨åˆ·æ–°ç”¨æˆ·ä¿¡æ¯
// åˆ†é…è§’è‰²åè°ƒç”¨ç”¨æˆ·ä¿¡æ¯åˆ·æ–°æ¥å£
async function refreshUserInfo() {
    try {
        // é‡æ–°è·å–ç”¨æˆ·æƒé™ä¿¡æ¯
        const response = await api.get('/user/current-permissions');
        
        // æ›´æ–°æœ¬åœ°å­˜å‚¨çš„æƒé™ä¿¡æ¯
        localStorage.setItem('userPermissions', JSON.stringify(response.data));
        
        // é‡æ–°æ¸²æŸ“èœå•
        this.renderMenu();
        
        console.log('ç”¨æˆ·æƒé™å·²åˆ·æ–°');
    } catch (error) {
        console.error('æƒé™åˆ·æ–°å¤±è´¥', error);
    }
}
```

**ğŸ”„ è‡ªåŠ¨åŒæ­¥æœºåˆ¶**ï¼š

```java
// æƒé™å˜æ›´äº‹ä»¶ç›‘å¬
@Component
public class PermissionChangeListener {
    
    @EventListener
    public void handleRoleAssignment(RoleAssignmentEvent event) {
        Long userId = event.getUserId();
        
        // æ¸…é™¤ç›¸å…³ç¼“å­˜
        clearUserCache(userId);
        
        // é€šçŸ¥å‰ç«¯åˆ·æ–°ï¼ˆWebSocketæˆ–SSEï¼‰
        notifyPermissionChange(userId);
    }
    
    private void notifyPermissionChange(Long userId) {
        // é€šè¿‡WebSocketé€šçŸ¥å‰ç«¯ç”¨æˆ·æƒé™å‘ç”Ÿå˜åŒ–
        webSocketService.sendToUser(userId, "PERMISSION_CHANGED");
    }
}
```

---

## 2. ğŸ–¥ï¸ å‰ç«¯èœå•ä¸æ›´æ–°å¤„ç†æ–¹æ³•


### 2.1 å‰ç«¯èœå•æ›´æ–°æœºåˆ¶


**ğŸ¯ èœå•æ˜¾ç¤ºåŸç†**ï¼š
```
å‰ç«¯èœå•æ˜¾ç¤ºæµç¨‹ï¼š
ç”¨æˆ·ç™»å½• â†’ è·å–æƒé™åˆ—è¡¨ â†’ æ ¹æ®æƒé™è¿‡æ»¤èœå• â†’ æ¸²æŸ“å¯è§èœå•

å¸¸è§é—®é¢˜ï¼š
æƒé™æ›´æ–°äº†ï¼Œä½†å‰ç«¯è¿˜æ˜¾ç¤ºæ—§èœå•
å°±åƒç”µè§†èŠ‚ç›®å•æ›´æ–°äº†ï¼Œä½†ä½ çš„ç”µè§†è¿˜æ˜¾ç¤ºæ˜¨å¤©çš„èŠ‚ç›®
```

**ğŸ’¡ èœå•ä¸æ›´æ–°çš„åŸå› **ï¼š
- **æœ¬åœ°å­˜å‚¨æœªæ¸…é™¤** - æµè§ˆå™¨ç¼“å­˜äº†æ—§çš„æƒé™ä¿¡æ¯
- **ç»„ä»¶æœªé‡æ–°æ¸²æŸ“** - Vue/Reactç»„ä»¶çŠ¶æ€æ²¡æœ‰æ›´æ–°
- **è·¯ç”±å®ˆå«æœªé‡æ–°éªŒè¯** - è·¯ç”±æƒé™æ£€æŸ¥ä½¿ç”¨äº†æ—§æ•°æ®

### 2.2 Vue.jsèœå•æ›´æ–°è§£å†³æ–¹æ¡ˆ


**ğŸ”§ å®æ—¶èœå•æ›´æ–°å®ç°**ï¼š

```javascript
// store/modules/permission.js
const permissionStore = {
    state: {
        menuList: [],
        permissions: []
    },
    
    mutations: {
        SET_MENU_LIST(state, menuList) {
            state.menuList = menuList;
        },
        SET_PERMISSIONS(state, permissions) {
            state.permissions = permissions;
        }
    },
    
    actions: {
        // é‡æ–°åŠ è½½ç”¨æˆ·æƒé™å’Œèœå•
        async refreshPermissions({ commit }) {
            try {
                // ä»æœåŠ¡å™¨é‡æ–°è·å–æƒé™
                const response = await api.getUserPermissions();
                const permissions = response.data.permissions;
                
                // æ›´æ–°çŠ¶æ€
                commit('SET_PERMISSIONS', permissions);
                
                // æ ¹æ®æ–°æƒé™è¿‡æ»¤èœå•
                const filteredMenu = this.filterMenuByPermissions(permissions);
                commit('SET_MENU_LIST', filteredMenu);
                
                // æ¸…é™¤æœ¬åœ°ç¼“å­˜
                localStorage.removeItem('userPermissions');
                localStorage.setItem('userPermissions', JSON.stringify(permissions));
                
            } catch (error) {
                console.error('æƒé™åˆ·æ–°å¤±è´¥', error);
            }
        }
    }
}
```

```vue
<!-- èœå•ç»„ä»¶ SideMenu.vue -->
<template>
    <div class="side-menu">
        <el-menu :default-active="activeMenu">
            <template v-for="menu in visibleMenus" :key="menu.id">
                <el-menu-item 
                    v-if="hasPermission(menu.permission)"
                    :index="menu.path">
                    {{ menu.name }}
                </el-menu-item>
            </template>
        </el-menu>
    </div>
</template>

<script>
export default {
    computed: {
        visibleMenus() {
            // å“åº”å¼åœ°æ ¹æ®æƒé™è¿‡æ»¤èœå•
            return this.$store.state.permission.menuList.filter(menu => 
                this.hasPermission(menu.permission)
            );
        }
    },
    
    methods: {
        hasPermission(permission) {
            const userPermissions = this.$store.state.permission.permissions;
            return userPermissions.includes(permission);
        },
        
        // ç›‘å¬æƒé™å˜åŒ–äº‹ä»¶
        handlePermissionChange() {
            // é‡æ–°åˆ·æ–°æƒé™
            this.$store.dispatch('refreshPermissions');
        }
    },
    
    created() {
        // ç›‘å¬WebSocketæƒé™å˜åŒ–é€šçŸ¥
        this.$socket.on('PERMISSION_CHANGED', this.handlePermissionChange);
    }
}
</script>
```

### 2.3 Reactèœå•æ›´æ–°è§£å†³æ–¹æ¡ˆ


```javascript
// hooks/usePermissions.js
import { useState, useEffect } from 'react';

export const usePermissions = () => {
    const [permissions, setPermissions] = useState([]);
    const [loading, setLoading] = useState(false);
    
    // åˆ·æ–°æƒé™çš„æ–¹æ³•
    const refreshPermissions = async () => {
        setLoading(true);
        try {
            const response = await api.get('/user/permissions');
            setPermissions(response.data.permissions);
            
            // æ›´æ–°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('permissions', JSON.stringify(response.data.permissions));
        } catch (error) {
            console.error('æƒé™æ›´æ–°å¤±è´¥', error);
        } finally {
            setLoading(false);
        }
    };
    
    // æ£€æŸ¥æƒé™çš„æ–¹æ³•
    const hasPermission = (permission) => {
        return permissions.includes(permission);
    };
    
    return {
        permissions,
        refreshPermissions,
        hasPermission,
        loading
    };
};
```

```jsx
// components/SideMenu.jsx
import React, { useEffect } from 'react';
import { usePermissions } from '../hooks/usePermissions';

const SideMenu = () => {
    const { permissions, refreshPermissions, hasPermission } = usePermissions();
    
    useEffect(() => {
        // ç›‘å¬æƒé™å˜åŒ–äº‹ä»¶
        const handlePermissionChange = () => {
            refreshPermissions();
        };
        
        // WebSocketäº‹ä»¶ç›‘å¬
        window.addEventListener('permissionChanged', handlePermissionChange);
        
        return () => {
            window.removeEventListener('permissionChanged', handlePermissionChange);
        };
    }, []);
    
    const menuItems = [
        { name: 'ç”¨æˆ·ç®¡ç†', permission: 'user:manage', path: '/users' },
        { name: 'è§’è‰²ç®¡ç†', permission: 'role:manage', path: '/roles' },
        { name: 'æƒé™è®¾ç½®', permission: 'permission:manage', path: '/permissions' }
    ];
    
    return (
        <div className="side-menu">
            {menuItems
                .filter(item => hasPermission(item.permission))
                .map(item => (
                    <div key={item.path} className="menu-item">
                        {item.name}
                    </div>
                ))
            }
        </div>
    );
};
```

### 2.4 å¼ºåˆ¶åˆ·æ–°ç­–ç•¥


**âš¡ ç«‹å³ç”Ÿæ•ˆçš„è§£å†³æ–¹æ¡ˆ**ï¼š

```javascript
// æƒé™ç®¡ç†é¡µé¢ - åˆ†é…è§’è‰²åç«‹å³åˆ·æ–°
async function assignRole(userId, roleId) {
    try {
        // 1. è°ƒç”¨åˆ†é…è§’è‰²æ¥å£
        await api.post('/admin/assign-role', { userId, roleId });
        
        // 2. ç«‹å³åˆ·æ–°ç›®æ ‡ç”¨æˆ·çš„æƒé™ï¼ˆå¦‚æœæ˜¯å½“å‰ç”¨æˆ·ï¼‰
        const currentUser = getCurrentUser();
        if (currentUser.id === userId) {
            await refreshCurrentUserPermissions();
            // æ˜¾ç¤ºæˆåŠŸæç¤º
            this.$message.success('è§’è‰²åˆ†é…æˆåŠŸï¼Œæƒé™å·²æ›´æ–°');
        }
        
        // 3. é€šçŸ¥å…¶ä»–ç®¡ç†å‘˜ç•Œé¢æ›´æ–°
        broadcastPermissionChange(userId);
        
    } catch (error) {
        this.$message.error('è§’è‰²åˆ†é…å¤±è´¥');
    }
}

// æƒé™å¼ºåˆ¶åˆ·æ–°æ–¹æ³•
async function refreshCurrentUserPermissions() {
    // æ¸…é™¤æ‰€æœ‰ç›¸å…³ç¼“å­˜
    localStorage.removeItem('userPermissions');
    localStorage.removeItem('userMenus');
    sessionStorage.clear();
    
    // é‡æ–°è·å–æƒé™
    await store.dispatch('user/refreshUserInfo');
    
    // å¼ºåˆ¶é‡æ–°æ¸²æŸ“è·¯ç”±
    this.$router.go(0); // ç®€å•ç²—æš´ä½†æœ‰æ•ˆçš„æ–¹æ³•
}
```

---

## 3. âš–ï¸ æ•°æ®æƒé™é…ç½®å†²çªè§£å†³


### 3.1 æ•°æ®æƒé™å†²çªé—®é¢˜


**ğŸ¯ ä»€ä¹ˆæ˜¯æ•°æ®æƒé™å†²çª**ï¼š
```
æ•°æ®æƒé™ï¼šæ§åˆ¶ç”¨æˆ·èƒ½çœ‹åˆ°å“ªäº›å…·ä½“æ•°æ®çš„æƒé™
æ¯”å¦‚ï¼šé”€å”®ç»ç†åªèƒ½çœ‹è‡ªå·±éƒ¨é—¨çš„é”€å”®æ•°æ®ï¼Œä¸èƒ½çœ‹å…¶ä»–éƒ¨é—¨çš„

å†²çªæƒ…å†µï¼š
ç”¨æˆ·æœ‰å¤šä¸ªè§’è‰²ï¼Œä¸åŒè§’è‰²çš„æ•°æ®æƒé™èŒƒå›´ä¸åŒï¼Œç³»ç»Ÿä¸çŸ¥é“è¯¥ç”¨å“ªä¸ª
å°±åƒä¸€ä¸ªäººæ—¢æ˜¯éƒ¨é—¨ç»ç†åˆæ˜¯é¡¹ç›®ç»„é•¿ï¼Œä¸çŸ¥é“è¯¥æŒ‰å“ªä¸ªèº«ä»½æ¥é™åˆ¶ä»–çœ‹æ•°æ®
```

**å¸¸è§å†²çªåœºæ™¯**ï¼š
- **è§’è‰²æƒé™é‡å ** - ç”¨æˆ·åŒæ—¶æ‹¥æœ‰"éƒ¨é—¨ç»ç†"å’Œ"æ™®é€šå‘˜å·¥"è§’è‰²
- **æƒé™èŒƒå›´å†²çª** - ä¸€ä¸ªè§’è‰²å…è®¸çœ‹å…¨éƒ¨æ•°æ®ï¼Œå¦ä¸€ä¸ªåªèƒ½çœ‹éƒ¨é—¨æ•°æ®
- **ç»§æ‰¿å…³ç³»æ··ä¹±** - å­è§’è‰²æƒé™ä¸çˆ¶è§’è‰²æƒé™ä¸ä¸€è‡´

### 3.2 å†²çªç±»å‹åˆ†æ


**ğŸ“Š æƒé™å†²çªåˆ†ç±»è¡¨æ ¼**ï¼š

| å†²çªç±»å‹ | **åœºæ™¯æè¿°** | **ç¤ºä¾‹** | **å½±å“** |
|---------|-------------|---------|----------|
| ğŸ”„ **èŒƒå›´å†²çª** | `ä¸åŒè§’è‰²æ•°æ®èŒƒå›´ä¸åŒ` | `ç»ç†è§’è‰²çœ‹å…¨éƒ¨ï¼Œå‘˜å·¥è§’è‰²çœ‹ä¸ªäºº` | `ä¸çŸ¥é“è¯¥é™åˆ¶åˆ°ä»€ä¹ˆç¨‹åº¦` |
| âš¡ **çº§åˆ«å†²çª** | `æƒé™çº§åˆ«é«˜ä½ä¸ä¸€è‡´` | `é«˜çº§æƒé™vsåŸºç¡€æƒé™` | `å¯èƒ½è¶Šæƒæˆ–æƒé™ä¸è¶³` |
| ğŸ”€ **ç±»å‹å†²çª** | `è¯»å†™æƒé™è®¾ç½®çŸ›ç›¾` | `åªè¯»è§’è‰²+ç®¡ç†å‘˜è§’è‰²` | `æ“ä½œæƒé™ä¸æ˜ç¡®` |
| ğŸ¯ **éƒ¨é—¨å†²çª** | `è·¨éƒ¨é—¨æƒé™é‡å ` | `æŠ€æœ¯éƒ¨ç»ç†+é”€å”®éƒ¨å‘˜å·¥` | `æ•°æ®è¾¹ç•Œæ¨¡ç³Š` |

### 3.3 æƒé™åˆå¹¶ç­–ç•¥


**ğŸª å¸¸ç”¨çš„æƒé™åˆå¹¶è§„åˆ™**ï¼š

```
ç­–ç•¥1ï¼šæœ€å¤§æƒé™åŸåˆ™ï¼ˆå–å¹¶é›†ï¼‰
ç”¨æˆ·æ‹¥æœ‰æ‰€æœ‰è§’è‰²æƒé™çš„æ€»å’Œ
é€‚ç”¨åœºæ™¯ï¼šå†…éƒ¨ç®¡ç†ç³»ç»Ÿï¼Œå®‰å…¨è¦æ±‚ä¸é«˜

ç­–ç•¥2ï¼šæœ€å°æƒé™åŸåˆ™ï¼ˆå–äº¤é›†ï¼‰  
åªç»™ç”¨æˆ·æ‰€æœ‰è§’è‰²å…±åŒæ‹¥æœ‰çš„æƒé™
é€‚ç”¨åœºæ™¯ï¼šé«˜å®‰å…¨è¦æ±‚çš„ç³»ç»Ÿ

ç­–ç•¥3ï¼šä¼˜å…ˆçº§ç­–ç•¥ï¼ˆæŒ‰è§’è‰²ç­‰çº§ï¼‰
é«˜çº§è§’è‰²çš„æƒé™è¦†ç›–ä½çº§è§’è‰²
é€‚ç”¨åœºæ™¯ï¼šæœ‰æ˜ç¡®å±‚çº§å…³ç³»çš„ç»„ç»‡

ç­–ç•¥4ï¼šæ˜ç¡®æ‹’ç»ç­–ç•¥
ä»»ä½•ä¸€ä¸ªè§’è‰²æ‹’ç»çš„æƒé™éƒ½è¢«æ‹’ç»
é€‚ç”¨åœºæ™¯ï¼šéœ€è¦ç²¾ç»†æ§åˆ¶çš„åœºæ™¯
```

### 3.4 ä»£ç å®ç°è§£å†³æ–¹æ¡ˆ


**ğŸ’» æƒé™åˆå¹¶ç®—æ³•å®ç°**ï¼š

```java
@Service
public class DataPermissionResolver {
    
    // è§£å†³æ•°æ®æƒé™å†²çªçš„æ ¸å¿ƒæ–¹æ³•
    public DataPermission resolveDataPermission(Long userId) {
        // 1. è·å–ç”¨æˆ·æ‰€æœ‰è§’è‰²
        List<Role> userRoles = userRoleService.getRolesByUserId(userId);
        
        // 2. è·å–æ¯ä¸ªè§’è‰²çš„æ•°æ®æƒé™
        List<DataPermission> rolePermissions = new ArrayList<>();
        for (Role role : userRoles) {
            DataPermission dp = getDataPermissionByRole(role);
            if (dp != null) {
                rolePermissions.add(dp);
            }
        }
        
        // 3. æ ¹æ®ç­–ç•¥åˆå¹¶æƒé™
        return mergeDataPermissions(rolePermissions);
    }
    
    // æƒé™åˆå¹¶çš„å…·ä½“å®ç°
    private DataPermission mergeDataPermissions(List<DataPermission> permissions) {
        if (permissions.isEmpty()) {
            return getDefaultPermission(); // é»˜è®¤æœ€å°æƒé™
        }
        
        // ä½¿ç”¨æœ€å¤§æƒé™ç­–ç•¥ï¼ˆå®é™…é¡¹ç›®ä¸­å¯é…ç½®ï¼‰
        DataPermission result = new DataPermission();
        
        // æ•°æ®èŒƒå›´å–æœ€å¤§å€¼
        DataScope maxScope = permissions.stream()
            .map(DataPermission::getDataScope)
            .max(Comparator.comparing(DataScope::getLevel))
            .orElse(DataScope.SELF_ONLY);
        result.setDataScope(maxScope);
        
        // éƒ¨é—¨æƒé™å–å¹¶é›†
        Set<Long> allDeptIds = permissions.stream()
            .flatMap(p -> p.getDepartmentIds().stream())
            .collect(Collectors.toSet());
        result.setDepartmentIds(allDeptIds);
        
        return result;
    }
}
```

**ğŸ¯ é…ç½®åŒ–æƒé™ç­–ç•¥**ï¼š

```java
// æƒé™ç­–ç•¥é…ç½®
@ConfigurationProperties(prefix = "rbac.data-permission")
@Component
public class DataPermissionConfig {
    
    // æƒé™åˆå¹¶ç­–ç•¥ï¼šMAX(æœ€å¤§), MIN(æœ€å°), PRIORITY(ä¼˜å…ˆçº§)
    private String mergeStrategy = "MAX";
    
    // è§’è‰²ä¼˜å…ˆçº§é…ç½®ï¼ˆæ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ï¼‰
    private Map<String, Integer> rolePriorities = new HashMap<>();
    
    // æ˜¯å¦å¯ç”¨æ˜ç¡®æ‹’ç»
    private boolean enableExplicitDeny = false;
    
    public DataPermission mergeByStrategy(List<DataPermission> permissions) {
        switch (mergeStrategy.toUpperCase()) {
            case "MAX":
                return mergeByMaxPermission(permissions);
            case "MIN":
                return mergeByMinPermission(permissions);
            case "PRIORITY":
                return mergeByPriority(permissions);
            default:
                return mergeByMaxPermission(permissions);
        }
    }
}
```

### 3.5 æ•°æ®æƒé™SQLç”Ÿæˆ


**ğŸ”§ åŠ¨æ€SQLæƒé™è¿‡æ»¤**ï¼š

```java
@Component
public class DataPermissionSqlGenerator {
    
    // æ ¹æ®ç”¨æˆ·æƒé™ç”Ÿæˆæ•°æ®è¿‡æ»¤SQL
    public String generateDataFilterSql(Long userId, String tableName) {
        DataPermission permission = dataPermissionResolver.resolveDataPermission(userId);
        
        StringBuilder sql = new StringBuilder();
        
        switch (permission.getDataScope()) {
            case ALL:
                // å…¨éƒ¨æ•°æ®æƒé™ï¼Œä¸æ·»åŠ è¿‡æ»¤æ¡ä»¶
                return "";
                
            case DEPT:
                // éƒ¨é—¨æ•°æ®æƒé™
                sql.append(" AND ").append(tableName).append(".dept_id IN (");
                sql.append(permission.getDepartmentIds().stream()
                    .map(String::valueOf)
                    .collect(Collectors.joining(",")));
                sql.append(")");
                break;
                
            case DEPT_AND_SUB:
                // éƒ¨é—¨åŠå­éƒ¨é—¨æ•°æ®æƒé™
                sql.append(" AND ").append(tableName).append(".dept_id IN (");
                sql.append("SELECT dept_id FROM sys_dept WHERE find_in_set(");
                sql.append(permission.getDepartmentIds().iterator().next());
                sql.append(", ancestors))");
                break;
                
            case SELF_ONLY:
                // ä»…ä¸ªäººæ•°æ®
                sql.append(" AND ").append(tableName).append(".create_by = '");
                sql.append(getCurrentUsername(userId)).append("'");
                break;
        }
        
        return sql.toString();
    }
}
```

---

## 4. ğŸ”‘ Tokenè¿‡æœŸåæƒé™åŒæ­¥é—®é¢˜


### 4.1 Tokenè¿‡æœŸé—®é¢˜åˆ†æ


**ğŸ¯ Tokenè¿‡æœŸåœºæ™¯ç†è§£**ï¼š
```
ä»€ä¹ˆæ˜¯Tokenè¿‡æœŸï¼š
Tokenå°±åƒä¸´æ—¶é€šè¡Œè¯ï¼Œæœ‰ä½¿ç”¨æœŸé™
è¿‡æœŸåéœ€è¦é‡æ–°è·å–ï¼Œå°±åƒé—¨å¡åˆ°æœŸéœ€è¦ç»­è´¹

æƒé™åŒæ­¥é—®é¢˜ï¼š
Tokenè¿‡æœŸé‡æ–°è·å–æ—¶ï¼Œå¯èƒ½è·å–åˆ°çš„æƒé™ä¿¡æ¯æ˜¯æ—§çš„
é€ æˆç”¨æˆ·æƒé™"æ—¶å…‰å€’æµ"çš„é—®é¢˜
```

**âš ï¸ å¸¸è§é—®é¢˜åœºæ™¯**ï¼š
- **Tokenåˆ·æ–°æ—¶æœºä¸å½“** - æƒé™åˆšæ›´æ–°ï¼ŒTokenç«‹å³è¿‡æœŸåˆ·æ–°
- **ç¼“å­˜æ•°æ®ä¸ä¸€è‡´** - æ–°Tokenä½¿ç”¨äº†æ—§çš„ç¼“å­˜æƒé™æ•°æ®
- **å¹¶å‘æ›´æ–°å†²çª** - å¤šä¸ªè¯·æ±‚åŒæ—¶åˆ·æ–°Tokenå¯¼è‡´æ•°æ®æ··ä¹±

### 4.2 Tokenåˆ·æ–°æœºåˆ¶ä¼˜åŒ–


**ğŸ”„ æ™ºèƒ½Tokenåˆ·æ–°ç­–ç•¥**ï¼š

```java
@Service
public class TokenRefreshService {
    
    @Autowired
    private RedisTemplate redisTemplate;
    
    // æ™ºèƒ½Tokenåˆ·æ–°ï¼Œç¡®ä¿æƒé™åŒæ­¥
    public String refreshTokenWithLatestPermissions(String oldToken) {
        try {
            // 1. è§£ææ—§Tokenè·å–ç”¨æˆ·ä¿¡æ¯
            Claims claims = jwtUtil.parseToken(oldToken);
            Long userId = claims.get("userId", Long.class);
            
            // 2. æ£€æŸ¥æƒé™æ˜¯å¦å‘ç”Ÿå˜åŒ–
            Long lastPermissionUpdateTime = getLastPermissionUpdateTime(userId);
            Long tokenIssueTime = claims.getIssuedAt().getTime();
            
            if (lastPermissionUpdateTime > tokenIssueTime) {
                // æƒé™å‘ç”Ÿäº†å˜åŒ–ï¼Œéœ€è¦é‡æ–°åŠ è½½
                clearUserPermissionCache(userId);
            }
            
            // 3. è·å–æœ€æ–°çš„æƒé™ä¿¡æ¯
            List<String> latestPermissions = permissionService.getUserPermissions(userId);
            
            // 4. ç”Ÿæˆæ–°Token
            return jwtUtil.generateToken(userId, latestPermissions);
            
        } catch (Exception e) {
            log.error("Tokenåˆ·æ–°å¤±è´¥", e);
            throw new AuthenticationException("Tokenåˆ·æ–°å¤±è´¥");
        }
    }
    
    // è·å–ç”¨æˆ·æƒé™æœ€åæ›´æ–°æ—¶é—´
    private Long getLastPermissionUpdateTime(Long userId) {
        String key = "user:permission:update_time:" + userId;
        Object updateTime = redisTemplate.opsForValue().get(key);
        return updateTime != null ? (Long) updateTime : 0L;
    }
}
```

### 4.3 æƒé™å˜æ›´é€šçŸ¥æœºåˆ¶


**ğŸ“¢ å®æ—¶æƒé™åŒæ­¥å®ç°**ï¼š

```java
@Component
public class PermissionChangeNotifier {
    
    @Autowired
    private RedisTemplate redisTemplate;
    
    // æƒé™å˜æ›´æ—¶çš„å¤„ç†é€»è¾‘
    @EventListener
    public void onPermissionChange(PermissionChangeEvent event) {
        Long userId = event.getUserId();
        
        // 1. è®°å½•æƒé™å˜æ›´æ—¶é—´
        String timeKey = "user:permission:update_time:" + userId;
        redisTemplate.opsForValue().set(timeKey, System.currentTimeMillis());
        
        // 2. æ ‡è®°ç”¨æˆ·Tokenéœ€è¦å¼ºåˆ¶åˆ·æ–°
        String forceRefreshKey = "user:token:force_refresh:" + userId;
        redisTemplate.opsForValue().set(forceRefreshKey, "true", Duration.ofMinutes(30));
        
        // 3. æ¸…é™¤ç›¸å…³ç¼“å­˜
        clearUserCaches(userId);
        
        // 4. é€šçŸ¥å‰ç«¯æƒé™å‘ç”Ÿå˜åŒ–ï¼ˆWebSocketï¼‰
        webSocketService.sendToUser(userId, new PermissionChangeMessage());
    }
    
    private void clearUserCaches(Long userId) {
        // æ¸…é™¤æƒé™ç¼“å­˜
        redisTemplate.delete("user:permissions:" + userId);
        // æ¸…é™¤èœå•ç¼“å­˜
        redisTemplate.delete("user:menus:" + userId);
        // æ¸…é™¤æ•°æ®æƒé™ç¼“å­˜
        redisTemplate.delete("user:data_permission:" + userId);
    }
}
```

### 4.4 å‰ç«¯TokenåŒæ­¥å¤„ç†


**ğŸ’» å‰ç«¯æƒé™åŒæ­¥æœºåˆ¶**ï¼š

```javascript
// axiosè¯·æ±‚æ‹¦æˆªå™¨ - å¤„ç†Tokenåˆ·æ–°å’Œæƒé™åŒæ­¥
axios.interceptors.response.use(
    response => response,
    async error => {
        const { response } = error;
        
        if (response?.status === 401) {
            // Tokenè¿‡æœŸï¼Œå°è¯•åˆ·æ–°
            try {
                const refreshResult = await refreshToken();
                
                // æ£€æŸ¥æ˜¯å¦æœ‰æƒé™æ›´æ–°é€šçŸ¥
                if (refreshResult.data.permissionChanged) {
                    // æƒé™å‘ç”Ÿå˜åŒ–ï¼Œé‡æ–°åŠ è½½ç”¨æˆ·ä¿¡æ¯
                    await store.dispatch('user/refreshUserInfo');
                    
                    // é€šçŸ¥ç”¨æˆ·æƒé™å·²æ›´æ–°
                    Message.info('æ‚¨çš„æƒé™å·²æ›´æ–°ï¼Œé¡µé¢å°†è‡ªåŠ¨åˆ·æ–°');
                    
                    // å»¶è¿Ÿåˆ·æ–°é¡µé¢ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æç¤º
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                }
                
                // é‡æ–°å‘èµ·åŸè¯·æ±‚
                return axios.request(response.config);
                
            } catch (refreshError) {
                // åˆ·æ–°å¤±è´¥ï¼Œè·³è½¬ç™»å½•é¡µ
                store.dispatch('user/logout');
                router.push('/login');
            }
        }
        
        return Promise.reject(error);
    }
);

// Tokenåˆ·æ–°æ–¹æ³•
async function refreshToken() {
    const refreshToken = localStorage.getItem('refreshToken');
    
    const response = await axios.post('/auth/refresh', {
        refreshToken: refreshToken
    });
    
    // æ›´æ–°Token
    const { accessToken, refreshToken: newRefreshToken } = response.data;
    localStorage.setItem('accessToken', accessToken);
    localStorage.setItem('refreshToken', newRefreshToken);
    
    // æ›´æ–°axiosé»˜è®¤header
    axios.defaults.headers.common['Authorization'] = `Bearer ${accessToken}`;
    
    return response;
}
```

### 4.5 æƒé™åŒæ­¥æœ€ä½³å®è·µ


**â­ æƒé™åŒæ­¥ç­–ç•¥æ€»ç»“**ï¼š

| åœºæ™¯ | **ç­–ç•¥** | **å®ç°æ–¹å¼** |
|------|---------|-------------|
| ğŸ”„ **æ­£å¸¸Tokenåˆ·æ–°** | `æ£€æŸ¥æƒé™ç‰ˆæœ¬å·` | `å¯¹æ¯”Tokenç­¾å‘æ—¶é—´ä¸æƒé™æ›´æ–°æ—¶é—´` |
| âš¡ **æƒé™å®æ—¶å˜æ›´** | `ä¸»åŠ¨é€šçŸ¥æœºåˆ¶` | `WebSocketæ¨é€+å¼ºåˆ¶Tokenåˆ·æ–°` |
| ğŸ¯ **é«˜é¢‘æƒé™æŸ¥è¯¢** | `ç¼“å­˜åˆ†å±‚ç­–ç•¥` | `L1æœ¬åœ°ç¼“å­˜+L2Redisç¼“å­˜+L3æ•°æ®åº“` |
| ğŸ”’ **å®‰å…¨æ€§è€ƒè™‘** | `æƒé™é™çº§ä¿æŠ¤` | `æƒé™å†²çªæ—¶é‡‡ç”¨æœ€å°æƒé™åŸåˆ™` |

```java
// æƒé™åŒæ­¥æ£€æŸ¥å·¥å…·ç±»
@Component  
public class PermissionSyncChecker {
    
    // æ£€æŸ¥Tokenä¸­çš„æƒé™æ˜¯å¦éœ€è¦åŒæ­¥
    public boolean needPermissionSync(String token) {
        try {
            Claims claims = jwtUtil.parseToken(token);
            Long userId = claims.get("userId", Long.class);
            Long tokenTime = claims.getIssuedAt().getTime();
            
            // è·å–ç”¨æˆ·æƒé™æœ€åå˜æ›´æ—¶é—´
            Long permissionUpdateTime = getLastPermissionUpdateTime(userId);
            
            // å¦‚æœæƒé™æ›´æ–°æ—¶é—´æ™šäºTokenç­¾å‘æ—¶é—´ï¼Œéœ€è¦åŒæ­¥
            return permissionUpdateTime > tokenTime;
            
        } catch (Exception e) {
            // Tokenè§£æå¤±è´¥ï¼Œéœ€è¦é‡æ–°è®¤è¯
            return true;
        }
    }
}
```

---

## 5. ğŸš€ æƒé™æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–


### 5.1 æ€§èƒ½é—®é¢˜åˆ†æ


**ğŸ¯ æƒé™æŸ¥è¯¢æ€§èƒ½ç“¶é¢ˆ**ï¼š
```
æƒé™æŸ¥è¯¢æ…¢çš„åŸå› ï¼š
1. æ•°æ®åº“è¡¨å…³è”è¿‡å¤š - ç”¨æˆ·â†’è§’è‰²â†’æƒé™ï¼Œå¤šè¡¨JOINæŸ¥è¯¢
2. é¢‘ç¹æŸ¥è¯¢æ•°æ®åº“ - æ¯æ¬¡è¯·æ±‚éƒ½æŸ¥æƒé™ï¼Œæ²¡æœ‰ç¼“å­˜
3. æƒé™è®¡ç®—å¤æ‚ - å®æ—¶è®¡ç®—æƒé™åˆå¹¶å’Œç»§æ‰¿å…³ç³»
4. ç´¢å¼•è®¾è®¡ä¸åˆç† - æŸ¥è¯¢å­—æ®µæ²¡æœ‰å»ºç«‹åˆé€‚ç´¢å¼•

å°±åƒæ¯æ¬¡å¼€é—¨éƒ½è¦ç°åœºéªŒè¯èº«ä»½è¯ä¸€æ ·ä½æ•ˆ
```

**ğŸ“Š æ€§èƒ½é—®é¢˜å½±å“**ï¼š
- **å“åº”æ—¶é—´æ…¢** - ç”¨æˆ·æ“ä½œéœ€è¦ç­‰å¾…æƒé™éªŒè¯
- **æ•°æ®åº“å‹åŠ›å¤§** - é«˜å¹¶å‘æ—¶æ•°æ®åº“æˆä¸ºç“¶é¢ˆ  
- **ç”¨æˆ·ä½“éªŒå·®** - é¡µé¢åŠ è½½ç¼“æ…¢ï¼Œæ“ä½œå¡é¡¿

### 5.2 æ•°æ®åº“ä¼˜åŒ–ç­–ç•¥


**ğŸ”§ SQLæŸ¥è¯¢ä¼˜åŒ–**ï¼š

```sql
-- ä¼˜åŒ–å‰ï¼šå¤šè¡¨å…³è”æŸ¥è¯¢ï¼Œæ€§èƒ½è¾ƒå·®
SELECT DISTINCT p.permission_code 
FROM users u
JOIN user_roles ur ON u.user_id = ur.user_id  
JOIN roles r ON ur.role_id = r.role_id
JOIN role_permissions rp ON r.role_id = rp.role_id
JOIN permissions p ON rp.permission_id = p.permission_id
WHERE u.user_id = ? AND u.status = 1 AND r.status = 1;

-- ä¼˜åŒ–åï¼šä½¿ç”¨EXISTSå­æŸ¥è¯¢ï¼Œå‡å°‘æ•°æ®ä¼ è¾“
SELECT permission_code 
FROM permissions p 
WHERE EXISTS (
    SELECT 1 FROM role_permissions rp 
    JOIN user_roles ur ON rp.role_id = ur.role_id 
    WHERE ur.user_id = ? AND rp.permission_id = p.permission_id
) AND p.status = 1;
```

**ğŸ“‹ ç´¢å¼•ä¼˜åŒ–å»ºè®®**ï¼š

```sql
-- æ ¸å¿ƒè¡¨ç´¢å¼•è®¾è®¡
-- ç”¨æˆ·è§’è‰²å…³è”è¡¨
CREATE INDEX idx_user_roles_user_id ON user_roles(user_id);
CREATE INDEX idx_user_roles_role_id ON user_roles(role_id);
CREATE UNIQUE INDEX uk_user_role ON user_roles(user_id, role_id);

-- è§’è‰²æƒé™å…³è”è¡¨  
CREATE INDEX idx_role_permissions_role_id ON role_permissions(role_id);
CREATE INDEX idx_role_permissions_permission_id ON role_permissions(permission_id);
CREATE UNIQUE INDEX uk_role_permission ON role_permissions(role_id, permission_id);

-- ç»„åˆç´¢å¼•ä¼˜åŒ–ç‰¹å®šæŸ¥è¯¢
CREATE INDEX idx_user_role_permission ON user_roles(user_id) 
    INCLUDE (role_id); -- PostgreSQL/SQL Serverè¯­æ³•
```

### 5.3 ç¼“å­˜ç­–ç•¥ä¼˜åŒ–


**âš¡ å¤šå±‚ç¼“å­˜æ¶æ„**ï¼š

```
ç¼“å­˜å±‚æ¬¡è®¾è®¡ï¼š
L1 - æœ¬åœ°ç¼“å­˜ï¼ˆåº”ç”¨å†…å­˜ï¼‰ï¼šæœ€å¿«ï¼Œä½†å®¹é‡å°
L2 - åˆ†å¸ƒå¼ç¼“å­˜ï¼ˆRedisï¼‰ï¼šå¿«é€Ÿï¼Œå®¹é‡å¤§ï¼Œæ”¯æŒé›†ç¾¤
L3 - æ•°æ®åº“ï¼šæœ€æ…¢ï¼Œä½†æ•°æ®æœ€å‡†ç¡®

ç¼“å­˜ç­–ç•¥ï¼š
çƒ­ç‚¹æƒé™ â†’ L1ç¼“å­˜ï¼ˆ5åˆ†é’Ÿï¼‰
æ™®é€šæƒé™ â†’ L2ç¼“å­˜ï¼ˆ30åˆ†é’Ÿï¼‰  
å†·é—¨æƒé™ â†’ ç›´æ¥æŸ¥æ•°æ®åº“
```

**ğŸ’» ç¼“å­˜å®ç°ä»£ç **ï¼š

```java
@Service
public class OptimizedPermissionService {
    
    @Autowired
    private RedisTemplate redisTemplate;
    
    private final LoadingCache<Long, List<String>> localCache = 
        Caffeine.newBuilder()
            .maximumSize(1000)
            .expireAfterWrite(5, TimeUnit.MINUTES)
            .build(this::loadPermissionsFromRedis);
    
    // è·å–ç”¨æˆ·æƒé™ - å¤šå±‚ç¼“å­˜ç­–ç•¥
    public List<String> getUserPermissions(Long userId) {
        try {
            // L1: æœ¬åœ°ç¼“å­˜
            return localCache.get(userId);
        } catch (Exception e) {
            log.warn("æœ¬åœ°ç¼“å­˜è·å–å¤±è´¥ï¼Œé™çº§åˆ°Redis", e);
            return getPermissionsFromRedis(userId);
        }
    }
    
    // ä»Redisè·å–æƒé™ï¼ˆL2ç¼“å­˜ï¼‰
    private List<String> loadPermissionsFromRedis(Long userId) {
        String cacheKey = "user:permissions:" + userId;
        
        // å°è¯•ä»Redisè·å–
        List<String> permissions = (List<String>) redisTemplate
            .opsForValue().get(cacheKey);
            
        if (permissions == null) {
            // Redisä¸­æ²¡æœ‰ï¼Œä»æ•°æ®åº“åŠ è½½
            permissions = loadPermissionsFromDatabase(userId);
            
            // å­˜å…¥Redisï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´
            redisTemplate.opsForValue().set(cacheKey, permissions, 
                Duration.ofMinutes(30));
        }
        
        return permissions;
    }
    
    // ä»æ•°æ®åº“åŠ è½½æƒé™ï¼ˆL3ï¼‰
    private List<String> loadPermissionsFromDatabase(Long userId) {
        // ä½¿ç”¨ä¼˜åŒ–åçš„SQLæŸ¥è¯¢
        return permissionMapper.selectPermissionsByUserId(userId);
    }
}
```

### 5.4 æƒé™é¢„åŠ è½½æœºåˆ¶


**ğŸ¯ æ™ºèƒ½æƒé™é¢„åŠ è½½**ï¼š

```java
@Component
public class PermissionPreloader {
    
    @Scheduled(fixedRate = 300000) // æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
    public void preloadHotUserPermissions() {
        // 1. è·å–æ´»è·ƒç”¨æˆ·åˆ—è¡¨ï¼ˆæœ€è¿‘1å°æ—¶å†…æœ‰æ“ä½œçš„ç”¨æˆ·ï¼‰
        List<Long> activeUsers = getActiveUsers(Duration.ofHours(1));
        
        // 2. æ‰¹é‡é¢„åŠ è½½è¿™äº›ç”¨æˆ·çš„æƒé™
        for (Long userId : activeUsers) {
            CompletableFuture.runAsync(() -> {
                try {
                    // å¼‚æ­¥é¢„åŠ è½½åˆ°ç¼“å­˜
                    permissionService.getUserPermissions(userId);
                } catch (Exception e) {
                    log.warn("é¢„åŠ è½½ç”¨æˆ·{}æƒé™å¤±è´¥", userId, e);
                }
            });
        }
        
        log.info("é¢„åŠ è½½äº†{}ä¸ªæ´»è·ƒç”¨æˆ·çš„æƒé™", activeUsers.size());
    }
    
    // ç™»å½•æ—¶é¢„åŠ è½½ç›¸å…³æƒé™
    @EventListener
    public void onUserLogin(UserLoginEvent event) {
        Long userId = event.getUserId();
        
        // å¼‚æ­¥é¢„åŠ è½½æƒé™ç›¸å…³æ•°æ®
        CompletableFuture.runAsync(() -> {
            // é¢„åŠ è½½æƒé™
            permissionService.getUserPermissions(userId);
            // é¢„åŠ è½½èœå•
            menuService.getUserMenus(userId);  
            // é¢„åŠ è½½æ•°æ®æƒé™
            dataPermissionService.getUserDataPermission(userId);
        });
    }
}
```

### 5.5 æƒé™æ‰¹é‡éªŒè¯ä¼˜åŒ–


**âš¡ æ‰¹é‡æƒé™æ£€æŸ¥**ï¼š

```java
@Service
public class BatchPermissionChecker {
    
    // æ‰¹é‡æ£€æŸ¥æƒé™ï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°
    public Map<String, Boolean> checkPermissionsBatch(Long userId, 
                                                     List<String> permissions) {
        // 1. è·å–ç”¨æˆ·æ‰€æœ‰æƒé™ï¼ˆä¸€æ¬¡æŸ¥è¯¢ï¼‰
        List<String> userPermissions = permissionService.getUserPermissions(userId);
        Set<String> permissionSet = new HashSet<>(userPermissions);
        
        // 2. æ‰¹é‡éªŒè¯
        Map<String, Boolean> result = new HashMap<>();
        for (String permission : permissions) {
            result.put(permission, permissionSet.contains(permission));
        }
        
        return result;
    }
    
    // é¡µé¢åˆå§‹åŒ–æ—¶æ‰¹é‡åŠ è½½æƒé™çŠ¶æ€
    public PermissionDTO getPagePermissions(Long userId, String pageCode) {
        // æ ¹æ®é¡µé¢ä»£ç è·å–è¯¥é¡µé¢éœ€è¦çš„æ‰€æœ‰æƒé™ç‚¹
        List<String> pagePermissions = getPageRequiredPermissions(pageCode);
        
        // æ‰¹é‡æ£€æŸ¥æƒé™
        Map<String, Boolean> permissionMap = checkPermissionsBatch(userId, pagePermissions);
        
        // å°è£…è¿”å›ç»“æœ
        PermissionDTO dto = new PermissionDTO();
        dto.setCanView(permissionMap.getOrDefault("view", false));
        dto.setCanEdit(permissionMap.getOrDefault("edit", false));
        dto.setCanDelete(permissionMap.getOrDefault("delete", false));
        dto.setCanExport(permissionMap.getOrDefault("export", false));
        
        return dto;
    }
}
```

### 5.6 æ€§èƒ½ç›‘æ§ä¸è°ƒä¼˜


**ğŸ“Š æƒé™æŸ¥è¯¢æ€§èƒ½ç›‘æ§**ï¼š

```java
@Aspect
@Component  
public class PermissionPerformanceMonitor {
    
    @Around("@annotation(PermissionCheck)")
    public Object monitorPermissionCheck(ProceedingJoinPoint joinPoint) throws Throwable {
        long startTime = System.currentTimeMillis();
        
        try {
            Object result = joinPoint.proceed();
            
            long endTime = System.currentTimeMillis();
            long duration = endTime - startTime;
            
            // è®°å½•æƒé™æŸ¥è¯¢è€—æ—¶
            if (duration > 100) { // è¶…è¿‡100msçš„æŸ¥è¯¢è®°å½•è­¦å‘Š
                log.warn("æƒé™æŸ¥è¯¢è€—æ—¶è¿‡é•¿: {}ms, æ–¹æ³•: {}", 
                    duration, joinPoint.getSignature().getName());
            }
            
            // å‘é€æ€§èƒ½æŒ‡æ ‡åˆ°ç›‘æ§ç³»ç»Ÿ
            metricsService.recordPermissionCheckTime(duration);
            
            return result;
            
        } catch (Exception e) {
            log.error("æƒé™æŸ¥è¯¢å¼‚å¸¸", e);
            throw e;
        }
    }
}
```

**ğŸ¯ æ€§èƒ½ä¼˜åŒ–æ•ˆæœå¯¹æ¯”**ï¼š

| ä¼˜åŒ–é¡¹ç›® | **ä¼˜åŒ–å‰** | **ä¼˜åŒ–å** | **æå‡æ•ˆæœ** |
|---------|-----------|-----------|-------------|
| ğŸ” **å•æ¬¡æƒé™æŸ¥è¯¢** | `150ms` | `5ms` | `30å€æå‡` |
| ğŸ“Š **æ‰¹é‡æƒé™æŸ¥è¯¢** | `500ms` | `20ms` | `25å€æå‡` |  
| ğŸ’¾ **ç¼“å­˜å‘½ä¸­ç‡** | `0%` | `95%` | `å¤§å¹…å‡å°‘DBå‹åŠ›` |
| ğŸš€ **å¹¶å‘å¤„ç†èƒ½åŠ›** | `100 QPS` | `2000 QPS` | `20å€æå‡` |

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 é—®é¢˜æ’æŸ¥æ ¸å¿ƒæ€è·¯


**ğŸ”§ RBACé—®é¢˜æ’æŸ¥ä¸‡èƒ½å…¬å¼**ï¼š
```
é—®é¢˜å®šä½ä¸‰æ­¥æ³•ï¼š
1ï¸âƒ£ ç¡®è®¤æ•°æ®å±‚ï¼šæ•°æ®åº“ä¸­æƒé™é…ç½®æ˜¯å¦æ­£ç¡®
2ï¸âƒ£ æ£€æŸ¥ç¼“å­˜å±‚ï¼šç¼“å­˜ä¸­çš„æƒé™ä¿¡æ¯æ˜¯å¦å·²æ›´æ–°  
3ï¸âƒ£ éªŒè¯åº”ç”¨å±‚ï¼šå‰ç«¯å’Œåç«¯æ˜¯å¦ä½¿ç”¨äº†æœ€æ–°æƒé™

è®°å¿†å£è¯€ï¼šæ•°æ®å‡†ä¸å‡†ï¼Œç¼“å­˜æ–°ä¸æ–°ï¼Œåº”ç”¨åŒä¸åŒ
```

### 6.2 æƒé™åŒæ­¥æœ€ä½³å®è·µ


**âš¡ æƒé™å®æ—¶åŒæ­¥æœºåˆ¶**ï¼š
- **ä¸»åŠ¨æ¸…ç¼“å­˜** - æƒé™å˜æ›´æ—¶ç«‹å³æ¸…é™¤ç›¸å…³ç¼“å­˜
- **ç‰ˆæœ¬å·æœºåˆ¶** - ç»™æƒé™æ•°æ®æ·»åŠ ç‰ˆæœ¬æ ‡è¯†
- **äº‹ä»¶é©±åŠ¨** - ä½¿ç”¨äº‹ä»¶æœºåˆ¶è§£è€¦æƒé™å˜æ›´é€šçŸ¥
- **ä¼˜é›…é™çº§** - æƒé™æœåŠ¡å¼‚å¸¸æ—¶çš„å¤‡ç”¨æ–¹æ¡ˆ

### 6.3 æ€§èƒ½ä¼˜åŒ–æ ¸å¿ƒç­–ç•¥


**ğŸš€ æƒé™æ€§èƒ½ä¼˜åŒ–è¦ç‚¹**ï¼š
- **å¤šå±‚ç¼“å­˜** - L1æœ¬åœ°+L2Redis+L3æ•°æ®åº“çš„ç¼“å­˜æ¶æ„
- **æ‰¹é‡å¤„ç†** - ä¸€æ¬¡æ€§è·å–å¤šä¸ªæƒé™ï¼Œå‡å°‘æŸ¥è¯¢æ¬¡æ•°
- **ç´¢å¼•ä¼˜åŒ–** - åˆç†è®¾è®¡æ•°æ®åº“ç´¢å¼•ï¼ŒåŠ é€Ÿæƒé™æŸ¥è¯¢
- **é¢„åŠ è½½æœºåˆ¶** - é¢„æµ‹æ€§åœ°åŠ è½½çƒ­ç‚¹ç”¨æˆ·æƒé™

### 6.4 æ•…éšœå¤„ç†checklist


**âœ… RBACæ•…éšœæ’æŸ¥æ¸…å•**ï¼š
- [ ] æ£€æŸ¥æ•°æ®åº“æƒé™é…ç½®æ˜¯å¦æ­£ç¡®
- [ ] éªŒè¯Redisç¼“å­˜æ˜¯å¦å·²æ›´æ–°
- [ ] ç¡®è®¤Tokenä¸­æƒé™ä¿¡æ¯æ˜¯å¦æœ€æ–°
- [ ] æµ‹è¯•å‰ç«¯æƒé™æ˜¾ç¤ºæ˜¯å¦æ­£å¸¸
- [ ] æ£€æŸ¥APIæ¥å£æƒé™éªŒè¯æ˜¯å¦ç”Ÿæ•ˆ
- [ ] éªŒè¯æ•°æ®æƒé™è¿‡æ»¤æ˜¯å¦æ­£ç¡®

### 6.5 è¿ç»´ç›‘æ§å»ºè®®


**ğŸ“Š æƒé™ç³»ç»Ÿç›‘æ§æŒ‡æ ‡**ï¼š
- **æƒé™æŸ¥è¯¢å“åº”æ—¶é—´** - ç›‘æ§æƒé™éªŒè¯çš„æ€§èƒ½
- **ç¼“å­˜å‘½ä¸­ç‡** - è¯„ä¼°ç¼“å­˜ç­–ç•¥çš„æœ‰æ•ˆæ€§  
- **æƒé™å˜æ›´é¢‘ç‡** - è§‚å¯Ÿç³»ç»Ÿæƒé™å˜åŒ–è¶‹åŠ¿
- **å¼‚å¸¸æƒé™è¯·æ±‚** - å‘ç°æ½œåœ¨çš„å®‰å…¨é—®é¢˜

**æ ¸å¿ƒè®°å¿†**ï¼š
- RBACé—®é¢˜90%éƒ½æ˜¯ç¼“å­˜åŒæ­¥é—®é¢˜ï¼Œå…ˆæ¸…ç¼“å­˜å†æ’æŸ¥
- æƒé™æ€§èƒ½ä¼˜åŒ–çš„å…³é”®æ˜¯ç¼“å­˜ç­–ç•¥ï¼Œç¼“å­˜å±‚æ¬¡è¦åˆ†æ˜
- Tokenåˆ·æ–°æ—¶å¿…é¡»åŒæ­¥æœ€æ–°æƒé™ï¼Œé¿å…æƒé™"å€’é€€"
- æ•°æ®æƒé™å†²çªç”¨ç­–ç•¥æ¨¡å¼è§£å†³ï¼Œå¯é…ç½®åŒ–ç®¡ç†