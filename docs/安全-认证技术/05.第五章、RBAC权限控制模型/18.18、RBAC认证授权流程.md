---
title: 18ã€RBACè®¤è¯æˆæƒæµç¨‹
---
## ğŸ“š ç›®å½•

1. [RBACåŸºç¡€æ¦‚å¿µ](#1-RBACåŸºç¡€æ¦‚å¿µ)
2. [ç™»å½•è®¤è¯æµç¨‹](#2-ç™»å½•è®¤è¯æµç¨‹)
3. [Tokenç”Ÿæˆä¸éªŒè¯](#3-Tokenç”Ÿæˆä¸éªŒè¯)
4. [æƒé™æ£€æŸ¥æœºåˆ¶](#4-æƒé™æ£€æŸ¥æœºåˆ¶)
5. [ä¼šè¯ç®¡ç†](#5-ä¼šè¯ç®¡ç†)
6. [å•ç‚¹ç™»å½•SSO](#6-å•ç‚¹ç™»å½•SSO)
7. [æƒé™ç¼“å­˜ç­–ç•¥](#7-æƒé™ç¼“å­˜ç­–ç•¥)
8. [å®‰å…¨é˜²æŠ¤æªæ–½](#8-å®‰å…¨é˜²æŠ¤æªæ–½)
9. [æƒé™åˆ·æ–°æœºåˆ¶](#9-æƒé™åˆ·æ–°æœºåˆ¶)
10. [æƒé™æ£€æŸ¥æ ¸å¿ƒç®—æ³•](#10-æƒé™æ£€æŸ¥æ ¸å¿ƒç®—æ³•)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ RBACåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯RBAC


**RBAC**ï¼ˆRole-Based Access Controlï¼‰ç¿»è¯‘è¿‡æ¥å°±æ˜¯ **"åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶"**ï¼Œå¬èµ·æ¥å¾ˆé«˜å¤§ä¸Šï¼Œå…¶å®å°±æ˜¯**æŒ‰èŒä½åˆ†é…æƒé™**çš„ç®¡ç†æ–¹å¼ã€‚

> ğŸ’¡ **é€šä¿—ç†è§£**ï¼šå°±åƒå…¬å¸é‡Œä¸åŒèŒä½çš„äººæœ‰ä¸åŒçš„æƒé™
> - æ™®é€šå‘˜å·¥ï¼šåªèƒ½æŸ¥çœ‹è‡ªå·±çš„å·¥èµ„æ¡
> - éƒ¨é—¨ç»ç†ï¼šèƒ½æŸ¥çœ‹éƒ¨é—¨æ‰€æœ‰äººçš„å·¥èµ„
> - HRï¼šèƒ½ç®¡ç†æ‰€æœ‰å‘˜å·¥ä¿¡æ¯
> - è´¢åŠ¡ï¼šèƒ½å¤„ç†è´¢åŠ¡ç›¸å…³æ“ä½œ

### 1.2 RBACæ ¸å¿ƒè¦ç´ 


```
ç”¨æˆ·(User) â† åˆ†é… â†’ è§’è‰²(Role) â† æˆäºˆ â†’ æƒé™(Permission)
```

**ğŸ”¸ ç”¨æˆ·(User)**ï¼šå°±æ˜¯ä½¿ç”¨ç³»ç»Ÿçš„äºº
- å¼ ä¸‰ã€æå››ã€ç‹äº”è¿™äº›å…·ä½“çš„äºº

**ğŸ”¸ è§’è‰²(Role)**ï¼šå°±æ˜¯èŒä½æˆ–èº«ä»½
- ç®¡ç†å‘˜ã€æ™®é€šç”¨æˆ·ã€è´¢åŠ¡ã€HRç­‰

**ğŸ”¸ æƒé™(Permission)**ï¼šå°±æ˜¯èƒ½åšä»€ä¹ˆäº‹
- æŸ¥çœ‹æ–‡ç« ã€åˆ é™¤ç”¨æˆ·ã€ä¿®æ”¹è®¾ç½®ç­‰

### 1.3 RBACæ¶æ„å›¾ç¤º


```
         ç”¨æˆ·ç®¡ç†ç³»ç»Ÿæ¶æ„
    
ç”¨æˆ·å±‚      è§’è‰²å±‚        æƒé™å±‚       èµ„æºå±‚
â”Œâ”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚å¼ ä¸‰ â”‚â”€â”€â”€â”‚ ç®¡ç†å‘˜  â”‚â”€â”€â”€â”‚ ç”¨æˆ·ç®¡ç† â”‚â”€â”€â”€â”‚ ç”¨æˆ·åˆ—è¡¨ â”‚
â”œâ”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚æå›› â”‚â”€â”€â”€â”‚ ç¼–è¾‘è€…  â”‚â”€â”€â”€â”‚ å†…å®¹ç¼–è¾‘ â”‚â”€â”€â”€â”‚ æ–‡ç« ç®¡ç† â”‚
â”œâ”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ç‹äº” â”‚â”€â”€â”€â”‚æ™®é€šç”¨æˆ· â”‚â”€â”€â”€â”‚ æŸ¥çœ‹æƒé™ â”‚â”€â”€â”€â”‚ ä¸ªäººä¿¡æ¯ â”‚
â””â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.4 ä¸ºä»€ä¹ˆè¦ç”¨RBAC


**ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜**ï¼š
```
ç›´æ¥ç»™ç”¨æˆ·åˆ†é…æƒé™ï¼š
å¼ ä¸‰ â†’ ç”¨æˆ·ç®¡ç†ã€æ–‡ç« ç®¡ç†ã€ç³»ç»Ÿè®¾ç½®...
æå›› â†’ ç”¨æˆ·ç®¡ç†ã€æ–‡ç« ç®¡ç†ã€ç³»ç»Ÿè®¾ç½®...
ç‹äº” â†’ ç”¨æˆ·ç®¡ç†ã€æ–‡ç« ç®¡ç†ã€ç³»ç»Ÿè®¾ç½®...

é—®é¢˜ï¼š
âŒ ç®¡ç†å¤æ‚ï¼šæ¯ä¸ªäººéƒ½è¦å•ç‹¬é…ç½®
âŒ å®¹æ˜“å‡ºé”™ï¼šå¿˜è®°åˆ†é…æŸä¸ªæƒé™
âŒ éš¾ä»¥ç»´æŠ¤ï¼šäººå‘˜å˜åŠ¨æ—¶è¦é‡æ–°é…ç½®
```

**RBACæ–¹å¼çš„ä¼˜åŠ¿**ï¼š
```
é€šè¿‡è§’è‰²ç®¡ç†æƒé™ï¼š
åˆ›å»ºè§’è‰² â†’ ç»™è§’è‰²åˆ†é…æƒé™ â†’ æŠŠç”¨æˆ·åˆ†é…åˆ°è§’è‰²

ä¼˜åŠ¿ï¼š
âœ… ç®¡ç†ç®€å•ï¼šæŒ‰è§’è‰²ç»Ÿä¸€ç®¡ç†
âœ… ä¸æ˜“å‡ºé”™ï¼šè§’è‰²æƒé™é…ç½®ä¸€æ¬¡å³å¯
âœ… æ˜“äºç»´æŠ¤ï¼šæ–°å‘˜å·¥ç›´æ¥åˆ†é…å¯¹åº”è§’è‰²
```

---

## 2. ğŸ” ç™»å½•è®¤è¯æµç¨‹


### 2.1 ç™»å½•è®¤è¯æ˜¯ä»€ä¹ˆ


**ç™»å½•è®¤è¯**å°±æ˜¯éªŒè¯ **"ä½ æ˜¯è°"** çš„è¿‡ç¨‹ï¼Œå°±åƒé—¨å«æ£€æŸ¥ä½ çš„å·¥ä½œè¯ä¸€æ ·ã€‚

> ğŸ“ **æ ¸å¿ƒç›®çš„**ï¼šç¡®è®¤ç”¨æˆ·èº«ä»½çš„çœŸå®æ€§

### 2.2 å®Œæ•´ç™»å½•æµç¨‹å›¾ç¤º


```
ç”¨æˆ·ç«¯                    æœåŠ¡ç«¯                   æ•°æ®åº“
  |                        |                        |
  |--[1]è¾“å…¥ç”¨æˆ·åå¯†ç ----->|                        |
  |                        |--[2]æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯------>|
  |                        |<--[3]è¿”å›ç”¨æˆ·æ•°æ®------|
  |                        |                        |
  |                        |--[4]å¯†ç éªŒè¯å¤„ç†       |
  |                        |                        |
  |<--[5]è¿”å›ç™»å½•ç»“æœ------|                        |
  |   (æˆåŠŸï¼šè¿”å›Token)     |                        |
  |   (å¤±è´¥ï¼šè¿”å›é”™è¯¯ä¿¡æ¯)   |                        |
```

### 2.3 ç™»å½•è®¤è¯è¯¦ç»†æ­¥éª¤


**æ­¥éª¤1ï¼šç”¨æˆ·æäº¤å‡­è¯**
```javascript
// ç”¨æˆ·åœ¨å‰ç«¯è¾“å…¥ç”¨æˆ·åå’Œå¯†ç 
const loginData = {
    username: "zhangsan",
    password: "123456"
};
```

**æ­¥éª¤2ï¼šæœåŠ¡ç«¯æ¥æ”¶å¤„ç†**
```javascript
// åç«¯æ¥æ”¶ç™»å½•è¯·æ±‚
app.post('/login', (req, res) => {
    const { username, password } = req.body;
    
    // æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
    const user = findUserByUsername(username);
    
    // éªŒè¯ç”¨æˆ·å­˜åœ¨æ€§
    if (!user) {
        return res.json({ error: 'ç”¨æˆ·ä¸å­˜åœ¨' });
    }
    
    // éªŒè¯å¯†ç æ­£ç¡®æ€§
    if (!verifyPassword(password, user.password)) {
        return res.json({ error: 'å¯†ç é”™è¯¯' });
    }
    
    // ç”Ÿæˆè®¿é—®ä»¤ç‰Œ
    const token = generateToken(user);
    res.json({ success: true, token: token });
});
```

**æ­¥éª¤3ï¼šå¯†ç éªŒè¯æœºåˆ¶**
```javascript
// å¯†ç åŠ å¯†å­˜å‚¨ï¼ˆæ³¨å†Œæ—¶ï¼‰
function hashPassword(plainPassword) {
    return bcrypt.hashSync(plainPassword, 10);
}

// å¯†ç éªŒè¯ï¼ˆç™»å½•æ—¶ï¼‰
function verifyPassword(plainPassword, hashedPassword) {
    return bcrypt.compareSync(plainPassword, hashedPassword);
}
```

> âš ï¸ **å®‰å…¨æé†’**ï¼šå¯†ç ç»å¯¹ä¸èƒ½æ˜æ–‡å­˜å‚¨ï¼Œå¿…é¡»åŠ å¯†ï¼

### 2.4 ç™»å½•çŠ¶æ€è¯´æ˜


| ç™»å½•ç»“æœ | **è¿”å›ä¿¡æ¯** | **ç”¨æˆ·çŠ¶æ€** | **åç»­æ“ä½œ** |
|---------|-------------|-------------|-------------|
| âœ… **æˆåŠŸ** | `è¿”å›Tokenå’Œç”¨æˆ·ä¿¡æ¯` | `å·²è®¤è¯çŠ¶æ€` | `å¯ä»¥è®¿é—®å—ä¿æŠ¤èµ„æº` |
| âŒ **ç”¨æˆ·ä¸å­˜åœ¨** | `ç”¨æˆ·åä¸å­˜åœ¨` | `æœªè®¤è¯çŠ¶æ€` | `æç¤ºæ³¨å†Œæˆ–æ£€æŸ¥ç”¨æˆ·å` |
| âŒ **å¯†ç é”™è¯¯** | `å¯†ç ä¸æ­£ç¡®` | `æœªè®¤è¯çŠ¶æ€` | `é‡æ–°è¾“å…¥æˆ–æ‰¾å›å¯†ç ` |
| âŒ **è´¦æˆ·é”å®š** | `è´¦æˆ·å·²è¢«é”å®š` | `é”å®šçŠ¶æ€` | `è”ç³»ç®¡ç†å‘˜æˆ–ç­‰å¾…è§£é”` |

---

## 3. ğŸ« Tokenç”Ÿæˆä¸éªŒè¯


### 3.1 ä»€ä¹ˆæ˜¯Token


**Token**å°±æ˜¯ä¸€å¼  **"é€šè¡Œè¯"**ï¼Œå°±åƒä½ è¿›å…¥å°åŒºæ—¶é—¨å«ç»™ä½ çš„ä¸´æ—¶å¡ç‰‡ã€‚

> ğŸ’¡ **é€šä¿—æ¯”å–»**ï¼š
> - ç™»å½•æˆåŠŸ = é—¨å«éªŒè¯äº†ä½ çš„èº«ä»½è¯
> - è·å¾—Token = é—¨å«ç»™ä½ ä¸€å¼ ä¸´æ—¶é€šè¡Œè¯
> - è®¿é—®èµ„æº = ç”¨é€šè¡Œè¯åˆ·å¡è¿›å…¥å„ä¸ªåŒºåŸŸ

### 3.2 JWT Tokenç»“æ„


**JWT**ï¼ˆJSON Web Tokenï¼‰æ˜¯æœ€å¸¸ç”¨çš„Tokenæ ¼å¼ï¼Œç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š

```
JWT Token ç»“æ„ï¼š
Header.Payload.Signature

ç¤ºä¾‹ï¼š
eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjoxLCJ1c2VybmFtZSI6InpoYW5nc2FuIn0.signature_hash
    â†‘                                      â†‘                                    â†‘
  Header                                Payload                             Signature
  (å¤´éƒ¨)                                (è½½è·)                               (ç­¾å)
```

### 3.3 JWTå„éƒ¨åˆ†è¯¦è§£


**ğŸ”¸ Headerï¼ˆå¤´éƒ¨ï¼‰**
```javascript
// åŒ…å«ä»¤ç‰Œç±»å‹å’Œç­¾åç®—æ³•
{
  "typ": "JWT",           // ä»¤ç‰Œç±»å‹
  "alg": "HS256"         // ç­¾åç®—æ³•
}
```

**ğŸ”¸ Payloadï¼ˆè½½è·ï¼‰**
```javascript
// åŒ…å«ç”¨æˆ·ä¿¡æ¯å’Œå…¶ä»–å£°æ˜
{
  "user_id": 1,                    // ç”¨æˆ·ID
  "username": "zhangsan",          // ç”¨æˆ·å
  "role": "admin",                 // ç”¨æˆ·è§’è‰²
  "exp": 1640995200,              // è¿‡æœŸæ—¶é—´æˆ³
  "iat": 1640908800               // ç­¾å‘æ—¶é—´æˆ³
}
```

**ğŸ”¸ Signatureï¼ˆç­¾åï¼‰**
```javascript
// é˜²ç¯¡æ”¹çš„æ•°å­—ç­¾å
HMACSHA256(
  base64UrlEncode(header) + "." +
  base64UrlEncode(payload),
  secret_key                       // æœåŠ¡ç«¯å¯†é’¥
)
```

### 3.4 Tokenç”Ÿæˆä»£ç ç¤ºä¾‹


```javascript
const jwt = require('jsonwebtoken');

// Tokenç”Ÿæˆå‡½æ•°
function generateToken(user) {
    const payload = {
        user_id: user.id,
        username: user.username,
        role: user.role,
        exp: Math.floor(Date.now() / 1000) + (24 * 60 * 60) // 24å°æ—¶åè¿‡æœŸ
    };
    
    const secret = 'your_secret_key';
    return jwt.sign(payload, secret);
}

// ä½¿ç”¨ç¤ºä¾‹
const user = { id: 1, username: 'zhangsan', role: 'admin' };
const token = generateToken(user);
console.log('ç”Ÿæˆçš„Token:', token);
```

### 3.5 TokenéªŒè¯æµç¨‹


```
å®¢æˆ·ç«¯è¯·æ±‚æµç¨‹ï¼š
1. å®¢æˆ·ç«¯åœ¨è¯·æ±‚å¤´ä¸­æºå¸¦Token
2. æœåŠ¡ç«¯éªŒè¯Tokençš„æœ‰æ•ˆæ€§
3. è§£æTokenè·å–ç”¨æˆ·ä¿¡æ¯
4. æ ¹æ®ç”¨æˆ·ä¿¡æ¯è¿›è¡Œæƒé™æ£€æŸ¥

éªŒè¯æ­¥éª¤ï¼š
éªŒè¯ç­¾å â†’ æ£€æŸ¥è¿‡æœŸæ—¶é—´ â†’ æå–ç”¨æˆ·ä¿¡æ¯ â†’ æƒé™éªŒè¯
```

```javascript
// TokenéªŒè¯ä¸­é—´ä»¶
function verifyToken(req, res, next) {
    // ä»è¯·æ±‚å¤´è·å–Token
    const token = req.headers.authorization?.replace('Bearer ', '');
    
    if (!token) {
        return res.status(401).json({ error: 'ç¼ºå°‘è®¿é—®ä»¤ç‰Œ' });
    }
    
    try {
        // éªŒè¯å¹¶è§£æToken
        const decoded = jwt.verify(token, 'your_secret_key');
        
        // æ£€æŸ¥Tokenæ˜¯å¦è¿‡æœŸ
        if (decoded.exp < Date.now() / 1000) {
            return res.status(401).json({ error: 'Tokenå·²è¿‡æœŸ' });
        }
        
        // å°†ç”¨æˆ·ä¿¡æ¯é™„åŠ åˆ°è¯·æ±‚å¯¹è±¡
        req.user = decoded;
        next();
        
    } catch (error) {
        return res.status(401).json({ error: 'Tokenæ— æ•ˆ' });
    }
}
```

### 3.6 Tokenä½¿ç”¨æœ€ä½³å®è·µ


> ğŸ”§ **Tokenå®‰å…¨ä½¿ç”¨å»ºè®®**ï¼š
> - âœ… è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´ï¼ˆä¸è¦å¤ªé•¿ï¼‰
> - âœ… ä½¿ç”¨HTTPSä¼ è¾“ï¼ˆé˜²æ­¢Tokenè¢«æˆªè·ï¼‰
> - âœ… å®¢æˆ·ç«¯å®‰å…¨å­˜å‚¨ï¼ˆé¿å…XSSæ”»å‡»ï¼‰
> - âœ… æä¾›Tokenåˆ·æ–°æœºåˆ¶
> - âœ… æ•æ„Ÿæ“ä½œéœ€è¦é‡æ–°éªŒè¯

---

## 4. âœ… æƒé™æ£€æŸ¥æœºåˆ¶


### 4.1 æƒé™æ£€æŸ¥çš„æœ¬è´¨


**æƒé™æ£€æŸ¥**å°±æ˜¯éªŒè¯ **"ä½ èƒ½åšä»€ä¹ˆ"** çš„è¿‡ç¨‹ï¼Œå°±åƒæ£€æŸ¥ä½ çš„é€šè¡Œè¯èƒ½è¿›å…¥å“ªäº›æˆ¿é—´ã€‚

> ğŸ“ **æ ¸å¿ƒç›®çš„**ï¼šç¡®ä¿ç”¨æˆ·åªèƒ½è®¿é—®è¢«æˆæƒçš„èµ„æºå’ŒåŠŸèƒ½

### 4.2 æƒé™æ£€æŸ¥æµç¨‹å›¾


```
ç”¨æˆ·è¯·æ±‚ â†’ TokenéªŒè¯ â†’ æå–ç”¨æˆ·ä¿¡æ¯ â†’ æŸ¥è¯¢ç”¨æˆ·æƒé™ â†’ æƒé™åŒ¹é… â†’ å…è®¸/æ‹’ç»è®¿é—®

è¯¦ç»†æµç¨‹ï¼š
å®¢æˆ·ç«¯                    æƒé™æ£€æŸ¥ä¸­é—´ä»¶              æƒé™æ•°æ®åº“
  |                           |                        |
  |--[1]æºå¸¦Tokenå‘èµ·è¯·æ±‚---->|                        |
  |                           |--[2]éªŒè¯Token--------->|
  |                           |<--[3]è¿”å›ç”¨æˆ·è§’è‰²------|
  |                           |                        |
  |                           |--[4]æŸ¥è¯¢è§’è‰²æƒé™------>|
  |                           |<--[5]è¿”å›æƒé™åˆ—è¡¨------|
  |                           |                        |
  |                           |--[6]æƒé™åŒ¹é…æ£€æŸ¥       |
  |                           |                        |
  |<--[7]è¿”å›æ£€æŸ¥ç»“æœ---------|                        |
```

### 4.3 æƒé™æ•°æ®ç»“æ„è®¾è®¡


```javascript
// ç”¨æˆ·è¡¨
const users = [
    { id: 1, username: 'zhangsan', role_ids: [1, 2] }  // ä¸€ä¸ªç”¨æˆ·å¯æœ‰å¤šä¸ªè§’è‰²
];

// è§’è‰²è¡¨
const roles = [
    { id: 1, name: 'admin', description: 'ç®¡ç†å‘˜' },
    { id: 2, name: 'editor', description: 'ç¼–è¾‘è€…' }
];

// æƒé™è¡¨
const permissions = [
    { id: 1, name: 'user:read', description: 'æŸ¥çœ‹ç”¨æˆ·' },
    { id: 2, name: 'user:write', description: 'ç¼–è¾‘ç”¨æˆ·' },
    { id: 3, name: 'article:read', description: 'æŸ¥çœ‹æ–‡ç« ' },
    { id: 4, name: 'article:write', description: 'ç¼–è¾‘æ–‡ç« ' }
];

// è§’è‰²æƒé™å…³è”è¡¨
const role_permissions = [
    { role_id: 1, permission_id: 1 },  // ç®¡ç†å‘˜æœ‰æŸ¥çœ‹ç”¨æˆ·æƒé™
    { role_id: 1, permission_id: 2 },  // ç®¡ç†å‘˜æœ‰ç¼–è¾‘ç”¨æˆ·æƒé™
    { role_id: 2, permission_id: 3 },  // ç¼–è¾‘è€…æœ‰æŸ¥çœ‹æ–‡ç« æƒé™
    { role_id: 2, permission_id: 4 }   // ç¼–è¾‘è€…æœ‰ç¼–è¾‘æ–‡ç« æƒé™
];
```

### 4.4 æƒé™æ£€æŸ¥æ ¸å¿ƒä»£ç 


```javascript
// æƒé™æ£€æŸ¥ä¸­é—´ä»¶
function checkPermission(requiredPermission) {
    return async (req, res, next) => {
        try {
            // ä»Tokenä¸­è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆå‰é¢å·²éªŒè¯è¿‡Tokenï¼‰
            const userId = req.user.user_id;
            
            // è·å–ç”¨æˆ·çš„æ‰€æœ‰æƒé™
            const userPermissions = await getUserPermissions(userId);
            
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰æ‰€éœ€æƒé™
            if (userPermissions.includes(requiredPermission)) {
                next(); // æœ‰æƒé™ï¼Œç»§ç»­æ‰§è¡Œ
            } else {
                res.status(403).json({ 
                    error: 'æƒé™ä¸è¶³', 
                    required: requiredPermission 
                });
            }
            
        } catch (error) {
            res.status(500).json({ error: 'æƒé™æ£€æŸ¥å¤±è´¥' });
        }
    };
}

// è·å–ç”¨æˆ·æƒé™çš„å‡½æ•°
async function getUserPermissions(userId) {
    // 1. æ ¹æ®ç”¨æˆ·IDè·å–ç”¨æˆ·è§’è‰²
    const userRoles = await getUserRoles(userId);
    
    // 2. æ ¹æ®è§’è‰²è·å–æƒé™åˆ—è¡¨
    let permissions = [];
    for (const role of userRoles) {
        const rolePermissions = await getRolePermissions(role.id);
        permissions = permissions.concat(rolePermissions);
    }
    
    // 3. å»é‡å¹¶è¿”å›æƒé™åˆ—è¡¨
    return [...new Set(permissions)];
}
```

### 4.5 å®é™…ä½¿ç”¨ç¤ºä¾‹


```javascript
// è·¯ç”±ä¸­ä½¿ç”¨æƒé™æ£€æŸ¥
app.get('/api/users', 
    verifyToken,                    // å…ˆéªŒè¯Token
    checkPermission('user:read'),   // å†æ£€æŸ¥æƒé™
    (req, res) => {
        // æœ‰æƒé™æ‰èƒ½æ‰§è¡Œçš„ä»£ç 
        res.json({ users: getAllUsers() });
    }
);

app.post('/api/users', 
    verifyToken,
    checkPermission('user:write'),
    (req, res) => {
        // åˆ›å»ºæ–°ç”¨æˆ·çš„ä»£ç 
        const newUser = createUser(req.body);
        res.json({ success: true, user: newUser });
    }
);
```

### 4.6 æƒé™æ£€æŸ¥å±‚çº§


```
ä¸åŒå±‚çº§çš„æƒé™æ§åˆ¶ï¼š

ğŸ”¹ è·¯ç”±çº§æƒé™æ§åˆ¶
app.get('/admin/*', checkPermission('admin:access'), ...)

ğŸ”¹ åŠŸèƒ½çº§æƒé™æ§åˆ¶  
function deleteUser() {
    if (!hasPermission('user:delete')) {
        throw new Error('æ— æƒé™åˆ é™¤ç”¨æˆ·');
    }
}

ğŸ”¹ æ•°æ®çº§æƒé™æ§åˆ¶
function getUserData(userId) {
    if (currentUser.id !== userId && !hasPermission('user:view_all')) {
        throw new Error('åªèƒ½æŸ¥çœ‹è‡ªå·±çš„æ•°æ®');
    }
}
```

> ğŸ’¡ **æƒé™æ£€æŸ¥ç²’åº¦è¯´æ˜**ï¼š
> - **ç²—ç²’åº¦**ï¼šé¡µé¢çº§æƒé™ï¼ˆèƒ½å¦è®¿é—®æŸä¸ªé¡µé¢ï¼‰
> - **ä¸­ç²’åº¦**ï¼šåŠŸèƒ½çº§æƒé™ï¼ˆèƒ½å¦ä½¿ç”¨æŸä¸ªåŠŸèƒ½ï¼‰
> - **ç»†ç²’åº¦**ï¼šæ•°æ®çº§æƒé™ï¼ˆèƒ½å¦è®¿é—®æŸæ¡å…·ä½“æ•°æ®ï¼‰

---

## 5. ğŸ• ä¼šè¯ç®¡ç†


### 5.1 ä»€ä¹ˆæ˜¯ä¼šè¯ç®¡ç†


**ä¼šè¯ç®¡ç†**å°±æ˜¯ç®¡ç†ç”¨æˆ· **"åœ¨çº¿çŠ¶æ€"** çš„æœºåˆ¶ï¼Œå°±åƒç®¡ç†è°æ­£åœ¨ä½¿ç”¨ç³»ç»Ÿã€ä½¿ç”¨å¤šé•¿æ—¶é—´äº†ã€‚

> ğŸ’¡ **é€šä¿—ç†è§£**ï¼š
> - å°±åƒå›¾ä¹¦é¦†ç®¡ç†è¯»è€…çš„å€Ÿé˜…å¡
> - è®°å½•è°è¿›æ¥äº†ã€ä»€ä¹ˆæ—¶å€™è¿›æ¥çš„ã€ä»€ä¹ˆæ—¶å€™è¯¥ç¦»å¼€
> - ç¡®ä¿åªæœ‰æœ‰æ•ˆçš„è¯»è€…èƒ½ä½¿ç”¨å›¾ä¹¦é¦†èµ„æº

### 5.2 ä¼šè¯çš„ç”Ÿå‘½å‘¨æœŸ


```
ä¼šè¯ç”Ÿå‘½å‘¨æœŸå›¾ç¤ºï¼š

åˆ›å»ºä¼šè¯ â†’ ä¼šè¯æ´»è·ƒ â†’ ä¼šè¯ç»­æœŸ â†’ ä¼šè¯å¤±æ•ˆ

   â†“           â†“           â†“           â†“
ç”¨æˆ·ç™»å½•    æ­£å¸¸ä½¿ç”¨     åˆ·æ–°Token   ç™»å‡º/è¿‡æœŸ
```

### 5.3 ä¸¤ç§ä¼šè¯ç®¡ç†æ–¹å¼


**ğŸ”¸ æœåŠ¡ç«¯ä¼šè¯ï¼ˆSessionï¼‰**
```
ç‰¹ç‚¹ï¼š
- ä¼šè¯æ•°æ®å­˜å‚¨åœ¨æœåŠ¡ç«¯
- å®¢æˆ·ç«¯åªä¿å­˜Session ID
- æœåŠ¡ç«¯æ§åˆ¶ä¼šè¯çŠ¶æ€

æµç¨‹ï¼š
ç”¨æˆ·ç™»å½• â†’ æœåŠ¡ç«¯åˆ›å»ºSession â†’ è¿”å›Session ID â†’ å®¢æˆ·ç«¯ä¿å­˜Cookie
```

**ğŸ”¸ æ— çŠ¶æ€ä¼šè¯ï¼ˆTokenï¼‰**
```
ç‰¹ç‚¹ï¼š
- ä¼šè¯ä¿¡æ¯åŒ…å«åœ¨Tokenä¸­
- æœåŠ¡ç«¯ä¸å­˜å‚¨ä¼šè¯çŠ¶æ€  
- é€šè¿‡TokenéªŒè¯ç”¨æˆ·çŠ¶æ€

æµç¨‹ï¼š
ç”¨æˆ·ç™»å½• â†’ æœåŠ¡ç«¯ç”ŸæˆJWT Token â†’ å®¢æˆ·ç«¯ä¿å­˜Token â†’ è¯·æ±‚æ—¶æºå¸¦Token
```

### 5.4 ä¼šè¯ç®¡ç†æ ¸å¿ƒåŠŸèƒ½


**ğŸ”¹ ä¼šè¯åˆ›å»º**
```javascript
// ç”¨æˆ·ç™»å½•æ—¶åˆ›å»ºä¼šè¯
function createSession(user) {
    const sessionData = {
        user_id: user.id,
        username: user.username,
        login_time: new Date(),
        last_activity: new Date(),
        ip_address: getClientIP(),
        user_agent: getUserAgent()
    };
    
    // Tokenæ–¹å¼
    const token = jwt.sign(sessionData, secret, { expiresIn: '24h' });
    
    return token;
}
```

**ğŸ”¹ ä¼šè¯éªŒè¯**
```javascript
// éªŒè¯ä¼šè¯æ˜¯å¦æœ‰æ•ˆ
function validateSession(req, res, next) {
    const token = req.headers.authorization?.replace('Bearer ', '');
    
    if (!token) {
        return res.status(401).json({ error: 'æœªç™»å½•' });
    }
    
    try {
        const sessionData = jwt.verify(token, secret);
        
        // æ£€æŸ¥ä¼šè¯æ˜¯å¦è¿‡æœŸ
        if (isSessionExpired(sessionData)) {
            return res.status(401).json({ error: 'ä¼šè¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•' });
        }
        
        // æ›´æ–°æœ€åæ´»åŠ¨æ—¶é—´
        updateLastActivity(sessionData.user_id);
        
        req.session = sessionData;
        next();
        
    } catch (error) {
        return res.status(401).json({ error: 'æ— æ•ˆçš„ä¼šè¯' });
    }
}
```

**ğŸ”¹ ä¼šè¯é”€æ¯**
```javascript
// ç”¨æˆ·ç™»å‡ºæ—¶é”€æ¯ä¼šè¯
function destroySession(req, res) {
    // Tokenæ–¹å¼ï¼šå®¢æˆ·ç«¯åˆ é™¤Tokenå³å¯
    // å¯é€‰ï¼šå°†TokenåŠ å…¥é»‘åå•
    addToBlacklist(req.headers.authorization);
    
    res.json({ message: 'ç™»å‡ºæˆåŠŸ' });
}
```

### 5.5 ä¼šè¯è¶…æ—¶å¤„ç†


```javascript
// ä¼šè¯è¶…æ—¶é…ç½®
const SESSION_CONFIG = {
    MAX_IDLE_TIME: 30 * 60 * 1000,    // 30åˆ†é’Ÿæ— æ“ä½œè¶…æ—¶
    MAX_SESSION_TIME: 8 * 60 * 60 * 1000,  // 8å°æ—¶ç»å¯¹è¶…æ—¶
    REFRESH_THRESHOLD: 15 * 60 * 1000      // å‰©ä½™15åˆ†é’Ÿæ—¶æé†’åˆ·æ–°
};

// æ£€æŸ¥ä¼šè¯æ˜¯å¦è¶…æ—¶
function isSessionExpired(sessionData) {
    const now = Date.now();
    const loginTime = new Date(sessionData.login_time).getTime();
    const lastActivity = new Date(sessionData.last_activity).getTime();
    
    // æ£€æŸ¥ç»å¯¹è¶…æ—¶
    if (now - loginTime > SESSION_CONFIG.MAX_SESSION_TIME) {
        return true;
    }
    
    // æ£€æŸ¥ç©ºé—²è¶…æ—¶
    if (now - lastActivity > SESSION_CONFIG.MAX_IDLE_TIME) {
        return true;
    }
    
    return false;
}
```

### 5.6 ä¼šè¯å®‰å…¨æªæ–½


> ğŸ”’ **ä¼šè¯å®‰å…¨æœ€ä½³å®è·µ**ï¼š
> 
> **âœ… ä¼šè¯æ ‡è¯†å®‰å…¨**
> - ä½¿ç”¨å¼ºéšæœºæ•°ç”ŸæˆSession ID
> - Tokenä½¿ç”¨å®‰å…¨çš„ç­¾åç®—æ³•
> 
> **âœ… ä¼ è¾“å®‰å…¨**  
> - ä½¿ç”¨HTTPSåŠ å¯†ä¼ è¾“
> - è®¾ç½®å®‰å…¨çš„Cookieå±æ€§
> 
> **âœ… å­˜å‚¨å®‰å…¨**
> - å®¢æˆ·ç«¯å®‰å…¨å­˜å‚¨Token
> - æ•æ„Ÿä¿¡æ¯ä¸æ”¾å…¥Tokenè½½è·
> 
> **âœ… è¶…æ—¶æ§åˆ¶**
> - è®¾ç½®åˆç†çš„ä¼šè¯è¶…æ—¶æ—¶é—´
> - å®ç°è‡ªåŠ¨ç»­æœŸå’Œå¼ºåˆ¶æ³¨é”€

---

## 6. ğŸŒ å•ç‚¹ç™»å½•SSO


### 6.1 ä»€ä¹ˆæ˜¯å•ç‚¹ç™»å½•


**å•ç‚¹ç™»å½•**ï¼ˆSSO - Single Sign Onï¼‰å°±æ˜¯ **"ä¸€æ¬¡ç™»å½•ï¼Œå¤„å¤„é€šè¡Œ"**ï¼Œå°±åƒç”¨ä¸€å¼ å¡å¯ä»¥è¿›å…¥æ•´ä¸ªå›­åŒºçš„æ‰€æœ‰å»ºç­‘ã€‚

> ğŸ’¡ **ç”Ÿæ´»åœºæ™¯ç±»æ¯”**ï¼š
> - ç”¨æ”¯ä»˜å®è´¦å·å¯ä»¥ç™»å½•æ·˜å®ã€å¤©çŒ«ã€é¥¿äº†ä¹ˆ
> - ç”¨Googleè´¦å·å¯ä»¥ç™»å½•YouTubeã€Gmailã€Google Drive
> - ç”¨å¾®ä¿¡å¯ä»¥ç™»å½•å¾ˆå¤šç¬¬ä¸‰æ–¹å°ç¨‹åº

### 6.2 æ²¡æœ‰SSOçš„ç—›ç‚¹


```
ä¼ ç»Ÿå¤šç³»ç»Ÿç™»å½•é—®é¢˜ï¼š

ç³»ç»ŸA          ç³»ç»ŸB          ç³»ç»ŸC
 â†“              â†“              â†“
ç™»å½•A          ç™»å½•B          ç™»å½•C
ç”¨æˆ·åå¯†ç      ç”¨æˆ·åå¯†ç      ç”¨æˆ·åå¯†ç 

é—®é¢˜ï¼š
âŒ ç”¨æˆ·éœ€è¦è®°ä½å¤šå¥—è´¦å·å¯†ç 
âŒ æ¯ä¸ªç³»ç»Ÿéƒ½è¦å•ç‹¬ç™»å½•
âŒ è´¦å·ä¿¡æ¯éš¾ä»¥ç»Ÿä¸€ç®¡ç†
âŒ ç”¨æˆ·ä½“éªŒå·®
```

### 6.3 SSOè§£å†³æ–¹æ¡ˆ


```
SSOç»Ÿä¸€ç™»å½•æ–¹æ¡ˆï¼š

           SSOè®¤è¯ä¸­å¿ƒ
               â†“
    ç»Ÿä¸€ç™»å½• â†’ è·å–å‡­è¯ â†’ è®¿é—®æ‰€æœ‰ç³»ç»Ÿ
               
        ç³»ç»ŸA    ç³»ç»ŸB    ç³»ç»ŸC
         â†‘        â†‘        â†‘
      å‡­è¯éªŒè¯  å‡­è¯éªŒè¯  å‡­è¯éªŒè¯

ä¼˜åŠ¿ï¼š
âœ… ç”¨æˆ·åªéœ€ç™»å½•ä¸€æ¬¡
âœ… ä¸€å¥—è´¦å·å¯†ç 
âœ… ç»Ÿä¸€çš„ç”¨æˆ·ç®¡ç†
âœ… æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ
```

### 6.4 SSOå®ç°æµç¨‹


```
SSOç™»å½•è¯¦ç»†æµç¨‹ï¼š

ç”¨æˆ·           åº”ç”¨ç³»ç»ŸA         SSOè®¤è¯ä¸­å¿ƒ        åº”ç”¨ç³»ç»ŸB
 |                |                   |                |
 |--[1]è®¿é—®ç³»ç»ŸA-->|                   |                |
 |                |--[2]æ£€æŸ¥ç™»å½•çŠ¶æ€->|                |
 |                |<-[3]é‡å®šå‘åˆ°SSO---|                |
 |                                    |                |
 |--[4]åœ¨SSOä¸­å¿ƒç™»å½•----------------->|                |
 |<-[5]è¿”å›è®¤è¯å‡­è¯(Token)------------|                |
 |                                    |                |
 |--[6]æºå¸¦å‡­è¯è®¿é—®ç³»ç»ŸA------------->|                |
 |                |<-[7]éªŒè¯å‡­è¯-----|                |
 |<-[8]è¿”å›ç³»ç»ŸAèµ„æº------------------|                |
 |                                    |                |
 |--[9]è®¿é—®ç³»ç»ŸB----------------------------------->|
 |                                    |               |<-[10]æ£€æŸ¥å‡­è¯
 |                                    |               |
 |<-[11]ç›´æ¥è¿”å›ç³»ç»ŸBèµ„æº---------------------------|
```

### 6.5 SSOæ ¸å¿ƒä»£ç å®ç°


**ğŸ”¸ SSOè®¤è¯ä¸­å¿ƒ**
```javascript
// SSOè®¤è¯æœåŠ¡
class SSOAuthService {
    // ç”¨æˆ·ç™»å½•SSOä¸­å¿ƒ
    async login(username, password) {
        // éªŒè¯ç”¨æˆ·å‡­æ®
        const user = await this.validateUser(username, password);
        if (!user) {
            throw new Error('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯');
        }
        
        // ç”ŸæˆSSO Token
        const ssoToken = this.generateSSOToken(user);
        
        // å­˜å‚¨ç”¨æˆ·ä¼šè¯
        await this.storeSession(user.id, ssoToken);
        
        return {
            user: user,
            sso_token: ssoToken,
            redirect_url: this.getRedirectUrl()
        };
    }
    
    // éªŒè¯SSO Token
    async validateToken(ssoToken) {
        try {
            const payload = jwt.verify(ssoToken, SSO_SECRET);
            const user = await this.getUserById(payload.user_id);
            
            return {
                valid: true,
                user: user
            };
        } catch (error) {
            return { valid: false };
        }
    }
}
```

**ğŸ”¸ åº”ç”¨ç³»ç»Ÿé›†æˆSSO**
```javascript
// åº”ç”¨ç³»ç»Ÿçš„SSOä¸­é—´ä»¶
function ssoAuthMiddleware(req, res, next) {
    // æ£€æŸ¥æœ¬åœ°ä¼šè¯
    const localToken = req.headers.authorization;
    if (localToken && isValidLocalToken(localToken)) {
        return next();
    }
    
    // æ£€æŸ¥SSO Token
    const ssoToken = req.query.sso_token || req.headers['sso-token'];
    if (ssoToken) {
        // å‘SSOä¸­å¿ƒéªŒè¯Token
        validateSSOToken(ssoToken)
            .then(result => {
                if (result.valid) {
                    // åˆ›å»ºæœ¬åœ°ä¼šè¯
                    const localToken = createLocalSession(result.user);
                    req.user = result.user;
                    req.local_token = localToken;
                    next();
                } else {
                    redirectToSSO(res);
                }
            })
            .catch(() => redirectToSSO(res));
    } else {
        redirectToSSO(res);
    }
}

// é‡å®šå‘åˆ°SSOç™»å½•é¡µ
function redirectToSSO(res) {
    const ssoLoginUrl = `${SSO_SERVER}/login?redirect=${encodeURIComponent(getCurrentUrl())}`;
    res.redirect(ssoLoginUrl);
}
```

### 6.6 SSOæ³¨é”€æµç¨‹


```
SSOå…¨å±€æ³¨é”€æµç¨‹ï¼š

ç”¨æˆ·              ç³»ç»ŸA            SSOä¸­å¿ƒ           ç³»ç»ŸB
 |                 |                 |                |
 |--[1]ç‚¹å‡»æ³¨é”€--->|                 |                |
 |                 |--[2]è¯·æ±‚å…¨å±€æ³¨é”€->|                |
 |                 |                 |--[3]é€šçŸ¥ç³»ç»ŸB->|
 |                 |                 |<-[4]ç¡®è®¤æ³¨é”€---|
 |                 |<-[5]æ¸…ç†ä¼šè¯-----|                |
 |<-[6]æ³¨é”€å®Œæˆ----|                 |                |
```

```javascript
// SSOå…¨å±€æ³¨é”€
async function globalLogout(ssoToken) {
    // éªŒè¯Token
    const tokenData = jwt.verify(ssoToken, SSO_SECRET);
    
    // è·å–ç”¨æˆ·åœ¨æ‰€æœ‰ç³»ç»Ÿçš„ä¼šè¯
    const userSessions = await getUserSessions(tokenData.user_id);
    
    // é€šçŸ¥æ‰€æœ‰æ¥å…¥çš„åº”ç”¨ç³»ç»Ÿ
    const logoutPromises = userSessions.map(session => {
        return notifyAppLogout(session.app_id, session.session_id);
    });
    
    await Promise.all(logoutPromises);
    
    // æ¸…ç†SSOä¸­å¿ƒçš„ä¼šè¯
    await clearSSOSession(tokenData.user_id);
    
    return { success: true, message: 'å…¨å±€æ³¨é”€æˆåŠŸ' };
}
```

### 6.7 SSOçš„ä¼˜ç¼ºç‚¹


| æ–¹é¢ | **ä¼˜ç‚¹** | **ç¼ºç‚¹** |
|------|---------|---------|
| **ç”¨æˆ·ä½“éªŒ** | `ä¸€æ¬¡ç™»å½•è®¿é—®æ‰€æœ‰ç³»ç»Ÿ` | `å•ç‚¹æ•…éšœå½±å“æ‰€æœ‰ç³»ç»Ÿ` |
| **å®‰å…¨ç®¡ç†** | `ç»Ÿä¸€çš„è´¦å·å¯†ç ç­–ç•¥` | `æƒé™è®¾è®¡ç›¸å¯¹å¤æ‚` |
| **å¼€å‘ç»´æŠ¤** | `ç»Ÿä¸€ç”¨æˆ·ç®¡ç†` | `éœ€è¦é¢å¤–å¼€å‘SSOä¸­å¿ƒ` |
| **ç³»ç»Ÿé›†æˆ** | `æ–°ç³»ç»Ÿæ¥å…¥ç›¸å¯¹ç®€å•` | `ç³»ç»Ÿé—´éœ€è¦ä¿¡ä»»å…³ç³»` |

> ğŸ¯ **SSOé€‚ç”¨åœºæ™¯**ï¼š
> - ä¼ä¸šå†…éƒ¨å¤šä¸ªç³»ç»Ÿ
> - åŒä¸€å…¬å¸çš„å¤šä¸ªäº§å“
> - éœ€è¦ç»Ÿä¸€ç”¨æˆ·ä½“éªŒçš„åœºæ™¯
> - ç”¨æˆ·ç®¡ç†æˆæœ¬è¾ƒé«˜çš„æƒ…å†µ

---

## 7. ğŸš€ æƒé™ç¼“å­˜ç­–ç•¥


### 7.1 ä¸ºä»€ä¹ˆéœ€è¦æƒé™ç¼“å­˜


**æƒé™ç¼“å­˜**å°±æ˜¯æŠŠç”¨æˆ·çš„æƒé™ä¿¡æ¯ **ä¸´æ—¶å­˜èµ·æ¥**ï¼Œé¿å…æ¯æ¬¡éƒ½å»æ•°æ®åº“æŸ¥è¯¢ï¼Œå°±åƒæŠŠå¸¸ç”¨çš„æ–‡ä»¶æ”¾åœ¨æ¡Œé¢ä¸Šï¼Œç”¨çš„æ—¶å€™ä¸ç”¨å»æ–‡ä»¶æŸœæ‰¾ã€‚

> ğŸ’¡ **æ€§èƒ½é—®é¢˜åœºæ™¯**ï¼š
> ```
> ç”¨æˆ·æ¯æ¬¡æ“ä½œéƒ½è¦æŸ¥è¯¢æƒé™ï¼š
> 1. ç”¨æˆ·ç‚¹å‡»"æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨" â†’ æŸ¥æ•°æ®åº“ç¡®è®¤æƒé™ â†’ æ˜¾ç¤ºåˆ—è¡¨
> 2. ç”¨æˆ·ç‚¹å‡»"ç¼–è¾‘ç”¨æˆ·" â†’ æŸ¥æ•°æ®åº“ç¡®è®¤æƒé™ â†’ æ˜¾ç¤ºç¼–è¾‘é¡µ
> 3. ç”¨æˆ·ç‚¹å‡»"åˆ é™¤ç”¨æˆ·" â†’ æŸ¥æ•°æ®åº“ç¡®è®¤æƒé™ â†’ æ‰§è¡Œåˆ é™¤
> 
> é—®é¢˜ï¼š
> âŒ æ¯ä¸ªæ“ä½œéƒ½è¦æŸ¥æ•°æ®åº“ï¼Œæ€§èƒ½å·®
> âŒ æ•°æ®åº“å‹åŠ›å¤§
> âŒ ç”¨æˆ·ä½“éªŒä¸æµç•…
> ```

### 7.2 æƒé™ç¼“å­˜æ¶æ„å›¾


```
æƒé™ç¼“å­˜æ¶æ„ï¼š

ç”¨æˆ·è¯·æ±‚ â†’ æƒé™æ£€æŸ¥ä¸­é—´ä»¶ â†’ ç¼“å­˜æ£€æŸ¥ â†’ è¿”å›æƒé™ç»“æœ
                              â†“
                          ç¼“å­˜å‘½ä¸­ï¼Ÿ
                         â†™        â†˜
                    æ˜¯/ä½¿ç”¨ç¼“å­˜    å¦/æŸ¥è¯¢æ•°æ®åº“
                                    â†“
                                å­˜å…¥ç¼“å­˜ â† æ•°æ®åº“æŸ¥è¯¢
```

### 7.3 ç¼“å­˜ç­–ç•¥ç±»å‹


**ğŸ”¸ å†…å­˜ç¼“å­˜ï¼ˆé€‚åˆå•æœºï¼‰**
```javascript
// ä½¿ç”¨Mapå®ç°å†…å­˜ç¼“å­˜
class MemoryPermissionCache {
    constructor() {
        this.cache = new Map();
        this.expireTime = 30 * 60 * 1000; // 30åˆ†é’Ÿè¿‡æœŸ
    }
    
    // è®¾ç½®ç”¨æˆ·æƒé™ç¼“å­˜
    setUserPermissions(userId, permissions) {
        const cacheData = {
            permissions: permissions,
            timestamp: Date.now()
        };
        this.cache.set(`user_permissions_${userId}`, cacheData);
    }
    
    // è·å–ç”¨æˆ·æƒé™ç¼“å­˜
    getUserPermissions(userId) {
        const cacheKey = `user_permissions_${userId}`;
        const cacheData = this.cache.get(cacheKey);
        
        if (!cacheData) {
            return null; // ç¼“å­˜ä¸å­˜åœ¨
        }
        
        // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
        if (Date.now() - cacheData.timestamp > this.expireTime) {
            this.cache.delete(cacheKey);
            return null; // ç¼“å­˜å·²è¿‡æœŸ
        }
        
        return cacheData.permissions;
    }
    
    // æ¸…é™¤ç”¨æˆ·æƒé™ç¼“å­˜
    clearUserPermissions(userId) {
        this.cache.delete(`user_permissions_${userId}`);
    }
}
```

**ğŸ”¸ Redisç¼“å­˜ï¼ˆé€‚åˆåˆ†å¸ƒå¼ï¼‰**
```javascript
const redis = require('redis');
const client = redis.createClient();

class RedisPermissionCache {
    constructor() {
        this.expireTime = 30 * 60; // 30åˆ†é’Ÿï¼ŒRedisä½¿ç”¨ç§’ä¸ºå•ä½
    }
    
    // è®¾ç½®æƒé™ç¼“å­˜
    async setUserPermissions(userId, permissions) {
        const cacheKey = `user_permissions_${userId}`;
        const cacheValue = JSON.stringify(permissions);
        
        await client.setex(cacheKey, this.expireTime, cacheValue);
    }
    
    // è·å–æƒé™ç¼“å­˜
    async getUserPermissions(userId) {
        const cacheKey = `user_permissions_${userId}`;
        const cacheValue = await client.get(cacheKey);
        
        if (!cacheValue) {
            return null;
        }
        
        return JSON.parse(cacheValue);
    }
    
    // æ¸…é™¤æƒé™ç¼“å­˜
    async clearUserPermissions(userId) {
        const cacheKey = `user_permissions_${userId}`;
        await client.del(cacheKey);
    }
}
```

### 7.4 å¸¦ç¼“å­˜çš„æƒé™æ£€æŸ¥å®ç°


```javascript
// å¸¦ç¼“å­˜çš„æƒé™æ£€æŸ¥æœåŠ¡
class CachedPermissionService {
    constructor() {
        this.cache = new RedisPermissionCache();
    }
    
    // è·å–ç”¨æˆ·æƒé™ï¼ˆä¼˜å…ˆä»ç¼“å­˜ï¼‰
    async getUserPermissions(userId) {
        // å…ˆå°è¯•ä»ç¼“å­˜è·å–
        let permissions = await this.cache.getUserPermissions(userId);
        
        if (permissions === null) {
            // ç¼“å­˜æœªå‘½ä¸­ï¼Œä»æ•°æ®åº“æŸ¥è¯¢
            console.log('ç¼“å­˜æœªå‘½ä¸­ï¼Œä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·æƒé™');
            permissions = await this.queryUserPermissionsFromDB(userId);
            
            // å­˜å…¥ç¼“å­˜
            await this.cache.setUserPermissions(userId, permissions);
        } else {
            console.log('ä»ç¼“å­˜è·å–ç”¨æˆ·æƒé™');
        }
        
        return permissions;
    }
    
    // æ£€æŸ¥ç”¨æˆ·æƒé™
    async checkUserPermission(userId, requiredPermission) {
        const permissions = await this.getUserPermissions(userId);
        return permissions.includes(requiredPermission);
    }
    
    // ä»æ•°æ®åº“æŸ¥è¯¢æƒé™
    async queryUserPermissionsFromDB(userId) {
        // å®é™…çš„æ•°æ®åº“æŸ¥è¯¢é€»è¾‘
        const user = await getUserById(userId);
        const roles = await getUserRoles(userId);
        
        let permissions = [];
        for (const role of roles) {
            const rolePermissions = await getRolePermissions(role.id);
            permissions = permissions.concat(rolePermissions);
        }
        
        return [...new Set(permissions)]; // å»é‡
    }
}
```

### 7.5 ç¼“å­˜æ›´æ–°ç­–ç•¥


**ğŸ”¹ è¢«åŠ¨æ›´æ–°ï¼ˆç¼“å­˜ç©¿é€ï¼‰**
```javascript
// å½“ç¼“å­˜è¿‡æœŸæ—¶è‡ªåŠ¨ä»æ•°æ®åº“é‡æ–°åŠ è½½
async function getPermissionsWithPassiveUpdate(userId) {
    let permissions = await cache.get(userId);
    
    if (!permissions) {
        permissions = await database.query(userId);
        await cache.set(userId, permissions, 1800); // 30åˆ†é’Ÿç¼“å­˜
    }
    
    return permissions;
}
```

**ğŸ”¹ ä¸»åŠ¨æ›´æ–°ï¼ˆæƒé™å˜æ›´æ—¶ï¼‰**
```javascript
// å½“æƒé™å‘ç”Ÿå˜åŒ–æ—¶ä¸»åŠ¨æ›´æ–°ç¼“å­˜
async function updateUserRole(userId, newRoleId) {
    // æ›´æ–°æ•°æ®åº“
    await database.updateUserRole(userId, newRoleId);
    
    // æ¸…é™¤æ—§ç¼“å­˜
    await cache.clearUserPermissions(userId);
    
    // é¢„åŠ è½½æ–°æƒé™åˆ°ç¼“å­˜
    const newPermissions = await queryUserPermissionsFromDB(userId);
    await cache.setUserPermissions(userId, newPermissions);
    
    return { success: true };
}
```

**ğŸ”¹ å®šæ—¶åˆ·æ–°ç­–ç•¥**
```javascript
// å®šæ—¶åˆ·æ–°çƒ­ç‚¹ç”¨æˆ·çš„æƒé™ç¼“å­˜
class ScheduledCacheRefresh {
    constructor() {
        this.hotUsers = new Set(); // æ´»è·ƒç”¨æˆ·åˆ—è¡¨
    }
    
    // è®°å½•æ´»è·ƒç”¨æˆ·
    recordActiveUser(userId) {
        this.hotUsers.add(userId);
    }
    
    // å®šæ—¶åˆ·æ–°ç¼“å­˜
    startScheduledRefresh() {
        setInterval(async () => {
            console.log('å¼€å§‹åˆ·æ–°æ´»è·ƒç”¨æˆ·æƒé™ç¼“å­˜');
            
            for (const userId of this.hotUsers) {
                try {
                    const permissions = await queryUserPermissionsFromDB(userId);
                    await cache.setUserPermissions(userId, permissions);
                } catch (error) {
                    console.error(`åˆ·æ–°ç”¨æˆ·${userId}æƒé™ç¼“å­˜å¤±è´¥:`, error);
                }
            }
            
            console.log('æƒé™ç¼“å­˜åˆ·æ–°å®Œæˆ');
        }, 10 * 60 * 1000); // æ¯10åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡
    }
}
```

### 7.6 ç¼“å­˜æ€§èƒ½å¯¹æ¯”


| å­˜å‚¨æ–¹å¼ | **æŸ¥è¯¢æ€§èƒ½** | **é€‚ç”¨åœºæ™¯** | **ä¼˜ç¼ºç‚¹** |
|---------|-------------|-------------|-----------|
| **æ•°æ®åº“ç›´æŸ¥** | `100-500ms` | `ä½å¹¶å‘åœºæ™¯` | `å‡†ç¡®ä½†æ…¢ï¼Œå‹åŠ›å¤§` |
| **å†…å­˜ç¼“å­˜** | `1-5ms` | `å•æœºåº”ç”¨` | `é€Ÿåº¦å¿«ï¼Œä½†ä¸å…±äº«` |
| **Redisç¼“å­˜** | `5-20ms` | `åˆ†å¸ƒå¼åº”ç”¨` | `é€Ÿåº¦å¿«ï¼Œæ”¯æŒé›†ç¾¤` |
| **æœ¬åœ°+Redis** | `1-20ms` | `é«˜å¹¶å‘åœºæ™¯` | `æœ€ä¼˜æ€§èƒ½ï¼Œå¤æ‚åº¦é«˜` |

> ğŸ“Š **ç¼“å­˜æ•ˆæœç»Ÿè®¡**ï¼š
> - âœ… æƒé™æŸ¥è¯¢é€Ÿåº¦æå‡ **95%**
> - âœ… æ•°æ®åº“å‹åŠ›å‡å°‘ **80%**
> - âœ… ç³»ç»Ÿå“åº”æ—¶é—´å‡å°‘ **60%**
> - âœ… ç”¨æˆ·ä½“éªŒæ˜¾è‘—æå‡

---

## 8. ğŸ›¡ï¸ å®‰å…¨é˜²æŠ¤æªæ–½


### 8.1 RBACå®‰å…¨å¨èƒä¸é˜²æŠ¤


**RBACç³»ç»Ÿé¢ä¸´çš„ä¸»è¦å®‰å…¨å¨èƒ**å°±åƒä¸€ä¸ªå¤§æ¥¼çš„å®‰å…¨ç®¡ç†ï¼Œéœ€è¦é˜²èŒƒå„ç§å¯èƒ½çš„å…¥ä¾µå’Œæ”»å‡»æ–¹å¼ã€‚

```
å¸¸è§å®‰å…¨å¨èƒåˆ†ç±»ï¼š

èº«ä»½è®¤è¯å¨èƒ           æƒé™ç»•è¿‡å¨èƒ           ä¼šè¯åŠ«æŒå¨èƒ
      â†“                     â†“                     â†“
  æš´åŠ›ç ´è§£å¯†ç            æƒé™æå‡æ”»å‡»           Tokençªƒå–
  æ’åº“æ”»å‡»              è¶Šæƒè®¿é—®              ä¼šè¯å›ºå®šæ”»å‡»
  ç¤¾ä¼šå·¥ç¨‹å­¦            SQLæ³¨å…¥ç»•è¿‡           XSSæ”»å‡»è·å–å‡­è¯
```

### 8.2 èº«ä»½è®¤è¯å®‰å…¨é˜²æŠ¤


**ğŸ”¸ å¯†ç å®‰å…¨ç­–ç•¥**
```javascript
// å¯†ç å¼ºåº¦éªŒè¯
function validatePasswordStrength(password) {
    const rules = {
        minLength: password.length >= 8,                    // æœ€å°‘8ä½
        hasUpperCase: /[A-Z]/.test(password),              // åŒ…å«å¤§å†™å­—æ¯
        hasLowerCase: /[a-z]/.test(password),              // åŒ…å«å°å†™å­—æ¯
        hasNumbers: /\d/.test(password),                   // åŒ…å«æ•°å­—
        hasSpecialChar: /[!@#$%^&*(),.?":{}|<>]/.test(password), // ç‰¹æ®Šå­—ç¬¦
        notCommon: !isCommonPassword(password)             // ä¸æ˜¯å¸¸è§å¯†ç 
    };
    
    const score = Object.values(rules).filter(Boolean).length;
    
    return {
        isStrong: score >= 5,
        score: score,
        feedback: generatePasswordFeedback(rules)
    };
}

// å¯†ç åŠ å¯†å­˜å‚¨
function hashPassword(plainPassword) {
    const saltRounds = 12; // è¶³å¤Ÿå¼ºçš„ç›å€¼è½®æ•°
    return bcrypt.hashSync(plainPassword, saltRounds);
}
```

**ğŸ”¸ ç™»å½•å°è¯•é™åˆ¶**
```javascript
// é˜²æš´åŠ›ç ´è§£æœºåˆ¶
class LoginAttemptLimiter {
    constructor() {
        this.attempts = new Map(); // å­˜å‚¨ç™»å½•å°è¯•è®°å½•
        this.maxAttempts = 5;      // æœ€å¤§å°è¯•æ¬¡æ•°
        this.lockDuration = 15 * 60 * 1000; // é”å®š15åˆ†é’Ÿ
    }
    
    // è®°å½•ç™»å½•å¤±è´¥
    recordFailedAttempt(identifier) {
        const key = `login_attempts_${identifier}`;
        const now = Date.now();
        
        let attemptData = this.attempts.get(key) || {
            count: 0,
            firstAttempt: now,
            lastAttempt: now,
            isLocked: false
        };
        
        attemptData.count++;
        attemptData.lastAttempt = now;
        
        // æ£€æŸ¥æ˜¯å¦éœ€è¦é”å®š
        if (attemptData.count >= this.maxAttempts) {
            attemptData.isLocked = true;
            attemptData.lockUntil = now + this.lockDuration;
        }
        
        this.attempts.set(key, attemptData);
        
        return {
            remainingAttempts: Math.max(0, this.maxAttempts - attemptData.count),
            isLocked: attemptData.isLocked,
            lockUntil: attemptData.lockUntil
        };
    }
    
    // æ£€æŸ¥æ˜¯å¦è¢«é”å®š
    isAccountLocked(identifier) {
        const key = `login_attempts_${identifier}`;
        const attemptData = this.attempts.get(key);
        
        if (!attemptData || !attemptData.isLocked) {
            return false;
        }
        
        // æ£€æŸ¥é”å®šæ˜¯å¦å·²è¿‡æœŸ
        if (Date.now() > attemptData.lockUntil) {
            this.attempts.delete(key); // æ¸…é™¤è¿‡æœŸçš„é”å®šè®°å½•
            return false;
        }
        
        return true;
    }
    
    // ç™»å½•æˆåŠŸåæ¸…é™¤å¤±è´¥è®°å½•
    clearFailedAttempts(identifier) {
        const key = `login_attempts_${identifier}`;
        this.attempts.delete(key);
    }
}
```

### 8.3 æƒé™æ§åˆ¶å®‰å…¨é˜²æŠ¤


**ğŸ”¸ æƒé™éªŒè¯åŠ å¼º**
```javascript
// å¤šå±‚æƒé™éªŒè¯
class EnhancedPermissionChecker {
    // æ£€æŸ¥æƒé™æ—¶è¿›è¡Œå¤šé‡éªŒè¯
    async checkPermission(userId, resource, action, context = {}) {
        try {
            // ç¬¬1å±‚ï¼šåŸºç¡€æƒé™æ£€æŸ¥
            const hasBasicPermission = await this.checkBasicPermission(userId, `${resource}:${action}`);
            if (!hasBasicPermission) {
                this.logSecurityEvent('PERMISSION_DENIED', userId, resource, action);
                return false;
            }
            
            // ç¬¬2å±‚ï¼šä¸Šä¸‹æ–‡æƒé™æ£€æŸ¥
            const hasContextPermission = await this.checkContextPermission(userId, resource, action, context);
            if (!hasContextPermission) {
                this.logSecurityEvent('CONTEXT_PERMISSION_DENIED', userId, resource, action, context);
                return false;
            }
            
            // ç¬¬3å±‚ï¼šæ—¶é—´çª—å£æ£€æŸ¥
            const isWithinTimeWindow = await this.checkTimeWindow(userId, action);
            if (!isWithinTimeWindow) {
                this.logSecurityEvent('TIME_WINDOW_VIOLATION', userId, action);
                return false;
            }
            
            // ç¬¬4å±‚ï¼šé¢‘ç‡é™åˆ¶æ£€æŸ¥
            const isWithinRateLimit = await this.checkRateLimit(userId, action);
            if (!isWithinRateLimit) {
                this.logSecurityEvent('RATE_LIMIT_EXCEEDED', userId, action);
                return false;
            }
            
            return true;
            
        } catch (error) {
            this.logSecurityEvent('PERMISSION_CHECK_ERROR', userId, resource, action, { error: error.message });
            return false; // å‡ºé”™æ—¶æ‹’ç»è®¿é—®
        }
    }
    
    // æ£€æŸ¥æ•°æ®çº§æƒé™ï¼ˆé˜²æ­¢è¶Šæƒè®¿é—®ï¼‰
    async checkDataLevelPermission(userId, resource, resourceId) {
        // ä¾‹ï¼šç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
        if (resource === 'user_profile') {
            const allowedUserIds = await this.getUserAccessibleUserIds(userId);
            return allowedUserIds.includes(resourceId);
        }
        
        // ä¾‹ï¼šç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±éƒ¨é—¨çš„æ•°æ®
        if (resource === 'department_data') {
            const userDepartment = await this.getUserDepartment(userId);
            const resourceDepartment = await this.getResourceDepartment(resourceId);
            return userDepartment === resourceDepartment;
        }
        
        return true;
    }
}
```

**ğŸ”¸ SQLæ³¨å…¥é˜²æŠ¤**
```javascript
// å‚æ•°åŒ–æŸ¥è¯¢é˜²æ­¢SQLæ³¨å…¥
class SecurePermissionQuery {
    // é”™è¯¯çš„æ–¹å¼ï¼ˆå®¹æ˜“SQLæ³¨å…¥ï¼‰
    // async getUserPermissions(userId) {
    //     const query = `SELECT permissions FROM users WHERE id = ${userId}`;
    //     return await db.query(query);
    // }
    
    // æ­£ç¡®çš„æ–¹å¼ï¼ˆå‚æ•°åŒ–æŸ¥è¯¢ï¼‰
    async getUserPermissions(userId) {
        const query = `
            SELECT p.permission_name 
            FROM users u
            JOIN user_roles ur ON u.id = ur.user_id
            JOIN role_permissions rp ON ur.role_id = rp.role_id
            JOIN permissions p ON rp.permission_id = p.id
            WHERE u.id = ? AND u.is_active = 1
        `;
        return await db.query(query, [userId]);
    }
    
    // è¾“å…¥éªŒè¯å’Œæ¸…ç†
    validateAndSanitizeInput(input, type) {
        switch (type) {
            case 'user_id':
                // åªå…è®¸æ•°å­—
                if (!/^\d+$/.test(input)) {
                    throw new Error('æ— æ•ˆçš„ç”¨æˆ·ID');
                }
                return parseInt(input);
                
            case 'permission_name':
                // åªå…è®¸å­—æ¯ã€æ•°å­—ã€å†’å·ã€ä¸‹åˆ’çº¿
                if (!/^[a-zA-Z0-9:_]+$/.test(input)) {
                    throw new Error('æ— æ•ˆçš„æƒé™åç§°');
                }
                return input.trim();
                
            default:
                throw new Error('æœªçŸ¥çš„è¾“å…¥ç±»å‹');
        }
    }
}
```

### 8.4 ä¼šè¯å®‰å…¨é˜²æŠ¤


**ğŸ”¸ Tokenå®‰å…¨æªæ–½**
```javascript
// Tokenå®‰å…¨ç”Ÿæˆå’ŒéªŒè¯
class SecureTokenManager {
    constructor() {
        this.secret = process.env.JWT_SECRET; // ä»ç¯å¢ƒå˜é‡è·å–å¯†é’¥
        this.algorithm = 'HS256';
        this.tokenBlacklist = new Set(); // Tokené»‘åå•
    }
    
    // ç”Ÿæˆå®‰å…¨çš„Token
    generateSecureToken(user, clientInfo) {
        const payload = {
            user_id: user.id,
            username: user.username,
            role: user.role,
            // æ·»åŠ å®¢æˆ·ç«¯æŒ‡çº¹ä¿¡æ¯é˜²æ­¢Tokenè¢«ç›—ç”¨
            client_fingerprint: this.generateClientFingerprint(clientInfo),
            // æ·»åŠ éšæœºnonceé˜²æ­¢é‡æ”¾æ”»å‡»
            nonce: this.generateNonce(),
            iat: Math.floor(Date.now() / 1000),
            exp: Math.floor(Date.now() / 1000) + (2 * 60 * 60) // 2å°æ—¶è¿‡æœŸ
        };
        
        return jwt.sign(payload, this.secret, { algorithm: this.algorithm });
    }
    
    // éªŒè¯Tokenå®‰å…¨æ€§
    async verifySecureToken(token, clientInfo) {
        try {
            // æ£€æŸ¥æ˜¯å¦åœ¨é»‘åå•ä¸­
            if (this.tokenBlacklist.has(token)) {
                throw new Error('Tokenå·²è¢«åŠé”€');
            }
            
            // éªŒè¯Tokenç­¾åå’Œè¿‡æœŸæ—¶é—´
            const payload = jwt.verify(token, this.secret);
            
            // éªŒè¯å®¢æˆ·ç«¯æŒ‡çº¹
            const currentFingerprint = this.generateClientFingerprint(clientInfo);
            if (payload.client_fingerprint !== currentFingerprint) {
                this.logSecurityEvent('TOKEN_FINGERPRINT_MISMATCH', payload.user_id);
                throw new Error('Tokenå®¢æˆ·ç«¯æŒ‡çº¹ä¸åŒ¹é…');
            }
            
            // æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
            const user = await this.getUserById(payload.user_id);
            if (!user || !user.is_active) {
                throw new Error('ç”¨æˆ·å·²è¢«ç¦ç”¨');
            }
            
            return payload;
            
        } catch (error) {
            this.logSecurityEvent('TOKEN_VERIFICATION_FAILED', null, { error: error.message });
            throw error;
        }
    }
    
    // ç”Ÿæˆå®¢æˆ·ç«¯æŒ‡çº¹
    generateClientFingerprint(clientInfo) {
        const fingerprint = `${clientInfo.userAgent}|${clientInfo.ip}|${clientInfo.acceptLanguage}`;
        return crypto.createHash('sha256').update(fingerprint).digest('hex');
    }
    
    // åŠé”€Tokenï¼ˆåŠ å…¥é»‘åå•ï¼‰
    revokeToken(token) {
        this.tokenBlacklist.add(token);
        // å®šæœŸæ¸…ç†è¿‡æœŸçš„é»‘åå•Token
        setTimeout(() => {
            this.tokenBlacklist.delete(token);
        }, 24 * 60 * 60 * 1000); // 24å°æ—¶åæ¸…ç†
    }
}
```

### 8.5 å®‰å…¨æ—¥å¿—ä¸ç›‘æ§


**ğŸ”¸ å®‰å…¨äº‹ä»¶æ—¥å¿—è®°å½•**
```javascript
// å®‰å…¨äº‹ä»¶æ—¥å¿—ç³»ç»Ÿ
class SecurityLogger {
    constructor() {
        this.logLevel = {
            INFO: 'INFO',
            WARN: 'WARN', 
            ERROR: 'ERROR',
            CRITICAL: 'CRITICAL'
        };
    }
    
    // è®°å½•å®‰å…¨äº‹ä»¶
    logSecurityEvent(eventType, userId, resource = null, action = null, details = {}) {
        const logEntry = {
            timestamp: new Date().toISOString(),
            event_type: eventType,
            user_id: userId,
            resource: resource,
            action: action,
            ip_address: details.ip || 'unknown',
            user_agent: details.userAgent || 'unknown',
            details: details,
            severity: this.getSeverity(eventType)
        };
        
        // å†™å…¥æ—¥å¿—æ–‡ä»¶
        this.writeToLog(logEntry);
        
        // ä¸¥é‡äº‹ä»¶ç«‹å³å‘é€å‘Šè­¦
        if (logEntry.severity === this.logLevel.CRITICAL) {
            this.sendAlert(logEntry);
        }
    }
    
    // æ ¹æ®äº‹ä»¶ç±»å‹ç¡®å®šä¸¥é‡ç¨‹åº¦
    getSeverity(eventType) {
        const severityMap = {
            'LOGIN_SUCCESS': this.logLevel.INFO,
            'LOGIN_FAILED': this.logLevel.WARN,
            'MULTIPLE_LOGIN_FAILURES': this.logLevel.ERROR,
            'ACCOUNT_LOCKED': this.logLevel.ERROR,
            'PERMISSION_DENIED': this.logLevel.WARN,
            'UNAUTHORIZED_ACCESS_ATTEMPT': this.logLevel.ERROR,
            'TOKEN_HIJACK_SUSPECTED': this.logLevel.CRITICAL,
            'PRIVILEGE_ESCALATION_ATTEMPT': this.logLevel.CRITICAL,
            'SQL_INJECTION_ATTEMPT': this.logLevel.CRITICAL
        };
        
        return severityMap[eventType] || this.logLevel.INFO;
    }
}
```

**ğŸ”¸ å¼‚å¸¸è¡Œä¸ºæ£€æµ‹**
```javascript
// ç”¨æˆ·è¡Œä¸ºå¼‚å¸¸æ£€æµ‹
class AnomalyDetector {
    constructor() {
        this.userProfiles = new Map(); // ç”¨æˆ·è¡Œä¸ºç”»åƒ
    }
    
    // åˆ†æç”¨æˆ·è¡Œä¸º
    analyzeUserBehavior(userId, action, context) {
        const profile = this.getUserProfile(userId);
        
        // æ£€æµ‹å¼‚å¸¸ç™»å½•
        if (action === 'login') {
            const isAnomalousLogin = this.detectAnomalousLogin(profile, context);
            if (isAnomalousLogin) {
                this.triggerSecurityAlert('ANOMALOUS_LOGIN', userId, context);
            }
        }
        
        // æ£€æµ‹æƒé™æ»¥ç”¨
        if (action === 'permission_check') {
            const isPermissionAbuse = this.detectPermissionAbuse(profile, context);
            if (isPermissionAbuse) {
                this.triggerSecurityAlert('PERMISSION_ABUSE', userId, context);
            }
        }
        
        // æ›´æ–°ç”¨æˆ·è¡Œä¸ºç”»åƒ
        this.updateUserProfile(userId, action, context);
    }
    
    // æ£€æµ‹å¼‚å¸¸ç™»å½•
    detectAnomalousLogin(profile, context) {
        const checks = [
            this.isUnusualLoginTime(profile, context.timestamp),
            this.isUnusualLocation(profile, context.ip),
            this.isUnusualDevice(profile, context.userAgent),
            this.isSuspiciousLoginPattern(profile, context)
        ];
        
        return checks.filter(Boolean).length >= 2; // 2ä¸ªæˆ–ä»¥ä¸Šå¼‚å¸¸æŒ‡æ ‡
    }
    
    // æ£€æµ‹æƒé™æ»¥ç”¨
    detectPermissionAbuse(profile, context) {
        // æ£€æŸ¥æ˜¯å¦åœ¨çŸ­æ—¶é—´å†…å°è¯•è®¿é—®å¤§é‡èµ„æº
        const recentActions = profile.recentActions || [];
        const timeWindow = 5 * 60 * 1000; // 5åˆ†é’Ÿçª—å£
        const now = Date.now();
        
        const recentCount = recentActions.filter(action => 
            now - action.timestamp < timeWindow
        ).length;
        
        return recentCount > 50; // 5åˆ†é’Ÿå†…è¶…è¿‡50æ¬¡æ“ä½œè§†ä¸ºå¼‚å¸¸
    }
}
```

### 8.6 å®‰å…¨é˜²æŠ¤æœ€ä½³å®è·µæ¸…å•


> ğŸ”’ **RBACå®‰å…¨é˜²æŠ¤æ£€æŸ¥æ¸…å•**ï¼š
> 
> **âœ… èº«ä»½è®¤è¯å®‰å…¨**
> - [ ] å¼ºå¯†ç ç­–ç•¥ï¼ˆé•¿åº¦ã€å¤æ‚åº¦ã€å®šæœŸæ›´æ¢ï¼‰
> - [ ] å¤šå› ç´ è®¤è¯ï¼ˆSMSã€é‚®ç®±ã€TOTPï¼‰
> - [ ] ç™»å½•å¤±è´¥é™åˆ¶ï¼ˆé˜²æš´åŠ›ç ´è§£ï¼‰
> - [ ] è´¦æˆ·é”å®šæœºåˆ¶
> 
> **âœ… æƒé™æ§åˆ¶å®‰å…¨**  
> - [ ] æœ€å°æƒé™åŸåˆ™ï¼ˆåªç»™å¿…éœ€æƒé™ï¼‰
> - [ ] æƒé™åˆ†ç¦»ï¼ˆæ•æ„Ÿæ“ä½œéœ€å¤šé‡éªŒè¯ï¼‰
> - [ ] æ•°æ®çº§æƒé™æ§åˆ¶
> - [ ] å‚æ•°åŒ–æŸ¥è¯¢ï¼ˆé˜²SQLæ³¨å…¥ï¼‰
> 
> **âœ… ä¼šè¯ç®¡ç†å®‰å…¨**
> - [ ] å®‰å…¨çš„Tokenç”Ÿæˆå’ŒéªŒè¯
> - [ ] åˆç†çš„ä¼šè¯è¶…æ—¶æ—¶é—´
> - [ ] Tokené»‘åå•æœºåˆ¶
> - [ ] å®¢æˆ·ç«¯æŒ‡çº¹éªŒè¯
> 
> **âœ… ç›‘æ§å’Œå“åº”**
> - [ ] å…¨é¢çš„å®‰å…¨äº‹ä»¶æ—¥å¿—
> - [ ] å¼‚å¸¸è¡Œä¸ºæ£€æµ‹å’Œå‘Šè­¦
> - [ ] å®šæœŸå®‰å…¨å®¡è®¡
> - [ ] åº”æ€¥å“åº”é¢„æ¡ˆ

---

## 9. ğŸ”„ æƒé™åˆ·æ–°æœºåˆ¶


### 9.1 ä¸ºä»€ä¹ˆéœ€è¦æƒé™åˆ·æ–°


**æƒé™åˆ·æ–°æœºåˆ¶**å°±æ˜¯åŠæ—¶æ›´æ–°ç”¨æˆ·æƒé™çš„æ–¹æ³•ï¼Œå°±åƒå‘˜å·¥èŒä½å˜åŠ¨åè¦åŠæ—¶æ›´æ¢é—¨ç¦å¡æƒé™ã€‚

> ğŸ’¡ **å…¸å‹åœºæ™¯é—®é¢˜**ï¼š
> ```
> åœºæ™¯1ï¼šå‘˜å·¥å‡èŒ
> å¼ ä¸‰ä»æ™®é€šå‘˜å·¥å‡ä¸ºéƒ¨é—¨ç»ç†ï¼Œä½†ç³»ç»Ÿä¸­æƒé™æ²¡åŠæ—¶æ›´æ–°
> ç»“æœï¼šå¼ ä¸‰æ— æ³•è®¿é—®ç®¡ç†åŠŸèƒ½ï¼Œå½±å“å·¥ä½œ
> 
> åœºæ™¯2ï¼šå‘˜å·¥ç¦»èŒ  
> æå››ç¦»èŒäº†ï¼Œä½†æƒé™æ²¡åŠæ—¶å›æ”¶
> ç»“æœï¼šæå››ä»èƒ½è®¿é—®å…¬å¸ç³»ç»Ÿï¼Œå­˜åœ¨å®‰å…¨éšæ‚£
> 
> åœºæ™¯3ï¼šæƒé™ç­–ç•¥è°ƒæ•´
> å…¬å¸è°ƒæ•´äº†æŸä¸ªè§’è‰²çš„æƒé™èŒƒå›´
> ç»“æœï¼šå·²ç™»å½•ç”¨æˆ·ä»ä½¿ç”¨æ—§æƒé™ï¼Œé€ æˆæ··ä¹±
> ```

### 9.2 æƒé™åˆ·æ–°è§¦å‘æœºåˆ¶


```
æƒé™åˆ·æ–°è§¦å‘æ—¶æœºï¼š

ä¸»åŠ¨è§¦å‘                 è¢«åŠ¨è§¦å‘                å®šæ—¶è§¦å‘
    â†“                       â†“                      â†“
ç”¨æˆ·è§’è‰²å˜æ›´             Tokenå³å°†è¿‡æœŸ            å®šæœŸå…¨é‡åˆ·æ–°
æƒé™ç­–ç•¥æ›´æ–°             ç¼“å­˜è¿‡æœŸ               ç³»ç»Ÿç»´æŠ¤çª—å£
ç®¡ç†å‘˜å¼ºåˆ¶åˆ·æ–°           å¼‚å¸¸æ£€æµ‹               ç­–ç•¥åŒæ­¥
```

### 9.3 å®æ—¶æƒé™åˆ·æ–°å®ç°


**ğŸ”¸ WebSocketå®æ—¶æ¨é€**
```javascript
// æœåŠ¡ç«¯ï¼šæƒé™å˜æ›´é€šçŸ¥
class PermissionNotificationService {
    constructor() {
        this.connectedClients = new Map(); // å­˜å‚¨WebSocketè¿æ¥
    }
    
    // ç”¨æˆ·è¿æ¥æ—¶æ³¨å†Œ
    registerClient(userId, websocket) {
        this.connectedClients.set(userId, websocket);
        
        websocket.on('close', () => {
            this.connectedClients.delete(userId);
        });
    }
    
    // æƒé™å˜æ›´æ—¶é€šçŸ¥ç”¨æˆ·
    notifyPermissionChange(userId, changeType, details) {
        const websocket = this.connectedClients.get(userId);
        
        if (websocket && websocket.readyState === WebSocket.OPEN) {
            const notification = {
                type: 'PERMISSION_CHANGE',
                changeType: changeType, // 'ROLE_UPDATED', 'PERMISSION_REVOKED', 'FORCE_LOGOUT'
                details: details,
                timestamp: new Date().toISOString(),
                action_required: this.getRequiredAction(changeType)
            };
            
            websocket.send(JSON.stringify(notification));
        }
    }
    
    // æ‰¹é‡é€šçŸ¥å¤šä¸ªç”¨æˆ·
    notifyMultipleUsers(userIds, changeType, details) {
        userIds.forEach(userId => {
            this.notifyPermissionChange(userId, changeType, details);
        });
    }
    
    // æ ¹æ®å˜æ›´ç±»å‹ç¡®å®šæ‰€éœ€æ“ä½œ
    getRequiredAction(changeType) {
        const actionMap = {
            'ROLE_UPDATED': 'REFRESH_PERMISSIONS',    // åˆ·æ–°æƒé™
            'PERMISSION_REVOKED': 'REFRESH_PERMISSIONS', // åˆ·æ–°æƒé™
            'ACCOUNT_DISABLED': 'FORCE_LOGOUT',      // å¼ºåˆ¶ç™»å‡º
            'SECURITY_VIOLATION': 'FORCE_LOGOUT',    // å¼ºåˆ¶ç™»å‡º
            'POLICY_UPDATED': 'REFRESH_PERMISSIONS'  // åˆ·æ–°æƒé™
        };
        
        return actionMap[changeType] || 'REFRESH_PERMISSIONS';
    }
}
```

**ğŸ”¸ å®¢æˆ·ç«¯å¤„ç†æƒé™åˆ·æ–°**
```javascript
// å‰ç«¯ï¼šå¤„ç†æƒé™åˆ·æ–°é€šçŸ¥
class ClientPermissionManager {
    constructor() {
        this.currentPermissions = [];
        this.websocket = null;
        this.reconnectAttempts = 0;
        this.maxReconnectAttempts = 5;
    }
    
    // å»ºç«‹WebSocketè¿æ¥
    connectToPermissionService() {
        this.websocket = new WebSocket('wss://yourserver.com/permission-ws');
        
        this.websocket.onopen = () => {
            console.log('æƒé™æœåŠ¡è¿æ¥æˆåŠŸ');
            this.reconnectAttempts = 0;
        };
        
        this.websocket.onmessage = (event) => {
            const notification = JSON.parse(event.data);
            this.handlePermissionNotification(notification);
        };
        
        this.websocket.onclose = () => {
            console.log('æƒé™æœåŠ¡è¿æ¥æ–­å¼€');
            this.attemptReconnect();
        };
        
        this.websocket.onerror = (error) => {
            console.error('æƒé™æœåŠ¡è¿æ¥é”™è¯¯:', error);
        };
    }
    
    // å¤„ç†æƒé™å˜æ›´é€šçŸ¥
    handlePermissionNotification(notification) {
        console.log('æ”¶åˆ°æƒé™å˜æ›´é€šçŸ¥:', notification);
        
        switch (notification.action_required) {
            case 'REFRESH_PERMISSIONS':
                this.refreshUserPermissions();
                this.showPermissionUpdateMessage(notification);
                break;
                
            case 'FORCE_LOGOUT':
                this.forceLogout(notification.details.reason);
                break;
                
            default:
                console.warn('æœªçŸ¥çš„æƒé™æ“ä½œ:', notification.action_required);
        }
    }
    
    // åˆ·æ–°ç”¨æˆ·æƒé™
    async refreshUserPermissions() {
        try {
            const response = await fetch('/api/auth/refresh-permissions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${this.getToken()}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                this.currentPermissions = data.permissions;
                this.updateUIPermissions();
                console.log('æƒé™åˆ·æ–°æˆåŠŸ');
            } else {
                console.error('æƒé™åˆ·æ–°å¤±è´¥');
                this.handleRefreshError();
            }
        } catch (error) {
            console.error('æƒé™åˆ·æ–°å¼‚å¸¸:', error);
            this.handleRefreshError();
        }
    }
    
    // å¼ºåˆ¶ç™»å‡º
    forceLogout(reason) {
        alert(`ç”±äº${reason}ï¼Œæ‚¨éœ€è¦é‡æ–°ç™»å½•`);
        
        // æ¸…é™¤æœ¬åœ°å­˜å‚¨
        localStorage.removeItem('auth_token');
        localStorage.removeItem('user_permissions');
        
        // é‡å®šå‘åˆ°ç™»å½•é¡µ
        window.location.href = '/login?reason=force_logout';
    }
    
    // æ›´æ–°UIæƒé™æ˜¾ç¤º
    updateUIPermissions() {
        // é‡æ–°æ£€æŸ¥é¡µé¢ä¸Šçš„æƒé™æ§åˆ¶å…ƒç´ 
        document.querySelectorAll('[data-permission]').forEach(element => {
            const requiredPermission = element.dataset.permission;
            const hasPermission = this.currentPermissions.includes(requiredPermission);
            
            if (hasPermission) {
                element.style.display = '';
                element.disabled = false;
            } else {
                element.style.display = 'none';
                element.disabled = true;
            }
        });
        
        // è§¦å‘æƒé™æ›´æ–°äº‹ä»¶
        window.dispatchEvent(new CustomEvent('permissionsUpdated', {
            detail: { permissions: this.currentPermissions }
        }));
    }
}
```

### 9.4 Tokenåˆ·æ–°æœºåˆ¶


**ğŸ”¸ è‡ªåŠ¨Tokenåˆ·æ–°**
```javascript
// Tokenè‡ªåŠ¨åˆ·æ–°æœåŠ¡
class TokenRefreshService {
    constructor() {
        this.refreshThreshold = 15 * 60 * 1000; // Tokenè¿‡æœŸå‰15åˆ†é’Ÿå¼€å§‹åˆ·æ–°
        this.refreshTimer = null;
        this.isRefreshing = false;
    }
    
    // å¯åŠ¨Tokenåˆ·æ–°ç›‘æ§
    startTokenRefreshMonitoring() {
        this.refreshTimer = setInterval(() => {
            this.checkAndRefreshToken();
        }, 60 * 1000); // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    }
    
    // æ£€æŸ¥å¹¶åˆ·æ–°Token
    async checkAndRefreshToken() {
        const token = this.getStoredToken();
        if (!token) {
            return;
        }
        
        try {
            const payload = this.decodeToken(token);
            const expirationTime = payload.exp * 1000;
            const currentTime = Date.now();
            const timeUntilExpiry = expirationTime - currentTime;
            
            // å¦‚æœTokenå³å°†è¿‡æœŸä¸”æœªåœ¨åˆ·æ–°ä¸­
            if (timeUntilExpiry <= this.refreshThreshold && !this.isRefreshing) {
                await this.refreshToken();
            }
            
        } catch (error) {
            console.error('Tokenæ£€æŸ¥å¤±è´¥:', error);
            this.handleTokenError();
        }
    }
    
    // åˆ·æ–°Token
    async refreshToken() {
        if (this.isRefreshing) {
            return; // é¿å…é‡å¤åˆ·æ–°
        }
        
        this.isRefreshing = true;
        
        try {
            const refreshToken = this.getRefreshToken();
            const response = await fetch('/api/auth/refresh-token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${refreshToken}`
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                
                // æ›´æ–°å­˜å‚¨çš„Token
                this.storeToken(data.access_token);
                if (data.refresh_token) {
                    this.storeRefreshToken(data.refresh_token);
                }
                
                // æ›´æ–°æƒé™ä¿¡æ¯
                if (data.permissions) {
                    this.updateStoredPermissions(data.permissions);
                }
                
                console.log('Tokenåˆ·æ–°æˆåŠŸ');
                
                // è§¦å‘Tokenåˆ·æ–°äº‹ä»¶
                window.dispatchEvent(new CustomEvent('tokenRefreshed', {
                    detail: { newToken: data.access_token }
                }));
                
            } else {
                throw new Error('Tokenåˆ·æ–°å¤±è´¥');
            }
            
        } catch (error) {
            console.error('Tokenåˆ·æ–°å¼‚å¸¸:', error);
            this.handleRefreshError();
        } finally {
            this.isRefreshing = false;
        }
    }
    
    // è§£ç Tokenè·å–ä¿¡æ¯
    decodeToken(token) {
        const payload = token.split('.')[1];
        const decoded = atob(payload);
        return JSON.parse(decoded);
    }
    
    // å¤„ç†åˆ·æ–°é”™è¯¯
    handleRefreshError() {
        // æ¸…é™¤æ— æ•ˆToken
        this.clearStoredTokens();
        
        // é‡å®šå‘åˆ°ç™»å½•é¡µ
        window.location.href = '/login?reason=token_expired';
    }
}
```

### 9.5 æƒé™ç¼“å­˜æ›´æ–°ç­–ç•¥


**ğŸ”¸ æƒé™å˜æ›´æ—¶çš„ç¼“å­˜å¤„ç†**
```javascript
// æƒé™å˜æ›´å¤„ç†æœåŠ¡
class PermissionChangeHandler {
    constructor() {
        this.cache = new RedisPermissionCache();
        this.notificationService = new PermissionNotificationService();
    }
    
    // å¤„ç†ç”¨æˆ·è§’è‰²å˜æ›´
    async handleUserRoleChange(userId, oldRoleIds, newRoleIds) {
        try {
            // 1. æ›´æ–°æ•°æ®åº“
            await this.updateUserRoles(userId, newRoleIds);
            
            // 2. æ¸…é™¤æ—§çš„æƒé™ç¼“å­˜
            await this.cache.clearUserPermissions(userId);
            
            // 3. é¢„åŠ è½½æ–°çš„æƒé™åˆ°ç¼“å­˜
            const newPermissions = await this.loadUserPermissions(userId);
            await this.cache.setUserPermissions(userId, newPermissions);
            
            // 4. é€šçŸ¥ç”¨æˆ·æƒé™å˜æ›´
            this.notificationService.notifyPermissionChange(userId, 'ROLE_UPDATED', {
                oldRoles: oldRoleIds,
                newRoles: newRoleIds,
                newPermissions: newPermissions
            });
            
            // 5. è®°å½•å˜æ›´æ—¥å¿—
            this.logPermissionChange(userId, 'ROLE_CHANGE', { oldRoleIds, newRoleIds });
            
            console.log(`ç”¨æˆ·${userId}è§’è‰²å˜æ›´å¤„ç†å®Œæˆ`);
            
        } catch (error) {
            console.error('å¤„ç†ç”¨æˆ·è§’è‰²å˜æ›´å¤±è´¥:', error);
            throw error;
        }
    }
    
    // å¤„ç†æƒé™ç­–ç•¥æ›´æ–°
    async handlePermissionPolicyUpdate(roleId, addedPermissions = [], removedPermissions = []) {
        try {
            // 1. æ›´æ–°è§’è‰²æƒé™
            await this.updateRolePermissions(roleId, addedPermissions, removedPermissions);
            
            // 2. è·å–å—å½±å“çš„ç”¨æˆ·
            const affectedUsers = await this.getUsersByRole(roleId);
            
            // 3. æ‰¹é‡æ›´æ–°ç”¨æˆ·æƒé™ç¼“å­˜
            for (const user of affectedUsers) {
                await this.cache.clearUserPermissions(user.id);
                const newPermissions = await this.loadUserPermissions(user.id);
                await this.cache.setUserPermissions(user.id, newPermissions);
            }
            
            // 4. æ‰¹é‡é€šçŸ¥ç”¨æˆ·
            const userIds = affectedUsers.map(user => user.id);
            this.notificationService.notifyMultipleUsers(userIds, 'POLICY_UPDATED', {
                roleId: roleId,
                addedPermissions: addedPermissions,
                removedPermissions: removedPermissions
            });
            
            // 5. è®°å½•ç­–ç•¥å˜æ›´æ—¥å¿—
            this.logPermissionChange(null, 'POLICY_UPDATE', {
                roleId,
                affectedUserCount: affectedUsers.length,
                addedPermissions,
                removedPermissions
            });
            
            console.log(`è§’è‰²${roleId}æƒé™ç­–ç•¥æ›´æ–°å®Œæˆï¼Œå½±å“${affectedUsers.length}ä¸ªç”¨æˆ·`);
            
        } catch (error) {
            console.error('å¤„ç†æƒé™ç­–ç•¥æ›´æ–°å¤±è´¥:', error);
            throw error;
        }
    }
    
    // å¼ºåˆ¶åˆ·æ–°æ‰€æœ‰åœ¨çº¿ç”¨æˆ·æƒé™
    async forceRefreshAllOnlineUsers() {
        try {
            // 1. è·å–æ‰€æœ‰åœ¨çº¿ç”¨æˆ·
            const onlineUsers = await this.getOnlineUsers();
            
            // 2. æ¸…é™¤æ‰€æœ‰ç”¨æˆ·çš„æƒé™ç¼“å­˜
            for (const userId of onlineUsers) {
                await this.cache.clearUserPermissions(userId);
            }
            
            // 3. é€šçŸ¥æ‰€æœ‰åœ¨çº¿ç”¨æˆ·åˆ·æ–°æƒé™
            this.notificationService.notifyMultipleUsers(onlineUsers, 'FORCE_REFRESH', {
                reason: 'ç³»ç»Ÿæƒé™ç­–ç•¥å·²æ›´æ–°',
                timestamp: new Date().toISOString()
            });
            
            console.log(`å·²é€šçŸ¥${onlineUsers.length}ä¸ªåœ¨çº¿ç”¨æˆ·åˆ·æ–°æƒé™`);
            
        } catch (error) {
            console.error('å¼ºåˆ¶åˆ·æ–°æ‰€æœ‰ç”¨æˆ·æƒé™å¤±è´¥:', error);
            throw error;
        }
    }
}
```

### 9.6 æ¸è¿›å¼æƒé™æ›´æ–°


**ğŸ”¸ åˆ†æ‰¹æ¬¡æƒé™æ›´æ–°**
```javascript
// å¤§è§„æ¨¡æƒé™æ›´æ–°çš„åˆ†æ‰¹å¤„ç†
class BatchPermissionUpdater {
    constructor() {
        this.batchSize = 100; // æ¯æ‰¹å¤„ç†100ä¸ªç”¨æˆ·
        this.delayBetweenBatches = 1000; // æ‰¹æ¬¡é—´å»¶è¿Ÿ1ç§’
    }
    
    // åˆ†æ‰¹æ›´æ–°ç”¨æˆ·æƒé™
    async updatePermissionsBatch(userIds, updateFunction) {
        const batches = this.createBatches(userIds, this.batchSize);
        let successCount = 0;
        let errorCount = 0;
        
        console.log(`å¼€å§‹åˆ†æ‰¹æ›´æ–°${userIds.length}ä¸ªç”¨æˆ·æƒé™ï¼Œå…±${batches.length}æ‰¹`);
        
        for (let i = 0; i < batches.length; i++) {
            const batch = batches[i];
            
            try {
                console.log(`å¤„ç†ç¬¬${i + 1}æ‰¹ï¼Œç”¨æˆ·æ•°é‡ï¼š${batch.length}`);
                
                // å¹¶å‘å¤„ç†å½“å‰æ‰¹æ¬¡çš„ç”¨æˆ·
                const batchPromises = batch.map(userId => 
                    this.updateSingleUserPermission(userId, updateFunction)
                        .then(() => ({ userId, success: true }))
                        .catch(error => ({ userId, success: false, error }))
                );
                
                const batchResults = await Promise.all(batchPromises);
                
                // ç»Ÿè®¡ç»“æœ
                const batchSuccessCount = batchResults.filter(r => r.success).length;
                const batchErrorCount = batchResults.length - batchSuccessCount;
                
                successCount += batchSuccessCount;
                errorCount += batchErrorCount;
                
                console.log(`ç¬¬${i + 1}æ‰¹å®Œæˆï¼šæˆåŠŸ${batchSuccessCount}ï¼Œå¤±è´¥${batchErrorCount}`);
                
                // è®°å½•å¤±è´¥çš„ç”¨æˆ·
                const failedUsers = batchResults.filter(r => !r.success);
                if (failedUsers.length > 0) {
                    console.error('æ‰¹æ¬¡å¤±è´¥ç”¨æˆ·:', failedUsers);
                }
                
                // æ‰¹æ¬¡é—´å»¶è¿Ÿï¼Œé¿å…å¯¹ç³»ç»Ÿé€ æˆè¿‡å¤§å‹åŠ›
                if (i < batches.length - 1) {
                    await this.sleep(this.delayBetweenBatches);
                }
                
            } catch (error) {
                console.error(`ç¬¬${i + 1}æ‰¹å¤„ç†å¤±è´¥:`, error);
                errorCount += batch.length;
            }
        }
        
        console.log(`æƒé™æ›´æ–°å®Œæˆï¼šæˆåŠŸ${successCount}ï¼Œå¤±è´¥${errorCount}`);
        
        return {
            totalUsers: userIds.length,
            successCount: successCount,
            errorCount: errorCount,
            successRate: ((successCount / userIds.length) * 100).toFixed(2) + '%'
        };
    }
    
    // æ›´æ–°å•ä¸ªç”¨æˆ·æƒé™
    async updateSingleUserPermission(userId, updateFunction) {
        try {
            await updateFunction(userId);
            return true;
        } catch (error) {
            console.error(`æ›´æ–°ç”¨æˆ·${userId}æƒé™å¤±è´¥:`, error);
            throw error;
        }
    }
    
    // åˆ›å»ºæ‰¹æ¬¡
    createBatches(array, batchSize) {
        const batches = [];
        for (let i = 0; i < array.length; i += batchSize) {
            batches.push(array.slice(i, i + batchSize));
        }
        return batches;
    }
    
    // å»¶è¿Ÿå‡½æ•°
    sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
}
```

### 9.7 æƒé™åˆ·æ–°ç›‘æ§ä¸å‘Šè­¦


**ğŸ”¸ åˆ·æ–°çŠ¶æ€ç›‘æ§**
```javascript
// æƒé™åˆ·æ–°ç›‘æ§ç³»ç»Ÿ
class PermissionRefreshMonitor {
    constructor() {
        this.refreshStats = {
            successCount: 0,
            failureCount: 0,
            totalRefreshTime: 0,
            lastRefreshTime: null
        };
        this.alertThresholds = {
            maxFailureRate: 0.05,      // æœ€å¤§å¤±è´¥ç‡5%
            maxRefreshTime: 30000,     // æœ€å¤§åˆ·æ–°æ—¶é—´30ç§’
            minSuccessRate: 0.95       // æœ€å°æˆåŠŸç‡95%
        };
    }
    
    // è®°å½•åˆ·æ–°æ“ä½œ
    recordRefreshOperation(userId, success, duration, error = null) {
        const operation = {
            userId: userId,
            timestamp: new Date(),
            success: success,
            duration: duration,
            error: error
        };
        
        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        if (success) {
            this.refreshStats.successCount++;
        } else {
            this.refreshStats.failureCount++;
        }
        
        this.refreshStats.totalRefreshTime += duration;
        this.refreshStats.lastRefreshTime = new Date();
        
        // æ£€æŸ¥æ˜¯å¦éœ€è¦å‘Šè­¦
        this.checkAlertConditions(operation);
        
        // è®°å½•åˆ°ç›‘æ§æ—¥å¿—
        this.logRefreshOperation(operation);
    }
    
    // æ£€æŸ¥å‘Šè­¦æ¡ä»¶
    checkAlertConditions(operation) {
        const totalOps = this.refreshStats.successCount + this.refreshStats.failureCount;
        
        if (totalOps > 0) {
            const failureRate = this.refreshStats.failureCount / totalOps;
            const avgRefreshTime = this.refreshStats.totalRefreshTime / totalOps;
            
            // å¤±è´¥ç‡è¿‡é«˜å‘Šè­¦
            if (failureRate > this.alertThresholds.maxFailureRate) {
                this.sendAlert('HIGH_FAILURE_RATE', {
                    currentRate: (failureRate * 100).toFixed(2) + '%',
                    threshold: (this.alertThresholds.maxFailureRate * 100) + '%',
                    failureCount: this.refreshStats.failureCount,
                    totalOps: totalOps
                });
            }
            
            // åˆ·æ–°æ—¶é—´è¿‡é•¿å‘Šè­¦
            if (operation.duration > this.alertThresholds.maxRefreshTime) {
                this.sendAlert('SLOW_REFRESH', {
                    duration: operation.duration + 'ms',
                    threshold: this.alertThresholds.maxRefreshTime + 'ms',
                    userId: operation.userId
                });
            }
        }
    }
    
    // å‘é€å‘Šè­¦
    sendAlert(alertType, details) {
        const alert = {
            type: alertType,
            timestamp: new Date().toISOString(),
            details: details,
            severity: this.getAlertSeverity(alertType)
        };
        
        console.error('æƒé™åˆ·æ–°å‘Šè­¦:', alert);
        
        // å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ
        this.sendToMonitoringSystem(alert);
    }
    
    // è·å–å½“å‰åˆ·æ–°ç»Ÿè®¡
    getRefreshStats() {
        const totalOps = this.refreshStats.successCount + this.refreshStats.failureCount;
        
        return {
            totalOperations: totalOps,
            successCount: this.refreshStats.successCount,
            failureCount: this.refreshStats.failureCount,
            successRate: totalOps > 0 ? ((this.refreshStats.successCount / totalOps) * 100).toFixed(2) + '%' : '0%',
            averageRefreshTime: totalOps > 0 ? Math.round(this.refreshStats.totalRefreshTime / totalOps) + 'ms' : '0ms',
            lastRefreshTime: this.refreshStats.lastRefreshTime
        };
    }
}
```

> ğŸ”„ **æƒé™åˆ·æ–°æœ€ä½³å®è·µ**ï¼š
> 
> **âœ… å®æ—¶æ€§åŸåˆ™**
> - å…³é”®æƒé™å˜æ›´ç«‹å³ç”Ÿæ•ˆ
> - ä½¿ç”¨WebSocketæ¨é€é€šçŸ¥
> - æä¾›æ‰‹åŠ¨åˆ·æ–°åŠŸèƒ½
> 
> **âœ… æ€§èƒ½ä¼˜åŒ–**  
> - åˆ†æ‰¹å¤„ç†å¤§è§„æ¨¡æ›´æ–°
> - åˆç†è®¾ç½®åˆ·æ–°é¢‘ç‡
> - é¿å…ç¼“å­˜é›ªå´©
> 
> **âœ… ç”¨æˆ·ä½“éªŒ**
> - æƒé™å˜æ›´å‹å¥½æç¤º
> - é¿å…é¢‘ç¹å¼ºåˆ¶åˆ·æ–°
> - æä¾›æƒé™å˜æ›´å†å²æŸ¥è¯¢
> 
> **âœ… ç›‘æ§å‘Šè­¦**
> - ç›‘æ§åˆ·æ–°æˆåŠŸç‡
> - å‘Šè­¦å¼‚å¸¸åˆ·æ–°æ—¶é—´
> - è®°å½•è¯¦ç»†åˆ·æ–°æ—¥å¿—

---

## 10. ğŸ§® æƒé™æ£€æŸ¥æ ¸å¿ƒç®—æ³•


### 10.1 æƒé™æ£€æŸ¥ç®—æ³•åŸç†


**æƒé™æ£€æŸ¥ç®—æ³•**å°±æ˜¯ç³»ç»Ÿåˆ¤æ–­ **"ç”¨æˆ·èƒ½å¦æ‰§è¡ŒæŸä¸ªæ“ä½œ"** çš„è®¡ç®—é€»è¾‘ï¼Œå°±åƒé—¨ç¦ç³»ç»Ÿåˆ¤æ–­é—¨å¡æ˜¯å¦æœ‰æƒé™è¿›å…¥æŸä¸ªåŒºåŸŸã€‚

> ğŸ’¡ **ç®—æ³•æ ¸å¿ƒæ€æƒ³**ï¼š
> ```
> æƒé™æ£€æŸ¥ = ç”¨æˆ·æƒé™é›†åˆ âˆ© æ‰€éœ€æƒé™é›†åˆ â‰  âˆ…
> 
> é€šä¿—ç†è§£ï¼š
> - ç”¨æˆ·æœ‰å“ªäº›æƒé™ï¼ˆæƒé™æ¸…å•ï¼‰
> - æ“ä½œéœ€è¦å“ªäº›æƒé™ï¼ˆå‡†å…¥æ¡ä»¶ï¼‰  
> - ä¸¤è€…æœ‰äº¤é›†å°±å…è®¸ï¼Œæ— äº¤é›†å°±æ‹’ç»
> ```

### 10.2 åŸºç¡€æƒé™åŒ¹é…ç®—æ³•


**ğŸ”¸ ç²¾ç¡®åŒ¹é…ç®—æ³•**
```javascript
// ç²¾ç¡®æƒé™åŒ¹é…
class ExactPermissionMatcher {
    constructor() {
        this.matchType = 'EXACT';
    }
    
    // æ£€æŸ¥å•ä¸ªæƒé™
    checkSinglePermission(userPermissions, requiredPermission) {
        // ç›´æ¥å­—ç¬¦ä¸²åŒ¹é…
        return userPermissions.includes(requiredPermission);
    }
    
    // æ£€æŸ¥å¤šä¸ªæƒé™ï¼ˆANDé€»è¾‘ï¼‰
    checkMultiplePermissionsAND(userPermissions, requiredPermissions) {
        // æ‰€æœ‰æƒé™éƒ½å¿…é¡»æ‹¥æœ‰
        return requiredPermissions.every(permission => 
            userPermissions.includes(permission)
        );
    }
    
    // æ£€æŸ¥å¤šä¸ªæƒé™ï¼ˆORé€»è¾‘ï¼‰
    checkMultiplePermissionsOR(userPermissions, requiredPermissions) {
        // æ‹¥æœ‰ä»»æ„ä¸€ä¸ªæƒé™å³å¯
        return requiredPermissions.some(permission => 
            userPermissions.includes(permission)
        );
    }
    
    // ä½¿ç”¨ç¤ºä¾‹
    performPermissionCheck() {
        const userPermissions = ['user:read', 'user:write', 'article:read'];
        
        // å•æƒé™æ£€æŸ¥
        const canReadUser = this.checkSinglePermission(userPermissions, 'user:read');
        console.log('å¯ä»¥æŸ¥çœ‹ç”¨æˆ·:', canReadUser); // true
        
        // å¤šæƒé™ANDæ£€æŸ¥
        const canManageUser = this.checkMultiplePermissionsAND(
            userPermissions, 
            ['user:read', 'user:write']
        );
        console.log('å¯ä»¥ç®¡ç†ç”¨æˆ·:', canManageUser); // true
        
        // å¤šæƒé™ORæ£€æŸ¥
        const canReadSomething = this.checkMultiplePermissionsOR(
            userPermissions,
            ['admin:read', 'user:read']
        );
        console.log('å¯ä»¥è¯»å–æŸäº›å†…å®¹:', canReadSomething); // true
    }
}
```

**ğŸ”¸ é€šé…ç¬¦åŒ¹é…ç®—æ³•**
```javascript
// æ”¯æŒé€šé…ç¬¦çš„æƒé™åŒ¹é…
class WildcardPermissionMatcher {
    constructor() {
        this.matchType = 'WILDCARD';
    }
    
    // é€šé…ç¬¦æƒé™æ£€æŸ¥
    checkWildcardPermission(userPermissions, requiredPermission) {
        return userPermissions.some(userPerm => {
            return this.wildcardMatch(userPerm, requiredPermission);
        });
    }
    
    // é€šé…ç¬¦åŒ¹é…é€»è¾‘
    wildcardMatch(pattern, target) {
        // å°†é€šé…ç¬¦æ¨¡å¼è½¬æ¢ä¸ºæ­£åˆ™è¡¨è¾¾å¼
        const regexPattern = pattern
            .replace(/\./g, '\\.')      // è½¬ä¹‰ç‚¹å·
            .replace(/\*/g, '.*')       // * åŒ¹é…ä»»æ„å­—ç¬¦
            .replace(/\?/g, '.')        // ? åŒ¹é…å•ä¸ªå­—ç¬¦
            + ';                      // åŒ¹é…åˆ°å­—ç¬¦ä¸²æœ«å°¾
        
        const regex = new RegExp('^' + regexPattern);
        return regex.test(target);
    }
    
    // ä½¿ç”¨ç¤ºä¾‹
    performWildcardCheck() {
        const userPermissions = [
            'user:*',           // ç”¨æˆ·æ¨¡å—æ‰€æœ‰æƒé™
            'article:read',     // æ–‡ç« è¯»æƒé™
            'system:config:*'   // ç³»ç»Ÿé…ç½®æ‰€æœ‰æƒé™
        ];
        
        // æ£€æŸ¥å…·ä½“æƒé™
        const canWriteUser = this.checkWildcardPermission(userPermissions, 'user:write');
        console.log('å¯ä»¥ç¼–è¾‘ç”¨æˆ·:', canWriteUser); // true (åŒ¹é… user:*)
        
        const canDeleteArticle = this.checkWildcardPermission(userPermissions, 'article:delete');
        console.log('å¯ä»¥åˆ é™¤æ–‡ç« :', canDeleteArticle); // false
        
        const canViewConfig = this.checkWildcardPermission(userPermissions, 'system:config:view');
        console.log('å¯ä»¥æŸ¥çœ‹ç³»ç»Ÿé…ç½®:', canViewConfig); // true (åŒ¹é… system:config:*)
    }
}
```

### 10.3 å±‚æ¬¡åŒ–æƒé™ç®—æ³•


**ğŸ”¸ æƒé™ç»§æ‰¿ç®—æ³•**
```javascript
// å±‚æ¬¡åŒ–æƒé™æ£€æŸ¥å™¨
class HierarchicalPermissionChecker {
    constructor() {
        // å®šä¹‰æƒé™å±‚æ¬¡ç»“æ„
        this.permissionHierarchy = {
            'admin': ['admin:*'],                    // ç®¡ç†å‘˜æ‹¥æœ‰æ‰€æœ‰æƒé™
            'manager': ['user:*', 'article:*'],     // ç»ç†æ‹¥æœ‰ç”¨æˆ·å’Œæ–‡ç« æƒé™
            'editor': ['article:read', 'article:write'], // ç¼–è¾‘è€…æ‹¥æœ‰æ–‡ç« è¯»å†™æƒé™
            'viewer': ['article:read', 'user:read']  // æŸ¥çœ‹è€…æ‹¥æœ‰åŸºæœ¬è¯»æƒé™
        };
        
        // æƒé™çº§åˆ«ï¼ˆä»é«˜åˆ°ä½ï¼‰
        this.permissionLevels = {
            'admin': 4,
            'manager': 3,
            'editor': 2,
            'viewer': 1
        };
    }
    
    // æ ¹æ®è§’è‰²è·å–ç»§æ‰¿æƒé™
    getInheritedPermissions(userRoles) {
        let allPermissions = new Set();
        
        userRoles.forEach(role => {
            const rolePermissions = this.permissionHierarchy[role] || [];
            rolePermissions.forEach(permission => {
                // å¤„ç†é€šé…ç¬¦æƒé™
                if (permission.includes('*')) {
                    const expandedPermissions = this.expandWildcardPermission(permission);
                    expandedPermissions.forEach(perm => allPermissions.add(perm));
                } else {
                    allPermissions.add(permission);
                }
            });
        });
        
        return Array.from(allPermissions);
    }
    
    // å±•å¼€é€šé…ç¬¦æƒé™
    expandWildcardPermission(wildcardPermission) {
        // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥æ ¹æ®ç³»ç»Ÿæ‰€æœ‰æƒé™æ¥å±•å¼€
        const basePermissions = [
            'user:read', 'user:write', 'user:delete',
            'article:read', 'article:write', 'article:delete',
            'system:config', 'system:log'
        ];
        
        const pattern = wildcardPermission.replace('*', '.*');
        const regex = new RegExp('^' + pattern + ');
        
        return basePermissions.filter(perm => regex.test(perm));
    }
    
    // æ£€æŸ¥å±‚æ¬¡åŒ–æƒé™
    checkHierarchicalPermission(userRoles, requiredPermission) {
        const userPermissions = this.getInheritedPermissions(userRoles);
        
        // ç›´æ¥æƒé™åŒ¹é…
        if (userPermissions.includes(requiredPermission)) {
            return true;
        }
        
        // é€šé…ç¬¦åŒ¹é…
        return userPermissions.some(userPerm => {
            if (userPerm.includes('*')) {
                return this.wildcardMatch(userPerm, requiredPermission);
            }
            return false;
        });
    }
    
    // é€šé…ç¬¦åŒ¹é…ï¼ˆå¤ç”¨ä¹‹å‰çš„æ–¹æ³•ï¼‰
    wildcardMatch(pattern, target) {
        const regexPattern = pattern
            .replace(/\./g, '\\.')
            .replace(/\*/g, '.*') + ';
        const regex = new RegExp('^' + regexPattern);
        return regex.test(target);
    }
}
```

### 10.4 åŠ¨æ€æƒé™è®¡ç®—ç®—æ³•


**ğŸ”¸ ä¸Šä¸‹æ–‡æ„ŸçŸ¥æƒé™ç®—æ³•**
```javascript
// ä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„æƒé™æ£€æŸ¥å™¨
class ContextAwarePermissionChecker {
    constructor() {
        this.contextRules = new Map();
        this.initializeContextRules();
    }
    
    // åˆå§‹åŒ–ä¸Šä¸‹æ–‡è§„åˆ™
    initializeContextRules() {
        // æ—¶é—´ç›¸å…³è§„åˆ™
        this.contextRules.set('time_based', {
            check: (context) => {
                const now = new Date();
                const workingHours = context.workingHours || { start: 9, end: 18 };
                const currentHour = now.getHours();
                return currentHour >= workingHours.start && currentHour <= workingHours.end;
            },
            description: 'å·¥ä½œæ—¶é—´é™åˆ¶'
        });
        
        // åœ°ç†ä½ç½®ç›¸å…³è§„åˆ™
        this.contextRules.set('location_based', {
            check: (context) => {
                const userLocation = context.userLocation;
                const allowedLocations = context.allowedLocations || [];
                return allowedLocations.length === 0 || allowedLocations.includes(userLocation);
            },
            description: 'åœ°ç†ä½ç½®é™åˆ¶'
        });
        
        // èµ„æºæ‰€æœ‰æƒè§„åˆ™
        this.contextRules.set('resource_ownership', {
            check: (context) => {
                const userId = context.userId;
                const resourceOwnerId = context.resourceOwnerId;
                return userId === resourceOwnerId;
            },
            description: 'èµ„æºæ‰€æœ‰æƒæ£€æŸ¥'
        });
        
        // éƒ¨é—¨æƒé™è§„åˆ™
        this.contextRules.set('department_access', {
            check: (context) => {
                const userDepartment = context.userDepartment;
                const resourceDepartment = context.resourceDepartment;
                return userDepartment === resourceDepartment;
            },
            description: 'éƒ¨é—¨æƒé™æ£€æŸ¥'
        });
    }
    
    // åŠ¨æ€æƒé™æ£€æŸ¥
    checkDynamicPermission(userId, requiredPermission, context = {}) {
        // 1. åŸºç¡€æƒé™æ£€æŸ¥
        const hasBasicPermission = this.checkBasicPermission(userId, requiredPermission);
        if (!hasBasicPermission) {
            return {
                allowed: false,
                reason: 'ç¼ºå°‘åŸºç¡€æƒé™',
                permission: requiredPermission
            };
        }
        
        // 2. ä¸Šä¸‹æ–‡è§„åˆ™æ£€æŸ¥
        const contextCheckResults = this.evaluateContextRules(context);
        const failedRules = contextCheckResults.filter(result => !result.passed);
        
        if (failedRules.length > 0) {
            return {
                allowed: false,
                reason: 'ä¸Šä¸‹æ–‡æ¡ä»¶ä¸æ»¡è¶³',
                failedRules: failedRules.map(rule => rule.description),
                permission: requiredPermission
            };
        }
        
        // 3. æ‰€æœ‰æ£€æŸ¥é€šè¿‡
        return {
            allowed: true,
            reason: 'æƒé™æ£€æŸ¥é€šè¿‡',
            permission: requiredPermission,
            contextRules: contextCheckResults.length
        };
    }
    
    // è¯„ä¼°ä¸Šä¸‹æ–‡è§„åˆ™
    evaluateContextRules(context) {
        const results = [];
        
        for (const [ruleName, rule] of this.contextRules) {
            try {
                const passed = rule.check(context);
                results.push({
                    ruleName: ruleName,
                    description: rule.description,
                    passed: passed
                });
            } catch (error) {
                console.error(`ä¸Šä¸‹æ–‡è§„åˆ™${ruleName}è¯„ä¼°å¤±è´¥:`, error);
                results.push({
                    ruleName: ruleName,
                    description: rule.description,
                    passed: false,
                    error: error.message
                });
            }
        }
        
        return results;
    }
    
    // ä½¿ç”¨ç¤ºä¾‹
    async performDynamicCheck() {
        const context = {
            userId: 123,
            userDepartment: 'IT',
            userLocation: 'Beijing',
            resourceOwnerId: 123,
            resourceDepartment: 'IT',
            workingHours: { start: 9, end: 18 },
            allowedLocations: ['Beijing', 'Shanghai']
        };
        
        const result = this.checkDynamicPermission(123, 'user:edit', context);
        console.log('åŠ¨æ€æƒé™æ£€æŸ¥ç»“æœ:', result);
    }
}
```

### 10.5 æƒé™è¡¨è¾¾å¼è¯„ä¼°ç®—æ³•


**ğŸ”¸ æƒé™è¡¨è¾¾å¼è§£æå™¨**
```javascript
// æƒé™è¡¨è¾¾å¼è¯„ä¼°å™¨
class PermissionExpressionEvaluator {
    constructor() {
        this.operators = {
            'AND': (a, b) => a && b,
            'OR': (a, b) => a || b,
            'NOT': (a) => !a
        };
    }
    
    // è§£ææƒé™è¡¨è¾¾å¼
    parseExpression(expression) {
        // ç®€åŒ–çš„è¡¨è¾¾å¼è§£æï¼ˆå®é™…åº”ä½¿ç”¨ä¸“ä¸šçš„è¡¨è¾¾å¼è§£æå™¨ï¼‰
        return this.tokenizeExpression(expression);
    }
    
    // è¡¨è¾¾å¼åˆ†è¯
    tokenizeExpression(expression) {
        const tokens = [];
        const regex = /(\(|\)|AND|OR|NOT|[\w:]+)/g;
        let match;
        
        while ((match = regex.exec(expression)) !== null) {
            tokens.push(match[1]);
        }
        
        return tokens;
    }
    
    // è¯„ä¼°æƒé™è¡¨è¾¾å¼
    evaluateExpression(expression, userPermissions) {
        try {
            const tokens = this.parseExpression(expression);
            return this.evaluateTokens(tokens, userPermissions);
        } catch (error) {
            console.error('æƒé™è¡¨è¾¾å¼è¯„ä¼°å¤±è´¥:', error);
            return false;
        }
    }
    
    // è¯„ä¼°tokenåºåˆ—
    evaluateTokens(tokens, userPermissions) {
        const stack = [];
        
        for (let i = 0; i < tokens.length; i++) {
            const token = tokens[i];
            
            if (token === '(') {
                // æ‰¾åˆ°åŒ¹é…çš„å³æ‹¬å·ï¼Œé€’å½’å¤„ç†
                const subExpressionEnd = this.findMatchingBracket(tokens, i);
                const subTokens = tokens.slice(i + 1, subExpressionEnd);
                const subResult = this.evaluateTokens(subTokens, userPermissions);
                stack.push(subResult);
                i = subExpressionEnd; // è·³è¿‡å·²å¤„ç†çš„éƒ¨åˆ†
            } else if (token === 'NOT') {
                // å¤„ç†NOTæ“ä½œç¬¦
                const nextValue = this.getNextValue(tokens, i + 1, userPermissions);
                stack.push(!nextValue.result);
                i = nextValue.nextIndex;
            } else if (token === 'AND') {
                // ANDæ“ä½œç¬¦
                const leftValue = stack.pop();
                const rightValue = this.getNextValue(tokens, i + 1, userPermissions);
                stack.push(leftValue && rightValue.result);
                i = rightValue.nextIndex;
            } else if (token === 'OR') {
                // ORæ“ä½œç¬¦
                const leftValue = stack.pop();
                const rightValue = this.getNextValue(tokens, i + 1, userPermissions);
                stack.push(leftValue || rightValue.result);
                i = rightValue.nextIndex;
            } else if (this.isPermissionToken(token)) {
                // æƒé™æ£€æŸ¥
                const hasPermission = userPermissions.includes(token);
                stack.push(hasPermission);
            }
        }
        
        return stack.length > 0 ? stack[stack.length - 1] : false;
    }
    
    // æŸ¥æ‰¾åŒ¹é…çš„æ‹¬å·
    findMatchingBracket(tokens, startIndex) {
        let count = 1;
        for (let i = startIndex + 1; i < tokens.length; i++) {
            if (tokens[i] === '(') count++;
            if (tokens[i] === ')') count--;
            if (count === 0) return i;
        }
        throw new Error('æ‹¬å·ä¸åŒ¹é…');
    }
    
    // è·å–ä¸‹ä¸€ä¸ªå€¼
    getNextValue(tokens, index, userPermissions) {
        const token = tokens[index];
        
        if (this.isPermissionToken(token)) {
            return {
                result: userPermissions.includes(token),
                nextIndex: index
            };
        } else if (token === '(') {
            const endIndex = this.findMatchingBracket(tokens, index);
            const subTokens = tokens.slice(index + 1, endIndex);
            return {
                result: this.evaluateTokens(subTokens, userPermissions),
                nextIndex: endIndex
            };
        }
        
        throw new Error('æ— æ•ˆçš„è¡¨è¾¾å¼');
    }
    
    // åˆ¤æ–­æ˜¯å¦ä¸ºæƒé™token
    isPermissionToken(token) {
        return token && !['AND', 'OR', 'NOT', '(', ')'].includes(token);
    }
    
    // ä½¿ç”¨ç¤ºä¾‹
    performExpressionCheck() {
        const userPermissions = ['user:read', 'article:write', 'system:config'];
        
        // å¤æ‚æƒé™è¡¨è¾¾å¼
        const expressions = [
            'user:read AND article:write',                    // éœ€è¦ä¸¤ä¸ªæƒé™
            'user:admin OR (user:read AND article:write)',   // ç®¡ç†å‘˜æƒé™æˆ–è€…ä¸¤ä¸ªåŸºç¡€æƒé™
            'NOT user:delete',                               // æ²¡æœ‰åˆ é™¤æƒé™
            '(user:read OR article:read) AND system:config'  // å¤åˆæ¡ä»¶
        ];
        
        expressions.forEach(expr => {
            const result = this.evaluateExpression(expr, userPermissions);
            console.log(`è¡¨è¾¾å¼ "${expr}" ç»“æœ:`, result);
        });
    }
}
```

### 10.6 æƒé™æ£€æŸ¥æ€§èƒ½ä¼˜åŒ–


**ğŸ”¸ æƒé™æ£€æŸ¥ç¼“å­˜å’Œä¼˜åŒ–**
```javascript
// é«˜æ€§èƒ½æƒé™æ£€æŸ¥å™¨
class OptimizedPermissionChecker {
    constructor() {
        this.permissionCache = new Map();    // æƒé™ç»“æœç¼“å­˜
        this.compiledRules = new Map();      // ç¼–è¯‘åçš„è§„åˆ™ç¼“å­˜
        this.cacheExpireTime = 5 * 60 * 1000; // 5åˆ†é’Ÿè¿‡æœŸ
    }
    
    // é«˜æ•ˆæƒé™æ£€æŸ¥ï¼ˆå¸¦ç¼“å­˜ï¼‰
    async checkPermissionOptimized(userId, requiredPermission, context = {}) {
        // 1. æ„é€ ç¼“å­˜é”®
        const cacheKey = this.buildCacheKey(userId, requiredPermission, context);
        
        // 2. æ£€æŸ¥ç¼“å­˜
        const cachedResult = this.getFromCache(cacheKey);
        if (cachedResult) {
            return cachedResult;
        }
        
        // 3. æ‰§è¡Œæƒé™æ£€æŸ¥
        const startTime = Date.now();
        const result = await this.performPermissionCheck(userId, requiredPermission, context);
        const duration = Date.now() - startTime;
        
        // 4. ç¼“å­˜ç»“æœ
        this.setCache(cacheKey, result, duration);
        
        return result;
    }
    
    // æ‰¹é‡æƒé™æ£€æŸ¥ä¼˜åŒ–
    async checkMultiplePermissions(userId, permissions, context = {}) {
        // ä½¿ç”¨ Promise.all å¹¶å‘æ£€æŸ¥å¤šä¸ªæƒé™
        const checkPromises = permissions.map(permission => 
            this.checkPermissionOptimized(userId, permission, context)
        );
        
        const results = await Promise.all(checkPromises);
        
        // æ„é€ ç»“æœæ˜ å°„
        const resultMap = {};
        permissions.forEach((permission, index) => {
            resultMap[permission] = results[index];
        });
        
        return resultMap;
    }
    
    // æƒé™é¢„çƒ­åŠ è½½
    async preloadUserPermissions(userId) {
        try {
            // è·å–ç”¨æˆ·å¸¸ç”¨æƒé™
            const commonPermissions = await this.getUserCommonPermissions(userId);
            
            // é¢„å…ˆæ£€æŸ¥å¹¶ç¼“å­˜
            const preloadPromises = commonPermissions.map(permission =>
                this.checkPermissionOptimized(userId, permission)
            );
            
            await Promise.all(preloadPromises);
            console.log(`ç”¨æˆ·${userId}æƒé™é¢„çƒ­å®Œæˆï¼Œé¢„åŠ è½½${commonPermissions.length}ä¸ªæƒé™`);
            
        } catch (error) {
            console.error('æƒé™é¢„çƒ­å¤±è´¥:', error);
        }
    }
    
    // æ„é€ ç¼“å­˜é”®
    buildCacheKey(userId, permission, context) {
        const contextStr = JSON.stringify(context);
        const hash = this.hashString(contextStr);
        return `perm_${userId}_${permission}_${hash}`;
    }
    
    // ç®€å•å“ˆå¸Œå‡½æ•°
    hashString(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash; // è½¬ä¸º32ä½æ•´æ•°
        }
        return hash.toString(36);
    }
    
    // è·å–ç¼“å­˜
    getFromCache(cacheKey) {
        const cacheEntry = this.permissionCache.get(cacheKey);
        
        if (!cacheEntry) {
            return null;
        }
        
        // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
        if (Date.now() - cacheEntry.timestamp > this.cacheExpireTime) {
            this.permissionCache.delete(cacheKey);
            return null;
        }
        
        return cacheEntry.result;
    }
    
    // è®¾ç½®ç¼“å­˜
    setCache(cacheKey, result, duration) {
        this.permissionCache.set(cacheKey, {
            result: result,
            timestamp: Date.now(),
            checkDuration: duration
        });
        
        // å®šæœŸæ¸…ç†è¿‡æœŸç¼“å­˜
        if (this.permissionCache.size > 10000) { // ç¼“å­˜ä¸Šé™
            this.cleanupExpiredCache();
        }
    }
    
    // æ¸…ç†è¿‡æœŸç¼“å­˜
    cleanupExpiredCache() {
        const now = Date.now();
        const expiredKeys = [];
        
        for (const [key, entry] of this.permissionCache) {
            if (now - entry.timestamp > this.cacheExpireTime) {
                expiredKeys.push(key);
            }
        }
        
        expiredKeys.forEach(key => this.permissionCache.delete(key));
        console.log(`æ¸…ç†äº†${expiredKeys.length}ä¸ªè¿‡æœŸæƒé™ç¼“å­˜`);
    }
    
    // è·å–æ€§èƒ½ç»Ÿè®¡
    getPerformanceStats() {
        let totalDuration = 0;
        let cacheHits = 0;
        
        for (const entry of this.permissionCache.values()) {
            totalDuration += entry.checkDuration;
            cacheHits++;
        }
        
        return {
            cacheSize: this.permissionCache.size,
            cacheHits: cacheHits,
            averageCheckTime: cacheHits > 0 ? Math.round(totalDuration / cacheHits) + 'ms' : '0ms'
        };
    }
}
```

> ğŸ§® **æƒé™æ£€æŸ¥ç®—æ³•æ€»ç»“**ï¼š
> 
> **ğŸ”¹ ç®—æ³•é€‰æ‹©åŸåˆ™**
> - **ç®€å•åœºæ™¯**ï¼šä½¿ç”¨ç²¾ç¡®åŒ¹é…ç®—æ³•
> - **çµæ´»åœºæ™¯**ï¼šä½¿ç”¨é€šé…ç¬¦åŒ¹é…ç®—æ³•  
> - **å¤æ‚åœºæ™¯**ï¼šä½¿ç”¨è¡¨è¾¾å¼è¯„ä¼°ç®—æ³•
> - **é«˜æ€§èƒ½åœºæ™¯**ï¼šåŠ å…¥ç¼“å­˜å’Œä¼˜åŒ–ç­–ç•¥
> 
> **ğŸ”¹ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**
> - æƒé™ç»“æœç¼“å­˜ï¼ˆå‡å°‘é‡å¤è®¡ç®—ï¼‰
> - æ‰¹é‡æƒé™æ£€æŸ¥ï¼ˆå‡å°‘ç½‘ç»œå¼€é”€ï¼‰
> - æƒé™é¢„çƒ­åŠ è½½ï¼ˆæå‡é¦–æ¬¡è®¿é—®é€Ÿåº¦ï¼‰
> - è¡¨è¾¾å¼ç¼–è¯‘ç¼“å­˜ï¼ˆé¿å…é‡å¤è§£æï¼‰
> 
> **ğŸ”¹ ç®—æ³•å¤æ‚åº¦å¯¹æ¯”**
> - ç²¾ç¡®åŒ¹é…ï¼šO(n)ï¼Œnä¸ºæƒé™æ•°é‡
> - é€šé…ç¬¦åŒ¹é…ï¼šO(nÃ—m)ï¼Œmä¸ºæ¨¡å¼å¤æ‚åº¦
> - è¡¨è¾¾å¼è¯„ä¼°ï¼šO(nÃ—k)ï¼Œkä¸ºè¡¨è¾¾å¼å¤æ‚åº¦
> - ç¼“å­˜ä¼˜åŒ–åï¼šO(1)ï¼ˆç¼“å­˜å‘½ä¸­æ—¶ï¼‰

---

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ RBACæ¨¡å‹ï¼šç”¨æˆ·-è§’è‰²-æƒé™çš„ä¸‰å±‚æ¶æ„ï¼Œç®€åŒ–æƒé™ç®¡ç†
ğŸ”¸ è®¤è¯æµç¨‹ï¼šéªŒè¯"ä½ æ˜¯è°"ï¼Œé€šè¿‡ç”¨æˆ·åå¯†ç ç¡®è®¤èº«ä»½
ğŸ”¸ Tokenæœºåˆ¶ï¼šç™»å½•åè·å¾—çš„"é€šè¡Œè¯"ï¼Œæºå¸¦ç”¨æˆ·ä¿¡æ¯å’Œæƒé™
ğŸ”¸ æƒé™æ£€æŸ¥ï¼šéªŒè¯"ä½ èƒ½åšä»€ä¹ˆ"ï¼Œæ¯æ¬¡æ“ä½œå‰çš„æƒé™éªŒè¯
ğŸ”¸ ä¼šè¯ç®¡ç†ï¼šç®¡ç†ç”¨æˆ·åœ¨çº¿çŠ¶æ€ï¼Œæ§åˆ¶ç™»å½•æ—¶é•¿å’Œå®‰å…¨
ğŸ”¸ SSOå•ç‚¹ç™»å½•ï¼šä¸€æ¬¡ç™»å½•å¤šç³»ç»Ÿé€šç”¨ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
ğŸ”¸ æƒé™ç¼“å­˜ï¼šä¸´æ—¶å­˜å‚¨æƒé™ä¿¡æ¯ï¼Œæå‡ç³»ç»Ÿæ€§èƒ½
ğŸ”¸ å®‰å…¨é˜²æŠ¤ï¼šå¤šå±‚æ¬¡å®‰å…¨æªæ–½ï¼Œé˜²èŒƒå„ç§æ”»å‡»å¨èƒ
ğŸ”¸ æƒé™åˆ·æ–°ï¼šåŠæ—¶æ›´æ–°ç”¨æˆ·æƒé™ï¼Œä¿è¯æƒé™çš„æ—¶æ•ˆæ€§
ğŸ”¸ æ£€æŸ¥ç®—æ³•ï¼šé«˜æ•ˆçš„æƒé™åŒ¹é…å’ŒéªŒè¯è®¡ç®—é€»è¾‘
```

### 11.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ è®¤è¯vsæˆæƒçš„åŒºåˆ«**
```
è®¤è¯(Authentication)ï¼š
- å›ç­”ï¼š"ä½ æ˜¯è°ï¼Ÿ"
- æ–¹å¼ï¼šç”¨æˆ·åå¯†ç ã€ç”Ÿç‰©è¯†åˆ«ã€è¯ä¹¦ç­‰
- ç»“æœï¼šç¡®è®¤ç”¨æˆ·èº«ä»½

æˆæƒ(Authorization)ï¼š
- å›ç­”ï¼š"ä½ èƒ½åšä»€ä¹ˆï¼Ÿ"  
- æ–¹å¼ï¼šè§’è‰²æƒé™ã€è®¿é—®æ§åˆ¶åˆ—è¡¨ç­‰
- ç»“æœï¼šç¡®å®šæ“ä½œæƒé™

å…³ç³»ï¼šå…ˆè®¤è¯å†æˆæƒï¼Œä¸¤è€…ç¼ºä¸€ä¸å¯
```

**ğŸ”¹ RBACçš„æ ¸å¿ƒä¼˜åŠ¿**
```
ç›¸æ¯”ç›´æ¥æƒé™åˆ†é…çš„ä¼˜åŠ¿ï¼š
âœ… ç®¡ç†ç®€åŒ–ï¼šæŒ‰è§’è‰²æ‰¹é‡ç®¡ç†æƒé™
âœ… é™ä½å‡ºé”™ï¼šå‡å°‘æƒé™é—æ¼å’Œé”™é…
âœ… æ˜“äºç»´æŠ¤ï¼šäººå‘˜å˜åŠ¨åªéœ€è°ƒæ•´è§’è‰²
âœ… èŒè´£æ¸…æ™°ï¼šè§’è‰²ä¸æƒé™å¯¹åº”å…³ç³»æ˜ç¡®
âœ… æ‰©å±•æ€§å¥½ï¼šæ–°å¢è§’è‰²å’Œæƒé™ç›¸å¯¹å®¹æ˜“
```

**ğŸ”¹ Token vs Sessionçš„é€‰æ‹©**
```
Tokené€‚ç”¨åœºæ™¯ï¼š
- åˆ†å¸ƒå¼ç³»ç»Ÿ
- ç§»åŠ¨ç«¯åº”ç”¨  
- APIæœåŠ¡
- æ— çŠ¶æ€è®¾è®¡

Sessioné€‚ç”¨åœºæ™¯ï¼š
- ä¼ ç»ŸWebåº”ç”¨
- é›†ä¸­å¼ç³»ç»Ÿ
- éœ€è¦æœåŠ¡ç«¯æ§åˆ¶
- å®‰å…¨è¦æ±‚æé«˜
```

### 11.3 å®æ–½æœ€ä½³å®è·µ


**ğŸ”¹ æƒé™è®¾è®¡åŸåˆ™**
> ğŸ’¡ **æœ€å°æƒé™åŸåˆ™**ï¼šåªç»™ç”¨æˆ·å®Œæˆå·¥ä½œæ‰€éœ€çš„æœ€å°æƒé™é›†
> ğŸ”’ **æƒé™åˆ†ç¦»åŸåˆ™**ï¼šæ•æ„Ÿæ“ä½œéœ€è¦å¤šä¸ªæƒé™ç»„åˆ
> ğŸ¯ **èŒè´£åˆ†ç¦»åŸåˆ™**ï¼šä¸åŒèŒè´£çš„æƒé™åˆ†é…ç»™ä¸åŒè§’è‰²
> â° **æ—¶é™æ§åˆ¶åŸåˆ™**ï¼šæƒé™åº”è¯¥æœ‰æ—¶é—´é™åˆ¶å’Œå®šæœŸå®¡æŸ¥

**ğŸ”¹ å®‰å…¨å®æ–½å»ºè®®**
```
è®¤è¯å®‰å…¨ï¼š
- å¼ºå¯†ç ç­–ç•¥ + å¤šå› ç´ è®¤è¯
- ç™»å½•å¤±è´¥é™åˆ¶ + è´¦æˆ·é”å®š  
- å¯†ç åŠ å¯†å­˜å‚¨ + å®šæœŸæ›´æ¢

æˆæƒå®‰å…¨ï¼š
- å‚æ•°åŒ–æŸ¥è¯¢é˜²SQLæ³¨å…¥
- è¾“å…¥éªŒè¯å’Œæ¸…ç†
- æƒé™æ£€æŸ¥å¤šé‡éªŒè¯
- æ•æ„Ÿæ“ä½œé¢å¤–ç¡®è®¤

ä¼šè¯å®‰å…¨ï¼š  
- åˆç†çš„è¶…æ—¶æ—¶é—´
- Tokené»‘åå•æœºåˆ¶
- å®¢æˆ·ç«¯æŒ‡çº¹éªŒè¯
- HTTPSåŠ å¯†ä¼ è¾“
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**
```
ç¼“å­˜ç­–ç•¥ï¼š
- æƒé™ä¿¡æ¯é€‚å½“ç¼“å­˜
- è®¾ç½®åˆç†è¿‡æœŸæ—¶é—´
- æƒé™å˜æ›´åŠæ—¶æ›´æ–°ç¼“å­˜

æ‰¹é‡æ“ä½œï¼š
- æ‰¹é‡æƒé™æ£€æŸ¥
- åˆ†æ‰¹å¤„ç†å¤§é‡æ›´æ–°
- å¼‚æ­¥å¤„ç†éå…³é”®æ“ä½œ

ç›‘æ§ä¼˜åŒ–ï¼š
- æƒé™æ£€æŸ¥æ€§èƒ½ç›‘æ§
- ç¼“å­˜å‘½ä¸­ç‡ç»Ÿè®¡  
- å¼‚å¸¸æ“ä½œå‘Šè­¦
```

### 11.4 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ


**ğŸ”¹ æƒé™ç®¡ç†å¸¸è§é—®é¢˜**
| é—®é¢˜ | **åŸå› åˆ†æ** | **è§£å†³æ–¹æ¡ˆ** |
|------|-------------|-------------|
| **æƒé™è¿‡åº¦å¤æ‚** | `æƒé™ç²’åº¦è¿‡ç»†ï¼Œç®¡ç†æ··ä¹±` | `åˆç†è§„åˆ’æƒé™å±‚çº§ï¼Œä½¿ç”¨è§’è‰²ç®€åŒ–` |
| **æ€§èƒ½é—®é¢˜** | `é¢‘ç¹æŸ¥è¯¢æ•°æ®åº“æƒé™` | `å¼•å…¥ç¼“å­˜æœºåˆ¶ï¼Œæ‰¹é‡å¤„ç†` |
| **æƒé™ä¸åŒæ­¥** | `æƒé™å˜æ›´åæœªåŠæ—¶æ›´æ–°` | `å®ç°æƒé™åˆ·æ–°æœºåˆ¶ï¼Œå®æ—¶é€šçŸ¥` |
| **å®‰å…¨æ¼æ´** | `æƒé™æ£€æŸ¥ä¸ä¸¥æ ¼` | `å¤šå±‚æƒé™éªŒè¯ï¼Œå®‰å…¨å®¡è®¡` |

**ğŸ”¹ æŠ€æœ¯é€‰å‹å»ºè®®**
```
å°å‹ç³»ç»Ÿï¼ˆ<1ä¸‡ç”¨æˆ·ï¼‰ï¼š
- ç®€å•çš„Session + Cookie
- åŸºç¡€çš„è§’è‰²æƒé™ç®¡ç†
- å…³ç³»æ•°æ®åº“å­˜å‚¨

ä¸­å‹ç³»ç»Ÿï¼ˆ1-10ä¸‡ç”¨æˆ·ï¼‰ï¼š
- JWT Token + Redisç¼“å­˜
- å®Œæ•´çš„RBACæƒé™æ¨¡å‹  
- è´Ÿè½½å‡è¡¡ + æ•°æ®åº“é›†ç¾¤

å¤§å‹ç³»ç»Ÿï¼ˆ>10ä¸‡ç”¨æˆ·ï¼‰ï¼š
- åˆ†å¸ƒå¼Sessionç®¡ç†
- å¾®æœåŠ¡æƒé™ä¸­å¿ƒ
- ç¼“å­˜é›†ç¾¤ + åˆ†åº“åˆ†è¡¨
```

### 11.5 å­¦ä¹ è·¯å¾„å»ºè®®


**ğŸ¯ å­¦ä¹ é˜¶æ®µè§„åˆ’**
```
åˆçº§é˜¶æ®µï¼š
1. ç†è§£è®¤è¯å’Œæˆæƒçš„åŸºæœ¬æ¦‚å¿µ
2. æŒæ¡åŸºç¡€çš„ç™»å½•æ³¨å†Œæµç¨‹
3. å­¦ä¼šç®€å•çš„æƒé™æ£€æŸ¥å®ç°
4. äº†è§£å¸¸è§çš„å®‰å…¨å¨èƒå’Œé˜²æŠ¤

ä¸­çº§é˜¶æ®µï¼š
1. æ·±å…¥ç†è§£RBACæƒé™æ¨¡å‹
2. æŒæ¡JWT Tokençš„ä½¿ç”¨
3. å­¦ä¼šæƒé™ç¼“å­˜å’Œä¼˜åŒ–
4. å®ç°å®Œæ•´çš„æƒé™ç®¡ç†ç³»ç»Ÿ

é«˜çº§é˜¶æ®µï¼š
1. è®¾è®¡å¤æ‚çš„æƒé™æ§åˆ¶ç­–ç•¥
2. å®ç°å•ç‚¹ç™»å½•SSOç³»ç»Ÿ
3. æƒé™ç³»ç»Ÿçš„ç›‘æ§å’Œè¿ç»´
4. å®‰å…¨å®¡è®¡å’Œåˆè§„è¦æ±‚
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- **RBACä¸‰è¦ç´ **ï¼šç”¨æˆ·ã€è§’è‰²ã€æƒé™ï¼Œè§’è‰²æ˜¯æ¡¥æ¢
- **åŒé‡éªŒè¯**ï¼šå…ˆè®¤è¯èº«ä»½ï¼ŒåéªŒè¯æƒé™
- **Tokenæœºåˆ¶**ï¼šç™»å½•è·å‡­è¯ï¼Œè¯·æ±‚å¸¦ä»¤ç‰Œï¼ŒéªŒè¯æŸ¥æƒé™
- **å®‰å…¨ç¬¬ä¸€**ï¼šå¤šå±‚é˜²æŠ¤ï¼Œç¼“å­˜æ€§èƒ½ï¼Œç›‘æ§å‘Šè­¦
- **ç”¨æˆ·ä½“éªŒ**ï¼šæƒé™å˜æ›´åŠæ—¶é€šçŸ¥ï¼Œæ“ä½œæµç•…æ— æ„ŸçŸ¥