---
title: 19ã€RBACæ€§èƒ½ä¼˜åŒ–ç­–ç•¥
---
## ğŸ“š ç›®å½•

1. [RBACæ€§èƒ½é—®é¢˜æ¦‚è¿°](#1-RBACæ€§èƒ½é—®é¢˜æ¦‚è¿°)
2. [æƒé™æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–](#2-æƒé™æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–)
3. [ç¼“å­˜ç­–ç•¥è®¾è®¡](#3-ç¼“å­˜ç­–ç•¥è®¾è®¡)
4. [æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–](#4-æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–)
5. [æƒé™è®¡ç®—ç®—æ³•ä¼˜åŒ–](#5-æƒé™è®¡ç®—ç®—æ³•ä¼˜åŒ–)
6. [å¤§ç”¨æˆ·é‡åœºæ™¯å¤„ç†](#6-å¤§ç”¨æˆ·é‡åœºæ™¯å¤„ç†)
7. [æƒé™å˜æ›´å®æ—¶æ€§å¤„ç†](#7-æƒé™å˜æ›´å®æ—¶æ€§å¤„ç†)
8. [ç›‘æ§å’Œæ€§èƒ½æŒ‡æ ‡](#8-ç›‘æ§å’Œæ€§èƒ½æŒ‡æ ‡)
9. [ç³»ç»Ÿæ‰©å±•æ€§è®¾è®¡](#9-ç³»ç»Ÿæ‰©å±•æ€§è®¾è®¡)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸš€ RBACæ€§èƒ½é—®é¢˜æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯RBACæ€§èƒ½é—®é¢˜


**é€šä¿—è§£é‡Š**ï¼šæƒ³è±¡ä¸€ä¸‹å…¬å¸çš„é—¨ç¦ç³»ç»Ÿï¼Œæ¯æ¬¡å‘˜å·¥åˆ·å¡è¿›å…¥éƒ½è¦éªŒè¯æƒé™ã€‚å¦‚æœå‘˜å·¥å¾ˆå¤šï¼Œæ¯æ¬¡éªŒè¯éƒ½è¦æŸ¥è¯¢æ•°æ®åº“ï¼Œç³»ç»Ÿå°±ä¼šå˜å¾—å¾ˆæ…¢ã€‚RBACæƒé™ç³»ç»Ÿä¹Ÿæ˜¯å¦‚æ­¤ã€‚

```
ä¼ ç»ŸRBACæŸ¥è¯¢æµç¨‹ï¼ˆæ…¢ï¼‰ï¼š
ç”¨æˆ·ç™»å½• â†’ æŸ¥è¯¢ç”¨æˆ·è§’è‰² â†’ æŸ¥è¯¢è§’è‰²æƒé™ â†’ éªŒè¯å…·ä½“æ“ä½œæƒé™
     â†“           â†“            â†“              â†“
   æ•°æ®åº“      æ•°æ®åº“        æ•°æ®åº“         æ•°æ®åº“
   æŸ¥è¯¢1       æŸ¥è¯¢2         æŸ¥è¯¢3          æŸ¥è¯¢4

ç»“æœï¼šæ¯æ¬¡æƒé™éªŒè¯éœ€è¦å¤šæ¬¡æ•°æ®åº“æŸ¥è¯¢ = ç³»ç»Ÿå˜æ…¢
```

### 1.2 RBACæ€§èƒ½ç“¶é¢ˆè¡¨ç°


**ğŸ”¸ å¸¸è§æ€§èƒ½é—®é¢˜**ï¼š
- **æƒé™æŸ¥è¯¢æ…¢**ï¼šç”¨æˆ·ç™»å½•åè·å–æƒé™åˆ—è¡¨è€—æ—¶é•¿
- **é¢‘ç¹æ•°æ®åº“è®¿é—®**ï¼šæ¯ä¸ªæ“ä½œéƒ½è¦æŸ¥æ•°æ®åº“éªŒè¯æƒé™
- **å¤æ‚æƒé™è®¡ç®—**ï¼šå¤šå±‚çº§è§’è‰²ã€æƒé™ç»§æ‰¿è®¡ç®—å¤æ‚
- **å¤§é‡ç”¨æˆ·å¹¶å‘**ï¼šåŒæ—¶åœ¨çº¿ç”¨æˆ·å¤šæ—¶ç³»ç»Ÿå¡é¡¿

> ğŸ’¡ **ç®€å•ç†è§£**ï¼šå°±åƒè¶…å¸‚æ”¶é“¶å‘˜æ¯æ¬¡ç»“è´¦éƒ½è¦æ‰“ç”µè¯é—®ç»ç†"è¿™ä¸ªå•†å“èƒ½æ‰“æŠ˜å—ï¼Ÿ"ï¼Œå¦‚æœé¡¾å®¢å¾ˆå¤šï¼Œæ”¶é“¶å°±ä¼šå¾ˆæ…¢ã€‚

### 1.3 ä¼˜åŒ–çš„å¿…è¦æ€§


**ä¸ºä»€ä¹ˆè¦ä¼˜åŒ–**ï¼š
```
ä¸šåŠ¡åœºæ™¯ä¸¾ä¾‹ï¼š
ğŸ“± ç”µå•†å¹³å°ï¼šç”¨æˆ·æµè§ˆå•†å“æ—¶éœ€è¦éªŒè¯ä¼šå‘˜æŠ˜æ‰£æƒé™
ğŸ¢ ä¼ä¸šç³»ç»Ÿï¼šå‘˜å·¥æ¯æ¬¡æ“ä½œéƒ½è¦éªŒè¯éƒ¨é—¨æƒé™
ğŸ“Š æ•°æ®åˆ†æï¼šæŠ¥è¡¨æŸ¥çœ‹éœ€è¦éªŒè¯æ•°æ®æƒé™

å¦‚æœæ¯æ¬¡éƒ½æŸ¥æ•°æ®åº“ï¼š
ç”¨æˆ·ä½“éªŒå·® â†’ é¡µé¢åŠ è½½æ…¢
æœåŠ¡å™¨å‹åŠ›å¤§ â†’ æ•°æ®åº“è´Ÿè½½é«˜
æˆæœ¬å¢åŠ  â†’ éœ€è¦æ›´å¤šæœåŠ¡å™¨èµ„æº
```

---

## 2. âš¡ æƒé™æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–


### 2.1 æŸ¥è¯¢ä¼˜åŒ–åŸºæœ¬æ€è·¯


**ğŸ¯ æ ¸å¿ƒæ€æƒ³**ï¼šå‡å°‘æŸ¥è¯¢æ¬¡æ•°ï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡

```
ä¼˜åŒ–å‰ï¼ˆæ¯æ¬¡éƒ½æŸ¥ï¼‰ï¼š
ç”¨æˆ·æ“ä½œ â†’ æŸ¥ç”¨æˆ·ä¿¡æ¯ â†’ æŸ¥è§’è‰²ä¿¡æ¯ â†’ æŸ¥æƒé™ä¿¡æ¯ â†’ éªŒè¯

ä¼˜åŒ–åï¼ˆæ‰¹é‡æŸ¥è¯¢ï¼‰ï¼š
ç”¨æˆ·ç™»å½•æ—¶ â†’ ä¸€æ¬¡æ€§æŸ¥å‡ºæ‰€æœ‰æƒé™ â†’ å­˜å‚¨èµ·æ¥ â†’ ç›´æ¥éªŒè¯
```

### 2.2 æƒé™é¢„åŠ è½½ç­–ç•¥


**ä»€ä¹ˆæ˜¯æƒé™é¢„åŠ è½½**ï¼šç”¨æˆ·ç™»å½•æ—¶ï¼Œä¸€æ¬¡æ€§æŠŠæ‰€æœ‰æƒé™ä¿¡æ¯æŸ¥å‡ºæ¥å­˜å¥½ï¼Œåç»­ç›´æ¥ä½¿ç”¨ã€‚

```java
// âœ… ä¼˜åŒ–åï¼šç™»å½•æ—¶é¢„åŠ è½½æ‰€æœ‰æƒé™
public class UserPermissionService {
    
    public UserPermissions loadUserPermissions(Long userId) {
        // ä¸€æ¬¡æ€§æŸ¥è¯¢ç”¨æˆ·çš„æ‰€æœ‰æƒé™ä¿¡æ¯
        List<String> permissions = permissionRepository
            .findAllPermissionsByUserId(userId);
        
        // å­˜å‚¨åˆ°ç”¨æˆ·ä¼šè¯æˆ–ç¼“å­˜ä¸­
        return new UserPermissions(userId, permissions);
    }
    
    // éªŒè¯æƒé™æ—¶ç›´æ¥ä»å†…å­˜åˆ¤æ–­
    public boolean hasPermission(UserPermissions userPerms, String permission) {
        return userPerms.getPermissions().contains(permission);
    }
}
```

### 2.3 SQLæŸ¥è¯¢ä¼˜åŒ–


**ğŸ”¸ å•æ¬¡å¤åˆæŸ¥è¯¢**ï¼šç”¨ä¸€æ¡SQLè¯­å¥æŸ¥å‡ºç”¨æˆ·æ‰€æœ‰æƒé™

```sql
-- âœ… ä¼˜åŒ–åï¼šä¸€æ¡SQLæŸ¥å‡ºç”¨æˆ·æ‰€æœ‰æƒé™
SELECT DISTINCT p.permission_code, p.permission_name
FROM users u
JOIN user_roles ur ON u.id = ur.user_id
JOIN roles r ON ur.role_id = r.id  
JOIN role_permissions rp ON r.id = rp.role_id
JOIN permissions p ON rp.permission_id = p.id
WHERE u.id = ? AND u.status = 'ACTIVE' AND r.status = 'ACTIVE'
```

**å¯¹æ¯”ä¼ ç»Ÿæ–¹å¼**ï¼š
```sql
-- âŒ ä¼ ç»Ÿæ–¹å¼ï¼šéœ€è¦å¤šæ¬¡æŸ¥è¯¢
-- ç¬¬1æ¬¡ï¼šæŸ¥ç”¨æˆ·è§’è‰²
SELECT role_id FROM user_roles WHERE user_id = ?

-- ç¬¬2æ¬¡ï¼šæŸ¥è§’è‰²æƒé™  
SELECT permission_id FROM role_permissions WHERE role_id IN (...)

-- ç¬¬3æ¬¡ï¼šæŸ¥æƒé™è¯¦æƒ…
SELECT * FROM permissions WHERE id IN (...)
```

### 2.4 æƒé™æ ‘ç»“æ„ä¼˜åŒ–


**ä»€ä¹ˆæ˜¯æƒé™æ ‘**ï¼šæŠŠæƒé™æŒ‰å±‚çº§å…³ç³»ç»„ç»‡ï¼Œæ–¹ä¾¿å¿«é€ŸæŸ¥æ‰¾ã€‚

```
æƒé™æ ‘ç¤ºä¾‹ï¼š
ç³»ç»Ÿç®¡ç†
â”œâ”€â”€ ç”¨æˆ·ç®¡ç†
â”‚   â”œâ”€â”€ ç”¨æˆ·æŸ¥çœ‹
â”‚   â”œâ”€â”€ ç”¨æˆ·æ·»åŠ 
â”‚   â””â”€â”€ ç”¨æˆ·åˆ é™¤
â””â”€â”€ è§’è‰²ç®¡ç†
    â”œâ”€â”€ è§’è‰²æŸ¥çœ‹
    â””â”€â”€ è§’è‰²ç¼–è¾‘
```

```java
// æƒé™æ ‘æ•°æ®ç»“æ„
public class PermissionTree {
    private Map<String, Set<String>> permissionTree = new HashMap<>();
    
    // æ£€æŸ¥æƒé™æ—¶åªéœ€è¦æŸ¥æ‰¾Map
    public boolean hasPermission(String userRole, String permission) {
        Set<String> rolePermissions = permissionTree.get(userRole);
        return rolePermissions != null && rolePermissions.contains(permission);
    }
}
```

---

## 3. ğŸ—‚ï¸ ç¼“å­˜ç­–ç•¥è®¾è®¡


### 3.1 ç¼“å­˜çš„ä½œç”¨


**é€šä¿—ç†è§£**ï¼šç¼“å­˜å°±åƒæ˜¯åœ¨ä½ çš„é’±åŒ…é‡Œæ”¾ä¸€äº›å¸¸ç”¨çš„ä¼šå‘˜å¡ï¼Œä¸ç”¨æ¯æ¬¡éƒ½å»ç¿»åŒ…æ‰¾ã€‚æƒé™ç¼“å­˜ä¹Ÿæ˜¯ä¸€æ ·ï¼ŒæŠŠå¸¸ç”¨çš„æƒé™ä¿¡æ¯æ”¾åœ¨"è¿‘å¤„"ï¼Œä¸ç”¨æ¯æ¬¡éƒ½æŸ¥æ•°æ®åº“ã€‚

### 3.2 Redisç¼“å­˜åº”ç”¨


**ğŸ”¸ ç”¨æˆ·æƒé™ç¼“å­˜**ï¼š

```java
@Service
public class PermissionCacheService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // ç¼“å­˜ç”¨æˆ·æƒé™ï¼ˆ30åˆ†é’Ÿè¿‡æœŸï¼‰
    public void cacheUserPermissions(Long userId, Set<String> permissions) {
        String key = "user:permissions:" + userId;
        redisTemplate.opsForValue().set(key, permissions, 30, TimeUnit.MINUTES);
    }
    
    // ä»ç¼“å­˜è·å–æƒé™
    public Set<String> getCachedPermissions(Long userId) {
        String key = "user:permissions:" + userId;
        return (Set<String>) redisTemplate.opsForValue().get(key);
    }
    
    // æƒé™éªŒè¯ï¼ˆå…ˆæŸ¥ç¼“å­˜ï¼Œå†æŸ¥æ•°æ®åº“ï¼‰
    public boolean hasPermission(Long userId, String permission) {
        Set<String> permissions = getCachedPermissions(userId);
        
        if (permissions == null) {
            // ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“å¹¶ç¼“å­˜
            permissions = loadPermissionsFromDB(userId);
            cacheUserPermissions(userId, permissions);
        }
        
        return permissions.contains(permission);
    }
}
```

### 3.3 å¤šå±‚ç¼“å­˜ç­–ç•¥


**ğŸ”¸ ç¼“å­˜å±‚çº§è®¾è®¡**ï¼š

```
ç¬¬1å±‚ï¼šæœ¬åœ°ç¼“å­˜ï¼ˆæœ€å¿«ï¼Œå®¹é‡å°ï¼‰
ç¬¬2å±‚ï¼šRedisç¼“å­˜ï¼ˆè¾ƒå¿«ï¼Œå®¹é‡å¤§ï¼‰
ç¬¬3å±‚ï¼šæ•°æ®åº“ï¼ˆæœ€æ…¢ï¼Œæ•°æ®æœ€å…¨ï¼‰

æŸ¥è¯¢æµç¨‹ï¼š
æœ¬åœ°ç¼“å­˜ â†’ Redisç¼“å­˜ â†’ æ•°æ®åº“
   â†“         â†“          â†“
 æ‰¾åˆ°äº†    æ‰¾åˆ°äº†      ä¸€å®šæœ‰
```

```java
// å¤šå±‚ç¼“å­˜å®ç°
@Service
public class MultiLevelCacheService {
    
    // æœ¬åœ°ç¼“å­˜ï¼ˆè¿›ç¨‹å†…ï¼‰
    private LoadingCache<Long, Set<String>> localCache = Caffeine.newBuilder()
        .maximumSize(1000)
        .expireAfterWrite(5, TimeUnit.MINUTES)
        .build(userId -> loadFromRedisOrDB(userId));
    
    public boolean hasPermission(Long userId, String permission) {
        try {
            Set<String> permissions = localCache.get(userId);
            return permissions.contains(permission);
        } catch (ExecutionException e) {
            return false;
        }
    }
}
```

### 3.4 ç¼“å­˜æ›´æ–°ç­–ç•¥


**ğŸ”¸ æƒé™å˜æ›´æ—¶å¦‚ä½•æ›´æ–°ç¼“å­˜**ï¼š

```
åœºæ™¯ï¼šç®¡ç†å‘˜ä¿®æ”¹äº†ç”¨æˆ·Açš„è§’è‰²
é—®é¢˜ï¼šç¼“å­˜ä¸­è¿˜æ˜¯æ—§çš„æƒé™ä¿¡æ¯

è§£å†³æ–¹æ¡ˆï¼š
1. ç«‹å³åˆ é™¤ç¼“å­˜ âœ…ï¼ˆæ¨èï¼‰
2. æ›´æ–°ç¼“å­˜å†…å®¹ âš ï¸ï¼ˆå¯èƒ½ä¸ä¸€è‡´ï¼‰
3. è®¾ç½®çŸ­è¿‡æœŸæ—¶é—´ âš ï¸ï¼ˆå»¶è¿Ÿæ›´æ–°ï¼‰
```

```java
// æƒé™å˜æ›´æ—¶æ¸…é™¤ç¼“å­˜
@Service
public class PermissionUpdateService {
    
    public void updateUserRole(Long userId, List<Long> roleIds) {
        // 1. æ›´æ–°æ•°æ®åº“
        userRoleRepository.updateUserRoles(userId, roleIds);
        
        // 2. ç«‹å³æ¸…é™¤ç¼“å­˜
        clearUserPermissionCache(userId);
        
        // 3. é€šçŸ¥å…¶ä»–æœåŠ¡å™¨æ¸…é™¤ç¼“å­˜ï¼ˆåˆ†å¸ƒå¼ç¯å¢ƒï¼‰
        messagePublisher.publish("permission.updated", userId);
    }
    
    private void clearUserPermissionCache(Long userId) {
        String key = "user:permissions:" + userId;
        redisTemplate.delete(key);
    }
}
```

---

## 4. ğŸ—ƒï¸ æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–


### 4.1 æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–


**ä»€ä¹ˆæ˜¯æ•°æ®åº“ç´¢å¼•**ï¼šå°±åƒä¹¦çš„ç›®å½•ï¼Œå¸®ä½ å¿«é€Ÿæ‰¾åˆ°æƒ³è¦çš„å†…å®¹ï¼Œä¸ç”¨ä¸€é¡µä¸€é¡µç¿»ã€‚

**ğŸ”¸ RBACå…³é”®è¡¨ç´¢å¼•è®¾è®¡**ï¼š

```sql
-- ç”¨æˆ·è§’è‰²è¡¨ç´¢å¼•
CREATE INDEX idx_user_roles_user_id ON user_roles(user_id);
CREATE INDEX idx_user_roles_role_id ON user_roles(role_id);

-- è§’è‰²æƒé™è¡¨ç´¢å¼•  
CREATE INDEX idx_role_permissions_role_id ON role_permissions(role_id);
CREATE INDEX idx_role_permissions_permission_id ON role_permissions(permission_id);

-- å¤åˆç´¢å¼•ï¼ˆæœ€é‡è¦ï¼‰
CREATE INDEX idx_user_roles_status ON user_roles(user_id, status);
CREATE INDEX idx_role_permissions_status ON role_permissions(role_id, status);
```

### 4.2 æŸ¥è¯¢è¯­å¥ä¼˜åŒ–


**ğŸ”¸ é¿å…N+1æŸ¥è¯¢é—®é¢˜**ï¼š

```java
// âŒ é”™è¯¯æ–¹å¼ï¼šN+1æŸ¥è¯¢
public List<UserPermission> getUserPermissions(List<Long> userIds) {
    List<UserPermission> result = new ArrayList<>();
    
    for (Long userId : userIds) {
        // æ¯ä¸ªç”¨æˆ·éƒ½æŸ¥è¯¢ä¸€æ¬¡æ•°æ®åº“ = Næ¬¡æŸ¥è¯¢
        List<String> permissions = permissionRepository.findByUserId(userId);
        result.add(new UserPermission(userId, permissions));
    }
    return result;
}

// âœ… æ­£ç¡®æ–¹å¼ï¼šæ‰¹é‡æŸ¥è¯¢
public List<UserPermission> getUserPermissions(List<Long> userIds) {
    // ä¸€æ¬¡æŸ¥è¯¢è·å–æ‰€æœ‰ç”¨æˆ·çš„æƒé™
    Map<Long, List<String>> permissionMap = 
        permissionRepository.findByUserIds(userIds);
    
    return userIds.stream()
        .map(id -> new UserPermission(id, permissionMap.get(id)))
        .collect(Collectors.toList());
}
```

### 4.3 æ•°æ®è¡¨ç»“æ„ä¼˜åŒ–


**ğŸ”¸ å†—ä½™è®¾è®¡æé«˜æŸ¥è¯¢æ•ˆç‡**ï¼š

```sql
-- ä¼ ç»Ÿè®¾è®¡ï¼šéœ€è¦å¤šè¡¨å…³è”
users â†’ user_roles â†’ roles â†’ role_permissions â†’ permissions

-- ä¼˜åŒ–è®¾è®¡ï¼šå¢åŠ å†—ä½™è¡¨
CREATE TABLE user_permission_cache (
    user_id BIGINT,
    permission_code VARCHAR(100),
    created_time TIMESTAMP,
    INDEX idx_user_permission (user_id, permission_code)
);

-- æŸ¥è¯¢æ—¶ç›´æ¥ä½¿ç”¨ç¼“å­˜è¡¨
SELECT permission_code FROM user_permission_cache WHERE user_id = ?
```

---

## 5. ğŸ§® æƒé™è®¡ç®—ç®—æ³•ä¼˜åŒ–


### 5.1 æƒé™è®¡ç®—çš„å¤æ‚æ€§


**ä»€ä¹ˆæ˜¯æƒé™è®¡ç®—**ï¼šåˆ¤æ–­ç”¨æˆ·æ˜¯å¦æœ‰æŸä¸ªæ“ä½œæƒé™çš„è¿‡ç¨‹ã€‚

```
ç®€å•åœºæ™¯ï¼š
ç”¨æˆ·A â†’ è§’è‰²B â†’ æƒé™C
åˆ¤æ–­ï¼šç”¨æˆ·Aæ˜¯å¦æœ‰æƒé™Cï¼Ÿç›´æ¥æŸ¥è¡¨å³å¯

å¤æ‚åœºæ™¯ï¼š
ç”¨æˆ·A â†’ å¤šä¸ªè§’è‰² â†’ æ¯ä¸ªè§’è‰²æœ‰å¤šä¸ªæƒé™ â†’ æƒé™ä¹‹é—´æœ‰ç»§æ‰¿å…³ç³»
åˆ¤æ–­ï¼šç”¨æˆ·Aæ˜¯å¦æœ‰æƒé™Xï¼Ÿéœ€è¦å¤æ‚è®¡ç®—
```

### 5.2 æƒé™ç»§æ‰¿ç®—æ³•ä¼˜åŒ–


**ğŸ”¸ æƒé™ç»§æ‰¿ç¤ºä¾‹**ï¼š

```
æƒé™ç»§æ‰¿å…³ç³»ï¼š
- éƒ¨é—¨ç»ç†ï¼šåŒ…å«æ™®é€šå‘˜å·¥çš„æ‰€æœ‰æƒé™ + å®¡æ‰¹æƒé™
- æ™®é€šå‘˜å·¥ï¼šåŸºç¡€æŸ¥çœ‹æƒé™ + ç¼–è¾‘æƒé™
- è®¿å®¢ï¼šä»…æœ‰æŸ¥çœ‹æƒé™

é—®é¢˜ï¼šå¦‚ä½•å¿«é€Ÿåˆ¤æ–­éƒ¨é—¨ç»ç†æ˜¯å¦æœ‰"æŸ¥çœ‹æŠ¥è¡¨"æƒé™ï¼Ÿ
```

```java
// âœ… æƒé™ç»§æ‰¿å¿«é€Ÿè®¡ç®—
public class PermissionInheritanceCalculator {
    
    // é¢„è®¡ç®—æƒé™ç»§æ‰¿æ ‘
    private Map<String, Set<String>> inheritanceTree = new HashMap<>();
    
    // ç³»ç»Ÿå¯åŠ¨æ—¶é¢„è®¡ç®—æ‰€æœ‰ç»§æ‰¿å…³ç³»
    @PostConstruct
    public void buildInheritanceTree() {
        Map<String, List<String>> parentChildMap = loadPermissionHierarchy();
        
        for (String permission : getAllPermissions()) {
            Set<String> inheritedPermissions = new HashSet<>();
            calculateInheritedPermissions(permission, parentChildMap, inheritedPermissions);
            inheritanceTree.put(permission, inheritedPermissions);
        }
    }
    
    // O(1)æ—¶é—´å¤æ‚åº¦æ£€æŸ¥æƒé™
    public boolean hasPermission(String userPermission, String targetPermission) {
        Set<String> inheritedPermissions = inheritanceTree.get(userPermission);
        return inheritedPermissions != null && inheritedPermissions.contains(targetPermission);
    }
}
```

### 5.3 ä½è¿ç®—æƒé™ä¼˜åŒ–


**ä»€ä¹ˆæ˜¯ä½è¿ç®—æƒé™**ï¼šç”¨äºŒè¿›åˆ¶ä½è¡¨ç¤ºæƒé™ï¼Œè®¡ç®—é€Ÿåº¦æå¿«ã€‚

```java
// ä½è¿ç®—æƒé™è®¾è®¡
public class BitPermissionManager {
    
    // æƒé™å¸¸é‡å®šä¹‰
    public static final long PERM_READ   = 1L;      // 0001
    public static final long PERM_WRITE  = 2L;      // 0010  
    public static final long PERM_DELETE = 4L;      // 0100
    public static final long PERM_ADMIN  = 8L;      // 1000
    
    // æ£€æŸ¥æƒé™ï¼ˆæå¿«ï¼‰
    public boolean hasPermission(long userPermissions, long targetPermission) {
        return (userPermissions & targetPermission) == targetPermission;
    }
    
    // æ·»åŠ æƒé™
    public long addPermission(long userPermissions, long newPermission) {
        return userPermissions | newPermission;
    }
    
    // ç§»é™¤æƒé™
    public long removePermission(long userPermissions, long targetPermission) {
        return userPermissions & (~targetPermission);
    }
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```java
// ç”¨æˆ·æƒé™ï¼šè¯»+å†™ = 0001 | 0010 = 0011
long userPerms = PERM_READ | PERM_WRITE;

// æ£€æŸ¥æ˜¯å¦æœ‰è¯»æƒé™ï¼š0011 & 0001 = 0001 âœ…
boolean canRead = hasPermission(userPerms, PERM_READ);

// æ£€æŸ¥æ˜¯å¦æœ‰åˆ é™¤æƒé™ï¼š0011 & 0100 = 0000 âŒ
boolean canDelete = hasPermission(userPerms, PERM_DELETE);
```

---

## 6. ğŸ‘¥ å¤§ç”¨æˆ·é‡åœºæ™¯å¤„ç†


### 6.1 å¤§ç”¨æˆ·é‡æŒ‘æˆ˜


**ä»€ä¹ˆæ˜¯å¤§ç”¨æˆ·é‡**ï¼šæˆåƒä¸Šä¸‡çš„ç”¨æˆ·åŒæ—¶ä½¿ç”¨ç³»ç»Ÿï¼Œæ¯ç§’é’Ÿæœ‰å¤§é‡æƒé™éªŒè¯è¯·æ±‚ã€‚

```
æŒ‘æˆ˜åœºæ™¯ï¼š
ğŸ“± ç”µå•†å¤§ä¿ƒï¼šç™¾ä¸‡ç”¨æˆ·åŒæ—¶æŠ¢è´­ï¼Œéœ€è¦éªŒè¯ä¼šå‘˜æƒé™
ğŸ¢ å¤§ä¼ä¸šï¼šä¸‡äººåŒæ—¶åŠå…¬ï¼Œé¢‘ç¹æƒé™éªŒè¯
ğŸ® æ¸¸æˆå¹³å°ï¼šå¤§é‡ç©å®¶åŒæ—¶åœ¨çº¿ï¼Œæƒé™éªŒè¯å‹åŠ›å¤§

é—®é¢˜ï¼š
- æ•°æ®åº“è¿æ¥æ•°ä¸å¤Ÿ
- ç¼“å­˜å†…å­˜å ç”¨è¿‡å¤§  
- æƒé™è®¡ç®—CPUå‹åŠ›å¤§
- å“åº”æ—¶é—´å˜é•¿
```

### 6.2 åˆ†ç‰‡å­˜å‚¨ç­–ç•¥


**ä»€ä¹ˆæ˜¯åˆ†ç‰‡**ï¼šæŠŠå¤§é‡æ•°æ®åˆ†æ•£åˆ°å¤šä¸ªæ•°æ®åº“ä¸­å­˜å‚¨ï¼Œå‡è½»å•ä¸ªæ•°æ®åº“å‹åŠ›ã€‚

```java
// ç”¨æˆ·åˆ†ç‰‡ç­–ç•¥
public class UserShardingService {
    
    private static final int SHARD_COUNT = 8; // 8ä¸ªæ•°æ®åº“åˆ†ç‰‡
    
    // æ ¹æ®ç”¨æˆ·IDè®¡ç®—åˆ†ç‰‡
    public int getShardIndex(Long userId) {
        return (int) (userId % SHARD_COUNT);
    }
    
    // ä»å¯¹åº”åˆ†ç‰‡æŸ¥è¯¢æƒé™
    public Set<String> getUserPermissions(Long userId) {
        int shardIndex = getShardIndex(userId);
        DataSource dataSource = getShardDataSource(shardIndex);
        
        // ä»å¯¹åº”çš„æ•°æ®åº“åˆ†ç‰‡æŸ¥è¯¢
        return queryPermissionsFromShard(dataSource, userId);
    }
}
```

### 6.3 æƒé™é¢„è®¡ç®—


**ä»€ä¹ˆæ˜¯æƒé™é¢„è®¡ç®—**ï¼šæå‰ç®—å¥½æ‰€æœ‰å¯èƒ½çš„æƒé™ç»„åˆï¼ŒæŸ¥è¯¢æ—¶ç›´æ¥ä½¿ç”¨ç»“æœã€‚

```java
// æƒé™é¢„è®¡ç®—æœåŠ¡
@Service  
public class PermissionPrecomputeService {
    
    // å®šæ—¶ä»»åŠ¡ï¼šæ¯å¤©å‡Œæ™¨é¢„è®¡ç®—æƒé™
    @Scheduled(cron = "0 0 2 * * ?")
    public void precomputeAllUserPermissions() {
        List<Long> allUserIds = userRepository.findAllActiveUserIds();
        
        // æ‰¹é‡å¤„ç†ï¼Œé¿å…å†…å­˜æº¢å‡º
        int batchSize = 1000;
        for (int i = 0; i < allUserIds.size(); i += batchSize) {
            List<Long> batch = allUserIds.subList(i, 
                Math.min(i + batchSize, allUserIds.size()));
            
            precomputeBatchPermissions(batch);
        }
    }
    
    private void precomputeBatchPermissions(List<Long> userIds) {
        Map<Long, Set<String>> permissionMap = 
            permissionService.batchLoadPermissions(userIds);
        
        // å­˜å‚¨åˆ°é¢„è®¡ç®—ç»“æœè¡¨
        permissionCacheRepository.batchSave(permissionMap);
    }
}
```

### 6.4 å¼‚æ­¥æƒé™åŠ è½½


**å¼‚æ­¥åŠ è½½çš„å¥½å¤„**ï¼šç”¨æˆ·ç™»å½•åï¼Œåœ¨åå°æ…¢æ…¢åŠ è½½æƒé™ï¼Œä¸å½±å“ç”¨æˆ·ä½“éªŒã€‚

```java
// å¼‚æ­¥æƒé™åŠ è½½
@Service
public class AsyncPermissionLoader {
    
    @Async
    public CompletableFuture<Set<String>> loadUserPermissionsAsync(Long userId) {
        // åå°å¼‚æ­¥åŠ è½½æƒé™
        Set<String> permissions = permissionRepository.findByUserId(userId);
        
        // åŠ è½½å®Œæˆåç¼“å­˜
        cacheService.cacheUserPermissions(userId, permissions);
        
        return CompletableFuture.completedFuture(permissions);
    }
    
    // ç”¨æˆ·ç™»å½•å¤„ç†
    public LoginResponse userLogin(String username, String password) {
        User user = authenticateUser(username, password);
        
        // å¼‚æ­¥åŠ è½½æƒé™ï¼Œä¸é˜»å¡ç™»å½•
        loadUserPermissionsAsync(user.getId());
        
        // å…ˆè¿”å›ç™»å½•æˆåŠŸï¼Œæƒé™åç»­åŠ è½½
        return new LoginResponse(user, "æƒé™åŠ è½½ä¸­...");
    }
}
```

---

## 7. âš¡ æƒé™å˜æ›´å®æ—¶æ€§å¤„ç†


### 7.1 æƒé™å˜æ›´çš„å®æ—¶æ€§é—®é¢˜


**ä»€ä¹ˆæ˜¯å®æ—¶æ€§é—®é¢˜**ï¼šç®¡ç†å‘˜ç»™ç”¨æˆ·åˆ†é…äº†æ–°æƒé™ï¼Œä½†ç”¨æˆ·éœ€è¦é‡æ–°ç™»å½•æ‰èƒ½ç”Ÿæ•ˆï¼Œä½“éªŒä¸å¥½ã€‚

```
å…¸å‹åœºæ™¯ï¼š
1. HRç»™æ–°å‘˜å·¥åˆ†é…éƒ¨é—¨è§’è‰²
2. å‘˜å·¥ç«‹å³å»è®¿é—®éƒ¨é—¨æ–‡æ¡£
3. ç³»ç»Ÿæç¤º"æƒé™ä¸è¶³" âŒ
4. å‘˜å·¥éœ€è¦é‡æ–°ç™»å½• ğŸ˜¤

ç†æƒ³æƒ…å†µï¼š
æƒé™åˆ†é…å®Œæˆ â†’ ç«‹å³ç”Ÿæ•ˆ â†’ ç”¨æˆ·å¯ä»¥æ­£å¸¸ä½¿ç”¨ âœ…
```

### 7.2 æ¶ˆæ¯é˜Ÿåˆ—å®æ—¶æ›´æ–°


**ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—é€šçŸ¥æƒé™å˜æ›´**ï¼š

```java
// æƒé™å˜æ›´å‘å¸ƒè€…
@Service
public class PermissionChangePublisher {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    // æƒé™å˜æ›´æ—¶å‘å¸ƒæ¶ˆæ¯
    public void publishPermissionChange(Long userId, String changeType) {
        PermissionChangeEvent event = new PermissionChangeEvent();
        event.setUserId(userId);
        event.setChangeType(changeType); // ADD, REMOVE, UPDATE
        event.setTimestamp(System.currentTimeMillis());
        
        // å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—
        rabbitTemplate.convertAndSend("permission.change", event);
    }
}

// æƒé™å˜æ›´ç›‘å¬å™¨
@Component
public class PermissionChangeListener {
    
    @RabbitListener(queues = "permission.change")
    public void handlePermissionChange(PermissionChangeEvent event) {
        Long userId = event.getUserId();
        
        // æ¸…é™¤ç›¸å…³ç¼“å­˜
        cacheService.evictUserPermissions(userId);
        
        // é€šçŸ¥åœ¨çº¿ç”¨æˆ·åˆ·æ–°æƒé™
        websocketService.notifyUserPermissionChange(userId);
        
        log.info("ç”¨æˆ·{}æƒé™å·²æ›´æ–°", userId);
    }
}
```

### 7.3 WebSocketå®æ—¶é€šçŸ¥


**é€šè¿‡WebSocketä¸»åŠ¨é€šçŸ¥ç”¨æˆ·æƒé™å˜æ›´**ï¼š

```java
// WebSocketæƒé™é€šçŸ¥
@Component
public class PermissionNotificationService {
    
    private final Map<Long, WebSocketSession> userSessions = new ConcurrentHashMap<>();
    
    // ç”¨æˆ·æƒé™å˜æ›´æ—¶ä¸»åŠ¨é€šçŸ¥
    public void notifyPermissionChange(Long userId) {
        WebSocketSession session = userSessions.get(userId);
        if (session != null && session.isOpen()) {
            try {
                PermissionUpdateMessage message = new PermissionUpdateMessage();
                message.setType("PERMISSION_UPDATED");
                message.setMessage("æ‚¨çš„æƒé™å·²æ›´æ–°ï¼Œè¯·åˆ·æ–°é¡µé¢");
                
                session.sendMessage(new TextMessage(JSON.toJSONString(message)));
            } catch (IOException e) {
                log.error("å‘é€æƒé™æ›´æ–°é€šçŸ¥å¤±è´¥", e);
            }
        }
    }
}
```

### 7.4 æƒé™ç‰ˆæœ¬æ§åˆ¶


**é€šè¿‡ç‰ˆæœ¬å·æ§åˆ¶æƒé™æ›´æ–°**ï¼š

```java
// æƒé™ç‰ˆæœ¬ç®¡ç†
@Service
public class PermissionVersionService {
    
    // ç”¨æˆ·æƒé™ç‰ˆæœ¬ç¼“å­˜
    private final Map<Long, Long> userPermissionVersions = new ConcurrentHashMap<>();
    
    // æ£€æŸ¥æƒé™æ—¶éªŒè¯ç‰ˆæœ¬
    public boolean hasPermissionWithVersionCheck(Long userId, String permission) {
        Long cachedVersion = userPermissionVersions.get(userId);
        Long currentVersion = getCurrentPermissionVersion(userId);
        
        if (cachedVersion == null || !cachedVersion.equals(currentVersion)) {
            // ç‰ˆæœ¬ä¸åŒ¹é…ï¼Œé‡æ–°åŠ è½½æƒé™
            reloadUserPermissions(userId);
            userPermissionVersions.put(userId, currentVersion);
        }
        
        return checkPermission(userId, permission);
    }
    
    // æƒé™å˜æ›´æ—¶æ›´æ–°ç‰ˆæœ¬
    public void incrementPermissionVersion(Long userId) {
        String versionKey = "user:permission:version:" + userId;
        redisTemplate.opsForValue().increment(versionKey);
    }
}
```

---

## 8. ğŸ“Š ç›‘æ§å’Œæ€§èƒ½æŒ‡æ ‡


### 8.1 å…³é”®æ€§èƒ½æŒ‡æ ‡(KPI)


**éœ€è¦ç›‘æ§çš„æ ¸å¿ƒæŒ‡æ ‡**ï¼š

```
ğŸ“ˆ å“åº”æ—¶é—´æŒ‡æ ‡ï¼š
- æƒé™éªŒè¯å¹³å‡è€—æ—¶
- 95%ç”¨æˆ·çš„æƒé™éªŒè¯è€—æ—¶
- æƒé™æŸ¥è¯¢è¶…æ—¶ç‡

ğŸ“ˆ ååé‡æŒ‡æ ‡ï¼š
- æ¯ç§’æƒé™éªŒè¯æ¬¡æ•°(QPS)
- å¹¶å‘ç”¨æˆ·æ•°
- æƒé™ç¼“å­˜å‘½ä¸­ç‡

ğŸ“ˆ é”™è¯¯ç‡æŒ‡æ ‡ï¼š
- æƒé™éªŒè¯å¤±è´¥ç‡
- ç¼“å­˜å¼‚å¸¸ç‡
- æ•°æ®åº“è¿æ¥å¼‚å¸¸ç‡
```

### 8.2 æ€§èƒ½ç›‘æ§å®ç°


```java
// æƒé™æ€§èƒ½ç›‘æ§
@Component
public class PermissionPerformanceMonitor {
    
    private final MeterRegistry meterRegistry;
    private final Timer permissionCheckTimer;
    private final Counter cacheHitCounter;
    private final Counter cacheMissCounter;
    
    public PermissionPerformanceMonitor(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.permissionCheckTimer = Timer.builder("permission.check.time")
            .description("æƒé™éªŒè¯è€—æ—¶")
            .register(meterRegistry);
        this.cacheHitCounter = Counter.builder("permission.cache.hit")
            .description("æƒé™ç¼“å­˜å‘½ä¸­")
            .register(meterRegistry);
        this.cacheMissCounter = Counter.builder("permission.cache.miss")
            .description("æƒé™ç¼“å­˜æœªå‘½ä¸­")
            .register(meterRegistry);
    }
    
    // ç›‘æ§æƒé™éªŒè¯æ€§èƒ½
    public boolean hasPermissionWithMonitoring(Long userId, String permission) {
        return permissionCheckTimer.recordCallable(() -> {
            boolean result = checkPermissionFromCache(userId, permission);
            
            if (result != null) {
                cacheHitCounter.increment(); // ç¼“å­˜å‘½ä¸­
            } else {
                cacheMissCounter.increment(); // ç¼“å­˜æœªå‘½ä¸­
                result = checkPermissionFromDB(userId, permission);
            }
            
            return result;
        });
    }
}
```

### 8.3 æŠ¥è­¦æœºåˆ¶


**ğŸ”¸ å…³é”®æŒ‡æ ‡æŠ¥è­¦è§„åˆ™**ï¼š

```yaml
# æŠ¥è­¦é…ç½®ç¤ºä¾‹
alerts:
  - name: "æƒé™éªŒè¯è€—æ—¶è¿‡é•¿"
    condition: "permission_check_time_95percentile > 500ms"
    action: "å‘é€é’‰é’‰é€šçŸ¥ç»™è¿ç»´å›¢é˜Ÿ"
    
  - name: "æƒé™ç¼“å­˜å‘½ä¸­ç‡è¿‡ä½"  
    condition: "cache_hit_rate < 80%"
    action: "å‘é€é‚®ä»¶ç»™å¼€å‘å›¢é˜Ÿ"
    
  - name: "æƒé™éªŒè¯å¤±è´¥ç‡è¿‡é«˜"
    condition: "permission_check_error_rate > 5%"  
    action: "å‘é€çŸ­ä¿¡ç»™ç³»ç»Ÿè´Ÿè´£äºº"
```

### 8.4 æ€§èƒ½åˆ†æå·¥å…·


```java
// æƒé™æ€§èƒ½åˆ†æ
@Service
public class PermissionAnalysisService {
    
    // åˆ†ææ…¢æŸ¥è¯¢æƒé™
    public List<SlowPermissionQuery> analyzeSlowQueries() {
        return permissionLogRepository.findSlowQueries(Duration.ofMillis(500));
    }
    
    // åˆ†æçƒ­ç‚¹æƒé™
    public List<HotPermission> analyzeHotPermissions() {
        return permissionLogRepository.findMostAccessedPermissions(100);
    }
    
    // ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
    @Scheduled(cron = "0 0 1 * * ?") // æ¯å¤©å‡Œæ™¨1ç‚¹
    public void generateDailyPerformanceReport() {
        PerformanceReport report = new PerformanceReport();
        report.setAvgResponseTime(getAverageResponseTime());
        report.setCacheHitRate(getCacheHitRate());
        report.setQps(getQpsStatistics());
        
        // å‘é€æŠ¥å‘Šç»™ç›¸å…³äººå‘˜
        emailService.sendPerformanceReport(report);
    }
}
```

---

## 9. ğŸ”§ ç³»ç»Ÿæ‰©å±•æ€§è®¾è®¡


### 9.1 ä»€ä¹ˆæ˜¯ç³»ç»Ÿæ‰©å±•æ€§


**é€šä¿—ç†è§£**ï¼šç³»ç»Ÿæ‰©å±•æ€§å°±åƒæ­ç§¯æœ¨ï¼Œå½“ç”¨æˆ·å¢å¤šæ—¶ï¼Œèƒ½å¤Ÿæ–¹ä¾¿åœ°æ·»åŠ æ›´å¤š"ç§¯æœ¨"æ¥æ‰¿æ‹…å‹åŠ›ï¼Œè€Œä¸æ˜¯æ¨å€’é‡å»ºã€‚

```
æ‰©å±•æ€§åœºæ™¯ï¼š
ğŸ“ˆ ç”¨æˆ·ä»1ä¸‡å¢é•¿åˆ°100ä¸‡
ğŸ“ˆ æƒé™éªŒè¯ä»æ¯ç§’100æ¬¡åˆ°æ¯ç§’10000æ¬¡  
ğŸ“ˆ æƒé™è§„åˆ™ä»ç®€å•åˆ°å¤æ‚

å¥½çš„æ‰©å±•æ€§ï¼šåŠ æœºå™¨å°±èƒ½è§£å†³ âœ…
å·®çš„æ‰©å±•æ€§ï¼šéœ€è¦é‡å†™ä»£ç  âŒ
```

### 9.2 æ°´å¹³æ‰©å±•è®¾è®¡


**ä»€ä¹ˆæ˜¯æ°´å¹³æ‰©å±•**ï¼šé€šè¿‡å¢åŠ æ›´å¤šæœåŠ¡å™¨æ¥åˆ†æ‹…å‹åŠ›ã€‚

```java
// å¯æ°´å¹³æ‰©å±•çš„æƒé™æœåŠ¡è®¾è®¡
@Service
public class ScalablePermissionService {
    
    // æ”¯æŒå¤šä¸ªRediså®ä¾‹
    private final List<RedisTemplate> redisTemplates;
    
    // æ”¯æŒå¤šä¸ªæ•°æ®åº“åˆ†ç‰‡
    private final List<DataSource> shardedDataSources;
    
    // æ ¹æ®ç”¨æˆ·IDé€‰æ‹©Rediså®ä¾‹
    private RedisTemplate selectRedisInstance(Long userId) {
        int index = (int) (userId % redisTemplates.size());
        return redisTemplates.get(index);
    }
    
    // æ ¹æ®ç”¨æˆ·IDé€‰æ‹©æ•°æ®åº“åˆ†ç‰‡
    private DataSource selectDataSource(Long userId) {
        int index = (int) (userId % shardedDataSources.size());
        return shardedDataSources.get(index);
    }
    
    // æƒé™éªŒè¯ï¼ˆè‡ªåŠ¨è·¯ç”±åˆ°å¯¹åº”å®ä¾‹ï¼‰
    public boolean hasPermission(Long userId, String permission) {
        RedisTemplate redis = selectRedisInstance(userId);
        // ä»å¯¹åº”çš„Rediså®ä¾‹æŸ¥è¯¢...
    }
}
```

### 9.3 å¾®æœåŠ¡æ¶æ„è®¾è®¡


**æƒé™ç³»ç»Ÿå¾®æœåŠ¡æ‹†åˆ†**ï¼š

```
æƒé™ç³»ç»Ÿå¾®æœåŠ¡æ¶æ„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·æœåŠ¡       â”‚    â”‚   è§’è‰²æœåŠ¡       â”‚    â”‚   æƒé™æœåŠ¡       â”‚
â”‚ User Service    â”‚    â”‚ Role Service    â”‚    â”‚Permission Serviceâ”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚- ç”¨æˆ·ä¿¡æ¯ç®¡ç†    â”‚    â”‚- è§’è‰²å®šä¹‰ç®¡ç†    â”‚    â”‚- æƒé™éªŒè¯        â”‚
â”‚- ç”¨æˆ·è®¤è¯       â”‚    â”‚- è§’è‰²åˆ†é…       â”‚    â”‚- æƒé™ç¼“å­˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   ç½‘å…³æœåŠ¡       â”‚
                    â”‚ Gateway Service â”‚
                    â”‚                 â”‚
                    â”‚- è·¯ç”±è½¬å‘        â”‚
                    â”‚- æƒé™æ‹¦æˆª        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.4 é…ç½®åŒ–æƒé™ç®¡ç†


**é€šè¿‡é…ç½®å®ç°çµæ´»çš„æƒé™æ§åˆ¶**ï¼š

```java
// é…ç½®åŒ–æƒé™è§„åˆ™
@Component
public class ConfigurablePermissionManager {
    
    // æƒé™è§„åˆ™é…ç½®
    @Value("${permission.rules}")
    private List<PermissionRule> permissionRules;
    
    // åŠ¨æ€æƒé™éªŒè¯
    public boolean hasPermission(UserContext user, String resource, String action) {
        for (PermissionRule rule : permissionRules) {
            if (rule.matches(user, resource, action)) {
                return rule.isAllowed();
            }
        }
        return false; // é»˜è®¤æ‹’ç»
    }
    
    // çƒ­æ›´æ–°æƒé™è§„åˆ™
    @EventListener
    public void onPermissionRuleUpdate(PermissionRuleUpdateEvent event) {
        // é‡æ–°åŠ è½½æƒé™è§„åˆ™é…ç½®
        this.permissionRules = loadPermissionRules();
        log.info("æƒé™è§„åˆ™å·²æ›´æ–°");
    }
}
```

```yaml
# æƒé™è§„åˆ™é…ç½®ç¤ºä¾‹
permission:
  rules:
    - name: "ç®¡ç†å‘˜å…¨æƒé™"
      condition: "user.role == 'ADMIN'"
      resource: "*"
      action: "*"  
      allowed: true
      
    - name: "æ™®é€šç”¨æˆ·æŸ¥çœ‹æƒé™"
      condition: "user.role == 'USER'"
      resource: "document.*"
      action: "READ"
      allowed: true
      
    - name: "éƒ¨é—¨ç»ç†å®¡æ‰¹æƒé™"
      condition: "user.role == 'MANAGER' && resource.department == user.department"
      resource: "approval.*"
      action: "APPROVE"
      allowed: true
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„ä¼˜åŒ–ç­–ç•¥


```
ğŸ¯ æŸ¥è¯¢ä¼˜åŒ–ï¼š
â€¢ æƒé™é¢„åŠ è½½ï¼šç™»å½•æ—¶ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æƒé™
â€¢ SQLä¼˜åŒ–ï¼šé¿å…N+1æŸ¥è¯¢ï¼Œä½¿ç”¨å¤åˆæŸ¥è¯¢
â€¢ ç´¢å¼•è®¾è®¡ï¼šä¸ºå…³é”®æŸ¥è¯¢è·¯å¾„å»ºç«‹ç´¢å¼•

ğŸ¯ ç¼“å­˜ç­–ç•¥ï¼š  
â€¢ å¤šå±‚ç¼“å­˜ï¼šæœ¬åœ°ç¼“å­˜ + Redis + æ•°æ®åº“
â€¢ ç¼“å­˜æ›´æ–°ï¼šæƒé™å˜æ›´æ—¶ç«‹å³æ¸…é™¤ç¼“å­˜
â€¢ ç¼“å­˜é¢„çƒ­ï¼šæå‰åŠ è½½çƒ­ç‚¹æƒé™æ•°æ®

ğŸ¯ ç®—æ³•ä¼˜åŒ–ï¼š
â€¢ æƒé™ç»§æ‰¿ï¼šé¢„è®¡ç®—ç»§æ‰¿å…³ç³»æ ‘
â€¢ ä½è¿ç®—ï¼šä½¿ç”¨ä½æ“ä½œæé«˜è®¡ç®—é€Ÿåº¦
â€¢ æ‰¹é‡å¤„ç†ï¼šå‡å°‘æ•°æ®åº“è®¿é—®æ¬¡æ•°
```

### 10.2 å¤§è§„æ¨¡åœºæ™¯è§£å†³æ–¹æ¡ˆ


```
ğŸ¯ å¤§ç”¨æˆ·é‡å¤„ç†ï¼š
â€¢ åˆ†ç‰‡å­˜å‚¨ï¼šç”¨æˆ·æ•°æ®åˆ†æ•£åˆ°å¤šä¸ªæ•°æ®åº“
â€¢ å¼‚æ­¥åŠ è½½ï¼šæƒé™åå°å¼‚æ­¥åŠ è½½ï¼Œä¸é˜»å¡ç”¨æˆ·
â€¢ æƒé™é¢„è®¡ç®—ï¼šå®šæ—¶ä»»åŠ¡é¢„è®¡ç®—æ‰€æœ‰æƒé™ç»„åˆ

ğŸ¯ å®æ—¶æ€§ä¿è¯ï¼š
â€¢ æ¶ˆæ¯é˜Ÿåˆ—ï¼šæƒé™å˜æ›´å®æ—¶é€šçŸ¥
â€¢ WebSocketï¼šä¸»åŠ¨æ¨é€æƒé™æ›´æ–°
â€¢ ç‰ˆæœ¬æ§åˆ¶ï¼šé€šè¿‡ç‰ˆæœ¬å·æ£€æµ‹æƒé™å˜åŒ–
```

### 10.3 ç³»ç»Ÿç¨³å®šæ€§ä¿éšœ


```
ğŸ¯ ç›‘æ§å‘Šè­¦ï¼š
â€¢ æ€§èƒ½æŒ‡æ ‡ï¼šå“åº”æ—¶é—´ã€ååé‡ã€é”™è¯¯ç‡
â€¢ è‡ªåŠ¨æŠ¥è­¦ï¼šå¼‚å¸¸æƒ…å†µåŠæ—¶é€šçŸ¥ç›¸å…³äººå‘˜
â€¢ æ€§èƒ½åˆ†æï¼šå®šæœŸåˆ†æç³»ç»Ÿç“¶é¢ˆç‚¹

ğŸ¯ æ‰©å±•è®¾è®¡ï¼š
â€¢ æ°´å¹³æ‰©å±•ï¼šæ”¯æŒå¢åŠ æœåŠ¡å™¨æå‡æ€§èƒ½
â€¢ å¾®æœåŠ¡åŒ–ï¼šæƒé™ç³»ç»Ÿæ¨¡å—åŒ–æ‹†åˆ†
â€¢ é…ç½®åŒ–ï¼šæƒé™è§„åˆ™æ”¯æŒåŠ¨æ€é…ç½®æ›´æ–°
```

### 10.4 å®è·µå»ºè®®


> ğŸ’¡ **ä¼˜åŒ–åŸåˆ™**ï¼š
> - å…ˆæµ‹é‡ï¼Œå†ä¼˜åŒ–ï¼šåŸºäºå®é™…æ€§èƒ½æ•°æ®è¿›è¡Œä¼˜åŒ–
> - æ¸è¿›å¼ä¼˜åŒ–ï¼šä»ç®€å•åˆ°å¤æ‚é€æ­¥ä¼˜åŒ–
> - æƒè¡¡å–èˆï¼šæ€§èƒ½vså¤æ‚åº¦ã€å®æ—¶æ€§vsä¸€è‡´æ€§

> âš ï¸ **å¸¸è§è¯¯åŒº**ï¼š
> - è¿‡åº¦ä¼˜åŒ–ï¼šæ²¡æœ‰æ€§èƒ½é—®é¢˜å°±è¿‡åº¦ä¼˜åŒ–
> - å¿½ç•¥ç›‘æ§ï¼šä¼˜åŒ–åä¸ç›‘æ§æ•ˆæœ
> - ä¸€åˆ€åˆ‡ï¼šæ‰€æœ‰åœºæ™¯ä½¿ç”¨åŒä¸€ç§ä¼˜åŒ–ç­–ç•¥

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- ç¼“å­˜ä¸ºç‹å‡æŸ¥è¯¢ï¼Œç´¢å¼•ä¼˜åŒ–å¿«å¦‚é£
- æ‰¹é‡å¤„ç†é™å‹åŠ›ï¼Œå¼‚æ­¥åŠ è½½ç”¨æˆ·å–œ  
- ç›‘æ§å‘Šè­¦ä¿ç¨³å®šï¼Œæ‰©å±•è®¾è®¡åº”æœªæ¥