---
title: 4ã€RBACç³»ç»Ÿè®¾è®¡å®è·µ
---
## ğŸ“š ç›®å½•

1. [RBACæ ¸å¿ƒæ¦‚å¿µè§£æ](#1-RBACæ ¸å¿ƒæ¦‚å¿µè§£æ)
2. [æ•°æ®åº“è®¾è®¡å®è·µ](#2-æ•°æ®åº“è®¾è®¡å®è·µ)
3. [RBACè¡¨ç»“æ„è®¾è®¡](#3-RBACè¡¨ç»“æ„è®¾è®¡)
4. [äº”è¡¨æ¨¡å‹è¯¦è§£](#4-äº”è¡¨æ¨¡å‹è¯¦è§£)
5. [æƒé™çŸ©é˜µè®¾è®¡](#5-æƒé™çŸ©é˜µè®¾è®¡)
6. [æƒé™ç¼“å­˜ä¸æ€§èƒ½ä¼˜åŒ–](#6-æƒé™ç¼“å­˜ä¸æ€§èƒ½ä¼˜åŒ–)
7. [åå°ç³»ç»Ÿæƒé™åŠ¨æ€é…ç½®](#7-åå°ç³»ç»Ÿæƒé™åŠ¨æ€é…ç½®)
8. [å®ç°æŠ€æœ¯é€‰å‹ä¸å¯¹æ¯”](#8-å®ç°æŠ€æœ¯é€‰å‹ä¸å¯¹æ¯”)
9. [RBACæœ€ä½³å®è·µ](#9-RBACæœ€ä½³å®è·µ)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” RBACæ ¸å¿ƒæ¦‚å¿µè§£æ


### 1.1 RBACæ˜¯ä»€ä¹ˆï¼Ÿ


**é€šä¿—ç†è§£**ï¼šRBACå°±æ˜¯"è§’è‰²ç®¡æƒé™ï¼Œç”¨æˆ·é…è§’è‰²"çš„æƒé™ç®¡ç†æ–¹å¼

```
æ—¥å¸¸ç”Ÿæ´»ä¸­çš„RBACï¼š
å…¬å¸é‡Œçš„èŒä½å°±æ˜¯"è§’è‰²"
- CEOè§’è‰²ï¼šèƒ½çœ‹æ‰€æœ‰æŠ¥è¡¨ã€æ‰¹å‡†é¢„ç®—
- ç»ç†è§’è‰²ï¼šèƒ½çœ‹éƒ¨é—¨æ•°æ®ã€ç®¡ç†ä¸‹å±
- å‘˜å·¥è§’è‰²ï¼šåªèƒ½çœ‹è‡ªå·±ç›¸å…³çš„ä¿¡æ¯

ç³»ç»Ÿä¸­ä¹Ÿä¸€æ ·ï¼š
- ç®¡ç†å‘˜è§’è‰²ï¼šå¢åˆ æ”¹æŸ¥æ‰€æœ‰æ•°æ®
- ç¼–è¾‘è§’è‰²ï¼šåªèƒ½ç¼–è¾‘å†…å®¹ï¼Œä¸èƒ½åˆ é™¤
- è®¿å®¢è§’è‰²ï¼šåªèƒ½æŸ¥çœ‹ï¼Œä¸èƒ½ä¿®æ”¹
```

**RBACå…¨ç§°**ï¼šRole-Based Access Controlï¼ˆåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼‰

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦RBACï¼Ÿ


**ä¼ ç»Ÿæƒé™ç®¡ç†çš„é—®é¢˜**ï¼š
```
âŒ ç›´æ¥ç»™ç”¨æˆ·åˆ†é…æƒé™çš„é—®é¢˜ï¼š

ç”¨æˆ·Aï¼šæ–‡ç« æŸ¥çœ‹ + æ–‡ç« ç¼–è¾‘ + ç”¨æˆ·ç®¡ç†
ç”¨æˆ·Bï¼šæ–‡ç« æŸ¥çœ‹ + æ–‡ç« ç¼–è¾‘ + ç”¨æˆ·ç®¡ç†  
ç”¨æˆ·Cï¼šæ–‡ç« æŸ¥çœ‹ + æ–‡ç« ç¼–è¾‘

é—®é¢˜ï¼š
1. æƒé™åˆ†æ•£ï¼Œéš¾ä»¥ç®¡ç†
2. äººå‘˜å˜åŠ¨æ—¶è¦é€ä¸ªè°ƒæ•´æƒé™
3. ç›¸åŒèŒè´£çš„äººæƒé™å¯èƒ½ä¸ä¸€è‡´
```

**RBACè§£å†³æ–¹æ¡ˆ**ï¼š
```
âœ… åŸºäºè§’è‰²çš„æƒé™ç®¡ç†ï¼š

è§’è‰²å®šä¹‰ï¼š
- ç¼–è¾‘è§’è‰² = æ–‡ç« æŸ¥çœ‹ + æ–‡ç« ç¼–è¾‘
- ç®¡ç†å‘˜è§’è‰² = æ–‡ç« æŸ¥çœ‹ + æ–‡ç« ç¼–è¾‘ + ç”¨æˆ·ç®¡ç†

ç”¨æˆ·åˆ†é…ï¼š
- ç”¨æˆ·Aã€Bï¼šåˆ†é…ç®¡ç†å‘˜è§’è‰²
- ç”¨æˆ·Cï¼šåˆ†é…ç¼–è¾‘è§’è‰²

ä¼˜åŠ¿ï¼š
1. æƒé™é›†ä¸­ç®¡ç†
2. è§’è‰²å¤ç”¨ï¼Œå‡å°‘é‡å¤é…ç½®
3. èŒè´£æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤
```

### 1.3 RBACæ ¸å¿ƒè¦ç´ 


**äº”ä¸ªæ ¸å¿ƒå®ä½“**ï¼š

| å®ä½“ | è¯´æ˜ | ä¸¾ä¾‹ |
|------|------|------|
| **ç”¨æˆ·(User)** | ç³»ç»Ÿçš„ä½¿ç”¨è€… | å¼ ä¸‰ã€æå›› |
| **è§’è‰²(Role)** | æƒé™çš„è½½ä½“ | ç¼–è¾‘ã€ç®¡ç†å‘˜ |
| **æƒé™(Permission)** | å…·ä½“çš„æ“ä½œæƒé™ | æŸ¥çœ‹æ–‡ç« ã€åˆ é™¤ç”¨æˆ· |
| **èµ„æº(Resource)** | è¢«ä¿æŠ¤çš„å¯¹è±¡ | æ–‡ç« ã€ç”¨æˆ·ä¿¡æ¯ |
| **æ“ä½œ(Operation)** | å¯¹èµ„æºçš„åŠ¨ä½œ | å¢ã€åˆ ã€æ”¹ã€æŸ¥ |

**å…³ç³»æ¨¡å‹**ï¼š
```
ç”¨æˆ· â†â†’ è§’è‰² â†â†’ æƒé™

å¼ ä¸‰ â†’ ç¼–è¾‘è§’è‰² â†’ {æ–‡ç« æŸ¥çœ‹, æ–‡ç« ç¼–è¾‘}
æå›› â†’ ç®¡ç†å‘˜è§’è‰² â†’ {æ–‡ç« æŸ¥çœ‹, æ–‡ç« ç¼–è¾‘, ç”¨æˆ·ç®¡ç†}
```

---

## 2. ğŸ’¾ æ•°æ®åº“è®¾è®¡å®è·µ


### 2.1 æ ¸å¿ƒè®¾è®¡æ€è·¯


**è®¾è®¡åŸåˆ™**ï¼š
- **å…³ç³»æ¸…æ™°**ï¼šç”¨æˆ·ã€è§’è‰²ã€æƒé™ä¸‰è€…å…³ç³»æ˜ç¡®
- **æ‰©å±•æ€§å¥½**ï¼šæ”¯æŒæœªæ¥åŠŸèƒ½æ‰©å±•
- **æ€§èƒ½ä¼˜å…ˆ**ï¼šæŸ¥è¯¢æ•ˆç‡é«˜ï¼Œé€‚åˆé«˜å¹¶å‘
- **ç»´æŠ¤ç®€å•**ï¼šè¡¨ç»“æ„æ˜“ç†è§£ï¼Œæ“ä½œç®€ä¾¿

### 2.2 æ•°æ®åº“è¡¨æ¦‚è§ˆ


**åŸºç¡€è¡¨ç»“æ„**ï¼š
```
ç”¨æˆ·è¡¨(users) â†â†’ ç”¨æˆ·è§’è‰²å…³è”è¡¨(user_roles) â†â†’ è§’è‰²è¡¨(roles)
                                                      â†“
æƒé™è¡¨(permissions) â†â†’ è§’è‰²æƒé™å…³è”è¡¨(role_permissions)
```

### 2.3 å®é™…åº”ç”¨åœºæ™¯åˆ†æ


**å…¸å‹åº”ç”¨åœºæ™¯**ï¼š
```
ğŸ¢ ä¼ä¸šåå°ç®¡ç†ç³»ç»Ÿï¼š
- è¶…çº§ç®¡ç†å‘˜ï¼šæ‰€æœ‰æƒé™
- éƒ¨é—¨ç»ç†ï¼šæœ¬éƒ¨é—¨æ•°æ®ç®¡ç†
- æ™®é€šå‘˜å·¥ï¼šä¸ªäººæ•°æ®æŸ¥çœ‹

ğŸ“ å†…å®¹ç®¡ç†ç³»ç»Ÿï¼š
- ä¸»ç¼–ï¼šå®¡æ ¸å‘å¸ƒæ‰€æœ‰æ–‡ç« 
- ç¼–è¾‘ï¼šç¼–è¾‘æŒ‡å®šæ ç›®æ–‡ç« 
- ä½œè€…ï¼šåªèƒ½ç¼–è¾‘è‡ªå·±çš„æ–‡ç« 

ğŸ›’ ç”µå•†ç®¡ç†ç³»ç»Ÿï¼š
- è¿è¥æ€»ç›‘ï¼šæŸ¥çœ‹æ‰€æœ‰æ•°æ®å’ŒæŠ¥è¡¨
- å•†å“ç®¡ç†å‘˜ï¼šç®¡ç†å•†å“ä¿¡æ¯
- å®¢æœï¼šå¤„ç†è®¢å•å’Œç”¨æˆ·é—®é¢˜
```

---

## 3. ğŸ“‹ RBACè¡¨ç»“æ„è®¾è®¡


### 3.1 ç”¨æˆ·è¡¨è®¾è®¡


```sql
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) NOT NULL UNIQUE COMMENT 'ç”¨æˆ·å',
    password VARCHAR(255) NOT NULL COMMENT 'å¯†ç ï¼ˆåŠ å¯†åï¼‰',
    email VARCHAR(100) COMMENT 'é‚®ç®±',
    phone VARCHAR(20) COMMENT 'æ‰‹æœºå·',
    real_name VARCHAR(50) COMMENT 'çœŸå®å§“å',
    status TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€ï¼š0ç¦ç”¨ 1å¯ç”¨',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_username (username),
    INDEX idx_email (email)
);
```

**è®¾è®¡è¦ç‚¹**ï¼š
- `id`ï¼šä¸»é”®ï¼Œå»ºè®®ä½¿ç”¨BIGINTåº”å¯¹å¤§æ•°æ®é‡
- `username`ï¼šå”¯ä¸€ç´¢å¼•ï¼Œç™»å½•å‡­è¯
- `password`ï¼š**å¿…é¡»åŠ å¯†å­˜å‚¨**ï¼ˆBCryptã€Argon2ç­‰ï¼‰
- `status`ï¼šè½¯åˆ é™¤æ ‡è®°ï¼Œæ”¯æŒç¦ç”¨ç”¨æˆ·
- `created_at/updated_at`ï¼šå®¡è®¡å­—æ®µï¼Œè®°å½•æ“ä½œæ—¶é—´

### 3.2 è§’è‰²è¡¨è®¾è®¡


```sql
CREATE TABLE roles (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    role_code VARCHAR(50) NOT NULL UNIQUE COMMENT 'è§’è‰²ç¼–ç ',
    role_name VARCHAR(100) NOT NULL COMMENT 'è§’è‰²åç§°',
    description TEXT COMMENT 'è§’è‰²æè¿°',
    status TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€ï¼š0ç¦ç”¨ 1å¯ç”¨',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_role_code (role_code)
);
```

**è®¾è®¡è¦ç‚¹**ï¼š
- `role_code`ï¼šè§’è‰²å”¯ä¸€æ ‡è¯†ï¼Œç¨‹åºä¸­ä½¿ç”¨ï¼ˆå¦‚ï¼šADMINã€EDITORï¼‰
- `role_name`ï¼šæ˜¾ç¤ºåç§°ï¼Œç”¨æˆ·ç•Œé¢å±•ç¤º
- `description`ï¼šè§’è‰²è¯´æ˜ï¼Œä¾¿äºç®¡ç†å‘˜ç†è§£

**ç¤ºä¾‹æ•°æ®**ï¼š
```sql
INSERT INTO roles (role_code, role_name, description) VALUES
('SUPER_ADMIN', 'è¶…çº§ç®¡ç†å‘˜', 'ç³»ç»Ÿæœ€é«˜æƒé™ï¼Œå¯ç®¡ç†æ‰€æœ‰åŠŸèƒ½'),
('DEPT_MANAGER', 'éƒ¨é—¨ç»ç†', 'ç®¡ç†æœ¬éƒ¨é—¨ç”¨æˆ·å’Œæ•°æ®'),
('EDITOR', 'ç¼–è¾‘', 'å†…å®¹ç¼–è¾‘å’Œå‘å¸ƒæƒé™'),
('VIEWER', 'æŸ¥çœ‹è€…', 'åªè¯»æƒé™ï¼ŒæŸ¥çœ‹ç›¸å…³æ•°æ®');
```

### 3.3 æƒé™è¡¨è®¾è®¡


```sql
CREATE TABLE permissions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    permission_code VARCHAR(100) NOT NULL UNIQUE COMMENT 'æƒé™ç¼–ç ',
    permission_name VARCHAR(100) NOT NULL COMMENT 'æƒé™åç§°',
    resource_type VARCHAR(50) COMMENT 'èµ„æºç±»å‹',
    operation_type VARCHAR(20) COMMENT 'æ“ä½œç±»å‹ï¼šCREATE,READ,UPDATE,DELETE',
    url_pattern VARCHAR(200) COMMENT 'URLåŒ¹é…æ¨¡å¼',
    description TEXT COMMENT 'æƒé™æè¿°',
    parent_id BIGINT DEFAULT 0 COMMENT 'çˆ¶æƒé™IDï¼ˆæ”¯æŒæƒé™åˆ†ç»„ï¼‰',
    status TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€ï¼š0ç¦ç”¨ 1å¯ç”¨',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_permission_code (permission_code),
    INDEX idx_parent_id (parent_id)
);
```

**æƒé™ç¼–ç è§„èŒƒ**ï¼š
```
æ¨¡å—:èµ„æº:æ“ä½œ æ ¼å¼
ä¾‹å¦‚ï¼š
- USER:MANAGE:CREATE  ï¼ˆç”¨æˆ·ç®¡ç†-åˆ›å»ºï¼‰
- USER:MANAGE:UPDATE  ï¼ˆç”¨æˆ·ç®¡ç†-ä¿®æ”¹ï¼‰
- ARTICLE:CONTENT:READ ï¼ˆæ–‡ç« å†…å®¹-æŸ¥çœ‹ï¼‰
- REPORT:SALES:EXPORT ï¼ˆé”€å”®æŠ¥è¡¨-å¯¼å‡ºï¼‰
```

**ç¤ºä¾‹æ•°æ®**ï¼š
```sql
INSERT INTO permissions (permission_code, permission_name, resource_type, operation_type) VALUES
-- ç”¨æˆ·ç®¡ç†æƒé™
('USER:MANAGE:CREATE', 'åˆ›å»ºç”¨æˆ·', 'USER', 'CREATE'),
('USER:MANAGE:READ', 'æŸ¥çœ‹ç”¨æˆ·', 'USER', 'READ'),
('USER:MANAGE:UPDATE', 'ä¿®æ”¹ç”¨æˆ·', 'USER', 'UPDATE'),
('USER:MANAGE:DELETE', 'åˆ é™¤ç”¨æˆ·', 'USER', 'DELETE'),
-- å†…å®¹ç®¡ç†æƒé™
('ARTICLE:CONTENT:CREATE', 'åˆ›å»ºæ–‡ç« ', 'ARTICLE', 'CREATE'),
('ARTICLE:CONTENT:PUBLISH', 'å‘å¸ƒæ–‡ç« ', 'ARTICLE', 'UPDATE');
```

---

## 4. ğŸ”— äº”è¡¨æ¨¡å‹è¯¦è§£


### 4.1 äº”è¡¨æ¨¡å‹æ¦‚è¿°


**äº”è¡¨æ¨¡å‹ç»„æˆ**ï¼š
1. **ç”¨æˆ·è¡¨**(users) - å­˜å‚¨ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
2. **è§’è‰²è¡¨**(roles) - å­˜å‚¨è§’è‰²å®šä¹‰
3. **æƒé™è¡¨**(permissions) - å­˜å‚¨æƒé™å®šä¹‰
4. **ç”¨æˆ·è§’è‰²å…³è”è¡¨**(user_roles) - ç”¨æˆ·ä¸è§’è‰²çš„å¤šå¯¹å¤šå…³ç³»
5. **è§’è‰²æƒé™å…³è”è¡¨**(role_permissions) - è§’è‰²ä¸æƒé™çš„å¤šå¯¹å¤šå…³ç³»

### 4.2 ç”¨æˆ·è§’è‰²å…³è”è¡¨


```sql
CREATE TABLE user_roles (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
    role_id BIGINT NOT NULL COMMENT 'è§’è‰²ID',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by BIGINT COMMENT 'åˆ†é…äººID',
    UNIQUE KEY uk_user_role (user_id, role_id),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE
);
```

**è®¾è®¡è¦ç‚¹**ï¼š
- `uk_user_role`ï¼šå¤åˆå”¯ä¸€ç´¢å¼•ï¼Œé˜²æ­¢é‡å¤åˆ†é…
- `created_by`ï¼šè®°å½•è°åˆ†é…çš„è§’è‰²ï¼Œä¾¿äºå®¡è®¡
- `ON DELETE CASCADE`ï¼šåˆ é™¤ç”¨æˆ·æ—¶è‡ªåŠ¨æ¸…ç†å…³è”å…³ç³»

### 4.3 è§’è‰²æƒé™å…³è”è¡¨


```sql
CREATE TABLE role_permissions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    role_id BIGINT NOT NULL COMMENT 'è§’è‰²ID',
    permission_id BIGINT NOT NULL COMMENT 'æƒé™ID',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by BIGINT COMMENT 'åˆ†é…äººID',
    UNIQUE KEY uk_role_permission (role_id, permission_id),
    FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE,
    FOREIGN KEY (permission_id) REFERENCES permissions(id) ON DELETE CASCADE
);
```

### 4.4 å…³ç³»å›¾ç¤º


```
ç”¨æˆ·è¡¨                    è§’è‰²è¡¨                    æƒé™è¡¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ users       â”‚          â”‚ roles       â”‚          â”‚permissions  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id          â”‚â—„â”€â”    â”Œâ”€â–ºâ”‚ id          â”‚â—„â”€â”    â”Œâ”€â–ºâ”‚ id          â”‚
â”‚ username    â”‚  â”‚    â”‚  â”‚ role_code   â”‚  â”‚    â”‚  â”‚ perm_code   â”‚
â”‚ password    â”‚  â”‚    â”‚  â”‚ role_name   â”‚  â”‚    â”‚  â”‚ perm_name   â”‚
â”‚ email       â”‚  â”‚    â”‚  â”‚ description â”‚  â”‚    â”‚  â”‚ resource    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚    â”‚                   â”‚    â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ user_roles      â”‚      â”‚role_permissions â”‚
          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
          â”‚ user_id         â”‚â”€â”€â”€â”€â”€â”€â”˜ role_id         â”‚â”€â”€â”€â”€â”€â”€â”˜
          â”‚ role_id         â”‚      â”‚ permission_id   â”‚
          â”‚ created_at      â”‚      â”‚ created_at      â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.5 æŸ¥è¯¢æƒé™çš„å®Œæ•´æµç¨‹


**æ ¹æ®ç”¨æˆ·IDæŸ¥è¯¢æ‰€æœ‰æƒé™**ï¼š
```sql
-- æŸ¥è¯¢ç”¨æˆ·å¼ ä¸‰çš„æ‰€æœ‰æƒé™
SELECT DISTINCT p.permission_code, p.permission_name
FROM users u
JOIN user_roles ur ON u.id = ur.user_id
JOIN roles r ON ur.role_id = r.id
JOIN role_permissions rp ON r.id = rp.role_id
JOIN permissions p ON rp.permission_id = p.id
WHERE u.username = 'å¼ ä¸‰'
AND u.status = 1 
AND r.status = 1 
AND p.status = 1;
```

---

## 5. ğŸ“Š æƒé™çŸ©é˜µè®¾è®¡


### 5.1 æƒé™çŸ©é˜µæ¦‚å¿µ


**ä»€ä¹ˆæ˜¯æƒé™çŸ©é˜µ**ï¼Ÿ
æƒé™çŸ©é˜µæ˜¯ä¸€ä¸ªè¡¨æ ¼å½¢å¼çš„æƒé™å±•ç¤ºæ–¹å¼ï¼Œæ¸…æ™°æ˜¾ç¤º"è°å¯¹ä»€ä¹ˆèµ„æºæœ‰ä»€ä¹ˆæƒé™"

```
æƒé™çŸ©é˜µç¤ºä¾‹ï¼š
              æ–‡ç« æŸ¥çœ‹  æ–‡ç« ç¼–è¾‘  æ–‡ç« åˆ é™¤  ç”¨æˆ·ç®¡ç†  ç³»ç»Ÿé…ç½®
ç®¡ç†å‘˜          âœ…       âœ…       âœ…       âœ…       âœ…
ç¼–è¾‘           âœ…       âœ…       âŒ       âŒ       âŒ
ä½œè€…           âœ…       âœ…(ä»…è‡ªå·±) âŒ       âŒ       âŒ
è®¿å®¢           âœ…       âŒ       âŒ       âŒ       âŒ
```

### 5.2 æƒé™çŸ©é˜µæ•°æ®åº“å®ç°


**çŸ©é˜µæŸ¥è¯¢è§†å›¾**ï¼š
```sql
-- åˆ›å»ºæƒé™çŸ©é˜µè§†å›¾ï¼Œä¾¿äºå¿«é€ŸæŸ¥çœ‹è§’è‰²æƒé™åˆ†é…æƒ…å†µ
CREATE VIEW v_permission_matrix AS
SELECT 
    r.role_name,
    p.resource_type,
    p.operation_type,
    CASE WHEN rp.id IS NOT NULL THEN 'âœ…' ELSE 'âŒ' END AS has_permission
FROM roles r
CROSS JOIN permissions p
LEFT JOIN role_permissions rp ON r.id = rp.role_id AND p.id = rp.permission_id
WHERE r.status = 1 AND p.status = 1
ORDER BY r.role_name, p.resource_type, p.operation_type;
```

### 5.3 åŠ¨æ€æƒé™çŸ©é˜µ


**å‰ç«¯å±•ç¤ºçš„æƒé™çŸ©é˜µ**ï¼š
```javascript
// è·å–æƒé™çŸ©é˜µæ•°æ®çš„APIå“åº”æ ¼å¼
{
  "roles": ["ç®¡ç†å‘˜", "ç¼–è¾‘", "ä½œè€…"],
  "permissions": [
    {
      "module": "ç”¨æˆ·ç®¡ç†",
      "actions": ["æŸ¥çœ‹", "åˆ›å»º", "ä¿®æ”¹", "åˆ é™¤"]
    },
    {
      "module": "å†…å®¹ç®¡ç†", 
      "actions": ["æŸ¥çœ‹", "åˆ›å»º", "ç¼–è¾‘", "å‘å¸ƒ"]
    }
  ],
  "matrix": {
    "ç®¡ç†å‘˜": {
      "ç”¨æˆ·ç®¡ç†": ["æŸ¥çœ‹", "åˆ›å»º", "ä¿®æ”¹", "åˆ é™¤"],
      "å†…å®¹ç®¡ç†": ["æŸ¥çœ‹", "åˆ›å»º", "ç¼–è¾‘", "å‘å¸ƒ"]
    },
    "ç¼–è¾‘": {
      "ç”¨æˆ·ç®¡ç†": ["æŸ¥çœ‹"],
      "å†…å®¹ç®¡ç†": ["æŸ¥çœ‹", "åˆ›å»º", "ç¼–è¾‘"]
    }
  }
}
```

---

## 6. âš¡ æƒé™ç¼“å­˜ä¸æ€§èƒ½ä¼˜åŒ–


### 6.1 ä¸ºä»€ä¹ˆéœ€è¦æƒé™ç¼“å­˜ï¼Ÿ


**æ€§èƒ½é—®é¢˜**ï¼š
```
æ¯æ¬¡æƒé™æ£€æŸ¥éƒ½æŸ¥è¯¢æ•°æ®åº“çš„é—®é¢˜ï¼š
1. é¢‘ç¹çš„å¤šè¡¨JOINæŸ¥è¯¢ï¼Œæ€§èƒ½å·®
2. é«˜å¹¶å‘æ—¶æ•°æ®åº“å‹åŠ›å¤§
3. ç”¨æˆ·ä½“éªŒå·®ï¼Œå“åº”æ…¢
```

**ç¼“å­˜è§£å†³æ–¹æ¡ˆ**ï¼š
```
âœ… å°†ç”¨æˆ·æƒé™ä¿¡æ¯ç¼“å­˜åˆ°å†…å­˜ä¸­
âœ… å‡å°‘æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°
âœ… æé«˜æƒé™æ£€æŸ¥å“åº”é€Ÿåº¦
âœ… é™ä½æ•°æ®åº“å‹åŠ›
```

### 6.2 æƒé™ç¼“å­˜ç­–ç•¥


**å¤šå±‚ç¼“å­˜æ¶æ„**ï¼š
```
åº”ç”¨å±‚ç¼“å­˜ â†’ Redisç¼“å­˜ â†’ æ•°æ®åº“

ç¬¬ä¸€å±‚ï¼šæœ¬åœ°ç¼“å­˜ï¼ˆCaffeine/Guava Cacheï¼‰
- ç¼“å­˜å½“å‰ç”¨æˆ·çš„æƒé™ä¿¡æ¯
- å‡å°‘ç½‘ç»œIOï¼Œå“åº”æœ€å¿«
- é€‚åˆé«˜é¢‘è®¿é—®çš„æƒé™æ£€æŸ¥

ç¬¬äºŒå±‚ï¼šåˆ†å¸ƒå¼ç¼“å­˜ï¼ˆRedisï¼‰
- ç¼“å­˜æ‰€æœ‰ç”¨æˆ·çš„æƒé™ä¿¡æ¯
- æ”¯æŒé›†ç¾¤ç¯å¢ƒå…±äº«
- æ•°æ®ä¸€è‡´æ€§å¥½

ç¬¬ä¸‰å±‚ï¼šæ•°æ®åº“
- æƒé™çš„æœ€ç»ˆæ•°æ®æº
- ç¼“å­˜å¤±æ•ˆæ—¶çš„æ•°æ®æ¥æº
```

### 6.3 Redisç¼“å­˜å®ç°


**ç¼“å­˜æ•°æ®ç»“æ„**ï¼š
```json
// Redis key: user:permissions:123
{
  "userId": 123,
  "username": "å¼ ä¸‰",
  "roles": [
    {
      "roleCode": "EDITOR",
      "roleName": "ç¼–è¾‘"
    }
  ],
  "permissions": [
    "ARTICLE:CONTENT:READ",
    "ARTICLE:CONTENT:CREATE",
    "ARTICLE:CONTENT:UPDATE"
  ],
  "cachedAt": "2025-01-15T10:30:00Z",
  "expireTime": 3600
}
```

**ç¼“å­˜ç®¡ç†ä»£ç ç¤ºä¾‹**ï¼š
```java
@Service
public class PermissionCacheService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    private static final String CACHE_PREFIX = "user:permissions:";
    private static final int CACHE_EXPIRE_HOURS = 2;
    
    // è·å–ç”¨æˆ·æƒé™ï¼ˆå…ˆä»ç¼“å­˜è·å–ï¼‰
    public Set<String> getUserPermissions(Long userId) {
        String cacheKey = CACHE_PREFIX + userId;
        
        // å…ˆä»ç¼“å­˜è·å–
        Set<String> permissions = (Set<String>) redisTemplate.opsForValue().get(cacheKey);
        if (permissions != null) {
            return permissions;
        }
        
        // ç¼“å­˜æœªå‘½ä¸­ï¼Œä»æ•°æ®åº“æŸ¥è¯¢
        permissions = loadUserPermissionsFromDB(userId);
        
        // å­˜å…¥ç¼“å­˜
        redisTemplate.opsForValue().set(cacheKey, permissions, 
            CACHE_EXPIRE_HOURS, TimeUnit.HOURS);
        
        return permissions;
    }
    
    // æƒé™å˜æ›´æ—¶æ¸…é™¤ç¼“å­˜
    public void clearUserPermissionCache(Long userId) {
        String cacheKey = CACHE_PREFIX + userId;
        redisTemplate.delete(cacheKey);
    }
    
    // è§’è‰²æƒé™å˜æ›´æ—¶ï¼Œæ¸…é™¤ç›¸å…³ç”¨æˆ·ç¼“å­˜
    public void clearRolePermissionCache(Long roleId) {
        // æŸ¥è¯¢æ‹¥æœ‰æ­¤è§’è‰²çš„æ‰€æœ‰ç”¨æˆ·
        List<Long> userIds = getUserIdsByRoleId(roleId);
        
        // æ‰¹é‡æ¸…é™¤è¿™äº›ç”¨æˆ·çš„æƒé™ç¼“å­˜
        List<String> cacheKeys = userIds.stream()
            .map(userId -> CACHE_PREFIX + userId)
            .collect(Collectors.toList());
            
        redisTemplate.delete(cacheKeys);
    }
}
```

### 6.4 ç¼“å­˜æ›´æ–°ç­–ç•¥


**ç¼“å­˜æ›´æ–°æ—¶æœº**ï¼š

| åœºæ™¯ | æ›´æ–°ç­–ç•¥ | è¯´æ˜ |
|------|----------|------|
| **ç”¨æˆ·è§’è‰²å˜æ›´** | ç«‹å³æ¸…é™¤ç”¨æˆ·ç¼“å­˜ | ç¡®ä¿æƒé™å˜æ›´ç«‹å³ç”Ÿæ•ˆ |
| **è§’è‰²æƒé™å˜æ›´** | æ¸…é™¤ç›¸å…³ç”¨æˆ·ç¼“å­˜ | æ‰¹é‡æ¸…é™¤æ‹¥æœ‰è¯¥è§’è‰²çš„ç”¨æˆ·ç¼“å­˜ |
| **æƒé™ä¿¡æ¯ä¿®æ”¹** | æ¸…é™¤ç›¸å…³ç¼“å­˜ | æ ¹æ®å½±å“èŒƒå›´æ¸…é™¤ç¼“å­˜ |
| **å®šæ—¶åˆ·æ–°** | è®¾ç½®è¿‡æœŸæ—¶é—´ | é˜²æ­¢ç¼“å­˜æ°¸è¿œä¸æ›´æ–° |

### 6.5 æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ


**æ•°æ®åº“å±‚é¢ä¼˜åŒ–**ï¼š
```sql
-- åˆ›å»ºå¤åˆç´¢å¼•ï¼Œä¼˜åŒ–æƒé™æŸ¥è¯¢
CREATE INDEX idx_user_role_status ON user_roles(user_id, role_id) 
WHERE status = 1;

CREATE INDEX idx_role_perm_status ON role_permissions(role_id, permission_id)
WHERE status = 1;

-- åˆ†åŒºè¡¨ä¼˜åŒ–ï¼ˆå¤§æ•°æ®é‡åœºæ™¯ï¼‰
ALTER TABLE user_roles PARTITION BY HASH(user_id) PARTITIONS 8;
```

**åº”ç”¨å±‚é¢ä¼˜åŒ–**ï¼š
```java
// æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–ï¼Œå‡å°‘æ•°æ®åº“äº¤äº’æ¬¡æ•°
public Map<Long, Set<String>> batchGetUserPermissions(List<Long> userIds) {
    // å…ˆä»ç¼“å­˜æ‰¹é‡è·å–
    Map<Long, Set<String>> result = new HashMap<>();
    List<Long> missedUserIds = new ArrayList<>();
    
    for (Long userId : userIds) {
        Set<String> permissions = getCachedPermissions(userId);
        if (permissions != null) {
            result.put(userId, permissions);
        } else {
            missedUserIds.add(userId);
        }
    }
    
    // æ‰¹é‡æŸ¥è¯¢ç¼“å­˜æœªå‘½ä¸­çš„ç”¨æˆ·æƒé™
    if (!missedUserIds.isEmpty()) {
        Map<Long, Set<String>> dbResult = batchLoadPermissionsFromDB(missedUserIds);
        result.putAll(dbResult);
        
        // æ‰¹é‡ç¼“å­˜ç»“æœ
        batchCachePermissions(dbResult);
    }
    
    return result;
}
```

---

## 7. ğŸ›ï¸ åå°ç³»ç»Ÿæƒé™åŠ¨æ€é…ç½®


### 7.1 åŠ¨æ€é…ç½®çš„éœ€æ±‚


**ä¸ºä»€ä¹ˆéœ€è¦åŠ¨æ€é…ç½®**ï¼Ÿ
```
é™æ€é…ç½®çš„é—®é¢˜ï¼š
âŒ æƒé™å˜æ›´éœ€è¦ä¿®æ”¹ä»£ç 
âŒ éœ€è¦é‡æ–°éƒ¨ç½²ç³»ç»Ÿ
âŒ ä¸èƒ½çµæ´»åº”å¯¹ä¸šåŠ¡å˜åŒ–
âŒ è¿ç»´æˆæœ¬é«˜

åŠ¨æ€é…ç½®çš„ä¼˜åŠ¿ï¼š
âœ… å®æ—¶è°ƒæ•´æƒé™ï¼Œæ— éœ€é‡å¯
âœ… å¯è§†åŒ–æƒé™ç®¡ç†ç•Œé¢
âœ… æ”¯æŒæƒé™çš„çµæ´»ç»„åˆ
âœ… é™ä½è¿ç»´æˆæœ¬
```

### 7.2 æƒé™é…ç½®ç•Œé¢è®¾è®¡


**è§’è‰²ç®¡ç†ç•Œé¢åŠŸèƒ½**ï¼š
```
è§’è‰²åˆ—è¡¨é¡µé¢ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [æ–°å¢è§’è‰²]                            [æœç´¢æ¡†] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è§’è‰²åç§°   â”‚ è§’è‰²æè¿°     â”‚ çŠ¶æ€  â”‚ æ“ä½œ      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¶…çº§ç®¡ç†å‘˜  â”‚ ç³»ç»Ÿæœ€é«˜æƒé™  â”‚ å¯ç”¨  â”‚[ç¼–è¾‘][åˆ é™¤] â”‚
â”‚ éƒ¨é—¨ç»ç†   â”‚ éƒ¨é—¨ç®¡ç†æƒé™  â”‚ å¯ç”¨  â”‚[ç¼–è¾‘][åˆ é™¤] â”‚
â”‚ æ™®é€šç¼–è¾‘   â”‚ å†…å®¹ç¼–è¾‘æƒé™  â”‚ å¯ç”¨  â”‚[ç¼–è¾‘][åˆ é™¤] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æƒé™é…ç½®é¡µé¢**ï¼š
```
æƒé™åˆ†é…ç•Œé¢ï¼ˆæ ‘å½¢ç»“æ„ï¼‰ï¼š
â–¡ ç”¨æˆ·ç®¡ç†
  â”œâ”€ â˜‘ æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨
  â”œâ”€ â˜‘ åˆ›å»ºç”¨æˆ·
  â”œâ”€ â˜‘ ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯
  â””â”€ â–¡ åˆ é™¤ç”¨æˆ·
â–¡ å†…å®¹ç®¡ç†  
  â”œâ”€ â˜‘ æŸ¥çœ‹æ–‡ç« åˆ—è¡¨
  â”œâ”€ â˜‘ åˆ›å»ºæ–‡ç« 
  â”œâ”€ â˜‘ ç¼–è¾‘æ–‡ç« 
  â””â”€ â˜‘ å‘å¸ƒæ–‡ç« 
```

### 7.3 åŠ¨æ€æƒé™åŠ è½½æœºåˆ¶


**æƒé™åŠ¨æ€åŠ è½½æµç¨‹**ï¼š
```
ç”¨æˆ·ç™»å½• â†’ æŸ¥è¯¢ç”¨æˆ·è§’è‰² â†’ æŸ¥è¯¢è§’è‰²æƒé™ â†’ ç”Ÿæˆæƒé™åˆ—è¡¨ â†’ ç¼“å­˜æƒé™ä¿¡æ¯

æƒé™æ£€æŸ¥æµç¨‹ï¼š
æ¥æ”¶è¯·æ±‚ â†’ ä»ç¼“å­˜è·å–æƒé™ â†’ æ£€æŸ¥æ˜¯å¦æœ‰æƒé™ â†’ å…è®¸/æ‹’ç»è®¿é—®
```

**åŠ¨æ€æƒé™é…ç½®å®ç°**ï¼š
```java
@RestController
@RequestMapping("/admin/permissions")
public class PermissionConfigController {
    
    @Autowired
    private PermissionService permissionService;
    
    // è·å–æƒé™æ ‘å½¢ç»“æ„
    @GetMapping("/tree")
    public Result<List<PermissionTree>> getPermissionTree() {
        List<PermissionTree> tree = permissionService.getPermissionTree();
        return Result.success(tree);
    }
    
    // è·å–è§’è‰²çš„æƒé™é…ç½®
    @GetMapping("/role/{roleId}")
    public Result<RolePermissionConfig> getRolePermissions(@PathVariable Long roleId) {
        RolePermissionConfig config = permissionService.getRolePermissionConfig(roleId);
        return Result.success(config);
    }
    
    // ä¿å­˜è§’è‰²æƒé™é…ç½®
    @PostMapping("/role/{roleId}")
    public Result saveRolePermissions(
        @PathVariable Long roleId, 
        @RequestBody List<Long> permissionIds) {
        
        permissionService.saveRolePermissions(roleId, permissionIds);
        
        // æ¸…é™¤ç›¸å…³æƒé™ç¼“å­˜
        permissionCacheService.clearRolePermissionCache(roleId);
        
        return Result.success("æƒé™é…ç½®ä¿å­˜æˆåŠŸ");
    }
}
```

### 7.4 æƒé™é…ç½®æ•°æ®ç»“æ„


**æƒé™æ ‘å½¢ç»“æ„**ï¼š
```java
public class PermissionTree {
    private Long id;
    private String permissionCode;
    private String permissionName;
    private Long parentId;
    private List<PermissionTree> children;
    private boolean checked; // æ˜¯å¦è¢«é€‰ä¸­
    
    // getters and setters
}
```

**è§’è‰²æƒé™é…ç½®å¯¹è±¡**ï¼š
```java
public class RolePermissionConfig {
    private Long roleId;
    private String roleName;
    private List<Long> permissionIds; // å·²åˆ†é…çš„æƒé™IDåˆ—è¡¨
    private List<PermissionTree> permissionTree; // æƒé™æ ‘ç»“æ„
    
    // getters and setters
}
```

---

## 8. ğŸ› ï¸ å®ç°æŠ€æœ¯é€‰å‹ä¸å¯¹æ¯”


### 8.1 ä¸»æµRBACå®ç°æ¡†æ¶


| æ¡†æ¶ | ä¼˜åŠ¿ | åŠ£åŠ¿ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| **Spring Security** | æˆç†Ÿç¨³å®šã€åŠŸèƒ½å¼ºå¤§ã€ç¤¾åŒºæ´»è·ƒ | å­¦ä¹ æ›²çº¿é™¡å³­ã€é…ç½®å¤æ‚ | ä¼ä¸šçº§åº”ç”¨ã€å¤æ‚æƒé™éœ€æ±‚ |
| **Apache Shiro** | ç®€å•æ˜“ç”¨ã€è½»é‡çº§ã€æ–‡æ¡£æ¸…æ™° | åŠŸèƒ½ç›¸å¯¹ç®€å•ã€æ›´æ–°è¾ƒæ…¢ | ä¸­å°å‹é¡¹ç›®ã€å¿«é€Ÿå¼€å‘ |
| **è‡ªç ”æ¡†æ¶** | é«˜åº¦å®šåˆ¶ã€ç¬¦åˆä¸šåŠ¡éœ€æ±‚ | å¼€å‘æˆæœ¬é«˜ã€ç»´æŠ¤å¤æ‚ | ç‰¹æ®Šä¸šåŠ¡éœ€æ±‚ã€å›¢é˜ŸæŠ€æœ¯å®åŠ›å¼º |

### 8.2 Spring Securityå®ç°


**æ ¸å¿ƒé…ç½®**ï¼š
```java
@Configuration
@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class SecurityConfig {
    
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
    
    @Bean
    public UserDetailsService userDetailsService() {
        return new CustomUserDetailsService();
    }
    
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
            .authorizeRequests()
            .antMatchers("/login", "/register").permitAll()
            .antMatchers("/admin/**").hasRole("ADMIN")
            .antMatchers("/api/**").authenticated()
            .and()
            .formLogin()
            .loginProcessingUrl("/login")
            .defaultSuccessUrl("/dashboard")
            .and()
            .logout()
            .logoutUrl("/logout")
            .logoutSuccessUrl("/login");
    }
}
```

**è‡ªå®šä¹‰ç”¨æˆ·è¯¦æƒ…æœåŠ¡**ï¼š
```java
@Service
public class CustomUserDetailsService implements UserDetailsService {
    
    @Autowired
    private UserService userService;
    
    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        User user = userService.findByUsername(username);
        if (user == null) {
            throw new UsernameNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨: " + username);
        }
        
        // æŸ¥è¯¢ç”¨æˆ·æƒé™
        Set<String> permissions = userService.getUserPermissions(user.getId());
        
        // è½¬æ¢ä¸ºSpring Securityçš„æƒé™æ ¼å¼
        Set<SimpleGrantedAuthority> authorities = permissions.stream()
            .map(SimpleGrantedAuthority::new)
            .collect(Collectors.toSet());
        
        return new org.springframework.security.core.userdetails.User(
            user.getUsername(),
            user.getPassword(),
            user.isEnabled(),
            true, true, true,
            authorities
        );
    }
}
```

### 8.3 Apache Shiroå®ç°


**Shiroé…ç½®**ï¼š
```java
@Configuration
public class ShiroConfig {
    
    @Bean
    public ShiroFilterFactoryBean shiroFilterFactoryBean(SecurityManager securityManager) {
        ShiroFilterFactoryBean factoryBean = new ShiroFilterFactoryBean();
        factoryBean.setSecurityManager(securityManager);
        
        Map<String, String> filterChainDefinitionMap = new LinkedHashMap<>();
        filterChainDefinitionMap.put("/login", "anon");
        filterChainDefinitionMap.put("/admin/**", "authc,roles[admin]");
        filterChainDefinitionMap.put("/**", "authc");
        
        factoryBean.setFilterChainDefinitionMap(filterChainDefinitionMap);
        return factoryBean;
    }
    
    @Bean
    public DefaultWebSecurityManager securityManager(CustomRealm customRealm) {
        DefaultWebSecurityManager manager = new DefaultWebSecurityManager();
        manager.setRealm(customRealm);
        return manager;
    }
}
```

**è‡ªå®šä¹‰Realm**ï¼š
```java
@Component
public class CustomRealm extends AuthorizingRealm {
    
    @Autowired
    private UserService userService;
    
    // æˆæƒæ–¹æ³•
    @Override
    protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principals) {
        String username = (String) principals.getPrimaryPrincipal();
        User user = userService.findByUsername(username);
        
        SimpleAuthorizationInfo authorizationInfo = new SimpleAuthorizationInfo();
        
        // æ·»åŠ è§’è‰²
        Set<String> roles = userService.getUserRoles(user.getId());
        authorizationInfo.setRoles(roles);
        
        // æ·»åŠ æƒé™
        Set<String> permissions = userService.getUserPermissions(user.getId());
        authorizationInfo.setStringPermissions(permissions);
        
        return authorizationInfo;
    }
    
    // è®¤è¯æ–¹æ³•
    @Override
    protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken token) 
            throws AuthenticationException {
        String username = (String) token.getPrincipal();
        User user = userService.findByUsername(username);
        
        if (user == null) {
            throw new UnknownAccountException("ç”¨æˆ·ä¸å­˜åœ¨");
        }
        
        return new SimpleAuthenticationInfo(username, user.getPassword(), getName());
    }
}
```

### 8.4 è‡ªç ”æ¡†æ¶å®ç°


**æ ¸å¿ƒæƒé™æ£€æŸ¥å™¨**ï¼š
```java
@Component
public class PermissionChecker {
    
    @Autowired
    private PermissionCacheService permissionCache;
    
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æŒ‡å®šæƒé™
    public boolean hasPermission(Long userId, String permission) {
        Set<String> userPermissions = permissionCache.getUserPermissions(userId);
        return userPermissions.contains(permission);
    }
    
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰è§’è‰²
    public boolean hasRole(Long userId, String roleCode) {
        Set<String> userRoles = permissionCache.getUserRoles(userId);
        return userRoles.contains(roleCode);
    }
    
    // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä¸€æƒé™
    public boolean hasAnyPermission(Long userId, String... permissions) {
        Set<String> userPermissions = permissionCache.getUserPermissions(userId);
        return Arrays.stream(permissions)
            .anyMatch(userPermissions::contains);
    }
}
```

**æƒé™æ³¨è§£å®ç°**ï¼š
```java
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface RequirePermission {
    String[] value();
    LogicalOperator operator() default LogicalOperator.AND;
}

@Aspect
@Component
public class PermissionAspect {
    
    @Autowired
    private PermissionChecker permissionChecker;
    
    @Around("@annotation(requirePermission)")
    public Object checkPermission(ProceedingJoinPoint joinPoint, RequirePermission requirePermission) throws Throwable {
        // è·å–å½“å‰ç”¨æˆ·ID
        Long userId = getCurrentUserId();
        
        String[] permissions = requirePermission.value();
        boolean hasPermission;
        
        if (requirePermission.operator() == LogicalOperator.AND) {
            // éœ€è¦æ‹¥æœ‰æ‰€æœ‰æƒé™
            hasPermission = Arrays.stream(permissions)
                .allMatch(perm -> permissionChecker.hasPermission(userId, perm));
        } else {
            // æ‹¥æœ‰ä»»ä¸€æƒé™å³å¯
            hasPermission = permissionChecker.hasAnyPermission(userId, permissions);
        }
        
        if (!hasPermission) {
            throw new AccessDeniedException("æƒé™ä¸è¶³");
        }
        
        return joinPoint.proceed();
    }
}
```

---

## 9. ğŸ† RBACæœ€ä½³å®è·µ


### 9.1 æƒé™è®¾è®¡åŸåˆ™


**æœ€å°æƒé™åŸåˆ™**ï¼š
```
âœ… ç”¨æˆ·åªè·å¾—å®Œæˆå·¥ä½œæ‰€éœ€çš„æœ€å°æƒé™
âœ… é¿å…æƒé™è¿‡åº¦åˆ†é…
âœ… å®šæœŸå®¡æŸ¥å’Œå›æ”¶ä¸å¿…è¦çš„æƒé™

ç¤ºä¾‹ï¼š
âŒ é”™è¯¯ï¼šç»™æ‰€æœ‰å‘˜å·¥ç®¡ç†å‘˜æƒé™å›¾æ–¹ä¾¿
âœ… æ­£ç¡®ï¼šæ ¹æ®å²—ä½èŒè´£åˆ†é…æœ€å°å¿…è¦æƒé™
```

**èŒè´£åˆ†ç¦»åŸåˆ™**ï¼š
```
âœ… é‡è¦æ“ä½œéœ€è¦å¤šäººåä½œ
âœ… é¿å…æƒåŠ›è¿‡äºé›†ä¸­
âœ… å…³é”®æ“ä½œéœ€è¦å®¡æ‰¹æµç¨‹

ç¤ºä¾‹ï¼š
- åˆ›å»ºç”¨æˆ·ï¼šæ™®é€šç®¡ç†å‘˜å¯ä»¥æ“ä½œ
- åˆ é™¤ç”¨æˆ·ï¼šéœ€è¦é«˜çº§ç®¡ç†å‘˜æƒé™
- æ•°æ®å¯¼å‡ºï¼šéœ€è¦æ•°æ®ç®¡ç†å‘˜+éƒ¨é—¨ç»ç†åŒé‡æˆæƒ
```

### 9.2 æ•°æ®å®‰å…¨å®è·µ


**æ•æ„Ÿæ“ä½œå®¡è®¡**ï¼š
```sql
-- åˆ›å»ºæ“ä½œå®¡è®¡è¡¨
CREATE TABLE operation_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    username VARCHAR(50),
    operation VARCHAR(100) NOT NULL COMMENT 'æ“ä½œç±»å‹',
    resource_type VARCHAR(50) COMMENT 'èµ„æºç±»å‹',
    resource_id VARCHAR(100) COMMENT 'èµ„æºID',
    ip_address VARCHAR(45) COMMENT 'IPåœ°å€',
    user_agent TEXT COMMENT 'ç”¨æˆ·ä»£ç†',
    request_data JSON COMMENT 'è¯·æ±‚æ•°æ®',
    response_status INT COMMENT 'å“åº”çŠ¶æ€',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_operation (user_id, operation, created_at),
    INDEX idx_resource (resource_type, resource_id)
);
```

**å®¡è®¡æ—¥å¿—è®°å½•**ï¼š
```java
@Aspect
@Component
public class AuditLogAspect {
    
    @Autowired
    private OperationLogService operationLogService;
    
    @AfterReturning(pointcut = "@annotation(auditLog)", returning = "result")
    public void recordAuditLog(JoinPoint joinPoint, AuditLog auditLog, Object result) {
        try {
            OperationLog log = new OperationLog();
            log.setUserId(getCurrentUserId());
            log.setUsername(getCurrentUsername());
            log.setOperation(auditLog.operation());
            log.setResourceType(auditLog.resourceType());
            log.setIpAddress(getClientIpAddress());
            log.setRequestData(JSON.toJSONString(joinPoint.getArgs()));
            log.setResponseStatus(200);
            
            operationLogService.save(log);
        } catch (Exception e) {
            // å®¡è®¡æ—¥å¿—è®°å½•å¤±è´¥ä¸åº”å½±å“ä¸»æµç¨‹
            logger.error("è®°å½•å®¡è®¡æ—¥å¿—å¤±è´¥", e);
        }
    }
}
```

### 9.3 æƒé™ç»´æŠ¤ç­–ç•¥


**å®šæœŸæƒé™å®¡æŸ¥**ï¼š
```java
@Service
public class PermissionAuditService {
    
    // æŸ¥æ‰¾é•¿æœŸæœªä½¿ç”¨çš„æƒé™
    public List<UnusedPermission> findUnusedPermissions(int days) {
        return operationLogRepository.findPermissionsNotUsedInDays(days);
    }
    
    // æŸ¥æ‰¾æƒé™è¿‡åº¦åˆ†é…çš„ç”¨æˆ·
    public List<OverPrivilegedUser> findOverPrivilegedUsers() {
        return userRepository.findUsersWithExcessivePermissions();
    }
    
    // ç”Ÿæˆæƒé™å®¡è®¡æŠ¥å‘Š
    public PermissionAuditReport generateAuditReport() {
        PermissionAuditReport report = new PermissionAuditReport();
        report.setUnusedPermissions(findUnusedPermissions(30));
        report.setOverPrivilegedUsers(findOverPrivilegedUsers());
        report.setRoleDistribution(getRoleDistribution());
        return report;
    }
}
```

### 9.4 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


**åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–**ï¼š
```java
// å¤§æ•°æ®é‡ä¸‹çš„ç”¨æˆ·æƒé™æŸ¥è¯¢ä¼˜åŒ–
@Repository
public class UserPermissionRepository {
    
    // ä½¿ç”¨æ¸¸æ ‡åˆ†é¡µï¼Œé¿å…æ·±åˆ†é¡µæ€§èƒ½é—®é¢˜
    public PageResult<UserPermission> findUserPermissions(
            Long lastUserId, int pageSize, String keyword) {
        
        StringBuilder sql = new StringBuilder();
        sql.append("SELECT u.id, u.username, GROUP_CONCAT(r.role_name) as roles ");
        sql.append("FROM users u ");
        sql.append("LEFT JOIN user_roles ur ON u.id = ur.user_id ");
        sql.append("LEFT JOIN roles r ON ur.role_id = r.id ");
        sql.append("WHERE u.id > ? ");
        
        if (StringUtils.hasText(keyword)) {
            sql.append("AND u.username LIKE ? ");
        }
        
        sql.append("GROUP BY u.id, u.username ");
        sql.append("ORDER BY u.id ");
        sql.append("LIMIT ?");
        
        // æ‰§è¡ŒæŸ¥è¯¢...
    }
}
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ RBACæœ¬è´¨ï¼šç”¨æˆ·-è§’è‰²-æƒé™çš„ä¸‰å±‚æƒé™æ§åˆ¶æ¨¡å‹
ğŸ”¸ äº”è¡¨è®¾è®¡ï¼šç”¨æˆ·è¡¨ã€è§’è‰²è¡¨ã€æƒé™è¡¨ã€ç”¨æˆ·è§’è‰²å…³è”è¡¨ã€è§’è‰²æƒé™å…³è”è¡¨
ğŸ”¸ æƒé™çŸ©é˜µï¼šæ¸…æ™°å±•ç¤ºè§’è‰²å’Œæƒé™çš„å¯¹åº”å…³ç³»
ğŸ”¸ ç¼“å­˜ç­–ç•¥ï¼šå¤šå±‚ç¼“å­˜æé«˜æƒé™æ£€æŸ¥æ€§èƒ½
ğŸ”¸ åŠ¨æ€é…ç½®ï¼šå¯è§†åŒ–ç•Œé¢å®ç°æƒé™çš„åŠ¨æ€åˆ†é…å’Œç®¡ç†
```

### 10.2 å…³é”®å®ç°è¦ç‚¹


**ğŸ”¹ æ•°æ®åº“è®¾è®¡è¦ç‚¹**
```
è¡¨ç»“æ„è®¾è®¡ï¼š
- åˆç†çš„å­—æ®µç±»å‹å’Œé•¿åº¦
- å¿…è¦çš„ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
- å¤–é”®çº¦æŸä¿è¯æ•°æ®ä¸€è‡´æ€§
- çŠ¶æ€å­—æ®µæ”¯æŒè½¯åˆ é™¤

æƒé™ç¼–ç è§„èŒƒï¼š
- ç»Ÿä¸€çš„ç¼–ç æ ¼å¼ï¼šæ¨¡å—:èµ„æº:æ“ä½œ
- ä¾¿äºç¨‹åºåˆ¤æ–­å’Œç®¡ç†ç»´æŠ¤
- æ”¯æŒæƒé™çš„å±‚æ¬¡åŒ–ç»„ç»‡
```

**ğŸ”¹ ç¼“å­˜è®¾è®¡è¦ç‚¹**
```
ç¼“å­˜ç­–ç•¥ï¼š
- å¤šå±‚ç¼“å­˜æ¶æ„æé«˜æ€§èƒ½
- åˆç†çš„è¿‡æœŸæ—¶é—´é¿å…æ•°æ®ä¸ä¸€è‡´
- æƒé™å˜æ›´æ—¶åŠæ—¶æ¸…é™¤ç›¸å…³ç¼“å­˜

ç¼“å­˜æ›´æ–°ï¼š
- ç”¨æˆ·è§’è‰²å˜æ›´ï¼šæ¸…é™¤ç”¨æˆ·æƒé™ç¼“å­˜
- è§’è‰²æƒé™å˜æ›´ï¼šæ‰¹é‡æ¸…é™¤ç›¸å…³ç”¨æˆ·ç¼“å­˜
- å®šæ—¶åˆ·æ–°ï¼šé˜²æ­¢ç¼“å­˜æ°¸ä¸è¿‡æœŸ
```

**ğŸ”¹ åŠ¨æ€é…ç½®è¦ç‚¹**
```
ç•Œé¢è®¾è®¡ï¼š
- æƒé™æ ‘å½¢ç»“æ„ä¾¿äºç†è§£å’Œæ“ä½œ
- æ‰¹é‡æ“ä½œæé«˜é…ç½®æ•ˆç‡
- å®æ—¶ç”Ÿæ•ˆå‡å°‘ç³»ç»Ÿé‡å¯

é…ç½®ç®¡ç†ï¼š
- æƒé™æ¨¡æ¿å‡å°‘é‡å¤é…ç½®
- æƒé™ç»§æ‰¿ç®€åŒ–ç®¡ç†å¤æ‚åº¦
- æ“ä½œå®¡è®¡ä¿è¯å®‰å…¨æ€§
```

### 10.3 æŠ€æœ¯é€‰å‹æŒ‡å¯¼


**æ¡†æ¶é€‰æ‹©å»ºè®®**ï¼š
```
Spring Securityï¼š
âœ… ä¼ä¸šçº§åº”ç”¨é¦–é€‰
âœ… åŠŸèƒ½å…¨é¢ï¼Œå®‰å…¨æ€§é«˜
âŒ å­¦ä¹ æˆæœ¬é«˜ï¼Œé…ç½®å¤æ‚

Apache Shiroï¼š
âœ… è½»é‡çº§ï¼Œæ˜“äºä½¿ç”¨
âœ… æ–‡æ¡£æ¸…æ™°ï¼Œä¸Šæ‰‹å¿«
âŒ åŠŸèƒ½ç›¸å¯¹ç®€å•

è‡ªç ”æ¡†æ¶ï¼š
âœ… é«˜åº¦å®šåˆ¶ï¼Œå®Œå…¨å¯æ§
âŒ å¼€å‘æˆæœ¬é«˜ï¼Œç»´æŠ¤å¤æ‚
```

### 10.4 å®é™…åº”ç”¨ä»·å€¼


**ä¸šåŠ¡åœºæ™¯åº”ç”¨**ï¼š
- **ä¼ä¸šç®¡ç†ç³»ç»Ÿ**ï¼šå¤šè§’è‰²ã€å¤šå±‚çº§æƒé™ç®¡ç†
- **å†…å®¹ç®¡ç†å¹³å°**ï¼šç¼–è¾‘ã€å®¡æ ¸ã€å‘å¸ƒç­‰æƒé™æ§åˆ¶
- **ç”µå•†åå°**ï¼šè¿è¥ã€å®¢æœã€è´¢åŠ¡ç­‰ä¸åŒæƒé™
- **SaaSå¹³å°**ï¼šç§Ÿæˆ·éš”ç¦»ã€è§’è‰²æƒé™ç®¡ç†

**ç³»ç»Ÿè®¾è®¡ä»·å€¼**ï¼š
- **å®‰å…¨æ€§**ï¼šç»†ç²’åº¦æƒé™æ§åˆ¶ï¼Œé˜²æ­¢æƒé™æ»¥ç”¨
- **å¯ç»´æŠ¤æ€§**ï¼šè§’è‰²åŒ–ç®¡ç†ï¼Œæƒé™å˜æ›´ç®€å•
- **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒæƒé™çš„çµæ´»ç»„åˆå’Œæ‰©å±•
- **æ€§èƒ½**ï¼šåˆç†ç¼“å­˜ç­–ç•¥ï¼Œé«˜å¹¶å‘åœºæ™¯å‹å¥½

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- RBACå°±æ˜¯"è§’è‰²ç®¡æƒé™ï¼Œç”¨æˆ·é…è§’è‰²"çš„æƒé™ç®¡ç†æ–¹å¼
- äº”è¡¨æ¨¡å‹æ˜¯RBACçš„æ ‡å‡†æ•°æ®åº“å®ç°
- æƒé™ç¼“å­˜æ˜¯é«˜æ€§èƒ½RBACç³»ç»Ÿçš„å¿…éœ€å“
- åŠ¨æ€é…ç½®è®©æƒé™ç®¡ç†æ›´åŠ çµæ´»ä¾¿æ·
- é€‰æ‹©åˆé€‚çš„æŠ€æœ¯æ¡†æ¶èƒ½äº‹åŠåŠŸå€