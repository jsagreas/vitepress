---
title: 11ã€RBACæ‰©å±•ä¸è¿›é˜¶
---
## ğŸ“š ç›®å½•

1. [ä¸´æ—¶æˆæƒä¸åŠ¨æ€æƒé™åˆ†é…](#1-ä¸´æ—¶æˆæƒä¸åŠ¨æ€æƒé™åˆ†é…)
2. [åŸºäºæ ‡ç­¾/å±æ€§çš„æ‰©å±•ï¼ˆRBAC + ABACï¼‰](#2-åŸºäºæ ‡ç­¾å±æ€§çš„æ‰©å±•rbac--abac)
3. [å¤šç§Ÿæˆ·ç³»ç»Ÿä¸­çš„æƒé™éš”ç¦»](#3-å¤šç§Ÿæˆ·ç³»ç»Ÿä¸­çš„æƒé™éš”ç¦»)
4. [æƒé™å˜æ›´çš„å³æ—¶ç”Ÿæ•ˆæœºåˆ¶](#4-æƒé™å˜æ›´çš„å³æ—¶ç”Ÿæ•ˆæœºåˆ¶)
5. [å®¡è®¡æ—¥å¿—è®°å½•æƒé™å˜æ›´](#5-å®¡è®¡æ—¥å¿—è®°å½•æƒé™å˜æ›´)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ•’ ä¸´æ—¶æˆæƒä¸åŠ¨æ€æƒé™åˆ†é…


### 1.1 ä»€ä¹ˆæ˜¯ä¸´æ—¶æˆæƒ


**ğŸ”¸ ç®€å•ç†è§£**
```
æƒ³è±¡ä½ æ˜¯ä¸€ä¸ªå…¬å¸å‘˜å·¥ï¼š
- å¹³æ—¶ä½ åªèƒ½è®¿é—®è‡ªå·±éƒ¨é—¨çš„æ–‡ä»¶
- ä½†å‚ä¸è·¨éƒ¨é—¨é¡¹ç›®æ—¶ï¼Œéœ€è¦ä¸´æ—¶è®¿é—®å…¶ä»–éƒ¨é—¨èµ„æ–™
- é¡¹ç›®ç»“æŸåï¼Œè¿™ä¸ªä¸´æ—¶æƒé™å°±è‡ªåŠ¨æ”¶å›

è¿™å°±æ˜¯ä¸´æ—¶æˆæƒï¼
```

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š
- â° **æœ‰æ—¶é—´é™åˆ¶** - æƒé™æœ‰æ˜ç¡®çš„å¼€å§‹å’Œç»“æŸæ—¶é—´
- ğŸ¯ **ç›®çš„æ˜ç¡®** - ä¸ºäº†ç‰¹å®šä»»åŠ¡æˆ–é¡¹ç›®è€Œæˆäºˆ
- ğŸ”„ **è‡ªåŠ¨å›æ”¶** - åˆ°æœŸåç³»ç»Ÿè‡ªåŠ¨æ”¶å›æƒé™
- ğŸ“‹ **å¯è¿½æº¯** - æœ‰å®Œæ•´çš„æˆæƒè®°å½•

### 1.2 ä¸´æ—¶æˆæƒçš„å®ç°æ–¹å¼


**ğŸ—ï¸ æ•°æ®åº“è®¾è®¡**
```sql
-- ä¸´æ—¶æƒé™è¡¨
CREATE TABLE temp_permissions (
    id BIGINT PRIMARY KEY,
    user_id BIGINT,           -- ç”¨æˆ·ID
    permission_id BIGINT,     -- æƒé™ID
    granted_by BIGINT,        -- æˆæƒäºº
    reason VARCHAR(500),      -- æˆæƒåŸå› 
    start_time DATETIME,      -- å¼€å§‹æ—¶é—´
    end_time DATETIME,        -- ç»“æŸæ—¶é—´
    status ENUM('active', 'expired', 'revoked'), -- çŠ¶æ€
    created_at DATETIME
);
```

**ğŸ’¡ ç”Ÿæ´»åŒ–è§£é‡Š**
```
è¿™å°±åƒç»™æœ‹å‹å®¶é’¥åŒ™ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æœ‹å‹å‡ºå·®äº†      â”‚ â†’ åŸå› æ˜ç¡®
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç»™ä½ é’¥åŒ™        â”‚ â†’ ä¸´æ—¶æˆæƒ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¸®å¿™ç…§çœ‹3å¤©     â”‚ â†’ æ—¶é—´é™åˆ¶
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å›æ¥åæ”¶å›é’¥åŒ™   â”‚ â†’ è‡ªåŠ¨åˆ°æœŸ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 åŠ¨æ€æƒé™åˆ†é…æœºåˆ¶


**ğŸ”„ ä»€ä¹ˆæ˜¯åŠ¨æ€æƒé™**
- **é™æ€æƒé™**ï¼šç”¨æˆ·è§’è‰²å›ºå®šï¼Œæƒé™åŸºæœ¬ä¸å˜
- **åŠ¨æ€æƒé™**ï¼šæ ¹æ®å®æ—¶æƒ…å†µè‡ªåŠ¨è°ƒæ•´ç”¨æˆ·æƒé™

**å®é™…åº”ç”¨åœºæ™¯**
```
ğŸ¥ åŒ»é™¢ç³»ç»Ÿï¼š
- åŒ»ç”Ÿå€¼ç­æ—¶ â†’ è‡ªåŠ¨è·å¾—æ€¥è¯Šå¤„ç†æƒé™
- ä¸‹ç­å â†’ æƒé™è‡ªåŠ¨å›æ”¶

ğŸ¢ ä¼ä¸šç³»ç»Ÿï¼š
- å‘˜å·¥è¿›å…¥é¡¹ç›®ç»„ â†’ è‡ªåŠ¨è·å¾—é¡¹ç›®ç›¸å…³æƒé™
- ç¦»å¼€é¡¹ç›®ç»„ â†’ æƒé™è‡ªåŠ¨ç§»é™¤

ğŸ“ æ•™è‚²ç³»ç»Ÿï¼š
- å­¦æœŸå¼€å§‹ â†’ å­¦ç”Ÿè‡ªåŠ¨è·å¾—è¯¾ç¨‹è®¿é—®æƒé™
- å­¦æœŸç»“æŸ â†’ æƒé™è‡ªåŠ¨åˆ°æœŸ
```

**ç®€å•å®ç°ç¤ºä¾‹**
```java
@Service
public class DynamicPermissionService {
    
    // æ£€æŸ¥å¹¶æ›´æ–°ç”¨æˆ·åŠ¨æ€æƒé™
    public void updateUserDynamicPermissions(Long userId) {
        User user = userService.getUser(userId);
        
        // 1. æ£€æŸ¥ä¸´æ—¶æƒé™æ˜¯å¦åˆ°æœŸ
        removeExpiredPermissions(userId);
        
        // 2. æ ¹æ®ç”¨æˆ·å½“å‰çŠ¶æ€åˆ†é…æƒé™
        assignContextBasedPermissions(user);
        
        // 3. æ›´æ–°æƒé™ç¼“å­˜
        refreshPermissionCache(userId);
    }
    
    // ç§»é™¤è¿‡æœŸæƒé™
    private void removeExpiredPermissions(Long userId) {
        LocalDateTime now = LocalDateTime.now();
        tempPermissionMapper.expirePermissions(userId, now);
    }
}
```

---

## 2. ğŸ·ï¸ åŸºäºæ ‡ç­¾/å±æ€§çš„æ‰©å±•ï¼ˆRBAC + ABACï¼‰


### 2.1 ä»€ä¹ˆæ˜¯ABAC


**ğŸ”¸ ABACå…¨ç§°**ï¼šAttribute-Based Access Controlï¼ˆåŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶ï¼‰

**é€šä¿—è§£é‡Š**
```
RBACåƒæ˜¯æŒ‰èŒä½åˆ†æƒé™ï¼š
æ€»ç›‘ â†’ èƒ½çœ‹æ‰€æœ‰éƒ¨é—¨æ•°æ®
ç»ç† â†’ èƒ½çœ‹æœ¬éƒ¨é—¨æ•°æ®
å‘˜å·¥ â†’ èƒ½çœ‹è‡ªå·±æ•°æ®

ABACåƒæ˜¯æŒ‰å…·ä½“æƒ…å†µåˆ†æƒé™ï¼š
- åœ¨å…¬å¸å†…éƒ¨ + å·¥ä½œæ—¶é—´ â†’ èƒ½è®¿é—®æ•æ„Ÿæ•°æ®
- åœ¨å®¶åŠå…¬ + éå·¥ä½œæ—¶é—´ â†’ åªèƒ½è®¿é—®åŸºç¡€æ•°æ®
- å‡ºå·®åœ¨å¤– + ç´§æ€¥æƒ…å†µ â†’ éœ€è¦å®¡æ‰¹åè®¿é—®
```

### 2.2 RBACå’ŒABACçš„åŒºåˆ«


| å¯¹æ¯”ç»´åº¦ | **RBAC** | **ABAC** |
|---------|----------|----------|
| **æƒé™ä¾æ®** | `ç”¨æˆ·è§’è‰²` | `å¤šç§å±æ€§` |
| **çµæ´»æ€§** | `ç›¸å¯¹å›ºå®š` | `é«˜åº¦çµæ´»` |
| **å¤æ‚åº¦** | `ç®€å•æ˜“æ‡‚` | `å¤æ‚ä½†å¼ºå¤§` |
| **é€‚ç”¨åœºæ™¯** | `ç»„ç»‡ç»“æ„æ¸…æ™°` | `å¤æ‚ä¸šåŠ¡è§„åˆ™` |

### 2.3 RBAC + ABAC æ··åˆæ¨¡å¼


**ğŸ”„ ä¸ºä»€ä¹ˆè¦ç»“åˆä½¿ç”¨**
```
å•çº¯RBACçš„å±€é™ï¼š
âŒ è§’è‰²å¤ªå¤šï¼Œéš¾ç®¡ç†
âŒ æ— æ³•å¤„ç†ä¸´æ—¶æƒ…å†µ
âŒ æƒé™ç²’åº¦ä¸å¤Ÿç»†

å•çº¯ABACçš„é—®é¢˜ï¼š
âŒ è§„åˆ™å¤æ‚ï¼Œéš¾ç»´æŠ¤
âŒ æ€§èƒ½å¼€é”€å¤§
âŒ å­¦ä¹ æˆæœ¬é«˜

RBAC + ABAC = æœ€ä½³å®è·µï¼
âœ… åŸºç¡€æƒé™ç”¨è§’è‰²ç®¡ç†
âœ… ç‰¹æ®Šæƒ…å†µç”¨å±æ€§æ§åˆ¶
âœ… å…¼é¡¾ç®€å•å’Œçµæ´»
```

**å®ç°æ¶æ„å›¾**
```
ç”¨æˆ·è¯·æ±‚è®¿é—®èµ„æº
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æƒé™æ£€æŸ¥å¼•æ“   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. RBACåŸºç¡€æ£€æŸ¥ â”‚ â†’ è§’è‰²æ˜¯å¦æœ‰åŸºç¡€æƒé™ï¼Ÿ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2. ABACæ¡ä»¶æ£€æŸ¥ â”‚ â†’ å½“å‰ç¯å¢ƒæ˜¯å¦å…è®¸ï¼Ÿ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 3. ç»¼åˆåˆ¤æ–­     â”‚ â†’ ä¸¤ä¸ªæ¡ä»¶éƒ½æ»¡è¶³ï¼Ÿ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    å…è®¸/æ‹’ç»è®¿é—®
```

**ä»£ç å®ç°ç¤ºä¾‹**
```java
@Component
public class HybridAccessController {
    
    public boolean checkAccess(User user, Resource resource, Context context) {
        // ç¬¬ä¸€æ­¥ï¼šRBACæ£€æŸ¥
        boolean rbacAllowed = rbacService.hasPermission(
            user.getRoles(), 
            resource.getRequiredPermission()
        );
        
        if (!rbacAllowed) {
            return false; // RBACéƒ½ä¸é€šè¿‡ï¼Œç›´æ¥æ‹’ç»
        }
        
        // ç¬¬äºŒæ­¥ï¼šABACæ£€æŸ¥
        return abacService.evaluatePolicy(user, resource, context);
    }
}

// ABACç­–ç•¥ç¤ºä¾‹
public class ABACPolicy {
    
    public boolean evaluatePolicy(User user, Resource resource, Context context) {
        // æ£€æŸ¥æ—¶é—´å±æ€§
        if (!isWorkingHours(context.getTimestamp())) {
            return false;
        }
        
        // æ£€æŸ¥ä½ç½®å±æ€§
        if (!isInOffice(context.getLocation())) {
            return resource.getSecurityLevel() <= SecurityLevel.LOW;
        }
        
        // æ£€æŸ¥è®¾å¤‡å±æ€§
        if (!isTrustedDevice(context.getDeviceId())) {
            return false;
        }
        
        return true;
    }
}
```

---

## 3. ğŸ¢ å¤šç§Ÿæˆ·ç³»ç»Ÿä¸­çš„æƒé™éš”ç¦»


### 3.1 ä»€ä¹ˆæ˜¯å¤šç§Ÿæˆ·ç³»ç»Ÿ


**ğŸ  ç”Ÿæ´»åŒ–æ¯”å–»**
```
å¤šç§Ÿæˆ·ç³»ç»Ÿå°±åƒä¸€æ ‹å…¬å¯“æ¥¼ï¼š

å•ç§Ÿæˆ·ç³»ç»Ÿ = ç‹¬æ ‹åˆ«å¢…
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Aå…¬å¸ä¸“ç”¨     â”‚ â†’ æ•´ä¸ªç³»ç»Ÿåªä¸ºAå…¬å¸æœåŠ¡
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚ Açš„æ•°æ® â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¤šç§Ÿæˆ·ç³»ç»Ÿ = å…¬å¯“æ¥¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚Aå…¬å¸â”‚ â”‚Bå…¬å¸â”‚ â”‚ â†’ åŒä¸€ä¸ªç³»ç»Ÿä¸ºå¤šå®¶å…¬å¸æœåŠ¡
â”‚ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚Cå…¬å¸â”‚ â”‚Då…¬å¸â”‚ â”‚ â†’ ä½†æ•°æ®å®Œå…¨éš”ç¦»
â”‚ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æƒé™éš”ç¦»çš„æŒ‘æˆ˜


**ğŸš« ä¸»è¦é—®é¢˜**
```
æ•°æ®æ³„éœ²é£é™©ï¼š
Aå…¬å¸å‘˜å·¥ä¸èƒ½çœ‹åˆ°Bå…¬å¸æ•°æ®

æƒé™ç®¡ç†å¤æ‚ï¼š
æ¯ä¸ªç§Ÿæˆ·éƒ½æœ‰è‡ªå·±çš„ç”¨æˆ·å’Œè§’è‰²ä½“ç³»

è·¨ç§Ÿæˆ·åä½œï¼š
æœ‰æ—¶éœ€è¦å®‰å…¨çš„è·¨ç§Ÿæˆ·æ•°æ®å…±äº«
```

### 3.3 å¤šç§Ÿæˆ·æƒé™éš”ç¦»æ–¹æ¡ˆ


**ğŸ” éš”ç¦»ç­–ç•¥**

**æ–¹æ¡ˆä¸€ï¼šæ•°æ®åº“çº§éš”ç¦»**
```sql
-- æ¯ä¸ªç§Ÿæˆ·ç‹¬ç«‹æ•°æ®åº“
tenant_1_db.users
tenant_1_db.roles  
tenant_1_db.permissions

tenant_2_db.users
tenant_2_db.roles
tenant_2_db.permissions

-- ä¼˜ç‚¹ï¼šéš”ç¦»å½»åº•ï¼Œå®‰å…¨æ€§æœ€é«˜
-- ç¼ºç‚¹ï¼šèµ„æºæ¶ˆè€—å¤§ï¼Œç»´æŠ¤å¤æ‚
```

**æ–¹æ¡ˆäºŒï¼šè¡¨çº§éš”ç¦»ï¼ˆæ¨èï¼‰**
```sql
-- å…±äº«æ•°æ®åº“ï¼Œè¡¨ä¸­åŠ ç§Ÿæˆ·å­—æ®µ
CREATE TABLE users (
    id BIGINT PRIMARY KEY,
    tenant_id VARCHAR(50) NOT NULL,  -- ç§Ÿæˆ·æ ‡è¯†
    username VARCHAR(100),
    email VARCHAR(200),
    -- ... å…¶ä»–å­—æ®µ
    INDEX idx_tenant_id (tenant_id)
);

CREATE TABLE user_roles (
    user_id BIGINT,
    role_id BIGINT,
    tenant_id VARCHAR(50) NOT NULL,  -- ç¡®ä¿è§’è‰²ä¹Ÿéš”ç¦»
    PRIMARY KEY (user_id, role_id)
);
```

**æƒé™æ£€æŸ¥å®ç°**
```java
@Service
public class MultiTenantPermissionService {
    
    // è·å–å½“å‰ç§Ÿæˆ·ID
    private String getCurrentTenantId() {
        return TenantContext.getCurrentTenant();
    }
    
    // æ£€æŸ¥ç”¨æˆ·æƒé™ï¼ˆè‡ªåŠ¨åŠ ç§Ÿæˆ·è¿‡æ»¤ï¼‰
    public boolean hasPermission(Long userId, String permission) {
        String tenantId = getCurrentTenantId();
        
        // æŸ¥è¯¢æ—¶è‡ªåŠ¨åŠ ä¸Šç§Ÿæˆ·æ¡ä»¶
        return permissionMapper.checkPermission(userId, permission, tenantId);
    }
    
    // è·å–ç”¨æˆ·è§’è‰²ï¼ˆåªè¿”å›å½“å‰ç§Ÿæˆ·çš„è§’è‰²ï¼‰
    public List<Role> getUserRoles(Long userId) {
        String tenantId = getCurrentTenantId();
        return roleMapper.getUserRolesByTenant(userId, tenantId);
    }
}
```

### 3.4 è·¨ç§Ÿæˆ·æƒé™ç®¡ç†


**ğŸ¤ å®‰å…¨çš„è·¨ç§Ÿæˆ·åä½œ**
```
åœºæ™¯ï¼šAå…¬å¸éœ€è¦å‘Bå…¬å¸å…±äº«æŸäº›æ•°æ®

è§£å†³æ–¹æ¡ˆï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è·¨ç§Ÿæˆ·æƒé™è¡¨     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ source_tenant   â”‚ â†’ Aå…¬å¸
â”‚ target_tenant   â”‚ â†’ Bå…¬å¸  
â”‚ resource_type   â”‚ â†’ é¡¹ç›®æ•°æ®
â”‚ permissions     â”‚ â†’ åªè¯»æƒé™
â”‚ expire_time     â”‚ â†’ 30å¤©ååˆ°æœŸ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®ç°ä»£ç **
```java
@Entity
public class CrossTenantPermission {
    private String sourceTenant;     // æ•°æ®æä¾›æ–¹
    private String targetTenant;     // æ•°æ®ä½¿ç”¨æ–¹
    private String resourceType;     // èµ„æºç±»å‹
    private String permissions;      // å…·ä½“æƒé™
    private LocalDateTime expireTime; // è¿‡æœŸæ—¶é—´
    private String approvedBy;       // å®¡æ‰¹äºº
}

@Service
public class CrossTenantService {
    
    public boolean canAccessCrossTenant(String currentTenant, 
                                       String targetTenant, 
                                       String resource) {
        CrossTenantPermission permission = 
            crossTenantMapper.findValidPermission(
                targetTenant, currentTenant, resource
            );
            
        return permission != null && 
               permission.getExpireTime().isAfter(LocalDateTime.now());
    }
}
```

---

## 4. âš¡ æƒé™å˜æ›´çš„å³æ—¶ç”Ÿæ•ˆæœºåˆ¶


### 4.1 æƒé™å˜æ›´çš„æŒ‘æˆ˜


**ğŸŒ ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜**
```
ç®¡ç†å‘˜ä¿®æ”¹ç”¨æˆ·æƒé™ â†’ ç”¨æˆ·é‡æ–°ç™»å½•åæ‰ç”Ÿæ•ˆ

é—®é¢˜ï¼š
âŒ ç”¨æˆ·ä½“éªŒå·®ï¼ˆéœ€è¦é‡æ–°ç™»å½•ï¼‰
âŒ å®‰å…¨é£é™©ï¼ˆæ’¤é”€æƒé™ä¸åŠæ—¶ï¼‰
âŒ ä¸šåŠ¡å½±å“ï¼ˆç´§æ€¥æˆæƒå»¶è¿Ÿï¼‰
```

**âš¡ å³æ—¶ç”Ÿæ•ˆçš„å¿…è¦æ€§**
```
ç´§æ€¥åœºæ™¯ï¼š
ğŸš¨ å‘ç°å®‰å…¨å¨èƒ â†’ éœ€è¦ç«‹å³æ’¤é”€æŸç”¨æˆ·æƒé™
ğŸ†˜ ä¸šåŠ¡ç´§æ€¥éœ€æ±‚ â†’ éœ€è¦ç«‹å³æˆäºˆä¸´æ—¶æƒé™
ğŸ”¥ åˆè§„è¦æ±‚ â†’ æƒé™å˜æ›´å¿…é¡»ç«‹å³ç”Ÿæ•ˆ
```

### 4.2 å³æ—¶ç”Ÿæ•ˆçš„å®ç°æ–¹æ¡ˆ


**ğŸ”„ æ–¹æ¡ˆå¯¹æ¯”**

| æ–¹æ¡ˆ | **å®ç°éš¾åº¦** | **å“åº”é€Ÿåº¦** | **ç³»ç»Ÿè´Ÿè½½** | **é€‚ç”¨åœºæ™¯** |
|------|-------------|-------------|-------------|-------------|
| **å®šæ—¶åˆ·æ–°** | `ç®€å•` | `æ…¢ï¼ˆåˆ†é’Ÿçº§ï¼‰` | `ä½` | `æƒé™å˜æ›´è¾ƒå°‘` |
| **æ¶ˆæ¯é€šçŸ¥** | `ä¸­ç­‰` | `å¿«ï¼ˆç§’çº§ï¼‰` | `ä¸­` | `ä¸€èˆ¬ä¸šåŠ¡åœºæ™¯` |
| **å®æ—¶æ¨é€** | `å¤æ‚` | `å¾ˆå¿«ï¼ˆæ¯«ç§’çº§ï¼‰` | `é«˜` | `é«˜å®‰å…¨è¦æ±‚` |

**æ¨èæ–¹æ¡ˆï¼šRedis + æ¶ˆæ¯é˜Ÿåˆ—**
```
æƒé™å˜æ›´æµç¨‹ï¼š
ç®¡ç†å‘˜ä¿®æ”¹æƒé™ â†’ æ›´æ–°æ•°æ®åº“ â†’ å‘é€MQæ¶ˆæ¯ â†’ åº”ç”¨æœåŠ¡å™¨æ¥æ”¶ â†’ åˆ·æ–°ç¼“å­˜
```

**æ¶æ„å›¾**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç®¡ç†åå°   â”‚â”€â”€â”€â†’â”‚  æƒé™ä¸­å¿ƒ   â”‚â”€â”€â”€â†’â”‚  æ¶ˆæ¯é˜Ÿåˆ—   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚                  â”‚
                          â†“                  â†“
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚ æ•°æ®åº“æ›´æ–°  â”‚    â”‚  å¹¿æ’­æ¶ˆæ¯   â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                                             â†“
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚          å„åº”ç”¨æœåŠ¡å™¨             â”‚
                   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
                   â”‚  â”‚ Redis   â”‚  â”‚ Redis   â”‚ ....  â”‚
                   â”‚  â”‚ ç¼“å­˜    â”‚  â”‚ ç¼“å­˜    â”‚       â”‚
                   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 ä»£ç å®ç°


**æƒé™å˜æ›´é€šçŸ¥**
```java
@Service
public class PermissionChangeService {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    // æƒé™å˜æ›´åå‘é€é€šçŸ¥
    @Transactional
    public void updateUserPermission(Long userId, List<String> permissions) {
        // 1. æ›´æ–°æ•°æ®åº“
        permissionMapper.updateUserPermissions(userId, permissions);
        
        // 2. å‘é€æƒé™å˜æ›´æ¶ˆæ¯
        PermissionChangeEvent event = new PermissionChangeEvent();
        event.setUserId(userId);
        event.setPermissions(permissions);
        event.setTimestamp(System.currentTimeMillis());
        
        rabbitTemplate.convertAndSend("permission.change", event);
    }
}
```

**æƒé™ç¼“å­˜åˆ·æ–°**
```java
@Component
@RabbitListener(queues = "permission.change")
public class PermissionChangeListener {
    
    @Autowired
    private RedisTemplate redisTemplate;
    
    // æ¥æ”¶æƒé™å˜æ›´æ¶ˆæ¯ï¼Œåˆ·æ–°ç¼“å­˜
    public void handlePermissionChange(PermissionChangeEvent event) {
        String cacheKey = "user:permissions:" + event.getUserId();
        
        // åˆ é™¤æ—§ç¼“å­˜
        redisTemplate.delete(cacheKey);
        
        // å¯é€‰ï¼šé¢„çƒ­æ–°ç¼“å­˜
        List<String> permissions = permissionService.getUserPermissions(event.getUserId());
        redisTemplate.opsForValue().set(cacheKey, permissions, Duration.ofHours(1));
        
        log.info("ç”¨æˆ·{}æƒé™ç¼“å­˜å·²åˆ·æ–°", event.getUserId());
    }
}
```

**æƒé™æ£€æŸ¥æ—¶çš„ç¼“å­˜ç­–ç•¥**
```java
@Service
public class PermissionService {
    
    public boolean hasPermission(Long userId, String permission) {
        String cacheKey = "user:permissions:" + userId;
        
        // å…ˆæŸ¥ç¼“å­˜
        List<String> permissions = (List<String>) redisTemplate.opsForValue().get(cacheKey);
        
        if (permissions == null) {
            // ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥æ•°æ®åº“
            permissions = permissionMapper.getUserPermissions(userId);
            redisTemplate.opsForValue().set(cacheKey, permissions, Duration.ofMinutes(30));
        }
        
        return permissions.contains(permission);
    }
}
```

---

## 5. ğŸ“‹ å®¡è®¡æ—¥å¿—è®°å½•æƒé™å˜æ›´


### 5.1 ä¸ºä»€ä¹ˆéœ€è¦å®¡è®¡æ—¥å¿—


**ğŸ” å®¡è®¡æ—¥å¿—çš„é‡è¦æ€§**
```
åˆè§„è¦æ±‚ï¼š
- é‡‘èã€åŒ»ç–—ç­‰è¡Œä¸šæ³•è§„è¦æ±‚
- å¿…é¡»è®°å½•æ‰€æœ‰æƒé™å˜æ›´æ“ä½œ

å®‰å…¨è¿½è¸ªï¼š
- å‘ç°æƒé™è¢«è¯¯ç”¨æ—¶ï¼Œèƒ½è¿½æŸ¥åŸå› 
- è¯†åˆ«å¼‚å¸¸çš„æƒé™å˜æ›´æ¨¡å¼

è´£ä»»è¿½ç©¶ï¼š
- æ˜ç¡®æ¯æ¬¡æƒé™å˜æ›´çš„æ“ä½œäºº
- ä¸ºå®‰å…¨äº‹ä»¶æä¾›è¯æ®é“¾
```

**å®é™…åœºæ™¯ä¸¾ä¾‹**
```
ğŸ¦ é“¶è¡Œç³»ç»Ÿï¼š
"ä¸ºä»€ä¹ˆå¼ ä¸‰èƒ½çœ‹åˆ°å®¢æˆ·Açš„è´¦æˆ·ä¿¡æ¯ï¼Ÿ"
â†’ æŸ¥å®¡è®¡æ—¥å¿—å‘ç°ï¼šæå››åœ¨æ˜¨å¤©ç»™å¼ ä¸‰ä¸´æ—¶æˆäºˆäº†æŸ¥è¯¢æƒé™

ğŸ¥ åŒ»é™¢ç³»ç»Ÿï¼š  
"è°æ³„éœ²äº†ç—…äººéšç§ä¿¡æ¯ï¼Ÿ"
â†’ æŸ¥å®¡è®¡æ—¥å¿—å‘ç°ï¼šæŸåŒ»ç”Ÿæƒé™è¢«å¼‚å¸¸æå‡ï¼Œéœ€è¦è°ƒæŸ¥

ğŸ¢ ä¼ä¸šç³»ç»Ÿï¼š
"è´¢åŠ¡æ•°æ®æ€ä¹ˆè¢«éè´¢åŠ¡äººå‘˜çœ‹åˆ°äº†ï¼Ÿ"
â†’ æŸ¥å®¡è®¡æ—¥å¿—å‘ç°ï¼šæƒé™é…ç½®é”™è¯¯ï¼Œéœ€è¦ç´§æ€¥ä¿®å¤
```

### 5.2 å®¡è®¡æ—¥å¿—çš„å†…å®¹è®¾è®¡


**ğŸ“ å¿…é¡»è®°å½•çš„ä¿¡æ¯**
```sql
CREATE TABLE permission_audit_log (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    operation_type VARCHAR(50),      -- æ“ä½œç±»å‹ï¼šGRANTã€REVOKEã€MODIFY
    target_user_id BIGINT,           -- è¢«æ“ä½œç”¨æˆ·
    target_username VARCHAR(100),    -- è¢«æ“ä½œç”¨æˆ·å
    permission_before TEXT,          -- å˜æ›´å‰æƒé™
    permission_after TEXT,           -- å˜æ›´åæƒé™
    operator_id BIGINT,             -- æ“ä½œäººID
    operator_username VARCHAR(100), -- æ“ä½œäººç”¨æˆ·å
    operation_reason VARCHAR(500),  -- æ“ä½œåŸå› 
    ip_address VARCHAR(45),         -- æ“ä½œIP
    user_agent TEXT,                -- æµè§ˆå™¨ä¿¡æ¯
    tenant_id VARCHAR(50),          -- ç§Ÿæˆ·ID
    operation_time DATETIME,        -- æ“ä½œæ—¶é—´
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 5.3 å®¡è®¡æ—¥å¿—å®ç°


**AOPåˆ‡é¢è®°å½•æ—¥å¿—**
```java
@Aspect
@Component
public class PermissionAuditAspect {
    
    @Autowired
    private AuditLogService auditLogService;
    
    // æ‹¦æˆªæ‰€æœ‰æƒé™å˜æ›´æ“ä½œ
    @Around("@annotation(PermissionAudit)")
    public Object auditPermissionChange(ProceedingJoinPoint joinPoint) throws Throwable {
        
        PermissionAudit annotation = getAnnotation(joinPoint);
        
        // è®°å½•æ“ä½œå‰çŠ¶æ€
        Object[] args = joinPoint.getArgs();
        Long targetUserId = (Long) args[0];
        List<String> beforePermissions = getCurrentPermissions(targetUserId);
        
        Object result;
        try {
            // æ‰§è¡Œå®é™…æ“ä½œ
            result = joinPoint.proceed();
            
            // è®°å½•æ“ä½œåçŠ¶æ€
            List<String> afterPermissions = getCurrentPermissions(targetUserId);
            
            // å†™å…¥å®¡è®¡æ—¥å¿—
            auditLogService.recordPermissionChange(
                annotation.operation(),
                targetUserId,
                beforePermissions,
                afterPermissions,
                getCurrentUser(),
                getClientInfo()
            );
            
        } catch (Exception e) {
            // è®°å½•æ“ä½œå¤±è´¥
            auditLogService.recordFailedOperation(
                annotation.operation(),
                targetUserId,
                getCurrentUser(),
                e.getMessage()
            );
            throw e;
        }
        
        return result;
    }
}
```

**ä½¿ç”¨å®¡è®¡æ³¨è§£**
```java
@Service
public class PermissionManageService {
    
    @PermissionAudit(operation = "GRANT_ROLE")
    public void grantRoleToUser(Long userId, Long roleId, String reason) {
        // æˆäºˆè§’è‰²
        userRoleMapper.addUserRole(userId, roleId);
    }
    
    @PermissionAudit(operation = "REVOKE_PERMISSION")  
    public void revokePermission(Long userId, String permission, String reason) {
        // æ’¤é”€æƒé™
        permissionMapper.revokeUserPermission(userId, permission);
    }
}
```

### 5.4 å®¡è®¡æ—¥å¿—æŸ¥è¯¢ä¸åˆ†æ


**å¸¸ç”¨æŸ¥è¯¢åœºæ™¯**
```java
@Service
public class AuditLogQueryService {
    
    // æŸ¥è¯¢ç”¨æˆ·æƒé™å˜æ›´å†å²
    public List<AuditLog> getUserPermissionHistory(Long userId, Date startTime, Date endTime) {
        return auditLogMapper.findByUserAndTimeRange(userId, startTime, endTime);
    }
    
    // æŸ¥è¯¢æŸä¸ªæƒé™çš„æ‰€æœ‰å˜æ›´è®°å½•
    public List<AuditLog> getPermissionChangeHistory(String permission) {
        return auditLogMapper.findByPermissionChange(permission);
    }
    
    // æŸ¥è¯¢å¼‚å¸¸æ“ä½œï¼ˆå¦‚æ·±å¤œæƒé™å˜æ›´ï¼‰
    public List<AuditLog> findSuspiciousOperations() {
        LocalTime nightStart = LocalTime.of(22, 0);  // æ™šä¸Š10ç‚¹
        LocalTime nightEnd = LocalTime.of(6, 0);     // æ—©ä¸Š6ç‚¹
        
        return auditLogMapper.findOperationsByTimeRange(nightStart, nightEnd);
    }
}
```

**æƒé™å˜æ›´æŠ¥è¡¨**
```java
// ç”Ÿæˆæƒé™å˜æ›´ç»Ÿè®¡æŠ¥è¡¨
@Service
public class PermissionReportService {
    
    public PermissionChangeReport generateMonthlyReport() {
        LocalDate startOfMonth = LocalDate.now().withDayOfMonth(1);
        LocalDate endOfMonth = startOfMonth.plusMonths(1);
        
        return PermissionChangeReport.builder()
            .totalChanges(auditLogMapper.countByTimeRange(startOfMonth, endOfMonth))
            .grantOperations(auditLogMapper.countByTypeAndTime("GRANT", startOfMonth, endOfMonth))
            .revokeOperations(auditLogMapper.countByTypeAndTime("REVOKE", startOfMonth, endOfMonth))
            .topOperators(auditLogMapper.findTopOperators(startOfMonth, endOfMonth))
            .suspiciousOperations(findSuspiciousOperations())
            .build();
    }
}
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ ä¸´æ—¶æˆæƒï¼šæœ‰æ—¶é—´é™åˆ¶çš„æƒé™åˆ†é…ï¼Œè‡ªåŠ¨è¿‡æœŸå›æ”¶
ğŸ”¸ åŠ¨æ€æƒé™ï¼šæ ¹æ®å®æ—¶æƒ…å†µè‡ªåŠ¨è°ƒæ•´ç”¨æˆ·æƒé™  
ğŸ”¸ RBAC + ABACï¼šç»“åˆè§’è‰²å’Œå±æ€§çš„æ··åˆæƒé™æ§åˆ¶æ¨¡å¼
ğŸ”¸ å¤šç§Ÿæˆ·éš”ç¦»ï¼šç¡®ä¿ä¸åŒç§Ÿæˆ·çš„æƒé™æ•°æ®å®Œå…¨éš”ç¦»
ğŸ”¸ å³æ—¶ç”Ÿæ•ˆï¼šæƒé™å˜æ›´åç«‹å³åœ¨æ•´ä¸ªç³»ç»Ÿä¸­ç”Ÿæ•ˆ
ğŸ”¸ å®¡è®¡æ—¥å¿—ï¼šå®Œæ•´è®°å½•æ‰€æœ‰æƒé™å˜æ›´æ“ä½œï¼Œæ”¯æŒè¿½æº¯
```

### 6.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸´æ—¶æˆæƒçš„æ ¸å¿ƒä»·å€¼**
```
è§£å†³é—®é¢˜ï¼š
- é¿å…ä¸ºä¸´æ—¶éœ€æ±‚åˆ›å»ºæ°¸ä¹…è§’è‰²
- å‡å°‘æƒé™ç®¡ç†çš„å¤æ‚åº¦
- æé«˜ç³»ç»Ÿå®‰å…¨æ€§ï¼ˆè‡ªåŠ¨å›æ”¶ï¼‰

å®ç°å…³é”®ï¼š
- æ˜ç¡®çš„æ—¶é—´è¾¹ç•Œ
- è‡ªåŠ¨åŒ–çš„æƒé™å›æ”¶
- å®Œæ•´çš„æ“ä½œè®°å½•
```

**ğŸ”¹ RBAC + ABAC æ··åˆæ¨¡å¼çš„ä¼˜åŠ¿**
```
æœ€ä½³å®è·µï¼š
- 80%çš„æƒé™ç”¨RBACç®¡ç†ï¼ˆç®€å•é«˜æ•ˆï¼‰
- 20%çš„ç‰¹æ®Šæƒ…å†µç”¨ABACå¤„ç†ï¼ˆçµæ´»ç²¾ç¡®ï¼‰
- ä¸¤è€…ç»“åˆæ—¢ä¿è¯æ˜“ç”¨æ€§åˆæ»¡è¶³å¤æ‚éœ€æ±‚
```

**ğŸ”¹ å¤šç§Ÿæˆ·æƒé™éš”ç¦»çš„é‡ç‚¹**
```
å®‰å…¨ç¬¬ä¸€ï¼š
- æ•°æ®éš”ç¦»æ˜¯åº•çº¿ï¼Œç»ä¸èƒ½ä¸²æˆ·
- æƒé™æ£€æŸ¥å¿…é¡»åŒ…å«ç§Ÿæˆ·ç»´åº¦
- è·¨ç§Ÿæˆ·åä½œéœ€è¦æ˜¾å¼æˆæƒå’Œå®¡æ‰¹
```

### 6.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ æŠ€æœ¯é€‰å‹å»ºè®®**
- **å°å‹ç³»ç»Ÿ**ï¼šåŸºç¡€RBAC + å®šæ—¶æƒé™åˆ·æ–°
- **ä¸­å‹ç³»ç»Ÿ**ï¼šRBAC + å°‘é‡ABAC + Redisç¼“å­˜ + MQé€šçŸ¥
- **å¤§å‹ç³»ç»Ÿ**ï¼šå®Œæ•´çš„æ··åˆæƒé™æ¨¡å‹ + å®æ—¶åŒæ­¥ + å®Œå–„å®¡è®¡

**âš¡ æ€§èƒ½ä¼˜åŒ–è¦ç‚¹**
- æƒé™æ•°æ®ä¼˜å…ˆä½¿ç”¨ç¼“å­˜ï¼Œè®¾ç½®åˆç†è¿‡æœŸæ—¶é—´
- æƒé™å˜æ›´æ¶ˆæ¯é‡‡ç”¨å¼‚æ­¥å¤„ç†ï¼Œé¿å…é˜»å¡ä¸»æµç¨‹
- å®¡è®¡æ—¥å¿—å†™å…¥é‡‡ç”¨æ‰¹é‡æ’å…¥ï¼Œæé«˜æ•°æ®åº“æ•ˆç‡

**ğŸ”’ å®‰å…¨æœ€ä½³å®è·µ**
- æƒé™å˜æ›´å¿…é¡»æœ‰æ“ä½œåŸå› å’Œå®¡æ‰¹æµç¨‹
- æ•æ„Ÿæƒé™çš„å˜æ›´éœ€è¦å‘é€å®æ—¶å‘Šè­¦é€šçŸ¥
- å®šæœŸå®¡æŸ¥ç”¨æˆ·æƒé™ï¼Œæ¸…ç†ä¸å¿…è¦çš„æƒé™æˆäºˆ

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- ä¸´æ—¶æˆæƒæœ‰æœŸé™ï¼Œåˆ°æœŸè‡ªåŠ¨å°±å›æ”¶
- è§’è‰²å±æ€§ç›¸ç»“åˆï¼Œçµæ´»å®‰å…¨ä¸¤ä¸è¯¯  
- å¤šç§Ÿæˆ·é—´è¦éš”ç¦»ï¼Œè·¨æˆ·åä½œéœ€å®¡æ‰¹
- æƒé™å˜æ›´å³æ—¶ç”Ÿæ•ˆï¼Œå®¡è®¡æ—¥å¿—ä¸èƒ½å°‘