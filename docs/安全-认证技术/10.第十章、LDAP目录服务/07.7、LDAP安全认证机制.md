---
title: 7ã€LDAPå®‰å…¨è®¤è¯æœºåˆ¶
---
## ğŸ“š ç›®å½•

1. [LDAPå®‰å…¨è®¤è¯æ¦‚è¿°](#1-ldapå®‰å…¨è®¤è¯æ¦‚è¿°)
2. [ç»‘å®šæ–¹å¼è¯¦è§£](#2-ç»‘å®šæ–¹å¼è¯¦è§£)
3. [è®¿é—®æ§åˆ¶åˆ—è¡¨ACL](#3-è®¿é—®æ§åˆ¶åˆ—è¡¨acl)
4. [åŠ å¯†ä¼ è¾“æœºåˆ¶](#4-åŠ å¯†ä¼ è¾“æœºåˆ¶)
5. [å¼€å‘è€…å®‰å…¨å®è·µ](#5-å¼€å‘è€…å®‰å…¨å®è·µ)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” LDAPå®‰å…¨è®¤è¯æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯LDAPå®‰å…¨è®¤è¯


**ğŸ’¡ é€šä¿—ç†è§£**ï¼š
æƒ³è±¡ä½ è¦è¿›å…¥ä¸€æ ‹åŠå…¬æ¥¼ï¼Œä½ éœ€è¦ï¼š
- è¯æ˜ä½ æ˜¯è°ï¼ˆèº«ä»½è®¤è¯ï¼‰
- è¯æ˜ä½ èƒ½è¿›å…¥å“ªäº›æˆ¿é—´ï¼ˆæƒé™æ§åˆ¶ï¼‰
- ç¡®ä¿ä½ çš„é€šè¯ä¸è¢«å·å¬ï¼ˆåŠ å¯†ä¼ è¾“ï¼‰

LDAPå®‰å…¨è®¤è¯å°±æ˜¯è¿™æ ·çš„é—¨å«ç³»ç»Ÿï¼Œä¿æŠ¤ç›®å½•æœåŠ¡çš„æ•°æ®å®‰å…¨ã€‚

```
æ™®é€šé—¨é”ç³»ç»Ÿï¼š           LDAPå®‰å…¨ç³»ç»Ÿï¼š
      é—¨å¡                    ç”¨æˆ·å‡­è¯
       â†“                        â†“
     åˆ·å¡å™¨                   LDAPç»‘å®š
       â†“                        â†“
    æƒé™æ£€æŸ¥                  ACLæƒé™æ£€æŸ¥
       â†“                        â†“
     å¼€é—¨/æ‹’ç»                 å…è®¸/æ‹’ç»è®¿é—®
```

### 1.2 LDAPå®‰å…¨çš„æ ¸å¿ƒè¦ç´ 


**ğŸ”¸ ä¸‰å¤§å®‰å…¨æ”¯æŸ±**ï¼š
```
ğŸ” èº«ä»½è®¤è¯ï¼ˆAuthenticationï¼‰
   â”œâ”€ åŒ¿åç»‘å®šï¼šä¸éªŒè¯èº«ä»½ï¼Œç±»ä¼¼æ¸¸å®¢å‚è§‚
   â”œâ”€ ç®€å•ç»‘å®šï¼šç”¨æˆ·åå¯†ç ï¼Œç±»ä¼¼é—¨ç¦å¡
   â””â”€ SASLç»‘å®šï¼šé«˜çº§è®¤è¯ï¼Œç±»ä¼¼æŒ‡çº¹+å¯†ç 

ğŸ›¡ï¸ æƒé™æ§åˆ¶ï¼ˆAuthorizationï¼‰
   â”œâ”€ ACLè®¿é—®æ§åˆ¶ï¼šè°èƒ½çœ‹ä»€ä¹ˆã€åšä»€ä¹ˆ
   â”œâ”€ ç”¨æˆ·çº§æƒé™ï¼šåŸºäºå…·ä½“ç”¨æˆ·
   â””â”€ ç»„çº§æƒé™ï¼šåŸºäºç”¨æˆ·ç»„

ğŸ”’ æ•°æ®åŠ å¯†ï¼ˆEncryptionï¼‰
   â”œâ”€ TLS/SSLï¼šä¼ è¾“è¿‡ç¨‹åŠ å¯†
   â””â”€ StartTLSï¼šå‡çº§ç°æœ‰è¿æ¥ä¸ºåŠ å¯†
```

### 1.3 ä¸ºä»€ä¹ˆéœ€è¦LDAPå®‰å…¨è®¤è¯


**ğŸš¨ ä¸å®‰å…¨çš„åæœ**ï¼š
```
âŒ æ•°æ®æ³„éœ²é£é™©ï¼š
   æ•æ„Ÿçš„ç”¨æˆ·ä¿¡æ¯ã€ç»„ç»‡æ¶æ„è¢«çªƒå–

âŒ è¶Šæƒè®¿é—®ï¼š
   æ™®é€šç”¨æˆ·è·å–ç®¡ç†å‘˜æƒé™

âŒ ä¸­é—´äººæ”»å‡»ï¼š
   å¯†ç åœ¨ä¼ è¾“ä¸­è¢«æˆªè·

âŒ æ‹’ç»æœåŠ¡ï¼š
   æ¶æ„è¯·æ±‚å¯¼è‡´æœåŠ¡å´©æºƒ
```

---

## 2. ğŸ”— ç»‘å®šæ–¹å¼è¯¦è§£


### 2.1 åŒ¿åç»‘å®š vs è®¤è¯ç»‘å®š


#### ğŸ”¸ åŒ¿åç»‘å®šï¼ˆAnonymous Bindï¼‰


**ğŸ’¡ ä»€ä¹ˆæ˜¯åŒ¿åç»‘å®š**ï¼š
å°±åƒè¿›å…¥å…¬å…±å›¾ä¹¦é¦†ï¼Œä¸éœ€è¦è¯æ˜èº«ä»½ï¼Œä»»ä½•äººéƒ½èƒ½è¿›å…¥ï¼Œä½†åªèƒ½çœ‹åˆ°å…¬å¼€çš„ä¹¦ç±ã€‚

```java
// åŒ¿åç»‘å®šç¤ºä¾‹
public class AnonymousBind {
    public void connectAnonymously() {
        LdapContext ctx = null;
        try {
            Hashtable<String, String> env = new Hashtable<>();
            env.put(Context.INITIAL_CONTEXT_FACTORY, "com.sun.jndi.ldap.LdapCtxFactory");
            env.put(Context.PROVIDER_URL, "ldap://localhost:389");
            // ä¸è®¾ç½®ç”¨æˆ·åå’Œå¯†ç  = åŒ¿åç»‘å®š
            
            ctx = new InitialLdapContext(env, null);
            System.out.println("åŒ¿åè¿æ¥æˆåŠŸ");
            
            // åªèƒ½è®¿é—®å…è®¸åŒ¿åè®¿é—®çš„æ•°æ®
            searchPublicInfo(ctx);
            
        } catch (Exception e) {
            System.out.println("è¿æ¥å¤±è´¥ï¼š" + e.getMessage());
        }
    }
}
```

**ğŸ“Š åŒ¿åç»‘å®šç‰¹ç‚¹**ï¼š

| ç‰¹å¾ | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|------|------|----------|
| **å®‰å…¨æ€§** | `â­â˜†â˜†â˜†â˜†` | å…¬å¼€ä¿¡æ¯æŸ¥è¯¢ |
| **æƒé™** | `åªè¯»ï¼Œä¸”èŒƒå›´æœ‰é™` | ä¼ä¸šé»„é¡µã€å…¬å‘Š |
| **æ€§èƒ½** | `âš¡âš¡âš¡âš¡âš¡` | æ— éœ€è®¤è¯å¼€é”€ |
| **é…ç½®** | `ğŸ”§ ç®€å•` | é»˜è®¤é…ç½®å³å¯ |

#### ğŸ”¸ è®¤è¯ç»‘å®šï¼ˆAuthenticated Bindï¼‰


**ğŸ’¡ ä»€ä¹ˆæ˜¯è®¤è¯ç»‘å®š**ï¼š
å°±åƒè¿›å…¥é“¶è¡Œï¼Œå¿…é¡»å‡ºç¤ºèº«ä»½è¯ã€éªŒè¯å¯†ç ï¼Œèº«ä»½ç¡®è®¤åæ‰èƒ½è®¿é—®ä½ çš„è´¦æˆ·ä¿¡æ¯ã€‚

```java
// è®¤è¯ç»‘å®šç¤ºä¾‹
public class AuthenticatedBind {
    public void connectWithAuth() {
        try {
            Hashtable<String, String> env = new Hashtable<>();
            env.put(Context.INITIAL_CONTEXT_FACTORY, "com.sun.jndi.ldap.LdapCtxFactory");
            env.put(Context.PROVIDER_URL, "ldap://localhost:389");
            
            // ğŸ” è®¾ç½®è®¤è¯ä¿¡æ¯
            env.put(Context.SECURITY_AUTHENTICATION, "simple");
            env.put(Context.SECURITY_PRINCIPAL, "cn=admin,dc=company,dc=com");
            env.put(Context.SECURITY_CREDENTIALS, "admin123");
            
            LdapContext ctx = new InitialLdapContext(env, null);
            System.out.println("è®¤è¯ç»‘å®šæˆåŠŸ");
            
            // å¯ä»¥è®¿é—®æ›´å¤šå—ä¿æŠ¤çš„æ•°æ®
            searchProtectedInfo(ctx);
            
        } catch (Exception e) {
            System.out.println("è®¤è¯å¤±è´¥ï¼š" + e.getMessage());
        }
    }
}
```

### 2.2 ç®€å•ç»‘å®šï¼ˆSimple Bindï¼‰


**ğŸ’¡ é€šä¿—ç†è§£**ï¼š
ç®€å•ç»‘å®šå°±åƒç”¨ç”¨æˆ·å+å¯†ç ç™»å½•ç½‘ç«™ï¼Œæ˜¯æœ€å¸¸è§çš„è®¤è¯æ–¹å¼ã€‚

#### ğŸ”¸ å·¥ä½œæµç¨‹

```
å®¢æˆ·ç«¯è¯·æ±‚æµç¨‹ï¼š
   ç”¨æˆ·è¾“å…¥         LDAPæœåŠ¡å™¨          éªŒè¯ç»“æœ
      â†“                  â†“                â†“
  ç”¨æˆ·å+å¯†ç     â†’   æŸ¥æ‰¾ç”¨æˆ·è®°å½•   â†’   å¯†ç åŒ¹é…ï¼Ÿ
      â†“                  â†“                â†“
   å‘é€è®¤è¯è¯·æ±‚    â†’   éªŒè¯å‡­è¯      â†’   è¿”å›æˆåŠŸ/å¤±è´¥
```

#### ğŸ”¸ ä»£ç å®ç°

```java
public class SimpleBind {
    public boolean authenticate(String username, String password) {
        try {
            Hashtable<String, String> env = new Hashtable<>();
            env.put(Context.INITIAL_CONTEXT_FACTORY, "com.sun.jndi.ldap.LdapCtxFactory");
            env.put(Context.PROVIDER_URL, "ldap://localhost:389");
            
            // ğŸ”‘ ç®€å•ç»‘å®šé…ç½®
            env.put(Context.SECURITY_AUTHENTICATION, "simple");
            env.put(Context.SECURITY_PRINCIPAL, username);
            env.put(Context.SECURITY_CREDENTIALS, password);
            
            new InitialDirContext(env);
            return true; // è®¤è¯æˆåŠŸ
            
        } catch (AuthenticationException e) {
            return false; // ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯
        } catch (Exception e) {
            throw new RuntimeException("LDAPè¿æ¥å¤±è´¥", e);
        }
    }
}
```

**âš ï¸ ç®€å•ç»‘å®šçš„å®‰å…¨é£é™©**ï¼š
```
ğŸš¨ å®‰å…¨é—®é¢˜ï¼š
â”œâ”€ å¯†ç æ˜æ–‡ä¼ è¾“ï¼ˆæœªåŠ å¯†æ—¶ï¼‰
â”œâ”€ å®¹æ˜“è¢«ä¸­é—´äººæ”»å‡»
â”œâ”€ å¯†ç å¯èƒ½è¢«ç½‘ç»œå—…æ¢å·¥å…·æ•è·
â””â”€ ä¸æ”¯æŒé«˜çº§è®¤è¯ç‰¹æ€§

ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼š
â”œâ”€ å¿…é¡»é…åˆTLS/SSLä½¿ç”¨
â”œâ”€ å®æ–½å¯†ç ç­–ç•¥ï¼ˆå¤æ‚åº¦ã€è¿‡æœŸï¼‰
â””â”€ è€ƒè™‘å‡çº§åˆ°SASLç»‘å®š
```

### 2.3 SASLç»‘å®šï¼ˆé«˜çº§è®¤è¯ï¼‰


**ğŸ’¡ ä»€ä¹ˆæ˜¯SASL**ï¼š
SASLï¼ˆSimple Authentication and Security Layerï¼‰ç®€å•è®¤è¯ä¸å®‰å…¨å±‚ï¼Œå°±åƒé“¶è¡Œçš„å¤šé‡éªŒè¯ï¼šä¸ä»…è¦å¯†ç ï¼Œè¿˜è¦çŸ­ä¿¡éªŒè¯ç ã€æŒ‡çº¹ç­‰ã€‚

#### ğŸ”¸ SASLæ”¯æŒçš„è®¤è¯æœºåˆ¶

```
ğŸ” SASLè®¤è¯æœºåˆ¶ï¼š

PLAINï¼š
â”œâ”€ æ˜æ–‡ä¼ è¾“ç”¨æˆ·åå¯†ç 
â””â”€ å¿…é¡»é…åˆTLSä½¿ç”¨

DIGEST-MD5ï¼š
â”œâ”€ å¯†ç ç»è¿‡MD5å“ˆå¸Œå¤„ç†
â”œâ”€ æ”¯æŒè´¨è¯¢-å“åº”æœºåˆ¶
â””â”€ æ¯”ç®€å•ç»‘å®šæ›´å®‰å…¨

GSSAPI (Kerberos)ï¼š
â”œâ”€ åŸºäºç¥¨æ®çš„è®¤è¯
â”œâ”€ æ”¯æŒå•ç‚¹ç™»å½•
â””â”€ ä¼ä¸šçº§å®‰å…¨æ ‡å‡†

EXTERNALï¼š
â”œâ”€ åŸºäºTLSå®¢æˆ·ç«¯è¯ä¹¦
â””â”€ æœ€é«˜å®‰å…¨çº§åˆ«
```

#### ğŸ”¸ SASL DIGEST-MD5 å®ç°

```java
public class SaslBind {
    public void authenticateWithSasl() {
        try {
            Hashtable<String, String> env = new Hashtable<>();
            env.put(Context.INITIAL_CONTEXT_FACTORY, "com.sun.jndi.ldap.LdapCtxFactory");
            env.put(Context.PROVIDER_URL, "ldap://localhost:389");
            
            // ğŸ” SASLè®¤è¯é…ç½®
            env.put(Context.SECURITY_AUTHENTICATION, "DIGEST-MD5");
            env.put(Context.SECURITY_PRINCIPAL, "username");
            env.put(Context.SECURITY_CREDENTIALS, "password");
            
            LdapContext ctx = new InitialLdapContext(env, null);
            System.out.println("SASLè®¤è¯æˆåŠŸ");
            
        } catch (Exception e) {
            System.out.println("SASLè®¤è¯å¤±è´¥ï¼š" + e.getMessage());
        }
    }
}
```

**ğŸ“Š ç»‘å®šæ–¹å¼å¯¹æ¯”**ï¼š

| ç»‘å®šæ–¹å¼ | **å®‰å…¨çº§åˆ«** | **æ€§èƒ½** | **å¤æ‚åº¦** | **é€‚ç”¨åœºæ™¯** |
|----------|-------------|----------|------------|-------------|
| `åŒ¿åç»‘å®š` | â­â˜†â˜†â˜†â˜† | âš¡âš¡âš¡âš¡âš¡ | ğŸ”§ æç®€ | `å…¬å¼€ä¿¡æ¯æŸ¥è¯¢` |
| `ç®€å•ç»‘å®š` | â­â­â˜†â˜†â˜† | âš¡âš¡âš¡âš¡â˜† | ğŸ”§ ç®€å• | `å†…éƒ¨ç³»ç»Ÿè®¤è¯` |
| `SASLç»‘å®š` | â­â­â­â­â­ | âš¡âš¡â­â˜†â˜† | ğŸ”§ğŸ”§ğŸ”§ | `ä¼ä¸šçº§åº”ç”¨` |

---

## 3. ğŸ›¡ï¸ è®¿é—®æ§åˆ¶åˆ—è¡¨ACL


### 3.1 ACLåŸºæœ¬æ¦‚å¿µ


**ğŸ’¡ é€šä¿—ç†è§£**ï¼š
ACLå°±åƒæ˜¯ä¸€ä»½æƒé™æ¸…å•ï¼Œæ˜ç¡®è§„å®š"è°èƒ½å¯¹ä»€ä¹ˆèµ„æºåšä»€ä¹ˆæ“ä½œ"ï¼Œå°±åƒåŠå…¬å®¤çš„é—¨ç¦æƒé™è¡¨ã€‚

```
åŠå…¬å®¤æƒé™è¡¨ï¼š               LDAP ACLï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚å¼ ä¸‰ - æ€»ç»ç†     â”‚         â”‚cn=zhangsan      â”‚
â”‚âœ… æ‰€æœ‰åŠå…¬å®¤     â”‚   â†’     â”‚âœ… dc=company    â”‚
â”‚âœ… æŸ¥çœ‹/ä¿®æ”¹      â”‚         â”‚âœ… read/write    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚æå›› - å‘˜å·¥       â”‚         â”‚cn=lisi          â”‚
â”‚âœ… è‡ªå·±åŠå…¬å®¤     â”‚   â†’     â”‚âœ… ou=staff      â”‚
â”‚âœ… ä»…æŸ¥çœ‹        â”‚         â”‚âœ… read only     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 ACLçš„ç»„æˆè¦ç´ 


**ğŸ”¸ ACLè§„åˆ™ç»“æ„**ï¼š
```
ACLè§„åˆ™ = è°(Who) + ä»€ä¹ˆèµ„æº(What) + ä»€ä¹ˆæƒé™(Permission)

ç¤ºä¾‹ç†è§£ï¼š
Who: cn=admin,dc=company,dc=com     (ç®¡ç†å‘˜ç”¨æˆ·)
What: ou=users,dc=company,dc=com    (ç”¨æˆ·ç»„ç»‡å•å…ƒ)
Permission: read,write,add,delete   (è¯»å†™å¢åˆ æƒé™)
```

#### ğŸ”¸ ä¸»ä½“ï¼ˆWhoï¼‰- è°æœ‰æƒé™

```
ğŸ‘¤ ç”¨æˆ·ä¸»ä½“ï¼š
cn=zhangsan,ou=users,dc=company,dc=com

ğŸ‘¥ ç»„ä¸»ä½“ï¼š
cn=admins,ou=groups,dc=company,dc=com

ğŸŒ åŒ¿åç”¨æˆ·ï¼š
anonymous

ğŸ”“ æ‰€æœ‰è®¤è¯ç”¨æˆ·ï¼š
users
```

#### ğŸ”¸ æƒé™ï¼ˆPermissionï¼‰- èƒ½åšä»€ä¹ˆ

```
ğŸ“– åŸºæœ¬æƒé™ï¼š
â”œâ”€ read (r)ï¼š      è¯»å–å±æ€§å’Œå€¼
â”œâ”€ write (w)ï¼š     ä¿®æ”¹å±æ€§å€¼  
â”œâ”€ add (a)ï¼š       æ·»åŠ æ–°æ¡ç›®
â”œâ”€ delete (d)ï¼š    åˆ é™¤æ¡ç›®
â”œâ”€ search (s)ï¼š    æœç´¢æ¡ç›®
â””â”€ compare (c)ï¼š   æ¯”è¾ƒå±æ€§å€¼

ğŸ¯ ç»„åˆæƒé™ï¼š
â”œâ”€ rwxï¼š          è¯»å†™æ‰§è¡Œï¼ˆå¸¸ç”¨ç»„åˆï¼‰
â”œâ”€ rï¼š            åªè¯»æƒé™
â””â”€ noneï¼š         æ— æƒé™
```

### 3.3 åŸºäºç”¨æˆ·çš„è®¿é—®é™åˆ¶


**ğŸ’¡ å®é™…åœºæ™¯**ï¼š
å…¬å¸HRåªèƒ½è®¿é—®å‘˜å·¥çš„è”ç³»ä¿¡æ¯ï¼Œä¸èƒ½çœ‹è–ªèµ„ä¿¡æ¯ï¼›è´¢åŠ¡äººå‘˜å¯ä»¥çœ‹è–ªèµ„ä½†ä¸èƒ½ä¿®æ”¹ä¸ªäººä¿¡æ¯ã€‚

#### ğŸ”¸ OpenLDAP ACLé…ç½®

```bash
# OpenLDAP slapd.conf é…ç½®ç¤ºä¾‹

# ğŸ” ç”¨æˆ·æƒé™é…ç½®
# ç®¡ç†å‘˜æ‹¥æœ‰æ‰€æœ‰æƒé™
access to *
    by dn="cn=admin,dc=company,dc=com" write
    by * none

# HRäººå‘˜åªèƒ½è¯»å–åŸºæœ¬ä¿¡æ¯
access to dn.subtree="ou=employees,dc=company,dc=com"
    attrs=cn,mail,telephoneNumber
    by dn="cn=hr-manager,ou=users,dc=company,dc=com" read
    by group="cn=hr-staff,ou=groups,dc=company,dc=com" read
    by * none

# ç”¨æˆ·åªèƒ½ä¿®æ”¹è‡ªå·±çš„ä¿¡æ¯
access to dn.subtree="ou=employees,dc=company,dc=com"
    attrs=userPassword,mail
    by self write
    by * none
```

#### ğŸ”¸ Javaä»£ç éªŒè¯æƒé™

```java
public class UserPermissionCheck {
    public boolean canUserAccessData(String userDN, String targetDN, String operation) {
        try {
            // ğŸ” æ¨¡æ‹Ÿæƒé™æ£€æŸ¥é€»è¾‘
            LdapContext ctx = getAuthenticatedContext(userDN);
            
            if (operation.equals("read")) {
                // å°è¯•è¯»å–ç›®æ ‡æ¡ç›®
                Attributes attrs = ctx.getAttributes(targetDN, new String[]{"cn"});
                return attrs != null;
                
            } else if (operation.equals("write")) {
                // å°è¯•ä¿®æ”¹ç›®æ ‡æ¡ç›®
                ModificationItem[] mods = {
                    new ModificationItem(DirContext.REPLACE_ATTRIBUTE, 
                        new BasicAttribute("description", "test"))
                };
                ctx.modifyAttributes(targetDN, mods);
                return true;
            }
            
        } catch (NoPermissionException e) {
            return false; // æ— æƒé™
        } catch (Exception e) {
            throw new RuntimeException("æƒé™æ£€æŸ¥å¤±è´¥", e);
        }
        
        return false;
    }
}
```

### 3.4 åŸºäºç»„çš„è®¿é—®é™åˆ¶


**ğŸ’¡ é€šä¿—ç†è§£**ï¼š
å°±åƒå¾®ä¿¡ç¾¤æƒé™ï¼Œç¾¤ä¸»èƒ½ç®¡ç†æ‰€æœ‰äººï¼Œç®¡ç†å‘˜èƒ½è¸¢äººä½†ä¸èƒ½è§£æ•£ç¾¤ï¼Œæ™®é€šæˆå‘˜åªèƒ½èŠå¤©ã€‚

#### ğŸ”¸ ç»„æƒé™é…ç½®ç¤ºä¾‹

```bash
# åŸºäºç»„çš„ACLé…ç½®

# ç®¡ç†å‘˜ç»„æ‹¥æœ‰å®Œå…¨æƒé™
access to dn.subtree="dc=company,dc=com"
    by group.exact="cn=administrators,ou=groups,dc=company,dc=com" write
    by * none

# å¼€å‘ç»„åªèƒ½è®¿é—®å¼€å‘ç›¸å…³æ•°æ®
access to dn.subtree="ou=development,dc=company,dc=com"
    by group="cn=developers,ou=groups,dc=company,dc=com" write
    by group="cn=testers,ou=groups,dc=company,dc=com" read
    by * none

# æ‰€æœ‰å‘˜å·¥å¯ä»¥è¯»å–å…¬å¸é€šè®¯å½•
access to dn.subtree="ou=phonebook,dc=company,dc=com"
    by group="cn=employees,ou=groups,dc=company,dc=com" read
    by * none
```

#### ğŸ”¸ åŠ¨æ€ç»„æƒé™æ£€æŸ¥

```java
public class GroupPermissionManager {
    
    public boolean checkGroupPermission(String userDN, String groupDN, String resource) {
        try {
            // ğŸ” æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å±äºæŒ‡å®šç»„
            if (!isUserInGroup(userDN, groupDN)) {
                return false;
            }
            
            // ğŸ›¡ï¸ è·å–ç»„æƒé™é…ç½®
            GroupPermissions permissions = getGroupPermissions(groupDN);
            
            // âœ… éªŒè¯èµ„æºè®¿é—®æƒé™
            return permissions.hasAccessTo(resource);
            
        } catch (Exception e) {
            System.out.println("æƒé™æ£€æŸ¥å¼‚å¸¸ï¼š" + e.getMessage());
            return false;
        }
    }
    
    private boolean isUserInGroup(String userDN, String groupDN) {
        try {
            LdapContext ctx = getContext();
            Attributes attrs = ctx.getAttributes(groupDN, new String[]{"member"});
            Attribute memberAttr = attrs.get("member");
            
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨æˆå‘˜åˆ—è¡¨ä¸­
            for (int i = 0; i < memberAttr.size(); i++) {
                if (userDN.equals(memberAttr.get(i))) {
                    return true;
                }
            }
            return false;
            
        } catch (Exception e) {
            return false;
        }
    }
}
```

**ğŸ“Š ç»„æƒé™ç®¡ç†æœ€ä½³å®è·µ**ï¼š

```
ğŸ¯ æƒé™è®¾è®¡åŸåˆ™ï¼š

æœ€å°æƒé™åŸåˆ™ï¼š
â”œâ”€ é»˜è®¤æ— æƒé™
â”œâ”€ åªç»™å¿…éœ€çš„æƒé™
â””â”€ å®šæœŸå®¡æ ¸æƒé™

èŒè´£åˆ†ç¦»ï¼š
â”œâ”€ ä¸åŒç»„è´Ÿè´£ä¸åŒèµ„æº
â”œâ”€ ç®¡ç†æƒé™ä¸ä½¿ç”¨æƒé™åˆ†ç¦»
â””â”€ é¿å…æƒé™è¿‡åº¦é›†ä¸­

æƒé™ç»§æ‰¿ï¼š
â”œâ”€ å­ç»„ç»‡ç»§æ‰¿çˆ¶ç»„ç»‡æƒé™
â”œâ”€ ç”¨æˆ·ç»§æ‰¿æ‰€å±ç»„æƒé™
â””â”€ æ˜ç¡®ç»§æ‰¿è§„åˆ™
```

---

## 4. ğŸ”’ åŠ å¯†ä¼ è¾“æœºåˆ¶


### 4.1 ä¸ºä»€ä¹ˆéœ€è¦åŠ å¯†ä¼ è¾“


**ğŸ’¡ é€šä¿—æ¯”å–»**ï¼š
ä¸åŠ å¯†çš„LDAPä¼ è¾“å°±åƒåœ¨æ˜ä¿¡ç‰‡ä¸Šå†™å¯†ç ï¼Œé‚®é€’å‘˜ã€åˆ†æ‹£å‘˜éƒ½èƒ½çœ‹åˆ°ä½ çš„ç§˜å¯†ã€‚åŠ å¯†ä¼ è¾“å°±åƒç”¨ä¿é™©ç®±å¯„é€é‡è¦æ–‡ä»¶ã€‚

**ğŸš¨ ä¸åŠ å¯†çš„é£é™©**ï¼š
```
ç½‘ç»œå—…æ¢æ”»å‡»ï¼š
é»‘å®¢åœ¨ç½‘ç»œä¸­ç›‘å¬æ•°æ®åŒ… â†’ æˆªè·ç”¨æˆ·åå¯†ç  â†’ å†’å……ç”¨æˆ·èº«ä»½

ä¸­é—´äººæ”»å‡»ï¼š
é»‘å®¢ä¼ªè£…æˆLDAPæœåŠ¡å™¨ â†’ ç”¨æˆ·è¿æ¥åˆ°å‡æœåŠ¡å™¨ â†’ çªƒå–è®¤è¯ä¿¡æ¯

æ•°æ®ç¯¡æ”¹ï¼š
é»‘å®¢ä¿®æ”¹ä¼ è¾“ä¸­çš„æ•°æ® â†’ æ”¹å˜æŸ¥è¯¢ç»“æœ â†’ å½±å“ä¸šåŠ¡é€»è¾‘
```

### 4.2 TLS/SSLåŠ å¯†è¯¦è§£


#### ğŸ”¸ ä»€ä¹ˆæ˜¯TLS/SSL


**ğŸ’¡ é€šä¿—ç†è§£**ï¼š
TLS/SSLå°±åƒç»™ä½ çš„ç”µè¯åŠ äº†åŠ å¯†å™¨ï¼Œåˆ«äººå°±ç®—å·å¬ä¹Ÿåªèƒ½å¬åˆ°"å˜€å˜€å—’å—’"çš„å¯†ç ï¼Œå¬ä¸æ‡‚ä½ åœ¨è¯´ä»€ä¹ˆã€‚

```
æ™®é€šHTTP vs HTTPSç±»æ¯”ï¼š
HTTP  â†’ æ˜æ–‡ä¼ è¾“ â†’ å®¹æ˜“è¢«çªƒå¬
HTTPS â†’ TLSåŠ å¯† â†’ å®‰å…¨ä¼ è¾“

åŒæ ·é“ç†ï¼š
LDAP  â†’ æ˜æ–‡ä¼ è¾“ â†’ ç«¯å£389
LDAPS â†’ TLSåŠ å¯† â†’ ç«¯å£636
```

#### ğŸ”¸ LDAPSè¿æ¥å®ç°

```java
public class SecureLdapConnection {
    
    public LdapContext connectSecure() {
        try {
            Hashtable<String, String> env = new Hashtable<>();
            env.put(Context.INITIAL_CONTEXT_FACTORY, "com.sun.jndi.ldap.LdapCtxFactory");
            
            // ğŸ”’ ä½¿ç”¨LDAPS (LDAP over SSL)
            env.put(Context.PROVIDER_URL, "ldaps://localhost:636");
            
            // ğŸ” SSLé…ç½®
            env.put(Context.SECURITY_PROTOCOL, "ssl");
            
            // è®¤è¯ä¿¡æ¯
            env.put(Context.SECURITY_AUTHENTICATION, "simple");
            env.put(Context.SECURITY_PRINCIPAL, "cn=admin,dc=company,dc=com");
            env.put(Context.SECURITY_CREDENTIALS, "admin123");
            
            // ğŸ›¡ï¸ åˆ›å»ºå®‰å…¨è¿æ¥
            return new InitialLdapContext(env, null);
            
        } catch (Exception e) {
            throw new RuntimeException("å®‰å…¨è¿æ¥å¤±è´¥ï¼š" + e.getMessage());
        }
    }
}
```

#### ğŸ”¸ SSLè¯ä¹¦é…ç½®

```java
// è‡ªç­¾åè¯ä¹¦çš„ä¿¡ä»»ç®¡ç†
public class TrustAllCertificates {
    
    static {
        // âš ï¸ ä»…ç”¨äºå¼€å‘ç¯å¢ƒï¼Œç”Ÿäº§ç¯å¢ƒè¦ç”¨æ­£å¼è¯ä¹¦
        System.setProperty("javax.net.ssl.trustStore", "/path/to/truststore.jks");
        System.setProperty("javax.net.ssl.trustStorePassword", "changeit");
        
        // æˆ–è€…ç¦ç”¨è¯ä¹¦éªŒè¯ï¼ˆä¸æ¨èï¼‰
        HttpsURLConnection.setDefaultHostnameVerifier((hostname, session) -> true);
    }
}
```

### 4.3 StartTLSæœºåˆ¶


**ğŸ’¡ ä»€ä¹ˆæ˜¯StartTLS**ï¼š
StartTLSå°±åƒ"ç”µè¯åŠ å¯†å‡çº§"ï¼Œé€šè¯å¼€å§‹æ—¶æ˜¯æ™®é€šç”µè¯ï¼Œç„¶ååŒæ–¹åå•†å‡çº§ä¸ºåŠ å¯†é€šè¯ï¼Œæ¯”ä¸€å¼€å§‹å°±ç”¨åŠ å¯†ç”µè¯æ›´çµæ´»ã€‚

#### ğŸ”¸ StartTLSå·¥ä½œæµç¨‹

```
StartTLSåå•†è¿‡ç¨‹ï¼š

æ­¥éª¤1ï¸âƒ£: å®¢æˆ·ç«¯è¿æ¥åˆ°LDAPæœåŠ¡å™¨ï¼ˆç«¯å£389ï¼Œæ™®é€šè¿æ¥ï¼‰
    Client â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ LDAP Server
           "æˆ‘æƒ³å»ºç«‹è¿æ¥"

æ­¥éª¤2ï¸âƒ£: å®¢æˆ·ç«¯è¯·æ±‚StartTLSå‡çº§
    Client â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ LDAP Server  
           "è¯·å‡çº§åˆ°TLSåŠ å¯†"

æ­¥éª¤3ï¸âƒ£: æœåŠ¡å™¨ç¡®è®¤æ”¯æŒTLS
    Client â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  LDAP Server
           "å¥½çš„ï¼Œå¼€å§‹TLSæ¡æ‰‹"

æ­¥éª¤4ï¸âƒ£: TLSæ¡æ‰‹ï¼Œäº¤æ¢è¯ä¹¦å’Œå¯†é’¥
    Client â†â”€â”€â”€â”€â”€TLSâ”€â”€â”€â”€â”€â†’ LDAP Server
           è¯ä¹¦éªŒè¯+å¯†é’¥åå•†

æ­¥éª¤5ï¸âƒ£: åŠ å¯†é€šä¿¡å»ºç«‹
    Client â†â”€â”€â”€åŠ å¯†æ•°æ®â”€â”€â”€â†’ LDAP Server
```

#### ğŸ”¸ StartTLSä»£ç å®ç°

```java
public class StartTlsConnection {
    
    public LdapContext connectWithStartTls() {
        try {
            Hashtable<String, String> env = new Hashtable<>();
            env.put(Context.INITIAL_CONTEXT_FACTORY, "com.sun.jndi.ldap.LdapCtxFactory");
            
            // ğŸ”Œ å…ˆå»ºç«‹æ™®é€šè¿æ¥
            env.put(Context.PROVIDER_URL, "ldap://localhost:389");
            
            LdapContext ctx = new InitialLdapContext(env, null);
            
            // ğŸ”’ å‡çº§åˆ°TLSåŠ å¯†è¿æ¥
            StartTlsResponse tls = (StartTlsResponse) 
                ctx.extendedOperation(new StartTlsRequest());
            
            SSLSession session = tls.negotiate();
            System.out.println("TLSåŠ å¯†å·²å¯åŠ¨ï¼ŒåŠ å¯†å¥—ä»¶ï¼š" + session.getCipherSuite());
            
            // ç°åœ¨å¯ä»¥å®‰å…¨åœ°è¿›è¡Œè®¤è¯
            ctx.addToEnvironment(Context.SECURITY_AUTHENTICATION, "simple");
            ctx.addToEnvironment(Context.SECURITY_PRINCIPAL, "cn=admin,dc=company,dc=com");
            ctx.addToEnvironment(Context.SECURITY_CREDENTIALS, "admin123");
            
            return ctx;
            
        } catch (Exception e) {
            throw new RuntimeException("StartTLSè¿æ¥å¤±è´¥ï¼š" + e.getMessage());
        }
    }
}
```

**ğŸ“Š TLS vs StartTLSå¯¹æ¯”**ï¼š

| ç‰¹å¾ | **LDAPS (TLS)** | **StartTLS** | **å»ºè®®** |
|------|-----------------|-------------|----------|
| `ç«¯å£` | 636ï¼ˆä¸“ç”¨SSLç«¯å£ï¼‰ | 389ï¼ˆæ ‡å‡†LDAPç«¯å£ï¼‰ | `StartTLSæ›´çµæ´»` |
| `è¿æ¥æ–¹å¼` | ç›´æ¥SSLè¿æ¥ | å…ˆæ˜æ–‡ååŠ å¯† | `LDAPSæ›´ç®€å•` |
| `çµæ´»æ€§` | â­â­â˜†â˜†â˜† | â­â­â­â­â­ | `StartTLSé€‚åº”æ€§å¼º` |
| `æ€§èƒ½` | âš¡âš¡âš¡âš¡â˜† | âš¡âš¡âš¡â˜†â˜† | `LDAPSç•¥å¿«` |

---

## 5. ğŸ› ï¸ å¼€å‘è€…å®‰å…¨å®è·µ


### 5.1 è¿æ¥æ± å®‰å…¨é…ç½®


**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦å®‰å…¨çš„è¿æ¥æ± **ï¼š
å°±åƒæ¸¸æ³³æ± éœ€è¦å®šæœŸæ¢æ°´æ¶ˆæ¯’ä¸€æ ·ï¼ŒLDAPè¿æ¥æ± ä¹Ÿéœ€è¦å®‰å…¨ç®¡ç†ï¼Œé˜²æ­¢è¿æ¥è¢«æ±¡æŸ“æˆ–æ»¥ç”¨ã€‚

```java
public class SecureLdapConnectionPool {
    
    private final GenericObjectPool<LdapContext> connectionPool;
    
    public SecureLdapConnectionPool() {
        // ğŸ”’ å®‰å…¨è¿æ¥æ± é…ç½®
        GenericObjectPoolConfig<LdapContext> config = new GenericObjectPoolConfig<>();
        config.setMaxTotal(50);                    // æœ€å¤§è¿æ¥æ•°
        config.setMaxIdle(10);                     // æœ€å¤§ç©ºé—²è¿æ¥
        config.setMinIdle(2);                      // æœ€å°ç©ºé—²è¿æ¥
        config.setMaxWaitMillis(30000);           // æœ€å¤§ç­‰å¾…æ—¶é—´
        config.setTestOnBorrow(true);             // å€Ÿç”¨æ—¶æµ‹è¯•è¿æ¥
        config.setTestOnReturn(true);             // å½’è¿˜æ—¶æµ‹è¯•è¿æ¥
        config.setValidationQuery("cn=admin");     // éªŒè¯æŸ¥è¯¢
        
        this.connectionPool = new GenericObjectPool<>(new LdapConnectionFactory(), config);
    }
    
    public LdapContext borrowConnection() throws Exception {
        return connectionPool.borrowObject();
    }
    
    public void returnConnection(LdapContext ctx) {
        connectionPool.returnObject(ctx);
    }
    
    // ğŸ” å®‰å…¨è¿æ¥å·¥å‚
    private class LdapConnectionFactory extends BasePooledObjectFactory<LdapContext> {
        
        @Override
        public LdapContext create() throws Exception {
            Hashtable<String, String> env = new Hashtable<>();
            env.put(Context.INITIAL_CONTEXT_FACTORY, "com.sun.jndi.ldap.LdapCtxFactory");
            env.put(Context.PROVIDER_URL, "ldaps://localhost:636");
            env.put(Context.SECURITY_PROTOCOL, "ssl");
            env.put(Context.SECURITY_AUTHENTICATION, "simple");
            env.put(Context.SECURITY_PRINCIPAL, "cn=pooluser,dc=company,dc=com");
            env.put(Context.SECURITY_CREDENTIALS, getEncryptedPassword());
            
            return new InitialLdapContext(env, null);
        }
        
        @Override
        public PooledObject<LdapContext> wrap(LdapContext ctx) {
            return new DefaultPooledObject<>(ctx);
        }
        
        @Override
        public boolean validateObject(PooledObject<LdapContext> p) {
            // ğŸ” éªŒè¯è¿æ¥æ˜¯å¦æœ‰æ•ˆ
            try {
                LdapContext ctx = p.getObject();
                ctx.getAttributes("", new String[]{"objectClass"});
                return true;
            } catch (Exception e) {
                return false;
            }
        }
    }
}
```

### 5.2 æ•æ„Ÿä¿¡æ¯åŠ å¯†å­˜å‚¨


**ğŸ’¡ å®‰å…¨åŸåˆ™**ï¼š
å¯†ç å°±åƒé“¶è¡Œå¡å¯†ç ï¼Œç»ä¸èƒ½æ˜æ–‡å­˜å‚¨åœ¨ä»£ç æˆ–é…ç½®æ–‡ä»¶ä¸­ï¼Œè¦ç”¨ä¸“é—¨çš„"ä¿é™©ç®±"ä¿å­˜ã€‚

#### ğŸ”¸ é…ç½®æ–‡ä»¶åŠ å¯†

```java
public class SecureConfigManager {
    
    private final AESUtil encryptionUtil;
    
    public SecureConfigManager() {
        this.encryptionUtil = new AESUtil();
    }
    
    // ğŸ” åŠ è½½åŠ å¯†çš„LDAPé…ç½®
    public LdapConfig loadSecureConfig() {
        Properties props = new Properties();
        try (InputStream input = getClass().getResourceAsStream("/ldap-secure.properties")) {
            props.load(input);
            
            LdapConfig config = new LdapConfig();
            config.setUrl(props.getProperty("ldap.url"));
            config.setBaseDn(props.getProperty("ldap.baseDn"));
            
            // ğŸ”“ è§£å¯†æ•æ„Ÿä¿¡æ¯
            String encryptedPassword = props.getProperty("ldap.password.encrypted");
            config.setPassword(encryptionUtil.decrypt(encryptedPassword));
            
            return config;
            
        } catch (Exception e) {
            throw new RuntimeException("é…ç½®åŠ è½½å¤±è´¥", e);
        }
    }
    
    // ğŸ” ç®€å•çš„AESåŠ å¯†å·¥å…·
    private static class AESUtil {
        private final String key = System.getProperty("ldap.encryption.key");
        
        public String decrypt(String encryptedText) {
            // å®ç°AESè§£å¯†é€»è¾‘
            // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”ç”¨ä¸­è¦ä½¿ç”¨æˆç†Ÿçš„åŠ å¯†åº“
            return performDecryption(encryptedText, key);
        }
    }
}
```

#### ğŸ”¸ å¯†ç å®‰å…¨å­˜å‚¨é…ç½®

```properties
# ldap-secure.properties

# æ˜æ–‡é…ç½®
ldap.url=ldaps://localhost:636
ldap.baseDn=dc=company,dc=com
ldap.bindDn=cn=app,ou=services,dc=company,dc=com

# ğŸ” åŠ å¯†å­˜å‚¨çš„å¯†ç 
ldap.password.encrypted=U2FsdGVkX1+vupppZksvRf5pq5g5XjFRIipRkwB0K1Y=

# å…¶ä»–å®‰å…¨é…ç½®
ldap.connection.timeout=30000
ldap.connection.pool.maxActive=50
ldap.ssl.trustStore=/etc/ssl/certs/ldap-truststore.jks
```

### 5.3 è¾“å…¥éªŒè¯ä¸æ³¨å…¥é˜²æŠ¤


**ğŸ’¡ LDAPæ³¨å…¥æ”»å‡»**ï¼š
å°±åƒSQLæ³¨å…¥ä¸€æ ·ï¼Œæ¶æ„ç”¨æˆ·å¯èƒ½é€šè¿‡ç‰¹æ®Šå­—ç¬¦ç ´åLDAPæŸ¥è¯¢ï¼Œè·å–æœªæˆæƒçš„æ•°æ®ã€‚

#### ğŸ”¸ å±é™©çš„æŸ¥è¯¢ç¤ºä¾‹

```java
// âŒ å±é™©ï¼šç›´æ¥æ‹¼æ¥ç”¨æˆ·è¾“å…¥
public class UnsafeLdapQuery {
    
    public List<User> searchUsers(String username) {
        // ç”¨æˆ·è¾“å…¥ï¼šadmin)(|(objectClass=*
        String filter = "(&(objectClass=user)(uid=" + username + "))";
        // ç»“æœï¼š(&(objectClass=user)(uid=admin)(|(objectClass=*)))
        // è¿™ä¼šè¿”å›æ‰€æœ‰å¯¹è±¡ï¼
        
        return ldapTemplate.search("ou=users,dc=company,dc=com", filter, userMapper);
    }
}
```

#### ğŸ”¸ å®‰å…¨çš„æŸ¥è¯¢å®ç°

```java
public class SafeLdapQuery {
    
    // âœ… å®‰å…¨ï¼šä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
    public List<User> searchUsersSafely(String username) {
        // ğŸ›¡ï¸ è¾“å…¥éªŒè¯
        if (!isValidUsername(username)) {
            throw new IllegalArgumentException("æ— æ•ˆçš„ç”¨æˆ·åæ ¼å¼");
        }
        
        // ğŸ”’ ä½¿ç”¨å ä½ç¬¦ï¼Œé˜²æ­¢æ³¨å…¥
        String filter = "(&(objectClass=user)(uid={0}))";
        return ldapTemplate.search("ou=users,dc=company,dc=com", 
                                 filter, 
                                 new String[]{username}, 
                                 userMapper);
    }
    
    // ğŸ” è¾“å…¥éªŒè¯æ–¹æ³•
    private boolean isValidUsername(String username) {
        if (username == null || username.trim().isEmpty()) {
            return false;
        }
        
        // æ£€æŸ¥é•¿åº¦
        if (username.length() > 50) {
            return false;
        }
        
        // æ£€æŸ¥ç‰¹æ®Šå­—ç¬¦ï¼ˆLDAPç‰¹æ®Šå­—ç¬¦ï¼š* ( ) \ / NULï¼‰
        String[] dangerousChars = {"*", "(", ")", "\\", "/", "\0"};
        for (String dangerous : dangerousChars) {
            if (username.contains(dangerous)) {
                return false;
            }
        }
        
        // åªå…è®¸å­—æ¯ã€æ•°å­—ã€ç‚¹ã€ä¸‹åˆ’çº¿ã€è¿å­—ç¬¦
        return username.matches("^[a-zA-Z0-9._-]+$");
    }
    
    // ğŸ” è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
    private String escapeLdapSearchFilter(String input) {
        if (input == null) return null;
        
        return input.replace("\\", "\\5c")
                   .replace("*", "\\2a")
                   .replace("(", "\\28")
                   .replace(")", "\\29")
                   .replace("\0", "\\00");
    }
}
```

### 5.4 å®¡è®¡æ—¥å¿—ä¸ç›‘æ§


**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦å®¡è®¡**ï¼š
å°±åƒé“¶è¡Œè¦è®°å½•æ¯ç¬”äº¤æ˜“ä¸€æ ·ï¼ŒLDAPæ“ä½œä¹Ÿè¦è®°å½•æ—¥å¿—ï¼Œå‡ºé—®é¢˜æ—¶èƒ½è¿½æŸ¥æ˜¯è°ã€ä»€ä¹ˆæ—¶å€™ã€åšäº†ä»€ä¹ˆã€‚

#### ğŸ”¸ å®‰å…¨å®¡è®¡å®ç°

```java
@Component
public class LdapSecurityAuditor {
    
    private static final Logger auditLogger = LoggerFactory.getLogger("LDAP_AUDIT");
    
    // ğŸ” è®°å½•è®¤è¯äº‹ä»¶
    public void logAuthentication(String userDn, String clientIP, boolean success) {
        AuditEvent event = AuditEvent.builder()
            .timestamp(System.currentTimeMillis())
            .eventType("AUTHENTICATION")
            .userDN(userDn)
            .clientIP(clientIP)
            .success(success)
            .build();
            
        auditLogger.info("Auth: user={}, ip={}, success={}, time={}", 
                         userDn, clientIP, success, new Date());
        
        // ğŸ’¾ å­˜å‚¨åˆ°å®¡è®¡æ•°æ®åº“
        auditRepository.save(event);
        
        // ğŸš¨ å¤±è´¥æ¬¡æ•°è¿‡å¤šæ—¶å‘Šè­¦
        if (!success) {
            checkFailedAttempts(userDn, clientIP);
        }
    }
    
    // ğŸ” è®°å½•æ•°æ®è®¿é—®äº‹ä»¶
    public void logDataAccess(String userDn, String targetDn, String operation) {
        auditLogger.info("Access: user={}, target={}, operation={}, time={}", 
                         userDn, targetDn, operation, new Date());
    }
    
    // ğŸš¨ æ£€æµ‹å¼‚å¸¸è¡Œä¸º
    private void checkFailedAttempts(String userDn, String clientIP) {
        long recentFailures = auditRepository.countFailedAttempts(userDn, 
                                                                  System.currentTimeMillis() - 300000); // 5åˆ†é’Ÿå†…
        
        if (recentFailures >= 5) {
            // è§¦å‘å®‰å…¨å‘Šè­¦
            securityAlertService.sendAlert(
                "é¢‘ç¹è®¤è¯å¤±è´¥", 
                String.format("ç”¨æˆ· %s ä» %s åœ¨5åˆ†é’Ÿå†…å¤±è´¥ %d æ¬¡", userDn, clientIP, recentFailures)
            );
            
            // å¯ä»¥è€ƒè™‘ä¸´æ—¶å°ç¦IP
            securityService.blockIP(clientIP, Duration.ofMinutes(15));
        }
    }
}
```

### 5.5 å¿…çŸ¥å®‰å…¨åŠ å›ºæªæ–½


#### ğŸ”¸ æœåŠ¡å™¨å®‰å…¨é…ç½®æ¸…å•

```bash
# OpenLDAP å®‰å…¨åŠ å›ºé…ç½®

# 1ï¸âƒ£ ç¦ç”¨ä¸å¿…è¦çš„åŠŸèƒ½
# ç¦ç”¨åŒ¿åç»‘å®š
disallow bind_anon

# 2ï¸âƒ£ å¼ºåˆ¶ä½¿ç”¨åŠ å¯†è¿æ¥
# è¦æ±‚æ‰€æœ‰è¿æ¥ä½¿ç”¨TLS
security tls=1

# 3ï¸âƒ£ è®¾ç½®åˆç†çš„æ—¥å¿—çº§åˆ«
loglevel 256  # è®°å½•è¿æ¥å’Œè®¤è¯äº‹ä»¶

# 4ï¸âƒ£ é™åˆ¶è¿æ¥æ•°å’Œè¶…æ—¶
# æœ€å¤§å¹¶å‘è¿æ¥æ•°
threads 16
# è¿æ¥è¶…æ—¶æ—¶é—´
conn_max_pending_auth 1000

# 5ï¸âƒ£ é…ç½®å¯†ç ç­–ç•¥
# ä½¿ç”¨ppolicy overlay
overlay ppolicy
ppolicy_default "cn=default,ou=policies,dc=company,dc=com"
```

#### ğŸ”¸ å¼€å‘ç¯å¢ƒå®‰å…¨æ£€æŸ¥è¡¨

```java
// ğŸ” å®‰å…¨é…ç½®æ£€æŸ¥å·¥å…·
public class LdapSecurityChecker {
    
    public SecurityCheckResult performSecurityCheck() {
        SecurityCheckResult result = new SecurityCheckResult();
        
        // âœ… æ£€æŸ¥1ï¼šè¿æ¥æ˜¯å¦ä½¿ç”¨åŠ å¯†
        result.addCheck("åŠ å¯†è¿æ¥", checkEncryptedConnection());
        
        // âœ… æ£€æŸ¥2ï¼šå¯†ç æ˜¯å¦å®‰å…¨å­˜å‚¨
        result.addCheck("å¯†ç å®‰å…¨", checkPasswordSecurity());
        
        // âœ… æ£€æŸ¥3ï¼šè¾“å…¥éªŒè¯æ˜¯å¦åˆ°ä½
        result.addCheck("è¾“å…¥éªŒè¯", checkInputValidation());
        
        // âœ… æ£€æŸ¥4ï¼šå®¡è®¡æ—¥å¿—æ˜¯å¦å¯ç”¨
        result.addCheck("å®¡è®¡æ—¥å¿—", checkAuditLogging());
        
        // âœ… æ£€æŸ¥5ï¼šæƒé™é…ç½®æ˜¯å¦åˆç†
        result.addCheck("æƒé™æ§åˆ¶", checkAccessControl());
        
        return result;
    }
    
    private boolean checkEncryptedConnection() {
        // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨LDAPSæˆ–StartTLS
        String ldapUrl = config.getLdapUrl();
        return ldapUrl.startsWith("ldaps://") || config.isStartTlsEnabled();
    }
    
    private boolean checkPasswordSecurity() {
        // æ£€æŸ¥å¯†ç æ˜¯å¦åŠ å¯†å­˜å‚¨
        return !config.getPassword().startsWith("plain:");
    }
    
    // ... å…¶ä»–æ£€æŸ¥æ–¹æ³•
}
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„å®‰å…¨æ¦‚å¿µ


```
ğŸ” è®¤è¯æ–¹å¼é€‰æ‹©ï¼š
â”œâ”€ åŒ¿åç»‘å®šï¼šä»…ç”¨äºå…¬å¼€ä¿¡æ¯æŸ¥è¯¢
â”œâ”€ ç®€å•ç»‘å®šï¼šå¿…é¡»é…åˆTLSä½¿ç”¨
â””â”€ SASLç»‘å®šï¼šä¼ä¸šçº§åº”ç”¨é¦–é€‰

ğŸ›¡ï¸ æƒé™æ§åˆ¶ç­–ç•¥ï¼š
â”œâ”€ æœ€å°æƒé™åŸåˆ™ï¼šåªç»™å¿…éœ€çš„æƒé™
â”œâ”€ ACLç²¾ç»†æ§åˆ¶ï¼šåŸºäºç”¨æˆ·ã€ç»„ã€èµ„æº
â””â”€ å®šæœŸæƒé™å®¡è®¡ï¼šé¿å…æƒé™æ³„éœ²

ğŸ”’ ä¼ è¾“åŠ å¯†æ–¹å¼ï¼š
â”œâ”€ LDAPSï¼šä¸“ç”¨SSLè¿æ¥ï¼ˆç«¯å£636ï¼‰
â”œâ”€ StartTLSï¼šçµæ´»çš„åŠ å¯†å‡çº§
â””â”€ è¯ä¹¦ç®¡ç†ï¼šæ­£ç¡®é…ç½®å’ŒéªŒè¯è¯ä¹¦
```

### 6.2 å¼€å‘å®è·µè¦ç‚¹


**ğŸ”¸ å®‰å…¨ç¼–ç åŸåˆ™**ï¼š
```
è¾“å…¥éªŒè¯ï¼š
â”œâ”€ è¿‡æ»¤ç‰¹æ®Šå­—ç¬¦ï¼šé˜²æ­¢LDAPæ³¨å…¥
â”œâ”€ é•¿åº¦é™åˆ¶ï¼šé˜²æ­¢ç¼“å†²åŒºæº¢å‡º
â””â”€ æ ¼å¼æ ¡éªŒï¼šç¡®ä¿æ•°æ®åˆæ³•æ€§

è¿æ¥ç®¡ç†ï¼š
â”œâ”€ ä½¿ç”¨è¿æ¥æ± ï¼šæé«˜æ€§èƒ½å’Œå®‰å…¨æ€§
â”œâ”€ è¶…æ—¶é…ç½®ï¼šé˜²æ­¢èµ„æºè€—å°½
â””â”€ å¼‚å¸¸å¤„ç†ï¼šé¿å…ä¿¡æ¯æ³„éœ²

æ•æ„Ÿä¿¡æ¯ä¿æŠ¤ï¼š
â”œâ”€ å¯†ç åŠ å¯†å­˜å‚¨ï¼šä¸èƒ½æ˜æ–‡ä¿å­˜
â”œâ”€ ä¼ è¾“åŠ å¯†ï¼šä½¿ç”¨TLS/SSL
â””â”€ æ—¥å¿—è„±æ•ï¼šé¿å…æ•æ„Ÿä¿¡æ¯æ³„éœ²
```

**ğŸ”¸ ç›‘æ§å‘Šè­¦æœºåˆ¶**ï¼š
```
å…³é”®æŒ‡æ ‡ç›‘æ§ï¼š
â”œâ”€ è®¤è¯å¤±è´¥æ¬¡æ•°ï¼šæ£€æµ‹æš´åŠ›ç ´è§£
â”œâ”€ å¼‚å¸¸è®¿é—®æ¨¡å¼ï¼šæ£€æµ‹æƒé™æ»¥ç”¨
â””â”€ è¿æ¥å¼‚å¸¸ï¼šæ£€æµ‹ç½‘ç»œæ”»å‡»

å®‰å…¨äº‹ä»¶å“åº”ï¼š
â”œâ”€ å®æ—¶å‘Šè­¦ï¼šåŠæ—¶å‘ç°å®‰å…¨äº‹ä»¶
â”œâ”€ è‡ªåŠ¨å°ç¦ï¼šé˜»æ­¢æ¶æ„è¡Œä¸º
â””â”€ å®¡è®¡è¿½æº¯ï¼šäº‹ååˆ†æè°ƒæŸ¥
```

### 6.3 ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ


**ğŸš€ éƒ¨ç½²å®‰å…¨æ£€æŸ¥**ï¼š
- âœ… å¼ºåˆ¶ä½¿ç”¨åŠ å¯†è¿æ¥ï¼ˆLDAPS/StartTLSï¼‰
- âœ… é…ç½®ä¸¥æ ¼çš„ACLæƒé™è§„åˆ™
- âœ… å¯ç”¨è¯¦ç»†çš„å®¡è®¡æ—¥å¿—è®°å½•
- âœ… å®æ–½å¯†ç å¤æ‚åº¦ç­–ç•¥
- âœ… å®šæœŸæ›´æ–°è¯ä¹¦å’Œå¯†é’¥
- âœ… ç›‘æ§å¼‚å¸¸è®¿é—®è¡Œä¸º
- âœ… å¤‡ä»½å…³é”®é…ç½®å’Œæ•°æ®

**ğŸ§  è®°å¿†è¦ç‚¹**ï¼š
```
LDAPå®‰å…¨ä¸‰è¦ç´ ï¼šè®¤è¯ã€æˆæƒã€åŠ å¯†
ACLæƒé™æ§åˆ¶ï¼šè°èƒ½å¯¹ä»€ä¹ˆåšä»€ä¹ˆ
ä¼ è¾“åŠ å¯†é€‰æ‹©ï¼šLDAPSç®€å•ï¼ŒStartTLSçµæ´»
å¼€å‘å®‰å…¨åŸåˆ™ï¼šè¾“å…¥éªŒè¯ã€è¿æ¥ç®¡ç†ã€æ•æ„Ÿä¿æŠ¤
```

**ğŸ’¡ å®æˆ˜å»ºè®®**ï¼š
- ä»æœ€åŸºç¡€çš„TLSåŠ å¯†å¼€å§‹ï¼Œé€æ­¥å®Œå–„å®‰å…¨æªæ–½
- ä¼˜å…ˆä¿æŠ¤æ ¸å¿ƒæ•æ„Ÿæ•°æ®ï¼Œä¸è¦è¯•å›¾ä¸€æ¬¡æ€§è§£å†³æ‰€æœ‰é—®é¢˜
- å»ºç«‹å®‰å…¨å¼€å‘è§„èŒƒï¼Œå›¢é˜Ÿæˆå‘˜éƒ½è¦éµå®ˆ
- å®šæœŸè¿›è¡Œå®‰å…¨è¯„ä¼°ï¼ŒåŠæ—¶å‘ç°å’Œä¿®å¤å®‰å…¨æ¼æ´