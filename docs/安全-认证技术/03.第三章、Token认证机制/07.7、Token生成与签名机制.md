---
title: 7ã€Tokenç”Ÿæˆä¸ç­¾åæœºåˆ¶
---
## ğŸ“š ç›®å½•

1. [Tokenæ˜¯ä»€ä¹ˆ](#1-Tokenæ˜¯ä»€ä¹ˆ)
2. [Tokenç”Ÿæˆçš„å…³é”®è¦ç´ ](#2-Tokenç”Ÿæˆçš„å…³é”®è¦ç´ )
3. [å¸¸è§ç­¾åç®—æ³•è¯¦è§£](#3-å¸¸è§ç­¾åç®—æ³•è¯¦è§£)
4. [Tokenç”Ÿæˆçš„å®‰å…¨éšæœºæ€§](#4-Tokenç”Ÿæˆçš„å®‰å…¨éšæœºæ€§)
5. [ä¿è¯å”¯ä¸€æ€§ä¸é˜²ç¯¡æ”¹åŸåˆ™](#5-ä¿è¯å”¯ä¸€æ€§ä¸é˜²ç¯¡æ”¹åŸåˆ™)
6. [ç”¨æˆ·ä¿¡æ¯ä¸æ—¶é—´æˆ³çš„ç»„åˆç­–ç•¥](#6-ç”¨æˆ·ä¿¡æ¯ä¸æ—¶é—´æˆ³çš„ç»„åˆç­–ç•¥)
7. [å®é™…åº”ç”¨ç¤ºä¾‹](#7-å®é™…åº”ç”¨ç¤ºä¾‹)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ Tokenæ˜¯ä»€ä¹ˆ


### 1.1 é€šä¿—ç†è§£Token


> ğŸ’¡ **ç®€å•æ¯”å–»**ï¼šTokenå°±åƒæ˜¯ç”µå½±é™¢çš„**ç”µå­ç¥¨**
> - é‡Œé¢åŒ…å«äº†ä½ çš„åº§ä½ä¿¡æ¯ã€åœºæ¬¡æ—¶é—´ã€ç”µå½±åç§°
> - æœ‰é˜²ä¼ªæ ‡è¯†ï¼Œåˆ«äººæ— æ³•ä¼ªé€ 
> - æœ‰æœ‰æ•ˆæœŸï¼Œè¿‡æœŸå°±ä¸èƒ½ç”¨äº†
> - å·¥ä½œäººå‘˜æ‰«ä¸€ä¸‹å°±çŸ¥é“ä½ çš„æ‰€æœ‰ä¿¡æ¯

**Tokençš„æœ¬è´¨**ï¼š
- ğŸ”‘ ä¸€ä¸ª**åŠ å¯†çš„å­—ç¬¦ä¸²**ï¼ŒåŒ…å«ç”¨æˆ·èº«ä»½å’Œæƒé™ä¿¡æ¯
- ğŸ›¡ï¸ æœåŠ¡å™¨é¢å‘çš„**æ•°å­—å‡­è¯**ï¼Œè¯æ˜"ä½ æ˜¯è°ï¼Œèƒ½åšä»€ä¹ˆ"
- â° æœ‰**æ—¶æ•ˆæ€§**ï¼Œè¿‡æœŸéœ€è¦é‡æ–°è·å–
- ğŸ”’ ç»è¿‡**æ•°å­—ç­¾å**ï¼Œé˜²æ­¢è¢«ç¯¡æ”¹

### 1.2 ä¸ºä»€ä¹ˆè¦ç”¨Token


ä¼ ç»Ÿè®¤è¯ vs Tokenè®¤è¯å¯¹æ¯”ï¼š

```
ä¼ ç»ŸSessionè®¤è¯ï¼š
ç”¨æˆ·ç™»å½• â†’ æœåŠ¡å™¨å­˜å‚¨Session â†’ è¿”å›SessionID
æ¯æ¬¡è¯·æ±‚ â†’ å¸¦ä¸ŠSessionID â†’ æœåŠ¡å™¨æŸ¥Sessionè¡¨

é—®é¢˜ï¼š
âŒ æœåŠ¡å™¨éœ€è¦å­˜å‚¨å¤§é‡Sessionæ•°æ®
âŒ å¤šå°æœåŠ¡å™¨å…±äº«Sessionå›°éš¾
âŒ ç§»åŠ¨ç«¯æ”¯æŒä¸å¥½
```

```
Tokenè®¤è¯ï¼š
ç”¨æˆ·ç™»å½• â†’ æœåŠ¡å™¨ç”ŸæˆToken â†’ è¿”å›Token
æ¯æ¬¡è¯·æ±‚ â†’ å¸¦ä¸ŠToken â†’ æœåŠ¡å™¨éªŒè¯Token

ä¼˜åŠ¿ï¼š
âœ… æœåŠ¡å™¨æ— éœ€å­˜å‚¨ï¼ŒèŠ‚çœå†…å­˜
âœ… å¤©ç„¶æ”¯æŒåˆ†å¸ƒå¼
âœ… è·¨å¹³å°æ”¯æŒå¥½
âœ… å®‰å…¨æ€§æ›´é«˜
```

---

## 2. ğŸ§© Tokenç”Ÿæˆçš„å…³é”®è¦ç´ 


### 2.1 ä¸‰å¤§æ ¸å¿ƒè¦ç´ 


Tokenç”Ÿæˆå°±åƒ**åˆ¶ä½œèº«ä»½è¯**ï¼Œéœ€è¦åŒ…å«ä¸‰ä¸ªå…³é”®ä¿¡æ¯ï¼š

```
Tokenç»“æ„å›¾ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å®Œæ•´Token               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç”¨æˆ·èº«ä»½    â”‚   æ—¶é—´æˆ³    â”‚  æ•°å­—ç­¾å â”‚
â”‚  ä¿¡æ¯       â”‚   ä¿¡æ¯      â”‚        â”‚
â”‚ (Header +   â”‚ (è¿‡æœŸæ—¶é—´ç­‰) â”‚ (é˜²ç¯¡æ”¹) â”‚
â”‚  Payload)   â”‚            â”‚        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ç”¨æˆ·èº«ä»½ä¿¡æ¯ (Payload)


**åŒ…å«ä»€ä¹ˆä¿¡æ¯**ï¼š
```json
{
  "userId": 12345,           // ç”¨æˆ·ID - å¿…é¡»
  "username": "å¼ ä¸‰",        // ç”¨æˆ·å - å¯é€‰
  "email": "user@demo.com",  // é‚®ç®± - å¯é€‰
  "roles": ["admin", "user"], // è§’è‰²æƒé™ - é‡è¦
  "departmentId": 101        // éƒ¨é—¨ID - ä¸šåŠ¡ç›¸å…³
}
```

> âš ï¸ **é‡è¦æé†’**ï¼šä¸è¦åœ¨Tokenä¸­æ”¾æ•æ„Ÿä¿¡æ¯ï¼
> - âŒ ä¸æ”¾å¯†ç ã€é“¶è¡Œå¡å·ç­‰æœºå¯†ä¿¡æ¯  
> - âœ… åªæ”¾ç”¨äºèº«ä»½è¯†åˆ«çš„åŸºæœ¬ä¿¡æ¯

### 2.3 æ—¶é—´æˆ³ä¿¡æ¯


**æ—¶é—´ç›¸å…³å­—æ®µ**ï¼š
```json
{
  "iat": 1691840400,  // issued at - ç­¾å‘æ—¶é—´
  "exp": 1691926800,  // expires - è¿‡æœŸæ—¶é—´  
  "nbf": 1691840400   // not before - ç”Ÿæ•ˆæ—¶é—´ï¼ˆå¯é€‰ï¼‰
}
```

**æ—¶é—´æˆ³çš„ä½œç”¨**ï¼š
- â° **è¿‡æœŸæ§åˆ¶**ï¼šé˜²æ­¢Tokenæ°¸ä¹…æœ‰æ•ˆçš„å®‰å…¨é£é™©
- ğŸ”„ **åˆ·æ–°æœºåˆ¶**ï¼šé…åˆrefresh tokenå®ç°æ— æ„Ÿç»­æœŸ
- ğŸ“… **ç”Ÿæ•ˆæ§åˆ¶**ï¼šå¯ä»¥è®¾ç½®Tokenåœ¨æœªæ¥æŸä¸ªæ—¶é—´æ‰ç”Ÿæ•ˆ

### 2.4 æ•°å­—ç­¾å


**ç­¾åçš„ä½œç”¨**ï¼š
```
åŸå§‹æ•°æ®ï¼š {"userId":123, "exp":1691926800}
åŠ ä¸Šå¯†é’¥ï¼š {"userId":123, "exp":1691926800} + "æœåŠ¡å™¨å¯†é’¥"
é€šè¿‡ç®—æ³•ï¼š HMAC-SHA256(æ•°æ® + å¯†é’¥)
å¾—åˆ°ç­¾åï¼š "a7b2c8e1f9d4..."

æœ€ç»ˆToken = Base64(header) + "." + Base64(payload) + "." + ç­¾å
```

---

## 3. ğŸ” å¸¸è§ç­¾åç®—æ³•è¯¦è§£


### 3.1 HMACç®—æ³•


> ğŸ“– **HMACæ¦‚å¿µ**ï¼šHash-based Message Authentication Code
> å“ˆå¸Œæ¶ˆæ¯è®¤è¯ç ï¼Œç”¨**å¯¹ç§°å¯†é’¥**è¿›è¡Œç­¾åéªŒè¯

**å·¥ä½œåŸç†**ï¼š
```
ç­¾åè¿‡ç¨‹ï¼š
æ•°æ® + æœåŠ¡å™¨å¯†é’¥ â†’ HMACç®—æ³• â†’ ç­¾å

éªŒè¯è¿‡ç¨‹ï¼š
æ”¶åˆ°çš„æ•°æ® + æœåŠ¡å™¨å¯†é’¥ â†’ HMACç®—æ³• â†’ é‡æ–°è®¡ç®—ç­¾å
æ–°ç­¾å == åŸç­¾å ï¼Ÿ éªŒè¯é€šè¿‡ : éªŒè¯å¤±è´¥
```

**ä¼˜ç¼ºç‚¹å¯¹æ¯”**ï¼š

| ç‰¹ç‚¹ | **æè¿°** | **é€‚ç”¨åœºæ™¯** |
|------|---------|-------------|
| âœ… **ç®€å•å¿«é€Ÿ** | è®¡ç®—é€Ÿåº¦å¿«ï¼ŒæœåŠ¡å™¨å‹åŠ›å° | å•ä½“åº”ç”¨ã€å†…éƒ¨ç³»ç»Ÿ |
| âœ… **å ç”¨å°** | ç­¾åé•¿åº¦çŸ­ï¼ŒTokenä½“ç§¯å° | ç§»åŠ¨ç«¯ã€å¸¦å®½æ•æ„Ÿåœºæ™¯ |
| âŒ **å¯†é’¥å…±äº«** | æ‰€æœ‰æœåŠ¡å™¨å¿…é¡»æœ‰ç›¸åŒå¯†é’¥ | ä¸é€‚åˆå¤§è§„æ¨¡åˆ†å¸ƒå¼ |

**ä»£ç ç¤ºä¾‹**ï¼š
```javascript
// HMAC-SHA256 ç­¾åç¤ºä¾‹
const crypto = require('crypto');

function createHMACSignature(data, secretKey) {
  return crypto
    .createHmac('sha256', secretKey)
    .update(data)
    .digest('base64');
}

// ä½¿ç”¨ç¤ºä¾‹
const payload = JSON.stringify({userId: 123, exp: 1691926800});
const secret = 'myServerSecret123';
const signature = createHMACSignature(payload, secret);
console.log('ç­¾åç»“æœ:', signature);
```

### 3.2 RSAç®—æ³•


> ğŸ“– **RSAæ¦‚å¿µ**ï¼šéå¯¹ç§°åŠ å¯†ç®—æ³•
> ä½¿ç”¨**å…¬é’¥ç§é’¥å¯¹**ï¼Œç§é’¥ç­¾åï¼Œå…¬é’¥éªŒè¯

**å·¥ä½œåŸç†**ï¼š
```
RSAå¯†é’¥å¯¹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç§é’¥      â”‚    â”‚    å…¬é’¥      â”‚
â”‚ (æœåŠ¡å™¨ä¿ç®¡) â”‚    â”‚ (å¯ä»¥å…¬å¼€)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                   â”‚
       â–¼                   â–¼
   ç”¨äºç­¾å              ç”¨äºéªŒè¯
```

**åº”ç”¨åœºæ™¯å›¾**ï¼š
```
æœåŠ¡ç«¯ç­¾åæµç¨‹ï¼š
Tokenæ•°æ® â†’ [ç§é’¥ç­¾å] â†’ å¸¦ç­¾åçš„Token â†’ å‘é€ç»™å®¢æˆ·ç«¯

å®¢æˆ·ç«¯éªŒè¯æµç¨‹ï¼š  
æ”¶åˆ°Token â†’ [å…¬é’¥éªŒè¯] â†’ éªŒè¯é€šè¿‡/å¤±è´¥
```

**ä¼˜ç¼ºç‚¹å¯¹æ¯”**ï¼š

| ç‰¹ç‚¹ | **æè¿°** | **é€‚ç”¨åœºæ™¯** |
|------|---------|-------------|
| âœ… **å®‰å…¨æ€§é«˜** | ç§é’¥ä¸éœ€è¦å…±äº«ç»™éªŒè¯æ–¹ | å¾®æœåŠ¡ã€ç¬¬ä¸‰æ–¹é›†æˆ |
| âœ… **åˆ†å¸ƒå¼å‹å¥½** | å„æœåŠ¡åªéœ€è¦å…¬é’¥éªŒè¯ | å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿ |
| âŒ **è®¡ç®—å¤æ‚** | ç­¾åéªŒè¯é€Ÿåº¦è¾ƒæ…¢ | å¯¹æ€§èƒ½è¦æ±‚ä¸é«˜çš„åœºæ™¯ |
| âŒ **ç­¾åè¾ƒé•¿** | Tokenä½“ç§¯ç›¸å¯¹è¾ƒå¤§ | éç§»åŠ¨ç«¯åœºæ™¯ |

### 3.3 ECDSAç®—æ³•


> ğŸ“– **ECDSAæ¦‚å¿µ**ï¼šElliptic Curve Digital Signature Algorithm
> æ¤­åœ†æ›²çº¿æ•°å­—ç­¾åç®—æ³•ï¼ŒRSAçš„**é«˜æ•ˆæ›¿ä»£æ–¹æ¡ˆ**

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
```
å®‰å…¨å¼ºåº¦å¯¹æ¯”ï¼š
RSA 2048ä½ = ECDSA 256ä½ = AES 128ä½

æ€§èƒ½å¯¹æ¯”ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç®—æ³•ç±»å‹   â”‚ å¯†é’¥é•¿åº¦ â”‚ ç­¾åé•¿åº¦ â”‚ è®¡ç®—é€Ÿåº¦ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ RSA         â”‚ 2048ä½ â”‚  256å­—èŠ‚ â”‚   æ…¢   â”‚
â”‚ ECDSA P-256 â”‚ 256ä½  â”‚   64å­—èŠ‚ â”‚   å¿«   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é€‚ç”¨åœºæ™¯**ï¼š
- ğŸš€ **é«˜æ€§èƒ½è¦æ±‚**ï¼šéœ€è¦å¿«é€Ÿç­¾åéªŒè¯çš„åœºæ™¯
- ğŸ“± **ç§»åŠ¨ç«¯åº”ç”¨**ï¼šå¯¹Tokenå¤§å°æ•æ„Ÿçš„åº”ç”¨  
- ğŸŒ **ç°ä»£åŒ–ç³»ç»Ÿ**ï¼šè¿½æ±‚æœ€ä½³å®‰å…¨æ€§èƒ½å¹³è¡¡

---

## 4. ğŸ² Tokenç”Ÿæˆçš„å®‰å…¨éšæœºæ€§


### 4.1 ä¸ºä»€ä¹ˆéœ€è¦éšæœºæ€§


> âš ï¸ **å®‰å…¨é£é™©**ï¼šå¦‚æœTokenç”Ÿæˆæ˜¯å¯é¢„æµ‹çš„ï¼Œæ”»å‡»è€…å¯èƒ½çŒœå‡ºå…¶ä»–ç”¨æˆ·çš„Token

**ä¸å®‰å…¨çš„ç”Ÿæˆæ–¹å¼**ï¼š
```javascript
// âŒ é”™è¯¯ç¤ºä¾‹ - å¯é¢„æµ‹çš„Token
function badTokenGenerate(userId) {
  const timestamp = Date.now();
  return `token_${userId}_${timestamp}`;  // å®¹æ˜“è¢«çŒœæµ‹
}
```

**å®‰å…¨çš„ç”Ÿæˆæ–¹å¼**ï¼š
```javascript
// âœ… æ­£ç¡®ç¤ºä¾‹ - å®‰å…¨éšæœºToken
const crypto = require('crypto');

function secureTokenGenerate(payload) {
  // 1. æ·»åŠ å®‰å…¨éšæœºæ•°
  const jti = crypto.randomBytes(16).toString('hex');  // JWT ID
  
  // 2. æ·»åŠ åˆ°payloadä¸­
  const securePayload = {
    ...payload,
    jti: jti,  // ä¿è¯å”¯ä¸€æ€§
    iat: Math.floor(Date.now() / 1000),  // ç­¾å‘æ—¶é—´
    exp: Math.floor(Date.now() / 1000) + 3600  // 1å°æ—¶åè¿‡æœŸ
  };
  
  return securePayload;
}
```

### 4.2 éšæœºæ€§çš„å®ç°è¦ç‚¹


**å…³é”®è¦ç´ **ï¼š

1. **JWT ID (jti)**ï¼š
   ```javascript
   // æ¯ä¸ªTokenéƒ½æœ‰å”¯ä¸€æ ‡è¯†
   "jti": "a7b2c3e4f5d6..." // 32ä½éšæœºå­—ç¬¦ä¸²
   ```

2. **å®‰å…¨æ—¶é—´æˆ³**ï¼š
   ```javascript
   // ç²¾ç¡®åˆ°ç§’ï¼Œé¿å…æ¯«ç§’çº§é¢„æµ‹
   "iat": 1691840400,  // Unixæ—¶é—´æˆ³ï¼ˆç§’ï¼‰
   ```

3. **ç›å€¼éšæœº**ï¼š
   ```javascript
   // åœ¨ç­¾åæ—¶æ·»åŠ éšæœºç›
   const salt = crypto.randomBytes(8).toString('hex');
   const signData = payload + salt + secretKey;
   ```

---

## 5. ğŸ›¡ï¸ ä¿è¯å”¯ä¸€æ€§ä¸é˜²ç¯¡æ”¹åŸåˆ™


### 5.1 å”¯ä¸€æ€§ä¿è¯æœºåˆ¶


**å¤šé‡å”¯ä¸€æ€§ä¿éšœ**ï¼š

```
å”¯ä¸€æ€§ä¿éšœä½“ç³»ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Tokenå”¯ä¸€æ€§              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç”¨æˆ·ç»´åº¦    â”‚   æ—¶é—´ç»´åº¦   â”‚ éšæœºç»´åº¦ â”‚
â”‚             â”‚             â”‚        â”‚
â”‚ â€¢ userId    â”‚ â€¢ iatæ—¶é—´æˆ³ â”‚ â€¢ jti   â”‚
â”‚ â€¢ è®¾å¤‡ID    â”‚ â€¢ ç²¾ç¡®åˆ°ç§’  â”‚ â€¢ éšæœºæ•° â”‚
â”‚ â€¢ sessionId â”‚ â€¢ å•è°ƒé€’å¢  â”‚ â€¢ UUID  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®ç°ç¤ºä¾‹**ï¼š
```javascript
function generateUniqueToken(userId, deviceId) {
  const now = Math.floor(Date.now() / 1000);
  const jti = crypto.randomUUID();  // æ ‡å‡†UUID
  
  const payload = {
    userId: userId,
    deviceId: deviceId,  // è®¾å¤‡å”¯ä¸€æ ‡è¯†
    iat: now,           // ç­¾å‘æ—¶é—´
    jti: jti,          // JWTå”¯ä¸€æ ‡è¯†
    exp: now + 3600    // è¿‡æœŸæ—¶é—´
  };
  
  return payload;
}
```

### 5.2 é˜²ç¯¡æ”¹æœºåˆ¶è¯¦è§£


**ç¯¡æ”¹æ£€æµ‹åŸç†**ï¼š

```
æ•°æ®å®Œæ•´æ€§éªŒè¯æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åŸå§‹æ•°æ®    â”‚ â†’  â”‚   æ•°å­—ç­¾å   â”‚ â†’  â”‚  å®Œæ•´Token  â”‚
â”‚ {"userId":123â”‚    â”‚ HMAC/RSAç­‰  â”‚    â”‚ header.     â”‚
â”‚  "exp":...}  â”‚    â”‚     ç®—æ³•    â”‚    â”‚ payload.    â”‚
â”‚             â”‚    â”‚             â”‚    â”‚ signature   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

éªŒè¯æ—¶ï¼š
æ”¶åˆ°Token â†’ åˆ†ç¦»æ•°æ®å’Œç­¾å â†’ é‡æ–°è®¡ç®—ç­¾å â†’ å¯¹æ¯”ç­¾åæ˜¯å¦ä¸€è‡´
```

**å¸¸è§ç¯¡æ”¹æ”»å‡»ä¸é˜²æŠ¤**ï¼š

| æ”»å‡»æ–¹å¼ | **æ”»å‡»åŸç†** | **é˜²æŠ¤æªæ–½** |
|---------|-------------|-------------|
| **æ•°æ®ä¿®æ”¹** | ä¿®æ”¹payloadä¸­çš„ç”¨æˆ·ID | æ•°å­—ç­¾åéªŒè¯å¤±è´¥ |
| **æ—¶é—´å»¶é•¿** | ä¿®æ”¹è¿‡æœŸæ—¶é—´å»¶é•¿æœ‰æ•ˆæœŸ | ç­¾åä¸åŒ¹é…ï¼ŒéªŒè¯å¤±è´¥ |
| **æƒé™æå‡** | ä¿®æ”¹è§’è‰²ä¿¡æ¯è·å¾—æ›´é«˜æƒé™ | æœåŠ¡ç«¯ç­¾åéªŒè¯æ‹’ç» |
| **é‡æ”¾æ”»å‡»** | å¤ç”¨å·²è¿‡æœŸçš„Token | æ—¶é—´æˆ³éªŒè¯+jtiå»é‡ |

---

## 6. â° ç”¨æˆ·ä¿¡æ¯ä¸æ—¶é—´æˆ³çš„ç»„åˆç­–ç•¥


### 6.1 ç»„åˆç­–ç•¥è®¾è®¡


**æœ€ä½³ç»„åˆæ¨¡å¼**ï¼š

```json
{
  "header": {
    "typ": "JWT",
    "alg": "HS256"
  },
  "payload": {
    // ğŸ‘¤ ç”¨æˆ·èº«ä»½ä¿¡æ¯
    "userId": 12345,
    "username": "å¼ ä¸‰",
    "roles": ["user", "admin"],
    
    // â° æ—¶é—´æ§åˆ¶ä¿¡æ¯  
    "iat": 1691840400,    // ç­¾å‘æ—¶é—´
    "exp": 1691926800,    // è¿‡æœŸæ—¶é—´
    "nbf": 1691840400,    // ç”Ÿæ•ˆæ—¶é—´
    
    // ğŸ² å”¯ä¸€æ€§ä¿¡æ¯
    "jti": "a7b2c3e4-f5d6-7890-abcd-ef1234567890",
    
    // ğŸ”’ å®‰å…¨æ§åˆ¶ä¿¡æ¯
    "deviceId": "mobile_ios_12345",
    "sessionId": "sess_abc123"
  }
}
```

### 6.2 æ—¶é—´ç­–ç•¥é…ç½®


**ä¸åŒåœºæ™¯çš„æ—¶é—´é…ç½®**ï¼š

```
åœºæ™¯é…ç½®å¯¹ç…§è¡¨ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åº”ç”¨åœºæ™¯   â”‚  æœ‰æ•ˆæ—¶é•¿  â”‚   åˆ·æ–°ç­–ç•¥ â”‚   å®‰å…¨ç­‰çº§  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å†…éƒ¨ç®¡ç†ç³»ç»Ÿ â”‚   8å°æ—¶   â”‚ è‡ªåŠ¨åˆ·æ–°  â”‚    ä¸­ç­‰    â”‚
â”‚ ç”µå•†è´­ç‰©ç½‘ç«™ â”‚   2å°æ—¶   â”‚ æ‰‹åŠ¨ç™»å½•  â”‚    è¾ƒé«˜    â”‚
â”‚ é“¶è¡Œé‡‘èç³»ç»Ÿ â”‚  15åˆ†é’Ÿ   â”‚ é¢‘ç¹éªŒè¯  â”‚    æé«˜    â”‚
â”‚ ç§»åŠ¨ç«¯APP   â”‚   7å¤©     â”‚ é™é»˜åˆ·æ–°  â”‚    ä¸­ç­‰    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ—¶é—´æ§åˆ¶ä»£ç ç¤ºä¾‹**ï¼š
```javascript
// ä¸åŒå®‰å…¨ç­‰çº§çš„Tokené…ç½®
const TokenConfig = {
  // é«˜å®‰å…¨ç­‰çº§ï¼ˆé“¶è¡Œç³»ç»Ÿï¼‰
  HIGH_SECURITY: {
    accessTokenTTL: 15 * 60,        // 15åˆ†é’Ÿ
    refreshTokenTTL: 60 * 60,       // 1å°æ—¶  
    requireReauth: true             // éœ€è¦é‡æ–°è®¤è¯
  },
  
  // ä¸­ç­‰å®‰å…¨ç­‰çº§ï¼ˆä¸€èˆ¬ç³»ç»Ÿï¼‰
  MEDIUM_SECURITY: {
    accessTokenTTL: 2 * 60 * 60,    // 2å°æ—¶
    refreshTokenTTL: 24 * 60 * 60,  // 24å°æ—¶
    requireReauth: false
  },
  
  // ä½å®‰å…¨ç­‰çº§ï¼ˆå†…éƒ¨ç³»ç»Ÿï¼‰
  LOW_SECURITY: {
    accessTokenTTL: 8 * 60 * 60,    // 8å°æ—¶
    refreshTokenTTL: 7 * 24 * 60 * 60, // 7å¤©
    requireReauth: false
  }
};
```

### 6.3 ç”¨æˆ·ä¿¡æ¯ç­›é€‰åŸåˆ™


**åŒ…å«ä¿¡æ¯çš„é€‰æ‹©æ ‡å‡†**ï¼š

> ğŸ¯ **æ ¸å¿ƒåŸåˆ™**ï¼šåªæ”¾**å¿…éœ€çš„**ã€**éæ•æ„Ÿçš„**ã€**éªŒè¯ç”¨çš„**ä¿¡æ¯

```javascript
// âœ… åº”è¯¥åŒ…å«çš„ä¿¡æ¯
const goodPayload = {
  userId: 123,              // ç”¨æˆ·æ ‡è¯† - å¿…éœ€
  roles: ['user'],          // æƒé™è§’è‰² - å¿…éœ€  
  departmentId: 101,        // ä¸šåŠ¡æ ‡è¯† - æŒ‰éœ€
  exp: 1691926800          // è¿‡æœŸæ—¶é—´ - å¿…éœ€
};

// âŒ ä¸åº”è¯¥åŒ…å«çš„ä¿¡æ¯
const badPayload = {
  password: "123456",       // å¯†ç  - ç»å¯¹ä¸èƒ½æ”¾
  idCard: "110101199001011234", // èº«ä»½è¯ - éšç§æ•æ„Ÿ
  bankAccount: "6222021234567890", // é“¶è¡Œå¡ - è´¢åŠ¡æ•æ„Ÿ
  fullUserInfo: {...}       // å®Œæ•´ç”¨æˆ·ä¿¡æ¯ - æ•°æ®è¿‡å¤š
};
```

---

## 7. ğŸ’» å®é™…åº”ç”¨ç¤ºä¾‹


### 7.1 å®Œæ•´Tokenç”Ÿæˆæµç¨‹


```javascript
const jwt = require('jsonwebtoken');
const crypto = require('crypto');

class TokenService {
  constructor() {
    this.secretKey = process.env.JWT_SECRET || 'defaultSecret123';
    this.algorithm = 'HS256';
  }
  
  // ğŸ”¥ æ ¸å¿ƒæ–¹æ³•ï¼šç”ŸæˆToken
  generateToken(userInfo, options = {}) {
    const now = Math.floor(Date.now() / 1000);
    
    // 1ï¸âƒ£ æ„å»ºpayload
    const payload = {
      // ç”¨æˆ·ä¿¡æ¯ï¼ˆå¿…éœ€ï¼‰
      userId: userInfo.userId,
      username: userInfo.username,
      roles: userInfo.roles || ['user'],
      
      // æ—¶é—´ä¿¡æ¯ï¼ˆå¿…éœ€ï¼‰
      iat: now,                                    // ç­¾å‘æ—¶é—´
      exp: now + (options.expiresIn || 3600),      // è¿‡æœŸæ—¶é—´
      
      // å”¯ä¸€æ€§ä¿¡æ¯ï¼ˆå¿…éœ€ï¼‰
      jti: crypto.randomUUID(),                    // JWT ID
      
      // ä¸šåŠ¡ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
      deviceId: options.deviceId,
      clientIp: options.clientIp
    };
    
    // 2ï¸âƒ£ ç”ŸæˆToken
    const token = jwt.sign(payload, this.secretKey, {
      algorithm: this.algorithm,
      header: {
        typ: 'JWT',
        alg: this.algorithm
      }
    });
    
    return {
      accessToken: token,
      tokenType: 'Bearer',
      expiresIn: options.expiresIn || 3600,
      expiresAt: payload.exp
    };
  }
  
  // ğŸ” éªŒè¯Token
  verifyToken(token) {
    try {
      const decoded = jwt.verify(token, this.secretKey);
      
      // é¢å¤–çš„å®‰å…¨æ£€æŸ¥
      const now = Math.floor(Date.now() / 1000);
      if (decoded.exp < now) {
        throw new Error('Tokenå·²è¿‡æœŸ');
      }
      
      return {
        valid: true,
        payload: decoded
      };
    } catch (error) {
      return {
        valid: false,
        error: error.message
      };
    }
  }
}
```

### 7.2 ä½¿ç”¨ç¤ºä¾‹


```javascript
// ğŸš€ å®é™…ä½¿ç”¨ç¤ºä¾‹
const tokenService = new TokenService();

// ç”¨æˆ·ç™»å½•æˆåŠŸåç”ŸæˆToken
async function loginUser(username, password) {
  // 1. éªŒè¯ç”¨æˆ·åå¯†ç ï¼ˆçœç•¥å…·ä½“å®ç°ï¼‰
  const user = await authenticateUser(username, password);
  
  if (!user) {
    throw new Error('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯');
  }
  
  // 2. ç”ŸæˆToken
  const tokenResult = tokenService.generateToken({
    userId: user.id,
    username: user.username,
    roles: user.roles
  }, {
    expiresIn: 2 * 60 * 60,  // 2å°æ—¶
    deviceId: 'web_browser_001',
    clientIp: '192.168.1.100'
  });
  
  console.log('ğŸ‰ Tokenç”ŸæˆæˆåŠŸ:', tokenResult);
  return tokenResult;
}

// APIè¯·æ±‚éªŒè¯Token
function authenticateRequest(req, res, next) {
  const authHeader = req.headers.authorization;
  
  if (!authHeader || !authHeader.startsWith('Bearer ')) {
    return res.status(401).json({ error: 'ç¼ºå°‘Token' });
  }
  
  const token = authHeader.substring(7);
  const verifyResult = tokenService.verifyToken(token);
  
  if (!verifyResult.valid) {
    return res.status(401).json({ error: 'Tokenæ— æ•ˆ: ' + verifyResult.error });
  }
  
  // Tokenæœ‰æ•ˆï¼Œå°†ç”¨æˆ·ä¿¡æ¯æ·»åŠ åˆ°è¯·æ±‚ä¸­
  req.user = verifyResult.payload;
  next();
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„å…³é”®æ¦‚å¿µ


```
ğŸ”¸ Tokenæœ¬è´¨ï¼šåŠ å¯†çš„æ•°å­—å‡­è¯ï¼ŒåŒ…å«èº«ä»½ä¿¡æ¯å’Œæ—¶é—´æ§åˆ¶
ğŸ”¸ ä¸‰å¤§è¦ç´ ï¼šç”¨æˆ·èº«ä»½ä¿¡æ¯ + æ—¶é—´æˆ³ä¿¡æ¯ + æ•°å­—ç­¾å
ğŸ”¸ ç­¾åç®—æ³•ï¼šHMAC(ç®€å•å¿«é€Ÿ) > RSA(å®‰å…¨åˆ†å¸ƒå¼) > ECDSA(é«˜æ•ˆç°ä»£)
ğŸ”¸ å®‰å…¨åŸåˆ™ï¼šå”¯ä¸€æ€§ä¿è¯ + é˜²ç¯¡æ”¹æœºåˆ¶ + é€‚å½“çš„è¿‡æœŸæ§åˆ¶
ğŸ”¸ ä¿¡æ¯é€‰æ‹©ï¼šåªæ”¾å¿…éœ€çš„ã€éæ•æ„Ÿçš„ã€ç”¨äºéªŒè¯çš„ä¿¡æ¯
```

### 8.2 å®é™…åº”ç”¨è¦ç‚¹


**ğŸ”¹ Tokenè®¾è®¡ç­–ç•¥**
```
å®‰å…¨æ€§ä¼˜å…ˆï¼š
â€¢ ä½¿ç”¨å¼ºéšæœºæ•°ç”ŸæˆJWT ID
â€¢ è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´
â€¢ é€‰æ‹©å®‰å…¨çš„ç­¾åç®—æ³•
â€¢ ä¸åœ¨Tokenä¸­å­˜æ”¾æ•æ„Ÿä¿¡æ¯

æ€§èƒ½ä¼˜å…ˆï¼š
â€¢ HMACç®—æ³•è®¡ç®—é€Ÿåº¦æœ€å¿«
â€¢ é¿å…Tokenä½“ç§¯è¿‡å¤§
â€¢ åˆç†è®¾ç½®ç¼“å­˜ç­–ç•¥
â€¢ å‡å°‘ä¸å¿…è¦çš„éªŒè¯å¼€é”€
```

**ğŸ”¹ å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ**

| é—®é¢˜åœºæ™¯ | **è§£å†³æ–¹æ¡ˆ** | **æ ¸å¿ƒè¦ç‚¹** |
|---------|-------------|-------------|
| **Tokenæ³„éœ²** | ç¼©çŸ­æœ‰æ•ˆæœŸ+IPç»‘å®š | é™åˆ¶Tokenä½¿ç”¨èŒƒå›´ |
| **æ€§èƒ½é—®é¢˜** | é€‰ç”¨HMAC+æœ¬åœ°éªŒè¯ | é¿å…æ¯æ¬¡éªŒè¯éƒ½æŸ¥æ•°æ®åº“ |
| **åˆ†å¸ƒå¼éƒ¨ç½²** | ä½¿ç”¨RSA+å…¬é’¥åˆ†å‘ | å„æœåŠ¡ç‹¬ç«‹éªŒè¯ |
| **ç§»åŠ¨ç«¯æ”¯æŒ** | é•¿æœŸToken+åˆ·æ–°æœºåˆ¶ | ç”¨æˆ·ä½“éªŒä¸å®‰å…¨å¹³è¡¡ |

### 8.3 æœ€ä½³å®è·µå»ºè®®


**ğŸ¯ ç”Ÿäº§ç¯å¢ƒé…ç½®å»ºè®®**
```javascript
// æ¨èçš„Tokené…ç½®
const PRODUCTION_CONFIG = {
  // ç®—æ³•é€‰æ‹©
  algorithm: 'HS256',           // å•ä½“åº”ç”¨
  // algorithm: 'RS256',        // å¾®æœåŠ¡æ¶æ„
  
  // æ—¶é—´é…ç½®
  accessTokenTTL: 15 * 60,      // 15åˆ†é’Ÿï¼ˆå®‰å…¨ï¼‰
  refreshTokenTTL: 7 * 24 * 3600, // 7å¤©ï¼ˆä¾¿åˆ©ï¼‰
  
  // å®‰å…¨é…ç½®
  issuer: 'your-app-name',      // ç­¾å‘è€…
  audience: 'your-users',       // ç›®æ ‡ç”¨æˆ·
  
  // é¢å¤–æ ¡éªŒ
  ipBinding: true,              // IPåœ°å€ç»‘å®š
  deviceFingerprint: true       // è®¾å¤‡æŒ‡çº¹
};
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- Token = èº«ä»½ä¿¡æ¯ + æ—¶é—´æ§åˆ¶ + æ•°å­—ç­¾å
- å®‰å…¨æ€§ï¼šéšæœºæ€§ + é˜²ç¯¡æ”¹ + é€‚åº¦è¿‡æœŸ
- æ€§èƒ½ï¼šé€‰å¯¹ç®—æ³• + æ§åˆ¶å¤§å° + åˆç†ç¼“å­˜
- å®ç”¨æ€§ï¼šå¿…éœ€ä¿¡æ¯ + ä¸šåŠ¡é€‚é… + ç”¨æˆ·ä½“éªŒ