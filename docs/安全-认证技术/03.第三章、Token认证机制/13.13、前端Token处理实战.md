---
title: 13ã€å‰ç«¯Tokenå¤„ç†å®æˆ˜
---
## ğŸ“š ç›®å½•

1. [Tokenè®¤è¯æœºåˆ¶åŸºç¡€](#1-Tokenè®¤è¯æœºåˆ¶åŸºç¡€)
2. [HTTPè¯·æ±‚å¤´è®¾ç½®](#2-HTTPè¯·æ±‚å¤´è®¾ç½®)
3. [è¯·æ±‚æ‹¦æˆªå™¨é…ç½®](#3-è¯·æ±‚æ‹¦æˆªå™¨é…ç½®)
4. [å“åº”æ‹¦æˆªå™¨å¤„ç†](#4-å“åº”æ‹¦æˆªå™¨å¤„ç†)
5. [Tokenè‡ªåŠ¨åˆ·æ–°å‰ç«¯å®ç°](#5-Tokenè‡ªåŠ¨åˆ·æ–°å‰ç«¯å®ç°)
6. [ç™»å½•çŠ¶æ€ç®¡ç†](#6-ç™»å½•çŠ¶æ€ç®¡ç†)
7. [Axiosæ‹¦æˆªå™¨é…ç½®å®ä¾‹](#7-Axiosæ‹¦æˆªå™¨é…ç½®å®ä¾‹)
8. [ä¼˜é›…çš„ç™»å½•è·³è½¬](#8-ä¼˜é›…çš„ç™»å½•è·³è½¬)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” Tokenè®¤è¯æœºåˆ¶åŸºç¡€


### 1.1 ä»€ä¹ˆæ˜¯Tokenè®¤è¯


**ç®€å•ç†è§£**ï¼šTokenå°±åƒæ˜¯ä¸€å¼ **ç”µå­é—¨ç¥¨**
```
ä¼ ç»Ÿè®¤è¯æµç¨‹ï¼š
ç”¨æˆ·ç™»å½• â†’ æœåŠ¡å™¨éªŒè¯ â†’ ç”ŸæˆSession â†’ å­˜å‚¨åœ¨æœåŠ¡å™¨ â†’ è¿”å›SessionIDç»™å®¢æˆ·ç«¯

Tokenè®¤è¯æµç¨‹ï¼š
ç”¨æˆ·ç™»å½• â†’ æœåŠ¡å™¨éªŒè¯ â†’ ç”ŸæˆToken â†’ ç›´æ¥è¿”å›ç»™å®¢æˆ·ç«¯ â†’ å®¢æˆ·ç«¯æ¯æ¬¡è¯·æ±‚éƒ½å¸¦ä¸ŠToken
```

**Tokençš„æœ¬è´¨**ï¼š
- ğŸ« **èº«ä»½å‡­è¯**ï¼šè¯æ˜"ä½ æ˜¯è°"çš„ç”µå­å‡­è¯
- ğŸ“ **åŒ…å«ä¿¡æ¯**ï¼šé€šå¸¸åŒ…å«ç”¨æˆ·IDã€æƒé™ã€è¿‡æœŸæ—¶é—´ç­‰
- ğŸ”’ **åŠ å¯†ç­¾å**ï¼šé˜²æ­¢è¢«ç¯¡æ”¹çš„å®‰å…¨ä¿éšœ
- â° **æœ‰æ—¶æ•ˆæ€§**ï¼šä¼šè¿‡æœŸï¼Œéœ€è¦åˆ·æ–°æˆ–é‡æ–°ç™»å½•

### 1.2 ä¸ºä»€ä¹ˆå‰ç«¯è¦å¤„ç†Token


```
å‰ç«¯éœ€è¦åšçš„äº‹æƒ…ï¼š
1. å­˜å‚¨Tokenï¼šç™»å½•æˆåŠŸåå®‰å…¨å­˜å‚¨
2. æºå¸¦Tokenï¼šæ¯æ¬¡è¯·æ±‚è‡ªåŠ¨æ·»åŠ åˆ°è¯·æ±‚å¤´
3. ç›‘æ§Tokenï¼šæ£€æµ‹è¿‡æœŸå¹¶å¤„ç†
4. åˆ·æ–°Tokenï¼šè¿‡æœŸå‰è‡ªåŠ¨æ›´æ–°
5. æ¸…ç†Tokenï¼šç™»å‡ºæ—¶æ¸…é™¤æ‰€æœ‰ç—•è¿¹
```

**ç°å®åœºæ™¯ç±»æ¯”**ï¼š
```
å°±åƒä½ å»å…¬å¸ä¸Šç­ï¼š
1. é—¨å¡å……å€¼ï¼ˆè·å–Tokenï¼‰
2. è¿›é—¨åˆ·å¡ï¼ˆè¯·æ±‚å¸¦Tokenï¼‰
3. å¡ç‰‡è¿‡æœŸæé†’ï¼ˆTokenè¿‡æœŸæ£€æµ‹ï¼‰
4. è‡ªåŠ¨ç»­è´¹ï¼ˆTokenåˆ·æ–°ï¼‰
5. ç¦»èŒäº¤å¡ï¼ˆç™»å‡ºæ¸…ç†ï¼‰
```

---

## 2. ğŸ“¡ HTTPè¯·æ±‚å¤´è®¾ç½®


### 2.1 Authorizationè¯·æ±‚å¤´è¯¦è§£


**åŸºæœ¬æ¦‚å¿µ**ï¼š`Authorization`æ˜¯HTTPæ ‡å‡†è¯·æ±‚å¤´ï¼Œä¸“é—¨ç”¨äºæºå¸¦è®¤è¯ä¿¡æ¯

```javascript
// æœ€ç®€å•çš„Tokenè®¾ç½®æ–¹å¼
const token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'

// æ ‡å‡†çš„Bearer Tokenæ ¼å¼
headers: {
  'Authorization': `Bearer ${token}`
}
```

### 2.2 ä¸ºä»€ä¹ˆè¦ç”¨Bearerå‰ç¼€


**Bearerçš„å«ä¹‰**ï¼š
- ğŸ“œ **Bearer** = "æŒæœ‰è€…"çš„æ„æ€
- ğŸ« è¡¨ç¤º"è°æ‹¿ç€è¿™ä¸ªTokenï¼Œè°å°±æœ‰æƒé™"
- ğŸ”’ è¿™æ˜¯OAuth2.0æ ‡å‡†è§„å®šçš„æ ¼å¼

```javascript
// âŒ é”™è¯¯å†™æ³•
'Authorization': token

// âœ… æ­£ç¡®å†™æ³•  
'Authorization': `Bearer ${token}`

// ğŸ” å®é™…æ•ˆæœ
// è¯·æ±‚å¤´ä¼šå˜æˆï¼šAuthorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### 2.3 æ‰‹åŠ¨è®¾ç½®è¯·æ±‚å¤´çš„æ–¹å¼


**æ–¹å¼ä¸€ï¼šå•æ¬¡è¯·æ±‚è®¾ç½®**
```javascript
// ä½¿ç”¨fetch
fetch('/api/userinfo', {
  method: 'GET',
  headers: {
    'Authorization': `Bearer ${localStorage.getItem('token')}`,
    'Content-Type': 'application/json'
  }
})

// ä½¿ç”¨axios
axios.get('/api/userinfo', {
  headers: {
    'Authorization': `Bearer ${token}`
  }
})
```

**æ–¹å¼äºŒï¼šå…¨å±€é»˜è®¤è®¾ç½®**
```javascript
// è®¾ç½®axioså…¨å±€é»˜è®¤è¯·æ±‚å¤´
axios.defaults.headers.common['Authorization'] = `Bearer ${token}`

// æˆ–è€…è®¾ç½®ç‰¹å®šç±»å‹è¯·æ±‚çš„é»˜è®¤å¤´
axios.defaults.headers.post['Authorization'] = `Bearer ${token}`
```

### 2.4 åŠ¨æ€è®¾ç½®è¯·æ±‚å¤´


```javascript
// è·å–å½“å‰æœ‰æ•ˆçš„Token
function getValidToken() {
  const token = localStorage.getItem('token')
  const expireTime = localStorage.getItem('tokenExpire')
  
  // æ£€æŸ¥Tokenæ˜¯å¦è¿‡æœŸ
  if (!token || !expireTime || Date.now() > expireTime) {
    return null
  }
  return token
}

// åŠ¨æ€è®¾ç½®è¯·æ±‚å¤´
function makeAuthenticatedRequest(url, options = {}) {
  const token = getValidToken()
  
  if (!token) {
    // æ²¡æœ‰æœ‰æ•ˆTokenï¼Œè·³è½¬ç™»å½•
    window.location.href = '/login'
    return
  }
  
  // è®¾ç½®è®¤è¯å¤´
  const headers = {
    ...options.headers,
    'Authorization': `Bearer ${token}`
  }
  
  return fetch(url, { ...options, headers })
}
```

---

## 3. ğŸ”§ è¯·æ±‚æ‹¦æˆªå™¨é…ç½®


### 3.1 ä»€ä¹ˆæ˜¯è¯·æ±‚æ‹¦æˆªå™¨


**å½¢è±¡ç†è§£**ï¼šæ‹¦æˆªå™¨å°±åƒæ˜¯**å®‰æ£€é—¨**
```
æ­£å¸¸æµç¨‹ï¼šç”¨æˆ·å‘èµ·è¯·æ±‚ â†’ ç›´æ¥å‘é€åˆ°æœåŠ¡å™¨
ä½¿ç”¨æ‹¦æˆªå™¨ï¼šç”¨æˆ·å‘èµ·è¯·æ±‚ â†’ æ‹¦æˆªå™¨å¤„ç† â†’ æ·»åŠ Token â†’ å‘é€åˆ°æœåŠ¡å™¨

å°±åƒæœºåœºå®‰æ£€ï¼š
ä¹˜å®¢å‡†å¤‡ç™»æœº â†’ å®‰æ£€é—¨æ£€æŸ¥ â†’ åˆæ ¼æ”¾è¡Œ â†’ ç™»æœº
ç”¨æˆ·å‘èµ·è¯·æ±‚ â†’ è¯·æ±‚æ‹¦æˆªå™¨ â†’ æ·»åŠ Token â†’ å‘é€è¯·æ±‚
```

### 3.2 Axiosè¯·æ±‚æ‹¦æˆªå™¨åŸºç¡€é…ç½®


```javascript
// åˆ›å»ºaxioså®ä¾‹
const apiClient = axios.create({
  baseURL: 'https://api.example.com',
  timeout: 10000
})

// è¯·æ±‚æ‹¦æˆªå™¨ï¼šåœ¨æ¯ä¸ªè¯·æ±‚å‘é€å‰æ‰§è¡Œ
apiClient.interceptors.request.use(
  (config) => {
    // è¿™é‡Œçš„configå°±æ˜¯è¯·æ±‚é…ç½®å¯¹è±¡
    console.log('å‡†å¤‡å‘é€è¯·æ±‚:', config.url)
    
    // ä»æœ¬åœ°å­˜å‚¨è·å–Token
    const token = localStorage.getItem('token')
    
    if (token) {
      // è‡ªåŠ¨æ·»åŠ Authorizationå¤´
      config.headers.Authorization = `Bearer ${token}`
    }
    
    // å¿…é¡»è¿”å›configï¼Œå¦åˆ™è¯·æ±‚æ— æ³•å‘é€
    return config
  },
  (error) => {
    // è¯·æ±‚é…ç½®å‡ºé”™æ—¶çš„å¤„ç†
    console.error('è¯·æ±‚é…ç½®é”™è¯¯:', error)
    return Promise.reject(error)
  }
)
```

### 3.3 æ™ºèƒ½Tokenç®¡ç†çš„è¯·æ±‚æ‹¦æˆªå™¨


```javascript
// æ›´æ™ºèƒ½çš„è¯·æ±‚æ‹¦æˆªå™¨
apiClient.interceptors.request.use((config) => {
  // 1. è·å–Tokenä¿¡æ¯
  const token = localStorage.getItem('token')
  const refreshToken = localStorage.getItem('refreshToken')
  const tokenExpire = localStorage.getItem('tokenExpire')
  
  // 2. æ£€æŸ¥æ˜¯å¦éœ€è¦Tokençš„æ¥å£
  const needAuth = !config.url.includes('/login') && 
                   !config.url.includes('/register') &&
                   !config.url.includes('/public')
  
  if (needAuth && token) {
    // 3. æ£€æŸ¥Tokenæ˜¯å¦å³å°†è¿‡æœŸï¼ˆæå‰5åˆ†é’Ÿåˆ·æ–°ï¼‰
    const now = Date.now()
    const expireTime = parseInt(tokenExpire)
    const fiveMinutes = 5 * 60 * 1000
    
    if (expireTime - now < fiveMinutes && refreshToken) {
      // Tokenå³å°†è¿‡æœŸï¼Œæ ‡è®°éœ€è¦åˆ·æ–°
      config.headers['X-Token-Refresh-Needed'] = 'true'
    }
    
    // 4. æ·»åŠ Authorizationå¤´
    config.headers.Authorization = `Bearer ${token}`
  }
  
  // 5. æ·»åŠ å…¶ä»–é€šç”¨å¤´ä¿¡æ¯
  config.headers['X-Timestamp'] = Date.now()
  config.headers['X-Client-Version'] = '1.0.0'
  
  return config
})
```

### 3.4 è¯·æ±‚æ‹¦æˆªå™¨çš„å®ç”¨æŠ€å·§


**æŠ€å·§ä¸€ï¼šæ ¹æ®ç¯å¢ƒåŠ¨æ€è®¾ç½®**
```javascript
apiClient.interceptors.request.use((config) => {
  // å¼€å‘ç¯å¢ƒæ·»åŠ è°ƒè¯•ä¿¡æ¯
  if (process.env.NODE_ENV === 'development') {
    config.headers['X-Debug'] = 'true'
    console.log('ğŸš€ å‘é€è¯·æ±‚:', config.method?.toUpperCase(), config.url)
  }
  
  return config
})
```

**æŠ€å·§äºŒï¼šè¯·æ±‚å»é‡å¤„ç†**
```javascript
const pendingRequests = new Map()

apiClient.interceptors.request.use((config) => {
  // ç”Ÿæˆè¯·æ±‚å”¯ä¸€æ ‡è¯†
  const requestKey = `${config.method}_${config.url}_${JSON.stringify(config.params || {})}`
  
  // æ£€æŸ¥æ˜¯å¦æœ‰ç›¸åŒçš„è¯·æ±‚æ­£åœ¨è¿›è¡Œ
  if (pendingRequests.has(requestKey)) {
    // å–æ¶ˆé‡å¤è¯·æ±‚
    config.cancelToken = new axios.CancelToken((cancel) => {
      cancel('é‡å¤çš„è¯·æ±‚è¢«å–æ¶ˆ')
    })
  } else {
    // è®°å½•è¯·æ±‚
    pendingRequests.set(requestKey, true)
  }
  
  return config
})
```

---

## 4. ğŸ”„ å“åº”æ‹¦æˆªå™¨å¤„ç†


### 4.1 ä»€ä¹ˆæ˜¯å“åº”æ‹¦æˆªå™¨


**å½¢è±¡ç†è§£**ï¼šå“åº”æ‹¦æˆªå™¨å°±åƒæ˜¯**å¿«é€’ç­¾æ”¶å¤„**
```
æ­£å¸¸æµç¨‹ï¼šæœåŠ¡å™¨è¿”å›æ•°æ® â†’ ç›´æ¥ç»™ç”¨æˆ·
ä½¿ç”¨æ‹¦æˆªå™¨ï¼šæœåŠ¡å™¨è¿”å›æ•°æ® â†’ å“åº”æ‹¦æˆªå™¨æ£€æŸ¥ â†’ å¤„ç†åç»™ç”¨æˆ·

å°±åƒå¿«é€’æµç¨‹ï¼š
å¿«é€’åˆ°è¾¾ â†’ ç­¾æ”¶å‘˜æ£€æŸ¥ â†’ ç¡®è®¤æ— è¯¯ â†’ äº¤ç»™æ”¶ä»¶äºº
æœåŠ¡å™¨å“åº” â†’ å“åº”æ‹¦æˆªå™¨ â†’ æ£€æŸ¥çŠ¶æ€ â†’ è¿”å›ç»™è°ƒç”¨è€…
```

### 4.2 åŸºç¡€å“åº”æ‹¦æˆªå™¨é…ç½®


```javascript
// å“åº”æ‹¦æˆªå™¨ï¼šåœ¨æ”¶åˆ°å“åº”åæ‰§è¡Œ
apiClient.interceptors.response.use(
  (response) => {
    // 2xx çŠ¶æ€ç ä¼šè¿›å…¥è¿™é‡Œ
    console.log('æ”¶åˆ°å“åº”:', response.status)
    
    // é€šå¸¸åªè¿”å›dataéƒ¨åˆ†ï¼Œç®€åŒ–ä½¿ç”¨
    return response.data
  },
  (error) => {
    // é2xxçŠ¶æ€ç ä¼šè¿›å…¥è¿™é‡Œ
    console.error('å“åº”é”™è¯¯:', error.response?.status)
    
    // ç»Ÿä¸€é”™è¯¯å¤„ç†
    if (error.response?.status === 401) {
      // Tokenè¿‡æœŸæˆ–æ— æ•ˆ
      localStorage.removeItem('token')
      window.location.href = '/login'
    }
    
    return Promise.reject(error)
  }
)
```

### 4.3 å®Œæ•´çš„Tokenè¿‡æœŸå¤„ç†


```javascript
apiClient.interceptors.response.use(
  (response) => response.data,
  async (error) => {
    const originalRequest = error.config
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯Tokenè¿‡æœŸé”™è¯¯
    if (error.response?.status === 401 && !originalRequest._retry) {
      originalRequest._retry = true // æ ‡è®°é¿å…æ— é™é‡è¯•
      
      try {
        // å°è¯•åˆ·æ–°Token
        const refreshToken = localStorage.getItem('refreshToken')
        if (refreshToken) {
          const response = await axios.post('/api/refresh-token', {
            refreshToken: refreshToken
          })
          
          const { token, refreshToken: newRefreshToken } = response.data
          
          // æ›´æ–°æœ¬åœ°å­˜å‚¨
          localStorage.setItem('token', token)
          localStorage.setItem('refreshToken', newRefreshToken)
          
          // æ›´æ–°åŸè¯·æ±‚çš„Authorizationå¤´
          originalRequest.headers.Authorization = `Bearer ${token}`
          
          // é‡æ–°å‘é€åŸè¯·æ±‚
          return apiClient(originalRequest)
        }
      } catch (refreshError) {
        // åˆ·æ–°Tokenå¤±è´¥ï¼Œè·³è½¬ç™»å½•
        console.error('Tokenåˆ·æ–°å¤±è´¥:', refreshError)
        localStorage.clear()
        window.location.href = '/login'
      }
    }
    
    return Promise.reject(error)
  }
)
```

### 4.4 å“åº”æ•°æ®æ ‡å‡†åŒ–å¤„ç†


```javascript
apiClient.interceptors.response.use(
  (response) => {
    const { data } = response
    
    // å‡è®¾åç«¯è¿”å›æ ¼å¼ï¼š{ code: 200, data: {...}, message: 'success' }
    if (data.code === 200) {
      return data.data // åªè¿”å›æœ‰ç”¨çš„æ•°æ®
    } else {
      // ä¸šåŠ¡é”™è¯¯å¤„ç†
      throw new Error(data.message || 'è¯·æ±‚å¤±è´¥')
    }
  },
  (error) => {
    // ç½‘ç»œé”™è¯¯å¤„ç†
    let errorMessage = 'ç½‘ç»œé”™è¯¯'
    
    if (error.response) {
      switch (error.response.status) {
        case 400:
          errorMessage = 'è¯·æ±‚å‚æ•°é”™è¯¯'
          break
        case 401:
          errorMessage = 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•'
          // æ¸…ç†æœ¬åœ°æ•°æ®å¹¶è·³è½¬
          localStorage.clear()
          window.location.href = '/login'
          break
        case 403:
          errorMessage = 'æ²¡æœ‰æƒé™è®¿é—®'
          break
        case 404:
          errorMessage = 'è¯·æ±‚çš„èµ„æºä¸å­˜åœ¨'
          break
        case 500:
          errorMessage = 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
          break
        default:
          errorMessage = error.response.data?.message || 'è¯·æ±‚å¤±è´¥'
      }
    }
    
    // æ˜¾ç¤ºé”™è¯¯æç¤ºï¼ˆå‡è®¾ä½¿ç”¨äº†æ¶ˆæ¯æç¤ºç»„ä»¶ï¼‰
    // Message.error(errorMessage)
    
    return Promise.reject(new Error(errorMessage))
  }
)
```

---

## 5. ğŸ”„ Tokenè‡ªåŠ¨åˆ·æ–°å‰ç«¯å®ç°


### 5.1 ä»€ä¹ˆæ˜¯Tokenè‡ªåŠ¨åˆ·æ–°


**ç”Ÿæ´»åœºæ™¯ç±»æ¯”**ï¼š
```
å¥èº«å¡ç»­è´¹ï¼š
- æ™®é€šæ–¹å¼ï¼šç­‰å¡è¿‡æœŸäº†å†å»ç»­è´¹ï¼ŒæœŸé—´æ— æ³•å¥èº«
- è‡ªåŠ¨ç»­è´¹ï¼šå¿«åˆ°æœŸæ—¶è‡ªåŠ¨ç»­è´¹ï¼Œæ— éœ€ä¸­æ–­

Tokenåˆ·æ–°ï¼š
- æ™®é€šæ–¹å¼ï¼šç­‰Tokenè¿‡æœŸäº†ç”¨æˆ·é‡æ–°ç™»å½•
- è‡ªåŠ¨åˆ·æ–°ï¼šTokenå¿«è¿‡æœŸæ—¶è‡ªåŠ¨è·å–æ–°çš„Token
```

**Tokenåˆ·æ–°çš„å¥½å¤„**ï¼š
- ğŸ¯ **ç”¨æˆ·ä½“éªŒå¥½**ï¼šç”¨æˆ·æ— æ„ŸçŸ¥ï¼Œä¸ä¼šçªç„¶è·³è½¬ç™»å½•é¡µ
- ğŸ”’ **å®‰å…¨æ€§é«˜**ï¼šTokenæœ‰æ•ˆæœŸçŸ­ï¼Œé™ä½è¢«ç›—ç”¨é£é™©
- âš¡ **æ•ˆç‡é«˜**ï¼šé¿å…é¢‘ç¹ç™»å½•æ“ä½œ

### 5.2 Tokenåˆ·æ–°çš„åŸºæœ¬åŸç†


```
Tokenä½“ç³»ç»„æˆï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Access Token  â”‚  â”‚  Refresh Token  â”‚
â”‚   (è®¿é—®ä»¤ç‰Œ)     â”‚  â”‚   (åˆ·æ–°ä»¤ç‰Œ)     â”‚
â”‚                 â”‚  â”‚                 â”‚
â”‚ - æœ‰æ•ˆæœŸçŸ­(15åˆ†é’Ÿ)â”‚  â”‚ - æœ‰æ•ˆæœŸé•¿(7å¤©)  â”‚
â”‚ - ç”¨äºAPIè°ƒç”¨    â”‚  â”‚ - ç”¨äºè·å–æ–°Tokenâ”‚
â”‚ - æºå¸¦ç”¨æˆ·ä¿¡æ¯   â”‚  â”‚ - åªèƒ½åˆ·æ–°ç”¨é€”   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åˆ·æ–°æµç¨‹**ï¼š
```
1. æ£€æµ‹Access Tokenå³å°†è¿‡æœŸ
2. ä½¿ç”¨Refresh Tokenå‘æœåŠ¡å™¨è¯·æ±‚
3. æœåŠ¡å™¨éªŒè¯Refresh Token
4. è¿”å›æ–°çš„Access Tokenå’ŒRefresh Token
5. æ›´æ–°æœ¬åœ°å­˜å‚¨
6. ç»§ç»­åŸæ¥çš„è¯·æ±‚
```

### 5.3 åŸºç¡€Tokenåˆ·æ–°å®ç°


```javascript
class TokenManager {
  constructor() {
    this.isRefreshing = false // é˜²æ­¢åŒæ—¶å¤šä¸ªåˆ·æ–°è¯·æ±‚
    this.failedQueue = [] // å­˜å‚¨åˆ·æ–°æœŸé—´çš„å¤±è´¥è¯·æ±‚
  }
  
  // æ£€æŸ¥Tokenæ˜¯å¦éœ€è¦åˆ·æ–°
  needsRefresh() {
    const token = localStorage.getItem('token')
    const expireTime = localStorage.getItem('tokenExpire')
    
    if (!token || !expireTime) return false
    
    // æå‰5åˆ†é’Ÿåˆ·æ–°
    const now = Date.now()
    const fiveMinutes = 5 * 60 * 1000
    
    return (expireTime - now) < fiveMinutes
  }
  
  // æ‰§è¡ŒTokenåˆ·æ–°
  async refreshToken() {
    if (this.isRefreshing) {
      // å¦‚æœæ­£åœ¨åˆ·æ–°ï¼Œè¿”å›ä¸€ä¸ªPromiseç­‰å¾…åˆ·æ–°å®Œæˆ
      return new Promise((resolve, reject) => {
        this.failedQueue.push({ resolve, reject })
      })
    }
    
    this.isRefreshing = true
    
    try {
      const refreshToken = localStorage.getItem('refreshToken')
      if (!refreshToken) {
        throw new Error('æ²¡æœ‰åˆ·æ–°ä»¤ç‰Œ')
      }
      
      const response = await axios.post('/api/refresh-token', {
        refreshToken: refreshToken
      })
      
      const { token, refreshToken: newRefreshToken, expireTime } = response.data
      
      // æ›´æ–°æœ¬åœ°å­˜å‚¨
      localStorage.setItem('token', token)
      localStorage.setItem('refreshToken', newRefreshToken)
      localStorage.setItem('tokenExpire', expireTime)
      
      // å¤„ç†ç­‰å¾…é˜Ÿåˆ—ä¸­çš„è¯·æ±‚
      this.failedQueue.forEach(({ resolve }) => {
        resolve(token)
      })
      this.failedQueue = []
      
      return token
    } catch (error) {
      // åˆ·æ–°å¤±è´¥ï¼Œå¤„ç†ç­‰å¾…é˜Ÿåˆ—
      this.failedQueue.forEach(({ reject }) => {
        reject(error)
      })
      this.failedQueue = []
      
      // æ¸…ç†å­˜å‚¨ï¼Œè·³è½¬ç™»å½•
      localStorage.clear()
      window.location.href = '/login'
      
      throw error
    } finally {
      this.isRefreshing = false
    }
  }
}

// å…¨å±€Tokenç®¡ç†å™¨å®ä¾‹
const tokenManager = new TokenManager()
```

### 5.4 ç»“åˆæ‹¦æˆªå™¨çš„è‡ªåŠ¨åˆ·æ–°


```javascript
// åœ¨è¯·æ±‚æ‹¦æˆªå™¨ä¸­æ£€æŸ¥Token
apiClient.interceptors.request.use(async (config) => {
  // æ£€æŸ¥æ˜¯å¦éœ€è¦Token
  if (config.url.includes('/login') || config.url.includes('/register')) {
    return config
  }
  
  // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ·æ–°
  if (tokenManager.needsRefresh()) {
    try {
      await tokenManager.refreshToken()
    } catch (error) {
      // åˆ·æ–°å¤±è´¥ï¼Œå¯èƒ½è·³è½¬åˆ°ç™»å½•é¡µäº†
      return Promise.reject(error)
    }
  }
  
  // æ·»åŠ æœ€æ–°çš„Token
  const token = localStorage.getItem('token')
  if (token) {
    config.headers.Authorization = `Bearer ${token}`
  }
  
  return config
})
```

### 5.5 å®šæ—¶åˆ·æ–°ç­–ç•¥


```javascript
class AutoRefreshManager extends TokenManager {
  constructor() {
    super()
    this.refreshTimer = null
    this.startAutoRefresh()
  }
  
  // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°å®šæ—¶å™¨
  startAutoRefresh() {
    this.clearAutoRefresh()
    
    // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    this.refreshTimer = setInterval(() => {
      if (this.needsRefresh()) {
        this.refreshToken().catch(() => {
          // é™é»˜å¤„ç†é”™è¯¯ï¼Œé¿å…å¹²æ‰°ç”¨æˆ·
        })
      }
    }, 60000) // 60ç§’æ£€æŸ¥ä¸€æ¬¡
  }
  
  // æ¸…ç†å®šæ—¶å™¨
  clearAutoRefresh() {
    if (this.refreshTimer) {
      clearInterval(this.refreshTimer)
      this.refreshTimer = null
    }
  }
  
  // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶çš„å¤„ç†
  handleVisibilityChange() {
    if (document.visibilityState === 'visible') {
      // é¡µé¢é‡æ–°å¯è§æ—¶æ£€æŸ¥Token
      if (this.needsRefresh()) {
        this.refreshToken().catch(() => {})
      }
    }
  }
}

// å¯ç”¨è‡ªåŠ¨åˆ·æ–°
const autoRefreshManager = new AutoRefreshManager()

// ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–
document.addEventListener('visibilitychange', () => {
  autoRefreshManager.handleVisibilityChange()
})
```

---

## 6. ğŸ“± ç™»å½•çŠ¶æ€ç®¡ç†


### 6.1 ä»€ä¹ˆæ˜¯ç™»å½•çŠ¶æ€ç®¡ç†


**ç®€å•ç†è§£**ï¼šç™»å½•çŠ¶æ€ç®¡ç†å°±æ˜¯**è®°å½•ç”¨æˆ·å½“å‰çš„ç™»å½•æƒ…å†µ**
```
éœ€è¦ç®¡ç†çš„çŠ¶æ€ï¼š
- ğŸ” æ˜¯å¦å·²ç™»å½•
- ğŸ‘¤ å½“å‰ç”¨æˆ·ä¿¡æ¯
- ğŸ« Tokenä¿¡æ¯
- â° ç™»å½•è¿‡æœŸæ—¶é—´
- ğŸ”„ åˆ·æ–°çŠ¶æ€
```

**ä¸ºä»€ä¹ˆéœ€è¦çŠ¶æ€ç®¡ç†**ï¼š
```
å®é™…åœºæ™¯ï¼š
- é¡µé¢åˆ·æ–°åä»ç„¶ä¿æŒç™»å½•çŠ¶æ€
- ä¸åŒé¡µé¢é—´å…±äº«ç”¨æˆ·ä¿¡æ¯
- è‡ªåŠ¨å¤„ç†ç™»å½•è¿‡æœŸ
- ç»Ÿä¸€ç®¡ç†è®¤è¯ç›¸å…³æ•°æ®
```

### 6.2 åŸºç¡€çš„çŠ¶æ€ç®¡ç†å®ç°


```javascript
class AuthStateManager {
  constructor() {
    this.state = {
      isLoggedIn: false,
      user: null,
      token: null,
      refreshToken: null,
      tokenExpire: null
    }
    
    // ä»æœ¬åœ°å­˜å‚¨æ¢å¤çŠ¶æ€
    this.restoreState()
  }
  
  // ä»æœ¬åœ°å­˜å‚¨æ¢å¤ç™»å½•çŠ¶æ€
  restoreState() {
    const token = localStorage.getItem('token')
    const refreshToken = localStorage.getItem('refreshToken')
    const tokenExpire = localStorage.getItem('tokenExpire')
    const userInfo = localStorage.getItem('userInfo')
    
    if (token && tokenExpire && Date.now() < parseInt(tokenExpire)) {
      this.state.isLoggedIn = true
      this.state.token = token
      this.state.refreshToken = refreshToken
      this.state.tokenExpire = tokenExpire
      this.state.user = userInfo ? JSON.parse(userInfo) : null
    }
  }
  
  // è®¾ç½®ç™»å½•çŠ¶æ€
  setLoginState(loginData) {
    const { token, refreshToken, expireTime, user } = loginData
    
    // æ›´æ–°å†…å­˜çŠ¶æ€
    this.state.isLoggedIn = true
    this.state.token = token
    this.state.refreshToken = refreshToken
    this.state.tokenExpire = expireTime
    this.state.user = user
    
    // æŒä¹…åŒ–åˆ°æœ¬åœ°å­˜å‚¨
    localStorage.setItem('token', token)
    localStorage.setItem('refreshToken', refreshToken)
    localStorage.setItem('tokenExpire', expireTime)
    localStorage.setItem('userInfo', JSON.stringify(user))
  }
  
  // æ¸…é™¤ç™»å½•çŠ¶æ€
  clearLoginState() {
    // æ¸…é™¤å†…å­˜çŠ¶æ€
    this.state.isLoggedIn = false
    this.state.token = null
    this.state.refreshToken = null
    this.state.tokenExpire = null
    this.state.user = null
    
    // æ¸…é™¤æœ¬åœ°å­˜å‚¨
    localStorage.removeItem('token')
    localStorage.removeItem('refreshToken')
    localStorage.removeItem('tokenExpire')
    localStorage.removeItem('userInfo')
  }
  
  // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
  isAuthenticated() {
    if (!this.state.token || !this.state.tokenExpire) {
      return false
    }
    
    // æ£€æŸ¥Tokenæ˜¯å¦è¿‡æœŸ
    return Date.now() < parseInt(this.state.tokenExpire)
  }
  
  // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
  getCurrentUser() {
    return this.state.user
  }
  
  // è·å–Token
  getToken() {
    return this.isAuthenticated() ? this.state.token : null
  }
}

// å…¨å±€è®¤è¯çŠ¶æ€ç®¡ç†å™¨
const authState = new AuthStateManager()
```

### 6.3 Vueé¡¹ç›®ä¸­çš„çŠ¶æ€ç®¡ç†


**ä½¿ç”¨Vuex/Piniaç®¡ç†ç™»å½•çŠ¶æ€**ï¼š
```javascript
// store/auth.js
import { defineStore } from 'pinia'

export const useAuthStore = defineStore('auth', {
  state: () => ({
    isLoggedIn: false,
    user: null,
    token: null,
    refreshToken: null
  }),
  
  getters: {
    // æ£€æŸ¥æ˜¯å¦å·²è®¤è¯
    isAuthenticated: (state) => {
      if (!state.token) return false
      
      const expireTime = localStorage.getItem('tokenExpire')
      return expireTime && Date.now() < parseInt(expireTime)
    },
    
    // è·å–ç”¨æˆ·è§’è‰²
    userRole: (state) => state.user?.role || 'guest'
  },
  
  actions: {
    // ç™»å½•æ“ä½œ
    async login(credentials) {
      try {
        const response = await apiClient.post('/api/login', credentials)
        const { token, refreshToken, expireTime, user } = response.data
        
        // æ›´æ–°çŠ¶æ€
        this.isLoggedIn = true
        this.token = token
        this.refreshToken = refreshToken
        this.user = user
        
        // æŒä¹…åŒ–å­˜å‚¨
        localStorage.setItem('token', token)
        localStorage.setItem('refreshToken', refreshToken)
        localStorage.setItem('tokenExpire', expireTime)
        localStorage.setItem('userInfo', JSON.stringify(user))
        
        return { success: true }
      } catch (error) {
        return { success: false, message: error.message }
      }
    },
    
    // ç™»å‡ºæ“ä½œ
    async logout() {
      try {
        // é€šçŸ¥æœåŠ¡å™¨ç™»å‡ºï¼ˆå¯é€‰ï¼‰
        if (this.token) {
          await apiClient.post('/api/logout')
        }
      } catch (error) {
        console.log('ç™»å‡ºè¯·æ±‚å¤±è´¥:', error)
      } finally {
        // æ¸…ç†çŠ¶æ€å’Œå­˜å‚¨
        this.clearAuth()
      }
    },
    
    // æ¸…ç†è®¤è¯ä¿¡æ¯
    clearAuth() {
      this.isLoggedIn = false
      this.token = null
      this.refreshToken = null
      this.user = null
      
      localStorage.clear()
    },
    
    // æ¢å¤ç™»å½•çŠ¶æ€ï¼ˆé¡µé¢åˆ·æ–°æ—¶è°ƒç”¨ï¼‰
    restoreAuth() {
      const token = localStorage.getItem('token')
      const userInfo = localStorage.getItem('userInfo')
      const expireTime = localStorage.getItem('tokenExpire')
      
      if (token && expireTime && Date.now() < parseInt(expireTime)) {
        this.isLoggedIn = true
        this.token = token
        this.refreshToken = localStorage.getItem('refreshToken')
        this.user = userInfo ? JSON.parse(userInfo) : null
      }
    }
  }
})
```

### 6.4 Reacté¡¹ç›®ä¸­çš„çŠ¶æ€ç®¡ç†


**ä½¿ç”¨Context + useReducer**ï¼š
```javascript
// AuthContext.js
import React, { createContext, useContext, useReducer, useEffect } from 'react'

const AuthContext = createContext()

const initialState = {
  isLoggedIn: false,
  user: null,
  token: null,
  loading: true
}

function authReducer(state, action) {
  switch (action.type) {
    case 'LOGIN_SUCCESS':
      return {
        ...state,
        isLoggedIn: true,
        user: action.payload.user,
        token: action.payload.token,
        loading: false
      }
    case 'LOGOUT':
      return {
        ...state,
        isLoggedIn: false,
        user: null,
        token: null,
        loading: false
      }
    case 'RESTORE_AUTH':
      return {
        ...state,
        ...action.payload,
        loading: false
      }
    default:
      return state
  }
}

export function AuthProvider({ children }) {
  const [state, dispatch] = useReducer(authReducer, initialState)
  
  // é¡µé¢åŠ è½½æ—¶æ¢å¤ç™»å½•çŠ¶æ€
  useEffect(() => {
    const token = localStorage.getItem('token')
    const userInfo = localStorage.getItem('userInfo')
    const expireTime = localStorage.getItem('tokenExpire')
    
    if (token && expireTime && Date.now() < parseInt(expireTime)) {
      dispatch({
        type: 'RESTORE_AUTH',
        payload: {
          isLoggedIn: true,
          token: token,
          user: userInfo ? JSON.parse(userInfo) : null
        }
      })
    } else {
      dispatch({ type: 'LOGOUT' })
    }
  }, [])
  
  const login = async (credentials) => {
    try {
      const response = await apiClient.post('/api/login', credentials)
      const { token, refreshToken, expireTime, user } = response.data
      
      // å­˜å‚¨åˆ°æœ¬åœ°
      localStorage.setItem('token', token)
      localStorage.setItem('refreshToken', refreshToken)
      localStorage.setItem('tokenExpire', expireTime)
      localStorage.setItem('userInfo', JSON.stringify(user))
      
      // æ›´æ–°çŠ¶æ€
      dispatch({
        type: 'LOGIN_SUCCESS',
        payload: { token, user }
      })
      
      return { success: true }
    } catch (error) {
      return { success: false, message: error.message }
    }
  }
  
  const logout = () => {
    localStorage.clear()
    dispatch({ type: 'LOGOUT' })
  }
  
  return (
    <AuthContext.Provider value={{
      ...state,
      login,
      logout
    }}>
      {children}
    </AuthContext.Provider>
  )
}

// Hook for using auth context
export const useAuth = () => {
  const context = useContext(AuthContext)
  if (!context) {
    throw new Error('useAuthå¿…é¡»åœ¨AuthProviderå†…éƒ¨ä½¿ç”¨')
  }
  return context
}
```

---

## 7. ğŸ› ï¸ Axiosæ‹¦æˆªå™¨é…ç½®å®ä¾‹


### 7.1 å®Œæ•´çš„Axiosé…ç½®æ–‡ä»¶


```javascript
// utils/api.js - å®Œæ•´çš„APIé…ç½®
import axios from 'axios'
import { useAuthStore } from '@/store/auth' // å‡è®¾ä½¿ç”¨Pinia

// åˆ›å»ºaxioså®ä¾‹
const apiClient = axios.create({
  baseURL: process.env.VUE_APP_API_BASE_URL || 'https://api.example.com',
  timeout: 10000,
  headers: {
    'Content-Type': 'application/json'
  }
})

// Tokenç®¡ç†å™¨
class TokenManager {
  constructor() {
    this.isRefreshing = false
    this.failedQueue = []
  }
  
  async refreshToken() {
    if (this.isRefreshing) {
      return new Promise((resolve, reject) => {
        this.failedQueue.push({ resolve, reject })
      })
    }
    
    this.isRefreshing = true
    
    try {
      const refreshToken = localStorage.getItem('refreshToken')
      const response = await axios.post('/api/refresh-token', {
        refreshToken
      })
      
      const { token, refreshToken: newRefreshToken, expireTime } = response.data
      
      // æ›´æ–°å­˜å‚¨
      localStorage.setItem('token', token)
      localStorage.setItem('refreshToken', newRefreshToken)
      localStorage.setItem('tokenExpire', expireTime)
      
      // å¤„ç†ç­‰å¾…é˜Ÿåˆ—
      this.failedQueue.forEach(({ resolve }) => resolve(token))
      this.failedQueue = []
      
      return token
    } catch (error) {
      this.failedQueue.forEach(({ reject }) => reject(error))
      this.failedQueue = []
      
      // æ¸…ç†å¹¶è·³è½¬ç™»å½•
      localStorage.clear()
      window.location.href = '/login'
      throw error
    } finally {
      this.isRefreshing = false
    }
  }
}

const tokenManager = new TokenManager()

// è¯·æ±‚æ‹¦æˆªå™¨
apiClient.interceptors.request.use(
  (config) => {
    // 1. æ·»åŠ è¯·æ±‚æ—¶é—´æˆ³
    config.metadata = { startTime: new Date() }
    
    // 2. æ·»åŠ Token
    const token = localStorage.getItem('token')
    if (token && !config.url.includes('/login')) {
      config.headers.Authorization = `Bearer ${token}`
    }
    
    // 3. å¼€å‘ç¯å¢ƒæ—¥å¿—
    if (process.env.NODE_ENV === 'development') {
      console.log(`ğŸš€ å‘é€è¯·æ±‚: ${config.method?.toUpperCase()} ${config.url}`)
    }
    
    return config
  },
  (error) => {
    console.error('âŒ è¯·æ±‚é…ç½®é”™è¯¯:', error)
    return Promise.reject(error)
  }
)

// å“åº”æ‹¦æˆªå™¨
apiClient.interceptors.response.use(
  (response) => {
    // 1. è®¡ç®—è¯·æ±‚è€—æ—¶
    if (response.config.metadata) {
      const duration = new Date() - response.config.metadata.startTime
      if (process.env.NODE_ENV === 'development') {
        console.log(`âœ… è¯·æ±‚å®Œæˆ: ${response.config.url} (${duration}ms)`)
      }
    }
    
    // 2. æ•°æ®æ ‡å‡†åŒ–å¤„ç†
    const { data } = response
    if (data && typeof data === 'object' && 'code' in data) {
      // åç«¯è¿”å›æ ¼å¼: { code: 200, data: {}, message: '' }
      if (data.code === 200) {
        return data.data
      } else {
        throw new Error(data.message || 'è¯·æ±‚å¤±è´¥')
      }
    }
    
    return data
  },
  async (error) => {
    const originalRequest = error.config
    
    // 1. Tokenè¿‡æœŸå¤„ç†
    if (error.response?.status === 401 && !originalRequest._retry) {
      originalRequest._retry = true
      
      try {
        const newToken = await tokenManager.refreshToken()
        originalRequest.headers.Authorization = `Bearer ${newToken}`
        return apiClient(originalRequest)
      } catch (refreshError) {
        return Promise.reject(refreshError)
      }
    }
    
    // 2. å…¶ä»–HTTPé”™è¯¯å¤„ç†
    const errorMessage = getErrorMessage(error)
    
    // 3. å¼€å‘ç¯å¢ƒé”™è¯¯æ—¥å¿—
    if (process.env.NODE_ENV === 'development') {
      console.error('âŒ è¯·æ±‚å¤±è´¥:', error.config?.url, errorMessage)
    }
    
    return Promise.reject(new Error(errorMessage))
  }
)

// é”™è¯¯ä¿¡æ¯æ˜ å°„
function getErrorMessage(error) {
  if (!error.response) {
    return 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®'
  }
  
  const { status, data } = error.response
  
  switch (status) {
    case 400:
      return data?.message || 'è¯·æ±‚å‚æ•°é”™è¯¯'
    case 401:
      return 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•'
    case 403:
      return 'æ²¡æœ‰æƒé™æ‰§è¡Œæ­¤æ“ä½œ'
    case 404:
      return 'è¯·æ±‚çš„èµ„æºä¸å­˜åœ¨'
    case 422:
      return data?.message || 'æ•°æ®éªŒè¯å¤±è´¥'
    case 429:
      return 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•'
    case 500:
      return 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    case 502:
      return 'ç½‘å…³é”™è¯¯'
    case 503:
      return 'æœåŠ¡æš‚ä¸å¯ç”¨'
    default:
      return data?.message || `è¯·æ±‚å¤±è´¥ (${status})`
  }
}

export default apiClient
```

### 7.2 ä¸šåŠ¡APIå°è£…ç¤ºä¾‹


```javascript
// api/user.js - ç”¨æˆ·ç›¸å…³API
import apiClient from '@/utils/api'

export const userApi = {
  // ç”¨æˆ·ç™»å½•
  login: (credentials) => {
    return apiClient.post('/api/auth/login', credentials)
  },
  
  // è·å–ç”¨æˆ·ä¿¡æ¯
  getUserInfo: () => {
    return apiClient.get('/api/user/profile')
  },
  
  // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
  updateProfile: (data) => {
    return apiClient.put('/api/user/profile', data)
  },
  
  // ä¿®æ”¹å¯†ç 
  changePassword: (data) => {
    return apiClient.post('/api/user/change-password', data)
  },
  
  // ç”¨æˆ·ç™»å‡º
  logout: () => {
    return apiClient.post('/api/auth/logout')
  }
}
```

### 7.3 Vueç»„ä»¶ä¸­çš„ä½¿ç”¨ç¤ºä¾‹


```vue
<template>
  <div class="login-form">
    <form @submit.prevent="handleLogin">
      <input 
        v-model="form.username" 
        placeholder="ç”¨æˆ·å"
        :disabled="loading"
      />
      <input 
        v-model="form.password" 
        type="password" 
        placeholder="å¯†ç "
        :disabled="loading"
      />
      <button type="submit" :disabled="loading">
        {{ loading ? 'ç™»å½•ä¸­...' : 'ç™»å½•' }}
      </button>
    </form>
  </div>
</template>

<script>
import { userApi } from '@/api/user'
import { useAuthStore } from '@/store/auth'

export default {
  name: 'LoginForm',
  data() {
    return {
      form: {
        username: '',
        password: ''
      },
      loading: false
    }
  },
  setup() {
    const authStore = useAuthStore()
    return { authStore }
  },
  methods: {
    async handleLogin() {
      if (!this.form.username || !this.form.password) {
        this.$message.error('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ')
        return
      }
      
      this.loading = true
      
      try {
        // è°ƒç”¨ç™»å½•API - æ‹¦æˆªå™¨ä¼šè‡ªåŠ¨å¤„ç†Token
        const result = await userApi.login(this.form)
        
        // æ›´æ–°ç™»å½•çŠ¶æ€
        await this.authStore.login(result)
        
        this.$message.success('ç™»å½•æˆåŠŸ')
        this.$router.push('/dashboard')
      } catch (error) {
        this.$message.error(error.message || 'ç™»å½•å¤±è´¥')
      } finally {
        this.loading = false
      }
    }
  }
}
</script>
```

---

## 8. ğŸšª ä¼˜é›…çš„ç™»å½•è·³è½¬


### 8.1 ä»€ä¹ˆæ˜¯ä¼˜é›…çš„ç™»å½•è·³è½¬


**æ™®é€šçš„è·³è½¬**ï¼šå‘ç°æ²¡ç™»å½•å°±ç›´æ¥è·³è½¬åˆ°ç™»å½•é¡µï¼Œç”¨æˆ·ä½“éªŒå·®
**ä¼˜é›…çš„è·³è½¬**ï¼šæ™ºèƒ½åˆ¤æ–­ã€ä¿å­˜çŠ¶æ€ã€å‹å¥½æç¤ºã€è‡ªåŠ¨è¿”å›

```
ä¼˜é›…ç™»å½•è·³è½¬çš„ç‰¹ç‚¹ï¼š
- ğŸ¯ æ™ºèƒ½æ£€æµ‹ï¼šå‡†ç¡®åˆ¤æ–­æ˜¯å¦éœ€è¦ç™»å½•
- ğŸ’¾ çŠ¶æ€ä¿å­˜ï¼šè®°ä½ç”¨æˆ·æƒ³å»çš„é¡µé¢
- ğŸ¨ å‹å¥½æç¤ºï¼šæ¸…æ¥šå‘ŠçŸ¥ç”¨æˆ·ä¸ºä»€ä¹ˆè¦ç™»å½•
- ğŸ”„ è‡ªåŠ¨è¿”å›ï¼šç™»å½•æˆåŠŸåå›åˆ°åŸæ¥çš„é¡µé¢
- â° æ—¶æœºåˆé€‚ï¼šåœ¨åˆé€‚çš„æ—¶é—´ç‚¹æç¤ºç™»å½•
```

### 8.2 è·¯ç”±å®ˆå«å®ç°ç™»å½•æ£€æŸ¥


**Vue Routerå®ˆå«**ï¼š
```javascript
// router/index.js
import { useAuthStore } from '@/store/auth'

const router = createRouter({
  history: createWebHistory(),
  routes: [
    {
      path: '/login',
      name: 'Login',
      component: () => import('@/views/Login.vue'),
      meta: { requiresAuth: false }
    },
    {
      path: '/dashboard',
      name: 'Dashboard', 
      component: () => import('@/views/Dashboard.vue'),
      meta: { requiresAuth: true }
    },
    {
      path: '/profile',
      name: 'Profile',
      component: () => import('@/views/Profile.vue'),
      meta: { requiresAuth: true }
    }
  ]
})

// å…¨å±€å‰ç½®å®ˆå«
router.beforeEach(async (to, from, next) => {
  const authStore = useAuthStore()
  
  // 1. æ¢å¤ç™»å½•çŠ¶æ€ï¼ˆé¡µé¢åˆ·æ–°æ—¶ï¼‰
  if (!authStore.isLoggedIn) {
    authStore.restoreAuth()
  }
  
  // 2. æ£€æŸ¥è·¯ç”±æ˜¯å¦éœ€è¦è®¤è¯
  if (to.meta.requiresAuth) {
    if (authStore.isAuthenticated) {
      // å·²ç™»å½•ï¼Œå…è®¸è®¿é—®
      next()
    } else {
      // æœªç™»å½•ï¼Œä¿å­˜ç›®æ ‡é¡µé¢å¹¶è·³è½¬ç™»å½•
      sessionStorage.setItem('redirectAfterLogin', to.fullPath)
      
      // æ˜¾ç¤ºå‹å¥½æç¤º
      ElMessage.warning('è¯·å…ˆç™»å½•åå†è®¿é—®è¯¥é¡µé¢')
      
      next({
        name: 'Login',
        query: { 
          redirect: to.fullPath,
          message: 'è¯·å…ˆç™»å½•'
        }
      })
    }
  } else {
    // ä¸éœ€è¦è®¤è¯çš„é¡µé¢ï¼Œç›´æ¥å…è®¸è®¿é—®
    next()
  }
})
```

### 8.3 ç™»å½•æˆåŠŸåçš„æ™ºèƒ½è·³è½¬


```javascript
// views/Login.vue
export default {
  name: 'LoginPage',
  data() {
    return {
      form: {
        username: '',
        password: ''
      }
    }
  },
  methods: {
    async handleLogin() {
      try {
        // æ‰§è¡Œç™»å½•
        const result = await userApi.login(this.form)
        await this.authStore.login(result)
        
        // æ™ºèƒ½è·³è½¬é€»è¾‘
        this.smartRedirect()
      } catch (error) {
        this.$message.error(error.message || 'ç™»å½•å¤±è´¥')
      }
    },
    
    smartRedirect() {
      // 1. ä¼˜å…ˆä½¿ç”¨URLå‚æ•°ä¸­çš„redirect
      const urlRedirect = this.$route.query.redirect
      
      // 2. å…¶æ¬¡ä½¿ç”¨sessionStorageä¸­ä¿å­˜çš„è·¯å¾„
      const sessionRedirect = sessionStorage.getItem('redirectAfterLogin')
      
      // 3. æœ€åä½¿ç”¨é»˜è®¤é¡µé¢
      const defaultRedirect = '/dashboard'
      
      // ç¡®å®šè·³è½¬ç›®æ ‡
      let targetPath = urlRedirect || sessionRedirect || defaultRedirect
      
      // 4. å®‰å…¨æ€§æ£€æŸ¥ï¼šé˜²æ­¢è·³è½¬åˆ°å¤–éƒ¨é“¾æ¥
      if (!targetPath.startsWith('/')) {
        targetPath = defaultRedirect
      }
      
      // 5. æ¸…ç†ä¸´æ—¶å­˜å‚¨
      sessionStorage.removeItem('redirectAfterLogin')
      
      // 6. æ‰§è¡Œè·³è½¬
      this.$router.replace(targetPath)
      
      // 7. æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯
      this.$message.success(`æ¬¢è¿å›æ¥ï¼Œ${this.authStore.user?.nickname || 'ç”¨æˆ·'}ï¼`)
    }
  }
}
```

### 8.4 è‡ªåŠ¨ç™»å½•è·³è½¬ç»„ä»¶


```javascript
// components/AutoLoginRedirect.vue
<template>
  <div class="auto-login-redirect">
    <div class="redirect-content">
      <div class="icon">ğŸ”</div>
      <h3>éœ€è¦ç™»å½•</h3>
      <p>{{ message }}</p>
      <div class="countdown">
        {{ countdown }} ç§’åè‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µ
      </div>
      <div class="actions">
        <button @click="redirectNow" class="btn-primary">ç«‹å³ç™»å½•</button>
        <button @click="cancel" class="btn-secondary">å–æ¶ˆ</button>
      </div>
    </div>
  </div>
</template>

<script>
export default {
  name: 'AutoLoginRedirect',
  props: {
    message: {
      type: String,
      default: 'æ‚¨éœ€è¦ç™»å½•åæ‰èƒ½è®¿é—®æ­¤é¡µé¢'
    },
    delay: {
      type: Number,
      default: 5 // 5ç§’åè‡ªåŠ¨è·³è½¬
    }
  },
  data() {
    return {
      countdown: this.delay,
      timer: null
    }
  },
  mounted() {
    this.startCountdown()
  },
  beforeUnmount() {
    this.clearTimer()
  },
  methods: {
    startCountdown() {
      this.timer = setInterval(() => {
        this.countdown--
        if (this.countdown <= 0) {
          this.redirectToLogin()
        }
      }, 1000)
    },
    
    clearTimer() {
      if (this.timer) {
        clearInterval(this.timer)
        this.timer = null
      }
    },
    
    redirectNow() {
      this.clearTimer()
      this.redirectToLogin()
    },
    
    redirectToLogin() {
      // ä¿å­˜å½“å‰é¡µé¢è·¯å¾„
      const currentPath = this.$route.fullPath
      sessionStorage.setItem('redirectAfterLogin', currentPath)
      
      // è·³è½¬åˆ°ç™»å½•é¡µ
      this.$router.push({
        name: 'Login',
        query: { redirect: currentPath }
      })
    },
    
    cancel() {
      this.clearTimer()
      this.$emit('cancel')
      // å¯ä»¥è·³è½¬åˆ°é¦–é¡µæˆ–å…¶ä»–å…¬å¼€é¡µé¢
      this.$router.push('/')
    }
  }
}
</script>

<style scoped>
.auto-login-redirect {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

.redirect-content {
  background: white;
  padding: 2rem;
  border-radius: 8px;
  text-align: center;
  max-width: 400px;
}

.icon {
  font-size: 3rem;
  margin-bottom: 1rem;
}

.countdown {
  font-size: 1.2rem;
  color: #666;
  margin: 1rem 0;
}

.actions {
  display: flex;
  gap: 1rem;
  justify-content: center;
  margin-top: 1.5rem;
}

.btn-primary, .btn-secondary {
  padding: 0.5rem 1rem;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.btn-primary {
  background: #007bff;
  color: white;
}

.btn-secondary {
  background: #6c757d;
  color: white;
}
</style>
```

### 8.5 æƒé™æ£€æŸ¥Hook


```javascript
// composables/useAuth.js
import { computed, ref, watch } from 'vue'
import { useRouter, useRoute } from 'vue-router'
import { useAuthStore } from '@/store/auth'

export function useAuthGuard() {
  const router = useRouter()
  const route = useRoute()
  const authStore = useAuthStore()
  
  const isLoading = ref(true)
  const needsAuth = ref(false)
  
  // æ£€æŸ¥å½“å‰è·¯ç”±æ˜¯å¦éœ€è¦è®¤è¯
  const checkAuth = () => {
    needsAuth.value = route.meta?.requiresAuth || false
    
    if (needsAuth.value && !authStore.isAuthenticated) {
      // éœ€è¦è®¤è¯ä½†æœªç™»å½•
      return false
    }
    
    return true
  }
  
  // æ‰§è¡Œç™»å½•è·³è½¬
  const redirectToLogin = (message = 'è¯·å…ˆç™»å½•') => {
    sessionStorage.setItem('redirectAfterLogin', route.fullPath)
    
    router.push({
      name: 'Login',
      query: {
        redirect: route.fullPath,
        message
      }
    })
  }
  
  // æƒé™éªŒè¯
  const hasPermission = (permission) => {
    if (!authStore.user) return false
    
    const userPermissions = authStore.user.permissions || []
    return userPermissions.includes(permission)
  }
  
  // è§’è‰²éªŒè¯
  const hasRole = (role) => {
    if (!authStore.user) return false
    
    const userRoles = authStore.user.roles || []
    return userRoles.includes(role)
  }
  
  return {
    isLoading: computed(() => isLoading.value),
    needsAuth: computed(() => needsAuth.value),
    isAuthenticated: computed(() => authStore.isAuthenticated),
    user: computed(() => authStore.user),
    checkAuth,
    redirectToLogin,
    hasPermission,
    hasRole
  }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Tokenè®¤è¯åŸç†ï¼šèº«ä»½å‡­è¯çš„ç”µå­åŒ–å®ç°
ğŸ”¸ è¯·æ±‚å¤´è®¾ç½®ï¼šAuthorization Beareræ ¼å¼æ ‡å‡†
ğŸ”¸ æ‹¦æˆªå™¨æœºåˆ¶ï¼šè¯·æ±‚å’Œå“åº”çš„ç»Ÿä¸€å¤„ç†å…¥å£
ğŸ”¸ Tokenåˆ·æ–°ï¼šä¿æŒç™»å½•çŠ¶æ€çš„æ ¸å¿ƒæŠ€æœ¯
ğŸ”¸ çŠ¶æ€ç®¡ç†ï¼šå‰ç«¯ç™»å½•çŠ¶æ€çš„æŒä¹…åŒ–å’ŒåŒæ­¥
ğŸ”¸ ç™»å½•è·³è½¬ï¼šç”¨æˆ·ä½“éªŒä¼˜åŒ–çš„é‡è¦ç¯èŠ‚
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ Token vs Sessionçš„åŒºåˆ«**
```
Sessionæ–¹å¼ï¼š
- æœåŠ¡å™¨å­˜å‚¨ç”¨æˆ·çŠ¶æ€
- ä¾èµ–Cookieä¼ é€’SessionID
- å ç”¨æœåŠ¡å™¨å†…å­˜
- é›†ç¾¤éƒ¨ç½²å¤æ‚

Tokenæ–¹å¼ï¼š
- å®¢æˆ·ç«¯å­˜å‚¨è®¤è¯ä¿¡æ¯
- è¯·æ±‚å¤´æºå¸¦Token
- æœåŠ¡å™¨æ— çŠ¶æ€
- æ˜“äºæ‰©å±•å’Œéƒ¨ç½²
```

**ğŸ”¹ æ‹¦æˆªå™¨çš„å·¥ä½œåŸç†**
```
è¯·æ±‚æ‹¦æˆªå™¨ï¼šå‘é€å‰å¤„ç†
- è‡ªåŠ¨æ·»åŠ Token
- ç»Ÿä¸€è¯·æ±‚æ ¼å¼
- æ·»åŠ å…¬å…±å‚æ•°

å“åº”æ‹¦æˆªå™¨ï¼šæ”¶åˆ°åå¤„ç†  
- ç»Ÿä¸€é”™è¯¯å¤„ç†
- è‡ªåŠ¨Tokenåˆ·æ–°
- æ•°æ®æ ¼å¼æ ‡å‡†åŒ–
```

**ğŸ”¹ Tokenåˆ·æ–°çš„é‡è¦æ€§**
```
æ²¡æœ‰åˆ·æ–°æœºåˆ¶ï¼š
- Tokenè¿‡æœŸç”¨æˆ·éœ€è¦é‡æ–°ç™»å½•
- ç”¨æˆ·ä½“éªŒå·®
- å¯èƒ½ä¸¢å¤±å½“å‰æ“ä½œ

æœ‰åˆ·æ–°æœºåˆ¶ï¼š
- æ— æ„ŸçŸ¥ç»­æœŸ
- æŒç»­çš„ç”¨æˆ·ä½“éªŒ
- æé«˜å®‰å…¨æ€§ï¼ˆçŸ­æœŸTokenï¼‰
```

### 9.3 å®é™…åº”ç”¨ä»·å€¼


**é¡¹ç›®åº”ç”¨åœºæ™¯**ï¼š
- ğŸŒ **SPAåº”ç”¨**ï¼šå•é¡µé¢åº”ç”¨çš„èº«ä»½è®¤è¯
- ğŸ“± **ç§»åŠ¨ç«¯H5**ï¼šæ‰‹æœºç½‘é¡µçš„ç™»å½•ç®¡ç†
- ğŸ”— **APIè°ƒç”¨**ï¼šå‰åç«¯åˆ†ç¦»é¡¹ç›®çš„æ¥å£è®¤è¯
- ğŸ› ï¸ **ç®¡ç†ç³»ç»Ÿ**ï¼šä¼ä¸šå†…éƒ¨ç³»ç»Ÿçš„æƒé™æ§åˆ¶

**æŠ€æœ¯é€‰å‹å»ºè®®**ï¼š
```
å°å‹é¡¹ç›®ï¼š
- ç®€å•çš„localStorage + åŸºç¡€æ‹¦æˆªå™¨
- æ‰‹åŠ¨Tokenç®¡ç†

ä¸­å‹é¡¹ç›®ï¼š
- Vuex/PiniaçŠ¶æ€ç®¡ç†
- è‡ªåŠ¨Tokenåˆ·æ–°
- è·¯ç”±æƒé™æ§åˆ¶

å¤§å‹é¡¹ç›®ï¼š
- å®Œæ•´çš„æƒé™ç®¡ç†ç³»ç»Ÿ
- å¤šç¯å¢ƒTokené…ç½®
- å®‰å…¨åŠ å›ºæªæ–½
```

### 9.4 å®‰å…¨æ³¨æ„äº‹é¡¹


**å­˜å‚¨å®‰å…¨**ï¼š
```
âœ… æ¨èåšæ³•ï¼š
- ä½¿ç”¨localStorageå­˜å‚¨Token
- è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´
- å®šæœŸæ¸…ç†æ— æ•ˆToken

âŒ é¿å…åšæ³•ï¼š
- Tokenå­˜å‚¨åœ¨Cookieï¼ˆCSRFé£é™©ï¼‰
- æ°¸ä¸è¿‡æœŸçš„Token
- æ˜æ–‡å­˜å‚¨æ•æ„Ÿä¿¡æ¯
```

**ä¼ è¾“å®‰å…¨**ï¼š
```
âœ… å¿…é¡»è¦æ±‚ï¼š
- HTTPSä¼ è¾“
- Beareræ ¼å¼
- æœåŠ¡ç«¯éªŒè¯

âŒ å®‰å…¨é£é™©ï¼š
- HTTPæ˜æ–‡ä¼ è¾“
- URLå‚æ•°ä¼ é€’Token
- ç¼ºå°‘æœåŠ¡ç«¯æ ¡éªŒ
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
Tokenè®¤è¯ä¸‰è¦ç´ ï¼šè·å–å­˜å‚¨å’Œä½¿ç”¨
æ‹¦æˆªå™¨åŒä¿é™©ï¼šè¯·æ±‚å“åº”éƒ½å¤„ç†
è‡ªåŠ¨åˆ·æ–°æ˜¯å…³é”®ï¼šç”¨æˆ·æ— æ„Ÿä½“éªŒå¥½
çŠ¶æ€ç®¡ç†è¦ç»Ÿä¸€ï¼šå…¨å±€å…±äº«é¿æ··ä¹±
ç™»å½•è·³è½¬éœ€ä¼˜é›…ï¼šä¿å­˜çŠ¶æ€å‹æç¤º
```