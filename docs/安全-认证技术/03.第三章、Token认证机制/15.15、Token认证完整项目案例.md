---
title: 15ã€Tokenè®¤è¯å®Œæ•´é¡¹ç›®æ¡ˆä¾‹
---
## ğŸ“š ç›®å½•

1. [Tokenè®¤è¯æ ¸å¿ƒæ¦‚å¿µ](#1-Tokenè®¤è¯æ ¸å¿ƒæ¦‚å¿µ)
2. [ç™»å½•æ³¨å†Œå®Œæ•´æµç¨‹](#2-ç™»å½•æ³¨å†Œå®Œæ•´æµç¨‹)
3. [ç”¨æˆ·ä¿¡æ¯è·å–æ¥å£](#3-ç”¨æˆ·ä¿¡æ¯è·å–æ¥å£)
4. [æƒé™æ§åˆ¶å®é™…åº”ç”¨](#4-æƒé™æ§åˆ¶å®é™…åº”ç”¨)
5. [é€€å‡ºç™»å½•å¤„ç†](#5-é€€å‡ºç™»å½•å¤„ç†)
6. [å¸¸è§é—®é¢˜è°ƒè¯•æ–¹æ³•](#6-å¸¸è§é—®é¢˜è°ƒè¯•æ–¹æ³•)
7. [ä¼ä¸šçº§å®ç°æ–¹æ¡ˆ](#7-ä¼ä¸šçº§å®ç°æ–¹æ¡ˆ)
8. [ç”Ÿäº§ç¯å¢ƒæ³¨æ„äº‹é¡¹](#8-ç”Ÿäº§ç¯å¢ƒæ³¨æ„äº‹é¡¹)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” Tokenè®¤è¯æ ¸å¿ƒæ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Tokenè®¤è¯


**ğŸ”¸ ç™½è¯è§£é‡Š**
Tokenè®¤è¯å°±åƒæ˜¯**å»æ¸¸ä¹å›­çš„æ‰‹ç¯**ï¼š
- ä½ ä¹°ç¥¨æ—¶ï¼Œå·¥ä½œäººå‘˜ç»™ä½ æˆ´ä¸ªæ‰‹ç¯ï¼ˆè·å–Tokenï¼‰
- ä¹‹åç©ä»»ä½•é¡¹ç›®ï¼Œåªéœ€è¦å‡ºç¤ºæ‰‹ç¯å°±è¡Œï¼ˆæºå¸¦Tokenï¼‰
- ä¸ç”¨æ¯æ¬¡éƒ½é‡æ–°ä¹°ç¥¨éªŒè¯èº«ä»½ï¼ˆé¿å…é‡å¤ç™»å½•ï¼‰

**ğŸ”¸ æŠ€æœ¯å«ä¹‰**
```
Tokenï¼šä¸€ä¸²ç‰¹æ®Šçš„å­—ç¬¦ä¸²ï¼Œåƒèº«ä»½è¯æ˜ä¹¦
ä½œç”¨ï¼šè¯æ˜ç”¨æˆ·å·²ç»æˆåŠŸç™»å½•ï¼Œæœ‰æƒè®¿é—®ç³»ç»Ÿ
åŸç†ï¼šç”¨æˆ·ç™»å½•æˆåŠŸåï¼ŒæœåŠ¡å™¨ç”ŸæˆTokenè¿”å›ç»™ç”¨æˆ·
ä½¿ç”¨ï¼šç”¨æˆ·è®¿é—®éœ€è¦æƒé™çš„æ¥å£æ—¶ï¼Œæºå¸¦è¿™ä¸ªToken
```

### 1.2 Tokenè®¤è¯æµç¨‹å›¾


```
ç”¨æˆ·ç«¯                    æœåŠ¡å™¨ç«¯                æ•°æ®åº“
  |                        |                      |
  |--[1]ç™»å½•è¯·æ±‚----------->|                      |
  |   ç”¨æˆ·å+å¯†ç            |--[2]éªŒè¯ç”¨æˆ·ä¿¡æ¯----->|
  |                        |<-[3]è¿”å›ç”¨æˆ·æ•°æ®------|
  |<--[4]è¿”å›Token---------|                      |
  |   (ç™»å½•æˆåŠŸ)           |                      |
  |                        |                      |
  |--[5]è®¿é—®æ¥å£----------->|                      |
  |   æºå¸¦Token           |--[6]éªŒè¯Token------->|
  |                        |<-[7]ç¡®è®¤æœ‰æ•ˆ---------|
  |<--[8]è¿”å›æ•°æ®----------|                      |
```

### 1.3 Tokençš„æœ¬è´¨


**ğŸ’¡ TokenåŒ…å«ä»€ä¹ˆä¿¡æ¯**
```
å…¸å‹Tokenå†…å®¹ï¼š
- ç”¨æˆ·IDï¼šæ ‡è¯†æ˜¯å“ªä¸ªç”¨æˆ·
- è¿‡æœŸæ—¶é—´ï¼šTokenä»€ä¹ˆæ—¶å€™å¤±æ•ˆ
- ç­¾åï¼šé˜²æ­¢Tokenè¢«ä¼ªé€ 
- æƒé™ä¿¡æ¯ï¼šç”¨æˆ·èƒ½åšä»€ä¹ˆæ“ä½œ

å®é™…Tokenæ ·å­ï¼š
eyJhbGciOiJIUzI1NiJ9.eyJ1c2VySWQiOjEsImV4cCI6MTY5...
ï¼ˆè¿™æ˜¯ä¸€ä¸ªJWTæ ¼å¼çš„Tokenï¼‰
```

---

## 2. ğŸšª ç™»å½•æ³¨å†Œå®Œæ•´æµç¨‹


### 2.1 ç”¨æˆ·æ³¨å†Œæµç¨‹


**ğŸ”¸ æ³¨å†Œæ­¥éª¤è¯¦è§£**
```
æ­¥éª¤1ï¼šç”¨æˆ·å¡«å†™æ³¨å†Œä¿¡æ¯
     â†“
æ­¥éª¤2ï¼šæœåŠ¡å™¨éªŒè¯ä¿¡æ¯æ ¼å¼
     â†“  
æ­¥éª¤3ï¼šæ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
     â†“
æ­¥éª¤4ï¼šå¯†ç åŠ å¯†å­˜å‚¨åˆ°æ•°æ®åº“
     â†“
æ­¥éª¤5ï¼šè¿”å›æ³¨å†Œç»“æœ
```

**ğŸ’» æ³¨å†Œæ¥å£ä»£ç ç¤ºä¾‹**
```java
@RestController
@RequestMapping("/auth")
public class AuthController {
    
    // ç”¨æˆ·æ³¨å†Œ
    @PostMapping("/register")
    public Result register(@RequestBody RegisterRequest request) {
        
        // 1. åŸºæœ¬ä¿¡æ¯éªŒè¯
        if (request.getUsername() == null || request.getPassword() == null) {
            return Result.error("ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º");
        }
        
        // 2. æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
        if (userService.existsByUsername(request.getUsername())) {
            return Result.error("ç”¨æˆ·åå·²å­˜åœ¨");
        }
        
        // 3. åˆ›å»ºæ–°ç”¨æˆ·ï¼ˆå¯†ç ä¼šè‡ªåŠ¨åŠ å¯†ï¼‰
        User newUser = userService.createUser(request);
        
        // 4. è¿”å›æˆåŠŸç»“æœ
        return Result.success("æ³¨å†ŒæˆåŠŸ");
    }
}
```

### 2.2 ç”¨æˆ·ç™»å½•æµç¨‹


**ğŸ”¸ ç™»å½•æ­¥éª¤è¯¦è§£**
```
ç”¨æˆ·è¾“å…¥è´¦å·å¯†ç 
     â†“
æœåŠ¡å™¨æŸ¥æ‰¾ç”¨æˆ·ä¿¡æ¯
     â†“
æ¯”å¯¹å¯†ç æ˜¯å¦æ­£ç¡®
     â†“
ç”ŸæˆTokenè¿”å›ç»™ç”¨æˆ·
     â†“
ç”¨æˆ·ä¿å­˜Tokenåˆ°æœ¬åœ°
```

**ğŸ’» ç™»å½•æ¥å£ä»£ç ç¤ºä¾‹**
```java
@PostMapping("/login")
public Result login(@RequestBody LoginRequest request) {
    
    // 1. æ ¹æ®ç”¨æˆ·åæŸ¥æ‰¾ç”¨æˆ·
    User user = userService.findByUsername(request.getUsername());
    if (user == null) {
        return Result.error("ç”¨æˆ·ä¸å­˜åœ¨");
    }
    
    // 2. éªŒè¯å¯†ç 
    if (!passwordEncoder.matches(request.getPassword(), user.getPassword())) {
        return Result.error("å¯†ç é”™è¯¯");
    }
    
    // 3. ç”ŸæˆToken
    String token = jwtUtil.generateToken(user.getId());
    
    // 4. è¿”å›Tokenå’Œç”¨æˆ·åŸºæœ¬ä¿¡æ¯
    LoginResponse response = new LoginResponse();
    response.setToken(token);
    response.setUsername(user.getUsername());
    response.setNickname(user.getNickname());
    
    return Result.success(response);
}
```

### 2.3 å‰ç«¯ç™»å½•å¤„ç†


**ğŸ’» å‰ç«¯ç™»å½•ä»£ç **
```javascript
// ç”¨æˆ·ç™»å½•å‡½æ•°
async function login() {
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    
    try {
        const response = await fetch('/auth/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ username, password })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // ä¿å­˜Tokenåˆ°æµè§ˆå™¨
            localStorage.setItem('token', result.data.token);
            // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
            localStorage.setItem('userInfo', JSON.stringify(result.data));
            // è·³è½¬åˆ°ä¸»é¡µ
            window.location.href = '/home';
        } else {
            alert(result.message);
        }
    } catch (error) {
        alert('ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
}
```

---

## 3. ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯è·å–æ¥å£


### 3.1 è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯


**ğŸ”¸ ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªæ¥å£**
ç”¨æˆ·åˆ·æ–°é¡µé¢åï¼ŒTokenè¿˜åœ¨ï¼Œä½†ç”¨æˆ·ä¿¡æ¯å¯èƒ½ä¸¢å¤±äº†ï¼Œéœ€è¦é‡æ–°è·å–ã€‚

**ğŸ’» åç«¯å®ç°**
```java
@GetMapping("/userInfo")
public Result getUserInfo(HttpServletRequest request) {
    
    // 1. ä»è¯·æ±‚å¤´è·å–Token
    String token = request.getHeader("Authorization");
    if (token == null) {
        return Result.error("æœªç™»å½•");
    }
    
    // 2. è§£æTokenè·å–ç”¨æˆ·ID
    Long userId = jwtUtil.getUserIdFromToken(token);
    
    // 3. æ ¹æ®ç”¨æˆ·IDæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
    User user = userService.findById(userId);
    if (user == null) {
        return Result.error("ç”¨æˆ·ä¸å­˜åœ¨");
    }
    
    // 4. è¿”å›ç”¨æˆ·ä¿¡æ¯ï¼ˆä¸åŒ…å«å¯†ç ï¼‰
    UserInfo userInfo = new UserInfo();
    userInfo.setId(user.getId());
    userInfo.setUsername(user.getUsername());
    userInfo.setNickname(user.getNickname());
    userInfo.setEmail(user.getEmail());
    
    return Result.success(userInfo);
}
```

### 3.2 å‰ç«¯è·å–ç”¨æˆ·ä¿¡æ¯


**ğŸ’» å‰ç«¯ä»£ç **
```javascript
// è·å–ç”¨æˆ·ä¿¡æ¯
async function getUserInfo() {
    const token = localStorage.getItem('token');
    
    try {
        const response = await fetch('/auth/userInfo', {
            method: 'GET',
            headers: {
                'Authorization': token,
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
            displayUserInfo(result.data);
        } else {
            // Tokenå¯èƒ½è¿‡æœŸäº†ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
            window.location.href = '/login';
        }
    } catch (error) {
        console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
    }
}

// é¡µé¢åŠ è½½æ—¶è·å–ç”¨æˆ·ä¿¡æ¯
window.onload = function() {
    if (localStorage.getItem('token')) {
        getUserInfo();
    }
};
```

---

## 4. ğŸ›¡ï¸ æƒé™æ§åˆ¶å®é™…åº”ç”¨


### 4.1 ä»€ä¹ˆæ˜¯æƒé™æ§åˆ¶


**ğŸ”¸ ç”Ÿæ´»ä¸­çš„æƒé™æ§åˆ¶**
- **å…¬å¸é—¨å¡**ï¼šä¸åŒå‘˜å·¥çš„é—¨å¡èƒ½æ‰“å¼€ä¸åŒçš„é—¨
- **é“¶è¡Œè´¦æˆ·**ï¼šåªæœ‰æœ¬äººæ‰èƒ½æŸ¥çœ‹å’Œæ“ä½œè‡ªå·±çš„è´¦æˆ·
- **å­¦æ ¡ç³»ç»Ÿ**ï¼šå­¦ç”Ÿåªèƒ½æŸ¥çœ‹æˆç»©ï¼Œè€å¸ˆè¿˜èƒ½ä¿®æ”¹æˆç»©

**ğŸ”¸ ç³»ç»Ÿä¸­çš„æƒé™æ§åˆ¶**
```
æƒé™æ§åˆ¶å°±æ˜¯ï¼šè°èƒ½åšä»€ä¹ˆäº‹æƒ…

å¸¸è§æƒé™ç±»å‹ï¼š
- æŸ¥çœ‹æƒé™ï¼šèƒ½ä¸èƒ½çœ‹åˆ°æ•°æ®
- ç¼–è¾‘æƒé™ï¼šèƒ½ä¸èƒ½ä¿®æ”¹æ•°æ®  
- åˆ é™¤æƒé™ï¼šèƒ½ä¸èƒ½åˆ é™¤æ•°æ®
- ç®¡ç†æƒé™ï¼šèƒ½ä¸èƒ½ç®¡ç†å…¶ä»–ç”¨æˆ·
```

### 4.2 åŸºäºè§’è‰²çš„æƒé™æ§åˆ¶


**ğŸ”¸ è§’è‰²æƒé™æ¨¡å‹**
```
ç³»ç»Ÿè§’è‰²è®¾è®¡ï¼š

ç®¡ç†å‘˜(ADMIN)ï¼š
- ç”¨æˆ·ç®¡ç†ï¼šâœ… å¢åˆ æ”¹æŸ¥æ‰€æœ‰ç”¨æˆ·
- å†…å®¹ç®¡ç†ï¼šâœ… ç®¡ç†æ‰€æœ‰å†…å®¹
- ç³»ç»Ÿè®¾ç½®ï¼šâœ… ä¿®æ”¹ç³»ç»Ÿé…ç½®

æ™®é€šç”¨æˆ·(USER)ï¼š
- ä¸ªäººä¿¡æ¯ï¼šâœ… æŸ¥çœ‹å’Œä¿®æ”¹è‡ªå·±çš„ä¿¡æ¯
- å†…å®¹æµè§ˆï¼šâœ… æŸ¥çœ‹å…¬å¼€å†…å®¹
- å‘è¡¨å†…å®¹ï¼šâœ… å‘è¡¨è‡ªå·±çš„å†…å®¹

æ¸¸å®¢(GUEST)ï¼š
- åŸºæœ¬æµè§ˆï¼šâœ… æŸ¥çœ‹å…¬å¼€å†…å®¹
- æ³¨å†Œç™»å½•ï¼šâœ… å¯ä»¥æ³¨å†Œå’Œç™»å½•
```

**ğŸ’» æƒé™æ£€æŸ¥ä»£ç **
```java
@RestController
@RequestMapping("/admin")
public class AdminController {
    
    // åªæœ‰ç®¡ç†å‘˜æ‰èƒ½è®¿é—®
    @GetMapping("/users")
    public Result getAllUsers(HttpServletRequest request) {
        
        // 1. è·å–å½“å‰ç”¨æˆ·
        User currentUser = getCurrentUser(request);
        
        // 2. æ£€æŸ¥æƒé™
        if (!currentUser.getRole().equals("ADMIN")) {
            return Result.error("æƒé™ä¸è¶³");
        }
        
        // 3. è¿”å›æ•°æ®
        List<User> users = userService.findAll();
        return Result.success(users);
    }
    
    // åˆ é™¤ç”¨æˆ·ï¼ˆåªæœ‰ç®¡ç†å‘˜å¯ä»¥ï¼‰
    @DeleteMapping("/users/{id}")
    public Result deleteUser(@PathVariable Long id, HttpServletRequest request) {
        
        User currentUser = getCurrentUser(request);
        if (!currentUser.getRole().equals("ADMIN")) {
            return Result.error("åªæœ‰ç®¡ç†å‘˜æ‰èƒ½åˆ é™¤ç”¨æˆ·");
        }
        
        userService.deleteById(id);
        return Result.success("åˆ é™¤æˆåŠŸ");
    }
}
```

### 4.3 ä½¿ç”¨æ‹¦æˆªå™¨ç»Ÿä¸€æƒé™æ§åˆ¶


**ğŸ’» æƒé™æ‹¦æˆªå™¨**
```java
@Component
public class AuthInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler) throws Exception {
        
        // 1. è·å–Token
        String token = request.getHeader("Authorization");
        if (token == null) {
            response.setStatus(401);
            response.getWriter().write("æœªç™»å½•");
            return false;
        }
        
        // 2. éªŒè¯Token
        if (!jwtUtil.isValidToken(token)) {
            response.setStatus(401);
            response.getWriter().write("Tokenæ— æ•ˆ");
            return false;
        }
        
        // 3. æ£€æŸ¥ç‰¹å®šæƒé™
        String requestURI = request.getRequestURI();
        if (requestURI.startsWith("/admin/")) {
            Long userId = jwtUtil.getUserIdFromToken(token);
            User user = userService.findById(userId);
            if (!"ADMIN".equals(user.getRole())) {
                response.setStatus(403);
                response.getWriter().write("æƒé™ä¸è¶³");
                return false;
            }
        }
        
        return true;
    }
}
```

---

## 5. ğŸšª é€€å‡ºç™»å½•å¤„ç†


### 5.1 é€€å‡ºç™»å½•çš„åŸç†


**ğŸ”¸ é€€å‡ºç™»å½•åšä»€ä¹ˆ**
```
å®¢æˆ·ç«¯æ“ä½œï¼š
1. æ¸…é™¤æœ¬åœ°å­˜å‚¨çš„Token
2. æ¸…é™¤ç”¨æˆ·ä¿¡æ¯
3. è·³è½¬åˆ°ç™»å½•é¡µé¢

æœåŠ¡å™¨ç«¯æ“ä½œï¼š
1. å°†TokenåŠ å…¥é»‘åå•ï¼ˆå¯é€‰ï¼‰
2. è®°å½•é€€å‡ºæ—¥å¿—ï¼ˆå¯é€‰ï¼‰
```

### 5.2 å‰ç«¯é€€å‡ºç™»å½•


**ğŸ’» å‰ç«¯é€€å‡ºä»£ç **
```javascript
// é€€å‡ºç™»å½•å‡½æ•°
function logout() {
    // 1. æ¸…é™¤æœ¬åœ°å­˜å‚¨
    localStorage.removeItem('token');
    localStorage.removeItem('userInfo');
    
    // 2. æ¸…é™¤sessionStorageï¼ˆå¦‚æœæœ‰ç”¨åˆ°ï¼‰
    sessionStorage.clear();
    
    // 3. å¯é€‰ï¼šè°ƒç”¨åç«¯é€€å‡ºæ¥å£
    fetch('/auth/logout', {
        method: 'POST',
        headers: {
            'Authorization': localStorage.getItem('token')
        }
    });
    
    // 4. è·³è½¬åˆ°ç™»å½•é¡µ
    window.location.href = '/login';
    
    // 5. æ˜¾ç¤ºæç¤ºä¿¡æ¯
    alert('å·²å®‰å…¨é€€å‡ºç™»å½•');
}

// é€€å‡ºæŒ‰é’®ç‚¹å‡»äº‹ä»¶
document.getElementById('logoutBtn').addEventListener('click', function() {
    if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
        logout();
    }
});
```

### 5.3 åç«¯é€€å‡ºç™»å½•æ¥å£


**ğŸ’» åç«¯é€€å‡ºä»£ç **
```java
@PostMapping("/logout")
public Result logout(HttpServletRequest request) {
    
    String token = request.getHeader("Authorization");
    
    if (token != null) {
        // 1. å°†TokenåŠ å…¥é»‘åå•ï¼ˆé˜²æ­¢ç»§ç»­ä½¿ç”¨ï¼‰
        tokenBlacklistService.addToBlacklist(token);
        
        // 2. è®°å½•é€€å‡ºæ—¥å¿—
        Long userId = jwtUtil.getUserIdFromToken(token);
        logService.recordLogout(userId);
    }
    
    return Result.success("é€€å‡ºæˆåŠŸ");
}
```

---

## 6. ğŸ”§ å¸¸è§é—®é¢˜è°ƒè¯•æ–¹æ³•


### 6.1 Tokenç›¸å…³é—®é¢˜


**â“ é—®é¢˜1ï¼šç™»å½•æˆåŠŸä½†è®¿é—®æ¥å£æç¤ºæœªç™»å½•**

**ğŸ” æ’æŸ¥æ­¥éª¤ï¼š**
```
1. æ£€æŸ¥Tokenæ˜¯å¦æ­£ç¡®ä¿å­˜
   console.log(localStorage.getItem('token'));

2. æ£€æŸ¥è¯·æ±‚å¤´æ˜¯å¦æ­£ç¡®æºå¸¦Token
   Networké¢æ¿æŸ¥çœ‹Request Headersä¸­çš„Authorization

3. æ£€æŸ¥Tokenæ ¼å¼æ˜¯å¦æ­£ç¡®
   Tokenå‰é¢å¯èƒ½éœ€è¦åŠ "Bearer "

4. æ£€æŸ¥Tokenæ˜¯å¦è¿‡æœŸ
   è§£ç JWTæŸ¥çœ‹expå­—æ®µ
```

**ğŸ’» è°ƒè¯•ä»£ç **
```javascript
// Tokenè°ƒè¯•å·¥å…·å‡½æ•°
function debugToken() {
    const token = localStorage.getItem('token');
    
    if (!token) {
        console.error('Tokenä¸å­˜åœ¨');
        return;
    }
    
    console.log('Token:', token);
    
    // å¦‚æœæ˜¯JWTï¼Œå¯ä»¥è§£ç æŸ¥çœ‹å†…å®¹
    try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        console.log('Tokenå†…å®¹:', payload);
        console.log('è¿‡æœŸæ—¶é—´:', new Date(payload.exp * 1000));
    } catch (e) {
        console.error('Tokenæ ¼å¼ä¸æ­£ç¡®');
    }
}
```

### 6.2 æƒé™ç›¸å…³é—®é¢˜


**â“ é—®é¢˜2ï¼šç”¨æˆ·æœ‰æƒé™ä½†æ¥å£è¿”å›æƒé™ä¸è¶³**

**ğŸ” æ’æŸ¥æ­¥éª¤ï¼š**
```
1. ç¡®è®¤ç”¨æˆ·è§’è‰²æ˜¯å¦æ­£ç¡®
   æŸ¥çœ‹æ•°æ®åº“ä¸­ç”¨æˆ·çš„roleå­—æ®µ

2. ç¡®è®¤æƒé™æ£€æŸ¥é€»è¾‘
   æ£€æŸ¥åç«¯æƒé™éªŒè¯ä»£ç 

3. ç¡®è®¤Tokenä¸­çš„ç”¨æˆ·ä¿¡æ¯
   è§£ç TokenæŸ¥çœ‹userIdæ˜¯å¦æ­£ç¡®

4. æ£€æŸ¥å¤§å°å†™æ•æ„Ÿé—®é¢˜
   è§’è‰²åç§°æ˜¯å¦åŒºåˆ†å¤§å°å†™
```

### 6.3 ç½‘ç»œè¯·æ±‚é—®é¢˜


**â“ é—®é¢˜3ï¼šTokenéªŒè¯æ€»æ˜¯å¤±è´¥**

**ğŸ” å¸¸è§åŸå› ï¼š**
```
1. è·¨åŸŸé—®é¢˜
   - æ£€æŸ¥CORSé…ç½®
   - ç¡®è®¤é¢„æ£€è¯·æ±‚æ˜¯å¦æˆåŠŸ

2. è¯·æ±‚å¤´æ ¼å¼é”™è¯¯
   - Authorization: Bearer token (æ³¨æ„ç©ºæ ¼)
   - ä¸æ˜¯ Authorization: token

3. Tokenè¢«æˆªæ–­
   - URLé•¿åº¦é™åˆ¶
   - HTTPå¤´é•¿åº¦é™åˆ¶

4. æ—¶é—´ä¸åŒæ­¥
   - æœåŠ¡å™¨æ—¶é—´ä¸å®¢æˆ·ç«¯æ—¶é—´ç›¸å·®å¤ªå¤§
```

**ğŸ’» ç½‘ç»œè°ƒè¯•ä»£ç **
```javascript
// å°è£…å¸¦Tokençš„è¯·æ±‚å‡½æ•°
async function apiRequest(url, options = {}) {
    const token = localStorage.getItem('token');
    
    const config = {
        ...options,
        headers: {
            'Content-Type': 'application/json',
            ...options.headers
        }
    };
    
    // æ·»åŠ Tokenåˆ°è¯·æ±‚å¤´
    if (token) {
        config.headers.Authorization = `Bearer ${token}`;
    }
    
    try {
        const response = await fetch(url, config);
        
        // è°ƒè¯•ä¿¡æ¯
        console.log('è¯·æ±‚URL:', url);
        console.log('è¯·æ±‚é…ç½®:', config);
        console.log('å“åº”çŠ¶æ€:', response.status);
        
        if (response.status === 401) {
            // Tokenå¯èƒ½è¿‡æœŸï¼Œè·³è½¬ç™»å½•
            localStorage.removeItem('token');
            window.location.href = '/login';
            return;
        }
        
        return await response.json();
    } catch (error) {
        console.error('è¯·æ±‚å¤±è´¥:', error);
        throw error;
    }
}
```

---

## 7. ğŸ¢ ä¼ä¸šçº§å®ç°æ–¹æ¡ˆ


### 7.1 Tokenç®¡ç†ç­–ç•¥


**ğŸ”¸ åŒTokenæœºåˆ¶**
```
Access Token (è®¿é—®ä»¤ç‰Œ)ï¼š
- æœ‰æ•ˆæœŸçŸ­ï¼ˆ15-30åˆ†é’Ÿï¼‰
- ç”¨äºæ—¥å¸¸APIè®¿é—®
- è¿‡æœŸåéœ€è¦åˆ·æ–°

Refresh Token (åˆ·æ–°ä»¤ç‰Œ)ï¼š
- æœ‰æ•ˆæœŸé•¿ï¼ˆ7-30å¤©ï¼‰
- ç”¨äºè·å–æ–°çš„Access Token
- æ›´å®‰å…¨ï¼Œä¸ç»å¸¸ä¼ è¾“
```

**ğŸ’» åŒTokenå®ç°**
```java
@PostMapping("/login")
public Result login(@RequestBody LoginRequest request) {
    
    // éªŒè¯ç”¨æˆ·ä¿¡æ¯...
    
    // ç”ŸæˆåŒToken
    String accessToken = jwtUtil.generateAccessToken(user.getId());
    String refreshToken = jwtUtil.generateRefreshToken(user.getId());
    
    // ä¿å­˜refresh tokenåˆ°æ•°æ®åº“
    refreshTokenService.save(user.getId(), refreshToken);
    
    TokenResponse response = new TokenResponse();
    response.setAccessToken(accessToken);
    response.setRefreshToken(refreshToken);
    response.setExpiresIn(30 * 60); // 30åˆ†é’Ÿ
    
    return Result.success(response);
}

// åˆ·æ–°Tokenæ¥å£
@PostMapping("/refresh")
public Result refreshToken(@RequestBody RefreshRequest request) {
    
    String refreshToken = request.getRefreshToken();
    
    // éªŒè¯refresh token
    if (!refreshTokenService.isValid(refreshToken)) {
        return Result.error("Refresh tokenæ— æ•ˆ");
    }
    
    Long userId = jwtUtil.getUserIdFromRefreshToken(refreshToken);
    
    // ç”Ÿæˆæ–°çš„access token
    String newAccessToken = jwtUtil.generateAccessToken(userId);
    
    TokenResponse response = new TokenResponse();
    response.setAccessToken(newAccessToken);
    response.setExpiresIn(30 * 60);
    
    return Result.success(response);
}
```

### 7.2 å®‰å…¨å¢å¼ºæªæ–½


**ğŸ”¸ Tokené»‘åå•æœºåˆ¶**
```java
@Service
public class TokenBlacklistService {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    // æ·»åŠ Tokenåˆ°é»‘åå•
    public void addToBlacklist(String token) {
        // è®¡ç®—Tokenå‰©ä½™æœ‰æ•ˆæ—¶é—´
        long expireTime = jwtUtil.getExpireTime(token);
        long ttl = expireTime - System.currentTimeMillis();
        
        if (ttl > 0) {
            // åœ¨Redisä¸­å­˜å‚¨ï¼Œè¿‡æœŸæ—¶é—´ç­‰äºTokenå‰©ä½™æ—¶é—´
            redisTemplate.opsForValue().set(
                "blacklist:" + token, 
                "1", 
                ttl, 
                TimeUnit.MILLISECONDS
            );
        }
    }
    
    // æ£€æŸ¥Tokenæ˜¯å¦åœ¨é»‘åå•ä¸­
    public boolean isBlacklisted(String token) {
        return redisTemplate.hasKey("blacklist:" + token);
    }
}
```

### 7.3 å¤šè®¾å¤‡ç™»å½•ç®¡ç†


**ğŸ’» è®¾å¤‡ç®¡ç†å®ç°**
```java
@Service
public class DeviceManager {
    
    // ç”¨æˆ·ç™»å½•æ—¶è®°å½•è®¾å¤‡ä¿¡æ¯
    public void recordDevice(Long userId, String deviceInfo, String token) {
        Device device = new Device();
        device.setUserId(userId);
        device.setDeviceInfo(deviceInfo);
        device.setToken(token);
        device.setLoginTime(new Date());
        
        deviceService.save(device);
        
        // é™åˆ¶åŒæ—¶ç™»å½•è®¾å¤‡æ•°é‡ï¼ˆæ¯”å¦‚æœ€å¤š3å°è®¾å¤‡ï¼‰
        List<Device> devices = deviceService.findByUserIdOrderByLoginTimeDesc(userId);
        if (devices.size() > 3) {
            // è¸¢æ‰æœ€æ—©ç™»å½•çš„è®¾å¤‡
            Device oldestDevice = devices.get(devices.size() - 1);
            tokenBlacklistService.addToBlacklist(oldestDevice.getToken());
            deviceService.delete(oldestDevice);
        }
    }
}
```

---

## 8. ğŸŒŸ ç”Ÿäº§ç¯å¢ƒæ³¨æ„äº‹é¡¹


### 8.1 å®‰å…¨é…ç½®è¦ç‚¹


**ğŸ” HTTPSå¿…é¡»å¯ç”¨**
```yaml
# application.yml
server:
  ssl:
    enabled: true
    key-store: classpath:keystore.p12
    key-store-password: password
    key-store-type: PKCS12
  port: 8443

# å¼ºåˆ¶HTTPSé‡å®šå‘
security:
  require-ssl: true
```

**ğŸ” Tokenå¯†é’¥ç®¡ç†**
```java
// ä¸è¦æŠŠå¯†é’¥å†™æ­»åœ¨ä»£ç é‡Œ
@Value("${jwt.secret}")
private String jwtSecret;

// ç”Ÿäº§ç¯å¢ƒåº”è¯¥ç”¨æ›´å¤æ‚çš„å¯†é’¥
// å»ºè®®ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é…ç½®ä¸­å¿ƒ
```

### 8.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®


**ğŸ“Š Redisç¼“å­˜Tokenä¿¡æ¯**
```java
@Service
public class TokenCacheService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // ç¼“å­˜ç”¨æˆ·Tokenä¿¡æ¯ï¼Œé¿å…é‡å¤è§£æ
    public void cacheTokenInfo(String token, TokenInfo tokenInfo) {
        redisTemplate.opsForValue().set(
            "token:info:" + token, 
            tokenInfo, 
            30, 
            TimeUnit.MINUTES
        );
    }
    
    public TokenInfo getTokenInfo(String token) {
        return (TokenInfo) redisTemplate.opsForValue().get("token:info:" + token);
    }
}
```

### 8.3 ç›‘æ§å’Œæ—¥å¿—


**ğŸ“ å…³é”®æ“ä½œæ—¥å¿—**
```java
@Service
public class SecurityLogService {
    
    private static final Logger logger = LoggerFactory.getLogger(SecurityLogService.class);
    
    // è®°å½•ç™»å½•æ—¥å¿—
    public void logLogin(String username, String ip, boolean success) {
        SecurityLog log = new SecurityLog();
        log.setAction("LOGIN");
        log.setUsername(username);
        log.setIpAddress(ip);
        log.setSuccess(success);
        log.setTimestamp(new Date());
        
        securityLogRepository.save(log);
        
        if (success) {
            logger.info("ç”¨æˆ· {} ä» {} æˆåŠŸç™»å½•", username, ip);
        } else {
            logger.warn("ç”¨æˆ· {} ä» {} ç™»å½•å¤±è´¥", username, ip);
        }
    }
    
    // è®°å½•æƒé™è¿è§„
    public void logUnauthorizedAccess(String username, String resource, String ip) {
        logger.warn("ç”¨æˆ· {} ä» {} è¯•å›¾è®¿é—®æ— æƒé™çš„èµ„æº: {}", username, ip, resource);
    }
}
```

### 8.4 å®¹å™¨åŒ–éƒ¨ç½²é…ç½®


**ğŸ³ Dockeré…ç½®ç¤ºä¾‹**
```dockerfile
# Dockerfile
FROM openjdk:11-jre-slim

# æ·»åŠ åº”ç”¨jar
COPY app.jar /app.jar

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV JWT_SECRET=your-production-secret
ENV REDIS_HOST=redis-server
ENV DB_HOST=mysql-server

# érootç”¨æˆ·è¿è¡Œ
RUN addgroup --system spring && adduser --system spring --ingroup spring
USER spring:spring

EXPOSE 8080
ENTRYPOINT ["java", "-jar", "/app.jar"]
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Tokenè®¤è¯åŸç†ï¼šç”¨æˆ·ç™»å½•åè·å–Tokenï¼Œåç»­è¯·æ±‚æºå¸¦Tokenè¯æ˜èº«ä»½
ğŸ”¸ å®Œæ•´ç™»å½•æµç¨‹ï¼šæ³¨å†Œâ†’ç™»å½•â†’è·å–Tokenâ†’æºå¸¦Tokenè®¿é—®â†’æƒé™éªŒè¯â†’é€€å‡ºç™»å½•
ğŸ”¸ æƒé™æ§åˆ¶æœºåˆ¶ï¼šåŸºäºè§’è‰²æ§åˆ¶ç”¨æˆ·èƒ½è®¿é—®å“ªäº›èµ„æº
ğŸ”¸ Tokenç®¡ç†ç­–ç•¥ï¼šæœ‰æ•ˆæœŸæ§åˆ¶ã€åˆ·æ–°æœºåˆ¶ã€é»‘åå•ç®¡ç†
ğŸ”¸ å®‰å…¨é˜²æŠ¤è¦ç‚¹ï¼šHTTPSä¼ è¾“ã€å¯†é’¥ä¿æŠ¤ã€è®¾å¤‡ç®¡ç†ã€æ“ä½œæ—¥å¿—
```

### 9.2 å…³é”®å®ç°è¦ç‚¹


**ğŸ”¹ å‰ç«¯Tokenå¤„ç†**
```
å­˜å‚¨ï¼šlocalStorageä¿å­˜Token
æºå¸¦ï¼šæ¯æ¬¡è¯·æ±‚æ·»åŠ Authorizationå¤´
å¤„ç†ï¼šTokenè¿‡æœŸæ—¶è‡ªåŠ¨è·³è½¬ç™»å½•
æ¸…é™¤ï¼šé€€å‡ºç™»å½•æ—¶åˆ é™¤æœ¬åœ°Token
```

**ğŸ”¹ åç«¯TokenéªŒè¯**
```
ç”Ÿæˆï¼šç™»å½•æˆåŠŸåç”ŸæˆåŒ…å«ç”¨æˆ·ä¿¡æ¯çš„Token
éªŒè¯ï¼šæ¯æ¬¡è¯·æ±‚æ£€æŸ¥Tokenæœ‰æ•ˆæ€§
æƒé™ï¼šæ ¹æ®Tokenä¸­çš„è§’è‰²ä¿¡æ¯æ§åˆ¶è®¿é—®
è¿‡æœŸï¼šè®¾ç½®åˆç†çš„Tokenè¿‡æœŸæ—¶é—´
```

**ğŸ”¹ å®‰å…¨è€ƒè™‘è¦ç‚¹**
```
ä¼ è¾“å®‰å…¨ï¼šä½¿ç”¨HTTPSä¼ è¾“Token
å­˜å‚¨å®‰å…¨ï¼šæ•æ„Ÿä¿¡æ¯ä¸æ”¾åœ¨Tokenä¸­
é˜²é‡æ”¾ï¼šTokenæ·»åŠ æ—¶é—´æˆ³å’Œéšæœºæ•°
é˜²ä¼ªé€ ï¼šä½¿ç”¨å¼ºå¯†é’¥ç­¾åToken
```

### 9.3 ç”Ÿäº§ç¯å¢ƒæ£€æŸ¥æ¸…å•


**â˜‘ï¸ å®‰å…¨æ£€æŸ¥**
- [ ] å¯ç”¨HTTPSä¼ è¾“
- [ ] Tokenå¯†é’¥è¶³å¤Ÿå¤æ‚
- [ ] è®¾ç½®åˆç†çš„Tokenè¿‡æœŸæ—¶é—´
- [ ] å®ç°Tokenåˆ·æ–°æœºåˆ¶
- [ ] æ·»åŠ Tokené»‘åå•åŠŸèƒ½

**â˜‘ï¸ æ€§èƒ½æ£€æŸ¥** 
- [ ] ä½¿ç”¨Redisç¼“å­˜Tokenä¿¡æ¯
- [ ] å®ç°æ•°æ®åº“è¿æ¥æ± 
- [ ] æ·»åŠ æ¥å£é™æµä¿æŠ¤
- [ ] ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢è¯­å¥

**â˜‘ï¸ ç›‘æ§æ£€æŸ¥**
- [ ] è®°å½•ç”¨æˆ·ç™»å½•æ—¥å¿—
- [ ] ç›‘æ§å¼‚å¸¸è®¿é—®è¡Œä¸º
- [ ] è®¾ç½®æ€§èƒ½ç›‘æ§æŒ‡æ ‡
- [ ] é…ç½®é”™è¯¯æŠ¥è­¦æœºåˆ¶

### 9.4 å¸¸è§é—®é¢˜å¿«é€Ÿè§£å†³


```
ğŸ”§ Tokenæ— æ•ˆï¼šæ£€æŸ¥æ ¼å¼ã€è¿‡æœŸæ—¶é—´ã€ç­¾åå¯†é’¥
ğŸ”§ æƒé™ä¸è¶³ï¼šç¡®è®¤ç”¨æˆ·è§’è‰²ã€æƒé™é…ç½®ã€Tokenå†…å®¹
ğŸ”§ è·¨åŸŸé—®é¢˜ï¼šé…ç½®CORSã€æ£€æŸ¥é¢„æ£€è¯·æ±‚
ğŸ”§ æ€§èƒ½é—®é¢˜ï¼šæ·»åŠ ç¼“å­˜ã€ä¼˜åŒ–æŸ¥è¯¢ã€ä½¿ç”¨è¿æ¥æ± 
ğŸ”§ å®‰å…¨é—®é¢˜ï¼šå¯ç”¨HTTPSã€ä¿æŠ¤å¯†é’¥ã€è®°å½•æ—¥å¿—
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- Tokenå°±åƒèº«ä»½è¯ï¼Œè¯æ˜ä½ æ˜¯è°
- ç™»å½•è·å–Tokenï¼Œè®¿é—®æºå¸¦Token
- æƒé™æ§åˆ¶å†³å®šä½ èƒ½åšä»€ä¹ˆ
- å®‰å…¨é…ç½®ä¿æŠ¤ç³»ç»Ÿä¸è¢«æ”»å‡»
- ç›‘æ§æ—¥å¿—å¸®åŠ©å‘ç°å’Œè§£å†³é—®é¢˜