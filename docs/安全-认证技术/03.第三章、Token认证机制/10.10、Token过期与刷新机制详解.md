---
title: 10ã€Tokenè¿‡æœŸä¸åˆ·æ–°æœºåˆ¶è¯¦è§£
---
## ğŸ“š ç›®å½•

1. [Tokenæœ‰æ•ˆæœŸè®¾è®¡](#1-Tokenæœ‰æ•ˆæœŸè®¾è®¡)
2. [åˆ·æ–°Tokenæœºåˆ¶è¯¦è§£](#2-åˆ·æ–°Tokenæœºåˆ¶è¯¦è§£)
3. [Access Tokenä¸Refresh Tokené…åˆ](#3-Access-Tokenä¸Refresh-Tokené…åˆ)
4. [å»¶è¿Ÿåˆ·æ–°ç­–ç•¥](#4-å»¶è¿Ÿåˆ·æ–°ç­–ç•¥)
5. [åˆ·æ–°Tokenå®‰å…¨æ€§é£é™©](#5-åˆ·æ–°Tokenå®‰å…¨æ€§é£é™©)
6. [åŒTokenè®¾è®¡æ¨¡å¼](#6-åŒTokenè®¾è®¡æ¨¡å¼)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ• Tokenæœ‰æ•ˆæœŸè®¾è®¡


### 1.1 ä»€ä¹ˆæ˜¯Tokenæœ‰æ•ˆæœŸ


**é€šä¿—ç†è§£**ï¼šTokenå°±åƒæ˜¯ä¸€å¼ æœ‰æ—¶é—´é™åˆ¶çš„é—¨ç¥¨ï¼Œè¿‡æœŸäº†å°±ä¸èƒ½å†ç”¨äº†ã€‚

```
ç±»æ¯”ç”Ÿæ´»åœºæ™¯ï¼š
ç”µå½±ç¥¨    â†’ åªåœ¨ç‰¹å®šæ—¶é—´æ®µæœ‰æ•ˆï¼Œè¿‡æœŸä½œåºŸ
èº«ä»½è¯    â†’ æœ‰å›ºå®šçš„æœ‰æ•ˆæœŸé™åˆ¶
ä¼šå‘˜å¡    â†’ å¯èƒ½æœ‰å¹´åº¦æˆ–æœˆåº¦çš„ä½¿ç”¨æœŸé™

Token     â†’ åœ¨ç½‘ç»œä¸–ç•Œä¸­çš„"ä¸´æ—¶é€šè¡Œè¯"
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦Tokenè¿‡æœŸ


**ğŸ” å®‰å…¨è€ƒè™‘**ï¼š
- **é™ä½æ³„éœ²é£é™©**ï¼šå³ä½¿Tokenè¢«ç›—ï¼Œå±å®³ä¹Ÿæœ‰æ—¶é—´é™åˆ¶
- **å‡å°‘æ»¥ç”¨**ï¼šé˜²æ­¢é•¿æœŸæ¶æ„ä½¿ç”¨
- **å¼ºåˆ¶é‡æ–°éªŒè¯**ï¼šå®šæœŸç¡®è®¤ç”¨æˆ·èº«ä»½çš„çœŸå®æ€§

**ğŸ’¡ ä¸¾ä¸ªä¾‹å­**ï¼š
```
å‡å¦‚ä½ çš„æ‰‹æœºä¸¢äº†ï¼Œé‡Œé¢ä¿å­˜çš„ç™»å½•ä¿¡æ¯ï¼š

æ²¡æœ‰è¿‡æœŸæ—¶é—´ï¼š
- æ¡åˆ°æ‰‹æœºçš„äººå¯ä»¥ä¸€ç›´ä½¿ç”¨ä½ çš„è´¦å·
- é£é™©æ— é™å»¶ç»­

æœ‰è¿‡æœŸæ—¶é—´ï¼š
- æœ€å¤šåªèƒ½ç”¨åˆ°Tokenè¿‡æœŸä¸ºæ­¢
- é£é™©è¢«æ§åˆ¶åœ¨æœ‰é™æ—¶é—´å†…
```

### 1.3 çŸ­æœŸToken vs é•¿æœŸToken


**ğŸ“Š è®¾è®¡å¯¹æ¯”**

| **ç‰¹å¾** | **çŸ­æœŸTokenï¼ˆ5-30åˆ†é’Ÿï¼‰** | **é•¿æœŸTokenï¼ˆ7-30å¤©ï¼‰** |
|---------|-------------------------|----------------------|
| **å®‰å…¨æ€§** | `ğŸŸ¢ é«˜` | `ğŸŸ¡ ä¸­` |
| **ç”¨æˆ·ä½“éªŒ** | `ğŸŸ¡ é¢‘ç¹é‡æ–°ç™»å½•` | `ğŸŸ¢ ä½¿ç”¨æ–¹ä¾¿` |
| **é£é™©æ§åˆ¶** | `ğŸŸ¢ é£é™©å°` | `ğŸ”´ é£é™©å¤§` |
| **é€‚ç”¨åœºæ™¯** | `é“¶è¡Œã€æ”¯ä»˜åº”ç”¨` | `ç¤¾äº¤ã€å¨±ä¹åº”ç”¨` |

### 1.4 æœ‰æ•ˆæœŸè®¾è®¡åŸåˆ™


**âš–ï¸ å¹³è¡¡è€ƒè™‘**ï¼š
```
å®‰å…¨æ€§ â†-----|-----â†’ ç”¨æˆ·ä½“éªŒ
        å¹³è¡¡ç‚¹

è¿‡çŸ­ï¼ˆ1-5åˆ†é’Ÿï¼‰ï¼š
âœ… æé«˜å®‰å…¨æ€§
âŒ ç”¨æˆ·ä½“éªŒæå·®ï¼Œé¢‘ç¹é‡æ–°è®¤è¯

é€‚ä¸­ï¼ˆ15-30åˆ†é’Ÿï¼‰ï¼š
âœ… è¾ƒå¥½çš„å®‰å…¨æ€§
âœ… å¯æ¥å—çš„ç”¨æˆ·ä½“éªŒ

è¿‡é•¿ï¼ˆæ•°å°æ—¶/æ•°å¤©ï¼‰ï¼š
âœ… ç”¨æˆ·ä½“éªŒå¥½
âŒ å®‰å…¨é£é™©å¢åŠ 
```

**ğŸ¯ å®é™…åº”ç”¨åœºæ™¯**ï¼š
```
é«˜å®‰å…¨è¦æ±‚ï¼š
- ç½‘é“¶æ”¯ä»˜ï¼š5-15åˆ†é’Ÿ
- åå°ç®¡ç†ï¼š10-30åˆ†é’Ÿ

ä¸€èˆ¬åº”ç”¨ï¼š
- ç”µå•†è´­ç‰©ï¼š30åˆ†é’Ÿ-2å°æ—¶
- ç¤¾äº¤åº”ç”¨ï¼š2-24å°æ—¶

ä½é£é™©åº”ç”¨ï¼š
- æ–°é—»é˜…è¯»ï¼š1-7å¤©
- å¨±ä¹æ¸¸æˆï¼š7-30å¤©
```

---

## 2. ğŸ”„ åˆ·æ–°Tokenæœºåˆ¶è¯¦è§£


### 2.1 ä»€ä¹ˆæ˜¯åˆ·æ–°Token


**ç®€å•ç†è§£**ï¼šåˆ·æ–°Tokenå°±åƒæ˜¯"ç»­è´¹å¡"ï¼Œå½“ä½ çš„é—¨ç¥¨å¿«åˆ°æœŸæ—¶ï¼Œç”¨å®ƒå¯ä»¥æ¢ä¸€å¼ æ–°é—¨ç¥¨ã€‚

```
ç”Ÿæ´»ç±»æ¯”ï¼š
å›¾ä¹¦é¦†å€Ÿä¹¦è¯åˆ°æœŸ â†’ ç”¨å­¦ç”Ÿè¯ç»­åŠ â†’ è·å¾—æ–°çš„å€Ÿä¹¦è¯

ç½‘ç»œè®¤è¯ä¸­ï¼š
Access Tokenåˆ°æœŸ â†’ ç”¨Refresh Token â†’ è·å¾—æ–°çš„Access Token
```

### 2.2 ä¸ºä»€ä¹ˆéœ€è¦åˆ·æ–°Token


**ğŸ¤” è§£å†³çš„é—®é¢˜**ï¼š
- **é¿å…é¢‘ç¹ç™»å½•**ï¼šç”¨æˆ·ä¸éœ€è¦åå¤è¾“å…¥ç”¨æˆ·åå¯†ç 
- **ä¿æŒç™»å½•çŠ¶æ€**ï¼šåœ¨ä¸å½±å“å®‰å…¨çš„å‰æä¸‹å»¶é•¿ä½¿ç”¨æ—¶é—´
- **å¹³è¡¡å®‰å…¨ä¸ä½“éªŒ**ï¼šæ—¢ä¿è¯å®‰å…¨åˆä¸å½±å“ç”¨æˆ·ä½¿ç”¨

**ğŸ” å…·ä½“åœºæ™¯**ï¼š
```
æ²¡æœ‰åˆ·æ–°æœºåˆ¶æ—¶ï¼š
ç”¨æˆ·ç™»å½• â†’ ä½¿ç”¨30åˆ†é’Ÿ â†’ Tokenè¿‡æœŸ â†’ å¿…é¡»é‡æ–°ç™»å½• â†’ ç”¨æˆ·ä½“éªŒå·®

æœ‰åˆ·æ–°æœºåˆ¶æ—¶ï¼š
ç”¨æˆ·ç™»å½• â†’ ä½¿ç”¨30åˆ†é’Ÿ â†’ Tokenè¿‡æœŸ â†’ è‡ªåŠ¨åˆ·æ–° â†’ ç»§ç»­ä½¿ç”¨ â†’ ä½“éªŒå¥½
```

### 2.3 åˆ·æ–°Tokençš„å·¥ä½œåŸç†


**ğŸ”„ åŸºæœ¬æµç¨‹**ï¼š
```
å®¢æˆ·ç«¯                     æœåŠ¡å™¨
  |                         |
  |--[1] è®¿é—®èµ„æº----------->|
  |                         |
  |<-[2] Tokenè¿‡æœŸé”™è¯¯------|
  |    (401 Unauthorized)   |
  |                         |
  |--[3] å‘é€Refresh Token->|
  |                         |
  |<-[4] è¿”å›æ–°Token-------|
  |    (æ–°Access Token)     |
  |                         |
  |--[5] ç”¨æ–°Tokenè®¿é—®----->|
  |                         |
  |<-[6] è¿”å›èµ„æºæ•°æ®-------|
```

**ğŸ’» ç®€åŒ–ä»£ç ç¤ºä¾‹**ï¼š
```javascript
// è‡ªåŠ¨åˆ·æ–°Tokençš„æœºåˆ¶
async function makeApiRequest(url) {
    let token = localStorage.getItem('accessToken');
    
    // ç¬¬ä¸€æ¬¡å°è¯•
    let response = await fetch(url, {
        headers: { 'Authorization': `Bearer ${token}` }
    });
    
    // å¦‚æœTokenè¿‡æœŸ
    if (response.status === 401) {
        // ä½¿ç”¨RefreshTokenè·å–æ–°Token
        const newToken = await refreshAccessToken();
        
        // ç”¨æ–°Tokené‡æ–°è¯·æ±‚
        response = await fetch(url, {
            headers: { 'Authorization': `Bearer ${newToken}` }
        });
    }
    
    return response;
}

async function refreshAccessToken() {
    const refreshToken = localStorage.getItem('refreshToken');
    
    const response = await fetch('/auth/refresh', {
        method: 'POST',
        body: JSON.stringify({ refreshToken }),
        headers: { 'Content-Type': 'application/json' }
    });
    
    const data = await response.json();
    localStorage.setItem('accessToken', data.accessToken);
    
    return data.accessToken;
}
```

---

## 3. ğŸ¤ Access Tokenä¸Refresh Tokené…åˆ


### 3.1 åŒTokenæ¨¡å¼çš„æ¦‚å¿µ


**ğŸ­ è§’è‰²åˆ†å·¥**ï¼š
```
Access Tokenï¼ˆè®¿é—®ä»¤ç‰Œï¼‰ï¼š
- ä½œç”¨ï¼šå®é™…è®¿é—®èµ„æºçš„"é’¥åŒ™"
- ç‰¹ç‚¹ï¼šæœ‰æ•ˆæœŸçŸ­ï¼ˆ15-30åˆ†é’Ÿï¼‰
- ä½¿ç”¨ï¼šæ¯æ¬¡APIè°ƒç”¨éƒ½è¦æºå¸¦

Refresh Tokenï¼ˆåˆ·æ–°ä»¤ç‰Œï¼‰ï¼š
- ä½œç”¨ï¼šè·å–æ–°Access Tokençš„"å‡­è¯"
- ç‰¹ç‚¹ï¼šæœ‰æ•ˆæœŸé•¿ï¼ˆ7-30å¤©ï¼‰
- ä½¿ç”¨ï¼šåªåœ¨åˆ·æ–°æ—¶ä½¿ç”¨
```

**ğŸ  ç”Ÿæ´»ç±»æ¯”**ï¼š
```
ä½ ä½é…’åº—çš„åœºæ™¯ï¼š

æˆ¿å¡ï¼ˆAccess Tokenï¼‰ï¼š
- å¼€æˆ¿é—¨ã€åç”µæ¢¯ã€ç”¨è®¾æ–½
- æ¯å¤©æ™šä¸Š12ç‚¹å¤±æ•ˆ
- éœ€è¦ç»å¸¸ä½¿ç”¨

èº«ä»½è¯ï¼ˆRefresh Tokenï¼‰ï¼š
- åˆ°å‰å°æ¢æ–°æˆ¿å¡
- æ•´ä¸ªä½åº—æœŸé—´æœ‰æ•ˆ
- åªåœ¨æ¢æˆ¿å¡æ—¶ä½¿ç”¨
```

### 3.2 åŒTokençš„å®‰å…¨è®¾è®¡


**ğŸ”’ åˆ†å±‚é˜²æŠ¤**ï¼š
```
                 é£é™©çº§åˆ«å¯¹æ¯”
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
Access Token    â†’    â”‚ é«˜é£é™©   â”‚ â†’ çŸ­æœŸæœ‰æ•ˆï¼Œé¢‘ç¹ä½¿ç”¨
                     â”‚ çŸ­æ—¶æ•ˆ   â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
Refresh Token   â†’    â”‚ ä¸­é£é™©   â”‚ â†’ é•¿æœŸæœ‰æ•ˆï¼Œå°‘é‡ä½¿ç”¨
                     â”‚ é•¿æ—¶æ•ˆ   â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ’¡ å®‰å…¨ä¼˜åŠ¿**ï¼š
- **éš”ç¦»é£é™©**ï¼šå³ä½¿Access Tokenè¢«ç›—ï¼Œå½±å“æ—¶é—´æœ‰é™
- **å‡å°‘æš´éœ²**ï¼šRefresh Tokenä½¿ç”¨é¢‘ç‡ä½ï¼Œè¢«æˆªè·æ¦‚ç‡å°
- **åŒé‡ä¿æŠ¤**ï¼šéœ€è¦åŒæ—¶è·å–ä¸¤ä¸ªTokenæ‰èƒ½é€ æˆé•¿æœŸå±å®³

### 3.3 Tokenå­˜å‚¨ç­–ç•¥


**ğŸ“± å®¢æˆ·ç«¯å­˜å‚¨æ–¹æ¡ˆ**ï¼š

```javascript
// å®‰å…¨å­˜å‚¨å»ºè®®
const tokenStorage = {
    // Access Tokenï¼šå¯ä»¥å­˜åœ¨å†…å­˜æˆ–sessionStorage
    setAccessToken(token) {
        // æ–¹æ¡ˆ1ï¼šå­˜å†…å­˜ï¼ˆæœ€å®‰å…¨ï¼Œä½†åˆ·æ–°é¡µé¢ä¸¢å¤±ï¼‰
        this.accessToken = token;
        
        // æ–¹æ¡ˆ2ï¼šsessionStorageï¼ˆåˆ·æ–°é¡µé¢ä¿æŒï¼Œå…³é—­æ ‡ç­¾é¡µä¸¢å¤±ï¼‰
        sessionStorage.setItem('accessToken', token);
    },
    
    // Refresh Tokenï¼šå»ºè®®å­˜åœ¨httpOnly cookieæˆ–å®‰å…¨çš„localStorage
    setRefreshToken(token) {
        // æœ€ä½³æ–¹æ¡ˆï¼šåç«¯è®¾ç½®httpOnly cookie
        // å¤‡é€‰æ–¹æ¡ˆï¼šåŠ å¯†åå­˜localStorage
        localStorage.setItem('refreshToken', encrypt(token));
    }
};
```

---

## 4. ğŸ•°ï¸ å»¶è¿Ÿåˆ·æ–°ç­–ç•¥


### 4.1 ä»€ä¹ˆæ˜¯å»¶è¿Ÿåˆ·æ–°ï¼ˆSliding Sessionï¼‰


**é€šä¿—è§£é‡Š**ï¼šå»¶è¿Ÿåˆ·æ–°å°±åƒ"æ´»è·ƒç»­è´¹"ï¼Œåªè¦ä½ åœ¨ä½¿ç”¨ï¼Œæ—¶é—´å°±ä¼šè‡ªåŠ¨å»¶é•¿ã€‚

```
ä¼ ç»Ÿå›ºå®šè¿‡æœŸï¼š
ç™»å½•æ—¶é—´: 9:00
è¿‡æœŸæ—¶é—´: 9:30 (å›ºå®š30åˆ†é’Ÿå)
ç»“æœ: æ— è®ºæ˜¯å¦ä½¿ç”¨ï¼Œ9:30å¿…é¡»é‡æ–°ç™»å½•

å»¶è¿Ÿåˆ·æ–°ï¼š
ç™»å½•æ—¶é—´: 9:00
æœ€åæ´»è·ƒ: 9:25 (ç”¨æˆ·åœ¨ä½¿ç”¨)
è¿‡æœŸæ—¶é—´: 9:55 (ä»æœ€åæ´»è·ƒæ—¶é—´å»¶é•¿30åˆ†é’Ÿ)
ç»“æœ: åªè¦åœ¨ä½¿ç”¨ï¼Œå°±ä¸ä¼šè¿‡æœŸ
```

### 4.2 å»¶è¿Ÿåˆ·æ–°çš„å®ç°æ–¹å¼


**âš¡ å®ç°ç­–ç•¥**ï¼š

```javascript
// å»¶è¿Ÿåˆ·æ–°çš„æ ¸å¿ƒé€»è¾‘
class SlidingSession {
    constructor() {
        this.lastActivity = Date.now();
        this.sessionTimeout = 30 * 60 * 1000; // 30åˆ†é’Ÿ
        this.checkInterval = 5 * 60 * 1000;   // 5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    }
    
    // è®°å½•ç”¨æˆ·æ´»è·ƒ
    updateActivity() {
        this.lastActivity = Date.now();
        console.log('ç”¨æˆ·æ´»è·ƒæ—¶é—´æ›´æ–°');
    }
    
    // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ·æ–°
    checkAndRefresh() {
        const now = Date.now();
        const timeSinceLastActivity = now - this.lastActivity;
        
        // å¦‚æœè·ç¦»ä¸Šæ¬¡æ´»è·ƒè¶…è¿‡15åˆ†é’Ÿï¼Œæå‰åˆ·æ–°Token
        if (timeSinceLastActivity > 15 * 60 * 1000) {
            this.refreshToken();
        }
    }
    
    // ç›‘å¬ç”¨æˆ·æ´»è·ƒäº‹ä»¶
    startMonitoring() {
        // ç›‘å¬å„ç§ç”¨æˆ·æ´»è·ƒè¡Œä¸º
        document.addEventListener('click', () => this.updateActivity());
        document.addEventListener('keypress', () => this.updateActivity());
        document.addEventListener('scroll', () => this.updateActivity());
        
        // å®šæœŸæ£€æŸ¥
        setInterval(() => this.checkAndRefresh(), this.checkInterval);
    }
}
```

### 4.3 å»¶è¿Ÿåˆ·æ–°çš„ä¼˜ç¼ºç‚¹


**âœ… ä¼˜åŠ¿**ï¼š
- **ç”¨æˆ·ä½“éªŒå¥½**ï¼šæ´»è·ƒç”¨æˆ·æ°¸è¿œä¸ä¼šè¢«å¼ºåˆ¶ç™»å‡º
- **ç¬¦åˆä½¿ç”¨ä¹ æƒ¯**ï¼šæ¨¡æ‹Ÿç°å®ä¸­"æ­£åœ¨ä½¿ç”¨å°±ä¸ä¼šè¿‡æœŸ"çš„é€»è¾‘
- **å‡å°‘æ‰“æ–­**ï¼šé¿å…åœ¨ç”¨æˆ·æ“ä½œè¿‡ç¨‹ä¸­çªç„¶è¦æ±‚é‡æ–°ç™»å½•

**âŒ ç¼ºç‚¹**ï¼š
- **å®‰å…¨é£é™©**ï¼šå¦‚æœç”¨æˆ·å¿˜è®°æ³¨é”€ï¼ŒTokenå¯èƒ½é•¿æœŸæœ‰æ•ˆ
- **å®ç°å¤æ‚**ï¼šéœ€è¦å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯é…åˆç›‘æ§æ´»è·ƒçŠ¶æ€
- **èµ„æºæ¶ˆè€—**ï¼šéœ€è¦æŒç»­ç›‘æ§å’Œè®°å½•ç”¨æˆ·æ´»è·ƒçŠ¶æ€

**ğŸ¯ é€‚ç”¨åœºæ™¯**ï¼š
```
é€‚åˆå»¶è¿Ÿåˆ·æ–°ï¼š
- é•¿æ—¶é—´å·¥ä½œçš„åå°ç³»ç»Ÿ
- åœ¨çº¿ç¼–è¾‘å™¨ã€IDE
- é•¿è§†é¢‘è§‚çœ‹åº”ç”¨

ä¸é€‚åˆå»¶è¿Ÿåˆ·æ–°ï¼š
- é“¶è¡Œã€æ”¯ä»˜ç±»åº”ç”¨
- æ¶‰åŠæ•æ„Ÿæ“ä½œçš„ç³»ç»Ÿ
- å…¬å…±è®¾å¤‡ä½¿ç”¨çš„åº”ç”¨
```

---

## 5. âš ï¸ åˆ·æ–°Tokenå®‰å…¨æ€§é£é™©


### 5.1 å¸¸è§å®‰å…¨é£é™©


**ğŸš¨ ä¸»è¦å®‰å…¨å¨èƒ**ï¼š

```
é£é™©ç±»å‹åˆ†æï¼š

1. Refresh Tokenæ³„éœ²ï¼š
   â”œâ”€ å­˜å‚¨ä¸å½“ï¼ˆæ˜æ–‡å­˜å‚¨ï¼‰
   â”œâ”€ ç½‘ç»œä¼ è¾“è¢«æˆªè·
   â””â”€ XSSæ”»å‡»è·å–

2. é‡æ”¾æ”»å‡»ï¼š
   â”œâ”€ æ—§çš„Refresh Tokenè¢«å¤ç”¨
   â”œâ”€ ç½‘ç»œè¯·æ±‚è¢«é‡å¤å‘é€
   â””â”€ ç¼ºå°‘ä¸€æ¬¡æ€§éªŒè¯

3. é•¿æœŸæœ‰æ•ˆæ€§é£é™©ï¼š
   â”œâ”€ ç”¨æˆ·è®¾å¤‡ä¸¢å¤±
   â”œâ”€ è´¦æˆ·è¢«é•¿æœŸæ§åˆ¶
   â””â”€ éš¾ä»¥åŠæ—¶å‘ç°å¼‚å¸¸
```

### 5.2 Refresh Tokenè¢«ç›—ç”¨çš„åæœ


**ğŸ’¥ å±å®³åˆ†æ**ï¼š
```
å‡è®¾åœºæ™¯ï¼šé»‘å®¢è·å–äº†ä½ çš„Refresh Token

immediate dangerï¼ˆç«‹å³å±é™©ï¼‰ï¼š
- å¯ä»¥è·å–æ–°çš„Access Token
- èƒ½å¤Ÿè®¿é—®ä½ çš„è´¦æˆ·èµ„æº
- åœ¨Refresh Tokenæœ‰æ•ˆæœŸå†…æŒç»­è®¿é—®

Long-term risksï¼ˆé•¿æœŸé£é™©ï¼‰ï¼š
- å³ä½¿ä½ ä¿®æ”¹å¯†ç ä¹Ÿæ— æ•ˆ
- é»‘å®¢å¯ä»¥"ç»­è´¹"è®¿é—®æƒé™
- å¾ˆéš¾è¢«å‘ç°ï¼ˆå› ä¸ºä¸éœ€è¦è¾“å…¥å¯†ç ï¼‰
```

**ğŸ” çœŸå®æ¡ˆä¾‹åœºæ™¯**ï¼š
```
ç”¨æˆ·å°æ˜çš„é­é‡ï¼š
1. åœ¨å…¬å…±WiFiä¸‹ä½¿ç”¨åº”ç”¨
2. ç½‘ç»œè¯·æ±‚è¢«ä¸­é—´äººæ”»å‡»æˆªè·
3. é»‘å®¢è·å¾—Refresh Token
4. é»‘å®¢å¯ä»¥æŒç»­30å¤©è®¿é—®å°æ˜è´¦æˆ·
5. å°æ˜æµ‘ç„¶ä¸çŸ¥ï¼Œç›´åˆ°å‘ç°å¼‚å¸¸æ“ä½œ
```

### 5.3 å®‰å…¨é˜²æŠ¤æªæ–½


**ğŸ›¡ï¸ é˜²æŠ¤ç­–ç•¥**ï¼š

```javascript
// å®‰å…¨çš„åˆ·æ–°Tokenå®ç°
const secureRefreshToken = {
    // 1. Tokenè½®æ¢ï¼ˆæ¯æ¬¡åˆ·æ–°éƒ½æ¢æ–°çš„Refresh Tokenï¼‰
    async refreshTokens(refreshToken) {
        const response = await fetch('/auth/refresh', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                refreshToken: refreshToken,
                // æ·»åŠ è®¾å¤‡æŒ‡çº¹
                deviceId: getDeviceFingerprint(),
                // æ·»åŠ æ—¶é—´æˆ³é˜²é‡æ”¾
                timestamp: Date.now()
            })
        });
        
        const data = await response.json();
        
        // é‡è¦ï¼šæ—§çš„Refresh Tokenç«‹å³å¤±æ•ˆ
        // æ–°çš„Access Tokenå’ŒRefresh Tokenéƒ½è¦æ›´æ–°
        return {
            accessToken: data.accessToken,
            refreshToken: data.refreshToken, // æ–°çš„ï¼
        };
    },
    
    // 2. è®¾å¤‡ç»‘å®šæ£€æŸ¥
    getDeviceFingerprint() {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        ctx.textBaseline = 'top';
        ctx.font = '14px Arial';
        ctx.fillText('Device fingerprint', 2, 2);
        
        return btoa(JSON.stringify({
            canvas: canvas.toDataURL(),
            userAgent: navigator.userAgent,
            language: navigator.language,
            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
        }));
    }
};
```

**ğŸ”’ æœåŠ¡ç«¯å®‰å…¨æªæ–½**ï¼š
```javascript
// æœåŠ¡ç«¯çš„å®‰å…¨æ£€æŸ¥
const serverSecurityChecks = {
    async validateRefreshToken(req, res) {
        const { refreshToken, deviceId, timestamp } = req.body;
        
        // 1. æ£€æŸ¥æ—¶é—´æˆ³ï¼ˆé˜²é‡æ”¾æ”»å‡»ï¼‰
        if (Date.now() - timestamp > 60000) { // è¶…è¿‡1åˆ†é’Ÿ
            return res.status(401).json({ error: 'Request expired' });
        }
        
        // 2. æ£€æŸ¥è®¾å¤‡æŒ‡çº¹
        const storedDeviceId = await getStoredDeviceId(refreshToken);
        if (deviceId !== storedDeviceId) {
            return res.status(401).json({ error: 'Device mismatch' });
        }
        
        // 3. æ£€æŸ¥Tokenæ˜¯å¦åœ¨é»‘åå•
        if (await isTokenBlacklisted(refreshToken)) {
            return res.status(401).json({ error: 'Token revoked' });
        }
        
        // 4. ç”Ÿæˆæ–°Tokenå¹¶ä½¿æ—§Tokenå¤±æ•ˆ
        const newTokens = await generateNewTokenPair(refreshToken);
        await revokeOldRefreshToken(refreshToken);
        
        return res.json(newTokens);
    }
};
```

---

## 6. ğŸ¯ åŒTokenè®¾è®¡æ¨¡å¼


### 6.1 åŒTokenæ¨¡å¼çš„æ ¸å¿ƒæ€æƒ³


**ğŸ§  è®¾è®¡ç†å¿µ**ï¼šå°†"ä½¿ç”¨æƒé™"å’Œ"æ›´æ–°æƒé™"åˆ†ç¦»ï¼Œé™ä½æ•´ä½“å®‰å…¨é£é™©ã€‚

```
ä¼ ç»Ÿå•Tokenæ¨¡å¼ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä¸€ä¸ªTokenå¹²æ‰€æœ‰äº‹  â”‚ â† é£é™©é›†ä¸­
â”‚  â”œâ”€ è®¿é—®èµ„æº        â”‚
â”‚  â”œâ”€ ä¿æŒç™»å½•çŠ¶æ€     â”‚
â”‚  â””â”€ é•¿æœŸæœ‰æ•ˆ        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åŒTokenæ¨¡å¼ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Access Token       â”‚    â”‚  Refresh Token      â”‚
â”‚  â”œâ”€ è®¿é—®èµ„æº        â”‚    â”‚  â”œâ”€ æ›´æ–°Access Tokenâ”‚
â”‚  â”œâ”€ çŸ­æœŸæœ‰æ•ˆ(30åˆ†é’Ÿ) â”‚    â”‚  â”œâ”€ é•¿æœŸæœ‰æ•ˆ(30å¤©)  â”‚
â”‚  â””â”€ é¢‘ç¹ä½¿ç”¨        â”‚    â”‚  â””â”€ å¶å°”ä½¿ç”¨        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†‘                           â”‚
         â””â”€â”€â”€â”€â”€ è¢«ç›—é£é™©åˆ†æ•£ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 åŒTokenæ¨¡å¼çš„å®Œæ•´æµç¨‹


**ğŸ”„ å®Œæ•´è®¤è¯æµç¨‹**ï¼š

```
ç¬¬ä¸€æ­¥ï¼šç”¨æˆ·ç™»å½•
ç”¨æˆ·  â”€â”€[ç”¨æˆ·å/å¯†ç ]â”€â”€â†’  æœåŠ¡å™¨
ç”¨æˆ·  â†â”€[åŒTokenè¿”å›]â”€â”€â”€   æœåŠ¡å™¨

ç¬¬äºŒæ­¥ï¼šæ­£å¸¸ä½¿ç”¨ï¼ˆçŸ­æœŸå¾ªç¯ï¼‰
ç”¨æˆ·  â”€â”€[Access Token]â”€â†’  APIæœåŠ¡
ç”¨æˆ·  â†â”€[è¿”å›æ•°æ®]â”€â”€â”€â”€â”€â”€   APIæœåŠ¡

ç¬¬ä¸‰æ­¥ï¼šTokenè¿‡æœŸåˆ·æ–°
ç”¨æˆ·  â”€â”€[Access Token]â”€â†’  APIæœåŠ¡
ç”¨æˆ·  â†â”€[401è¿‡æœŸé”™è¯¯]â”€â”€â”€   APIæœåŠ¡
ç”¨æˆ·  â”€â”€[Refresh Token]â†’  è®¤è¯æœåŠ¡
ç”¨æˆ·  â†â”€[æ–°Access Token]â”€  è®¤è¯æœåŠ¡
ç”¨æˆ·  â”€â”€[æ–°Access Token]â†’ APIæœåŠ¡
ç”¨æˆ·  â†â”€[è¿”å›æ•°æ®]â”€â”€â”€â”€â”€â”€   APIæœåŠ¡

ç¬¬å››æ­¥ï¼šé•¿æœŸè¿‡æœŸé‡æ–°ç™»å½•
ç”¨æˆ·  â”€â”€[Refresh Token]â†’  è®¤è¯æœåŠ¡
ç”¨æˆ·  â†â”€[401è¿‡æœŸé”™è¯¯]â”€â”€â”€   è®¤è¯æœåŠ¡
ç”¨æˆ·  â”€â”€[é‡æ–°ç™»å½•]â”€â”€â”€â”€â”€â”€â†’  è®¤è¯æœåŠ¡
```

### 6.3 æœ€ä½³å®è·µå®ç°


**ğŸ’ ç”Ÿäº§çº§å®ç°ç¤ºä¾‹**ï¼š

```javascript
class TokenManager {
    constructor() {
        this.accessToken = null;
        this.refreshToken = null;
        this.refreshPromise = null; // é˜²æ­¢å¹¶å‘åˆ·æ–°
    }
    
    // ç»Ÿä¸€çš„è¯·æ±‚æ–¹æ³•
    async request(url, options = {}) {
        // ç¡®ä¿æœ‰æœ‰æ•ˆçš„Access Token
        await this.ensureValidAccessToken();
        
        // æ·»åŠ è®¤è¯å¤´
        const headers = {
            ...options.headers,
            'Authorization': `Bearer ${this.accessToken}`
        };
        
        const response = await fetch(url, {
            ...options,
            headers
        });
        
        // å¤„ç†Tokenè¿‡æœŸ
        if (response.status === 401) {
            await this.refreshAccessToken();
            // é‡è¯•è¯·æ±‚
            return fetch(url, {
                ...options,
                headers: {
                    ...options.headers,
                    'Authorization': `Bearer ${this.accessToken}`
                }
            });
        }
        
        return response;
    }
    
    // ç¡®ä¿Access Tokenæœ‰æ•ˆ
    async ensureValidAccessToken() {
        if (!this.accessToken || this.isTokenExpiringSoon()) {
            await this.refreshAccessToken();
        }
    }
    
    // åˆ·æ–°Access Token
    async refreshAccessToken() {
        // é˜²æ­¢å¹¶å‘åˆ·æ–°
        if (this.refreshPromise) {
            return this.refreshPromise;
        }
        
        this.refreshPromise = this.performRefresh();
        
        try {
            await this.refreshPromise;
        } finally {
            this.refreshPromise = null;
        }
    }
    
    // æ‰§è¡Œå®é™…åˆ·æ–°
    async performRefresh() {
        if (!this.refreshToken) {
            throw new Error('No refresh token available');
        }
        
        const response = await fetch('/auth/refresh', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                refreshToken: this.refreshToken
            })
        });
        
        if (response.ok) {
            const data = await response.json();
            this.accessToken = data.accessToken;
            // å¦‚æœè¿”å›æ–°çš„Refresh Tokenï¼Œæ›´æ–°å®ƒ
            if (data.refreshToken) {
                this.refreshToken = data.refreshToken;
            }
            this.saveTokens();
        } else {
            // Refresh Tokenä¹Ÿè¿‡æœŸäº†ï¼Œéœ€è¦é‡æ–°ç™»å½•
            this.clearTokens();
            throw new Error('Refresh token expired, please login again');
        }
    }
    
    // æ£€æŸ¥Tokenæ˜¯å¦å³å°†è¿‡æœŸ
    isTokenExpiringSoon() {
        if (!this.accessToken) return true;
        
        // è§£æJWTè·å–è¿‡æœŸæ—¶é—´
        const payload = JSON.parse(atob(this.accessToken.split('.')[1]));
        const expiry = payload.exp * 1000;
        const now = Date.now();
        
        // å¦‚æœ5åˆ†é’Ÿå†…è¿‡æœŸï¼Œå°±æå‰åˆ·æ–°
        return (expiry - now) < 5 * 60 * 1000;
    }
    
    // ä¿å­˜Tokenåˆ°æœ¬åœ°
    saveTokens() {
        localStorage.setItem('refreshToken', this.refreshToken);
        sessionStorage.setItem('accessToken', this.accessToken);
    }
    
    // æ¸…é™¤æ‰€æœ‰Token
    clearTokens() {
        this.accessToken = null;
        this.refreshToken = null;
        localStorage.removeItem('refreshToken');
        sessionStorage.removeItem('accessToken');
    }
}

// ä½¿ç”¨ç¤ºä¾‹
const tokenManager = new TokenManager();

// ç®€å•çš„APIè°ƒç”¨ï¼Œè‡ªåŠ¨å¤„ç†Tokenåˆ·æ–°
async function getUserProfile() {
    const response = await tokenManager.request('/api/user/profile');
    return response.json();
}
```

### 6.4 åŒTokenæ¨¡å¼çš„å˜ç§


**ğŸ¨ å¸¸è§è®¾è®¡å˜ç§**ï¼š

```
1. åŸºç¡€åŒTokenæ¨¡å¼ï¼š
   Access Token(30åˆ†é’Ÿ) + Refresh Token(30å¤©)

2. å¤šçº§Tokenæ¨¡å¼ï¼š
   Access Token(15åˆ†é’Ÿ) + Refresh Token(7å¤©) + Long-term Token(90å¤©)

3. æ»‘åŠ¨çª—å£æ¨¡å¼ï¼š
   Access Token(åŠ¨æ€è¿‡æœŸ) + Refresh Token(å›ºå®šè¿‡æœŸ)

4. è®¾å¤‡ç»‘å®šæ¨¡å¼ï¼š
   Access Token + Refresh Token + Device Token(è®¾å¤‡å”¯ä¸€)
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Tokenè¿‡æœŸè®¾è®¡ï¼šå¹³è¡¡å®‰å…¨æ€§å’Œç”¨æˆ·ä½“éªŒçš„å…³é”®
ğŸ”¸ åˆ·æ–°æœºåˆ¶ï¼šé¿å…é¢‘ç¹ç™»å½•ï¼Œä¿æŒè‰¯å¥½ç”¨æˆ·ä½“éªŒ
ğŸ”¸ åŒTokenæ¨¡å¼ï¼šåˆ†ç¦»è®¿é—®æƒé™å’Œæ›´æ–°æƒé™ï¼Œé™ä½é£é™©
ğŸ”¸ å»¶è¿Ÿåˆ·æ–°ï¼šåŸºäºç”¨æˆ·æ´»è·ƒåº¦çš„æ™ºèƒ½ç»­æœŸç­–ç•¥
ğŸ”¸ å®‰å…¨é˜²æŠ¤ï¼šé˜²æ­¢Tokenæ³„éœ²å’Œæ»¥ç”¨çš„å¤šå±‚é˜²æŠ¤
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ Tokenè¿‡æœŸçš„æœ¬è´¨**
```
Tokenè¿‡æœŸ = ä¸´æ—¶é€šè¡Œè¯çš„æ—¶æ•ˆæ€§
ç›®çš„ï¼šæ§åˆ¶é£é™©æ—¶é—´çª—å£ï¼Œä¸æ˜¯ä¸ºäº†åˆéš¾ç”¨æˆ·
è®¾è®¡ï¼šåœ¨å®‰å…¨å’Œä½“éªŒé—´æ‰¾åˆ°æœ€ä½³å¹³è¡¡ç‚¹
```

**ğŸ”¹ åŒTokençš„æ ¸å¿ƒæ€æƒ³**
```
èŒè´£åˆ†ç¦»ï¼š
- Access Tokenï¼šå¹²æ´»çš„å·¥å…·ï¼ˆçŸ­æœŸï¼Œé«˜é¢‘ä½¿ç”¨ï¼‰
- Refresh Tokenï¼šæ›´æ–°çš„å‡­è¯ï¼ˆé•¿æœŸï¼Œä½é¢‘ä½¿ç”¨ï¼‰

é£é™©åˆ†æ•£ï¼š
- å³ä½¿Access Tokenè¢«ç›—ï¼Œå½±å“æ—¶é—´æœ‰é™
- Refresh Tokenä½¿ç”¨é¢‘ç‡ä½ï¼Œè¢«ç›—æ¦‚ç‡å°
```

**ğŸ”¹ åˆ·æ–°æœºåˆ¶çš„ä»·å€¼**
```
ç”¨æˆ·è§†è§’ï¼šæ— æ„ŸçŸ¥çš„ç™»å½•çŠ¶æ€ä¿æŒ
å¼€å‘è§†è§’ï¼šå®‰å…¨å’Œä½“éªŒçš„æœ€ä½³å®è·µ
ä¸šåŠ¡è§†è§’ï¼šæé«˜ç”¨æˆ·ç•™å­˜ç‡å’Œæ»¡æ„åº¦
```

### 7.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ é€‰æ‹©æŒ‡å¯¼**
```
é«˜å®‰å…¨åœºæ™¯ï¼ˆé“¶è¡Œã€æ”¯ä»˜ï¼‰ï¼š
âœ… çŸ­æœŸAccess Tokenï¼ˆ5-15åˆ†é’Ÿï¼‰
âœ… è®¾å¤‡ç»‘å®š
âœ… ä¸¥æ ¼çš„åˆ·æ–°é™åˆ¶
âŒ å»¶è¿Ÿåˆ·æ–°

ä¸€èˆ¬åº”ç”¨åœºæ™¯ï¼ˆç¤¾äº¤ã€ç”µå•†ï¼‰ï¼š
âœ… ä¸­æœŸAccess Tokenï¼ˆ30åˆ†é’Ÿ-2å°æ—¶ï¼‰
âœ… æ ‡å‡†åŒTokenæ¨¡å¼
âœ… å¯é€‰å»¶è¿Ÿåˆ·æ–°

ä½é£é™©åœºæ™¯ï¼ˆæ–°é—»ã€å¨±ä¹ï¼‰ï¼š
âœ… é•¿æœŸAccess Tokenï¼ˆæ•°å°æ—¶ï¼‰
âœ… ç®€åŒ–çš„åˆ·æ–°æœºåˆ¶
âœ… ç”¨æˆ·ä½“éªŒä¼˜å…ˆ
```

**ğŸ›¡ï¸ å®‰å…¨å®æ–½å»ºè®®**
```
å¿…é¡»å®æ–½ï¼š
- Tokenè½®æ¢ï¼ˆæ¯æ¬¡åˆ·æ–°éƒ½æ¢æ–°Tokenï¼‰
- æ—¶é—´æˆ³éªŒè¯ï¼ˆé˜²é‡æ”¾æ”»å‡»ï¼‰
- è®¾å¤‡æŒ‡çº¹è¯†åˆ«
- Tokené»‘åå•æœºåˆ¶

å»ºè®®å®æ–½ï¼š
- å¼‚åœ°ç™»å½•æ£€æµ‹
- å¹¶å‘åˆ·æ–°æ§åˆ¶
- è¯¦ç»†çš„å®¡è®¡æ—¥å¿—
- å¼‚å¸¸è¡Œä¸ºç›‘æ§

å¯é€‰å®æ–½ï¼š
- ç”Ÿç‰©è¯†åˆ«éªŒè¯
- å¤šå› å­è®¤è¯é›†æˆ
- æ™ºèƒ½é£é™©è¯„ä¼°
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- Tokenè¿‡æœŸæ˜¯ä¸ºäº†å®‰å…¨ï¼Œåˆ·æ–°æœºåˆ¶æ˜¯ä¸ºäº†ä½“éªŒ
- åŒTokenæ¨¡å¼ï¼šçŸ­æœŸå¹²æ´»ï¼Œé•¿æœŸç»­å‘½
- å®‰å…¨æªæ–½ä¸æ˜¯è¶Šå¤šè¶Šå¥½ï¼Œè€Œæ˜¯è¦æ°åˆ°å¥½å¤„
- ç”¨æˆ·æ— æ„ŸçŸ¥çš„å®‰å…¨ä½“éªŒæ‰æ˜¯æœ€å¥½çš„è®¾è®¡