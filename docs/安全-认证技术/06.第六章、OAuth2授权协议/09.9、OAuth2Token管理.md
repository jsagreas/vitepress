---
title: 9ã€OAuth2Tokenç®¡ç†
---
## ğŸ“š ç›®å½•

1. [OAuth2 Tokenæ¦‚è¿°](#1-OAuth2-Tokenæ¦‚è¿°)
2. [Access Tokenè¯¦è§£](#2-Access-Tokenè¯¦è§£)
3. [Refresh Tokenæœºåˆ¶](#3-Refresh-Tokenæœºåˆ¶)
4. [Tokençš„ç±»å‹ä¸æ ¼å¼](#4-Tokençš„ç±»å‹ä¸æ ¼å¼)
5. [Scopeå’ŒStateå‚æ•°](#5-Scopeå’ŒStateå‚æ•°)
6. [æˆæƒæœåŠ¡ä¸èµ„æºæœåŠ¡å™¨](#6-æˆæƒæœåŠ¡ä¸èµ„æºæœåŠ¡å™¨)
7. [Tokenç”Ÿå‘½å‘¨æœŸç®¡ç†](#7-Tokenç”Ÿå‘½å‘¨æœŸç®¡ç†)
8. [JWTä½œä¸ºè®¿é—®ä»¤ç‰Œ](#8-JWTä½œä¸ºè®¿é—®ä»¤ç‰Œ)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ« OAuth2 Tokenæ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯Tokenï¼Ÿ


**ğŸ”‘ é€šä¿—ç†è§£**
```
æƒ³è±¡ä½ å»é“¶è¡ŒåŠäº‹ï¼š
- ä½ å…ˆåœ¨é—¨å£å–å·æœºæ‹¿åˆ°ä¸€ä¸ªæ’é˜Ÿå·ç 
- è¿™ä¸ªå·ç å°±åƒTokenï¼Œè¯æ˜ä½ æœ‰èµ„æ ¼åŠä¸šåŠ¡
- é“¶è¡Œå·¥ä½œäººå‘˜çœ‹åˆ°è¿™ä¸ªå·ç ï¼Œå°±çŸ¥é“è¯¥ä¸ºä½ æä¾›æœåŠ¡

OAuth2ä¸­çš„Tokenä¹Ÿæ˜¯ä¸€æ ·ï¼š
- Tokenæ˜¯ä½ è®¿é—®èµ„æºçš„"å‡­è¯"
- å°±åƒé’¥åŒ™ä¸€æ ·ï¼Œæœ‰äº†å®ƒæ‰èƒ½å¼€é—¨
- ä¸åŒçš„Tokenæœ‰ä¸åŒçš„æƒé™å’Œæœ‰æ•ˆæœŸ
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦Tokenï¼Ÿ


**ğŸšª ä¼ ç»Ÿå¯†ç æ–¹å¼çš„é—®é¢˜**
```
ä¼ ç»Ÿæ–¹å¼ï¼šæ¯æ¬¡éƒ½è¦è¾“å…¥ç”¨æˆ·åå¯†ç 
é—®é¢˜ï¼š
âŒ ç¬¬ä¸‰æ–¹åº”ç”¨éœ€è¦ä¿å­˜ä½ çš„å¯†ç 
âŒ å¯†ç æ³„éœ²é£é™©å¤§
âŒ æ— æ³•é™åˆ¶ç¬¬ä¸‰æ–¹åº”ç”¨çš„æƒé™
âŒ ç”¨æˆ·æ”¹å¯†ç åï¼Œæ‰€æœ‰åº”ç”¨éƒ½å¤±æ•ˆ

Tokenæ–¹å¼çš„ä¼˜åŠ¿ï¼š
âœ… ç¬¬ä¸‰æ–¹åº”ç”¨ä¸éœ€è¦çŸ¥é“ä½ çš„å¯†ç 
âœ… å¯ä»¥è®¾ç½®ä¸åŒçš„æƒé™èŒƒå›´
âœ… å¯ä»¥éšæ—¶æ’¤é”€æŸä¸ªåº”ç”¨çš„è®¿é—®æƒ
âœ… æœ‰æ—¶é—´é™åˆ¶ï¼Œæ›´å®‰å…¨
```

### 1.3 OAuth2 Tokençš„å·¥ä½œæµç¨‹


```
ç”¨æˆ· â†’ å¾®ä¿¡ç™»å½• â†’ ç¬¬ä¸‰æ–¹åº”ç”¨ â†’ è®¿é—®ç”¨æˆ·ä¿¡æ¯

å…·ä½“æ­¥éª¤ï¼š
ç¬¬1æ­¥ï¼šç”¨æˆ·ç‚¹å‡»"å¾®ä¿¡ç™»å½•"
ç¬¬2æ­¥ï¼šè·³è½¬åˆ°å¾®ä¿¡æˆæƒé¡µé¢
ç¬¬3æ­¥ï¼šç”¨æˆ·åŒæ„æˆæƒ
ç¬¬4æ­¥ï¼šå¾®ä¿¡è¿”å›Authorization Codeï¼ˆæˆæƒç ï¼‰
ç¬¬5æ­¥ï¼šåº”ç”¨ç”¨æˆæƒç æ¢å–Access Token
ç¬¬6æ­¥ï¼šåº”ç”¨ç”¨Access Tokenè®¿é—®ç”¨æˆ·ä¿¡æ¯
```

---

## 2. ğŸ” Access Tokenè¯¦è§£


### 2.1 ä»€ä¹ˆæ˜¯Access Tokenï¼Ÿ


**ğŸ’¡ æ ¸å¿ƒæ¦‚å¿µ**
```
Access Token = è®¿é—®èµ„æºçš„é’¥åŒ™

é€šä¿—æ¯”å–»ï¼š
- å°±åƒé…’åº—æˆ¿å¡ï¼Œåˆ·å¡æ‰èƒ½è¿›æˆ¿é—´
- æˆ¿å¡ä¸Šè®°å½•äº†ä½ çš„æˆ¿é—´å·å’Œæœ‰æ•ˆæœŸ
- æ²¡æœ‰æˆ¿å¡æˆ–æˆ¿å¡è¿‡æœŸï¼Œå°±è¿›ä¸äº†æˆ¿é—´

æŠ€æœ¯å±‚é¢ï¼š
- æ˜¯ä¸€ä¸²éšæœºå­—ç¬¦ä¸²æˆ–åŠ å¯†åçš„ä¿¡æ¯
- ä»£è¡¨ç”¨æˆ·æˆæƒæŸä¸ªåº”ç”¨è®¿é—®ç‰¹å®šèµ„æº
- æœ‰æ—¶é—´é™åˆ¶ï¼Œè¿‡æœŸåéœ€è¦é‡æ–°è·å–
```

### 2.2 Access Tokençš„ç»„æˆå’Œæ ¼å¼


**ğŸ“‹ å¸¸è§æ ¼å¼ç±»å‹**

| Tokenç±»å‹ | **æ ¼å¼ç¤ºä¾‹** | **ç‰¹ç‚¹** |
|---------|------------|---------|
| **éšæœºå­—ç¬¦ä¸²** | `a1b2c3d4e5f6...` | ä¸é€æ˜ï¼Œéœ€è¦æœåŠ¡å™¨éªŒè¯ |
| **JWTæ ¼å¼** | `eyJ0eXAi...` | è‡ªåŒ…å«ï¼Œå¯ä»¥è§£ç æŸ¥çœ‹ä¿¡æ¯ |
| **Bearer Token** | `Bearer a1b2c3d4...` | HTTPæ ‡å‡†æ ¼å¼ |

**ğŸ” Access TokenåŒ…å«çš„ä¿¡æ¯**
```
Tokenä¸­é€šå¸¸åŒ…å«ï¼š
âœ… ç”¨æˆ·IDï¼ˆå“ªä¸ªç”¨æˆ·æˆæƒçš„ï¼‰
âœ… åº”ç”¨IDï¼ˆå“ªä¸ªåº”ç”¨è·å¾—äº†æˆæƒï¼‰
âœ… æƒé™èŒƒå›´ï¼ˆèƒ½è®¿é—®ä»€ä¹ˆèµ„æºï¼‰
âœ… è¿‡æœŸæ—¶é—´ï¼ˆä»€ä¹ˆæ—¶å€™å¤±æ•ˆï¼‰
âœ… ç­¾å‘æ—¶é—´ï¼ˆä»€ä¹ˆæ—¶å€™åˆ›å»ºçš„ï¼‰

æ³¨æ„ï¼šæœ‰äº›Tokenæ˜¯åŠ å¯†çš„ï¼Œå¤–éƒ¨æ— æ³•ç›´æ¥çœ‹åˆ°å†…å®¹
```

### 2.3 Bearer Tokençš„ä½¿ç”¨æ–¹æ³•


**ğŸŒ HTTP Headerä¼ è¾“æ–¹å¼**
```http
GET /api/user/profile HTTP/1.1
Host: api.example.com
Authorization: Bearer a1b2c3d4e5f6g7h8i9j0

è§£é‡Šï¼š
- Bearerï¼šè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªBearerç±»å‹çš„token
- åé¢è·Ÿç€å®é™…çš„tokenå­—ç¬¦ä¸²
- æœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚åï¼Œè§£æè¿™ä¸ªtokenéªŒè¯æƒé™
```

**ğŸ’» ä»£ç ç¤ºä¾‹**
```javascript
// å‰ç«¯å‘é€è¯·æ±‚æ—¶æºå¸¦Token
const response = await fetch('/api/user/profile', {
  headers: {
    'Authorization': `Bearer ${accessToken}`,
    'Content-Type': 'application/json'
  }
});

// åç«¯éªŒè¯Token
app.get('/api/user/profile', (req, res) => {
  const token = req.headers.authorization?.split(' ')[1];
  if (!token) {
    return res.status(401).json({ error: 'ç¼ºå°‘è®¿é—®ä»¤ç‰Œ' });
  }
  
  // éªŒè¯tokenæœ‰æ•ˆæ€§
  const user = verifyToken(token);
  if (!user) {
    return res.status(401).json({ error: 'ä»¤ç‰Œæ— æ•ˆ' });
  }
  
  res.json({ user: user });
});
```

### 2.4 ä»¤ç‰Œçš„ä¼ è¾“æ–¹å¼


**ğŸ“¡ ä¸‰ç§å¸¸è§ä¼ è¾“æ–¹å¼**

```
æ–¹å¼1ï¼šHTTP Authorization Headerï¼ˆæ¨èï¼‰
Authorization: Bearer your_token_here

æ–¹å¼2ï¼šURLæŸ¥è¯¢å‚æ•°ï¼ˆä¸å®‰å…¨ï¼Œä¸æ¨èï¼‰
GET /api/data?access_token=your_token_here

æ–¹å¼3ï¼šè¯·æ±‚ä½“ï¼ˆPOSTè¯·æ±‚ï¼‰
{
  "access_token": "your_token_here",
  "data": "some_data"
}

ä¸ºä»€ä¹ˆæ¨èHeaderæ–¹å¼ï¼š
âœ… ä¸ä¼šå‡ºç°åœ¨URLä¸­ï¼Œæ›´å®‰å…¨
âœ… ä¸ä¼šè¢«æ—¥å¿—ç³»ç»Ÿè®°å½•
âœ… ç¬¦åˆHTTPæ ‡å‡†
âœ… æ”¯æŒHTTPSåŠ å¯†ä¼ è¾“
```

---

## 3. ğŸ”„ Refresh Tokenæœºåˆ¶


### 3.1 ä»€ä¹ˆæ˜¯Refresh Tokenï¼Ÿ


**ğŸ”„ æ ¸å¿ƒæ¦‚å¿µ**
```
Refresh Token = è·å–æ–°é’¥åŒ™çš„å‡­è¯

ç”Ÿæ´»æ¯”å–»ï¼š
- Access Tokenåƒæ˜¯ä¸´æ—¶é€šè¡Œè¯ï¼Œæœ‰æ•ˆæœŸçŸ­
- Refresh Tokenåƒæ˜¯èº«ä»½è¯ï¼Œæœ‰æ•ˆæœŸé•¿
- é€šè¡Œè¯è¿‡æœŸäº†ï¼Œç”¨èº«ä»½è¯å¯ä»¥æ¢æ–°çš„é€šè¡Œè¯
- èº«ä»½è¯ä¸¢äº†æ‰éœ€è¦é‡æ–°åŠç†

æŠ€æœ¯å±‚é¢ï¼š
- ç”¨æ¥è·å–æ–°çš„Access Token
- æœ‰æ•ˆæœŸæ¯”Access Tokené•¿å¾ˆå¤š
- é€šå¸¸åªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼ˆç”¨å®Œå°±åºŸäº†ï¼‰
- å­˜å‚¨è¦æ¯”Access Tokenæ›´å®‰å…¨
```

### 3.2 ä¸ºä»€ä¹ˆéœ€è¦Refresh Tokenï¼Ÿ


**âš¡ è§£å†³çš„æ ¸å¿ƒé—®é¢˜**
```
é—®é¢˜1ï¼šå®‰å…¨æ€§ vs ç”¨æˆ·ä½“éªŒ
- Access Tokenæœ‰æ•ˆæœŸçŸ­ â†’ å®‰å…¨
- ä½†ç”¨æˆ·éœ€è¦é¢‘ç¹é‡æ–°ç™»å½• â†’ ä½“éªŒå·®

è§£å†³æ–¹æ¡ˆï¼š
âœ… Access TokençŸ­æœŸæœ‰æ•ˆï¼ˆ1-2å°æ—¶ï¼‰
âœ… Refresh Tokené•¿æœŸæœ‰æ•ˆï¼ˆå‡ å¤©åˆ°å‡ ä¸ªæœˆï¼‰
âœ… Access Tokenè¿‡æœŸæ—¶ï¼Œè‡ªåŠ¨ç”¨Refresh Tokenæ¢æ–°çš„
âœ… ç”¨æˆ·æ— æ„ŸçŸ¥ï¼Œæ—¢å®‰å…¨åˆæ–¹ä¾¿

é—®é¢˜2ï¼šé™ä½å¯†ç æ³„éœ²é£é™©
- å‡å°‘ç”¨æˆ·è¾“å…¥å¯†ç çš„æ¬¡æ•°
- å³ä½¿Access Tokenè¢«çªƒå–ï¼Œå½±å“æ—¶é—´æœ‰é™
```

### 3.3 Tokenåˆ·æ–°æµç¨‹


**ğŸ”„ åˆ·æ–°æœºåˆ¶è¯¦è§£**
```
æ­£å¸¸è®¿é—®æµç¨‹ï¼š
å®¢æˆ·ç«¯ â†’ [æºå¸¦Access Token] â†’ èµ„æºæœåŠ¡å™¨
       â† [è¿”å›ç”¨æˆ·æ•°æ®] â†

Access Tokenè¿‡æœŸæµç¨‹ï¼š
å®¢æˆ·ç«¯ â†’ [æºå¸¦è¿‡æœŸToken] â†’ èµ„æºæœåŠ¡å™¨
       â† [è¿”å›401é”™è¯¯] â†

è‡ªåŠ¨åˆ·æ–°æµç¨‹ï¼š
å®¢æˆ·ç«¯ â†’ [æºå¸¦Refresh Token] â†’ æˆæƒæœåŠ¡å™¨
       â† [è¿”å›æ–°çš„Access Token] â†

é‡æ–°è®¿é—®æµç¨‹ï¼š
å®¢æˆ·ç«¯ â†’ [æºå¸¦æ–°Access Token] â†’ èµ„æºæœåŠ¡å™¨
       â† [è¿”å›ç”¨æˆ·æ•°æ®] â†
```

**ğŸ’» åˆ·æ–°Tokenä»£ç ç¤ºä¾‹**
```javascript
// æ£€æŸ¥Tokenæ˜¯å¦è¿‡æœŸï¼Œè‡ªåŠ¨åˆ·æ–°
async function makeAuthenticatedRequest(url) {
  let token = getStoredAccessToken();
  
  // å°è¯•ç”¨å½“å‰tokenå‘é€è¯·æ±‚
  let response = await fetch(url, {
    headers: { 'Authorization': `Bearer ${token}` }
  });
  
  // å¦‚æœtokenè¿‡æœŸï¼Œå°è¯•åˆ·æ–°
  if (response.status === 401) {
    const refreshToken = getStoredRefreshToken();
    
    // ç”¨refresh tokenè·å–æ–°çš„access token
    const refreshResponse = await fetch('/oauth/token', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        grant_type: 'refresh_token',
        refresh_token: refreshToken
      })
    });
    
    if (refreshResponse.ok) {
      const newTokens = await refreshResponse.json();
      storeTokens(newTokens.access_token, newTokens.refresh_token);
      
      // ç”¨æ–°tokené‡æ–°å‘é€è¯·æ±‚
      response = await fetch(url, {
        headers: { 'Authorization': `Bearer ${newTokens.access_token}` }
      });
    }
  }
  
  return response;
}
```

### 3.4 Refresh Tokençš„å®‰å…¨å­˜å‚¨


**ğŸ”’ å­˜å‚¨å®‰å…¨ç­–ç•¥**
```
å®¢æˆ·ç«¯å­˜å‚¨å»ºè®®ï¼š
âœ… ä½¿ç”¨HttpOnly Cookieï¼ˆWebåº”ç”¨ï¼‰
âœ… ä½¿ç”¨å®‰å…¨çš„å¯†é’¥åº“ï¼ˆç§»åŠ¨åº”ç”¨ï¼‰
âœ… åŠ å¯†å­˜å‚¨
âœ… è®¾ç½®è¿‡æœŸæ—¶é—´

âŒ é¿å…çš„åšæ³•ï¼š
âŒ å­˜å‚¨åœ¨localStorageï¼ˆXSSé£é™©ï¼‰
âŒ å­˜å‚¨åœ¨æ™®é€šCookieï¼ˆCSRFé£é™©ï¼‰
âŒ æ˜æ–‡å­˜å‚¨
âŒ æ°¸ä¸è¿‡æœŸ
```

---

## 4. ğŸ¯ Tokençš„ç±»å‹ä¸æ ¼å¼


### 4.1 æŒ‰åŠŸèƒ½åˆ†ç±»


**ğŸ“‹ TokenåŠŸèƒ½ç±»å‹**

| Tokenç±»å‹ | **ä½œç”¨** | **æœ‰æ•ˆæœŸ** | **ä½¿ç”¨é¢‘ç‡** |
|---------|---------|-----------|------------|
| **Access Token** | è®¿é—®èµ„æº | çŸ­æœŸï¼ˆ1-2å°æ—¶ï¼‰ | é«˜é¢‘ä½¿ç”¨ |
| **Refresh Token** | åˆ·æ–°Access Token | é•¿æœŸï¼ˆå¤©-æœˆï¼‰ | ä½é¢‘ä½¿ç”¨ |
| **ID Token** | èº«ä»½ä¿¡æ¯ | çŸ­æœŸï¼ˆ1å°æ—¶ï¼‰ | ä¸€æ¬¡æ€§éªŒè¯ |

### 4.2 æŒ‰ç»“æ„åˆ†ç±»


**ğŸ” ç»“æ„ç±»å‹è¯¦è§£**

**ä¸é€æ˜Tokenï¼ˆOpaque Tokenï¼‰**
```
æ ¼å¼ï¼šéšæœºå­—ç¬¦ä¸²
ç¤ºä¾‹ï¼šb8a47c2f-87dc-4f5e-8b2a-1c9d7e3f4b5a

ç‰¹ç‚¹ï¼š
âœ… æ— æ³•ç›´æ¥è§£æå†…å®¹
âœ… éœ€è¦è°ƒç”¨æˆæƒæœåŠ¡å™¨éªŒè¯
âœ… å¯ä»¥éšæ—¶æ’¤é”€
âœ… æœåŠ¡å™¨ç«¯æ§åˆ¶æ›´çµæ´»

ç¼ºç‚¹ï¼š
âŒ æ¯æ¬¡éªŒè¯éƒ½éœ€è¦ç½‘ç»œè¯·æ±‚
âŒ å¢åŠ æˆæƒæœåŠ¡å™¨è´Ÿæ‹…
```

**è‡ªåŒ…å«Tokenï¼ˆJWTï¼‰**
```
æ ¼å¼ï¼šHeader.Payload.Signature
ç¤ºä¾‹ï¼šeyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiIxMjM0...

ç‰¹ç‚¹ï¼š
âœ… åŒ…å«ç”¨æˆ·å’Œæƒé™ä¿¡æ¯
âœ… æ— éœ€è°ƒç”¨æˆæƒæœåŠ¡å™¨éªŒè¯
âœ… å‡å°‘ç½‘ç»œè¯·æ±‚
âœ… æ”¯æŒç¦»çº¿éªŒè¯

ç¼ºç‚¹ï¼š
âŒ éš¾ä»¥æ’¤é”€ï¼ˆé™¤éè®¾ç½®é»‘åå•ï¼‰
âŒ Tokenè¾ƒå¤§
âŒ æ•æ„Ÿä¿¡æ¯å¯èƒ½æ³„éœ²
```

---

## 5. ğŸª Scopeå’ŒStateå‚æ•°


### 5.1 Scopeå‚æ•°è¯¦è§£


**ğŸ¯ ä»€ä¹ˆæ˜¯Scopeï¼Ÿ**
```
Scope = æƒé™èŒƒå›´ = è¿™ä¸ªåº”ç”¨èƒ½åšä»€ä¹ˆ

ç”Ÿæ´»æ¯”å–»ï¼š
- å°±åƒç»™ä¿å§†çš„æƒé™æ¸…å•
- "å¯ä»¥æ‰“æ‰«æˆ¿é—´ã€æ´—è¡£æœï¼Œä½†ä¸èƒ½ç¢°è´µé‡ç‰©å“"
- æ˜ç¡®è§„å®šåº”ç”¨èƒ½è®¿é—®å“ªäº›èµ„æº

æŠ€æœ¯å«ä¹‰ï¼š
- å®šä¹‰åº”ç”¨å¯ä»¥è®¿é—®çš„èµ„æºèŒƒå›´
- ç”¨ç©ºæ ¼åˆ†éš”çš„æƒé™åˆ—è¡¨
- ç”¨æˆ·æˆæƒæ—¶å¯ä»¥çœ‹åˆ°å…·ä½“æƒé™
```

**ğŸ“‹ å¸¸è§Scopeç¤ºä¾‹**

| å¹³å° | **Scopeå€¼** | **å«ä¹‰** |
|-----|-----------|---------|
| **å¾®ä¿¡** | `snsapi_userinfo` | è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ |
| **GitHub** | `repo user:email` | è®¿é—®ä»“åº“å’Œé‚®ç®± |
| **Google** | `openid email profile` | èº«ä»½ã€é‚®ç®±ã€èµ„æ–™ |
| **è‡ªå®šä¹‰** | `read write delete` | è¯»ã€å†™ã€åˆ é™¤æƒé™ |

**ğŸ’» Scopeä½¿ç”¨ç¤ºä¾‹**
```javascript
// æ„å»ºæˆæƒURLæ—¶æŒ‡å®šscope
const authUrl = `https://accounts.google.com/oauth/authorize?` +
  `client_id=${clientId}&` +
  `redirect_uri=${redirectUri}&` +
  `scope=openid email profile&` +  // è¿™é‡ŒæŒ‡å®šæƒé™èŒƒå›´
  `response_type=code&` +
  `state=${randomState}`;

// ç”¨æˆ·åŒæ„åï¼Œåº”ç”¨åªèƒ½è®¿é—®æŒ‡å®šèŒƒå›´çš„èµ„æº
// ä¾‹å¦‚åªèƒ½è·å–é‚®ç®±å’ŒåŸºæœ¬èµ„æ–™ï¼Œä¸èƒ½è®¿é—®äº‘ç›˜æ–‡ä»¶
```

### 5.2 Stateå‚æ•°è¯¦è§£


**ğŸ›¡ï¸ ä»€ä¹ˆæ˜¯Stateï¼Ÿ**
```
State = çŠ¶æ€å‚æ•° = é˜²æ­¢æ”»å‡»çš„éšæœºå€¼

å®‰å…¨æ¯”å–»ï¼š
- å°±åƒé“¶è¡Œè½¬è´¦çš„éªŒè¯ç 
- å‘èµ·è¯·æ±‚æ—¶ç”Ÿæˆä¸€ä¸ªéšæœºæ•°
- å›è°ƒæ—¶æ£€æŸ¥è¿™ä¸ªéšæœºæ•°æ˜¯å¦åŒ¹é…
- ä¸åŒ¹é…å°±è¯´æ˜å¯èƒ½è¢«æ”»å‡»äº†

æŠ€æœ¯ä½œç”¨ï¼š
- é˜²æ­¢CSRFï¼ˆè·¨ç«™è¯·æ±‚ä¼ªé€ ï¼‰æ”»å‡»
- ä¿æŒå®¢æˆ·ç«¯çŠ¶æ€ä¿¡æ¯
- ç¡®ä¿æˆæƒæµç¨‹çš„å®Œæ•´æ€§
```

**ğŸ”’ Stateå‚æ•°å®‰å…¨æœºåˆ¶**
```
æ”»å‡»åœºæ™¯ï¼š
1. é»‘å®¢è¯±å¯¼ç”¨æˆ·ç‚¹å‡»æ¶æ„é“¾æ¥
2. é“¾æ¥æŒ‡å‘åˆæ³•çš„OAuthæˆæƒé¡µé¢
3. ç”¨æˆ·æˆæƒåï¼Œå›è°ƒåˆ°é»‘å®¢æ§åˆ¶çš„é¡µé¢
4. é»‘å®¢è·å¾—ç”¨æˆ·çš„æˆæƒç 

é˜²æŠ¤æœºåˆ¶ï¼š
1. å‘èµ·æˆæƒæ—¶ç”Ÿæˆéšæœºstateå€¼
2. å°†stateå­˜å‚¨åœ¨sessionæˆ–æœ¬åœ°
3. æˆæƒæœåŠ¡å™¨åŸæ ·è¿”å›stateå€¼
4. å›è°ƒæ—¶éªŒè¯stateæ˜¯å¦åŒ¹é…
5. ä¸åŒ¹é…åˆ™æ‹’ç»å¤„ç†
```

**ğŸ’» Stateä½¿ç”¨ç¤ºä¾‹**
```javascript
// å‘èµ·æˆæƒè¯·æ±‚
function initiateOAuth() {
  // ç”Ÿæˆéšæœºstateå€¼
  const state = generateRandomString(32);
  
  // å­˜å‚¨stateåˆ°session
  sessionStorage.setItem('oauth_state', state);
  
  // æ„å»ºæˆæƒURL
  const authUrl = `https://oauth.provider.com/authorize?` +
    `client_id=${clientId}&` +
    `redirect_uri=${redirectUri}&` +
    `scope=read write&` +
    `state=${state}&` +           // åŒ…å«stateå‚æ•°
    `response_type=code`;
  
  // è·³è½¬åˆ°æˆæƒé¡µé¢
  window.location.href = authUrl;
}

// å¤„ç†æˆæƒå›è°ƒ
function handleCallback(code, returnedState) {
  // è·å–ä¹‹å‰å­˜å‚¨çš„state
  const storedState = sessionStorage.getItem('oauth_state');
  
  // éªŒè¯stateæ˜¯å¦åŒ¹é…
  if (storedState !== returnedState) {
    throw new Error('Stateå‚æ•°ä¸åŒ¹é…ï¼Œå¯èƒ½å­˜åœ¨å®‰å…¨é£é™©');
  }
  
  // stateéªŒè¯é€šè¿‡ï¼Œç»§ç»­å¤„ç†æˆæƒç 
  exchangeCodeForToken(code);
}

// ç”Ÿæˆéšæœºå­—ç¬¦ä¸²
function generateRandomString(length) {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  let result = '';
  for (let i = 0; i < length; i++) {
    result += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return result;
}
```

---

## 6. ğŸ—ï¸ æˆæƒæœåŠ¡ä¸èµ„æºæœåŠ¡å™¨


### 6.1 æœåŠ¡å™¨è§’è‰²åˆ’åˆ†


**ğŸ­ OAuth2ä¸­çš„è§’è‰²**
```
æƒ³è±¡ä¸€ä¸ªå°åŒºç®¡ç†ç³»ç»Ÿï¼š

é—¨å«å®¤ï¼ˆæˆæƒæœåŠ¡å™¨ï¼‰ï¼š
- è´Ÿè´£æ£€æŸ¥èº«ä»½è¯
- å‘æ”¾ä¸´æ—¶é€šè¡Œè¯
- è®°å½•è¿›å‡ºäººå‘˜

å„ä¸ªæ¥¼æ ‹ï¼ˆèµ„æºæœåŠ¡å™¨ï¼‰ï¼š
- æä¾›å…·ä½“æœåŠ¡ï¼ˆè®¿é—®æˆ¿é—´ï¼‰
- æ£€æŸ¥é€šè¡Œè¯æ˜¯å¦æœ‰æ•ˆ
- æ ¹æ®æƒé™æä¾›ä¸åŒçº§åˆ«çš„æœåŠ¡

ä¸šä¸»ï¼ˆç”¨æˆ·ï¼‰ï¼š
- æ‹¥æœ‰èº«ä»½è¯
- å†³å®šç»™è°å‘é€šè¡Œè¯

è®¿å®¢ï¼ˆå®¢æˆ·ç«¯åº”ç”¨ï¼‰ï¼š
- éœ€è¦é€šè¡Œè¯æ‰èƒ½è¿›å…¥
- åªèƒ½è®¿é—®è¢«æˆæƒçš„åŒºåŸŸ
```

### 6.2 æˆæƒæœåŠ¡å™¨èŒè´£è¯¦è§£


**ğŸ›ï¸ Authorization Serveræ ¸å¿ƒåŠŸèƒ½**
```
1. ç”¨æˆ·è®¤è¯
   - éªŒè¯ç”¨æˆ·èº«ä»½ï¼ˆç”¨æˆ·åå¯†ç ï¼‰
   - å¤šå› ç´ è®¤è¯ï¼ˆçŸ­ä¿¡éªŒè¯ç ï¼‰
   - ç¬¬ä¸‰æ–¹ç™»å½•é›†æˆ

2. æˆæƒç®¡ç†
   - å±•ç¤ºæˆæƒé¡µé¢ç»™ç”¨æˆ·
   - è®°å½•ç”¨æˆ·çš„æˆæƒå†³å®š
   - ç®¡ç†åº”ç”¨çš„æƒé™èŒƒå›´

3. Tokenå‘æ”¾
   - ç”ŸæˆAccess Token
   - ç”ŸæˆRefresh Token
   - è®¾ç½®Tokenæœ‰æ•ˆæœŸ

4. TokenéªŒè¯
   - éªŒè¯Tokenæœ‰æ•ˆæ€§
   - æä¾›Tokenä¿¡æ¯æŸ¥è¯¢æ¥å£
   - å¤„ç†Tokenåˆ·æ–°è¯·æ±‚

5. å®‰å…¨ç®¡ç†
   - é˜²æ­¢é‡æ”¾æ”»å‡»
   - è®°å½•å®‰å…¨æ—¥å¿—
   - ç®¡ç†åº”ç”¨å¯†é’¥
```

**ğŸ’» æˆæƒæœåŠ¡å™¨æ ¸å¿ƒæ¥å£**
```javascript
// 1. æˆæƒç«¯ç‚¹ - è·å–æˆæƒç 
app.get('/oauth/authorize', (req, res) => {
  const { client_id, redirect_uri, scope, state } = req.query;
  
  // éªŒè¯å®¢æˆ·ç«¯åˆæ³•æ€§
  if (!isValidClient(client_id)) {
    return res.status(400).send('éæ³•å®¢æˆ·ç«¯');
  }
  
  // æ˜¾ç¤ºæˆæƒé¡µé¢
  res.render('authorize', { client_id, scope, state });
});

// 2. Tokenç«¯ç‚¹ - äº¤æ¢Access Token
app.post('/oauth/token', (req, res) => {
  const { grant_type, code, refresh_token } = req.body;
  
  if (grant_type === 'authorization_code') {
    // ç”¨æˆæƒç æ¢Token
    const token = exchangeCodeForToken(code);
    res.json({
      access_token: token.access_token,
      refresh_token: token.refresh_token,
      expires_in: 3600
    });
  } else if (grant_type === 'refresh_token') {
    // åˆ·æ–°Token
    const newToken = refreshAccessToken(refresh_token);
    res.json({
      access_token: newToken.access_token,
      expires_in: 3600
    });
  }
});

// 3. TokenéªŒè¯ç«¯ç‚¹ - éªŒè¯Tokenæœ‰æ•ˆæ€§
app.post('/oauth/introspect', (req, res) => {
  const { token } = req.body;
  const tokenInfo = validateToken(token);
  
  res.json({
    active: tokenInfo.valid,
    user_id: tokenInfo.user_id,
    scope: tokenInfo.scope,
    exp: tokenInfo.expires_at
  });
});
```

### 6.3 èµ„æºæœåŠ¡å™¨èŒè´£è¯¦è§£


**ğŸ¢ Resource Serveræ ¸å¿ƒåŠŸèƒ½**
```
1. TokenéªŒè¯
   - æ£€æŸ¥Tokenæ ¼å¼æ˜¯å¦æ­£ç¡®
   - éªŒè¯Tokenæ˜¯å¦æœ‰æ•ˆ
   - ç¡®è®¤Tokenæƒé™èŒƒå›´

2. æƒé™æ§åˆ¶
   - æ ¹æ®Scopeé™åˆ¶è®¿é—®èŒƒå›´
   - å®æ–½åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶
   - è®°å½•è®¿é—®æ—¥å¿—

3. èµ„æºä¿æŠ¤
   - ä¿æŠ¤æ•æ„Ÿæ•°æ®ä¸è¢«æ³„éœ²
   - å®æ–½è®¿é—®é¢‘ç‡é™åˆ¶
   - å¤„ç†å¼‚å¸¸è¯·æ±‚

4. æ•°æ®æœåŠ¡
   - æä¾›APIæ¥å£
   - è¿”å›ç”¨æˆ·æ•°æ®
   - å¤„ç†ä¸šåŠ¡é€»è¾‘
```

**ğŸ’» èµ„æºæœåŠ¡å™¨å®ç°ç¤ºä¾‹**
```javascript
// TokenéªŒè¯ä¸­é—´ä»¶
function verifyToken(req, res, next) {
  const authHeader = req.headers.authorization;
  
  if (!authHeader || !authHeader.startsWith('Bearer ')) {
    return res.status(401).json({ error: 'ç¼ºå°‘è®¿é—®ä»¤ç‰Œ' });
  }
  
  const token = authHeader.split(' ')[1];
  
  // è°ƒç”¨æˆæƒæœåŠ¡å™¨éªŒè¯Token
  fetch('http://auth-server/oauth/introspect', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ token })
  })
  .then(response => response.json())
  .then(tokenInfo => {
    if (!tokenInfo.active) {
      return res.status(401).json({ error: 'ä»¤ç‰Œå·²è¿‡æœŸ' });
    }
    
    // å°†Tokenä¿¡æ¯é™„åŠ åˆ°è¯·æ±‚å¯¹è±¡
    req.user = {
      id: tokenInfo.user_id,
      scope: tokenInfo.scope
    };
    next();
  })
  .catch(error => {
    res.status(500).json({ error: 'ä»¤ç‰ŒéªŒè¯å¤±è´¥' });
  });
}

// å—ä¿æŠ¤çš„APIæ¥å£
app.get('/api/user/profile', verifyToken, (req, res) => {
  // æ£€æŸ¥æƒé™èŒƒå›´
  if (!req.user.scope.includes('profile')) {
    return res.status(403).json({ error: 'æƒé™ä¸è¶³' });
  }
  
  // è¿”å›ç”¨æˆ·ä¿¡æ¯
  const userProfile = getUserProfile(req.user.id);
  res.json(userProfile);
});

app.get('/api/user/posts', verifyToken, (req, res) => {
  // æ£€æŸ¥æƒé™èŒƒå›´
  if (!req.user.scope.includes('posts')) {
    return res.status(403).json({ error: 'æƒé™ä¸è¶³' });
  }
  
  // è¿”å›ç”¨æˆ·æ–‡ç« 
  const userPosts = getUserPosts(req.user.id);
  res.json(userPosts);
});
```

---

## 7. â±ï¸ Tokenç”Ÿå‘½å‘¨æœŸç®¡ç†


### 7.1 Tokençš„ç”Ÿå‘½å‘¨æœŸé˜¶æ®µ


**ğŸ”„ å®Œæ•´ç”Ÿå‘½å‘¨æœŸ**
```
é˜¶æ®µ1ï¼šåˆ›å»ºï¼ˆCreationï¼‰
- ç”¨æˆ·å®Œæˆæˆæƒåç”Ÿæˆ
- è®¾ç½®åˆå§‹æœ‰æ•ˆæœŸ
- ç»‘å®šç”¨æˆ·å’Œåº”ç”¨ä¿¡æ¯

é˜¶æ®µ2ï¼šæ¿€æ´»ï¼ˆActiveï¼‰
- Tokenå¤„äºå¯ç”¨çŠ¶æ€
- å¯ä»¥è®¿é—®è¢«æˆæƒçš„èµ„æº
- æ¯æ¬¡ä½¿ç”¨ä¼šè¢«éªŒè¯

é˜¶æ®µ3ï¼šå³å°†è¿‡æœŸï¼ˆNear Expiryï¼‰
- æ¥è¿‘è®¾å®šçš„è¿‡æœŸæ—¶é—´
- å®¢æˆ·ç«¯åº”å‡†å¤‡åˆ·æ–°Token
- å¯ä»¥è®¾ç½®æå‰åˆ·æ–°ç­–ç•¥

é˜¶æ®µ4ï¼šè¿‡æœŸï¼ˆExpiredï¼‰
- è¶…è¿‡æœ‰æ•ˆæœŸé™
- æ— æ³•ç»§ç»­è®¿é—®èµ„æº
- éœ€è¦ä½¿ç”¨Refresh Tokenæ›´æ–°

é˜¶æ®µ5ï¼šæ’¤é”€ï¼ˆRevokedï¼‰
- ä¸»åŠ¨æ’¤é”€Token
- ç«‹å³å¤±æ•ˆï¼Œæ— æ³•æ¢å¤
- é€šå¸¸ç”±ç”¨æˆ·æˆ–ç®¡ç†å‘˜æ“ä½œ
```

### 7.2 Tokenè¿‡æœŸæ—¶é—´ç­–ç•¥


**â° ä¸åŒTokençš„æœ‰æ•ˆæœŸå»ºè®®**

| Tokenç±»å‹ | **å»ºè®®æœ‰æ•ˆæœŸ** | **è€ƒè™‘å› ç´ ** |
|---------|-------------|------------|
| **Access Token** | 1-2å°æ—¶ | å®‰å…¨æ€§ä¼˜å…ˆï¼ŒçŸ­æœŸæœ‰æ•ˆ |
| **Refresh Token** | 7-30å¤© | ç”¨æˆ·ä½“éªŒï¼Œä¸è¦å¤ªé¢‘ç¹ç™»å½• |
| **ID Token** | 5-60åˆ†é’Ÿ | èº«ä»½éªŒè¯ï¼Œä¸€æ¬¡æ€§ä½¿ç”¨ |

**ğŸ¯ è¿‡æœŸæ—¶é—´è®¾è®¡åŸåˆ™**
```
å®‰å…¨æ€§è€ƒè™‘ï¼š
âœ… Access Tokenå°½é‡çŸ­æœŸ
âœ… æ•æ„Ÿæ“ä½œçš„Tokenæ›´çŸ­æœŸ
âœ… é«˜é£é™©ç¯å¢ƒä¸‹ç¼©çŸ­æœ‰æ•ˆæœŸ

ç”¨æˆ·ä½“éªŒè€ƒè™‘ï¼š
âœ… Refresh Tokené€‚å½“é•¿æœŸ
âœ… é¿å…é¢‘ç¹è¦æ±‚é‡æ–°ç™»å½•
âœ… æ”¯æŒ"è®°ä½æˆ‘"åŠŸèƒ½

ä¸šåŠ¡éœ€æ±‚è€ƒè™‘ï¼š
âœ… æ ¹æ®åº”ç”¨ç±»å‹è°ƒæ•´
âœ… ä¼ä¸šåº”ç”¨å¯ä»¥æ›´é•¿æœŸ
âœ… é‡‘èåº”ç”¨éœ€è¦æ›´çŸ­æœŸ
```

### 7.3 Tokenè‡ªåŠ¨åˆ·æ–°ç­–ç•¥


**ğŸ”„ åˆ·æ–°æ—¶æœºé€‰æ‹©**
```
ç­–ç•¥1ï¼šä¸»åŠ¨åˆ·æ–°ï¼ˆæ¨èï¼‰
- åœ¨Tokenè¿‡æœŸå‰ä¸»åŠ¨åˆ·æ–°
- é¿å…ç”¨æˆ·æ„ŸçŸ¥åˆ°ä¸­æ–­
- é€šå¸¸åœ¨å‰©ä½™25-50%æ—¶é—´æ—¶åˆ·æ–°

ç­–ç•¥2ï¼šè¢«åŠ¨åˆ·æ–°
- æ”¶åˆ°401é”™è¯¯åå†åˆ·æ–°
- ç”¨æˆ·å¯èƒ½æ„ŸçŸ¥åˆ°å»¶è¿Ÿ
- å®ç°ç®€å•ä½†ä½“éªŒç¨å·®

ç­–ç•¥3ï¼šåå°åˆ·æ–°
- å®šæ—¶å™¨å®šæœŸæ£€æŸ¥å’Œåˆ·æ–°
- ç”¨æˆ·æ— æ„ŸçŸ¥
- éœ€è¦æ›´å¤æ‚çš„çŠ¶æ€ç®¡ç†
```

**ğŸ’» è‡ªåŠ¨åˆ·æ–°å®ç°**
```javascript
class TokenManager {
  constructor() {
    this.accessToken = null;
    this.refreshToken = null;
    this.expiresAt = null;
    this.refreshTimer = null;
  }
  
  // è®¾ç½®Tokenä¿¡æ¯
  setTokens(accessToken, refreshToken, expiresIn) {
    this.accessToken = accessToken;
    this.refreshToken = refreshToken;
    this.expiresAt = Date.now() + expiresIn * 1000;
    
    // è®¾ç½®è‡ªåŠ¨åˆ·æ–°ï¼ˆåœ¨75%æ—¶é—´ç‚¹åˆ·æ–°ï¼‰
    const refreshTime = expiresIn * 0.75 * 1000;
    this.scheduleRefresh(refreshTime);
  }
  
  // å®‰æ’è‡ªåŠ¨åˆ·æ–°
  scheduleRefresh(delay) {
    if (this.refreshTimer) {
      clearTimeout(this.refreshTimer);
    }
    
    this.refreshTimer = setTimeout(() => {
      this.refreshTokens();
    }, delay);
  }
  
  // åˆ·æ–°Token
  async refreshTokens() {
    if (!this.refreshToken) {
      throw new Error('æ²¡æœ‰å¯ç”¨çš„Refresh Token');
    }
    
    try {
      const response = await fetch('/oauth/token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          grant_type: 'refresh_token',
          refresh_token: this.refreshToken
        })
      });
      
      if (response.ok) {
        const tokens = await response.json();
        this.setTokens(
          tokens.access_token, 
          tokens.refresh_token || this.refreshToken,
          tokens.expires_in
        );
        console.log('Tokenåˆ·æ–°æˆåŠŸ');
      } else {
        throw new Error('Tokenåˆ·æ–°å¤±è´¥');
      }
    } catch (error) {
      console.error('åˆ·æ–°Tokenæ—¶å‡ºé”™:', error);
      // åˆ·æ–°å¤±è´¥ï¼Œå¯èƒ½éœ€è¦é‡æ–°ç™»å½•
      this.clearTokens();
      this.redirectToLogin();
    }
  }
  
  // è·å–æœ‰æ•ˆçš„Access Token
  async getValidToken() {
    // æ£€æŸ¥å½“å‰Tokenæ˜¯å¦å³å°†è¿‡æœŸ
    if (this.isTokenExpiringSoon()) {
      await this.refreshTokens();
    }
    
    return this.accessToken;
  }
  
  // æ£€æŸ¥Tokenæ˜¯å¦å³å°†è¿‡æœŸ
  isTokenExpiringSoon() {
    const now = Date.now();
    const fiveMinutes = 5 * 60 * 1000;
    return (this.expiresAt - now) < fiveMinutes;
  }
  
  // æ¸…ç†Tokenä¿¡æ¯
  clearTokens() {
    this.accessToken = null;
    this.refreshToken = null;
    this.expiresAt = null;
    if (this.refreshTimer) {
      clearTimeout(this.refreshTimer);
      this.refreshTimer = null;
    }
  }
}
```

### 7.4 ä»¤ç‰Œæ’¤é”€æœºåˆ¶


**ğŸš« ä»€ä¹ˆæ—¶å€™éœ€è¦æ’¤é”€Tokenï¼Ÿ**
```
ç”¨æˆ·ä¸»åŠ¨æ“ä½œï¼š
- é€€å‡ºç™»å½•
- å–æ¶ˆåº”ç”¨æˆæƒ
- ä¿®æ”¹å¯†ç 

å®‰å…¨åŸå› ï¼š
- æ£€æµ‹åˆ°å¼‚å¸¸ä½¿ç”¨
- Tokenå¯èƒ½è¢«ç›—ç”¨
- è®¾å¤‡ä¸¢å¤±æˆ–è¢«ç›—

ç®¡ç†åŸå› ï¼š
- ç”¨æˆ·è´¦å·è¢«ç¦ç”¨
- åº”ç”¨è¢«ä¸‹æ¶
- è¿è§„æ“ä½œ
```

**ğŸ’» Tokenæ’¤é”€å®ç°**
```javascript
// å®¢æˆ·ç«¯æ’¤é”€Token
async function revokeToken(token, tokenType = 'access_token') {
  try {
    const response = await fetch('/oauth/revoke', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        token: token,
        token_type_hint: tokenType
      })
    });
    
    if (response.ok) {
      console.log('Tokenæ’¤é”€æˆåŠŸ');
      // æ¸…ç†æœ¬åœ°å­˜å‚¨çš„Token
      localStorage.removeItem('access_token');
      localStorage.removeItem('refresh_token');
    }
  } catch (error) {
    console.error('æ’¤é”€Tokenå¤±è´¥:', error);
  }
}

// æœåŠ¡ç«¯æ’¤é”€æ¥å£
app.post('/oauth/revoke', (req, res) => {
  const { token, token_type_hint } = req.body;
  
  try {
    // ä»æ•°æ®åº“ä¸­åˆ é™¤Tokenè®°å½•
    if (token_type_hint === 'refresh_token') {
      revokeRefreshToken(token);
      // åŒæ—¶æ’¤é”€å…³è”çš„Access Token
      revokeAssociatedAccessTokens(token);
    } else {
      revokeAccessToken(token);
    }
    
    res.status(200).json({ message: 'Tokenå·²æ’¤é”€' });
  } catch (error) {
    res.status(400).json({ error: 'æ’¤é”€å¤±è´¥' });
  }
});

// æ‰¹é‡æ’¤é”€ç”¨æˆ·çš„æ‰€æœ‰Token
function revokeAllUserTokens(userId) {
  // æ’¤é”€è¯¥ç”¨æˆ·çš„æ‰€æœ‰Access Token
  database.execute(
    'UPDATE tokens SET revoked = true WHERE user_id = ? AND type = "access"',
    [userId]
  );
  
  // æ’¤é”€è¯¥ç”¨æˆ·çš„æ‰€æœ‰Refresh Token
  database.execute(
    'UPDATE tokens SET revoked = true WHERE user_id = ? AND type = "refresh"',
    [userId]
  );
  
  console.log(`ç”¨æˆ· ${userId} çš„æ‰€æœ‰Tokenå·²æ’¤é”€`);
}
```

---

## 8. ğŸŸï¸ JWTä½œä¸ºè®¿é—®ä»¤ç‰Œ


### 8.1 JWTåŸºç¡€æ¦‚å¿µ


**ğŸ« ä»€ä¹ˆæ˜¯JWTï¼Ÿ**
```
JWT = JSON Web Token = è‡ªåŒ…å«çš„ä»¤ç‰Œæ ¼å¼

ç»“æ„ç»„æˆï¼š
Header.Payload.Signature

å®é™…æ ·å­ï¼š
eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.
eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.
TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ

è§£ç åçš„å†…å®¹ï¼š
Header: { "typ": "JWT", "alg": "HS256" }
Payload: { "sub": "1234567890", "name": "John Doe", "admin": true }
Signature: éªŒè¯ç­¾å
```

### 8.2 JWTä½œä¸ºAccess Tokençš„ä¼˜ç‚¹


**âœ… ä¸»è¦ä¼˜åŠ¿**
```
1. è‡ªåŒ…å«æ€§
   - Tokenæœ¬èº«åŒ…å«ç”¨æˆ·ä¿¡æ¯
   - æ— éœ€æŸ¥è¯¢æ•°æ®åº“éªŒè¯
   - å‡å°‘ç½‘ç»œè¯·æ±‚

2. æ— çŠ¶æ€æ€§
   - æœåŠ¡å™¨ä¸éœ€è¦å­˜å‚¨TokençŠ¶æ€
   - ä¾¿äºæ¨ªå‘æ‰©å±•
   - æ”¯æŒåˆ†å¸ƒå¼æ¶æ„

3. è·¨åŸŸæ”¯æŒ
   - å¯ä»¥åœ¨ä¸åŒåŸŸåé—´ä½¿ç”¨
   - æ”¯æŒå¾®æœåŠ¡æ¶æ„
   - ä¾¿äºå•ç‚¹ç™»å½•ï¼ˆSSOï¼‰

4. æ ‡å‡†åŒ–
   - éµå¾ªRFC 7519æ ‡å‡†
   - å¤šç§è¯­è¨€éƒ½æœ‰å®ç°åº“
   - äº’æ“ä½œæ€§å¥½
```

**ğŸ’» JWTç”Ÿæˆå’ŒéªŒè¯ç¤ºä¾‹**
```javascript
const jwt = require('jsonwebtoken');

// ç”ŸæˆJWT Access Token
function generateJWTToken(user, scopes) {
  const payload = {
    sub: user.id,                    // ç”¨æˆ·ID
    name: user.name,                 // ç”¨æˆ·å
    email: user.email,               // é‚®ç®±
    scope: scopes.join(' '),         // æƒé™èŒƒå›´
    iat: Math.floor(Date.now() / 1000),  // ç­¾å‘æ—¶é—´
    exp: Math.floor(Date.now() / 1000) + 3600,  // è¿‡æœŸæ—¶é—´ï¼ˆ1å°æ—¶ï¼‰
    iss: 'my-auth-server',           // ç­¾å‘è€…
    aud: 'my-app'                    // å—ä¼—
  };
  
  const secret = process.env.JWT_SECRET;
  return jwt.sign(payload, secret);
}

// éªŒè¯JWT Token
function verifyJWTToken(token) {
  try {
    const secret = process.env.JWT_SECRET;
    const decoded = jwt.verify(token, secret);
    
    return {
      valid: true,
      user: {
        id: decoded.sub,
        name: decoded.name,
        email: decoded.email,
        scope: decoded.scope.split(' ')
      }
    };
  } catch (error) {
    return {
      valid: false,
      error: error.message
    };
  }
}

// åœ¨APIä¸­ä½¿ç”¨JWTéªŒè¯
app.get('/api/protected', (req, res) => {
  const token = req.headers.authorization?.split(' ')[1];
  
  if (!token) {
    return res.status(401).json({ error: 'ç¼ºå°‘ä»¤ç‰Œ' });
  }
  
  const verification = verifyJWTToken(token);
  
  if (!verification.valid) {
    return res.status(401).json({ error: 'æ— æ•ˆä»¤ç‰Œ' });
  }
  
  // Tokenæœ‰æ•ˆï¼Œå¤„ç†ä¸šåŠ¡é€»è¾‘
  res.json({
    message: 'è®¿é—®æˆåŠŸ',
    user: verification.user
  });
});
```

### 8.3 JWTä½œä¸ºAccess Tokençš„ç¼ºç‚¹


**âŒ ä¸»è¦ç¼ºé™·**
```
1. æ— æ³•æ’¤é”€
   - ä¸€æ—¦ç­¾å‘ï¼Œåœ¨è¿‡æœŸå‰ä¸€ç›´æœ‰æ•ˆ
   - å³ä½¿ç”¨æˆ·æ³¨é”€ä¹Ÿæ— æ³•ç«‹å³å¤±æ•ˆ
   - éœ€è¦ç»´æŠ¤é»‘åå•æœºåˆ¶

2. Tokenè¾ƒå¤§
   - åŒ…å«ç”¨æˆ·ä¿¡æ¯ï¼Œä½“ç§¯æ¯”éšæœºå­—ç¬¦ä¸²å¤§
   - æ¯æ¬¡è¯·æ±‚éƒ½è¦ä¼ è¾“å®Œæ•´Token
   - å¢åŠ ç½‘ç»œä¼ è¾“å¼€é”€

3. å®‰å…¨é£é™©
   - Payloadæ˜¯Base64ç¼–ç ï¼Œä¸æ˜¯åŠ å¯†
   - æ•æ„Ÿä¿¡æ¯å¯èƒ½è¢«è§£ç æŸ¥çœ‹
   - éœ€è¦HTTPSä¿æŠ¤ä¼ è¾“

4. æ›´æ–°å›°éš¾
   - ç”¨æˆ·ä¿¡æ¯å˜æ›´åï¼Œå·²å‘æ”¾çš„Tokenä¸ä¼šæ›´æ–°
   - éœ€è¦ç­‰Tokenè¿‡æœŸåæ‰èƒ½è·å–æ–°ä¿¡æ¯
   - æˆ–è€…ç¼©çŸ­Tokenæœ‰æ•ˆæœŸ
```

### 8.4 JWTä½¿ç”¨æœ€ä½³å®è·µ


**ğŸ›¡ï¸ å®‰å…¨ä½¿ç”¨å»ºè®®**
```
Payloadè®¾è®¡ï¼š
âœ… ä¸è¦æ”¾æ•æ„Ÿä¿¡æ¯ï¼ˆå¯†ç ã€èº«ä»½è¯å·ï¼‰
âœ… åªæ”¾å¿…è¦çš„èº«ä»½æ ‡è¯†ä¿¡æ¯
âœ… ä½¿ç”¨æ ‡å‡†å­—æ®µåï¼ˆsubã€iatã€expç­‰ï¼‰

æœ‰æ•ˆæœŸè®¾ç½®ï¼š
âœ… è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´ï¼ˆé€šå¸¸1-2å°æ—¶ï¼‰
âœ… æ•æ„Ÿåº”ç”¨ä½¿ç”¨æ›´çŸ­æœ‰æ•ˆæœŸ
âœ… é…åˆRefresh Tokenä½¿ç”¨

æ’¤é”€æœºåˆ¶ï¼š
âœ… ç»´æŠ¤Tokené»‘åå•
âœ… é‡è¦æ“ä½œå‰æ£€æŸ¥é»‘åå•
âœ… æä¾›Tokenæ’¤é”€æ¥å£

ä¼ è¾“å®‰å…¨ï¼š
âœ… å¿…é¡»ä½¿ç”¨HTTPSä¼ è¾“
âœ… ä¸è¦åœ¨URLä¸­ä¼ è¾“JWT
âœ… ä½¿ç”¨Authorization Header
```

**ğŸ’» JWTé»‘åå•å®ç°**
```javascript
// JWTé»‘åå•ç®¡ç†
class JWTBlacklist {
  constructor() {
    this.blacklist = new Set();
    this.redis = require('redis').createClient();
  }
  
  // å°†TokenåŠ å…¥é»‘åå•
  async addToBlacklist(token) {
    const decoded = jwt.decode(token);
    if (decoded && decoded.exp) {
      // è®¡ç®—Tokenå‰©ä½™æœ‰æ•ˆæœŸ
      const remainingTime = decoded.exp - Math.floor(Date.now() / 1000);
      
      if (remainingTime > 0) {
        // åœ¨Redisä¸­å­˜å‚¨ï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´
        await this.redis.setex(`blacklist:${token}`, remainingTime, '1');
        this.blacklist.add(token);
      }
    }
  }
  
  // æ£€æŸ¥Tokenæ˜¯å¦åœ¨é»‘åå•ä¸­
  async isBlacklisted(token) {
    if (this.blacklist.has(token)) {
      return true;
    }
    
    // æ£€æŸ¥Redis
    const exists = await this.redis.exists(`blacklist:${token}`);
    return exists === 1;
  }
}

// å¢å¼ºç‰ˆJWTéªŒè¯ä¸­é—´ä»¶
const blacklist = new JWTBlacklist();

async function verifyJWTWithBlacklist(req, res, next) {
  const token = req.headers.authorization?.split(' ')[1];
  
  if (!token) {
    return res.status(401).json({ error: 'ç¼ºå°‘ä»¤ç‰Œ' });
  }
  
  // æ£€æŸ¥é»‘åå•
  if (await blacklist.isBlacklisted(token)) {
    return res.status(401).json({ error: 'ä»¤ç‰Œå·²è¢«æ’¤é”€' });
  }
  
  // éªŒè¯JWT
  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    req.user = decoded;
    next();
  } catch (error) {
    return res.status(401).json({ error: 'æ— æ•ˆä»¤ç‰Œ' });
  }
}

// Tokenæ’¤é”€æ¥å£
app.post('/oauth/revoke-jwt', async (req, res) => {
  const { token } = req.body;
  
  try {
    await blacklist.addToBlacklist(token);
    res.json({ message: 'Tokenå·²æ’¤é”€' });
  } catch (error) {
    res.status(500).json({ error: 'æ’¤é”€å¤±è´¥' });
  }
});
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ« TokenåŸºç¡€æ¦‚å¿µï¼š
- Access Tokenï¼šè®¿é—®èµ„æºçš„é’¥åŒ™ï¼Œæœ‰æ•ˆæœŸçŸ­
- Refresh Tokenï¼šè·å–æ–°é’¥åŒ™çš„å‡­è¯ï¼Œæœ‰æ•ˆæœŸé•¿
- Bearer Tokenï¼šHTTPæ ‡å‡†çš„Tokenä¼ è¾“æ ¼å¼

ğŸ”„ Tokenå·¥ä½œæœºåˆ¶ï¼š
- æˆæƒç æ¢å–Access Token
- Access Tokenè®¿é—®èµ„æº
- Tokenè¿‡æœŸåç”¨Refresh Tokenåˆ·æ–°
- æ”¯æŒä¸»åŠ¨æ’¤é”€æœºåˆ¶

ğŸ¯ æƒé™æ§åˆ¶å‚æ•°ï¼š
- Scopeï¼šå®šä¹‰è®¿é—®æƒé™èŒƒå›´
- Stateï¼šé˜²æ­¢CSRFæ”»å‡»çš„éšæœºå‚æ•°

ğŸ—ï¸ æœåŠ¡å™¨è§’è‰²ï¼š
- æˆæƒæœåŠ¡å™¨ï¼šç®¡ç†ç”¨æˆ·è®¤è¯å’ŒTokenå‘æ”¾
- èµ„æºæœåŠ¡å™¨ï¼šä¿æŠ¤èµ„æºï¼ŒéªŒè¯Tokenæƒé™
```

### 9.2 Tokenç®¡ç†å…³é”®è¦ç‚¹


**ğŸ”‘ Access Tokenç®¡ç†**
```
âœ… æœ‰æ•ˆæœŸå»ºè®®ï¼š1-2å°æ—¶
âœ… ä¼ è¾“æ–¹å¼ï¼šHTTP Authorization Header
âœ… æ ¼å¼ï¼šBearer + Tokenå­—ç¬¦ä¸²
âœ… éªŒè¯ï¼šæ¯æ¬¡è¯·æ±‚éƒ½è¦éªŒè¯æœ‰æ•ˆæ€§
```

**ğŸ”„ Refresh Tokenç®¡ç†**
```
âœ… æœ‰æ•ˆæœŸå»ºè®®ï¼š7-30å¤©
âœ… å­˜å‚¨ï¼šå®‰å…¨å­˜å‚¨ï¼Œé¿å…æ³„éœ²
âœ… ä½¿ç”¨ï¼šä»…ç”¨äºåˆ·æ–°Access Token
âœ… æ’¤é”€ï¼šæ”¯æŒä¸»åŠ¨æ’¤é”€æœºåˆ¶
```

**ğŸ›¡ï¸ å®‰å…¨æœ€ä½³å®è·µ**
```
âœ… ä½¿ç”¨HTTPSä¼ è¾“
âœ… è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´
âœ… å®æ–½Tokenæ’¤é”€æœºåˆ¶
âœ… éªŒè¯Stateå‚æ•°é˜²æ­¢CSRF
âœ… é™åˆ¶Scopeæƒé™èŒƒå›´
```

### 9.3 JWTä½œä¸ºTokençš„æƒè¡¡


| ç‰¹æ€§ | **JWTä¼˜åŠ¿** | **JWTåŠ£åŠ¿** |
|------|-----------|-----------|
| **éªŒè¯æ•ˆç‡** | æ— éœ€æŸ¥åº“ï¼Œç¦»çº¿éªŒè¯ | Tokenä½“ç§¯å¤§ï¼Œä¼ è¾“å¼€é”€ |
| **æ‰©å±•æ€§** | æ— çŠ¶æ€ï¼Œæ˜“æ‰©å±• | éš¾ä»¥æ’¤é”€ï¼Œéœ€è¦é»‘åå• |
| **ä¿¡æ¯æºå¸¦** | è‡ªåŒ…å«ç”¨æˆ·ä¿¡æ¯ | æ•æ„Ÿä¿¡æ¯å¯èƒ½æ³„éœ² |
| **æ ‡å‡†åŒ–** | éµå¾ªRFCæ ‡å‡† | å®ç°å¤æ‚åº¦è¾ƒé«˜ |

### 9.4 å®é™…åº”ç”¨å»ºè®®


**ğŸ¯ Tokenç±»å‹é€‰æ‹©**
```
å°å‹åº”ç”¨ï¼š
âœ… ä½¿ç”¨ä¸é€æ˜Tokenï¼Œç®€å•å¯é 
âœ… é›†ä¸­å¼æ¶æ„ï¼ŒçŠ¶æ€æ˜“ç®¡ç†

å¤§å‹åº”ç”¨/å¾®æœåŠ¡ï¼š
âœ… ä½¿ç”¨JWT Tokenï¼Œæ— çŠ¶æ€æ‰©å±•
âœ… é…åˆé»‘åå•æœºåˆ¶ä¿è¯å®‰å…¨
```

**â° æœ‰æ•ˆæœŸç­–ç•¥**
```
é«˜å®‰å…¨åº”ç”¨ï¼š
- Access Token: 15-30åˆ†é’Ÿ
- Refresh Token: 1-7å¤©

ä¸€èˆ¬åº”ç”¨ï¼š
- Access Token: 1-2å°æ—¶  
- Refresh Token: 7-30å¤©

å†…éƒ¨åº”ç”¨ï¼š
- Access Token: 2-8å°æ—¶
- Refresh Token: 30-90å¤©
```

**ğŸ”„ åˆ·æ–°ç­–ç•¥**
```
æ¨èæ–¹å¼ï¼š
âœ… ä¸»åŠ¨åˆ·æ–°ï¼šå‰©ä½™25-50%æ—¶é—´æ—¶åˆ·æ–°
âœ… é™é»˜åˆ·æ–°ï¼šç”¨æˆ·æ— æ„ŸçŸ¥
âœ… é”™è¯¯é‡è¯•ï¼šå¤±è´¥æ—¶æœ‰é‡è¯•æœºåˆ¶
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- Tokenæ˜¯OAuth2çš„æ ¸å¿ƒï¼Œç†è§£Access Tokenå’ŒRefresh Tokençš„åŒºåˆ«å¾ˆå…³é”®
- Scopeå®šä¹‰æƒé™èŒƒå›´ï¼ŒStateé˜²æ­¢å®‰å…¨æ”»å‡»ï¼Œä¸¤ä¸ªå‚æ•°éƒ½å¾ˆé‡è¦
- æˆæƒæœåŠ¡å™¨ç®¡Tokenï¼Œèµ„æºæœåŠ¡å™¨ç”¨Tokenï¼ŒèŒè´£è¦åˆ†æ¸…
- JWTæœ‰ä¼˜ç¼ºç‚¹ï¼Œé€‰æ‹©æ—¶è¦æ ¹æ®å®é™…éœ€æ±‚æƒè¡¡
- å®‰å…¨æ°¸è¿œæ˜¯ç¬¬ä¸€ä½ï¼ŒHTTPSã€åˆç†æœ‰æ•ˆæœŸã€æ’¤é”€æœºåˆ¶ç¼ºä¸€ä¸å¯