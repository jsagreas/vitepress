---
title: 12ã€OAuth2å®‰å…¨ä¸åº”ç”¨
---
## ğŸ“š ç›®å½•

1. [OAuth2æ ¸å¿ƒæ¦‚å¿µå›é¡¾](#1-OAuth2æ ¸å¿ƒæ¦‚å¿µå›é¡¾)
2. [OAuth2å®‰å…¨æœºåˆ¶è¯¦è§£](#2-OAuth2å®‰å…¨æœºåˆ¶è¯¦è§£)
3. [ç¬¬ä¸‰æ–¹ç™»å½•å®ç°åŸç†](#3-ç¬¬ä¸‰æ–¹ç™»å½•å®ç°åŸç†)
4. [OAuth2 vs OpenID Connect](#4-OAuth2-vs-OpenID-Connect)
5. [å®æˆ˜åº”ç”¨åœºæ™¯](#5-å®æˆ˜åº”ç”¨åœºæ™¯)
6. [å¸¸è§å®‰å…¨æ¼æ´ä¸é˜²æŠ¤](#6-å¸¸è§å®‰å…¨æ¼æ´ä¸é˜²æŠ¤)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” OAuth2æ ¸å¿ƒæ¦‚å¿µå›é¡¾


### 1.1 ä»€ä¹ˆæ˜¯OAuth2


> **ç®€å•ç†è§£**ï¼šOAuth2å°±åƒæ˜¯ä¸€ä¸ª"æ•°å­—é’¥åŒ™ç®¡ç†ç³»ç»Ÿ"ï¼Œè®©ä½ å¯ä»¥å®‰å…¨åœ°ç»™åˆ«äººä¸€æŠŠ"ä¸´æ—¶é’¥åŒ™"æ¥è®¿é—®ä½ çš„èµ„æºï¼Œè€Œä¸éœ€è¦æŠŠä½ çš„"ä¸»é’¥åŒ™"ï¼ˆå¯†ç ï¼‰å‘Šè¯‰ä»–ä»¬ã€‚

**ğŸ”‘ ç”Ÿæ´»ä¸­çš„ç±»æ¯”**ï¼š
```
ä¼ ç»Ÿæ–¹å¼ = æŠŠå®¶é—¨é’¥åŒ™ç»™æœ‹å‹
OAuth2 = ç»™æœ‹å‹ä¸€å¼ ä¸´æ—¶é—¨å¡

å®¶é—¨é’¥åŒ™çš„é—®é¢˜ï¼š
- æœ‹å‹å¯ä»¥éšæ—¶è¿›å…¥ä½ å®¶
- æ— æ³•æ§åˆ¶æœ‹å‹çš„è®¿é—®èŒƒå›´
- æ— æ³•éšæ—¶æ”¶å›æƒé™
- å¦‚æœé’¥åŒ™ä¸¢äº†å¾ˆå±é™©

ä¸´æ—¶é—¨å¡çš„ä¼˜åŠ¿ï¼š
- å¯ä»¥è®¾ç½®æœ‰æ•ˆæœŸï¼ˆæ¯”å¦‚åªèƒ½ç”¨3å¤©ï¼‰
- å¯ä»¥é™åˆ¶è®¿é—®èŒƒå›´ï¼ˆåªèƒ½è¿›å®¢å…ï¼Œä¸èƒ½è¿›å§å®¤ï¼‰
- å¯ä»¥éšæ—¶è¿œç¨‹æ’¤é”€é—¨å¡
- é—¨å¡ä¸¢äº†å½±å“æœ‰é™
```

### 1.2 OAuth2è§£å†³çš„æ ¸å¿ƒé—®é¢˜


**âŒ ä¼ ç»Ÿå¯†ç å…±äº«çš„é—®é¢˜**ï¼š
- ç”¨æˆ·éœ€è¦æŠŠå¯†ç å‘Šè¯‰ç¬¬ä¸‰æ–¹åº”ç”¨
- ç¬¬ä¸‰æ–¹åº”ç”¨è·å¾—ç”¨æˆ·è´¦å·çš„å®Œå…¨æ§åˆ¶æƒ
- ç”¨æˆ·æ— æ³•æ’¤é”€å¯¹ç‰¹å®šåº”ç”¨çš„æˆæƒ
- å¯†ç æ³„éœ²å½±å“é¢å¾ˆå¤§

**âœ… OAuth2çš„è§£å†³æ–¹æ¡ˆ**ï¼š
- ç”¨æˆ·ä¸éœ€è¦å‘ç¬¬ä¸‰æ–¹é€éœ²å¯†ç 
- ç¬¬ä¸‰æ–¹åªèƒ½è·å¾—æœ‰é™çš„è®¿é—®æƒé™
- ç”¨æˆ·å¯ä»¥éšæ—¶æ’¤é”€æˆæƒ
- è®¿é—®ä»¤ç‰Œæœ‰æ—¶æ•ˆæ€§ï¼Œé™ä½å®‰å…¨é£é™©

```
ä¼ ç»Ÿæ–¹å¼æµç¨‹ï¼š
ç”¨æˆ· â†’ å‘Šè¯‰å¯†ç  â†’ ç¬¬ä¸‰æ–¹åº”ç”¨ â†’ ç”¨å¯†ç è®¿é—® â†’ èµ„æºæœåŠ¡å™¨

OAuth2æµç¨‹ï¼š
ç”¨æˆ· â†’ æˆæƒç¡®è®¤ â†’ æˆæƒæœåŠ¡å™¨ â†’ å‘æ”¾ä»¤ç‰Œ â†’ ç¬¬ä¸‰æ–¹åº”ç”¨ â†’ ç”¨ä»¤ç‰Œè®¿é—® â†’ èµ„æºæœåŠ¡å™¨
```

### 1.3 OAuth2å››ä¸ªæ ¸å¿ƒè§’è‰²


```
OAuth2è§’è‰²å…³ç³»å›¾ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â‘ è¯·æ±‚æˆæƒ     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”‚ ç¬¬ä¸‰æ–¹åº”ç”¨   â”‚
â”‚(Resource     â”‚                 â”‚(Client)     â”‚
â”‚ Owner)       â”‚ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â‘£è¿”å›èµ„æº      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                               â”‚
      â”‚â‘¡æˆæƒç¡®è®¤                      â”‚â‘¢ç”¨ä»¤ç‰Œè¯·æ±‚èµ„æº
      â†“                               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æˆæƒæœåŠ¡å™¨   â”‚                 â”‚ èµ„æºæœåŠ¡å™¨   â”‚
â”‚(Authorizationâ”‚                â”‚(Resource    â”‚
â”‚ Server)      â”‚                 â”‚ Server)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

| **è§’è‰²** | **é€šä¿—è§£é‡Š** | **ç°å®ä¾‹å­** |
|---------|-------------|-------------|
| **ç”¨æˆ·(Resource Owner)** | `èµ„æºçš„çœŸæ­£ä¸»äºº` | `ä½ çš„å¾®ä¿¡è´¦å·ã€ä½ çš„GitHubä»“åº“` |
| **ç¬¬ä¸‰æ–¹åº”ç”¨(Client)** | `æƒ³è¦è®¿é—®èµ„æºçš„åº”ç”¨` | `æŸä¸ªç½‘ç«™æƒ³ç”¨ä½ çš„å¾®ä¿¡å¤´åƒ` |
| **æˆæƒæœåŠ¡å™¨(Authorization Server)** | `è´Ÿè´£éªŒè¯ç”¨æˆ·èº«ä»½å’Œå‘æ”¾ä»¤ç‰Œ` | `å¾®ä¿¡çš„æˆæƒé¡µé¢` |
| **èµ„æºæœåŠ¡å™¨(Resource Server)** | `å­˜å‚¨ç”¨æˆ·èµ„æºçš„æœåŠ¡å™¨` | `å­˜å‚¨å¾®ä¿¡ç”¨æˆ·ä¿¡æ¯çš„æœåŠ¡å™¨` |

---

## 2. ğŸ›¡ï¸ OAuth2å®‰å…¨æœºåˆ¶è¯¦è§£


### 2.1 ä¸ºä»€ä¹ˆå¿…é¡»ä½¿ç”¨HTTPS


**ğŸ”’ HTTPSçš„å¿…è¦æ€§**

> **æ ¸å¿ƒåŸå› **ï¼šOAuth2æ¶‰åŠæ•æ„Ÿä¿¡æ¯ä¼ è¾“ï¼ŒåŒ…æ‹¬æˆæƒç ã€è®¿é—®ä»¤ç‰Œç­‰ï¼Œå¦‚æœè¢«æˆªè·ä¼šé€ æˆä¸¥é‡å®‰å…¨é—®é¢˜ã€‚

```
HTTPä¼ è¾“çš„å±é™©ï¼š

ç”¨æˆ·æµè§ˆå™¨ â”€â”€â”€â”€ ç½‘ç»œä¼ è¾“ â”€â”€â”€â”€ æˆæƒæœåŠ¡å™¨
             â†‘ å¯è¢«çªƒå¬ â†‘
         æˆæƒç : abc123
         ä»¤ç‰Œ: xyz789
         
æ”»å‡»è€…å¯ä»¥ï¼š
â€¢ æˆªè·æˆæƒç ï¼Œä¼ªé€ ç”¨æˆ·èº«ä»½
â€¢ å·å–è®¿é—®ä»¤ç‰Œï¼Œå†’å……ç¬¬ä¸‰æ–¹åº”ç”¨
â€¢ ä¿®æ”¹é‡å®šå‘åœ°å€ï¼ŒåŠ«æŒæˆæƒæµç¨‹
```

**âœ… HTTPSä¿æŠ¤æœºåˆ¶**ï¼š
- **åŠ å¯†ä¼ è¾“**ï¼šæ‰€æœ‰æ•°æ®éƒ½ç»è¿‡TLSåŠ å¯†
- **èº«ä»½éªŒè¯**ï¼šç¡®è®¤æœåŠ¡å™¨èº«ä»½çœŸå®æ€§
- **æ•°æ®å®Œæ•´æ€§**ï¼šé˜²æ­¢ä¼ è¾“è¿‡ç¨‹ä¸­æ•°æ®è¢«ç¯¡æ”¹

### 2.2 Stateå‚æ•°é˜²CSRFæ”»å‡»


**âš ï¸ CSRFæ”»å‡»åŸç†**

> **ä»€ä¹ˆæ˜¯CSRF**ï¼šè·¨ç«™è¯·æ±‚ä¼ªé€ ï¼Œæ”»å‡»è€…è¯±å¯¼ç”¨æˆ·åœ¨ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹æ‰§è¡ŒæŸä¸ªæ“ä½œã€‚

```
CSRFæ”»å‡»æµç¨‹ï¼š

æ­¥éª¤1ï¼šç”¨æˆ·æ­£å¸¸è®¿é—®é“¶è¡Œç½‘ç«™ï¼Œå·²ç»ç™»å½•
æ­¥éª¤2ï¼šç”¨æˆ·åŒæ—¶è®¿é—®æ¶æ„ç½‘ç«™
æ­¥éª¤3ï¼šæ¶æ„ç½‘ç«™å·å·å‘é“¶è¡Œç½‘ç«™å‘é€è½¬è´¦è¯·æ±‚
æ­¥éª¤4ï¼šç”±äºç”¨æˆ·å·²ç™»å½•ï¼Œé“¶è¡Œè¯¯ä»¥ä¸ºæ˜¯ç”¨æˆ·çš„æ­£å¸¸æ“ä½œ

åœ¨OAuth2ä¸­çš„CSRFï¼š
æ­¥éª¤1ï¼šç”¨æˆ·è®¿é—®ç¬¬ä¸‰æ–¹ç½‘ç«™A
æ­¥éª¤2ï¼šæ”»å‡»è€…è¯±å¯¼ç”¨æˆ·ç‚¹å‡»é“¾æ¥
æ­¥éª¤3ï¼šé“¾æ¥å®é™…æ˜¯ç½‘ç«™Bçš„OAuthæˆæƒåœ°å€
æ­¥éª¤4ï¼šç”¨æˆ·åœ¨ä¸çŸ¥æƒ…ä¸‹ç»™ç½‘ç«™Bæˆæƒäº†è‡ªå·±çš„è´¦å·
```

**ğŸ›¡ï¸ Stateå‚æ•°é˜²æŠ¤æœºåˆ¶**

```javascript
// ç¬¬ä¸‰æ–¹åº”ç”¨ç”Ÿæˆéšæœºstate
const state = generateRandomString(); // ä¾‹å¦‚: "abc123xyz"

// ä¿å­˜stateï¼ˆå¯ä»¥å­˜åœ¨sessionæˆ–cookieä¸­ï¼‰
session.oauthState = state;

// æ„é€ æˆæƒé“¾æ¥æ—¶å¸¦ä¸Šstate
const authUrl = `https://oauth.example.com/authorize?
  client_id=your_client_id&
  redirect_uri=your_callback&
  state=${state}&
  response_type=code`;

// ç”¨æˆ·æˆæƒåï¼ŒæˆæƒæœåŠ¡å™¨ä¼šåŸæ ·è¿”å›state
// åœ¨å›è°ƒå¤„ç†ä¸­éªŒè¯state
app.get('/callback', (req, res) => {
  const receivedState = req.query.state;
  const savedState = req.session.oauthState;
  
  if (receivedState !== savedState) {
    return res.status(400).send('Stateå‚æ•°ä¸åŒ¹é…ï¼Œå¯èƒ½å—åˆ°CSRFæ”»å‡»');
  }
  
  // stateéªŒè¯é€šè¿‡ï¼Œç»§ç»­å¤„ç†æˆæƒç 
});
```

> **Stateå·¥ä½œåŸç†**ï¼šå°±åƒé“¶è¡Œè½¬è´¦æ—¶çš„"éªŒè¯ç "ï¼Œåªæœ‰å‘èµ·è¯·æ±‚çš„äººæ‰çŸ¥é“è¿™ä¸ªéšæœºç ï¼Œç¡®ä¿æˆæƒå›è°ƒç¡®å®æ¥è‡ªä¹‹å‰çš„æˆæƒè¯·æ±‚ã€‚

### 2.3 Redirect URIç™½åå•æœºåˆ¶


**ğŸ¯ ä¸ºä»€ä¹ˆéœ€è¦ç™½åå•éªŒè¯**

```
æ²¡æœ‰ç™½åå•éªŒè¯çš„é£é™©ï¼š

æ­£å¸¸æµç¨‹ï¼š
ç”¨æˆ·æˆæƒ â†’ å›è°ƒåˆ° https://app.com/callback

æ”»å‡»åœºæ™¯ï¼š
æ”»å‡»è€…ä¿®æ”¹å›è°ƒåœ°å€ â†’ å›è°ƒåˆ° https://evil.com/steal
                  â†“
              æˆæƒç è¢«æ”»å‡»è€…è·å–
```

**âœ… ç™½åå•éªŒè¯æœºåˆ¶**

```javascript
// åœ¨OAuthåº”ç”¨æ³¨å†Œæ—¶é¢„å…ˆé…ç½®å…è®¸çš„å›è°ƒåœ°å€
const allowedRedirectUris = [
  'https://myapp.com/oauth/callback',
  'https://myapp.com/auth/success',
  'https://dev.myapp.com/callback'  // å¼€å‘ç¯å¢ƒ
];

// æˆæƒæœåŠ¡å™¨éªŒè¯å›è°ƒåœ°å€
function validateRedirectUri(requestedUri) {
  // ç²¾ç¡®åŒ¹é…ï¼ˆæ¨èï¼‰
  return allowedRedirectUris.includes(requestedUri);
  
  // æˆ–è€…å‰ç¼€åŒ¹é…ï¼ˆéœ€è°¨æ…ï¼‰
  // return allowedRedirectUris.some(allowed => 
  //   requestedUri.startsWith(allowed)
  // );
}
```

> **å®‰å…¨è¦ç‚¹**ï¼šå›è°ƒåœ°å€å¿…é¡»ä½¿ç”¨HTTPSï¼Œå¹¶ä¸”è¦ç²¾ç¡®åŒ¹é…ï¼Œä¸å»ºè®®ä½¿ç”¨é€šé…ç¬¦æˆ–å‰ç¼€åŒ¹é…ã€‚

### 2.4 æˆæƒç å®‰å…¨æªæ–½


**â° çŸ­æœ‰æ•ˆæœŸè®¾è®¡**

```
æˆæƒç ç‰¹ç‚¹ï¼š
â€¢ æœ‰æ•ˆæœŸå¾ˆçŸ­ï¼ˆé€šå¸¸1-10åˆ†é’Ÿï¼‰
â€¢ ä¸€æ¬¡æ€§ä½¿ç”¨ï¼ˆç”¨è¿‡å³ä½œåºŸï¼‰
â€¢ åªèƒ½æ¢å–è®¿é—®ä»¤ç‰Œï¼Œä¸èƒ½ç›´æ¥è®¿é—®èµ„æº

ä¸ºä»€ä¹ˆè¦çŸ­æœ‰æ•ˆæœŸï¼Ÿ
å‡è®¾æˆæƒç è¢«æˆªè·ï¼š
- æ”»å‡»è€…å¿…é¡»åœ¨å¾ˆçŸ­æ—¶é—´å†…ä½¿ç”¨
- ä¸€æ—¦è¢«æ­£å¸¸åº”ç”¨ä½¿ç”¨ï¼Œæˆæƒç ç«‹å³å¤±æ•ˆ
- å¤§å¤§é™ä½äº†æ”»å‡»æˆåŠŸçš„å¯èƒ½æ€§
```

**ğŸ”„ ä¸€æ¬¡æ€§ä½¿ç”¨åŸåˆ™**

```javascript
// æˆæƒç ä½¿ç”¨é€»è¾‘
const authCodes = new Map(); // å­˜å‚¨æˆæƒç 

// ç”Ÿæˆæˆæƒç 
function generateAuthCode(userId, clientId) {
  const code = generateRandomString();
  authCodes.set(code, {
    userId,
    clientId,
    used: false,
    expiresAt: Date.now() + 600000 // 10åˆ†é’Ÿåè¿‡æœŸ
  });
  return code;
}

// éªŒè¯å¹¶ä½¿ç”¨æˆæƒç 
function exchangeAuthCode(code, clientId) {
  const codeInfo = authCodes.get(code);
  
  if (!codeInfo) {
    throw new Error('æˆæƒç ä¸å­˜åœ¨');
  }
  
  if (codeInfo.used) {
    throw new Error('æˆæƒç å·²ä½¿ç”¨'); // é˜²æ­¢é‡å¤ä½¿ç”¨
  }
  
  if (Date.now() > codeInfo.expiresAt) {
    throw new Error('æˆæƒç å·²è¿‡æœŸ');
  }
  
  if (codeInfo.clientId !== clientId) {
    throw new Error('å®¢æˆ·ç«¯IDä¸åŒ¹é…');
  }
  
  // æ ‡è®°ä¸ºå·²ä½¿ç”¨
  codeInfo.used = true;
  
  return generateAccessToken(codeInfo.userId);
}
```

### 2.5 PKCEæ‰©å±•è¯¦è§£


**ğŸ“± PKCEè§£å†³çš„é—®é¢˜**

> **ä»€ä¹ˆæ˜¯PKCE**ï¼šProof Key for Code Exchangeï¼Œä¸ºç§»åŠ¨åº”ç”¨å’Œå•é¡µåº”ç”¨æä¾›é¢å¤–å®‰å…¨ä¿æŠ¤ã€‚

```
ä¼ ç»Ÿæˆæƒç æµç¨‹çš„é—®é¢˜ï¼š

ç§»åŠ¨åº”ç”¨çš„ç‰¹æ®Šæƒ…å†µï¼š
1. æ— æ³•å®‰å…¨å­˜å‚¨client_secretï¼ˆåº”ç”¨å¯ä»¥è¢«åç¼–è¯‘ï¼‰
2. è‡ªå®šä¹‰URL Schemeå¯èƒ½è¢«åŠ«æŒ
3. æˆæƒç åœ¨è®¾å¤‡é—´ä¼ è¾“å¯èƒ½è¢«æˆªè·

ä¾‹å¦‚ï¼š
ç”¨æˆ·åœ¨å¾®ä¿¡ä¸­ç‚¹å‡»é“¾æ¥ â†’ è·³è½¬åˆ°Safariæˆæƒ â†’ æˆæƒåè·³å›åº”ç”¨
      â†‘                                      â†‘
 æ¶æ„åº”ç”¨å¯èƒ½åœ¨è¿™é‡Œæ³¨å†Œç›¸åŒçš„URL Schemeæˆªè·æˆæƒç 
```

**ğŸ” PKCEå·¥ä½œæµç¨‹**

```javascript
// æ­¥éª¤1ï¼šå®¢æˆ·ç«¯ç”Ÿæˆcode_verifierå’Œcode_challenge
function generatePKCE() {
  // code_verifier: éšæœºå­—ç¬¦ä¸²ï¼ˆ43-128ä½ï¼‰
  const codeVerifier = generateRandomString(128);
  
  // code_challenge: code_verifierçš„SHA256å“ˆå¸Œå€¼ï¼ˆbase64ç¼–ç ï¼‰
  const codeChallenge = base64URLEncode(
    sha256(codeVerifier)
  );
  
  return { codeVerifier, codeChallenge };
}

// æ­¥éª¤2ï¼šæˆæƒè¯·æ±‚æ—¶å¸¦ä¸Šcode_challenge
const { codeVerifier, codeChallenge } = generatePKCE();

const authUrl = `https://oauth.example.com/authorize?
  client_id=your_client_id&
  redirect_uri=your_callback&
  code_challenge=${codeChallenge}&
  code_challenge_method=S256&
  response_type=code`;

// æ­¥éª¤3ï¼šæ¢å–ä»¤ç‰Œæ—¶å¸¦ä¸Šcode_verifier
const tokenResponse = await fetch('https://oauth.example.com/token', {
  method: 'POST',
  headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
  body: `grant_type=authorization_code&
         code=${authorizationCode}&
         redirect_uri=${redirectUri}&
         client_id=${clientId}&
         code_verifier=${codeVerifier}`
});
```

```
PKCEé˜²æŠ¤åŸç†ï¼š

æ”»å‡»è€…æˆªè·äº†æˆæƒç ï¼Œä½†æ˜¯ï¼š
1. æ”»å‡»è€…ä¸çŸ¥é“åŸå§‹çš„code_verifier
2. æ— æ³•é€šè¿‡code_challengeæ¨ç®—å‡ºcode_verifierï¼ˆå•å‘å“ˆå¸Œï¼‰
3. æ²¡æœ‰æ­£ç¡®çš„code_verifierå°±æ— æ³•æ¢å–è®¿é—®ä»¤ç‰Œ

å°±åƒï¼šæˆæƒç æ˜¯"é—¨ç¥¨"ï¼Œcode_verifieræ˜¯"èº«ä»½è¯"
      æœ‰é—¨ç¥¨æ²¡èº«ä»½è¯ä¹Ÿè¿›ä¸äº†åœº
```

### 2.6 Scopeæƒé™æ§åˆ¶


**ğŸ¯ ç²¾ç»†åŒ–æƒé™ç®¡ç†**

> **ä»€ä¹ˆæ˜¯Scope**ï¼šæƒé™èŒƒå›´ï¼Œå®šä¹‰ç¬¬ä¸‰æ–¹åº”ç”¨å¯ä»¥è®¿é—®å“ªäº›èµ„æºå’Œæ‰§è¡Œå“ªäº›æ“ä½œã€‚

```javascript
// å¸¸è§çš„Scopeç¤ºä¾‹
const scopes = {
  'read:profile': 'è¯»å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯',
  'read:email': 'è·å–ç”¨æˆ·é‚®ç®±',
  'write:post': 'å‘å¸ƒå†…å®¹',
  'read:contacts': 'è¯»å–è”ç³»äºº',
  'admin': 'ç®¡ç†å‘˜æƒé™'
};

// æˆæƒæ—¶æŒ‡å®šscope
const authUrl = `https://oauth.example.com/authorize?
  client_id=your_client_id&
  scope=read:profile read:email&
  response_type=code`;

// æœåŠ¡å™¨éªŒè¯tokenæ—¶æ£€æŸ¥scope
function checkPermission(token, requiredScope) {
  const tokenInfo = validateToken(token);
  
  if (!tokenInfo.scopes.includes(requiredScope)) {
    throw new Error(`æƒé™ä¸è¶³ï¼Œéœ€è¦ ${requiredScope} æƒé™`);
  }
  
  return true;
}
```

**ğŸ”„ æœ€å°æƒé™åŸåˆ™**

```
æƒé™ç”³è¯·çš„æœ€ä½³å®è·µï¼š

âŒ é”™è¯¯åšæ³•ï¼š
åº”ç”¨ä¸€æ¬¡æ€§ç”³è¯·æ‰€æœ‰å¯èƒ½ç”¨åˆ°çš„æƒé™
scope=read:profile,read:email,write:post,read:contacts,admin

âœ… æ­£ç¡®åšæ³•ï¼š
æ ¹æ®åŠŸèƒ½éœ€è¦é€æ­¥ç”³è¯·æƒé™
ç™»å½•æ—¶åªç”³è¯·ï¼šscope=read:profile
å‘é‚®ä»¶æ—¶ç”³è¯·ï¼šscope=read:email
å‘å¸ƒå†…å®¹æ—¶ç”³è¯·ï¼šscope=write:post
```

---

## 3. ğŸ”— ç¬¬ä¸‰æ–¹ç™»å½•å®ç°åŸç†


### 3.1 ç¬¬ä¸‰æ–¹ç™»å½•çš„æ ¸å¿ƒé€»è¾‘


**ğŸ¤ ä»€ä¹ˆæ˜¯ç¬¬ä¸‰æ–¹ç™»å½•**

> **ç®€å•ç†è§£**ï¼šç¬¬ä¸‰æ–¹ç™»å½•å°±æ˜¯ç”¨ä½ å·²æœ‰çš„è´¦å·ï¼ˆå¦‚å¾®ä¿¡ã€QQã€GitHubï¼‰æ¥ç™»å½•å…¶ä»–ç½‘ç«™ï¼Œä¸éœ€è¦é‡æ–°æ³¨å†Œè´¦å·ã€‚

```
ä¼ ç»Ÿæ³¨å†Œç™»å½• vs ç¬¬ä¸‰æ–¹ç™»å½•ï¼š

ä¼ ç»Ÿæ–¹å¼ï¼š
ç½‘ç«™A â†’ ç”¨æˆ·æ³¨å†Œ â†’ å¡«å†™ä¿¡æ¯ â†’ éªŒè¯é‚®ç®± â†’ è®¾ç½®å¯†ç  â†’ ç™»å½•æˆåŠŸ
é—®é¢˜ï¼šæ¯ä¸ªç½‘ç«™éƒ½è¦æ³¨å†Œï¼Œè®°ä½å¾ˆå¤šå¯†ç 

ç¬¬ä¸‰æ–¹ç™»å½•ï¼š
ç½‘ç«™A â†’ ç‚¹å‡»"å¾®ä¿¡ç™»å½•" â†’ å¾®ä¿¡æˆæƒ â†’ è·å–ç”¨æˆ·ä¿¡æ¯ â†’ è‡ªåŠ¨ç™»å½•
ä¼˜åŠ¿ï¼šä¸€ä¸ªå¾®ä¿¡è´¦å·ç™»å½•æ‰€æœ‰æ”¯æŒçš„ç½‘ç«™
```

### 3.2 å¾®ä¿¡ç™»å½•å®ç°æµç¨‹


**ğŸ“± å¾®ä¿¡ç™»å½•å®Œæ•´æµç¨‹**

```
å¾®ä¿¡ç™»å½•æ—¶åºå›¾ï¼š

ç”¨æˆ·        ç¬¬ä¸‰æ–¹ç½‘ç«™      å¾®ä¿¡æˆæƒæœåŠ¡å™¨      å¾®ä¿¡APIæœåŠ¡å™¨
 |             |                |                 |
 |â”€ç‚¹å‡»å¾®ä¿¡ç™»å½•â”€>|                |                 |
 |             |â”€æ„å»ºæˆæƒé“¾æ¥â”€>  |                 |
 |<â”€è·³è½¬åˆ°å¾®ä¿¡â”€ |                |                 |
 |             |                |                 |
 |â”€â”€â”€â”€â”€â”€â”€â”€ç”¨æˆ·æˆæƒç¡®è®¤â”€â”€â”€â”€â”€â”€â”€â”€â”€>|                 |
 |             |                |                 |
 |             |<â”€â”€è¿”å›æˆæƒç â”€â”€â”€|                 |
 |â”€è·³è½¬å›ç½‘ç«™â”€> |                |                 |
 |             |                |                 |
 |             |â”€â”€â”€ç”¨æˆæƒç æ¢å–access_tokenâ”€â”€â”€>|   |
 |             |                |                 |
 |             |<â”€â”€â”€â”€è¿”å›access_tokenå’Œopenidâ”€â”€|   |
 |             |                |                 |
 |             |â”€â”€â”€â”€â”€â”€â”€â”€ç”¨tokenè·å–ç”¨æˆ·ä¿¡æ¯â”€â”€â”€â”€â”€â”€â”€â”€>|
 |             |                |                 |
 |             |<â”€â”€â”€â”€â”€â”€â”€è¿”å›ç”¨æˆ·ä¿¡æ¯ï¼ˆå¤´åƒã€æ˜µç§°ï¼‰â”€â”€|
 |             |                |                 |
 |<â”€ç™»å½•æˆåŠŸâ”€ |                |                 |
```

**ğŸ’» å¾®ä¿¡ç™»å½•ä»£ç å®ç°**

```javascript
// æ­¥éª¤1ï¼šæ„å»ºå¾®ä¿¡æˆæƒé“¾æ¥
function buildWechatAuthUrl() {
  const config = {
    appId: 'your_wechat_appid',
    redirectUri: 'https://yoursite.com/auth/wechat/callback',
    scope: 'snsapi_userinfo', // è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
    state: generateRandomString()
  };
  
  const authUrl = `https://open.weixin.qq.com/connect/qrconnect?
    appid=${config.appId}&
    redirect_uri=${encodeURIComponent(config.redirectUri)}&
    response_type=code&
    scope=${config.scope}&
    state=${config.state}`;
    
  return authUrl;
}

// æ­¥éª¤2ï¼šå¤„ç†å¾®ä¿¡å›è°ƒ
async function handleWechatCallback(code, state) {
  // éªŒè¯stateå‚æ•°
  if (!validateState(state)) {
    throw new Error('StateéªŒè¯å¤±è´¥');
  }
  
  // ç”¨æˆæƒç æ¢å–access_token
  const tokenResponse = await fetch('https://api.weixin.qq.com/sns/oauth2/access_token', {
    method: 'GET',
    url: `https://api.weixin.qq.com/sns/oauth2/access_token?
      appid=${config.appId}&
      secret=${config.appSecret}&
      code=${code}&
      grant_type=authorization_code`
  });
  
  const tokenData = await tokenResponse.json();
  const { access_token, openid } = tokenData;
  
  // è·å–ç”¨æˆ·ä¿¡æ¯
  const userResponse = await fetch(
    `https://api.weixin.qq.com/sns/userinfo?
     access_token=${access_token}&
     openid=${openid}&
     lang=zh_CN`
  );
  
  const userInfo = await userResponse.json();
  
  // åœ¨ç³»ç»Ÿä¸­åˆ›å»ºæˆ–æ›´æ–°ç”¨æˆ·
  const user = await createOrUpdateUser({
    openId: openid,
    nickname: userInfo.nickname,
    avatar: userInfo.headimgurl,
    gender: userInfo.sex
  });
  
  return user;
}
```

### 3.3 GitHub OAuthç™»å½•


**ğŸ™ GitHubç™»å½•ç‰¹ç‚¹**

```javascript
// GitHub OAuthé…ç½®
const githubConfig = {
  clientId: 'your_github_client_id',
  clientSecret: 'your_github_client_secret',
  scope: 'user:email', // è·å–ç”¨æˆ·é‚®ç®±æƒé™
  authUrl: 'https://github.com/login/oauth/authorize',
  tokenUrl: 'https://github.com/login/oauth/access_token',
  userUrl: 'https://api.github.com/user'
};

// æ„å»ºGitHubæˆæƒé“¾æ¥
function buildGithubAuthUrl() {
  return `${githubConfig.authUrl}?
    client_id=${githubConfig.clientId}&
    redirect_uri=${encodeURIComponent(redirectUri)}&
    scope=${githubConfig.scope}&
    state=${generateState()}`;
}

// å¤„ç†GitHubå›è°ƒ
async function handleGithubCallback(code) {
  // è·å–access_token
  const tokenResponse = await fetch(githubConfig.tokenUrl, {
    method: 'POST',
    headers: {
      'Accept': 'application/json',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      client_id: githubConfig.clientId,
      client_secret: githubConfig.clientSecret,
      code: code
    })
  });
  
  const { access_token } = await tokenResponse.json();
  
  // è·å–ç”¨æˆ·ä¿¡æ¯
  const userResponse = await fetch(githubConfig.userUrl, {
    headers: {
      'Authorization': `Bearer ${access_token}`,
      'User-Agent': 'YourApp'
    }
  });
  
  const githubUser = await userResponse.json();
  
  return {
    id: githubUser.id,
    username: githubUser.login,
    email: githubUser.email,
    avatar: githubUser.avatar_url
  };
}
```

---

## 4. ğŸ†š OAuth2 vs OpenID Connect


### 4.1 æ ¸å¿ƒåŒºåˆ«ç†è§£


**ğŸ” æœ¬è´¨å·®å¼‚**

> **OAuth2**ï¼šæˆæƒåè®®ï¼Œè§£å†³"æˆ‘èƒ½è®¿é—®ä»€ä¹ˆèµ„æº"çš„é—®é¢˜
> **OpenID Connect**ï¼šèº«ä»½è®¤è¯åè®®ï¼Œè§£å†³"æˆ‘æ˜¯è°"çš„é—®é¢˜

```
ç”Ÿæ´»ä¸­çš„ç±»æ¯”ï¼š

OAuth2 = é—¨ç¦å¡
â€¢ ç»™ä½ ä¸€å¼ å¡ï¼Œå¯ä»¥è¿›å…¥ç‰¹å®šæˆ¿é—´
â€¢ å…³æ³¨çš„æ˜¯ä½ èƒ½åšä»€ä¹ˆ
â€¢ ä¸å…³å¿ƒä½ å…·ä½“æ˜¯è°

OpenID Connect = èº«ä»½è¯ + é—¨ç¦å¡
â€¢ ä¸ä»…ç»™ä½ é—¨ç¦æƒé™
â€¢ è¿˜è¦ç¡®è®¤ä½ çš„èº«ä»½ä¿¡æ¯
â€¢ æ—¢çŸ¥é“ä½ èƒ½åšä»€ä¹ˆï¼Œä¹ŸçŸ¥é“ä½ æ˜¯è°
```

**ğŸ“Š è¯¦ç»†å¯¹æ¯”è¡¨**

| **æ–¹é¢** | **OAuth2** | **OpenID Connect** |
|---------|-----------|-------------------|
| **ä¸»è¦ç›®çš„** | `æˆæƒ(Authorization)` | `è®¤è¯(Authentication) + æˆæƒ` |
| **è§£å†³é—®é¢˜** | `ç¬¬ä¸‰æ–¹åº”ç”¨è®¿é—®ç”¨æˆ·èµ„æº` | `ç”¨æˆ·èº«ä»½éªŒè¯ + å•ç‚¹ç™»å½•` |
| **è¿”å›å†…å®¹** | `Access Token` | `Access Token + ID Token` |
| **ç”¨æˆ·ä¿¡æ¯** | `é€šè¿‡APIè·å–ï¼Œæ ¼å¼ä¸ç»Ÿä¸€` | `æ ‡å‡†åŒ–çš„ç”¨æˆ·ä¿¡æ¯æ ¼å¼` |
| **é€‚ç”¨åœºæ™¯** | `APIæˆæƒã€èµ„æºè®¿é—®` | `å•ç‚¹ç™»å½•ã€èº«ä»½éªŒè¯` |

### 4.2 ID Tokenè¯¦è§£


**ğŸ« ä»€ä¹ˆæ˜¯ID Token**

> **ID Token**ï¼šä¸€ä¸ªåŒ…å«ç”¨æˆ·èº«ä»½ä¿¡æ¯çš„JWTä»¤ç‰Œï¼Œç”±OpenID Connectæä¾›ï¼Œæ˜¯å¯¹OAuth2çš„æ‰©å±•ã€‚

```javascript
// ID Tokençš„ç»“æ„ï¼ˆJWTæ ¼å¼ï¼‰
const idToken = {
  header: {
    "alg": "RS256",
    "kid": "key-id",
    "typ": "JWT"
  },
  payload: {
    "iss": "https://auth.example.com",  // ç­¾å‘è€…
    "sub": "user123",                   // ç”¨æˆ·å”¯ä¸€æ ‡è¯†
    "aud": "your-client-id",           // æ¥æ”¶æ–¹
    "exp": 1640995200,                 // è¿‡æœŸæ—¶é—´
    "iat": 1640991600,                 // ç­¾å‘æ—¶é—´
    "email": "user@example.com",       // ç”¨æˆ·é‚®ç®±
    "name": "å¼ ä¸‰",                     // ç”¨æˆ·å§“å
    "picture": "https://avatar.url"    // ç”¨æˆ·å¤´åƒ
  },
  signature: "..."
};

// éªŒè¯å’Œè§£æID Token
function parseIdToken(idToken) {
  // 1. éªŒè¯ç­¾å
  if (!verifySignature(idToken)) {
    throw new Error('ID Tokenç­¾åæ— æ•ˆ');
  }
  
  // 2. æ£€æŸ¥è¿‡æœŸæ—¶é—´
  const payload = decodeJWT(idToken).payload;
  if (Date.now() > payload.exp * 1000) {
    throw new Error('ID Tokenå·²è¿‡æœŸ');
  }
  
  // 3. éªŒè¯audience
  if (payload.aud !== config.clientId) {
    throw new Error('ID Tokenæ¥æ”¶æ–¹ä¸åŒ¹é…');
  }
  
  return payload;
}
```

### 4.3 ä½¿ç”¨åœºæ™¯åŒºåˆ†


**ğŸ¯ é€‰æ‹©æŒ‡å—**

```
ä»€ä¹ˆæ—¶å€™ç”¨OAuth2ï¼š
âœ… ç¬¬ä¸‰æ–¹åº”ç”¨éœ€è¦è®¿é—®ç”¨æˆ·çš„APIèµ„æº
âœ… ç”¨æˆ·æˆæƒåº”ç”¨ä»£è¡¨è‡ªå·±æ‰§è¡Œæ“ä½œ
âœ… éœ€è¦ç»†ç²’åº¦çš„æƒé™æ§åˆ¶
ä¾‹å­ï¼š
- ç…§ç‰‡åº”ç”¨è®¿é—®ç”¨æˆ·çš„äº‘ç›˜ç…§ç‰‡
- ç¤¾äº¤åº”ç”¨ä»£æ›¿ç”¨æˆ·å‘å¸ƒå†…å®¹
- æ•°æ®åˆ†æå·¥å…·è¯»å–ç”¨æˆ·çš„ä¸šåŠ¡æ•°æ®

ä»€ä¹ˆæ—¶å€™ç”¨OpenID Connectï¼š
âœ… ç”¨æˆ·å•ç‚¹ç™»å½•åœºæ™¯
âœ… éœ€è¦è·å–ç”¨æˆ·èº«ä»½ä¿¡æ¯
âœ… å¤šä¸ªåº”ç”¨å…±äº«ç”¨æˆ·èº«ä»½
ä¾‹å­ï¼š
- ä¼ä¸šå†…éƒ¨å¤šä¸ªç³»ç»Ÿç»Ÿä¸€ç™»å½•
- ç”¨æˆ·ç”¨Googleè´¦å·ç™»å½•å„ç§ç½‘ç«™
- ç§»åŠ¨åº”ç”¨çš„ç¤¾äº¤ç™»å½•åŠŸèƒ½
```

---

## 5. ğŸ’¼ å®æˆ˜åº”ç”¨åœºæ™¯


### 5.1 ä¼ä¸šå•ç‚¹ç™»å½•(SSO)


**ğŸ¢ ä¼ä¸šSSOæ¶æ„**

```
ä¼ä¸šSSOç³»ç»Ÿæ¶æ„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   é‚®ä»¶ç³»ç»Ÿ   â”‚    â”‚   OAç³»ç»Ÿ    â”‚    â”‚  è´¢åŠ¡ç³»ç»Ÿ   â”‚
â”‚             â”‚    â”‚             â”‚    â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                  â”‚                  â”‚
       â”‚                  â”‚                  â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚    ç»Ÿä¸€èº«ä»½è®¤è¯ä¸­å¿ƒ      â”‚
              â”‚   (OpenID Connect)      â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–²
                          â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚    å‘˜å·¥ç™»å½•    â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**âš¡ SSOå®ç°æµç¨‹**

```javascript
// ä¼ä¸šSSOç™»å½•æµç¨‹
class EnterpriseSSOHandler {
  async handleLogin(email, password) {
    // 1. éªŒè¯å‘˜å·¥èº«ä»½
    const employee = await this.authenticateEmployee(email, password);
    if (!employee) {
      throw new Error('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯');
    }
    
    // 2. ç”Ÿæˆç»Ÿä¸€çš„èº«ä»½ä»¤ç‰Œ
    const idToken = this.generateIDToken({
      sub: employee.id,
      email: employee.email,
      name: employee.name,
      department: employee.department,
      role: employee.role
    });
    
    // 3. è®¾ç½®SSOä¼šè¯
    const ssoSession = await this.createSSOSession(employee.id);
    
    return { idToken, ssoSession };
  }
  
  // å…¶ä»–ç³»ç»ŸéªŒè¯SSOçŠ¶æ€
  async validateSSOAccess(systemId, idToken) {
    // éªŒè¯ID Token
    const userInfo = this.validateIDToken(idToken);
    
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®è¯¥ç³»ç»Ÿ
    const hasAccess = await this.checkSystemAccess(
      userInfo.sub, 
      systemId
    );
    
    if (!hasAccess) {
      throw new Error('æ— æƒé™è®¿é—®è¯¥ç³»ç»Ÿ');
    }
    
    return userInfo;
  }
}
```

### 5.2 APIæˆæƒç®¡ç†


**ğŸ”§ APIæ¥å£ä¿æŠ¤**

```javascript
// APIæˆæƒä¸­é—´ä»¶
class APIAuthMiddleware {
  async validateToken(req, res, next) {
    const authHeader = req.headers.authorization;
    
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      return res.status(401).json({ error: 'ç¼ºå°‘è®¿é—®ä»¤ç‰Œ' });
    }
    
    const token = authHeader.substring(7);
    
    try {
      // éªŒè¯ä»¤ç‰Œ
      const tokenInfo = await this.verifyAccessToken(token);
      
      // æ£€æŸ¥æƒé™èŒƒå›´
      const requiredScope = this.getRequiredScope(req.path, req.method);
      if (!this.hasScope(tokenInfo.scopes, requiredScope)) {
        return res.status(403).json({ 
          error: `æƒé™ä¸è¶³ï¼Œéœ€è¦ ${requiredScope} æƒé™` 
        });
      }
      
      // æ·»åŠ ç”¨æˆ·ä¿¡æ¯åˆ°è¯·æ±‚ä¸­
      req.user = tokenInfo.user;
      req.scopes = tokenInfo.scopes;
      
      next();
    } catch (error) {
      return res.status(401).json({ error: 'æ— æ•ˆçš„è®¿é—®ä»¤ç‰Œ' });
    }
  }
  
  getRequiredScope(path, method) {
    const scopeMap = {
      'GET /api/user/profile': 'read:profile',
      'POST /api/user/posts': 'write:posts',
      'GET /api/user/emails': 'read:email',
      'DELETE /api/admin/*': 'admin'
    };
    
    const key = `${method} ${path}`;
    return scopeMap[key] || 'basic';
  }
}

// ä½¿ç”¨ç¤ºä¾‹
app.use('/api', new APIAuthMiddleware().validateToken);

app.get('/api/user/profile', (req, res) => {
  // è¿™é‡Œå¯ä»¥ç¡®ä¿ç”¨æˆ·å·²ç»é€šè¿‡OAuth2æˆæƒ
  res.json({
    id: req.user.id,
    name: req.user.name,
    email: req.user.email
  });
});
```

### 5.3 ç§»åŠ¨åº”ç”¨é›†æˆ


**ğŸ“± ç§»åŠ¨ç«¯OAuth2æœ€ä½³å®è·µ**

```javascript
// ç§»åŠ¨åº”ç”¨OAuth2å®ç°ï¼ˆReact Nativeç¤ºä¾‹ï¼‰
class MobileOAuthHandler {
  async initiateOAuth() {
    // 1. ç”ŸæˆPKCEå‚æ•°
    const { codeVerifier, codeChallenge } = this.generatePKCE();
    
    // 2. ä¿å­˜code_verifier
    await AsyncStorage.setItem('oauth_code_verifier', codeVerifier);
    
    // 3. æ„å»ºæˆæƒURL
    const authUrl = this.buildAuthUrl(codeChallenge);
    
    // 4. æ‰“å¼€ç³»ç»Ÿæµè§ˆå™¨è¿›è¡Œæˆæƒ
    const result = await AuthSession.startAsync({
      authUrl: authUrl,
      returnUrl: 'myapp://oauth/callback'
    });
    
    if (result.type === 'success') {
      return this.handleAuthCallback(result.params);
    } else {
      throw new Error('ç”¨æˆ·å–æ¶ˆæˆæƒ');
    }
  }
  
  async handleAuthCallback(params) {
    const { code, state } = params;
    
    // éªŒè¯state
    const savedState = await AsyncStorage.getItem('oauth_state');
    if (state !== savedState) {
      throw new Error('StateéªŒè¯å¤±è´¥');
    }
    
    // è·å–ä¿å­˜çš„code_verifier
    const codeVerifier = await AsyncStorage.getItem('oauth_code_verifier');
    
    // æ¢å–è®¿é—®ä»¤ç‰Œ
    const tokens = await this.exchangeCodeForTokens(code, codeVerifier);
    
    // ä¿å­˜ä»¤ç‰Œ
    await AsyncStorage.setItem('access_token', tokens.access_token);
    await AsyncStorage.setItem('refresh_token', tokens.refresh_token);
    
    return tokens;
  }
  
  generatePKCE() {
    const codeVerifier = this.generateRandomString(128);
    const codeChallenge = this.base64URLEncode(
      CryptoJS.SHA256(codeVerifier)
    );
    return { codeVerifier, codeChallenge };
  }
}
```

---

## 6. âš ï¸ å¸¸è§å®‰å…¨æ¼æ´ä¸é˜²æŠ¤


### 6.1 æˆæƒç æ‹¦æˆªæ”»å‡»


**ğŸ¯ æ”»å‡»åŸç†**

```
æˆæƒç æ‹¦æˆªæ”»å‡»åœºæ™¯ï¼š

æ­£å¸¸æµç¨‹ï¼š
åº”ç”¨Aæ³¨å†ŒURL Scheme: myapp://
ç”¨æˆ·æˆæƒåè·³è½¬: myapp://oauth/callback?code=abc123

æ”»å‡»æµç¨‹ï¼š
1. æ¶æ„åº”ç”¨Bä¹Ÿæ³¨å†Œç›¸åŒçš„URL Scheme: myapp://
2. å½“ç³»ç»Ÿæœ‰å¤šä¸ªåº”ç”¨æ³¨å†Œç›¸åŒschemeæ—¶ï¼Œå¯èƒ½è·³è½¬åˆ°æ¶æ„åº”ç”¨
3. æ¶æ„åº”ç”¨è·å–åˆ°æˆæƒç 
4. æ¶æ„åº”ç”¨ç”¨æˆæƒç æ¢å–ç”¨æˆ·çš„è®¿é—®ä»¤ç‰Œ
```

**ğŸ›¡ï¸ é˜²æŠ¤æªæ–½**

```javascript
// 1. ä½¿ç”¨åº”ç”¨ä¸“ç”¨çš„URL Scheme
// âŒ é€šç”¨scheme: myapp://
// âœ… åŒ…å«åŒ…åçš„scheme: com.yourcompany.myapp://

// 2. å®ç°PKCEéªŒè¯
const pkceProtection = {
  // ç”Ÿæˆå¹¶ä¿å­˜code_verifier
  async initiate() {
    const codeVerifier = generateSecureRandom(128);
    const codeChallenge = sha256Base64URL(codeVerifier);
    
    await secureStorage.setItem('pkce_verifier', codeVerifier);
    
    return codeChallenge;
  },
  
  // éªŒè¯æˆæƒç æ—¶ä½¿ç”¨code_verifier
  async verify(authCode) {
    const codeVerifier = await secureStorage.getItem('pkce_verifier');
    
    if (!codeVerifier) {
      throw new Error('PKCEéªŒè¯å¤±è´¥ï¼šæ‰¾ä¸åˆ°code_verifier');
    }
    
    // å³ä½¿æ”»å‡»è€…æˆªè·æˆæƒç ï¼Œæ²¡æœ‰code_verifierä¹Ÿæ— æ³•æ¢å–ä»¤ç‰Œ
    return this.exchangeToken(authCode, codeVerifier);
  }
};

// 3. ä½¿ç”¨App Links (Android) æˆ– Universal Links (iOS)
// è¿™äº›é“¾æ¥ä¸åº”ç”¨çš„åŒ…å/Bundle IDç»‘å®šï¼Œæ›´å®‰å…¨
```

### 6.2 ä»¤ç‰Œæ³„éœ²é˜²æŠ¤


**ğŸ’” ä»¤ç‰Œæ³„éœ²çš„å±å®³**

```
è®¿é—®ä»¤ç‰Œæ³„éœ²çš„å¯èƒ½é€”å¾„ï¼š
1. æ—¥å¿—æ–‡ä»¶ä¸­æ‰“å°äº†ä»¤ç‰Œ
2. URLå‚æ•°ä¸­ä¼ é€’ä»¤ç‰Œï¼ˆGETè¯·æ±‚ï¼‰
3. å­˜å‚¨åœ¨ä¸å®‰å…¨çš„åœ°æ–¹ï¼ˆå¦‚localStorageï¼‰
4. é€šè¿‡HTTPä¼ è¾“ï¼ˆæœªä½¿ç”¨HTTPSï¼‰
5. ç¬¬ä¸‰æ–¹JavaScriptåº“è·å–ä»¤ç‰Œ
```

**ğŸ”’ ä»¤ç‰Œå®‰å…¨æœ€ä½³å®è·µ**

```javascript
// âŒ é”™è¯¯çš„ä»¤ç‰Œå¤„ç†æ–¹å¼
class BadTokenHandler {
  saveToken(token) {
    // é”™è¯¯1ï¼šå­˜å‚¨åœ¨localStorageï¼ˆXSSæ”»å‡»å¯è·å–ï¼‰
    localStorage.setItem('access_token', token);
    
    // é”™è¯¯2ï¼šåœ¨URLä¸­ä¼ é€’ä»¤ç‰Œ
    window.location.href = `/dashboard?token=${token}`;
    
    // é”™è¯¯3ï¼šåœ¨æ—¥å¿—ä¸­æ‰“å°ä»¤ç‰Œ
    console.log('Access Token:', token);
  }
}

// âœ… æ­£ç¡®çš„ä»¤ç‰Œå¤„ç†æ–¹å¼
class SecureTokenHandler {
  saveToken(token, refreshToken) {
    // æ­£ç¡®1ï¼šä½¿ç”¨HttpOnly Cookieå­˜å‚¨ï¼ˆé˜²XSSï¼‰
    this.setHttpOnlyCookie('access_token', token, {
      secure: true,      // ä»…HTTPSä¼ è¾“
      sameSite: 'strict' // é˜²CSRF
    });
    
    // æ­£ç¡®2ï¼šåˆ·æ–°ä»¤ç‰ŒåŠ å¯†å­˜å‚¨
    const encryptedRefreshToken = this.encrypt(refreshToken);
    sessionStorage.setItem('rt', encryptedRefreshToken);
  }
  
  useToken(apiCall) {
    // æ­£ç¡®3ï¼šé€šè¿‡Headerä¼ é€’ä»¤ç‰Œ
    return fetch(apiCall.url, {
      headers: {
        'Authorization': `Bearer ${this.getToken()}`,
        'Content-Type': 'application/json'
      },
      method: apiCall.method,
      body: JSON.stringify(apiCall.data)
    });
  }
  
  // æ­£ç¡®4ï¼šå®šæœŸåˆ·æ–°ä»¤ç‰Œ
  async refreshTokenIfNeeded() {
    const token = this.getToken();
    const tokenInfo = this.decodeJWT(token);
    
    // ä»¤ç‰Œå³å°†è¿‡æœŸæ—¶è‡ªåŠ¨åˆ·æ–°
    if (tokenInfo.exp - Date.now()/1000 < 300) { // 5åˆ†é’Ÿå†…è¿‡æœŸ
      await this.refreshToken();
    }
  }
}
```

### 6.3 è·¨ç«™è¯·æ±‚ä¼ªé€ (CSRF)é˜²æŠ¤


**ğŸ­ CSRFæ”»å‡»æ·±å…¥è§£æ**

```javascript
// CSRFæ”»å‡»ç¤ºä¾‹
// æ”»å‡»è€…ç½‘ç«™ evil.com ä¸Šçš„æ¶æ„ä»£ç 
function csrfAttack() {
  // ç”¨æˆ·å·²ç»åœ¨ bank.com ç™»å½•ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨å¸¦ä¸Šcookie
  const maliciousForm = document.createElement('form');
  maliciousForm.method = 'POST';
  maliciousForm.action = 'https://bank.com/transfer';
  maliciousForm.innerHTML = `
    <input name="to_account" value="attacker_account" />
    <input name="amount" value="10000" />
  `;
  
  document.body.appendChild(maliciousForm);
  maliciousForm.submit(); // å·å·æäº¤è½¬è´¦è¯·æ±‚
}

// OAuth2ä¸­çš„CSRFï¼šè¯±å¯¼ç”¨æˆ·æˆæƒç»™é”™è¯¯çš„åº”ç”¨
function oauthCSRFAttack() {
  // æ”»å‡»è€…æ„é€ æˆæƒé“¾æ¥ï¼Œä½†redirect_uriæŒ‡å‘æ”»å‡»è€…æ§åˆ¶çš„åœ°å€
  const maliciousAuthUrl = `
    https://oauth.example.com/authorize?
    client_id=legitimate_app_id&
    redirect_uri=https://attacker.com/steal_code&
    response_type=code
  `;
  
  // è¯±å¯¼ç”¨æˆ·ç‚¹å‡»ï¼Œç”¨æˆ·ä»¥ä¸ºæ˜¯åœ¨ç»™åˆæ³•åº”ç”¨æˆæƒ
  window.location.href = maliciousAuthUrl;
}
```

**ğŸ›¡ï¸ å®Œå–„çš„CSRFé˜²æŠ¤**

```javascript
class CSRFProtection {
  // ç”Ÿæˆå’ŒéªŒè¯Stateå‚æ•°
  generateState() {
    const state = {
      random: generateSecureRandom(32),
      timestamp: Date.now(),
      clientInfo: this.getClientFingerprint()
    };
    
    // ç­¾åstateé˜²ç¯¡æ”¹
    const signedState = this.signState(state);
    return signedState;
  }
  
  validateState(receivedState, savedState) {
    // 1. éªŒè¯ç­¾å
    if (!this.verifyStateSignature(receivedState)) {
      throw new Error('Stateç­¾åéªŒè¯å¤±è´¥');
    }
    
    // 2. æ£€æŸ¥æ˜¯å¦åŒ¹é…
    if (receivedState !== savedState) {
      throw new Error('Stateå‚æ•°ä¸åŒ¹é…');
    }
    
    // 3. æ£€æŸ¥æ—¶æ•ˆæ€§ï¼ˆé˜²é‡æ”¾æ”»å‡»ï¼‰
    const stateData = this.parseState(receivedState);
    if (Date.now() - stateData.timestamp > 600000) { // 10åˆ†é’Ÿ
      throw new Error('Stateå·²è¿‡æœŸ');
    }
    
    return true;
  }
  
  // åŒé‡éªŒè¯ï¼šState + Referreræ£€æŸ¥
  validateRequest(req) {
    const receivedState = req.query.state;
    const savedState = req.session.oauthState;
    
    // StateéªŒè¯
    this.validateState(receivedState, savedState);
    
    // ReferreréªŒè¯
    const referrer = req.headers.referer;
    if (!referrer || !this.isValidReferrer(referrer)) {
      throw new Error('è¯·æ±‚æ¥æºéªŒè¯å¤±è´¥');
    }
    
    return true;
  }
}
```

### 6.4 å¼€æ”¾é‡å®šå‘æ¼æ´


**ğŸŒ å¼€æ”¾é‡å®šå‘çš„å±é™©**

```javascript
// âŒ å±é™©çš„é‡å®šå‘å¤„ç†
app.get('/oauth/callback', (req, res) => {
  const { code, redirect_url } = req.query;
  
  // å±é™©ï¼šç›´æ¥ä½¿ç”¨ç”¨æˆ·æä¾›çš„redirect_url
  if (code) {
    res.redirect(redirect_url); // æ”»å‡»è€…å¯ä»¥é‡å®šå‘åˆ°æ¶æ„ç½‘ç«™
  }
});

// æ”»å‡»ç¤ºä¾‹ï¼š
// https://yourapp.com/oauth/callback?code=abc&redirect_url=https://evil.com/steal

// âœ… å®‰å…¨çš„é‡å®šå‘å¤„ç†
class SecureRedirectHandler {
  constructor() {
    this.allowedRedirects = [
      'https://yourapp.com',
      'https://app.yourcompany.com',
      'https://mobile.yourapp.com'
    ];
  }
  
  validateAndRedirect(redirectUrl) {
    // 1. æ£€æŸ¥æ˜¯å¦åœ¨ç™½åå•ä¸­
    const isAllowed = this.allowedRedirects.some(allowed => 
      redirectUrl.startsWith(allowed)
    );
    
    if (!isAllowed) {
      throw new Error('é‡å®šå‘åœ°å€ä¸åœ¨å…è®¸åˆ—è¡¨ä¸­');
    }
    
    // 2. éªŒè¯URLæ ¼å¼
    try {
      const url = new URL(redirectUrl);
      
      // 3. åªå…è®¸HTTPSï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
      if (url.protocol !== 'https:' && process.env.NODE_ENV === 'production') {
        throw new Error('é‡å®šå‘åœ°å€å¿…é¡»ä½¿ç”¨HTTPS');
      }
      
      return redirectUrl;
    } catch (error) {
      throw new Error('æ— æ•ˆçš„é‡å®šå‘åœ°å€æ ¼å¼');
    }
  }
  
  safeRedirect(res, redirectUrl) {
    try {
      const safeUrl = this.validateAndRedirect(redirectUrl);
      res.redirect(safeUrl);
    } catch (error) {
      // é‡å®šå‘éªŒè¯å¤±è´¥ï¼Œè·³è½¬åˆ°é»˜è®¤å®‰å…¨é¡µé¢
      res.redirect('/auth/error?message=' + encodeURIComponent(error.message));
    }
  }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„å®‰å…¨è¦ç‚¹


```
ğŸ”¸ HTTPSå¿…éœ€ï¼šOAuth2çš„æ‰€æœ‰é€šä¿¡éƒ½å¿…é¡»ä½¿ç”¨HTTPSåŠ å¯†
ğŸ”¸ Stateé˜²æŠ¤ï¼šä½¿ç”¨Stateå‚æ•°é˜²æ­¢CSRFæ”»å‡»ï¼Œç¡®ä¿æˆæƒè¯·æ±‚çš„çœŸå®æ€§
ğŸ”¸ PKCEä¿æŠ¤ï¼šç§»åŠ¨åº”ç”¨å¿…é¡»ä½¿ç”¨PKCEæ‰©å±•é˜²æ­¢æˆæƒç æ‹¦æˆª
ğŸ”¸ ç™½åå•éªŒè¯ï¼šä¸¥æ ¼éªŒè¯å›è°ƒåœ°å€ï¼Œé˜²æ­¢å¼€æ”¾é‡å®šå‘æ¼æ´
ğŸ”¸ ä»¤ç‰Œå®‰å…¨ï¼šè®¿é—®ä»¤ç‰ŒçŸ­æœ‰æ•ˆæœŸã€ä¸€æ¬¡æ€§ä½¿ç”¨ã€å®‰å…¨å­˜å‚¨
ğŸ”¸ æƒé™æœ€å°åŒ–ï¼šæŒ‰éœ€ç”³è¯·Scopeæƒé™ï¼Œéµå¾ªæœ€å°æƒé™åŸåˆ™
ğŸ”¸ åŠæ—¶æ’¤é”€ï¼šæä¾›ç”¨æˆ·éšæ—¶æ’¤é”€æˆæƒçš„æœºåˆ¶
```

### 7.2 ç¬¬ä¸‰æ–¹ç™»å½•å®æ–½æŒ‡å—


**ğŸ¯ æŠ€æœ¯é€‰æ‹©**
```
é€‰æ‹©OAuth2æ—¶ï¼š
âœ… éœ€è¦è®¿é—®ç”¨æˆ·èµ„æºï¼ˆå¦‚ç…§ç‰‡ã€è”ç³»äººï¼‰
âœ… éœ€è¦ä»£è¡¨ç”¨æˆ·æ‰§è¡Œæ“ä½œï¼ˆå¦‚å‘å¸ƒå†…å®¹ï¼‰
âœ… éœ€è¦ç»†ç²’åº¦æƒé™æ§åˆ¶

é€‰æ‹©OpenID Connectæ—¶ï¼š
âœ… ä¸»è¦ç›®çš„æ˜¯ç”¨æˆ·èº«ä»½éªŒè¯
âœ… éœ€è¦æ ‡å‡†åŒ–çš„ç”¨æˆ·ä¿¡æ¯æ ¼å¼
âœ… å®ç°å•ç‚¹ç™»å½•(SSO)
```

**ğŸ”§ å®æ–½æœ€ä½³å®è·µ**
```
å‰æœŸå‡†å¤‡ï¼š
â€¢ åœ¨å„å¹³å°æ³¨å†Œå¼€å‘è€…è´¦å·
â€¢ é…ç½®æ­£ç¡®çš„å›è°ƒåœ°å€
â€¢ ç”³è¯·åˆé€‚çš„æƒé™èŒƒå›´

æŠ€æœ¯å®ç°ï¼š
â€¢ æœåŠ¡ç«¯å¤„ç†æ•æ„Ÿæ“ä½œï¼ˆtokenäº¤æ¢ï¼‰
â€¢ å®¢æˆ·ç«¯åªå¤„ç†ç”¨æˆ·äº¤äº’
â€¢ å®æ–½å®Œæ•´çš„é”™è¯¯å¤„ç†æœºåˆ¶

å®‰å…¨æªæ–½ï¼š
â€¢ å¯ç”¨æ‰€æœ‰å®‰å…¨ç‰¹æ€§ï¼ˆStateã€PKCEç­‰ï¼‰
â€¢ å®šæœŸå®¡æŸ¥å’Œæ›´æ–°å®‰å…¨é…ç½®
â€¢ ç›‘æ§å¼‚å¸¸çš„æˆæƒè¡Œä¸º
```

### 7.3 å¸¸è§é—®é¢˜è§£å†³


**â“ ä¸ºä»€ä¹ˆæˆæƒåè·³è½¬å¤±è´¥ï¼Ÿ**
- æ£€æŸ¥å›è°ƒåœ°å€æ˜¯å¦æ­£ç¡®é…ç½®
- ç¡®è®¤å›è°ƒåœ°å€ä½¿ç”¨HTTPS
- éªŒè¯å›è°ƒåœ°å€åœ¨å¹³å°ç™½åå•ä¸­

**â“ è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Ÿ**
- ç¡®è®¤ç”³è¯·äº†æ­£ç¡®çš„æƒé™èŒƒå›´
- æ£€æŸ¥è®¿é—®ä»¤ç‰Œæ˜¯å¦æœ‰æ•ˆ
- éªŒè¯APIè°ƒç”¨çš„è¯·æ±‚å¤´æ ¼å¼

**â“ ç§»åŠ¨åº”ç”¨æˆæƒå¼‚å¸¸ï¼Ÿ**
- ç¡®ä¿å®æ–½äº†PKCEæ‰©å±•
- æ£€æŸ¥URL Schemeé…ç½®
- éªŒè¯åº”ç”¨ç­¾åå’ŒåŒ…å

### 7.4 å‘å±•è¶‹åŠ¿ä¸å»ºè®®


**ğŸš€ æ–°å…´å®‰å…¨æ ‡å‡†**
```
OAuth2.1ï¼š
â€¢ ç®€åŒ–å’Œæ¾„æ¸…OAuth2è§„èŒƒ
â€¢ å¼ºåˆ¶è¦æ±‚PKCE
â€¢ ç§»é™¤éšå¼æˆæƒæµç¨‹

WebAuthné›†æˆï¼š
â€¢ ç”Ÿç‰©è¯†åˆ«è®¤è¯
â€¢ æ— å¯†ç ç™»å½•ä½“éªŒ
â€¢ æ›´é«˜çš„å®‰å…¨ç­‰çº§
```

**ğŸ’¡ å­¦ä¹ å»ºè®®**
```
åŸºç¡€æŒæ¡ï¼š
â€¢ ç†è§£OAuth2å››ä¸ªè§’è‰²å’ŒåŸºæœ¬æµç¨‹
â€¢ æŒæ¡å¸¸ç”¨çš„æˆæƒç±»å‹
â€¢ ç†Ÿæ‚‰å®‰å…¨æœ€ä½³å®è·µ

è¿›é˜¶å­¦ä¹ ï¼š
â€¢ æ·±å…¥å­¦ä¹ JWTå’ŒOpenID Connect
â€¢ æŒæ¡ä¼ä¸šçº§SSOæ–¹æ¡ˆ
â€¢ äº†è§£é›¶ä¿¡ä»»å®‰å…¨æ¶æ„

å®è·µç»éªŒï¼š
â€¢ é›†æˆä¸»æµç¬¬ä¸‰æ–¹ç™»å½•ï¼ˆå¾®ä¿¡ã€GitHubç­‰ï¼‰
â€¢ å®ç°è‡ªå·±çš„OAuth2æœåŠ¡å™¨
â€¢ å‚ä¸å¼€æºé¡¹ç›®è´¡çŒ®
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
OAuth2æˆæƒä¸è®¤è¯ï¼ŒOpenID ConnectçŸ¥èº«ä»½
HTTPSå¿…ç”¨é˜²çªƒå¬ï¼ŒStateå‚æ•°æŒ¡æ”»å‡»
PKCEç§»åŠ¨è¦å¯ç”¨ï¼Œå›è°ƒåœ°å€è®¾ç™½åå•
ä»¤ç‰Œå®‰å…¨çŸ­æœ‰æ•ˆï¼Œæƒé™æœ€å°æŒ‰éœ€ç»™
ç¬¬ä¸‰æ–¹ç™»å½•æˆè¶‹åŠ¿ï¼Œå®‰å…¨å®æ–½æ˜¯å…³é”®
```