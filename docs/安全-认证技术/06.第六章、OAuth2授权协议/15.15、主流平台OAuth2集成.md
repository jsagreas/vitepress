---
title: 15ã€ä¸»æµå¹³å°OAuth2é›†æˆ
---
## ğŸ“š ç›®å½•

1. [OAuth2å¹³å°é›†æˆæ¦‚è¿°](#1-OAuth2å¹³å°é›†æˆæ¦‚è¿°)
2. [å¾®ä¿¡å¼€æ”¾å¹³å°OAuth2é›†æˆ](#2-å¾®ä¿¡å¼€æ”¾å¹³å°OAuth2é›†æˆ)
3. [QQäº’è”OAuth2é›†æˆ](#3-QQäº’è”OAuth2é›†æˆ)
4. [Google OAuth2é›†æˆ](#4-Google-OAuth2é›†æˆ)
5. [æ”¯ä»˜å®OAuth2é›†æˆ](#5-æ”¯ä»˜å®OAuth2é›†æˆ)
6. [é›†æˆæ­¥éª¤æ ‡å‡†åŒ–æ¨¡æ¿](#6-é›†æˆæ­¥éª¤æ ‡å‡†åŒ–æ¨¡æ¿)
7. [å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ](#7-å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” OAuth2å¹³å°é›†æˆæ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯ç¬¬ä¸‰æ–¹ç™»å½•

**é€šä¿—ç†è§£**ï¼šå°±åƒç”¨èº«ä»½è¯å¯ä»¥åœ¨å¤šä¸ªåœ°æ–¹è¯æ˜èº«ä»½ä¸€æ ·ï¼Œç”¨å¾®ä¿¡è´¦å·å¯ä»¥ç›´æ¥ç™»å½•å…¶ä»–åº”ç”¨ï¼Œä¸éœ€è¦é‡æ–°æ³¨å†Œ

```
ä¼ ç»Ÿæ³¨å†Œç™»å½•ï¼š
ç”¨æˆ· â†’ å¡«å†™è¡¨å• â†’ é‚®ç®±éªŒè¯ â†’ åˆ›å»ºè´¦å· â†’ ç™»å½•

ç¬¬ä¸‰æ–¹ç™»å½•ï¼š
ç”¨æˆ· â†’ ç‚¹å‡»"å¾®ä¿¡ç™»å½•" â†’ å¾®ä¿¡æˆæƒ â†’ è‡ªåŠ¨ç™»å½• âœ¨
```

### 1.2 ä¸ºä»€ä¹ˆè¦é›†æˆç¬¬ä¸‰æ–¹ç™»å½•

**ğŸ¯ å¯¹ç”¨æˆ·çš„å¥½å¤„**ï¼š
- **çœäº‹**ï¼šä¸ç”¨è®°é‚£ä¹ˆå¤šè´¦å·å¯†ç 
- **å¿«é€Ÿ**ï¼šä¸€é”®ç™»å½•ï¼Œå‡ ç§’æå®š
- **å®‰å…¨**ï¼šå¤§å‚çš„å®‰å…¨ä¿éšœ

**ğŸ’¼ å¯¹å¼€å‘è€…çš„å¥½å¤„**ï¼š
- **é™ä½é—¨æ§›**ï¼šç”¨æˆ·æ›´æ„¿æ„å°è¯•ä½ çš„åº”ç”¨
- **è·å–ä¿¡æ¯**ï¼šå¯ä»¥æ‹¿åˆ°ç”¨æˆ·çš„åŸºæœ¬èµ„æ–™ï¼ˆå¤´åƒã€æ˜µç§°ç­‰ï¼‰
- **æé«˜è½¬åŒ–**ï¼šæ³¨å†Œæµç¨‹ç®€åŒ–ï¼Œè½¬åŒ–ç‡æ›´é«˜

### 1.3 ä¸»æµå¹³å°å¯¹æ¯”


| å¹³å° | **é€‚ç”¨åœºæ™¯** | **ç”¨æˆ·é‡** | **é›†æˆéš¾åº¦** | **è·å–ä¿¡æ¯** |
|------|-------------|-----------|-------------|-------------|
| ğŸŸ¢ **å¾®ä¿¡** | `å›½å†…ç§»åŠ¨ç«¯ä¸»æµ` | `12äº¿+` | `â­â­â­` | `å¤´åƒã€æ˜µç§°ã€æ€§åˆ«` |
| ğŸ”µ **QQ** | `PCç«¯ã€æ¸¸æˆåº”ç”¨` | `8äº¿+` | `â­â­` | `å¤´åƒã€æ˜µç§°ã€æ€§åˆ«ã€åœ°åŒº` |
| ğŸ”´ **Google** | `æµ·å¤–åº”ç”¨å¿…å¤‡` | `30äº¿+` | `â­â­` | `é‚®ç®±ã€å¤´åƒã€å§“å` |
| ğŸŸ¡ **æ”¯ä»˜å®** | `æ”¯ä»˜ç›¸å…³åº”ç”¨` | `10äº¿+` | `â­â­â­` | `å¤´åƒã€æ˜µç§°` |

---

## 2. ğŸ’š å¾®ä¿¡å¼€æ”¾å¹³å°OAuth2é›†æˆ


### 2.1 å¾®ä¿¡ç™»å½•çš„å·¥ä½œåŸç†

**ç®€å•ç†è§£**ï¼šå°±åƒæ‰¾å¾®ä¿¡å¸®ä½ è¯æ˜"è¿™ä¸ªäººç¡®å®æ˜¯å¾®ä¿¡ç”¨æˆ·"

```
æˆæƒæµç¨‹ï¼š
ä½ çš„åº”ç”¨ â†’ "å¸®æˆ‘éªŒè¯è¿™ä¸ªç”¨æˆ·" â†’ å¾®ä¿¡
å¾®ä¿¡ â†’ "ç”¨æˆ·ï¼ŒæŸåº”ç”¨æƒ³è·å–ä½ çš„ä¿¡æ¯ï¼ŒåŒæ„å—ï¼Ÿ" â†’ ç”¨æˆ·
ç”¨æˆ· â†’ "åŒæ„" â†’ å¾®ä¿¡  
å¾®ä¿¡ â†’ "è¿™æ˜¯ç”¨æˆ·ä¿¡æ¯å’Œå‡­è¯" â†’ ä½ çš„åº”ç”¨
```

### 2.2 ç½‘ç«™åº”ç”¨æˆæƒï¼ˆPCç«¯ï¼‰


**ğŸ”§ é›†æˆæ­¥éª¤**ï¼š

**æ­¥éª¤1ï¸âƒ£ï¼šç”³è¯·åº”ç”¨**
```
å‰å¾€ï¼šhttps://open.weixin.qq.com/
1. æ³¨å†Œå¼€å‘è€…è´¦å·
2. åˆ›å»ºç½‘ç«™åº”ç”¨
3. è·å– AppID å’Œ AppSecret
4. é…ç½®å›è°ƒåŸŸåï¼ˆé‡è¦ï¼ï¼‰
```

**æ­¥éª¤2ï¸âƒ£ï¼šå¼•å¯¼ç”¨æˆ·æˆæƒ**
```javascript
// æ„é€ å¾®ä¿¡æˆæƒé“¾æ¥
const wxAuthUrl = `https://open.weixin.qq.com/connect/qrconnect?` +
  `appid=${APPID}&` +                    // ä½ çš„åº”ç”¨ID
  `redirect_uri=${encodeURIComponent(REDIRECT_URI)}&` + // å›è°ƒåœ°å€
  `response_type=code&` +               // å›ºå®šå€¼
  `scope=snsapi_login&` +               // æˆæƒèŒƒå›´
  `state=${STATE}`;                     // é˜²CSRFæ”»å‡»

// ç”¨æˆ·ç‚¹å‡»ç™»å½•æ—¶è·³è½¬åˆ°è¿™ä¸ªé“¾æ¥
window.location.href = wxAuthUrl;
```

> ğŸ’¡ **redirect_uri**ï¼šç”¨æˆ·æˆæƒåå¾®ä¿¡ä¼šè·³è½¬å›è¿™ä¸ªåœ°å€ï¼Œå¹¶æºå¸¦æˆæƒç 

**æ­¥éª¤3ï¸âƒ£ï¼šè·å–è®¿é—®ä»¤ç‰Œ**
```javascript
// å¾®ä¿¡å›è°ƒåï¼Œä»URLä¸­è·å–æˆæƒç 
const code = new URLSearchParams(window.location.search).get('code');

// ç”¨æˆæƒç æ¢å–è®¿é—®ä»¤ç‰Œ
const tokenResponse = await fetch('https://api.weixin.qq.com/sns/oauth2/access_token', {
  method: 'GET',
  params: {
    appid: APPID,
    secret: APPSECRET,
    code: code,
    grant_type: 'authorization_code'
  }
});

const tokenData = await tokenResponse.json();
// è¿”å›ï¼šaccess_token, openid, refresh_token ç­‰
```

**æ­¥éª¤4ï¸âƒ£ï¼šè·å–ç”¨æˆ·ä¿¡æ¯**
```javascript
// ç”¨è®¿é—®ä»¤ç‰Œè·å–ç”¨æˆ·ä¿¡æ¯
const userResponse = await fetch('https://api.weixin.qq.com/sns/userinfo', {
  method: 'GET',
  params: {
    access_token: tokenData.access_token,
    openid: tokenData.openid
  }
});

const userInfo = await userResponse.json();
// è¿”å›ï¼šæ˜µç§°ã€å¤´åƒã€æ€§åˆ«ç­‰ä¿¡æ¯
```

### 2.3 ç§»åŠ¨åº”ç”¨æˆæƒï¼ˆæ‰‹æœºç«¯ï¼‰


**æ ¸å¿ƒåŒºåˆ«**ï¼šç§»åŠ¨ç«¯æˆæƒä¼šè°ƒèµ·å¾®ä¿¡Appï¼Œä½“éªŒæ›´æµç•…

```javascript
// ç§»åŠ¨ç«¯æˆæƒé“¾æ¥ï¼ˆä¼šå”¤èµ·å¾®ä¿¡Appï¼‰
const mobileAuthUrl = `https://open.weixin.qq.com/connect/oauth2/authorize?` +
  `appid=${APPID}&` +
  `redirect_uri=${encodeURIComponent(REDIRECT_URI)}&` +
  `response_type=code&` +
  `scope=snsapi_userinfo&` +    // æ³¨æ„ï¼šç§»åŠ¨ç«¯ç”¨snsapi_userinfo
  `state=${STATE}#wechat_redirect`;
```

### 2.4 Scopeæƒé™è¯´æ˜


**ğŸ” æƒé™èŒƒå›´å¯¹æ¯”**ï¼š

```
ğŸ“± snsapi_baseï¼ˆåŸºç¡€æˆæƒï¼‰
è·å–ä¿¡æ¯ï¼šåªèƒ½æ‹¿åˆ° openid
ç‰¹ç‚¹ï¼šç”¨æˆ·æ— æ„ŸçŸ¥ï¼Œä¸å¼¹æˆæƒé¡µé¢
é€‚ç”¨ï¼šåªéœ€è¦æ ‡è¯†ç”¨æˆ·èº«ä»½çš„åœºæ™¯

ğŸ‘¤ snsapi_userinfoï¼ˆç”¨æˆ·ä¿¡æ¯æˆæƒï¼‰  
è·å–ä¿¡æ¯ï¼šæ˜µç§°ã€å¤´åƒã€æ€§åˆ«ã€åœ°åŒºç­‰
ç‰¹ç‚¹ï¼šéœ€è¦ç”¨æˆ·æ‰‹åŠ¨ç¡®è®¤æˆæƒ
é€‚ç”¨ï¼šéœ€è¦å±•ç¤ºç”¨æˆ·ä¿¡æ¯çš„åœºæ™¯
```

> âš ï¸ **æ³¨æ„**ï¼šæƒé™è¶Šå¤§ï¼Œç”¨æˆ·æˆæƒçš„å¿ƒç†é—¨æ§›è¶Šé«˜ï¼Œè¦æŒ‰éœ€ç”³è¯·

---

## 3. ğŸ§ QQäº’è”OAuth2é›†æˆ


### 3.1 QQç™»å½•çš„ç‰¹ç‚¹

**ä¸ºä»€ä¹ˆé€‰æ‹©QQç™»å½•**ï¼š
- **PCç«¯æ™®åŠç‡é«˜**ï¼šç‰¹åˆ«æ˜¯æ¸¸æˆã€ç¤¾äº¤ç±»åº”ç”¨
- **ä¿¡æ¯ä¸°å¯Œ**ï¼šå¯ä»¥è·å–æ¯”è¾ƒè¯¦ç»†çš„ç”¨æˆ·èµ„æ–™
- **æ¥å…¥ç®€å•**ï¼šæ–‡æ¡£æ¸…æ™°ï¼Œæµç¨‹æ ‡å‡†

### 3.2 é›†æˆæ­¥éª¤


**æ­¥éª¤1ï¸âƒ£ï¼šç”³è¯·åº”ç”¨**
```
å‰å¾€ï¼šhttps://connect.qq.com/
1. åˆ›å»ºåº”ç”¨
2. è·å– APP ID å’Œ APP Key
3. è®¾ç½®å›è°ƒåœ°å€
```

**æ­¥éª¤2ï¸âƒ£ï¼šè·å–Authorization Code**
```javascript
const qqAuthUrl = `https://graph.qq.com/oauth2.0/authorize?` +
  `response_type=code&` +
  `client_id=${APP_ID}&` +              // ä½ çš„APP ID
  `redirect_uri=${encodeURIComponent(REDIRECT_URI)}&` +
  `scope=get_user_info&` +              // è·å–ç”¨æˆ·ä¿¡æ¯æƒé™
  `state=${STATE}`;

window.location.href = qqAuthUrl;
```

**æ­¥éª¤3ï¸âƒ£ï¼šè·å–Access Token**
```javascript
const tokenResponse = await fetch(`https://graph.qq.com/oauth2.0/token?` +
  `grant_type=authorization_code&` +
  `client_id=${APP_ID}&` +
  `client_secret=${APP_KEY}&` +
  `code=${code}&` +
  `redirect_uri=${REDIRECT_URI}`
);

// QQè¿”å›çš„æ˜¯URLå‚æ•°æ ¼å¼ï¼Œéœ€è¦è§£æ
const tokenText = await tokenResponse.text();
const accessToken = new URLSearchParams(tokenText).get('access_token');
```

**æ­¥éª¤4ï¸âƒ£ï¼šè·å–OpenID**
```javascript
// QQéœ€è¦å…ˆè·å–OpenIDï¼Œå†è·å–ç”¨æˆ·ä¿¡æ¯
const openIdResponse = await fetch(`https://graph.qq.com/oauth2.0/me?access_token=${accessToken}`);
const openIdText = await openIdResponse.text();

// è§£æJSONPæ ¼å¼è¿”å›çš„OpenID
const openIdMatch = openIdText.match(/openid":"([^"]+)"/);
const openId = openIdMatch[1];
```

**æ­¥éª¤5ï¸âƒ£ï¼šè·å–ç”¨æˆ·ä¿¡æ¯**
```javascript
const userInfoResponse = await fetch(`https://graph.qq.com/user/get_user_info?` +
  `access_token=${accessToken}&` +
  `oauth_consumer_key=${APP_ID}&` +
  `openid=${openId}`
);

const userInfo = await userInfoResponse.json();
// è¿”å›ï¼šæ˜µç§°ã€å¤´åƒã€æ€§åˆ«ã€åœ°åŒºç­‰
```

---

## 4. ğŸŒ Google OAuth2é›†æˆ


### 4.1 Googleç™»å½•çš„ä¼˜åŠ¿

**é€‚ç”¨åœºæ™¯**ï¼š
- **æµ·å¤–ç”¨æˆ·**ï¼šGoogleè´¦å·æ™®åŠç‡æé«˜
- **ä¼ä¸šåº”ç”¨**ï¼šä¸Google Workspaceæ·±åº¦é›†æˆ
- **é‚®ç®±è·å–**ï¼šå¯ä»¥ç›´æ¥è·å–ç”¨æˆ·é‚®ç®±

### 4.2 é›†æˆæ­¥éª¤


**æ­¥éª¤1ï¸âƒ£ï¼šGoogle Consoleé…ç½®**
```
å‰å¾€ï¼šhttps://console.developers.google.com/
1. åˆ›å»ºé¡¹ç›®
2. å¯ç”¨ Google+ API
3. åˆ›å»º OAuth2.0 å®¢æˆ·ç«¯ID
4. é…ç½®æˆæƒé‡å®šå‘URI
```

**æ­¥éª¤2ï¸âƒ£ï¼šå‰ç«¯é›†æˆï¼ˆæ¨èç”¨Google SDKï¼‰**
```html
<!-- å¼•å…¥Googleç™»å½•SDK -->
<script src="https://apis.google.com/js/platform.js"></script>
<meta name="google-signin-client_id" content="YOUR_CLIENT_ID.apps.googleusercontent.com">

<!-- Googleç™»å½•æŒ‰é’® -->
<div class="g-signin2" data-onsuccess="onGoogleSignIn"></div>
```

```javascript
function onGoogleSignIn(googleUser) {
  const profile = googleUser.getBasicProfile();
  const idToken = googleUser.getAuthResponse().id_token;
  
  console.log('ç”¨æˆ·ä¿¡æ¯ï¼š', {
    id: profile.getId(),
    name: profile.getName(),
    email: profile.getEmail(),
    avatar: profile.getImageUrl()
  });
  
  // å‘é€åˆ°åç«¯éªŒè¯
  sendTokenToBackend(idToken);
}
```

**æ­¥éª¤3ï¸âƒ£ï¼šåç«¯éªŒè¯Token**
```javascript
const { OAuth2Client } = require('google-auth-library');
const client = new OAuth2Client(CLIENT_ID);

async function verify(token) {
  const ticket = await client.verifyIdToken({
    idToken: token,
    audience: CLIENT_ID,
  });
  
  const payload = ticket.getPayload();
  return {
    userId: payload['sub'],
    email: payload['email'],
    name: payload['name'],
    avatar: payload['picture']
  };
}
```

---

## 5. ğŸ’™ æ”¯ä»˜å®OAuth2é›†æˆ


### 5.1 æ”¯ä»˜å®ç™»å½•ç‰¹ç‚¹

**é€‚ç”¨åœºæ™¯**ï¼š
- **é‡‘èç±»åº”ç”¨**ï¼šå¤©ç„¶çš„ä¿¡ä»»èƒŒä¹¦
- **å®åè®¤è¯**ï¼šæ”¯ä»˜å®è´¦å·åŸºæœ¬éƒ½æ˜¯å®åçš„
- **æ”¯ä»˜åœºæ™¯**ï¼šä¸æ”¯ä»˜ä¸šåŠ¡ç»“åˆç´§å¯†

### 5.2 é›†æˆæ­¥éª¤


**æ­¥éª¤1ï¸âƒ£ï¼šå¼€æ”¾å¹³å°ç”³è¯·**
```
å‰å¾€ï¼šhttps://open.alipay.com/
1. åˆ›å»ºåº”ç”¨
2. è·å– APPID
3. ç”Ÿæˆåº”ç”¨ç§é’¥å’Œå…¬é’¥
4. ä¸Šä¼ åº”ç”¨å…¬é’¥åˆ°æ”¯ä»˜å®
```

**æ­¥éª¤2ï¸âƒ£ï¼šç”Ÿæˆæˆæƒé“¾æ¥**
```javascript
const alipayAuthUrl = `https://openauth.alipay.com/oauth2/publicAppAuthorize.htm?` +
  `app_id=${APP_ID}&` +
  `scope=auth_user&` +                  // è·å–ç”¨æˆ·ä¿¡æ¯
  `redirect_uri=${encodeURIComponent(REDIRECT_URI)}&` +
  `state=${STATE}`;

window.location.href = alipayAuthUrl;
```

**æ­¥éª¤3ï¸âƒ£ï¼šè·å–Access Token**
```javascript
// æ”¯ä»˜å®éœ€è¦RSAç­¾åï¼Œæ¯”è¾ƒå¤æ‚
const params = {
  method: 'alipay.system.oauth.token',
  app_id: APP_ID,
  charset: 'UTF-8',
  sign_type: 'RSA2',
  timestamp: new Date().toISOString(),
  version: '1.0',
  grant_type: 'authorization_code',
  code: authCode
};

// ç”Ÿæˆç­¾åï¼ˆéœ€è¦RSAç§é’¥ï¼‰
params.sign = generateRSASign(params, privateKey);

const tokenResponse = await fetch('https://openapi.alipay.com/gateway.do', {
  method: 'POST',
  body: new URLSearchParams(params)
});
```

> ğŸ’¡ **æç¤º**ï¼šæ”¯ä»˜å®çš„ç­¾åæœºåˆ¶æ¯”è¾ƒå¤æ‚ï¼Œå»ºè®®ä½¿ç”¨å®˜æ–¹SDK

---

## 6. ğŸ”§ é›†æˆæ­¥éª¤æ ‡å‡†åŒ–æ¨¡æ¿


### 6.1 é€šç”¨é›†æˆæµç¨‹


```
æ ‡å‡†OAuth2é›†æˆäº”æ­¥æ³•ï¼š

æ­¥éª¤1ï¸âƒ£ï¼šå¹³å°ç”³è¯·
â”œâ”€ æ³¨å†Œå¼€å‘è€…è´¦å·
â”œâ”€ åˆ›å»ºåº”ç”¨
â”œâ”€ è·å–å‡­è¯ï¼ˆAppID/AppSecretï¼‰
â””â”€ é…ç½®å›è°ƒåœ°å€

æ­¥éª¤2ï¸âƒ£ï¼šæ„é€ æˆæƒé“¾æ¥
â”œâ”€ æ‹¼æ¥æˆæƒURL
â”œâ”€ è®¾ç½®æƒé™èŒƒå›´ï¼ˆscopeï¼‰
â”œâ”€ é˜²CSRFï¼ˆstateå‚æ•°ï¼‰
â””â”€ è·³è½¬åˆ°ç¬¬ä¸‰æ–¹å¹³å°

æ­¥éª¤3ï¸âƒ£ï¼šå¤„ç†å›è°ƒ
â”œâ”€ è·å–æˆæƒç ï¼ˆcodeï¼‰
â”œâ”€ éªŒè¯stateå‚æ•°
â””â”€ é”™è¯¯å¤„ç†

æ­¥éª¤4ï¸âƒ£ï¼šè·å–è®¿é—®ä»¤ç‰Œ
â”œâ”€ ç”¨æˆæƒç æ¢å–access_token
â”œâ”€ å¤„ç†è¿”å›ç»“æœ
â””â”€ ä¿å­˜tokenå’Œåˆ·æ–°ä»¤ç‰Œ

æ­¥éª¤5ï¸âƒ£ï¼šè·å–ç”¨æˆ·ä¿¡æ¯
â”œâ”€ è°ƒç”¨ç”¨æˆ·ä¿¡æ¯æ¥å£
â”œâ”€ è§£æç”¨æˆ·æ•°æ®
â””â”€ åˆ›å»ºæˆ–æ›´æ–°æœ¬åœ°ç”¨æˆ·
```

### 6.2 å‰ç«¯é€šç”¨ä»£ç æ¨¡æ¿


```javascript
class ThirdPartyLogin {
  constructor(platform, config) {
    this.platform = platform;
    this.config = config;
  }
  
  // ç”Ÿæˆæˆæƒé“¾æ¥
  generateAuthUrl() {
    const baseUrl = this.config.authUrl;
    const params = new URLSearchParams({
      client_id: this.config.clientId,
      redirect_uri: this.config.redirectUri,
      response_type: 'code',
      scope: this.config.scope,
      state: this.generateState()
    });
    
    return `${baseUrl}?${params.toString()}`;
  }
  
  // å¤„ç†å›è°ƒ
  handleCallback() {
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    const state = urlParams.get('state');
    
    if (!code) {
      throw new Error('æˆæƒå¤±è´¥ï¼šæ²¡æœ‰è·å–åˆ°æˆæƒç ');
    }
    
    if (state !== this.getStoredState()) {
      throw new Error('æˆæƒå¤±è´¥ï¼šstateéªŒè¯å¤±è´¥');
    }
    
    return this.exchangeToken(code);
  }
  
  // ç”Ÿæˆé˜²CSRFçš„state
  generateState() {
    const state = Math.random().toString(36).substring(2);
    localStorage.setItem('oauth_state', state);
    return state;
  }
}
```

### 6.3 åç«¯é€šç”¨å¤„ç†æ¨¡æ¿


```javascript
class OAuthHandler {
  async exchangeToken(platform, code) {
    const config = this.getConfig(platform);
    
    const response = await fetch(config.tokenUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        client_id: config.clientId,
        client_secret: config.clientSecret,
        code: code,
        grant_type: 'authorization_code'
      })
    });
    
    const tokenData = await response.json();
    
    if (tokenData.error) {
      throw new Error(`è·å–tokenå¤±è´¥: ${tokenData.error_description}`);
    }
    
    return tokenData.access_token;
  }
  
  async getUserInfo(platform, accessToken) {
    const config = this.getConfig(platform);
    
    const response = await fetch(`${config.userInfoUrl}?access_token=${accessToken}`);
    const userInfo = await response.json();
    
    return this.normalizeUserInfo(platform, userInfo);
  }
  
  // ç»Ÿä¸€ç”¨æˆ·ä¿¡æ¯æ ¼å¼
  normalizeUserInfo(platform, rawData) {
    const mappings = {
      wechat: {
        id: 'openid',
        name: 'nickname',
        avatar: 'headimgurl'
      },
      qq: {
        id: 'openid', 
        name: 'nickname',
        avatar: 'figureurl_qq_1'
      },
      google: {
        id: 'sub',
        name: 'name',
        avatar: 'picture',
        email: 'email'
      }
    };
    
    const mapping = mappings[platform];
    return {
      platform: platform,
      platformUserId: rawData[mapping.id],
      name: rawData[mapping.name],
      avatar: rawData[mapping.avatar],
      email: rawData[mapping.email] || null
    };
  }
}
```

---

## 7. â“ å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ


### 7.1 å›è°ƒåœ°å€ç›¸å…³é—®é¢˜


**ğŸ”¸ é—®é¢˜1ï¼šredirect_uri_mismatch**
```
é”™è¯¯ä¿¡æ¯ï¼šå›è°ƒåœ°å€ä¸åŒ¹é…
åŸå› ï¼šé…ç½®çš„å›è°ƒåœ°å€å’Œå®é™…ä¸ä¸€è‡´

è§£å†³æ–¹æ¡ˆï¼š
âœ… ç¡®ä¿å›è°ƒåœ°å€å®Œå…¨ä¸€è‡´ï¼ˆåŒ…æ‹¬åè®®ã€åŸŸåã€ç«¯å£ã€è·¯å¾„ï¼‰
âœ… å¼€å‘ç¯å¢ƒå¯ä»¥ç”¨ localhostï¼Œç”Ÿäº§ç¯å¢ƒè¦ç”¨å®é™…åŸŸå
âœ… å›è°ƒåœ°å€è¦è¿›è¡ŒURLç¼–ç 
```

**ğŸ”¸ é—®é¢˜2ï¼šæœ¬åœ°å¼€å‘å›è°ƒé—®é¢˜**
```
é—®é¢˜ï¼šæœ¬åœ°å¼€å‘æ—¶æ— æ³•å›è°ƒåˆ° localhost

è§£å†³æ–¹æ¡ˆï¼š
1ï¸âƒ£ ä½¿ç”¨å†…ç½‘ç©¿é€å·¥å…·ï¼ˆå¦‚ ngrokï¼‰
2ï¸âƒ£ ä¿®æ”¹æœ¬åœ°hostsæ–‡ä»¶ï¼Œæ˜ å°„åŸŸååˆ°æœ¬åœ°
3ï¸âƒ£ éƒ¨åˆ†å¹³å°æ”¯æŒ localhost å›è°ƒï¼ˆå¦‚Googleï¼‰
```

### 7.2 Tokenç›¸å…³é—®é¢˜


**ğŸ”¸ é—®é¢˜3ï¼šaccess_tokenè¿‡æœŸ**
```javascript
// å¤„ç†tokenè¿‡æœŸ
async function callApiWithTokenRefresh(apiCall) {
  try {
    return await apiCall();
  } catch (error) {
    if (error.code === 'TOKEN_EXPIRED') {
      // ä½¿ç”¨refresh_tokenåˆ·æ–°
      await refreshAccessToken();
      return await apiCall(); // é‡è¯•
    }
    throw error;
  }
}
```

**ğŸ”¸ é—®é¢˜4ï¼šè·¨åŸŸé—®é¢˜**
```javascript
// åç«¯éœ€è¦è®¾ç½®CORS
app.use((req, res, next) => {
  res.header('Access-Control-Allow-Origin', 'https://yourdomain.com');
  res.header('Access-Control-Allow-Credentials', 'true');
  next();
});
```

### 7.3 ç”¨æˆ·ä½“éªŒé—®é¢˜


**ğŸ”¸ é—®é¢˜5ï¼šæˆæƒé¡µé¢ä½“éªŒå·®**
```
ä¼˜åŒ–æ–¹æ¡ˆï¼š
âœ… ä½¿ç”¨å¼¹çª—è€Œä¸æ˜¯é¡µé¢è·³è½¬
âœ… æ·»åŠ åŠ è½½çŠ¶æ€æç¤º
âœ… æä¾›å–æ¶ˆç™»å½•çš„é€‰é¡¹
âœ… å¤±è´¥åç»™å‡ºæ˜ç¡®çš„é”™è¯¯æç¤º
```

```javascript
// å¼¹çª—æ–¹å¼æˆæƒ
function loginWithPopup(authUrl) {
  const popup = window.open(
    authUrl,
    'oauth_login',
    'width=500,height=600,scrollbars=yes'
  );
  
  // ç›‘å¬å¼¹çª—å…³é—­
  const checkClosed = setInterval(() => {
    if (popup.closed) {
      clearInterval(checkClosed);
      // æ£€æŸ¥ç™»å½•ç»“æœ
      checkLoginResult();
    }
  }, 1000);
}
```

### 7.4 å®‰å…¨ç›¸å…³é—®é¢˜


**ğŸ”¸ é—®é¢˜6ï¼šCSRFæ”»å‡»é˜²æŠ¤**
```javascript
// ç”Ÿæˆå¹¶éªŒè¯stateå‚æ•°
const state = crypto.randomBytes(32).toString('hex');
sessionStorage.setItem('oauth_state', state);

// å›è°ƒæ—¶éªŒè¯
const returnedState = urlParams.get('state');
if (returnedState !== sessionStorage.getItem('oauth_state')) {
  throw new Error('å¯èƒ½é­å—CSRFæ”»å‡»');
}
```

**ğŸ”¸ é—®é¢˜7ï¼šå¯†é’¥å®‰å…¨**
```
å®‰å…¨åŸåˆ™ï¼š
âŒ ä¸è¦åœ¨å‰ç«¯æš´éœ² client_secret
âœ… æ•æ„Ÿæ“ä½œéƒ½åœ¨åç«¯å®Œæˆ  
âœ… ä½¿ç”¨ç¯å¢ƒå˜é‡å­˜å‚¨å¯†é’¥
âœ… å®šæœŸæ›´æ¢å¯†é’¥
```

### 7.5 è°ƒè¯•æŠ€å·§


**ğŸ”§ è°ƒè¯•å·¥å…·ç®±**ï¼š
```javascript
// å¼€å‘æ¨¡å¼è°ƒè¯•ä¿¡æ¯
if (process.env.NODE_ENV === 'development') {
  console.log('æˆæƒURL:', authUrl);
  console.log('å›è°ƒå‚æ•°:', urlParams.toString());
  console.log('ç”¨æˆ·ä¿¡æ¯:', userInfo);
}

// ç½‘ç»œè¯·æ±‚ç›‘æ§
const originalFetch = window.fetch;
window.fetch = function(...args) {
  console.log('è¯·æ±‚:', args);
  return originalFetch.apply(this, arguments)
    .then(response => {
      console.log('å“åº”:', response);
      return response;
    });
};
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ OAuth2æµç¨‹ï¼šæˆæƒç æ¨¡å¼æ˜¯ä¸»æµï¼Œå®‰å…¨æ€§æœ€é«˜
ğŸ”¸ å¹³å°å·®å¼‚ï¼šæ¯ä¸ªå¹³å°çš„æ¥å£ç»†èŠ‚ä¸åŒï¼Œä½†æµç¨‹ç±»ä¼¼
ğŸ”¸ æƒé™æ§åˆ¶ï¼šæŒ‰éœ€ç”³è¯·æƒé™ï¼Œå¹³è¡¡ç”¨æˆ·ä½“éªŒå’ŒåŠŸèƒ½éœ€æ±‚
ğŸ”¸ å®‰å…¨æªæ–½ï¼šstateé˜²CSRFã€HTTPSä¼ è¾“ã€åç«¯éªŒè¯
ğŸ”¸ ç”¨æˆ·ä½“éªŒï¼šå¼¹çª—æˆæƒã€é”™è¯¯æç¤ºã€åŠ è½½çŠ¶æ€
```

### 8.2 å¹³å°é€‰æ‹©æŒ‡å—


**ğŸ¯ é€‰æ‹©ä¾æ®**ï¼š
```
å›½å†…ç§»åŠ¨åº”ç”¨ â†’ å¾®ä¿¡ç™»å½•ï¼ˆç”¨æˆ·é‡æœ€å¤§ï¼‰
PCç«¯ç¤¾äº¤åº”ç”¨ â†’ QQç™»å½•ï¼ˆè€ç”¨æˆ·å¤šï¼‰
æµ·å¤–åº”ç”¨ â†’ Googleç™»å½•ï¼ˆå¿…å¤‡ï¼‰
é‡‘èæ”¯ä»˜åº”ç”¨ â†’ æ”¯ä»˜å®ç™»å½•ï¼ˆä¿¡ä»»åº¦é«˜ï¼‰
ä¼ä¸šçº§åº”ç”¨ â†’ å¤šå¹³å°æ”¯æŒ
```

### 8.3 é›†æˆæœ€ä½³å®è·µ


**âœ¨ å¼€å‘å»ºè®®**ï¼š
```
è§„åˆ’é˜¶æ®µï¼š
âœ… åˆ†æç›®æ ‡ç”¨æˆ·ç¾¤ä½“
âœ… é€‰æ‹©åˆé€‚çš„ç™»å½•å¹³å°
âœ… è®¾è®¡ç»Ÿä¸€çš„ç”¨æˆ·ä½“ç³»

å¼€å‘é˜¶æ®µï¼š  
âœ… ä½¿ç”¨æ ‡å‡†åŒ–æ¨¡æ¿
âœ… åšå¥½é”™è¯¯å¤„ç†
âœ… æ³¨æ„å®‰å…¨é˜²æŠ¤

æµ‹è¯•é˜¶æ®µï¼š
âœ… æµ‹è¯•å„ç§å¼‚å¸¸æƒ…å†µ
âœ… éªŒè¯è·¨æµè§ˆå™¨å…¼å®¹æ€§
âœ… æ£€æŸ¥ç§»åŠ¨ç«¯ä½“éªŒ

ä¸Šçº¿é˜¶æ®µï¼š
âœ… é…ç½®ç”Ÿäº§ç¯å¢ƒå›è°ƒåœ°å€
âœ… ç›‘æ§ç™»å½•æˆåŠŸç‡
âœ… æ”¶é›†ç”¨æˆ·åé¦ˆ
```

### 8.4 æ’æŸ¥é—®é¢˜çš„æ–¹æ³•


```
ğŸ” é—®é¢˜æ’æŸ¥æ­¥éª¤ï¼š

1ï¸âƒ£ æ£€æŸ¥é…ç½®
â”œâ”€ AppID/AppSecretæ˜¯å¦æ­£ç¡®
â”œâ”€ å›è°ƒåœ°å€æ˜¯å¦åŒ¹é…
â””â”€ æƒé™scopeæ˜¯å¦è¶³å¤Ÿ

2ï¸âƒ£ æŸ¥çœ‹ç½‘ç»œè¯·æ±‚
â”œâ”€ æˆæƒè¯·æ±‚æ˜¯å¦æ­£å¸¸å‘é€
â”œâ”€ å›è°ƒæ˜¯å¦æ”¶åˆ°code
â””â”€ tokenäº¤æ¢æ˜¯å¦æˆåŠŸ

3ï¸âƒ£ éªŒè¯æ•°æ®æ ¼å¼
â”œâ”€ å‚æ•°æ˜¯å¦æ­£ç¡®ç¼–ç 
â”œâ”€ ç­¾åæ˜¯å¦æ­£ç¡®ï¼ˆæ”¯ä»˜å®ï¼‰
â””â”€ è¿”å›æ•°æ®æ˜¯å¦ç¬¦åˆé¢„æœŸ

4ï¸âƒ£ æ£€æŸ¥ç¯å¢ƒå› ç´ 
â”œâ”€ ç½‘ç»œæ˜¯å¦æ­£å¸¸
â”œâ”€ åŸŸåæ˜¯å¦å¯è®¿é—®
â””â”€ SSLè¯ä¹¦æ˜¯å¦æœ‰æ•ˆ
```

**ğŸ§  è®°å¿†è¦ç‚¹**ï¼š
- OAuth2æ˜¯æˆæƒåè®®ï¼Œä¸æ˜¯è®¤è¯åè®®
- æˆæƒç æ¨¡å¼æœ€å®‰å…¨ï¼Œé€‚åˆWebåº”ç”¨
- æ¯ä¸ªå¹³å°éƒ½æœ‰ç»†èŠ‚å·®å¼‚ï¼Œä½†æ ¸å¿ƒæµç¨‹ç›¸åŒ
- å®‰å…¨ç¬¬ä¸€ï¼šstateé˜²CSRFï¼Œåç«¯éªŒè¯token
- ç”¨æˆ·ä½“éªŒå¾ˆé‡è¦ï¼šå¼¹çª— > è·³è½¬ï¼Œé”™è¯¯æç¤ºè¦å‹å¥½