---
title: 10ã€OAuth2æ ¸å¿ƒç«¯ç‚¹ä¸å‚æ•°
---
## ğŸ“š ç›®å½•

1. [OAuth2ç«¯ç‚¹æ¦‚è¿°](#1-OAuth2ç«¯ç‚¹æ¦‚è¿°)
2. [æˆæƒç«¯ç‚¹è¯¦è§£](#2-æˆæƒç«¯ç‚¹è¯¦è§£)
3. [ä»¤ç‰Œç«¯ç‚¹è¯¦è§£](#3-ä»¤ç‰Œç«¯ç‚¹è¯¦è§£)
4. [é‡å®šå‘URIè§„èŒƒ](#4-é‡å®šå‘URIè§„èŒƒ)
5. [æ ¸å¿ƒå‚æ•°è¯¦ç»†è¯´æ˜](#5-æ ¸å¿ƒå‚æ•°è¯¦ç»†è¯´æ˜)
6. [stateå‚æ•°é˜²CSRFåŸç†](#6-stateå‚æ•°é˜²CSRFåŸç†)
7. [å®é™…åº”ç”¨ç¤ºä¾‹](#7-å®é™…åº”ç”¨ç¤ºä¾‹)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ OAuth2ç«¯ç‚¹æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯OAuth2ç«¯ç‚¹

**ç®€å•ç†è§£**ï¼šç«¯ç‚¹å°±æ˜¯OAuth2æµç¨‹ä¸­çš„**ç‰¹å®šç½‘å€**ï¼Œå°±åƒé“¶è¡Œçš„ä¸åŒçª—å£ä¸€æ ·ï¼Œæ¯ä¸ªçª—å£åŠç†ä¸åŒçš„ä¸šåŠ¡ã€‚

```
é“¶è¡Œç±»æ¯”ï¼š
æŸœå°1ï¼ˆæˆæƒç«¯ç‚¹ï¼‰ï¼šç”¨æˆ·ç”³è¯·ä¸šåŠ¡æˆæƒ
æŸœå°2ï¼ˆä»¤ç‰Œç«¯ç‚¹ï¼‰ï¼šç³»ç»Ÿé—´äº¤æ¢å‡­è¯
```

**ğŸ”¸ æ ¸å¿ƒç«¯ç‚¹**
```
OAuth2æœ‰ä¸¤ä¸ªå…³é”®ç«¯ç‚¹ï¼š
âœ… æˆæƒç«¯ç‚¹ï¼šç”¨æˆ·åŒæ„æˆæƒçš„åœ°æ–¹
âœ… ä»¤ç‰Œç«¯ç‚¹ï¼šåº”ç”¨è·å–è®¿é—®ä»¤ç‰Œçš„åœ°æ–¹
```

### 1.2 ç«¯ç‚¹çš„ä½œç”¨å’Œå…³ç³»


**ğŸ“Š ç«¯ç‚¹äº¤äº’æµç¨‹**
```
ç”¨æˆ·æµè§ˆå™¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ æˆæƒç«¯ç‚¹
     â†“                        â†“
   ç”¨æˆ·æˆæƒ                  ç”Ÿæˆæˆæƒç 
     â†“                        â†“
åº”ç”¨åç«¯ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ é‡å®šå‘å›æ¥
     â†“
åº”ç”¨åç«¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ ä»¤ç‰Œç«¯ç‚¹
     â†“                        â†“
   æäº¤æˆæƒç                 è¿”å›è®¿é—®ä»¤ç‰Œ
```

**ğŸ’¡ é€šä¿—è§£é‡Š**
- **æˆæƒç«¯ç‚¹**ï¼šç”¨æˆ·è¯´"æˆ‘åŒæ„"çš„åœ°æ–¹
- **ä»¤ç‰Œç«¯ç‚¹**ï¼šåº”ç”¨è·å¾—"é€šè¡Œè¯"çš„åœ°æ–¹
- **é‡å®šå‘URI**ï¼šç”¨æˆ·æˆæƒå"å›å®¶"çš„è·¯å¾„

---

## 2. ğŸ¯ æˆæƒç«¯ç‚¹è¯¦è§£


### 2.1 æˆæƒç«¯ç‚¹çš„æœ¬è´¨å«ä¹‰


**ğŸ”¸ å®šä¹‰è¯´æ˜**
```
æˆæƒç«¯ç‚¹ï¼ˆAuthorization Endpointï¼‰ï¼š
å°±æ˜¯ç”¨æˆ·è¿›è¡Œæˆæƒæ“ä½œçš„ç½‘é¡µåœ°å€

é€šä¿—ç†è§£ï¼š
ç”¨æˆ·ç‚¹å‡»"å¾®ä¿¡ç™»å½•"åè·³è½¬çš„å¾®ä¿¡æˆæƒé¡µé¢ç½‘å€
```

### 2.2 æˆæƒç«¯ç‚¹çš„å·¥ä½œè¿‡ç¨‹


**ğŸ“‹ è¯¦ç»†æµç¨‹**
```
ç¬¬1æ­¥ï¼šåº”ç”¨æ„é€ æˆæƒé“¾æ¥
https://auth.example.com/oauth/authorize?
  client_id=123456&
  response_type=code&
  redirect_uri=https://myapp.com/callback&
  scope=read_profile&
  state=random123

ç¬¬2æ­¥ï¼šç”¨æˆ·ç‚¹å‡»é“¾æ¥è·³è½¬åˆ°æˆæƒé¡µé¢
ç¬¬3æ­¥ï¼šç”¨æˆ·åœ¨æˆæƒé¡µé¢ç‚¹å‡»"åŒæ„"
ç¬¬4æ­¥ï¼šæˆæƒæœåŠ¡å™¨é‡å®šå‘å›åº”ç”¨
https://myapp.com/callback?
  code=AUTH_CODE_HERE&
  state=random123
```

### 2.3 æˆæƒç«¯ç‚¹çš„å…³é”®ç‰¹å¾


**ğŸ”‘ æ ¸å¿ƒç‰¹ç‚¹**
- âœ… **ç”¨æˆ·å¯è§**ï¼šç”¨æˆ·èƒ½ç›´æ¥çœ‹åˆ°å’Œæ“ä½œçš„é¡µé¢
- âœ… **æµè§ˆå™¨è®¿é—®**ï¼šé€šè¿‡æµè§ˆå™¨åœ°å€æ è®¿é—®
- âœ… **GETè¯·æ±‚**ï¼šä½¿ç”¨URLå‚æ•°ä¼ é€’ä¿¡æ¯
- âœ… **è¿”å›æˆæƒç **ï¼šæˆåŠŸåè¿”å›ä¸´æ—¶çš„æˆæƒç 

**âš ï¸ å®‰å…¨è€ƒè™‘**
```
æˆæƒç«¯ç‚¹å®‰å…¨è¦ç‚¹ï¼š
ğŸ”’ å¿…é¡»ä½¿ç”¨HTTPSåè®®
ğŸ”’ éªŒè¯redirect_uriçš„åˆæ³•æ€§
ğŸ”’ æ£€æŸ¥client_idçš„æœ‰æ•ˆæ€§
ğŸ”’ éªŒè¯stateå‚æ•°é˜²æ­¢CSRFæ”»å‡»
```

---

## 3. ğŸ” ä»¤ç‰Œç«¯ç‚¹è¯¦è§£


### 3.1 ä»¤ç‰Œç«¯ç‚¹çš„æœ¬è´¨å«ä¹‰


**ğŸ”¸ å®šä¹‰è¯´æ˜**
```
ä»¤ç‰Œç«¯ç‚¹ï¼ˆToken Endpointï¼‰ï¼š
åº”ç”¨ç¨‹åºç”¨æˆæƒç æ¢å–è®¿é—®ä»¤ç‰Œçš„æ¥å£åœ°å€

é€šä¿—ç†è§£ï¼š
å°±åƒç”¨"å…‘æ¢åˆ¸"å»å…‘æ¢"æ­£å¼é—¨ç¥¨"çš„çª—å£
```

### 3.2 ä»¤ç‰Œç«¯ç‚¹çš„å·¥ä½œè¿‡ç¨‹


**ğŸ“‹ è¯¦ç»†æµç¨‹**
```
åº”ç”¨åç«¯å‘ä»¤ç‰Œç«¯ç‚¹å‘é€POSTè¯·æ±‚ï¼š

POST https://auth.example.com/oauth/token
Content-Type: application/x-www-form-urlencoded

grant_type=authorization_code&
code=åˆšæ‰æ”¶åˆ°çš„æˆæƒç &
redirect_uri=https://myapp.com/callback&
client_id=123456&
client_secret=åº”ç”¨å¯†é’¥
```

**ğŸ“¨ è¿”å›å“åº”**
```json
{
  "access_token": "è®¿é—®ä»¤ç‰Œ",
  "token_type": "Bearer",
  "expires_in": 3600,
  "refresh_token": "åˆ·æ–°ä»¤ç‰Œ",
  "scope": "read_profile"
}
```

### 3.3 ä»¤ç‰Œç«¯ç‚¹çš„å…³é”®ç‰¹å¾


**ğŸ”‘ æ ¸å¿ƒç‰¹ç‚¹**
- âœ… **æœåŠ¡ç«¯è®¿é—®**ï¼šåªæœ‰åº”ç”¨åç«¯èƒ½è®¿é—®
- âœ… **POSTè¯·æ±‚**ï¼šé€šè¿‡è¯·æ±‚ä½“ä¼ é€’æ•æ„Ÿä¿¡æ¯
- âœ… **éœ€è¦è®¤è¯**ï¼šå¿…é¡»æä¾›client_secret
- âœ… **è¿”å›ä»¤ç‰Œ**ï¼šè¿”å›çœŸæ­£çš„è®¿é—®ä»¤ç‰Œ

**ğŸ”’ å®‰å…¨æœºåˆ¶**
```
ä»¤ç‰Œç«¯ç‚¹å®‰å…¨ç‰¹ç‚¹ï¼š
ğŸ›¡ï¸ éœ€è¦å®¢æˆ·ç«¯è®¤è¯ï¼ˆclient_secretï¼‰
ğŸ›¡ï¸ ä½¿ç”¨POSTè¯·æ±‚ï¼ˆå‚æ•°ä¸æš´éœ²åœ¨URLä¸­ï¼‰
ğŸ›¡ï¸ åªæ¥å—æœåŠ¡ç«¯è¯·æ±‚ï¼ˆä¸ç»è¿‡æµè§ˆå™¨ï¼‰
ğŸ›¡ï¸ éªŒè¯æˆæƒç çš„æœ‰æ•ˆæ€§å’Œæ—¶æ•ˆæ€§
```

---

## 4. ğŸ”„ é‡å®šå‘URIè§„èŒƒ


### 4.1 é‡å®šå‘URIçš„å«ä¹‰


**ğŸ”¸ å®šä¹‰è¯´æ˜**
```
é‡å®šå‘URIï¼ˆredirect_uriï¼‰ï¼š
ç”¨æˆ·æˆæƒå®Œæˆåï¼ŒæˆæƒæœåŠ¡å™¨å°†ç”¨æˆ·"é€å›"çš„ç›®æ ‡åœ°å€

ç”Ÿæ´»ç±»æ¯”ï¼š
å°±åƒä½ å»é“¶è¡ŒåŠäº‹ï¼ŒåŠå®Œåå·¥ä½œäººå‘˜è¯´"è¯·åˆ°3å·çª—å£"
è¿™ä¸ª"3å·çª—å£"å°±æ˜¯redirect_uri
```

### 4.2 é‡å®šå‘URIçš„ä½œç”¨è¿‡ç¨‹


**ğŸ“Š å·¥ä½œæµç¨‹å›¾**
```
ç”¨æˆ· â”€â”€â”€â”€â”
         â”‚
         â†“
    æˆæƒæœåŠ¡å™¨ â”€â”€â”€â”€â†’ ç”¨æˆ·æˆæƒ
         â”‚
         â†“
   æ„é€ é‡å®šå‘URL
         â”‚
         â†“
    ç”¨æˆ·æµè§ˆå™¨ â”€â”€â”€â”€â†’ è·³è½¬åˆ°åº”ç”¨
         â”‚
         â†“
      åº”ç”¨æ¥æ”¶ â”€â”€â”€â”€â†’ å¤„ç†æˆæƒç 
```

**ğŸ’¡ å…·ä½“ç¤ºä¾‹**
```
æ³¨å†Œæ—¶å¡«å†™ï¼šhttps://myapp.com/oauth/callback
å®é™…é‡å®šå‘ï¼šhttps://myapp.com/oauth/callback?code=AUTH123&state=xyz
```

### 4.3 é‡å®šå‘URIçš„å®‰å…¨è§„èŒƒ


**ğŸ”’ å®‰å…¨è¦æ±‚**
```
âœ… å¿…é¡»å®Œå…¨åŒ¹é…ï¼šåè®®ã€åŸŸåã€ç«¯å£ã€è·¯å¾„éƒ½è¦ä¸€è‡´
âœ… å¿…é¡»ä½¿ç”¨HTTPSï¼šä¿æŠ¤æˆæƒç ä¼ è¾“å®‰å…¨
âœ… ä¸èƒ½ä½¿ç”¨é€šé…ç¬¦ï¼šå¦‚ *.example.com æ˜¯ä¸è¢«å…è®¸çš„
âœ… å»ºè®®ä½¿ç”¨å›ºå®šè·¯å¾„ï¼šé¿å…åŠ¨æ€ç”Ÿæˆçš„URL
```

**âš ï¸ å¸¸è§é”™è¯¯**
```
âŒ é”™è¯¯ç¤ºä¾‹ï¼š
æ³¨å†Œï¼šhttps://myapp.com/callback
ä½¿ç”¨ï¼šhttp://myapp.com/callback   ï¼ˆåè®®ä¸åŒ¹é…ï¼‰
ä½¿ç”¨ï¼šhttps://myapp.com/callback/ ï¼ˆè·¯å¾„ä¸åŒ¹é…ï¼‰
ä½¿ç”¨ï¼šhttps://sub.myapp.com/callback ï¼ˆåŸŸåä¸åŒ¹é…ï¼‰

âœ… æ­£ç¡®åšæ³•ï¼š
å®Œå…¨ä¸€è‡´çš„URLä½¿ç”¨
```

---

## 5. ğŸ“ æ ¸å¿ƒå‚æ•°è¯¦ç»†è¯´æ˜


### 5.1 å®¢æˆ·ç«¯æ ‡è¯†å‚æ•°


#### ğŸ”¸ client_idï¼ˆå®¢æˆ·ç«¯IDï¼‰

```
å«ä¹‰ï¼šåº”ç”¨åœ¨æˆæƒæœåŠ¡å™¨ä¸Šçš„å”¯ä¸€æ ‡è¯†ç¬¦
æ€§è´¨ï¼šå…¬å¼€ä¿¡æ¯ï¼Œå¯ä»¥æš´éœ²ç»™ç”¨æˆ·
ä½œç”¨ï¼šå‘Šè¯‰æˆæƒæœåŠ¡å™¨æ˜¯å“ªä¸ªåº”ç”¨åœ¨è¯·æ±‚æˆæƒ

ç±»æ¯”ç†è§£ï¼š
å°±åƒä½ çš„å­¦å·ï¼Œæ˜¯å…¬å¼€çš„èº«ä»½æ ‡è¯†
```

**ğŸ“‹ ä½¿ç”¨ç¤ºä¾‹**
```
æˆæƒé“¾æ¥ä¸­ï¼š
https://auth.example.com/oauth/authorize?client_id=123456...

ä»¤ç‰Œè¯·æ±‚ä¸­ï¼š
POST data: client_id=123456&client_secret=...
```

#### ğŸ”¸ client_secretï¼ˆå®¢æˆ·ç«¯å¯†é’¥ï¼‰

```
å«ä¹‰ï¼šåº”ç”¨çš„ç§å¯†å‡­è¯ï¼Œè¯æ˜åº”ç”¨èº«ä»½
æ€§è´¨ï¼šç»å¯¹ä¿å¯†ï¼Œåªèƒ½åœ¨æœåŠ¡ç«¯ä½¿ç”¨
ä½œç”¨ï¼šåœ¨ä»¤ç‰Œç«¯ç‚¹éªŒè¯åº”ç”¨çš„çœŸå®èº«ä»½

ç±»æ¯”ç†è§£ï¼š
å°±åƒä½ çš„é“¶è¡Œå¡å¯†ç ï¼Œç»ä¸èƒ½ç»™åˆ«äººçŸ¥é“
```

**ğŸ”’ å®‰å…¨ä½¿ç”¨**
```
âœ… æ­£ç¡®åšæ³•ï¼š
- åªåœ¨æœåŠ¡ç«¯å­˜å‚¨å’Œä½¿ç”¨
- ä¸èƒ½å†™åœ¨å‰ç«¯ä»£ç ä¸­
- ä¸èƒ½é€šè¿‡URLä¼ é€’
- å®šæœŸè½®æ¢å¯†é’¥

âŒ å±é™©åšæ³•ï¼š
- å†™åœ¨JavaScriptä»£ç ä¸­
- å­˜å‚¨åœ¨ç§»åŠ¨åº”ç”¨ä¸­
- é€šè¿‡æ—¥å¿—è®°å½•
```

### 5.2 å“åº”ç±»å‹å‚æ•°


#### ğŸ”¸ response_typeï¼ˆå“åº”ç±»å‹ï¼‰

```
å«ä¹‰ï¼šå‘Šè¯‰æˆæƒæœåŠ¡å™¨æˆ‘ä»¬æƒ³è¦ä»€ä¹ˆç±»å‹çš„å“åº”
å¸¸ç”¨å€¼ï¼š
- codeï¼šè¦æˆæƒç ï¼ˆæœ€å®‰å…¨ï¼Œæ¨èï¼‰
- tokenï¼šç›´æ¥è¦è®¿é—®ä»¤ç‰Œï¼ˆä¸å®‰å…¨ï¼‰
- id_tokenï¼šè¦èº«ä»½ä»¤ç‰Œï¼ˆOpenID Connectï¼‰
```

**ğŸ’¡ ç±»å‹å¯¹æ¯”**
```
response_type=codeï¼š
æµç¨‹ï¼šæˆæƒç  â†’ æ¢å–ä»¤ç‰Œ
å®‰å…¨æ€§ï¼šé«˜ï¼ˆä»¤ç‰Œä¸ç»è¿‡æµè§ˆå™¨ï¼‰
é€‚ç”¨ï¼šWebåº”ç”¨ã€ç§»åŠ¨åº”ç”¨

response_type=tokenï¼š
æµç¨‹ï¼šç›´æ¥è¿”å›ä»¤ç‰Œ
å®‰å…¨æ€§ï¼šä½ï¼ˆä»¤ç‰Œæš´éœ²åœ¨URLä¸­ï¼‰
é€‚ç”¨ï¼šçº¯å‰ç«¯åº”ç”¨ï¼ˆä¸æ¨èï¼‰
```

#### ğŸ”¸ grant_typeï¼ˆæˆæƒç±»å‹ï¼‰

```
å«ä¹‰ï¼šå‘Šè¯‰ä»¤ç‰Œç«¯ç‚¹ä½¿ç”¨å“ªç§æ–¹å¼è·å–ä»¤ç‰Œ
å¸¸ç”¨å€¼ï¼š
- authorization_codeï¼šç”¨æˆæƒç æ¢ä»¤ç‰Œ
- refresh_tokenï¼šç”¨åˆ·æ–°ä»¤ç‰Œæ¢æ–°ä»¤ç‰Œ
- client_credentialsï¼šå®¢æˆ·ç«¯å‡­è¯æ¨¡å¼
- passwordï¼šå¯†ç æ¨¡å¼ï¼ˆä¸æ¨èï¼‰
```

### 5.3 èŒƒå›´å’ŒçŠ¶æ€å‚æ•°


#### ğŸ”¸ scopeï¼ˆæƒé™èŒƒå›´ï¼‰

```
å«ä¹‰ï¼šåº”ç”¨è¯·æ±‚çš„æƒé™èŒƒå›´ï¼Œå‘Šè¯‰ç”¨æˆ·"æˆ‘æƒ³è®¿é—®ä½ çš„ä»€ä¹ˆä¿¡æ¯"
æ ¼å¼ï¼šç”¨ç©ºæ ¼åˆ†éš”çš„æƒé™åˆ—è¡¨
ç¤ºä¾‹ï¼šread_profile write_posts read_friends

é€šä¿—ç†è§£ï¼š
å°±åƒä½ ä¸‹è½½APPæ—¶çœ‹åˆ°çš„æƒé™ç”³è¯·
"æ­¤åº”ç”¨æƒ³è¦è®¿é—®æ‚¨çš„ï¼šç›¸å†Œã€é€šè®¯å½•ã€ä½ç½®ä¿¡æ¯"
```

**ğŸ“‹ å¸¸è§èŒƒå›´ç¤ºä¾‹**
```
ç¤¾äº¤åº”ç”¨å¸¸è§scopeï¼š
- read_profileï¼šè¯»å–åŸºæœ¬èµ„æ–™
- read_friendsï¼šè¯»å–å¥½å‹åˆ—è¡¨
- write_postsï¼šå‘å¸ƒåŠ¨æ€
- read_messagesï¼šè¯»å–ç§ä¿¡

ä¼ä¸šåº”ç”¨å¸¸è§scopeï¼š
- user:readï¼šè¯»å–ç”¨æˆ·ä¿¡æ¯
- repo:writeï¼šä¿®æ”¹ä»£ç ä»“åº“
- adminï¼šç®¡ç†å‘˜æƒé™
```

#### ğŸ”¸ stateï¼ˆçŠ¶æ€å‚æ•°ï¼‰

```
å«ä¹‰ï¼šé˜²æ­¢CSRFæ”»å‡»çš„å®‰å…¨å‚æ•°
ç‰¹ç‚¹ï¼šåº”ç”¨ç”Ÿæˆçš„éšæœºå­—ç¬¦ä¸²ï¼ŒæˆæƒæœåŠ¡å™¨åŸæ ·è¿”å›
ä½œç”¨ï¼šéªŒè¯æˆæƒå“åº”çš„åˆæ³•æ€§

ç±»æ¯”ç†è§£ï¼š
å°±åƒé“¶è¡Œå–å·ï¼Œä½ æ‹¿ç€å·ç ç‰Œï¼ŒåŠå®Œäº‹åæ ¸å¯¹å·ç ç¡®è®¤æ˜¯ä½ æœ¬äººçš„ä¸šåŠ¡
```

---

## 6. ğŸ›¡ï¸ stateå‚æ•°é˜²CSRFåŸç†


### 6.1 CSRFæ”»å‡»æ˜¯ä»€ä¹ˆ


**ğŸ”¸ æ”»å‡»åœºæ™¯è¯´æ˜**
```
CSRFï¼ˆè·¨ç«™è¯·æ±‚ä¼ªé€ ï¼‰æ”»å‡»è¿‡ç¨‹ï¼š

1. ç”¨æˆ·å·²ç™»å½•ç½‘ç«™A
2. ç”¨æˆ·è®¿é—®æ¶æ„ç½‘ç«™B
3. ç½‘ç«™Bå·å·å‘ç½‘ç«™Aå‘èµ·è¯·æ±‚
4. ç”±äºç”¨æˆ·å·²ç™»å½•ï¼Œè¯·æ±‚ä¼šæˆåŠŸæ‰§è¡Œ
5. ç”¨æˆ·åœ¨ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹æ‰§è¡Œäº†æ¶æ„æ“ä½œ

OAuth2ä¸­çš„CSRFï¼š
æ¶æ„ç½‘ç«™æ„é€ æˆæƒé“¾æ¥ï¼Œè®©ç”¨æˆ·åœ¨ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹
æˆæƒæ¶æ„åº”ç”¨è®¿é—®è‡ªå·±çš„è´¦æˆ·
```

### 6.2 stateå‚æ•°çš„é˜²æŠ¤æœºåˆ¶


**ğŸ”’ é˜²æŠ¤åŸç†**
```
ç¬¬1æ­¥ï¼šåº”ç”¨ç”Ÿæˆéšæœºstate
state = "random_string_" + Math.random()

ç¬¬2æ­¥ï¼šå°†stateåŠ å…¥æˆæƒé“¾æ¥
https://auth.example.com/oauth/authorize?
  client_id=123&
  state=random_string_12345&
  ...å…¶ä»–å‚æ•°

ç¬¬3æ­¥ï¼šæˆæƒæœåŠ¡å™¨åŸæ ·è¿”å›state
ç”¨æˆ·æˆæƒåé‡å®šå‘ï¼š
https://myapp.com/callback?
  code=AUTH_CODE&
  state=random_string_12345

ç¬¬4æ­¥ï¼šåº”ç”¨éªŒè¯state
if (æ”¶åˆ°çš„state === ä¹‹å‰ç”Ÿæˆçš„state) {
  // åˆæ³•è¯·æ±‚ï¼Œç»§ç»­å¤„ç†
} else {
  // å¯èƒ½æ˜¯CSRFæ”»å‡»ï¼Œæ‹’ç»å¤„ç†
}
```

### 6.3 stateå‚æ•°æœ€ä½³å®è·µ


**âœ… ç”Ÿæˆè§„èŒƒ**
```javascript
// ç”Ÿæˆå®‰å…¨çš„stateå‚æ•°
function generateState() {
  return 'state_' + Math.random().toString(36).substring(2) + 
         Date.now().toString(36);
}

// å­˜å‚¨stateï¼ˆå¯ä»¥å­˜åœ¨sessionä¸­ï¼‰
const state = generateState();
req.session.oauthState = state;
```

**âœ… éªŒè¯è§„èŒƒ**
```javascript
// éªŒè¯è¿”å›çš„state
function verifyState(receivedState) {
  const storedState = req.session.oauthState;
  
  if (!storedState || receivedState !== storedState) {
    throw new Error('Invalid state parameter - possible CSRF attack');
  }
  
  // éªŒè¯æˆåŠŸåæ¸…é™¤state
  delete req.session.oauthState;
  return true;
}
```

**ğŸ”’ å®‰å…¨è¦ç‚¹**
```
stateå‚æ•°å®‰å…¨ä½¿ç”¨ï¼š
âœ… æ¯æ¬¡è¯·æ±‚ç”Ÿæˆæ–°çš„éšæœºå€¼
âœ… åŒ…å«è¶³å¤Ÿçš„éšæœºæ€§ï¼ˆè‡³å°‘32ä½ï¼‰
âœ… éªŒè¯åç«‹å³æ¸…é™¤å­˜å‚¨çš„state
âœ… è®¾ç½®stateçš„è¿‡æœŸæ—¶é—´
âœ… ç»‘å®šåˆ°ç”¨æˆ·ä¼šè¯ä¸­
```

---

## 7. ğŸš€ å®é™…åº”ç”¨ç¤ºä¾‹


### 7.1 å®Œæ•´æˆæƒæµç¨‹ç¤ºä¾‹


**ğŸ“‹ Node.jså®ç°ç¤ºä¾‹**
```javascript
const express = require('express');
const session = require('express-session');
const axios = require('axios');

const app = express();
app.use(session({ secret: 'your-secret' }));

// é…ç½®å‚æ•°
const CLIENT_ID = 'your_client_id';
const CLIENT_SECRET = 'your_client_secret';
const REDIRECT_URI = 'https://yourapp.com/oauth/callback';
const AUTH_URL = 'https://auth.example.com/oauth/authorize';
const TOKEN_URL = 'https://auth.example.com/oauth/token';

// ç¬¬1æ­¥ï¼šæ„é€ æˆæƒé“¾æ¥
app.get('/login', (req, res) => {
  // ç”Ÿæˆstateå‚æ•°
  const state = 'state_' + Math.random().toString(36).substring(2);
  req.session.oauthState = state;
  
  // æ„é€ æˆæƒURL
  const authUrl = `${AUTH_URL}?` +
    `client_id=${CLIENT_ID}&` +
    `response_type=code&` +
    `redirect_uri=${encodeURIComponent(REDIRECT_URI)}&` +
    `scope=read_profile&` +
    `state=${state}`;
  
  res.redirect(authUrl);
});

// ç¬¬2æ­¥ï¼šå¤„ç†æˆæƒå›è°ƒ
app.get('/oauth/callback', async (req, res) => {
  const { code, state } = req.query;
  
  // éªŒè¯stateå‚æ•°
  if (state !== req.session.oauthState) {
    return res.status(400).send('Invalid state parameter');
  }
  delete req.session.oauthState;
  
  try {
    // ç”¨æˆæƒç æ¢å–è®¿é—®ä»¤ç‰Œ
    const tokenResponse = await axios.post(TOKEN_URL, {
      grant_type: 'authorization_code',
      code: code,
      redirect_uri: REDIRECT_URI,
      client_id: CLIENT_ID,
      client_secret: CLIENT_SECRET
    });
    
    const { access_token } = tokenResponse.data;
    
    // å­˜å‚¨è®¿é—®ä»¤ç‰Œ
    req.session.accessToken = access_token;
    
    res.send('Login successful!');
  } catch (error) {
    res.status(500).send('Token exchange failed');
  }
});
```

### 7.2 å‚æ•°å¤„ç†æœ€ä½³å®è·µ


**ğŸ”§ å‚æ•°æ„é€ å·¥å…·å‡½æ•°**
```javascript
// OAuth2å‚æ•°æ„é€ å·¥å…·
class OAuth2Helper {
  static buildAuthUrl(config) {
    const params = new URLSearchParams({
      client_id: config.clientId,
      response_type: config.responseType || 'code',
      redirect_uri: config.redirectUri,
      scope: config.scope || '',
      state: config.state
    });
    
    return `${config.authEndpoint}?${params.toString()}`;
  }
  
  static async exchangeCodeForToken(config) {
    const response = await axios.post(config.tokenEndpoint, {
      grant_type: 'authorization_code',
      code: config.code,
      redirect_uri: config.redirectUri,
      client_id: config.clientId,
      client_secret: config.clientSecret
    }, {
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      }
    });
    
    return response.data;
  }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ ä¸¤ä¸ªå…³é”®ç«¯ç‚¹ï¼š
  - æˆæƒç«¯ç‚¹ï¼šç”¨æˆ·æˆæƒçš„åœ°æ–¹ï¼ˆæµè§ˆå™¨è®¿é—®ï¼‰
  - ä»¤ç‰Œç«¯ç‚¹ï¼šè·å–ä»¤ç‰Œçš„åœ°æ–¹ï¼ˆæœåŠ¡ç«¯è®¿é—®ï¼‰

ğŸ”¸ æ ¸å¿ƒå‚æ•°å«ä¹‰ï¼š
  - client_idï¼šåº”ç”¨èº«ä»½æ ‡è¯†ï¼ˆå…¬å¼€ï¼‰
  - client_secretï¼šåº”ç”¨å¯†é’¥ï¼ˆä¿å¯†ï¼‰
  - response_typeï¼šæƒ³è¦çš„å“åº”ç±»å‹
  - grant_typeï¼šä»¤ç‰Œè·å–æ–¹å¼
  - scopeï¼šæƒé™èŒƒå›´
  - stateï¼šé˜²CSRFçš„å®‰å…¨å‚æ•°

ğŸ”¸ é‡å®šå‘URIè§„èŒƒï¼š
  - å¿…é¡»å®Œå…¨åŒ¹é…
  - å¿…é¡»ä½¿ç”¨HTTPS
  - ä¸èƒ½ä½¿ç”¨é€šé…ç¬¦
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ç«¯ç‚¹çš„æœ¬è´¨åŒºåˆ«**
```
æˆæƒç«¯ç‚¹ï¼š
- ç”¨æˆ·èƒ½çœ‹è§çš„é¡µé¢
- å¤„ç†ç”¨æˆ·æˆæƒè¡Œä¸º
- è¿”å›æˆæƒç ç»™åº”ç”¨

ä»¤ç‰Œç«¯ç‚¹ï¼š
- åç«¯æœåŠ¡æ¥å£
- éªŒè¯åº”ç”¨èº«ä»½
- è¿”å›è®¿é—®ä»¤ç‰Œ
```

**ğŸ”¹ å‚æ•°çš„å®‰å…¨çº§åˆ«**
```
å…¬å¼€å‚æ•°ï¼šclient_id, response_type, scope, state
ä¿å¯†å‚æ•°ï¼šclient_secret, access_token, refresh_token
ä¸´æ—¶å‚æ•°ï¼šcodeï¼ˆæˆæƒç ï¼Œç”¨åå³ç„šï¼‰
```

**ğŸ”¹ stateå‚æ•°çš„é‡è¦æ€§**
```
ä½œç”¨ï¼šé˜²æ­¢CSRFæ”»å‡»
åŸç†ï¼šéšæœºå€¼ + å¾€è¿”éªŒè¯
å¿…è¦æ€§ï¼šOAuth2å®‰å…¨çš„é‡è¦ç¯èŠ‚
```

### 8.3 å®é™…åº”ç”¨è¦ç‚¹


**âœ… å¼€å‘æ³¨æ„äº‹é¡¹**
- æˆæƒç«¯ç‚¹çš„URLå‚æ•°è¦æ­£ç¡®ç¼–ç 
- ä»¤ç‰Œç«¯ç‚¹å¿…é¡»ä½¿ç”¨POSTè¯·æ±‚
- client_secretç»ä¸èƒ½æš´éœ²ç»™å®¢æˆ·ç«¯
- stateå‚æ•°å¿…é¡»æ¯æ¬¡éšæœºç”Ÿæˆ
- é‡å®šå‘URIå¿…é¡»ä¸¥æ ¼åŒ¹é…

**ğŸ”’ å®‰å…¨æœ€ä½³å®è·µ**
- å§‹ç»ˆéªŒè¯stateå‚æ•°
- æˆæƒç ä½¿ç”¨åç«‹å³å¤±æ•ˆ
- è®¿é—®ä»¤ç‰Œè®¾ç½®åˆç†è¿‡æœŸæ—¶é—´
- ä½¿ç”¨HTTPSä¿æŠ¤æ‰€æœ‰é€šä¿¡
- å®šæœŸè½®æ¢client_secret

**ğŸ’¡ è°ƒè¯•æŠ€å·§**
- æ£€æŸ¥å‚æ•°åç§°æ˜¯å¦æ­£ç¡®
- éªŒè¯URLç¼–ç æ˜¯å¦æ­£ç¡®
- ç¡®è®¤é‡å®šå‘URIé…ç½®ä¸€è‡´
- æŸ¥çœ‹æˆæƒæœåŠ¡å™¨çš„é”™è¯¯å“åº”
- ä½¿ç”¨å¼€å‘è€…å·¥å…·è·Ÿè¸ªè¯·æ±‚è¿‡ç¨‹

**æ ¸å¿ƒè®°å¿†**ï¼š
- æˆæƒç«¯ç‚¹ç»™ç”¨æˆ·çœ‹ï¼Œä»¤ç‰Œç«¯ç‚¹ç»™åº”ç”¨ç”¨
- client_idå…¬å¼€ï¼Œclient_secretä¿å¯†
- stateå‚æ•°é˜²æ”»å‡»ï¼Œé‡å®šå‘URIè¦ç²¾ç¡®
- æˆæƒç æ¢ä»¤ç‰Œï¼Œå®‰å…¨ç¬¬ä¸€è¦è®°ä½