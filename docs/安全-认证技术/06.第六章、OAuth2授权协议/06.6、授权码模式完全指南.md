---
title: 6ã€æˆæƒç æ¨¡å¼å®Œå…¨æŒ‡å—
---
## ğŸ“š ç›®å½•

1. [ä¸ºä»€ä¹ˆæˆæƒç æ¨¡å¼æœ€é‡è¦](#1-ä¸ºä»€ä¹ˆæˆæƒç æ¨¡å¼æœ€é‡è¦)
2. [æˆæƒç æ¨¡å¼8æ­¥å®Œæ•´æµç¨‹](#2-æˆæƒç æ¨¡å¼8æ­¥å®Œæ•´æµç¨‹)
3. [å…³é”®å‚æ•°è¯¦ç»†è§£è¯»](#3-å…³é”®å‚æ•°è¯¦ç»†è§£è¯»)
4. [æˆæƒç æ¢å–è®¿é—®ä»¤ç‰Œ](#4-æˆæƒç æ¢å–è®¿é—®ä»¤ç‰Œ)
5. [ä¸ºä»€ä¹ˆè¦ä¸¤æ­¥èµ°çš„å®‰å…¨è®¾è®¡](#5-ä¸ºä»€ä¹ˆè¦ä¸¤æ­¥èµ°çš„å®‰å…¨è®¾è®¡)
6. [å®é™…å¼€å‘æ³¨æ„äº‹é¡¹](#6-å®é™…å¼€å‘æ³¨æ„äº‹é¡¹)
7. [é”™è¯¯å¤„ç†å’Œå¼‚å¸¸æƒ…å†µ](#7-é”™è¯¯å¤„ç†å’Œå¼‚å¸¸æƒ…å†µ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” ä¸ºä»€ä¹ˆæˆæƒç æ¨¡å¼æœ€é‡è¦


### 1.1 ä»€ä¹ˆæ˜¯æˆæƒç æ¨¡å¼

**é€šä¿—ç†è§£**ï¼šæˆæƒç æ¨¡å¼å°±åƒæ˜¯**"å–å·åŠäº‹"**çš„æµç¨‹
- ä½ å…ˆå»çª—å£å–ä¸€ä¸ª**å·ç **ï¼ˆæˆæƒç ï¼‰
- ç„¶åæ‹¿ç€è¿™ä¸ª**å·ç **å»æ­£å¼åŠäº‹ï¼ˆæ¢å–è®¿é—®ä»¤ç‰Œï¼‰
- è¿™æ ·ç¡®ä¿åªæœ‰**æœ¬äºº**æ‰èƒ½å®Œæˆæ•´ä¸ªæµç¨‹

```
ç”Ÿæ´»åœºæ™¯ç±»æ¯”ï¼š
é“¶è¡ŒåŠä¸šåŠ¡ â†’ å…ˆå–å· â†’ å«å·ååŠç†
OAuth2æˆæƒ â†’ å…ˆè·å–æˆæƒç  â†’ ç”¨æˆæƒç æ¢ä»¤ç‰Œ
```

### 1.2 ä¸ºä»€ä¹ˆæœ€å®‰å…¨æœ€é‡è¦


**ğŸ›¡ï¸ å®‰å…¨ä¼˜åŠ¿**ï¼š
```
âœ… è®¿é—®ä»¤ç‰Œä¸ç›´æ¥æš´éœ²ï¼šä»¤ç‰Œä¸é€šè¿‡æµè§ˆå™¨ä¼ è¾“
âœ… ä¸¤æ­¥éªŒè¯ï¼šéœ€è¦æˆæƒç +å®¢æˆ·ç«¯å¯†é’¥åŒé‡éªŒè¯
âœ… æ—¶é—´é™åˆ¶ï¼šæˆæƒç æœ‰æ•ˆæœŸå¾ˆçŸ­ï¼ˆé€šå¸¸10åˆ†é’Ÿï¼‰
âœ… ä¸€æ¬¡æ€§ä½¿ç”¨ï¼šæ¯ä¸ªæˆæƒç åªèƒ½ä½¿ç”¨ä¸€æ¬¡
âœ… æœåŠ¡å™¨é—´é€šä¿¡ï¼šæœ€ç»ˆä»¤ç‰Œäº¤æ¢åœ¨æœåŠ¡å™¨é—´è¿›è¡Œ
```

**ğŸ“Š ä½¿ç”¨åœºæ™¯**ï¼š
- ğŸŒ **Webåº”ç”¨**ï¼šæœ€å¸¸è§ï¼Œå¦‚ç½‘ç«™ç¬¬ä¸‰æ–¹ç™»å½•
- ğŸ“± **ç§»åŠ¨åº”ç”¨**ï¼šé…åˆæ·±é“¾æ¥ä½¿ç”¨
- ğŸ–¥ï¸ **æ¡Œé¢åº”ç”¨**ï¼šé…åˆæœ¬åœ°æœåŠ¡å™¨
- â­ **ä¼ä¸šçº§åº”ç”¨**ï¼šå®‰å…¨è¦æ±‚é«˜çš„åœºæ™¯

---

## 2. ğŸ”„ æˆæƒç æ¨¡å¼8æ­¥å®Œæ•´æµç¨‹


### 2.1 æµç¨‹æ¦‚è§ˆå›¾


```
ç”¨æˆ·æµè§ˆå™¨          å®¢æˆ·ç«¯åº”ç”¨            æˆæƒæœåŠ¡å™¨           èµ„æºæœåŠ¡å™¨
      |                  |                    |                   |
   [1]|--ç‚¹å‡»ç™»å½•-------->|                    |                   |
      |                  |                    |                   |
   [2]|<--é‡å®šå‘åˆ°æˆæƒé¡µ--|[æ„é€ æˆæƒURL]       |                   |
      |                  |                    |                   |
   [3]|--è®¿é—®æˆæƒé¡µé¢------------------->|                   |
      |                  |              |                   |
   [4]|<--æ˜¾ç¤ºæˆæƒé¡µé¢-----------------|                   |
      |                  |              |                   |
   [5]|--ç”¨æˆ·åŒæ„æˆæƒ----------------->|                   |
      |                  |              |                   |
   [6]|<--å›è°ƒå¸¦æˆæƒç -----------------|                   |
      |                  |              |                   |
   [7]|--ä¼ é€’æˆæƒç ------>|--ç”¨æˆæƒç æ¢ä»¤ç‰Œ->|                   |
      |                  |<--è¿”å›è®¿é—®ä»¤ç‰Œ----|                   |
   [8]|<--ç™»å½•æˆåŠŸ--------|--ç”¨ä»¤ç‰Œè®¿é—®èµ„æº---------------->|
```

### 2.2 è¯¦ç»†æ­¥éª¤è§£æ


**æ­¥éª¤1ï¼šç”¨æˆ·å‘èµ·ç™»å½•**
```
ç”¨æˆ·è¡Œä¸ºï¼šç‚¹å‡»"ç”¨å¾®ä¿¡ç™»å½•"æŒ‰é’®
è§¦å‘äº‹ä»¶ï¼šå®¢æˆ·ç«¯åº”ç”¨å¼€å§‹OAuth2æµç¨‹
```

**æ­¥éª¤2ï¼šæ„é€ æˆæƒURLå¹¶é‡å®šå‘**
```http
HTTP/1.1 302 Found
Location: https://api.weixin.qq.com/oauth2/authorize?
    response_type=code&
    client_id=wx123456789&
    redirect_uri=https://myapp.com/callback&
    scope=userinfo&
    state=abc123
```

**æ­¥éª¤3ï¼šç”¨æˆ·è®¿é—®æˆæƒæœåŠ¡å™¨**
```
ç”¨æˆ·æµè§ˆå™¨è‡ªåŠ¨è·³è½¬åˆ°å¾®ä¿¡æˆæƒé¡µé¢
æ˜¾ç¤ºï¼š"MyAppæƒ³è¦è·å–ä½ çš„åŸºæœ¬ä¿¡æ¯"
```

**æ­¥éª¤4ï¼šæ˜¾ç¤ºæˆæƒç¡®è®¤é¡µé¢**
```
æˆæƒé¡µé¢å†…å®¹ï¼š
- åº”ç”¨åç§°ï¼šMyApp
- è¯·æ±‚æƒé™ï¼šè·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
- æŒ‰é’®ï¼šåŒæ„/æ‹’ç»
```

**æ­¥éª¤5ï¼šç”¨æˆ·ç¡®è®¤æˆæƒ**
```
ç”¨æˆ·ç‚¹å‡»"åŒæ„"æŒ‰é’®
æˆæƒæœåŠ¡å™¨è®°å½•ç”¨æˆ·åŒæ„
```

**æ­¥éª¤6ï¼šé‡å®šå‘å›å®¢æˆ·ç«¯**
```http
HTTP/1.1 302 Found
Location: https://myapp.com/callback?
    code=AUTH_CODE_HERE&
    state=abc123
```

**æ­¥éª¤7ï¼šæˆæƒç æ¢å–è®¿é—®ä»¤ç‰Œ**
```http
POST /oauth2/token HTTP/1.1
Host: api.weixin.qq.com
Content-Type: application/x-www-form-urlencoded

grant_type=authorization_code&
code=AUTH_CODE_HERE&
client_id=wx123456789&
client_secret=SECRET_KEY&
redirect_uri=https://myapp.com/callback
```

**æ­¥éª¤8ï¼šè·å–å¹¶ä½¿ç”¨è®¿é—®ä»¤ç‰Œ**
```json
{
  "access_token": "ACCESS_TOKEN_HERE",
  "token_type": "Bearer",
  "expires_in": 7200,
  "refresh_token": "REFRESH_TOKEN_HERE",
  "scope": "userinfo"
}
```

---

## 3. ğŸ”‘ å…³é”®å‚æ•°è¯¦ç»†è§£è¯»


### 3.1 response_typeå‚æ•°


**`response_type=code`**
```
å«ä¹‰ï¼šå‘Šè¯‰æˆæƒæœåŠ¡å™¨æˆ‘ä»¬è¦ä½¿ç”¨æˆæƒç æ¨¡å¼
å›ºå®šå€¼ï¼šåœ¨æˆæƒç æ¨¡å¼ä¸­å¿…é¡»æ˜¯"code"
ä½œç”¨ï¼šæˆæƒæœåŠ¡å™¨æ®æ­¤åˆ¤æ–­è¿”å›æˆæƒç è€Œä¸æ˜¯ä»¤ç‰Œ
```

**âš ï¸ é‡è¦æé†’**ï¼š
- è¿™ä¸ªå‚æ•°**ä¸èƒ½å˜**ï¼Œå†™é”™äº†å°±ä¸æ˜¯æˆæƒç æ¨¡å¼äº†
- å…¶ä»–æ¨¡å¼æœ‰ä¸åŒçš„å€¼ï¼š`token`ï¼ˆéšå¼æ¨¡å¼ï¼‰ã€`password`ï¼ˆå¯†ç æ¨¡å¼ï¼‰

### 3.2 client_idå‚æ•°


**åº”ç”¨æ ‡è¯†ç¬¦**
```
å«ä¹‰ï¼šå°±åƒæ˜¯ä½ çš„"èº«ä»½è¯å·"ï¼Œå”¯ä¸€æ ‡è¯†ä½ çš„åº”ç”¨
è·å–æ–¹å¼ï¼šåœ¨æˆæƒæœåŠ¡å™¨æ³¨å†Œåº”ç”¨æ—¶è·å¾—
æ ¼å¼ï¼šé€šå¸¸æ˜¯å­—ç¬¦ä¸²ï¼Œå¦‚ wx123456789
ä½œç”¨ï¼šè®©æˆæƒæœåŠ¡å™¨çŸ¥é“æ˜¯å“ªä¸ªåº”ç”¨åœ¨è¯·æ±‚æˆæƒ
```

**ğŸ“ å®é™…ä½¿ç”¨**ï¼š
```javascript
// å¾®ä¿¡çš„client_idå«AppID
const wechatAppId = 'wx1234567890abcdef';

// GitHubçš„client_id
const githubClientId = 'Iv1.1234567890abcdef';

// è…¾è®¯QQçš„client_idå«AppID  
const qqAppId = '12345678';
```

### 3.3 redirect_uriå‚æ•°


**å›è°ƒåœ°å€**
```
å«ä¹‰ï¼šç”¨æˆ·æˆæƒåè·³è½¬å›æ¥çš„åœ°å€
è¦æ±‚ï¼šå¿…é¡»ä¸æ³¨å†Œæ—¶å¡«å†™çš„åœ°å€å®Œå…¨ä¸€è‡´
ä½œç”¨ï¼šå‘Šè¯‰æˆæƒæœåŠ¡å™¨æˆæƒå®Œæˆåè·³è½¬åˆ°å“ªé‡Œ
å®‰å…¨æ€§ï¼šé˜²æ­¢æˆæƒç è¢«åŠ«æŒåˆ°å…¶ä»–ç½‘ç«™
```

**ğŸ”§ é…ç½®ç¤ºä¾‹**ï¼š
```javascript
// å¼€å‘ç¯å¢ƒ
const redirectUri = 'http://localhost:3000/auth/callback';

// ç”Ÿäº§ç¯å¢ƒ  
const redirectUri = 'https://myapp.com/auth/callback';

// å¿…é¡»åœ¨æˆæƒæœåŠ¡å™¨åå°é…ç½®ç›¸åŒçš„åœ°å€
```

**âš ï¸ å¸¸è§é”™è¯¯**ï¼š
- åœ°å€ä¸åŒ¹é…ï¼š`redirect_uri_mismatch`
- åè®®ä¸åŒï¼šhttp vs https
- ç«¯å£ä¸åŒï¼š3000 vs 8080
- è·¯å¾„ä¸åŒï¼š/callback vs /auth/callback

### 3.4 scopeå‚æ•°


**æƒé™èŒƒå›´**
```
å«ä¹‰ï¼šå‘Šè¯‰æˆæƒæœåŠ¡å™¨ä½ éœ€è¦ä»€ä¹ˆæƒé™
æ ¼å¼ï¼šå¤šä¸ªæƒé™ç”¨ç©ºæ ¼åˆ†éš”
ä½œç”¨ï¼šé™åˆ¶è®¿é—®ä»¤ç‰Œçš„ä½¿ç”¨èŒƒå›´
åŸåˆ™ï¼šæŒ‰éœ€ç”³è¯·ï¼Œæœ€å°æƒé™åŸåˆ™
```

**ğŸ“Š å¸¸è§æƒé™èŒƒå›´**ï¼š
```javascript
// åŸºç¡€ä¿¡æ¯æƒé™
scope: 'profile'           // ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
scope: 'email'             // é‚®ç®±åœ°å€
scope: 'phone'             // æ‰‹æœºå·ç 

// ç»„åˆæƒé™
scope: 'profile email'     // åŸºæœ¬ä¿¡æ¯+é‚®ç®±
scope: 'read write'        // è¯»å†™æƒé™

// ç‰¹å®šå¹³å°æƒé™
// å¾®ä¿¡
scope: 'snsapi_base'       // é™é»˜æˆæƒï¼Œåªèƒ½è·å–openid
scope: 'snsapi_userinfo'   // éœ€è¦ç”¨æˆ·ç¡®è®¤ï¼Œå¯è·å–è¯¦ç»†ä¿¡æ¯

// GitHub
scope: 'repo'              // è®¿é—®ä»“åº“
scope: 'user'              // ç”¨æˆ·ä¿¡æ¯
scope: 'admin:org'         // ç»„ç»‡ç®¡ç†æƒé™
```

### 3.5 stateå‚æ•°


**å®‰å…¨å‚æ•°**
```
å«ä¹‰ï¼šé˜²æ­¢CSRFæ”»å‡»çš„éšæœºå­—ç¬¦ä¸²
ç”Ÿæˆï¼šå®¢æˆ·ç«¯ç”Ÿæˆéšæœºå€¼
éªŒè¯ï¼šå›è°ƒæ—¶å¿…é¡»éªŒè¯stateå€¼ä¸€è‡´
ä½œç”¨ï¼šç¡®ä¿è¯·æ±‚æ¥æºçš„çœŸå®æ€§
```

**ğŸ›¡ï¸ å®‰å…¨å®ç°**ï¼š
```javascript
// ç”Ÿæˆstate
function generateState() {
    return Math.random().toString(36).substring(2, 15) + 
           Math.random().toString(36).substring(2, 15);
}

// ä¿å­˜stateï¼ˆé€šå¸¸å­˜åœ¨sessionä¸­ï¼‰
const state = generateState();
sessionStorage.setItem('oauth_state', state);

// éªŒè¯state
function verifyState(returnedState) {
    const savedState = sessionStorage.getItem('oauth_state');
    return savedState === returnedState;
}
```

**âš ï¸ å®‰å…¨æé†’**ï¼š
- stateå‚æ•°**ä¸èƒ½çœç•¥**
- å¿…é¡»æ˜¯**ä¸å¯é¢„æµ‹**çš„éšæœºå€¼
- **æ¯æ¬¡è¯·æ±‚**éƒ½è¦ç”Ÿæˆæ–°çš„state
- å›è°ƒæ—¶**å¿…é¡»éªŒè¯**stateä¸€è‡´æ€§

---

## 4. ğŸ”„ æˆæƒç æ¢å–è®¿é—®ä»¤ç‰Œ


### 4.1 æ¢å–è¿‡ç¨‹è¯¦è§£


**ä¸ºä»€ä¹ˆè¦æ¢å–ï¼Ÿ**
```
æˆæƒç çš„é™åˆ¶ï¼š
âŒ åªèƒ½ä½¿ç”¨ä¸€æ¬¡
âŒ æœ‰æ•ˆæœŸå¾ˆçŸ­ï¼ˆé€šå¸¸10åˆ†é’Ÿï¼‰
âŒ ä¸èƒ½ç›´æ¥è®¿é—®èµ„æº

è®¿é—®ä»¤ç‰Œçš„ä¼˜åŠ¿ï¼š
âœ… å¯ä»¥å¤šæ¬¡ä½¿ç”¨
âœ… æœ‰æ•ˆæœŸç›¸å¯¹è¾ƒé•¿
âœ… å¯ä»¥ç›´æ¥è®¿é—®èµ„æºAPI
```

### 4.2 æ¢å–è¯·æ±‚è¯¦è§£


**å®Œæ•´çš„HTTPè¯·æ±‚**ï¼š
```http
POST /oauth2/token HTTP/1.1
Host: api.example.com
Content-Type: application/x-www-form-urlencoded
Authorization: Basic Base64(client_id:client_secret)

grant_type=authorization_code&
code=AUTHORIZATION_CODE_HERE&
redirect_uri=https://myapp.com/callback&
client_id=your_client_id
```

**å‚æ•°è¯´æ˜**ï¼š
```javascript
{
  grant_type: 'authorization_code',    // å›ºå®šå€¼ï¼Œè¡¨ç¤ºç”¨æˆæƒç æ¢ä»¤ç‰Œ
  code: 'æˆæƒç ',                       // ä¸Šä¸€æ­¥è·å¾—çš„æˆæƒç 
  redirect_uri: 'å›è°ƒåœ°å€',             // å¿…é¡»ä¸ä¹‹å‰çš„å®Œå…¨ä¸€è‡´
  client_id: 'åº”ç”¨ID',                  // åº”ç”¨æ ‡è¯†
  client_secret: 'åº”ç”¨å¯†é’¥'             // åº”ç”¨å¯†é’¥ï¼ˆè¯æ˜æ˜¯åˆæ³•åº”ç”¨ï¼‰
}
```

### 4.3 æˆåŠŸå“åº”ç¤ºä¾‹


```json
{
  "access_token": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "Bearer",
  "expires_in": 3600,
  "refresh_token": "def50200...",
  "scope": "profile email"
}
```

**å“åº”å‚æ•°è§£é‡Š**ï¼š
- **access_token**ï¼šè®¿é—®ä»¤ç‰Œï¼Œç”¨äºè®¿é—®å—ä¿æŠ¤èµ„æº
- **token_type**ï¼šä»¤ç‰Œç±»å‹ï¼Œé€šå¸¸æ˜¯"Bearer"
- **expires_in**ï¼šä»¤ç‰Œæœ‰æ•ˆæœŸï¼Œå•ä½ç§’ï¼ˆ3600=1å°æ—¶ï¼‰
- **refresh_token**ï¼šåˆ·æ–°ä»¤ç‰Œï¼Œç”¨äºè·å–æ–°çš„è®¿é—®ä»¤ç‰Œ
- **scope**ï¼šå®é™…æˆäºˆçš„æƒé™èŒƒå›´

### 4.4 ä»£ç å®ç°ç¤ºä¾‹


```javascript
async function exchangeCodeForToken(authCode) {
    const params = new URLSearchParams({
        grant_type: 'authorization_code',
        code: authCode,
        redirect_uri: 'https://myapp.com/callback',
        client_id: 'your_client_id',
        client_secret: 'your_client_secret'
    });
    
    try {
        const response = await fetch('https://api.example.com/oauth2/token', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: params
        });
        
        const tokenData = await response.json();
        
        if (response.ok) {
            // ä¿å­˜è®¿é—®ä»¤ç‰Œ
            localStorage.setItem('access_token', tokenData.access_token);
            console.log('è·å–ä»¤ç‰ŒæˆåŠŸï¼');
            return tokenData;
        } else {
            throw new Error(tokenData.error_description);
        }
    } catch (error) {
        console.error('æ¢å–ä»¤ç‰Œå¤±è´¥ï¼š', error.message);
    }
}
```

---

## 5. ğŸ›¡ï¸ ä¸ºä»€ä¹ˆè¦ä¸¤æ­¥èµ°çš„å®‰å…¨è®¾è®¡


### 5.1 ä¸€æ­¥èµ°çš„å®‰å…¨é£é™©


**å¦‚æœç›´æ¥è¿”å›è®¿é—®ä»¤ç‰Œä¼šæ€æ ·ï¼Ÿ**
```
é£é™©åœºæ™¯ï¼š
1. è®¿é—®ä»¤ç‰Œåœ¨URLä¸­ä¼ è¾“ â†’ å®¹æ˜“è¢«æ‹¦æˆª
2. æµè§ˆå™¨å†å²è®°å½•ä¿å­˜ä»¤ç‰Œ â†’ ä¿¡æ¯æ³„éœ²
3. æœåŠ¡å™¨æ—¥å¿—è®°å½•ä»¤ç‰Œ â†’ å®‰å…¨é£é™©
4. æ¶æ„ç½‘ç«™åŠ«æŒä»¤ç‰Œ â†’ å†’å……ç”¨æˆ·

å®é™…å±å®³ï¼š
âŒ ä»¤ç‰Œå¯èƒ½è¢«ç½‘ç»œç›‘å¬å·¥å…·æˆªè·
âŒ æµè§ˆå™¨æ’ä»¶å¯èƒ½è¯»å–æ•æ„Ÿä¿¡æ¯
âŒ æœåŠ¡å™¨è®¿é—®æ—¥å¿—åŒ…å«æ•æ„Ÿä»¤ç‰Œ
âŒ æ¶æ„å¹¿å‘Šæˆ–è„šæœ¬å¯èƒ½çªƒå–ä»¤ç‰Œ
```

### 5.2 ä¸¤æ­¥èµ°çš„å®‰å…¨ä¼˜åŠ¿


**ç¬¬ä¸€æ­¥ï¼šè·å–æˆæƒç **
```
å®‰å…¨ç‰¹ç‚¹ï¼š
âœ… æˆæƒç æœ¬èº«æ— æ³•è®¿é—®èµ„æº
âœ… æˆæƒç æœ‰æ•ˆæœŸå¾ˆçŸ­ï¼ˆ10åˆ†é’Ÿï¼‰
âœ… æˆæƒç åªèƒ½ä½¿ç”¨ä¸€æ¬¡
âœ… å³ä½¿è¢«æˆªè·ä¹Ÿæ— æ³•ç›´æ¥ä½¿ç”¨
```

**ç¬¬äºŒæ­¥ï¼šæ¢å–è®¿é—®ä»¤ç‰Œ**
```
å®‰å…¨ç‰¹ç‚¹ï¼š
âœ… åœ¨æœåŠ¡å™¨åç«¯è¿›è¡Œï¼Œä¸ç»è¿‡æµè§ˆå™¨
âœ… éœ€è¦å®¢æˆ·ç«¯å¯†é’¥è¿›è¡Œèº«ä»½éªŒè¯
âœ… ä½¿ç”¨HTTPSåŠ å¯†ä¼ è¾“
âœ… ä¸ä¼šæš´éœ²åœ¨URLæˆ–æ—¥å¿—ä¸­
```

### 5.3 å®‰å…¨æœºåˆ¶å›¾è§£


```
ä¸å®‰å…¨çš„ä¸€æ­¥æµç¨‹ï¼š
ç”¨æˆ·æˆæƒ â†’ ç›´æ¥è¿”å›ä»¤ç‰Œ(URLä¸­) â†’ ä»¤ç‰Œæš´éœ²é£é™©

å®‰å…¨çš„ä¸¤æ­¥æµç¨‹ï¼š
ç”¨æˆ·æˆæƒ â†’ è¿”å›æˆæƒç (URLä¸­) â†’ åç«¯ç”¨æˆæƒç +å¯†é’¥æ¢ä»¤ç‰Œ â†’ ä»¤ç‰Œå®‰å…¨è·å–
            â†‘                    â†‘
         ä¸´æ—¶çš„,çŸ­æœŸçš„          éœ€è¦å¯†é’¥éªŒè¯
         å³ä½¿æ³„éœ²å½±å“æœ‰é™       åœ¨æœåŠ¡å™¨ç«¯å®‰å…¨è¿›è¡Œ
```

### 5.4 æ·±å…¥ç†è§£å®‰å…¨è®¾è®¡


**æˆæƒç çš„å·§å¦™ä¹‹å¤„**ï¼š
```
æˆæƒç  = ä¸´æ—¶é—¨ç¥¨
- æœ‰æ•ˆæœŸçŸ­ï¼šè¿‡æœŸè‡ªåŠ¨å¤±æ•ˆ
- ä¸€æ¬¡æ€§ï¼šç”¨å®Œå³åºŸ
- éœ€è¦é…å¯¹ï¼šå¿…é¡»é…åˆå®¢æˆ·ç«¯å¯†é’¥ä½¿ç”¨
- æ— ç›´æ¥ä»·å€¼ï¼šä¸èƒ½ç›´æ¥è®¿é—®èµ„æº

å°±åƒé“¶è¡Œå–æ¬¾ï¼š
- é“¶è¡Œå¡å·å¯ä»¥å…¬å¼€ï¼ˆæˆæƒç ï¼‰
- ä½†å–æ¬¾éœ€è¦å¯†ç ï¼ˆå®¢æˆ·ç«¯å¯†é’¥ï¼‰
- åœ¨å®‰å…¨çš„ATMä¸Šæ“ä½œï¼ˆæœåŠ¡å™¨ç«¯ï¼‰
```

---

## 6. âš¡ å®é™…å¼€å‘æ³¨æ„äº‹é¡¹


### 6.1 URLæ„é€ æ³¨æ„äº‹é¡¹


**æ­£ç¡®çš„URLç¼–ç **ï¼š
```javascript
// âŒ é”™è¯¯ï¼šç›´æ¥æ‹¼æ¥å¯èƒ½å¯¼è‡´ç‰¹æ®Šå­—ç¬¦é—®é¢˜
const authUrl = `https://api.example.com/oauth2/authorize?client_id=${clientId}&redirect_uri=${redirectUri}`;

// âœ… æ­£ç¡®ï¼šä½¿ç”¨URLç¼–ç 
const params = new URLSearchParams({
    response_type: 'code',
    client_id: clientId,
    redirect_uri: redirectUri,
    scope: 'profile email',
    state: generateState()
});
const authUrl = `https://api.example.com/oauth2/authorize?${params}`;
```

**å‚æ•°æ ¡éªŒ**ï¼š
```javascript
function buildAuthUrl(config) {
    // å¿…éœ€å‚æ•°æ£€æŸ¥
    if (!config.clientId) throw new Error('client_id is required');
    if (!config.redirectUri) throw new Error('redirect_uri is required');
    
    // URLæ ¼å¼éªŒè¯
    try {
        new URL(config.redirectUri);
    } catch (error) {
        throw new Error('redirect_uri must be a valid URL');
    }
    
    return authUrl;
}
```

### 6.2 å›è°ƒå¤„ç†æœ€ä½³å®è·µ


**å›è°ƒè·¯ç”±è®¾è®¡**ï¼š
```javascript
// Express.jsç¤ºä¾‹
app.get('/auth/callback', async (req, res) => {
    const { code, state, error } = req.query;
    
    // 1. é”™è¯¯å¤„ç†
    if (error) {
        return res.redirect(`/login?error=${error}`);
    }
    
    // 2. stateéªŒè¯
    const savedState = req.session.oauth_state;
    if (state !== savedState) {
        return res.status(400).send('Invalid state parameter');
    }
    
    // 3. æˆæƒç å¤„ç†
    if (code) {
        try {
            const tokenData = await exchangeCodeForToken(code);
            req.session.access_token = tokenData.access_token;
            res.redirect('/dashboard'); // ç™»å½•æˆåŠŸ
        } catch (error) {
            res.redirect('/login?error=token_exchange_failed');
        }
    }
});
```

### 6.3 ä»¤ç‰Œç®¡ç†ç­–ç•¥


**å®‰å…¨å­˜å‚¨**ï¼š
```javascript
// âŒ ä¸å®‰å…¨ï¼šå­˜å‚¨åœ¨localStorage
localStorage.setItem('access_token', token);

// âœ… è¾ƒå®‰å…¨ï¼šå­˜å‚¨åœ¨httpOnly cookie
res.cookie('access_token', token, {
    httpOnly: true,    // é˜²æ­¢XSSæ”»å‡»
    secure: true,      // åªåœ¨HTTPSä¸‹ä¼ è¾“
    sameSite: 'strict', // é˜²æ­¢CSRFæ”»å‡»
    maxAge: 3600000    // 1å°æ—¶è¿‡æœŸ
});

// âœ… æœ€å®‰å…¨ï¼šå­˜å‚¨åœ¨æœåŠ¡å™¨session
req.session.tokens = {
    access_token: tokenData.access_token,
    refresh_token: tokenData.refresh_token,
    expires_at: Date.now() + tokenData.expires_in * 1000
};
```

### 6.4 é”™è¯¯é‡è¯•æœºåˆ¶


```javascript
async function exchangeCodeForTokenWithRetry(authCode, maxRetries = 3) {
    for (let attempt = 1; attempt <= maxRetries; attempt++) {
        try {
            return await exchangeCodeForToken(authCode);
        } catch (error) {
            if (attempt === maxRetries) {
                throw error; // æœ€åä¸€æ¬¡å°è¯•å¤±è´¥
            }
            
            // æŒ‡æ•°é€€é¿é‡è¯•
            await new Promise(resolve => 
                setTimeout(resolve, Math.pow(2, attempt) * 1000)
            );
        }
    }
}
```

---

## 7. âš ï¸ é”™è¯¯å¤„ç†å’Œå¼‚å¸¸æƒ…å†µ


### 7.1 å¸¸è§é”™è¯¯ç±»å‹


**æˆæƒé˜¶æ®µé”™è¯¯**ï¼š
```
ç”¨æˆ·æ‹’ç»æˆæƒï¼š
URL: https://myapp.com/callback?error=access_denied&state=abc123
å¤„ç†ï¼šé‡å®šå‘åˆ°ç™»å½•é¡µï¼Œæç¤ºç”¨æˆ·æˆæƒè¢«æ‹’ç»

å‚æ•°é”™è¯¯ï¼š
error=invalid_request
error_description=Missing required parameter: client_id
å¤„ç†ï¼šæ£€æŸ¥æˆæƒURLå‚æ•°æ˜¯å¦å®Œæ•´

åº”ç”¨é…ç½®é”™è¯¯ï¼š
error=unauthorized_client  
error_description=Invalid redirect URI
å¤„ç†ï¼šæ£€æŸ¥redirect_uriæ˜¯å¦ä¸æ³¨å†Œä¿¡æ¯ä¸€è‡´
```

**ä»¤ç‰Œäº¤æ¢é˜¶æ®µé”™è¯¯**ï¼š
```json
{
  "error": "invalid_grant",
  "error_description": "Authorization code has expired"
}
```

### 7.2 é”™è¯¯å¤„ç†ä»£ç ç¤ºä¾‹


```javascript
function handleOAuthError(error, errorDescription) {
    const errorMessages = {
        'access_denied': 'ç”¨æˆ·æ‹’ç»äº†æˆæƒè¯·æ±‚',
        'invalid_request': 'è¯·æ±‚å‚æ•°æœ‰è¯¯ï¼Œè¯·é‡è¯•',
        'invalid_client': 'åº”ç”¨é…ç½®é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜',
        'invalid_grant': 'æˆæƒç å·²è¿‡æœŸæˆ–æ— æ•ˆï¼Œè¯·é‡æ–°æˆæƒ',
        'unsupported_response_type': 'ä¸æ”¯æŒçš„å“åº”ç±»å‹',
        'server_error': 'æˆæƒæœåŠ¡å™¨å‡ºç°é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•'
    };
    
    const userMessage = errorMessages[error] || 'æˆæƒè¿‡ç¨‹ä¸­å‡ºç°æœªçŸ¥é”™è¯¯';
    
    // è®°å½•è¯¦ç»†é”™è¯¯ä¿¡æ¯
    console.error('OAuth Error:', {
        error,
        errorDescription,
        timestamp: new Date().toISOString()
    });
    
    // æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯
    alert(userMessage);
}
```

### 7.3 è¶…æ—¶å¤„ç†


```javascript
class OAuthHandler {
    constructor() {
        this.authTimeout = 10 * 60 * 1000; // 10åˆ†é’Ÿè¶…æ—¶
    }
    
    startAuthFlow() {
        // è®¾ç½®è¶…æ—¶æ¸…ç†
        const timeoutId = setTimeout(() => {
            this.handleAuthTimeout();
        }, this.authTimeout);
        
        // ä¿å­˜è¶…æ—¶IDï¼Œä»¥ä¾¿åœ¨æˆåŠŸæ—¶æ¸…é™¤
        sessionStorage.setItem('auth_timeout', timeoutId);
    }
    
    handleAuthTimeout() {
        // æ¸…ç†ä¸´æ—¶æ•°æ®
        sessionStorage.removeItem('oauth_state');
        sessionStorage.removeItem('auth_timeout');
        
        // æç¤ºç”¨æˆ·é‡æ–°æˆæƒ
        alert('æˆæƒè¶…æ—¶ï¼Œè¯·é‡æ–°ç™»å½•');
        window.location.href = '/login';
    }
    
    handleAuthSuccess() {
        // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
        const timeoutId = sessionStorage.getItem('auth_timeout');
        if (timeoutId) {
            clearTimeout(timeoutId);
            sessionStorage.removeItem('auth_timeout');
        }
    }
}
```

### 7.4 ç½‘ç»œå¼‚å¸¸å¤„ç†


```javascript
async function robustTokenExchange(authCode) {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30ç§’è¶…æ—¶
    
    try {
        const response = await fetch('/oauth2/token', {
            method: 'POST',
            signal: controller.signal,
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                grant_type: 'authorization_code',
                code: authCode,
                // ... å…¶ä»–å‚æ•°
            })
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        return await response.json();
        
    } catch (error) {
        clearTimeout(timeoutId);
        
        if (error.name === 'AbortError') {
            throw new Error('è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
        } else if (error.name === 'TypeError') {
            throw new Error('ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•');
        } else {
            throw error;
        }
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„å…³é”®æ¦‚å¿µ


```
ğŸ”¸ æˆæƒç æ¨¡å¼ï¼šOAuth2æœ€å®‰å…¨ã€æœ€å¸¸ç”¨çš„æˆæƒæ¨¡å¼
ğŸ”¸ ä¸¤æ­¥éªŒè¯ï¼šå…ˆè·å–æˆæƒç ï¼Œå†æ¢å–è®¿é—®ä»¤ç‰Œ
ğŸ”¸ å…³é”®å‚æ•°ï¼šresponse_typeã€client_idã€redirect_uriã€scopeã€state
ğŸ”¸ å®‰å…¨è®¾è®¡ï¼šè®¿é—®ä»¤ç‰Œä¸ç»è¿‡æµè§ˆå™¨ï¼Œåœ¨æœåŠ¡å™¨ç«¯å®‰å…¨äº¤æ¢
ğŸ”¸ æ—¶æ•ˆæ€§ï¼šæˆæƒç çŸ­æœŸæœ‰æ•ˆï¼Œè®¿é—®ä»¤ç‰Œç›¸å¯¹é•¿æœŸæœ‰æ•ˆ
```

### 8.2 å®‰å…¨è¦ç‚¹è®°å¿†


**ğŸ›¡ï¸ å®‰å…¨ä¸‰åŸåˆ™**ï¼š
```
1. stateå‚æ•°å¿…é¡»ä½¿ç”¨ï¼šé˜²æ­¢CSRFæ”»å‡»
2. redirect_uriå¿…é¡»ç²¾ç¡®åŒ¹é…ï¼šé˜²æ­¢æˆæƒåŠ«æŒ  
3. client_secretå¿…é¡»ä¿å¯†ï¼šåœ¨æœåŠ¡å™¨ç«¯ä½¿ç”¨
```

**âš ï¸ å¸¸è§å®‰å…¨è¯¯åŒº**ï¼š
```
âŒ åœ¨å‰ç«¯æš´éœ²client_secret
âŒ å¿½ç•¥stateå‚æ•°éªŒè¯
âŒ redirect_urié…ç½®è¿‡äºå®½æ³›
âŒ è®¿é—®ä»¤ç‰Œå­˜å‚¨åœ¨ä¸å®‰å…¨ä½ç½®
```

### 8.3 å¼€å‘å®è·µè¦ç‚¹


**ğŸ”§ å¼€å‘æ£€æŸ¥æ¸…å•**ï¼š
```
âœ… æ­£ç¡®æ„é€ æˆæƒURLï¼ˆå‚æ•°ç¼–ç ï¼‰
âœ… å®‰å…¨ä¿å­˜å’ŒéªŒè¯stateå‚æ•°
âœ… å¦¥å–„å¤„ç†å„ç§é”™è¯¯æƒ…å†µ
âœ… åˆç†è®¾ç½®è¶…æ—¶å’Œé‡è¯•æœºåˆ¶
âœ… å®‰å…¨å­˜å‚¨å’Œç®¡ç†è®¿é—®ä»¤ç‰Œ
âœ… å®ç°ä»¤ç‰Œåˆ·æ–°æœºåˆ¶
```

**ğŸ“ è®°å¿†å£è¯€**ï¼š
```
æˆæƒç æ¨¡å¼æœ€å®‰å…¨ï¼Œä¸¤æ­¥éªŒè¯ä¿å¹³å®‰
å…ˆå–ç æ¥åæ¢ä»¤ï¼ŒæœåŠ¡å™¨ç«¯åšäº¤æ¢
stateå‚æ•°é˜²æ”»å‡»ï¼Œredirectè¦åŒ¹é…
å¯†é’¥ä¿å¯†è«æ³„éœ²ï¼Œé”™è¯¯å¤„ç†è¦å‘¨å…¨
```

**ğŸ¯ å®é™…åº”ç”¨ä»·å€¼**ï¼š
- **ä¼ä¸šçº§åº”ç”¨**ï¼šæ»¡è¶³é«˜å®‰å…¨è¦æ±‚
- **ç¬¬ä¸‰æ–¹ç™»å½•**ï¼šå¾®ä¿¡ã€æ”¯ä»˜å®ã€GitHubç­‰
- **APIé›†æˆ**ï¼šå®‰å…¨è®¿é—®ç¬¬ä¸‰æ–¹æœåŠ¡
- **ç§»åŠ¨åº”ç”¨**ï¼šé…åˆæ·±é“¾æ¥å®ç°æˆæƒ
- **å¾®æœåŠ¡æ¶æ„**ï¼šæœåŠ¡é—´å®‰å…¨é€šä¿¡