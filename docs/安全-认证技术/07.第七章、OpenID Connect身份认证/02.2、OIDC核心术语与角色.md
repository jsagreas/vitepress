---
title: 2、OIDC核心术语与角色
---
## 📚 目录

1. [OpenID Connect基本概念](#1-OpenID-Connect基本概念)
2. [OIDC核心角色详解](#2-OIDC核心角色详解)
3. [ID Token深度解析](#3-ID-Token深度解析)
4. [三种Token的区别与作用](#4-三种Token的区别与作用)
5. [用户信息获取机制](#5-用户信息获取机制)
6. [Claims声明系统](#6-Claims声明系统)
7. [Scope在OIDC中的特殊作用](#7-Scope在OIDC中的特殊作用)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🔐 OpenID Connect基本概念


### 1.1 什么是OpenID Connect


**🔸 简单理解**
```
想象你要进入一个高级会所：
- OAuth 2.0：只管你有没有门卡（授权）
- OpenID Connect：不仅要门卡，还要确认你的身份（认证）

通俗说：OAuth 2.0 解决"能不能访问"，OIDC 解决"你是谁"
```

**🔸 本质定义**
- **基础**：建立在OAuth 2.0之上的身份认证协议
- **目的**：让应用程序能够验证用户身份并获取基本信息
- **特点**：在授权的基础上增加了身份验证功能

### 1.2 OIDC与OAuth 2.0的关系


```
┌─────────────────────────────────┐
│         OpenID Connect          │ ← 身份认证层
│  (Who you are + What you can do) │
├─────────────────────────────────┤
│           OAuth 2.0             │ ← 授权框架
│      (What you can access)      │
└─────────────────────────────────┘
```

**🔸 核心区别**
- **OAuth 2.0**：`"这个人可以访问你的照片"`
- **OpenID Connect**：`"这个人是张三，可以访问你的照片"`

---

## 2. 👥 OIDC核心角色详解


### 2.1 End-User（终端用户）


**🔸 通俗理解**
```
就是你我这样的普通用户：
- 想要登录某个网站或APP
- 拥有身份信息（姓名、邮箱等）
- 希望不用到处注册账号
```

**🔸 用户在流程中的行为**
1. 点击"用Google登录"按钮
2. 在Google页面输入用户名密码
3. 同意授权给第三方应用
4. 成功登录到第三方应用

### 2.2 Relying Party (RP)（依赖方）


**🔸 通俗理解**
```
就是那些第三方网站和应用：
- 比如一个在线购物网站
- 不想自己管理用户密码
- 依赖Google/微信等大平台来验证用户身份
```

**🔸 为什么叫"依赖方"**
- **依赖**身份提供商来验证用户
- **依赖**外部平台提供用户信息
- 自己不存储用户的登录凭据

**🔸 RP的典型例子**
```
📱 移动APP：美团、饿了么的"微信登录"
🌐 购物网站：某电商的"支付宝登录"  
🎮 游戏平台：Steam的"Google登录"
💼 企业应用：公司内网的"钉钉登录"
```

### 2.3 OpenID Provider (OP)（身份提供商）


**🔸 通俗理解**
```
就是那些大的身份认证平台：
- Google、微信、支付宝、钉钉等
- 管理着数亿用户的身份信息
- 为其他应用提供身份验证服务
```

**🔸 OP的核心职责**
1. **身份验证**：确认用户是谁
2. **信息提供**：告诉RP用户的基本信息
3. **授权管理**：控制哪些信息可以分享

**🔸 三者关系图示**
```
End-User (用户)                 Relying Party (依赖方)
     │                               │
     │ ①"我要用Google登录"              │
     │────────────────────────────▶│
     │                               │
     │ ②跳转到Google登录页面           │
     │◀────────────────────────────│
     │                               │
     ▼                               │
OpenID Provider (Google)              │
     │                               │  
     │ ③返回用户身份信息                │
     │──────────────────────────────▶│
```

---

## 3. 🎫 ID Token深度解析


### 3.1 ID Token概念


**🔸 生活类比**
```
ID Token 就像你的身份证：
- 证明你是谁（姓名、照片）
- 什么时候颁发的（签发日期）
- 什么时候过期（有效期）
- 由权威机构颁发（政府/身份提供商）
```

**🔸 技术定义**
- **本质**：包含用户身份信息的JWT（JSON Web Token）
- **作用**：证明用户的身份和基本信息
- **特点**：有数字签名，防止篡改

### 3.2 ID Token结构与用途


**🔸 ID Token的组成部分**
```json
{
  "iss": "https://accounts.google.com",     // 谁颁发的
  "sub": "123456789",                       // 用户唯一标识
  "aud": "your-app-id.apps.com",           // 给谁用的
  "exp": 1640995200,                        // 什么时候过期
  "iat": 1640991600,                        // 什么时候颁发
  "name": "张三",                            // 用户姓名
  "email": "zhangsan@gmail.com",           // 用户邮箱
  "picture": "https://lh3.googleusercontent.com/..."  // 头像
}
```

**🔸 每个字段的通俗含义**
- `iss`（发行者）：哪家公司颁发的身份证
- `sub`（主体）：身份证号码（用户唯一ID）
- `aud`（受众）：这个身份证给谁看的
- `exp`（过期时间）：身份证有效期
- `name`：真实姓名
- `email`：联系邮箱

### 3.3 ID Token的用途


**🔸 主要用途**
1. **身份验证**：确认登录的人是谁
2. **信息展示**：在界面上显示用户名和头像
3. **权限判断**：根据用户身份决定功能权限
4. **审计日志**：记录是谁进行了什么操作

**🔸 使用示例**
```javascript
// 解析ID Token获取用户信息
const userInfo = parseJWT(idToken);
console.log(`欢迎 ${userInfo.name}！`);
console.log(`您的邮箱是：${userInfo.email}`);

// 在页面显示用户头像
document.getElementById('avatar').src = userInfo.picture;
```

---

## 4. 🎯 三种Token的区别与作用


### 4.1 ID Token vs Access Token vs Refresh Token


**🔸 生活类比理解**

| Token类型 | **生活类比** | **主要作用** | **使用场景** |
|-----------|------------|-------------|-------------|
| 🆔 **ID Token** | `身份证` | `证明你是谁` | `登录验证，显示用户信息` |
| 🔑 **Access Token** | `门禁卡` | `访问具体资源` | `调用API，访问数据` |
| 🔄 **Refresh Token** | `身份证续期单` | `获取新的访问权限` | `刷新过期的Access Token` |

### 4.2 详细对比分析


**🔸 ID Token（身份令牌）**
```
用途：我是谁？
内容：用户的身份信息（姓名、邮箱、头像等）
有效期：通常较短（几分钟到几小时）
使用方：应用程序（用于显示用户信息）
格式：JWT（可以直接解析）

实际例子：
登录后显示"欢迎 张三"，就是从ID Token中读取的姓名
```

**🔸 Access Token（访问令牌）**
```
用途：我能做什么？
内容：访问权限信息（通常是不透明的字符串）
有效期：通常较短（几分钟到几小时）
使用方：API服务器（用于权限验证）
格式：可能是JWT，也可能是随机字符串

实际例子：
调用"获取用户相册"API时，需要携带Access Token
```

**🔸 Refresh Token（刷新令牌）**
```
用途：如何延续访问权限？
内容：用于获取新Access Token的凭据
有效期：通常较长（几天到几个月）
使用方：应用程序（当Access Token过期时使用）
格式：通常是不透明的字符串

实际例子：
Access Token过期后，用Refresh Token自动获取新的Access Token
```

### 4.3 三种Token的协作流程


```
用户登录流程：
①用户登录 ─▶ ②获得ID Token（知道是谁）
              ③获得Access Token（知道能做什么）
              ④获得Refresh Token（知道如何续期）

使用流程：
⑤显示用户信息（使用ID Token）
⑥调用API（使用Access Token）
⑦Access Token过期 ─▶ ⑧用Refresh Token刷新 ─▶ ⑨获得新Access Token
```

---

## 5. 📡 用户信息获取机制


### 5.1 UserInfo端点概念


**🔸 通俗理解**
```
UserInfo端点就像一个"个人信息查询窗口"：
- 你拿着Access Token（相当于查询凭证）
- 到这个窗口查询用户的详细信息
- 窗口返回用户的完整资料
```

**🔸 为什么需要UserInfo端点**
- **ID Token空间限制**：不能包含所有用户信息
- **动态信息获取**：可以获取最新的用户信息
- **权限控制**：根据权限返回不同详细程度的信息

### 5.2 用户信息获取流程


```
客户端应用                UserInfo端点               身份提供商数据库
     │                        │                         │
     │─[1]携带Access Token─▶│                         │
     │   GET /userinfo        │                         │
     │                        │─[2]验证Token─────────▶│
     │                        │                         │
     │                        │◀─[3]返回用户权限───────│
     │                        │                         │
     │                        │─[4]查询用户信息───────▶│
     │                        │                         │
     │                        │◀─[5]返回详细信息───────│
     │                        │                         │
     │◀─[6]返回用户信息─────│                         │
     │   JSON格式             │                         │
```

### 5.3 UserInfo端点实际使用


**🔸 请求示例**
```http
GET /userinfo HTTP/1.1
Host: accounts.google.com
Authorization: Bearer ya29.a0ARrdaM8j7h2gQ...
```

**🔸 响应示例**
```json
{
  "sub": "123456789",
  "name": "张三",
  "given_name": "三",
  "family_name": "张", 
  "email": "zhangsan@gmail.com",
  "email_verified": true,
  "picture": "https://lh3.googleusercontent.com/a-/AOh14Gi...",
  "locale": "zh-CN",
  "updated_at": 1640991600
}
```

**🔸 代码实现示例**
```javascript
// 获取用户详细信息
async function getUserInfo(accessToken) {
    const response = await fetch('https://accounts.google.com/userinfo', {
        headers: {
            'Authorization': `Bearer ${accessToken}`
        }
    });
    
    const userInfo = await response.json();
    console.log('用户姓名：', userInfo.name);
    console.log('用户邮箱：', userInfo.email);
    
    return userInfo;
}
```

---

## 6. 📋 Claims声明系统


### 6.1 Claims概念


**🔸 通俗理解**
```
Claims就像填写个人信息表的各个字段：
- 姓名字段：name
- 邮箱字段：email  
- 年龄字段：age
- 地址字段：address

每个字段都在"声明"用户的某个属性
```

**🔸 技术定义**
- **本质**：关于用户的一条信息声明
- **格式**：键值对形式，如 `"name": "张三"`
- **作用**：描述用户的各种属性和特征

### 6.2 Claims分类


**🔸 标准Claims（所有OIDC都支持）**

| Claim名称 | **中文含义** | **示例值** | **用途** |
|-----------|------------|----------|---------|
| `sub` | `用户唯一标识` | `"123456789"` | `区分不同用户` |
| `name` | `完整姓名` | `"张三"` | `显示用户姓名` |
| `email` | `邮箱地址` | `"user@example.com"` | `联系和验证` |
| `picture` | `头像URL` | `"https://example.com/avatar.jpg"` | `显示用户头像` |
| `given_name` | `名字` | `"三"` | `称呼用户` |
| `family_name` | `姓氏` | `"张"` | `正式场合使用` |

**🔸 自定义Claims（各平台扩展）**
```json
{
  "company": "阿里巴巴",           // 工作单位
  "department": "技术部",          // 部门
  "employee_id": "E001234",       // 员工号
  "role": "senior_developer",     // 职位角色
  "access_level": "level_3"       // 权限等级
}
```

### 6.3 Claims的获取方式


**🔸 两种获取途径**
1. **从ID Token中获取**：基本信息，空间有限
2. **从UserInfo端点获取**：详细信息，内容丰富

**🔸 对比示例**
```javascript
// 方式1：从ID Token获取基本Claims
const basicInfo = parseJWT(idToken);
console.log(basicInfo.name);  // "张三"
console.log(basicInfo.email); // "user@example.com"

// 方式2：从UserInfo端点获取详细Claims
const detailInfo = await getUserInfo(accessToken);
console.log(detailInfo.address);     // 详细地址
console.log(detailInfo.phone_number); // 手机号码
console.log(detailInfo.birthdate);   // 生日
```

---

## 7. 🎯 Scope在OIDC中的特殊作用


### 7.1 Scope概念回顾


**🔸 生活类比**
```
Scope就像不同级别的会员卡：
- 普通会员：只能看基本信息
- VIP会员：可以看详细信息  
- 超级VIP：可以看所有信息

应用程序申请什么级别，就能获得对应的用户信息
```

### 7.2 OIDC中的标准Scope


**🔸 openid（必须的基础Scope）**
```
含义：这是一个OpenID Connect请求（不是纯OAuth 2.0）
效果：会返回ID Token
包含Claims：sub（用户唯一标识）

没有这个Scope，就不是OIDC请求！
```

**🔸 profile（个人资料Scope）**
```
含义：请求访问用户的基本个人资料
包含Claims：
- name（姓名）
- family_name（姓氏） 
- given_name（名字）
- picture（头像）
- gender（性别）
- birthdate（生日）
- locale（语言设置）
```

**🔸 email（邮箱Scope）**
```
含义：请求访问用户的邮箱信息
包含Claims：
- email（邮箱地址）
- email_verified（邮箱是否已验证）
```

**🔸 phone（电话Scope）**
```
含义：请求访问用户的电话信息
包含Claims：
- phone_number（电话号码）
- phone_number_verified（电话是否已验证）
```

### 7.3 Scope的实际应用


**🔸 权限申请示例**
```javascript
// 基础登录：只要用户身份
const basicScope = 'openid';

// 显示用户信息：要姓名和头像
const profileScope = 'openid profile';

// 发送邮件功能：需要邮箱权限
const emailScope = 'openid profile email';

// 完整用户信息：申请所有标准权限
const fullScope = 'openid profile email phone address';
```

**🔸 授权URL示例**
```
基础授权URL：
https://accounts.google.com/oauth/authorize?
  client_id=your-app-id&
  scope=openid profile email&          ← 指定需要的权限范围
  response_type=code&
  redirect_uri=https://your-app.com/callback

用户看到的授权页面：
┌─────────────────────────────┐
│  应用 "购物助手" 请求权限：    │
│  ✓ 查看您的基本信息          │  ← profile scope
│  ✓ 查看您的邮箱地址          │  ← email scope
│  □ 查看您的电话号码          │  ← 未申请phone scope
│                             │
│    [同意]    [拒绝]         │
└─────────────────────────────┘
```

### 7.4 Scope与Claims的对应关系


**🔸 权限映射表**

| Scope | **用户看到的权限** | **可获得的Claims** | **典型用途** |
|-------|-------------------|-------------------|-------------|
| `openid` | `基本身份验证` | `sub` | `确认用户身份` |
| `profile` | `查看基本资料` | `name, picture, gender` | `个性化界面显示` |
| `email` | `查看邮箱地址` | `email, email_verified` | `邮件通知，账号关联` |
| `phone` | `查看电话号码` | `phone_number, phone_number_verified` | `短信验证，紧急联系` |

**🔸 实际获取示例**
```javascript
// 用户授权了 "openid profile email"
const idToken = {
    "sub": "123456789",           // openid scope 提供
    "name": "张三",                // profile scope 提供  
    "picture": "https://...",     // profile scope 提供
    "email": "user@example.com",  // email scope 提供
    "email_verified": true        // email scope 提供
    // 注意：没有phone_number，因为没申请phone scope
};
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的基本概念


```
🔸 OpenID Connect：在OAuth 2.0基础上添加身份认证功能
🔸 三大角色：用户(End-User)、应用(RP)、身份提供商(OP)  
🔸 ID Token：包含用户身份信息的数字证书
🔸 UserInfo端点：获取详细用户信息的API接口
🔸 Claims：用户的各种属性声明（姓名、邮箱等）
🔸 Scope：控制可获取的用户信息范围
```

### 8.2 关键理解要点


**🔹 ID Token vs Access Token的本质区别**
```
ID Token回答：你是谁？（用于身份验证）
Access Token回答：你能做什么？（用于资源访问）

记忆方法：
ID = Identity（身份）→ 证明身份用
Access = 访问权限 → 访问资源用
```

**🔹 为什么需要UserInfo端点**
```
ID Token的限制：
- 大小有限制，不能包含所有信息
- 一次性获取，无法更新

UserInfo端点的优势：
- 可以获取详细信息
- 信息实时更新
- 根据权限返回不同内容
```

**🔹 Scope在OIDC中的特殊性**
```
普通OAuth 2.0的scope：控制API访问权限
OIDC中的scope：控制用户信息获取范围

openid scope是必须的，没有它就不是OIDC请求！
```

### 8.3 实际应用指导


**🔸 选择合适的Scope策略**
- ✅ **最小权限原则**：只申请必需的用户信息
- ✅ **用户体验优先**：避免申请过多权限吓跑用户
- ✅ **功能需求匹配**：根据实际功能需要申请对应scope

**🔸 安全使用建议**
- 🔒 **验证ID Token签名**：确保token未被篡改
- 🔒 **检查token有效期**：避免使用过期token
- 🔒 **验证audience字段**：确保token是给自己应用的
- 🔒 **HTTPS传输**：所有token传输必须加密

### 8.4 常见应用场景


**🔸 单点登录(SSO)**
```
场景：用户用Google账号登录多个网站
核心：ID Token提供统一身份信息
优势：一次登录，到处使用
```

**🔸 社交登录**
```  
场景：第三方网站的"微信登录"功能
核心：获取用户基本信息（头像、昵称）
优势：降低注册门槛，提升用户体验
```

**🔸 个性化服务**
```
场景：根据用户信息提供定制化功能
核心：通过Claims获取用户偏好信息
优势：提供更好的个性化体验
```

**核心记忆口诀**：
- OIDC身份认证，三角色要分清
- ID令牌证身份，Access令牌管权限  
- UserInfo详信息，Claims属性表
- Scope控制范围，openid是必须
- 安全验证签名，HTTPS保传输