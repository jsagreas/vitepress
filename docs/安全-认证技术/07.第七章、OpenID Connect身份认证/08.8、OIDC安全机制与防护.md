---
title: 8ã€OIDCå®‰å…¨æœºåˆ¶ä¸é˜²æŠ¤
---
## ğŸ“š ç›®å½•

1. [OIDCå®‰å…¨æ¦‚è¿°](#1-OIDCå®‰å…¨æ¦‚è¿°)
2. [PKCEé˜²æŠ¤æœºåˆ¶è¯¦è§£](#2-PKCEé˜²æŠ¤æœºåˆ¶è¯¦è§£)
3. [Nonceå‚æ•°é˜²é‡æ”¾æ”»å‡»](#3-Nonceå‚æ•°é˜²é‡æ”¾æ”»å‡»)
4. [Stateå‚æ•°é˜²CSRFæ”»å‡»](#4-Stateå‚æ•°é˜²CSRFæ”»å‡»)
5. [Tokenç®¡ç†å®‰å…¨ç­–ç•¥](#5-Tokenç®¡ç†å®‰å…¨ç­–ç•¥)
6. [HTTPSä¸ä¼ è¾“å®‰å…¨](#6-HTTPSä¸ä¼ è¾“å®‰å…¨)
7. [é‡å®šå‘URIå®‰å…¨éªŒè¯](#7-é‡å®šå‘URIå®‰å…¨éªŒè¯)
8. [å¸¸è§OIDCæ”»å‡»ä¸é˜²æŠ¤](#8-å¸¸è§OIDCæ”»å‡»ä¸é˜²æŠ¤)
9. [å®‰å…¨å®è·µæ€»ç»“](#9-å®‰å…¨å®è·µæ€»ç»“)

---

## 1. ğŸ” OIDCå®‰å…¨æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯OIDCå®‰å…¨


**ç®€å•ç†è§£**ï¼šOIDCå®‰å…¨å°±æ˜¯ä¿æŠ¤èº«ä»½è®¤è¯è¿‡ç¨‹ä¸è¢«åäººé’»ç©ºå­

```
å¥½æ¯”ä½ å»é“¶è¡Œå–é’±çš„å®‰å…¨æµç¨‹ï¼š
1. èº«ä»½è¯éªŒè¯ â†’ OIDCèº«ä»½è®¤è¯
2. å¯†ç è¾“å…¥ â†’ ç”¨æˆ·å‡­è¯éªŒè¯  
3. çŸ­ä¿¡éªŒè¯ç  â†’ å¤šé‡éªŒè¯æœºåˆ¶
4. å–é’±å‡­æ¡ â†’ Tokenä»¤ç‰Œ
5. ç›‘æ§æ‘„åƒå¤´ â†’ å®‰å…¨æ—¥å¿—è®°å½•

æ¯ä¸ªç¯èŠ‚éƒ½è¦ç¡®ä¿å®‰å…¨ï¼
```

### 1.2 OIDCå®‰å…¨å¨èƒæ¨¡å‹


**ğŸ¯ ä¸»è¦å®‰å…¨é£é™©**

| å¨èƒç±»å‹ | **ç®€å•ç†è§£** | **å±å®³ç¨‹åº¦** | **é˜²æŠ¤é‡ç‚¹** |
|---------|------------|-------------|-------------|
| ğŸ”“ **TokenåŠ«æŒ** | `åäººå·èµ°ä½ çš„é€šè¡Œè¯` | `æé«˜` | `å®‰å…¨å­˜å‚¨å’Œä¼ è¾“` |
| ğŸ­ **èº«ä»½å†’å……** | `åäººå‡æ‰®æˆä½ ` | `æé«˜` | `èº«ä»½éªŒè¯å¼ºåŒ–` |
| ğŸ”„ **é‡æ”¾æ”»å‡»** | `åäººé‡å¤ä½¿ç”¨æ—§è¯·æ±‚` | `é«˜` | `Nonceé˜²æŠ¤` |
| âš¡ **CSRFæ”»å‡»** | `åäººè¯±éª—ä½ ç‚¹å‡»æ¶æ„é“¾æ¥` | `é«˜` | `Stateå‚æ•°éªŒè¯` |
| ğŸ“± **ç§»åŠ¨ç«¯åŠ«æŒ** | `æ¶æ„Appå·å–è®¤è¯ä¿¡æ¯` | `ä¸­` | `PKCEå¼ºåŒ–` |

### 1.3 OIDCå®‰å…¨æ¶æ„å›¾


```
ç”¨æˆ·æµè§ˆå™¨                    åº”ç”¨æœåŠ¡å™¨                  è®¤è¯æœåŠ¡å™¨
     |                           |                           |
     |--[1]è®¿é—®ä¿æŠ¤èµ„æº---------->|                           |
     |<--[2]é‡å®šå‘åˆ°è®¤è¯é¡µé¢------|                           |
     |                           |                           |
     |--[3]ç”¨æˆ·ç™»å½•éªŒè¯-------------------------->|[ğŸ”å®‰å…¨æ£€æŸ¥]
     |<--[4]æˆæƒç +State--------------------------|           |
     |                           |                           |
     |--[5]æäº¤æˆæƒç ----------->|--[6]éªŒè¯+è·å–Token------>|[ğŸ›¡ï¸é˜²æŠ¤]
     |<--[7]è¿”å›ç”¨æˆ·ä¿¡æ¯---------|<--[8]ID Token+Access-----|
```

---

## 2. ğŸ›¡ï¸ PKCEé˜²æŠ¤æœºåˆ¶è¯¦è§£


### 2.1 ä»€ä¹ˆæ˜¯PKCE


**PKCE**å…¨ç§°ï¼š**Proof Key for Code Exchange**ï¼ˆæˆæƒç äº¤æ¢çš„éªŒè¯å¯†é’¥ï¼‰

**é€šä¿—ç†è§£**ï¼šå°±åƒå–å¿«é€’çš„éªŒè¯ç 

```
ä¼ ç»Ÿå–å¿«é€’ï¼š                    PKCEæœºåˆ¶ï¼š
åªéœ€è¦èº«ä»½è¯ â†’ ä¸å¤Ÿå®‰å…¨          èº«ä»½è¯ + å–è´§éªŒè¯ç  â†’ æ›´å®‰å…¨

åäººå¯èƒ½ï¼š                      åäººæ— æ³•ï¼š
- å·çœ‹èº«ä»½è¯å·ç                 - å³ä½¿çŸ¥é“èº«ä»½è¯ï¼Œæ²¡æœ‰éªŒè¯ç ä¹Ÿå–ä¸åˆ°
- å‡å†’èº«ä»½å–è´§                  - éªŒè¯ç æ˜¯éšæœºç”Ÿæˆï¼Œæ— æ³•ä¼ªé€ 
```

### 2.2 PKCEå·¥ä½œåŸç†


**ğŸ”§ PKCEå®‰å…¨æµç¨‹**

```
ç¬¬1æ­¥ï¼šç”Ÿæˆéšæœºå¯†é’¥
Appç”Ÿæˆéšæœºå­—ç¬¦ä¸² code_verifier = "abc123xyz789..."
è®¡ç®—å“ˆå¸Œå€¼ code_challenge = SHA256(code_verifier)

ç¬¬2æ­¥ï¼šæˆæƒè¯·æ±‚
https://auth.server.com/authorize?
  client_id=your_app&
  redirect_uri=https://yourapp.com/callback&
  code_challenge=hash_value&      â† å‘é€å“ˆå¸Œå€¼
  code_challenge_method=S256

ç¬¬3æ­¥ï¼šéªŒè¯äº¤æ¢
POST https://auth.server.com/token
{
  "grant_type": "authorization_code",
  "code": "auth_code_from_step2",
  "code_verifier": "abc123xyz789..."  â† å‘é€åŸå§‹å€¼
}

ç¬¬4æ­¥ï¼šæœåŠ¡å™¨éªŒè¯
if (SHA256(code_verifier) == code_challenge) {
  // éªŒè¯é€šè¿‡ï¼Œè¿”å›Token
} else {
  // éªŒè¯å¤±è´¥ï¼Œæ‹’ç»è¯·æ±‚
}
```

### 2.3 PKCEå¼ºåˆ¶ä½¿ç”¨åœºæ™¯


**ğŸ“± å•é¡µåº”ç”¨ï¼ˆSPAï¼‰å¿…é¡»ä½¿ç”¨PKCE**

```javascript
// SPAä¸­çš„PKCEå®ç°ç¤ºä¾‹
class OIDCClient {
    generatePKCE() {
        // ç”ŸæˆéšæœºéªŒè¯å­—ç¬¦ä¸²
        const codeVerifier = this.generateRandomString(128);
        
        // è®¡ç®—æŒ‘æˆ˜å€¼
        const codeChallenge = btoa(
            String.fromCharCode.apply(null, 
                new Uint8Array(
                    crypto.subtle.digest('SHA-256', 
                        new TextEncoder().encode(codeVerifier)
                    )
                )
            )
        ).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        
        return { codeVerifier, codeChallenge };
    }
    
    startAuth() {
        const { codeVerifier, codeChallenge } = this.generatePKCE();
        
        // ä¿å­˜verifierï¼ˆåˆ·æ–°é¡µé¢åéœ€è¦ç”¨åˆ°ï¼‰
        sessionStorage.setItem('pkce_verifier', codeVerifier);
        
        // æ„å»ºæˆæƒURL
        const authUrl = `${this.authServer}/authorize?` + 
            `client_id=${this.clientId}&` +
            `redirect_uri=${this.redirectUri}&` +
            `code_challenge=${codeChallenge}&` +
            `code_challenge_method=S256&` +
            `response_type=code&scope=openid profile`;
        
        window.location.href = authUrl;
    }
}
```

### 2.4 ä¸ºä»€ä¹ˆç§»åŠ¨ç«¯å¿…é¡»ç”¨PKCE


**ğŸ” ç§»åŠ¨ç«¯å®‰å…¨å¨èƒ**

```
å¨èƒåœºæ™¯ï¼šæ¶æ„AppåŠ«æŒ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä½ çš„åˆæ³•App        â”‚    â”‚   æ¶æ„App           â”‚
â”‚                    â”‚    â”‚                    â”‚
â”‚ 1.å‘èµ·è®¤è¯è¯·æ±‚      â”‚    â”‚ 2.ç›‘å¬ç³»ç»ŸIntent    â”‚
â”‚ 2.è·³è½¬åˆ°æµè§ˆå™¨      â”‚    â”‚ 3.æˆªè·æˆæƒç         â”‚
â”‚ 3.ç”¨æˆ·å®Œæˆè®¤è¯      â”‚    â”‚ 4.å†’å……åˆæ³•App      â”‚
â”‚ 4.æµè§ˆå™¨è¿”å›æˆæƒç    â”‚ â†â”€ â”‚ 5.è·å–ç”¨æˆ·Token    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ²¡æœ‰PKCEï¼šæ¶æ„Appå¯ä»¥ç”¨æˆªè·çš„æˆæƒç æ¢å–Token
æœ‰äº†PKCEï¼šæ¶æ„Appæ²¡æœ‰code_verifierï¼Œæ— æ³•å®Œæˆäº¤æ¢
```

**ğŸ’¡ PKCEé˜²æŠ¤æ•ˆæœ**

```
ä¼ ç»Ÿæµç¨‹ï¼ˆä¸å®‰å…¨ï¼‰ï¼š
æˆæƒç  â†’ ç›´æ¥æ¢Token âŒ

PKCEæµç¨‹ï¼ˆå®‰å…¨ï¼‰ï¼š
æˆæƒç  + éªŒè¯å¯†é’¥ â†’ æ¢Token âœ…

å¥½æ¯”ï¼š
æˆ¿é—¨é’¥åŒ™ VS æˆ¿é—¨é’¥åŒ™+æŒ‡çº¹è¯†åˆ«
```

---

## 3. ğŸ”„ Nonceå‚æ•°é˜²é‡æ”¾æ”»å‡»


### 3.1 ä»€ä¹ˆæ˜¯é‡æ”¾æ”»å‡»


**é€šä¿—ç†è§£**ï¼šåäººå½•ä¸‹ä½ è¯´çš„è¯ï¼Œé‡å¤æ’­æ”¾æ¥å†’å……ä½ 

```
ç”Ÿæ´»ä¾‹å­ï¼š
ä½ å¯¹é—¨ç¦è¯´"èŠéº»å¼€é—¨"â†’ é—¨å¼€äº†
åäººå½•éŸ³é‡å¤æ’­æ”¾"èŠéº»å¼€é—¨"â†’ é—¨åˆå¼€äº† âŒ

æŠ€æœ¯ä¾‹å­ï¼š
ç”¨æˆ·ç™»å½•è¯·æ±‚ â†’ æˆåŠŸè®¤è¯
é»‘å®¢é‡å¤å‘é€ç›¸åŒè¯·æ±‚ â†’ å¯èƒ½å†æ¬¡æˆåŠŸ âŒ
```

### 3.2 Nonceå·¥ä½œåŸç†


**Nonce** = **N**umber used **once**ï¼ˆåªç”¨ä¸€æ¬¡çš„æ•°å­—ï¼‰

**ğŸ”’ Nonceé˜²æŠ¤æœºåˆ¶**

```
ç¬¬1æ­¥ï¼šå®¢æˆ·ç«¯ç”Ÿæˆå”¯ä¸€æ ‡è¯†
nonce = "éšæœºå­—ç¬¦ä¸²_å½“å‰æ—¶é—´æˆ³_ç”¨æˆ·ID"
ä¾‹å¦‚ï¼šnonce = "abc123_1703234567_user001"

ç¬¬2æ­¥ï¼šå‘é€è®¤è¯è¯·æ±‚
https://auth.server.com/authorize?
  client_id=your_app&
  nonce=abc123_1703234567_user001&    â† åŒ…å«nonce
  response_type=id_token&
  scope=openid

ç¬¬3æ­¥ï¼šæœåŠ¡å™¨éªŒè¯å¹¶ç»‘å®šnonce
æœåŠ¡å™¨è®°å½•ï¼šè¿™ä¸ªnonceå·²ç»ä½¿ç”¨è¿‡äº†
ID Tokenä¸­åŒ…å«ç›¸åŒçš„nonceå€¼

ç¬¬4æ­¥ï¼šå®¢æˆ·ç«¯éªŒè¯
æ”¶åˆ°ID Tokenåï¼Œæ£€æŸ¥nonceæ˜¯å¦åŒ¹é…
if (token.nonce === sent_nonce) {
  // éªŒè¯é€šè¿‡ï¼Œè¿™æ˜¯æ–°é²œçš„å“åº”
} else {
  // å¯èƒ½æ˜¯é‡æ”¾æ”»å‡»ï¼Œæ‹’ç»
}
```

### 3.3 Nonceå®ç°ç¤ºä¾‹


```javascript
class NonceManager {
    generateNonce() {
        // ç”Ÿæˆå”¯ä¸€çš„nonceå€¼
        const timestamp = Date.now();
        const random = Math.random().toString(36).substring(2);
        const userId = this.getCurrentUserId();
        
        return `${random}_${timestamp}_${userId}`;
    }
    
    storeNonce(nonce) {
        // å­˜å‚¨nonceï¼ˆç”¨äºåç»­éªŒè¯ï¼‰
        const expiry = Date.now() + (5 * 60 * 1000); // 5åˆ†é’Ÿè¿‡æœŸ
        sessionStorage.setItem(`nonce_${nonce}`, expiry.toString());
    }
    
    validateNonce(receivedNonce) {
        const stored = sessionStorage.getItem(`nonce_${receivedNonce}`);
        
        if (!stored) {
            console.error('Nonceæœªæ‰¾åˆ°ï¼Œå¯èƒ½æ˜¯é‡æ”¾æ”»å‡»');
            return false;
        }
        
        if (Date.now() > parseInt(stored)) {
            console.error('Nonceå·²è¿‡æœŸ');
            return false;
        }
        
        // ä½¿ç”¨åç«‹å³åˆ é™¤ï¼ˆç¡®ä¿åªç”¨ä¸€æ¬¡ï¼‰
        sessionStorage.removeItem(`nonce_${receivedNonce}`);
        return true;
    }
}

// ä½¿ç”¨ç¤ºä¾‹
const nonceManager = new NonceManager();

// å‘èµ·è®¤è¯å‰
const nonce = nonceManager.generateNonce();
nonceManager.storeNonce(nonce);

// æ”¶åˆ°ID Tokenå
const idToken = parseJWT(response.id_token);
if (nonceManager.validateNonce(idToken.nonce)) {
    console.log('è®¤è¯å“åº”æœ‰æ•ˆ');
} else {
    console.error('ç–‘ä¼¼é‡æ”¾æ”»å‡»ï¼Œæ‹’ç»å¤„ç†');
}
```

### 3.4 Nonceæœ€ä½³å®è·µ


**âš¡ Nonceå®‰å…¨è¦ç‚¹**

```
âœ… å¿…é¡»åšçš„ï¼š
- æ¯æ¬¡è¯·æ±‚ç”Ÿæˆæ–°çš„nonce
- nonceè¦è¶³å¤Ÿéšæœºï¼Œéš¾ä»¥é¢„æµ‹
- æœåŠ¡å™¨å¿…é¡»éªŒè¯nonceå”¯ä¸€æ€§
- ä½¿ç”¨åç«‹å³æ ‡è®°ä¸ºå·²ç”¨
- è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´

âŒ ä¸èƒ½åšçš„ï¼š
- é‡å¤ä½¿ç”¨ç›¸åŒçš„nonce
- nonceåŒ…å«æ•æ„Ÿä¿¡æ¯
- å¿½ç•¥nonceéªŒè¯
- nonceæ°¸ä¸è¿‡æœŸ
```

---

## 4. âš¡ Stateå‚æ•°é˜²CSRFæ”»å‡»


### 4.1 ä»€ä¹ˆæ˜¯CSRFæ”»å‡»


**CSRF**å…¨ç§°ï¼š**Cross-Site Request Forgery**ï¼ˆè·¨ç«™è¯·æ±‚ä¼ªé€ ï¼‰

**é€šä¿—ç†è§£**ï¼šåäººè¯±éª—ä½ åœ¨ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹åšäº‹æƒ…

```
ç”Ÿæ´»ä¾‹å­ï¼š
ä½ ç™»å½•äº†ç½‘é“¶ï¼Œè¿˜æ²¡é€€å‡º
åäººå‘ç»™ä½ ä¸€ä¸ª"æç¬‘å›¾ç‰‡"é“¾æ¥
ä½ ç‚¹å‡»åï¼Œå®é™…ä¸Šæ˜¯è½¬è´¦ç»™åäººçš„é“¾æ¥
å› ä¸ºä½ è¿˜åœ¨ç™»å½•çŠ¶æ€ï¼Œè½¬è´¦æˆåŠŸäº† âŒ

OIDCåœºæ™¯ï¼š
ä½ æ­£åœ¨ç™»å½•æŸä¸ªç½‘ç«™
åäººå‘ç»™ä½ æ¶æ„é“¾æ¥ï¼ŒåŒ…å«ä¼ªé€ çš„æˆæƒç 
ä½ ç‚¹å‡»åï¼Œåäººå¯èƒ½è·å–ä½ çš„èº«ä»½ä¿¡æ¯ âŒ
```

### 4.2 Stateå‚æ•°å·¥ä½œåŸç†


**Stateå‚æ•°**ï¼šå®¢æˆ·ç«¯ç”Ÿæˆçš„éšæœºå­—ç¬¦ä¸²ï¼Œç”¨æ¥éªŒè¯å“åº”çš„åˆæ³•æ€§

**ğŸ” Stateé˜²æŠ¤æµç¨‹**

```
ç¬¬1æ­¥ï¼šå®¢æˆ·ç«¯ç”ŸæˆState
state = generateRandomString()
ä¾‹å¦‚ï¼šstate = "xyz789_é˜²æŠ¤æ ‡è¯†"

ç¬¬2æ­¥ï¼šå­˜å‚¨Stateå¹¶å‘èµ·è¯·æ±‚
sessionStorage.setItem('oauth_state', state);

https://auth.server.com/authorize?
  client_id=your_app&
  state=xyz789_é˜²æŠ¤æ ‡è¯†&           â† åŒ…å«state
  redirect_uri=https://yourapp.com/callback&
  response_type=code

ç¬¬3æ­¥ï¼šè®¤è¯æœåŠ¡å™¨åŸæ ·è¿”å›State
https://yourapp.com/callback?
  code=æˆæƒç &
  state=xyz789_é˜²æŠ¤æ ‡è¯†            â† åŸæ ·è¿”å›

ç¬¬4æ­¥ï¼šå®¢æˆ·ç«¯éªŒè¯State
const receivedState = getUrlParam('state');
const storedState = sessionStorage.getItem('oauth_state');

if (receivedState === storedState) {
  // éªŒè¯é€šè¿‡ï¼Œè¿™æ˜¯æˆ‘ä»¬å‘èµ·çš„è¯·æ±‚
  processAuthCode();
} else {
  // å¯èƒ½æ˜¯CSRFæ”»å‡»ï¼Œæ‹’ç»å¤„ç†
  alert('å®‰å…¨éªŒè¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•');
}
```

### 4.3 Stateå®ç°ç¤ºä¾‹


```javascript
class CSRFProtection {
    generateState() {
        // ç”Ÿæˆéšæœºstateå€¼
        const array = new Uint8Array(32);
        crypto.getRandomValues(array);
        return Array.from(array, byte => 
            byte.toString(16).padStart(2, '0')
        ).join('');
    }
    
    storeState(state) {
        // å­˜å‚¨stateï¼ˆå¸¦è¿‡æœŸæ—¶é—´ï¼‰
        const expiry = Date.now() + (10 * 60 * 1000); // 10åˆ†é’Ÿ
        sessionStorage.setItem('oauth_state', state);
        sessionStorage.setItem('oauth_state_expiry', expiry.toString());
    }
    
    validateState(receivedState) {
        const storedState = sessionStorage.getItem('oauth_state');
        const expiry = sessionStorage.getItem('oauth_state_expiry');
        
        // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
        if (!expiry || Date.now() > parseInt(expiry)) {
            console.error('Stateå·²è¿‡æœŸ');
            this.clearState();
            return false;
        }
        
        // æ£€æŸ¥æ˜¯å¦åŒ¹é…
        if (receivedState !== storedState) {
            console.error('Stateä¸åŒ¹é…ï¼Œå¯èƒ½æ˜¯CSRFæ”»å‡»');
            this.clearState();
            return false;
        }
        
        // éªŒè¯é€šè¿‡ï¼Œæ¸…ç†state
        this.clearState();
        return true;
    }
    
    clearState() {
        sessionStorage.removeItem('oauth_state');
        sessionStorage.removeItem('oauth_state_expiry');
    }
}

// ä½¿ç”¨ç¤ºä¾‹
const csrf = new CSRFProtection();

// å‘èµ·OAuthè®¤è¯
function startOAuth() {
    const state = csrf.generateState();
    csrf.storeState(state);
    
    const authUrl = `${authServer}/authorize?` +
        `client_id=${clientId}&` +
        `state=${state}&` +
        `redirect_uri=${redirectUri}&` +
        `response_type=code&scope=openid`;
    
    window.location.href = authUrl;
}

// å¤„ç†å›è°ƒ
function handleCallback() {
    const urlParams = new URLSearchParams(window.location.search);
    const receivedState = urlParams.get('state');
    const authCode = urlParams.get('code');
    
    if (!csrf.validateState(receivedState)) {
        alert('å®‰å…¨éªŒè¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•');
        return;
    }
    
    // å®‰å…¨éªŒè¯é€šè¿‡ï¼Œå¤„ç†æˆæƒç 
    exchangeCodeForTokens(authCode);
}
```

### 4.4 CSRFæ”»å‡»é˜²æŠ¤æ•ˆæœ


**ğŸ›¡ï¸ æœ‰State vs æ²¡æœ‰State**

```
æ²¡æœ‰Stateé˜²æŠ¤ï¼š
æ¶æ„ç½‘ç«™ â†’ ä¼ªé€ å›è°ƒè¯·æ±‚ â†’ åº”ç”¨æ¥å— âŒ

æœ‰Stateé˜²æŠ¤ï¼š
æ¶æ„ç½‘ç«™ â†’ ä¼ªé€ å›è°ƒè¯·æ±‚ â†’ Stateä¸åŒ¹é… â†’ æ‹’ç» âœ…

é˜²æŠ¤åŸç†ï¼š
åªæœ‰å‘èµ·è¯·æ±‚çš„å®¢æˆ·ç«¯æ‰çŸ¥é“æ­£ç¡®çš„stateå€¼
æ¶æ„ç½‘ç«™æ— æ³•çŒœåˆ°éšæœºç”Ÿæˆçš„state
```

---

## 5. ğŸ”„ Tokenç®¡ç†å®‰å…¨ç­–ç•¥


### 5.1 Tokenç±»å‹ä¸ç”Ÿå‘½å‘¨æœŸ


**ğŸ¯ OIDC Tokenå®¶æ—**

```
Tokenç±»å‹è¯´æ˜ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Tokenç±»å‹    â”‚ ç”¨é€”       â”‚ ç”Ÿå‘½å‘¨æœŸ     â”‚ å®‰å…¨è¦æ±‚       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ID Token     â”‚ èº«ä»½ä¿¡æ¯   â”‚ çŸ­æœŸ(15-60åˆ†) â”‚ ç­¾åéªŒè¯å¿…é¡»   â”‚
â”‚ Access Token â”‚ APIè®¿é—®    â”‚ çŸ­æœŸ(1-24å°æ—¶) â”‚ åŠ å¯†ä¼ è¾“       â”‚
â”‚ Refresh Tokenâ”‚ åˆ·æ–°è®¿é—®   â”‚ é•¿æœŸ(å¤©/æœˆ)   â”‚ é«˜å®‰å…¨å­˜å‚¨     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”Ÿå‘½å‘¨æœŸå›¾ç¤ºï¼š
æ—¶é—´çº¿: 0min â”€â”€â”€â”€ 15min â”€â”€â”€â”€ 60min â”€â”€â”€â”€ 24h â”€â”€â”€â”€ 7day â”€â”€â”€â”€ 30day
       â”‚        â”‚         â”‚        â”‚       â”‚         â”‚
ID Token: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘
Access:   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘
Refresh:  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
```

### 5.2 Tokenè¿‡æœŸç­–ç•¥


**â° æ™ºèƒ½è¿‡æœŸç®¡ç†**

```javascript
class TokenManager {
    constructor() {
        this.tokens = {
            idToken: null,
            accessToken: null,
            refreshToken: null
        };
        
        this.expiryTimes = {
            idToken: null,
            accessToken: null,
            refreshToken: null
        };
    }
    
    storeTokens(tokenResponse) {
        const now = Date.now();
        
        // å­˜å‚¨Tokenå’Œè¿‡æœŸæ—¶é—´
        this.tokens.idToken = tokenResponse.id_token;
        this.tokens.accessToken = tokenResponse.access_token;
        this.tokens.refreshToken = tokenResponse.refresh_token;
        
        // è®¡ç®—è¿‡æœŸæ—¶é—´ï¼ˆæå‰5åˆ†é’Ÿåˆ·æ–°ï¼‰
        this.expiryTimes.idToken = now + (15 * 60 * 1000);
        this.expiryTimes.accessToken = now + ((tokenResponse.expires_in - 300) * 1000);
        this.expiryTimes.refreshToken = now + (30 * 24 * 60 * 60 * 1000); // 30å¤©
    }
    
    async getValidAccessToken() {
        const now = Date.now();
        
        // æ£€æŸ¥Access Tokenæ˜¯å¦å³å°†è¿‡æœŸ
        if (this.expiryTimes.accessToken > now) {
            return this.tokens.accessToken;
        }
        
        // å°è¯•åˆ·æ–°Token
        if (this.tokens.refreshToken && this.expiryTimes.refreshToken > now) {
            await this.refreshTokens();
            return this.tokens.accessToken;
        }
        
        // Refresh Tokenä¹Ÿè¿‡æœŸäº†ï¼Œéœ€è¦é‡æ–°ç™»å½•
        throw new Error('éœ€è¦é‡æ–°ç™»å½•');
    }
    
    async refreshTokens() {
        try {
            const response = await fetch('/token/refresh', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    refresh_token: this.tokens.refreshToken
                })
            });
            
            const newTokens = await response.json();
            this.storeTokens(newTokens);
            
        } catch (error) {
            console.error('Tokenåˆ·æ–°å¤±è´¥:', error);
            this.clearTokens();
            throw error;
        }
    }
    
    clearTokens() {
        this.tokens = { idToken: null, accessToken: null, refreshToken: null };
        this.expiryTimes = { idToken: null, accessToken: null, refreshToken: null };
    }
}
```

### 5.3 Tokenå®‰å…¨å­˜å‚¨æœ€ä½³å®è·µ


**ğŸ“¦ å­˜å‚¨æ–¹æ¡ˆå¯¹æ¯”**

| å­˜å‚¨ä½ç½® | **å®‰å…¨æ€§** | **æŒä¹…æ€§** | **è·¨æ ‡ç­¾é¡µ** | **æ¨èç”¨é€”** |
|---------|-----------|-----------|-------------|-------------|
| ğŸ§  **å†…å­˜å˜é‡** | `æé«˜` | `å·®` | `ä¸å…±äº«` | `ä¸´æ—¶Token` |
| ğŸª **HttpOnly Cookie** | `é«˜` | `å¥½` | `å…±äº«` | `Refresh Token` |
| ğŸ’¾ **SessionStorage** | `ä¸­` | `ä¸­` | `ä¸å…±äº«` | `Access Token` |
| ğŸª **LocalStorage** | `ä½` | `æå¥½` | `å…±äº«` | `ä¸æ¨è` |

**ğŸ” å®‰å…¨å­˜å‚¨å®ç°**

```javascript
class SecureTokenStorage {
    // æ–¹æ¡ˆ1ï¼šå†…å­˜å­˜å‚¨ï¼ˆæœ€å®‰å…¨ä½†ä¸æŒä¹…ï¼‰
    storeInMemory(tokens) {
        // å­˜å‚¨åœ¨é—­åŒ…ä¸­ï¼Œå¤–éƒ¨æ— æ³•ç›´æ¥è®¿é—®
        let privateTokens = { ...tokens };
        
        return {
            getAccessToken: () => privateTokens.accessToken,
            getRefreshToken: () => privateTokens.refreshToken,
            clear: () => { privateTokens = {}; }
        };
    }
    
    // æ–¹æ¡ˆ2ï¼šåˆ†ç¦»å­˜å‚¨ï¼ˆå¹³è¡¡å®‰å…¨æ€§å’Œå¯ç”¨æ€§ï¼‰
    storeSeparated(tokens) {
        // Access Tokenå­˜åœ¨SessionStorageï¼ˆä¼šè¯çº§åˆ«ï¼‰
        sessionStorage.setItem('access_token', tokens.accessToken);
        sessionStorage.setItem('id_token', tokens.idToken);
        
        // Refresh Tokené€šè¿‡HttpOnly Cookieå­˜å‚¨ï¼ˆéœ€è¦åç«¯é…åˆï¼‰
        document.cookie = `refresh_token=${tokens.refreshToken}; ` +
                         'HttpOnly; Secure; SameSite=Strict; Max-Age=2592000';
    }
    
    // æ–¹æ¡ˆ3ï¼šåŠ å¯†å­˜å‚¨ï¼ˆé¢å¤–ä¿æŠ¤å±‚ï¼‰
    async storeEncrypted(tokens, userKey) {
        const encryptedTokens = await this.encryptData(tokens, userKey);
        sessionStorage.setItem('encrypted_tokens', encryptedTokens);
    }
    
    async encryptData(data, key) {
        // ä½¿ç”¨Web Crypto APIè¿›è¡ŒåŠ å¯†
        const encoder = new TextEncoder();
        const dataBuffer = encoder.encode(JSON.stringify(data));
        const keyBuffer = encoder.encode(key);
        
        const cryptoKey = await crypto.subtle.importKey(
            'raw', keyBuffer, { name: 'AES-GCM' }, false, ['encrypt']
        );
        
        const iv = crypto.getRandomValues(new Uint8Array(12));
        const encrypted = await crypto.subtle.encrypt(
            { name: 'AES-GCM', iv }, cryptoKey, dataBuffer
        );
        
        return btoa(JSON.stringify({
            iv: Array.from(iv),
            data: Array.from(new Uint8Array(encrypted))
        }));
    }
}
```

### 5.4 Tokenæ³„éœ²åº”å¯¹æªæ–½


**ğŸš¨ Tokenæ³„éœ²æ£€æµ‹ä¸å“åº”**

```javascript
class TokenSecurityMonitor {
    constructor() {
        this.setupSecurityMonitoring();
    }
    
    setupSecurityMonitoring() {
        // ç›‘æ§å¯ç–‘çš„Tokenä½¿ç”¨
        window.addEventListener('focus', () => {
            this.checkTokenIntegrity();
        });
        
        // å®šæœŸæ£€æŸ¥TokençŠ¶æ€
        setInterval(() => {
            this.performSecurityCheck();
        }, 30000); // 30ç§’æ£€æŸ¥ä¸€æ¬¡
    }
    
    checkTokenIntegrity() {
        const storedToken = sessionStorage.getItem('access_token');
        
        if (storedToken) {
            // éªŒè¯Tokenæ ¼å¼
            if (!this.isValidJWT(storedToken)) {
                console.warn('æ£€æµ‹åˆ°å¼‚å¸¸Tokenæ ¼å¼');
                this.handleTokenCompromise();
            }
            
            // æ£€æŸ¥Tokenæ˜¯å¦è¢«ç¯¡æ”¹
            if (!this.verifyTokenSignature(storedToken)) {
                console.error('Tokenç­¾åéªŒè¯å¤±è´¥');
                this.handleTokenCompromise();
            }
        }
    }
    
    handleTokenCompromise() {
        // Tokenå¯èƒ½è¢«æ³„éœ²ï¼Œç«‹å³é‡‡å–ä¿æŠ¤æªæ–½
        console.error('æ£€æµ‹åˆ°Tokenå®‰å…¨å¼‚å¸¸ï¼Œæ‰§è¡Œä¿æŠ¤æªæ–½');
        
        // 1. æ¸…é™¤æ‰€æœ‰Token
        this.clearAllTokens();
        
        // 2. æ’¤é”€æœåŠ¡å™¨ç«¯ä¼šè¯
        this.revokeServerSession();
        
        // 3. é‡å®šå‘åˆ°ç™»å½•é¡µ
        window.location.href = '/login?reason=security';
        
        // 4. è®°å½•å®‰å…¨äº‹ä»¶
        this.logSecurityEvent('token_compromise_detected');
    }
    
    async revokeServerSession() {
        try {
            await fetch('/auth/revoke', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
        } catch (error) {
            console.error('ä¼šè¯æ’¤é”€å¤±è´¥:', error);
        }
    }
}
```

---

## 6. ğŸ”’ HTTPSä¸ä¼ è¾“å®‰å…¨


### 6.1 ä¸ºä»€ä¹ˆOIDCå¿…é¡»ä½¿ç”¨HTTPS


**HTTPSçš„é‡è¦æ€§**ï¼šå°±åƒç»™ä¿¡ä»¶åŠ ä¸Šå¯†å°ä¿¡å°

```
HTTPä¼ è¾“ï¼ˆä¸å®‰å…¨ï¼‰ï¼š
å®¢æˆ·ç«¯ â”€â”€æ˜æ–‡Tokenâ”€â”€> æœåŠ¡å™¨
       â†‘ ä¸­é—´äººå¯ä»¥çœ‹åˆ°æ‰€æœ‰å†…å®¹ âŒ

HTTPSä¼ è¾“ï¼ˆå®‰å…¨ï¼‰ï¼š
å®¢æˆ·ç«¯ â”€â”€åŠ å¯†Tokenâ”€â”€> æœåŠ¡å™¨
       â†‘ ä¸­é—´äººåªèƒ½çœ‹åˆ°åŠ å¯†æ•°æ® âœ…

æ¯”å–»ç†è§£ï¼š
HTTP = æ˜ä¿¡ç‰‡ï¼šæ‰€æœ‰äººéƒ½èƒ½çœ‹åˆ°å†…å®¹
HTTPS = å¯†å°ä¿¡ä»¶ï¼šåªæœ‰æ”¶ä»¶äººèƒ½æ‰“å¼€
```

### 6.2 HTTPSé…ç½®è¦æ±‚


**ğŸ” OIDCçš„HTTPSå¼ºåˆ¶è¦æ±‚**

```
âœ… å¿…é¡»ä½¿ç”¨HTTPSçš„åœºæ™¯ï¼š
- è®¤è¯æœåŠ¡å™¨çš„æ‰€æœ‰ç«¯ç‚¹
- å®¢æˆ·ç«¯çš„é‡å®šå‘URI
- Tokenäº¤æ¢è¯·æ±‚
- ç”¨æˆ·ä¿¡æ¯APIè°ƒç”¨
- æ³¨é”€ç«¯ç‚¹

âŒ ç»ä¸å…è®¸HTTPçš„æƒ…å†µï¼š
- ç”Ÿäº§ç¯å¢ƒçš„ä»»ä½•OIDCæµç¨‹
- åŒ…å«æ•æ„Ÿæ•°æ®çš„è¯·æ±‚
- Tokenä¼ è¾“è¿‡ç¨‹
- ç”¨æˆ·å‡­è¯æäº¤
```

**ğŸ“‹ HTTPSå®‰å…¨é…ç½®æ£€æŸ¥å•**

```bash
# 1. æ£€æŸ¥SSLè¯ä¹¦æœ‰æ•ˆæ€§
openssl s_client -connect auth.yourserver.com:443 -verify_return_error

# 2. éªŒè¯TLSç‰ˆæœ¬ï¼ˆè‡³å°‘1.2ï¼‰
curl -sS https://auth.yourserver.com --tlsv1.2 --max-time 10

# 3. æ£€æŸ¥è¯ä¹¦é“¾å®Œæ•´æ€§
curl -I https://auth.yourserver.com

# 4. éªŒè¯HSTSå¤´éƒ¨
curl -I https://auth.yourserver.com | grep -i strict-transport-security
```

### 6.3 ä¼ è¾“å®‰å…¨å®ç°


```javascript
class HTTPSSecurityValidator {
    validateEnvironment() {
        // æ£€æŸ¥å½“å‰ç¯å¢ƒçš„å®‰å…¨æ€§
        const checks = {
            httpsRequired: this.checkHTTPS(),
            secureContext: this.checkSecureContext(),
            mixedContent: this.checkMixedContent()
        };
        
        return checks;
    }
    
    checkHTTPS() {
        // ç¡®ä¿åœ¨HTTPSç¯å¢ƒä¸‹è¿è¡Œ
        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
            console.error('OIDCå¿…é¡»åœ¨HTTPSç¯å¢ƒä¸‹è¿è¡Œ');
            return false;
        }
        return true;
    }
    
    checkSecureContext() {
        // éªŒè¯å®‰å…¨ä¸Šä¸‹æ–‡
        if (!window.isSecureContext) {
            console.warn('å½“å‰ä¸åœ¨å®‰å…¨ä¸Šä¸‹æ–‡ä¸­ï¼ŒæŸäº›åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨');
            return false;
        }
        return true;
    }
    
    checkMixedContent() {
        // æ£€æŸ¥æ˜¯å¦æœ‰æ··åˆå†…å®¹ï¼ˆHTTPSé¡µé¢åŠ è½½HTTPèµ„æºï¼‰
        const scripts = document.querySelectorAll('script[src^="http:"]');
        const images = document.querySelectorAll('img[src^="http:"]');
        
        if (scripts.length > 0 || images.length > 0) {
            console.warn('æ£€æµ‹åˆ°æ··åˆå†…å®¹ï¼Œå¯èƒ½å½±å“å®‰å…¨æ€§');
            return false;
        }
        return true;
    }
    
    enforceHTTPS() {
        // å¼ºåˆ¶é‡å®šå‘åˆ°HTTPS
        if (location.protocol === 'http:' && location.hostname !== 'localhost') {
            location.replace(`https:${location.href.substring(location.protocol.length)}`);
        }
    }
}

// åˆå§‹åŒ–å®‰å…¨æ£€æŸ¥
const httpsValidator = new HTTPSSecurityValidator();
httpsValidator.enforceHTTPS();

const securityStatus = httpsValidator.validateEnvironment();
if (!securityStatus.httpsRequired) {
    alert('å½“å‰ç¯å¢ƒä¸å®‰å…¨ï¼ŒOIDCåŠŸèƒ½å·²ç¦ç”¨');
}
```

### 6.4 è¯ä¹¦ç®¡ç†æœ€ä½³å®è·µ


**ğŸ“œ SSL/TLSè¯ä¹¦ç®¡ç†**

```
è¯ä¹¦é€‰æ‹©æ ‡å‡†ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¯ä¹¦ç±»å‹        â”‚ éªŒè¯çº§åˆ«     â”‚ é€‚ç”¨åœºæ™¯     â”‚ æ¨èç¨‹åº¦    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ DVï¼ˆåŸŸåéªŒè¯ï¼‰   â”‚ åŸºç¡€         â”‚ æµ‹è¯•ç¯å¢ƒ     â”‚ â­â­        â”‚
â”‚ OVï¼ˆç»„ç»‡éªŒè¯ï¼‰   â”‚ ä¸­ç­‰         â”‚ ä¼ä¸šåº”ç”¨     â”‚ â­â­â­â­    â”‚
â”‚ EVï¼ˆæ‰©å±•éªŒè¯ï¼‰   â”‚ æœ€é«˜         â”‚ é‡‘è/æ”¿åºœ    â”‚ â­â­â­â­â­  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è¯ä¹¦æ›´æ–°è‡ªåŠ¨åŒ–ï¼š
1. è¯ä¹¦åˆ°æœŸç›‘æ§ â†’ æå‰30å¤©æé†’
2. è‡ªåŠ¨ç»­æœŸé…ç½® â†’ Let's Encryptç­‰
3. è¯ä¹¦éƒ¨ç½²è„šæœ¬ â†’ æ— ç¼æ›´æ–°
4. å›æ»šæœºåˆ¶å‡†å¤‡ â†’ åº”å¯¹æ›´æ–°å¤±è´¥
```

---

## 7. ğŸ¯ é‡å®šå‘URIå®‰å…¨éªŒè¯


### 7.1 ä»€ä¹ˆæ˜¯é‡å®šå‘URIæ”»å‡»


**ç®€å•ç†è§£**ï¼šåäººæŠŠä½ å¼•å¯¼åˆ°é”™è¯¯çš„åœ°æ–¹

```
æ­£å¸¸æµç¨‹ï¼š
ç”¨æˆ· â†’ è®¤è¯æœåŠ¡å™¨ â†’ åˆæ³•åº”ç”¨å›è°ƒåœ°å€ âœ…

æ”»å‡»æµç¨‹ï¼š
ç”¨æˆ· â†’ è®¤è¯æœåŠ¡å™¨ â†’ æ¶æ„ç½‘ç«™åœ°å€ âŒ

å¥½æ¯”ï¼š
ä½ å«å‡ºç§Ÿè½¦å»é“¶è¡Œ
åäººå‘Šè¯‰å¸æœºå»ä»–çš„å‡é“¶è¡Œ
ä½ åœ¨å‡é“¶è¡Œè¾“å…¥äº†å¯†ç  âŒ
```

### 7.2 é‡å®šå‘URIç™½åå•æœºåˆ¶


**ğŸ” ç™½åå•éªŒè¯æµç¨‹**

```
ç¬¬1æ­¥ï¼šæ³¨å†Œåº”ç”¨æ—¶é…ç½®ç™½åå•
å…è®¸çš„é‡å®šå‘URIï¼š
âœ… https://yourapp.com/callback
âœ… https://yourapp.com/auth/callback  
âœ… https://mobile.yourapp.com/oauth

ç¬¬2æ­¥ï¼šè®¤è¯è¯·æ±‚éªŒè¯
ç”¨æˆ·å‘èµ·è¯·æ±‚ï¼š
https://auth.server.com/authorize?
  client_id=your_app&
  redirect_uri=https://yourapp.com/callback&  â† å¿…é¡»åœ¨ç™½åå•ä¸­
  response_type=code

ç¬¬3æ­¥ï¼šæœåŠ¡å™¨éªŒè¯
if (redirect_uri in whitelist) {
  // å…è®¸ç»§ç»­è®¤è¯æµç¨‹ âœ…
} else {
  // æ‹’ç»è¯·æ±‚ï¼Œè¿”å›é”™è¯¯ âŒ
}
```

### 7.3 é‡å®šå‘URIéªŒè¯å®ç°


```javascript
class RedirectURIValidator {
    constructor(clientId) {
        this.clientId = clientId;
        this.whitelist = this.getWhitelistedURIs();
    }
    
    getWhitelistedURIs() {
        // ä»é…ç½®ä¸­è·å–ç™½åå•ï¼ˆå®é™…åº”ä»æœåŠ¡å™¨è·å–ï¼‰
        const whitelists = {
            'web_app_123': [
                'https://yourapp.com/callback',
                'https://yourapp.com/auth/callback',
                'https://staging.yourapp.com/callback'
            ],
            'mobile_app_456': [
                'com.yourapp.mobile://oauth/callback',
                'https://yourapp.com/mobile/callback'
            ]
        };
        
        return whitelists[this.clientId] || [];
    }
    
    validateRedirectURI(providedURI) {
        // 1. åŸºæœ¬æ ¼å¼éªŒè¯
        if (!this.isValidURI(providedURI)) {
            console.error('é‡å®šå‘URIæ ¼å¼æ— æ•ˆ');
            return false;
        }
        
        // 2. åè®®æ£€æŸ¥
        if (!this.isSecureProtocol(providedURI)) {
            console.error('å¿…é¡»ä½¿ç”¨HTTPSæˆ–å®‰å…¨åè®®');
            return false;
        }
        
        // 3. ç™½åå•éªŒè¯ï¼ˆç²¾ç¡®åŒ¹é…ï¼‰
        if (!this.whitelist.includes(providedURI)) {
            console.error('é‡å®šå‘URIä¸åœ¨ç™½åå•ä¸­');
            return false;
        }
        
        // 4. åŸŸåéªŒè¯
        if (!this.validateDomain(providedURI)) {
            console.error('åŸŸåéªŒè¯å¤±è´¥');
            return false;
        }
        
        return true;
    }
    
    isValidURI(uri) {
        try {
            new URL(uri);
            return true;
        } catch {
            return false;
        }
    }
    
    isSecureProtocol(uri) {
        const url = new URL(uri);
        const secureProtocols = ['https:', 'com.yourapp.mobile:'];
        
        return secureProtocols.some(protocol => 
            url.protocol === protocol
        );
    }
    
    validateDomain(uri) {
        const url = new URL(uri);
        const allowedDomains = [
            'yourapp.com',
            'staging.yourapp.com',
            'localhost' // ä»…å¼€å‘ç¯å¢ƒ
        ];
        
        return allowedDomains.some(domain => 
            url.hostname === domain || 
            url.hostname.endsWith(`.${domain}`)
        );
    }
    
    // æ¨¡ç³ŠåŒ¹é…éªŒè¯ï¼ˆæ›´çµæ´»ä½†é£é™©æ›´é«˜ï¼‰
    validateWithPattern(providedURI) {
        const patterns = [
            /^https:\/\/.*\.yourapp\.com\/.*callback$/,
            /^com\.yourapp\.mobile:\/\/oauth\/callback$/
        ];
        
        return patterns.some(pattern => pattern.test(providedURI));
    }
}

// ä½¿ç”¨ç¤ºä¾‹
const validator = new RedirectURIValidator('web_app_123');

function handleAuthRequest(params) {
    const redirectURI = params.redirect_uri;
    
    if (!validator.validateRedirectURI(redirectURI)) {
        return {
            error: 'invalid_redirect_uri',
            error_description: 'é‡å®šå‘URIéªŒè¯å¤±è´¥'
        };
    }
    
    // éªŒè¯é€šè¿‡ï¼Œç»§ç»­è®¤è¯æµç¨‹
    return proceedWithAuth(params);
}
```

### 7.4 ç§»åŠ¨åº”ç”¨çš„ç‰¹æ®Šå¤„ç†


**ğŸ“± ç§»åŠ¨åº”ç”¨é‡å®šå‘URI**

```javascript
class MobileRedirectHandler {
    validateMobileRedirect(uri) {
        // ç§»åŠ¨åº”ç”¨çš„ç‰¹æ®ŠURIæ ¼å¼
        const mobilePatterns = {
            // iOS Universal Links
            universalLink: /^https:\/\/yourapp\.com\/mobile\/oauth$/,
            
            // Android App Links  
            appLink: /^https:\/\/mobile\.yourapp\.com\/oauth$/,
            
            // Custom URL Scheme
            customScheme: /^com\.yourapp\.mobile:\/\/oauth\/callback$/
        };
        
        return Object.values(mobilePatterns).some(pattern => 
            pattern.test(uri)
        );
    }
    
    generateMobileRedirect() {
        const platform = this.detectPlatform();
        
        switch (platform) {
            case 'ios':
                return 'https://yourapp.com/mobile/oauth';
            case 'android':
                return 'https://mobile.yourapp.com/oauth';
            default:
                return 'com.yourapp.mobile://oauth/callback';
        }
    }
    
    detectPlatform() {
        const userAgent = navigator.userAgent;
        if (/iPhone|iPad/.test(userAgent)) return 'ios';
        if (/Android/.test(userAgent)) return 'android';
        return 'unknown';
    }
}
```

---

## 8. ğŸš¨ å¸¸è§OIDCæ”»å‡»ä¸é˜²æŠ¤


### 8.1 æ”»å‡»åˆ†ç±»æ¦‚è§ˆ


**ğŸ¯ OIDCå®‰å…¨å¨èƒå…¨æ™¯**

```
æ”»å‡»ç±»å‹åˆ†å¸ƒï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    OIDCæ”»å‡»å¨èƒçŸ©é˜µ                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ”»å‡»ç±»å‹        â”‚ å‘ç”Ÿé¢‘ç‡    â”‚ å±å®³ç¨‹åº¦    â”‚ é˜²æŠ¤éš¾åº¦  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ­ æˆæƒç åŠ«æŒ    â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â”‚
â”‚ ğŸ”„ Tokené‡æ”¾     â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ      â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â”‚ â–ˆâ–ˆâ–ˆâ–ˆ      â”‚
â”‚ âš¡ CSRFæ”»å‡»     â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ      â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ      â”‚ â–ˆâ–ˆâ–ˆâ–ˆ      â”‚
â”‚ ğŸ•³ï¸ é‡å®šå‘åŠ«æŒ   â”‚ â–ˆâ–ˆâ–ˆâ–ˆ        â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â”‚ â–ˆâ–ˆâ–ˆâ–ˆ      â”‚
â”‚ ğŸ‘¤ èº«ä»½æ··æ·†      â”‚ â–ˆâ–ˆâ–ˆâ–ˆ        â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ      â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â”‚
â”‚ ğŸ” ä¿¡æ¯æ³„éœ²      â”‚ â–ˆâ–ˆâ–ˆâ–ˆ        â”‚ â–ˆâ–ˆâ–ˆâ–ˆ        â”‚ â–ˆâ–ˆ        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 æˆæƒç åŠ«æŒæ”»å‡»


**ğŸ­ æ”»å‡»åŸç†ä¸é˜²æŠ¤**

```
æ”»å‡»åœºæ™¯ï¼šæ¶æ„åº”ç”¨æˆªè·æˆæƒç 

æ”»å‡»æµç¨‹ï¼š
ç”¨æˆ·è®¾å¤‡
    â†“ [1]å¯åŠ¨è®¤è¯
è®¤è¯æœåŠ¡å™¨
    â†“ [2]è¿”å›æˆæƒç 
æ¶æ„åº”ç”¨ç›‘å¬ â† [3]æˆªè·æˆæƒç 
    â†“ [4]å†’å……åˆæ³•åº”ç”¨
è®¤è¯æœåŠ¡å™¨
    â†“ [5]è¿”å›Tokenç»™æ¶æ„åº”ç”¨ âŒ

é˜²æŠ¤æªæ–½ï¼š
âœ… PKCEå¼ºåˆ¶éªŒè¯
âœ… å®¢æˆ·ç«¯è®¤è¯
âœ… æˆæƒç çŸ­æ—¶è¿‡æœŸ
âœ… ç»‘å®šè®¾å¤‡æŒ‡çº¹
```

**ğŸ›¡ï¸ é˜²æŠ¤ä»£ç å®ç°**

```javascript
class AuthCodeProtection {
    constructor() {
        this.deviceFingerprint = this.generateDeviceFingerprint();
    }
    
    generateDeviceFingerprint() {
        // ç”Ÿæˆè®¾å¤‡å”¯ä¸€æ ‡è¯†
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        ctx.textBaseline = 'top';
        ctx.font = '14px Arial';
        ctx.fillText('Device fingerprint', 2, 2);
        
        const fingerprint = {
            screen: `${screen.width}x${screen.height}`,
            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
            language: navigator.language,
            platform: navigator.platform,
            canvas: canvas.toDataURL()
        };
        
        return btoa(JSON.stringify(fingerprint));
    }
    
    secureAuthCodeExchange(authCode, codeVerifier) {
        return {
            grant_type: 'authorization_code',
            code: authCode,
            code_verifier: codeVerifier,           // PKCEéªŒè¯
            client_id: this.clientId,
            device_fingerprint: this.deviceFingerprint, // è®¾å¤‡ç»‘å®š
            timestamp: Date.now()                  // æ—¶é—´æˆ³éªŒè¯
        };
    }
    
    validateAuthCode(authCode) {
        // éªŒè¯æˆæƒç çš„æœ‰æ•ˆæ€§å’Œæ¥æº
        const codeAge = Date.now() - this.extractTimestamp(authCode);
        
        if (codeAge > 300000) { // 5åˆ†é’Ÿè¿‡æœŸ
            throw new Error('æˆæƒç å·²è¿‡æœŸ');
        }
        
        return true;
    }
}
```

### 8.3 Tokené‡æ”¾æ”»å‡»é˜²æŠ¤


**ğŸ”„ é‡æ”¾æ”»å‡»æ·±åº¦é˜²æŠ¤**

```javascript
class ReplayAttackDefense {
    constructor() {
        this.usedNonces = new Set();
        this.requestHistory = new Map();
    }
    
    generateSecureNonce() {
        // ç”Ÿæˆå¼ºéšæœºæ€§nonce
        const timestamp = Date.now();
        const random = crypto.getRandomValues(new Uint32Array(4));
        const userContext = this.getUserContext();
        
        const nonce = `${timestamp}_${Array.from(random).join('')}_${userContext}`;
        return btoa(nonce);
    }
    
    validateRequest(request) {
        const { nonce, timestamp, signature } = request;
        
        // 1. Nonceå”¯ä¸€æ€§æ£€æŸ¥
        if (this.usedNonces.has(nonce)) {
            throw new Error('æ£€æµ‹åˆ°é‡æ”¾æ”»å‡»ï¼šNonceå·²ä½¿ç”¨');
        }
        
        // 2. æ—¶é—´çª—å£éªŒè¯
        const now = Date.now();
        if (now - timestamp > 300000) { // 5åˆ†é’Ÿæ—¶é—´çª—å£
            throw new Error('è¯·æ±‚å·²è¿‡æœŸ');
        }
        
        // 3. ç­¾åéªŒè¯
        if (!this.verifySignature(request, signature)) {
            throw new Error('ç­¾åéªŒè¯å¤±è´¥');
        }
        
        // 4. è¯·æ±‚é¢‘ç‡é™åˆ¶
        if (this.isRateLimited(request.client_id)) {
            throw new Error('è¯·æ±‚è¿‡äºé¢‘ç¹');
        }
        
        // è®°å½•å·²ä½¿ç”¨çš„nonce
        this.usedNonces.add(nonce);
        this.cleanExpiredNonces();
        
        return true;
    }
    
    isRateLimited(clientId) {
        const key = `rate_limit_${clientId}`;
        const history = this.requestHistory.get(key) || [];
        const now = Date.now();
        
        // æ¸…ç†1åˆ†é’Ÿå‰çš„è®°å½•
        const recentRequests = history.filter(time => now - time < 60000);
        
        // æ£€æŸ¥1åˆ†é’Ÿå†…çš„è¯·æ±‚æ•°é‡
        if (recentRequests.length >= 10) {
            return true;
        }
        
        // è®°å½•å½“å‰è¯·æ±‚
        recentRequests.push(now);
        this.requestHistory.set(key, recentRequests);
        
        return false;
    }
    
    cleanExpiredNonces() {
        // å®šæœŸæ¸…ç†è¿‡æœŸçš„nonceï¼ˆé¿å…å†…å­˜æ³„éœ²ï¼‰
        if (this.usedNonces.size > 10000) {
            this.usedNonces.clear();
            console.log('æ¸…ç†è¿‡æœŸçš„nonceè®°å½•');
        }
    }
}
```

### 8.4 ä¼šè¯å›ºå®šæ”»å‡»é˜²æŠ¤


**ğŸ”’ ä¼šè¯å®‰å…¨ç®¡ç†**

```javascript
class SessionSecurityManager {
    constructor() {
        this.sessionRotationInterval = 30 * 60 * 1000; // 30åˆ†é’Ÿ
        this.setupSessionMonitoring();
    }
    
    setupSessionMonitoring() {
        // ç›‘æ§å¼‚å¸¸ç™»å½•æ´»åŠ¨
        this.detectConcurrentSessions();
        this.detectLocationAnomaly();
        this.monitorUserBehavior();
    }
    
    detectConcurrentSessions() {
        // æ£€æµ‹åŒä¸€ç”¨æˆ·çš„å¤šä¸ªæ´»è·ƒä¼šè¯
        setInterval(() => {
            const activeTokens = this.getActiveTokens();
            const userSessions = new Map();
            
            activeTokens.forEach(token => {
                const userId = this.extractUserId(token);
                const sessions = userSessions.get(userId) || [];
                sessions.push(token);
                userSessions.set(userId, sessions);
            });
            
            userSessions.forEach((sessions, userId) => {
                if (sessions.length > 3) { // è¶…è¿‡3ä¸ªå¹¶å‘ä¼šè¯
                    console.warn(`ç”¨æˆ·${userId}å­˜åœ¨${sessions.length}ä¸ªå¹¶å‘ä¼šè¯`);
                    this.handleSuspiciousActivity(userId, sessions);
                }
            });
        }, 60000);
    }
    
    handleSuspiciousActivity(userId, sessions) {
        // å¤„ç†å¯ç–‘æ´»åŠ¨
        console.error(`æ£€æµ‹åˆ°ç”¨æˆ·${userId}çš„å¼‚å¸¸ä¼šè¯æ´»åŠ¨`);
        
        // 1. ç«‹å³æ’¤é”€æ‰€æœ‰æ—§ä¼šè¯
        sessions.slice(0, -1).forEach(token => {
            this.revokeToken(token);
        });
        
        // 2. å¼ºåˆ¶æœ€æ–°ä¼šè¯é‡æ–°è®¤è¯
        this.requireReauth(sessions[sessions.length - 1]);
        
        // 3. å‘é€å®‰å…¨å‘Šè­¦
        this.sendSecurityAlert(userId, 'concurrent_sessions_detected');
        
        // 4. è®°å½•å®‰å…¨äº‹ä»¶
        this.logSecurityEvent({
            userId,
            event: 'suspicious_concurrent_sessions',
            timestamp: Date.now(),
            sessionCount: sessions.length
        });
    }
    
    rotateSession(currentToken) {
        // ä¼šè¯è½®æ¢æœºåˆ¶
        try {
            // 1. ç”Ÿæˆæ–°çš„ä¼šè¯Token
            const newToken = this.generateNewToken(currentToken);
            
            // 2. ä¿æŒçŸ­æš‚çš„é‡å æœŸï¼ˆé¿å…ç«æ€æ¡ä»¶ï¼‰
            setTimeout(() => {
                this.revokeToken(currentToken);
            }, 30000); // 30ç§’é‡å æœŸ
            
            // 3. æ›´æ–°å®¢æˆ·ç«¯Token
            this.updateClientToken(newToken);
            
            console.log('ä¼šè¯è½®æ¢å®Œæˆ');
            return newToken;
            
        } catch (error) {
            console.error('ä¼šè¯è½®æ¢å¤±è´¥:', error);
            throw error;
        }
    }
}
```

---

## 9. ğŸ“‹ å®‰å…¨å®è·µæ€»ç»“


### 9.1 OIDCå®‰å…¨æ¸…å•


**âœ… å¿…é¡»å®æ–½çš„å®‰å…¨æªæ–½**

```
ğŸ” è®¤è¯å®‰å…¨ï¼š
â–¡ å¼ºåˆ¶ä½¿ç”¨HTTPS
â–¡ å®æ–½PKCEï¼ˆSPAå’Œç§»åŠ¨åº”ç”¨ï¼‰
â–¡ é…ç½®Nonceé˜²é‡æ”¾
â–¡ è®¾ç½®Stateé˜²CSRF
â–¡ å¯ç”¨å®¢æˆ·ç«¯è®¤è¯

ğŸ›¡ï¸ Tokenå®‰å…¨ï¼š
â–¡ è®¾ç½®åˆç†çš„Tokenè¿‡æœŸæ—¶é—´
â–¡ å®æ–½Tokenè½®æ¢æœºåˆ¶
â–¡ å®‰å…¨å­˜å‚¨Token
â–¡ ç›‘æ§Tokenä½¿ç”¨å¼‚å¸¸
â–¡ æä¾›Tokenæ’¤é”€åŠŸèƒ½

ğŸ¯ åº”ç”¨å®‰å…¨ï¼š
â–¡ éªŒè¯é‡å®šå‘URIç™½åå•
â–¡ å®æ–½è¯·æ±‚é¢‘ç‡é™åˆ¶
â–¡ ç›‘æ§å¹¶å‘ä¼šè¯
â–¡ è®°å½•å®‰å…¨å®¡è®¡æ—¥å¿—
â–¡ å®šæœŸå®‰å…¨æ‰«æ

ğŸ“Š ç›‘æ§å‘Šè­¦ï¼š
â–¡ å¼‚å¸¸ç™»å½•æ´»åŠ¨ç›‘æ§
â–¡ Tokenæ³„éœ²æ£€æµ‹
â–¡ æ”»å‡»æ¨¡å¼è¯†åˆ«
â–¡ å®æ—¶å®‰å…¨å‘Šè­¦
â–¡ äº‹ä»¶å“åº”æµç¨‹
```

### 9.2 å®‰å…¨é…ç½®æ¨¡æ¿


```javascript
// OIDCå®‰å…¨é…ç½®æœ€ä½³å®è·µæ¨¡æ¿
const OIDCSecurityConfig = {
    // åŸºç¡€å®‰å…¨é…ç½®
    security: {
        forceHTTPS: true,
        requirePKCE: ['spa', 'mobile'],
        enforceNonce: true,
        validateState: true,
        strictRedirectURI: true
    },
    
    // Tokenå®‰å…¨ç­–ç•¥
    tokens: {
        idToken: {
            expiresIn: 900,        // 15åˆ†é’Ÿ
            algorithm: 'RS256',
            issuer: 'https://auth.yourserver.com'
        },
        accessToken: {
            expiresIn: 3600,       // 1å°æ—¶
            refreshThreshold: 300,  // æå‰5åˆ†é’Ÿåˆ·æ–°
            maxLifetime: 86400     // 24å°æ—¶æœ€å¤§ç”Ÿå‘½å‘¨æœŸ
        },
        refreshToken: {
            expiresIn: 2592000,    // 30å¤©
            rotateOnUse: true,
            revokeFamily: true     // æ’¤é”€æ•´ä¸ªTokenå®¶æ—
        }
    },
    
    // å®‰å…¨é™åˆ¶
    limits: {
        maxConcurrentSessions: 3,
        authAttempts: {
            maxAttempts: 5,
            lockoutDuration: 900   // 15åˆ†é’Ÿé”å®š
        },
        rateLimiting: {
            requestsPerMinute: 60,
            burstLimit: 10
        }
    },
    
    // ç›‘æ§é…ç½®
    monitoring: {
        logSecurityEvents: true,
        alertThresholds: {
            failedLogins: 3,
            concurrentSessions: 5,
            suspiciousIPs: 10
        },
        retentionPeriod: 90       // 90å¤©æ—¥å¿—ä¿ç•™
    }
};
```

### 9.3 å®‰å…¨æ£€æŸ¥è„šæœ¬


```javascript
class OIDCSecurityAuditor {
    async performSecurityAudit() {
        console.log('ğŸ” å¼€å§‹OIDCå®‰å…¨å®¡è®¡...');
        
        const results = {
            httpsCheck: await this.checkHTTPS(),
            pkceCheck: await this.checkPKCE(),
            tokenSecurity: await this.checkTokenSecurity(),
            redirectSecurity: await this.checkRedirectURIs(),
            sessionSecurity: await this.checkSessionManagement()
        };
        
        this.generateSecurityReport(results);
        return results;
    }
    
    async checkHTTPS() {
        const checks = {
            protocolCheck: location.protocol === 'https:',
            hstsHeader: await this.checkHSTSHeader(),
            certificateValid: await this.checkCertificate(),
            mixedContent: this.checkMixedContent()
        };
        
        return {
            passed: Object.values(checks).every(Boolean),
            details: checks
        };
    }
    
    async checkPKCE() {
        // æ£€æŸ¥PKCEå®æ–½æƒ…å†µ
        const hasPKCE = sessionStorage.getItem('pkce_verifier') !== null;
        const codeChallenge = this.extractCodeChallenge();
        
        return {
            passed: hasPKCE && codeChallenge,
            details: {
                pkceImplemented: hasPKCE,
                challengePresent: !!codeChallenge
            }
        };
    }
    
    generateSecurityReport(results) {
        console.log('ğŸ“Š OIDCå®‰å…¨å®¡è®¡æŠ¥å‘Š');
        console.log('========================');
        
        Object.entries(results).forEach(([check, result]) => {
            const status = result.passed ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥';
            console.log(`${check}: ${status}`);
            
            if (!result.passed) {
                console.warn(`  è¯¦æƒ…: ${JSON.stringify(result.details)}`);
            }
        });
        
        const overallScore = Object.values(results)
            .filter(r => r.passed).length / Object.keys(results).length * 100;
        
        console.log(`\næ€»ä½“å®‰å…¨è¯„åˆ†: ${overallScore.toFixed(1)}%`);
        
        if (overallScore < 80) {
            console.error('âš ï¸ å®‰å…¨è¯„åˆ†åä½ï¼Œè¯·ç«‹å³ä¿®å¤å¤±è´¥çš„æ£€æŸ¥é¡¹ï¼');
        }
    }
}

// æ‰§è¡Œå®‰å…¨å®¡è®¡
const auditor = new OIDCSecurityAuditor();
auditor.performSecurityAudit();
```

### 9.4 åº”æ€¥å“åº”è®¡åˆ’


**ğŸš¨ å®‰å…¨äº‹ä»¶å“åº”æµç¨‹**

```
å®‰å…¨äº‹ä»¶å“åº”çŸ©é˜µï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ äº‹ä»¶ç±»å‹        â”‚ å“åº”æ—¶é—´        â”‚ å¤„ç½®æªæ–½        â”‚ æ¢å¤é¢„æœŸ        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ”´ Tokenæ³„éœ²    â”‚ ç«‹å³ï¼ˆ<5åˆ†é’Ÿï¼‰  â”‚ æ’¤é”€æ‰€æœ‰Token   â”‚ 2-4å°æ—¶         â”‚
â”‚ ğŸŸ¡ å¼‚å¸¸ç™»å½•     â”‚ 15åˆ†é’Ÿå†…       â”‚ é”å®šè´¦æˆ·        â”‚ 1å°æ—¶           â”‚
â”‚ ğŸŸ¢ å¯ç–‘æ´»åŠ¨     â”‚ 1å°æ—¶å†…        â”‚ åŠ å¼ºç›‘æ§        â”‚ æŒç»­ç›‘æ§        â”‚
â”‚ ğŸ”´ ç³»ç»Ÿå…¥ä¾µ     â”‚ ç«‹å³ï¼ˆ<3åˆ†é’Ÿï¼‰  â”‚ æ–­å¼€ç½‘ç»œ        â”‚ 24-72å°æ—¶       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åº”æ€¥å¤„ç½®SOPï¼š
1. å‘ç°å®‰å…¨å¨èƒ â†’ ç«‹å³è¯„ä¼°ä¸¥é‡ç¨‹åº¦
2. æ‰§è¡Œéš”ç¦»æªæ–½ â†’ é˜²æ­¢å¨èƒæ‰©æ•£
3. æ”¶é›†è¯æ®ä¿¡æ¯ â†’ åˆ†ææ”»å‡»æ¥æº
4. é€šçŸ¥ç›¸å…³äººå‘˜ â†’ å¯åŠ¨åº”æ€¥é¢„æ¡ˆ
5. å®æ–½ä¿®å¤æªæ–½ â†’ æ¢å¤æ­£å¸¸æœåŠ¡
6. æ€»ç»“ç»éªŒæ•™è®­ â†’ æ”¹è¿›å®‰å…¨ç­–ç•¥
```

### 9.5 æŒç»­å®‰å…¨æ”¹è¿›


**ğŸ“ˆ å®‰å…¨æˆç†Ÿåº¦æå‡è·¯å¾„**

```
Level 1 - åŸºç¡€å®‰å…¨ï¼š
âœ… å®æ–½HTTPS
âœ… åŸºæœ¬Tokenä¿æŠ¤
âœ… ç®€å•è®¿é—®æ§åˆ¶

Level 2 - å¢å¼ºé˜²æŠ¤ï¼š
âœ… PKCEå®æ–½
âœ… å¤šå› å­è®¤è¯
âœ… å®‰å…¨ç›‘æ§

Level 3 - é«˜çº§å®‰å…¨ï¼š
âœ… é›¶ä¿¡ä»»æ¶æ„
âœ… è¡Œä¸ºåˆ†æ
âœ… å¨èƒæƒ…æŠ¥

Level 4 - ä¼ä¸šçº§å®‰å…¨ï¼š
âœ… è‡ªåŠ¨åŒ–å“åº”
âœ… æœºå™¨å­¦ä¹ æ£€æµ‹
âœ… å…¨é¢å®¡è®¡
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- **PKCEæ˜¯ç§»åŠ¨ç«¯å’ŒSPAçš„ç”Ÿå‘½çº¿**ï¼Œä¸ç”¨å°±æ˜¯è£¸å¥”
- **Nonceå’ŒStateæ˜¯åŒé‡ä¿é™©**ï¼Œé˜²é‡æ”¾é˜²CSRFç¼ºä¸€ä¸å¯  
- **HTTPSæ˜¯åŸºç¡€ä¸­çš„åŸºç¡€**ï¼Œæ²¡æœ‰HTTPSå°±æ²¡æœ‰å®‰å…¨
- **Tokenå°±åƒç°é‡‘ä¸€æ ·**ï¼Œå¿…é¡»å°å¿ƒä¿ç®¡å’ŒåŠæ—¶æ›´æ¢
- **ç™½åå•èƒœè¿‡é»‘åå•**ï¼Œé‡å®šå‘URIå¿…é¡»ä¸¥æ ¼æ§åˆ¶
- **ç›‘æ§æ¯”é˜²æŠ¤æ›´é‡è¦**ï¼ŒåŠæ—¶å‘ç°æ‰èƒ½åŠæ—¶åº”å¯¹