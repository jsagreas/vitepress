---
title: 6ã€OAuth2ä¸OIDCå¾®æœåŠ¡å®ç°
---
## ğŸ“š ç›®å½•

1. [ä»€ä¹ˆæ˜¯OAuth2å’ŒOIDC](#1-ä»€ä¹ˆæ˜¯OAuth2å’ŒOIDC)
2. [OAuth2å››å¤§æ ¸å¿ƒè§’è‰²](#2-OAuth2å››å¤§æ ¸å¿ƒè§’è‰²)
3. [OAuth2æˆæƒæ¨¡å¼è¯¦è§£](#3-OAuth2æˆæƒæ¨¡å¼è¯¦è§£)
4. [OIDCæ ¸å¿ƒæ¦‚å¿µ](#4-OIDCæ ¸å¿ƒæ¦‚å¿µ)
5. [Scopeså’ŒClaimsè®¾è®¡](#5-Scopeså’ŒClaimsè®¾è®¡)
6. [ä¼ä¸šç›®å½•é›†æˆ](#6-ä¼ä¸šç›®å½•é›†æˆ)
7. [ä¸»æµå®ç°æ–¹æ¡ˆ](#7-ä¸»æµå®ç°æ–¹æ¡ˆ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” ä»€ä¹ˆæ˜¯OAuth2å’ŒOIDC


### 1.1 ç®€å•ç†è§£OAuth2


**ğŸ’¡ ç”Ÿæ´»åœºæ™¯ç±»æ¯”**
```
ä½ æƒ³ç”¨ç¬¬ä¸‰æ–¹åº”ç”¨ï¼ˆå¦‚ç¾å›¢ï¼‰æŸ¥çœ‹ä½ çš„å¾®ä¿¡å¥½å‹ä¿¡æ¯ï¼š

ä¼ ç»Ÿæ–¹å¼ï¼šæŠŠå¾®ä¿¡è´¦å·å¯†ç å‘Šè¯‰ç¾å›¢ âŒ 
- ä¸å®‰å…¨ï¼šç¾å›¢çŸ¥é“ä½ å¯†ç 
- ä¸å¯æ§ï¼šç¾å›¢å¯ä»¥åšä»»ä½•æ“ä½œ

OAuth2æ–¹å¼ï¼šå¾®ä¿¡ç»™ç¾å›¢ä¸€ä¸ª"ä¸´æ—¶é€šè¡Œè¯" âœ…
- å®‰å…¨ï¼šç¾å›¢ä¸çŸ¥é“ä½ å¯†ç 
- å¯æ§ï¼šåªèƒ½çœ‹å¥½å‹ä¿¡æ¯ï¼Œä¸èƒ½å‘æ¶ˆæ¯
- å¯æ’¤é”€ï¼šéšæ—¶å¯ä»¥å–æ¶ˆæˆæƒ
```

**ğŸ¯ OAuth2æœ¬è´¨**
- **æˆæƒæ¡†æ¶**ï¼šè®©ç¬¬ä¸‰æ–¹åº”ç”¨å®‰å…¨åœ°è·å–ç”¨æˆ·èµ„æº
- **ä¸æ˜¯è®¤è¯**ï¼šåªç®¡"èƒ½ä¸èƒ½è®¿é—®"ï¼Œä¸ç®¡"ä½ æ˜¯è°"
- **tokenæœºåˆ¶**ï¼šç”¨ä»¤ç‰Œä»£æ›¿å¯†ç 

### 1.2 OIDCæ˜¯ä»€ä¹ˆ


**ğŸ”— OIDCä¸OAuth2å…³ç³»**
```
OAuth2: æˆ‘æœ‰æƒé™è®¿é—®ä½ çš„ç…§ç‰‡
OIDC:   æˆ‘çŸ¥é“ä½ æ˜¯å¼ ä¸‰ï¼Œè€Œä¸”æˆ‘æœ‰æƒé™è®¿é—®ä½ çš„ç…§ç‰‡

ç®€å•è¯´ï¼šOIDC = OAuth2 + èº«ä»½ä¿¡æ¯
```

**âœ¨ OIDCæ ¸å¿ƒä»·å€¼**
- **èº«ä»½è®¤è¯**ï¼šå‘Šè¯‰åº”ç”¨"ç”¨æˆ·æ˜¯è°"
- **ç»Ÿä¸€ç™»å½•**ï¼šä¸€æ¬¡ç™»å½•ï¼Œå¤šå¤„ä½¿ç”¨
- **æ ‡å‡†åŒ–**ï¼šåŸºäºJWTçš„èº«ä»½ä¿¡æ¯ä¼ é€’

---

## 2. ğŸ‘¥ OAuth2å››å¤§æ ¸å¿ƒè§’è‰²


### 2.1 è§’è‰²å…³ç³»å›¾ç¤º


```
ç”¨æˆ·ç”Ÿæ€ç³»ç»Ÿï¼š

Resource Owner     Client              Authorization Server    Resource Server
(èµ„æºæ‹¥æœ‰è€…)        (å®¢æˆ·ç«¯åº”ç”¨)          (æˆæƒæœåŠ¡å™¨)            (èµ„æºæœåŠ¡å™¨)
     ğŸ‘¤               ğŸ“±                    ğŸ›ï¸                   ğŸ’¾
     |                |                     |                    |
     |---â‘ è¯·æ±‚æˆæƒ---->|                     |                    |
     |<--â‘¡é‡å®šå‘åˆ°æˆæƒ--|--â‘¢è¯·æ±‚æˆæƒç ------>|                    |
     |---â‘£ç”¨æˆ·ç™»å½•æˆæƒ->|<--â‘¤è¿”å›æˆæƒç -----|                    |
     |                |---â‘¥ç”¨tokenæ¢ç ---->|                    |
     |                |<--â‘¦è¿”å›è®¿é—®ä»¤ç‰Œ----|                    |
     |                |---â‘§ç”¨tokenè®¿é—®èµ„æº--------------->|      |
     |                |<--â‘¨è¿”å›èµ„æºæ•°æ®-------------------|      |
```

### 2.2 è¯¦ç»†è§’è‰²è§£æ


**ğŸ‘¤ Resource Ownerï¼ˆèµ„æºæ‹¥æœ‰è€…ï¼‰**
```
ç®€å•ç†è§£ï¼šæ‹¥æœ‰æ•°æ®çš„ç”¨æˆ·

ç°å®ä¾‹å­ï¼š
- å¾®ä¿¡ç”¨æˆ·ï¼šæ‹¥æœ‰å¥½å‹åˆ—è¡¨ã€æœ‹å‹åœˆæ•°æ®
- é“¶è¡Œç”¨æˆ·ï¼šæ‹¥æœ‰è´¦æˆ·ä½™é¢ã€äº¤æ˜“è®°å½•
- GitHubç”¨æˆ·ï¼šæ‹¥æœ‰ä»£ç ä»“åº“ã€ä¸ªäººä¿¡æ¯

æ ¸å¿ƒä½œç”¨ï¼š
âœ… å†³å®šæ˜¯å¦æˆæƒç»™ç¬¬ä¸‰æ–¹åº”ç”¨
âœ… æ§åˆ¶æˆæƒèŒƒå›´å’Œæ—¶é—´
```

**ğŸ“± Clientï¼ˆå®¢æˆ·ç«¯åº”ç”¨ï¼‰**
```
ç®€å•ç†è§£ï¼šæƒ³è¦è·å–ç”¨æˆ·æ•°æ®çš„åº”ç”¨

åˆ†ç±»è¯´æ˜ï¼š
ğŸ”¸ å…¬å¼€å®¢æˆ·ç«¯ï¼šç§»åŠ¨Appã€å•é¡µåº”ç”¨(SPA)
  - ä¸èƒ½å®‰å…¨å­˜å‚¨å¯†é’¥
  - éœ€è¦PKCEå¢å¼ºå®‰å…¨æ€§
  
ğŸ”¸ æœºå¯†å®¢æˆ·ç«¯ï¼šæœåŠ¡å™¨åº”ç”¨ã€åç«¯æœåŠ¡
  - å¯ä»¥å®‰å…¨å­˜å‚¨client_secret
  - æ”¯æŒå®Œæ•´çš„æˆæƒç æ¨¡å¼

å®ä¾‹ï¼š
- ç¬¬ä¸‰æ–¹ç™»å½•çš„ç½‘ç«™
- è°ƒç”¨APIçš„ç§»åŠ¨åº”ç”¨
- å¾®æœåŠ¡é—´çš„æœåŠ¡è°ƒç”¨
```

**ğŸ›ï¸ Authorization Serverï¼ˆæˆæƒæœåŠ¡å™¨ï¼‰**
```
ç®€å•ç†è§£ï¼šè´Ÿè´£ç”¨æˆ·ç™»å½•å’Œå‘æ”¾ä»¤ç‰Œçš„æœåŠ¡

æ ¸å¿ƒèŒè´£ï¼š
ğŸ” ç”¨æˆ·èº«ä»½éªŒè¯
ğŸ« å‘æ”¾è®¿é—®ä»¤ç‰Œ
âš™ï¸ ç®¡ç†å®¢æˆ·ç«¯æ³¨å†Œ
ğŸ”§ å¤„ç†ä»¤ç‰Œåˆ·æ–°

å¸¸è§å®ç°ï¼š
- Keycloakï¼ˆå¼€æºï¼‰
- Auth0ï¼ˆå•†ä¸šï¼‰
- Azure ADï¼ˆå¾®è½¯ï¼‰
- AWS Cognitoï¼ˆäºšé©¬é€Šï¼‰
```

**ğŸ’¾ Resource Serverï¼ˆèµ„æºæœåŠ¡å™¨ï¼‰**
```
ç®€å•ç†è§£ï¼šå­˜å‚¨ç”¨æˆ·æ•°æ®å¹¶æä¾›APIçš„æœåŠ¡

èŒè´£è¯´æ˜ï¼š
ğŸ“¡ æ¥æ”¶ä»¤ç‰ŒéªŒè¯è¯·æ±‚
ğŸ” éªŒè¯ä»¤ç‰Œæœ‰æ•ˆæ€§
ğŸ“Š æ ¹æ®æƒé™è¿”å›æ•°æ®
ğŸš« æ‹’ç»æ— æ•ˆè¯·æ±‚

å®ä¾‹ï¼š
- ç”¨æˆ·ä¿¡æ¯API
- æ–‡ä»¶å­˜å‚¨æœåŠ¡
- ä¸šåŠ¡æ•°æ®æ¥å£
```

---

## 3. ğŸ”„ OAuth2æˆæƒæ¨¡å¼è¯¦è§£


### 3.1 æˆæƒç æ¨¡å¼ + PKCEï¼ˆæ¨èï¼‰


**ğŸ¯ é€‚ç”¨åœºæ™¯**ï¼šWebåº”ç”¨ã€ç§»åŠ¨Appã€SPAåº”ç”¨

**ğŸ”’ PKCEå®‰å…¨å¢å¼º**
```
ä¼ ç»Ÿé—®é¢˜ï¼šæˆæƒç å¯èƒ½è¢«æ‹¦æˆª
PKCEè§£å†³ï¼šç”¨éšæœºç”Ÿæˆçš„éªŒè¯ç å¢åŠ å®‰å…¨æ€§

PKCEæµç¨‹ï¼š
1. å®¢æˆ·ç«¯ç”Ÿæˆ code_verifierï¼ˆéšæœºå­—ç¬¦ä¸²ï¼‰
2. è®¡ç®— code_challenge = SHA256(code_verifier)
3. æˆæƒæ—¶æºå¸¦ code_challenge
4. æ¢tokenæ—¶æä¾›åŸå§‹ code_verifier éªŒè¯
```

**ğŸ“‹ å®Œæ•´æµç¨‹**
```
è¯¦ç»†æ­¥éª¤è¯´æ˜ï¼š

â‘ ç”¨æˆ·è®¿é—®åº”ç”¨ï¼Œç‚¹å‡»"ç¬¬ä¸‰æ–¹ç™»å½•"
â‘¡åº”ç”¨ç”ŸæˆPKCEå‚æ•°ï¼Œè·³è½¬åˆ°æˆæƒæœåŠ¡å™¨
â‘¢ç”¨æˆ·åœ¨æˆæƒé¡µé¢ç™»å½•å¹¶ç¡®è®¤æˆæƒ
â‘£æˆæƒæœåŠ¡å™¨å›è°ƒåº”ç”¨ï¼Œè¿”å›æˆæƒç 
â‘¤åº”ç”¨åç«¯ç”¨æˆæƒç +PKCEéªŒè¯æ¢å–token
â‘¥è·å¾—è®¿é—®ä»¤ç‰Œï¼Œå¯ä»¥è°ƒç”¨APIè·å–ç”¨æˆ·æ•°æ®

å®‰å…¨æ€§ï¼š
âœ… æˆæƒç åªèƒ½ä½¿ç”¨ä¸€æ¬¡
âœ… PKCEé˜²æ­¢æˆæƒç è¢«åŠ«æŒ
âœ… å®¢æˆ·ç«¯éœ€è¦é¢„å…ˆæ³¨å†Œ
```

**ğŸ’» ä»£ç ç¤ºä¾‹**
```javascript
// 1. ç”ŸæˆPKCEå‚æ•°
function generatePKCE() {
    const codeVerifier = crypto.randomBytes(32).toString('base64url');
    const codeChallenge = crypto
        .createHash('sha256')
        .update(codeVerifier)
        .digest('base64url');
    
    return { codeVerifier, codeChallenge };
}

// 2. æ„å»ºæˆæƒURL
const { codeVerifier, codeChallenge } = generatePKCE();
const authUrl = `${AUTH_SERVER}/authorize?` +
    `response_type=code&` +
    `client_id=${CLIENT_ID}&` +
    `redirect_uri=${REDIRECT_URI}&` +
    `scope=openid profile email&` +
    `code_challenge=${codeChallenge}&` +
    `code_challenge_method=S256&` +
    `state=${randomState}`;

// 3. å¤„ç†å›è°ƒï¼Œæ¢å–token
app.get('/callback', async (req, res) => {
    const { code, state } = req.query;
    
    const tokenResponse = await fetch(`${AUTH_SERVER}/token`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
            grant_type: 'authorization_code',
            client_id: CLIENT_ID,
            code: code,
            redirect_uri: REDIRECT_URI,
            code_verifier: codeVerifier // PKCEéªŒè¯
        })
    });
    
    const tokens = await tokenResponse.json();
    // tokensåŒ…å«ï¼šaccess_tokenã€id_tokenã€refresh_token
});
```

### 3.2 å®¢æˆ·ç«¯å‡­è¯æ¨¡å¼


**ğŸ¯ é€‚ç”¨åœºæ™¯**ï¼šæœåŠ¡å™¨é—´è°ƒç”¨ã€æœºå™¨å¯¹æœºå™¨è®¤è¯

**ğŸ’¡ ç®€å•ç†è§£**
```
åœºæ™¯ï¼šå¾®æœåŠ¡Aéœ€è¦è°ƒç”¨å¾®æœåŠ¡Bçš„API

ä¼ ç»Ÿæ–¹å¼ï¼šåœ¨ä»£ç é‡Œå†™æ­»ç”¨æˆ·åå¯†ç  âŒ
OAuth2æ–¹å¼ï¼šç”¨å®¢æˆ·ç«¯IDå’Œå¯†é’¥è·å–token âœ…

ç‰¹ç‚¹ï¼š
- æ²¡æœ‰ç”¨æˆ·å‚ä¸
- åº”ç”¨ä»£è¡¨è‡ªå·±ï¼ˆä¸æ˜¯ä»£è¡¨ç”¨æˆ·ï¼‰
- é€‚åˆåå°ä»»åŠ¡ã€å®šæ—¶ä»»åŠ¡
```

**ğŸ“‹ æµç¨‹å›¾ç¤º**
```
å¾®æœåŠ¡é—´è°ƒç”¨æµç¨‹ï¼š

Service A          Authorization Server          Service B
    |                        |                       |
    |--â‘ å®¢æˆ·ç«¯å‡­è¯è¯·æ±‚------->|                       |
    |  (client_id + secret)   |                       |
    |<-â‘¡è¿”å›è®¿é—®ä»¤ç‰Œ----------|                       |
    |                        |                       |
    |--â‘¢æºå¸¦tokenè°ƒç”¨API-------------------->|       |
    |<-â‘£è¿”å›APIæ•°æ®-------------------------|       |
```

**ğŸ’» ä»£ç ç¤ºä¾‹**
```javascript
// å¾®æœåŠ¡è·å–è®¿é—®ä»¤ç‰Œ
async function getServiceToken() {
    const response = await fetch(`${AUTH_SERVER}/token`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'Authorization': `Basic ${btoa(CLIENT_ID + ':' + CLIENT_SECRET)}`
        },
        body: new URLSearchParams({
            grant_type: 'client_credentials',
            scope: 'service:read service:write'
        })
    });
    
    return await response.json();
}

// ä½¿ç”¨tokenè°ƒç”¨å…¶ä»–æœåŠ¡
async function callOtherService(token) {
    const response = await fetch(`${SERVICE_B_URL}/api/data`, {
        headers: {
            'Authorization': `Bearer ${token.access_token}`
        }
    });
    
    return await response.json();
}
```

### 3.3 åˆ·æ–°ä»¤ç‰Œæœºåˆ¶


**ğŸ”„ ä¸ºä»€ä¹ˆéœ€è¦åˆ·æ–°ä»¤ç‰Œ**
```
è®¿é—®ä»¤ç‰Œç‰¹ç‚¹ï¼š
- ç”Ÿå‘½å‘¨æœŸçŸ­ï¼ˆé€šå¸¸15-30åˆ†é’Ÿï¼‰
- ä¸€æ—¦æ³„éœ²å½±å“æœ‰é™
- è¿‡æœŸåéœ€è¦é‡æ–°è·å–

åˆ·æ–°ä»¤ç‰Œç‰¹ç‚¹ï¼š
- ç”Ÿå‘½å‘¨æœŸé•¿ï¼ˆå‡ å¤©åˆ°å‡ ä¸ªæœˆï¼‰
- åªèƒ½ç”¨æ¥æ¢æ–°çš„è®¿é—®ä»¤ç‰Œ
- å­˜å‚¨æ›´å®‰å…¨ï¼ˆHttpOnly Cookieï¼‰
```

**ğŸ’» åˆ·æ–°å®ç°**
```javascript
// ä»¤ç‰Œåˆ·æ–°é€»è¾‘
async function refreshAccessToken(refreshToken) {
    try {
        const response = await fetch(`${AUTH_SERVER}/token`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({
                grant_type: 'refresh_token',
                refresh_token: refreshToken,
                client_id: CLIENT_ID
            })
        });
        
        const newTokens = await response.json();
        return newTokens;
    } catch (error) {
        // åˆ·æ–°å¤±è´¥ï¼Œéœ€è¦é‡æ–°ç™»å½•
        redirectToLogin();
    }
}

// è‡ªåŠ¨åˆ·æ–°ä¸­é—´ä»¶
function autoRefreshMiddleware(req, res, next) {
    const token = req.headers.authorization?.split(' ')[1];
    
    if (isTokenExpiringSoon(token)) {
        const refreshToken = req.cookies.refresh_token;
        const newTokens = await refreshAccessToken(refreshToken);
        
        // æ›´æ–°token
        res.setHeader('Authorization', `Bearer ${newTokens.access_token}`);
    }
    
    next();
}
```

### 3.4 è®¾å¤‡ç æ¨¡å¼


**ğŸ“± é€‚ç”¨åœºæ™¯**ï¼šæ™ºèƒ½ç”µè§†ã€ç‰©è”ç½‘è®¾å¤‡ç­‰è¾“å…¥å›°éš¾çš„è®¾å¤‡

**ğŸ’¡ ä½¿ç”¨åœºæ™¯**
```
å…¸å‹ä¾‹å­ï¼šåœ¨æ™ºèƒ½ç”µè§†ä¸Šç™»å½•Netflix

ä¼ ç»Ÿå›°éš¾ï¼š
- ç”µè§†è¾“å…¥è´¦å·å¯†ç å¾ˆéº»çƒ¦
- æ²¡æœ‰å®Œæ•´çš„æµè§ˆå™¨åŠŸèƒ½

è®¾å¤‡ç æ–¹æ¡ˆï¼š
- ç”µè§†æ˜¾ç¤ºä¸€ä¸ªçŸ­ç ï¼šWXYZ-1234
- ç”¨æˆ·åœ¨æ‰‹æœºä¸Šè®¿é—®æŒ‡å®šç½‘å€
- è¾“å…¥çŸ­ç å¹¶å®Œæˆç™»å½•
- ç”µè§†è‡ªåŠ¨è·å¾—æˆæƒ
```

**ğŸ“‹ æµç¨‹è¯´æ˜**
```
è®¾å¤‡æˆæƒæµç¨‹ï¼š

Smart TV           Authorization Server           User's Phone
    |                       |                         |
    |--â‘ è¯·æ±‚è®¾å¤‡ç --------->|                         |
    |<-â‘¡è¿”å›è®¾å¤‡ç &ç”¨æˆ·ç ----|                         |
    |  æ˜¾ç¤ºï¼šè®¿é—® xxx.com    |                         |
    |  è¾“å…¥ç ï¼šWXYZ-1234    |                         |
    |                      |<--â‘¢ç”¨æˆ·è®¿é—®å¹¶è¾“å…¥ç ------|
    |                      |---â‘£ç”¨æˆ·ç™»å½•ç¡®è®¤---------->|
    |--â‘¤è½®è¯¢æ£€æŸ¥æˆæƒçŠ¶æ€--->|                         |
    |<-â‘¥è¿”å›è®¿é—®ä»¤ç‰Œ--------|                         |
```

---

## 4. ğŸ†” OIDCæ ¸å¿ƒæ¦‚å¿µ


### 4.1 ID Tokenè¯¦è§£


**ğŸ« ID Tokenæ˜¯ä»€ä¹ˆ**
```
ç®€å•ç†è§£ï¼šç”¨æˆ·çš„"èº«ä»½è¯"

åŒ…å«ä¿¡æ¯ï¼š
- ç”¨æˆ·å”¯ä¸€æ ‡è¯†ï¼ˆsubï¼‰
- å§“åã€é‚®ç®±ç­‰åŸºæœ¬ä¿¡æ¯
- ä»¤ç‰Œå‘æ”¾æ—¶é—´å’Œæœ‰æ•ˆæœŸ
- å‘æ”¾æ–¹ä¿¡æ¯

æ ¼å¼ï¼šJWTï¼ˆJSON Web Tokenï¼‰
ç»“æ„ï¼šHeader.Payload.Signature
```

**ğŸ“‹ ID Tokenç»“æ„ç¤ºä¾‹**
```json
// Headerï¼ˆå¤´éƒ¨ï¼‰
{
  "alg": "RS256",
  "typ": "JWT",
  "kid": "key-id-1"
}

// Payloadï¼ˆè½½è·ï¼‰
{
  "iss": "https://auth.example.com",     // å‘æ”¾æ–¹
  "sub": "12345",                        // ç”¨æˆ·ID
  "aud": "my-app",                       // ç›®æ ‡åº”ç”¨
  "exp": 1640995200,                     // è¿‡æœŸæ—¶é—´
  "iat": 1640991600,                     // å‘æ”¾æ—¶é—´
  "auth_time": 1640991500,               // è®¤è¯æ—¶é—´
  "nonce": "random-123",                 // é˜²é‡æ”¾
  "name": "å¼ ä¸‰",                        // ç”¨æˆ·å§“å
  "email": "zhang@example.com",          // é‚®ç®±
  "picture": "https://avatar.com/123.jpg" // å¤´åƒ
}

// Signatureï¼ˆç­¾åï¼‰
// ç”¨ç§é’¥å¯¹Headerå’ŒPayloadçš„ç­¾åï¼Œç¡®ä¿ä¸è¢«ç¯¡æ”¹
```

### 4.2 UserInfoç«¯ç‚¹


**ğŸ“¡ UserInfoçš„ä½œç”¨**
```
ID Tokené™åˆ¶ï¼š
- å¤§å°æœ‰é™åˆ¶ï¼ˆURLé•¿åº¦é™åˆ¶ï¼‰
- ä¿¡æ¯ç›¸å¯¹å›ºå®š
- ä¸èƒ½å®æ—¶æ›´æ–°

UserInfoä¼˜åŠ¿ï¼š
- å¯ä»¥è¿”å›æ›´è¯¦ç»†çš„ç”¨æˆ·ä¿¡æ¯
- ä¿¡æ¯å¯ä»¥å®æ—¶è·å–
- æ”¯æŒæ›´å¤šè‡ªå®šä¹‰å±æ€§
```

**ğŸ’» UserInfoè°ƒç”¨ç¤ºä¾‹**
```javascript
// è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
async function getUserInfo(accessToken) {
    const response = await fetch(`${AUTH_SERVER}/userinfo`, {
        headers: {
            'Authorization': `Bearer ${accessToken}`,
            'Accept': 'application/json'
        }
    });
    
    const userInfo = await response.json();
    return userInfo;
}

// è¿”å›çš„ç”¨æˆ·ä¿¡æ¯ç¤ºä¾‹
{
    "sub": "12345",
    "name": "å¼ ä¸‰",
    "given_name": "ä¸‰",
    "family_name": "å¼ ",
    "email": "zhang@example.com",
    "email_verified": true,
    "picture": "https://avatar.com/123.jpg",
    "locale": "zh-CN",
    "updated_at": 1640991600,
    // è‡ªå®šä¹‰å±æ€§
    "department": "æŠ€æœ¯éƒ¨",
    "role": "é«˜çº§å·¥ç¨‹å¸ˆ",
    "phone": "+86-138****1234"
}
```

### 4.3 nonceå‚æ•°è¯¦è§£


**ğŸ”’ nonceçš„å®‰å…¨ä½œç”¨**
```
é—®é¢˜ï¼šé‡æ”¾æ”»å‡»
æ”»å‡»è€…å¯èƒ½æˆªè·ID Tokenå¹¶é‡å¤ä½¿ç”¨

nonceè§£å†³æ–¹æ¡ˆï¼š
1. å®¢æˆ·ç«¯ç”Ÿæˆéšæœºnonceå€¼
2. å‘èµ·æˆæƒè¯·æ±‚æ—¶æºå¸¦nonce
3. æˆæƒæœåŠ¡å™¨å°†nonceåŒ…å«åœ¨ID Tokenä¸­
4. å®¢æˆ·ç«¯éªŒè¯è¿”å›çš„nonceæ˜¯å¦åŒ¹é…

ä½œç”¨ï¼šç¡®ä¿ID Tokenæ˜¯ä¸ºå½“å‰è¯·æ±‚ä¸“é—¨ç”Ÿæˆçš„
```

**ğŸ’» nonceå®ç°**
```javascript
// 1. ç”Ÿæˆå¹¶å­˜å‚¨nonce
function generateNonce() {
    const nonce = crypto.randomBytes(16).toString('hex');
    sessionStorage.setItem('oidc_nonce', nonce);
    return nonce;
}

// 2. æˆæƒè¯·æ±‚æºå¸¦nonce
const nonce = generateNonce();
const authUrl = `${AUTH_SERVER}/authorize?` +
    `response_type=code&` +
    `client_id=${CLIENT_ID}&` +
    `scope=openid profile email&` +
    `nonce=${nonce}&` +
    `redirect_uri=${REDIRECT_URI}`;

// 3. éªŒè¯è¿”å›çš„ID Tokenä¸­çš„nonce
function validateIdToken(idToken) {
    const payload = JSON.parse(atob(idToken.split('.')[1]));
    const expectedNonce = sessionStorage.getItem('oidc_nonce');
    
    if (payload.nonce !== expectedNonce) {
        throw new Error('NonceéªŒè¯å¤±è´¥ï¼Œå¯èƒ½é­å—é‡æ”¾æ”»å‡»');
    }
    
    // éªŒè¯æˆåŠŸåæ¸…é™¤nonce
    sessionStorage.removeItem('oidc_nonce');
    return payload;
}
```

### 4.4 acr/amrè®¤è¯ä¸Šä¸‹æ–‡


**ğŸ” acrï¼ˆAuthentication Context Class Referenceï¼‰**
```
ç®€å•ç†è§£ï¼šè®¤è¯å¼ºåº¦çº§åˆ«

çº§åˆ«ç¤ºä¾‹ï¼š
- acr=0ï¼šæ— è®¤è¯
- acr=1ï¼šåŸºæœ¬å¯†ç è®¤è¯
- acr=2ï¼šå¤šå› å­è®¤è¯
- acr=3ï¼šé«˜å¼ºåº¦è®¤è¯ï¼ˆç¡¬ä»¶ä»¤ç‰Œç­‰ï¼‰

åº”ç”¨åœºæ™¯ï¼š
- è½¬è´¦æ“ä½œè¦æ±‚acr>=2ï¼ˆå¤šå› å­è®¤è¯ï¼‰
- æŸ¥çœ‹ä½™é¢åªéœ€è¦acr>=1ï¼ˆåŸºæœ¬è®¤è¯ï¼‰
```

**ğŸ” amrï¼ˆAuthentication Methods Referenceï¼‰**
```
ç®€å•ç†è§£ï¼šå…·ä½“çš„è®¤è¯æ–¹å¼

å¸¸è§æ–¹æ³•ï¼š
- pwdï¼šå¯†ç è®¤è¯
- smsï¼šçŸ­ä¿¡éªŒè¯ç 
- otpï¼šåŠ¨æ€ä»¤ç‰Œ
- bioï¼šç”Ÿç‰©è¯†åˆ«
- faceï¼šäººè„¸è¯†åˆ«
- fptï¼šæŒ‡çº¹è¯†åˆ«

å®é™…åº”ç”¨ï¼š
ç”¨æˆ·é€šè¿‡"å¯†ç +çŸ­ä¿¡éªŒè¯ç "ç™»å½•
amr: ["pwd", "sms"]
```

**ğŸ’» è®¤è¯ä¸Šä¸‹æ–‡ä½¿ç”¨**
```javascript
// è¯·æ±‚ç‰¹å®šè®¤è¯çº§åˆ«
const authUrl = `${AUTH_SERVER}/authorize?` +
    `response_type=code&` +
    `client_id=${CLIENT_ID}&` +
    `scope=openid profile&` +
    `acr_values=2&` +  // è¦æ±‚å¤šå› å­è®¤è¯
    `redirect_uri=${REDIRECT_URI}`;

// éªŒè¯è®¤è¯çº§åˆ«
function checkAuthLevel(idToken) {
    const payload = JSON.parse(atob(idToken.split('.')[1]));
    
    if (payload.acr < 2) {
        // è®¤è¯çº§åˆ«ä¸è¶³ï¼Œè¦æ±‚é‡æ–°è®¤è¯
        return redirectToStrongAuth();
    }
    
    // æ£€æŸ¥è®¤è¯æ–¹å¼
    if (!payload.amr.includes('sms')) {
        alert('éœ€è¦çŸ­ä¿¡éªŒè¯æ‰èƒ½è¿›è¡Œæ­¤æ“ä½œ');
        return false;
    }
    
    return true;
}
```

---

## 5. ğŸ”§ Scopeså’ŒClaimsè®¾è®¡


### 5.1 Scopesï¼ˆæƒé™èŒƒå›´ï¼‰è®¾è®¡


**ğŸ¯ æœ€å°æƒé™åŸåˆ™**
```
é”™è¯¯è®¾è®¡ï¼š
scope: "admin"  // æƒé™å¤ªå¤§ï¼Œé£é™©é«˜

æ­£ç¡®è®¾è®¡ï¼š
scope: "user:read user:profile:edit order:create"

ç»†ç²’åº¦æƒé™ï¼š
- user:read        # è¯»å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
- user:profile:edit # ç¼–è¾‘ç”¨æˆ·èµ„æ–™
- user:password:change # ä¿®æ”¹å¯†ç 
- order:read       # æŸ¥çœ‹è®¢å•
- order:create     # åˆ›å»ºè®¢å•
- order:cancel     # å–æ¶ˆè®¢å•
```

**ğŸ“Š Scopeså±‚æ¬¡è®¾è®¡**
```
æƒé™å±‚çº§ç»“æ„ï¼š

ä¸šåŠ¡åŸŸçº§åˆ«ï¼š
â”œâ”€â”€ user          # ç”¨æˆ·ç›¸å…³
â”œâ”€â”€ order         # è®¢å•ç›¸å…³
â”œâ”€â”€ product       # å•†å“ç›¸å…³
â””â”€â”€ payment       # æ”¯ä»˜ç›¸å…³

æ“ä½œçº§åˆ«ï¼š
â”œâ”€â”€ read          # è¯»å–æƒé™
â”œâ”€â”€ write         # å†™å…¥æƒé™
â”œâ”€â”€ delete        # åˆ é™¤æƒé™
â””â”€â”€ admin         # ç®¡ç†æƒé™

ç»„åˆç¤ºä¾‹ï¼š
- user:read          # è¯»å–ç”¨æˆ·ä¿¡æ¯
- order:write        # åˆ›å»º/ä¿®æ”¹è®¢å•
- product:admin      # å•†å“ç®¡ç†æƒé™
- payment:read       # æŸ¥çœ‹æ”¯ä»˜ä¿¡æ¯
```

**ğŸ’» ScopeséªŒè¯å®ç°**
```javascript
// æƒé™æ£€æŸ¥ä¸­é—´ä»¶
function requireScopes(requiredScopes) {
    return (req, res, next) => {
        const token = req.headers.authorization?.split(' ')[1];
        
        if (!token) {
            return res.status(401).json({ error: 'Token required' });
        }
        
        const payload = jwt.decode(token);
        const userScopes = payload.scope.split(' ');
        
        // æ£€æŸ¥æ˜¯å¦æ‹¥æœ‰æ‰€æœ‰å¿…éœ€æƒé™
        const hasAllScopes = requiredScopes.every(scope => 
            userScopes.includes(scope)
        );
        
        if (!hasAllScopes) {
            return res.status(403).json({
                error: 'Insufficient permissions',
                required: requiredScopes,
                current: userScopes
            });
        }
        
        next();
    };
}

// ä½¿ç”¨ç¤ºä¾‹
app.get('/api/users/:id', 
    requireScopes(['user:read']),
    (req, res) => {
        // åªæœ‰æ‹¥æœ‰user:readæƒé™æ‰èƒ½è®¿é—®
    }
);

app.put('/api/users/:id/profile',
    requireScopes(['user:profile:edit']),
    (req, res) => {
        // éœ€è¦ç¼–è¾‘æƒé™æ‰èƒ½ä¿®æ”¹èµ„æ–™
    }
);

app.delete('/api/orders/:id',
    requireScopes(['order:delete', 'order:admin']),
    (req, res) => {
        // éœ€è¦åˆ é™¤æƒé™æˆ–ç®¡ç†å‘˜æƒé™
    }
);
```

### 5.2 Claimsï¼ˆå£°æ˜ï¼‰è®¾è®¡


**ğŸ“‹ Claimsåˆ†ç±»**
```
æ ‡å‡†Claimsï¼ˆOIDCè§„å®šï¼‰ï¼š
- subï¼šç”¨æˆ·å”¯ä¸€æ ‡è¯†
- nameï¼šç”¨æˆ·å§“å
- emailï¼šé‚®ç®±åœ°å€
- pictureï¼šå¤´åƒURL
- localeï¼šè¯­è¨€åå¥½

ä¸šåŠ¡Claimsï¼ˆè‡ªå®šä¹‰ï¼‰ï¼š
- departmentï¼šéƒ¨é—¨
- roleï¼šè§’è‰²
- levelï¼šçº§åˆ«
- permissionsï¼šå…·ä½“æƒé™åˆ—è¡¨
- tenant_idï¼šç§Ÿæˆ·IDï¼ˆå¤šç§Ÿæˆ·åœºæ™¯ï¼‰
```

**ğŸ—ï¸ ç»†ç²’åº¦Claimsè®¾è®¡**
```json
// ç”¨æˆ·èº«ä»½å£°æ˜ç¤ºä¾‹
{
  "sub": "user_12345",
  "name": "å¼ ä¸‰",
  "email": "zhang@company.com",
  "email_verified": true,
  
  // ç»„ç»‡ä¿¡æ¯
  "org": {
    "id": "org_001",
    "name": "ç§‘æŠ€å…¬å¸",
    "department": "ç ”å‘éƒ¨",
    "team": "åç«¯å›¢é˜Ÿ"
  },
  
  // è§’è‰²æƒé™
  "roles": ["developer", "team_lead"],
  "permissions": [
    "code:read",
    "code:write", 
    "review:approve",
    "deploy:staging"
  ],
  
  // ä¸šåŠ¡å±æ€§
  "employee_id": "EMP001",
  "hire_date": "2020-01-15",
  "security_level": 2,
  
  // ä¸´æ—¶å±æ€§
  "project_access": ["proj_a", "proj_b"],
  "temporary_admin": {
    "granted_at": "2024-01-01T00:00:00Z",
    "expires_at": "2024-01-31T23:59:59Z"
  }
}
```

**ğŸ’» Claimsä½¿ç”¨ç¤ºä¾‹**
```javascript
// åŸºäºClaimsçš„æƒé™æ£€æŸ¥
function checkProjectAccess(req, res, next) {
    const token = req.headers.authorization?.split(' ')[1];
    const payload = jwt.decode(token);
    const projectId = req.params.projectId;
    
    // æ£€æŸ¥é¡¹ç›®è®¿é—®æƒé™
    if (!payload.project_access.includes(projectId)) {
        return res.status(403).json({
            error: 'No access to this project',
            projectId,
            allowedProjects: payload.project_access
        });
    }
    
    // æ£€æŸ¥å®‰å…¨çº§åˆ«
    if (payload.security_level < 2) {
        return res.status(403).json({
            error: 'Insufficient security level',
            required: 2,
            current: payload.security_level
        });
    }
    
    next();
}

// åŠ¨æ€æƒé™æ£€æŸ¥
function hasPermission(userClaims, requiredPermission) {
    // ç›´æ¥æƒé™æ£€æŸ¥
    if (userClaims.permissions.includes(requiredPermission)) {
        return true;
    }
    
    // è§’è‰²æƒé™æ£€æŸ¥
    const rolePermissions = {
        'admin': ['*'],  // ç®¡ç†å‘˜æ‹¥æœ‰æ‰€æœ‰æƒé™
        'team_lead': ['code:*', 'review:*'],
        'developer': ['code:read', 'code:write']
    };
    
    for (const role of userClaims.roles) {
        const permissions = rolePermissions[role] || [];
        if (permissions.includes('*') || 
            permissions.includes(requiredPermission) ||
            permissions.some(p => p.endsWith(':*') && 
                requiredPermission.startsWith(p.slice(0, -1)))) {
            return true;
        }
    }
    
    return false;
}
```

---

## 6. ğŸ¢ ä¼ä¸šç›®å½•é›†æˆ


### 6.1 SAMLé›†æˆåŸºç¡€


**ğŸ”— SAMLä¸OAuth2çš„å…³ç³»**
```
SAMLï¼šä¼ä¸šçº§èº«ä»½è®¤è¯æ ‡å‡†
OAuth2ï¼šæˆæƒæ¡†æ¶

é›†æˆåœºæ™¯ï¼š
ç”¨æˆ·åœ¨ä¼ä¸šADä¸­ç™»å½• â†’ SAMLè®¤è¯ â†’ è·å–OAuth2 token

æµç¨‹ï¼š
Enterprise AD â†’ SAML IdP â†’ OAuth2 AS â†’ åº”ç”¨ç³»ç»Ÿ
```

**ğŸ“‹ SAMLé›†æˆè·¯å¾„**
```
é›†æˆæ¶æ„ï¼š

å‘˜å·¥                ä¼ä¸šAD/LDAP              OAuth2æˆæƒæœåŠ¡å™¨              ä¸šåŠ¡åº”ç”¨
 |                       |                         |                      |
 |--â‘ è®¿é—®åº”ç”¨----------->|                         |                      |
 |<-â‘¡é‡å®šå‘åˆ°ADç™»å½•------|--â‘¢SAMLè®¤è¯è¯·æ±‚-------->|                      |
 |--â‘£ADè´¦å·ç™»å½•--------->|--â‘¤SAMLæ–­è¨€----------->|                      |
 |                       |<-â‘¥éªŒè¯æ–­è¨€-------------|                      |
 |                       |                         |--â‘¦å‘æ”¾OAuth2 token->|
 |<-â‘§åº”ç”¨ç™»å½•æˆåŠŸ------------------------------------|                      |
```

**ğŸ’» SAMLé›†æˆé…ç½®ç¤ºä¾‹**
```xml
<!-- SAML Service Provideré…ç½® -->
<saml:SPSSODescriptor>
    <saml:NameIDFormat>
        urn:oasis:names:tc:SAML:2.0:nameid-format:persistent
    </saml:NameIDFormat>
    
    <saml:AssertionConsumerService 
        Binding="urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST"
        Location="https://oauth.company.com/saml/acs"
        Index="0" />
</saml:SPSSODescriptor>
```

```javascript
// SAMLæ–­è¨€å¤„ç†
app.post('/saml/acs', async (req, res) => {
    try {
        // éªŒè¯SAMLæ–­è¨€
        const assertion = await saml.validateAssertion(req.body.SAMLResponse);
        
        // æå–ç”¨æˆ·ä¿¡æ¯
        const userInfo = {
            employeeId: assertion.attributes.employeeId,
            email: assertion.attributes.email,
            department: assertion.attributes.department,
            roles: assertion.attributes.roles.split(',')
        };
        
        // ç”ŸæˆOAuth2 token
        const tokens = await generateOAuth2Tokens(userInfo);
        
        // é‡å®šå‘åˆ°åŸå§‹åº”ç”¨
        res.redirect(`/dashboard?access_token=${tokens.access_token}`);
    } catch (error) {
        res.status(400).json({ error: 'SAML authentication failed' });
    }
});
```

### 6.2 LDAP/ADå¯¹æ¥


**ğŸ“– LDAPåŸºç¡€æ¦‚å¿µ**
```
LDAPï¼šè½»é‡çº§ç›®å½•è®¿é—®åè®®

ä¼ä¸šåº”ç”¨ï¼š
- å­˜å‚¨å‘˜å·¥ä¿¡æ¯
- ç»„ç»‡æ¶æ„ç®¡ç†
- ç»Ÿä¸€èº«ä»½è®¤è¯
- æƒé™ç®¡ç†

ADï¼ˆActive Directoryï¼‰ï¼š
å¾®è½¯çš„LDAPå®ç°ï¼Œä¼ä¸šä¸­æœ€å¸¸ç”¨
```

**ğŸ”§ LDAPå¯¹æ¥å®ç°**
```javascript
const ldap = require('ldapjs');

// LDAPè¿æ¥é…ç½®
const ldapClient = ldap.createClient({
    url: 'ldap://company-dc.local:389',
    bindDN: 'cn=service-account,ou=Service Accounts,dc=company,dc=local',
    bindCredentials: 'service-password'
});

// LDAPç”¨æˆ·è®¤è¯
async function authenticateUser(username, password) {
    try {
        // 1. æŸ¥æ‰¾ç”¨æˆ·
        const searchOptions = {
            filter: `(sAMAccountName=${username})`,
            scope: 'sub',
            attributes: ['cn', 'mail', 'department', 'memberOf']
        };
        
        const searchResult = await ldapSearch('dc=company,dc=local', searchOptions);
        if (searchResult.length === 0) {
            throw new Error('User not found');
        }
        
        const userDN = searchResult[0].dn;
        const userInfo = searchResult[0].attributes;
        
        // 2. éªŒè¯å¯†ç 
        await ldapBind(userDN, password);
        
        // 3. æå–ç”¨æˆ·ä¿¡æ¯å’Œè§’è‰²
        const roles = extractRolesFromGroups(userInfo.memberOf);
        
        return {
            username: userInfo.cn,
            email: userInfo.mail,
            department: userInfo.department,
            roles: roles,
            authenticated: true
        };
    } catch (error) {
        return { authenticated: false, error: error.message };
    }
}

// æå–ç”¨æˆ·è§’è‰²
function extractRolesFromGroups(memberOf) {
    const roleMapping = {
        'CN=Developers,OU=Groups,DC=company,DC=local': 'developer',
        'CN=Team Leads,OU=Groups,DC=company,DC=local': 'team_lead',
        'CN=Admins,OU=Groups,DC=company,DC=local': 'admin'
    };
    
    return memberOf
        .map(group => roleMapping[group])
        .filter(role => role !== undefined);
}
```

### 6.3 ä¼ä¸šSSOæ‰©å±•æ–¹å¼


**ğŸŒ SSOé›†æˆæ¨¡å¼**
```
ä¼ä¸šSSOé›†æˆæ¶æ„ï¼š

                    ä¼ä¸šSSOç½‘å…³
                         |
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        |               |               |
    SAML IdP        OIDC Provider    LDAP/AD
        |               |               |
    â”œâ”€SAP           â”œâ”€å†…éƒ¨ç³»ç»Ÿ        â”œâ”€é‚®ä»¶ç³»ç»Ÿ
    â”œâ”€Salesforce    â”œâ”€å¼€å‘å·¥å…·        â”œâ”€æ–‡ä»¶ç³»ç»Ÿ
    â””â”€Office365     â””â”€ç›‘æ§ç³»ç»Ÿ        â””â”€VPNç³»ç»Ÿ
```

**ğŸ’» ç»Ÿä¸€SSOå®ç°**
```javascript
// ä¼ä¸šSSOè·¯ç”±é…ç½®
const ssoRoutes = {
    // ä¸åŒåº”ç”¨çš„SSOé…ç½®
    'app1': {
        protocol: 'SAML',
        idp_url: 'https://sso.company.com/saml/idp',
        sp_acs: 'https://app1.company.com/saml/acs'
    },
    'app2': {
        protocol: 'OIDC', 
        auth_url: 'https://sso.company.com/oidc/auth',
        client_id: 'app2-client-id'
    },
    'app3': {
        protocol: 'OAuth2',
        auth_url: 'https://sso.company.com/oauth2/authorize',
        client_id: 'app3-client-id'
    }
};

// SSOä¸­é—´ä»¶
function ssoMiddleware(req, res, next) {
    const appId = req.headers['x-app-id'];
    const config = ssoRoutes[appId];
    
    if (!config) {
        return res.status(400).json({ error: 'Unknown application' });
    }
    
    // æ£€æŸ¥ç°æœ‰ä¼šè¯
    const ssoSession = req.session.sso;
    if (ssoSession && !isSessionExpired(ssoSession)) {
        req.user = ssoSession.user;
        return next();
    }
    
    // é‡å®šå‘åˆ°å¯¹åº”çš„è®¤è¯æ–¹å¼
    switch (config.protocol) {
        case 'SAML':
            return redirectToSAML(res, config);
        case 'OIDC':
            return redirectToOIDC(res, config);
        case 'OAuth2':
            return redirectToOAuth2(res, config);
        default:
            return res.status(500).json({ error: 'Unsupported protocol' });
    }
}
```

---

## 7. ğŸ› ï¸ ä¸»æµå®ç°æ–¹æ¡ˆ


### 7.1 Keycloakï¼ˆå¼€æºæ¨èï¼‰


**ğŸŒŸ Keycloakä¼˜åŠ¿**
```
åŠŸèƒ½å…¨é¢ï¼š
âœ… å®Œæ•´çš„OAuth2/OIDCå®ç°
âœ… ç”¨æˆ·ç®¡ç†å’Œæ³¨å†Œ
âœ… ç¤¾äº¤ç™»å½•é›†æˆ
âœ… å¤šç§Ÿæˆ·æ”¯æŒ
âœ… ä¸»é¢˜å®šåˆ¶

ä¼ä¸šç‰¹æ€§ï¼š
âœ… LDAP/ADé›†æˆ
âœ… SAMLæ”¯æŒ
âœ… å•ç‚¹ç™»å½•(SSO)
âœ… èº«ä»½ä»£ç†
âœ… ç»†ç²’åº¦æƒé™æ§åˆ¶
```

**ğŸ’» Keycloakå¿«é€Ÿéƒ¨ç½²**
```bash
# Dockeréƒ¨ç½²Keycloak
version: '3.8'
services:
  keycloak:
    image: quay.io/keycloak/keycloak:22.0
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin123
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: password
    ports:
      - "8080:8080"
    depends_on:
      - postgres
    command: start-dev

  postgres:
    image: postgres:13
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: password
    volumes:
      - keycloak_data:/var/lib/postgresql/data

volumes:
  keycloak_data:
```

**ğŸ”§ Keycloakå®¢æˆ·ç«¯é…ç½®**
```javascript
// Keycloak JavaScripté€‚é…å™¨
import Keycloak from 'keycloak-js';

const keycloak = new Keycloak({
    url: 'http://localhost:8080',
    realm: 'my-realm',
    clientId: 'my-app'
});

// åˆå§‹åŒ–å’Œç™»å½•
async function initAuth() {
    try {
        const authenticated = await keycloak.init({
            onLoad: 'login-required',
            checkLoginIframe: false
        });
        
        if (authenticated) {
            console.log('ç”¨æˆ·å·²è®¤è¯');
            console.log('Token:', keycloak.token);
            console.log('ç”¨æˆ·ä¿¡æ¯:', keycloak.tokenParsed);
        }
    } catch (error) {
        console.error('è®¤è¯å¤±è´¥:', error);
    }
}

// è‡ªåŠ¨åˆ·æ–°token
setInterval(() => {
    keycloak.updateToken(70) // æå‰70ç§’åˆ·æ–°
        .then(refreshed => {
            if (refreshed) {
                console.log('Tokenå·²åˆ·æ–°');
            }
        })
        .catch(() => {
            console.log('Tokenåˆ·æ–°å¤±è´¥ï¼Œéœ€è¦é‡æ–°ç™»å½•');
            keycloak.login();
        });
}, 60000);

// è°ƒç”¨å—ä¿æŠ¤çš„API
async function callProtectedAPI() {
    try {
        const response = await fetch('/api/protected', {
            headers: {
                'Authorization': `Bearer ${keycloak.token}`
            }
        });
        
        const data = await response.json();
        return data;
    } catch (error) {
        if (error.status === 401) {
            // Tokenè¿‡æœŸï¼Œå°è¯•åˆ·æ–°
            await keycloak.updateToken();
            return callProtectedAPI(); // é‡è¯•
        }
        throw error;
    }
}
```

### 7.2 Auth0ï¼ˆå•†ä¸šæ–¹æ¡ˆï¼‰


**ğŸ¢ Auth0ç‰¹ç‚¹**
```
æ‰˜ç®¡æœåŠ¡ï¼š
âœ… æ— éœ€è‡ªå»ºåŸºç¡€è®¾æ–½
âœ… 99.9%å¯ç”¨æ€§ä¿è¯
âœ… å…¨çƒCDNåŠ é€Ÿ
âœ… è‡ªåŠ¨æ›´æ–°å’Œç»´æŠ¤

å¼€å‘å‹å¥½ï¼š
âœ… ä¸°å¯Œçš„SDKå’Œç¤ºä¾‹
âœ… å¯è§†åŒ–é…ç½®ç•Œé¢
âœ… è¯¦ç»†çš„æ–‡æ¡£å’Œæ•™ç¨‹
âœ… å¼ºå¤§çš„è§„åˆ™å¼•æ“

ä¼ä¸šçº§ï¼š
âœ… å¤šå› å­è®¤è¯
âœ… å¼‚å¸¸æ£€æµ‹
âœ… å®¡è®¡æ—¥å¿—
âœ… åˆè§„è®¤è¯
```

**ğŸ’» Auth0é›†æˆç¤ºä¾‹**
```javascript
// Auth0 React SDKä½¿ç”¨
import { Auth0Provider, useAuth0 } from '@auth0/auth0-react';

// 1. åº”ç”¨åŒ…è£…
function App() {
    return (
        <Auth0Provider
            domain="your-tenant.auth0.com"
            clientId="your-client-id"
            redirectUri={window.location.origin}
            audience="https://your-api.com"
            scope="openid profile email offline_access"
        >
            <MyApp />
        </Auth0Provider>
    );
}

// 2. ç»„ä»¶ä¸­ä½¿ç”¨
function MyApp() {
    const { 
        isLoading, 
        isAuthenticated, 
        error, 
        user, 
        loginWithRedirect,
        logout,
        getAccessTokenSilently 
    } = useAuth0();

    if (isLoading) return <div>åŠ è½½ä¸­...</div>;
    if (error) return <div>è®¤è¯é”™è¯¯: {error.message}</div>;

    if (!isAuthenticated) {
        return (
            <button onClick={() => loginWithRedirect()}>
                ç™»å½•
            </button>
        );
    }

    return (
        <div>
            <h1>æ¬¢è¿, {user.name}!</h1>
            <button onClick={() => logout({ returnTo: window.location.origin })}>
                é€€å‡º
            </button>
        </div>
    );
}

// 3. APIè°ƒç”¨
async function callAPI() {
    const { getAccessTokenSilently } = useAuth0();
    
    try {
        const token = await getAccessTokenSilently({
            audience: 'https://your-api.com',
            scope: 'read:data write:data'
        });

        const response = await fetch('/api/protected', {
            headers: {
                Authorization: `Bearer ${token}`
            }
        });

        return await response.json();
    } catch (error) {
        console.error('APIè°ƒç”¨å¤±è´¥:', error);
    }
}
```

### 7.3 Spring Authorization Server


**â˜• Springç”Ÿæ€é›†æˆ**
```
Springä¼˜åŠ¿ï¼š
âœ… ä¸Spring Bootå®Œç¾é›†æˆ
âœ… åŸºäºSpring Security
âœ… é«˜åº¦å¯å®šåˆ¶
âœ… ä¼ä¸šçº§ç‰¹æ€§æ”¯æŒ

é€‚ç”¨åœºæ™¯ï¼š
- JavaæŠ€æœ¯æ ˆä¼ä¸š
- éœ€è¦æ·±åº¦å®šåˆ¶
- é«˜æ€§èƒ½è¦æ±‚
- ç°æœ‰Springåº”ç”¨é›†æˆ
```

**ğŸ’» Spring Authorization Serveré…ç½®**
```java
// 1. æˆæƒæœåŠ¡å™¨é…ç½®
@Configuration
@EnableAuthorizationServer
public class AuthorizationServerConfig {
    
    @Bean
    public RegisteredClientRepository registeredClientRepository() {
        RegisteredClient registeredClient = RegisteredClient.withId(UUID.randomUUID().toString())
                .clientId("my-client")
                .clientSecret("{noop}secret")
                .clientAuthenticationMethod(ClientAuthenticationMethod.CLIENT_SECRET_BASIC)
                .authorizationGrantType(AuthorizationGrantType.AUTHORIZATION_CODE)
                .authorizationGrantType(AuthorizationGrantType.REFRESH_TOKEN)
                .redirectUri("http://127.0.0.1:8080/login/oauth2/code/my-client")
                .scope(OidcScopes.OPENID)
                .scope(OidcScopes.PROFILE)
                .scope("read")
                .scope("write")
                .tokenSettings(TokenSettings.builder()
                        .accessTokenTimeToLive(Duration.ofMinutes(15))
                        .refreshTokenTimeToLive(Duration.ofDays(30))
                        .build())
                .build();

        return new InMemoryRegisteredClientRepository(registeredClient);
    }

    @Bean
    public JWKSource<SecurityContext> jwkSource() {
        KeyPair keyPair = generateRsaKey();
        RSAKey rsaKey = new RSAKey.Builder((RSAPublicKey) keyPair.getPublic())
                .privateKey((RSAPrivateKey) keyPair.getPrivate())
                .keyID(UUID.randomUUID().toString())
                .build();
        JWKSet jwkSet = new JWKSet(rsaKey);
        return new ImmutableJWKSet<>(jwkSet);
    }

    @Bean
    public JwtDecoder jwtDecoder(JWKSource<SecurityContext> jwkSource) {
        return OAuth2AuthorizationServerConfiguration.jwtDecoder(jwkSource);
    }
}

// 2. èµ„æºæœåŠ¡å™¨é…ç½®
@Configuration
@EnableWebSecurity
public class ResourceServerConfig {

    @Bean
    public SecurityFilterChain resourceServerSecurityFilterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(authorize -> authorize
                .requestMatchers("/api/public/**").permitAll()
                .requestMatchers("/api/user/**").hasAuthority("SCOPE_read")
                .requestMatchers("/api/admin/**").hasAuthority("SCOPE_write")
                .anyRequest().authenticated()
            )
            .oauth2ResourceServer(resourceServer -> resourceServer
                .jwt(Customizer.withDefaults())
            );
        
        return http.build();
    }
}

// 3. è‡ªå®šä¹‰ç”¨æˆ·ä¿¡æ¯ç«¯ç‚¹
@RestController
public class UserInfoController {
    
    @GetMapping("/userinfo")
    public Map<String, Object> userInfo(Authentication authentication) {
        Map<String, Object> userInfo = new HashMap<>();
        userInfo.put("sub", authentication.getName());
        userInfo.put("name", "ç”¨æˆ·å§“å");
        userInfo.put("email", "user@example.com");
        userInfo.put("roles", authentication.getAuthorities());
        
        return userInfo;
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»ç†è§£çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ” OAuth2æœ¬è´¨ï¼š
- æˆæƒæ¡†æ¶ï¼Œä¸æ˜¯è®¤è¯åè®®
- ç”¨tokenä»£æ›¿å¯†ç ï¼Œå®‰å…¨å¯æ§
- å››å¤§è§’è‰²åˆ†å·¥æ˜ç¡®

ğŸ†” OIDCæ‰©å±•ï¼š
- OAuth2 + èº«ä»½è®¤è¯
- ID Tokenæä¾›ç”¨æˆ·èº«ä»½ä¿¡æ¯
- UserInfoç«¯ç‚¹è·å–è¯¦ç»†ä¿¡æ¯

ğŸ”’ å®‰å…¨æœºåˆ¶ï¼š
- PKCEé˜²æ­¢æˆæƒç åŠ«æŒ
- nonceé˜²æ­¢é‡æ”¾æ”»å‡»
- åˆ·æ–°ä»¤ç‰Œå»¶é•¿ä¼šè¯
```

### 8.2 å…³é”®åº”ç”¨åœºæ™¯


**ğŸ¯ å…¸å‹ä½¿ç”¨åœºæ™¯**
```
ç¬¬ä¸‰æ–¹ç™»å½•ï¼š
- å¾®ä¿¡ç™»å½•ã€GitHubç™»å½•
- é¿å…é‡å¤æ³¨å†Œï¼Œæå‡ç”¨æˆ·ä½“éªŒ

å¾®æœåŠ¡è®¤è¯ï¼š
- æœåŠ¡é—´å®‰å…¨è°ƒç”¨
- ç»Ÿä¸€çš„èº«ä»½éªŒè¯å’Œæˆæƒ

ä¼ä¸šSSOï¼š
- ä¸€æ¬¡ç™»å½•ï¼Œå¤šç³»ç»Ÿè®¿é—®
- ä¸ç°æœ‰AD/LDAPé›†æˆ

ç§»åŠ¨åº”ç”¨ï¼š
- å®‰å…¨çš„APIè®¿é—®
- ç¦»çº¿è®¿é—®èƒ½åŠ›
```

### 8.3 å®æ–½å»ºè®®


**ğŸ“‹ æŠ€æœ¯é€‰å‹æŒ‡å¯¼**
```
å¼€æºæ–¹æ¡ˆé€‰æ‹©ï¼š
- Keycloakï¼šåŠŸèƒ½å…¨é¢ï¼Œç¤¾åŒºæ´»è·ƒ
- Spring Authorization Serverï¼šJavaç”Ÿæ€é¦–é€‰

å•†ä¸šæ–¹æ¡ˆï¼š
- Auth0ï¼šå¼€å‘æ•ˆç‡é«˜ï¼ŒåŠŸèƒ½ä¸°å¯Œ
- Azure ADï¼šå¾®è½¯ç”Ÿæ€é›†æˆ

è‡ªå»ºè€ƒè™‘ï¼š
- æŠ€æœ¯å›¢é˜Ÿèƒ½åŠ›
- å®‰å…¨åˆè§„è¦æ±‚  
- ç»´æŠ¤æˆæœ¬é¢„ç®—
- å®šåˆ¶åŒ–éœ€æ±‚
```

**âš ï¸ å¸¸è§é™·é˜±é¿å…**
```
æƒé™è®¾è®¡ï¼š
âŒ ç²—ç²’åº¦æƒé™ï¼Œå®‰å…¨é£é™©é«˜
âœ… ç»†ç²’åº¦æƒé™ï¼Œæœ€å°æƒé™åŸåˆ™

ä»¤ç‰Œç®¡ç†ï¼š
âŒ é•¿æœŸæœ‰æ•ˆçš„è®¿é—®ä»¤ç‰Œ
âœ… çŸ­æœŸè®¿é—®ä»¤ç‰Œ+åˆ·æ–°ä»¤ç‰Œ

é›†æˆæµ‹è¯•ï¼š
âŒ åªåœ¨å¼€å‘ç¯å¢ƒæµ‹è¯•
âœ… å¤šç¯å¢ƒå®Œæ•´æµç¨‹æµ‹è¯•

é”™è¯¯å¤„ç†ï¼š
âŒ æš´éœ²æ•æ„Ÿé”™è¯¯ä¿¡æ¯
âœ… ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
```

**ğŸš€ æœ€ä½³å®è·µæ€»ç»“**
```
å®‰å…¨æ€§ï¼š
- ä½¿ç”¨HTTPSç¡®ä¿ä¼ è¾“å®‰å…¨
- å®šæœŸè½®æ¢å¯†é’¥å’Œå¯†é’¥
- å®æ–½rate limitingé˜²æ­¢æ”»å‡»
- è®°å½•å®¡è®¡æ—¥å¿—

å¯ç”¨æ€§ï¼š
- å®ç°ä¼˜é›…çš„é”™è¯¯å¤„ç†
- æä¾›ç”¨æˆ·å‹å¥½çš„ç•Œé¢
- æ”¯æŒå¤šç§ç™»å½•æ–¹å¼
- è€ƒè™‘ç¦»çº¿åœºæ™¯

å¯ç»´æŠ¤æ€§ï¼š
- æ¸…æ™°çš„æƒé™æ¨¡å‹è®¾è®¡
- å®Œå–„çš„æ–‡æ¡£å’Œç¤ºä¾‹
- è‡ªåŠ¨åŒ–æµ‹è¯•è¦†ç›–
- ç›‘æ§å‘Šè­¦æœºåˆ¶
```

**æ ¸å¿ƒè®°å¿†ç‚¹**ï¼š
- OAuth2è§£å†³æˆæƒé—®é¢˜ï¼ŒOIDCè§£å†³è®¤è¯é—®é¢˜
- å››å¤§è§’è‰²å„å¸å…¶èŒï¼Œæˆæƒæµç¨‹ç¯ç¯ç›¸æ‰£  
- å®‰å…¨æœºåˆ¶å±‚å±‚ä¿æŠ¤ï¼Œæƒé™è®¾è®¡ç²¾ç¡®æ§åˆ¶
- ä¼ä¸šé›†æˆéœ€è¦è€ƒè™‘ç°æœ‰ç³»ç»Ÿï¼Œé€‰å‹éœ€è¦å¹³è¡¡æˆæœ¬å’Œéœ€æ±‚