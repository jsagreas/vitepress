---
title: 15ã€è½åœ°æ¶æ„ä¸è¿ç§»å®è·µ
---
## ğŸ“š ç›®å½•

1. [å¾®æœåŠ¡è®¤è¯æ¶æ„æ¦‚è¿°](#1-å¾®æœåŠ¡è®¤è¯æ¶æ„æ¦‚è¿°)
2. [å‚è€ƒæ‹“æ‰‘ä¸æ•°æ®æµ](#2-å‚è€ƒæ‹“æ‰‘ä¸æ•°æ®æµ)
3. [æŠ€æœ¯é€‰å‹çŸ©é˜µ](#3-æŠ€æœ¯é€‰å‹çŸ©é˜µ)
4. [æ€§èƒ½ä¸ç¼“å­˜ç­–ç•¥](#4-æ€§èƒ½ä¸ç¼“å­˜ç­–ç•¥)
5. [ç°åº¦ä¸å›æ»šç­–ç•¥](#5-ç°åº¦ä¸å›æ»šç­–ç•¥)
6. [ä»å•ä½“è¿ç§»å®è·µ](#6-ä»å•ä½“è¿ç§»å®è·µ)
7. [ä¸Šçº¿æ£€æŸ¥æ¸…å•](#7-ä¸Šçº¿æ£€æŸ¥æ¸…å•)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ—ï¸ å¾®æœåŠ¡è®¤è¯æ¶æ„æ¦‚è¿°


### 1.1 ä¸ºä»€ä¹ˆéœ€è¦å¾®æœåŠ¡è®¤è¯æ¶æ„ï¼Ÿ


> **é€šä¿—ç†è§£**ï¼šæƒ³è±¡ä¸€ä¸ªè´­ç‰©ä¸­å¿ƒï¼ŒåŸæ¥åªæœ‰ä¸€ä¸ªå¤§é—¨å’Œä¸€ä¸ªæ”¶é“¶å°ï¼Œç°åœ¨æ‹†åˆ†æˆå¾ˆå¤šä¸ªä¸“å–åº—ï¼Œæ¯ä¸ªåº—éƒ½éœ€è¦ç‹¬ç«‹çš„èº«ä»½éªŒè¯å’Œæƒé™ç®¡ç†ã€‚

**ğŸ” å•ä½“åº”ç”¨ vs å¾®æœåŠ¡è®¤è¯çš„æ ¹æœ¬åŒºåˆ«**

```
å•ä½“åº”ç”¨è®¤è¯ï¼ˆç®€å•ä½†å—é™ï¼‰ï¼š
ç”¨æˆ·ç™»å½• â†’ Sessionä¿å­˜åœ¨æœåŠ¡å™¨ â†’ æ‰€æœ‰åŠŸèƒ½å…±äº«Session
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å•ä½“åº”ç”¨               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ç”¨æˆ·ç®¡ç† â”‚ â”‚è®¢å•ç®¡ç† â”‚ â”‚å•†å“ç®¡ç† â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚        å…±äº«Sessionå­˜å‚¨              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
é—®é¢˜ï¼šæ‰©å±•å›°éš¾ï¼Œå•ç‚¹æ•…éšœ

å¾®æœåŠ¡è®¤è¯ï¼ˆå¤æ‚ä½†çµæ´»ï¼‰ï¼š
ç”¨æˆ·ç™»å½• â†’ è·å–Token â†’ æ¯ä¸ªæœåŠ¡ç‹¬ç«‹éªŒè¯Token
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ç”¨æˆ·æœåŠ¡ â”‚   â”‚è®¢å•æœåŠ¡ â”‚   â”‚å•†å“æœåŠ¡ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†‘             â†‘             â†‘
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ è®¤è¯ä¸­å¿ƒ    â”‚
           â”‚(ç»Ÿä¸€é¢å‘Token)â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ä¼˜åŠ¿ï¼šç‹¬ç«‹æ‰©å±•ï¼Œé«˜å¯ç”¨
```

### 1.2 å¾®æœåŠ¡è®¤è¯çš„æ ¸å¿ƒæŒ‘æˆ˜


**ğŸ¯ éœ€è¦è§£å†³çš„å…³é”®é—®é¢˜**

| **æŒ‘æˆ˜** | **å…·ä½“é—®é¢˜** | **è§£å†³æ€è·¯** |
|---------|-------------|-------------|
| **åˆ†å¸ƒå¼Session** | `ç”¨æˆ·çŠ¶æ€å¦‚ä½•åœ¨å¤šä¸ªæœåŠ¡é—´å…±äº«ï¼Ÿ` | `ä½¿ç”¨JWTç­‰æ— çŠ¶æ€Token` |
| **æœåŠ¡é—´è°ƒç”¨** | `æœåŠ¡Aè°ƒç”¨æœåŠ¡Bæ—¶å¦‚ä½•ä¼ é€’èº«ä»½ï¼Ÿ` | `Tokenä¼ é€’å’ŒæœåŠ¡é—´è®¤è¯` |
| **æƒé™æ§åˆ¶** | `ä¸åŒæœåŠ¡çš„æƒé™å¦‚ä½•ç»Ÿä¸€ç®¡ç†ï¼Ÿ` | `åŸºäºè§’è‰²å’Œç­–ç•¥çš„ç»Ÿä¸€æˆæƒ` |
| **æ€§èƒ½é—®é¢˜** | `æ¯æ¬¡éƒ½éªŒè¯Tokenä¼šå¾ˆæ…¢å—ï¼Ÿ` | `ç¼“å­˜ç­–ç•¥å’Œæ‰¹é‡éªŒè¯` |
| **å®‰å…¨æ€§** | `Tokenæ³„éœ²ã€æœåŠ¡å†’å……æ€ä¹ˆåŠï¼Ÿ` | `åŠ å¯†ä¼ è¾“å’ŒæœåŠ¡èº«ä»½éªŒè¯` |

---

## 2. ğŸŒ å‚è€ƒæ‹“æ‰‘ä¸æ•°æ®æµ


### 2.1 å®Œæ•´æ¶æ„æ‹“æ‰‘å›¾


```
å¾®æœåŠ¡è®¤è¯æ¶æ„å…¨æ™¯å›¾ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Webå®¢æˆ·ç«¯  â”‚    â”‚  ç§»åŠ¨å®¢æˆ·ç«¯  â”‚    â”‚  ç¬¬ä¸‰æ–¹åº”ç”¨  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                   â”‚                   â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ â‘  ç”¨æˆ·è¯·æ±‚
                            â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚   APIç½‘å…³    â”‚ â† ç»Ÿä¸€å…¥å£
                   â”‚  (Kong/Zuul) â”‚
                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚ â‘¡ è·¯ç”±è½¬å‘
                          â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚   èº«ä»½æä¾›å•†      â”‚ â† è®¤è¯ä¸­å¿ƒ
                â”‚ (IdP/Keycloak)   â”‚
                â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ â‘¢ TokenéªŒè¯
                       â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   ç­–ç•¥å¼•æ“        â”‚ â† æƒé™æ§åˆ¶
              â”‚ (OPA/è‡ªç ”)       â”‚
              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ â‘£ æƒé™å†³ç­–
                     â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚              å¾®æœåŠ¡é›†ç¾¤                      â”‚
    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
    â”‚ â”‚ç”¨æˆ·æœåŠ¡ â”‚ â”‚è®¢å•æœåŠ¡ â”‚ â”‚å•†å“æœåŠ¡ â”‚ â† â‘¤ ä¸šåŠ¡å¤„ç†â”‚
    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ â‘¥ æ•°æ®è®¿é—®
                      â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚         æ•°æ®å±‚              â”‚
         â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
         â”‚ â”‚MySQL    â”‚ â”‚Redis    â”‚     â”‚
         â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 è¯¦ç»†æ•°æ®æµè¯´æ˜


**ğŸ”„ å®Œæ•´è¯·æ±‚æµç¨‹è§£æ**

```
ç”¨æˆ·ç™»å½•è´­ä¹°å•†å“çš„å®Œæ•´æµç¨‹ï¼š

ç¬¬1æ­¥ï¼šç”¨æˆ·è®¤è¯
å®¢æˆ·ç«¯ â†’ APIç½‘å…³ â†’ IdPè®¤è¯ä¸­å¿ƒ
æ•°æ®ï¼šPOST /auth/login {username, password}
è¿”å›ï¼šJWT Token + ç”¨æˆ·ä¿¡æ¯

ç¬¬2æ­¥ï¼šè®¿é—®å•†å“åˆ—è¡¨
å®¢æˆ·ç«¯ â†’ APIç½‘å…³ â†’ ç­–ç•¥å¼•æ“ â†’ å•†å“æœåŠ¡
æ•°æ®ï¼šGET /products (Header: Authorization: Bearer jwt_token)
éªŒè¯ï¼šTokenæœ‰æ•ˆæ€§ + è®¿é—®æƒé™
è¿”å›ï¼šå•†å“åˆ—è¡¨æ•°æ®

ç¬¬3æ­¥ï¼šåˆ›å»ºè®¢å•
å®¢æˆ·ç«¯ â†’ APIç½‘å…³ â†’ ç­–ç•¥å¼•æ“ â†’ è®¢å•æœåŠ¡ â†’ ç”¨æˆ·æœåŠ¡(è·å–ç”¨æˆ·ä¿¡æ¯) â†’ å•†å“æœåŠ¡(éªŒè¯å•†å“)
æ•°æ®ï¼šPOST /orders {productId, quantity}
éªŒè¯ï¼šTokenæœ‰æ•ˆæ€§ + åˆ›å»ºè®¢å•æƒé™ + å•†å“åº“å­˜
è¿”å›ï¼šè®¢å•åˆ›å»ºç»“æœ

ç¬¬4æ­¥ï¼šæœåŠ¡é—´è°ƒç”¨
è®¢å•æœåŠ¡å†…éƒ¨ï¼š
- è°ƒç”¨ç”¨æˆ·æœåŠ¡ï¼šä¼ é€’åŸå§‹Tokenï¼ŒéªŒè¯ç”¨æˆ·èº«ä»½
- è°ƒç”¨å•†å“æœåŠ¡ï¼šä¼ é€’æœåŠ¡Tokenï¼ŒéªŒè¯å•†å“ä¿¡æ¯å’Œåº“å­˜
- è°ƒç”¨æ”¯ä»˜æœåŠ¡ï¼šä¼ é€’æœåŠ¡Tokenï¼Œåˆ›å»ºæ”¯ä»˜è®°å½•
```

### 2.3 å…³é”®ç»„ä»¶èŒè´£åˆ’åˆ†


**ğŸ“‹ å„ç»„ä»¶æ ¸å¿ƒèŒè´£**

```
APIç½‘å…³èŒè´£ï¼š
âœ… ç»Ÿä¸€å…¥å£å’Œè·¯ç”±åˆ†å‘
âœ… è´Ÿè½½å‡è¡¡å’Œç†”æ–­é™çº§  
âœ… è¯·æ±‚æ—¥å¿—å’Œç›‘æ§ç»Ÿè®¡
âœ… CORSå’Œå®‰å…¨ç­–ç•¥
âœ… é™æµå’Œé˜²åˆ·æ§åˆ¶

èº«ä»½æä¾›å•†(IdP)èŒè´£ï¼š
âœ… ç”¨æˆ·è®¤è¯å’ŒTokené¢å‘
âœ… TokenéªŒè¯å’Œåˆ·æ–°
âœ… ç”¨æˆ·ä¿¡æ¯ç®¡ç†
âœ… å•ç‚¹ç™»å½•(SSO)æ”¯æŒ
âœ… å¤šç§Ÿæˆ·å’Œæƒé™ç®¡ç†

ç­–ç•¥å¼•æ“èŒè´£ï¼š
âœ… ç»Ÿä¸€æƒé™å†³ç­–
âœ… åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶(RBAC)
âœ… åŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶(ABAC)  
âœ… åŠ¨æ€æƒé™ç­–ç•¥æ›´æ–°
âœ… å®¡è®¡æ—¥å¿—è®°å½•

å¾®æœåŠ¡èŒè´£ï¼š
âœ… ä¸šåŠ¡é€»è¾‘å¤„ç†
âœ… TokenéªŒè¯(JWTç­¾åæ ¡éªŒ)
âœ… æœ¬åœ°ç¼“å­˜ç®¡ç†
âœ… æœåŠ¡é—´å®‰å…¨è°ƒç”¨
âœ… ä¸šåŠ¡æ•°æ®è®¿é—®
```

---

## 3. ğŸ› ï¸ æŠ€æœ¯é€‰å‹çŸ©é˜µ


### 3.1 èº«ä»½æä¾›å•†(IdP)é€‰å‹å¯¹æ¯”


**ğŸ” IdPæŠ€æœ¯æ–¹æ¡ˆå¯¹æ¯”**

| **æ–¹æ¡ˆ** | **Keycloak** | **è‡ªç ”IdP** | **äº‘æ‰˜ç®¡IdP** |
|---------|-------------|-------------|-------------|
| **å¼€å‘æˆæœ¬** | `ä½ï¼Œå¼€ç®±å³ç”¨` | `é«˜ï¼Œéœ€è¦å®Œæ•´å¼€å‘` | `ä¸­ï¼Œé…ç½®å’Œé›†æˆ` |
| **åŠŸèƒ½å®Œæ•´æ€§** | `â­â­â­â­â­ åŠŸèƒ½éå¸¸ä¸°å¯Œ` | `â­â­â­ æŒ‰éœ€å®šåˆ¶` | `â­â­â­â­ åŠŸèƒ½è¾ƒå…¨` |
| **å®šåˆ¶çµæ´»æ€§** | `â­â­â­ æ’ä»¶æ‰©å±•` | `â­â­â­â­â­ å®Œå…¨å¯æ§` | `â­â­ é…ç½®å—é™` |
| **è¿ç»´æˆæœ¬** | `ä¸­ï¼Œéœ€è¦è‡ªå·±éƒ¨ç½²` | `é«˜ï¼Œå®Œå…¨è‡ªç»´æŠ¤` | `ä½ï¼Œäº‘å‚å•†è´Ÿè´£` |
| **æ€§èƒ½è¡¨ç°** | `â­â­â­â­ æ€§èƒ½è‰¯å¥½` | `â­â­â­â­â­ å¯ä¼˜åŒ–` | `â­â­â­â­ å–å†³äºäº‘å‚å•†` |
| **å®‰å…¨æ€§** | `â­â­â­â­â­ ä¹…ç»è€ƒéªŒ` | `â­â­â­ çœ‹å¼€å‘è´¨é‡` | `â­â­â­â­â­ äº‘å‚å•†ä¿éšœ` |

**ğŸ’¡ é€‰æ‹©å»ºè®®**

```
Keycloaké€‚ç”¨åœºæ™¯ï¼š
âœ… ä¸­å°ä¼ä¸šå¿«é€Ÿä¸Šçº¿
âœ… æ ‡å‡†OAuth2/OIDCéœ€æ±‚
âœ… éœ€è¦ç®¡ç†ç•Œé¢
âœ… å¼€å‘èµ„æºæœ‰é™

è‡ªç ”IdPé€‚ç”¨åœºæ™¯ï¼š  
âœ… å¤§å‹ä¼ä¸šï¼Œç‰¹æ®Šä¸šåŠ¡éœ€æ±‚
âœ… å¯¹æ€§èƒ½è¦æ±‚æé«˜
âœ… éœ€è¦æ·±åº¦å®šåˆ¶
âœ… æœ‰å¼ºå¤§çš„å¼€å‘å›¢é˜Ÿ

äº‘æ‰˜ç®¡IdPé€‚ç”¨åœºæ™¯ï¼š
âœ… åˆ›ä¸šå…¬å¸ï¼Œå¿«é€ŸéªŒè¯
âœ… ä¸æƒ³æŠ•å…¥è¿ç»´èµ„æº  
âœ… éœ€è¦å…¨çƒåŒ–éƒ¨ç½²
âœ… é¢„ç®—å……è¶³
```

### 3.2 APIç½‘å…³é€‰å‹å¯¹æ¯”


| **ç½‘å…³** | **Kong** | **Zuul** | **Spring Cloud Gateway** | **Nginx+** |
|---------|----------|----------|-------------------------|-----------|
| **è¯­è¨€** | `Lua/Go` | `Java` | `Java` | `C/Lua` |
| **æ€§èƒ½** | `â­â­â­â­â­` | `â­â­â­` | `â­â­â­â­` | `â­â­â­â­â­` |
| **åŠŸèƒ½ä¸°å¯Œåº¦** | `â­â­â­â­â­` | `â­â­â­` | `â­â­â­â­` | `â­â­â­` |
| **æ’ä»¶ç”Ÿæ€** | `â­â­â­â­â­` | `â­â­â­` | `â­â­â­â­` | `â­â­â­` |
| **å­¦ä¹ æˆæœ¬** | `ä¸­ç­‰` | `è¾ƒé«˜` | `è¾ƒé«˜` | `è¾ƒä½` |

### 3.3 ç­–ç•¥å¼•æ“é€‰å‹


**ğŸ¯ ç­–ç•¥å¼•æ“å¯¹æ¯”**

```
OPA (Open Policy Agent)ï¼š
ä¼˜ç‚¹ï¼š
âœ… å£°æ˜å¼ç­–ç•¥è¯­è¨€(Rego)
âœ… äº‘åŸç”Ÿï¼Œå®¹å™¨åŒ–å‹å¥½
âœ… æ€§èƒ½ä¼˜ç§€ï¼Œå†…å­˜å ç”¨å°
âœ… ç¤¾åŒºæ´»è·ƒï¼Œç”Ÿæ€ä¸°å¯Œ

ç¼ºç‚¹ï¼š
âŒ å­¦ä¹ æ›²çº¿è¾ƒé™¡å³­
âŒ Regoè¯­æ³•éœ€è¦é€‚åº”
âŒ è°ƒè¯•ç›¸å¯¹å›°éš¾

è‡ªç ”ç­–ç•¥å¼•æ“ï¼š
ä¼˜ç‚¹ï¼š
âœ… å®Œå…¨å¯æ§ï¼Œæ·±åº¦å®šåˆ¶
âœ… ä¸ä¸šåŠ¡ç´§å¯†ç»“åˆ
âœ… æ€§èƒ½å¯é’ˆå¯¹æ€§ä¼˜åŒ–

ç¼ºç‚¹ï¼š
âŒ å¼€å‘æˆæœ¬é«˜
âŒ ç»´æŠ¤å·¥ä½œé‡å¤§
âŒ å®¹é”™æ€§éœ€è¦è‡ªå·±ä¿éšœ
```

---

## 4. âš¡ æ€§èƒ½ä¸ç¼“å­˜ç­–ç•¥


### 4.1 ä¸ºä»€ä¹ˆè¦å…³æ³¨æ€§èƒ½ï¼Ÿ


> **ç°å®é—®é¢˜**ï¼šç”¨æˆ·æ¯æ¬¡ç‚¹å‡»éƒ½è¦éªŒè¯Tokenï¼Œå¦‚æœæ¯æ¬¡éƒ½è¦è°ƒç”¨è®¤è¯ä¸­å¿ƒï¼Œç³»ç»Ÿä¼šå¾ˆæ…¢ï¼
> 
> **è§£å†³æ€è·¯**ï¼šæŠŠå¸¸ç”¨çš„éªŒè¯ä¿¡æ¯ç¼“å­˜èµ·æ¥ï¼Œå°±åƒæŠŠèº«ä»½è¯å¤å°ä»¶æ”¾åœ¨é’±åŒ…é‡Œï¼Œä¸ç”¨æ¯æ¬¡éƒ½è·‘æ´¾å‡ºæ‰€ã€‚

### 4.2 å…¬é’¥ç¼“å­˜ç­–ç•¥


**ğŸ”‘ JWTéªŒè¯çš„æ€§èƒ½ç“¶é¢ˆ**

```
æ²¡æœ‰ç¼“å­˜çš„JWTéªŒè¯æµç¨‹ï¼ˆæ…¢ï¼‰ï¼š
ç”¨æˆ·è¯·æ±‚ â†’ å¾®æœåŠ¡ â†’ è°ƒç”¨IdPè·å–å…¬é’¥ â†’ éªŒè¯JWT â†’ è¿”å›ç»“æœ
æ¯æ¬¡éƒ½è¦ç½‘ç»œè°ƒç”¨ï¼Œå»¶è¿Ÿé«˜ï¼

æœ‰ç¼“å­˜çš„JWTéªŒè¯æµç¨‹ï¼ˆå¿«ï¼‰ï¼š
ç”¨æˆ·è¯·æ±‚ â†’ å¾®æœåŠ¡ â†’ ä»ç¼“å­˜è·å–å…¬é’¥ â†’ éªŒè¯JWT â†’ è¿”å›ç»“æœ
å¤§éƒ¨åˆ†è¯·æ±‚éƒ½æ˜¯å†…å­˜æ“ä½œï¼Œå»¶è¿Ÿä½ï¼
```

**ğŸ’¡ å…¬é’¥ç¼“å­˜å®ç°**

```java
@Component
public class JwtPublicKeyCache {
    
    private final RedisTemplate<String, String> redisTemplate;
    private final LoadingCache<String, RSAPublicKey> localCache;
    
    public JwtPublicKeyCache() {
        // æœ¬åœ°ç¼“å­˜ï¼š1åˆ†é’Ÿè¿‡æœŸï¼Œæœ€å¤š1000ä¸ªkey
        this.localCache = Caffeine.newBuilder()
                .expireAfterWrite(1, TimeUnit.MINUTES)
                .maximumSize(1000)
                .build(this::loadPublicKeyFromIdP);
    }
    
    /**
     * è·å–å…¬é’¥ï¼šæœ¬åœ°ç¼“å­˜ â†’ Redisç¼“å­˜ â†’ IdPæœåŠ¡å™¨
     */
    public RSAPublicKey getPublicKey(String keyId) {
        try {
            return localCache.get(keyId);
        } catch (Exception e) {
            log.error("è·å–å…¬é’¥å¤±è´¥: keyId={}", keyId, e);
            throw new RuntimeException("å…¬é’¥è·å–å¤±è´¥");
        }
    }
    
    private RSAPublicKey loadPublicKeyFromIdP(String keyId) {
        // å…ˆä»RedisæŸ¥
        String cachedKey = redisTemplate.opsForValue()
            .get("jwt:public_key:" + keyId);
        
        if (cachedKey != null) {
            return parsePublicKey(cachedKey);
        }
        
        // Redisæ²¡æœ‰ï¼Œä»IdPè·å–
        String publicKeyPem = idpClient.getPublicKey(keyId);
        
        // å­˜å…¥Redisï¼Œ5åˆ†é’Ÿè¿‡æœŸ
        redisTemplate.opsForValue().set(
            "jwt:public_key:" + keyId, 
            publicKeyPem, 
            5, TimeUnit.MINUTES
        );
        
        return parsePublicKey(publicKeyPem);
    }
}
```

### 4.3 ä»¤ç‰Œè§£æç¼“å­˜


**ğŸ¯ JWTè§£æä¼˜åŒ–**

```java
@Service
public class TokenValidationService {
    
    private final LoadingCache<String, JwtClaims> tokenCache;
    
    public TokenValidationService() {
        // è§£æåçš„JWTç¼“å­˜30ç§’ï¼ˆå¹³è¡¡å®‰å…¨æ€§å’Œæ€§èƒ½ï¼‰
        this.tokenCache = Caffeine.newBuilder()
                .expireAfterWrite(30, TimeUnit.SECONDS)
                .maximumSize(10000)
                .build(this::parseAndValidateToken);
    }
    
    public JwtClaims validateToken(String token) {
        try {
            return tokenCache.get(token);
        } catch (Exception e) {
            throw new SecurityException("TokenéªŒè¯å¤±è´¥", e);
        }
    }
    
    private JwtClaims parseAndValidateToken(String token) {
        // å®é™…çš„JWTè§£æå’ŒéªŒè¯é€»è¾‘
        JwtConsumer consumer = new JwtConsumerBuilder()
                .setVerificationKey(getPublicKey())
                .setExpectedIssuer("your-idp")
                .build();
                
        return consumer.processToClaims(token);
    }
}
```

### 4.4 çƒ­è·¯å¾„ä¼˜åŒ–


**ğŸš€ å…³é”®è·¯å¾„æ€§èƒ½ä¼˜åŒ–**

```
çƒ­è·¯å¾„è¯†åˆ«ï¼š
1. ç”¨æˆ·ç™»å½•æ¥å£ - é¢‘æ¬¡é«˜ï¼Œå½±å“ç”¨æˆ·ä½“éªŒ
2. TokenéªŒè¯é€»è¾‘ - æ¯ä¸ªè¯·æ±‚éƒ½è¦æ‰§è¡Œ
3. æƒé™æ£€æŸ¥é€»è¾‘ - å®‰å…¨å…³é”®è·¯å¾„
4. æœåŠ¡é—´è°ƒç”¨è®¤è¯ - å½±å“æ•´ä½“æ€§èƒ½

ä¼˜åŒ–ç­–ç•¥ï¼š
âœ… å¼‚æ­¥å¤„ç†éå…³é”®é€»è¾‘
âœ… æ‰¹é‡æ“ä½œå‡å°‘ç½‘ç»œè°ƒç”¨
âœ… é¢„çƒ­ç¼“å­˜å‡å°‘å†·å¯åŠ¨
âœ… è¿æ¥æ± å¤ç”¨å‡å°‘è¿æ¥å¼€é”€
```

**ğŸ’¡ æ‰¹é‡TokenéªŒè¯**

```java
@Service
public class BatchTokenValidator {
    
    /**
     * æ‰¹é‡éªŒè¯Tokenï¼Œå‡å°‘ç½‘ç»œè°ƒç”¨
     */
    public Map<String, Boolean> batchValidate(List<String> tokens) {
        Map<String, Boolean> results = new HashMap<>();
        List<String> needValidation = new ArrayList<>();
        
        // å…ˆä»ç¼“å­˜è·å–
        for (String token : tokens) {
            Boolean cached = getCachedResult(token);
            if (cached != null) {
                results.put(token, cached);
            } else {
                needValidation.add(token);
            }
        }
        
        // æ‰¹é‡éªŒè¯å‰©ä½™çš„Token
        if (!needValidation.isEmpty()) {
            Map<String, Boolean> batchResults = 
                validateTokensBatch(needValidation);
            
            // æ›´æ–°ç¼“å­˜
            for (Map.Entry<String, Boolean> entry : batchResults.entrySet()) {
                cacheResult(entry.getKey(), entry.getValue());
                results.put(entry.getKey(), entry.getValue());
            }
        }
        
        return results;
    }
}
```

---

## 5. ğŸ”„ ç°åº¦ä¸å›æ»šç­–ç•¥


### 5.1 ä¸ºä»€ä¹ˆéœ€è¦ç°åº¦å‘å¸ƒï¼Ÿ


> **é£é™©æ§åˆ¶**ï¼šè®¤è¯ç³»ç»Ÿæ˜¯æ ¸å¿ƒç³»ç»Ÿï¼Œä¸€æ—¦å‡ºé”™å½±å“æ‰€æœ‰ç”¨æˆ·ï¼
> 
> **é€šä¿—ç†è§£**ï¼šå°±åƒè¯•åƒï¼Œå…ˆç»™ä¸€å°éƒ¨åˆ†å®¢äººè¯•è¯•æ–°èœå“ï¼Œæ²¡é—®é¢˜å†å…¨é¢æ¨å¹¿ã€‚

### 5.2 åŒå‘ä»¤ç‰Œç­–ç•¥


**ğŸ”„ æ–°è€Tokenå¹¶è¡Œå‘æ”¾**

```
åŒTokenç­–ç•¥æµç¨‹ï¼š

ç¬¬1é˜¶æ®µï¼šåŒå‘Token
ç™»å½•æˆåŠŸ â†’ åŒæ—¶é¢å‘æ–°Tokenå’Œè€Token
{
  "access_token_v1": "old_format_jwt...",  // è€ç‰ˆæœ¬
  "access_token_v2": "new_format_jwt...",  // æ–°ç‰ˆæœ¬  
  "token_version": "both"
}

ç¬¬2é˜¶æ®µï¼šåŒéªŒè¯
æ¯ä¸ªå¾®æœåŠ¡ â†’ åŒæ—¶æ”¯æŒæ–°è€Tokenæ ¼å¼éªŒè¯
if (isNewToken(token)) {
    return validateV2Token(token);
} else {
    return validateV1Token(token);
}

ç¬¬3é˜¶æ®µï¼šé€æ­¥åˆ‡æ¢
æŒ‰æœåŠ¡é€ä¸ªåˆ‡æ¢åˆ°åªæ¥å—æ–°Token
ç›‘æ§é”™è¯¯ç‡ï¼Œæœ‰é—®é¢˜ç«‹å³å›æ»š

ç¬¬4é˜¶æ®µï¼šå®Œå…¨åˆ‡æ¢
æ‰€æœ‰æœåŠ¡åªæ¥å—æ–°Token
åœæ­¢é¢å‘è€Token
```

### 5.3 æŒ‰ç§Ÿæˆ·ç°åº¦å‘å¸ƒ


**ğŸ¢ å¤šç§Ÿæˆ·ç¯å¢ƒçš„å®‰å…¨ç°åº¦**

```java
@Service
public class TenantBasedGrayScaleService {
    
    private final GrayScaleConfig grayScaleConfig;
    
    /**
     * æ ¹æ®ç§Ÿæˆ·å†³å®šä½¿ç”¨å“ªç§è®¤è¯æ–¹å¼
     */
    public AuthMethod selectAuthMethod(String tenantId) {
        Set<String> grayTenants = grayScaleConfig.getGrayTenants();
        
        if (grayTenants.contains(tenantId)) {
            // ç°åº¦ç§Ÿæˆ·ä½¿ç”¨æ–°è®¤è¯
            return AuthMethod.NEW_JWT;
        } else {
            // å…¶ä»–ç§Ÿæˆ·ä½¿ç”¨è€è®¤è¯
            return AuthMethod.OLD_SESSION;
        }
    }
    
    /**
     * ç°åº¦é…ç½®çƒ­æ›´æ–°
     */
    @EventListener
    public void handleGrayScaleUpdate(GrayScaleUpdateEvent event) {
        grayScaleConfig.updateConfig(event.getNewConfig());
        log.info("ç°åº¦é…ç½®å·²æ›´æ–°: {}", event.getNewConfig());
    }
}

// é…ç½®ç¤ºä¾‹
@ConfigurationProperties("grayscale")
@Data
public class GrayScaleConfig {
    private Set<String> grayTenants = new HashSet<>();
    private double grayPercentage = 0.1; // 10%ç”¨æˆ·
    private boolean enableGrayScale = false;
}
```

### 5.4 å¿«é€Ÿå›æ»šæœºåˆ¶


**âš¡ ç´§æ€¥å›æ»šé¢„æ¡ˆ**

```yaml
# å›æ»šé…ç½®å¼€å…³
rollback:
  enabled: false
  triggers:
    error-rate: 0.05      # é”™è¯¯ç‡è¶…è¿‡5%è§¦å‘
    latency-p99: 1000     # P99å»¶è¿Ÿè¶…è¿‡1000ms
    success-rate: 0.95    # æˆåŠŸç‡ä½äº95%
  
  actions:
    - disable-new-auth    # ç¦ç”¨æ–°è®¤è¯
    - fallback-to-old    # å›é€€åˆ°è€è®¤è¯  
    - send-alert         # å‘é€å‘Šè­¦
    - create-incident    # åˆ›å»ºäº‹ä»¶
```

```java
@Component
public class AutoRollbackMonitor {
    
    @Scheduled(fixedDelay = 30000) // 30ç§’æ£€æŸ¥ä¸€æ¬¡
    public void checkMetricsAndRollback() {
        MetricsData metrics = metricsCollector.collect();
        
        if (shouldRollback(metrics)) {
            log.warn("æ£€æµ‹åˆ°å¼‚å¸¸æŒ‡æ ‡ï¼Œå¼€å§‹è‡ªåŠ¨å›æ»š: {}", metrics);
            
            // æ‰§è¡Œå›æ»š
            rollbackService.executeRollback();
            
            // å‘é€å‘Šè­¦
            alertService.sendAlert("è®¤è¯ç³»ç»Ÿè‡ªåŠ¨å›æ»š", metrics);
            
            // è®°å½•äº‹ä»¶
            incidentService.createIncident("AUTO_ROLLBACK", metrics);
        }
    }
    
    private boolean shouldRollback(MetricsData metrics) {
        return metrics.getErrorRate() > rollbackConfig.getErrorRateThreshold()
            || metrics.getLatencyP99() > rollbackConfig.getLatencyThreshold()
            || metrics.getSuccessRate() < rollbackConfig.getSuccessRateThreshold();
    }
}
```

---

## 6. ğŸ“¦ ä»å•ä½“è¿ç§»å®è·µ


### 6.1 ä¸ºä»€ä¹ˆè¦ä»å•ä½“è¿ç§»åˆ°å¾®æœåŠ¡è®¤è¯ï¼Ÿ


> **å•ä½“åº”ç”¨çš„ç—›ç‚¹**ï¼šå°±åƒä¸€ä¸ªå¤§æˆ¿å­ï¼Œæ‰€æœ‰äººéƒ½ä½åœ¨ä¸€èµ·ï¼Œä¸€ä¸ªäººæ„Ÿå†’å…¨å®¶éƒ½æœ‰é£é™©ï¼
> 
> **å¾®æœåŠ¡çš„ä¼˜åŠ¿**ï¼šå°±åƒç‹¬ç«‹çš„å…¬å¯“ï¼Œæ¯ä¸ªæœåŠ¡éƒ½æœ‰è‡ªå·±çš„ç©ºé—´ï¼Œäº’ä¸å¹²æ‰°ã€‚

**ğŸ“Š è¿ç§»å‰åå¯¹æ¯”**

```
å•ä½“è®¤è¯çš„é—®é¢˜ï¼š
âŒ Sessionå­˜å‚¨åœ¨å•æœºï¼Œæ— æ³•æ°´å¹³æ‰©å±•
âŒ æ‰€æœ‰åŠŸèƒ½è€¦åˆï¼Œä¿®æ”¹ä¸€ä¸ªå½±å“å…¨å±€
âŒ æŠ€æœ¯æ ˆç»Ÿä¸€ï¼Œæ— æ³•é€‰æ‹©æœ€é€‚åˆçš„æŠ€æœ¯
âŒ éƒ¨ç½²æ—¶å¿…é¡»æ•´ä½“é‡å¯
âŒ å•ç‚¹æ•…éšœå½±å“æ‰€æœ‰åŠŸèƒ½

å¾®æœåŠ¡è®¤è¯çš„ä¼˜åŠ¿ï¼š
âœ… æ— çŠ¶æ€Tokenï¼Œå¯ä»¥æ°´å¹³æ‰©å±•
âœ… æœåŠ¡ç‹¬ç«‹ï¼Œä¿®æ”¹å½±å“èŒƒå›´å¯æ§
âœ… æŠ€æœ¯æ ˆå¤šæ ·åŒ–ï¼Œæ¯ä¸ªæœåŠ¡å¯é€‰æœ€ä¼˜æ–¹æ¡ˆ
âœ… ç‹¬ç«‹éƒ¨ç½²ï¼Œä¸å½±å“å…¶ä»–æœåŠ¡
âœ… é«˜å¯ç”¨ï¼Œå•ä¸ªæœåŠ¡æ•…éšœä¸å½±å“æ•´ä½“
```

### 6.2 ä¼šè¯æ‹†åˆ†ç­–ç•¥


**ğŸ”„ Sessionåˆ°Tokençš„å¹³æ»‘è¿‡æ¸¡**

```
ç¬¬1é˜¶æ®µï¼šSession + TokenåŒæ¨¡å¼
ç”¨æˆ·ç™»å½• â†’ åŒæ—¶åˆ›å»ºSessionå’ŒJWT Token
å‰ç«¯ â†’ å¯ä»¥é€‰æ‹©ä½¿ç”¨Sessionæˆ–Token
åç«¯ â†’ åŒæ—¶æ”¯æŒSessionå’ŒTokenéªŒè¯

ç¬¬2é˜¶æ®µï¼šé€æ­¥åˆ‡æ¢åˆ°Token
æ–°åŠŸèƒ½ â†’ åªä½¿ç”¨Tokenè®¤è¯
è€åŠŸèƒ½ â†’ ç»§ç»­æ”¯æŒSessionï¼Œä½†æ¨èToken
ç›‘æ§ â†’ è§‚å¯ŸTokenä½¿ç”¨æƒ…å†µå’Œç¨³å®šæ€§

ç¬¬3é˜¶æ®µï¼šå®Œå…¨åˆ‡æ¢åˆ°Token  
æ‰€æœ‰åŠŸèƒ½ â†’ åªä½¿ç”¨Tokenè®¤è¯
Session â†’ åªä¿ç•™å‘åå…¼å®¹ï¼Œä¸å†æ–°å»º
æ•°æ®æ¸…ç† â†’ å®šæœŸæ¸…ç†è¿‡æœŸSessionæ•°æ®
```

**ğŸ’¡ å®é™…ä»£ç å®ç°**

```java
@Component
public class HybridAuthenticationManager {
    
    private final SessionAuthService sessionAuth;
    private final TokenAuthService tokenAuth;
    private final MigrationConfig config;
    
    /**
     * ç»Ÿä¸€è®¤è¯å…¥å£ï¼šæ”¯æŒSessionå’ŒToken
     */
    public Authentication authenticate(HttpServletRequest request) {
        // ä¼˜å…ˆå°è¯•Tokenè®¤è¯
        String token = extractToken(request);
        if (token != null) {
            try {
                return tokenAuth.authenticate(token);
            } catch (Exception e) {
                log.warn("Tokenè®¤è¯å¤±è´¥ï¼Œå°è¯•Sessionè®¤è¯: {}", e.getMessage());
            }
        }
        
        // å›é€€åˆ°Sessionè®¤è¯
        if (config.isSessionEnabled()) {
            return sessionAuth.authenticate(request);
        }
        
        throw new AuthenticationException("è®¤è¯å¤±è´¥");
    }
    
    /**
     * ç™»å½•æ—¶åŒé‡åˆ›å»º
     */
    public LoginResponse login(LoginRequest request) {
        User user = validateCredentials(request);
        
        LoginResponse response = new LoginResponse();
        response.setUser(user);
        
        // åˆ›å»ºJWT Token
        String token = tokenAuth.createToken(user);
        response.setAccessToken(token);
        
        // å¦‚æœå¯ç”¨äº†Sessionå…¼å®¹æ¨¡å¼ï¼Œä¹Ÿåˆ›å»ºSession
        if (config.isSessionCompatMode()) {
            String sessionId = sessionAuth.createSession(user);
            response.setSessionId(sessionId);
        }
        
        return response;
    }
}
```

### 6.3 ç»Ÿä¸€ç™»å½•è¿ç§»


**ğŸ¯ å•ç‚¹ç™»å½•çš„æ¸è¿›å¼è¿ç§»**

```
è¿ç§»æ­¥éª¤ï¼š

ç¬¬1æ­¥ï¼šè¯†åˆ«ç°æœ‰ç™»å½•ç‚¹
- Webç®¡ç†åå°
- ç§»åŠ¨App  
- ç¬¬ä¸‰æ–¹é›†æˆç³»ç»Ÿ
- å†…éƒ¨å·¥å…·ç³»ç»Ÿ

ç¬¬2æ­¥ï¼šæ­å»ºç»Ÿä¸€è®¤è¯ä¸­å¿ƒ
éƒ¨ç½²IdPæœåŠ¡ â†’ é…ç½®OAuth2/OIDC â†’ è¿ç§»ç”¨æˆ·æ•°æ®

ç¬¬3æ­¥ï¼šé€ä¸ªç³»ç»Ÿæ¥å…¥
ä¼˜å…ˆçº§æ’åºï¼š
1. å½±å“æœ€å°çš„å†…éƒ¨å·¥å…·ï¼ˆè¯•ç‚¹ï¼‰
2. ç”¨æˆ·é‡è¾ƒå°çš„ç³»ç»Ÿï¼ˆéªŒè¯ï¼‰  
3. æ ¸å¿ƒä¸šåŠ¡ç³»ç»Ÿï¼ˆæœ€åï¼‰

ç¬¬4æ­¥ï¼šæ•°æ®åŒæ­¥å’ŒéªŒè¯
æ–°è€ç³»ç»Ÿå¹¶è¡Œ â†’ æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥ â†’ ç”¨æˆ·ä½“éªŒæµ‹è¯•
```

### 6.4 æœ€å°å¯è¡Œåˆ‡æ¢è·¯å¾„


**âš¡ é£é™©æœ€å°çš„è¿ç§»è·¯å¾„**

```java
// æœ€å°å¯è¡Œè¿ç§»ç­–ç•¥
public class MinimalViableMigration {
    
    /**
     * ç¬¬1é˜¶æ®µï¼šåªè¿ç§»æ–°ç”¨æˆ·
     */
    @PostMapping("/register")
    public ResponseEntity<RegisterResponse> register(@RequestBody RegisterRequest request) {
        User user = createUser(request);
        
        // æ–°ç”¨æˆ·ç›´æ¥ä½¿ç”¨å¾®æœåŠ¡è®¤è¯
        String token = jwtService.createToken(user);
        
        return ResponseEntity.ok(RegisterResponse.builder()
                .token(token)
                .authType("JWT")
                .build());
    }
    
    /**
     * ç¬¬2é˜¶æ®µï¼šè€ç”¨æˆ·ç™»å½•æ—¶è¿ç§»
     */
    @PostMapping("/login")  
    public ResponseEntity<LoginResponse> login(@RequestBody LoginRequest request) {
        User user = validateUser(request);
        
        if (user.getAuthType() == AuthType.LEGACY) {
            // è€ç”¨æˆ·é¦–æ¬¡ç™»å½•æ—¶è¿ç§»åˆ°æ–°è®¤è¯
            migrateUserToNewAuth(user);
        }
        
        String token = jwtService.createToken(user);
        
        return ResponseEntity.ok(LoginResponse.builder()
                .token(token)  
                .migrated(user.getAuthType() == AuthType.JWT)
                .build());
    }
    
    /**
     * ç¬¬3é˜¶æ®µï¼šæ‰¹é‡è¿ç§»å‰©ä½™ç”¨æˆ·
     */
    @Scheduled(cron = "0 0 2 * * ?") // æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
    public void batchMigrateUsers() {
        List<User> legacyUsers = userService.findLegacyUsers(1000);
        
        for (User user : legacyUsers) {
            try {
                migrateUserToNewAuth(user);
                log.info("ç”¨æˆ·è¿ç§»æˆåŠŸ: {}", user.getUsername());
            } catch (Exception e) {
                log.error("ç”¨æˆ·è¿ç§»å¤±è´¥: {}", user.getUsername(), e);
            }
        }
    }
}
```

---

## 7. âœ… ä¸Šçº¿æ£€æŸ¥æ¸…å•


### 7.1 å¯†é’¥ç®¡ç†æ£€æŸ¥


**ğŸ” å¯†é’¥å®‰å…¨æ£€æŸ¥æ¸…å•**

```
JWTå¯†é’¥æ£€æŸ¥ï¼š
âœ… ä½¿ç”¨è¶³å¤Ÿå¼ºåº¦çš„å¯†é’¥ï¼ˆè‡³å°‘2048ä½RSAæˆ–256ä½ECDSAï¼‰
âœ… å¯†é’¥å­˜å‚¨åœ¨å®‰å…¨çš„åœ°æ–¹ï¼ˆHSMã€äº‘KMSã€åŠ å¯†å­˜å‚¨ï¼‰
âœ… é…ç½®å¯†é’¥è½®æ¢ç­–ç•¥ï¼ˆå»ºè®®æ¯å¹´è½®æ¢ä¸€æ¬¡ï¼‰
âœ… å¤‡ä»½å¯†é’¥åˆ°å®‰å…¨ä½ç½®
âœ… æµ‹è¯•å¯†é’¥æ¢å¤æµç¨‹

APIå¯†é’¥æ£€æŸ¥ï¼š
âœ… æ¯ä¸ªå¾®æœåŠ¡æœ‰ç‹¬ç«‹çš„APIå¯†é’¥
âœ… å¯†é’¥æœ‰åˆé€‚çš„æƒé™èŒƒå›´
âœ… é…ç½®å¯†é’¥è¿‡æœŸæ—¶é—´
âœ… å®ç°å¯†é’¥è‡ªåŠ¨è½®æ¢
âœ… ç›‘æ§å¼‚å¸¸çš„å¯†é’¥ä½¿ç”¨

æ•°æ®åº“å¯†é’¥æ£€æŸ¥ï¼š
âœ… æ•°æ®åº“è¿æ¥ä½¿ç”¨åŠ å¯†
âœ… æ•æ„Ÿæ•°æ®å­—æ®µåŠ å¯†å­˜å‚¨
âœ… å®šæœŸæ›´æ¢æ•°æ®åº“å¯†ç 
âœ… é™åˆ¶æ•°æ®åº“è®¿é—®IP
âœ… å¼€å¯æ•°æ®åº“å®¡è®¡æ—¥å¿—
```

### 7.2 å›è°ƒå’ŒCORSé…ç½®


**ğŸ”— è·¨åŸŸå’Œå›è°ƒé…ç½®æ£€æŸ¥**

```yaml
# CORSé…ç½®ç¤ºä¾‹
cors:
  allowed-origins:
    - https://app.company.com
    - https://admin.company.com
  allowed-methods:
    - GET
    - POST
    - PUT
    - DELETE
    - OPTIONS
  allowed-headers:
    - Authorization
    - Content-Type
    - X-Request-ID
  allow-credentials: true
  max-age: 3600

# OAuth2å›è°ƒURLé…ç½®
oauth2:
  redirect-uris:
    - https://app.company.com/callback
    - https://admin.company.com/auth/callback
  post-logout-redirect-uris:
    - https://app.company.com/logout-success
```

### 7.3 é€Ÿç‡é™åˆ¶é…ç½®


**ğŸš¦ é˜²åˆ·å’Œé™æµé…ç½®**

```java
@Configuration
public class RateLimitConfig {
    
    /**
     * ç™»å½•æ¥å£é™æµï¼šæ¯åˆ†é’Ÿ5æ¬¡
     */
    @Bean
    public RateLimiter loginRateLimiter() {
        return RateLimiter.create(5.0 / 60.0); // æ¯åˆ†é’Ÿ5æ¬¡
    }
    
    /**
     * Tokenåˆ·æ–°é™æµï¼šæ¯åˆ†é’Ÿ10æ¬¡
     */
    @Bean  
    public RateLimiter refreshTokenRateLimiter() {
        return RateLimiter.create(10.0 / 60.0);
    }
    
    /**
     * åŸºäºç”¨æˆ·çš„é™æµ
     */
    @Component
    public class UserBasedRateLimit {
        private final LoadingCache<String, RateLimiter> userLimiters;
        
        public UserBasedRateLimit() {
            this.userLimiters = Caffeine.newBuilder()
                    .expireAfterAccess(1, TimeUnit.HOURS)
                    .build(key -> RateLimiter.create(100.0 / 60.0)); // æ¯åˆ†é’Ÿ100æ¬¡
        }
        
        public boolean tryAcquire(String userId) {
            return userLimiters.get(userId).tryAcquire();
        }
    }
}
```

### 7.4 å®¡è®¡å’Œå‘Šè­¦é…ç½®


**ğŸ“Š ç›‘æ§å‘Šè­¦æ£€æŸ¥æ¸…å•**

```
å®¡è®¡æ—¥å¿—ï¼š
âœ… è®°å½•æ‰€æœ‰è®¤è¯äº‹ä»¶ï¼ˆç™»å½•ã€ç™»å‡ºã€Tokenåˆ·æ–°ï¼‰
âœ… è®°å½•æˆæƒå†³ç­–ï¼ˆæƒé™æ£€æŸ¥æˆåŠŸ/å¤±è´¥ï¼‰
âœ… è®°å½•æ•æ„Ÿæ“ä½œï¼ˆå¯†ç ä¿®æ”¹ã€æƒé™å˜æ›´ï¼‰
âœ… æ—¥å¿—åŒ…å«å¿…è¦å­—æ®µï¼ˆæ—¶é—´ã€ç”¨æˆ·ã€IPã€æ“ä½œã€ç»“æœï¼‰
âœ… æ—¥å¿—å®‰å…¨ä¼ è¾“å’Œå­˜å‚¨

å‘Šè­¦é…ç½®ï¼š
âœ… å¼‚å¸¸ç™»å½•å‘Šè­¦ï¼ˆå¼‚åœ°ç™»å½•ã€å¤šæ¬¡å¤±è´¥ï¼‰
âœ… æƒé™å¼‚å¸¸å‘Šè­¦ï¼ˆæƒé™æå‡ã€å¼‚å¸¸è®¿é—®ï¼‰
âœ… ç³»ç»Ÿå¼‚å¸¸å‘Šè­¦ï¼ˆæœåŠ¡ä¸å¯ç”¨ã€å“åº”ç¼“æ…¢ï¼‰
âœ… å®‰å…¨äº‹ä»¶å‘Šè­¦ï¼ˆTokenæ³„éœ²ã€æš´åŠ›ç ´è§£ï¼‰

ç›‘æ§æŒ‡æ ‡ï¼š
âœ… è®¤è¯æˆåŠŸç‡
âœ… TokenéªŒè¯å»¶è¿Ÿ
âœ… æœåŠ¡å¯ç”¨æ€§
âœ… é”™è¯¯ç‡å’Œé”™è¯¯åˆ†å¸ƒ
âœ… å¹¶å‘ç”¨æˆ·æ•°
```

### 7.5 å¤‡ä»½å’Œæ¢å¤æ¼”ç»ƒ


**ğŸ’¾ ç¾éš¾æ¢å¤æ£€æŸ¥**

```bash
#!/bin/bash
# å¤‡ä»½è„šæœ¬ç¤ºä¾‹

# å¤‡ä»½ç”¨æˆ·æ•°æ®
mysqldump -u root -p auth_db users > /backup/users_$(date +%Y%m%d).sql

# å¤‡ä»½é…ç½®æ–‡ä»¶  
tar -czf /backup/config_$(date +%Y%m%d).tar.gz /opt/auth/config/

# å¤‡ä»½å¯†é’¥æ–‡ä»¶ï¼ˆåŠ å¯†å­˜å‚¨ï¼‰
gpg --encrypt --recipient admin@company.com /opt/auth/keys/jwt.key > /backup/jwt_key_$(date +%Y%m%d).gpg

# éªŒè¯å¤‡ä»½å®Œæ•´æ€§
if [ $? -eq 0 ]; then
    echo "å¤‡ä»½æˆåŠŸ: $(date)" >> /var/log/backup.log
else
    echo "å¤‡ä»½å¤±è´¥: $(date)" >> /var/log/backup.log
    # å‘é€å‘Šè­¦é‚®ä»¶
    mail -s "è®¤è¯ç³»ç»Ÿå¤‡ä»½å¤±è´¥" admin@company.com < /var/log/backup.log
fi
```

**ğŸ”„ æ¢å¤æ¼”ç»ƒæ¸…å•**

```
æ¢å¤æ¼”ç»ƒæ­¥éª¤ï¼š
âœ… æ¨¡æ‹Ÿä¸»æœåŠ¡å™¨æ•…éšœ
âœ… ä»å¤‡ä»½æ¢å¤æ•°æ®
âœ… éªŒè¯æœåŠ¡åŠŸèƒ½æ­£å¸¸
âœ… æµ‹è¯•ç”¨æˆ·ç™»å½•
âœ… æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§
âœ… è®°å½•æ¢å¤æ—¶é—´
âœ… æ€»ç»“æ”¹è¿›ç‚¹

æ¼”ç»ƒé¢‘ç‡ï¼š
âœ… æ¯å­£åº¦è¿›è¡Œä¸€æ¬¡å®Œæ•´æ¼”ç»ƒ
âœ… æ¯æœˆè¿›è¡Œéƒ¨åˆ†åŠŸèƒ½æµ‹è¯•
âœ… æ–°ç‰ˆæœ¬å‘å¸ƒå‰å¿…é¡»æ¼”ç»ƒ
âœ… é‡å¤§å˜æ›´åéªŒè¯æ¢å¤èƒ½åŠ›
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ¶æ„ç†è§£ï¼šå®¢æˆ·ç«¯â†’ç½‘å…³â†’IdPâ†’ç­–ç•¥å¼•æ“â†’å¾®æœåŠ¡â†’æ•°æ®å±‚çš„å®Œæ•´é“¾è·¯
ğŸ”¸ æŠ€æœ¯é€‰å‹ï¼šæ ¹æ®å›¢é˜Ÿèƒ½åŠ›å’Œä¸šåŠ¡éœ€æ±‚é€‰æ‹©åˆé€‚çš„IdPã€ç½‘å…³ã€ç­–ç•¥å¼•æ“
ğŸ”¸ æ€§èƒ½ä¼˜åŒ–ï¼šé€šè¿‡ç¼“å­˜ç­–ç•¥å’Œçƒ­è·¯å¾„ä¼˜åŒ–æå‡ç³»ç»Ÿæ€§èƒ½
ğŸ”¸ ç°åº¦å‘å¸ƒï¼šåŒTokenã€æŒ‰ç§Ÿæˆ·ç°åº¦ã€å¿«é€Ÿå›æ»šçš„é£é™©æ§åˆ¶ç­–ç•¥
ğŸ”¸ è¿ç§»å®è·µï¼šä»å•ä½“åˆ°å¾®æœåŠ¡çš„æ¸è¿›å¼ã€æœ€å°é£é™©è¿ç§»è·¯å¾„
ğŸ”¸ ä¸Šçº¿ä¿éšœï¼šå¯†é’¥ã€CORSã€é™æµã€ç›‘æ§ã€å¤‡ä»½çš„å…¨æ–¹ä½æ£€æŸ¥
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å¾®æœåŠ¡è®¤è¯çš„æœ¬è´¨å˜åŒ–**
```
å•ä½“ï¼šSessioné›†ä¸­ç®¡ç† â†’ å¾®æœåŠ¡ï¼šTokenåˆ†å¸ƒå¼éªŒè¯
çŠ¶æ€ä¾èµ– â†’ æ— çŠ¶æ€è®¾è®¡
å•ç‚¹æ‰©å±• â†’ æ°´å¹³æ‰©å±•
æŠ€æœ¯ç»Ÿä¸€ â†’ æŠ€æœ¯å¤šæ ·åŒ–
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–çš„æ ¸å¿ƒæ€è·¯**
```
ç¼“å­˜ç­–ç•¥ï¼šæœ¬åœ°ç¼“å­˜ > åˆ†å¸ƒå¼ç¼“å­˜ > è¿œç¨‹è°ƒç”¨
æ‰¹é‡æ“ä½œï¼šå‡å°‘ç½‘ç»œè°ƒç”¨æ¬¡æ•°
é¢„çƒ­æœºåˆ¶ï¼šé¿å…å†·å¯åŠ¨æ€§èƒ½é—®é¢˜
å¼‚æ­¥å¤„ç†ï¼šéå…³é”®è·¯å¾„å¼‚æ­¥åŒ–
```

**ğŸ”¹ é£é™©æ§åˆ¶çš„å…³é”®æªæ–½**
```
ç°åº¦å‘å¸ƒï¼šå°èŒƒå›´éªŒè¯ â†’ é€æ­¥æ”¾é‡ â†’ å…¨é‡ä¸Šçº¿
å¿«é€Ÿå›æ»šï¼šç›‘æ§å‘Šè­¦ â†’ è‡ªåŠ¨å›æ»š â†’ äººå·¥ä»‹å…¥
å¤‡ä»½æ¢å¤ï¼šæ•°æ®å¤‡ä»½ â†’ å®šæœŸæ¼”ç»ƒ â†’ å¿«é€Ÿæ¢å¤
```

### 8.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ’¼ ä¼ä¸šå®æ–½æ”¶ç›Š**
- **æ‰©å±•æ€§æå‡**ï¼šç³»ç»Ÿå¯ä»¥æŒ‰éœ€ç‹¬ç«‹æ‰©å±•å„ä¸ªè®¤è¯ç»„ä»¶
- **å¯ç”¨æ€§å¢å¼º**ï¼šå•ä¸ªæœåŠ¡æ•…éšœä¸å½±å“æ•´ä½“è®¤è¯åŠŸèƒ½
- **å®‰å…¨æ€§æ”¹å–„**ï¼šç»Ÿä¸€çš„å®‰å…¨ç­–ç•¥å’Œç²¾ç»†åŒ–æƒé™æ§åˆ¶
- **å¼€å‘æ•ˆç‡**ï¼šæ–°æœåŠ¡å¯ä»¥å¿«é€Ÿæ¥å…¥ç»Ÿä¸€è®¤è¯ä½“ç³»

**ğŸ”§ æŠ€æœ¯å®æ–½æŒ‡å¯¼**
- **å¾ªåºæ¸è¿›**ï¼šä»ç®€å•åœºæ™¯å¼€å§‹ï¼Œé€æ­¥è¦†ç›–å¤æ‚ä¸šåŠ¡
- **é£é™©å¯æ§**ï¼šæ¯ä¸ªé˜¶æ®µéƒ½è¦æœ‰å›æ»šé¢„æ¡ˆå’Œç›‘æ§æªæ–½
- **å›¢é˜Ÿåä½œ**ï¼šéœ€è¦æ¶æ„ã€å¼€å‘ã€è¿ç»´ã€å®‰å…¨å›¢é˜Ÿç´§å¯†é…åˆ
- **æŒç»­ä¼˜åŒ–**ï¼šæ ¹æ®ä¸šåŠ¡å¢é•¿å’ŒæŠ€æœ¯å‘å±•æŒç»­æ”¹è¿›æ¶æ„

### 8.4 å®æ–½å»ºè®®ä¸æ³¨æ„äº‹é¡¹


**ğŸ¯ æˆåŠŸå®æ–½çš„å…³é”®å› ç´ **
```
æŠ€æœ¯å±‚é¢ï¼š
âœ… é€‰æ‹©æˆç†Ÿç¨³å®šçš„å¼€æºæ–¹æ¡ˆ
âœ… å®Œå–„çš„ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶
âœ… å……åˆ†çš„æµ‹è¯•å’Œå‹åŠ›éªŒè¯
âœ… è¯¦ç»†çš„æ–‡æ¡£å’Œè¿ç»´æ‰‹å†Œ

ç®¡ç†å±‚é¢ï¼š
âœ… é«˜å±‚æ”¯æŒå’Œè¶³å¤Ÿçš„èµ„æºæŠ•å…¥
âœ… è·¨å›¢é˜Ÿåä½œå’Œæ²Ÿé€šæœºåˆ¶
âœ… æ¸…æ™°çš„é¡¹ç›®è®¡åˆ’å’Œé‡Œç¨‹ç¢‘
âœ… é£é™©è¯„ä¼°å’Œåº”å¯¹é¢„æ¡ˆ

è¿è¥å±‚é¢ï¼š
âœ… ç”¨æˆ·åŸ¹è®­å’Œæ”¯æŒ
âœ… å¹³æ»‘çš„è¿ç§»ä½“éªŒ
âœ… åŠæ—¶çš„é—®é¢˜å“åº”
âœ… æŒç»­çš„æ€§èƒ½ä¼˜åŒ–
```

**âš ï¸ å¸¸è§é™·é˜±å’Œé¿å…æ–¹æ³•**
```
è¿‡åº¦è®¾è®¡ï¼š
é—®é¢˜ï¼šä¸€å¼€å§‹å°±è¿½æ±‚å®Œç¾æ¶æ„
è§£å†³ï¼šMVPæ€è·¯ï¼Œé€æ­¥æ¼”è¿›

å¿½è§†æ€§èƒ½ï¼š
é—®é¢˜ï¼šåªå…³æ³¨åŠŸèƒ½ï¼Œä¸å…³æ³¨æ€§èƒ½
è§£å†³ï¼šæ—©æœŸå°±è¦è€ƒè™‘ç¼“å­˜å’Œä¼˜åŒ–

ç¼ºä¹ç›‘æ§ï¼š
é—®é¢˜ï¼šä¸Šçº¿åæ‰å‘ç°é—®é¢˜
è§£å†³ï¼šç›‘æ§å’Œæ—¥å¿—è¦åŒæ­¥å¼€å‘

ç”¨æˆ·ä½“éªŒï¼š
é—®é¢˜ï¼šæŠ€æœ¯é©±åŠ¨ï¼Œå¿½è§†ç”¨æˆ·æ„Ÿå—
è§£å†³ï¼šç«™åœ¨ç”¨æˆ·è§’åº¦è®¾è®¡æµç¨‹
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
å¾®æœåŠ¡è®¤è¯æ¶æ„è®¾è®¡ï¼Œç½‘å…³IdPç­–ç•¥å¼•æ“é…
æ€§èƒ½ç¼“å­˜çƒ­è·¯å¾„ä¼˜åŒ–ï¼Œç°åº¦å›æ»šé£é™©å¯æ§
å•ä½“è¿ç§»å¾ªåºæ¸è¿›ï¼Œæœ€å°å¯è¡Œè·¯å¾„æ¸…æ™°
ä¸Šçº¿æ£€æŸ¥å¯†é’¥CORSï¼Œç›‘æ§å‘Šè­¦å¤‡ä»½åˆ°ä½
æŠ€æœ¯é€‰å‹çœ‹å›¢é˜Ÿèƒ½åŠ›ï¼Œä¸šåŠ¡éœ€æ±‚æ˜¯ç¬¬ä¸€
```