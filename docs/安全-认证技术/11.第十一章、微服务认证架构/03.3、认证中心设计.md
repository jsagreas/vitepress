---
title: 3ã€è®¤è¯ä¸­å¿ƒè®¾è®¡
---
## ğŸ“š ç›®å½•

1. [è®¤è¯ä¸­å¿ƒåŸºæœ¬æ¦‚å¿µ](#1-è®¤è¯ä¸­å¿ƒåŸºæœ¬æ¦‚å¿µ)
2. [è®¤è¯ä¸­å¿ƒè®¾è®¡åŸåˆ™](#2-è®¤è¯ä¸­å¿ƒè®¾è®¡åŸåˆ™)
3. [è®¤è¯æœåŠ¡ä¸­å¿ƒæ¶æ„](#3-è®¤è¯æœåŠ¡ä¸­å¿ƒæ¶æ„)
4. [Tokenç»Ÿä¸€ç®¡ç†æœºåˆ¶](#4-Tokenç»Ÿä¸€ç®¡ç†æœºåˆ¶)
5. [è®¤è¯ä¸­å¿ƒè®¾è®¡æ¨¡å¼](#5-è®¤è¯ä¸­å¿ƒè®¾è®¡æ¨¡å¼)
6. [API Gatewayé›†æˆè®¤è¯](#6-API-Gatewayé›†æˆè®¤è¯)
7. [ç»Ÿä¸€è®¤è¯æœåŠ¡è®¾è®¡](#7-ç»Ÿä¸€è®¤è¯æœåŠ¡è®¾è®¡)
8. [ç”¨æˆ·èº«ä»½æ•°æ®æ¨¡å‹](#8-ç”¨æˆ·èº«ä»½æ•°æ®æ¨¡å‹)
9. [å¤šå®¢æˆ·ç«¯æ”¯æŒç­–ç•¥](#9-å¤šå®¢æˆ·ç«¯æ”¯æŒç­–ç•¥)
10. [è®¤è¯ä¸­å¿ƒé«˜å¯ç”¨éƒ¨ç½²](#10-è®¤è¯ä¸­å¿ƒé«˜å¯ç”¨éƒ¨ç½²)
11. [ç”¨æˆ·å¯†ç å®‰å…¨ç®¡ç†](#11-ç”¨æˆ·å¯†ç å®‰å…¨ç®¡ç†)
12. [å¤šç§Ÿæˆ·è®¤è¯æ”¯æŒ](#12-å¤šç§Ÿæˆ·è®¤è¯æ”¯æŒ)
13. [èº«ä»½æä¾›è€…æ¶æ„](#13-èº«ä»½æä¾›è€…æ¶æ„)
14. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#14-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ›ï¸ è®¤è¯ä¸­å¿ƒåŸºæœ¬æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯è®¤è¯ä¸­å¿ƒ


**è®¤è¯ä¸­å¿ƒï¼ˆAuth Serverï¼‰**å°±åƒæ˜¯ä¸€ä¸ªä¸“é—¨çš„**"èº«ä»½è¯åŠäº‹å¤„"**ï¼Œæ‰€æœ‰ç”¨æˆ·éƒ½éœ€è¦åˆ°è¿™é‡Œæ¥è¯æ˜è‡ªå·±çš„èº«ä»½ï¼Œç„¶åæ‹¿åˆ°ä¸€ä¸ª**"é€šè¡Œè¯"**å»è®¿é—®å„ç§æœåŠ¡ã€‚

> ğŸ’¡ **é€šä¿—ç†è§£**ï¼šå°±åƒä½ å»é“¶è¡ŒåŠäº‹ï¼Œéœ€è¦å…ˆåˆ°å‰å°éªŒè¯èº«ä»½ï¼Œç„¶åæ‹¿åˆ°ä¸€ä¸ªå·ç ç‰Œï¼Œå‡­è¿™ä¸ªå·ç ç‰Œå¯ä»¥å»ä¸åŒçš„çª—å£åŠç†å„ç§ä¸šåŠ¡

### 1.2 è®¤è¯ä¸­å¿ƒè§£å†³ä»€ä¹ˆé—®é¢˜


**ä¼ ç»Ÿé—®é¢˜**ï¼š
```
ç”¨æˆ·ç™»å½•ç”µå•†ç½‘ç«™ â†’ éœ€è¦è´¦å·å¯†ç 
ç”¨æˆ·ç™»å½•è®¢å•ç³»ç»Ÿ â†’ åˆéœ€è¦è´¦å·å¯†ç   
ç”¨æˆ·ç™»å½•æ”¯ä»˜ç³»ç»Ÿ â†’ è¿˜éœ€è¦è´¦å·å¯†ç 
```

**è®¤è¯ä¸­å¿ƒè§£å†³æ–¹æ¡ˆ**ï¼š
```
ç”¨æˆ· â†’ è®¤è¯ä¸­å¿ƒï¼ˆä¸€æ¬¡ç™»å½•ï¼‰â†’ è·å¾—Token
Token â†’ ç”µå•†ç½‘ç«™ âœ“
Token â†’ è®¢å•ç³»ç»Ÿ âœ“  
Token â†’ æ”¯ä»˜ç³»ç»Ÿ âœ“
```

### 1.3 è®¤è¯ä¸­å¿ƒæ ¸å¿ƒä½œç”¨


```
â”Œâ”€ è®¤è¯ä¸­å¿ƒæ ¸å¿ƒåŠŸèƒ½ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ” ç»Ÿä¸€èº«ä»½éªŒè¯ï¼šä¸€å¤„ç™»å½•ï¼Œå¤„å¤„å¯ç”¨ â”‚
â”‚ ğŸ« Tokenç­¾å‘ï¼šé¢å‘æ•°å­—é€šè¡Œè¯      â”‚
â”‚ ğŸ›¡ï¸ æƒé™æ£€æŸ¥ï¼šæ§åˆ¶è®¿é—®èŒƒå›´        â”‚
â”‚ ğŸ“Š ä¼šè¯ç®¡ç†ï¼šè·Ÿè¸ªç”¨æˆ·çŠ¶æ€        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸ“‹ è®¤è¯ä¸­å¿ƒè®¾è®¡åŸåˆ™


### 2.1 æ ¸å¿ƒè®¾è®¡åŸåˆ™


**ğŸ¯ å•ä¸€èŒè´£åŸåˆ™**
```
è®¤è¯ä¸­å¿ƒåªåšä¸€ä»¶äº‹ï¼šéªŒè¯èº«ä»½å’Œé¢å‘Token
ä¸åšï¼šä¸šåŠ¡é€»è¾‘ã€æ•°æ®å¤„ç†ã€ç•Œé¢å±•ç¤º
åªåšï¼šèº«ä»½éªŒè¯ã€Tokenç®¡ç†ã€æƒé™æ§åˆ¶
```

**ğŸ”„ é›†ä¸­è®¤è¯ï¼Œåˆ†å¸ƒå¼éªŒè¯**
```
é›†ä¸­è®¤è¯ï¼šæ‰€æœ‰ç”¨æˆ·éƒ½åœ¨è®¤è¯ä¸­å¿ƒç™»å½•
åˆ†å¸ƒå¼éªŒè¯ï¼šå„ä¸ªæœåŠ¡è‡ªå·±éªŒè¯TokençœŸä¼ª
```

### 2.2 è®¾è®¡æ¶æ„å›¾


```
        ç”¨æˆ·è¯·æ±‚
           â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  è®¤è¯ä¸­å¿ƒ    â”‚ â† é›†ä¸­å¤„ç†ç™»å½•
    â”‚ Auth Server â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚ é¢å‘Token
           â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ API Gateway â”‚ â† ç»Ÿä¸€å…¥å£
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚ è½¬å‘è¯·æ±‚+Token
      â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
      â†“         â†“        â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”
  â”‚æœåŠ¡A  â”‚ â”‚æœåŠ¡B  â”‚ â”‚æœåŠ¡C  â”‚ â† å„è‡ªéªŒè¯Token
  â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 è®¾è®¡è¦ç‚¹


> âš ï¸ **é‡è¦åŸåˆ™**ï¼šè®¤è¯ä¸­å¿ƒè¦åšåˆ°**"ä¿¡ä»»ä½†éªŒè¯"**
> - **ä¿¡ä»»**ï¼šç›¸ä¿¡Tokenæ˜¯æœ‰æ•ˆçš„
> - **éªŒè¯**ï¼šæ¯æ¬¡éƒ½è¦æ£€æŸ¥Tokenæ˜¯å¦è¿‡æœŸã€è¢«ç¯¡æ”¹

**ğŸ”§ æŠ€æœ¯è¦æ±‚**ï¼š
- âœ… **é«˜å¯ç”¨**ï¼šè®¤è¯æœåŠ¡ä¸èƒ½æŒ‚ï¼ŒæŒ‚äº†æ‰€æœ‰ç³»ç»Ÿéƒ½ç”¨ä¸äº†
- âœ… **é«˜æ€§èƒ½**ï¼šéªŒè¯é€Ÿåº¦è¦å¿«ï¼Œä¸èƒ½æˆä¸ºç“¶é¢ˆ
- âœ… **å®‰å…¨æ€§**ï¼šTokenä¸èƒ½è¢«ä¼ªé€ æˆ–ç ´è§£
- âœ… **å¯æ‰©å±•**ï¼šæ”¯æŒå¤šç§è®¤è¯æ–¹å¼

---

## 3. ğŸ—ï¸ è®¤è¯æœåŠ¡ä¸­å¿ƒæ¶æ„


### 3.1 æ•´ä½“æ¶æ„è®¾è®¡


è®¤è¯æœåŠ¡ä¸­å¿ƒå°±åƒä¸€ä¸ª**"æ•°å­—åŒ–çš„èº«ä»½è¯åŠç†ä¸­å¿ƒ"**ï¼ŒåŒ…å«å‡ ä¸ªæ ¸å¿ƒéƒ¨é—¨ï¼š

```
è®¤è¯æœåŠ¡ä¸­å¿ƒ (Auth Server)
â”œâ”€â”€ ç”¨æˆ·ç®¡ç†éƒ¨é—¨ (User Management)
â”œâ”€â”€ èº«ä»½éªŒè¯éƒ¨é—¨ (Authentication)  
â”œâ”€â”€ Tokenç­¾å‘éƒ¨é—¨ (Token Service)
â”œâ”€â”€ æƒé™ç®¡ç†éƒ¨é—¨ (Authorization)
â””â”€â”€ ä¼šè¯ç®¡ç†éƒ¨é—¨ (Session Management)
```

### 3.2 æ ¸å¿ƒç»„ä»¶è¯¦è§£


**ğŸ” èº«ä»½éªŒè¯æ¨¡å—**
```java
// ç®€åŒ–çš„èº«ä»½éªŒè¯é€»è¾‘
public class AuthenticationService {
    
    // éªŒè¯ç”¨æˆ·èº«ä»½
    public AuthResult authenticate(String username, String password) {
        User user = userService.findByUsername(username);
        
        if (user == null) {
            return AuthResult.failure("ç”¨æˆ·ä¸å­˜åœ¨");
        }
        
        if (!passwordEncoder.matches(password, user.getPassword())) {
            return AuthResult.failure("å¯†ç é”™è¯¯");
        }
        
        return AuthResult.success(user);
    }
}
```

**ğŸ« Tokenç­¾å‘æ¨¡å—**
```java
// Tokenç­¾å‘æœåŠ¡
public class TokenService {
    
    // ç”Ÿæˆè®¿é—®Token
    public String generateAccessToken(User user) {
        return JWT.create()
            .withSubject(user.getId())           // ç”¨æˆ·ID
            .withClaim("username", user.getName()) // ç”¨æˆ·å
            .withClaim("roles", user.getRoles())   // è§’è‰²ä¿¡æ¯
            .withExpiresAt(new Date(System.currentTimeMillis() + 3600000)) // 1å°æ—¶è¿‡æœŸ
            .sign(algorithm);
    }
}
```

### 3.3 é›†ä¸­è®¤è¯åˆ†å¸ƒå¼éªŒè¯ç­–ç•¥


**ğŸ’¡ æ ¸å¿ƒæ€æƒ³**ï¼šè®¤è¯ä¸­å¿ƒè´Ÿè´£ç™»å½•ï¼Œå„ä¸ªæœåŠ¡è´Ÿè´£éªŒè¯Token

```
ç™»å½•æµç¨‹ï¼š
ç”¨æˆ· â†’ è®¤è¯ä¸­å¿ƒ â†’ éªŒè¯èº«ä»½ â†’ é¢å‘Token â†’ è¿”å›ç»™ç”¨æˆ·

è®¿é—®æµç¨‹ï¼š  
ç”¨æˆ· â†’ æœåŠ¡Aï¼ˆæºå¸¦Tokenï¼‰â†’ éªŒè¯Token â†’ å¤„ç†è¯·æ±‚
ç”¨æˆ· â†’ æœåŠ¡Bï¼ˆæºå¸¦Tokenï¼‰â†’ éªŒè¯Token â†’ å¤„ç†è¯·æ±‚
```

**ğŸš€ ä¼˜åŠ¿**ï¼š
- **æ€§èƒ½é«˜**ï¼šå„æœåŠ¡ç‹¬ç«‹éªŒè¯ï¼Œä¸ä¾èµ–è®¤è¯ä¸­å¿ƒ
- **å¯ç”¨æ€§å¼º**ï¼šè®¤è¯ä¸­å¿ƒæš‚æ—¶æ•…éšœä¸å½±å“å·²ç™»å½•ç”¨æˆ·
- **æ‰©å±•æ€§å¥½**ï¼šæ–°å¢æœåŠ¡åªéœ€è¦é›†æˆTokenéªŒè¯

---

## 4. ğŸ« Tokenç»Ÿä¸€ç®¡ç†æœºåˆ¶


### 4.1 Tokenç”Ÿå‘½å‘¨æœŸç®¡ç†


Tokenå°±åƒ**"ä¸´æ—¶èº«ä»½è¯"**ï¼Œæœ‰å›ºå®šçš„ä½¿ç”¨æœŸé™å’Œç®¡ç†è§„åˆ™ï¼š

```
Tokenç”Ÿå‘½å‘¨æœŸï¼š
åˆ›å»º â†’ æ¿€æ´» â†’ ä½¿ç”¨ â†’ åˆ·æ–° â†’ è¿‡æœŸ/æ’¤é”€
```

### 4.2 Tokenå­˜å‚¨ç­–ç•¥


**ğŸ“Š ä¸‰ç§å­˜å‚¨æ–¹å¼å¯¹æ¯”**ï¼š

| å­˜å‚¨æ–¹å¼ | **ä¼˜ç‚¹** | **ç¼ºç‚¹** | **é€‚ç”¨åœºæ™¯** |
|---------|---------|---------|-------------|
| `å†…å­˜å­˜å‚¨` | `é€Ÿåº¦å¿«` | `é‡å¯ä¸¢å¤±` | `å¼€å‘æµ‹è¯•ç¯å¢ƒ` |
| `Redisç¼“å­˜` | `å¿«é€Ÿ+æŒä¹…` | `éœ€è¦ç»´æŠ¤Redis` | `ç”Ÿäº§ç¯å¢ƒé¦–é€‰` |
| `æ•°æ®åº“` | `æŒä¹…å¯é ` | `é€Ÿåº¦ç›¸å¯¹æ…¢` | `é«˜å®‰å…¨æ€§è¦æ±‚` |

**ğŸ”§ æ¨èçš„Tokenç®¡ç†å®ç°**ï¼š
```java
public class TokenManager {
    
    private RedisTemplate<String, Object> redisTemplate;
    
    // å­˜å‚¨Token
    public void storeToken(String tokenId, TokenInfo tokenInfo) {
        String key = "token:" + tokenId;
        redisTemplate.opsForValue().set(key, tokenInfo, Duration.ofHours(1));
    }
    
    // éªŒè¯Token
    public boolean validateToken(String tokenId) {
        String key = "token:" + tokenId;
        return redisTemplate.hasKey(key);
    }
    
    // æ’¤é”€Token  
    public void revokeToken(String tokenId) {
        String key = "token:" + tokenId;
        redisTemplate.delete(key);
    }
}
```

### 4.3 ç¼“å­˜ç­–ç•¥ä¼˜åŒ–


> ğŸ’¡ **æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**ï¼šä½¿ç”¨**å¤šçº§ç¼“å­˜**æé«˜éªŒè¯æ•ˆç‡

```
TokenéªŒè¯æµç¨‹ï¼š
1. æœ¬åœ°ç¼“å­˜æŸ¥æ‰¾ (æœ€å¿«ï¼Œ1-2ms)
   â†“ (æœªå‘½ä¸­)
2. RedisæŸ¥æ‰¾ (è¾ƒå¿«ï¼Œ5-10ms)  
   â†“ (æœªå‘½ä¸­)
3. æ•°æ®åº“æŸ¥æ‰¾ (æœ€æ…¢ï¼Œ50-100ms)
```

---

## 5. ğŸ¨ è®¤è¯ä¸­å¿ƒè®¾è®¡æ¨¡å¼


### 5.1 å¸¸è§è®¾è®¡æ¨¡å¼


**ğŸ›ï¸ ä¸­å¿ƒåŒ–æ¨¡å¼ï¼ˆæ¨èï¼‰**
```
æ‰€æœ‰è®¤è¯è¯·æ±‚ â†’ è®¤è¯ä¸­å¿ƒ â†’ ç»Ÿä¸€å¤„ç†
ä¼˜ç‚¹ï¼šç®¡ç†é›†ä¸­ï¼Œå®‰å…¨æ€§é«˜
ç¼ºç‚¹ï¼šå•ç‚¹æ•…éšœé£é™©
```

**ğŸŒ è”é‚¦æ¨¡å¼**
```
å¤šä¸ªè®¤è¯ä¸­å¿ƒ â†’ äº’ç›¸ä¿¡ä»» â†’ ç”¨æˆ·å¯ä»¥è·¨åŸŸè®¿é—®  
ä¼˜ç‚¹ï¼šåˆ†å¸ƒå¼ï¼Œæ— å•ç‚¹æ•…éšœ
ç¼ºç‚¹ï¼šé…ç½®å¤æ‚ï¼Œä¿¡ä»»å…³ç³»ç®¡ç†å›°éš¾
```

### 5.2 æ¨èçš„è®¾è®¡æ¨¡å¼


**ğŸ¯ æ··åˆæ¨¡å¼**ï¼šç»“åˆä¸­å¿ƒåŒ–å’Œåˆ†å¸ƒå¼çš„ä¼˜åŠ¿

```
è®¤è¯æ¶æ„è®¾è®¡ï¼š
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚  ä¸»è®¤è¯ä¸­å¿ƒ  â”‚ â† æ ¸å¿ƒè®¤è¯é€»è¾‘
           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
          â”‚               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
    â”‚ è®¤è¯ä¸­å¿ƒA   â”‚ â”‚ è®¤è¯ä¸­å¿ƒB  â”‚ â† è´Ÿè½½åˆ†æ‹…
    â”‚(åœ°åŒº1)     â”‚ â”‚(åœ°åŒº2)    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 è®¾è®¡æ¨¡å¼é€‰æ‹©æŒ‡å¯¼


> ğŸ“ **é€‰æ‹©å»ºè®®**ï¼š
> - **å°å‹ç³»ç»Ÿ**ï¼šå•ä¸€è®¤è¯ä¸­å¿ƒ
> - **ä¸­å‹ç³»ç»Ÿ**ï¼šä¸»ä»è®¤è¯ä¸­å¿ƒ
> - **å¤§å‹ç³»ç»Ÿ**ï¼šå¤šåŒºåŸŸè®¤è¯ä¸­å¿ƒ
> - **è¶…å¤§å‹ç³»ç»Ÿ**ï¼šè”é‚¦è®¤è¯æ¶æ„

---

## 6. ğŸŒ API Gatewayé›†æˆè®¤è¯


### 6.1 ç½‘å…³è®¤è¯æ¨¡å¼


API Gatewayå°±åƒ**"å°åŒºé—¨å«"**ï¼Œæ‰€æœ‰è¿›å…¥çš„äººéƒ½è¦æ£€æŸ¥é€šè¡Œè¯ï¼š

```
ç”¨æˆ·è¯·æ±‚æµç¨‹ï¼š
ç”¨æˆ· â†’ API Gateway â†’ æ£€æŸ¥Token â†’ è½¬å‘åˆ°åç«¯æœåŠ¡
             â†“
        (Tokenæ— æ•ˆ)
             â†“
         æ‹’ç»è®¿é—®
```

### 6.2 ç½‘å…³é›†æˆæ–¹æ¡ˆ


**ğŸ”§ JWTéªŒè¯æ–¹æ¡ˆï¼ˆæ¨èï¼‰**ï¼š
```java
// ç½‘å…³TokenéªŒè¯æ‹¦æˆªå™¨
@Component
public class AuthenticationFilter implements GlobalFilter {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        
        // 1. è·å–Token
        String token = getTokenFromRequest(exchange.getRequest());
        
        // 2. éªŒè¯Token
        if (!jwtUtil.validateToken(token)) {
            return unauthorized(exchange.getResponse());
        }
        
        // 3. è§£æç”¨æˆ·ä¿¡æ¯  
        UserInfo userInfo = jwtUtil.parseToken(token);
        
        // 4. æ·»åŠ åˆ°è¯·æ±‚å¤´ä¼ é€’ç»™åç«¯æœåŠ¡
        ServerHttpRequest request = exchange.getRequest().mutate()
            .header("X-User-Id", userInfo.getUserId())
            .header("X-User-Role", userInfo.getRole())
            .build();
            
        return chain.filter(exchange.mutate().request(request).build());
    }
}
```

### 6.3 ç½‘å…³è®¤è¯æµç¨‹å›¾


```
å®¢æˆ·ç«¯è¯·æ±‚             API Gateway                åç«¯æœåŠ¡
     â”‚                     â”‚                        â”‚
     â”‚â”€â”€â”€â”€[1]è¯·æ±‚+Tokenâ”€â”€â”€â”€â†’â”‚                        â”‚
     â”‚                     â”‚                        â”‚
     â”‚                     â”‚â”€â”€[2]éªŒè¯Tokenâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                     â”‚                        â”‚
     â”‚                     â”‚â”€â”€[3]æ·»åŠ ç”¨æˆ·ä¿¡æ¯â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
     â”‚                     â”‚                        â”‚
     â”‚                     â”‚â†â”€[4]è¿”å›å¤„ç†ç»“æœâ”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                     â”‚                        â”‚
     â”‚â†â”€â”€â”€[5]è¿”å›å“åº”â”€â”€â”€â”€â”€â”€â”‚                        â”‚
```

---

## 7. ğŸ¯ ç»Ÿä¸€è®¤è¯æœåŠ¡è®¾è®¡


### 7.1 UAAç»Ÿä¸€è®¤è¯æœåŠ¡


**UAAï¼ˆUser Account and Authenticationï¼‰**å°±åƒæ˜¯ä¸€ä¸ª**"è¶…çº§èº«ä»½ç®¡ç†ä¸­å¿ƒ"**ï¼Œç®¡ç†æ‰€æœ‰ç”¨æˆ·çš„èº«ä»½å’Œæƒé™ã€‚

> ğŸ’¡ **æ ¸å¿ƒåŠŸèƒ½**ï¼š
> - **ç”¨æˆ·ç®¡ç†**ï¼šæ³¨å†Œã€ç™»å½•ã€å¯†ç é‡ç½®
> - **æƒé™ç®¡ç†**ï¼šè§’è‰²åˆ†é…ã€æƒé™æ§åˆ¶
> - **å®¢æˆ·ç«¯ç®¡ç†**ï¼šä¸åŒåº”ç”¨çš„è®¿é—®æ§åˆ¶
> - **Tokenç®¡ç†**ï¼šç­¾å‘ã€åˆ·æ–°ã€æ’¤é”€

### 7.2 UAAæ¶æ„è®¾è®¡


```
ç»Ÿä¸€è®¤è¯æœåŠ¡æ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            UAAæœåŠ¡                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç”¨æˆ·æœåŠ¡    â”‚  è®¤è¯æœåŠ¡    â”‚ TokenæœåŠ¡â”‚
â”‚ UserService â”‚AuthService  â”‚TokenSvc â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æƒé™æœåŠ¡    â”‚  å®¢æˆ·ç«¯æœåŠ¡  â”‚ ä¼šè¯æœåŠ¡ â”‚
â”‚ RoleService â”‚ClientServiceâ”‚SessionSvcâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.3 UAAæ ¸å¿ƒæ¥å£è®¾è®¡


```java
// ç»Ÿä¸€è®¤è¯æœåŠ¡æ¥å£
@RestController
@RequestMapping("/uaa")
public class UaaController {
    
    // ç”¨æˆ·ç™»å½•
    @PostMapping("/login")
    public ResponseEntity<TokenResponse> login(@RequestBody LoginRequest request) {
        // éªŒè¯ç”¨æˆ·åå¯†ç 
        User user = authService.authenticate(request.getUsername(), request.getPassword());
        
        // ç”ŸæˆToken
        String accessToken = tokenService.generateAccessToken(user);
        String refreshToken = tokenService.generateRefreshToken(user);
        
        return ResponseEntity.ok(new TokenResponse(accessToken, refreshToken));
    }
    
    // Tokenåˆ·æ–°
    @PostMapping("/refresh")
    public ResponseEntity<TokenResponse> refresh(@RequestBody RefreshRequest request) {
        String newAccessToken = tokenService.refreshAccessToken(request.getRefreshToken());
        return ResponseEntity.ok(new TokenResponse(newAccessToken, request.getRefreshToken()));
    }
    
    // ç”¨æˆ·ç™»å‡º
    @PostMapping("/logout")
    public ResponseEntity<Void> logout(@RequestHeader("Authorization") String token) {
        tokenService.revokeToken(extractToken(token));
        return ResponseEntity.ok().build();
    }
}
```

---

## 8. ğŸ‘¤ ç”¨æˆ·èº«ä»½æ•°æ®æ¨¡å‹


### 8.1 ç”¨æˆ·èº«ä»½ä¿¡æ¯ç»“æ„


ç”¨æˆ·èº«ä»½æ•°æ®å°±åƒ**"æ•°å­—èº«ä»½è¯"**ï¼ŒåŒ…å«äº†è¯†åˆ«å’Œæˆæƒç”¨æˆ·æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯ï¼š

```java
// ç”¨æˆ·èº«ä»½æ•°æ®æ¨¡å‹
public class UserIdentity {
    
    // åŸºæœ¬èº«ä»½ä¿¡æ¯
    private String userId;          // ç”¨æˆ·å”¯ä¸€ID
    private String username;        // ç”¨æˆ·å
    private String email;           // é‚®ç®±
    private String phoneNumber;     // æ‰‹æœºå·
    
    // è®¤è¯ä¿¡æ¯  
    private String passwordHash;    // å¯†ç å“ˆå¸Œå€¼
    private LocalDateTime lastLogin; // æœ€åç™»å½•æ—¶é—´
    private boolean enabled;        // è´¦æˆ·æ˜¯å¦æ¿€æ´»
    
    // æƒé™ä¿¡æ¯
    private Set<String> roles;      // è§’è‰²åˆ—è¡¨
    private Set<String> authorities; // æƒé™åˆ—è¡¨
    
    // æ‰©å±•ä¿¡æ¯
    private Map<String, Object> attributes; // è‡ªå®šä¹‰å±æ€§
}
```

### 8.2 ç”¨æˆ·èº«ä»½å­˜å‚¨ç»“æ„


**ğŸ“Š æ•°æ®åº“è¡¨è®¾è®¡**ï¼š

```sql
-- ç”¨æˆ·åŸºæœ¬ä¿¡æ¯è¡¨
CREATE TABLE users (
    id VARCHAR(64) PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(100),
    phone_number VARCHAR(20),
    password_hash VARCHAR(255) NOT NULL,
    enabled BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç”¨æˆ·è§’è‰²å…³ç³»è¡¨
CREATE TABLE user_roles (
    user_id VARCHAR(64),
    role_id VARCHAR(64),
    PRIMARY KEY (user_id, role_id)
);

-- è§’è‰²æƒé™è¡¨
CREATE TABLE role_permissions (
    role_id VARCHAR(64),
    permission VARCHAR(100),
    PRIMARY KEY (role_id, permission)
);
```

### 8.3 èº«ä»½æ•°æ®ç¼“å­˜ç­–ç•¥


> ğŸš€ **æ€§èƒ½ä¼˜åŒ–**ï¼šå°†ç”¨æˆ·èº«ä»½ä¿¡æ¯ç¼“å­˜åˆ°Redisä¸­ï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢

```java
// ç”¨æˆ·èº«ä»½ç¼“å­˜æœåŠ¡
@Service
public class UserIdentityCache {
    
    @Autowired
    private RedisTemplate<String, UserIdentity> redisTemplate;
    
    // ç¼“å­˜ç”¨æˆ·èº«ä»½ä¿¡æ¯
    public void cacheUserIdentity(String userId, UserIdentity identity) {
        String key = "user:identity:" + userId;
        redisTemplate.opsForValue().set(key, identity, Duration.ofMinutes(30));
    }
    
    // è·å–ç¼“å­˜çš„ç”¨æˆ·èº«ä»½ä¿¡æ¯
    public UserIdentity getCachedUserIdentity(String userId) {
        String key = "user:identity:" + userId;
        return redisTemplate.opsForValue().get(key);
    }
}
```

---

## 9. ğŸ“± å¤šå®¢æˆ·ç«¯æ”¯æŒç­–ç•¥


### 9.1 å¤šå®¢æˆ·ç«¯åœºæ™¯


ç°ä»£åº”ç”¨é€šå¸¸éœ€è¦æ”¯æŒå¤šç§å®¢æˆ·ç«¯ç±»å‹ï¼š

```
å®¢æˆ·ç«¯ç±»å‹ï¼š
â”œâ”€â”€ Webæµè§ˆå™¨åº”ç”¨ (SPA)
â”œâ”€â”€ ç§»åŠ¨App (iOS/Android)  
â”œâ”€â”€ æ¡Œé¢åº”ç”¨ç¨‹åº
â”œâ”€â”€ æœåŠ¡ç«¯APIè°ƒç”¨
â””â”€â”€ ç¬¬ä¸‰æ–¹é›†æˆåº”ç”¨
```

### 9.2 ä¸åŒå®¢æˆ·ç«¯çš„è®¤è¯ç­–ç•¥


**ğŸ“Š å®¢æˆ·ç«¯ç±»å‹ä¸è®¤è¯æ–¹å¼**ï¼š

| å®¢æˆ·ç«¯ç±»å‹ | **è®¤è¯æ–¹å¼** | **Tokenå­˜å‚¨** | **å®‰å…¨çº§åˆ«** |
|-----------|-------------|-------------|-------------|
| `Web SPA` | `æˆæƒç æ¨¡å¼+PKCE` | `å†…å­˜/SessionStorage` | `ä¸­ç­‰` |
| `ç§»åŠ¨App` | `æˆæƒç æ¨¡å¼+PKCE` | `å®‰å…¨å­˜å‚¨/Keychain` | `é«˜` |
| `æœåŠ¡ç«¯` | `å®¢æˆ·ç«¯å‡­è¯æ¨¡å¼` | `é…ç½®æ–‡ä»¶` | `æœ€é«˜` |
| `ç¬¬ä¸‰æ–¹åº”ç”¨` | `æˆæƒç æ¨¡å¼` | `æ•°æ®åº“` | `ä¸­ç­‰` |

### 9.3 å¤šå®¢æˆ·ç«¯é…ç½®ç®¡ç†


```java
// å®¢æˆ·ç«¯é…ç½®ç®¡ç†
@Entity
public class OAuthClient {
    
    @Id
    private String clientId;                    // å®¢æˆ·ç«¯ID
    
    private String clientSecret;               // å®¢æˆ·ç«¯å¯†é’¥
    private Set<String> grantTypes;            // æ”¯æŒçš„æˆæƒç±»å‹
    private Set<String> scopes;                // å…è®¸çš„æƒé™èŒƒå›´
    private Set<String> redirectUris;          // é‡å®šå‘åœ°å€
    private Integer accessTokenValiditySeconds; // Tokenæœ‰æ•ˆæœŸ
    
    // å®¢æˆ·ç«¯ç±»å‹ï¼šweb, mobile, serviceç­‰
    private String clientType;
    
    // æ˜¯å¦éœ€è¦ç”¨æˆ·æˆæƒç¡®è®¤
    private boolean requireApproval;
}
```

### 9.4 å®¢æˆ·ç«¯è®¿é—®æ§åˆ¶


> âš ï¸ **å®‰å…¨ç­–ç•¥**ï¼šä¸åŒç±»å‹çš„å®¢æˆ·ç«¯é‡‡ç”¨ä¸åŒçš„å®‰å…¨æªæ–½

```java
// å®¢æˆ·ç«¯è®¿é—®æ§åˆ¶æœåŠ¡
@Service  
public class ClientAccessControl {
    
    public boolean validateClientAccess(String clientId, String requestedScope) {
        OAuthClient client = clientService.findByClientId(clientId);
        
        // æ£€æŸ¥å®¢æˆ·ç«¯æ˜¯å¦æ¿€æ´»
        if (!client.isEnabled()) {
            return false;
        }
        
        // æ£€æŸ¥è¯·æ±‚çš„æƒé™æ˜¯å¦åœ¨å…è®¸èŒƒå›´å†…
        return client.getScopes().contains(requestedScope);
    }
}
```

---

## 10. ğŸ—ï¸ è®¤è¯ä¸­å¿ƒé«˜å¯ç”¨éƒ¨ç½²


### 10.1 é«˜å¯ç”¨æ¶æ„è®¾è®¡


è®¤è¯ä¸­å¿ƒçš„é«˜å¯ç”¨å°±åƒ**"é“¶è¡ŒATMæœºç½‘ç»œ"**ï¼Œè¦ç¡®ä¿ç”¨æˆ·éšæ—¶éšåœ°éƒ½èƒ½å–åˆ°é’±ï¼š

```
é«˜å¯ç”¨æ¶æ„ï¼š
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ è´Ÿè½½å‡è¡¡å™¨   â”‚ â† æµé‡åˆ†å‘
          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â†“         â†“         â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚è®¤è¯ä¸­å¿ƒ1 â”‚ â”‚ è®¤è¯ä¸­å¿ƒ2  â”‚ â”‚è®¤è¯ä¸­å¿ƒ3 â”‚ â† å¤šå®ä¾‹éƒ¨ç½²
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚         â”‚           â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Redisé›†ç¾¤     â”‚ â† å…±äº«å­˜å‚¨
         â”‚ (ä¸»ä»+å“¨å…µ)   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 10.2 éƒ¨ç½²ç­–ç•¥


**ğŸ¯ æ¨èçš„éƒ¨ç½²æ–¹æ¡ˆ**ï¼š

```yaml
# Docker Compose é«˜å¯ç”¨éƒ¨ç½²ç¤ºä¾‹
version: '3.8'
services:
  # è®¤è¯æœåŠ¡å®ä¾‹
  auth-server-1:
    image: auth-server:latest
    environment:
      - SERVER_PORT=8081
      - REDIS_HOST=redis-cluster
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      
  auth-server-2:
    image: auth-server:latest  
    environment:
      - SERVER_PORT=8082
      - REDIS_HOST=redis-cluster
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/health"]
      
  # è´Ÿè½½å‡è¡¡å™¨
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    depends_on:
      - auth-server-1
      - auth-server-2
```

### 10.3 æ•…éšœè½¬ç§»æœºåˆ¶


> ğŸ’¡ **æ•…éšœè½¬ç§»ç­–ç•¥**ï¼šå½“æŸä¸ªè®¤è¯ä¸­å¿ƒå®ä¾‹æ•…éšœæ—¶ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°å¥åº·å®ä¾‹

**å¥åº·æ£€æŸ¥é…ç½®**ï¼š
```java
// å¥åº·æ£€æŸ¥ç«¯ç‚¹
@RestController
public class HealthController {
    
    @Autowired
    private RedisTemplate redisTemplate;
    
    @GetMapping("/health")
    public ResponseEntity<Map<String, Object>> health() {
        Map<String, Object> status = new HashMap<>();
        
        try {
            // æ£€æŸ¥æ•°æ®åº“è¿æ¥
            userRepository.count();
            status.put("database", "UP");
            
            // æ£€æŸ¥Redisè¿æ¥
            redisTemplate.opsForValue().get("health-check");
            status.put("redis", "UP");
            
            status.put("status", "UP");
            return ResponseEntity.ok(status);
            
        } catch (Exception e) {
            status.put("status", "DOWN");
            status.put("error", e.getMessage());
            return ResponseEntity.status(503).body(status);
        }
    }
}
```

---

## 11. ğŸ” ç”¨æˆ·å¯†ç å®‰å…¨ç®¡ç†


### 11.1 å¯†ç å®‰å…¨ç­–ç•¥


å¯†ç å®‰å…¨å°±åƒ**"ä¿é™©ç®±çš„å¯†ç é”"**ï¼Œéœ€è¦å¤šé‡ä¿æŠ¤æœºåˆ¶ï¼š

> ğŸ›¡ï¸ **å¯†ç å®‰å…¨åŸåˆ™**ï¼š
> - **ä¸æ˜æ–‡å­˜å‚¨**ï¼šæ°¸è¿œä¸ä¿å­˜åŸå§‹å¯†ç 
> - **å¼ºå“ˆå¸Œç®—æ³•**ï¼šä½¿ç”¨BCryptã€SCryptç­‰
> - **åŠ ç›å¤„ç†**ï¼šé˜²æ­¢å½©è™¹è¡¨æ”»å‡»
> - **å¯†ç ç­–ç•¥**ï¼šå¼ºåˆ¶å¤æ‚å¯†ç è§„åˆ™

### 11.2 å¯†ç åŠ å¯†å®ç°


```java
// å¯†ç å®‰å…¨ç®¡ç†æœåŠ¡
@Service
public class PasswordSecurityService {
    
    // ä½¿ç”¨BCryptåŠ å¯†å¯†ç 
    private PasswordEncoder passwordEncoder = new BCryptPasswordEncoder(12);
    
    // åŠ å¯†å¯†ç 
    public String encodePassword(String rawPassword) {
        return passwordEncoder.encode(rawPassword);
    }
    
    // éªŒè¯å¯†ç 
    public boolean matches(String rawPassword, String encodedPassword) {
        return passwordEncoder.matches(rawPassword, encodedPassword);
    }
    
    // å¯†ç å¼ºåº¦æ£€æŸ¥
    public boolean isStrongPassword(String password) {
        return password.length() >= 8 &&                    // è‡³å°‘8ä½
               password.matches(".*[A-Z].*") &&             // åŒ…å«å¤§å†™å­—æ¯
               password.matches(".*[a-z].*") &&             // åŒ…å«å°å†™å­—æ¯  
               password.matches(".*[0-9].*") &&             // åŒ…å«æ•°å­—
               password.matches(".*[!@#$%^&*()_+].*");      // åŒ…å«ç‰¹æ®Šå­—ç¬¦
    }
}
```

### 11.3 å¯†ç ç­–ç•¥é…ç½®


**ğŸ”§ å¯†ç ç­–ç•¥é…ç½®**ï¼š
```java
// å¯†ç ç­–ç•¥é…ç½®
@Configuration
public class PasswordPolicyConfig {
    
    @Bean
    public PasswordPolicy passwordPolicy() {
        return PasswordPolicy.builder()
            .minLength(8)                      // æœ€å°é•¿åº¦8ä½
            .maxLength(128)                    // æœ€å¤§é•¿åº¦128ä½
            .requireUppercase(true)            // éœ€è¦å¤§å†™å­—æ¯
            .requireLowercase(true)            // éœ€è¦å°å†™å­—æ¯
            .requireNumbers(true)              // éœ€è¦æ•°å­—
            .requireSpecialChars(true)         // éœ€è¦ç‰¹æ®Šå­—ç¬¦
            .maxRepeatingChars(3)              // æœ€å¤š3ä¸ªé‡å¤å­—ç¬¦
            .historySize(5)                    // ä¸èƒ½ä¸æœ€è¿‘5æ¬¡å¯†ç ç›¸åŒ
            .build();
    }
}
```

### 11.4 å¯†ç é‡ç½®æœºåˆ¶


```java
// å¯†ç é‡ç½®æœåŠ¡
@Service
public class PasswordResetService {
    
    // å‘é€å¯†ç é‡ç½®é‚®ä»¶
    public void sendPasswordResetEmail(String email) {
        User user = userService.findByEmail(email);
        if (user == null) return; // ä¸æš´éœ²ç”¨æˆ·æ˜¯å¦å­˜åœ¨
        
        // ç”Ÿæˆé‡ç½®Tokenï¼ˆæœ‰æ•ˆæœŸ30åˆ†é’Ÿï¼‰
        String resetToken = generateResetToken();
        cacheService.put("reset:" + resetToken, user.getId(), 30, TimeUnit.MINUTES);
        
        // å‘é€é‚®ä»¶
        emailService.sendPasswordResetEmail(email, resetToken);
    }
    
    // é‡ç½®å¯†ç 
    public boolean resetPassword(String token, String newPassword) {
        String userId = cacheService.get("reset:" + token);
        if (userId == null) return false; // Tokenæ— æ•ˆæˆ–è¿‡æœŸ
        
        // æ›´æ–°å¯†ç 
        userService.updatePassword(userId, passwordEncoder.encode(newPassword));
        
        // æ¸…é™¤Token
        cacheService.delete("reset:" + token);
        
        return true;
    }
}
```

---

## 12. ğŸ¢ å¤šç§Ÿæˆ·è®¤è¯æ”¯æŒ


### 12.1 å¤šç§Ÿæˆ·æ¦‚å¿µ


å¤šç§Ÿæˆ·è®¤è¯å°±åƒ**"å¤§å‹å•†åœºçš„ç§Ÿæˆ·ç®¡ç†"**ï¼Œæ¯ä¸ªç§Ÿæˆ·æœ‰ç‹¬ç«‹çš„åº—é“ºï¼Œä½†å…±äº«åŸºç¡€è®¾æ–½ï¼š

> ğŸ’¡ **å¤šç§Ÿæˆ·åœºæ™¯**ï¼š
> - **SaaSåº”ç”¨**ï¼šå¤šä¸ªä¼ä¸šä½¿ç”¨åŒä¸€å¥—ç³»ç»Ÿ
> - **å¹³å°æœåŠ¡**ï¼šä¸ºä¸åŒå®¢æˆ·æä¾›ç‹¬ç«‹ç¯å¢ƒ
> - **ä¼ä¸šé›†å›¢**ï¼šä¸åŒå­å…¬å¸ä½¿ç”¨ç»Ÿä¸€è®¤è¯

### 12.2 å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»


**ğŸ“Š ä¸‰ç§éš”ç¦»æ¨¡å¼**ï¼š

| éš”ç¦»æ¨¡å¼ | **æ•°æ®éš”ç¦»** | **æˆæœ¬** | **å®‰å…¨æ€§** |
|---------|------------|---------|-----------|
| `å…±äº«æ•°æ®åº“` | `é€»è¾‘éš”ç¦»` | `ä½` | `ä¸­ç­‰` |
| `ç‹¬ç«‹Schema` | `Schemaéš”ç¦»` | `ä¸­ç­‰` | `é«˜` |
| `ç‹¬ç«‹æ•°æ®åº“` | `ç‰©ç†éš”ç¦»` | `é«˜` | `æœ€é«˜` |

### 12.3 å¤šç§Ÿæˆ·è®¤è¯å®ç°


```java
// å¤šç§Ÿæˆ·ä¸Šä¸‹æ–‡ç®¡ç†
@Component
public class TenantContext {
    
    private static final ThreadLocal<String> tenantId = new ThreadLocal<>();
    
    public static void setTenantId(String tenant) {
        tenantId.set(tenant);
    }
    
    public static String getTenantId() {
        return tenantId.get();
    }
    
    public static void clear() {
        tenantId.remove();
    }
}

// å¤šç§Ÿæˆ·è®¤è¯æœåŠ¡
@Service
public class MultiTenantAuthService {
    
    public AuthResult authenticate(String tenantId, String username, String password) {
        // è®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡
        TenantContext.setTenantId(tenantId);
        
        try {
            // åœ¨æŒ‡å®šç§Ÿæˆ·ä¸‹éªŒè¯ç”¨æˆ·
            User user = userService.findByUsernameAndTenant(username, tenantId);
            
            if (user == null || !passwordEncoder.matches(password, user.getPassword())) {
                return AuthResult.failure("è®¤è¯å¤±è´¥");
            }
            
            // ç”ŸæˆåŒ…å«ç§Ÿæˆ·ä¿¡æ¯çš„Token
            String token = jwtService.generateToken(user, tenantId);
            
            return AuthResult.success(token);
            
        } finally {
            TenantContext.clear();
        }
    }
}
```

### 12.4 ç§Ÿæˆ·è·¯ç”±ç­–ç•¥


```java
// ç§Ÿæˆ·è·¯ç”±æ‹¦æˆªå™¨
@Component
public class TenantRoutingInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, 
                           Object handler) throws Exception {
        
        // ä»è¯·æ±‚ä¸­æå–ç§Ÿæˆ·IDï¼ˆå¯ä»¥ä»åŸŸåã€Headerã€å‚æ•°ç­‰è·å–ï¼‰
        String tenantId = extractTenantId(request);
        
        if (tenantId == null) {
            response.setStatus(HttpStatus.BAD_REQUEST.value());
            return false;
        }
        
        // éªŒè¯ç§Ÿæˆ·æ˜¯å¦å­˜åœ¨ä¸”æ¿€æ´»
        if (!tenantService.isActiveTenant(tenantId)) {
            response.setStatus(HttpStatus.FORBIDDEN.value());
            return false;
        }
        
        // è®¾ç½®ç§Ÿæˆ·ä¸Šä¸‹æ–‡
        TenantContext.setTenantId(tenantId);
        
        return true;
    }
    
    private String extractTenantId(HttpServletRequest request) {
        // ä»å­åŸŸåæå–ï¼štenant1.myapp.com
        String host = request.getServerName();
        if (host.contains(".")) {
            return host.split("\\.")[0];
        }
        
        // ä»Headeræå–
        return request.getHeader("X-Tenant-ID");
    }
}
```

---

## 13. ğŸ›ï¸ èº«ä»½æä¾›è€…æ¶æ„


### 13.1 èº«ä»½æä¾›è€…ï¼ˆIdPï¼‰æ¦‚å¿µ


èº«ä»½æä¾›è€…å°±åƒ**"æƒå¨çš„èº«ä»½è¯å‘æ”¾æœºæ„"**ï¼Œè´Ÿè´£éªŒè¯å’Œè¯æ˜ç”¨æˆ·èº«ä»½ï¼š

> ğŸ’¡ **IdPæ ¸å¿ƒèŒè´£**ï¼š
> - **èº«ä»½éªŒè¯**ï¼šç¡®è®¤ç”¨æˆ·æ˜¯è°
> - **èº«ä»½æ–­è¨€**ï¼šå‘å…¶ä»–ç³»ç»Ÿè¯æ˜ç”¨æˆ·èº«ä»½
> - **å±æ€§æä¾›**ï¼šæä¾›ç”¨æˆ·çš„è¯¦ç»†ä¿¡æ¯
> - **ä¼šè¯ç®¡ç†**ï¼šç®¡ç†ç”¨æˆ·ç™»å½•çŠ¶æ€

### 13.2 IdPæ¶æ„è®¾è®¡


```
èº«ä»½æä¾›è€…æ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         èº«ä»½æä¾›è€… (IdP)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚èº«ä»½éªŒè¯æ¨¡å— â”‚  â”‚å±æ€§ç®¡ç†æ¨¡å— â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚æ–­è¨€ç­¾å‘æ¨¡å— â”‚  â”‚ä¼šè¯ç®¡ç†æ¨¡å— â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 13.3 IdPæ ¸å¿ƒæ¥å£


```java
// èº«ä»½æä¾›è€…æ¥å£
public interface IdentityProvider {
    
    // éªŒè¯ç”¨æˆ·èº«ä»½
    IdentityAssertion authenticate(AuthenticationRequest request);
    
    // è·å–ç”¨æˆ·å±æ€§
    UserAttributes getUserAttributes(String userId);
    
    // ç­¾å‘èº«ä»½æ–­è¨€
    SecurityAssertion issueAssertion(String userId, String audience);
    
    // éªŒè¯èº«ä»½æ–­è¨€
    boolean validateAssertion(SecurityAssertion assertion);
}

// èº«ä»½æ–­è¨€å®ä½“
public class IdentityAssertion {
    private String userId;                    // ç”¨æˆ·ID
    private String issuer;                    // ç­¾å‘æ–¹
    private String audience;                  // ç›®æ ‡å—ä¼—
    private Map<String, Object> attributes;   // ç”¨æˆ·å±æ€§
    private Date issuedAt;                    // ç­¾å‘æ—¶é—´
    private Date expiresAt;                   // è¿‡æœŸæ—¶é—´
    private String signature;                 // æ•°å­—ç­¾å
}
```

### 13.4 è”é‚¦èº«ä»½ç®¡ç†


**ğŸŒ è”é‚¦è®¤è¯åœºæ™¯**ï¼šå¤šä¸ªç»„ç»‡å…±äº«èº«ä»½è®¤è¯æœåŠ¡

```
è”é‚¦èº«ä»½æ¶æ„ï¼š
     ä¼ä¸šA IdP â†â”€â”€â”
                   â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     ä¼ä¸šB IdP â†â”€â”€â”¼â”€â”€â”€â†’â”‚  ä¿¡ä»»å…³ç³»    â”‚
                   â”‚    â”‚  ç®¡ç†ä¸­å¿ƒ    â”‚
     ä¼ä¸šC IdP â†â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   åº”ç”¨æœåŠ¡       â”‚
                    â”‚ (æ¥å—å¤šæ–¹è®¤è¯)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è”é‚¦ä¿¡ä»»ç®¡ç†**ï¼š
```java
// è”é‚¦ä¿¡ä»»ç®¡ç†æœåŠ¡
@Service
public class FederationTrustService {
    
    // éªŒè¯æ¥è‡ªè”é‚¦ä¼™ä¼´çš„æ–­è¨€
    public boolean validateFederatedAssertion(SecurityAssertion assertion) {
        
        // 1. æ£€æŸ¥ç­¾å‘æ–¹æ˜¯å¦åœ¨ä¿¡ä»»åˆ—è¡¨ä¸­
        String issuer = assertion.getIssuer();
        FederatedPartner partner = federatedPartnerRepository.findByIssuer(issuer);
        
        if (partner == null || !partner.isActive()) {
            return false;
        }
        
        // 2. éªŒè¯æ•°å­—ç­¾å
        PublicKey publicKey = partner.getPublicKey();
        if (!cryptoService.verifySignature(assertion, publicKey)) {
            return false;
        }
        
        // 3. æ£€æŸ¥æ–­è¨€æ˜¯å¦è¿‡æœŸ
        if (assertion.getExpiresAt().before(new Date())) {
            return false;
        }
        
        return true;
    }
}
```

---

## 14. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 14.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ è®¤è¯ä¸­å¿ƒï¼šç»Ÿä¸€èº«ä»½éªŒè¯çš„æ ¸å¿ƒç»„ä»¶ï¼Œç±»ä¼¼æ•°å­—èº«ä»½è¯åŠäº‹å¤„
ğŸ”¸ é›†ä¸­è®¤è¯åˆ†å¸ƒå¼éªŒè¯ï¼šç™»å½•é›†ä¸­å¤„ç†ï¼ŒéªŒè¯åˆ†æ•£è¿›è¡Œ
ğŸ”¸ Tokenç®¡ç†ï¼šç»Ÿä¸€ç­¾å‘ã€å­˜å‚¨ã€éªŒè¯ã€æ’¤é”€Token
ğŸ”¸ å¤šå®¢æˆ·ç«¯æ”¯æŒï¼šé€‚é…ä¸åŒç±»å‹å®¢æˆ·ç«¯çš„è®¤è¯éœ€æ±‚  
ğŸ”¸ é«˜å¯ç”¨è®¾è®¡ï¼šç¡®ä¿è®¤è¯æœåŠ¡çš„ç¨³å®šæ€§å’Œå¯é æ€§
ğŸ”¸ å¯†ç å®‰å…¨ï¼šå¼ºå“ˆå¸Œã€åŠ ç›ã€å¯†ç ç­–ç•¥ç­‰å®‰å…¨æªæ–½
ğŸ”¸ å¤šç§Ÿæˆ·æ”¯æŒï¼šä¸ºå¤šä¸ªç»„ç»‡æä¾›éš”ç¦»çš„è®¤è¯æœåŠ¡
ğŸ”¸ èº«ä»½æä¾›è€…ï¼šæ ‡å‡†åŒ–çš„èº«ä»½éªŒè¯å’Œæ–­è¨€æœåŠ¡
```

### 14.2 å…³é”®è®¾è®¡è¦ç‚¹


> ğŸ’¡ **è®¾è®¡åŸåˆ™è®°å¿†**ï¼š
> - **å•ä¸€èŒè´£**ï¼šè®¤è¯ä¸­å¿ƒåªç®¡èº«ä»½éªŒè¯ï¼Œä¸ç®¡ä¸šåŠ¡é€»è¾‘
> - **é›†ä¸­ç»Ÿä¸€**ï¼šæ‰€æœ‰è®¤è¯è¯·æ±‚ç»Ÿä¸€å¤„ç†ï¼Œé¿å…é‡å¤å»ºè®¾
> - **å®‰å…¨ç¬¬ä¸€**ï¼šæ‰€æœ‰è®¾è®¡ä»¥å®‰å…¨æ€§ä¸ºé¦–è¦è€ƒè™‘
> - **é«˜å¯ç”¨æ€§**ï¼šè®¤è¯æœåŠ¡ä¸èƒ½æˆä¸ºç³»ç»Ÿçš„å•ç‚¹æ•…éšœ
> - **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒå¤šç§è®¤è¯æ–¹å¼å’Œå®¢æˆ·ç«¯ç±»å‹

### 14.3 å®é™…åº”ç”¨å»ºè®®


**ğŸ¯ é¡¹ç›®å®æ–½å»ºè®®**ï¼š
- **å°å‹é¡¹ç›®**ï¼šä½¿ç”¨ç°æˆçš„è®¤è¯æ¡†æ¶ï¼ˆå¦‚Spring Security + JWTï¼‰
- **ä¸­å‹é¡¹ç›®**ï¼šè‡ªå»ºç®€åŒ–çš„è®¤è¯ä¸­å¿ƒï¼Œé‡ç‚¹å…³æ³¨Tokenç®¡ç†
- **å¤§å‹é¡¹ç›®**ï¼šå®Œæ•´çš„è®¤è¯ä¸­å¿ƒè®¾è®¡ï¼ŒåŒ…å«å¤šç§Ÿæˆ·æ”¯æŒ
- **è¶…å¤§å‹é¡¹ç›®**ï¼šè”é‚¦èº«ä»½ç®¡ç†ï¼Œæ”¯æŒè·¨ç»„ç»‡è®¤è¯

**ğŸ”§ æŠ€æœ¯é€‰å‹å»ºè®®**ï¼š
- **JWT**ï¼šé€‚åˆæ— çŠ¶æ€è®¤è¯ï¼Œæ€§èƒ½å¥½
- **Session**ï¼šé€‚åˆä¼ ç»ŸWebåº”ç”¨ï¼Œå®‰å…¨æ€§é«˜
- **OAuth2**ï¼šé€‚åˆç¬¬ä¸‰æ–¹é›†æˆï¼Œæ ‡å‡†åŒ–ç¨‹åº¦é«˜
- **SAML**ï¼šé€‚åˆä¼ä¸šçº§åº”ç”¨ï¼ŒåŠŸèƒ½å®Œæ•´

**âš ï¸ å¸¸è§é™·é˜±é¿å…**ï¼š
- **ä¸è¦**æŠŠä¸šåŠ¡é€»è¾‘æ”¾åœ¨è®¤è¯ä¸­å¿ƒ
- **ä¸è¦**åœ¨Tokenä¸­å­˜å‚¨æ•æ„Ÿä¿¡æ¯
- **ä¸è¦**å¿½ç•¥Tokençš„å®‰å…¨å­˜å‚¨
- **ä¸è¦**å¿½è§†å¯†ç å®‰å…¨ç­–ç•¥
- **ä¸è¦**è®¾è®¡è¿‡äºå¤æ‚çš„æƒé™æ¨¡å‹

### 14.4 å­¦ä¹ è·¯å¾„å»ºè®®


**ğŸ“š å­¦ä¹ é¡ºåº**ï¼š
1. ç†è§£è®¤è¯å’Œæˆæƒçš„åŸºæœ¬æ¦‚å¿µ
2. æŒæ¡JWTå’ŒOAuth2.0åè®®
3. å­¦ä¹ Spring Securityæ¡†æ¶
4. å®è·µç®€å•çš„è®¤è¯ä¸­å¿ƒæ­å»º
5. æ·±å…¥å­¦ä¹ é«˜çº§ç‰¹æ€§ï¼ˆå¤šç§Ÿæˆ·ã€è”é‚¦ç­‰ï¼‰

**æ ¸å¿ƒè®°å¿†**ï¼š
- è®¤è¯ä¸­å¿ƒæ˜¯å¾®æœåŠ¡å®‰å…¨æ¶æ„çš„æ ¸å¿ƒåŸºç¡€è®¾æ–½
- è®¾è®¡è¦ç‚¹æ˜¯é›†ä¸­è®¤è¯ã€åˆ†å¸ƒå¼éªŒè¯ã€ç»Ÿä¸€ç®¡ç†
- å®‰å…¨æ€§ã€å¯ç”¨æ€§ã€å¯æ‰©å±•æ€§æ˜¯è®¾è®¡çš„ä¸‰å¤§æ”¯æŸ±
- é€‰æ‹©åˆé€‚çš„æŠ€æœ¯æ–¹æ¡ˆæ¯”è¿½æ±‚å¤æ‚çš„æ¶æ„æ›´é‡è¦