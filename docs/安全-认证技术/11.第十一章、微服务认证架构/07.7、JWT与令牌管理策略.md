---
title: 7ã€JWTä¸ä»¤ç‰Œç®¡ç†ç­–ç•¥
---
## ğŸ“š ç›®å½•

1. [ä»¤ç‰Œç±»å‹å¯¹æ¯”åˆ†æ](#1-ä»¤ç‰Œç±»å‹å¯¹æ¯”åˆ†æ)
2. [JWTç»“æ„ä¸ç­¾åç®—æ³•](#2-jwtç»“æ„ä¸ç­¾åç®—æ³•)
3. [JWKSä¸å¯†é’¥ç®¡ç†](#3-jwksä¸å¯†é’¥ç®¡ç†)
4. [ä»¤ç‰ŒåŠé”€ä¸é»‘åå•ç­–ç•¥](#4-ä»¤ç‰ŒåŠé”€ä¸é»‘åå•ç­–ç•¥)
5. [Introspectionç«¯ç‚¹æœºåˆ¶](#5-introspectionç«¯ç‚¹æœºåˆ¶)
6. [ä»¤ç‰Œå°ºå¯¸ä¸ç½‘å…³é™åˆ¶](#6-ä»¤ç‰Œå°ºå¯¸ä¸ç½‘å…³é™åˆ¶)
7. [å…¬é’¥éªŒè¯ä¸å¯†é’¥è½®æ¢](#7-å…¬é’¥éªŒè¯ä¸å¯†é’¥è½®æ¢)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” ä»¤ç‰Œç±»å‹å¯¹æ¯”åˆ†æ


### 1.1 JWT vs Opaque Token åŸºæœ¬æ¦‚å¿µ


**ğŸ¯ ä»€ä¹ˆæ˜¯JWTï¼Ÿ**
JWTï¼ˆJSON Web Tokenï¼‰å°±åƒä¸€å¼ **è‡ªå¸¦èº«ä»½è¯æ˜çš„é€šè¡Œè¯**ï¼Œé‡Œé¢åŒ…å«äº†ç”¨æˆ·ä¿¡æ¯ï¼Œä¸éœ€è¦é¢å¤–æŸ¥è¯¢å°±èƒ½çŸ¥é“æŒæœ‰è€…æ˜¯è°ã€‚

**ğŸ¯ ä»€ä¹ˆæ˜¯Opaque Tokenï¼Ÿ**
Opaque Tokenå°±åƒä¸€å¼ **é¤å…å–é¤å·ç ç‰Œ**ï¼Œå·ç æœ¬èº«æ²¡æœ‰æ„ä¹‰ï¼Œå¿…é¡»æ‹¿åˆ°æœåŠ¡å°ï¼ˆè®¤è¯æœåŠ¡ï¼‰æ‰èƒ½çŸ¥é“å¯¹åº”çš„è®¢å•å†…å®¹ã€‚

```
JWTä»¤ç‰Œç¤ºä¾‹ï¼ˆå¯è¯»å–å†…å®¹ï¼‰ï¼š
eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjoxMjM0LCJuYW1lIjoiZGF2aWQiLCJleHAiOjE2MDA1NTUyMDB9.signature

è§£ç åèƒ½ç›´æ¥çœ‹åˆ°ï¼š
{
  "user_id": 1234,
  "name": "david",
  "exp": 1600555200
}

Opaque Tokenç¤ºä¾‹ï¼ˆä¸å¯è¯»å–ï¼‰ï¼š
a8f5c9d7e2b4a1c6f8e3d9b2a5c7f1e4
```

### 1.2 ä¸¤ç§ä»¤ç‰Œçš„ä¼˜ç¼ºç‚¹å¯¹æ¯”


| ç‰¹æ€§ | **JWT** | **Opaque Token** |
|------|---------|------------------|
| **ä¿¡æ¯è·å–** | `è‡ªåŒ…å«ï¼Œæ— éœ€æŸ¥è¯¢` | `éœ€è¦è°ƒç”¨è®¤è¯æœåŠ¡æŸ¥è¯¢` |
| **æ€§èƒ½** | `éªŒè¯å¿«ï¼Œæœ¬åœ°è§£æ` | `æ¯æ¬¡éœ€è¦ç½‘ç»œè°ƒç”¨` |
| **å®‰å…¨æ€§** | `ä¿¡æ¯å¯è§ï¼Œå®¹æ˜“æ³„éœ²` | `ä¿¡æ¯ä¸å¯è§ï¼Œæ›´å®‰å…¨` |
| **æ’¤é”€èƒ½åŠ›** | `éš¾ä»¥æ’¤é”€ï¼Œéœ€è¦é¢å¤–æœºåˆ¶` | `æ’¤é”€ç®€å•ï¼Œåˆ é™¤è®°å½•å³å¯` |
| **å­˜å‚¨éœ€æ±‚** | `æ— éœ€æœåŠ¡ç«¯å­˜å‚¨` | `éœ€è¦æœåŠ¡ç«¯å­˜å‚¨ä¼šè¯ä¿¡æ¯` |
| **ä»¤ç‰Œå¤§å°** | `è¾ƒå¤§(å‡ KB)` | `è¾ƒå°(å‡ åå­—èŠ‚)` |

### 1.3 é€‚ç”¨åœºæ™¯åˆ†æ


**ğŸ¯ JWTé€‚ç”¨åœºæ™¯**
```
âœ… å¾®æœåŠ¡æ¶æ„ï¼šé¿å…é¢‘ç¹è°ƒç”¨è®¤è¯æœåŠ¡
âœ… æ— çŠ¶æ€APIï¼šä¸æƒ³åœ¨æœåŠ¡ç«¯å­˜å‚¨ä¼šè¯
âœ… è·¨åŸŸåœºæ™¯ï¼šéœ€è¦åœ¨ä¸åŒåŸŸåé—´ä¼ é€’ç”¨æˆ·ä¿¡æ¯
âœ… ç§»åŠ¨åº”ç”¨ï¼šå‡å°‘ç½‘ç»œè¯·æ±‚æå‡æ€§èƒ½
âœ… çŸ­æœŸè®¿é—®ï¼šä»¤ç‰Œæœ‰æ•ˆæœŸè¾ƒçŸ­ï¼ˆ1-2å°æ—¶ï¼‰

ç¤ºä¾‹åœºæ™¯ï¼š
ç”¨æˆ·ç™»å½•åï¼Œå‰ç«¯æ¯æ¬¡è°ƒç”¨APIéƒ½æºå¸¦JWT
å„ä¸ªå¾®æœåŠ¡å¯ä»¥ç›´æ¥éªŒè¯JWTï¼Œæ— éœ€è°ƒç”¨ç”¨æˆ·æœåŠ¡
```

**ğŸ¯ Opaque Tokené€‚ç”¨åœºæ™¯**
```
âœ… é«˜å®‰å…¨è¦æ±‚ï¼šä¸èƒ½æš´éœ²ä»»ä½•ç”¨æˆ·ä¿¡æ¯
âœ… é•¿æœŸä¼šè¯ï¼šéœ€è¦çµæ´»çš„ä¼šè¯ç®¡ç†
âœ… å®æ—¶æ’¤é”€ï¼šéœ€è¦ç«‹å³æ’¤é”€ç”¨æˆ·è®¿é—®æƒé™
âœ… å¤æ‚æƒé™ï¼šæƒé™ä¿¡æ¯ç»å¸¸å˜åŒ–
âœ… å®¡è®¡è¦æ±‚ï¼šéœ€è¦è¯¦ç»†çš„è®¿é—®æ—¥å¿—

ç¤ºä¾‹åœºæ™¯ï¼š
ä¼ä¸šå†…éƒ¨ç³»ç»Ÿï¼Œç”¨æˆ·æƒé™ç»å¸¸è°ƒæ•´
é‡‘èç³»ç»Ÿï¼Œéœ€è¦å®æ—¶æ’¤é”€å¯ç–‘ç”¨æˆ·çš„è®¿é—®æƒé™
```

---

## 2. ğŸ—ï¸ JWTç»“æ„ä¸ç­¾åç®—æ³•


### 2.1 JWTä¸‰éƒ¨åˆ†ç»“æ„è¯¦è§£


**ğŸ“‹ JWTç»“æ„ç»„æˆ**
```
å®Œæ•´JWT = Header.Payload.Signature

JWTç¤ºä¾‹ï¼š
eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9  â† Headerï¼ˆå¤´éƒ¨ï¼‰
.
eyJ1c2VyX2lkIjoxMjM0LCJuYW1lIjoiZGF2aWQiLCJleHAiOjE2MDA1NTUyMDB9  â† Payloadï¼ˆè½½è·ï¼‰
.
signature_here  â† Signatureï¼ˆç­¾åï¼‰
```

**ğŸ”¸ Headerï¼ˆå¤´éƒ¨ï¼‰**
```json
{
  "typ": "JWT",        // ä»¤ç‰Œç±»å‹
  "alg": "RS256",      // ç­¾åç®—æ³•
  "kid": "key-123"     // å¯†é’¥IDï¼ˆç”¨äºå¯†é’¥è½®æ¢ï¼‰
}
```

**ğŸ”¸ Payloadï¼ˆè½½è·ï¼‰**
```json
{
  // æ ‡å‡†å£°æ˜
  "iss": "auth-server",      // å‘è¡Œè€…ï¼ˆè°å‘çš„ä»¤ç‰Œï¼‰
  "sub": "user123",          // ä¸»é¢˜ï¼ˆä»¤ç‰Œæ˜¯å…³äºè°çš„ï¼‰
  "aud": "api-service",      // å—ä¼—ï¼ˆä»¤ç‰Œç»™è°ç”¨çš„ï¼‰
  "exp": 1600555200,         // è¿‡æœŸæ—¶é—´
  "iat": 1600551600,         // ç­¾å‘æ—¶é—´
  "jti": "token-uuid-123",   // ä»¤ç‰ŒIDï¼ˆç”¨äºæ’¤é”€ï¼‰
  
  // è‡ªå®šä¹‰å£°æ˜
  "user_id": 1234,
  "username": "david",
  "roles": ["user", "admin"]
}
```

**ğŸ”¸ Signatureï¼ˆç­¾åï¼‰**
```javascript
// ç­¾åç”Ÿæˆè¿‡ç¨‹
const header = base64url(JSON.stringify(headerObj));
const payload = base64url(JSON.stringify(payloadObj));
const signature = sign(header + "." + payload, privateKey, algorithm);
```

### 2.2 ä¸»è¦ç­¾åç®—æ³•å¯¹æ¯”


**ğŸ¯ å¯¹ç§°åŠ å¯†ç®—æ³•ï¼ˆHS256ï¼‰**
```
ä¼˜ç‚¹ï¼š
âœ… è®¡ç®—é€Ÿåº¦å¿«
âœ… å®ç°ç®€å•

ç¼ºç‚¹ï¼š
âŒ æ‰€æœ‰æœåŠ¡éƒ½éœ€è¦å…±äº«å¯†é’¥ï¼ˆå®‰å…¨é£é™©ï¼‰
âŒ å¯†é’¥æ³„éœ²å½±å“æ•´ä¸ªç³»ç»Ÿ

é€‚ç”¨ï¼šå•ä½“åº”ç”¨æˆ–é«˜åº¦å¯ä¿¡çš„å†…éƒ¨ç³»ç»Ÿ
```

**ğŸ¯ éå¯¹ç§°åŠ å¯†ç®—æ³•ï¼ˆRS256ï¼‰**
```
ä¼˜ç‚¹ï¼š
âœ… ç§é’¥åªåœ¨è®¤è¯æœåŠ¡ï¼Œå…¶ä»–æœåŠ¡åªéœ€å…¬é’¥
âœ… å³ä½¿å…¬é’¥æ³„éœ²ä¹Ÿä¸èƒ½ä¼ªé€ ä»¤ç‰Œ
âœ… é€‚åˆå¾®æœåŠ¡æ¶æ„

ç¼ºç‚¹ï¼š
âŒ è®¡ç®—é€Ÿåº¦ç›¸å¯¹è¾ƒæ…¢
âŒ å®ç°å¤æ‚ä¸€äº›

é€‚ç”¨ï¼šå¾®æœåŠ¡æ¶æ„ï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿ
```

**ğŸ¯ æ¤­åœ†æ›²çº¿ç®—æ³•ï¼ˆES256ï¼‰**
```
ä¼˜ç‚¹ï¼š
âœ… å®‰å…¨æ€§é«˜ï¼Œç›¸åŒå®‰å…¨çº§åˆ«ä¸‹å¯†é’¥é•¿åº¦æ›´çŸ­
âœ… è®¡ç®—æ•ˆç‡æ¯”RS256é«˜
âœ… ç§»åŠ¨è®¾å¤‡å‹å¥½

ç¼ºç‚¹ï¼š
âŒ ç›¸å¯¹è¾ƒæ–°ï¼Œå…¼å®¹æ€§éœ€è¦è€ƒè™‘

é€‚ç”¨ï¼šæ–°é¡¹ç›®ï¼Œç§»åŠ¨åº”ç”¨ï¼ŒIoTè®¾å¤‡
```

### 2.3 ç®—æ³•é€‰æ‹©å®è·µå»ºè®®


```
ğŸ¢ ä¼ä¸šå†…éƒ¨ç³»ç»Ÿï¼ˆé«˜ä¿¡ä»»ï¼‰ï¼š
æ¨èï¼šHS256
åŸå› ï¼šæ€§èƒ½å¥½ï¼Œç®¡ç†ç®€å•

ğŸŒ å¾®æœåŠ¡æ¶æ„ï¼š
æ¨èï¼šRS256
åŸå› ï¼šå¯†é’¥ç®¡ç†å®‰å…¨ï¼Œå„æœåŠ¡ç‹¬ç«‹éªŒè¯

ğŸ“± ç§»åŠ¨åº”ç”¨ï¼š
æ¨èï¼šES256
åŸå› ï¼šæ€§èƒ½å¥½ï¼Œå®‰å…¨æ€§é«˜

ğŸ’¡ å®é™…é€‰æ‹©è€ƒè™‘å› ç´ ï¼š
- ç³»ç»Ÿæ¶æ„ï¼ˆå•ä½“/å¾®æœåŠ¡ï¼‰
- å®‰å…¨è¦æ±‚çº§åˆ«
- æ€§èƒ½è¦æ±‚
- å›¢é˜ŸæŠ€æœ¯æ ˆç†Ÿæ‚‰åº¦
```

---

## 3. ğŸ”‘ JWKSä¸å¯†é’¥ç®¡ç†


### 3.1 JWKSåŸºæœ¬æ¦‚å¿µ


**ğŸ¯ ä»€ä¹ˆæ˜¯JWKSï¼Ÿ**
JWKSï¼ˆJSON Web Key Setï¼‰å°±åƒä¸€ä¸ª**å…¬é’¥ä»“åº“**ï¼Œå„ä¸ªæœåŠ¡å¯ä»¥ä»è¿™é‡Œè·å–éªŒè¯JWTæ‰€éœ€çš„å…¬é’¥ä¿¡æ¯ã€‚

```json
// JWKSç«¯ç‚¹è¿”å›çš„å¯†é’¥é›†åˆ
{
  "keys": [
    {
      "kid": "key-2024-01",     // å¯†é’¥IDï¼ˆé‡è¦ï¼ç”¨äºæ‰¾å¯¹åº”çš„å¯†é’¥ï¼‰
      "kty": "RSA",             // å¯†é’¥ç±»å‹
      "use": "sig",             // ç”¨é€”ï¼šç­¾å
      "alg": "RS256",           // ç®—æ³•
      "n": "...",               // RSAå…¬é’¥çš„nå€¼
      "e": "AQAB"               // RSAå…¬é’¥çš„eå€¼
    },
    {
      "kid": "key-2024-02",     // å¦ä¸€ä¸ªå¯†é’¥ï¼ˆæ”¯æŒå¯†é’¥è½®æ¢ï¼‰
      "kty": "RSA",
      "use": "sig",
      "alg": "RS256",
      "n": "...",
      "e": "AQAB"
    }
  ]
}
```

### 3.2 kidï¼ˆKey IDï¼‰çš„é‡è¦ä½œç”¨


**ğŸ”¸ kidçš„æ ¸å¿ƒä½œç”¨**
```
é—®é¢˜ï¼šå¦‚ä½•çŸ¥é“ç”¨å“ªä¸ªå¯†é’¥éªŒè¯JWTï¼Ÿ
è§£å†³ï¼šJWT Headerä¸­çš„kidå­—æ®µæŒ‡å®šä½¿ç”¨å“ªä¸ªå¯†é’¥

JWT Headerç¤ºä¾‹ï¼š
{
  "typ": "JWT",
  "alg": "RS256",
  "kid": "key-2024-01"  â† å‘Šè¯‰éªŒè¯è€…ä½¿ç”¨key-2024-01è¿™ä¸ªå¯†é’¥
}

éªŒè¯æµç¨‹ï¼š
1. è§£æJWT Headerï¼Œè·å–kidå€¼
2. ä»JWKSä¸­æ‰¾åˆ°å¯¹åº”kidçš„å…¬é’¥
3. ä½¿ç”¨è¯¥å…¬é’¥éªŒè¯JWTç­¾å
```

### 3.3 å¯†é’¥è½®æ¢ç­–ç•¥


**ğŸ”„ ä¸ºä»€ä¹ˆéœ€è¦å¯†é’¥è½®æ¢ï¼Ÿ**
```
å®‰å…¨è€ƒè™‘ï¼š
- å®šæœŸæ›´æ¢å¯†é’¥é™ä½è¢«ç ´è§£é£é™©
- å‘˜å·¥ç¦»èŒæ—¶éœ€è¦æ›´æ¢å¯†é’¥
- å¯†é’¥æ³„éœ²æ—¶ç´§æ€¥æ›¿æ¢

è¿ç»´è€ƒè™‘ï¼š
- å¹³æ»‘è¿‡æ¸¡ï¼Œä¸å½±å“ç°æœ‰ç”¨æˆ·
- æ”¯æŒå¤šä¸ªå¯†é’¥å¹¶å­˜
```

**ğŸ¯ å¯†é’¥è½®æ¢å®æ–½æ­¥éª¤**
```
æ­¥éª¤1ï¼šç”Ÿæˆæ–°å¯†é’¥
- åˆ›å»ºæ–°çš„å¯†é’¥å¯¹
- åˆ†é…æ–°çš„kidï¼ˆå¦‚ï¼škey-2024-02ï¼‰
- æ·»åŠ åˆ°JWKSä¸­

æ­¥éª¤2ï¼šå¹¶è¡ŒæœŸï¼ˆé‡è¦ï¼ï¼‰
- æ–°æ—§å¯†é’¥åŒæ—¶å­˜åœ¨JWKSä¸­
- æ–°ä»¤ç‰Œä½¿ç”¨æ–°å¯†é’¥ç­¾å
- æ—§ä»¤ç‰Œä»å¯ç”¨æ—§å¯†é’¥éªŒè¯

æ­¥éª¤3ï¼šåˆ‡æ¢æœŸ
- è®¤è¯æœåŠ¡å¼€å§‹ä½¿ç”¨æ–°å¯†é’¥ç­¾åæ–°ä»¤ç‰Œ
- æ‰€æœ‰æœåŠ¡æ›´æ–°JWKSç¼“å­˜

æ­¥éª¤4ï¼šæ¸…ç†æœŸ
- ç­‰å¾…æ‰€æœ‰æ—§ä»¤ç‰Œè¿‡æœŸ
- ä»JWKSä¸­ç§»é™¤æ—§å¯†é’¥

æ—¶é—´è§„åˆ’ç¤ºä¾‹ï¼š
Day 1: æ·»åŠ æ–°å¯†é’¥åˆ°JWKS
Day 2: å¼€å§‹ç”¨æ–°å¯†é’¥ç­¾å
Day 30: æ—§ä»¤ç‰Œè¿‡æœŸååˆ é™¤æ—§å¯†é’¥
```

### 3.4 JWKSç¼“å­˜ç­–ç•¥


**âš¡ ç¼“å­˜çš„å¿…è¦æ€§**
```
é—®é¢˜ï¼šæ¯æ¬¡éªŒè¯JWTéƒ½è°ƒç”¨JWKSç«¯ç‚¹ï¼Ÿ
â†’ ç½‘ç»œå¼€é”€å¤§ï¼Œæ€§èƒ½å·®ï¼Œå¯ç”¨æ€§é£é™©

è§£å†³ï¼šæœ¬åœ°ç¼“å­˜JWKS
â†’ å®šæœŸåˆ·æ–°ï¼Œå¼‚å¸¸æ—¶é™çº§
```

**ğŸ¯ ç¼“å­˜å®ç°ç­–ç•¥**
```javascript
// ç®€åŒ–çš„JWKSç¼“å­˜é€»è¾‘
class JWKSCache {
  constructor() {
    this.keys = new Map();
    this.cacheExpire = Date.now() + 3600000; // 1å°æ—¶
  }
  
  async getKey(kid) {
    // æ£€æŸ¥ç¼“å­˜æ˜¯å¦è¿‡æœŸ
    if (Date.now() > this.cacheExpire) {
      await this.refreshKeys();
    }
    
    // æ£€æŸ¥æ˜¯å¦æœ‰å¯¹åº”çš„å¯†é’¥
    if (!this.keys.has(kid)) {
      await this.refreshKeys(); // ç«‹å³åˆ·æ–°
    }
    
    return this.keys.get(kid);
  }
  
  async refreshKeys() {
    try {
      const jwks = await fetch('https://auth.example.com/.well-known/jwks.json');
      const data = await jwks.json();
      
      // æ›´æ–°ç¼“å­˜
      this.keys.clear();
      data.keys.forEach(key => {
        this.keys.set(key.kid, key);
      });
      
      this.cacheExpire = Date.now() + 3600000;
    } catch (error) {
      console.error('åˆ·æ–°JWKSå¤±è´¥ï¼Œä½¿ç”¨ç¼“å­˜çš„å¯†é’¥');
    }
  }
}
```

---

## 4. ğŸš« ä»¤ç‰ŒåŠé”€ä¸é»‘åå•ç­–ç•¥


### 4.1 JWTåŠé”€é¢ä¸´çš„æŒ‘æˆ˜


**ğŸ¯ JWTçš„"æ— çŠ¶æ€"éš¾é¢˜**
```
ä¼ ç»ŸSessionï¼š
æœåŠ¡ç«¯åˆ é™¤sessionè®°å½• â†’ ç«‹å³å¤±æ•ˆ âœ…

JWTå›°å¢ƒï¼š
JWTæ˜¯è‡ªåŒ…å«çš„ï¼ŒæœåŠ¡ç«¯ä¸ä¿å­˜çŠ¶æ€
å³ä½¿ç”¨æˆ·é€€å‡ºç™»å½•ï¼ŒJWTåœ¨è¿‡æœŸå‰ä»ç„¶æœ‰æ•ˆ âŒ

çœŸå®åœºæ™¯ï¼š
ç”¨æˆ·åœ¨å’–å•¡åº—ç™»å½•ï¼Œå¿˜è®°é€€å‡ºå°±ç¦»å¼€
â†’ å…¶ä»–äººå¯èƒ½ä½¿ç”¨è¯¥è®¾å¤‡ç»§ç»­è®¿é—®ç³»ç»Ÿ
```

### 4.2 jtiï¼ˆJWT IDï¼‰æœºåˆ¶


**ğŸ”¸ jtiçš„ä½œç”¨**
```json
// JWT Payloadä¸­çš„jtiå­—æ®µ
{
  "iss": "auth-server",
  "sub": "user123",
  "exp": 1600555200,
  "jti": "jwt-abc123def456",  // æ¯ä¸ªJWTçš„å”¯ä¸€æ ‡è¯†
  "user_id": 1234
}
```

**ğŸ¯ åŸºäºjtiçš„åŠé”€æœºåˆ¶**
```javascript
// é»‘åå•ç®¡ç†
class TokenBlacklist {
  constructor() {
    this.blacklistedTokens = new Set();
  }
  
  // åŠé”€ä»¤ç‰Œ
  revokeToken(jti, exp) {
    this.blacklistedTokens.add(jti);
    
    // è®¾ç½®è‡ªåŠ¨æ¸…ç†ï¼ˆä»¤ç‰Œè¿‡æœŸåä»é»‘åå•ç§»é™¤ï¼‰
    setTimeout(() => {
      this.blacklistedTokens.delete(jti);
    }, (exp * 1000) - Date.now());
  }
  
  // æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦è¢«åŠé”€
  isRevoked(jti) {
    return this.blacklistedTokens.has(jti);
  }
}

// éªŒè¯JWTæ—¶çš„æ£€æŸ¥
function validateJWT(token) {
  const decoded = jwt.decode(token);
  
  // 1. éªŒè¯ç­¾åå’Œè¿‡æœŸæ—¶é—´
  if (!jwt.verify(token, publicKey)) {
    throw new Error('Invalid token');
  }
  
  // 2. æ£€æŸ¥æ˜¯å¦åœ¨é»‘åå•ä¸­
  if (blacklist.isRevoked(decoded.jti)) {
    throw new Error('Token has been revoked');
  }
  
  return decoded;
}
```

### 4.3 ä¼šè¯çŠ¶æ€è¡¨ç­–ç•¥


**ğŸ¯ ä»€ä¹ˆæ˜¯ä¼šè¯çŠ¶æ€è¡¨ï¼Ÿ**
ä¼šè¯çŠ¶æ€è¡¨å°±åƒä¸€ä¸ª**"ç™½åå•"**ï¼Œåªè®°å½•æœ‰æ•ˆçš„ä¼šè¯ï¼Œè€Œä¸æ˜¯è®°å½•æ‰€æœ‰è¢«åŠé”€çš„ä»¤ç‰Œã€‚

```javascript
// ä¼šè¯çŠ¶æ€ç®¡ç†
class SessionManager {
  constructor() {
    this.activeSessions = new Map(); // æœ‰æ•ˆä¼šè¯è¡¨
  }
  
  // åˆ›å»ºä¼šè¯ï¼ˆç™»å½•æ—¶ï¼‰
  createSession(userId, jti, expiresAt) {
    this.activeSessions.set(jti, {
      userId,
      createdAt: Date.now(),
      expiresAt,
      lastActivity: Date.now()
    });
  }
  
  // éªŒè¯ä¼šè¯
  validateSession(jti) {
    const session = this.activeSessions.get(jti);
    
    if (!session) {
      return false; // ä¼šè¯ä¸å­˜åœ¨æˆ–å·²è¢«åŠé”€
    }
    
    if (Date.now() > session.expiresAt) {
      this.activeSessions.delete(jti); // æ¸…ç†è¿‡æœŸä¼šè¯
      return false;
    }
    
    // æ›´æ–°æœ€åæ´»åŠ¨æ—¶é—´
    session.lastActivity = Date.now();
    return true;
  }
  
  // åŠé”€ä¼šè¯ï¼ˆé€€å‡ºç™»å½•ï¼‰
  revokeSession(jti) {
    this.activeSessions.delete(jti);
  }
  
  // åŠé”€ç”¨æˆ·çš„æ‰€æœ‰ä¼šè¯
  revokeAllUserSessions(userId) {
    for (const [jti, session] of this.activeSessions) {
      if (session.userId === userId) {
        this.activeSessions.delete(jti);
      }
    }
  }
}
```

### 4.4 çŸ­æœ‰æ•ˆæœŸ+åˆ·æ–°ä»¤ç‰Œç»„åˆ


**ğŸ¯ æœ€ä½³å®è·µï¼šåŒä»¤ç‰Œç­–ç•¥**
```
è®¿é—®ä»¤ç‰Œï¼ˆAccess Tokenï¼‰ï¼š
- æœ‰æ•ˆæœŸçŸ­ï¼ˆ15-30åˆ†é’Ÿï¼‰
- ç”¨äºAPIè°ƒç”¨
- è¢«ç›—ç”¨å½±å“æ—¶é—´çŸ­

åˆ·æ–°ä»¤ç‰Œï¼ˆRefresh Tokenï¼‰ï¼š
- æœ‰æ•ˆæœŸé•¿ï¼ˆ7-30å¤©ï¼‰
- ä»…ç”¨äºè·å–æ–°çš„è®¿é—®ä»¤ç‰Œ
- ä½¿ç”¨é¢‘ç‡ä½ï¼Œç›¸å¯¹å®‰å…¨

ä¼˜åŠ¿ï¼š
âœ… è®¿é—®ä»¤ç‰Œè¿‡æœŸå¿«ï¼Œå³ä½¿æ³„éœ²å½±å“æœ‰é™
âœ… åˆ·æ–°ä»¤ç‰Œå¯ä»¥è¢«ç«‹å³åŠé”€
âœ… ç”¨æˆ·ä½“éªŒå¥½ï¼Œæ— éœ€é¢‘ç¹ç™»å½•
```

**ğŸ”„ åˆ·æ–°æµç¨‹å®ç°**
```javascript
// ä»¤ç‰Œåˆ·æ–°é€»è¾‘
class TokenService {
  // åˆ·æ–°è®¿é—®ä»¤ç‰Œ
  async refreshAccessToken(refreshToken) {
    // 1. éªŒè¯åˆ·æ–°ä»¤ç‰Œ
    const decoded = jwt.verify(refreshToken, publicKey);
    
    // 2. æ£€æŸ¥åˆ·æ–°ä»¤ç‰Œæ˜¯å¦åœ¨é»‘åå•ä¸­
    if (await this.isRefreshTokenRevoked(decoded.jti)) {
      throw new Error('Refresh token revoked');
    }
    
    // 3. æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
    const user = await this.getUserById(decoded.sub);
    if (!user || !user.active) {
      throw new Error('User inactive');
    }
    
    // 4. ç”Ÿæˆæ–°çš„è®¿é—®ä»¤ç‰Œ
    const newAccessToken = jwt.sign({
      sub: user.id,
      name: user.name,
      roles: user.roles,
      exp: Math.floor(Date.now() / 1000) + 1800, // 30åˆ†é’Ÿ
      jti: generateUUID()
    }, privateKey, { algorithm: 'RS256' });
    
    // 5. å¯é€‰ï¼šè½®æ¢åˆ·æ–°ä»¤ç‰Œï¼ˆæ›´å®‰å…¨ï¼‰
    const newRefreshToken = await this.rotateRefreshToken(decoded.jti);
    
    return {
      access_token: newAccessToken,
      refresh_token: newRefreshToken,
      expires_in: 1800
    };
  }
}
```

---

## 5. ğŸ” Introspectionç«¯ç‚¹æœºåˆ¶


### 5.1 ä»€ä¹ˆæ˜¯Token Introspectionï¼Ÿ


**ğŸ¯ IntrospectionåŸºæœ¬æ¦‚å¿µ**
Token Introspectionå°±åƒ**"éªŒè¯ä¸­å¿ƒ"**ï¼Œå½“æœåŠ¡ä¸ç¡®å®šä»¤ç‰Œçš„çŠ¶æ€æ—¶ï¼Œå¯ä»¥é—®è¿™ä¸ªä¸­å¿ƒï¼š"è¿™ä¸ªä»¤ç‰Œè¿˜æœ‰æ•ˆå—ï¼Ÿ"

```
æ ‡å‡†æµç¨‹ï¼š
1. å®¢æˆ·ç«¯å‘é€ä»¤ç‰Œç»™APIæœåŠ¡
2. APIæœåŠ¡è°ƒç”¨introspectionç«¯ç‚¹éªŒè¯ä»¤ç‰Œ
3. è®¤è¯æœåŠ¡è¿”å›ä»¤ç‰Œçš„è¯¦ç»†çŠ¶æ€
4. APIæœåŠ¡æ ¹æ®çŠ¶æ€å†³å®šæ˜¯å¦å…è®¸è®¿é—®

RFC 7662å®šä¹‰çš„æ ‡å‡†ç«¯ç‚¹ï¼š
POST /oauth/introspect
```

### 5.2 ä½•æ—¶éœ€è¦Introspectionï¼Ÿ


**ğŸ¯ ä½¿ç”¨Opaque Tokençš„åœºæ™¯**
```
åœºæ™¯ï¼šå¾®æœåŠ¡æ”¶åˆ°ä¸€ä¸ªOpaque Token
é—®é¢˜ï¼šæ— æ³•ç›´æ¥çŸ¥é“ä»¤ç‰Œå†…å®¹å’ŒçŠ¶æ€
è§£å†³ï¼šè°ƒç”¨introspectionç«¯ç‚¹è·å–è¯¦ç»†ä¿¡æ¯

ç¤ºä¾‹è¯·æ±‚ï¼š
POST /oauth/introspect
Content-Type: application/x-www-form-urlencoded

token=a8f5c9d7e2b4a1c6f8e3d9b2a5c7f1e4&
token_type_hint=access_token

ç¤ºä¾‹å“åº”ï¼š
{
  "active": true,
  "client_id": "my-app",
  "username": "david",
  "scope": "read write",
  "exp": 1600555200,
  "sub": "user123"
}
```

**ğŸ¯ JWTéœ€è¦å®æ—¶çŠ¶æ€æ£€æŸ¥çš„åœºæ™¯**
```
è™½ç„¶JWTæ˜¯è‡ªåŒ…å«çš„ï¼Œä½†ä»¥ä¸‹æƒ…å†µéœ€è¦introspectionï¼š

âœ… é«˜å®‰å…¨åœºæ™¯ï¼š
- é‡‘èäº¤æ˜“å‰æœ€ç»ˆç¡®è®¤
- æ•æ„Ÿæ“ä½œæƒé™éªŒè¯

âœ… å®æ—¶çŠ¶æ€å˜åŒ–ï¼š
- ç”¨æˆ·è¢«ä¸´æ—¶ç¦ç”¨
- æƒé™å®æ—¶è°ƒæ•´
- ç´§æ€¥æ’¤é”€è®¿é—®

âœ… å®¡è®¡è¦æ±‚ï¼š
- éœ€è¦è®°å½•æ¯æ¬¡è®¿é—®
- è¯¦ç»†çš„æ—¥å¿—è¿½è¸ª
```

### 5.3 Introspectionå®ç°ç¤ºä¾‹


```javascript
// Introspectionç«¯ç‚¹å®ç°
class IntrospectionService {
  async introspectToken(token, tokenType) {
    try {
      let tokenInfo;
      
      if (tokenType === 'access_token' || this.looksLikeJWT(token)) {
        tokenInfo = await this.introspectJWT(token);
      } else {
        tokenInfo = await this.introspectOpaqueToken(token);
      }
      
      return tokenInfo;
    } catch (error) {
      return { active: false };
    }
  }
  
  async introspectJWT(jwt) {
    // 1. éªŒè¯JWTç­¾å
    const decoded = jwt.verify(jwt, publicKey);
    
    // 2. æ£€æŸ¥æ˜¯å¦åœ¨é»‘åå•
    if (await this.isTokenRevoked(decoded.jti)) {
      return { active: false };
    }
    
    // 3. æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
    const user = await this.getUserById(decoded.sub);
    if (!user || !user.active) {
      return { active: false };
    }
    
    // 4. è¿”å›ä»¤ç‰Œä¿¡æ¯
    return {
      active: true,
      sub: decoded.sub,
      username: user.username,
      client_id: decoded.aud,
      scope: decoded.scope,
      exp: decoded.exp
    };
  }
  
  async introspectOpaqueToken(token) {
    // ä»æ•°æ®åº“æŸ¥è¯¢ä»¤ç‰Œä¿¡æ¯
    const session = await this.getSessionByToken(token);
    
    if (!session || Date.now() > session.expiresAt) {
      return { active: false };
    }
    
    return {
      active: true,
      sub: session.userId,
      username: session.username,
      client_id: session.clientId,
      scope: session.scope,
      exp: Math.floor(session.expiresAt / 1000)
    };
  }
}
```

### 5.4 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


**âš¡ ç¼“å­˜ç­–ç•¥**
```javascript
// å¸¦ç¼“å­˜çš„introspection
class CachedIntrospectionService extends IntrospectionService {
  constructor() {
    super();
    this.cache = new Map();
    this.cacheTimeout = 300000; // 5åˆ†é’Ÿç¼“å­˜
  }
  
  async introspectToken(token, tokenType) {
    const cacheKey = `introspect:${token}`;
    const cached = this.cache.get(cacheKey);
    
    // ä½¿ç”¨ç¼“å­˜ç»“æœ
    if (cached && Date.now() < cached.expiry) {
      return cached.result;
    }
    
    // è°ƒç”¨çˆ¶ç±»æ–¹æ³•è·å–ç»“æœ
    const result = await super.introspectToken(token, tokenType);
    
    // åªç¼“å­˜æœ‰æ•ˆä»¤ç‰Œï¼Œé¿å…ç¼“å­˜æ”»å‡»
    if (result.active) {
      this.cache.set(cacheKey, {
        result,
        expiry: Date.now() + this.cacheTimeout
      });
    }
    
    return result;
  }
}
```

---

## 6. ğŸ“ ä»¤ç‰Œå°ºå¯¸ä¸ç½‘å…³é™åˆ¶


### 6.1 JWTå°ºå¯¸é—®é¢˜åˆ†æ


**ğŸ¯ JWTå°ºå¯¸æ„æˆ**
```
å…¸å‹JWTå°ºå¯¸åˆ†æï¼š

åŸºç¡€JWTï¼ˆæœ€å°ä¿¡æ¯ï¼‰ï¼š~200å­—èŠ‚
{
  "sub": "user123",
  "exp": 1600555200,
  "iat": 1600551600
}

æ ‡å‡†ä¼ä¸šçº§JWTï¼š~800å­—èŠ‚
{
  "sub": "user123",
  "name": "David Wang",
  "email": "david@company.com",
  "roles": ["user", "manager"],
  "permissions": ["read:users", "write:reports"],
  "department": "engineering",
  "exp": 1600555200,
  "iat": 1600551600,
  "iss": "https://auth.company.com",
  "aud": ["api-gateway", "user-service"]
}

æƒé™ä¸°å¯Œçš„JWTï¼š~2KB+
åŒ…å«è¯¦ç»†çš„æƒé™åˆ—è¡¨ã€ç”¨æˆ·å±æ€§ç­‰
```

### 6.2 ç½‘å…³å’Œä»£ç†é™åˆ¶


**âš ï¸ å¸¸è§é™åˆ¶é—®é¢˜**
```
HTTP Headeré™åˆ¶ï¼š
- Apache: é»˜è®¤8KB
- Nginx: é»˜è®¤4KB-8KB
- CloudFlare: 16KB
- AWS ALB: 16KB

URLé•¿åº¦é™åˆ¶ï¼š
- IEæµè§ˆå™¨: 2048å­—ç¬¦
- Chrome: ~2MBï¼ˆå®é™…å»ºè®®<2000å­—ç¬¦ï¼‰
- Safari: 80000å­—ç¬¦

é—®é¢˜åœºæ™¯ï¼š
GET /api/users?access_token=very_long_jwt_token
â†’ URLè¿‡é•¿å¯¼è‡´è¯·æ±‚å¤±è´¥
```

### 6.3 ä»¤ç‰Œå°ºå¯¸ä¼˜åŒ–ç­–ç•¥


**ğŸ¯ å‡å°‘JWTè½½è·**
```javascript
// âŒ ä¸å¥½çš„åšæ³•ï¼šåŒ…å«è¿‡å¤šä¿¡æ¯
const badJWT = {
  sub: "user123",
  name: "David Wang",
  email: "david@company.com",
  avatar: "https://cdn.example.com/avatars/user123.jpg",
  profile: {
    bio: "Full stack developer with 5 years experience...",
    skills: ["JavaScript", "Python", "Docker", "K8s"],
    projects: [/*...å¤§é‡é¡¹ç›®æ•°æ®...*/]
  },
  permissions: [/*...100å¤šä¸ªæƒé™...*/],
  settings: {/*...ç”¨æˆ·è®¾ç½®...*/}
};

// âœ… å¥½çš„åšæ³•ï¼šåªåŒ…å«å¿…è¦ä¿¡æ¯
const goodJWT = {
  sub: "user123",           // ç”¨æˆ·IDï¼ˆå¿…éœ€ï¼‰
  role: "manager",          // ä¸»è¦è§’è‰²
  dept: "eng",             // éƒ¨é—¨ç¼©å†™
  exp: 1600555200,         // è¿‡æœŸæ—¶é—´
  scope: "read:api write:reports"  // æƒé™èŒƒå›´æ¦‚è¿°
};

// è¯¦ç»†ä¿¡æ¯é€šè¿‡APIè·å–
// GET /api/users/profile (using the JWT)
```

**ğŸ¯ ä½¿ç”¨æƒé™èŒƒå›´è€Œéå…·ä½“æƒé™**
```javascript
// âŒ è¯¦ç»†æƒé™åˆ—è¡¨ï¼ˆè¿‡å¤§ï¼‰
{
  "permissions": [
    "users:create",
    "users:read", 
    "users:update",
    "users:delete",
    "reports:create",
    "reports:read",
    "reports:update",
    "reports:delete",
    "analytics:read",
    "analytics:export"
    // ... æ›´å¤šæƒé™
  ]
}

// âœ… æƒé™èŒƒå›´ï¼ˆç´§å‡‘ï¼‰
{
  "scope": "users:* reports:* analytics:read"
}

// æˆ–ä½¿ç”¨è§’è‰²
{
  "role": "manager",
  "scope": "department:engineering"
}
```

### 6.4 æ›¿ä»£ä¼ è¾“æ–¹æ¡ˆ


**ğŸ”„ ä»¤ç‰Œå¼•ç”¨æ¨¡å¼**
```javascript
// å¤§å‹JWTçš„å¤„ç†æ–¹æ¡ˆ
class LargeTokenHandler {
  async createTokenReference(largeJWT) {
    // 1. ç”ŸæˆçŸ­å¼•ç”¨ID
    const tokenRef = generateShortId(); // å¦‚ï¼štk_abc123
    
    // 2. å­˜å‚¨å®Œæ•´ä»¤ç‰Œ
    await this.storeToken(tokenRef, largeJWT, 3600); // 1å°æ—¶TTL
    
    // 3. è¿”å›å¼•ç”¨ä»¤ç‰Œ
    return {
      token_type: "reference",
      access_token: tokenRef,
      expires_in: 3600
    };
  }
  
  async resolveTokenReference(tokenRef) {
    // æ ¹æ®å¼•ç”¨è·å–å®Œæ•´ä»¤ç‰Œ
    const fullToken = await this.retrieveToken(tokenRef);
    if (!fullToken) {
      throw new Error('Token reference expired or invalid');
    }
    
    return jwt.verify(fullToken, publicKey);
  }
}

// APIç½‘å…³ä½¿ç”¨
app.use(async (req, res, next) => {
  const token = req.headers.authorization?.replace('Bearer ', '');
  
  if (token?.startsWith('tk_')) {
    // ä»¤ç‰Œå¼•ç”¨ï¼Œéœ€è¦è§£æ
    req.user = await tokenHandler.resolveTokenReference(token);
  } else {
    // ç›´æ¥JWT
    req.user = jwt.verify(token, publicKey);
  }
  
  next();
});
```

---

## 7. ğŸ” å…¬é’¥éªŒè¯ä¸å¯†é’¥è½®æ¢


### 7.1 å…¬é’¥åˆ†å‘æœºåˆ¶


**ğŸ¯ å…¬é’¥åˆ†å‘çš„æŒ‘æˆ˜**
```
é—®é¢˜ï¼šå¦‚ä½•è®©æ‰€æœ‰å¾®æœåŠ¡å®‰å…¨åœ°è·å–åˆ°æ­£ç¡®çš„å…¬é’¥ï¼Ÿ

æ–¹æ¡ˆå¯¹æ¯”ï¼š
âŒ ç¡¬ç¼–ç å…¬é’¥ï¼šæ— æ³•è½®æ¢ï¼Œä¸å¤Ÿçµæ´»
âŒ é…ç½®æ–‡ä»¶ï¼šæ›´æ–°å›°éš¾ï¼Œå®¹æ˜“å‡ºé”™  
âœ… JWKSç«¯ç‚¹ï¼šåŠ¨æ€è·å–ï¼Œæ”¯æŒè½®æ¢
âœ… é…ç½®ä¸­å¿ƒï¼šé›†ä¸­ç®¡ç†ï¼Œç‰ˆæœ¬æ§åˆ¶
```

**ğŸ”„ JWKSç«¯ç‚¹å®ç°**
```javascript
// è®¤è¯æœåŠ¡æä¾›JWKSç«¯ç‚¹
class JWKSEndpoint {
  constructor() {
    this.keyPairs = new Map(); // å­˜å‚¨å¯†é’¥å¯¹
  }
  
  // ç”Ÿæˆæ–°å¯†é’¥å¯¹
  generateKeyPair(kid) {
    const { publicKey, privateKey } = crypto.generateKeyPairSync('rsa', {
      modulusLength: 2048,
      publicExponent: 65537
    });
    
    this.keyPairs.set(kid, { publicKey, privateKey });
    return { publicKey, privateKey };
  }
  
  // JWKSç«¯ç‚¹
  getJWKS() {
    const keys = [];
    
    for (const [kid, keyPair] of this.keyPairs) {
      const publicKeyJWK = this.rsaPublicKeyToJWK(keyPair.publicKey, kid);
      keys.push(publicKeyJWK);
    }
    
    return { keys };
  }
  
  // å°†RSAå…¬é’¥è½¬æ¢ä¸ºJWKæ ¼å¼
  rsaPublicKeyToJWK(publicKey, kid) {
    // æå–å…¬é’¥å‚æ•°
    const keyObject = crypto.createPublicKey(publicKey);
    const keyData = keyObject.export({ format: 'jwk' });
    
    return {
      kid,
      kty: 'RSA',
      use: 'sig',
      alg: 'RS256',
      n: keyData.n,
      e: keyData.e
    };
  }
}
```

### 7.2 æ¸è¿›å¼å¯†é’¥è½®æ¢


**ğŸ“… è½®æ¢æ—¶é—´è¡¨è§„åˆ’**
```
å¯†é’¥è½®æ¢å‘¨æœŸå»ºè®®ï¼š
ğŸ” ç”Ÿäº§ç¯å¢ƒï¼š3-6ä¸ªæœˆ
ğŸ”§ æµ‹è¯•ç¯å¢ƒï¼š1ä¸ªæœˆ  
ğŸš¨ ç´§æ€¥æƒ…å†µï¼šç«‹å³ï¼ˆå¦‚å¯†é’¥æ³„éœ²ï¼‰

è½®æ¢è®¡åˆ’ï¼š
ç¬¬1å‘¨ï¼šå‡†å¤‡æ–°å¯†é’¥ï¼Œæ·»åŠ åˆ°JWKS
ç¬¬2å‘¨ï¼šå¼€å§‹ä½¿ç”¨æ–°å¯†é’¥ç­¾åæ–°ä»¤ç‰Œ
ç¬¬8å‘¨ï¼šæ‰€æœ‰æ—§ä»¤ç‰Œè¿‡æœŸ
ç¬¬9å‘¨ï¼šä»JWKSç§»é™¤æ—§å¯†é’¥
```

**ğŸ”„ è‡ªåŠ¨åŒ–è½®æ¢å®ç°**
```javascript
class AutoKeyRotation {
  constructor() {
    this.jwksService = new JWKSEndpoint();
    this.rotationInterval = 90 * 24 * 60 * 60 * 1000; // 90å¤©
  }
  
  startAutoRotation() {
    // å®šæœŸè½®æ¢å¯†é’¥
    setInterval(() => {
      this.rotateKeys();
    }, this.rotationInterval);
  }
  
  async rotateKeys() {
    try {
      console.log('å¼€å§‹å¯†é’¥è½®æ¢...');
      
      // 1. ç”Ÿæˆæ–°å¯†é’¥
      const newKid = `key-${Date.now()}`;
      const newKeyPair = this.jwksService.generateKeyPair(newKid);
      
      // 2. é€šçŸ¥æ‰€æœ‰æœåŠ¡æ›´æ–°JWKSç¼“å­˜
      await this.notifyServicesAboutNewKey();
      
      // 3. ç­‰å¾…ç¼“å­˜æ›´æ–°å®Œæˆ
      await this.sleep(30000); // 30ç§’
      
      // 4. åˆ‡æ¢åˆ°æ–°å¯†é’¥è¿›è¡Œç­¾å
      this.currentSigningKey = newKid;
      
      console.log(`å¯†é’¥è½®æ¢å®Œæˆï¼Œæ–°å¯†é’¥ID: ${newKid}`);
      
      // 5. å®‰æ’æ¸…ç†æ—§å¯†é’¥ï¼ˆåœ¨æ‰€æœ‰æ—§ä»¤ç‰Œè¿‡æœŸåï¼‰
      this.scheduleOldKeyCleanup();
      
    } catch (error) {
      console.error('å¯†é’¥è½®æ¢å¤±è´¥:', error);
      // å‘é€å‘Šè­¦
      await this.sendRotationAlert(error);
    }
  }
  
  scheduleOldKeyCleanup() {
    // JWTè¿‡æœŸæ—¶é—´ + ç¼“å†²æ—¶é—´åæ¸…ç†æ—§å¯†é’¥
    const cleanupDelay = this.maxTokenLifetime + (24 * 60 * 60 * 1000); // +1å¤©ç¼“å†²
    
    setTimeout(() => {
      this.cleanupOldKeys();
    }, cleanupDelay);
  }
}
```

### 7.3 å¯†é’¥éªŒè¯æœ€ä½³å®è·µ


**âœ… éªŒè¯é“¾è·¯ä¼˜åŒ–**
```javascript
class OptimizedJWTValidator {
  constructor() {
    this.jwksCache = new Map();
    this.cacheExpiry = new Map();
  }
  
  async validateJWT(token) {
    try {
      // 1. è§£æHeaderè·å–kid
      const header = this.parseJWTHeader(token);
      if (!header.kid) {
        throw new Error('Missing kid in JWT header');
      }
      
      // 2. è·å–å¯¹åº”çš„å…¬é’¥
      const publicKey = await this.getPublicKey(header.kid);
      if (!publicKey) {
        throw new Error(`Public key not found for kid: ${header.kid}`);
      }
      
      // 3. éªŒè¯JWT
      const payload = jwt.verify(token, publicKey, {
        algorithms: [header.alg],
        clockTolerance: 30 // 30ç§’æ—¶é’Ÿåå·®å®¹å¿
      });
      
      return payload;
      
    } catch (error) {
      // è®°å½•éªŒè¯å¤±è´¥çš„è¯¦ç»†ä¿¡æ¯
      console.log('JWTéªŒè¯å¤±è´¥:', {
        error: error.message,
        kid: this.parseJWTHeader(token)?.kid,
        timestamp: new Date().toISOString()
      });
      throw error;
    }
  }
  
  async getPublicKey(kid) {
    // æ£€æŸ¥ç¼“å­˜
    if (this.jwksCache.has(kid)) {
      const expiry = this.cacheExpiry.get(kid);
      if (Date.now() < expiry) {
        return this.jwksCache.get(kid);
      }
    }
    
    // åˆ·æ–°JWKS
    await this.refreshJWKS();
    return this.jwksCache.get(kid);
  }
  
  async refreshJWKS() {
    try {
      const response = await fetch('https://auth.example.com/.well-known/jwks.json');
      const jwks = await response.json();
      
      // æ›´æ–°ç¼“å­˜
      jwks.keys.forEach(key => {
        const publicKey = this.jwkToPublicKey(key);
        this.jwksCache.set(key.kid, publicKey);
        this.cacheExpiry.set(key.kid, Date.now() + 3600000); // 1å°æ—¶
      });
      
    } catch (error) {
      console.error('åˆ·æ–°JWKSå¤±è´¥:', error);
      // ç»§ç»­ä½¿ç”¨ç¼“å­˜çš„å¯†é’¥ï¼Œé¿å…æœåŠ¡ä¸­æ–­
    }
  }
}
```

### 7.4 å¯†é’¥æ³„éœ²åº”æ€¥å“åº”


**ğŸš¨ ç´§æ€¥è½®æ¢æµç¨‹**
```javascript
class EmergencyKeyRotation {
  async emergencyRotation(compromisedKid, reason) {
    console.log(`ğŸš¨ ç´§æ€¥å¯†é’¥è½®æ¢: ${reason}`);
    
    // 1. ç«‹å³åœç”¨æ³„éœ²çš„å¯†é’¥
    await this.disableKey(compromisedKid);
    
    // 2. ç”Ÿæˆæ–°å¯†é’¥
    const newKid = `emergency-${Date.now()}`;
    const newKeyPair = await this.generateKeyPair(newKid);
    
    // 3. ç«‹å³æ›´æ–°JWKS
    await this.updateJWKS();
    
    // 4. å¼ºåˆ¶åˆ·æ–°æ‰€æœ‰æœåŠ¡çš„å¯†é’¥ç¼“å­˜
    await this.forceRefreshAllServices();
    
    // 5. æ’¤é”€æ‰€æœ‰ä½¿ç”¨æ—§å¯†é’¥çš„ä»¤ç‰Œ
    await this.revokeTokensByKey(compromisedKid);
    
    // 6. å‘é€å®‰å…¨é€šçŸ¥
    await this.sendSecurityAlert({
      type: 'KEY_COMPROMISE',
      compromisedKey: compromisedKid,
      newKey: newKid,
      timestamp: new Date().toISOString()
    });
    
    console.log(`âœ… ç´§æ€¥è½®æ¢å®Œæˆï¼Œæ–°å¯†é’¥: ${newKid}`);
  }
  
  async revokeTokensByKey(kid) {
    // å°†ä½¿ç”¨æŒ‡å®šå¯†é’¥ç­¾åçš„æ‰€æœ‰ä»¤ç‰ŒåŠ å…¥é»‘åå•
    const affectedTokens = await this.findTokensByKey(kid);
    
    for (const token of affectedTokens) {
      await this.blacklistToken(token.jti);
    }
    
    console.log(`æ’¤é”€äº†${affectedTokens.length}ä¸ªå—å½±å“çš„ä»¤ç‰Œ`);
  }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ ä»¤ç‰Œç±»å‹é€‰æ‹©ï¼šJWTé€‚åˆæ— çŠ¶æ€åœºæ™¯ï¼ŒOpaqueé€‚åˆé«˜å®‰å…¨åœºæ™¯
ğŸ”¸ JWTç»“æ„ï¼šHeaderæŒ‡å®šç®—æ³•å’Œå¯†é’¥IDï¼ŒPayloadåŒ…å«å£°æ˜ï¼ŒSignatureä¿è¯å®Œæ•´æ€§
ğŸ”¸ ç­¾åç®—æ³•ï¼šRS256é€‚åˆå¾®æœåŠ¡ï¼ŒHS256é€‚åˆå•ä½“ï¼ŒES256æ€§èƒ½æ›´å¥½
ğŸ”¸ JWKSæœºåˆ¶ï¼šå…¬é’¥åˆ†å‘çš„æ ‡å‡†æ–¹å¼ï¼Œæ”¯æŒå¯†é’¥è½®æ¢
ğŸ”¸ ä»¤ç‰ŒåŠé”€ï¼šé€šè¿‡jtié»‘åå•ã€ä¼šè¯è¡¨æˆ–åŒä»¤ç‰Œç­–ç•¥å®ç°
ğŸ”¸ Introspectionï¼šç”¨äºéªŒè¯Opaqueä»¤ç‰Œæˆ–å®æ—¶çŠ¶æ€æ£€æŸ¥
ğŸ”¸ å¯†é’¥è½®æ¢ï¼šå®šæœŸæ›´æ¢å¯†é’¥ï¼Œæ¸è¿›å¼éƒ¨ç½²é¿å…ä¸­æ–­
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ JWTçš„è®¾è®¡æƒè¡¡**
```
è‡ªåŒ…å« vs å®‰å…¨æ€§ï¼š
- è‡ªåŒ…å«æé«˜æ€§èƒ½ä½†ä¿¡æ¯å¯è§
- éœ€è¦åœ¨ä¾¿åˆ©æ€§å’Œå®‰å…¨æ€§é—´æ‰¾å¹³è¡¡

æ— çŠ¶æ€ vs å¯æ’¤é”€ï¼š
- æ— çŠ¶æ€å‡å°‘æœåŠ¡ç«¯å‹åŠ›
- å¯æ’¤é”€éœ€è¦é¢å¤–çš„çŠ¶æ€ç®¡ç†æœºåˆ¶
```

**ğŸ”¹ ä»¤ç‰Œç®¡ç†ç­–ç•¥é€‰æ‹©**
```
å°å‹åº”ç”¨ï¼š
- ä½¿ç”¨JWT + çŸ­æœ‰æ•ˆæœŸ
- ç®€å•çš„å¯†é’¥ç®¡ç†

å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿï¼š
- è€ƒè™‘Opaque + ç¼“å­˜
- å®Œå–„çš„JWKSåŸºç¡€è®¾æ–½
- è‡ªåŠ¨åŒ–å¯†é’¥è½®æ¢

é«˜å®‰å…¨åœºæ™¯ï¼š
- Opaqueä»¤ç‰Œ
- å®æ—¶introspection
- ä¸¥æ ¼çš„æ’¤é”€æœºåˆ¶
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ æŠ€æœ¯é€‰å‹å»ºè®®**
- **åˆåˆ›å…¬å¸**ï¼šJWT + RS256 + åŸºç¡€JWKS
- **ä¸­ç­‰è§„æ¨¡**ï¼šåŒä»¤ç‰Œç­–ç•¥ + è‡ªåŠ¨è½®æ¢  
- **å¤§å‹ä¼ä¸š**ï¼šOpaqueä»¤ç‰Œ + é›†ä¸­ç®¡ç†
- **é‡‘èçº§åˆ«**ï¼šå¼ºåˆ¶introspection + å®æ—¶æ’¤é”€

**ğŸ”§ å®æ–½ä¼˜å…ˆçº§**
1. **åŸºç¡€å®‰å…¨**ï¼šæ­£ç¡®çš„ç­¾åç®—æ³•å’Œå¯†é’¥ç®¡ç†
2. **å¯ç”¨æ€§**ï¼šJWKSç¼“å­˜å’Œé”™è¯¯å¤„ç†
3. **å¯æ’¤é”€æ€§**ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©æ’¤é”€ç­–ç•¥
4. **è¿ç»´è‡ªåŠ¨åŒ–**ï¼šè‡ªåŠ¨å¯†é’¥è½®æ¢å’Œç›‘æ§

**âš ï¸ å¸¸è§é™·é˜±é¿å…**
- ä¸è¦åœ¨JWTä¸­æ”¾ç½®æ•æ„Ÿä¿¡æ¯
- ä¸è¦å¿½è§†ä»¤ç‰Œå°ºå¯¸å¯¹æ€§èƒ½çš„å½±å“
- ä¸è¦å¿˜è®°å¯†é’¥è½®æ¢çš„å‘åå…¼å®¹
- ä¸è¦åœ¨å®¢æˆ·ç«¯å­˜å‚¨åˆ·æ–°ä»¤ç‰Œå¤ªä¹…

**æ ¸å¿ƒè®°å¿†**ï¼š
- JWTä¾¿åˆ©ä½†éœ€å°å¿ƒä¿¡æ¯æ³„éœ²
- å¯†é’¥ç®¡ç†æ˜¯å®‰å…¨çš„åŸºç¡€
- æ’¤é”€æœºåˆ¶è¦æ ¹æ®åœºæ™¯é€‰æ‹©
- æ€§èƒ½å’Œå®‰å…¨éœ€è¦å¹³è¡¡è€ƒè™‘