---
title: 5ã€è®¤è¯æœåŠ¡é«˜å¯ç”¨ä¸æ‰©å±•
---
## ğŸ“š ç›®å½•

1. [Tokenç»­ç­¾æœºåˆ¶è®¾è®¡](#1-Tokenç»­ç­¾æœºåˆ¶è®¾è®¡)
2. [å¤šèŠ‚ç‚¹è®¤è¯ä¸€è‡´æ€§](#2-å¤šèŠ‚ç‚¹è®¤è¯ä¸€è‡´æ€§)
3. [Redisè®¤è¯æ•°æ®ç®¡ç†](#3-Redisè®¤è¯æ•°æ®ç®¡ç†)
4. [å¤šç§Ÿæˆ·æƒé™éš”ç¦»](#4-å¤šç§Ÿæˆ·æƒé™éš”ç¦»)
5. [åˆ†å¸ƒå¼ä¼šè¯ç®¡ç†](#5-åˆ†å¸ƒå¼ä¼šè¯ç®¡ç†)
6. [Tokenä¸Sessioné€‰æ‹©ç­–ç•¥](#6-Tokenä¸Sessioné€‰æ‹©ç­–ç•¥)
7. [å•ç‚¹ç™»å½•SSOå®ç°](#7-å•ç‚¹ç™»å½•SSOå®ç°)
8. [è®¤è¯ç›‘æ§ä¸æ•…éšœæ’æŸ¥](#8-è®¤è¯ç›‘æ§ä¸æ•…éšœæ’æŸ¥)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”„ Tokenç»­ç­¾æœºåˆ¶è®¾è®¡


### 1.1 ä»€ä¹ˆæ˜¯Tokenç»­ç­¾


> ğŸ’¡ **ç®€å•ç†è§£**: Tokenç»­ç­¾å°±åƒç»™ä½ çš„é—¨å¡å»¶é•¿æœ‰æ•ˆæœŸï¼Œå¿«è¿‡æœŸæ—¶è‡ªåŠ¨åˆ·æ–°ï¼Œé¿å…é¢‘ç¹é‡æ–°ç™»å½•

**æ ¸å¿ƒæ¦‚å¿µ**:
- ğŸ« **Access Token**: çŸ­æœŸä»¤ç‰Œï¼Œç”¨äºå®é™…è®¿é—®èµ„æºï¼ˆé€šå¸¸15-30åˆ†é’Ÿï¼‰
- ğŸ”„ **Refresh Token**: é•¿æœŸä»¤ç‰Œï¼Œç”¨äºè·å–æ–°çš„Access Tokenï¼ˆé€šå¸¸7-30å¤©ï¼‰
- â° **è‡ªåŠ¨ç»­ç­¾**: åœ¨Tokenå³å°†è¿‡æœŸå‰è‡ªåŠ¨è·å–æ–°Token

```
ç”¨æˆ·ä½“éªŒå¯¹æ¯”ï¼š
æ²¡æœ‰ç»­ç­¾ï¼šç™»å½• â†’ 30åˆ†é’Ÿå â†’ é‡æ–°ç™»å½• â†’ 30åˆ†é’Ÿå â†’ é‡æ–°ç™»å½•...
æœ‰ç»­ç­¾æœºåˆ¶ï¼šç™»å½• â†’ è‡ªåŠ¨ç»­ç­¾ â†’ è‡ªåŠ¨ç»­ç­¾ â†’ 7å¤©åæ‰éœ€é‡æ–°ç™»å½•
```

### 1.2 ç»­ç­¾æœºåˆ¶å®ç°åŸç†


**åŒTokenæ¨¡å¼**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    çŸ­Token     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å®¢æˆ·ç«¯    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚  APIæœåŠ¡å™¨  â”‚
â”‚             â”‚                â”‚             â”‚
â”‚ AccessToken â”‚                â”‚   éªŒè¯æƒé™  â”‚
â”‚RefreshToken â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   é•¿Token      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  (ç»­ç­¾ç”¨)
```

**ç»­ç­¾æ—¶æœºç­–ç•¥**:
- ğŸ¯ **ä¸»åŠ¨ç»­ç­¾**: Tokenè¿‡æœŸå‰5åˆ†é’Ÿä¸»åŠ¨åˆ·æ–°
- ğŸ”„ **è¢«åŠ¨ç»­ç­¾**: APIè¿”å›401æ—¶å†ç»­ç­¾
- âš¡ **æ™ºèƒ½ç»­ç­¾**: æ ¹æ®ç”¨æˆ·æ´»è·ƒåº¦åŠ¨æ€è°ƒæ•´

### 1.3 ç»­ç­¾æœºåˆ¶ä»£ç å®ç°


**å‰ç«¯è‡ªåŠ¨ç»­ç­¾ç¤ºä¾‹**:
```javascript
class TokenManager {
    constructor() {
        this.accessToken = localStorage.getItem('accessToken');
        this.refreshToken = localStorage.getItem('refreshToken');
    }
    
    // æ£€æŸ¥Tokenæ˜¯å¦å³å°†è¿‡æœŸ
    isTokenExpiring(token) {
        const payload = JSON.parse(atob(token.split('.')[1]));
        const expTime = payload.exp * 1000;
        const currentTime = Date.now();
        // æå‰5åˆ†é’Ÿç»­ç­¾
        return (expTime - currentTime) < 5 * 60 * 1000;
    }
    
    // è‡ªåŠ¨ç»­ç­¾Token
    async autoRefresh() {
        if (this.isTokenExpiring(this.accessToken)) {
            try {
                const response = await fetch('/auth/refresh', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${this.refreshToken}` }
                });
                
                const { accessToken, refreshToken } = await response.json();
                this.updateTokens(accessToken, refreshToken);
                
            } catch (error) {
                // ç»­ç­¾å¤±è´¥ï¼Œè·³è½¬ç™»å½•é¡µ
                this.redirectToLogin();
            }
        }
    }
}
```

**åç«¯ç»­ç­¾æ¥å£ç¤ºä¾‹**:
```java
@RestController
public class AuthController {
    
    @PostMapping("/auth/refresh")
    public ResponseEntity<?> refreshToken(@RequestHeader("Authorization") String refreshToken) {
        try {
            // éªŒè¯RefreshToken
            Claims claims = jwtUtil.validateToken(refreshToken);
            String userId = claims.getSubject();
            
            // æ£€æŸ¥RefreshTokenæ˜¯å¦åœ¨é»‘åå•
            if (redisTemplate.hasKey("blacklist:" + refreshToken)) {
                return ResponseEntity.status(401).body("Tokenå·²å¤±æ•ˆ");
            }
            
            // ç”Ÿæˆæ–°çš„Tokenå¯¹
            String newAccessToken = jwtUtil.generateAccessToken(userId);
            String newRefreshToken = jwtUtil.generateRefreshToken(userId);
            
            // å°†æ—§RefreshTokenåŠ å…¥é»‘åå•
            redisTemplate.opsForValue().set("blacklist:" + refreshToken, 
                "expired", Duration.ofDays(30));
            
            return ResponseEntity.ok(new TokenResponse(newAccessToken, newRefreshToken));
            
        } catch (Exception e) {
            return ResponseEntity.status(401).body("ç»­ç­¾å¤±è´¥");
        }
    }
}
```

### 1.4 ç»­ç­¾å®‰å…¨è€ƒè™‘


ğŸ”’ **å®‰å…¨é˜²æŠ¤æªæ–½**:
- **RefreshTokenå•æ¬¡ä½¿ç”¨**: æ¯æ¬¡ç»­ç­¾åæ—§çš„RefreshTokenç«‹å³å¤±æ•ˆ
- **é»‘åå•æœºåˆ¶**: è®°å½•å·²ä½¿ç”¨çš„RefreshTokenï¼Œé˜²æ­¢é‡æ”¾æ”»å‡»
- **è®¾å¤‡ç»‘å®š**: RefreshTokenä¸è®¾å¤‡ä¿¡æ¯ç»‘å®šï¼Œé˜²æ­¢è·¨è®¾å¤‡æ»¥ç”¨
- **å¼‚å¸¸ç›‘æ§**: ç›‘æ§å¼‚å¸¸ç»­ç­¾è¡Œä¸ºï¼ŒåŠæ—¶å‘ç°å®‰å…¨å¨èƒ

---

## 2. ğŸ”— å¤šèŠ‚ç‚¹è®¤è¯ä¸€è‡´æ€§


### 2.1 å¤šèŠ‚ç‚¹è®¤è¯æŒ‘æˆ˜


> ğŸ’­ **å½¢è±¡æ¯”å–»**: æƒ³è±¡å¤šä¸ªä¿å®‰åœ¨ä¸åŒé—¨å²—ï¼Œä»–ä»¬éœ€è¦å…±äº«åŒä¸€ä»½"é€šè¡Œè¯åå•"ï¼Œä¿è¯è®¤è¯ç»“æœä¸€è‡´

**ä¸»è¦é—®é¢˜**:
```
ç”¨æˆ·ç™»å½• â†’ èŠ‚ç‚¹A (ç”ŸæˆToken)
ç”¨æˆ·è®¿é—® â†’ èŠ‚ç‚¹B (éªŒè¯Token) âŒ ä¸è®¤è¯†è¿™ä¸ªToken
ç”¨æˆ·è®¿é—® â†’ èŠ‚ç‚¹C (éªŒè¯Token) âŒ ä¹Ÿä¸è®¤è¯†

ç»“æœï¼šç”¨æˆ·éœ€è¦åœ¨æ¯ä¸ªèŠ‚ç‚¹éƒ½ç™»å½•ä¸€æ¬¡
```

### 2.2 JWTæ— çŠ¶æ€æ–¹æ¡ˆ


**JWTçš„å¤©ç„¶ä¼˜åŠ¿**:
```
JWT Tokenç»“æ„ï¼š
Header.Payload.Signature

ä¼˜åŠ¿ï¼š
âœ… è‡ªåŒ…å«ï¼šTokenæœ¬èº«åŒ…å«ç”¨æˆ·ä¿¡æ¯
âœ… æ— çŠ¶æ€ï¼šä¸éœ€è¦æœåŠ¡ç«¯å­˜å‚¨ä¼šè¯ä¿¡æ¯  
âœ… è·¨èŠ‚ç‚¹ï¼šä»»ä½•èŠ‚ç‚¹éƒ½èƒ½ç‹¬ç«‹éªŒè¯Token
```

**JWTéªŒè¯æµç¨‹**:
```
å®¢æˆ·ç«¯                èŠ‚ç‚¹A                èŠ‚ç‚¹B
   |                    |                    |
   |â”€â”€â”€â”€ JWT Token â”€â”€â”€â”€â†’|                    |
   |                    |éªŒè¯ç­¾å âœ“           |
   |â†â”€â”€â”€â”€ è®¿é—®æˆåŠŸ â”€â”€â”€â”€â”€â”€|                    |
   |                    |                    |
   |â”€â”€â”€â”€ åŒä¸€JWT Token â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’|
   |                    |                éªŒè¯ç­¾å âœ“
   |â†â”€â”€â”€â”€ è®¿é—®æˆåŠŸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€|
```

### 2.3 å…±äº«å¯†é’¥ç®¡ç†


**ç»Ÿä¸€ç­¾åå¯†é’¥**:
```java
@Configuration
public class JwtConfig {
    
    // æ–¹æ¡ˆ1ï¼šé…ç½®æ–‡ä»¶ç»Ÿä¸€å¯†é’¥
    @Value("${jwt.secret}")
    private String jwtSecret;
    
    // æ–¹æ¡ˆ2ï¼šä»é…ç½®ä¸­å¿ƒè·å–å¯†é’¥
    @Autowired
    private ConfigService configService;
    
    @PostConstruct
    public void initSecret() {
        // ä»Nacos/Apolloç­‰é…ç½®ä¸­å¿ƒè·å–å¯†é’¥
        this.jwtSecret = configService.getConfig("jwt.secret");
    }
    
    // æ–¹æ¡ˆ3ï¼šå®šæœŸè½®æ¢å¯†é’¥
    @Scheduled(cron = "0 0 2 * * ?") // æ¯å¤©å‡Œæ™¨2ç‚¹
    public void rotateSecret() {
        String newSecret = configService.getConfig("jwt.secret.new");
        if (newSecret != null) {
            this.jwtSecret = newSecret;
            // é€šçŸ¥æ‰€æœ‰èŠ‚ç‚¹æ›´æ–°å¯†é’¥
            messagingService.broadcast("jwt.secret.update", newSecret);
        }
    }
}
```

### 2.4 åˆ†å¸ƒå¼Tokené»‘åå•


**Redisé›†ä¸­å¼é»‘åå•**:
```java
@Service
public class TokenBlacklistService {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    // æ·»åŠ Tokenåˆ°é»‘åå•
    public void addToBlacklist(String tokenId, long expireTime) {
        String key = "token:blacklist:" + tokenId;
        long ttl = expireTime - System.currentTimeMillis();
        
        if (ttl > 0) {
            redisTemplate.opsForValue().set(key, "blacklisted", 
                Duration.ofMillis(ttl));
        }
    }
    
    // æ£€æŸ¥Tokenæ˜¯å¦åœ¨é»‘åå•
    public boolean isBlacklisted(String tokenId) {
        String key = "token:blacklist:" + tokenId;
        return redisTemplate.hasKey(key);
    }
    
    // ç”¨æˆ·é€€å‡ºæ—¶ï¼Œå°†æ‰€æœ‰TokenåŠ å…¥é»‘åå•
    public void blacklistUserTokens(String userId) {
        Set<String> userTokens = redisTemplate.opsForSet()
            .members("user:tokens:" + userId);
        
        for (String tokenId : userTokens) {
            addToBlacklist(tokenId, getTokenExpireTime(tokenId));
        }
    }
}
```

---

## 3. ğŸ—„ï¸ Redisè®¤è¯æ•°æ®ç®¡ç†


### 3.1 Redisåœ¨è®¤è¯ä¸­çš„ä½œç”¨


> ğŸ’¡ **é€šä¿—ç†è§£**: Rediså°±åƒä¸€ä¸ªè¶…å¿«çš„"è®°äº‹æœ¬"ï¼Œä¸“é—¨è®°å½•ç”¨æˆ·ç™»å½•çŠ¶æ€ã€æƒé™ä¿¡æ¯ç­‰éœ€è¦å¿«é€ŸæŸ¥è¯¢çš„æ•°æ®

**ä¸»è¦ç”¨é€”**:
- ğŸ« **Tokenå­˜å‚¨**: å­˜å‚¨æœ‰çŠ¶æ€Tokenä¿¡æ¯
- ğŸ“‹ **é»‘åå•ç®¡ç†**: è®°å½•å·²æ’¤é”€çš„Token
- ğŸ‘¤ **ç”¨æˆ·ä¼šè¯**: å­˜å‚¨ç”¨æˆ·ç™»å½•çŠ¶æ€å’Œæƒé™ä¿¡æ¯
- ğŸ• **é™æµé˜²åˆ·**: è®°å½•ç”¨æˆ·æ“ä½œé¢‘ç‡ï¼Œé˜²æ­¢æ¶æ„è¯·æ±‚

### 3.2 Tokenå­˜å‚¨ç­–ç•¥


**å­˜å‚¨ç»“æ„è®¾è®¡**:
```
Rediså­˜å‚¨ç»“æ„ï¼š

# ç”¨æˆ·Tokenæ˜ å°„
user:tokens:{userId} = Set {token1, token2, token3}

# Tokenè¯¦ç»†ä¿¡æ¯
token:info:{tokenId} = Hash {
    userId: "123",
    deviceInfo: "iPhone 13",
    loginTime: "2025-01-01 10:00:00",
    lastActive: "2025-01-01 15:30:00",
    permissions: "user,admin"
}

# Tokené»‘åå•
token:blacklist:{tokenId} = "blacklisted"

# ç”¨æˆ·æƒé™ç¼“å­˜
user:permissions:{userId} = Hash {
    roles: "admin,user",
    permissions: "read,write,delete"
}
```

**Javaå®ç°ç¤ºä¾‹**:
```java
@Service
public class RedisTokenService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // å­˜å‚¨Tokenä¿¡æ¯
    public void storeToken(String userId, String tokenId, TokenInfo tokenInfo) {
        // 1. å°†TokenåŠ å…¥ç”¨æˆ·Tokené›†åˆ
        redisTemplate.opsForSet().add("user:tokens:" + userId, tokenId);
        
        // 2. å­˜å‚¨Tokenè¯¦ç»†ä¿¡æ¯
        Map<String, Object> tokenData = new HashMap<>();
        tokenData.put("userId", userId);
        tokenData.put("deviceInfo", tokenInfo.getDeviceInfo());
        tokenData.put("loginTime", tokenInfo.getLoginTime());
        tokenData.put("permissions", String.join(",", tokenInfo.getPermissions()));
        
        redisTemplate.opsForHash().putAll("token:info:" + tokenId, tokenData);
        
        // 3. è®¾ç½®è¿‡æœŸæ—¶é—´
        redisTemplate.expire("token:info:" + tokenId, Duration.ofDays(7));
    }
    
    // è·å–Tokenä¿¡æ¯
    public TokenInfo getTokenInfo(String tokenId) {
        Map<Object, Object> tokenData = redisTemplate.opsForHash()
            .entries("token:info:" + tokenId);
        
        if (tokenData.isEmpty()) {
            return null;
        }
        
        TokenInfo tokenInfo = new TokenInfo();
        tokenInfo.setUserId((String) tokenData.get("userId"));
        tokenInfo.setDeviceInfo((String) tokenData.get("deviceInfo"));
        tokenInfo.setPermissions(Arrays.asList(
            ((String) tokenData.get("permissions")).split(",")));
        
        return tokenInfo;
    }
    
    // æ¸…ç†ç”¨æˆ·æ‰€æœ‰Token
    public void clearUserTokens(String userId) {
        Set<Object> tokens = redisTemplate.opsForSet()
            .members("user:tokens:" + userId);
        
        for (Object token : tokens) {
            redisTemplate.delete("token:info:" + token);
        }
        
        redisTemplate.delete("user:tokens:" + userId);
    }
}
```

### 3.3 é»‘åå•ç®¡ç†ä¼˜åŒ–


**åˆ†å±‚é»‘åå•ç­–ç•¥**:
```java
@Service
public class OptimizedBlacklistService {
    
    // å…¨å±€é»‘åå•ï¼ˆæ°¸ä¹…ï¼‰
    private static final String GLOBAL_BLACKLIST = "blacklist:global";
    // ä¸´æ—¶é»‘åå•ï¼ˆæœ‰è¿‡æœŸæ—¶é—´ï¼‰
    private static final String TEMP_BLACKLIST = "blacklist:temp:";
    
    public void addToGlobalBlacklist(String tokenId) {
        // æ°¸ä¹…é»‘åå•ï¼Œç”¨äºè¢«ç›—Token
        redisTemplate.opsForSet().add(GLOBAL_BLACKLIST, tokenId);
    }
    
    public void addToTempBlacklist(String tokenId, long expireSeconds) {
        // ä¸´æ—¶é»‘åå•ï¼Œç”¨äºæ­£å¸¸é€€å‡ºçš„Token
        redisTemplate.opsForValue().set(TEMP_BLACKLIST + tokenId, 
            "temp", Duration.ofSeconds(expireSeconds));
    }
    
    public boolean isBlacklisted(String tokenId) {
        // æ£€æŸ¥å…¨å±€é»‘åå•
        if (redisTemplate.opsForSet().isMember(GLOBAL_BLACKLIST, tokenId)) {
            return true;
        }
        
        // æ£€æŸ¥ä¸´æ—¶é»‘åå•
        return redisTemplate.hasKey(TEMP_BLACKLIST + tokenId);
    }
}
```

### 3.4 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


**æ‰¹é‡æ“ä½œä¼˜åŒ–**:
```java
// æ‰¹é‡éªŒè¯TokençŠ¶æ€
public Map<String, Boolean> batchCheckTokens(List<String> tokenIds) {
    RedisCallback<Map<String, Boolean>> callback = connection -> {
        Map<String, Boolean> result = new HashMap<>();
        
        // ä½¿ç”¨Pipelineæ‰¹é‡æ£€æŸ¥
        connection.openPipeline();
        
        for (String tokenId : tokenIds) {
            connection.exists(("token:info:" + tokenId).getBytes());
            connection.sIsMember(GLOBAL_BLACKLIST.getBytes(), tokenId.getBytes());
        }
        
        List<Object> results = connection.closePipeline();
        
        // å¤„ç†ç»“æœ
        for (int i = 0; i < tokenIds.size(); i++) {
            String tokenId = tokenIds.get(i);
            boolean exists = (Boolean) results.get(i * 2);
            boolean blacklisted = (Boolean) results.get(i * 2 + 1);
            
            result.put(tokenId, exists && !blacklisted);
        }
        
        return result;
    };
    
    return redisTemplate.execute(callback);
}
```

---

## 4. ğŸ¢ å¤šç§Ÿæˆ·æƒé™éš”ç¦»


### 4.1 å¤šç§Ÿæˆ·æ¦‚å¿µç†è§£


> ğŸ’­ **ç”Ÿæ´»ä¸¾ä¾‹**: å¤šç§Ÿæˆ·å°±åƒä¸€æ ‹åŠå…¬æ¥¼ï¼Œæ¯å®¶å…¬å¸éƒ½æœ‰è‡ªå·±çš„åŠå…¬åŒºåŸŸï¼Œäº’ä¸å¹²æ‰°ï¼Œä½†å…±ç”¨ç”µæ¢¯ã€å¤§å ‚ç­‰å…¬å…±è®¾æ–½

**å¤šç§Ÿæˆ·æ¶æ„ç‰¹ç‚¹**:
- ğŸ¢ **ç§Ÿæˆ·éš”ç¦»**: æ¯ä¸ªç§Ÿæˆ·çš„æ•°æ®å’Œæƒé™å®Œå…¨åˆ†ç¦»
- ğŸ’° **èµ„æºå…±äº«**: å¤šä¸ªç§Ÿæˆ·å…±äº«åŒä¸€å¥—ç³»ç»Ÿèµ„æº
- ğŸ”’ **å®‰å…¨éš”ç¦»**: ç§Ÿæˆ·ä¹‹é—´æ— æ³•è®¿é—®å½¼æ­¤çš„æ•°æ®
- ğŸ“Š **ç‹¬ç«‹ç®¡ç†**: æ¯ä¸ªç§Ÿæˆ·å¯ä»¥ç‹¬ç«‹ç®¡ç†ç”¨æˆ·å’Œæƒé™

### 4.2 ç§Ÿæˆ·è¯†åˆ«æœºåˆ¶


**ç§Ÿæˆ·IDä¼ é€’æ–¹å¼**:
```
æ–¹å¼1ï¼šURLè·¯å¾„
https://api.example.com/tenant1/users
https://api.example.com/tenant2/users

æ–¹å¼2ï¼šå­åŸŸå
https://tenant1.example.com/api/users  
https://tenant2.example.com/api/users

æ–¹å¼3ï¼šè¯·æ±‚å¤´
Header: X-Tenant-ID: tenant1

æ–¹å¼4ï¼šTokenä¸­åŒ…å«
JWT Payload: {
  "userId": "123",
  "tenantId": "tenant1",
  "permissions": ["read", "write"]
}
```

**Spring Bootç§Ÿæˆ·æ‹¦æˆªå™¨**:
```java
@Component
public class TenantInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
            HttpServletResponse response, Object handler) {
        
        String tenantId = extractTenantId(request);
        
        if (tenantId == null) {
            response.setStatus(400);
            return false;
        }
        
        // å°†ç§Ÿæˆ·IDå­˜å‚¨åˆ°çº¿ç¨‹æœ¬åœ°å˜é‡
        TenantContext.setCurrentTenant(tenantId);
        return true;
    }
    
    private String extractTenantId(HttpServletRequest request) {
        // 1. ä»è¯·æ±‚å¤´è·å–
        String tenantId = request.getHeader("X-Tenant-ID");
        if (tenantId != null) return tenantId;
        
        // 2. ä»å­åŸŸåè·å–
        String host = request.getServerName();
        if (host.contains(".")) {
            return host.split("\\.")[0];
        }
        
        // 3. ä»JWT Tokenè·å–
        String token = request.getHeader("Authorization");
        if (token != null) {
            return extractTenantFromToken(token);
        }
        
        return null;
    }
    
    @Override
    public void afterCompletion(HttpServletRequest request, 
            HttpServletResponse response, Object handler, Exception ex) {
        // æ¸…ç†çº¿ç¨‹æœ¬åœ°å˜é‡
        TenantContext.clear();
    }
}
```

### 4.3 æ•°æ®éš”ç¦»ç­–ç•¥


**æ•°æ®åº“å±‚é¢éš”ç¦»**:

| éš”ç¦»æ–¹å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|---------|------|------|---------|
| **ç‹¬ç«‹æ•°æ®åº“** | å®Œå…¨éš”ç¦»ï¼Œæ€§èƒ½å¥½ | æˆæœ¬é«˜ï¼Œç»´æŠ¤å¤æ‚ | å¤§å®¢æˆ·ï¼Œä¸¥æ ¼éš”ç¦»è¦æ±‚ |
| **å…±äº«æ•°æ®åº“ç‹¬ç«‹Schema** | éš”ç¦»å¥½ï¼Œæˆæœ¬ä¸­ç­‰ | ç»´æŠ¤è¾ƒå¤æ‚ | ä¸­ç­‰å®¢æˆ·ï¼Œå¹³è¡¡éš”ç¦»ä¸æˆæœ¬ |
| **å…±äº«æ•°æ®åº“æ·»åŠ ç§Ÿæˆ·å­—æ®µ** | æˆæœ¬ä½ï¼Œç»´æŠ¤ç®€å• | éš”ç¦»é£é™©ï¼ŒæŸ¥è¯¢å¤æ‚ | å°å®¢æˆ·ï¼Œæˆæœ¬ä¼˜å…ˆ |

**åŸºäºç§Ÿæˆ·å­—æ®µçš„å®ç°**:
```java
@Entity
@Table(name = "users")
@Where(clause = "tenant_id = :tenantId")
public class User {
    @Id
    private Long id;
    
    @Column(name = "tenant_id", nullable = false)
    private String tenantId;
    
    private String username;
    private String email;
    
    // è‡ªåŠ¨è®¾ç½®ç§Ÿæˆ·ID
    @PrePersist
    public void prePersist() {
        if (tenantId == null) {
            tenantId = TenantContext.getCurrentTenant();
        }
    }
}

@Repository
public class UserRepository {
    
    @Query("SELECT u FROM User u WHERE u.tenantId = :#{T(com.example.TenantContext).getCurrentTenant()}")
    List<User> findAllForCurrentTenant();
    
    @Query("SELECT u FROM User u WHERE u.tenantId = :#{T(com.example.TenantContext).getCurrentTenant()} AND u.id = :id")
    Optional<User> findByIdForCurrentTenant(@Param("id") Long id);
}
```

### 4.4 æƒé™éš”ç¦»è®¾è®¡


**åˆ†å±‚æƒé™æ¨¡å‹**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           è¶…çº§ç®¡ç†å‘˜                â”‚ â† è·¨ç§Ÿæˆ·ç®¡ç†æƒé™
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         ç§Ÿæˆ·ç®¡ç†å‘˜                  â”‚ â† ç§Ÿæˆ·å†…æœ€é«˜æƒé™
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  
â”‚         éƒ¨é—¨ç®¡ç†å‘˜                  â”‚ â† éƒ¨é—¨å†…ç®¡ç†æƒé™
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         æ™®é€šç”¨æˆ·                    â”‚ â† åŸºæœ¬ä¸šåŠ¡æƒé™
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æƒé™éªŒè¯æ‹¦æˆªå™¨**:
```java
@Component
public class TenantPermissionService {
    
    public boolean hasPermission(String userId, String resource, String action) {
        String currentTenant = TenantContext.getCurrentTenant();
        
        // 1. è·å–ç”¨æˆ·åœ¨å½“å‰ç§Ÿæˆ·çš„è§’è‰²
        List<String> roles = getUserRolesInTenant(userId, currentTenant);
        
        // 2. è·å–è§’è‰²å¯¹åº”çš„æƒé™
        Set<String> permissions = new HashSet<>();
        for (String role : roles) {
            permissions.addAll(getRolePermissions(role, currentTenant));
        }
        
        // 3. æ£€æŸ¥æ˜¯å¦æœ‰å¯¹åº”æƒé™
        String permission = resource + ":" + action;
        return permissions.contains(permission);
    }
    
    // è·¨ç§Ÿæˆ·æƒé™æ£€æŸ¥ï¼ˆä»…è¶…çº§ç®¡ç†å‘˜ï¼‰
    public boolean hasGlobalPermission(String userId, String permission) {
        return userService.isSuperAdmin(userId) && 
               globalPermissionService.hasPermission(userId, permission);
    }
}
```

---

## 5. ğŸ”„ åˆ†å¸ƒå¼ä¼šè¯ç®¡ç†


### 5.1 åˆ†å¸ƒå¼ä¼šè¯æŒ‘æˆ˜


> ğŸ’­ **æ¯”å–»ç†è§£**: ä¼ ç»Ÿä¼šè¯å°±åƒåœ¨ä¸€å®¶åº—é“ºçš„å‚¨ç‰©æŸœå­˜ä¸œè¥¿ï¼Œåªèƒ½åœ¨è¿™å®¶åº—å–ã€‚åˆ†å¸ƒå¼ä¼šè¯å°±åƒé“¶è¡Œå¡ï¼Œåœ¨ä»»ä½•ç½‘ç‚¹éƒ½èƒ½ä½¿ç”¨

**ä¼ ç»Ÿä¼šè¯é—®é¢˜**:
```
ç”¨æˆ·ç™»å½• â†’ æœåŠ¡å™¨A (Sessionå­˜å‚¨åœ¨å†…å­˜)
ç”¨æˆ·è¯·æ±‚ â†’ è´Ÿè½½å‡è¡¡å™¨ â†’ æœåŠ¡å™¨B âŒ æ‰¾ä¸åˆ°Session
ç”¨æˆ·è¯·æ±‚ â†’ è´Ÿè½½å‡è¡¡å™¨ â†’ æœåŠ¡å™¨C âŒ ä¹Ÿæ‰¾ä¸åˆ°Session

ç»“æœï¼šç”¨æˆ·ä½“éªŒå·®ï¼Œéœ€è¦ç²˜æ€§ä¼šè¯
```

**åˆ†å¸ƒå¼ä¼šè¯è§£å†³æ–¹æ¡ˆ**:
- ğŸª **Sessioné›†ä¸­å­˜å‚¨**: ä½¿ç”¨Rediså­˜å‚¨Session
- ğŸ”„ **SessionåŒæ­¥**: æœåŠ¡å™¨ä¹‹é—´åŒæ­¥Session
- ğŸ« **æ— çŠ¶æ€Token**: ä½¿ç”¨JWTæ›¿ä»£ä¼ ç»ŸSession

### 5.2 Redisé›†ä¸­å¼Session


**Spring Session + Rediså®ç°**:
```java
@Configuration
@EnableRedisHttpSession(maxInactiveIntervalInSeconds = 1800)
public class SessionConfig {
    
    @Bean
    public LettuceConnectionFactory connectionFactory() {
        return new LettuceConnectionFactory(
            new RedisStandaloneConfiguration("localhost", 6379));
    }
    
    @Bean
    public RedisTemplate<String, Object> redisTemplate() {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(connectionFactory());
        template.setDefaultSerializer(new GenericJackson2JsonRedisSerializer());
        return template;
    }
}
```

**Sessionæ“ä½œç¤ºä¾‹**:
```java
@RestController
public class SessionController {
    
    @PostMapping("/login")
    public ResponseEntity<?> login(@RequestBody LoginRequest request, 
                                  HttpServletRequest httpRequest) {
        // éªŒè¯ç”¨æˆ·åå¯†ç 
        User user = userService.authenticate(request.getUsername(), request.getPassword());
        
        if (user != null) {
            // åˆ›å»ºSession
            HttpSession session = httpRequest.getSession(true);
            session.setAttribute("userId", user.getId());
            session.setAttribute("username", user.getUsername());
            session.setAttribute("permissions", user.getPermissions());
            session.setMaxInactiveInterval(1800); // 30åˆ†é’Ÿ
            
            return ResponseEntity.ok(new LoginResponse("ç™»å½•æˆåŠŸ", session.getId()));
        }
        
        return ResponseEntity.status(401).body("ç™»å½•å¤±è´¥");
    }
    
    @GetMapping("/profile")
    public ResponseEntity<?> getProfile(HttpSession session) {
        String userId = (String) session.getAttribute("userId");
        
        if (userId == null) {
            return ResponseEntity.status(401).body("æœªç™»å½•");
        }
        
        User user = userService.findById(userId);
        return ResponseEntity.ok(user);
    }
}
```

### 5.3 Sessioné›†ç¾¤åŒæ­¥


**ä¸»ä»åŒæ­¥æ¨¡å¼**:
```
ä¸»RedisèŠ‚ç‚¹     ä»RedisèŠ‚ç‚¹1    ä»RedisèŠ‚ç‚¹2
     â”‚              â”‚              â”‚
     â”‚â”€â”€â”€â”€ å†™å…¥ â”€â”€â”€â”€â†’â”‚              â”‚
     â”‚              â”‚â”€â”€â”€â”€ åŒæ­¥ â”€â”€â”€â”€â†’â”‚
     â”‚              â”‚              â”‚
     â”‚â†â”€â”€ è¯»å– â”€â”€â”€â”€â”€â”€â”‚â†â”€â”€ è¯»å– â”€â”€â”€â”€â”€â”‚
```

**å“¨å…µæ¨¡å¼é…ç½®**:
```java
@Configuration
public class RedisClusterConfig {
    
    @Bean
    public RedisSentinelConfiguration sentinelConfiguration() {
        RedisSentinelConfiguration config = new RedisSentinelConfiguration();
        config.master("mymaster");
        config.sentinel("127.0.0.1", 26379);
        config.sentinel("127.0.0.1", 26380);
        config.sentinel("127.0.0.1", 26381);
        return config;
    }
    
    @Bean
    public LettuceConnectionFactory lettuceConnectionFactory() {
        return new LettuceConnectionFactory(sentinelConfiguration());
    }
}
```

### 5.4 å¤šç«¯ç™»å½•å†²çªå¤„ç†


**ç™»å½•å†²çªç­–ç•¥**:

| ç­–ç•¥ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ | å®ç°æ–¹å¼ |
|------|------|---------|---------|
| **è¸¢å‡ºæ—§è®¾å¤‡** | æ–°è®¾å¤‡ç™»å½•æ—¶è¸¢å‡ºæ—§è®¾å¤‡ | å®‰å…¨æ€§è¦æ±‚é«˜ | åˆ é™¤æ—§Session/Token |
| **é™åˆ¶è®¾å¤‡æ•°é‡** | æœ€å¤šå…è®¸Nä¸ªè®¾å¤‡åŒæ—¶ç™»å½• | å¹³è¡¡å®‰å…¨ä¸ä½“éªŒ | ç»´æŠ¤è®¾å¤‡åˆ—è¡¨ï¼Œè¶…å‡ºé™åˆ¶æ—¶è¸¢å‡ºæœ€æ—§çš„ |
| **å…è®¸å¤šè®¾å¤‡** | ä¸é™åˆ¶ç™»å½•è®¾å¤‡æ•°é‡ | ç”¨æˆ·ä½“éªŒä¼˜å…ˆ | ä¸ºæ¯ä¸ªè®¾å¤‡åˆ†é…ç‹¬ç«‹Session |
| **è®¾å¤‡ç±»å‹éš”ç¦»** | æ‰‹æœºã€ç”µè„‘ã€å¹³æ¿åˆ†åˆ«è®¡ç®— | å¤æ‚ä¸šåŠ¡åœºæ™¯ | æŒ‰è®¾å¤‡ç±»å‹åˆ†ç»„ç®¡ç† |

**å¤šè®¾å¤‡ç®¡ç†å®ç°**:
```java
@Service
public class MultiDeviceSessionService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    public void handleUserLogin(String userId, String deviceId, 
                               String deviceType, String sessionId) {
        String deviceKey = "user:devices:" + userId;
        String sessionKey = "device:session:" + deviceId;
        
        // è·å–å½“å‰ç”¨æˆ·çš„æ‰€æœ‰è®¾å¤‡
        Map<Object, Object> devices = redisTemplate.opsForHash().entries(deviceKey);
        
        // æ£€æŸ¥è®¾å¤‡æ•°é‡é™åˆ¶
        if (devices.size() >= getMaxDevicesForUser(userId)) {
            // è¸¢å‡ºæœ€æ—§çš„è®¾å¤‡
            String oldestDeviceId = findOldestDevice(devices);
            removeDeviceSession(userId, oldestDeviceId);
        }
        
        // è®°å½•æ–°è®¾å¤‡ä¿¡æ¯
        DeviceInfo deviceInfo = new DeviceInfo();
        deviceInfo.setDeviceId(deviceId);
        deviceInfo.setDeviceType(deviceType);
        deviceInfo.setLoginTime(System.currentTimeMillis());
        deviceInfo.setSessionId(sessionId);
        
        redisTemplate.opsForHash().put(deviceKey, deviceId, deviceInfo);
        redisTemplate.opsForValue().set(sessionKey, sessionId, Duration.ofMinutes(30));
    }
    
    public void removeDeviceSession(String userId, String deviceId) {
        // 1. åˆ é™¤è®¾å¤‡è®°å½•
        redisTemplate.opsForHash().delete("user:devices:" + userId, deviceId);
        
        // 2. åˆ é™¤Session
        String sessionKey = "device:session:" + deviceId;
        String sessionId = (String) redisTemplate.opsForValue().get(sessionKey);
        if (sessionId != null) {
            redisTemplate.delete("spring:session:sessions:" + sessionId);
        }
        
        redisTemplate.delete(sessionKey);
    }
}
```

---

## 6. âš–ï¸ Tokenä¸Sessioné€‰æ‹©ç­–ç•¥


### 6.1 Token vs Session å¯¹æ¯”


> ğŸ’¡ **å½¢è±¡æ¯”å–»**: Sessionåƒé…’åº—æˆ¿å¡ï¼Œéœ€è¦åœ¨å‰å°éªŒè¯ï¼›Tokenåƒèº«ä»½è¯ï¼Œèµ°åˆ°å“ªé‡Œéƒ½èƒ½è¯æ˜èº«ä»½

| ç‰¹æ€§ | Session | Token (JWT) |
|------|---------|-------------|
| **å­˜å‚¨ä½ç½®** | æœåŠ¡ç«¯å†…å­˜/æ•°æ®åº“ | å®¢æˆ·ç«¯ |
| **çŠ¶æ€æ€§** | æœ‰çŠ¶æ€ | æ— çŠ¶æ€ |
| **æ‰©å±•æ€§** | éœ€è¦å…±äº«å­˜å‚¨ | å¤©ç„¶æ”¯æŒåˆ†å¸ƒå¼ |
| **å®‰å…¨æ€§** | SessionIDæ³„éœ²é£é™©è¾ƒå° | Tokenæ³„éœ²å½±å“è¾ƒå¤§ |
| **æ€§èƒ½** | éœ€è¦å­˜å‚¨æŸ¥è¯¢ | æœ¬åœ°éªŒè¯ï¼Œæ€§èƒ½å¥½ |
| **æ³¨é”€** | æœåŠ¡ç«¯åˆ é™¤å³å¯ | éœ€è¦é»‘åå•æœºåˆ¶ |

### 6.2 é€‰æ‹©å†³ç­–æ ‘


```
ä¸šåŠ¡éœ€æ±‚åˆ†æ
      â”‚
      â–¼
   æ˜¯å¦éœ€è¦åˆ†å¸ƒå¼ï¼Ÿ
   â”Œâ”€â”€â”€ æ˜¯ â”€â”€â”€â”         â”Œâ”€â”€â”€ å¦ â”€â”€â”€â”
   â”‚          â”‚         â”‚          â”‚
   â–¼          â–¼         â–¼          â–¼
å¾®æœåŠ¡æ¶æ„ï¼Ÿ  å•ä½“åº”ç”¨   ä¼ ç»ŸWebåº”ç”¨  ç®€å•åº”ç”¨
   â”‚                    â”‚          â”‚
   â–¼                    â–¼          â–¼
é€‰æ‹©JWT Token       é€‰æ‹©Session   é€‰æ‹©Session
   â”‚                    â”‚          â”‚
   â–¼                    â–¼          â–¼
éœ€è¦å³æ—¶æ³¨é”€ï¼Ÿ       éœ€è¦å¤æ‚çŠ¶æ€ï¼Ÿ  æ€§èƒ½è¦æ±‚é«˜ï¼Ÿ
 â”Œâ”€æ˜¯â”€â” â”Œâ”€å¦â”€â”      â”Œâ”€æ˜¯â”€â” â”Œâ”€å¦â”€â”  â”Œâ”€æ˜¯â”€â” â”Œâ”€å¦â”€â”
 â”‚    â”‚ â”‚    â”‚      â”‚    â”‚ â”‚    â”‚  â”‚    â”‚ â”‚    â”‚
 â–¼    â–¼ â–¼    â–¼      â–¼    â–¼ â–¼    â–¼  â–¼    â–¼ â–¼    â–¼
JWT + Redis  çº¯JWT   Session JWT+ç®€åŒ– å†…å­˜Cache æ ‡å‡†Session
é»‘åå•æœºåˆ¶           å…±äº«å­˜å‚¨  çŠ¶æ€ç®¡ç†
```

### 6.3 æ··åˆæ–¹æ¡ˆè®¾è®¡


**JWT + Redis æ··åˆæ¶æ„**:
```java
@Service
public class HybridAuthService {
    
    @Autowired
    private JwtUtil jwtUtil;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    public LoginResponse login(String username, String password) {
        // 1. éªŒè¯ç”¨æˆ·
        User user = authenticate(username, password);
        
        // 2. ç”ŸæˆJWT Token
        String accessToken = jwtUtil.generateAccessToken(user.getId());
        String refreshToken = jwtUtil.generateRefreshToken(user.getId());
        
        // 3. åœ¨Redisä¸­å­˜å‚¨TokençŠ¶æ€ï¼ˆç”¨äºå¿«é€Ÿæ’¤é”€ï¼‰
        String tokenKey = "token:status:" + jwtUtil.getTokenId(accessToken);
        TokenStatus status = new TokenStatus();
        status.setUserId(user.getId());
        status.setActive(true);
        status.setLastUsed(System.currentTimeMillis());
        
        redisTemplate.opsForValue().set(tokenKey, status, 
            Duration.ofMinutes(jwtUtil.getAccessTokenExpireMinutes()));
        
        // 4. è®°å½•ç”¨æˆ·æ´»è·ƒToken
        redisTemplate.opsForSet().add("user:active:tokens:" + user.getId(), 
            jwtUtil.getTokenId(accessToken));
        
        return new LoginResponse(accessToken, refreshToken);
    }
    
    public boolean validateToken(String token) {
        try {
            // 1. JWTæœ¬åœ°éªŒè¯ï¼ˆå¿«é€Ÿï¼‰
            Claims claims = jwtUtil.validateToken(token);
            String tokenId = claims.getId();
            
            // 2. RedisçŠ¶æ€æ£€æŸ¥ï¼ˆå¯é€‰ï¼Œç”¨äºå³æ—¶æ’¤é”€ï¼‰
            if (isStrictModeEnabled()) {
                String tokenKey = "token:status:" + tokenId;
                TokenStatus status = (TokenStatus) redisTemplate.opsForValue().get(tokenKey);
                return status != null && status.isActive();
            }
            
            return true;
        } catch (Exception e) {
            return false;
        }
    }
    
    public void logout(String token) {
        String tokenId = jwtUtil.getTokenId(token);
        String userId = jwtUtil.getUserId(token);
        
        // 1. æ ‡è®°Tokenä¸ºéæ´»è·ƒçŠ¶æ€
        String tokenKey = "token:status:" + tokenId;
        TokenStatus status = (TokenStatus) redisTemplate.opsForValue().get(tokenKey);
        if (status != null) {
            status.setActive(false);
            redisTemplate.opsForValue().set(tokenKey, status, Duration.ofMinutes(30));
        }
        
        // 2. ä»ç”¨æˆ·æ´»è·ƒTokené›†åˆä¸­ç§»é™¤
        redisTemplate.opsForSet().remove("user:active:tokens:" + userId, tokenId);
        
        // 3. åŠ å…¥é»‘åå•ï¼ˆå¯é€‰ï¼‰
        redisTemplate.opsForSet().add("token:blacklist", tokenId);
    }
}
```

### 6.4 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


**TokenéªŒè¯ä¼˜åŒ–**:
```java
@Component
public class OptimizedTokenValidator {
    
    // æœ¬åœ°ç¼“å­˜ï¼Œå‡å°‘Redisè®¿é—®
    private final Cache<String, Boolean> tokenCache = Caffeine.newBuilder()
        .maximumSize(10000)
        .expireAfterWrite(5, TimeUnit.MINUTES)
        .build();
    
    public boolean isTokenValid(String tokenId) {
        // 1. å…ˆæŸ¥æœ¬åœ°ç¼“å­˜
        Boolean cached = tokenCache.getIfPresent(tokenId);
        if (cached != null) {
            return cached;
        }
        
        // 2. æŸ¥è¯¢Redis
        boolean isValid = !redisTemplate.opsForSet().isMember("token:blacklist", tokenId);
        
        // 3. ç¼“å­˜ç»“æœ
        tokenCache.put(tokenId, isValid);
        
        return isValid;
    }
    
    // å½“Tokenè¢«æ’¤é”€æ—¶ï¼Œæ¸…é™¤ç¼“å­˜
    @EventListener
    public void onTokenRevoked(TokenRevokedEvent event) {
        tokenCache.invalidate(event.getTokenId());
    }
}
```

---

## 7. ğŸŒ å•ç‚¹ç™»å½•SSOå®ç°


### 7.1 SSOåŸºæœ¬æ¦‚å¿µ


> ğŸ’­ **ç”Ÿæ´»åœºæ™¯**: SSOå°±åƒå…¬å¸çš„å·¥ç‰Œï¼Œåˆ·ä¸€æ¬¡å¡å°±èƒ½è¿›å…¥å…¬å¸æ‰€æœ‰æ¥¼å±‚ï¼Œä¸ç”¨åœ¨æ¯ä¸ªé—¨éƒ½åˆ·å¡

**SSOæ ¸å¿ƒä»·å€¼**:
- ğŸšª **ä¸€æ¬¡ç™»å½•ï¼Œå¤šå¤„ä½¿ç”¨**: ç™»å½•ä¸€ä¸ªç³»ç»Ÿï¼Œè®¿é—®æ‰€æœ‰ç›¸å…³ç³»ç»Ÿ
- ğŸ‘¤ **ç»Ÿä¸€ç”¨æˆ·ä½“éªŒ**: ç”¨æˆ·æ— éœ€è®°ä½å¤šå¥—è´¦å·å¯†ç 
- ğŸ”’ **é›†ä¸­æƒé™ç®¡ç†**: ç»Ÿä¸€ç®¡ç†ç”¨æˆ·æƒé™å’Œè®¿é—®æ§åˆ¶
- ğŸ’° **é™ä½ç®¡ç†æˆæœ¬**: å‡å°‘å¯†ç é‡ç½®ã€è´¦å·ç®¡ç†ç­‰å·¥ä½œé‡

### 7.2 SSOå®ç°æ¨¡å¼


**CAS (Central Authentication Service) æ¨¡å¼**:
```
ç”¨æˆ·è®¿é—®æµç¨‹ï¼š
1. ç”¨æˆ·è®¿é—®åº”ç”¨A â†’ å‘ç°æœªç™»å½• â†’ é‡å®šå‘åˆ°SSOè®¤è¯ä¸­å¿ƒ
2. ç”¨æˆ·åœ¨SSOä¸­å¿ƒç™»å½• â†’ ç”ŸæˆTGT (Ticket Granting Ticket)
3. SSOä¸­å¿ƒé‡å®šå‘å›åº”ç”¨Aï¼Œæºå¸¦ST (Service Ticket)
4. åº”ç”¨Aä½¿ç”¨STå‘SSOä¸­å¿ƒéªŒè¯ â†’ è·å–ç”¨æˆ·ä¿¡æ¯
5. ç”¨æˆ·è®¿é—®åº”ç”¨B â†’ åº”ç”¨Bé‡å®šå‘åˆ°SSOä¸­å¿ƒ
6. SSOä¸­å¿ƒå‘ç°å·²ç™»å½• â†’ ç›´æ¥é¢å‘æ–°STç»™åº”ç”¨B
```

**æµç¨‹å›¾ç¤º**:
```
ç”¨æˆ·        åº”ç”¨A        SSOä¸­å¿ƒ        åº”ç”¨B
 â”‚           â”‚            â”‚             â”‚
 â”‚â”€â”€è®¿é—®â”€â”€â”€â”€â†’â”‚            â”‚             â”‚
 â”‚           â”‚â”€â”€é‡å®šå‘â”€â”€â”€â†’â”‚             â”‚
 â”‚           â”‚            â”‚             â”‚
 â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€ç™»å½•é¡µé¢â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚             â”‚
 â”‚           â”‚            â”‚             â”‚
 â”‚â”€â”€ç™»å½•å‡­æ®â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚             â”‚
 â”‚           â”‚            â”‚(ç”ŸæˆTGT)    â”‚
 â”‚           â”‚â†â”€â”€â”€STâ”€â”€â”€â”€â”€â”€â”‚             â”‚
 â”‚â†â”€é‡å®šå‘â”€â”€â”‚            â”‚             â”‚
 â”‚           â”‚            â”‚             â”‚
 â”‚           â”‚â”€â”€éªŒè¯STâ”€â”€â”€â†’â”‚             â”‚
 â”‚           â”‚â†â”€ç”¨æˆ·ä¿¡æ¯â”€â”€â”‚             â”‚
 â”‚           â”‚            â”‚             â”‚
 â”‚â”€â”€è®¿é—®åº”ç”¨Bâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
 â”‚           â”‚            â”‚             â”‚
 â”‚           â”‚            â”‚â†â”€é‡å®šå‘â”€â”€â”€â”€â”‚
 â”‚           â”‚            â”‚             â”‚
 â”‚           â”‚            â”‚â”€â”€æ–°STâ”€â”€â”€â”€â”€â†’â”‚
 â”‚           â”‚            â”‚             â”‚
 â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ç›´æ¥è®¿é—®â”€â”‚
```

### 7.3 Spring Security SSOå®ç°


**SSOè®¤è¯ä¸­å¿ƒ**:
```java
@RestController
public class SSOController {
    
    @Autowired
    private TicketService ticketService;
    
    @Autowired
    private UserService userService;
    
    // ç»Ÿä¸€ç™»å½•å…¥å£
    @GetMapping("/login")
    public ModelAndView login(@RequestParam String service, 
                             HttpServletRequest request) {
        
        // æ£€æŸ¥æ˜¯å¦å·²ç»ç™»å½•
        String tgt = getTGTFromCookie(request);
        if (tgt != null && ticketService.isValidTGT(tgt)) {
            // å·²ç™»å½•ï¼Œç›´æ¥é¢å‘ServiceTicket
            String serviceTicket = ticketService.generateServiceTicket(tgt, service);
            return new ModelAndView("redirect:" + service + "?ticket=" + serviceTicket);
        }
        
        // æœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•é¡µé¢
        ModelAndView mv = new ModelAndView("login");
        mv.addObject("service", service);
        return mv;
    }
    
    // å¤„ç†ç™»å½•
    @PostMapping("/login")
    public ModelAndView doLogin(@RequestParam String username,
                               @RequestParam String password,
                               @RequestParam String service,
                               HttpServletResponse response) {
        
        // éªŒè¯ç”¨æˆ·å‡­æ®
        User user = userService.authenticate(username, password);
        if (user == null) {
            return new ModelAndView("login", "error", "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
        }
        
        // ç”ŸæˆTicketGrantingTicket
        String tgt = ticketService.generateTGT(user.getId());
        
        // è®¾ç½®TGT Cookie
        Cookie tgtCookie = new Cookie("TGT", tgt);
        tgtCookie.setHttpOnly(true);
        tgtCookie.setSecure(true);
        tgtCookie.setPath("/");
        tgtCookie.setMaxAge(8 * 60 * 60); // 8å°æ—¶
        response.addCookie(tgtCookie);
        
        // ç”ŸæˆServiceTicketå¹¶é‡å®šå‘
        String serviceTicket = ticketService.generateServiceTicket(tgt, service);
        return new ModelAndView("redirect:" + service + "?ticket=" + serviceTicket);
    }
    
    // ç¥¨æ®éªŒè¯æ¥å£
    @GetMapping("/validate")
    public ResponseEntity<?> validateTicket(@RequestParam String ticket,
                                          @RequestParam String service) {
        
        TicketValidationResult result = ticketService.validateServiceTicket(ticket, service);
        
        if (result.isValid()) {
            return ResponseEntity.ok(result.getUserInfo());
        } else {
            return ResponseEntity.status(401).body("ç¥¨æ®æ— æ•ˆ");
        }
    }
    
    // ç»Ÿä¸€é€€å‡º
    @PostMapping("/logout")
    public ModelAndView logout(HttpServletRequest request, 
                              HttpServletResponse response) {
        
        String tgt = getTGTFromCookie(request);
        if (tgt != null) {
            // æ’¤é”€TGTï¼Œè¿™ä¼šä½¿æ‰€æœ‰ç›¸å…³çš„ServiceTicketå¤±æ•ˆ
            ticketService.revokeTGT(tgt);
            
            // æ¸…é™¤Cookie
            Cookie cookie = new Cookie("TGT", "");
            cookie.setMaxAge(0);
            cookie.setPath("/");
            response.addCookie(cookie);
        }
        
        return new ModelAndView("logout-success");
    }
}
```

**ç¥¨æ®æœåŠ¡å®ç°**:
```java
@Service
public class TicketService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // ç”ŸæˆTGT
    public String generateTGT(String userId) {
        String tgt = "TGT-" + UUID.randomUUID().toString();
        
        TGTInfo tgtInfo = new TGTInfo();
        tgtInfo.setUserId(userId);
        tgtInfo.setCreateTime(System.currentTimeMillis());
        tgtInfo.setActive(true);
        
        redisTemplate.opsForValue().set("tgt:" + tgt, tgtInfo, Duration.ofHours(8));
        
        return tgt;
    }
    
    // ç”ŸæˆServiceTicket
    public String generateServiceTicket(String tgt, String service) {
        if (!isValidTGT(tgt)) {
            throw new IllegalArgumentException("TGTæ— æ•ˆ");
        }
        
        String serviceTicket = "ST-" + UUID.randomUUID().toString();
        
        STInfo stInfo = new STInfo();
        stInfo.setTgt(tgt);
        stInfo.setService(service);
        stInfo.setCreateTime(System.currentTimeMillis());
        stInfo.setUsed(false);
        
        // ServiceTicketä¸€æ¬¡æ€§ä½¿ç”¨ï¼ŒçŸ­æœŸæœ‰æ•ˆ
        redisTemplate.opsForValue().set("st:" + serviceTicket, stInfo, Duration.ofMinutes(5));
        
        return serviceTicket;
    }
    
    // éªŒè¯ServiceTicket
    public TicketValidationResult validateServiceTicket(String ticket, String service) {
        STInfo stInfo = (STInfo) redisTemplate.opsForValue().get("st:" + ticket);
        
        if (stInfo == null || stInfo.isUsed() || !service.equals(stInfo.getService())) {
            return new TicketValidationResult(false, null);
        }
        
        // æ ‡è®°ä¸ºå·²ä½¿ç”¨
        stInfo.setUsed(true);
        redisTemplate.opsForValue().set("st:" + ticket, stInfo, Duration.ofMinutes(1));
        
        // è·å–ç”¨æˆ·ä¿¡æ¯
        TGTInfo tgtInfo = (TGTInfo) redisTemplate.opsForValue().get("tgt:" + stInfo.getTgt());
        if (tgtInfo == null || !tgtInfo.isActive()) {
            return new TicketValidationResult(false, null);
        }
        
        User user = userService.findById(tgtInfo.getUserId());
        return new TicketValidationResult(true, user);
    }
}
```

### 7.4 å®¢æˆ·ç«¯åº”ç”¨é›†æˆ


**Spring Bootå®¢æˆ·ç«¯é…ç½®**:
```java
@Component
public class SSOFilter implements Filter {
    
    @Value("${sso.server.url}")
    private String ssoServerUrl;
    
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, 
                        FilterChain chain) throws IOException, ServletException {
        
        HttpServletRequest req = (HttpServletRequest) request;
        HttpServletResponse resp = (HttpServletResponse) response;
        
        // æ£€æŸ¥æ˜¯å¦å·²è®¤è¯
        if (isAuthenticated(req)) {
            chain.doFilter(request, response);
            return;
        }
        
        // æ£€æŸ¥æ˜¯å¦æœ‰ç¥¨æ®
        String ticket = req.getParameter("ticket");
        if (ticket != null) {
            // éªŒè¯ç¥¨æ®
            User user = validateTicketWithSSOServer(ticket);
            if (user != null) {
                // åˆ›å»ºæœ¬åœ°ä¼šè¯
                HttpSession session = req.getSession();
                session.setAttribute("user", user);
                
                // é‡å®šå‘å»é™¤ç¥¨æ®å‚æ•°
                String redirectUrl = removeTicketParameter(req.getRequestURL().toString());
                resp.sendRedirect(redirectUrl);
                return;
            }
        }
        
        // é‡å®šå‘åˆ°SSOç™»å½•
        String serviceUrl = req.getRequestURL().toString();
        String loginUrl = ssoServerUrl + "/login?service=" + 
                         URLEncoder.encode(serviceUrl, "UTF-8");
        resp.sendRedirect(loginUrl);
    }
    
    private User validateTicketWithSSOServer(String ticket) {
        try {
            RestTemplate restTemplate = new RestTemplate();
            String validateUrl = ssoServerUrl + "/validate?ticket=" + ticket + 
                               "&service=" + getCurrentServiceUrl();
            
            ResponseEntity<User> response = restTemplate.getForEntity(validateUrl, User.class);
            return response.getStatusCode().is2xxSuccessful() ? response.getBody() : null;
            
        } catch (Exception e) {
            return null;
        }
    }
}
```

---

## 8. ğŸ“Š è®¤è¯ç›‘æ§ä¸æ•…éšœæ’æŸ¥


### 8.1 è®¤è¯æ€§èƒ½ç›‘æ§æŒ‡æ ‡


**å…³é”®ç›‘æ§æŒ‡æ ‡**:

| æŒ‡æ ‡ç±»å‹ | å…·ä½“æŒ‡æ ‡ | æ­£å¸¸èŒƒå›´ | è¯´æ˜ |
|---------|---------|---------|------|
| **æ€§èƒ½æŒ‡æ ‡** | ç™»å½•å“åº”æ—¶é—´ | < 200ms | ç”¨æˆ·ç™»å½•ä½“éªŒ |
| | TokenéªŒè¯æ—¶é—´ | < 50ms | APIè®¿é—®æ€§èƒ½ |
| | å¹¶å‘ç™»å½•æ•° | æ ¹æ®ä¸šåŠ¡ | ç³»ç»Ÿè´Ÿè½½ç›‘æ§ |
| **ä¸šåŠ¡æŒ‡æ ‡** | ç™»å½•æˆåŠŸç‡ | > 99% | ç³»ç»Ÿå¯ç”¨æ€§ |
| | Tokenç»­ç­¾æˆåŠŸç‡ | > 99.5% | ç”¨æˆ·ä½“éªŒ |
| | å¼‚å¸¸ç™»å½•æ£€æµ‹ | < 0.1% | å®‰å…¨æ€§ç›‘æ§ |
| **å®‰å…¨æŒ‡æ ‡** | å¤±è´¥ç™»å½•æ¬¡æ•° | ç›‘æ§é˜ˆå€¼ | æš´åŠ›ç ´è§£æ£€æµ‹ |
| | å¼‚åœ°ç™»å½•æ£€æµ‹ | å®æ—¶å‘Šè­¦ | è´¦å·å®‰å…¨ |
| | Tokenæ³„éœ²æ£€æµ‹ | å®æ—¶å‘Šè­¦ | å®‰å…¨å¨èƒ |

### 8.2 ç›‘æ§å®ç°


**MicrometeræŒ‡æ ‡æ”¶é›†**:
```java
@Component
public class AuthMetrics {
    
    private final Counter loginSuccessCounter;
    private final Counter loginFailureCounter;
    private final Timer loginTimer;
    private final Timer tokenValidationTimer;
    private final Gauge activeSessionGauge;
    
    public AuthMetrics(MeterRegistry meterRegistry, 
                      SessionRegistry sessionRegistry) {
        
        this.loginSuccessCounter = Counter.builder("auth.login.success")
            .description("æˆåŠŸç™»å½•æ¬¡æ•°")
            .register(meterRegistry);
            
        this.loginFailureCounter = Counter.builder("auth.login.failure")
            .description("å¤±è´¥ç™»å½•æ¬¡æ•°")
            .tag("reason", "unknown")
            .register(meterRegistry);
            
        this.loginTimer = Timer.builder("auth.login.duration")
            .description("ç™»å½•å¤„ç†æ—¶é—´")
            .register(meterRegistry);
            
        this.tokenValidationTimer = Timer.builder("auth.token.validation.duration")
            .description("TokenéªŒè¯æ—¶é—´")
            .register(meterRegistry);
            
        this.activeSessionGauge = Gauge.builder("auth.sessions.active")
            .description("æ´»è·ƒä¼šè¯æ•°")
            .register(meterRegistry, sessionRegistry, SessionRegistry::getSessionCount);
    }
    
    public void recordSuccessfulLogin(String method) {
        loginSuccessCounter.increment(Tags.of("method", method));
    }
    
    public void recordFailedLogin(String reason, String method) {
        loginFailureCounter.increment(Tags.of("reason", reason, "method", method));
    }
    
    public Timer.Sample startLoginTimer() {
        return Timer.start(loginTimer);
    }
    
    public Timer.Sample startTokenValidationTimer() {
        return Timer.start(tokenValidationTimer);
    }
}
```

**ç™»å½•ç›‘æ§åˆ‡é¢**:
```java
@Aspect
@Component
public class LoginMonitoringAspect {
    
    @Autowired
    private AuthMetrics authMetrics;
    
    @Around("@annotation(com.example.annotation.MonitorLogin)")
    public Object monitorLogin(ProceedingJoinPoint joinPoint) throws Throwable {
        Timer.Sample sample = authMetrics.startLoginTimer();
        
        try {
            Object result = joinPoint.proceed();
            
            // æˆåŠŸç™»å½•
            authMetrics.recordSuccessfulLogin("password");
            
            return result;
            
        } catch (AuthenticationException e) {
            // ç™»å½•å¤±è´¥
            String reason = determineFailureReason(e);
            authMetrics.recordFailedLogin(reason, "password");
            
            throw e;
        } finally {
            sample.stop();
        }
    }
    
    private String determineFailureReason(AuthenticationException e) {
        if (e instanceof BadCredentialsException) {
            return "invalid_credentials";
        } else if (e instanceof AccountLockedException) {
            return "account_locked";
        } else if (e instanceof AccountExpiredException) {
            return "account_expired";
        }
        return "unknown";
    }
}
```

### 8.3 è®¤è¯æ—¥å¿—è®°å½•è§„èŒƒ


**ç»Ÿä¸€æ—¥å¿—æ ¼å¼**:
```java
@Component
public class AuthLogger {
    
    private final Logger securityLogger = LoggerFactory.getLogger("SECURITY");
    private final Logger auditLogger = LoggerFactory.getLogger("AUDIT");
    
    public void logSuccessfulLogin(LoginEvent event) {
        auditLogger.info("LOGIN_SUCCESS|user={}|ip={}|userAgent={}|sessionId={}|timestamp={}",
            event.getUsername(),
            event.getClientIp(),
            event.getUserAgent(),
            event.getSessionId(),
            Instant.now());
    }
    
    public void logFailedLogin(LoginEvent event, String reason) {
        securityLogger.warn("LOGIN_FAILURE|user={}|ip={}|reason={}|userAgent={}|timestamp={}",
            event.getUsername(),
            event.getClientIp(),
            reason,
            event.getUserAgent(),
            Instant.now());
    }
    
    public void logSuspiciousActivity(String userId, String activity, String details) {
        securityLogger.error("SUSPICIOUS_ACTIVITY|user={}|activity={}|details={}|timestamp={}",
            userId, activity, details, Instant.now());
    }
    
    public void logTokenOperation(String operation, String tokenId, String userId) {
        auditLogger.info("TOKEN_OPERATION|operation={}|tokenId={}|userId={}|timestamp={}",
            operation, tokenId, userId, Instant.now());
    }
}
```

### 8.4 å¸¸è§è®¤è¯æ•…éšœæ’æŸ¥


**æ•…éšœæ’æŸ¥æ‰‹å†Œ**:

ğŸ” **ç™»å½•å¤±è´¥é—®é¢˜**:
```
æ•…éšœç°è±¡ï¼šç”¨æˆ·æ— æ³•ç™»å½•
æ’æŸ¥æ­¥éª¤ï¼š
1. æ£€æŸ¥ç”¨æˆ·è´¦å·çŠ¶æ€ï¼ˆæ˜¯å¦é”å®šã€è¿‡æœŸï¼‰
2. éªŒè¯å¯†ç ç­–ç•¥ï¼ˆå¤æ‚åº¦ã€å†å²å¯†ç ï¼‰
3. æŸ¥çœ‹ç™»å½•æ—¥å¿—ï¼Œç¡®è®¤å¤±è´¥åŸå› 
4. æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒæœåŠ¡çŠ¶æ€
5. éªŒè¯æ•°æ®åº“è¿æ¥å’Œç”¨æˆ·è¡¨æ•°æ®

å¸¸ç”¨å‘½ä»¤ï¼š
# æŸ¥çœ‹ç”¨æˆ·çŠ¶æ€
SELECT * FROM users WHERE username = 'xxx';
# æŸ¥çœ‹ç™»å½•æ—¥å¿—
grep "LOGIN_FAILURE" /var/log/auth.log | tail -20
```

ğŸ” **TokenéªŒè¯å¤±è´¥**:
```
æ•…éšœç°è±¡ï¼šAPIè®¿é—®è¿”å›401æœªæˆæƒ
æ’æŸ¥æ­¥éª¤ï¼š
1. éªŒè¯Tokenæ ¼å¼å’Œç­¾å
2. æ£€æŸ¥Tokenæ˜¯å¦è¿‡æœŸ
3. ç¡®è®¤Tokenæ˜¯å¦åœ¨é»‘åå•ä¸­
4. éªŒè¯å¯†é’¥é…ç½®æ˜¯å¦ä¸€è‡´
5. æ£€æŸ¥æ—¶é’ŸåŒæ­¥é—®é¢˜

æ’æŸ¥å·¥å…·ï¼š
# è§£æJWT Token
echo "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9..." | base64 -d
# æ£€æŸ¥Redisé»‘åå•
redis-cli SISMEMBER token:blacklist "token-id"
```

ğŸ” **ä¼šè¯ä¸¢å¤±é—®é¢˜**:
```
æ•…éšœç°è±¡ï¼šç”¨æˆ·é¢‘ç¹éœ€è¦é‡æ–°ç™»å½•
æ’æŸ¥æ­¥éª¤ï¼š
1. æ£€æŸ¥Sessionè¶…æ—¶é…ç½®
2. éªŒè¯Redisè¿æ¥çŠ¶æ€
3. æŸ¥çœ‹Sessionå­˜å‚¨æƒ…å†µ
4. æ£€æŸ¥è´Ÿè½½å‡è¡¡é…ç½®
5. ç¡®è®¤Cookieè®¾ç½®

æ’æŸ¥å‘½ä»¤ï¼š
# æ£€æŸ¥Redisä¸­çš„Session
redis-cli KEYS "spring:session:*"
# æŸ¥çœ‹Sessionè¯¦æƒ…
redis-cli HGETALL "spring:session:sessions:xxx"
```

### 8.5 è®¤è¯é“¾è·¯è¿½è¸ª


**åˆ†å¸ƒå¼è¿½è¸ªå®ç°**:
```java
@Component
public class AuthTracingService {
    
    private final Tracer tracer;
    
    public AuthTracingService(Tracer tracer) {
        this.tracer = tracer;
    }
    
    public Span startLoginTrace(String username, String clientIp) {
        return tracer.nextSpan()
            .name("user-login")
            .tag("username", username)
            .tag("client.ip", clientIp)
            .tag("auth.method", "password")
            .start();
    }
    
    public Span startTokenValidationTrace(String tokenType) {
        return tracer.nextSpan()
            .name("token-validation")
            .tag("token.type", tokenType)
            .tag("auth.step", "validation")
            .start();
    }
    
    public void recordAuthEvent(Span span, String event, String result) {
        span.tag("auth.event", event)
            .tag("auth.result", result);
            
        if ("failure".equals(result)) {
            span.tag("error", "true");
        }
    }
}

// ä½¿ç”¨ç¤ºä¾‹
@Service
public class LoginService {
    
    @Autowired
    private AuthTracingService tracingService;
    
    public LoginResult login(String username, String password, String clientIp) {
        Span loginSpan = tracingService.startLoginTrace(username, clientIp);
        
        try (Tracer.SpanInScope ws = tracer.withSpanInScope(loginSpan)) {
            
            // ç”¨æˆ·éªŒè¯
            Span validationSpan = tracer.nextSpan()
                .name("credential-validation")
                .start();
                
            try (Tracer.SpanInScope ws2 = tracer.withSpanInScope(validationSpan)) {
                User user = authenticateUser(username, password);
                validationSpan.tag("validation.result", "success");
                
                // Tokenç”Ÿæˆ
                Span tokenSpan = tracer.nextSpan()
                    .name("token-generation")
                    .start();
                    
                try (Tracer.SpanInScope ws3 = tracer.withSpanInScope(tokenSpan)) {
                    String token = generateToken(user);
                    tokenSpan.tag("token.generated", "true");
                    
                    tracingService.recordAuthEvent(loginSpan, "login", "success");
                    return new LoginResult(true, token);
                    
                } finally {
                    tokenSpan.end();
                }
                
            } catch (AuthenticationException e) {
                validationSpan.tag("validation.result", "failure")
                            .tag("failure.reason", e.getMessage());
                tracingService.recordAuthEvent(loginSpan, "login", "failure");
                throw e;
            } finally {
                validationSpan.end();
            }
            
        } finally {
            loginSpan.end();
        }
    }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Tokenç»­ç­¾ï¼šåŒTokenæœºåˆ¶ï¼Œä¿è¯ç”¨æˆ·ä½“éªŒå’Œå®‰å…¨æ€§çš„å¹³è¡¡
ğŸ”¸ å¤šèŠ‚ç‚¹ä¸€è‡´æ€§ï¼šJWTæ— çŠ¶æ€ç‰¹æ€§è§£å†³åˆ†å¸ƒå¼è®¤è¯é—®é¢˜
ğŸ”¸ Redisç®¡ç†ï¼šé›†ä¸­å­˜å‚¨TokençŠ¶æ€ã€é»‘åå•ã€æƒé™ä¿¡æ¯
ğŸ”¸ å¤šç§Ÿæˆ·éš”ç¦»ï¼šæ•°æ®éš”ç¦»ã€æƒé™éš”ç¦»ã€è®¿é—®éš”ç¦»ä¸‰ä¸ªå±‚é¢
ğŸ”¸ åˆ†å¸ƒå¼ä¼šè¯ï¼šRedisé›†ä¸­å­˜å‚¨è§£å†³Sessionå…±äº«é—®é¢˜
ğŸ”¸ æ–¹æ¡ˆé€‰æ‹©ï¼šæ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰æ‹©Tokenè¿˜æ˜¯Session
ğŸ”¸ SSOå®ç°ï¼šç»Ÿä¸€è®¤è¯å…¥å£ï¼Œç¥¨æ®éªŒè¯æœºåˆ¶
ğŸ”¸ ç›‘æ§è¿ç»´ï¼šæ€§èƒ½æŒ‡æ ‡ã€å®‰å…¨æŒ‡æ ‡ã€æ•…éšœæ’æŸ¥
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆéœ€è¦ç»­ç­¾æœºåˆ¶**:
```
ç”¨æˆ·ä½“éªŒï¼šé¿å…é¢‘ç¹é‡æ–°ç™»å½•
å®‰å…¨è€ƒè™‘ï¼šçŸ­æœŸTokené™ä½æ³„éœ²é£é™©
ç³»ç»Ÿè®¾è®¡ï¼šåŒTokenåˆ†ç¦»è®¿é—®å’Œåˆ·æ–°èŒè´£
æŠ€æœ¯å®ç°ï¼šå‰ç«¯è‡ªåŠ¨ç»­ç­¾ï¼Œç”¨æˆ·æ— æ„ŸçŸ¥
```

**ğŸ”¹ åˆ†å¸ƒå¼è®¤è¯çš„æ ¸å¿ƒæŒ‘æˆ˜**:
```
çŠ¶æ€åŒæ­¥ï¼šå¤šèŠ‚ç‚¹é—´çš„è®¤è¯çŠ¶æ€ä¸€è‡´æ€§
æ€§èƒ½è€ƒè™‘ï¼šéªŒè¯æ•ˆç‡å’Œå­˜å‚¨å¼€é”€çš„å¹³è¡¡
å®‰å…¨è¦æ±‚ï¼šTokenæ’¤é”€å’Œæƒé™å˜æ›´çš„å®æ—¶æ€§
æ‰©å±•æ€§ï¼šç³»ç»Ÿè§„æ¨¡å¢é•¿æ—¶çš„æ¶æ„é€‚åº”æ€§
```

**ğŸ”¹ å¤šç§Ÿæˆ·éš”ç¦»çš„é‡è¦æ€§**:
```
æ•°æ®å®‰å…¨ï¼šé˜²æ­¢ç§Ÿæˆ·é—´æ•°æ®æ³„éœ²
æƒé™ç®¡ç†ï¼šç§Ÿæˆ·å†…éƒ¨çš„ç²¾ç»†åŒ–æƒé™æ§åˆ¶
ç³»ç»Ÿæ¶æ„ï¼šå…±äº«èµ„æºå’Œç‹¬ç«‹ç®¡ç†çš„å¹³è¡¡
åˆè§„è¦æ±‚ï¼šæ»¡è¶³ä¸åŒè¡Œä¸šçš„åˆè§„æ ‡å‡†
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ“Š æŠ€æœ¯é€‰å‹å»ºè®®**:

| åœºæ™¯ç±»å‹ | æ¨èæ–¹æ¡ˆ | ç†ç”± |
|---------|---------|------|
| **å¾®æœåŠ¡æ¶æ„** | JWT + Redisé»‘åå• | æ— çŠ¶æ€ï¼Œæ˜“æ‰©å±• |
| **å•ä½“åº”ç”¨** | Session + Rediså­˜å‚¨ | ç®€å•ï¼ŒåŠŸèƒ½å®Œæ•´ |
| **ç§»åŠ¨åº”ç”¨** | åŒTokenç»­ç­¾ | ç”¨æˆ·ä½“éªŒå¥½ |
| **ä¼ä¸šå†…ç½‘** | SSO + RBAC | ç»Ÿä¸€ç®¡ç†ï¼Œæƒé™æ¸…æ™° |
| **å¤šç§Ÿæˆ·SaaS** | JWT + ç§Ÿæˆ·éš”ç¦» | æ‰©å±•æ€§å¥½ï¼Œéš”ç¦»æ€§å¼º |

**ğŸ”§ å®æ–½è¦ç‚¹**:
- **æ¸è¿›å¼æ”¹é€ **: ä»å•ä½“åˆ°å¾®æœåŠ¡é€æ­¥æ¼”è¿›
- **ç›‘æ§å…ˆè¡Œ**: å…ˆå»ºç«‹ç›‘æ§ä½“ç³»å†ä¼˜åŒ–æ€§èƒ½
- **å®‰å…¨ä¼˜å…ˆ**: æƒé™æ§åˆ¶å’Œæ•°æ®éš”ç¦»ä¸èƒ½å¦¥å
- **ç”¨æˆ·ä½“éªŒ**: åœ¨å®‰å…¨å’Œä¾¿åˆ©æ€§ä¹‹é—´æ‰¾åˆ°å¹³è¡¡

**ğŸ’¡ æœ€ä½³å®è·µæ€»ç»“**:
```
æ¶æ„è®¾è®¡ï¼š
âœ… è®¤è¯ä¸­å¿ƒç‹¬ç«‹éƒ¨ç½²ï¼Œé¿å…å•ç‚¹æ•…éšœ
âœ… ä½¿ç”¨Redisé›†ç¾¤ä¿è¯é«˜å¯ç”¨
âœ… å®æ–½å¤šå±‚ç¼“å­˜æå‡æ€§èƒ½
âœ… å»ºç«‹å®Œå–„çš„ç›‘æ§å‘Šè­¦æœºåˆ¶

å®‰å…¨é˜²æŠ¤ï¼š
âœ… TokenåŠ å¯†å­˜å‚¨ï¼Œå®šæœŸè½®æ¢å¯†é’¥
âœ… å®æ–½é»‘åå•æœºåˆ¶ï¼Œæ”¯æŒå³æ—¶æ’¤é”€
âœ… ç›‘æ§å¼‚å¸¸ç™»å½•ï¼ŒåŠæ—¶å‘ç°å®‰å…¨å¨èƒ
âœ… å®ç°å¤šå› å­è®¤è¯å¢å¼ºå®‰å…¨æ€§

æ€§èƒ½ä¼˜åŒ–ï¼š
âœ… æœ¬åœ°ç¼“å­˜å‡å°‘Redisè®¿é—®
âœ… æ‰¹é‡æ“ä½œä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢
âœ… å¼‚æ­¥å¤„ç†æå‡ç”¨æˆ·ä½“éªŒ
âœ… CDNåŠ é€Ÿé™æ€èµ„æºåŠ è½½

è¿ç»´ä¿éšœï¼š
âœ… å®Œå–„çš„æ—¥å¿—è®°å½•å’Œå®¡è®¡
âœ… è‡ªåŠ¨åŒ–éƒ¨ç½²å’Œå›æ»šæœºåˆ¶
âœ… å®šæœŸå®‰å…¨æ‰«æå’Œæ¸—é€æµ‹è¯•
âœ… å»ºç«‹åº”æ€¥å“åº”é¢„æ¡ˆ
```

### 9.4 æ‰©å±•å­¦ä¹ æ–¹å‘


**ğŸš€ æ·±å…¥å­¦ä¹ å»ºè®®**:
- ğŸ” **OAuth 2.0/OpenID Connect**: æ ‡å‡†åŒ–çš„æˆæƒå’Œè®¤è¯åè®®
- ğŸ›¡ï¸ **é›¶ä¿¡ä»»æ¶æ„**: ç°ä»£å®‰å…¨æ¶æ„è®¾è®¡ç†å¿µ
- ğŸŒ **SAMLè”åˆè®¤è¯**: ä¼ä¸šçº§èº«ä»½è”åˆè§£å†³æ–¹æ¡ˆ
- ğŸ”‘ **å¯†ç å­¦åŸºç¡€**: åŠ å¯†ç®—æ³•å’Œæ•°å­—ç­¾ååŸç†
- ğŸ“Š **å®‰å…¨å®¡è®¡**: åˆè§„æ€§è¦æ±‚å’Œå®¡è®¡å®è·µ

**ğŸ”§ å®æˆ˜é¡¹ç›®æ¨è**:
- æ„å»ºä¼ä¸šçº§SSOè®¤è¯ä¸­å¿ƒ
- å®ç°å¤šç§Ÿæˆ·SaaSæƒé™ç³»ç»Ÿ
- å¼€å‘ç§»åŠ¨ç«¯å®‰å…¨è®¤è¯SDK
- è®¾è®¡åˆ†å¸ƒå¼ä¼šè¯ç®¡ç†æ–¹æ¡ˆ

**æ ¸å¿ƒè®°å¿†å£è¯€**:
```
è®¤è¯ä¸­å¿ƒè¦é«˜å¯ç”¨ï¼ŒTokenç»­ç­¾ç”¨æˆ·æ— æ„ŸçŸ¥
å¤šèŠ‚ç‚¹å…±äº«ç”¨JWTï¼Œé»‘åå•æœºåˆ¶é˜²æ³„éœ²
Redisé›†ç¾¤å­˜çŠ¶æ€ï¼Œç§Ÿæˆ·éš”ç¦»ä¿å®‰å…¨
SSOç»Ÿä¸€ç”¨æˆ·ä½“éªŒï¼Œç›‘æ§æ—¥å¿—åŠ©è¿ç»´
```