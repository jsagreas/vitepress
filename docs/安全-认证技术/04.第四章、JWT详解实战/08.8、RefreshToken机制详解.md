---
title: 8ã€RefreshTokenæœºåˆ¶è¯¦è§£
---
## ğŸ“š ç›®å½•

1. [RefreshTokenåŸºæœ¬æ¦‚å¿µ](#1-refreshtokenåŸºæœ¬æ¦‚å¿µ)
2. [åŒTokenæ¨¡å¼åŸç†](#2-åŒtokenæ¨¡å¼åŸç†)
3. [åˆ·æ–°æµç¨‹ä¸å®ç°](#3-åˆ·æ–°æµç¨‹ä¸å®ç°)
4. [å®‰å…¨æœºåˆ¶è®¾è®¡](#4-å®‰å…¨æœºåˆ¶è®¾è®¡)
5. [å¤šç«¯ç™»å½•å¤„ç†](#5-å¤šç«¯ç™»å½•å¤„ç†)
6. [æ— æ„Ÿåˆ·æ–°å®ç°](#6-æ— æ„Ÿåˆ·æ–°å®ç°)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”‘ RefreshTokenåŸºæœ¬æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯RefreshToken


**ğŸ”¸ ç®€å•ç†è§£**
æƒ³è±¡ä½ å»å›¾ä¹¦é¦†å€Ÿä¹¦ï¼š
- **å€Ÿä¹¦å¡ï¼ˆAccessTokenï¼‰**ï¼šç”¨æ¥å€Ÿä¹¦ï¼Œä½†æœ‰æ•ˆæœŸå¾ˆçŸ­ï¼ˆæ¯”å¦‚1å°æ—¶ï¼‰
- **èº«ä»½è¯ï¼ˆRefreshTokenï¼‰**ï¼šè¯æ˜ä½ çš„èº«ä»½ï¼Œæœ‰æ•ˆæœŸå¾ˆé•¿ï¼ˆæ¯”å¦‚1ä¸ªæœˆï¼‰
- å½“å€Ÿä¹¦å¡è¿‡æœŸæ—¶ï¼Œç”¨èº«ä»½è¯å»æ¢æ–°çš„å€Ÿä¹¦å¡ï¼Œä¸ç”¨é‡æ–°åŠç†æ‰€æœ‰æ‰‹ç»­

**ğŸ”¸ æŠ€æœ¯å®šä¹‰**
RefreshTokenæ˜¯ä¸€ä¸ª**é•¿æœŸæœ‰æ•ˆçš„ä»¤ç‰Œ**ï¼Œä¸“é—¨ç”¨æ¥è·å–æ–°çš„AccessTokenï¼Œè€Œä¸éœ€è¦ç”¨æˆ·é‡æ–°è¾“å…¥ç”¨æˆ·åå¯†ç ã€‚

### 1.2 AccessToken vs RefreshTokenå¯¹æ¯”


| ç‰¹å¾ | **AccessToken** | **RefreshToken** | **å½¢è±¡ç±»æ¯”** |
|------|----------------|------------------|-------------|
| ğŸ• **æœ‰æ•ˆæœŸ** | `çŸ­æœŸ(15åˆ†é’Ÿ-2å°æ—¶)` | `é•¿æœŸ(7å¤©-30å¤©)` | `ä¸´æ—¶é€šè¡Œè¯ vs é•¿æœŸèº«ä»½è¯` |
| ğŸ¯ **ä½œç”¨** | `è®¿é—®å—ä¿æŠ¤èµ„æº` | `è·å–æ–°AccessToken` | `é’¥åŒ™ vs é’¥åŒ™åˆ¶é€ æœº` |
| ğŸ“ **å­˜å‚¨ä½ç½®** | `å†…å­˜/SessionStorage` | `å®‰å…¨å­˜å‚¨/HttpOnly Cookie` | `å£è¢‹é‡Œ vs ä¿é™©ç®±é‡Œ` |
| ğŸ”„ **ä½¿ç”¨é¢‘ç‡** | `æ¯æ¬¡APIè°ƒç”¨` | `åªåœ¨Tokenè¿‡æœŸæ—¶` | `é¢‘ç¹ä½¿ç”¨ vs å¶å°”ä½¿ç”¨` |
| ğŸ›¡ï¸ **å®‰å…¨çº§åˆ«** | `ä¸­ç­‰(é¢‘ç¹ä¼ è¾“)` | `é«˜(å¾ˆå°‘ä¼ è¾“)` | `æ—¥å¸¸é’¥åŒ™ vs å¤‡ç”¨é’¥åŒ™` |

### 1.3 ä¸ºä»€ä¹ˆéœ€è¦RefreshToken


**ğŸ¤” æ²¡æœ‰RefreshTokenä¼šæ€æ ·ï¼Ÿ**

```
ç”¨æˆ·ç™»å½• â”€â”€â”€â”€â–¶ è·å¾—AccessToken(24å°æ—¶æœ‰æ•ˆ)
     â”‚
     â–¼
å·¥ä½œä¸€æ•´å¤©ï¼ŒTokenåœ¨ä¸‹åˆ3ç‚¹è¿‡æœŸ
     â”‚
     â–¼
âŒ ç”¨æˆ·å¿…é¡»é‡æ–°ç™»å½•ï¼Œè¾“å…¥ç”¨æˆ·åå¯†ç 
```

**âœ… æœ‰RefreshTokençš„å¥½å¤„**

```
ç”¨æˆ·ä½“éªŒè§’åº¦ï¼š
â€¢ å‡å°‘é‡å¤ç™»å½•çš„çƒ¦æ¼
â€¢ ä¿æŒç™»å½•çŠ¶æ€çš„è¿ç»­æ€§
â€¢ ç”¨æˆ·å‡ ä¹æ„Ÿè§‰ä¸åˆ°Tokenæ›´æ–°

å®‰å…¨è§’åº¦ï¼š
â€¢ AccessTokençŸ­æœŸæœ‰æ•ˆï¼Œè¢«ç›—ç”¨é£é™©å°
â€¢ RefreshTokenä¸ç”¨äºæ—¥å¸¸APIè°ƒç”¨ï¼Œæš´éœ²æœºä¼šå°‘
â€¢ å¯ä»¥å•ç‹¬æ’¤é”€RefreshTokenï¼Œå¼ºåˆ¶é‡æ–°ç™»å½•
```

---

## 2. âš–ï¸ åŒTokenæ¨¡å¼åŸç†


### 2.1 åŒTokenè®¾è®¡æ€è·¯


**ğŸ¯ æ ¸å¿ƒæ€æƒ³**ï¼š**èŒè´£åˆ†ç¦»**

```
ğŸ“ ç±»æ¯”ç†è§£ï¼š
å°±åƒé“¶è¡Œå¡å’Œèº«ä»½è¯çš„å…³ç³»ï¼š

é“¶è¡Œå¡(AccessToken)ï¼š
â€¢ ç”¨æ¥æ—¥å¸¸æ¶ˆè´¹ï¼Œä½†é¢åº¦æœ‰é™ã€æœŸé™è¾ƒçŸ­
â€¢ ä¸¢å¤±äº†å½±å“ç›¸å¯¹è¾ƒå°ï¼Œå¯ä»¥å¿«é€ŸæŒ‚å¤±

èº«ä»½è¯(RefreshToken)ï¼š
â€¢ ç”¨æ¥åŠç†é‡è¦ä¸šåŠ¡ï¼Œè¯æ˜èº«ä»½
â€¢ å¾ˆå°‘æ‹¿å‡ºæ¥ä½¿ç”¨ï¼Œä¸¢å¤±å½±å“å¤§
â€¢ ç”¨å®ƒå¯ä»¥è¡¥åŠæ–°çš„é“¶è¡Œå¡
```

### 2.2 åŒTokenå·¥ä½œæµç¨‹å›¾


```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    ç™»å½•è¯·æ±‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·å®¢æˆ·ç«¯     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚   è®¤è¯æœåŠ¡å™¨     â”‚
â”‚                â”‚               â”‚                 â”‚
â”‚                â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚
â”‚                â”‚  è¿”å›åŒToken   â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                  â”‚
         â–¼                                  â”‚
   å­˜å‚¨Tokenï¼š                              â”‚
   â€¢ AccessToken(å†…å­˜)                      â”‚
   â€¢ RefreshToken(å®‰å…¨å­˜å‚¨)                 â”‚
         â”‚                                  â”‚
         â–¼                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    APIè¯·æ±‚+AT   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä¸šåŠ¡APIè°ƒç”¨   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚   èµ„æºæœåŠ¡å™¨     â”‚
â”‚                â”‚               â”‚                 â”‚
â”‚                â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚
â”‚                â”‚   è¿”å›æ•°æ®     â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
   AccessTokenè¿‡æœŸï¼Ÿ
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
    â”‚   æ˜¯     â”‚         ä¸æ˜¯
    â–¼          â–¼          â”‚
ä½¿ç”¨RefreshToken â”€â”€â”€â”€â”€â”€â”€â”€â”˜
è·å–æ–°AccessToken
```

### 2.3 Tokenç”Ÿå‘½å‘¨æœŸç®¡ç†


**ğŸ”„ TokençŠ¶æ€è½¬æ¢å›¾**

```
[ç”¨æˆ·ç™»å½•] â”€â”€â–¶ [åŒTokenç”Ÿæˆ] â”€â”€â–¶ [æ­£å¸¸ä½¿ç”¨é˜¶æ®µ]
                      â”‚              â”‚
                      â–¼              â–¼
              [RefreshToken     [AccessToken
               é•¿æœŸæœ‰æ•ˆ]         çŸ­æœŸæœ‰æ•ˆ]
                      â”‚              â”‚
                      â”‚              â–¼
                      â”‚        [Tokenå¿«è¿‡æœŸ]
                      â”‚              â”‚
                      â”‚              â–¼
                      â””â”€â”€â”€â”€â”€â–¶ [è‡ªåŠ¨åˆ·æ–°Token]
                                     â”‚
                                     â–¼
                             [è·å¾—æ–°AccessToken]
                                     â”‚
                                     â–¼
                              [ç»§ç»­æ­£å¸¸ä½¿ç”¨]
```

---

## 3. ğŸ”„ åˆ·æ–°æµç¨‹ä¸å®ç°


### 3.1 Tokenåˆ·æ–°çš„è§¦å‘æ—¶æœº


**ğŸ• ä¸‰ç§åˆ·æ–°ç­–ç•¥**

```
1ï¸âƒ£ è¢«åŠ¨åˆ·æ–°ï¼šAccessTokenè¿‡æœŸåæ‰åˆ·æ–°
   ä¼˜ç‚¹ï¼šèŠ‚çœæœåŠ¡å™¨èµ„æº
   ç¼ºç‚¹ï¼šç”¨æˆ·å¯èƒ½æ„ŸçŸ¥åˆ°å»¶è¿Ÿ

2ï¸âƒ£ ä¸»åŠ¨åˆ·æ–°ï¼šAccessTokenå¿«è¿‡æœŸæ—¶æå‰åˆ·æ–°
   ä¼˜ç‚¹ï¼šç”¨æˆ·ä½“éªŒæ›´å¥½
   ç¼ºç‚¹ï¼šå¢åŠ æœåŠ¡å™¨è¯·æ±‚

3ï¸âƒ£ å®šæœŸåˆ·æ–°ï¼šæŒ‰å›ºå®šæ—¶é—´é—´éš”åˆ·æ–°
   ä¼˜ç‚¹ï¼šå¯é¢„æµ‹çš„åˆ·æ–°æ—¶é—´
   ç¼ºç‚¹ï¼šå¯èƒ½äº§ç”Ÿä¸å¿…è¦çš„åˆ·æ–°
```

### 3.2 åˆ·æ–°æµç¨‹è¯¦ç»†æ­¥éª¤


**ğŸ“‹ å®Œæ•´åˆ·æ–°æµç¨‹**

```
æ­¥éª¤1ï¼šæ£€æµ‹AccessTokençŠ¶æ€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯å‘èµ·APIè¯·æ±‚             â”‚
â”‚ â”œâ”€ æ£€æŸ¥AccessTokenæ˜¯å¦å­˜åœ¨    â”‚
â”‚ â”œâ”€ æ£€æŸ¥AccessTokenæ˜¯å¦è¿‡æœŸ    â”‚
â”‚ â””â”€ åˆ¤æ–­æ˜¯å¦éœ€è¦åˆ·æ–°         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
æ­¥éª¤2ï¼šå‘èµ·åˆ·æ–°è¯·æ±‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /auth/refresh          â”‚
â”‚ Headers:                    â”‚
â”‚   Authorization: Bearer RT  â”‚
â”‚ Body:                       â”‚
â”‚   {                        â”‚
â”‚     "refreshToken": "xxx"   â”‚
â”‚   }                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
æ­¥éª¤3ï¼šæœåŠ¡å™¨éªŒè¯å’Œå“åº”
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æœåŠ¡å™¨ç«¯å¤„ç†ï¼š               â”‚
â”‚ â”œâ”€ éªŒè¯RefreshTokenæœ‰æ•ˆæ€§    â”‚
â”‚ â”œâ”€ æ£€æŸ¥Tokenæ˜¯å¦è¢«æ’¤é”€       â”‚
â”‚ â”œâ”€ ç”Ÿæˆæ–°çš„AccessToken      â”‚
â”‚ â””â”€ å¯é€‰ï¼šç”Ÿæˆæ–°RefreshToken  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
æ­¥éª¤4ï¼šæ›´æ–°æœ¬åœ°Token
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®¢æˆ·ç«¯æ”¶åˆ°å“åº”åï¼š           â”‚
â”‚ â”œâ”€ æ›´æ–°AccessToken          â”‚
â”‚ â”œâ”€ æ›´æ–°RefreshToken(å¯é€‰)   â”‚
â”‚ â””â”€ é‡æ–°å‘èµ·åŸå§‹APIè¯·æ±‚       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 å‰ç«¯åˆ·æ–°Tokenå®ç°


```javascript
// ğŸ”§ Tokenç®¡ç†ç±»
class TokenManager {
    constructor() {
        this.accessToken = localStorage.getItem('accessToken');
        this.refreshToken = localStorage.getItem('refreshToken');
        this.refreshPromise = null; // é˜²æ­¢é‡å¤åˆ·æ–°
    }
    
    // âœ… æ£€æŸ¥Tokenæ˜¯å¦å³å°†è¿‡æœŸï¼ˆæå‰5åˆ†é’Ÿåˆ·æ–°ï¼‰
    isTokenExpiringSoon() {
        if (!this.accessToken) return true;
        
        try {
            const payload = JSON.parse(atob(this.accessToken.split('.')[1]));
            const now = Math.floor(Date.now() / 1000);
            return (payload.exp - now) < 300; // 5åˆ†é’Ÿå†…è¿‡æœŸ
        } catch (error) {
            return true;
        }
    }
    
    // ğŸ”„ åˆ·æ–°Token
    async refreshAccessToken() {
        // é˜²æ­¢å¹¶å‘åˆ·æ–°
        if (this.refreshPromise) {
            return this.refreshPromise;
        }
        
        this.refreshPromise = this._doRefresh();
        
        try {
            const result = await this.refreshPromise;
            return result;
        } finally {
            this.refreshPromise = null;
        }
    }
    
    // å®é™…çš„åˆ·æ–°é€»è¾‘
    async _doRefresh() {
        if (!this.refreshToken) {
            throw new Error('æ²¡æœ‰RefreshTokenï¼Œéœ€è¦é‡æ–°ç™»å½•');
        }
        
        try {
            const response = await fetch('/api/auth/refresh', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${this.refreshToken}`
                }
            });
            
            if (!response.ok) {
                throw new Error('åˆ·æ–°Tokenå¤±è´¥');
            }
            
            const data = await response.json();
            
            // æ›´æ–°Token
            this.accessToken = data.accessToken;
            this.refreshToken = data.refreshToken || this.refreshToken;
            
            // å­˜å‚¨åˆ°æœ¬åœ°
            localStorage.setItem('accessToken', this.accessToken);
            localStorage.setItem('refreshToken', this.refreshToken);
            
            return this.accessToken;
        } catch (error) {
            // åˆ·æ–°å¤±è´¥ï¼Œæ¸…é™¤Tokenï¼Œè·³è½¬ç™»å½•
            this.clearTokens();
            window.location.href = '/login';
            throw error;
        }
    }
    
    // æ¸…é™¤æ‰€æœ‰Token
    clearTokens() {
        this.accessToken = null;
        this.refreshToken = null;
        localStorage.removeItem('accessToken');
        localStorage.removeItem('refreshToken');
    }
}
```

### 3.4 åç«¯åˆ·æ–°Tokenå®ç°


```java
@RestController
@RequestMapping("/api/auth")
public class AuthController {
    
    @Autowired
    private TokenService tokenService;
    
    @Autowired
    private RedisTemplate redisTemplate;
    
    // ğŸ”„ åˆ·æ–°Tokenç«¯ç‚¹
    @PostMapping("/refresh")
    public ResponseEntity<?> refreshToken(HttpServletRequest request) {
        try {
            // 1. ä»è¯·æ±‚å¤´è·å–RefreshToken
            String refreshToken = extractTokenFromHeader(request);
            
            if (refreshToken == null) {
                return ResponseEntity.status(401)
                    .body(Map.of("error", "ç¼ºå°‘RefreshToken"));
            }
            
            // 2. éªŒè¯RefreshToken
            if (!tokenService.validateRefreshToken(refreshToken)) {
                return ResponseEntity.status(401)
                    .body(Map.of("error", "RefreshTokenæ— æ•ˆæˆ–å·²è¿‡æœŸ"));
            }
            
            // 3. æ£€æŸ¥Tokenæ˜¯å¦è¢«æ’¤é”€ï¼ˆé»‘åå•æ£€æŸ¥ï¼‰
            String tokenId = tokenService.getTokenId(refreshToken);
            if (redisTemplate.hasKey("blacklist:refresh:" + tokenId)) {
                return ResponseEntity.status(401)
                    .body(Map.of("error", "RefreshTokenå·²è¢«æ’¤é”€"));
            }
            
            // 4. è·å–ç”¨æˆ·ä¿¡æ¯
            String userId = tokenService.getUserIdFromToken(refreshToken);
            User user = userService.findById(userId);
            
            // 5. ç”Ÿæˆæ–°çš„AccessToken
            String newAccessToken = tokenService.generateAccessToken(user);
            
            // 6. å¯é€‰ï¼šç”Ÿæˆæ–°çš„RefreshTokenï¼ˆTokenè½®æ¢ç­–ç•¥ï¼‰
            String newRefreshToken = tokenService.generateRefreshToken(user);
            
            // 7. å°†æ—§çš„RefreshTokenåŠ å…¥é»‘åå•ï¼ˆå¦‚æœä½¿ç”¨äº†Tokenè½®æ¢ï¼‰
            if (newRefreshToken != null) {
                redisTemplate.setex("blacklist:refresh:" + tokenId, 
                    Duration.ofDays(30), "revoked");
            }
            
            // 8. è¿”å›æ–°Token
            Map<String, Object> response = new HashMap<>();
            response.put("accessToken", newAccessToken);
            response.put("refreshToken", newRefreshToken);
            response.put("tokenType", "Bearer");
            response.put("expiresIn", 3600); // 1å°æ—¶
            
            return ResponseEntity.ok(response);
            
        } catch (Exception e) {
            return ResponseEntity.status(500)
                .body(Map.of("error", "Tokenåˆ·æ–°å¤±è´¥"));
        }
    }
    
    // æå–Tokençš„è¾…åŠ©æ–¹æ³•
    private String extractTokenFromHeader(HttpServletRequest request) {
        String bearerToken = request.getHeader("Authorization");
        if (bearerToken != null && bearerToken.startsWith("Bearer ")) {
            return bearerToken.substring(7);
        }
        return null;
    }
}
```

---

## 4. ğŸ›¡ï¸ å®‰å…¨æœºåˆ¶è®¾è®¡


### 4.1 RefreshTokenå®‰å…¨å­˜å‚¨


**ğŸ”’ å­˜å‚¨ä½ç½®é€‰æ‹©**

| å­˜å‚¨æ–¹å¼ | **å®‰å…¨æ€§** | **æ˜“ç”¨æ€§** | **é€‚ç”¨åœºæ™¯** | **æ½œåœ¨é£é™©** |
|---------|-----------|-----------|-------------|-------------|
| ğŸª **HttpOnly Cookie** | `â­â­â­â­â­` | `â­â­â­` | `Webåº”ç”¨` | `CSRFæ”»å‡»` |
| ğŸ’¾ **LocalStorage** | `â­â­` | `â­â­â­â­â­` | `SPAåº”ç”¨` | `XSSæ”»å‡»` |
| ğŸ” **å†…å­˜å­˜å‚¨** | `â­â­â­â­` | `â­â­` | `é«˜å®‰å…¨è¦æ±‚` | `åˆ·æ–°é¡µé¢ä¸¢å¤±` |
| ğŸ“± **åŸç”Ÿåº”ç”¨å­˜å‚¨** | `â­â­â­â­â­` | `â­â­â­â­` | `ç§»åŠ¨åº”ç”¨` | `è®¾å¤‡ä¸¢å¤±` |

**ğŸ’¡ æœ€ä½³å®è·µå»ºè®®**

```javascript
// âœ… æ¨èï¼šç»“åˆä½¿ç”¨å¤šç§å­˜å‚¨æ–¹å¼
class SecureTokenStorage {
    constructor() {
        this.useSecureStorage = this.detectSecureEnvironment();
    }
    
    // æ£€æµ‹æ˜¯å¦ä¸ºå®‰å…¨ç¯å¢ƒ
    detectSecureEnvironment() {
        return window.location.protocol === 'https:' && 
               window.isSecureContext;
    }
    
    // å®‰å…¨å­˜å‚¨RefreshToken
    storeRefreshToken(token) {
        if (this.useSecureStorage) {
            // ä½¿ç”¨HttpOnly Cookieï¼ˆéœ€è¦æœåŠ¡å™¨é…åˆï¼‰
            document.cookie = `refreshToken=${token}; ` +
                            `HttpOnly; Secure; SameSite=Strict; ` +
                            `Max-Age=${30 * 24 * 60 * 60}`; // 30å¤©
        } else {
            // é™çº§åˆ°åŠ å¯†å­˜å‚¨
            const encryptedToken = this.encrypt(token);
            localStorage.setItem('rt', encryptedToken);
        }
    }
    
    // ç®€å•çš„TokenåŠ å¯†ï¼ˆå®é™…é¡¹ç›®ä¸­ä½¿ç”¨æ›´å¼ºçš„åŠ å¯†ï¼‰
    encrypt(text) {
        return btoa(text + 'your-secret-key');
    }
    
    decrypt(encryptedText) {
        const decoded = atob(encryptedText);
        return decoded.replace('your-secret-key', '');
    }
}
```

### 4.2 Tokenè½®æ¢æœºåˆ¶


**ğŸ”„ ä»€ä¹ˆæ˜¯Tokenè½®æ¢ï¼Ÿ**

> ğŸ’¡ **ç®€å•ç†è§£**  
> æ¯æ¬¡ä½¿ç”¨RefreshTokenè·å–æ–°AccessTokenæ—¶ï¼ŒåŒæ—¶ä¹Ÿç”Ÿæˆä¸€ä¸ªæ–°çš„RefreshTokenï¼Œæ—§çš„RefreshTokenç«‹å³å¤±æ•ˆã€‚  
> å°±åƒæ¯æ¬¡å–é’±åï¼Œé“¶è¡Œå¡å¯†ç éƒ½ä¼šè‡ªåŠ¨æ›´æ–°ä¸€æ ·ã€‚

**ğŸ”¸ è½®æ¢æœºåˆ¶çš„å¥½å¤„**

```
å®‰å…¨ä¼˜åŠ¿ï¼š
â€¢ å³ä½¿RefreshTokenè¢«ç›—ï¼Œä½¿ç”¨æ—¶é—´çª—å£å¾ˆçŸ­
â€¢ è¢«ç›—ç”¨åä¼šå¯¼è‡´åˆæ³•ç”¨æˆ·çš„Tokenå¤±æ•ˆï¼Œå®¹æ˜“å‘ç°
â€¢ é™åˆ¶äº†Tokençš„æ»¥ç”¨æ—¶é—´

å®ç°ç¤ºä¾‹ï¼š
æ—§RefreshToken: RT_001 (æœ‰æ•ˆ)
ä½¿ç”¨RT_001åˆ·æ–° â”€â–¶ è¿”å›æ–°Token: AT_002 + RT_002
åŒæ—¶RT_001ç«‹å³å¤±æ•ˆï¼Œåªæœ‰RT_002å¯ç”¨
```

### 4.3 å¼‚å¸¸æ£€æµ‹æœºåˆ¶


**ğŸš¨ å¯ç–‘æ´»åŠ¨æ£€æµ‹**

```java
@Service
public class TokenSecurityService {
    
    // æ£€æµ‹å¼‚å¸¸åˆ·æ–°è¡Œä¸º
    public boolean detectAnomalousRefresh(String userId, String clientInfo) {
        // 1. é¢‘ç‡æ£€æµ‹ï¼š5åˆ†é’Ÿå†…åˆ·æ–°è¶…è¿‡10æ¬¡
        String frequencyKey = "refresh_freq:" + userId;
        Long count = redisTemplate.opsForValue().increment(frequencyKey);
        redisTemplate.expire(frequencyKey, Duration.ofMinutes(5));
        
        if (count > 10) {
            logSecurityEvent("é«˜é¢‘åˆ·æ–°å¼‚å¸¸", userId, clientInfo);
            return true;
        }
        
        // 2. åœ°ç†ä½ç½®æ£€æµ‹ï¼šä¸åŒåœ°åŒºåŒæ—¶åˆ·æ–°
        String locationKey = "refresh_location:" + userId;
        String currentLocation = extractLocation(clientInfo);
        String lastLocation = redisTemplate.opsForValue().get(locationKey);
        
        if (lastLocation != null && !lastLocation.equals(currentLocation)) {
            double distance = calculateDistance(lastLocation, currentLocation);
            if (distance > 1000) { // 1000å…¬é‡Œ
                logSecurityEvent("åœ°ç†ä½ç½®å¼‚å¸¸", userId, clientInfo);
                return true;
            }
        }
        
        redisTemplate.opsForValue().set(locationKey, currentLocation, 
                                       Duration.ofHours(1));
        
        // 3. è®¾å¤‡æŒ‡çº¹æ£€æµ‹
        return detectDeviceFingerprint(userId, clientInfo);
    }
    
    // å®‰å…¨äº‹ä»¶æ—¥å¿—
    private void logSecurityEvent(String eventType, String userId, String clientInfo) {
        SecurityLog log = new SecurityLog();
        log.setEventType(eventType);
        log.setUserId(userId);
        log.setClientInfo(clientInfo);
        log.setTimestamp(new Date());
        
        securityLogRepository.save(log);
        
        // å‘é€å‘Šè­¦é€šçŸ¥
        notificationService.sendSecurityAlert(userId, eventType);
    }
}
```

---

## 5. ğŸ“± å¤šç«¯ç™»å½•å¤„ç†


### 5.1 å¤šç«¯ç™»å½•åœºæ™¯åˆ†æ


**ğŸ“‹ å¸¸è§å¤šç«¯ç™»å½•éœ€æ±‚**

```
ğŸŒ Webç«¯ï¼šChromeæµè§ˆå™¨ç™»å½•
ğŸ“± ç§»åŠ¨ç«¯ï¼šæ‰‹æœºAPPç™»å½•
ğŸ’» æ¡Œé¢ç«¯ï¼šæ¡Œé¢åº”ç”¨ç™»å½•
ğŸ–¥ï¸ å…¶ä»–è®¾å¤‡ï¼šå¹³æ¿ã€æ™ºèƒ½TVç­‰

æŒ‘æˆ˜ï¼š
â€¢ å¦‚ä½•åŒºåˆ†ä¸åŒè®¾å¤‡çš„Tokenï¼Ÿ
â€¢ ä¸€ä¸ªè®¾å¤‡çš„Tokenåˆ·æ–°æ˜¯å¦å½±å“å…¶ä»–è®¾å¤‡ï¼Ÿ
â€¢ å¦‚ä½•å®ç°è®¾å¤‡ç®¡ç†å’Œå¼ºåˆ¶ä¸‹çº¿ï¼Ÿ
```

### 5.2 è®¾å¤‡ç»‘å®šTokenè®¾è®¡


**ğŸ”‘ è®¾å¤‡æ ‡è¯†ç”Ÿæˆ**

```javascript
// ç”Ÿæˆè®¾å¤‡æŒ‡çº¹
class DeviceFingerprint {
    static generate() {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        ctx.textBaseline = 'top';
        ctx.font = '14px Arial';
        ctx.fillText('Device fingerprint', 2, 2);
        
        const fingerprint = {
            userAgent: navigator.userAgent,
            language: navigator.language,
            platform: navigator.platform,
            screen: `${screen.width}x${screen.height}`,
            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
            canvas: canvas.toDataURL(),
            timestamp: Date.now()
        };
        
        // ç”Ÿæˆè®¾å¤‡IDï¼ˆå®é™…é¡¹ç›®ä¸­ä½¿ç”¨æ›´å¤æ‚çš„ç®—æ³•ï¼‰
        return btoa(JSON.stringify(fingerprint)).substring(0, 32);
    }
}

// å¸¦è®¾å¤‡ä¿¡æ¯çš„ç™»å½•è¯·æ±‚
async function loginWithDevice(username, password) {
    const deviceId = DeviceFingerprint.generate();
    const deviceInfo = {
        deviceId: deviceId,
        deviceType: getDeviceType(), // 'web', 'mobile', 'desktop'
        deviceName: getDeviceName(), // 'Chrome on Windows', 'iPhone 13'
        lastActiveTime: new Date().toISOString()
    };
    
    const response = await fetch('/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            username,
            password,
            deviceInfo
        })
    });
    
    return response.json();
}
```

### 5.3 å¤šè®¾å¤‡Tokenç®¡ç†


**ğŸ—ƒï¸ æ•°æ®åº“è®¾è®¡**

```sql
-- ç”¨æˆ·è®¾å¤‡è¡¨
CREATE TABLE user_devices (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    device_id VARCHAR(64) NOT NULL,
    device_type VARCHAR(20) NOT NULL,
    device_name VARCHAR(100),
    refresh_token_id VARCHAR(64) NOT NULL,
    last_active_time TIMESTAMP,
    created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE,
    
    UNIQUE KEY uk_user_device (user_id, device_id),
    INDEX idx_user_id (user_id),
    INDEX idx_refresh_token (refresh_token_id)
);

-- RefreshTokenè¡¨
CREATE TABLE refresh_tokens (
    id VARCHAR(64) PRIMARY KEY,
    user_id BIGINT NOT NULL,
    device_id VARCHAR(64) NOT NULL,
    token_hash VARCHAR(255) NOT NULL,
    expires_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_revoked BOOLEAN DEFAULT FALSE,
    
    INDEX idx_user_device (user_id, device_id),
    INDEX idx_expires (expires_at)
);
```

**ğŸ”§ è®¾å¤‡ç®¡ç†æœåŠ¡**

```java
@Service
public class DeviceTokenService {
    
    // ä¸ºç‰¹å®šè®¾å¤‡åˆ·æ–°Token
    public TokenResponse refreshTokenForDevice(String refreshToken, 
                                             String deviceId) {
        // 1. éªŒè¯RefreshTokenå’Œè®¾å¤‡ç»‘å®šå…³ç³»
        RefreshTokenEntity tokenEntity = validateRefreshToken(refreshToken);
        if (!tokenEntity.getDeviceId().equals(deviceId)) {
            throw new SecurityException("Tokenä¸è®¾å¤‡ä¸åŒ¹é…");
        }
        
        // 2. ç”Ÿæˆæ–°çš„AccessToken
        String newAccessToken = generateAccessToken(tokenEntity.getUserId(), deviceId);
        
        // 3. å¯é€‰ï¼šç”Ÿæˆæ–°çš„RefreshTokenï¼ˆè®¾å¤‡çº§åˆ«çš„è½®æ¢ï¼‰
        String newRefreshToken = generateRefreshToken(tokenEntity.getUserId(), deviceId);
        
        // 4. æ›´æ–°è®¾å¤‡æœ€åæ´»è·ƒæ—¶é—´
        updateDeviceLastActive(tokenEntity.getUserId(), deviceId);
        
        return new TokenResponse(newAccessToken, newRefreshToken);
    }
    
    // è·å–ç”¨æˆ·æ‰€æœ‰è®¾å¤‡
    public List<DeviceInfo> getUserDevices(Long userId) {
        return userDeviceRepository.findActiveDevicesByUserId(userId)
            .stream()
            .map(this::convertToDeviceInfo)
            .collect(Collectors.toList());
    }
    
    // å¼ºåˆ¶ä¸‹çº¿æŒ‡å®šè®¾å¤‡
    public void logoutDevice(Long userId, String deviceId) {
        // 1. æ’¤é”€è¯¥è®¾å¤‡çš„æ‰€æœ‰RefreshToken
        refreshTokenRepository.revokeByUserAndDevice(userId, deviceId);
        
        // 2. å°†è®¾å¤‡æ ‡è®°ä¸ºéæ´»è·ƒ
        userDeviceRepository.deactivateDevice(userId, deviceId);
        
        // 3. å°†è¯¥è®¾å¤‡çš„æ‰€æœ‰AccessTokenåŠ å…¥é»‘åå•
        List<String> accessTokens = getActiveAccessTokens(userId, deviceId);
        for (String token : accessTokens) {
            blacklistToken(token);
        }
    }
    
    // é™åˆ¶è®¾å¤‡æ•°é‡
    public void enforceDeviceLimit(Long userId) {
        List<UserDevice> devices = userDeviceRepository
            .findActiveDevicesByUserId(userId);
        
        if (devices.size() > MAX_DEVICES_PER_USER) {
            // æŒ‰æœ€åæ´»è·ƒæ—¶é—´æ’åºï¼Œç§»é™¤æœ€è€çš„è®¾å¤‡
            devices.sort(Comparator.comparing(UserDevice::getLastActiveTime));
            
            for (int i = 0; i < devices.size() - MAX_DEVICES_PER_USER; i++) {
                logoutDevice(userId, devices.get(i).getDeviceId());
            }
        }
    }
}
```

---

## 6. âœ¨ æ— æ„Ÿåˆ·æ–°å®ç°


### 6.1 ä»€ä¹ˆæ˜¯æ— æ„Ÿåˆ·æ–°


**ğŸ”¸ ç”¨æˆ·ä½“éªŒè§’åº¦**

> ğŸ¯ **æ— æ„Ÿåˆ·æ–°çš„ç›®æ ‡**  
> ç”¨æˆ·åœ¨ä½¿ç”¨åº”ç”¨è¿‡ç¨‹ä¸­ï¼ŒTokenè¿‡æœŸå’Œæ›´æ–°çš„è¿‡ç¨‹å®Œå…¨é€æ˜ï¼Œç”¨æˆ·ä¸ä¼šæ„Ÿè§‰åˆ°ä»»ä½•ä¸­æ–­æˆ–å»¶è¿Ÿã€‚

**ğŸŒŸ æ— æ„Ÿåˆ·æ–° vs æœ‰æ„Ÿåˆ·æ–°å¯¹æ¯”**

```
âŒ æœ‰æ„Ÿåˆ·æ–°ä½“éªŒï¼š
ç”¨æˆ·ç‚¹å‡»æŒ‰é’® â–¶ å‘ç°Tokenè¿‡æœŸ â–¶ æ˜¾ç¤º"æ­£åœ¨åˆ·æ–°..." â–¶ é¡µé¢ç­‰å¾… â–¶ åˆ·æ–°å®Œæˆ â–¶ é‡æ–°æ‰§è¡Œæ“ä½œ

âœ… æ— æ„Ÿåˆ·æ–°ä½“éªŒï¼š
ç”¨æˆ·ç‚¹å‡»æŒ‰é’® â–¶ è‡ªåŠ¨æ£€æµ‹å¹¶åˆ·æ–°Token â–¶ ç›´æ¥è¿”å›ç»“æœ

ç”¨æˆ·æ„ŸçŸ¥ï¼šå®Œå…¨æ²¡æœ‰æ„Ÿè§‰åˆ°Tokenæ›´æ–°è¿‡ç¨‹
```

### 6.2 HTTPæ‹¦æˆªå™¨å®ç°


**ğŸ”§ å‰ç«¯Axiosæ‹¦æˆªå™¨**

```javascript
// Tokenç®¡ç†å™¨ï¼ˆå‰é¢å·²å®ç°ï¼‰
const tokenManager = new TokenManager();

// åˆ›å»ºAxioså®ä¾‹
const apiClient = axios.create({
    baseURL: '/api',
    timeout: 10000
});

// è¯·æ±‚æ‹¦æˆªå™¨ï¼šè‡ªåŠ¨æ·»åŠ AccessToken
apiClient.interceptors.request.use(
    async (config) => {
        // æ£€æŸ¥Tokenæ˜¯å¦å³å°†è¿‡æœŸ
        if (tokenManager.isTokenExpiringSoon()) {
            try {
                // æ— æ„Ÿåˆ·æ–°Token
                await tokenManager.refreshAccessToken();
            } catch (error) {
                // åˆ·æ–°å¤±è´¥ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
                window.location.href = '/login';
                return Promise.reject(error);
            }
        }
        
        // æ·»åŠ AccessTokenåˆ°è¯·æ±‚å¤´
        if (tokenManager.accessToken) {
            config.headers.Authorization = `Bearer ${tokenManager.accessToken}`;
        }
        
        return config;
    },
    (error) => Promise.reject(error)
);

// å“åº”æ‹¦æˆªå™¨ï¼šå¤„ç†401é”™è¯¯
apiClient.interceptors.response.use(
    (response) => response,
    async (error) => {
        const originalRequest = error.config;
        
        // å¦‚æœæ˜¯401é”™è¯¯ä¸”ä¸æ˜¯åˆ·æ–°Tokençš„è¯·æ±‚
        if (error.response?.status === 401 && 
            !originalRequest._retry && 
            !originalRequest.url.includes('/auth/refresh')) {
            
            originalRequest._retry = true;
            
            try {
                // å°è¯•åˆ·æ–°Token
                await tokenManager.refreshAccessToken();
                
                // æ›´æ–°åŸå§‹è¯·æ±‚çš„Authorizationå¤´
                originalRequest.headers.Authorization = 
                    `Bearer ${tokenManager.accessToken}`;
                
                // é‡æ–°å‘èµ·åŸå§‹è¯·æ±‚
                return apiClient(originalRequest);
            } catch (refreshError) {
                // åˆ·æ–°å¤±è´¥ï¼Œè·³è½¬ç™»å½•
                window.location.href = '/login';
                return Promise.reject(refreshError);
            }
        }
        
        return Promise.reject(error);
    }
);
```

### 6.3 å¹¶å‘è¯·æ±‚å¤„ç†


**ğŸš¦ é˜²æ­¢é‡å¤åˆ·æ–°**

```javascript
class AdvancedTokenManager {
    constructor() {
        this.accessToken = localStorage.getItem('accessToken');
        this.refreshToken = localStorage.getItem('refreshToken');
        this.refreshPromise = null; // æ­£åœ¨è¿›è¡Œçš„åˆ·æ–°Promise
        this.waitingQueue = []; // ç­‰å¾…Tokenåˆ·æ–°çš„è¯·æ±‚é˜Ÿåˆ—
    }
    
    async refreshAccessToken() {
        // å¦‚æœå·²ç»æœ‰åˆ·æ–°åœ¨è¿›è¡Œä¸­ï¼Œè¿”å›åŒä¸€ä¸ªPromise
        if (this.refreshPromise) {
            return this.refreshPromise;
        }
        
        // åˆ›å»ºæ–°çš„åˆ·æ–°Promise
        this.refreshPromise = this._performRefresh();
        
        try {
            const newToken = await this.refreshPromise;
            
            // åˆ·æ–°æˆåŠŸï¼Œå¤„ç†ç­‰å¾…é˜Ÿåˆ—
            this._processWaitingQueue(newToken);
            
            return newToken;
        } catch (error) {
            // åˆ·æ–°å¤±è´¥ï¼Œæ‹’ç»ç­‰å¾…é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰è¯·æ±‚
            this._rejectWaitingQueue(error);
            throw error;
        } finally {
            this.refreshPromise = null;
        }
    }
    
    // å®é™…çš„åˆ·æ–°é€»è¾‘
    async _performRefresh() {
        const response = await fetch('/api/auth/refresh', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${this.refreshToken}`
            }
        });
        
        if (!response.ok) {
            throw new Error('Tokenåˆ·æ–°å¤±è´¥');
        }
        
        const data = await response.json();
        
        // æ›´æ–°Token
        this.accessToken = data.accessToken;
        this.refreshToken = data.refreshToken || this.refreshToken;
        
        localStorage.setItem('accessToken', this.accessToken);
        localStorage.setItem('refreshToken', this.refreshToken);
        
        return this.accessToken;
    }
    
    // å¤„ç†ç­‰å¾…é˜Ÿåˆ—ä¸­çš„è¯·æ±‚
    _processWaitingQueue(newToken) {
        this.waitingQueue.forEach(({ resolve }) => {
            resolve(newToken);
        });
        this.waitingQueue = [];
    }
    
    // æ‹’ç»ç­‰å¾…é˜Ÿåˆ—ä¸­çš„è¯·æ±‚
    _rejectWaitingQueue(error) {
        this.waitingQueue.forEach(({ reject }) => {
            reject(error);
        });
        this.waitingQueue = [];
    }
    
    // è·å–æœ‰æ•ˆçš„AccessToken
    async getValidAccessToken() {
        if (!this.isTokenExpiringSoon()) {
            return this.accessToken;
        }
        
        // å¦‚æœæœ‰åˆ·æ–°åœ¨è¿›è¡Œä¸­ï¼ŒåŠ å…¥ç­‰å¾…é˜Ÿåˆ—
        if (this.refreshPromise) {
            return new Promise((resolve, reject) => {
                this.waitingQueue.push({ resolve, reject });
            });
        }
        
        // å¼€å§‹åˆ·æ–°Token
        return this.refreshAccessToken();
    }
}
```

### 6.4 React Hookå®ç°


**âš¡ useAuth Hook**

```javascript
import { useState, useEffect, useContext, createContext } from 'react';

// è®¤è¯ä¸Šä¸‹æ–‡
const AuthContext = createContext();

// è®¤è¯æä¾›è€…ç»„ä»¶
export function AuthProvider({ children }) {
    const [user, setUser] = useState(null);
    const [loading, setLoading] = useState(true);
    const tokenManager = new AdvancedTokenManager();
    
    // åˆå§‹åŒ–è®¤è¯çŠ¶æ€
    useEffect(() => {
        initializeAuth();
    }, []);
    
    const initializeAuth = async () => {
        try {
            const token = await tokenManager.getValidAccessToken();
            if (token) {
                const userInfo = await fetchUserInfo();
                setUser(userInfo);
            }
        } catch (error) {
            console.error('åˆå§‹åŒ–è®¤è¯å¤±è´¥:', error);
        } finally {
            setLoading(false);
        }
    };
    
    // è‡ªåŠ¨APIè°ƒç”¨Hook
    const apiCall = async (url, options = {}) => {
        try {
            const token = await tokenManager.getValidAccessToken();
            
            const response = await fetch(url, {
                ...options,
                headers: {
                    ...options.headers,
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (!response.ok) {
                throw new Error(`APIè°ƒç”¨å¤±è´¥: ${response.status}`);
            }
            
            return response.json();
        } catch (error) {
            console.error('APIè°ƒç”¨é”™è¯¯:', error);
            throw error;
        }
    };
    
    const value = {
        user,
        loading,
        apiCall,
        login: async (credentials) => {
            // ç™»å½•é€»è¾‘
        },
        logout: () => {
            tokenManager.clearTokens();
            setUser(null);
        }
    };
    
    return (
        <AuthContext.Provider value={value}>
            {children}
        </AuthContext.Provider>
    );
}

// ä½¿ç”¨è®¤è¯Hook
export function useAuth() {
    const context = useContext(AuthContext);
    if (!context) {
        throw new Error('useAuthå¿…é¡»åœ¨AuthProviderå†…ä½¿ç”¨');
    }
    return context;
}

// è‡ªåŠ¨åˆ·æ–°çš„APIè°ƒç”¨Hook
export function useApiCall() {
    const { apiCall } = useAuth();
    
    return useCallback(async (url, options) => {
        return apiCall(url, options);
    }, [apiCall]);
}
```

### 6.5 Vue Composition APIå®ç°


**ğŸ”§ Vue 3 ç»„åˆå¼API**

```javascript
// composables/useAuth.js
import { ref, reactive, onMounted } from 'vue';

const tokenManager = new AdvancedTokenManager();

// å…¨å±€è®¤è¯çŠ¶æ€
const authState = reactive({
    user: null,
    loading: false,
    isAuthenticated: false
});

export function useAuth() {
    const login = async (credentials) => {
        authState.loading = true;
        try {
            const response = await fetch('/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(credentials)
            });
            
            const data = await response.json();
            
            tokenManager.setTokens(data.accessToken, data.refreshToken);
            authState.user = data.user;
            authState.isAuthenticated = true;
            
            return data;
        } finally {
            authState.loading = false;
        }
    };
    
    const logout = () => {
        tokenManager.clearTokens();
        authState.user = null;
        authState.isAuthenticated = false;
    };
    
    // è‡ªåŠ¨åˆ·æ–°çš„APIè°ƒç”¨
    const apiCall = async (url, options = {}) => {
        const token = await tokenManager.getValidAccessToken();
        
        return fetch(url, {
            ...options,
            headers: {
                ...options.headers,
                'Authorization': `Bearer ${token}`
            }
        });
    };
    
    // åˆå§‹åŒ–è®¤è¯çŠ¶æ€
    onMounted(async () => {
        if (tokenManager.hasValidToken()) {
            try {
                const userInfo = await apiCall('/api/user/profile');
                authState.user = await userInfo.json();
                authState.isAuthenticated = true;
            } catch (error) {
                console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                logout();
            }
        }
    });
    
    return {
        ...toRefs(authState),
        login,
        logout,
        apiCall
    };
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ”¸ RefreshTokenæœ¬è´¨**
- æ˜¯ä¸€ä¸ª**é•¿æœŸæœ‰æ•ˆçš„èº«ä»½å‡­è¯**ï¼Œä¸“é—¨ç”¨æ¥è·å–æ–°çš„AccessToken
- å°±åƒ**èº«ä»½è¯å’Œä¸´æ—¶é€šè¡Œè¯**çš„å…³ç³»ï¼Œèº«ä»½è¯ç”¨æ¥æ¢æ–°çš„é€šè¡Œè¯

**ğŸ”¸ åŒTokenæ¨¡å¼ä¼˜åŠ¿**
- **èŒè´£åˆ†ç¦»**ï¼šAccessTokenç”¨äºæ—¥å¸¸APIè°ƒç”¨ï¼ŒRefreshTokenç”¨äºTokenæ›´æ–°
- **å®‰å…¨å¹³è¡¡**ï¼šçŸ­æœŸTokené™ä½è¢«ç›—é£é™©ï¼Œé•¿æœŸTokenå‡å°‘ç”¨æˆ·é‡å¤ç™»å½•

**ğŸ”¸ æ ¸å¿ƒå·¥ä½œæµç¨‹**
```
ç™»å½• â†’ è·å¾—åŒToken â†’ ä½¿ç”¨AccessTokenè®¿é—®API â†’ Tokenè¿‡æœŸ â†’ ç”¨RefreshTokenåˆ·æ–° â†’ è·å¾—æ–°AccessToken
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆéœ€è¦RefreshToken**
```
ç”¨æˆ·ä½“éªŒï¼šé¿å…é¢‘ç¹è¦æ±‚ç”¨æˆ·é‡æ–°ç™»å½•
å®‰å…¨æ€§ï¼šAccessTokençŸ­æœŸæœ‰æ•ˆï¼Œè¢«ç›—ç”¨å½±å“æœ‰é™
å¹³è¡¡ç‚¹ï¼šåœ¨å®‰å…¨æ€§å’Œç”¨æˆ·ä½“éªŒä¹‹é—´æ‰¾åˆ°æœ€ä½³å¹³è¡¡
```

**ğŸ”¹ åˆ·æ–°æ—¶æœºçš„é€‰æ‹©**
- **è¢«åŠ¨åˆ·æ–°**ï¼šTokenè¿‡æœŸåå†åˆ·æ–°ï¼ˆèŠ‚çœèµ„æºï¼‰
- **ä¸»åŠ¨åˆ·æ–°**ï¼šTokenå¿«è¿‡æœŸæ—¶æå‰åˆ·æ–°ï¼ˆæ›´å¥½ä½“éªŒï¼‰
- **å®šæ—¶åˆ·æ–°**ï¼šæŒ‰å›ºå®šé—´éš”åˆ·æ–°ï¼ˆå¯é¢„æµ‹æ€§ï¼‰

**ğŸ”¹ å¤šè®¾å¤‡ç™»å½•å¤„ç†**
- æ¯ä¸ªè®¾å¤‡æœ‰ç‹¬ç«‹çš„Tokenå¯¹
- è®¾å¤‡ç»‘å®šé˜²æ­¢Tokenè¢«è·¨è®¾å¤‡ä½¿ç”¨
- æ”¯æŒè®¾å¤‡ç®¡ç†å’Œå¼ºåˆ¶ä¸‹çº¿

### 7.3 å®‰å…¨æœ€ä½³å®è·µ


**ğŸ›¡ï¸ å­˜å‚¨å®‰å…¨**
```
RefreshTokenå­˜å‚¨ï¼š
âœ… Webç«¯ï¼šHttpOnly Cookieï¼ˆé˜²XSSï¼‰
âœ… ç§»åŠ¨ç«¯ï¼šå®‰å…¨å­˜å‚¨/Keychainï¼ˆé˜²é€†å‘ï¼‰
âœ… æ¡Œé¢ç«¯ï¼šåŠ å¯†æœ¬åœ°å­˜å‚¨
```

**ğŸ”„ Tokenè½®æ¢æœºåˆ¶**
```
æ¯æ¬¡åˆ·æ–°æ—¶ï¼š
â€¢ ç”Ÿæˆæ–°çš„RefreshToken
â€¢ æ—§çš„RefreshTokenç«‹å³å¤±æ•ˆ
â€¢ é™åˆ¶Tokençš„æœ‰æ•ˆä½¿ç”¨æ—¶é—´
```

**ğŸš¨ å¼‚å¸¸æ£€æµ‹**
```
ç›‘æ§æŒ‡æ ‡ï¼š
â€¢ å¼‚å¸¸é«˜é¢‘åˆ·æ–°
â€¢ å¼‚åœ°ç™»å½•æ£€æµ‹
â€¢ è®¾å¤‡æŒ‡çº¹å˜åŒ–
```

### 7.4 å®ç°æŠ€æœ¯è¦ç‚¹


**ğŸ”§ å‰ç«¯å®ç°å…³é”®**
- ä½¿ç”¨HTTPæ‹¦æˆªå™¨å®ç°æ— æ„Ÿåˆ·æ–°
- é˜²æ­¢å¹¶å‘åˆ·æ–°å¯¼è‡´çš„é‡å¤è¯·æ±‚
- åˆç†çš„Tokenè¿‡æœŸæ—¶é—´æ£€æµ‹

**âš™ï¸ åç«¯å®ç°å…³é”®**
- RefreshTokençš„å®‰å…¨éªŒè¯å’Œå­˜å‚¨
- è®¾å¤‡ç»‘å®šå’Œå¤šç«¯ç™»å½•ç®¡ç†
- Tokené»‘åå•å’Œæ’¤é”€æœºåˆ¶

**ğŸ“± æ— æ„Ÿåˆ·æ–°æ ¸å¿ƒ**
- æå‰æ£€æµ‹Tokenè¿‡æœŸ
- é˜Ÿåˆ—åŒ–å¹¶å‘è¯·æ±‚
- é€æ˜çš„é”™è¯¯å¤„ç†å’Œé‡è¯•

### 7.5 å®é™…åº”ç”¨å»ºè®®


**ğŸ¯ é€‚ç”¨åœºæ™¯**
- éœ€è¦é•¿æ—¶é—´ä¿æŒç™»å½•çŠ¶æ€çš„åº”ç”¨
- å¯¹ç”¨æˆ·ä½“éªŒè¦æ±‚è¾ƒé«˜çš„ç³»ç»Ÿ
- æ”¯æŒå¤šè®¾å¤‡ç™»å½•çš„å¹³å°

**âš–ï¸ æƒè¡¡è€ƒè™‘**
- **å¤æ‚åº¦ vs å®‰å…¨æ€§**ï¼šå¢åŠ äº†ç³»ç»Ÿå¤æ‚åº¦ï¼Œä½†æé«˜äº†å®‰å…¨æ€§
- **æ€§èƒ½ vs ä½“éªŒ**ï¼šå¢åŠ äº†åˆ·æ–°è¯·æ±‚ï¼Œä½†æ”¹å–„äº†ç”¨æˆ·ä½“éªŒ
- **å­˜å‚¨ vs å®‰å…¨**ï¼šéœ€è¦å®‰å…¨å­˜å‚¨ï¼Œä½†é¿å…äº†é¢‘ç¹ç™»å½•

**ğŸ“ˆ ç›‘æ§æŒ‡æ ‡**
- Tokenåˆ·æ–°é¢‘ç‡å’ŒæˆåŠŸç‡
- ç”¨æˆ·ç™»å½•ä¼šè¯æ—¶é•¿
- å¼‚å¸¸å®‰å…¨äº‹ä»¶æ•°é‡

---

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- RefreshTokenæ˜¯èº«ä»½è¯ï¼ŒAccessTokenæ˜¯ä¸´æ—¶é€šè¡Œè¯
- åŒTokenèŒè´£åˆ†ç¦»ï¼Œå®‰å…¨ä¸ä½“éªŒå¹¶é‡
- æ— æ„Ÿåˆ·æ–°è®©ç”¨æˆ·æ„Ÿè§‰ä¸åˆ°Tokenæ›´æ–°è¿‡ç¨‹
- å¤šè®¾å¤‡ç®¡ç†éœ€è¦è®¾å¤‡ç»‘å®šå’Œç‹¬ç«‹Token
- å®‰å…¨å­˜å‚¨å’Œå¼‚å¸¸æ£€æµ‹æ˜¯å…³é”®é˜²æŠ¤æªæ–½