---
title: 6ã€JWTåç«¯é›†æˆå®è·µ
---
## ğŸ“š ç›®å½•

1. [JWTåç«¯é›†æˆæ¦‚è¿°](#1-jwtåç«¯é›†æˆæ¦‚è¿°)
2. [Spring Booté›†æˆJWTå®è·µ](#2-spring-booté›†æˆjwtå®è·µ)
3. [ç™»å½•è®¤è¯å®Œæ•´æµç¨‹](#3-ç™»å½•è®¤è¯å®Œæ•´æµç¨‹)
4. [JWTæ‹¦æˆªå™¨ä¸Filterå®ç°](#4-jwtæ‹¦æˆªå™¨ä¸filterå®ç°)
5. [Tokenä¼ è¾“æ–¹å¼è¯¦è§£](#5-tokenä¼ è¾“æ–¹å¼è¯¦è§£)
6. [Express.js JWTä¸­é—´ä»¶](#6-express-js-jwtä¸­é—´ä»¶)
7. [è·¯ç”±æƒé™æ§åˆ¶æœºåˆ¶](#7-è·¯ç”±æƒé™æ§åˆ¶æœºåˆ¶)
8. [ç”¨æˆ·ä¿¡æ¯æ³¨å…¥å®ç°](#8-ç”¨æˆ·ä¿¡æ¯æ³¨å…¥å®ç°)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ JWTåç«¯é›†æˆæ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯JWTåç«¯é›†æˆ

**é€šä¿—ç†è§£**ï¼šå°±æ˜¯åœ¨åç«¯æœåŠ¡å™¨ä¸Šä½¿ç”¨JWTæ¥éªŒè¯ç”¨æˆ·èº«ä»½ï¼Œå°±åƒé—¨å«æ£€æŸ¥é€šè¡Œè¯ä¸€æ ·ã€‚

```
ç”¨æˆ·ç™»å½•æµç¨‹ï¼š
ç”¨æˆ· --è´¦å·å¯†ç --> åç«¯æœåŠ¡å™¨ --éªŒè¯æˆåŠŸ--> ç”ŸæˆJWT --è¿”å›--> ç”¨æˆ·ä¿å­˜Token
ç”¨æˆ·è¯·æ±‚ --æºå¸¦JWT--> åç«¯éªŒè¯JWT --é€šè¿‡--> å…è®¸è®¿é—®èµ„æº
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦åç«¯é›†æˆJWT

**è§£å†³çš„æ ¸å¿ƒé—®é¢˜**ï¼š
- âœ… **æ— çŠ¶æ€è®¤è¯**ï¼šæœåŠ¡å™¨ä¸éœ€è¦å­˜å‚¨ç”¨æˆ·ä¼šè¯
- âœ… **åˆ†å¸ƒå¼å‹å¥½**ï¼šå¤šä¸ªæœåŠ¡å™¨éƒ½èƒ½éªŒè¯åŒä¸€ä¸ªToken
- âœ… **æ€§èƒ½æå‡**ï¼šä¸éœ€è¦é¢‘ç¹æŸ¥è¯¢æ•°æ®åº“éªŒè¯èº«ä»½
- âœ… **ç§»åŠ¨ç«¯å‹å¥½**ï¼šæ¯”Cookieæ›´é€‚åˆAPPåº”ç”¨

### 1.3 é›†æˆæ¶æ„å›¾

```
å‰ç«¯åº”ç”¨                    åç«¯æœåŠ¡
    |                         |
    |--[1]ç™»å½•è¯·æ±‚------------>|
    |   {username, password}   |--éªŒè¯ç”¨æˆ·
    |                         |--ç”ŸæˆJWT
    |<--[2]è¿”å›JWT-------------|
    |   {token: "eyJ..."}      |
    |                         |
    |--[3]ä¸šåŠ¡è¯·æ±‚------------>|
    |   Header: Authorization  |--éªŒè¯JWT
    |   Bearer eyJ...          |--è§£æç”¨æˆ·ä¿¡æ¯
    |<--[4]è¿”å›æ•°æ®------------|--å…è®¸è®¿é—®
```

---

## 2. â˜• Spring Booté›†æˆJWTå®è·µ


### 2.1 JWTä¾èµ–åº“é€‰æ‹©

**ä¸»æµJWTåº“å¯¹æ¯”**ï¼š

| åº“åç§° | **ç‰¹ç‚¹** | **ä½¿ç”¨åœºæ™¯** |
|--------|---------|-------------|
| `jjwt` | ğŸŸ¢ åŠŸèƒ½å®Œæ•´ï¼Œç¤¾åŒºæ´»è·ƒ | **æ¨èé¦–é€‰** |
| `java-jwt` | ğŸŸ¡ è½»é‡çº§ï¼ŒAuth0å‡ºå“ | ç®€å•åœºæ™¯ |
| `nimbus-jose-jwt` | ğŸ”µ åŠŸèƒ½å¼ºå¤§ï¼Œå¤æ‚ | ä¼ä¸šçº§åº”ç”¨ |

### 2.2 æ·»åŠ ä¾èµ–é…ç½®

```xml
<!-- Mavenä¾èµ– -->
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt-api</artifactId>
    <version>0.11.5</version>
</dependency>
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt-impl</artifactId>
    <version>0.11.5</version>
    <scope>runtime</scope>
</dependency>
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt-jackson</artifactId>
    <version>0.11.5</version>
    <scope>runtime</scope>
</dependency>
```

### 2.3 JWTå·¥å…·ç±»å®ç°

```java
@Component
public class JwtUtil {
    
    // å¯†é’¥ï¼ˆå®é™…é¡¹ç›®ä¸­åº”è¯¥ä»é…ç½®æ–‡ä»¶è¯»å–ï¼‰
    private String secret = "mySecretKey123456789";
    // Tokenæœ‰æ•ˆæœŸï¼ˆ24å°æ—¶ï¼‰
    private long expiration = 86400000;
    
    /**
     * ç”ŸæˆJWT Token
     * @param username ç”¨æˆ·å
     * @param userId ç”¨æˆ·ID
     * @return JWTå­—ç¬¦ä¸²
     */
    public String generateToken(String username, Long userId) {
        Date now = new Date();
        Date expireTime = new Date(now.getTime() + expiration);
        
        return Jwts.builder()
            .setSubject(username)                    // ç”¨æˆ·å
            .claim("userId", userId)                 // è‡ªå®šä¹‰ä¿¡æ¯
            .setIssuedAt(now)                       // ç­¾å‘æ—¶é—´
            .setExpiration(expireTime)              // è¿‡æœŸæ—¶é—´
            .signWith(SignatureAlgorithm.HS256, secret)  // ç­¾åç®—æ³•å’Œå¯†é’¥
            .compact();
    }
    
    /**
     * éªŒè¯Tokenæ˜¯å¦æœ‰æ•ˆ
     */
    public boolean validateToken(String token) {
        try {
            Jwts.parser().setSigningKey(secret).parseClaimsJws(token);
            return true;
        } catch (JwtException e) {
            return false;
        }
    }
    
    /**
     * ä»Tokenä¸­è·å–ç”¨æˆ·å
     */
    public String getUsernameFromToken(String token) {
        Claims claims = Jwts.parser()
            .setSigningKey(secret)
            .parseClaimsJws(token)
            .getBody();
        return claims.getSubject();
    }
}
```

> ğŸ’¡ **ä»£ç è¯´æ˜**ï¼š
> - `setSubject()`ï¼šè®¾ç½®JWTçš„ä¸»ä½“ï¼Œé€šå¸¸æ˜¯ç”¨æˆ·æ ‡è¯†
> - `claim()`ï¼šæ·»åŠ è‡ªå®šä¹‰ä¿¡æ¯ï¼Œå¦‚ç”¨æˆ·IDã€è§’è‰²ç­‰
> - `setExpiration()`ï¼šè®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œè¿‡æœŸåTokenæ— æ•ˆ
> - `signWith()`ï¼šç”¨å¯†é’¥ç­¾åï¼Œç¡®ä¿Tokenä¸è¢«ç¯¡æ”¹

---

## 3. ğŸ” ç™»å½•è®¤è¯å®Œæ•´æµç¨‹


### 3.1 ç™»å½•æµç¨‹å›¾è§£

```
ç”¨æˆ·ç™»å½•å®Œæ•´æµç¨‹ï¼š

å®¢æˆ·ç«¯                          æœåŠ¡ç«¯                    æ•°æ®åº“
   |                             |                         |
   |--[1]POST /login------------>|                         |
   |   {username:"admin",        |                         |
   |    password:"123456"}       |                         |
   |                             |--[2]éªŒè¯ç”¨æˆ·ä¿¡æ¯-------->|
   |                             |<--[3]è¿”å›ç”¨æˆ·æ•°æ®-------|
   |                             |                         |
   |                             |--[4]ç”ŸæˆJWT Token       |
   |<--[5]è¿”å›Token--------------|                         |
   |   {token:"eyJ...",          |                         |
   |    user:{id:1,name:"admin"}}|                         |
```

### 3.2 ç™»å½•Controllerå®ç°

```java
@RestController
@RequestMapping("/api/auth")
public class AuthController {
    
    @Autowired
    private UserService userService;
    
    @Autowired
    private JwtUtil jwtUtil;
    
    /**
     * ç”¨æˆ·ç™»å½•æ¥å£
     */
    @PostMapping("/login")
    public ResponseEntity<?> login(@RequestBody LoginRequest request) {
        
        // 1. éªŒè¯ç”¨æˆ·åå¯†ç 
        User user = userService.validateUser(request.getUsername(), request.getPassword());
        
        if (user == null) {
            return ResponseEntity.badRequest()
                .body(new LoginResponse("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯", null, null));
        }
        
        // 2. ç”ŸæˆJWT Token
        String token = jwtUtil.generateToken(user.getUsername(), user.getId());
        
        // 3. è¿”å›Tokenå’Œç”¨æˆ·ä¿¡æ¯
        return ResponseEntity.ok(
            new LoginResponse("ç™»å½•æˆåŠŸ", token, user)
        );
    }
}

// ç™»å½•è¯·æ±‚å¯¹è±¡
class LoginRequest {
    private String username;
    private String password;
    // getter/setter...
}

// ç™»å½•å“åº”å¯¹è±¡
class LoginResponse {
    private String message;
    private String token;
    private User user;
    // constructor, getter/setter...
}
```

### 3.3 ç”¨æˆ·éªŒè¯Service

```java
@Service
public class UserService {
    
    @Autowired
    private UserRepository userRepository;
    
    /**
     * éªŒè¯ç”¨æˆ·ç™»å½•ä¿¡æ¯
     */
    public User validateUser(String username, String password) {
        // 1. æ ¹æ®ç”¨æˆ·åæŸ¥æ‰¾ç”¨æˆ·
        User user = userRepository.findByUsername(username);
        
        if (user == null) {
            return null;
        }
        
        // 2. éªŒè¯å¯†ç ï¼ˆå®é™…é¡¹ç›®ä¸­å¯†ç åº”è¯¥æ˜¯åŠ å¯†çš„ï¼‰
        if (passwordMatches(password, user.getPassword())) {
            return user;
        }
        
        return null;
    }
    
    private boolean passwordMatches(String rawPassword, String encodedPassword) {
        // è¿™é‡Œåº”è¯¥ä½¿ç”¨BCryptç­‰åŠ å¯†æ–¹å¼æ¯”è¾ƒ
        return rawPassword.equals(encodedPassword);
    }
}
```

> ğŸ”¥ **é‡è¦æç¤º**ï¼šå®é™…é¡¹ç›®ä¸­å¯†ç å¿…é¡»åŠ å¯†å­˜å‚¨ï¼Œä¸èƒ½æ˜æ–‡ä¿å­˜ï¼

---

## 4. ğŸ›¡ï¸ JWTæ‹¦æˆªå™¨ä¸Filterå®ç°


### 4.1 ä»€ä¹ˆæ˜¯æ‹¦æˆªå™¨

**é€šä¿—è§£é‡Š**ï¼šæ‹¦æˆªå™¨å°±åƒå°åŒºé—¨å«ï¼Œæ¯ä¸ªäººè¿›å…¥éƒ½è¦æ£€æŸ¥é€šè¡Œè¯ï¼ˆJWTï¼‰ï¼ŒéªŒè¯é€šè¿‡æ‰èƒ½è¿›å…¥ã€‚

### 4.2 Filteræ–¹å¼å®ç°JWTéªŒè¯

```java
@Component
public class JwtAuthenticationFilter implements Filter {
    
    @Autowired
    private JwtUtil jwtUtil;
    
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, 
                        FilterChain chain) throws IOException, ServletException {
        
        HttpServletRequest httpRequest = (HttpServletRequest) request;
        HttpServletResponse httpResponse = (HttpServletResponse) response;
        
        // 1. è·å–è¯·æ±‚è·¯å¾„
        String path = httpRequest.getRequestURI();
        
        // 2. è·³è¿‡ç™»å½•æ¥å£
        if (path.equals("/api/auth/login") || path.startsWith("/public/")) {
            chain.doFilter(request, response);
            return;
        }
        
        // 3. ä»Headerä¸­è·å–Token
        String token = getTokenFromRequest(httpRequest);
        
        if (token == null || !jwtUtil.validateToken(token)) {
            // Tokenæ— æ•ˆï¼Œè¿”å›401
            httpResponse.setStatus(HttpStatus.UNAUTHORIZED.value());
            httpResponse.getWriter().write("{\"error\":\"Tokenæ— æ•ˆæˆ–å·²è¿‡æœŸ\"}");
            return;
        }
        
        // 4. Tokenæœ‰æ•ˆï¼Œç»§ç»­å¤„ç†è¯·æ±‚
        chain.doFilter(request, response);
    }
    
    /**
     * ä»è¯·æ±‚ä¸­æå–Token
     */
    private String getTokenFromRequest(HttpServletRequest request) {
        String authHeader = request.getHeader("Authorization");
        
        if (authHeader != null && authHeader.startsWith("Bearer ")) {
            return authHeader.substring(7); // å»æ‰"Bearer "å‰ç¼€
        }
        
        return null;
    }
}
```

### 4.3 æ‹¦æˆªå™¨æ–¹å¼å®ç°

```java
@Component
public class JwtInterceptor implements HandlerInterceptor {
    
    @Autowired
    private JwtUtil jwtUtil;
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler) throws Exception {
        
        // 1. è·å–Token
        String token = getTokenFromRequest(request);
        
        if (token == null || !jwtUtil.validateToken(token)) {
            response.setStatus(401);
            response.getWriter().write("{\"error\":\"æœªç™»å½•æˆ–ç™»å½•å·²è¿‡æœŸ\"}");
            return false; // é˜»æ­¢è¯·æ±‚ç»§ç»­æ‰§è¡Œ
        }
        
        // 2. å°†ç”¨æˆ·ä¿¡æ¯å­˜å‚¨åˆ°è¯·æ±‚ä¸­ï¼Œä¾›Controllerä½¿ç”¨
        String username = jwtUtil.getUsernameFromToken(token);
        request.setAttribute("currentUser", username);
        
        return true; // å…è®¸è¯·æ±‚ç»§ç»­æ‰§è¡Œ
    }
}

// é…ç½®æ‹¦æˆªå™¨
@Configuration
public class WebConfig implements WebMvcConfigurer {
    
    @Autowired
    private JwtInterceptor jwtInterceptor;
    
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(jwtInterceptor)
            .addPathPatterns("/api/**")           // æ‹¦æˆªæ‰€æœ‰apiè¯·æ±‚
            .excludePathPatterns("/api/auth/**"); // æ’é™¤ç™»å½•æ¥å£
    }
}
```

> ğŸ“‹ **Filter vs Interceptorå¯¹æ¯”**ï¼š
> - **Filter**ï¼šåœ¨Servletçº§åˆ«å·¥ä½œï¼Œå¯ä»¥ä¿®æ”¹è¯·æ±‚å’Œå“åº”
> - **Interceptor**ï¼šåœ¨Spring MVCçº§åˆ«å·¥ä½œï¼Œå¯ä»¥è®¿é—®Handlerä¿¡æ¯

---

## 5. ğŸ“¡ Tokenä¼ è¾“æ–¹å¼è¯¦è§£


### 5.1 HTTP Headerä¼ è¾“ï¼ˆæ¨èï¼‰

```javascript
// å‰ç«¯å‘é€è¯·æ±‚
fetch('/api/users', {
    method: 'GET',
    headers: {
        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiJ9...',
        'Content-Type': 'application/json'
    }
});
```

```java
// åç«¯æ¥æ”¶Token
@GetMapping("/users")
public ResponseEntity<?> getUsers(HttpServletRequest request) {
    String authHeader = request.getHeader("Authorization");
    String token = authHeader.substring(7); // å»æ‰"Bearer "
    
    // éªŒè¯Token...
    return ResponseEntity.ok(userList);
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… RESTful APIæ ‡å‡†åšæ³•
- âœ… æ”¯æŒè·¨åŸŸè¯·æ±‚
- âœ… ç§»åŠ¨ç«¯å‹å¥½

### 5.2 Cookieä¼ è¾“æ–¹å¼

```java
// åç«¯è®¾ç½®Tokenåˆ°Cookie
@PostMapping("/login")
public ResponseEntity<?> login(@RequestBody LoginRequest request, 
                              HttpServletResponse response) {
    // éªŒè¯ç”¨æˆ·...
    String token = jwtUtil.generateToken(user.getUsername(), user.getId());
    
    // è®¾ç½®åˆ°Cookieä¸­
    Cookie tokenCookie = new Cookie("token", token);
    tokenCookie.setHttpOnly(true);      // é˜²æ­¢XSSæ”»å‡»
    tokenCookie.setSecure(true);        // åªåœ¨HTTPSä¸‹ä¼ è¾“
    tokenCookie.setPath("/");           // æ•´ä¸ªç½‘ç«™å¯ç”¨
    tokenCookie.setMaxAge(86400);       // 24å°æ—¶è¿‡æœŸ
    
    response.addCookie(tokenCookie);
    
    return ResponseEntity.ok(loginResponse);
}
```

```java
// ä»Cookieè¯»å–Token
public String getTokenFromCookie(HttpServletRequest request) {
    Cookie[] cookies = request.getCookies();
    if (cookies != null) {
        for (Cookie cookie : cookies) {
            if ("token".equals(cookie.getName())) {
                return cookie.getValue();
            }
        }
    }
    return null;
}
```

### 5.3 ä¼ è¾“æ–¹å¼å¯¹æ¯”

| ä¼ è¾“æ–¹å¼ | **ä¼˜ç‚¹** | **ç¼ºç‚¹** | **é€‚ç”¨åœºæ™¯** |
|---------|---------|---------|-------------|
| **Header** | RESTfulæ ‡å‡†ï¼Œè·¨åŸŸå‹å¥½ | å‰ç«¯éœ€æ‰‹åŠ¨è®¾ç½® | APIæœåŠ¡ï¼Œç§»åŠ¨ç«¯ |
| **Cookie** | è‡ªåŠ¨æºå¸¦ï¼Œä½¿ç”¨ç®€å• | è·¨åŸŸé™åˆ¶ï¼ŒCSRFé£é™© | ä¼ ç»ŸWebåº”ç”¨ |

---

## 6. ğŸš€ Express.js JWTä¸­é—´ä»¶


### 6.1 Express.jsç¯å¢ƒæ­å»º

```bash
# å®‰è£…ä¾èµ–
npm install express jsonwebtoken bcryptjs
```

### 6.2 JWTå·¥å…·å‡½æ•°

```javascript
const jwt = require('jsonwebtoken');

const JWT_SECRET = 'your-secret-key-here';
const JWT_EXPIRES_IN = '24h';

/**
 * ç”ŸæˆJWT Token
 */
function generateToken(userId, username) {
    return jwt.sign(
        { 
            userId: userId, 
            username: username 
        },
        JWT_SECRET,
        { 
            expiresIn: JWT_EXPIRES_IN 
        }
    );
}

/**
 * éªŒè¯JWT Token
 */
function verifyToken(token) {
    try {
        return jwt.verify(token, JWT_SECRET);
    } catch (error) {
        return null;
    }
}

module.exports = { generateToken, verifyToken };
```

### 6.3 JWTä¸­é—´ä»¶å®ç°

```javascript
const { verifyToken } = require('./jwt-utils');

/**
 * JWTè®¤è¯ä¸­é—´ä»¶
 */
function authenticateToken(req, res, next) {
    // 1. ä»Headerè·å–Token
    const authHeader = req.headers['authorization'];
    const token = authHeader && authHeader.split(' ')[1]; // Bearer TOKEN
    
    if (!token) {
        return res.status(401).json({ 
            error: 'ç¼ºå°‘è®¿é—®ä»¤ç‰Œ' 
        });
    }
    
    // 2. éªŒè¯Token
    const decoded = verifyToken(token);
    
    if (!decoded) {
        return res.status(403).json({ 
            error: 'æ— æ•ˆæˆ–å·²è¿‡æœŸçš„ä»¤ç‰Œ' 
        });
    }
    
    // 3. å°†ç”¨æˆ·ä¿¡æ¯é™„åŠ åˆ°è¯·æ±‚å¯¹è±¡
    req.user = {
        userId: decoded.userId,
        username: decoded.username
    };
    
    next(); // ç»§ç»­å¤„ç†è¯·æ±‚
}

module.exports = authenticateToken;
```

### 6.4 ç™»å½•è·¯ç”±å®ç°

```javascript
const express = require('express');
const bcrypt = require('bcryptjs');
const { generateToken } = require('./jwt-utils');

const router = express.Router();

// æ¨¡æ‹Ÿç”¨æˆ·æ•°æ®åº“
const users = [
    { id: 1, username: 'admin', password: '$2b$10$...' }, // åŠ å¯†åçš„å¯†ç 
];

/**
 * ç”¨æˆ·ç™»å½•
 */
router.post('/login', async (req, res) => {
    const { username, password } = req.body;
    
    // 1. æŸ¥æ‰¾ç”¨æˆ·
    const user = users.find(u => u.username === username);
    if (!user) {
        return res.status(400).json({ error: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯' });
    }
    
    // 2. éªŒè¯å¯†ç 
    const passwordMatch = await bcrypt.compare(password, user.password);
    if (!passwordMatch) {
        return res.status(400).json({ error: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯' });
    }
    
    // 3. ç”ŸæˆToken
    const token = generateToken(user.id, user.username);
    
    // 4. è¿”å›ç»“æœ
    res.json({
        message: 'ç™»å½•æˆåŠŸ',
        token: token,
        user: {
            id: user.id,
            username: user.username
        }
    });
});

module.exports = router;
```

### 6.5 å—ä¿æŠ¤è·¯ç”±ä½¿ç”¨

```javascript
const express = require('express');
const authenticateToken = require('./auth-middleware');

const app = express();

// å…¬å¼€è·¯ç”±ï¼ˆæ— éœ€è®¤è¯ï¼‰
app.use('/api/auth', require('./auth-routes'));

// å—ä¿æŠ¤è·¯ç”±ï¼ˆéœ€è¦JWTè®¤è¯ï¼‰
app.get('/api/profile', authenticateToken, (req, res) => {
    // req.user åŒ…å«ä»JWTä¸­è§£æçš„ç”¨æˆ·ä¿¡æ¯
    res.json({
        message: 'è·å–ç”¨æˆ·èµ„æ–™æˆåŠŸ',
        user: req.user
    });
});

app.get('/api/users', authenticateToken, (req, res) => {
    res.json({
        message: 'è·å–ç”¨æˆ·åˆ—è¡¨æˆåŠŸ',
        currentUser: req.user.username,
        users: ['ç”¨æˆ·1', 'ç”¨æˆ·2', 'ç”¨æˆ·3']
    });
});
```

---

## 7. ğŸ›ï¸ è·¯ç”±æƒé™æ§åˆ¶æœºåˆ¶


### 7.1 åŸºäºè§’è‰²çš„æƒé™æ§åˆ¶

```java
// ç”¨æˆ·è§’è‰²æšä¸¾
public enum UserRole {
    ADMIN("ç®¡ç†å‘˜"),
    USER("æ™®é€šç”¨æˆ·"),
    GUEST("è®¿å®¢");
    
    private String description;
    
    UserRole(String description) {
        this.description = description;
    }
}

// æƒé™æ³¨è§£
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface RequireRole {
    UserRole[] value();
}
```

### 7.2 æƒé™æ£€æŸ¥å®ç°

```java
@Component
public class RoleCheckInterceptor implements HandlerInterceptor {
    
    @Autowired
    private JwtUtil jwtUtil;
    
    @Autowired
    private UserService userService;
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler) throws Exception {
        
        // 1. æ£€æŸ¥æ˜¯å¦éœ€è¦æƒé™éªŒè¯
        if (!(handler instanceof HandlerMethod)) {
            return true;
        }
        
        HandlerMethod handlerMethod = (HandlerMethod) handler;
        RequireRole requireRole = handlerMethod.getMethodAnnotation(RequireRole.class);
        
        if (requireRole == null) {
            return true; // æ— éœ€æƒé™éªŒè¯
        }
        
        // 2. è·å–ç”¨æˆ·è§’è‰²
        String token = getTokenFromRequest(request);
        String username = jwtUtil.getUsernameFromToken(token);
        User user = userService.findByUsername(username);
        
        // 3. æ£€æŸ¥æƒé™
        UserRole userRole = user.getRole();
        UserRole[] requiredRoles = requireRole.value();
        
        for (UserRole required : requiredRoles) {
            if (userRole == required) {
                return true; // æƒé™é€šè¿‡
            }
        }
        
        // 4. æƒé™ä¸è¶³
        response.setStatus(403);
        response.getWriter().write("{\"error\":\"æƒé™ä¸è¶³\"}");
        return false;
    }
}
```

### 7.3 Controllerä¸­ä½¿ç”¨æƒé™æ§åˆ¶

```java
@RestController
@RequestMapping("/api/admin")
public class AdminController {
    
    /**
     * åªæœ‰ç®¡ç†å‘˜å¯ä»¥è®¿é—®
     */
    @GetMapping("/users")
    @RequireRole(UserRole.ADMIN)
    public ResponseEntity<?> getAllUsers() {
        List<User> users = userService.findAll();
        return ResponseEntity.ok(users);
    }
    
    /**
     * ç®¡ç†å‘˜å’Œæ™®é€šç”¨æˆ·éƒ½å¯ä»¥è®¿é—®
     */
    @GetMapping("/profile")
    @RequireRole({UserRole.ADMIN, UserRole.USER})
    public ResponseEntity<?> getProfile(HttpServletRequest request) {
        String currentUser = (String) request.getAttribute("currentUser");
        return ResponseEntity.ok(userService.findByUsername(currentUser));
    }
}
```

### 7.4 Express.jsæƒé™æ§åˆ¶

```javascript
/**
 * è§’è‰²æƒé™æ£€æŸ¥ä¸­é—´ä»¶
 */
function requireRole(roles) {
    return (req, res, next) => {
        // å‡è®¾ç”¨æˆ·ä¿¡æ¯å·²ç»é€šè¿‡JWTä¸­é—´ä»¶æ³¨å…¥
        const userRole = req.user.role;
        
        if (!roles.includes(userRole)) {
            return res.status(403).json({ 
                error: 'æƒé™ä¸è¶³ï¼Œéœ€è¦ä»¥ä¸‹è§’è‰²ä¹‹ä¸€ï¼š' + roles.join(', ') 
            });
        }
        
        next();
    };
}

// ä½¿ç”¨æƒé™æ§åˆ¶
app.get('/api/admin/users', 
    authenticateToken,           // å…ˆéªŒè¯JWT
    requireRole(['admin']),      // å†éªŒè¯è§’è‰²
    (req, res) => {
        res.json({ message: 'ç®¡ç†å‘˜ä¸“ç”¨æ¥å£' });
    }
);

app.get('/api/profile', 
    authenticateToken,
    requireRole(['admin', 'user']), // å¤šä¸ªè§’è‰²éƒ½å¯ä»¥è®¿é—®
    (req, res) => {
        res.json({ user: req.user });
    }
);
```

---

## 8. ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯æ³¨å…¥å®ç°


### 8.1 ä»€ä¹ˆæ˜¯ç”¨æˆ·ä¿¡æ¯æ³¨å…¥

**é€šä¿—è§£é‡Š**ï¼šå°±æ˜¯åœ¨éªŒè¯JWTåï¼ŒæŠŠç”¨æˆ·ä¿¡æ¯"æ³¨å…¥"åˆ°è¯·æ±‚ä¸­ï¼Œè¿™æ ·Controllerå°±èƒ½ç›´æ¥ä½¿ç”¨ç”¨æˆ·ä¿¡æ¯ï¼Œä¸ç”¨å†æ¬¡è§£æTokenã€‚

### 8.2 Spring Bootç”¨æˆ·ä¿¡æ¯æ³¨å…¥

```java
@Component
public class UserInfoInjectionFilter implements Filter {
    
    @Autowired
    private JwtUtil jwtUtil;
    
    @Autowired
    private UserService userService;
    
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, 
                        FilterChain chain) throws IOException, ServletException {
        
        HttpServletRequest httpRequest = (HttpServletRequest) request;
        
        // 1. è·å–Token
        String token = getTokenFromRequest(httpRequest);
        
        if (token != null && jwtUtil.validateToken(token)) {
            // 2. ä»Tokenè§£æç”¨æˆ·ä¿¡æ¯
            String username = jwtUtil.getUsernameFromToken(token);
            Long userId = jwtUtil.getUserIdFromToken(token);
            
            // 3. æŸ¥è¯¢å®Œæ•´ç”¨æˆ·ä¿¡æ¯ï¼ˆå¯é€‰ï¼Œæ ¹æ®éœ€è¦ï¼‰
            User user = userService.findByUsername(username);
            
            // 4. æ³¨å…¥ç”¨æˆ·ä¿¡æ¯åˆ°è¯·æ±‚ä¸­
            httpRequest.setAttribute("currentUserId", userId);
            httpRequest.setAttribute("currentUsername", username);
            httpRequest.setAttribute("currentUser", user);
        }
        
        chain.doFilter(request, response);
    }
}
```

### 8.3 Controllerä¸­è·å–ç”¨æˆ·ä¿¡æ¯

```java
@RestController
@RequestMapping("/api")
public class UserController {
    
    /**
     * æ–¹å¼1ï¼šä»HttpServletRequestè·å–
     */
    @GetMapping("/profile")
    public ResponseEntity<?> getProfile(HttpServletRequest request) {
        // ä»è¯·æ±‚ä¸­è·å–ç”¨æˆ·ä¿¡æ¯
        String username = (String) request.getAttribute("currentUsername");
        User user = (User) request.getAttribute("currentUser");
        
        if (user == null) {
            return ResponseEntity.status(401).body("ç”¨æˆ·æœªç™»å½•");
        }
        
        return ResponseEntity.ok(user);
    }
    
    /**
     * æ–¹å¼2ï¼šä½¿ç”¨è‡ªå®šä¹‰æ³¨è§£æ³¨å…¥
     */
    @GetMapping("/orders")
    public ResponseEntity<?> getOrders(@CurrentUser User currentUser) {
        List<Order> orders = orderService.findByUserId(currentUser.getId());
        return ResponseEntity.ok(orders);
    }
}
```

### 8.4 è‡ªå®šä¹‰ç”¨æˆ·æ³¨å…¥æ³¨è§£

```java
// è‡ªå®šä¹‰æ³¨è§£
@Target(ElementType.PARAMETER)
@Retention(RetentionPolicy.RUNTIME)
public @interface CurrentUser {
}

// å‚æ•°è§£æå™¨
@Component
public class CurrentUserArgumentResolver implements HandlerMethodArgumentResolver {
    
    @Override
    public boolean supportsParameter(MethodParameter parameter) {
        return parameter.hasParameterAnnotation(CurrentUser.class) &&
               parameter.getParameterType().equals(User.class);
    }
    
    @Override
    public Object resolveArgument(MethodParameter parameter,
                                ModelAndViewContainer mavContainer,
                                NativeWebRequest webRequest,
                                WebDataBinderFactory binderFactory) throws Exception {
        
        HttpServletRequest request = webRequest.getNativeRequest(HttpServletRequest.class);
        return request.getAttribute("currentUser");
    }
}

// æ³¨å†Œå‚æ•°è§£æå™¨
@Configuration
public class WebConfig implements WebMvcConfigurer {
    
    @Autowired
    private CurrentUserArgumentResolver currentUserArgumentResolver;
    
    @Override
    public void addArgumentResolvers(List<HandlerMethodArgumentResolver> resolvers) {
        resolvers.add(currentUserArgumentResolver);
    }
}
```

### 8.5 Express.jsç”¨æˆ·ä¿¡æ¯æ³¨å…¥

```javascript
/**
 * JWTä¸­é—´ä»¶ - ç”¨æˆ·ä¿¡æ¯æ³¨å…¥ç‰ˆæœ¬
 */
function authenticateToken(req, res, next) {
    const authHeader = req.headers['authorization'];
    const token = authHeader && authHeader.split(' ')[1];
    
    if (!token) {
        return res.status(401).json({ error: 'ç¼ºå°‘è®¿é—®ä»¤ç‰Œ' });
    }
    
    const decoded = verifyToken(token);
    if (!decoded) {
        return res.status(403).json({ error: 'æ— æ•ˆä»¤ç‰Œ' });
    }
    
    // æ³¨å…¥ç”¨æˆ·ä¿¡æ¯
    req.user = {
        id: decoded.userId,
        username: decoded.username,
        role: decoded.role || 'user'
    };
    
    // å¯é€‰ï¼šæŸ¥è¯¢å®Œæ•´ç”¨æˆ·ä¿¡æ¯
    // const fullUser = await getUserById(decoded.userId);
    // req.user.fullProfile = fullUser;
    
    next();
}

// Controllerä¸­ç›´æ¥ä½¿ç”¨
app.get('/api/dashboard', authenticateToken, (req, res) => {
    // ç›´æ¥ä½¿ç”¨ req.userï¼Œæ— éœ€å†æ¬¡è§£æToken
    res.json({
        message: `æ¬¢è¿ï¼Œ${req.user.username}!`,
        userId: req.user.id,
        role: req.user.role
    });
});
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ JWTåç«¯é›†æˆï¼šåœ¨æœåŠ¡å™¨ç«¯éªŒè¯å’Œå¤„ç†JWT Token
ğŸ”¸ ç™»å½•æµç¨‹ï¼šè´¦å·å¯†ç éªŒè¯ â†’ ç”ŸæˆJWT â†’ è¿”å›Token
ğŸ”¸ è¯·æ±‚éªŒè¯ï¼šæ¯ä¸ªè¯·æ±‚æºå¸¦JWT â†’ æœåŠ¡å™¨éªŒè¯ â†’ å…è®¸è®¿é—®
ğŸ”¸ æ‹¦æˆªå™¨/Filterï¼šåœ¨è¯·æ±‚å¤„ç†å‰éªŒè¯JWTçš„æœ‰æ•ˆæ€§
ğŸ”¸ Tokenä¼ è¾“ï¼šHeader(æ¨è)å’ŒCookieä¸¤ç§ä¸»è¦æ–¹å¼
ğŸ”¸ æƒé™æ§åˆ¶ï¼šåŸºäºJWTä¸­çš„ç”¨æˆ·ä¿¡æ¯è¿›è¡Œæƒé™éªŒè¯
ğŸ”¸ ç”¨æˆ·æ³¨å…¥ï¼šå°†ç”¨æˆ·ä¿¡æ¯æ³¨å…¥åˆ°è¯·æ±‚ä¸­ä¾›ä¸šåŠ¡é€»è¾‘ä½¿ç”¨
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ JWTéªŒè¯æ—¶æœº**
```
è¯·æ±‚æµç¨‹ï¼š
å®¢æˆ·ç«¯è¯·æ±‚ â†’ æ‹¦æˆªå™¨/Filter â†’ JWTéªŒè¯ â†’ æƒé™æ£€æŸ¥ â†’ ä¸šåŠ¡å¤„ç†

å…³é”®ç‚¹ï¼š
- JWTéªŒè¯åœ¨ä¸šåŠ¡é€»è¾‘ä¹‹å‰æ‰§è¡Œ
- æ— æ•ˆTokenç›´æ¥è¿”å›401ï¼Œä¸è¿›å…¥ä¸šåŠ¡ä»£ç 
- ç”¨æˆ·ä¿¡æ¯åœ¨éªŒè¯åæ³¨å…¥è¯·æ±‚ä¸­
```

**ğŸ”¹ å®‰å…¨æœ€ä½³å®è·µ**
```
Tokenå®‰å…¨ï¼š
âœ… ä½¿ç”¨HTTPSä¼ è¾“
âœ… è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´
âœ… å¯†é’¥è¦è¶³å¤Ÿå¤æ‚ä¸”å®šæœŸæ›´æ¢
âœ… æ•æ„Ÿæ“ä½œéœ€è¦äºŒæ¬¡éªŒè¯

æƒé™æ§åˆ¶ï¼š
âœ… æœ€å°æƒé™åŸåˆ™
âœ… è§’è‰²å’Œæƒé™åˆ†ç¦»
âœ… è·¯ç”±çº§åˆ«çš„æƒé™æ§åˆ¶
âœ… æ•æ„Ÿæ¥å£çš„é¢å¤–éªŒè¯
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ æŠ€æœ¯é€‰å‹å»ºè®®**
- **Javaé¡¹ç›®**ï¼šSpring Boot + jjwt
- **Node.jsé¡¹ç›®**ï¼šExpress + jsonwebtoken
- **æƒé™å¤æ‚**ï¼šä½¿ç”¨RBACè§’è‰²æƒé™æ¨¡å‹
- **å¾®æœåŠ¡**ï¼šJWTæ— çŠ¶æ€ç‰¹æ€§æ›´é€‚åˆ

**ğŸ”§ å¼€å‘å®è·µè¦ç‚¹**
```
å¼€å‘é˜¶æ®µï¼š
1. å…ˆå®ç°åŸºç¡€JWTç”Ÿæˆå’ŒéªŒè¯
2. å†æ·»åŠ æ‹¦æˆªå™¨è¿›è¡Œç»Ÿä¸€éªŒè¯
3. æœ€ååŠ å…¥æƒé™æ§åˆ¶å’Œç”¨æˆ·æ³¨å…¥

éƒ¨ç½²é˜¶æ®µï¼š
1. é…ç½®HTTPS
2. è®¾ç½®å®‰å…¨çš„JWTå¯†é’¥
3. é…ç½®åˆç†çš„Tokenè¿‡æœŸæ—¶é—´
4. æ·»åŠ æ—¥å¿—è®°å½•å’Œç›‘æ§
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- JWTåç«¯é›†æˆå°±æ˜¯è®©æœåŠ¡å™¨å­¦ä¼šéªŒè¯"é€šè¡Œè¯"
- ç™»å½•ç”ŸæˆTokenï¼Œè¯·æ±‚æºå¸¦Tokenï¼ŒæœåŠ¡å™¨éªŒè¯Token
- æ‹¦æˆªå™¨æ˜¯å®ˆé—¨å‘˜ï¼Œæƒé™æ§åˆ¶æ˜¯è§„åˆ™æ£€æŸ¥
- ç”¨æˆ·ä¿¡æ¯æ³¨å…¥è®©ä¸šåŠ¡ä»£ç æ›´ç®€æ´æ˜“ç”¨
- å®‰å…¨æ°¸è¿œæ˜¯ç¬¬ä¸€ä½ï¼ŒHTTPSå’Œå¯†é’¥ç®¡ç†ä¸å¯å¿½è§†