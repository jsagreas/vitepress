---
title: 5ã€JWTç”Ÿæˆä¸è§£ææµç¨‹
---
## ğŸ“š ç›®å½•

1. [JWTç”Ÿæˆè§£ææ¦‚è¿°](#1-JWTç”Ÿæˆè§£ææ¦‚è¿°)
2. [åˆ›å»ºJWTçš„åŸºæœ¬æµç¨‹](#2-åˆ›å»ºJWTçš„åŸºæœ¬æµç¨‹)
3. [æœåŠ¡ç«¯ç”ŸæˆTokenå®æˆ˜](#3-æœåŠ¡ç«¯ç”ŸæˆTokenå®æˆ˜)
4. [JWTè§£æä¸éªŒè¯æµç¨‹](#4-JWTè§£æä¸éªŒè¯æµç¨‹)
5. [ç­¾åéªŒè¯æœºåˆ¶è¯¦è§£](#5-ç­¾åéªŒè¯æœºåˆ¶è¯¦è§£)
6. [è¿‡æœŸæ—¶é—´ç®¡ç†ä¸åˆ·æ–°ç­–ç•¥](#6-è¿‡æœŸæ—¶é—´ç®¡ç†ä¸åˆ·æ–°ç­–ç•¥)
7. [å¤šè¯­è¨€JWTæ“ä½œå®æˆ˜](#7-å¤šè¯­è¨€JWTæ“ä½œå®æˆ˜)
8. [å¼‚å¸¸å¤„ç†ä¸é”™è¯¯ç ](#8-å¼‚å¸¸å¤„ç†ä¸é”™è¯¯ç )
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ JWTç”Ÿæˆè§£ææ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯JWTç”Ÿæˆä¸è§£æ


**JWTç”Ÿæˆ**ï¼šå°±æ˜¯æŠŠç”¨æˆ·ä¿¡æ¯æ‰“åŒ…æˆä¸€ä¸ªå®‰å…¨çš„ä»¤ç‰Œ
**JWTè§£æ**ï¼šå°±æ˜¯æŠŠè¿™ä¸ªä»¤ç‰Œæ‹†å¼€ï¼Œå–å‡ºé‡Œé¢çš„ç”¨æˆ·ä¿¡æ¯

> ğŸ’¡ **é€šä¿—ç†è§£**
> 
> æƒ³è±¡JWTå°±åƒä¸€ä¸ª**å¯†å°çš„åŒ…è£¹**ï¼š
> - **ç”Ÿæˆ**ï¼šæŠŠé‡è¦ä¿¡æ¯è£…è¿›ç›’å­ï¼Œè´´ä¸Šé˜²ä¼ªæ ‡ç­¾
> - **è§£æ**ï¼šæ”¶åˆ°ç›’å­åï¼ŒéªŒè¯æ ‡ç­¾ï¼Œå–å‡ºä¿¡æ¯

### 1.2 JWTçš„ä¸‰ä¸ªç»„æˆéƒ¨åˆ†


```
JWTä»¤ç‰Œç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Header    â”‚   Payload   â”‚  Signature  â”‚
â”‚   (å¤´éƒ¨)    â”‚  (è½½è·)     â”‚   (ç­¾å)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç®—æ³•ä¿¡æ¯     â”‚  ç”¨æˆ·æ•°æ®    â”‚  å®‰å…¨éªŒè¯    â”‚
â”‚ {"alg":...} â”‚ {"sub":...} â”‚   å¯†é’¥ç­¾å   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            ç”¨.è¿æ¥
eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ1c2VyMTIzIn0.signature
```

**å„éƒ¨åˆ†å«ä¹‰**ï¼š
- **Header**ï¼šè¯´æ˜ä¹¦ - å‘Šè¯‰ä½ ç”¨ä»€ä¹ˆç®—æ³•åŠ å¯†çš„
- **Payload**ï¼šåŒ…è£¹å†…å®¹ - å®é™…çš„ç”¨æˆ·æ•°æ®
- **Signature**ï¼šé˜²ä¼ªç­¾å - ç¡®ä¿å†…å®¹æ²¡è¢«ç¯¡æ”¹

### 1.3 JWTå·¥ä½œåŸç†å›¾è§£


```
ç”¨æˆ·ç™»å½•æµç¨‹ï¼š
å®¢æˆ·ç«¯                    æœåŠ¡ç«¯
   |                        |
   |â”€â”€[1]ç”¨æˆ·åå¯†ç ç™»å½•â”€â”€â”€â”€â†’|
   |                        |â”€â”€[2]éªŒè¯ç”¨æˆ·ä¿¡æ¯
   |                        |â”€â”€[3]ç”ŸæˆJWTä»¤ç‰Œ
   |â†â”€â”€[4]è¿”å›JWTä»¤ç‰Œâ”€â”€â”€â”€â”€â”€|
   |                        |
   |â”€â”€[5]æºå¸¦JWTè®¿é—®èµ„æºâ”€â”€â†’|
   |                        |â”€â”€[6]è§£æéªŒè¯JWT
   |â†â”€â”€[7]è¿”å›å—ä¿æŠ¤èµ„æºâ”€â”€â”€â”€|
```

---

## 2. ğŸ”§ åˆ›å»ºJWTçš„åŸºæœ¬æµç¨‹


### 2.1 JWTç”Ÿæˆçš„5ä¸ªæ­¥éª¤


```
JWTç”Ÿæˆæµç¨‹ï¼š
æ­¥éª¤ 1ï¸âƒ£ï¼šå‡†å¤‡Headerï¼ˆå¤´éƒ¨ä¿¡æ¯ï¼‰
æ­¥éª¤ 2ï¸âƒ£ï¼šå‡†å¤‡Payloadï¼ˆç”¨æˆ·æ•°æ®ï¼‰  
æ­¥éª¤ 3ï¸âƒ£ï¼šBase64ç¼–ç Headerå’ŒPayload
æ­¥éª¤ 4ï¸âƒ£ï¼šä½¿ç”¨å¯†é’¥å¯¹å‰ä¸¤éƒ¨åˆ†è¿›è¡Œç­¾å
æ­¥éª¤ 5ï¸âƒ£ï¼šæ‹¼æ¥ä¸‰éƒ¨åˆ†å½¢æˆæœ€ç»ˆJWT
```

### 2.2 è¯¦ç»†ç”Ÿæˆè¿‡ç¨‹


**æ­¥éª¤1ï¼šåˆ›å»ºHeader**
```json
{
  "alg": "HS256",    // ç­¾åç®—æ³•ï¼šHMAC SHA256
  "typ": "JWT"       // ä»¤ç‰Œç±»å‹ï¼šJWT
}
```

**æ­¥éª¤2ï¼šåˆ›å»ºPayload**
```json
{
  "sub": "user123",           // ä¸»é¢˜ï¼šç”¨æˆ·ID
  "username": "å¼ ä¸‰",         // ç”¨æˆ·å
  "exp": 1692720000,         // è¿‡æœŸæ—¶é—´æˆ³
  "iat": 1692630000,         // ç­¾å‘æ—¶é—´æˆ³
  "role": "admin"            // ç”¨æˆ·è§’è‰²
}
```

**æ­¥éª¤3ï¼šBase64ç¼–ç **
```javascript
// Headerç¼–ç å
eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9

// Payloadç¼–ç å  
eyJzdWIiOiJ1c2VyMTIzIiwidXNlcm5hbWUiOiLlvKDkuIkiLCJleHAiOjE2OTI3MjAwMDB9
```

**æ­¥éª¤4ï¼šç”Ÿæˆç­¾å**
```javascript
// ä¼ªä»£ç 
signature = HMACSHA256(
  base64UrlEncode(header) + "." + base64UrlEncode(payload),
  secret_key
)
```

**æ­¥éª¤5ï¼šæœ€ç»ˆæ‹¼æ¥**
```
æœ€ç»ˆJWTï¼š
header.payload.signature
```

### 2.3 ç”Ÿæˆè¿‡ç¨‹å›¾è§£


```
åŸå§‹æ•°æ®                  å¤„ç†è¿‡ç¨‹                    æœ€ç»ˆç»“æœ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Header  â”‚â”€Base64ç¼–ç â†’  â”‚ Part 1  â”‚              â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚         â”‚
                              +                   â”‚  JWT    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚ Token   â”‚
â”‚ Payload â”‚â”€Base64ç¼–ç â†’  â”‚ Part 2  â”‚â”€â”€â”€â”€â”€æ‹¼æ¥â”€â”€â”€â”€â†’â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚         â”‚
                              +                   â”‚         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚         â”‚
â”‚ Secret  â”‚â”€HMACç­¾åâ”€â”€â”€â†’ â”‚ Part 3  â”‚              â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. ğŸ’» æœåŠ¡ç«¯ç”ŸæˆTokenå®æˆ˜


### 3.1 Java/Spring Bootç”ŸæˆJWT


**æ·»åŠ ä¾èµ–**
```xml
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt</artifactId>
    <version>0.9.1</version>
</dependency>
```

**JWTå·¥å…·ç±»**
```java
@Component
public class JwtUtil {
    
    // å¯†é’¥ï¼ˆå®é™…é¡¹ç›®ä¸­åº”è¯¥æ”¾åœ¨é…ç½®æ–‡ä»¶ï¼‰
    private String secretKey = "mySecretKey123456";
    
    // è¿‡æœŸæ—¶é—´ï¼š24å°æ—¶
    private long expiration = 86400000;
    
    /**
     * ç”ŸæˆJWTä»¤ç‰Œ
     * @param username ç”¨æˆ·å
     * @param userId ç”¨æˆ·ID
     * @param role ç”¨æˆ·è§’è‰²
     * @return JWTå­—ç¬¦ä¸²
     */
    public String generateToken(String username, String userId, String role) {
        Date now = new Date();
        Date expiryDate = new Date(now.getTime() + expiration);
        
        return Jwts.builder()
                .setSubject(userId)                    // è®¾ç½®ä¸»é¢˜ï¼ˆç”¨æˆ·IDï¼‰
                .claim("username", username)           // è‡ªå®šä¹‰å­—æ®µï¼šç”¨æˆ·å
                .claim("role", role)                   // è‡ªå®šä¹‰å­—æ®µï¼šè§’è‰²
                .setIssuedAt(now)                      // ç­¾å‘æ—¶é—´
                .setExpiration(expiryDate)             // è¿‡æœŸæ—¶é—´
                .signWith(SignatureAlgorithm.HS256, secretKey)  // ç­¾åç®—æ³•å’Œå¯†é’¥
                .compact();                            // ç”Ÿæˆä»¤ç‰Œå­—ç¬¦ä¸²
    }
}
```

**Controllerä¸­ä½¿ç”¨**
```java
@RestController
public class AuthController {
    
    @Autowired
    private JwtUtil jwtUtil;
    
    @PostMapping("/login")
    public ResponseEntity<?> login(@RequestBody LoginRequest request) {
        // 1. éªŒè¯ç”¨æˆ·åå¯†ç ï¼ˆçœç•¥éªŒè¯é€»è¾‘ï¼‰
        if (validateUser(request.getUsername(), request.getPassword())) {
            
            // 2. ç”ŸæˆJWTä»¤ç‰Œ
            String token = jwtUtil.generateToken(
                request.getUsername(), 
                "user123", 
                "admin"
            );
            
            // 3. è¿”å›ä»¤ç‰Œç»™å®¢æˆ·ç«¯
            return ResponseEntity.ok(new JwtResponse(token));
        }
        
        return ResponseEntity.badRequest().body("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
    }
}
```

### 3.2 ç”Ÿæˆç»“æœç¤ºä¾‹


**ç”Ÿæˆçš„JWTä»¤ç‰Œ**ï¼š
```
eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ1c2VyMTIzIiwidXNlcm5hbWUiOiLlvKDkuIkiLCJyb2xlIjoiYWRtaW4iLCJleHAiOjE2OTI3MjAwMDAsImlhdCI6MTY5MjYzMDAwMH0.K8pO7Jx4VzD-Kn2HWpCBA2Uxv5yj0K9bGvE7YdHEU4s
```

**è§£ç åå†…å®¹**ï¼š
```json
// Headeréƒ¨åˆ†
{
  "typ": "JWT",
  "alg": "HS256"
}

// Payloadéƒ¨åˆ†
{
  "sub": "user123",
  "username": "å¼ ä¸‰",
  "role": "admin", 
  "exp": 1692720000,
  "iat": 1692630000
}
```

---

## 4. ğŸ” JWTè§£æä¸éªŒè¯æµç¨‹


### 4.1 JWTè§£æçš„4ä¸ªæ­¥éª¤


```
JWTè§£æéªŒè¯æµç¨‹ï¼š
æ­¥éª¤ 1ï¸âƒ£ï¼šåˆ†å‰²JWTè·å–ä¸‰ä¸ªéƒ¨åˆ†
æ­¥éª¤ 2ï¸âƒ£ï¼šéªŒè¯ç­¾åæ˜¯å¦æ­£ç¡®
æ­¥éª¤ 3ï¸âƒ£ï¼šæ£€æŸ¥ä»¤ç‰Œæ˜¯å¦è¿‡æœŸ
æ­¥éª¤ 4ï¸âƒ£ï¼šæå–å¹¶è¿”å›ç”¨æˆ·ä¿¡æ¯
```

### 4.2 Javaè§£æJWTä»£ç 


```java
@Component
public class JwtUtil {
    
    private String secretKey = "mySecretKey123456";
    
    /**
     * è§£æJWTä»¤ç‰Œ
     * @param token JWTå­—ç¬¦ä¸²
     * @return è§£æå‡ºçš„Claimså¯¹è±¡
     */
    public Claims parseToken(String token) {
        try {
            return Jwts.parser()
                    .setSigningKey(secretKey)      // è®¾ç½®å¯†é’¥
                    .parseClaimsJws(token)         // è§£æä»¤ç‰Œ
                    .getBody();                    // è·å–è½½è·å†…å®¹
        } catch (ExpiredJwtException e) {
            throw new RuntimeException("ä»¤ç‰Œå·²è¿‡æœŸ");
        } catch (JwtException e) {
            throw new RuntimeException("æ— æ•ˆçš„ä»¤ç‰Œ");
        }
    }
    
    /**
     * ä»ä»¤ç‰Œä¸­è·å–ç”¨æˆ·å
     */
    public String getUsernameFromToken(String token) {
        Claims claims = parseToken(token);
        return claims.get("username", String.class);
    }
    
    /**
     * ä»ä»¤ç‰Œä¸­è·å–ç”¨æˆ·ID
     */
    public String getUserIdFromToken(String token) {
        Claims claims = parseToken(token);
        return claims.getSubject();
    }
    
    /**
     * æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦è¿‡æœŸ
     */
    public boolean isTokenExpired(String token) {
        try {
            Claims claims = parseToken(token);
            Date expiration = claims.getExpiration();
            return expiration.before(new Date());
        } catch (Exception e) {
            return true;  // è§£æå¤±è´¥è§†ä¸ºè¿‡æœŸ
        }
    }
}
```

### 4.3 åœ¨æ‹¦æˆªå™¨ä¸­ä½¿ç”¨


```java
@Component
public class JwtInterceptor implements HandlerInterceptor {
    
    @Autowired
    private JwtUtil jwtUtil;
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler) throws Exception {
        
        // 1. ä»è¯·æ±‚å¤´è·å–token
        String token = request.getHeader("Authorization");
        if (token == null || !token.startsWith("Bearer ")) {
            response.setStatus(401);
            return false;
        }
        
        // 2. å»æ‰"Bearer "å‰ç¼€
        token = token.substring(7);
        
        try {
            // 3. è§£æéªŒè¯token
            Claims claims = jwtUtil.parseToken(token);
            
            // 4. å°†ç”¨æˆ·ä¿¡æ¯å­˜å…¥è¯·æ±‚ä¸­ï¼Œä¾›åç»­ä½¿ç”¨
            request.setAttribute("userId", claims.getSubject());
            request.setAttribute("username", claims.get("username"));
            request.setAttribute("role", claims.get("role"));
            
            return true;  // éªŒè¯é€šè¿‡ï¼Œç»§ç»­å¤„ç†è¯·æ±‚
            
        } catch (Exception e) {
            response.setStatus(401);
            return false;  // éªŒè¯å¤±è´¥ï¼Œæ‹’ç»è®¿é—®
        }
    }
}
```

---

## 5. ğŸ” ç­¾åéªŒè¯æœºåˆ¶è¯¦è§£


### 5.1 æ‰‹åŠ¨éªŒè¯ç­¾åè¿‡ç¨‹


**ç­¾åéªŒè¯åŸç†**ï¼š
```
éªŒè¯è¿‡ç¨‹ï¼š
1. æ¥æ”¶JWTï¼šheader.payload.signature
2. é‡æ–°è®¡ç®—ï¼šnewSignature = HMAC(header.payload, secret)
3. å¯¹æ¯”ç­¾åï¼šnewSignature === signature
4. éªŒè¯ç»“æœï¼šç›¸ç­‰=æœ‰æ•ˆï¼Œä¸ç­‰=æ— æ•ˆ/è¢«ç¯¡æ”¹
```

**æ‰‹åŠ¨éªŒè¯ä»£ç ç¤ºä¾‹**ï¼š
```java
public boolean manualVerifySignature(String token, String secretKey) {
    // 1. åˆ†å‰²JWT
    String[] parts = token.split("\\.");
    if (parts.length != 3) {
        return false;
    }
    
    String header = parts[0];
    String payload = parts[1];
    String signature = parts[2];
    
    // 2. é‡æ–°è®¡ç®—ç­¾å
    String data = header + "." + payload;
    String expectedSignature = calculateHmacSha256(data, secretKey);
    
    // 3. å¯¹æ¯”ç­¾å
    return signature.equals(expectedSignature);
}

// HMAC-SHA256ç­¾åè®¡ç®—
private String calculateHmacSha256(String data, String key) {
    try {
        Mac mac = Mac.getInstance("HmacSHA256");
        SecretKeySpec keySpec = new SecretKeySpec(key.getBytes(), "HmacSHA256");
        mac.init(keySpec);
        
        byte[] signatureBytes = mac.doFinal(data.getBytes());
        return Base64.getUrlEncoder().withoutPadding()
                .encodeToString(signatureBytes);
    } catch (Exception e) {
        throw new RuntimeException("ç­¾åè®¡ç®—å¤±è´¥", e);
    }
}
```

### 5.2 ä½¿ç”¨åº“è‡ªåŠ¨éªŒè¯ vs æ‰‹åŠ¨éªŒè¯


| ğŸ†š å¯¹æ¯”é¡¹ | **è‡ªåŠ¨éªŒè¯ï¼ˆæ¨èï¼‰** | **æ‰‹åŠ¨éªŒè¯** |
|-----------|-------------------|------------|
| **å¤æ‚åº¦** | â­ ç®€å• | â­â­â­ å¤æ‚ |
| **å®‰å…¨æ€§** | â­â­â­â­â­ é«˜ | â­â­â­ ä¸­ |
| **ç»´æŠ¤æ€§** | â­â­â­â­â­ å¥½ | â­â­ å·® |
| **æ€§èƒ½** | â­â­â­â­ ä¼˜ | â­â­â­ ä¸€èˆ¬ |
| **é€‚ç”¨åœºæ™¯** | ç”Ÿäº§ç¯å¢ƒ | å­¦ä¹ ç†è§£ |

> ğŸ’¡ **å»ºè®®**
> 
> - **ç”Ÿäº§ç¯å¢ƒ**ï¼šä½¿ç”¨æˆç†Ÿçš„JWTåº“ï¼ˆå¦‚jjwtã€auth0ï¼‰
> - **å­¦ä¹ é˜¶æ®µ**ï¼šå¯ä»¥æ‰‹åŠ¨å®ç°ç†è§£åŸç†
> - **å®‰å…¨ç¬¬ä¸€**ï¼šåº“ç»è¿‡å¤§é‡æµ‹è¯•ï¼Œæ›´å®‰å…¨å¯é 

---

## 6. â° è¿‡æœŸæ—¶é—´ç®¡ç†ä¸åˆ·æ–°ç­–ç•¥


### 6.1 è¿‡æœŸæ—¶é—´ï¼ˆexpï¼‰è®¾ç½®


**å¸¸è§è¿‡æœŸæ—¶é—´è®¾ç½®**ï¼š
```java
public class TokenConfig {
    // è®¿é—®ä»¤ç‰Œï¼šçŸ­æœŸæœ‰æ•ˆï¼ˆ15åˆ†é’Ÿ-2å°æ—¶ï¼‰
    public static final long ACCESS_TOKEN_EXPIRY = 2 * 60 * 60 * 1000;  // 2å°æ—¶
    
    // åˆ·æ–°ä»¤ç‰Œï¼šé•¿æœŸæœ‰æ•ˆï¼ˆ7å¤©-30å¤©ï¼‰
    public static final long REFRESH_TOKEN_EXPIRY = 7 * 24 * 60 * 60 * 1000;  // 7å¤©
}
```

**è®¾ç½®è¿‡æœŸæ—¶é—´**ï¼š
```java
public String generateAccessToken(String userId) {
    Date now = new Date();
    Date expiry = new Date(now.getTime() + ACCESS_TOKEN_EXPIRY);
    
    return Jwts.builder()
            .setSubject(userId)
            .setIssuedAt(now)
            .setExpiration(expiry)  // è®¾ç½®è¿‡æœŸæ—¶é—´
            .signWith(SignatureAlgorithm.HS256, secretKey)
            .compact();
}
```

### 6.2 åŒTokenåˆ·æ–°ç­–ç•¥


**åˆ·æ–°æœºåˆ¶å›¾è§£**ï¼š
```
åŒTokenå·¥ä½œæµç¨‹ï¼š
å®¢æˆ·ç«¯                    æœåŠ¡ç«¯
   |                        |
   |â”€â”€[1]ç™»å½•è¯·æ±‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’|
   |â†â”€[2]è®¿é—®Token+åˆ·æ–°Tokenâ”€|
   |                        |
   |â”€â”€[3]ç”¨è®¿é—®Tokenè¯·æ±‚â”€â”€â”€â†’|  âœ… è®¿é—®Tokenæœ‰æ•ˆ
   |â†â”€[4]è¿”å›æ•°æ®â”€â”€â”€â”€â”€â”€â”€â”€â”€---|
   |                        |
   |â”€â”€[5]ç”¨è®¿é—®Tokenè¯·æ±‚â”€â”€â”€â†’|  âŒ è®¿é—®Tokenè¿‡æœŸ
   |â†â”€[6]è¿”å›401é”™è¯¯â”€â”€â”€â”€â”€â”€---|
   |                        |
   |â”€â”€[7]ç”¨åˆ·æ–°Tokenè¯·æ±‚â”€â”€â”€â†’|  ğŸ”„ åˆ·æ–°Tokenæœ‰æ•ˆ
   |â†â”€[8]è¿”å›æ–°çš„è®¿é—®Tokenâ”€---|
```

**åˆ·æ–°Tokenå®ç°**ï¼š
```java
@RestController
public class TokenController {
    
    @PostMapping("/refresh")
    public ResponseEntity<?> refreshToken(@RequestBody RefreshRequest request) {
        String refreshToken = request.getRefreshToken();
        
        try {
            // 1. éªŒè¯åˆ·æ–°Tokenæ˜¯å¦æœ‰æ•ˆ
            Claims claims = jwtUtil.parseToken(refreshToken);
            
            // 2. æ£€æŸ¥æ˜¯å¦ä¸ºåˆ·æ–°Tokenç±»å‹
            String tokenType = claims.get("type", String.class);
            if (!"refresh".equals(tokenType)) {
                return ResponseEntity.badRequest().body("æ— æ•ˆçš„åˆ·æ–°ä»¤ç‰Œ");
            }
            
            // 3. ç”Ÿæˆæ–°çš„è®¿é—®Token
            String userId = claims.getSubject();
            String newAccessToken = jwtUtil.generateAccessToken(userId);
            
            // 4. å¯é€‰ï¼šç”Ÿæˆæ–°çš„åˆ·æ–°Tokenï¼ˆæ»šåŠ¨åˆ·æ–°ï¼‰
            String newRefreshToken = jwtUtil.generateRefreshToken(userId);
            
            return ResponseEntity.ok(new TokenResponse(newAccessToken, newRefreshToken));
            
        } catch (Exception e) {
            return ResponseEntity.status(401).body("åˆ·æ–°ä»¤ç‰Œæ— æ•ˆæˆ–å·²è¿‡æœŸ");
        }
    }
}
```

### 6.3 è¿‡æœŸå¤„ç†æœ€ä½³å®è·µ


**å®¢æˆ·ç«¯è‡ªåŠ¨åˆ·æ–°æœºåˆ¶**ï¼š
```javascript
// å‰ç«¯æ‹¦æˆªå™¨ç¤ºä¾‹
axios.interceptors.response.use(
    response => response,  // æˆåŠŸå“åº”ç›´æ¥è¿”å›
    async error => {
        if (error.response.status === 401) {
            // è®¿é—®Tokenè¿‡æœŸï¼Œå°è¯•åˆ·æ–°
            try {
                const refreshToken = localStorage.getItem('refreshToken');
                const response = await axios.post('/auth/refresh', {
                    refreshToken: refreshToken
                });
                
                // æ›´æ–°Token
                const newAccessToken = response.data.accessToken;
                localStorage.setItem('accessToken', newAccessToken);
                
                // é‡æ–°å‘é€åŸè¯·æ±‚
                error.config.headers.Authorization = `Bearer ${newAccessToken}`;
                return axios.request(error.config);
                
            } catch (refreshError) {
                // åˆ·æ–°å¤±è´¥ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
                localStorage.clear();
                window.location.href = '/login';
            }
        }
        return Promise.reject(error);
    }
);
```

---

## 7. ğŸŒ å¤šè¯­è¨€JWTæ“ä½œå®æˆ˜


### 7.1 Node.jsä¸­JWTæ“ä½œ


**å®‰è£…jsonwebtokenåº“**ï¼š
```bash
npm install jsonwebtoken
```

**ç”ŸæˆJWT**ï¼š
```javascript
const jwt = require('jsonwebtoken');

// ç”ŸæˆToken
function generateToken(userId, username, role) {
    const payload = {
        sub: userId,        // ç”¨æˆ·ID
        username: username, // ç”¨æˆ·å
        role: role,         // è§’è‰²
        exp: Math.floor(Date.now() / 1000) + (60 * 60 * 2), // 2å°æ—¶åè¿‡æœŸ
        iat: Math.floor(Date.now() / 1000)  // å½“å‰æ—¶é—´
    };
    
    const secretKey = 'mySecretKey123456';
    
    return jwt.sign(payload, secretKey, { algorithm: 'HS256' });
}

// ä½¿ç”¨ç¤ºä¾‹
const token = generateToken('user123', 'å¼ ä¸‰', 'admin');
console.log('ç”Ÿæˆçš„Token:', token);
```

**è§£æéªŒè¯JWT**ï¼š
```javascript
// è§£æToken
function parseToken(token) {
    const secretKey = 'mySecretKey123456';
    
    try {
        const decoded = jwt.verify(token, secretKey);
        return {
            success: true,
            data: decoded
        };
    } catch (error) {
        let errorMsg = 'ä»¤ç‰ŒéªŒè¯å¤±è´¥';
        
        if (error.name === 'TokenExpiredError') {
            errorMsg = 'ä»¤ç‰Œå·²è¿‡æœŸ';
        } else if (error.name === 'JsonWebTokenError') {
            errorMsg = 'æ— æ•ˆçš„ä»¤ç‰Œ';
        }
        
        return {
            success: false,
            error: errorMsg
        };
    }
}

// Expressä¸­é—´ä»¶
function jwtMiddleware(req, res, next) {
    const authHeader = req.headers['authorization'];
    const token = authHeader && authHeader.split(' ')[1]; // Bearer TOKEN
    
    if (!token) {
        return res.status(401).json({ error: 'ç¼ºå°‘è®¿é—®ä»¤ç‰Œ' });
    }
    
    const result = parseToken(token);
    if (!result.success) {
        return res.status(401).json({ error: result.error });
    }
    
    req.user = result.data; // å°†ç”¨æˆ·ä¿¡æ¯å­˜å…¥è¯·æ±‚å¯¹è±¡
    next();
}
```

### 7.2 Pythonä¸­JWTæ“ä½œ


**å®‰è£…PyJWTåº“**ï¼š
```bash
pip install PyJWT
```

**ç”ŸæˆJWT**ï¼š
```python
import jwt
import datetime

class JWTUtil:
    def __init__(self):
        self.secret_key = 'mySecretKey123456'
        self.algorithm = 'HS256'
    
    def generate_token(self, user_id, username, role):
        """ç”ŸæˆJWTä»¤ç‰Œ"""
        now = datetime.datetime.utcnow()
        expiry = now + datetime.timedelta(hours=2)  # 2å°æ—¶åè¿‡æœŸ
        
        payload = {
            'sub': user_id,          # ç”¨æˆ·ID
            'username': username,    # ç”¨æˆ·å  
            'role': role,           # è§’è‰²
            'exp': expiry,          # è¿‡æœŸæ—¶é—´
            'iat': now             # ç­¾å‘æ—¶é—´
        }
        
        token = jwt.encode(payload, self.secret_key, algorithm=self.algorithm)
        return token
    
    def parse_token(self, token):
        """è§£æéªŒè¯JWTä»¤ç‰Œ"""
        try:
            payload = jwt.decode(
                token, 
                self.secret_key, 
                algorithms=[self.algorithm]
            )
            return {
                'success': True,
                'data': payload
            }
        except jwt.ExpiredSignatureError:
            return {
                'success': False,
                'error': 'ä»¤ç‰Œå·²è¿‡æœŸ'
            }
        except jwt.InvalidTokenError:
            return {
                'success': False,
                'error': 'æ— æ•ˆçš„ä»¤ç‰Œ'
            }

# ä½¿ç”¨ç¤ºä¾‹
jwt_util = JWTUtil()

# ç”Ÿæˆä»¤ç‰Œ
token = jwt_util.generate_token('user123', 'å¼ ä¸‰', 'admin')
print(f'ç”Ÿæˆçš„Token: {token}')

# è§£æä»¤ç‰Œ
result = jwt_util.parse_token(token)
if result['success']:
    print(f'ç”¨æˆ·ä¿¡æ¯: {result["data"]}')
else:
    print(f'é”™è¯¯: {result["error"]}')
```

**Flaskä¸­ä½¿ç”¨**ï¼š
```python
from flask import Flask, request, jsonify
from functools import wraps

app = Flask(__name__)
jwt_util = JWTUtil()

def token_required(f):
    """JWTéªŒè¯è£…é¥°å™¨"""
    @wraps(f)
    def decorated(*args, **kwargs):
        token = None
        
        # ä»è¯·æ±‚å¤´è·å–token
        if 'Authorization' in request.headers:
            auth_header = request.headers['Authorization']
            if auth_header.startswith('Bearer '):
                token = auth_header[7:]  # å»æ‰'Bearer '
        
        if not token:
            return jsonify({'error': 'ç¼ºå°‘è®¿é—®ä»¤ç‰Œ'}), 401
        
        # éªŒè¯token
        result = jwt_util.parse_token(token)
        if not result['success']:
            return jsonify({'error': result['error']}), 401
        
        # å°†ç”¨æˆ·ä¿¡æ¯ä¼ é€’ç»™è·¯ç”±å‡½æ•°
        return f(result['data'], *args, **kwargs)
    
    return decorated

@app.route('/protected')
@token_required
def protected_route(current_user):
    return jsonify({
        'message': 'è®¿é—®æˆåŠŸ',
        'user': current_user['username'],
        'role': current_user['role']
    })
```

---

## 8. âš ï¸ å¼‚å¸¸å¤„ç†ä¸é”™è¯¯ç 


### 8.1 å¸¸è§JWTå¼‚å¸¸ç±»å‹


**å¼‚å¸¸åˆ†ç±»è¡¨**ï¼š
| ğŸš« å¼‚å¸¸ç±»å‹ | **å«ä¹‰** | **åŸå› ** | **å¤„ç†æ–¹å¼** |
|------------|----------|----------|------------|
| `ExpiredJwtException` | ä»¤ç‰Œè¿‡æœŸ | è¶…è¿‡è®¾ç½®çš„è¿‡æœŸæ—¶é—´ | å¼•å¯¼ç”¨æˆ·åˆ·æ–°æˆ–é‡æ–°ç™»å½• |
| `MalformedJwtException` | ä»¤ç‰Œæ ¼å¼é”™è¯¯ | JWTæ ¼å¼ä¸æ­£ç¡® | è¿”å›400é”™è¯¯ï¼Œè¦æ±‚é‡æ–°è·å– |
| `SignatureException` | ç­¾åéªŒè¯å¤±è´¥ | å¯†é’¥ä¸åŒ¹é…æˆ–è¢«ç¯¡æ”¹ | è¿”å›401é”™è¯¯ï¼Œæ‹’ç»è®¿é—® |
| `UnsupportedJwtException` | ä¸æ”¯æŒçš„JWT | ä½¿ç”¨äº†ä¸æ”¯æŒçš„ç®—æ³• | è¿”å›400é”™è¯¯ |
| `IllegalArgumentException` | å‚æ•°éæ³• | ä¼ å…¥ç©ºå€¼æˆ–éæ³•å€¼ | è¿”å›400é”™è¯¯ |

### 8.2 ç»Ÿä¸€å¼‚å¸¸å¤„ç†


**Javaå¼‚å¸¸å¤„ç†**ï¼š
```java
@Component
public class JwtUtil {
    
    public JwtResult parseTokenSafely(String token) {
        try {
            Claims claims = Jwts.parser()
                    .setSigningKey(secretKey)
                    .parseClaimsJws(token)
                    .getBody();
            
            return JwtResult.success(claims);
            
        } catch (ExpiredJwtException e) {
            return JwtResult.error(JwtErrorCode.TOKEN_EXPIRED, "ä»¤ç‰Œå·²è¿‡æœŸ");
            
        } catch (MalformedJwtException e) {
            return JwtResult.error(JwtErrorCode.TOKEN_MALFORMED, "ä»¤ç‰Œæ ¼å¼é”™è¯¯");
            
        } catch (SignatureException e) {
            return JwtResult.error(JwtErrorCode.SIGNATURE_INVALID, "ç­¾åéªŒè¯å¤±è´¥");
            
        } catch (UnsupportedJwtException e) {
            return JwtResult.error(JwtErrorCode.TOKEN_UNSUPPORTED, "ä¸æ”¯æŒçš„ä»¤ç‰Œç±»å‹");
            
        } catch (IllegalArgumentException e) {
            return JwtResult.error(JwtErrorCode.TOKEN_ILLEGAL, "ä»¤ç‰Œå‚æ•°éæ³•");
            
        } catch (Exception e) {
            return JwtResult.error(JwtErrorCode.UNKNOWN_ERROR, "æœªçŸ¥é”™è¯¯");
        }
    }
}

// ç»“æœå°è£…ç±»
public class JwtResult {
    private boolean success;
    private JwtErrorCode errorCode;
    private String errorMessage;
    private Claims data;
    
    public static JwtResult success(Claims claims) {
        JwtResult result = new JwtResult();
        result.success = true;
        result.data = claims;
        return result;
    }
    
    public static JwtResult error(JwtErrorCode code, String message) {
        JwtResult result = new JwtResult();
        result.success = false;
        result.errorCode = code;
        result.errorMessage = message;
        return result;
    }
    
    // getterå’Œsetteræ–¹æ³•...
}
```

### 8.3 é”™è¯¯ç å®šä¹‰


**é”™è¯¯ç æšä¸¾**ï¼š
```java
public enum JwtErrorCode {
    TOKEN_EXPIRED(1001, "ä»¤ç‰Œå·²è¿‡æœŸ"),
    TOKEN_MALFORMED(1002, "ä»¤ç‰Œæ ¼å¼é”™è¯¯"),
    SIGNATURE_INVALID(1003, "ç­¾åéªŒè¯å¤±è´¥"),
    TOKEN_UNSUPPORTED(1004, "ä¸æ”¯æŒçš„ä»¤ç‰Œç±»å‹"),
    TOKEN_ILLEGAL(1005, "ä»¤ç‰Œå‚æ•°éæ³•"),
    TOKEN_MISSING(1006, "ç¼ºå°‘è®¿é—®ä»¤ç‰Œ"),
    UNKNOWN_ERROR(1999, "æœªçŸ¥é”™è¯¯");
    
    private final int code;
    private final String message;
    
    JwtErrorCode(int code, String message) {
        this.code = code;
        this.message = message;
    }
    
    public int getCode() { return code; }
    public String getMessage() { return message; }
}
```

### 8.4 å‰ç«¯é”™è¯¯å¤„ç†


**JavaScripté”™è¯¯å¤„ç†**ï¼š
```javascript
class JwtHandler {
    static handleJwtError(errorCode, errorMessage) {
        switch (errorCode) {
            case 1001: // TOKEN_EXPIRED
                console.warn('ä»¤ç‰Œå·²è¿‡æœŸï¼Œå°è¯•åˆ·æ–°...');
                return this.refreshToken();
                
            case 1002: // TOKEN_MALFORMED
            case 1003: // SIGNATURE_INVALID
                console.error('ä»¤ç‰Œæ— æ•ˆï¼Œéœ€è¦é‡æ–°ç™»å½•');
                this.redirectToLogin();
                break;
                
            case 1006: // TOKEN_MISSING
                console.warn('ç¼ºå°‘è®¿é—®ä»¤ç‰Œ');
                this.redirectToLogin();
                break;
                
            default:
                console.error(`JWTé”™è¯¯: ${errorMessage}`);
                this.showErrorMessage(errorMessage);
        }
    }
    
    static refreshToken() {
        // åˆ·æ–°ä»¤ç‰Œé€»è¾‘
        const refreshToken = localStorage.getItem('refreshToken');
        if (!refreshToken) {
            this.redirectToLogin();
            return;
        }
        
        // è°ƒç”¨åˆ·æ–°æ¥å£...
    }
    
    static redirectToLogin() {
        localStorage.clear();
        window.location.href = '/login';
    }
    
    static showErrorMessage(message) {
        // æ˜¾ç¤ºé”™è¯¯æç¤º
        alert(`è®¤è¯é”™è¯¯: ${message}`);
    }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ JWTç»“æ„ï¼šHeader.Payload.Signature ä¸‰éƒ¨åˆ†ç»„æˆ
ğŸ”¸ ç”Ÿæˆæµç¨‹ï¼šå‡†å¤‡æ•°æ® â†’ Base64ç¼–ç  â†’ HMACç­¾å â†’ æ‹¼æ¥ä»¤ç‰Œ
ğŸ”¸ è§£ææµç¨‹ï¼šåˆ†å‰²ä»¤ç‰Œ â†’ éªŒè¯ç­¾å â†’ æ£€æŸ¥è¿‡æœŸ â†’ æå–ä¿¡æ¯
ğŸ”¸ ç­¾åéªŒè¯ï¼šç¡®ä¿ä»¤ç‰Œå®Œæ•´æ€§ï¼Œé˜²æ­¢æ•°æ®è¢«ç¯¡æ”¹
ğŸ”¸ è¿‡æœŸç®¡ç†ï¼šåˆç†è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå®ç°ä»¤ç‰Œåˆ·æ–°æœºåˆ¶
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ JWTç”Ÿæˆçš„æœ¬è´¨**
```
ç†è§£è¦ç‚¹ï¼š
- JWTä¸æ˜¯åŠ å¯†ï¼Œè€Œæ˜¯ç¼–ç +ç­¾å
- ä»»ä½•äººéƒ½å¯ä»¥è§£ç çœ‹åˆ°å†…å®¹ï¼ˆæ‰€ä»¥ä¸è¦æ”¾æ•æ„Ÿä¿¡æ¯ï¼‰
- ç­¾åç¡®ä¿å†…å®¹æ²¡æœ‰è¢«ä¿®æ”¹
- å¯†é’¥åªæœ‰æœåŠ¡å™¨çŸ¥é“ï¼Œåˆ«äººæ— æ³•ä¼ªé€ ç­¾å
```

**ğŸ”¹ è¿‡æœŸæ—¶é—´çš„è®¾è®¡æ€è·¯**
```
è®¾è®¡åŸåˆ™ï¼š
- è®¿é—®ä»¤ç‰Œï¼šçŸ­æœŸï¼ˆ2å°æ—¶å†…ï¼‰ï¼Œé¢‘ç¹ä½¿ç”¨
- åˆ·æ–°ä»¤ç‰Œï¼šé•¿æœŸï¼ˆ7å¤©å†…ï¼‰ï¼Œå¶å°”ä½¿ç”¨
- å¹³è¡¡å®‰å…¨æ€§ä¸ç”¨æˆ·ä½“éªŒ
- è‡ªåŠ¨åˆ·æ–°å‡å°‘ç”¨æˆ·æ„ŸçŸ¥
```

**ğŸ”¹ å¼‚å¸¸å¤„ç†çš„é‡è¦æ€§**
```
ä¸ºä»€ä¹ˆé‡è¦ï¼š
- æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
- å¼•å¯¼ç”¨æˆ·æ­£ç¡®æ“ä½œ
- é˜²æ­¢å®‰å…¨ä¿¡æ¯æ³„éœ²
- æå‡ç”¨æˆ·ä½“éªŒ
```

### 9.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ’» å¼€å‘åœºæ™¯åº”ç”¨**
- **å‰åç«¯åˆ†ç¦»**ï¼šJWTä½œä¸ºæ— çŠ¶æ€è®¤è¯æ–¹æ¡ˆ
- **å¾®æœåŠ¡æ¶æ„**ï¼šæœåŠ¡é—´ä¼ é€’ç”¨æˆ·èº«ä»½ä¿¡æ¯
- **ç§»åŠ¨ç«¯åº”ç”¨**ï¼šAppä¸APIæœåŠ¡å™¨çš„è®¤è¯
- **å•ç‚¹ç™»å½•**ï¼šå¤šä¸ªåº”ç”¨å…±äº«ç”¨æˆ·èº«ä»½

**ğŸ”§ è¿ç»´ç›‘æ§**
- **ä»¤ç‰Œä½¿ç”¨é‡**ï¼šç›‘æ§ç³»ç»Ÿè´Ÿè½½
- **è¿‡æœŸç‡ç»Ÿè®¡**ï¼šä¼˜åŒ–è¿‡æœŸæ—¶é—´è®¾ç½®
- **å¼‚å¸¸æŠ¥è­¦**ï¼šåŠæ—¶å‘ç°å®‰å…¨é—®é¢˜
- **æ€§èƒ½åˆ†æ**ï¼šJWTå¤„ç†æ€§èƒ½ä¼˜åŒ–

### 9.4 å®‰å…¨æœ€ä½³å®è·µ


```
ğŸ”’ å®‰å…¨å»ºè®®ï¼š
âœ… ä½¿ç”¨å¼ºå¯†é’¥ï¼ˆè‡³å°‘32ä½éšæœºå­—ç¬¦ï¼‰
âœ… è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´ï¼ˆä¸å®œè¿‡é•¿ï¼‰
âœ… æ•æ„Ÿä¿¡æ¯ä¸è¦æ”¾åœ¨JWTä¸­
âœ… ä½¿ç”¨HTTPSä¼ è¾“JWTä»¤ç‰Œ
âœ… å®ç°ä»¤ç‰Œé»‘åå•æœºåˆ¶ï¼ˆå¯é€‰ï¼‰
âœ… å®šæœŸè½®æ¢ç­¾åå¯†é’¥
âœ… ç›‘æ§å¼‚å¸¸çš„JWTè¯·æ±‚
```

**ğŸ¯ æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- JWT = ä¿¡æ¯åŒ…è£… + é˜²ä¼ªç­¾å
- ç”Ÿæˆå®¹æ˜“ï¼ŒéªŒè¯ä¸¥æ ¼
- æ— çŠ¶æ€è®¾è®¡ï¼Œä¾¿äºæ‰©å±•
- åˆç†è¿‡æœŸï¼ŒåŠæ—¶åˆ·æ–°
- å®‰å…¨ç¬¬ä¸€ï¼Œç”¨æˆ·ä½“éªŒç¬¬äºŒ