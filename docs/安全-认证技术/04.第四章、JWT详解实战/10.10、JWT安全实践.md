---
title: 10ã€JWTå®‰å…¨å®è·µ
---
## ğŸ“š ç›®å½•

1. [JWTä¼˜ç¼ºç‚¹æ·±åº¦åˆ†æ](#1-JWTä¼˜ç¼ºç‚¹æ·±åº¦åˆ†æ)
2. [æ— çŠ¶æ€è®¤è¯æœºåˆ¶è¯¦è§£](#2-æ— çŠ¶æ€è®¤è¯æœºåˆ¶è¯¦è§£)
3. [JWTå¸¸è§å®‰å…¨æ¼æ´](#3-JWTå¸¸è§å®‰å…¨æ¼æ´)
4. [JWTå®‰å…¨æœ€ä½³å®è·µ](#4-JWTå®‰å…¨æœ€ä½³å®è·µ)
5. [JWTå®æˆ˜åº”ç”¨åœºæ™¯](#5-JWTå®æˆ˜åº”ç”¨åœºæ™¯)
6. [å®Œæ•´ä»£ç å®ç°ç¤ºä¾‹](#6-å®Œæ•´ä»£ç å®ç°ç¤ºä¾‹)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ JWTä¼˜ç¼ºç‚¹æ·±åº¦åˆ†æ


### 1.1 ä»€ä¹ˆæ˜¯JWTçš„æœ¬è´¨ä¼˜åŠ¿


**ğŸ”¸ æ— çŠ¶æ€è®¤è¯æœºåˆ¶**
```
ä¼ ç»ŸSessionæ–¹å¼ï¼š
ç”¨æˆ·ç™»å½• â†’ æœåŠ¡å™¨å­˜å‚¨Session â†’ è¿”å›SessionID
ç”¨æˆ·è¯·æ±‚ â†’ æºå¸¦SessionID â†’ æœåŠ¡å™¨æŸ¥æ‰¾Sessionæ•°æ®

JWTæ–¹å¼ï¼š
ç”¨æˆ·ç™»å½• â†’ æœåŠ¡å™¨ç­¾å‘JWT â†’ è¿”å›JWT
ç”¨æˆ·è¯·æ±‚ â†’ æºå¸¦JWT â†’ æœåŠ¡å™¨éªŒè¯JWTç­¾å

å…³é”®åŒºåˆ«ï¼šJWTè‡ªåŒ…å«æ‰€æœ‰ä¿¡æ¯ï¼ŒæœåŠ¡å™¨ä¸éœ€è¦å­˜å‚¨ä»»ä½•çŠ¶æ€ï¼
```

**ğŸ’¡ å®é™…å¥½å¤„è¯´äººè¯**
- **æœåŠ¡å™¨ä¸ç”¨è®°å¿†**ï¼šå°±åƒèº«ä»½è¯ä¸€æ ·ï¼Œä¿¡æ¯éƒ½åœ¨å¡ç‰‡ä¸Šï¼Œä¸ç”¨å†æŸ¥æ¡£æ¡ˆ
- **å¤šæœåŠ¡å™¨å‹å¥½**ï¼šAæœåŠ¡å™¨å‘çš„ä»¤ç‰Œï¼ŒBæœåŠ¡å™¨ä¹Ÿèƒ½è®¤è¯†
- **å‡å°‘æ•°æ®åº“æŸ¥è¯¢**ï¼šä¸ç”¨æ¯æ¬¡éƒ½å»æ•°æ®åº“æŸ¥Session
- **å‰åç«¯åˆ†ç¦»å‹å¥½**ï¼šæ‰‹æœºAPPã€ç½‘é¡µéƒ½èƒ½ç”¨åŒä¸€å¥—è®¤è¯

### 1.2 JWTçš„çœŸå®ä¼˜åŠ¿


| ä¼˜åŠ¿ç‰¹ç‚¹ | **é€šä¿—è§£é‡Š** | **å®é™…ä»·å€¼** |
|---------|------------|-------------|
| ğŸŒ **è·¨åŸŸå‹å¥½** | `åƒé€šè¡Œè¯ï¼Œå“ªé‡Œéƒ½è®¤` | `å•ç‚¹ç™»å½•ã€å¾®æœåŠ¡æ¶æ„` |
| ğŸ“± **ç§»åŠ¨ç«¯é€‚é…** | `APPä¸ç”¨å­˜å‚¨å¤æ‚çŠ¶æ€` | `åŸç”Ÿåº”ç”¨ã€å°ç¨‹åºå¼€å‘` |
| âš¡ **æ€§èƒ½ä¼˜ç§€** | `ä¸ç”¨æ¯æ¬¡æŸ¥æ•°æ®åº“` | `é«˜å¹¶å‘åœºæ™¯ä¸‹å‡è½»å‹åŠ›` |
| ğŸ”„ **æ°´å¹³æ‰©å±•** | `æ–°æœåŠ¡å™¨ç«‹å³å¯ç”¨` | `äº‘éƒ¨ç½²ã€è´Ÿè½½å‡è¡¡` |

### 1.3 JWTçš„çœŸå®ç¼ºç‚¹


**ğŸš¨ å…³é”®ç¼ºç‚¹è¦æ˜ç™½**

```
âŒ ä»¤ç‰Œæ’¤é”€å›°éš¾ï¼š
é—®é¢˜ï¼šJWTä¸€æ—¦ç­¾å‘ï¼Œåœ¨è¿‡æœŸå‰éƒ½æœ‰æ•ˆ
æ¯”å–»ï¼šå°±åƒå‘å‡ºå»çš„é’ç¥¨ï¼Œå¾ˆéš¾æ”¶å›æ¥
å½±å“ï¼šç”¨æˆ·é€€å‡ºç™»å½•ï¼Œä»¤ç‰Œå¯èƒ½ä»ç„¶æœ‰æ•ˆ

âŒ ä»¤ç‰Œä½“ç§¯è¾ƒå¤§ï¼š
Session: é€šå¸¸32å­—èŠ‚çš„ID
JWT: é€šå¸¸å‡ ç™¾å­—èŠ‚åˆ°å‡ KB
å½±å“ï¼šå¢åŠ ç½‘ç»œä¼ è¾“å¼€é”€

âŒ å¯†é’¥ç®¡ç†å¤æ‚ï¼š
é—®é¢˜ï¼šå¯†é’¥æ³„éœ²å½±å“æ‰€æœ‰ä»¤ç‰Œ
è§£å†³ï¼šéœ€è¦å¯†é’¥è½®æ¢ã€HSMç­‰æ–¹æ¡ˆ
```

**ğŸ“Š ä¼˜ç¼ºç‚¹å¯¹æ¯”è¡¨**

| å¯¹æ¯”ç»´åº¦ | **JWT** | **Session** | **é€‚ç”¨åœºæ™¯** |
|---------|---------|-------------|-------------|
| ğŸ”’ **å®‰å…¨æ’¤é”€** | `å›°éš¾ï¼Œéœ€é¢å¤–æœºåˆ¶` | `ç®€å•ï¼Œåˆ é™¤å³å¯` | `Sessionæ›´é€‚åˆæ•æ„Ÿæ“ä½œ` |
| ğŸ“¦ **å­˜å‚¨å¼€é”€** | `å®¢æˆ·ç«¯å­˜å‚¨ï¼Œä½“ç§¯å¤§` | `æœåŠ¡ç«¯å­˜å‚¨ï¼Œä½“ç§¯å°` | `JWTé€‚åˆæ— çŠ¶æ€æœåŠ¡` |
| ğŸŒ **åˆ†å¸ƒå¼å‹å¥½** | `å¤©ç„¶æ”¯æŒ` | `éœ€å…±äº«å­˜å‚¨` | `JWTé€‚åˆå¾®æœåŠ¡` |
| âš¡ **æ€§èƒ½è¡¨ç°** | `è§£ç å¼€é”€ï¼Œæ— IO` | `æŸ¥è¯¢å¼€é”€ï¼Œæœ‰IO` | `çœ‹å…·ä½“åœºæ™¯` |

---

## 2. ğŸ—ï¸ æ— çŠ¶æ€è®¤è¯æœºåˆ¶è¯¦è§£


### 2.1 ä»€ä¹ˆå«æ— çŠ¶æ€è®¤è¯


**ğŸ¤” ä¼ ç»Ÿè®¤è¯çš„"æœ‰çŠ¶æ€"é—®é¢˜**
```
ç”¨æˆ·ç™»å½•æµç¨‹ï¼ˆä¼ ç»ŸSessionï¼‰ï¼š

å®¢æˆ·ç«¯                  æœåŠ¡å™¨                æ•°æ®åº“/ç¼“å­˜
  |                      |                      |
  |--[1]ç”¨æˆ·åå¯†ç ------->|                      |
  |                      |--[2]éªŒè¯ç”¨æˆ·-------->|
  |                      |<-[3]ç”¨æˆ·ä¿¡æ¯---------|
  |                      |--[4]åˆ›å»ºSession----->|
  |                      |<-[5]å­˜å‚¨æˆåŠŸ---------|
  |<--[6]è¿”å›SessionID---|                      |
  
æ¯æ¬¡è¯·æ±‚éƒ½éœ€è¦ï¼š
  |--[7]æºå¸¦SessionID--->|                      |
  |                      |--[8]æŸ¥è¯¢Session----->|
  |                      |<-[9]Sessionæ•°æ®------|
  |<--[10]å“åº”æ•°æ®-------|                      |

é—®é¢˜ï¼šæœåŠ¡å™¨å¿…é¡»"è®°ä½"æ¯ä¸ªç”¨æˆ·çš„çŠ¶æ€
```

**âœ¨ JWTçš„"æ— çŠ¶æ€"ä¼˜åŠ¿**
```
ç”¨æˆ·ç™»å½•æµç¨‹ï¼ˆJWTï¼‰ï¼š

å®¢æˆ·ç«¯                  æœåŠ¡å™¨
  |                      |
  |--[1]ç”¨æˆ·åå¯†ç ------->|
  |                      |--[2]éªŒè¯ç”¨æˆ·
  |                      |--[3]ç­¾å‘JWT
  |<--[4]è¿”å›JWT---------|
  
æ¯æ¬¡è¯·æ±‚ï¼š
  |--[5]æºå¸¦JWT--------->|
  |                      |--[6]éªŒè¯JWTç­¾å
  |                      |--[7]è§£æç”¨æˆ·ä¿¡æ¯
  |<--[8]å“åº”æ•°æ®-------|

ä¼˜åŠ¿ï¼šæœåŠ¡å™¨ä¸éœ€è¦å­˜å‚¨ä»»ä½•çŠ¶æ€ä¿¡æ¯ï¼
```

### 2.2 æ— çŠ¶æ€è®¤è¯çš„æ ¸å¿ƒåŸç†


**ğŸ” JWTè‡ªåŒ…å«ä¿¡æ¯æœºåˆ¶**
```javascript
// JWTåŒ…å«ä¸‰éƒ¨åˆ†ä¿¡æ¯
const jwtPayload = {
  // ç”¨æˆ·èº«ä»½ä¿¡æ¯
  userId: 12345,
  username: "john_doe",
  role: "admin",
  
  // æƒé™ä¿¡æ¯
  permissions: ["read", "write", "delete"],
  
  // æ—¶é—´æ§åˆ¶
  iat: 1641234567,  // ç­¾å‘æ—¶é—´
  exp: 1641321967   // è¿‡æœŸæ—¶é—´
}

// å…³é”®ç†è§£ï¼šæ‰€æœ‰è®¤è¯éœ€è¦çš„ä¿¡æ¯éƒ½åœ¨JWTé‡Œï¼
```

**ğŸ¯ æ— çŠ¶æ€çš„å®é™…å¥½å¤„**

```
åœºæ™¯1ï¼šå¤šæœåŠ¡å™¨éƒ¨ç½²
ä¼ ç»Ÿæ–¹å¼ï¼šéœ€è¦Sessionå…±äº«å­˜å‚¨ï¼ˆRedisé›†ç¾¤ï¼‰
JWTæ–¹å¼ï¼šæ¯ä¸ªæœåŠ¡å™¨éƒ½èƒ½ç‹¬ç«‹éªŒè¯

åœºæ™¯2ï¼šå¾®æœåŠ¡æ¶æ„  
ä¼ ç»Ÿæ–¹å¼ï¼šæ‰€æœ‰æœåŠ¡éƒ½è¦è¿åŒä¸€ä¸ªSessionå­˜å‚¨
JWTæ–¹å¼ï¼šæ¯ä¸ªæœåŠ¡ç‹¬ç«‹éªŒè¯ï¼Œäº’ä¸ä¾èµ–

åœºæ™¯3ï¼šç§»åŠ¨åº”ç”¨
ä¼ ç»Ÿæ–¹å¼ï¼šéœ€è¦ç»´æŠ¤å¤æ‚çš„SessionåŒæ­¥
JWTæ–¹å¼ï¼šAPPå­˜å‚¨JWTï¼Œç¦»çº¿ä¹Ÿèƒ½éªŒè¯éƒ¨åˆ†ä¿¡æ¯
```

---

## 3. ğŸš¨ JWTå¸¸è§å®‰å…¨æ¼æ´


### 3.1 ç®—æ³•æ··æ·†æ”»å‡»ï¼ˆAlgorithm Confusionï¼‰


**ğŸ” ä»€ä¹ˆæ˜¯ç®—æ³•æ··æ·†**
```
æ­£å¸¸æƒ…å†µï¼š
JWT Header: {"alg": "HS256", "typ": "JWT"}
æœåŠ¡å™¨ï¼šä½¿ç”¨HS256ç®—æ³• + å¯†é’¥éªŒè¯ç­¾å

æ”»å‡»æƒ…å†µï¼š
æ”»å‡»è€…ä¿®æ”¹Header: {"alg": "none", "typ": "JWT"}
æˆ–è€…: {"alg": "RS256", "typ": "JWT"}
æœåŠ¡å™¨ï¼šå¦‚æœæ²¡æœ‰ä¸¥æ ¼æ£€æŸ¥ç®—æ³•ï¼Œå¯èƒ½è¢«ç»•è¿‡
```

**âš ï¸ æ”»å‡»ç¤ºä¾‹è¯´æ˜**
```javascript
// å±é™©çš„ä»£ç å†™æ³•
function verifyToken(token) {
  const decoded = jwt.decode(token, {complete: true});
  const algorithm = decoded.header.alg;
  
  // å±é™©ï¼ç›´æ¥ä½¿ç”¨Tokenä¸­å£°æ˜çš„ç®—æ³•
  if (algorithm === 'HS256') {
    return jwt.verify(token, secret, {algorithm: 'HS256'});
  } else if (algorithm === 'RS256') {
    return jwt.verify(token, publicKey, {algorithm: 'RS256'});
  } else if (algorithm === 'none') {
    // éå¸¸å±é™©ï¼å…è®¸æ— ç­¾åéªŒè¯
    return jwt.decode(token);
  }
}
```

**ğŸ›¡ï¸ æ­£ç¡®é˜²æŠ¤æ–¹å¼**
```javascript
// å®‰å…¨çš„ä»£ç å†™æ³•
function verifyToken(token) {
  // å¼ºåˆ¶æŒ‡å®šç®—æ³•ï¼Œä¸ä¿¡ä»»Tokenä¸­çš„å£°æ˜
  return jwt.verify(token, secret, {
    algorithms: ['HS256']  // åªå…è®¸æŒ‡å®šç®—æ³•
  });
}
```

### 3.2 å¯†é’¥æ³„éœ²é£é™©


**ğŸ”‘ å¯†é’¥æ³„éœ²çš„ä¸¥é‡åæœ**
```
ä¸€æ—¦å¯†é’¥æ³„éœ²ï¼š
âœ— æ”»å‡»è€…å¯ä»¥ä¼ªé€ ä»»æ„JWT
âœ— å¯ä»¥æ¨¡æ‹Ÿä»»æ„ç”¨æˆ·èº«ä»½
âœ— å¯ä»¥è®¾ç½®ä»»æ„æƒé™å’Œè¿‡æœŸæ—¶é—´
âœ— ç°æœ‰æ‰€æœ‰JWTéƒ½å˜å¾—ä¸å¯ä¿¡
```

**ğŸ¯ å¯†é’¥æ³„éœ²å¸¸è§åŸå› **
- **ä»£ç æ³„éœ²**ï¼šå¯†é’¥ç›´æ¥å†™åœ¨ä»£ç é‡Œæäº¤åˆ°Git
- **æ—¥å¿—æ³„éœ²**ï¼šå¯†é’¥è¢«æ‰“å°åˆ°æ—¥å¿—æ–‡ä»¶ä¸­  
- **é…ç½®æ³„éœ²**ï¼šé…ç½®æ–‡ä»¶æƒé™è®¾ç½®ä¸å½“
- **å†…å­˜æ³„éœ²**ï¼šæœåŠ¡å™¨è¢«æ”»å‡»ï¼Œå†…å­˜æ•°æ®è¢«è¯»å–

### 3.3 æ—¶é—´æ”»å‡»ï¼ˆTiming Attackï¼‰


**â° ä»€ä¹ˆæ˜¯æ—¶é—´æ”»å‡»**
```python
# å±é™©çš„å¯†é’¥æ¯”è¾ƒæ–¹å¼
def verify_signature(signature1, signature2):
    if len(signature1) != len(signature2):
        return False
    
    for i in range(len(signature1)):
        if signature1[i] != signature2[i]:
            return False  # ç«‹å³è¿”å›ï¼Œæš´éœ²æ—¶é—´å·®å¼‚
    return True

# æ”»å‡»åŸç†ï¼š
# æ­£ç¡®å‰ç¼€è¶Šé•¿ï¼Œæ¯”è¾ƒæ—¶é—´è¶Šä¹…
# æ”»å‡»è€…å¯ä»¥é€šè¿‡æ—¶é—´å·®å¼‚é€ä½çŒœæµ‹æ­£ç¡®ç­¾å
```

**ğŸ›¡ï¸ é˜²æŠ¤ï¼šæ’å®šæ—¶é—´æ¯”è¾ƒ**
```python
# å®‰å…¨çš„æ¯”è¾ƒæ–¹å¼
import hmac

def verify_signature(signature1, signature2):
    # ä½¿ç”¨hmac.compare_digestè¿›è¡Œæ’å®šæ—¶é—´æ¯”è¾ƒ
    return hmac.compare_digest(signature1, signature2)
```

### 3.4 JWTåŠ«æŒä¸é‡æ”¾æ”»å‡»


**ğŸ­ ä»¤ç‰ŒåŠ«æŒåœºæ™¯**
```
æ”»å‡»åœºæ™¯ï¼š
1. ç½‘ç»œå—…æ¢ï¼šHTTPä¼ è¾“è¢«æˆªè·
2. XSSæ”»å‡»ï¼šæ¶æ„è„šæœ¬çªƒå–localStorageä¸­çš„JWT
3. æ¶æ„è½¯ä»¶ï¼šæœ¬åœ°å­˜å‚¨è¢«æ¶æ„ç¨‹åºè¯»å–

é‡æ”¾æ”»å‡»ï¼š
æ”»å‡»è€…è·å¾—æœ‰æ•ˆJWTåï¼Œåœ¨è¿‡æœŸå‰åå¤ä½¿ç”¨
```

---

## 4. ğŸ›¡ï¸ JWTå®‰å…¨æœ€ä½³å®è·µ


### 4.1 å¯†é’¥ç®¡ç†æœ€ä½³å®è·µ


**ğŸ” å®‰å…¨å¯†é’¥ç”Ÿæˆä¸å­˜å‚¨**
```javascript
// âœ… æ­£ç¡®çš„å¯†é’¥ç®¡ç†
const crypto = require('crypto');

// 1. ç”Ÿæˆè¶³å¤Ÿå¼ºåº¦çš„å¯†é’¥
const generateSecretKey = () => {
  return crypto.randomBytes(64).toString('hex'); // 512ä½å¯†é’¥
};

// 2. ä»ç¯å¢ƒå˜é‡è¯»å–å¯†é’¥
const JWT_SECRET = process.env.JWT_SECRET;
if (!JWT_SECRET) {
  throw new Error('JWT_SECRET must be set in environment variables');
}

// 3. å¯†é’¥è½®æ¢æœºåˆ¶
const keyRotation = {
  currentKey: process.env.JWT_SECRET_CURRENT,
  previousKey: process.env.JWT_SECRET_PREVIOUS,
  
  // æ”¯æŒæ–°æ—§å¯†é’¥åŒæ—¶éªŒè¯
  verify(token) {
    try {
      return jwt.verify(token, this.currentKey);
    } catch (err) {
      // å¦‚æœæ–°å¯†é’¥éªŒè¯å¤±è´¥ï¼Œå°è¯•æ—§å¯†é’¥
      return jwt.verify(token, this.previousKey);
    }
  }
};
```

### 4.2 ä»¤ç‰Œè¿‡æœŸç­–ç•¥


**â³ åˆç†çš„è¿‡æœŸæ—¶é—´è®¾è®¡**
```javascript
const tokenConfig = {
  // è®¿é—®ä»¤ç‰Œï¼šçŸ­æœŸæœ‰æ•ˆï¼Œæ‰¿è½½æ•æ„Ÿæ“ä½œ
  accessToken: {
    expiresIn: '15m',        // 15åˆ†é’Ÿ
    audience: 'api-access',
    issuer: 'auth-server'
  },
  
  // åˆ·æ–°ä»¤ç‰Œï¼šé•¿æœŸæœ‰æ•ˆï¼Œä»…ç”¨äºè·å–æ–°è®¿é—®ä»¤ç‰Œ
  refreshToken: {
    expiresIn: '7d',         // 7å¤©
    audience: 'token-refresh',
    issuer: 'auth-server'
  }
};

// åŒä»¤ç‰Œæœºåˆ¶å®ç°
function generateTokens(user) {
  const accessToken = jwt.sign(
    {
      userId: user.id,
      username: user.username,
      role: user.role,
      type: 'access'
    },
    JWT_SECRET,
    tokenConfig.accessToken
  );
  
  const refreshToken = jwt.sign(
    {
      userId: user.id,
      type: 'refresh'
    },
    JWT_SECRET,
    tokenConfig.refreshToken
  );
  
  return { accessToken, refreshToken };
}
```

### 4.3 JWTæ’¤é”€æœºåˆ¶


**ğŸš« ä»¤ç‰Œé»‘åå•å®ç°**
```javascript
// Rediså­˜å‚¨é»‘åå•
const redis = require('redis');
const client = redis.createClient();

class JWTBlacklist {
  // æ·»åŠ ä»¤ç‰Œåˆ°é»‘åå•
  static async addToBlacklist(token) {
    try {
      const decoded = jwt.decode(token);
      const tokenId = decoded.jti; // JWT ID
      const expiresIn = decoded.exp - Math.floor(Date.now() / 1000);
      
      if (expiresIn > 0) {
        // åªéœ€è¦å­˜å‚¨åˆ°ä»¤ç‰Œè¿‡æœŸä¸ºæ­¢
        await client.setex(`blacklist:${tokenId}`, expiresIn, 'revoked');
      }
    } catch (error) {
      console.error('Failed to blacklist token:', error);
    }
  }
  
  // æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦åœ¨é»‘åå•ä¸­
  static async isBlacklisted(token) {
    try {
      const decoded = jwt.decode(token);
      const tokenId = decoded.jti;
      const result = await client.get(`blacklist:${tokenId}`);
      return result === 'revoked';
    } catch (error) {
      return false; // è§£æå¤±è´¥è®¤ä¸ºæœªè¢«æ’¤é”€
    }
  }
}

// ä¸­é—´ä»¶éªŒè¯
async function jwtMiddleware(req, res, next) {
  const token = req.headers.authorization?.replace('Bearer ', '');
  
  if (!token) {
    return res.status(401).json({ error: 'No token provided' });
  }
  
  // 1. æ£€æŸ¥é»‘åå•
  if (await JWTBlacklist.isBlacklisted(token)) {
    return res.status(401).json({ error: 'Token has been revoked' });
  }
  
  // 2. éªŒè¯ä»¤ç‰Œ
  try {
    const decoded = jwt.verify(token, JWT_SECRET);
    req.user = decoded;
    next();
  } catch (error) {
    return res.status(401).json({ error: 'Invalid token' });
  }
}
```

### 4.4 å®‰å…¨ä¼ è¾“ä¸å­˜å‚¨


**ğŸŒ HTTPSå¼ºåˆ¶ä¼ è¾“**
```javascript
// Express.js å®‰å…¨é…ç½®
const helmet = require('helmet');

app.use(helmet({
  hsts: {
    maxAge: 31536000,
    includeSubDomains: true,
    preload: true
  }
}));

// å¼ºåˆ¶HTTPSé‡å®šå‘
app.use((req, res, next) => {
  if (!req.secure && req.get('X-Forwarded-Proto') !== 'https') {
    return res.redirect(`https://${req.get('Host')}${req.url}`);
  }
  next();
});
```

**ğŸ“± å®¢æˆ·ç«¯å®‰å…¨å­˜å‚¨**
```javascript
// âœ… æ¨èçš„å­˜å‚¨æ–¹å¼
class TokenStorage {
  // æ–¹å¼1ï¼šHttpOnly Cookieï¼ˆæ¨èï¼‰
  static setTokenCookie(res, token) {
    res.cookie('jwt', token, {
      httpOnly: true,    // é˜²æ­¢XSSæ”»å‡»
      secure: true,      // ä»…HTTPSä¼ è¾“
      sameSite: 'strict', // é˜²æ­¢CSRFæ”»å‡»
      maxAge: 15 * 60 * 1000 // 15åˆ†é’Ÿ
    });
  }
  
  // æ–¹å¼2ï¼šå†…å­˜å­˜å‚¨ï¼ˆSPAåº”ç”¨ï¼‰
  static memoryStorage = {
    token: null,
    setToken(token) { this.token = token; },
    getToken() { return this.token; },
    clearToken() { this.token = null; }
  };
}

// âŒ ä¸æ¨èçš„å­˜å‚¨æ–¹å¼
// localStorage - å®¹æ˜“è¢«XSSæ”»å‡»
// sessionStorage - åŒæ ·æœ‰XSSé£é™©
```

---

## 5. ğŸ® JWTå®æˆ˜åº”ç”¨åœºæ™¯


### 5.1 å•é¡µåº”ç”¨(SPA)è®¤è¯


**ğŸŒ å‰åç«¯åˆ†ç¦»æ¶æ„**
```
åº”ç”¨åœºæ™¯ï¼š
- Vue.js/Reactå‰ç«¯ + Node.jsåç«¯
- ç”¨æˆ·ç™»å½•åè·å–JWT
- å‰ç«¯å­˜å‚¨JWTå¹¶åœ¨è¯·æ±‚ä¸­æºå¸¦
- åç«¯éªŒè¯JWTå¹¶è¿”å›æ•°æ®

å®é™…ä»·å€¼ï¼š
âœ“ å‰åç«¯å®Œå…¨è§£è€¦
âœ“ æ”¯æŒå¤šç«¯å…±äº«ï¼ˆWebã€APPã€å°ç¨‹åºï¼‰
âœ“ ä¾¿äºCDNéƒ¨ç½²å’Œç¼“å­˜
```

**ğŸ“± å®ç°æ–¹æ¡ˆç¤ºä¾‹**
```javascript
// å‰ç«¯ Vue.js å®ç°
export default {
  data() {
    return {
      token: null,
      user: null
    }
  },
  
  methods: {
    async login(credentials) {
      try {
        const response = await axios.post('/api/login', credentials);
        this.token = response.data.token;
        
        // è®¾ç½®é»˜è®¤è¯·æ±‚å¤´
        axios.defaults.headers.common['Authorization'] = `Bearer ${this.token}`;
        
        // è§£æç”¨æˆ·ä¿¡æ¯
        this.user = this.parseToken(this.token);
        
      } catch (error) {
        console.error('Login failed:', error);
      }
    },
    
    parseToken(token) {
      const payload = JSON.parse(atob(token.split('.')[1]));
      return {
        id: payload.userId,
        name: payload.username,
        role: payload.role
      };
    }
  }
}
```

### 5.2 å¾®æœåŠ¡æ¶æ„ä¸­çš„è®¤è¯


**ğŸ—ï¸ å¾®æœåŠ¡è®¤è¯æµç¨‹**
```
ç”¨æˆ·è®¤è¯æµç¨‹ï¼š

å‰ç«¯åº”ç”¨                è®¤è¯æœåŠ¡             ä¸šåŠ¡æœåŠ¡A          ä¸šåŠ¡æœåŠ¡B
   |                      |                    |                  |
   |--[1]ç™»å½•è¯·æ±‚--------->|                    |                  |
   |                      |--[2]éªŒè¯ç”¨æˆ·        |                  |
   |                      |--[3]ç­¾å‘JWT         |                  |
   |<--[4]è¿”å›JWT----------|                    |                  |
   |                      |                    |                  |
   |--[5]ä¸šåŠ¡è¯·æ±‚A+JWT-------------------->|                  |
   |                      |                    |--[6]éªŒè¯JWT      |
   |                      |                    |--[7]å¤„ç†ä¸šåŠ¡      |
   |<--[8]è¿”å›ç»“æœA--------------------------|                  |
   |                      |                    |                  |
   |--[9]ä¸šåŠ¡è¯·æ±‚B+JWT-------------------------------------->|
   |                      |                    |                  |--[10]éªŒè¯JWT
   |                      |                    |                  |--[11]å¤„ç†ä¸šåŠ¡
   |<--[12]è¿”å›ç»“æœB-------------------------------------|

ä¼˜åŠ¿ï¼šæ¯ä¸ªæœåŠ¡éƒ½èƒ½ç‹¬ç«‹éªŒè¯JWTï¼Œæ— éœ€ä¾èµ–è®¤è¯æœåŠ¡
```

### 5.3 ç§»åŠ¨ç«¯APPè®¤è¯


**ğŸ“± åŸç”Ÿåº”ç”¨é›†æˆ**
```java
// Android JWTå¤„ç†ç¤ºä¾‹
public class JWTManager {
    private static final String TOKEN_KEY = "jwt_token";
    private SharedPreferences preferences;
    
    public void saveToken(String token) {
        // ä½¿ç”¨Androidå®‰å…¨å­˜å‚¨
        preferences.edit()
            .putString(TOKEN_KEY, token)
            .apply();
    }
    
    public String getToken() {
        return preferences.getString(TOKEN_KEY, null);
    }
    
    public boolean isTokenValid() {
        String token = getToken();
        if (token == null) return false;
        
        try {
            // è§£æJWTæ£€æŸ¥è¿‡æœŸæ—¶é—´
            String[] parts = token.split("\\.");
            String payload = new String(Base64.decode(parts[1], Base64.DEFAULT));
            JSONObject json = new JSONObject(payload);
            
            long exp = json.getLong("exp");
            long now = System.currentTimeMillis() / 1000;
            
            return exp > now;
        } catch (Exception e) {
            return false;
        }
    }
}
```

---

## 6. ğŸ’» å®Œæ•´ä»£ç å®ç°ç¤ºä¾‹


### 6.1 åç«¯ç™»å½•ç­¾å‘JWT


```javascript
const express = require('express');
const jwt = require('jsonwebtoken');
const bcrypt = require('bcrypt');
const rateLimit = require('express-rate-limit');

const app = express();
app.use(express.json());

// ç™»å½•é™æµ
const loginLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15åˆ†é’Ÿ
  max: 5, // æœ€å¤š5æ¬¡å°è¯•
  message: 'ç™»å½•å°è¯•è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•',
  standardHeaders: true,
  legacyHeaders: false,
});

// ç”¨æˆ·ç™»å½•æ¥å£
app.post('/api/login', loginLimiter, async (req, res) => {
  try {
    const { username, password } = req.body;
    
    // 1. åŸºç¡€éªŒè¯
    if (!username || !password) {
      return res.status(400).json({ 
        error: 'ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º' 
      });
    }
    
    // 2. æŸ¥æ‰¾ç”¨æˆ·ï¼ˆè¿™é‡Œç®€åŒ–å¤„ç†ï¼‰
    const user = await findUserByUsername(username);
    if (!user) {
      return res.status(401).json({ 
        error: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯' 
      });
    }
    
    // 3. éªŒè¯å¯†ç 
    const isValidPassword = await bcrypt.compare(password, user.passwordHash);
    if (!isValidPassword) {
      return res.status(401).json({ 
        error: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯' 
      });
    }
    
    // 4. ç”ŸæˆJWT
    const tokenPayload = {
      userId: user.id,
      username: user.username,
      role: user.role,
      permissions: user.permissions,
      jti: generateUniqueId(), // JWT IDï¼Œç”¨äºæ’¤é”€
    };
    
    const token = jwt.sign(
      tokenPayload,
      process.env.JWT_SECRET,
      {
        expiresIn: '15m',
        issuer: 'your-app-name',
        audience: 'your-app-users'
      }
    );
    
    // 5. è¿”å›ç»“æœ
    res.json({
      success: true,
      token: token,
      user: {
        id: user.id,
        username: user.username,
        role: user.role
      },
      expiresIn: 15 * 60 // 15åˆ†é’Ÿï¼Œç§’ä¸ºå•ä½
    });
    
  } catch (error) {
    console.error('Login error:', error);
    res.status(500).json({ 
      error: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯' 
    });
  }
});

// è¾…åŠ©å‡½æ•°
function generateUniqueId() {
  return require('crypto').randomBytes(16).toString('hex');
}

async function findUserByUsername(username) {
  // è¿™é‡Œåº”è¯¥æ˜¯æ•°æ®åº“æŸ¥è¯¢
  // è¿”å›ç”¨æˆ·å¯¹è±¡æˆ–null
  return {
    id: 1,
    username: 'demo_user',
    passwordHash: '$2b$10$...',
    role: 'user',
    permissions: ['read', 'write']
  };
}
```

### 6.2 JWTéªŒè¯ä¸­é—´ä»¶


```javascript
// JWTéªŒè¯ä¸­é—´ä»¶
const jwtMiddleware = async (req, res, next) => {
  try {
    // 1. æå–token
    const authHeader = req.headers.authorization;
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
      return res.status(401).json({ 
        error: 'ç¼ºå°‘è®¤è¯ä»¤ç‰Œ' 
      });
    }
    
    const token = authHeader.substring(7); // ç§»é™¤ 'Bearer ' å‰ç¼€
    
    // 2. æ£€æŸ¥é»‘åå•ï¼ˆå¦‚æœå®ç°äº†æ’¤é”€æœºåˆ¶ï¼‰
    if (await isTokenBlacklisted(token)) {
      return res.status(401).json({ 
        error: 'ä»¤ç‰Œå·²è¢«æ’¤é”€' 
      });
    }
    
    // 3. éªŒè¯JWT
    const decoded = jwt.verify(token, process.env.JWT_SECRET, {
      issuer: 'your-app-name',
      audience: 'your-app-users'
    });
    
    // 4. æ£€æŸ¥ç”¨æˆ·çŠ¶æ€ï¼ˆå¯é€‰ï¼‰
    const user = await getUserById(decoded.userId);
    if (!user || !user.active) {
      return res.status(401).json({ 
        error: 'ç”¨æˆ·è´¦å·å·²è¢«ç¦ç”¨' 
      });
    }
    
    // 5. å°†ç”¨æˆ·ä¿¡æ¯é™„åŠ åˆ°è¯·æ±‚å¯¹è±¡
    req.user = {
      id: decoded.userId,
      username: decoded.username,
      role: decoded.role,
      permissions: decoded.permissions
    };
    
    next();
    
  } catch (error) {
    if (error.name === 'TokenExpiredError') {
      return res.status(401).json({ 
        error: 'ä»¤ç‰Œå·²è¿‡æœŸ',
        code: 'TOKEN_EXPIRED'
      });
    } else if (error.name === 'JsonWebTokenError') {
      return res.status(401).json({ 
        error: 'æ— æ•ˆçš„ä»¤ç‰Œ' 
      });
    } else {
      console.error('JWTéªŒè¯é”™è¯¯:', error);
      return res.status(500).json({ 
        error: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯' 
      });
    }
  }
};

// å—ä¿æŠ¤çš„è·¯ç”±ç¤ºä¾‹
app.get('/api/profile', jwtMiddleware, (req, res) => {
  res.json({
    message: 'è·å–ç”¨æˆ·ä¿¡æ¯æˆåŠŸ',
    user: req.user
  });
});

// æƒé™æ£€æŸ¥ä¸­é—´ä»¶
const requireRole = (roles) => {
  return (req, res, next) => {
    if (!req.user) {
      return res.status(401).json({ error: 'æœªè®¤è¯' });
    }
    
    if (!roles.includes(req.user.role)) {
      return res.status(403).json({ 
        error: 'æƒé™ä¸è¶³',
        required: roles,
        current: req.user.role
      });
    }
    
    next();
  };
};

// éœ€è¦ç®¡ç†å‘˜æƒé™çš„è·¯ç”±
app.get('/api/admin/users', 
  jwtMiddleware, 
  requireRole(['admin', 'super_admin']), 
  (req, res) => {
    res.json({ message: 'ç®¡ç†å‘˜ä¸“ç”¨æ¥å£' });
  }
);
```

### 6.3 å‰ç«¯æ‹¦æˆªå™¨å®ç°


```javascript
// Axiosè¯·æ±‚æ‹¦æˆªå™¨
import axios from 'axios';

// åˆ›å»ºaxioså®ä¾‹
const api = axios.create({
  baseURL: 'https://your-api.com',
  timeout: 10000
});

// Tokenç®¡ç†å·¥å…·
class TokenManager {
  static getToken() {
    return localStorage.getItem('jwt_token');
  }
  
  static setToken(token) {
    localStorage.setItem('jwt_token', token);
  }
  
  static clearToken() {
    localStorage.removeItem('jwt_token');
  }
  
  // æ£€æŸ¥tokenæ˜¯å¦å³å°†è¿‡æœŸ
  static isTokenExpiringSoon(token, thresholdMinutes = 5) {
    try {
      const payload = JSON.parse(atob(token.split('.')[1]));
      const exp = payload.exp * 1000; // è½¬æ¢ä¸ºæ¯«ç§’
      const threshold = thresholdMinutes * 60 * 1000;
      
      return (exp - Date.now()) < threshold;
    } catch {
      return true; // è§£æå¤±è´¥è®¤ä¸ºå·²è¿‡æœŸ
    }
  }
}

// è¯·æ±‚æ‹¦æˆªå™¨ï¼šè‡ªåŠ¨æ·»åŠ JWT
api.interceptors.request.use(
  (config) => {
    const token = TokenManager.getToken();
    if (token) {
      // æ£€æŸ¥tokenæ˜¯å¦å³å°†è¿‡æœŸ
      if (TokenManager.isTokenExpiringSoon(token)) {
        console.warn('Tokenå³å°†è¿‡æœŸï¼Œå»ºè®®åˆ·æ–°');
        // å¯ä»¥åœ¨è¿™é‡Œè§¦å‘tokenåˆ·æ–°é€»è¾‘
      }
      
      config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
  },
  (error) => {
    return Promise.reject(error);
  }
);

// å“åº”æ‹¦æˆªå™¨ï¼šå¤„ç†è®¤è¯é”™è¯¯
api.interceptors.response.use(
  (response) => {
    return response;
  },
  (error) => {
    if (error.response?.status === 401) {
      const errorCode = error.response.data?.code;
      
      if (errorCode === 'TOKEN_EXPIRED') {
        // Tokenè¿‡æœŸå¤„ç†
        TokenManager.clearToken();
        
        // è·³è½¬åˆ°ç™»å½•é¡µé¢
        window.location.href = '/login?reason=expired';
        
        // æ˜¾ç¤ºå‹å¥½æç¤º
        alert('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
        
      } else {
        // å…¶ä»–è®¤è¯é”™è¯¯
        TokenManager.clearToken();
        window.location.href = '/login?reason=invalid';
      }
    }
    
    return Promise.reject(error);
  }
);

// ä½¿ç”¨ç¤ºä¾‹
export const userAPI = {
  // ç™»å½•
  async login(credentials) {
    const response = await api.post('/api/login', credentials);
    const { token, user } = response.data;
    
    // ä¿å­˜token
    TokenManager.setToken(token);
    
    return { token, user };
  },
  
  // è·å–ç”¨æˆ·ä¿¡æ¯
  async getProfile() {
    const response = await api.get('/api/profile');
    return response.data;
  },
  
  // é€€å‡ºç™»å½•
  async logout() {
    try {
      await api.post('/api/logout');
    } finally {
      // æ— è®ºè¯·æ±‚æˆåŠŸä¸å¦éƒ½æ¸…é™¤æœ¬åœ°token
      TokenManager.clearToken();
      window.location.href = '/login';
    }
  }
};
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ JWTæœ¬è´¨ï¼šè‡ªåŒ…å«çš„æ— çŠ¶æ€è®¤è¯ä»¤ç‰Œ
ğŸ”¸ æ ¸å¿ƒä¼˜åŠ¿ï¼šè·¨åŸŸå‹å¥½ã€æ°´å¹³æ‰©å±•ã€å‡å°‘æœåŠ¡å™¨å­˜å‚¨
ğŸ”¸ ä¸»è¦ç¼ºç‚¹ï¼šæ’¤é”€å›°éš¾ã€ä½“ç§¯è¾ƒå¤§ã€å¯†é’¥ç®¡ç†å¤æ‚  
ğŸ”¸ å®‰å…¨é£é™©ï¼šç®—æ³•æ··æ·†ã€å¯†é’¥æ³„éœ²ã€æ—¶é—´æ”»å‡»ã€ä»¤ç‰ŒåŠ«æŒ
ğŸ”¸ æœ€ä½³å®è·µï¼šå¼ºå¯†é’¥ã€çŸ­è¿‡æœŸã€HTTPSä¼ è¾“ã€å®‰å…¨å­˜å‚¨
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ JWT vs Sessionçš„é€‰æ‹©åŸåˆ™**
```
é€‰æ‹©JWTçš„åœºæ™¯ï¼š
âœ“ å¾®æœåŠ¡æ¶æ„ï¼Œéœ€è¦æœåŠ¡é—´è®¤è¯
âœ“ å‰åç«¯åˆ†ç¦»ï¼Œéœ€è¦è·¨åŸŸè®¤è¯  
âœ“ ç§»åŠ¨ç«¯åº”ç”¨ï¼Œéœ€è¦ç¦»çº¿éªŒè¯
âœ“ é«˜å¹¶å‘åœºæ™¯ï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢

é€‰æ‹©Sessionçš„åœºæ™¯ï¼š
âœ“ ä¼ ç»Ÿå•ä½“åº”ç”¨
âœ“ éœ€è¦é¢‘ç¹æ’¤é”€æƒé™
âœ“ å¯¹å®‰å…¨æ€§è¦æ±‚æé«˜
âœ“ ç”¨æˆ·ä¼šè¯ç®¡ç†å¤æ‚
```

**ğŸ”¹ å®‰å…¨å®è·µè®°å¿†å£è¯€**
```
å¯†é’¥ç®¡ç†è¦ä¸¥æ ¼ï¼Œç¯å¢ƒå˜é‡æ¥å­˜å‚¨
ç®—æ³•å›ºå®šä¸å¯å˜ï¼Œå¼ºåˆ¶æ ¡éªŒé˜²æ··æ·†
è¿‡æœŸæ—¶é—´è¦åˆç†ï¼ŒåŒä»¤ç‰Œæ¥ç»­æœŸ
HTTPSå¿…é¡»è¦ä½¿ç”¨ï¼Œå®‰å…¨ä¼ è¾“æœ€é‡è¦
é»‘åå•æœºåˆ¶è¦å»ºç«‹ï¼Œæ’¤é”€åŠŸèƒ½ä¸å¯å°‘
```

### 7.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ JWTåœ¨é¡¹ç›®ä¸­çš„å…¸å‹ä½¿ç”¨**
- **å°å‹é¡¹ç›®**ï¼šç®€å•çš„ç”¨æˆ·è®¤è¯ï¼Œ15-30åˆ†é’Ÿè¿‡æœŸ
- **ä¼ä¸šçº§åº”ç”¨**ï¼šåŒä»¤ç‰Œæœºåˆ¶ï¼Œè®¿é—®ä»¤ç‰ŒçŸ­æœŸï¼Œåˆ·æ–°ä»¤ç‰Œé•¿æœŸ
- **å¾®æœåŠ¡æ¶æ„**ï¼šç»Ÿä¸€è®¤è¯ä¸­å¿ƒç­¾å‘ï¼Œå„æœåŠ¡ç‹¬ç«‹éªŒè¯
- **ç§»åŠ¨åº”ç”¨**ï¼šæœ¬åœ°å®‰å…¨å­˜å‚¨ï¼Œç½‘ç»œè¯·æ±‚è‡ªåŠ¨æºå¸¦

**ğŸ”§ å®æ–½å»ºè®®**
- **å¼€å‘é˜¶æ®µ**ï¼šä½¿ç”¨è¾ƒé•¿è¿‡æœŸæ—¶é—´ä¾¿äºè°ƒè¯•
- **æµ‹è¯•é˜¶æ®µ**ï¼šæ¨¡æ‹Ÿå„ç§æ”»å‡»åœºæ™¯ï¼ŒéªŒè¯å®‰å…¨æªæ–½
- **ç”Ÿäº§ç¯å¢ƒ**ï¼šä¸¥æ ¼çš„å¯†é’¥ç®¡ç†ï¼Œå®Œå–„çš„ç›‘æ§å‘Šè­¦
- **è¿ç»´ç›‘æ§**ï¼šå¼‚å¸¸ç™»å½•æ£€æµ‹ï¼Œä»¤ç‰Œä½¿ç”¨åˆ†æ

**æ ¸å¿ƒè®°å¿†**ï¼š
- JWTåƒèº«ä»½è¯ï¼Œä¿¡æ¯éƒ½åœ¨è¯ä¸Šï¼Œå“ªé‡Œéƒ½èƒ½éªŒè¯
- å®‰å…¨ç¬¬ä¸€è¦ç‰¢è®°ï¼Œå¯†é’¥ç®¡ç†æ˜¯å…³é”®
- è¿‡æœŸæ’¤é”€è¦å¤„ç†ï¼ŒåŒä»¤ç‰Œæœºåˆ¶è§£éš¾é¢˜
- HTTPSä¼ è¾“æ˜¯å¿…é¡»ï¼Œæœ¬åœ°å­˜å‚¨è¦å®‰å…¨