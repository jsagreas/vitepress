---
title: 11ã€MFAç³»ç»Ÿæ¶æ„è®¾è®¡
---
## ğŸ“š ç›®å½•

1. [MFAç³»ç»ŸåŸºç¡€æ¦‚å¿µ](#1-mfaç³»ç»ŸåŸºç¡€æ¦‚å¿µ)
2. [è®¤è¯æœåŠ¡æ¶æ„å›¾è®¾è®¡](#2-è®¤è¯æœåŠ¡æ¶æ„å›¾è®¾è®¡)
3. [æ•´ä½“æ¶æ„å›¾è®¾è®¡](#3-æ•´ä½“æ¶æ„å›¾è®¾è®¡)
4. [å¾®æœåŠ¡æ‹†åˆ†ç­–ç•¥](#4-å¾®æœåŠ¡æ‹†åˆ†ç­–ç•¥)
5. [æ•°æ®åº“è¡¨ç»“æ„è®¾è®¡](#5-æ•°æ®åº“è¡¨ç»“æ„è®¾è®¡)
6. [è®¤è¯æœåŠ¡ç‹¬ç«‹éƒ¨ç½²](#6-è®¤è¯æœåŠ¡ç‹¬ç«‹éƒ¨ç½²)
7. [ç”¨æˆ·è®¤è¯çŠ¶æ€ç®¡ç†](#7-ç”¨æˆ·è®¤è¯çŠ¶æ€ç®¡ç†)
8. [è®¤è¯æµç¨‹çŠ¶æ€æœº](#8-è®¤è¯æµç¨‹çŠ¶æ€æœº)
9. [ä¼šè¯ç®¡ç†å’Œä»¤ç‰Œè®¾è®¡](#9-ä¼šè¯ç®¡ç†å’Œä»¤ç‰Œè®¾è®¡)
10. [é«˜å¯ç”¨å’Œè´Ÿè½½å‡è¡¡](#10-é«˜å¯ç”¨å’Œè´Ÿè½½å‡è¡¡)
11. [APIæ¥å£è§„èŒƒ](#11-apiæ¥å£è§„èŒƒ)
12. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#12-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” MFAç³»ç»ŸåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯MFA

**MFAï¼ˆMulti-Factor Authenticationï¼‰**å°±æ˜¯**å¤šå› å­è®¤è¯**ï¼Œè¯´ç™½äº†å°±æ˜¯ç”¨å¤šç§æ–¹å¼æ¥éªŒè¯ä½ çš„èº«ä»½ã€‚

```
ç®€å•ç±»æ¯”ï¼š
å•å› å­è®¤è¯ = åªç”¨é’¥åŒ™å¼€é—¨
å¤šå› å­è®¤è¯ = ç”¨é’¥åŒ™ + æŒ‡çº¹ + å¯†ç å¼€é—¨

ä¸ºä»€ä¹ˆè¦å¤šé‡éªŒè¯ï¼Ÿ
- ä¸€æŠŠé’¥åŒ™ä¸¢äº†ï¼Œå°å·å°±èƒ½è¿›é—¨
- å¤šé‡éªŒè¯ï¼Œå°±ç®—ä¸¢äº†ä¸€æ ·ï¼Œè¿˜æœ‰å…¶ä»–ä¿æŠ¤
```

**ğŸ”¸ ä¸‰ç§è®¤è¯å› å­**
```
ä½ çŸ¥é“çš„ï¼ˆSomething You Knowï¼‰ï¼š
- å¯†ç ã€PINç ã€å®‰å…¨é—®é¢˜ç­”æ¡ˆ
- å°±åƒä½ è®°åœ¨è„‘å­é‡Œçš„ç§˜å¯†

ä½ æ‹¥æœ‰çš„ï¼ˆSomething You Haveï¼‰ï¼š
- æ‰‹æœºçŸ­ä¿¡ã€ç¡¬ä»¶ä»¤ç‰Œã€é“¶è¡Œå¡
- å°±åƒä½ æ‰‹é‡Œæ‹¿ç€çš„ç‰©å“

ä½ æ˜¯è°ï¼ˆSomething You Areï¼‰ï¼š
- æŒ‡çº¹ã€äººè„¸ã€è™¹è†œã€å£°éŸ³
- å°±åƒä½ èº«ä½“ç‹¬æœ‰çš„ç‰¹å¾
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦MFAç³»ç»Ÿ

**ğŸ¯ è§£å†³çš„æ ¸å¿ƒé—®é¢˜**
```
ä¼ ç»Ÿå•ä¸€å¯†ç çš„é—®é¢˜ï¼š
âŒ å¯†ç æ³„éœ²ï¼šé»‘å®¢æ‹–åº“ï¼Œå¯†ç è¢«ç›—
âŒ å¯†ç å¤ç”¨ï¼šä¸€ä¸ªç½‘ç«™æ³„éœ²ï¼Œå…¶ä»–ç½‘ç«™ä¹Ÿå±é™©
âŒ å¼±å¯†ç ï¼šç”¨æˆ·å›¾æ–¹ä¾¿ï¼Œè®¾ç½®ç®€å•å¯†ç 
âŒ ç¤¾ä¼šå·¥ç¨‹ï¼šé€šè¿‡æ¬ºéª—è·å–å¯†ç 

MFAçš„é˜²æŠ¤æ•ˆæœï¼š
âœ… å¤šå±‚é˜²æŠ¤ï¼šå°±ç®—å¯†ç è¢«ç›—ï¼Œè¿˜æœ‰å…¶ä»–éªŒè¯
âœ… åŠ¨æ€éªŒè¯ï¼šçŸ­ä¿¡éªŒè¯ç æ¯æ¬¡éƒ½ä¸åŒ
âœ… è®¾å¤‡ç»‘å®šï¼šåªæœ‰ç‰¹å®šè®¾å¤‡æ‰èƒ½é€šè¿‡éªŒè¯
âœ… å¼‚å¸¸æ£€æµ‹ï¼šå‘ç°å¯ç–‘ç™»å½•ç«‹å³é˜»æ­¢
```

---

## 2. ğŸ—ï¸ è®¤è¯æœåŠ¡æ¶æ„å›¾è®¾è®¡


### 2.1 æ ¸å¿ƒæœåŠ¡ç»„ä»¶æ¶æ„


```
è®¤è¯æœåŠ¡æ ¸å¿ƒæ¶æ„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å‰ç«¯åº”ç”¨å±‚                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Webå‰ç«¯    â”‚  ç§»åŠ¨App    â”‚  ç¬¬ä¸‰æ–¹åº”ç”¨    â”‚  ç®¡ç†åå°  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚             â”‚             â”‚
              â–¼             â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   APIç½‘å…³å±‚                         â”‚
â”‚  â€¢ è¯·æ±‚è·¯ç”±      â€¢ é™æµæ§åˆ¶     â€¢ æƒé™æ ¡éªŒ           â”‚
â”‚  â€¢ è´Ÿè½½å‡è¡¡      â€¢ æ—¥å¿—è®°å½•     â€¢ åè®®è½¬æ¢           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 è®¤è¯æœåŠ¡å±‚                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ç”¨æˆ·è®¤è¯æœåŠ¡   â”‚   ä»¤ç‰Œç®¡ç†æœåŠ¡   â”‚   MFAéªŒè¯æœåŠ¡    â”‚
â”‚                â”‚                â”‚                â”‚
â”‚ â€¢ ç”¨æˆ·ç™»å½•      â”‚ â€¢ JWTç”Ÿæˆ       â”‚ â€¢ çŸ­ä¿¡éªŒè¯      â”‚
â”‚ â€¢ å¯†ç éªŒè¯      â”‚ â€¢ Tokenåˆ·æ–°     â”‚ â€¢ é‚®ä»¶éªŒè¯      â”‚
â”‚ â€¢ ä¼šè¯ç®¡ç†      â”‚ â€¢ Tokenæ’¤é”€     â”‚ â€¢ APPéªŒè¯       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚                â”‚
                  â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 æ•°æ®å­˜å‚¨å±‚                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ç”¨æˆ·æ•°æ®åº“     â”‚   Redisç¼“å­˜      â”‚   æ—¥å¿—å­˜å‚¨       â”‚
â”‚                â”‚                â”‚                â”‚
â”‚ â€¢ ç”¨æˆ·ä¿¡æ¯      â”‚ â€¢ ä¼šè¯æ•°æ®      â”‚ â€¢ æ“ä½œæ—¥å¿—      â”‚
â”‚ â€¢ è®¤è¯å†å²      â”‚ â€¢ éªŒè¯ç         â”‚ â€¢ å®‰å…¨æ—¥å¿—      â”‚
â”‚ â€¢ è®¾å¤‡ä¿¡æ¯      â”‚ â€¢ ä¸´æ—¶ä»¤ç‰Œ      â”‚ â€¢ å®¡è®¡æ—¥å¿—      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æœåŠ¡é—´é€šä¿¡è®¾è®¡


**ğŸ”¸ åŒæ­¥é€šä¿¡**
```java
// ç”¨æˆ·è®¤è¯æ—¶è°ƒç”¨MFAéªŒè¯
@RestController
public class AuthController {
    
    @Autowired
    private MfaService mfaService;
    
    public AuthResult authenticate(String username, String password) {
        // 1. å¯†ç éªŒè¯é€šè¿‡å
        if (passwordValid) {
            // 2. æ£€æŸ¥æ˜¯å¦éœ€è¦MFA
            if (mfaService.isRequired(username)) {
                return AuthResult.needMfa();
            }
            return AuthResult.success();
        }
        return AuthResult.failed();
    }
}
```

**ğŸ”¸ å¼‚æ­¥é€šä¿¡**
```java
// å‘é€éªŒè¯ç å¼‚æ­¥å¤„ç†
@EventListener
public class MfaEventHandler {
    
    @Async
    public void handleSendSms(MfaEvent event) {
        // å¼‚æ­¥å‘é€çŸ­ä¿¡éªŒè¯ç 
        smsService.sendCode(event.getPhone(), event.getCode());
        
        // è®°å½•å‘é€æ—¥å¿—
        logService.recordMfaSend(event);
    }
}
```

---

## 3. ğŸŒ æ•´ä½“æ¶æ„å›¾è®¾è®¡


### 3.1 å®Œæ•´ç³»ç»Ÿæ¶æ„


```
MFAç³»ç»Ÿæ•´ä½“æ¶æ„ï¼š

            ã€ç”¨æˆ·ç«¯ã€‘
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Webå‰ç«¯ â”‚ ç§»åŠ¨App  â”‚ æ¡Œé¢åº”ç”¨ â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚        CDN/è´Ÿè½½å‡è¡¡          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚        APIç½‘å…³              â”‚
    â”‚  â€¢ ç»Ÿä¸€å…¥å£                  â”‚
    â”‚  â€¢ é™æµç†”æ–­                  â”‚
    â”‚  â€¢ å®‰å…¨è¿‡æ»¤                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         â–¼                     â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  â”‚ ç”¨æˆ·æœåŠ¡    â”‚    â”‚   è®¤è¯æœåŠ¡          â”‚
    â”‚  â”‚            â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  â”‚â€¢ ç”¨æˆ·ç®¡ç†   â”‚â—„â”€â”€â–ºâ”‚  â”‚ åŸºç¡€è®¤è¯æ¨¡å—     â”‚
    â”‚  â”‚â€¢ æƒé™ç®¡ç†   â”‚    â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚  â”‚â€¢ è§’è‰²ç®¡ç†   â”‚    â”‚  â”‚ MFAéªŒè¯æ¨¡å—      â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                     â”‚  â”‚ ä»¤ç‰Œç®¡ç†æ¨¡å—     â”‚
    â”‚                     â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                     â”‚  â”‚ ä¼šè¯ç®¡ç†æ¨¡å—     â”‚
    â”‚                     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                     â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  â”‚ é€šçŸ¥æœåŠ¡    â”‚â—„â”€â”€â–ºâ”‚  â”‚ å®‰å…¨ç›‘æ§æœåŠ¡     â”‚
    â”‚  â”‚            â”‚    â”‚  â”‚                â”‚
    â”‚  â”‚â€¢ çŸ­ä¿¡å‘é€   â”‚    â”‚  â”‚â€¢ å¼‚å¸¸æ£€æµ‹        â”‚
    â”‚  â”‚â€¢ é‚®ä»¶å‘é€   â”‚    â”‚  â”‚â€¢ é£é™©è¯„ä¼°        â”‚
    â”‚  â”‚â€¢ æ¨é€é€šçŸ¥   â”‚    â”‚  â”‚â€¢ å®¡è®¡æ—¥å¿—        â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚       æ•°æ®å­˜å‚¨å±‚             â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ MySQL   â”‚ Redis   â”‚ MongoDB â”‚
    â”‚ä¸»æ•°æ®åº“  â”‚ ç¼“å­˜    â”‚ æ—¥å¿—åº“   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 éƒ¨ç½²æ¶æ„è®¾è®¡


```
ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ¶æ„ï¼š

                ã€äº’è”ç½‘ã€‘
                     â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   é˜²ç«å¢™     â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  è´Ÿè½½å‡è¡¡    â”‚
              â”‚ (Nginx/LVS) â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚             â”‚             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ WebæœåŠ¡1 â”‚ â”‚ WebæœåŠ¡2 â”‚ â”‚ WebæœåŠ¡3 â”‚
    â”‚         â”‚ â”‚         â”‚ â”‚         â”‚
    â”‚APIç½‘å…³  â”‚ â”‚APIç½‘å…³  â”‚ â”‚APIç½‘å…³  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚           â”‚           â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”´â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚   â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚    è®¤è¯æœåŠ¡é›†ç¾¤      â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚è®¤è¯èŠ‚ç‚¹1 â”‚ è®¤è¯èŠ‚ç‚¹2  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚      æ•°æ®å±‚         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚MySQLä¸»åº“â”‚ MySQLä»åº“  â”‚
         â”‚         â”‚           â”‚
         â”‚Redisé›†ç¾¤â”‚ MongoDB   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. ğŸ”§ å¾®æœåŠ¡æ‹†åˆ†ç­–ç•¥


### 4.1 æœåŠ¡æ‹†åˆ†åŸåˆ™


**ğŸ¯ æŒ‰ä¸šåŠ¡èƒ½åŠ›æ‹†åˆ†**
```
ç”¨æˆ·æœåŠ¡ï¼ˆUser Serviceï¼‰ï¼š
- ç”¨æˆ·åŸºç¡€ä¿¡æ¯ç®¡ç†
- ç”¨æˆ·æ³¨å†Œã€èµ„æ–™ä¿®æ”¹
- ç”¨æˆ·çŠ¶æ€ç®¡ç†

è®¤è¯æœåŠ¡ï¼ˆAuth Serviceï¼‰ï¼š  
- ç”¨æˆ·ç™»å½•éªŒè¯
- å¯†ç æ ¡éªŒ
- åŸºç¡€è®¤è¯é€»è¾‘

MFAæœåŠ¡ï¼ˆMFA Serviceï¼‰ï¼š
- å¤šå› å­éªŒè¯é€»è¾‘
- éªŒè¯ç å‘é€å’Œæ ¡éªŒ
- è®¾å¤‡ç®¡ç†

ä»¤ç‰ŒæœåŠ¡ï¼ˆToken Serviceï¼‰ï¼š
- JWTä»¤ç‰Œç”Ÿæˆå’ŒéªŒè¯
- ä»¤ç‰Œåˆ·æ–°å’Œæ’¤é”€
- ä¼šè¯ç®¡ç†

é€šçŸ¥æœåŠ¡ï¼ˆNotification Serviceï¼‰ï¼š
- çŸ­ä¿¡å‘é€
- é‚®ä»¶å‘é€  
- æ¨é€é€šçŸ¥
```

### 4.2 æœåŠ¡è¾¹ç•Œå®šä¹‰


**ğŸ”¸ æœåŠ¡èŒè´£çŸ©é˜µ**

| æœåŠ¡åç§° | **æ ¸å¿ƒèŒè´£** | **æ•°æ®æ‰€æœ‰æƒ** | **å¯¹å¤–æ¥å£** |
|---------|-------------|---------------|-------------|
| **ç”¨æˆ·æœåŠ¡** | `ç”¨æˆ·ä¿¡æ¯ç®¡ç†` | `ç”¨æˆ·åŸºç¡€è¡¨` | `ç”¨æˆ·CRUDæ¥å£` |
| **è®¤è¯æœåŠ¡** | `èº«ä»½éªŒè¯` | `è®¤è¯å†å²è¡¨` | `ç™»å½•éªŒè¯æ¥å£` |
| **MFAæœåŠ¡** | `å¤šå› å­éªŒè¯` | `MFAé…ç½®è¡¨` | `éªŒè¯ç æ¥å£` |
| **ä»¤ç‰ŒæœåŠ¡** | `ä»¤ç‰Œç®¡ç†` | `ä¼šè¯è¡¨` | `ä»¤ç‰Œæ“ä½œæ¥å£` |
| **é€šçŸ¥æœåŠ¡** | `æ¶ˆæ¯å‘é€` | `å‘é€è®°å½•è¡¨` | `å‘é€æ¥å£` |

### 4.3 æœåŠ¡ä¾èµ–å…³ç³»


```
æœåŠ¡ä¾èµ–å›¾ï¼š

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  å‰ç«¯åº”ç”¨    â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  è®¤è¯æœåŠ¡    â”‚â—„â”€â”€â”
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
          â”‚           â”‚
          â–¼           â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚  ç”¨æˆ·æœåŠ¡    â”‚â”€â”€â”€â”˜
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  MFAæœåŠ¡    â”‚â”€â”€â”€â”€â–ºâ”‚  é€šçŸ¥æœåŠ¡    â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  ä»¤ç‰ŒæœåŠ¡    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¾èµ–å…³ç³»è¯´æ˜ï¼š
â€¢ è®¤è¯æœåŠ¡è°ƒç”¨ç”¨æˆ·æœåŠ¡éªŒè¯ç”¨æˆ·ä¿¡æ¯
â€¢ MFAæœåŠ¡è°ƒç”¨é€šçŸ¥æœåŠ¡å‘é€éªŒè¯ç 
â€¢ è®¤è¯æœåŠ¡è°ƒç”¨MFAæœåŠ¡è¿›è¡Œå¤šå› å­éªŒè¯
â€¢ è®¤è¯æˆåŠŸåè°ƒç”¨ä»¤ç‰ŒæœåŠ¡ç”Ÿæˆä»¤ç‰Œ
```

### 4.4 å¾®æœåŠ¡å®ç°ç¤ºä¾‹


```java
// è®¤è¯æœåŠ¡æ¥å£
@RestController
@RequestMapping("/auth")
public class AuthController {
    
    @Autowired
    private UserServiceClient userService;
    
    @Autowired  
    private MfaServiceClient mfaService;
    
    @Autowired
    private TokenServiceClient tokenService;
    
    @PostMapping("/login")
    public ResponseEntity<AuthResult> login(@RequestBody LoginRequest request) {
        // 1. éªŒè¯ç”¨æˆ·å¯†ç 
        User user = userService.validateUser(request.getUsername(), request.getPassword());
        if (user == null) {
            return ResponseEntity.ok(AuthResult.failed("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"));
        }
        
        // 2. æ£€æŸ¥æ˜¯å¦éœ€è¦MFA
        if (mfaService.isRequired(user.getId())) {
            // å‘é€éªŒè¯ç 
            mfaService.sendCode(user.getId(), user.getPhone());
            return ResponseEntity.ok(AuthResult.needMfa());
        }
        
        // 3. ç”Ÿæˆä»¤ç‰Œ
        String token = tokenService.generateToken(user.getId());
        return ResponseEntity.ok(AuthResult.success(token));
    }
}
```

---

## 5. ğŸ’¾ æ•°æ®åº“è¡¨ç»“æ„è®¾è®¡


### 5.1 ç”¨æˆ·ç›¸å…³è¡¨ç»“æ„


**ğŸ”¸ ç”¨æˆ·åŸºç¡€ä¿¡æ¯è¡¨**
```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ç”¨æˆ·ID',
    username VARCHAR(50) NOT NULL UNIQUE COMMENT 'ç”¨æˆ·å',
    email VARCHAR(100) UNIQUE COMMENT 'é‚®ç®±',
    phone VARCHAR(20) UNIQUE COMMENT 'æ‰‹æœºå·',
    password_hash VARCHAR(255) NOT NULL COMMENT 'å¯†ç å“ˆå¸Œ',
    salt VARCHAR(32) NOT NULL COMMENT 'å¯†ç ç›å€¼',
    status ENUM('ACTIVE', 'DISABLED', 'LOCKED') DEFAULT 'ACTIVE' COMMENT 'ç”¨æˆ·çŠ¶æ€',
    mfa_enabled BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦å¯ç”¨MFA',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    
    INDEX idx_username (username),
    INDEX idx_email (email),
    INDEX idx_phone (phone)
) COMMENT 'ç”¨æˆ·åŸºç¡€ä¿¡æ¯è¡¨';
```

**ğŸ”¸ ç”¨æˆ·è®¾å¤‡è¡¨**
```sql
-- ç”¨æˆ·è®¾å¤‡è¡¨
CREATE TABLE user_devices (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'è®¾å¤‡ID',
    user_id BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
    device_id VARCHAR(64) NOT NULL COMMENT 'è®¾å¤‡å”¯ä¸€æ ‡è¯†',
    device_name VARCHAR(100) COMMENT 'è®¾å¤‡åç§°',
    device_type ENUM('WEB', 'MOBILE', 'DESKTOP') COMMENT 'è®¾å¤‡ç±»å‹',
    device_info JSON COMMENT 'è®¾å¤‡è¯¦ç»†ä¿¡æ¯',
    is_trusted BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦ä¿¡ä»»è®¾å¤‡',
    last_used_at TIMESTAMP COMMENT 'æœ€åä½¿ç”¨æ—¶é—´',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    
    UNIQUE KEY uk_user_device (user_id, device_id),
    INDEX idx_user_id (user_id),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) COMMENT 'ç”¨æˆ·è®¾å¤‡ä¿¡æ¯è¡¨';
```

### 5.2 è®¤è¯ç›¸å…³è¡¨ç»“æ„


**ğŸ”¸ è®¤è¯å†å²è¡¨**
```sql
-- è®¤è¯å†å²è¡¨  
CREATE TABLE auth_history (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'è®°å½•ID',
    user_id BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
    auth_method ENUM('PASSWORD', 'SMS', 'EMAIL', 'TOTP', 'FINGERPRINT') COMMENT 'è®¤è¯æ–¹å¼',
    auth_result ENUM('SUCCESS', 'FAILED', 'BLOCKED') COMMENT 'è®¤è¯ç»“æœ',
    ip_address VARCHAR(45) COMMENT 'IPåœ°å€',
    user_agent TEXT COMMENT 'ç”¨æˆ·ä»£ç†',
    device_id VARCHAR(64) COMMENT 'è®¾å¤‡ID',
    failure_reason VARCHAR(255) COMMENT 'å¤±è´¥åŸå› ',
    auth_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'è®¤è¯æ—¶é—´',
    
    INDEX idx_user_id (user_id),
    INDEX idx_auth_time (auth_time),
    INDEX idx_ip_address (ip_address),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) COMMENT 'è®¤è¯å†å²è®°å½•è¡¨';
```

### 5.3 MFAç›¸å…³è¡¨ç»“æ„


**ğŸ”¸ MFAé…ç½®è¡¨**
```sql
-- MFAé…ç½®è¡¨
CREATE TABLE mfa_configs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'é…ç½®ID',
    user_id BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
    mfa_type ENUM('SMS', 'EMAIL', 'TOTP', 'BACKUP_CODES') NOT NULL COMMENT 'MFAç±»å‹',
    config_data JSON COMMENT 'é…ç½®æ•°æ®',
    is_primary BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦ä¸»è¦æ–¹å¼',
    is_enabled BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦å¯ç”¨',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    
    UNIQUE KEY uk_user_type (user_id, mfa_type),
    INDEX idx_user_id (user_id),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) COMMENT 'MFAé…ç½®è¡¨';
```

**ğŸ”¸ éªŒè¯ç è¡¨**  
```sql
-- éªŒè¯ç è¡¨
CREATE TABLE verification_codes (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'éªŒè¯ç ID',
    user_id BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
    code_type ENUM('SMS', 'EMAIL', 'LOGIN', 'RESET_PASSWORD') NOT NULL COMMENT 'éªŒè¯ç ç±»å‹',
    code VARCHAR(10) NOT NULL COMMENT 'éªŒè¯ç ',
    target VARCHAR(100) NOT NULL COMMENT 'å‘é€ç›®æ ‡(æ‰‹æœºå·/é‚®ç®±)',
    attempts INT DEFAULT 0 COMMENT 'å°è¯•æ¬¡æ•°',
    max_attempts INT DEFAULT 5 COMMENT 'æœ€å¤§å°è¯•æ¬¡æ•°',
    expires_at TIMESTAMP NOT NULL COMMENT 'è¿‡æœŸæ—¶é—´',
    used_at TIMESTAMP NULL COMMENT 'ä½¿ç”¨æ—¶é—´',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    
    INDEX idx_user_id (user_id),
    INDEX idx_code (code),
    INDEX idx_expires_at (expires_at),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) COMMENT 'éªŒè¯ç è¡¨';
```

### 5.4 ä¼šè¯å’Œä»¤ç‰Œè¡¨ç»“æ„


**ğŸ”¸ ç”¨æˆ·ä¼šè¯è¡¨**
```sql
-- ç”¨æˆ·ä¼šè¯è¡¨
CREATE TABLE user_sessions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ä¼šè¯ID',
    session_id VARCHAR(64) NOT NULL UNIQUE COMMENT 'ä¼šè¯æ ‡è¯†',
    user_id BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
    device_id VARCHAR(64) COMMENT 'è®¾å¤‡ID',
    ip_address VARCHAR(45) COMMENT 'IPåœ°å€',
    user_agent TEXT COMMENT 'ç”¨æˆ·ä»£ç†',
    auth_level ENUM('BASIC', 'MFA_VERIFIED') DEFAULT 'BASIC' COMMENT 'è®¤è¯çº§åˆ«',
    last_activity TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'æœ€åæ´»è·ƒæ—¶é—´',
    expires_at TIMESTAMP NOT NULL COMMENT 'è¿‡æœŸæ—¶é—´',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    
    INDEX idx_session_id (session_id),
    INDEX idx_user_id (user_id),
    INDEX idx_expires_at (expires_at),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) COMMENT 'ç”¨æˆ·ä¼šè¯è¡¨';
```

---

## 6. ğŸš€ è®¤è¯æœåŠ¡ç‹¬ç«‹éƒ¨ç½²


### 6.1 æœåŠ¡ç‹¬ç«‹æ€§è®¾è®¡


**ğŸ”¸ ä¸ºä»€ä¹ˆè¦ç‹¬ç«‹éƒ¨ç½²è®¤è¯æœåŠ¡ï¼Ÿ**
```
ç‹¬ç«‹éƒ¨ç½²çš„å¥½å¤„ï¼š
âœ… å®‰å…¨éš”ç¦»ï¼šè®¤è¯é€»è¾‘ä¸ä¸šåŠ¡é€»è¾‘åˆ†ç¦»
âœ… ä¸“ä¸šåŒ–ï¼šä¸“é—¨å›¢é˜Ÿè´Ÿè´£å®‰å…¨ç›¸å…³åŠŸèƒ½
âœ… å¯æ‰©å±•ï¼šæ ¹æ®è®¤è¯è´Ÿè½½ç‹¬ç«‹æ‰©å®¹
âœ… å¤ç”¨æ€§ï¼šå¤šä¸ªåº”ç”¨å¯ä»¥å…±äº«è®¤è¯æœåŠ¡
âœ… å‡çº§ç‹¬ç«‹ï¼šè®¤è¯æœåŠ¡å‡çº§ä¸å½±å“ä¸šåŠ¡ç³»ç»Ÿ

ä¸¾ä¾‹è¯´æ˜ï¼š
å°±åƒé“¶è¡Œçš„ä¿é™©åº“å’Œè¥ä¸šå¤§å…æ˜¯åˆ†å¼€çš„
- ä¿é™©åº“ï¼šä¸“é—¨ä¿ç®¡è´µé‡ç‰©å“(è®¤è¯æœåŠ¡)
- è¥ä¸šå¤§å…ï¼šå¤„ç†æ—¥å¸¸ä¸šåŠ¡(ä¸šåŠ¡æœåŠ¡)
```

### 6.2 æœåŠ¡éƒ¨ç½²æ¶æ„


```
è®¤è¯æœåŠ¡ç‹¬ç«‹éƒ¨ç½²æ¶æ„ï¼š

                 ã€ä¸šåŠ¡ç³»ç»Ÿç¾¤ã€‘
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ç”µå•†ç³»ç»Ÿ â”‚ CRMç³»ç»Ÿ â”‚ OAç³»ç»Ÿ  â”‚ å…¶ä»–ç³»ç»Ÿ â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”´â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”´â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”´â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
          â”‚         â”‚         â”‚         â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚         â”‚
                    â–¼         â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚     APIç½‘å…³         â”‚
              â”‚ â€¢ è·¯ç”±è½¬å‘          â”‚
              â”‚ â€¢ ä»¤ç‰ŒéªŒè¯          â”‚
              â”‚ â€¢ æƒé™æ£€æŸ¥          â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   è®¤è¯æœåŠ¡é›†ç¾¤       â”‚
              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
              â”‚è®¤è¯èŠ‚ç‚¹1 â”‚ è®¤è¯èŠ‚ç‚¹2  â”‚
              â”‚         â”‚           â”‚
              â”‚â€¢ ç”¨æˆ·è®¤è¯â”‚ â€¢ ç”¨æˆ·è®¤è¯ â”‚
              â”‚â€¢ MFAéªŒè¯â”‚ â€¢ MFAéªŒè¯ â”‚
              â”‚â€¢ ä»¤ç‰Œç®¡ç†â”‚ â€¢ ä»¤ç‰Œç®¡ç† â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   è®¤è¯æ•°æ®åº“         â”‚
              â”‚ â€¢ ç”¨æˆ·ä¿¡æ¯          â”‚
              â”‚ â€¢ è®¤è¯é…ç½®          â”‚
              â”‚ â€¢ ä¼šè¯æ•°æ®          â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.3 Dockerå®¹å™¨åŒ–éƒ¨ç½²


```yaml
# docker-compose.yml
version: '3.8'

services:
  # è®¤è¯æœåŠ¡
  auth-service:
    image: auth-service:latest
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - DATABASE_URL=jdbc:mysql://auth-db:3306/auth_db
      - REDIS_URL=redis://auth-redis:6379
    depends_on:
      - auth-db
      - auth-redis
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # è®¤è¯æ•°æ®åº“
  auth-db:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=rootpass
      - MYSQL_DATABASE=auth_db
      - MYSQL_USER=auth_user
      - MYSQL_PASSWORD=auth_pass
    volumes:
      - auth-db-data:/var/lib/mysql
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql

  # Redisç¼“å­˜
  auth-redis:
    image: redis:alpine
    command: redis-server --requirepass redis_pass
    volumes:
      - auth-redis-data:/data

volumes:
  auth-db-data:
  auth-redis-data:
```

### 6.4 æœåŠ¡é…ç½®ç®¡ç†


```java
// è®¤è¯æœåŠ¡é…ç½®
@Configuration
@ConfigurationProperties(prefix = "auth")
public class AuthConfig {
    
    // JWTé…ç½®
    private JwtConfig jwt = new JwtConfig();
    
    // MFAé…ç½®
    private MfaConfig mfa = new MfaConfig();
    
    // ä¼šè¯é…ç½®
    private SessionConfig session = new SessionConfig();
    
    public static class JwtConfig {
        private String secret;
        private long accessTokenExpiry = 3600; // 1å°æ—¶
        private long refreshTokenExpiry = 86400 * 7; // 7å¤©
        
        // getters and setters
    }
    
    public static class MfaConfig {
        private int codeLength = 6;
        private int codeExpiry = 300; // 5åˆ†é’Ÿ
        private int maxAttempts = 5;
        
        // getters and setters  
    }
    
    public static class SessionConfig {
        private long sessionTimeout = 1800; // 30åˆ†é’Ÿ
        private int maxSessions = 5; // åŒæ—¶æœ€å¤§ä¼šè¯æ•°
        
        // getters and setters
    }
}
```

---

## 7. ğŸ‘¤ ç”¨æˆ·è®¤è¯çŠ¶æ€ç®¡ç†


### 7.1 è®¤è¯çŠ¶æ€å®šä¹‰


**ğŸ”¸ ä¸‰ç§è®¤è¯çŠ¶æ€**
```
ç”¨æˆ·è®¤è¯çŠ¶æ€è½¬æ¢ï¼š

æœªè®¤è¯ï¼ˆUNAUTHENTICATEDï¼‰
    â†“ ç”¨æˆ·åå¯†ç éªŒè¯é€šè¿‡
å·²è®¤è¯ï¼ˆAUTHENTICATEDï¼‰  
    â†“ MFAéªŒè¯é€šè¿‡
å·²éªŒè¯ï¼ˆVERIFIEDï¼‰

çŠ¶æ€è¯´æ˜ï¼š
â€¢ æœªè®¤è¯ï¼šç”¨æˆ·å°šæœªç™»å½•æˆ–ç™»å½•å¤±è´¥
â€¢ å·²è®¤è¯ï¼šå¯†ç éªŒè¯é€šè¿‡ï¼Œä½†å¯èƒ½éœ€è¦MFAéªŒè¯  
â€¢ å·²éªŒè¯ï¼šå®Œæˆæ‰€æœ‰è®¤è¯æ­¥éª¤ï¼Œè·å¾—å®Œå…¨è®¿é—®æƒé™
```

### 7.2 çŠ¶æ€ç®¡ç†å®ç°


```java
// è®¤è¯çŠ¶æ€æšä¸¾
public enum AuthStatus {
    UNAUTHENTICATED("æœªè®¤è¯"),
    AUTHENTICATED("å·²è®¤è¯"), 
    VERIFIED("å·²éªŒè¯");
    
    private final String description;
    
    AuthStatus(String description) {
        this.description = description;
    }
}

// ç”¨æˆ·ä¼šè¯å¯¹è±¡
public class UserSession {
    private String sessionId;
    private Long userId;
    private AuthStatus authStatus;
    private Set<String> permissions;
    private LocalDateTime lastActivity;
    private LocalDateTime expiresAt;
    private String deviceId;
    private String ipAddress;
    
    // æ£€æŸ¥æ˜¯å¦éœ€è¦MFAéªŒè¯
    public boolean needsMfaVerification() {
        return authStatus == AuthStatus.AUTHENTICATED;
    }
    
    // æ£€æŸ¥æ˜¯å¦å®Œå…¨éªŒè¯
    public boolean isFullyVerified() {
        return authStatus == AuthStatus.VERIFIED;
    }
    
    // æ›´æ–°è®¤è¯çŠ¶æ€
    public void updateAuthStatus(AuthStatus newStatus) {
        this.authStatus = newStatus;
        this.lastActivity = LocalDateTime.now();
    }
}
```

### 7.3 çŠ¶æ€å­˜å‚¨ç®¡ç†


```java
// ä¼šè¯ç®¡ç†æœåŠ¡
@Service
public class SessionManager {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // åˆ›å»ºä¼šè¯
    public UserSession createSession(Long userId) {
        UserSession session = new UserSession();
        session.setSessionId(generateSessionId());
        session.setUserId(userId);
        session.setAuthStatus(AuthStatus.UNAUTHENTICATED);
        session.setLastActivity(LocalDateTime.now());
        session.setExpiresAt(LocalDateTime.now().plusMinutes(30));
        
        // å­˜å‚¨åˆ°Redis
        String key = "session:" + session.getSessionId();
        redisTemplate.opsForValue().set(key, session, Duration.ofMinutes(30));
        
        return session;
    }
    
    // æ›´æ–°è®¤è¯çŠ¶æ€
    public void updateAuthStatus(String sessionId, AuthStatus status) {
        String key = "session:" + sessionId;
        UserSession session = (UserSession) redisTemplate.opsForValue().get(key);
        
        if (session != null) {
            session.updateAuthStatus(status);
            redisTemplate.opsForValue().set(key, session, Duration.ofMinutes(30));
        }
    }
    
    // è·å–ä¼šè¯
    public UserSession getSession(String sessionId) {
        String key = "session:" + sessionId;
        return (UserSession) redisTemplate.opsForValue().get(key);
    }
    
    // åˆ é™¤ä¼šè¯
    public void removeSession(String sessionId) {
        String key = "session:" + sessionId;
        redisTemplate.delete(key);
    }
}
```

---

## 8. ğŸ”„ è®¤è¯æµç¨‹çŠ¶æ€æœº


### 8.1 çŠ¶æ€æœºè®¾è®¡å›¾


```
è®¤è¯æµç¨‹çŠ¶æ€æœºï¼š

        å¼€å§‹
         â”‚
         â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   æœªè®¤è¯     â”‚
   â”‚ UNAUTHENTICATED â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚ è¾“å…¥ç”¨æˆ·åå¯†ç 
          â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     å¯†ç é”™è¯¯
   â”‚  å¯†ç éªŒè¯     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
          â”‚ å¯†ç æ­£ç¡®              â”‚
          â–¼                     â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
   â”‚   å·²è®¤è¯     â”‚             â”‚
   â”‚ AUTHENTICATED â”‚             â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
          â”‚                     â”‚
     â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                â”‚
     â–¼         â–¼                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚æ— éœ€MFA  â”‚ â”‚ éœ€è¦MFAéªŒè¯  â”‚     â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
     â”‚            â”‚ MFAéªŒè¯      â”‚
     â”‚            â–¼             â”‚
     â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
     â”‚     â”‚  MFAéªŒè¯     â”‚     â”‚
     â”‚     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
     â”‚            â”‚             â”‚
     â”‚       â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”        â”‚
     â”‚       â–¼         â–¼        â”‚
     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
     â”‚  â”‚MFAæˆåŠŸ â”‚ â”‚MFAå¤±è´¥ â”‚   â”‚
     â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜   â”‚
     â”‚       â”‚          â”‚       â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
             â–¼                   â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
      â”‚   å·²éªŒè¯     â”‚           â”‚
      â”‚  VERIFIED    â”‚           â”‚
      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
             â”‚                   â”‚
             â–¼                   â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚  è®¿é—®ç³»ç»Ÿ     â”‚    â”‚  è®¤è¯å¤±è´¥     â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 çŠ¶æ€æœºå®ç°


```java
// è®¤è¯çŠ¶æ€æœº
@Component
public class AuthStateMachine {
    
    // çŠ¶æ€è½¬æ¢æ–¹æ³•
    public AuthResult processPasswordAuth(String sessionId, String username, String password) {
        UserSession session = sessionManager.getSession(sessionId);
        
        // éªŒè¯å¯†ç 
        if (userService.validatePassword(username, password)) {
            // å¯†ç æ­£ç¡®ï¼Œè½¬æ¢åˆ°å·²è®¤è¯çŠ¶æ€
            session.updateAuthStatus(AuthStatus.AUTHENTICATED);
            sessionManager.updateSession(session);
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦MFA
            if (mfaService.isRequired(session.getUserId())) {
                return AuthResult.needMfa();
            } else {
                // æ— éœ€MFAï¼Œç›´æ¥è½¬æ¢åˆ°å·²éªŒè¯çŠ¶æ€
                session.updateAuthStatus(AuthStatus.VERIFIED);
                sessionManager.updateSession(session);
                return AuthResult.success();
            }
        } else {
            // å¯†ç é”™è¯¯ï¼Œä¿æŒæœªè®¤è¯çŠ¶æ€
            return AuthResult.failed("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
        }
    }
    
    // MFAéªŒè¯çŠ¶æ€è½¬æ¢
    public AuthResult processMfaAuth(String sessionId, String code) {
        UserSession session = sessionManager.getSession(sessionId);
        
        // æ£€æŸ¥å½“å‰çŠ¶æ€
        if (session.getAuthStatus() != AuthStatus.AUTHENTICATED) {
            return AuthResult.failed("è¯·å…ˆå®Œæˆå¯†ç è®¤è¯");
        }
        
        // éªŒè¯MFA
        if (mfaService.validateCode(session.getUserId(), code)) {
            // MFAéªŒè¯æˆåŠŸï¼Œè½¬æ¢åˆ°å·²éªŒè¯çŠ¶æ€
            session.updateAuthStatus(AuthStatus.VERIFIED);
            sessionManager.updateSession(session);
            return AuthResult.success();
        } else {
            // MFAéªŒè¯å¤±è´¥ï¼Œå›é€€åˆ°æœªè®¤è¯çŠ¶æ€
            session.updateAuthStatus(AuthStatus.UNAUTHENTICATED);
            sessionManager.updateSession(session);
            return AuthResult.failed("éªŒè¯ç é”™è¯¯");
        }
    }
}
```

### 8.3 çŠ¶æ€è½¬æ¢è§„åˆ™


**ğŸ”¸ çŠ¶æ€è½¬æ¢è§„åˆ™è¡¨**

| å½“å‰çŠ¶æ€ | **è§¦å‘äº‹ä»¶** | **ç›®æ ‡çŠ¶æ€** | **æ¡ä»¶æ£€æŸ¥** |
|----------|-------------|-------------|-------------|
| `UNAUTHENTICATED` | `å¯†ç éªŒè¯æˆåŠŸ` | `AUTHENTICATED` | `ç”¨æˆ·åå¯†ç æ­£ç¡®` |
| `AUTHENTICATED` | `æ— éœ€MFA` | `VERIFIED` | `ç”¨æˆ·æœªå¯ç”¨MFA` |
| `AUTHENTICATED` | `MFAéªŒè¯æˆåŠŸ` | `VERIFIED` | `MFAéªŒè¯ç æ­£ç¡®` |
| `AUTHENTICATED` | `MFAéªŒè¯å¤±è´¥` | `UNAUTHENTICATED` | `MFAéªŒè¯ç é”™è¯¯æˆ–è¶…æ—¶` |
| `ä»»æ„çŠ¶æ€` | `ä¼šè¯è¶…æ—¶` | `UNAUTHENTICATED` | `è¶…è¿‡æœ€å¤§ç©ºé—²æ—¶é—´` |
| `ä»»æ„çŠ¶æ€` | `ç”¨æˆ·ç™»å‡º` | `UNAUTHENTICATED` | `ä¸»åŠ¨é€€å‡ºç™»å½•` |

---

## 9. ğŸ« ä¼šè¯ç®¡ç†å’Œä»¤ç‰Œè®¾è®¡


### 9.1 ä¼šè¯ç®¡ç†ç­–ç•¥


**ğŸ”¸ ä¼šè¯ç®¡ç†æ ¸å¿ƒæ¦‚å¿µ**
```
ä»€ä¹ˆæ˜¯ä¼šè¯ï¼Ÿ
ä¼šè¯å°±åƒä½ åœ¨é“¶è¡ŒåŠä¸šåŠ¡æ—¶çš„"æ’é˜Ÿå·ç "
- æ‹¿åˆ°å·ç ï¼šè¯æ˜ä½ æ­£åœ¨åŠç†ä¸šåŠ¡
- å·ç æœ‰æ•ˆæœŸï¼šè¶…æ—¶å°±éœ€è¦é‡æ–°å–å·  
- å·ç å”¯ä¸€æ€§ï¼šæ¯ä¸ªäººçš„å·ç éƒ½ä¸åŒ
- ä¸šåŠ¡å®Œæˆï¼šå·ç å°±å¤±æ•ˆäº†

Webåº”ç”¨ä¸­çš„ä¼šè¯ï¼š
- ç”¨æˆ·ç™»å½•æˆåŠŸè·å¾—ä¼šè¯ID
- ä¼šè¯IDå­˜å‚¨ç”¨æˆ·çš„è®¤è¯çŠ¶æ€
- æ¯æ¬¡è¯·æ±‚æºå¸¦ä¼šè¯IDéªŒè¯èº«ä»½
- ä¼šè¯è¶…æ—¶æˆ–é€€å‡ºç™»å½•ä¼šè¯å¤±æ•ˆ
```

**ğŸ”¸ ä¼šè¯å­˜å‚¨ç­–ç•¥**

| å­˜å‚¨æ–¹å¼ | **ä¼˜ç‚¹** | **ç¼ºç‚¹** | **é€‚ç”¨åœºæ™¯** |
|---------|---------|---------|-------------|
| **å†…å­˜å­˜å‚¨** | `é€Ÿåº¦æœ€å¿«` | `é‡å¯ä¸¢å¤±ï¼Œå•æœºé™åˆ¶` | `å¼€å‘æµ‹è¯•ç¯å¢ƒ` |
| **Rediså­˜å‚¨** | `é«˜æ€§èƒ½ï¼ŒæŒä¹…åŒ–` | `éœ€è¦é¢å¤–ç»„ä»¶` | `ç”Ÿäº§ç¯å¢ƒæ¨è` |
| **æ•°æ®åº“å­˜å‚¨** | `æ•°æ®å®‰å…¨ï¼Œæ˜“ç®¡ç†` | `æ€§èƒ½ç›¸å¯¹è¾ƒä½` | `æ•°æ®æ•æ„Ÿåœºæ™¯` |
| **åˆ†å¸ƒå¼ç¼“å­˜** | `é«˜å¯ç”¨ï¼Œå¯æ‰©å±•` | `å¤æ‚åº¦é«˜` | `å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿ` |

### 9.2 JWTä»¤ç‰Œè®¾è®¡


**ğŸ”¸ JWTç»“æ„è§£æ**
```java
// JWTä»¤ç‰Œç»“æ„
public class JwtToken {
    // Headerï¼šå¤´éƒ¨ä¿¡æ¯
    private JwtHeader header;
    
    // Payloadï¼šè½½è·ä¿¡æ¯  
    private JwtPayload payload;
    
    // Signatureï¼šç­¾åä¿¡æ¯
    private String signature;
    
    public static class JwtHeader {
        private String alg = "HS256"; // ç­¾åç®—æ³•
        private String typ = "JWT";   // ä»¤ç‰Œç±»å‹
    }
    
    public static class JwtPayload {
        private Long sub;        // ç”¨æˆ·ID(Subject)
        private Long iat;        // ç­¾å‘æ—¶é—´(Issued At)
        private Long exp;        // è¿‡æœŸæ—¶é—´(Expiration)
        private String iss;      // ç­¾å‘è€…(Issuer)
        private List<String> roles;  // ç”¨æˆ·è§’è‰²
        private AuthStatus authStatus; // è®¤è¯çŠ¶æ€
    }
}
```

**ğŸ”¸ JWTç”Ÿæˆå’ŒéªŒè¯**
```java
@Service
public class JwtTokenService {
    
    @Value("${auth.jwt.secret}")
    private String jwtSecret;
    
    @Value("${auth.jwt.accessTokenExpiry}")
    private long accessTokenExpiry;
    
    // ç”Ÿæˆè®¿é—®ä»¤ç‰Œ
    public String generateAccessToken(UserSession session) {
        Date now = new Date();
        Date expiry = new Date(now.getTime() + accessTokenExpiry * 1000);
        
        return Jwts.builder()
            .setSubject(session.getUserId().toString())
            .setIssuedAt(now)
            .setExpiration(expiry)
            .setIssuer("auth-service")
            .claim("sessionId", session.getSessionId())
            .claim("authStatus", session.getAuthStatus())
            .claim("deviceId", session.getDeviceId())
            .signWith(SignatureAlgorithm.HS256, jwtSecret)
            .compact();
    }
    
    // éªŒè¯ä»¤ç‰Œ
    public Claims validateToken(String token) {
        try {
            return Jwts.parser()
                .setSigningKey(jwtSecret)
                .parseClaimsJws(token)
                .getBody();
        } catch (JwtException e) {
            throw new InvalidTokenException("ä»¤ç‰Œæ— æ•ˆ", e);
        }
    }
    
    // åˆ·æ–°ä»¤ç‰Œ
    public String refreshToken(String oldToken) {
        Claims claims = validateToken(oldToken);
        String sessionId = claims.get("sessionId", String.class);
        
        UserSession session = sessionManager.getSession(sessionId);
        if (session == null || !session.isFullyVerified()) {
            throw new InvalidTokenException("ä¼šè¯æ— æ•ˆæˆ–æœªå®Œå…¨éªŒè¯");
        }
        
        return generateAccessToken(session);
    }
}
```

### 9.3 ä»¤ç‰Œå®‰å…¨ç­–ç•¥


**ğŸ”¸ ä»¤ç‰Œè½®è½¬æœºåˆ¶**
```java
// ä»¤ç‰Œè½®è½¬æœåŠ¡
@Service
public class TokenRotationService {
    
    // çŸ­æœŸè®¿é—®ä»¤ç‰Œ + é•¿æœŸåˆ·æ–°ä»¤ç‰Œ
    public TokenPair issueTokens(UserSession session) {
        String accessToken = generateAccessToken(session, Duration.ofMinutes(15));
        String refreshToken = generateRefreshToken(session, Duration.ofDays(7));
        
        // å­˜å‚¨åˆ·æ–°ä»¤ç‰Œ
        tokenStorage.storeRefreshToken(session.getUserId(), refreshToken);
        
        return new TokenPair(accessToken, refreshToken);
    }
    
    // ä½¿ç”¨åˆ·æ–°ä»¤ç‰Œè·å–æ–°çš„è®¿é—®ä»¤ç‰Œ
    public TokenPair rotateTokens(String refreshToken) {
        // éªŒè¯åˆ·æ–°ä»¤ç‰Œ
        Claims claims = validateRefreshToken(refreshToken);
        Long userId = Long.parseLong(claims.getSubject());
        
        // æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦åœ¨ç™½åå•ä¸­
        if (!tokenStorage.isValidRefreshToken(userId, refreshToken)) {
            throw new InvalidTokenException("åˆ·æ–°ä»¤ç‰Œæ— æ•ˆ");
        }
        
        // æ’¤é”€æ—§çš„åˆ·æ–°ä»¤ç‰Œ
        tokenStorage.revokeRefreshToken(userId, refreshToken);
        
        // ç”Ÿæˆæ–°çš„ä»¤ç‰Œå¯¹
        UserSession session = sessionManager.getSessionByUserId(userId);
        return issueTokens(session);
    }
}
```

**ğŸ”¸ ä»¤ç‰Œé»‘åå•æœºåˆ¶**
```java
// ä»¤ç‰Œé»‘åå•ç®¡ç†
@Service  
public class TokenBlacklistService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // æ·»åŠ ä»¤ç‰Œåˆ°é»‘åå•
    public void blacklistToken(String token) {
        Claims claims = jwtTokenService.validateToken(token);
        Date expiration = claims.getExpiration();
        
        String key = "blacklist:" + token;
        long ttl = expiration.getTime() - System.currentTimeMillis();
        
        // å­˜å‚¨åˆ°Redisï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´
        redisTemplate.opsForValue().set(key, "blacklisted", Duration.ofMillis(ttl));
    }
    
    // æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦åœ¨é»‘åå•ä¸­
    public boolean isBlacklisted(String token) {
        String key = "blacklist:" + token;
        return redisTemplate.hasKey(key);
    }
    
    // ç”¨æˆ·ç™»å‡ºæ—¶åŠ å…¥é»‘åå•
    public void blacklistUserTokens(Long userId) {
        // è·å–ç”¨æˆ·æ‰€æœ‰æ´»è·ƒä»¤ç‰Œ
        List<String> userTokens = tokenStorage.getUserActiveTokens(userId);
        
        // æ‰¹é‡åŠ å…¥é»‘åå•
        userTokens.forEach(this::blacklistToken);
        
        // æ¸…é™¤ç”¨æˆ·ä»¤ç‰Œå­˜å‚¨
        tokenStorage.clearUserTokens(userId);
    }
}
```

---

## 10. âš–ï¸ é«˜å¯ç”¨å’Œè´Ÿè½½å‡è¡¡


### 10.1 é«˜å¯ç”¨æ¶æ„è®¾è®¡


**ğŸ”¸ è®¤è¯æœåŠ¡é«˜å¯ç”¨æ–¹æ¡ˆ**
```
é«˜å¯ç”¨éƒ¨ç½²æ¶æ„ï¼š

              ã€è´Ÿè½½å‡è¡¡å±‚ã€‘
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚      Load Balancer      â”‚
         â”‚    (Nginx/HAProxy)      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚         â”‚         â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚è®¤è¯èŠ‚ç‚¹1 â”‚ â”‚è®¤è¯èŠ‚ç‚¹2 â”‚ â”‚è®¤è¯èŠ‚ç‚¹3 â”‚
    â”‚         â”‚ â”‚         â”‚ â”‚         â”‚
    â”‚å¥åº·çŠ¶æ€ â”‚ â”‚å¥åº·çŠ¶æ€ â”‚ â”‚å¥åº·çŠ¶æ€ â”‚
    â”‚Active   â”‚ â”‚Active   â”‚ â”‚Active   â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
          â”‚           â”‚           â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”´â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚   â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Redis Cluster  â”‚
              â”‚   ä¸»ä»å¤åˆ¶      â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å…³é”®ç‰¹æ€§ï¼š
âœ… å¤šèŠ‚ç‚¹éƒ¨ç½²ï¼šå•ç‚¹æ•…éšœä¸å½±å“æ•´ä½“æœåŠ¡
âœ… å¥åº·æ£€æŸ¥ï¼šè‡ªåŠ¨æ£€æµ‹èŠ‚ç‚¹çŠ¶æ€
âœ… æ•…éšœè½¬ç§»ï¼šæ•…éšœèŠ‚ç‚¹è‡ªåŠ¨ä»è´Ÿè½½å‡è¡¡ä¸­ç§»é™¤
âœ… æ•°æ®å†—ä½™ï¼šRedisä¸»ä»å¤åˆ¶ä¿è¯æ•°æ®å¯ç”¨æ€§
```

### 10.2 è´Ÿè½½å‡è¡¡é…ç½®


**ğŸ”¸ Nginxè´Ÿè½½å‡è¡¡é…ç½®**
```nginx
# nginx.conf
upstream auth_backend {
    # åŠ æƒè½®è¯¢
    server 192.168.1.10:8080 weight=3 max_fails=2 fail_timeout=30s;
    server 192.168.1.11:8080 weight=2 max_fails=2 fail_timeout=30s;
    server 192.168.1.12:8080 weight=1 max_fails=2 fail_timeout=30s backup;
    
    # ä¼šè¯ä¿æŒ(å¯é€‰)
    ip_hash;
    
    # å¥åº·æ£€æŸ¥
    keepalive 32;
}

server {
    listen 80;
    server_name auth.example.com;
    
    # è®¤è¯æ¥å£ä»£ç†
    location /auth/ {
        proxy_pass http://auth_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 5s;
        proxy_send_timeout 10s;
        proxy_read_timeout 10s;
        
        # é”™è¯¯å¤„ç†
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503;
    }
    
    # å¥åº·æ£€æŸ¥æ¥å£
    location /health {
        proxy_pass http://auth_backend/actuator/health;
    }
}
```

### 10.3 æœåŠ¡å¥åº·æ£€æŸ¥


```java
// å¥åº·æ£€æŸ¥ç«¯ç‚¹
@RestController
@RequestMapping("/actuator")
public class HealthController {
    
    @Autowired
    private DatabaseHealthIndicator databaseHealth;
    
    @Autowired  
    private RedisHealthIndicator redisHealth;
    
    @GetMapping("/health")
    public ResponseEntity<Map<String, Object>> health() {
        Map<String, Object> status = new HashMap<>();
        
        try {
            // æ£€æŸ¥æ•°æ®åº“è¿æ¥
            boolean dbHealthy = databaseHealth.isHealthy();
            status.put("database", dbHealthy ? "UP" : "DOWN");
            
            // æ£€æŸ¥Redisè¿æ¥
            boolean redisHealthy = redisHealth.isHealthy();
            status.put("redis", redisHealthy ? "UP" : "DOWN");
            
            // æ£€æŸ¥ç³»ç»Ÿèµ„æº
            status.put("memory", getMemoryUsage());
            status.put("cpu", getCpuUsage());
            status.put("timestamp", Instant.now());
            
            // æ•´ä½“å¥åº·çŠ¶æ€
            boolean overall = dbHealthy && redisHealthy;
            status.put("status", overall ? "UP" : "DOWN");
            
            HttpStatus httpStatus = overall ? HttpStatus.OK : HttpStatus.SERVICE_UNAVAILABLE;
            return ResponseEntity.status(httpStatus).body(status);
            
        } catch (Exception e) {
            status.put("status", "DOWN");
            status.put("error", e.getMessage());
            return ResponseEntity.status(HttpStatus.SERVICE_UNAVAILABLE).body(status);
        }
    }
}
```

### 10.4 ç†”æ–­å’Œé™æµæœºåˆ¶


```java
// ç†”æ–­å™¨é…ç½®
@Configuration
public class CircuitBreakerConfig {
    
    @Bean
    public CircuitBreaker authCircuitBreaker() {
        return CircuitBreaker.ofDefaults("auth-service")
            .toBuilder()
            .failureRateThreshold(50)        // å¤±è´¥ç‡50%è§¦å‘ç†”æ–­
            .waitDurationInOpenState(Duration.ofSeconds(30))  // ç†”æ–­30ç§’
            .slidingWindowSize(10)           // æ»‘åŠ¨çª—å£10ä¸ªè¯·æ±‚
            .minimumNumberOfCalls(5)         // æœ€å°è°ƒç”¨æ¬¡æ•°
            .build();
    }
}

// é™æµé…ç½®
@Configuration
public class RateLimitConfig {
    
    @Bean
    public RateLimiter loginRateLimiter() {
        RateLimiterConfig config = RateLimiterConfig.custom()
            .limitRefreshPeriod(Duration.ofMinutes(1))  // 1åˆ†é’Ÿåˆ·æ–°
            .limitForPeriod(10)                         // æ¯åˆ†é’Ÿ10æ¬¡è¯·æ±‚
            .timeoutDuration(Duration.ofSeconds(5))     // ç­‰å¾…5ç§’
            .build();
            
        return RateLimiter.of("login-rate-limiter", config);
    }
}
```

---

## 11. ğŸ”Œ APIæ¥å£è§„èŒƒ


### 11.1 æ¥å£è®¾è®¡åŸåˆ™


**ğŸ”¸ RESTful APIè®¾è®¡è§„èŒƒ**
```
URLè®¾è®¡åŸåˆ™ï¼š
âœ… ä½¿ç”¨åè¯è€ŒéåŠ¨è¯ï¼š/users è€Œä¸æ˜¯ /getUsers
âœ… ä½¿ç”¨å¤æ•°å½¢å¼ï¼š/users è€Œä¸æ˜¯ /user  
âœ… å±‚çº§å…³ç³»æ¸…æ™°ï¼š/users/{id}/sessions
âœ… ç‰ˆæœ¬æ§åˆ¶ï¼š/v1/auth/login

HTTPæ–¹æ³•ä½¿ç”¨ï¼š
GET    - è·å–èµ„æº
POST   - åˆ›å»ºèµ„æº  
PUT    - å®Œæ•´æ›´æ–°èµ„æº
PATCH  - éƒ¨åˆ†æ›´æ–°èµ„æº
DELETE - åˆ é™¤èµ„æº

çŠ¶æ€ç è§„èŒƒï¼š
200 - è¯·æ±‚æˆåŠŸ
201 - åˆ›å»ºæˆåŠŸ
400 - è¯·æ±‚å‚æ•°é”™è¯¯
401 - æœªæˆæƒ
403 - ç¦æ­¢è®¿é—®
404 - èµ„æºä¸å­˜åœ¨
500 - æœåŠ¡å™¨é”™è¯¯
```

### 11.2 è®¤è¯ç›¸å…³æ¥å£å®šä¹‰


**ğŸ”¸ ç”¨æˆ·ç™»å½•æ¥å£**
```java
// ç™»å½•æ¥å£
@PostMapping("/v1/auth/login")
public ResponseEntity<AuthResponse> login(@RequestBody @Valid LoginRequest request) {
    /*
    è¯·æ±‚ç¤ºä¾‹ï¼š
    POST /v1/auth/login
    {
        "username": "user123",
        "password": "password123", 
        "deviceId": "device_abc123",
        "deviceInfo": {
            "platform": "web",
            "browser": "Chrome",
            "version": "91.0"
        }
    }
    
    å“åº”ç¤ºä¾‹ï¼š
    {
        "code": 200,
        "message": "ç™»å½•æˆåŠŸ",
        "data": {
            "sessionId": "sess_abc123",
            "accessToken": "eyJhbGci...",
            "refreshToken": "refresh_xyz789",
            "needMfa": false,
            "user": {
                "id": 12345,
                "username": "user123",
                "email": "user@example.com"
            }
        }
    }
    */
}
```

**ğŸ”¸ MFAéªŒè¯æ¥å£**
```java
// MFAéªŒè¯æ¥å£
@PostMapping("/v1/auth/mfa/verify")
public ResponseEntity<MfaResponse> verifyMfa(@RequestBody @Valid MfaRequest request) {
    /*
    è¯·æ±‚ç¤ºä¾‹ï¼š
    POST /v1/auth/mfa/verify
    {
        "sessionId": "sess_abc123",
        "code": "123456",
        "mfaType": "SMS"
    }
    
    å“åº”ç¤ºä¾‹ï¼š
    {
        "code": 200,
        "message": "MFAéªŒè¯æˆåŠŸ",
        "data": {
            "verified": true,
            "accessToken": "eyJhbGci...",
            "refreshToken": "refresh_new123"
        }
    }
    */
}

// å‘é€MFAéªŒè¯ç æ¥å£
@PostMapping("/v1/auth/mfa/send")
public ResponseEntity<SendCodeResponse> sendMfaCode(@RequestBody @Valid SendCodeRequest request) {
    /*
    è¯·æ±‚ç¤ºä¾‹ï¼š
    POST /v1/auth/mfa/send
    {
        "sessionId": "sess_abc123",
        "mfaType": "SMS",
        "target": "+86138****5678"
    }
    
    å“åº”ç¤ºä¾‹ï¼š
    {
        "code": 200,
        "message": "éªŒè¯ç å‘é€æˆåŠŸ",
        "data": {
            "sent": true,
            "expiresIn": 300,
            "canResendAfter": 60
        }
    }
    */
}
```

### 11.3 ä¼šè¯ç®¡ç†æ¥å£


**ğŸ”¸ ä¼šè¯ç›¸å…³æ¥å£**
```java
// è·å–å½“å‰ä¼šè¯ä¿¡æ¯
@GetMapping("/v1/auth/session")
public ResponseEntity<SessionResponse> getCurrentSession(HttpServletRequest request) {
    /*
    è¯·æ±‚å¤´ï¼š
    Authorization: Bearer eyJhbGci...
    
    å“åº”ç¤ºä¾‹ï¼š
    {
        "code": 200,
        "message": "è·å–æˆåŠŸ",
        "data": {
            "sessionId": "sess_abc123",
            "userId": 12345,
            "authStatus": "VERIFIED",
            "lastActivity": "2025-08-12T15:30:00Z",
            "expiresAt": "2025-08-12T16:00:00Z",
            "deviceInfo": {
                "deviceId": "device_abc123",
                "platform": "web"
            }
        }
    }
    */
}

// åˆ·æ–°ä»¤ç‰Œ
@PostMapping("/v1/auth/token/refresh")
public ResponseEntity<TokenResponse> refreshToken(@RequestBody RefreshTokenRequest request) {
    /*
    è¯·æ±‚ç¤ºä¾‹ï¼š
    POST /v1/auth/token/refresh
    {
        "refreshToken": "refresh_xyz789"
    }
    
    å“åº”ç¤ºä¾‹ï¼š
    {
        "code": 200,
        "message": "ä»¤ç‰Œåˆ·æ–°æˆåŠŸ",
        "data": {
            "accessToken": "eyJhbGci...",
            "refreshToken": "refresh_new456",
            "expiresIn": 3600
        }
    }
    */
}

// ç”¨æˆ·ç™»å‡º
@PostMapping("/v1/auth/logout")
public ResponseEntity<LogoutResponse> logout(HttpServletRequest request) {
    /*
    è¯·æ±‚å¤´ï¼š
    Authorization: Bearer eyJhbGci...
    
    å“åº”ç¤ºä¾‹ï¼š
    {
        "code": 200,
        "message": "ç™»å‡ºæˆåŠŸ",
        "data": {
            "loggedOut": true
        }
    }
    */
}
```

### 11.4 é”™è¯¯å“åº”è§„èŒƒ


**ğŸ”¸ ç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼**
```java
// é”™è¯¯å“åº”å®ä½“
public class ErrorResponse {
    private int code;           // é”™è¯¯ç 
    private String message;     // é”™è¯¯ä¿¡æ¯
    private String details;     // è¯¦ç»†æè¿°
    private long timestamp;     // æ—¶é—´æˆ³
    private String path;        // è¯·æ±‚è·¯å¾„
    
    /*
    é”™è¯¯å“åº”ç¤ºä¾‹ï¼š
    {
        "code": 401,
        "message": "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯",
        "details": "æä¾›çš„å‡­è¯æ— æ•ˆï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç ",
        "timestamp": 1692024000000,
        "path": "/v1/auth/login"
    }
    */
}

// å…¨å±€å¼‚å¸¸å¤„ç†
@ControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(AuthenticationException.class)
    public ResponseEntity<ErrorResponse> handleAuthException(AuthenticationException e) {
        ErrorResponse error = ErrorResponse.builder()
            .code(401)
            .message("è®¤è¯å¤±è´¥")
            .details(e.getMessage())
            .timestamp(System.currentTimeMillis())
            .build();
            
        return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(error);
    }
    
    @ExceptionHandler(ValidationException.class)
    public ResponseEntity<ErrorResponse> handleValidationException(ValidationException e) {
        ErrorResponse error = ErrorResponse.builder()
            .code(400)
            .message("å‚æ•°éªŒè¯å¤±è´¥")
            .details(e.getMessage())
            .timestamp(System.currentTimeMillis())
            .build();
            
        return ResponseEntity.status(HttpStatus.BAD_REQUEST).body(error);
    }
}
```

---

## 12. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 12.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ MFAç³»ç»Ÿæ¶æ„ï¼šå¤šå±‚æ¬¡ã€æ¨¡å—åŒ–çš„è®¤è¯æœåŠ¡è®¾è®¡
ğŸ”¸ å¾®æœåŠ¡æ‹†åˆ†ï¼šæŒ‰ä¸šåŠ¡èƒ½åŠ›æ‹†åˆ†ï¼ŒæœåŠ¡è¾¹ç•Œæ¸…æ™°
ğŸ”¸ æ•°æ®åº“è®¾è®¡ï¼šç”¨æˆ·ã€è®¤è¯ã€MFAã€ä¼šè¯ç­‰æ ¸å¿ƒè¡¨ç»“æ„
ğŸ”¸ è®¤è¯çŠ¶æ€ï¼šæœªè®¤è¯â†’å·²è®¤è¯â†’å·²éªŒè¯çš„çŠ¶æ€è½¬æ¢
ğŸ”¸ ä»¤ç‰Œè®¾è®¡ï¼šJWTç»“æ„ã€å®‰å…¨ç­–ç•¥ã€è½®è½¬æœºåˆ¶
ğŸ”¸ é«˜å¯ç”¨æ¶æ„ï¼šè´Ÿè½½å‡è¡¡ã€å¥åº·æ£€æŸ¥ã€ç†”æ–­é™æµ
ğŸ”¸ APIè§„èŒƒï¼šRESTfulè®¾è®¡ã€é”™è¯¯å¤„ç†ã€æ¥å£æ ‡å‡†åŒ–
```

### 12.2 æ¶æ„è®¾è®¡å…³é”®è¦ç‚¹


**ğŸ”¹ ç³»ç»Ÿåˆ†å±‚çš„ä»·å€¼**
```
åˆ†å±‚æ¶æ„çš„å¥½å¤„ï¼š
â€¢ èŒè´£åˆ†ç¦»ï¼šæ¯å±‚ä¸“æ³¨è‡ªå·±çš„åŠŸèƒ½
â€¢ æ˜“äºç»´æŠ¤ï¼šä¿®æ”¹æŸå±‚ä¸å½±å“å…¶ä»–å±‚
â€¢ å¯æ‰©å±•æ€§ï¼šå¯ä»¥ç‹¬ç«‹æ‰©å±•æŸä¸ªå±‚æ¬¡
â€¢ æŠ€æœ¯é€‰æ‹©ï¼šä¸åŒå±‚å¯ä»¥é€‰æ‹©æœ€é€‚åˆçš„æŠ€æœ¯

å®é™…åº”ç”¨ï¼š
â€¢ APIç½‘å…³å±‚ï¼šç»Ÿä¸€å…¥å£ï¼Œæµé‡ç®¡æ§
â€¢ ä¸šåŠ¡æœåŠ¡å±‚ï¼šæ ¸å¿ƒè®¤è¯é€»è¾‘
â€¢ æ•°æ®å­˜å‚¨å±‚ï¼šæŒä¹…åŒ–å’Œç¼“å­˜
```

**ğŸ”¹ å¾®æœåŠ¡æ‹†åˆ†çš„åŸåˆ™**
```
æ‹†åˆ†è€ƒè™‘å› ç´ ï¼š
â€¢ ä¸šåŠ¡è¾¹ç•Œï¼šæŒ‰ä¸šåŠ¡åŠŸèƒ½æ‹†åˆ†æœåŠ¡
â€¢ æ•°æ®æ‰€æœ‰æƒï¼šæ¯ä¸ªæœåŠ¡ç®¡ç†è‡ªå·±çš„æ•°æ®
â€¢ å›¢é˜Ÿç»“æ„ï¼šæœåŠ¡è¾¹ç•Œä¸å›¢é˜Ÿè¾¹ç•Œå¯¹åº”
â€¢ æŠ€æœ¯æ ˆï¼šå¯ä»¥é€‰æ‹©æœ€é€‚åˆçš„æŠ€æœ¯

é¿å…è¿‡åº¦æ‹†åˆ†ï¼š
â€¢ å¤ªå°çš„æœåŠ¡å¢åŠ å¤æ‚åº¦
â€¢ æœåŠ¡é—´é€šä¿¡å¼€é”€
â€¢ åˆ†å¸ƒå¼ç³»ç»Ÿçš„å¤æ‚æ€§
```

**ğŸ”¹ çŠ¶æ€ç®¡ç†çš„æ ¸å¿ƒæ€æƒ³**
```
çŠ¶æ€æœºè®¾è®¡åŸåˆ™ï¼š
â€¢ çŠ¶æ€æ˜ç¡®ï¼šæ¯ä¸ªçŠ¶æ€å«ä¹‰æ¸…æ¥š
â€¢ è½¬æ¢è§„åˆ™ï¼šçŠ¶æ€è½¬æ¢æ¡ä»¶æ˜ç¡®  
â€¢ é”™è¯¯å¤„ç†ï¼šå¼‚å¸¸æƒ…å†µçš„çŠ¶æ€å›é€€
â€¢ æŒä¹…åŒ–ï¼šçŠ¶æ€éœ€è¦å¯é å­˜å‚¨

è®¤è¯çŠ¶æ€çš„æ„ä¹‰ï¼š
â€¢ æœªè®¤è¯ï¼šç¡®ä¿å®‰å…¨ï¼Œæ‹’ç»è®¿é—®
â€¢ å·²è®¤è¯ï¼šå…è®¸åŸºæœ¬æ“ä½œï¼Œä½†é™åˆ¶æ•æ„Ÿæ“ä½œ
â€¢ å·²éªŒè¯ï¼šå®Œå…¨è®¿é—®ï¼Œæ‰€æœ‰æ“ä½œæƒé™
```

### 12.3 å®‰å…¨è®¾è®¡è¦ç‚¹


**ğŸ”¹ ä»¤ç‰Œå®‰å…¨ç­–ç•¥**
```
JWTå®‰å…¨è€ƒè™‘ï¼š
â€¢ çŸ­æœŸæœ‰æ•ˆï¼šè®¿é—®ä»¤ç‰Œæ—¶é—´çŸ­ï¼Œå‡å°‘æ³„éœ²é£é™©
â€¢ ä»¤ç‰Œè½®è½¬ï¼šå®šæœŸæ›´æ¢ï¼Œé™ä½é‡æ”¾æ”»å‡»
â€¢ é»‘åå•æœºåˆ¶ï¼šæ’¤é”€ä»¤ç‰Œï¼Œç«‹å³å¤±æ•ˆ
â€¢ ç­¾åéªŒè¯ï¼šé˜²æ­¢ä»¤ç‰Œè¢«ç¯¡æ”¹

ä¼šè¯å®‰å…¨ï¼š
â€¢ ä¼šè¯è¶…æ—¶ï¼šç©ºé—²è¶…æ—¶è‡ªåŠ¨ç™»å‡º
â€¢ è®¾å¤‡ç»‘å®šï¼šé™åˆ¶ä¼šè¯è®¾å¤‡æ•°é‡
â€¢ å¼‚åœ°æ£€æµ‹ï¼šå¼‚å¸¸ç™»å½•ä½ç½®å‘Šè­¦
â€¢ å¹¶å‘æ§åˆ¶ï¼šé™åˆ¶åŒæ—¶ç™»å½•ä¼šè¯æ•°
```

**ğŸ”¹ æ•°æ®å­˜å‚¨å®‰å…¨**
```
æ•æ„Ÿæ•°æ®ä¿æŠ¤ï¼š
â€¢ å¯†ç å“ˆå¸Œï¼šä½¿ç”¨BCryptç­‰å®‰å…¨å“ˆå¸Œ
â€¢ åŠ ç›å¤„ç†ï¼šé˜²æ­¢å½©è™¹è¡¨æ”»å‡»
â€¢ æ•°æ®åŠ å¯†ï¼šæ•æ„Ÿå­—æ®µåŠ å¯†å­˜å‚¨
â€¢ è®¿é—®æ§åˆ¶ï¼šæ•°æ®åº“æƒé™æœ€å°åŒ–

ç¼“å­˜å®‰å…¨ï¼š
â€¢ Rediså¯†ç ï¼šè®¾ç½®è®¿é—®å¯†ç 
â€¢ ç½‘ç»œéš”ç¦»ï¼šå†…ç½‘è®¿é—®ï¼Œé˜²ç«å¢™ä¿æŠ¤
â€¢ æ•°æ®è¿‡æœŸï¼šæ•æ„Ÿæ•°æ®è‡ªåŠ¨è¿‡æœŸ
â€¢ å¤‡ä»½åŠ å¯†ï¼šå¤‡ä»½æ–‡ä»¶åŠ å¯†å­˜å‚¨
```

### 12.4 é«˜å¯ç”¨è®¾è®¡è¦ç‚¹


**ğŸ”¹ æœåŠ¡å¯ç”¨æ€§ä¿éšœ**
```
å¤šèŠ‚ç‚¹éƒ¨ç½²ï¼š
â€¢ è‡³å°‘3ä¸ªèŠ‚ç‚¹ï¼šä¿è¯é«˜å¯ç”¨
â€¢ è·¨æœºæˆ¿éƒ¨ç½²ï¼šé˜²æ­¢å•ç‚¹æ•…éšœ
â€¢ è‡ªåŠ¨æ‰©ç¼©å®¹ï¼šæ ¹æ®è´Ÿè½½åŠ¨æ€è°ƒæ•´
â€¢ ç°åº¦å‘å¸ƒï¼šé™ä½å‡çº§é£é™©

ç›‘æ§å‘Šè­¦ï¼š
â€¢ å¥åº·æ£€æŸ¥ï¼šå®æ—¶ç›‘æ§æœåŠ¡çŠ¶æ€
â€¢ æ€§èƒ½ç›‘æ§ï¼šå“åº”æ—¶é—´ã€é”™è¯¯ç‡
â€¢ èµ„æºç›‘æ§ï¼šCPUã€å†…å­˜ã€ç£ç›˜
â€¢ ä¸šåŠ¡ç›‘æ§ï¼šç™»å½•æˆåŠŸç‡ã€MFAé€šè¿‡ç‡
```

**ğŸ”¹ æ•°æ®å¯é æ€§ä¿éšœ**
```
æ•°æ®åº“é«˜å¯ç”¨ï¼š
â€¢ ä¸»ä»å¤åˆ¶ï¼šæ•°æ®å®æ—¶å¤‡ä»½
â€¢ è¯»å†™åˆ†ç¦»ï¼šå‡è½»ä¸»åº“å‹åŠ›  
â€¢ æ•…éšœåˆ‡æ¢ï¼šä¸»åº“æ•…éšœè‡ªåŠ¨åˆ‡æ¢
â€¢ å®šæœŸå¤‡ä»½ï¼šæ•°æ®å®šæœŸå¤‡ä»½åˆ°å¼‚åœ°

Redisé«˜å¯ç”¨ï¼š
â€¢ å“¨å…µæ¨¡å¼ï¼šè‡ªåŠ¨æ•…éšœåˆ‡æ¢
â€¢ é›†ç¾¤æ¨¡å¼ï¼šæ•°æ®åˆ†ç‰‡å­˜å‚¨
â€¢ æŒä¹…åŒ–ï¼šRDB + AOFåŒé‡ä¿éšœ
â€¢ ç›‘æ§æŠ¥è­¦ï¼šå®æ—¶ç›‘æ§RedisçŠ¶æ€
```

### 12.5 æ€§èƒ½ä¼˜åŒ–è¦ç‚¹


**ğŸ”¹ å“åº”é€Ÿåº¦ä¼˜åŒ–**
```
ç¼“å­˜ç­–ç•¥ï¼š
â€¢ å¤šçº§ç¼“å­˜ï¼šæœ¬åœ°ç¼“å­˜ + åˆ†å¸ƒå¼ç¼“å­˜
â€¢ ç¼“å­˜é¢„çƒ­ï¼šç³»ç»Ÿå¯åŠ¨æ—¶é¢„åŠ è½½çƒ­ç‚¹æ•°æ®
â€¢ ç¼“å­˜æ›´æ–°ï¼šæ•°æ®å˜æ›´æ—¶åŠæ—¶æ›´æ–°ç¼“å­˜
â€¢ ç¼“å­˜é›ªå´©ï¼šè®¾ç½®ä¸åŒçš„è¿‡æœŸæ—¶é—´

æ•°æ®åº“ä¼˜åŒ–ï¼š
â€¢ ç´¢å¼•ä¼˜åŒ–ï¼šä¸ºæŸ¥è¯¢å­—æ®µå»ºç«‹åˆé€‚ç´¢å¼•
â€¢ æŸ¥è¯¢ä¼˜åŒ–ï¼šé¿å…å…¨è¡¨æ‰«æ
â€¢ è¿æ¥æ± ï¼šå¤ç”¨æ•°æ®åº“è¿æ¥
â€¢ åˆ†åº“åˆ†è¡¨ï¼šå¤§æ•°æ®é‡æ—¶è¿›è¡Œåˆ†ç‰‡
```

**ğŸ”¹ å¹¶å‘å¤„ç†ä¼˜åŒ–**
```
å¼‚æ­¥å¤„ç†ï¼š
â€¢ æ¶ˆæ¯é˜Ÿåˆ—ï¼šè€—æ—¶æ“ä½œå¼‚æ­¥å¤„ç†
â€¢ äº‹ä»¶é©±åŠ¨ï¼šè§£è€¦æœåŠ¡é—´ä¾èµ–
â€¢ æ‰¹é‡æ“ä½œï¼šå‡å°‘æ•°æ®åº“äº¤äº’æ¬¡æ•°
â€¢ éé˜»å¡IOï¼šæé«˜å¹¶å‘å¤„ç†èƒ½åŠ›

é™æµé˜²æŠ¤ï¼š
â€¢ æ¥å£é™æµï¼šé˜²æ­¢æ¶æ„è¯·æ±‚
â€¢ ç”¨æˆ·é™æµï¼šé˜²æ­¢å•ç”¨æˆ·æ»¥ç”¨
â€¢ IPé™æµï¼šé˜²æ­¢IPåœ°å€æ”»å‡»
â€¢ ç†”æ–­é™çº§ï¼šç³»ç»Ÿè¿‡è½½æ—¶ä¿æŠ¤æ ¸å¿ƒåŠŸèƒ½
```

### 12.6 è¿ç»´ç®¡ç†è¦ç‚¹


**ğŸ”¹ æ—¥å¿—å’Œå®¡è®¡**
```
æ—¥å¿—åˆ†ç±»ï¼š
â€¢ ä¸šåŠ¡æ—¥å¿—ï¼šç”¨æˆ·ç™»å½•ã€æ“ä½œè®°å½•
â€¢ é”™è¯¯æ—¥å¿—ï¼šç³»ç»Ÿå¼‚å¸¸ã€é”™è¯¯ä¿¡æ¯
â€¢ è®¿é—®æ—¥å¿—ï¼šAPIè°ƒç”¨ã€å“åº”æ—¶é—´
â€¢ å®‰å…¨æ—¥å¿—ï¼šå¼‚å¸¸ç™»å½•ã€æ”»å‡»å°è¯•

å®¡è®¡è¦æ±‚ï¼š
â€¢ æ“ä½œå¯è¿½æº¯ï¼šè®°å½•è°åœ¨ä»€ä¹ˆæ—¶å€™åšäº†ä»€ä¹ˆ
â€¢ æ•°æ®å®Œæ•´æ€§ï¼šæ—¥å¿—ä¸èƒ½è¢«ç¯¡æ”¹
â€¢ é•¿æœŸä¿å­˜ï¼šæ»¡è¶³åˆè§„è¦æ±‚
â€¢ å¿«é€ŸæŸ¥è¯¢ï¼šæ”¯æŒå¿«é€Ÿæ£€ç´¢å’Œåˆ†æ
```

**ğŸ”¹ éƒ¨ç½²å’Œå‘å¸ƒ**
```
CI/CDæµç¨‹ï¼š
â€¢ ä»£ç æ£€æŸ¥ï¼šè‡ªåŠ¨åŒ–ä»£ç è´¨é‡æ£€æŸ¥
â€¢ è‡ªåŠ¨åŒ–æµ‹è¯•ï¼šå•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•
â€¢ æ„å»ºæ‰“åŒ…ï¼šDockeré•œåƒæ„å»º
â€¢ è‡ªåŠ¨éƒ¨ç½²ï¼šè“ç»¿éƒ¨ç½²ã€æ»šåŠ¨æ›´æ–°

é…ç½®ç®¡ç†ï¼š
â€¢ ç¯å¢ƒéš”ç¦»ï¼šå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒåˆ†ç¦»
â€¢ é…ç½®ä¸­å¿ƒï¼šç»Ÿä¸€é…ç½®ç®¡ç†
â€¢ æ•æ„Ÿä¿¡æ¯ï¼šå¯†é’¥ã€å¯†ç åŠ å¯†å­˜å‚¨
â€¢ ç‰ˆæœ¬æ§åˆ¶ï¼šé…ç½®å˜æ›´ç‰ˆæœ¬ç®¡ç†
```

### 12.7 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ”¹ æŠ€æœ¯é€‰å‹å»ºè®®**
```
æ¶æ„é€‰æ‹©ï¼š
â€¢ å°å‹ç³»ç»Ÿï¼šå•ä½“æ¶æ„ï¼Œç®€å•é«˜æ•ˆ
â€¢ ä¸­å‹ç³»ç»Ÿï¼šå¾®æœåŠ¡æ¶æ„ï¼Œæ¨¡å—åŒ–
â€¢ å¤§å‹ç³»ç»Ÿï¼šåˆ†å¸ƒå¼æ¶æ„ï¼Œé«˜å¹¶å‘
â€¢ è¶…å¤§å‹ç³»ç»Ÿï¼šå¾®æœåŠ¡ + æœåŠ¡ç½‘æ ¼

æŠ€æœ¯æ ˆæ¨èï¼š
â€¢ å¼€å‘è¯­è¨€ï¼šJava/Go/Python
â€¢ æ•°æ®åº“ï¼šMySQL/PostgreSQL
â€¢ ç¼“å­˜ï¼šRedis/Memcached
â€¢ æ¶ˆæ¯é˜Ÿåˆ—ï¼šRabbitMQ/Kafka
â€¢ å®¹å™¨åŒ–ï¼šDocker + Kubernetes
```

**ğŸ”¹ å¼€å‘å®è·µå»ºè®®**
```
ä»£ç è´¨é‡ï¼š
â€¢ ä»£ç è§„èŒƒï¼šç»Ÿä¸€ç¼–ç é£æ ¼
â€¢ å•å…ƒæµ‹è¯•ï¼šç¡®ä¿ä»£ç è´¨é‡
â€¢ ä»£ç å®¡æŸ¥ï¼šå›¢é˜Ÿäº’ç›¸å®¡æŸ¥
â€¢ æ–‡æ¡£ç»´æŠ¤ï¼šåŠæ—¶æ›´æ–°æŠ€æœ¯æ–‡æ¡£

å®‰å…¨å®è·µï¼š
â€¢ å®‰å…¨ç¼–ç ï¼šé˜²æ­¢å¸¸è§æ¼æ´
â€¢ ä¾èµ–ç®¡ç†ï¼šåŠæ—¶æ›´æ–°ä¾èµ–ç‰ˆæœ¬
â€¢ å®‰å…¨æµ‹è¯•ï¼šå®šæœŸå®‰å…¨æ‰«æ
â€¢ åº”æ€¥å“åº”ï¼šåˆ¶å®šå®‰å…¨äº‹ä»¶å“åº”æµç¨‹
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
æ¶æ„è®¾è®¡åˆ†å±‚æ¬¡ï¼Œå¾®æœåŠ¡æ‹†åˆ†è¦åˆç†
çŠ¶æ€ç®¡ç†ç”¨çŠ¶æ€æœºï¼Œä»¤ç‰Œå®‰å…¨æ˜¯å…³é”®
é«˜å¯ç”¨é å¤šèŠ‚ç‚¹ï¼Œæ€§èƒ½ä¼˜åŒ–ç”¨ç¼“å­˜
æ—¥å¿—å®¡è®¡ä¸èƒ½å°‘ï¼Œå®‰å…¨é˜²æŠ¤è¦åšå¥½
```

**æœ€ç»ˆç†è§£**ï¼š
- MFAç³»ç»Ÿæ¶æ„è®¾è®¡æ˜¯ä¸€ä¸ªç³»ç»Ÿå·¥ç¨‹ï¼Œéœ€è¦ä»æ¶æ„ã€å®‰å…¨ã€æ€§èƒ½ã€è¿ç»´ç­‰å¤šä¸ªç»´åº¦è€ƒè™‘
- æ ¸å¿ƒæ˜¯è¦ç†è§£ä¸šåŠ¡éœ€æ±‚ï¼Œåˆç†æ‹†åˆ†æœåŠ¡ï¼Œä¿è¯ç³»ç»Ÿçš„å®‰å…¨æ€§å’Œå¯ç”¨æ€§
- å®é™…åº”ç”¨ä¸­è¦æ ¹æ®ä¸šåŠ¡è§„æ¨¡å’Œå›¢é˜Ÿèƒ½åŠ›é€‰æ‹©åˆé€‚çš„æŠ€æœ¯æ ˆå’Œæ¶æ„æ¨¡å¼
- å®‰å…¨è®¤è¯ç³»ç»Ÿè´£ä»»é‡å¤§ï¼Œå¿…é¡»ä¸¥æ ¼æŒ‰ç…§å®‰å…¨æ ‡å‡†è¿›è¡Œè®¾è®¡å’Œå®ç°