---
title: 18ã€å®‰å…¨é˜²æŠ¤ç­–ç•¥
---
## ğŸ“š ç›®å½•

1. [å®‰å…¨é˜²æŠ¤æ ¸å¿ƒæ¦‚å¿µ](#1-å®‰å…¨é˜²æŠ¤æ ¸å¿ƒæ¦‚å¿µ)
2. [åŸºç¡€é˜²æŠ¤ç­–ç•¥](#2-åŸºç¡€é˜²æŠ¤ç­–ç•¥)
3. [ç™»å½•å®‰å…¨æœºåˆ¶](#3-ç™»å½•å®‰å…¨æœºåˆ¶)
4. [å¤šå› å­è®¤è¯è¯¦è§£](#4-å¤šå› å­è®¤è¯è¯¦è§£)
5. [è®¾å¤‡ä¸IPé£æ§](#5-è®¾å¤‡ä¸IPé£æ§)
6. [æ—¥å¿—å®¡è®¡ä¸ç›‘æ§](#6-æ—¥å¿—å®¡è®¡ä¸ç›‘æ§)
7. [Tokenå®‰å…¨ç®¡ç†](#7-Tokenå®‰å…¨ç®¡ç†)
8. [æš´åŠ›ç ´è§£é˜²æŠ¤](#8-æš´åŠ›ç ´è§£é˜²æŠ¤)
9. [å¼‚å¸¸æ£€æµ‹ç³»ç»Ÿ](#9-å¼‚å¸¸æ£€æµ‹ç³»ç»Ÿ)
10. [å¯†ç å®‰å…¨ç­–ç•¥](#10-å¯†ç å®‰å…¨ç­–ç•¥)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” å®‰å…¨é˜²æŠ¤æ ¸å¿ƒæ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯å®‰å…¨é˜²æŠ¤

**é€šä¿—è§£é‡Š**ï¼šå°±åƒç»™ä½ çš„æˆ¿å­è£…é—¨é”ã€ç›‘æ§ã€æŠ¥è­¦å™¨ä¸€æ ·ï¼Œå®‰å…¨é˜²æŠ¤æ˜¯ä¸ºäº†ä¿æŠ¤ä½ çš„ç³»ç»Ÿä¸è¢«åäººè¿›å…¥æˆ–ç ´åã€‚

```
ç°å®ç”Ÿæ´»ä¸­çš„å®‰å…¨é˜²æŠ¤ï¼š        ç³»ç»Ÿå®‰å…¨é˜²æŠ¤ï¼š
æˆ¿å­ â†’ é—¨é”                 åº”ç”¨ â†’ ç”¨æˆ·è®¤è¯
     â†’ ç›‘æ§æ‘„åƒå¤´                 â†’ è¡Œä¸ºç›‘æ§  
     â†’ æŠ¥è­¦ç³»ç»Ÿ                  â†’ å¼‚å¸¸æ£€æµ‹
     â†’ ä¿å®‰å·¡é€»                  â†’ æ—¥å¿—å®¡è®¡
```

### 1.2 é˜²æŠ¤å±‚æ¬¡ç†è§£

**åˆ†å±‚é˜²æŠ¤æ€æƒ³**ï¼šä¸€é“é—¨é”ä¸å¤Ÿï¼Œéœ€è¦å¤šé‡ä¿æŠ¤

```
ğŸ  ç‰©ç†å±‚é¢                   ğŸ’» æ•°å­—å±‚é¢
â”Œâ”€ å›´å¢™ï¼ˆç½‘ç»œé˜²ç«å¢™ï¼‰          â”Œâ”€ ç½‘ç»œå±‚é˜²æŠ¤
â”œâ”€ å¤§é—¨ï¼ˆç™»å½•éªŒè¯ï¼‰            â”œâ”€ åº”ç”¨å±‚è®¤è¯
â”œâ”€ æˆ¿é—¨ï¼ˆæƒé™æ§åˆ¶ï¼‰            â”œâ”€ ä¸šåŠ¡å±‚æˆæƒ
â”œâ”€ ä¿é™©æŸœï¼ˆæ•æ„Ÿæ•°æ®åŠ å¯†ï¼‰      â”œâ”€ æ•°æ®å±‚åŠ å¯†
â””â”€ ç›‘æ§ï¼ˆæ—¥å¿—å®¡è®¡ï¼‰            â””â”€ å®¡è®¡å±‚ç›‘æ§
```

### 1.3 æ ¸å¿ƒé˜²æŠ¤åŸåˆ™

**ğŸ”¸ æœ€å°æƒé™åŸåˆ™**
```
å«ä¹‰ï¼šç”¨æˆ·åªèƒ½è®¿é—®å®Œæˆå·¥ä½œå¿…éœ€çš„æœ€å°‘èµ„æº
æ¯”å¦‚ï¼šæ™®é€šå‘˜å·¥ä¸èƒ½è®¿é—®è´¢åŠ¡ç³»ç»Ÿï¼Œåªèƒ½è®¿é—®è‡ªå·±çš„å·¥ä½œç³»ç»Ÿ
```

**ğŸ”¸ å¤šé‡éªŒè¯åŸåˆ™**  
```
å«ä¹‰ï¼šä¸€ä¸ªå¯†ç ä¸å¤Ÿï¼Œéœ€è¦å¤šç§æ–¹å¼è¯æ˜èº«ä»½
æ¯”å¦‚ï¼šå¯†ç  + æ‰‹æœºéªŒè¯ç  + æŒ‡çº¹è¯†åˆ«
```

**ğŸ”¸ æŒç»­ç›‘æ§åŸåˆ™**
```
å«ä¹‰ï¼š24å°æ—¶ä¸é—´æ–­åœ°ç›‘æ§å¯ç–‘è¡Œä¸º
æ¯”å¦‚ï¼šåŠå¤œçªç„¶å¤§é‡ç™»å½•ã€å¼‚åœ°ç™»å½•ç­‰å¼‚å¸¸æƒ…å†µ
```

---

## 2. ğŸ›¡ï¸ åŸºç¡€é˜²æŠ¤ç­–ç•¥


### 2.1 HttpOnly + Secure é˜²æŠ¤


**ğŸ”¸ HttpOnly æ˜¯ä»€ä¹ˆï¼Ÿ**
ç®€å•è¯´ï¼šè®©Cookieåªèƒ½è¢«æœåŠ¡å™¨è®¿é—®ï¼ŒJavaScriptè¯»ä¸åˆ°

```javascript
// âŒ å±é™©ï¼šJavaScriptå¯ä»¥è¯»å–Cookie
document.cookie; // èƒ½è¯»åˆ°ç”¨æˆ·çš„ç™»å½•ä¿¡æ¯

// âœ… å®‰å…¨ï¼šè®¾ç½®HttpOnlyå
// JavaScriptè¯»ä¸åˆ°Cookieï¼ŒXSSæ”»å‡»å·ä¸èµ°ç”¨æˆ·ç™»å½•çŠ¶æ€
```

**ğŸ”¸ Secure æ˜¯ä»€ä¹ˆï¼Ÿ**
ç®€å•è¯´ï¼šCookieåªèƒ½åœ¨HTTPSè¿æ¥ä¸­ä¼ è¾“ï¼Œé˜²æ­¢è¢«çªƒå¬

```
HTTPä¼ è¾“ï¼š  ç”¨æˆ· â†’ [æ˜æ–‡Cookie] â†’ æœåŠ¡å™¨  âŒ å¯è¢«ä¸­é—´äººæˆªè·
HTTPSä¼ è¾“ï¼š ç”¨æˆ· â†’ [åŠ å¯†Cookie] â†’ æœåŠ¡å™¨  âœ… æ— æ³•è¢«çªƒå¬
```

**ğŸ’» å®é™…è®¾ç½®ç¤ºä¾‹**
```javascript
// Node.js Expressè®¾ç½®å®‰å…¨Cookie
app.use(session({
    cookie: {
        httpOnly: true,    // é˜²XSSæ”»å‡»
        secure: true,      // åªåœ¨HTTPSä¸­ä¼ è¾“  
        maxAge: 86400000   // 24å°æ—¶è¿‡æœŸ
    }
}));
```

### 2.2 CSRF Tokenæœºåˆ¶


**ğŸ”¸ CSRFæ”»å‡»æ˜¯ä»€ä¹ˆï¼Ÿ**
é€šä¿—è§£é‡Šï¼šåç½‘ç«™å†’å……ä½ å‘å¥½ç½‘ç«™å‘è¯·æ±‚

```
æ”»å‡»åœºæ™¯ï¼š
1. ä½ ç™»å½•äº†é“¶è¡Œç½‘ç«™A
2. ä½ è®¿é—®äº†æ¶æ„ç½‘ç«™B  
3. ç½‘ç«™Bå·å·å‘é“¶è¡ŒAå‘é€è½¬è´¦è¯·æ±‚
4. é“¶è¡ŒAä»¥ä¸ºæ˜¯ä½ æœ¬äººæ“ä½œï¼Œæ‰§è¡Œè½¬è´¦

å±å®³ï¼šä½ çš„é’±è¢«å·å·è½¬èµ°äº†ï¼
```

**ğŸ”¸ CSRF Tokenå¦‚ä½•é˜²æŠ¤ï¼Ÿ**
ç®€å•è¯´ï¼šç»™æ¯ä¸ªæ“ä½œä¸€ä¸ª"æš—å·"ï¼Œæ¶æ„ç½‘ç«™ä¸çŸ¥é“æš—å·

```
é˜²æŠ¤æµç¨‹ï¼š
1. ç”¨æˆ·è®¿é—®é“¶è¡Œç½‘ç«™A
2. ç½‘ç«™Aç»™ç”¨æˆ·ä¸€ä¸ªéšæœºæš—å·(Token)
3. ç”¨æˆ·æäº¤è¡¨å•æ—¶å¿…é¡»å¸¦ä¸Šè¿™ä¸ªæš—å·
4. ç½‘ç«™AéªŒè¯æš—å·æ­£ç¡®æ‰æ‰§è¡Œæ“ä½œ
5. æ¶æ„ç½‘ç«™Bä¸çŸ¥é“æš—å·ï¼Œæ— æ³•ä¼ªé€ è¯·æ±‚
```

**ğŸ’» å®ç°ç¤ºä¾‹**
```html
<!-- è¡¨å•ä¸­åŒ…å«CSRF Token -->
<form action="/transfer" method="POST">
    <input type="hidden" name="csrf_token" value="abc123xyz789">
    <input type="text" name="amount" placeholder="è½¬è´¦é‡‘é¢">
    <button type="submit">ç¡®è®¤è½¬è´¦</button>
</form>
```

```javascript
// æœåŠ¡å™¨éªŒè¯CSRF Token
app.post('/transfer', (req, res) => {
    const clientToken = req.body.csrf_token;
    const sessionToken = req.session.csrf_token;
    
    if (clientToken !== sessionToken) {
        return res.status(403).send('CSRFæ”»å‡»æ£€æµ‹');
    }
    
    // Tokenæ­£ç¡®ï¼Œæ‰§è¡Œè½¬è´¦æ“ä½œ
    processTransfer(req.body.amount);
});
```

### 2.3 Tokenæœ€å°æƒé™åŸåˆ™


**ğŸ”¸ ä»€ä¹ˆæ˜¯æœ€å°æƒé™ï¼Ÿ**
é€šä¿—è§£é‡Šï¼šç»™ç”¨æˆ·åˆšå¥½å¤Ÿç”¨çš„æƒé™ï¼Œå¤šä¸€ç‚¹éƒ½ä¸ç»™

```
æƒé™åˆ†é…ç¤ºä¾‹ï¼š
ğŸ‘¨â€ğŸ’¼ æ€»ç»ç†ï¼šæŸ¥çœ‹æ‰€æœ‰éƒ¨é—¨æ•°æ® + å®¡æ‰¹æƒé™
ğŸ‘¨â€ğŸ’» ç¨‹åºå‘˜ï¼šæŸ¥çœ‹å¼€å‘ç›¸å…³æ•°æ® + ä»£ç æäº¤æƒé™  
ğŸ‘¨â€ğŸ¨ è®¾è®¡å¸ˆï¼šæŸ¥çœ‹è®¾è®¡ç›¸å…³æ•°æ® + ç´ æä¸Šä¼ æƒé™
ğŸ”’ è®¿å®¢ï¼š  åªèƒ½æŸ¥çœ‹å…¬å¼€ä¿¡æ¯

æ¯ä¸ªäººåªèƒ½åšè‡ªå·±å·¥ä½œèŒƒå›´å†…çš„äº‹æƒ…
```

**ğŸ’» JWTæƒé™æ§åˆ¶ç¤ºä¾‹**
```javascript
// JWT TokenåŒ…å«ç”¨æˆ·è§’è‰²å’Œæƒé™
const token = jwt.sign({
    userId: 123,
    role: 'developer',
    permissions: ['read:code', 'write:code', 'deploy:test']
}, secretKey);

// æƒé™æ£€æŸ¥ä¸­é—´ä»¶
function checkPermission(required) {
    return (req, res, next) => {
        const user = req.user; // ä»Tokenè§£æå‡ºçš„ç”¨æˆ·ä¿¡æ¯
        
        if (!user.permissions.includes(required)) {
            return res.status(403).json({ 
                error: 'æƒé™ä¸è¶³' 
            });
        }
        
        next();
    };
}

// ä½¿ç”¨æƒé™æ£€æŸ¥
app.post('/deploy', checkPermission('deploy:prod'), (req, res) => {
    // åªæœ‰å…·å¤‡ç”Ÿäº§éƒ¨ç½²æƒé™çš„ç”¨æˆ·æ‰èƒ½è®¿é—®
});
```

---

## 3. ğŸ”‘ ç™»å½•å®‰å…¨æœºåˆ¶


### 3.1 éªŒè¯ç é˜²æŠ¤


**ğŸ”¸ éªŒè¯ç çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ**
ç®€å•è¯´ï¼šè¯æ˜æ“ä½œçš„æ˜¯çœŸäººï¼Œä¸æ˜¯æœºå™¨äºº

```
éªŒè¯ç ç±»å‹ï¼š
ğŸ“ å›¾ç‰‡éªŒè¯ç ï¼šè¯†åˆ«å›¾ç‰‡ä¸­çš„æ•°å­—/å­—æ¯
ğŸ§© æ‹¼å›¾éªŒè¯ç ï¼šæ‹–åŠ¨æ‹¼å›¾å—åˆ°æ­£ç¡®ä½ç½®
ğŸ¤– è¡Œä¸ºéªŒè¯ç ï¼šæ¨¡æ‹Ÿäººç±»æ“ä½œè¡Œä¸º
ğŸ“± çŸ­ä¿¡éªŒè¯ç ï¼šæ‰‹æœºæ¥æ”¶æ•°å­—éªŒè¯ç 
```

**ğŸ”¸ ä½•æ—¶ä½¿ç”¨éªŒè¯ç ï¼Ÿ**
```
ä½¿ç”¨åœºæ™¯ï¼š
â€¢ ç™»å½•å¤±è´¥3æ¬¡åè¦æ±‚è¾“å…¥éªŒè¯ç 
â€¢ æ³¨å†Œè´¦æˆ·æ—¶éªŒè¯æ‰‹æœºå·
â€¢ æ‰¾å›å¯†ç æ—¶éªŒè¯èº«ä»½
â€¢ é‡è¦æ“ä½œç¡®è®¤ï¼ˆè½¬è´¦ã€åˆ é™¤æ•°æ®ï¼‰
```

**ğŸ’» éªŒè¯ç å®ç°ç¤ºä¾‹**
```javascript
// ç”ŸæˆéªŒè¯ç 
function generateCaptcha() {
    const chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    let result = '';
    for (let i = 0; i < 4; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
}

// ç™»å½•æ—¶éªŒè¯ç æ£€æŸ¥
app.post('/login', (req, res) => {
    const { username, password, captcha } = req.body;
    
    // æ£€æŸ¥éªŒè¯ç 
    if (req.session.captcha !== captcha.toUpperCase()) {
        return res.json({ 
            error: 'éªŒè¯ç é”™è¯¯' 
        });
    }
    
    // éªŒè¯ç”¨æˆ·åå¯†ç ...
});
```

### 3.2 åŒé‡éªŒè¯æœºåˆ¶


**ğŸ”¸ ä»€ä¹ˆæ˜¯åŒé‡éªŒè¯ï¼Ÿ**
é€šä¿—è§£é‡Šï¼šé™¤äº†å¯†ç ï¼Œè¿˜éœ€è¦ç¬¬äºŒä¸ªè¯æ®è¯æ˜æ˜¯ä½ æœ¬äºº

```
åŒé‡éªŒè¯æµç¨‹ï¼š
1ï¸âƒ£ è¾“å…¥ç”¨æˆ·åå¯†ç ï¼ˆä½ çŸ¥é“çš„ä¸œè¥¿ï¼‰
2ï¸âƒ£ è¾“å…¥æ‰‹æœºéªŒè¯ç ï¼ˆä½ æ‹¥æœ‰çš„ä¸œè¥¿ï¼‰
âœ… ä¸¤ä¸ªéƒ½å¯¹æ‰èƒ½ç™»å½•æˆåŠŸ

ä¸ºä»€ä¹ˆå®‰å…¨ï¼Ÿ
å³ä½¿å¯†ç è¢«å·ï¼Œæ²¡æœ‰ä½ çš„æ‰‹æœºä¹Ÿç™»å½•ä¸äº†
```

**ğŸ”¸ å¸¸è§çš„ç¬¬äºŒå› å­**
```
ğŸ“± æ‰‹æœºçŸ­ä¿¡ï¼šå‘é€éªŒè¯ç åˆ°æ‰‹æœº
ğŸ“§ é‚®ç®±éªŒè¯ï¼šå‘é€ç¡®è®¤é“¾æ¥åˆ°é‚®ç®±
ğŸ” èº«ä»½éªŒè¯å™¨ï¼šGoogle Authenticatorç­‰APP
ğŸ”‘ ç¡¬ä»¶Tokenï¼šé“¶è¡Œçš„Uç›¾
ğŸ‘† ç”Ÿç‰©è¯†åˆ«ï¼šæŒ‡çº¹ã€äººè„¸è¯†åˆ«
```

**ğŸ’» çŸ­ä¿¡éªŒè¯ç å®ç°**
```javascript
// å‘é€çŸ­ä¿¡éªŒè¯ç 
async function sendSMSCode(phoneNumber) {
    const code = Math.floor(100000 + Math.random() * 900000); // 6ä½æ•°å­—
    
    // ä¿å­˜éªŒè¯ç ï¼ˆ5åˆ†é’Ÿè¿‡æœŸï¼‰
    await redis.setex(`sms:${phoneNumber}`, 300, code);
    
    // å‘é€çŸ­ä¿¡
    await smsService.send(phoneNumber, `éªŒè¯ç ï¼š${code}ï¼Œ5åˆ†é’Ÿå†…æœ‰æ•ˆ`);
    
    return { success: true };
}

// éªŒè¯çŸ­ä¿¡éªŒè¯ç 
async function verifySMSCode(phoneNumber, code) {
    const savedCode = await redis.get(`sms:${phoneNumber}`);
    
    if (!savedCode || savedCode !== code) {
        return { valid: false, message: 'éªŒè¯ç é”™è¯¯æˆ–å·²è¿‡æœŸ' };
    }
    
    // éªŒè¯æˆåŠŸååˆ é™¤éªŒè¯ç 
    await redis.del(`sms:${phoneNumber}`);
    
    return { valid: true };
}
```

### 3.3 ç™»å½•é¢‘ç‡é™åˆ¶


**ğŸ”¸ ä¸ºä»€ä¹ˆè¦é™åˆ¶ç™»å½•é¢‘ç‡ï¼Ÿ**
ç®€å•è¯´ï¼šé˜²æ­¢åäººç”¨ç¨‹åºç–¯ç‹‚å°è¯•å¯†ç ï¼ˆæš´åŠ›ç ´è§£ï¼‰

```
æš´åŠ›ç ´è§£æ”»å‡»ï¼š
åäººç¨‹åºæ¯ç§’å°è¯•1000æ¬¡å¯†ç ï¼š
password123 âŒ
password456 âŒ  
password789 âŒ
123456      âŒ
...
admin123    âœ… ç ´è§£æˆåŠŸï¼

é˜²æŠ¤æªæ–½ï¼š
é™åˆ¶æ¯åˆ†é’Ÿæœ€å¤šå°è¯•5æ¬¡ï¼Œè¶…è¿‡å°±é”å®šè´¦æˆ·
```

**ğŸ”¸ é¢‘ç‡é™åˆ¶ç­–ç•¥**
```
æ¸è¿›å¼é™åˆ¶ï¼š
ç¬¬1æ¬¡å¤±è´¥ï¼šæ­£å¸¸
ç¬¬2æ¬¡å¤±è´¥ï¼šæ­£å¸¸  
ç¬¬3æ¬¡å¤±è´¥ï¼šç­‰å¾…30ç§’
ç¬¬4æ¬¡å¤±è´¥ï¼šç­‰å¾…5åˆ†é’Ÿ
ç¬¬5æ¬¡å¤±è´¥ï¼šé”å®š1å°æ—¶
```

**ğŸ’» é¢‘ç‡é™åˆ¶å®ç°**
```javascript
// ç™»å½•é¢‘ç‡é™åˆ¶
async function checkLoginLimit(username, ip) {
    const userKey = `login_fail:user:${username}`;
    const ipKey = `login_fail:ip:${ip}`;
    
    // æ£€æŸ¥ç”¨æˆ·å¤±è´¥æ¬¡æ•°
    const userFails = await redis.get(userKey) || 0;
    const ipFails = await redis.get(ipKey) || 0;
    
    if (userFails >= 5) {
        return {
            allowed: false,
            message: 'è´¦æˆ·å·²é”å®š1å°æ—¶',
            waitTime: await redis.ttl(userKey)
        };
    }
    
    if (ipFails >= 20) {
        return {
            allowed: false, 
            message: 'IPå·²è¢«é™åˆ¶',
            waitTime: await redis.ttl(ipKey)
        };
    }
    
    return { allowed: true };
}

// ç™»å½•å¤±è´¥å¤„ç†
async function handleLoginFail(username, ip) {
    const userKey = `login_fail:user:${username}`;
    const ipKey = `login_fail:ip:${ip}`;
    
    // å¢åŠ å¤±è´¥è®¡æ•°
    await redis.incr(userKey);
    await redis.incr(ipKey);
    
    // è®¾ç½®è¿‡æœŸæ—¶é—´
    await redis.expire(userKey, 3600); // 1å°æ—¶
    await redis.expire(ipKey, 3600);
}
```

---

## 4. ğŸ” å¤šå› å­è®¤è¯è¯¦è§£


### 4.1 MFAåŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯å¤šå› å­è®¤è¯ï¼ˆMFAï¼‰ï¼Ÿ**
é€šä¿—è§£é‡Šï¼šç”¨å¤šç§æ–¹å¼è¯æ˜ä½ çš„èº«ä»½ï¼Œå°±åƒè¿›é“¶è¡Œé‡‘åº“éœ€è¦å¤šæŠŠé’¥åŒ™

```
ä¸‰ç§è®¤è¯å› å­ï¼š
ğŸ§  ä½ çŸ¥é“çš„ï¼ˆKnowledgeï¼‰ï¼šå¯†ç ã€PINç 
ğŸ¤ ä½ æ‹¥æœ‰çš„ï¼ˆPossessionï¼‰ï¼šæ‰‹æœºã€ç¡¬ä»¶Token
ğŸ‘¤ ä½ æœ¬èº«çš„ï¼ˆInherenceï¼‰ï¼šæŒ‡çº¹ã€äººè„¸ã€è™¹è†œ

å•å› å­ï¼šåªç”¨å¯†ç               â†’ å®‰å…¨æ€§ï¼šâ­â­â˜†â˜†â˜†
åŒå› å­ï¼šå¯†ç +æ‰‹æœºéªŒè¯ç         â†’ å®‰å…¨æ€§ï¼šâ­â­â­â­â˜†  
ä¸‰å› å­ï¼šå¯†ç +æ‰‹æœº+æŒ‡çº¹è¯†åˆ«    â†’ å®‰å…¨æ€§ï¼šâ­â­â­â­â­
```

### 4.2 TOTPæ—¶é—´ç è®¤è¯


**ğŸ”¸ TOTPæ˜¯ä»€ä¹ˆï¼Ÿ**
ç®€å•è¯´ï¼šæ‰‹æœºAPPæ¯30ç§’ç”Ÿæˆä¸€ä¸ªæ–°çš„6ä½æ•°å¯†ç 

```
TOTPå·¥ä½œåŸç†ï¼š
1. ç”¨æˆ·æ‰«æäºŒç»´ç ï¼Œæ‰‹æœºAPPè·å¾—å¯†é’¥
2. APPæ ¹æ®å½“å‰æ—¶é—´+å¯†é’¥è®¡ç®—å‡º6ä½æ•°å­—
3. æ¯30ç§’æ•°å­—è‡ªåŠ¨å˜åŒ–
4. æœåŠ¡å™¨ç”¨ç›¸åŒç®—æ³•éªŒè¯æ•°å­—æ˜¯å¦æ­£ç¡®

ä¼˜ç‚¹ï¼šæ— éœ€ç½‘ç»œï¼Œç¦»çº¿ä¹Ÿèƒ½ç”¨
```

**ğŸ’» TOTPå®ç°ç¤ºä¾‹**
```javascript
const speakeasy = require('speakeasy');

// ç”Ÿæˆç”¨æˆ·ä¸“å±å¯†é’¥
function setupTOTP(username) {
    const secret = speakeasy.generateSecret({
        name: `MyApp (${username})`,
        length: 32
    });
    
    return {
        secret: secret.base32,
        qrcode: secret.otpauth_url // äºŒç»´ç é“¾æ¥
    };
}

// éªŒè¯TOTPç 
function verifyTOTP(token, secret) {
    return speakeasy.totp.verify({
        secret: secret,
        encoding: 'base32',
        token: token,
        window: 1 // å…è®¸å‰å30ç§’è¯¯å·®
    });
}

// ç™»å½•æ—¶éªŒè¯
app.post('/verify-totp', (req, res) => {
    const { username, totpCode } = req.body;
    const userSecret = getUserTOTPSecret(username);
    
    if (verifyTOTP(totpCode, userSecret)) {
        res.json({ success: true });
    } else {
        res.json({ success: false, message: 'TOTPç é”™è¯¯' });
    }
});
```

### 4.3 ç”Ÿç‰©è¯†åˆ«è®¤è¯


**ğŸ”¸ ç”Ÿç‰©è¯†åˆ«çš„ä¼˜åŠ¿**
```
ä¼ ç»Ÿè®¤è¯é—®é¢˜ï¼š
å¯†ç  â†’ å¯èƒ½è¢«å·çœ‹ã€çŒœåˆ°ã€ç ´è§£
æ‰‹æœº â†’ å¯èƒ½è¢«å·ã€ä¸¢å¤±
å¡ç‰‡ â†’ å¯èƒ½è¢«å¤åˆ¶ã€ä¼ªé€ 

ç”Ÿç‰©è¯†åˆ«ä¼˜åŠ¿ï¼š
æŒ‡çº¹ â†’ æ¯ä¸ªäººç‹¬ä¸€æ— äºŒï¼Œæ— æ³•ä¼ªé€ 
äººè„¸ â†’ æ´»ä½“æ£€æµ‹ï¼Œç…§ç‰‡æ— æ³•æ¬ºéª—  
å£°éŸ³ â†’ å£°çº¹è¯†åˆ«ï¼Œå½•éŸ³ä¹Ÿèƒ½è¯†åˆ«
```

**ğŸ”¸ ç”Ÿç‰©è¯†åˆ«ç±»å‹**
```
ğŸ‘† æŒ‡çº¹è¯†åˆ«
â€¢ ä¼˜ç‚¹ï¼šé€Ÿåº¦å¿«ï¼Œè®¾å¤‡ä¾¿å®œ
â€¢ ç¼ºç‚¹ï¼šæ‰‹æŒ‡å—ä¼¤æ—¶æ— æ³•ä½¿ç”¨

ğŸ‘¤ äººè„¸è¯†åˆ«  
â€¢ ä¼˜ç‚¹ï¼šæ— æ¥è§¦ï¼Œç”¨æˆ·ä½“éªŒå¥½
â€¢ ç¼ºç‚¹ï¼šå…‰çº¿ã€è§’åº¦å½±å“å‡†ç¡®ç‡

ğŸ‘ï¸ è™¹è†œè¯†åˆ«
â€¢ ä¼˜ç‚¹ï¼šå‡†ç¡®ç‡æé«˜ï¼Œå¾ˆéš¾ä¼ªé€ 
â€¢ ç¼ºç‚¹ï¼šè®¾å¤‡æ˜‚è´µï¼Œç”¨æˆ·æ¥å—åº¦ä½

ğŸ—£ï¸ å£°çº¹è¯†åˆ«
â€¢ ä¼˜ç‚¹ï¼šå¯è¿œç¨‹ä½¿ç”¨ï¼Œè‡ªç„¶æ–¹ä¾¿
â€¢ ç¼ºç‚¹ï¼šç¯å¢ƒå™ªéŸ³å½±å“ï¼Œæ„Ÿå†’æ—¶å˜åŒ–
```

---

## 5. ğŸŒ è®¾å¤‡ä¸IPé£æ§


### 5.1 è®¾å¤‡ç®¡ç†ç­–ç•¥


**ğŸ”¸ ä»€ä¹ˆæ˜¯è®¾å¤‡ç®¡ç†ï¼Ÿ**
ç®€å•è¯´ï¼šè®°ä½ç”¨æˆ·å¸¸ç”¨çš„è®¾å¤‡ï¼Œé™Œç”Ÿè®¾å¤‡éœ€è¦é¢å¤–éªŒè¯

```
è®¾å¤‡ç®¡ç†æµç¨‹ï¼š
1. ç”¨æˆ·é¦–æ¬¡ç™»å½•æ–°è®¾å¤‡
2. ç³»ç»Ÿè®°å½•è®¾å¤‡æŒ‡çº¹ä¿¡æ¯  
3. å‘é€éªŒè¯é‚®ä»¶/çŸ­ä¿¡ç¡®è®¤
4. ç”¨æˆ·ç¡®è®¤åï¼Œè®¾å¤‡è¢«æ ‡è®°ä¸ºå¯ä¿¡
5. ä¸‹æ¬¡åœ¨æ­¤è®¾å¤‡ç™»å½•æ— éœ€é¢å¤–éªŒè¯

è®¾å¤‡æŒ‡çº¹åŒ…æ‹¬ï¼š
â€¢ æµè§ˆå™¨ç±»å‹å’Œç‰ˆæœ¬
â€¢ æ“ä½œç³»ç»Ÿä¿¡æ¯
â€¢ å±å¹•åˆ†è¾¨ç‡  
â€¢ æ—¶åŒºè®¾ç½®
â€¢ å·²å®‰è£…æ’ä»¶åˆ—è¡¨
```

**ğŸ’» è®¾å¤‡æŒ‡çº¹æ”¶é›†**
```javascript
// å‰ç«¯æ”¶é›†è®¾å¤‡ä¿¡æ¯
function generateDeviceFingerprint() {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    ctx.textBaseline = 'top';
    ctx.font = '14px Arial';
    ctx.fillText('Device fingerprint', 2, 2);
    
    const fingerprint = {
        userAgent: navigator.userAgent,
        language: navigator.language,
        platform: navigator.platform,
        screenResolution: `${screen.width}x${screen.height}`,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        canvasFingerprint: canvas.toDataURL(),
        plugins: Array.from(navigator.plugins).map(p => p.name)
    };
    
    return btoa(JSON.stringify(fingerprint));
}

// åç«¯éªŒè¯è®¾å¤‡
async function checkDeviceReputiation(userId, deviceId) {
    const device = await db.findDevice(userId, deviceId);
    
    if (!device) {
        // æ–°è®¾å¤‡ï¼Œéœ€è¦éªŒè¯
        return { 
            trusted: false, 
            action: 'verify_device' 
        };
    }
    
    if (device.lastSeen < Date.now() - 90 * 24 * 3600 * 1000) {
        // è®¾å¤‡è¶…è¿‡90å¤©æœªä½¿ç”¨ï¼Œé‡æ–°éªŒè¯
        return { 
            trusted: false, 
            action: 'reverify_device' 
        };
    }
    
    return { trusted: true };
}
```

### 5.2 IPé£æ§ç­–ç•¥


**ğŸ”¸ ä»€ä¹ˆæ˜¯IPé£æ§ï¼Ÿ**
ç®€å•è¯´ï¼šæ ¹æ®ç”¨æˆ·çš„ç™»å½•ä½ç½®åˆ¤æ–­æ˜¯å¦æœ‰é£é™©

```
IPé£é™©è¯„ä¼°ï¼š
ğŸŸ¢ ä½é£é™©ï¼šå¸¸ç”¨IPåœ°å€ï¼Œæœ¬åœ°ç™»å½•
ğŸŸ¡ ä¸­é£é™©ï¼šæ–°çš„IPåœ°å€ï¼Œä½†åœ¨åŒåŸ
ğŸ”´ é«˜é£é™©ï¼šå¼‚å›½IPåœ°å€ï¼Œå‡Œæ™¨ç™»å½•

é£æ§æªæ–½ï¼š
ä½é£é™© â†’ æ­£å¸¸ç™»å½•
ä¸­é£é™© â†’ çŸ­ä¿¡éªŒè¯ç ç¡®è®¤
é«˜é£é™© â†’ å¤šé‡éªŒè¯ + äººå·¥å®¡æ ¸
```

**ğŸ”¸ å¼‚åœ°ç™»å½•æ£€æµ‹**
```
æ£€æµ‹é€»è¾‘ï¼š
1. è®°å½•ç”¨æˆ·ä¸Šæ¬¡ç™»å½•çš„IPåœ°å€å’Œæ—¶é—´
2. è®¡ç®—ä¸¤æ¬¡ç™»å½•é—´çš„åœ°ç†è·ç¦»
3. è®¡ç®—æ—¶é—´é—´éš”
4. åˆ¤æ–­æ˜¯å¦å­˜åœ¨"ç¬é—´ç§»åŠ¨"

ä¾‹å­ï¼š
ä¸Šæ¬¡ç™»å½•ï¼šåŒ—äº¬ï¼Œ10:00
è¿™æ¬¡ç™»å½•ï¼šä¸Šæµ·ï¼Œ10:30
è·ç¦»ï¼šçº¦1200å…¬é‡Œ
æ—¶é—´ï¼š30åˆ†é’Ÿ
ç»“è®ºï¼š30åˆ†é’Ÿå†…ä»åŒ—äº¬åˆ°ä¸Šæµ·ä¸å¯èƒ½ï¼Œå¯èƒ½è´¦å·è¢«ç›—
```

**ğŸ’» IPé£æ§å®ç°**
```javascript
// IPåœ°å€é£é™©è¯„ä¼°
async function assessIPRisk(userId, currentIP) {
    // è·å–ç”¨æˆ·å†å²ç™»å½•è®°å½•
    const loginHistory = await db.getUserLoginHistory(userId, 30); // 30å¤©å†…
    
    // è·å–IPåœ°ç†ä½ç½®
    const currentLocation = await getIPGeolocation(currentIP);
    
    if (loginHistory.length === 0) {
        return { risk: 'medium', reason: 'é¦–æ¬¡ç™»å½•' };
    }
    
    const lastLogin = loginHistory[0];
    const lastLocation = await getIPGeolocation(lastLogin.ip);
    
    // è®¡ç®—åœ°ç†è·ç¦»
    const distance = calculateDistance(currentLocation, lastLocation);
    const timeDiff = Date.now() - lastLogin.timestamp;
    
    // å¼‚åœ°ç™»å½•æ£€æµ‹
    if (distance > 100 && timeDiff < 2 * 3600 * 1000) { // 2å°æ—¶å†…è·¨åŸ
        return { 
            risk: 'high', 
            reason: 'å¼‚åœ°ç™»å½•', 
            distance: distance,
            locations: [lastLocation.city, currentLocation.city]
        };
    }
    
    // æ£€æŸ¥IPæ˜¯å¦åœ¨é»‘åå•
    const isBlacklisted = await checkIPBlacklist(currentIP);
    if (isBlacklisted) {
        return { risk: 'high', reason: 'IPåœ¨é»‘åå•ä¸­' };
    }
    
    // æ£€æŸ¥æ˜¯å¦ä¸ºå¸¸ç”¨IP
    const isFrequentIP = loginHistory.some(log => log.ip === currentIP);
    if (isFrequentIP) {
        return { risk: 'low', reason: 'å¸¸ç”¨IP' };
    }
    
    return { risk: 'medium', reason: 'æ–°IPåœ°å€' };
}
```

---

## 6. ğŸ“Š æ—¥å¿—å®¡è®¡ä¸ç›‘æ§


### 6.1 å®¡è®¡æ—¥å¿—çš„é‡è¦æ€§


**ğŸ”¸ ä¸ºä»€ä¹ˆéœ€è¦å®¡è®¡æ—¥å¿—ï¼Ÿ**
ç®€å•è¯´ï¼šå°±åƒå•†åº—çš„ç›‘æ§å½•åƒï¼Œè®°å½•è°åœ¨ä»€ä¹ˆæ—¶å€™åšäº†ä»€ä¹ˆäº‹

```
å®¡è®¡æ—¥å¿—çš„ä½œç”¨ï¼š
ğŸ” äº‹åè°ƒæŸ¥ï¼šå‡ºé—®é¢˜æ—¶èƒ½è¿½æº¯åŸå› 
âš–ï¸ æ³•å¾‹è¯æ®ï¼šè¯æ˜åˆè§„æ“ä½œ  
ğŸ›¡ï¸ å®‰å…¨åˆ†æï¼šå‘ç°æ”»å‡»æ¨¡å¼
ğŸ“Š è¡Œä¸ºåˆ†æï¼šäº†è§£ç”¨æˆ·ä½¿ç”¨ä¹ æƒ¯
ğŸš¨ å®æ—¶å‘Šè­¦ï¼šå¼‚å¸¸è¡Œä¸ºç«‹å³é€šçŸ¥
```

**ğŸ”¸ éœ€è¦è®°å½•çš„å…³é”®äº‹ä»¶**
```
ç”¨æˆ·è¡Œä¸ºï¼š
âœ… ç™»å½•æˆåŠŸ/å¤±è´¥
âœ… å¯†ç ä¿®æ”¹
âœ… æƒé™å˜æ›´
âœ… æ•æ„Ÿæ•°æ®è®¿é—®
âœ… æ–‡ä»¶ä¸Šä¼ /ä¸‹è½½
âœ… è´¦æˆ·é”å®š/è§£é”

ç³»ç»Ÿäº‹ä»¶ï¼š
âš™ï¸ æœåŠ¡å¯åŠ¨/åœæ­¢  
âš™ï¸ é…ç½®æ–‡ä»¶ä¿®æ”¹
âš™ï¸ æ•°æ®åº“è¿æ¥å¼‚å¸¸
âš™ï¸ ç£ç›˜ç©ºé—´ä¸è¶³
âš™ï¸ ç½‘ç»œè¿æ¥ä¸­æ–­
```

**ğŸ’» æ—¥å¿—è®°å½•å®ç°**
```javascript
// å®¡è®¡æ—¥å¿—è®°å½•å™¨
class AuditLogger {
    static async log(event) {
        const logEntry = {
            timestamp: new Date().toISOString(),
            eventType: event.type,
            userId: event.userId,
            userIP: event.ip,
            userAgent: event.userAgent,
            action: event.action,
            resource: event.resource,
            result: event.result,
            details: event.details,
            sessionId: event.sessionId
        };
        
        // å†™å…¥æ•°æ®åº“
        await db.auditLogs.insert(logEntry);
        
        // å…³é”®äº‹ä»¶ç«‹å³å‘Šè­¦
        if (this.isCriticalEvent(event)) {
            await this.sendAlert(logEntry);
        }
    }
    
    static isCriticalEvent(event) {
        const criticalEvents = [
            'LOGIN_FAILURE_MULTIPLE',
            'ADMIN_LOGIN',
            'PASSWORD_CHANGE',
            'PERMISSION_ESCALATION'
        ];
        
        return criticalEvents.includes(event.type);
    }
}

// ä½¿ç”¨ç¤ºä¾‹
app.post('/login', async (req, res) => {
    const loginResult = await authenticateUser(req.body);
    
    // è®°å½•ç™»å½•äº‹ä»¶
    await AuditLogger.log({
        type: loginResult.success ? 'LOGIN_SUCCESS' : 'LOGIN_FAILURE',
        userId: req.body.username,
        ip: req.ip,
        userAgent: req.headers['user-agent'],
        action: 'user_login',
        result: loginResult.success ? 'success' : 'failure',
        details: loginResult.message
    });
    
    res.json(loginResult);
});
```

### 6.2 ç™»å½•è¡Œä¸ºåˆ†æ


**ğŸ”¸ ä»€ä¹ˆæ˜¯è¡Œä¸ºåˆ†æï¼Ÿ**
ç®€å•è¯´ï¼šé€šè¿‡åˆ†æç”¨æˆ·çš„è¡Œä¸ºæ¨¡å¼ï¼Œå‘ç°å¯ç–‘æ´»åŠ¨

```
æ­£å¸¸ç”¨æˆ·è¡Œä¸ºæ¨¡å¼ï¼š
ğŸ‘¤ ç”¨æˆ·å¼ ä¸‰ï¼š
â€¢ å·¥ä½œæ—¥ 9:00-18:00 ç™»å½•
â€¢ å¸¸ç”¨IPï¼šå…¬å¸ç½‘ç»œ + å®¶åº­ç½‘ç»œ  
â€¢ å¸¸ç”¨è®¾å¤‡ï¼šåŠå…¬ç”µè„‘ + ä¸ªäººæ‰‹æœº
â€¢ è®¿é—®å†…å®¹ï¼šä¸»è¦æ˜¯å·¥ä½œç›¸å…³æ¨¡å—

å¼‚å¸¸è¡Œä¸ºæ¨¡å¼ï¼š
ğŸš¨ å¯ç–‘æ´»åŠ¨ï¼š
â€¢ å‡Œæ™¨3ç‚¹ç™»å½•ï¼ˆå¹³æ—¶ä»ä¸å¤œé—´ä½¿ç”¨ï¼‰
â€¢ æ¥è‡ªé™Œç”Ÿå›½å®¶çš„IP
â€¢ çŸ­æ—¶é—´å†…å¤§é‡ä¸‹è½½æ–‡ä»¶
â€¢ è®¿é—®å¹³æ—¶ä¸ç”¨çš„æ•æ„ŸåŠŸèƒ½
```

**ğŸ’» è¡Œä¸ºåˆ†æå®ç°**
```javascript
// ç”¨æˆ·è¡Œä¸ºåˆ†æ
class BehaviorAnalyzer {
    // åˆ†æç™»å½•æ—¶é—´å¼‚å¸¸
    static async analyzeLoginTime(userId, loginTime) {
        const history = await db.getLoginHistory(userId, 90); // 90å¤©å†å²
        
        if (history.length < 10) {
            return { risk: 'low', reason: 'æ•°æ®ä¸è¶³' };
        }
        
        // è®¡ç®—ç”¨æˆ·å¸¸ç”¨ç™»å½•æ—¶é—´æ®µ
        const hours = history.map(log => new Date(log.timestamp).getHours());
        const usualHours = this.findCommonHours(hours);
        
        const currentHour = new Date(loginTime).getHours();
        
        if (!usualHours.includes(currentHour)) {
            return { 
                risk: 'medium', 
                reason: 'éå¸¸ç”¨æ—¶é—´æ®µç™»å½•',
                usualHours: usualHours,
                currentHour: currentHour
            };
        }
        
        return { risk: 'low' };
    }
    
    // åˆ†æè®¿é—®æ¨¡å¼å¼‚å¸¸
    static async analyzeAccessPattern(userId, accessLog) {
        const userProfile = await db.getUserProfile(userId);
        const recentAccess = await db.getRecentAccess(userId, 7); // 7å¤©å†…è®¿é—®è®°å½•
        
        // æ£€æŸ¥æ˜¯å¦è®¿é—®äº†æ–°çš„æ•æ„Ÿæ¨¡å—
        const sensitiveModules = ['admin', 'finance', 'hr'];
        const accessedSensitive = accessLog.filter(log => 
            sensitiveModules.some(module => log.resource.includes(module))
        );
        
        if (accessedSensitive.length > 0 && !userProfile.hasSensitiveAccess) {
            return {
                risk: 'high',
                reason: 'è®¿é—®æ•æ„Ÿæ¨¡å—',
                modules: accessedSensitive.map(log => log.resource)
            };
        }
        
        // æ£€æŸ¥è®¿é—®é¢‘ç‡å¼‚å¸¸
        if (accessLog.length > userProfile.avgDailyAccess * 3) {
            return {
                risk: 'medium', 
                reason: 'è®¿é—®é¢‘ç‡å¼‚å¸¸é«˜',
                current: accessLog.length,
                average: userProfile.avgDailyAccess
            };
        }
        
        return { risk: 'low' };
    }
}
```

---

## 7. ğŸ« Tokenå®‰å…¨ç®¡ç†


### 7.1 Tokenæ³„éœ²é£é™©


**ğŸ”¸ Tokenæ˜¯ä»€ä¹ˆï¼Ÿ**
ç®€å•è¯´ï¼šå°±åƒä½ çš„ä¸´æ—¶é€šè¡Œè¯ï¼Œè¯æ˜ä½ å·²ç»ç™»å½•è¿‡äº†

```
Tokençš„ä½œç”¨ï¼š
ğŸ« èº«ä»½å‡­è¯ï¼šè¯æ˜ä½ æ˜¯è°
â° æ—¶æ•ˆæ€§ï¼šæœ‰è¿‡æœŸæ—¶é—´ï¼Œä¸æ˜¯æ°¸ä¹…æœ‰æ•ˆ
ğŸ” æƒé™è½½ä½“ï¼šåŒ…å«ä½ èƒ½åšä»€ä¹ˆçš„ä¿¡æ¯
ğŸ”„ å¯æ’¤é”€ï¼šæœåŠ¡å™¨å¯ä»¥è®©Tokenå¤±æ•ˆ
```

**ğŸ”¸ Tokenæ³„éœ²çš„å±å®³**
```
æ³„éœ²é€”å¾„ï¼š
ğŸ’» XSSæ”»å‡»ï¼šæ¶æ„è„šæœ¬å·å–Token
ğŸ“± ç§»åŠ¨åº”ç”¨ï¼šåç¼–è¯‘è·å–Token  
ğŸŒ ç½‘ç»œä¼ è¾“ï¼šHTTPæ˜æ–‡ä¼ è¾“è¢«æˆªè·
ğŸ’¾ æ—¥å¿—æ–‡ä»¶ï¼šTokenè¢«å†™å…¥æ—¥å¿—
ğŸ‘¥ å†…éƒ¨äººå‘˜ï¼šå‘˜å·¥æ¶æ„è·å–

å±å®³åæœï¼š
ğŸš¨ èº«ä»½å†’å……ï¼šæ”»å‡»è€…å¯ä»¥å†’å……ç”¨æˆ·
ğŸ”“ æ•°æ®æ³„éœ²ï¼šè®¿é—®ç”¨æˆ·çš„ç§å¯†ä¿¡æ¯  
ğŸ’¸ èµ„äº§æŸå¤±ï¼šè¿›è¡Œæ¶æ„æ“ä½œï¼ˆè½¬è´¦ç­‰ï¼‰
ğŸ¢ å£°èª‰æŸå¤±ï¼šç”¨æˆ·ä¿¡ä»»åº¦ä¸‹é™
```

### 7.2 Tokené»‘åå•æœºåˆ¶


**ğŸ”¸ ä»€ä¹ˆæ˜¯Tokené»‘åå•ï¼Ÿ**
ç®€å•è¯´ï¼šæŠŠå·²ç»ä½œåºŸçš„Tokenè®°å½•ä¸‹æ¥ï¼Œæ‹’ç»å…¶è®¿é—®

```
é»‘åå•ä½¿ç”¨åœºæ™¯ï¼š
ğŸ”’ ç”¨æˆ·ä¸»åŠ¨ç™»å‡ºï¼šæŠŠTokenåŠ å…¥é»‘åå•
ğŸ“± è®¾å¤‡ä¸¢å¤±ï¼šæŠŠè¯¥è®¾å¤‡çš„æ‰€æœ‰TokenåŠ å…¥é»‘åå•
ğŸš¨ å®‰å…¨äº‹ä»¶ï¼šæŠŠå¯ç–‘TokenåŠ å…¥é»‘åå•
â° Tokenåˆ·æ–°ï¼šæŠŠæ—§TokenåŠ å…¥é»‘åå•
```

**ğŸ’» é»‘åå•å®ç°**
```javascript
// Tokené»‘åå•ç®¡ç†
class TokenBlacklist {
    // æ·»åŠ Tokenåˆ°é»‘åå•
    static async addToBlacklist(token, reason, expiry) {
        const tokenHash = crypto.createHash('sha256').update(token).digest('hex');
        
        await redis.setex(
            `blacklist:${tokenHash}`, 
            expiry, // è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
            JSON.stringify({
                reason: reason,
                addedAt: new Date().toISOString(),
                originalExpiry: expiry
            })
        );
    }
    
    // æ£€æŸ¥Tokenæ˜¯å¦åœ¨é»‘åå•
    static async isBlacklisted(token) {
        const tokenHash = crypto.createHash('sha256').update(token).digest('hex');
        const result = await redis.get(`blacklist:${tokenHash}`);
        
        if (result) {
            const info = JSON.parse(result);
            return {
                blacklisted: true,
                reason: info.reason,
                addedAt: info.addedAt
            };
        }
        
        return { blacklisted: false };
    }
    
    // æ¸…ç†è¿‡æœŸçš„é»‘åå•è®°å½•ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰
    static async cleanupExpired() {
        // Redisä¼šè‡ªåŠ¨åˆ é™¤è¿‡æœŸé”®ï¼Œæ— éœ€æ‰‹åŠ¨æ¸…ç†
        // è¿™é‡Œå¯ä»¥æ·»åŠ ç»Ÿè®¡ä¿¡æ¯è®°å½•
        const count = await redis.eval(`
            return #redis.call('keys', 'blacklist:*')
        `, 0);
        
        console.log(`å½“å‰é»‘åå•Tokenæ•°é‡: ${count}`);
    }
}

// JWTéªŒè¯ä¸­é—´ä»¶
async function validateToken(req, res, next) {
    const token = req.headers.authorization?.replace('Bearer ', '');
    
    if (!token) {
        return res.status(401).json({ error: 'ç¼ºå°‘Token' });
    }
    
    // æ£€æŸ¥æ˜¯å¦åœ¨é»‘åå•
    const blacklistCheck = await TokenBlacklist.isBlacklisted(token);
    if (blacklistCheck.blacklisted) {
        return res.status(401).json({ 
            error: 'Tokenå·²å¤±æ•ˆ',
            reason: blacklistCheck.reason 
        });
    }
    
    try {
        const decoded = jwt.verify(token, SECRET_KEY);
        req.user = decoded;
        next();
    } catch (error) {
        return res.status(401).json({ error: 'Tokenæ— æ•ˆ' });
    }
}
```

### 7.3 IPç»‘å®šç­–ç•¥


**ğŸ”¸ ä»€ä¹ˆæ˜¯Token IPç»‘å®šï¼Ÿ**
ç®€å•è¯´ï¼šTokenåªèƒ½åœ¨ç‰¹å®šIPåœ°å€ä½¿ç”¨ï¼Œé˜²æ­¢è¢«ç›—ç”¨

```
IPç»‘å®šåŸç†ï¼š
1. ç”¨æˆ·ç™»å½•æ—¶ï¼Œè®°å½•IPåœ°å€
2. å°†IPåœ°å€å†™å…¥Tokenæˆ–å…³è”å­˜å‚¨  
3. æ¯æ¬¡ä½¿ç”¨Tokenæ—¶éªŒè¯IPæ˜¯å¦åŒ¹é…
4. IPä¸åŒ¹é…åˆ™æ‹’ç»è®¿é—®

é€‚ç”¨åœºæ™¯ï¼š
âœ… ä¼ä¸šå†…ç½‘ï¼šIPåœ°å€ç›¸å¯¹å›ºå®š
âœ… é«˜å®‰å…¨è¦æ±‚ï¼šé“¶è¡Œã€æ”¿åºœç³»ç»Ÿ
âŒ ç§»åŠ¨ç”¨æˆ·ï¼šIPåœ°å€ç»å¸¸å˜åŒ–
âŒ CDNåŠ é€Ÿï¼šIPåœ°å€ä¼šè¢«ä»£ç†
```

**ğŸ’» IPç»‘å®šå®ç°**
```javascript
// Tokenç”Ÿæˆæ—¶ç»‘å®šIP
function generateTokenWithIP(user, clientIP) {
    const payload = {
        userId: user.id,
        username: user.username,
        permissions: user.permissions,
        boundIP: clientIP, // ç»‘å®šIPåœ°å€
        iat: Math.floor(Date.now() / 1000),
        exp: Math.floor(Date.now() / 1000) + 3600 // 1å°æ—¶è¿‡æœŸ
    };
    
    return jwt.sign(payload, SECRET_KEY);
}

// TokenéªŒè¯æ—¶æ£€æŸ¥IP
function validateTokenWithIP(req, res, next) {
    const token = req.headers.authorization?.replace('Bearer ', '');
    const clientIP = req.ip;
    
    try {
        const decoded = jwt.verify(token, SECRET_KEY);
        
        // æ£€æŸ¥IPç»‘å®š
        if (decoded.boundIP && decoded.boundIP !== clientIP) {
            return res.status(401).json({
                error: 'IPåœ°å€ä¸åŒ¹é…',
                boundIP: decoded.boundIP,
                currentIP: clientIP
            });
        }
        
        req.user = decoded;
        next();
    } catch (error) {
        return res.status(401).json({ error: 'Tokenæ— æ•ˆ' });
    }
}

// çµæ´»çš„IPéªŒè¯ç­–ç•¥
class IPValidator {
    // æ£€æŸ¥IPæ˜¯å¦åœ¨å…è®¸èŒƒå›´å†…
    static isIPAllowed(boundIP, currentIP) {
        // å®Œå…¨åŒ¹é…
        if (boundIP === currentIP) {
            return true;
        }
        
        // åŒä¸€å­ç½‘æ£€æŸ¥ï¼ˆä¼ä¸šå†…ç½‘åœºæ™¯ï¼‰
        if (this.isSameSubnet(boundIP, currentIP, 24)) {
            return true;
        }
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºå·²çŸ¥çš„ä»£ç†æœåŠ¡å™¨
        if (this.isTrustedProxy(currentIP)) {
            return true;
        }
        
        return false;
    }
    
    // æ£€æŸ¥æ˜¯å¦åœ¨åŒä¸€å­ç½‘
    static isSameSubnet(ip1, ip2, prefixLength) {
        // ç®€åŒ–å®ç°ï¼Œå®é™…åº”ä½¿ç”¨ä¸“ä¸šçš„IPå¤„ç†åº“
        const mask = (0xFFFFFFFF << (32 - prefixLength)) >>> 0;
        const addr1 = this.ipToInt(ip1) & mask;
        const addr2 = this.ipToInt(ip2) & mask;
        return addr1 === addr2;
    }
}
```

---

## 8. ğŸ”¨ æš´åŠ›ç ´è§£é˜²æŠ¤


### 8.1 æš´åŠ›ç ´è§£æ”»å‡»åŸç†


**ğŸ”¸ ä»€ä¹ˆæ˜¯æš´åŠ›ç ´è§£ï¼Ÿ**
é€šä¿—è§£é‡Šï¼šå°±åƒå°å·ç”¨å„ç§é’¥åŒ™å°è¯•å¼€é”ï¼Œç¨‹åºç”¨å„ç§å¯†ç å°è¯•ç™»å½•

```
æš´åŠ›ç ´è§£æ”»å‡»è¿‡ç¨‹ï¼š
ğŸ¤– æ”»å‡»ç¨‹åºè‡ªåŠ¨è¿è¡Œ
ğŸ“ å‡†å¤‡å¸¸ç”¨å¯†ç å­—å…¸ï¼š
   - 123456
   - password
   - admin123
   - ç”¨æˆ·å§“å+ç”Ÿæ—¥
   - ...

ğŸ”„ å¾ªç¯å°è¯•ï¼š
   ç”¨æˆ·åï¼šadmin, å¯†ç ï¼š123456     âŒ
   ç”¨æˆ·åï¼šadmin, å¯†ç ï¼špassword   âŒ  
   ç”¨æˆ·åï¼šadmin, å¯†ç ï¼šadmin123   âœ… æˆåŠŸï¼

ğŸ’¥ å±å®³ï¼š
   - è´¦æˆ·è¢«ç ´è§£ï¼Œæ•°æ®æ³„éœ²
   - æœåŠ¡å™¨èµ„æºè¢«æ¶ˆè€—
   - æ­£å¸¸ç”¨æˆ·æ— æ³•ä½¿ç”¨
```

**ğŸ”¸ æ”»å‡»ç‰¹å¾è¯†åˆ«**
```
æ­£å¸¸ç”¨æˆ·ç™»å½•ï¼š
â€¢ ç™»å½•é¢‘ç‡ï¼šå¶å°”å¤±è´¥1-2æ¬¡  
â€¢ æ—¶é—´é—´éš”ï¼šäººå·¥æ“ä½œï¼Œé—´éš”ä¸è§„å¾‹
â€¢ æ¥æºIPï¼šç›¸å¯¹å›ºå®š
â€¢ ç”¨æˆ·ä»£ç†ï¼šçœŸå®æµè§ˆå™¨

æš´åŠ›ç ´è§£æ”»å‡»ï¼š
â€¢ ç™»å½•é¢‘ç‡ï¼šå¤§é‡è¿ç»­å¤±è´¥
â€¢ æ—¶é—´é—´éš”ï¼šéå¸¸è§„å¾‹ï¼ˆç¨‹åºåŒ–ï¼‰
â€¢ æ¥æºIPï¼šå¯èƒ½æ¥è‡ªå¤šä¸ªIP
â€¢ ç”¨æˆ·ä»£ç†ï¼šå¯èƒ½æ˜¯è„šæœ¬æˆ–å·¥å…·
```

### 8.2 è´¦æˆ·é”å®šç­–ç•¥


**ğŸ”¸ ä¸ºä»€ä¹ˆè¦é”å®šè´¦æˆ·ï¼Ÿ**
ç®€å•è¯´ï¼šè¿ç»­è¾“é”™å¯†ç è¯´æ˜å¯èƒ½ä¸æ˜¯æœ¬äººï¼Œæš‚æ—¶ç¦æ­¢ç™»å½•

```
é”å®šç­–ç•¥è®¾è®¡ï¼š
ğŸ”¢ å¤±è´¥æ¬¡æ•°é˜ˆå€¼ï¼šè¿ç»­å¤±è´¥5æ¬¡
â° é”å®šæ—¶é—´ï¼šä»5åˆ†é’Ÿåˆ°24å°æ—¶é€’å¢
ğŸ”“ è§£é”æ–¹å¼ï¼šæ—¶é—´è‡ªåŠ¨è§£é” æˆ– ç®¡ç†å‘˜æ‰‹åŠ¨è§£é”
ğŸ“§ é€šçŸ¥æœºåˆ¶ï¼šé‚®ä»¶/çŸ­ä¿¡é€šçŸ¥ç”¨æˆ·

æ¸è¿›é”å®šç¤ºä¾‹ï¼š
ç¬¬1-2æ¬¡å¤±è´¥ï¼šæ­£å¸¸
ç¬¬3æ¬¡å¤±è´¥ï¼šç­‰å¾…30ç§’  
ç¬¬4æ¬¡å¤±è´¥ï¼šç­‰å¾…5åˆ†é’Ÿ
ç¬¬5æ¬¡å¤±è´¥ï¼šé”å®š1å°æ—¶
ç¬¬6æ¬¡å¤±è´¥ï¼šé”å®š24å°æ—¶
```

**ğŸ’» è´¦æˆ·é”å®šå®ç°**
```javascript
// è´¦æˆ·é”å®šç®¡ç†
class AccountLockManager {
    // æ£€æŸ¥è´¦æˆ·æ˜¯å¦è¢«é”å®š
    static async checkLockStatus(username) {
        const lockKey = `account_lock:${username}`;
        const lockInfo = await redis.get(lockKey);
        
        if (!lockInfo) {
            return { locked: false };
        }
        
        const lock = JSON.parse(lockInfo);
        const now = Date.now();
        
        if (now < lock.unlockTime) {
            return {
                locked: true,
                unlockTime: lock.unlockTime,
                reason: lock.reason,
                remainingTime: Math.ceil((lock.unlockTime - now) / 1000)
            };
        }
        
        // é”å®šæ—¶é—´å·²è¿‡ï¼Œè‡ªåŠ¨è§£é”
        await redis.del(lockKey);
        return { locked: false };
    }
    
    // å¤„ç†ç™»å½•å¤±è´¥
    static async handleLoginFailure(username, ip) {
        const failKey = `login_fail:${username}`;
        const lockKey = `account_lock:${username}`;
        
        // å¢åŠ å¤±è´¥è®¡æ•°
        const failCount = await redis.incr(failKey);
        await redis.expire(failKey, 3600); // 1å°æ—¶åé‡ç½®è®¡æ•°
        
        // æ ¹æ®å¤±è´¥æ¬¡æ•°ç¡®å®šé”å®šæ—¶é—´
        const lockDuration = this.calculateLockDuration(failCount);
        
        if (lockDuration > 0) {
            const lockInfo = {
                unlockTime: Date.now() + lockDuration * 1000,
                reason: `è¿ç»­ç™»å½•å¤±è´¥${failCount}æ¬¡`,
                lockedBy: ip,
                lockedAt: new Date().toISOString()
            };
            
            await redis.setex(lockKey, lockDuration, JSON.stringify(lockInfo));
            
            // å‘é€é”å®šé€šçŸ¥
            await this.sendLockNotification(username, lockInfo);
            
            return { locked: true, duration: lockDuration };
        }
        
        return { locked: false, failCount: failCount };
    }
    
    // è®¡ç®—é”å®šæ—¶é—´ï¼ˆç§’ï¼‰
    static calculateLockDuration(failCount) {
        const lockSchedule = {
            3: 30,        // 30ç§’
            4: 300,       // 5åˆ†é’Ÿ  
            5: 3600,      // 1å°æ—¶
            6: 86400      // 24å°æ—¶
        };
        
        return lockSchedule[failCount] || 86400; // é»˜è®¤24å°æ—¶
    }
    
    // å‘é€é”å®šé€šçŸ¥
    static async sendLockNotification(username, lockInfo) {
        const user = await db.users.findByUsername(username);
        if (user && user.email) {
            await emailService.send({
                to: user.email,
                subject: 'è´¦æˆ·å®‰å…¨è­¦å‘Š',
                text: `æ‚¨çš„è´¦æˆ·å› å¤šæ¬¡ç™»å½•å¤±è´¥å·²è¢«é”å®šï¼Œè§£é”æ—¶é—´ï¼š${new Date(lockInfo.unlockTime).toLocaleString()}`
            });
        }
    }
}
```

### 8.3 éªŒè¯ç é˜²æŠ¤å‡çº§


**ğŸ”¸ åŠ¨æ€éªŒè¯ç ç­–ç•¥**
```
åŸºç¡€ç­–ç•¥ï¼šå¤±è´¥3æ¬¡åè¦æ±‚éªŒè¯ç 
å‡çº§ç­–ç•¥ï¼š
â€¢ ç¬¬1æ¬¡å¤±è´¥ï¼šæ­£å¸¸
â€¢ ç¬¬2æ¬¡å¤±è´¥ï¼šç®€å•è®¡ç®—éªŒè¯ç  (2+3=?)
â€¢ ç¬¬3æ¬¡å¤±è´¥ï¼šå›¾ç‰‡éªŒè¯ç  (è¯†åˆ«å­—æ¯æ•°å­—)
â€¢ ç¬¬4æ¬¡å¤±è´¥ï¼šæ‹¼å›¾éªŒè¯ç  (æ‹–åŠ¨æ‹¼å›¾)  
â€¢ ç¬¬5æ¬¡å¤±è´¥ï¼šçŸ­ä¿¡éªŒè¯ç  (æ‰‹æœºéªŒè¯)
```

**ğŸ’» åŠ¨æ€éªŒè¯ç å®ç°**
```javascript
// åŠ¨æ€éªŒè¯ç ç®¡ç†
class DynamicCaptchaManager {
    // æ ¹æ®å¤±è´¥æ¬¡æ•°é€‰æ‹©éªŒè¯ç ç±»å‹
    static async getCaptchaType(username) {
        const failKey = `login_fail:${username}`;
        const failCount = await redis.get(failKey) || 0;
        
        if (failCount < 2) {
            return { type: 'none' };
        } else if (failCount < 3) {
            return { 
                type: 'math',
                challenge: this.generateMathChallenge()
            };
        } else if (failCount < 4) {
            return {
                type: 'image', 
                challenge: this.generateImageChallenge()
            };
        } else {
            return { 
                type: 'sms',
                message: 'éœ€è¦æ‰‹æœºçŸ­ä¿¡éªŒè¯'
            };
        }
    }
    
    // ç”Ÿæˆæ•°å­¦éªŒè¯ç 
    static generateMathChallenge() {
        const a = Math.floor(Math.random() * 10) + 1;
        const b = Math.floor(Math.random() * 10) + 1;
        const operations = ['+', '-', '*'];
        const op = operations[Math.floor(Math.random() * operations.length)];
        
        let answer;
        switch (op) {
            case '+': answer = a + b; break;
            case '-': answer = a - b; break;
            case '*': answer = a * b; break;
        }
        
        return {
            question: `${a} ${op} ${b} = ?`,
            answer: answer.toString()
        };
    }
    
    // éªŒè¯ç éªŒè¯
    static async verifyCaptcha(username, userAnswer, challengeId) {
        const challenge = await redis.get(`captcha:${challengeId}`);
        if (!challenge) {
            return { valid: false, message: 'éªŒè¯ç å·²è¿‡æœŸ' };
        }
        
        const challengeData = JSON.parse(challenge);
        const isValid = userAnswer.toString().trim() === challengeData.answer;
        
        // éªŒè¯ååˆ é™¤éªŒè¯ç 
        await redis.del(`captcha:${challengeId}`);
        
        return { 
            valid: isValid, 
            message: isValid ? 'éªŒè¯é€šè¿‡' : 'éªŒè¯ç é”™è¯¯'
        };
    }
}
```

---

## 9. ğŸš¨ å¼‚å¸¸æ£€æµ‹ç³»ç»Ÿ


### 9.1 å¼‚å¸¸è¡Œä¸ºæ¨¡å¼è¯†åˆ«


**ğŸ”¸ ä»€ä¹ˆæ˜¯å¼‚å¸¸æ£€æµ‹ï¼Ÿ**
ç®€å•è¯´ï¼šé€šè¿‡åˆ†æç”¨æˆ·çš„æ­£å¸¸è¡Œä¸ºï¼Œå‘ç°ä¸æ­£å¸¸çš„æ“ä½œ

```
æ­£å¸¸è¡Œä¸ºå»ºæ¨¡ï¼š
ğŸ‘¤ ç”¨æˆ·ç”»åƒå»ºç«‹ï¼š
â€¢ å·¥ä½œæ—¶é—´ï¼šå‘¨ä¸€åˆ°å‘¨äº” 9:00-18:00
â€¢ å¸¸ç”¨åœ°ç‚¹ï¼šåŒ—äº¬ã€ä¸Šæµ·ï¼ˆå‡ºå·®ï¼‰
â€¢ è®¿é—®æ¨¡å¼ï¼šä¸»è¦æŸ¥çœ‹æŠ¥è¡¨ï¼Œå¶å°”ä¸‹è½½æ–‡ä»¶
â€¢ æ“ä½œé¢‘ç‡ï¼šæ¯å¤©å¹³å‡50æ¬¡ç‚¹å‡»

å¼‚å¸¸è¡Œä¸ºè¯†åˆ«ï¼š
ğŸš¨ æ—¶é—´å¼‚å¸¸ï¼šå‡Œæ™¨3ç‚¹å¤§é‡æ“ä½œ
ğŸš¨ åœ°ç‚¹å¼‚å¸¸ï¼šçªç„¶ä»ä¿„ç½—æ–¯ç™»å½•  
ğŸš¨ è¡Œä¸ºå¼‚å¸¸ï¼šä¸‹è½½äº†100ä¸ªæ–‡ä»¶
ğŸš¨ é¢‘ç‡å¼‚å¸¸ï¼š1åˆ†é’Ÿå†…ç‚¹å‡»500æ¬¡
```

**ğŸ”¸ å¼‚å¸¸æ£€æµ‹ç®—æ³•**
```
åŸºäºè§„åˆ™çš„æ£€æµ‹ï¼š
IF ç™»å½•æ—¶é—´ = å‡Œæ™¨2-6ç‚¹ THEN é£é™©=é«˜
IF ä¸‹è½½æ–‡ä»¶æ•° > 50 THEN é£é™©=é«˜
IF IPåœ°å€ â‰  å¸¸ç”¨å›½å®¶ THEN é£é™©=ä¸­

åŸºäºç»Ÿè®¡çš„æ£€æµ‹ï¼š
â€¢ è®¡ç®—ç”¨æˆ·è¡Œä¸ºçš„å¹³å‡å€¼å’Œæ ‡å‡†å·®
â€¢ è¶…è¿‡3å€æ ‡å‡†å·®è§†ä¸ºå¼‚å¸¸
â€¢ ä¾‹ï¼šç”¨æˆ·å¹³å‡æ¯å¤©ä¸‹è½½5ä¸ªæ–‡ä»¶ï¼Œæ ‡å‡†å·®=2
  ä»Šå¤©ä¸‹è½½äº†20ä¸ªæ–‡ä»¶ï¼š(20-5)/2 = 7.5å€æ ‡å‡†å·® â†’ å¼‚å¸¸ï¼

åŸºäºæœºå™¨å­¦ä¹ çš„æ£€æµ‹ï¼š
â€¢ è®­ç»ƒç”¨æˆ·è¡Œä¸ºæ¨¡å‹
â€¢ æ–°è¡Œä¸ºä¸æ¨¡å‹å¯¹æ¯”
â€¢ è®¡ç®—å¼‚å¸¸å¾—åˆ†
```

**ğŸ’» å¼‚å¸¸æ£€æµ‹å®ç°**
```javascript
// å¼‚å¸¸è¡Œä¸ºæ£€æµ‹å™¨
class AnomalyDetector {
    // æ£€æµ‹ç™»å½•å¼‚å¸¸
    static async detectLoginAnomaly(userId, loginData) {
        const userProfile = await this.getUserProfile(userId);
        const anomalies = [];
        
        // æ—¶é—´å¼‚å¸¸æ£€æµ‹
        const loginHour = new Date(loginData.timestamp).getHours();
        if (!this.isNormalHour(userProfile.usualHours, loginHour)) {
            anomalies.push({
                type: 'unusual_time',
                severity: 'medium',
                details: `ç”¨æˆ·é€šå¸¸åœ¨${userProfile.usualHours.join(',')}ç‚¹ç™»å½•ï¼Œç°åœ¨æ˜¯${loginHour}ç‚¹`
            });
        }
        
        // åœ°ç†ä½ç½®å¼‚å¸¸æ£€æµ‹  
        const distance = this.calculateDistance(
            userProfile.usualLocation, 
            loginData.location
        );
        
        if (distance > 1000) { // è¶…è¿‡1000å…¬é‡Œ
            anomalies.push({
                type: 'unusual_location',
                severity: 'high',
                details: `è·ç¦»å¸¸ç”¨åœ°ç‚¹${distance}å…¬é‡Œ`
            });
        }
        
        // è®¾å¤‡å¼‚å¸¸æ£€æµ‹
        if (!userProfile.knownDevices.includes(loginData.deviceId)) {
            anomalies.push({
                type: 'new_device',
                severity: 'medium', 
                details: 'ä½¿ç”¨æ–°è®¾å¤‡ç™»å½•'
            });
        }
        
        return {
            hasAnomaly: anomalies.length > 0,
            anomalies: anomalies,
            riskScore: this.calculateRiskScore(anomalies)
        };
    }
    
    // æ£€æµ‹æ“ä½œå¼‚å¸¸
    static async detectOperationAnomaly(userId, operations) {
        const userProfile = await this.getUserProfile(userId);
        const stats = this.calculateOperationStats(operations);
        
        const anomalies = [];
        
        // æ“ä½œé¢‘ç‡å¼‚å¸¸
        if (stats.operationsPerMinute > userProfile.avgOperationsPerMinute * 5) {
            anomalies.push({
                type: 'high_frequency',
                severity: 'high',
                details: `æ“ä½œé¢‘ç‡å¼‚å¸¸ï¼š${stats.operationsPerMinute}/åˆ†é’Ÿ`
            });
        }
        
        // ä¸‹è½½å¼‚å¸¸
        if (stats.downloadCount > userProfile.avgDailyDownloads * 3) {
            anomalies.push({
                type: 'excessive_download',
                severity: 'high',
                details: `ä¸‹è½½æ–‡ä»¶æ•°å¼‚å¸¸ï¼š${stats.downloadCount}ä¸ª`
            });
        }
        
        // è®¿é—®æ•æ„Ÿèµ„æºå¼‚å¸¸
        const sensitiveAccess = operations.filter(op => 
            op.resource && this.isSensitiveResource(op.resource)
        );
        
        if (sensitiveAccess.length > 0 && !userProfile.hasSensitivePermission) {
            anomalies.push({
                type: 'unauthorized_access',
                severity: 'critical',
                details: `å°è¯•è®¿é—®æ•æ„Ÿèµ„æºï¼š${sensitiveAccess.map(a => a.resource).join(', ')}`
            });
        }
        
        return {
            hasAnomaly: anomalies.length > 0,
            anomalies: anomalies,
            riskScore: this.calculateRiskScore(anomalies)
        };
    }
}
```

### 9.2 å®æ—¶å‘Šè­¦æœºåˆ¶


**ğŸ”¸ å‘Šè­¦è§¦å‘æ¡ä»¶**
```
å‘Šè­¦çº§åˆ«ï¼š
ğŸŸ¢ ä½é£é™©ï¼šè®°å½•æ—¥å¿—ï¼Œæ— éœ€ç«‹å³å¤„ç†
ğŸŸ¡ ä¸­é£é™©ï¼šé‚®ä»¶é€šçŸ¥å®‰å…¨ç®¡ç†å‘˜
ğŸ”´ é«˜é£é™©ï¼šçŸ­ä¿¡+é‚®ä»¶+ç³»ç»Ÿå¼¹çª—
ğŸš¨ ä¸¥é‡é£é™©ï¼šç«‹å³é”å®šè´¦æˆ·+ç”µè¯é€šçŸ¥

å‘Šè­¦åœºæ™¯ï¼š
â€¢ å¤šæ¬¡ç™»å½•å¤±è´¥ â†’ ä¸­é£é™©
â€¢ å¼‚åœ°ç™»å½• â†’ ä¸­é£é™©
â€¢ å‡Œæ™¨å¤§é‡ä¸‹è½½ â†’ é«˜é£é™©  
â€¢ è®¿é—®æœªæˆæƒèµ„æº â†’ ä¸¥é‡é£é™©
â€¢ æ‰¹é‡æ•°æ®å¯¼å‡º â†’ ä¸¥é‡é£é™©
```

**ğŸ’» å‘Šè­¦ç³»ç»Ÿå®ç°**
```javascript
// å®æ—¶å‘Šè­¦ç³»ç»Ÿ
class SecurityAlertSystem {
    // å¤„ç†å®‰å…¨äº‹ä»¶
    static async handleSecurityEvent(event) {
        const riskLevel = this.assessRiskLevel(event);
        const alertConfig = this.getAlertConfig(riskLevel);
        
        // è®°å½•å®‰å…¨äº‹ä»¶
        await db.securityEvents.insert({
            ...event,
            riskLevel: riskLevel,
            timestamp: new Date(),
            handled: false
        });
        
        // æ ¹æ®é£é™©çº§åˆ«æ‰§è¡Œå¯¹åº”æ“ä½œ
        switch (riskLevel) {
            case 'low':
                await this.logEvent(event);
                break;
                
            case 'medium':
                await this.sendEmailAlert(event);
                break;
                
            case 'high':
                await this.sendEmailAlert(event);
                await this.sendSMSAlert(event);
                await this.notifySecurityTeam(event);
                break;
                
            case 'critical':
                await this.lockUserAccount(event.userId);
                await this.sendEmergencyAlert(event);
                await this.callSecurityTeam(event);
                break;
        }
    }
    
    // å‘é€é‚®ä»¶å‘Šè­¦
    static async sendEmailAlert(event) {
        const subject = `å®‰å…¨å‘Šè­¦ - ${event.type}`;
        const body = this.formatAlertMessage(event);
        
        await emailService.send({
            to: ['security@company.com'],
            subject: subject,
            html: body
        });
    }
    
    // å‘é€çŸ­ä¿¡å‘Šè­¦
    static async sendSMSAlert(event) {
        const message = `å®‰å…¨å‘Šè­¦ï¼šç”¨æˆ·${event.username}å‡ºç°${event.type}ï¼Œé£é™©çº§åˆ«ï¼š${event.riskLevel}`;
        
        const securityTeam = await db.getSecurityTeamContacts();
        for (const contact of securityTeam) {
            await smsService.send(contact.phone, message);
        }
    }
    
    // æ ¼å¼åŒ–å‘Šè­¦æ¶ˆæ¯
    static formatAlertMessage(event) {
        return `
            <h2>å®‰å…¨å‘Šè­¦é€šçŸ¥</h2>
            <p><strong>å‘Šè­¦ç±»å‹ï¼š</strong>${event.type}</p>
            <p><strong>é£é™©çº§åˆ«ï¼š</strong>${event.riskLevel}</p>
            <p><strong>ç”¨æˆ·ï¼š</strong>${event.username}</p>
            <p><strong>æ—¶é—´ï¼š</strong>${new Date(event.timestamp).toLocaleString()}</p>
            <p><strong>IPåœ°å€ï¼š</strong>${event.ip}</p>
            <p><strong>è¯¦ç»†ä¿¡æ¯ï¼š</strong>${event.details}</p>
            
            <h3>å»ºè®®å¤„ç†æªæ–½ï¼š</h3>
            <ul>
                ${this.getSuggestedActions(event).map(action => `<li>${action}</li>`).join('')}
            </ul>
        `;
    }
}
```

---

## 10. ğŸ” å¯†ç å®‰å…¨ç­–ç•¥


### 10.1 å¯†ç å¤æ‚åº¦è¦æ±‚


**ğŸ”¸ ä¸ºä»€ä¹ˆéœ€è¦å¤æ‚å¯†ç ï¼Ÿ**
ç®€å•è¯´ï¼šç®€å•å¯†ç å®¹æ˜“è¢«çŒœåˆ°ï¼Œå¤æ‚å¯†ç æ›´éš¾ç ´è§£

```
å¼±å¯†ç ç¤ºä¾‹ï¼š
âŒ 123456        â†’ æ•°å­—å­—å…¸æ”»å‡»
âŒ password      â†’ å¸¸ç”¨è¯å…¸æ”»å‡»  
âŒ admin123      â†’ ç»„åˆå­—å…¸æ”»å‡»
âŒ zhangsan      â†’ ä¸ªäººä¿¡æ¯æ”»å‡»
âŒ qwerty        â†’ é”®ç›˜è§„å¾‹æ”»å‡»

å¼ºå¯†ç ç‰¹å¾ï¼š
âœ… é•¿åº¦è‡³å°‘8ä½
âœ… åŒ…å«å¤§å°å†™å­—æ¯
âœ… åŒ…å«æ•°å­—
âœ… åŒ…å«ç‰¹æ®Šå­—ç¬¦  
âœ… ä¸æ˜¯å¸¸ç”¨è¯æ±‡
âœ… ä¸åŒ…å«ä¸ªäººä¿¡æ¯

å¼ºå¯†ç ç¤ºä¾‹ï¼š
âœ… P@ssW0rd2024!  â†’ æ»¡è¶³æ‰€æœ‰æ¡ä»¶
âœ… MyS3cur3P@ss   â†’ å®¹æ˜“è®°å¿†ä¸”å®‰å…¨
```

**ğŸ”¸ å¯†ç å¼ºåº¦è¯„ä¼°**
```
å¯†ç å¼ºåº¦ç®—æ³•ï¼š
åŸºç¡€åˆ†ï¼š0åˆ†
é•¿åº¦åˆ†ï¼šæ¯ä¸ªå­—ç¬¦+4åˆ†  
å­—ç¬¦ç±»å‹åˆ†ï¼š
â€¢ å°å†™å­—æ¯ï¼š+1åˆ†
â€¢ å¤§å†™å­—æ¯ï¼š+2åˆ†  
â€¢ æ•°å­—ï¼š+1åˆ†
â€¢ ç‰¹æ®Šç¬¦å·ï¼š+3åˆ†

å‡åˆ†é¡¹ï¼š
â€¢ è¿ç»­å­—ç¬¦ï¼š-1åˆ† (abc, 123)
â€¢ é‡å¤å­—ç¬¦ï¼š-1åˆ† (aaa, 111)
â€¢ å¸¸ç”¨æ¨¡å¼ï¼š-2åˆ† (é”®ç›˜åºåˆ—)

å¼ºåº¦ç­‰çº§ï¼š
0-30åˆ†ï¼šå¼±
31-60åˆ†ï¼šä¸­ç­‰
61-90åˆ†ï¼šå¼º
90åˆ†ä»¥ä¸Šï¼šå¾ˆå¼º
```

**ğŸ’» å¯†ç å¼ºåº¦æ£€æŸ¥**
```javascript
// å¯†ç å¼ºåº¦æ£€æŸ¥å™¨
class PasswordStrengthChecker {
    // æ£€æŸ¥å¯†ç å¼ºåº¦
    static checkStrength(password) {
        let score = 0;
        const feedback = [];
        
        // é•¿åº¦æ£€æŸ¥
        if (password.length < 8) {
            feedback.push('å¯†ç è‡³å°‘éœ€è¦8ä½å­—ç¬¦');
        } else {
            score += password.length * 4;
        }
        
        // å­—ç¬¦ç±»å‹æ£€æŸ¥
        const patterns = {
            lowercase: /[a-z]/,
            uppercase: /[A-Z]/, 
            numbers: /[0-9]/,
            special: /[^a-zA-Z0-9]/
        };
        
        let typeCount = 0;
        for (const [type, pattern] of Object.entries(patterns)) {
            if (pattern.test(password)) {
                typeCount++;
                switch (type) {
                    case 'lowercase': score += 1; break;
                    case 'uppercase': score += 2; break;
                    case 'numbers': score += 1; break;
                    case 'special': score += 3; break;
                }
            } else {
                feedback.push(`ç¼ºå°‘${this.getTypeDescription(type)}`);
            }
        }
        
        // å‡åˆ†é¡¹æ£€æŸ¥
        if (this.hasConsecutiveChars(password)) {
            score -= 1;
            feedback.push('é¿å…è¿ç»­å­—ç¬¦');
        }
        
        if (this.hasRepeatingChars(password)) {
            score -= 1;
            feedback.push('é¿å…é‡å¤å­—ç¬¦');
        }
        
        if (this.isCommonPassword(password)) {
            score -= 10;
            feedback.push('è¿™æ˜¯å¸¸ç”¨å¯†ç ï¼Œä¸å®‰å…¨');
        }
        
        return {
            score: Math.max(0, score),
            level: this.getStrengthLevel(score),
            feedback: feedback
        };
    }
    
    // æ£€æŸ¥è¿ç»­å­—ç¬¦
    static hasConsecutiveChars(password) {
        for (let i = 0; i < password.length - 2; i++) {
            const char1 = password.charCodeAt(i);
            const char2 = password.charCodeAt(i + 1);
            const char3 = password.charCodeAt(i + 2);
            
            if (char2 === char1 + 1 && char3 === char2 + 1) {
                return true;
            }
        }
        return false;
    }
    
    // æ£€æŸ¥é‡å¤å­—ç¬¦
    static hasRepeatingChars(password) {
        const repeats = password.match(/(.)\1{2,}/g);
        return repeats && repeats.length > 0;
    }
    
    // æ£€æŸ¥æ˜¯å¦ä¸ºå¸¸ç”¨å¯†ç 
    static isCommonPassword(password) {
        const commonPasswords = [
            '123456', 'password', 'admin', 'qwerty',
            'letmein', 'welcome', '123456789', 'admin123'
        ];
        
        return commonPasswords.includes(password.toLowerCase());
    }
    
    // è·å–å¼ºåº¦ç­‰çº§
    static getStrengthLevel(score) {
        if (score < 30) return 'weak';
        if (score < 60) return 'medium';  
        if (score < 90) return 'strong';
        return 'very_strong';
    }
}
```

### 10.2 å¯†ç å­˜å‚¨å®‰å…¨


**ğŸ”¸ ä¸ºä»€ä¹ˆä¸èƒ½æ˜æ–‡å­˜å‚¨å¯†ç ï¼Ÿ**
ç®€å•è¯´ï¼šæ˜æ–‡å¯†ç è¢«å·çœ‹åï¼Œåäººç›´æ¥å°±çŸ¥é“ä½ çš„å¯†ç äº†

```
å¯†ç å­˜å‚¨æ–¹å¼å¯¹æ¯”ï¼š

âŒ æ˜æ–‡å­˜å‚¨ï¼š
æ•°æ®åº“ï¼šadmin / 123456
é£é™©ï¼šæ•°æ®æ³„éœ²åç›´æ¥è·å–æ‰€æœ‰å¯†ç 

âŒ ç®€å•åŠ å¯†ï¼š
æ•°æ®åº“ï¼šadmin / MTIzNDU2 (Base64ç¼–ç )
é£é™©ï¼šå®¹æ˜“è¢«è§£ç è¿˜åŸ

âŒ MD5å“ˆå¸Œï¼š
æ•°æ®åº“ï¼šadmin / e10adc3949ba59abbe56e057f20f883e
é£é™©ï¼šå½©è™¹è¡¨æ”»å‡»ï¼Œç§’ç ´å¸¸ç”¨å¯†ç 

âœ… åŠ ç›å“ˆå¸Œï¼š
æ•°æ®åº“ï¼šadmin / $2b$10$N9qo8uLOickgx2ZMRZoMye.../salt
ä¼˜ç‚¹ï¼šæ¯ä¸ªç”¨æˆ·ä¸åŒç›å€¼ï¼Œæ— æ³•æ‰¹é‡ç ´è§£
```

**ğŸ”¸ ä»€ä¹ˆæ˜¯ç›å€¼ï¼ˆSaltï¼‰ï¼Ÿ**
ç®€å•è¯´ï¼šç»™å¯†ç åŠ æ–™ï¼ŒåŒæ ·çš„å¯†ç å˜æˆä¸åŒçš„å“ˆå¸Œå€¼

```
æ— ç›å“ˆå¸Œé—®é¢˜ï¼š
ç”¨æˆ·Aå¯†ç ï¼š123456 â†’ MD5ï¼še10adc3949ba59abbe56e057f20f883e
ç”¨æˆ·Bå¯†ç ï¼š123456 â†’ MD5ï¼še10adc3949ba59abbe56e057f20f883e
é—®é¢˜ï¼šç›¸åŒå¯†ç äº§ç”Ÿç›¸åŒå“ˆå¸Œï¼Œå®¹æ˜“è¢«æ‰¹é‡ç ´è§£

åŠ ç›å“ˆå¸Œè§£å†³ï¼š
ç”¨æˆ·Aï¼š123456 + saltA â†’ bcryptï¼š$2b$10$abcdef...
ç”¨æˆ·Bï¼š123456 + saltB â†’ bcryptï¼š$2b$10$xyz789...
ä¼˜ç‚¹ï¼šç›¸åŒå¯†ç äº§ç”Ÿä¸åŒå“ˆå¸Œï¼Œæé«˜å®‰å…¨æ€§
```

**ğŸ’» å®‰å…¨å¯†ç å­˜å‚¨å®ç°**
```javascript
const bcrypt = require('bcrypt');

// å¯†ç åŠ å¯†å­˜å‚¨
class PasswordManager {
    // åŠ å¯†å¯†ç 
    static async hashPassword(plainPassword) {
        const saltRounds = 12; // ç›å€¼è½®æ•°ï¼Œè¶Šé«˜è¶Šå®‰å…¨ä½†è¶Šæ…¢
        
        try {
            const hashedPassword = await bcrypt.hash(plainPassword, saltRounds);
            return {
                success: true,
                hashedPassword: hashedPassword
            };
        } catch (error) {
            return {
                success: false,
                error: 'å¯†ç åŠ å¯†å¤±è´¥'
            };
        }
    }
    
    // éªŒè¯å¯†ç 
    static async verifyPassword(plainPassword, hashedPassword) {
        try {
            const isMatch = await bcrypt.compare(plainPassword, hashedPassword);
            return {
                success: true,
                isMatch: isMatch
            };
        } catch (error) {
            return {
                success: false,
                error: 'å¯†ç éªŒè¯å¤±è´¥'
            };
        }
    }
    
    // ç”¨æˆ·æ³¨å†Œæ—¶å­˜å‚¨å¯†ç 
    static async registerUser(username, plainPassword) {
        // æ£€æŸ¥å¯†ç å¼ºåº¦
        const strengthCheck = PasswordStrengthChecker.checkStrength(plainPassword);
        if (strengthCheck.level === 'weak') {
            return {
                success: false,
                message: 'å¯†ç å¼ºåº¦ä¸è¶³',
                feedback: strengthCheck.feedback
            };
        }
        
        // åŠ å¯†å¯†ç 
        const hashResult = await this.hashPassword(plainPassword);
        if (!hashResult.success) {
            return hashResult;
        }
        
        // å­˜å‚¨åˆ°æ•°æ®åº“
        const user = {
            username: username,
            password: hashResult.hashedPassword,
            createdAt: new Date(),
            passwordLastChanged: new Date()
        };
        
        await db.users.insert(user);
        
        return {
            success: true,
            message: 'ç”¨æˆ·æ³¨å†ŒæˆåŠŸ'
        };
    }
    
    // ç”¨æˆ·ç™»å½•éªŒè¯
    static async loginUser(username, plainPassword) {
        const user = await db.users.findByUsername(username);
        if (!user) {
            return {
                success: false,
                message: 'ç”¨æˆ·ä¸å­˜åœ¨'
            };
        }
        
        const verifyResult = await this.verifyPassword(plainPassword, user.password);
        if (!verifyResult.success || !verifyResult.isMatch) {
            return {
                success: false,
                message: 'å¯†ç é”™è¯¯'
            };
        }
        
        return {
            success: true,
            message: 'ç™»å½•æˆåŠŸ',
            user: {
                id: user.id,
                username: user.username
            }
        };
    }
}
```

### 10.3 å¯†ç ç­–ç•¥ç®¡ç†


**ğŸ”¸ ä¼ä¸šå¯†ç ç­–ç•¥**
```
å¯†ç ç­–ç•¥é…ç½®ï¼š
ğŸ“ æœ€å°é•¿åº¦ï¼š8-16å­—ç¬¦
ğŸ”„ å®šæœŸæ›´æ¢ï¼š90å¤©å¼ºåˆ¶æ›´æ¢
ğŸš« å†å²é™åˆ¶ï¼šä¸èƒ½é‡å¤ä½¿ç”¨æœ€è¿‘5ä¸ªå¯†ç 
â° å¯†ç è¿‡æœŸï¼šæå‰15å¤©æé†’ç”¨æˆ·æ›´æ¢
ğŸ”’ ä¸´æ—¶é”å®šï¼šè¿ç»­å¤±è´¥5æ¬¡é”å®šè´¦æˆ·
```

**ğŸ”¸ å¯†ç è¿‡æœŸç®¡ç†**
```
è¿‡æœŸç®¡ç†æµç¨‹ï¼š
1. å¯†ç è®¾ç½®90å¤©æœ‰æ•ˆæœŸ
2. åˆ°æœŸå‰15å¤©å¼€å§‹æé†’
3. åˆ°æœŸå‰7å¤©æ¯å¤©æé†’
4. åˆ°æœŸå‰1å¤©å¼ºåˆ¶æé†’
5. è¿‡æœŸåç¦æ­¢ç™»å½•ï¼Œå¿…é¡»é‡ç½®å¯†ç 
```

**ğŸ’» å¯†ç ç­–ç•¥å®ç°**
```javascript
// å¯†ç ç­–ç•¥ç®¡ç†å™¨
class PasswordPolicyManager {
    static POLICY_CONFIG = {
        minLength: 8,
        maxLength: 128,
        requireUppercase: true,
        requireLowercase: true,
        requireNumbers: true,
        requireSpecialChars: true,
        passwordExpireDays: 90,
        passwordHistoryCount: 5,
        warningDays: 15
    };
    
    // æ£€æŸ¥å¯†ç æ˜¯å¦ç¬¦åˆç­–ç•¥
    static validatePasswordPolicy(password, userId = null) {
        const errors = [];
        const policy = this.POLICY_CONFIG;
        
        // é•¿åº¦æ£€æŸ¥
        if (password.length < policy.minLength) {
            errors.push(`å¯†ç é•¿åº¦è‡³å°‘${policy.minLength}ä½`);
        }
        if (password.length > policy.maxLength) {
            errors.push(`å¯†ç é•¿åº¦ä¸èƒ½è¶…è¿‡${policy.maxLength}ä½`);
        }
        
        // å­—ç¬¦ç±»å‹æ£€æŸ¥
        if (policy.requireUppercase && !/[A-Z]/.test(password)) {
            errors.push('å¯†ç å¿…é¡»åŒ…å«å¤§å†™å­—æ¯');
        }
        if (policy.requireLowercase && !/[a-z]/.test(password)) {
            errors.push('å¯†ç å¿…é¡»åŒ…å«å°å†™å­—æ¯');
        }
        if (policy.requireNumbers && !/[0-9]/.test(password)) {
            errors.push('å¯†ç å¿…é¡»åŒ…å«æ•°å­—');
        }
        if (policy.requireSpecialChars && !/[^a-zA-Z0-9]/.test(password)) {
            errors.push('å¯†ç å¿…é¡»åŒ…å«ç‰¹æ®Šå­—ç¬¦');
        }
        
        return {
            valid: errors.length === 0,
            errors: errors
        };
    }
    
    // æ£€æŸ¥å¯†ç å†å²é‡å¤
    static async checkPasswordHistory(userId, newPassword) {
        const passwordHistory = await db.passwordHistory.find({
            userId: userId
        }).sort({ createdAt: -1 }).limit(this.POLICY_CONFIG.passwordHistoryCount);
        
        for (const historyItem of passwordHistory) {
            const isMatch = await bcrypt.compare(newPassword, historyItem.passwordHash);
            if (isMatch) {
                return {
                    valid: false,
                    message: `ä¸èƒ½é‡å¤ä½¿ç”¨æœ€è¿‘${this.POLICY_CONFIG.passwordHistoryCount}ä¸ªå¯†ç `
                };
            }
        }
        
        return { valid: true };
    }
    
    // æ£€æŸ¥å¯†ç æ˜¯å¦è¿‡æœŸ
    static async checkPasswordExpiry(userId) {
        const user = await db.users.findById(userId);
        if (!user || !user.passwordLastChanged) {
            return { expired: false };
        }
        
        const now = new Date();
        const passwordAge = (now - user.passwordLastChanged) / (1000 * 60 * 60 * 24); // å¤©æ•°
        const expireDays = this.POLICY_CONFIG.passwordExpireDays;
        const warningDays = this.POLICY_CONFIG.warningDays;
        
        if (passwordAge >= expireDays) {
            return {
                expired: true,
                message: 'å¯†ç å·²è¿‡æœŸï¼Œè¯·ç«‹å³æ›´æ¢'
            };
        }
        
        if (passwordAge >= (expireDays - warningDays)) {
            const remainingDays = Math.ceil(expireDays - passwordAge);
            return {
                expired: false,
                warning: true,
                message: `å¯†ç å°†åœ¨${remainingDays}å¤©åè¿‡æœŸï¼Œè¯·åŠæ—¶æ›´æ¢`,
                remainingDays: remainingDays
            };
        }
        
        return { expired: false, warning: false };
    }
    
    // æ›´æ¢å¯†ç 
    static async changePassword(userId, oldPassword, newPassword) {
        const user = await db.users.findById(userId);
        if (!user) {
            return { success: false, message: 'ç”¨æˆ·ä¸å­˜åœ¨' };
        }
        
        // éªŒè¯æ—§å¯†ç 
        const oldPasswordValid = await bcrypt.compare(oldPassword, user.password);
        if (!oldPasswordValid) {
            return { success: false, message: 'åŸå¯†ç é”™è¯¯' };
        }
        
        // æ£€æŸ¥æ–°å¯†ç ç­–ç•¥
        const policyCheck = this.validatePasswordPolicy(newPassword);
        if (!policyCheck.valid) {
            return {
                success: false,
                message: 'æ–°å¯†ç ä¸ç¬¦åˆç­–ç•¥è¦æ±‚',
                errors: policyCheck.errors
            };
        }
        
        // æ£€æŸ¥å¯†ç å†å²
        const historyCheck = await this.checkPasswordHistory(userId, newPassword);
        if (!historyCheck.valid) {
            return {
                success: false,
                message: historyCheck.message
            };
        }
        
        // åŠ å¯†æ–°å¯†ç 
        const newPasswordHash = await bcrypt.hash(newPassword, 12);
        
        // ä¿å­˜å¯†ç å†å²
        await db.passwordHistory.insert({
            userId: userId,
            passwordHash: user.password,
            createdAt: new Date()
        });
        
        // æ›´æ–°ç”¨æˆ·å¯†ç 
        await db.users.update({ id: userId }, {
            password: newPasswordHash,
            passwordLastChanged: new Date()
        });
        
        return {
            success: true,
            message: 'å¯†ç æ›´æ¢æˆåŠŸ'
        };
    }
}
```

---

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ” å®‰å…¨é˜²æŠ¤æœ¬è´¨ï¼šå¤šå±‚æ¬¡ã€å¤šç»´åº¦çš„ç»¼åˆé˜²æŠ¤ä½“ç³»
ğŸ›¡ï¸ åŸºç¡€é˜²æŠ¤ï¼šHttpOnlyã€CSRF Tokenã€æœ€å°æƒé™åŸåˆ™
ğŸ”‘ ç™»å½•å®‰å…¨ï¼šéªŒè¯ç ã€é¢‘ç‡é™åˆ¶ã€åŒé‡éªŒè¯æœºåˆ¶
ğŸ¯ å¤šå› å­è®¤è¯ï¼šçŸ¥é“çš„+æ‹¥æœ‰çš„+æœ¬èº«çš„ä¸‰é‡éªŒè¯
ğŸŒ é£æ§ç®¡ç†ï¼šè®¾å¤‡ç®¡ç†ã€IPé£æ§ã€å¼‚åœ°ç™»å½•æ£€æµ‹
ğŸ“Š ç›‘æ§å®¡è®¡ï¼šæ—¥å¿—è®°å½•ã€è¡Œä¸ºåˆ†æã€å¼‚å¸¸æ£€æµ‹
ğŸ« Tokenç®¡ç†ï¼šé»‘åå•ã€IPç»‘å®šã€æ³„éœ²åè¡¥æ•‘
ğŸ”¨ æš´åŠ›ç ´è§£ï¼šè´¦æˆ·é”å®šã€æ¸è¿›å¼é™åˆ¶ã€åŠ¨æ€éªŒè¯ç 
ğŸš¨ å¼‚å¸¸æ£€æµ‹ï¼šè¡Œä¸ºå»ºæ¨¡ã€å®æ—¶å‘Šè­¦ã€è‡ªåŠ¨å“åº”
ğŸ” å¯†ç å®‰å…¨ï¼šå¤æ‚åº¦è¦æ±‚ã€å®‰å…¨å­˜å‚¨ã€ç­–ç•¥ç®¡ç†
```

### 11.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å®‰å…¨é˜²æŠ¤çš„æ ¸å¿ƒæ€ç»´**
```
çºµæ·±é˜²æŠ¤ï¼š
ä¸ä¾èµ–å•ä¸€é˜²æŠ¤æªæ–½ï¼Œæ„å»ºå¤šå±‚é˜²æŠ¤ä½“ç³»
å³ä½¿ä¸€å±‚è¢«çªç ´ï¼Œå…¶ä»–å±‚ä»èƒ½é˜»æŒ¡æ”»å‡»

æŒç»­ç›‘æ§ï¼š
å®‰å…¨ä¸æ˜¯ä¸€æ¬¡æ€§å·¥ä½œï¼Œéœ€è¦æŒç»­ç›‘æ§å’Œæ”¹è¿›
å»ºç«‹å®Œå–„çš„æ—¥å¿—å®¡è®¡å’Œå¼‚å¸¸æ£€æµ‹æœºåˆ¶

ç”¨æˆ·ä½“éªŒå¹³è¡¡ï¼š
å®‰å…¨æªæ–½ä¸èƒ½è¿‡åº¦å½±å“ç”¨æˆ·ä½“éªŒ
åœ¨å®‰å…¨æ€§å’Œä¾¿åˆ©æ€§ä¹‹é—´æ‰¾åˆ°æœ€ä½³å¹³è¡¡ç‚¹
```

**ğŸ”¹ è®¤è¯å®‰å…¨çš„å®ç°è¦ç‚¹**
```
å¤šå› å­ç»“åˆï¼š
å•ä¸€è®¤è¯å› å­ä¸å¤Ÿå®‰å…¨ï¼Œéœ€è¦å¤šç§æ–¹å¼ç»„åˆ
æ ¹æ®é£é™©çº§åˆ«åŠ¨æ€è°ƒæ•´è®¤è¯å¼ºåº¦

è¡Œä¸ºåˆ†æï¼š
å»ºç«‹ç”¨æˆ·è¡Œä¸ºåŸºçº¿ï¼Œè¯†åˆ«å¼‚å¸¸æ“ä½œ
ç»“åˆè§„åˆ™æ£€æµ‹å’Œæœºå™¨å­¦ä¹ ç®—æ³•

åŠæ—¶å“åº”ï¼š
å»ºç«‹åˆ†çº§å‘Šè­¦æœºåˆ¶ï¼Œå¿«é€Ÿå“åº”å®‰å…¨äº‹ä»¶
å‡†å¤‡åº”æ€¥é¢„æ¡ˆï¼Œæœ€å°åŒ–å®‰å…¨å½±å“
```

### 11.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ é˜²æŠ¤ç­–ç•¥é€‰æ‹©**
```
åŸºç¡€åº”ç”¨ï¼š
âœ… å¯†ç å¤æ‚åº¦è¦æ±‚
âœ… HttpOnly + Secure Cookie
âœ… CSRF Tokenä¿æŠ¤
âœ… åŸºæœ¬é¢‘ç‡é™åˆ¶

ä¸­çº§åº”ç”¨ï¼š
âœ… çŸ­ä¿¡éªŒè¯ç 
âœ… è®¾å¤‡ç®¡ç†
âœ… IPé£æ§
âœ… å®¡è®¡æ—¥å¿—

é«˜çº§åº”ç”¨ï¼š
âœ… ç”Ÿç‰©è¯†åˆ«
âœ… è¡Œä¸ºåˆ†æ
âœ… æœºå™¨å­¦ä¹ å¼‚å¸¸æ£€æµ‹
âœ… é›¶ä¿¡ä»»æ¶æ„
```

**ğŸ› ï¸ å®æ–½ä¼˜å…ˆçº§å»ºè®®**
```
ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€å®‰å…¨
1. å¯†ç å®‰å…¨ç­–ç•¥
2. HTTPS + å®‰å…¨Cookie
3. CSRFé˜²æŠ¤
4. åŸºæœ¬æ—¥å¿—è®°å½•

ç¬¬äºŒé˜¶æ®µï¼šè®¤è¯å¢å¼º
1. çŸ­ä¿¡éªŒè¯ç 
2. ç™»å½•é¢‘ç‡é™åˆ¶
3. ç®€å•å¼‚å¸¸æ£€æµ‹
4. Tokené»‘åå•

ç¬¬ä¸‰é˜¶æ®µï¼šæ™ºèƒ½é˜²æŠ¤
1. å¤šå› å­è®¤è¯
2. è®¾å¤‡æŒ‡çº¹è¯†åˆ«
3. è¡Œä¸ºåˆ†æ
4. è‡ªåŠ¨åŒ–å“åº”

ç¬¬å››é˜¶æ®µï¼šé«˜çº§é˜²æŠ¤
1. æœºå™¨å­¦ä¹ æ£€æµ‹
2. ç”Ÿç‰©è¯†åˆ«é›†æˆ
3. é›¶ä¿¡ä»»æ¶æ„
4. å¨èƒæƒ…æŠ¥é›†æˆ
```

### 11.4 å¸¸è§é—®é¢˜ä¸å¯¹ç­–


**â“ å¦‚ä½•å¹³è¡¡å®‰å…¨ä¸ç”¨æˆ·ä½“éªŒï¼Ÿ**
```
è§£å†³æ€è·¯ï¼š
â€¢ é£é™©è‡ªé€‚åº”ï¼šæ ¹æ®ç”¨æˆ·è¡Œä¸ºé£é™©åŠ¨æ€è°ƒæ•´å®‰å…¨ç­–ç•¥
â€¢ ç”¨æˆ·æ•™è‚²ï¼šå¸®åŠ©ç”¨æˆ·ç†è§£å®‰å…¨æªæ–½çš„å¿…è¦æ€§
â€¢ æ¸è¿›å¼éªŒè¯ï¼šä»ç®€å•åˆ°å¤æ‚çš„éªŒè¯æ–¹å¼
â€¢ æ™ºèƒ½åˆ¤æ–­ï¼šå‡å°‘å¯¹æ­£å¸¸ç”¨æˆ·çš„å¹²æ‰°
```

**â“ å¦‚ä½•åº”å¯¹æ–°å‹æ”»å‡»ï¼Ÿ**
```
åº”å¯¹ç­–ç•¥ï¼š
â€¢ å¨èƒæƒ…æŠ¥ï¼šå…³æ³¨æœ€æ–°çš„å®‰å…¨å¨èƒä¿¡æ¯
â€¢ æŒç»­æ”¹è¿›ï¼šå®šæœŸæ›´æ–°å’Œå®Œå–„é˜²æŠ¤ç­–ç•¥
â€¢ å®‰å…¨åŸ¹è®­ï¼šæé«˜å›¢é˜Ÿçš„å®‰å…¨æ„è¯†å’ŒæŠ€èƒ½
â€¢ åº”æ€¥é¢„æ¡ˆï¼šå‡†å¤‡å„ç§å®‰å…¨äº‹ä»¶çš„åº”å¯¹æ–¹æ¡ˆ
```

### 11.5 æœ€ä½³å®è·µæ€»ç»“


**ğŸŒŸ è®¾è®¡åŸåˆ™**
- **æœ€å°æƒé™**ï¼šåªç»™ç”¨æˆ·å¿…éœ€çš„æœ€å°‘æƒé™
- **æ·±åº¦é˜²æŠ¤**ï¼šå¤šå±‚æ¬¡çš„å®‰å…¨é˜²æŠ¤æªæ–½
- **æŒç»­éªŒè¯**ï¼šä¸ä¿¡ä»»ï¼ŒæŒç»­éªŒè¯
- **å¿«é€Ÿå“åº”**ï¼šåŠæ—¶å‘ç°å’Œå¤„ç†å®‰å…¨äº‹ä»¶

**ğŸ”§ å®æ–½è¦ç‚¹**
- **å…¨å‘˜å‚ä¸**ï¼šå®‰å…¨ä¸åªæ˜¯æŠ€æœ¯å›¢é˜Ÿçš„è´£ä»»
- **å®šæœŸè¯„ä¼°**ï¼šæŒç»­è¯„ä¼°å’Œæ”¹è¿›å®‰å…¨æªæ–½
- **åˆè§„éµå¾ª**ï¼šéµå¾ªè¡Œä¸šå®‰å…¨æ ‡å‡†å’Œæ³•è§„
- **ç”¨æˆ·æ•™è‚²**ï¼šæé«˜ç”¨æˆ·çš„å®‰å…¨æ„è¯†

**ğŸ“Š ç›‘æ§æŒ‡æ ‡**
- **ç™»å½•æˆåŠŸç‡**ï¼šç›‘æ§å¼‚å¸¸ç™»å½•æ´»åŠ¨
- **å‘Šè­¦å“åº”æ—¶é—´**ï¼šè¡¡é‡å®‰å…¨äº‹ä»¶å¤„ç†æ•ˆç‡
- **ç”¨æˆ·æŠ•è¯‰ç‡**ï¼šå¹³è¡¡å®‰å…¨ä¸ç”¨æˆ·ä½“éªŒ
- **å®‰å…¨äº‹ä»¶æ•°é‡**ï¼šè¯„ä¼°é˜²æŠ¤æ•ˆæœ

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
ğŸ” å®‰å…¨é˜²æŠ¤å¤šå±‚æ¬¡ï¼Œè®¤è¯æˆæƒè¦ä¸¥å¯†
ğŸ›¡ï¸ å¯†ç TokenåŒä¿é™©ï¼Œå¼‚å¸¸æ£€æµ‹ä¸æ”¾æ¾
ğŸš¨ æ—¥å¿—å®¡è®¡è®°å½•å…¨ï¼Œé£æ§ç­–ç•¥è¦æ™ºèƒ½
âš–ï¸ å®‰å…¨ä½“éªŒä¸¤å¹³è¡¡ï¼ŒæŒç»­æ”¹è¿›æ˜¯å…³é”®
```
