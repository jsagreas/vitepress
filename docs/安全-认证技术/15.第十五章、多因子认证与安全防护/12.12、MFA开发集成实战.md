---
title: 12ã€MFAå¼€å‘é›†æˆå®æˆ˜
---
## ğŸ“š ç›®å½•

1. [MFAåœ¨Webåº”ç”¨ä¸­çš„é›†æˆ](#1-MFAåœ¨Webåº”ç”¨ä¸­çš„é›†æˆ)
2. [ç™»å½•é€»è¾‘ä¸MFAç»“åˆæ–¹å¼](#2-ç™»å½•é€»è¾‘ä¸MFAç»“åˆæ–¹å¼)
3. [Session + MFA æµç¨‹è¯¦è§£](#3-Session-MFA-æµç¨‹è¯¦è§£)
4. [Token + MFA æµç¨‹å®ç°](#4-Token-MFA-æµç¨‹å®ç°)
5. [APIè®¾è®¡ä¸æ¥å£å®‰å…¨](#5-APIè®¾è®¡ä¸æ¥å£å®‰å…¨)
6. [å‰åç«¯äº¤äº’å®ç°](#6-å‰åç«¯äº¤äº’å®ç°)
7. [å¸¸ç”¨å¼€å‘åº“ä»‹ç»](#7-å¸¸ç”¨å¼€å‘åº“ä»‹ç»)
8. [JWTä»¤ç‰Œè®¾è®¡è¯¦è§£](#8-JWTä»¤ç‰Œè®¾è®¡è¯¦è§£)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” MFAåœ¨Webåº”ç”¨ä¸­çš„é›†æˆ


### 1.1 ä»€ä¹ˆæ˜¯MFAé›†æˆ


**å¤šå› å­è®¤è¯ï¼ˆMFAï¼‰é›†æˆ**ï¼šå°±æ˜¯åœ¨åŸæœ‰çš„ç”¨æˆ·ç™»å½•ç³»ç»ŸåŸºç¡€ä¸Šï¼Œ**å¢åŠ ç¬¬äºŒé“éªŒè¯é—¨æ§›**ã€‚

ç®€å•ç†è§£ï¼š
```
ä¼ ç»Ÿç™»å½•ï¼šç”¨æˆ·å + å¯†ç  = ç™»å½•æˆåŠŸ
MFAç™»å½•ï¼šç”¨æˆ·å + å¯†ç  + éªŒè¯ç  = ç™»å½•æˆåŠŸ
```

**ä¸ºä»€ä¹ˆéœ€è¦MFA**ï¼Ÿ
- ğŸ”’ **å¯†ç è¢«ç›—**ï¼šå³ä½¿å¯†ç æ³„éœ²ï¼Œé»‘å®¢è¿˜éœ€è¦ä½ çš„æ‰‹æœº
- ğŸ’³ **æ’åº“æ”»å‡»**ï¼šé˜²æ­¢ç”¨åŒä¸€å¥—å¯†ç åœ¨å¤šä¸ªç½‘ç«™è¢«æ”»å‡»
- ğŸ¢ **ä¼ä¸šå®‰å…¨**ï¼šä¿æŠ¤é‡è¦ç³»ç»Ÿå’Œæ•æ„Ÿæ•°æ®

### 1.2 MFAé›†æˆçš„æ ¸å¿ƒæ€è·¯


**é›†æˆåŸç†**ï¼šåœ¨ç°æœ‰ç™»å½•æµç¨‹ä¸­**æ’å…¥éªŒè¯æ­¥éª¤**

```
åŸæ¥çš„ç™»å½•æµç¨‹ï¼š
ç”¨æˆ·è¾“å…¥è´¦å·å¯†ç  â†’ éªŒè¯è´¦å·å¯†ç  â†’ ç™»å½•æˆåŠŸ â†’ é¢å‘ä¼šè¯

åŠ å…¥MFAåçš„æµç¨‹ï¼š
ç”¨æˆ·è¾“å…¥è´¦å·å¯†ç  â†’ éªŒè¯è´¦å·å¯†ç  â†’ è¦æ±‚è¾“å…¥éªŒè¯ç  â†’ éªŒè¯æˆåŠŸ â†’ ç™»å½•æˆåŠŸ â†’ é¢å‘ä¼šè¯
```

**å…³é”®è®¾è®¡ç‚¹**ï¼š
- âœ… **æ¸è¿›å¼éªŒè¯**ï¼šå…ˆéªŒè¯å¯†ç ï¼Œå†éªŒè¯ç¬¬äºŒå› å­
- âœ… **çŠ¶æ€ç®¡ç†**ï¼šè®°å½•ç”¨æˆ·å®Œæˆäº†å“ªäº›éªŒè¯æ­¥éª¤  
- âœ… **å®‰å…¨æ€§**ï¼šéªŒè¯ç æœ‰æ—¶æ•ˆæ€§ï¼Œé˜²æ­¢é‡æ”¾æ”»å‡»
- âœ… **ç”¨æˆ·ä½“éªŒ**ï¼šæµç¨‹ç®€å•æ¸…æ™°ï¼Œå‡ºé”™æœ‰æ˜ç¡®æç¤º

### 1.3 MFAé›†æˆæ¶æ„å›¾


```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 MFAé›†æˆæ¶æ„                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å‰ç«¯ç•Œé¢                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ç™»å½•é¡µé¢ â”‚â†’ â”‚éªŒè¯ç é¡µ â”‚â†’ â”‚æˆåŠŸé¡µé¢ â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  åç«¯æœåŠ¡                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚è´¦å·éªŒè¯ â”‚â†’ â”‚MFAéªŒè¯  â”‚â†’ â”‚ä¼šè¯åˆ›å»º â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å¤–éƒ¨æœåŠ¡                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚  â”‚çŸ­ä¿¡æœåŠ¡ â”‚  â”‚é‚®ä»¶æœåŠ¡ â”‚                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸ”‘ ç™»å½•é€»è¾‘ä¸MFAç»“åˆæ–¹å¼


### 2.1 ä¼ ç»Ÿç™»å½• vs MFAç™»å½•å¯¹æ¯”


| **å¯¹æ¯”ç»´åº¦** | **ä¼ ç»Ÿç™»å½•** | **MFAç™»å½•** |
|-------------|-------------|-------------|
| **éªŒè¯æ­¥éª¤** | `1æ­¥ï¼šç”¨æˆ·å+å¯†ç ` | `2æ­¥ï¼šå¯†ç +éªŒè¯ç ` |
| **å®‰å…¨çº§åˆ«** | `ğŸŸ¡ ä¸­ç­‰` | `ğŸŸ¢ é«˜` |
| **ç”¨æˆ·ä½“éªŒ** | `ğŸŸ¢ ç®€å•å¿«æ·` | `ğŸŸ¡ ç•¥å¾®å¤æ‚` |
| **æŠ€æœ¯å¤æ‚åº¦** | `ğŸŸ¢ ç®€å•` | `ğŸŸ¡ ä¸­ç­‰` |
| **é˜²æ”»å‡»èƒ½åŠ›** | `ğŸ”´ å¯†ç æ³„éœ²å³å¤±æ•ˆ` | `ğŸŸ¢ éœ€è¦å¤šä¸ªå› å­` |

### 2.2 MFAç»“åˆçš„ä¸‰ç§æ—¶æœº


**ğŸ”¸ ç™»å½•æ—¶å¼ºåˆ¶MFA**
```
é€‚ç”¨åœºæ™¯ï¼šé“¶è¡Œç³»ç»Ÿã€ç®¡ç†åå°
ç”¨æˆ·ä½“éªŒï¼šæ¯æ¬¡ç™»å½•éƒ½éœ€è¦éªŒè¯ç 
å®‰å…¨çº§åˆ«ï¼šæœ€é«˜
```

**ğŸ”¸ æ•æ„Ÿæ“ä½œæ—¶MFA**  
```
é€‚ç”¨åœºæ™¯ï¼šæ”¯ä»˜ã€ä¿®æ”¹å¯†ç ã€åˆ é™¤æ•°æ®
ç”¨æˆ·ä½“éªŒï¼šæ—¥å¸¸ä½¿ç”¨ç®€å•ï¼Œå…³é”®æ—¶åˆ»éªŒè¯
å®‰å…¨çº§åˆ«ï¼šé«˜
```

**ğŸ”¸ å¯é€‰æ‹©æ€§MFA**
```
é€‚ç”¨åœºæ™¯ï¼šç¤¾äº¤è½¯ä»¶ã€æ™®é€šç½‘ç«™
ç”¨æˆ·ä½“éªŒï¼šç”¨æˆ·å¯ä»¥é€‰æ‹©å¼€å¯æˆ–å…³é—­
å®‰å…¨çº§åˆ«ï¼šä¸­ç­‰
```

### 2.3 ç™»å½•é€»è¾‘æ”¹é€ è¦ç‚¹


**æ ¸å¿ƒæ€è·¯**ï¼šæŠŠåŸæ¥çš„"ä¸€æ­¥åˆ°ä½"æ”¹æˆ"åˆ†æ­¥éªŒè¯"

**æ”¹é€ å‰çš„ç™»å½•é€»è¾‘**ï¼š
```java
// ä¼ ç»Ÿç™»å½•ï¼ˆä¼ªä»£ç ï¼‰
if (éªŒè¯ç”¨æˆ·åå¯†ç ()) {
    åˆ›å»ºä¼šè¯();
    return "ç™»å½•æˆåŠŸ";
}
return "ç™»å½•å¤±è´¥";
```

**æ”¹é€ åçš„ç™»å½•é€»è¾‘**ï¼š
```java
// MFAç™»å½•ï¼ˆä¼ªä»£ç ï¼‰
if (éªŒè¯ç”¨æˆ·åå¯†ç ()) {
    if (ç”¨æˆ·å¼€å¯äº†MFA()) {
        å‘é€éªŒè¯ç ();
        ä¿å­˜ä¸´æ—¶çŠ¶æ€("å¯†ç å·²éªŒè¯");
        return "è¯·è¾“å…¥éªŒè¯ç ";
    } else {
        åˆ›å»ºä¼šè¯();
        return "ç™»å½•æˆåŠŸ";
    }
}
return "å¯†ç é”™è¯¯";
```

**å…³é”®å˜åŒ–**ï¼š
- ğŸ”„ **çŠ¶æ€åˆ†ç¦»**ï¼šå¯†ç éªŒè¯ â‰  ç™»å½•æˆåŠŸ
- ğŸ“± **éªŒè¯ç å‘é€**ï¼šå¯†ç æ­£ç¡®åè§¦å‘
- ğŸ’¾ **ä¸´æ—¶çŠ¶æ€**ï¼šè®°å½•éªŒè¯è¿›åº¦
- ğŸ”’ **æ¡ä»¶ç™»å½•**ï¼šæ‰€æœ‰éªŒè¯é€šè¿‡æ‰ç®—æˆåŠŸ

---

## 3. ğŸª Session + MFA æµç¨‹è¯¦è§£


### 3.1 ä»€ä¹ˆæ˜¯Session + MFA


**Session**ï¼šæœåŠ¡å™¨ä¸ºç”¨æˆ·åˆ†é…çš„**ä¼šè¯æ ‡è¯†**ï¼Œåƒ"ä¸´æ—¶èº«ä»½è¯"

**Session + MFAçš„æ ¸å¿ƒæ€è·¯**ï¼š
- ç”¨æˆ·éªŒè¯å¯†ç åï¼Œç»™ä¸€ä¸ª"**åŠæˆå“Session**"
- éªŒè¯MFAåï¼ŒæŠŠ"åŠæˆå“"å˜æˆ"**æ­£å¼Session**"

### 3.2 Session + MFA è¯¦ç»†æµç¨‹


```
ç”¨æˆ·è¡Œä¸º                    æœåŠ¡å™¨è¡Œä¸º                     SessionçŠ¶æ€
   |                          |                            |
è¾“å…¥ç”¨æˆ·åå¯†ç  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ éªŒè¯è´¦å·å¯†ç                       |
   |                          |                            |
   |                    â”Œâ”€éªŒè¯æˆåŠŸâ”€â”                       |
   |                    â”‚         â”‚                       |
   |                    â–¼         â–¼                       |
   |              åˆ›å»ºä¸´æ—¶Session  å‘é€éªŒè¯ç               ä¸´æ—¶Session
   |                    â”‚         â”‚                   (auth_level: partial)
   |                    â–¼         â”‚                       |
æ”¶åˆ°"è¯·è¾“å…¥éªŒè¯ç "      è¿”å›SessionID      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   |                          â”‚                            |
è¾“å…¥éªŒè¯ç  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ éªŒè¯MFAç                        |
   |                          â”‚                            |
   |                    â”Œâ”€éªŒè¯æˆåŠŸâ”€â”                       |
   |                    â”‚         â”‚                       |
   |                    â–¼         â–¼                       |
   |              å‡çº§SessionçŠ¶æ€  è¿”å›æˆåŠŸ               æ­£å¼Session
   |                    â”‚         â”‚                   (auth_level: full)
   |                    â–¼         â”‚                       |
ç™»å½•æˆåŠŸ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å®Œæ•´æƒé™      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 SessionçŠ¶æ€è®¾è®¡


**ä¸´æ—¶Sessionï¼ˆéƒ¨åˆ†è®¤è¯ï¼‰**ï¼š
```java
Session {
    userId: "12345",
    authLevel: "partial",           // éƒ¨åˆ†è®¤è¯
    createTime: "2024-01-27 10:00", 
    expireTime: "2024-01-27 10:05", // 5åˆ†é’Ÿè¿‡æœŸ
    permissions: ["login_step2"]     // åªèƒ½è¿›è¡Œç¬¬äºŒæ­¥éªŒè¯
}
```

**æ­£å¼Sessionï¼ˆå®Œå…¨è®¤è¯ï¼‰**ï¼š
```java
Session {
    userId: "12345", 
    authLevel: "full",              // å®Œå…¨è®¤è¯
    createTime: "2024-01-27 10:02",
    expireTime: "2024-01-27 12:02", // 2å°æ—¶è¿‡æœŸ
    permissions: ["read", "write", "delete"] // å®Œæ•´æƒé™
}
```

### 3.4 Session + MFA ä»£ç ç¤ºä¾‹


```java
// ç¬¬ä¸€æ­¥ï¼šéªŒè¯ç”¨æˆ·åå¯†ç 
@PostMapping("/auth/login")
public ResponseEntity<?> login(@RequestBody LoginRequest request) {
    // éªŒè¯è´¦å·å¯†ç 
    if (!userService.validatePassword(request.getUsername(), request.getPassword())) {
        return ResponseEntity.badRequest().body("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
    }
    
    User user = userService.findByUsername(request.getUsername());
    
    // æ£€æŸ¥æ˜¯å¦å¼€å¯MFA
    if (user.isMfaEnabled()) {
        // åˆ›å»ºä¸´æ—¶Session
        String sessionId = sessionService.createPartialSession(user.getId());
        
        // å‘é€éªŒè¯ç 
        mfaService.sendSmsCode(user.getPhoneNumber());
        
        return ResponseEntity.ok(new LoginResponse(
            false,                    // ç™»å½•æœªå®Œæˆ
            "è¯·è¾“å…¥çŸ­ä¿¡éªŒè¯ç ",        
            sessionId,                // ä¸´æ—¶ä¼šè¯ID
            "need_mfa"               // éœ€è¦MFAéªŒè¯
        ));
    } else {
        // ç›´æ¥åˆ›å»ºæ­£å¼Session
        String sessionId = sessionService.createFullSession(user.getId());
        return ResponseEntity.ok(new LoginResponse(
            true,                    // ç™»å½•å®Œæˆ
            "ç™»å½•æˆåŠŸ",
            sessionId,               // æ­£å¼ä¼šè¯ID  
            "success"
        ));
    }
}

// ç¬¬äºŒæ­¥ï¼šéªŒè¯MFAç 
@PostMapping("/auth/verify-mfa")  
public ResponseEntity<?> verifyMfa(@RequestBody MfaRequest request) {
    // æ£€æŸ¥SessionçŠ¶æ€
    Session session = sessionService.getSession(request.getSessionId());
    if (session == null || !"partial".equals(session.getAuthLevel())) {
        return ResponseEntity.badRequest().body("ä¼šè¯æ— æ•ˆæˆ–å·²è¿‡æœŸ");
    }
    
    // éªŒè¯MFAç 
    if (!mfaService.validateCode(session.getUserId(), request.getCode())) {
        return ResponseEntity.badRequest().body("éªŒè¯ç é”™è¯¯");
    }
    
    // å‡çº§Sessionä¸ºå®Œå…¨è®¤è¯
    sessionService.upgradeToFullSession(request.getSessionId());
    
    return ResponseEntity.ok(new LoginResponse(
        true,                        // ç™»å½•å®Œæˆ
        "ç™»å½•æˆåŠŸ",
        request.getSessionId(),      // åŒä¸€ä¸ªä¼šè¯ID
        "success"
    ));
}
```

### 3.5 Session + MFA çš„ä¼˜ç¼ºç‚¹


**âœ… ä¼˜ç‚¹**ï¼š
- **çŠ¶æ€ç®¡ç†ç®€å•**ï¼šæœåŠ¡å™¨ç«¯ç»Ÿä¸€ç®¡ç†
- **å®‰å…¨æ€§é«˜**ï¼šSessionå­˜å‚¨åœ¨æœåŠ¡å™¨ï¼Œä¸æ˜“è¢«ç¯¡æ”¹
- **æƒé™æ§åˆ¶ç²¾ç¡®**ï¼šå¯ä»¥ç²¾ç¡®æ§åˆ¶éƒ¨åˆ†è®¤è¯ç”¨æˆ·çš„æƒé™

**âŒ ç¼ºç‚¹**ï¼š
- **æœåŠ¡å™¨å‹åŠ›**ï¼šéœ€è¦å­˜å‚¨å¤§é‡Sessionä¿¡æ¯
- **æ‰©å±•æ€§å·®**ï¼šå¤šæœåŠ¡å™¨éƒ¨ç½²æ—¶SessionåŒæ­¥å¤æ‚
- **ä¾èµ–Cookie**ï¼šç§»åŠ¨ç«¯APIæ”¯æŒä¸å¤Ÿå‹å¥½

---

## 4. ğŸ« Token + MFA æµç¨‹å®ç°


### 4.1 ä»€ä¹ˆæ˜¯Token + MFA


**Token**ï¼šä¸€ä¸ª**åŠ å¯†çš„å­—ç¬¦ä¸²**ï¼ŒåŒ…å«ç”¨æˆ·ä¿¡æ¯å’Œæƒé™ï¼Œåƒ"åŠ å¯†çš„èº«ä»½è¯"

**Token + MFAçš„æ ¸å¿ƒæ€è·¯**ï¼š
- ç”¨æˆ·éªŒè¯å¯†ç åï¼Œç»™ä¸€ä¸ª"**éƒ¨åˆ†æƒé™Token**"
- éªŒè¯MFAåï¼Œç»™ä¸€ä¸ª"**å®Œæ•´æƒé™Token**"

### 4.2 Token vs Session å¯¹æ¯”


| **ç‰¹æ€§** | **Sessionæ–¹å¼** | **Tokenæ–¹å¼** |
|---------|----------------|---------------|
| **å­˜å‚¨ä½ç½®** | `ğŸ–¥ï¸ æœåŠ¡å™¨å†…å­˜/æ•°æ®åº“` | `ğŸ“± å®¢æˆ·ç«¯ï¼ˆé€šå¸¸æ˜¯æµè§ˆå™¨ï¼‰` |
| **çŠ¶æ€ç®¡ç†** | `æœ‰çŠ¶æ€ï¼ˆæœåŠ¡å™¨è®°å½•ï¼‰` | `æ— çŠ¶æ€ï¼ˆTokenè‡ªåŒ…å«ï¼‰` |
| **æ‰©å±•æ€§** | `ğŸ”´ éœ€è¦SessionåŒæ­¥` | `ğŸŸ¢ å¤©ç„¶æ”¯æŒåˆ†å¸ƒå¼` |
| **å®‰å…¨é£é™©** | `ğŸŸ¡ SessionåŠ«æŒ` | `ğŸŸ¡ Tokenæ³„éœ²` |
| **ç§»åŠ¨ç«¯æ”¯æŒ** | `ğŸ”´ ä¾èµ–Cookie` | `ğŸŸ¢ åŸç”Ÿæ”¯æŒ` |

### 4.3 Token + MFA è¯¦ç»†æµç¨‹


```
ç”¨æˆ·è¡Œä¸º                    æœåŠ¡å™¨è¡Œä¸º                     TokençŠ¶æ€
   |                          |                            |
è¾“å…¥ç”¨æˆ·åå¯†ç  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ éªŒè¯è´¦å·å¯†ç                       |
   |                          |                            |
   |                    â”Œâ”€éªŒè¯æˆåŠŸâ”€â”                       |
   |                    â”‚         â”‚                       |
   |                    â–¼         â–¼                       |
   |              ç”Ÿæˆä¸´æ—¶Token   å‘é€éªŒè¯ç                ä¸´æ—¶Token
   |                    â”‚         â”‚                   (level: "partial")
   |                    â–¼         â”‚                       |
æ”¶åˆ°ä¸´æ—¶Token          è¿”å›Token   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   |                          â”‚                            |
æºå¸¦Tokenè¾“å…¥éªŒè¯ç  â”€â”€â”€â”€â†’ éªŒè¯Token+MFAç                  |
   |                          â”‚                            |
   |                    â”Œâ”€éªŒè¯æˆåŠŸâ”€â”                       |
   |                    â”‚         â”‚                       |
   |                    â–¼         â–¼                       |
   |              ç”Ÿæˆæ­£å¼Token   è¿”å›æˆåŠŸ               æ­£å¼Token  
   |                    â”‚         â”‚                   (level: "full")
   |                    â–¼         â”‚                       |
ç™»å½•æˆåŠŸ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å®Œæ•´æƒé™      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.4 JWT + MFA Tokenè®¾è®¡


**ä¸´æ—¶Tokenï¼ˆéƒ¨åˆ†è®¤è¯ï¼‰**ï¼š
```json
{
  "header": {
    "alg": "HS256",
    "typ": "JWT"
  },
  "payload": {
    "userId": "12345",
    "authLevel": "partial",        
    "permissions": ["mfa_verify"],  
    "exp": 1643284200,              
    "iat": 1643283900,              
    "step": "mfa_required"          
  }
}
```

**æ­£å¼Tokenï¼ˆå®Œå…¨è®¤è¯ï¼‰**ï¼š
```json
{
  "header": {
    "alg": "HS256", 
    "typ": "JWT"
  },
  "payload": {
    "userId": "12345",
    "authLevel": "full",           
    "permissions": ["read", "write", "delete"],
    "exp": 1643291100,             
    "iat": 1643284500,             
    "step": "completed"            
  }
}
```

### 4.5 Token + MFA ä»£ç ç¤ºä¾‹


```java
// JWT Tokenç”ŸæˆæœåŠ¡
@Service
public class JwtTokenService {
    
    // ç”Ÿæˆéƒ¨åˆ†è®¤è¯Token
    public String generatePartialToken(String userId) {
        Map<String, Object> claims = new HashMap<>();
        claims.put("userId", userId);
        claims.put("authLevel", "partial");
        claims.put("permissions", Arrays.asList("mfa_verify"));
        claims.put("step", "mfa_required");
        
        return JWT.create()
            .withPayload(claims)
            .withExpiresAt(new Date(System.currentTimeMillis() + 5 * 60 * 1000)) // 5åˆ†é’Ÿ
            .sign(Algorithm.HMAC256(jwtSecret));
    }
    
    // ç”Ÿæˆå®Œæ•´è®¤è¯Token
    public String generateFullToken(String userId) {
        Map<String, Object> claims = new HashMap<>();
        claims.put("userId", userId);
        claims.put("authLevel", "full");
        claims.put("permissions", Arrays.asList("read", "write", "delete"));
        claims.put("step", "completed");
        
        return JWT.create()
            .withPayload(claims)
            .withExpiresAt(new Date(System.currentTimeMillis() + 2 * 60 * 60 * 1000)) // 2å°æ—¶
            .sign(Algorithm.HMAC256(jwtSecret));
    }
}

// ç™»å½•æ§åˆ¶å™¨
@RestController
public class AuthController {
    
    // ç¬¬ä¸€æ­¥ï¼šéªŒè¯å¯†ç ï¼Œè¿”å›ä¸´æ—¶Token
    @PostMapping("/auth/login")
    public ResponseEntity<?> login(@RequestBody LoginRequest request) {
        if (!userService.validatePassword(request.getUsername(), request.getPassword())) {
            return ResponseEntity.badRequest().body("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
        }
        
        User user = userService.findByUsername(request.getUsername());
        
        if (user.isMfaEnabled()) {
            // ç”Ÿæˆä¸´æ—¶Token
            String partialToken = jwtTokenService.generatePartialToken(user.getId());
            
            // å‘é€éªŒè¯ç 
            mfaService.sendSmsCode(user.getPhoneNumber());
            
            return ResponseEntity.ok(Map.of(
                "success", false,
                "message", "è¯·è¾“å…¥çŸ­ä¿¡éªŒè¯ç ", 
                "token", partialToken,
                "step", "mfa_required"
            ));
        } else {
            // ç›´æ¥ç”Ÿæˆå®Œæ•´Token
            String fullToken = jwtTokenService.generateFullToken(user.getId());
            return ResponseEntity.ok(Map.of(
                "success", true,
                "message", "ç™»å½•æˆåŠŸ",
                "token", fullToken,
                "step", "completed"
            ));
        }
    }
    
    // ç¬¬äºŒæ­¥ï¼šéªŒè¯MFAï¼Œè¿”å›å®Œæ•´Token
    @PostMapping("/auth/verify-mfa")
    public ResponseEntity<?> verifyMfa(
            @RequestHeader("Authorization") String token,
            @RequestBody MfaRequest request) {
        
        // éªŒè¯ä¸´æ—¶Token
        DecodedJWT decodedJWT = jwtTokenService.validateToken(token);
        if (decodedJWT == null || !"partial".equals(decodedJWT.getClaim("authLevel").asString())) {
            return ResponseEntity.badRequest().body("Tokenæ— æ•ˆæˆ–å·²è¿‡æœŸ");
        }
        
        String userId = decodedJWT.getClaim("userId").asString();
        
        // éªŒè¯MFAç 
        if (!mfaService.validateCode(userId, request.getCode())) {
            return ResponseEntity.badRequest().body("éªŒè¯ç é”™è¯¯");
        }
        
        // ç”Ÿæˆå®Œæ•´Token
        String fullToken = jwtTokenService.generateFullToken(userId);
        
        return ResponseEntity.ok(Map.of(
            "success", true,
            "message", "ç™»å½•æˆåŠŸ", 
            "token", fullToken,
            "step", "completed"
        ));
    }
}
```

### 4.6 Token + MFA çš„ä¼˜ç¼ºç‚¹


**âœ… ä¼˜ç‚¹**ï¼š
- **æ— çŠ¶æ€**ï¼šæœåŠ¡å™¨ä¸éœ€è¦å­˜å‚¨ä¼šè¯ä¿¡æ¯
- **æ‰©å±•æ€§å¥½**ï¼šå¤©ç„¶æ”¯æŒåˆ†å¸ƒå¼å’Œè´Ÿè½½å‡è¡¡
- **ç§»åŠ¨ç«¯å‹å¥½**ï¼šä¸ä¾èµ–Cookieï¼ŒAPIè°ƒç”¨æ–¹ä¾¿
- **è·¨åŸŸæ”¯æŒ**ï¼šTokenå¯ä»¥åœ¨ä¸åŒåŸŸä¹‹é—´ä¼ é€’

**âŒ ç¼ºç‚¹**ï¼š
- **Tokenæ’¤é”€å›°éš¾**ï¼šæ— æ³•ä¸»åŠ¨è®©Tokenå¤±æ•ˆï¼ˆé™¤éç»´æŠ¤é»‘åå•ï¼‰
- **Tokenæ³„éœ²é£é™©**ï¼šå¦‚æœTokenè¢«ç›—ï¼Œåœ¨è¿‡æœŸå‰éƒ½æœ‰æ•ˆ
- **è½½è·é™åˆ¶**ï¼šTokenä¸å®œå­˜å‚¨å¤§é‡ä¿¡æ¯

---

## 5. ğŸ”— APIè®¾è®¡ä¸æ¥å£å®‰å…¨


### 5.1 MFAç›¸å…³APIè®¾è®¡åŸåˆ™


**APIè®¾è®¡æ ¸å¿ƒæ€è·¯**ï¼š
- ğŸ“± **RESTfulé£æ ¼**ï¼šURLè¯­ä¹‰åŒ–ï¼ŒHTTPçŠ¶æ€ç è§„èŒƒ
- ğŸ”’ **å®‰å…¨ç¬¬ä¸€**ï¼šæ‰€æœ‰æ•æ„Ÿæ“ä½œéƒ½è¦éªŒè¯
- ğŸ¯ **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªAPIåªåšä¸€ä»¶äº‹
- ğŸ’¡ **ç”¨æˆ·å‹å¥½**ï¼šè¿”å›ä¿¡æ¯æ¸…æ™°æ˜ç¡®

### 5.2 æ ¸å¿ƒAPIæ¥å£è®¾è®¡


**ğŸ”¸ `/auth/login` - ç¬¬ä¸€æ­¥ç™»å½•**

```http
POST /auth/login
Content-Type: application/json

è¯·æ±‚ä½“ï¼š
{
    "username": "user@example.com",
    "password": "mypassword123",
    "deviceInfo": {                    // å¯é€‰ï¼šè®¾å¤‡ä¿¡æ¯
        "userAgent": "Mozilla/5.0...",
        "ipAddress": "192.168.1.100"
    }
}

æˆåŠŸå“åº”ï¼ˆéœ€è¦MFAï¼‰ï¼š
{
    "success": false,
    "message": "è¯·è¾“å…¥çŸ­ä¿¡éªŒè¯ç ",
    "data": {
        "sessionId": "sess_abc123",     // Sessionæ–¹å¼
        "token": "eyJhbGciOi...",      // æˆ–Tokenæ–¹å¼
        "step": "mfa_required",
        "mfaType": "sms",              // sms/email/totp
        "expiresIn": 300,              // 5åˆ†é’Ÿè¿‡æœŸ
        "maskedPhone": "138****5678"   // è„±æ•æ˜¾ç¤º
    }
}

æˆåŠŸå“åº”ï¼ˆæ— éœ€MFAï¼‰ï¼š
{
    "success": true, 
    "message": "ç™»å½•æˆåŠŸ",
    "data": {
        "sessionId": "sess_def456",
        "token": "eyJhbGciOi...",
        "step": "completed",
        "user": {
            "id": "12345",
            "username": "user@example.com",
            "roles": ["user"]
        }
    }
}

å¤±è´¥å“åº”ï¼š
{
    "success": false,
    "message": "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯",
    "error": "INVALID_CREDENTIALS",
    "data": null
}
```

**ğŸ”¸ `/auth/verify` - ç¬¬äºŒæ­¥MFAéªŒè¯**

```http  
POST /auth/verify
Content-Type: application/json
Authorization: Bearer eyJhbGciOi...  // ä¸´æ—¶Tokenæˆ–SessionID

è¯·æ±‚ä½“ï¼š
{
    "code": "123456",                   // éªŒè¯ç 
    "type": "sms",                      // éªŒè¯ç±»å‹
    "sessionId": "sess_abc123"          // Sessionæ–¹å¼éœ€è¦
}

æˆåŠŸå“åº”ï¼š
{
    "success": true,
    "message": "éªŒè¯æˆåŠŸ",
    "data": {
        "token": "eyJhbGciOi...",      // å®Œæ•´æƒé™Token
        "sessionId": "sess_abc123",     // å‡çº§åçš„Session
        "step": "completed",
        "user": {
            "id": "12345", 
            "username": "user@example.com",
            "roles": ["user"]
        }
    }
}

å¤±è´¥å“åº”ï¼š
{
    "success": false,
    "message": "éªŒè¯ç é”™è¯¯æˆ–å·²è¿‡æœŸ",
    "error": "INVALID_MFA_CODE",
    "data": {
        "remainingAttempts": 2,         // å‰©ä½™å°è¯•æ¬¡æ•°
        "nextRetryTime": 1643284800     // ä¸‹æ¬¡é‡è¯•æ—¶é—´
    }
}
```

### 5.3 è¾…åŠ©APIè®¾è®¡


**ğŸ”¸ é‡å‘éªŒè¯ç **
```http
POST /auth/resend-code
Authorization: Bearer eyJhbGciOi...

{
    "type": "sms",
    "sessionId": "sess_abc123"
}
```

**ğŸ”¸ æ£€æŸ¥è®¤è¯çŠ¶æ€**
```http
GET /auth/status  
Authorization: Bearer eyJhbGciOi...

å“åº”ï¼š
{
    "authenticated": true,
    "authLevel": "partial",      // partial/full
    "step": "mfa_required",      // mfa_required/completed
    "expiresAt": 1643284800
}
```

**ğŸ”¸ é€€å‡ºç™»å½•**
```http
POST /auth/logout
Authorization: Bearer eyJhbGciOi...

{
    "success": true,
    "message": "å·²å®‰å…¨é€€å‡º"
}
```

### 5.4 APIå®‰å…¨é˜²æŠ¤æªæ–½


**ğŸ›¡ï¸ é¢‘ç‡é™åˆ¶ï¼ˆRate Limitingï¼‰**
```java
// é™åˆ¶ç™»å½•å°è¯•æ¬¡æ•°
@RateLimiter(key = "login:#{request.clientIp}", 
            rate = "5/minute")
public ResponseEntity<?> login(HttpServletRequest request, @RequestBody LoginRequest loginRequest) {
    // ç™»å½•é€»è¾‘
}

// é™åˆ¶éªŒè¯ç å‘é€é¢‘ç‡  
@RateLimiter(key = "sms:#{userId}", 
            rate = "3/minute")
public void sendSmsCode(String userId) {
    // å‘é€çŸ­ä¿¡é€»è¾‘
}
```

**ğŸ”’ è¾“å…¥éªŒè¯ä¸è¿‡æ»¤**
```java
public class LoginRequest {
    @NotBlank(message = "ç”¨æˆ·åä¸èƒ½ä¸ºç©º")
    @Email(message = "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®") 
    private String username;
    
    @NotBlank(message = "å¯†ç ä¸èƒ½ä¸ºç©º")
    @Size(min = 6, max = 50, message = "å¯†ç é•¿åº¦6-50ä½")
    private String password;
    
    // getters/setters...
}
```

**ğŸ• æ—¶é—´çª—å£æ§åˆ¶**
```java
// éªŒè¯ç 5åˆ†é’Ÿè¿‡æœŸ
private static final long MFA_CODE_EXPIRE_TIME = 5 * 60 * 1000;

// ç™»å½•ä¼šè¯30åˆ†é’Ÿè¿‡æœŸ
private static final long SESSION_EXPIRE_TIME = 30 * 60 * 1000;

// Token 2å°æ—¶è¿‡æœŸ
private static final long TOKEN_EXPIRE_TIME = 2 * 60 * 60 * 1000;
```

### 5.5 é”™è¯¯å¤„ç†ä¸å“åº”ç 


| **HTTPçŠ¶æ€ç ** | **ä¸šåŠ¡åœºæ™¯** | **è¯´æ˜** |
|---------------|-------------|----------|
| `200 OK` | `ç™»å½•æˆåŠŸã€éªŒè¯æˆåŠŸ` | `æ­£å¸¸å®Œæˆæ“ä½œ` |
| `400 Bad Request` | `å‚æ•°é”™è¯¯ã€éªŒè¯ç é”™è¯¯` | `å®¢æˆ·ç«¯è¯·æ±‚æœ‰è¯¯` |
| `401 Unauthorized` | `å¯†ç é”™è¯¯ã€Tokenæ— æ•ˆ` | `è®¤è¯å¤±è´¥` |
| `403 Forbidden` | `è´¦å·è¢«é”å®šã€æƒé™ä¸è¶³` | `æœ‰èº«ä»½ä½†æ— æƒé™` |
| `429 Too Many Requests` | `é¢‘ç‡é™åˆ¶è§¦å‘` | `è¯·æ±‚è¿‡äºé¢‘ç¹` |
| `500 Internal Server Error` | `æœåŠ¡å™¨å¼‚å¸¸` | `å†…éƒ¨é”™è¯¯` |

---

## 6. ğŸ–¥ï¸ å‰åç«¯äº¤äº’å®ç°


### 6.1 å‰ç«¯äº¤äº’æµç¨‹è®¾è®¡


**æ ¸å¿ƒæ€è·¯**ï¼šæŠŠå¤æ‚çš„è®¤è¯æµç¨‹ï¼Œåšæˆ**ç®€å•æ˜“æ‡‚çš„ç”¨æˆ·ç•Œé¢**

```
ç”¨æˆ·çœ‹åˆ°çš„ç•Œé¢æµç¨‹ï¼š
ç™»å½•é¡µé¢ â†’ [è¾“å…¥è´¦å·å¯†ç ] â†’ [ç‚¹å‡»ç™»å½•] â†’ éªŒè¯ç é¡µé¢ â†’ [è¾“å…¥éªŒè¯ç ] â†’ [ç‚¹å‡»éªŒè¯] â†’ æˆåŠŸé¡µé¢

å‰ç«¯å®é™…çš„æŠ€æœ¯æµç¨‹ï¼š  
è°ƒç”¨ç™»å½•API â†’ è§£æè¿”å›ç»“æœ â†’ æ˜¾ç¤ºéªŒè¯ç è¾“å…¥æ¡† â†’ è°ƒç”¨éªŒè¯API â†’ å­˜å‚¨Token â†’ è·³è½¬ä¸»é¡µ
```

### 6.2 å‰ç«¯çŠ¶æ€ç®¡ç†


**è®¤è¯çŠ¶æ€ï¼ˆAuth Stateï¼‰**ï¼š
```javascript
// å‰ç«¯çŠ¶æ€ç®¡ç†ï¼ˆä¾‹å¦‚ï¼šVuex/Reduxï¼‰
const authState = {
    // è®¤è¯çŠ¶æ€
    isAuthenticated: false,           // æ˜¯å¦å·²è®¤è¯  
    authLevel: null,                  // 'partial' | 'full' | null
    currentStep: 'login',            // 'login' | 'mfa' | 'completed'
    
    // Token/Sessionç®¡ç†
    token: null,                     // JWT Token
    sessionId: null,                 // Session ID
    tokenExpireTime: null,           // Tokenè¿‡æœŸæ—¶é—´
    
    // ç”¨æˆ·ä¿¡æ¯
    user: null,                      // ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
    permissions: [],                 // ç”¨æˆ·æƒé™åˆ—è¡¨
    
    // MFAç›¸å…³
    mfaType: null,                   // 'sms' | 'email' | 'totp'  
    maskedPhone: null,               // è„±æ•æ‰‹æœºå·
    codeExpireTime: null,            // éªŒè¯ç è¿‡æœŸæ—¶é—´
    
    // UIçŠ¶æ€
    loading: false,                  // åŠ è½½çŠ¶æ€
    error: null                      // é”™è¯¯ä¿¡æ¯
};
```

### 6.3 å‰ç«¯æ ¸å¿ƒäº¤äº’ä»£ç 


**ğŸ”¸ ç™»å½•é¡µé¢ç»„ä»¶**
```vue
<template>
  <div class="login-container">
    <!-- ç¬¬ä¸€æ­¥ï¼šè´¦å·å¯†ç ç™»å½• -->
    <div v-if="currentStep === 'login'" class="login-form">
      <h2>ç”¨æˆ·ç™»å½•</h2>
      <form @submit.prevent="handleLogin">
        <input 
          v-model="loginForm.username" 
          type="email" 
          placeholder="é‚®ç®±"
          required 
        />
        <input 
          v-model="loginForm.password" 
          type="password" 
          placeholder="å¯†ç "
          required 
        />
        <button type="submit" :disabled="loading">
          {{ loading ? 'ç™»å½•ä¸­...' : 'ç™»å½•' }}
        </button>
      </form>
      <div v-if="error" class="error">{{ error }}</div>
    </div>
    
    <!-- ç¬¬äºŒæ­¥ï¼šMFAéªŒè¯ -->
    <div v-if="currentStep === 'mfa'" class="mfa-form">
      <h2>å®‰å…¨éªŒè¯</h2>
      <p>éªŒè¯ç å·²å‘é€åˆ° {{ maskedPhone }}</p>
      <form @submit.prevent="handleMfaVerify">
        <input 
          v-model="mfaForm.code" 
          type="text" 
          placeholder="è¯·è¾“å…¥6ä½éªŒè¯ç "
          maxlength="6"
          required 
        />
        <button type="submit" :disabled="loading">
          {{ loading ? 'éªŒè¯ä¸­...' : 'éªŒè¯' }}
        </button>
      </form>
      <button @click="resendCode" :disabled="resendCountdown > 0">
        {{ resendCountdown > 0 ? `${resendCountdown}ç§’åé‡å‘` : 'é‡æ–°å‘é€' }}
      </button>
      <div v-if="error" class="error">{{ error }}</div>
    </div>
  </div>
</template>

<script>
export default {
  data() {
    return {
      currentStep: 'login',         // å½“å‰æ­¥éª¤
      loading: false,               // åŠ è½½çŠ¶æ€
      error: null,                  // é”™è¯¯ä¿¡æ¯
      
      loginForm: {                  // ç™»å½•è¡¨å•
        username: '',
        password: ''
      },
      
      mfaForm: {                    // MFAè¡¨å•
        code: ''
      },
      
      tempToken: null,              // ä¸´æ—¶Token
      maskedPhone: null,            // è„±æ•æ‰‹æœºå·
      resendCountdown: 0            // é‡å‘å€’è®¡æ—¶
    };
  },
  
  methods: {
    // å¤„ç†ç™»å½•
    async handleLogin() {
      this.loading = true;
      this.error = null;
      
      try {
        const response = await fetch('/auth/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(this.loginForm)
        });
        
        const result = await response.json();
        
        if (result.success) {
          // ç™»å½•æˆåŠŸï¼ˆæ— éœ€MFAï¼‰
          this.saveAuthInfo(result.data);
          this.$router.push('/dashboard');
        } else if (result.data && result.data.step === 'mfa_required') {
          // éœ€è¦MFAéªŒè¯
          this.currentStep = 'mfa';
          this.tempToken = result.data.token;
          this.maskedPhone = result.data.maskedPhone;
          this.startResendCountdown();
        } else {
          // ç™»å½•å¤±è´¥
          this.error = result.message;
        }
      } catch (err) {
        this.error = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•';
      } finally {
        this.loading = false;
      }
    },
    
    // å¤„ç†MFAéªŒè¯
    async handleMfaVerify() {
      this.loading = true;
      this.error = null;
      
      try {
        const response = await fetch('/auth/verify', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${this.tempToken}`
          },
          body: JSON.stringify({
            code: this.mfaForm.code,
            type: 'sms'
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          // MFAéªŒè¯æˆåŠŸ
          this.saveAuthInfo(result.data);
          this.$router.push('/dashboard');
        } else {
          // éªŒè¯å¤±è´¥
          this.error = result.message;
          this.mfaForm.code = ''; // æ¸…ç©ºè¾“å…¥æ¡†
        }
      } catch (err) {
        this.error = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•';
      } finally {
        this.loading = false;
      }
    },
    
    // é‡å‘éªŒè¯ç 
    async resendCode() {
      try {
        await fetch('/auth/resend-code', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${this.tempToken}`
          },
          body: JSON.stringify({
            type: 'sms'
          })
        });
        
        this.startResendCountdown();
      } catch (err) {
        this.error = 'é‡å‘å¤±è´¥ï¼Œè¯·é‡è¯•';
      }
    },
    
    // ä¿å­˜è®¤è¯ä¿¡æ¯
    saveAuthInfo(data) {
      // å­˜å‚¨åˆ°localStorageæˆ–Vuex
      localStorage.setItem('token', data.token);
      localStorage.setItem('user', JSON.stringify(data.user));
      
      // æ›´æ–°å…¨å±€çŠ¶æ€
      this.$store.commit('auth/setAuthInfo', {
        isAuthenticated: true,
        authLevel: 'full',
        token: data.token,
        user: data.user
      });
    },
    
    // é‡å‘å€’è®¡æ—¶
    startResendCountdown() {
      this.resendCountdown = 60;
      const timer = setInterval(() => {
        this.resendCountdown--;
        if (this.resendCountdown <= 0) {
          clearInterval(timer);
        }
      }, 1000);
    }
  }
};
</script>
```

### 6.4 å‰ç«¯é”™è¯¯å¤„ç†ä¸ç”¨æˆ·æç¤º


**é”™è¯¯å¤„ç†ç­–ç•¥**ï¼š
```javascript
// ç»Ÿä¸€é”™è¯¯å¤„ç†å‡½æ•°
function handleAuthError(error, errorCode) {
    const errorMessages = {
        'INVALID_CREDENTIALS': 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯',
        'INVALID_MFA_CODE': 'éªŒè¯ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥',  
        'CODE_EXPIRED': 'éªŒè¯ç å·²è¿‡æœŸï¼Œè¯·é‡æ–°è·å–',
        'ACCOUNT_LOCKED': 'è´¦å·å·²è¢«é”å®šï¼Œè¯·è”ç³»ç®¡ç†å‘˜',
        'TOO_MANY_REQUESTS': 'æ“ä½œè¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•'
    };
    
    return errorMessages[errorCode] || error || 'æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•';
}

// ç”¨æˆ·å‹å¥½çš„æç¤ºä¿¡æ¯
const userMessages = {
    'mfa_sent': 'éªŒè¯ç å·²å‘é€ï¼Œè¯·æŸ¥æ”¶çŸ­ä¿¡',
    'mfa_success': 'éªŒè¯æˆåŠŸï¼Œæ­£åœ¨è·³è½¬...',
    'login_success': 'ç™»å½•æˆåŠŸï¼Œæ¬¢è¿å›æ¥ï¼',
    'network_error': 'ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•'
};
```

### 6.5 å‰ç«¯å®‰å…¨è€ƒè™‘


**ğŸ”’ Tokenå­˜å‚¨å®‰å…¨**ï¼š
```javascript
// âŒ ä¸å®‰å…¨ï¼šç›´æ¥å­˜localStorage
localStorage.setItem('token', token);

// âœ… æ›´å®‰å…¨ï¼šåŠ ä¸Šè¿‡æœŸæ—¶é—´æ£€æŸ¥
function saveToken(token, expiresIn) {
    const tokenData = {
        token: token,
        expiresAt: Date.now() + (expiresIn * 1000)
    };
    localStorage.setItem('authToken', JSON.stringify(tokenData));
}

function getValidToken() {
    const tokenData = localStorage.getItem('authToken');
    if (!tokenData) return null;
    
    const { token, expiresAt } = JSON.parse(tokenData);
    
    // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
    if (Date.now() > expiresAt) {
        localStorage.removeItem('authToken');
        return null;
    }
    
    return token;
}
```

**ğŸ”„ è‡ªåŠ¨Tokenåˆ·æ–°**ï¼š
```javascript  
// HTTPæ‹¦æˆªå™¨ï¼Œè‡ªåŠ¨å¤„ç†Tokenè¿‡æœŸ
axios.interceptors.response.use(
    response => response,
    async error => {
        if (error.response?.status === 401) {
            // Tokenè¿‡æœŸï¼Œæ¸…é™¤æœ¬åœ°å­˜å‚¨å¹¶è·³è½¬åˆ°ç™»å½•é¡µ
            localStorage.removeItem('authToken');
            window.location.href = '/login';
        }
        return Promise.reject(error);
    }
);
```

---

## 7. ğŸ“š å¸¸ç”¨å¼€å‘åº“ä»‹ç»


### 7.1 JavaæŠ€æœ¯æ ˆ


**ğŸƒ Spring Security + JWT**
```xml
<!-- Mavenä¾èµ– -->
<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-security</artifactId>
    </dependency>
    <dependency>
        <groupId>com.auth0</groupId>
        <artifactId>java-jwt</artifactId>
        <version>4.2.1</version>
    </dependency>
    <dependency>
        <groupId>com.warrenstrange</groupId>
        <artifactId>googleauth</artifactId>
        <version>1.5.0</version>
    </dependency>
</dependencies>
```

**æ ¸å¿ƒä»£ç ç¤ºä¾‹**ï¼š
```java
// JWTå·¥å…·ç±»
@Component
public class JwtUtil {
    @Value("${jwt.secret}")
    private String secret;
    
    public String generateToken(String userId, String authLevel) {
        return JWT.create()
            .withSubject(userId)
            .withClaim("authLevel", authLevel)
            .withExpiresAt(new Date(System.currentTimeMillis() + 3600000)) // 1å°æ—¶
            .sign(Algorithm.HMAC256(secret));
    }
    
    public DecodedJWT validateToken(String token) {
        try {
            return JWT.require(Algorithm.HMAC256(secret))
                .build()
                .verify(token);
        } catch (Exception e) {
            return null;
        }
    }
}

// TOTPå·¥å…·ç±»ï¼ˆGoogle Authenticatorï¼‰
@Component  
public class TotpUtil {
    public String generateSecretKey() {
        final GoogleAuthenticator gAuth = new GoogleAuthenticator();
        final GoogleAuthenticatorKey key = gAuth.createCredentials();
        return key.getKey();
    }
    
    public boolean validateCode(String secretKey, int code) {
        final GoogleAuthenticator gAuth = new GoogleAuthenticator();
        return gAuth.authorize(secretKey, code);
    }
}
```

### 7.2 PythonæŠ€æœ¯æ ˆ


**ğŸ Django + PyJWT + pyotp**
```bash
# å®‰è£…ä¾èµ–
pip install django
pip install PyJWT  
pip install pyotp
pip install qrcode
```

**æ ¸å¿ƒä»£ç ç¤ºä¾‹**ï¼š
```python
import jwt
import pyotp
import qrcode
from datetime import datetime, timedelta

# JWTå·¥å…·ç±»
class JWTUtil:
    def __init__(self, secret_key):
        self.secret_key = secret_key
    
    def generate_token(self, user_id, auth_level):
        payload = {
            'user_id': user_id,
            'auth_level': auth_level,
            'exp': datetime.utcnow() + timedelta(hours=1),
            'iat': datetime.utcnow()
        }
        return jwt.encode(payload, self.secret_key, algorithm='HS256')
    
    def validate_token(self, token):
        try:
            return jwt.decode(token, self.secret_key, algorithms=['HS256'])
        except:
            return None

# TOTPå·¥å…·ç±»
class TOTPUtil:
    @staticmethod
    def generate_secret():
        return pyotp.random_base32()
    
    @staticmethod
    def generate_qr_code(secret, user_email, issuer_name):
        totp_uri = pyotp.totp.TOTP(secret).provisioning_uri(
            name=user_email,
            issuer_name=issuer_name
        )
        
        qr = qrcode.QRCode(version=1, box_size=10, border=5)
        qr.add_data(totp_uri)
        qr.make(fit=True)
        
        return qr.make_image(fill_color="black", back_color="white")
    
    @staticmethod
    def validate_code(secret, code):
        totp = pyotp.TOTP(secret)
        return totp.verify(code)

# Djangoè§†å›¾ç¤ºä¾‹
from django.http import JsonResponse
from django.views.decorators.csrf import csrf_exempt
import json

@csrf_exempt
def login_view(request):
    if request.method == 'POST':
        data = json.loads(request.body)
        username = data.get('username')
        password = data.get('password')
        
        # éªŒè¯ç”¨æˆ·å¯†ç 
        user = authenticate_user(username, password)
        if not user:
            return JsonResponse({'success': False, 'message': 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯'})
        
        # æ£€æŸ¥æ˜¯å¦å¯ç”¨MFA
        if user.mfa_enabled:
            # ç”Ÿæˆä¸´æ—¶token
            jwt_util = JWTUtil(settings.SECRET_KEY)
            partial_token = jwt_util.generate_token(user.id, 'partial')
            
            # å‘é€éªŒè¯ç 
            send_sms_code(user.phone_number)
            
            return JsonResponse({
                'success': False,
                'message': 'è¯·è¾“å…¥çŸ­ä¿¡éªŒè¯ç ',
                'token': partial_token,
                'step': 'mfa_required'
            })
        else:
            # ç”Ÿæˆå®Œæ•´token
            full_token = jwt_util.generate_token(user.id, 'full')
            return JsonResponse({
                'success': True,
                'message': 'ç™»å½•æˆåŠŸ',
                'token': full_token
            })
```

### 7.3 Node.jsæŠ€æœ¯æ ˆ


**ğŸŸ¢ Express + jsonwebtoken + speakeasy**
```bash
# å®‰è£…ä¾èµ–
npm install express
npm install jsonwebtoken
npm install speakeasy  
npm install qrcode
npm install bcrypt
```

**æ ¸å¿ƒä»£ç ç¤ºä¾‹**ï¼š
```javascript
const jwt = require('jsonwebtoken');
const speakeasy = require('speakeasy');  
const QRCode = require('qrcode');
const bcrypt = require('bcrypt');

// JWTå·¥å…·ç±»
class JWTUtil {
    constructor(secretKey) {
        this.secretKey = secretKey;
    }
    
    generateToken(userId, authLevel, expiresIn = '1h') {
        return jwt.sign(
            { 
                userId, 
                authLevel,
                iat: Math.floor(Date.now() / 1000)
            },
            this.secretKey,
            { expiresIn }
        );
    }
    
    validateToken(token) {
        try {
            return jwt.verify(token, this.secretKey);
        } catch (error) {
            return null;
        }
    }
}

// TOTPå·¥å…·ç±»
class TOTPUtil {
    static generateSecret() {
        return speakeasy.generateSecret({
            name: 'My App',
            length: 20
        });
    }
    
    static async generateQRCode(secret, userEmail, issuer) {
        const otpauthUrl = speakeasy.otpauthURL({
            secret: secret,
            label: userEmail,
            issuer: issuer,
            encoding: 'base32'
        });
        
        return await QRCode.toDataURL(otpauthUrl);
    }
    
    static validateCode(secret, code) {
        return speakeasy.totp.verify({
            secret: secret,
            encoding: 'base32',
            token: code,
            window: 1  // å…è®¸å‰å30ç§’çš„æ—¶é—´è¯¯å·®
        });
    }
}

// Expressè·¯ç”±ç¤ºä¾‹
const express = require('express');
const app = express();
const jwtUtil = new JWTUtil(process.env.JWT_SECRET);

app.use(express.json());

// ç™»å½•æ¥å£
app.post('/auth/login', async (req, res) => {
    const { username, password } = req.body;
    
    try {
        // éªŒè¯ç”¨æˆ·å¯†ç 
        const user = await User.findOne({ username });
        if (!user || !await bcrypt.compare(password, user.passwordHash)) {
            return res.status(400).json({
                success: false,
                message: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯'
            });
        }
        
        // æ£€æŸ¥MFA
        if (user.mfaEnabled) {
            // ç”Ÿæˆä¸´æ—¶token
            const partialToken = jwtUtil.generateToken(user.id, 'partial', '5m');
            
            // å‘é€çŸ­ä¿¡éªŒè¯ç 
            await sendSmsCode(user.phoneNumber);
            
            return res.json({
                success: false,
                message: 'è¯·è¾“å…¥çŸ­ä¿¡éªŒè¯ç ',
                data: {
                    token: partialToken,
                    step: 'mfa_required',
                    maskedPhone: maskPhoneNumber(user.phoneNumber)
                }
            });
        } else {
            // ç›´æ¥ç™»å½•æˆåŠŸ
            const fullToken = jwtUtil.generateToken(user.id, 'full');
            return res.json({
                success: true,
                message: 'ç™»å½•æˆåŠŸ',
                data: {
                    token: fullToken,
                    user: {
                        id: user.id,
                        username: user.username
                    }
                }
            });
        }
    } catch (error) {
        return res.status(500).json({
            success: false,
            message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
        });
    }
});

// MFAéªŒè¯æ¥å£
app.post('/auth/verify', async (req, res) => {
    const { code } = req.body;
    const token = req.headers.authorization?.replace('Bearer ', '');
    
    try {
        // éªŒè¯ä¸´æ—¶token
        const decoded = jwtUtil.validateToken(token);
        if (!decoded || decoded.authLevel !== 'partial') {
            return res.status(401).json({
                success: false,
                message: 'Tokenæ— æ•ˆæˆ–å·²è¿‡æœŸ'
            });
        }
        
        // éªŒè¯MFAç 
        const user = await User.findById(decoded.userId);
        const isValidCode = await validateSmsCode(user.phoneNumber, code);
        
        if (!isValidCode) {
            return res.status(400).json({
                success: false,
                message: 'éªŒè¯ç é”™è¯¯'
            });
        }
        
        // ç”Ÿæˆå®Œæ•´token
        const fullToken = jwtUtil.generateToken(user.id, 'full');
        
        return res.json({
            success: true,
            message: 'éªŒè¯æˆåŠŸ',
            data: {
                token: fullToken,
                user: {
                    id: user.id,
                    username: user.username
                }
            }
        });
    } catch (error) {
        return res.status(500).json({
            success: false,
            message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
        });
    }
});
```

### 7.4 å¼€å‘åº“é€‰æ‹©å»ºè®®


| **è¯­è¨€** | **JWTåº“** | **TOTPåº“** | **äºŒç»´ç ç”Ÿæˆ** | **çŸ­ä¿¡æœåŠ¡** |
|---------|-----------|-----------|-------------|-------------|
| **Java** | `java-jwt` | `GoogleAuthenticator` | `ZXing` | `é˜¿é‡Œäº‘SMS` |
| **Python** | `PyJWT` | `pyotp` | `qrcode` | `è…¾è®¯äº‘SMS` |  
| **Node.js** | `jsonwebtoken` | `speakeasy` | `qrcode` | `Twilio` |
| **PHP** | `firebase/jwt` | `spomky-labs/otphp` | `endroid/qr-code` | `yunpian` |
| **C#** | `System.IdentityModel.Tokens.Jwt` | `OtpNet` | `QRCoder` | `åä¿¡çŸ­ä¿¡` |

**é€‰æ‹©å»ºè®®**ï¼š
- ğŸ”¥ **æˆç†Ÿç¨³å®š**ï¼šä¼˜å…ˆé€‰æ‹©ç¤¾åŒºæ´»è·ƒã€æ–‡æ¡£å®Œå–„çš„åº“
- ğŸ›¡ï¸ **å®‰å…¨æ€§**ï¼šé€‰æ‹©ç»è¿‡å®‰å…¨å®¡è®¡ã€å®šæœŸæ›´æ–°çš„åº“
- âš¡ **æ€§èƒ½**ï¼šè€ƒè™‘åº“çš„æ€§èƒ½è¡¨ç°å’Œå†…å­˜å ç”¨
- ğŸ”§ **æ˜“ç”¨æ€§**ï¼šAPIè®¾è®¡ç®€æ´ï¼Œä½¿ç”¨æ–¹ä¾¿
- ğŸ“š **æ–‡æ¡£è´¨é‡**ï¼šæœ‰è¯¦ç»†çš„æ–‡æ¡£å’Œç¤ºä¾‹ä»£ç 

---

## 8. ğŸ« JWTä»¤ç‰Œè®¾è®¡è¯¦è§£


### 8.1 JWTè®¤è¯çº§åˆ«æ ‡è¯†è®¾è®¡


**æ ¸å¿ƒæ€è·¯**ï¼šåœ¨JWTçš„è½½è·ï¼ˆPayloadï¼‰ä¸­åŠ å…¥**è®¤è¯çº§åˆ«æ ‡è¯†**ï¼Œè®©æœåŠ¡å™¨çŸ¥é“ç”¨æˆ·å®Œæˆäº†å“ªäº›è®¤è¯æ­¥éª¤ã€‚

**è®¤è¯çº§åˆ«åˆ†ç±»**ï¼š
```
ğŸ”¸ noneï¼šæœªè®¤è¯çŠ¶æ€
ğŸ”¸ partialï¼šéƒ¨åˆ†è®¤è¯ï¼ˆä»…å¯†ç éªŒè¯æˆåŠŸï¼‰  
ğŸ”¸ fullï¼šå®Œå…¨è®¤è¯ï¼ˆå¯†ç +MFAéªŒè¯æˆåŠŸï¼‰
ğŸ”¸ elevatedï¼šæå‡è®¤è¯ï¼ˆéœ€è¦é‡æ–°è¾“å…¥å¯†ç çš„æ•æ„Ÿæ“ä½œï¼‰
```

### 8.2 JWTè½½è·ç»“æ„è®¾è®¡


**ğŸ¯ æ ‡å‡†JWTç»“æ„**ï¼š
```json
{
  "header": {
    "alg": "HS256",                    // ç­¾åç®—æ³•
    "typ": "JWT"                       // Tokenç±»å‹
  },
  "payload": {
    // æ ‡å‡†å£°æ˜
    "iss": "my-app.com",               // ç­¾å‘è€…
    "sub": "12345",                    // ä¸»é¢˜ï¼ˆç”¨æˆ·IDï¼‰
    "aud": "web-client",               // å—ä¼—
    "exp": 1643291100,                 // è¿‡æœŸæ—¶é—´
    "iat": 1643284500,                 // ç­¾å‘æ—¶é—´
    "jti": "abc-123-def",              // JWT ID
    
    // è‡ªå®šä¹‰å£°æ˜ï¼ˆMFAç›¸å…³ï¼‰
    "auth_level": "full",              // è®¤è¯çº§åˆ«
    "auth_methods": ["password", "sms"], // å·²å®Œæˆçš„è®¤è¯æ–¹æ³•
    "step": "completed",               // å½“å‰è®¤è¯æ­¥éª¤
    "device_id": "device_abc123",      // è®¾å¤‡æ ‡è¯†
    "ip_address": "192.168.1.100",     // IPåœ°å€
    "user_agent": "Chrome/96.0",       // ç”¨æˆ·ä»£ç†
    
    // ç”¨æˆ·æƒé™
    "roles": ["user", "admin"],        // ç”¨æˆ·è§’è‰²
    "permissions": ["read", "write"],  // å…·ä½“æƒé™
    
    // MFAç‰¹å®š
    "mfa_required": true,              // æ˜¯å¦éœ€è¦MFA
    "mfa_methods": ["sms", "totp"],    // æ”¯æŒçš„MFAæ–¹æ³•
    "last_mfa_time": 1643284400        // ä¸Šæ¬¡MFAéªŒè¯æ—¶é—´
  }
}
```

### 8.3 ä¸åŒè®¤è¯çº§åˆ«çš„Tokenè®¾è®¡


**ğŸ”¸ éƒ¨åˆ†è®¤è¯Tokenï¼ˆå¯†ç éªŒè¯åï¼‰**ï¼š
```java
public String generatePartialToken(User user) {
    Map<String, Object> claims = new HashMap<>();
    claims.put("sub", user.getId());
    claims.put("auth_level", "partial");
    claims.put("auth_methods", Arrays.asList("password"));
    claims.put("step", "mfa_required");
    claims.put("mfa_required", true);
    claims.put("mfa_methods", user.getEnabledMfaMethods());
    claims.put("permissions", Arrays.asList("mfa_verify")); // åªèƒ½è¿›è¡ŒMFAéªŒè¯
    
    return JWT.create()
        .withPayload(claims)
        .withExpiresAt(new Date(System.currentTimeMillis() + 5 * 60 * 1000)) // 5åˆ†é’Ÿè¿‡æœŸ
        .sign(Algorithm.HMAC256(jwtSecret));
}
```

**ğŸ”¸ å®Œå…¨è®¤è¯Tokenï¼ˆMFAéªŒè¯åï¼‰**ï¼š
```java
public String generateFullToken(User user) {
    Map<String, Object> claims = new HashMap<>();
    claims.put("sub", user.getId());
    claims.put("auth_level", "full");
    claims.put("auth_methods", Arrays.asList("password", "sms"));
    claims.put("step", "completed");
    claims.put("mfa_required", false);
    claims.put("last_mfa_time", System.currentTimeMillis() / 1000);
    claims.put("roles", user.getRoles());
    claims.put("permissions", user.getPermissions());
    
    return JWT.create()
        .withPayload(claims)
        .withExpiresAt(new Date(System.currentTimeMillis() + 2 * 60 * 60 * 1000)) // 2å°æ—¶è¿‡æœŸ
        .sign(Algorithm.HMAC256(jwtSecret));
}
```

**ğŸ”¸ æå‡è®¤è¯Tokenï¼ˆæ•æ„Ÿæ“ä½œï¼‰**ï¼š
```java
public String generateElevatedToken(User user) {
    Map<String, Object> claims = new HashMap<>();
    claims.put("sub", user.getId());
    claims.put("auth_level", "elevated");
    claims.put("auth_methods", Arrays.asList("password", "sms", "re-auth"));
    claims.put("step", "elevated");
    claims.put("elevated_time", System.currentTimeMillis() / 1000);
    claims.put("permissions", user.getElevatedPermissions()); // æ•æ„Ÿæ“ä½œæƒé™
    
    return JWT.create()
        .withPayload(claims)
        .withExpiresAt(new Date(System.currentTimeMillis() + 15 * 60 * 1000)) // 15åˆ†é’Ÿè¿‡æœŸ
        .sign(Algorithm.HMAC256(jwtSecret));
}
```

### 8.4 TokenéªŒè¯ä¸æƒé™æ§åˆ¶


**ğŸ”’ æƒé™éªŒè¯æ‹¦æˆªå™¨**ï¼š
```java
@Component
public class AuthInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler) throws Exception {
        
        String token = extractTokenFromRequest(request);
        if (token == null) {
            response.setStatus(401);
            return false;
        }
        
        DecodedJWT decodedJWT = jwtUtil.validateToken(token);
        if (decodedJWT == null) {
            response.setStatus(401);
            return false;
        }
        
        // è·å–è®¤è¯çº§åˆ«
        String authLevel = decodedJWT.getClaim("auth_level").asString();
        String requestPath = request.getRequestURI();
        
        // æ ¹æ®è·¯å¾„è¦æ±‚çš„è®¤è¯çº§åˆ«è¿›è¡Œæ§åˆ¶
        if (requiresFullAuth(requestPath) && !"full".equals(authLevel)) {
            response.setStatus(403);
            return false;
        }
        
        if (requiresElevatedAuth(requestPath) && !"elevated".equals(authLevel)) {
            response.setStatus(403); 
            return false;
        }
        
        // å°†ç”¨æˆ·ä¿¡æ¯å­˜å…¥è¯·æ±‚ä¸Šä¸‹æ–‡
        request.setAttribute("userId", decodedJWT.getSubject());
        request.setAttribute("authLevel", authLevel);
        
        return true;
    }
    
    private boolean requiresFullAuth(String path) {
        return path.startsWith("/api/user/") || 
               path.startsWith("/api/data/");
    }
    
    private boolean requiresElevatedAuth(String path) {
        return path.startsWith("/api/admin/") || 
               path.startsWith("/api/payment/") ||
               path.startsWith("/api/user/delete");
    }
}
```

**ğŸ›¡ï¸ æ³¨è§£å¼æƒé™æ§åˆ¶**ï¼š
```java
// è‡ªå®šä¹‰æ³¨è§£
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface RequireAuthLevel {
    String value() default "full"; // partial, full, elevated
    int maxAge() default 3600;     // MFAéªŒè¯çš„æœ€å¤§æœ‰æ•ˆæ—¶é—´ï¼ˆç§’ï¼‰
}

// ä½¿ç”¨æ³¨è§£
@RestController
public class UserController {
    
    @GetMapping("/api/user/profile")
    @RequireAuthLevel("full")  // éœ€è¦å®Œå…¨è®¤è¯
    public ResponseEntity<?> getUserProfile() {
        // è·å–ç”¨æˆ·èµ„æ–™
    }
    
    @DeleteMapping("/api/user/delete")
    @RequireAuthLevel(value = "elevated", maxAge = 300) // éœ€è¦5åˆ†é’Ÿå†…çš„æå‡è®¤è¯
    public ResponseEntity<?> deleteUser() {
        // åˆ é™¤ç”¨æˆ·ï¼ˆæ•æ„Ÿæ“ä½œï¼‰
    }
    
    @PostMapping("/api/payment/transfer")
    @RequireAuthLevel(value = "elevated", maxAge = 600) // éœ€è¦10åˆ†é’Ÿå†…çš„æå‡è®¤è¯
    public ResponseEntity<?> transferMoney() {
        // è½¬è´¦æ“ä½œ
    }
}

// AOPåˆ‡é¢å¤„ç†
@Aspect
@Component
public class AuthLevelAspect {
    
    @Before("@annotation(requireAuthLevel)")
    public void checkAuthLevel(JoinPoint joinPoint, RequireAuthLevel requireAuthLevel) {
        HttpServletRequest request = getCurrentRequest();
        String authLevel = (String) request.getAttribute("authLevel");
        
        // æ£€æŸ¥è®¤è¯çº§åˆ«
        if (!isAuthLevelSufficient(authLevel, requireAuthLevel.value())) {
            throw new InsufficientAuthException("éœ€è¦" + requireAuthLevel.value() + "çº§åˆ«è®¤è¯");
        }
        
        // æ£€æŸ¥MFAæ—¶æ•ˆæ€§
        if ("elevated".equals(requireAuthLevel.value())) {
            checkMfaFreshness(request, requireAuthLevel.maxAge());
        }
    }
    
    private boolean isAuthLevelSufficient(String currentLevel, String requiredLevel) {
        Map<String, Integer> levelMap = Map.of(
            "none", 0,
            "partial", 1, 
            "full", 2,
            "elevated", 3
        );
        
        return levelMap.getOrDefault(currentLevel, 0) >= 
               levelMap.getOrDefault(requiredLevel, 2);
    }
}
```

### 8.5 Tokenç”Ÿå‘½å‘¨æœŸç®¡ç†


**ğŸ”„ Tokenåˆ·æ–°ç­–ç•¥**ï¼š
```java
@Service
public class TokenRefreshService {
    
    // åˆ·æ–°Tokenï¼ˆä¿æŒè®¤è¯çº§åˆ«ï¼‰
    public String refreshToken(String oldToken) {
        DecodedJWT decoded = jwtUtil.validateToken(oldToken);
        if (decoded == null) {
            throw new InvalidTokenException("Tokenæ— æ•ˆ");
        }
        
        String userId = decoded.getSubject();
        String authLevel = decoded.getClaim("auth_level").asString();
        List<String> authMethods = decoded.getClaim("auth_methods").asList(String.class);
        
        // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°éªŒè¯MFA
        Long lastMfaTime = decoded.getClaim("last_mfa_time").asLong();
        if (lastMfaTime != null && isTokenExpiredForSensitiveOps(lastMfaTime)) {
            // MFAè¿‡æœŸï¼Œé™çº§ä¸ºéƒ¨åˆ†è®¤è¯
            return generatePartialToken(userService.findById(userId));
        }
        
        // ç”Ÿæˆæ–°Tokenï¼Œä¿æŒåŸæœ‰è®¤è¯çº§åˆ«
        Map<String, Object> claims = new HashMap<>();
        claims.put("sub", userId);
        claims.put("auth_level", authLevel);
        claims.put("auth_methods", authMethods);
        claims.put("last_mfa_time", lastMfaTime);
        
        return JWT.create()
            .withPayload(claims)
            .withExpiresAt(new Date(System.currentTimeMillis() + getTokenExpireTime(authLevel)))
            .sign(Algorithm.HMAC256(jwtSecret));
    }
    
    // æ£€æŸ¥MFAæ˜¯å¦è¿‡æœŸï¼ˆç”¨äºæ•æ„Ÿæ“ä½œï¼‰
    private boolean isTokenExpiredForSensitiveOps(Long lastMfaTime) {
        long currentTime = System.currentTimeMillis() / 1000;
        return (currentTime - lastMfaTime) > 15 * 60; // 15åˆ†é’Ÿ
    }
    
    // æ ¹æ®è®¤è¯çº§åˆ«è·å–Tokenè¿‡æœŸæ—¶é—´
    private long getTokenExpireTime(String authLevel) {
        switch (authLevel) {
            case "partial":
                return 5 * 60 * 1000;      // 5åˆ†é’Ÿ
            case "full": 
                return 2 * 60 * 60 * 1000; // 2å°æ—¶
            case "elevated":
                return 15 * 60 * 1000;     // 15åˆ†é’Ÿ
            default:
                return 30 * 60 * 1000;     // 30åˆ†é’Ÿ
        }
    }
}
```

**ğŸš« Tokené»‘åå•æœºåˆ¶**ï¼š
```java
@Service
public class TokenBlacklistService {
    
    private final RedisTemplate<String, String> redisTemplate;
    
    // å°†TokenåŠ å…¥é»‘åå•
    public void blacklistToken(String token) {
        DecodedJWT decoded = jwtUtil.validateToken(token);
        if (decoded != null) {
            String jti = decoded.getClaim("jti").asString();
            long expireTime = decoded.getExpiresAt().getTime();
            long ttl = expireTime - System.currentTimeMillis();
            
            if (ttl > 0) {
                redisTemplate.opsForValue().set(
                    "blacklist:" + jti, 
                    "revoked", 
                    Duration.ofMillis(ttl)
                );
            }
        }
    }
    
    // æ£€æŸ¥Tokenæ˜¯å¦åœ¨é»‘åå•ä¸­
    public boolean isTokenBlacklisted(String token) {
        DecodedJWT decoded = jwtUtil.validateToken(token);
        if (decoded == null) return true;
        
        String jti = decoded.getClaim("jti").asString();
        return redisTemplate.hasKey("blacklist:" + jti);
    }
    
    // ç”¨æˆ·é€€å‡ºæ—¶ï¼Œæ’¤é”€æ‰€æœ‰Token
    public void revokeAllUserTokens(String userId) {
        // å°†ç”¨æˆ·IDåŠ å…¥å…¨å±€æ’¤é”€åˆ—è¡¨
        redisTemplate.opsForValue().set(
            "user_revoked:" + userId,
            String.valueOf(System.currentTimeMillis()),
            Duration.ofDays(1) // 1å¤©è¿‡æœŸ
        );
    }
    
    // æ£€æŸ¥ç”¨æˆ·çš„Tokenæ˜¯å¦è¢«å…¨å±€æ’¤é”€
    public boolean isUserTokenRevoked(String userId, long tokenIssuedTime) {
        String revokedTimeStr = redisTemplate.opsForValue().get("user_revoked:" + userId);
        if (revokedTimeStr == null) return false;
        
        long revokedTime = Long.parseLong(revokedTimeStr);
        return tokenIssuedTime < revokedTime;
    }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ” MFAé›†æˆæœ¬è´¨ï¼šåœ¨åŸæœ‰ç™»å½•åŸºç¡€ä¸Šå¢åŠ ç¬¬äºŒé“éªŒè¯é—¨æ§›
ğŸ”‘ ç™»å½•é€»è¾‘æ”¹é€ ï¼šä»"ä¸€æ­¥åˆ°ä½"å˜æˆ"åˆ†æ­¥éªŒè¯"
ğŸª Sessionæ–¹å¼ï¼šæœåŠ¡å™¨ç«¯çŠ¶æ€ç®¡ç†ï¼Œé€‚åˆä¼ ç»ŸWebåº”ç”¨
ğŸ« Tokenæ–¹å¼ï¼šæ— çŠ¶æ€è®¾è®¡ï¼Œé€‚åˆç°ä»£APIå’Œç§»åŠ¨ç«¯
ğŸ”— APIè®¾è®¡åŸåˆ™ï¼šRESTfulé£æ ¼ï¼Œå®‰å…¨ç¬¬ä¸€ï¼Œç”¨æˆ·å‹å¥½
ğŸ–¥ï¸ å‰åç«¯äº¤äº’ï¼šçŠ¶æ€ç®¡ç†æ¸…æ™°ï¼Œé”™è¯¯å¤„ç†å®Œå–„
ğŸ“š å¼€å‘åº“é€‰æ‹©ï¼šæˆç†Ÿç¨³å®šï¼Œå®‰å…¨å¯é ï¼Œæ˜“äºä½¿ç”¨
ğŸ¯ JWTè®¾è®¡ï¼šè®¤è¯çº§åˆ«æ ‡è¯†ï¼Œæƒé™æ§åˆ¶ç²¾ç¡®
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ MFAé›†æˆçš„æ ¸å¿ƒæ€è·¯**ï¼š
```
æ¸è¿›å¼éªŒè¯ï¼š
å¯†ç éªŒè¯æˆåŠŸ â†’ ä¸´æ—¶æƒé™çŠ¶æ€ â†’ MFAéªŒè¯æˆåŠŸ â†’ å®Œæ•´æƒé™çŠ¶æ€

çŠ¶æ€ç®¡ç†ï¼š
- Sessionæ–¹å¼ï¼šæœåŠ¡å™¨ç«¯è®°å½•çŠ¶æ€
- Tokenæ–¹å¼ï¼šå®¢æˆ·ç«¯æºå¸¦çŠ¶æ€ä¿¡æ¯

å®‰å…¨è€ƒè™‘ï¼š
- æ—¶æ•ˆæ€§ï¼šéªŒè¯ç å’Œä¸´æ—¶çŠ¶æ€éƒ½æœ‰è¿‡æœŸæ—¶é—´
- é¢‘ç‡é™åˆ¶ï¼šé˜²æ­¢æš´åŠ›ç ´è§£å’Œé‡æ”¾æ”»å‡»  
- æƒé™æ§åˆ¶ï¼šä¸åŒè®¤è¯çº§åˆ«å¯¹åº”ä¸åŒæƒé™
```

**ğŸ”¹ Session vs Tokençš„é€‰æ‹©**ï¼š
```
Sessioné€‚åˆï¼š
âœ… ä¼ ç»ŸWebåº”ç”¨ï¼Œä¸»è¦ä½¿ç”¨æµè§ˆå™¨è®¿é—®
âœ… å¯¹å®‰å…¨æ€§è¦æ±‚æé«˜ï¼Œéœ€è¦ç²¾ç¡®æ§åˆ¶ä¼šè¯
âœ… å•ä½“æ¶æ„ï¼ŒæœåŠ¡å™¨æ•°é‡è¾ƒå°‘

Tokené€‚åˆï¼š
âœ… ç°ä»£APIåº”ç”¨ï¼Œæ”¯æŒå¤šç§å®¢æˆ·ç«¯
âœ… åˆ†å¸ƒå¼æ¶æ„ï¼Œéœ€è¦æ— çŠ¶æ€è®¾è®¡
âœ… ç§»åŠ¨ç«¯åº”ç”¨ï¼Œä¸ä¾èµ–Cookie
```

**ğŸ”¹ å‰åç«¯äº¤äº’çš„æ ¸å¿ƒ**ï¼š
```
çŠ¶æ€åŒæ­¥ï¼š
å‰ç«¯éœ€è¦æ¸…æ¥šå½“å‰å¤„äºå“ªä¸ªè®¤è¯æ­¥éª¤

é”™è¯¯å¤„ç†ï¼š
ä¸åŒç±»å‹çš„é”™è¯¯è¦æœ‰ä¸åŒçš„å¤„ç†ç­–ç•¥

ç”¨æˆ·ä½“éªŒï¼š
å¤æ‚çš„å®‰å…¨æµç¨‹è¦åšæˆç®€å•çš„ç”¨æˆ·ç•Œé¢
```

### 9.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ’¼ ä¸šåŠ¡åœºæ™¯åº”ç”¨**ï¼š
- **é‡‘èç³»ç»Ÿ**ï¼šç™»å½•+æ”¯ä»˜åŒé‡MFAéªŒè¯
- **ä¼ä¸šOA**ï¼šæ ¹æ®æ“ä½œæ•æ„Ÿåº¦è¦æ±‚ä¸åŒè®¤è¯çº§åˆ«  
- **ç”µå•†å¹³å°**ï¼šæ™®é€šæµè§ˆæ— éœ€MFAï¼Œæ”¯ä»˜æ—¶è¦æ±‚MFA
- **åŒ»ç–—ç³»ç»Ÿ**ï¼šæŸ¥çœ‹ç—…å†éœ€MFAï¼Œä¿®æ”¹ç—…å†éœ€æå‡è®¤è¯

**ğŸ”§ æŠ€æœ¯å®è·µè¦ç‚¹**ï¼š
- **æ¶æ„è®¾è®¡**ï¼šé€‰æ‹©é€‚åˆçš„Sessionæˆ–Tokenæ–¹æ¡ˆ
- **å®‰å…¨é˜²æŠ¤**ï¼šé¢‘ç‡é™åˆ¶ã€è¾“å…¥éªŒè¯ã€æ—¶æ•ˆæ§åˆ¶
- **ç”¨æˆ·ä½“éªŒ**ï¼šæµç¨‹ç®€åŒ–ã€æç¤ºæ¸…æ™°ã€é”™è¯¯å‹å¥½
- **è¿ç»´ç›‘æ§**ï¼šè®°å½•è®¤è¯æ—¥å¿—ï¼Œç›‘æ§å¼‚å¸¸è¡Œä¸º

**ğŸ“Š æ€§èƒ½ä¼˜åŒ–è€ƒè™‘**ï¼š
```
Tokenæ€§èƒ½ï¼š
âœ… æ— éœ€æœåŠ¡å™¨ç«¯æŸ¥è¯¢ï¼ŒéªŒè¯é€Ÿåº¦å¿«
âŒ Tokenä½“ç§¯è¾ƒå¤§ï¼Œç½‘ç»œä¼ è¾“å¼€é”€

Sessionæ€§èƒ½ï¼š  
âœ… Session IDå°ï¼Œç½‘ç»œä¼ è¾“å¿«
âŒ éœ€è¦æœåŠ¡å™¨ç«¯æŸ¥è¯¢ï¼Œæ•°æ®åº“å‹åŠ›å¤§

ç¼“å­˜ç­–ç•¥ï¼š
- Sessionå­˜å‚¨ä½¿ç”¨Redisç­‰å†…å­˜ç¼“å­˜
- TokenéªŒè¯ç»“æœå¯ä»¥çŸ­æ—¶é—´ç¼“å­˜
- ç”¨æˆ·æƒé™ä¿¡æ¯é€‚åº¦ç¼“å­˜
```

**ğŸ¯ æœ€ä½³å®è·µå»ºè®®**ï¼š
```
å¼€å‘é˜¶æ®µï¼š
1ï¸âƒ£ å…ˆå®ç°åŸºç¡€çš„ç”¨æˆ·åå¯†ç è®¤è¯
2ï¸âƒ£ å†é›†æˆMFAåŠŸèƒ½ï¼Œé€æ­¥å®Œå–„
3ï¸âƒ£ å‰åç«¯åè°ƒæµ‹è¯•ï¼Œç¡®ä¿æµç¨‹é¡ºç•…
4ï¸âƒ£ åŠ å…¥å®Œå–„çš„é”™è¯¯å¤„ç†å’Œç”¨æˆ·æç¤º

ç”Ÿäº§éƒ¨ç½²ï¼š
1ï¸âƒ£ é…ç½®åˆç†çš„Tokenè¿‡æœŸæ—¶é—´
2ï¸âƒ£ å¯ç”¨é¢‘ç‡é™åˆ¶å’Œå®‰å…¨é˜²æŠ¤
3ï¸âƒ£ ç›‘æ§è®¤è¯æˆåŠŸç‡å’Œå¤±è´¥åŸå›   
4ï¸âƒ£ å‡†å¤‡ç”¨æˆ·åé¦ˆå’Œå®¢æœæ”¯æŒæ¸ é“
```

**âš ï¸ å¸¸è§é™·é˜±é¿å…**ï¼š
```
å®‰å…¨é™·é˜±ï¼š
âŒ ä¸´æ—¶Tokenè¿‡æœŸæ—¶é—´è¿‡é•¿
âŒ éªŒè¯ç é‡ç”¨æˆ–æ— è¿‡æœŸæ§åˆ¶  
âŒ æƒé™éªŒè¯é€»è¾‘ä¸å®Œæ•´
âŒ æ•æ„Ÿä¿¡æ¯åœ¨Tokenä¸­æ˜æ–‡å­˜å‚¨

ç”¨æˆ·ä½“éªŒé™·é˜±ï¼š
âŒ éªŒè¯å¤±è´¥åæ²¡æœ‰æ¸…æ™°çš„é”™è¯¯æç¤º
âŒ éªŒè¯ç å‘é€å¤±è´¥æ²¡æœ‰é‡è¯•æœºåˆ¶
âŒ è®¤è¯æµç¨‹è¿‡äºå¤æ‚ï¼Œç”¨æˆ·æ˜“è¿·å¤±
âŒ ç§»åŠ¨ç«¯å’ŒPCç«¯ä½“éªŒä¸ä¸€è‡´

æŠ€æœ¯å®ç°é™·é˜±ï¼š
âŒ Sessionå’ŒTokenæ··ç”¨ï¼ŒçŠ¶æ€ç®¡ç†æ··ä¹±
âŒ å‰ç«¯çŠ¶æ€ç®¡ç†ä¸å®Œå–„ï¼Œåˆ·æ–°é¡µé¢ä¸¢çŠ¶æ€
âŒ APIæ¥å£è®¾è®¡ä¸è§„èŒƒï¼Œå‰ç«¯é€‚é…å›°éš¾
âŒ å¼€å‘åº“ç‰ˆæœ¬è¿‡è€ï¼Œå­˜åœ¨å®‰å…¨æ¼æ´
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
MFAé›†æˆåˆ†ä¸¤æ­¥ï¼Œå¯†ç éªŒè¯æ˜¯ç¬¬ä¸€
ä¸´æ—¶çŠ¶æ€è¦ç®¡å¥½ï¼Œå®Œæ•´æƒé™å†æ”¾è¡Œ
SessionæœåŠ¡å™¨å­˜ï¼ŒTokenå®¢æˆ·ç«¯å¸¦
APIè®¾è®¡è¦è§„èŒƒï¼Œå‰åäº¤äº’è«å‡ºé”™
å¼€å‘åº“è¦é€‰å¥½ï¼ŒJWTè®¾è®¡æœ‰é—¨é“
å®‰å…¨ä½“éªŒä¸¤æ‰‹æŠ“ï¼Œç”Ÿäº§éƒ¨ç½²ç»†æ€é‡
```