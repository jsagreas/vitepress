---
title: 5ã€å‰ç«¯è®¤è¯å®æˆ˜
---
## ğŸ“š ç›®å½•

1. [SPAå•é¡µåº”ç”¨è®¤è¯](#1-SPAå•é¡µåº”ç”¨è®¤è¯)
2. [å‰ç«¯Tokenå®‰å…¨å­˜å‚¨](#2-å‰ç«¯Tokenå®‰å…¨å­˜å‚¨)
3. [è·¨åŸŸè®¤è¯å¤„ç†](#3-è·¨åŸŸè®¤è¯å¤„ç†)
4. [æ— æ„Ÿåˆ·æ–°Tokenæœºåˆ¶](#4-æ— æ„Ÿåˆ·æ–°Tokenæœºåˆ¶)
5. [è·¯ç”±å®ˆå«å®ç°](#5-è·¯ç”±å®ˆå«å®ç°)
6. [ç§»åŠ¨ç«¯è®¤è¯ç­–ç•¥](#6-ç§»åŠ¨ç«¯è®¤è¯ç­–ç•¥)
7. [å‰ç«¯å®‰å…¨é˜²æŠ¤](#7-å‰ç«¯å®‰å…¨é˜²æŠ¤)
8. [æ¡†æ¶é›†æˆæ–¹æ¡ˆ](#8-æ¡†æ¶é›†æˆæ–¹æ¡ˆ)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸš€ SPAå•é¡µåº”ç”¨è®¤è¯


### 1.1 ä»€ä¹ˆæ˜¯SPAè®¤è¯


**SPAè®¤è¯æœ¬è´¨**ï¼šåœ¨å•é¡µåº”ç”¨ä¸­ï¼Œé¡µé¢ä¸åˆ·æ–°ï¼Œä½†éœ€è¦éªŒè¯ç”¨æˆ·èº«ä»½çš„è¿‡ç¨‹ã€‚

```
ä¼ ç»Ÿç½‘ç«™ vs SPAè®¤è¯åŒºåˆ«ï¼š

ä¼ ç»Ÿç½‘ç«™ï¼ˆå¤šé¡µé¢ï¼‰ï¼š
ç”¨æˆ·ç™»å½• â†’ æœåŠ¡å™¨éªŒè¯ â†’ è¿”å›æ–°é¡µé¢ â†’ é¡µé¢åŒ…å«ç™»å½•ä¿¡æ¯

SPAåº”ç”¨ï¼ˆå•é¡µé¢ï¼‰ï¼š
ç”¨æˆ·ç™»å½• â†’ è·å–Token â†’ å­˜å‚¨Token â†’ æ¯æ¬¡è¯·æ±‚æºå¸¦Token
```

**ğŸ”¸ æ ¸å¿ƒç‰¹ç‚¹**ï¼š
- `ğŸ“± é¡µé¢æ— åˆ·æ–°`ï¼šæ•´ä¸ªåº”ç”¨åœ¨ä¸€ä¸ªé¡µé¢å†…è¿è¡Œ
- `ğŸ”‘ Tokené©±åŠ¨`ï¼šä¾é Tokenè€ŒéSessionç»´æŒç™»å½•çŠ¶æ€
- `âš¡ å®¢æˆ·ç«¯è·¯ç”±`ï¼šè·¯ç”±åˆ‡æ¢åœ¨å‰ç«¯å®Œæˆ
- `ğŸŒ APIäº¤äº’`ï¼šé€šè¿‡AJAX/Fetchä¸åç«¯é€šä¿¡

### 1.2 SPAè®¤è¯æµç¨‹è¯¦è§£


**ğŸ¯ å®Œæ•´è®¤è¯æµç¨‹**ï¼š

```
ç”¨æˆ·æ“ä½œæµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·ç™»å½•   â”‚â”€â”€â”€â–¶â”‚  è¾“å…¥è´¦å¯†    â”‚â”€â”€â”€â–¶â”‚  ç‚¹å‡»ç™»å½•    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å­˜å‚¨Token  â”‚â—€â”€â”€â”€â”‚  éªŒè¯æˆåŠŸ    â”‚â—€â”€â”€â”€â”‚  å‘é€è¯·æ±‚    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è·³è½¬é¦–é¡µ    â”‚â”€â”€â”€â–¶â”‚  è‡ªåŠ¨è®¤è¯    â”‚â”€â”€â”€â–¶â”‚  æ­£å¸¸ä½¿ç”¨    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ’¡ æŠ€æœ¯å®ç°è¦ç‚¹**ï¼š
```javascript
// åŸºç¡€ç™»å½•æµç¨‹
const login = async (username, password) => {
  // 1. å‘é€ç™»å½•è¯·æ±‚
  const response = await fetch('/api/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username, password })
  });
  
  // 2. è·å–Token
  const { token, refreshToken } = await response.json();
  
  // 3. å­˜å‚¨Token
  localStorage.setItem('token', token);
  localStorage.setItem('refreshToken', refreshToken);
  
  // 4. è·³è½¬é¦–é¡µ
  router.push('/dashboard');
};
```

### 1.3 SPAè®¤è¯çš„ä¼˜åŠ¿ä¸æŒ‘æˆ˜


**âœ… ä¼˜åŠ¿**ï¼š
- `âš¡ ç”¨æˆ·ä½“éªŒå¥½`ï¼šæ— é¡µé¢åˆ·æ–°ï¼Œæ“ä½œæµç•…
- `ğŸš€ æ€§èƒ½æ›´ä½³`ï¼šå‡å°‘æœåŠ¡å™¨æ¸²æŸ“å‹åŠ›
- `ğŸ“± ç§»åŠ¨ç«¯å‹å¥½`ï¼šé€‚åˆå¼€å‘ç§»åŠ¨åº”ç”¨
- `ğŸ”„ çŠ¶æ€ç®¡ç†`ï¼šå‰ç«¯å®Œå…¨æ§åˆ¶åº”ç”¨çŠ¶æ€

**âŒ æŒ‘æˆ˜**ï¼š
- `ğŸ”’ å®‰å…¨é£é™©`ï¼šTokenå­˜å‚¨åœ¨å®¢æˆ·ç«¯ï¼Œå®¹æ˜“è¢«æ”»å‡»
- `ğŸŒ SEOå›°éš¾`ï¼šæœç´¢å¼•æ“éš¾ä»¥æŠ“å–å†…å®¹
- `âš ï¸ åˆå§‹åŠ è½½`ï¼šé¦–æ¬¡åŠ è½½æ—¶é—´å¯èƒ½è¾ƒé•¿
- `ğŸ”§ å¤æ‚åº¦é«˜`ï¼šéœ€è¦å¤„ç†æ›´å¤šå‰ç«¯é€»è¾‘

---

## 2. ğŸ” å‰ç«¯Tokenå®‰å…¨å­˜å‚¨


### 2.1 å­˜å‚¨æ–¹æ¡ˆå¯¹æ¯”


**ğŸ¯ ä¸‰ç§ä¸»è¦å­˜å‚¨æ–¹å¼**ï¼š

| å­˜å‚¨æ–¹å¼ | **å®‰å…¨æ€§** | **æŒä¹…åŒ–** | **å®¹é‡** | **é€‚ç”¨åœºæ™¯** |
|---------|-----------|-----------|---------|-------------|
| `ğŸ’¾ localStorage` | `ğŸ”´ ä½` | `âœ… æ°¸ä¹…` | `~10MB` | `é•¿æœŸç™»å½•çŠ¶æ€` |
| `ğŸ“ sessionStorage` | `ğŸŸ¡ ä¸­` | `âŒ ä¼šè¯` | `~10MB` | `ä¸´æ—¶ç™»å½•çŠ¶æ€` |
| `ğŸ§  Memory` | `ğŸŸ¢ é«˜` | `âŒ ä¸´æ—¶` | `æ— é™åˆ¶` | `é«˜å®‰å…¨è¦æ±‚` |
| `ğŸª Cookie` | `ğŸŸ¡ ä¸­` | `âœ… å¯é…ç½®` | `~4KB` | `SSRåº”ç”¨` |

### 2.2 localStorage vs sessionStorage vs Memory


**ğŸ“Š è¯¦ç»†å¯¹æ¯”åˆ†æ**ï¼š

**ğŸ”¸ localStorageï¼ˆæœ¬åœ°å­˜å‚¨ï¼‰**ï¼š
```javascript
// ç‰¹ç‚¹ï¼šæ•°æ®æ°¸ä¹…ä¿å­˜ï¼Œç›´åˆ°æ‰‹åŠ¨æ¸…é™¤
localStorage.setItem('token', 'your-token');
const token = localStorage.getItem('token');

// ä¼˜ç‚¹ï¼š
// âœ… ç”¨æˆ·å…³é—­æµè§ˆå™¨åä»ä¿æŒç™»å½•
// âœ… é€‚åˆ"è®°ä½æˆ‘"åŠŸèƒ½
// âœ… å®¹é‡å¤§ï¼Œä½¿ç”¨ç®€å•

// ç¼ºç‚¹ï¼š
// âŒ å®¹æ˜“è¢«XSSæ”»å‡»è·å–
// âŒ æ‰€æœ‰æ ‡ç­¾é¡µå…±äº«ï¼Œå®‰å…¨é£é™©é«˜
// âŒ æ— æ³•è®¾ç½®è¿‡æœŸæ—¶é—´
```

**ğŸ”¸ sessionStorageï¼ˆä¼šè¯å­˜å‚¨ï¼‰**ï¼š
```javascript
// ç‰¹ç‚¹ï¼šæµè§ˆå™¨ä¼šè¯ç»“æŸæ—¶è‡ªåŠ¨æ¸…é™¤
sessionStorage.setItem('token', 'your-token');
const token = sessionStorage.getItem('token');

// ä¼˜ç‚¹ï¼š
// âœ… æ ‡ç­¾é¡µç‹¬ç«‹ï¼Œå®‰å…¨æ€§æ›´å¥½
// âœ… ä¼šè¯ç»“æŸè‡ªåŠ¨æ¸…é™¤
// âœ… é€‚åˆå•æ¬¡ä¼šè¯ä½¿ç”¨

// ç¼ºç‚¹ï¼š
// âŒ ç”¨æˆ·åˆ·æ–°é¡µé¢éœ€è¦é‡æ–°ç™»å½•
// âŒ ä»ç„¶å®¹æ˜“è¢«XSSæ”»å‡»
// âŒ ç”¨æˆ·ä½“éªŒä¸å¤Ÿå¥½
```

**ğŸ”¸ Memoryï¼ˆå†…å­˜å­˜å‚¨ï¼‰**ï¼š
```javascript
// ç‰¹ç‚¹ï¼šå­˜å‚¨åœ¨JavaScriptå˜é‡ä¸­
let tokenStore = {
  accessToken: null,
  refreshToken: null
};

// ä¼˜ç‚¹ï¼š
// âœ… æœ€å®‰å…¨ï¼ŒXSSéš¾ä»¥è·å–
// âœ… åº”ç”¨å…³é—­è‡ªåŠ¨æ¸…é™¤
// âœ… å®Œå…¨æ§åˆ¶ç”Ÿå‘½å‘¨æœŸ

// ç¼ºç‚¹ï¼š
// âŒ é¡µé¢åˆ·æ–°ä¸¢å¤±æ•°æ®
// âŒ å®ç°å¤æ‚åº¦é«˜
// âŒ éœ€è¦é…åˆå…¶ä»–æ–¹æ¡ˆ
```

### 2.3 æœ€ä½³å­˜å‚¨ç­–ç•¥


**ğŸ¯ æ¨èçš„æ··åˆå­˜å‚¨æ–¹æ¡ˆ**ï¼š

```javascript
class TokenManager {
  constructor() {
    // å†…å­˜å­˜å‚¨AccessTokenï¼ˆçŸ­æœŸï¼‰
    this.accessToken = null;
    
    // localStorageå­˜å‚¨RefreshTokenï¼ˆé•¿æœŸï¼‰
    this.refreshToken = localStorage.getItem('refreshToken');
  }
  
  // è®¾ç½®Token
  setTokens(accessToken, refreshToken) {
    // AccessTokenå­˜å†…å­˜ï¼ˆå®‰å…¨ï¼‰
    this.accessToken = accessToken;
    
    // RefreshTokenå­˜localStorageï¼ˆæŒä¹…ï¼‰
    this.refreshToken = refreshToken;
    localStorage.setItem('refreshToken', refreshToken);
  }
  
  // è·å–AccessToken
  getAccessToken() {
    return this.accessToken;
  }
  
  // æ¸…é™¤æ‰€æœ‰Token
  clearTokens() {
    this.accessToken = null;
    this.refreshToken = null;
    localStorage.removeItem('refreshToken');
  }
}

const tokenManager = new TokenManager();
```

**ğŸ’¡ æ ¸å¿ƒè®¾è®¡ç†å¿µ**ï¼š
- `ğŸ”‘ AccessToken`ï¼šå­˜å†…å­˜ï¼Œå®‰å…¨æ€§é«˜ï¼Œè¿‡æœŸæ—¶é—´çŸ­
- `ğŸ”„ RefreshToken`ï¼šå­˜localStorageï¼Œç”¨äºåˆ·æ–°AccessToken
- `âš¡ è‡ªåŠ¨åˆ·æ–°`ï¼šAccessTokenè¿‡æœŸæ—¶ç”¨RefreshTokenè·å–æ–°Token

---

## 3. ğŸŒ è·¨åŸŸè®¤è¯å¤„ç†


### 3.1 ä»€ä¹ˆæ˜¯è·¨åŸŸè®¤è¯é—®é¢˜


**ğŸ”¸ è·¨åŸŸåŸºç¡€æ¦‚å¿µ**ï¼š
```
åŒæºç­–ç•¥ï¼šæµè§ˆå™¨å®‰å…¨æœºåˆ¶ï¼Œé™åˆ¶ä¸åŒæºä¹‹é—´çš„èµ„æºè®¿é—®

åŒæºå®šä¹‰ï¼šåè®® + åŸŸå + ç«¯å£ å®Œå…¨ç›¸åŒ

ç¤ºä¾‹è¯´æ˜ï¼š
å½“å‰é¡µé¢ï¼šhttps://app.example.com:3000
APIæœåŠ¡ï¼šhttps://api.example.com:8080
ç»“æœï¼šä¸åŒæºï¼Œå­˜åœ¨è·¨åŸŸé—®é¢˜
```

**âš ï¸ è·¨åŸŸè®¤è¯çš„æŒ‘æˆ˜**ï¼š
- `ğŸš« Cookieæ— æ³•æºå¸¦`ï¼šæµè§ˆå™¨é»˜è®¤ä¸å‘é€è·¨åŸŸCookie
- `ğŸ”’ é¢„æ£€è¯·æ±‚`ï¼šå¤æ‚è¯·æ±‚éœ€è¦OPTIONSé¢„æ£€
- `ğŸ“¡ è¯·æ±‚å¤´é™åˆ¶`ï¼šè‡ªå®šä¹‰è¯·æ±‚å¤´å¯èƒ½è¢«é˜»æ­¢
- `ğŸ”‘ å‡­è¯ä¼ é€’å›°éš¾`ï¼šè®¤è¯ä¿¡æ¯éš¾ä»¥æ­£ç¡®ä¼ é€’

### 3.2 è·¨åŸŸè®¤è¯è§£å†³æ–¹æ¡ˆ


**ğŸ¯ æ–¹æ¡ˆä¸€ï¼šCORSé…ç½®ï¼ˆæ¨èï¼‰**

**å‰ç«¯é…ç½®**ï¼š
```javascript
// è®¾ç½®è¯·æ±‚æºå¸¦å‡­è¯
fetch('/api/user', {
  method: 'GET',
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  },
  credentials: 'include' // å…³é”®ï¼šæºå¸¦Cookie
});

// Axioså…¨å±€é…ç½®
axios.defaults.withCredentials = true;
axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
```

**åç«¯é…ç½®ç¤ºä¾‹**ï¼š
```javascript
// Express.js CORSé…ç½®
app.use(cors({
  origin: ['https://app.example.com'],     // å…è®¸çš„æº
  credentials: true,                       // å…è®¸æºå¸¦å‡­è¯
  allowedHeaders: ['Content-Type', 'Authorization'], // å…è®¸çš„è¯·æ±‚å¤´
  methods: ['GET', 'POST', 'PUT', 'DELETE'] // å…è®¸çš„æ–¹æ³•
}));
```

**ğŸ¯ æ–¹æ¡ˆäºŒï¼šä»£ç†è½¬å‘**

```javascript
// Vue.jså¼€å‘ç¯å¢ƒä»£ç†é…ç½®
// vue.config.js
module.exports = {
  devServer: {
    proxy: {
      '/api': {
        target: 'https://api.example.com:8080',
        changeOrigin: true,
        secure: true
      }
    }
  }
};

// å‰ç«¯è¯·æ±‚ï¼ˆçœ‹èµ·æ¥æ˜¯åŒæºï¼‰
fetch('/api/user') // å®é™…è¯·æ±‚ï¼šhttps://api.example.com:8080/api/user
```

**ğŸ¯ æ–¹æ¡ˆä¸‰ï¼šJSONPï¼ˆä»…é™GETè¯·æ±‚ï¼‰**

```javascript
// åŠ¨æ€åˆ›å»ºscriptæ ‡ç­¾å®ç°è·¨åŸŸ
function jsonpRequest(url, callback) {
  const script = document.createElement('script');
  script.src = `${url}?callback=${callback}`;
  document.head.appendChild(script);
}

// ä½¿ç”¨ç¤ºä¾‹ï¼ˆè¾ƒå°‘ä½¿ç”¨ï¼‰
jsonpRequest('/api/data', 'handleResponse');
```

### 3.3 é¢„æ£€è¯·æ±‚å¤„ç†


**ğŸ” ä»€ä¹ˆæ˜¯é¢„æ£€è¯·æ±‚**ï¼š
```
å¤æ‚è¯·æ±‚ç‰¹å¾ï¼š
- HTTPæ–¹æ³•ï¼šPUTã€DELETEã€PATCHç­‰
- è‡ªå®šä¹‰è¯·æ±‚å¤´ï¼šAuthorizationã€X-Tokenç­‰
- Content-Typeï¼šapplication/jsonç­‰

æµè§ˆå™¨è¡Œä¸ºï¼š
å‘é€å®é™…è¯·æ±‚å‰ï¼Œå…ˆå‘é€OPTIONSè¯·æ±‚è¯¢é—®æœåŠ¡å™¨æ˜¯å¦å…è®¸
```

**âš¡ é¢„æ£€è¯·æ±‚ä¼˜åŒ–**ï¼š
```javascript
// åç«¯ä¼˜åŒ–ï¼šè®¾ç½®é¢„æ£€ç¼“å­˜
app.options('*', (req, res) => {
  res.header('Access-Control-Max-Age', '86400'); // ç¼“å­˜24å°æ—¶
  res.header('Access-Control-Allow-Methods', 'GET,POST,PUT,DELETE');
  res.header('Access-Control-Allow-Headers', 'Authorization,Content-Type');
  res.sendStatus(200);
});
```

---

## 4. ğŸ”„ æ— æ„Ÿåˆ·æ–°Tokenæœºåˆ¶


### 4.1 ä¸ºä»€ä¹ˆéœ€è¦æ— æ„Ÿåˆ·æ–°


**ğŸ¯ è§£å†³çš„æ ¸å¿ƒé—®é¢˜**ï¼š
```
AccessTokenè¿‡æœŸå›°æ‰°ï¼š
ç”¨æˆ·æ­£åœ¨ä½¿ç”¨åº”ç”¨ â†’ AccessTokenè¿‡æœŸ â†’ è¯·æ±‚å¤±è´¥ â†’ è¢«è¿«é‡æ–°ç™»å½•

ç†æƒ³çš„ç”¨æˆ·ä½“éªŒï¼š
ç”¨æˆ·æ­£åœ¨ä½¿ç”¨åº”ç”¨ â†’ AccessTokenè¿‡æœŸ â†’ è‡ªåŠ¨åˆ·æ–° â†’ ç»§ç»­æ­£å¸¸ä½¿ç”¨
```

**ğŸ’¡ æ— æ„Ÿåˆ·æ–°çš„ä»·å€¼**ï¼š
- `ğŸš€ ç”¨æˆ·ä½“éªŒå¥½`ï¼šæ— éœ€é‡æ–°ç™»å½•
- `ğŸ”’ å®‰å…¨æ€§é«˜`ï¼šAccessTokenè¿‡æœŸæ—¶é—´çŸ­
- `âš¡ æ“ä½œè¿ç»­`ï¼šä¸ä¸­æ–­ç”¨æˆ·æ“ä½œæµç¨‹

### 4.2 Tokenåˆ·æ–°ç­–ç•¥


**ğŸ¯ ç­–ç•¥ä¸€ï¼šè¢«åŠ¨åˆ·æ–°ï¼ˆæ¨èï¼‰**

```javascript
// è¯·æ±‚æ‹¦æˆªå™¨ï¼šè‡ªåŠ¨åˆ·æ–°è¿‡æœŸToken
axios.interceptors.response.use(
  response => response,
  async error => {
    const originalRequest = error.config;
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯Tokenè¿‡æœŸé”™è¯¯
    if (error.response?.status === 401 && !originalRequest._retry) {
      originalRequest._retry = true;
      
      try {
        // ä½¿ç”¨RefreshTokenè·å–æ–°Token
        const refreshToken = localStorage.getItem('refreshToken');
        const response = await axios.post('/api/refresh', {
          refresh_token: refreshToken
        });
        
        const { access_token } = response.data;
        
        // æ›´æ–°Token
        tokenManager.setAccessToken(access_token);
        
        // é‡è¯•åŸè¯·æ±‚
        originalRequest.headers['Authorization'] = `Bearer ${access_token}`;
        return axios(originalRequest);
        
      } catch (refreshError) {
        // åˆ·æ–°å¤±è´¥ï¼Œè·³è½¬ç™»å½•é¡µ
        tokenManager.clearTokens();
        router.push('/login');
        return Promise.reject(refreshError);
      }
    }
    
    return Promise.reject(error);
  }
);
```

**ğŸ¯ ç­–ç•¥äºŒï¼šä¸»åŠ¨åˆ·æ–°**

```javascript
// å®šæ—¶æ£€æŸ¥Tokenè¿‡æœŸæ—¶é—´
class TokenRefreshManager {
  constructor() {
    this.refreshTimer = null;
  }
  
  // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
  startAutoRefresh(token) {
    // è§£æTokenè¿‡æœŸæ—¶é—´
    const payload = JSON.parse(atob(token.split('.')[1]));
    const expiryTime = payload.exp * 1000;
    const currentTime = Date.now();
    
    // æå‰5åˆ†é’Ÿåˆ·æ–°
    const refreshTime = expiryTime - currentTime - 5 * 60 * 1000;
    
    if (refreshTime > 0) {
      this.refreshTimer = setTimeout(() => {
        this.refreshToken();
      }, refreshTime);
    }
  }
  
  // åˆ·æ–°Token
  async refreshToken() {
    try {
      const refreshToken = localStorage.getItem('refreshToken');
      const response = await fetch('/api/refresh', {
        method: 'POST',
        body: JSON.stringify({ refresh_token: refreshToken })
      });
      
      const { access_token } = await response.json();
      tokenManager.setAccessToken(access_token);
      
      // å¯åŠ¨ä¸‹ä¸€æ¬¡åˆ·æ–°
      this.startAutoRefresh(access_token);
      
    } catch (error) {
      console.error('Tokenåˆ·æ–°å¤±è´¥:', error);
      // è·³è½¬ç™»å½•é¡µ
      router.push('/login');
    }
  }
}
```

### 4.3 åˆ·æ–°å¤±è´¥å¤„ç†


**âš ï¸ åˆ·æ–°å¤±è´¥çš„å¸¸è§åŸå› **ï¼š
- `ğŸ”‘ RefreshTokenè¿‡æœŸ`ï¼šç”¨æˆ·é•¿æ—¶é—´æœªä½¿ç”¨åº”ç”¨
- `ğŸš« RefreshTokenæ— æ•ˆ`ï¼šTokenè¢«ç¯¡æ”¹æˆ–æœåŠ¡å™¨é‡ç½®
- `ğŸŒ ç½‘ç»œå¼‚å¸¸`ï¼šç½‘ç»œä¸ç¨³å®šå¯¼è‡´è¯·æ±‚å¤±è´¥
- `ğŸ”’ æƒé™å˜æ›´`ï¼šç”¨æˆ·æƒé™è¢«ç®¡ç†å‘˜ä¿®æ”¹

**ğŸ›¡ï¸ ä¼˜é›…çš„é”™è¯¯å¤„ç†**ï¼š
```javascript
class AuthErrorHandler {
  static handle(error) {
    switch (error.code) {
      case 'REFRESH_TOKEN_EXPIRED':
        // RefreshTokenè¿‡æœŸï¼Œéœ€è¦é‡æ–°ç™»å½•
        this.redirectToLogin('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
        break;
        
      case 'REFRESH_TOKEN_INVALID':
        // RefreshTokenæ— æ•ˆï¼Œæ¸…é™¤æœ¬åœ°æ•°æ®
        tokenManager.clearTokens();
        this.redirectToLogin('ç™»å½•çŠ¶æ€å¼‚å¸¸ï¼Œè¯·é‡æ–°ç™»å½•');
        break;
        
      case 'NETWORK_ERROR':
        // ç½‘ç»œé”™è¯¯ï¼Œæç¤ºç”¨æˆ·ç¨åé‡è¯•
        this.showMessage('ç½‘ç»œå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•');
        break;
        
      default:
        // å…¶ä»–é”™è¯¯ï¼Œé€šç”¨å¤„ç†
        this.redirectToLogin('è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•');
    }
  }
  
  static redirectToLogin(message) {
    // æ˜¾ç¤ºæç¤ºä¿¡æ¯
    alert(message);
    // æ¸…é™¤è®¤è¯æ•°æ®
    tokenManager.clearTokens();
    // è·³è½¬ç™»å½•é¡µ
    window.location.href = '/login';
  }
}
```

---

## 5. ğŸ›¡ï¸ è·¯ç”±å®ˆå«å®ç°


### 5.1 ä»€ä¹ˆæ˜¯è·¯ç”±å®ˆå«


**ğŸ”¸ è·¯ç”±å®ˆå«æœ¬è´¨**ï¼šåœ¨ç”¨æˆ·è®¿é—®é¡µé¢å‰ï¼Œæ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®çš„æœºåˆ¶ã€‚

```
ç”¨æˆ·è®¿é—®æµç¨‹ï¼š
ç”¨æˆ·ç‚¹å‡»é“¾æ¥ â†’ è·¯ç”±å®ˆå«æ£€æŸ¥ â†’ éªŒè¯æƒé™ â†’ å…è®¸/æ‹’ç»è®¿é—®

å®ˆå«ç±»å‹ï¼š
ğŸ“ å…¨å±€å®ˆå«ï¼šæ£€æŸ¥æ‰€æœ‰è·¯ç”±
ğŸ“ è·¯ç”±å®ˆå«ï¼šæ£€æŸ¥ç‰¹å®šè·¯ç”±
ğŸ“ ç»„ä»¶å®ˆå«ï¼šåœ¨ç»„ä»¶å†…æ£€æŸ¥
```

### 5.2 Vue Routerè·¯ç”±å®ˆå«


**ğŸ¯ å…¨å±€å‰ç½®å®ˆå«**ï¼š

```javascript
import router from './router';
import { tokenManager } from './auth';

// éœ€è¦ç™»å½•çš„è·¯ç”±åˆ—è¡¨
const requiresAuthRoutes = ['/dashboard', '/profile', '/settings'];

// å…¨å±€å‰ç½®å®ˆå«
router.beforeEach(async (to, from, next) => {
  // æ£€æŸ¥æ˜¯å¦éœ€è¦ç™»å½•
  const requiresAuth = requiresAuthRoutes.some(route => 
    to.path.startsWith(route)
  );
  
  if (requiresAuth) {
    const token = tokenManager.getAccessToken();
    
    if (!token) {
      // æœªç™»å½•ï¼Œè·³è½¬ç™»å½•é¡µ
      next({
        path: '/login',
        query: { redirect: to.fullPath } // è®°ä½ç›®æ ‡é¡µé¢
      });
      return;
    }
    
    try {
      // éªŒè¯Tokenæœ‰æ•ˆæ€§
      await validateToken(token);
      next(); // Tokenæœ‰æ•ˆï¼Œå…è®¸è®¿é—®
    } catch (error) {
      // Tokenæ— æ•ˆï¼Œæ¸…é™¤å¹¶è·³è½¬ç™»å½•
      tokenManager.clearTokens();
      next('/login');
    }
  } else {
    next(); // ä¸éœ€è¦ç™»å½•çš„é¡µé¢ï¼Œç›´æ¥é€šè¿‡
  }
});

// TokenéªŒè¯å‡½æ•°
async function validateToken(token) {
  const response = await fetch('/api/validate', {
    headers: { 'Authorization': `Bearer ${token}` }
  });
  
  if (!response.ok) {
    throw new Error('Tokenæ— æ•ˆ');
  }
}
```

**ğŸ¯ è·¯ç”±çº§åˆ«å®ˆå«**ï¼š

```javascript
// è·¯ç”±é…ç½®ä¸­çš„å®ˆå«
const routes = [
  {
    path: '/admin',
    component: AdminLayout,
    beforeEnter: (to, from, next) => {
      // æ£€æŸ¥ç®¡ç†å‘˜æƒé™
      const userRole = getUserRole();
      if (userRole === 'admin') {
        next();
      } else {
        next('/403'); // æ— æƒé™é¡µé¢
      }
    }
  }
];
```

### 5.3 React Routerè·¯ç”±å®ˆå«


**ğŸ¯ é«˜é˜¶ç»„ä»¶æ–¹å¼**ï¼š

```javascript
import React from 'react';
import { Navigate, useLocation } from 'react-router-dom';
import { useAuth } from './AuthContext';

// è·¯ç”±å®ˆå«ç»„ä»¶
function ProtectedRoute({ children }) {
  const { isAuthenticated, loading } = useAuth();
  const location = useLocation();
  
  // åŠ è½½ä¸­æ˜¾ç¤ºloading
  if (loading) {
    return <div>Loading...</div>;
  }
  
  // æœªç™»å½•é‡å®šå‘åˆ°ç™»å½•é¡µ
  if (!isAuthenticated) {
    return (
      <Navigate 
        to="/login" 
        state={{ from: location }} 
        replace 
      />
    );
  }
  
  // å·²ç™»å½•æ˜¾ç¤ºé¡µé¢å†…å®¹
  return children;
}

// ä½¿ç”¨ç¤ºä¾‹
function App() {
  return (
    <Routes>
      <Route path="/login" element={<LoginPage />} />
      <Route 
        path="/dashboard" 
        element={
          <ProtectedRoute>
            <Dashboard />
          </ProtectedRoute>
        } 
      />
    </Routes>
  );
}
```

**ğŸ¯ æƒé™çº§åˆ«å®ˆå«**ï¼š

```javascript
// æƒé™æ£€æŸ¥ç»„ä»¶
function RequireAuth({ children, requiredRole }) {
  const { user, isAuthenticated } = useAuth();
  
  if (!isAuthenticated) {
    return <Navigate to="/login" />;
  }
  
  if (requiredRole && user.role !== requiredRole) {
    return <Navigate to="/403" />; // æ— æƒé™é¡µé¢
  }
  
  return children;
}

// ä½¿ç”¨ç¤ºä¾‹
<Route 
  path="/admin" 
  element={
    <RequireAuth requiredRole="admin">
      <AdminPanel />
    </RequireAuth>
  } 
/>
```

---

## 6. ğŸ“± ç§»åŠ¨ç«¯è®¤è¯ç­–ç•¥


### 6.1 ç§»åŠ¨APPè®¤è¯ç‰¹ç‚¹


**ğŸ”¸ ç§»åŠ¨ç«¯vs Webç«¯å·®å¼‚**ï¼š

```
Webç«¯ç‰¹ç‚¹ï¼š
- Cookieæ”¯æŒè‰¯å¥½
- æµè§ˆå™¨å®‰å…¨æ²™ç®±
- ç”¨æˆ·ä¸»åŠ¨è®¿é—®

ç§»åŠ¨ç«¯ç‰¹ç‚¹ï¼š
- åŸç”Ÿå­˜å‚¨API
- åº”ç”¨æ²™ç®±ç¯å¢ƒ  
- æ¨é€é€šçŸ¥æ”¯æŒ
- ç”Ÿç‰©è¯†åˆ«å¯ç”¨
```

**ğŸ“± ç§»åŠ¨ç«¯è®¤è¯ä¼˜åŠ¿**ï¼š
- `ğŸ”’ å­˜å‚¨æ›´å®‰å…¨`ï¼šåº”ç”¨æ²™ç®±ä¿æŠ¤
- `ğŸ‘† ç”Ÿç‰©è¯†åˆ«`ï¼šæŒ‡çº¹ã€äººè„¸è¯†åˆ«
- `ğŸ“² æ¨é€éªŒè¯`ï¼šçŸ­ä¿¡ã€æ¨é€éªŒè¯ç 
- `â±ï¸ é•¿æœŸæœ‰æ•ˆ`ï¼šç”¨æˆ·ä½¿ç”¨ä¹ æƒ¯ä¸åŒ

### 6.2 React Nativeè®¤è¯å®ç°


**ğŸ¯ åŸºç¡€è®¤è¯æµç¨‹**ï¼š

```javascript
// AsyncStorageå®‰å…¨å­˜å‚¨
import AsyncStorage from '@react-native-async-storage/async-storage';
import { Alert } from 'react-native';

class MobileAuthManager {
  // å­˜å‚¨Token
  static async storeTokens(accessToken, refreshToken) {
    try {
      await AsyncStorage.multiSet([
        ['access_token', accessToken],
        ['refresh_token', refreshToken],
        ['login_time', Date.now().toString()]
      ]);
    } catch (error) {
      console.error('Tokenå­˜å‚¨å¤±è´¥:', error);
    }
  }
  
  // è·å–Token
  static async getAccessToken() {
    try {
      return await AsyncStorage.getItem('access_token');
    } catch (error) {
      console.error('Tokenè·å–å¤±è´¥:', error);
      return null;
    }
  }
  
  // æ¸…é™¤Token
  static async clearTokens() {
    try {
      await AsyncStorage.multiRemove([
        'access_token', 
        'refresh_token', 
        'login_time'
      ]);
    } catch (error) {
      console.error('Tokenæ¸…é™¤å¤±è´¥:', error);
    }
  }
}
```

**ğŸ¯ ç”Ÿç‰©è¯†åˆ«é›†æˆ**ï¼š

```javascript
import TouchID from 'react-native-touch-id';

class BiometricAuth {
  // æ£€æŸ¥ç”Ÿç‰©è¯†åˆ«æ”¯æŒ
  static async isSupported() {
    try {
      const biometryType = await TouchID.isSupported();
      return biometryType !== false;
    } catch (error) {
      return false;
    }
  }
  
  // ç”Ÿç‰©è¯†åˆ«ç™»å½•
  static async authenticate() {
    const optionalConfigObject = {
      title: 'ç”Ÿç‰©è¯†åˆ«ç™»å½•',
      subtitle: 'è¯·éªŒè¯æ‚¨çš„èº«ä»½',
      description: 'ä½¿ç”¨æŒ‡çº¹æˆ–é¢å®¹IDå¿«é€Ÿç™»å½•',
      fallbackLabel: 'ä½¿ç”¨å¯†ç ',
      cancelText: 'å–æ¶ˆ',
    };
    
    try {
      const isAuthenticated = await TouchID.authenticate(
        'è¯·è¿›è¡Œç”Ÿç‰©è¯†åˆ«éªŒè¯',
        optionalConfigObject
      );
      
      if (isAuthenticated) {
        // ç”Ÿç‰©è¯†åˆ«æˆåŠŸï¼Œè·å–å­˜å‚¨çš„Token
        const token = await MobileAuthManager.getAccessToken();
        return token;
      }
    } catch (error) {
      console.error('ç”Ÿç‰©è¯†åˆ«å¤±è´¥:', error);
      throw error;
    }
  }
}
```

### 6.3 Flutterè®¤è¯å®ç°


**ğŸ¯ åŸºç¡€è®¤è¯æœåŠ¡**ï¼š

```dart
// Dart/Flutterè®¤è¯ç®¡ç†
import 'package:shared_preferences/shared_preferences.dart';
import 'package:local_auth/local_auth.dart';

class FlutterAuthManager {
  static const String _tokenKey = 'access_token';
  static const String _refreshTokenKey = 'refresh_token';
  
  // å­˜å‚¨Token
  static Future<void> storeTokens(String accessToken, String refreshToken) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setString(_tokenKey, accessToken);
    await prefs.setString(_refreshTokenKey, refreshToken);
  }
  
  // è·å–Token
  static Future<String?> getAccessToken() async {
    final prefs = await SharedPreferences.getInstance();
    return prefs.getString(_tokenKey);
  }
  
  // ç”Ÿç‰©è¯†åˆ«è®¤è¯
  static Future<bool> authenticateWithBiometrics() async {
    final LocalAuthentication localAuth = LocalAuthentication();
    
    try {
      final bool isAvailable = await localAuth.canCheckBiometrics;
      if (!isAvailable) return false;
      
      final bool isAuthenticated = await localAuth.authenticate(
        localizedReason: 'è¯·ä½¿ç”¨ç”Ÿç‰©è¯†åˆ«éªŒè¯èº«ä»½',
        options: AuthenticationOptions(
          biometricOnly: true,
          stickyAuth: true,
        ),
      );
      
      return isAuthenticated;
    } catch (e) {
      print('ç”Ÿç‰©è¯†åˆ«é”™è¯¯: $e');
      return false;
    }
  }
}
```

### 6.4 æ··åˆåº”ç”¨è®¤è¯ç­–ç•¥


**ğŸ¯ Cordova/PhoneGapæ–¹æ¡ˆ**ï¼š

```javascript
// æ··åˆåº”ç”¨è®¤è¯æ’ä»¶ä½¿ç”¨
document.addEventListener('deviceready', function() {
  // æ£€æŸ¥æŒ‡çº¹è¯†åˆ«æ”¯æŒ
  window.plugins.touchid.isAvailable(
    function(msg) {
      console.log('TouchIDå¯ç”¨: ' + msg);
    },
    function(msg) {
      console.log('TouchIDä¸å¯ç”¨: ' + msg);
    }
  );
  
  // æ‰§è¡ŒæŒ‡çº¹è¯†åˆ«
  window.plugins.touchid.authenticate(
    function(msg) {
      console.log('è®¤è¯æˆåŠŸ: ' + msg);
      // æ‰§è¡Œç™»å½•é€»è¾‘
    },
    function(msg) {
      console.log('è®¤è¯å¤±è´¥: ' + msg);
    },
    'è¯·è¿›è¡ŒæŒ‡çº¹éªŒè¯'
  );
});
```

---

## 7. ğŸ”’ å‰ç«¯å®‰å…¨é˜²æŠ¤


### 7.1 XSSé˜²æŠ¤ç­–ç•¥


**ğŸ”¸ ä»€ä¹ˆæ˜¯XSSæ”»å‡»**ï¼š
```
XSS (Cross-Site Scripting)ï¼šè·¨ç«™è„šæœ¬æ”»å‡»
åŸç†ï¼šåœ¨ç½‘é¡µä¸­æ³¨å…¥æ¶æ„è„šæœ¬ï¼Œçªƒå–ç”¨æˆ·ä¿¡æ¯

æ”»å‡»ç¤ºä¾‹ï¼š
æ¶æ„ç”¨æˆ·æäº¤ï¼š<script>alert(document.cookie)</script>
å¦‚æœç›´æ¥æ¸²æŸ“ï¼šå¼¹å‡ºCookieä¿¡æ¯ï¼Œæš´éœ²ç”¨æˆ·æ•°æ®
```

**ğŸ›¡ï¸ XSSé˜²æŠ¤æ–¹æ¡ˆ**ï¼š

```javascript
// 1. è¾“å…¥éªŒè¯å’Œè½¬ä¹‰
function escapeHtml(unsafe) {
  return unsafe
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

// 2. ä½¿ç”¨å®‰å…¨çš„DOMæ“ä½œ
// âŒ å±é™©æ–¹å¼
element.innerHTML = userInput;

// âœ… å®‰å…¨æ–¹å¼
element.textContent = userInput;
// æˆ–ä½¿ç”¨
element.insertAdjacentText('afterbegin', userInput);

// 3. CSPå†…å®¹å®‰å…¨ç­–ç•¥é…ç½®
// HTTPå“åº”å¤´è®¾ç½®
Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline'
```

### 7.2 CSRFé˜²æŠ¤ç­–ç•¥


**ğŸ”¸ ä»€ä¹ˆæ˜¯CSRFæ”»å‡»**ï¼š
```
CSRF (Cross-Site Request Forgery)ï¼šè·¨ç«™è¯·æ±‚ä¼ªé€ 
åŸç†ï¼šåˆ©ç”¨ç”¨æˆ·å·²ç™»å½•çŠ¶æ€ï¼Œä¼ªé€ ç”¨æˆ·è¯·æ±‚

æ”»å‡»æµç¨‹ï¼š
ç”¨æˆ·ç™»å½•Aç½‘ç«™ â†’ è®¿é—®æ¶æ„ç½‘ç«™B â†’ Bç½‘ç«™å‘Aç½‘ç«™å‘é€è¯·æ±‚ â†’ 
è¯·æ±‚æºå¸¦Aç½‘ç«™Cookie â†’ Aç½‘ç«™è¯¯è®¤ä¸ºæ˜¯ç”¨æˆ·æ“ä½œ
```

**ğŸ›¡ï¸ CSRFé˜²æŠ¤æ–¹æ¡ˆ**ï¼š

```javascript
// 1. CSRF TokenéªŒè¯
// è·å–CSRF Token
function getCSRFToken() {
  return document.querySelector('meta[name="csrf-token"]').content;
}

// æ‰€æœ‰è¯·æ±‚æºå¸¦CSRF Token
fetch('/api/transfer', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'X-CSRF-Token': getCSRFToken()
  },
  body: JSON.stringify({ amount: 1000 })
});

// 2. åŒæºæ£€æŸ¥
// éªŒè¯Refererå¤´
function validateReferer(request) {
  const referer = request.headers.referer;
  const allowedOrigins = ['https://myapp.com'];
  return allowedOrigins.some(origin => referer.startsWith(origin));
}

// 3. åŒCookieéªŒè¯
// è®¾ç½®éšæœºCookieï¼ŒåŒæ—¶åœ¨è¯·æ±‚å¤´ä¸­å‘é€ç›¸åŒå€¼
document.cookie = `csrf_token=${randomToken}; SameSite=Strict`;
```

### 7.3 ç‚¹å‡»åŠ«æŒé˜²æŠ¤


**ğŸ”¸ ä»€ä¹ˆæ˜¯ç‚¹å‡»åŠ«æŒ**ï¼š
```
Clickjackingï¼šç‚¹å‡»åŠ«æŒæ”»å‡»
åŸç†ï¼šå°†ç›®æ ‡ç½‘ç«™åµŒå…¥é€æ˜iframeï¼Œè¯±å¯¼ç”¨æˆ·ç‚¹å‡»

æ”»å‡»ç¤ºä¾‹ï¼š
æ¶æ„ç½‘ç«™æ˜¾ç¤º"ç‚¹å‡»è·å–å¥–å“"æŒ‰é’®
å®é™…ç‚¹å‡»çš„æ˜¯iframeä¸­çš„"ç¡®è®¤è½¬è´¦"æŒ‰é’®
ç”¨æˆ·åœ¨ä¸çŸ¥æƒ…æƒ…å†µä¸‹æ‰§è¡Œäº†å±é™©æ“ä½œ
```

**ğŸ›¡ï¸ ç‚¹å‡»åŠ«æŒé˜²æŠ¤**ï¼š

```javascript
// 1. X-Frame-Optionså“åº”å¤´
// æœåŠ¡å™¨é…ç½®ï¼šç¦æ­¢è¢«iframeåµŒå…¥
X-Frame-Options: DENY
// æˆ–åªå…è®¸åŒæºåµŒå…¥
X-Frame-Options: SAMEORIGIN

// 2. JavaScripté˜²æŠ¤
// æ£€æŸ¥é¡µé¢æ˜¯å¦è¢«åµŒå…¥
if (window.top !== window.self) {
  // è¢«åµŒå…¥iframeä¸­ï¼Œè·³è½¬åˆ°é¡¶çº§çª—å£
  window.top.location = window.self.location;
}

// 3. CSSé˜²æŠ¤
// éšè—é¡µé¢ç›´åˆ°ç¡®è®¤ä¸åœ¨iframeä¸­
<style id="antiClickjack">
  body { display: none !important; }
</style>
<script>
  if (self === top) {
    document.getElementById("antiClickjack").remove();
  }
</script>
```

---

## 8. ğŸ”§ æ¡†æ¶é›†æˆæ–¹æ¡ˆ


### 8.1 Reactè®¤è¯æ–¹æ¡ˆ


**ğŸ¯ Context + Hooksæ–¹æ¡ˆ**ï¼š

```javascript
// AuthContext.js
import React, { createContext, useContext, useReducer, useEffect } from 'react';

const AuthContext = createContext();

const authReducer = (state, action) => {
  switch (action.type) {
    case 'LOGIN_SUCCESS':
      return {
        ...state,
        isAuthenticated: true,
        user: action.payload.user,
        loading: false
      };
    case 'LOGOUT':
      return {
        ...state,
        isAuthenticated: false,
        user: null,
        loading: false
      };
    case 'LOADING':
      return { ...state, loading: true };
    default:
      return state;
  }
};

// AuthProviderç»„ä»¶
export function AuthProvider({ children }) {
  const [state, dispatch] = useReducer(authReducer, {
    isAuthenticated: false,
    user: null,
    loading: true
  });
  
  // åˆå§‹åŒ–æ£€æŸ¥ç™»å½•çŠ¶æ€
  useEffect(() => {
    const initAuth = async () => {
      const token = tokenManager.getAccessToken();
      if (token) {
        try {
          const user = await fetchUserInfo(token);
          dispatch({ type: 'LOGIN_SUCCESS', payload: { user } });
        } catch (error) {
          tokenManager.clearTokens();
        }
      }
      dispatch({ type: 'LOADING', payload: false });
    };
    
    initAuth();
  }, []);
  
  const login = async (credentials) => {
    dispatch({ type: 'LOADING' });
    try {
      const { token, user } = await apiLogin(credentials);
      tokenManager.setTokens(token);
      dispatch({ type: 'LOGIN_SUCCESS', payload: { user } });
    } catch (error) {
      throw error;
    }
  };
  
  const logout = () => {
    tokenManager.clearTokens();
    dispatch({ type: 'LOGOUT' });
  };
  
  return (
    <AuthContext.Provider value={{ ...state, login, logout }}>
      {children}
    </AuthContext.Provider>
  );
}

// è‡ªå®šä¹‰Hook
export const useAuth = () => {
  const context = useContext(AuthContext);
  if (!context) {
    throw new Error('useAuthå¿…é¡»åœ¨AuthProviderå†…ä½¿ç”¨');
  }
  return context;
};
```

### 8.2 Vueè®¤è¯æ–¹æ¡ˆ


**ğŸ¯ PiniaçŠ¶æ€ç®¡ç†æ–¹æ¡ˆ**ï¼š

```javascript
// stores/auth.js
import { defineStore } from 'pinia';
import { tokenManager } from '@/utils/auth';

export const useAuthStore = defineStore('auth', {
  state: () => ({
    isAuthenticated: false,
    user: null,
    loading: false
  }),
  
  getters: {
    hasRole: (state) => (role) => {
      return state.user?.roles?.includes(role) || false;
    }
  },
  
  actions: {
    async login(credentials) {
      this.loading = true;
      try {
        const response = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(credentials)
        });
        
        const { token, user } = await response.json();
        
        tokenManager.setTokens(token);
        this.isAuthenticated = true;
        this.user = user;
        
        return { success: true };
      } catch (error) {
        return { success: false, error: error.message };
      } finally {
        this.loading = false;
      }
    },
    
    logout() {
      tokenManager.clearTokens();
      this.isAuthenticated = false;
      this.user = null;
      this.$router.push('/login');
    },
    
    async initAuth() {
      const token = tokenManager.getAccessToken();
      if (token) {
        try {
          const user = await this.fetchUserInfo();
          this.isAuthenticated = true;
          this.user = user;
        } catch (error) {
          this.logout();
        }
      }
    }
  }
});
```

### 8.3 Angularè®¤è¯æ–¹æ¡ˆ


**ğŸ¯ Service + Guardæ–¹æ¡ˆ**ï¼š

```typescript
// auth.service.ts
import { Injectable } from '@angular/core';
import { BehaviorSubject, Observable } from 'rxjs';
import { HttpClient } from '@angular/common/http';

@Injectable({ providedIn: 'root' })
export class AuthService {
  private isAuthenticatedSubject = new BehaviorSubject<boolean>(false);
  private userSubject = new BehaviorSubject<any>(null);
  
  public isAuthenticated$ = this.isAuthenticatedSubject.asObservable();
  public user$ = this.userSubject.asObservable();
  
  constructor(private http: HttpClient) {
    this.initAuth();
  }
  
  async login(credentials: any): Promise<any> {
    try {
      const response = await this.http.post<any>('/api/login', credentials).toPromise();
      
      tokenManager.setTokens(response.token, response.refreshToken);
      this.isAuthenticatedSubject.next(true);
      this.userSubject.next(response.user);
      
      return { success: true };
    } catch (error) {
      return { success: false, error };
    }
  }
  
  logout(): void {
    tokenManager.clearTokens();
    this.isAuthenticatedSubject.next(false);
    this.userSubject.next(null);
  }
  
  private async initAuth(): Promise<void> {
    const token = tokenManager.getAccessToken();
    if (token) {
      try {
        const user = await this.fetchUserInfo().toPromise();
        this.isAuthenticatedSubject.next(true);
        this.userSubject.next(user);
      } catch (error) {
        this.logout();
      }
    }
  }
}

// auth.guard.ts
@Injectable({ providedIn: 'root' })
export class AuthGuard implements CanActivate {
  constructor(
    private authService: AuthService,
    private router: Router
  ) {}
  
  canActivate(): Observable<boolean> {
    return this.authService.isAuthenticated$.pipe(
      map(isAuthenticated => {
        if (!isAuthenticated) {
          this.router.navigate(['/login']);
          return false;
        }
        return true;
      })
    );
  }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ SPAè®¤è¯ï¼šå•é¡µåº”ç”¨çš„Tokené©±åŠ¨è®¤è¯æœºåˆ¶
ğŸ”¸ å­˜å‚¨ç­–ç•¥ï¼šlocalStorageã€sessionStorageã€Memoryçš„ä¼˜ç¼ºç‚¹å¯¹æ¯”
ğŸ”¸ è·¨åŸŸå¤„ç†ï¼šCORSé…ç½®ã€ä»£ç†è½¬å‘ã€é¢„æ£€è¯·æ±‚ä¼˜åŒ–
ğŸ”¸ æ— æ„Ÿåˆ·æ–°ï¼šTokenè‡ªåŠ¨åˆ·æ–°æœºåˆ¶ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
ğŸ”¸ è·¯ç”±å®ˆå«ï¼šæƒé™æ§åˆ¶çš„å‰ç«¯å®ç°æ–¹æ¡ˆ
ğŸ”¸ ç§»åŠ¨ç«¯ç­–ç•¥ï¼šåŸç”Ÿåº”ç”¨çš„å®‰å…¨å­˜å‚¨å’Œç”Ÿç‰©è¯†åˆ«
ğŸ”¸ å®‰å…¨é˜²æŠ¤ï¼šXSSã€CSRFã€ç‚¹å‡»åŠ«æŒçš„é˜²æŠ¤æ–¹æ³•
ğŸ”¸ æ¡†æ¶é›†æˆï¼šReactã€Vueã€Angularçš„è®¤è¯æ–¹æ¡ˆ
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ Tokenå­˜å‚¨çš„å®‰å…¨è€ƒé‡**ï¼š
```
å®‰å…¨æ€§æ’åºï¼šMemory > sessionStorage > localStorage > Cookie
æ¨èæ–¹æ¡ˆï¼šAccessTokenå­˜Memoryï¼ŒRefreshTokenå­˜localStorage
æ ¸å¿ƒåŸåˆ™ï¼šçŸ­æœŸTokené«˜å®‰å…¨ï¼Œé•¿æœŸTokenä¿æŒç™»å½•
```

**ğŸ”¹ è·¨åŸŸè®¤è¯çš„æœ¬è´¨**ï¼š
```
æ ¹æœ¬é—®é¢˜ï¼šæµè§ˆå™¨åŒæºç­–ç•¥é™åˆ¶
è§£å†³æ€è·¯ï¼šæœåŠ¡å™¨ä¸»åŠ¨å…è®¸ + å®¢æˆ·ç«¯æ­£ç¡®é…ç½®
å…³é”®é…ç½®ï¼šcredentialsã€CORSå¤´ã€é¢„æ£€ç¼“å­˜
```

**ğŸ”¹ æ— æ„Ÿåˆ·æ–°çš„ä»·å€¼**ï¼š
```
ç”¨æˆ·ä»·å€¼ï¼šæ— éœ€é‡å¤ç™»å½•ï¼Œä½¿ç”¨ä½“éªŒæµç•…
å®‰å…¨ä»·å€¼ï¼šAccessTokençŸ­æœŸåŒ–ï¼Œé™ä½æ³„éœ²é£é™©
æŠ€æœ¯ä»·å€¼ï¼šè‡ªåŠ¨åŒ–å¤„ç†ï¼Œå‡å°‘æ‰‹åŠ¨å¹²é¢„
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ æŠ€æœ¯é€‰å‹å»ºè®®**ï¼š
```
ä¼ä¸šçº§åº”ç”¨ï¼š
âœ… é‡‡ç”¨Memory+localStorageæ··åˆå­˜å‚¨
âœ… å®ç°å®Œæ•´çš„æ— æ„Ÿåˆ·æ–°æœºåˆ¶
âœ… é…ç½®ä¸¥æ ¼çš„CORSç­–ç•¥
âœ… é›†æˆå®Œå–„çš„é”™è¯¯å¤„ç†

ä¸ªäººé¡¹ç›®ï¼š
âœ… localStorageå­˜å‚¨å³å¯
âœ… åŸºç¡€çš„TokenéªŒè¯
âœ… ç®€å•çš„è·¯ç”±å®ˆå«
âœ… åŸºæœ¬çš„å®‰å…¨é˜²æŠ¤
```

**ğŸ”§ å¼€å‘å®è·µè¦ç‚¹**ï¼š
```
å¼€å‘é˜¶æ®µï¼š
ğŸ“ è®¾è®¡æ¸…æ™°çš„è®¤è¯çŠ¶æ€ç®¡ç†
ğŸ“ å®ç°ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶
ğŸ“ é…ç½®å¼€å‘ç¯å¢ƒçš„ä»£ç†è½¬å‘

æµ‹è¯•é˜¶æ®µï¼š
ğŸ§ª æµ‹è¯•Tokenè¿‡æœŸåœºæ™¯
ğŸ§ª æµ‹è¯•ç½‘ç»œå¼‚å¸¸å¤„ç†
ğŸ§ª æµ‹è¯•å®‰å…¨æ”»å‡»é˜²æŠ¤

éƒ¨ç½²é˜¶æ®µï¼š
ğŸš€ é…ç½®ç”Ÿäº§ç¯å¢ƒCORS
ğŸš€ å¯ç”¨HTTPSä¼ è¾“
ğŸš€ è®¾ç½®å®‰å…¨å“åº”å¤´
```

**ğŸ’¡ å®‰å…¨æ³¨æ„äº‹é¡¹**ï¼š
```
æ°¸è¿œä¸è¦ï¼š
âŒ åœ¨URLå‚æ•°ä¸­ä¼ é€’Token
âŒ åœ¨æ§åˆ¶å°æ‰“å°æ•æ„Ÿä¿¡æ¯
âŒ å¿½ç•¥HTTPSçš„é‡è¦æ€§
âŒ ä¿¡ä»»ç”¨æˆ·è¾“å…¥æ•°æ®

å§‹ç»ˆè®°ä½ï¼š
âœ… éªŒè¯æ‰€æœ‰ç”¨æˆ·è¾“å…¥
âœ… ä½¿ç”¨æœ€å°æƒé™åŸåˆ™
âœ… å®šæœŸæ›´æ–°ä¾èµ–åº“
âœ… ç›‘æ§å¼‚å¸¸ç™»å½•è¡Œä¸º
```

### 9.4 å­¦ä¹ è·¯å¾„å»ºè®®


**ğŸ“ å…¥é—¨é˜¶æ®µ**ï¼š
1. ç†è§£Tokenè®¤è¯åŸºç¡€æ¦‚å¿µ
2. æŒæ¡åŸºæœ¬çš„ç™»å½•ç™»å‡ºæµç¨‹  
3. å­¦ä¼šç®€å•çš„è·¯ç”±æƒé™æ§åˆ¶
4. äº†è§£å¸¸è§çš„å®‰å…¨é—®é¢˜

**ğŸ”¥ è¿›é˜¶é˜¶æ®µ**ï¼š
1. å®ç°å®Œæ•´çš„æ— æ„Ÿåˆ·æ–°æœºåˆ¶
2. è§£å†³å¤æ‚çš„è·¨åŸŸè®¤è¯é—®é¢˜
3. é›†æˆç”Ÿç‰©è¯†åˆ«ç­‰é«˜çº§ç‰¹æ€§
4. ä¼˜åŒ–è®¤è¯ç›¸å…³çš„ç”¨æˆ·ä½“éªŒ

**âš¡ é«˜çº§é˜¶æ®µ**ï¼š
1. è®¾è®¡ä¼ä¸šçº§çš„è®¤è¯æ¶æ„
2. å®ç°å¤šç«¯ç»Ÿä¸€çš„è®¤è¯æ–¹æ¡ˆ
3. å¤„ç†å¤§è§„æ¨¡åº”ç”¨çš„æ€§èƒ½é—®é¢˜
4. ç ”ç©¶æœ€æ–°çš„å®‰å…¨é˜²æŠ¤æŠ€æœ¯

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
å‰ç«¯è®¤è¯Tokenä¸ºç‹ï¼Œå®‰å…¨å­˜å‚¨æ˜¯å…³é”®
è·¨åŸŸé…ç½®CORSå¤´ï¼Œæ— æ„Ÿåˆ·æ–°ç”¨æˆ·çˆ½
è·¯ç”±å®ˆå«æŠŠå¥½å…³ï¼Œç§»åŠ¨ç”Ÿç‰©æ›´å®‰å…¨
XSSé˜²æŠ¤è¾“å…¥éªŒï¼ŒCSRFä»¤ç‰Œä¸èƒ½å¿˜
æ¡†æ¶é›†æˆæœ‰å¥—è·¯ï¼Œå®æˆ˜ç»éªŒæœ€é‡è¦
```