---
title: 9ã€Spring_Securityå®æˆ˜
---
## ğŸ“š ç›®å½•

1. [Spring Securityæ ¸å¿ƒæ¦‚å¿µ](#1-spring-securityæ ¸å¿ƒæ¦‚å¿µ)
2. [æ ¸å¿ƒç»„ä»¶æ·±å…¥ç†è§£](#2-æ ¸å¿ƒç»„ä»¶æ·±å…¥ç†è§£)
3. [è‡ªå®šä¹‰ç™»å½•è®¤è¯é€»è¾‘](#3-è‡ªå®šä¹‰ç™»å½•è®¤è¯é€»è¾‘)
4. [JWTé›†æˆå®æˆ˜](#4-jwté›†æˆå®æˆ˜)
5. [æƒé™æ§åˆ¶ä¸æ³¨è§£](#5-æƒé™æ§åˆ¶ä¸æ³¨è§£)
6. [OAuth2é›†æˆå®æˆ˜](#6-oauth2é›†æˆå®æˆ˜)
7. [SecurityContextä¸çº¿ç¨‹å®‰å…¨](#7-securitycontextä¸çº¿ç¨‹å®‰å…¨)
8. [å¤šç”¨æˆ·ç±»å‹å¤„ç†](#8-å¤šç”¨æˆ·ç±»å‹å¤„ç†)
9. [å¼‚å¸¸å¤„ç†ä¸å®šåˆ¶åŒ–](#9-å¼‚å¸¸å¤„ç†ä¸å®šåˆ¶åŒ–)
10. [æ— çŠ¶æ€æ¶æ„é…ç½®](#10-æ— çŠ¶æ€æ¶æ„é…ç½®)
11. [ç¬¬ä¸‰æ–¹å¹³å°é›†æˆ](#11-ç¬¬ä¸‰æ–¹å¹³å°é›†æˆ)
12. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#12-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” Spring Securityæ ¸å¿ƒæ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Spring Securityï¼Ÿ


> ğŸ’¡ **ç®€å•ç†è§£**ï¼šSpring Securityå°±åƒæ˜¯ä½ å®¶çš„é—¨å«ç³»ç»Ÿï¼Œè´Ÿè´£æ£€æŸ¥è°èƒ½è¿›é—¨ã€è°èƒ½è®¿é—®å“ªäº›æˆ¿é—´

**æ ¸å¿ƒä½œç”¨**ï¼š
- **è®¤è¯**ï¼ˆAuthenticationï¼‰ï¼šéªŒè¯ä½ æ˜¯è°ï¼ˆèº«ä»½è¯æ£€æŸ¥ï¼‰
- **æˆæƒ**ï¼ˆAuthorizationï¼‰ï¼šéªŒè¯ä½ èƒ½åšä»€ä¹ˆï¼ˆæƒé™æ£€æŸ¥ï¼‰
- **æ”»å‡»é˜²æŠ¤**ï¼šé˜²æ­¢å„ç§æ¶æ„æ”»å‡»

```
ç°å®ä¸­çš„å®‰ä¿ç³»ç»Ÿï¼š                Spring Securityç³»ç»Ÿï¼š
     å¤§é—¨                           FilterChain
      |                               |
   èº«ä»½éªŒè¯                      AuthenticationManager
      |                               |
   æƒé™æ£€æŸ¥                     AuthorizationManager
      |                               |
   è¿›å…¥æˆ¿é—´                        è®¿é—®èµ„æº
```

### 1.2 Spring Securityçš„å·¥ä½œåŸç†


> ğŸ“– **æ ¸å¿ƒæ€æƒ³**ï¼šé€šè¿‡ä¸€ç³»åˆ—è¿‡æ»¤å™¨ï¼ˆFilterï¼‰å¯¹è¯·æ±‚è¿›è¡Œå±‚å±‚æ£€æŸ¥

**å·¥ä½œæµç¨‹**ï¼š
```
ç”¨æˆ·è¯·æ±‚ â†’ è¿‡æ»¤å™¨é“¾ â†’ èº«ä»½éªŒè¯ â†’ æƒé™æ£€æŸ¥ â†’ è®¿é—®èµ„æº

è¯¦ç»†æµç¨‹ï¼š
HTTPè¯·æ±‚
    â†“
SecurityFilterChain (è¿‡æ»¤å™¨é“¾)
    â†“
UsernamePasswordAuthenticationFilter (ç™»å½•è¿‡æ»¤å™¨)
    â†“
AuthenticationManager (è®¤è¯ç®¡ç†å™¨)
    â†“
UserDetailsService (ç”¨æˆ·ä¿¡æ¯æœåŠ¡)
    â†“
AuthorizationFilter (æƒé™è¿‡æ»¤å™¨)
    â†“
è®¿é—®ç›®æ ‡èµ„æº
```

### 1.3 ä¸ºä»€ä¹ˆéœ€è¦Spring Securityï¼Ÿ


**ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜**ï¼š
```java
// ä¼ ç»Ÿæ–¹å¼ï¼šæ¯ä¸ªæ¥å£éƒ½è¦å†™é‡å¤ä»£ç 
@GetMapping("/admin")
public String adminPage(HttpSession session) {
    User user = (User) session.getAttribute("user");
    if (user == null) {
        return "è¯·å…ˆç™»å½•";  // é‡å¤çš„ç™»å½•æ£€æŸ¥
    }
    if (!"admin".equals(user.getRole())) {
        return "æƒé™ä¸è¶³";  // é‡å¤çš„æƒé™æ£€æŸ¥
    }
    return "ç®¡ç†å‘˜é¡µé¢";
}
```

**Spring Securityæ–¹å¼**ï¼š
```java
// Spring Securityï¼šæ³¨è§£æå®š
@GetMapping("/admin")
@PreAuthorize("hasRole('ADMIN')")  // ä¸€ä¸ªæ³¨è§£è§£å†³è®¤è¯+æˆæƒ
public String adminPage() {
    return "ç®¡ç†å‘˜é¡µé¢";  // åªå…³æ³¨ä¸šåŠ¡é€»è¾‘
}
```

---

## 2. ğŸ”§ æ ¸å¿ƒç»„ä»¶æ·±å…¥ç†è§£


### 2.1 FilterChainï¼ˆè¿‡æ»¤å™¨é“¾ï¼‰


> ğŸ’¡ **å½¢è±¡æ¯”å–»**ï¼šFilterChainå°±åƒæœºåœºå®‰æ£€ï¼Œæ¯ä¸ªç¯èŠ‚éƒ½è¦è¿‡å…³æ‰èƒ½ç™»æœº

**æ ¸å¿ƒä½œç”¨**ï¼š
- æŒ‰é¡ºåºæ‰§è¡Œå®‰å…¨æ£€æŸ¥
- æ¯ä¸ªFilterè´Ÿè´£ä¸åŒçš„å®‰å…¨ä»»åŠ¡
- ä»»ä½•ä¸€ä¸ªç¯èŠ‚ä¸é€šè¿‡éƒ½ä¼šè¢«æ‹¦æˆª

**ä¸»è¦è¿‡æ»¤å™¨**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SecurityContextPersistenceFilter  â”‚ â† æ¢å¤å®‰å…¨ä¸Šä¸‹æ–‡
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  UsernamePasswordAuthenticationFilter â”‚ â† å¤„ç†ç™»å½•
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  BasicAuthenticationFilter  â”‚ â† å¤„ç†åŸºç¡€è®¤è¯
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  JwtAuthenticationFilter    â”‚ â† å¤„ç†JWTè®¤è¯
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  AuthorizationFilter        â”‚ â† æƒé™æ£€æŸ¥
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è‡ªå®šä¹‰è¿‡æ»¤å™¨ç¤ºä¾‹**ï¼š
```java
// è‡ªå®šä¹‰JWTè¿‡æ»¤å™¨
public class JwtAuthenticationFilter extends OncePerRequestFilter {
    
    @Override
    protected void doFilterInternal(HttpServletRequest request, 
                                  HttpServletResponse response, 
                                  FilterChain filterChain) throws ServletException, IOException {
        
        // 1. ä»è¯·æ±‚å¤´è·å–token
        String token = request.getHeader("Authorization");
        
        if (token != null && token.startsWith("Bearer ")) {
            // 2. éªŒè¯tokenå¹¶è®¾ç½®ç”¨æˆ·ä¿¡æ¯
            String username = jwtUtil.getUsernameFromToken(token);
            // 3. è®¾ç½®åˆ°Spring Securityä¸Šä¸‹æ–‡
            setAuthenticationInContext(username);
        }
        
        // 4. ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨
        filterChain.doFilter(request, response);
    }
}
```

### 2.2 AuthenticationManagerï¼ˆè®¤è¯ç®¡ç†å™¨ï¼‰


> ğŸ’¡ **å½¢è±¡æ¯”å–»**ï¼šAuthenticationManagerå°±åƒæ˜¯èº«ä»½éªŒè¯çš„æ€»æŒ‡æŒ¥ï¼Œè´Ÿè´£åè°ƒå„ç§è®¤è¯æ–¹å¼

**æ ¸å¿ƒèŒè´£**ï¼š
- ç®¡ç†å¤šç§è®¤è¯æ–¹å¼ï¼ˆç”¨æˆ·åå¯†ç ã€JWTã€OAuth2ç­‰ï¼‰
- åè°ƒè®¤è¯æä¾›è€…ï¼ˆAuthenticationProviderï¼‰
- è¿”å›è®¤è¯ç»“æœ

**è®¤è¯æµç¨‹**ï¼š
```
ç”¨æˆ·æäº¤è®¤è¯ä¿¡æ¯
        â†“
AuthenticationManageræ¥æ”¶
        â†“
é€‰æ‹©åˆé€‚çš„AuthenticationProvider
        â†“
è°ƒç”¨UserDetailsServiceè·å–ç”¨æˆ·ä¿¡æ¯
        â†“
å¯†ç éªŒè¯/TokenéªŒè¯
        â†“
è¿”å›Authenticationå¯¹è±¡
```

**é…ç½®ç¤ºä¾‹**ï¼š
```java
@Configuration
public class SecurityConfig {
    
    @Bean
    public AuthenticationManager authenticationManager(
            AuthenticationConfiguration config) throws Exception {
        return config.getAuthenticationManager();
    }
    
    @Bean
    public DaoAuthenticationProvider authenticationProvider() {
        DaoAuthenticationProvider provider = new DaoAuthenticationProvider();
        provider.setUserDetailsService(userDetailsService);  // è®¾ç½®ç”¨æˆ·æœåŠ¡
        provider.setPasswordEncoder(passwordEncoder());      // è®¾ç½®å¯†ç ç¼–ç å™¨
        return provider;
    }
}
```

---

## 3. ğŸ‘¤ è‡ªå®šä¹‰ç™»å½•è®¤è¯é€»è¾‘


### 3.1 ç†è§£ç™»å½•è®¤è¯çš„æœ¬è´¨


> ğŸ“– **æ ¸å¿ƒæ¦‚å¿µ**ï¼šç™»å½•è®¤è¯å°±æ˜¯éªŒè¯ç”¨æˆ·æä¾›çš„å‡­æ®ï¼ˆç”¨æˆ·å+å¯†ç ï¼‰æ˜¯å¦æ­£ç¡®

**è®¤è¯è¿‡ç¨‹**ï¼š
```
ç”¨æˆ·è¾“å…¥è´¦å·å¯†ç 
        â†“
Spring Securityæ¥æ”¶è®¤è¯è¯·æ±‚
        â†“
è°ƒç”¨UserDetailsServiceæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
        â†“
æ¯”è¾ƒå¯†ç æ˜¯å¦åŒ¹é…
        â†“
ç”ŸæˆAuthenticationå¯¹è±¡
        â†“
ä¿å­˜åˆ°SecurityContextä¸­
```

### 3.2 è‡ªå®šä¹‰UserDetailsService


> ğŸ”§ **å®è·µç›®æ ‡**ï¼šå‘Šè¯‰Spring Securityå¦‚ä½•ä»æ•°æ®åº“è·å–ç”¨æˆ·ä¿¡æ¯

```java
@Service
public class CustomUserDetailsService implements UserDetailsService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        // 1. ä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·
        User user = userRepository.findByUsername(username);
        if (user == null) {
            throw new UsernameNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨: " + username);
        }
        
        // 2. è½¬æ¢ä¸ºSpring Securityçš„UserDetails
        return org.springframework.security.core.userdetails.User.builder()
                .username(user.getUsername())
                .password(user.getPassword())  // æ•°æ®åº“ä¸­çš„åŠ å¯†å¯†ç 
                .authorities("ROLE_" + user.getRole())  // ç”¨æˆ·è§’è‰²
                .accountExpired(false)
                .accountLocked(false)
                .credentialsExpired(false)
                .disabled(false)
                .build();
    }
}
```

### 3.3 è‡ªå®šä¹‰ç™»å½•æ¥å£


> ğŸš€ **å®æˆ˜åœºæ™¯**ï¼šå‰åç«¯åˆ†ç¦»é¡¹ç›®éœ€è¦è‡ªå·±çš„ç™»å½•API

```java
@RestController
public class AuthController {
    
    @Autowired
    private AuthenticationManager authenticationManager;
    
    @Autowired
    private JwtUtil jwtUtil;
    
    @PostMapping("/login")
    public ResponseEntity<?> login(@RequestBody LoginRequest loginRequest) {
        try {
            // 1. åˆ›å»ºè®¤è¯token
            UsernamePasswordAuthenticationToken authToken = 
                new UsernamePasswordAuthenticationToken(
                    loginRequest.getUsername(), 
                    loginRequest.getPassword()
                );
            
            // 2. æ‰§è¡Œè®¤è¯
            Authentication authentication = authenticationManager.authenticate(authToken);
            
            // 3. è®¤è¯æˆåŠŸï¼Œç”ŸæˆJWT
            UserDetails userDetails = (UserDetails) authentication.getPrincipal();
            String jwt = jwtUtil.generateToken(userDetails.getUsername());
            
            // 4. è¿”å›token
            return ResponseEntity.ok(new JwtResponse(jwt));
            
        } catch (BadCredentialsException e) {
            return ResponseEntity.badRequest().body("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
        }
    }
}
```

**ç™»å½•è¯·æ±‚å¯¹è±¡**ï¼š
```java
public class LoginRequest {
    private String username;
    private String password;
    
    // getter/setterçœç•¥
}

public class JwtResponse {
    private String token;
    private String type = "Bearer";
    
    public JwtResponse(String token) {
        this.token = token;
    }
    
    // getter/setterçœç•¥
}
```

---

## 4. ğŸ« JWTé›†æˆå®æˆ˜


### 4.1 JWTæ˜¯ä»€ä¹ˆï¼Ÿ


> ğŸ’¡ **å½¢è±¡æ¯”å–»**ï¼šJWTå°±åƒæ˜¯ä¸€å¼ ç‰¹æ®Šçš„é—¨ç¥¨ï¼ŒåŒ…å«äº†ä½ çš„èº«ä»½ä¿¡æ¯ï¼Œè€Œä¸”æ— æ³•ä¼ªé€ 

**JWTçš„ç»„æˆ**ï¼š
```
JWT = Header.Payload.Signature

Header (å¤´éƒ¨): æè¿°tokenç±»å‹å’ŒåŠ å¯†ç®—æ³•
{
  "typ": "JWT",
  "alg": "HS256"
}

Payload (è½½è·): å­˜å‚¨ç”¨æˆ·ä¿¡æ¯
{
  "sub": "1234567890",
  "name": "å¼ ä¸‰",
  "role": "admin",
  "exp": 1735689600
}

Signature (ç­¾å): é˜²æ­¢ç¯¡æ”¹çš„ç­¾å
HMACSHA256(
  base64UrlEncode(header) + "." + base64UrlEncode(payload),
  secret
)
```

### 4.2 JWTå·¥å…·ç±»å®ç°


```java
@Component
public class JwtUtil {
    
    private String secret = "mySecretKey";  // å®é™…é¡¹ç›®ä¸­åº”è¯¥ä»é…ç½®æ–‡ä»¶è¯»å–
    private int expiration = 86400;  // 24å°æ—¶ï¼Œå•ä½ç§’
    
    /**
     * ç”ŸæˆJWT Token
     */
    public String generateToken(String username) {
        Map<String, Object> claims = new HashMap<>();
        claims.put("sub", username);
        claims.put("created", new Date());
        
        return Jwts.builder()
                .setClaims(claims)
                .setExpiration(new Date(System.currentTimeMillis() + expiration * 1000))
                .signWith(SignatureAlgorithm.HS256, secret)
                .compact();
    }
    
    /**
     * ä»tokenä¸­è·å–ç”¨æˆ·å
     */
    public String getUsernameFromToken(String token) {
        return getClaimFromToken(token, Claims::getSubject);
    }
    
    /**
     * éªŒè¯tokenæ˜¯å¦æœ‰æ•ˆ
     */
    public boolean validateToken(String token, UserDetails userDetails) {
        String username = getUsernameFromToken(token);
        return username.equals(userDetails.getUsername()) && !isTokenExpired(token);
    }
    
    private boolean isTokenExpired(String token) {
        Date expiration = getClaimFromToken(token, Claims::getExpiration);
        return expiration.before(new Date());
    }
}
```

### 4.3 JWTè¿‡æ»¤å™¨é›†æˆ


```java
@Component
public class JwtAuthenticationFilter extends OncePerRequestFilter {
    
    @Autowired
    private JwtUtil jwtUtil;
    
    @Autowired
    private UserDetailsService userDetailsService;
    
    @Override
    protected void doFilterInternal(HttpServletRequest request, 
                                  HttpServletResponse response, 
                                  FilterChain filterChain) throws ServletException, IOException {
        
        String requestHeader = request.getHeader("Authorization");
        
        if (requestHeader != null && requestHeader.startsWith("Bearer ")) {
            // æå–token
            String token = requestHeader.substring(7);
            
            try {
                // ä»tokenè·å–ç”¨æˆ·å
                String username = jwtUtil.getUsernameFromToken(token);
                
                if (username != null && SecurityContextHolder.getContext().getAuthentication() == null) {
                    // åŠ è½½ç”¨æˆ·ä¿¡æ¯
                    UserDetails userDetails = userDetailsService.loadUserByUsername(username);
                    
                    // éªŒè¯token
                    if (jwtUtil.validateToken(token, userDetails)) {
                        // åˆ›å»ºè®¤è¯å¯¹è±¡
                        UsernamePasswordAuthenticationToken authentication = 
                            new UsernamePasswordAuthenticationToken(
                                userDetails, null, userDetails.getAuthorities());
                        
                        // è®¾ç½®åˆ°SecurityContext
                        SecurityContextHolder.getContext().setAuthentication(authentication);
                    }
                }
            } catch (Exception e) {
                logger.error("JWTéªŒè¯å¤±è´¥: " + e.getMessage());
            }
        }
        
        filterChain.doFilter(request, response);
    }
}
```

---

## 5. ğŸ›¡ï¸ æƒé™æ§åˆ¶ä¸æ³¨è§£


### 5.1 æƒé™æ§åˆ¶çš„åŸºæœ¬æ¦‚å¿µ


> ğŸ“– **æ ¸å¿ƒç†è§£**ï¼šæƒé™æ§åˆ¶å°±æ˜¯å†³å®šå·²ç™»å½•ç”¨æˆ·èƒ½è®¿é—®å“ªäº›èµ„æºã€æ‰§è¡Œå“ªäº›æ“ä½œ

**æƒé™å±‚çº§**ï¼š
```
è®¤è¯æˆåŠŸç”¨æˆ·
    â”œâ”€â”€ ROLE_USER (æ™®é€šç”¨æˆ·)
    â”‚   â”œâ”€â”€ æŸ¥çœ‹ä¸ªäººä¿¡æ¯
    â”‚   â””â”€â”€ ä¿®æ”¹ä¸ªäººèµ„æ–™
    â”œâ”€â”€ ROLE_ADMIN (ç®¡ç†å‘˜)
    â”‚   â”œâ”€â”€ ç”¨æˆ·ç®¡ç†
    â”‚   â”œâ”€â”€ ç³»ç»Ÿè®¾ç½®
    â”‚   â””â”€â”€ æ•°æ®å¯¼å‡º
    â””â”€â”€ ROLE_SUPER_ADMIN (è¶…çº§ç®¡ç†å‘˜)
        â””â”€â”€ æ‰€æœ‰æƒé™
```

### 5.2 @PreAuthorizeæ³¨è§£è¯¦è§£


> ğŸ”§ **ä½œç”¨**ï¼šåœ¨æ–¹æ³•æ‰§è¡Œå‰æ£€æŸ¥ç”¨æˆ·æƒé™

**åŸºç¡€ç”¨æ³•**ï¼š
```java
@RestController
public class UserController {
    
    // æ£€æŸ¥æ˜¯å¦æœ‰ADMINè§’è‰²
    @GetMapping("/admin/users")
    @PreAuthorize("hasRole('ADMIN')")
    public List<User> getAllUsers() {
        return userService.findAll();
    }
    
    // æ£€æŸ¥æ˜¯å¦æœ‰ç‰¹å®šæƒé™
    @DeleteMapping("/user/{id}")
    @PreAuthorize("hasAuthority('USER_DELETE')")
    public void deleteUser(@PathVariable Long id) {
        userService.delete(id);
    }
    
    // åªèƒ½æ“ä½œè‡ªå·±çš„æ•°æ®
    @PutMapping("/user/{id}")
    @PreAuthorize("authentication.name == #username or hasRole('ADMIN')")
    public User updateUser(@PathVariable String username, @RequestBody User user) {
        return userService.update(user);
    }
    
    // å¤æ‚æƒé™è¡¨è¾¾å¼
    @PostMapping("/sensitive-data")
    @PreAuthorize("hasRole('ADMIN') and hasIpAddress('192.168.1.0/24')")
    public void processSensitiveData() {
        // åªæœ‰ç®¡ç†å‘˜ä¸”åœ¨å†…ç½‘æ‰èƒ½è®¿é—®
    }
}
```

### 5.3 @Securedæ³¨è§£


> ğŸ’¡ **ç‰¹ç‚¹**ï¼šæ›´ç®€å•çš„æƒé™æ£€æŸ¥ï¼Œåªæ”¯æŒè§’è‰²æ£€æŸ¥

```java
@RestController
public class AdminController {
    
    @GetMapping("/admin/dashboard")
    @Secured("ROLE_ADMIN")  // ç®€å•çš„è§’è‰²æ£€æŸ¥
    public String dashboard() {
        return "ç®¡ç†å‘˜ä»ªè¡¨ç›˜";
    }
    
    @GetMapping("/super-admin")
    @Secured({"ROLE_ADMIN", "ROLE_SUPER_ADMIN"})  // å¤šä¸ªè§’è‰²ä»»é€‰å…¶ä¸€
    public String superAdminPage() {
        return "è¶…çº§ç®¡ç†å‘˜é¡µé¢";
    }
}
```

### 5.4 æ–¹æ³•çº§æƒé™æ§åˆ¶é…ç½®


```java
@Configuration
@EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true)
public class MethodSecurityConfig {
    
    // å¯ç”¨@PreAuthorizeã€@PostAuthorizeç­‰æ³¨è§£
    // å¯ç”¨@Securedæ³¨è§£
}
```

**æƒé™è¡¨è¾¾å¼å¯¹æ¯”**ï¼š

| è¡¨è¾¾å¼ | è¯´æ˜ | ç¤ºä¾‹ |
|-------|------|------|
| `hasRole('ADMIN')` | æ£€æŸ¥è§’è‰² | ç”¨æˆ·å¿…é¡»æœ‰ADMINè§’è‰² |
| `hasAuthority('READ')` | æ£€æŸ¥æƒé™ | ç”¨æˆ·å¿…é¡»æœ‰READæƒé™ |
| `authentication.name` | è·å–ç”¨æˆ·å | æ£€æŸ¥å½“å‰ç™»å½•ç”¨æˆ·å |
| `hasIpAddress('192.168.1.1')` | IPåœ°å€æ£€æŸ¥ | æ£€æŸ¥è¯·æ±‚IP |
| `#id == authentication.name` | å‚æ•°æ£€æŸ¥ | å‚æ•°idç­‰äºç”¨æˆ·å |

---

## 6. ğŸ”— OAuth2é›†æˆå®æˆ˜


### 6.1 OAuth2æ˜¯ä»€ä¹ˆï¼Ÿ


> ğŸ’¡ **å½¢è±¡æ¯”å–»**ï¼šOAuth2å°±åƒæ˜¯ä»£å®¢æ³Šè½¦æœåŠ¡ï¼Œä½ ä¸ç”¨æŠŠè½¦é’¥åŒ™ï¼ˆå¯†ç ï¼‰ç»™åˆ«äººï¼Œä½†æˆæƒä»–ä»¬å¸®ä½ åœè½¦

**OAuth2è§’è‰²**ï¼š
```
Resource Owner (èµ„æºæ‰€æœ‰è€…)ï¼šä½ 
    â†“ æˆæƒ
Client (å®¢æˆ·ç«¯åº”ç”¨)ï¼šç¬¬ä¸‰æ–¹åº”ç”¨
    â†“ è¯·æ±‚æˆæƒ
Authorization Server (æˆæƒæœåŠ¡å™¨)ï¼šå¾®ä¿¡ã€GitHubç­‰
    â†“ é¢å‘ä»¤ç‰Œ
Resource Server (èµ„æºæœåŠ¡å™¨)ï¼šå­˜å‚¨ç”¨æˆ·ä¿¡æ¯çš„æœåŠ¡å™¨
```

### 6.2 OAuth2è®¤è¯æœåŠ¡é›†æˆ


**æ·»åŠ ä¾èµ–**ï¼š
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-oauth2-client</artifactId>
</dependency>
```

**é…ç½®æ–‡ä»¶è®¾ç½®**ï¼š
```yaml
spring:
  security:
    oauth2:
      client:
        registration:
          github:
            client-id: your-github-client-id
            client-secret: your-github-client-secret
            scope: user:email, read:user
        provider:
          github:
            authorization-uri: https://github.com/login/oauth/authorize
            token-uri: https://github.com/login/oauth/access_token
            user-info-uri: https://api.github.com/user
            user-name-attribute: id
```

### 6.3 OAuth2é…ç½®ç±»


```java
@Configuration
public class OAuth2Config {
    
    @Bean
    public SecurityFilterChain oauth2FilterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/", "/login", "/error").permitAll()
                .anyRequest().authenticated()
            )
            .oauth2Login(oauth2 -> oauth2
                .loginPage("/login")
                .defaultSuccessUrl("/home", true)
                .userInfoEndpoint(userInfo -> userInfo
                    .userService(customOAuth2UserService())
                )
            );
        
        return http.build();
    }
    
    @Bean
    public OAuth2UserService<OAuth2UserRequest, OAuth2User> customOAuth2UserService() {
        return new CustomOAuth2UserService();
    }
}
```

### 6.4 è‡ªå®šä¹‰OAuth2ç”¨æˆ·æœåŠ¡


```java
@Service
public class CustomOAuth2UserService implements OAuth2UserService<OAuth2UserRequest, OAuth2User> {
    
    @Autowired
    private UserRepository userRepository;
    
    private DefaultOAuth2UserService delegate = new DefaultOAuth2UserService();
    
    @Override
    public OAuth2User loadUser(OAuth2UserRequest userRequest) throws OAuth2AuthenticationException {
        // 1. ä»OAuth2æä¾›å•†è·å–ç”¨æˆ·ä¿¡æ¯
        OAuth2User oauth2User = delegate.loadUser(userRequest);
        
        // 2. æå–ç”¨æˆ·ä¿¡æ¯
        String registrationId = userRequest.getClientRegistration().getRegistrationId();
        String email = oauth2User.getAttribute("email");
        String name = oauth2User.getAttribute("name");
        
        // 3. ä¿å­˜æˆ–æ›´æ–°ç”¨æˆ·ä¿¡æ¯
        User user = userRepository.findByEmail(email);
        if (user == null) {
            user = new User();
            user.setEmail(email);
            user.setName(name);
            user.setProvider(registrationId);
            user.setRole("USER");
            userRepository.save(user);
        }
        
        // 4. è¿”å›è‡ªå®šä¹‰ç”¨æˆ·å¯¹è±¡
        return new CustomOAuth2User(oauth2User, user);
    }
}
```

---

## 7. ğŸ§µ SecurityContextä¸çº¿ç¨‹å®‰å…¨


### 7.1 SecurityContextæ˜¯ä»€ä¹ˆï¼Ÿ


> ğŸ’¡ **å½¢è±¡æ¯”å–»**ï¼šSecurityContextå°±åƒæ˜¯ä¸€ä¸ªèº«ä»½å¡å¤¹ï¼Œå­˜å‚¨å½“å‰ç”¨æˆ·çš„èº«ä»½ä¿¡æ¯ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„å¡å¤¹

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- **SecurityContext**ï¼šå®‰å…¨ä¸Šä¸‹æ–‡ï¼Œå­˜å‚¨è®¤è¯ä¿¡æ¯
- **SecurityContextHolder**ï¼šä¸Šä¸‹æ–‡æŒæœ‰è€…ï¼Œç®¡ç†SecurityContext
- **ThreadLocal**ï¼šçº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼Œç¡®ä¿çº¿ç¨‹å®‰å…¨

### 7.2 SecurityContextçš„å·¥ä½œåŸç†


```
HTTPè¯·æ±‚ â†’ Filter â†’ SecurityContext â†’ ä¸šåŠ¡æ–¹æ³• â†’ æ¸…ç†
    â†“         â†“           â†“              â†“         â†“
  çº¿ç¨‹1    è®¾ç½®ç”¨æˆ·A    ç”¨æˆ·Aä¿¡æ¯      è®¿é—®èµ„æº   æ¸…ç©ºä¸Šä¸‹æ–‡
  çº¿ç¨‹2    è®¾ç½®ç”¨æˆ·B    ç”¨æˆ·Bä¿¡æ¯      è®¿é—®èµ„æº   æ¸…ç©ºä¸Šä¸‹æ–‡
```

**ThreadLocalåŸç†ç¤ºæ„**ï¼š
```java
// ThreadLocalçš„å·¥ä½œæœºåˆ¶
ThreadLocal<SecurityContext> contextHolder = new ThreadLocal<>();

// æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ç‹¬ç«‹çš„å­˜å‚¨ç©ºé—´
Thread-1: SecurityContext{user: "å¼ ä¸‰", roles: ["USER"]}
Thread-2: SecurityContext{user: "æå››", roles: ["ADMIN"]}
Thread-3: SecurityContext{user: "ç‹äº”", roles: ["USER"]}
```

### 7.3 è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯


```java
@Service
public class UserService {
    
    /**
     * è·å–å½“å‰ç™»å½•ç”¨æˆ·
     */
    public String getCurrentUsername() {
        SecurityContext context = SecurityContextHolder.getContext();
        Authentication authentication = context.getAuthentication();
        
        if (authentication != null && authentication.isAuthenticated()) {
            return authentication.getName();
        }
        return null;
    }
    
    /**
     * è·å–å½“å‰ç”¨æˆ·æƒé™
     */
    public Collection<String> getCurrentUserAuthorities() {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        
        if (authentication != null) {
            return authentication.getAuthorities().stream()
                    .map(GrantedAuthority::getAuthority)
                    .collect(Collectors.toList());
        }
        return Collections.emptyList();
    }
    
    /**
     * åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦æœ‰æŒ‡å®šè§’è‰²
     */
    public boolean hasRole(String role) {
        return getCurrentUserAuthorities().contains("ROLE_" + role);
    }
}
```

### 7.4 å¼‚æ­¥æ–¹æ³•ä¸­çš„SecurityContext


> âš ï¸ **æ³¨æ„**ï¼šå¼‚æ­¥æ–¹æ³•é»˜è®¤æ— æ³•è·å–SecurityContext

**é—®é¢˜ç¤ºä¾‹**ï¼š
```java
@Service
public class AsyncService {
    
    @Async
    public void processDataAsync() {
        // è¿™é‡Œè·å–ä¸åˆ°å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼
        String username = SecurityContextHolder.getContext()
                .getAuthentication().getName(); // å¯èƒ½ä¸ºnull
    }
}
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```java
@Configuration
@EnableAsync
public class AsyncConfig implements AsyncConfigurer {
    
    @Override
    public Executor getAsyncExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(10);
        executor.setMaxPoolSize(20);
        executor.setQueueCapacity(100);
        
        // å…³é”®ï¼šè®¾ç½®ä»»åŠ¡è£…é¥°å™¨ï¼Œä¼ é€’SecurityContext
        executor.setTaskDecorator(new SecurityContextPropagatingTaskDecorator());
        
        executor.initialize();
        return executor;
    }
}
```

**æ‰‹åŠ¨ä¼ é€’SecurityContext**ï¼š
```java
@Service
public class AsyncService {
    
    public void processData() {
        // ä¿å­˜å½“å‰SecurityContext
        SecurityContext context = SecurityContextHolder.getContext();
        
        CompletableFuture.runAsync(() -> {
            try {
                // åœ¨å¼‚æ­¥çº¿ç¨‹ä¸­è®¾ç½®SecurityContext
                SecurityContextHolder.setContext(context);
                
                // ç°åœ¨å¯ä»¥è·å–ç”¨æˆ·ä¿¡æ¯äº†
                String username = SecurityContextHolder.getContext()
                        .getAuthentication().getName();
                
                // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
                doSomething(username);
                
            } finally {
                // æ¸…ç†SecurityContext
                SecurityContextHolder.clearContext();
            }
        });
    }
}
```

---

## 8. ğŸ‘¥ å¤šç”¨æˆ·ç±»å‹å¤„ç†


### 8.1 å¤šç”¨æˆ·ç±»å‹çš„éœ€æ±‚åœºæ™¯


> ğŸ“– **å®é™…åœºæ™¯**ï¼šä¸€ä¸ªç³»ç»Ÿå¯èƒ½æœ‰æ™®é€šç”¨æˆ·ã€ç®¡ç†å‘˜ã€å•†å®¶ã€å®¢æœç­‰ä¸åŒç±»å‹çš„ç”¨æˆ·

**ç”¨æˆ·ç±»å‹ç¤ºä¾‹**ï¼š
```
ç”µå•†ç³»ç»Ÿç”¨æˆ·ç±»å‹ï¼š
â”œâ”€â”€ Customer (é¡¾å®¢)
â”‚   â”œâ”€â”€ æµè§ˆå•†å“
â”‚   â”œâ”€â”€ ä¸‹å•è´­ä¹°
â”‚   â””â”€â”€ æŸ¥çœ‹è®¢å•
â”œâ”€â”€ Merchant (å•†å®¶)
â”‚   â”œâ”€â”€ ä¸Šæ¶å•†å“
â”‚   â”œâ”€â”€ å¤„ç†è®¢å•
â”‚   â””â”€â”€ æŸ¥çœ‹é”€å”®æ•°æ®
â”œâ”€â”€ Admin (ç®¡ç†å‘˜)
â”‚   â”œâ”€â”€ ç”¨æˆ·ç®¡ç†
â”‚   â”œâ”€â”€ å•†å“å®¡æ ¸
â”‚   â””â”€â”€ ç³»ç»Ÿé…ç½®
â””â”€â”€ CustomerService (å®¢æœ)
    â”œâ”€â”€ å¤„ç†æŠ•è¯‰
    â””â”€â”€ åœ¨çº¿å’¨è¯¢
```

### 8.2 ç”¨æˆ·å®ä½“è®¾è®¡


```java
// åŸºç¡€ç”¨æˆ·å®ä½“
@Entity
@Table(name = "users")
@Inheritance(strategy = InheritanceType.JOINED)
@DiscriminatorColumn(name = "user_type")
public abstract class BaseUser {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(unique = true)
    private String username;
    
    private String password;
    
    private String email;
    
    @Enumerated(EnumType.STRING)
    private UserType userType;
    
    private boolean enabled = true;
    
    // æŠ½è±¡æ–¹æ³•ï¼Œç”±å­ç±»å®ç°
    public abstract Collection<? extends GrantedAuthority> getAuthorities();
}

// é¡¾å®¢ç”¨æˆ·
@Entity
@DiscriminatorValue("CUSTOMER")
public class Customer extends BaseUser {
    private String address;
    private String phone;
    
    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() {
        return Arrays.asList(new SimpleGrantedAuthority("ROLE_CUSTOMER"));
    }
}

// å•†å®¶ç”¨æˆ·
@Entity
@DiscriminatorValue("MERCHANT")
public class Merchant extends BaseUser {
    private String companyName;
    private String businessLicense;
    
    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() {
        return Arrays.asList(
            new SimpleGrantedAuthority("ROLE_MERCHANT"),
            new SimpleGrantedAuthority("PRODUCT_MANAGE")
        );
    }
}

// ç®¡ç†å‘˜ç”¨æˆ·
@Entity
@DiscriminatorValue("ADMIN")
public class Admin extends BaseUser {
    private String department;
    
    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() {
        return Arrays.asList(
            new SimpleGrantedAuthority("ROLE_ADMIN"),
            new SimpleGrantedAuthority("USER_MANAGE"),
            new SimpleGrantedAuthority("SYSTEM_CONFIG")
        );
    }
}
```

### 8.3 å¤šç”¨æˆ·ç±»å‹UserDetailsService


```java
@Service
public class MultiUserTypeUserDetailsService implements UserDetailsService {
    
    @Autowired
    private CustomerRepository customerRepository;
    
    @Autowired
    private MerchantRepository merchantRepository;
    
    @Autowired
    private AdminRepository adminRepository;
    
    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        BaseUser user = findUserByUsername(username);
        
        if (user == null) {
            throw new UsernameNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨: " + username);
        }
        
        return new CustomUserPrincipal(user);
    }
    
    /**
     * ä»æ‰€æœ‰ç”¨æˆ·ç±»å‹ä¸­æŸ¥æ‰¾ç”¨æˆ·
     */
    private BaseUser findUserByUsername(String username) {
        // å…ˆä»é¡¾å®¢ä¸­æŸ¥æ‰¾
        Optional<Customer> customer = customerRepository.findByUsername(username);
        if (customer.isPresent()) {
            return customer.get();
        }
        
        // å†ä»å•†å®¶ä¸­æŸ¥æ‰¾
        Optional<Merchant> merchant = merchantRepository.findByUsername(username);
        if (merchant.isPresent()) {
            return merchant.get();
        }
        
        // æœ€åä»ç®¡ç†å‘˜ä¸­æŸ¥æ‰¾
        Optional<Admin> admin = adminRepository.findByUsername(username);
        return admin.orElse(null);
    }
}
```

### 8.4 è‡ªå®šä¹‰UserPrincipal


```java
public class CustomUserPrincipal implements UserDetails {
    
    private BaseUser user;
    
    public CustomUserPrincipal(BaseUser user) {
        this.user = user;
    }
    
    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() {
        return user.getAuthorities();
    }
    
    @Override
    public String getPassword() {
        return user.getPassword();
    }
    
    @Override
    public String getUsername() {
        return user.getUsername();
    }
    
    @Override
    public boolean isAccountNonExpired() {
        return true;
    }
    
    @Override
    public boolean isAccountNonLocked() {
        return true;
    }
    
    @Override
    public boolean isCredentialsNonExpired() {
        return true;
    }
    
    @Override
    public boolean isEnabled() {
        return user.isEnabled();
    }
    
    // è·å–ç”¨æˆ·ç±»å‹
    public UserType getUserType() {
        return user.getUserType();
    }
    
    // è·å–å®Œæ•´ç”¨æˆ·å¯¹è±¡
    public BaseUser getUser() {
        return user;
    }
    
    // ç±»å‹å®‰å…¨çš„getteræ–¹æ³•
    public Customer asCustomer() {
        return user instanceof Customer ? (Customer) user : null;
    }
    
    public Merchant asMerchant() {
        return user instanceof Merchant ? (Merchant) user : null;
    }
    
    public Admin asAdmin() {
        return user instanceof Admin ? (Admin) user : null;
    }
}
```

### 8.5 åŸºäºç”¨æˆ·ç±»å‹çš„æƒé™æ§åˆ¶


```java
@RestController
public class UserTypeController {
    
    // åªæœ‰é¡¾å®¢å¯ä»¥è®¿é—®
    @GetMapping("/customer/orders")
    @PreAuthorize("hasRole('CUSTOMER')")
    public List<Order> getCustomerOrders() {
        CustomUserPrincipal principal = getCurrentUser();
        Customer customer = principal.asCustomer();
        return orderService.findByCustomerId(customer.getId());
    }
    
    // åªæœ‰å•†å®¶å¯ä»¥è®¿é—®
    @GetMapping("/merchant/products")
    @PreAuthorize("hasRole('MERCHANT')")
    public List<Product> getMerchantProducts() {
        CustomUserPrincipal principal = getCurrentUser();
        Merchant merchant = principal.asMerchant();
        return productService.findByMerchantId(merchant.getId());
    }
    
    // åªæœ‰ç®¡ç†å‘˜å¯ä»¥è®¿é—®
    @GetMapping("/admin/users")
    @PreAuthorize("hasRole('ADMIN')")
    public List<BaseUser> getAllUsers() {
        return userService.findAllUsers();
    }
    
    // é¡¾å®¢å’Œå•†å®¶éƒ½å¯ä»¥è®¿é—®ï¼Œä½†çœ‹åˆ°ä¸åŒå†…å®¹
    @GetMapping("/dashboard")
    @PreAuthorize("hasAnyRole('CUSTOMER', 'MERCHANT', 'ADMIN')")
    public DashboardData getDashboard() {
        CustomUserPrincipal principal = getCurrentUser();
        
        switch (principal.getUserType()) {
            case CUSTOMER:
                return dashboardService.getCustomerDashboard(principal.asCustomer());
            case MERCHANT:
                return dashboardService.getMerchantDashboard(principal.asMerchant());
            case ADMIN:
                return dashboardService.getAdminDashboard(principal.asAdmin());
            default:
                throw new AccessDeniedException("æœªçŸ¥ç”¨æˆ·ç±»å‹");
        }
    }
    
    private CustomUserPrincipal getCurrentUser() {
        Authentication auth = SecurityContextHolder.getContext().getAuthentication();
        return (CustomUserPrincipal) auth.getPrincipal();
    }
}
```

---

## 9. âŒ å¼‚å¸¸å¤„ç†ä¸å®šåˆ¶åŒ–


### 9.1 Spring Securityå¼‚å¸¸ç±»å‹


> ğŸ“– **å¼‚å¸¸åˆ†ç±»**ï¼šSpring Securityçš„å¼‚å¸¸ä¸»è¦åˆ†ä¸ºè®¤è¯å¼‚å¸¸å’Œæˆæƒå¼‚å¸¸

**å¸¸è§å¼‚å¸¸ç±»å‹**ï¼š
```
AuthenticationException (è®¤è¯å¼‚å¸¸)
â”œâ”€â”€ BadCredentialsException (ç”¨æˆ·åå¯†ç é”™è¯¯)
â”œâ”€â”€ UsernameNotFoundException (ç”¨æˆ·ä¸å­˜åœ¨)  
â”œâ”€â”€ AccountExpiredException (è´¦æˆ·è¿‡æœŸ)
â”œâ”€â”€ CredentialsExpiredException (å‡­æ®è¿‡æœŸ)
â”œâ”€â”€ DisabledException (è´¦æˆ·è¢«ç¦ç”¨)
â””â”€â”€ LockedException (è´¦æˆ·è¢«é”å®š)

AccessDeniedException (æˆæƒå¼‚å¸¸)
â”œâ”€â”€ ç”¨æˆ·å·²è®¤è¯ä½†æƒé™ä¸è¶³
â””â”€â”€ è®¿é—®å—ä¿æŠ¤èµ„æºè¢«æ‹’ç»
```

### 9.2 å…¨å±€å¼‚å¸¸å¤„ç†å™¨


```java
@ControllerAdvice
public class SecurityExceptionHandler {
    
    /**
     * å¤„ç†è®¤è¯å¼‚å¸¸
     */
    @ExceptionHandler(AuthenticationException.class)
    public ResponseEntity<ErrorResponse> handleAuthenticationException(
            AuthenticationException ex) {
        
        ErrorResponse error = new ErrorResponse();
        error.setTimestamp(LocalDateTime.now());
        error.setStatus(HttpStatus.UNAUTHORIZED.value());
        error.setPath(getCurrentPath());
        
        // æ ¹æ®å…·ä½“å¼‚å¸¸ç±»å‹è¿”å›ä¸åŒæ¶ˆæ¯
        if (ex instanceof BadCredentialsException) {
            error.setError("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
            error.setMessage("è¯·æ£€æŸ¥æ‚¨çš„ç™»å½•å‡­æ®");
        } else if (ex instanceof DisabledException) {
            error.setError("è´¦æˆ·å·²è¢«ç¦ç”¨");
            error.setMessage("è¯·è”ç³»ç®¡ç†å‘˜è§£å°è´¦æˆ·");
        } else if (ex instanceof LockedException) {
            error.setError("è´¦æˆ·å·²è¢«é”å®š");  
            error.setMessage("è¯·ç¨åé‡è¯•æˆ–è”ç³»ç®¡ç†å‘˜");
        } else {
            error.setError("è®¤è¯å¤±è´¥");
            error.setMessage("ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•");
        }
        
        return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(error);
    }
    
    /**
     * å¤„ç†æˆæƒå¼‚å¸¸
     */
    @ExceptionHandler(AccessDeniedException.class)
    public ResponseEntity<ErrorResponse> handleAccessDeniedException(
            AccessDeniedException ex) {
        
        ErrorResponse error = new ErrorResponse();
        error.setTimestamp(LocalDateTime.now());
        error.setStatus(HttpStatus.FORBIDDEN.value());
        error.setError("æƒé™ä¸è¶³");
        error.setMessage("æ‚¨æ²¡æœ‰æƒé™è®¿é—®æ­¤èµ„æº");
        error.setPath(getCurrentPath());
        
        return ResponseEntity.status(HttpStatus.FORBIDDEN).body(error);
    }
    
    /**
     * å¤„ç†JWTç›¸å…³å¼‚å¸¸
     */
    @ExceptionHandler(JwtException.class)
    public ResponseEntity<ErrorResponse> handleJwtException(JwtException ex) {
        ErrorResponse error = new ErrorResponse();
        error.setTimestamp(LocalDateTime.now());
        error.setStatus(HttpStatus.UNAUTHORIZED.value());
        error.setError("Tokenæ— æ•ˆ");
        error.setMessage("è¯·é‡æ–°ç™»å½•");
        error.setPath(getCurrentPath());
        
        return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(error);
    }
    
    private String getCurrentPath() {
        RequestAttributes attrs = RequestContextHolder.getRequestAttributes();
        if (attrs instanceof ServletRequestAttributes) {
            HttpServletRequest request = ((ServletRequestAttributes) attrs).getRequest();
            return request.getRequestURI();
        }
        return "unknown";
    }
}
```

### 9.3 è‡ªå®šä¹‰é”™è¯¯å“åº”æ ¼å¼


```java
public class ErrorResponse {
    private LocalDateTime timestamp;
    private int status;
    private String error;
    private String message;
    private String path;
    
    // constructors, getters, setters
}

public class LoginErrorResponse extends ErrorResponse {
    private int remainingAttempts;  // å‰©ä½™ç™»å½•å°è¯•æ¬¡æ•°
    private long lockTimeRemaining; // é”å®šå‰©ä½™æ—¶é—´
    
    // constructors, getters, setters
}
```

### 9.4 è‡ªå®šä¹‰è®¤è¯å…¥å£ç‚¹


```java
@Component
public class CustomAuthenticationEntryPoint implements AuthenticationEntryPoint {
    
    private ObjectMapper objectMapper = new ObjectMapper();
    
    @Override
    public void commence(HttpServletRequest request, 
                        HttpServletResponse response,
                        AuthenticationException authException) throws IOException {
        
        response.setContentType("application/json;charset=UTF-8");
        response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
        
        ErrorResponse errorResponse = new ErrorResponse();
        errorResponse.setTimestamp(LocalDateTime.now());
        errorResponse.setStatus(401);
        errorResponse.setError("æœªæˆæƒ");
        errorResponse.setMessage("è¯·å…ˆç™»å½•");
        errorResponse.setPath(request.getRequestURI());
        
        String jsonResponse = objectMapper.writeValueAsString(errorResponse);
        response.getWriter().write(jsonResponse);
    }
}
```

### 9.5 è‡ªå®šä¹‰è®¿é—®æ‹’ç»å¤„ç†å™¨


```java
@Component
public class CustomAccessDeniedHandler implements AccessDeniedHandler {
    
    private ObjectMapper objectMapper = new ObjectMapper();
    
    @Override
    public void handle(HttpServletRequest request,
                      HttpServletResponse response,
                      AccessDeniedException accessDeniedException) throws IOException {
        
        response.setContentType("application/json;charset=UTF-8");
        response.setStatus(HttpServletResponse.SC_FORBIDDEN);
        
        ErrorResponse errorResponse = new ErrorResponse();
        errorResponse.setTimestamp(LocalDateTime.now());
        errorResponse.setStatus(403);
        errorResponse.setError("æƒé™ä¸è¶³");
        errorResponse.setMessage("æ‚¨æ²¡æœ‰æƒé™æ‰§è¡Œæ­¤æ“ä½œ");
        errorResponse.setPath(request.getRequestURI());
        
        String jsonResponse = objectMapper.writeValueAsString(errorResponse);
        response.getWriter().write(jsonResponse);
    }
}
```

---

## 10. ğŸš€ æ— çŠ¶æ€æ¶æ„é…ç½®


### 10.1 ä»€ä¹ˆæ˜¯æ— çŠ¶æ€æ¶æ„ï¼Ÿ


> ğŸ’¡ **æ ¸å¿ƒç†è§£**ï¼šæ— çŠ¶æ€æ¶æ„æ„å‘³ç€æœåŠ¡å™¨ä¸ä¿å­˜ç”¨æˆ·çš„ç™»å½•çŠ¶æ€ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½é€šè¿‡Tokenæ¥éªŒè¯èº«ä»½

**æœ‰çŠ¶æ€ vs æ— çŠ¶æ€å¯¹æ¯”**ï¼š
```
ä¼ ç»Ÿæœ‰çŠ¶æ€æ¶æ„ï¼š
ç”¨æˆ·ç™»å½• â†’ æœåŠ¡å™¨åˆ›å»ºSession â†’ è¿”å›SessionID â†’ åç»­è¯·æ±‚æºå¸¦SessionID
ä¼˜ç‚¹ï¼šæœåŠ¡å™¨èƒ½æ§åˆ¶ä¼šè¯
ç¼ºç‚¹ï¼šéš¾ä»¥æ‰©å±•ï¼Œéœ€è¦Sessionå…±äº«

ç°ä»£æ— çŠ¶æ€æ¶æ„ï¼š
ç”¨æˆ·ç™»å½• â†’ æœåŠ¡å™¨è¿”å›JWT Token â†’ åç»­è¯·æ±‚æºå¸¦Token â†’ æœåŠ¡å™¨éªŒè¯Token
ä¼˜ç‚¹ï¼šæ˜“äºæ‰©å±•ï¼Œæ— éœ€Sessionå…±äº«
ç¼ºç‚¹ï¼šTokenæ— æ³•ä¸»åŠ¨å¤±æ•ˆ
```

### 10.2 æ— çŠ¶æ€å®‰å…¨é…ç½®


```java
@Configuration
@EnableWebSecurity
public class StatelessSecurityConfig {
    
    @Autowired
    private JwtAuthenticationFilter jwtAuthenticationFilter;
    
    @Autowired
    private CustomAuthenticationEntryPoint authenticationEntryPoint;
    
    @Autowired
    private CustomAccessDeniedHandler accessDeniedHandler;
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            // ç¦ç”¨CSRF (æ— çŠ¶æ€åº”ç”¨ä¸éœ€è¦)
            .csrf(csrf -> csrf.disable())
            
            // è®¾ç½®æ— çŠ¶æ€ä¼šè¯ç®¡ç†
            .sessionManagement(session -> session
                .sessionCreationPolicy(SessionCreationPolicy.STATELESS)
            )
            
            // é…ç½®URLæƒé™
            .authorizeHttpRequests(auth -> auth
                // å…¬å¼€æ¥å£
                .requestMatchers("/auth/login", "/auth/register", "/public/**").permitAll()
                // APIæ¥å£éœ€è¦è®¤è¯
                .requestMatchers("/api/**").authenticated()
                // ç®¡ç†å‘˜æ¥å£éœ€è¦ç®¡ç†å‘˜æƒé™
                .requestMatchers("/admin/**").hasRole("ADMIN")
                // å…¶ä»–è¯·æ±‚éœ€è¦è®¤è¯
                .anyRequest().authenticated()
            )
            
            // è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†
            .exceptionHandling(ex -> ex
                .authenticationEntryPoint(authenticationEntryPoint)
                .accessDeniedHandler(accessDeniedHandler)
            )
            
            // æ·»åŠ JWTè¿‡æ»¤å™¨
            .addFilterBefore(jwtAuthenticationFilter, UsernamePasswordAuthenticationFilter.class);
        
        return http.build();
    }
    
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder(12);
    }
}
```

### 10.3 å®Œæ•´çš„ç™»å½•æµç¨‹å®ç°


```java
@RestController
@RequestMapping("/auth")
public class AuthController {
    
    @Autowired
    private AuthenticationManager authenticationManager;
    
    @Autowired
    private JwtUtil jwtUtil;
    
    @Autowired
    private UserService userService;
    
    @Autowired
    private PasswordEncoder passwordEncoder;
    
    /**
     * ç”¨æˆ·æ³¨å†Œ
     */
    @PostMapping("/register")
    public ResponseEntity<?> register(@RequestBody RegisterRequest registerRequest) {
        try {
            // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
            if (userService.existsByUsername(registerRequest.getUsername())) {
                return ResponseEntity.badRequest()
                    .body(new MessageResponse("ç”¨æˆ·åå·²è¢«ä½¿ç”¨"));
            }
            
            // åˆ›å»ºæ–°ç”¨æˆ·
            User user = new User();
            user.setUsername(registerRequest.getUsername());
            user.setEmail(registerRequest.getEmail());
            user.setPassword(passwordEncoder.encode(registerRequest.getPassword()));
            user.setRole("USER");
            
            userService.save(user);
            
            return ResponseEntity.ok(new MessageResponse("æ³¨å†ŒæˆåŠŸ"));
            
        } catch (Exception e) {
            return ResponseEntity.badRequest()
                .body(new MessageResponse("æ³¨å†Œå¤±è´¥: " + e.getMessage()));
        }
    }
    
    /**
     * ç”¨æˆ·ç™»å½•
     */
    @PostMapping("/login")
    public ResponseEntity<?> login(@RequestBody LoginRequest loginRequest) {
        try {
            // æ‰§è¡Œè®¤è¯
            Authentication authentication = authenticationManager.authenticate(
                new UsernamePasswordAuthenticationToken(
                    loginRequest.getUsername(),
                    loginRequest.getPassword()
                )
            );
            
            // è·å–ç”¨æˆ·ä¿¡æ¯
            UserDetails userDetails = (UserDetails) authentication.getPrincipal();
            
            // ç”ŸæˆJWT Token
            String token = jwtUtil.generateToken(userDetails.getUsername());
            
            // æ„é€ å“åº”
            LoginResponse response = new LoginResponse();
            response.setToken(token);
            response.setType("Bearer");
            response.setUsername(userDetails.getUsername());
            response.setAuthorities(userDetails.getAuthorities().stream()
                .map(GrantedAuthority::getAuthority)
                .collect(Collectors.toList()));
            
            return ResponseEntity.ok(response);
            
        } catch (BadCredentialsException e) {
            return ResponseEntity.badRequest()
                .body(new MessageResponse("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"));
        } catch (Exception e) {
            return ResponseEntity.badRequest()
                .body(new MessageResponse("ç™»å½•å¤±è´¥: " + e.getMessage()));
        }
    }
    
    /**
     * åˆ·æ–°Token
     */
    @PostMapping("/refresh")
    public ResponseEntity<?> refreshToken(HttpServletRequest request) {
        String token = extractTokenFromRequest(request);
        
        if (token != null && jwtUtil.canTokenBeRefreshed(token)) {
            String refreshedToken = jwtUtil.refreshToken(token);
            return ResponseEntity.ok(new JwtResponse(refreshedToken));
        } else {
            return ResponseEntity.badRequest()
                .body(new MessageResponse("Tokenæ— æ³•åˆ·æ–°"));
        }
    }
    
    /**
     * è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
     */
    @GetMapping("/me")
    public ResponseEntity<?> getCurrentUser() {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        
        if (authentication != null && authentication.isAuthenticated()) {
            UserDetails userDetails = (UserDetails) authentication.getPrincipal();
            
            UserInfoResponse userInfo = new UserInfoResponse();
            userInfo.setUsername(userDetails.getUsername());
            userInfo.setAuthorities(userDetails.getAuthorities().stream()
                .map(GrantedAuthority::getAuthority)
                .collect(Collectors.toList()));
            
            return ResponseEntity.ok(userInfo);
        }
        
        return ResponseEntity.badRequest().body(new MessageResponse("æœªç™»å½•"));
    }
    
    private String extractTokenFromRequest(HttpServletRequest request) {
        String bearerToken = request.getHeader("Authorization");
        if (bearerToken != null && bearerToken.startsWith("Bearer ")) {
            return bearerToken.substring(7);
        }
        return null;
    }
}
```

### 10.4 Tokenæ‹¦æˆªå™¨å®ç°


```java
@Component
public class JwtAuthenticationFilter extends OncePerRequestFilter {
    
    @Autowired
    private JwtUtil jwtUtil;
    
    @Autowired
    private UserDetailsService userDetailsService;
    
    // ä¸éœ€è¦è®¤è¯çš„è·¯å¾„
    private final List<String> excludePaths = Arrays.asList(
        "/auth/login",
        "/auth/register", 
        "/public"
    );
    
    @Override
    protected void doFilterInternal(HttpServletRequest request,
                                  HttpServletResponse response,
                                  FilterChain filterChain) throws ServletException, IOException {
        
        // è·³è¿‡ä¸éœ€è¦è®¤è¯çš„è·¯å¾„
        if (shouldSkipFilter(request)) {
            filterChain.doFilter(request, response);
            return;
        }
        
        try {
            // æå–Token
            String token = extractTokenFromRequest(request);
            
            if (token != null) {
                // éªŒè¯Tokenå¹¶è®¾ç½®è®¤è¯ä¿¡æ¯
                if (validateTokenAndSetAuthentication(token)) {
                    logger.debug("TokenéªŒè¯æˆåŠŸï¼Œç”¨æˆ·: " + jwtUtil.getUsernameFromToken(token));
                } else {
                    logger.warn("TokenéªŒè¯å¤±è´¥");
                }
            }
        } catch (Exception e) {
            logger.error("JWTéªŒè¯è¿‡ç¨‹å‡ºé”™: " + e.getMessage());
        }
        
        // ç»§ç»­è¿‡æ»¤å™¨é“¾
        filterChain.doFilter(request, response);
    }
    
    private boolean shouldSkipFilter(HttpServletRequest request) {
        String path = request.getRequestURI();
        return excludePaths.stream().anyMatch(path::startsWith);
    }
    
    private String extractTokenFromRequest(HttpServletRequest request) {
        String bearerToken = request.getHeader("Authorization");
        if (bearerToken != null && bearerToken.startsWith("Bearer ")) {
            return bearerToken.substring(7);
        }
        return null;
    }
    
    private boolean validateTokenAndSetAuthentication(String token) {
        try {
            // ä»Tokenè·å–ç”¨æˆ·å
            String username = jwtUtil.getUsernameFromToken(token);
            
            if (username != null && SecurityContextHolder.getContext().getAuthentication() == null) {
                // åŠ è½½ç”¨æˆ·è¯¦æƒ…
                UserDetails userDetails = userDetailsService.loadUserByUsername(username);
                
                // éªŒè¯Tokenæœ‰æ•ˆæ€§
                if (jwtUtil.validateToken(token, userDetails)) {
                    // åˆ›å»ºè®¤è¯å¯¹è±¡
                    UsernamePasswordAuthenticationToken authentication = 
                        new UsernamePasswordAuthenticationToken(
                            userDetails, 
                            null, 
                            userDetails.getAuthorities()
                        );
                    
                    // è®¾ç½®åˆ°SecurityContext
                    SecurityContextHolder.getContext().setAuthentication(authentication);
                    return true;
                }
            }
        } catch (Exception e) {
            logger.error("Tokenå¤„ç†å¼‚å¸¸: " + e.getMessage());
        }
        
        return false;
    }
}
```

---

## 11. ğŸŒ ç¬¬ä¸‰æ–¹å¹³å°é›†æˆ


### 11.1 æ¥å…¥GitHubç™»å½•


> ğŸš€ **å®é™…åœºæ™¯**ï¼šå¾ˆå¤šåº”ç”¨æ”¯æŒä½¿ç”¨GitHubã€Googleã€å¾®ä¿¡ç­‰ç¬¬ä¸‰æ–¹è´¦å·ç™»å½•

**GitHub OAuthåº”ç”¨è®¾ç½®**ï¼š
```
1. ç™»å½•GitHub â†’ Settings â†’ Developer settings â†’ OAuth Apps
2. åˆ›å»ºæ–°åº”ç”¨ï¼š
   - Application name: ä½ çš„åº”ç”¨åç§°
   - Homepage URL: http://localhost:8080
   - Authorization callback URL: http://localhost:8080/login/oauth2/code/github
3. è·å–Client IDå’ŒClient Secret
```

### 11.2 Spring Booté…ç½®


```yaml
# application.yml
spring:
  security:
    oauth2:
      client:
        registration:
          github:
            client-id: ${GITHUB_CLIENT_ID:your-github-client-id}
            client-secret: ${GITHUB_CLIENT_SECRET:your-github-client-secret}
            scope: 
              - user:email
              - read:user
        provider:
          github:
            authorization-uri: https://github.com/login/oauth/authorize
            token-uri: https://github.com/login/oauth/access_token
            user-info-uri: https://api.github.com/user
            user-name-attribute: id

# æ—¥å¿—é…ç½®ï¼ˆå¯é€‰ï¼‰
logging:
  level:
    org.springframework.security: DEBUG
    org.springframework.security.oauth2: DEBUG
```

### 11.3 OAuth2å®‰å…¨é…ç½®


```java
@Configuration
@EnableWebSecurity
public class OAuth2SecurityConfig {
    
    @Autowired
    private CustomOAuth2UserService customOAuth2UserService;
    
    @Autowired
    private OAuth2LoginSuccessHandler successHandler;
    
    @Autowired
    private OAuth2LoginFailureHandler failureHandler;
    
    @Bean
    public SecurityFilterChain oauth2FilterChain(HttpSecurity http) throws Exception {
        http
            .csrf(csrf -> csrf.disable())
            
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/", "/login", "/error", "/webjars/**").permitAll()
                .anyRequest().authenticated()
            )
            
            .oauth2Login(oauth2 -> oauth2
                .loginPage("/login")  // è‡ªå®šä¹‰ç™»å½•é¡µé¢
                .defaultSuccessUrl("/dashboard", true)
                .failureUrl("/login?error=true")
                
                // è‡ªå®šä¹‰ç”¨æˆ·ä¿¡æ¯æœåŠ¡
                .userInfoEndpoint(userInfo -> userInfo
                    .userService(customOAuth2UserService)
                )
                
                // è‡ªå®šä¹‰æˆåŠŸå’Œå¤±è´¥å¤„ç†å™¨
                .successHandler(successHandler)
                .failureHandler(failureHandler)
            );
        
        return http.build();
    }
}
```

### 11.4 è‡ªå®šä¹‰OAuth2ç”¨æˆ·æœåŠ¡


```java
@Service
public class CustomOAuth2UserService implements OAuth2UserService<OAuth2UserRequest, OAuth2User> {
    
    @Autowired
    private UserRepository userRepository;
    
    private final DefaultOAuth2UserService delegate = new DefaultOAuth2UserService();
    
    @Override
    public OAuth2User loadUser(OAuth2UserRequest userRequest) throws OAuth2AuthenticationException {
        // 1. ä»OAuth2æä¾›å•†è·å–ç”¨æˆ·ä¿¡æ¯
        OAuth2User oauth2User = delegate.loadUser(userRequest);
        
        // 2. è·å–æ³¨å†ŒIDï¼ˆgithub, googleç­‰ï¼‰
        String registrationId = userRequest.getClientRegistration().getRegistrationId();
        
        // 3. æå–ç”¨æˆ·ä¿¡æ¯
        Map<String, Object> attributes = oauth2User.getAttributes();
        UserInfo userInfo = extractUserInfo(registrationId, attributes);
        
        // 4. ä¿å­˜æˆ–æ›´æ–°ç”¨æˆ·
        User user = saveOrUpdateUser(userInfo, registrationId);
        
        // 5. è¿”å›è‡ªå®šä¹‰çš„OAuth2User
        return new CustomOAuth2User(oauth2User.getAuthorities(), attributes, "id", user);
    }
    
    private UserInfo extractUserInfo(String registrationId, Map<String, Object> attributes) {
        UserInfo userInfo = new UserInfo();
        
        switch (registrationId) {
            case "github":
                userInfo.setId(String.valueOf(attributes.get("id")));
                userInfo.setName((String) attributes.get("name"));
                userInfo.setEmail((String) attributes.get("email"));
                userInfo.setAvatarUrl((String) attributes.get("avatar_url"));
                userInfo.setUsername((String) attributes.get("login"));
                break;
                
            case "google":
                userInfo.setId((String) attributes.get("sub"));
                userInfo.setName((String) attributes.get("name"));
                userInfo.setEmail((String) attributes.get("email"));
                userInfo.setAvatarUrl((String) attributes.get("picture"));
                userInfo.setUsername((String) attributes.get("email"));
                break;
                
            default:
                throw new OAuth2AuthenticationException("ä¸æ”¯æŒçš„OAuth2æä¾›å•†: " + registrationId);
        }
        
        return userInfo;
    }
    
    private User saveOrUpdateUser(UserInfo userInfo, String provider) {
        // æ ¹æ®é‚®ç®±æŸ¥æ‰¾ç°æœ‰ç”¨æˆ·
        User user = userRepository.findByEmail(userInfo.getEmail());
        
        if (user == null) {
            // åˆ›å»ºæ–°ç”¨æˆ·
            user = new User();
            user.setUsername(userInfo.getUsername());
            user.setEmail(userInfo.getEmail());
            user.setName(userInfo.getName());
            user.setAvatarUrl(userInfo.getAvatarUrl());
            user.setProvider(provider);
            user.setProviderId(userInfo.getId());
            user.setRole("USER");
            user.setEnabled(true);
        } else {
            // æ›´æ–°ç°æœ‰ç”¨æˆ·ä¿¡æ¯
            user.setName(userInfo.getName());
            user.setAvatarUrl(userInfo.getAvatarUrl());
            if (user.getProvider() == null) {
                user.setProvider(provider);
                user.setProviderId(userInfo.getId());
            }
        }
        
        return userRepository.save(user);
    }
}
```

### 11.5 è‡ªå®šä¹‰OAuth2ç”¨æˆ·å¯¹è±¡


```java
public class CustomOAuth2User implements OAuth2User {
    
    private Collection<? extends GrantedAuthority> authorities;
    private Map<String, Object> attributes;
    private String nameAttributeKey;
    private User user;
    
    public CustomOAuth2User(Collection<? extends GrantedAuthority> authorities,
                           Map<String, Object> attributes,
                           String nameAttributeKey,
                           User user) {
        this.authorities = authorities;
        this.attributes = attributes;
        this.nameAttributeKey = nameAttributeKey;
        this.user = user;
    }
    
    @Override
    public Map<String, Object> getAttributes() {
        return attributes;
    }
    
    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() {
        return authorities;
    }
    
    @Override
    public String getName() {
        return String.valueOf(attributes.get(nameAttributeKey));
    }
    
    // è‡ªå®šä¹‰æ–¹æ³•
    public User getUser() {
        return user;
    }
    
    public String getEmail() {
        return user.getEmail();
    }
    
    public String getDisplayName() {
        return user.getName();
    }
}
```

### 11.6 æˆåŠŸå’Œå¤±è´¥å¤„ç†å™¨


```java
@Component
public class OAuth2LoginSuccessHandler implements AuthenticationSuccessHandler {
    
    private JwtUtil jwtUtil;
    
    @Override
    public void onAuthenticationSuccess(HttpServletRequest request,
                                      HttpServletResponse response,
                                      Authentication authentication) throws IOException {
        
        CustomOAuth2User oauth2User = (CustomOAuth2User) authentication.getPrincipal();
        User user = oauth2User.getUser();
        
        // ç”ŸæˆJWT Token
        String token = jwtUtil.generateToken(user.getUsername());
        
        // é‡å®šå‘åˆ°å‰ç«¯é¡µé¢ï¼Œæºå¸¦token
        String redirectUrl = String.format("http://localhost:3000/auth/callback?token=%s", token);
        response.sendRedirect(redirectUrl);
    }
}

@Component
public class OAuth2LoginFailureHandler implements AuthenticationFailureHandler {
    
    @Override
    public void onAuthenticationFailure(HttpServletRequest request,
                                      HttpServletResponse response,
                                      AuthenticationException exception) throws IOException {
        
        String errorMessage = URLEncoder.encode("OAuth2ç™»å½•å¤±è´¥", "UTF-8");
        response.sendRedirect("/login?error=" + errorMessage);
    }
}
```

### 11.7 å‰ç«¯ç™»å½•é¡µé¢


```html
<!DOCTYPE html>
<html>
<head>
    <title>ç™»å½•</title>
    <style>
        .login-container { max-width: 400px; margin: 100px auto; padding: 20px; }
        .oauth-button { display: block; width: 100%; margin: 10px 0; padding: 10px; }
        .github { background-color: #333; color: white; }
        .google { background-color: #4285f4; color: white; }
    </style>
</head>
<body>
    <div class="login-container">
        <h2>ç”¨æˆ·ç™»å½•</h2>
        
        <!-- ä¼ ç»Ÿç™»å½•è¡¨å• -->
        <form action="/auth/login" method="post">
            <div>
                <input type="text" name="username" placeholder="ç”¨æˆ·å" required>
            </div>
            <div>
                <input type="password" name="password" placeholder="å¯†ç " required>
            </div>
            <button type="submit">ç™»å½•</button>
        </form>
        
        <hr>
        
        <!-- OAuth2ç™»å½•æŒ‰é’® -->
        <a href="/oauth2/authorization/github" class="oauth-button github">
            ä½¿ç”¨GitHubç™»å½•
        </a>
        
        <a href="/oauth2/authorization/google" class="oauth-button google">
            ä½¿ç”¨Googleç™»å½•
        </a>
    </div>
</body>
</html>
```

---

## 12. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 12.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Spring Securityæœ¬è´¨ï¼šåŸºäºè¿‡æ»¤å™¨é“¾çš„å®‰å…¨æ¡†æ¶
ğŸ”¸ æ ¸å¿ƒç»„ä»¶ï¼šFilterChainã€AuthenticationManagerã€UserDetailsService
ğŸ”¸ è®¤è¯vsæˆæƒï¼šè®¤è¯è§£å†³"ä½ æ˜¯è°"ï¼Œæˆæƒè§£å†³"ä½ èƒ½åšä»€ä¹ˆ"
ğŸ”¸ JWTé›†æˆï¼šæ— çŠ¶æ€è®¤è¯ï¼ŒTokenåŒ…å«ç”¨æˆ·ä¿¡æ¯
ğŸ”¸ æƒé™æ§åˆ¶ï¼š@PreAuthorizeã€@Securedæ³¨è§£å®ç°æ–¹æ³•çº§æƒé™æ§åˆ¶
ğŸ”¸ OAuth2é›†æˆï¼šç¬¬ä¸‰æ–¹ç™»å½•ï¼Œå§”æ‰˜è®¤è¯æœºåˆ¶
ğŸ”¸ SecurityContextï¼šçº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼Œä¿å­˜å½“å‰ç”¨æˆ·è®¤è¯ä¿¡æ¯
ğŸ”¸ å¤šç”¨æˆ·ç±»å‹ï¼šåŒä¸€ç³»ç»Ÿæ”¯æŒä¸åŒç±»å‹ç”¨æˆ·å’Œæƒé™
ğŸ”¸ å¼‚å¸¸å¤„ç†ï¼šè®¤è¯å¼‚å¸¸å’Œæˆæƒå¼‚å¸¸çš„ç»Ÿä¸€å¤„ç†
ğŸ”¸ æ— çŠ¶æ€æ¶æ„ï¼šåŸºäºTokençš„ç°ä»£Webåº”ç”¨å®‰å…¨æ–¹æ¡ˆ
```

### 12.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ è¿‡æ»¤å™¨é“¾çš„å·¥ä½œæœºåˆ¶**
```
ç†è§£è¦ç‚¹ï¼š
- æ¯ä¸ªHTTPè¯·æ±‚éƒ½è¦ç»è¿‡å®Œæ•´çš„è¿‡æ»¤å™¨é“¾
- è¿‡æ»¤å™¨æŒ‰ç…§é¡ºåºæ‰§è¡Œï¼Œä»»ä½•ä¸€ä¸ªå¤±è´¥éƒ½ä¼šä¸­æ–­
- è‡ªå®šä¹‰è¿‡æ»¤å™¨éœ€è¦æ­£ç¡®æ’å…¥åˆ°é“¾ä¸­çš„åˆé€‚ä½ç½®
- è¿‡æ»¤å™¨è´Ÿè´£ä¸åŒçš„å®‰å…¨æ£€æŸ¥èŒè´£
```

**ğŸ”¹ è®¤è¯ä¸æˆæƒçš„åŒºåˆ«**
```
è®¤è¯ (Authentication)ï¼š
- éªŒè¯ç”¨æˆ·èº«ä»½ï¼š"ä½ æ˜¯å¼ ä¸‰å—ï¼Ÿ"
- é€šè¿‡ç”¨æˆ·åå¯†ç ã€Tokenã€æŒ‡çº¹ç­‰æ–¹å¼
- æˆåŠŸååˆ›å»ºAuthenticationå¯¹è±¡

æˆæƒ (Authorization)ï¼š  
- éªŒè¯ç”¨æˆ·æƒé™ï¼š"å¼ ä¸‰èƒ½è®¿é—®ç®¡ç†å‘˜é¡µé¢å—ï¼Ÿ"
- åŸºäºè§’è‰²ã€æƒé™ã€èµ„æºç­‰è¿›è¡Œæ£€æŸ¥
- åœ¨è®¤è¯æˆåŠŸçš„åŸºç¡€ä¸Šè¿›è¡Œ
```

**ğŸ”¹ JWTçš„ä¼˜åŠ¿ä¸æ³¨æ„äº‹é¡¹**
```
ä¼˜åŠ¿ï¼š
- æ— çŠ¶æ€ï¼šæœåŠ¡å™¨ä¸éœ€è¦å­˜å‚¨Session
- å¯æ‰©å±•ï¼šé€‚åˆåˆ†å¸ƒå¼ç³»ç»Ÿ
- è·¨åŸŸå‹å¥½ï¼šå¯ä»¥åœ¨ä¸åŒåŸŸåé—´ä½¿ç”¨

æ³¨æ„äº‹é¡¹ï¼š
- æ— æ³•ä¸»åŠ¨å¤±æ•ˆï¼šTokenä¸€æ—¦ç­¾å‘å°±æœ‰æ•ˆç›´åˆ°è¿‡æœŸ
- å®‰å…¨å­˜å‚¨ï¼šå®¢æˆ·ç«¯éœ€è¦å®‰å…¨å­˜å‚¨Token
- è¿‡æœŸå¤„ç†ï¼šéœ€è¦å®ç°Tokenåˆ·æ–°æœºåˆ¶
```

**ğŸ”¹ æƒé™æ³¨è§£çš„ä½¿ç”¨åœºæ™¯**
```
@PreAuthorizeï¼š
- åŠŸèƒ½æœ€å¼ºå¤§ï¼Œæ”¯æŒå¤æ‚è¡¨è¾¾å¼
- å¯ä»¥è®¿é—®æ–¹æ³•å‚æ•°å’Œè®¤è¯ä¿¡æ¯
- é€‚åˆéœ€è¦åŠ¨æ€æƒé™åˆ¤æ–­çš„åœºæ™¯

@Securedï¼š
- ç®€å•æ˜“ç”¨ï¼Œåªèƒ½æ£€æŸ¥è§’è‰²
- æ€§èƒ½è¾ƒå¥½ï¼Œç¼–è¯‘æ—¶æ£€æŸ¥
- é€‚åˆç®€å•çš„è§’è‰²æƒé™æ§åˆ¶

é€‰æ‹©åŸåˆ™ï¼š
- ç®€å•è§’è‰²æ£€æŸ¥ â†’ @Secured
- å¤æ‚æƒé™é€»è¾‘ â†’ @PreAuthorize
```

### 12.3 å®é™…åº”ç”¨æœ€ä½³å®è·µ


**ğŸ¯ å®‰å…¨é…ç½®æœ€ä½³å®è·µ**
```
1. å¯†ç å®‰å…¨ï¼š
   - ä½¿ç”¨BCryptPasswordEncoder
   - è®¾ç½®è¶³å¤Ÿçš„å¼ºåº¦ï¼ˆ12è½®ä»¥ä¸Šï¼‰
   - ä¸è¦åœ¨æ—¥å¿—ä¸­è®°å½•å¯†ç 

2. Tokenå®‰å…¨ï¼š
   - ä½¿ç”¨å¼ºéšæœºå¯†é’¥ç­¾åJWT
   - è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´ï¼ˆä¸è¦å¤ªé•¿ï¼‰
   - å®ç°Tokenåˆ·æ–°æœºåˆ¶

3. ä¼šè¯ç®¡ç†ï¼š
   - æ— çŠ¶æ€åº”ç”¨ç¦ç”¨Session
   - è®¾ç½®åˆé€‚çš„CSRFä¿æŠ¤ç­–ç•¥
   - é…ç½®å®‰å…¨çš„Cookieå±æ€§
```

**ğŸ”§ æ€§èƒ½ä¼˜åŒ–å»ºè®®**
```
1. ç¼“å­˜ç”¨æˆ·ä¿¡æ¯ï¼š
   - UserDetailsServiceç»“æœç¼“å­˜
   - æƒé™ä¿¡æ¯ç¼“å­˜ï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢

2. è¿‡æ»¤å™¨ä¼˜åŒ–ï¼š
   - é™æ€èµ„æºè·³è¿‡å®‰å…¨è¿‡æ»¤å™¨
   - åˆç†è®¾ç½®è¿‡æ»¤å™¨é¡ºåº

3. æ•°æ®åº“ä¼˜åŒ–ï¼š
   - ç”¨æˆ·è¡¨æ·»åŠ é€‚å½“ç´¢å¼•
   - æƒé™æŸ¥è¯¢ä½¿ç”¨è¿æ¥æŸ¥è¯¢è€ŒéN+1
```

**ğŸš¨ å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ**
```
é—®é¢˜1ï¼šå¾ªç¯ä¾èµ–
è§£å†³ï¼šä½¿ç”¨@Lazyæ³¨è§£å»¶è¿ŸåŠ è½½

é—®é¢˜2ï¼šCORSè·¨åŸŸé—®é¢˜  
è§£å†³ï¼šæ­£ç¡®é…ç½®CORSï¼Œæ³¨æ„é¢„æ£€è¯·æ±‚

é—®é¢˜3ï¼šå¼‚æ­¥æ–¹æ³•è·å–ä¸åˆ°ç”¨æˆ·ä¿¡æ¯
è§£å†³ï¼šä½¿ç”¨SecurityContextPropagatingTaskDecorator

é—®é¢˜4ï¼šJWT Tokenæ³„éœ²
è§£å†³ï¼šè®¾ç½®çŸ­è¿‡æœŸæ—¶é—´+åˆ·æ–°æœºåˆ¶

é—®é¢˜5ï¼šæƒé™æ³¨è§£ä¸ç”Ÿæ•ˆ
è§£å†³ï¼šæ£€æŸ¥@EnableGlobalMethodSecurityé…ç½®
```

### 12.4 å­¦ä¹ è·¯å¾„å»ºè®®


**ğŸ“š å¾ªåºæ¸è¿›çš„å­¦ä¹ é¡ºåº**
```
åŸºç¡€é˜¶æ®µï¼š
1. ç†è§£è®¤è¯å’Œæˆæƒæ¦‚å¿µ
2. æŒæ¡åŸºæœ¬çš„è¡¨å•ç™»å½•é…ç½®
3. å­¦ä¼šè‡ªå®šä¹‰UserDetailsService
4. äº†è§£å¯†ç ç¼–ç å™¨çš„ä½¿ç”¨

è¿›é˜¶é˜¶æ®µï¼š
5. æŒæ¡JWT Tokenæœºåˆ¶
6. å­¦ä¼šè‡ªå®šä¹‰è¿‡æ»¤å™¨
7. ç†è§£SecurityContextå’Œçº¿ç¨‹å®‰å…¨
8. æŒæ¡æ–¹æ³•çº§æƒé™æ§åˆ¶

é«˜çº§é˜¶æ®µï¼š
9. OAuth2ç¬¬ä¸‰æ–¹ç™»å½•é›†æˆ
10. å¤æ‚æƒé™æ¨¡å‹è®¾è®¡
11. å®‰å…¨æ¼æ´é˜²æŠ¤
12. æ€§èƒ½ä¼˜åŒ–å’Œç›‘æ§
```

**ğŸ› ï¸ å®è·µé¡¹ç›®å»ºè®®**
```
é¡¹ç›®1ï¼šåŸºç¡€åšå®¢ç³»ç»Ÿ
- ç”¨æˆ·æ³¨å†Œç™»å½•
- åŸºäºè§’è‰²çš„æƒé™æ§åˆ¶
- æ–‡ç« çš„å¢åˆ æ”¹æŸ¥æƒé™

é¡¹ç›®2ï¼šç”µå•†åå°ç®¡ç†
- å¤šç”¨æˆ·ç±»å‹ï¼ˆç”¨æˆ·ã€å•†å®¶ã€ç®¡ç†å‘˜ï¼‰
- å¤æ‚çš„æƒé™çŸ©é˜µ
- JWT + OAuth2ç™»å½•

é¡¹ç›®3ï¼šå¾®æœåŠ¡å®‰å…¨ç½‘å…³
- ç»Ÿä¸€è®¤è¯ä¸­å¿ƒ
- Tokenè½¬å‘å’ŒéªŒè¯
- æœåŠ¡é—´å®‰å…¨é€šä¿¡
```

### 12.5 æ‰©å±•å­¦ä¹ æ–¹å‘


**ğŸ” æ·±å…¥å­¦ä¹ é¢†åŸŸ**
```
å®‰å…¨æ¡†æ¶ï¼š
- Spring Securityè¿›é˜¶ç‰¹æ€§
- Apache Shiroå¯¹æ¯”å­¦ä¹ 
- è‡ªå®šä¹‰å®‰å…¨æ¡†æ¶è®¾è®¡

è®¤è¯æ ‡å‡†ï¼š
- OAuth 2.0æ·±å…¥ç†è§£
- OpenID Connectåè®®
- SAML 2.0ä¼ä¸šçº§å•ç‚¹ç™»å½•

åŠ å¯†æŠ€æœ¯ï¼š
- å¯¹ç§°åŠ å¯†å’Œéå¯¹ç§°åŠ å¯†
- æ•°å­—ç­¾åå’Œè¯ä¹¦
- HTTPSå’ŒTLSåè®®

å®‰å…¨é˜²æŠ¤ï¼š
- XSSã€CSRFã€SQLæ³¨å…¥é˜²æŠ¤
- APIå®‰å…¨è®¾è®¡
- æ¸—é€æµ‹è¯•åŸºç¡€
```

**ğŸ“ˆ èŒä¸šå‘å±•æ–¹å‘**
```
æŠ€æœ¯è·¯çº¿ï¼š
- é«˜çº§Javaå¼€å‘å·¥ç¨‹å¸ˆ
- ç³»ç»Ÿæ¶æ„å¸ˆ
- å®‰å…¨æ¶æ„å¸ˆ
- DevSecOpså·¥ç¨‹å¸ˆ

èƒ½åŠ›è¦æ±‚ï¼š
- æ·±åº¦ç†è§£å®‰å…¨åŸç†
- å…·å¤‡å¨èƒå»ºæ¨¡èƒ½åŠ›
- æŒæ¡å®‰å…¨å¼€å‘ç”Ÿå‘½å‘¨æœŸ
- äº†è§£åˆè§„å’Œå®¡è®¡è¦æ±‚
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
è¿‡æ»¤å™¨é“¾å±‚å±‚å…³ï¼Œè®¤è¯æˆæƒè¦åˆ†æ¸…
JWTæ— çŠ¶æ€çœŸæ–¹ä¾¿ï¼ŒOAuthç¬¬ä¸‰æ–¹æœ€æ—¶é«¦  
æ³¨è§£æƒé™ç®€å•ç”¨ï¼Œå¼‚å¸¸å¤„ç†è¦å‘¨å…¨
SecurityContextçº¿ç¨‹ç»‘ï¼Œå¤šç”¨æˆ·ç±»å‹å·§è®¾è®¡
æ— çŠ¶æ€æ¶æ„æœ€æµè¡Œï¼Œç¬¬ä¸‰æ–¹ç™»å½•ç”¨æˆ·çˆ±
```
