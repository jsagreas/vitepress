---
title: 6ã€åç«¯è®¤è¯æ¶æ„
---
## ğŸ“š ç›®å½•

1. [è®¤è¯ä¸­é—´ä»¶è®¾è®¡](#1-è®¤è¯ä¸­é—´ä»¶è®¾è®¡)
2. [ç»Ÿä¸€è®¤è¯ä¸­å¿ƒ](#2-ç»Ÿä¸€è®¤è¯ä¸­å¿ƒ)
3. [åˆ†å¸ƒå¼Sessionç®¡ç†](#3-åˆ†å¸ƒå¼sessionç®¡ç†)
4. [å¾®æœåŠ¡è®¤è¯ç½‘å…³](#4-å¾®æœåŠ¡è®¤è¯ç½‘å…³)
5. [è®¤è¯æ€§èƒ½ä¼˜åŒ–](#5-è®¤è¯æ€§èƒ½ä¼˜åŒ–)
6. [æ•°æ®åº“è®¾è®¡ä¼˜åŒ–](#6-æ•°æ®åº“è®¾è®¡ä¼˜åŒ–)
7. [ç¼“å­˜ç­–ç•¥å®ç°](#7-ç¼“å­˜ç­–ç•¥å®ç°)
8. [å¼‚æ­¥å¤„ç†æœºåˆ¶](#8-å¼‚æ­¥å¤„ç†æœºåˆ¶)
9. [ç›‘æ§å‘Šè­¦ä½“ç³»](#9-ç›‘æ§å‘Šè­¦ä½“ç³»)
10. [ä¸»æµæŠ€æœ¯æ ˆå¯¹æ¯”](#10-ä¸»æµæŠ€æœ¯æ ˆå¯¹æ¯”)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ›¡ï¸ è®¤è¯ä¸­é—´ä»¶è®¾è®¡


### 1.1 ä»€ä¹ˆæ˜¯è®¤è¯ä¸­é—´ä»¶


> ğŸ’¡ **é€šä¿—ç†è§£**  
> è®¤è¯ä¸­é—´ä»¶å°±åƒæ˜¯å¤§æ¥¼çš„é—¨å«ï¼Œæ¯ä¸ªè¿›å…¥çš„äººéƒ½è¦å…ˆéªŒè¯èº«ä»½ï¼ŒéªŒè¯é€šè¿‡æ‰èƒ½è¿›å…¥ã€‚åœ¨ç¨‹åºä¸­ï¼Œå®ƒè´Ÿè´£æ£€æŸ¥æ¯ä¸ªè¯·æ±‚æ˜¯å¦æœ‰åˆæ³•çš„èº«ä»½è¯æ˜ã€‚

**ğŸ”¸ è®¤è¯ä¸­é—´ä»¶çš„æœ¬è´¨**
- **æ‹¦æˆªè¯·æ±‚**ï¼šåœ¨è¯·æ±‚åˆ°è¾¾ä¸šåŠ¡é€»è¾‘ä¹‹å‰è¿›è¡Œæ‹¦æˆª
- **èº«ä»½éªŒè¯**ï¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•ã€Tokenæ˜¯å¦æœ‰æ•ˆ
- **æƒé™æ£€æŸ¥**ï¼šéªŒè¯ç”¨æˆ·æ˜¯å¦æœ‰è®¿é—®ç‰¹å®šèµ„æºçš„æƒé™
- **ç»Ÿä¸€å¤„ç†**ï¼šæ‰€æœ‰è®¤è¯é€»è¾‘é›†ä¸­åœ¨ä¸€å¤„ï¼Œé¿å…é‡å¤ä»£ç 

### 1.2 ä¸‰ç§å®ç°æ¨¡å¼è¯¦è§£


##### ğŸ”¹ æ‹¦æˆªå™¨æ¨¡å¼ (Interceptor)


**å·¥ä½œåŸç†**ï¼šåœ¨è¯·æ±‚å¤„ç†å‰åè¿›è¡Œæ‹¦æˆªæ“ä½œ

```java
// Spring MVC æ‹¦æˆªå™¨ç¤ºä¾‹
@Component
public class AuthInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler) {
        // ğŸ”¸ è·å–è¯·æ±‚ä¸­çš„Token
        String token = request.getHeader("Authorization");
        
        // ğŸ”¸ éªŒè¯Tokenæ˜¯å¦æœ‰æ•ˆ
        if (token == null || !isValidToken(token)) {
            response.setStatus(401);
            return false; // æ‹¦æˆªè¯·æ±‚
        }
        
        // ğŸ”¸ å°†ç”¨æˆ·ä¿¡æ¯å­˜å…¥è¯·æ±‚ä¸Šä¸‹æ–‡
        User user = getUserFromToken(token);
        request.setAttribute("currentUser", user);
        return true; // æ”¾è¡Œè¯·æ±‚
    }
}
```

**ğŸ¯ é€‚ç”¨åœºæ™¯**ï¼šSpring MVCã€Strutsç­‰MVCæ¡†æ¶

##### ğŸ”¹ è¿‡æ»¤å™¨æ¨¡å¼ (Filter)


**å·¥ä½œåŸç†**ï¼šåœ¨Servletå®¹å™¨å±‚é¢å¯¹æ‰€æœ‰è¯·æ±‚è¿›è¡Œè¿‡æ»¤

```java
// Servlet Filter ç¤ºä¾‹
@WebFilter("/api/*")
public class AuthFilter implements Filter {
    
    @Override
    public void doFilter(ServletRequest request, 
                        ServletResponse response, 
                        FilterChain chain) {
        
        HttpServletRequest httpRequest = (HttpServletRequest) request;
        HttpServletResponse httpResponse = (HttpServletResponse) response;
        
        // ğŸ”¸ æ£€æŸ¥æ˜¯å¦éœ€è¦è®¤è¯
        String path = httpRequest.getRequestURI();
        if (isPublicPath(path)) {
            chain.doFilter(request, response);
            return;
        }
        
        // ğŸ”¸ æ‰§è¡Œè®¤è¯é€»è¾‘
        if (!authenticateRequest(httpRequest)) {
            httpResponse.setStatus(401);
            return;
        }
        
        // ğŸ”¸ ç»§ç»­å¤„ç†é“¾
        chain.doFilter(request, response);
    }
}
```

**ğŸ¯ é€‚ç”¨åœºæ™¯**ï¼šJava Webåº”ç”¨ã€éœ€è¦åœ¨å®¹å™¨å±‚ç»Ÿä¸€å¤„ç†

##### ğŸ”¹ è£…é¥°å™¨æ¨¡å¼ (Decorator)


**å·¥ä½œåŸç†**ï¼šé€šè¿‡è£…é¥°å™¨åŒ…è£…åŸæœ‰åŠŸèƒ½ï¼Œæ·»åŠ è®¤è¯é€»è¾‘

```python
# Python Flaskè£…é¥°å™¨ç¤ºä¾‹
from functools import wraps

def require_auth(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        # ğŸ”¸ ä»è¯·æ±‚å¤´è·å–Token
        token = request.headers.get('Authorization')
        
        # ğŸ”¸ éªŒè¯Token
        if not token or not verify_token(token):
            return jsonify({'error': 'æœªæˆæƒè®¿é—®'}), 401
            
        # ğŸ”¸ è·å–ç”¨æˆ·ä¿¡æ¯
        current_user = get_user_from_token(token)
        return f(current_user, *args, **kwargs)
    
    return decorated_function

# ä½¿ç”¨è£…é¥°å™¨
@app.route('/api/profile')
@require_auth
def get_profile(current_user):
    return jsonify(current_user.to_dict())
```

**ğŸ¯ é€‚ç”¨åœºæ™¯**ï¼šPythonã€JavaScriptç­‰æ”¯æŒè£…é¥°å™¨çš„è¯­è¨€

### 1.3 ä¸‰ç§æ¨¡å¼å¯¹æ¯”


| å®ç°æ–¹å¼ | **ä¼˜åŠ¿** | **åŠ£åŠ¿** | **é€‚ç”¨åœºæ™¯** |
|---------|---------|---------|-------------|
| ğŸ”¸ **æ‹¦æˆªå™¨** | `ç²’åº¦ç»†ï¼Œå¯é’ˆå¯¹ç‰¹å®šController` | `æ¡†æ¶ç»‘å®šå¼º` | `Spring MVCé¡¹ç›®` |
| ğŸ”¸ **è¿‡æ»¤å™¨** | `å®¹å™¨çº§åˆ«ï¼Œè¦†ç›–é¢å¹¿` | `ç²’åº¦ç²—ï¼Œéš¾ä»¥ç²¾ç¡®æ§åˆ¶` | `æ•´ä½“å®‰å…¨ç­–ç•¥` |
| ğŸ”¸ **è£…é¥°å™¨** | `çµæ´»ï¼ŒæŒ‰éœ€ä½¿ç”¨` | `éœ€è¦æ‰‹åŠ¨æ·»åŠ åˆ°æ¯ä¸ªæ¥å£` | `å¿«é€Ÿå¼€å‘ï¼Œç»†ç²’åº¦æ§åˆ¶` |

---

## 2. ğŸ¢ ç»Ÿä¸€è®¤è¯ä¸­å¿ƒ


### 2.1 ä¸ºä»€ä¹ˆéœ€è¦ç»Ÿä¸€è®¤è¯ä¸­å¿ƒ


> ğŸŒ° **ç”Ÿæ´»ç±»æ¯”**  
> å°±åƒä¸€ä¸ªå¤§å‹å•†åœºï¼Œå¦‚æœæ¯ä¸ªåº—é“ºéƒ½æœ‰è‡ªå·±çš„ä¼šå‘˜å¡ç³»ç»Ÿï¼Œé¡¾å®¢å°±éœ€è¦åŠå¾ˆå¤šå¼ å¡ã€‚ç»Ÿä¸€è®¤è¯ä¸­å¿ƒå°±åƒå•†åœºçš„ç»Ÿä¸€ä¼šå‘˜ç³»ç»Ÿï¼Œä¸€å¼ å¡èµ°éå…¨å•†åœºã€‚

**ğŸ”¸ è§£å†³çš„é—®é¢˜**
- **é‡å¤ç™»å½•**ï¼šç”¨æˆ·ä¸ç”¨åœ¨æ¯ä¸ªç³»ç»Ÿéƒ½ç™»å½•ä¸€é
- **å¯†ç ç®¡ç†**ï¼šç”¨æˆ·åªéœ€è¦è®°ä½ä¸€å¥—ç”¨æˆ·åå¯†ç 
- **å®‰å…¨ç»Ÿä¸€**ï¼šæ‰€æœ‰ç³»ç»Ÿçš„å®‰å…¨ç­–ç•¥åœ¨ä¸€ä¸ªåœ°æ–¹ç®¡ç†
- **ç”¨æˆ·ä½“éªŒ**ï¼šä¸€æ¬¡ç™»å½•ï¼Œåˆ°å¤„å¯ç”¨

### 2.2 ç»Ÿä¸€è®¤è¯ä¸­å¿ƒæ¶æ„


```
ç”¨æˆ·æµè§ˆå™¨                è®¤è¯ä¸­å¿ƒ                å„ä¸ªä¸šåŠ¡ç³»ç»Ÿ
     â”‚                      â”‚                       â”‚
     â”‚â”€â”€[1]è®¿é—®ç³»ç»ŸAâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                       â”‚
     â”‚                      â”‚                       â”‚
     â”‚                  [2]æ£€æŸ¥æœªç™»å½•             â”‚
     â”‚                      â”‚                       â”‚
     â”‚â—„â”€[3]é‡å®šå‘åˆ°è®¤è¯ä¸­å¿ƒâ”€â”€â”‚                       â”‚
     â”‚                      â”‚                       â”‚
     â”‚â”€â”€[4]è¾“å…¥ç”¨æˆ·åå¯†ç â”€â”€â”€â”€â–¶â”‚                       â”‚
     â”‚                      â”‚                       â”‚
     â”‚â—„â”€[5]è¿”å›è®¤è¯Tokenâ”€â”€â”€â”€â”€â”‚                       â”‚
     â”‚                      â”‚                       â”‚
     â”‚â”€â”€[6]å¸¦Tokenè®¿é—®ç³»ç»ŸAâ”€â”€â”‚â”€â”€â”€â”€â”€[7]éªŒè¯Tokenâ”€â”€â”€â”€â–¶â”‚
     â”‚                      â”‚                       â”‚
     â”‚â—„â”€[8]è¿”å›ä¸šåŠ¡æ•°æ®â”€â”€â”€â”€â”€â”€â”‚â—„â”€â”€â”€â”€[9]è¿”å›ç»“æœâ”€â”€â”€â”€â”€â”€â”‚
```

### 2.3 è®¤è¯ä¸­å¿ƒæ ¸å¿ƒåŠŸèƒ½


##### ğŸ”¹ ç”¨æˆ·è®¤è¯


```java
@RestController
@RequestMapping("/auth")
public class AuthController {
    
    // ğŸ”¸ ç”¨æˆ·ç™»å½•
    @PostMapping("/login")
    public ResponseEntity<?> login(@RequestBody LoginRequest request) {
        // éªŒè¯ç”¨æˆ·åå¯†ç 
        User user = userService.authenticate(
            request.getUsername(), 
            request.getPassword()
        );
        
        if (user == null) {
            return ResponseEntity.status(401)
                .body(new ErrorResponse("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"));
        }
        
        // ç”Ÿæˆè®¿é—®Token
        String accessToken = jwtService.generateToken(user);
        String refreshToken = jwtService.generateRefreshToken(user);
        
        return ResponseEntity.ok(new LoginResponse(
            accessToken, 
            refreshToken, 
            user.getId()
        ));
    }
}
```

##### ğŸ”¹ TokenéªŒè¯æœåŠ¡


```java
@RestController
@RequestMapping("/auth")
public class TokenController {
    
    // ğŸ”¸ éªŒè¯Tokenæ˜¯å¦æœ‰æ•ˆ
    @PostMapping("/validate")
    public ResponseEntity<?> validateToken(@RequestBody TokenRequest request) {
        try {
            // è§£æå¹¶éªŒè¯Token
            Claims claims = jwtService.parseToken(request.getToken());
            
            // æ£€æŸ¥Tokenæ˜¯å¦è¿‡æœŸ
            if (claims.getExpiration().before(new Date())) {
                return ResponseEntity.status(401)
                    .body(new ErrorResponse("Tokenå·²è¿‡æœŸ"));
            }
            
            // è¿”å›ç”¨æˆ·ä¿¡æ¯
            Long userId = claims.get("userId", Long.class);
            User user = userService.getUserById(userId);
            
            return ResponseEntity.ok(new ValidateResponse(
                true, 
                user.getId(), 
                user.getRoles()
            ));
            
        } catch (Exception e) {
            return ResponseEntity.status(401)
                .body(new ErrorResponse("Tokenæ— æ•ˆ"));
        }
    }
}
```

##### ğŸ”¹ æƒé™æ£€æŸ¥æœºåˆ¶


```java
@Service
public class PermissionService {
    
    // ğŸ”¸ æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰è®¿é—®æƒé™
    public boolean hasPermission(Long userId, String resource, String action) {
        // è·å–ç”¨æˆ·è§’è‰²
        List<Role> roles = userService.getUserRoles(userId);
        
        // æ£€æŸ¥è§’è‰²æƒé™
        for (Role role : roles) {
            List<Permission> permissions = roleService.getRolePermissions(role.getId());
            
            for (Permission permission : permissions) {
                if (permission.getResource().equals(resource) && 
                    permission.getAction().equals(action)) {
                    return true;
                }
            }
        }
        
        return false;
    }
}
```

### 2.4 ä¸šåŠ¡ç³»ç»Ÿé›†æˆ


```java
// ä¸šåŠ¡ç³»ç»Ÿä¸­çš„è®¤è¯æ£€æŸ¥
@Component
public class AuthService {
    
    @Autowired
    private RestTemplate restTemplate;
    
    public User validateTokenWithAuthCenter(String token) {
        try {
            // ğŸ”¸ è°ƒç”¨è®¤è¯ä¸­å¿ƒéªŒè¯Token
            TokenRequest request = new TokenRequest(token);
            ResponseEntity<ValidateResponse> response = restTemplate.postForEntity(
                "http://auth-center/auth/validate",
                request,
                ValidateResponse.class
            );
            
            if (response.getStatusCode() == HttpStatus.OK) {
                ValidateResponse validateResponse = response.getBody();
                if (validateResponse.isValid()) {
                    return userService.getUserById(validateResponse.getUserId());
                }
            }
            
            return null;
        } catch (Exception e) {
            return null;
        }
    }
}
```

---

## 3. ğŸŒ åˆ†å¸ƒå¼Sessionç®¡ç†


### 3.1 ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼Session


> ğŸ’¡ **é€šä¿—ç†è§£**  
> ä¼ ç»ŸSessionå°±åƒä½ åœ¨é“¶è¡ŒAåŠäº‹æ—¶æ‹¿çš„å·ç ç‰Œï¼Œåªåœ¨é“¶è¡ŒAæœ‰ç”¨ã€‚åˆ†å¸ƒå¼Sessionå°±åƒé“¶è¡Œçš„VIPå¡ï¼Œåœ¨ä»»ä½•ä¸€ä¸ªé“¶è¡Œç½‘ç‚¹éƒ½èƒ½è¯†åˆ«ä½ çš„èº«ä»½ã€‚

**ğŸ”¸ ä¼ ç»ŸSessionçš„é—®é¢˜**
- **æœåŠ¡å™¨ç»‘å®š**ï¼šSessionå­˜å‚¨åœ¨å•ä¸ªæœåŠ¡å™¨ä¸Š
- **æ‰©å±•å›°éš¾**ï¼šå¢åŠ æœåŠ¡å™¨åï¼ŒSessionæ— æ³•å…±äº«
- **å•ç‚¹æ•…éšœ**ï¼šæœåŠ¡å™¨å®•æœºï¼Œæ‰€æœ‰Sessionä¸¢å¤±

**ğŸ”¸ åˆ†å¸ƒå¼Sessionçš„ä¼˜åŠ¿**
- **æœåŠ¡å™¨æ— å…³**ï¼šä»»ä½•æœåŠ¡å™¨éƒ½èƒ½è®¿é—®Session
- **é«˜å¯ç”¨æ€§**ï¼šæœåŠ¡å™¨å®•æœºä¸å½±å“ç”¨æˆ·ç™»å½•çŠ¶æ€
- **æ°´å¹³æ‰©å±•**ï¼šå¯ä»¥éšæ„å¢å‡æœåŠ¡å™¨

### 3.2 åˆ†å¸ƒå¼Sessionå®ç°æ–¹æ¡ˆ


##### ğŸ”¹ Rediså…±äº«å­˜å‚¨æ–¹æ¡ˆ


```java
@Configuration
@EnableRedisHttpSession
public class SessionConfig {
    
    @Bean
    public RedisConnectionFactory connectionFactory() {
        return new LettuceConnectionFactory("redis-server", 6379);
    }
}

// Sessionæ“ä½œç¤ºä¾‹
@Service
public class SessionService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // ğŸ”¸ å­˜å‚¨ç”¨æˆ·Session
    public void saveUserSession(String sessionId, User user) {
        String key = "session:" + sessionId;
        redisTemplate.opsForValue().set(key, user, Duration.ofHours(2));
    }
    
    // ğŸ”¸ è·å–ç”¨æˆ·Session
    public User getUserSession(String sessionId) {
        String key = "session:" + sessionId;
        return (User) redisTemplate.opsForValue().get(key);
    }
    
    // ğŸ”¸ åˆ é™¤Sessionï¼ˆç”¨æˆ·é€€å‡ºï¼‰
    public void removeSession(String sessionId) {
        String key = "session:" + sessionId;
        redisTemplate.delete(key);
    }
}
```

##### ğŸ”¹ JWTæ— çŠ¶æ€æ–¹æ¡ˆ


```java
@Service
public class JwtSessionService {
    
    private final String SECRET_KEY = "your-secret-key";
    
    // ğŸ”¸ åˆ›å»ºJWT Tokenï¼ˆæ›¿ä»£ä¼ ç»ŸSessionï¼‰
    public String createToken(User user) {
        return Jwts.builder()
            .setSubject(user.getUsername())
            .claim("userId", user.getId())
            .claim("roles", user.getRoles())
            .setExpiration(new Date(System.currentTimeMillis() + 86400000)) // 24å°æ—¶
            .signWith(SignatureAlgorithm.HS256, SECRET_KEY)
            .compact();
    }
    
    // ğŸ”¸ è§£æTokenè·å–ç”¨æˆ·ä¿¡æ¯
    public User getUserFromToken(String token) {
        try {
            Claims claims = Jwts.parser()
                .setSigningKey(SECRET_KEY)
                .parseClaimsJws(token)
                .getBody();
                
            Long userId = claims.get("userId", Long.class);
            return userService.getUserById(userId);
        } catch (Exception e) {
            return null;
        }
    }
}
```

### 3.3 ä¸¤ç§æ–¹æ¡ˆå¯¹æ¯”


| æ–¹æ¡ˆ | **ä¼˜åŠ¿** | **åŠ£åŠ¿** | **é€‚ç”¨åœºæ™¯** |
|------|---------|---------|-------------|
| ğŸ”¸ **Rediså…±äº«** | `æ”¯æŒSessionæ“ä½œï¼Œå¯éšæ—¶æ’¤é”€` | `éœ€è¦é¢å¤–RedisæœåŠ¡å™¨` | `éœ€è¦ç²¾ç¡®æ§åˆ¶Sessionç”Ÿå‘½å‘¨æœŸ` |
| ğŸ”¸ **JWTæ— çŠ¶æ€** | `æ— éœ€å­˜å‚¨ï¼Œå®Œå…¨æ— çŠ¶æ€` | `æ— æ³•æ’¤é”€ï¼ŒTokenè¾ƒå¤§` | `å¾®æœåŠ¡æ¶æ„ï¼Œç®€åŒ–éƒ¨ç½²` |

---

## 4. ğŸšª å¾®æœåŠ¡è®¤è¯ç½‘å…³


### 4.1 è®¤è¯ç½‘å…³çš„ä½œç”¨


> ğŸŒ° **ç”Ÿæ´»ç±»æ¯”**  
> å¾®æœåŠ¡è®¤è¯ç½‘å…³å°±åƒå¤§å‹è´­ç‰©ä¸­å¿ƒçš„æ€»å…¥å£ï¼Œæ‰€æœ‰é¡¾å®¢éƒ½è¦ä»è¿™é‡Œè¿›å…¥ï¼Œå®‰ä¿äººå‘˜åœ¨è¿™é‡Œç»Ÿä¸€æ£€æŸ¥æ¯ä¸ªäººçš„èº«ä»½å’Œæƒé™ï¼Œç„¶åå¼•å¯¼åˆ°å¯¹åº”çš„åŒºåŸŸã€‚

**ğŸ”¸ æ ¸å¿ƒåŠŸèƒ½**
- **ç»Ÿä¸€å…¥å£**ï¼šæ‰€æœ‰å¤–éƒ¨è¯·æ±‚éƒ½ç»è¿‡ç½‘å…³
- **èº«ä»½è®¤è¯**ï¼šéªŒè¯ç”¨æˆ·èº«ä»½çš„åˆæ³•æ€§
- **æƒé™æ§åˆ¶**ï¼šæ£€æŸ¥ç”¨æˆ·çš„è®¿é—®æƒé™
- **è¯·æ±‚è½¬å‘**ï¼šå°†åˆæ³•è¯·æ±‚è½¬å‘åˆ°å¯¹åº”çš„å¾®æœåŠ¡

### 4.2 ç½‘å…³è®¤è¯æ¶æ„


```
å¤–éƒ¨å®¢æˆ·ç«¯                è®¤è¯ç½‘å…³                å¾®æœåŠ¡é›†ç¾¤
     â”‚                      â”‚                       â”‚
     â”‚â”€â”€[1]å‘é€è¯·æ±‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                       â”‚
     â”‚   (å¸¦Token)          â”‚                       â”‚
     â”‚                      â”‚â”€â”€[2]éªŒè¯Token        â”‚
     â”‚                      â”‚   æ£€æŸ¥æƒé™            â”‚
     â”‚                      â”‚                       â”‚
     â”‚                      â”‚â”€â”€[3]è½¬å‘è¯·æ±‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ ç”¨æˆ·æœåŠ¡
     â”‚                      â”‚   (æ·»åŠ ç”¨æˆ·ä¿¡æ¯)       â”‚
     â”‚                      â”‚                       â”‚
     â”‚â—„â”€[4]è¿”å›å“åº”â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â—„â”€[5]ä¸šåŠ¡å¤„ç†ç»“æœâ”€â”€â”€â”€â”€â”‚
```

### 4.3 Spring Cloud Gatewayå®ç°


```java
@Component
public class AuthGatewayFilter implements GlobalFilter, Ordered {
    
    @Autowired
    private AuthService authService;
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, 
                            GatewayFilterChain chain) {
        
        ServerHttpRequest request = exchange.getRequest();
        String path = request.getURI().getPath();
        
        // ğŸ”¸ æ£€æŸ¥æ˜¯å¦æ˜¯å…¬å¼€æ¥å£
        if (isPublicApi(path)) {
            return chain.filter(exchange);
        }
        
        // ğŸ”¸ è·å–Authorizationå¤´
        String authHeader = request.getHeaders().getFirst("Authorization");
        if (authHeader == null || !authHeader.startsWith("Bearer ")) {
            return onError(exchange, "ç¼ºå°‘è®¤è¯ä¿¡æ¯", HttpStatus.UNAUTHORIZED);
        }
        
        String token = authHeader.substring(7);
        
        // ğŸ”¸ éªŒè¯Token
        return authService.validateToken(token)
            .flatMap(user -> {
                if (user == null) {
                    return onError(exchange, "Tokenæ— æ•ˆ", HttpStatus.UNAUTHORIZED);
                }
                
                // ğŸ”¸ æ£€æŸ¥æ¥å£æƒé™
                if (!hasPermission(user, path)) {
                    return onError(exchange, "æƒé™ä¸è¶³", HttpStatus.FORBIDDEN);
                }
                
                // ğŸ”¸ æ·»åŠ ç”¨æˆ·ä¿¡æ¯åˆ°è¯·æ±‚å¤´ï¼Œä¼ é€’ç»™ä¸‹æ¸¸æœåŠ¡
                ServerHttpRequest modifiedRequest = exchange.getRequest()
                    .mutate()
                    .header("X-User-Id", user.getId().toString())
                    .header("X-User-Roles", String.join(",", user.getRoles()))
                    .build();
                
                return chain.filter(exchange.mutate()
                    .request(modifiedRequest)
                    .build());
            });
    }
    
    private boolean hasPermission(User user, String path) {
        // ç®€åŒ–çš„æƒé™æ£€æŸ¥é€»è¾‘
        return user.getRoles().contains("ADMIN") || 
               path.startsWith("/api/public/");
    }
    
    private Mono<Void> onError(ServerWebExchange exchange, 
                              String message, 
                              HttpStatus status) {
        ServerHttpResponse response = exchange.getResponse();
        response.setStatusCode(status);
        
        String body = "{\"error\":\"" + message + "\"}";
        DataBuffer buffer = response.bufferFactory().wrap(body.getBytes());
        
        return response.writeWith(Mono.just(buffer));
    }
    
    @Override
    public int getOrder() {
        return -100; // é«˜ä¼˜å…ˆçº§ï¼Œä¼˜å…ˆæ‰§è¡Œ
    }
}
```

### 4.4 å¾®æœåŠ¡æ¥æ”¶ç”¨æˆ·ä¿¡æ¯


```java
// ä¸‹æ¸¸å¾®æœåŠ¡ä¸­è·å–ç”¨æˆ·ä¿¡æ¯
@RestController
@RequestMapping("/api/orders")
public class OrderController {
    
    @GetMapping("/my")
    public ResponseEntity<?> getMyOrders(HttpServletRequest request) {
        // ğŸ”¸ ä»ç½‘å…³ä¼ é€’çš„è¯·æ±‚å¤´ä¸­è·å–ç”¨æˆ·ä¿¡æ¯
        String userIdHeader = request.getHeader("X-User-Id");
        String userRolesHeader = request.getHeader("X-User-Roles");
        
        if (userIdHeader == null) {
            return ResponseEntity.status(401).body("ç”¨æˆ·ä¿¡æ¯ç¼ºå¤±");
        }
        
        Long userId = Long.parseLong(userIdHeader);
        List<String> roles = Arrays.asList(userRolesHeader.split(","));
        
        // ğŸ”¸ åŸºäºç”¨æˆ·IDæŸ¥è¯¢è®¢å•
        List<Order> orders = orderService.getOrdersByUserId(userId);
        
        return ResponseEntity.ok(orders);
    }
}
```

---

## 5. âš¡ è®¤è¯æ€§èƒ½ä¼˜åŒ–


### 5.1 ä¸ºä»€ä¹ˆéœ€è¦æ€§èƒ½ä¼˜åŒ–


> ğŸ’¡ **ç°å®é—®é¢˜**  
> æƒ³è±¡ä¸€ä¸ªå¤§å‹ç½‘ç«™æ¯ç§’æœ‰10ä¸‡æ¬¡è¯·æ±‚ï¼Œå¦‚æœæ¯æ¬¡éƒ½è¦æŸ¥è¯¢æ•°æ®åº“éªŒè¯ç”¨æˆ·èº«ä»½ï¼Œæ•°æ®åº“ä¼šè¢«å‹å®ã€‚æˆ‘ä»¬éœ€è¦ç”¨å„ç§æŠ€æœ¯æ‰‹æ®µæ¥å‡è½»å‹åŠ›ï¼Œæé«˜å“åº”é€Ÿåº¦ã€‚

**ğŸ”¸ æ€§èƒ½ç“¶é¢ˆç‚¹**
- **æ•°æ®åº“æŸ¥è¯¢**ï¼šæ¯æ¬¡è®¤è¯éƒ½æŸ¥æ•°æ®åº“å¾ˆæ…¢
- **åŠ å¯†è§£å¯†**ï¼šJWTç­¾åéªŒè¯æ¶ˆè€—CPU
- **ç½‘ç»œè¯·æ±‚**ï¼šè°ƒç”¨è®¤è¯ä¸­å¿ƒå¢åŠ å»¶è¿Ÿ
- **é‡å¤è®¡ç®—**ï¼šç›¸åŒTokenåå¤éªŒè¯æµªè´¹èµ„æº

### 5.2 ç¼“å­˜ä¼˜åŒ–ç­–ç•¥


##### ğŸ”¹ Tokenç¼“å­˜


```java
@Service
public class CachedAuthService {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    // ğŸ”¸ å¸¦ç¼“å­˜çš„TokenéªŒè¯
    public User validateTokenWithCache(String token) {
        // å…ˆä»ç¼“å­˜æŸ¥æ‰¾
        String cacheKey = "token_cache:" + token;
        String cachedUserInfo = redisTemplate.opsForValue().get(cacheKey);
        
        if (cachedUserInfo != null) {
            return JSON.parseObject(cachedUserInfo, User.class);
        }
        
        // ç¼“å­˜æœªå‘½ä¸­ï¼Œæ‰§è¡ŒçœŸæ­£çš„TokenéªŒè¯
        User user = validateTokenFromDatabase(token);
        if (user != null) {
            // ç¼“å­˜ç»“æœï¼Œè®¾ç½®è¾ƒçŸ­çš„è¿‡æœŸæ—¶é—´
            redisTemplate.opsForValue().set(
                cacheKey, 
                JSON.toJSONString(user), 
                Duration.ofMinutes(5)
            );
        }
        
        return user;
    }
}
```

##### ğŸ”¹ ç”¨æˆ·ä¿¡æ¯ç¼“å­˜


```java
@Service
public class UserCacheService {
    
    @Cacheable(value = "users", key = "#userId")
    public User getUserById(Long userId) {
        return userRepository.findById(userId).orElse(null);
    }
    
    @Cacheable(value = "user_permissions", key = "#userId")
    public List<String> getUserPermissions(Long userId) {
        return permissionRepository.findByUserId(userId);
    }
    
    // ğŸ”¸ ç”¨æˆ·ä¿¡æ¯æ›´æ–°æ—¶æ¸…é™¤ç¼“å­˜
    @CacheEvict(value = {"users", "user_permissions"}, key = "#user.id")
    public void updateUser(User user) {
        userRepository.save(user);
    }
}
```

### 5.3 å¼‚æ­¥å¤„ç†ä¼˜åŒ–


```java
@Service
public class AsyncAuthService {
    
    @Async
    public CompletableFuture<Boolean> logAuthEventAsync(String userId, 
                                                       String action, 
                                                       String ip) {
        // ğŸ”¸ å¼‚æ­¥è®°å½•è®¤è¯æ—¥å¿—ï¼Œä¸é˜»å¡ä¸»æµç¨‹
        try {
            AuthLog log = new AuthLog(userId, action, ip, new Date());
            authLogRepository.save(log);
            return CompletableFuture.completedFuture(true);
        } catch (Exception e) {
            return CompletableFuture.completedFuture(false);
        }
    }
    
    @Async
    public CompletableFuture<Void> updateLastLoginTimeAsync(Long userId) {
        // ğŸ”¸ å¼‚æ­¥æ›´æ–°æœ€åç™»å½•æ—¶é—´
        userService.updateLastLoginTime(userId, new Date());
        return CompletableFuture.completedFuture(null);
    }
}
```

### 5.4 æ‰¹é‡å¤„ç†ä¼˜åŒ–


```java
@Service
public class BatchAuthService {
    
    // ğŸ”¸ æ‰¹é‡éªŒè¯Tokenï¼ˆé€‚ç”¨äºæ‰¹é‡å¤„ç†åœºæ™¯ï¼‰
    public Map<String, User> validateTokensBatch(List<String> tokens) {
        Map<String, User> results = new HashMap<>();
        
        // å…ˆä»ç¼“å­˜æ‰¹é‡è·å–
        List<String> cacheKeys = tokens.stream()
            .map(token -> "token_cache:" + token)
            .collect(Collectors.toList());
            
        List<String> cachedResults = redisTemplate.opsForValue()
            .multiGet(cacheKeys);
            
        // å¤„ç†ç¼“å­˜å‘½ä¸­çš„Token
        for (int i = 0; i < tokens.size(); i++) {
            String cachedResult = cachedResults.get(i);
            if (cachedResult != null) {
                results.put(tokens.get(i), 
                    JSON.parseObject(cachedResult, User.class));
            }
        }
        
        // æ‰¹é‡å¤„ç†ç¼“å­˜æœªå‘½ä¸­çš„Token
        List<String> uncachedTokens = tokens.stream()
            .filter(token -> !results.containsKey(token))
            .collect(Collectors.toList());
            
        if (!uncachedTokens.isEmpty()) {
            Map<String, User> dbResults = validateTokensFromDatabase(uncachedTokens);
            results.putAll(dbResults);
            
            // æ‰¹é‡ç¼“å­˜ç»“æœ
            batchCacheResults(dbResults);
        }
        
        return results;
    }
}
```

---

## 6. ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡ä¼˜åŒ–


### 6.1 æ ¸å¿ƒè¡¨ç»“æ„è®¾è®¡


##### ğŸ”¹ ç”¨æˆ·è¡¨ (users)


```sql
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) NOT NULL UNIQUE COMMENT 'ç”¨æˆ·å',
    email VARCHAR(100) NOT NULL UNIQUE COMMENT 'é‚®ç®±',
    password_hash VARCHAR(255) NOT NULL COMMENT 'å¯†ç å“ˆå¸Œ',
    phone VARCHAR(20) COMMENT 'æ‰‹æœºå·',
    status TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€ï¼š1-æ­£å¸¸ï¼Œ0-ç¦ç”¨',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    last_login_at TIMESTAMP COMMENT 'æœ€åç™»å½•æ—¶é—´',
    login_count INT DEFAULT 0 COMMENT 'ç™»å½•æ¬¡æ•°',
    
    -- ğŸ”¸ ç´¢å¼•ä¼˜åŒ–
    INDEX idx_username (username),
    INDEX idx_email (email),
    INDEX idx_phone (phone),
    INDEX idx_status (status),
    INDEX idx_last_login (last_login_at)
) COMMENT = 'ç”¨æˆ·åŸºç¡€ä¿¡æ¯è¡¨';
```

##### ğŸ”¹ è§’è‰²è¡¨ (roles)


```sql
CREATE TABLE roles (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(50) NOT NULL UNIQUE COMMENT 'è§’è‰²åç§°',
    display_name VARCHAR(100) COMMENT 'æ˜¾ç¤ºåç§°',
    description TEXT COMMENT 'è§’è‰²æè¿°',
    status TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€ï¼š1-å¯ç”¨ï¼Œ0-ç¦ç”¨',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_name (name),
    INDEX idx_status (status)
) COMMENT = 'è§’è‰²ä¿¡æ¯è¡¨';
```

##### ğŸ”¹ æƒé™è¡¨ (permissions)


```sql
CREATE TABLE permissions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL UNIQUE COMMENT 'æƒé™æ ‡è¯†',
    display_name VARCHAR(100) COMMENT 'æƒé™æ˜¾ç¤ºå',
    resource VARCHAR(100) COMMENT 'èµ„æºæ ‡è¯†',
    action VARCHAR(50) COMMENT 'æ“ä½œç±»å‹',
    description TEXT COMMENT 'æƒé™æè¿°',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_name (name),
    INDEX idx_resource_action (resource, action)
) COMMENT = 'æƒé™ä¿¡æ¯è¡¨';
```

##### ğŸ”¹ ç”¨æˆ·è§’è‰²å…³è”è¡¨ (user_roles)


```sql
CREATE TABLE user_roles (
    user_id BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
    role_id BIGINT NOT NULL COMMENT 'è§’è‰²ID',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ†é…æ—¶é—´',
    
    PRIMARY KEY (user_id, role_id),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE,
    
    INDEX idx_user_id (user_id),
    INDEX idx_role_id (role_id)
) COMMENT = 'ç”¨æˆ·è§’è‰²å…³è”è¡¨';
```

##### ğŸ”¹ è§’è‰²æƒé™å…³è”è¡¨ (role_permissions)


```sql
CREATE TABLE role_permissions (
    role_id BIGINT NOT NULL COMMENT 'è§’è‰²ID',
    permission_id BIGINT NOT NULL COMMENT 'æƒé™ID',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    PRIMARY KEY (role_id, permission_id),
    FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE,
    FOREIGN KEY (permission_id) REFERENCES permissions(id) ON DELETE CASCADE,
    
    INDEX idx_role_id (role_id),
    INDEX idx_permission_id (permission_id)
) COMMENT = 'è§’è‰²æƒé™å…³è”è¡¨';
```

### 6.2 ç´¢å¼•ä¼˜åŒ–ç­–ç•¥


##### ğŸ”¹ æŸ¥è¯¢ä¼˜åŒ–ç´¢å¼•


```sql
-- ğŸ”¸ ç”¨æˆ·ç™»å½•æŸ¥è¯¢ä¼˜åŒ–
-- å¸¸è§æŸ¥è¯¢ï¼šSELECT * FROM users WHERE username = ? AND status = 1
CREATE INDEX idx_username_status ON users(username, status);

-- ğŸ”¸ æƒé™æ£€æŸ¥æŸ¥è¯¢ä¼˜åŒ–  
-- æŸ¥è¯¢ç”¨æˆ·çš„æ‰€æœ‰æƒé™
CREATE INDEX idx_user_role_permission ON user_roles(user_id);
CREATE INDEX idx_role_permission_detail ON role_permissions(role_id);

-- ğŸ”¸ èµ„æºæƒé™æŸ¥è¯¢ä¼˜åŒ–
-- æ£€æŸ¥ç”¨æˆ·å¯¹ç‰¹å®šèµ„æºçš„æ“ä½œæƒé™
CREATE INDEX idx_permission_resource_action ON permissions(resource, action);
```

##### ğŸ”¹ åˆ†åŒºè¡¨ä¼˜åŒ–


```sql
-- ğŸ”¸ è®¤è¯æ—¥å¿—è¡¨åˆ†åŒºï¼ˆæŒ‰æœˆåˆ†åŒºï¼‰
CREATE TABLE auth_logs (
    id BIGINT AUTO_INCREMENT,
    user_id BIGINT,
    action VARCHAR(50),
    ip_address VARCHAR(45),
    user_agent TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    PRIMARY KEY (id, created_at),
    INDEX idx_user_action (user_id, action),
    INDEX idx_ip (ip_address),
    INDEX idx_created_at (created_at)
) PARTITION BY RANGE (YEAR(created_at) * 100 + MONTH(created_at)) (
    PARTITION p202501 VALUES LESS THAN (202502),
    PARTITION p202502 VALUES LESS THAN (202503),
    PARTITION p202503 VALUES LESS THAN (202504)
    -- å¯ä»¥ç»§ç»­æ·»åŠ æ›´å¤šåˆ†åŒº
);
```

---

## 7. ğŸš€ ç¼“å­˜ç­–ç•¥å®ç°


### 7.1 Redisç¼“å­˜æ¶æ„


```java
@Configuration
public class RedisCacheConfig {
    
    @Bean
    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory factory) {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(factory);
        
        // ğŸ”¸ è®¾ç½®åºåˆ—åŒ–å™¨
        template.setKeySerializer(new StringRedisSerializer());
        template.setValueSerializer(new GenericJackson2JsonRedisSerializer());
        template.setHashKeySerializer(new StringRedisSerializer());
        template.setHashValueSerializer(new GenericJackson2JsonRedisSerializer());
        
        return template;
    }
    
    @Bean
    public CacheManager cacheManager(RedisConnectionFactory factory) {
        RedisCacheManager.Builder builder = RedisCacheManager
            .RedisCacheManagerBuilder
            .fromConnectionFactory(factory)
            .cacheDefaults(cacheConfiguration());
            
        return builder.build();
    }
    
    private RedisCacheConfiguration cacheConfiguration() {
        return RedisCacheConfiguration.defaultCacheConfig()
            .entryTtl(Duration.ofMinutes(10)) // é»˜è®¤10åˆ†é’Ÿè¿‡æœŸ
            .serializeKeysWith(RedisSerializationContext.SerializationPair
                .fromSerializer(new StringRedisSerializer()))
            .serializeValuesWith(RedisSerializationContext.SerializationPair
                .fromSerializer(new GenericJackson2JsonRedisSerializer()));
    }
}
```

### 7.2 åˆ†å±‚ç¼“å­˜ç­–ç•¥


```java
@Service
public class LayeredCacheService {
    
    // ğŸ”¸ æœ¬åœ°ç¼“å­˜ï¼ˆCaffeineï¼‰
    private final Cache<String, User> localCache = Caffeine.newBuilder()
        .maximumSize(1000)
        .expireAfterWrite(Duration.ofMinutes(2))
        .build();
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    public User getUser(Long userId) {
        String key = "user:" + userId;
        
        // ğŸ”¸ å…ˆæŸ¥æœ¬åœ°ç¼“å­˜
        User user = localCache.getIfPresent(key);
        if (user != null) {
            return user;
        }
        
        // ğŸ”¸ æœ¬åœ°ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥Redis
        user = (User) redisTemplate.opsForValue().get(key);
        if (user != null) {
            localCache.put(key, user); // æ”¾å…¥æœ¬åœ°ç¼“å­˜
            return user;
        }
        
        // ğŸ”¸ Redisä¹Ÿæœªå‘½ä¸­ï¼ŒæŸ¥æ•°æ®åº“
        user = userRepository.findById(userId).orElse(null);
        if (user != null) {
            // åŒæ—¶æ›´æ–°ä¸¤å±‚ç¼“å­˜
            localCache.put(key, user);
            redisTemplate.opsForValue().set(key, user, Duration.ofMinutes(10));
        }
        
        return user;
    }
    
    // ğŸ”¸ æ›´æ–°æ—¶æ¸…é™¤ä¸¤å±‚ç¼“å­˜
    public void invalidateUser(Long userId) {
        String key = "user:" + userId;
        localCache.invalidate(key);
        redisTemplate.delete(key);
    }
}
```

### 7.3 ç¼“å­˜è¿‡æœŸç­–ç•¥


```java
@Component
public class CacheExpirationManager {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // ğŸ”¸ ä¸åŒç±»å‹æ•°æ®ä½¿ç”¨ä¸åŒçš„è¿‡æœŸæ—¶é—´
    public void cacheWithExpiration(String key, Object value, CacheType type) {
        Duration expiration;
        
        switch (type) {
            case USER_INFO:
                expiration = Duration.ofMinutes(30); // ç”¨æˆ·ä¿¡æ¯30åˆ†é’Ÿ
                break;
            case TOKEN_VALIDATION:
                expiration = Duration.ofMinutes(5);  // TokenéªŒè¯5åˆ†é’Ÿ
                break;
            case PERMISSION_DATA:
                expiration = Duration.ofHours(1);    // æƒé™æ•°æ®1å°æ—¶
                break;
            case SESSION_DATA:
                expiration = Duration.ofMinutes(15); // Sessionæ•°æ®15åˆ†é’Ÿ
                break;
            default:
                expiration = Duration.ofMinutes(10); // é»˜è®¤10åˆ†é’Ÿ
        }
        
        redisTemplate.opsForValue().set(key, value, expiration);
    }
    
    // ğŸ”¸ åŸºäºè®¿é—®é¢‘ç‡çš„åŠ¨æ€è¿‡æœŸæ—¶é—´
    public void cacheWithDynamicExpiration(String key, Object value, int accessCount) {
        Duration expiration;
        
        if (accessCount > 100) {
            expiration = Duration.ofHours(2);    // é«˜é¢‘è®¿é—®æ•°æ®ç¼“å­˜2å°æ—¶
        } else if (accessCount > 10) {
            expiration = Duration.ofMinutes(30); // ä¸­é¢‘è®¿é—®æ•°æ®30åˆ†é’Ÿ
        } else {
            expiration = Duration.ofMinutes(5);  // ä½é¢‘è®¿é—®æ•°æ®5åˆ†é’Ÿ
        }
        
        redisTemplate.opsForValue().set(key, value, expiration);
    }
}

enum CacheType {
    USER_INFO, TOKEN_VALIDATION, PERMISSION_DATA, SESSION_DATA
}
```

---

## 8. âš™ï¸ å¼‚æ­¥å¤„ç†æœºåˆ¶


### 8.1 æ¶ˆæ¯é˜Ÿåˆ—é›†æˆ


##### ğŸ”¹ RabbitMQå¼‚æ­¥è®¤è¯äº‹ä»¶


```java
@Configuration
@EnableRabbit
public class RabbitConfig {
    
    // ğŸ”¸ è®¤è¯äº‹ä»¶äº¤æ¢æœº
    @Bean
    public DirectExchange authExchange() {
        return new DirectExchange("auth.exchange");
    }
    
    // ğŸ”¸ ç™»å½•äº‹ä»¶é˜Ÿåˆ—
    @Bean
    public Queue loginQueue() {
        return QueueBuilder.durable("auth.login.queue").build();
    }
    
    // ğŸ”¸ æ³¨é”€äº‹ä»¶é˜Ÿåˆ—
    @Bean
    public Queue logoutQueue() {
        return QueueBuilder.durable("auth.logout.queue").build();
    }
    
    @Bean
    public Binding loginBinding() {
        return BindingBuilder.bind(loginQueue())
            .to(authExchange())
            .with("auth.login");
    }
}

@Service
public class AuthEventPublisher {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    // ğŸ”¸ å‘å¸ƒç™»å½•äº‹ä»¶
    public void publishLoginEvent(Long userId, String ip, Date loginTime) {
        LoginEvent event = new LoginEvent(userId, ip, loginTime);
        rabbitTemplate.convertAndSend(
            "auth.exchange", 
            "auth.login", 
            event
        );
    }
    
    // ğŸ”¸ å‘å¸ƒæƒé™å˜æ›´äº‹ä»¶
    public void publishPermissionChangeEvent(Long userId, List<String> newPermissions) {
        PermissionChangeEvent event = new PermissionChangeEvent(userId, newPermissions);
        rabbitTemplate.convertAndSend(
            "auth.exchange", 
            "auth.permission.change", 
            event
        );
    }
}
```

##### ğŸ”¹ å¼‚æ­¥äº‹ä»¶å¤„ç†


```java
@Component
public class AuthEventHandler {
    
    @Autowired
    private UserService userService;
    
    @Autowired
    private LogService logService;
    
    // ğŸ”¸ å¤„ç†ç™»å½•äº‹ä»¶
    @RabbitListener(queues = "auth.login.queue")
    public void handleLoginEvent(LoginEvent event) {
        try {
            // æ›´æ–°ç”¨æˆ·æœ€åç™»å½•æ—¶é—´
            userService.updateLastLoginTime(event.getUserId(), event.getLoginTime());
            
            // è®°å½•ç™»å½•æ—¥å¿—
            logService.logUserAction(
                event.getUserId(), 
                "LOGIN", 
                event.getIpAddress()
            );
            
            // æ£€æŸ¥å¼‚å¸¸ç™»å½•ï¼ˆä¸åŒåœ°åŒºç™»å½•ï¼‰
            checkAbnormalLogin(event);
            
        } catch (Exception e) {
            // å¼‚æ­¥å¤„ç†å¤±è´¥ï¼Œè®°å½•é”™è¯¯ä½†ä¸å½±å“ä¸»æµç¨‹
            log.error("å¤„ç†ç™»å½•äº‹ä»¶å¤±è´¥", e);
        }
    }
    
    // ğŸ”¸ å¤„ç†æƒé™å˜æ›´äº‹ä»¶
    @RabbitListener(queues = "auth.permission.queue")
    public void handlePermissionChangeEvent(PermissionChangeEvent event) {
        try {
            // æ¸…é™¤ç”¨æˆ·ç›¸å…³ç¼“å­˜
            cacheService.invalidateUserPermissions(event.getUserId());
            
            // è®°å½•æƒé™å˜æ›´æ—¥å¿—
            logService.logPermissionChange(
                event.getUserId(), 
                event.getNewPermissions()
            );
            
            // é€šçŸ¥å…¶ä»–ç³»ç»Ÿæƒé™å‘ç”Ÿå˜åŒ–
            notificationService.notifyPermissionChange(event);
            
        } catch (Exception e) {
            log.error("å¤„ç†æƒé™å˜æ›´äº‹ä»¶å¤±è´¥", e);
        }
    }
    
    private void checkAbnormalLogin(LoginEvent event) {
        // ğŸ”¸ ç®€å•çš„å¼‚å¸¸æ£€æµ‹é€»è¾‘
        String currentIp = event.getIpAddress();
        String lastLoginIp = userService.getLastLoginIp(event.getUserId());
        
        if (lastLoginIp != null && !currentIp.equals(lastLoginIp)) {
            // IPåœ°å€å˜åŒ–ï¼Œå¯èƒ½æ˜¯å¼‚åœ°ç™»å½•
            securityService.sendAbnormalLoginAlert(
                event.getUserId(), 
                currentIp, 
                lastLoginIp
            );
        }
    }
}
```

### 8.2 äº‹ä»¶é©±åŠ¨æ¶æ„


```java
@Component
public class AuthEventBus {
    
    @EventListener
    @Async
    public void handleUserLogin(UserLoginEvent event) {
        // ğŸ”¸ å¼‚æ­¥å¤„ç†ç™»å½•åçš„ä¸šåŠ¡é€»è¾‘
        
        // è®°å½•ç”¨æˆ·è¡Œä¸º
        behaviorTrackingService.recordLogin(event.getUserId());
        
        // æ›´æ–°ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯
        statisticsService.incrementLoginCount(event.getUserId());
        
        // æ¨é€ä¸ªæ€§åŒ–å†…å®¹
        recommendationService.updateUserProfile(event.getUserId());
    }
    
    @EventListener
    @Async
    public void handleTokenExpired(TokenExpiredEvent event) {
        // ğŸ”¸ Tokenè¿‡æœŸæ—¶çš„æ¸…ç†å·¥ä½œ
        
        // æ¸…é™¤ç›¸å…³ç¼“å­˜
        cacheService.invalidateTokenCache(event.getToken());
        
        // è®°å½•è¿‡æœŸäº‹ä»¶
        auditService.recordTokenExpiration(event);
        
        // å¦‚æœéœ€è¦ï¼Œå‘é€é€šçŸ¥ç»™ç”¨æˆ·
        if (event.shouldNotifyUser()) {
            notificationService.sendTokenExpiredNotification(event.getUserId());
        }
    }
}
```

### 8.3 æœ€ç»ˆä¸€è‡´æ€§ä¿è¯


```java
@Service
public class ConsistencyManager {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // ğŸ”¸ ç¡®ä¿ç¼“å­˜ä¸æ•°æ®åº“çš„æœ€ç»ˆä¸€è‡´æ€§
    @Transactional
    public void updateUserWithConsistency(User user) {
        try {
            // æ›´æ–°æ•°æ®åº“
            userRepository.save(user);
            
            // å‘å¸ƒæ›´æ–°äº‹ä»¶ï¼Œå¼‚æ­¥æ›´æ–°ç¼“å­˜
            applicationEventPublisher.publishEvent(
                new UserUpdatedEvent(user.getId())
            );
            
        } catch (Exception e) {
            // æ•°æ®åº“æ›´æ–°å¤±è´¥ï¼Œå‘å¸ƒè¡¥å¿äº‹ä»¶
            applicationEventPublisher.publishEvent(
                new UserUpdateFailedEvent(user.getId())
            );
            throw e;
        }
    }
    
    @EventListener
    @Async
    public void handleUserUpdated(UserUpdatedEvent event) {
        // ğŸ”¸ å¼‚æ­¥æ›´æ–°ç¼“å­˜
        try {
            User user = userRepository.findById(event.getUserId()).orElse(null);
            if (user != null) {
                String cacheKey = "user:" + event.getUserId();
                redisTemplate.opsForValue().set(cacheKey, user, Duration.ofMinutes(30));
            }
        } catch (Exception e) {
            // ç¼“å­˜æ›´æ–°å¤±è´¥ï¼Œå¯ä»¥é‡è¯•æˆ–è€…è®°å½•æ—¥å¿—
            retryService.scheduleRetry("updateUserCache", event.getUserId());
        }
    }
}
```

---

## 9. ğŸ“Š ç›‘æ§å‘Šè­¦ä½“ç³»


### 9.1 æ€§èƒ½ç›‘æ§


```java
@Component
public class AuthPerformanceMonitor {
    
    private final MeterRegistry meterRegistry;
    private final Timer authTimer;
    private final Counter authSuccessCounter;
    private final Counter authFailCounter;
    
    public AuthPerformanceMonitor(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.authTimer = Timer.builder("auth.duration")
            .description("è®¤è¯è€—æ—¶")
            .register(meterRegistry);
        this.authSuccessCounter = Counter.builder("auth.success")
            .description("è®¤è¯æˆåŠŸæ¬¡æ•°")
            .register(meterRegistry);
        this.authFailCounter = Counter.builder("auth.fail")
            .description("è®¤è¯å¤±è´¥æ¬¡æ•°")
            .register(meterRegistry);
    }
    
    // ğŸ”¸ ç›‘æ§è®¤è¯æ€§èƒ½
    public User authenticateWithMonitoring(String username, String password) {
        return Timer.Sample.start(meterRegistry)
            .stop(authTimer.wrap(() -> {
                try {
                    User user = authService.authenticate(username, password);
                    if (user != null) {
                        authSuccessCounter.increment();
                        return user;
                    } else {
                        authFailCounter.increment();
                        return null;
                    }
                } catch (Exception e) {
                    authFailCounter.increment();
                    throw e;
                }
            }));
    }
    
    // ğŸ”¸ ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡
    @EventListener
    public void onCacheEvent(CacheEvent event) {
        if (event instanceof CacheHitEvent) {
            meterRegistry.counter("cache.hit", "type", event.getCacheType()).increment();
        } else if (event instanceof CacheMissEvent) {
            meterRegistry.counter("cache.miss", "type", event.getCacheType()).increment();
        }
    }
}
```

### 9.2 é”™è¯¯å‘Šè­¦


```java
@Service
public class SecurityAlertService {
    
    @Autowired
    private NotificationService notificationService;
    
    private final AtomicLong failedLoginCount = new AtomicLong(0);
    
    // ğŸ”¸ æ£€æµ‹æš´åŠ›ç ´è§£æ”»å‡»
    @EventListener
    public void onAuthenticationFailure(AuthFailureEvent event) {
        String clientIp = event.getClientIp();
        
        // ç»Ÿè®¡å•ä¸ªIPçš„å¤±è´¥æ¬¡æ•°
        String failCountKey = "fail_count:" + clientIp;
        Long currentFailCount = redisTemplate.opsForValue()
            .increment(failCountKey, 1);
            
        redisTemplate.expire(failCountKey, Duration.ofMinutes(10));
        
        // ğŸ”¸ è§¦å‘å‘Šè­¦é˜ˆå€¼
        if (currentFailCount >= 5) {
            SecurityAlert alert = SecurityAlert.builder()
                .type("BRUTE_FORCE_ATTACK")
                .clientIp(clientIp)
                .failCount(currentFailCount)
                .message(String.format("IP %s åœ¨10åˆ†é’Ÿå†…ç™»å½•å¤±è´¥%dæ¬¡", clientIp, currentFailCount))
                .severity("HIGH")
                .build();
                
            sendAlert(alert);
            
            // ä¸´æ—¶å°ç¦IP
            blacklistService.addToBlacklist(clientIp, Duration.ofMinutes(30));
        }
    }
    
    // ğŸ”¸ æ£€æµ‹å¼‚å¸¸Tokenä½¿ç”¨
    @EventListener
    public void onAbnormalTokenUsage(TokenEvent event) {
        if (isAbnormalTokenUsage(event)) {
            SecurityAlert alert = SecurityAlert.builder()
                .type("ABNORMAL_TOKEN_USAGE")
                .userId(event.getUserId())
                .token(event.getToken().substring(0, 10) + "...")
                .message("æ£€æµ‹åˆ°Tokenå¼‚å¸¸ä½¿ç”¨æ¨¡å¼")
                .severity("MEDIUM")
                .build();
                
            sendAlert(alert);
        }
    }
    
    private void sendAlert(SecurityAlert alert) {
        // ğŸ”¸ å‘é€å‘Šè­¦åˆ°å¤šä¸ªæ¸ é“
        try {
            // é‚®ä»¶å‘Šè­¦
            notificationService.sendEmail(
                "security@company.com", 
                "å®‰å…¨å‘Šè­¦ï¼š" + alert.getType(), 
                alert.getMessage()
            );
            
            // çŸ­ä¿¡å‘Šè­¦ï¼ˆé«˜å±äº‹ä»¶ï¼‰
            if ("HIGH".equals(alert.getSeverity())) {
                notificationService.sendSms(
                    "13800138000", 
                    alert.getMessage()
                );
            }
            
            // ä¼ä¸šå¾®ä¿¡/é’‰é’‰å‘Šè­¦
            notificationService.sendToWorkChat(alert);
            
            // è®°å½•å‘Šè­¦æ—¥å¿—
            alertLogService.recordAlert(alert);
            
        } catch (Exception e) {
            log.error("å‘é€å®‰å…¨å‘Šè­¦å¤±è´¥", e);
        }
    }
    
    private boolean isAbnormalTokenUsage(TokenEvent event) {
        // ğŸ”¸ æ£€æµ‹å¼‚å¸¸ä½¿ç”¨æ¨¡å¼
        
        // 1. çŸ­æ—¶é—´å†…å¤§é‡APIè°ƒç”¨
        String rateLimitKey = "api_rate:" + event.getUserId();
        Long apiCallCount = redisTemplate.opsForValue().increment(rateLimitKey, 1);
        redisTemplate.expire(rateLimitKey, Duration.ofMinutes(1));
        
        if (apiCallCount > 1000) { // 1åˆ†é’Ÿè¶…è¿‡1000æ¬¡è°ƒç”¨
            return true;
        }
        
        // 2. å¼‚åœ°IPè®¿é—®
        String currentIp = event.getClientIp();
        String lastKnownIp = getUserLastKnownIp(event.getUserId());
        
        if (lastKnownIp != null && isDistantIp(currentIp, lastKnownIp)) {
            return true;
        }
        
        // 3. å¼‚å¸¸æ—¶é—´è®¿é—®
        LocalTime currentTime = LocalTime.now();
        if (currentTime.isBefore(LocalTime.of(6, 0)) || 
            currentTime.isAfter(LocalTime.of(23, 0))) {
            return true;
        }
        
        return false;
    }
}
```

### 9.3 å®‰å…¨äº‹ä»¶è®°å½•


```java
@Service
public class SecurityAuditService {
    
    @Autowired
    private SecurityLogRepository securityLogRepository;
    
    // ğŸ”¸ è®°å½•å®‰å…¨ç›¸å…³äº‹ä»¶
    @Async
    @EventListener
    public void recordSecurityEvent(SecurityEvent event) {
        SecurityLog log = SecurityLog.builder()
            .eventType(event.getType())
            .userId(event.getUserId())
            .clientIp(event.getClientIp())
            .userAgent(event.getUserAgent())
            .requestUri(event.getRequestUri())
            .eventData(JSON.toJSONString(event.getEventData()))
            .riskLevel(calculateRiskLevel(event))
            .occurredAt(new Date())
            .build();
            
        securityLogRepository.save(log);
        
        // é«˜é£é™©äº‹ä»¶ç«‹å³å¤„ç†
        if (log.getRiskLevel() >= RiskLevel.HIGH.getValue()) {
            handleHighRiskEvent(event, log);
        }
    }
    
    // ğŸ”¸ ç”Ÿæˆå®‰å…¨æŠ¥å‘Š
    @Scheduled(cron = "0 0 9 * * MON") // æ¯å‘¨ä¸€æ—©ä¸Š9ç‚¹
    public void generateWeeklySecurityReport() {
        Date oneWeekAgo = Date.from(Instant.now().minus(7, ChronoUnit.DAYS));
        
        // ç»Ÿè®¡ä¸€å‘¨å†…çš„å®‰å…¨äº‹ä»¶
        Map<String, Long> eventStats = securityLogRepository
            .findByOccurredAtAfter(oneWeekAgo)
            .stream()
            .collect(Collectors.groupingBy(
                SecurityLog::getEventType,
                Collectors.counting()
            ));
            
        // ç”ŸæˆæŠ¥å‘Š
        SecurityReport report = SecurityReport.builder()
            .reportPeriod("Past 7 days")
            .eventStatistics(eventStats)
            .highRiskEvents(getHighRiskEventsCount(oneWeekAgo))
            .recommendedActions(generateRecommendations(eventStats))
            .build();
            
        // å‘é€æŠ¥å‘Š
        reportService.sendSecurityReport(report);
    }
    
    private RiskLevel calculateRiskLevel(SecurityEvent event) {
        int score = 0;
        
        // ğŸ”¸ æ ¹æ®äº‹ä»¶ç±»å‹è¯„åˆ†
        switch (event.getType()) {
            case "LOGIN_FAILURE":
                score += 1;
                break;
            case "BRUTE_FORCE_ATTACK":
                score += 5;
                break;
            case "ABNORMAL_TOKEN_USAGE":
                score += 3;
                break;
            case "PERMISSION_ESCALATION":
                score += 8;
                break;
        }
        
        // ğŸ”¸ æ ¹æ®ç”¨æˆ·è§’è‰²è¯„åˆ†
        if (event.getUserRoles().contains("ADMIN")) {
            score += 2;
        }
        
        // ğŸ”¸ æ ¹æ®è®¿é—®æ—¶é—´è¯„åˆ†
        LocalTime accessTime = event.getAccessTime();
        if (accessTime.isBefore(LocalTime.of(6, 0)) || 
            accessTime.isAfter(LocalTime.of(22, 0))) {
            score += 1;
        }
        
        return RiskLevel.fromScore(score);
    }
}
```

---

## 10. ğŸ”§ ä¸»æµæŠ€æœ¯æ ˆå¯¹æ¯”


### 10.1 Spring Security


> ğŸ’¡ **ç‰¹ç‚¹**ï¼šJavaç”Ÿæ€æœ€æˆç†Ÿçš„å®‰å…¨æ¡†æ¶ï¼ŒåŠŸèƒ½å…¨é¢ä½†å­¦ä¹ æ›²çº¿è¾ƒé™¡å³­

```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(authz -> authz
                .requestMatchers("/api/public/**").permitAll()
                .requestMatchers("/api/admin/**").hasRole("ADMIN")
                .anyRequest().authenticated()
            )
            .oauth2ResourceServer(oauth2 -> oauth2
                .jwt(jwt -> jwt.decoder(jwtDecoder()))
            )
            .sessionManagement(session -> session
                .sessionCreationPolicy(SessionCreationPolicy.STATELESS)
            );
        return http.build();
    }
    
    @Bean
    public JwtDecoder jwtDecoder() {
        return NimbusJwtDecoder.withJwkSetUri("https://auth-server/jwks").build();
    }
}
```

**ğŸ¯ é€‚ç”¨åœºæ™¯**ï¼š
- âœ… å¤§å‹ä¼ä¸šçº§Javaåº”ç”¨
- âœ… éœ€è¦å¤æ‚æƒé™æ§åˆ¶çš„ç³»ç»Ÿ
- âœ… ä¸Springç”Ÿæ€æ·±åº¦é›†æˆçš„é¡¹ç›®

### 10.2 Passport.js (Node.js)


> ğŸ’¡ **ç‰¹ç‚¹**ï¼šNode.jsæœ€æµè¡Œçš„è®¤è¯åº“ï¼Œç­–ç•¥ä¸°å¯Œï¼Œé›†æˆç®€å•

```javascript
// JWTç­–ç•¥é…ç½®
const JwtStrategy = require('passport-jwt').Strategy;
const ExtractJwt = require('passport-jwt').ExtractJwt;

passport.use(new JwtStrategy({
    jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),
    secretOrKey: process.env.JWT_SECRET
}, async (payload, done) => {
    try {
        const user = await User.findById(payload.userId);
        if (user) {
            return done(null, user);
        } else {
            return done(null, false);
        }
    } catch (error) {
        return done(error, false);
    }
}));

// ä½¿ç”¨ä¸­é—´ä»¶
app.use('/api/protected', passport.authenticate('jwt', { session: false }));
```

**ğŸ¯ é€‚ç”¨åœºæ™¯**ï¼š
- âœ… Node.js Webåº”ç”¨å’ŒAPI
- âœ… éœ€è¦å¤šç§è®¤è¯ç­–ç•¥ï¼ˆOAuthã€æœ¬åœ°è®¤è¯ç­‰ï¼‰
- âœ… å¿«é€ŸåŸå‹å¼€å‘

### 10.3 Gin (Go)


> ğŸ’¡ **ç‰¹ç‚¹**ï¼šGoè¯­è¨€é«˜æ€§èƒ½Webæ¡†æ¶ï¼Œè‡ªå®šä¹‰ä¸­é—´ä»¶å®ç°è®¤è¯

```go
// JWTä¸­é—´ä»¶
func JWTMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        authHeader := c.GetHeader("Authorization")
        if authHeader == "" {
            c.JSON(401, gin.H{"error": "ç¼ºå°‘è®¤è¯å¤´"})
            c.Abort()
            return
        }
        
        tokenString := strings.Replace(authHeader, "Bearer ", "", 1)
        token, err := jwt.Parse(tokenString, func(token *jwt.Token) (interface{}, error) {
            return []byte(secretKey), nil
        })
        
        if err != nil || !token.Valid {
            c.JSON(401, gin.H{"error": "Tokenæ— æ•ˆ"})
            c.Abort()
            return
        }
        
        if claims, ok := token.Claims.(jwt.MapClaims); ok {
            c.Set("userId", claims["userId"])
            c.Set("userRoles", claims["roles"])
        }
        
        c.Next()
    }
}

// ä½¿ç”¨ä¸­é—´ä»¶
authorized := r.Group("/api")
authorized.Use(JWTMiddleware())
{
    authorized.GET("/profile", getProfile)
    authorized.POST("/orders", createOrder)
}
```

**ğŸ¯ é€‚ç”¨åœºæ™¯**ï¼š
- âœ… é«˜æ€§èƒ½APIæœåŠ¡
- âœ… å¾®æœåŠ¡æ¶æ„
- âœ… å¯¹æ€§èƒ½è¦æ±‚æé«˜çš„ç³»ç»Ÿ

### 10.4 Django (Python)


> ğŸ’¡ **ç‰¹ç‚¹**ï¼šPythonå…¨æ ˆæ¡†æ¶ï¼Œå†…ç½®è®¤è¯ç³»ç»Ÿï¼Œå¿«é€Ÿå¼€å‘

```python
# Django REST Framework JWTè®¤è¯
from rest_framework.decorators import api_view, permission_classes
from rest_framework.permissions import IsAuthenticated
from rest_framework_simplejwt.authentication import JWTAuthentication

class CustomAuthenticationMiddleware:
    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        # ğŸ”¸ è®¤è¯é€»è¾‘
        auth_header = request.META.get('HTTP_AUTHORIZATION')
        if auth_header and auth_header.startswith('Bearer '):
            token = auth_header[7:]
            try:
                user = authenticate_token(token)
                request.user = user
            except Exception:
                request.user = None
        
        response = self.get_response(request)
        return response

# ä½¿ç”¨è£…é¥°å™¨ä¿æŠ¤è§†å›¾
@api_view(['GET'])
@permission_classes([IsAuthenticated])
def protected_view(request):
    return Response({'message': f'Hello {request.user.username}'})
```

**ğŸ¯ é€‚ç”¨åœºæ™¯**ï¼š
- âœ… å¿«é€ŸåŸå‹å’ŒMVPå¼€å‘
- âœ… å†…å®¹ç®¡ç†ç³»ç»Ÿ
- âœ… æ•°æ®åˆ†æå’Œåå°ç®¡ç†ç³»ç»Ÿ

### 10.5 æŠ€æœ¯æ ˆé€‰æ‹©å¯¹æ¯”


| æŠ€æœ¯æ ˆ | **æ€§èƒ½** | **å­¦ä¹ éš¾åº¦** | **ç”Ÿæ€ä¸°å¯Œåº¦** | **é€‚ç”¨è§„æ¨¡** | **æ¨èæŒ‡æ•°** |
|-------|---------|-------------|--------------|-------------|-------------|
| ğŸ”¸ **Spring Security** | `é«˜` | `éš¾` | `æä¸°å¯Œ` | `å¤§å‹ä¼ä¸šçº§` | `â­â­â­â­â­` |
| ğŸ”¸ **Passport.js** | `ä¸­é«˜` | `ä¸­` | `ä¸°å¯Œ` | `ä¸­å°å‹åº”ç”¨` | `â­â­â­â­` |
| ğŸ”¸ **Gin** | `æé«˜` | `ä¸­` | `ä¸€èˆ¬` | `é«˜æ€§èƒ½API` | `â­â­â­â­` |
| ğŸ”¸ **Django** | `ä¸­` | `æ˜“` | `ä¸°å¯Œ` | `å¿«é€Ÿå¼€å‘` | `â­â­â­` |

---

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ è®¤è¯ä¸­é—´ä»¶ï¼šè¯·æ±‚æ‹¦æˆªå’Œèº«ä»½éªŒè¯çš„æ ¸å¿ƒæœºåˆ¶
ğŸ”¸ ç»Ÿä¸€è®¤è¯ä¸­å¿ƒï¼šå•ç‚¹ç™»å½•å’Œé›†ä¸­å¼èº«ä»½ç®¡ç†
ğŸ”¸ åˆ†å¸ƒå¼Sessionï¼šå¤šæœåŠ¡å™¨å…±äº«ç”¨æˆ·çŠ¶æ€
ğŸ”¸ è®¤è¯ç½‘å…³ï¼šå¾®æœåŠ¡æ¶æ„ä¸‹çš„ç»Ÿä¸€è®¤è¯å…¥å£
ğŸ”¸ æ€§èƒ½ä¼˜åŒ–ï¼šç¼“å­˜ã€å¼‚æ­¥å¤„ç†å’Œæ‰¹é‡æ“ä½œ
ğŸ”¸ æ•°æ®åº“è®¾è®¡ï¼šç”¨æˆ·ã€è§’è‰²ã€æƒé™è¡¨ç»“æ„å’Œç´¢å¼•ä¼˜åŒ–
ğŸ”¸ ç›‘æ§å‘Šè­¦ï¼šå®‰å…¨äº‹ä»¶æ£€æµ‹å’Œé£é™©é¢„è­¦
```

### 11.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ æ¶æ„è®¾è®¡æ€è·¯**
```
å®‰å…¨æ€§ä¼˜å…ˆï¼šæ‰€æœ‰è®¾è®¡ä»¥å®‰å…¨ä¸ºæ ¸å¿ƒ
æ€§èƒ½å…¼é¡¾ï¼šåœ¨ä¿è¯å®‰å…¨çš„å‰æä¸‹ä¼˜åŒ–æ€§èƒ½
å¯æ‰©å±•æ€§ï¼šæ”¯æŒæ°´å¹³æ‰©å±•å’ŒåŠŸèƒ½æ‰©å±•
ç›‘æ§å¯è§‚æµ‹ï¼šå…¨é¢çš„ç›‘æ§å’Œæ—¥å¿—è®°å½•
```

**ğŸ”¹ å®ç°æ–¹å¼é€‰æ‹©**
```
æ‹¦æˆªå™¨ï¼šé€‚ç”¨äºMVCæ¡†æ¶ï¼Œç²’åº¦ç»†
è¿‡æ»¤å™¨ï¼šé€‚ç”¨äºæ•´ä½“ç­–ç•¥ï¼Œè¦†ç›–é¢å¹¿  
è£…é¥°å™¨ï¼šé€‚ç”¨äºçµæ´»æ§åˆ¶ï¼ŒæŒ‰éœ€ä½¿ç”¨
JWT vs Sessionï¼šæ— çŠ¶æ€ vs æœ‰çŠ¶æ€çš„æƒè¡¡
ç¼“å­˜ç­–ç•¥ï¼šæœ¬åœ°ç¼“å­˜ + åˆ†å¸ƒå¼ç¼“å­˜çš„åˆ†å±‚è®¾è®¡
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–å…³é”®ç‚¹**
```
ç¼“å­˜å‘½ä¸­ç‡ï¼šåˆç†çš„ç¼“å­˜ç­–ç•¥å’Œè¿‡æœŸæ—¶é—´
å¼‚æ­¥å¤„ç†ï¼šéå…³é”®è·¯å¾„å¼‚æ­¥åŒ–ï¼Œæé«˜å“åº”é€Ÿåº¦
æ‰¹é‡æ“ä½œï¼šå‡å°‘æ•°æ®åº“è®¿é—®æ¬¡æ•°
è¿æ¥æ± ä¼˜åŒ–ï¼šåˆç†é…ç½®æ•°æ®åº“å’ŒRedisè¿æ¥æ± 
ç´¢å¼•ä¼˜åŒ–ï¼šé’ˆå¯¹æŸ¥è¯¢æ¨¡å¼è®¾è®¡åˆé€‚çš„ç´¢å¼•
```

### 11.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¸šåŠ¡åœºæ™¯é€‚ç”¨æ€§**

**ä¼ä¸šçº§åº”ç”¨**ï¼š
- Spring Security + Redis + æ•°æ®åº“åˆ†ç‰‡
- å®Œæ•´çš„RBACæƒé™ä½“ç³»
- è¯¦ç»†çš„å®¡è®¡æ—¥å¿—å’Œç›‘æ§å‘Šè­¦

**äº’è”ç½‘åº”ç”¨**ï¼š
- JWT + ç½‘å…³è®¤è¯ + å¤šçº§ç¼“å­˜
- é«˜å¹¶å‘å¤„ç†èƒ½åŠ›
- å¼¹æ€§æ‰©å®¹å’ŒæœåŠ¡é™çº§

**å¾®æœåŠ¡æ¶æ„**ï¼š
- ç»Ÿä¸€è®¤è¯ä¸­å¿ƒ + æœåŠ¡ç½‘æ ¼
- æœåŠ¡é—´è®¤è¯å’Œæˆæƒ
- åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª

**ç§»åŠ¨åº”ç”¨åç«¯**ï¼š
- JWT + Refresh Tokenæœºåˆ¶
- è®¾å¤‡æŒ‡çº¹å’Œè¡Œä¸ºåˆ†æ
- å¤šç«¯ç™»å½•çŠ¶æ€ç®¡ç†

### 11.4 å·¥ç¨‹å®è·µè¦ç‚¹


**ğŸ”§ å¼€å‘å»ºè®®**

**å®‰å…¨ç¬¬ä¸€**ï¼š
- æ°¸è¿œä¸è¦åœ¨å®¢æˆ·ç«¯å­˜å‚¨æ•æ„Ÿä¿¡æ¯
- ä½¿ç”¨å¼ºåŠ å¯†ç®—æ³•å’Œè¶³å¤Ÿé•¿çš„å¯†é’¥
- å®šæœŸæ›´æ–°ä¾èµ–åº“ï¼Œä¿®å¤å®‰å…¨æ¼æ´
- å®æ–½æœ€å°æƒé™åŸåˆ™

**æ€§èƒ½è€ƒè™‘**ï¼š
- åˆç†ä½¿ç”¨ç¼“å­˜ï¼Œä½†è¦æ³¨æ„æ•°æ®ä¸€è‡´æ€§
- å¼‚æ­¥å¤„ç†éå…³é”®ä¸šåŠ¡é€»è¾‘
- ç›‘æ§å…³é”®æŒ‡æ ‡ï¼ŒåŠæ—¶å‘ç°æ€§èƒ½ç“¶é¢ˆ
- é¢„ä¼°ç³»ç»Ÿå®¹é‡ï¼Œæå‰åšå¥½æ‰©å®¹å‡†å¤‡

**å¯ç»´æŠ¤æ€§**ï¼š
- ç»Ÿä¸€çš„è®¤è¯å’Œæˆæƒæ ‡å‡†
- æ¸…æ™°çš„é”™è¯¯ç å’Œæ—¥å¿—æ ¼å¼
- å®Œå–„çš„æ–‡æ¡£å’Œä»£ç æ³¨é‡Š
- è‡ªåŠ¨åŒ–æµ‹è¯•è¦†ç›–å…³é”®åœºæ™¯

**ğŸ”¹ å¸¸è§é—®é¢˜è§£å†³**

**Tokenå®‰å…¨**ï¼š
```
é—®é¢˜ï¼šJWT Tokenè¢«æˆªè·æ€ä¹ˆåŠï¼Ÿ
è§£å†³ï¼š
- è®¾ç½®è¾ƒçŸ­çš„è¿‡æœŸæ—¶é—´
- ä½¿ç”¨HTTPSåŠ å¯†ä¼ è¾“
- å®æ–½Refresh Tokenæœºåˆ¶
- ç›‘æ§å¼‚å¸¸Tokenä½¿ç”¨æ¨¡å¼
```

**ç¼“å­˜ä¸€è‡´æ€§**ï¼š
```
é—®é¢˜ï¼šç¼“å­˜å’Œæ•°æ®åº“æ•°æ®ä¸ä¸€è‡´
è§£å†³ï¼š
- ä½¿ç”¨äº‹ä»¶é©±åŠ¨æ›´æ–°ç¼“å­˜
- è®¾ç½®åˆç†çš„ç¼“å­˜è¿‡æœŸæ—¶é—´
- å®æ–½ç¼“å­˜é¢„çƒ­æœºåˆ¶
- æä¾›æ‰‹åŠ¨ç¼“å­˜åˆ·æ–°æ¥å£
```

**é«˜å¹¶å‘å¤„ç†**ï¼š
```
é—®é¢˜ï¼šè®¤è¯æœåŠ¡æˆä¸ºæ€§èƒ½ç“¶é¢ˆ
è§£å†³ï¼š
- å®æ–½å¤šçº§ç¼“å­˜ç­–ç•¥
- ä½¿ç”¨è¿æ¥æ± å’Œæ‰¹é‡å¤„ç†
- è€ƒè™‘ä½¿ç”¨æ— çŠ¶æ€JWT
- éƒ¨ç½²å¤šä¸ªè®¤è¯æœåŠ¡å®ä¾‹
```

### 11.5 æŠ€æœ¯æ¼”è¿›è¶‹åŠ¿


**ğŸš€ æœªæ¥å‘å±•æ–¹å‘**

**é›¶ä¿¡ä»»å®‰å…¨**ï¼š
- ä¸ä¿¡ä»»ç½‘ç»œè¾¹ç•Œï¼ŒéªŒè¯æ¯ä¸ªè¯·æ±‚
- åŸºäºèº«ä»½å’Œè®¾å¤‡çš„ç²¾ç»†åŒ–è®¿é—®æ§åˆ¶
- å®æ—¶é£é™©è¯„ä¼°å’ŒåŠ¨æ€æƒé™è°ƒæ•´

**ç”Ÿç‰©è¯†åˆ«è®¤è¯**ï¼š
- æŒ‡çº¹ã€äººè„¸ã€å£°çº¹ç­‰å¤šå› å­è®¤è¯
- è¾¹ç¼˜è®¡ç®—å’Œæœ¬åœ°åŒ–å¤„ç†
- éšç§ä¿æŠ¤å’Œæ•°æ®å®‰å…¨

**AIå®‰å…¨**ï¼š
- æ™ºèƒ½å¼‚å¸¸æ£€æµ‹å’Œå¨èƒè¯†åˆ«
- ç”¨æˆ·è¡Œä¸ºåˆ†æå’Œé£é™©å»ºæ¨¡
- è‡ªé€‚åº”å®‰å…¨ç­–ç•¥è°ƒæ•´

**äº‘åŸç”Ÿå®‰å…¨**ï¼š
- æœåŠ¡ç½‘æ ¼å®‰å…¨ç­–ç•¥
- å®¹å™¨å’ŒKuberneteså®‰å…¨
- æ— æœåŠ¡å™¨æ¶æ„å®‰å…¨

### 11.6 å­¦ä¹ è¿›é˜¶è·¯å¾„


**ğŸ—ºï¸ æ¨èå­¦ä¹ é¡ºåº**

**ğŸ“š åŸºç¡€é˜¶æ®µ** (1-2ä¸ªæœˆ)
```
è®¤è¯åŸºç¡€æ¦‚å¿µ â†’ ä¸­é—´ä»¶å®ç° â†’ JWTä½¿ç”¨ â†’ åŸºç¡€æƒé™æ§åˆ¶
```

**ğŸ“š è¿›é˜¶é˜¶æ®µ** (2-3ä¸ªæœˆ)
```
ç»Ÿä¸€è®¤è¯ä¸­å¿ƒ â†’ åˆ†å¸ƒå¼Session â†’ ç¼“å­˜ç­–ç•¥ â†’ æ€§èƒ½ä¼˜åŒ–
```

**ğŸ“š é«˜çº§é˜¶æ®µ** (3-4ä¸ªæœˆ)
```
å¾®æœåŠ¡è®¤è¯ â†’ å®‰å…¨ç›‘æ§ â†’ å¼‚æ­¥å¤„ç† â†’ æ¶æ„è®¾è®¡
```

**ğŸ“š ä¸“å®¶é˜¶æ®µ** (6ä¸ªæœˆä»¥ä¸Š)
```
é›¶ä¿¡ä»»æ¶æ„ â†’ AIå®‰å…¨åº”ç”¨ â†’ äº‘åŸç”Ÿå®‰å…¨ â†’ å®‰å…¨å’¨è¯¢
```

**ğŸ¯ å®è·µé¡¹ç›®å»ºè®®**

1. **ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ**ï¼šå®ç°å®Œæ•´çš„RBACæƒé™ä½“ç³»
2. **APIç½‘å…³**ï¼šæ„å»ºå¾®æœåŠ¡è®¤è¯ç½‘å…³
3. **å•ç‚¹ç™»å½•ç³»ç»Ÿ**ï¼šä¼ä¸šçº§SSOè§£å†³æ–¹æ¡ˆ  
4. **å®‰å…¨ç›‘æ§å¹³å°**ï¼šå®æ—¶å¨èƒæ£€æµ‹å’Œå‘Šè­¦
5. **ç§»åŠ¨åº”ç”¨åç«¯**ï¼šæ”¯æŒå¤šç«¯çš„è®¤è¯æœåŠ¡

---

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- è®¤è¯ä¸­é—´ä»¶æ˜¯å®‰å…¨çš„ç¬¬ä¸€é“é˜²çº¿ï¼Œé€‰æ‹©åˆé€‚çš„å®ç°æ¨¡å¼å¾ˆå…³é”®
- ç»Ÿä¸€è®¤è¯ä¸­å¿ƒè§£å†³å¤šç³»ç»Ÿç™»å½•é—®é¢˜ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
- åˆ†å¸ƒå¼Sessionå’ŒJWTå„æœ‰ä¼˜åŠ£ï¼Œæ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰æ‹©
- æ€§èƒ½ä¼˜åŒ–è¦ä»ç¼“å­˜ã€å¼‚æ­¥ã€æ‰¹å¤„ç†å¤šä¸ªç»´åº¦è€ƒè™‘
- ç›‘æ§å‘Šè­¦æ˜¯å®‰å…¨è¿ç»´çš„é‡è¦ä¿éšœï¼ŒåŠæ—©å‘ç°é—®é¢˜
- æŠ€æœ¯é€‰å‹è¦è€ƒè™‘å›¢é˜ŸæŠ€èƒ½ã€ä¸šåŠ¡è§„æ¨¡å’Œå‘å±•é˜¶æ®µ
- å®‰å…¨æ°¸è¿œæ˜¯ç¬¬ä¸€ä½çš„ï¼Œä¸è¦ä¸ºäº†æ€§èƒ½ç‰ºç‰²å®‰å…¨æ€§

ğŸ§  **è®°å¿†å£è¯€**: "ä¸­é—´ä»¶æ‹¦æˆªï¼Œä¸­å¿ƒç»Ÿä¸€ç®¡ï¼Œåˆ†å¸ƒå¼å…±äº«ï¼Œç½‘å…³åšè®¤è¯ï¼Œä¼˜åŒ–ææ€§èƒ½ï¼Œç›‘æ§ä¿å®‰å…¨"