---
title: 12ã€SpringSecurityæ•´åˆOAuth2
---
## ğŸ“š ç›®å½•

1. [Spring Security OAuth2 Clientæ¦‚è¿°](#1-Spring-Security-OAuth2-Clientæ¦‚è¿°)
2. [æ¥å…¥ç¬¬ä¸‰æ–¹å¹³å°GitHubç™»å½•](#2-æ¥å…¥ç¬¬ä¸‰æ–¹å¹³å°GitHubç™»å½•)
3. [ç™»å½•åçš„ç”¨æˆ·æ•°æ®ç»‘å®šæµç¨‹](#3-ç™»å½•åçš„ç”¨æˆ·æ•°æ®ç»‘å®šæµç¨‹)
4. [ç”¨æˆ·ä¿¡æ¯åŒæ­¥ä¸æœ¬åœ°è´¦å·ç­–ç•¥](#4-ç”¨æˆ·ä¿¡æ¯åŒæ­¥ä¸æœ¬åœ°è´¦å·ç­–ç•¥)
5. [å®æˆ˜æ¡ˆä¾‹å®Œæ•´æ¼”ç¤º](#5-å®æˆ˜æ¡ˆä¾‹å®Œæ•´æ¼”ç¤º)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” Spring Security OAuth2 Clientæ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯OAuth2 Client


**ğŸ”¸ é€šä¿—ç†è§£**
```
æƒ³è±¡ä½ è¦å»ä¸€ä¸ªé«˜æ¡£é¤å…åƒé¥­ï¼š
- ä½ æ²¡æœ‰ä¼šå‘˜å¡ï¼Œä½†æœ‰æœ‹å‹çš„æ¨èä¿¡
- é¤å…ä¿¡ä»»ä½ æœ‹å‹ï¼Œæ‰€ä»¥ä¹Ÿä¿¡ä»»ä½ 
- ä½ ä¸éœ€è¦åŠæ–°å¡ï¼Œç”¨æœ‹å‹çš„ä¿¡èª‰å°±èƒ½è¿›å»

OAuth2 Clientå°±åƒè¿™ä¸ªè¿‡ç¨‹ï¼š
- ä½ çš„åº”ç”¨ = ä½ è‡ªå·±
- ç¬¬ä¸‰æ–¹å¹³å°(GitHub) = ä½ çš„æœ‹å‹  
- ç”¨æˆ· = é¤å…è¦éªŒè¯çš„äºº
- é€šè¿‡ç¬¬ä¸‰æ–¹èº«ä»½éªŒè¯ï¼Œå…å»é‡æ–°æ³¨å†Œçš„éº»çƒ¦
```

**ğŸ”¸ æ ¸å¿ƒä½œç”¨**
Spring Security OAuth2 Clientæ˜¯Springæä¾›çš„OAuth2å®¢æˆ·ç«¯å®ç°ï¼Œå®ƒå¸®æˆ‘ä»¬ï¼š
- **ç®€åŒ–é›†æˆ**ï¼šå‡ è¡Œé…ç½®å°±èƒ½æ¥å…¥GitHubã€Googleç­‰å¹³å°
- **è‡ªåŠ¨å¤„ç†**ï¼šè‡ªåŠ¨å¤„ç†OAuth2çš„å¤æ‚æµç¨‹
- **å®‰å…¨ä¿éšœ**ï¼šå†…ç½®å®‰å…¨æœºåˆ¶ï¼Œé˜²æ­¢å¸¸è§æ”»å‡»
- **ç”¨æˆ·ä½“éªŒ**ï¼šç”¨æˆ·ä¸€é”®ç™»å½•ï¼Œæ— éœ€è®°ä½æ–°å¯†ç 

### 1.2 OAuth2ç™»å½•æµç¨‹ç®€åŒ–ç†è§£


```
ç”¨æˆ·æ“ä½œæµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1.ç‚¹å‡»ç™»å½•  â”‚â”€â”€â”€>â”‚ 2.è·³è½¬GitHub â”‚â”€â”€â”€>â”‚ 3.æˆæƒç¡®è®¤  â”‚
â”‚   æˆ‘ä»¬ç½‘ç«™   â”‚    â”‚   æˆæƒé¡µé¢   â”‚    â”‚  åŒæ„ç™»å½•   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚ 6.ç™»å½•æˆåŠŸ  â”‚<â”€â”€â”€â”‚ 5.è·å–ç”¨æˆ·  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  è¿”å›ç½‘ç«™   â”‚    â”‚   ä¿¡æ¯æ•°æ®   â”‚    4.è¿”å›æˆæƒç 
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç†è§£**ï¼š
- ç”¨æˆ·çš„GitHubå¯†ç **ä»ä¸ç»è¿‡æˆ‘ä»¬çš„ç³»ç»Ÿ**
- æˆ‘ä»¬åªè·å¾—GitHubç»™çš„"é€šè¡Œè¯"(Token)
- é€šè¿‡è¿™ä¸ªé€šè¡Œè¯ï¼Œæˆ‘ä»¬å¯ä»¥è·å–ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯

### 1.3 ä¸ºä»€ä¹ˆè¦ç”¨OAuth2 Client


**ğŸ¯ è§£å†³çš„æ ¸å¿ƒé—®é¢˜**
```
ä¼ ç»Ÿæ³¨å†Œç™»å½•çš„ç—›ç‚¹ï¼š
âŒ ç”¨æˆ·éœ€è¦è®°ä½åˆä¸€ä¸ªå¯†ç 
âŒ æˆ‘ä»¬éœ€è¦å­˜å‚¨å’Œä¿æŠ¤å¯†ç 
âŒ ç”¨æˆ·æ‹…å¿ƒä¿¡æ¯å®‰å…¨
âŒ æ³¨å†Œæµç¨‹ç¹çï¼Œç”¨æˆ·æµå¤±

OAuth2ç™»å½•çš„ä¼˜åŠ¿ï¼š
âœ… ç”¨æˆ·æ— éœ€æ–°å¯†ç ï¼Œé™ä½é—¨æ§›
âœ… æˆ‘ä»¬æ— éœ€å­˜å‚¨å¯†ç ï¼Œé™ä½é£é™©
âœ… å€Ÿç”¨å¤§å¹³å°çš„ä¿¡èª‰ï¼Œå¢åŠ ä¿¡ä»»
âœ… ä¸€é”®ç™»å½•ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
```

---

## 2. ğŸ™ æ¥å…¥ç¬¬ä¸‰æ–¹å¹³å°GitHubç™»å½•


### 2.1 GitHubåº”ç”¨æ³¨å†Œå‡†å¤‡


**ğŸ”¸ åœ¨GitHubä¸Šåˆ›å»ºOAuth App**

ç¬¬ä¸€æ­¥ï¼šç™»å½•GitHubï¼Œè¿›å…¥è®¾ç½®
```
1. è®¿é—® GitHub.com -> Settings -> Developer settings
2. é€‰æ‹© OAuth Apps -> New OAuth App
3. å¡«å†™åº”ç”¨ä¿¡æ¯ï¼š
   - Application name: æˆ‘çš„ç½‘ç«™
   - Homepage URL: http://localhost:8080  
   - Authorization callback URL: http://localhost:8080/login/oauth2/code/github
```

**ğŸ”¸ è·å–é‡è¦é…ç½®ä¿¡æ¯**
```
æ³¨å†ŒæˆåŠŸåï¼ŒGitHubä¼šç»™ä½ ï¼š
- Client ID: å°±åƒä½ çš„åº”ç”¨èº«ä»½è¯å·
- Client Secret: å°±åƒä½ çš„åº”ç”¨å¯†ç ï¼ˆè¦ä¿å¯†ï¼ï¼‰

æ¯”å¦‚ï¼š
Client ID: 1a2b3c4d5e6f7g8h
Client Secret: a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0
```

### 2.2 Spring Booté¡¹ç›®é…ç½®


**ğŸ”¸ æ·»åŠ ä¾èµ–**
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-oauth2-client</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-security</artifactId>
</dependency>
```

**ğŸ”¸ æ ¸å¿ƒé…ç½®æ–‡ä»¶**
```yaml
# application.yml
spring:
  security:
    oauth2:
      client:
        registration:
          github:  # è¿™ä¸ªåå­—å¯ä»¥è‡ªå®šä¹‰ï¼Œä½†è¦å’Œå›è°ƒURLå¯¹åº”
            client-id: ${GITHUB_CLIENT_ID:ä½ çš„Client ID}
            client-secret: ${GITHUB_CLIENT_SECRET:ä½ çš„Client Secret}
            scope:
              - user:email  # è¯·æ±‚è·å–ç”¨æˆ·é‚®ç®±æƒé™
              - read:user   # è¯·æ±‚è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯æƒé™
```

**é…ç½®è¯´æ˜**ï¼š
- `registration.github`ï¼šæ³¨å†Œä¸€ä¸ªåä¸ºgithubçš„OAuth2å®¢æˆ·ç«¯
- `client-id/client-secret`ï¼šGitHubç»™çš„èº«ä»½å‡­è¯
- `scope`ï¼šè¯·æ±‚çš„æƒé™èŒƒå›´ï¼Œè¿™é‡Œè¦ç”¨æˆ·é‚®ç®±å’ŒåŸºæœ¬ä¿¡æ¯

### 2.3 å®‰å…¨é…ç½®ç±»


**ğŸ”¸ é…ç½®OAuth2ç™»å½•**
```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/", "/login", "/error").permitAll()  // å…¬å¼€é¡µé¢
                .anyRequest().authenticated()  // å…¶ä»–é¡µé¢éœ€è¦ç™»å½•
            )
            .oauth2Login(oauth2 -> oauth2
                .loginPage("/login")  // è‡ªå®šä¹‰ç™»å½•é¡µé¢
                .defaultSuccessUrl("/dashboard", true)  // ç™»å½•æˆåŠŸåè·³è½¬
                .userInfoEndpoint(userInfo -> userInfo
                    .userService(customOAuth2UserService())  // è‡ªå®šä¹‰ç”¨æˆ·æœåŠ¡
                )
            );
        return http.build();
    }
    
    @Bean
    public OAuth2UserService<OAuth2UserRequest, OAuth2User> customOAuth2UserService() {
        return new CustomOAuth2UserService();
    }
}
```

**ğŸ”¸ è‡ªå®šä¹‰ç™»å½•é¡µé¢**
```html
<!-- /templates/login.html -->
<!DOCTYPE html>
<html>
<head>
    <title>ç™»å½•é¡µé¢</title>
    <style>
        .login-btn {
            background: #333;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            text-decoration: none;
            display: inline-block;
        }
    </style>
</head>
<body>
    <h2>æ¬¢è¿ç™»å½•æˆ‘çš„ç½‘ç«™</h2>
    
    <!-- è¿™ä¸ªé“¾æ¥ä¼šè§¦å‘GitHub OAuth2ç™»å½• -->
    <a href="/oauth2/authorization/github" class="login-btn">
        ğŸ™ ä½¿ç”¨ GitHub è´¦å·ç™»å½•
    </a>
</body>
</html>
```

### 2.4 ç†è§£OAuth2ç™»å½•é“¾æ¥


**ğŸ”¸ ç¥å¥‡çš„ç™»å½•é“¾æ¥**
```
/oauth2/authorization/github
â”‚                      â”‚
â”‚                      â””â”€â”€ å¯¹åº”é…ç½®ä¸­çš„ registration.github
â””â”€â”€ Spring Securityå›ºå®šçš„OAuth2ç«¯ç‚¹

ç‚¹å‡»è¿™ä¸ªé“¾æ¥åå‘ç”Ÿçš„äº‹ï¼š
1. Spring Securityæ„é€ GitHubæˆæƒURL
2. æµè§ˆå™¨è·³è½¬åˆ°GitHubæˆæƒé¡µé¢
3. ç”¨æˆ·ç¡®è®¤æˆæƒåï¼ŒGitHubå›è°ƒæˆ‘ä»¬çš„åº”ç”¨  
4. Spring Securityè‡ªåŠ¨å¤„ç†å›è°ƒï¼Œè·å–ç”¨æˆ·ä¿¡æ¯
5. ç™»å½•å®Œæˆï¼Œè·³è½¬åˆ° defaultSuccessUrl
```

---

## 3. ğŸ”„ ç™»å½•åçš„ç”¨æˆ·æ•°æ®ç»‘å®šæµç¨‹


### 3.1 OAuth2Userå¯¹è±¡ç†è§£


**ğŸ”¸ GitHubè¿”å›çš„ç”¨æˆ·æ•°æ®ç»“æ„**
```java
// GitHub OAuth2ç™»å½•æˆåŠŸåï¼Œæˆ‘ä»¬æ‹¿åˆ°çš„ç”¨æˆ·å¯¹è±¡å¤§æ¦‚é•¿è¿™æ ·ï¼š
{
    "id": 12345678,
    "login": "zhangsan",
    "name": "å¼ ä¸‰",
    "email": "zhangsan@email.com", 
    "avatar_url": "https://avatars.githubusercontent.com/u/12345678",
    "bio": "ä¸€ä¸ªçƒ­çˆ±ç¼–ç¨‹çš„å¼€å‘è€…",
    "location": "åŒ—äº¬"
}
```

**ğŸ”¸ åœ¨ä»£ç ä¸­è®¿é—®ç”¨æˆ·ä¿¡æ¯**
```java
@Controller
public class UserController {
    
    @GetMapping("/dashboard") 
    public String dashboard(OAuth2AuthenticationToken token, Model model) {
        // è·å–OAuth2ç”¨æˆ·å¯¹è±¡
        OAuth2User oauth2User = token.getPrincipal();
        
        // æå–ç”¨æˆ·ä¿¡æ¯
        String githubId = oauth2User.getAttribute("id").toString();
        String username = oauth2User.getAttribute("login");
        String name = oauth2User.getAttribute("name");
        String email = oauth2User.getAttribute("email");
        String avatar = oauth2User.getAttribute("avatar_url");
        
        // ä¼ é€’ç»™å‰ç«¯é¡µé¢
        model.addAttribute("username", username);
        model.addAttribute("name", name);
        model.addAttribute("email", email);
        model.addAttribute("avatar", avatar);
        
        return "dashboard";
    }
}
```

### 3.2 è‡ªå®šä¹‰ç”¨æˆ·æœåŠ¡å¤„ç†


**ğŸ”¸ ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰ç”¨æˆ·æœåŠ¡**
```
é»˜è®¤æƒ…å†µä¸‹ï¼š
- Spring Securityåªæ˜¯ç®€å•åœ°ä¿å­˜GitHubè¿”å›çš„ç”¨æˆ·ä¿¡æ¯
- æ¯æ¬¡ç™»å½•éƒ½é‡æ–°è·å–ï¼Œä¸ä¼šæŒä¹…åŒ–åˆ°æˆ‘ä»¬çš„æ•°æ®åº“
- æ— æ³•å’Œæˆ‘ä»¬è‡ªå·±çš„ç”¨æˆ·ç³»ç»Ÿé›†æˆ

è‡ªå®šä¹‰ç”¨æˆ·æœåŠ¡çš„ä½œç”¨ï¼š
âœ… å°†OAuth2ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ°æˆ‘ä»¬çš„æ•°æ®åº“
âœ… å®ç°ç”¨æˆ·ä¿¡æ¯çš„æœ¬åœ°åŒ–ç®¡ç†
âœ… æ”¯æŒç”¨æˆ·ä¿¡æ¯çš„è¡¥å……å’Œæ›´æ–°
âœ… é›†æˆæˆ‘ä»¬è‡ªå·±çš„æƒé™ç³»ç»Ÿ
```

**ğŸ”¸ åˆ›å»ºæœ¬åœ°ç”¨æˆ·å®ä½“**
```java
@Entity
@Table(name = "users")
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String githubId;        // GitHubç”¨æˆ·ID
    private String username;        // GitHubç”¨æˆ·å
    private String email;           // é‚®ç®±
    private String name;            // æ˜¾ç¤ºåç§°
    private String avatarUrl;       // å¤´åƒURL
    
    private LocalDateTime createdAt;    // é¦–æ¬¡ç™»å½•æ—¶é—´
    private LocalDateTime updatedAt;    // æœ€åæ›´æ–°æ—¶é—´
    
    // getter/setter çœç•¥...
}
```

**ğŸ”¸ è‡ªå®šä¹‰OAuth2ç”¨æˆ·æœåŠ¡**
```java
@Service
public class CustomOAuth2UserService implements OAuth2UserService<OAuth2UserRequest, OAuth2User> {
    
    @Autowired
    private UserRepository userRepository;
    
    private final OAuth2UserService<OAuth2UserRequest, OAuth2User> delegate = 
            new DefaultOAuth2UserService();
    
    @Override
    public OAuth2User loadUser(OAuth2UserRequest userRequest) throws OAuth2AuthenticationException {
        // 1. å…ˆè·å–GitHubçš„ç”¨æˆ·ä¿¡æ¯
        OAuth2User oauth2User = delegate.loadUser(userRequest);
        
        // 2. æå–å…³é”®ä¿¡æ¯
        String githubId = oauth2User.getAttribute("id").toString();
        String username = oauth2User.getAttribute("login");
        String email = oauth2User.getAttribute("email");
        String name = oauth2User.getAttribute("name");
        String avatarUrl = oauth2User.getAttribute("avatar_url");
        
        // 3. æŸ¥æ‰¾æˆ–åˆ›å»ºæœ¬åœ°ç”¨æˆ·
        User localUser = userRepository.findByGithubId(githubId)
                .orElseGet(() -> createNewUser(githubId, username, email, name, avatarUrl));
        
        // 4. æ›´æ–°ç”¨æˆ·ä¿¡æ¯ï¼ˆGitHubä¿¡æ¯å¯èƒ½ä¼šå˜åŒ–ï¼‰
        updateUserInfo(localUser, username, email, name, avatarUrl);
        
        // 5. è¿”å›åŒ…è£…åçš„ç”¨æˆ·å¯¹è±¡
        return new CustomOAuth2User(oauth2User, localUser);
    }
    
    private User createNewUser(String githubId, String username, String email, String name, String avatarUrl) {
        User user = new User();
        user.setGithubId(githubId);
        user.setUsername(username);
        user.setEmail(email);
        user.setName(name);
        user.setAvatarUrl(avatarUrl);
        user.setCreatedAt(LocalDateTime.now());
        user.setUpdatedAt(LocalDateTime.now());
        
        return userRepository.save(user);
    }
    
    private void updateUserInfo(User user, String username, String email, String name, String avatarUrl) {
        // æ›´æ–°å¯èƒ½å˜åŒ–çš„ä¿¡æ¯
        user.setUsername(username);
        user.setEmail(email);
        user.setName(name);
        user.setAvatarUrl(avatarUrl);
        user.setUpdatedAt(LocalDateTime.now());
        
        userRepository.save(user);
    }
}
```

### 3.3 è‡ªå®šä¹‰OAuth2UseråŒ…è£…ç±»


**ğŸ”¸ ä¸ºä»€ä¹ˆéœ€è¦åŒ…è£…ç±»**
```
åŸå§‹çš„OAuth2UseråªåŒ…å«GitHubçš„ä¿¡æ¯ï¼Œä½†æˆ‘ä»¬éœ€è¦ï¼š
- è®¿é—®æˆ‘ä»¬æ•°æ®åº“ä¸­çš„ç”¨æˆ·ID
- è·å–ç”¨æˆ·çš„è§’è‰²æƒé™ä¿¡æ¯
- æ”¯æŒSpring Securityçš„æƒé™æ£€æŸ¥
```

**ğŸ”¸ åˆ›å»ºåŒ…è£…ç±»**
```java
public class CustomOAuth2User implements OAuth2User {
    
    private OAuth2User oauth2User;  // åŸå§‹çš„GitHubç”¨æˆ·ä¿¡æ¯
    private User localUser;         // æˆ‘ä»¬æ•°æ®åº“ä¸­çš„ç”¨æˆ·ä¿¡æ¯
    
    public CustomOAuth2User(OAuth2User oauth2User, User localUser) {
        this.oauth2User = oauth2User;
        this.localUser = localUser;
    }
    
    @Override
    public Map<String, Object> getAttributes() {
        return oauth2User.getAttributes();
    }
    
    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() {
        // è¿™é‡Œå¯ä»¥æ ¹æ®æœ¬åœ°ç”¨æˆ·ä¿¡æ¯è®¾ç½®æƒé™
        return Collections.singletonList(new SimpleGrantedAuthority("ROLE_USER"));
    }
    
    @Override
    public String getName() {
        return oauth2User.getAttribute("login");  // è¿”å›GitHubç”¨æˆ·å
    }
    
    // æä¾›è®¿é—®æœ¬åœ°ç”¨æˆ·ä¿¡æ¯çš„æ–¹æ³•
    public Long getUserId() {
        return localUser.getId();
    }
    
    public String getEmail() {
        return localUser.getEmail();
    }
    
    public String getDisplayName() {
        return localUser.getName();
    }
}
```

---

## 4. ğŸ”„ ç”¨æˆ·ä¿¡æ¯åŒæ­¥ä¸æœ¬åœ°è´¦å·ç­–ç•¥


### 4.1 ç”¨æˆ·ä¿¡æ¯åŒæ­¥ç­–ç•¥


**ğŸ”¸ åŒæ­¥æ—¶æœºé€‰æ‹©**
```
é¦–æ¬¡ç™»å½•æ—¶ï¼š
âœ… åˆ›å»ºæœ¬åœ°ç”¨æˆ·è®°å½•
âœ… ä¿å­˜GitHubåŸºæœ¬ä¿¡æ¯
âœ… è®¾ç½®é»˜è®¤è§’è‰²æƒé™

æ¯æ¬¡ç™»å½•æ—¶ï¼š
âœ… æ›´æ–°å¯èƒ½å˜åŒ–çš„ä¿¡æ¯ï¼ˆç”¨æˆ·åã€é‚®ç®±ã€å¤´åƒç­‰ï¼‰
âœ… æ›´æ–°æœ€åç™»å½•æ—¶é—´
âŒ ä¸è¦æ¯æ¬¡éƒ½å®Œå…¨è¦†ç›–ï¼ˆç”¨æˆ·å¯èƒ½åœ¨æˆ‘ä»¬ç³»ç»Ÿä¸­æœ‰è‡ªå®šä¹‰è®¾ç½®ï¼‰

å®šæœŸæ‰¹é‡åŒæ­¥ï¼š
âœ… å¯ä»¥è€ƒè™‘å®šæ—¶ä»»åŠ¡ï¼Œæ‰¹é‡æ›´æ–°æ´»è·ƒç”¨æˆ·çš„ä¿¡æ¯
âŒ ä¸å»ºè®®é¢‘ç¹è°ƒç”¨GitHub APIï¼ˆæœ‰é™åˆ¶ï¼‰
```

**ğŸ”¸ ä¿¡æ¯åŒæ­¥ç­–ç•¥ä»£ç **
```java
@Service
public class UserSyncService {
    
    public void syncUserInfo(User localUser, OAuth2User githubUser) {
        boolean needUpdate = false;
        
        // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å˜åŒ–
        String newUsername = githubUser.getAttribute("login");
        if (!Objects.equals(localUser.getUsername(), newUsername)) {
            localUser.setUsername(newUsername);
            needUpdate = true;
        }
        
        // æ£€æŸ¥é‚®ç®±æ˜¯å¦å˜åŒ–
        String newEmail = githubUser.getAttribute("email");
        if (!Objects.equals(localUser.getEmail(), newEmail)) {
            localUser.setEmail(newEmail);
            needUpdate = true;
        }
        
        // æ£€æŸ¥å¤´åƒæ˜¯å¦å˜åŒ–
        String newAvatarUrl = githubUser.getAttribute("avatar_url");
        if (!Objects.equals(localUser.getAvatarUrl(), newAvatarUrl)) {
            localUser.setAvatarUrl(newAvatarUrl);
            needUpdate = true;
        }
        
        // åªæœ‰ä¿¡æ¯çœŸçš„å˜åŒ–äº†æ‰ä¿å­˜
        if (needUpdate) {
            localUser.setUpdatedAt(LocalDateTime.now());
            userRepository.save(localUser);
        }
        
        // æ— è®ºæ˜¯å¦æ›´æ–°ï¼Œéƒ½è®°å½•æœ€åç™»å½•æ—¶é—´
        localUser.setLastLoginAt(LocalDateTime.now());
        userRepository.save(localUser);
    }
}
```

### 4.2 æœ¬åœ°è´¦å·å…³è”ç­–ç•¥


**ğŸ”¸ å¤„ç†è´¦å·å…³è”çš„å‡ ç§æƒ…å†µ**

```
æƒ…å†µ1ï¼šæ–°ç”¨æˆ·é¦–æ¬¡GitHubç™»å½•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   GitHub    â”‚â”€â”€â”€>â”‚   åˆ›å»ºæ–°    â”‚â”€â”€â”€>â”‚  è®¾ç½®é»˜è®¤   â”‚
â”‚   ç™»å½•      â”‚    â”‚  æœ¬åœ°è´¦æˆ·   â”‚    â”‚   æƒé™      â”‚  
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æƒ…å†µ2ï¼šå·²æœ‰GitHubè´¦æˆ·å†æ¬¡ç™»å½•  
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   GitHub    â”‚â”€â”€â”€>â”‚   æ‰¾åˆ°å·²æœ‰  â”‚â”€â”€â”€>â”‚  æ›´æ–°ä¿¡æ¯   â”‚
â”‚   ç™»å½•      â”‚    â”‚  æœ¬åœ°è´¦æˆ·   â”‚    â”‚  è®°å½•ç™»å½•   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æƒ…å†µ3ï¼šç”¨æˆ·æœ‰ä¼ ç»Ÿè´¦æˆ·ï¼Œæƒ³ç»‘å®šGitHubï¼ˆéœ€è¦é¢å¤–å®ç°ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¼ ç»Ÿç™»å½•   â”‚â”€â”€â”€>â”‚  ä¸ªäººä¸­å¿ƒ   â”‚â”€â”€â”€>â”‚ ç»‘å®šGitHub  â”‚
â”‚   çŠ¶æ€ä¸‹    â”‚    â”‚  ç»‘å®šåŠŸèƒ½   â”‚    â”‚   è´¦æˆ·      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”¸ é‚®ç®±é‡å¤å¤„ç†ç­–ç•¥**
```java
@Service
public class UserAccountService {
    
    public User handleGithubLogin(String githubId, String email, String username) {
        // å…ˆé€šè¿‡GitHub IDæŸ¥æ‰¾
        Optional<User> existingByGithubId = userRepository.findByGithubId(githubId);
        if (existingByGithubId.isPresent()) {
            return existingByGithubId.get();  // GitHubè´¦æˆ·å·²å­˜åœ¨ï¼Œç›´æ¥è¿”å›
        }
        
        // æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²è¢«å…¶ä»–è´¦æˆ·ä½¿ç”¨
        Optional<User> existingByEmail = userRepository.findByEmail(email);
        if (existingByEmail.isPresent()) {
            User existingUser = existingByEmail.get();
            
            if (existingUser.getGithubId() == null) {
                // æƒ…å†µï¼šç”¨æˆ·ä¹‹å‰ç”¨ä¼ ç»Ÿæ–¹å¼æ³¨å†Œï¼Œç°åœ¨æƒ³ç”¨GitHubç™»å½•
                existingUser.setGithubId(githubId);  // ç»‘å®šGitHub ID
                existingUser.setUsername(username);   // æ›´æ–°ç”¨æˆ·å
                return userRepository.save(existingUser);
            } else {
                // æƒ…å†µï¼šé‚®ç®±è¢«å…¶ä»–GitHubè´¦æˆ·å ç”¨ï¼ˆç†è®ºä¸Šä¸åº”è¯¥å‘ç”Ÿï¼‰
                throw new RuntimeException("è¯¥é‚®ç®±å·²è¢«å…¶ä»–GitHubè´¦æˆ·ä½¿ç”¨");
            }
        }
        
        // åˆ›å»ºå…¨æ–°çš„è´¦æˆ·
        return createNewGithubUser(githubId, email, username);
    }
}
```

### 4.3 æƒé™è§’è‰²ç®¡ç†


**ğŸ”¸ åŸºäºOAuth2çš„æƒé™è®¾è®¡**
```java
@Entity
public class User {
    // ... å…¶ä»–å­—æ®µ
    
    @Enumerated(EnumType.STRING)
    private UserRole role = UserRole.USER;  // é»˜è®¤è§’è‰²
    
    private boolean enabled = true;         // è´¦æˆ·æ˜¯å¦å¯ç”¨
    private boolean verified = false;       // é‚®ç®±æ˜¯å¦éªŒè¯ï¼ˆGitHubç™»å½•å¯é»˜è®¤ä¸ºtrueï¼‰
}

public enum UserRole {
    USER("æ™®é€šç”¨æˆ·"),
    ADMIN("ç®¡ç†å‘˜"),
    MODERATOR("ç‰ˆä¸»");
    
    private String description;
    
    UserRole(String description) {
        this.description = description;
    }
}
```

**ğŸ”¸ åœ¨Securityé…ç½®ä¸­ä½¿ç”¨è§’è‰²**
```java
@Service
public class CustomOAuth2UserService implements OAuth2UserService<OAuth2UserRequest, OAuth2User> {
    
    @Override
    public OAuth2User loadUser(OAuth2UserRequest userRequest) throws OAuth2AuthenticationException {
        OAuth2User oauth2User = delegate.loadUser(userRequest);
        
        // è·å–æˆ–åˆ›å»ºç”¨æˆ·
        User localUser = getOrCreateUser(oauth2User);
        
        // æ„å»ºæƒé™åˆ—è¡¨
        List<GrantedAuthority> authorities = new ArrayList<>();
        authorities.add(new SimpleGrantedAuthority("ROLE_" + localUser.getRole().name()));
        
        // ç‰¹æ®Šæƒé™åˆ¤æ–­
        if (localUser.isVerified()) {
            authorities.add(new SimpleGrantedAuthority("VERIFIED_USER"));
        }
        
        return new CustomOAuth2User(oauth2User, localUser, authorities);
    }
}
```

---

## 5. ğŸ› ï¸ å®æˆ˜æ¡ˆä¾‹å®Œæ•´æ¼”ç¤º


### 5.1 å®Œæ•´é¡¹ç›®ç»“æ„


```
src/main/java/
â”œâ”€â”€ config/
â”‚   â””â”€â”€ SecurityConfig.java          # å®‰å…¨é…ç½®
â”œâ”€â”€ controller/
â”‚   â”œâ”€â”€ AuthController.java          # è®¤è¯ç›¸å…³æ§åˆ¶å™¨
â”‚   â””â”€â”€ UserController.java          # ç”¨æˆ·ä¿¡æ¯æ§åˆ¶å™¨
â”œâ”€â”€ entity/
â”‚   â””â”€â”€ User.java                    # ç”¨æˆ·å®ä½“
â”œâ”€â”€ repository/
â”‚   â””â”€â”€ UserRepository.java          # ç”¨æˆ·æ•°æ®è®¿é—®
â”œâ”€â”€ service/
â”‚   â”œâ”€â”€ CustomOAuth2UserService.java # è‡ªå®šä¹‰OAuth2æœåŠ¡
â”‚   â””â”€â”€ UserService.java             # ç”¨æˆ·ä¸šåŠ¡æœåŠ¡
â””â”€â”€ oauth2/
    â””â”€â”€ CustomOAuth2User.java        # è‡ªå®šä¹‰OAuth2ç”¨æˆ·
```

### 5.2 æ ¸å¿ƒæ§åˆ¶å™¨å®ç°


**ğŸ”¸ è®¤è¯æ§åˆ¶å™¨**
```java
@Controller
public class AuthController {
    
    @GetMapping("/login")
    public String loginPage() {
        return "login";  // è¿”å›ç™»å½•é¡µé¢
    }
    
    @GetMapping("/dashboard")
    public String dashboard(Authentication authentication, Model model) {
        if (authentication.getPrincipal() instanceof CustomOAuth2User) {
            CustomOAuth2User oauth2User = (CustomOAuth2User) authentication.getPrincipal();
            
            // ä¼ é€’ç”¨æˆ·ä¿¡æ¯åˆ°é¡µé¢
            model.addAttribute("userId", oauth2User.getUserId());
            model.addAttribute("username", oauth2User.getName());
            model.addAttribute("email", oauth2User.getEmail());
            model.addAttribute("displayName", oauth2User.getDisplayName());
        }
        
        return "dashboard";
    }
    
    @GetMapping("/profile")
    @PreAuthorize("hasRole('USER')")  // éœ€è¦ç™»å½•
    public String profile(Authentication authentication, Model model) {
        CustomOAuth2User oauth2User = (CustomOAuth2User) authentication.getPrincipal();
        
        // è·å–å®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯
        User user = userService.findById(oauth2User.getUserId());
        model.addAttribute("user", user);
        
        return "profile";
    }
}
```

### 5.3 å‰ç«¯é¡µé¢ç¤ºä¾‹


**ğŸ”¸ ç”¨æˆ·ä»ªè¡¨æ¿é¡µé¢**
```html
<!-- dashboard.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>ç”¨æˆ·ä»ªè¡¨æ¿</title>
    <style>
        .user-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            max-width: 400px;
            margin: 20px auto;
        }
        .avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <div class="user-card">
        <h2>æ¬¢è¿å›æ¥ï¼</h2>
        
        <div th:if="${username}">
            <h3 th:text="${displayName ?: username}">ç”¨æˆ·å</h3>
            <p><strong>GitHubç”¨æˆ·å:</strong> <span th:text="${username}"></span></p>
            <p><strong>é‚®ç®±:</strong> <span th:text="${email}"></span></p>
            <p><strong>ç”¨æˆ·ID:</strong> <span th:text="${userId}"></span></p>
        </div>
        
        <div>
            <a href="/profile">ä¸ªäººèµ„æ–™</a> |
            <a href="/logout">é€€å‡ºç™»å½•</a>
        </div>
    </div>
</body>
</html>
```

### 5.4 æµ‹è¯•ç™»å½•æµç¨‹


**ğŸ”¸ å¯åŠ¨åº”ç”¨æµ‹è¯•æ­¥éª¤**
```
1. å¯åŠ¨Spring Bootåº”ç”¨
2. è®¿é—® http://localhost:8080/login
3. ç‚¹å‡»"ä½¿ç”¨ GitHub è´¦å·ç™»å½•"
4. æµè§ˆå™¨è·³è½¬åˆ°GitHubæˆæƒé¡µé¢
5. ç¡®è®¤æˆæƒåï¼Œå›åˆ°æˆ‘ä»¬çš„åº”ç”¨
6. æŸ¥çœ‹ http://localhost:8080/dashboard
7. æ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦åˆ›å»ºäº†ç”¨æˆ·è®°å½•
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ OAuth2 Clientæœ¬è´¨ï¼šè®©ç”¨æˆ·é€šè¿‡ç¬¬ä¸‰æ–¹å¹³å°ç™»å½•æˆ‘ä»¬çš„åº”ç”¨
ğŸ”¸ Spring Securityé›†æˆï¼šå‡ è¡Œé…ç½®å°±èƒ½å®ç°GitHubç™»å½•
ğŸ”¸ ç”¨æˆ·æ•°æ®ç»‘å®šï¼šå°†ç¬¬ä¸‰æ–¹ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ°æˆ‘ä»¬çš„æ•°æ®åº“
ğŸ”¸ ä¿¡æ¯åŒæ­¥ç­–ç•¥ï¼šå¹³è¡¡æ•°æ®ä¸€è‡´æ€§å’Œç³»ç»Ÿæ€§èƒ½
ğŸ”¸ æƒé™è§’è‰²ç®¡ç†ï¼šåŸºäºOAuth2ç”¨æˆ·çš„æƒé™æ§åˆ¶
```

### 6.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ OAuth2ç™»å½•çš„å¥½å¤„**
```
ç”¨æˆ·è§’åº¦ï¼š
âœ… æ— éœ€è®°ä½æ–°å¯†ç 
âœ… å¿«é€Ÿä¸€é”®ç™»å½•
âœ… ä¿¡ä»»å¤§å¹³å°çš„å®‰å…¨æ€§

å¼€å‘è€…è§’åº¦ï¼š
âœ… æ— éœ€å¤„ç†å¯†ç å­˜å‚¨å’ŒåŠ å¯†
âœ… é™ä½å®‰å…¨é£é™©
âœ… æé«˜ç”¨æˆ·è½¬åŒ–ç‡
âœ… è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
```

**ğŸ”¹ æ•°æ®åŒæ­¥çš„å¹³è¡¡ç‚¹**
```
åŒæ­¥é¢‘ç‡ï¼š
- é¦–æ¬¡ç™»å½•ï¼šâœ… å¿…é¡»åŒæ­¥ï¼Œåˆ›å»ºæœ¬åœ°è´¦æˆ·
- æ¯æ¬¡ç™»å½•ï¼šâœ… åŒæ­¥åŸºæœ¬ä¿¡æ¯å˜åŒ–
- å®šæœŸåŒæ­¥ï¼šâ“ æ ¹æ®ä¸šåŠ¡éœ€æ±‚å†³å®š

åŒæ­¥å†…å®¹ï¼š
- åŸºæœ¬ä¿¡æ¯ï¼šâœ… ç”¨æˆ·åã€é‚®ç®±ã€å¤´åƒ
- æ‰©å±•ä¿¡æ¯ï¼šâ“ æ ¹æ®æƒé™èŒƒå›´å†³å®š
- æ•æ„Ÿä¿¡æ¯ï¼šâŒ ä¸è¦ä¿å­˜ä¸å¿…è¦çš„ä¿¡æ¯
```

**ğŸ”¹ å®‰å…¨æ³¨æ„äº‹é¡¹**
```
é…ç½®å®‰å…¨ï¼š
âœ… Client Secretè¦ä¿å¯†ï¼Œä¸è¦æäº¤åˆ°ä»£ç ä»“åº“
âœ… ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é…ç½®æœåŠ¡å™¨ç®¡ç†æ•æ„Ÿä¿¡æ¯
âœ… å›è°ƒURLè¦é…ç½®æ­£ç¡®ï¼Œé˜²æ­¢é‡å®šå‘æ”»å‡»

ç”¨æˆ·éšç§ï¼š
âœ… åªè¯·æ±‚å¿…è¦çš„æƒé™scope
âœ… æ˜ç¡®å‘ŠçŸ¥ç”¨æˆ·è·å–äº†å“ªäº›ä¿¡æ¯
âœ… æä¾›è´¦æˆ·è§£ç»‘åŠŸèƒ½
```

### 6.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ”¸ ä½•æ—¶ä½¿ç”¨OAuth2ç™»å½•**
```
é€‚ç”¨åœºæ™¯ï¼š
âœ… é¢å‘ä¸ªäººç”¨æˆ·çš„åº”ç”¨ï¼ˆåšå®¢ã€è®ºå›ã€å·¥å…·ç­‰ï¼‰
âœ… å¿«é€ŸåŸå‹å¼€å‘å’ŒMVPéªŒè¯
âœ… éœ€è¦è·å–ç”¨æˆ·ç¤¾äº¤ä¿¡æ¯çš„åº”ç”¨
âœ… å¸Œæœ›é™ä½æ³¨å†Œé—¨æ§›çš„åº”ç”¨

ä¸é€‚ç”¨åœºæ™¯ï¼š
âŒ ä¼ä¸šå†…éƒ¨ç³»ç»Ÿï¼ˆæ›´é€‚åˆLDAP/ADï¼‰
âŒ å¯¹ç”¨æˆ·èº«ä»½æœ‰ä¸¥æ ¼è¦æ±‚çš„ç³»ç»Ÿï¼ˆé“¶è¡Œã€æ”¿åºœï¼‰
âŒ å®Œå…¨ç¦»çº¿çš„åº”ç”¨
âŒ å¯¹ç¬¬ä¸‰æ–¹ä¾èµ–æ•æ„Ÿçš„ç³»ç»Ÿ
```

**ğŸ”¸ å¸¸è§é—®é¢˜è§£å†³**
```
é—®é¢˜1ï¼šç”¨æˆ·å–æ¶ˆæˆæƒæ€ä¹ˆåŠï¼Ÿ
è§£å†³ï¼šåœ¨GitHubå–æ¶ˆæˆæƒåï¼Œä¸‹æ¬¡ç™»å½•ä¼šé‡æ–°è¯·æ±‚æˆæƒ

é—®é¢˜2ï¼šGitHubæœåŠ¡ä¸å¯ç”¨æ€ä¹ˆåŠï¼Ÿ
è§£å†³ï¼šè€ƒè™‘æä¾›å¤‡ç”¨ç™»å½•æ–¹å¼ï¼ˆä¼ ç»Ÿç”¨æˆ·åå¯†ç ï¼‰

é—®é¢˜3ï¼šç”¨æˆ·ä¿¡æ¯æ›´æ–°ä¸åŠæ—¶ï¼Ÿ
è§£å†³ï¼šå¯ä»¥æä¾›æ‰‹åŠ¨åˆ·æ–°æŒ‰é’®ï¼Œæˆ–è°ƒæ•´åŒæ­¥ç­–ç•¥

é—®é¢˜4ï¼šå¦‚ä½•å¤„ç†ä¼ä¸šGitHubè´¦æˆ·ï¼Ÿ
è§£å†³ï¼šGitHub Appsæ”¯æŒç»„ç»‡æˆæƒï¼Œå¯ä»¥è·å–ç»„ç»‡ä¿¡æ¯
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- OAuth2 Clientè®©ç¬¬ä¸‰æ–¹ç™»å½•å˜ç®€å•
- ç”¨æˆ·æ•°æ®è¦æœ¬åœ°åŒ–ï¼Œä½†åŒæ­¥è¦é€‚åº¦
- å®‰å…¨é…ç½®æ˜¯åŸºç¡€ï¼Œç”¨æˆ·ä½“éªŒæ˜¯ç›®æ ‡
- æƒé™è§’è‰²è¦æ¸…æ™°ï¼Œæ‰©å±•æ¥å£è¦å‹å¥½