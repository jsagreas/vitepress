---
title: 10ã€SpringSecurityåŸºç¡€é…ç½®
---
## ğŸ“š ç›®å½•

1. [SpringSecurityæ¡†æ¶æ¦‚è¿°](#1-springsecurityæ¡†æ¶æ¦‚è¿°)
2. [æ ¸å¿ƒç»„ä»¶è¯¦è§£](#2-æ ¸å¿ƒç»„ä»¶è¯¦è§£)
3. [è‡ªå®šä¹‰è®¤è¯ç™»å½•é€»è¾‘](#3-è‡ªå®šä¹‰è®¤è¯ç™»å½•é€»è¾‘)
4. [æƒé™æ§åˆ¶æ³¨è§£è¯¦è§£](#4-æƒé™æ§åˆ¶æ³¨è§£è¯¦è§£)
5. [è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†](#5-è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†)
6. [SecurityConfigé…ç½®ç±»è¯¦è§£](#6-securityconfigé…ç½®ç±»è¯¦è§£)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” SpringSecurityæ¡†æ¶æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯SpringSecurity


**ç®€å•ç†è§£**ï¼šSpringSecurityå°±åƒæ˜¯ä½ å®¶çš„é—¨å«ç³»ç»Ÿï¼Œè´Ÿè´£æ£€æŸ¥è¿›å…¥ç³»ç»Ÿçš„æ¯ä¸ªäººæ˜¯å¦æœ‰æƒé™ã€‚

```
æƒ³è±¡ä¸€ä¸ªåŠå…¬æ¥¼çš„å®‰ä¿ç³»ç»Ÿï¼š
ğŸ¢ å¤§æ¥¼å…¥å£ â†’ SpringSecurityæ€»å…¥å£
ğŸ”‘ é—¨ç¦å¡   â†’ ç”¨æˆ·å‡­è¯(ç”¨æˆ·åå¯†ç /Token)
ğŸ‘® ä¿å®‰     â†’ è®¤è¯ç®¡ç†å™¨(AuthenticationManager)
ğŸ“‹ æƒé™è¡¨   â†’ æƒé™é…ç½®
ğŸšª å„æ¥¼å±‚   â†’ ä¸åŒçš„ç³»ç»Ÿèµ„æº
```

**æ ¸å¿ƒèŒè´£**ï¼š
- **ğŸ” è®¤è¯(Authentication)** - ç¡®è®¤"ä½ æ˜¯è°"
- **ğŸ›¡ï¸ æˆæƒ(Authorization)** - ç¡®è®¤"ä½ èƒ½åšä»€ä¹ˆ"
- **ğŸ”’ ä¼šè¯ç®¡ç†** - ç®¡ç†ç”¨æˆ·ç™»å½•çŠ¶æ€
- **ğŸ› ï¸ å®‰å…¨é…ç½®** - ç»Ÿä¸€çš„å®‰å…¨ç­–ç•¥

### 1.2 SpringSecurityå·¥ä½œæµç¨‹


```
ç”¨æˆ·è®¿é—®ç³»ç»Ÿçš„å®Œæ•´æµç¨‹ï¼š

ç”¨æˆ·è¯·æ±‚ â†’ å®‰å…¨è¿‡æ»¤å™¨é“¾ â†’ è®¤è¯ç®¡ç†å™¨ â†’ æƒé™æ£€æŸ¥ â†’ è®¿é—®èµ„æº
    â†“           â†“            â†“         â†“         â†“
  æµè§ˆå™¨      FilterChain   AuthManager  æˆæƒæ£€æŸ¥   Controller
    
è¯¦ç»†æ­¥éª¤ï¼š
â‘ ç”¨æˆ·å‘èµ·è¯·æ±‚(å¦‚è®¿é—®/adminé¡µé¢)
â‘¡SpringSecurityæ‹¦æˆªè¯·æ±‚
â‘¢æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
â‘£å¦‚æœæœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢
â‘¤ç”¨æˆ·è¾“å…¥è´¦å·å¯†ç 
â‘¥AuthenticationManageréªŒè¯èº«ä»½
â‘¦éªŒè¯æˆåŠŸåæ£€æŸ¥æ˜¯å¦æœ‰è®¿é—®æƒé™
â‘§æœ‰æƒé™åˆ™å…è®¸è®¿é—®ï¼Œæ— æƒé™åˆ™æ‹’ç»
```

### 1.3 ä¸ºä»€ä¹ˆè¦ç”¨SpringSecurity


**ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜**ï¼š
```java
// ä¼ ç»Ÿçš„æƒé™æ£€æŸ¥æ–¹å¼ - æ¯ä¸ªControlleréƒ½è¦å†™
@GetMapping("/admin")
public String admin(HttpSession session) {
    User user = (User) session.getAttribute("user");
    if (user == null) {
        return "redirect:/login";  // æœªç™»å½•
    }
    if (!"ADMIN".equals(user.getRole())) {
        return "access-denied";    // æ— æƒé™
    }
    return "admin";
}
```

**ä½¿ç”¨SpringSecurityå**ï¼š
```java
// åªéœ€è¦ä¸€ä¸ªæ³¨è§£å°±æå®š
@GetMapping("/admin")
@PreAuthorize("hasRole('ADMIN')")
public String admin() {
    return "admin";  // ä¸“æ³¨ä¸šåŠ¡é€»è¾‘
}
```

---

## 2. âš™ï¸ æ ¸å¿ƒç»„ä»¶è¯¦è§£


### 2.1 FilterChain - å®‰å…¨è¿‡æ»¤å™¨é“¾


**é€šä¿—ç†è§£**ï¼šè¿‡æ»¤å™¨é“¾å°±åƒæœºåœºçš„å®‰æ£€æµç¨‹ï¼Œæ¯ä¸ªç¯èŠ‚éƒ½æœ‰ç‰¹å®šçš„æ£€æŸ¥ä»»åŠ¡ã€‚

```
SpringSecurityè¿‡æ»¤å™¨é“¾ç¤ºæ„å›¾ï¼š

è¯·æ±‚è¿›å…¥ â†’ [è¿‡æ»¤å™¨1] â†’ [è¿‡æ»¤å™¨2] â†’ [è¿‡æ»¤å™¨3] â†’ ... â†’ ç›®æ ‡èµ„æº
           â†“          â†“          â†“
         ä¼šè¯æ£€æŸ¥    èº«ä»½è®¤è¯    æƒé™éªŒè¯
           
å®é™…è¿‡æ»¤å™¨é“¾ï¼š
SecurityContextPersistenceFilter  â† ç®¡ç†å®‰å…¨ä¸Šä¸‹æ–‡
UsernamePasswordAuthenticationFilter â† å¤„ç†ç™»å½•è¡¨å•
BasicAuthenticationFilter â† å¤„ç†HTTP Basicè®¤è¯
ExceptionTranslationFilter â† å¤„ç†å®‰å…¨å¼‚å¸¸
FilterSecurityInterceptor â† æœ€ç»ˆçš„æƒé™æ£€æŸ¥
```

**å…³é”®è¿‡æ»¤å™¨ä½œç”¨**ï¼š

| è¿‡æ»¤å™¨åç§° | **ä½œç”¨è¯´æ˜** | **é€šä¿—ç†è§£** |
|-----------|-------------|-------------|
| `SecurityContextPersistenceFilter` | ç®¡ç†ç”¨æˆ·çš„å®‰å…¨ä¸Šä¸‹æ–‡ | æœºåœºå…¥å£çš„èº«ä»½ç¡®è®¤ |
| `UsernamePasswordAuthenticationFilter` | å¤„ç†è¡¨å•ç™»å½• | æ£€æŸ¥ç™»æœºç‰Œå’Œèº«ä»½è¯ |
| `BasicAuthenticationFilter` | å¤„ç†HTTPåŸºæœ¬è®¤è¯ | ç®€å•çš„å£ä»¤éªŒè¯ |
| `FilterSecurityInterceptor` | æœ€ç»ˆæƒé™æ£€æŸ¥ | ç™»æœºå£çš„æœ€åæ£€æŸ¥ |

### 2.2 AuthenticationManager - è®¤è¯ç®¡ç†å™¨


**ç®€å•ç†è§£**ï¼šAuthenticationManagerå°±åƒæ˜¯å…¬å¸çš„äººäº‹éƒ¨é—¨ï¼Œä¸“é—¨è´Ÿè´£éªŒè¯å‘˜å·¥èº«ä»½ã€‚

```
è®¤è¯ç®¡ç†å™¨çš„å·¥ä½œæµç¨‹ï¼š

ç”¨æˆ·æäº¤å‡­è¯ â†’ AuthenticationManager â†’ AuthenticationProvider â†’ UserDetailsService
     â†“                â†“                      â†“                    â†“
 (ç”¨æˆ·å+å¯†ç )      (ç»Ÿä¸€å…¥å£)           (å…·ä½“éªŒè¯é€»è¾‘)         (è·å–ç”¨æˆ·ä¿¡æ¯)
     
å…·ä½“éªŒè¯è¿‡ç¨‹ï¼š
â‘ æ¥æ”¶ç”¨æˆ·æäº¤çš„ç”¨æˆ·åå’Œå¯†ç 
â‘¡è°ƒç”¨UserDetailsServiceæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
â‘¢æ¯”å¯¹å¯†ç æ˜¯å¦æ­£ç¡®
â‘£éªŒè¯ç”¨æˆ·è´¦å·çŠ¶æ€(æ˜¯å¦é”å®šã€è¿‡æœŸç­‰)
â‘¤è¿”å›è®¤è¯ç»“æœ
```

**æ ¸å¿ƒæ¥å£å…³ç³»**ï¼š
```java
// è®¤è¯ç®¡ç†å™¨æ¥å£
public interface AuthenticationManager {
    Authentication authenticate(Authentication authentication);
}

// ç”¨æˆ·è¯¦æƒ…æœåŠ¡æ¥å£  
public interface UserDetailsService {
    UserDetails loadUserByUsername(String username);
}
```

### 2.3 æ ¸å¿ƒç»„ä»¶åä½œå…³ç³»


```
ç»„ä»¶åä½œç¤ºæ„å›¾ï¼š

FilterChain â€”â€”â€”â€”â€”â€”â†’ AuthenticationManager
    â†“                        â†“
æ”¶åˆ°è¯·æ±‚å¹¶æ‹¦æˆª           å†³å®šå¦‚ä½•è®¤è¯ç”¨æˆ·
    â†“                        â†“
è°ƒç”¨è®¤è¯ç®¡ç†å™¨ â†â€”â€”â€”â€”â€”â€”â€” AuthenticationProvider
    â†“                        â†“
è·å–è®¤è¯ç»“æœ           è°ƒç”¨UserDetailsService
    â†“                        â†“
ç»§ç»­è¿‡æ»¤å™¨é“¾ â†â€”â€”â€”â€”â€”â€”â€” è¿”å›ç”¨æˆ·è¯¦ç»†ä¿¡æ¯

ç®€å•ç†è§£ï¼š
è¿‡æ»¤å™¨é“¾è´Ÿè´£"æ‹¦æˆª"ï¼Œè®¤è¯ç®¡ç†å™¨è´Ÿè´£"éªŒè¯"
```

---

## 3. ğŸ”‘ è‡ªå®šä¹‰è®¤è¯ç™»å½•é€»è¾‘


### 3.1 ä»€ä¹ˆæ˜¯è‡ªå®šä¹‰è®¤è¯


**é»˜è®¤è®¤è¯çš„å±€é™**ï¼š
- SpringSecurityé»˜è®¤ä½¿ç”¨å†…å­˜ä¸­çš„ç”¨æˆ·ä¿¡æ¯
- å®é™…é¡¹ç›®ä¸­ç”¨æˆ·ä¿¡æ¯é€šå¸¸å­˜åœ¨æ•°æ®åº“ä¸­
- éœ€è¦è‡ªå®šä¹‰è®¤è¯é€»è¾‘æ¥å¯¹æ¥è‡ªå·±çš„ç”¨æˆ·ç³»ç»Ÿ

### 3.2 å®ç°UserDetailsService


**æ ¸å¿ƒæ€è·¯**ï¼šå‘Šè¯‰SpringSecurityå¦‚ä½•æŸ¥æ‰¾ç”¨æˆ·ä¿¡æ¯ã€‚

```java
@Service
public class CustomUserDetailsService implements UserDetailsService {
    
    @Autowired
    private UserMapper userMapper; // æ•°æ®åº“ç”¨æˆ·æŸ¥è¯¢
    
    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        // 1. ä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·
        User user = userMapper.findByUsername(username);
        if (user == null) {
            throw new UsernameNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨ï¼š" + username);
        }
        
        // 2. æ„å»ºSpringSecurityéœ€è¦çš„ç”¨æˆ·ä¿¡æ¯
        return User.builder()
                .username(user.getUsername())
                .password(user.getPassword()) // å·²åŠ å¯†çš„å¯†ç 
                .roles(user.getRole())        // ç”¨æˆ·è§’è‰²
                .accountLocked(!user.getEnabled()) // è´¦å·çŠ¶æ€
                .build();
    }
}
```

**å…³é”®ç†è§£**ï¼š
- `loadUserByUsername`æ–¹æ³•ï¼šSpringSecurityä¼šè‡ªåŠ¨è°ƒç”¨
- `UserDetails`å¯¹è±¡ï¼šåŒ…å«ç”¨æˆ·åã€å¯†ç ã€æƒé™ç­‰ä¿¡æ¯
- æŠ›å‡º`UsernameNotFoundException`ï¼šå‘Šè¯‰æ¡†æ¶ç”¨æˆ·ä¸å­˜åœ¨

### 3.3 è‡ªå®šä¹‰è®¤è¯æˆåŠŸ/å¤±è´¥å¤„ç†


**è®¤è¯æˆåŠŸå¤„ç†å™¨**ï¼š
```java
@Component
public class LoginSuccessHandler implements AuthenticationSuccessHandler {
    
    @Override
    public void onAuthenticationSuccess(HttpServletRequest request,
                                      HttpServletResponse response,
                                      Authentication authentication) throws IOException {
        // ç™»å½•æˆåŠŸåçš„è‡ªå®šä¹‰é€»è¾‘
        User user = (User) authentication.getPrincipal();
        
        // è®°å½•ç™»å½•æ—¥å¿—
        logService.recordLogin(user.getUsername(), request.getRemoteAddr());
        
        // è¿”å›JSONå“åº”(é€‚åˆå‰åç«¯åˆ†ç¦»)
        response.setContentType("application/json;charset=UTF-8");
        response.getWriter().write("{\"status\":\"success\",\"message\":\"ç™»å½•æˆåŠŸ\"}");
    }
}
```

**è®¤è¯å¤±è´¥å¤„ç†å™¨**ï¼š
```java
@Component
public class LoginFailureHandler implements AuthenticationFailureHandler {
    
    @Override
    public void onAuthenticationFailure(HttpServletRequest request,
                                      HttpServletResponse response,
                                      AuthenticationException exception) throws IOException {
        
        String message = "ç™»å½•å¤±è´¥";
        if (exception instanceof UsernameNotFoundException) {
            message = "ç”¨æˆ·åä¸å­˜åœ¨";
        } else if (exception instanceof BadCredentialsException) {
            message = "å¯†ç é”™è¯¯";
        }
        
        // è¿”å›å¤±è´¥ä¿¡æ¯
        response.setContentType("application/json;charset=UTF-8");
        response.getWriter().write("{\"status\":\"error\",\"message\":\"" + message + "\"}");
    }
}
```

### 3.4 è‡ªå®šä¹‰ç™»å½•è¡¨å•å¤„ç†


```java
// è‡ªå®šä¹‰ç™»å½•Controllerï¼ˆå¯é€‰ï¼‰
@Controller
public class LoginController {
    
    @GetMapping("/login")
    public String loginPage() {
        return "login"; // è¿”å›è‡ªå®šä¹‰ç™»å½•é¡µé¢
    }
    
    // ç™»å½•è¡¨å•æäº¤ä¼šè¢«SpringSecurityè‡ªåŠ¨å¤„ç†
    // æ— éœ€æ‰‹åŠ¨å®ç°POST /loginæ¥å£
}
```

---

## 4. ğŸ¯ æƒé™æ§åˆ¶æ³¨è§£è¯¦è§£


### 4.1 @PreAuthorize - æ–¹æ³•æ‰§è¡Œå‰æƒé™æ£€æŸ¥


**ä½œç”¨**ï¼šåœ¨æ–¹æ³•æ‰§è¡Œä¹‹å‰æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰ç›¸åº”æƒé™ã€‚

```java
@RestController
public class AdminController {
    
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰ADMINè§’è‰²
    @PreAuthorize("hasRole('ADMIN')")
    @GetMapping("/admin/users")
    public List<User> getAllUsers() {
        return userService.findAll();
    }
    
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰ç‰¹å®šæƒé™
    @PreAuthorize("hasAuthority('USER_READ')")
    @GetMapping("/admin/user/{id}")
    public User getUser(@PathVariable Long id) {
        return userService.findById(id);
    }
    
    // å¤æ‚æƒé™è¡¨è¾¾å¼ï¼šç®¡ç†å‘˜æˆ–è€…æ˜¯ç”¨æˆ·æœ¬äºº
    @PreAuthorize("hasRole('ADMIN') or #id == authentication.principal.id")
    @GetMapping("/user/{id}/profile")
    public User getUserProfile(@PathVariable Long id) {
        return userService.findById(id);
    }
}
```

**å¸¸ç”¨è¡¨è¾¾å¼**ï¼š

| è¡¨è¾¾å¼ | **ä½œç”¨** | **ç¤ºä¾‹** |
|--------|---------|----------|
| `hasRole('ROLE')` | æ£€æŸ¥æ˜¯å¦æœ‰æŒ‡å®šè§’è‰² | `hasRole('ADMIN')` |
| `hasAuthority('AUTH')` | æ£€æŸ¥æ˜¯å¦æœ‰æŒ‡å®šæƒé™ | `hasAuthority('USER_DELETE')` |
| `isAuthenticated()` | æ£€æŸ¥æ˜¯å¦å·²ç™»å½• | ä»»ä½•ç™»å½•ç”¨æˆ·éƒ½å¯è®¿é—® |
| `permitAll()` | å…è®¸æ‰€æœ‰ç”¨æˆ· | å…¬å¼€è®¿é—®çš„æ¥å£ |
| `#å‚æ•°å` | è®¿é—®æ–¹æ³•å‚æ•° | `#id == authentication.principal.id` |

### 4.2 @Secured - ç®€å•è§’è‰²æ£€æŸ¥


**ä½œç”¨**ï¼šæ›´ç®€æ´çš„è§’è‰²æƒé™æ£€æŸ¥ï¼Œåªæ”¯æŒè§’è‰²éªŒè¯ã€‚

```java
@RestController  
public class UserController {
    
    // å•ä¸ªè§’è‰²æ£€æŸ¥
    @Secured("ROLE_ADMIN")
    @DeleteMapping("/user/{id}")
    public void deleteUser(@PathVariable Long id) {
        userService.deleteById(id);
    }
    
    // å¤šä¸ªè§’è‰²æ£€æŸ¥(æ»¡è¶³å…¶ä¸­ä¸€ä¸ªå³å¯)
    @Secured({"ROLE_ADMIN", "ROLE_MANAGER"})
    @PutMapping("/user/{id}")
    public User updateUser(@PathVariable Long id, @RequestBody User user) {
        return userService.update(id, user);
    }
}
```

**@PreAuthorize vs @Secured**ï¼š

```java
// @Secured - ç®€å•ä½†åŠŸèƒ½æœ‰é™
@Secured("ROLE_ADMIN")
public void method1() {}

// @PreAuthorize - çµæ´»ä½†ç›¸å¯¹å¤æ‚
@PreAuthorize("hasRole('ADMIN') and #user.id == authentication.principal.id")
public void method2(User user) {}
```

### 4.3 æ–¹æ³•çº§æƒé™æ§åˆ¶æœ€ä½³å®è·µ


```java
@Service
@Transactional
public class OrderService {
    
    // åŸºç¡€æƒé™ï¼šåªæœ‰ç™»å½•ç”¨æˆ·å¯ä»¥æŸ¥çœ‹è®¢å•
    @PreAuthorize("isAuthenticated()")
    public List<Order> getMyOrders() {
        // è·å–å½“å‰ç™»å½•ç”¨æˆ·çš„è®¢å•
        String username = SecurityContextHolder.getContext()
                           .getAuthentication().getName();
        return orderRepository.findByUsername(username);
    }
    
    // ç®¡ç†å‘˜æƒé™ï¼šå¯ä»¥æŸ¥çœ‹æ‰€æœ‰è®¢å•
    @PreAuthorize("hasRole('ADMIN')")
    public List<Order> getAllOrders() {
        return orderRepository.findAll();
    }
    
    // ç»„åˆæƒé™ï¼šç®¡ç†å‘˜æˆ–è®¢å•æ‰€æœ‰è€…å¯ä»¥æŸ¥çœ‹è®¢å•è¯¦æƒ…
    @PreAuthorize("hasRole('ADMIN') or @orderService.isOwner(#orderId, authentication.name)")
    public Order getOrderDetail(@PathVariable Long orderId) {
        return orderRepository.findById(orderId);
    }
    
    // è‡ªå®šä¹‰æƒé™æ£€æŸ¥æ–¹æ³•
    public boolean isOwner(Long orderId, String username) {
        Order order = orderRepository.findById(orderId);
        return order != null && order.getUsername().equals(username);
    }
}
```

---

## 5. âš ï¸ è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†


### 5.1 ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†


**é»˜è®¤å¼‚å¸¸å¤„ç†çš„é—®é¢˜**ï¼š
```
ç”¨æˆ·è®¿é—®æ²¡æœ‰æƒé™çš„æ¥å£ï¼š
é»˜è®¤è¿”å› â†’ 403 Forbiddené¡µé¢ (ç”¨æˆ·ä½“éªŒå·®)
æœŸæœ›è¿”å› â†’ {"code":403, "message":"æƒé™ä¸è¶³"} (å‰ç«¯å‹å¥½)
```

### 5.2 è®¤è¯å¼‚å¸¸å¤„ç†


```java
@Component
public class CustomAuthenticationEntryPoint implements AuthenticationEntryPoint {
    
    @Override
    public void commence(HttpServletRequest request,
                        HttpServletResponse response,
                        AuthenticationException authException) throws IOException {
        
        // è®¾ç½®å“åº”ç±»å‹
        response.setContentType("application/json;charset=UTF-8");
        response.setStatus(HttpStatus.UNAUTHORIZED.value());
        
        // æ„å»ºé”™è¯¯å“åº”
        Map<String, Object> result = new HashMap<>();
        result.put("code", 401);
        result.put("message", "è¯·å…ˆç™»å½•");
        result.put("timestamp", System.currentTimeMillis());
        
        // å†™å…¥å“åº”
        ObjectMapper objectMapper = new ObjectMapper();
        response.getWriter().write(objectMapper.writeValueAsString(result));
    }
}
```

### 5.3 æˆæƒå¼‚å¸¸å¤„ç†


```java
@Component
public class CustomAccessDeniedHandler implements AccessDeniedHandler {
    
    @Override
    public void handle(HttpServletRequest request,
                      HttpServletResponse response,
                      AccessDeniedException accessDeniedException) throws IOException {
        
        response.setContentType("application/json;charset=UTF-8");
        response.setStatus(HttpStatus.FORBIDDEN.value());
        
        Map<String, Object> result = new HashMap<>();
        result.put("code", 403);
        result.put("message", "æƒé™ä¸è¶³ï¼Œæ— æ³•è®¿é—®");
        result.put("timestamp", System.currentTimeMillis());
        
        ObjectMapper objectMapper = new ObjectMapper();
        response.getWriter().write(objectMapper.writeValueAsString(result));
    }
}
```

### 5.4 å…¨å±€å¼‚å¸¸å¤„ç†å™¨


```java
@RestControllerAdvice
public class SecurityExceptionHandler {
    
    // å¤„ç†æƒé™ç›¸å…³å¼‚å¸¸
    @ExceptionHandler(AccessDeniedException.class)
    public ResponseEntity<Map<String, Object>> handleAccessDenied(AccessDeniedException e) {
        Map<String, Object> response = new HashMap<>();
        response.put("code", 403);
        response.put("message", "æƒé™ä¸è¶³");
        response.put("detail", e.getMessage());
        
        return ResponseEntity.status(403).body(response);
    }
    
    // å¤„ç†è®¤è¯å¼‚å¸¸
    @ExceptionHandler(AuthenticationException.class)
    public ResponseEntity<Map<String, Object>> handleAuthentication(AuthenticationException e) {
        Map<String, Object> response = new HashMap<>();
        response.put("code", 401);
        response.put("message", "è®¤è¯å¤±è´¥");
        response.put("detail", e.getMessage());
        
        return ResponseEntity.status(401).body(response);
    }
}
```

---

## 6. ğŸ”§ SecurityConfigé…ç½®ç±»è¯¦è§£


### 6.1 åŸºç¡€é…ç½®ç»“æ„


```java
@Configuration
@EnableWebSecurity  // å¯ç”¨SpringSecurity
@EnableGlobalMethodSecurity(prePostEnabled = true) // å¯ç”¨æ–¹æ³•çº§æ³¨è§£
public class SecurityConfig {
    
    @Autowired
    private CustomUserDetailsService userDetailsService;
    
    @Autowired
    private LoginSuccessHandler successHandler;
    
    @Autowired
    private LoginFailureHandler failureHandler;
    
    @Autowired
    private CustomAuthenticationEntryPoint authenticationEntryPoint;
    
    @Autowired
    private CustomAccessDeniedHandler accessDeniedHandler;
}
```

### 6.2 å¯†ç åŠ å¯†å™¨é…ç½®


```java
@Configuration
public class SecurityConfig {
    
    // å¯†ç åŠ å¯†å™¨Bean
    @Bean
    public PasswordEncoder passwordEncoder() {
        // BCryptæ˜¯ç›®å‰æœ€æ¨èçš„å¯†ç åŠ å¯†æ–¹å¼
        return new BCryptPasswordEncoder();
    }
    
    // ä¸ºä»€ä¹ˆè¦åŠ å¯†å¯†ç ï¼Ÿ
    // 1. æ•°æ®åº“ä¸­ä¸å­˜å‚¨æ˜æ–‡å¯†ç ï¼Œé˜²æ­¢æ³„éœ²
    // 2. BCryptæ¯æ¬¡åŠ å¯†ç»“æœéƒ½ä¸åŒï¼Œé˜²æ­¢å½©è™¹è¡¨æ”»å‡»
    // 3. ä¸å¯é€†åŠ å¯†ï¼Œå³ä½¿ä»£ç æ³„éœ²ä¹Ÿæ— æ³•åæ¨å¯†ç 
}
```

### 6.3 è®¤è¯ç®¡ç†å™¨é…ç½®


```java
@Configuration
public class SecurityConfig {
    
    @Bean
    public AuthenticationManager authenticationManager(
            AuthenticationConfiguration authConfig) throws Exception {
        return authConfig.getAuthenticationManager();
    }
    
    // é…ç½®è®¤è¯æä¾›è€…
    @Bean
    public DaoAuthenticationProvider authenticationProvider() {
        DaoAuthenticationProvider authProvider = new DaoAuthenticationProvider();
        authProvider.setUserDetailsService(userDetailsService);
        authProvider.setPasswordEncoder(passwordEncoder());
        return authProvider;
    }
}
```

### 6.4 å®Œæ•´çš„SecurityConfigé…ç½®


```java
@Configuration
@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled = true)
public class SecurityConfig {
    
    // æ³¨å…¥è‡ªå®šä¹‰ç»„ä»¶...
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            // é…ç½®æˆæƒè§„åˆ™
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/", "/home", "/register").permitAll() // å…¬å¼€è®¿é—®
                .requestMatchers("/admin/**").hasRole("ADMIN")          // ç®¡ç†å‘˜é¡µé¢
                .requestMatchers("/api/public/**").permitAll()          // å…¬å¼€API
                .anyRequest().authenticated()                           // å…¶ä»–è¯·æ±‚éœ€è¦è®¤è¯
            )
            
            // é…ç½®è¡¨å•ç™»å½•
            .formLogin(form -> form
                .loginPage("/login")                    // è‡ªå®šä¹‰ç™»å½•é¡µé¢
                .loginProcessingUrl("/perform-login")   // ç™»å½•è¡¨å•æäº¤åœ°å€
                .successHandler(successHandler)         // ç™»å½•æˆåŠŸå¤„ç†å™¨
                .failureHandler(failureHandler)         // ç™»å½•å¤±è´¥å¤„ç†å™¨
                .permitAll()
            )
            
            // é…ç½®ç™»å‡º
            .logout(logout -> logout
                .logoutUrl("/logout")
                .logoutSuccessUrl("/")
                .invalidateHttpSession(true)
                .permitAll()
            )
            
            // é…ç½®å¼‚å¸¸å¤„ç†
            .exceptionHandling(ex -> ex
                .authenticationEntryPoint(authenticationEntryPoint)
                .accessDeniedHandler(accessDeniedHandler)
            )
            
            // å…¶ä»–é…ç½®
            .csrf(csrf -> csrf.disable())               // ç¦ç”¨CSRF(APIé¡¹ç›®)
            .sessionManagement(session -> session
                .sessionCreationPolicy(SessionCreationPolicy.IF_REQUIRED)
            );
        
        return http.build();
    }
    
    // å…¶ä»–Beané…ç½®...
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
}
```

### 6.5 é…ç½®è¯¦è§£


**URLæƒé™é…ç½®è§£é‡Š**ï¼š
```java
.authorizeHttpRequests(auth -> auth
    .requestMatchers("/public/**").permitAll()     // æ‰€æœ‰äººéƒ½èƒ½è®¿é—®
    .requestMatchers("/admin/**").hasRole("ADMIN") // åªæœ‰ADMINè§’è‰²èƒ½è®¿é—®  
    .requestMatchers("/user/**").hasAnyRole("USER", "ADMIN") // å¤šè§’è‰²è®¿é—®
    .anyRequest().authenticated()                  // å…¶ä»–URLéœ€è¦ç™»å½•
)

// æƒé™åŒ¹é…é¡ºåºå¾ˆé‡è¦ï¼
// SpringSecurityæŒ‰ç…§é…ç½®é¡ºåºåŒ¹é…ï¼Œç¬¬ä¸€ä¸ªåŒ¹é…çš„è§„åˆ™ç”Ÿæ•ˆ
// æ‰€ä»¥è¦æŠŠå…·ä½“çš„è§„åˆ™æ”¾åœ¨å‰é¢ï¼Œé€šç”¨è§„åˆ™æ”¾åœ¨åé¢
```

**è¡¨å•ç™»å½•é…ç½®è§£é‡Š**ï¼š
```java
.formLogin(form -> form
    .loginPage("/login")                // æœªç™»å½•æ—¶è·³è½¬çš„é¡µé¢
    .loginProcessingUrl("/perform-login") // è¡¨å•actionåœ°å€
    .usernameParameter("username")      // ç”¨æˆ·åå­—æ®µå(é»˜è®¤username)
    .passwordParameter("password")      // å¯†ç å­—æ®µå(é»˜è®¤password)
    .defaultSuccessUrl("/home", true)   // ç™»å½•æˆåŠŸåè·³è½¬é¡µé¢
    .failureUrl("/login?error=true")    // ç™»å½•å¤±è´¥åè·³è½¬é¡µé¢
)
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ SpringSecurityæœ¬è´¨ï¼šç»Ÿä¸€çš„è®¤è¯å’Œæˆæƒæ¡†æ¶
ğŸ”¸ FilterChainï¼šè¯·æ±‚æ‹¦æˆªå’Œå®‰å…¨æ£€æŸ¥çš„è¿‡æ»¤å™¨é“¾
ğŸ”¸ AuthenticationManagerï¼šä¸“é—¨è´Ÿè´£ç”¨æˆ·èº«ä»½éªŒè¯
ğŸ”¸ UserDetailsServiceï¼šå‘Šè¯‰æ¡†æ¶å¦‚ä½•æŸ¥æ‰¾ç”¨æˆ·ä¿¡æ¯
ğŸ”¸ æƒé™æ³¨è§£ï¼š@PreAuthorizeå’Œ@Securedæ§åˆ¶æ–¹æ³•è®¿é—®æƒé™
ğŸ”¸ SecurityConfigï¼šæ•´ä¸ªå®‰å…¨é…ç½®çš„æ ¸å¿ƒç±»
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ è®¤è¯å’Œæˆæƒçš„åŒºåˆ«**
```
è®¤è¯(Authentication)ï¼šç¡®è®¤"ä½ æ˜¯è°"
- ç”¨æˆ·è¾“å…¥ç”¨æˆ·åå¯†ç 
- ç³»ç»ŸéªŒè¯èº«ä»½ä¿¡æ¯
- ç¡®è®¤ç”¨æˆ·èº«ä»½çœŸå®æ€§

æˆæƒ(Authorization)ï¼šç¡®è®¤"ä½ èƒ½åšä»€ä¹ˆ"  
- æ£€æŸ¥ç”¨æˆ·çš„è§’è‰²å’Œæƒé™
- å†³å®šç”¨æˆ·èƒ½è®¿é—®å“ªäº›èµ„æº
- æ§åˆ¶æ“ä½œæƒé™
```

**ğŸ”¹ è¿‡æ»¤å™¨é“¾çš„å·¥ä½œåŸç†**
```
ç†è§£è¦ç‚¹ï¼š
- æ¯ä¸ªè¯·æ±‚éƒ½è¦ç»è¿‡å®Œæ•´çš„è¿‡æ»¤å™¨é“¾
- è¿‡æ»¤å™¨æŒ‰é¡ºåºæ‰§è¡Œï¼Œå‰ä¸€ä¸ªé€šè¿‡æ‰åˆ°ä¸‹ä¸€ä¸ª
- è®¤è¯å¤±è´¥åœ¨ä»»ä½•ä¸€ä¸ªç¯èŠ‚éƒ½ä¼šè¢«æ‹¦æˆª
- æœ€åä¸€ä¸ªè¿‡æ»¤å™¨è´Ÿè´£æœ€ç»ˆçš„æƒé™æ£€æŸ¥
```

**ğŸ”¹ è‡ªå®šä¹‰é…ç½®çš„æ ¸å¿ƒæ€è·¯**
```
é…ç½®åŸåˆ™ï¼š
- UserDetailsServiceï¼šå‘Šè¯‰SpringSecurityå¦‚ä½•æŸ¥ç”¨æˆ·
- PasswordEncoderï¼šå‘Šè¯‰SpringSecurityå¦‚ä½•éªŒè¯å¯†ç   
- æˆåŠŸ/å¤±è´¥å¤„ç†å™¨ï¼šå‘Šè¯‰SpringSecurityè®¤è¯ååšä»€ä¹ˆ
- å¼‚å¸¸å¤„ç†å™¨ï¼šå‘Šè¯‰SpringSecurityå‡ºé”™æ—¶æ€ä¹ˆå“åº”
```

### 7.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¼ä¸šçº§åº”ç”¨åœºæ™¯**
- **åå°ç®¡ç†ç³»ç»Ÿ**ï¼šä¸åŒè§’è‰²è®¿é—®ä¸åŒåŠŸèƒ½æ¨¡å—
- **APIæ¥å£ä¿æŠ¤**ï¼šé˜²æ­¢æœªæˆæƒè®¿é—®æ•æ„Ÿæ•°æ®  
- **å¤šç§Ÿæˆ·ç³»ç»Ÿ**ï¼šæ ¹æ®ç”¨æˆ·èº«ä»½æ§åˆ¶æ•°æ®è®¿é—®èŒƒå›´
- **ç§»åŠ¨ç«¯è®¤è¯**ï¼šç»“åˆJWTå®ç°æ— çŠ¶æ€è®¤è¯

**ğŸ”§ å¼€å‘å®è·µå»ºè®®**
- **æ¸è¿›å¼é…ç½®**ï¼šå…ˆé…ç½®åŸºç¡€è®¤è¯ï¼Œå†æ·»åŠ å¤æ‚æƒé™æ§åˆ¶
- **ç»Ÿä¸€å¼‚å¸¸å¤„ç†**ï¼šæä¾›ä¸€è‡´çš„é”™è¯¯å“åº”æ ¼å¼
- **æƒé™è®¾è®¡**ï¼šåˆç†è®¾è®¡è§’è‰²å’Œæƒé™çš„å±‚æ¬¡ç»“æ„
- **å®‰å…¨æµ‹è¯•**ï¼šé’ˆå¯¹ä¸åŒè§’è‰²è¿›è¡Œå……åˆ†çš„æƒé™æµ‹è¯•

**æ ¸å¿ƒè®°å¿†**ï¼š
- SpringSecurity = é—¨å«ç³»ç»Ÿï¼Œè´Ÿè´£èº«ä»½éªŒè¯å’Œæƒé™æ§åˆ¶
- FilterChain = å®‰æ£€æµç¨‹ï¼Œå±‚å±‚æŠŠå…³ç¡®ä¿å®‰å…¨
- AuthenticationManager = èº«ä»½éªŒè¯å®˜ï¼Œä¸“é—¨ç¡®è®¤ç”¨æˆ·èº«ä»½
- è‡ªå®šä¹‰é…ç½® = å‘Šè¯‰ç³»ç»ŸæŒ‰ç…§ä½ çš„è§„åˆ™å·¥ä½œ
- æƒé™æ³¨è§£ = æ–¹æ³•çº§çš„è®¿é—®æ§åˆ¶ï¼Œç®€å•é«˜æ•ˆ