---
title: 11ã€SpringSecurityé›†æˆJWT
---
## ğŸ“š ç›®å½•

1. [JWTä¸Spring Securityé›†æˆæ¦‚è¿°](#1-JWTä¸SpringSecurityé›†æˆæ¦‚è¿°)
2. [ç™»å½•æ¥å£ç­¾å‘JWT](#2-ç™»å½•æ¥å£ç­¾å‘JWT)
3. [æ‹¦æˆªå™¨éªŒè¯Tokenå¹¶è®¾ç½®ä¸Šä¸‹æ–‡](#3-æ‹¦æˆªå™¨éªŒè¯Tokenå¹¶è®¾ç½®ä¸Šä¸‹æ–‡)
4. [åŸºäºè§’è‰²çš„æƒé™æ§åˆ¶](#4-åŸºäºè§’è‰²çš„æƒé™æ§åˆ¶)
5. [æ— çŠ¶æ€å®‰å…¨æ¶æ„å®æˆ˜é…ç½®](#5-æ— çŠ¶æ€å®‰å…¨æ¶æ„å®æˆ˜é…ç½®)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” JWTä¸Spring Securityé›†æˆæ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯Spring Security + JWT


**ğŸ”¸ Spring Security**ï¼š
- Springå®¶æ—çš„å®‰å…¨æ¡†æ¶ï¼Œä¸“é—¨ç”¨æ¥å¤„ç†è®¤è¯å’Œæˆæƒ
- å°±åƒç»™ä½ çš„æˆ¿å­è£…äº†ä¸€å¥—æ™ºèƒ½å®‰é˜²ç³»ç»Ÿ
- å¯ä»¥æ§åˆ¶è°èƒ½è¿›é—¨ï¼Œè°èƒ½è¿›å“ªä¸ªæˆ¿é—´

**ğŸ”¸ JWTé›†æˆçš„å¥½å¤„**ï¼š
```
ä¼ ç»ŸSessionæ–¹å¼ï¼š
ç”¨æˆ·ç™»å½• â†’ æœåŠ¡å™¨å­˜å‚¨Session â†’ è¿”å›Cookie
é—®é¢˜ï¼šæœåŠ¡å™¨è¦è®°ä½æ‰€æœ‰ç”¨æˆ·çŠ¶æ€ï¼Œå ç”¨å†…å­˜

JWTæ–¹å¼ï¼š
ç”¨æˆ·ç™»å½• â†’ æœåŠ¡å™¨ç”ŸæˆJWT â†’ è¿”å›Token
ä¼˜åŠ¿ï¼šæœåŠ¡å™¨ä¸éœ€è¦å­˜å‚¨ç”¨æˆ·çŠ¶æ€ï¼Œæ›´è½»é‡
```

### 1.2 æ•´ä½“å·¥ä½œæµç¨‹


```
å®¢æˆ·ç«¯                    Spring Security + JWT                æ•°æ®åº“
  |                              |                              |
  |--[1]ç”¨æˆ·åå¯†ç ç™»å½•----------->|                              |
  |                              |--[2]éªŒè¯ç”¨æˆ·ä¿¡æ¯------------>|
  |                              |<-[3]è¿”å›ç”¨æˆ·ä¿¡æ¯-------------|
  |<-[4]è¿”å›JWT Token------------|                              |
  |                              |                              |
  |--[5]æºå¸¦Tokenè®¿é—®API-------->|                              |
  |                              |--[6]éªŒè¯Tokenæœ‰æ•ˆæ€§--------->|
  |                              |<-[7]è¿”å›ç”¨æˆ·æƒé™-------------|
  |<-[8]è¿”å›APIæ•°æ®-------------|                              |
```

### 1.3 æ ¸å¿ƒç»„ä»¶è¯´æ˜


| ç»„ä»¶ | ä½œç”¨ | é€šä¿—è§£é‡Š |
|-----|------|---------|
| **AuthenticationManager** | `è®¤è¯ç®¡ç†å™¨` | `é—¨å«ä¸»ç®¡ï¼Œå†³å®šç”¨æˆ·èƒ½å¦è¿›é—¨` |
| **UserDetailsService** | `ç”¨æˆ·ä¿¡æ¯æœåŠ¡` | `æ¡£æ¡ˆå®¤ï¼Œå­˜æ”¾ç”¨æˆ·åŸºæœ¬ä¿¡æ¯` |
| **JwtAuthenticationFilter** | `JWTè¿‡æ»¤å™¨` | `æ£€æŸ¥å‘˜ï¼ŒéªŒè¯æ¯ä¸ªäººçš„é€šè¡Œè¯` |
| **SecurityContext** | `å®‰å…¨ä¸Šä¸‹æ–‡` | `èº«ä»½è¯æ˜ï¼Œè¯æ˜ä½ æ˜¯è°` |

---

## 2. ğŸ« ç™»å½•æ¥å£ç­¾å‘JWT


### 2.1 JWTå·¥å…·ç±»å®ç°


> ğŸ’¡ **è¯´æ˜**: JWTå·¥å…·ç±»å°±åƒä¸€ä¸ª"è¯ä»¶åˆ¶ä½œæœº"ï¼Œè´Ÿè´£åˆ¶ä½œå’ŒéªŒè¯ç”¨æˆ·çš„èº«ä»½è¯æ˜

```java
@Component
public class JwtTokenUtil {
    
    private String secret = "mySecretKey"; // ç­¾åå¯†é’¥
    private int expiration = 86400; // 24å°æ—¶è¿‡æœŸ
    
    /**
     * ç”ŸæˆJWT Token - å°±åƒåˆ¶ä½œèº«ä»½è¯
     */
    public String generateToken(UserDetails userDetails) {
        Map<String, Object> claims = new HashMap<>();
        claims.put("username", userDetails.getUsername());
        claims.put("roles", userDetails.getAuthorities());
        
        return Jwts.builder()
                .setClaims(claims)              // è®¾ç½®ç”¨æˆ·ä¿¡æ¯
                .setSubject(userDetails.getUsername()) // è®¾ç½®ä¸»é¢˜(ç”¨æˆ·å)
                .setIssuedAt(new Date())        // è®¾ç½®ç­¾å‘æ—¶é—´
                .setExpiration(new Date(System.currentTimeMillis() + expiration * 1000))
                .signWith(SignatureAlgorithm.HS512, secret) // ç­¾å
                .compact();
    }
    
    /**
     * ä»Tokenä¸­è·å–ç”¨æˆ·å
     */
    public String getUsernameFromToken(String token) {
        return getClaimFromToken(token, Claims::getSubject);
    }
    
    /**
     * éªŒè¯Tokenæ˜¯å¦æœ‰æ•ˆ
     */
    public boolean validateToken(String token, UserDetails userDetails) {
        String username = getUsernameFromToken(token);
        return username.equals(userDetails.getUsername()) && !isTokenExpired(token);
    }
    
    // æ£€æŸ¥Tokenæ˜¯å¦è¿‡æœŸ
    private boolean isTokenExpired(String token) {
        Date expiration = getExpirationDateFromToken(token);
        return expiration.before(new Date());
    }
}
```

### 2.2 ç™»å½•æ¥å£å®ç°


> ğŸ’¡ **æ ¸å¿ƒæ€è·¯**: ç”¨æˆ·æä¾›ç”¨æˆ·åå¯†ç  â†’ éªŒè¯æ­£ç¡® â†’ ç”ŸæˆJWT â†’ è¿”å›ç»™ç”¨æˆ·

```java
@RestController
@RequestMapping("/auth")
public class AuthController {
    
    @Autowired
    private AuthenticationManager authenticationManager;
    
    @Autowired
    private JwtTokenUtil jwtTokenUtil;
    
    @Autowired
    private UserDetailsService userDetailsService;
    
    /**
     * ç”¨æˆ·ç™»å½•æ¥å£
     */
    @PostMapping("/login")
    public ResponseEntity<?> login(@RequestBody LoginRequest loginRequest) {
        try {
            // æ­¥éª¤1ï¼šéªŒè¯ç”¨æˆ·åå¯†ç 
            authenticationManager.authenticate(
                new UsernamePasswordAuthenticationToken(
                    loginRequest.getUsername(),
                    loginRequest.getPassword()
                )
            );
            
            // æ­¥éª¤2ï¼šè·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
            UserDetails userDetails = userDetailsService
                .loadUserByUsername(loginRequest.getUsername());
            
            // æ­¥éª¤3ï¼šç”ŸæˆJWT Token
            String token = jwtTokenUtil.generateToken(userDetails);
            
            // æ­¥éª¤4ï¼šè¿”å›Tokenç»™å®¢æˆ·ç«¯
            return ResponseEntity.ok(new JwtResponse(token));
            
        } catch (BadCredentialsException e) {
            return ResponseEntity.status(401)
                .body(new ErrorResponse("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"));
        }
    }
}

// ç™»å½•è¯·æ±‚å¯¹è±¡
class LoginRequest {
    private String username;
    private String password;
    // getter/setterçœç•¥
}

// JWTå“åº”å¯¹è±¡
class JwtResponse {
    private String token;
    private String type = "Bearer"; // Tokenç±»å‹
    
    public JwtResponse(String token) {
        this.token = token;
    }
    // getter/setterçœç•¥
}
```

### 2.3 ç™»å½•æµç¨‹è¯¦è§£


```
ç™»å½•éªŒè¯è¿‡ç¨‹ï¼š

1. ç”¨æˆ·æäº¤ç™»å½•è¡¨å•
   â†“
2. AuthenticationManageréªŒè¯ç”¨æˆ·åå¯†ç 
   â†“
3. éªŒè¯æˆåŠŸï¼Œè·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
   â†“
4. JwtTokenUtilç”ŸæˆJWT Token
   â†“
5. è¿”å›Tokenç»™å®¢æˆ·ç«¯
   â†“
6. å®¢æˆ·ç«¯ä¿å­˜Tokenï¼ˆé€šå¸¸å­˜localStorageï¼‰
```

---

## 3. ğŸ›¡ï¸ æ‹¦æˆªå™¨éªŒè¯Tokenå¹¶è®¾ç½®ä¸Šä¸‹æ–‡


### 3.1 JWTè®¤è¯è¿‡æ»¤å™¨


> ğŸ’¡ **ä½œç”¨**: è¿™ä¸ªè¿‡æ»¤å™¨å°±åƒé—¨å£çš„ä¿å®‰ï¼Œæ£€æŸ¥æ¯ä¸ªäººçš„"é€šè¡Œè¯"(JWT)æ˜¯å¦æœ‰æ•ˆ

```java
@Component
public class JwtAuthenticationFilter extends OncePerRequestFilter {
    
    @Autowired
    private UserDetailsService userDetailsService;
    
    @Autowired
    private JwtTokenUtil jwtTokenUtil;
    
    @Override
    protected void doFilterInternal(HttpServletRequest request, 
                                  HttpServletResponse response, 
                                  FilterChain chain) throws ServletException, IOException {
        
        // æ­¥éª¤1ï¼šä»è¯·æ±‚å¤´è·å–Token
        String token = getTokenFromRequest(request);
        
        if (token != null && SecurityContextHolder.getContext().getAuthentication() == null) {
            
            // æ­¥éª¤2ï¼šä»Tokenä¸­è§£æç”¨æˆ·å
            String username = jwtTokenUtil.getUsernameFromToken(token);
            
            if (username != null) {
                // æ­¥éª¤3ï¼šåŠ è½½ç”¨æˆ·ä¿¡æ¯
                UserDetails userDetails = userDetailsService.loadUserByUsername(username);
                
                // æ­¥éª¤4ï¼šéªŒè¯Tokenæ˜¯å¦æœ‰æ•ˆ
                if (jwtTokenUtil.validateToken(token, userDetails)) {
                    
                    // æ­¥éª¤5ï¼šåˆ›å»ºè®¤è¯å¯¹è±¡
                    UsernamePasswordAuthenticationToken authToken = 
                        new UsernamePasswordAuthenticationToken(
                            userDetails, null, userDetails.getAuthorities());
                    
                    // æ­¥éª¤6ï¼šè®¾ç½®åˆ°å®‰å…¨ä¸Šä¸‹æ–‡
                    SecurityContextHolder.getContext().setAuthentication(authToken);
                }
            }
        }
        
        // ç»§ç»­æ‰§è¡Œåç»­è¿‡æ»¤å™¨
        chain.doFilter(request, response);
    }
    
    /**
     * ä»è¯·æ±‚å¤´ä¸­æå–JWT Token
     */
    private String getTokenFromRequest(HttpServletRequest request) {
        String bearerToken = request.getHeader("Authorization");
        if (bearerToken != null && bearerToken.startsWith("Bearer ")) {
            return bearerToken.substring(7); // å»æ‰"Bearer "å‰ç¼€
        }
        return null;
    }
}
```

### 3.2 å®‰å…¨ä¸Šä¸‹æ–‡è®¾ç½®è¯¦è§£


> ğŸ” **æ·±å…¥ç†è§£**: SecurityContextå°±åƒä¸€ä¸ª"èº«ä»½è¯æ˜ç›’å­"ï¼ŒSpring Securityé€šè¿‡å®ƒçŸ¥é“å½“å‰ç”¨æˆ·æ˜¯è°

```java
// å®‰å…¨ä¸Šä¸‹æ–‡çš„ä½œç”¨ç¤ºä¾‹
@RestController
public class UserController {
    
    @GetMapping("/profile")
    public ResponseEntity<?> getUserProfile() {
        // ä»å®‰å…¨ä¸Šä¸‹æ–‡è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
        Authentication auth = SecurityContextHolder.getContext().getAuthentication();
        
        if (auth != null && auth.isAuthenticated()) {
            String username = auth.getName(); // è·å–ç”¨æˆ·å
            Collection<? extends GrantedAuthority> authorities = auth.getAuthorities(); // è·å–æƒé™
            
            return ResponseEntity.ok(new UserProfile(username, authorities));
        }
        
        return ResponseEntity.status(401).body("æœªç™»å½•");
    }
}
```

### 3.3 TokenéªŒè¯æµç¨‹å›¾


```
HTTPè¯·æ±‚æºå¸¦Token
        â†“
JwtAuthenticationFilteræ‹¦æˆª
        â†“
ä»Headeræå–Token
        â†“
Tokenå­˜åœ¨ï¼Ÿ â”€â”€Noâ”€â”€> ç»§ç»­æ‰§è¡Œ(åŒ¿åç”¨æˆ·)
   â†“ Yes
è§£æTokenè·å–ç”¨æˆ·å
        â†“
Tokenæœ‰æ•ˆï¼Ÿ â”€â”€Noâ”€â”€> ç»§ç»­æ‰§è¡Œ(è®¤è¯å¤±è´¥)
   â†“ Yes
åˆ›å»ºAuthenticationå¯¹è±¡
        â†“
è®¾ç½®åˆ°SecurityContext
        â†“
ç»§ç»­æ‰§è¡Œåç»­é€»è¾‘
```

---

## 4. ğŸ‘¥ åŸºäºè§’è‰²çš„æƒé™æ§åˆ¶


### 4.1 ç”¨æˆ·è§’è‰²æ¨¡å‹è®¾è®¡


> ğŸ’¡ **ç†è§£**: RBACå°±åƒå…¬å¸çš„èŒä½ä½“ç³»ï¼Œä¸åŒèŒä½æœ‰ä¸åŒçš„æƒé™

```java
// ç”¨æˆ·å®ä½“
@Entity
public class User {
    private Long id;
    private String username;
    private String password;
    
    // ç”¨æˆ·å¯ä»¥æœ‰å¤šä¸ªè§’è‰²
    @ManyToMany(fetch = FetchType.EAGER)
    private Set<Role> roles = new HashSet<>();
}

// è§’è‰²å®ä½“  
@Entity
public class Role {
    private Long id;
    private String name; // ROLE_ADMIN, ROLE_USER, ROLE_MANAGER
    
    // è§’è‰²å¯ä»¥æœ‰å¤šä¸ªæƒé™
    @ManyToMany(fetch = FetchType.EAGER)
    private Set<Permission> permissions = new HashSet<>();
}

// æƒé™å®ä½“
@Entity  
public class Permission {
    private Long id;
    private String name; // READ_USER, WRITE_USER, DELETE_USER
    private String description;
}
```

### 4.2 æƒé™è§’è‰²å¯¹åº”è¡¨


| è§’è‰² | æƒé™ | è¯´æ˜ |
|-----|------|------|
| **ADMIN** | `å…¨éƒ¨æƒé™` | `è¶…çº§ç®¡ç†å‘˜ï¼Œå¯ä»¥åšä»»ä½•æ“ä½œ` |
| **MANAGER** | `READ_USER, WRITE_USER` | `éƒ¨é—¨ç»ç†ï¼Œå¯ä»¥æŸ¥çœ‹å’Œç¼–è¾‘ç”¨æˆ·` |
| **USER** | `READ_USER` | `æ™®é€šç”¨æˆ·ï¼Œåªèƒ½æŸ¥çœ‹åŸºæœ¬ä¿¡æ¯` |
| **GUEST** | `æ— æƒé™` | `è®¿å®¢ï¼Œåªèƒ½è®¿é—®å…¬å¼€å†…å®¹` |

### 4.3 UserDetailsServiceå®ç°


> ğŸ” **ä½œç”¨**: è¿™ä¸ªæœåŠ¡è´Ÿè´£ä»æ•°æ®åº“åŠ è½½ç”¨æˆ·ä¿¡æ¯å’Œæƒé™

```java
@Service
public class CustomUserDetailsService implements UserDetailsService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        // ä»æ•°æ®åº“æŸ¥æ‰¾ç”¨æˆ·
        User user = userRepository.findByUsername(username);
        if (user == null) {
            throw new UsernameNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨: " + username);
        }
        
        // æ„å»ºç”¨æˆ·æƒé™åˆ—è¡¨
        Set<GrantedAuthority> authorities = new HashSet<>();
        
        // æ·»åŠ è§’è‰²æƒé™(è§’è‰²åå¿…é¡»ä»¥ROLE_å¼€å¤´)
        user.getRoles().forEach(role -> {
            authorities.add(new SimpleGrantedAuthority(role.getName()));
            
            // æ·»åŠ å…·ä½“æƒé™
            role.getPermissions().forEach(permission -> {
                authorities.add(new SimpleGrantedAuthority(permission.getName()));
            });
        });
        
        // è¿”å›Spring Securityçš„Userå¯¹è±¡
        return new org.springframework.security.core.userdetails.User(
            user.getUsername(),
            user.getPassword(),
            authorities
        );
    }
}
```

### 4.4 æƒé™æ§åˆ¶å®ç°


```java
@RestController
@RequestMapping("/api")
public class AdminController {
    
    /**
     * åªæœ‰ADMINè§’è‰²å¯ä»¥è®¿é—®
     */
    @GetMapping("/admin/users")
    @PreAuthorize("hasRole('ADMIN')")
    public List<User> getAllUsers() {
        return userService.findAll();
    }
    
    /**
     * ADMINæˆ–MANAGERè§’è‰²å¯ä»¥è®¿é—®
     */
    @PostMapping("/admin/users")
    @PreAuthorize("hasRole('ADMIN') or hasRole('MANAGER')")
    public User createUser(@RequestBody User user) {
        return userService.save(user);
    }
    
    /**
     * éœ€è¦ç‰¹å®šæƒé™æ‰èƒ½è®¿é—®
     */
    @DeleteMapping("/admin/users/{id}")
    @PreAuthorize("hasAuthority('DELETE_USER')")
    public ResponseEntity<?> deleteUser(@PathVariable Long id) {
        userService.deleteById(id);
        return ResponseEntity.ok("åˆ é™¤æˆåŠŸ");
    }
    
    /**
     * ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„ä¿¡æ¯
     */
    @GetMapping("/user/profile")
    @PreAuthorize("authentication.name == #username")
    public User getUserProfile(@RequestParam String username) {
        return userService.findByUsername(username);
    }
}
```

---

## 5. ğŸš€ æ— çŠ¶æ€å®‰å…¨æ¶æ„å®æˆ˜é…ç½®


### 5.1 Spring Securityé…ç½®ç±»


> ğŸ’¡ **æ ¸å¿ƒæ€æƒ³**: æ— çŠ¶æ€æ„å‘³ç€æœåŠ¡å™¨ä¸ä¿å­˜ç”¨æˆ·ç™»å½•çŠ¶æ€ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½è¦éªŒè¯JWT

```java
@Configuration
@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled = true) // å¯ç”¨æ–¹æ³•çº§æƒé™æ§åˆ¶
public class SecurityConfig {
    
    @Autowired
    private CustomUserDetailsService userDetailsService;
    
    @Autowired
    private JwtAuthenticationFilter jwtAuthenticationFilter;
    
    /**
     * å¯†ç ç¼–ç å™¨é…ç½®
     */
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
    
    /**
     * è®¤è¯ç®¡ç†å™¨é…ç½®
     */
    @Bean
    public AuthenticationManager authenticationManager(
            AuthenticationConfiguration config) throws Exception {
        return config.getAuthenticationManager();
    }
    
    /**
     * å®‰å…¨è¿‡æ»¤å™¨é“¾é…ç½® - æ ¸å¿ƒé…ç½®
     */
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            // ç¦ç”¨CSRF(è·¨ç«™è¯·æ±‚ä¼ªé€ ä¿æŠ¤) - JWTä¸éœ€è¦
            .csrf(csrf -> csrf.disable())
            
            // ç¦ç”¨Session - å®ç°æ— çŠ¶æ€
            .sessionManagement(session -> 
                session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
            
            // é…ç½®è¯·æ±‚æƒé™
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/auth/login", "/auth/register").permitAll() // ç™»å½•æ³¨å†Œå…¬å¼€
                .requestMatchers("/api/admin/**").hasRole("ADMIN")             // ç®¡ç†å‘˜æ¥å£
                .requestMatchers("/api/user/**").hasAnyRole("USER", "ADMIN")   // ç”¨æˆ·æ¥å£
                .anyRequest().authenticated()                                   // å…¶ä»–è¯·æ±‚éœ€è¦è®¤è¯
            )
            
            // æ·»åŠ JWTè¿‡æ»¤å™¨
            .addFilterBefore(jwtAuthenticationFilter, UsernamePasswordAuthenticationFilter.class)
            
            // é…ç½®å¼‚å¸¸å¤„ç†
            .exceptionHandling(ex -> ex
                .authenticationEntryPoint(new JwtAuthenticationEntryPoint())   // è®¤è¯å¤±è´¥å¤„ç†
                .accessDeniedHandler(new JwtAccessDeniedHandler())             // æƒé™ä¸è¶³å¤„ç†
            );
            
        return http.build();
    }
}
```

### 5.2 JWTå¼‚å¸¸å¤„ç†å™¨


```java
/**
 * JWTè®¤è¯å¤±è´¥å¤„ç†å™¨
 */
@Component
public class JwtAuthenticationEntryPoint implements AuthenticationEntryPoint {
    
    @Override
    public void commence(HttpServletRequest request, 
                        HttpServletResponse response,
                        AuthenticationException authException) throws IOException {
        
        response.setContentType("application/json;charset=UTF-8");
        response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
        
        Map<String, Object> result = new HashMap<>();
        result.put("code", 401);
        result.put("message", "æœªç™»å½•æˆ–Tokenå·²è¿‡æœŸ");
        result.put("data", null);
        
        ObjectMapper mapper = new ObjectMapper();
        response.getWriter().write(mapper.writeValueAsString(result));
    }
}

/**
 * JWTæƒé™ä¸è¶³å¤„ç†å™¨  
 */
@Component
public class JwtAccessDeniedHandler implements AccessDeniedHandler {
    
    @Override
    public void handle(HttpServletRequest request,
                      HttpServletResponse response, 
                      AccessDeniedException accessDeniedException) throws IOException {
        
        response.setContentType("application/json;charset=UTF-8");
        response.setStatus(HttpServletResponse.SC_FORBIDDEN);
        
        Map<String, Object> result = new HashMap<>();
        result.put("code", 403);
        result.put("message", "æƒé™ä¸è¶³ï¼Œè®¿é—®è¢«æ‹’ç»");
        result.put("data", null);
        
        ObjectMapper mapper = new ObjectMapper();
        response.getWriter().write(mapper.writeValueAsString(result));
    }
}
```

### 5.3 æ— çŠ¶æ€æ¶æ„ä¼˜åŠ¿å¯¹æ¯”


| ç‰¹æ€§ | **ä¼ ç»ŸSession** | **JWTæ— çŠ¶æ€** |
|------|----------------|---------------|
| **æœåŠ¡å™¨å­˜å‚¨** | `éœ€è¦å­˜å‚¨Session` | `ä¸éœ€è¦å­˜å‚¨çŠ¶æ€` |
| **æ‰©å±•æ€§** | `éš¾ä»¥æ°´å¹³æ‰©å±•` | `æ˜“äºæ°´å¹³æ‰©å±•` |
| **è·¨åŸŸæ”¯æŒ** | `éœ€è¦ç‰¹æ®Šå¤„ç†` | `å¤©ç„¶æ”¯æŒè·¨åŸŸ` |
| **ç§»åŠ¨ç«¯å‹å¥½** | `Cookieæœºåˆ¶é™åˆ¶` | `Headeræºå¸¦çµæ´»` |
| **æœåŠ¡å™¨å‹åŠ›** | `å†…å­˜å ç”¨è¾ƒå¤§` | `å†…å­˜å ç”¨å¾ˆå°` |

### 5.4 å®Œæ•´çš„é…ç½®ç¤ºä¾‹


```java
// åº”ç”¨å¯åŠ¨ç±»
@SpringBootApplication
public class SecurityJwtApplication {
    public static void main(String[] args) {
        SpringApplication.run(SecurityJwtApplication.class, args);
    }
}

// é…ç½®æ–‡ä»¶ application.yml
server:
  port: 8080

spring:
  datasource:
    url: jdbc:mysql://localhost:3306/security_demo
    username: root
    password: password
  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true

# JWTé…ç½®
jwt:
  secret: mySecretKey123456789  # JWTç­¾åå¯†é’¥
  expiration: 86400            # Tokenè¿‡æœŸæ—¶é—´(ç§’)
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ JWTé›†æˆåŸç†ï¼šSpring Security + JWT = æ— çŠ¶æ€è®¤è¯æ¶æ„
ğŸ”¸ ç™»å½•æµç¨‹ï¼šéªŒè¯ç”¨æˆ· â†’ ç”ŸæˆJWT â†’ è¿”å›Token
ğŸ”¸ TokenéªŒè¯ï¼šæ¯æ¬¡è¯·æ±‚ â†’ è§£æJWT â†’ è®¾ç½®å®‰å…¨ä¸Šä¸‹æ–‡  
ğŸ”¸ æƒé™æ§åˆ¶ï¼šåŸºäºè§’è‰²å’Œæƒé™çš„ç»†ç²’åº¦è®¿é—®æ§åˆ¶
ğŸ”¸ æ— çŠ¶æ€ç‰¹æ€§ï¼šæœåŠ¡å™¨ä¸ä¿å­˜ç”¨æˆ·çŠ¶æ€ï¼Œä¾èµ–JWTæ‰¿è½½ä¿¡æ¯
```

### 6.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆé€‰æ‹©JWT + Spring Security**
```
ä¼ ç»Ÿé—®é¢˜ï¼š
- Sessionå­˜å‚¨å ç”¨æœåŠ¡å™¨å†…å­˜
- é›†ç¾¤éƒ¨ç½²éœ€è¦Sessionå…±äº«
- ç§»åŠ¨ç«¯Cookieæœºåˆ¶ä¸å‹å¥½

JWTè§£å†³æ–¹æ¡ˆï¼š
- Tokenè‡ªåŒ…å«ç”¨æˆ·ä¿¡æ¯
- æœåŠ¡å™¨å®Œå…¨æ— çŠ¶æ€
- å¤©ç„¶æ”¯æŒåˆ†å¸ƒå¼å’Œè·¨åŸŸ
```

**ğŸ”¹ å®‰å…¨ä¸Šä¸‹æ–‡çš„ä½œç”¨**
```
SecurityContextå°±åƒä¸€ä¸ª"ä¸´æ—¶èº«ä»½è¯"ï¼š
- å­˜å‚¨å½“å‰è¯·æ±‚çš„ç”¨æˆ·ä¿¡æ¯
- åç»­ä¸šåŠ¡é€»è¾‘å¯ä»¥ç›´æ¥ä½¿ç”¨
- è¯·æ±‚ç»“æŸåè‡ªåŠ¨æ¸…ç†
```

**ğŸ”¹ æƒé™æ§åˆ¶çš„å±‚æ¬¡**
```
URLçº§åˆ«ï¼šåœ¨SecurityConfigä¸­é…ç½®è·¯å¾„æƒé™
æ–¹æ³•çº§åˆ«ï¼šä½¿ç”¨@PreAuthorizeæ³¨è§£æ§åˆ¶æ–¹æ³•æƒé™  
æ•°æ®çº§åˆ«ï¼šåœ¨ä¸šåŠ¡é€»è¾‘ä¸­æ§åˆ¶æ•°æ®è®¿é—®æƒé™
```

### 6.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ é€‚ç”¨åœºæ™¯**
- âœ… **å‰åç«¯åˆ†ç¦»é¡¹ç›®**ï¼šAPIæ¥å£è®¤è¯
- âœ… **å¾®æœåŠ¡æ¶æ„**ï¼šæœåŠ¡é—´æ— çŠ¶æ€è®¤è¯  
- âœ… **ç§»åŠ¨åº”ç”¨**ï¼šAppç™»å½•è®¤è¯
- âœ… **è·¨åŸŸåº”ç”¨**ï¼šå¤šåŸŸåç»Ÿä¸€è®¤è¯

**ğŸ”§ æœ€ä½³å®è·µ**  
```
å®‰å…¨å»ºè®®ï¼š
- JWTå¯†é’¥è¦è¶³å¤Ÿå¤æ‚ä¸”å®šæœŸæ›´æ¢
- Tokenè¿‡æœŸæ—¶é—´ä¸å®œå¤ªé•¿(å»ºè®®24å°æ—¶å†…)
- æ•æ„Ÿæ“ä½œéœ€è¦é¢å¤–éªŒè¯
- å®ç°Tokenåˆ·æ–°æœºåˆ¶

æ€§èƒ½ä¼˜åŒ–ï¼š
- ç”¨æˆ·æƒé™ä¿¡æ¯å¯ä»¥ç¼“å­˜
- JWTè§£æç»“æœå¯ä»¥ç¼“å­˜
- æ•°æ®åº“æŸ¥è¯¢è¦å»ºç«‹ç´¢å¼•
```

**ğŸ’¡ æ ¸å¿ƒè®°å¿†**
- JWT + Spring Security = ç°ä»£åŒ–æ— çŠ¶æ€è®¤è¯
- ç™»å½•ç”ŸæˆTokenï¼Œæ¯æ¬¡è¯·æ±‚éªŒè¯Token
- SecurityContextæ‰¿è½½ç”¨æˆ·èº«ä»½ä¿¡æ¯
- åŸºäºè§’è‰²å’Œæƒé™çš„ç»†ç²’åº¦æ§åˆ¶
- æ— çŠ¶æ€æ¶æ„å¤©ç„¶æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²