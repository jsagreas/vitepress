---
title: 9ã€SSOä¸JWTå®æˆ˜åº”ç”¨
---
## ğŸ“š ç›®å½•

1. [JWTåœ¨SSOä¸­çš„åº”ç”¨ä¼˜åŠ¿](#1-jwtåœ¨ssoä¸­çš„åº”ç”¨ä¼˜åŠ¿)
2. [JWTç»“æ„ä¸ç­¾åæ ¡éªŒ](#2-jwtç»“æ„ä¸ç­¾åæ ¡éªŒ)
3. [ç”Ÿæˆã€é¢å‘ä¸è§£æJWT](#3-ç”Ÿæˆé¢å‘ä¸è§£æjwt)
4. [æ— çŠ¶æ€SSOæ¶æ„ä¸‹çš„åˆ·æ–°Tokenæœºåˆ¶](#4-æ— çŠ¶æ€ssoæ¶æ„ä¸‹çš„åˆ·æ–°tokenæœºåˆ¶)
5. [ç»“åˆRediså®ç°Tokené»‘åå•](#5-ç»“åˆrediså®ç°tokené»‘åå•)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ JWTåœ¨SSOä¸­çš„åº”ç”¨ä¼˜åŠ¿


### 1.1 ä»€ä¹ˆæ˜¯SSOå•ç‚¹ç™»å½•


**ğŸ’¡ é€šä¿—ç†è§£**
æƒ³è±¡ä½ åœ¨ä¸€ä¸ªå¤§å‹å•†åœºé‡Œï¼Œæ‰‹é‡Œæœ‰ä¸€å¼ VIPå¡ã€‚æœ‰äº†è¿™å¼ å¡ï¼Œä½ å¯ä»¥ï¼š
- è¿›å…¥å•†åœºå†…ä»»ä½•ä¸€å®¶åº—é“º
- ä¸ç”¨æ¯å®¶åº—éƒ½é‡æ–°éªŒè¯èº«ä»½
- ä¸€æ¬¡éªŒè¯ï¼Œåˆ°å¤„é€šè¡Œ

```
ä¼ ç»Ÿå¤šç³»ç»Ÿç™»å½•ï¼š        SSOå•ç‚¹ç™»å½•ï¼š
ç”¨æˆ· â†’ ç³»ç»ŸA (ç™»å½•)     ç”¨æˆ· â†’ è®¤è¯ä¸­å¿ƒ (ä¸€æ¬¡ç™»å½•)
ç”¨æˆ· â†’ ç³»ç»ŸB (å†ç™»å½•)      â†“
ç”¨æˆ· â†’ ç³»ç»ŸC (åˆç™»å½•)    ç³»ç»ŸAã€Bã€C (è‡ªåŠ¨ä¿¡ä»»)
```

**ğŸ”‘ SSOçš„æ ¸å¿ƒä½œç”¨**
- **ä¸€æ¬¡ç™»å½•ï¼Œå¤„å¤„é€šè¡Œ**ï¼šç™»å½•ä¸€ä¸ªç³»ç»Ÿï¼Œå…¶ä»–ç³»ç»Ÿè‡ªåŠ¨ä¿¡ä»»
- **ç»Ÿä¸€èº«ä»½ç®¡ç†**ï¼šæ‰€æœ‰ç³»ç»Ÿçš„ç”¨æˆ·ä¿¡æ¯é›†ä¸­ç®¡ç†
- **æå‡ç”¨æˆ·ä½“éªŒ**ï¼šé¿å…é‡å¤è¾“å…¥è´¦å·å¯†ç 

### 1.2 ä¸ºä»€ä¹ˆé€‰æ‹©JWTåšSSO


**ğŸš€ JWTçš„å¤©ç„¶ä¼˜åŠ¿**

**æ— çŠ¶æ€ç‰¹æ€§**
```
ä¼ ç»ŸSessionæ–¹å¼ï¼š
ç”¨æˆ·ç™»å½• â†’ æœåŠ¡å™¨å­˜å‚¨Session â†’ å¤šå°æœåŠ¡å™¨éœ€è¦å…±äº«SessionçŠ¶æ€

JWTæ–¹å¼ï¼š
ç”¨æˆ·ç™»å½• â†’ ç”ŸæˆJWT â†’ ç”¨æˆ·æºå¸¦JWT â†’ æœåŠ¡å™¨ç›´æ¥éªŒè¯ï¼ˆæ— éœ€å­˜å‚¨ï¼‰
```

**è·¨åŸŸå‹å¥½**
```
åŒåŸŸåSessionï¼šåªèƒ½åœ¨ç›¸åŒåŸŸåä¸‹ä½¿ç”¨
JWT Tokenï¼šå¯ä»¥è·¨åŸŸåã€è·¨ç³»ç»Ÿä½¿ç”¨
```

**æ‰©å±•æ€§å¼º**
```
é›†ç¾¤éƒ¨ç½²æ—¶ï¼š
Sessionéœ€è¦ï¼šRedisé›†ç¾¤ + SessionåŒæ­¥
JWTåªéœ€è¦ï¼šç›¸åŒçš„å¯†é’¥éªŒè¯
```

### 1.3 JWT-SSOæ¶æ„å›¾è§£


```
æ•´ä½“æ¶æ„æµç¨‹ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â‘ ç™»å½•è¯·æ±‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·æµè§ˆå™¨  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚  è®¤è¯ä¸­å¿ƒ(CAS)   â”‚
â”‚             â”‚                 â”‚                â”‚
â”‚             â”‚ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ ãƒ»éªŒè¯ç”¨æˆ·åå¯†ç   â”‚
â”‚             â”‚    â‘¡è¿”å›JWT      â”‚ ãƒ»ç”ŸæˆJWT Token â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                  â”‚
       â”‚â‘¢æºå¸¦JWTè®¿é—®                       â”‚â‘£å¯†é’¥æ ¡éªŒ
       â†“                                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    JWTéªŒè¯      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä¸šåŠ¡ç³»ç»ŸA  â”‚ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚   ä¸šåŠ¡ç³»ç»ŸB     â”‚
â”‚ ãƒ»æ ¡éªŒJWTæœ‰æ•ˆæ€§â”‚                 â”‚ ãƒ»æ ¡éªŒJWTæœ‰æ•ˆæ€§   â”‚
â”‚ ãƒ»è§£æç”¨æˆ·ä¿¡æ¯â”‚                 â”‚ ãƒ»è§£æç”¨æˆ·ä¿¡æ¯    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”¸ å…³é”®ä¼˜åŠ¿å¯¹æ¯”**

| ç‰¹æ€§ | **ä¼ ç»ŸSession-SSO** | **JWT-SSO** |
|------|-------------------|------------|
| **çŠ¶æ€å­˜å‚¨** | `æœåŠ¡å™¨ç«¯å­˜å‚¨Session` | `å®¢æˆ·ç«¯å­˜å‚¨Token` |
| **æ‰©å±•æ€§** | `éœ€è¦Sessionå…±äº«æœºåˆ¶` | `æ— çŠ¶æ€ï¼Œå¤©ç„¶æ”¯æŒé›†ç¾¤` |
| **è·¨åŸŸæ”¯æŒ** | `å—åŒæºç­–ç•¥é™åˆ¶` | `åŸç”Ÿæ”¯æŒè·¨åŸŸ` |
| **æœåŠ¡å™¨å‹åŠ›** | `éœ€è¦å­˜å‚¨å¤§é‡Session` | `åªéœ€éªŒè¯ï¼Œæ— å­˜å‚¨å‹åŠ›` |
| **å®‰å…¨æ€§** | `æœåŠ¡å™¨æ§åˆ¶ï¼Œç›¸å¯¹å®‰å…¨` | `éœ€è¦å¦¥å–„ä¿ç®¡å¯†é’¥` |

---

## 2. ğŸ” JWTç»“æ„ä¸ç­¾åæ ¡éªŒ


### 2.1 JWTçš„ä¸‰æ®µå¼ç»“æ„


**ğŸ“‹ JWTå®Œæ•´æ ¼å¼**
```
å®Œæ•´JWTç¤ºä¾‹ï¼š
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c

ç»“æ„åˆ†è§£ï¼š
Header.Payload.Signature
  â‘      â‘¡      â‘¢
```

### 2.2 Headerï¼ˆå¤´éƒ¨ï¼‰è¯¦è§£


**ğŸ”§ Headerå†…å®¹ç»“æ„**
```json
{
  "alg": "HS256",     // ç­¾åç®—æ³•
  "typ": "JWT"        // Tokenç±»å‹
}
```

**å¸¸ç”¨ç­¾åç®—æ³•**
```
å¯¹ç§°åŠ å¯†ç®—æ³•ï¼š
ãƒ»HS256ï¼šHMAC + SHA256ï¼Œå¯†é’¥ç›¸åŒ
ãƒ»HS384ï¼šHMAC + SHA384
ãƒ»HS512ï¼šHMAC + SHA512

éå¯¹ç§°åŠ å¯†ç®—æ³•ï¼š
ãƒ»RS256ï¼šRSA + SHA256ï¼Œå…¬ç§é’¥å¯¹
ãƒ»ES256ï¼šECDSA + SHA256
```

### 2.3 Payloadï¼ˆè´Ÿè½½ï¼‰è¯¦è§£


**ğŸ“¦ Payloadæ ‡å‡†å­—æ®µ**
```json
{
  // æ ‡å‡†å£°æ˜(Registered Claims)
  "iss": "auth-server",        // å‘è¡Œè€…
  "sub": "user123",            // ä¸»é¢˜(ç”¨æˆ·ID)
  "aud": "my-app",            // å—ä¼—(å“ªä¸ªåº”ç”¨)
  "exp": 1735689600,          // è¿‡æœŸæ—¶é—´(æ—¶é—´æˆ³)
  "iat": 1735603200,          // ç­¾å‘æ—¶é—´
  "nbf": 1735603200,          // ç”Ÿæ•ˆæ—¶é—´
  
  // è‡ªå®šä¹‰å£°æ˜(Private Claims)
  "username": "john.doe",      // ç”¨æˆ·å
  "roles": ["admin", "user"],  // ç”¨æˆ·è§’è‰²
  "permissions": ["read", "write"] // æƒé™åˆ—è¡¨
}
```

**âš ï¸ Payloadå®‰å…¨æ³¨æ„**
> **é‡è¦æé†’**ï¼šPayloadåªæ˜¯Base64ç¼–ç ï¼Œä¸æ˜¯åŠ å¯†ï¼ä»»ä½•äººéƒ½å¯ä»¥è§£ç æŸ¥çœ‹å†…å®¹ã€‚
> 
> âŒ **ä¸è¦å­˜æ”¾**ï¼šå¯†ç ã€é“¶è¡Œå¡å·ã€èº«ä»½è¯å·ç­‰æ•æ„Ÿä¿¡æ¯
> âœ… **å¯ä»¥å­˜æ”¾**ï¼šç”¨æˆ·IDã€ç”¨æˆ·åã€è§’è‰²æƒé™ç­‰éæ•æ„Ÿä¿¡æ¯

### 2.4 Signatureï¼ˆç­¾åï¼‰è¯¦è§£


**ğŸ” ç­¾åç”Ÿæˆè¿‡ç¨‹**
```javascript
// ç­¾åç”Ÿæˆä¼ªä»£ç 
const header = base64url(JSON.stringify({alg: "HS256", typ: "JWT"}))
const payload = base64url(JSON.stringify({sub: "user123", name: "John"}))
const secret = "your-secret-key"

const signature = HMACSHA256(
  header + "." + payload,  // è¦ç­¾åçš„å†…å®¹
  secret                   // å¯†é’¥
)

const jwt = header + "." + payload + "." + base64url(signature)
```

**ğŸ›¡ï¸ ç­¾åæ ¡éªŒæµç¨‹**
```
JWTéªŒè¯æ­¥éª¤ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ”¶åˆ°JWT     â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆ†å‰²ä¸‰ä¸ªéƒ¨åˆ†  â”‚ â† Header.Payload.Signature
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é‡æ–°è®¡ç®—ç­¾å  â”‚ â† HMAC(Header.Payload, å¯†é’¥)
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¯¹æ¯”ç­¾åä¸€è‡´  â”‚ â† æ–°ç­¾å == åŸç­¾åï¼Ÿ
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ£€æŸ¥è¿‡æœŸæ—¶é—´  â”‚ â† exp > å½“å‰æ—¶é—´ï¼Ÿ
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ éªŒè¯é€šè¿‡     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. ğŸ› ï¸ ç”Ÿæˆã€é¢å‘ä¸è§£æJWT


### 3.1 JWTç”Ÿæˆå®ç°


**ğŸ“ Javaç”ŸæˆJWTç¤ºä¾‹**
```java
import io.jsonwebtoken.*;
import java.util.Date;

public class JwtUtils {
    private static final String SECRET = "my-secret-key-2024";
    private static final long EXPIRATION = 24 * 60 * 60 * 1000; // 24å°æ—¶
    
    // ç”ŸæˆJWT
    public static String generateToken(String username, List<String> roles) {
        Date now = new Date();
        Date expiration = new Date(now.getTime() + EXPIRATION);
        
        return Jwts.builder()
            .setSubject(username)                    // ç”¨æˆ·å
            .claim("roles", roles)                   // ç”¨æˆ·è§’è‰²
            .setIssuedAt(now)                        // ç­¾å‘æ—¶é—´
            .setExpiration(expiration)               // è¿‡æœŸæ—¶é—´
            .signWith(SignatureAlgorithm.HS256, SECRET) // ç­¾å
            .compact();
    }
}
```

**ğŸ”„ Node.jsç”ŸæˆJWTç¤ºä¾‹**
```javascript
const jwt = require('jsonwebtoken');

const SECRET = 'my-secret-key-2024';

// ç”ŸæˆJWT
function generateToken(userInfo) {
    const payload = {
        sub: userInfo.userId,
        username: userInfo.username,
        roles: userInfo.roles,
        exp: Math.floor(Date.now() / 1000) + (24 * 60 * 60) // 24å°æ—¶åè¿‡æœŸ
    };
    
    return jwt.sign(payload, SECRET);
}

// ä½¿ç”¨ç¤ºä¾‹
const token = generateToken({
    userId: '12345',
    username: 'john.doe',
    roles: ['user', 'admin']
});
```

### 3.2 SSOç™»å½•æ¥å£å®ç°


**ğŸ” è®¤è¯ä¸­å¿ƒç™»å½•æ¥å£**
```java
@RestController
@RequestMapping("/auth")
public class AuthController {
    
    @PostMapping("/login")
    public ResponseEntity<?> login(@RequestBody LoginRequest request) {
        // 1. éªŒè¯ç”¨æˆ·åå¯†ç 
        User user = userService.authenticate(request.getUsername(), request.getPassword());
        if (user == null) {
            return ResponseEntity.badRequest().body("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
        }
        
        // 2. ç”ŸæˆJWT
        String token = JwtUtils.generateToken(user.getUsername(), user.getRoles());
        
        // 3. è¿”å›Token
        LoginResponse response = new LoginResponse();
        response.setToken(token);
        response.setUsername(user.getUsername());
        response.setExpiresIn(24 * 60 * 60); // 24å°æ—¶
        
        return ResponseEntity.ok(response);
    }
}
```

### 3.3 JWTè§£æéªŒè¯


**ğŸ” Javaè§£æJWT**
```java
public class JwtUtils {
    
    // è§£æJWT
    public static Claims parseToken(String token) {
        try {
            return Jwts.parser()
                .setSigningKey(SECRET)
                .parseClaimsJws(token)
                .getBody();
        } catch (ExpiredJwtException e) {
            throw new RuntimeException("Tokenå·²è¿‡æœŸ");
        } catch (MalformedJwtException e) {
            throw new RuntimeException("Tokenæ ¼å¼é”™è¯¯");
        } catch (SignatureException e) {
            throw new RuntimeException("Tokenç­¾åæ— æ•ˆ");
        }
    }
    
    // è·å–ç”¨æˆ·ä¿¡æ¯
    public static String getUsername(String token) {
        Claims claims = parseToken(token);
        return claims.getSubject();
    }
    
    // æ£€æŸ¥Tokenæ˜¯å¦è¿‡æœŸ
    public static boolean isTokenExpired(String token) {
        Claims claims = parseToken(token);
        return claims.getExpiration().before(new Date());
    }
}
```

### 3.4 ä¸šåŠ¡ç³»ç»ŸJWTéªŒè¯æ‹¦æˆªå™¨


**ğŸ›¡ï¸ Spring Bootæ‹¦æˆªå™¨**
```java
@Component
public class JwtInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler) throws Exception {
        
        // 1. è·å–Token
        String token = request.getHeader("Authorization");
        if (token == null || !token.startsWith("Bearer ")) {
            response.setStatus(401);
            return false;
        }
        
        token = token.substring(7); // å»æ‰"Bearer "
        
        try {
            // 2. éªŒè¯Token
            Claims claims = JwtUtils.parseToken(token);
            
            // 3. å°†ç”¨æˆ·ä¿¡æ¯å­˜å‚¨åˆ°è¯·æ±‚ä¸­
            request.setAttribute("username", claims.getSubject());
            request.setAttribute("roles", claims.get("roles"));
            
            return true;
        } catch (Exception e) {
            response.setStatus(401);
            return false;
        }
    }
}
```

---

## 4. ğŸ”„ æ— çŠ¶æ€SSOæ¶æ„ä¸‹çš„åˆ·æ–°Tokenæœºåˆ¶


### 4.1 ä¸ºä»€ä¹ˆéœ€è¦åˆ·æ–°Token


**â° Tokenè¿‡æœŸé—®é¢˜**
```
é—®é¢˜åœºæ™¯ï¼š
ç”¨æˆ·ä¸Šåˆ9ç‚¹ç™»å½• â†’ JWTæœ‰æ•ˆæœŸ24å°æ—¶ â†’ ç¬¬äºŒå¤©9ç‚¹è‡ªåŠ¨è¿‡æœŸ
ç»“æœï¼šç”¨æˆ·æ­£åœ¨ä½¿ç”¨ç³»ç»Ÿæ—¶çªç„¶éœ€è¦é‡æ–°ç™»å½•ï¼Œä½“éªŒæå·®

è§£å†³æ–¹æ¡ˆï¼š
çŸ­æœŸToken + é•¿æœŸåˆ·æ–°Token = å¹³è¡¡å®‰å…¨æ€§ä¸ç”¨æˆ·ä½“éªŒ
```

**ğŸ¯ åŒTokenç­–ç•¥**
- **Access Token**ï¼šçŸ­æœŸæœ‰æ•ˆï¼ˆ30åˆ†é’Ÿ-2å°æ—¶ï¼‰ï¼Œç”¨äºAPIè®¿é—®
- **Refresh Token**ï¼šé•¿æœŸæœ‰æ•ˆï¼ˆ7-30å¤©ï¼‰ï¼Œç”¨äºè·å–æ–°çš„Access Token

### 4.2 åˆ·æ–°Tokenæœºåˆ¶è®¾è®¡


**ğŸ“Š åŒTokenå·¥ä½œæµç¨‹**
```
ç”¨æˆ·ç™»å½•æµç¨‹ï¼š

ç”¨æˆ· â”€â”€ç™»å½•è¯·æ±‚â”€â”€â†’ è®¤è¯ä¸­å¿ƒ
     â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Access Token (30åˆ†é’Ÿ) + Refresh Token (7å¤©)

æ—¥å¸¸ä½¿ç”¨æµç¨‹ï¼š

ç”¨æˆ· â”€â”€APIè¯·æ±‚(Access Token)â”€â”€â†’ ä¸šåŠ¡ç³»ç»Ÿ
     â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ­£å¸¸å“åº”

Tokenå³å°†è¿‡æœŸï¼š

ç”¨æˆ· â”€â”€åˆ·æ–°è¯·æ±‚(Refresh Token)â”€â”€â†’ è®¤è¯ä¸­å¿ƒ
     â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ–°çš„Access Token (30åˆ†é’Ÿ)

Refresh Tokenè¿‡æœŸï¼š

ç”¨æˆ· â”€â”€åˆ·æ–°è¯·æ±‚(è¿‡æœŸRefresh Token)â”€â”€â†’ è®¤è¯ä¸­å¿ƒ
     â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 401é”™è¯¯ï¼Œéœ€è¦é‡æ–°ç™»å½•
```

### 4.3 åˆ·æ–°Tokenå®ç°


**ğŸ”§ ç”ŸæˆåŒToken**
```java
public class TokenService {
    
    public TokenPair generateTokenPair(String username, List<String> roles) {
        Date now = new Date();
        
        // Access Token - 30åˆ†é’Ÿ
        String accessToken = Jwts.builder()
            .setSubject(username)
            .claim("roles", roles)
            .claim("type", "access")
            .setIssuedAt(now)
            .setExpiration(new Date(now.getTime() + 30 * 60 * 1000))
            .signWith(SignatureAlgorithm.HS256, ACCESS_SECRET)
            .compact();
        
        // Refresh Token - 7å¤©
        String refreshToken = Jwts.builder()
            .setSubject(username)
            .claim("type", "refresh")
            .setIssuedAt(now)
            .setExpiration(new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000))
            .signWith(SignatureAlgorithm.HS256, REFRESH_SECRET)
            .compact();
        
        return new TokenPair(accessToken, refreshToken);
    }
}
```

**ğŸ”„ åˆ·æ–°Tokenæ¥å£**
```java
@PostMapping("/refresh")
public ResponseEntity<?> refreshToken(@RequestBody RefreshRequest request) {
    try {
        // 1. éªŒè¯Refresh Token
        Claims claims = Jwts.parser()
            .setSigningKey(REFRESH_SECRET)
            .parseClaimsJws(request.getRefreshToken())
            .getBody();
        
        if (!"refresh".equals(claims.get("type"))) {
            return ResponseEntity.badRequest().body("Tokenç±»å‹é”™è¯¯");
        }
        
        // 2. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä»ç„¶æœ‰æ•ˆ
        String username = claims.getSubject();
        User user = userService.findByUsername(username);
        if (user == null || !user.isActive()) {
            return ResponseEntity.badRequest().body("ç”¨æˆ·å·²å¤±æ•ˆ");
        }
        
        // 3. ç”Ÿæˆæ–°çš„Access Token
        String newAccessToken = generateAccessToken(username, user.getRoles());
        
        RefreshResponse response = new RefreshResponse();
        response.setAccessToken(newAccessToken);
        response.setExpiresIn(30 * 60); // 30åˆ†é’Ÿ
        
        return ResponseEntity.ok(response);
        
    } catch (ExpiredJwtException e) {
        return ResponseEntity.status(401).body("Refresh Tokenå·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•");
    }
}
```

### 4.4 å‰ç«¯è‡ªåŠ¨åˆ·æ–°Token


**ğŸ’» JavaScriptè‡ªåŠ¨åˆ·æ–°é€»è¾‘**
```javascript
class TokenManager {
    constructor() {
        this.accessToken = localStorage.getItem('accessToken');
        this.refreshToken = localStorage.getItem('refreshToken');
        this.isRefreshing = false;
    }
    
    // æ£€æŸ¥Tokenæ˜¯å¦å³å°†è¿‡æœŸï¼ˆæå‰5åˆ†é’Ÿåˆ·æ–°ï¼‰
    isTokenExpiringSoon(token) {
        if (!token) return true;
        
        const payload = JSON.parse(atob(token.split('.')[1]));
        const expTime = payload.exp * 1000; // è½¬æ¢ä¸ºæ¯«ç§’
        const now = Date.now();
        
        return (expTime - now) < 5 * 60 * 1000; // 5åˆ†é’Ÿå†…è¿‡æœŸ
    }
    
    // è‡ªåŠ¨åˆ·æ–°Token
    async refreshTokenIfNeeded() {
        if (this.isTokenExpiringSoon(this.accessToken) && !this.isRefreshing) {
            this.isRefreshing = true;
            
            try {
                const response = await fetch('/auth/refresh', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ refreshToken: this.refreshToken })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    this.accessToken = data.accessToken;
                    localStorage.setItem('accessToken', data.accessToken);
                } else {
                    // Refresh Tokenä¹Ÿè¿‡æœŸäº†ï¼Œéœ€è¦é‡æ–°ç™»å½•
                    this.logout();
                }
            } catch (error) {
                console.error('åˆ·æ–°Tokenå¤±è´¥:', error);
                this.logout();
            }
            
            this.isRefreshing = false;
        }
    }
    
    logout() {
        localStorage.removeItem('accessToken');
        localStorage.removeItem('refreshToken');
        window.location.href = '/login';
    }
}

// åœ¨æ¯æ¬¡APIè¯·æ±‚å‰è‡ªåŠ¨æ£€æŸ¥
const tokenManager = new TokenManager();
setInterval(() => {
    tokenManager.refreshTokenIfNeeded();
}, 60000); // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
```

---

## 5. ğŸ—ƒï¸ ç»“åˆRediså®ç°Tokené»‘åå•


### 5.1 ä¸ºä»€ä¹ˆéœ€è¦Tokené»‘åå•


**ğŸš« æ— çŠ¶æ€JWTçš„å®‰å…¨é—®é¢˜**
```
é—®é¢˜åœºæ™¯ï¼š
ç”¨æˆ·é€€å‡ºç™»å½• â†’ JWTä»ç„¶æœ‰æ•ˆ â†’ å¦‚æœJWTè¢«æ³„éœ²ä»å¯ä½¿ç”¨

ä¼ ç»Ÿè§£å†³æ–¹æ¡ˆå›°éš¾ï¼š
JWTè®¾è®¡ä¸ºæ— çŠ¶æ€ â†’ æœåŠ¡å™¨ä¸å­˜å‚¨TokençŠ¶æ€ â†’ æ— æ³•"åºŸé™¤"å·²å‘å‡ºçš„Token

å®é™…éœ€æ±‚ï¼š
1. ç”¨æˆ·ä¸»åŠ¨é€€å‡ºç™»å½•
2. ç®¡ç†å‘˜å¼ºåˆ¶ç”¨æˆ·ä¸‹çº¿
3. ç”¨æˆ·å¯†ç è¢«ä¿®æ”¹
4. å‘ç°Tokenæ³„éœ²
```

### 5.2 Redisé»‘åå•è®¾è®¡æ–¹æ¡ˆ


**ğŸ”§ é»‘åå•æ•°æ®ç»“æ„**
```
Rediså­˜å‚¨æ–¹æ¡ˆï¼š

æ–¹æ¡ˆ1ï¼šå­˜å‚¨å®Œæ•´Token
key: "blacklist:token:" + token_hash
value: "1"
TTL: tokenå‰©ä½™è¿‡æœŸæ—¶é—´

æ–¹æ¡ˆ2ï¼šå­˜å‚¨Token IDï¼ˆæ¨èï¼‰
key: "blacklist:jti:" + jti
value: user_id
TTL: tokenå‰©ä½™è¿‡æœŸæ—¶é—´

ä¼˜åŠ¿å¯¹æ¯”ï¼š
æ–¹æ¡ˆ1ï¼šç®€å•ç›´è§‚ï¼Œä½†å­˜å‚¨ç©ºé—´å¤§
æ–¹æ¡ˆ2ï¼šèŠ‚çœç©ºé—´ï¼Œéœ€è¦åœ¨JWTä¸­æ·»åŠ jtiå­—æ®µ
```

### 5.3 Tokené»‘åå•å®ç°


**ğŸ“ æ·»åŠ JTIåˆ°JWT**
```java
public class JwtUtils {
    
    // ç”Ÿæˆå¸¦JTIçš„JWT
    public static String generateTokenWithJti(String username, List<String> roles) {
        Date now = new Date();
        Date expiration = new Date(now.getTime() + EXPIRATION);
        String jti = UUID.randomUUID().toString(); // å”¯ä¸€Token ID
        
        return Jwts.builder()
            .setSubject(username)
            .setId(jti)                              // è®¾ç½®Token ID
            .claim("roles", roles)
            .setIssuedAt(now)
            .setExpiration(expiration)
            .signWith(SignatureAlgorithm.HS256, SECRET)
            .compact();
    }
}
```

**ğŸ—ƒï¸ Redisé»‘åå•æœåŠ¡**
```java
@Service
public class TokenBlacklistService {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    // å°†TokenåŠ å…¥é»‘åå•
    public void addToBlacklist(String token) {
        try {
            Claims claims = JwtUtils.parseToken(token);
            String jti = claims.getId();
            
            if (jti != null) {
                // è®¡ç®—Tokenå‰©ä½™è¿‡æœŸæ—¶é—´
                Date expiration = claims.getExpiration();
                long ttl = expiration.getTime() - System.currentTimeMillis();
                
                if (ttl > 0) {
                    String key = "blacklist:jti:" + jti;
                    redisTemplate.opsForValue().set(key, claims.getSubject(), 
                                                  Duration.ofMillis(ttl));
                }
            }
        } catch (Exception e) {
            log.error("åŠ å…¥é»‘åå•å¤±è´¥", e);
        }
    }
    
    // æ£€æŸ¥Tokenæ˜¯å¦åœ¨é»‘åå•ä¸­
    public boolean isBlacklisted(String token) {
        try {
            Claims claims = JwtUtils.parseToken(token);
            String jti = claims.getId();
            
            if (jti != null) {
                String key = "blacklist:jti:" + jti;
                return redisTemplate.hasKey(key);
            }
            return false;
        } catch (Exception e) {
            return true; // è§£æå¤±è´¥è®¤ä¸ºæ˜¯æ— æ•ˆToken
        }
    }
    
    // ç”¨æˆ·é€€å‡ºæ—¶å°†æ‰€æœ‰TokenåŠ å…¥é»‘åå•
    public void blacklistUserTokens(String username) {
        // å¯ä»¥åœ¨ç”¨æˆ·ç™»å½•æ—¶è®°å½•æ‰€æœ‰activeçš„jti
        // é€€å‡ºæ—¶æ‰¹é‡åŠ å…¥é»‘åå•
        Set<String> userTokens = getUserActiveTokens(username);
        for (String jti : userTokens) {
            String key = "blacklist:jti:" + jti;
            redisTemplate.opsForValue().set(key, username, Duration.ofDays(1));
        }
    }
}
```

### 5.4 é›†æˆé»‘åå•éªŒè¯


**ğŸ›¡ï¸ å¢å¼ºç‰ˆJWTæ‹¦æˆªå™¨**
```java
@Component
public class EnhancedJwtInterceptor implements HandlerInterceptor {
    
    @Autowired
    private TokenBlacklistService blacklistService;
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler) throws Exception {
        
        String token = extractToken(request);
        if (token == null) {
            response.setStatus(401);
            return false;
        }
        
        try {
            // 1. åŸºæœ¬JWTéªŒè¯
            Claims claims = JwtUtils.parseToken(token);
            
            // 2. æ£€æŸ¥é»‘åå•
            if (blacklistService.isBlacklisted(token)) {
                response.setStatus(401);
                response.getWriter().write("{\"error\":\"Tokenå·²è¢«æ’¤é”€\"}");
                return false;
            }
            
            // 3. å­˜å‚¨ç”¨æˆ·ä¿¡æ¯
            request.setAttribute("username", claims.getSubject());
            request.setAttribute("jti", claims.getId());
            
            return true;
        } catch (Exception e) {
            response.setStatus(401);
            return false;
        }
    }
}
```

### 5.5 é€€å‡ºç™»å½•å®ç°


**ğŸšª å®Œæ•´é€€å‡ºç™»å½•æ¥å£**
```java
@PostMapping("/logout")
public ResponseEntity<?> logout(HttpServletRequest request) {
    String token = extractToken(request);
    
    if (token != null) {
        // 1. å°†å½“å‰TokenåŠ å…¥é»‘åå•
        blacklistService.addToBlacklist(token);
        
        // 2. å¯é€‰ï¼šå°†ç”¨æˆ·æ‰€æœ‰Tokenéƒ½åŠ å…¥é»‘åå•ï¼ˆå¼ºåˆ¶å…¨è®¾å¤‡ä¸‹çº¿ï¼‰
        try {
            Claims claims = JwtUtils.parseToken(token);
            String username = claims.getSubject();
            // blacklistService.blacklistUserTokens(username);
        } catch (Exception e) {
            // å¿½ç•¥è§£æé”™è¯¯
        }
    }
    
    return ResponseEntity.ok().body("{\"message\":\"é€€å‡ºæˆåŠŸ\"}");
}
```

### 5.6 é»‘åå•æ€§èƒ½ä¼˜åŒ–


**âš¡ ç¼“å­˜å’Œæ‰¹é‡æ“ä½œä¼˜åŒ–**
```java
@Service
public class OptimizedBlacklistService {
    
    // æœ¬åœ°ç¼“å­˜ï¼Œå‡å°‘RedisæŸ¥è¯¢
    private final Cache<String, Boolean> localCache = Caffeine.newBuilder()
        .maximumSize(10000)
        .expireAfterWrite(5, TimeUnit.MINUTES)
        .build();
    
    public boolean isBlacklisted(String token) {
        try {
            Claims claims = JwtUtils.parseToken(token);
            String jti = claims.getId();
            
            if (jti == null) return false;
            
            // 1. å…ˆæŸ¥æœ¬åœ°ç¼“å­˜
            Boolean cached = localCache.getIfPresent(jti);
            if (cached != null) {
                return cached;
            }
            
            // 2. æŸ¥è¯¢Redis
            String key = "blacklist:jti:" + jti;
            boolean blacklisted = redisTemplate.hasKey(key);
            
            // 3. ç¼“å­˜ç»“æœ
            localCache.put(jti, blacklisted);
            
            return blacklisted;
        } catch (Exception e) {
            return true;
        }
    }
    
    // æ‰¹é‡æ£€æŸ¥ï¼ˆé€‚ç”¨äºæ‰¹é‡å¤„ç†åœºæ™¯ï¼‰
    public Map<String, Boolean> isBlacklistedBatch(List<String> jtis) {
        Map<String, Boolean> results = new HashMap<>();
        List<String> toCheck = new ArrayList<>();
        
        // å…ˆæŸ¥æœ¬åœ°ç¼“å­˜
        for (String jti : jtis) {
            Boolean cached = localCache.getIfPresent(jti);
            if (cached != null) {
                results.put(jti, cached);
            } else {
                toCheck.add(jti);
            }
        }
        
        // æ‰¹é‡æŸ¥è¯¢Redis
        if (!toCheck.isEmpty()) {
            List<String> keys = toCheck.stream()
                .map(jti -> "blacklist:jti:" + jti)
                .collect(Collectors.toList());
                
            List<Boolean> exists = redisTemplate.executePipelined((RedisCallback<Object>) connection -> {
                for (String key : keys) {
                    connection.exists(key.getBytes());
                }
                return null;
            });
            
            for (int i = 0; i < toCheck.size(); i++) {
                String jti = toCheck.get(i);
                Boolean blacklisted = exists.get(i);
                results.put(jti, blacklisted);
                localCache.put(jti, blacklisted);
            }
        }
        
        return results;
    }
}
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ SSOæ¦‚å¿µï¼šä¸€æ¬¡ç™»å½•ï¼Œå¤„å¤„é€šè¡Œçš„ç»Ÿä¸€èº«ä»½è®¤è¯æœºåˆ¶
ğŸ”¸ JWTä¼˜åŠ¿ï¼šæ— çŠ¶æ€ã€è·¨åŸŸå‹å¥½ã€æ‰©å±•æ€§å¼ºï¼Œå¤©ç„¶é€‚åˆSSO
ğŸ”¸ JWTç»“æ„ï¼šHeader.Payload.Signatureä¸‰æ®µå¼ï¼Œç­¾åä¿è¯å®Œæ•´æ€§
ğŸ”¸ åŒTokenç­–ç•¥ï¼šçŸ­æœŸAccess Token + é•¿æœŸRefresh Tokenå¹³è¡¡å®‰å…¨ä¸ä½“éªŒ
ğŸ”¸ é»‘åå•æœºåˆ¶ï¼šä½¿ç”¨Rediså®ç°JWTæ’¤é”€ï¼Œè§£å†³æ— çŠ¶æ€çš„å®‰å…¨é—®é¢˜
```

### 6.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ JWTçš„æœ¬è´¨ç†è§£**
```
JWTä¸æ˜¯åŠ å¯†ï¼Œæ˜¯ç­¾åï¼š
- Payloadå†…å®¹å¯è¢«ä»»ä½•äººè§£ç æŸ¥çœ‹
- ç­¾åç¡®ä¿å†…å®¹æ²¡æœ‰è¢«ç¯¡æ”¹
- æœåŠ¡å™¨é€šè¿‡éªŒè¯ç­¾åç¡®è®¤TokençœŸå®æ€§
```

**ğŸ”¹ æ— çŠ¶æ€çš„ä¼˜åŠ¿ä¸æŒ‘æˆ˜**
```
ä¼˜åŠ¿ï¼š
+ æœåŠ¡å™¨æ— éœ€å­˜å‚¨SessionçŠ¶æ€
+ å¤©ç„¶æ”¯æŒåˆ†å¸ƒå¼å’Œé›†ç¾¤éƒ¨ç½²
+ è·¨åŸŸã€è·¨ç³»ç»Ÿä½¿ç”¨æ–¹ä¾¿

æŒ‘æˆ˜ï¼š
- æ— æ³•ä¸»åŠ¨åºŸé™¤å·²å‘å‡ºçš„Token
- Tokenè¿‡æœŸå‰ä¸€ç›´æœ‰æ•ˆï¼Œå­˜åœ¨å®‰å…¨é£é™©
- éœ€è¦é¢å¤–æœºåˆ¶å®ç°Tokenæ’¤é”€
```

**ğŸ”¹ åˆ·æ–°Tokençš„è®¾è®¡æ€æƒ³**
```
å¹³è¡¡ç‚¹ï¼š
å®‰å…¨æ€§ï¼šAccess TokençŸ­æœŸè¿‡æœŸï¼Œé™ä½æ³„éœ²é£é™©
ä½“éªŒæ€§ï¼šRefresh Tokené•¿æœŸæœ‰æ•ˆï¼Œé¿å…é¢‘ç¹ç™»å½•
çµæ´»æ€§ï¼šå¯ç‹¬ç«‹æ’¤é”€ï¼Œç²¾ç»†æ§åˆ¶ç”¨æˆ·ä¼šè¯
```

### 6.3 å®é™…åº”ç”¨æŒ‡å¯¼


**âœ… é€‚ç”¨åœºæ™¯**
- å¾®æœåŠ¡æ¶æ„çš„ç»Ÿä¸€è®¤è¯
- ä¼ä¸šå†…éƒ¨å¤šç³»ç»Ÿå•ç‚¹ç™»å½•
- ç§»åŠ¨ç«¯APIæ¥å£è®¤è¯
- è·¨åŸŸåçš„Webåº”ç”¨é›†æˆ

**âš ï¸ å®‰å…¨æ³¨æ„äº‹é¡¹**
- ä½¿ç”¨HTTPSä¼ è¾“JWT
- å¦¥å–„ä¿ç®¡ç­¾åå¯†é’¥
- è®¾ç½®åˆç†çš„Tokenè¿‡æœŸæ—¶é—´
- æ•æ„Ÿä¿¡æ¯ä¸è¦æ”¾åœ¨Payloadä¸­
- å®æ–½Tokené»‘åå•æœºåˆ¶

**ğŸ”§ æ€§èƒ½ä¼˜åŒ–å»ºè®®**
- ä½¿ç”¨æœ¬åœ°ç¼“å­˜å‡å°‘RedisæŸ¥è¯¢
- æ‰¹é‡éªŒè¯Tokenæé«˜æ•ˆç‡
- åˆç†è®¾ç½®ç¼“å­˜è¿‡æœŸæ—¶é—´
- ç›‘æ§Rediså†…å­˜ä½¿ç”¨æƒ…å†µ

### 6.4 å¸¸è§é—®é¢˜è§£å†³


**â“ JWTæ³„éœ²æ€ä¹ˆåŠï¼Ÿ**
```
ç«‹å³å“åº”æªæ–½ï¼š
1. å°†æ³„éœ²çš„TokenåŠ å…¥é»‘åå•
2. å¼ºåˆ¶ç”¨æˆ·é‡æ–°ç™»å½•
3. æ£€æŸ¥ç³»ç»Ÿæ—¥å¿—æ’æŸ¥æ³„éœ²åŸå› 
4. è€ƒè™‘è½®æ¢ç­¾åå¯†é’¥
```

**â“ å¦‚ä½•å¤„ç†å¤§é‡è¿‡æœŸTokenï¼Ÿ**
```
Redisè‡ªåŠ¨æ¸…ç†ï¼š
- è®¾ç½®åˆç†çš„TTLï¼Œè®©Redisè‡ªåŠ¨åˆ é™¤è¿‡æœŸè®°å½•
- ç›‘æ§Rediså†…å­˜ä½¿ç”¨ï¼Œé¿å…å†…å­˜çˆ†ç‚¸
- è€ƒè™‘ä½¿ç”¨Redisé›†ç¾¤åˆ†æ•£å­˜å‚¨å‹åŠ›
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- JWT-SSO = æ— çŠ¶æ€è®¤è¯ + ç»Ÿä¸€èº«ä»½ç®¡ç†
- åŒToken = å®‰å…¨æ€§ä¸ç”¨æˆ·ä½“éªŒçš„å¹³è¡¡
- é»‘åå• = æ— çŠ¶æ€æ¶æ„ä¸‹çš„Tokenæ’¤é”€æ–¹æ¡ˆ
- å®‰å…¨ç¬¬ä¸€ï¼Œæ€§èƒ½ä¼˜åŒ–ï¼Œç›‘æ§ä¿éšœ