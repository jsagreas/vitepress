---
title: 11ã€SSOåœ¨å¾®æœåŠ¡æ¶æ„ä¸­çš„é›†æˆ
---
## ğŸ“š ç›®å½•

1. [å¾®æœåŠ¡æ¶æ„ä¸­SSOçš„æŒ‘æˆ˜](#1-å¾®æœåŠ¡æ¶æ„ä¸­SSOçš„æŒ‘æˆ˜)
2. [å¾®æœåŠ¡ç½‘å…³+SSOé›†æˆæ–¹æ¡ˆ](#2-å¾®æœåŠ¡ç½‘å…³SSOé›†æˆæ–¹æ¡ˆ)
3. [æœåŠ¡é—´Tokenä¼ é€’ä¸éªŒè¯](#3-æœåŠ¡é—´Tokenä¼ é€’ä¸éªŒè¯)
4. [è·¨å¾®æœåŠ¡Sessionå…±äº«æ–¹æ¡ˆ](#4-è·¨å¾®æœåŠ¡Sessionå…±äº«æ–¹æ¡ˆ)
5. [Spring Cloud Gatewayä¸JWTå®è·µ](#5-Spring-Cloud-Gatewayä¸JWTå®è·µ)
6. [Nginxç½‘å…³é›†æˆå®ç°](#6-Nginxç½‘å…³é›†æˆå®ç°)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ—ï¸ å¾®æœåŠ¡æ¶æ„ä¸­SSOçš„æŒ‘æˆ˜


### 1.1 ä»€ä¹ˆæ˜¯å¾®æœåŠ¡æ¶æ„ä¸‹çš„SSO


**ğŸ“– é€šä¿—ç†è§£**ï¼š
æƒ³è±¡ä¸€ä¸ªå¤§å‹è´­ç‰©ç½‘ç«™ï¼Œå®ƒè¢«æ‹†åˆ†æˆäº†å¤šä¸ªå°æœåŠ¡ï¼š
- ç”¨æˆ·æœåŠ¡ï¼ˆç®¡ç†ç”¨æˆ·ä¿¡æ¯ï¼‰
- å•†å“æœåŠ¡ï¼ˆç®¡ç†å•†å“ä¿¡æ¯ï¼‰
- è®¢å•æœåŠ¡ï¼ˆå¤„ç†è®¢å•ï¼‰
- æ”¯ä»˜æœåŠ¡ï¼ˆå¤„ç†ä»˜æ¬¾ï¼‰

ç”¨æˆ·ç™»å½•ä¸€æ¬¡åï¼Œåº”è¯¥èƒ½å¤Ÿè®¿é—®æ‰€æœ‰è¿™äº›æœåŠ¡ï¼Œè€Œä¸éœ€è¦åœ¨æ¯ä¸ªæœåŠ¡ä¸Šéƒ½é‡æ–°ç™»å½•ã€‚

```
ä¼ ç»Ÿå•ä½“åº”ç”¨ï¼š
ç”¨æˆ· â†’ ç™»å½• â†’ ä¸€ä¸ªå¤§åº”ç”¨ï¼ˆåŒ…å«æ‰€æœ‰åŠŸèƒ½ï¼‰

å¾®æœåŠ¡æ¶æ„ï¼š
        â”Œâ”€ç”¨æˆ·æœåŠ¡
ç”¨æˆ· â†’ ç™»å½• â†’ â”œâ”€å•†å“æœåŠ¡
        â”œâ”€è®¢å•æœåŠ¡
        â””â”€æ”¯ä»˜æœåŠ¡
```

### 1.2 å¾®æœåŠ¡SSOé¢ä¸´çš„æ ¸å¿ƒæŒ‘æˆ˜


**ğŸ” ä¸»è¦æŒ‘æˆ˜**ï¼š

**1ï¸âƒ£ åˆ†å¸ƒå¼è®¤è¯é—®é¢˜**
```
é—®é¢˜ï¼šæ¯ä¸ªå¾®æœåŠ¡éƒ½éœ€è¦éªŒè¯ç”¨æˆ·èº«ä»½
ä¼ ç»Ÿåšæ³•ï¼šæ¯ä¸ªæœåŠ¡éƒ½è¿æ¥ç”¨æˆ·æ•°æ®åº“
ç¼ºç‚¹ï¼šæ€§èƒ½å·®ã€è€¦åˆåº¦é«˜ã€æ•°æ®ä¸ä¸€è‡´
```

**2ï¸âƒ£ Tokenä¼ é€’å¤æ‚æ€§**
```
ç”¨æˆ·è¯·æ±‚è·¯å¾„ï¼š
å‰ç«¯ â†’ ç½‘å…³ â†’ ç”¨æˆ·æœåŠ¡ â†’ è®¢å•æœåŠ¡ â†’ æ”¯ä»˜æœåŠ¡

æ¯ä¸€æ­¥éƒ½éœ€è¦ï¼š
- éªŒè¯ç”¨æˆ·èº«ä»½
- ä¼ é€’ç”¨æˆ·ä¿¡æ¯
- ç¡®ä¿å®‰å…¨æ€§
```

**3ï¸âƒ£ ä¼šè¯çŠ¶æ€ç®¡ç†**
```
é—®é¢˜ï¼šç”¨æˆ·çŠ¶æ€åœ¨å“ªé‡Œå­˜å‚¨ï¼Ÿ
é€‰æ‹©ï¼š
- æœ¬åœ°å­˜å‚¨ï¼šæœåŠ¡é‡å¯ä¸¢å¤±
- æ•°æ®åº“å­˜å‚¨ï¼šæ€§èƒ½é—®é¢˜
- ç¼“å­˜å­˜å‚¨ï¼šéœ€è¦åŒæ­¥
```

### 1.3 å¾®æœåŠ¡SSOçš„è§£å†³æ€è·¯


**ğŸ’¡ æ ¸å¿ƒè§£å†³æ–¹æ¡ˆ**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                å‰ç«¯åº”ç”¨                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            APIç½‘å…³                      â”‚ â† ç»Ÿä¸€å…¥å£
â”‚        (è®¤è¯+è·¯ç”±+é‰´æƒ)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         â”‚         â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”
â”‚ç”¨æˆ·æœåŠ¡â”‚ â”‚å•†å“æœåŠ¡â”‚ â”‚è®¢å•æœåŠ¡â”‚ â† ä¸šåŠ¡æœåŠ¡
â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ¯ å…³é”®è®¾è®¡åŸåˆ™**ï¼š
- **é›†ä¸­è®¤è¯**ï¼šåœ¨ç½‘å…³å±‚ç»Ÿä¸€å¤„ç†è®¤è¯
- **æ— çŠ¶æ€è®¾è®¡**ï¼šä½¿ç”¨JWTç­‰æ— çŠ¶æ€Token
- **æœåŠ¡è§£è€¦**ï¼šä¸šåŠ¡æœåŠ¡ä¸ç›´æ¥å¤„ç†è®¤è¯é€»è¾‘
- **å®‰å…¨ä¼ é€’**ï¼šæœåŠ¡é—´å®‰å…¨åœ°ä¼ é€’ç”¨æˆ·ä¿¡æ¯

---

## 2. ğŸšª å¾®æœåŠ¡ç½‘å…³+SSOé›†æˆæ–¹æ¡ˆ


### 2.1 API Gatewayçš„ä½œç”¨


**ğŸ“– ä»€ä¹ˆæ˜¯API Gateway**ï¼š
APIç½‘å…³å°±åƒæ˜¯ä¸€ä¸ªå¤§æ¥¼çš„ä¿å®‰ï¼Œæ‰€æœ‰æƒ³è¿›å…¥å¤§æ¥¼çš„äººéƒ½å¿…é¡»å…ˆç»è¿‡ä¿å®‰æ£€æŸ¥ã€‚

```
æ²¡æœ‰ç½‘å…³çš„æƒ…å†µï¼š
ç”¨æˆ· â†’ ç›´æ¥è®¿é—®å„ä¸ªå¾®æœåŠ¡
é—®é¢˜ï¼š
- æ¯ä¸ªæœåŠ¡éƒ½è¦éªŒè¯èº«ä»½
- å®‰å…¨ç­–ç•¥åˆ†æ•£
- éš¾ä»¥ç»Ÿä¸€ç®¡ç†

æœ‰ç½‘å…³çš„æƒ…å†µï¼š
ç”¨æˆ· â†’ ç½‘å…³(ç»Ÿä¸€è®¤è¯) â†’ è½¬å‘åˆ°å…·ä½“æœåŠ¡
ä¼˜åŠ¿ï¼š
- ç»Ÿä¸€è®¤è¯å…¥å£
- å®‰å…¨ç­–ç•¥é›†ä¸­
- ä¾¿äºç›‘æ§å’Œç®¡ç†
```

### 2.2 Gateway + SSO é›†æˆæ¶æ„


**ğŸ—ï¸ å®Œæ•´æ¶æ„å›¾**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Webå‰ç«¯    â”‚    â”‚  ç§»åŠ¨ç«¯APP   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                  â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   Load Balancer â”‚ â† è´Ÿè½½å‡è¡¡
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   API Gateway   â”‚ â† ç»Ÿä¸€å…¥å£
         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
         â”‚  â”‚ Auth Filter â”‚â”‚ â† è®¤è¯è¿‡æ»¤å™¨
         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚             â”‚             â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”
â”‚ç”¨æˆ·æœåŠ¡  â”‚   â”‚è®¢å•æœåŠ¡  â”‚   â”‚æ”¯ä»˜æœåŠ¡  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 Gatewayè®¤è¯æµç¨‹


**ğŸ”„ è®¤è¯å¤„ç†æµç¨‹**ï¼š

```
1. ç”¨æˆ·è¯·æ±‚åˆ°è¾¾ç½‘å…³
   â†“
2. ç½‘å…³æ£€æŸ¥è¯·æ±‚å¤´ä¸­çš„Token
   â†“
3. éªŒè¯Tokençš„æœ‰æ•ˆæ€§
   â”œâ”€æœ‰æ•ˆ â†’ è§£æç”¨æˆ·ä¿¡æ¯ â†’ è½¬å‘è¯·æ±‚
   â””â”€æ— æ•ˆ â†’ è¿”å›401æœªæˆæƒ
   
è¯¦ç»†æ­¥éª¤ï¼š
æ­¥éª¤1: æ¥æ”¶è¯·æ±‚
GET /api/orders HTTP/1.1
Authorization: Bearer eyJhbGciOiJIUzI1NiJ9...

æ­¥éª¤2: TokenéªŒè¯
if (tokenå­˜åœ¨ && tokenæœ‰æ•ˆ) {
    æå–ç”¨æˆ·ä¿¡æ¯
    è®¾ç½®è¯·æ±‚å¤´
    è½¬å‘åˆ°è®¢å•æœåŠ¡
} else {
    è¿”å›401é”™è¯¯
}

æ­¥éª¤3: è½¬å‘è¯·æ±‚
GET /orders HTTP/1.1
X-User-Id: 12345
X-User-Role: customer
Authorization: Bearer eyJhbGciOiJIUzI1NiJ9...
```

### 2.4 ç½‘å…³è®¤è¯é…ç½®ç¤ºä¾‹


**ğŸ”§ Gatewayé…ç½®**ï¼š

```yaml
# application.yml
spring:
  cloud:
    gateway:
      routes:
        - id: user-service
          uri: http://localhost:8081
          predicates:
            - Path=/api/users/**
          filters:
            - name: AuthenticationFilter  # è‡ªå®šä¹‰è®¤è¯è¿‡æ»¤å™¨
        
        - id: order-service  
          uri: http://localhost:8082
          predicates:
            - Path=/api/orders/**
          filters:
            - name: AuthenticationFilter

# è®¤è¯ç›¸å…³é…ç½®
jwt:
  secret: mySecretKey
  expiration: 86400  # 24å°æ—¶
```

**ğŸ’» è®¤è¯è¿‡æ»¤å™¨å®ç°**ï¼š

```java
@Component
public class AuthenticationFilter implements GatewayFilter {
    
    @Autowired
    private JwtUtil jwtUtil;
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, 
                            GatewayFilterChain chain) {
        
        ServerHttpRequest request = exchange.getRequest();
        
        // 1. æ£€æŸ¥æ˜¯å¦éœ€è¦è®¤è¯ï¼ˆæ’é™¤ç™»å½•æ¥å£ï¼‰
        if (isPublicPath(request.getPath().toString())) {
            return chain.filter(exchange);
        }
        
        // 2. è·å–Token
        String token = getTokenFromRequest(request);
        if (token == null) {
            return unauthorized(exchange);
        }
        
        // 3. éªŒè¯Token
        try {
            Claims claims = jwtUtil.parseToken(token);
            String userId = claims.getSubject();
            String role = claims.get("role", String.class);
            
            // 4. æ·»åŠ ç”¨æˆ·ä¿¡æ¯åˆ°è¯·æ±‚å¤´
            ServerHttpRequest modifiedRequest = request.mutate()
                .header("X-User-Id", userId)
                .header("X-User-Role", role)
                .build();
                
            return chain.filter(exchange.mutate()
                .request(modifiedRequest).build());
                
        } catch (Exception e) {
            return unauthorized(exchange);
        }
    }
    
    private boolean isPublicPath(String path) {
        return path.startsWith("/api/auth/") || 
               path.startsWith("/api/public/");
    }
    
    private String getTokenFromRequest(ServerHttpRequest request) {
        String authHeader = request.getHeaders().getFirst("Authorization");
        if (authHeader != null && authHeader.startsWith("Bearer ")) {
            return authHeader.substring(7);
        }
        return null;
    }
    
    private Mono<Void> unauthorized(ServerWebExchange exchange) {
        ServerHttpResponse response = exchange.getResponse();
        response.setStatusCode(HttpStatus.UNAUTHORIZED);
        return response.setComplete();
    }
}
```

---

## 3. ğŸ”„ æœåŠ¡é—´Tokenä¼ é€’ä¸éªŒè¯


### 3.1 Tokenä¼ é€’çš„å¿…è¦æ€§


**ğŸ“– ä¸ºä»€ä¹ˆéœ€è¦Tokenä¼ é€’**ï¼š

æƒ³è±¡ä½ æœ‰ä¸€å¼ ä¼šå‘˜å¡ï¼Œåœ¨å•†åœºé‡Œï¼š
1. è¿›å…¥å•†åœºæ—¶ä¿å®‰éªŒè¯äº†ä½ çš„ä¼šå‘˜å¡
2. ä½†å½“ä½ å»ä¸åŒæ¥¼å±‚çš„åº—é“ºæ—¶ï¼Œæ¯ä¸ªåº—é“ºéƒ½éœ€è¦çŸ¥é“ä½ æ˜¯ä¼šå‘˜
3. æ‰€ä»¥ä½ éœ€è¦éšèº«æºå¸¦ä¼šå‘˜å¡ï¼Œæˆ–è€…æœ‰å…¶ä»–æ–¹å¼è¯æ˜èº«ä»½

```
å¾®æœåŠ¡åœºæ™¯ï¼š
ç”¨æˆ·è¯·æ±‚ â†’ ç½‘å…³(éªŒè¯) â†’ ç”¨æˆ·æœåŠ¡ â†’ è®¢å•æœåŠ¡ â†’ æ”¯ä»˜æœåŠ¡

æ¯ä¸ªæœåŠ¡éƒ½éœ€è¦çŸ¥é“ï¼š
- å½“å‰ç”¨æˆ·æ˜¯è°ï¼Ÿ
- ç”¨æˆ·æœ‰ä»€ä¹ˆæƒé™ï¼Ÿ
- è¯·æ±‚æ˜¯å¦åˆæ³•ï¼Ÿ
```

### 3.2 Tokenä¼ é€’æ–¹æ¡ˆ


**ğŸ”„ æ–¹æ¡ˆå¯¹æ¯”**ï¼š

| ä¼ é€’æ–¹å¼ | **ä¼˜ç‚¹** | **ç¼ºç‚¹** | **é€‚ç”¨åœºæ™¯** |
|---------|---------|---------|-------------|
| **HTTP Header** | `ç®€å•ã€æ ‡å‡†` | `æ¯æ¬¡ä¼ é€’` | `REST API` |
| **æœåŠ¡ä¸Šä¸‹æ–‡** | `è‡ªåŠ¨ä¼ é€’` | `æ¡†æ¶ä¾èµ–` | `Spring Cloud` |
| **æ¶ˆæ¯é˜Ÿåˆ—** | `å¼‚æ­¥å¤„ç†` | `å¤æ‚åº¦é«˜` | `äº‹ä»¶é©±åŠ¨` |

### 3.3 HTTP Headerä¼ é€’å®ç°


**ğŸ’» å®ç°æ–¹å¼**ï¼š

```java
// ç½‘å…³å±‚ï¼šæ·»åŠ ç”¨æˆ·ä¿¡æ¯åˆ°è¯·æ±‚å¤´
@Component
public class UserInfoFilter implements GatewayFilter {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, 
                            GatewayFilterChain chain) {
        
        // ä»JWTä¸­è§£æç”¨æˆ·ä¿¡æ¯
        String token = getToken(exchange.getRequest());
        UserInfo userInfo = jwtUtil.parseUserInfo(token);
        
        // æ·»åŠ åˆ°è¯·æ±‚å¤´
        ServerHttpRequest request = exchange.getRequest().mutate()
            .header("X-User-Id", userInfo.getUserId().toString())
            .header("X-User-Name", userInfo.getUsername())
            .header("X-User-Role", userInfo.getRole())
            .header("X-Original-Token", token)
            .build();
            
        return chain.filter(exchange.mutate().request(request).build());
    }
}

// å¾®æœåŠ¡å±‚ï¼šä»è¯·æ±‚å¤´è·å–ç”¨æˆ·ä¿¡æ¯
@Component
public class UserContextHolder {
    
    private static final ThreadLocal<UserInfo> userContext = 
        new ThreadLocal<>();
    
    public static void setUser(UserInfo user) {
        userContext.set(user);
    }
    
    public static UserInfo getCurrentUser() {
        return userContext.get();
    }
    
    public static void clear() {
        userContext.remove();
    }
}

// æ‹¦æˆªå™¨ï¼šè‡ªåŠ¨è§£æè¯·æ±‚å¤´
@Component
public class UserInfoInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler) throws Exception {
        
        // ä»è¯·æ±‚å¤´è·å–ç”¨æˆ·ä¿¡æ¯
        String userId = request.getHeader("X-User-Id");
        String userName = request.getHeader("X-User-Name");
        String userRole = request.getHeader("X-User-Role");
        
        if (userId != null) {
            UserInfo userInfo = new UserInfo();
            userInfo.setUserId(Long.valueOf(userId));
            userInfo.setUsername(userName);
            userInfo.setRole(userRole);
            
            UserContextHolder.setUser(userInfo);
        }
        
        return true;
    }
    
    @Override
    public void afterCompletion(HttpServletRequest request, 
                              HttpServletResponse response, 
                              Object handler, Exception ex) {
        // æ¸…ç†çº¿ç¨‹æœ¬åœ°å˜é‡
        UserContextHolder.clear();
    }
}
```

### 3.4 æœåŠ¡é—´è°ƒç”¨Tokenä¼ é€’


**ğŸ”— Feignå®¢æˆ·ç«¯è‡ªåŠ¨ä¼ é€’**ï¼š

```java
// é…ç½®Feignè‡ªåŠ¨ä¼ é€’Token
@Configuration
public class FeignConfig {
    
    @Bean
    public RequestInterceptor requestInterceptor() {
        return new RequestInterceptor() {
            @Override
            public void apply(RequestTemplate template) {
                // è·å–å½“å‰è¯·æ±‚çš„Token
                ServletRequestAttributes attributes = 
                    (ServletRequestAttributes) RequestContextHolder
                        .getRequestAttributes();
                        
                if (attributes != null) {
                    HttpServletRequest request = attributes.getRequest();
                    String token = request.getHeader("Authorization");
                    
                    if (token != null) {
                        // ä¼ é€’åˆ°ä¸‹æ¸¸æœåŠ¡
                        template.header("Authorization", token);
                    }
                    
                    // ä¼ é€’ç”¨æˆ·ä¿¡æ¯
                    String userId = request.getHeader("X-User-Id");
                    if (userId != null) {
                        template.header("X-User-Id", userId);
                    }
                }
            }
        };
    }
}

// ä½¿ç”¨ç¤ºä¾‹
@FeignClient(name = "order-service", configuration = FeignConfig.class)
public interface OrderServiceClient {
    
    @GetMapping("/orders/{orderId}")
    OrderDto getOrder(@PathVariable("orderId") Long orderId);
}

// åœ¨æ§åˆ¶å™¨ä¸­ä½¿ç”¨
@RestController
public class UserController {
    
    @Autowired
    private OrderServiceClient orderServiceClient;
    
    @GetMapping("/users/{userId}/orders/{orderId}")
    public ResponseEntity<OrderDto> getUserOrder(
            @PathVariable Long userId,
            @PathVariable Long orderId) {
        
        // Tokenä¼šè‡ªåŠ¨ä¼ é€’ç»™order-service
        OrderDto order = orderServiceClient.getOrder(orderId);
        
        // order-serviceå¯ä»¥è·å–åˆ°å½“å‰ç”¨æˆ·ä¿¡æ¯
        return ResponseEntity.ok(order);
    }
}
```

---

## 4. ğŸ”„ è·¨å¾®æœåŠ¡Sessionå…±äº«æ–¹æ¡ˆ


### 4.1 Sessionå…±äº«çš„æŒ‘æˆ˜


**ğŸ“– ä»€ä¹ˆæ˜¯Sessionå…±äº«é—®é¢˜**ï¼š

ä¼ ç»Ÿå•ä½“åº”ç”¨ä¸­ï¼Œç”¨æˆ·ç™»å½•åSessionå­˜å‚¨åœ¨åº”ç”¨æœåŠ¡å™¨çš„å†…å­˜ä¸­ã€‚ä½†åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼š

```
é—®é¢˜åœºæ™¯ï¼š
ç”¨æˆ·åœ¨æœåŠ¡Aç™»å½• â†’ Sessionå­˜åœ¨æœåŠ¡A
ç”¨æˆ·è®¿é—®æœåŠ¡B â†’ æœåŠ¡Bæ‰¾ä¸åˆ°Session â†’ è¦æ±‚é‡æ–°ç™»å½•

ç†æƒ³æƒ…å†µï¼š
ç”¨æˆ·åœ¨ä»»ä½•åœ°æ–¹ç™»å½• â†’ æ‰€æœ‰æœåŠ¡éƒ½èƒ½è¯†åˆ«ç”¨æˆ·èº«ä»½
```

### 4.2 Sessionå…±äº«è§£å†³æ–¹æ¡ˆ


**ğŸ¯ ä¸»è¦æ–¹æ¡ˆå¯¹æ¯”**ï¼š

| æ–¹æ¡ˆ | **åŸç†** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** |
|------|---------|---------|---------|
| **Rediså…±äº«** | `é›†ä¸­å­˜å‚¨Session` | `ç®€å•æ˜“ç”¨` | `å•ç‚¹æ•…éšœé£é™©` |
| **JWTæ— çŠ¶æ€** | `TokenåŒ…å«ç”¨æˆ·ä¿¡æ¯` | `æ— éœ€å­˜å‚¨` | `æ— æ³•ä¸»åŠ¨å¤±æ•ˆ` |
| **æ•°æ®åº“å…±äº«** | `DBå­˜å‚¨Session` | `æŒä¹…åŒ–` | `æ€§èƒ½è¾ƒå·®` |
| **Sticky Session** | `è´Ÿè½½å‡è¡¡ç»‘å®š` | `æ— éœ€æ”¹é€ ` | `æ‰©å±•æ€§å·®` |

### 4.3 Redis Sessionå…±äº«å®ç°


**ğŸ”§ Rediså…±äº«é…ç½®**ï¼š

```yaml
# application.yml
spring:
  session:
    store-type: redis
    redis:
      namespace: spring:session
      flush-mode: on_save
  redis:
    host: localhost
    port: 6379
    database: 0
    timeout: 10000ms
    lettuce:
      pool:
        max-active: 10
        max-wait: -1ms
        max-idle: 8
        min-idle: 0
```

**ğŸ’» é…ç½®ç±»**ï¼š

```java
@Configuration
@EnableRedisHttpSession(maxInactiveIntervalInSeconds = 1800) // 30åˆ†é’Ÿ
public class SessionConfig {
    
    @Bean
    public LettuceConnectionFactory connectionFactory() {
        return new LettuceConnectionFactory(
            new RedisStandaloneConfiguration("localhost", 6379));
    }
    
    @Bean
    public RedisTemplate<String, Object> redisTemplate(
            LettuceConnectionFactory connectionFactory) {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(connectionFactory);
        
        // è®¾ç½®åºåˆ—åŒ–å™¨
        template.setKeySerializer(new StringRedisSerializer());
        template.setValueSerializer(new GenericJackson2JsonRedisSerializer());
        
        return template;
    }
}

// è‡ªå®šä¹‰SessionæœåŠ¡
@Service
public class SessionService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // åˆ›å»ºSession
    public String createSession(UserInfo userInfo) {
        String sessionId = UUID.randomUUID().toString();
        String sessionKey = "session:" + sessionId;
        
        // å­˜å‚¨ç”¨æˆ·ä¿¡æ¯
        redisTemplate.opsForValue().set(sessionKey, userInfo, 
            Duration.ofMinutes(30));
            
        return sessionId;
    }
    
    // è·å–Session
    public UserInfo getSession(String sessionId) {
        String sessionKey = "session:" + sessionId;
        return (UserInfo) redisTemplate.opsForValue().get(sessionKey);
    }
    
    // æ›´æ–°Sessionè¿‡æœŸæ—¶é—´
    public void refreshSession(String sessionId) {
        String sessionKey = "session:" + sessionId;
        redisTemplate.expire(sessionKey, Duration.ofMinutes(30));
    }
    
    // åˆ é™¤Session
    public void removeSession(String sessionId) {
        String sessionKey = "session:" + sessionId;
        redisTemplate.delete(sessionKey);
    }
}
```

### 4.4 JWTæ— çŠ¶æ€æ–¹æ¡ˆå®ç°


**ğŸ’» JWTæœåŠ¡å®ç°**ï¼š

```java
@Service
public class JwtService {
    
    @Value("${jwt.secret}")
    private String secret;
    
    @Value("${jwt.expiration}")
    private Long expiration;
    
    // ç”ŸæˆToken
    public String generateToken(UserInfo userInfo) {
        Map<String, Object> claims = new HashMap<>();
        claims.put("userId", userInfo.getUserId());
        claims.put("username", userInfo.getUsername());
        claims.put("role", userInfo.getRole());
        claims.put("permissions", userInfo.getPermissions());
        
        return Jwts.builder()
            .setClaims(claims)
            .setSubject(userInfo.getUsername())
            .setIssuedAt(new Date())
            .setExpiration(new Date(System.currentTimeMillis() + expiration))
            .signWith(SignatureAlgorithm.HS512, secret)
            .compact();
    }
    
    // è§£æToken
    public UserInfo parseToken(String token) {
        try {
            Claims claims = Jwts.parser()
                .setSigningKey(secret)
                .parseClaimsJws(token)
                .getBody();
                
            UserInfo userInfo = new UserInfo();
            userInfo.setUserId(claims.get("userId", Long.class));
            userInfo.setUsername(claims.get("username", String.class));
            userInfo.setRole(claims.get("role", String.class));
            userInfo.setPermissions(claims.get("permissions", List.class));
            
            return userInfo;
        } catch (Exception e) {
            throw new RuntimeException("Tokenè§£æå¤±è´¥", e);
        }
    }
    
    // éªŒè¯Token
    public boolean validateToken(String token) {
        try {
            Jwts.parser().setSigningKey(secret).parseClaimsJws(token);
            return true;
        } catch (Exception e) {
            return false;
        }
    }
}

// ä½¿ç”¨ç¤ºä¾‹
@RestController
public class AuthController {
    
    @Autowired
    private JwtService jwtService;
    
    @PostMapping("/login")
    public ResponseEntity<Map<String, String>> login(
            @RequestBody LoginRequest request) {
        
        // éªŒè¯ç”¨æˆ·å‡­æ®ï¼ˆçœç•¥éªŒè¯é€»è¾‘ï¼‰
        UserInfo userInfo = authenticateUser(request);
        
        if (userInfo != null) {
            // ç”ŸæˆJWT Token
            String token = jwtService.generateToken(userInfo);
            
            Map<String, String> response = new HashMap<>();
            response.put("token", token);
            response.put("type", "Bearer");
            
            return ResponseEntity.ok(response);
        }
        
        return ResponseEntity.status(401).build();
    }
}
```

---

## 5. ğŸš€ Spring Cloud Gatewayä¸JWTå®è·µ


### 5.1 Spring Cloud Gatewayç®€ä»‹


**ğŸ“– ä»€ä¹ˆæ˜¯Spring Cloud Gateway**ï¼š

Spring Cloud Gatewayæ˜¯Springå®˜æ–¹æä¾›çš„å¾®æœåŠ¡ç½‘å…³ï¼Œå°±åƒæ˜¯ä¸€ä¸ªæ™ºèƒ½çš„äº¤é€šæŒ‡æŒ¥ä¸­å¿ƒï¼š
- æ¥æ”¶æ‰€æœ‰è¯·æ±‚
- æ ¹æ®è§„åˆ™è·¯ç”±åˆ°ä¸åŒæœåŠ¡
- åœ¨è·¯ç”±è¿‡ç¨‹ä¸­å¯ä»¥æ‰§è¡Œå„ç§è¿‡æ»¤å™¨ï¼ˆè®¤è¯ã€é™æµç­‰ï¼‰

```
Gatewayå·¥ä½œæµç¨‹ï¼š
è¯·æ±‚ â†’ è·¯ç”±åŒ¹é… â†’ æ‰§è¡Œå‰ç½®è¿‡æ»¤å™¨ â†’ è½¬å‘åˆ°ç›®æ ‡æœåŠ¡ â†’ æ‰§è¡Œåç½®è¿‡æ»¤å™¨ â†’ è¿”å›å“åº”
```

### 5.2 Gateway + JWTå®Œæ•´é…ç½®


**ğŸ“‹ é¡¹ç›®ç»“æ„**ï¼š

```
gateway-service/
â”œâ”€â”€ src/main/java/
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”œâ”€â”€ GatewayConfig.java      # ç½‘å…³é…ç½®
â”‚   â”‚   â””â”€â”€ SecurityConfig.java     # å®‰å…¨é…ç½®
â”‚   â”œâ”€â”€ filter/
â”‚   â”‚   â”œâ”€â”€ AuthenticationFilter.java  # è®¤è¯è¿‡æ»¤å™¨
â”‚   â”‚   â””â”€â”€ UserInfoFilter.java        # ç”¨æˆ·ä¿¡æ¯è¿‡æ»¤å™¨
â”‚   â”œâ”€â”€ util/
â”‚   â”‚   â””â”€â”€ JwtUtil.java            # JWTå·¥å…·ç±»
â”‚   â””â”€â”€ GatewayApplication.java
â”œâ”€â”€ src/main/resources/
â”‚   â””â”€â”€ application.yml
â””â”€â”€ pom.xml
```

**ğŸ”§ ç½‘å…³é…ç½®**ï¼š

```yaml
# application.yml
server:
  port: 8080

spring:
  application:
    name: gateway-service
  cloud:
    gateway:
      discovery:
        locator:
          enabled: true
          lower-case-service-id: true
      routes:
        # è®¤è¯æœåŠ¡è·¯ç”±ï¼ˆæ— éœ€è®¤è¯ï¼‰
        - id: auth-service
          uri: lb://auth-service
          predicates:
            - Path=/api/auth/**
          filters:
            - StripPrefix=1
        
        # ç”¨æˆ·æœåŠ¡è·¯ç”±ï¼ˆéœ€è¦è®¤è¯ï¼‰
        - id: user-service
          uri: lb://user-service
          predicates:
            - Path=/api/users/**
          filters:
            - StripPrefix=1
            - name: Authentication
        
        # è®¢å•æœåŠ¡è·¯ç”±ï¼ˆéœ€è¦è®¤è¯ï¼‰
        - id: order-service
          uri: lb://order-service
          predicates:
            - Path=/api/orders/**
          filters:
            - StripPrefix=1
            - name: Authentication

# JWTé…ç½®
jwt:
  secret: mySecretKey123456789
  expiration: 86400  # 24å°æ—¶ï¼ˆç§’ï¼‰
  
# ä¸éœ€è¦è®¤è¯çš„è·¯å¾„
security:
  ignore-paths:
    - /api/auth/login
    - /api/auth/register
    - /api/public/**
    - /actuator/**
```

### 5.3 JWTè®¤è¯è¿‡æ»¤å™¨å®ç°


**ğŸ’» å®Œæ•´è®¤è¯è¿‡æ»¤å™¨**ï¼š

```java
@Component
@Slf4j
public class AuthenticationFilter implements GatewayFilter, Ordered {
    
    @Autowired
    private JwtUtil jwtUtil;
    
    @Value("#{'${security.ignore-paths}'.split(',')}")
    private List<String> ignorePaths;
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        ServerHttpRequest request = exchange.getRequest();
        String path = request.getPath().toString();
        
        log.info("è¯·æ±‚è·¯å¾„: {}", path);
        
        // 1. æ£€æŸ¥æ˜¯å¦ä¸ºå¿½ç•¥è·¯å¾„
        if (isIgnorePath(path)) {
            log.info("å¿½ç•¥è®¤è¯è·¯å¾„: {}", path);
            return chain.filter(exchange);
        }
        
        // 2. è·å–Token
        String token = extractToken(request);
        if (StringUtils.isEmpty(token)) {
            log.warn("ç¼ºå°‘Token");
            return unauthorized(exchange, "ç¼ºå°‘è®¤è¯Token");
        }
        
        // 3. éªŒè¯Token
        try {
            Claims claims = jwtUtil.parseToken(token);
            
            // 4. æå–ç”¨æˆ·ä¿¡æ¯
            String userId = claims.getSubject();
            String username = claims.get("username", String.class);
            String role = claims.get("role", String.class);
            
            log.info("ç”¨æˆ·è®¤è¯æˆåŠŸ: userId={}, username={}, role={}", 
                userId, username, role);
            
            // 5. æ·»åŠ ç”¨æˆ·ä¿¡æ¯åˆ°è¯·æ±‚å¤´
            ServerHttpRequest modifiedRequest = request.mutate()
                .header("X-User-Id", userId)
                .header("X-User-Name", username)
                .header("X-User-Role", role)
                .header("X-Auth-Token", token)
                .build();
            
            return chain.filter(exchange.mutate().request(modifiedRequest).build());
            
        } catch (ExpiredJwtException e) {
            log.warn("Tokenå·²è¿‡æœŸ");
            return unauthorized(exchange, "Tokenå·²è¿‡æœŸ");
        } catch (Exception e) {
            log.error("TokenéªŒè¯å¤±è´¥", e);
            return unauthorized(exchange, "TokenéªŒè¯å¤±è´¥");
        }
    }
    
    private boolean isIgnorePath(String path) {
        return ignorePaths.stream()
            .anyMatch(ignorePath -> {
                if (ignorePath.endsWith("/**")) {
                    String prefix = ignorePath.substring(0, ignorePath.length() - 3);
                    return path.startsWith(prefix);
                } else if (ignorePath.endsWith("/*")) {
                    String prefix = ignorePath.substring(0, ignorePath.length() - 2);
                    return path.startsWith(prefix) && 
                           path.substring(prefix.length()).indexOf('/') == -1;
                } else {
                    return path.equals(ignorePath);
                }
            });
    }
    
    private String extractToken(ServerHttpRequest request) {
        // 1. ä»Authorizationå¤´è·å–
        String authHeader = request.getHeaders().getFirst("Authorization");
        if (authHeader != null && authHeader.startsWith("Bearer ")) {
            return authHeader.substring(7);
        }
        
        // 2. ä»å‚æ•°è·å–ï¼ˆç”¨äºWebSocketç­‰åœºæ™¯ï¼‰
        List<String> tokenParams = request.getQueryParams().get("token");
        if (tokenParams != null && !tokenParams.isEmpty()) {
            return tokenParams.get(0);
        }
        
        return null;
    }
    
    private Mono<Void> unauthorized(ServerWebExchange exchange, String message) {
        ServerHttpResponse response = exchange.getResponse();
        response.setStatusCode(HttpStatus.UNAUTHORIZED);
        response.getHeaders().add("Content-Type", "application/json;charset=UTF-8");
        
        String body = "{\"code\":401,\"message\":\"" + message + "\"}";
        DataBuffer buffer = response.bufferFactory().wrap(body.getBytes(StandardCharsets.UTF_8));
        
        return response.writeWith(Mono.just(buffer));
    }
    
    @Override
    public int getOrder() {
        return -100;  // ä¼˜å…ˆçº§è¾ƒé«˜
    }
}
```

### 5.4 JWTå·¥å…·ç±»å®ç°


**ğŸ”§ JWTå·¥å…·ç±»**ï¼š

```java
@Component
@Slf4j
public class JwtUtil {
    
    @Value("${jwt.secret}")
    private String secret;
    
    @Value("${jwt.expiration}")
    private Long expiration;
    
    /**
     * ç”ŸæˆToken
     */
    public String generateToken(UserInfo userInfo) {
        Map<String, Object> claims = new HashMap<>();
        claims.put("username", userInfo.getUsername());
        claims.put("role", userInfo.getRole());
        claims.put("permissions", userInfo.getPermissions());
        
        return createToken(claims, userInfo.getUserId().toString());
    }
    
    /**
     * åˆ›å»ºToken
     */
    private String createToken(Map<String, Object> claims, String subject) {
        Date now = new Date();
        Date expiryDate = new Date(now.getTime() + expiration * 1000);
        
        return Jwts.builder()
            .setClaims(claims)
            .setSubject(subject)
            .setIssuedAt(now)
            .setExpiration(expiryDate)
            .signWith(SignatureAlgorithm.HS512, secret)
            .compact();
    }
    
    /**
     * è§£æToken
     */
    public Claims parseToken(String token) {
        try {
            return Jwts.parser()
                .setSigningKey(secret)
                .parseClaimsJws(token)
                .getBody();
        } catch (ExpiredJwtException e) {
            log.error("Tokenå·²è¿‡æœŸ: {}", e.getMessage());
            throw e;
        } catch (UnsupportedJwtException e) {
            log.error("ä¸æ”¯æŒçš„Token: {}", e.getMessage());
            throw new RuntimeException("ä¸æ”¯æŒçš„Token");
        } catch (MalformedJwtException e) {
            log.error("Tokenæ ¼å¼é”™è¯¯: {}", e.getMessage());
            throw new RuntimeException("Tokenæ ¼å¼é”™è¯¯");
        } catch (SignatureException e) {
            log.error("Tokenç­¾åéªŒè¯å¤±è´¥: {}", e.getMessage());
            throw new RuntimeException("Tokenç­¾åéªŒè¯å¤±è´¥");
        } catch (IllegalArgumentException e) {
            log.error("Tokenä¸ºç©º: {}", e.getMessage());
            throw new RuntimeException("Tokenä¸ºç©º");
        }
    }
    
    /**
     * éªŒè¯Token
     */
    public boolean validateToken(String token) {
        try {
            parseToken(token);
            return true;
        } catch (Exception e) {
            return false;
        }
    }
    
    /**
     * ä»Tokenä¸­è·å–ç”¨æˆ·å
     */
    public String getUsernameFromToken(String token) {
        Claims claims = parseToken(token);
        return claims.get("username", String.class);
    }
    
    /**
     * ä»Tokenä¸­è·å–ç”¨æˆ·ID
     */
    public String getUserIdFromToken(String token) {
        Claims claims = parseToken(token);
        return claims.getSubject();
    }
    
    /**
     * æ£€æŸ¥Tokenæ˜¯å¦è¿‡æœŸ
     */
    public boolean isTokenExpired(String token) {
        try {
            Claims claims = parseToken(token);
            Date expiration = claims.getExpiration();
            return expiration.before(new Date());
        } catch (ExpiredJwtException e) {
            return true;
        }
    }
}
```

---

## 6. ğŸŒ Nginxç½‘å…³é›†æˆå®ç°


### 6.1 Nginx + JWTè®¤è¯æ–¹æ¡ˆ


**ğŸ“– ä¸ºä»€ä¹ˆé€‰æ‹©Nginx**ï¼š

Nginxä½œä¸ºç½‘å…³çš„ä¼˜åŠ¿ï¼š
- **æ€§èƒ½æé«˜**ï¼šCè¯­è¨€ç¼–å†™ï¼Œå¤„ç†å¹¶å‘èƒ½åŠ›å¼º
- **é…ç½®çµæ´»**ï¼šæ”¯æŒå¤æ‚çš„è·¯ç”±å’Œè´Ÿè½½å‡è¡¡
- **æ‰©å±•æ€§å¥½**ï¼šé€šè¿‡luaè„šæœ¬å¯ä»¥å®ç°å¤æ‚é€»è¾‘
- **æˆæœ¬ä½**ï¼šå¼€æºå…è´¹ï¼Œè¿ç»´æˆæœ¬ä½

```
Nginxç½‘å…³æ¶æ„ï¼š
å®¢æˆ·ç«¯ â†’ Nginx(luaè„šæœ¬éªŒè¯JWT) â†’ ä¸Šæ¸¸å¾®æœåŠ¡

éªŒè¯æµç¨‹ï¼š
1. æ¥æ”¶è¯·æ±‚
2. æå–JWT Token
3. luaè„šæœ¬éªŒè¯Token
4. æ·»åŠ ç”¨æˆ·ä¿¡æ¯åˆ°è¯·æ±‚å¤´
5. è½¬å‘åˆ°åç«¯æœåŠ¡
```

### 6.2 Nginxé…ç½®å®ç°


**ğŸ”§ Nginxä¸»é…ç½®**ï¼š

```nginx
# nginx.conf
worker_processes auto;
error_log /var/log/nginx/error.log;

events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    
    # æ—¥å¿—æ ¼å¼
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                   '$status $body_bytes_sent "$http_referer" '
                   '"$http_user_agent" "$http_x_forwarded_for"';
    
    access_log /var/log/nginx/access.log main;
    
    # å¼•å…¥luaæ¨¡å—
    lua_package_path "/etc/nginx/lua/?.lua;;";
    lua_shared_dict jwt_cache 10m;  # JWTç¼“å­˜
    
    # ä¸Šæ¸¸æœåŠ¡å®šä¹‰
    upstream auth_service {
        server 127.0.0.1:8081;
        server 127.0.0.1:8082 backup;
    }
    
    upstream user_service {
        server 127.0.0.1:9001;
        server 127.0.0.1:9002;
    }
    
    upstream order_service {
        server 127.0.0.1:9101;
        server 127.0.0.1:9102;
    }
    
    # ä¸»è¦é…ç½®
    include /etc/nginx/conf.d/*.conf;
}
```

**ğŸ”§ ç½‘å…³è™šæ‹Ÿä¸»æœºé…ç½®**ï¼š

```nginx
# conf.d/gateway.conf
server {
    listen 80;
    server_name api.example.com;
    
    # è®¾ç½®å˜é‡
    set $jwt_secret "mySecretKey123456789";
    
    # è®¤è¯æœåŠ¡ï¼ˆæ— éœ€JWTéªŒè¯ï¼‰
    location /api/auth/ {
        proxy_pass http://auth_service/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # ç”¨æˆ·æœåŠ¡ï¼ˆéœ€è¦JWTéªŒè¯ï¼‰
    location /api/users/ {
        # JWTéªŒè¯
        access_by_lua_file /etc/nginx/lua/jwt_auth.lua;
        
        proxy_pass http://user_service/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # ä¼ é€’ç”¨æˆ·ä¿¡æ¯ï¼ˆç”±luaè„šæœ¬è®¾ç½®ï¼‰
        proxy_set_header X-User-Id $user_id;
        proxy_set_header X-User-Name $username;
        proxy_set_header X-User-Role $user_role;
    }
    
    # è®¢å•æœåŠ¡ï¼ˆéœ€è¦JWTéªŒè¯ï¼‰
    location /api/orders/ {
        # JWTéªŒè¯
        access_by_lua_file /etc/nginx/lua/jwt_auth.lua;
        
        proxy_pass http://order_service/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # ä¼ é€’ç”¨æˆ·ä¿¡æ¯
        proxy_set_header X-User-Id $user_id;
        proxy_set_header X-User-Name $username;
        proxy_set_header X-User-Role $user_role;
    }
    
    # é™æ€èµ„æº
    location /static/ {
        root /var/www;
        expires 7d;
        add_header Cache-Control "public, immutable";
    }
    
    # å¥åº·æ£€æŸ¥
    location /health {
        access_log off;
        return 200 "healthy";
        add_header Content-Type text/plain;
    }
}
```

### 6.3 Lua JWTéªŒè¯è„šæœ¬


**ğŸ’» JWTéªŒè¯è„šæœ¬**ï¼š

```lua
-- lua/jwt_auth.lua
local jwt = require "resty.jwt"
local cjson = require "cjson"

-- JWTå¯†é’¥ï¼ˆåº”è¯¥ä»ç¯å¢ƒå˜é‡è¯»å–ï¼‰
local jwt_secret = ngx.var.jwt_secret or "mySecretKey123456789"

-- è·å–Token
local function get_token()
    -- ä»Authorizationå¤´è·å–
    local auth_header = ngx.var.http_authorization
    if auth_header then
        local token = string.match(auth_header, "Bearer%s+(.+)")
        if token then
            return token
        end
    end
    
    -- ä»å‚æ•°è·å–
    local args = ngx.req.get_uri_args()
    if args.token then
        return args.token
    end
    
    return nil
end

-- éªŒè¯Token
local function validate_token(token)
    if not token then
        return false, "ç¼ºå°‘Token"
    end
    
    -- æ£€æŸ¥ç¼“å­˜
    local cache_key = "jwt:" .. token
    local cached_result = ngx.shared.jwt_cache:get(cache_key)
    if cached_result then
        local user_info = cjson.decode(cached_result)
        return true, user_info
    end
    
    -- éªŒè¯JWT
    local jwt_obj = jwt:verify(jwt_secret, token)
    if not jwt_obj or not jwt_obj.valid then
        return false, "Tokenæ— æ•ˆ"
    end
    
    -- æ£€æŸ¥è¿‡æœŸæ—¶é—´
    local now = ngx.time()
    if jwt_obj.payload.exp and jwt_obj.payload.exp < now then
        return false, "Tokenå·²è¿‡æœŸ"
    end
    
    -- æå–ç”¨æˆ·ä¿¡æ¯
    local user_info = {
        user_id = jwt_obj.payload.sub,
        username = jwt_obj.payload.username,
        role = jwt_obj.payload.role,
        permissions = jwt_obj.payload.permissions
    }
    
    -- ç¼“å­˜ç»“æœï¼ˆ5åˆ†é’Ÿï¼‰
    ngx.shared.jwt_cache:set(cache_key, cjson.encode(user_info), 300)
    
    return true, user_info
end

-- ä¸»é€»è¾‘
local token = get_token()
local valid, result = validate_token(token)

if not valid then
    ngx.log(ngx.ERR, "JWTéªŒè¯å¤±è´¥: " .. (result or "æœªçŸ¥é”™è¯¯"))
    ngx.status = 401
    ngx.header["Content-Type"] = "application/json"
    ngx.say(cjson.encode({
        code = 401,
        message = result or "è®¤è¯å¤±è´¥"
    }))
    ngx.exit(401)
end

-- è®¾ç½®ç”¨æˆ·ä¿¡æ¯å˜é‡
ngx.var.user_id = result.user_id
ngx.var.username = result.username
ngx.var.user_role = result.role

-- è®°å½•æ—¥å¿—
ngx.log(ngx.INFO, "ç”¨æˆ·è®¤è¯æˆåŠŸ: " .. result.username)
```

### 6.4 Nginx JWTæ¨¡å—å®‰è£…


**âš™ï¸ å®‰è£…æ­¥éª¤**ï¼š

```bash
# 1. å®‰è£…OpenRestyï¼ˆåŒ…å«nginx + luaï¼‰
wget https://openresty.org/package/rhel/openresty.repo
sudo mv openresty.repo /etc/yum.repos.d/
sudo yum install openresty

# 2. å®‰è£…lua-resty-jwtæ¨¡å—
git clone https://github.com/auth0/lua-resty-jwt.git
cd lua-resty-jwt
sudo cp -r lib/resty /usr/local/openresty/lualib/

# 3. å¯åŠ¨nginx
sudo systemctl start openresty
sudo systemctl enable openresty

# 4. æµ‹è¯•é…ç½®
sudo nginx -t
sudo nginx -s reload
```

**ğŸ”§ Dockeræ–¹å¼éƒ¨ç½²**ï¼š

```dockerfile
# Dockerfile
FROM openresty/openresty:alpine

# å®‰è£…lua-resty-jwt
RUN mkdir -p /tmp && \
    cd /tmp && \
    wget https://github.com/auth0/lua-resty-jwt/archive/master.zip && \
    unzip master.zip && \
    cp -r lua-resty-jwt-master/lib/resty /usr/local/openresty/lualib/

# å¤åˆ¶é…ç½®æ–‡ä»¶
COPY nginx.conf /usr/local/openresty/nginx/conf/
COPY conf.d/ /etc/nginx/conf.d/
COPY lua/ /etc/nginx/lua/

EXPOSE 80

CMD ["/usr/local/openresty/bin/openresty", "-g", "daemon off;"]
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å¾®æœåŠ¡SSOæŒ‘æˆ˜ï¼šåˆ†å¸ƒå¼è®¤è¯ã€Tokenä¼ é€’ã€çŠ¶æ€ç®¡ç†
ğŸ”¸ API Gatewayä½œç”¨ï¼šç»Ÿä¸€å…¥å£ã€é›†ä¸­è®¤è¯ã€å®‰å…¨è·¯ç”±
ğŸ”¸ Tokenä¼ é€’æ–¹å¼ï¼šHTTP Headerã€æœåŠ¡ä¸Šä¸‹æ–‡ã€æ¶ˆæ¯é˜Ÿåˆ—
ğŸ”¸ Sessionå…±äº«æ–¹æ¡ˆï¼šRediså…±äº«ã€JWTæ— çŠ¶æ€ã€æ•°æ®åº“å­˜å‚¨
ğŸ”¸ Spring Cloud Gatewayï¼šè·¯ç”±åŒ¹é…ã€è¿‡æ»¤å™¨é“¾ã€è´Ÿè½½å‡è¡¡
ğŸ”¸ Nginx + Luaï¼šé«˜æ€§èƒ½ç½‘å…³ã€çµæ´»é…ç½®ã€æ‰©å±•æ€§å¼º
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å¾®æœåŠ¡SSOçš„æœ¬è´¨**
```
æ ¸å¿ƒé—®é¢˜ï¼š
- å¦‚ä½•åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­ç»´æŠ¤ç”¨æˆ·èº«ä»½ï¼Ÿ
- å¦‚ä½•ç¡®ä¿å®‰å…¨çš„åŒæ—¶ä¿è¯æ€§èƒ½ï¼Ÿ
- å¦‚ä½•å¤„ç†æœåŠ¡é—´çš„ç”¨æˆ·ä¿¡æ¯ä¼ é€’ï¼Ÿ

è§£å†³æ€è·¯ï¼š
- é›†ä¸­è®¤è¯ï¼šåœ¨ç½‘å…³å±‚ç»Ÿä¸€å¤„ç†
- æ— çŠ¶æ€åŒ–ï¼šä½¿ç”¨JWTå‡å°‘çŠ¶æ€ä¾èµ–
- æ ‡å‡†åŒ–ï¼šç»Ÿä¸€Tokenä¼ é€’å’ŒéªŒè¯æœºåˆ¶
```

**ğŸ”¹ æ–¹æ¡ˆé€‰æ‹©åŸåˆ™**
```
é€‰æ‹©ä¾æ®ï¼š
- æ€§èƒ½è¦æ±‚ï¼šNginx > Spring Cloud Gateway > å…¶ä»–
- å¼€å‘å¤æ‚åº¦ï¼šSpring Bootç”Ÿæ€ > Nginx Lua
- åŠŸèƒ½ä¸°å¯Œåº¦ï¼šSpring Cloud Gateway > Nginx
- è¿ç»´æˆæœ¬ï¼šNginx < Spring Cloud Gateway

å®é™…å»ºè®®ï¼š
- ä¸­å°å‹é¡¹ç›®ï¼šSpring Cloud Gateway + JWT
- é«˜æ€§èƒ½è¦æ±‚ï¼šNginx + Lua + JWT
- ä¼ä¸šçº§åº”ç”¨ï¼šSpring Cloud Gateway + Redis Session
```

### 7.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¸šåŠ¡åœºæ™¯åº”ç”¨**
- **ç”µå•†å¹³å°**ï¼šç”¨æˆ·ç™»å½•åå¯è®¿é—®å•†å“ã€è®¢å•ã€æ”¯ä»˜ç­‰æ‰€æœ‰æœåŠ¡
- **ä¼ä¸šåº”ç”¨**ï¼šå‘˜å·¥ç™»å½•OAç³»ç»Ÿåå¯ä½¿ç”¨æ‰€æœ‰ä¸šåŠ¡æ¨¡å—
- **SaaSå¹³å°**ï¼šå®¢æˆ·ç™»å½•åå¯ä½¿ç”¨å¹³å°æä¾›çš„å„ç§æœåŠ¡
- **ç§»åŠ¨åº”ç”¨**ï¼šAPPç™»å½•åå¯è°ƒç”¨æ‰€æœ‰åç«¯API

**ğŸ”§ æŠ€æœ¯å®ç°è¦ç‚¹**
- **å®‰å…¨æ€§**ï¼šTokenç­¾åéªŒè¯ã€HTTPSä¼ è¾“ã€å®šæœŸè½®æ¢å¯†é’¥
- **æ€§èƒ½**ï¼šTokenç¼“å­˜ã€è¿æ¥æ± ã€è´Ÿè½½å‡è¡¡
- **å¯é æ€§**ï¼šæ•…éšœè½¬ç§»ã€å¥åº·æ£€æŸ¥ã€ç›‘æ§å‘Šè­¦
- **æ‰©å±•æ€§**ï¼šæ°´å¹³æ‰©å±•ã€æœåŠ¡å‘ç°ã€é…ç½®ä¸­å¿ƒ

**ğŸ’¡ æœ€ä½³å®è·µå»ºè®®**
```
å¼€å‘å»ºè®®ï¼š
1. ç»Ÿä¸€è®¤è¯æ ‡å‡†ï¼Œé¿å…å„æœåŠ¡è‡ªè¡Œå®ç°
2. åˆç†è®¾ç½®Tokenè¿‡æœŸæ—¶é—´å’Œåˆ·æ–°ç­–ç•¥
3. å®ç°å®Œå–„çš„æ—¥å¿—è®°å½•å’Œç›‘æ§
4. è€ƒè™‘å¤šç§Ÿæˆ·å’Œæƒé™ç»†ç²’åº¦æ§åˆ¶

è¿ç»´å»ºè®®ï¼š
1. å®šæœŸæ›´æ–°JWTå¯†é’¥
2. ç›‘æ§ç½‘å…³æ€§èƒ½å’Œé”™è¯¯ç‡
3. å®ç°ç°åº¦å‘å¸ƒå’Œå›æ»šæœºåˆ¶
4. å»ºç«‹å®Œå–„çš„åº”æ€¥å“åº”æµç¨‹
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- å¾®æœåŠ¡SSOæ ¸å¿ƒåœ¨äºé›†ä¸­è®¤è¯ã€åˆ†å¸ƒå¼éªŒè¯
- ç½‘å…³æ˜¯å®ç°SSOçš„å…³é”®ç»„ä»¶ï¼Œæ‰¿æ‹…è®¤è¯å’Œè·¯ç”±èŒè´£
- JWTæ— çŠ¶æ€åŒ–æ˜¯å¾®æœåŠ¡è®¤è¯çš„æœ€ä½³å®è·µ
- é€‰æ‹©æŠ€æœ¯æ–¹æ¡ˆè¦å¹³è¡¡æ€§èƒ½ã€å¤æ‚åº¦å’Œä¸šåŠ¡éœ€æ±‚