---
title: 20ã€ZSetæœ‰åºé›†åˆæ€§èƒ½ä¼˜åŒ–
---
## ğŸ“š ç›®å½•

1. [ZSetæ€§èƒ½åŸºç¡€è®¤çŸ¥](#1-ZSetæ€§èƒ½åŸºç¡€è®¤çŸ¥)
2. [å¤§æœ‰åºé›†åˆä¼˜åŒ–ç­–ç•¥](#2-å¤§æœ‰åºé›†åˆä¼˜åŒ–ç­–ç•¥)
3. [æ’è¡Œæ¦œæ€§èƒ½ä¼˜åŒ–](#3-æ’è¡Œæ¦œæ€§èƒ½ä¼˜åŒ–)
4. [ZSetä½¿ç”¨é™·é˜±è¯¦è§£](#4-ZSetä½¿ç”¨é™·é˜±è¯¦è§£)
5. [æœ€ä½³å®è·µæŒ‡å—](#5-æœ€ä½³å®è·µæŒ‡å—)
6. [æ€§èƒ½ç›‘æ§ä¸è°ƒä¼˜](#6-æ€§èƒ½ç›‘æ§ä¸è°ƒä¼˜)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ ZSetæ€§èƒ½åŸºç¡€è®¤çŸ¥


### 1.1 ZSetæ˜¯ä»€ä¹ˆ

**é€šä¿—ç†è§£**ï¼šZSetå°±åƒä¸€ä¸ªè‡ªåŠ¨æ’åºçš„ç§¯åˆ†æ¦œï¼Œæ¯ä¸ªç©å®¶éƒ½æœ‰åˆ†æ•°ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æŒ‰åˆ†æ•°æ’åºã€‚

```
æƒ³è±¡ä¸€ä¸ªæ¸¸æˆæ’è¡Œæ¦œï¼š
ç©å®¶A - 1000åˆ†
ç©å®¶B - 950åˆ†  
ç©å®¶C - 800åˆ†

ZSetç‰¹ç‚¹ï¼š
âœ… è‡ªåŠ¨æŒ‰åˆ†æ•°æ’åº
âœ… æ”¯æŒèŒƒå›´æŸ¥è¯¢
âœ… å¿«é€ŸæŸ¥æ‰¾æ’å
âœ… åˆ†æ•°å¯ä»¥é‡å¤ï¼Œä½†æˆå‘˜å”¯ä¸€
```

### 1.2 ZSetå†…éƒ¨ç»“æ„ç†è§£

```
ZSetåº•å±‚å®ç°ï¼šè·³è·ƒè¡¨ + å“ˆå¸Œè¡¨

è·³è·ƒè¡¨ç»“æ„ç¤ºæ„ï¼š
Level 3:  [å¤´] -----------> [1000åˆ†] -> NULL
Level 2:  [å¤´] -> [950åˆ†] -> [1000åˆ†] -> NULL  
Level 1:  [å¤´] -> [800åˆ†] -> [950åˆ†] -> [1000åˆ†] -> NULL

å“ˆå¸Œè¡¨ï¼š
{"ç©å®¶A": 1000, "ç©å®¶B": 950, "ç©å®¶C": 800}
```

**ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡**ï¼š
- ğŸ“ˆ **è·³è·ƒè¡¨**ï¼šä¿è¯æœ‰åºï¼Œæ”¯æŒèŒƒå›´æŸ¥è¯¢ï¼Œæ—¶é—´å¤æ‚åº¦O(log n)
- ğŸ” **å“ˆå¸Œè¡¨**ï¼šå¿«é€Ÿå®šä½æˆå‘˜ï¼Œæ—¶é—´å¤æ‚åº¦O(1)
- ğŸ¯ **åŒé‡ç»“æ„**ï¼šæ—¢èƒ½å¿«é€ŸæŸ¥æ‰¾ï¼Œåˆèƒ½æœ‰åºéå†

### 1.3 ZSetæ€§èƒ½ç‰¹å¾

| æ“ä½œç±»å‹ | æ—¶é—´å¤æ‚åº¦ | æ€§èƒ½è¡¨ç° | é€‚ç”¨åœºæ™¯ |
|---------|-----------|----------|----------|
| `ZADD` | O(log n) | ğŸŸ¢ ä¼˜ç§€ | æ·»åŠ æ–°æˆå‘˜ |
| `ZSCORE` | O(1) | ğŸŸ¢ æå¿« | æŸ¥è¯¢åˆ†æ•° |
| `ZRANK` | O(log n) | ğŸŸ¢ ä¼˜ç§€ | æŸ¥è¯¢æ’å |
| `ZRANGE` | O(log n + m) | ğŸŸ¡ ä¸­ç­‰ | èŒƒå›´æŸ¥è¯¢ |
| `ZREMRANGEBYRANK` | O(log n + m) | ğŸ”´ è¾ƒæ…¢ | æ‰¹é‡åˆ é™¤ |

**æ€§èƒ½é—®é¢˜é¢„è­¦**ï¼š
- âš ï¸ æ•°æ®é‡è¶…è¿‡100ä¸‡æ—¶æ€§èƒ½ä¸‹é™æ˜æ˜¾
- âš ï¸ å¤§èŒƒå›´æŸ¥è¯¢å¯èƒ½å¯¼è‡´é˜»å¡
- âš ï¸ é¢‘ç¹çš„å¤§æ‰¹é‡æ“ä½œå½±å“æ•´ä½“æ€§èƒ½

---

## 2. ğŸ“Š å¤§æœ‰åºé›†åˆä¼˜åŒ–ç­–ç•¥


### 2.1 å¤§ZSetåˆ†ç‰‡ç­–ç•¥è¯¦è§£


**ä»€ä¹ˆæ˜¯åˆ†ç‰‡**ï¼šå°†ä¸€ä¸ªå¤§çš„ZSetæ‹†åˆ†æˆå¤šä¸ªå°çš„ZSetï¼Œé™ä½å•ä¸ªé›†åˆçš„æ•°æ®é‡ã€‚

#### ğŸ”„ æ—¶é—´åˆ†ç‰‡ç­–ç•¥

```java
// æŒ‰æ—¶é—´åˆ†ç‰‡ï¼šæ¯å°æ—¶ä¸€ä¸ªæ’è¡Œæ¦œ
public class HourlyRankingSharding {
    
    public void addScore(String userId, double score) {
        String hour = getCurrentHour(); // "2024-08-28-14"
        String key = "ranking:" + hour;
        
        // æ·»åŠ åˆ°å½“å‰å°æ—¶çš„æ’è¡Œæ¦œ
        jedis.zadd(key, score, userId);
        
        // è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œé¿å…å†…å­˜æ³„æ¼
        jedis.expire(key, 86400 * 7); // ä¿å­˜7å¤©
    }
    
    // è·å–å½“å‰å°æ—¶æ’è¡Œæ¦œ
    public List<String> getCurrentRanking(int start, int end) {
        String key = "ranking:" + getCurrentHour();
        return jedis.zrevrange(key, start, end);
    }
    
    private String getCurrentHour() {
        return LocalDateTime.now().format(
            DateTimeFormatter.ofPattern("yyyy-MM-dd-HH")
        );
    }
}
```

#### ğŸ¯ ç”¨æˆ·åˆ†ç‰‡ç­–ç•¥

```java
// æŒ‰ç”¨æˆ·IDå“ˆå¸Œåˆ†ç‰‡
public class UserHashSharding {
    private static final int SHARD_COUNT = 16; // 16ä¸ªåˆ†ç‰‡
    
    public void addScore(String userId, double score) {
        int shardId = Math.abs(userId.hashCode()) % SHARD_COUNT;
        String key = "ranking:shard:" + shardId;
        
        jedis.zadd(key, score, userId);
    }
    
    // è·å–å…¨å±€æ’è¡Œæ¦œï¼ˆéœ€è¦åˆå¹¶å¤šä¸ªåˆ†ç‰‡ï¼‰
    public List<RankingItem> getGlobalRanking(int topN) {
        List<RankingItem> allItems = new ArrayList<>();
        
        // ä»æ‰€æœ‰åˆ†ç‰‡è·å–å‰topN*2çš„æ•°æ®
        for (int i = 0; i < SHARD_COUNT; i++) {
            String key = "ranking:shard:" + i;
            Set<Tuple> items = jedis.zrevrangeWithScores(key, 0, topN * 2);
            
            for (Tuple tuple : items) {
                allItems.add(new RankingItem(
                    tuple.getElement(), 
                    tuple.getScore()
                ));
            }
        }
        
        // åˆå¹¶æ’åºå¹¶å–å‰topN
        return allItems.stream()
            .sorted((a, b) -> Double.compare(b.getScore(), a.getScore()))
            .limit(topN)
            .collect(Collectors.toList());
    }
}
```

### 2.2 åˆ†æ•°åŒºé—´åˆ†ç‰‡


**æ ¸å¿ƒæ€æƒ³**ï¼šæŒ‰åˆ†æ•°èŒƒå›´å°†æ•°æ®åˆ†åˆ°ä¸åŒçš„ZSetä¸­ã€‚

```java
public class ScoreRangeSharding {
    
    // åˆ†æ•°åŒºé—´å®šä¹‰
    private static final double[] SCORE_RANGES = {
        0, 1000, 5000, 10000, 50000, Double.MAX_VALUE
    };
    
    public void addScore(String userId, double score) {
        String key = getShardKey(score);
        jedis.zadd(key, score, userId);
        
        // åŒæ—¶ç»´æŠ¤ç”¨æˆ·çš„åˆ†ç‰‡ä¿¡æ¯ï¼Œä¾¿äºåç»­æŸ¥è¯¢å’Œæ›´æ–°
        jedis.hset("user:shard", userId, key);
    }
    
    private String getShardKey(double score) {
        for (int i = 0; i < SCORE_RANGES.length - 1; i++) {
            if (score >= SCORE_RANGES[i] && score < SCORE_RANGES[i + 1]) {
                return "ranking:score:" + SCORE_RANGES[i] + "-" + SCORE_RANGES[i + 1];
            }
        }
        return "ranking:score:max";
    }
    
    // è·å–åˆ†æ•°åŒºé—´çš„æ’è¡Œæ¦œ
    public List<String> getRankingByScoreRange(double minScore, double maxScore) {
        List<String> result = new ArrayList<>();
        
        for (int i = 0; i < SCORE_RANGES.length - 1; i++) {
            double rangeMin = SCORE_RANGES[i];
            double rangeMax = SCORE_RANGES[i + 1];
            
            // åˆ¤æ–­åŒºé—´æ˜¯å¦ä¸æŸ¥è¯¢èŒƒå›´é‡å 
            if (rangeMax > minScore && rangeMin < maxScore) {
                String key = "ranking:score:" + rangeMin + "-" + rangeMax;
                Set<String> members = jedis.zrangeByScore(key, 
                    Math.max(minScore, rangeMin), 
                    Math.min(maxScore, rangeMax)
                );
                result.addAll(members);
            }
        }
        
        return result;
    }
}
```

### 2.3 çƒ­ç‚¹æ•°æ®åˆ†ç¦»ç­–ç•¥


**é—®é¢˜åœºæ™¯**ï¼šæ’è¡Œæ¦œå‰100åç»å¸¸æŸ¥è¯¢ï¼Œä½†æ•°æ®é‡åºå¤§æ—¶æŸ¥è¯¢å˜æ…¢ã€‚

```java
public class HotColdDataSeparation {
    
    private static final int HOT_DATA_SIZE = 100;
    
    // çƒ­æ•°æ®ï¼šå‰100åå•ç‹¬å­˜å‚¨
    private void updateHotData(String mainKey) {
        String hotKey = mainKey + ":hot";
        
        // è·å–å‰100åæ•°æ®
        Set<Tuple> topData = jedis.zrevrangeWithScores(mainKey, 0, HOT_DATA_SIZE - 1);
        
        // é‡å»ºçƒ­æ•°æ®é›†åˆ
        jedis.del(hotKey);
        if (!topData.isEmpty()) {
            Map<String, Double> hotScores = new HashMap<>();
            for (Tuple tuple : topData) {
                hotScores.put(tuple.getElement(), tuple.getScore());
            }
            jedis.zadd(hotKey, hotScores);
            jedis.expire(hotKey, 3600); // 1å°æ—¶è¿‡æœŸ
        }
    }
    
    // æ™ºèƒ½æŸ¥è¯¢ï¼šä¼˜å…ˆæŸ¥è¯¢çƒ­æ•°æ®
    public List<String> getRanking(String key, int start, int end) {
        String hotKey = key + ":hot";
        
        // å¦‚æœæŸ¥è¯¢èŒƒå›´åœ¨çƒ­æ•°æ®èŒƒå›´å†…ï¼Œç›´æ¥æŸ¥è¯¢çƒ­æ•°æ®
        if (end < HOT_DATA_SIZE && jedis.exists(hotKey)) {
            return jedis.zrevrange(hotKey, start, end);
        }
        
        // å¦åˆ™æŸ¥è¯¢å®Œæ•´æ•°æ®
        return jedis.zrevrange(key, start, end);
    }
    
    // å¼‚æ­¥æ›´æ–°çƒ­æ•°æ®
    @Async
    public void asyncUpdateHotData(String mainKey) {
        updateHotData(mainKey);
    }
}
```

---

## 3. ğŸ† æ’è¡Œæ¦œæ€§èƒ½ä¼˜åŒ–


### 3.1 æ’è¡Œæ¦œç¼“å­˜ç­–ç•¥


#### ğŸ“¦ å¤šçº§ç¼“å­˜æ¶æ„

```
å®¢æˆ·ç«¯ç¼“å­˜ï¼ˆ5ç§’ï¼‰ â†’ Redisçƒ­ç‚¹ç¼“å­˜ï¼ˆ1åˆ†é’Ÿï¼‰ â†’ Redisä¸»æ•°æ® â†’ æ•°æ®åº“

ç¼“å­˜å±‚æ¬¡ï¼š
Level 1: åº”ç”¨å†…å­˜ç¼“å­˜ï¼ˆCaffeine/Guavaï¼‰
Level 2: Redisçƒ­ç‚¹æ•°æ®ç¼“å­˜  
Level 3: Rediså®Œæ•´æ’è¡Œæ¦œæ•°æ®
Level 4: æ•°æ®åº“æŒä¹…åŒ–å­˜å‚¨
```

```java
@Service
public class RankingCacheService {
    
    @Cacheable(value = "ranking:hot", key = "#type + ':' + #page", unless = "#result.size() == 0")
    public List<RankingItem> getHotRanking(String type, int page) {
        int start = page * 20;
        int end = start + 19;
        
        String hotKey = "ranking:" + type + ":hot";
        Set<Tuple> results = jedis.zrevrangeWithScores(hotKey, start, end);
        
        return results.stream()
            .map(t -> new RankingItem(t.getElement(), t.getScore()))
            .collect(Collectors.toList());
    }
    
    // ç¼“å­˜é¢„çƒ­
    @PostConstruct
    public void preloadCache() {
        String[] rankingTypes = {"daily", "weekly", "monthly"};
        
        for (String type : rankingTypes) {
            for (int page = 0; page < 10; page++) { // é¢„çƒ­å‰10é¡µ
                getHotRanking(type, page);
            }
        }
    }
}
```

#### âš¡ å¢é‡æ›´æ–°æœºåˆ¶

```java
public class IncrementalRankingUpdate {
    
    // æ‰¹é‡æ›´æ–°åˆ†æ•°
    public void batchUpdateScores(List<ScoreUpdate> updates) {
        Pipeline pipeline = jedis.pipelined();
        Set<String> affectedKeys = new HashSet<>();
        
        for (ScoreUpdate update : updates) {
            String key = "ranking:" + update.getType();
            pipeline.zincrby(key, update.getScoreDelta(), update.getUserId());
            affectedKeys.add(key);
        }
        
        pipeline.sync();
        
        // å¼‚æ­¥æ›´æ–°ç¼“å­˜
        for (String key : affectedKeys) {
            asyncUpdateCache(key);
        }
    }
    
    // æ™ºèƒ½ç¼“å­˜å¤±æ•ˆ
    private void asyncUpdateCache(String key) {
        CompletableFuture.runAsync(() -> {
            // åªæœ‰åˆ†æ•°å˜åŒ–å½±å“åˆ°å‰100åæ—¶æ‰æ›´æ–°çƒ­ç‚¹ç¼“å­˜
            String hotKey = key + ":hot";
            Double minHotScore = jedis.zscore(hotKey, 
                jedis.zrange(hotKey, -1, -1).iterator().next()
            );
            
            Double maxNewScore = jedis.zscore(key,
                jedis.zrevrange(key, 0, 0).iterator().next()
            );
            
            if (maxNewScore > minHotScore) {
                updateHotCache(key);
            }
        });
    }
}
```

### 3.2 åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–


#### ğŸ” æ™ºèƒ½åˆ†é¡µç­–ç•¥

```java
public class OptimizedPagination {
    
    // æ·±åˆ†é¡µä¼˜åŒ–ï¼šä½¿ç”¨æ¸¸æ ‡åˆ†é¡µ
    public RankingPage getRankingPage(String key, String cursor, int pageSize) {
        long startRank;
        
        if (cursor == null || cursor.isEmpty()) {
            startRank = 0;
        } else {
            // è§£ææ¸¸æ ‡è·å–èµ·å§‹æ’å
            String userId = decodeCursor(cursor);
            Long rank = jedis.zrevrank(key, userId);
            startRank = (rank != null) ? rank + 1 : 0;
        }
        
        long endRank = startRank + pageSize - 1;
        Set<Tuple> results = jedis.zrevrangeWithScores(key, startRank, endRank);
        
        List<RankingItem> items = new ArrayList<>();
        String nextCursor = null;
        
        for (Tuple tuple : results) {
            items.add(new RankingItem(
                tuple.getElement(), 
                tuple.getScore(),
                startRank + items.size() + 1 // æ’å
            ));
            nextCursor = tuple.getElement(); // æœ€åä¸€ä¸ªå…ƒç´ ä½œä¸ºä¸‹ä¸€é¡µæ¸¸æ ‡
        }
        
        return new RankingPage(items, nextCursor, results.size() == pageSize);
    }
    
    // è·³é¡µæŸ¥è¯¢ä¼˜åŒ–ï¼šé¢„ä¼°è·³é¡µä½ç½®
    public List<RankingItem> jumpToPage(String key, int targetPage, int pageSize) {
        // å…ˆè·å–æ€»æ•°ä¼°ç®—
        long totalCount = jedis.zcard(key);
        long targetRank = (long) targetPage * pageSize;
        
        if (targetRank >= totalCount) {
            return Collections.emptyList();
        }
        
        // ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾å®šä½å‡†ç¡®ä½ç½®
        return getRanking(key, (int) targetRank, (int) (targetRank + pageSize - 1));
    }
}
```

### 3.3 å®æ—¶æ€§å¹³è¡¡


```java
public class RealtimeBalancer {
    
    // å®æ—¶æ€§çº§åˆ«é…ç½®
    enum RealtimeLevel {
        REAL_TIME(0, "å®æ—¶æ›´æ–°"),     // ç«‹å³æ›´æ–°
        NEAR_REAL_TIME(5, "å‡†å®æ—¶"), // 5ç§’å»¶è¿Ÿ
        PERIODIC(60, "å®šæœŸæ›´æ–°");     // 1åˆ†é’Ÿå»¶è¿Ÿ
        
        final int delaySec;
        final String desc;
        
        RealtimeLevel(int delaySec, String desc) {
            this.delaySec = delaySec;
            this.desc = desc;
        }
    }
    
    public void updateScore(String userId, double score, RealtimeLevel level) {
        switch (level) {
            case REAL_TIME:
                // ç«‹å³æ›´æ–°ä¸»æ¦œå’Œç¼“å­˜
                updateMainRanking(userId, score);
                updateCache(userId, score);
                break;
                
            case NEAR_REAL_TIME:
                // ç«‹å³æ›´æ–°ä¸»æ¦œï¼Œå»¶è¿Ÿæ›´æ–°ç¼“å­˜
                updateMainRanking(userId, score);
                scheduleUpdateCache(userId, score, 5);
                break;
                
            case PERIODIC:
                // åŠ å…¥æ›´æ–°é˜Ÿåˆ—ï¼Œæ‰¹é‡å¤„ç†
                addToUpdateQueue(userId, score);
                break;
        }
    }
    
    // æ‰¹é‡å¤„ç†é˜Ÿåˆ—
    @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿæ‰§è¡Œ
    public void processBatchUpdates() {
        List<ScoreUpdate> updates = getAndClearUpdateQueue();
        if (!updates.isEmpty()) {
            batchUpdateRanking(updates);
            updateCacheAfterBatch();
        }
    }
}
```

---

## 4. âš  ZSetä½¿ç”¨é™·é˜±è¯¦è§£


### 4.1 ZRANGEå¤§èŒƒå›´æŸ¥è¯¢é£é™©


#### ğŸš¨ é—®é¢˜åœºæ™¯

```java
// âŒ å±é™©æ“ä½œï¼šå¯èƒ½å¯¼è‡´Redisé˜»å¡
public void dangerousLargeRangeQuery() {
    // æŸ¥è¯¢æ‰€æœ‰æ•°æ®ï¼ˆ100ä¸‡æ¡è®°å½•ï¼‰
    Set<String> allMembers = jedis.zrange("large_ranking", 0, -1);
    
    // å¤§èŒƒå›´åˆ†æ•°æŸ¥è¯¢
    Set<String> highScores = jedis.zrangeByScore("ranking", 
        Double.NEGATIVE_INFINITY, Double.POSITIVE_INFINITY);
}
```

**é—®é¢˜åˆ†æ**ï¼š
- ğŸ”´ **å†…å­˜å ç”¨**ï¼šä¸€æ¬¡æ€§åŠ è½½å¤§é‡æ•°æ®åˆ°å†…å­˜
- ğŸ”´ **ç½‘ç»œä¼ è¾“**ï¼šå¤§æ•°æ®åŒ…å¯èƒ½å¯¼è‡´ç½‘ç»œè¶…æ—¶
- ğŸ”´ **Redisé˜»å¡**ï¼šé•¿æ—¶é—´æ“ä½œé˜»å¡å…¶ä»–å®¢æˆ·ç«¯
- ğŸ”´ **åº”ç”¨å´©æºƒ**ï¼šæ¥æ”¶ç«¯å¯èƒ½å› å†…å­˜ä¸è¶³å´©æºƒ

#### âœ… å®‰å…¨çš„æŸ¥è¯¢æ–¹å¼

```java
public class SafeRangeQuery {
    
    private static final int MAX_BATCH_SIZE = 1000;
    
    // åˆ†æ‰¹æŸ¥è¯¢å¤§èŒƒå›´æ•°æ®
    public List<String> safeLargeRangeQuery(String key, long start, long end) {
        List<String> result = new ArrayList<>();
        long current = start;
        
        while (current <= end) {
            long batchEnd = Math.min(current + MAX_BATCH_SIZE - 1, end);
            
            Set<String> batch = jedis.zrange(key, current, batchEnd);
            result.addAll(batch);
            
            // é¿å…ç©ºç»“æœæ— é™å¾ªç¯
            if (batch.isEmpty()) {
                break;
            }
            
            current = batchEnd + 1;
            
            // å¯é€‰ï¼šæ·»åŠ å»¶è¿Ÿé¿å…è¿‡åº¦å ç”¨Redisèµ„æº
            if (current <= end) {
                try {
                    Thread.sleep(10); // 10mså»¶è¿Ÿ
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                    break;
                }
            }
        }
        
        return result;
    }
    
    // æµå¼å¤„ç†å¤§æ•°æ®é›†
    public void processLargeDataset(String key, Consumer<String> processor) {
        long start = 0;
        int batchSize = 100;
        
        while (true) {
            Set<String> batch = jedis.zrange(key, start, start + batchSize - 1);
            
            if (batch.isEmpty()) {
                break;
            }
            
            // é€ä¸ªå¤„ç†ï¼Œé¿å…å†…å­˜ç§¯ç´¯
            for (String member : batch) {
                processor.accept(member);
            }
            
            start += batchSize;
        }
    }
}
```

### 4.2 åˆ†æ•°ç²¾åº¦é—®é¢˜


#### ğŸ”¢ IEEE 754åŒç²¾åº¦æµ®ç‚¹æ•°é™åˆ¶

```java
public class ScorePrecisionIssue {
    
    // âŒ ç²¾åº¦é—®é¢˜ç¤ºä¾‹
    public void precisionProblem() {
        double score1 = 0.1 + 0.2;  // 0.30000000000000004
        double score2 = 0.3;        // 0.3
        
        jedis.zadd("test", score1, "user1");
        jedis.zadd("test", score2, "user2");
        
        // æ’åºå¯èƒ½ä¸ç¬¦åˆé¢„æœŸ
        System.out.println(score1 == score2); // false
    }
    
    // âœ… è§£å†³æ–¹æ¡ˆ1ï¼šæ•´æ•°åŒ–åˆ†æ•°
    public void integerScoreSolution() {
        // å°†åˆ†æ•°ä¹˜ä»¥åˆé€‚çš„å€æ•°è½¬ä¸ºæ•´æ•°
        double originalScore = 98.67;
        long integerScore = Math.round(originalScore * 1000); // 98670
        
        jedis.zadd("ranking", integerScore, "user1");
        
        // æŸ¥è¯¢æ—¶è½¬æ¢å›åŸå§‹åˆ†æ•°
        Double storedScore = jedis.zscore("ranking", "user1");
        double displayScore = storedScore / 1000.0; // 98.67
    }
    
    // âœ… è§£å†³æ–¹æ¡ˆ2ï¼šä½¿ç”¨BigDecimalå¤„ç†
    public void bigDecimalSolution() {
        BigDecimal score = new BigDecimal("98.67");
        
        // è½¬æ¢ä¸ºå¯ä»¥ç²¾ç¡®è¡¨ç¤ºçš„é•¿æ•´æ•°
        long preciseScore = score.multiply(new BigDecimal("1000")).longValue();
        
        jedis.zadd("ranking", preciseScore, "user1");
    }
}
```

#### ğŸ“Š åˆ†æ•°è®¾è®¡æœ€ä½³å®è·µ

```java
public class ScoreDesignBestPractices {
    
    // æ—¶é—´æˆ³ + è‡ªå¢IDç»„åˆåˆ†æ•°
    public double createTimeBasedScore(long timestamp, long autoIncId) {
        // é«˜ä½ï¼šæ—¶é—´æˆ³ï¼ˆç§’çº§ï¼‰ï¼Œä½ä½ï¼šè‡ªå¢ID
        // ç¡®ä¿æ—¶é—´æˆ³å ä¸»å¯¼åœ°ä½ï¼ŒIDç”¨äºå»é‡
        return timestamp * 1000000.0 + autoIncId;
    }
    
    // å¤šç»´åº¦åˆ†æ•°åˆå¹¶
    public double createMultiDimensionScore(int level, int experience, int achievements) {
        // æƒé‡åˆ†é…ï¼šç­‰çº§(60%) + ç»éªŒ(30%) + æˆå°±(10%)
        return level * 0.6 * 1000000 +    // ç­‰çº§æƒé‡æœ€é«˜
               experience * 0.3 * 1000 +   // ç»éªŒæ¬¡ä¹‹
               achievements * 0.1 * 10;     // æˆå°±æœ€ä½
    }
    
    // åˆ†æ•°èŒƒå›´å½’ä¸€åŒ–
    public double normalizeScore(double rawScore, double minScore, double maxScore) {
        if (maxScore == minScore) {
            return 0.0;
        }
        
        // å½’ä¸€åŒ–åˆ° [0, 1000000] èŒƒå›´ï¼Œé¿å…ç²¾åº¦é—®é¢˜
        double normalized = (rawScore - minScore) / (maxScore - minScore);
        return Math.round(normalized * 1000000);
    }
}
```

### 4.3 å†…å­˜å ç”¨è¯„ä¼°


#### ğŸ“ ZSetå†…å­˜å ç”¨è®¡ç®—

```java
public class ZSetMemoryCalculator {
    
    public static class MemoryEstimate {
        long totalMemory;      // æ€»å†…å­˜å ç”¨ï¼ˆå­—èŠ‚ï¼‰
        long memberMemory;     // æˆå‘˜æ•°æ®å†…å­˜
        long scoreMemory;      // åˆ†æ•°æ•°æ®å†…å­˜
        long indexMemory;      // ç´¢å¼•ç»“æ„å†…å­˜
        long overheadMemory;   // Rediså¯¹è±¡å¤´ç­‰å¼€é”€
        
        // è®¡ç®—æ–¹æ³•
        public double getMemoryMB() {
            return totalMemory / 1024.0 / 1024.0;
        }
    }
    
    // ä¼°ç®—ZSetå†…å­˜å ç”¨
    public MemoryEstimate estimateMemory(long memberCount, double avgMemberLength) {
        MemoryEstimate estimate = new MemoryEstimate();
        
        // æˆå‘˜å­—ç¬¦ä¸²å†…å­˜ï¼šå­—ç¬¦ä¸²é•¿åº¦ + Rediså­—ç¬¦ä¸²å¯¹è±¡å¼€é”€
        estimate.memberMemory = (long) (memberCount * (avgMemberLength + 20));
        
        // åˆ†æ•°å†…å­˜ï¼šæ¯ä¸ªåˆ†æ•°8å­—èŠ‚ï¼ˆdoubleï¼‰
        estimate.scoreMemory = memberCount * 8;
        
        // è·³è·ƒè¡¨ç´¢å¼•å†…å­˜ï¼šå¹³å‡æ¯ä¸ªèŠ‚ç‚¹40å­—èŠ‚å¼€é”€
        estimate.indexMemory = memberCount * 40;
        
        // å“ˆå¸Œè¡¨å†…å­˜ï¼šå¹³å‡æ¯ä¸ªæ¡ç›®16å­—èŠ‚
        long hashTableMemory = memberCount * 16;
        
        // Rediså¯¹è±¡å¤´å¼€é”€ï¼šçº¦80å­—èŠ‚åŸºç¡€å¼€é”€
        estimate.overheadMemory = 80 + hashTableMemory;
        
        estimate.totalMemory = estimate.memberMemory + 
                              estimate.scoreMemory + 
                              estimate.indexMemory + 
                              estimate.overheadMemory;
        
        return estimate;
    }
    
    // å®é™…å†…å­˜ä½¿ç”¨ç›‘æ§
    public long getActualMemoryUsage(String key) {
        // ä½¿ç”¨DEBUG OBJECTå‘½ä»¤è·å–å®é™…å†…å­˜å ç”¨
        String info = jedis.debugObject(key);
        
        // è§£æserializedlengthå­—æ®µ
        Pattern pattern = Pattern.compile("serializedlength:(\\d+)");
        Matcher matcher = pattern.matcher(info);
        
        if (matcher.find()) {
            return Long.parseLong(matcher.group(1));
        }
        
        return -1; // æ— æ³•è·å–æ—¶è¿”å›-1
    }
}
```

#### ğŸ’¾ å†…å­˜ä¼˜åŒ–ç­–ç•¥

```java
public class MemoryOptimizationStrategies {
    
    // ç­–ç•¥1ï¼šæˆå‘˜IDä¼˜åŒ–
    public void optimizeMemberIds() {
        // âŒ ä½¿ç”¨é•¿å­—ç¬¦ä¸²ä½œä¸ºæˆå‘˜ID
        // jedis.zadd("ranking", score, "user_uuid_550e8400-e29b-41d4-a716-446655440000");
        
        // âœ… ä½¿ç”¨çŸ­æ•°å­—ID
        jedis.zadd("ranking", score, "12345");
        
        // ç»´æŠ¤IDæ˜ å°„å…³ç³»ï¼ˆå¦‚æœéœ€è¦ï¼‰
        jedis.hset("id_mapping", "12345", "user_uuid_550e8400-e29b-41d4-a716-446655440000");
    }
    
    // ç­–ç•¥2ï¼šåˆ†æ•°èŒƒå›´å‹ç¼©
    public void compressScoreRange() {
        // âŒ ä½¿ç”¨è¿‡å¤§çš„åˆ†æ•°èŒƒå›´
        // double score = System.currentTimeMillis(); // 13ä½æ•°å­—
        
        // âœ… å‹ç¼©åˆ†æ•°èŒƒå›´
        long timestamp = System.currentTimeMillis();
        long baseTime = 1609459200000L; // 2021-01-01 00:00:00åŸºå‡†æ—¶é—´
        double compressedScore = (timestamp - baseTime) / 1000.0; // è½¬ä¸ºç§’çº§
        
        jedis.zadd("ranking", compressedScore, "user123");
    }
    
    // ç­–ç•¥3ï¼šå®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®
    @Scheduled(cron = "0 0 2 * * ?") // æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
    public void cleanupExpiredData() {
        String[] keys = {"daily_ranking", "weekly_ranking", "monthly_ranking"};
        
        for (String key : keys) {
            // åªä¿ç•™å‰1ä¸‡åï¼Œåˆ é™¤å…¶ä½™æ•°æ®
            long totalCount = jedis.zcard(key);
            if (totalCount > 10000) {
                jedis.zremrangeByRank(key, 0, totalCount - 10001);
            }
        }
    }
}
```

---

## 5. ğŸ¯ æœ€ä½³å®è·µæŒ‡å—


### 5.1 ZSetæ•°æ®å»ºæ¨¡


#### ğŸ“‹ æ•°æ®æ¨¡å‹è®¾è®¡åŸåˆ™

```
1ï¸âƒ£ å•ä¸€èŒè´£åŸåˆ™ï¼šæ¯ä¸ªZSetåªè´Ÿè´£ä¸€ç§æ’åºé€»è¾‘
2ï¸âƒ£ åˆç†ç²’åº¦ï¼šé¿å…å•ä¸ªZSetè¿‡å¤§ï¼Œä¹Ÿé¿å…è¿‡åº¦åˆ†ç‰‡
3ï¸âƒ£ å‘½åè§„èŒƒï¼škeyå‘½åè¦ä½“ç°ä¸šåŠ¡å«ä¹‰å’Œæ—¶é—´èŒƒå›´
4ï¸âƒ£ ç”Ÿå‘½å‘¨æœŸï¼šè®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´ï¼Œé¿å…å†…å­˜æ³„æ¼
```

```java
public class ZSetDataModeling {
    
    // æ¸¸æˆæ’è¡Œæ¦œæ•°æ®æ¨¡å‹
    public static class GameRankingModel {
        
        // å…¨æœç­‰çº§æ’è¡Œæ¦œ
        public void updateLevelRanking(String userId, int level, long experience) {
            // åˆ†æ•°è®¾è®¡ï¼šç­‰çº§ * 10^6 + ç»éªŒå€¼ï¼ˆç¡®ä¿ç­‰çº§ä¼˜å…ˆï¼‰
            double score = level * 1000000.0 + experience;
            jedis.zadd("ranking:level:global", score, userId);
            
            // è®¾ç½®7å¤©è¿‡æœŸæ—¶é—´
            jedis.expire("ranking:level:global", 7 * 24 * 3600);
        }
        
        // åŒºæœç§¯åˆ†æ’è¡Œæ¦œ
        public void updateScoreRanking(int serverId, String userId, long score) {
            String key = String.format("ranking:score:server:%d", serverId);
            jedis.zadd(key, score, userId);
            
            // åŒºæœæ’è¡Œæ¦œä¿å­˜30å¤©
            jedis.expire(key, 30 * 24 * 3600);
        }
        
        // å®æ—¶æ´»åŠ¨æ’è¡Œæ¦œ
        public void updateActivityRanking(String activityId, String userId, long score) {
            String key = "ranking:activity:" + activityId;
            jedis.zadd(key, score, userId);
            
            // æ´»åŠ¨ç»“æŸåè‡ªåŠ¨è¿‡æœŸ
            long activityEndTime = getActivityEndTime(activityId);
            jedis.expireAt(key, activityEndTime);
        }
    }
}
```

#### ğŸ—‚ å¤šç»´åº¦æ’è¡Œæ¦œè®¾è®¡

```java
public class MultiDimensionRanking {
    
    // ç”µå•†å•†å“æ’è¡Œæ¦œ
    public static class ProductRankingModel {
        
        // ç»¼åˆè¯„åˆ†æ’è¡Œæ¦œ
        public void updateProductRanking(String productId, ProductMetrics metrics) {
            // ç»¼åˆè¯„åˆ†ç®—æ³•ï¼šé”€é‡(40%) + è¯„åˆ†(30%) + æ”¶è—(20%) + æµè§ˆ(10%)
            double score = metrics.getSalesCount() * 0.4 +
                          metrics.getAvgRating() * 100 * 0.3 +
                          metrics.getFavoriteCount() * 0.2 +
                          metrics.getViewCount() * 0.001 * 0.1;
            
            jedis.zadd("ranking:product:comprehensive", score, productId);
        }
        
        // åˆ†ç±»æ’è¡Œæ¦œ
        public void updateCategoryRanking(String category, String productId, double score) {
            String key = "ranking:product:category:" + category;
            jedis.zadd(key, score, productId);
            
            // åˆ†ç±»æ’è¡Œæ¦œæ¯å¤©æ›´æ–°ï¼Œä¿å­˜3å¤©
            jedis.expire(key, 3 * 24 * 3600);
        }
        
        // æ—¶é—´æ®µæ’è¡Œæ¦œ
        public void updateTimeRangeRanking(String productId, double score) {
            String today = LocalDate.now().toString();
            String thisWeek = getWeekKey();
            String thisMonth = getMonthKey();
            
            // åŒæ—¶æ›´æ–°æ—¥ã€å‘¨ã€æœˆæ’è¡Œæ¦œ
            jedis.zadd("ranking:product:daily:" + today, score, productId);
            jedis.zadd("ranking:product:weekly:" + thisWeek, score, productId);
            jedis.zadd("ranking:product:monthly:" + thisMonth, score, productId);
        }
    }
}
```

### 5.2 åˆ†æ•°è®¾è®¡åŸåˆ™


#### ğŸ§® åˆ†æ•°ç²¾åº¦å’ŒèŒƒå›´æ§åˆ¶

```java
public class ScoreDesignPrinciples {
    
    // åŸåˆ™1ï¼šä½¿ç”¨æ•´æ•°åˆ†æ•°é¿å…æµ®ç‚¹ç²¾åº¦é—®é¢˜
    public void useIntegerScores() {
        // âŒ æµ®ç‚¹åˆ†æ•°å¯èƒ½æœ‰ç²¾åº¦é—®é¢˜
        // double score = calculateScore(); // å¯èƒ½æ˜¯ 98.67000000001
        
        // âœ… æ•´æ•°åˆ†æ•°ç¡®ä¿ç²¾åº¦
        long integerScore = Math.round(calculateScore() * 1000); // 98670
        jedis.zadd("ranking", integerScore, userId);
    }
    
    // åŸåˆ™2ï¼šåˆ†æ•°è¦å…·æœ‰å•è°ƒæ€§
    public double createMonotonicScore(long timestamp, int priority) {
        // æ—¶é—´æˆ³ç¡®ä¿æ—¶é—´ç»´åº¦å•è°ƒï¼Œä¼˜å…ˆçº§ç¡®ä¿åŒä¸€æ—¶é—´çš„æ’åº
        return timestamp * 1000.0 + priority;
    }
    
    // åŸåˆ™3ï¼šåˆ†æ•°èŒƒå›´è¦åˆç†
    public double normalizeToReasonableRange(double rawScore) {
        // å°†åˆ†æ•°æ§åˆ¶åœ¨åˆç†èŒƒå›´å†…ï¼Œé¿å…è¿‡å¤§æ•°å€¼
        double minScore = 0;
        double maxScore = 1000000;
        
        return Math.max(minScore, Math.min(maxScore, rawScore));
    }
    
    // åŸåˆ™4ï¼šæ”¯æŒå¤šç»´åº¦æƒé‡
    public double createWeightedScore(Map<String, Double> dimensions, Map<String, Double> weights) {
        double totalScore = 0;
        double totalWeight = 0;
        
        for (Map.Entry<String, Double> entry : dimensions.entrySet()) {
            String dimension = entry.getKey();
            Double value = entry.getValue();
            Double weight = weights.getOrDefault(dimension, 1.0);
            
            totalScore += value * weight;
            totalWeight += weight;
        }
        
        // å½’ä¸€åŒ–å¤„ç†
        return totalWeight > 0 ? totalScore / totalWeight : 0;
    }
}
```

### 5.3 è¿‡æœŸæ—¶é—´ç­–ç•¥


#### â° TTLç­–ç•¥è®¾è®¡

```java
public class TTLStrategies {
    
    // ä¸šåŠ¡ç±»å‹ä¸TTLæ˜ å°„
    private static final Map<String, Integer> TTL_CONFIG = Map.of(
        "realtime", 300,        // å®æ—¶æ’è¡Œæ¦œï¼š5åˆ†é’Ÿ
        "daily", 86400 * 2,     // æ—¥æ’è¡Œæ¦œï¼š2å¤©
        "weekly", 86400 * 14,   // å‘¨æ’è¡Œæ¦œï¼š2å‘¨
        "monthly", 86400 * 62,  // æœˆæ’è¡Œæ¦œï¼š2ä¸ªæœˆ
        "activity", -1,         // æ´»åŠ¨æ’è¡Œæ¦œï¼šæ´»åŠ¨ç»“æŸæ—¶é—´
        "permanent", -1         // æ°¸ä¹…æ’è¡Œæ¦œï¼šä¸è¿‡æœŸ
    );
    
    public void setRankingTTL(String key, String rankingType) {
        Integer ttl = TTL_CONFIG.get(rankingType);
        
        if (ttl != null && ttl > 0) {
            jedis.expire(key, ttl);
        } else if ("activity".equals(rankingType)) {
            // æ´»åŠ¨æ’è¡Œæ¦œï¼šæ ¹æ®æ´»åŠ¨ç»“æŸæ—¶é—´è®¾ç½®
            long endTime = getActivityEndTime(extractActivityId(key));
            jedis.expireAt(key, endTime);
        }
        // permanentç±»å‹ä¸è®¾ç½®TTL
    }
    
    // æ™ºèƒ½TTLç»­æœŸ
    public void renewTTLIfNeeded(String key) {
        Long currentTTL = jedis.ttl(key);
        
        if (currentTTL != null && currentTTL > 0 && currentTTL < 3600) {
            // å¦‚æœTTLå°äº1å°æ—¶ï¼Œä¸”æœ€è¿‘æœ‰è®¿é—®ï¼Œåˆ™ç»­æœŸ
            if (isRecentlyAccessed(key)) {
                String rankingType = extractRankingType(key);
                setRankingTTL(key, rankingType);
            }
        }
    }
    
    // æ‰¹é‡æ¸…ç†è¿‡æœŸæ’è¡Œæ¦œ
    @Scheduled(cron = "0 0 3 * * ?") // æ¯å¤©å‡Œæ™¨3ç‚¹
    public void cleanupExpiredRankings() {
        Set<String> allKeys = jedis.keys("ranking:*");
        
        for (String key : allKeys) {
            Long ttl = jedis.ttl(key);
            
            // æ¸…ç†å·²è¿‡æœŸä½†Redisæœªè‡ªåŠ¨åˆ é™¤çš„key
            if (ttl != null && ttl == -2) {
                jedis.del(key);
            }
            
            // æ¸…ç†é•¿æ—¶é—´æœªè®¿é—®çš„temporaryæ’è¡Œæ¦œ
            if (key.contains("temp:") && !isRecentlyAccessed(key)) {
                jedis.del(key);
            }
        }
    }
}
```

---

## 6. ğŸ“Š æ€§èƒ½ç›‘æ§ä¸è°ƒä¼˜


### 6.1 ZSetæ€§èƒ½æŒ‡æ ‡ç›‘æ§


#### ğŸ“ˆ å…³é”®æ€§èƒ½æŒ‡æ ‡

```java
@Component
public class ZSetPerformanceMonitor {
    
    // ç›‘æ§æŒ‡æ ‡å®šä¹‰
    public static class ZSetMetrics {
        long keyCount;          // ZSetæ•°é‡
        long totalMembers;      // æ€»æˆå‘˜æ•°
        long totalMemoryBytes;  // æ€»å†…å­˜å ç”¨
        double avgOperationTime; // å¹³å‡æ“ä½œè€—æ—¶
        long slowQueryCount;    // æ…¢æŸ¥è¯¢æ•°é‡
        Map<String, Long> operationCounts; // å„æ“ä½œæ‰§è¡Œæ¬¡æ•°
    }
    
    // æ”¶é›†ZSetç›¸å…³æŒ‡æ ‡
    public ZSetMetrics collectMetrics() {
        ZSetMetrics metrics = new ZSetMetrics();
        
        // è·å–æ‰€æœ‰ZSet keys
        Set<String> zsetKeys = jedis.keys("*");
        zsetKeys = zsetKeys.stream()
            .filter(key -> "zset".equals(jedis.type(key)))
            .collect(Collectors.toSet());
        
        metrics.keyCount = zsetKeys.size();
        
        // ç»Ÿè®¡æ€»æˆå‘˜æ•°å’Œå†…å­˜ä½¿ç”¨
        long totalMembers = 0;
        long totalMemory = 0;
        
        for (String key : zsetKeys) {
            totalMembers += jedis.zcard(key);
            
            // è·å–å†…å­˜ä½¿ç”¨ï¼ˆéœ€è¦Redis 4.0+ï¼‰
            try {
                String memoryInfo = jedis.memoryUsage(key);
                if (memoryInfo != null) {
                    totalMemory += Long.parseLong(memoryInfo);
                }
            } catch (Exception e) {
                // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨DEBUG OBJECTä¼°ç®—
                totalMemory += estimateMemoryUsage(key);
            }
        }
        
        metrics.totalMembers = totalMembers;
        metrics.totalMemoryBytes = totalMemory;
        
        return metrics;
    }
    
    // æ…¢æŸ¥è¯¢ç›‘æ§
    @EventListener
    public void onSlowQuery(RedisSlowQueryEvent event) {
        if (isZSetOperation(event.getCommand())) {
            // è®°å½•ZSetæ…¢æŸ¥è¯¢
            logger.warn("ZSet slow query detected: {} took {}ms", 
                event.getCommand(), event.getDuration());
            
            // å‘é€å‘Šè­¦
            if (event.getDuration() > 1000) { // è¶…è¿‡1ç§’
                alertManager.sendAlert("ZSet operation timeout", 
                    String.format("Command: %s, Duration: %dms", 
                        event.getCommand(), event.getDuration()));
            }
        }
    }
}
```

#### ğŸ” å®æ—¶æ€§èƒ½åˆ†æ

```java
public class RealTimePerformanceAnalyzer {
    
    // æ“ä½œè€—æ—¶ç»Ÿè®¡
    private final Map<String, CircularFifoBuffer> operationTimes = new ConcurrentHashMap<>();
    
    public <T> T monitorOperation(String operation, Supplier<T> supplier) {
        long startTime = System.currentTimeMillis();
        
        try {
            T result = supplier.get();
            
            long duration = System.currentTimeMillis() - startTime;
            recordOperationTime(operation, duration);
            
            return result;
        } catch (Exception e) {
            long duration = System.currentTimeMillis() - startTime;
            recordOperationTime(operation + "_ERROR", duration);
            throw e;
        }
    }
    
    private void recordOperationTime(String operation, long duration) {
        operationTimes.computeIfAbsent(operation, 
            k -> new CircularFifoBuffer(1000)).add(duration);
        
        // å®æ—¶å‘Šè­¦æ£€æŸ¥
        if (duration > getSlowThreshold(operation)) {
            handleSlowOperation(operation, duration);
        }
    }
    
    // è·å–æ“ä½œç»Ÿè®¡ä¿¡æ¯
    public OperationStats getOperationStats(String operation) {
        CircularFifoBuffer times = operationTimes.get(operation);
        if (times == null || times.isEmpty()) {
            return new OperationStats();
        }
        
        List<Long> timeList = new ArrayList<>(times);
        Collections.sort(timeList);
        
        return new OperationStats(
            timeList.stream().mapToLong(Long::longValue).average().orElse(0), // å¹³å‡å€¼
            timeList.get(timeList.size() / 2),      // ä¸­ä½æ•°
            timeList.get((int) (timeList.size() * 0.95)), // P95
            timeList.get((int) (timeList.size() * 0.99))  // P99
        );
    }
}
```

### 6.2 è‡ªåŠ¨è°ƒä¼˜ç­–ç•¥


```java
@Component
public class AutoTuningService {
    
    // è‡ªåŠ¨åˆ†ç‰‡é˜ˆå€¼
    private static final long AUTO_SHARD_THRESHOLD = 100000;
    
    // å®šæœŸæ£€æŸ¥æ˜¯å¦éœ€è¦åˆ†ç‰‡
    @Scheduled(fixedRate = 300000) // 5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    public void checkAndAutoShard() {
        Set<String> largeZSets = findLargeZSets();
        
        for (String key : largeZSets) {
            long memberCount = jedis.zcard(key);
            
            if (memberCount > AUTO_SHARD_THRESHOLD) {
                logger.info("Auto-sharding large ZSet: {} with {} members", key, memberCount);
                autoShardZSet(key);
            }
        }
    }
    
    // è‡ªåŠ¨åˆ†ç‰‡å®ç°
    private void autoShardZSet(String originalKey) {
        // ç”Ÿæˆåˆ†ç‰‡é”®å
        String shardPrefix = originalKey + ":shard:";
        int shardCount = calculateOptimalShardCount(jedis.zcard(originalKey));
        
        // æ•°æ®è¿ç§»
        long batchSize = 1000;
        long offset = 0;
        
        while (true) {
            Set<Tuple> batch = jedis.zrangeWithScores(originalKey, offset, offset + batchSize - 1);
            
            if (batch.isEmpty()) {
                break;
            }
            
            // åˆ†é…åˆ°ä¸åŒåˆ†ç‰‡
            for (Tuple tuple : batch) {
                int shardIndex = Math.abs(tuple.getElement().hashCode()) % shardCount;
                String shardKey = shardPrefix + shardIndex;
                
                jedis.zadd(shardKey, tuple.getScore(), tuple.getElement());
            }
            
            offset += batchSize;
        }
        
        // è®¾ç½®åˆ†ç‰‡å…ƒä¿¡æ¯
        jedis.hset(originalKey + ":meta", "sharded", "true");
        jedis.hset(originalKey + ":meta", "shard_count", String.valueOf(shardCount));
        
        // é‡å‘½ååŸå§‹keyä¸ºbackup
        jedis.rename(originalKey, originalKey + ":backup:" + System.currentTimeMillis());
    }
    
    // è®¡ç®—æœ€ä¼˜åˆ†ç‰‡æ•°
    private int calculateOptimalShardCount(long memberCount) {
        // æ¯ä¸ªåˆ†ç‰‡ç›®æ ‡å¤§å°ï¼š5ä¸‡æ¡è®°å½•
        int targetShardSize = 50000;
        int shardCount = (int) Math.ceil((double) memberCount / targetShardSize);
        
        // åˆ†ç‰‡æ•°åº”è¯¥æ˜¯2çš„å¹‚ï¼Œä¾¿äºå“ˆå¸Œåˆ†å¸ƒ
        return Integer.highestOneBit(shardCount - 1) << 1;
    }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 æ€§èƒ½ä¼˜åŒ–å¿…çŸ¥è¦ç‚¹


```
ğŸ”¸ æ•°æ®é‡æ§åˆ¶ï¼šå•ä¸ªZSetå»ºè®®ä¸è¶…è¿‡10ä¸‡æˆå‘˜
ğŸ”¸ åˆ†ç‰‡ç­–ç•¥ï¼šæŒ‰æ—¶é—´ã€ç”¨æˆ·ã€åˆ†æ•°èŒƒå›´ç­‰ç»´åº¦åˆç†åˆ†ç‰‡
ğŸ”¸ æŸ¥è¯¢ä¼˜åŒ–ï¼šé¿å…å¤§èŒƒå›´æŸ¥è¯¢ï¼Œä½¿ç”¨åˆ†é¡µå’Œé™åˆ¶
ğŸ”¸ ç¼“å­˜ç­–ç•¥ï¼šçƒ­ç‚¹æ•°æ®å•ç‹¬ç¼“å­˜ï¼Œå¤šçº§ç¼“å­˜æå‡æ€§èƒ½
ğŸ”¸ åˆ†æ•°è®¾è®¡ï¼šä½¿ç”¨æ•´æ•°åˆ†æ•°ï¼Œé¿å…æµ®ç‚¹ç²¾åº¦é—®é¢˜
```

### 7.2 å…³é”®é™·é˜±è¦é¿å…


**ğŸ”¹ å¤§èŒƒå›´æŸ¥è¯¢é™·é˜±**
```
âŒ å±é™©æ“ä½œï¼šZRANGE key 0 -1ï¼ˆè·å–å…¨éƒ¨æ•°æ®ï¼‰
âŒ å±é™©æ“ä½œï¼šZRANGEBYSCORE key -inf +infï¼ˆæ— é™èŒƒå›´æŸ¥è¯¢ï¼‰
âœ… å®‰å…¨æ“ä½œï¼šåˆ†é¡µæŸ¥è¯¢ã€é™åˆ¶è¿”å›æ•°é‡ã€æ‰¹é‡å¤„ç†
```

**ğŸ”¹ åˆ†æ•°ç²¾åº¦é™·é˜±**
```
âŒ æµ®ç‚¹åˆ†æ•°ï¼šå¯èƒ½å‡ºç°ç²¾åº¦è¯¯å·®
âœ… æ•´æ•°åˆ†æ•°ï¼šç²¾ç¡®å¯æ§ï¼Œé¿å…ç²¾åº¦é—®é¢˜
âœ… åˆ†æ•°å½’ä¸€åŒ–ï¼šæ§åˆ¶åœ¨åˆç†èŒƒå›´å†…
```

**ğŸ”¹ å†…å­˜ä½¿ç”¨é™·é˜±**
```
é—®é¢˜ï¼šZSetå ç”¨å†…å­˜æ¯”é¢„æœŸå¤§å¾ˆå¤š
åŸå› ï¼šè·³è·ƒè¡¨å’Œå“ˆå¸Œè¡¨åŒé‡å­˜å‚¨
è§£å†³ï¼šåˆç†è¯„ä¼°å†…å­˜éœ€æ±‚ï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå®šæœŸæ¸…ç†
```

### 7.3 æœ€ä½³å®è·µè¦ç‚¹


**ğŸ¯ è®¾è®¡åŸåˆ™**
- å•ä¸€èŒè´£ï¼šæ¯ä¸ªZSetåªè´Ÿè´£ä¸€ç§æ’åº
- åˆç†ç²’åº¦ï¼šé¿å…è¿‡å¤§ä¹Ÿé¿å…è¿‡åº¦åˆ†ç‰‡
- ç”Ÿå‘½å‘¨æœŸï¼šè®¾ç½®åˆç†çš„TTLç­–ç•¥

**ğŸ”§ ä¼˜åŒ–ç­–ç•¥**
- çƒ­ç‚¹åˆ†ç¦»ï¼šé«˜é¢‘è®¿é—®æ•°æ®å•ç‹¬å­˜å‚¨
- æ‰¹é‡æ“ä½œï¼šå‡å°‘ç½‘ç»œå¾€è¿”æ¬¡æ•°
- å¼‚æ­¥æ›´æ–°ï¼šé™ä½å®æ—¶æ€§è¦æ±‚ï¼Œæå‡æ€§èƒ½

**ğŸ“Š ç›‘æ§å‘Šè­¦**
- å…³é”®æŒ‡æ ‡ï¼šå†…å­˜ä½¿ç”¨ã€æ“ä½œè€—æ—¶ã€æ…¢æŸ¥è¯¢
- è‡ªåŠ¨å‘Šè­¦ï¼šå¼‚å¸¸æƒ…å†µåŠæ—¶é€šçŸ¥
- æ€§èƒ½åˆ†æï¼šå®šæœŸåˆ†ææ€§èƒ½ç“¶é¢ˆ

### 7.4 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ† æ’è¡Œæ¦œç³»ç»Ÿ**
```
å®æ—¶æ’è¡Œæ¦œï¼š
- ä½¿ç”¨çƒ­ç‚¹ç¼“å­˜æå‡æŸ¥è¯¢é€Ÿåº¦
- å¼‚æ­¥æ›´æ–°å‡å°‘å†™å…¥å‹åŠ›
- åˆ†é¡µæŸ¥è¯¢é¿å…å¤§æ•°æ®é‡ä¼ è¾“

å†å²æ’è¡Œæ¦œï¼š
- æŒ‰æ—¶é—´åˆ†ç‰‡å­˜å‚¨
- è®¾ç½®åˆç†è¿‡æœŸæ—¶é—´
- å®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®
```

**ğŸ›’ æ¨èç³»ç»Ÿ**
```
å•†å“æ¨èï¼š
- å¤šç»´åº¦åˆ†æ•°è®¾è®¡
- ä¸ªæ€§åŒ–æ¨èåˆ†ç‰‡
- å®æ—¶æ›´æ–°ä¸æ‰¹é‡è®¡ç®—ç»“åˆ
```

**ğŸ“± ç¤¾äº¤åº”ç”¨**
```
æœ‹å‹åŠ¨æ€ï¼š
- æŒ‰æ—¶é—´çº¿åˆ†ç‰‡
- çƒ­é—¨å†…å®¹ç¼“å­˜
- ä¸ªæ€§åŒ–å±•ç¤ºä¼˜åŒ–
```

### 7.5 è¿›é˜¶å­¦ä¹ å»ºè®®


```
ğŸ“š æ·±å…¥å­¦ä¹ æ–¹å‘ï¼š
1. Redisé›†ç¾¤ç¯å¢ƒä¸‹çš„ZSetä½¿ç”¨
2. ZSetä¸å…¶ä»–æ•°æ®ç»“æ„çš„ç»„åˆä½¿ç”¨
3. å¤§æ•°æ®é‡ä¸‹çš„åˆ†å¸ƒå¼æ’åºç­–ç•¥
4. å®æ—¶è®¡ç®—ä¸ç¦»çº¿è®¡ç®—çš„ç»“åˆ

ğŸ”¬ å®è·µé¡¹ç›®å»ºè®®ï¼š
1. å®ç°ä¸€ä¸ªé«˜æ€§èƒ½æ¸¸æˆæ’è¡Œæ¦œç³»ç»Ÿ
2. æ„å»ºç”µå•†å•†å“æ¨èå¼•æ“
3. å¼€å‘å®æ—¶çƒ­ç‚¹å†…å®¹æ’åºç³»ç»Ÿ
4. è®¾è®¡åˆ†å¸ƒå¼é™æµæ’é˜Ÿç³»ç»Ÿ
```

---

**ğŸ§  æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
> *"ZSetä¼˜åŒ–æœ‰é—¨é“ï¼Œåˆ†ç‰‡ç¼“å­˜ä¸èƒ½å°‘ï¼›*  
> *å¤§é‡æŸ¥è¯¢è¦åˆ†é¡µï¼Œåˆ†æ•°ç²¾åº¦æ•´æ•°å¥½ï¼›*  
> *å†…å­˜ç›‘æ§å¾ˆé‡è¦ï¼ŒTTLè®¾ç½®åˆ«å¿˜æ‰ï¼›*  
> *çƒ­ç‚¹åˆ†ç¦»æ€§èƒ½é«˜ï¼Œæœ€ä½³å®è·µè¦è®°ç‰¢ï¼"*