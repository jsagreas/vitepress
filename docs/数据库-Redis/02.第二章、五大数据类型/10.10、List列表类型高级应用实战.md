---
title: 10ã€Liståˆ—è¡¨ç±»å‹é«˜çº§åº”ç”¨å®æˆ˜
---
## ğŸ“š ç›®å½•

1. [Liståˆ—è¡¨åŸºç¡€å›é¡¾](#1-Liståˆ—è¡¨åŸºç¡€å›é¡¾)
2. [æ¶ˆæ¯é˜Ÿåˆ—å®ç°](#2-æ¶ˆæ¯é˜Ÿåˆ—å®ç°)
3. [ä»»åŠ¡é˜Ÿåˆ—ç³»ç»Ÿ](#3-ä»»åŠ¡é˜Ÿåˆ—ç³»ç»Ÿ)
4. [æ—¶é—´çº¿åŠŸèƒ½](#4-æ—¶é—´çº¿åŠŸèƒ½)
5. [å®æˆ˜æ¡ˆä¾‹è¯¦è§£](#5-å®æˆ˜æ¡ˆä¾‹è¯¦è§£)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ“ Liståˆ—è¡¨åŸºç¡€å›é¡¾


### 1.1 ä»€ä¹ˆæ˜¯Redis List


**ç®€å•ç†è§£**ï¼šRedisçš„Listå°±åƒç°å®ä¸­çš„æ’é˜Ÿé˜Ÿåˆ—ï¼Œæœ‰é¡ºåºã€å¯ä»¥ä»å¤´éƒ¨æˆ–å°¾éƒ¨æ“ä½œã€‚

```
æƒ³è±¡ä¸€ä¸ªæ’é˜Ÿåœºæ™¯ï¼š
â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”
â”‚  A  â”‚  B  â”‚  C  â”‚  D  â”‚  â† é˜Ÿåˆ—ï¼ŒAæœ€å…ˆè¿›å…¥
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜
 å¤´éƒ¨                   å°¾éƒ¨
(å·¦ä¾§)                 (å³ä¾§)
```

### 1.2 æ ¸å¿ƒç‰¹ç‚¹


**ğŸ”¸ æœ‰åºæ€§**ï¼šå…ƒç´ æŒ‰æ·»åŠ é¡ºåºæ’åˆ—ï¼Œæœ‰å…ˆåä¹‹åˆ†
**ğŸ”¸ å¯é‡å¤**ï¼šåŒä¸€ä¸ªå€¼å¯ä»¥å‡ºç°å¤šæ¬¡
**ğŸ”¸ åŒç«¯æ“ä½œ**ï¼šå¯ä»¥ä»å·¦è¾¹(å¤´éƒ¨)æˆ–å³è¾¹(å°¾éƒ¨)æ“ä½œ
**ğŸ”¸ ç´¢å¼•è®¿é—®**ï¼šå¯ä»¥é€šè¿‡ä½ç½®(ç´¢å¼•)ç›´æ¥è®¿é—®å…ƒç´ 

### 1.3 åŸºæœ¬æ“ä½œå›é¡¾


```bash
# ä»å·¦è¾¹(å¤´éƒ¨)æ·»åŠ å…ƒç´ 
LPUSH mylist A B C    # ç»“æœï¼šC B A

# ä»å³è¾¹(å°¾éƒ¨)æ·»åŠ å…ƒç´   
RPUSH mylist D E      # ç»“æœï¼šC B A D E

# ä»å·¦è¾¹å¼¹å‡ºå…ƒç´ 
LPOP mylist          # è¿”å›ï¼šCï¼Œå‰©ä½™ï¼šB A D E

# ä»å³è¾¹å¼¹å‡ºå…ƒç´ 
RPOP mylist          # è¿”å›ï¼šEï¼Œå‰©ä½™ï¼šB A D
```

---

## 2. ğŸ“¨ æ¶ˆæ¯é˜Ÿåˆ—å®ç°


### 2.1 ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—


**é€šä¿—è§£é‡Š**ï¼šå°±åƒé‚®å±€çš„ä¿¡ç®±ï¼Œå‘ä¿¡äººæŠŠä¿¡æŠ•è¿›å»ï¼Œæ”¶ä¿¡äººæ¥å–ä¿¡ã€‚å‘ä¿¡äººä¸ç”¨ç­‰æ”¶ä¿¡äººåœ¨åœºï¼Œæ”¶ä¿¡äººä¹Ÿä¸ç”¨æ‹…å¿ƒé”™è¿‡ä¿¡ä»¶ã€‚

```
æ¶ˆæ¯é˜Ÿåˆ—å·¥ä½œåŸç†ï¼š
ç”Ÿäº§è€… â”€â”€å‘é€æ¶ˆæ¯â”€â”€> [æ¶ˆæ¯é˜Ÿåˆ—] â”€â”€å–å‡ºæ¶ˆæ¯â”€â”€> æ¶ˆè´¹è€…
(å‘ä¿¡äºº)              (ä¿¡ç®±)              (æ”¶ä¿¡äºº)
```

### 2.2 ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼


**åŸºæœ¬æ¦‚å¿µ**ï¼š
- **ç”Ÿäº§è€…**ï¼šäº§ç”Ÿæ¶ˆæ¯çš„ç¨‹åº(æ¯”å¦‚ç”¨æˆ·æ³¨å†ŒæˆåŠŸåéœ€è¦å‘é‚®ä»¶)
- **æ¶ˆè´¹è€…**ï¼šå¤„ç†æ¶ˆæ¯çš„ç¨‹åº(æ¯”å¦‚ä¸“é—¨è´Ÿè´£å‘é‚®ä»¶çš„æœåŠ¡)
- **é˜Ÿåˆ—**ï¼šå­˜æ”¾æ¶ˆæ¯çš„åœ°æ–¹(Redis Listå……å½“è¿™ä¸ªè§’è‰²)

**ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- **è§£è€¦**ï¼šç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¸ç”¨ç›´æ¥è”ç³»
- **ç¼“å†²**ï¼šç”Ÿäº§è€…äº§ç”Ÿæ¶ˆæ¯å¾ˆå¿«æ—¶ï¼Œæ¶ˆè´¹è€…å¯ä»¥æ…¢æ…¢å¤„ç†
- **å¯é **ï¼šæ¶ˆæ¯ä¸ä¼šä¸¢å¤±ï¼Œå­˜åœ¨é˜Ÿåˆ—é‡Œ

### 2.3 ä»£ç å®ç°ç¤ºä¾‹


**ç”Ÿäº§è€…ä»£ç (å‘é€æ¶ˆæ¯)**ï¼š
```python
import redis

# è¿æ¥Redis
r = redis.Redis(host='localhost', port=6379, db=0)

def send_message(queue_name, message):
    """å‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ—"""
    # ä½¿ç”¨LPUSHä»å·¦è¾¹æ·»åŠ æ¶ˆæ¯(æ–°æ¶ˆæ¯åœ¨å‰é¢)
    r.lpush(queue_name, message)
    print(f"å·²å‘é€æ¶ˆæ¯: {message}")

# å‘é€å‡ æ¡æ¶ˆæ¯
send_message("email_queue", "å‘é€æ¬¢è¿é‚®ä»¶ç»™ç”¨æˆ·123")
send_message("email_queue", "å‘é€è®¢å•ç¡®è®¤é‚®ä»¶ç»™ç”¨æˆ·456")
```

**æ¶ˆè´¹è€…ä»£ç (å¤„ç†æ¶ˆæ¯)**ï¼š
```python
import redis
import time

r = redis.Redis(host='localhost', port=6379, db=0)

def consume_message(queue_name):
    """ä»é˜Ÿåˆ—æ¶ˆè´¹æ¶ˆæ¯"""
    while True:
        # ä½¿ç”¨BRPOPä»å³è¾¹é˜»å¡å¼å–å‡ºæ¶ˆæ¯(å…ˆè¿›å…ˆå‡º)
        message = r.brpop(queue_name, timeout=5)
        
        if message:
            queue, msg = message
            msg = msg.decode('utf-8')
            print(f"æ”¶åˆ°æ¶ˆæ¯: {msg}")
            
            # å¤„ç†æ¶ˆæ¯(æ¯”å¦‚çœŸæ­£å‘é‚®ä»¶)
            process_message(msg)
        else:
            print("æ²¡æœ‰æ–°æ¶ˆæ¯ï¼Œç»§ç»­ç­‰å¾…...")

def process_message(message):
    """å…·ä½“å¤„ç†æ¶ˆæ¯çš„é€»è¾‘"""
    print(f"æ­£åœ¨å¤„ç†: {message}")
    time.sleep(2)  # æ¨¡æ‹Ÿå¤„ç†æ—¶é—´
    print("å¤„ç†å®Œæˆï¼")

# å¼€å§‹æ¶ˆè´¹æ¶ˆæ¯
consume_message("email_queue")
```

### 2.4 é˜Ÿåˆ—å¯é æ€§ä¿è¯


**é—®é¢˜**ï¼šå¦‚æœæ¶ˆè´¹è€…å–å‡ºæ¶ˆæ¯åï¼Œè¿˜æ²¡å¤„ç†å®Œå°±å´©æºƒäº†æ€ä¹ˆåŠï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨"å·¥ä½œé˜Ÿåˆ—"æ¨¡å¼
```python
def reliable_consume(queue_name):
    """å¯é çš„æ¶ˆæ¯æ¶ˆè´¹"""
    processing_queue = f"{queue_name}:processing"
    
    while True:
        # 1. åŸå­æ€§åœ°ä»é˜Ÿåˆ—ç§»åŠ¨æ¶ˆæ¯åˆ°å¤„ç†é˜Ÿåˆ—
        message = r.brpoplpush(queue_name, processing_queue, timeout=5)
        
        if message:
            try:
                msg = message.decode('utf-8')
                print(f"å¼€å§‹å¤„ç†: {msg}")
                
                # 2. å¤„ç†æ¶ˆæ¯
                process_message(msg)
                
                # 3. å¤„ç†æˆåŠŸï¼Œä»å¤„ç†é˜Ÿåˆ—åˆ é™¤
                r.lrem(processing_queue, 1, message)
                print("æ¶ˆæ¯å¤„ç†æˆåŠŸå¹¶åˆ é™¤")
                
            except Exception as e:
                print(f"å¤„ç†å¤±è´¥: {e}")
                # å¯ä»¥é€‰æ‹©é‡æ–°æ”¾å›é˜Ÿåˆ—æˆ–è®°å½•é”™è¯¯
```

**æµç¨‹è¯´æ˜**ï¼š
```
1. æ™®é€šé˜Ÿåˆ— â”€â”€BRPOPLPUSHâ”€â”€> å¤„ç†é˜Ÿåˆ— (åŸå­æ“ä½œ)
2. å¤„ç†æ¶ˆæ¯
3. æˆåŠŸï¼šä»å¤„ç†é˜Ÿåˆ—åˆ é™¤
   å¤±è´¥ï¼šæ¶ˆæ¯ä»åœ¨å¤„ç†é˜Ÿåˆ—ï¼Œå¯ä»¥é‡è¯•
```

---

## 3. âš™ï¸ ä»»åŠ¡é˜Ÿåˆ—ç³»ç»Ÿ


### 3.1 ä»»åŠ¡é˜Ÿåˆ—æ˜¯ä»€ä¹ˆ


**ç”Ÿæ´»ä¾‹å­**ï¼šå°±åƒå¾…åŠäº‹é¡¹æ¸…å•ï¼Œä½ æŠŠè¦åšçš„äº‹æƒ…å†™ä¸‹æ¥ï¼Œç„¶åæŒ‰ä¼˜å…ˆçº§æˆ–é¡ºåºä¸€ä»¶ä»¶å®Œæˆã€‚

**æŠ€æœ¯åœºæ™¯**ï¼š
- ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡ â†’ ç”Ÿæˆç¼©ç•¥å›¾(å¼‚æ­¥ä»»åŠ¡)
- ç”¨æˆ·æ³¨å†Œ â†’ å‘é€æ¬¢è¿é‚®ä»¶(å¼‚æ­¥ä»»åŠ¡)  
- æ•°æ®å¯¼å…¥ â†’ æ¸…æ´—æ•°æ®(è€—æ—¶ä»»åŠ¡)

### 3.2 å¼‚æ­¥ä»»åŠ¡å¤„ç†


**åŒæ­¥ vs å¼‚æ­¥**ï¼š
```
åŒæ­¥å¤„ç†ï¼š
ç”¨æˆ·æ³¨å†Œ â†’ [ç­‰å¾…å‘é‚®ä»¶å®Œæˆ] â†’ è¿”å›æˆåŠŸé¡µé¢
(ç”¨æˆ·è¦ç­‰å¾ˆä¹…)

å¼‚æ­¥å¤„ç†ï¼š
ç”¨æˆ·æ³¨å†Œ â†’ [æ”¾å…¥ä»»åŠ¡é˜Ÿåˆ—] â†’ ç«‹å³è¿”å›æˆåŠŸé¡µé¢
          â†“
[åå°æ…¢æ…¢å‘é‚®ä»¶]
(ç”¨æˆ·ä½“éªŒå¥½)
```

**å®ç°ä»£ç **ï¼š
```python
import json
import uuid
from datetime import datetime

def add_task(task_type, task_data, priority=0):
    """æ·»åŠ å¼‚æ­¥ä»»åŠ¡"""
    task = {
        'id': str(uuid.uuid4()),
        'type': task_type,
        'data': task_data,
        'priority': priority,
        'created_at': datetime.now().isoformat(),
        'status': 'pending'
    }
    
    # æ ¹æ®ä¼˜å…ˆçº§é€‰æ‹©ä¸åŒé˜Ÿåˆ—
    queue_name = f"tasks:priority_{priority}"
    r.lpush(queue_name, json.dumps(task))
    
    print(f"ä»»åŠ¡å·²æ·»åŠ : {task['id']}")
    return task['id']

# ä½¿ç”¨ç¤ºä¾‹
add_task('send_email', {'to': 'user@example.com', 'subject': 'æ¬¢è¿'}, priority=1)
add_task('generate_thumbnail', {'image_path': '/upload/photo.jpg'}, priority=2)
```

### 3.3 ä»»åŠ¡ä¼˜å…ˆçº§ç®¡ç†


**å¤šé˜Ÿåˆ—ç­–ç•¥**ï¼š
```
é«˜ä¼˜å…ˆçº§é˜Ÿåˆ— (priority_1): é‚®ä»¶å‘é€ã€çŸ­ä¿¡é€šçŸ¥
ä¸­ä¼˜å…ˆçº§é˜Ÿåˆ— (priority_2): å›¾ç‰‡å¤„ç†ã€æ•°æ®åˆ†æ  
ä½ä¼˜å…ˆçº§é˜Ÿåˆ— (priority_3): æ—¥å¿—æ¸…ç†ã€æ•°æ®å¤‡ä»½
```

**ä»»åŠ¡è°ƒåº¦å™¨**ï¼š
```python
def task_scheduler():
    """ä»»åŠ¡è°ƒåº¦å™¨ - æŒ‰ä¼˜å…ˆçº§å¤„ç†ä»»åŠ¡"""
    queues = [
        "tasks:priority_1",  # é«˜ä¼˜å…ˆçº§
        "tasks:priority_2",  # ä¸­ä¼˜å…ˆçº§  
        "tasks:priority_3"   # ä½ä¼˜å…ˆçº§
    ]
    
    while True:
        task_found = False
        
        # æŒ‰ä¼˜å…ˆçº§é¡ºåºæ£€æŸ¥é˜Ÿåˆ—
        for queue in queues:
            task_json = r.rpop(queue)
            if task_json:
                task = json.loads(task_json.decode('utf-8'))
                execute_task(task)
                task_found = True
                break
        
        if not task_found:
            time.sleep(1)  # æ²¡æœ‰ä»»åŠ¡æ—¶ä¼‘æ¯ä¸€ä¸‹

def execute_task(task):
    """æ‰§è¡Œå…·ä½“ä»»åŠ¡"""
    print(f"æ‰§è¡Œä»»åŠ¡ {task['id']}: {task['type']}")
    
    try:
        if task['type'] == 'send_email':
            # å‘é‚®ä»¶é€»è¾‘
            send_email(task['data'])
        elif task['type'] == 'generate_thumbnail':
            # ç”Ÿæˆç¼©ç•¥å›¾é€»è¾‘
            generate_thumbnail(task['data'])
            
        print(f"ä»»åŠ¡ {task['id']} å®Œæˆ")
    except Exception as e:
        print(f"ä»»åŠ¡ {task['id']} å¤±è´¥: {e}")
```

### 3.4 ä»»åŠ¡çŠ¶æ€è·Ÿè¸ª


**çŠ¶æ€è®¾è®¡**ï¼š
```python
TASK_STATUS = {
    'pending': 'ç­‰å¾…å¤„ç†',
    'processing': 'æ­£åœ¨å¤„ç†', 
    'completed': 'å·²å®Œæˆ',
    'failed': 'å¤„ç†å¤±è´¥'
}
```

**çŠ¶æ€è·Ÿè¸ªå®ç°**ï¼š
```python
def track_task_status(task_id, status, result=None):
    """è·Ÿè¸ªä»»åŠ¡çŠ¶æ€"""
    task_key = f"task:status:{task_id}"
    status_data = {
        'status': status,
        'updated_at': datetime.now().isoformat()
    }
    
    if result:
        status_data['result'] = result
    
    r.hset(task_key, mapping=status_data)
    r.expire(task_key, 86400)  # 24å°æ—¶ååˆ é™¤

def get_task_status(task_id):
    """æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€"""
    task_key = f"task:status:{task_id}"
    return r.hgetall(task_key)
```

---

## 4. ğŸ“° æ—¶é—´çº¿åŠŸèƒ½


### 4.1 æ—¶é—´çº¿æ˜¯ä»€ä¹ˆ


**ç”Ÿæ´»ä¾‹å­**ï¼šå°±åƒå¾®ä¿¡æœ‹å‹åœˆï¼ŒæŒ‰æ—¶é—´é¡ºåºæ˜¾ç¤ºæœ€æ–°çš„åŠ¨æ€ï¼Œè¶Šæ–°çš„è¶Šåœ¨ä¸Šé¢ã€‚

**æŠ€æœ¯ç‰¹ç‚¹**ï¼š
- **æ—¶é—´é¡ºåº**ï¼šæœ€æ–°çš„å†…å®¹åœ¨å‰é¢
- **æµå¼æ›´æ–°**ï¼šä¸æ–­æœ‰æ–°å†…å®¹åŠ å…¥
- **åˆ†é¡µæŸ¥çœ‹**ï¼šä¸€æ¬¡çœ‹ä¸€éƒ¨åˆ†ï¼Œå¯ä»¥ç¿»é¡µ

### 4.2 ç”¨æˆ·åŠ¨æ€æ—¶é—´çº¿


**åœºæ™¯**ï¼šç¤¾äº¤ç½‘ç«™ï¼Œç”¨æˆ·è¦çœ‹å…³æ³¨çš„äººçš„æœ€æ–°åŠ¨æ€ã€‚

```
ç”¨æˆ·Aå…³æ³¨äº†Bã€Cã€D
Bå‘äº†ä¸€æ¡åŠ¨æ€ â†’ æ¨é€åˆ°Açš„æ—¶é—´çº¿
Cå‘äº†ä¸€æ¡åŠ¨æ€ â†’ æ¨é€åˆ°Açš„æ—¶é—´çº¿  
Då‘äº†ä¸€æ¡åŠ¨æ€ â†’ æ¨é€åˆ°Açš„æ—¶é—´çº¿

Açš„æ—¶é—´çº¿: [Dçš„åŠ¨æ€, Cçš„åŠ¨æ€, Bçš„åŠ¨æ€] (æœ€æ–°åœ¨å‰)
```

**ä»£ç å®ç°**ï¼š
```python
def post_message(user_id, content):
    """ç”¨æˆ·å‘å¸ƒåŠ¨æ€"""
    message = {
        'id': str(uuid.uuid4()),
        'user_id': user_id,
        'content': content,
        'timestamp': datetime.now().isoformat()
    }
    
    # è·å–è¯¥ç”¨æˆ·çš„ç²‰ä¸åˆ—è¡¨
    followers = get_followers(user_id)
    
    # æ¨é€åˆ°æ¯ä¸ªç²‰ä¸çš„æ—¶é—´çº¿
    for follower_id in followers:
        timeline_key = f"timeline:{follower_id}"
        r.lpush(timeline_key, json.dumps(message))
        
        # ä¿æŒæ—¶é—´çº¿é•¿åº¦ï¼Œåªä¿ç•™æœ€æ–°çš„1000æ¡
        r.ltrim(timeline_key, 0, 999)
    
    print(f"ç”¨æˆ·{user_id}çš„åŠ¨æ€å·²æ¨é€ç»™{len(followers)}ä¸ªç²‰ä¸")

def get_timeline(user_id, page=0, size=20):
    """è·å–ç”¨æˆ·æ—¶é—´çº¿"""
    timeline_key = f"timeline:{user_id}"
    start = page * size
    end = start + size - 1
    
    # è·å–æŒ‡å®šèŒƒå›´çš„åŠ¨æ€
    messages = r.lrange(timeline_key, start, end)
    
    timeline = []
    for msg in messages:
        timeline.append(json.loads(msg.decode('utf-8')))
    
    return timeline
```

### 4.3 æ“ä½œå†å²è®°å½•


**ç”¨é€”**ï¼šè®°å½•ç”¨æˆ·çš„æ“ä½œï¼Œç”¨äºå®¡è®¡ã€æ’¤é”€ã€é—®é¢˜æ’æŸ¥ã€‚

```python
def log_user_operation(user_id, operation, details):
    """è®°å½•ç”¨æˆ·æ“ä½œ"""
    log_entry = {
        'timestamp': datetime.now().isoformat(),
        'user_id': user_id,
        'operation': operation,
        'details': details,
        'ip': get_client_ip()  # å‡è®¾æœ‰è·å–IPçš„å‡½æ•°
    }
    
    # æ·»åŠ åˆ°æ“ä½œå†å²
    history_key = f"user:history:{user_id}"
    r.lpush(history_key, json.dumps(log_entry))
    
    # åªä¿ç•™æœ€è¿‘6ä¸ªæœˆçš„è®°å½•
    r.ltrim(history_key, 0, 10000)

def get_user_history(user_id, limit=50):
    """è·å–ç”¨æˆ·æ“ä½œå†å²"""
    history_key = f"user:history:{user_id}"
    logs = r.lrange(history_key, 0, limit-1)
    
    history = []
    for log in logs:
        history.append(json.loads(log.decode('utf-8')))
    
    return history

# ä½¿ç”¨ç¤ºä¾‹
log_user_operation(123, 'login', {'device': 'mobile'})
log_user_operation(123, 'purchase', {'product_id': 456, 'amount': 99.99})
```

---

## 5. ğŸ› ï¸ å®æˆ˜æ¡ˆä¾‹è¯¦è§£


### 5.1 ç®€å•MQæ¶ˆæ¯é˜Ÿåˆ—


**åœºæ™¯**ï¼šç”µå•†ç½‘ç«™ï¼Œç”¨æˆ·ä¸‹å•åéœ€è¦å‘é€ç¡®è®¤é‚®ä»¶ã€æ›´æ–°åº“å­˜ã€ç”Ÿæˆå‘ç¥¨ç­‰æ“ä½œã€‚

```python
class SimpleMQ:
    def __init__(self, redis_client):
        self.redis = redis_client
    
    def publish(self, topic, message):
        """å‘å¸ƒæ¶ˆæ¯"""
        queue_key = f"mq:{topic}"
        msg_data = {
            'id': str(uuid.uuid4()),
            'content': message,
            'timestamp': datetime.now().isoformat()
        }
        self.redis.lpush(queue_key, json.dumps(msg_data))
        return msg_data['id']
    
    def subscribe(self, topic, callback):
        """è®¢é˜…æ¶ˆæ¯"""
        queue_key = f"mq:{topic}"
        
        while True:
            # é˜»å¡å¼è·å–æ¶ˆæ¯
            result = self.redis.brpop(queue_key, timeout=10)
            
            if result:
                _, message = result
                msg_data = json.loads(message.decode('utf-8'))
                
                try:
                    callback(msg_data)
                except Exception as e:
                    print(f"å¤„ç†æ¶ˆæ¯å¤±è´¥: {e}")

# ä½¿ç”¨ç¤ºä¾‹
mq = SimpleMQ(r)

# ç”¨æˆ·ä¸‹å•åå‘å¸ƒæ¶ˆæ¯
def handle_order(order_id):
    mq.publish('order_created', {
        'order_id': order_id,
        'user_id': 123,
        'amount': 299.99
    })

# é‚®ä»¶æœåŠ¡è®¢é˜…æ¶ˆæ¯
def send_order_email(message):
    order_data = message['content']
    print(f"å‘é€è®¢å•ç¡®è®¤é‚®ä»¶: è®¢å•{order_data['order_id']}")

# åº“å­˜æœåŠ¡è®¢é˜…æ¶ˆæ¯  
def update_inventory(message):
    order_data = message['content']
    print(f"æ›´æ–°åº“å­˜: è®¢å•{order_data['order_id']}")

# å¯åŠ¨æ¶ˆè´¹è€…
mq.subscribe('order_created', send_order_email)
```

### 5.2 å¾®åšæ—¶é—´çº¿å®ç°


**æ¨æ¨¡å¼ vs æ‹‰æ¨¡å¼**ï¼š
```
æ¨æ¨¡å¼ (é€‚åˆå…³æ³¨æ•°ä¸å¤šçš„ç”¨æˆ·):
ç”¨æˆ·å‘å¾®åš â†’ ç«‹å³æ¨é€ç»™æ‰€æœ‰ç²‰ä¸çš„æ—¶é—´çº¿
ä¼˜ç‚¹ï¼šè¯»å–å¿«ï¼Œç¼ºç‚¹ï¼šå†™å…¥æ…¢(ç²‰ä¸å¤šæ—¶)

æ‹‰æ¨¡å¼ (é€‚åˆå¤§Vç”¨æˆ·):  
ç”¨æˆ·å‘å¾®åš â†’ åªå­˜åˆ°è‡ªå·±çš„å¾®åšåˆ—è¡¨
ç”¨æˆ·çœ‹æ—¶é—´çº¿ â†’ å®æ—¶å»å…³æ³¨çš„äººé‚£é‡Œæ‹‰å–
ä¼˜ç‚¹ï¼šå†™å…¥å¿«ï¼Œç¼ºç‚¹ï¼šè¯»å–æ…¢

æ··åˆæ¨¡å¼ï¼š
æ™®é€šç”¨æˆ·ç”¨æ¨æ¨¡å¼ï¼Œå¤§Vç”¨æ‹‰æ¨¡å¼
```

```python
class WeiboTimeline:
    def __init__(self, redis_client):
        self.redis = redis_client
        self.big_v_threshold = 10000  # ç²‰ä¸è¶…è¿‡1ä¸‡ç®—å¤§V
    
    def post_weibo(self, user_id, content):
        """å‘å¸ƒå¾®åš"""
        weibo = {
            'id': str(uuid.uuid4()),
            'user_id': user_id,
            'content': content,
            'timestamp': datetime.now().isoformat()
        }
        
        # å­˜å‚¨åˆ°ç”¨æˆ·çš„å¾®åšåˆ—è¡¨
        user_weibo_key = f"user:weibo:{user_id}"
        self.redis.lpush(user_weibo_key, json.dumps(weibo))
        
        # åˆ¤æ–­æ˜¯å¦æ˜¯å¤§V
        follower_count = self.get_follower_count(user_id)
        
        if follower_count < self.big_v_threshold:
            # æ™®é€šç”¨æˆ·ï¼šæ¨é€ç»™ç²‰ä¸
            self._push_to_followers(user_id, weibo)
        else:
            # å¤§Vï¼šä¸æ¨é€ï¼Œç²‰ä¸ä¸»åŠ¨æ‹‰å–
            print(f"å¤§Vç”¨æˆ·{user_id}å‘å¸ƒå¾®åšï¼Œç²‰ä¸éœ€ä¸»åŠ¨æ‹‰å–")
    
    def _push_to_followers(self, user_id, weibo):
        """æ¨é€ç»™ç²‰ä¸"""
        followers = self.get_followers(user_id)
        
        for follower_id in followers:
            timeline_key = f"timeline:{follower_id}"
            self.redis.lpush(timeline_key, json.dumps(weibo))
            self.redis.ltrim(timeline_key, 0, 999)  # ä¿æŒ1000æ¡
    
    def get_timeline(self, user_id, page=0, size=20):
        """è·å–æ—¶é—´çº¿"""
        timeline_key = f"timeline:{user_id}"
        
        # å…ˆä»æ¨é€çš„æ—¶é—´çº¿è·å–
        timeline = self._get_push_timeline(user_id, page, size)
        
        # å¦‚æœä¸å¤Ÿï¼Œä»å¤§Vé‚£é‡Œæ‹‰å–
        if len(timeline) < size:
            big_v_weibos = self._pull_from_big_v(user_id, size - len(timeline))
            timeline.extend(big_v_weibos)
        
        return sorted(timeline, key=lambda x: x['timestamp'], reverse=True)[:size]
```

### 5.3 æœ€æ–°è¯„è®ºåˆ—è¡¨


**éœ€æ±‚**ï¼šæ–‡ç« çš„è¯„è®ºåˆ—è¡¨ï¼Œæ˜¾ç¤ºæœ€æ–°çš„è¯„è®ºåœ¨å‰é¢ã€‚

```python
def add_comment(article_id, user_id, content):
    """æ·»åŠ è¯„è®º"""
    comment = {
        'id': str(uuid.uuid4()),
        'article_id': article_id,
        'user_id': user_id,
        'content': content,
        'timestamp': datetime.now().isoformat()
    }
    
    # æ·»åŠ åˆ°è¯„è®ºåˆ—è¡¨(æœ€æ–°åœ¨å‰)
    comments_key = f"article:comments:{article_id}"
    r.lpush(comments_key, json.dumps(comment))
    
    # æ›´æ–°è¯„è®ºæ€»æ•°
    count_key = f"article:comment_count:{article_id}"
    r.incr(count_key)
    
    return comment['id']

def get_comments(article_id, page=0, size=10):
    """è·å–è¯„è®ºåˆ—è¡¨"""
    comments_key = f"article:comments:{article_id}"
    start = page * size
    end = start + size - 1
    
    comment_jsons = r.lrange(comments_key, start, end)
    
    comments = []
    for comment_json in comment_jsons:
        comment = json.loads(comment_json.decode('utf-8'))
        # å¯ä»¥åœ¨è¿™é‡Œè¡¥å……ç”¨æˆ·ä¿¡æ¯
        comment['username'] = get_username(comment['user_id'])
        comments.append(comment)
    
    return comments

def get_comment_count(article_id):
    """è·å–è¯„è®ºæ€»æ•°"""
    count_key = f"article:comment_count:{article_id}"
    count = r.get(count_key)
    return int(count) if count else 0
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Redis Listç‰¹ç‚¹ï¼šæœ‰åºã€å¯é‡å¤ã€åŒç«¯æ“ä½œ
ğŸ”¸ æ¶ˆæ¯é˜Ÿåˆ—åŸç†ï¼šç”Ÿäº§è€…-é˜Ÿåˆ—-æ¶ˆè´¹è€…æ¨¡å¼è§£è€¦ç³»ç»Ÿ
ğŸ”¸ ä»»åŠ¡é˜Ÿåˆ—ä½œç”¨ï¼šå¼‚æ­¥å¤„ç†è€—æ—¶æ“ä½œï¼Œæå‡ç”¨æˆ·ä½“éªŒ
ğŸ”¸ æ—¶é—´çº¿åŠŸèƒ½ï¼šæŒ‰æ—¶é—´é¡ºåºç»„ç»‡å†…å®¹ï¼Œæ”¯æŒæµå¼æ›´æ–°
ğŸ”¸ å¯é æ€§ä¿è¯ï¼šé€šè¿‡BRPOPLPUSHç­‰å‘½ä»¤ç¡®ä¿æ¶ˆæ¯ä¸ä¸¢å¤±
```

### 6.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆç”¨Liståšé˜Ÿåˆ—**
```
ä¼˜åŠ¿ï¼š
- LPUSH/RPOP å®ç°é˜Ÿåˆ—çš„å…ˆè¿›å…ˆå‡º
- BRPOP é˜»å¡å¼è·å–ï¼Œé¿å…ç©ºè½®è¯¢
- åŸå­æ“ä½œï¼Œå¹¶å‘å®‰å…¨
- ç®€å•é«˜æ•ˆï¼Œå­¦ä¹ æˆæœ¬ä½

æ³¨æ„ï¼š
- ä¸æ”¯æŒæ¶ˆæ¯ç¡®è®¤æœºåˆ¶(éœ€è¦è‡ªå·±å®ç°)
- ä¸æ”¯æŒæ¶ˆæ¯ä¼˜å…ˆçº§(éœ€è¦å¤šé˜Ÿåˆ—)
- é˜Ÿåˆ—é•¿åº¦è¿‡é•¿ä¼šå½±å“æ€§èƒ½
```

**ğŸ”¹ æ¨æ¨¡å¼ vs æ‹‰æ¨¡å¼é€‰æ‹©**
```
æ¨æ¨¡å¼é€‚åˆï¼š
- ç²‰ä¸æ•°é‡ä¸å¤šçš„ç”¨æˆ·
- å®æ—¶æ€§è¦æ±‚é«˜çš„åœºæ™¯
- è¯»å¤šå†™å°‘çš„æƒ…å†µ

æ‹‰æ¨¡å¼é€‚åˆï¼š  
- å¤§Vç”¨æˆ·(ç²‰ä¸å¾ˆå¤š)
- ä¸ªæ€§åŒ–æ¨èéœ€æ±‚
- å†™å¤šè¯»å°‘çš„æƒ…å†µ

å®é™…é¡¹ç›®ä¸­å¾€å¾€é‡‡ç”¨æ··åˆæ¨¡å¼
```

**ğŸ”¹ Listé•¿åº¦æ§åˆ¶å¾ˆé‡è¦**
```
é—®é¢˜ï¼šListæ— é™å¢é•¿ä¼šå¯¼è‡´å†…å­˜é—®é¢˜
è§£å†³ï¼šä½¿ç”¨LTRIMå®šæœŸæ¸…ç†
å»ºè®®ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚è®¾ç½®åˆç†ä¸Šé™

ç¤ºä¾‹ï¼š
LTRIM timeline:123 0 999  # åªä¿ç•™1000æ¡æœ€æ–°è®°å½•
```

### 6.3 å®é™…åº”ç”¨ä»·å€¼


**ä¸šåŠ¡åœºæ™¯åº”ç”¨**ï¼š
- **ç”µå•†ç³»ç»Ÿ**ï¼šè®¢å•å¤„ç†é˜Ÿåˆ—ï¼Œå•†å“è¯„è®ºåˆ—è¡¨
- **ç¤¾äº¤å¹³å°**ï¼šç”¨æˆ·æ—¶é—´çº¿ï¼Œæ¶ˆæ¯é€šçŸ¥é˜Ÿåˆ—  
- **å†…å®¹ç½‘ç«™**ï¼šæ–‡ç« è¯„è®ºï¼Œæ“ä½œå†å²è®°å½•
- **ä»»åŠ¡è°ƒåº¦**ï¼šå¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—ï¼Œå®šæ—¶ä»»åŠ¡ç®¡ç†

**æ€§èƒ½ä¼˜åŒ–å»ºè®®**ï¼š
- åˆç†è®¾ç½®é˜Ÿåˆ—é•¿åº¦ä¸Šé™
- æ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹é€‰æ‹©æ¨æ‹‰æ¨¡å¼
- ä½¿ç”¨æ‰¹é‡æ“ä½œæé«˜æ•ˆç‡
- ç›‘æ§é˜Ÿåˆ—é•¿åº¦é¿å…ç§¯å‹

### 6.4 å¸¸è§é—®é¢˜ä¸è§£å†³


| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| **æ¶ˆæ¯ä¸¢å¤±** | æ¶ˆè´¹è€…å´©æºƒ | ä½¿ç”¨BRPOPLPUSHç¡®ä¿åŸå­æ€§ |
| **é˜Ÿåˆ—ç§¯å‹** | æ¶ˆè´¹é€Ÿåº¦æ…¢ | å¢åŠ æ¶ˆè´¹è€…æ•°é‡æˆ–ä¼˜åŒ–å¤„ç†é€»è¾‘ |
| **å†…å­˜å ç”¨é«˜** | é˜Ÿåˆ—è¿‡é•¿ | ä½¿ç”¨LTRIMå®šæœŸæ¸…ç† |
| **é¡ºåºæ··ä¹±** | å¹¶å‘æ¶ˆè´¹ | å•çº¿ç¨‹æ¶ˆè´¹æˆ–åŠ é”æ§åˆ¶ |

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- Listé˜Ÿåˆ—è§£å†³å¼‚æ­¥è§£è€¦é—®é¢˜
- BRPOPé˜»å¡ç­‰å¾…é¿å…ç©ºè½®è¯¢  
- LTRIMæ§åˆ¶é•¿åº¦é˜²æ­¢å†…å­˜çˆ†ç‚¸
- æ¨æ‹‰ç»“åˆåº”å¯¹ä¸åŒä¸šåŠ¡åœºæ™¯