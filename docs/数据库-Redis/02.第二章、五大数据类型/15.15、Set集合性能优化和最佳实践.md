---
title: 15ã€Seté›†åˆæ€§èƒ½ä¼˜åŒ–å’Œæœ€ä½³å®è·µ
---
## ğŸ“š ç›®å½•

1. [Seté›†åˆæ€§èƒ½ä¼˜åŒ–æ¦‚è¿°](#1-seté›†åˆæ€§èƒ½ä¼˜åŒ–æ¦‚è¿°)
2. [å¤§é›†åˆä¼˜åŒ–ç­–ç•¥](#2-å¤§é›†åˆä¼˜åŒ–ç­–ç•¥)
3. [é›†åˆè¿ç®—ä¼˜åŒ–](#3-é›†åˆè¿ç®—ä¼˜åŒ–)
4. [Setä½¿ç”¨é™·é˜±](#4-setä½¿ç”¨é™·é˜±)
5. [æœ€ä½³å®è·µæŒ‡å—](#5-æœ€ä½³å®è·µæŒ‡å—)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ Seté›†åˆæ€§èƒ½ä¼˜åŒ–æ¦‚è¿°


### 1.1 ä¸ºä»€ä¹ˆéœ€è¦ä¼˜åŒ–Seté›†åˆ


Seté›†åˆæ˜¯Redisä¸­çš„æ— åºé›†åˆç±»å‹ï¼Œå­˜å‚¨ä¸é‡å¤çš„å­—ç¬¦ä¸²å…ƒç´ ã€‚å½“é›†åˆå˜å¾—å¾ˆå¤§æˆ–è€…ä½¿ç”¨æ–¹å¼ä¸å½“æ—¶ï¼Œå°±ä¼šå‡ºç°æ€§èƒ½é—®é¢˜ã€‚

**ğŸ”¸ ä»€ä¹ˆæ˜¯æ€§èƒ½é—®é¢˜**
```
å†…å­˜å ç”¨è¿‡å¤šï¼šé›†åˆå¤ªå¤§å ç”¨å¤§é‡å†…å­˜
æ“ä½œå˜æ…¢ï¼šå¢åˆ æŸ¥æ”¹æ“ä½œè€—æ—¶å¢åŠ 
é˜»å¡é—®é¢˜ï¼šæŸäº›æ“ä½œä¼šé˜»å¡RedisæœåŠ¡
ç½‘ç»œä¼ è¾“æ…¢ï¼šè·å–æ•°æ®æ—¶ä¼ è¾“é‡è¿‡å¤§
```

**ğŸ’¡ ä¼˜åŒ–çš„æ ¸å¿ƒæ€æƒ³**
- **åˆ†è€Œæ²»ä¹‹**ï¼šæŠŠå¤§é›†åˆæ‹†åˆ†æˆå°é›†åˆ
- **åˆç†ä½¿ç”¨**ï¼šé¿å…ä¸€æ¬¡æ€§æ“ä½œè¿‡å¤šæ•°æ®
- **æå‰è§„åˆ’**ï¼šè®¾è®¡æ—¶å°±è€ƒè™‘æ€§èƒ½é—®é¢˜

### 1.2 Seté›†åˆçš„åº•å±‚å­˜å‚¨


Redisçš„Seté›†åˆæ ¹æ®å…ƒç´ æ•°é‡å’Œç±»å‹ï¼Œä¼šè‡ªåŠ¨é€‰æ‹©ä¸åŒçš„å­˜å‚¨æ–¹å¼ï¼š

```
å°é›†åˆï¼ˆå…ƒç´ å°‘ï¼‰ï¼šä½¿ç”¨ intsetï¼ˆæ•´æ•°é›†åˆï¼‰
å¤§é›†åˆï¼ˆå…ƒç´ å¤šï¼‰ï¼šä½¿ç”¨ hashtableï¼ˆå“ˆå¸Œè¡¨ï¼‰

è½¬æ¢æ¡ä»¶ï¼š
- å…ƒç´ æ•°é‡è¶…è¿‡ 512 ä¸ª
- æˆ–å­˜åœ¨éæ•´æ•°å…ƒç´ 
```

**ğŸ”§ é…ç½®å‚æ•°**
```bash
# redis.conf é…ç½®
set-max-intset-entries 512    # æœ€å¤§æ•´æ•°é›†åˆå…ƒç´ æ•°
```

---

## 2. ğŸ“¦ å¤§é›†åˆä¼˜åŒ–ç­–ç•¥


### 2.1 å¤§é›†åˆæ‹†åˆ†æ–¹æ¡ˆ


å½“ä¸€ä¸ªSeté›†åˆåŒ…å«æ•°ç™¾ä¸‡ä¸ªå…ƒç´ æ—¶ï¼Œå°±éœ€è¦è€ƒè™‘æ‹†åˆ†äº†ã€‚

**ğŸ”¸ æŒ‰ä¸šåŠ¡é€»è¾‘æ‹†åˆ†**
```bash
# åŸæ¥ï¼šæ‰€æœ‰ç”¨æˆ·IDå­˜åœ¨ä¸€ä¸ªé›†åˆ
SADD all_users 1001 1002 1003 ... 9999999

# ä¼˜åŒ–ï¼šæŒ‰åœ°åŒºæ‹†åˆ†
SADD users:beijing 1001 1002 1003
SADD users:shanghai 2001 2002 2003  
SADD users:guangzhou 3001 3002 3003
```

**ğŸ”¸ æŒ‰å“ˆå¸Œå€¼æ‹†åˆ†**
```bash
# æŒ‰ç”¨æˆ·IDå°¾æ•°æ‹†åˆ†æˆ10ä¸ªå°é›†åˆ
SADD users:0 1000 1010 1020  # IDå°¾æ•°ä¸º0
SADD users:1 1001 1011 1021  # IDå°¾æ•°ä¸º1
SADD users:2 1002 1012 1022  # IDå°¾æ•°ä¸º2
```

**ğŸ’» æ‹†åˆ†ä»£ç ç¤ºä¾‹**
```python
def add_user_to_sharded_set(user_id):
    # æ ¹æ®ç”¨æˆ·IDè®¡ç®—åˆ†ç‰‡
    shard = user_id % 10
    key = f"users:{shard}"
    redis_client.sadd(key, user_id)

def get_all_users():
    all_users = set()
    # ä»æ‰€æœ‰åˆ†ç‰‡æ”¶é›†ç”¨æˆ·
    for i in range(10):
        users = redis_client.smembers(f"users:{i}")
        all_users.update(users)
    return all_users
```

### 2.2 é›†åˆå¤§å°æ§åˆ¶


**ğŸ¯ è®¾ç½®åˆç†çš„å¤§å°ä¸Šé™**

æ¯ä¸ªSeté›†åˆå»ºè®®æ§åˆ¶åœ¨ä»¥ä¸‹èŒƒå›´ï¼š
- **æ—¥å¸¸æ“ä½œ**ï¼š< 10ä¸‡ä¸ªå…ƒç´ 
- **æ‰¹é‡å¤„ç†**ï¼š< 100ä¸‡ä¸ªå…ƒç´   
- **è¶…å¤§é›†åˆ**ï¼šè€ƒè™‘æ‹†åˆ†æˆ–ä½¿ç”¨å…¶ä»–æ–¹æ¡ˆ

**ğŸ”§ ç›‘æ§é›†åˆå¤§å°**
```bash
# æ£€æŸ¥é›†åˆå…ƒç´ æ•°é‡
SCARD user_set

# å¦‚æœè¿”å›å€¼è¶…è¿‡é˜ˆå€¼ï¼Œè§¦å‘æ‹†åˆ†é€»è¾‘
```

### 2.3 å†…å­˜ä½¿ç”¨ä¼˜åŒ–


**ğŸ”¸ é€‰æ‹©åˆé€‚çš„æ•°æ®ç±»å‹**
```bash
# å¦‚æœå­˜å‚¨çš„éƒ½æ˜¯æ•´æ•°ï¼Œè®©Redisè‡ªåŠ¨ä¼˜åŒ–
SADD number_set 1 2 3 4 5    # ä½¿ç”¨intsetå­˜å‚¨

# é¿å…ä¸å¿…è¦çš„å­—ç¬¦ä¸²
SADD user_set "user_1001"    # å ç”¨æ›´å¤šå†…å­˜
SADD user_set 1001           # æ›´èŠ‚çœå†…å­˜
```

**ğŸ”¸ é¿å…å­˜å‚¨å†—ä½™ä¿¡æ¯**
```bash
# ä¸å¥½çš„åšæ³•ï¼šå­˜å‚¨å®Œæ•´JSON
SADD products '{"id":1,"name":"iPhone","price":999}'

# å¥½çš„åšæ³•ï¼šåªå­˜å‚¨IDï¼Œå…¶ä»–ä¿¡æ¯ç”¨Hashå­˜å‚¨
SADD products 1
HSET product:1 name iPhone price 999
```

### 2.4 æ“ä½œæ€§èƒ½ä¼˜åŒ–


**ğŸš€ æ‰¹é‡æ“ä½œä¼˜åŒ–**
```bash
# é¿å…å¾ªç¯è°ƒç”¨å•ä¸ªæ“ä½œ
for item in items:
    SADD myset item    # æ…¢ï¼æ¯æ¬¡éƒ½è¦ç½‘ç»œå¾€è¿”

# ä½¿ç”¨æ‰¹é‡æ“ä½œ
SADD myset item1 item2 item3 ... itemN    # å¿«ï¼ä¸€æ¬¡ç½‘ç»œå¾€è¿”
```

**ğŸ’» Pythonæ‰¹é‡æ“ä½œç¤ºä¾‹**
```python
# æ•ˆç‡ä½çš„å†™æ³•
for user_id in user_ids:
    redis_client.sadd("active_users", user_id)

# æ•ˆç‡é«˜çš„å†™æ³•  
redis_client.sadd("active_users", *user_ids)
```

---

## 3. âš¡ é›†åˆè¿ç®—ä¼˜åŒ–


### 3.1 è¿ç®—é¡ºåºä¼˜åŒ–


Seté›†åˆæ”¯æŒäº¤é›†ã€å¹¶é›†ã€å·®é›†è¿ç®—ï¼Œä½†è¿ç®—é¡ºåºä¼šå½±å“æ€§èƒ½ã€‚

**ğŸ”¸ äº¤é›†è¿ç®—ä¼˜åŒ–**
```bash
# æœ‰ä¸‰ä¸ªé›†åˆéœ€è¦æ±‚äº¤é›†
SCARD set1    # è¿”å› 100ä¸‡
SCARD set2    # è¿”å› 1000  
SCARD set3    # è¿”å› 500

# é”™è¯¯çš„åšæ³•ï¼šå…ˆç®—å¤§é›†åˆ
SINTER set1 set2    # ä¼šå¤„ç†100ä¸‡ä¸ªå…ƒç´ 

# æ­£ç¡®çš„åšæ³•ï¼šå…ˆç®—å°é›†åˆ
SINTER set2 set3    # å…ˆå¤„ç†è¾ƒå°‘çš„å…ƒç´ 
```

**ğŸ’¡ ä¼˜åŒ–è§„åˆ™**
- **äº¤é›†**ï¼šä»æœ€å°çš„é›†åˆå¼€å§‹
- **å¹¶é›†**ï¼šé¡ºåºå½±å“ä¸å¤§ï¼Œä½†ä»å»ºè®®ä»å°åˆ°å¤§
- **å·®é›†**ï¼šç¬¬ä¸€ä¸ªé›†åˆçš„å¤§å°æœ€é‡è¦

### 3.2 ä¸­é—´ç»“æœç¼“å­˜


å½“éœ€è¦å¤šæ¬¡ä½¿ç”¨ç›¸åŒçš„è¿ç®—ç»“æœæ—¶ï¼Œå¯ä»¥æŠŠç»“æœå­˜å‚¨èµ·æ¥ã€‚

**ğŸ”§ ç¼“å­˜äº¤é›†ç»“æœ**
```bash
# è®¡ç®—å¹¶ç¼“å­˜äº¤é›†ç»“æœ
SINTERSTORE cache:result set1 set2 set3
EXPIRE cache:result 3600    # è®¾ç½®1å°æ—¶è¿‡æœŸ

# åç»­ç›´æ¥ä½¿ç”¨ç¼“å­˜ç»“æœ
SMEMBERS cache:result
```

**ğŸ’» æ™ºèƒ½ç¼“å­˜ç¤ºä¾‹**
```python
def get_common_users(group1, group2, cache_time=3600):
    cache_key = f"common_users:{group1}:{group2}"
    
    # å…ˆæ£€æŸ¥ç¼“å­˜
    if redis_client.exists(cache_key):
        return redis_client.smembers(cache_key)
    
    # è®¡ç®—äº¤é›†å¹¶ç¼“å­˜
    result = redis_client.sinter(f"users:{group1}", f"users:{group2}")
    if result:
        redis_client.sadd(cache_key, *result)
        redis_client.expire(cache_key, cache_time)
    
    return result
```

### 3.3 åˆ†æ‰¹è¿ç®—ç­–ç•¥


å¯¹äºè¶…å¤§é›†åˆï¼Œå¯ä»¥åˆ†æ‰¹è¿›è¡Œè¿ç®—ï¼Œé¿å…é•¿æ—¶é—´é˜»å¡ã€‚

**ğŸ”„ åˆ†æ‰¹å¤„ç†æ€è·¯**
```
åŸé›†åˆï¼š1000ä¸‡ä¸ªå…ƒç´ 
åˆ†æ‰¹å¤§å°ï¼šæ¯æ‰¹10ä¸‡ä¸ªå…ƒç´ 
å¤„ç†æ–¹å¼ï¼šåˆ†100æ‰¹ï¼Œæ¯æ‰¹å•ç‹¬å¤„ç†
```

**ğŸ’» åˆ†æ‰¹è¿ç®—å®ç°**
```python
def batch_set_operation(large_set_key, batch_size=100000):
    all_members = redis_client.smembers(large_set_key)
    total_members = list(all_members)
    
    results = []
    # åˆ†æ‰¹å¤„ç†
    for i in range(0, len(total_members), batch_size):
        batch = total_members[i:i + batch_size]
        
        # åˆ›å»ºä¸´æ—¶æ‰¹æ¬¡é›†åˆ
        temp_key = f"temp_batch_{i}"
        redis_client.sadd(temp_key, *batch)
        
        # æ‰§è¡Œå…·ä½“è¿ç®—ï¼ˆè¿™é‡Œä»¥äº¤é›†ä¸ºä¾‹ï¼‰
        batch_result = redis_client.sinter(temp_key, "target_set")
        results.extend(batch_result)
        
        # æ¸…ç†ä¸´æ—¶é›†åˆ
        redis_client.delete(temp_key)
    
    return set(results)  # å»é‡åˆå¹¶ç»“æœ
```

### 3.4 å¼‚æ­¥è¿ç®—å¤„ç†


å¯¹äºè€—æ—¶çš„é›†åˆè¿ç®—ï¼Œå¯ä»¥æ”¾åˆ°åå°å¼‚æ­¥å¤„ç†ã€‚

**ğŸ”¸ å¼‚æ­¥å¤„ç†æµç¨‹**
```
1. æ¥æ”¶è¿ç®—è¯·æ±‚
2. ç”Ÿæˆä»»åŠ¡ID
3. åå°æ‰§è¡Œè¿ç®—
4. å­˜å‚¨è¿ç®—ç»“æœ
5. é€šçŸ¥å®¢æˆ·ç«¯å®Œæˆ
```

**ğŸ’» å¼‚æ­¥è¿ç®—ç¤ºä¾‹**
```python
import uuid
from celery import Celery

app = Celery('set_operations')

@app.task
def async_set_intersection(set_keys, result_key):
    """å¼‚æ­¥è®¡ç®—å¤šä¸ªé›†åˆçš„äº¤é›†"""
    try:
        # æ‰§è¡Œäº¤é›†è¿ç®—
        redis_client.sinterstore(result_key, *set_keys)
        # è®¾ç½®ç»“æœè¿‡æœŸæ—¶é—´
        redis_client.expire(result_key, 7200)  # 2å°æ—¶
        return {"status": "success", "result_key": result_key}
    except Exception as e:
        return {"status": "error", "message": str(e)}

# ä½¿ç”¨å¼‚æ­¥ä»»åŠ¡
task_id = str(uuid.uuid4())
result_key = f"intersection_result:{task_id}"
task = async_set_intersection.delay(["set1", "set2", "set3"], result_key)
```

---

## 4. âš ï¸ Setä½¿ç”¨é™·é˜±


### 4.1 SMEMBERSå…¨é‡è·å–é£é™©


`SMEMBERS`å‘½ä»¤ä¼šä¸€æ¬¡æ€§è¿”å›é›†åˆçš„æ‰€æœ‰å…ƒç´ ï¼Œè¿™æ˜¯æœ€å±é™©çš„é™·é˜±ä¹‹ä¸€ã€‚

**ğŸš« å±é™©æ“ä½œ**
```bash
# å±é™©ï¼å¦‚æœé›†åˆæœ‰100ä¸‡ä¸ªå…ƒç´ 
SMEMBERS huge_set    # ä¼šè¿”å›æ‰€æœ‰100ä¸‡ä¸ªå…ƒç´ 
```

**âš ï¸ é£é™©åˆ†æ**
```
å†…å­˜å ç”¨ï¼šæœåŠ¡å™¨éœ€è¦å‡†å¤‡æ‰€æœ‰æ•°æ®
ç½‘ç»œé˜»å¡ï¼šå¤§é‡æ•°æ®ä¼ è¾“å ç”¨å¸¦å®½
å®¢æˆ·ç«¯å¡æ­»ï¼šå®¢æˆ·ç«¯éœ€è¦æ¥æ”¶å¤„ç†å¤§é‡æ•°æ®
Redisé˜»å¡ï¼šåœ¨å‡†å¤‡æ•°æ®æœŸé—´Redisæ— æ³•å¤„ç†å…¶ä»–è¯·æ±‚
```

**âœ… å®‰å…¨æ›¿ä»£æ–¹æ¡ˆ**
```bash
# æ–¹æ¡ˆ1ï¼šä½¿ç”¨SCANåˆ†æ‰¹è·å–
SSCAN myset 0 COUNT 100    # æ¯æ¬¡è·å–100ä¸ªå…ƒç´ 

# æ–¹æ¡ˆ2ï¼šä½¿ç”¨SRANDMEMBERéšæœºé‡‡æ ·
SRANDMEMBER myset 100      # éšæœºè·å–100ä¸ªå…ƒç´ 

# æ–¹æ¡ˆ3ï¼šå…ˆæ£€æŸ¥å¤§å°å†å†³å®š
SCARD myset                # å¦‚æœè¿”å›å€¼è¿‡å¤§ï¼Œæ‹’ç»å…¨é‡è·å–
```

**ğŸ’» å®‰å…¨è·å–ä»£ç **
```python
def safe_get_set_members(key, max_size=10000):
    # å…ˆæ£€æŸ¥é›†åˆå¤§å°
    size = redis_client.scard(key)
    
    if size > max_size:
        print(f"é›†åˆå¤ªå¤§({size}ä¸ªå…ƒç´ )ï¼Œè¯·ä½¿ç”¨åˆ†æ‰¹è·å–")
        return None
    
    # å®‰å…¨è·å–
    return redis_client.smembers(key)

def scan_get_set_members(key, count=100):
    """ä½¿ç”¨SCANåˆ†æ‰¹è·å–é›†åˆå…ƒç´ """
    members = set()
    cursor = 0
    
    while True:
        cursor, batch = redis_client.sscan(key, cursor, count=count)
        members.update(batch)
        
        if cursor == 0:  # æ‰«æå®Œæˆ
            break
    
    return members
```

### 4.2 å¤§é›†åˆè¿ç®—é˜»å¡é—®é¢˜


å½“å¯¹å¤§é›†åˆè¿›è¡Œäº¤é›†ã€å¹¶é›†ã€å·®é›†è¿ç®—æ—¶ï¼ŒRedisä¼šè¢«é˜»å¡ã€‚

**ğŸš« é˜»å¡æ“ä½œç¤ºä¾‹**
```bash
# ä¸¤ä¸ªå„æœ‰100ä¸‡å…ƒç´ çš„é›†åˆæ±‚äº¤é›†
SINTER huge_set1 huge_set2    # å¯èƒ½é˜»å¡æ•°ç§’é’Ÿ
```

**ğŸ“Š é˜»å¡æ—¶é—´é¢„ä¼°**
| é›†åˆå¤§å° | è¿ç®—ç±»å‹ | é¢„ä¼°é˜»å¡æ—¶é—´ |
|---------|---------|-------------|
| 10ä¸‡ | äº¤é›† | < 100ms |
| 100ä¸‡ | äº¤é›† | 1-5ç§’ |
| 1000ä¸‡ | äº¤é›† | 10-30ç§’ |
| 100ä¸‡ | å¹¶é›† | 2-10ç§’ |

**âœ… é¿å…é˜»å¡çš„æ–¹æ³•**

1. **ä½¿ç”¨STOREå‘½ä»¤å¼‚æ­¥å¤„ç†**
```bash
# æŠŠç»“æœå­˜å‚¨åˆ°æ–°keyï¼Œåå°è®¡ç®—
SINTERSTORE result_key huge_set1 huge_set2
```

2. **åˆ†æ‰¹å¤„ç†**
```bash
# å…ˆæ‹†åˆ†å¤§é›†åˆï¼Œå†åˆ†åˆ«è¿ç®—
SINTER small_set1 small_set2
SINTER small_set3 small_set4
```

3. **ä½¿ç”¨ä¸»ä»åˆ†ç¦»**
```bash
# åœ¨ä»åº“æ‰§è¡Œè€—æ—¶è¿ç®—
# ä¸»åº“ç»§ç»­å¤„ç†å†™æ“ä½œ
```

### 4.3 å†…å­˜å ç”¨è¯„ä¼°


å¾ˆå¤šå¼€å‘è€…ä½ä¼°äº†Seté›†åˆçš„å†…å­˜å ç”¨ã€‚

**ğŸ“ å†…å­˜å ç”¨è®¡ç®—**
```bash
# æŸ¥çœ‹é›†åˆå ç”¨çš„å†…å­˜
MEMORY USAGE myset

# æŸ¥çœ‹å•ä¸ªå…ƒç´ çš„å†…å­˜å ç”¨
MEMORY USAGE myset SAMPLES 5
```

**ğŸ’¡ å†…å­˜å ç”¨è§„å¾‹**
```
æ•´æ•°å…ƒç´ ï¼šæ¯ä¸ªå…ƒç´ çº¦8å­—èŠ‚
çŸ­å­—ç¬¦ä¸²ï¼šæ¯ä¸ªå…ƒç´ çº¦16-32å­—èŠ‚  
é•¿å­—ç¬¦ä¸²ï¼šæ¯ä¸ªå…ƒç´ çº¦32å­—èŠ‚+å­—ç¬¦ä¸²é•¿åº¦
å¯¹è±¡åºåˆ—åŒ–ï¼šæ¯ä¸ªå…ƒç´ å¯èƒ½å‡ ç™¾å­—èŠ‚

ç¤ºä¾‹ï¼š
100ä¸‡ä¸ªæ•´æ•° â‰ˆ 8MB
100ä¸‡ä¸ªç”¨æˆ·å â‰ˆ 50MB  
100ä¸‡ä¸ªJSONå¯¹è±¡ â‰ˆ 500MB
```

**ğŸ”§ å†…å­˜ç›‘æ§ä»£ç **
```python
def monitor_set_memory(key):
    """ç›‘æ§é›†åˆå†…å­˜ä½¿ç”¨"""
    size = redis_client.scard(key)
    memory = redis_client.memory_usage(key)
    
    if memory:
        avg_per_element = memory / size if size > 0 else 0
        print(f"é›†åˆ {key}:")
        print(f"  å…ƒç´ æ•°é‡: {size:,}")
        print(f"  å†…å­˜å ç”¨: {memory:,} bytes ({memory/1024/1024:.2f} MB)")
        print(f"  å¹³å‡æ¯å…ƒç´ : {avg_per_element:.2f} bytes")
        
        # è­¦å‘Šé˜ˆå€¼
        if memory > 100 * 1024 * 1024:  # 100MB
            print("  âš ï¸  å†…å­˜å ç”¨è¿‡é«˜ï¼Œå»ºè®®ä¼˜åŒ–ï¼")

# ä½¿ç”¨ç¤ºä¾‹
monitor_set_memory("user_ids")
```

### 4.4 çƒ­ç‚¹é›†åˆå¤„ç†


æŸäº›é›†åˆä¼šè¢«é¢‘ç¹è®¿é—®ï¼Œæˆä¸ºæ€§èƒ½ç“¶é¢ˆã€‚

**ğŸ”¥ çƒ­ç‚¹é›†åˆçš„ç‰¹å¾**
```
é«˜å¹¶å‘è®¿é—®ï¼šæ¯ç§’æ•°åƒæ¬¡è¯»å†™
é¢‘ç¹ä¿®æ”¹ï¼šå…ƒç´ ç»å¸¸å¢åˆ 
å¤§é‡å®¢æˆ·ç«¯ï¼šå¤šä¸ªåº”ç”¨åŒæ—¶è®¿é—®
```

**âœ… çƒ­ç‚¹å¤„ç†ç­–ç•¥**

1. **è¯»å†™åˆ†ç¦»**
```python
# ä¸»åº“å¤„ç†å†™æ“ä½œ
def add_to_hot_set(key, member):
    return master_redis.sadd(key, member)

# ä»åº“å¤„ç†è¯»æ“ä½œ  
def read_from_hot_set(key):
    return slave_redis.smembers(key)
```

2. **æœ¬åœ°ç¼“å­˜**
```python
import time
from threading import Lock

class SetCache:
    def __init__(self, redis_client, cache_time=60):
        self.redis = redis_client
        self.cache = {}
        self.cache_time = cache_time
        self.lock = Lock()
    
    def get_set(self, key):
        now = time.time()
        
        with self.lock:
            # æ£€æŸ¥æœ¬åœ°ç¼“å­˜
            if key in self.cache:
                data, timestamp = self.cache[key]
                if now - timestamp < self.cache_time:
                    return data
            
            # ä»Redisè·å–å¹¶ç¼“å­˜
            data = self.redis.smembers(key)
            self.cache[key] = (data, now)
            return data
```

3. **åˆ†ç‰‡å¤„ç†**
```python
def get_shard_key(base_key, value):
    """æ ¹æ®å€¼è®¡ç®—åˆ†ç‰‡key"""
    shard = hash(str(value)) % 10
    return f"{base_key}:shard:{shard}"

def add_to_sharded_set(base_key, member):
    """æ·»åŠ åˆ°åˆ†ç‰‡é›†åˆ"""
    shard_key = get_shard_key(base_key, member)
    return redis_client.sadd(shard_key, member)

def check_in_sharded_set(base_key, member):
    """æ£€æŸ¥å…ƒç´ æ˜¯å¦åœ¨åˆ†ç‰‡é›†åˆä¸­"""
    shard_key = get_shard_key(base_key, member)
    return redis_client.sismember(shard_key, member)
```

---

## 5. ğŸ† æœ€ä½³å®è·µæŒ‡å—


### 5.1 Setå‘½åè§„èŒƒ


å¥½çš„å‘½åè§„èŒƒèƒ½è®©ä»£ç æ›´æ˜“ç»´æŠ¤ï¼Œä¹Ÿä¾¿äºç›‘æ§å’Œè°ƒè¯•ã€‚

**ğŸ”¸ æ¨èçš„å‘½åæ ¼å¼**
```bash
# æ ¼å¼ï¼šä¸šåŠ¡æ¨¡å—:æ•°æ®ç±»å‹:å…·ä½“ç”¨é€”
user:set:active           # æ´»è·ƒç”¨æˆ·é›†åˆ
product:set:hot           # çƒ­é—¨å•†å“é›†åˆ  
order:set:today           # ä»Šæ—¥è®¢å•é›†åˆ
cache:set:search_result   # æœç´¢ç»“æœç¼“å­˜é›†åˆ
```

**ğŸ”¸ é¿å…çš„å‘½åæ–¹å¼**
```bash
# å¤ªç®€å•ï¼Œä¸çŸ¥é“æ˜¯ä»€ä¹ˆ
set1, data, temp

# å¤ªå¤æ‚ï¼Œä¸æ˜“è¯»
user_active_members_from_beijing_last_week_filtered
```

**ğŸ’¡ å‘½åæœ€ä½³å®è·µ**
- **ä½¿ç”¨å†’å·åˆ†éš”**ï¼šä¾¿äºæŒ‰å‰ç¼€æŸ¥æ‰¾
- **åŒ…å«ä¸šåŠ¡å«ä¹‰**ï¼šä¸€çœ‹å°±çŸ¥é“ç”¨é€”
- **ä¿æŒé•¿åº¦é€‚ä¸­**ï¼šä¸è¶…è¿‡50ä¸ªå­—ç¬¦
- **ç»Ÿä¸€å›¢é˜Ÿè§„èŒƒ**ï¼šæ•´ä¸ªå›¢é˜Ÿä½¿ç”¨ç›¸åŒè§„åˆ™

### 5.2 é›†åˆå¤§å°ç›‘æ§


å®šæœŸç›‘æ§é›†åˆå¤§å°ï¼ŒåŠæ—¶å‘ç°å¼‚å¸¸å¢é•¿ã€‚

**ğŸ”§ ç›‘æ§è„šæœ¬**
```python
import redis
import json
from datetime import datetime

def monitor_all_sets(redis_client, size_threshold=100000):
    """ç›‘æ§æ‰€æœ‰Seté›†åˆçš„å¤§å°"""
    report = {
        "timestamp": datetime.now().isoformat(),
        "large_sets": [],
        "total_sets": 0,
        "total_memory": 0
    }
    
    # è·å–æ‰€æœ‰key
    for key in redis_client.scan_iter(match="*", _type="set"):
        report["total_sets"] += 1
        
        size = redis_client.scard(key)
        memory = redis_client.memory_usage(key) or 0
        report["total_memory"] += memory
        
        # è®°å½•å¤§é›†åˆ
        if size > size_threshold:
            report["large_sets"].append({
                "key": key.decode() if isinstance(key, bytes) else key,
                "size": size,
                "memory_mb": round(memory / 1024 / 1024, 2)
            })
    
    return report

# ä½¿ç”¨ç¤ºä¾‹
redis_client = redis.Redis(host='localhost', port=6379, db=0)
report = monitor_all_sets(redis_client)

# è¾“å‡ºæŠ¥å‘Š
print("ğŸ“Š Redis Seté›†åˆç›‘æ§æŠ¥å‘Š")
print(f"æ€»é›†åˆæ•°é‡: {report['total_sets']}")
print(f"æ€»å†…å­˜å ç”¨: {report['total_memory']/1024/1024:.2f} MB")
print(f"å¤§é›†åˆæ•°é‡: {len(report['large_sets'])}")

for item in report['large_sets']:
    print(f"  {item['key']}: {item['size']:,} å…ƒç´ , {item['memory_mb']} MB")
```

**ğŸ“ˆ è®¾ç½®ç›‘æ§å‘Šè­¦**
```python
def check_set_alerts(redis_client):
    """æ£€æŸ¥é›†åˆå‘Šè­¦æ¡ä»¶"""
    alerts = []
    
    for key in redis_client.scan_iter(match="*", _type="set"):
        size = redis_client.scard(key)
        memory = redis_client.memory_usage(key) or 0
        
        # å¤§å°å‘Šè­¦
        if size > 1000000:  # 100ä¸‡å…ƒç´ 
            alerts.append(f"âš ï¸ {key} å…ƒç´ è¿‡å¤š: {size:,}")
        
        # å†…å­˜å‘Šè­¦
        if memory > 100 * 1024 * 1024:  # 100MB
            alerts.append(f"âš ï¸ {key} å†…å­˜è¿‡å¤§: {memory/1024/1024:.1f}MB")
    
    return alerts
```

### 5.3 è¿‡æœŸæ—¶é—´è®¾ç½®


åˆç†è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œé¿å…æ— ç”¨æ•°æ®å ç”¨å†…å­˜ã€‚

**â° è¿‡æœŸæ—¶é—´ç­–ç•¥**
```bash
# ä¸´æ—¶ç»“æœï¼šçŸ­æœŸè¿‡æœŸ
SADD temp:search_result item1 item2 item3
EXPIRE temp:search_result 300    # 5åˆ†é’Ÿè¿‡æœŸ

# ç¼“å­˜æ•°æ®ï¼šä¸­æœŸè¿‡æœŸ
SADD cache:hot_products prod1 prod2 prod3  
EXPIRE cache:hot_products 3600   # 1å°æ—¶è¿‡æœŸ

# ä¸šåŠ¡æ•°æ®ï¼šé•¿æœŸè¿‡æœŸæˆ–ä¸è¿‡æœŸ
SADD user:favorites:123 item1 item2
EXPIRE user:favorites:123 2592000  # 30å¤©è¿‡æœŸ
```

**ğŸ’» æ™ºèƒ½è¿‡æœŸç®¡ç†**
```python
class SetManager:
    def __init__(self, redis_client):
        self.redis = redis_client
    
    def create_temp_set(self, key, members, ttl=300):
        """åˆ›å»ºä¸´æ—¶é›†åˆ"""
        if members:
            self.redis.sadd(key, *members)
            self.redis.expire(key, ttl)
    
    def create_cache_set(self, key, members, ttl=3600):
        """åˆ›å»ºç¼“å­˜é›†åˆ"""
        if members:
            self.redis.sadd(key, *members)
            self.redis.expire(key, ttl)
    
    def refresh_ttl(self, key, ttl):
        """åˆ·æ–°è¿‡æœŸæ—¶é—´"""
        if self.redis.exists(key):
            self.redis.expire(key, ttl)
            return True
        return False

# ä½¿ç”¨ç¤ºä¾‹
set_manager = SetManager(redis_client)

# åˆ›å»ºä¸´æ—¶æœç´¢ç»“æœ
search_results = ["item1", "item2", "item3"]
set_manager.create_temp_set("search:user123", search_results, 600)
```

### 5.4 ä¸šåŠ¡åœºæ™¯é€‰æ‹©


ä¸åŒçš„ä¸šåŠ¡åœºæ™¯éœ€è¦é€‰æ‹©åˆé€‚çš„Setä½¿ç”¨æ–¹å¼ã€‚

**ğŸ¯ å¸¸è§ä¸šåŠ¡åœºæ™¯å¯¹æ¯”**

| åœºæ™¯ | Setä½¿ç”¨æ–¹å¼ | æ³¨æ„äº‹é¡¹ |
|-----|-----------|---------|
| **ç”¨æˆ·æ ‡ç­¾** | `SADD user:123:tags tag1 tag2` | æ ‡ç­¾æ•°é‡é€šå¸¸è¾ƒå°‘ï¼Œæ— éœ€ç‰¹æ®Šä¼˜åŒ– |
| **å•†å“åˆ†ç±»** | `SADD category:electronics prod1 prod2` | å•†å“æ•°é‡å¯èƒ½å¾ˆå¤šï¼Œè€ƒè™‘åˆ†é¡µ |
| **åœ¨çº¿ç”¨æˆ·** | `SADD online:users user1 user2` | éœ€è¦å®šæœŸæ¸…ç†è¿‡æœŸç”¨æˆ· |
| **è®¿é—®ç»Ÿè®¡** | `SADD visit:today:ip ip1 ip2` | æŒ‰å¤©æ‹†åˆ†ï¼Œè‡ªåŠ¨è¿‡æœŸ |
| **æƒé™ç®¡ç†** | `SADD role:admin:users user1 user2` | å…ƒç´ è¾ƒå°‘ï¼Œä½†è®¿é—®é¢‘ç¹ |

**ğŸ’¡ é€‰æ‹©æŒ‡å—**

1. **æ•°æ®é‡å°(<1ä¸‡)**ï¼šç›´æ¥ä½¿ç”¨ï¼Œæ— éœ€ä¼˜åŒ–
```python
# ç”¨æˆ·æ”¶è—å•†å“
redis_client.sadd(f"user:{user_id}:favorites", product_id)
```

2. **æ•°æ®é‡ä¸­ç­‰(1ä¸‡-10ä¸‡)**ï¼šè€ƒè™‘åˆ†é¡µå’Œç›‘æ§
```python
# æ´»è·ƒç”¨æˆ·åˆ—è¡¨
def get_active_users(page=1, page_size=100):
    start = (page - 1) * page_size
    # ä½¿ç”¨SRANDMEMBERéšæœºè·å–
    return redis_client.srandmember("active_users", page_size)
```

3. **æ•°æ®é‡å¤§(>10ä¸‡)**ï¼šå¿…é¡»åˆ†ç‰‡å’Œä¼˜åŒ–
```python
# å¤§é‡å•†å“IDåˆ†ç‰‡å­˜å‚¨
def add_product_to_category(category, product_id):
    shard = product_id % 10
    key = f"category:{category}:shard:{shard}"
    redis_client.sadd(key, product_id)
```

**ğŸ”„ ä¸šåŠ¡åœºæ™¯è¿ç§»**
```python
def migrate_large_set(old_key, new_key_pattern, shard_count=10):
    """å°†å¤§é›†åˆè¿ç§»ä¸ºåˆ†ç‰‡é›†åˆ"""
    
    # åˆ†æ‰¹è·å–åŸé›†åˆæ•°æ®
    cursor = 0
    migrated_count = 0
    
    while True:
        cursor, members = redis_client.sscan(old_key, cursor, count=1000)
        
        for member in members:
            # è®¡ç®—æ–°çš„åˆ†ç‰‡key
            shard = hash(member) % shard_count
            new_key = new_key_pattern.format(shard=shard)
            
            # æ·»åŠ åˆ°æ–°çš„åˆ†ç‰‡é›†åˆ
            redis_client.sadd(new_key, member)
            migrated_count += 1
        
        if cursor == 0:
            break
    
    print(f"è¿ç§»å®Œæˆï¼Œå…±è¿ç§» {migrated_count} ä¸ªå…ƒç´ ")
    # å¯ä»¥é€‰æ‹©æ˜¯å¦åˆ é™¤åŸé›†åˆ
    # redis_client.delete(old_key)
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„ä¼˜åŒ–è¦ç‚¹


```
ğŸ”¸ å¤§é›†åˆæ‹†åˆ†ï¼šè¶…è¿‡10ä¸‡å…ƒç´ è€ƒè™‘æ‹†åˆ†ï¼ŒæŒ‰ä¸šåŠ¡é€»è¾‘æˆ–å“ˆå¸Œå€¼åˆ†ç‰‡
ğŸ”¸ é¿å…SMEMBERSï¼šæ°¸è¿œä¸è¦å¯¹å¤§é›†åˆä½¿ç”¨å…¨é‡è·å–
ğŸ”¸ è¿ç®—é¡ºåºä¼˜åŒ–ï¼šäº¤é›†è¿ç®—ä»æœ€å°é›†åˆå¼€å§‹ï¼Œå‡å°‘è®¡ç®—é‡
ğŸ”¸ å†…å­˜ç›‘æ§ï¼šå®šæœŸæ£€æŸ¥é›†åˆå¤§å°å’Œå†…å­˜å ç”¨ï¼Œè®¾ç½®å‘Šè­¦
ğŸ”¸ åˆç†è¿‡æœŸï¼šä¸´æ—¶æ•°æ®è®¾ç½®çŸ­æœŸè¿‡æœŸï¼Œç¼“å­˜æ•°æ®è®¾ç½®ä¸­æœŸè¿‡æœŸ
```

### 6.2 å…³é”®æ€§èƒ½é™·é˜±


**ğŸš« ç»å¯¹è¦é¿å…çš„æ“ä½œ**
```
âŒ SMEMBERS huge_set        # å…¨é‡è·å–å¤§é›†åˆ
âŒ SINTER set1 set2 set3    # ä¸æ£€æŸ¥é›†åˆå¤§å°ç›´æ¥è¿ç®—  
âŒ æ— é™åˆ¶æ·»åŠ å…ƒç´ åˆ°åŒä¸€é›†åˆ    # é›†åˆæ— é™å¢é•¿
âŒ çƒ­ç‚¹é›†åˆæ— ç¼“å­˜ç­–ç•¥        # é«˜å¹¶å‘è®¿é—®åŒä¸€é›†åˆ
âŒ æ— è¿‡æœŸæ—¶é—´è®¾ç½®           # ä¸´æ—¶æ•°æ®æ°¸ä¹…å ç”¨å†…å­˜
```

**âœ… æ¨èçš„å®‰å…¨åšæ³•**
```
âœ… SSCAN + COUNT          # åˆ†æ‰¹è·å–é›†åˆæ•°æ®
âœ… SCARDæ£€æŸ¥åå†è¿ç®—       # å…ˆæ£€æŸ¥å¤§å°å†å†³å®šæ“ä½œ
âœ… æŒ‰ä¸šåŠ¡é€»è¾‘åˆ†ç‰‡å­˜å‚¨       # æ§åˆ¶å•ä¸ªé›†åˆå¤§å°
âœ… è¯»å†™åˆ†ç¦»+æœ¬åœ°ç¼“å­˜       # ç¼“è§£çƒ­ç‚¹é›†åˆå‹åŠ›
âœ… æ™ºèƒ½è¿‡æœŸæ—¶é—´ç®¡ç†        # æ ¹æ®æ•°æ®ç±»å‹è®¾ç½®TTL
```

### 6.3 æ€§èƒ½ä¼˜åŒ–è®°å¿†å£è¯€


```
ğŸ¯ Setä¼˜åŒ–ä¸‰åŸåˆ™ï¼š
åˆ†ç‰‡å­˜å‚¨æ§å¤§å°ï¼Œæ‰¹é‡æ“ä½œå‡å¾€è¿”
è¿ç®—é¡ºåºè¦ä¼˜åŒ–ï¼Œå°é›†åˆå…ˆè®¡ç®—  
ç›‘æ§å‘Šè­¦ä¸å¯å°‘ï¼Œè¿‡æœŸæ¸…ç†è¦è®°ç‰¢
```

### 6.4 å®é™…åº”ç”¨å»ºè®®


- **å¼€å‘é˜¶æ®µ**ï¼šè®¾è®¡æ—¶å°±è€ƒè™‘æ•°æ®é‡å¢é•¿ï¼Œæå‰è§„åˆ’åˆ†ç‰‡ç­–ç•¥
- **æµ‹è¯•é˜¶æ®µ**ï¼šæ¨¡æ‹Ÿå¤§æ•°æ®é‡åœºæ™¯ï¼ŒéªŒè¯æ€§èƒ½è¡¨ç°
- **ç”Ÿäº§é˜¶æ®µ**ï¼šå»ºç«‹ç›‘æ§ä½“ç³»ï¼Œå®šæœŸæ£€æŸ¥å’Œä¼˜åŒ–
- **ç»´æŠ¤é˜¶æ®µ**ï¼šæ ¹æ®ä¸šåŠ¡å‘å±•è°ƒæ•´é›†åˆç»“æ„å’Œä¼˜åŒ–ç­–ç•¥

**æ ¸å¿ƒè®°ä½**ï¼š
- Seté›†åˆä¼˜åŒ–çš„æœ¬è´¨æ˜¯**æ§åˆ¶è§„æ¨¡**å’Œ**åˆç†ä½¿ç”¨**
- å¤§é›†åˆçš„å±å®³æ¯”æƒ³è±¡ä¸­ä¸¥é‡ï¼Œ**é¢„é˜²èƒœäºæ²»ç–—**
- æ€§èƒ½ä¼˜åŒ–æ˜¯ä¸ªæŒç»­è¿‡ç¨‹ï¼Œéœ€è¦**ç›‘æ§å’Œè°ƒæ•´**
- é€‰æ‹©åˆé€‚çš„æ•°æ®ç»“æ„å’Œä½¿ç”¨æ–¹å¼æ¯”ç›²ç›®ä¼˜åŒ–æ›´é‡è¦