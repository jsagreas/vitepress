---
title: 19ã€ZSetæœ‰åºé›†åˆç±»å‹é«˜çº§åº”ç”¨
---
## ğŸ“š ç›®å½•

1. [ZSeté«˜çº§åº”ç”¨æ¦‚è¿°](#1-ZSeté«˜çº§åº”ç”¨æ¦‚è¿°)
2. [æ’è¡Œæ¦œç³»ç»Ÿè®¾è®¡](#2-æ’è¡Œæ¦œç³»ç»Ÿè®¾è®¡)
3. [å»¶æ—¶é˜Ÿåˆ—å®ç°](#3-å»¶æ—¶é˜Ÿåˆ—å®ç°)
4. [ä¼˜å…ˆçº§é˜Ÿåˆ—è®¾è®¡](#4-ä¼˜å…ˆçº§é˜Ÿåˆ—è®¾è®¡)
5. [æ—¶é—´çª—å£ç»Ÿè®¡](#5-æ—¶é—´çª—å£ç»Ÿè®¡)
6. [å®æˆ˜æ¡ˆä¾‹è¯¦è§£](#6-å®æˆ˜æ¡ˆä¾‹è¯¦è§£)
7. [æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#7-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ ZSeté«˜çº§åº”ç”¨æ¦‚è¿°


### 1.1 ZSetåœ¨å®é™…ä¸šåŠ¡ä¸­çš„ä»·å€¼


**æ ¸å¿ƒä¼˜åŠ¿**
```
ZSet = è‡ªåŠ¨æ’åº + å¿«é€ŸæŸ¥æ‰¾ + èŒƒå›´æ“ä½œ

ä¼ ç»Ÿè§£å†³æ–¹æ¡ˆ vs ZSetï¼š
æ•°æ®åº“æ’åºï¼šæ¯æ¬¡æŸ¥è¯¢éƒ½è¦ORDER BYï¼Œæ…¢
å†…å­˜æ’åºï¼šç¨‹åºé‡å¯ä¸¢å¤±ï¼Œä¸æŒä¹…
æ–‡ä»¶å­˜å‚¨ï¼šè¯»å†™æ…¢ï¼Œå¹¶å‘å·®
ZSetæ–¹æ¡ˆï¼šè‡ªåŠ¨æœ‰åºï¼ŒO(log n)æ“ä½œï¼ŒæŒä¹…åŒ–
```

**å››å¤§åº”ç”¨åœºæ™¯æ¦‚è§ˆ**
```
ä¸šåŠ¡åœºæ™¯åˆ†ç±»ï¼š

ğŸ“Š æ’è¡Œæ¦œç³»ç»Ÿ
â€¢ æ¸¸æˆç§¯åˆ†æ¦œã€é”€å”®æ’è¡Œã€çƒ­é—¨å†…å®¹
â€¢ ç‰¹ç‚¹ï¼šéœ€è¦å®æ—¶æ›´æ–°æ’åï¼Œæ”¯æŒåˆ†é¡µæŸ¥è¯¢

â° å»¶æ—¶é˜Ÿåˆ—  
â€¢ å®šæ—¶ä»»åŠ¡ã€å»¶è¿Ÿæ¶ˆæ¯ã€è¿‡æœŸå¤„ç†
â€¢ ç‰¹ç‚¹ï¼šæŒ‰æ—¶é—´æ’åºï¼Œåˆ°æœŸè‡ªåŠ¨è§¦å‘

ğŸ¯ ä¼˜å…ˆçº§é˜Ÿåˆ—
â€¢ ä»»åŠ¡è°ƒåº¦ã€æ¶ˆæ¯å¤„ç†ã€è´Ÿè½½å‡è¡¡
â€¢ ç‰¹ç‚¹ï¼šæŒ‰ä¼˜å…ˆçº§å¤„ç†ï¼ŒåŠ¨æ€è°ƒæ•´

ğŸ“ˆ æ—¶é—´çª—å£ç»Ÿè®¡
â€¢ å®æ—¶ç›‘æ§ã€è¶‹åŠ¿åˆ†æã€æ»‘åŠ¨çª—å£
â€¢ ç‰¹ç‚¹ï¼šæ—¶é—´åºåˆ—æ•°æ®ï¼Œç»Ÿè®¡è®¡ç®—
```

### 1.2 ZSetæ ¸å¿ƒæœºåˆ¶å›é¡¾


**æ•°æ®ç»“æ„åŸç†**
```
ZSetå†…éƒ¨ç»“æ„ï¼š
member(å…ƒç´ ) + score(åˆ†æ•°) â†’ è‡ªåŠ¨æŒ‰scoreæ’åº

ç¤ºä¾‹ï¼š
ZADD leaderboard 1500 "player1" 2000 "player2" 1200 "player3"

å†…éƒ¨æ’åºç»“æœï¼š
player3(1200) â†’ player1(1500) â†’ player2(2000)

å…³é”®ç‰¹æ€§ï¼š
â€¢ æ’å…¥ï¼šO(log N) - è‡ªåŠ¨ç»´æŠ¤æœ‰åº
â€¢ æŸ¥è¯¢ï¼šO(log N) - äºŒåˆ†æŸ¥æ‰¾å®šä½  
â€¢ èŒƒå›´ï¼šO(log N + M) - å¿«é€ŸèŒƒå›´æ“ä½œ
â€¢ æ’åï¼šO(log N) - ç›´æ¥è·å–æ’å
```

---

## 2. ğŸ“Š æ’è¡Œæ¦œç³»ç»Ÿè®¾è®¡


### 2.1 å®æ—¶æ’è¡Œæ¦œè®¾è®¡


**åŸºç¡€æ’è¡Œæ¦œå®ç°**
```java
/**
 * å®æ—¶æ¸¸æˆæ’è¡Œæ¦œ
 */
public class GameLeaderboard {
    private final String LEADERBOARD_KEY = "game:leaderboard";
    
    // æ›´æ–°ç©å®¶åˆ†æ•°
    public void updateScore(String playerId, double score) {
        jedis.zadd(LEADERBOARD_KEY, score, playerId);
    }
    
    // è·å–æ’è¡Œæ¦œå‰Nå
    public List<PlayerRank> getTopRanking(int topN) {
        // æŒ‰åˆ†æ•°å€’åºè·å–ï¼ˆåˆ†æ•°é«˜çš„åœ¨å‰ï¼‰
        Set<Tuple> rankings = jedis.zrevrangeWithScores(LEADERBOARD_KEY, 0, topN - 1);
        
        List<PlayerRank> result = new ArrayList<>();
        int rank = 1;
        for (Tuple tuple : rankings) {
            result.add(new PlayerRank(tuple.getElement(), tuple.getScore(), rank++));
        }
        return result;
    }
    
    // è·å–ç©å®¶å½“å‰æ’å
    public PlayerRank getPlayerRank(String playerId) {
        Double score = jedis.zscore(LEADERBOARD_KEY, playerId);
        if (score == null) return null;
        
        // è·å–æ’åï¼ˆä»0å¼€å§‹ï¼Œæ‰€ä»¥+1ï¼‰
        Long rank = jedis.zrevrank(LEADERBOARD_KEY, playerId);
        return new PlayerRank(playerId, score, rank + 1);
    }
}
```

**åˆ†é¡µå±•ç¤ºå®ç°**
```java
// åˆ†é¡µè·å–æ’è¡Œæ¦œ
public PageResult<PlayerRank> getRankingByPage(int pageNo, int pageSize) {
    int start = (pageNo - 1) * pageSize;
    int end = start + pageSize - 1;
    
    // è·å–æŒ‡å®šèŒƒå›´çš„æ’åæ•°æ®
    Set<Tuple> rankings = jedis.zrevrangeWithScores(LEADERBOARD_KEY, start, end);
    
    List<PlayerRank> players = new ArrayList<>();
    int currentRank = start + 1; // å½“å‰æ’å
    
    for (Tuple tuple : rankings) {
        players.add(new PlayerRank(
            tuple.getElement(), 
            tuple.getScore(), 
            currentRank++
        ));
    }
    
    // è·å–æ€»æ•°
    long total = jedis.zcard(LEADERBOARD_KEY);
    
    return new PageResult<>(players, pageNo, pageSize, total);
}
```

### 2.2 å¤šç»´åº¦æ’è¡Œæ¦œ


**å¤šç»´åº¦æ’è¡Œæ¦œè®¾è®¡æ€è·¯**
```
ä¸šåŠ¡éœ€æ±‚ï¼šæ¸¸æˆéœ€è¦å¤šä¸ªç»´åº¦çš„æ’è¡Œæ¦œ
â€¢ æ€»ç§¯åˆ†æ’è¡Œæ¦œ
â€¢ å‘¨ç§¯åˆ†æ’è¡Œæ¦œ  
â€¢ ç­‰çº§æ’è¡Œæ¦œ
â€¢ è´¢å¯Œæ’è¡Œæ¦œ

è®¾è®¡æ–¹æ¡ˆï¼š
game:rank:total     - æ€»ç§¯åˆ†æ¦œ
game:rank:week      - å‘¨ç§¯åˆ†æ¦œ
game:rank:level     - ç­‰çº§æ¦œ
game:rank:wealth    - è´¢å¯Œæ¦œ
```

**å¤šç»´åº¦æ›´æ–°å®ç°**
```java
public class MultiDimensionRanking {
    
    // ç©å®¶å‡çº§æ—¶åŒæ—¶æ›´æ–°å¤šä¸ªç»´åº¦
    public void playerLevelUp(String playerId, PlayerInfo info) {
        // 1. æ›´æ–°æ€»ç§¯åˆ†æ¦œ
        jedis.zadd("game:rank:total", info.getTotalScore(), playerId);
        
        // 2. æ›´æ–°ç­‰çº§æ¦œ
        jedis.zadd("game:rank:level", info.getLevel(), playerId);
        
        // 3. æ›´æ–°è´¢å¯Œæ¦œ  
        jedis.zadd("game:rank:wealth", info.getWealth(), playerId);
        
        // 4. æ›´æ–°æœ¬å‘¨ç§¯åˆ†æ¦œ
        String weekKey = "game:rank:week:" + getCurrentWeek();
        jedis.zadd(weekKey, info.getWeekScore(), playerId);
        jedis.expire(weekKey, 7 * 24 * 3600); // ä¸€å‘¨åè¿‡æœŸ
    }
    
    // è·å–ç©å®¶åœ¨å„ç»´åº¦çš„æ’å
    public PlayerMultiRank getPlayerMultiRank(String playerId) {
        PlayerMultiRank result = new PlayerMultiRank();
        
        // æ€»ç§¯åˆ†æ’å
        result.setTotalRank(jedis.zrevrank("game:rank:total", playerId) + 1);
        
        // ç­‰çº§æ’å
        result.setLevelRank(jedis.zrevrank("game:rank:level", playerId) + 1);
        
        // è´¢å¯Œæ’å
        result.setWealthRank(jedis.zrevrank("game:rank:wealth", playerId) + 1);
        
        return result;
    }
}
```

### 2.3 å†å²æ’è¡Œæ¦œå­˜å‚¨


**å†å²å¿«ç…§ç­–ç•¥**
```java
public class HistoryRankingManager {
    
    // æ¯æ—¥ä¿å­˜æ’è¡Œæ¦œå¿«ç…§
    @Scheduled(cron = "0 0 0 * * ?") // æ¯å¤©0ç‚¹æ‰§è¡Œ
    public void saveHistorySnapshot() {
        String todayKey = "game:rank:total";
        String historyKey = "game:history:" + LocalDate.now().toString();
        
        // æ–¹æ¡ˆ1ï¼šå¤åˆ¶æ•´ä¸ªæ’è¡Œæ¦œ
        Set<Tuple> currentRanking = jedis.zrangeWithScores(todayKey, 0, -1);
        for (Tuple tuple : currentRanking) {
            jedis.zadd(historyKey, tuple.getScore(), tuple.getElement());
        }
        
        // è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆä¿å­˜30å¤©ï¼‰
        jedis.expire(historyKey, 30 * 24 * 3600);
    }
    
    // è·å–å†å²æ’è¡Œæ¦œ
    public List<PlayerRank> getHistoryRanking(LocalDate date, int topN) {
        String historyKey = "game:history:" + date.toString();
        Set<Tuple> rankings = jedis.zrevrangeWithScores(historyKey, 0, topN - 1);
        
        List<PlayerRank> result = new ArrayList<>();
        int rank = 1;
        for (Tuple tuple : rankings) {
            result.add(new PlayerRank(tuple.getElement(), tuple.getScore(), rank++));
        }
        return result;
    }
}
```

---

## 3. â° å»¶æ—¶é˜Ÿåˆ—å®ç°


### 3.1 åŸºäºæ—¶é—´æˆ³çš„å»¶æ—¶é˜Ÿåˆ—


**å»¶æ—¶é˜Ÿåˆ—è®¾è®¡åŸç†**
```
å»¶æ—¶é˜Ÿåˆ—æ ¸å¿ƒæ€æƒ³ï¼š
â€¢ ç”¨æ‰§è¡Œæ—¶é—´çš„æ—¶é—´æˆ³ä½œä¸ºscore
â€¢ ä»»åŠ¡ä¿¡æ¯ä½œä¸ºmember
â€¢ å®šæ—¶æ‰«æåˆ°æœŸä»»åŠ¡

æ—¶é—´çº¿ç¤ºä¾‹ï¼š
ç°åœ¨æ—¶é—´: 1693200000
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä»»åŠ¡A   â”‚  ä»»åŠ¡B   â”‚  ä»»åŠ¡C   â”‚  ä»»åŠ¡D   â”‚
â”‚ +30ç§’   â”‚ +60ç§’   â”‚ +120ç§’  â”‚ +300ç§’  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
1693200030 1693200060 1693200120 1693200300
```

**å»¶æ—¶é˜Ÿåˆ—åŸºç¡€å®ç°**
```java
public class DelayQueue {
    private final String QUEUE_KEY = "delay:queue";
    
    // æ·»åŠ å»¶æ—¶ä»»åŠ¡
    public void addDelayTask(String taskId, String taskData, long delaySeconds) {
        long executeTime = System.currentTimeMillis() / 1000 + delaySeconds;
        
        // åˆ›å»ºä»»åŠ¡å¯¹è±¡
        DelayTask task = new DelayTask(taskId, taskData, executeTime);
        String taskJson = JSON.toJSONString(task);
        
        // æ·»åŠ åˆ°ZSetï¼Œæ‰§è¡Œæ—¶é—´ä½œä¸ºåˆ†æ•°
        jedis.zadd(QUEUE_KEY, executeTime, taskJson);
        
        System.out.println("æ·»åŠ å»¶æ—¶ä»»åŠ¡: " + taskId + ", å»¶æ—¶: " + delaySeconds + "ç§’");
    }
    
    // è·å–åˆ°æœŸä»»åŠ¡
    public List<DelayTask> getExpiredTasks() {
        long currentTime = System.currentTimeMillis() / 1000;
        
        // è·å–åˆ†æ•°å°äºç­‰äºå½“å‰æ—¶é—´çš„ä»»åŠ¡ï¼ˆåˆ°æœŸä»»åŠ¡ï¼‰
        Set<String> expiredTasks = jedis.zrangeByScore(QUEUE_KEY, 0, currentTime);
        
        List<DelayTask> tasks = new ArrayList<>();
        for (String taskJson : expiredTasks) {
            DelayTask task = JSON.parseObject(taskJson, DelayTask.class);
            tasks.add(task);
            
            // å¤„ç†å®Œæˆååˆ é™¤ä»»åŠ¡
            jedis.zrem(QUEUE_KEY, taskJson);
        }
        
        return tasks;
    }
    
    // å–æ¶ˆå»¶æ—¶ä»»åŠ¡
    public boolean cancelDelayTask(String taskId) {
        // ç”±äºmemberæ˜¯JSONï¼Œéœ€è¦å…ˆæŸ¥æ‰¾å†åˆ é™¤
        Set<String> allTasks = jedis.zrange(QUEUE_KEY, 0, -1);
        
        for (String taskJson : allTasks) {
            DelayTask task = JSON.parseObject(taskJson, DelayTask.class);
            if (task.getTaskId().equals(taskId)) {
                jedis.zrem(QUEUE_KEY, taskJson);
                return true;
            }
        }
        return false;
    }
}
```

### 3.2 ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿ


**å®šæ—¶æ‰«æå¤„ç†å™¨**
```java
@Component
public class DelayTaskProcessor {
    
    @Autowired
    private DelayQueue delayQueue;
    
    // æ¯5ç§’æ‰«æä¸€æ¬¡åˆ°æœŸä»»åŠ¡
    @Scheduled(fixedDelay = 5000)
    public void processExpiredTasks() {
        List<DelayTask> expiredTasks = delayQueue.getExpiredTasks();
        
        for (DelayTask task : expiredTasks) {
            try {
                // æ ¹æ®ä»»åŠ¡ç±»å‹åˆ†å‘å¤„ç†
                handleTask(task);
                System.out.println("å¤„ç†å»¶æ—¶ä»»åŠ¡: " + task.getTaskId());
            } catch (Exception e) {
                System.err.println("å¤„ç†ä»»åŠ¡å¤±è´¥: " + task.getTaskId() + ", é”™è¯¯: " + e.getMessage());
                // å¤„ç†å¤±è´¥çš„ä»»åŠ¡å¯ä»¥é‡æ–°æ”¾å…¥é˜Ÿåˆ—æˆ–è®°å½•å¤±è´¥æ—¥å¿—
            }
        }
    }
    
    private void handleTask(DelayTask task) {
        // æ ¹æ®ä»»åŠ¡ç±»å‹å¤„ç†
        switch (task.getTaskType()) {
            case "ORDER_TIMEOUT":
                handleOrderTimeout(task);
                break;
            case "SEND_EMAIL":
                sendDelayEmail(task);
                break;
            case "CACHE_EXPIRE":
                handleCacheExpire(task);
                break;
            default:
                System.out.println("æœªçŸ¥ä»»åŠ¡ç±»å‹: " + task.getTaskType());
        }
    }
}
```

### 3.3 é˜Ÿåˆ—ç›‘æ§å‘Šè­¦


**é˜Ÿåˆ—çŠ¶æ€ç›‘æ§**
```java
public class DelayQueueMonitor {
    
    // è·å–é˜Ÿåˆ—ç»Ÿè®¡ä¿¡æ¯
    public QueueStats getQueueStats() {
        long totalTasks = jedis.zcard(QUEUE_KEY);
        long currentTime = System.currentTimeMillis() / 1000;
        
        // ç»Ÿè®¡åˆ°æœŸä»»åŠ¡æ•°é‡
        long expiredCount = jedis.zcount(QUEUE_KEY, 0, currentTime);
        
        // ç»Ÿè®¡æœªæ¥1å°æ—¶å†…åˆ°æœŸçš„ä»»åŠ¡
        long nextHourExpired = jedis.zcount(QUEUE_KEY, currentTime, currentTime + 3600);
        
        // è·å–æœ€è¿‘å’Œæœ€è¿œçš„ä»»åŠ¡æ—¶é—´
        Set<Tuple> firstTask = jedis.zrangeWithScores(QUEUE_KEY, 0, 0);
        Set<Tuple> lastTask = jedis.zrangeWithScores(QUEUE_KEY, -1, -1);
        
        QueueStats stats = new QueueStats();
        stats.setTotalTasks(totalTasks);
        stats.setExpiredTasks(expiredCount);
        stats.setNextHourTasks(nextHourExpired);
        
        if (!firstTask.isEmpty()) {
            stats.setNearestTaskTime((long) firstTask.iterator().next().getScore());
        }
        if (!lastTask.isEmpty()) {
            stats.setFarthestTaskTime((long) lastTask.iterator().next().getScore());
        }
        
        return stats;
    }
    
    // æ£€æŸ¥é˜Ÿåˆ—å¥åº·çŠ¶æ€
    @Scheduled(fixedDelay = 60000) // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    public void checkQueueHealth() {
        QueueStats stats = getQueueStats();
        
        // å‘Šè­¦è§„åˆ™
        if (stats.getExpiredTasks() > 1000) {
            sendAlert("å»¶æ—¶é˜Ÿåˆ—å †ç§¯ä¸¥é‡ï¼Œåˆ°æœŸä»»åŠ¡æ•°: " + stats.getExpiredTasks());
        }
        
        if (stats.getTotalTasks() > 10000) {
            sendAlert("å»¶æ—¶é˜Ÿåˆ—ä»»åŠ¡æ€»æ•°è¿‡å¤š: " + stats.getTotalTasks());
        }
    }
}
```

---

## 4. ğŸ¯ ä¼˜å…ˆçº§é˜Ÿåˆ—è®¾è®¡


### 4.1 ä»»åŠ¡ä¼˜å…ˆçº§ç®¡ç†


**ä¼˜å…ˆçº§é˜Ÿåˆ—åŸºæœ¬å®ç°**
```java
public class PriorityTaskQueue {
    private final String QUEUE_KEY = "priority:queue";
    
    // ä¼˜å…ˆçº§å®šä¹‰
    public enum Priority {
        LOW(1), NORMAL(5), HIGH(10), URGENT(20), CRITICAL(50);
        
        private final int score;
        Priority(int score) { this.score = score; }
        public int getScore() { return score; }
    }
    
    // æ·»åŠ ä¼˜å…ˆçº§ä»»åŠ¡
    public void addTask(String taskId, String taskData, Priority priority) {
        PriorityTask task = new PriorityTask(taskId, taskData, priority);
        String taskJson = JSON.toJSONString(task);
        
        // ä½¿ç”¨ä¼˜å…ˆçº§åˆ†æ•°ï¼Œåˆ†æ•°è¶Šé«˜ä¼˜å…ˆçº§è¶Šé«˜
        jedis.zadd(QUEUE_KEY, priority.getScore(), taskJson);
        
        System.out.println("æ·»åŠ ä»»åŠ¡: " + taskId + ", ä¼˜å…ˆçº§: " + priority);
    }
    
    // è·å–æœ€é«˜ä¼˜å…ˆçº§ä»»åŠ¡
    public PriorityTask getHighestPriorityTask() {
        // æŒ‰åˆ†æ•°å€’åºè·å–ç¬¬ä¸€ä¸ªï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
        Set<String> tasks = jedis.zrevrange(QUEUE_KEY, 0, 0);
        
        if (tasks.isEmpty()) {
            return null;
        }
        
        String taskJson = tasks.iterator().next();
        jedis.zrem(QUEUE_KEY, taskJson); // è·å–ååˆ é™¤
        
        return JSON.parseObject(taskJson, PriorityTask.class);
    }
    
    // æ‰¹é‡è·å–ä»»åŠ¡ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
    public List<PriorityTask> getTasks(int batchSize) {
        Set<String> tasks = jedis.zrevrange(QUEUE_KEY, 0, batchSize - 1);
        
        List<PriorityTask> result = new ArrayList<>();
        for (String taskJson : tasks) {
            PriorityTask task = JSON.parseObject(taskJson, PriorityTask.class);
            result.add(task);
            jedis.zrem(QUEUE_KEY, taskJson);
        }
        
        return result;
    }
}
```

### 4.2 åŠ¨æ€ä¼˜å…ˆçº§è°ƒæ•´


**ä¼˜å…ˆçº§åŠ¨æ€è°ƒæ•´æœºåˆ¶**
```java
public class DynamicPriorityManager {
    
    // æ ¹æ®ç­‰å¾…æ—¶é—´åŠ¨æ€è°ƒæ•´ä¼˜å…ˆçº§
    public void adjustPriorityByWaitTime() {
        long currentTime = System.currentTimeMillis();
        Set<Tuple> allTasks = jedis.zrangeWithScores(QUEUE_KEY, 0, -1);
        
        for (Tuple tuple : allTasks) {
            String taskJson = tuple.getElement();
            double currentScore = tuple.getScore();
            
            PriorityTask task = JSON.parseObject(taskJson, PriorityTask.class);
            
            // è®¡ç®—ç­‰å¾…æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
            long waitMinutes = (currentTime - task.getCreateTime()) / (1000 * 60);
            
            // æ¯ç­‰å¾…10åˆ†é’Ÿï¼Œä¼˜å…ˆçº§+1
            double bonusScore = waitMinutes / 10.0;
            double newScore = currentScore + bonusScore;
            
            // æ›´æ–°ä¼˜å…ˆçº§
            if (newScore != currentScore) {
                jedis.zadd(QUEUE_KEY, newScore, taskJson);
                System.out.println("ä»»åŠ¡ " + task.getTaskId() + " ä¼˜å…ˆçº§è°ƒæ•´: " 
                                 + currentScore + " â†’ " + newScore);
            }
        }
    }
    
    // æ ¹æ®ç³»ç»Ÿè´Ÿè½½è°ƒæ•´ä¼˜å…ˆçº§
    public void adjustPriorityBySystemLoad() {
        double cpuUsage = getCpuUsage();
        
        if (cpuUsage > 80) {
            // ç³»ç»Ÿè´Ÿè½½é«˜ï¼Œåªå¤„ç†ç´§æ€¥ä»»åŠ¡
            demoteNormalTasks();
        } else if (cpuUsage < 30) {
            // ç³»ç»Ÿè´Ÿè½½ä½ï¼Œæå‡æ‰€æœ‰ä»»åŠ¡ä¼˜å…ˆçº§
            promoteAllTasks();
        }
    }
    
    private void demoteNormalTasks() {
        // é™ä½æ™®é€šä»»åŠ¡çš„ä¼˜å…ˆçº§
        Set<Tuple> normalTasks = jedis.zrangeByScoreWithScores(QUEUE_KEY, 1, 10);
        
        for (Tuple tuple : normalTasks) {
            double newScore = tuple.getScore() * 0.5; // ä¼˜å…ˆçº§å‡åŠ
            jedis.zadd(QUEUE_KEY, newScore, tuple.getElement());
        }
    }
}
```

### 4.3 è´Ÿè½½å‡è¡¡ç®—æ³•


**å¤šé˜Ÿåˆ—è´Ÿè½½å‡è¡¡**
```java
public class LoadBalancedTaskDispatcher {
    private final List<String> workerQueues = Arrays.asList(
        "worker:queue:1", "worker:queue:2", "worker:queue:3"
    );
    
    // æ ¹æ®é˜Ÿåˆ—é•¿åº¦åˆ†å‘ä»»åŠ¡
    public void distributeTask(PriorityTask task) {
        // æ‰¾åˆ°ä»»åŠ¡æ•°æœ€å°‘çš„é˜Ÿåˆ—
        String targetQueue = null;
        long minQueueSize = Long.MAX_VALUE;
        
        for (String queueKey : workerQueues) {
            long queueSize = jedis.zcard(queueKey);
            if (queueSize < minQueueSize) {
                minQueueSize = queueSize;
                targetQueue = queueKey;
            }
        }
        
        // æ·»åŠ åˆ°ç›®æ ‡é˜Ÿåˆ—
        String taskJson = JSON.toJSONString(task);
        jedis.zadd(targetQueue, task.getPriority().getScore(), taskJson);
        
        System.out.println("ä»»åŠ¡åˆ†å‘åˆ°: " + targetQueue + ", å½“å‰é˜Ÿåˆ—å¤§å°: " + minQueueSize);
    }
    
    // åŠ æƒè½®è¯¢åˆ†å‘
    public void distributeTaskWithWeight(PriorityTask task) {
        // å®šä¹‰æƒé‡ï¼ˆå¤„ç†èƒ½åŠ›ï¼‰
        Map<String, Integer> queueWeights = Map.of(
            "worker:queue:1", 3,  // é«˜æ€§èƒ½æœåŠ¡å™¨
            "worker:queue:2", 2,  // ä¸­ç­‰æ€§èƒ½æœåŠ¡å™¨  
            "worker:queue:3", 1   // ä½æ€§èƒ½æœåŠ¡å™¨
        );
        
        // æ ¹æ®æƒé‡å’Œå½“å‰è´Ÿè½½é€‰æ‹©é˜Ÿåˆ—
        String targetQueue = selectQueueByWeight(queueWeights);
        
        String taskJson = JSON.toJSONString(task);
        jedis.zadd(targetQueue, task.getPriority().getScore(), taskJson);
    }
}
```

---

## 5. ğŸ“ˆ æ—¶é—´çª—å£ç»Ÿè®¡


### 5.1 æ»‘åŠ¨çª—å£å®ç°


**æ»‘åŠ¨çª—å£ç»Ÿè®¡åŸç†**
```
æ»‘åŠ¨çª—å£æ¦‚å¿µï¼š
â€¢ å›ºå®šæ—¶é—´é•¿åº¦çš„çª—å£
â€¢ çª—å£éšæ—¶é—´ç§»åŠ¨
â€¢ å®æ—¶ç»Ÿè®¡çª—å£å†…çš„æ•°æ®

ç¤ºä¾‹ï¼šç»Ÿè®¡æœ€è¿‘1å°æ—¶çš„è®¿é—®é‡
æ—¶é—´æˆ³ä½œä¸ºscoreï¼Œäº‹ä»¶ä½œä¸ºmember

å½“å‰æ—¶é—´: 1693200000
çª—å£å¤§å°: 3600ç§’ï¼ˆ1å°æ—¶ï¼‰
çª—å£èŒƒå›´: [1693196400, 1693200000]

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        1å°æ—¶æ»‘åŠ¨çª—å£                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚äº‹ä»¶1  äº‹ä»¶2  äº‹ä»¶3  ...  äº‹ä»¶N           â”‚
â”‚1693196500 1693197000 1693198000 1693199500â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ»‘åŠ¨çª—å£åŸºç¡€å®ç°**
```java
public class SlidingWindowCounter {
    
    // è®°å½•è®¿é—®äº‹ä»¶
    public void recordAccess(String userId, String action) {
        String key = "access:window:" + action;
        long timestamp = System.currentTimeMillis() / 1000;
        String member = userId + ":" + timestamp;
        
        // æ·»åŠ è®¿é—®è®°å½•
        jedis.zadd(key, timestamp, member);
        
        // æ¸…ç†è¿‡æœŸæ•°æ®ï¼ˆä¿ç•™æœ€è¿‘1å°æ—¶ï¼‰
        long windowStart = timestamp - 3600;
        jedis.zremrangeByScore(key, 0, windowStart);
    }
    
    // è·å–æ»‘åŠ¨çª—å£å†…çš„ç»Ÿè®¡
    public WindowStats getWindowStats(String action, int windowSeconds) {
        String key = "access:window:" + action;
        long currentTime = System.currentTimeMillis() / 1000;
        long windowStart = currentTime - windowSeconds;
        
        // ç»Ÿè®¡çª—å£å†…çš„äº‹ä»¶æ•°é‡
        long totalCount = jedis.zcount(key, windowStart, currentTime);
        
        // è·å–çª—å£å†…çš„è¯¦ç»†æ•°æ®
        Set<Tuple> windowData = jedis.zrangeByScoreWithScores(key, windowStart, currentTime);
        
        // æŒ‰æ—¶é—´æ®µåˆ†ç»„ç»Ÿè®¡ï¼ˆæ¯5åˆ†é’Ÿä¸€ä¸ªæ®µï¼‰
        Map<Long, Long> timeSegments = new HashMap<>();
        long segmentSize = 300; // 5åˆ†é’Ÿ
        
        for (Tuple tuple : windowData) {
            long eventTime = (long) tuple.getScore();
            long segment = (eventTime / segmentSize) * segmentSize;
            timeSegments.merge(segment, 1L, Long::sum);
        }
        
        WindowStats stats = new WindowStats();
        stats.setTotalCount(totalCount);
        stats.setWindowStart(windowStart);
        stats.setWindowEnd(currentTime);
        stats.setTimeSegments(timeSegments);
        
        return stats;
    }
    
    // è·å–å®æ—¶é€Ÿç‡ï¼ˆæ¯ç§’äº‹ä»¶æ•°ï¼‰
    public double getRealTimeRate(String action) {
        WindowStats stats = getWindowStats(action, 60); // æœ€è¿‘1åˆ†é’Ÿ
        return stats.getTotalCount() / 60.0;
    }
}
```

### 5.2 æ—¶é—´åºåˆ—æ•°æ®å¤„ç†


**å¤šç²’åº¦æ—¶é—´ç»Ÿè®¡**
```java
public class TimeSeriesAnalyzer {
    
    // å¤šç²’åº¦è®°å½•æ•°æ®
    public void recordMetric(String metric, double value) {
        long timestamp = System.currentTimeMillis() / 1000;
        String member = metric + ":" + timestamp + ":" + value;
        
        // è®°å½•åˆ°ä¸åŒç²’åº¦çš„æ—¶é—´åºåˆ—
        jedis.zadd("metrics:minute:" + metric, timestamp, member);
        jedis.zadd("metrics:hour:" + metric, timestamp, member);  
        jedis.zadd("metrics:day:" + metric, timestamp, member);
        
        // è®¾ç½®è¿‡æœŸæ—¶é—´
        jedis.expire("metrics:minute:" + metric, 3600);    // 1å°æ—¶
        jedis.expire("metrics:hour:" + metric, 86400);     // 1å¤©
        jedis.expire("metrics:day:" + metric, 86400 * 30); // 30å¤©
    }
    
    // è®¡ç®—æŒ‡å®šæ—¶é—´èŒƒå›´çš„ç»Ÿè®¡å€¼
    public MetricStats calculateStats(String metric, String granularity, 
                                    long startTime, long endTime) {
        String key = "metrics:" + granularity + ":" + metric;
        
        Set<Tuple> data = jedis.zrangeByScoreWithScores(key, startTime, endTime);
        
        if (data.isEmpty()) {
            return new MetricStats();
        }
        
        double sum = 0;
        double min = Double.MAX_VALUE;
        double max = Double.MIN_VALUE;
        int count = 0;
        
        for (Tuple tuple : data) {
            String[] parts = tuple.getElement().split(":");
            double value = Double.parseDouble(parts[2]);
            
            sum += value;
            min = Math.min(min, value);
            max = Math.max(max, value);
            count++;
        }
        
        MetricStats stats = new MetricStats();
        stats.setSum(sum);
        stats.setAverage(sum / count);
        stats.setMin(min);
        stats.setMax(max);
        stats.setCount(count);
        
        return stats;
    }
}
```

### 5.3 è¶‹åŠ¿åˆ†æè®¡ç®—


**è¶‹åŠ¿è®¡ç®—å®ç°**
```java
public class TrendAnalyzer {
    
    // è®¡ç®—å¢é•¿è¶‹åŠ¿
    public TrendResult analyzeTrend(String metric, int days) {
        List<DayStats> dayStats = new ArrayList<>();
        
        // è·å–æœ€è¿‘Nå¤©çš„æ•°æ®
        for (int i = days - 1; i >= 0; i--) {
            long dayStart = getStartOfDay(-i);
            long dayEnd = getEndOfDay(-i);
            
            MetricStats stats = calculateStats(metric, "day", dayStart, dayEnd);
            dayStats.add(new DayStats(dayStart, stats.getSum()));
        }
        
        // è®¡ç®—è¶‹åŠ¿
        double trend = calculateLinearTrend(dayStats);
        TrendDirection direction = getTrendDirection(trend);
        
        TrendResult result = new TrendResult();
        result.setTrend(trend);
        result.setDirection(direction);
        result.setDayStats(dayStats);
        
        return result;
    }
    
    private double calculateLinearTrend(List<DayStats> dayStats) {
        int n = dayStats.size();
        double sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
        
        for (int i = 0; i < n; i++) {
            double x = i; // å¤©æ•°
            double y = dayStats.get(i).getValue(); // æ•°å€¼
            
            sumX += x;
            sumY += y;
            sumXY += x * y;
            sumX2 += x * x;
        }
        
        // çº¿æ€§å›å½’æ–œç‡è®¡ç®—
        return (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
    }
    
    private TrendDirection getTrendDirection(double trend) {
        if (trend > 0.1) return TrendDirection.UP;
        if (trend < -0.1) return TrendDirection.DOWN;
        return TrendDirection.STABLE;
    }
}
```

---

## 6. ğŸš€ å®æˆ˜æ¡ˆä¾‹è¯¦è§£


### 6.1 æ¸¸æˆæ’è¡Œæ¦œç³»ç»Ÿ


**å®Œæ•´çš„æ¸¸æˆæ’è¡Œæ¦œå®ç°**
```java
@Service
public class GameRankingService {
    
    // ç©å®¶å‡»æ€æ•Œäººï¼Œè·å¾—ç§¯åˆ†
    public void playerKillEnemy(String playerId, int killCount) {
        String key = "game:rank:kills";
        
        // å¢åŠ å‡»æ€æ•°
        jedis.zincrby(key, killCount, playerId);
        
        // æ›´æ–°ç©å®¶ç­‰çº§ï¼ˆåŸºäºå‡»æ€æ•°ï¼‰
        updatePlayerLevel(playerId);
        
        // å¹¿æ’­æ’è¡Œæ¦œæ›´æ–°äº‹ä»¶
        broadcastRankingUpdate(playerId);
    }
    
    // è·å–å®æ—¶æ’è¡Œæ¦œ
    public GameRankingResponse getRealTimeRanking(int topN) {
        String key = "game:rank:kills";
        
        Set<Tuple> topPlayers = jedis.zrevrangeWithScores(key, 0, topN - 1);
        
        List<PlayerRankInfo> rankings = new ArrayList<>();
        int rank = 1;
        
        for (Tuple tuple : topPlayers) {
            String playerId = tuple.getElement();
            double kills = tuple.getScore();
            
            // è·å–ç©å®¶è¯¦ç»†ä¿¡æ¯
            PlayerInfo playerInfo = getPlayerInfo(playerId);
            
            PlayerRankInfo rankInfo = new PlayerRankInfo();
            rankInfo.setRank(rank++);
            rankInfo.setPlayerId(playerId);
            rankInfo.setPlayerName(playerInfo.getName());
            rankInfo.setKills((long) kills);
            rankInfo.setLevel(playerInfo.getLevel());
            
            rankings.add(rankInfo);
        }
        
        GameRankingResponse response = new GameRankingResponse();
        response.setRankings(rankings);
        response.setUpdateTime(System.currentTimeMillis());
        response.setTotalPlayers(jedis.zcard(key));
        
        return response;
    }
    
    // è·å–ç©å®¶å‘¨å›´æ’å
    public List<PlayerRankInfo> getPlayerSurroundingRank(String playerId, int range) {
        String key = "game:rank:kills";
        
        Long playerRank = jedis.zrevrank(key, playerId);
        if (playerRank == null) {
            return new ArrayList<>();
        }
        
        // è®¡ç®—èŒƒå›´
        long start = Math.max(0, playerRank - range);
        long end = playerRank + range;
        
        Set<Tuple> surroundingPlayers = jedis.zrevrangeWithScores(key, start, end);
        
        List<PlayerRankInfo> result = new ArrayList<>();
        long currentRank = start + 1;
        
        for (Tuple tuple : surroundingPlayers) {
            PlayerInfo playerInfo = getPlayerInfo(tuple.getElement());
            
            PlayerRankInfo rankInfo = new PlayerRankInfo();
            rankInfo.setRank((int) currentRank++);
            rankInfo.setPlayerId(tuple.getElement());
            rankInfo.setPlayerName(playerInfo.getName());
            rankInfo.setKills((long) tuple.getScore());
            
            result.add(rankInfo);
        }
        
        return result;
    }
}
```

### 6.2 çƒ­é—¨å†…å®¹æ’åºç³»ç»Ÿ


**åŸºäºå¤šå› å­çš„çƒ­é—¨å†…å®¹æ’åº**
```java
@Service 
public class HotContentRankingService {
    
    // è®¡ç®—å†…å®¹çƒ­åº¦åˆ†æ•°
    private double calculateHotScore(ContentMetrics metrics) {
        long now = System.currentTimeMillis() / 1000;
        long publishTime = metrics.getPublishTime();
        
        // æ—¶é—´è¡°å‡å› å­ï¼ˆå‘å¸ƒæ—¶é—´è¶Šä¹…ï¼Œåˆ†æ•°è¡°å‡è¶Šå¤šï¼‰
        double timeDecay = Math.exp(-(now - publishTime) / 86400.0); // æŒ‰å¤©è¡°å‡
        
        // ç»¼åˆåˆ†æ•° = (ç‚¹èµæ•° * 2 + è¯„è®ºæ•° * 3 + åˆ†äº«æ•° * 5) * æ—¶é—´è¡°å‡
        double baseScore = metrics.getLikes() * 2 + 
                          metrics.getComments() * 3 + 
                          metrics.getShares() * 5;
        
        return baseScore * timeDecay;
    }
    
    // æ›´æ–°å†…å®¹çƒ­åº¦
    public void updateContentHotness(String contentId) {
        ContentMetrics metrics = getContentMetrics(contentId);
        double hotScore = calculateHotScore(metrics);
        
        // æ›´æ–°çƒ­é—¨æ’è¡Œæ¦œ
        jedis.zadd("content:hot:ranking", hotScore, contentId);
        
        // åˆ†ç±»æ’è¡Œæ¦œ
        String category = metrics.getCategory();
        jedis.zadd("content:hot:" + category, hotScore, contentId);
        
        // ä¿ç•™å‰1000ä¸ªçƒ­é—¨å†…å®¹
        jedis.zremrangeByRank("content:hot:ranking", 0, -1001);
        jedis.zremrangeByRank("content:hot:" + category, 0, -501);
    }
    
    // è·å–çƒ­é—¨å†…å®¹
    public List<ContentInfo> getHotContent(String category, int pageNo, int pageSize) {
        String key = category.equals("all") ? "content:hot:ranking" : "content:hot:" + category;
        
        int start = (pageNo - 1) * pageSize;
        int end = start + pageSize - 1;
        
        Set<Tuple> hotContent = jedis.zrevrangeWithScores(key, start, end);
        
        List<ContentInfo> result = new ArrayList<>();
        for (Tuple tuple : hotContent) {
            String contentId = tuple.getElement();
            double hotScore = tuple.getScore();
            
            ContentInfo contentInfo = getContentInfo(contentId);
            contentInfo.setHotScore(hotScore);
            
            result.add(contentInfo);
        }
        
        return result;
    }
}
```

### 6.3 å»¶æ—¶æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿ


**è®¢å•è¶…æ—¶å¤„ç†ç¤ºä¾‹**
```java
@Service
public class OrderTimeoutService {
    
    // åˆ›å»ºè®¢å•æ—¶è®¾ç½®è¶…æ—¶ä»»åŠ¡
    public void createOrderWithTimeout(String orderId, int timeoutMinutes) {
        // ä¿å­˜è®¢å•ä¿¡æ¯
        saveOrder(orderId);
        
        // æ·»åŠ è¶…æ—¶æ£€æŸ¥ä»»åŠ¡
        DelayTask timeoutTask = new DelayTask();
        timeoutTask.setTaskId("ORDER_TIMEOUT_" + orderId);
        timeoutTask.setTaskType("ORDER_TIMEOUT");
        timeoutTask.setTaskData(orderId);
        
        delayQueue.addDelayTask(
            timeoutTask.getTaskId(),
            JSON.toJSONString(timeoutTask),
            timeoutMinutes * 60 // è½¬æ¢ä¸ºç§’
        );
        
        System.out.println("è®¢å•åˆ›å»ºæˆåŠŸ: " + orderId + ", è¶…æ—¶æ—¶é—´: " + timeoutMinutes + "åˆ†é’Ÿ");
    }
    
    // ç”¨æˆ·æ”¯ä»˜è®¢å•
    public void payOrder(String orderId) {
        // æ›´æ–°è®¢å•çŠ¶æ€
        updateOrderStatus(orderId, OrderStatus.PAID);
        
        // å–æ¶ˆè¶…æ—¶ä»»åŠ¡
        String taskId = "ORDER_TIMEOUT_" + orderId;
        boolean cancelled = delayQueue.cancelDelayTask(taskId);
        
        if (cancelled) {
            System.out.println("è®¢å•æ”¯ä»˜æˆåŠŸï¼Œå·²å–æ¶ˆè¶…æ—¶ä»»åŠ¡: " + orderId);
        }
    }
    
    // å¤„ç†è¶…æ—¶è®¢å•
    public void handleOrderTimeout(String orderId) {
        Order order = getOrder(orderId);
        
        if (order.getStatus() == OrderStatus.UNPAID) {
            // è®¢å•ç¡®å®è¶…æ—¶æœªæ”¯ä»˜ï¼Œæ‰§è¡Œå–æ¶ˆé€»è¾‘
            updateOrderStatus(orderId, OrderStatus.TIMEOUT_CANCELLED);
            releaseOrderStock(orderId);
            sendTimeoutNotification(orderId);
            
            System.out.println("è®¢å•è¶…æ—¶å·²å–æ¶ˆ: " + orderId);
        } else {
            System.out.println("è®¢å•çŠ¶æ€å·²å˜æ›´ï¼Œæ— éœ€å¤„ç†è¶…æ—¶: " + orderId);
        }
    }
}
```

---

## 7. âš¡ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


### 7.1 ZSetæ€§èƒ½ä¼˜åŒ–è¦ç‚¹


**å†…å­˜ä¼˜åŒ–**
```java
// 1. æ§åˆ¶ZSetå¤§å°ï¼Œé¿å…æ— é™å¢é•¿
public void maintainRankingSize(String key, int maxSize) {
    long currentSize = jedis.zcard(key);
    
    if (currentSize > maxSize) {
        // ç§»é™¤æ’åæœ€ä½çš„å…ƒç´ 
        long removeCount = currentSize - maxSize;
        jedis.zremrangeByRank(key, 0, removeCount - 1);
    }
}

// 2. å®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®
@Scheduled(fixedRate = 3600000) // æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡
public void cleanupExpiredData() {
    long expireTime = System.currentTimeMillis() / 1000 - 86400; // 1å¤©å‰
    
    // æ¸…ç†è¿‡æœŸçš„æ—¶é—´çª—å£æ•°æ®
    for (String metric : getActiveMetrics()) {
        String key = "metrics:minute:" + metric;
        jedis.zremrangeByScore(key, 0, expireTime);
    }
}
```

**æ“ä½œä¼˜åŒ–**
```java
// 3. æ‰¹é‡æ“ä½œå‡å°‘ç½‘ç»œå¾€è¿”
public void batchUpdateRanking(Map<String, Double> updates) {
    Pipeline pipeline = jedis.pipelined();
    
    for (Map.Entry<String, Double> entry : updates.entrySet()) {
        pipeline.zadd(RANKING_KEY, entry.getValue(), entry.getKey());
    }
    
    pipeline.sync(); // æ‰¹é‡æ‰§è¡Œ
}

// 4. ä½¿ç”¨Luaè„šæœ¬ä¿è¯åŸå­æ€§
private final String ATOMIC_UPDATE_SCRIPT = 
    "local key = KEYS[1] " +
    "local member = ARGV[1] " +
    "local increment = tonumber(ARGV[2]) " +
    "local maxSize = tonumber(ARGV[3]) " +
    "redis.call('ZINCRBY', key, increment, member) " +
    "local size = redis.call('ZCARD', key) " +
    "if size > maxSize then " +
    "  redis.call('ZREMRANGEBYRANK', key, 0, size - maxSize - 1) " +
    "end " +
    "return redis.call('ZREVRANK', key, member)";

public Long atomicUpdateRanking(String member, double increment) {
    return (Long) jedis.eval(ATOMIC_UPDATE_SCRIPT, 1, RANKING_KEY, member, 
                           String.valueOf(increment), String.valueOf(MAX_RANKING_SIZE));
}
```

### 7.2 ç›‘æ§å’Œå‘Šè­¦


**æ€§èƒ½ç›‘æ§æŒ‡æ ‡**
```java
@Component
public class ZSetPerformanceMonitor {
    
    @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿç›‘æ§ä¸€æ¬¡
    public void monitorZSetPerformance() {
        Map<String, Long> zsetSizes = new HashMap<>();
        
        // ç›‘æ§ä¸»è¦ZSetçš„å¤§å°
        zsetSizes.put("game:rank:total", jedis.zcard("game:rank:total"));
        zsetSizes.put("delay:queue", jedis.zcard("delay:queue"));
        zsetSizes.put("priority:queue", jedis.zcard("priority:queue"));
        
        // æ£€æŸ¥æ˜¯å¦æœ‰å¼‚å¸¸å¢é•¿
        for (Map.Entry<String, Long> entry : zsetSizes.entrySet()) {
            String key = entry.getKey();
            Long size = entry.getValue();
            
            if (size > getThreshold(key)) {
                sendAlert("ZSetå¼‚å¸¸å¢é•¿: " + key + ", å½“å‰å¤§å°: " + size);
            }
        }
        
        // è®°å½•æ€§èƒ½æŒ‡æ ‡
        recordMetrics(zsetSizes);
    }
    
    // ç›‘æ§æ“ä½œå»¶è¿Ÿ
    public <T> T monitorOperation(String operation, Supplier<T> task) {
        long startTime = System.currentTimeMillis();
        
        try {
            T result = task.get();
            return result;
        } finally {
            long duration = System.currentTimeMillis() - startTime;
            
            if (duration > 100) { // è¶…è¿‡100msè®°å½•æ…¢æ“ä½œ
                System.out.println("æ…¢æ“ä½œå‘Šè­¦: " + operation + ", è€—æ—¶: " + duration + "ms");
            }
            
            // è®°å½•æ“ä½œè€—æ—¶
            recordOperationMetric(operation, duration);
        }
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å››å¤§åº”ç”¨åœºæ™¯ç²¾è¦


```
ğŸ¯ æ’è¡Œæ¦œç³»ç»Ÿï¼š
â€¢ æ ¸å¿ƒï¼šscoreå­˜å‚¨åˆ†æ•°ï¼Œè‡ªåŠ¨æ’åº
â€¢ ç‰¹ç‚¹ï¼šå®æ—¶æ›´æ–°ï¼Œåˆ†é¡µæŸ¥è¯¢ï¼Œå¤šç»´åº¦
â€¢ ä¼˜åŒ–ï¼šæ§åˆ¶å¤§å°ï¼Œæ‰¹é‡æ“ä½œï¼Œå®šæœŸå¿«ç…§

â° å»¶æ—¶é˜Ÿåˆ—ï¼š
â€¢ æ ¸å¿ƒï¼šscoreå­˜å‚¨æ‰§è¡Œæ—¶é—´æˆ³
â€¢ ç‰¹ç‚¹ï¼šåˆ°æœŸè‡ªåŠ¨è§¦å‘ï¼Œæ”¯æŒå–æ¶ˆ
â€¢ ä¼˜åŒ–ï¼šå®šæ—¶æ‰«æï¼Œå¼‚å¸¸å¤„ç†ï¼Œç›‘æ§å‘Šè­¦

ğŸ¯ ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼š
â€¢ æ ¸å¿ƒï¼šscoreå­˜å‚¨ä¼˜å…ˆçº§åˆ†æ•°
â€¢ ç‰¹ç‚¹ï¼šé«˜ä¼˜å…ˆçº§å…ˆå¤„ç†ï¼ŒåŠ¨æ€è°ƒæ•´
â€¢ ä¼˜åŒ–ï¼šè´Ÿè½½å‡è¡¡ï¼Œæ‰¹é‡å¤„ç†ï¼Œæƒé‡åˆ†é…

ğŸ“ˆ æ—¶é—´çª—å£ç»Ÿè®¡ï¼š
â€¢ æ ¸å¿ƒï¼šscoreå­˜å‚¨æ—¶é—´æˆ³ï¼Œæ»‘åŠ¨è®¡ç®—
â€¢ ç‰¹ç‚¹ï¼šå®æ—¶ç»Ÿè®¡ï¼Œè¶‹åŠ¿åˆ†æï¼Œå¤šç²’åº¦
â€¢ ä¼˜åŒ–ï¼šå®šæœŸæ¸…ç†ï¼Œåˆ†æ®µç»Ÿè®¡ï¼Œç¼“å­˜ç»“æœ
```

### 8.2 è®¾è®¡åŸåˆ™å’Œæœ€ä½³å®è·µ


**ğŸ”¸ é€‰æ‹©åˆé€‚çš„scoreå€¼**
```
æ’è¡Œæ¦œï¼šç”¨æˆ·åˆ†æ•°ã€é”€é‡ç­‰ä¸šåŠ¡æ•°å€¼
å»¶æ—¶é˜Ÿåˆ—ï¼šæ‰§è¡Œæ—¶é—´çš„æ—¶é—´æˆ³
ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼šä¼˜å…ˆçº§åˆ†æ•°ï¼ˆæ•°å€¼è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ï¼‰
æ—¶é—´ç»Ÿè®¡ï¼šäº‹ä»¶å‘ç”Ÿçš„æ—¶é—´æˆ³
```

**ğŸ”¸ å†…å­˜ç®¡ç†ç­–ç•¥**
```
å¤§å°é™åˆ¶ï¼šZREMRANGEBYRANKæ§åˆ¶ZSetæœ€å¤§å…ƒç´ æ•°
è¿‡æœŸæ¸…ç†ï¼šZREMRANGEBYSCOREæ¸…ç†è¿‡æœŸæ—¶é—´æ•°æ®
æ‰¹é‡æ“ä½œï¼šPipelineå‡å°‘ç½‘ç»œå¼€é”€
åŸå­æ“ä½œï¼šLuaè„šæœ¬ä¿è¯æ•°æ®ä¸€è‡´æ€§
```

**ğŸ”¸ æ€§èƒ½ä¼˜åŒ–è¦ç‚¹**
```
åˆç†è®¾ç½®ZSetå¤§å°ä¸Šé™
å®šæœŸæ¸…ç†è¿‡æœŸå’Œæ— ç”¨æ•°æ®
ä½¿ç”¨æ‰¹é‡æ“ä½œå‡å°‘ç½‘ç»œå¾€è¿”  
ç›‘æ§ZSetå¤§å°å’Œæ“ä½œå»¶è¿Ÿ
è€ƒè™‘æ•°æ®åˆ†ç‰‡ï¼Œé¿å…å•ä¸ªZSetè¿‡å¤§
```

### 8.3 å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ


**â“ å¸¸è§é—®é¢˜**
```
é—®é¢˜1ï¼šZSetå†…å­˜å ç”¨è¿‡å¤§
è§£å†³ï¼šè®¾ç½®æœ€å¤§å…ƒç´ æ•°ï¼Œå®šæœŸæ¸…ç†

é—®é¢˜2ï¼šå»¶æ—¶é˜Ÿåˆ—ä»»åŠ¡å †ç§¯
è§£å†³ï¼šå¢åŠ æ¶ˆè´¹è€…ï¼Œä¼˜åŒ–å¤„ç†é€»è¾‘

é—®é¢˜3ï¼šæ’è¡Œæ¦œæ›´æ–°é¢‘ç¹å½±å“æ€§èƒ½
è§£å†³ï¼šæ‰¹é‡æ›´æ–°ï¼Œå¼‚æ­¥å¤„ç†

é—®é¢˜4ï¼šæ—¶é—´çª—å£æ•°æ®å¢é•¿è¿‡å¿«
è§£å†³ï¼šåˆç†è®¾ç½®çª—å£å¤§å°ï¼ŒåŠæ—¶æ¸…ç†è¿‡æœŸæ•°æ®
```

**âœ… æœ€ä½³å®è·µå»ºè®®**
```
è®¾è®¡é˜¶æ®µï¼šæ˜ç¡®scoreçš„å«ä¹‰å’Œå–å€¼èŒƒå›´
å®ç°é˜¶æ®µï¼šè€ƒè™‘è¾¹ç•Œæƒ…å†µå’Œå¼‚å¸¸å¤„ç†
è¿ç»´é˜¶æ®µï¼šç›‘æ§æ€§èƒ½æŒ‡æ ‡ï¼ŒåŠæ—¶ä¼˜åŒ–
æ‰©å±•é˜¶æ®µï¼šè€ƒè™‘æ•°æ®åˆ†ç‰‡å’Œé›†ç¾¤éƒ¨ç½²
```

### 8.4 å­¦ä¹ å»ºè®®


**ğŸ“š æŒæ¡è·¯å¾„**
```
1. ç†è§£ZSetåŸºæœ¬ç‰¹æ€§ï¼šæœ‰åºã€ä¸é‡å¤ã€scoreæ’åº
2. æŒæ¡å››å¤§åº”ç”¨åœºæ™¯çš„è®¾è®¡æ€è·¯
3. å®è·µå…·ä½“ä¸šåŠ¡åœºæ™¯çš„å®ç°
4. å­¦ä¹ æ€§èƒ½ä¼˜åŒ–å’Œç›‘æ§æ–¹æ³•
5. äº†è§£å¤§è§„æ¨¡åº”ç”¨çš„æ¶æ„è®¾è®¡
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- ZSetçš„ç²¾é«“åœ¨äºscoreçš„å·§å¦™è¿ç”¨
- æ’è¡Œæ¦œç”¨ä¸šåŠ¡åˆ†æ•°ï¼Œå»¶æ—¶é˜Ÿåˆ—ç”¨æ—¶é—´æˆ³
- ä¼˜å…ˆçº§é˜Ÿåˆ—ç”¨ä¼˜å…ˆçº§ï¼Œæ—¶é—´ç»Ÿè®¡ç”¨æ—¶é—´æˆ³
- æ€§èƒ½ä¼˜åŒ–é‡ç‚¹æ˜¯æ§åˆ¶å¤§å°å’Œæ‰¹é‡æ“ä½œ
- ç›‘æ§å‘Šè­¦æ˜¯ç”Ÿäº§ç¯å¢ƒçš„å¿…å¤‡ä¿éšœ