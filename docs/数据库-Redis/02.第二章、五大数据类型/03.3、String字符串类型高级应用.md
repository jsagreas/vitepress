---
title: 3ã€Stringå­—ç¬¦ä¸²ç±»å‹é«˜çº§åº”ç”¨
---
## ğŸ“š ç›®å½•

1. [åˆ†å¸ƒå¼é”åŸºç¡€](#1-åˆ†å¸ƒå¼é”åŸºç¡€)
2. [ç¼“å­˜åº”ç”¨æ¨¡å¼](#2-ç¼“å­˜åº”ç”¨æ¨¡å¼)
3. [é«˜çº§è®¡æ•°åº”ç”¨](#3-é«˜çº§è®¡æ•°åº”ç”¨)
4. [å®æˆ˜æ¡ˆä¾‹è¯¦è§£](#4-å®æˆ˜æ¡ˆä¾‹è¯¦è§£)
5. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#5-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” åˆ†å¸ƒå¼é”åŸºç¡€


### 1.1 ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼é”


**ğŸ¤” ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”ï¼Ÿ**

åœ¨å•æœºç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨synchronizedæˆ–Lockæ¥ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚ä½†åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¤šä¸ªæœåŠ¡å™¨ä¸Šçš„ç¨‹åºåŒæ—¶æ“ä½œåŒä¸€ä¸ªèµ„æºæ—¶ï¼Œæ™®é€šé”å°±ä¸ç®¡ç”¨äº†ã€‚

```
å•æœºæƒ…å†µï¼š
æœåŠ¡å™¨A: çº¿ç¨‹1ã€çº¿ç¨‹2 -> ç”¨synchronizedæ§åˆ¶

åˆ†å¸ƒå¼æƒ…å†µï¼š
æœåŠ¡å™¨A: çº¿ç¨‹1
æœåŠ¡å™¨B: çº¿ç¨‹2    -> synchronizedæ— æ³•è·¨æœåŠ¡å™¨æ§åˆ¶
æœåŠ¡å™¨C: çº¿ç¨‹3
```

> ğŸ’¡ **é€šä¿—ç†è§£**ï¼šåˆ†å¸ƒå¼é”å°±åƒå…¬å…±å•æ‰€çš„é—¨é”ï¼Œä¸ç®¡ä½ ä»å“ªä¸ªæ¥¼å±‚æ¥ï¼Œéƒ½è¦æ’é˜Ÿï¼Œä¸€æ¬¡åªèƒ½ä¸€ä¸ªäººè¿›å»ã€‚

### 1.2 Rediså®ç°åˆ†å¸ƒå¼é”çš„æ ¸å¿ƒå‘½ä»¤


**ğŸ¯ SETå‘½ä»¤çš„å¼ºå¤§å‚æ•°**

```bash
SET key value PX milliseconds NX
```

**å‚æ•°è¯¦è§£ï¼š**
- `key`: é”çš„åç§°ï¼ˆæ¯”å¦‚"order_lock"ï¼‰
- `value`: é”çš„å”¯ä¸€æ ‡è¯†ï¼ˆé€šå¸¸æ˜¯UUIDï¼‰
- `PX milliseconds`: é”çš„è¿‡æœŸæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
- `NX`: åªæœ‰å½“keyä¸å­˜åœ¨æ—¶æ‰è®¾ç½®æˆåŠŸ

> âš ï¸ **ä¸ºä»€ä¹ˆè¦ç”¨PXå’ŒNXï¼Ÿ**
> - **NX**ï¼šç¡®ä¿åªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯èƒ½è·å–é”
> - **PX**ï¼šé˜²æ­¢ç¨‹åºå´©æºƒåé”æ°¸è¿œä¸é‡Šæ”¾

### 1.3 åˆ†å¸ƒå¼é”çš„å®ç°æµç¨‹


**ğŸ”„ å®Œæ•´çš„åŠ é”è§£é”æµç¨‹**

```
å®¢æˆ·ç«¯A                    RedisæœåŠ¡å™¨                å®¢æˆ·ç«¯B
   |                          |                        |
   |--[1]SET lock uuid PX 5000 NX-->|                  |
   |<-----[2]OK-----------------|                      |
   |                          |                        |
   |  æ‰§è¡Œä¸šåŠ¡é€»è¾‘              |                        |
   |                          |                        |
   |                          |<--[3]SET lock uuid2 NX---|
   |                          |-----[4]nil------------>|
   |                          |                        |
   |--[5]DEL lock æ£€æŸ¥uuid---->|                       |
   |<-----[6]1-----------------|                       |
   |                          |                        |
```

**ğŸ”§ Javaä»£ç å®ç°ç¤ºä¾‹**

```java
public class RedisDistributedLock {
    private Jedis jedis;
    
    // è·å–é”
    public boolean tryLock(String lockKey, String requestId, int expireTime) {
        // SET lock_key unique_value PX expire_time NX
        String result = jedis.set(lockKey, requestId, "PX", expireTime, "NX");
        return "OK".equals(result);
    }
    
    // é‡Šæ”¾é”ï¼ˆä½¿ç”¨Luaè„šæœ¬ä¿è¯åŸå­æ€§ï¼‰
    public boolean releaseLock(String lockKey, String requestId) {
        String script = "if redis.call('get', KEYS[1]) == ARGV[1] then " +
                       "return redis.call('del', KEYS[1]) else return 0 end";
        Object result = jedis.eval(script, Arrays.asList(lockKey), Arrays.asList(requestId));
        return "1".equals(result.toString());
    }
}
```

### 1.4 é”çš„å…³é”®è®¾è®¡è¦ç‚¹


**ğŸ¯ é”å”¯ä¸€æ ‡è¯†çš„é‡è¦æ€§**

```java
// âŒ é”™è¯¯åšæ³•ï¼šæ‰€æœ‰å®¢æˆ·ç«¯ä½¿ç”¨ç›¸åŒæ ‡è¯†
String lockValue = "locked";

// âœ… æ­£ç¡®åšæ³•ï¼šæ¯ä¸ªå®¢æˆ·ç«¯ä½¿ç”¨å”¯ä¸€æ ‡è¯†
String lockValue = UUID.randomUUID().toString();
```

> ğŸ’¡ **ä¸ºä»€ä¹ˆè¦å”¯ä¸€æ ‡è¯†ï¼Ÿ**
> é˜²æ­¢å®¢æˆ·ç«¯Aé‡Šæ”¾äº†å®¢æˆ·ç«¯Bçš„é”ã€‚æ¯”å¦‚Aè·å–é”åè¶…æ—¶ï¼Œé”è‡ªåŠ¨é‡Šæ”¾ï¼ŒBè·å–é”ï¼Œè¿™æ—¶Aé†’æ¥ä¸èƒ½é‡Šæ”¾Bçš„é”ã€‚

**â° è¶…æ—¶æœºåˆ¶çš„è®¾è®¡åŸåˆ™**

```java
// ä¸šåŠ¡æ‰§è¡Œæ—¶é—´è¯„ä¼°
int businessTime = 3000;  // ä¸šåŠ¡é¢„è®¡3ç§’
int lockTimeout = businessTime * 2;  // é”è¶…æ—¶è®¾ç½®ä¸º6ç§’

// ç»™ä¸šåŠ¡ç•™è¶³å¤Ÿçš„æ‰§è¡Œæ—¶é—´
if (tryLock("order_process", uuid, lockTimeout)) {
    try {
        // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
        processOrder();
    } finally {
        releaseLock("order_process", uuid);
    }
}
```

---

## 2. ğŸ“¦ ç¼“å­˜åº”ç”¨æ¨¡å¼


### 2.1 å¯¹è±¡åºåˆ—åŒ–ç¼“å­˜


**ğŸ¯ ä»€ä¹ˆæ—¶å€™éœ€è¦ç¼“å­˜å¯¹è±¡ï¼Ÿ**

å½“æˆ‘ä»¬éœ€è¦é¢‘ç¹æŸ¥è¯¢æ•°æ®åº“ä¸­çš„å¤æ‚å¯¹è±¡æ—¶ï¼Œæ¯”å¦‚ç”¨æˆ·ä¿¡æ¯ã€å•†å“è¯¦æƒ…ç­‰ï¼Œæ¯æ¬¡éƒ½æŸ¥æ•°æ®åº“ä¼šå¾ˆæ…¢ã€‚

**ğŸ“„ JSONåºåˆ—åŒ–æ–¹å¼ï¼ˆæ¨èï¼‰**

```java
// å­˜å‚¨ç”¨æˆ·å¯¹è±¡
public void cacheUser(User user) {
    String userJson = JSON.toJSONString(user);
    jedis.setex("user:" + user.getId(), 3600, userJson);
}

// è·å–ç”¨æˆ·å¯¹è±¡  
public User getUser(Long userId) {
    String userJson = jedis.get("user:" + userId);
    if (userJson != null) {
        return JSON.parseObject(userJson, User.class);
    }
    // ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“
    User user = userService.getById(userId);
    if (user != null) {
        cacheUser(user);  // æŸ¥åˆ°åæ”¾å…¥ç¼“å­˜
    }
    return user;
}
```

> ğŸ’¡ **ä¸ºä»€ä¹ˆé€‰æ‹©JSONï¼Ÿ**
> - å¯è¯»æ€§å¥½ï¼Œè°ƒè¯•æ–¹ä¾¿
> - è·¨è¯­è¨€æ”¯æŒ
> - å ç”¨ç©ºé—´é€‚ä¸­

**ğŸ”„ ç¼“å­˜æ›´æ–°ç­–ç•¥å¯¹æ¯”**

| ç­–ç•¥ç±»å‹ | **æ›´æ–°æ—¶æœº** | **æ•°æ®ä¸€è‡´æ€§** | **é€‚ç”¨åœºæ™¯** |
|---------|------------|-------------|-------------|
| **Cache Aside** | `å…ˆæ›´æ–°DBï¼Œå†åˆ ç¼“å­˜` | `æœ€ç»ˆä¸€è‡´` | `è¯»å¤šå†™å°‘` |
| **Write Through** | `åŒæ—¶æ›´æ–°DBå’Œç¼“å­˜` | `å¼ºä¸€è‡´` | `å†™æ“ä½œé¢‘ç¹` |
| **Write Back** | `å…ˆæ›´æ–°ç¼“å­˜ï¼Œå®šæ—¶å†™DB` | `æœ€ç»ˆä¸€è‡´` | `å†™æ“ä½œå¯†é›†` |

### 2.2 ç¼“å­˜ç©¿é€é˜²æŠ¤


**ğŸš« ä»€ä¹ˆæ˜¯ç¼“å­˜ç©¿é€ï¼Ÿ**

```
æ­£å¸¸æƒ…å†µï¼š
ç”¨æˆ·è¯·æ±‚ -> ç¼“å­˜å‘½ä¸­ -> è¿”å›æ•°æ®

ç¼“å­˜ç©¿é€ï¼š
ç”¨æˆ·è¯·æ±‚ -> ç¼“å­˜æœªå‘½ä¸­ -> æ•°æ®åº“ä¹Ÿæ²¡æœ‰ -> æ¯æ¬¡éƒ½è¦æŸ¥æ•°æ®åº“
```

**ğŸ›¡ï¸ ç©ºå€¼ç¼“å­˜é˜²æŠ¤**

```java
public User getUserSafe(Long userId) {
    String cacheKey = "user:" + userId;
    String userJson = jedis.get(cacheKey);
    
    if ("null".equals(userJson)) {
        return null;  // æ˜ç¡®çŸ¥é“ç”¨æˆ·ä¸å­˜åœ¨
    }
    
    if (userJson != null) {
        return JSON.parseObject(userJson, User.class);
    }
    
    // æŸ¥è¯¢æ•°æ®åº“
    User user = userService.getById(userId);
    if (user != null) {
        jedis.setex(cacheKey, 3600, JSON.toJSONString(user));
    } else {
        // ç¼“å­˜ç©ºå€¼ï¼Œé˜²æ­¢ç©¿é€
        jedis.setex(cacheKey, 300, "null");  // 5åˆ†é’Ÿè¿‡æœŸ
    }
    return user;
}
```

### 2.3 çƒ­ç‚¹æ•°æ®ç¼“å­˜ç­–ç•¥


**ğŸ”¥ çƒ­ç‚¹æ•°æ®è¯†åˆ«ä¸å¤„ç†**

```java
// çƒ­ç‚¹æ•°æ®ç¼“å­˜ç®¡ç†
public class HotDataCache {
    
    // å»¶é•¿çƒ­ç‚¹æ•°æ®ç¼“å­˜æ—¶é—´
    public void cacheHotData(String key, Object data, boolean isHot) {
        String json = JSON.toJSONString(data);
        int expireTime = isHot ? 7200 : 3600;  // çƒ­ç‚¹æ•°æ®ç¼“å­˜2å°æ—¶
        jedis.setex(key, expireTime, json);
    }
    
    // é¢„çƒ­çƒ­ç‚¹æ•°æ®
    public void preloadHotData() {
        // æå‰åŠ è½½ä»Šæ—¥çƒ­é—¨å•†å“
        List<Product> hotProducts = productService.getTodayHotProducts();
        for (Product product : hotProducts) {
            String key = "product:" + product.getId();
            cacheHotData(key, product, true);
        }
    }
}
```

---

## 3. ğŸ”¢ é«˜çº§è®¡æ•°åº”ç”¨


### 3.1 å…¨å±€IDç”Ÿæˆå™¨


**ğŸ¯ ä¸ºä»€ä¹ˆéœ€è¦å…¨å±€IDï¼Ÿ**

åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¤šä¸ªæœåŠ¡å™¨ä¸èƒ½ä½¿ç”¨æ•°æ®åº“çš„è‡ªå¢IDï¼Œå› ä¸ºä¼šé‡å¤ã€‚Redisçš„åŸå­æ€§æ“ä½œå¯ä»¥ç”Ÿæˆå…¨å±€å”¯ä¸€IDã€‚

**âš¡ INCRå®ç°å…¨å±€ID**

```java
public class GlobalIdGenerator {
    
    // ç”Ÿæˆè®¢å•ID
    public Long generateOrderId() {
        String key = "order:id:" + LocalDate.now().format(DateTimeFormatter.ofPattern("yyyyMMdd"));
        Long id = jedis.incr(key);
        
        // è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆç¬¬äºŒå¤©è¿‡æœŸï¼‰
        if (id == 1) {
            jedis.expire(key, 86400);
        }
        
        // ç»„åˆæœ€ç»ˆIDï¼šæ—¥æœŸ + åºå·
        String dateStr = LocalDate.now().format(DateTimeFormatter.ofPattern("yyyyMMdd"));
        return Long.parseLong(dateStr + String.format("%06d", id));
    }
}
```

**ç”Ÿæˆçš„IDæ ¼å¼**ï¼š
```
2024012200001  (2024å¹´1æœˆ22æ—¥ç¬¬1ä¸ªè®¢å•)
2024012200002  (2024å¹´1æœˆ22æ—¥ç¬¬2ä¸ªè®¢å•)
2024012300001  (2024å¹´1æœˆ23æ—¥ç¬¬1ä¸ªè®¢å•ï¼Œé‡æ–°è®¡æ•°)
```

### 3.2 æ¥å£é™æµè®¡æ•°


**ğŸš¦ æ»‘åŠ¨çª—å£é™æµç®—æ³•**

```java
public class RateLimiter {
    
    // é™åˆ¶æ¯ä¸ªç”¨æˆ·æ¯åˆ†é’Ÿæœ€å¤šè°ƒç”¨100æ¬¡API
    public boolean isAllowed(String userId, String apiPath) {
        String key = "rate_limit:" + userId + ":" + apiPath;
        String currentMinute = String.valueOf(System.currentTimeMillis() / 60000);
        String limitKey = key + ":" + currentMinute;
        
        Long count = jedis.incr(limitKey);
        
        if (count == 1) {
            jedis.expire(limitKey, 60); // 1åˆ†é’Ÿè¿‡æœŸ
        }
        
        return count <= 100;  // æ¯åˆ†é’Ÿæœ€å¤š100æ¬¡
    }
}
```

**ğŸ›ï¸ ä»¤ç‰Œæ¡¶é™æµ**

```java
// åŸºäºRediså®ç°ä»¤ç‰Œæ¡¶
public boolean acquireToken(String bucketKey, int capacity, int refillRate) {
    String script = 
        "local bucket = redis.call('HMGET', KEYS[1], 'tokens', 'lastRefill') " +
        "local now = tonumber(ARGV[1]) " +
        "local capacity = tonumber(ARGV[2]) " +
        "local rate = tonumber(ARGV[3]) " +
        // ... Luaè„šæœ¬å®ç°ä»¤ç‰Œæ¡¶é€»è¾‘
        "return 1";  // ç®€åŒ–ç‰ˆæœ¬
        
    Object result = jedis.eval(script, Arrays.asList(bucketKey), 
                              Arrays.asList(String.valueOf(System.currentTimeMillis()),
                                          String.valueOf(capacity),
                                          String.valueOf(refillRate)));
    return "1".equals(result.toString());
}
```

### 3.3 ä¸šåŠ¡ç»Ÿè®¡è®¡æ•°


**ğŸ“Š å®æ—¶ç»Ÿè®¡åº”ç”¨**

```java
public class BusinessStats {
    
    // é¡µé¢è®¿é—®ç»Ÿè®¡
    public void recordPageView(String page) {
        String today = LocalDate.now().format(DateTimeFormatter.ofPattern("yyyyMMdd"));
        jedis.incr("pv:" + page + ":" + today);
    }
    
    // ç”¨æˆ·æ´»è·ƒç»Ÿè®¡
    public void recordUserActive(Long userId) {
        String today = LocalDate.now().format(DateTimeFormatter.ofPattern("yyyyMMdd"));
        jedis.sadd("active_users:" + today, userId.toString());
    }
    
    // è·å–ä»Šæ—¥æ•°æ®
    public Map<String, Object> getTodayStats() {
        String today = LocalDate.now().format(DateTimeFormatter.ofPattern("yyyyMMdd"));
        Map<String, Object> stats = new HashMap<>();
        
        stats.put("pageViews", jedis.get("pv:homepage:" + today));
        stats.put("activeUsers", jedis.scard("active_users:" + today));
        
        return stats;
    }
}
```

---

## 4. ğŸ¯ å®æˆ˜æ¡ˆä¾‹è¯¦è§£


### 4.1 å•†å“è¯¦æƒ…é¡µç¼“å­˜å®ç°


**ğŸ›ï¸ å®Œæ•´çš„å•†å“ç¼“å­˜æ–¹æ¡ˆ**

```java
@Service
public class ProductCacheService {
    
    // å¤šå±‚ç¼“å­˜ç­–ç•¥
    public Product getProductDetail(Long productId) {
        String cacheKey = "product:detail:" + productId;
        
        // L1ç¼“å­˜ï¼šåŸºç¡€ä¿¡æ¯ï¼ˆé•¿æœŸç¼“å­˜ï¼‰
        String basicInfo = jedis.get(cacheKey + ":basic");
        // L2ç¼“å­˜ï¼šåº“å­˜ä»·æ ¼ï¼ˆçŸ­æœŸç¼“å­˜ï¼‰
        String dynamicInfo = jedis.get(cacheKey + ":dynamic");
        
        if (basicInfo != null && dynamicInfo != null) {
            Product product = JSON.parseObject(basicInfo, Product.class);
            ProductDynamic dynamic = JSON.parseObject(dynamicInfo, ProductDynamic.class);
            product.setStock(dynamic.getStock());
            product.setPrice(dynamic.getPrice());
            return product;
        }
        
        // ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“
        Product product = productService.getById(productId);
        if (product != null) {
            cacheProduct(product);
        }
        return product;
    }
    
    private void cacheProduct(Product product) {
        String basicKey = "product:detail:" + product.getId() + ":basic";
        String dynamicKey = "product:detail:" + product.getId() + ":dynamic";
        
        // åŸºç¡€ä¿¡æ¯ç¼“å­˜1å¤©
        jedis.setex(basicKey, 86400, JSON.toJSONString(product));
        
        // åŠ¨æ€ä¿¡æ¯ç¼“å­˜10åˆ†é’Ÿ
        ProductDynamic dynamic = new ProductDynamic(product.getStock(), product.getPrice());
        jedis.setex(dynamicKey, 600, JSON.toJSONString(dynamic));
    }
}
```

### 4.2 ç”¨æˆ·è®¿é—®è®¡æ•°å™¨


**ğŸ‘¥ UV/PVç»Ÿè®¡å®ç°**

```java
public class VisitCounter {
    
    // è®°å½•é¡µé¢è®¿é—®
    public void recordVisit(String page, String userId, String sessionId) {
        String today = LocalDate.now().format(DateTimeFormatter.ofPattern("yyyyMMdd"));
        
        // PVè®¡æ•°ï¼ˆé¡µé¢æµè§ˆé‡ï¼‰
        jedis.incr("pv:" + page + ":" + today);
        
        // UVè®¡æ•°ï¼ˆç‹¬ç«‹è®¿å®¢ï¼‰- ä½¿ç”¨Setå»é‡
        jedis.sadd("uv:" + page + ":" + today, userId);
        
        // IPè®¡æ•°ï¼ˆç‹¬ç«‹IPï¼‰
        String clientIp = getClientIp();
        jedis.sadd("ip:" + page + ":" + today, clientIp);
        
        // è®¾ç½®è¿‡æœŸæ—¶é—´
        jedis.expire("pv:" + page + ":" + today, 86400 * 7); // ä¿ç•™7å¤©
        jedis.expire("uv:" + page + ":" + today, 86400 * 7);
        jedis.expire("ip:" + page + ":" + today, 86400 * 7);
    }
    
    // è·å–è®¿é—®ç»Ÿè®¡
    public Map<String, Long> getVisitStats(String page, String date) {
        Map<String, Long> stats = new HashMap<>();
        stats.put("pv", jedis.get("pv:" + page + ":" + date));
        stats.put("uv", jedis.scard("uv:" + page + ":" + date));
        stats.put("ip", jedis.scard("ip:" + page + ":" + date));
        return stats;
    }
}
```

### 4.3 APIè°ƒç”¨é™æµ


**ğŸ” å¤šç»´åº¦é™æµæ§åˆ¶**

```java
@Component
public class ApiRateLimiter {
    
    // ç”¨æˆ·çº§åˆ«é™æµ
    public boolean checkUserLimit(String userId, String api) {
        return checkLimit("user:" + userId + ":" + api, 1000, 3600); // æ¯å°æ—¶1000æ¬¡
    }
    
    // IPçº§åˆ«é™æµ
    public boolean checkIpLimit(String ip, String api) {
        return checkLimit("ip:" + ip + ":" + api, 10000, 3600); // æ¯å°æ—¶10000æ¬¡
    }
    
    // é€šç”¨é™æµæ£€æŸ¥
    private boolean checkLimit(String key, int limit, int window) {
        String currentWindow = String.valueOf(System.currentTimeMillis() / (window * 1000));
        String limitKey = "rate_limit:" + key + ":" + currentWindow;
        
        Long count = jedis.incr(limitKey);
        if (count == 1) {
            jedis.expire(limitKey, window);
        }
        
        return count <= limit;
    }
    
    // åŠ¨æ€é™æµï¼ˆæ ¹æ®ç³»ç»Ÿè´Ÿè½½è°ƒæ•´ï¼‰
    public boolean smartRateLimit(String key, String api) {
        double systemLoad = getSystemLoad();
        int dynamicLimit = (int)(1000 * (1.0 - systemLoad)); // è´Ÿè½½è¶Šé«˜é™æµè¶Šä¸¥
        
        return checkLimit(key, dynamicLimit, 60);
    }
}
```

### 4.4 éªŒè¯ç å­˜å‚¨ç®¡ç†


**ğŸ“± éªŒè¯ç å®Œæ•´æµç¨‹**

```java
@Service
public class CaptchaService {
    
    // ç”Ÿæˆå¹¶å­˜å‚¨éªŒè¯ç 
    public String generateCaptcha(String phone) {
        // æ£€æŸ¥å‘é€é¢‘ç‡é™åˆ¶
        String rateKey = "captcha:rate:" + phone;
        if (jedis.exists(rateKey)) {
            throw new RuntimeException("éªŒè¯ç å‘é€å¤ªé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•");
        }
        
        // ç”Ÿæˆ6ä½æ•°å­—éªŒè¯ç 
        String code = String.format("%06d", new Random().nextInt(999999));
        String cacheKey = "captcha:" + phone;
        
        // å­˜å‚¨éªŒè¯ç ï¼Œ5åˆ†é’Ÿè¿‡æœŸ
        jedis.setex(cacheKey, 300, code);
        
        // è®¾ç½®å‘é€é¢‘ç‡é™åˆ¶ï¼Œ60ç§’å†…ä¸èƒ½é‡å¤å‘é€
        jedis.setex(rateKey, 60, "1");
        
        // å‘é€çŸ­ä¿¡
        sendSms(phone, code);
        
        return "éªŒè¯ç å·²å‘é€";
    }
    
    // éªŒè¯ç æ ¡éªŒ
    public boolean verifyCaptcha(String phone, String inputCode) {
        String cacheKey = "captcha:" + phone;
        String storedCode = jedis.get(cacheKey);
        
        if (storedCode == null) {
            return false; // éªŒè¯ç è¿‡æœŸæˆ–ä¸å­˜åœ¨
        }
        
        boolean valid = storedCode.equals(inputCode);
        if (valid) {
            jedis.del(cacheKey); // éªŒè¯æˆåŠŸåç«‹å³åˆ é™¤
        }
        
        return valid;
    }
}
```

### 4.5 Session Tokenå­˜å‚¨


**ğŸ« åˆ†å¸ƒå¼Sessionç®¡ç†**

```java
@Service 
public class SessionManager {
    
    // åˆ›å»ºç”¨æˆ·ä¼šè¯
    public String createSession(Long userId) {
        String sessionId = UUID.randomUUID().toString();
        String sessionKey = "session:" + sessionId;
        
        // ä¼šè¯ä¿¡æ¯
        Map<String, String> sessionData = new HashMap<>();
        sessionData.put("userId", userId.toString());
        sessionData.put("loginTime", String.valueOf(System.currentTimeMillis()));
        sessionData.put("lastActive", String.valueOf(System.currentTimeMillis()));
        
        // å­˜å‚¨ä¼šè¯ï¼Œ30åˆ†é’Ÿè¿‡æœŸ
        jedis.hmset(sessionKey, sessionData);
        jedis.expire(sessionKey, 1800);
        
        // ç»´æŠ¤ç”¨æˆ·çš„æ´»è·ƒä¼šè¯åˆ—è¡¨
        jedis.sadd("user:sessions:" + userId, sessionId);
        jedis.expire("user:sessions:" + userId, 1800);
        
        return sessionId;
    }
    
    // éªŒè¯ä¼šè¯
    public Long validateSession(String sessionId) {
        String sessionKey = "session:" + sessionId;
        Map<String, String> sessionData = jedis.hgetAll(sessionKey);
        
        if (sessionData.isEmpty()) {
            return null; // ä¼šè¯ä¸å­˜åœ¨æˆ–å·²è¿‡æœŸ
        }
        
        // æ›´æ–°æœ€åæ´»è·ƒæ—¶é—´
        jedis.hset(sessionKey, "lastActive", String.valueOf(System.currentTimeMillis()));
        jedis.expire(sessionKey, 1800); // å»¶é•¿è¿‡æœŸæ—¶é—´
        
        return Long.parseLong(sessionData.get("userId"));
    }
    
    // ç™»å‡ºï¼ˆæ¸…é™¤ä¼šè¯ï¼‰
    public void destroySession(String sessionId) {
        String sessionKey = "session:" + sessionId;
        Map<String, String> sessionData = jedis.hgetAll(sessionKey);
        
        if (!sessionData.isEmpty()) {
            String userId = sessionData.get("userId");
            jedis.srem("user:sessions:" + userId, sessionId);
        }
        
        jedis.del(sessionKey);
    }
}
```

---

## 5. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 5.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ åˆ†å¸ƒå¼é”ï¼šè§£å†³åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„å¹¶å‘æ§åˆ¶é—®é¢˜
ğŸ”¸ ç¼“å­˜æ¨¡å¼ï¼šæå‡æ•°æ®è®¿é—®é€Ÿåº¦ï¼Œå‡å°‘æ•°æ®åº“å‹åŠ›  
ğŸ”¸ è®¡æ•°åº”ç”¨ï¼šå…¨å±€IDç”Ÿæˆã€é™æµæ§åˆ¶ã€ç»Ÿè®¡åˆ†æ
ğŸ”¸ åŸå­æ“ä½œï¼šINCRã€SET NX PXç­‰ä¿è¯æ“ä½œåŸå­æ€§
ğŸ”¸ è¿‡æœŸç­–ç•¥ï¼šåˆç†è®¾ç½®TTLé˜²æ­¢å†…å­˜æ³„æ¼
```

### 5.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ åˆ†å¸ƒå¼é”çš„æœ¬è´¨**
```
æ ¸å¿ƒæ€æƒ³ï¼š
- åˆ©ç”¨Rediså•çº¿ç¨‹ç‰¹æ€§ä¿è¯æ“ä½œåŸå­æ€§
- é€šè¿‡NXå‚æ•°å®ç°"åªæœ‰ä¸€ä¸ªèƒ½æˆåŠŸ"
- é€šè¿‡PXå‚æ•°é˜²æ­¢æ­»é”
- é€šè¿‡å”¯ä¸€æ ‡è¯†é˜²æ­¢è¯¯é‡Šæ”¾
```

**ğŸ”¹ ç¼“å­˜è®¾è®¡çš„æƒè¡¡**
```
ä¸€è‡´æ€§ vs æ€§èƒ½ï¼š
- å¼ºä¸€è‡´æ€§ï¼šåŒæ­¥æ›´æ–°ï¼Œæ€§èƒ½è¾ƒä½
- æœ€ç»ˆä¸€è‡´æ€§ï¼šå¼‚æ­¥æ›´æ–°ï¼Œæ€§èƒ½è¾ƒé«˜
- æ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰æ‹©åˆé€‚çš„ç­–ç•¥
```

**ğŸ”¹ è®¡æ•°åº”ç”¨çš„ç²¾é«“**
```
åŸå­æ€§ä¿è¯ï¼š
- INCRå‘½ä»¤å¤©ç„¶åŸå­æ€§
- é¿å…å¹¶å‘é—®é¢˜
- æ€§èƒ½è¿œè¶…æ•°æ®åº“è®¡æ•°
```

### 5.3 å®é™…åº”ç”¨å»ºè®®


**âœ… æœ€ä½³å®è·µ**
- åˆ†å¸ƒå¼é”å¿…é¡»è®¾ç½®è¿‡æœŸæ—¶é—´
- ç¼“å­˜keyè¦æœ‰ç»Ÿä¸€çš„å‘½åè§„èŒƒ  
- é‡è¦æ“ä½œä½¿ç”¨Luaè„šæœ¬ä¿è¯åŸå­æ€§
- ç›‘æ§Rediså†…å­˜ä½¿ç”¨æƒ…å†µ
- åˆç†è®¾ç½®å„ç§TTLæ—¶é—´

**âŒ å¸¸è§é™·é˜±**
- å¿˜è®°è®¾ç½®é”çš„è¿‡æœŸæ—¶é—´å¯¼è‡´æ­»é”
- ç¼“å­˜é›ªå´©ï¼šå¤§é‡ç¼“å­˜åŒæ—¶è¿‡æœŸ
- ç¼“å­˜ç©¿é€ï¼šæ¶æ„è¯·æ±‚ä¸å­˜åœ¨çš„æ•°æ®
- å†…å­˜æ³„æ¼ï¼šå¿˜è®°è®¾ç½®è¿‡æœŸæ—¶é—´

### 5.4 æ€§èƒ½ä¼˜åŒ–æŒ‡å¯¼


**ğŸš€ æ€§èƒ½ä¼˜åŒ–è¦ç‚¹**
```
è¿æ¥æ± ä¼˜åŒ–ï¼š
- ä½¿ç”¨è¿æ¥æ± é¿å…é¢‘ç¹è¿æ¥
- åˆç†è®¾ç½®æ± å¤§å°å‚æ•°

æ‰¹é‡æ“ä½œï¼š
- ä½¿ç”¨pipelineå‡å°‘ç½‘ç»œå¾€è¿”
- ä½¿ç”¨mget/msetæ‰¹é‡å¤„ç†

æ•°æ®ç»“æ„é€‰æ‹©ï¼š
- æ ¹æ®è®¿é—®æ¨¡å¼é€‰æ‹©åˆé€‚çš„æ•°æ®ç±»å‹
- Stringé€‚åˆç®€å•KVåœºæ™¯
- Hashé€‚åˆå¯¹è±¡å­˜å‚¨åœºæ™¯
```

**ğŸ“Š ç›‘æ§æŒ‡æ ‡**
- **å‘½ä¸­ç‡**ï¼šç¼“å­˜å‘½ä¸­ç‡åº”>80%
- **å“åº”æ—¶é—´**ï¼šæ“ä½œå»¶è¿Ÿåº”<1ms  
- **å†…å­˜ä½¿ç”¨**ï¼šé¿å…å†…å­˜æº¢å‡º
- **è¿æ¥æ•°**ï¼šç›‘æ§è¿æ¥æ± çŠ¶æ€
- **æ…¢æŸ¥è¯¢**ï¼šç›‘æ§æ‰§è¡Œæ—¶é—´>10msçš„å‘½ä»¤

**æ ¸å¿ƒè®°å¿†**ï¼š
- Stringç±»å‹è™½ç®€å•ï¼Œä½†åº”ç”¨åœºæ™¯å¾ˆå¹¿æ³›
- åˆ†å¸ƒå¼é”è¦è€ƒè™‘åŸå­æ€§ã€è¿‡æœŸæ—¶é—´ã€å”¯ä¸€æ ‡è¯†
- ç¼“å­˜è®¾è®¡è¦å¹³è¡¡ä¸€è‡´æ€§å’Œæ€§èƒ½
- è®¡æ•°åº”ç”¨åˆ©ç”¨RedisåŸå­æ€§ç‰¹ç‚¹
- å®æˆ˜ä¸­è¦è€ƒè™‘å¼‚å¸¸æƒ…å†µå’Œæ€§èƒ½ä¼˜åŒ–