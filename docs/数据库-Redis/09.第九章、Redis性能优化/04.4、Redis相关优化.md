---
title: 4ã€Redisç›¸å…³ä¼˜åŒ–
---
## ğŸ“š ç›®å½•

1. [Redisæ€§èƒ½ä¼˜åŒ–æ¦‚è¿°](#1-Redisæ€§èƒ½ä¼˜åŒ–æ¦‚è¿°)
2. [Pipelineæ‰¹é‡æ“ä½œ](#2-Pipelineæ‰¹é‡æ“ä½œ)
3. [æ…¢æŸ¥è¯¢æ—¥å¿—ä¸ç›‘æ§](#3-æ…¢æŸ¥è¯¢æ—¥å¿—ä¸ç›‘æ§)
4. [çƒ­ç‚¹Keyè§£å†³æ–¹æ¡ˆ](#4-çƒ­ç‚¹Keyè§£å†³æ–¹æ¡ˆ)
5. [å†…å­˜ä¼˜åŒ–ç­–ç•¥](#5-å†…å­˜ä¼˜åŒ–ç­–ç•¥)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. âš¡ Redisæ€§èƒ½ä¼˜åŒ–æ¦‚è¿°


### 1.1 ä¸ºä»€ä¹ˆéœ€è¦æ€§èƒ½ä¼˜åŒ–


**ç°å®é—®é¢˜**ï¼šå°±åƒé«˜é€Ÿå…¬è·¯ï¼Œè½¦å°‘çš„æ—¶å€™ç•…é€šæ— é˜»ï¼Œè½¦å¤šäº†å°±ä¼šæ‹¥å µã€‚Redisä¹Ÿä¸€æ ·ï¼Œè®¿é—®é‡å¤§äº†æ€§èƒ½å°±ä¼šä¸‹é™ã€‚

**å¸¸è§æ€§èƒ½ç“¶é¢ˆ**ï¼š
```
ç½‘ç»œç“¶é¢ˆï¼š
å®¢æˆ·ç«¯ â†â†’ RedisæœåŠ¡å™¨ (ç½‘ç»œå»¶è¿Ÿ)
é—®é¢˜ï¼šæ¯ä¸ªå‘½ä»¤éƒ½è¦ä¸€æ¬¡ç½‘ç»œå¾€è¿”

CPUç“¶é¢ˆï¼š
å•çº¿ç¨‹å¤„ç†å‘½ä»¤ (Redisæ˜¯å•çº¿ç¨‹çš„)
é—®é¢˜ï¼šå¤æ‚å‘½ä»¤ä¼šé˜»å¡å…¶ä»–æ“ä½œ

å†…å­˜ç“¶é¢ˆï¼š
æ•°æ®é‡å¢é•¿ â†’ å†…å­˜ä¸è¶³ â†’ æ€§èƒ½ä¸‹é™
é—®é¢˜ï¼šå†…å­˜ç”¨å®Œäº†ï¼Œæˆ–è€…é¢‘ç¹çš„åƒåœ¾å›æ”¶
```

### 1.2 ä¼˜åŒ–ç­–ç•¥æ¦‚è§ˆ


```
æ€§èƒ½ä¼˜åŒ–çš„ä¸‰ä¸ªæ–¹å‘ï¼š

1. å‡å°‘ç½‘ç»œå¼€é”€
   â†“
   Pipelineæ‰¹é‡æ“ä½œ

2. é¿å…é˜»å¡æ“ä½œ  
   â†“
   æ…¢æŸ¥è¯¢ç›‘æ§ + çƒ­ç‚¹Keyä¼˜åŒ–

3. åˆç†ä½¿ç”¨å†…å­˜
   â†“  
   å†…å­˜ä¼˜åŒ– + è¿‡æœŸç­–ç•¥
```

---

## 2. ğŸš€ Pipelineæ‰¹é‡æ“ä½œ


### 2.1 ä»€ä¹ˆæ˜¯Pipeline


**ç”Ÿæ´»ä¾‹å­**ï¼šå°±åƒå¯„å¿«é€’ï¼Œä½ æœ‰100ä¸ªåŒ…è£¹è¦å¯„ï¼Œæ˜¯ä¸€ä¸ªä¸€ä¸ªè·‘100è¶Ÿå¿«é€’åº—æ•ˆç‡é«˜ï¼Œè¿˜æ˜¯æŠŠ100ä¸ªåŒ…è£¹ä¸€æ¬¡æ€§å¸¦å»æ•ˆç‡é«˜ï¼Ÿ

```
æ™®é€šæ¨¡å¼ (ä¸€ä¸ªä¸€ä¸ªå‘é€):
å®¢æˆ·ç«¯ â†’ å‘½ä»¤1 â†’ Redis â†’ ç»“æœ1 â†’ å®¢æˆ·ç«¯
å®¢æˆ·ç«¯ â†’ å‘½ä»¤2 â†’ Redis â†’ ç»“æœ2 â†’ å®¢æˆ·ç«¯  
å®¢æˆ·ç«¯ â†’ å‘½ä»¤3 â†’ Redis â†’ ç»“æœ3 â†’ å®¢æˆ·ç«¯
æ€»æ—¶é—´ = 3 Ã— (ç½‘ç»œå»¶è¿Ÿ + å¤„ç†æ—¶é—´)

Pipelineæ¨¡å¼ (æ‰¹é‡å‘é€):
å®¢æˆ·ç«¯ â†’ å‘½ä»¤1,å‘½ä»¤2,å‘½ä»¤3 â†’ Redis â†’ ç»“æœ1,ç»“æœ2,ç»“æœ3 â†’ å®¢æˆ·ç«¯
æ€»æ—¶é—´ = 1 Ã— ç½‘ç»œå»¶è¿Ÿ + 3 Ã— å¤„ç†æ—¶é—´
```

### 2.2 Pipelineå·¥ä½œåŸç†


**æ ¸å¿ƒæ€æƒ³**ï¼šæŠŠå¤šä¸ªRediså‘½ä»¤æ‰“åŒ…å‘é€ï¼Œå‡å°‘ç½‘ç»œå¾€è¿”æ¬¡æ•°ã€‚

```
Pipelineå¤„ç†æµç¨‹ï¼š

æ­¥éª¤1ï¼šå®¢æˆ·ç«¯å‡†å¤‡å¤šä¸ªå‘½ä»¤
â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”
â”‚ SET  â”‚ GET  â”‚ INCR â”‚
â”‚ key1 â”‚ key2 â”‚ key3 â”‚  
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜

æ­¥éª¤2ï¼šæ‰¹é‡å‘é€ç»™Redis
å®¢æˆ·ç«¯ â•â•â•â•â•â•â•â•â•â•â•> RedisæœåŠ¡å™¨

æ­¥éª¤3ï¼šRedisä¾æ¬¡æ‰§è¡Œ
Rediså†…éƒ¨ï¼šSET key1 â†’ GET key2 â†’ INCR key3

æ­¥éª¤4ï¼šæ‰¹é‡è¿”å›ç»“æœ  
å®¢æˆ·ç«¯ <â•â•â•â•â•â•â•â•â•â•â• RedisæœåŠ¡å™¨
       [OK, value, 1]
```

### 2.3 Pipelineä»£ç å®ç°


**Pythonå®ç°**ï¼š
```python
import redis
import time

r = redis.Redis(host='localhost', port=6379, db=0)

# æ™®é€šæ–¹å¼ - é€ä¸ªæ‰§è¡Œ
def normal_operations():
    start_time = time.time()
    
    for i in range(1000):
        r.set(f"key{i}", f"value{i}")
    
    end_time = time.time()
    print(f"æ™®é€šæ–¹å¼è€—æ—¶: {end_time - start_time:.2f}ç§’")

# Pipelineæ–¹å¼ - æ‰¹é‡æ‰§è¡Œ
def pipeline_operations():
    start_time = time.time()
    
    pipe = r.pipeline()
    for i in range(1000):
        pipe.set(f"key{i}", f"value{i}")
    
    # ä¸€æ¬¡æ€§æ‰§è¡Œæ‰€æœ‰å‘½ä»¤
    pipe.execute()
    
    end_time = time.time()
    print(f"Pipelineæ–¹å¼è€—æ—¶: {end_time - start_time:.2f}ç§’")
```

**Javaå®ç°**ï¼š
```java
// Jedis Pipelineç¤ºä¾‹
Jedis jedis = new Jedis("localhost", 6379);

// åˆ›å»ºPipeline
Pipeline pipeline = jedis.pipelined();

// æ‰¹é‡æ·»åŠ å‘½ä»¤
for(int i = 0; i < 1000; i++) {
    pipeline.set("key" + i, "value" + i);
}

// ä¸€æ¬¡æ€§æ‰§è¡Œ
List<Object> results = pipeline.syncAndReturnAll();
```

### 2.4 Pipelineä½¿ç”¨æ³¨æ„äº‹é¡¹


**âš ï¸ é‡è¦é™åˆ¶**ï¼š
```
å‘½ä»¤æ•°é‡æ§åˆ¶ï¼š
- å»ºè®®æ¯æ‰¹100-1000ä¸ªå‘½ä»¤
- å¤ªå¤šä¼šå ç”¨å¤§é‡å†…å­˜
- å¤ªå°‘ä¼˜åŒ–æ•ˆæœä¸æ˜æ˜¾

å†…å­˜æ¶ˆè€—ï¼š
- Pipelineä¼šåœ¨å†…å­˜ä¸­ç¼“å­˜æ‰€æœ‰å‘½ä»¤å’Œç»“æœ
- å¤§æ‰¹é‡æ“ä½œè¦æ³¨æ„å†…å­˜ä½¿ç”¨

ä¸æ”¯æŒäº‹åŠ¡ï¼š
- Pipelineä¸ä¿è¯åŸå­æ€§
- å¦‚éœ€åŸå­æ€§ï¼Œä½¿ç”¨MULTI/EXEC
```

**ğŸ’¡ æœ€ä½³å®è·µ**ï¼š
```python
def batch_process_with_pipeline(data_list, batch_size=500):
    """åˆ†æ‰¹ä½¿ç”¨Pipelineå¤„ç†å¤§é‡æ•°æ®"""
    total_processed = 0
    
    for i in range(0, len(data_list), batch_size):
        batch = data_list[i:i+batch_size]
        
        pipe = r.pipeline()
        for item in batch:
            pipe.set(item['key'], item['value'])
        
        pipe.execute()
        total_processed += len(batch)
        print(f"å·²å¤„ç† {total_processed}/{len(data_list)} æ¡æ•°æ®")
```

---

## 3. ğŸ” æ…¢æŸ¥è¯¢æ—¥å¿—ä¸ç›‘æ§


### 3.1 ä»€ä¹ˆæ˜¯æ…¢æŸ¥è¯¢


**é€šä¿—è§£é‡Š**ï¼šå°±åƒä½“æ£€æŠ¥å‘Šï¼Œå‘Šè¯‰ä½ å“ªäº›æ“ä½œè€—æ—¶å¤ªé•¿ï¼Œå½±å“äº†æ•´ä½“æ€§èƒ½ã€‚

**Rediså•çº¿ç¨‹ç‰¹æ€§**ï¼š
```
Rediså¤„ç†å‘½ä»¤çš„æ–¹å¼ï¼š
å‘½ä»¤é˜Ÿåˆ—: [å‘½ä»¤1] [å‘½ä»¤2] [å‘½ä»¤3] [å‘½ä»¤4]
          â†“
       å•çº¿ç¨‹å¤„ç†å™¨
          â†“
        [ç»“æœ]

é—®é¢˜ï¼šå¦‚æœå‘½ä»¤2å¾ˆæ…¢ï¼Œå‘½ä»¤3å’Œ4å°±è¦ç­‰å¾…
```

### 3.2 æ…¢æŸ¥è¯¢é…ç½®


**åŸºæœ¬é…ç½®**ï¼š
```bash
# è®¾ç½®æ…¢æŸ¥è¯¢æ—¶é—´é˜ˆå€¼(å¾®ç§’)
CONFIG SET slowlog-log-slower-than 10000  # 10æ¯«ç§’

# è®¾ç½®æ…¢æŸ¥è¯¢æ—¥å¿—æœ€å¤§é•¿åº¦
CONFIG SET slowlog-max-len 128

# æŸ¥çœ‹å½“å‰é…ç½®
CONFIG GET slowlog*
```

**é…ç½®å»ºè®®**ï¼š
```
ç”Ÿäº§ç¯å¢ƒå»ºè®®ï¼š
slowlog-log-slower-than: 10000 (10æ¯«ç§’)
slowlog-max-len: 1000

å¼€å‘ç¯å¢ƒå»ºè®®ï¼š  
slowlog-log-slower-than: 1000 (1æ¯«ç§’)
slowlog-max-len: 128
```

### 3.3 æ…¢æŸ¥è¯¢æ—¥å¿—åˆ†æ


**æŸ¥çœ‹æ…¢æŸ¥è¯¢**ï¼š
```bash
# è·å–æ‰€æœ‰æ…¢æŸ¥è¯¢
SLOWLOG GET

# è·å–æœ€è¿‘10æ¡æ…¢æŸ¥è¯¢
SLOWLOG GET 10

# è·å–æ…¢æŸ¥è¯¢æ€»æ•°
SLOWLOG LEN

# æ¸…ç©ºæ…¢æŸ¥è¯¢æ—¥å¿—
SLOWLOG RESET
```

**æ—¥å¿—ä¿¡æ¯è§£è¯»**ï¼š
```bash
127.0.0.1:6379> SLOWLOG GET 2
1) 1) (integer) 2           # å”¯ä¸€æ ‡è¯†ç¬¦
   2) (integer) 1635724800  # æ‰§è¡Œæ—¶é—´æˆ³
   3) (integer) 12000       # æ‰§è¡Œè€—æ—¶(å¾®ç§’) = 12æ¯«ç§’
   4) 1) "KEYS"             # æ‰§è¡Œçš„å‘½ä»¤
      2) "user:*"           # å‘½ä»¤å‚æ•°
   5) "127.0.0.1:54321"     # å®¢æˆ·ç«¯åœ°å€

è§£è¯»ï¼šKEYS user:* å‘½ä»¤è€—æ—¶12æ¯«ç§’ï¼Œæ¯”è¾ƒæ…¢
```

### 3.4 å¸¸è§æ…¢æŸ¥è¯¢åŠä¼˜åŒ–


**å…¸å‹æ…¢å‘½ä»¤**ï¼š
```bash
# âŒ å±é™©å‘½ä»¤ - ä¼šæ‰«ææ‰€æœ‰key
KEYS pattern*           # æ›¿æ¢ä¸ºï¼šSCAN
FLUSHALL               # æ›¿æ¢ä¸ºï¼šåˆ†æ‰¹åˆ é™¤
HGETALL big_hash       # æ›¿æ¢ä¸ºï¼šHSCAN

# âŒ å¤§é›†åˆæ“ä½œ
SMEMBERS big_set       # æ›¿æ¢ä¸ºï¼šSSCAN  
LRANGE list 0 -1       # æ›¿æ¢ä¸ºï¼šåˆ†é¡µè·å–

# âŒ å¤æ‚è®¡ç®—
SORT big_list          # æ›¿æ¢ä¸ºï¼šåº”ç”¨å±‚æ’åº
```

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
```python
# âŒ é”™è¯¯æ–¹å¼
def get_all_users_wrong():
    keys = r.keys("user:*")  # æ…¢æŸ¥è¯¢!
    users = []
    for key in keys:
        users.append(r.hgetall(key))
    return users

# âœ… æ­£ç¡®æ–¹å¼  
def get_all_users_right():
    users = []
    cursor = 0
    
    while True:
        cursor, keys = r.scan(cursor, match="user:*", count=100)
        
        if keys:
            pipe = r.pipeline()
            for key in keys:
                pipe.hgetall(key)
            results = pipe.execute()
            users.extend(results)
        
        if cursor == 0:
            break
    
    return users
```

---

## 4. ğŸ”¥ çƒ­ç‚¹Keyè§£å†³æ–¹æ¡ˆ


### 4.1 ä»€ä¹ˆæ˜¯çƒ­ç‚¹Key


**ç”Ÿæ´»ä¾‹å­**ï¼šå°±åƒæ˜æ˜Ÿçš„å¾®åšï¼Œçªç„¶ç«äº†ï¼Œå¤§å®¶éƒ½å»çœ‹ï¼ŒæœåŠ¡å™¨æ‰›ä¸ä½äº†ã€‚

**æŠ€æœ¯å®šä¹‰**ï¼šæŸä¸ªKeyè¢«å¤§é‡å®¢æˆ·ç«¯é¢‘ç¹è®¿é—®ï¼Œå¯¼è‡´ï¼š
- å•ä¸ªRediså®ä¾‹å‹åŠ›è¿‡å¤§
- ç½‘ç»œå¸¦å®½å ç”¨è¿‡é«˜  
- å“åº”æ—¶é—´å˜é•¿

### 4.2 çƒ­ç‚¹Keyäº§ç”ŸåŸå› 


**å…¸å‹åœºæ™¯**ï¼š
```
çªå‘çƒ­ç‚¹ï¼š
- çƒ­æœäº‹ä»¶ç›¸å…³æ•°æ®
- é™æ—¶æŠ¢è´­å•†å“ä¿¡æ¯
- çªå‘æ–°é—»å†…å®¹

ä¸šåŠ¡çƒ­ç‚¹ï¼š
- ç”¨æˆ·ç™»å½•token
- çƒ­é—¨å•†å“è¯¦æƒ…
- ç³»ç»Ÿé…ç½®ä¿¡æ¯
```

### 4.3 çƒ­ç‚¹Keyæ£€æµ‹æ–¹æ³•


**ç›‘æ§æŒ‡æ ‡**ï¼š
```python
def monitor_hot_keys():
    """ç›‘æ§çƒ­ç‚¹Key"""
    # ä½¿ç”¨Redisçš„CLIENT TRACKINGåŠŸèƒ½
    # æˆ–è€…åœ¨åº”ç”¨å±‚ç»Ÿè®¡è®¿é—®é¢‘ç‡
    
    key_stats = {}
    
    def record_key_access(key):
        if key not in key_stats:
            key_stats[key] = 0
        key_stats[key] += 1
        
        # è¶…è¿‡é˜ˆå€¼å°±æ˜¯çƒ­ç‚¹Key
        if key_stats[key] > 1000:  # 1000æ¬¡/åˆ†é’Ÿ
            handle_hot_key(key)
    
    return key_stats
```

**æ£€æµ‹å·¥å…·**ï¼š
```bash
# Redis 4.0+ æ”¯æŒçƒ­ç‚¹Keyç»Ÿè®¡
redis-cli --hotkeys

# ä½¿ç”¨monitorå‘½ä»¤å®æ—¶ç›‘æ§(ä»…å¼€å‘ç¯å¢ƒ)
redis-cli monitor | grep -i "your_key_pattern"
```

### 4.4 çƒ­ç‚¹Keyè§£å†³æ–¹æ¡ˆ


**æ–¹æ¡ˆ1ï¼šæœ¬åœ°ç¼“å­˜**
```python
import time
from functools import lru_cache

class LocalCache:
    def __init__(self, ttl=60):
        self.cache = {}
        self.ttl = ttl
    
    def get(self, key):
        if key in self.cache:
            data, timestamp = self.cache[key]
            if time.time() - timestamp < self.ttl:
                return data
            else:
                del self.cache[key]
        return None
    
    def set(self, key, value):
        self.cache[key] = (value, time.time())

# ä½¿ç”¨æœ¬åœ°ç¼“å­˜å‡å°‘Redisè®¿é—®
local_cache = LocalCache(ttl=60)

def get_hot_data(key):
    # å…ˆæŸ¥æœ¬åœ°ç¼“å­˜
    data = local_cache.get(key)
    if data:
        return data
    
    # æœ¬åœ°æ²¡æœ‰ï¼ŒæŸ¥Redis
    data = r.get(key)
    if data:
        local_cache.set(key, data)
    
    return data
```

**æ–¹æ¡ˆ2ï¼šè¯»å†™åˆ†ç¦»**
```python
# ä¸»ä»å¤åˆ¶ + è¯»å†™åˆ†ç¦»
class RedisCluster:
    def __init__(self):
        self.master = redis.Redis(host='master-redis')
        self.slaves = [
            redis.Redis(host='slave1-redis'),
            redis.Redis(host='slave2-redis'),
            redis.Redis(host='slave3-redis')
        ]
        self.slave_index = 0
    
    def write(self, key, value):
        """å†™æ“ä½œèµ°ä¸»åº“"""
        return self.master.set(key, value)
    
    def read(self, key):
        """è¯»æ“ä½œèµ°ä»åº“ï¼Œè½®è¯¢è´Ÿè½½å‡è¡¡"""
        slave = self.slaves[self.slave_index]
        self.slave_index = (self.slave_index + 1) % len(self.slaves)
        return slave.get(key)
```

**æ–¹æ¡ˆ3ï¼šæ•°æ®åˆ†ç‰‡**
```python
def get_shard_key(original_key, shard_count=10):
    """å°†çƒ­ç‚¹Keyåˆ†ç‰‡å­˜å‚¨"""
    import hashlib
    
    # æ ¹æ®Keyè®¡ç®—å“ˆå¸Œå€¼
    hash_value = int(hashlib.md5(original_key.encode()).hexdigest(), 16)
    shard_index = hash_value % shard_count
    
    return f"{original_key}:shard:{shard_index}"

def set_with_sharding(key, value, shard_count=10):
    """åˆ†ç‰‡å­˜å‚¨"""
    for i in range(shard_count):
        shard_key = f"{key}:shard:{i}"
        r.set(shard_key, value)

def get_with_sharding(key, shard_count=10):
    """åˆ†ç‰‡è¯»å–"""
    shard_key = get_shard_key(key, shard_count)
    return r.get(shard_key)
```

---

## 5. ğŸ’¾ å†…å­˜ä¼˜åŒ–ç­–ç•¥


### 5.1 Rediså†…å­˜ä½¿ç”¨åˆ†æ


**å†…å­˜ç»„æˆ**ï¼š
```
Rediså†…å­˜ä½¿ç”¨ = æ•°æ®å†…å­˜ + ç¼“å†²åŒºå†…å­˜ + å¤åˆ¶ç§¯å‹ç¼“å†²åŒº + å…¶ä»–

æ•°æ®å†…å­˜ï¼šå­˜å‚¨ç”¨æˆ·æ•°æ®(å å¤§å¤´)
ç¼“å†²åŒºï¼šå®¢æˆ·ç«¯è¿æ¥ã€AOFç¼“å†²ç­‰
å¤åˆ¶å†…å­˜ï¼šä¸»ä»å¤åˆ¶ç›¸å…³
å…¶ä»–ï¼šRedisè‡ªèº«è¿è¡Œå†…å­˜
```

**å†…å­˜æŸ¥çœ‹å‘½ä»¤**ï¼š
```bash
# æŸ¥çœ‹å†…å­˜ä½¿ç”¨æƒ…å†µ
INFO memory

# åˆ†æå†…å­˜ä½¿ç”¨
MEMORY USAGE keyname    # æŸ¥çœ‹æŸä¸ªkeyå ç”¨å†…å­˜
MEMORY STATS           # æŸ¥çœ‹å†…å­˜ç»Ÿè®¡ä¿¡æ¯
```

### 5.2 å‹ç¼©å­˜å‚¨ä¼˜åŒ–


**å­—ç¬¦ä¸²å‹ç¼©**ï¼š
```bash
# Redisä¼šè‡ªåŠ¨å‹ç¼©é•¿å­—ç¬¦ä¸²
# å½“å­—ç¬¦ä¸²é•¿åº¦è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œä½¿ç”¨LZFå‹ç¼©ç®—æ³•

# é…ç½®å‹ç¼©å‚æ•°
CONFIG SET list-compress-depth 1    # å‹ç¼©åˆ—è¡¨ä¸¤ç«¯1ä¸ªå…ƒç´ 
CONFIG SET hash-max-ziplist-entries 512  # å“ˆå¸Œå‹ç¼©é˜ˆå€¼
```

**æ•°æ®ç»“æ„ä¼˜åŒ–**ï¼š
```python
# âŒ å†…å­˜æµªè´¹çš„æ–¹å¼
def store_user_info_wasteful(user_id, info):
    """æ¯ä¸ªå­—æ®µå•ç‹¬å­˜å‚¨"""
    r.set(f"user:{user_id}:name", info['name'])
    r.set(f"user:{user_id}:email", info['email'])
    r.set(f"user:{user_id}:phone", info['phone'])
    # æ¯ä¸ªkeyéƒ½æœ‰å¼€é”€

# âœ… å†…å­˜ä¼˜åŒ–çš„æ–¹å¼
def store_user_info_optimized(user_id, info):
    """ä½¿ç”¨Hashç»Ÿä¸€å­˜å‚¨"""
    r.hset(f"user:{user_id}", mapping=info)
    # ä¸€ä¸ªHashå­˜å‚¨æ‰€æœ‰ä¿¡æ¯ï¼Œå¼€é”€å°
```

### 5.3 è¿‡æœŸæ—¶é—´ç­–ç•¥


**ä¸ºä»€ä¹ˆè¦è®¾ç½®è¿‡æœŸ**ï¼šå°±åƒå†°ç®±ï¼Œå¦‚æœä¸åŠæ—¶æ¸…ç†è¿‡æœŸé£Ÿå“ï¼Œå¾ˆå¿«å°±è£…ä¸ä¸‹äº†ã€‚

**è¿‡æœŸç­–ç•¥åˆ†ç±»**ï¼š
```bash
# 1. å›ºå®šè¿‡æœŸæ—¶é—´
SET session:123 "user_data" EX 3600    # 1å°æ—¶åè¿‡æœŸ

# 2. ç»å¯¹è¿‡æœŸæ—¶é—´  
EXPIREAT key 1635724800               # æŒ‡å®šæ—¶é—´æˆ³è¿‡æœŸ

# 3. è®¿é—®åå»¶æœŸ
GET key
EXPIRE key 3600                       # è·å–åé‡ç½®è¿‡æœŸæ—¶é—´
```

**æ™ºèƒ½è¿‡æœŸç­–ç•¥**ï¼š
```python
def smart_expire_strategy(key, data, access_pattern):
    """æ ¹æ®è®¿é—®æ¨¡å¼è®¾ç½®è¿‡æœŸæ—¶é—´"""
    
    if access_pattern == 'session':
        # ä¼šè¯æ•°æ®ï¼š30åˆ†é’Ÿæ— è®¿é—®å°±è¿‡æœŸ
        r.setex(key, 1800, data)
        
    elif access_pattern == 'cache':
        # ç¼“å­˜æ•°æ®ï¼š1å°æ—¶è¿‡æœŸï¼Œä½†è®¿é—®åå»¶é•¿
        r.setex(key, 3600, data)
        
    elif access_pattern == 'temp':
        # ä¸´æ—¶æ•°æ®ï¼š5åˆ†é’Ÿè¿‡æœŸ
        r.setex(key, 300, data)
    
    else:
        # é»˜è®¤ç­–ç•¥ï¼š24å°æ—¶è¿‡æœŸ
        r.setex(key, 86400, data)

def access_with_refresh(key):
    """è®¿é—®æ—¶åˆ·æ–°è¿‡æœŸæ—¶é—´"""
    data = r.get(key)
    if data:
        # è®¿é—®æˆåŠŸï¼Œå»¶é•¿è¿‡æœŸæ—¶é—´
        r.expire(key, 3600)
    return data
```

### 5.4 å†…å­˜å›æ”¶æœºåˆ¶


**Rediså†…å­˜å›æ”¶ç­–ç•¥**ï¼š
```bash
# æŸ¥çœ‹å½“å‰ç­–ç•¥
CONFIG GET maxmemory-policy

# å¸¸ç”¨ç­–ç•¥
allkeys-lru      # æ‰€æœ‰keyä½¿ç”¨LRUç®—æ³•åˆ é™¤
allkeys-lfu      # æ‰€æœ‰keyä½¿ç”¨LFUç®—æ³•åˆ é™¤  
volatile-lru     # åªå¯¹æœ‰è¿‡æœŸæ—¶é—´çš„keyä½¿ç”¨LRU
volatile-ttl     # åˆ é™¤æœ€æ¥è¿‘è¿‡æœŸçš„key
noeviction       # ä¸åˆ é™¤ï¼Œè¿”å›é”™è¯¯(é»˜è®¤)
```

**ç­–ç•¥é€‰æ‹©æŒ‡å—**ï¼š
```python
def choose_eviction_policy(use_case):
    """æ ¹æ®ä½¿ç”¨åœºæ™¯é€‰æ‹©å›æ”¶ç­–ç•¥"""
    
    if use_case == 'cache':
        # çº¯ç¼“å­˜åœºæ™¯ï¼šallkeys-lru
        return "æ‰€æœ‰æ•°æ®éƒ½å¯ä»¥åˆ é™¤ï¼Œä¼˜å…ˆåˆ é™¤æœ€å°‘ä½¿ç”¨çš„"
        
    elif use_case == 'session':
        # ä¼šè¯å­˜å‚¨ï¼švolatile-ttl  
        return "åªåˆ é™¤æœ‰è¿‡æœŸæ—¶é—´çš„æ•°æ®ï¼Œä¼˜å…ˆåˆ é™¤å¿«è¿‡æœŸçš„"
        
    elif use_case == 'mixed':
        # æ··åˆåœºæ™¯ï¼šallkeys-lfu
        return "åˆ é™¤è®¿é—®é¢‘ç‡æœ€ä½çš„æ•°æ®"
    
    else:
        return "æ ¹æ®å…·ä½“ä¸šåŠ¡å†³å®š"
```

### 5.5 å†…å­˜ä¼˜åŒ–å®è·µ


**æ•°æ®ç±»å‹é€‰æ‹©**ï¼š
```python
# âŒ å†…å­˜æµªè´¹
def store_numbers_wasteful():
    for i in range(10000):
        r.set(f"number:{i}", str(i))  # æ¯ä¸ªæ•°å­—éƒ½æ˜¯ç‹¬ç«‹çš„key

# âœ… å†…å­˜ä¼˜åŒ–
def store_numbers_optimized():
    # ä½¿ç”¨Hashæ‰¹é‡å­˜å‚¨
    pipe = r.pipeline()
    for i in range(10000):
        pipe.hset("numbers", str(i), str(i))
    pipe.execute()
```

**å¯¹è±¡å­˜å‚¨ä¼˜åŒ–**ï¼š
```python
import json
import pickle

def store_object_optimized(key, obj):
    """ä¼˜åŒ–å¯¹è±¡å­˜å‚¨"""
    
    # æ–¹æ¡ˆ1ï¼šJSONåºåˆ—åŒ–(å¯è¯»æ€§å¥½)
    if len(json.dumps(obj)) < 1024:
        r.set(key, json.dumps(obj))
    
    # æ–¹æ¡ˆ2ï¼šPickleåºåˆ—åŒ–(æ›´ç´§å‡‘)  
    else:
        r.set(key, pickle.dumps(obj))
        
    # è®¾ç½®åˆç†è¿‡æœŸæ—¶é—´
    r.expire(key, 3600)
```

---

## 6. ğŸ“Š æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Pipelineæ‰¹é‡æ“ä½œï¼šå‡å°‘ç½‘ç»œå¾€è¿”ï¼Œæ˜¾è‘—æå‡æ€§èƒ½
ğŸ”¸ æ…¢æŸ¥è¯¢ç›‘æ§ï¼šæ‰¾å‡ºæ€§èƒ½ç“¶é¢ˆï¼Œé¿å…é˜»å¡æ“ä½œ
ğŸ”¸ çƒ­ç‚¹Keyé—®é¢˜ï¼šé«˜é¢‘è®¿é—®å¯¼è‡´æ€§èƒ½ä¸‹é™ï¼Œéœ€è¦åˆ†æ•£ç­–ç•¥
ğŸ”¸ å†…å­˜ä¼˜åŒ–ï¼šåˆç†ä½¿ç”¨æ•°æ®ç±»å‹ï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´
ğŸ”¸ æ€§èƒ½ç›‘æ§ï¼šå»ºç«‹å®Œå–„çš„ç›‘æ§ä½“ç³»ï¼ŒåŠæ—¶å‘ç°é—®é¢˜
```

### 6.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ Pipelineä»€ä¹ˆæ—¶å€™ç”¨**
```
é€‚åˆåœºæ™¯ï¼š
- æ‰¹é‡æ•°æ®æ“ä½œ(å¯¼å…¥ã€å¯¼å‡º)
- åˆå§‹åŒ–å¤§é‡ç¼“å­˜
- æ•°æ®è¿ç§»å’ŒåŒæ­¥

ä¸é€‚åˆåœºæ™¯ï¼š
- å‘½ä»¤é—´æœ‰ä¾èµ–å…³ç³»
- éœ€è¦æ ¹æ®å‰ä¸€ä¸ªå‘½ä»¤ç»“æœå†³å®šä¸‹ä¸€ä¸ªå‘½ä»¤
- å®æ—¶æ€§è¦æ±‚æé«˜çš„æ“ä½œ
```

**ğŸ”¹ æ…¢æŸ¥è¯¢ä¼˜åŒ–æ€è·¯**
```
å‘ç°é—®é¢˜ï¼šé€šè¿‡æ…¢æŸ¥è¯¢æ—¥å¿—å®šä½è€—æ—¶æ“ä½œ
åˆ†æåŸå› ï¼šæ˜¯æ•°æ®é‡å¤§è¿˜æ˜¯ç®—æ³•å¤æ‚
è§£å†³æ–¹æ¡ˆï¼š
- é¿å…å…¨è¡¨æ‰«æç±»å‘½ä»¤(KEYSã€FLUSHALL)
- ä½¿ç”¨SCANæ›¿ä»£KEYS
- åˆ†é¡µè·å–å¤§é›†åˆæ•°æ®
- å°†å¤æ‚è®¡ç®—ç§»åˆ°åº”ç”¨å±‚
```

**ğŸ”¹ å†…å­˜ä¼˜åŒ–æ ¸å¿ƒåŸåˆ™**
```
é€‰æ‹©åˆé€‚çš„æ•°æ®ç»“æ„ï¼š
- å°å¯¹è±¡ç”¨Hashè€Œä¸æ˜¯å¤šä¸ªString
- æ•°å€¼èŒƒå›´å°ç”¨æ•´æ•°ç¼–ç 
- å¤§é›†åˆè€ƒè™‘åˆ†ç‰‡å­˜å‚¨

è®¾ç½®åˆç†è¿‡æœŸæ—¶é—´ï¼š
- ä¼šè¯æ•°æ®ï¼š30åˆ†é’Ÿ-2å°æ—¶
- ç¼“å­˜æ•°æ®ï¼š1-24å°æ—¶  
- ä¸´æ—¶æ•°æ®ï¼š5-30åˆ†é’Ÿ
- æ°¸ä¹…æ•°æ®ï¼šè°¨æ…ä½¿ç”¨ï¼Œå®šæœŸæ¸…ç†
```

### 6.3 æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ


**ç›‘æ§ä½“ç³»**ï¼š
```python
def redis_health_check():
    """Rediså¥åº·æ£€æŸ¥"""
    info = r.info()
    
    # æ£€æŸ¥å†…å­˜ä½¿ç”¨ç‡
    memory_usage = info['used_memory'] / info['maxmemory'] * 100
    if memory_usage > 80:
        print(f"âš ï¸ å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: {memory_usage:.1f}%")
    
    # æ£€æŸ¥æ…¢æŸ¥è¯¢
    slowlog_len = r.slowlog_len()
    if slowlog_len > 10:
        print(f"âš ï¸ æ…¢æŸ¥è¯¢è¿‡å¤š: {slowlog_len}æ¡")
    
    # æ£€æŸ¥è¿æ¥æ•°
    connected_clients = info['connected_clients']
    if connected_clients > 1000:
        print(f"âš ï¸ è¿æ¥æ•°è¿‡å¤š: {connected_clients}")

# å®šæœŸæ‰§è¡Œå¥åº·æ£€æŸ¥
import schedule
schedule.every(5).minutes.do(redis_health_check)
```

**æ€§èƒ½ä¼˜åŒ–æ¸…å•**ï¼š

| ä¼˜åŒ–ç±»å‹ | å…·ä½“æªæ–½ | æ•ˆæœ |
|---------|---------|------|
| **ç½‘ç»œä¼˜åŒ–** | ä½¿ç”¨Pipelineæ‰¹é‡æ“ä½œ | å‡å°‘50-90%ç½‘ç»œè€—æ—¶ |
| **å‘½ä»¤ä¼˜åŒ–** | é¿å…KEYSç­‰å…¨è¡¨æ‰«æ | é¿å…é˜»å¡å…¶ä»–æ“ä½œ |
| **å†…å­˜ä¼˜åŒ–** | åˆç†æ•°æ®ç»“æ„+è¿‡æœŸæ—¶é—´ | å‡å°‘30-60%å†…å­˜ä½¿ç”¨ |
| **è¿æ¥ä¼˜åŒ–** | è¿æ¥æ± å¤ç”¨ | å‡å°‘è¿æ¥å¼€é”€ |
| **ç›‘æ§ä¼˜åŒ–** | æ…¢æŸ¥è¯¢+å†…å­˜ç›‘æ§ | åŠæ—¶å‘ç°æ€§èƒ½é—®é¢˜ |

### 6.4 å®é™…åº”ç”¨ä»·å€¼


**ä¸šåŠ¡åœºæ™¯ä¼˜åŒ–**ï¼š
- **ç”µå•†ç³»ç»Ÿ**ï¼šå•†å“è¯¦æƒ…ç¼“å­˜ä¼˜åŒ–ï¼Œåº“å­˜çƒ­ç‚¹Keyåˆ†æ•£
- **ç¤¾äº¤å¹³å°**ï¼šç”¨æˆ·ä¿¡æ¯ç¼“å­˜ï¼Œçƒ­é—¨å†…å®¹åˆ†çº§ç¼“å­˜
- **æ¸¸æˆç³»ç»Ÿ**ï¼šæ’è¡Œæ¦œæ•°æ®ï¼Œç©å®¶çŠ¶æ€æ‰¹é‡æ›´æ–°
- **å†…å®¹ç½‘ç«™**ï¼šæ–‡ç« ç¼“å­˜ï¼Œè¯„è®ºæ•°æ®Pipelineæ“ä½œ

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- Pipelineæ‰¹é‡å‡ç½‘ç»œï¼Œæ…¢æŸ¥è¯¢ç›‘æ§æ‰¾ç“¶é¢ˆ
- çƒ­ç‚¹Keyè¦åˆ†æ•£ï¼Œå†…å­˜ä¼˜åŒ–è®¾è¿‡æœŸ  
- ç›‘æ§å‘Šè­¦è¦åŠæ—¶ï¼Œæ€§èƒ½é—®é¢˜æ—©å‘ç°
- æ•°æ®ç»“æ„é€‰å¯¹äº†ï¼Œå†…å­˜æ•ˆç‡æä¸€å€