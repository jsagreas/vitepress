---
title: 3ã€RedisåŸå­æ€§ä¸äº‹åŠ¡æ§åˆ¶
---
## ğŸ“š ç›®å½•

1. [åŸå­æ€§ä¸äº‹åŠ¡æ¦‚è¿°](#1-åŸå­æ€§ä¸äº‹åŠ¡æ¦‚è¿°)
2. [MULTI-EXECäº‹åŠ¡æœºåˆ¶](#2-MULTI-EXECäº‹åŠ¡æœºåˆ¶)
3. [WATCHä¹è§‚é”æœºåˆ¶](#3-WATCHä¹è§‚é”æœºåˆ¶)
4. [DISCARDå–æ¶ˆäº‹åŠ¡](#4-DISCARDå–æ¶ˆäº‹åŠ¡)
5. [äº‹åŠ¡éš”ç¦»ç‰¹æ€§](#5-äº‹åŠ¡éš”ç¦»ç‰¹æ€§)
6. [äº‹åŠ¡çš„å±€é™æ€§](#6-äº‹åŠ¡çš„å±€é™æ€§)
7. [å®é™…åº”ç”¨åœºæ™¯](#7-å®é™…åº”ç”¨åœºæ™¯)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ åŸå­æ€§ä¸äº‹åŠ¡æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯åŸå­æ€§


**ğŸ”¸ åŸå­æ€§çš„é€šä¿—ç†è§£**
```
åŸå­æ€§å°±åƒ"è¦ä¹ˆå…¨åšï¼Œè¦ä¹ˆä¸åš"
æ¯”å¦‚è½¬è´¦ï¼š
- è¦ä¹ˆAæ‰£é’±ä¸”BåŠ é’±ï¼ˆæˆåŠŸï¼‰
- è¦ä¹ˆAä¸æ‰£é’±ä¸”Bä¸åŠ é’±ï¼ˆå¤±è´¥ï¼‰
- ç»ä¸èƒ½Aæ‰£äº†é’±ä½†Bæ²¡åŠ é’±ï¼ˆæ•°æ®ä¸ä¸€è‡´ï¼‰
```

**ğŸ’¡ åŸå­æ“ä½œçš„ç‰¹ç‚¹**ï¼š
- **ä¸å¯åˆ†å‰²**ï¼šæ“ä½œè¦ä¹ˆå®Œå…¨æ‰§è¡Œï¼Œè¦ä¹ˆå®Œå…¨ä¸æ‰§è¡Œ
- **ä¸€è‡´çŠ¶æ€**ï¼šæ‰§è¡Œå‰åæ•°æ®éƒ½æ˜¯ä¸€è‡´çš„
- **éš”ç¦»æ‰§è¡Œ**ï¼šä¸ä¼šè¢«å…¶ä»–æ“ä½œå¹²æ‰°

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦äº‹åŠ¡


**ğŸ”¸ æ²¡æœ‰äº‹åŠ¡çš„é—®é¢˜**
```bash
# åœºæ™¯ï¼šç”¨æˆ·è´­ä¹°å•†å“ï¼Œéœ€è¦å‡åº“å­˜å’Œæ‰£ä½™é¢

# æ“ä½œ1ï¼šå‡å°‘åº“å­˜
DECR product:123:stock
# å¦‚æœè¿™æ—¶å€™Rediså´©æºƒæˆ–ç½‘ç»œæ–­å¼€...

# æ“ä½œ2ï¼šæ‰£é™¤ä½™é¢  
DECR user:456:balance
# å¯èƒ½åº“å­˜å‡äº†ï¼Œä½†ä½™é¢æ²¡æ‰£ï¼Œæ•°æ®ä¸ä¸€è‡´ï¼
```

**ğŸ”¸ äº‹åŠ¡çš„ä»·å€¼**
- **æ•°æ®ä¸€è‡´æ€§**ï¼šå¤šä¸ªæ“ä½œä½œä¸ºæ•´ä½“æ‰§è¡Œ
- **é”™è¯¯æ¢å¤**ï¼šå‡ºç°é—®é¢˜æ—¶å¯ä»¥å›æ»š
- **å¹¶å‘æ§åˆ¶**ï¼šé˜²æ­¢å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶ä¿®æ”¹æ•°æ®

### 1.3 Redisäº‹åŠ¡çš„ç‰¹ç‚¹


| ç‰¹æ€§ | **è¯´æ˜** | **ä¸ä¼ ç»Ÿæ•°æ®åº“å¯¹æ¯”** |
|------|----------|---------------------|
| **åŸå­æ€§** | æ‰€æœ‰å‘½ä»¤ä¸€èµ·æ‰§è¡Œ | âœ… æ”¯æŒ |
| **ä¸€è‡´æ€§** | æ‰§è¡Œå‰åæ•°æ®ä¸€è‡´ | âœ… æ”¯æŒ |
| **éš”ç¦»æ€§** | æ‰§è¡Œæ—¶ä¸è¢«æ‰“æ–­ | âš ï¸ éƒ¨åˆ†æ”¯æŒ |
| **æŒä¹…æ€§** | ç»“æœæŒä¹…ä¿å­˜ | âœ… æ”¯æŒï¼ˆé…ç½®ç›¸å…³ï¼‰ |

---

## 2. ğŸ”„ MULTI-EXECäº‹åŠ¡æœºåˆ¶


### 2.1 åŸºæœ¬äº‹åŠ¡æµç¨‹


**ğŸ”¸ äº‹åŠ¡çš„ä¸‰ä¸ªé˜¶æ®µ**
```
1. å¼€å§‹äº‹åŠ¡ï¼šMULTI
2. å‘½ä»¤å…¥é˜Ÿï¼šå„ç§Rediså‘½ä»¤
3. æ‰§è¡Œäº‹åŠ¡ï¼šEXEC
```

**ğŸ’¡ é€šä¿—æ¯”å–»**ï¼š
```
MULTI  = å¼€å§‹å†™è´­ç‰©æ¸…å•
å‘½ä»¤   = åœ¨æ¸…å•ä¸Šå†™å•†å“
EXEC   = æ‹¿ç€æ¸…å•å»æ”¶é“¶å°ä¸€æ¬¡æ€§ç»“è´¦
```

### 2.2 åŸºæœ¬ä½¿ç”¨ç¤ºä¾‹


**ğŸ”§ ç®€å•äº‹åŠ¡ç¤ºä¾‹**
```bash
# å¼€å§‹äº‹åŠ¡
MULTI
OK

# æ·»åŠ å‘½ä»¤åˆ°é˜Ÿåˆ—ï¼ˆä¸ä¼šç«‹å³æ‰§è¡Œï¼‰
SET user:123:name "å¼ ä¸‰"
QUEUED

INCR user:123:logincount  
QUEUED

SET user:123:lastlogin "2025-08-28"
QUEUED

# æ‰§è¡Œæ‰€æœ‰å‘½ä»¤
EXEC
1) OK
2) (integer) 1  
3) OK
```

### 2.3 å‘½ä»¤æ’é˜Ÿæœºåˆ¶


**ğŸ”¸ æ’é˜Ÿè¿‡ç¨‹è¯¦è§£**
```
å®¢æˆ·ç«¯çŠ¶æ€å˜åŒ–ï¼š
æ­£å¸¸çŠ¶æ€ â”€â”€MULTIâ”€â”€> äº‹åŠ¡çŠ¶æ€ â”€â”€EXECâ”€â”€> æ­£å¸¸çŠ¶æ€
            â”‚           â”‚
            â–¼           â–¼
        å‘½ä»¤å…¥é˜Ÿ    æ‰¹é‡æ‰§è¡Œ
```

**ğŸ’¡ é‡è¦ç†è§£**ï¼š
- **MULTIå**ï¼šå‘½ä»¤ä¸ç«‹å³æ‰§è¡Œï¼Œè€Œæ˜¯æ”¾å…¥é˜Ÿåˆ—
- **è¿”å›QUEUED**ï¼šè¡¨ç¤ºå‘½ä»¤å·²å…¥é˜Ÿç­‰å¾…
- **EXECæ—¶**ï¼šé˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å‘½ä»¤æŒ‰é¡ºåºæ‰§è¡Œ

**ğŸ”§ é˜Ÿåˆ—çŠ¶æ€æŸ¥çœ‹**
```bash
MULTI
SET key1 "value1"  # å…¥é˜Ÿ
SET key2 "value2"  # å…¥é˜Ÿ
# æ­¤æ—¶key1å’Œkey2è¿˜ä¸å­˜åœ¨

GET key1
# è¿”å›QUEUEDï¼Œè€Œä¸æ˜¯"value1"

EXEC
# ç°åœ¨æ‰çœŸæ­£æ‰§è¡Œï¼Œkey1å’Œkey2æ‰è¢«åˆ›å»º
```

### 2.4 äº‹åŠ¡æ‰§è¡Œç‰¹ç‚¹


**ğŸ”¸ æ‰¹é‡æ‰§è¡Œç‰¹æ€§**
```
æ™®é€šå‘½ä»¤ï¼šä¸€æ¡ä¸€æ¡æ‰§è¡Œï¼Œæ¯æ¡éƒ½æœ‰ç½‘ç»œå¾€è¿”
äº‹åŠ¡å‘½ä»¤ï¼šæ‰“åŒ…ä¸€èµ·æ‰§è¡Œï¼Œå‡å°‘ç½‘ç»œå¼€é”€

æ€§èƒ½å¯¹æ¯”ï¼š
æ™®é€šæ–¹å¼ï¼š100æ¡å‘½ä»¤ = 100æ¬¡ç½‘ç»œå¾€è¿”
äº‹åŠ¡æ–¹å¼ï¼š100æ¡å‘½ä»¤ = 2æ¬¡ç½‘ç»œå¾€è¿”ï¼ˆMULTIå’ŒEXECï¼‰
```

**ğŸ“Š æ‰§è¡Œè¿‡ç¨‹å›¾**
```
å®¢æˆ·ç«¯                    RedisæœåŠ¡å™¨
   â”‚                         â”‚
   â”œâ”€â”€â”€ MULTI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ å¼€å¯äº‹åŠ¡çŠ¶æ€
   â”œâ”€â”€â”€ SET key1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ å‘½ä»¤å…¥é˜Ÿ
   â”œâ”€â”€â”€ INCR counter â”€â”€â”€â”€â”€â”€>â”‚ å‘½ä»¤å…¥é˜Ÿ  
   â”œâ”€â”€â”€ DEL temp â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ å‘½ä»¤å…¥é˜Ÿ
   â”œâ”€â”€â”€ EXEC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ æ‰¹é‡æ‰§è¡Œæ‰€æœ‰å‘½ä»¤
   â”‚<â”€â”€â”€â”€â”€â”€ è¿”å›ç»“æœ â”€â”€â”€â”€â”€â”€â”€â”€â”¤
```

---

## 3. ğŸ‘ï¸ WATCHä¹è§‚é”æœºåˆ¶


### 3.1 ä¹è§‚é”çš„æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯ä¹è§‚é”**
```
æ‚²è§‚é”æ€æƒ³ï¼š"æˆ‘è§‰å¾—ä¼šæœ‰å†²çªï¼Œå…ˆé”ä½å†æ“ä½œ"
ä¹è§‚é”æ€æƒ³ï¼š"æˆ‘è§‰å¾—ä¸ä¼šå†²çªï¼Œæ“ä½œæ—¶å†æ£€æŸ¥"

å°±åƒï¼š
æ‚²è§‚é” = ä¸Šå•æ‰€å…ˆé”é—¨
ä¹è§‚é” = è¿›å»åæ£€æŸ¥æœ‰æ²¡æœ‰äºº
```

**ğŸ’¡ WATCHçš„å·¥ä½œåŸç†**ï¼š
- **ç›‘æ§é”®**ï¼šWATCHå…³æ³¨æŸäº›é”®çš„å˜åŒ–
- **æ£€æµ‹å˜åŒ–**ï¼šEXECæ—¶æ£€æŸ¥è¢«ç›‘æ§çš„é”®æ˜¯å¦è¢«ä¿®æ”¹
- **è‡ªåŠ¨å–æ¶ˆ**ï¼šå¦‚æœæœ‰å˜åŒ–ï¼Œæ•´ä¸ªäº‹åŠ¡è¢«å–æ¶ˆ

### 3.2 WATCHåŸºæœ¬ä½¿ç”¨


**ğŸ”§ åŸºæœ¬è¯­æ³•**
```bash
WATCH key [key ...]  # ç›‘æ§ä¸€ä¸ªæˆ–å¤šä¸ªé”®
# ... äº‹åŠ¡æ“ä½œ ...
```

**ğŸ”§ å®é™…ç¤ºä¾‹**
```bash
# ç›‘æ§ç”¨æˆ·ä½™é¢
WATCH user:123:balance
GET user:123:balance
# å‡è®¾ä½™é¢æ˜¯100

MULTI
# å¦‚æœä½™é¢å¤Ÿï¼Œå°±æ‰£é™¤50
DECRBY user:123:balance 50
SET user:123:lastpurchase "å•†å“A"
EXEC

# å¦‚æœåœ¨EXECå‰ï¼Œå…¶ä»–å®¢æˆ·ç«¯ä¿®æ”¹äº†balance
# è¿™ä¸ªäº‹åŠ¡ä¼šè¢«å–æ¶ˆï¼Œè¿”å›null
```

### 3.3 CASæ“ä½œå®ç°


**ğŸ”¸ CASï¼ˆCompare And Swapï¼‰æ¨¡å¼**
```
CAS = æ¯”è¾ƒå¹¶äº¤æ¢
1. æ¯”è¾ƒï¼šæ£€æŸ¥å€¼æ˜¯å¦å’Œé¢„æœŸä¸€è‡´
2. äº¤æ¢ï¼šä¸€è‡´åˆ™ä¿®æ”¹ï¼Œä¸ä¸€è‡´åˆ™æ”¾å¼ƒ
```

**ğŸ”§ å®ç°å®‰å…¨çš„è®¡æ•°å™¨**
```bash
# å®‰å…¨é€’å¢è®¡æ•°å™¨çš„å®Œæ•´æµç¨‹
def safe_increment(key):
    while True:
        # 1. ç›‘æ§é”®
        WATCH key
        
        # 2. è·å–å½“å‰å€¼
        current_value = GET key
        
        # 3. å¼€å§‹äº‹åŠ¡
        MULTI
        SET key (current_value + 1)
        
        # 4. æ‰§è¡Œäº‹åŠ¡
        result = EXEC
        
        # 5. æ£€æŸ¥ç»“æœ
        if result is not null:
            break  # æˆåŠŸ
        # å¤±è´¥åˆ™é‡è¯•
```

### 3.4 ç›‘æ§å¤šä¸ªé”®


**ğŸ”§ å¤æ‚ä¸šåŠ¡åœºæ™¯**
```bash
# è½¬è´¦æ“ä½œï¼šAç»™Bè½¬100å…ƒ
WATCH account:A:balance account:B:balance

# æ£€æŸ¥Aè´¦æˆ·ä½™é¢
balance_A = GET account:A:balance
if balance_A < 100:
    UNWATCH  # ä½™é¢ä¸è¶³ï¼Œå–æ¶ˆç›‘æ§
    return "ä½™é¢ä¸è¶³"

MULTI
DECRBY account:A:balance 100  # Aæ‰£æ¬¾
INCRBY account:B:balance 100  # Bæ”¶æ¬¾  
EXEC

# å¦‚æœåœ¨EXECå‰ï¼Œä»»ä¸€è´¦æˆ·è¢«å…¶ä»–äººä¿®æ”¹
# äº‹åŠ¡ä¼šè¢«å–æ¶ˆï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§
```

**ğŸ“Š ç›‘æ§çŠ¶æ€å›¾**
```
WATCH account:A â”€â”€â”
                  â”œâ”€â”€> äº‹åŠ¡çŠ¶æ€ç›‘æ§
WATCH account:B â”€â”€â”˜
                  â”‚
å…¶ä»–å®¢æˆ·ç«¯ä¿®æ”¹A â”€â”€â”€â”¼â”€â”€> è§¦å‘ç›‘æ§
                  â”‚
EXEC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€> æ£€æŸ¥å˜åŒ– â”€â”€> å–æ¶ˆäº‹åŠ¡
                  
å¦‚æœæ— å˜åŒ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> æ­£å¸¸æ‰§è¡Œ
```

---

## 4. âŒ DISCARDå–æ¶ˆäº‹åŠ¡


### 4.1 DISCARDçš„ä½œç”¨


**ğŸ”¸ ä»€ä¹ˆæ˜¯DISCARD**
```
DISCARD = æ¸…ç©ºå‘½ä»¤é˜Ÿåˆ—ï¼Œé€€å‡ºäº‹åŠ¡çŠ¶æ€
å°±åƒæ’•æ‰è´­ç‰©æ¸…å•ï¼Œä¸ä¹°äº†
```

**ğŸ’¡ ä½¿ç”¨åœºæ™¯**ï¼š
- **æ¡ä»¶ä¸æ»¡è¶³**ï¼šæ£€æŸ¥å‘ç°ä¸éœ€è¦æ‰§è¡Œäº‹åŠ¡
- **é”™è¯¯æ¢å¤**ï¼šå‘ç°å‘½ä»¤æœ‰è¯¯ï¼Œå–æ¶ˆäº‹åŠ¡
- **å¼‚å¸¸å¤„ç†**ï¼šç¨‹åºå¼‚å¸¸æ—¶çš„æ¸…ç†æ“ä½œ

### 4.2 DISCARDä½¿ç”¨ç¤ºä¾‹


**ğŸ”§ æ¡ä»¶åˆ¤æ–­åœºæ™¯**
```bash
# æ£€æŸ¥åº“å­˜åå†³å®šæ˜¯å¦è´­ä¹°
MULTI
GET product:123:stock
QUEUED

# å‡è®¾é€šè¿‡å…¶ä»–æ–¹å¼æ£€æŸ¥åº“å­˜ä¸è¶³
# å–æ¶ˆè´­ä¹°äº‹åŠ¡
DISCARD
OK

# äº‹åŠ¡çŠ¶æ€ç»“æŸï¼Œå‘½ä»¤é˜Ÿåˆ—æ¸…ç©º
```

**ğŸ”§ é”™è¯¯å¤„ç†åœºæ™¯**
```bash
MULTI
SET user:123:name "å¼ ä¸‰"
QUEUED

# å‘ç°è¾“å…¥äº†é”™è¯¯çš„å‘½ä»¤
SET user:123:age "abc"  # å¹´é¾„åº”è¯¥æ˜¯æ•°å­—
QUEUED

# å‘ç°é”™è¯¯ï¼Œå–æ¶ˆæ•´ä¸ªäº‹åŠ¡
DISCARD
OK

# é‡æ–°å¼€å§‹æ­£ç¡®çš„äº‹åŠ¡
MULTI
SET user:123:name "å¼ ä¸‰"
SET user:123:age "25"
EXEC
```

### 4.3 DISCARD vs EXEC


**ğŸ“Š çŠ¶æ€å¯¹æ¯”**
```
äº‹åŠ¡å‘½ä»¤æ‰§è¡Œè·¯å¾„ï¼š

MULTI â”€â”€> å‘½ä»¤å…¥é˜Ÿ â”€â”€â”¬â”€â”€> EXEC â”€â”€> æ‰§è¡Œå‘½ä»¤
                   â”‚
                   â””â”€â”€> DISCARD â”€â”€> æ¸…ç©ºé˜Ÿåˆ—

ç»“æœå¯¹æ¯”ï¼š
EXECï¼š   è¿”å›æ‰€æœ‰å‘½ä»¤çš„æ‰§è¡Œç»“æœ
DISCARDï¼šè¿”å›OKï¼Œæ‰€æœ‰å‘½ä»¤è¢«ä¸¢å¼ƒ
```

---

## 5. ğŸ”’ äº‹åŠ¡éš”ç¦»ç‰¹æ€§


### 5.1 Redisäº‹åŠ¡çš„éš”ç¦»æ€§


**ğŸ”¸ éš”ç¦»æ€§çš„å«ä¹‰**
```
éš”ç¦»æ€§ = äº‹åŠ¡æ‰§è¡Œæ—¶ä¸è¢«å…¶ä»–æ“ä½œå¹²æ‰°

Redisçš„éš”ç¦»ç‰¹ç‚¹ï¼š
âœ… EXECé˜¶æ®µï¼šå®Œå…¨éš”ç¦»ï¼Œè¿ç»­æ‰§è¡Œ
âŒ MULTIé˜¶æ®µï¼šä¸éš”ç¦»ï¼Œå…¶ä»–å‘½ä»¤å¯ä»¥æ‰§è¡Œ
```

**ğŸ’¡ éš”ç¦»æ€§ç¤ºä¾‹**
```bash
# å®¢æˆ·ç«¯A
MULTI
INCR counter
INCR counter  
# æ­¤æ—¶è¿˜åœ¨æ’é˜ŸçŠ¶æ€

# å®¢æˆ·ç«¯Bï¼ˆå¯ä»¥æ­£å¸¸æ‰§è¡Œï¼‰
GET counter    # èƒ½æ­£å¸¸è·å–å€¼
SET other "value"  # èƒ½æ­£å¸¸è®¾ç½®

# å®¢æˆ·ç«¯Aç»§ç»­
EXEC
# è¿™æ—¶æ‰å¼€å§‹è¿ç»­æ‰§è¡Œï¼Œä¸ä¼šè¢«æ‰“æ–­
```

### 5.2 æ‰§è¡Œé˜¶æ®µçš„åŸå­æ€§


**ğŸ”¸ EXECé˜¶æ®µç‰¹ç‚¹**
```
EXECå¼€å§‹åï¼š
- æ‰€æœ‰å‘½ä»¤è¿ç»­æ‰§è¡Œ
- å…¶ä»–å®¢æˆ·ç«¯å‘½ä»¤è¢«é˜»å¡
- ä¸ä¼šæœ‰äº¤é”™æ‰§è¡Œ
```

**ğŸ“Š æ‰§è¡Œæ—¶åºå›¾**
```
æ—¶é—´è½´    å®¢æˆ·ç«¯A        å®¢æˆ·ç«¯B        RedisçŠ¶æ€
  â”‚       MULTI            â”‚           å¼€å¯äº‹åŠ¡
  â”œâ”€      INCR key         â”‚           å‘½ä»¤å…¥é˜Ÿ
  â”œâ”€      INCR key         â”‚           å‘½ä»¤å…¥é˜Ÿ  
  â”œâ”€      EXEC             â”‚           å¼€å§‹æ‰§è¡Œ
  â”œâ”€        â”‚              SET other   â† è¢«é˜»å¡
  â”œâ”€        â”‚              GET key     â† è¢«é˜»å¡
  â”œâ”€      è¿”å›ç»“æœ          â”‚           æ‰§è¡Œå®Œæˆ
  â””â”€        â”‚              ç»§ç»­æ‰§è¡Œ    â† æ¢å¤å¤„ç†
```

### 5.3 äº‹åŠ¡ä¸ç®¡é“çš„åŒºåˆ«


| ç‰¹æ€§ | **äº‹åŠ¡(MULTI/EXEC)** | **ç®¡é“(Pipeline)** |
|------|---------------------|-------------------|
| **åŸå­æ€§** | âœ… æœ‰ä¿è¯ | âŒ æ— ä¿è¯ |
| **éš”ç¦»æ€§** | âœ… EXECæ—¶éš”ç¦» | âŒ æ— éš”ç¦» |
| **é”™è¯¯å¤„ç†** | éƒ¨åˆ†å‘½ä»¤å¯èƒ½å¤±è´¥ | å„å‘½ä»¤ç‹¬ç«‹ |
| **æ€§èƒ½** | å‡å°‘ç½‘ç»œå¾€è¿” | å‡å°‘ç½‘ç»œå¾€è¿” |
| **ä½¿ç”¨åœºæ™¯** | éœ€è¦ä¸€è‡´æ€§ | ä»…ä¼˜åŒ–æ€§èƒ½ |

---

## 6. âš ï¸ äº‹åŠ¡çš„å±€é™æ€§


### 6.1 è¯­æ³•é”™è¯¯å¤„ç†


**ğŸ”¸ è¯­æ³•é”™è¯¯çš„å½±å“**
```bash
MULTI
SET key1 "value1"     # æ­£ç¡®å‘½ä»¤
INVALID_COMMAND       # è¯­æ³•é”™è¯¯
SET key2 "value2"     # æ­£ç¡®å‘½ä»¤
EXEC

# ç»“æœï¼šæ•´ä¸ªäº‹åŠ¡è¢«å–æ¶ˆï¼Œæ‰€æœ‰å‘½ä»¤éƒ½ä¸æ‰§è¡Œ
# è¿”å›é”™è¯¯ä¿¡æ¯
```

**ğŸ’¡ é”™è¯¯æ£€æµ‹æ—¶æœº**ï¼š
- **å…¥é˜Ÿæ—¶æ£€æµ‹**ï¼šè¯­æ³•é”™è¯¯ä¼šè¢«ç«‹å³å‘ç°
- **æ•´ä½“å–æ¶ˆ**ï¼šæœ‰è¯­æ³•é”™è¯¯æ—¶ï¼ŒEXECä¼šæ‹’ç»æ‰§è¡Œ
- **å…¨éƒ¨å¤±è´¥**ï¼šä¸ä¼šæ‰§è¡Œä»»ä½•å‘½ä»¤

### 6.2 è¿è¡Œæ—¶é”™è¯¯å¤„ç†


**ğŸ”¸ è¿è¡Œæ—¶é”™è¯¯çš„å½±å“**
```bash
MULTI
SET key1 "value1"           # æ‰§è¡ŒæˆåŠŸ
INCR key1                   # è¿è¡Œæ—¶é”™è¯¯ï¼ˆstringä¸èƒ½é€’å¢ï¼‰
SET key2 "value2"           # æ‰§è¡ŒæˆåŠŸ  
EXEC

# ç»“æœï¼š
# 1) OK              (SETæˆåŠŸ)
# 2) é”™è¯¯ä¿¡æ¯         (INCRå¤±è´¥)
# 3) OK              (SETæˆåŠŸ)
```

**ğŸ’¡ éƒ¨åˆ†å¤±è´¥ç‰¹æ€§**ï¼š
- **ä¸ä¼šå›æ»š**ï¼šRedisä¸æ”¯æŒå›æ»šæœºåˆ¶
- **ç»§ç»­æ‰§è¡Œ**ï¼šé”™è¯¯ä¸å½±å“å…¶ä»–å‘½ä»¤
- **éœ€è¦æ£€æŸ¥**ï¼šåº”ç”¨ç¨‹åºéœ€è¦æ£€æŸ¥è¿”å›ç»“æœ

### 6.3 äº‹åŠ¡ä¸æ”¯æŒçš„ç‰¹æ€§


**âŒ ä¸æ”¯æŒåµŒå¥—äº‹åŠ¡**
```bash
MULTI
  MULTI    # é”™è¯¯ï¼ä¸èƒ½åµŒå¥—
  ...
  EXEC
EXEC
```

**âŒ ä¸æ”¯æŒæ¡ä»¶æ‰§è¡Œ**
```bash
# Redisäº‹åŠ¡ä¸æ”¯æŒè¿™æ ·çš„é€»è¾‘
MULTI
IF GET counter > 10 THEN    # ä¸æ”¯æŒæ¡ä»¶è¯­å¥
  INCR counter
ENDIF
EXEC
```

**âŒ ä¸æ”¯æŒå›æ»š**
```bash
# ä¼ ç»Ÿæ•°æ®åº“çš„äº‹åŠ¡
BEGIN
  UPDATE account SET balance = balance - 100 WHERE id = 1
  # å¦‚æœå‡ºé”™å¯ä»¥ ROLLBACK
  UPDATE account SET balance = balance + 100 WHERE id = 2
COMMIT

# Redisæ— æ³•å›æ»šï¼Œéœ€è¦åº”ç”¨ç¨‹åºå¤„ç†
```

---

## 7. ğŸš€ å®é™…åº”ç”¨åœºæ™¯


### 7.1 è´¦æˆ·è½¬è´¦


**ğŸ”¸ å®‰å…¨è½¬è´¦å®ç°**
```python
def transfer_money(from_account, to_account, amount):
    while True:
        # ç›‘æ§ä¸¤ä¸ªè´¦æˆ·
        redis.watch(f"account:{from_account}", f"account:{to_account}")
        
        # æ£€æŸ¥ä½™é¢
        balance = int(redis.get(f"account:{from_account}") or 0)
        if balance < amount:
            redis.unwatch()
            return False, "ä½™é¢ä¸è¶³"
        
        # æ‰§è¡Œè½¬è´¦
        pipe = redis.pipeline()
        pipe.multi()
        pipe.decrby(f"account:{from_account}", amount)
        pipe.incrby(f"account:{to_account}", amount)
        pipe.set(f"transfer:log:{time()}", f"{from_account}->{to_account}:{amount}")
        
        result = pipe.execute()
        if result:  # æˆåŠŸ
            return True, "è½¬è´¦æˆåŠŸ"
        # å¤±è´¥åˆ™é‡è¯•
```

### 7.2 å•†å“ç§’æ€


**ğŸ”¸ é˜²æ­¢è¶…å–çš„ç§’æ€å®ç°**
```python
def seckill_product(product_id, user_id):
    stock_key = f"product:{product_id}:stock"
    
    while True:
        redis.watch(stock_key)
        
        # æ£€æŸ¥åº“å­˜
        stock = int(redis.get(stock_key) or 0)
        if stock <= 0:
            redis.unwatch()
            return False, "å•†å“å·²å”®ç½„"
        
        # æ‰§è¡Œç§’æ€
        pipe = redis.pipeline()
        pipe.multi()
        pipe.decr(stock_key)  # å‡åº“å­˜
        pipe.sadd(f"product:{product_id}:buyers", user_id)  # è®°å½•è´­ä¹°è€…
        pipe.set(f"order:{user_id}:{product_id}", time())   # åˆ›å»ºè®¢å•
        
        result = pipe.execute()
        if result:
            return True, "è´­ä¹°æˆåŠŸ"
        # åº“å­˜è¢«æŠ¢ï¼Œé‡è¯•
```

### 7.3 åˆ†å¸ƒå¼é”


**ğŸ”¸ åŸºäºäº‹åŠ¡çš„åˆ†å¸ƒå¼é”**
```python
def acquire_lock(lock_name, timeout=10):
    identifier = str(uuid.uuid4())
    lock_key = f"lock:{lock_name}"
    
    end = time.time() + timeout
    while time.time() < end:
        # å°è¯•è·å–é”
        if redis.set(lock_key, identifier, nx=True, ex=timeout):
            return identifier
        time.sleep(0.001)
    return False

def release_lock(lock_name, identifier):
    lock_key = f"lock:{lock_name}"
    
    while True:
        redis.watch(lock_key)
        
        # æ£€æŸ¥é”çš„æ‹¥æœ‰è€…
        if redis.get(lock_key) == identifier:
            pipe = redis.pipeline()
            pipe.multi()
            pipe.delete(lock_key)
            result = pipe.execute()
            if result:
                return True
        else:
            redis.unwatch()
            return False
```

### 7.4 è®¡æ•°å™¨æ›´æ–°


**ğŸ”¸ ç½‘ç«™è®¿é—®ç»Ÿè®¡**
```python
def update_page_stats(page_id, user_id):
    page_key = f"page:{page_id}"
    user_key = f"user:{user_id}"
    
    pipe = redis.pipeline()
    pipe.multi()
    
    # æ›´æ–°é¡µé¢è®¿é—®é‡
    pipe.incr(f"{page_key}:views")
    
    # æ›´æ–°ä»Šæ—¥è®¿é—®é‡
    today = datetime.now().strftime("%Y-%m-%d")
    pipe.incr(f"{page_key}:views:{today}")
    
    # è®°å½•ç”¨æˆ·è®¿é—®
    pipe.sadd(f"{page_key}:visitors", user_id)
    pipe.incr(f"{user_key}:page_views")
    
    # æ›´æ–°æœ€åè®¿é—®æ—¶é—´
    pipe.set(f"{page_key}:last_visit", time.time())
    
    pipe.execute()
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ MULTIï¼šå¼€å¯äº‹åŠ¡ï¼Œå‘½ä»¤å¼€å§‹æ’é˜Ÿè€Œä¸æ˜¯æ‰§è¡Œ
ğŸ”¸ EXECï¼šæ‰§è¡Œäº‹åŠ¡ï¼Œæ‰€æœ‰æ’é˜Ÿå‘½ä»¤æ‰¹é‡è¿è¡Œ  
ğŸ”¸ WATCHï¼šä¹è§‚é”æœºåˆ¶ï¼Œç›‘æ§é”®çš„å˜åŒ–
ğŸ”¸ DISCARDï¼šå–æ¶ˆäº‹åŠ¡ï¼Œæ¸…ç©ºå‘½ä»¤é˜Ÿåˆ—
ğŸ”¸ åŸå­æ€§ï¼šEXECé˜¶æ®µæ‰€æœ‰å‘½ä»¤è¿ç»­æ‰§è¡Œï¼Œä¸è¢«æ‰“æ–­
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ Redisäº‹åŠ¡çš„ç‰¹æ®Šæ€§**
```
ä¸ä¼ ç»Ÿæ•°æ®åº“äº‹åŠ¡çš„åŒºåˆ«ï¼š
âœ… æœ‰åŸå­æ€§ï¼šEXECæ—¶æ‰¹é‡æ‰§è¡Œ
âœ… æœ‰éš”ç¦»æ€§ï¼šæ‰§è¡Œæ—¶ä¸è¢«æ‰“æ–­
âŒ æ— å›æ»šæœºåˆ¶ï¼šé”™è¯¯å‘½ä»¤ä¸å½±å“å…¶ä»–å‘½ä»¤
âŒ æ— æ¡ä»¶æ‰§è¡Œï¼šä¸æ”¯æŒif/elseé€»è¾‘
```

**ğŸ”¹ WATCHä¹è§‚é”çš„ä»·å€¼**
```
è§£å†³å¹¶å‘é—®é¢˜ï¼š
- å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶ä¿®æ”¹æ•°æ®
- é¿å…æ•°æ®ä¸ä¸€è‡´
- å®ç°CAS(Compare And Swap)æ¨¡å¼
- æ€§èƒ½æ¯”æ‚²è§‚é”å¥½
```

**ğŸ”¹ äº‹åŠ¡çš„ä¸¤ä¸ªé˜¶æ®µ**
```
æ’é˜Ÿé˜¶æ®µï¼ˆMULTIåï¼‰ï¼š
- å‘½ä»¤ä¸æ‰§è¡Œï¼Œåªæ˜¯å…¥é˜Ÿ
- å…¶ä»–å®¢æˆ·ç«¯å¯ä»¥æ­£å¸¸æ“ä½œ
- å¯ä»¥ç”¨DISCARDå–æ¶ˆ

æ‰§è¡Œé˜¶æ®µï¼ˆEXECæ—¶ï¼‰ï¼š
- æ‰€æœ‰å‘½ä»¤è¿ç»­æ‰§è¡Œ
- å…¶ä»–æ“ä½œè¢«é˜»å¡
- ä¿è¯æ‰§è¡Œçš„åŸå­æ€§
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


**âœ… é€‚åˆä½¿ç”¨äº‹åŠ¡çš„åœºæ™¯**ï¼š
- å¤šä¸ªç›¸å…³æ“ä½œéœ€è¦ä¿æŒä¸€è‡´æ€§
- éœ€è¦æ‰¹é‡æ‰§è¡Œå‡å°‘ç½‘ç»œå¼€é”€  
- éœ€è¦ä¹è§‚é”è§£å†³å¹¶å‘é—®é¢˜
- å¯¹éƒ¨åˆ†å¤±è´¥å¯ä»¥å®¹å¿çš„åœºæ™¯

**âŒ ä¸é€‚åˆä½¿ç”¨äº‹åŠ¡çš„åœºæ™¯**ï¼š
- éœ€è¦æ¡ä»¶åˆ¤æ–­å’Œå¤æ‚é€»è¾‘
- éœ€è¦å›æ»šæœºåˆ¶ä¿è¯æ•°æ®å®‰å…¨
- å•ä¸ªæ“ä½œå·²ç»è¶³å¤ŸåŸå­
- å¯¹é”™è¯¯é›¶å®¹å¿çš„å…³é”®ä¸šåŠ¡

### 8.4 æœ€ä½³å®è·µå»ºè®®


**ğŸ”§ ä½¿ç”¨å»ºè®®**ï¼š
```
1. åˆç†ä½¿ç”¨WATCHé¿å…å¹¶å‘é—®é¢˜
2. æ£€æŸ¥EXECè¿”å›ç»“æœå¤„ç†é”™è¯¯
3. ä¿æŒäº‹åŠ¡ç®€å•ï¼Œé¿å…é•¿äº‹åŠ¡
4. ä½¿ç”¨é‡è¯•æœºåˆ¶å¤„ç†WATCHå¤±è´¥
5. åœ¨äº‹åŠ¡ä¸­é¿å…è€—æ—¶æ“ä½œ
```

**âš¡ æ€§èƒ½ä¼˜åŒ–**ï¼š
```
äº‹åŠ¡ä¼˜åŒ–ï¼š
- å‡å°‘WATCHçš„é”®æ•°é‡
- é¿å…ç›‘æ§çƒ­ç‚¹é”®
- åˆç†è®¾ç½®é‡è¯•æ¬¡æ•°å’Œé—´éš”
- æ‰¹é‡æ“ä½œæ›¿ä»£å¤šæ¬¡äº‹åŠ¡
```

**ğŸ”’ å®‰å…¨è€ƒè™‘**ï¼š
```
æ•°æ®ä¸€è‡´æ€§ï¼š
- æ£€æŸ¥æ‰€æœ‰å‘½ä»¤çš„æ‰§è¡Œç»“æœ
- å¯¹å…³é”®ä¸šåŠ¡å¢åŠ åº”ç”¨å±‚æ£€æŸ¥
- ä½¿ç”¨Luaè„šæœ¬æ›¿ä»£å¤æ‚äº‹åŠ¡
- è€ƒè™‘æœ€ç»ˆä¸€è‡´æ€§è€Œéå¼ºä¸€è‡´æ€§
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- Redisäº‹åŠ¡æä¾›æ‰¹é‡æ‰§è¡Œå’Œç®€å•ä¸€è‡´æ€§
- WATCHå®ç°ä¹è§‚é”è§£å†³å¹¶å‘é—®é¢˜
- äº‹åŠ¡ä¸æ”¯æŒå›æ»šï¼Œéœ€è¦åº”ç”¨å±‚å¤„ç†é”™è¯¯
- é€‚åˆç®€å•çš„åŸå­æ“ä½œï¼Œä¸é€‚åˆå¤æ‚ä¸šåŠ¡é€»è¾‘