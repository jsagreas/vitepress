---
title: 6ã€Rediså‘å¸ƒè®¢é˜…æ¨¡å¼å’ŒStreamæµ
---
## ğŸ“š ç›®å½•

1. [å‘å¸ƒè®¢é˜…åŸºç¡€æ¦‚å¿µ](#1-å‘å¸ƒè®¢é˜…åŸºç¡€æ¦‚å¿µ)
2. [åŸºç¡€Pub/Subå‘½ä»¤](#2-åŸºç¡€PubSubå‘½ä»¤)
3. [æ¨¡å¼åŒ¹é…è®¢é˜…](#3-æ¨¡å¼åŒ¹é…è®¢é˜…)
4. [Redis Streamsæµå¤„ç†](#4-Redis-Streamsæµå¤„ç†)
5. [åº”ç”¨åœºæ™¯è¯¦è§£](#5-åº”ç”¨åœºæ™¯è¯¦è§£)
6. [é™åˆ¶å’Œæ³¨æ„äº‹é¡¹](#6-é™åˆ¶å’Œæ³¨æ„äº‹é¡¹)
7. [å®æˆ˜æ¡ˆä¾‹åˆ†æ](#7-å®æˆ˜æ¡ˆä¾‹åˆ†æ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ å‘å¸ƒè®¢é˜…åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯å‘å¸ƒè®¢é˜…æ¨¡å¼


**ç®€å•ç†è§£**ï¼šå‘å¸ƒè®¢é˜…å°±åƒ**è®¢é˜…æŠ¥çº¸**ä¸€æ ·ã€‚ä½ è®¢é˜…äº†æŸä¸ªé¢‘é“ï¼Œåªè¦è¿™ä¸ªé¢‘é“æœ‰æ–°æ¶ˆæ¯ï¼Œä½ å°±èƒ½ç«‹å³æ”¶åˆ°ã€‚

```
ç”Ÿæ´»ä¸­çš„ä¾‹å­ï¼š
ä½ è®¢é˜…äº†"ç§‘æŠ€æ–°é—»"é¢‘é“
å½“æœ‰ç§‘æŠ€æ–°é—»å‘å¸ƒæ—¶ï¼Œä½ ä¼šè‡ªåŠ¨æ”¶åˆ°æ¨é€

Redisä¸­çš„å‘å¸ƒè®¢é˜…ï¼š
å®¢æˆ·ç«¯Aè®¢é˜…äº†"news"é¢‘é“  
å®¢æˆ·ç«¯Bå‘"news"é¢‘é“å‘å¸ƒæ¶ˆæ¯
å®¢æˆ·ç«¯Aç«‹å³æ”¶åˆ°è¿™æ¡æ¶ˆæ¯
```

### 1.2 æ ¸å¿ƒè§’è‰²å’Œæ¦‚å¿µ


**ğŸ“¡ å‘å¸ƒè€…ï¼ˆPublisherï¼‰**ï¼šå‘é€æ¶ˆæ¯çš„å®¢æˆ·ç«¯
```bash
# å‘å¸ƒè€…å‘é€æ¶ˆæ¯
PUBLISH news "é‡å¤§ç§‘æŠ€æ–°é—»ï¼šAIæŠ€æœ¯çªç ´"
```

**ğŸ“» è®¢é˜…è€…ï¼ˆSubscriberï¼‰**ï¼šæ¥æ”¶æ¶ˆæ¯çš„å®¢æˆ·ç«¯
```bash  
# è®¢é˜…è€…è®¢é˜…é¢‘é“
SUBSCRIBE news
```

**ğŸ“º é¢‘é“ï¼ˆChannelï¼‰**ï¼šæ¶ˆæ¯ä¼ è¾“çš„é€šé“
```bash
# é¢‘é“åç§°å¯ä»¥æ˜¯ä»»æ„å­—ç¬¦ä¸²
news          # æ–°é—»é¢‘é“
chat:room1    # èŠå¤©å®¤1
user:1001     # ç”¨æˆ·1001çš„ç§äººé¢‘é“
```

### 1.3 å‘å¸ƒè®¢é˜…çš„å·¥ä½œæœºåˆ¶


```
å·¥ä½œæµç¨‹å›¾ï¼š

å‘å¸ƒè€…                  RedisæœåŠ¡å™¨                è®¢é˜…è€…ä»¬
  |                        |                       |
  |--[PUBLISH]------------->|                       |
  |   é¢‘é“:æ¶ˆæ¯              |--[æ¶ˆæ¯æ¨é€]----------->|è®¢é˜…è€…1
  |                        |--[æ¶ˆæ¯æ¨é€]----------->|è®¢é˜…è€…2  
  |                        |--[æ¶ˆæ¯æ¨é€]----------->|è®¢é˜…è€…3
  |                        |                       |

ç‰¹ç‚¹ï¼š
1. å‘å¸ƒè€…ä¸éœ€è¦çŸ¥é“æœ‰è°åœ¨è®¢é˜…
2. è®¢é˜…è€…ä¸éœ€è¦çŸ¥é“æ¶ˆæ¯æ¥è‡ªè°
3. æ¶ˆæ¯æ˜¯å®æ—¶æ¨é€çš„
4. æ¶ˆæ¯ä¸ä¼šè¢«å­˜å‚¨ï¼ˆå‘å®Œå°±æ²¡äº†ï¼‰
```

### 1.4 ä¸ä¼ ç»Ÿæ¶ˆæ¯ä¼ é€’çš„åŒºåˆ«


| ç‰¹æ€§ | **ä¼ ç»Ÿç‚¹å¯¹ç‚¹** | **å‘å¸ƒè®¢é˜…** |
|------|-------------|------------|
| **æ¶ˆæ¯æ¥æ”¶è€…** | `æŒ‡å®šçš„æ¥æ”¶è€…` | `æ‰€æœ‰è®¢é˜…è€…` |
| **è€¦åˆç¨‹åº¦** | `å‘é€è€…éœ€è¦çŸ¥é“æ¥æ”¶è€…` | `å‘é€è€…å’Œæ¥æ”¶è€…äº’ä¸çŸ¥é“` |
| **æ¶ˆæ¯å­˜å‚¨** | `é€šå¸¸ä¼šå­˜å‚¨` | `ä¸å­˜å‚¨ï¼Œå®æ—¶æ¨é€` |
| **æ‰©å±•æ€§** | `æ·»åŠ æ¥æ”¶è€…éœ€è¦ä¿®æ”¹å‘é€è€…` | `ä»»æ„æ·»åŠ è®¢é˜…è€…` |

---

## 2. âš™ï¸ åŸºç¡€Pub/Subå‘½ä»¤


### 2.1 è®¢é˜…é¢‘é“ - SUBSCRIBE


**ğŸ”¸ åŸºæœ¬è¯­æ³•**
```bash
SUBSCRIBE channel1 [channel2 ...]
```

**ğŸ”¸ å®é™…æ“ä½œæ¼”ç¤º**
```bash
# ç»ˆç«¯1ï¼šè®¢é˜…è€…
SUBSCRIBE news sports tech
# è¿›å…¥è®¢é˜…æ¨¡å¼ï¼Œç­‰å¾…æ¶ˆæ¯

# è¿”å›ä¿¡æ¯ï¼š
1) "subscribe"     # æ“ä½œç±»å‹
2) "news"          # é¢‘é“å
3) (integer) 1     # å½“å‰è®¢é˜…çš„é¢‘é“æ•°

1) "subscribe"
2) "sports"  
3) (integer) 2

1) "subscribe"
2) "tech"
3) (integer) 3
```

### 2.2 å‘å¸ƒæ¶ˆæ¯ - PUBLISH


**ğŸ”¸ åŸºæœ¬è¯­æ³•**
```bash
PUBLISH channel message
```

**ğŸ”¸ å®é™…æ“ä½œæ¼”ç¤º**
```bash
# ç»ˆç«¯2ï¼šå‘å¸ƒè€…
PUBLISH news "ä»Šæ—¥å¤´æ¡ï¼šRedis 7.0æ­£å¼å‘å¸ƒ"
# è¿”å›ï¼š(integer) 1  è¡¨ç¤ºæœ‰1ä¸ªå®¢æˆ·ç«¯æ”¶åˆ°æ¶ˆæ¯

PUBLISH sports "NBAæ€»å†³èµ›å¼€å§‹"
# è¿”å›ï¼š(integer) 1

PUBLISH tech "AIæŠ€æœ¯æ–°çªç ´"
# è¿”å›ï¼š(integer) 1
```

**ğŸ”¸ è®¢é˜…è€…æ”¶åˆ°çš„æ¶ˆæ¯æ ¼å¼**
```bash
# ç»ˆç«¯1æ”¶åˆ°çš„æ¶ˆæ¯ï¼š
1) "message"                          # æ¶ˆæ¯ç±»å‹
2) "news"                            # é¢‘é“å
3) "ä»Šæ—¥å¤´æ¡ï¼šRedis 7.0æ­£å¼å‘å¸ƒ"        # æ¶ˆæ¯å†…å®¹

1) "message"
2) "sports"  
3) "NBAæ€»å†³èµ›å¼€å§‹"

1) "message"
2) "tech"
3) "AIæŠ€æœ¯æ–°çªç ´"
```

### 2.3 å–æ¶ˆè®¢é˜… - UNSUBSCRIBE


**ğŸ”¸ åŸºæœ¬è¯­æ³•**
```bash
UNSUBSCRIBE [channel1] [channel2 ...]
```

**ğŸ”¸ å®é™…æ“ä½œ**
```bash
# å–æ¶ˆè®¢é˜…æŒ‡å®šé¢‘é“
UNSUBSCRIBE news
# è¿”å›ï¼š
1) "unsubscribe"
2) "news"
3) (integer) 2     # å‰©ä½™è®¢é˜…é¢‘é“æ•°

# å–æ¶ˆæ‰€æœ‰è®¢é˜…
UNSUBSCRIBE
# é€€å‡ºè®¢é˜…æ¨¡å¼
```

### 2.4 æŸ¥çœ‹é¢‘é“ä¿¡æ¯


**ğŸ”¸ æŸ¥çœ‹æ´»è·ƒé¢‘é“**
```bash
# æŸ¥çœ‹è‡³å°‘æœ‰ä¸€ä¸ªè®¢é˜…è€…çš„é¢‘é“
PUBSUB CHANNELS
# è¿”å›æ‰€æœ‰æ´»è·ƒé¢‘é“åˆ—è¡¨

# æŸ¥çœ‹åŒ¹é…æ¨¡å¼çš„é¢‘é“
PUBSUB CHANNELS news*
# è¿”å›ä»¥"news"å¼€å¤´çš„æ´»è·ƒé¢‘é“
```

**ğŸ”¸ æŸ¥çœ‹é¢‘é“è®¢é˜…æ•°**
```bash
# æŸ¥çœ‹æŒ‡å®šé¢‘é“çš„è®¢é˜…è€…æ•°é‡
PUBSUB NUMSUB news sports
# è¿”å›ï¼š
1) "news"
2) (integer) 2     # newsé¢‘é“æœ‰2ä¸ªè®¢é˜…è€…
3) "sports"  
4) (integer) 1     # sportsé¢‘é“æœ‰1ä¸ªè®¢é˜…è€…
```

---

## 3. ğŸ” æ¨¡å¼åŒ¹é…è®¢é˜…


### 3.1 æ¨¡å¼è®¢é˜… - PSUBSCRIBE


**ğŸ”¸ åŸºæœ¬æ¦‚å¿µ**
æ¨¡å¼è®¢é˜…å…è®¸ä½ ç”¨**é€šé…ç¬¦**è®¢é˜…å¤šä¸ªé¢‘é“ï¼Œå°±åƒæ–‡ä»¶ç³»ç»Ÿçš„é€šé…ç¬¦ä¸€æ ·ã€‚

```bash
# åŸºæœ¬è¯­æ³•
PSUBSCRIBE pattern1 [pattern2 ...]

# æ”¯æŒçš„é€šé…ç¬¦ï¼š
*     # åŒ¹é…ä»»æ„å­—ç¬¦
?     # åŒ¹é…å•ä¸ªå­—ç¬¦  
[abc] # åŒ¹é…æŒ‡å®šå­—ç¬¦ä¸­çš„ä»»æ„ä¸€ä¸ª
```

**ğŸ”¸ å®é™…ä½¿ç”¨ç¤ºä¾‹**
```bash
# ç»ˆç«¯1ï¼šæ¨¡å¼è®¢é˜…
PSUBSCRIBE news:*
# è®¢é˜…æ‰€æœ‰ä»¥"news:"å¼€å¤´çš„é¢‘é“

PSUBSCRIBE chat:room:*  
# è®¢é˜…æ‰€æœ‰èŠå¤©å®¤é¢‘é“

PSUBSCRIBE user:*:notification
# è®¢é˜…æ‰€æœ‰ç”¨æˆ·çš„é€šçŸ¥é¢‘é“
```

**ğŸ”¸ å‘å¸ƒæ¶ˆæ¯åˆ°æ¨¡å¼åŒ¹é…çš„é¢‘é“**
```bash
# ç»ˆç«¯2ï¼šå‘å¸ƒæ¶ˆæ¯
PUBLISH news:tech "æŠ€æœ¯æ–°é—»"
PUBLISH news:sports "ä½“è‚²æ–°é—»"  
PUBLISH chat:room:101 "èŠå¤©æ¶ˆæ¯"
PUBLISH user:1001:notification "ç”¨æˆ·é€šçŸ¥"
```

**ğŸ”¸ è®¢é˜…è€…æ¥æ”¶åˆ°çš„æ¶ˆæ¯**
```bash
# æ¨¡å¼è®¢é˜…æ”¶åˆ°çš„æ¶ˆæ¯æ ¼å¼ï¼š
1) "pmessage"              # æ¨¡å¼æ¶ˆæ¯ç±»å‹
2) "news:*"                # åŒ¹é…çš„æ¨¡å¼
3) "news:tech"             # å®é™…é¢‘é“å
4) "æŠ€æœ¯æ–°é—»"               # æ¶ˆæ¯å†…å®¹

1) "pmessage"
2) "news:*"
3) "news:sports"
4) "ä½“è‚²æ–°é—»"
```

### 3.2 æ¨¡å¼è®¢é˜…çš„é«˜çº§ç”¨æ³•


**ğŸ”¸ å¤šå±‚çº§æ¨¡å¼åŒ¹é…**
```bash
# è®¢é˜…å¤šå±‚çº§ç»“æ„
PSUBSCRIBE app:*:*:log
# åŒ¹é…ï¼šapp:web:error:log, app:api:info:log ç­‰

# è®¢é˜…ç”¨æˆ·ç›¸å…³çš„æ‰€æœ‰é¢‘é“
PSUBSCRIBE user:*
# åŒ¹é…ï¼šuser:1001, user:login, user:logout ç­‰
```

**ğŸ”¸ å¤æ‚æ¨¡å¼ç»„åˆ**
```bash
# åŒæ—¶è®¢é˜…å¤šç§æ¨¡å¼
PSUBSCRIBE order:* payment:* notification:*

# é’ˆå¯¹ç‰¹å®šç”¨æˆ·ç»„çš„é€šçŸ¥
PSUBSCRIBE vip:user:*:alert
PSUBSCRIBE normal:user:*:info
```

### 3.3 å–æ¶ˆæ¨¡å¼è®¢é˜… - PUNSUBSCRIBE


**ğŸ”¸ åŸºæœ¬æ“ä½œ**
```bash
# å–æ¶ˆæŒ‡å®šæ¨¡å¼è®¢é˜…
PUNSUBSCRIBE news:*

# å–æ¶ˆæ‰€æœ‰æ¨¡å¼è®¢é˜…
PUNSUBSCRIBE
```

### 3.4 æ¨¡å¼è®¢é˜…çš„å®é™…åº”ç”¨


**ğŸ“Š æ—¥å¿—æ”¶é›†ç³»ç»Ÿ**
```bash
# è®¢é˜…æ‰€æœ‰æœåŠ¡çš„é”™è¯¯æ—¥å¿—
PSUBSCRIBE *:error:*

# è®¢é˜…ç‰¹å®šç¯å¢ƒçš„æ—¥å¿—
PSUBSCRIBE prod:*:log
PSUBSCRIBE dev:*:log
```

**ğŸ‘¥ ç”¨æˆ·é€šçŸ¥ç³»ç»Ÿ**
```bash
# è®¢é˜…VIPç”¨æˆ·çš„æ‰€æœ‰é€šçŸ¥
PSUBSCRIBE vip:*:*

# è®¢é˜…ç‰¹å®šç±»å‹çš„é€šçŸ¥
PSUBSCRIBE *:order:*
PSUBSCRIBE *:payment:*
```

---

## 4. ğŸŒŠ Redis Streamsæµå¤„ç†


### 4.1 ä¸ºä»€ä¹ˆéœ€è¦Streams


**ğŸ¤” Pub/Subçš„é—®é¢˜**ï¼š
```
1. æ¶ˆæ¯ä¸æŒä¹…åŒ– - å‘é€å®Œå°±æ²¡äº†
2. è®¢é˜…è€…ç¦»çº¿æ—¶ä¼šä¸¢å¤±æ¶ˆæ¯
3. æ— æ³•é‡å¤æ¶ˆè´¹æ¶ˆæ¯
4. æ²¡æœ‰æ¶ˆæ¯ç¡®è®¤æœºåˆ¶
```

**ğŸ’¡ Streamsçš„ä¼˜åŠ¿**ï¼š
```
1. æ¶ˆæ¯æŒä¹…åŒ–å­˜å‚¨
2. æ”¯æŒæ¶ˆè´¹è€…ç»„
3. æ¶ˆæ¯å¯ä»¥é‡å¤æ¶ˆè´¹  
4. æœ‰æ¶ˆæ¯ç¡®è®¤æœºåˆ¶
5. æ”¯æŒæ¶ˆæ¯å›æº¯
```

### 4.2 æ·»åŠ æ¶ˆæ¯åˆ°æµ - XADD


**ğŸ”¸ åŸºæœ¬è¯­æ³•**
```bash
XADD stream_name ID field1 value1 [field2 value2 ...]
```

**ğŸ”¸ å®é™…æ“ä½œç¤ºä¾‹**
```bash
# è‡ªåŠ¨ç”ŸæˆIDæ·»åŠ æ¶ˆæ¯
XADD orders * user_id 1001 product "iPhone" amount 8999 status "pending"
# è¿”å›ï¼š1642581234567-0  (æ—¶é—´æˆ³-åºå·)

# æŒ‡å®šIDæ·»åŠ æ¶ˆæ¯
XADD orders 1642581234568-0 user_id 1002 product "iPad" amount 5999 status "paid"

# æ·»åŠ å¤šä¸ªå­—æ®µ
XADD logs * level "error" service "payment" message "è¿æ¥è¶…æ—¶" timestamp 1642581234
```

### 4.3 è¯»å–æµæ¶ˆæ¯ - XREAD


**ğŸ”¸ åŸºæœ¬è¯­æ³•**
```bash
XREAD [COUNT count] [BLOCK milliseconds] STREAMS key1 [key2 ...] ID1 [ID2 ...]
```

**ğŸ”¸ è¯»å–æ“ä½œç¤ºä¾‹**
```bash
# ä»æµå¼€å§‹è¯»å–æ‰€æœ‰æ¶ˆæ¯
XREAD STREAMS orders 0
# è¿”å›æ‰€æœ‰æ¶ˆæ¯

# ä»æŒ‡å®šIDåè¯»å–æ–°æ¶ˆæ¯
XREAD STREAMS orders 1642581234567-0
# è¿”å›IDä¹‹åçš„æ¶ˆæ¯

# é˜»å¡ç­‰å¾…æ–°æ¶ˆæ¯ï¼ˆç±»ä¼¼è®¢é˜…ï¼‰
XREAD BLOCK 0 STREAMS orders $
# $è¡¨ç¤ºåªè¯»å–æ–°æ¶ˆæ¯ï¼ŒBLOCK 0è¡¨ç¤ºæ°¸ä¹…é˜»å¡
```

**ğŸ”¸ è¿”å›çš„æ¶ˆæ¯æ ¼å¼**
```bash
1) 1) "orders"                          # æµåç§°
   2) 1) 1) "1642581234567-0"           # æ¶ˆæ¯ID
         2) 1) "user_id"                # å­—æ®µ1
            2) "1001"                   # å€¼1  
            3) "product"                # å­—æ®µ2
            4) "iPhone"                 # å€¼2
            5) "amount"                 # å­—æ®µ3
            6) "8999"                   # å€¼3
```

### 4.4 æ¶ˆè´¹è€…ç»„ - Consumer Groups


**ğŸ”¸ æ¶ˆè´¹è€…ç»„çš„æ¦‚å¿µ**
æ¶ˆè´¹è€…ç»„å°±åƒ**å›¢é˜Ÿåˆä½œ**ï¼Œå¤šä¸ªæ¶ˆè´¹è€…å…±åŒå¤„ç†ä¸€ä¸ªæµä¸­çš„æ¶ˆæ¯ï¼Œæ¯æ¡æ¶ˆæ¯åªä¼šè¢«ç»„å†…çš„ä¸€ä¸ªæ¶ˆè´¹è€…å¤„ç†ã€‚

```
æ¶ˆè´¹è€…ç»„å·¥ä½œç¤ºä¾‹ï¼š

æµ: orders
â”œâ”€â”€ æ¶ˆæ¯1 â†’ æ¶ˆè´¹è€…Aå¤„ç†
â”œâ”€â”€ æ¶ˆæ¯2 â†’ æ¶ˆè´¹è€…Bå¤„ç†  
â”œâ”€â”€ æ¶ˆæ¯3 â†’ æ¶ˆè´¹è€…Cå¤„ç†
â””â”€â”€ æ¶ˆæ¯4 â†’ æ¶ˆè´¹è€…Aå¤„ç†

ç‰¹ç‚¹ï¼šè´Ÿè½½å‡è¡¡ï¼Œä¸ä¼šé‡å¤å¤„ç†
```

**ğŸ”¸ åˆ›å»ºæ¶ˆè´¹è€…ç»„**
```bash
# åˆ›å»ºæ¶ˆè´¹è€…ç»„
XGROUP CREATE orders order_processors 0 MKSTREAM
# orders: æµåç§°
# order_processors: æ¶ˆè´¹è€…ç»„åç§°  
# 0: ä»å¤´å¼€å§‹æ¶ˆè´¹
# MKSTREAM: å¦‚æœæµä¸å­˜åœ¨åˆ™åˆ›å»º
```

**ğŸ”¸ æ¶ˆè´¹è€…ç»„è¯»å–æ¶ˆæ¯ - XREADGROUP**
```bash
# åŸºæœ¬è¯­æ³•
XREADGROUP GROUP group_name consumer_name [COUNT count] [BLOCK milliseconds] STREAMS key1 [key2 ...] ID1 [ID2 ...]

# å®é™…æ“ä½œ
XREADGROUP GROUP order_processors consumer1 COUNT 1 STREAMS orders >
# >è¡¨ç¤ºè¯»å–æœªè¢«ç»„å†…æ¶ˆè´¹çš„æ¶ˆæ¯

XREADGROUP GROUP order_processors consumer2 COUNT 2 STREAMS orders >
```

### 4.5 æ¶ˆæ¯ç¡®è®¤å’Œé‡è¯•æœºåˆ¶


**ğŸ”¸ æ¶ˆæ¯ç¡®è®¤ - XACK**
```bash
# ç¡®è®¤æ¶ˆæ¯å·²å¤„ç†
XACK orders order_processors 1642581234567-0
# è¿”å›ï¼š(integer) 1  è¡¨ç¤ºç¡®è®¤æˆåŠŸ
```

**ğŸ”¸ æŸ¥çœ‹å¾…ç¡®è®¤æ¶ˆæ¯**
```bash
# æŸ¥çœ‹æ¶ˆè´¹è€…çš„å¾…ç¡®è®¤æ¶ˆæ¯åˆ—è¡¨
XPENDING orders order_processors
# è¿”å›å¾…ç¡®è®¤æ¶ˆæ¯çš„ç»Ÿè®¡ä¿¡æ¯

# æŸ¥çœ‹å…·ä½“çš„å¾…ç¡®è®¤æ¶ˆæ¯
XPENDING orders order_processors - + 10 consumer1
```

**ğŸ”¸ æ¶ˆæ¯é‡æ–°åˆ†é…**
```bash
# å°†è¶…æ—¶æœªç¡®è®¤çš„æ¶ˆæ¯åˆ†é…ç»™å…¶ä»–æ¶ˆè´¹è€…
XCLAIM orders order_processors consumer2 30000 1642581234567-0
# 30000: è¶…æ—¶æ—¶é—´(æ¯«ç§’)
```

### 4.6 Streamsçš„å®é™…åº”ç”¨æ¨¡å¼


**ğŸ“¦ è®¢å•å¤„ç†ç³»ç»Ÿ**
```python
import redis

r = redis.Redis()

# ç”Ÿäº§è€…ï¼šæ·»åŠ è®¢å•
def add_order(user_id, product, amount):
    r.xadd('orders', {
        'user_id': user_id,
        'product': product, 
        'amount': amount,
        'status': 'pending',
        'created_at': time.time()
    })

# æ¶ˆè´¹è€…ï¼šå¤„ç†è®¢å•
def process_orders():
    # åˆ›å»ºæ¶ˆè´¹è€…ç»„
    try:
        r.xgroup_create('orders', 'processors', id='0', mkstream=True)
    except:
        pass  # ç»„å·²å­˜åœ¨
    
    while True:
        # è¯»å–æ¶ˆæ¯
        messages = r.xreadgroup(
            'processors', 'worker1', 
            {'orders': '>'}, 
            count=1, block=1000
        )
        
        for stream, msgs in messages:
            for msg_id, fields in msgs:
                # å¤„ç†è®¢å•é€»è¾‘
                process_single_order(fields)
                
                # ç¡®è®¤æ¶ˆæ¯
                r.xack('orders', 'processors', msg_id)
```

---

## 5. ğŸš€ åº”ç”¨åœºæ™¯è¯¦è§£


### 5.1 å®æ—¶æ¶ˆæ¯æ¨é€


**ğŸ“± ç§»åŠ¨ç«¯æ¨é€ç³»ç»Ÿ**
```bash
# ç”¨æˆ·ä¸Šçº¿æ—¶è®¢é˜…ä¸ªäººæ¨é€é¢‘é“
SUBSCRIBE user:1001:push

# ç³»ç»Ÿå‘ç‰¹å®šç”¨æˆ·æ¨é€æ¶ˆæ¯
PUBLISH user:1001:push "æ‚¨æœ‰æ–°çš„è®¢å•æ¶ˆæ¯"
PUBLISH user:1001:push "æ‚¨çš„å¿«é€’å·²å‘è´§"

# ç¾¤ç»„æ¨é€
PUBLISH group:vip:notifications "VIPç”¨æˆ·ä¸“äº«æ´»åŠ¨å¼€å§‹"
```

**ğŸ”” ç³»ç»Ÿé€šçŸ¥æ¶æ„**
```python
# é€šçŸ¥å‘é€æœåŠ¡
class NotificationService:
    def __init__(self):
        self.redis = redis.Redis()
    
    def send_to_user(self, user_id, message):
        # å‘é€ç»™ç‰¹å®šç”¨æˆ·
        self.redis.publish(f'user:{user_id}:notifications', message)
    
    def send_to_group(self, group, message):
        # å‘é€ç»™ç”¨æˆ·ç»„
        self.redis.publish(f'group:{group}:notifications', message)
    
    def broadcast(self, message):
        # å…¨ç«™å¹¿æ’­
        self.redis.publish('global:notifications', message)

# å®¢æˆ·ç«¯è®¢é˜…æœåŠ¡
class NotificationClient:
    def __init__(self, user_id):
        self.redis = redis.Redis()
        self.user_id = user_id
        
    def listen(self):
        pubsub = self.redis.pubsub()
        # è®¢é˜…ä¸ªäººé€šçŸ¥
        pubsub.subscribe(f'user:{self.user_id}:notifications')
        # è®¢é˜…å…¨å±€é€šçŸ¥
        pubsub.subscribe('global:notifications')
        
        for message in pubsub.listen():
            if message['type'] == 'message':
                self.handle_notification(message['data'])
```

### 5.2 èŠå¤©å®¤ç³»ç»Ÿ


**ğŸ’¬ èŠå¤©å®¤å®Œæ•´å®ç°**
```python
class ChatRoom:
    def __init__(self, room_id):
        self.redis = redis.Redis()
        self.room_id = room_id
        self.channel = f'chat:room:{room_id}'
    
    def join_room(self, user_id, username):
        # ç”¨æˆ·åŠ å…¥æˆ¿é—´
        self.redis.sadd(f'room:{self.room_id}:users', user_id)
        
        # å¹¿æ’­åŠ å…¥æ¶ˆæ¯
        join_msg = {
            'type': 'join',
            'user_id': user_id,
            'username': username,
            'message': f'{username} åŠ å…¥äº†èŠå¤©å®¤',
            'timestamp': time.time()
        }
        self.redis.publish(self.channel, json.dumps(join_msg))
    
    def send_message(self, user_id, username, message):
        # å‘é€èŠå¤©æ¶ˆæ¯
        chat_msg = {
            'type': 'message',
            'user_id': user_id, 
            'username': username,
            'message': message,
            'timestamp': time.time()
        }
        
        # ä¿å­˜èŠå¤©è®°å½•åˆ°Streamï¼ˆå¯å›æº¯ï¼‰
        self.redis.xadd(f'chat:history:{self.room_id}', chat_msg)
        
        # å®æ—¶æ¨é€ç»™åœ¨çº¿ç”¨æˆ·
        self.redis.publish(self.channel, json.dumps(chat_msg))
    
    def leave_room(self, user_id, username):
        # ç”¨æˆ·ç¦»å¼€æˆ¿é—´
        self.redis.srem(f'room:{self.room_id}:users', user_id)
        
        leave_msg = {
            'type': 'leave',
            'user_id': user_id,
            'username': username, 
            'message': f'{username} ç¦»å¼€äº†èŠå¤©å®¤',
            'timestamp': time.time()
        }
        self.redis.publish(self.channel, json.dumps(leave_msg))

# å®¢æˆ·ç«¯ç›‘å¬å™¨
class ChatClient:
    def __init__(self, user_id, username):
        self.redis = redis.Redis()
        self.user_id = user_id
        self.username = username
        self.current_room = None
    
    def join_room(self, room_id):
        if self.current_room:
            self.leave_current_room()
            
        self.current_room = room_id
        self.pubsub = self.redis.pubsub()
        self.pubsub.subscribe(f'chat:room:{room_id}')
        
        # é€šçŸ¥æœåŠ¡å™¨ç”¨æˆ·åŠ å…¥
        chat_room = ChatRoom(room_id)
        chat_room.join_room(self.user_id, self.username)
        
        # å¼€å§‹ç›‘å¬æ¶ˆæ¯
        self.listen()
    
    def listen(self):
        for message in self.pubsub.listen():
            if message['type'] == 'message':
                msg_data = json.loads(message['data'])
                self.handle_message(msg_data)
    
    def handle_message(self, msg_data):
        msg_type = msg_data['type']
        if msg_type == 'message':
            print(f"[{msg_data['username']}]: {msg_data['message']}")
        elif msg_type == 'join':
            print(f"ğŸŸ¢ {msg_data['message']}")
        elif msg_type == 'leave':
            print(f"ğŸ”´ {msg_data['message']}")
```

### 5.3 äº‹ä»¶é©±åŠ¨æ¶æ„


**ğŸ—ï¸ å¾®æœåŠ¡äº‹ä»¶æ€»çº¿**
```python
# äº‹ä»¶å‘å¸ƒå™¨
class EventBus:
    def __init__(self):
        self.redis = redis.Redis()
    
    def publish_event(self, event_type, event_data):
        event = {
            'type': event_type,
            'data': event_data,
            'timestamp': time.time(),
            'event_id': str(uuid.uuid4())
        }
        
        # å‘å¸ƒåˆ°å¯¹åº”é¢‘é“
        self.redis.publish(f'events:{event_type}', json.dumps(event))
        
        # åŒæ—¶ä¿å­˜åˆ°Streamç”¨äºå†å²æŸ¥è¯¢
        self.redis.xadd('events:all', event)

# è®¢å•æœåŠ¡
class OrderService:
    def __init__(self):
        self.event_bus = EventBus()
    
    def create_order(self, order_data):
        # åˆ›å»ºè®¢å•é€»è¾‘
        order = self.save_order(order_data)
        
        # å‘å¸ƒè®¢å•åˆ›å»ºäº‹ä»¶
        self.event_bus.publish_event('order.created', {
            'order_id': order.id,
            'user_id': order.user_id,
            'amount': order.amount
        })

# åº“å­˜æœåŠ¡
class InventoryService:
    def __init__(self):
        self.redis = redis.Redis()
        self.setup_listeners()
    
    def setup_listeners(self):
        pubsub = self.redis.pubsub()
        # ç›‘å¬è®¢å•äº‹ä»¶
        pubsub.subscribe('events:order.created')
        
        for message in pubsub.listen():
            if message['type'] == 'message':
                event = json.loads(message['data'])
                self.handle_order_created(event['data'])
    
    def handle_order_created(self, order_data):
        # å‡å°‘åº“å­˜é€»è¾‘
        self.reduce_inventory(order_data['product_id'], order_data['quantity'])
        
        # å‘å¸ƒåº“å­˜æ›´æ–°äº‹ä»¶
        event_bus = EventBus()
        event_bus.publish_event('inventory.updated', order_data)

# é€šçŸ¥æœåŠ¡
class NotificationService:
    def __init__(self):
        self.redis = redis.Redis()
        self.setup_listeners()
    
    def setup_listeners(self):
        pubsub = self.redis.pubsub()
        # ä½¿ç”¨æ¨¡å¼è®¢é˜…ç›‘å¬æ‰€æœ‰äº‹ä»¶
        pubsub.psubscribe('events:*')
        
        for message in pubsub.listen():
            if message['type'] == 'pmessage':
                event = json.loads(message['data'])
                self.handle_event(event)
    
    def handle_event(self, event):
        event_type = event['type']
        if event_type == 'order.created':
            self.send_order_confirmation(event['data'])
        elif event_type == 'inventory.low':
            self.send_inventory_alert(event['data'])
```

---

## 6. âš ï¸ é™åˆ¶å’Œæ³¨æ„äº‹é¡¹


### 6.1 æ¶ˆæ¯ä¸¢å¤±é—®é¢˜


**ğŸš¨ Pub/Subæ¶ˆæ¯ä¸¢å¤±åœºæ™¯**
```bash
# åœºæ™¯1ï¼šè®¢é˜…è€…æœªè¿æ¥
PUBLISH news "é‡è¦æ¶ˆæ¯"  # å¦‚æœæ²¡æœ‰è®¢é˜…è€…ï¼Œæ¶ˆæ¯ä¸¢å¤±

# åœºæ™¯2ï¼šç½‘ç»œæ–­å¼€
# å®¢æˆ·ç«¯ç½‘ç»œæ–­å¼€æœŸé—´çš„æ¶ˆæ¯å…¨éƒ¨ä¸¢å¤±

# åœºæ™¯3ï¼šå®¢æˆ·ç«¯ç¼“å†²åŒºæ»¡
# Rediså®¢æˆ·ç«¯è¾“å‡ºç¼“å†²åŒºæ»¡æ—¶ä¼šæ–­å¼€è¿æ¥ï¼Œæ¶ˆæ¯ä¸¢å¤±
```

**ğŸ’¡ è§£å†³æ¶ˆæ¯ä¸¢å¤±çš„æ–¹æ¡ˆ**
```python
# æ–¹æ¡ˆ1ï¼šåŒå†™æœºåˆ¶ï¼ˆPub/Sub + Listï¼‰
def reliable_publish(channel, message):
    # å‘å¸ƒå®æ—¶æ¶ˆæ¯
    redis.publish(channel, message)
    
    # åŒæ—¶ä¿å­˜åˆ°Listä½œä¸ºå¤‡ä»½
    redis.lpush(f'{channel}:backup', message)
    redis.ltrim(f'{channel}:backup', 0, 1000)  # ä¿ç•™æœ€è¿‘1000æ¡

# æ–¹æ¡ˆ2ï¼šä½¿ç”¨Streamsæ›¿ä»£
def reliable_publish_stream(stream, message):
    # Streamsä¼šæŒä¹…åŒ–æ¶ˆæ¯
    redis.xadd(stream, message)

# æ–¹æ¡ˆ3ï¼šæ¶ˆæ¯ç¡®è®¤æœºåˆ¶
class ReliablePubSub:
    def publish_with_ack(self, channel, message):
        msg_id = str(uuid.uuid4())
        msg_with_id = {
            'id': msg_id,
            'content': message,
            'timestamp': time.time()
        }
        
        # ä¿å­˜å¾…ç¡®è®¤æ¶ˆæ¯
        self.redis.hset('pending_messages', msg_id, json.dumps(msg_with_id))
        
        # å‘å¸ƒæ¶ˆæ¯
        self.redis.publish(channel, json.dumps(msg_with_id))
        
        # è®¾ç½®è¶…æ—¶æ¸…ç†
        self.redis.expire(f'pending:{msg_id}', 300)
```

### 6.2 æ€§èƒ½å½±å“è€ƒè™‘


**ğŸ“Š æ€§èƒ½æŒ‡æ ‡åˆ†æ**
```python
# æ€§èƒ½æµ‹è¯•ç»“æœç¤ºä¾‹
æ€§èƒ½æŒ‡æ ‡å¯¹æ¯”ï¼š

æ“ä½œç±»å‹          QPS        å†…å­˜å ç”¨      CPUä½¿ç”¨
PUBLISH         100K+       æä½          ä½
SUBSCRIBE       100K+       ä¸­ç­‰          ä¸­ç­‰
Patternè®¢é˜…     50K+        è¾ƒé«˜          è¾ƒé«˜
å¤§é‡è®¢é˜…è€…      é™ä½        çº¿æ€§å¢é•¿       çº¿æ€§å¢é•¿
```

**ğŸ”§ æ€§èƒ½ä¼˜åŒ–æŠ€å·§**
```bash
# 1. åˆç†è®¾ç½®å®¢æˆ·ç«¯è¾“å‡ºç¼“å†²åŒº
CONFIG SET client-output-buffer-limit "pubsub 32mb 8mb 60"

# 2. é¿å…è®¢é˜…è¿‡å¤šé¢‘é“
# æ¯ä¸ªå®¢æˆ·ç«¯è®¢é˜…é¢‘é“æ•°å»ºè®® < 1000

# 3. é¿å…å¤æ‚çš„æ¨¡å¼åŒ¹é…
# âŒ é¿å…ï¼šPSUBSCRIBE *:*:*:*:*
# âœ… æ¨èï¼šPSUBSCRIBE user:*:notification

# 4. ç›‘æ§è®¢é˜…è€…çŠ¶æ€
PUBSUB NUMSUB channel_name  # ç›‘æ§è®¢é˜…è€…æ•°é‡
```

**âš¡ é«˜å¹¶å‘åœºæ™¯ä¼˜åŒ–**
```python
class HighPerformancePubSub:
    def __init__(self):
        # ä½¿ç”¨è¿æ¥æ± 
        self.pool = redis.ConnectionPool(max_connections=100)
        self.redis = redis.Redis(connection_pool=self.pool)
    
    def batch_publish(self, messages):
        # æ‰¹é‡å‘å¸ƒæ¶ˆæ¯
        pipe = self.redis.pipeline()
        for channel, message in messages:
            pipe.publish(channel, message)
        pipe.execute()
    
    def async_subscribe(self, channels, callback):
        # å¼‚æ­¥è®¢é˜…å¤„ç†
        pubsub = self.redis.pubsub()
        pubsub.subscribe(*channels)
        
        # ä½¿ç”¨çº¿ç¨‹æ± å¤„ç†æ¶ˆæ¯
        import concurrent.futures
        with concurrent.futures.ThreadPoolExecutor() as executor:
            for message in pubsub.listen():
                if message['type'] == 'message':
                    executor.submit(callback, message)
```

### 6.3 ä¸ä¸“ä¸šæ¶ˆæ¯é˜Ÿåˆ—å¯¹æ¯”


| ç‰¹æ€§ | **Redis Pub/Sub** | **Redis Streams** | **RabbitMQ** | **Kafka** |
|------|------------------|-------------------|--------------|-----------|
| **æ¶ˆæ¯æŒä¹…åŒ–** | `âŒ ä¸æ”¯æŒ` | `âœ… æ”¯æŒ` | `âœ… æ”¯æŒ` | `âœ… æ”¯æŒ` |
| **æ¶ˆæ¯ç¡®è®¤** | `âŒ æ— ç¡®è®¤` | `âœ… æ”¯æŒACK` | `âœ… æ”¯æŒACK` | `âœ… æ”¯æŒACK` |
| **æ¶ˆæ¯é‡è¯•** | `âŒ ä¸æ”¯æŒ` | `âœ… æ”¯æŒ` | `âœ… æ”¯æŒ` | `âœ… æ”¯æŒ` |
| **é›†ç¾¤æ”¯æŒ** | `éƒ¨åˆ†æ”¯æŒ` | `éƒ¨åˆ†æ”¯æŒ` | `âœ… å®Œæ•´æ”¯æŒ` | `âœ… å®Œæ•´æ”¯æŒ` |
| **æ€§èƒ½** | `æé«˜` | `é«˜` | `ä¸­ç­‰` | `æé«˜` |
| **è¿ç»´å¤æ‚åº¦** | `ä½` | `ä½` | `ä¸­ç­‰` | `é«˜` |

**ğŸ¯ é€‰æ‹©å»ºè®®**
```
é€‰æ‹©Redis Pub/Subçš„åœºæ™¯ï¼š
âœ… å®æ—¶æ€§è¦æ±‚æé«˜ï¼ˆæ¯«ç§’çº§ï¼‰
âœ… æ¶ˆæ¯ä¸¢å¤±å¯æ¥å—
âœ… ç³»ç»Ÿæ¶æ„ç®€å•
âœ… å·²æœ‰RedisåŸºç¡€è®¾æ–½

é€‰æ‹©Redis Streamsçš„åœºæ™¯ï¼š
âœ… éœ€è¦æ¶ˆæ¯æŒä¹…åŒ–
âœ… éœ€è¦æ¶ˆè´¹è€…ç»„åŠŸèƒ½  
âœ… éœ€è¦æ¶ˆæ¯é‡è¯•æœºåˆ¶
âœ… æ¶ˆæ¯é‡ä¸æ˜¯ç‰¹åˆ«å¤§

é€‰æ‹©ä¸“ä¸šMQçš„åœºæ™¯ï¼š
âœ… ä¼ä¸šçº§å¯é æ€§è¦æ±‚
âœ… å¤æ‚çš„æ¶ˆæ¯è·¯ç”±éœ€æ±‚
âœ… éœ€è¦å®Œæ•´çš„é›†ç¾¤æ”¯æŒ
âœ… æœ‰ä¸“é—¨çš„è¿ç»´å›¢é˜Ÿ
```

---

## 7. ğŸ› ï¸ å®æˆ˜æ¡ˆä¾‹åˆ†æ


### 7.1 å®Œæ•´èŠå¤©å®¤ç³»ç»Ÿå®ç°


**ğŸ—ï¸ ç³»ç»Ÿæ¶æ„è®¾è®¡**
```
ç³»ç»Ÿç»„ä»¶æ¶æ„ï¼š

å®¢æˆ·ç«¯1 â†â†’ WebSocket Server â†â†’ Redis Pub/Sub â†â†’ WebSocket Server â†â†’ å®¢æˆ·ç«¯2
    â†“                                    â†“                              â†“
å†å²è®°å½•API â†â†’ Redis Streams â†â†’ æ¶ˆæ¯æŒä¹…åŒ–æœåŠ¡ â†â†’ Redis Streams â†â†’ å†å²è®°å½•API

ç‰¹ç‚¹ï¼š
1. å®æ—¶é€šä¿¡ç”¨Pub/Sub
2. å†å²è®°å½•ç”¨Streams  
3. ç”¨æˆ·çŠ¶æ€ç”¨Hash/Set
4. æˆ¿é—´ç®¡ç†ç”¨Set
```

**ğŸ’» åç«¯æ ¸å¿ƒä»£ç **
```python
import redis
import json
import asyncio
import websockets
from datetime import datetime

class ChatServer:
    def __init__(self):
        self.redis = redis.Redis(decode_responses=True)
        self.clients = {}  # WebSocketè¿æ¥ç®¡ç†
        
    async def register_client(self, websocket, user_id, username):
        """æ³¨å†Œæ–°å®¢æˆ·ç«¯è¿æ¥"""
        self.clients[user_id] = {
            'websocket': websocket,
            'username': username,
            'rooms': set()
        }
        
        # è®¾ç½®ç”¨æˆ·åœ¨çº¿çŠ¶æ€
        self.redis.hset('users:online', user_id, json.dumps({
            'username': username,
            'login_time': datetime.now().isoformat()
        }))
    
    async def join_room(self, user_id, room_id):
        """ç”¨æˆ·åŠ å…¥æˆ¿é—´"""
        if user_id not in self.clients:
            return
            
        client = self.clients[user_id]
        client['rooms'].add(room_id)
        
        # æ·»åŠ ç”¨æˆ·åˆ°æˆ¿é—´
        self.redis.sadd(f'room:{room_id}:members', user_id)
        
        # è®¢é˜…æˆ¿é—´é¢‘é“
        await self.subscribe_room(user_id, room_id)
        
        # å¹¿æ’­åŠ å…¥æ¶ˆæ¯
        join_message = {
            'type': 'user_joined',
            'room_id': room_id,
            'user_id': user_id,
            'username': client['username'],
            'message': f"{client['username']} åŠ å…¥äº†æˆ¿é—´",
            'timestamp': datetime.now().isoformat()
        }
        
        # å‘å¸ƒå®æ—¶æ¶ˆæ¯
        self.redis.publish(f'room:{room_id}', json.dumps(join_message))
        
        # ä¿å­˜åˆ°å†å²è®°å½•
        self.redis.xadd(f'room:{room_id}:history', join_message)
    
    async def send_message(self, user_id, room_id, content):
        """å‘é€èŠå¤©æ¶ˆæ¯"""
        if user_id not in self.clients:
            return
            
        client = self.clients[user_id]
        
        # æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨æˆ¿é—´ä¸­
        if not self.redis.sismember(f'room:{room_id}:members', user_id):
            return
        
        message = {
            'type': 'chat_message',
            'room_id': room_id,
            'user_id': user_id,
            'username': client['username'],
            'content': content,
            'timestamp': datetime.now().isoformat()
        }
        
        # å‘å¸ƒå®æ—¶æ¶ˆæ¯
        self.redis.publish(f'room:{room_id}', json.dumps(message))
        
        # ä¿å­˜åˆ°å†å²è®°å½•Stream
        self.redis.xadd(f'room:{room_id}:history', message)
        
        # æ›´æ–°æˆ¿é—´æ´»è·ƒåº¦
        self.redis.zincrby('rooms:activity', 1, room_id)
    
    async def subscribe_room(self, user_id, room_id):
        """è®¢é˜…æˆ¿é—´æ¶ˆæ¯"""
        pubsub = self.redis.pubsub()
        pubsub.subscribe(f'room:{room_id}')
        
        # åœ¨åå°ä»»åŠ¡ä¸­å¤„ç†æ¶ˆæ¯
        asyncio.create_task(self.handle_room_messages(user_id, pubsub))
    
    async def handle_room_messages(self, user_id, pubsub):
        """å¤„ç†æˆ¿é—´æ¶ˆæ¯"""
        for message in pubsub.listen():
            if message['type'] == 'message':
                if user_id in self.clients:
                    websocket = self.clients[user_id]['websocket']
                    await websocket.send(message['data'])
    
    def get_room_history(self, room_id, count=50):
        """è·å–æˆ¿é—´å†å²è®°å½•"""
        messages = self.redis.xrevrange(
            f'room:{room_id}:history', 
            count=count
        )
        
        history = []
        for msg_id, fields in messages:
            history.append({
                'id': msg_id,
                **dict(zip(fields[::2], fields[1::2]))
            })
        
        return history[::-1]  # æŒ‰æ—¶é—´æ­£åºè¿”å›
    
    def get_online_users(self, room_id):
        """è·å–æˆ¿é—´åœ¨çº¿ç”¨æˆ·"""
        member_ids = self.redis.smembers(f'room:{room_id}:members')
        online_users = []
        
        for user_id in member_ids:
            if user_id in self.clients:
                online_users.append({
                    'user_id': user_id,
                    'username': self.clients[user_id]['username']
                })
        
        return online_users

# WebSocketå¤„ç†å™¨
async def websocket_handler(websocket, path):
    chat_server = ChatServer()
    
    try:
        # ç”¨æˆ·è®¤è¯
        auth_message = await websocket.recv()
        auth_data = json.loads(auth_message)
        user_id = auth_data['user_id']
        username = auth_data['username']
        
        # æ³¨å†Œå®¢æˆ·ç«¯
        await chat_server.register_client(websocket, user_id, username)
        
        # å‘é€è®¤è¯æˆåŠŸæ¶ˆæ¯
        await websocket.send(json.dumps({
            'type': 'auth_success',
            'message': 'è¿æ¥æˆåŠŸ'
        }))
        
        # å¤„ç†å®¢æˆ·ç«¯æ¶ˆæ¯
        async for message in websocket:
            data = json.loads(message)
            msg_type = data['type']
            
            if msg_type == 'join_room':
                await chat_server.join_room(user_id, data['room_id'])
                
            elif msg_type == 'send_message':
                await chat_server.send_message(
                    user_id, 
                    data['room_id'], 
                    data['content']
                )
                
            elif msg_type == 'get_history':
                history = chat_server.get_room_history(data['room_id'])
                await websocket.send(json.dumps({
                    'type': 'room_history',
                    'room_id': data['room_id'],
                    'messages': history
                }))
    
    except websockets.exceptions.ConnectionClosed:
        pass
    finally:
        # æ¸…ç†è¿æ¥
        if user_id in chat_server.clients:
            del chat_server.clients[user_id]
            chat_server.redis.hdel('users:online', user_id)

# å¯åŠ¨WebSocketæœåŠ¡å™¨
if __name__ == "__main__":
    start_server = websockets.serve(websocket_handler, "localhost", 8765)
    asyncio.get_event_loop().run_until_complete(start_server)
    asyncio.get_event_loop().run_forever()
```

**ğŸŒ å‰ç«¯JavaScriptä»£ç **
```javascript
class ChatClient {
    constructor(userId, username) {
        this.userId = userId;
        this.username = username;
        this.socket = null;
        this.currentRoom = null;
    }
    
    connect() {
        this.socket = new WebSocket('ws://localhost:8765');
        
        this.socket.onopen = () => {
            // å‘é€è®¤è¯ä¿¡æ¯
            this.socket.send(JSON.stringify({
                type: 'auth',
                user_id: this.userId,
                username: this.username
            }));
        };
        
        this.socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            this.handleMessage(data);
        };
        
        this.socket.onclose = () => {
            console.log('è¿æ¥å·²å…³é—­');
            // è‡ªåŠ¨é‡è¿é€»è¾‘
            setTimeout(() => this.connect(), 3000);
        };
    }
    
    handleMessage(data) {
        switch(data.type) {
            case 'auth_success':
                console.log('è®¤è¯æˆåŠŸ');
                break;
                
            case 'chat_message':
                this.displayMessage(data);
                break;
                
            case 'user_joined':
                this.displaySystemMessage(`${data.username} åŠ å…¥äº†æˆ¿é—´`);
                break;
                
            case 'room_history':
                this.displayHistory(data.messages);
                break;
        }
    }
    
    joinRoom(roomId) {
        this.currentRoom = roomId;
        this.socket.send(JSON.stringify({
            type: 'join_room',
            room_id: roomId
        }));
        
        // è·å–å†å²è®°å½•
        this.socket.send(JSON.stringify({
            type: 'get_history',
            room_id: roomId
        }));
    }
    
    sendMessage(content) {
        if (!this.currentRoom || !content.trim()) return;
        
        this.socket.send(JSON.stringify({
            type: 'send_message',
            room_id: this.currentRoom,
            content: content.trim()
        }));
    }
    
    displayMessage(data) {
        const messagesContainer = document.getElementById('messages');
        const messageElement = document.createElement('div');
        messageElement.className = 'message';
        
        const time = new Date(data.timestamp).toLocaleTimeString();
        messageElement.innerHTML = `
            <div class="message-header">
                <span class="username">${data.username}</span>
                <span class="time">${time}</span>
            </div>
            <div class="message-content">${data.content}</div>
        `;
        
        messagesContainer.appendChild(messageElement);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    displaySystemMessage(text) {
        const messagesContainer = document.getElementById('messages');
        const systemMessage = document.createElement('div');
        systemMessage.className = 'system-message';
        systemMessage.textContent = text;
        messagesContainer.appendChild(systemMessage);
    }
    
    displayHistory(messages) {
        const messagesContainer = document.getElementById('messages');
        messagesContainer.innerHTML = ''; // æ¸…ç©ºç°æœ‰æ¶ˆæ¯
        
        messages.forEach(msg => {
            if (msg.type === 'chat_message') {
                this.displayMessage(msg);
            } else if (msg.type === 'user_joined') {
                this.displaySystemMessage(msg.message);
            }
        });
    }
}

// ä½¿ç”¨ç¤ºä¾‹
const client = new ChatClient('user123', 'å¼ ä¸‰');
client.connect();

// é¡µé¢äº‹ä»¶ç»‘å®š
document.getElementById('joinRoomBtn').onclick = () => {
    const roomId = document.getElementById('roomInput').value;
    client.joinRoom(roomId);
};

document.getElementById('sendBtn').onclick = () => {
    const content = document.getElementById('messageInput').value;
    client.sendMessage(content);
    document.getElementById('messageInput').value = '';
};

document.getElementById('messageInput').onkeypress = (e) => {
    if (e.key === 'Enter') {
        const content = e.target.value;
        client.sendMessage(content);
        e.target.value = '';
    }
};
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å‘å¸ƒè®¢é˜…æœ¬è´¨ï¼šå®æ—¶æ¶ˆæ¯æ¨é€æœºåˆ¶ï¼Œå‘å¸ƒè€…å’Œè®¢é˜…è€…è§£è€¦
ğŸ”¸ åŸºç¡€å‘½ä»¤ï¼šPUBLISHå‘å¸ƒã€SUBSCRIBEè®¢é˜…ã€UNSUBSCRIBEå–æ¶ˆè®¢é˜…
ğŸ”¸ æ¨¡å¼è®¢é˜…ï¼šPSUBSCRIBEæ”¯æŒé€šé…ç¬¦ï¼Œå¯è®¢é˜…å¤šä¸ªåŒ¹é…çš„é¢‘é“
ğŸ”¸ æ¶ˆæ¯æ ¼å¼ï¼šåŒ…å«æ¶ˆæ¯ç±»å‹ã€é¢‘é“åã€æ¶ˆæ¯å†…å®¹çš„ç»“æ„åŒ–æ•°æ®
ğŸ”¸ Streamsä¼˜åŠ¿ï¼šæ¶ˆæ¯æŒä¹…åŒ–ã€æ¶ˆè´¹è€…ç»„ã€æ¶ˆæ¯ç¡®è®¤ã€æ”¯æŒå›æº¯
ğŸ”¸ æ ¸å¿ƒåŒºåˆ«ï¼šPub/Subå®æ—¶ä½†ä¸æŒä¹…ï¼ŒStreamsæŒä¹…ä½†ç¨æ…¢
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å‘å¸ƒè®¢é˜…çš„å®é™…ä»·å€¼**
```
è§£è€¦ç³»ç»Ÿç»„ä»¶ï¼š
- å‘å¸ƒè€…ä¸éœ€è¦çŸ¥é“è°åœ¨è®¢é˜…
- è®¢é˜…è€…ä¸éœ€è¦çŸ¥é“æ¶ˆæ¯æ¥æº  
- ç»„ä»¶å¯ä»¥ç‹¬ç«‹å¼€å‘å’Œéƒ¨ç½²

å®ç°å®æ—¶é€šä¿¡ï¼š
- æ¯«ç§’çº§æ¶ˆæ¯ä¼ é€’
- æ”¯æŒä¸€å¯¹å¤šå¹¿æ’­
- å¤©ç„¶çš„è§‚å¯Ÿè€…æ¨¡å¼å®ç°
```

**ğŸ”¹ ä½¿ç”¨åœºæ™¯çš„é€‰æ‹©æ ‡å‡†**
```
é€‰æ‹©Pub/Subçš„æƒ…å†µï¼š
âœ… å®æ—¶æ€§è¦æ±‚é«˜ï¼ˆèŠå¤©ã€æ¨é€ï¼‰
âœ… æ¶ˆæ¯ä¸¢å¤±å¯æ¥å—
âœ… ç³»ç»Ÿæ¶æ„ç®€å•
âœ… ä¸´æ—¶æ€§æ¶ˆæ¯é€šçŸ¥

é€‰æ‹©Streamsçš„æƒ…å†µï¼š  
âœ… æ¶ˆæ¯éœ€è¦æŒä¹…åŒ–
âœ… éœ€è¦æ¶ˆè´¹è€…ç»„åŠŸèƒ½
âœ… æ¶ˆæ¯ä¸èƒ½ä¸¢å¤±
âœ… éœ€è¦æ¶ˆæ¯å¤„ç†ç¡®è®¤
```

**ğŸ”¹ æ€§èƒ½å’Œå¯é æ€§çš„å¹³è¡¡**
```
æ€§èƒ½ä¼˜åŒ–ï¼š
- æ§åˆ¶è®¢é˜…è€…æ•°é‡
- é¿å…å¤æ‚æ¨¡å¼åŒ¹é…  
- åˆç†è®¾ç½®ç¼“å†²åŒºå¤§å°
- ä½¿ç”¨è¿æ¥æ± ç®¡ç†è¿æ¥

å¯é æ€§ä¿éšœï¼š
- Pub/Sub + å¤‡ä»½å­˜å‚¨åŒå†™
- ä½¿ç”¨Streamsæ›¿ä»£å…³é”®åœºæ™¯
- å®ç°æ¶ˆæ¯ç¡®è®¤æœºåˆ¶
- è®¾è®¡é‡è¯•å’Œæ¢å¤é€»è¾‘
```

### 8.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¸šåŠ¡åœºæ™¯åº”ç”¨**
- **å³æ—¶é€šè®¯**ï¼šèŠå¤©å®¤ã€åœ¨çº¿å®¢æœã€å®æ—¶è¯„è®º
- **ç³»ç»Ÿé€šçŸ¥**ï¼šç”¨æˆ·æ¶ˆæ¯æ¨é€ã€ç³»ç»Ÿå‘Šè­¦ã€çŠ¶æ€æ›´æ–°  
- **æ•°æ®åŒæ­¥**ï¼šç¼“å­˜æ›´æ–°é€šçŸ¥ã€é…ç½®å˜æ›´æ¨é€
- **äº‹ä»¶é©±åŠ¨**ï¼šå¾®æœåŠ¡è§£è€¦ã€ä¸šåŠ¡äº‹ä»¶å¤„ç†

**ğŸ”§ æŠ€æœ¯æ¶æ„ä»·å€¼**
- **è§£è€¦æ¶æ„**ï¼šé™ä½ç»„ä»¶é—´ä¾èµ–ï¼Œæé«˜å¯ç»´æŠ¤æ€§
- **æ‰©å±•æ€§**ï¼šæ”¯æŒåŠ¨æ€å¢åŠ è®¢é˜…è€…ï¼Œç³»ç»Ÿæ˜“æ‰©å±•
- **å®æ—¶æ€§**ï¼šæ¯«ç§’çº§æ¶ˆæ¯ä¼ é€’ï¼Œç”¨æˆ·ä½“éªŒä½³
- **ç®€åŒ–è®¾è®¡**ï¼šä¸éœ€è¦å¤æ‚çš„è½®è¯¢æœºåˆ¶

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
```
å‘å¸ƒè®¢é˜…è§£è€¦å¥½ï¼Œå®æ—¶é€šä¿¡ä¸å¯å°‘
Pub/Subå¿«ä½†æ˜“ä¸¢ï¼ŒStreamsæ…¢ä½†å¯é   
æ¨¡å¼è®¢é˜…ç”¨é€šé…ï¼Œæ‰¹é‡ç®¡ç†å¾ˆæ–¹ä¾¿
èŠå¤©æ¨é€é€‰å‰è€…ï¼Œæ—¥å¿—é˜Ÿåˆ—é€‰åè€…
æ€§èƒ½å¯é éœ€å¹³è¡¡ï¼Œåœºæ™¯é€‰æ‹©æ˜¯å…³é”®
```

### 8.4 å¸¸è§åº”ç”¨æ¶æ„æ¨¡å¼


| æ¶æ„æ¨¡å¼ | **ä½¿ç”¨æŠ€æœ¯** | **å…¸å‹åœºæ™¯** | **ç‰¹ç‚¹** |
|---------|-------------|-------------|---------|
| **å¹¿æ’­é€šçŸ¥** | `Pub/Sub` | `ç³»ç»Ÿå…¬å‘Šã€é…ç½®æ›´æ–°` | `ä¸€å¯¹å¤šï¼Œå®æ—¶æ€§å¼º` |
| **ç‚¹å¯¹ç‚¹æ¶ˆæ¯** | `Streams + æ¶ˆè´¹ç»„` | `è®¢å•å¤„ç†ã€ä»»åŠ¡é˜Ÿåˆ—` | `å¯é æ€§é«˜ï¼Œæ”¯æŒç¡®è®¤` |
| **æ··åˆæ¶æ„** | `Pub/Sub + Streams` | `èŠå¤©ç³»ç»Ÿã€äº‹ä»¶ç³»ç»Ÿ` | `å®æ—¶+æŒä¹…ï¼ŒåŠŸèƒ½å®Œæ•´` |
| **äº‹ä»¶é©±åŠ¨** | `æ¨¡å¼è®¢é˜…` | `å¾®æœåŠ¡é€šä¿¡ã€æ—¥å¿—æ”¶é›†` | `æ¾è€¦åˆï¼Œæ˜“æ‰©å±•` |