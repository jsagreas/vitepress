---
title: 6ã€ç¼“å­˜ä½¿ç”¨æœ€ä½³å®è·µ
---
## ğŸ“š ç›®å½•

1. [ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜æœ¬è´¨](#1-ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜æœ¬è´¨)
2. [ç¼“å­˜ä¸æ•°æ®åº“åŒå†™ä¸€è‡´æ€§åˆ†æ](#2-ç¼“å­˜ä¸æ•°æ®åº“åŒå†™ä¸€è‡´æ€§åˆ†æ)
3. [ç¼“å­˜æ›´æ–°ç­–ç•¥è¯¦è§£](#3-ç¼“å­˜æ›´æ–°ç­–ç•¥è¯¦è§£)
4. [å…ˆåˆ åå†™ç­–ç•¥](#4-å…ˆåˆ åå†™ç­–ç•¥)
5. [å»¶è¿ŸåŒåˆ ç­–ç•¥](#5-å»¶è¿ŸåŒåˆ ç­–ç•¥)
6. [ç¼“å­˜æ›´æ–°ç­–ç•¥å¯¹æ¯”](#6-ç¼“å­˜æ›´æ–°ç­–ç•¥å¯¹æ¯”)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ§© ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜æœ¬è´¨


### 1.1 ä»€ä¹ˆæ˜¯ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜


**é€šä¿—ç†è§£**ï¼šå°±åƒä½ æ¡Œä¸Šæ”¾äº†ä¸€ä»½æ–‡ä»¶çš„å¤å°ä»¶ï¼ŒåŸæ–‡ä»¶æ”¹äº†ï¼Œä½†å¤å°ä»¶æ²¡æœ‰åŠæ—¶æ›´æ–°ï¼Œè¿™å°±äº§ç”Ÿäº†ä¸ä¸€è‡´ã€‚

```
ç°å®åœºæ™¯ç±»æ¯”ï¼š
åŸæ–‡ä»¶ï¼ˆæ•°æ®åº“ï¼‰ï¼šå­˜æ”¾ç€æœ€æƒå¨çš„æ•°æ®
å¤å°ä»¶ï¼ˆç¼“å­˜ï¼‰ï¼šä¸ºäº†å¿«é€Ÿè®¿é—®åˆ¶ä½œçš„å‰¯æœ¬

é—®é¢˜äº§ç”Ÿï¼š
- åŸæ–‡ä»¶ä¿®æ”¹äº† â†’ æ•°æ®åº“æ›´æ–°äº†
- å¤å°ä»¶è¿˜æ˜¯æ—§çš„ â†’ ç¼“å­˜æ²¡æ›´æ–°
- åˆ«äººçœ‹å¤å°ä»¶ â†’ ç”¨æˆ·è¯»åˆ°äº†è¿‡æœŸæ•°æ®
```

### 1.2 ä¸€è‡´æ€§é—®é¢˜çš„å½±å“


**ğŸ”¸ ä¸šåŠ¡å½±å“ç¤ºä¾‹**ï¼š
```
ç”µå•†åº“å­˜é—®é¢˜ï¼š
æ•°æ®åº“æ˜¾ç¤ºï¼šå•†å“Aåº“å­˜ = 0ï¼ˆå·²å”®ç½„ï¼‰
ç¼“å­˜æ˜¾ç¤ºï¼šå•†å“Aåº“å­˜ = 5ï¼ˆè¿‡æœŸæ•°æ®ï¼‰
ç»“æœï¼šç”¨æˆ·çœ‹åˆ°æœ‰åº“å­˜ï¼Œä¸‹å•åå‘ç°æ— è´§ â†’ ç”¨æˆ·ä½“éªŒå·®

ç”¨æˆ·ä¿¡æ¯é—®é¢˜ï¼š
æ•°æ®åº“ï¼šç”¨æˆ·æ˜µç§° = "æ–°æ˜µç§°"ï¼ˆç”¨æˆ·åˆšä¿®æ”¹ï¼‰
ç¼“å­˜ï¼šç”¨æˆ·æ˜µç§° = "æ—§æ˜µç§°"ï¼ˆæœªæ›´æ–°ï¼‰
ç»“æœï¼šç”¨æˆ·ä¿®æ”¹æ˜µç§°åï¼Œé¡µé¢æ˜¾ç¤ºè¿˜æ˜¯æ—§çš„ â†’ åŠŸèƒ½å¼‚å¸¸
```

### 1.3 ä¸€è‡´æ€§é—®é¢˜çš„æ ¹æœ¬åŸå› 


**ğŸ” é—®é¢˜åˆ†æ**ï¼š
```
æ ¹æœ¬çŸ›ç›¾ï¼š
- ç¼“å­˜çš„ç›®æ ‡ = æå‡æ€§èƒ½ï¼ˆå¿«é€Ÿè¯»å–ï¼‰
- ä¸€è‡´æ€§çš„è¦æ±‚ = æ•°æ®æ­£ç¡®ï¼ˆå®æ—¶åŒæ­¥ï¼‰
- ä¸¤è€…å¤©ç„¶å†²çª = ä¸å¯èƒ½åŒæ—¶å®Œç¾

æŠ€æœ¯åŸå› ï¼š
1. æ“ä½œéåŸå­æ€§ï¼šæ›´æ–°æ•°æ®åº“å’Œç¼“å­˜ä¸æ˜¯ä¸€ä¸ªåŸå­æ“ä½œ
2. ç½‘ç»œå»¶è¿Ÿï¼šç¼“å­˜å’Œæ•°æ®åº“ä¹‹é—´å­˜åœ¨ç½‘ç»œå»¶è¿Ÿ  
3. å¹¶å‘è®¿é—®ï¼šå¤šä¸ªè¯·æ±‚åŒæ—¶è¯»å†™é€ æˆç«æ€æ¡ä»¶
4. åˆ†å¸ƒå¼ç¯å¢ƒï¼šå¤šä¸ªèŠ‚ç‚¹ä¹‹é—´çš„æ•°æ®åŒæ­¥å»¶è¿Ÿ
```

---

## 2. ğŸ”„ ç¼“å­˜ä¸æ•°æ®åº“åŒå†™ä¸€è‡´æ€§åˆ†æ


### 2.1 åŒå†™ä¸€è‡´æ€§çš„å«ä¹‰


**ä»€ä¹ˆæ˜¯åŒå†™**ï¼šæ›´æ–°æ•°æ®æ—¶ï¼Œæ—¢è¦å†™æ•°æ®åº“ï¼Œä¹Ÿè¦å†™ç¼“å­˜ï¼Œä¿è¯ä¸¤è¾¹æ•°æ®ä¸€è‡´ã€‚

```
åŒå†™åœºæ™¯ï¼š
ç”¨æˆ·ä¿®æ”¹ä¸ªäººä¿¡æ¯ â†’ éœ€è¦åŒæ—¶æ›´æ–°æ•°æ®åº“å’Œç¼“å­˜

ä¼ ç»Ÿåšæ³•ï¼š
1. æ›´æ–°æ•°æ®åº“ âœ“
2. æ›´æ–°ç¼“å­˜ âœ“  
3. è¿”å›æˆåŠŸ

ç†æƒ³ç»“æœï¼šæ•°æ®åº“å’Œç¼“å­˜éƒ½æ˜¯æœ€æ–°æ•°æ®
```

### 2.2 åŒå†™ä¸€è‡´æ€§é¢ä¸´çš„æŒ‘æˆ˜


#### ğŸš¨ æŒ‘æˆ˜1ï¼šæ“ä½œå¤±è´¥çš„é£é™©

```
åœºæ™¯æè¿°ï¼š
Step 1: æ›´æ–°æ•°æ®åº“ â†’ æˆåŠŸ âœ…
Step 2: æ›´æ–°ç¼“å­˜ â†’ å¤±è´¥ âŒï¼ˆç½‘ç»œé—®é¢˜/Rediså®•æœºï¼‰

ç»“æœï¼šæ•°æ®åº“æ˜¯æ–°æ•°æ®ï¼Œç¼“å­˜æ˜¯æ—§æ•°æ® â†’ ä¸ä¸€è‡´

ç°å®ä¾‹å­ï¼š
ç”¨æˆ·ä¿®æ”¹æ‰‹æœºå·ï¼š
- æ•°æ®åº“ï¼šæ‰‹æœºå· = 138xxxx9999ï¼ˆæ–°å·ç ï¼‰
- ç¼“å­˜ï¼šæ‰‹æœºå· = 136xxxx8888ï¼ˆæ—§å·ç ï¼‰
- ç”¨æˆ·åˆ·æ–°é¡µé¢çœ‹åˆ°çš„è¿˜æ˜¯æ—§æ‰‹æœºå·
```

#### ğŸš¨ æŒ‘æˆ˜2ï¼šå¹¶å‘è®¿é—®çš„ç«æ€é—®é¢˜

```
æ—¶é—´çº¿é—®é¢˜ï¼š

æ—¶åˆ»T1ï¼šçº¿ç¨‹A æ›´æ–°æ•°æ®åº“ user=å¼ ä¸‰
æ—¶åˆ»T2ï¼šçº¿ç¨‹B è¯»å–ç¼“å­˜ user=æå››ï¼ˆæ—§æ•°æ®ï¼‰
æ—¶åˆ»T3ï¼šçº¿ç¨‹A æ›´æ–°ç¼“å­˜ user=å¼ ä¸‰
æ—¶åˆ»T4ï¼šçº¿ç¨‹B æŠŠè¯»åˆ°çš„æ—§æ•°æ®å†™å›ç¼“å­˜ user=æå››

æœ€ç»ˆç»“æœï¼šæ•°æ®åº“=å¼ ä¸‰ï¼Œç¼“å­˜=æå›› â†’ ä¸ä¸€è‡´
```

### 2.3 åŒå†™ä¸€è‡´æ€§çš„æ ¸å¿ƒéš¾ç‚¹


```
æŠ€æœ¯éš¾ç‚¹åˆ†æï¼š

åŸå­æ€§ä¿è¯ï¼š
- æ— æ³•ä¿è¯æ•°æ®åº“å’Œç¼“å­˜æ“ä½œçš„åŸå­æ€§
- åˆ†å¸ƒå¼äº‹åŠ¡ä»£ä»·é«˜æ˜‚ï¼Œæ€§èƒ½å½±å“å¤§

æ—¶åºæ§åˆ¶ï¼š  
- å¹¶å‘ç¯å¢ƒä¸‹æ“ä½œé¡ºåºéš¾ä»¥æ§åˆ¶
- ç½‘ç»œå»¶è¿Ÿå¯¼è‡´æ“ä½œåˆ°è¾¾æ—¶é—´ä¸å¯é¢„æœŸ

æ•…éšœå¤„ç†ï¼š
- éƒ¨åˆ†æ“ä½œå¤±è´¥æ—¶çš„çŠ¶æ€æ¢å¤
- æ•°æ®ä¸ä¸€è‡´æ—¶çš„æ£€æµ‹å’Œä¿®å¤

æ€§èƒ½å¹³è¡¡ï¼š
- å¼ºä¸€è‡´æ€§ vs é«˜æ€§èƒ½çš„æƒè¡¡
- å¤æ‚åº¦ vs å¯ç»´æŠ¤æ€§çš„å¹³è¡¡
```

---

## 3. ğŸ“‹ ç¼“å­˜æ›´æ–°ç­–ç•¥è¯¦è§£


### 3.1 å¸¸è§çš„ç¼“å­˜æ›´æ–°æ¨¡å¼


**ğŸ”¸ æ›´æ–°ç­–ç•¥åˆ†ç±»**ï¼š
```
1. Cache Asideï¼ˆæ—è·¯ç¼“å­˜ï¼‰
   åº”ç”¨ç¨‹åºç®¡ç†ç¼“å­˜å’Œæ•°æ®åº“

2. Write Throughï¼ˆå†™é€ï¼‰
   åº”ç”¨å†™ç¼“å­˜ï¼Œç¼“å­˜è´Ÿè´£å†™æ•°æ®åº“

3. Write Behindï¼ˆå†™å›ï¼‰
   åº”ç”¨å†™ç¼“å­˜ï¼Œå¼‚æ­¥æ‰¹é‡å†™æ•°æ®åº“

4. Write Aroundï¼ˆç»•å†™ï¼‰
   åº”ç”¨ç›´æ¥å†™æ•°æ®åº“ï¼Œä¸æ›´æ–°ç¼“å­˜
```

### 3.2 Cache Asideæ¨¡å¼è¯¦è§£


**ğŸ’¡ Cache Asideå·¥ä½œåŸç†**ï¼š
```
è¯»æ“ä½œæµç¨‹ï¼š
1. åº”ç”¨å…ˆæŸ¥ç¼“å­˜
2. ç¼“å­˜å‘½ä¸­ â†’ ç›´æ¥è¿”å›
3. ç¼“å­˜æœªå‘½ä¸­ â†’ æŸ¥æ•°æ®åº“ â†’ å†™å…¥ç¼“å­˜ â†’ è¿”å›æ•°æ®

å†™æ“ä½œæµç¨‹ï¼š
1. åº”ç”¨æ›´æ–°æ•°æ®åº“
2. åˆ é™¤ç¼“å­˜ä¸­çš„æ—§æ•°æ®
3. ä¸‹æ¬¡è¯»å–æ—¶é‡æ–°åŠ è½½åˆ°ç¼“å­˜
```

**ğŸ“Š Cache Asideæ¨¡å¼å›¾ç¤º**ï¼š
```
                  è¯»æ“ä½œ
åº”ç”¨ç¨‹åº â”€â”€â”€â”€â”€â–º ç¼“å­˜
   â”‚               â”‚
   â”‚               â–¼
   â”‚          å‘½ä¸­ï¼Ÿè¿”å›æ•°æ®
   â”‚               â”‚
   â–¼               â–¼ æœªå‘½ä¸­
æ•°æ®åº“ â—„â”€â”€â”€â”€â”€â”€â”€ æŸ¥è¯¢æ•°æ®åº“
   â”‚               â”‚
   â”‚               â–¼
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º æ›´æ–°ç¼“å­˜

                  å†™æ“ä½œ  
åº”ç”¨ç¨‹åº â”€â”€â”€â”€â”€â–º æ•°æ®åº“ï¼ˆæ›´æ–°ï¼‰
   â”‚
   â–¼
åˆ é™¤ç¼“å­˜
```

### 3.3 ä¸ºä»€ä¹ˆé€‰æ‹©åˆ é™¤è€Œä¸æ˜¯æ›´æ–°ç¼“å­˜


**ğŸ¤” æ›´æ–° vs åˆ é™¤å¯¹æ¯”**ï¼š

```java
// æ–¹å¼1ï¼šæ›´æ–°ç¼“å­˜ï¼ˆé—®é¢˜è¾ƒå¤šï¼‰
public void updateUser(User user) {
    // 1. æ›´æ–°æ•°æ®åº“
    userDao.update(user);
    
    // 2. æ›´æ–°ç¼“å­˜
    redisTemplate.opsForValue().set("user:" + user.getId(), user);
}

// æ–¹å¼2ï¼šåˆ é™¤ç¼“å­˜ï¼ˆæ¨èï¼‰
public void updateUser(User user) {
    // 1. æ›´æ–°æ•°æ®åº“
    userDao.update(user);
    
    // 2. åˆ é™¤ç¼“å­˜
    redisTemplate.delete("user:" + user.getId());
}
```

**ä¸ºä»€ä¹ˆé€‰æ‹©åˆ é™¤**ï¼š

| å¯¹æ¯”é¡¹ | æ›´æ–°ç¼“å­˜ | åˆ é™¤ç¼“å­˜ |
|--------|----------|----------|
| **å¤æ‚åœºæ™¯å¤„ç†** | âŒ å¤æ‚è®¡ç®—é€»è¾‘é‡å¤æ‰§è¡Œ | âœ… æŒ‰éœ€è®¡ç®—ï¼Œé¿å…æµªè´¹ |
| **å¹¶å‘å®‰å…¨æ€§** | âŒ å®¹æ˜“å‡ºç°è„æ•°æ® | âœ… æœ€ç»ˆä¸€è‡´æ€§å¥½ |
| **å®ç°ç®€å•æ€§** | âŒ éœ€è¦åŒæ­¥å¤æ‚é€»è¾‘ | âœ… å®ç°ç®€å• |
| **èµ„æºæ¶ˆè€—** | âŒ æ¯æ¬¡æ›´æ–°éƒ½è¦è®¡ç®— | âœ… åªåœ¨éœ€è¦æ—¶è®¡ç®— |

**ğŸ”¥ å®é™…æ¡ˆä¾‹å¯¹æ¯”**ï¼š
```
å¤æ‚è®¡ç®—åœºæ™¯ï¼š
ç¼“å­˜å†…å®¹ï¼šç”¨æˆ·çš„è®¢å•ç»Ÿè®¡ï¼ˆéœ€è¦å…³è”æŸ¥è¯¢å¤šå¼ è¡¨ï¼‰

æ›´æ–°ç¼“å­˜æ–¹å¼ï¼š
- æ¯æ¬¡ç”¨æˆ·ä¿¡æ¯å˜æ›´ â†’ é‡æ–°è®¡ç®—è®¢å•ç»Ÿè®¡ â†’ æµªè´¹èµ„æº
- å¦‚æœè¿˜æœ‰å…¶ä»–å…³è”æ•°æ®å˜æ›´ â†’ è®¡ç®—é€»è¾‘è¶Šæ¥è¶Šå¤æ‚

åˆ é™¤ç¼“å­˜æ–¹å¼ï¼š  
- ç”¨æˆ·ä¿¡æ¯å˜æ›´ â†’ åˆ é™¤ç¼“å­˜
- ä¸‹æ¬¡è®¿é—®æ—¶ â†’ é‡æ–°è®¡ç®—å¹¶ç¼“å­˜
- é€»è¾‘ç®€å•ï¼ŒæŒ‰éœ€è®¡ç®—
```

---

## 4. ğŸ—‘ å…ˆåˆ åå†™ç­–ç•¥


### 4.1 å…ˆåˆ åå†™çš„åŸºæœ¬æµç¨‹


**ğŸ”¸ ç­–ç•¥åŸç†**ï¼š
```
æ“ä½œé¡ºåºï¼š
1ï¸âƒ£ åˆ é™¤ç¼“å­˜
2ï¸âƒ£ æ›´æ–°æ•°æ®åº“
3ï¸âƒ£ è¿”å›æ“ä½œç»“æœ

ä¸‹æ¬¡è¯»å–æ—¶ï¼š
4ï¸âƒ£ ç¼“å­˜æœªå‘½ä¸­ â†’ ä»æ•°æ®åº“è¯»å–æœ€æ–°æ•°æ®
5ï¸âƒ£ å°†æœ€æ–°æ•°æ®å†™å…¥ç¼“å­˜
```

### 4.2 å…ˆåˆ åå†™ä»£ç å®ç°


```java
@Service
public class UserService {
    
    @Autowired
    private UserDao userDao;
    
    @Autowired
    private RedisTemplate redisTemplate;
    
    /**
     * å…ˆåˆ åå†™ç­–ç•¥æ›´æ–°ç”¨æˆ·
     */
    public void updateUser(User user) {
        String cacheKey = "user:" + user.getId();
        
        try {
            // ğŸ—‘ Step 1: åˆ é™¤ç¼“å­˜
            redisTemplate.delete(cacheKey);
            
            // ğŸ’¾ Step 2: æ›´æ–°æ•°æ®åº“  
            userDao.updateUser(user);
            
            log.info("ç”¨æˆ·æ›´æ–°æˆåŠŸï¼ŒID: {}", user.getId());
            
        } catch (Exception e) {
            log.error("ç”¨æˆ·æ›´æ–°å¤±è´¥", e);
            throw new RuntimeException("æ›´æ–°å¤±è´¥");
        }
    }
}
```

### 4.3 å…ˆåˆ åå†™çš„æ½œåœ¨é—®é¢˜


#### ğŸš¨ é—®é¢˜1ï¼šå¹¶å‘è¯»å†™å†²çª

```
æ—¶é—´çº¿åˆ†æï¼š

T1: çº¿ç¨‹A åˆ é™¤ç¼“å­˜ user:123
T2: çº¿ç¨‹B æŸ¥è¯¢ç”¨æˆ·123 â†’ ç¼“å­˜æœªå‘½ä¸­
T3: çº¿ç¨‹B ä»æ•°æ®åº“è¯»å–æ—§æ•°æ® â†’ name="å¼ ä¸‰"
T4: çº¿ç¨‹A æ›´æ–°æ•°æ®åº“ â†’ name="æå››"  
T5: çº¿ç¨‹B å°†æ—§æ•°æ®å†™å…¥ç¼“å­˜ â†’ name="å¼ ä¸‰"

ç»“æœï¼šæ•°æ®åº“=æå››ï¼Œç¼“å­˜=å¼ ä¸‰ â†’ ä¸ä¸€è‡´
```

**ğŸ”§ é—®é¢˜åœºæ™¯è¿˜åŸ**ï¼š
```java
// çº¿ç¨‹Aï¼šæ›´æ–°æ“ä½œ
public void updateUser() {
    redisTemplate.delete("user:123");     // T1: åˆ é™¤ç¼“å­˜
    Thread.sleep(100);                     // æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç†å»¶è¿Ÿ
    userDao.update("user:123", "æå››");    // T4: æ›´æ–°æ•°æ®åº“
}

// çº¿ç¨‹Bï¼šæŸ¥è¯¢æ“ä½œ
public User getUser() {
    User user = redisTemplate.get("user:123");  // T2: ç¼“å­˜æœªå‘½ä¸­
    if (user == null) {
        user = userDao.findById(123);           // T3: æŸ¥æ•°æ®åº“å¾—åˆ°"å¼ ä¸‰"
        redisTemplate.set("user:123", user);    // T5: å†™å…¥æ—§æ•°æ®
    }
    return user;
}
```

#### âš¡ é—®é¢˜å‘ç”Ÿçš„æ¡ä»¶

```
åŒæ—¶æ»¡è¶³ä¸‰ä¸ªæ¡ä»¶æ‰ä¼šå‡ºç°é—®é¢˜ï¼š
âœ“ åˆ é™¤ç¼“å­˜å’Œæ›´æ–°æ•°æ®åº“ä¹‹é—´æœ‰æ—¶é—´é—´éš”
âœ“ æ°å¥½æœ‰è¯»è¯·æ±‚åœ¨è¿™ä¸ªæ—¶é—´é—´éš”å†…å‘ç”Ÿ
âœ“ è¯»è¯·æ±‚çš„æ•°æ®åº“æŸ¥è¯¢æ¯”æ›´æ–°æ“ä½œæ›´å¿«å®Œæˆ

å®é™…è¯„ä¼°ï¼š
- è¿™ç§æƒ…å†µå‘ç”Ÿæ¦‚ç‡è¾ƒä½
- å½±å“æŒç»­æ—¶é—´çŸ­ï¼ˆç›´åˆ°ç¼“å­˜è¿‡æœŸï¼‰
- å¤§å¤šæ•°ä¸šåŠ¡åœºæ™¯å¯ä»¥æ¥å—
```

---

## 5. ğŸ”„ å»¶è¿ŸåŒåˆ ç­–ç•¥


### 5.1 å»¶è¿ŸåŒåˆ çš„è®¾è®¡æ€æƒ³


**ğŸ¯ ç­–ç•¥ç›®çš„**ï¼šè§£å†³å…ˆåˆ åå†™ç­–ç•¥çš„å¹¶å‘é—®é¢˜ï¼Œé€šè¿‡äºŒæ¬¡åˆ é™¤ç¡®ä¿æ•°æ®ä¸€è‡´æ€§ã€‚

**ğŸ’¡ åŸºæœ¬æ€è·¯**ï¼š
```
æ“ä½œæµç¨‹ï¼š
1ï¸âƒ£ ç¬¬ä¸€æ¬¡åˆ é™¤ç¼“å­˜
2ï¸âƒ£ æ›´æ–°æ•°æ®åº“
3ï¸âƒ£ å»¶è¿Ÿä¸€æ®µæ—¶é—´
4ï¸âƒ£ ç¬¬äºŒæ¬¡åˆ é™¤ç¼“å­˜

è®¾è®¡é€»è¾‘ï¼š
å³ä½¿åœ¨æ­¥éª¤1-2ä¹‹é—´æœ‰è„æ•°æ®å†™å…¥ç¼“å­˜ï¼Œ
æ­¥éª¤4ä¹Ÿä¼šå°†å…¶æ¸…é™¤ï¼Œä¿è¯æœ€ç»ˆä¸€è‡´æ€§
```

### 5.2 å»¶è¿ŸåŒåˆ å®Œæ•´å®ç°


#### ğŸ”§ åŒæ­¥ç‰ˆæœ¬å®ç°

```java
@Service
public class UserService {
    
    @Autowired
    private UserDao userDao;
    
    @Autowired
    private RedisTemplate redisTemplate;
    
    /**
     * å»¶è¿ŸåŒåˆ ç­–ç•¥
     */
    public void updateUserWithDelayDoubleDelete(User user) {
        String cacheKey = "user:" + user.getId();
        
        try {
            // ğŸ—‘ ç¬¬ä¸€æ¬¡åˆ é™¤ç¼“å­˜
            redisTemplate.delete(cacheKey);
            log.info("ç¬¬ä¸€æ¬¡åˆ é™¤ç¼“å­˜: {}", cacheKey);
            
            // ğŸ’¾ æ›´æ–°æ•°æ®åº“
            userDao.updateUser(user);
            log.info("æ•°æ®åº“æ›´æ–°å®Œæˆ: {}", user.getId());
            
            // â° å»¶è¿Ÿåˆ é™¤ï¼ˆåŒæ­¥æ–¹å¼ï¼‰
            Thread.sleep(500);  // å»¶è¿Ÿ500æ¯«ç§’
            
            // ğŸ—‘ ç¬¬äºŒæ¬¡åˆ é™¤ç¼“å­˜
            redisTemplate.delete(cacheKey);
            log.info("ç¬¬äºŒæ¬¡åˆ é™¤ç¼“å­˜: {}", cacheKey);
            
        } catch (Exception e) {
            log.error("å»¶è¿ŸåŒåˆ ç­–ç•¥æ‰§è¡Œå¤±è´¥", e);
            throw new RuntimeException("æ›´æ–°å¤±è´¥");
        }
    }
}
```

#### ğŸ“ˆ å¼‚æ­¥ç‰ˆæœ¬å®ç°ï¼ˆæ¨èï¼‰

```java
@Service
public class UserService {
    
    @Autowired
    private UserDao userDao;
    
    @Autowired
    private RedisTemplate redisTemplate;
    
    @Autowired
    private TaskExecutor taskExecutor;
    
    /**
     * å¼‚æ­¥å»¶è¿ŸåŒåˆ ç­–ç•¥
     */
    public void updateUserWithAsyncDelayDelete(User user) {
        String cacheKey = "user:" + user.getId();
        
        try {
            // ğŸ—‘ ç¬¬ä¸€æ¬¡åˆ é™¤ç¼“å­˜
            redisTemplate.delete(cacheKey);
            
            // ğŸ’¾ æ›´æ–°æ•°æ®åº“
            userDao.updateUser(user);
            
            // ğŸ“¤ å¼‚æ­¥å»¶è¿Ÿåˆ é™¤ï¼ˆä¸é˜»å¡ä¸»æµç¨‹ï¼‰
            taskExecutor.execute(() -> {
                try {
                    Thread.sleep(500);  // å»¶è¿Ÿ500ms
                    redisTemplate.delete(cacheKey);
                    log.info("å¼‚æ­¥ç¬¬äºŒæ¬¡åˆ é™¤ç¼“å­˜å®Œæˆ: {}", cacheKey);
                } catch (Exception e) {
                    log.error("å¼‚æ­¥åˆ é™¤ç¼“å­˜å¤±è´¥: {}", cacheKey, e);
                    // å¯ä»¥åŠ å…¥é‡è¯•é˜Ÿåˆ—æˆ–å‘Šè­¦
                }
            });
            
        } catch (Exception e) {
            log.error("ç”¨æˆ·æ›´æ–°å¤±è´¥", e);
            throw new RuntimeException("æ›´æ–°å¤±è´¥");
        }
    }
}
```

### 5.3 å»¶è¿Ÿæ—¶é—´è®¾å®šæŠ€å·§


#### â° å»¶è¿Ÿæ—¶é—´çš„è®¡ç®—æ–¹æ³•

**ğŸ”¸ å»¶è¿Ÿæ—¶é—´ = è¯»å–æ•°æ®åº“çš„æ—¶é—´ + å†™å…¥ç¼“å­˜çš„æ—¶é—´ + å®‰å…¨ä½™é‡**

```java
/**
 * æ™ºèƒ½å»¶è¿Ÿæ—¶é—´è®¡ç®—
 */
@Component
public class CacheDelayCalculator {
    
    // æµ‹é‡æ•°æ®åº“è¯»å–æ—¶é—´
    public long measureDatabaseReadTime() {
        long start = System.currentTimeMillis();
        // æ‰§è¡Œå…¸å‹çš„æ•°æ®åº“æŸ¥è¯¢
        userDao.findById(testId);
        long end = System.currentTimeMillis();
        return end - start;
    }
    
    // æµ‹é‡ç¼“å­˜å†™å…¥æ—¶é—´  
    public long measureCacheWriteTime() {
        long start = System.currentTimeMillis();
        redisTemplate.opsForValue().set("test:key", "test:value");
        long end = System.currentTimeMillis();
        return end - start;
    }
    
    // è®¡ç®—æ¨èå»¶è¿Ÿæ—¶é—´
    public long getRecommendedDelay() {
        long dbTime = measureDatabaseReadTime();
        long cacheTime = measureCacheWriteTime();
        long safetyMargin = 100;  // 100mså®‰å…¨ä½™é‡
        
        return dbTime + cacheTime + safetyMargin;
    }
}
```

#### ğŸ“Š ä¸åŒåœºæ™¯çš„å»¶è¿Ÿæ—¶é—´å‚è€ƒ

| åœºæ™¯ç±»å‹ | æ•°æ®åº“å“åº”æ—¶é—´ | æ¨èå»¶è¿Ÿæ—¶é—´ | è¯´æ˜ |
|----------|---------------|-------------|------|
| **ç®€å•æŸ¥è¯¢** | 1-5ms | 100ms | ç”¨æˆ·ä¿¡æ¯ã€å•†å“åŸºç¡€ä¿¡æ¯ |
| **å¤æ‚æŸ¥è¯¢** | 10-50ms | 200ms | ç»Ÿè®¡æ•°æ®ã€å…³è”æŸ¥è¯¢ |
| **è¶…å¤æ‚æŸ¥è¯¢** | 100ms+ | 500ms | æŠ¥è¡¨æ•°æ®ã€å¤§é‡è®¡ç®— |
| **è·¨åº“æŸ¥è¯¢** | 50-200ms | 300-600ms | å¾®æœåŠ¡é—´è°ƒç”¨ |

### 5.4 å»¶è¿ŸåŒåˆ çš„æ”¹è¿›ç‰ˆæœ¬


#### ğŸ”„ é‡è¯•æœºåˆ¶ç‰ˆæœ¬

```java
@Component
public class DelayDoubleDeleteService {
    
    private static final int MAX_RETRY = 3;
    private static final long RETRY_DELAY = 1000;
    
    /**
     * å¸¦é‡è¯•çš„å»¶è¿ŸåŒåˆ 
     */
    public void delayDoubleDeleteWithRetry(String cacheKey) {
        CompletableFuture.runAsync(() -> {
            try {
                Thread.sleep(500);  // å»¶è¿Ÿç­‰å¾…
                
                // é‡è¯•åˆ é™¤é€»è¾‘
                for (int i = 0; i < MAX_RETRY; i++) {
                    try {
                        redisTemplate.delete(cacheKey);
                        log.info("ç¬¬äºŒæ¬¡åˆ é™¤ç¼“å­˜æˆåŠŸ: {} (é‡è¯•ç¬¬{}æ¬¡)", cacheKey, i + 1);
                        return;  // æˆåŠŸåˆ™é€€å‡º
                    } catch (Exception e) {
                        log.warn("ç¬¬äºŒæ¬¡åˆ é™¤ç¼“å­˜å¤±è´¥: {} (é‡è¯•ç¬¬{}æ¬¡)", cacheKey, i + 1);
                        if (i < MAX_RETRY - 1) {
                            Thread.sleep(RETRY_DELAY);  // é‡è¯•å‰ç­‰å¾…
                        }
                    }
                }
                
                // æ‰€æœ‰é‡è¯•éƒ½å¤±è´¥ï¼Œè®°å½•å‘Šè­¦
                log.error("å»¶è¿ŸåŒåˆ å½»åº•å¤±è´¥ï¼Œéœ€è¦äººå·¥ä»‹å…¥: {}", cacheKey);
                
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        });
    }
}
```

#### ğŸ“¨ æ¶ˆæ¯é˜Ÿåˆ—ç‰ˆæœ¬ï¼ˆä¼ä¸šçº§ï¼‰

```java
/**
 * åŸºäºæ¶ˆæ¯é˜Ÿåˆ—çš„å»¶è¿ŸåŒåˆ 
 */
@Component
public class MQDelayDoubleDelete {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    /**
     * å‘é€å»¶è¿Ÿåˆ é™¤æ¶ˆæ¯
     */
    public void sendDelayDeleteMessage(String cacheKey) {
        DelayDeleteMessage message = new DelayDeleteMessage(cacheKey, System.currentTimeMillis());
        
        // å‘é€å»¶è¿Ÿæ¶ˆæ¯ï¼ˆRabbitMQå»¶è¿Ÿæ’ä»¶ï¼‰
        rabbitTemplate.convertAndSend(
            "delay.exchange", 
            "cache.delete", 
            message,
            msg -> {
                msg.getMessageProperties().setDelay(500);  // å»¶è¿Ÿ500ms
                return msg;
            }
        );
        
        log.info("å‘é€å»¶è¿Ÿåˆ é™¤æ¶ˆæ¯: {}", cacheKey);
    }
    
    /**
     * æ¶ˆè´¹å»¶è¿Ÿåˆ é™¤æ¶ˆæ¯
     */
    @RabbitListener(queues = "cache.delete.queue")
    public void handleDelayDelete(DelayDeleteMessage message) {
        try {
            redisTemplate.delete(message.getCacheKey());
            log.info("æ¶ˆæ¯é˜Ÿåˆ—å»¶è¿Ÿåˆ é™¤æˆåŠŸ: {}", message.getCacheKey());
        } catch (Exception e) {
            log.error("æ¶ˆæ¯é˜Ÿåˆ—å»¶è¿Ÿåˆ é™¤å¤±è´¥: {}", message.getCacheKey(), e);
            // å¯ä»¥é‡æ–°æŠ•é€’åˆ°æ­»ä¿¡é˜Ÿåˆ—
        }
    }
}
```

---

## 6. ğŸ”€ ç¼“å­˜æ›´æ–°ç­–ç•¥å¯¹æ¯”


### 6.1 ç­–ç•¥å¯¹æ¯”åˆ†æ


| ç­–ç•¥ | **ä¸€è‡´æ€§** | **æ€§èƒ½** | **å¤æ‚åº¦** | **é€‚ç”¨åœºæ™¯** |
|------|-----------|---------|-----------|-------------|
| ğŸŸ¢ **å…ˆåˆ åå†™** | æœ€ç»ˆä¸€è‡´ | é«˜ | ç®€å• | ä¸€èˆ¬ä¸šåŠ¡åœºæ™¯ |
| ğŸ”µ **å»¶è¿ŸåŒåˆ ** | å¼ºä¸€è‡´è¶‹å‘ | ä¸­é«˜ | ä¸­ç­‰ | ä¸€è‡´æ€§è¦æ±‚é«˜ |
| ğŸŸ¡ **å…ˆå†™ååˆ ** | å¯èƒ½ä¸ä¸€è‡´ | æœ€é«˜ | æœ€ç®€å• | ä¸€è‡´æ€§è¦æ±‚ä½ |
| ğŸŸ£ **åˆ†å¸ƒå¼é”** | å¼ºä¸€è‡´ | è¾ƒä½ | å¤æ‚ | é‡‘èç­‰ä¸¥æ ¼åœºæ™¯ |

### 6.2 å®é™…é€‰æ‹©å»ºè®®


**ğŸ¯ æ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹é€‰æ‹©**ï¼š
```
ç”¨æˆ·ä¿¡æ¯ç±»ï¼ˆä¸€è‡´æ€§ä¸­ç­‰ï¼‰ï¼š
æ¨èï¼šå…ˆåˆ åå†™ âœ“
ç†ç”±ï¼šçŸ­æš‚ä¸ä¸€è‡´å¯æ¥å—ï¼Œæ€§èƒ½å¥½

å•†å“åº“å­˜ç±»ï¼ˆä¸€è‡´æ€§è¦æ±‚é«˜ï¼‰ï¼š
æ¨èï¼šå»¶è¿ŸåŒåˆ  + åˆ†å¸ƒå¼é” âœ“  
ç†ç”±ï¼šåº“å­˜é”™è¯¯å½±å“ä¸šåŠ¡

ç»Ÿè®¡æ•°æ®ç±»ï¼ˆä¸€è‡´æ€§è¦æ±‚ä½ï¼‰ï¼š
æ¨èï¼šå®šæ—¶åˆ·æ–° âœ“
ç†ç”±ï¼šå®æ—¶æ€§è¦æ±‚ä¸é«˜ï¼Œé™ä½å¤æ‚åº¦
```

### 6.3 æ··åˆç­–ç•¥å®è·µ


#### ğŸ¨ æ ¹æ®æ•°æ®ç±»å‹é‡‡ç”¨ä¸åŒç­–ç•¥

```java
@Service  
public class SmartCacheService {
    
    /**
     * æ ¹æ®æ•°æ®ç±»å‹æ™ºèƒ½é€‰æ‹©ç¼“å­˜ç­–ç•¥
     */
    public void smartUpdate(String dataType, String key, Object newValue) {
        
        switch (dataType) {
            case "USER_INFO":
                // ç”¨æˆ·ä¿¡æ¯ï¼šå…ˆåˆ åå†™
                simpleDeleteThenUpdate(key, newValue);
                break;
                
            case "PRODUCT_STOCK": 
                // å•†å“åº“å­˜ï¼šå»¶è¿ŸåŒåˆ 
                delayDoubleDelete(key, newValue);
                break;
                
            case "STATISTICS":
                // ç»Ÿè®¡æ•°æ®ï¼šå¼‚æ­¥æ›´æ–°  
                asyncUpdate(key, newValue);
                break;
                
            default:
                // é»˜è®¤ç­–ç•¥
                simpleDeleteThenUpdate(key, newValue);
        }
    }
}
```

---

## 7. ğŸ›¡ ç¼“å­˜ä¸€è‡´æ€§ä¿éšœæ–¹æ¡ˆ


### 7.1 ç›‘æ§å’Œæ£€æµ‹æœºåˆ¶


#### ğŸ“Š ä¸€è‡´æ€§ç›‘æ§

```java
@Component
public class CacheConsistencyMonitor {
    
    /**
     * å®šæœŸæ£€æŸ¥ç¼“å­˜ä¸€è‡´æ€§
     */
    @Scheduled(fixedRate = 60000)  // æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
    public void checkConsistency() {
        List<String> criticalKeys = getCriticalCacheKeys();
        
        for (String key : criticalKeys) {
            Object cacheValue = redisTemplate.opsForValue().get(key);
            Object dbValue = getDatabaseValue(key);
            
            if (!Objects.equals(cacheValue, dbValue)) {
                // å‘ç°ä¸ä¸€è‡´
                log.warn("ç¼“å­˜ä¸ä¸€è‡´æ£€æµ‹: key={}, cache={}, db={}", 
                        key, cacheValue, dbValue);
                
                // ä¿®å¤ä¸ä¸€è‡´
                redisTemplate.delete(key);
                sendAlert("ç¼“å­˜ä¸ä¸€è‡´å‘Šè­¦", key);
            }
        }
    }
}
```

### 7.2 é™çº§å’Œå…œåº•ç­–ç•¥


#### ğŸ”„ ç¼“å­˜é™çº§æ–¹æ¡ˆ

```java
@Service
public class CacheService {
    
    /**
     * å¸¦é™çº§çš„ç¼“å­˜æŸ¥è¯¢
     */
    public User getUserWithFallback(Long userId) {
        try {
            // å°è¯•ä»ç¼“å­˜è·å–
            User user = redisTemplate.opsForValue().get("user:" + userId);
            if (user != null) {
                return user;
            }
            
        } catch (Exception e) {
            log.warn("ç¼“å­˜æœåŠ¡å¼‚å¸¸ï¼Œé™çº§åˆ°æ•°æ®åº“æŸ¥è¯¢", e);
        }
        
        // ç¼“å­˜æœªå‘½ä¸­æˆ–å¼‚å¸¸ï¼ŒæŸ¥è¯¢æ•°æ®åº“
        User user = userDao.findById(userId);
        
        // å°è¯•å›å†™ç¼“å­˜ï¼ˆå¯é€‰ï¼‰
        try {
            redisTemplate.opsForValue().set("user:" + userId, user, Duration.ofMinutes(30));
        } catch (Exception e) {
            log.warn("å›å†™ç¼“å­˜å¤±è´¥ï¼Œä½†ä¸å½±å“ä¸šåŠ¡", e);
        }
        
        return user;
    }
}
```

### 7.3 åˆ†å¸ƒå¼åœºæ™¯çš„å¤„ç†


#### ğŸŒ å¤šå®ä¾‹ç¯å¢ƒä¸‹çš„æŒ‘æˆ˜

```
åˆ†å¸ƒå¼ç¯å¢ƒé—®é¢˜ï¼š

å•æœºç¯å¢ƒï¼š
App1 â†’ Redis â†’ Database
ï¼ˆç›¸å¯¹ç®€å•ï¼Œå»¶è¿Ÿå¯æ§ï¼‰

åˆ†å¸ƒå¼ç¯å¢ƒï¼š
App1 â”€â”
App2 â”€â”¤ â†’ Redis Cluster â†’ Database Cluster  
App3 â”€â”˜
ï¼ˆå¤æ‚åº¦æˆå€å¢åŠ ï¼‰

æ–°å¢æŒ‘æˆ˜ï¼š
- ç½‘ç»œåˆ†åŒºå¯èƒ½å¯¼è‡´éƒ¨åˆ†èŠ‚ç‚¹æ“ä½œå¤±è´¥
- ä¸åŒåº”ç”¨å®ä¾‹çš„æ“ä½œæ—¶åºéš¾ä»¥æ§åˆ¶  
- ç¼“å­˜é›†ç¾¤å’Œæ•°æ®åº“é›†ç¾¤çš„ä¸€è‡´æ€§æ›´éš¾ä¿è¯
```

#### ğŸ”„ åˆ†å¸ƒå¼ä¸€è‡´æ€§è§£å†³æ€è·¯

```java
/**
 * åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„ç¼“å­˜æ›´æ–°
 */
@Service
public class DistributedCacheService {
    
    @Autowired
    private RedisTemplate redisTemplate;
    
    @Autowired
    private DistributedLock distributedLock;
    
    /**
     * åŸºäºåˆ†å¸ƒå¼é”çš„å¼ºä¸€è‡´æ€§æ›´æ–°
     */
    public void updateWithLock(String key, Object value) {
        String lockKey = "lock:update:" + key;
        
        if (distributedLock.tryLock(lockKey, 5000)) {  // 5ç§’è¶…æ—¶
            try {
                // åœ¨é”ä¿æŠ¤ä¸‹è¿›è¡Œæ›´æ–°
                redisTemplate.delete(key);
                updateDatabase(key, value);
                
                // å»¶è¿ŸåŒåˆ 
                CompletableFuture.runAsync(() -> {
                    try {
                        Thread.sleep(500);
                        redisTemplate.delete(key);
                    } catch (Exception e) {
                        log.error("åˆ†å¸ƒå¼å»¶è¿Ÿåˆ é™¤å¤±è´¥", e);
                    }
                });
                
            } finally {
                distributedLock.unlock(lockKey);
            }
        } else {
            throw new RuntimeException("è·å–åˆ†å¸ƒå¼é”å¤±è´¥");
        }
    }
}
```

---

## 8. ğŸ“š å®æˆ˜æ¡ˆä¾‹åˆ†æ


### 8.1 ç”µå•†å•†å“ç¼“å­˜æ¡ˆä¾‹


#### ğŸ›’ ä¸šåŠ¡åœºæ™¯

```
ä¸šåŠ¡éœ€æ±‚ï¼š
- å•†å“ä¿¡æ¯æ›´æ–°é¢‘ç‡ï¼šä¸­ç­‰ï¼ˆæ¯å¤©å‡ åæ¬¡ï¼‰
- æŸ¥è¯¢é¢‘ç‡ï¼šæé«˜ï¼ˆæ¯ç§’ä¸Šåƒæ¬¡ï¼‰
- ä¸€è‡´æ€§è¦æ±‚ï¼šé«˜ï¼ˆä»·æ ¼é”™è¯¯å½±å“ä¸šåŠ¡ï¼‰
- æ€§èƒ½è¦æ±‚ï¼šé«˜ï¼ˆå½±å“ç”¨æˆ·ä½“éªŒï¼‰
```

**ğŸ”§ å®ç°æ–¹æ¡ˆ**ï¼š
```java
@Service
public class ProductCacheService {
    
    private static final String PRODUCT_KEY_PREFIX = "product:";
    private static final int CACHE_EXPIRE_MINUTES = 30;
    
    /**
     * å•†å“ä¿¡æ¯ç¼“å­˜è¯»å–
     */
    public Product getProduct(Long productId) {
        String cacheKey = PRODUCT_KEY_PREFIX + productId;
        
        // 1. æŸ¥è¯¢ç¼“å­˜
        Product product = redisTemplate.opsForValue().get(cacheKey);
        if (product != null) {
            return product;  // ç¼“å­˜å‘½ä¸­
        }
        
        // 2. ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“
        product = productDao.findById(productId);
        if (product != null) {
            // 3. å›å†™ç¼“å­˜ï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´
            redisTemplate.opsForValue().set(
                cacheKey, 
                product, 
                Duration.ofMinutes(CACHE_EXPIRE_MINUTES)
            );
        }
        
        return product;
    }
    
    /**
     * å•†å“ä¿¡æ¯æ›´æ–°ï¼ˆå»¶è¿ŸåŒåˆ ç­–ç•¥ï¼‰
     */
    public void updateProduct(Product product) {
        String cacheKey = PRODUCT_KEY_PREFIX + product.getId();
        
        // 1. ç¬¬ä¸€æ¬¡åˆ é™¤ç¼“å­˜
        redisTemplate.delete(cacheKey);
        
        // 2. æ›´æ–°æ•°æ®åº“
        productDao.updateProduct(product);
        
        // 3. å¼‚æ­¥å»¶è¿Ÿåˆ é™¤
        CompletableFuture.runAsync(() -> {
            try {
                Thread.sleep(300);  // å•†å“æŸ¥è¯¢ä¸€èˆ¬è¾ƒå¿«ï¼Œå»¶è¿Ÿ300ms
                redisTemplate.delete(cacheKey);
                log.info("å•†å“ç¼“å­˜å»¶è¿Ÿåˆ é™¤å®Œæˆ: {}", product.getId());
            } catch (Exception e) {
                log.error("å•†å“ç¼“å­˜å»¶è¿Ÿåˆ é™¤å¤±è´¥: {}", product.getId(), e);
                // å‘é€å‘Šè­¦æˆ–åŠ å…¥é‡è¯•é˜Ÿåˆ—
            }
        });
    }
}
```

### 8.2 ç”¨æˆ·ä¼šè¯ç¼“å­˜æ¡ˆä¾‹


#### ğŸ‘¤ ç”¨æˆ·ä¼šè¯ç®¡ç†

```java
@Service
public class UserSessionService {
    
    /**
     * ç”¨æˆ·ä¿¡æ¯æ›´æ–°ï¼ˆå½±å“ä¼šè¯ï¼‰
     */
    public void updateUserInfo(User user) {
        // ç”¨æˆ·ä¿¡æ¯å¯èƒ½å½±å“å¤šä¸ªç¼“å­˜
        List<String> relatedCacheKeys = Arrays.asList(
            "user:" + user.getId(),
            "user:profile:" + user.getId(),
            "user:permissions:" + user.getId()
        );
        
        try {
            // 1. æ‰¹é‡åˆ é™¤ç›¸å…³ç¼“å­˜
            redisTemplate.delete(relatedCacheKeys);
            
            // 2. æ›´æ–°æ•°æ®åº“
            userDao.updateUser(user);
            
            // 3. å»¶è¿ŸåŒåˆ ï¼ˆå¤„ç†å…³è”ç¼“å­˜ï¼‰
            CompletableFuture.runAsync(() -> {
                try {
                    Thread.sleep(400);
                    relatedCacheKeys.forEach(key -> {
                        try {
                            redisTemplate.delete(key);
                        } catch (Exception e) {
                            log.warn("å»¶è¿Ÿåˆ é™¤å¤±è´¥: {}", key);
                        }
                    });
                } catch (Exception e) {
                    log.error("ç”¨æˆ·ç›¸å…³ç¼“å­˜å»¶è¿Ÿåˆ é™¤å¼‚å¸¸", e);
                }
            });
            
        } catch (Exception e) {
            log.error("ç”¨æˆ·ä¿¡æ¯æ›´æ–°å¤±è´¥", e);
            throw new RuntimeException("ç”¨æˆ·ä¿¡æ¯æ›´æ–°å¤±è´¥");
        }
    }
}
```

---

## 9. âš  æ³¨æ„äº‹é¡¹ä¸é™·é˜±


### 9.1 å¸¸è§è¯¯åŒº


> âš ï¸ **è¯¯åŒº1ï¼šè¿‡åº¦ä¾èµ–ç¼“å­˜ä¸€è‡´æ€§**
> 
> å¾ˆå¤šæ–°æ‰‹è®¤ä¸ºç¼“å­˜å¿…é¡»å’Œæ•°æ®åº“å®æ—¶ä¸€è‡´ï¼Œä½†è¿™åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ä»£ä»·æé«˜ã€‚
> 
> **æ­£ç¡®ç†è§£**ï¼šå¤§å¤šæ•°ä¸šåŠ¡åœºæ™¯ä¸‹ï¼ŒçŸ­æš‚çš„æ•°æ®ä¸ä¸€è‡´æ˜¯å¯ä»¥æ¥å—çš„ã€‚

> ğŸ”¥ **è¯¯åŒº2ï¼šå¿½è§†ç¼“å­˜å¤±æ•ˆçš„å½±å“**  
> 
> åˆ é™¤ç¼“å­˜åå¦‚æœå¤§é‡è¯·æ±‚æ¶Œå…¥ï¼Œå¯èƒ½å‹å®æ•°æ®åº“ã€‚
> 
> **è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨äº’æ–¥é”æˆ–ä¿¡å·é‡é™åˆ¶å¹¶å‘é‡å»ºã€‚

```java
/**
 * é˜²æ­¢ç¼“å­˜å‡»ç©¿çš„å®‰å…¨åˆ é™¤
 */
public Object getWithMutex(String key) {
    Object value = redisTemplate.opsForValue().get(key);
    if (value != null) {
        return value;
    }
    
    // ä½¿ç”¨åˆ†å¸ƒå¼é”é˜²æ­¢å¤§é‡å¹¶å‘æŸ¥è¯¢æ•°æ®åº“
    String lockKey = "lock:" + key;
    if (distributedLock.tryLock(lockKey, 5000)) {
        try {
            // åŒé‡æ£€æŸ¥
            value = redisTemplate.opsForValue().get(key);
            if (value != null) {
                return value;
            }
            
            // æŸ¥è¯¢æ•°æ®åº“å¹¶ç¼“å­˜
            value = queryDatabase(key);
            redisTemplate.opsForValue().set(key, value, Duration.ofMinutes(30));
            
        } finally {
            distributedLock.unlock(lockKey);
        }
    }
    
    return value;
}
```

### 9.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®


**ğŸš€ æ€§èƒ½ä¼˜åŒ–è¦ç‚¹**ï¼š
```
æ‰¹é‡æ“ä½œï¼š
- ä½¿ç”¨pipelineæ‰¹é‡åˆ é™¤å¤šä¸ªç¼“å­˜key
- å‡å°‘ç½‘ç»œå¾€è¿”æ¬¡æ•°

å¼‚æ­¥å¤„ç†ï¼š
- å»¶è¿Ÿåˆ é™¤æ“ä½œå¼‚æ­¥æ‰§è¡Œ
- ä¸é˜»å¡ä¸»ä¸šåŠ¡æµç¨‹

åˆç†è®¾ç½®è¿‡æœŸæ—¶é—´ï¼š
- ç»“åˆå»¶è¿ŸåŒåˆ å’ŒTTLè¿‡æœŸ
- åŒé‡ä¿éšœæ•°æ®ä¸€è‡´æ€§

ç›‘æ§å‘Šè­¦ï¼š
- ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡
- å¼‚å¸¸æƒ…å†µåŠæ—¶å‘Šè­¦
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ ç¼“å­˜ä¸€è‡´æ€§ï¼šç¼“å­˜å’Œæ•°æ®åº“æ•°æ®ä¿æŒåŒæ­¥çš„é—®é¢˜
ğŸ”¸ åŒå†™ä¸€è‡´æ€§ï¼šåŒæ—¶å†™ç¼“å­˜å’Œæ•°æ®åº“å¸¦æ¥çš„æŒ‘æˆ˜
ğŸ”¸ å…ˆåˆ åå†™ï¼šç®€å•å®ç”¨çš„ç¼“å­˜æ›´æ–°ç­–ç•¥
ğŸ”¸ å»¶è¿ŸåŒåˆ ï¼šè§£å†³å¹¶å‘é—®é¢˜çš„æ”¹è¿›ç­–ç•¥
ğŸ”¸ ç­–ç•¥é€‰æ‹©ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆ
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸€è‡´æ€§é—®é¢˜çš„æœ¬è´¨**
```
æ ¸å¿ƒçŸ›ç›¾ï¼š
- ç¼“å­˜è¿½æ±‚æ€§èƒ½ â†â†’ ä¸€è‡´æ€§è¦æ±‚å‡†ç¡®
- åˆ†å¸ƒå¼ç¯å¢ƒ â†â†’ åŸå­æ“ä½œéœ€æ±‚
- é«˜å¹¶å‘è®¿é—® â†â†’ æ•°æ®åŒæ­¥æ§åˆ¶

è§£å†³æ€è·¯ï¼š
- æƒè¡¡å–èˆï¼šç»å¯¹ä¸€è‡´æ€§ä»£ä»·è¿‡é«˜
- æœ€ç»ˆä¸€è‡´æ€§ï¼šçŸ­æš‚ä¸ä¸€è‡´å¯ä»¥æ¥å—
- åˆ†å±‚å¤„ç†ï¼šä¸åŒæ•°æ®ä¸åŒç­–ç•¥
```

**ğŸ”¹ ç­–ç•¥é€‰æ‹©çš„ä¾æ®**
```
ä¸šåŠ¡å®¹å¿åº¦ï¼š
- ç”¨æˆ·æ˜µç§°ï¼šçŸ­æš‚ä¸ä¸€è‡´æ— æ‰€è°“
- è´¦æˆ·ä½™é¢ï¼šç»å¯¹ä¸èƒ½ä¸ä¸€è‡´
- å•†å“åº“å­˜ï¼šä¸ä¸€è‡´å¯èƒ½å½±å“é”€å”®

æŠ€æœ¯å¤æ‚åº¦ï¼š
- ç®€å•åœºæ™¯ï¼šå…ˆåˆ åå†™è¶³å¤Ÿ
- å¤æ‚åœºæ™¯ï¼šå»¶è¿ŸåŒåˆ  + ç›‘æ§
- æç«¯åœºæ™¯ï¼šåˆ†å¸ƒå¼äº‹åŠ¡

æ€§èƒ½å½±å“ï¼š
- ä¸€è‡´æ€§å¼ºåº¦ â†‘ â†’ æ€§èƒ½å¼€é”€ â†‘
- éœ€è¦åœ¨ä¸€è‡´æ€§å’Œæ€§èƒ½é—´å¹³è¡¡
```

### 10.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ æ–°æ‰‹å®è·µå»ºè®®**ï¼š
```
å­¦ä¹ è·¯å¾„ï¼š
1ï¸âƒ£ ç†è§£é—®é¢˜ï¼šå…ˆææ¸…æ¥šä¸ºä»€ä¹ˆä¼šä¸ä¸€è‡´
2ï¸âƒ£ ç®€å•æ–¹æ¡ˆï¼šä»å…ˆåˆ åå†™å¼€å§‹å®è·µ
3ï¸âƒ£ ç›‘æ§è§‚å¯Ÿï¼šåŠ å…¥æ—¥å¿—è§‚å¯Ÿä¸€è‡´æ€§æƒ…å†µ
4ï¸âƒ£ é€æ­¥ä¼˜åŒ–ï¼šæ ¹æ®å®é™…æƒ…å†µé€‰æ‹©å»¶è¿ŸåŒåˆ 
5ï¸âƒ£ ç»¼åˆæ–¹æ¡ˆï¼šç»“åˆä¸šåŠ¡ç‰¹ç‚¹è®¾è®¡ç»¼åˆç­–ç•¥
```

**ğŸ”§ ç”Ÿäº§ç¯å¢ƒå»ºè®®**ï¼š
```
è®¾è®¡åŸåˆ™ï¼š
- é»˜è®¤ç­–ç•¥ï¼šå…ˆåˆ åå†™ï¼ˆç®€å•å¯é ï¼‰
- å…³é”®ä¸šåŠ¡ï¼šå»¶è¿ŸåŒåˆ  + ç›‘æ§
- æç«¯åœºæ™¯ï¼šåˆ†å¸ƒå¼é” + è¡¥å¿æœºåˆ¶

è¿ç»´è¦ç‚¹ï¼š
- ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡å’Œä¸€è‡´æ€§
- å»ºç«‹ç¼“å­˜å¤±æ•ˆçš„åº”æ€¥é¢„æ¡ˆ  
- å®šæœŸæ£€æŸ¥å’Œæ¸…ç†è¿‡æœŸç¼“å­˜
- è®°å½•å’Œåˆ†æä¸€è‡´æ€§é—®é¢˜
```

### 10.4 å­¦ä¹ æ£€æŸ¥æ¸…å•


**ğŸ“ è‡ªæˆ‘æ£€æµ‹**ï¼š
- [x] ç†è§£ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜çš„äº§ç”ŸåŸå› 
- [x] æŒæ¡å…ˆåˆ åå†™ç­–ç•¥çš„å®ç°å’Œé—®é¢˜
- [x] ç†è§£å»¶è¿ŸåŒåˆ ç­–ç•¥çš„è®¾è®¡æ€æƒ³
- [x] èƒ½å¤Ÿæ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰æ‹©åˆé€‚ç­–ç•¥
- [x] äº†è§£åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„é¢å¤–æŒ‘æˆ˜
- [ ] èƒ½å¤Ÿè®¾è®¡å®Œæ•´çš„ç¼“å­˜ä¸€è‡´æ€§æ–¹æ¡ˆ
- [ ] æŒæ¡ç¼“å­˜ä¸€è‡´æ€§çš„ç›‘æ§å’Œè¿ç»´

---

> ğŸ§  **è®°å¿†å£è¯€**
> 
> *"ç¼“å­˜ä¸€è‡´æ˜¯éš¾é¢˜ï¼Œå…ˆåˆ åå†™æ˜¯åŸºç¡€ï¼›*  
> *å»¶è¿ŸåŒåˆ è§£å¹¶å‘ï¼Œç­–ç•¥é€‰æ‹©çœ‹ä¸šåŠ¡ï¼›*  
> *ç›‘æ§å‘Šè­¦ä¸å¯å°‘ï¼Œé™çº§å…œåº•è¦åšå¥½ï¼"*

**ğŸ¯ å­¦ä¹ é‡ç‚¹**ï¼š
- ç¼“å­˜ä¸€è‡´æ€§æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„ç»å…¸é—®é¢˜
- æ²¡æœ‰å®Œç¾æ–¹æ¡ˆï¼Œåªæœ‰æœ€é€‚åˆçš„æ–¹æ¡ˆ
- ç†è§£ä¸šåŠ¡éœ€æ±‚æ¯”è¿½æ±‚æŠ€æœ¯å®Œç¾æ›´é‡è¦
- å®è·µä¸­çš„ç›‘æ§å’Œè¿ç»´åŒæ ·å…³é”®