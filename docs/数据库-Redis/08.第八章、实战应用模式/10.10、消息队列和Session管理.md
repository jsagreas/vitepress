---
title: 10ã€æ¶ˆæ¯é˜Ÿåˆ—å’ŒSessionç®¡ç†
---
## ğŸ“š ç›®å½•

1. [Listé˜Ÿåˆ—ç³»ç»Ÿ](#1-Listé˜Ÿåˆ—ç³»ç»Ÿ)
2. [Streamé˜Ÿåˆ—é«˜çº§ç‰¹æ€§](#2-Streamé˜Ÿåˆ—é«˜çº§ç‰¹æ€§)
3. [å‘å¸ƒè®¢é˜…æ¨¡å¼](#3-å‘å¸ƒè®¢é˜…æ¨¡å¼)
4. [Sessionå­˜å‚¨ç®¡ç†](#4-Sessionå­˜å‚¨ç®¡ç†)
5. [Redis Sessionè§£å†³æ–¹æ¡ˆ](#5-Redis-Sessionè§£å†³æ–¹æ¡ˆ)
6. [Tokenè®¤è¯ä½“ç³»](#6-Tokenè®¤è¯ä½“ç³»)
7. [åº”ç”¨é›†æˆå®è·µ](#7-åº”ç”¨é›†æˆå®è·µ)
8. [æ¶ˆæ¯é˜Ÿåˆ—åº”ç”¨åœºæ™¯](#8-æ¶ˆæ¯é˜Ÿåˆ—åº”ç”¨åœºæ™¯)
9. [ç³»ç»Ÿå¯¹æ¯”åˆ†æ](#9-ç³»ç»Ÿå¯¹æ¯”åˆ†æ)
10. [å®‰å…¨é˜²æŠ¤](#10-å®‰å…¨é˜²æŠ¤)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ“‹ Listé˜Ÿåˆ—ç³»ç»Ÿ


### 1.1 Listå®ç°ç®€å•é˜Ÿåˆ—


**ğŸ’¡ ä»€ä¹ˆæ˜¯Listé˜Ÿåˆ—**ï¼šRedisçš„Listæ•°æ®ç»“æ„å¤©ç„¶æ”¯æŒé˜Ÿåˆ—æ“ä½œï¼Œå°±åƒç°å®ä¸­çš„æ’é˜Ÿç³»ç»Ÿ

```
Listé˜Ÿåˆ—å·¥ä½œåŸç†ï¼š
ç”Ÿäº§è€… â†’ [æ¶ˆæ¯3][æ¶ˆæ¯2][æ¶ˆæ¯1] â†’ æ¶ˆè´¹è€…
         â†‘                  â†‘
      LPUSHå…¥é˜Ÿ          RPOPå‡ºé˜Ÿ

ç‰¹ç‚¹ï¼šå…ˆè¿›å…ˆå‡º(FIFO)ï¼Œæ“ä½œç®€å•ï¼Œæ€§èƒ½é«˜æ•ˆ
```

**ğŸ”¸ Listé˜Ÿåˆ—æ ¸å¿ƒæ¦‚å¿µ**
```
é˜Ÿåˆ—ç‰¹æ€§ï¼š
âœ… FIFOé¡ºåºï¼šä¸¥æ ¼æŒ‰ç…§å…ˆè¿›å…ˆå‡ºé¡ºåº
âœ… åŸå­æ“ä½œï¼šæ‰€æœ‰é˜Ÿåˆ—æ“ä½œéƒ½æ˜¯åŸå­æ€§çš„
âœ… é˜»å¡æ”¯æŒï¼šæ”¯æŒé˜»å¡å¼ç­‰å¾…æ–°æ¶ˆæ¯
âœ… å¤šæ¶ˆè´¹è€…ï¼šå¤šä¸ªæ¶ˆè´¹è€…å¯ä»¥ç«äº‰æ¶ˆè´¹æ¶ˆæ¯
```

### 1.2 Listé˜Ÿåˆ—æ ¸å¿ƒæ“ä½œ


**ğŸ“¤ LPUSH - ç”Ÿäº§æ¶ˆæ¯**
```bash
# ä»åˆ—è¡¨å·¦ä¾§æ¨å…¥æ¶ˆæ¯
LPUSH order_queue "è®¢å•å¤„ç†:ORD001"
LPUSH order_queue "å‘é€é‚®ä»¶:user@example.com"
LPUSH order_queue "ç”ŸæˆæŠ¥è¡¨:daily_2024"

# æŸ¥çœ‹é˜Ÿåˆ—çŠ¶æ€
LRANGE order_queue 0 -1
# è¿”å›ï¼š
# 1) "ç”ŸæˆæŠ¥è¡¨:daily_2024"     â† æœ€æ–°æ¶ˆæ¯(é˜Ÿåˆ—å¤´)
# 2) "å‘é€é‚®ä»¶:user@example.com"
# 3) "è®¢å•å¤„ç†:ORD001"        â† æœ€æ—©æ¶ˆæ¯(é˜Ÿåˆ—å°¾)
```

**ğŸ“¥ RPOP - æ¶ˆè´¹æ¶ˆæ¯**
```bash
# ä»åˆ—è¡¨å³ä¾§å¼¹å‡ºæ¶ˆæ¯(æœ€æ—©çš„æ¶ˆæ¯)
RPOP order_queue    # è¿”å›ï¼š"è®¢å•å¤„ç†:ORD001"
RPOP order_queue    # è¿”å›ï¼š"å‘é€é‚®ä»¶:user@example.com"  
RPOP order_queue    # è¿”å›ï¼š"ç”ŸæˆæŠ¥è¡¨:daily_2024"
RPOP order_queue    # è¿”å›ï¼š(nil) - é˜Ÿåˆ—ä¸ºç©º

ç‰¹ç‚¹ï¼šæ¶ˆæ¯è¢«æ¶ˆè´¹åç«‹å³ä»é˜Ÿåˆ—ä¸­åˆ é™¤
```

**â³ BRPOP - é˜»å¡é˜Ÿåˆ—**
```bash
# é˜»å¡å¼è·å–æ¶ˆæ¯ï¼Œè§£å†³ç©ºè½®è¯¢é—®é¢˜
BRPOP order_queue 30    # ç­‰å¾…30ç§’ï¼Œæœ‰æ¶ˆæ¯ç«‹å³è¿”å›
BRPOP order_queue 0     # æ°¸ä¹…ç­‰å¾…ï¼Œç›´åˆ°æœ‰æ–°æ¶ˆæ¯

# è¿”å›æ ¼å¼
1) "order_queue"        # é˜Ÿåˆ—åç§°
2) "è®¢å•å¤„ç†:ORD001"    # æ¶ˆæ¯å†…å®¹

# å¤šé˜Ÿåˆ—ç›‘å¬
BRPOP queue1 queue2 queue3 10    # åŒæ—¶ç›‘å¬å¤šä¸ªé˜Ÿåˆ—
```

**ğŸ“¥ BLPOP - é˜»å¡è·å–**
```bash
# ä»å·¦ä¾§é˜»å¡è·å–(è·å–æœ€æ–°æ¶ˆæ¯)
BLPOP order_queue 30    # ä¸BRPOPæ–¹å‘ç›¸å

ä½¿ç”¨åŒºåˆ«ï¼š
BRPOPï¼šè·å–æœ€æ—©çš„æ¶ˆæ¯(å¸¸ç”¨äºFIFOé˜Ÿåˆ—)
BLPOPï¼šè·å–æœ€æ–°çš„æ¶ˆæ¯(ç±»ä¼¼æ ˆçš„LIFOæ¨¡å¼)
```

### 1.3 è¶…æ—¶è®¾ç½®æœºåˆ¶


**â° é˜»å¡è¶…æ—¶è¯¦è§£**
```bash
# è¶…æ—¶å‚æ•°è¯´æ˜
BRPOP queue_name 0      # æ°¸ä¹…ç­‰å¾…ï¼Œç›´åˆ°æœ‰æ¶ˆæ¯æˆ–è¿æ¥æ–­å¼€
BRPOP queue_name 30     # ç­‰å¾…30ç§’ï¼Œè¶…æ—¶è¿”å›(nil)
BRPOP queue_name 1      # ç­‰å¾…1ç§’ï¼Œé€‚åˆé«˜é¢‘æ£€æŸ¥

# è¶…æ—¶å¤„ç†ç­–ç•¥
def consumer_with_timeout():
    while True:
        result = redis.brpop("task_queue", timeout=30)
        if result:
            queue_name, message = result
            process_message(message)
        else:
            # è¶…æ—¶å¤„ç†ï¼šæ£€æŸ¥ç³»ç»ŸçŠ¶æ€ã€è®°å½•å¿ƒè·³ç­‰
            health_check()
```

### 1.4 ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼


**ğŸ­ åŸºç¡€ç”Ÿäº§æ¶ˆè´¹æ¶æ„**
```
ç”Ÿäº§æ¶ˆè´¹æ¨¡å¼æ¶æ„ï¼š
                    Redis Listé˜Ÿåˆ—
ç”Ÿäº§è€…1 â”€â”€â”        â”Œâ”€[æ¶ˆæ¯A]â”€â”        â”Œâ”€â”€ æ¶ˆè´¹è€…1
ç”Ÿäº§è€…2 â”€â”€â”¼â”€LPUSHâ”€â†’â”‚[æ¶ˆæ¯B]  â”‚â”€BRPOPâ”€â†’â”œâ”€â”€ æ¶ˆè´¹è€…2  
ç”Ÿäº§è€…3 â”€â”€â”˜        â””â”€[æ¶ˆæ¯C]â”€â”˜        â””â”€â”€ æ¶ˆè´¹è€…3

ç‰¹ç‚¹ï¼šç”Ÿäº§è€…è´Ÿè´£äº§ç”Ÿä»»åŠ¡ï¼Œæ¶ˆè´¹è€…ç«äº‰å¤„ç†ä»»åŠ¡
```

**ğŸ”„ å®Œæ•´å®ç°ç¤ºä¾‹**
```python
import redis
import json
import time

# ç”Ÿäº§è€…å®ç°
class TaskProducer:
    def __init__(self):
        self.redis_client = redis.Redis(host='localhost', port=6379)
    
    def send_task(self, task_type, task_data):
        task = {
            "id": generate_task_id(),
            "type": task_type,
            "data": task_data,
            "created_time": time.time()
        }
        self.redis_client.lpush("task_queue", json.dumps(task))
        print(f"ä»»åŠ¡å·²å‘é€ï¼š{task['id']}")

# æ¶ˆè´¹è€…å®ç°
class TaskConsumer:
    def __init__(self, consumer_id):
        self.redis_client = redis.Redis(host='localhost', port=6379)
        self.consumer_id = consumer_id
    
    def start_consuming(self):
        while True:
            # é˜»å¡ç­‰å¾…ä»»åŠ¡
            result = self.redis_client.brpop("task_queue", timeout=30)
            if result:
                queue_name, task_json = result
                task = json.loads(task_json)
                self.process_task(task)
    
    def process_task(self, task):
        print(f"æ¶ˆè´¹è€…{self.consumer_id}å¤„ç†ä»»åŠ¡ï¼š{task['id']}")
        # å…·ä½“ä¸šåŠ¡å¤„ç†é€»è¾‘
```

### 1.5 å¤šæ¶ˆè´¹è€…å¤„ç†


**ğŸ‘¥ å¤šæ¶ˆè´¹è€…åä½œæœºåˆ¶**
```bash
# åœºæ™¯ï¼šå¤šä¸ªæ¶ˆè´¹è€…å¤„ç†åŒä¸€é˜Ÿåˆ—
æ¶ˆè´¹è€…A: BRPOP order_queue 30
æ¶ˆè´¹è€…B: BRPOP order_queue 30
æ¶ˆè´¹è€…C: BRPOP order_queue 30

# Redisè‡ªåŠ¨åˆ†å‘æœºåˆ¶
è®¢å•æ¶ˆæ¯1 â†’ æ¶ˆè´¹è€…Aè·å–å¹¶å¤„ç†
è®¢å•æ¶ˆæ¯2 â†’ æ¶ˆè´¹è€…Bè·å–å¹¶å¤„ç†  
è®¢å•æ¶ˆæ¯3 â†’ æ¶ˆè´¹è€…Cè·å–å¹¶å¤„ç†

è‡ªåŠ¨è´Ÿè½½å‡è¡¡ï¼šç©ºé—²æ¶ˆè´¹è€…ä¼˜å…ˆè·å–æ–°æ¶ˆæ¯
```

**âš–ï¸ è´Ÿè½½åˆ†é…ç‰¹æ€§**
```
å…¬å¹³åˆ†å‘ï¼šRedisä¿è¯æ¶ˆæ¯å‡åŒ€åˆ†å‘ç»™æ´»è·ƒæ¶ˆè´¹è€…
ç«äº‰æ¶ˆè´¹ï¼šæ¯ä¸ªæ¶ˆæ¯åªä¼šè¢«ä¸€ä¸ªæ¶ˆè´¹è€…è·å–
é«˜å¯ç”¨ï¼šå•ä¸ªæ¶ˆè´¹è€…æ•…éšœä¸å½±å“æ•´ä½“å¤„ç†
å¼¹æ€§æ‰©å±•ï¼šå¯éšæ—¶å¢å‡æ¶ˆè´¹è€…æ•°é‡

å®é™…åº”ç”¨ï¼š
ç”µå•†è®¢å•å¤„ç†ï¼šå¤šä¸ªè®¢å•å¤„ç†å™¨å¹¶è¡Œå·¥ä½œ
é‚®ä»¶å‘é€ï¼šå¤šä¸ªé‚®ä»¶æœåŠ¡å™¨åˆ†æ‹…å‘é€ä»»åŠ¡
å›¾ç‰‡å¤„ç†ï¼šå¤šä¸ªå›¾ç‰‡å¤„ç†æœåŠ¡å™¨å¹¶è¡Œå¤„ç†
```

### 1.6 æ¶ˆæ¯å¯é æ€§ä¿è¯


**ğŸ›¡ï¸ å¯é æ€§é—®é¢˜åˆ†æ**
```bash
# é—®é¢˜åœºæ™¯ï¼šæ¶ˆè´¹è€…è·å–æ¶ˆæ¯åå´©æºƒ
ç”Ÿäº§è€…ï¼šLPUSH task_queue "é‡è¦ä»»åŠ¡"
æ¶ˆè´¹è€…ï¼šmessage = BRPOP task_queue 0    # è·å–æ¶ˆæ¯
        # æ­¤æ—¶æ¶ˆè´¹è€…å´©æºƒï¼Œæ¶ˆæ¯ä¸¢å¤±ï¼

é—®é¢˜æ ¹æºï¼šRPOP/BRPOPæ˜¯ç ´åæ€§æ“ä½œï¼Œæ¶ˆæ¯å‡ºé˜Ÿåå°±æ¶ˆå¤±äº†
```

**ğŸ”§ RPOPLPUSHå®ç°å¯é é˜Ÿåˆ—**
```bash
# ä½¿ç”¨RPOPLPUSHå®ç°å¯é æ¶ˆæ¯å¤„ç†
RPOPLPUSH source_queue processing_queue

# å®Œæ•´å¤„ç†æµç¨‹
def reliable_process():
    # 1. åŸå­æ€§ç§»åŠ¨æ¶ˆæ¯
    message = RPOPLPUSH("work_queue", "processing_queue")
    
    try:
        # 2. å¤„ç†æ¶ˆæ¯
        process_business_logic(message)
        
        # 3. å¤„ç†æˆåŠŸï¼Œä»processingé˜Ÿåˆ—åˆ é™¤
        LREM("processing_queue", 1, message)
        
    except Exception as e:
        # 4. å¤„ç†å¤±è´¥ï¼Œæ¶ˆæ¯ä¿ç•™åœ¨processingé˜Ÿåˆ—
        log_error(f"æ¶ˆæ¯å¤„ç†å¤±è´¥: {message}, é”™è¯¯: {e}")
        # å¯ä»¥ç¨åé‡è¯•æˆ–è½¬å…¥æ­»ä¿¡é˜Ÿåˆ—
```

### 1.7 æ¶ˆæ¯å¤„ç†ç¡®è®¤


**âœ… æ¶ˆæ¯ç¡®è®¤æœºåˆ¶å®ç°**
```bash
# åŸºäºListçš„æ¶ˆæ¯ç¡®è®¤æ¨¡å¼
def message_with_ack():
    # 1. æ¶ˆè´¹æ¶ˆæ¯ï¼ˆç§»åŠ¨åˆ°å¤„ç†é˜Ÿåˆ—ï¼‰
    message = RPOPLPUSH("task_queue", "processing:worker1")
    
    if message:
        try:
            # 2. å¤„ç†ä¸šåŠ¡é€»è¾‘
            result = process_task(message)
            
            # 3. å¤„ç†æˆåŠŸç¡®è®¤
            LREM("processing:worker1", 1, message)
            log_success(f"æ¶ˆæ¯ç¡®è®¤å®Œæˆ: {message}")
            
        except Exception as e:
            # 4. å¤„ç†å¤±è´¥ï¼Œæ¶ˆæ¯ä¿ç•™ç­‰å¾…é‡è¯•
            increment_retry_count(message)
            log_error(f"æ¶ˆæ¯å¤„ç†å¤±è´¥ï¼Œç­‰å¾…é‡è¯•: {message}")

# é‡è¯•æœºåˆ¶
def retry_failed_messages():
    processing_queues = ["processing:worker1", "processing:worker2"]
    for queue in processing_queues:
        messages = LRANGE(queue, 0, -1)
        for message in messages:
            retry_count = get_retry_count(message)
            if retry_count < 3:
                # é‡æ–°æŠ•å…¥å·¥ä½œé˜Ÿåˆ—
                LREM(queue, 1, message)
                LPUSH("task_queue", message)
            else:
                # è¶…è¿‡é‡è¯•æ¬¡æ•°ï¼Œç§»å…¥æ­»ä¿¡é˜Ÿåˆ—
                LREM(queue, 1, message) 
                LPUSH("dead_letter_queue", message)
```

### 1.8 é”™è¯¯æ¶ˆæ¯å¤„ç†


**ğŸš¨ é”™è¯¯å¤„ç†ç­–ç•¥**
```bash
# é”™è¯¯åˆ†ç±»å¤„ç†
def handle_message_error(message, error):
    error_type = classify_error(error)
    
    if error_type == "TEMPORARY":
        # ä¸´æ—¶é”™è¯¯ï¼šç½‘ç»œè¶…æ—¶ã€æœåŠ¡æš‚æ—¶ä¸å¯ç”¨
        LPUSH("retry_queue", message)
        
    elif error_type == "BUSINESS":
        # ä¸šåŠ¡é”™è¯¯ï¼šæ•°æ®æ ¼å¼é”™è¯¯ã€ä¸šåŠ¡è§„åˆ™ä¸ç¬¦
        LPUSH("business_error_queue", message)
        
    elif error_type == "FATAL":
        # è‡´å‘½é”™è¯¯ï¼šä»£ç é”™è¯¯ã€ç³»ç»Ÿå¼‚å¸¸
        LPUSH("dead_letter_queue", message)

# å»¶æ—¶é‡è¯•é˜Ÿåˆ—
def delayed_retry():
    # è®¾ç½®é‡è¯•æ—¶é—´
    retry_time = int(time.time()) + 300  # 5åˆ†é’Ÿåé‡è¯•
    ZADD("delayed_retry", retry_time, message)
    
    # å®šæ—¶æ‰«æåˆ°æœŸçš„é‡è¯•æ¶ˆæ¯
    current_time = int(time.time())
    expired_messages = ZRANGEBYSCORE("delayed_retry", 0, current_time)
    for message in expired_messages:
        LPUSH("task_queue", message)  # é‡æ–°å…¥é˜Ÿ
        ZREM("delayed_retry", message)  # ä»å»¶æ—¶é˜Ÿåˆ—åˆ é™¤
```

### 1.9 é˜Ÿåˆ—é•¿åº¦ç›‘æ§


**ğŸ“Š é˜Ÿåˆ—ç›‘æ§å®ç°**
```bash
# åŸºç¡€é˜Ÿåˆ—é•¿åº¦ç›‘æ§
def monitor_queue_length():
    queue_names = ["task_queue", "email_queue", "order_queue"]
    
    for queue_name in queue_names:
        length = LLEN(queue_name)
        
        # è®¾ç½®å‘Šè­¦é˜ˆå€¼
        if length > 1000:
            send_critical_alert(f"{queue_name}ä¸¥é‡ç§¯å‹: {length}æ¡")
        elif length > 500:
            send_warning_alert(f"{queue_name}å¼€å§‹ç§¯å‹: {length}æ¡")
        elif length > 100:
            log_info(f"{queue_name}é˜Ÿåˆ—é•¿åº¦: {length}")

# æ¶ˆè´¹é€Ÿç‡ç›‘æ§
def monitor_consumption_rate():
    queue_name = "task_queue"
    
    # è®°å½•å½“å‰é•¿åº¦
    current_length = LLEN(queue_name)
    SETEX(f"queue_snapshot:{queue_name}", 60, current_length)
    
    # è·å–1åˆ†é’Ÿå‰çš„é•¿åº¦
    previous_length = GET(f"queue_snapshot:{queue_name}")
    
    if previous_length:
        consumption_rate = int(previous_length) - current_length
        
        if consumption_rate < 0:
            alert("ç”Ÿäº§é€Ÿåº¦è¶…è¿‡æ¶ˆè´¹é€Ÿåº¦ï¼Œé˜Ÿåˆ—ç§¯å‹åŠ å‰§")
        elif consumption_rate < 10:
            warn("æ¶ˆè´¹é€Ÿåº¦è¿‡æ…¢ï¼Œè€ƒè™‘å¢åŠ æ¶ˆè´¹è€…")
```

### 1.10 ç®€å•é˜Ÿåˆ—å±€é™æ€§


**âŒ ä¸æ”¯æŒé‡å¤æ¶ˆè´¹**
```bash
# é—®é¢˜æ¼”ç¤º
LPUSH news_queue "é‡è¦æ–°é—»ï¼šRedis 7.0å‘å¸ƒ"

# ç¬¬ä¸€ä¸ªæ¶ˆè´¹è€…
news = RPOP news_queue    # è·å–æ¶ˆæ¯ï¼Œæ¶ˆæ¯ä»é˜Ÿåˆ—ä¸­åˆ é™¤

# ç¬¬äºŒä¸ªæ¶ˆè´¹è€…
news = RPOP news_queue    # è¿”å›(nil)ï¼Œæ— æ³•è·å–åŒä¸€æ¶ˆæ¯

é—®é¢˜ï¼šæ¶ˆæ¯åªèƒ½è¢«æ¶ˆè´¹ä¸€æ¬¡ï¼Œæ— æ³•å®ç°å¤šä¸ªç³»ç»Ÿå¤„ç†åŒä¸€äº‹ä»¶
è§£å†³ï¼šä½¿ç”¨Streamé˜Ÿåˆ—æˆ–å‘å¸ƒè®¢é˜…æ¨¡å¼
```

**ğŸ“ å…¶ä»–å±€é™æ€§**
```
æ¶ˆæ¯ä¸¢å¤±é£é™©ï¼š
- æ¶ˆè´¹è€…è·å–æ¶ˆæ¯åå´©æºƒï¼Œæ¶ˆæ¯æ°¸ä¹…ä¸¢å¤±
- éœ€è¦é¢å¤–å®ç°ç¡®è®¤æœºåˆ¶

æ— ä¼˜å…ˆçº§ï¼š
- æ— æ³•å®ç°é«˜ä¼˜å…ˆçº§æ¶ˆæ¯ä¼˜å…ˆå¤„ç†
- ä¸¥æ ¼æŒ‰ç…§FIFOé¡ºåº

æ— æ¶ˆæ¯å›æº¯ï¼š
- æ¶ˆæ¯æ¶ˆè´¹åæ— æ³•é‡æ–°è·å–
- æ— æ³•å®ç°æ¶ˆæ¯é‡æ”¾åŠŸèƒ½

æ‰©å±•æ€§é™åˆ¶ï¼š
- éš¾ä»¥å®ç°å¤æ‚çš„æ¶ˆæ¯è·¯ç”±
- æ— æ³•æ”¯æŒæ¶ˆæ¯åˆ†åŒº
```

---

## 2. ğŸŒŠ Streamé˜Ÿåˆ—é«˜çº§ç‰¹æ€§


### 2.1 StreamåŸºç¡€æ“ä½œ


**ğŸ’¡ Streamé˜Ÿåˆ—æ¦‚å¿µ**ï¼šRedis 5.0å¼•å…¥çš„å¼ºå¤§æ¶ˆæ¯æµï¼Œæ”¯æŒæ¶ˆæ¯æŒä¹…åŒ–å’Œé‡å¤æ¶ˆè´¹

```
Streamæ¶ˆæ¯æµç»“æ„ï¼š
æ¶ˆæ¯ID: 1577836800000-0    1577836801000-0    1577836802000-0
æ¶ˆæ¯:   {user: "å¼ ä¸‰",       {user: "æå››",       {user: "ç‹äº”", 
        action: "login"}    action: "order"}    action: "pay"}
        â†‘                   â†‘                   â†‘
      æŒä¹…åŒ–æ¶ˆæ¯1           æŒä¹…åŒ–æ¶ˆæ¯2         æŒä¹…åŒ–æ¶ˆæ¯3

ç‰¹ç‚¹ï¼šæ¶ˆæ¯æ°¸ä¹…ä¿å­˜ï¼Œæ”¯æŒå¤šæ¶ˆè´¹ç»„ï¼Œè‡ªåŠ¨ç”Ÿæˆæœ‰åºID
```

**ğŸ“¤ XADD - æ¶ˆæ¯ç”Ÿäº§**
```bash
# åŸºæœ¬è¯­æ³•
XADD stream_name ID field1 value1 field2 value2

# è‡ªåŠ¨ç”ŸæˆIDï¼ˆæ¨èï¼‰
XADD user_events * user_id "1001" action "login" ip "192.168.1.100"
# è¿”å›ï¼š1724901600000-0

XADD order_events * order_id "ORD001" user_id "1001" amount "299.99" 
# è¿”å›ï¼š1724901601000-0

# æ¶ˆæ¯IDæ ¼å¼ï¼šæ¯«ç§’æ—¶é—´æˆ³-åºå·
# 1724901600000-0 è¡¨ç¤ºï¼š2024å¹´8æœˆ29æ—¥æŸæ—¶åˆ»çš„ç¬¬ä¸€æ¡æ¶ˆæ¯
```

**ğŸ“¥ XREAD - æ¶ˆæ¯æ¶ˆè´¹**
```bash
# åŸºç¡€æ¶ˆè´¹æ–¹å¼
XREAD STREAMS user_events 0-0           # ä»å¤´å¼€å§‹è¯»å–æ‰€æœ‰æ¶ˆæ¯
XREAD STREAMS user_events $             # åªè¯»å–æ–°æ¶ˆæ¯
XREAD STREAMS user_events 1724901600000-0    # ä»æŒ‡å®šIDåè¯»å–

# é˜»å¡ç­‰å¾…æ–°æ¶ˆæ¯
XREAD BLOCK 5000 STREAMS user_events $  # é˜»å¡5ç§’ç­‰å¾…

# æ‰¹é‡è¯»å–
XREAD COUNT 10 STREAMS user_events 0-0  # æœ€å¤šè¯»å–10æ¡æ¶ˆæ¯
```

### 2.2 æŒä¹…åŒ–ç‰¹æ€§


**ğŸ’¾ StreamæŒä¹…åŒ–æœºåˆ¶**
```bash
# StreamæŒä¹…åŒ–ä¼˜åŠ¿
ç‰¹ç‚¹ï¼šæ¶ˆæ¯æ°¸ä¹…ä¿å­˜åœ¨Streamä¸­ï¼Œä¸ä¼šå› ä¸ºæ¶ˆè´¹è€Œåˆ é™¤

# æ¶ˆæ¯å†å²æŸ¥çœ‹
XRANGE user_events - +                    # æŸ¥çœ‹æ‰€æœ‰æ¶ˆæ¯
XRANGE user_events 1724901600000 1724901700000    # æŒ‰æ—¶é—´èŒƒå›´æŸ¥çœ‹
XLEN user_events                         # æŸ¥çœ‹æ¶ˆæ¯æ€»æ•°

# ä¸Listå¯¹æ¯”
Listé˜Ÿåˆ—ï¼šæ¶ˆæ¯æ¶ˆè´¹ååˆ é™¤ï¼Œæ— æ³•é‡å¤è·å–
Streamé˜Ÿåˆ—ï¼šæ¶ˆæ¯æ°¸ä¹…ä¿å­˜ï¼Œå¯ä»¥åå¤è¯»å–å’Œå›æ”¾

å®é™…ä»·å€¼ï¼š
- å¯ä»¥é‡æ–°å¤„ç†å†å²æ¶ˆæ¯
- æ”¯æŒæ¶ˆæ¯å®¡è®¡å’Œå›æº¯
- æ–°åŠ å…¥çš„æ¶ˆè´¹è€…å¯ä»¥å¤„ç†å†å²æ•°æ®
```

### 2.3 é‡å¤æ¶ˆè´¹æœºåˆ¶


**ğŸ”„ å¤šæ¶ˆè´¹ç»„é‡å¤æ¶ˆè´¹**
```bash
# åœºæ™¯ï¼šç”¨æˆ·ä¸‹å•äº‹ä»¶éœ€è¦å¤šä¸ªç³»ç»Ÿå¤„ç†
XADD order_events * order_id "ORD001" user_id "1001" amount "299.99"

# åˆ›å»ºå¤šä¸ªæ¶ˆè´¹ç»„ï¼Œæ¯ç»„ç‹¬ç«‹æ¶ˆè´¹
XGROUP CREATE order_events email_group 0      # é‚®ä»¶ç³»ç»Ÿç»„
XGROUP CREATE order_events sms_group 0        # çŸ­ä¿¡ç³»ç»Ÿç»„  
XGROUP CREATE order_events log_group 0        # æ—¥å¿—ç³»ç»Ÿç»„

# æ¯ä¸ªç»„éƒ½å¯ä»¥æ¶ˆè´¹åŒä¸€æ¡æ¶ˆæ¯
é‚®ä»¶ç»„æ¶ˆè´¹ï¼šXREADGROUP GROUP email_group worker1 STREAMS order_events >
çŸ­ä¿¡ç»„æ¶ˆè´¹ï¼šXREADGROUP GROUP sms_group worker1 STREAMS order_events >
æ—¥å¿—ç»„æ¶ˆè´¹ï¼šXREADGROUP GROUP log_group worker1 STREAMS order_events >

ç»“æœï¼šåŒä¸€ä¸ªè®¢å•äº‹ä»¶è¢«3ä¸ªç³»ç»Ÿåˆ†åˆ«å¤„ç†
```

**ğŸ“Š é‡å¤æ¶ˆè´¹æ¶æ„å›¾**
```
è®¢å•äº‹ä»¶: ORD001ä¸‹å•
         â†“
    Streamå­˜å‚¨
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ æ¶ˆæ¯æ°¸ä¹…ä¿å­˜ â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”
    â†“     â†“     â†“     â†“
 é‚®ä»¶ç»„  çŸ­ä¿¡ç»„ æ—¥å¿—ç»„ åº“å­˜ç»„
   â†“     â†“     â†“     â†“
å‘é‚®ä»¶  å‘çŸ­ä¿¡  è®°å½•  æ‰£åº“å­˜

ç‰¹ç‚¹ï¼šä¸€æ¡æ¶ˆæ¯ï¼Œå¤šä¸ªä¸šåŠ¡ç³»ç»Ÿç‹¬ç«‹å¤„ç†
```

### 2.4 æ¶ˆè´¹ç»„æœºåˆ¶


**ğŸ‘¥ XREADGROUP - æ¶ˆè´¹ç»„è¯¦è§£**
```bash
# æ¶ˆè´¹ç»„åˆ›å»º
XGROUP CREATE stream_name group_name start_id [MKSTREAM]

# å®é™…ç¤ºä¾‹
XGROUP CREATE user_events email_group 0          # ä»æœ€æ—©æ¶ˆæ¯å¼€å§‹
XGROUP CREATE user_events notification_group $   # ä»æœ€æ–°æ¶ˆæ¯å¼€å§‹

# æ¶ˆè´¹ç»„å†…å¤šæ¶ˆè´¹è€…
XREADGROUP GROUP email_group worker1 COUNT 5 STREAMS user_events >
XREADGROUP GROUP email_group worker2 COUNT 5 STREAMS user_events >

# æ¶ˆè´¹ç»„çŠ¶æ€æŸ¥çœ‹
XINFO GROUPS user_events              # æŸ¥çœ‹æ‰€æœ‰æ¶ˆè´¹ç»„
XINFO CONSUMERS user_events email_group    # æŸ¥çœ‹æ¶ˆè´¹ç»„å†…æ¶ˆè´¹è€…
```

**ğŸ—ï¸ æ¶ˆè´¹ç»„å†…éƒ¨æœºåˆ¶**
```
æ¶ˆè´¹ç»„å†…è´Ÿè½½å‡è¡¡ï¼š
Group: email_group
â”œâ”€ worker1: å¤„ç†æ¶ˆæ¯1, 3, 5, 7...
â”œâ”€ worker2: å¤„ç†æ¶ˆæ¯2, 4, 6, 8...  
â””â”€ worker3: å¾…æœºçŠ¶æ€

æ¶ˆæ¯åˆ†é…è§„åˆ™ï¼š
- ç»„å†…æ¶ˆè´¹è€…è½®æµè·å–æ¶ˆæ¯
- æ¯æ¡æ¶ˆæ¯åªåˆ†é…ç»™ç»„å†…ä¸€ä¸ªæ¶ˆè´¹è€…
- æ”¯æŒæ¶ˆè´¹è€…åŠ¨æ€åŠ å…¥å’Œé€€å‡º
- æ¶ˆè´¹è€…æ•…éšœæ—¶æ¶ˆæ¯å¯ä»¥é‡æ–°åˆ†é…
```

### 2.5 æ¶ˆæ¯ACKç¡®è®¤æœºåˆ¶


**âœ… XACK - æ¶ˆæ¯ç¡®è®¤**
```bash
# æ¶ˆæ¯å¤„ç†å’Œç¡®è®¤æµç¨‹
# 1. æ¶ˆè´¹è€…è·å–æ¶ˆæ¯
messages = XREADGROUP GROUP email_group worker1 COUNT 1 STREAMS user_events >

# 2. å¤„ç†ä¸šåŠ¡é€»è¾‘
for stream, msgs in messages:
    for msg_id, fields in msgs:
        try:
            send_email(fields['user_id'], fields['content'])
            # 3. ç¡®è®¤æ¶ˆæ¯å¤„ç†å®Œæˆ
            XACK user_events email_group msg_id
        except Exception:
            # å¤„ç†å¤±è´¥ï¼Œä¸å‘é€ACKï¼Œæ¶ˆæ¯ä¿æŒpendingçŠ¶æ€
            log_error(f"é‚®ä»¶å‘é€å¤±è´¥: {msg_id}")

# æŸ¥çœ‹å¾…ç¡®è®¤æ¶ˆæ¯
XPENDING user_events email_group    # è¿”å›pendingæ¶ˆæ¯ç»Ÿè®¡
XPENDING user_events email_group - + 10    # æŸ¥çœ‹å…·ä½“pendingæ¶ˆæ¯
```

### 2.6 æ¶ˆæ¯ç¡®è®¤å’Œé‡è¯•æœºåˆ¶


**ğŸ”„ æ•…éšœè½¬ç§»å’Œé‡è¯•**
```bash
# æ¶ˆæ¯é‡æ–°åˆ†é…ï¼ˆæ¶ˆè´¹è€…æ•…éšœè½¬ç§»ï¼‰
XCLAIM stream_name group_name consumer min_idle_time message_id

# å®é™…åº”ç”¨ï¼šå¤„ç†è¶…æ—¶æ¶ˆæ¯
def handle_timeout_messages():
    # æŸ¥æ‰¾è¶…è¿‡5åˆ†é’Ÿæœªç¡®è®¤çš„æ¶ˆæ¯
    pending_msgs = XPENDING user_events email_group - + 100
    
    for msg in pending_msgs:
        if msg['idle_time'] > 300000:  # 5åˆ†é’Ÿ = 300000æ¯«ç§’
            # é‡æ–°åˆ†é…ç»™å½“å‰æ¶ˆè´¹è€…
            XCLAIM user_events email_group worker1 300000 msg['message_id']
            
            # é‡æ–°å¤„ç†
            retry_message_processing(msg['message_id'])

# è‡ªåŠ¨é‡è¯•æœºåˆ¶
def auto_retry_system():
    while True:
        handle_timeout_messages()
        time.sleep(60)  # æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡è¶…æ—¶æ¶ˆæ¯
```

---

## 3. ğŸ“¡ å‘å¸ƒè®¢é˜…æ¨¡å¼


### 3.1 å‘å¸ƒè®¢é˜…åŸºç¡€


**ğŸ’¡ å‘å¸ƒè®¢é˜…æ¦‚å¿µ**ï¼šå®æ—¶æ¶ˆæ¯å¹¿æ’­ç³»ç»Ÿï¼Œå‘å¸ƒè€…å‘å¸ƒæ¶ˆæ¯åˆ°é¢‘é“ï¼Œæ‰€æœ‰è®¢é˜…è€…å®æ—¶æ¥æ”¶

```
å‘å¸ƒè®¢é˜…æ¶æ„ï¼š
å‘å¸ƒè€…A â”€â”€â”
å‘å¸ƒè€…B â”€â”€â”¼â”€â”€â†’ é¢‘é“Channel â”€â”€â”¬â”€â”€â†’ è®¢é˜…è€…1 (Webç«¯)
å‘å¸ƒè€…C â”€â”€â”˜     (å¹¿æ’­)       â”œâ”€â”€â†’ è®¢é˜…è€…2 (ç§»åŠ¨ç«¯)
                              â””â”€â”€â†’ è®¢é˜…è€…3 (åå°ç³»ç»Ÿ)

ç‰¹ç‚¹ï¼šä¸€å¯¹å¤šå¹¿æ’­ï¼Œæ¶ˆæ¯å®æ—¶æ¨é€ï¼Œä¸æŒä¹…åŒ–å­˜å‚¨
```

**ğŸ“¢ PUBLISH - å‘å¸ƒæ¶ˆæ¯**
```bash
# åŸºæœ¬è¯­æ³•
PUBLISH channel_name message

# å®é™…åº”ç”¨
PUBLISH system_notifications "ç³»ç»Ÿå°†åœ¨30åˆ†é’Ÿåç»´æŠ¤"
PUBLISH user_activities "ç”¨æˆ·1001å®Œæˆäº†è®¢å•æ”¯ä»˜"
PUBLISH chat_room_001 "å¼ ä¸‰: å¤§å®¶å¥½ï¼"

# è¿”å›å€¼ï¼šæ¥æ”¶åˆ°æ¶ˆæ¯çš„è®¢é˜…è€…æ•°é‡
PUBLISH news_channel "é‡è¦æ–°é—»"    # è¿”å›ï¼š5 (æœ‰5ä¸ªè®¢é˜…è€…æ”¶åˆ°)
```

**ğŸ“º SUBSCRIBE - è®¢é˜…é¢‘é“**
```bash
# è®¢é˜…å•ä¸ªé¢‘é“
SUBSCRIBE news_channel

# è®¢é˜…å¤šä¸ªé¢‘é“
SUBSCRIBE news_channel user_activities system_notifications

# æ¥æ”¶æ¶ˆæ¯æ ¼å¼
1) "message"                    # æ¶ˆæ¯ç±»å‹
2) "news_channel"              # é¢‘é“åç§°  
3) "é‡è¦æ–°é—»å†…å®¹"               # æ¶ˆæ¯å†…å®¹

# å–æ¶ˆè®¢é˜…
UNSUBSCRIBE news_channel    # å–æ¶ˆç‰¹å®šé¢‘é“
UNSUBSCRIBE                 # å–æ¶ˆæ‰€æœ‰é¢‘é“
```

### 3.2 å®æ—¶æ¶ˆæ¯æ¨é€


**âš¡ å®æ—¶æ¨é€å®ç°**
```python
import redis
import threading

# å‘å¸ƒè€… - å®æ—¶çŠ¶æ€æ¨é€
class StatusPublisher:
    def __init__(self):
        self.redis_client = redis.Redis()
    
    def publish_user_status(self, user_id, status):
        channel = f"user_status_{user_id}"
        message = json.dumps({
            "user_id": user_id,
            "status": status,
            "timestamp": time.time()
        })
        subscribers = self.redis_client.publish(channel, message)
        print(f"çŠ¶æ€æ¨é€ç»™{subscribers}ä¸ªè®¢é˜…è€…")

# è®¢é˜…è€… - å®æ—¶æ¥æ”¶çŠ¶æ€
class StatusSubscriber:
    def __init__(self, user_id):
        self.redis_client = redis.Redis()
        self.pubsub = self.redis_client.pubsub()
        self.user_id = user_id
    
    def start_listening(self):
        # è®¢é˜…ç”¨æˆ·çŠ¶æ€é¢‘é“
        self.pubsub.subscribe(f"user_status_{self.user_id}")
        
        for message in self.pubsub.listen():
            if message['type'] == 'message':
                status_data = json.loads(message['data'])
                self.handle_status_change(status_data)
    
    def handle_status_change(self, status_data):
        # å®æ—¶æ›´æ–°UIçŠ¶æ€
        print(f"ç”¨æˆ·çŠ¶æ€å˜æ›´: {status_data}")
```

### 3.3 é¢‘é“æ¨¡å¼åŒ¹é…


**ğŸ¯ PSUBSCRIBE - æ¨¡å¼è®¢é˜…**
```bash
# ä½¿ç”¨é€šé…ç¬¦è®¢é˜…å¤šä¸ªé¢‘é“
PSUBSCRIBE user:*                    # è®¢é˜…æ‰€æœ‰user:å¼€å¤´çš„é¢‘é“
PSUBSCRIBE game:room:*:chat         # è®¢é˜…æ¸¸æˆæˆ¿é—´èŠå¤©
PSUBSCRIBE system:alerts:*          # è®¢é˜…ç³»ç»Ÿå‘Šè­¦
PSUBSCRIBE news:*:breaking         # è®¢é˜…çªå‘æ–°é—»

# æ¨¡å¼åŒ¹é…ç¤ºä¾‹
PUBLISH user:1001:status "online"       # åŒ¹é… user:*
PUBLISH user:1002:notification "æ–°æ¶ˆæ¯" # åŒ¹é… user:*
PUBLISH game:room:101:chat "hello"     # åŒ¹é… game:room:*:chat
PUBLISH system:alerts:cpu "CPUå‘Šè­¦"    # åŒ¹é… system:alerts:*
```

**ğŸ“Š æ¨¡å¼åŒ¹é…åº”ç”¨åœºæ™¯**
```
èŠå¤©ç³»ç»Ÿï¼š
PSUBSCRIBE chat:room:*     # è®¢é˜…æ‰€æœ‰èŠå¤©å®¤
PUBLISH chat:room:101 "æ¶ˆæ¯å†…å®¹"    # æˆ¿é—´101çš„æ¶ˆæ¯

ç”¨æˆ·é€šçŸ¥ï¼š  
PSUBSCRIBE user:*:notifications    # è®¢é˜…æ‰€æœ‰ç”¨æˆ·é€šçŸ¥
PUBLISH user:1001:notifications "æ‚¨æœ‰æ–°è®¢å•"

ç³»ç»Ÿç›‘æ§ï¼š
PSUBSCRIBE monitor:*:alerts    # è®¢é˜…æ‰€æœ‰ç›‘æ§å‘Šè­¦
PUBLISH monitor:cpu:alerts "CPUä½¿ç”¨ç‡è¿‡é«˜"
```

### 3.4 æ¶ˆæ¯å¹¿æ’­


**ğŸ“» å¹¿æ’­æœºåˆ¶è¯¦è§£**
```bash
# å¹¿æ’­ç‰¹æ€§ï¼šä¸€æ¡æ¶ˆæ¯ï¼Œå¤šä¸ªæ¥æ”¶è€…
PUBLISH global_announcement "ç³»ç»Ÿå‡çº§é€šçŸ¥ï¼šä»Šæ™š12ç‚¹ç»´æŠ¤"

# æ‰€æœ‰è®¢é˜…è€…åŒæ—¶æ”¶åˆ°
Webå‰ç«¯è®¢é˜…è€…  â†’ æ˜¾ç¤ºé¡µé¢é€šçŸ¥æ 
ç§»åŠ¨ç«¯è®¢é˜…è€…   â†’ æ¨é€æ‰‹æœºé€šçŸ¥  
ç®¡ç†åå°è®¢é˜…è€… â†’ è®°å½•ç³»ç»Ÿæ—¥å¿—
é‚®ä»¶ç³»ç»Ÿè®¢é˜…è€… â†’ å‘é€é‚®ä»¶é€šçŸ¥

ç‰¹ç‚¹ï¼š
âœ… å®æ—¶å¹¿æ’­ï¼šæ¶ˆæ¯å‘å¸ƒåç«‹å³æ¨é€
âœ… å¤šç«¯æ¥æ”¶ï¼šæ‰€æœ‰è®¢é˜…è€…éƒ½èƒ½æ”¶åˆ°
âœ… ç‹¬ç«‹å¤„ç†ï¼šæ¯ä¸ªè®¢é˜…è€…ç‹¬ç«‹å¤„ç†æ¶ˆæ¯
âœ… æ— çŠ¶æ€ï¼šå‘å¸ƒè€…ä¸çŸ¥é“æœ‰å¤šå°‘è®¢é˜…è€…
```

### 3.5 ä¸ä¿è¯æ¶ˆæ¯æŒä¹…åŒ–


**âŒ å‘å¸ƒè®¢é˜…å±€é™æ€§**
```bash
# æŒä¹…åŒ–é—®é¢˜
PUBLISH chat_room "å¼ ä¸‰: å¤§å®¶å¥½ï¼"

é—®é¢˜åœºæ™¯ï¼š
1. å¦‚æœå‘å¸ƒæ—¶æ²¡æœ‰è®¢é˜…è€… â†’ æ¶ˆæ¯ç›´æ¥ä¸¢å¤±
2. è®¢é˜…è€…ä¸´æ—¶ç¦»çº¿ â†’ é”™è¿‡æ‰€æœ‰æ¶ˆæ¯
3. RedisæœåŠ¡é‡å¯ â†’ æ‰€æœ‰æœªå¤„ç†æ¶ˆæ¯ä¸¢å¤±
4. ç½‘ç»œæ–­å¼€é‡è¿ â†’ æ–­å¼€æœŸé—´æ¶ˆæ¯å…¨éƒ¨ä¸¢å¤±

è§£å†³æ–¹æ¡ˆï¼š
æ–¹æ¡ˆ1ï¼šé‡è¦æ¶ˆæ¯åŒæ—¶å­˜å‚¨åˆ°Streamæˆ–æ•°æ®åº“
æ–¹æ¡ˆ2ï¼šå®¢æˆ·ç«¯é‡è¿åä¸»åŠ¨æ‹‰å–ç¦»çº¿æ¶ˆæ¯  
æ–¹æ¡ˆ3ï¼šä½¿ç”¨æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼ˆå…¶ä»–MQï¼‰
```

**ğŸ’¡ é€‚ç”¨åœºæ™¯åˆ¤æ–­**
```
é€‚åˆå‘å¸ƒè®¢é˜…ï¼š
âœ… å®æ—¶æ€§è¦æ±‚é«˜ï¼ˆèŠå¤©ã€é€šçŸ¥ï¼‰
âœ… æ¶ˆæ¯ä¸¢å¤±å½±å“å°ï¼ˆçŠ¶æ€æ›´æ–°ï¼‰
âœ… å¹¿æ’­ç‰¹æ€§é‡è¦ï¼ˆç³»ç»Ÿå…¬å‘Šï¼‰

ä¸é€‚åˆå‘å¸ƒè®¢é˜…ï¼š
âŒ æ¶ˆæ¯ä¸èƒ½ä¸¢å¤±ï¼ˆæ”¯ä»˜ã€è®¢å•ï¼‰
âŒ éœ€è¦æ¶ˆæ¯å†å²ï¼ˆå®¡è®¡ã€åˆ†æï¼‰
âŒ ç¦»çº¿æ¶ˆæ¯å¤„ç†ï¼ˆé‚®ä»¶ã€ä»»åŠ¡ï¼‰
```

---

## 4. ğŸ’¾ Sessionå­˜å‚¨ç®¡ç†


### 4.1 SessionåŸºç¡€æ¦‚å¿µ


**ğŸ¤” Sessionæ˜¯ä»€ä¹ˆ**ï¼šæœåŠ¡å™¨ä¸ºè¯†åˆ«ç”¨æˆ·èº«ä»½è€Œç»´æŠ¤çš„ä¼šè¯çŠ¶æ€ä¿¡æ¯

```
Sessionå·¥ä½œæµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    1.ç™»å½•è¯·æ±‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚   WebæœåŠ¡å™¨     â”‚
â”‚         â”‚                 â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚         â”‚ â† 2.è¿”å›SessionID â”‚ â”‚Sessionå­˜å‚¨  â”‚ â”‚
â”‚         â”‚                 â”‚ â”‚sess_abc:    â”‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚ â”‚{id:1001,    â”‚ â”‚
     â”‚                      â”‚ â”‚ name:"å¼ ä¸‰"}â”‚ â”‚
     â”‚ 3.åç»­è¯·æ±‚(å¸¦SessionID)  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚                 â”‚
       4.æ ¹æ®SessionIDè¯†åˆ«ç”¨æˆ·  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æœ¬è´¨ï¼šé€šè¿‡SessionIDæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œç»´æŒç™»å½•çŠ¶æ€
```

### 4.2 ä¼ ç»ŸSessionçš„é—®é¢˜


**ğŸ  å•æœºSessionå±€é™**
```
å•æœºSessionæ¶æ„é—®é¢˜ï¼š
                ç”¨æˆ·è¯·æ±‚éšæœºåˆ†é…
                       â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“              â†“              â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚æœåŠ¡å™¨A   â”‚    â”‚æœåŠ¡å™¨B   â”‚    â”‚æœåŠ¡å™¨C   â”‚
   â”‚Session1 â”‚    â”‚Session2 â”‚    â”‚Session3 â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é—®é¢˜æ¼”ç¤ºï¼š
1. ç”¨æˆ·åœ¨æœåŠ¡å™¨Aç™»å½•ï¼ŒSessionå­˜å‚¨åœ¨A
2. è´Ÿè½½å‡è¡¡å™¨å°†ç”¨æˆ·ç¬¬äºŒæ¬¡è¯·æ±‚åˆ†é…åˆ°æœåŠ¡å™¨B
3. æœåŠ¡å™¨Bæ‰¾ä¸åˆ°ç”¨æˆ·Session â†’ è¦æ±‚é‡æ–°ç™»å½•
4. ç”¨æˆ·ä½“éªŒæå·®ï¼Œéœ€è¦é¢‘ç¹ç™»å½•
```

### 4.3 é›†ç¾¤ç¯å¢ƒæŒ‘æˆ˜


**ğŸŒ é›†ç¾¤Sessionå…±äº«æŒ‘æˆ˜**
```
æŒ‘æˆ˜1ï¼šSessionåŒæ­¥é—®é¢˜
æœåŠ¡å™¨Açš„Sessionå¦‚ä½•å®æ—¶åŒæ­¥åˆ°æœåŠ¡å™¨Bã€Cï¼Ÿ

æŒ‘æˆ˜2ï¼šä¸€è‡´æ€§é—®é¢˜  
å¤šä¸ªæœåŠ¡å™¨åŒæ—¶ä¿®æ”¹Sessionæ—¶å¦‚ä½•ä¿è¯ä¸€è‡´æ€§ï¼Ÿ

æŒ‘æˆ˜3ï¼šæ•…éšœå¤„ç†
æŸå°æœåŠ¡å™¨å®•æœºï¼Œå…¶Sessionæ•°æ®å¦‚ä½•ä¸ä¸¢å¤±ï¼Ÿ

æŒ‘æˆ˜4ï¼šæ‰©å±•æ€§é—®é¢˜
å¢åŠ æ–°æœåŠ¡å™¨æ—¶å¦‚ä½•è·å–ç°æœ‰Sessionæ•°æ®ï¼Ÿ

ä¼ ç»Ÿè§£å†³æ–¹æ¡ˆï¼š
- Sessionå¤åˆ¶ï¼šæ€§èƒ½å·®ï¼Œç½‘ç»œå¼€é”€å¤§
- Sessionç²˜æ€§ï¼šè´Ÿè½½å‡è¡¡å›ºå®šç”¨æˆ·åˆ°ç‰¹å®šæœåŠ¡å™¨
- æ•°æ®åº“å­˜å‚¨ï¼šæ€§èƒ½å·®ï¼Œæ•°æ®åº“å‹åŠ›å¤§
```

---

## 5. ğŸ”§ Redis Sessionè§£å†³æ–¹æ¡ˆ


### 5.1 Rediså­˜å‚¨Sessionä¼˜åŠ¿


**âœ… é›†ä¸­åŒ–Sessionæ¶æ„**
```
Redis Sessionè§£å†³æ–¹æ¡ˆï¼š
         è´Ÿè½½å‡è¡¡å™¨
            â†“
â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”
â”‚  A  â”‚    B    â”‚  C  â”‚ â† WebæœåŠ¡å™¨é›†ç¾¤
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜
      â”‚    â”‚    â”‚
      â””â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”˜
           â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Redis Session  â”‚ â† é›†ä¸­Sessionå­˜å‚¨
    â”‚   é›†ä¸­å­˜å‚¨       â”‚  
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜åŠ¿è¯´æ˜ï¼š
âœ… å…±äº«è®¿é—®ï¼šæ‰€æœ‰æœåŠ¡å™¨è®¿é—®åŒä¸€ä»½Session
âœ… é«˜æ€§èƒ½ï¼šå†…å­˜æ“ä½œï¼Œè¯»å†™æå¿«
âœ… è‡ªåŠ¨è¿‡æœŸï¼šTTLæœºåˆ¶è‡ªåŠ¨æ¸…ç†è¿‡æœŸSession
âœ… æŒä¹…åŒ–ï¼šAOF/RDBä¿è¯æ•°æ®å®‰å…¨æ€§
âœ… æ‰©å±•æ€§ï¼šRedisé›†ç¾¤æ”¯æŒå¤§è§„æ¨¡éƒ¨ç½²
```

### 5.2 Sessionå­˜å‚¨æ–¹æ¡ˆ


**ğŸ—‚ï¸ Hashç»“æ„å­˜å‚¨Session**
```bash
# æ¨èæ–¹æ¡ˆï¼šHashç»“æ„å­˜å‚¨
HMSET session:sess_abc123 
  user_id "1001"
  username "å¼ ä¸‰"
  role "admin"
  login_time "1724901600"
  last_access "1724905200"  
  ip_address "192.168.1.100"
  user_agent "Mozilla/5.0..."

# è®¾ç½®è¿‡æœŸæ—¶é—´
EXPIRE session:sess_abc123 7200    # 2å°æ—¶è¿‡æœŸ

# è·å–Sessionå­—æ®µ
HGET session:sess_abc123 user_id        # è·å–å•ä¸ªå­—æ®µ
HMGET session:sess_abc123 user_id username    # è·å–å¤šä¸ªå­—æ®µ
HGETALL session:sess_abc123             # è·å–æ‰€æœ‰å­—æ®µ
```

**ğŸ“¦ å…¶ä»–å­˜å‚¨æ–¹æ¡ˆå¯¹æ¯”**
```bash
# æ–¹æ¡ˆ1ï¼šStringå­˜å‚¨JSON
SET session:sess_abc123 '{
  "user_id": "1001",
  "username": "å¼ ä¸‰",
  "role": "admin"
}' EX 7200

ä¼˜ç‚¹ï¼šç»“æ„ç®€å•ï¼Œé€‚åˆå°å‹Session
ç¼ºç‚¹ï¼šä¿®æ”¹éƒ¨åˆ†å­—æ®µéœ€è¦é‡å†™æ•´ä¸ªJSON

# æ–¹æ¡ˆ2ï¼šå¤šä¸ªStringå­—æ®µ
SET session:sess_abc123:user_id "1001" EX 7200
SET session:sess_abc123:username "å¼ ä¸‰" EX 7200  
SET session:sess_abc123:role "admin" EX 7200

ä¼˜ç‚¹ï¼šå­—æ®µç‹¬ç«‹ï¼Œå¯å•ç‹¬æ“ä½œ
ç¼ºç‚¹ï¼škeyæ•°é‡å¤šï¼Œè¿‡æœŸæ—¶é—´éš¾ç»Ÿä¸€ç®¡ç†

æ¨èï¼šHashç»“æ„å…¼é¡¾çµæ´»æ€§å’Œæ•ˆç‡
```

### 5.3 Sessionæ•°æ®ç»“æ„è®¾è®¡


**ğŸ—ï¸ Sessionç»“æ„è®¾è®¡åŸåˆ™**
```bash
# æ ‡å‡†Sessionç»“æ„è®¾è®¡
session:sess_abc123 = {
  # åŸºç¡€èº«ä»½ä¿¡æ¯
  "user_id": "1001",
  "username": "å¼ ä¸‰",
  "role": "admin",
  
  # ä¼šè¯ä¿¡æ¯
  "session_id": "sess_abc123", 
  "login_time": "1724901600",
  "last_access": "1724905200",
  
  # å®‰å…¨ä¿¡æ¯
  "ip_address": "192.168.1.100",
  "user_agent": "Mozilla/5.0...",
  
  # ä¸šåŠ¡ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
  "current_page": "/dashboard",
  "shopping_cart_id": "cart_001"
}

è®¾è®¡åŸåˆ™ï¼š
âœ… å¿…è¦ä¿¡æ¯ï¼šç”¨æˆ·èº«ä»½ã€ä¼šè¯çŠ¶æ€ã€å®‰å…¨éªŒè¯
âœ… æ•°æ®ç²¾ç®€ï¼šé¿å…å­˜å‚¨å¤§é‡ä¸šåŠ¡æ•°æ®
âœ… å®‰å…¨è€ƒè™‘ï¼šIPã€User-Agentç”¨äºå®‰å…¨éªŒè¯
âœ… æ‰©å±•æ€§ï¼šé¢„ç•™ä¸šåŠ¡å­—æ®µä½†ä¸æ»¥ç”¨
```

### 5.4 åºåˆ—åŒ–å¤„ç†


**ğŸ”„ Sessionæ•°æ®åºåˆ—åŒ–**
```java
// Javaåºåˆ—åŒ–æ–¹æ¡ˆå¯¹æ¯”

// æ–¹æ¡ˆ1ï¼šJavaåŸç”Ÿåºåˆ—åŒ–
public class JavaSessionSerializer {
    public byte[] serialize(HttpSession session) {
        ByteArrayOutputStream bos = new ByteArrayOutputStream();
        ObjectOutputStream oos = new ObjectOutputStream(bos);
        oos.writeObject(session);
        return bos.toByteArray();
    }
    
    // ä¼˜ç‚¹ï¼šæ”¯æŒå¤æ‚å¯¹è±¡
    // ç¼ºç‚¹ï¼šä½“ç§¯å¤§ï¼Œè·¨è¯­è¨€ä¸å…¼å®¹
}

// æ–¹æ¡ˆ2ï¼šJSONåºåˆ—åŒ–ï¼ˆæ¨èï¼‰
public class JsonSessionSerializer {
    private ObjectMapper mapper = new ObjectMapper();
    
    public String serialize(SessionData sessionData) {
        return mapper.writeValueAsString(sessionData);
    }
    
    public SessionData deserialize(String json) {
        return mapper.readValue(json, SessionData.class);
    }
    
    // ä¼˜ç‚¹ï¼šä½“ç§¯å°ï¼Œè·¨è¯­è¨€å…¼å®¹ï¼Œå¯è¯»æ€§å¥½
    // ç¼ºç‚¹ï¼šä¸æ”¯æŒå¤æ‚å¯¹è±¡å…³ç³»
}
```

### 5.5 è¿‡æœŸæ—¶é—´ç®¡ç†


**â° Sessionè¿‡æœŸç­–ç•¥**
```bash
# å›ºå®šè¿‡æœŸæ—¶é—´
def create_fixed_session(user_id):
    session_id = generate_session_id()
    session_data = build_session_data(user_id)
    
    HMSET f"session:{session_id}" session_data
    EXPIRE f"session:{session_id}" 1800    # 30åˆ†é’Ÿå›ºå®šè¿‡æœŸ
    
    return session_id

# æ»‘åŠ¨è¿‡æœŸæ—¶é—´ï¼ˆæ¨èï¼‰
def access_sliding_session(session_id):
    session_data = HGETALL f"session:{session_id}"
    
    if session_data:
        # æ›´æ–°æœ€åè®¿é—®æ—¶é—´
        HSET f"session:{session_id}" "last_access" current_timestamp()
        # é‡æ–°è®¾ç½®è¿‡æœŸæ—¶é—´
        EXPIRE f"session:{session_id}" 1800
        return session_data
    else:
        return None  # Sessionå·²è¿‡æœŸ

# åˆ†å±‚è¿‡æœŸç­–ç•¥
def smart_expire_session(session_id, user_activity_level):
    if user_activity_level == "high":
        EXPIRE f"session:{session_id}" 3600    # æ´»è·ƒç”¨æˆ·1å°æ—¶
    elif user_activity_level == "normal":
        EXPIRE f"session:{session_id}" 1800    # æ™®é€šç”¨æˆ·30åˆ†é’Ÿ  
    else:
        EXPIRE f"session:{session_id}" 900     # ä¸æ´»è·ƒç”¨æˆ·15åˆ†é’Ÿ
```

### 5.6 ç™»å½•æµç¨‹å®ç°


**ğŸ”‘ å®Œæ•´ç™»å½•æµç¨‹**
```java
@Service
public class SessionService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // ç”¨æˆ·ç™»å½•
    public String login(String username, String password, String ipAddress) {
        // 1. éªŒè¯ç”¨æˆ·å‡­æ®
        User user = userService.authenticate(username, password);
        if (user == null) {
            throw new AuthenticationException("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
        }
        
        // 2. ç”ŸæˆSessionID
        String sessionId = UUID.randomUUID().toString();
        
        // 3. æ„å»ºSessionæ•°æ®
        Map<String, Object> sessionData = new HashMap<>();
        sessionData.put("user_id", user.getId());
        sessionData.put("username", user.getUsername());
        sessionData.put("role", user.getRole());
        sessionData.put("login_time", System.currentTimeMillis());
        sessionData.put("ip_address", ipAddress);
        
        // 4. å­˜å‚¨åˆ°Redis
        String sessionKey = "session:" + sessionId;
        redisTemplate.opsForHash().putAll(sessionKey, sessionData);
        redisTemplate.expire(sessionKey, Duration.ofHours(2));
        
        return sessionId;
    }
    
    // éªŒè¯Session
    public SessionData validateSession(String sessionId) {
        String sessionKey = "session:" + sessionId;
        Map<Object, Object> sessionMap = redisTemplate.opsForHash().entries(sessionKey);
        
        if (sessionMap.isEmpty()) {
            return null;  // Sessionä¸å­˜åœ¨æˆ–å·²è¿‡æœŸ
        }
        
        // æ»‘åŠ¨è¿‡æœŸæ—¶é—´
        redisTemplate.expire(sessionKey, Duration.ofHours(2));
        
        return SessionData.fromMap(sessionMap);
    }
}
```

### 5.7 Sessionæ•°æ®æœ€å°åŒ–


**ğŸ“Š Sessionä¼˜åŒ–åŸåˆ™**
```bash
# ä¸æ¨èï¼šå­˜å‚¨è¿‡å¤šæ•°æ®
HMSET session:sess_abc123
  user_id "1001"
  username "å¼ ä¸‰"
  full_profile '{"age":25,"phone":"138...","address":"åŒ—äº¬å¸‚æœé˜³åŒº..."}'  # å¤§é‡æ•°æ®
  permissions '[{"module":"user","read":true,"write":true}...]'          # å¤æ‚æƒé™
  shopping_cart '[{"id":"001","name":"å•†å“1","price":99.9}...]'          # è´­ç‰©è½¦è¯¦æƒ…

é—®é¢˜ï¼šSessionè¿‡å¤§ï¼Œå½±å“æ€§èƒ½

# æ¨èï¼šæœ€å°åŒ–å­˜å‚¨
HMSET session:sess_abc123
  user_id "1001"              # ç”¨æˆ·æ ‡è¯†
  username "å¼ ä¸‰"             # æ˜¾ç¤ºåç§°
  role "admin"               # è§’è‰²æ ‡è¯†  
  login_time "1724901600"    # ç™»å½•æ—¶é—´

# å…¶ä»–ä¿¡æ¯æŒ‰éœ€æŸ¥è¯¢
user_profile = get_user_profile(user_id)      # ä»æ•°æ®åº“è·å–
user_permissions = get_user_permissions(role)  # ä»ç¼“å­˜è·å–
```

### 5.8 å¼‚å¸¸å¤„ç†æœºåˆ¶


**ğŸ› ï¸ Sessionå¼‚å¸¸å¤„ç†**
```java
@Service  
public class SessionManager {
    
    public SessionData getSessionSafely(String sessionId) {
        try {
            // å°è¯•ä»Redisè·å–Session
            Map<Object, Object> sessionMap = redisTemplate.opsForHash()
                .entries("session:" + sessionId);
                
            if (sessionMap.isEmpty()) {
                return null;  // Sessionè¿‡æœŸ
            }
            
            return SessionData.fromMap(sessionMap);
            
        } catch (RedisConnectionException e) {
            // Redisè¿æ¥å¼‚å¸¸ï¼Œé™çº§å¤„ç†
            log.error("Redisè¿æ¥å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°ç¼“å­˜", e);
            return getFromLocalCache(sessionId);
            
        } catch (Exception e) {
            // å…¶ä»–å¼‚å¸¸
            log.error("Sessionè·å–å¼‚å¸¸", e);
            return null;
        }
    }
    
    // é™çº§å¤„ç†
    private SessionData getFromLocalCache(String sessionId) {
        // ä½¿ç”¨æœ¬åœ°ç¼“å­˜æˆ–ç›´æ¥æŸ¥è¯¢æ•°æ®åº“
        return localCacheManager.get(sessionId);
    }
    
    // Sessionå†²çªå¤„ç†
    public void handleSessionConflict(String userId, String newSessionId) {
        try {
            // æŸ¥æ‰¾ç”¨æˆ·çš„å…¶ä»–Session
            Set<String> userSessions = findUserSessions(userId);
            
            for (String existingSession : userSessions) {
                if (!existingSession.equals(newSessionId)) {
                    // æ ¹æ®ä¸šåŠ¡è§„åˆ™å¤„ç†
                    if (allowMultipleLogin) {
                        continue;  // å…è®¸å¤šè®¾å¤‡ç™»å½•
                    } else {
                        deleteSession(existingSession);  // è¸¢å‡ºæ—§Session
                    }
                }
            }
        } catch (Exception e) {
            log.error("Sessionå†²çªå¤„ç†å¼‚å¸¸", e);
        }
    }
}
```

---

## 6. ğŸ« Tokenè®¤è¯ä½“ç³»


### 6.1 Tokenè®¤è¯æœºåˆ¶


**ğŸ”‘ Token vs Sessionå¯¹æ¯”**
```
Sessionæœºåˆ¶ï¼š
å®¢æˆ·ç«¯å­˜å‚¨ï¼šSessionID (å¦‚ï¼šsess_abc123)
æœåŠ¡å™¨å­˜å‚¨ï¼šå®Œæ•´ç”¨æˆ·ä¿¡æ¯
éªŒè¯æ–¹å¼ï¼šæ ¹æ®SessionIDæŸ¥æ‰¾æœåŠ¡å™¨ç«¯Session

Tokenæœºåˆ¶ï¼š
å®¢æˆ·ç«¯å­˜å‚¨ï¼šToken (åŒ…å«ç”¨æˆ·ä¿¡æ¯)
æœåŠ¡å™¨å­˜å‚¨ï¼šTokenç™½åå•/é»‘åå•(å¯é€‰)
éªŒè¯æ–¹å¼ï¼šè§£æTokenè·å–ç”¨æˆ·ä¿¡æ¯

ä¼˜åŠ¿å¯¹æ¯”ï¼š
Session: å®‰å…¨æ€§é«˜ï¼ŒæœåŠ¡å™¨å®Œå…¨æ§åˆ¶
Token: æ— çŠ¶æ€ï¼Œæ‰©å±•æ€§å¥½ï¼Œé€‚åˆå¾®æœåŠ¡
```

### 6.2 JWTçš„ä½¿ç”¨


**ğŸ” JWT Tokenç»“æ„**
```
JWTç»„æˆç»“æ„ï¼š
Header.Payload.Signature

ç¤ºä¾‹JWTï¼š
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9    # Header
.eyJ1c2VyX2lkIjoiMTAwMSIsInVzZXJuYW1l # Payload  
.signature_hash                          # Signature

Payloadå†…å®¹ï¼š
{
  "user_id": "1001",
  "username": "å¼ ä¸‰", 
  "role": "admin",
  "exp": 1724908800,    # è¿‡æœŸæ—¶é—´æˆ³
  "iat": 1724901600     # ç­¾å‘æ—¶é—´æˆ³
}
```

### 6.3 JWT Tokenç¼“å­˜


**ğŸ’¾ Tokenå­˜å‚¨åœ¨Redisä¸­**
```bash
# Tokenç™½åå•æœºåˆ¶ï¼ˆæ¨èï¼‰
SET token:eyJhbGciOiJ... "user:1001" EX 3600

# TokenéªŒè¯æµç¨‹
def validate_jwt_token(token):
    # 1. æ£€æŸ¥Tokenæ˜¯å¦åœ¨Redisç™½åå•ä¸­
    user_info = GET f"token:{token}"
    if not user_info:
        return None  # Tokenæ— æ•ˆæˆ–å·²æ’¤é”€
    
    # 2. éªŒè¯JWTç­¾åå’Œè¿‡æœŸæ—¶é—´
    try:
        payload = jwt.decode(token, secret_key, algorithms=['HS256'])
        return payload
    except jwt.ExpiredSignatureError:
        # Tokenè¿‡æœŸï¼Œä»Redisåˆ é™¤
        DEL f"token:{token}"
        return None
    except jwt.InvalidTokenError:
        return None

# Tokené»‘åå•æœºåˆ¶
SET revoked_token:eyJhbGciOiJ... "1" EX 3600    # æ ‡è®°Tokenå·²æ’¤é”€

def is_token_revoked(token):
    return EXISTS f"revoked_token:{token}"
```

### 6.4 Tokenè¿‡æœŸå’Œåˆ·æ–°


**ğŸ”„ Tokenåˆ·æ–°æœºåˆ¶**
```bash
# åŒTokenç­–ç•¥
def create_token_pair(user_id):
    # Access Tokenï¼ˆçŸ­æœŸï¼Œ15åˆ†é’Ÿï¼‰
    access_payload = {
        "user_id": user_id,
        "type": "access",
        "exp": time.time() + 900
    }
    access_token = jwt.encode(access_payload, secret_key)
    
    # Refresh Tokenï¼ˆé•¿æœŸï¼Œ7å¤©ï¼‰
    refresh_token = generate_secure_random_string()
    
    # å­˜å‚¨Tokenå¯¹
    SET f"access_token:{access_token}" user_id EX 900
    SET f"refresh_token:{refresh_token}" user_id EX 604800
    
    return access_token, refresh_token

# Tokenåˆ·æ–°æµç¨‹
def refresh_access_token(refresh_token):
    user_id = GET f"refresh_token:{refresh_token}"
    if not user_id:
        raise Exception("Refresh Tokenæ— æ•ˆæˆ–å·²è¿‡æœŸ")
    
    # ç”Ÿæˆæ–°çš„Access Token
    new_access_token = create_access_token(user_id)
    
    # å¯é€‰ï¼šè½®æ¢Refresh Tokenæé«˜å®‰å…¨æ€§
    new_refresh_token = generate_secure_random_string()
    DEL f"refresh_token:{refresh_token}"  # åˆ é™¤æ—§Token
    SET f"refresh_token:{new_refresh_token}" user_id EX 604800
    
    return new_access_token, new_refresh_token
```

### 6.5 å•ç‚¹ç™»å½•SSOå®ç°


**ğŸŒ SSOç³»ç»Ÿæ¶æ„**
```
SSOå•ç‚¹ç™»å½•æ¶æ„ï¼š
        è®¤è¯ä¸­å¿ƒ
           â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   SSO Token     â”‚
    â”‚   å…¨å±€å­˜å‚¨      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†‘
    â”Œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”
    â†“      â†“      â†“
 ç³»ç»ŸA   ç³»ç»ŸB   ç³»ç»ŸC

æµç¨‹ï¼šç”¨æˆ·åœ¨ä»»ä¸€ç³»ç»Ÿç™»å½•ï¼Œå…¶ä»–ç³»ç»Ÿè‡ªåŠ¨ç™»å½•
```

**ğŸ”§ SSO Tokenå®ç°**
```bash
# SSOç™»å½•æµç¨‹
def sso_login(user_id, client_systems):
    # 1. åˆ›å»ºå…¨å±€SSO Token
    sso_token = generate_sso_token()
    sso_payload = {
        "user_id": user_id,
        "systems": client_systems,
        "exp": time.time() + 28800  # 8å°æ—¶æœ‰æ•ˆæœŸ
    }
    
    # 2. å­˜å‚¨SSO Token
    SET f"sso_token:{sso_token}" json.dumps(sso_payload) EX 28800
    
    # 3. åœ¨å„ç³»ç»Ÿä¸­å»ºç«‹æ˜ å°„
    for system in client_systems:
        SET f"sso:{system}:{user_id}" sso_token EX 28800
    
    return sso_token

# ç³»ç»Ÿé—´SSOéªŒè¯
def verify_sso_access(sso_token, system_name):
    # éªŒè¯SSO Token
    token_data = GET f"sso_token:{sso_token}"
    if not token_data:
        return None
    
    payload = json.loads(token_data)
    user_id = payload['user_id']
    
    # éªŒè¯ç³»ç»Ÿè®¿é—®æƒé™
    if system_name in payload['systems']:
        return create_system_session(user_id, system_name)
    else:
        raise PermissionError(f"ç”¨æˆ·æ— æƒè®¿é—®ç³»ç»Ÿ{system_name}")
```

### 6.6 å¤šè®¾å¤‡ç™»å½•ç®¡ç†


**ğŸ“± åŒä¸€ç”¨æˆ·å¤šè®¾å¤‡ç™»å½•**
```bash
# è®¾å¤‡Sessionç®¡ç†
def multi_device_login(user_id, device_info):
    device_type = device_info['type']    # pc, mobile, tablet
    device_id = device_info['id']        # è®¾å¤‡å”¯ä¸€æ ‡è¯†
    
    session_id = generate_session_id()
    
    # å­˜å‚¨è®¾å¤‡Sessionæ˜ å°„
    device_key = f"device:{user_id}:{device_type}:{device_id}"
    SET device_key session_id EX 7200
    
    # å­˜å‚¨Sessionè¯¦æƒ…
    session_data = {
        "user_id": user_id,
        "device_type": device_type,
        "device_id": device_id,
        "login_time": current_timestamp(),
        "device_name": device_info.get('name', 'æœªçŸ¥è®¾å¤‡')
    }
    HMSET f"session:{session_id}" session_data
    EXPIRE f"session:{session_id}" 7200
    
    # è®°å½•ç”¨æˆ·æ´»è·ƒè®¾å¤‡
    SADD f"user_devices:{user_id}" device_key
    EXPIRE f"user_devices:{user_id}" 7200

# æŸ¥çœ‹ç”¨æˆ·æ‰€æœ‰è®¾å¤‡
def get_user_devices(user_id):
    device_keys = SMEMBERS f"user_devices:{user_id}"
    devices = []
    
    for device_key in device_keys:
        session_id = GET device_key
        if session_id:
            session_data = HGETALL f"session:{session_id}"
            devices.append(session_data)
    
    return devices
```

### 6.7 äº’è¸¢æœºåˆ¶å®ç°


**ğŸšª å•è®¾å¤‡ç™»å½•å®ç°**
```bash
# äº’è¸¢æœºåˆ¶ï¼šåŒç±»è®¾å¤‡åªå…è®¸ä¸€ä¸ªç™»å½•
def single_device_login(user_id, device_type, new_device_id):
    # 1. æŸ¥æ‰¾åŒç±»å‹è®¾å¤‡çš„ç°æœ‰Session
    device_pattern = f"device:{user_id}:{device_type}:*"
    existing_devices = SCAN 0 MATCH device_pattern
    
    # 2. è¸¢å‡ºåŒç±»å‹è®¾å¤‡
    for old_device_key in existing_devices:
        old_session_id = GET old_device_key
        if old_session_id:
            # åˆ é™¤æ—§è®¾å¤‡Session
            DEL f"session:{old_session_id}"
            DEL old_device_key
            
            # é€šçŸ¥æ—§è®¾å¤‡è¢«è¸¢å‡º
            PUBLISH f"user_events:{user_id}" json.dumps({
                "type": "force_logout",
                "reason": "å…¶ä»–è®¾å¤‡ç™»å½•",
                "session_id": old_session_id
            })
    
    # 3. åˆ›å»ºæ–°è®¾å¤‡Session
    return create_device_session(user_id, device_type, new_device_id)

# å…¨å±€äº’è¸¢ï¼ˆæ‰€æœ‰è®¾å¤‡åªèƒ½ä¸€ä¸ªåœ¨çº¿ï¼‰
def global_single_login(user_id):
    # æŸ¥æ‰¾ç”¨æˆ·æ‰€æœ‰Session
    user_sessions = find_all_user_sessions(user_id)
    
    # åˆ é™¤æ‰€æœ‰ç°æœ‰Session
    for session_id in user_sessions:
        DEL f"session:{session_id}"
        
        # é€šçŸ¥è®¾å¤‡ç™»å‡º
        PUBLISH f"user_events:{user_id}" json.dumps({
            "type": "force_logout",
            "reason": "è´¦æˆ·åœ¨å…¶ä»–åœ°æ–¹ç™»å½•"
        })
```

### 6.8 åœ¨çº¿ç”¨æˆ·ç»Ÿè®¡


**ğŸ‘¥ ç”¨æˆ·çŠ¶æ€ç®¡ç†**
```bash
# åœ¨çº¿ç”¨æˆ·é›†åˆç®¡ç†
def user_login(user_id):
    # åŠ å…¥åœ¨çº¿ç”¨æˆ·é›†åˆ
    SADD "online_users" user_id
    
    # è®°å½•ç”¨æˆ·æœ€åæ´»è·ƒæ—¶é—´
    SETEX f"user_heartbeat:{user_id}" 300 current_timestamp()
    
    # è®°å½•ç”¨æˆ·çŠ¶æ€è¯¦æƒ…
    HSET f"user_status:{user_id}"
      "status" "online"
      "login_time" current_timestamp()
      "last_active" current_timestamp()

def user_logout(user_id):
    # ä»åœ¨çº¿é›†åˆç§»é™¤
    SREM "online_users" user_id
    
    # æ¸…ç†ç›¸å…³æ•°æ®
    DEL f"user_heartbeat:{user_id}"
    DEL f"user_status:{user_id}"

# å®æ—¶åœ¨çº¿ç»Ÿè®¡
def get_online_statistics():
    total_online = SCARD "online_users"
    online_users = SMEMBERS "online_users" 
    
    return {
        "total_count": total_online,
        "user_list": online_users,
        "timestamp": current_timestamp()
    }

# å®šæ—¶æ¸…ç†ç¦»çº¿ç”¨æˆ·
def cleanup_offline_users():
    all_online = SMEMBERS "online_users"
    current_time = current_timestamp()
    
    for user_id in all_online:
        last_heartbeat = GET f"user_heartbeat:{user_id}"
        
        if not last_heartbeat or (current_time - int(last_heartbeat)) > 600:
            # 10åˆ†é’Ÿæ— å¿ƒè·³ï¼Œæ ‡è®°ä¸ºç¦»çº¿
            user_logout(user_id)
            log_info(f"ç”¨æˆ·{user_id}å› é•¿æ—¶é—´æ— æ´»åŠ¨è¢«æ ‡è®°ä¸ºç¦»çº¿")
```

---

## 7. ğŸ”§ åº”ç”¨é›†æˆå®è·µ


### 7.1 Spring Sessionæ¡†æ¶


**ğŸŒŸ Spring Sessionè‡ªåŠ¨é…ç½®**
```yaml
# application.ymlé…ç½®
spring:
  session:
    store-type: redis              # æŒ‡å®šä½¿ç”¨Rediså­˜å‚¨
    timeout: 1800s                 # Sessionè¿‡æœŸæ—¶é—´30åˆ†é’Ÿ
    redis:
      flush-mode: on_save          # ä¿å­˜æ—¶ç«‹å³åˆ·æ–°åˆ°Redis
      namespace: spring:session     # Redis keyå‘½åç©ºé—´
      cleanup-cron: "0 * * * * *"  # æ¯åˆ†é’Ÿæ¸…ç†è¿‡æœŸSession
  redis:
    host: localhost
    port: 6379
    password: your_redis_password
    lettuce:
      pool:
        max-active: 8              # æœ€å¤§è¿æ¥æ•°
        max-idle: 8                # æœ€å¤§ç©ºé—²è¿æ¥
        min-idle: 0                # æœ€å°ç©ºé—²è¿æ¥
```

**ğŸ”§ Spring Sessionå¯ç”¨**
```java
// å¯ç”¨Redis Sessionæ”¯æŒ
@EnableRedisHttpSession(maxInactiveIntervalInSeconds = 1800)
@Configuration
public class SessionConfig {
    
    // è‡ªå®šä¹‰Sessionåºåˆ—åŒ–å™¨
    @Bean
    public RedisSerializer<Object> springSessionDefaultRedisSerializer() {
        return new GenericJackson2JsonRedisSerializer();
    }
    
    // Sessionäº‹ä»¶ç›‘å¬
    @EventListener
    public void sessionCreated(SessionCreatedEvent event) {
        HttpSession session = event.getSession();
        log.info("Sessionåˆ›å»º: {}", session.getId());
    }
    
    @EventListener  
    public void sessionExpired(SessionExpiredEvent event) {
        HttpSession session = event.getSession();
        log.info("Sessionè¿‡æœŸ: {}", session.getId());
    }
}
```

### 7.2 é€æ˜åŒ–ä½¿ç”¨


**ğŸ”„ Spring Sessioné€æ˜åŒ–é›†æˆ**
```java
@RestController
public class UserController {
    
    // ç™»å½•æ¥å£ - Sessionè‡ªåŠ¨å­˜å‚¨åˆ°Redis
    @PostMapping("/login")
    public ResponseEntity<?> login(HttpServletRequest request, 
                                  @RequestBody LoginRequest loginRequest) {
        // éªŒè¯ç”¨æˆ·å‡­æ®
        User user = authService.authenticate(loginRequest);
        if (user == null) {
            return ResponseEntity.status(401).body("è®¤è¯å¤±è´¥");
        }
        
        // è·å–Sessionï¼ˆSpringè‡ªåŠ¨ä»Redisç®¡ç†ï¼‰
        HttpSession session = request.getSession();
        
        // å­˜å‚¨ç”¨æˆ·ä¿¡æ¯ï¼ˆè‡ªåŠ¨ä¿å­˜åˆ°Redisï¼‰
        session.setAttribute("user_id", user.getId());
        session.setAttribute("username", user.getUsername());
        session.setAttribute("role", user.getRole());
        session.setAttribute("login_time", System.currentTimeMillis());
        
        return ResponseEntity.ok("ç™»å½•æˆåŠŸ");
    }
    
    // è·å–ç”¨æˆ·ä¿¡æ¯ - è‡ªåŠ¨ä»RedisåŠ è½½Session
    @GetMapping("/profile")
    public ResponseEntity<?> getUserProfile(HttpServletRequest request) {
        HttpSession session = request.getSession(false);
        
        if (session == null) {
            return ResponseEntity.status(401).body("æœªç™»å½•");
        }
        
        // ä»Sessionè·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆSpringè‡ªåŠ¨ä»Redisè¯»å–ï¼‰
        String userId = (String) session.getAttribute("user_id");
        String username = (String) session.getAttribute("username");
        String role = (String) session.getAttribute("role");
        
        if (userId == null) {
            return ResponseEntity.status(401).body("Sessionå·²è¿‡æœŸ");
        }
        
        Map<String, Object> userInfo = new HashMap<>();
        userInfo.put("user_id", userId);
        userInfo.put("username", username);
        userInfo.put("role", role);
        
        return ResponseEntity.ok(userInfo);
    }
    
    // é€€å‡ºç™»å½• - è‡ªåŠ¨æ¸…ç†Redisä¸­çš„Session
    @PostMapping("/logout")
    public ResponseEntity<?> logout(HttpServletRequest request) {
        HttpSession session = request.getSession(false);
        if (session != null) {
            session.invalidate();  // Springè‡ªåŠ¨ä»Redisåˆ é™¤Session
        }
        return ResponseEntity.ok("é€€å‡ºæˆåŠŸ");
    }
}
```

### 7.3 æ¡†æ¶é›†æˆæœ€ä½³å®è·µ


**æ¡†æ¶é›†æˆç­–ç•¥**
```java
// è‡ªå®šä¹‰Sessioné…ç½®
@Configuration
public class CustomSessionConfig {
    
    // Sessionæ•°æ®æœ€å°åŒ–é…ç½®
    @Bean
    public SessionRepository<? extends Session> sessionRepository(
            RedisTemplate<String, Object> redisTemplate) {
        
        RedisIndexedSessionRepository repository = 
            new RedisIndexedSessionRepository(redisTemplate);
            
        // é…ç½®Sessionæœ€å¤§é—²ç½®æ—¶é—´
        repository.setDefaultMaxInactiveInterval(Duration.ofMinutes(30));
        
        // é…ç½®Redis keyå‘½åç©ºé—´
        repository.setRedisKeyNamespace("myapp:session");
        
        return repository;
    }
    
    // Session Cookieé…ç½®
    @Bean
    public CookieHttpSessionIdResolver httpSessionIdResolver() {
        CookieHttpSessionIdResolver resolver = new CookieHttpSessionIdResolver();
        resolver.setCookieName("MYSESSIONID");
        resolver.setCookieMaxAge(Duration.ofHours(2));
        resolver.setCookieHttpOnly(true);
        resolver.setCookieSecure(true);  // ç”Ÿäº§ç¯å¢ƒå¯ç”¨
        return resolver;
    }
}
```

**åº”ç”¨é›†æˆæ¨¡å¼**
```java
// Sessionæ‹¦æˆªå™¨å®ç°
@Component
public class SessionInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler) throws Exception {
        
        // è·å–Sessionï¼ˆSpringè‡ªåŠ¨ä»Redisè¯»å–ï¼‰
        HttpSession session = request.getSession(false);
        
        if (session == null) {
            response.setStatus(401);
            response.getWriter().write("æœªç™»å½•");
            return false;
        }
        
        // æ£€æŸ¥Sessionæœ‰æ•ˆæ€§
        String userId = (String) session.getAttribute("user_id");
        if (userId == null) {
            session.invalidate();
            response.setStatus(401);
            response.getWriter().write("Sessionæ— æ•ˆ");
            return false;
        }
        
        // æ›´æ–°æœ€åè®¿é—®æ—¶é—´ï¼ˆSessionè‡ªåŠ¨å»¶æœŸï¼‰
        session.setAttribute("last_access", System.currentTimeMillis());
        
        return true;
    }
}
```

---

## 8. åº”ç”¨åœºæ™¯å®è·µ


### 8.1 å¼‚æ­¥ä»»åŠ¡å¤„ç†


**å¼‚æ­¥å¤„ç†æ¶æ„**
```
åŒæ­¥å¤„ç†é—®é¢˜ï¼š
ç”¨æˆ·è¯·æ±‚ â†’ å¤„ç†ä¸šåŠ¡ â†’ å‘é€é‚®ä»¶ â†’ ç”ŸæˆæŠ¥è¡¨ â†’ è¿”å›ç»“æœ
           â†‘        â†‘        â†‘
         100ms    2000ms   5000ms   æ€»è€—æ—¶ï¼š7100ms

å¼‚æ­¥å¤„ç†ä¼˜åŒ–ï¼š
ç”¨æˆ·è¯·æ±‚ â†’ å¤„ç†æ ¸å¿ƒä¸šåŠ¡ â†’ è¿”å›ç»“æœ (ä»…200ms)
           â†“
       å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—
           â†“
   åå°å¼‚æ­¥å¤„ç†ï¼šå‘é€é‚®ä»¶ã€ç”ŸæˆæŠ¥è¡¨
```

**å…·ä½“å®ç°**
```bash
# ç”¨æˆ·ä¸‹å•åçš„å¼‚æ­¥å¤„ç†
def handle_order_creation(order_data):
    # 1. æ ¸å¿ƒä¸šåŠ¡ï¼šåˆ›å»ºè®¢å•ï¼ˆåŒæ­¥ï¼‰
    order_id = create_order(order_data)
    
    # 2. å¼‚æ­¥ä»»åŠ¡ï¼ˆå‘é€åˆ°é˜Ÿåˆ—ï¼‰
    async_tasks = [
        {"type": "send_email", "order_id": order_id, "email": order_data['email']},
        {"type": "send_sms", "order_id": order_id, "phone": order_data['phone']}, 
        {"type": "update_inventory", "product_id": order_data['product_id']},
        {"type": "generate_invoice", "order_id": order_id}
    ]
    
    for task in async_tasks:
        LPUSH("async_tasks", json.dumps(task))
    
    # 3. ç«‹å³è¿”å›ç»“æœ
    return {"order_id": order_id, "status": "success"}

# å¼‚æ­¥ä»»åŠ¡æ¶ˆè´¹è€…
def async_task_worker():
    while True:
        result = BRPOP("async_tasks", timeout=30)
        if result:
            queue_name, task_json = result
            task = json.loads(task_json)
            
            if task['type'] == 'send_email':
                send_order_email(task['order_id'], task['email'])
            elif task['type'] == 'send_sms':
                send_order_sms(task['order_id'], task['phone'])
            # ... å¤„ç†å…¶ä»–ä»»åŠ¡ç±»å‹
```

### 8.2 ç³»ç»Ÿè§£è€¦


**ç³»ç»Ÿè§£è€¦ä½œç”¨**
```
ç´§è€¦åˆæ¶æ„é—®é¢˜ï¼š
è®¢å•æœåŠ¡ â†’ ç›´æ¥è°ƒç”¨åº“å­˜æœåŠ¡ â†’ ç›´æ¥è°ƒç”¨é‚®ä»¶æœåŠ¡ â†’ ç›´æ¥è°ƒç”¨ç‰©æµæœåŠ¡
           â†‘              â†‘              â†‘
        å¼ºä¾èµ–           å¼ºä¾èµ–          å¼ºä¾èµ–

é—®é¢˜ï¼šä»»ä¸€æœåŠ¡æ•…éšœå½±å“æ•´ä¸ªæµç¨‹ï¼Œéš¾ä»¥ç»´æŠ¤å’Œæ‰©å±•

æ¶ˆæ¯é˜Ÿåˆ—è§£è€¦æ¶æ„ï¼š
è®¢å•æœåŠ¡ â†’ å‘å¸ƒè®¢å•äº‹ä»¶ â†’ æ¶ˆæ¯é˜Ÿåˆ— â†’ å„æœåŠ¡ç‹¬ç«‹ç›‘å¬å¤„ç†
                                  â”œâ”€ åº“å­˜æœåŠ¡
                                  â”œâ”€ é‚®ä»¶æœåŠ¡  
                                  â””â”€ ç‰©æµæœåŠ¡

ä¼˜åŠ¿ï¼šæœåŠ¡ç‹¬ç«‹ï¼Œæ•…éšœéš”ç¦»ï¼Œæ˜“äºæ‰©å±•
```

**è§£è€¦å®ç°ç¤ºä¾‹**
```bash
# è®¢å•æœåŠ¡å‘å¸ƒäº‹ä»¶
def order_service_create_order(order_data):
    order_id = save_order_to_db(order_data)
    
    # å‘å¸ƒè®¢å•åˆ›å»ºäº‹ä»¶
    event = {
        "event_type": "order_created",
        "order_id": order_id,
        "user_id": order_data['user_id'],
        "product_id": order_data['product_id'], 
        "quantity": order_data['quantity'],
        "timestamp": current_timestamp()
    }
    
    XADD order_events * event

# åº“å­˜æœåŠ¡ç›‘å¬è®¢å•äº‹ä»¶
def inventory_service_listener():
    while True:
        messages = XREADGROUP GROUP inventory_group worker1 STREAMS order_events >
        for stream, msgs in messages:
            for msg_id, fields in msgs:
                if fields['event_type'] == 'order_created':
                    reduce_inventory(fields['product_id'], fields['quantity'])
                    XACK order_events inventory_group msg_id

# é‚®ä»¶æœåŠ¡ç‹¬ç«‹ç›‘å¬
def email_service_listener():
    while True:
        messages = XREADGROUP GROUP email_group worker1 STREAMS order_events >
        for stream, msgs in messages:
            for msg_id, fields in msgs:
                if fields['event_type'] == 'order_created':
                    send_order_confirmation_email(fields['user_id'])
                    XACK order_events email_group msg_id
```

### 8.3 æµé‡å‰Šå³°


**å‰Šå³°å¡«è°·æœºåˆ¶**
```bash
# ç§’æ€æ´»åŠ¨æµé‡å‰Šå³°
def flash_sale_request(user_id, product_id):
    # 1. å¿«é€Ÿå“åº”ç”¨æˆ·ï¼ˆä¸ç›´æ¥å¤„ç†åº“å­˜ï¼‰
    request_data = {
        "user_id": user_id,
        "product_id": product_id,
        "request_time": current_timestamp(),
        "request_id": generate_request_id()
    }
    
    # 2. è¯·æ±‚æ”¾å…¥é˜Ÿåˆ—
    LPUSH("flash_sale_queue", json.dumps(request_data))
    
    # 3. ç«‹å³è¿”å›ï¼ˆç”¨æˆ·æ— éœ€ç­‰å¾…ï¼‰
    return {"status": "processing", "request_id": request_data['request_id']}

# åå°æŒ‰å›ºå®šé€Ÿç‡å¤„ç†
def flash_sale_processor():
    while True:
        # æ§åˆ¶å¤„ç†é€Ÿç‡ï¼šæ¯ç§’æœ€å¤šå¤„ç†100ä¸ªè¯·æ±‚
        for _ in range(100):
            result = RPOP("flash_sale_queue")
            if result:
                request = json.loads(result)
                process_flash_sale_order(request)
            else:
                break
        
        time.sleep(1)  # ç­‰å¾…1ç§’ï¼Œæ§åˆ¶å¤„ç†é€Ÿç‡
```

**æµé‡å‰Šå³°æ•ˆæœå›¾**
```
è¯·æ±‚æµé‡æ¨¡å¼ï¼š
åŸå§‹æµé‡ï¼š    â•­â”€â•®
             â•±   â•²     â† ç¬é—´é«˜å³°å‹å®ç³»ç»Ÿ
            â•±     â•²
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•±       â•²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

å‰Šå³°åï¼š    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â•±           â•²  â† å¹³ç¼“å¤„ç†ï¼Œç³»ç»Ÿç¨³å®š
          â•±             â•²
â”€â”€â”€â”€â”€â”€â”€â”€â”€â•±               â•²â”€â”€â”€â”€â”€â”€â”€

æ¶ˆæ¯é˜Ÿåˆ—ä½œä¸ºç¼“å†²ï¼Œå¹³æ»‘æµé‡å³°å€¼
```

### 8.4 æ—¥å¿—æ”¶é›†åº”ç”¨


**æ—¥å¿—æ”¶é›†ç³»ç»Ÿå®ç°**
```bash
# å„æœåŠ¡äº§ç”Ÿæ—¥å¿—æ¶ˆæ¯
def application_logging():
    # ç”¨æˆ·æœåŠ¡æ—¥å¿—
    log_event = {
        "service": "user-service",
        "level": "INFO", 
        "message": "ç”¨æˆ·ç™»å½•æˆåŠŸ",
        "user_id": "1001",
        "ip": "192.168.1.100",
        "timestamp": current_timestamp()
    }
    XADD app_logs * log_event
    
    # è®¢å•æœåŠ¡æ—¥å¿—
    error_event = {
        "service": "order-service",
        "level": "ERROR",
        "message": "åº“å­˜ä¸è¶³",
        "order_id": "ORD001",  
        "error_code": "INSUFFICIENT_STOCK",
        "timestamp": current_timestamp()
    }
    XADD app_logs * error_event

# æ—¥å¿—å¤„ç†ç³»ç»Ÿ
def log_processing_system():
    # åˆ›å»ºå¤šä¸ªæ¶ˆè´¹ç»„
    XGROUP CREATE app_logs storage_group 0     # æ—¥å¿—å­˜å‚¨ç»„
    XGROUP CREATE app_logs analysis_group 0    # æ—¥å¿—åˆ†æç»„
    XGROUP CREATE app_logs alert_group 0       # å‘Šè­¦å¤„ç†ç»„
    
    # æ—¥å¿—å­˜å‚¨æ¶ˆè´¹è€…
    def log_storage_worker():
        while True:
            messages = XREADGROUP GROUP storage_group worker1 STREAMS app_logs >
            for stream, msgs in messages:
                for msg_id, fields in msgs:
                    # å­˜å‚¨åˆ°Elasticsearchæˆ–æ•°æ®åº“
                    store_log_to_es(fields)
                    XACK app_logs storage_group msg_id
    
    # å®æ—¶å‘Šè­¦æ¶ˆè´¹è€…
    def log_alert_worker():
        while True:
            messages = XREADGROUP GROUP alert_group worker1 STREAMS app_logs >
            for stream, msgs in messages:
                for msg_id, fields in msgs:
                    if fields['level'] == 'ERROR':
                        send_alert_notification(fields)
                    XACK app_logs alert_group msg_id
```

---

## 9. ç³»ç»Ÿå¯¹æ¯”åˆ†æ


### 9.1 Redis MQ vs RabbitMQ vs Kafka


**è¯¦ç»†åŠŸèƒ½å¯¹æ¯”è¡¨**

| ç‰¹æ€§ç»´åº¦ | **Redis List** | **Redis Stream** | **RabbitMQ** | **Apache Kafka** |
|---------|---------------|------------------|--------------|------------------|
| **éƒ¨ç½²å¤æ‚åº¦** | `æç®€å•` | `æç®€å•` | `ä¸­ç­‰å¤æ‚` | `å¤æ‚` |
| **å­¦ä¹ æˆæœ¬** | `æä½` | `ä½` | `ä¸­ç­‰` | `é«˜` |
| **æ¶ˆæ¯æŒä¹…åŒ–** | `å†…å­˜+RDB/AOF` | `å†…å­˜+RDB/AOF` | `ç£ç›˜+å†…å­˜` | `ç£ç›˜æ—¥å¿—` |
| **æ¶ˆæ¯é¡ºåº** | `ä¸¥æ ¼FIFO` | `ä¸¥æ ¼æœ‰åº` | `é˜Ÿåˆ—å†…æœ‰åº` | `åˆ†åŒºå†…æœ‰åº` |
| **é‡å¤æ¶ˆè´¹** | `ä¸æ”¯æŒ` | `å¤šæ¶ˆè´¹ç»„` | `æ”¯æŒ` | `æ”¯æŒ` |
| **æ¶ˆæ¯ç¡®è®¤** | `æ‰‹åŠ¨å®ç°` | `XACKæœºåˆ¶` | `è‡ªåŠ¨/æ‰‹åŠ¨ACK` | `Offsetæäº¤` |
| **æ¶ˆæ¯è·¯ç”±** | `æ— è·¯ç”±` | `åŸºç¡€è·¯ç”±` | `Exchangeè·¯ç”±` | `Topicè·¯ç”±` |
| **æ‰©å±•æ€§** | `Redisé›†ç¾¤é™åˆ¶` | `Redisé›†ç¾¤é™åˆ¶` | `èŠ‚ç‚¹é›†ç¾¤` | `æ°´å¹³æ— é™æ‰©å±•` |
| **ç›‘æ§å·¥å…·** | `Rediså‘½ä»¤` | `XINFOå‘½ä»¤` | `Management UI` | `JMX+ç¬¬ä¸‰æ–¹å·¥å…·` |
| **æ¶ˆæ¯å›æº¯** | `ä¸æ”¯æŒ` | `æ”¯æŒå†å²å›æ”¾` | `ä¸æ”¯æŒ` | `æ”¯æŒOffsetå›é€€` |
| **æ€§èƒ½(TPS)** | `10ä¸‡+` | `8ä¸‡+` | `2ä¸‡+` | `ç™¾ä¸‡+` |
| **å»¶è¿Ÿ** | `<1ms` | `<1ms` | `1-5ms` | `å‡ msåˆ°å‡ åms` |
| **èµ„æºæ¶ˆè€—** | `å†…å­˜ä¸ºä¸»` | `å†…å­˜ä¸ºä¸»` | `å†…å­˜+ç£ç›˜` | `ç£ç›˜ä¸ºä¸»` |

### 9.2 æŠ€æœ¯é€‰æ‹©å†³ç­–


**Redis MQé€‚ç”¨åœºæ™¯**
```
ä¸šåŠ¡è§„æ¨¡ï¼š
âœ… ä¸­å°å‹åº”ç”¨ï¼ˆæ—¥æ¶ˆæ¯é‡ < 10ä¸‡ï¼‰
âœ… ç®€å•çš„æ¶ˆæ¯æµè½¬
âœ… å¯¹å»¶è¿Ÿæ•æ„Ÿçš„åœºæ™¯

æŠ€æœ¯æ¡ä»¶ï¼š
âœ… å›¢é˜ŸRedisç»éªŒä¸°å¯Œ
âœ… ç³»ç»Ÿå·²ä½¿ç”¨Redis
âœ… å¸Œæœ›æ¶æ„ç®€å•
âœ… å¿«é€Ÿå¼€å‘éƒ¨ç½²

å…·ä½“åº”ç”¨ï¼š
âœ… Webåº”ç”¨å¼‚æ­¥ä»»åŠ¡
âœ… å®æ—¶é€šçŸ¥æ¨é€
âœ… ç®€å•çš„ä¸šåŠ¡äº‹ä»¶å¤„ç†
âœ… Sessioné›†ä¸­å­˜å‚¨
```

**ä¸“ä¸šMQé€‚ç”¨åœºæ™¯**
```
ä¸šåŠ¡è§„æ¨¡ï¼š
âœ… å¤§å‹ä¼ä¸šåº”ç”¨ï¼ˆæ—¥æ¶ˆæ¯é‡ > 10ä¸‡ï¼‰  
âœ… å¤æ‚çš„ä¸šåŠ¡æµç¨‹
âœ… è·¨ç³»ç»Ÿé›†æˆ

æŠ€æœ¯è¦æ±‚ï¼š
âœ… é«˜å¯é æ€§è¦æ±‚ï¼ˆé‡‘èã€æ”¯ä»˜ï¼‰
âœ… å¤æ‚æ¶ˆæ¯è·¯ç”±éœ€æ±‚
âœ… éœ€è¦ä¸“ä¸šè¿ç»´å·¥å…·
âœ… å¤šè¯­è¨€ç³»ç»Ÿé›†æˆ

å…·ä½“åº”ç”¨ï¼š
âœ… å¾®æœåŠ¡æ¶æ„é€šä¿¡
âœ… å¤§æ•°æ®æµå¤„ç†
âœ… ä¼ä¸šåº”ç”¨é›†æˆ
âœ… å®æ—¶æ•°æ®åŒæ­¥
```

---

## 10. å®‰å…¨é˜²æŠ¤


### 10.1 Sessionå®‰å…¨æ³¨æ„äº‹é¡¹


**Sessionå®‰å…¨é˜²æŠ¤æªæ–½**
```java
// 1. Sessionå›ºå®šæ”»å‡»é˜²æŠ¤
@Service
public class SessionSecurityService {
    
    public String regenerateSessionId(HttpServletRequest request) {
        HttpSession oldSession = request.getSession(false);
        if (oldSession != null) {
            // ä¿å­˜æ—§Sessionæ•°æ®
            Map<String, Object> sessionData = new HashMap<>();
            Enumeration<String> attributeNames = oldSession.getAttributeNames();
            while (attributeNames.hasMoreElements()) {
                String name = attributeNames.nextElement();
                sessionData.put(name, oldSession.getAttribute(name));
            }
            
            // é”€æ¯æ—§Session
            oldSession.invalidate();
            
            // åˆ›å»ºæ–°Session
            HttpSession newSession = request.getSession(true);
            
            // æ¢å¤Sessionæ•°æ®
            sessionData.forEach(newSession::setAttribute);
            
            return newSession.getId();
        }
        return null;
    }
    
    // 2. IPåœ°å€éªŒè¯
    public boolean validateSessionIP(HttpSession session, String currentIP) {
        String sessionIP = (String) session.getAttribute("ip_address");
        return sessionIP != null && sessionIP.equals(currentIP);
    }
    
    // 3. User-AgentéªŒè¯
    public boolean validateUserAgent(HttpSession session, String currentUA) {
        String sessionUA = (String) session.getAttribute("user_agent");
        if (sessionUA == null) return true;  // é¦–æ¬¡è®¿é—®
        return sessionUA.equals(currentUA);
    }
}
```

**Tokenå®‰å…¨æªæ–½**
```bash
# Tokenå¼‚å¸¸ä½¿ç”¨æ£€æµ‹
def detect_token_abuse(token):
    # è®°å½•Tokenä½¿ç”¨é¢‘ç‡
    usage_key = f"token_usage:{token}"
    current_usage = INCR usage_key
    EXPIRE usage_key 60  # 1åˆ†é’Ÿçª—å£
    
    if current_usage > 100:  # 1åˆ†é’Ÿè¶…è¿‡100æ¬¡ä½¿ç”¨
        # ç–‘ä¼¼Tokenæ³„éœ²ï¼Œç«‹å³æ’¤é”€
        DEL f"token:{token}"
        send_security_alert(f"Tokenå¼‚å¸¸ä½¿ç”¨è¢«æ’¤é”€: {token}")

# IPåœ°ç†ä½ç½®æ£€æµ‹
def geo_location_check(token, client_ip):
    # è·å–Tokenä¸Šæ¬¡ä½¿ç”¨çš„IP
    last_ip = GET f"token_last_ip:{token}" 
    
    if last_ip:
        last_location = get_ip_location(last_ip)
        current_location = get_ip_location(client_ip)
        
        # è®¡ç®—åœ°ç†è·ç¦»
        distance = calculate_distance(last_location, current_location)
        
        if distance > 1000:  # è·ç¦»è¶…è¿‡1000å…¬é‡Œ
            # å¯èƒ½è´¦æˆ·è¢«ç›—ï¼Œè¦æ±‚é¢å¤–éªŒè¯
            require_two_factor_auth(token)
    
    # æ›´æ–°IPè®°å½•
    SETEX f"token_last_ip:{token}" 3600 client_ip

# Tokenæ—¶æ•ˆæ€§æ§åˆ¶
def token_lifecycle_management():
    # å®šæœŸæ¸…ç†è¿‡æœŸToken
    expired_tokens = SCAN 0 MATCH "token:*"
    for token_key in expired_tokens:
        ttl = TTL token_key
        if ttl == -1:  # æ²¡æœ‰è®¾ç½®è¿‡æœŸæ—¶é—´çš„å¼‚å¸¸Token
            DEL token_key
        elif ttl < 60:  # å³å°†è¿‡æœŸçš„Token
            log_info(f"Tokenå³å°†è¿‡æœŸ: {token_key}")
```

---

## 11. æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
Listé˜Ÿåˆ—ï¼šLPUSH/RPOP/BRPOPï¼Œç®€å•FIFOé˜Ÿåˆ—ï¼Œç«äº‰æ¶ˆè´¹ï¼Œä¸æ”¯æŒé‡å¤æ¶ˆè´¹
Streamé˜Ÿåˆ—ï¼šXADD/XREAD/XREADGROUP/XACKï¼Œæ”¯æŒæ¶ˆè´¹ç»„ã€æŒä¹…åŒ–ã€é‡å¤æ¶ˆè´¹
å‘å¸ƒè®¢é˜…ï¼šPUBLISH/SUBSCRIBEï¼Œå®æ—¶å¹¿æ’­ï¼Œä¸æŒä¹…åŒ–ï¼Œé€‚åˆé€šçŸ¥æ¨é€
Sessionç®¡ç†ï¼šè§£å†³åˆ†å¸ƒå¼ç”¨æˆ·çŠ¶æ€å…±äº«ï¼ŒHashç»“æ„å­˜å‚¨ï¼Œè‡ªåŠ¨è¿‡æœŸ
Tokenè®¤è¯ï¼šJWTç¼“å­˜ã€åŒTokenæœºåˆ¶ã€å¤šè®¾å¤‡ç®¡ç†ã€å®‰å…¨é˜²æŠ¤
```

### 11.2 ä¸‰ç§æ¶ˆæ¯æ¨¡å¼å®Œæ•´å¯¹æ¯”


| ç‰¹æ€§ | **Listé˜Ÿåˆ—** | **Streamé˜Ÿåˆ—** | **å‘å¸ƒè®¢é˜…** |
|------|-------------|---------------|-------------|
| **æ¶ˆæ¯æŒä¹…åŒ–** | `æ”¯æŒ` | `æ”¯æŒ` | `ä¸æ”¯æŒ` |
| **é‡å¤æ¶ˆè´¹** | `ä¸æ”¯æŒ` | `å¤šæ¶ˆè´¹ç»„æ”¯æŒ` | `å¤©ç„¶å¹¿æ’­` |
| **æ¶ˆæ¯ç¡®è®¤** | `æ‰‹åŠ¨å®ç°` | `XACKæœºåˆ¶` | `æ— ç¡®è®¤` |
| **æ¶ˆæ¯é¡ºåº** | `ä¸¥æ ¼FIFO` | `ä¸¥æ ¼æœ‰åº` | `å‘å¸ƒé¡ºåº` |
| **é˜»å¡ç­‰å¾…** | `BRPOP/BLPOP` | `XREAD BLOCK` | `å®æ—¶æ¨é€` |
| **æ•…éšœæ¢å¤** | `æ‰‹åŠ¨å¤„ç†` | `XCLAIMé‡åˆ†é…` | `ä¸æ”¯æŒ` |
| **å†å²å›æº¯** | `ä¸æ”¯æŒ` | `XRANGEæŸ¥çœ‹` | `ä¸æ”¯æŒ` |
| **ç›‘æ§èƒ½åŠ›** | `LLEN` | `XINFOè¯¦ç»†` | `PUBSUBçŠ¶æ€` |

### 11.3 å®é™…åº”ç”¨å†³ç­–æŒ‡å—


**æ¶ˆæ¯é˜Ÿåˆ—é€‰æ‹©ç­–ç•¥**
```
ç®€å•å¼‚æ­¥ä»»åŠ¡ â†’ Listé˜Ÿåˆ—
â”œâ”€ é‚®ä»¶å‘é€ã€å›¾ç‰‡å¤„ç†
â”œâ”€ æ•°æ®å¯¼å…¥ã€æŠ¥è¡¨ç”Ÿæˆ
â””â”€ ç®€å•çš„åå°ä»»åŠ¡

å¤æ‚ä¸šåŠ¡æµç¨‹ â†’ Streamé˜Ÿåˆ—  
â”œâ”€ è®¢å•å¤„ç†æµç¨‹
â”œâ”€ ç”¨æˆ·æ³¨å†Œæµç¨‹
â”œâ”€ æ”¯ä»˜å¤„ç†æµç¨‹
â””â”€ éœ€è¦æ¶ˆæ¯ç¡®è®¤çš„åœºæ™¯

å®æ—¶é€šçŸ¥æ¨é€ â†’ å‘å¸ƒè®¢é˜…
â”œâ”€ åœ¨çº¿èŠå¤©ç³»ç»Ÿ
â”œâ”€ å®æ—¶çŠ¶æ€æ›´æ–°
â”œâ”€ ç³»ç»Ÿå…¬å‘Šæ¨é€
â””â”€ å¤šç«¯æ¶ˆæ¯åŒæ­¥
```

**Sessionç®¡ç†ç­–ç•¥**
```
åº”ç”¨è§„æ¨¡é€‰æ‹©ï¼š
å°å‹åº”ç”¨ï¼ˆ<1000ç”¨æˆ·ï¼‰  â†’ Stringå­˜å‚¨JSON Session
ä¸­å‹åº”ç”¨ï¼ˆ1000-10000ï¼‰ â†’ Hashç»“æ„å­˜å‚¨Sessionå­—æ®µ  
å¤§å‹åº”ç”¨ï¼ˆ>10000ç”¨æˆ·ï¼‰ â†’ Redisé›†ç¾¤ + Spring Session

å®‰å…¨çº§åˆ«é€‰æ‹©ï¼š
æ™®é€šåº”ç”¨ â†’ åŸºç¡€Session + è¿‡æœŸæ§åˆ¶
æ•æ„Ÿåº”ç”¨ â†’ Session + IPéªŒè¯ + è®¾å¤‡ç®¡ç†
é«˜å®‰å…¨åº”ç”¨ â†’ åŒToken + å¤šå› å­è®¤è¯ + è¡Œä¸ºåˆ†æ
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- Listç®€å•é˜Ÿåˆ—ç«äº‰æ¶ˆè´¹ï¼ŒStreamå¼ºå¤§é˜Ÿåˆ—æ”¯æŒACKï¼Œå‘å¸ƒè®¢é˜…å®æ—¶å¹¿æ’­
- Sessioné›†ä¸­è§£å†³åˆ†å¸ƒå¼çŠ¶æ€ï¼ŒTokenæ— çŠ¶æ€é€‚åˆå¾®æœåŠ¡æ¶æ„  
- å¼‚æ­¥è§£è€¦æå‡ä½“éªŒï¼Œæµé‡å‰Šå³°ä¿æŠ¤ç³»ç»Ÿï¼Œæ—¥å¿—æ”¶é›†ä¾¿äºè¿ç»´
- å®‰å…¨é˜²æŠ¤å¤šå±‚ä¿éšœï¼Œç›‘æ§å‘Šè­¦åŠæ—¶å“åº”ï¼ŒæŠ€æœ¯é€‰æ‹©å› åœºæ™¯è€Œå¼‚