---
title: 1ã€Rediså¸¸è§åº”ç”¨åœºæ™¯
---
## ğŸ“š ç›®å½•

1. [ç¼“å­˜åº”ç”¨æ¨¡å¼](#1-ç¼“å­˜åº”ç”¨æ¨¡å¼)
2. [åˆ†å¸ƒå¼é”åº”ç”¨](#2-åˆ†å¸ƒå¼é”åº”ç”¨)
3. [æ’è¡Œæ¦œç³»ç»Ÿ](#3-æ’è¡Œæ¦œç³»ç»Ÿ)
4. [å»¶æ—¶ä»»åŠ¡å¤„ç†](#4-å»¶æ—¶ä»»åŠ¡å¤„ç†)
5. [Sessionå…±äº«æ–¹æ¡ˆ](#5-Sessionå…±äº«æ–¹æ¡ˆ)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ—„ï¸ ç¼“å­˜åº”ç”¨æ¨¡å¼


### 1.1 ä»€ä¹ˆæ˜¯Redisç¼“å­˜


**ğŸ’¡ ç¼“å­˜çš„æœ¬è´¨**
```
ç¼“å­˜å°±åƒæ˜¯ä¸€ä¸ª"å¿«é€Ÿå–è´§ä»“åº“"ï¼š

ç°å®æ¯”å–»ï¼š
è¶…å¸‚æ”¶é“¶å°æ—è¾¹çš„å£é¦™ç³– â†’ é«˜é¢‘å•†å“ï¼Œå¿«é€Ÿè·å–
ä»“åº“é‡Œçš„å¤§ä»¶å•†å“ â†’ ä½é¢‘å•†å“ï¼Œéœ€è¦æ—¶é—´è·å–

Redisç¼“å­˜ï¼š
çƒ­ç‚¹æ•°æ®å­˜å‚¨åœ¨Redis â†’ å†…å­˜ä¸­ï¼Œæ¯«ç§’çº§è·å–
å†·æ•°æ®å­˜å‚¨åœ¨æ•°æ®åº“ â†’ ç£ç›˜ä¸­ï¼Œéœ€è¦æŸ¥è¯¢æ—¶é—´
```

**ğŸ”¸ ä¸ºä»€ä¹ˆéœ€è¦ç¼“å­˜**
- **é€Ÿåº¦å·®å¼‚å·¨å¤§**ï¼šå†…å­˜è®¿é—®æ¯”ç£ç›˜å¿«1000å€ä»¥ä¸Š
- **å‡è½»æ•°æ®åº“å‹åŠ›**ï¼šé¿å…é‡å¤çš„å¤æ‚æŸ¥è¯¢
- **æå‡ç”¨æˆ·ä½“éªŒ**ï¼šé¡µé¢å“åº”æ›´å¿«

### 1.2 ç¼“å­˜åº”ç”¨æ¨¡å¼åˆ†ç±»


#### ğŸ“– æ—è·¯ç¼“å­˜æ¨¡å¼ (Cache Aside)


**å·¥ä½œåŸç†**ï¼šåº”ç”¨ç¨‹åºè´Ÿè´£ç»´æŠ¤ç¼“å­˜å’Œæ•°æ®åº“çš„æ•°æ®ä¸€è‡´æ€§

```
è¯»å–æµç¨‹ï¼š
åº”ç”¨ç¨‹åº â†’ æŸ¥Redisç¼“å­˜ â†’ å‘½ä¸­ï¼Ÿè¿”å›æ•°æ® : æŸ¥æ•°æ®åº“+å†™ç¼“å­˜

å†™å…¥æµç¨‹ï¼š
åº”ç”¨ç¨‹åº â†’ æ›´æ–°æ•°æ®åº“ â†’ åˆ é™¤Redisç¼“å­˜

ä¸ºä»€ä¹ˆåˆ é™¤è€Œä¸æ˜¯æ›´æ–°ç¼“å­˜ï¼Ÿ
å› ä¸ºç›´æ¥æ›´æ–°å¯èƒ½å¯¼è‡´å¹¶å‘æ—¶çš„æ•°æ®ä¸ä¸€è‡´é—®é¢˜
```

```java
// Javaä»£ç ç¤ºä¾‹ - æ—è·¯ç¼“å­˜æ¨¡å¼
@Service
public class UserService {
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private UserDao userDao;
    
    // è¯»å–ç”¨æˆ·ä¿¡æ¯
    public User getUserById(Long userId) {
        String key = "user:" + userId;
        
        // 1. å…ˆæŸ¥ç¼“å­˜
        User user = (User) redisTemplate.opsForValue().get(key);
        if (user != null) {
            return user; // ç¼“å­˜å‘½ä¸­ï¼Œç›´æ¥è¿”å›
        }
        
        // 2. ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥æ•°æ®åº“
        user = userDao.findById(userId);
        if (user != null) {
            // 3. å†™å…¥ç¼“å­˜ï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´
            redisTemplate.opsForValue().set(key, user, 30, TimeUnit.MINUTES);
        }
        
        return user;
    }
    
    // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
    public void updateUser(User user) {
        String key = "user:" + user.getId();
        
        // 1. å…ˆæ›´æ–°æ•°æ®åº“
        userDao.update(user);
        
        // 2. åˆ é™¤ç¼“å­˜ï¼ˆè®©ä¸‹æ¬¡è¯»å–æ—¶é‡æ–°åŠ è½½ï¼‰
        redisTemplate.delete(key);
    }
}
```

#### ğŸ”„ é€å†™æ¨¡å¼ (Write Through)


**å·¥ä½œåŸç†**ï¼šåº”ç”¨ç¨‹åºåªæ“ä½œç¼“å­˜ï¼Œç¼“å­˜è´Ÿè´£ä¸æ•°æ®åº“åŒæ­¥

```
ç‰¹ç‚¹ï¼š
âœ… æ•°æ®ä¸€è‡´æ€§æ›´å¥½
âŒ å†™å…¥æ€§èƒ½è¾ƒæ…¢
ğŸ¯ é€‚ç”¨åœºæ™¯ï¼šå¯¹ä¸€è‡´æ€§è¦æ±‚å¾ˆé«˜çš„ç³»ç»Ÿ
```

#### ğŸ“ å›å†™æ¨¡å¼ (Write Back)


**å·¥ä½œåŸç†**ï¼šåº”ç”¨ç¨‹åºåªå†™ç¼“å­˜ï¼Œç¼“å­˜å®šæœŸæ‰¹é‡å†™å…¥æ•°æ®åº“

```
ç‰¹ç‚¹ï¼š
âœ… å†™å…¥æ€§èƒ½æœ€å¥½
âŒ å¯èƒ½ä¸¢å¤±æ•°æ®ï¼ˆRedisæ•…éšœæ—¶ï¼‰
ğŸ¯ é€‚ç”¨åœºæ™¯ï¼šå¯¹æ€§èƒ½è¦æ±‚æé«˜ï¼Œå¯æ¥å—å°‘é‡æ•°æ®ä¸¢å¤±
```

### 1.3 ç¼“å­˜å®è·µè¦ç‚¹


**ğŸ”‘ ç¼“å­˜é”®è®¾è®¡åŸåˆ™**
```
å‘½åè§„èŒƒï¼š
user:123          â†’ ç”¨æˆ·IDä¸º123çš„ä¿¡æ¯
product:456       â†’ å•†å“IDä¸º456çš„ä¿¡æ¯
cart:user:123     â†’ ç”¨æˆ·123çš„è´­ç‰©è½¦
session:abc123    â†’ ä¼šè¯IDä¸ºabc123çš„ä¿¡æ¯

è®¾è®¡è¦ç‚¹ï¼š
â€¢ å±‚çº§æ¸…æ™°ï¼šç”¨å†’å·åˆ†éš”ä¸åŒå±‚çº§
â€¢ ç®€æ´æ˜äº†ï¼šé¿å…è¿‡é•¿çš„é”®å
â€¢ é¿å…å†²çªï¼šä¸åŒä¸šåŠ¡ä½¿ç”¨ä¸åŒå‰ç¼€
```

**â° è¿‡æœŸæ—¶é—´ç­–ç•¥**
```
çƒ­ç‚¹æ•°æ®ï¼š30åˆ†é’Ÿ - 2å°æ—¶
ç”¨æˆ·ä¿¡æ¯ï¼š10-30åˆ†é’Ÿ
å•†å“ä¿¡æ¯ï¼š1-6å°æ—¶
é…ç½®ä¿¡æ¯ï¼š12-24å°æ—¶

è®¾ç½®åŸåˆ™ï¼š
â€¢ æ ¹æ®æ•°æ®æ›´æ–°é¢‘ç‡è®¾å®š
â€¢ æ ¹æ®ä¸šåŠ¡é‡è¦æ€§è°ƒæ•´
â€¢ é¿å…åŒæ—¶å¤§é‡è¿‡æœŸï¼ˆç¼“å­˜é›ªå´©ï¼‰
```

---

## 2. ğŸ”’ åˆ†å¸ƒå¼é”åº”ç”¨


### 2.1 ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼é”


**ğŸ”¸ é—®é¢˜èƒŒæ™¯**
```
å•æœºç¯å¢ƒï¼š
çº¿ç¨‹A â†’ synchronized â†’ ä¸´ç•Œèµ„æº â† çº¿ç¨‹B (ç­‰å¾…)

åˆ†å¸ƒå¼ç¯å¢ƒï¼š
æœåŠ¡å™¨1çš„çº¿ç¨‹A â†’ ??? â†’ å…±äº«èµ„æº â† ??? â† æœåŠ¡å™¨2çš„çº¿ç¨‹B
                   â†‘
              éœ€è¦åˆ†å¸ƒå¼é”åè°ƒ
```

**ğŸ’¡ åˆ†å¸ƒå¼é”çš„ä½œç”¨**
- **äº’æ–¥è®¿é—®**ï¼šç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªè¿›ç¨‹èƒ½è®¿é—®å…±äº«èµ„æº
- **é¿å…æ•°æ®ç«äº‰**ï¼šé˜²æ­¢å¹¶å‘ä¿®æ”¹å¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´
- **åŸå­æ€§ä¿è¯**ï¼šä¿è¯æ“ä½œçš„åŸå­æ€§

### 2.2 Redisåˆ†å¸ƒå¼é”å®ç°


#### ğŸ”§ åŸºç¡€å®ç°æ–¹æ¡ˆ


```java
public class RedisDistributedLock {
    private RedisTemplate<String, String> redisTemplate;
    
    // è·å–é”
    public boolean tryLock(String lockKey, String requestId, int expireTime) {
        // SET key value NX EX seconds
        // NXï¼šåªåœ¨é”®ä¸å­˜åœ¨æ—¶è®¾ç½®
        // EXï¼šè®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
        String result = redisTemplate.execute((RedisCallback<String>) connection -> {
            Object nativeConnection = connection.getNativeConnection();
            // è¿™é‡Œæ˜¯åŸå­æ“ä½œ
            return jedis.set(lockKey, requestId, "NX", "EX", expireTime);
        });
        
        return "OK".equals(result);
    }
    
    // é‡Šæ”¾é” - ä½¿ç”¨Luaè„šæœ¬ä¿è¯åŸå­æ€§
    public boolean releaseLock(String lockKey, String requestId) {
        String luaScript = 
            "if redis.call('get', KEYS[1]) == ARGV[1] then " +
            "    return redis.call('del', KEYS[1]) " +
            "else " +
            "    return 0 " +
            "end";
            
        Object result = redisTemplate.execute((RedisCallback<Object>) connection -> {
            return jedis.eval(luaScript, 1, lockKey, requestId);
        });
        
        return "1".equals(result.toString());
    }
}
```

#### ğŸ¯ ä½¿ç”¨ç¤ºä¾‹


```java
@Service
public class OrderService {
    @Autowired
    private RedisDistributedLock distributedLock;
    
    // ç§’æ€å•†å“æ‰£å‡åº“å­˜
    public boolean reduceStock(Long productId, int quantity) {
        String lockKey = "lock:product:" + productId;
        String requestId = UUID.randomUUID().toString();
        
        // å°è¯•è·å–é”ï¼Œæœ€å¤šç­‰å¾…10ç§’
        boolean locked = distributedLock.tryLock(lockKey, requestId, 10);
        if (!locked) {
            return false; // è·å–é”å¤±è´¥
        }
        
        try {
            // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
            int currentStock = getStockFromDB(productId);
            if (currentStock >= quantity) {
                updateStock(productId, currentStock - quantity);
                return true;
            }
            return false;
        } finally {
            // é‡Šæ”¾é”
            distributedLock.releaseLock(lockKey, requestId);
        }
    }
}
```

### 2.3 åˆ†å¸ƒå¼é”æ³¨æ„äº‹é¡¹


**âš ï¸ å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ**

| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| **é”è¶…æ—¶é‡Šæ”¾** | ä¸šåŠ¡æ‰§è¡Œæ—¶é—´è¶…è¿‡é”è¿‡æœŸæ—¶é—´ | è®¾ç½®åˆç†è¿‡æœŸæ—¶é—´ï¼Œæˆ–å®ç°é”ç»­æœŸ |
| **è¯¯åˆ åˆ«äººçš„é”** | é‡Šæ”¾é”æ—¶æ²¡æœ‰éªŒè¯èº«ä»½ | ä½¿ç”¨å”¯ä¸€requestIdæ ‡è¯†é”çš„æ‹¥æœ‰è€… |
| **åŸå­æ€§é—®é¢˜** | è·å–é”çš„æ£€æŸ¥å’Œè®¾ç½®ä¸æ˜¯åŸå­æ“ä½œ | ä½¿ç”¨`SET NX EX`æˆ–Luaè„šæœ¬ |

**ğŸ›¡ï¸ æœ€ä½³å®è·µ**
```
é”è®¾è®¡åŸåˆ™ï¼š
â€¢ é”ç²’åº¦è¦åˆé€‚ï¼šä¸èƒ½å¤ªå¤§å½±å“å¹¶å‘ï¼Œä¸èƒ½å¤ªå°é”å†²çªå¤š
â€¢ è¶…æ—¶æ—¶é—´è¦åˆç†ï¼šæ ¹æ®ä¸šåŠ¡æ‰§è¡Œæ—¶é—´è®¾å®š
â€¢ è¦æœ‰é‡Šæ”¾æœºåˆ¶ï¼šé¿å…æ­»é”
â€¢ è¦æœ‰é‡è¯•æœºåˆ¶ï¼šè·å–å¤±è´¥æ—¶çš„é‡è¯•ç­–ç•¥
```

---

## 3. ğŸ† æ’è¡Œæ¦œç³»ç»Ÿ


### 3.1 æ’è¡Œæ¦œéœ€æ±‚åˆ†æ


**ğŸ”¸ æ’è¡Œæ¦œçš„å¸¸è§åœºæ™¯**
```
æ¸¸æˆç§¯åˆ†æ¦œï¼š    ç”µå•†é”€é‡æ¦œï¼š    ç¤¾äº¤ç‚¹èµæ¦œï¼š
ç©å®¶A: 9500åˆ†   å•†å“A: 1200ä»¶   æ–‡ç« A: 5000ğŸ‘
ç©å®¶B: 8800åˆ†   å•†å“B: 980ä»¶    æ–‡ç« B: 4500ğŸ‘
ç©å®¶C: 7600åˆ†   å•†å“C: 750ä»¶    æ–‡ç« C: 3200ğŸ‘

å…±åŒç‰¹ç‚¹ï¼š
â€¢ éœ€è¦æŒ‰åˆ†æ•°æ’åº
â€¢ ç»å¸¸æŸ¥è¯¢æ’å
â€¢ åˆ†æ•°ä¼šå®æ—¶æ›´æ–°
â€¢ éœ€è¦åˆ†é¡µæŸ¥è¯¢
```

### 3.2 Redis Sorted Setå®ç°


**ğŸ¯ æ ¸å¿ƒæ•°æ®ç»“æ„ï¼šSorted Set (æœ‰åºé›†åˆ)**
```
Rediså‘½ä»¤ï¼š
ZADD key score member    # æ·»åŠ æˆå‘˜å’Œåˆ†æ•°
ZRANK key member         # æŸ¥è¯¢æˆå‘˜æ’å(ä»0å¼€å§‹)
ZRANGE key start stop    # æŸ¥è¯¢æ’åèŒƒå›´å†…çš„æˆå‘˜
ZINCRBY key increment member  # å¢åŠ æˆå‘˜åˆ†æ•°
```

```java
@Service
public class RankingService {
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    // æ›´æ–°ç”¨æˆ·åˆ†æ•°
    public void updateScore(String userId, double score) {
        String key = "ranking:game:score";
        redisTemplate.opsForZSet().add(key, userId, score);
    }
    
    // å¢åŠ ç”¨æˆ·åˆ†æ•°
    public void incrementScore(String userId, double increment) {
        String key = "ranking:game:score";
        redisTemplate.opsForZSet().incrementScore(key, userId, increment);
    }
    
    // è·å–ç”¨æˆ·æ’åï¼ˆæ’åä»1å¼€å§‹ï¼‰
    public Long getUserRank(String userId) {
        String key = "ranking:game:score";
        Long rank = redisTemplate.opsForZSet().reverseRank(key, userId);
        return rank != null ? rank + 1 : null;
    }
    
    // è·å–æ’è¡Œæ¦œå‰Nå
    public List<RankItem> getTopN(int n) {
        String key = "ranking:game:score";
        Set<ZSetOperations.TypedTuple<String>> tuples = 
            redisTemplate.opsForZSet().reverseRangeWithScores(key, 0, n - 1);
        
        List<RankItem> result = new ArrayList<>();
        int rank = 1;
        for (ZSetOperations.TypedTuple<String> tuple : tuples) {
            result.add(new RankItem(rank++, tuple.getValue(), tuple.getScore()));
        }
        return result;
    }
    
    // è·å–ç”¨æˆ·å‘¨å›´çš„æ’å
    public List<RankItem> getRankingAround(String userId, int count) {
        Long rank = getUserRank(userId);
        if (rank == null) return new ArrayList<>();
        
        long start = Math.max(0, rank - count - 1);
        long end = rank + count - 1;
        
        return getRankingByRange(start, end);
    }
}
```

### 3.3 æ’è¡Œæ¦œé«˜çº§åŠŸèƒ½


**ğŸ“Š å¤šç»´åº¦æ’è¡Œæ¦œ**
```java
// æ”¯æŒä¸åŒæ—¶é—´ç»´åº¦çš„æ’è¡Œæ¦œ
public class MultiTimeRanking {
    
    // æ›´æ–°å„ä¸ªæ—¶é—´ç»´åº¦çš„æ’è¡Œæ¦œ
    public void updateAllRankings(String userId, double score) {
        String today = LocalDate.now().toString();
        String thisWeek = getWeekKey();
        String thisMonth = getMonthKey();
        
        // æ—¥æ’è¡Œæ¦œ
        redisTemplate.opsForZSet().add("ranking:daily:" + today, userId, score);
        
        // å‘¨æ’è¡Œæ¦œ
        redisTemplate.opsForZSet().incrementScore("ranking:weekly:" + thisWeek, userId, score);
        
        // æœˆæ’è¡Œæ¦œ
        redisTemplate.opsForZSet().incrementScore("ranking:monthly:" + thisMonth, userId, score);
        
        // æ€»æ’è¡Œæ¦œ
        redisTemplate.opsForZSet().incrementScore("ranking:total", userId, score);
    }
}
```

**ğŸ• å®šæœŸæ¸…ç†ç­–ç•¥**
```java
// å®šæ—¶ä»»åŠ¡æ¸…ç†è¿‡æœŸçš„æ’è¡Œæ¦œæ•°æ®
@Scheduled(cron = "0 0 1 * * ?") // æ¯å¤©å‡Œæ™¨1ç‚¹æ‰§è¡Œ
public void cleanExpiredRankings() {
    String yesterday = LocalDate.now().minusDays(1).toString();
    String lastWeek = getLastWeekKey();
    
    // åˆ é™¤è¿‡æœŸçš„æ—¥æ’è¡Œæ¦œ
    redisTemplate.delete("ranking:daily:" + yesterday);
    
    // ä¿ç•™å‘¨æ’è¡Œæ¦œç”¨äºå†å²æŸ¥è¯¢ï¼Œä½†å¯ä»¥è®¾ç½®è¾ƒé•¿çš„è¿‡æœŸæ—¶é—´
    redisTemplate.expire("ranking:weekly:" + lastWeek, 30, TimeUnit.DAYS);
}
```

---

## 4. ğŸ” åˆ†å¸ƒå¼é”åº”ç”¨


### 4.1 åˆ†å¸ƒå¼é”çš„çœŸå®éœ€æ±‚


**ğŸ”¸ å…¸å‹ä¸šåŠ¡åœºæ™¯**
```
ç§’æ€æ´»åŠ¨ï¼š
é—®é¢˜ï¼š1000äººåŒæ—¶æŠ¢100ä»¶å•†å“ï¼Œå¦‚ä½•é˜²æ­¢è¶…å–ï¼Ÿ
éœ€æ±‚ï¼šç¡®ä¿åº“å­˜æ‰£å‡çš„åŸå­æ€§

è®¢å•å·ç”Ÿæˆï¼š
é—®é¢˜ï¼šå¤šä¸ªæœåŠ¡åŒæ—¶ç”Ÿæˆè®¢å•å·ï¼Œå¦‚ä½•é¿å…é‡å¤ï¼Ÿ
éœ€æ±‚ï¼šç¡®ä¿è®¢å•å·ç”Ÿæˆçš„å”¯ä¸€æ€§

å®šæ—¶ä»»åŠ¡ï¼š
é—®é¢˜ï¼šå¤šä¸ªå®ä¾‹çš„å®šæ—¶ä»»åŠ¡åŒæ—¶æ‰§è¡Œï¼Œå¦‚ä½•é¿å…é‡å¤ï¼Ÿ
éœ€æ±‚ï¼šç¡®ä¿ä»»åŠ¡åªæ‰§è¡Œä¸€æ¬¡
```

### 4.2 Redisåˆ†å¸ƒå¼é”è¯¦è§£


#### ğŸ”‘ é”çš„æ ¸å¿ƒè¦ç´ 


```
é”çš„ä¸‰è¦ç´ ï¼š
1. äº’æ–¥æ€§ï¼šåŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªå®¢æˆ·ç«¯è·å–é”
2. å®‰å…¨æ€§ï¼šåªæœ‰é”çš„æŒæœ‰è€…æ‰èƒ½é‡Šæ”¾é”
3. æ´»æ€§ï¼šå³ä½¿æŒæœ‰é”çš„å®¢æˆ·ç«¯å´©æºƒï¼Œé”æœ€ç»ˆä¹Ÿèƒ½è¢«é‡Šæ”¾
```

#### âš¡ ç®€å•é”å®ç°


```java
public class SimpleRedisLock {
    private RedisTemplate<String, String> redisTemplate;
    
    // å°è¯•è·å–é”
    public boolean lock(String lockKey, String requestId, int expireSeconds) {
        // ä½¿ç”¨SETå‘½ä»¤çš„NXå’ŒEXé€‰é¡¹ï¼Œä¿è¯åŸå­æ€§
        Boolean result = redisTemplate.opsForValue()
            .setIfAbsent(lockKey, requestId, Duration.ofSeconds(expireSeconds));
        return Boolean.TRUE.equals(result);
    }
    
    // é‡Šæ”¾é” - å¿…é¡»ä½¿ç”¨Luaè„šæœ¬ä¿è¯åŸå­æ€§
    public boolean unlock(String lockKey, String requestId) {
        String script = 
            "if redis.call('get', KEYS[1]) == ARGV[1] then " +
            "    return redis.call('del', KEYS[1]) " +
            "else " +
            "    return 0 " +
            "end";
        
        DefaultRedisScript<Long> redisScript = new DefaultRedisScript<>();
        redisScript.setScriptText(script);
        redisScript.setResultType(Long.class);
        
        Long result = redisTemplate.execute(redisScript, 
            Collections.singletonList(lockKey), requestId);
        return result != null && result == 1L;
    }
}
```

**ğŸ› ï¸ å®é™…ä½¿ç”¨æ¨¡å¼**
```java
@Component
public class InventoryService {
    @Autowired
    private SimpleRedisLock redisLock;
    
    // æ‰£å‡åº“å­˜çš„å®‰å…¨å®ç°
    public boolean reduceInventory(Long productId, int quantity) {
        String lockKey = "lock:inventory:" + productId;
        String requestId = Thread.currentThread().getId() + "-" + System.currentTimeMillis();
        
        // å°è¯•è·å–é”ï¼Œè¶…æ—¶æ—¶é—´10ç§’
        boolean locked = redisLock.lock(lockKey, requestId, 10);
        if (!locked) {
            log.warn("è·å–åº“å­˜é”å¤±è´¥ï¼Œå•†å“ID: {}", productId);
            return false;
        }
        
        try {
            // æ‰§è¡Œåº“å­˜æ‰£å‡é€»è¾‘
            Integer currentStock = getCurrentStock(productId);
            if (currentStock >= quantity) {
                updateStock(productId, currentStock - quantity);
                return true;
            }
            return false;
        } finally {
            // ç¡®ä¿é‡Šæ”¾é”
            redisLock.unlock(lockKey, requestId);
        }
    }
}
```

### 4.3 åˆ†å¸ƒå¼é”çš„é—®é¢˜ä¸æ”¹è¿›


**âš ï¸ å¸¸è§é—®é¢˜**

| é—®é¢˜ | åœºæ™¯ | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| **é”è¶…æ—¶** | ä¸šåŠ¡æ‰§è¡Œæ—¶é—´æ¯”é”è¿‡æœŸæ—¶é—´é•¿ | å®ç°é”ç»­æœŸæˆ–è®¾ç½®åˆç†è¶…æ—¶æ—¶é—´ |
| **æ­»é”** | å®¢æˆ·ç«¯è·å–é”åå´©æºƒ | è®¾ç½®é”è‡ªåŠ¨è¿‡æœŸæ—¶é—´ |
| **é”è¯¯åˆ ** | åˆ é™¤äº†å…¶ä»–å®¢æˆ·ç«¯çš„é” | ä½¿ç”¨å”¯ä¸€æ ‡è¯†éªŒè¯é”çš„æŒæœ‰è€… |
| **åŸå­æ€§** | æ£€æŸ¥å’Œè®¾ç½®é”ä¸æ˜¯åŸå­æ“ä½œ | ä½¿ç”¨Luaè„šæœ¬æˆ–Rediså‘½ä»¤ |

**ğŸ”§ é”ç»­æœŸå®ç°**
```java
// çœ‹é—¨ç‹—æœºåˆ¶ï¼šå®šæœŸå»¶é•¿é”çš„è¿‡æœŸæ—¶é—´
public class LockWatchdog {
    private ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(1);
    
    public boolean lockWithWatchdog(String lockKey, String requestId) {
        boolean locked = redisLock.lock(lockKey, requestId, 30); // 30ç§’è¶…æ—¶
        
        if (locked) {
            // å¯åŠ¨çœ‹é—¨ç‹—ï¼Œæ¯20ç§’ç»­æœŸä¸€æ¬¡
            ScheduledFuture<?> watchdog = scheduler.scheduleAtFixedRate(() -> {
                if (isLockMine(lockKey, requestId)) {
                    redisTemplate.expire(lockKey, 30, TimeUnit.SECONDS);
                }
            }, 20, 20, TimeUnit.SECONDS);
            
            // ä¸šåŠ¡å®Œæˆååœæ­¢çœ‹é—¨ç‹—
            // watchdog.cancel(false);
        }
        
        return locked;
    }
}
```

---

## 5. ğŸ† æ’è¡Œæ¦œç³»ç»Ÿ


### 5.1 æ’è¡Œæ¦œçš„ä¸šåŠ¡ä»·å€¼


**ğŸ® æ¸¸æˆæ’è¡Œæ¦œåº”ç”¨**
```
å®é™…éœ€æ±‚ï¼š
â€¢ å®æ—¶æ˜¾ç¤ºç©å®¶ç§¯åˆ†æ’å
â€¢ æ”¯æŒæŸ¥çœ‹è‡ªå·±çš„æ’åä½ç½®
â€¢ æ˜¾ç¤ºæ’åå˜åŒ–è¶‹åŠ¿
â€¢ æ”¯æŒä¸åŒæ—¶é—´ç»´åº¦ï¼ˆæ—¥æ¦œã€å‘¨æ¦œã€æœˆæ¦œï¼‰

æŠ€æœ¯æŒ‘æˆ˜ï¼š
â€¢ é«˜å¹¶å‘æ›´æ–°åˆ†æ•°
â€¢ å¿«é€ŸæŸ¥è¯¢ä»»æ„ç”¨æˆ·æ’å
â€¢ é«˜æ•ˆè·å–TOP Nç”¨æˆ·
â€¢ æ•°æ®é‡å¤§æ—¶çš„æ€§èƒ½ä¿è¯
```

### 5.2 Sorted Setæ·±å…¥åº”ç”¨


#### ğŸ“ˆ å®æ—¶ç§¯åˆ†æ›´æ–°


```java
@Component
public class GameRankingService {
    
    // ç©å®¶å®Œæˆæ¸¸æˆåæ›´æ–°ç§¯åˆ†
    public void updatePlayerScore(String playerId, int scoreIncrement, String gameMode) {
        String key = "ranking:" + gameMode;
        
        // å¢åŠ ç§¯åˆ†
        Double newScore = redisTemplate.opsForZSet()
            .incrementScore(key, playerId, scoreIncrement);
        
        // è®°å½•ç§¯åˆ†å˜åŒ–å†å²
        recordScoreHistory(playerId, scoreIncrement, newScore);
    }
    
    // è·å–ç©å®¶è¯¦ç»†æ’åä¿¡æ¯
    public PlayerRankInfo getPlayerRankInfo(String playerId, String gameMode) {
        String key = "ranking:" + gameMode;
        
        // è·å–å½“å‰ç§¯åˆ†
        Double score = redisTemplate.opsForZSet().score(key, playerId);
        if (score == null) {
            return null; // ç©å®¶ä¸åœ¨æ’è¡Œæ¦œä¸­
        }
        
        // è·å–æ’åï¼ˆæ³¨æ„ï¼šRedisè¿”å›çš„rankä»0å¼€å§‹ï¼‰
        Long rank = redisTemplate.opsForZSet().reverseRank(key, playerId);
        
        // è·å–æ€»äººæ•°
        Long totalPlayers = redisTemplate.opsForZSet().zCard(key);
        
        return new PlayerRankInfo(playerId, score.intValue(), 
            rank + 1, totalPlayers);
    }
    
    // è·å–ç©å®¶å‘¨å›´çš„æ’å
    public List<RankItem> getNearbyPlayers(String playerId, String gameMode, int radius) {
        Long playerRank = redisTemplate.opsForZSet().reverseRank("ranking:" + gameMode, playerId);
        if (playerRank == null) return new ArrayList<>();
        
        long start = Math.max(0, playerRank - radius);
        long end = playerRank + radius;
        
        Set<ZSetOperations.TypedTuple<String>> tuples = redisTemplate.opsForZSet()
            .reverseRangeWithScores("ranking:" + gameMode, start, end);
        
        return convertToRankItems(tuples, start + 1);
    }
}
```

#### ğŸ… æ¦œå•ç¼“å­˜ä¼˜åŒ–


```java
// çƒ­æ¦œæ•°æ®é¢„è®¡ç®—å’Œç¼“å­˜
@Component
public class RankingCacheService {
    
    // é¢„è®¡ç®—TOPæ¦œå•ï¼Œå®šæœŸæ›´æ–°
    @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡
    public void updateTopRankingsCache() {
        String sourceKey = "ranking:game:score";
        String cacheKey = "cache:top100";
        
        // è·å–TOP 100
        Set<ZSetOperations.TypedTuple<String>> top100 = 
            redisTemplate.opsForZSet().reverseRangeWithScores(sourceKey, 0, 99);
        
        // è½¬æ¢ä¸ºæ˜“è¯»æ ¼å¼å¹¶ç¼“å­˜
        List<RankItem> rankList = convertToRankList(top100);
        redisTemplate.opsForValue().set(cacheKey, 
            JSON.toJSONString(rankList), 5, TimeUnit.MINUTES);
    }
    
    // å¿«é€Ÿè·å–TOPæ¦œå•
    public List<RankItem> getTop100() {
        String cacheKey = "cache:top100";
        String cached = redisTemplate.opsForValue().get(cacheKey);
        
        if (cached != null) {
            return JSON.parseArray(cached, RankItem.class);
        }
        
        // ç¼“å­˜æœªå‘½ä¸­ï¼Œå®æ—¶è®¡ç®—
        return calculateTop100();
    }
}
```

---

## 6. â° å»¶æ—¶ä»»åŠ¡å¤„ç†


### 6.1 å»¶æ—¶ä»»åŠ¡çš„åº”ç”¨åœºæ™¯


**ğŸ”¸ å¸¸è§ä¸šåŠ¡éœ€æ±‚**
```
è®¢å•è¶…æ—¶å–æ¶ˆï¼š
ä¸‹å•å30åˆ†é’Ÿæœªæ”¯ä»˜ â†’ è‡ªåŠ¨å–æ¶ˆè®¢å•

æ¶ˆæ¯å®šæ—¶å‘é€ï¼š
ç”¨æˆ·ç”Ÿæ—¥å‰3å¤© â†’ å‘é€ç”Ÿæ—¥ç¥ç¦çŸ­ä¿¡

ä¼šå‘˜åˆ°æœŸæé†’ï¼š
ä¼šå‘˜åˆ°æœŸå‰7å¤© â†’ å‘é€ç»­è´¹æé†’

é™æ—¶ä¼˜æƒ ï¼š
æ´»åŠ¨å¼€å§‹æ—¶é—´ â†’ è‡ªåŠ¨ä¸Šçº¿ä¿ƒé”€æ´»åŠ¨
```

### 6.2 Rediså»¶æ—¶é˜Ÿåˆ—å®ç°


#### ğŸ• åŸºäºSorted Setçš„å»¶æ—¶é˜Ÿåˆ—


**ğŸ’¡ æ ¸å¿ƒæ€æƒ³**ï¼šå°†ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´ä½œä¸ºscoreï¼Œä»»åŠ¡ä¿¡æ¯ä½œä¸ºmember

```java
@Component
public class DelayedTaskService {
    
    // æ·»åŠ å»¶æ—¶ä»»åŠ¡
    public void addDelayedTask(String taskId, Object taskData, long delaySeconds) {
        String key = "delayed:tasks";
        long executeTime = System.currentTimeMillis() + delaySeconds * 1000;
        
        // ä»»åŠ¡ä¿¡æ¯åºåˆ—åŒ–
        DelayedTask task = new DelayedTask(taskId, taskData, executeTime);
        String taskJson = JSON.toJSONString(task);
        
        // ä½¿ç”¨æ‰§è¡Œæ—¶é—´ä½œä¸ºscoreæ·»åŠ åˆ°sorted set
        redisTemplate.opsForZSet().add(key, taskJson, executeTime);
        
        log.info("æ·»åŠ å»¶æ—¶ä»»åŠ¡: {}, å»¶è¿Ÿ{}ç§’æ‰§è¡Œ", taskId, delaySeconds);
    }
    
    // è·å–åˆ°æœŸçš„ä»»åŠ¡
    public List<DelayedTask> getExpiredTasks() {
        String key = "delayed:tasks";
        long currentTime = System.currentTimeMillis();
        
        // è·å–scoreå°äºç­‰äºå½“å‰æ—¶é—´çš„ä»»åŠ¡ï¼ˆå³åˆ°æœŸä»»åŠ¡ï¼‰
        Set<String> expiredTasks = redisTemplate.opsForZSet()
            .rangeByScore(key, 0, currentTime);
        
        List<DelayedTask> tasks = new ArrayList<>();
        for (String taskJson : expiredTasks) {
            DelayedTask task = JSON.parseObject(taskJson, DelayedTask.class);
            tasks.add(task);
            
            // è·å–åç«‹å³åˆ é™¤ï¼Œé¿å…é‡å¤æ‰§è¡Œ
            redisTemplate.opsForZSet().remove(key, taskJson);
        }
        
        return tasks;
    }
    
    // å®šæ—¶æ£€æŸ¥å¹¶æ‰§è¡Œåˆ°æœŸä»»åŠ¡
    @Scheduled(fixedRate = 1000) // æ¯ç§’æ£€æŸ¥ä¸€æ¬¡
    public void processExpiredTasks() {
        List<DelayedTask> expiredTasks = getExpiredTasks();
        
        for (DelayedTask task : expiredTasks) {
            try {
                executeTask(task);
            } catch (Exception e) {
                log.error("æ‰§è¡Œå»¶æ—¶ä»»åŠ¡å¤±è´¥: {}", task.getTaskId(), e);
                // å¯ä»¥å°†å¤±è´¥çš„ä»»åŠ¡é‡æ–°åŠ å…¥é˜Ÿåˆ—æˆ–è®°å½•åˆ°å¤±è´¥é˜Ÿåˆ—
            }
        }
    }
}
```

#### ğŸ“‹ å…·ä½“åº”ç”¨ç¤ºä¾‹


```java
// è®¢å•è¶…æ—¶å–æ¶ˆå®ç°
@Service
public class OrderTimeoutService {
    @Autowired
    private DelayedTaskService delayedTaskService;
    
    // åˆ›å»ºè®¢å•æ—¶æ·»åŠ è¶…æ—¶ä»»åŠ¡
    public void createOrderWithTimeout(Order order) {
        // ä¿å­˜è®¢å•
        orderDao.save(order);
        
        // æ·»åŠ 30åˆ†é’Ÿåçš„è¶…æ—¶å–æ¶ˆä»»åŠ¡
        Map<String, Object> taskData = new HashMap<>();
        taskData.put("orderId", order.getId());
        taskData.put("action", "cancel_unpaid_order");
        
        delayedTaskService.addDelayedTask(
            "cancel_order_" + order.getId(),
            taskData,
            30 * 60 // 30åˆ†é’Ÿ
        );
    }
    
    // æ”¯ä»˜æˆåŠŸæ—¶å–æ¶ˆè¶…æ—¶ä»»åŠ¡
    public void onOrderPaid(String orderId) {
        // æ›´æ–°è®¢å•çŠ¶æ€
        orderDao.updateStatus(orderId, OrderStatus.PAID);
        
        // å–æ¶ˆè¶…æ—¶ä»»åŠ¡
        cancelDelayedTask("cancel_order_" + orderId);
    }
}
```

---

## 7. ğŸ”„ Sessionå…±äº«æ–¹æ¡ˆ


### 7.1 Sessionå…±äº«çš„é—®é¢˜èƒŒæ™¯


**ğŸ”¸ ä¼ ç»Ÿå•æœºSessioné—®é¢˜**
```
å•æœºåº”ç”¨ï¼š
ç”¨æˆ· â†’ WebæœåŠ¡å™¨ â†’ å†…å­˜ä¸­çš„Session

é—®é¢˜ï¼š
âœ… ç®€å•ç›´æ¥
âŒ æœåŠ¡å™¨é‡å¯Sessionä¸¢å¤±
âŒ æ— æ³•æ”¯æŒè´Ÿè½½å‡è¡¡
âŒ æ°´å¹³æ‰©å±•å›°éš¾

åˆ†å¸ƒå¼åº”ç”¨ï¼š
         è´Ÿè½½å‡è¡¡å™¨
           /    \
    æœåŠ¡å™¨A      æœåŠ¡å™¨B
     Session1    Session2

é—®é¢˜ï¼šç”¨æˆ·è¯·æ±‚å¯èƒ½è·¯ç”±åˆ°ä¸åŒæœåŠ¡å™¨ï¼ŒSessionæ— æ³•å…±äº«
```

### 7.2 Redis Sessionå­˜å‚¨æ–¹æ¡ˆ


#### ğŸ’¾ Sessionæ•°æ®ç»“æ„è®¾è®¡


```java
// Sessionæ•°æ®æ¨¡å‹
public class RedisSession {
    private String sessionId;
    private String userId;
    private Map<String, Object> attributes;
    private long creationTime;
    private long lastAccessTime;
    private int maxInactiveInterval; // è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
    
    // æ£€æŸ¥Sessionæ˜¯å¦è¿‡æœŸ
    public boolean isExpired() {
        return System.currentTimeMillis() - lastAccessTime > 
               maxInactiveInterval * 1000L;
    }
}
```

#### ğŸ”§ Sessionç®¡ç†å®ç°


```java
@Component
public class RedisSessionManager {
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    private static final String SESSION_PREFIX = "session:";
    private static final int DEFAULT_TIMEOUT = 30 * 60; // 30åˆ†é’Ÿ
    
    // åˆ›å»ºæ–°Session
    public RedisSession createSession() {
        String sessionId = generateSessionId();
        RedisSession session = new RedisSession();
        session.setSessionId(sessionId);
        session.setCreationTime(System.currentTimeMillis());
        session.setLastAccessTime(System.currentTimeMillis());
        session.setMaxInactiveInterval(DEFAULT_TIMEOUT);
        session.setAttributes(new HashMap<>());
        
        saveSession(session);
        return session;
    }
    
    // è·å–Session
    public RedisSession getSession(String sessionId) {
        String key = SESSION_PREFIX + sessionId;
        RedisSession session = (RedisSession) redisTemplate.opsForValue().get(key);
        
        if (session != null && !session.isExpired()) {
            // æ›´æ–°æœ€åè®¿é—®æ—¶é—´
            session.setLastAccessTime(System.currentTimeMillis());
            saveSession(session);
            return session;
        }
        
        return null; // Sessionä¸å­˜åœ¨æˆ–å·²è¿‡æœŸ
    }
    
    // ä¿å­˜Session
    public void saveSession(RedisSession session) {
        String key = SESSION_PREFIX + session.getSessionId();
        
        // ä¿å­˜Sessionæ•°æ®ï¼Œè®¾ç½®è¿‡æœŸæ—¶é—´
        redisTemplate.opsForValue().set(key, session, 
            session.getMaxInactiveInterval(), TimeUnit.SECONDS);
    }
    
    // åˆ é™¤Session
    public void invalidateSession(String sessionId) {
        String key = SESSION_PREFIX + sessionId;
        redisTemplate.delete(key);
    }
    
    // ç”Ÿæˆå”¯ä¸€Session ID
    private String generateSessionId() {
        return UUID.randomUUID().toString().replace("-", "");
    }
}
```

#### ğŸŒ Webå±‚é›†æˆ


```java
// Spring MVCæ‹¦æˆªå™¨é›†æˆ
@Component
public class RedisSessionInterceptor implements HandlerInterceptor {
    @Autowired
    private RedisSessionManager sessionManager;
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler) {
        // ä»Cookieä¸­è·å–Session ID
        String sessionId = getSessionIdFromCookie(request);
        
        RedisSession session = null;
        if (sessionId != null) {
            session = sessionManager.getSession(sessionId);
        }
        
        if (session == null) {
            // åˆ›å»ºæ–°Session
            session = sessionManager.createSession();
            
            // è®¾ç½®Cookie
            Cookie cookie = new Cookie("JSESSIONID", session.getSessionId());
            cookie.setPath("/");
            cookie.setMaxAge(30 * 60); // 30åˆ†é’Ÿ
            response.addCookie(cookie);
        }
        
        // å°†Sessionæ”¾å…¥è¯·æ±‚å±æ€§ä¸­ï¼Œä¾›Controllerä½¿ç”¨
        request.setAttribute("session", session);
        return true;
    }
    
    private String getSessionIdFromCookie(HttpServletRequest request) {
        Cookie[] cookies = request.getCookies();
        if (cookies != null) {
            for (Cookie cookie : cookies) {
                if ("JSESSIONID".equals(cookie.getName())) {
                    return cookie.getValue();
                }
            }
        }
        return null;
    }
}
```

---

## 8. â²ï¸ å»¶æ—¶ä»»åŠ¡å¤„ç†


### 8.1 å»¶æ—¶ä»»åŠ¡çš„æ ¸å¿ƒåœºæ™¯


**ğŸ•’ æ—¶é—´é©±åŠ¨çš„ä¸šåŠ¡é€»è¾‘**
```
ç”µå•†åœºæ™¯ï¼š
â€¢ è®¢å•è¶…æ—¶è‡ªåŠ¨å–æ¶ˆ
â€¢ ç¡®è®¤æ”¶è´§å€’è®¡æ—¶
â€¢ ä¼˜æƒ åˆ¸åˆ°æœŸæé†’

ç¤¾äº¤åœºæ™¯ï¼š
â€¢ åŠ¨æ€å®šæ—¶å‘å¸ƒ
â€¢ ç”Ÿæ—¥ç¥ç¦æ¨é€
â€¢ æ´»åŠ¨å¼€å§‹é€šçŸ¥

ä¸šåŠ¡æµç¨‹ï¼š
â€¢ å®¡æ‰¹æµç¨‹è¶…æ—¶å¤„ç†
â€¢ ä»»åŠ¡æˆªæ­¢æé†’
â€¢ æ•°æ®å®šæœŸæ¸…ç†
```

### 8.2 å»¶æ—¶é˜Ÿåˆ—çš„æŠ€æœ¯å®ç°


#### â° åŸºäºè¿‡æœŸé”®é€šçŸ¥


```java
// åˆ©ç”¨Redisé”®è¿‡æœŸäº‹ä»¶å®ç°å»¶æ—¶ä»»åŠ¡
@Component
public class ExpireBasedDelayQueue {
    
    // æ·»åŠ å»¶æ—¶ä»»åŠ¡
    public void addTask(String taskId, Object taskData, long delaySeconds) {
        // å°†ä»»åŠ¡æ•°æ®å­˜å‚¨åˆ°Hashä¸­
        String dataKey = "task:data:" + taskId;
        redisTemplate.opsForHash().putAll(dataKey, convertToHash(taskData));
        
        // åˆ›å»ºè¿‡æœŸé”®è§¦å‘ä»»åŠ¡æ‰§è¡Œ
        String triggerKey = "task:trigger:" + taskId;
        redisTemplate.opsForValue().set(triggerKey, taskId, delaySeconds, TimeUnit.SECONDS);
    }
    
    // ç›‘å¬é”®è¿‡æœŸäº‹ä»¶
    @EventListener
    public void handleExpiredKey(ExpiredKeyEvent event) {
        String expiredKey = new String(event.getSource());
        
        if (expiredKey.startsWith("task:trigger:")) {
            String taskId = expiredKey.substring("task:trigger:".length());
            executeDelayedTask(taskId);
        }
    }
    
    private void executeDelayedTask(String taskId) {
        String dataKey = "task:data:" + taskId;
        Map<Object, Object> taskData = redisTemplate.opsForHash().entries(dataKey);
        
        if (!taskData.isEmpty()) {
            // æ‰§è¡Œä»»åŠ¡é€»è¾‘
            processTask(taskId, taskData);
            
            // åˆ é™¤ä»»åŠ¡æ•°æ®
            redisTemplate.delete(dataKey);
        }
    }
}
```

#### ğŸ“ å®é™…ä¸šåŠ¡åº”ç”¨


```java
// è®¢å•è¶…æ—¶å–æ¶ˆçš„å®Œæ•´å®ç°
@Service
public class OrderTimeoutProcessor {
    
    // åˆ›å»ºè®¢å•æ—¶è®¾ç½®è¶…æ—¶ä»»åŠ¡
    public void createOrderWithTimeout(Order order) {
        // ä¿å­˜è®¢å•åˆ°æ•°æ®åº“
        orderRepository.save(order);
        
        // åˆ›å»ºè¶…æ—¶å–æ¶ˆä»»åŠ¡
        Map<String, Object> taskData = new HashMap<>();
        taskData.put("orderId", order.getId());
        taskData.put("action", "CANCEL_ORDER");
        taskData.put("reason", "PAYMENT_TIMEOUT");
        
        delayTaskService.addDelayedTask(
            "cancel_order_" + order.getId(),
            taskData,
            30 * 60 // 30åˆ†é’Ÿåæ‰§è¡Œ
        );
        
        log.info("è®¢å•è¶…æ—¶ä»»åŠ¡å·²è®¾ç½®: {}", order.getId());
    }
    
    // å¤„ç†è¶…æ—¶ä»»åŠ¡
    public void handleTimeoutTask(String taskId, Map<String, Object> taskData) {
        String action = (String) taskData.get("action");
        
        if ("CANCEL_ORDER".equals(action)) {
            String orderId = (String) taskData.get("orderId");
            cancelUnpaidOrder(orderId);
        }
    }
    
    private void cancelUnpaidOrder(String orderId) {
        Order order = orderRepository.findById(orderId);
        
        // æ£€æŸ¥è®¢å•çŠ¶æ€ï¼Œåªå–æ¶ˆæœªæ”¯ä»˜çš„è®¢å•
        if (order != null && order.getStatus() == OrderStatus.PENDING_PAYMENT) {
            order.setStatus(OrderStatus.CANCELLED);
            order.setCancelReason("æ”¯ä»˜è¶…æ—¶è‡ªåŠ¨å–æ¶ˆ");
            orderRepository.save(order);
            
            // æ¢å¤åº“å­˜
            restoreInventory(order);
            
            log.info("è®¢å•è¶…æ—¶è‡ªåŠ¨å–æ¶ˆ: {}", orderId);
        }
    }
}
```

---

## 9. ğŸŒ Sessionå…±äº«æ–¹æ¡ˆ


### 9.1 Sessionå…±äº«çš„æ¶æ„è®¾è®¡


**ğŸ—ï¸ ç³»ç»Ÿæ¶æ„å›¾**
```
ç”¨æˆ·è¯·æ±‚æµç¨‹ï¼š
ç”¨æˆ·æµè§ˆå™¨ â†’ è´Ÿè½½å‡è¡¡å™¨ â†’ ä»»æ„WebæœåŠ¡å™¨ â†’ Redis Sessionå­˜å‚¨

                  è´Ÿè½½å‡è¡¡å™¨
                     |
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼           â–¼           â–¼
    WebæœåŠ¡å™¨A   WebæœåŠ¡å™¨B   WebæœåŠ¡å™¨C
         |           |           |
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â–¼
               Redisé›†ç¾¤
             (Sessionç»Ÿä¸€å­˜å‚¨)

ä¼˜åŠ¿ï¼š
âœ… ç”¨æˆ·å¯ä»¥è®¿é—®ä»»æ„æœåŠ¡å™¨
âœ… æœåŠ¡å™¨é‡å¯ä¸å½±å“ç”¨æˆ·ä¼šè¯
âœ… æ”¯æŒæ°´å¹³æ‰©å±•
```

### 9.2 Sessionæ•°æ®å­˜å‚¨ç­–ç•¥


#### ğŸ“¦ Sessionæ•°æ®ç»“æ„ä¼˜åŒ–


```java
// ä¼˜åŒ–çš„Sessionå­˜å‚¨ç»“æ„
@Component
public class OptimizedSessionManager {
    
    // ä½¿ç”¨Hashç»“æ„å­˜å‚¨Sessionï¼Œä¾¿äºéƒ¨åˆ†æ›´æ–°
    public void setSessionAttribute(String sessionId, String attribute, Object value) {
        String key = "session:" + sessionId;
        
        // åºåˆ—åŒ–å±æ€§å€¼
        String jsonValue = JSON.toJSONString(value);
        
        // ä½¿ç”¨Hashå­˜å‚¨ï¼Œæ”¯æŒå•ä¸ªå±æ€§æ›´æ–°
        redisTemplate.opsForHash().put(key, attribute, jsonValue);
        
        // æ›´æ–°æœ€åè®¿é—®æ—¶é—´
        redisTemplate.opsForHash().put(key, "lastAccessTime", 
            String.valueOf(System.currentTimeMillis()));
        
        // å»¶é•¿Sessionè¿‡æœŸæ—¶é—´
        redisTemplate.expire(key, 30, TimeUnit.MINUTES);
    }
    
    // è·å–Sessionå±æ€§
    public <T> T getSessionAttribute(String sessionId, String attribute, Class<T> clazz) {
        String key = "session:" + sessionId;
        
        String jsonValue = (String) redisTemplate.opsForHash().get(key, attribute);
        if (jsonValue != null) {
            // æ›´æ–°è®¿é—®æ—¶é—´
            updateLastAccessTime(sessionId);
            return JSON.parseObject(jsonValue, clazz);
        }
        
        return null;
    }
    
    // æ‰¹é‡è·å–Sessionæ‰€æœ‰å±æ€§
    public Map<String, Object> getSessionAttributes(String sessionId) {
        String key = "session:" + sessionId;
        Map<Object, Object> hashData = redisTemplate.opsForHash().entries(key);
        
        Map<String, Object> attributes = new HashMap<>();
        for (Map.Entry<Object, Object> entry : hashData.entrySet()) {
            String attrName = (String) entry.getKey();
            String jsonValue = (String) entry.getValue();
            
            if (!"lastAccessTime".equals(attrName)) {
                attributes.put(attrName, JSON.parse(jsonValue));
            }
        }
        
        updateLastAccessTime(sessionId);
        return attributes;
    }
}
```

#### ğŸ”„ Sessionç”Ÿå‘½å‘¨æœŸç®¡ç†


```java
// Sessionæ¸…ç†å’Œç»´æŠ¤
@Component
public class SessionMaintenanceService {
    
    // å®šæœŸæ¸…ç†è¿‡æœŸSession
    @Scheduled(fixedRate = 300000) // æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
    public void cleanExpiredSessions() {
        String pattern = "session:*";
        Set<String> sessionKeys = redisTemplate.keys(pattern);
        
        for (String key : sessionKeys) {
            String lastAccessTimeStr = (String) redisTemplate.opsForHash()
                .get(key, "lastAccessTime");
            
            if (lastAccessTimeStr != null) {
                long lastAccessTime = Long.parseLong(lastAccessTimeStr);
                long currentTime = System.currentTimeMillis();
                
                // æ£€æŸ¥æ˜¯å¦è¶…è¿‡30åˆ†é’Ÿæœªè®¿é—®
                if (currentTime - lastAccessTime > 30 * 60 * 1000) {
                    redisTemplate.delete(key);
                    log.info("æ¸…ç†è¿‡æœŸSession: {}", key);
                }
            }
        }
    }
    
    // Sessionç»Ÿè®¡ä¿¡æ¯
    public SessionStats getSessionStats() {
        String pattern = "session:*";
        Set<String> sessionKeys = redisTemplate.keys(pattern);
        
        int totalSessions = sessionKeys.size();
        int activeSessions = 0;
        long currentTime = System.currentTimeMillis();
        
        for (String key : sessionKeys) {
            String lastAccessTimeStr = (String) redisTemplate.opsForHash()
                .get(key, "lastAccessTime");
            
            if (lastAccessTimeStr != null) {
                long lastAccessTime = Long.parseLong(lastAccessTimeStr);
                // 5åˆ†é’Ÿå†…è®¿é—®è¿‡çš„ç®—ä½œæ´»è·ƒSession
                if (currentTime - lastAccessTime < 5 * 60 * 1000) {
                    activeSessions++;
                }
            }
        }
        
        return new SessionStats(totalSessions, activeSessions);
    }
}
```

---

## 10. ğŸ“Š åº”ç”¨æ¨¡å¼æ€§èƒ½å¯¹æ¯”


### 10.1 å„æ¨¡å¼æ€§èƒ½ç‰¹ç‚¹


| åº”ç”¨æ¨¡å¼ | **å†…å­˜å ç”¨** | **æŸ¥è¯¢æ€§èƒ½** | **å¹¶å‘æ”¯æŒ** | **å¤æ‚åº¦** | **é€‚ç”¨åœºæ™¯** |
|---------|-------------|-------------|-------------|-----------|-------------|
| **ğŸ—„ï¸ ç¼“å­˜** | `ä¸­ç­‰` | `æå¿«` | `æé«˜` | `ä½` | `çƒ­ç‚¹æ•°æ®è®¿é—®åŠ é€Ÿ` |
| **ğŸ”’ åˆ†å¸ƒå¼é”** | `æä½` | `å¿«` | `ä¸­` | `ä¸­` | `å¹¶å‘æ§åˆ¶ï¼Œé˜²æ­¢èµ„æºç«äº‰` |
| **ğŸ† æ’è¡Œæ¦œ** | `ä½` | `å¿«` | `é«˜` | `ä½` | `å®æ—¶æ’åæŸ¥è¯¢å’Œæ›´æ–°` |
| **â° å»¶æ—¶ä»»åŠ¡** | `ä½` | `ä¸­` | `ä¸­` | `ä¸­` | `å®šæ—¶ä¸šåŠ¡é€»è¾‘å¤„ç†` |
| **ğŸ”„ Session** | `ä¸­` | `å¿«` | `é«˜` | `ä½` | `åˆ†å¸ƒå¼ç¯å¢ƒç”¨æˆ·çŠ¶æ€ç®¡ç†` |

### 10.2 é€‰å‹å†³ç­–æŒ‡å—


**ğŸ¯ æ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹é€‰æ‹©**
```
é«˜å¹¶å‘è¯»å– + æ•°æ®æ›´æ–°ä¸é¢‘ç¹ï¼š
â†’ é€‰æ‹©ç¼“å­˜æ¨¡å¼
â†’ å…¸å‹åœºæ™¯ï¼šå•†å“è¯¦æƒ…ã€ç”¨æˆ·ä¿¡æ¯

éœ€è¦ä¸¥æ ¼äº’æ–¥æ§åˆ¶ï¼š
â†’ é€‰æ‹©åˆ†å¸ƒå¼é”
â†’ å…¸å‹åœºæ™¯ï¼šåº“å­˜æ‰£å‡ã€è®¢å•ç”Ÿæˆ

éœ€è¦å®æ—¶æ’ååŠŸèƒ½ï¼š
â†’ é€‰æ‹©æ’è¡Œæ¦œæ¨¡å¼
â†’ å…¸å‹åœºæ™¯ï¼šæ¸¸æˆç§¯åˆ†ã€é”€é‡æ’å

éœ€è¦å®šæ—¶æ‰§è¡Œä»»åŠ¡ï¼š
â†’ é€‰æ‹©å»¶æ—¶ä»»åŠ¡
â†’ å…¸å‹åœºæ™¯ï¼šè®¢å•è¶…æ—¶ã€æ¶ˆæ¯æ¨é€

å¤šæœåŠ¡å™¨ç”¨æˆ·çŠ¶æ€ï¼š
â†’ é€‰æ‹©Sessionå…±äº«
â†’ å…¸å‹åœºæ™¯ï¼šç™»å½•çŠ¶æ€ã€è´­ç‰©è½¦
```

---

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ ç¼“å­˜æ¨¡å¼ï¼šé€šè¿‡å†…å­˜å­˜å‚¨çƒ­ç‚¹æ•°æ®ï¼Œå¤§å¹…æå‡è®¿é—®é€Ÿåº¦
ğŸ”¸ åˆ†å¸ƒå¼é”ï¼šåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­å®ç°èµ„æºçš„äº’æ–¥è®¿é—®æ§åˆ¶
ğŸ”¸ æ’è¡Œæ¦œï¼šåŸºäºSorted Setå®ç°é«˜æ•ˆçš„å®æ—¶æ’ååŠŸèƒ½
ğŸ”¸ å»¶æ—¶ä»»åŠ¡ï¼šåˆ©ç”¨æ—¶é—´ä½œä¸ºè§¦å‘æ¡ä»¶çš„å¼‚æ­¥ä»»åŠ¡å¤„ç†
ğŸ”¸ Sessionå…±äº«ï¼šè§£å†³åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„ç”¨æˆ·çŠ¶æ€ç®¡ç†é—®é¢˜
```

### 11.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ Redisä¸ºä»€ä¹ˆé€‚åˆè¿™äº›åœºæ™¯**
```
é«˜æ€§èƒ½ç‰¹ç‚¹ï¼š
â€¢ å†…å­˜å­˜å‚¨ï¼šæ¯”ç£ç›˜å¿«1000å€
â€¢ å•çº¿ç¨‹ï¼šé¿å…é”ç«äº‰å¼€é”€
â€¢ åŸå­æ“ä½œï¼šå¤©ç„¶æ”¯æŒå¹¶å‘å®‰å…¨

ä¸°å¯Œæ•°æ®ç»“æ„ï¼š
â€¢ Stringï¼šé€‚åˆç¼“å­˜å’Œé”
â€¢ Hashï¼šé€‚åˆå¤æ‚å¯¹è±¡å­˜å‚¨
â€¢ Sorted Setï¼šå¤©ç„¶æ”¯æŒæ’åº
â€¢ Listï¼šæ”¯æŒé˜Ÿåˆ—æ“ä½œ

æŒä¹…åŒ–ä¿è¯ï¼š
â€¢ RDB + AOFï¼šæ•°æ®å®‰å…¨æ€§
â€¢ é›†ç¾¤æ¨¡å¼ï¼šé«˜å¯ç”¨æ€§
```

**ğŸ”¹ åº”ç”¨æ¨¡å¼çš„å…±åŒæ€è·¯**
```
é—®é¢˜è¯†åˆ«ï¼š
â€¢ æ€§èƒ½ç“¶é¢ˆåœ¨å“ªé‡Œï¼Ÿ
â€¢ å¹¶å‘æ§åˆ¶éœ€æ±‚ï¼Ÿ
â€¢ æ—¶é—´é©±åŠ¨é€»è¾‘ï¼Ÿ

æŠ€æœ¯é€‰å‹ï¼š
â€¢ é€‰æ‹©åˆé€‚çš„Redisæ•°æ®ç»“æ„
â€¢ è®¾è®¡åˆç†çš„é”®å‘½åè§„èŒƒ
â€¢ è€ƒè™‘æ•°æ®è¿‡æœŸå’Œæ¸…ç†ç­–ç•¥

å·¥ç¨‹å®è·µï¼š
â€¢ å¼‚å¸¸å¤„ç†å’Œå®¹é”™è®¾è®¡
â€¢ ç›‘æ§å’Œæ—¥å¿—è®°å½•
â€¢ æ€§èƒ½ä¼˜åŒ–å’Œè°ƒè¯•
```

### 11.3 å®é™…åº”ç”¨å»ºè®®


**âœ… æœ€ä½³å®è·µ**
```
ç¼“å­˜è®¾è®¡ï¼š
â€¢ è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´
â€¢ å¤„ç†ç¼“å­˜ç©¿é€å’Œé›ªå´©
â€¢ é¢„çƒ­çƒ­ç‚¹æ•°æ®

é”ä½¿ç”¨ï¼š
â€¢ é”ç²’åº¦è¦åˆé€‚
â€¢ é¿å…æ­»é”è®¾è®¡
â€¢ å®ç°é”ç»­æœŸæœºåˆ¶

æ’è¡Œæ¦œï¼š
â€¢ è€ƒè™‘æ•°æ®æ¸…ç†ç­–ç•¥
â€¢ æ”¯æŒå¤šç»´åº¦æ’è¡Œ
â€¢ ç¼“å­˜TOPæ¦œå•

å»¶æ—¶ä»»åŠ¡ï¼š
â€¢ ç¡®ä¿ä»»åŠ¡ä¸é‡å¤æ‰§è¡Œ
â€¢ å¤„ç†ä»»åŠ¡æ‰§è¡Œå¤±è´¥
â€¢ ç›‘æ§ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€

Sessionï¼š
â€¢ åˆç†è®¾è®¡Sessionç»“æ„
â€¢ å®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®
â€¢ è€ƒè™‘å®‰å…¨æ€§é—®é¢˜
```

**âš ï¸ å¸¸è§é™·é˜±**
```
è¿‡åº¦ä½¿ç”¨ï¼š
â€¢ ä¸æ˜¯æ‰€æœ‰åœºæ™¯éƒ½éœ€è¦Redis
â€¢ ç®€å•åœºæ™¯ä½¿ç”¨ç®€å•æ–¹æ¡ˆ

æ•°æ®ä¸€è‡´æ€§ï¼š
â€¢ ç¼“å­˜ä¸æ•°æ®åº“çš„åŒæ­¥é—®é¢˜
â€¢ åˆ†å¸ƒå¼é”çš„å¯é æ€§ä¿è¯

æ€§èƒ½ä¼˜åŒ–ï¼š
â€¢ é¿å…å¤§é”®å€¼å­˜å‚¨
â€¢ åˆç†è®¾è®¡è¿‡æœŸç­–ç•¥
â€¢ ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ
```

### 11.4 å­¦ä¹ è¿›é˜¶è·¯å¾„


**ğŸ“š å­¦ä¹ å»ºè®®**
```
åŸºç¡€é˜¶æ®µï¼š
1ï¸âƒ£ æŒæ¡RedisåŸºæœ¬æ•°æ®ç»“æ„
2ï¸âƒ£ ç†è§£å„ç§åº”ç”¨æ¨¡å¼çš„åŸç†
3ï¸âƒ£ èƒ½å¤Ÿç¼–å†™åŸºæœ¬çš„åº”ç”¨ä»£ç 

è¿›é˜¶é˜¶æ®µï¼š
4ï¸âƒ£ æ·±å…¥ç†è§£æ€§èƒ½ä¼˜åŒ–æŠ€å·§
5ï¸âƒ£ æŒæ¡é›†ç¾¤å’Œé«˜å¯ç”¨é…ç½®
6ï¸âƒ£ å­¦ä¼štroubleshootingå’Œè°ƒè¯•

å®æˆ˜é˜¶æ®µï¼š
7ï¸âƒ£ åœ¨çœŸå®é¡¹ç›®ä¸­åº”ç”¨è¿™äº›æ¨¡å¼
8ï¸âƒ£ æ ¹æ®ä¸šåŠ¡éœ€æ±‚è¿›è¡Œå®šåˆ¶åŒ–å¼€å‘
9ï¸âƒ£ æŒç»­ä¼˜åŒ–å’Œç›‘æ§ç³»ç»Ÿæ€§èƒ½
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- Redisåº”ç”¨æ¨¡å¼éƒ½æ˜¯ä¸ºäº†è§£å†³å®é™…ä¸šåŠ¡é—®é¢˜
- æ¯ç§æ¨¡å¼éƒ½æœ‰å…¶é€‚ç”¨åœºæ™¯å’ŒæŠ€æœ¯ç‰¹ç‚¹
- å·¥ç¨‹å®è·µä¸­è¦è€ƒè™‘æ€§èƒ½ã€å¯é æ€§å’Œå¯ç»´æŠ¤æ€§
- ç†è§£åŸç†æ¯”è®°å¿†å‘½ä»¤æ›´é‡è¦