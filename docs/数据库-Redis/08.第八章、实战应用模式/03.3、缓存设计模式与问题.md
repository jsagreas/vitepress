---
title: 3ã€ç¼“å­˜è®¾è®¡æ¨¡å¼ä¸é—®é¢˜
---
## ğŸ“š ç›®å½•

1. [ç¼“å­˜åŸºç¡€æ¦‚å¿µ](#1-ç¼“å­˜åŸºç¡€æ¦‚å¿µ)
2. [ç¼“å­˜è®¾è®¡æ¨¡å¼](#2-ç¼“å­˜è®¾è®¡æ¨¡å¼)
3. [ç¼“å­˜ä¸€è‡´æ€§ç­–ç•¥](#3-ç¼“å­˜ä¸€è‡´æ€§ç­–ç•¥)
4. [ç¼“å­˜ä¸‰å¤§é—®é¢˜](#4-ç¼“å­˜ä¸‰å¤§é—®é¢˜)
5. [çƒ­ç‚¹æ•°æ®å¤„ç†](#5-çƒ­ç‚¹æ•°æ®å¤„ç†)
6. [ç¼“å­˜å®æˆ˜åº”ç”¨](#6-ç¼“å­˜å®æˆ˜åº”ç”¨)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ’¾ ç¼“å­˜åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯ç¼“å­˜


**ğŸ”¸ ç¼“å­˜çš„æœ¬è´¨**
```
ç®€å•ç†è§£ï¼šç¼“å­˜å°±åƒ"ä»“åº“çš„å¿«é€’ç«™ç‚¹"
- ä»“åº“ = æ•°æ®åº“ï¼ˆå­˜å‚¨æ‰€æœ‰å•†å“ï¼Œä½†è·ç¦»è¿œã€å–è´§æ…¢ï¼‰
- å¿«é€’ç«™ç‚¹ = ç¼“å­˜ï¼ˆå­˜å‚¨çƒ­é—¨å•†å“ï¼Œè·ç¦»è¿‘ã€å–è´§å¿«ï¼‰
- é¡¾å®¢ = åº”ç”¨ç¨‹åºï¼ˆéœ€è¦å¿«é€Ÿè·å–å•†å“æ•°æ®ï¼‰
```

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦ç¼“å­˜**
> æ•°æ®åº“æŸ¥è¯¢ä¸ºä»€ä¹ˆæ…¢ï¼Ÿ
> - **ç£ç›˜IOæ…¢**ï¼šæ•°æ®å­˜åœ¨ç¡¬ç›˜ä¸Šï¼Œè¯»å–éœ€è¦æœºæ¢°æ“ä½œ
> - **ç½‘ç»œå»¶è¿Ÿ**ï¼šæ•°æ®åº“å¯èƒ½åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Š
> - **å¤æ‚æŸ¥è¯¢**ï¼šå…³è”æŸ¥è¯¢ã€è®¡ç®—æ“ä½œæ¶ˆè€—CPU
> - **å¹¶å‘ç«äº‰**ï¼šå¤§é‡è¯·æ±‚åŒæ—¶è®¿é—®æ•°æ®åº“

**ğŸš€ Redisåšç¼“å­˜çš„ä¼˜åŠ¿**
```
é€Ÿåº¦ä¼˜åŠ¿ï¼š
â€¢ å†…å­˜å­˜å‚¨ï¼šæ•°æ®åœ¨RAMä¸­ï¼Œè®¿é—®é€Ÿåº¦æ˜¯ç£ç›˜çš„1000å€ä»¥ä¸Š
â€¢ ç®€å•ç»“æ„ï¼škey-valueç»“æ„ï¼ŒæŸ¥æ‰¾æ—¶é—´O(1)
â€¢ ç½‘ç»œä¼˜åŒ–ï¼šé«˜æ•ˆçš„é€šä¿¡åè®®

åŠŸèƒ½ä¼˜åŠ¿ï¼š
â€¢ ä¸°å¯Œæ•°æ®ç±»å‹ï¼šStringã€Hashã€Listã€Setã€ZSet
â€¢ è¿‡æœŸæœºåˆ¶ï¼šè‡ªåŠ¨æ¸…ç†è¿‡æœŸæ•°æ®
â€¢ æŒä¹…åŒ–ï¼šæ•°æ®å¯æŒä¹…åŒ–åˆ°ç£ç›˜
â€¢ é›†ç¾¤æ”¯æŒï¼šæ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²
```

### 1.2 ç¼“å­˜ä½¿ç”¨çš„åŸºæœ¬æµç¨‹


**ğŸ“Š ç¼“å­˜å·¥ä½œæµç¨‹**
```
ç”¨æˆ·è¯·æ±‚ â†’ åº”ç”¨ç¨‹åº â†’ ç¼“å­˜æ£€æŸ¥ â†’ æ•°æ®åº“æŸ¥è¯¢ â†’ å†™å…¥ç¼“å­˜ â†’ è¿”å›ç»“æœ

è¯¦ç»†æ­¥éª¤ï¼š
â‘  åº”ç”¨æ”¶åˆ°æŸ¥è¯¢è¯·æ±‚
â‘¡ å…ˆå»Redisç¼“å­˜ä¸­æŸ¥æ‰¾æ•°æ®
â‘¢ å¦‚æœç¼“å­˜æœ‰æ•°æ®ï¼ˆç¼“å­˜å‘½ä¸­ï¼‰â†’ ç›´æ¥è¿”å›
â‘£ å¦‚æœç¼“å­˜æ²¡æ•°æ®ï¼ˆç¼“å­˜æœªå‘½ä¸­ï¼‰â†’ æŸ¥è¯¢æ•°æ®åº“
â‘¤ æ•°æ®åº“è¿”å›ç»“æœ â†’ å†™å…¥Redisç¼“å­˜
â‘¥ è¿”å›ç»“æœç»™ç”¨æˆ·
```

**ğŸ¯ ç¼“å­˜å‘½ä¸­ç‡**
```
è®¡ç®—å…¬å¼ï¼šç¼“å­˜å‘½ä¸­ç‡ = ç¼“å­˜å‘½ä¸­æ¬¡æ•° / æ€»æŸ¥è¯¢æ¬¡æ•°

ç¤ºä¾‹ï¼š
æ€»æŸ¥è¯¢ï¼š1000æ¬¡
ç¼“å­˜å‘½ä¸­ï¼š800æ¬¡
ç¼“å­˜å‘½ä¸­ç‡ = 800/1000 = 80%

å‘½ä¸­ç‡å½±å“ï¼š
â€¢ 90%ä»¥ä¸Šï¼šä¼˜ç§€ï¼Œå¤§éƒ¨åˆ†è¯·æ±‚ç”±ç¼“å­˜å¤„ç†
â€¢ 70-90%ï¼šè‰¯å¥½ï¼Œç¼“å­˜å‘æŒ¥è¾ƒå¥½ä½œç”¨
â€¢ 50-70%ï¼šä¸€èˆ¬ï¼Œç¼“å­˜æ•ˆæœæœ‰é™
â€¢ 50%ä»¥ä¸‹ï¼šè¾ƒå·®ï¼Œéœ€è¦ä¼˜åŒ–ç¼“å­˜ç­–ç•¥
```

### 1.3 ç¼“å­˜è®¾è®¡è§„èŒƒ


**ğŸ”‘ ç¼“å­˜é”®å‘½åè§„èŒƒ**
```
æ¨èæ ¼å¼ï¼šä¸šåŠ¡æ¨¡å—:æ•°æ®ç±»å‹:å”¯ä¸€æ ‡è¯†

å¥½çš„å‘½åç¤ºä¾‹ï¼š
user:info:12345        // ç”¨æˆ·ä¿¡æ¯ï¼ŒIDä¸º12345
product:detail:67890   // å•†å“è¯¦æƒ…ï¼ŒIDä¸º67890
order:list:user:999    // ç”¨æˆ·999çš„è®¢å•åˆ—è¡¨
session:token:abc123   // ä¼šè¯token

é¿å…çš„å‘½åï¼š
user12345             // ä¸æ¸…æ¥šæ˜¯ä»€ä¹ˆæ•°æ®
data_67890            // å¤ªæ¨¡ç³Š
u:i:12345            // è¿‡äºç®€åŒ–ï¼Œä¸æ˜“ç†è§£
```

**â° ç¼“å­˜è¿‡æœŸæ—¶é—´è®¾ç½®**
```
è®¾ç½®åŸåˆ™ï¼š

çƒ­ç‚¹æ•°æ®ï¼š30åˆ†é’Ÿ - 2å°æ—¶
â€¢ ç”¨æˆ·ä¿¡æ¯ã€å•†å“è¯¦æƒ…
â€¢ è®¿é—®é¢‘ç‡é«˜ï¼Œå…è®¸ç¨é•¿è¿‡æœŸæ—¶é—´

ä¸€èˆ¬æ•°æ®ï¼š5åˆ†é’Ÿ - 30åˆ†é’Ÿ  
â€¢ æ–‡ç« å†…å®¹ã€é…ç½®ä¿¡æ¯
â€¢ å¹³è¡¡æ•°æ®æ–°é²œåº¦å’Œæ€§èƒ½

å®æ—¶æ•°æ®ï¼š30ç§’ - 5åˆ†é’Ÿ
â€¢ åº“å­˜ä¿¡æ¯ã€ä»·æ ¼ä¿¡æ¯
â€¢ å¯¹æ•°æ®æ–°é²œåº¦è¦æ±‚é«˜

ä¸´æ—¶æ•°æ®ï¼š5åˆ†é’Ÿ - 1å°æ—¶
â€¢ éªŒè¯ç ã€ä¸´æ—¶token
â€¢ æœ‰æ˜ç¡®çš„ä¸šåŠ¡æœ‰æ•ˆæœŸ
```

**ğŸ“‹ ç¼“å­˜æ•°æ®æ ¼å¼é€‰æ‹©**
```
Stringæ ¼å¼ï¼šç®€å•çš„å€¼
â€¢ ç”¨æˆ·IDã€è®¡æ•°å™¨ã€å¼€å…³çŠ¶æ€
â€¢ set user:login:12345 "true"

Hashæ ¼å¼ï¼šå¯¹è±¡æ•°æ®  
â€¢ ç”¨æˆ·ä¿¡æ¯ã€å•†å“ä¿¡æ¯
â€¢ hmset user:12345 name "å¼ ä¸‰" age 25 email "test@qq.com"

Listæ ¼å¼ï¼šæœ‰åºåˆ—è¡¨
â€¢ æœ€æ–°æ–‡ç« ã€æ¶ˆæ¯é˜Ÿåˆ—
â€¢ lpush latest:news "æ–°é—»1" "æ–°é—»2"

Setæ ¼å¼ï¼šå»é‡é›†åˆ
â€¢ æ ‡ç­¾ã€å…³æ³¨åˆ—è¡¨
â€¢ sadd user:12345:tags "æŠ€æœ¯" "é˜…è¯»"

ZSetæ ¼å¼ï¼šå¸¦åˆ†æ•°çš„æœ‰åºé›†åˆ
â€¢ æ’è¡Œæ¦œã€çƒ­åº¦æ’åº
â€¢ zadd hotrank 100 "æ–‡ç« 1" 95 "æ–‡ç« 2"
```

---

## 2. ğŸ”„ ç¼“å­˜è®¾è®¡æ¨¡å¼


### 2.1 Cache-Asideï¼ˆæ—è·¯ç¼“å­˜ï¼‰


**ğŸ”¸ ä»€ä¹ˆæ˜¯Cache-Aside**
```
æœ€å¸¸ç”¨çš„ç¼“å­˜æ¨¡å¼ï¼Œåº”ç”¨ç¨‹åºç›´æ¥ç®¡ç†ç¼“å­˜
ç®€å•ç†è§£ï¼šåº”ç”¨ç¨‹åºæ—¢è¦ç®¡æ•°æ®åº“ï¼Œåˆè¦ç®¡ç¼“å­˜

å·¥ä½œæµç¨‹ï¼š
è¯»å–æ•°æ®æ—¶ï¼šå…ˆæŸ¥ç¼“å­˜ â†’ ç¼“å­˜æ²¡æœ‰ â†’ æŸ¥æ•°æ®åº“ â†’ å†™ç¼“å­˜
æ›´æ–°æ•°æ®æ—¶ï¼šå…ˆåˆ ç¼“å­˜ â†’ æ›´æ–°æ•°æ®åº“ â†’ ï¼ˆå¯é€‰ï¼‰é¢„çƒ­ç¼“å­˜
```

**ğŸ’» ä»£ç ç¤ºä¾‹**
```java
// Cache-Asideè¯»å–æ¨¡å¼
public User getUserById(Long userId) {
    String cacheKey = "user:info:" + userId;
    
    // â‘  å…ˆæŸ¥ç¼“å­˜
    String userJson = redisTemplate.opsForValue().get(cacheKey);
    if (userJson != null) {
        return JSON.parseObject(userJson, User.class);
    }
    
    // â‘¡ ç¼“å­˜æ²¡æœ‰ï¼ŒæŸ¥æ•°æ®åº“
    User user = userMapper.selectById(userId);
    if (user != null) {
        // â‘¢ å†™å…¥ç¼“å­˜ï¼Œè®¾ç½®30åˆ†é’Ÿè¿‡æœŸ
        redisTemplate.opsForValue().set(cacheKey, JSON.toJSONString(user), 30, TimeUnit.MINUTES);
    }
    
    return user;
}

// Cache-Asideæ›´æ–°æ¨¡å¼
public void updateUser(User user) {
    String cacheKey = "user:info:" + user.getId();
    
    // â‘  å…ˆåˆ é™¤ç¼“å­˜
    redisTemplate.delete(cacheKey);
    
    // â‘¡ æ›´æ–°æ•°æ®åº“
    userMapper.updateById(user);
    
    // â‘¢ å¯é€‰ï¼šé¢„çƒ­ç¼“å­˜
    // redisTemplate.opsForValue().set(cacheKey, JSON.toJSONString(user), 30, TimeUnit.MINUTES);
}
```

**âœ… Cache-Asideä¼˜ç¼ºç‚¹**
```
ä¼˜ç‚¹ï¼š
â€¢ ç®€å•æ˜“æ‡‚ï¼šé€»è¾‘æ¸…æ™°ï¼Œå®¹æ˜“å®ç°
â€¢ çµæ´»æ§åˆ¶ï¼šåº”ç”¨ç¨‹åºå®Œå…¨æ§åˆ¶ç¼“å­˜é€»è¾‘
â€¢ é€‚åº”æ€§å¼ºï¼šå¯ä»¥é’ˆå¯¹ä¸åŒæ•°æ®é‡‡ç”¨ä¸åŒç­–ç•¥

ç¼ºç‚¹ï¼š
â€¢ ä»£ç ä¾µå…¥ï¼šä¸šåŠ¡ä»£ç ä¸­éœ€è¦å¤„ç†ç¼“å­˜é€»è¾‘
â€¢ ä¸€è‡´æ€§é£é™©ï¼šåˆ ç¼“å­˜å’Œæ›´æ–°æ•°æ®åº“ä¹‹é—´å¯èƒ½ä¸ä¸€è‡´
â€¢ é‡å¤ä»£ç ï¼šæ¯ä¸ªæ•°æ®æ“ä½œéƒ½è¦å†™ç±»ä¼¼çš„ç¼“å­˜ä»£ç 
```

### 2.2 Read-Throughï¼ˆè¯»ç©¿é€ï¼‰


**ğŸ”¸ ä»€ä¹ˆæ˜¯Read-Through**
```
ç¼“å­˜å±‚ç›´æ¥è´Ÿè´£æ•°æ®åŠ è½½ï¼Œå¯¹åº”ç”¨ç¨‹åºé€æ˜
ç®€å•ç†è§£ï¼šåº”ç”¨åªç®¡é—®ç¼“å­˜è¦æ•°æ®ï¼Œç¼“å­˜è‡ªå·±å»æ•°æ®åº“å–

å·¥ä½œåŸç†ï¼š
åº”ç”¨è¯·æ±‚æ•°æ® â†’ ç¼“å­˜ä¸­é—´ä»¶æ£€æŸ¥ â†’ å¦‚æœæ²¡æœ‰è‡ªåŠ¨ä»æ•°æ®åº“åŠ è½½ â†’ è¿”å›ç»™åº”ç”¨
```

**ğŸ“Š Read-Throughæµç¨‹å›¾**
```
åº”ç”¨ç¨‹åº                ç¼“å­˜ä¸­é—´ä»¶              æ•°æ®åº“
    |                       |                    |
    |----æŸ¥è¯¢æ•°æ®----------->|                    |
    |                       |--æ£€æŸ¥ç¼“å­˜--------->|å†…å­˜
    |                       |<-ç¼“å­˜æœªå‘½ä¸­--------|
    |                       |                    |
    |                       |--è‡ªåŠ¨æŸ¥è¯¢--------->|ç£ç›˜
    |                       |<--è¿”å›æ•°æ®---------|
    |                       |--å†™å…¥ç¼“å­˜--------->|
    |<---è¿”å›æ•°æ®------------|                    |
```

**ğŸ’» å®ç°ç¤ºä¾‹**
```java
// Read-Throughéœ€è¦ç¼“å­˜ä¸­é—´ä»¶æ”¯æŒï¼Œæ¯”å¦‚ä½¿ç”¨Spring Cache
@Service
public class UserService {
    
    @Cacheable(value = "users", key = "#userId")
    public User getUserById(Long userId) {
        // è¿™é‡Œåªå†™æ•°æ®åº“æŸ¥è¯¢é€»è¾‘
        // ç¼“å­˜çš„æŸ¥æ‰¾ã€åŠ è½½ã€å­˜å‚¨éƒ½ç”±æ¡†æ¶è‡ªåŠ¨å¤„ç†
        return userMapper.selectById(userId);
    }
}

é…ç½®è¯´æ˜ï¼š
â€¢ @Cacheableï¼šè‡ªåŠ¨æ£€æŸ¥ç¼“å­˜ï¼Œç¼ºå¤±æ—¶æ‰§è¡Œæ–¹æ³•å¹¶ç¼“å­˜ç»“æœ
â€¢ value = "users"ï¼šç¼“å­˜åç§°ç©ºé—´
â€¢ key = "#userId"ï¼šç¼“å­˜keyçš„ç”Ÿæˆè§„åˆ™
```

**âœ… Read-Throughä¼˜ç¼ºç‚¹**
```
ä¼˜ç‚¹ï¼š
â€¢ ä»£ç ç®€æ´ï¼šä¸šåŠ¡ä»£ç ä¸éœ€è¦å¤„ç†ç¼“å­˜é€»è¾‘
â€¢ é€æ˜æ€§ï¼šå¯¹åº”ç”¨ç¨‹åºå®Œå…¨é€æ˜
â€¢ ä¸€è‡´æ€§ï¼šç¼“å­˜é€»è¾‘ç»Ÿä¸€å¤„ç†

ç¼ºç‚¹ï¼š
â€¢ ä¾èµ–æ¡†æ¶ï¼šéœ€è¦æ”¯æŒRead-Throughçš„ç¼“å­˜æ¡†æ¶
â€¢ çµæ´»æ€§å·®ï¼šç¼“å­˜ç­–ç•¥ä¸å¤Ÿçµæ´»
â€¢ è°ƒè¯•å›°éš¾ï¼šç¼“å­˜é€»è¾‘å¯¹å¼€å‘è€…ä¸é€æ˜
```

### 2.3 Write-Throughï¼ˆå†™ç©¿é€ï¼‰


**ğŸ”¸ ä»€ä¹ˆæ˜¯Write-Through**
```
å†™æ•°æ®æ—¶åŒæ—¶æ›´æ–°ç¼“å­˜å’Œæ•°æ®åº“ï¼Œä¿è¯æ•°æ®åŒæ­¥
ç®€å•ç†è§£ï¼šå†™æ•°æ®æ—¶ï¼Œç¼“å­˜å’Œæ•°æ®åº“åŒæ—¶æ›´æ–°ï¼Œç¡®ä¿ä¸€è‡´

ç‰¹ç‚¹ï¼š
â€¢ åŒæ­¥å†™å…¥ï¼šç¼“å­˜å’Œæ•°æ®åº“åŒæ—¶æ›´æ–°
â€¢ å¼ºä¸€è‡´æ€§ï¼šæ•°æ®åœ¨ç¼“å­˜å’Œæ•°æ®åº“ä¸­å§‹ç»ˆä¸€è‡´
â€¢ å†™å…¥å»¶è¿Ÿï¼šå› ä¸ºè¦åŒæ—¶å†™ä¸¤ä¸ªåœ°æ–¹ï¼Œå†™å…¥é€Ÿåº¦è¾ƒæ…¢
```

**ğŸ“Š Write-Throughæµç¨‹å›¾**
```
åº”ç”¨ç¨‹åº              ç¼“å­˜ä¸­é—´ä»¶              æ•°æ®åº“
    |                     |                    |
    |----æ›´æ–°æ•°æ®-------->|                    |
    |                     |--æ›´æ–°ç¼“å­˜--------->|å†…å­˜
    |                     |--æ›´æ–°æ•°æ®åº“------->|ç£ç›˜
    |                     |<--ç¡®è®¤å†™å…¥---------|
    |<---æ›´æ–°å®Œæˆ---------|                    |
```

**ğŸ’» å®ç°ç¤ºä¾‹**
```java
@Service
public class UserService {
    
    // Write-Throughæ›´æ–°æ¨¡å¼
    @CachePut(value = "users", key = "#user.id")
    public User updateUser(User user) {
        // â‘  æ›´æ–°æ•°æ®åº“
        userMapper.updateById(user);
        
        // â‘¡ æ¡†æ¶è‡ªåŠ¨æ›´æ–°ç¼“å­˜ï¼ˆ@CachePutçš„ä½œç”¨ï¼‰
        // è¿”å›çš„å¯¹è±¡ä¼šè¢«æ”¾å…¥ç¼“å­˜
        return user;
    }
    
    // æ‰‹åŠ¨å®ç°Write-Through
    public void updateUserManual(User user) {
        String cacheKey = "user:info:" + user.getId();
        
        try {
            // åŒæ—¶æ›´æ–°ç¼“å­˜å’Œæ•°æ®åº“
            userMapper.updateById(user);
            redisTemplate.opsForValue().set(cacheKey, JSON.toJSONString(user), 30, TimeUnit.MINUTES);
        } catch (Exception e) {
            // å¦‚æœä»»ä½•ä¸€ä¸ªæ“ä½œå¤±è´¥ï¼Œéœ€è¦å›æ»š
            throw new RuntimeException("æ›´æ–°å¤±è´¥", e);
        }
    }
}
```

### 2.4 Write-Backï¼ˆå†™å›ï¼‰


**ğŸ”¸ ä»€ä¹ˆæ˜¯Write-Back**
```
ä¹Ÿå«Write-Behindï¼Œæ•°æ®å…ˆå†™å…¥ç¼“å­˜ï¼Œå¼‚æ­¥æ‰¹é‡å†™å…¥æ•°æ®åº“
ç®€å•ç†è§£ï¼šå…ˆè®°åœ¨"å°æœ¬å­"ä¸Šï¼Œå®šæœŸæ•´ç†åˆ°"å¤§è´¦æœ¬"é‡Œ

å·¥ä½œæœºåˆ¶ï¼š
â€¢ å†™å…¥æ—¶ï¼šåªæ›´æ–°ç¼“å­˜ï¼Œæ ‡è®°ä¸º"è„æ•°æ®"
â€¢ å¼‚æ­¥å†™å›ï¼šå®šæœŸæˆ–è¾¾åˆ°æ¡ä»¶æ—¶æ‰¹é‡å†™å…¥æ•°æ®åº“
â€¢ æ€§èƒ½ä¼˜åŠ¿ï¼šå†™å…¥é€Ÿåº¦å¿«ï¼Œå¯ä»¥æ‰¹é‡æ“ä½œ
```

**ğŸ“ˆ Write-Backæ—¶åºå›¾**
```
æ—¶é—´è½´ï¼š  0s    1s    2s    3s    4s    5s    â†å¼‚æ­¥å†™å›
åº”ç”¨å†™å…¥ï¼š W1    W2    W3    W4    W5    
ç¼“å­˜çŠ¶æ€ï¼š [W1]  [W1,W2] [W1,W2,W3] [W1,W2,W3,W4] [W1,W2,W3,W4,W5]
æ•°æ®åº“ï¼š   []    []     []      []     []     [W1,W2,W3,W4,W5]
```

**ğŸ’» Write-Backå®ç°æ€è·¯**
```java
// Write-Backéœ€è¦ä¸“é—¨çš„å®ç°ï¼Œè¿™é‡Œæ˜¯ç®€åŒ–ç¤ºä¾‹
public class WriteBackCache {
    private Map<String, Object> cache = new ConcurrentHashMap<>();
    private Set<String> dirtyKeys = ConcurrentHashMap.newKeySet();
    
    // å†™å…¥ç¼“å­˜ï¼Œæ ‡è®°ä¸ºè„æ•°æ®
    public void put(String key, Object value) {
        cache.put(key, value);
        dirtyKeys.add(key);  // æ ‡è®°ä¸ºéœ€è¦å†™å›æ•°æ®åº“
    }
    
    // å¼‚æ­¥å†™å›åˆ°æ•°æ®åº“
    @Scheduled(fixedDelay = 5000)  // æ¯5ç§’æ‰§è¡Œä¸€æ¬¡
    public void writeBack() {
        for (String key : dirtyKeys) {
            Object value = cache.get(key);
            // æ‰¹é‡å†™å…¥æ•°æ®åº“
            writeToDatabase(key, value);
        }
        dirtyKeys.clear();
    }
}
```

### 2.5 å››ç§æ¨¡å¼å¯¹æ¯”


| æ¨¡å¼ | **å†™å…¥ä½ç½®** | **ä¸€è‡´æ€§** | **æ€§èƒ½** | **å¤æ‚åº¦** | **é€‚ç”¨åœºæ™¯** |
|------|------------|-----------|---------|----------|------------|
| **Cache-Aside** | `åº”ç”¨ç®¡ç†` | **æœ€ç»ˆä¸€è‡´** | `è¯»å¿«å†™æ…¢` | `ä¸­ç­‰` | `é€šç”¨åœºæ™¯` |
| **Read-Through** | `ç¼“å­˜ç®¡ç†` | **æœ€ç»ˆä¸€è‡´** | `è¯»ä¸­ç­‰` | `ä½` | `è¯»å¤šå†™å°‘` |
| **Write-Through** | `åŒæ—¶å†™å…¥` | **å¼ºä¸€è‡´** | `å†™æ…¢è¯»å¿«` | `ä½` | `ä¸€è‡´æ€§è¦æ±‚é«˜` |
| **Write-Back** | `ç¼“å­˜ä¼˜å…ˆ` | **å¼±ä¸€è‡´** | `è¯»å†™éƒ½å¿«` | `é«˜` | `é«˜æ€§èƒ½è¦æ±‚` |

---

## 3. ğŸ”„ ç¼“å­˜ä¸€è‡´æ€§ç­–ç•¥


### 3.1 ç¼“å­˜ä¸æ•°æ®åº“åŒå†™ä¸€è‡´æ€§é—®é¢˜


**ğŸš¨ ä¸€è‡´æ€§é—®é¢˜çš„æœ¬è´¨**
```
é—®é¢˜æè¿°ï¼š
ç¼“å­˜ä¸­çš„æ•°æ®å’Œæ•°æ®åº“ä¸­çš„æ•°æ®ä¸ä¸€è‡´

äº§ç”ŸåŸå› ï¼š
â€¢ æ›´æ–°æ“ä½œä¸æ˜¯åŸå­æ€§çš„ï¼šåˆ ç¼“å­˜å’Œæ›´æ–°æ•°æ®åº“æ˜¯ä¸¤ä¸ªç‹¬ç«‹æ“ä½œ
â€¢ å¹¶å‘è®¿é—®ï¼šå¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å†™å¯èƒ½å¯¼è‡´ç«æ€æ¡ä»¶
â€¢ ç½‘ç»œå¼‚å¸¸ï¼šæ“ä½œæ‰§è¡Œä¸€åŠæ—¶ç½‘ç»œä¸­æ–­
â€¢ ç³»ç»Ÿæ•…éšœï¼šæŸä¸ªæ“ä½œæˆåŠŸï¼Œå¦ä¸€ä¸ªæ“ä½œå¤±è´¥
```

**ğŸ’­ ç»å…¸é—®é¢˜åœºæ™¯**
```
åœºæ™¯1ï¼šå…ˆåˆ ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“
æ—¶é—´çº¿ï¼š
T1: çº¿ç¨‹Aåˆ é™¤ç¼“å­˜
T2: çº¿ç¨‹BæŸ¥è¯¢ï¼Œç¼“å­˜missï¼Œä»æ•°æ®åº“è¯»å–æ—§æ•°æ®
T3: çº¿ç¨‹Bå°†æ—§æ•°æ®å†™å…¥ç¼“å­˜
T4: çº¿ç¨‹Aæ›´æ–°æ•°æ®åº“ä¸ºæ–°æ•°æ®
ç»“æœï¼šç¼“å­˜æ˜¯æ—§æ•°æ®ï¼Œæ•°æ®åº“æ˜¯æ–°æ•°æ® âŒ

åœºæ™¯2ï¼šå…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ ç¼“å­˜
æ—¶é—´çº¿ï¼š
T1: çº¿ç¨‹Aæ›´æ–°æ•°æ®åº“
T2: çº¿ç¨‹BæŸ¥è¯¢ç¼“å­˜ï¼Œå¾—åˆ°æ—§æ•°æ®
T3: çº¿ç¨‹Aåˆ é™¤ç¼“å­˜
ç»“æœï¼šç”¨æˆ·Bçœ‹åˆ°äº†æ—§æ•°æ®ï¼Œä½†ä¸ä¼šæŒä¹…åŒ– âš ï¸
```

### 3.2 å¼ºä¸€è‡´æ€§æ–¹æ¡ˆ


**ğŸ”’ åˆ†å¸ƒå¼é”æ–¹æ¡ˆ**
```java
public User updateUserWithLock(User user) {
    String lockKey = "lock:user:" + user.getId();
    String lockValue = UUID.randomUUID().toString();
    
    try {
        // â‘  è·å–åˆ†å¸ƒå¼é”
        if (redisTemplate.opsForValue().setIfAbsent(lockKey, lockValue, 10, TimeUnit.SECONDS)) {
            
            // â‘¡ åˆ é™¤ç¼“å­˜
            redisTemplate.delete("user:info:" + user.getId());
            
            // â‘¢ æ›´æ–°æ•°æ®åº“
            userMapper.updateById(user);
            
            return user;
        } else {
            throw new RuntimeException("è·å–é”å¤±è´¥");
        }
    } finally {
        // â‘£ é‡Šæ”¾é”
        String currentValue = redisTemplate.opsForValue().get(lockKey);
        if (lockValue.equals(currentValue)) {
            redisTemplate.delete(lockKey);
        }
    }
}
```

**ğŸ¯ ä¸¤é˜¶æ®µæäº¤æ–¹æ¡ˆ**
```
åŸç†ï¼šå°†ç¼“å­˜å’Œæ•°æ®åº“çš„æ›´æ–°çœ‹ä½œåˆ†å¸ƒå¼äº‹åŠ¡

æ­¥éª¤ï¼š
â‘  å‡†å¤‡é˜¶æ®µï¼šå‘ç¼“å­˜å’Œæ•°æ®åº“å‘é€prepareè¯·æ±‚
â‘¡ æäº¤é˜¶æ®µï¼šå¦‚æœéƒ½å‡†å¤‡æˆåŠŸï¼Œå‘é€commitè¯·æ±‚
â‘¢ å›æ»šé˜¶æ®µï¼šå¦‚æœä»»ä½•ä¸€ä¸ªprepareå¤±è´¥ï¼Œå‘é€rollbackè¯·æ±‚

å®é™…åº”ç”¨ï¼š
â€¢ ä½¿ç”¨åˆ†å¸ƒå¼äº‹åŠ¡æ¡†æ¶ï¼ˆå¦‚Seataï¼‰
â€¢ æˆæœ¬è¾ƒé«˜ï¼Œé€šå¸¸ç”¨äºæ ¸å¿ƒä¸šåŠ¡
```

### 3.3 æœ€ç»ˆä¸€è‡´æ€§æ–¹æ¡ˆ


**â° å»¶æ—¶åŒåˆ ç­–ç•¥**
```java
public void updateUserWithDelayedDelete(User user) {
    String cacheKey = "user:info:" + user.getId();
    
    // â‘  ç¬¬ä¸€æ¬¡åˆ é™¤ç¼“å­˜
    redisTemplate.delete(cacheKey);
    
    // â‘¡ æ›´æ–°æ•°æ®åº“
    userMapper.updateById(user);
    
    // â‘¢ å»¶æ—¶åå†æ¬¡åˆ é™¤ç¼“å­˜
    CompletableFuture.runAsync(() -> {
        try {
            Thread.sleep(1000);  // å»¶æ—¶1ç§’
            redisTemplate.delete(cacheKey);
        } catch (Exception e) {
            log.error("å»¶æ—¶åˆ é™¤ç¼“å­˜å¤±è´¥", e);
        }
    });
}
```

**ğŸ”„ ä¸ºä»€ä¹ˆè¦å»¶æ—¶åŒåˆ **
```
è§£å†³é—®é¢˜ï¼š
ç¬¬ä¸€æ¬¡åˆ é™¤åï¼Œå¦‚æœæœ‰å¹¶å‘è¯»å–ï¼Œå¯èƒ½å°†æ—§æ•°æ®é‡æ–°å†™å…¥ç¼“å­˜
å»¶æ—¶åˆ é™¤å¯ä»¥æ¸…é™¤è¿™äº›"è„æ•°æ®"

å»¶æ—¶æ—¶é—´è®¾ç½®ï¼š
â€¢ ä¸€èˆ¬è®¾ç½®ä¸º1-5ç§’
â€¢ è¦å¤§äºæ•°æ®åº“ä¸»ä»åŒæ­¥æ—¶é—´
â€¢ è¦å¤§äºä¸šåŠ¡ä»£ç æ‰§è¡Œæ—¶é—´
```

**ğŸ“¡ å¼‚æ­¥æ›´æ–°æœºåˆ¶**
```java
// åŸºäºæ¶ˆæ¯é˜Ÿåˆ—çš„å¼‚æ­¥æ›´æ–°
@EventListener
public void handleUserUpdateEvent(UserUpdateEvent event) {
    // å¼‚æ­¥å¤„ç†ç¼“å­˜æ›´æ–°
    CompletableFuture.runAsync(() -> {
        String cacheKey = "user:info:" + event.getUserId();
        
        // ä»æ•°æ®åº“é‡æ–°åŠ è½½æœ€æ–°æ•°æ®
        User latestUser = userMapper.selectById(event.getUserId());
        
        if (latestUser != null) {
            // æ›´æ–°ç¼“å­˜
            redisTemplate.opsForValue().set(cacheKey, 
                JSON.toJSONString(latestUser), 30, TimeUnit.MINUTES);
        } else {
            // ç”¨æˆ·è¢«åˆ é™¤ï¼Œåˆ é™¤ç¼“å­˜
            redisTemplate.delete(cacheKey);
        }
    });
}

// å‘å¸ƒæ›´æ–°äº‹ä»¶
public void updateUser(User user) {
    userMapper.updateById(user);
    // å‘å¸ƒå¼‚æ­¥æ›´æ–°äº‹ä»¶
    applicationEventPublisher.publishEvent(new UserUpdateEvent(user.getId()));
}
```

---

## 4. ğŸ’¥ ç¼“å­˜ä¸‰å¤§é—®é¢˜


### 4.1 ç¼“å­˜ç©¿é€


**ğŸš¨ é—®é¢˜æè¿°**
```
ç¼“å­˜ç©¿é€ï¼šæŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®ï¼Œå¯¼è‡´æ¯æ¬¡éƒ½è¦æŸ¥æ•°æ®åº“

å…¸å‹åœºæ™¯ï¼š
â€¢ æ¶æ„ç”¨æˆ·æ•…æ„æŸ¥è¯¢ä¸å­˜åœ¨çš„ç”¨æˆ·ID
â€¢ å‰ç«¯ä¼ é”™å‚æ•°ï¼ŒæŸ¥è¯¢äº†ä¸å­˜åœ¨çš„å•†å“
â€¢ çˆ¬è™«ç¨‹åºéšæœºç”ŸæˆIDè¿›è¡ŒæŸ¥è¯¢

å±å®³ï¼š
â€¢ ç¼“å­˜å®Œå…¨å¤±æ•ˆï¼Œæ‰€æœ‰è¯·æ±‚éƒ½æ‰“åˆ°æ•°æ®åº“
â€¢ æ•°æ®åº“å‹åŠ›æ¿€å¢ï¼Œå¯èƒ½å¯¼è‡´æœåŠ¡å´©æºƒ
â€¢ ç³»ç»Ÿå“åº”å˜æ…¢ï¼Œç”¨æˆ·ä½“éªŒä¸‹é™
```

**ğŸŒ¸ è§£å†³æ–¹æ¡ˆ1ï¼šå¸ƒéš†è¿‡æ»¤å™¨**
```java
@Component
public class BloomFilterService {
    private BloomFilter<String> bloomFilter;
    
    @PostConstruct
    public void init() {
        // åˆ›å»ºå¸ƒéš†è¿‡æ»¤å™¨ï¼Œé¢„æœŸ100ä¸‡ä¸ªå…ƒç´ ï¼Œè¯¯åˆ¤ç‡1%
        bloomFilter = BloomFilter.create(Funnels.stringFunnel(Charset.defaultCharset()), 
            1000000, 0.01);
        
        // å°†æ‰€æœ‰å­˜åœ¨çš„ç”¨æˆ·IDåŠ å…¥å¸ƒéš†è¿‡æ»¤å™¨
        List<Long> userIds = userMapper.selectAllIds();
        for (Long id : userIds) {
            bloomFilter.put(String.valueOf(id));
        }
    }
    
    public boolean mightExist(String userId) {
        return bloomFilter.mightContain(userId);
    }
}

// æŸ¥è¯¢æ—¶å…ˆè¿‡å¸ƒéš†è¿‡æ»¤å™¨
public User getUserById(Long userId) {
    // â‘  å¸ƒéš†è¿‡æ»¤å™¨é¢„æ£€æŸ¥
    if (!bloomFilterService.mightExist(String.valueOf(userId))) {
        return null;  // è‚¯å®šä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›
    }
    
    // â‘¡ æ­£å¸¸çš„ç¼“å­˜æŸ¥è¯¢æµç¨‹
    String cacheKey = "user:info:" + userId;
    String userJson = redisTemplate.opsForValue().get(cacheKey);
    if (userJson != null) {
        return JSON.parseObject(userJson, User.class);
    }
    
    // â‘¢ æŸ¥è¯¢æ•°æ®åº“
    User user = userMapper.selectById(userId);
    if (user != null) {
        redisTemplate.opsForValue().set(cacheKey, JSON.toJSONString(user), 30, TimeUnit.MINUTES);
    }
    
    return user;
}
```

**ğŸ•³ï¸ è§£å†³æ–¹æ¡ˆ2ï¼šç©ºå€¼ç¼“å­˜**
```java
public User getUserByIdWithNullCache(Long userId) {
    String cacheKey = "user:info:" + userId;
    
    // â‘  æŸ¥è¯¢ç¼“å­˜
    String userJson = redisTemplate.opsForValue().get(cacheKey);
    if (userJson != null) {
        if ("null".equals(userJson)) {
            return null;  // ä¹‹å‰æŸ¥è¯¢è¿‡ï¼Œç¡®è®¤ä¸å­˜åœ¨
        }
        return JSON.parseObject(userJson, User.class);
    }
    
    // â‘¡ æŸ¥è¯¢æ•°æ®åº“
    User user = userMapper.selectById(userId);
    
    if (user != null) {
        // â‘¢ å­˜åœ¨åˆ™ç¼“å­˜å¯¹è±¡
        redisTemplate.opsForValue().set(cacheKey, JSON.toJSONString(user), 30, TimeUnit.MINUTES);
    } else {
        // â‘£ ä¸å­˜åœ¨åˆ™ç¼“å­˜ç©ºå€¼ï¼Œè¾ƒçŸ­è¿‡æœŸæ—¶é—´
        redisTemplate.opsForValue().set(cacheKey, "null", 5, TimeUnit.MINUTES);
    }
    
    return user;
}
```

**ğŸ›¡ï¸ è§£å†³æ–¹æ¡ˆ3ï¼šå‚æ•°æ ¡éªŒ**
```java
@RestController
public class UserController {
    
    @GetMapping("/user/{userId}")
    public User getUser(@PathVariable Long userId) {
        // â‘  åŸºç¡€å‚æ•°æ ¡éªŒ
        if (userId == null || userId <= 0) {
            throw new IllegalArgumentException("ç”¨æˆ·IDä¸èƒ½ä¸ºç©ºæˆ–å°äºç­‰äº0");
        }
        
        // â‘¡ èŒƒå›´æ ¡éªŒï¼ˆå‡è®¾ç”¨æˆ·IDåœ¨åˆç†èŒƒå›´å†…ï¼‰
        if (userId > 999999999L) {
            throw new IllegalArgumentException("ç”¨æˆ·IDè¶…å‡ºæœ‰æ•ˆèŒƒå›´");
        }
        
        // â‘¢ æ ¼å¼æ ¡éªŒ
        String userIdStr = String.valueOf(userId);
        if (!userIdStr.matches("\\d{1,9}")) {
            throw new IllegalArgumentException("ç”¨æˆ·IDæ ¼å¼ä¸æ­£ç¡®");
        }
        
        return userService.getUserById(userId);
    }
}
```

### 4.2 ç¼“å­˜å‡»ç©¿


**ğŸ’¥ é—®é¢˜æè¿°**
```
ç¼“å­˜å‡»ç©¿ï¼šçƒ­ç‚¹keyè¿‡æœŸçš„ç¬é—´ï¼Œå¤§é‡è¯·æ±‚ç›´æ¥æ‰“åˆ°æ•°æ®åº“

å…¸å‹åœºæ™¯ï¼š
â€¢ æ˜æ˜Ÿå¾®åšï¼šç²‰ä¸é‡å¤§ï¼ŒåŒæ—¶è®¿é—®
â€¢ å•†å“ç§’æ€ï¼šçƒ­é—¨å•†å“ï¼Œç¬é—´é«˜å¹¶å‘
â€¢ çƒ­é—¨æ–‡ç« ï¼šçªç„¶æˆä¸ºçƒ­ç‚¹ï¼Œç¼“å­˜åˆšå¥½è¿‡æœŸ

å±å®³ï¼š
â€¢ ç¬é—´æ•°æ®åº“å‹åŠ›æ¿€å¢
â€¢ å¯èƒ½å¯¼è‡´æ•°æ®åº“è¿æ¥æ± è€—å°½
â€¢ ç³»ç»Ÿå“åº”æ—¶é—´å‰§å¢
```

**ğŸ” è§£å†³æ–¹æ¡ˆ1ï¼šäº’æ–¥é”**
```java
public User getHotUserById(Long userId) {
    String cacheKey = "user:info:" + userId;
    String lockKey = "lock:user:" + userId;
    
    // â‘  æŸ¥è¯¢ç¼“å­˜
    String userJson = redisTemplate.opsForValue().get(cacheKey);
    if (userJson != null) {
        return JSON.parseObject(userJson, User.class);
    }
    
    // â‘¡ ç¼“å­˜missï¼Œå°è¯•è·å–é”
    String lockValue = UUID.randomUUID().toString();
    boolean getLock = redisTemplate.opsForValue()
        .setIfAbsent(lockKey, lockValue, 10, TimeUnit.SECONDS);
    
    if (getLock) {
        try {
            // â‘¢ è·å–é”æˆåŠŸï¼ŒæŸ¥è¯¢æ•°æ®åº“
            User user = userMapper.selectById(userId);
            if (user != null) {
                // â‘£ å†™å…¥ç¼“å­˜
                redisTemplate.opsForValue().set(cacheKey, JSON.toJSONString(user), 30, TimeUnit.MINUTES);
            }
            return user;
        } finally {
            // â‘¤ é‡Šæ”¾é”
            String currentValue = redisTemplate.opsForValue().get(lockKey);
            if (lockValue.equals(currentValue)) {
                redisTemplate.delete(lockKey);
            }
        }
    } else {
        // â‘¥ è·å–é”å¤±è´¥ï¼Œç­‰å¾…åé‡è¯•
        try {
            Thread.sleep(100);  // ç­‰å¾…100ms
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
        return getHotUserById(userId);  // é€’å½’é‡è¯•
    }
}
```

**â™¾ï¸ è§£å†³æ–¹æ¡ˆ2ï¼šæ°¸ä¸è¿‡æœŸ**
```java
public User getHotUserByIdNeverExpire(Long userId) {
    String cacheKey = "user:info:" + userId;
    
    String userJson = redisTemplate.opsForValue().get(cacheKey);
    if (userJson != null) {
        User user = JSON.parseObject(userJson, User.class);
        
        // æ£€æŸ¥é€»è¾‘è¿‡æœŸæ—¶é—´
        if (user.getCacheExpireTime().isAfter(LocalDateTime.now())) {
            return user;
        } else {
            // æ•°æ®é€»è¾‘è¿‡æœŸï¼Œå¼‚æ­¥æ›´æ–°
            CompletableFuture.runAsync(() -> refreshUserCache(userId));
            return user;  // å…ˆè¿”å›æ—§æ•°æ®
        }
    }
    
    // ç¼“å­˜çœŸçš„æ²¡æœ‰ï¼ŒåŒæ­¥åŠ è½½
    return loadUserAndCache(userId);
}

private void refreshUserCache(Long userId) {
    User latestUser = userMapper.selectById(userId);
    if (latestUser != null) {
        // è®¾ç½®é€»è¾‘è¿‡æœŸæ—¶é—´
        latestUser.setCacheExpireTime(LocalDateTime.now().plusMinutes(30));
        redisTemplate.opsForValue().set("user:info:" + userId, JSON.toJSONString(latestUser));
    }
}
```

**ğŸ”¥ è§£å†³æ–¹æ¡ˆ3ï¼šçƒ­ç‚¹é¢„çƒ­**
```java
@Component
public class HotDataPreheater {
    
    @EventListener
    public void handleHotDataDetected(HotDataEvent event) {
        String key = event.getKey();
        
        // æ£€æŸ¥æ˜¯å¦å³å°†è¿‡æœŸï¼ˆè¿˜æœ‰5åˆ†é’Ÿè¿‡æœŸï¼‰
        Long ttl = redisTemplate.getExpire(key);
        if (ttl != null && ttl < 300) {  // å°äº5åˆ†é’Ÿ
            // å¼‚æ­¥é¢„çƒ­
            CompletableFuture.runAsync(() -> {
                preloadHotData(key);
            });
        }
    }
    
    private void preloadHotData(String key) {
        // æ ¹æ®keyç±»å‹ï¼Œä»æ•°æ®åº“é‡æ–°åŠ è½½æ•°æ®
        if (key.startsWith("user:info:")) {
            Long userId = Long.valueOf(key.split(":")[2]);
            User user = userMapper.selectById(userId);
            if (user != null) {
                redisTemplate.opsForValue().set(key, JSON.toJSONString(user), 30, TimeUnit.MINUTES);
            }
        }
        // å…¶ä»–ç±»å‹çš„çƒ­ç‚¹æ•°æ®é¢„çƒ­...
    }
}
```

### 4.3 ç¼“å­˜é›ªå´©


**â„ï¸ é—®é¢˜æè¿°**
```
ç¼“å­˜é›ªå´©ï¼šå¤§é‡ç¼“å­˜åŒæ—¶è¿‡æœŸï¼Œå¯¼è‡´æ•°æ®åº“ç¬é—´å‹åŠ›æ¿€å¢

å…¸å‹åœºæ™¯ï¼š
â€¢ ç³»ç»Ÿé‡å¯ï¼šæ‰€æœ‰ç¼“å­˜å¤±æ•ˆ
â€¢ ç›¸åŒè¿‡æœŸæ—¶é—´ï¼šå¤§é‡æ•°æ®è®¾ç½®ç›¸åŒè¿‡æœŸæ—¶é—´
â€¢ ç¼“å­˜æœåŠ¡æ•…éšœï¼šRediså®•æœºï¼Œæ‰€æœ‰ç¼“å­˜å¤±æ•ˆ
â€¢ å®šæ—¶ä»»åŠ¡ï¼šå®šæ—¶æ¸…ç†ç¼“å­˜å¯¼è‡´å¤§é‡æ•°æ®åŒæ—¶å¤±æ•ˆ

å±å®³ï¼š
â€¢ æ•°æ®åº“ç¬é—´æ¥æ”¶å¤§é‡è¯·æ±‚
â€¢ å¯èƒ½å¯¼è‡´æ•°æ®åº“è¿æ¥æ± è€—å°½
â€¢ ç³»ç»Ÿçº§è”æ•…éšœ
```

**ğŸ² è§£å†³æ–¹æ¡ˆ1ï¼šéšæœºè¿‡æœŸæ—¶é—´**
```java
@Service
public class UserService {
    
    public void cacheUserWithRandomExpire(User user) {
        String cacheKey = "user:info:" + user.getId();
        
        // åŸºç¡€è¿‡æœŸæ—¶é—´30åˆ†é’Ÿ
        int baseExpireMinutes = 30;
        
        // éšæœºå¢åŠ 0-10åˆ†é’Ÿ
        Random random = new Random();
        int randomMinutes = random.nextInt(10);
        int totalExpireMinutes = baseExpireMinutes + randomMinutes;
        
        redisTemplate.opsForValue().set(cacheKey, 
            JSON.toJSONString(user), 
            totalExpireMinutes, TimeUnit.MINUTES);
    }
    
    // æ‰¹é‡è®¾ç½®æ—¶ä½¿ç”¨ä¸åŒè¿‡æœŸæ—¶é—´
    public void batchCacheUsers(List<User> users) {
        for (int i = 0; i < users.size(); i++) {
            User user = users.get(i);
            String cacheKey = "user:info:" + user.getId();
            
            // æ¯ä¸ªç”¨æˆ·çš„è¿‡æœŸæ—¶é—´éƒ½ä¸åŒï¼š30-40åˆ†é’Ÿéšæœº
            int expireMinutes = 30 + (i % 10);
            
            redisTemplate.opsForValue().set(cacheKey, 
                JSON.toJSONString(user), 
                expireMinutes, TimeUnit.MINUTES);
        }
    }
}
```

**ğŸ—ï¸ è§£å†³æ–¹æ¡ˆ2ï¼šå¤šçº§ç¼“å­˜**
```
æ¶æ„è®¾è®¡ï¼š

ç”¨æˆ·è¯·æ±‚ â†’ Nginxç¼“å­˜ â†’ åº”ç”¨å†…å­˜ç¼“å­˜ â†’ Redisç¼“å­˜ â†’ æ•°æ®åº“

å„çº§ç¼“å­˜ç‰¹ç‚¹ï¼š
L1 - Nginxç¼“å­˜ï¼š
â€¢ é™æ€èµ„æºã€æ¥å£å“åº”
â€¢ è¿‡æœŸæ—¶é—´ï¼š5-30åˆ†é’Ÿ
â€¢ å‡å°‘åº”ç”¨æœåŠ¡å™¨å‹åŠ›

L2 - åº”ç”¨å†…å­˜ç¼“å­˜ï¼š
â€¢ çƒ­ç‚¹æ•°æ®ã€é…ç½®ä¿¡æ¯
â€¢ è¿‡æœŸæ—¶é—´ï¼š1-10åˆ†é’Ÿ  
â€¢ JVMå †å†…å­˜ï¼Œè®¿é—®æœ€å¿«

L3 - Redisç¼“å­˜ï¼š
â€¢ ä¸»è¦ç¼“å­˜å±‚
â€¢ è¿‡æœŸæ—¶é—´ï¼š10åˆ†é’Ÿ-å‡ å°æ—¶
â€¢ åˆ†å¸ƒå¼å…±äº«

L4 - æ•°æ®åº“ï¼š
â€¢ æœ€ç»ˆæ•°æ®æº
â€¢ æŒä¹…åŒ–å­˜å‚¨
```

**ğŸ”„ è§£å†³æ–¹æ¡ˆ3ï¼šç†”æ–­é™çº§**
```java
@Component
public class UserServiceWithCircuitBreaker {
    
    // ä½¿ç”¨Hystrixå®ç°ç†”æ–­
    @HystrixCommand(fallbackMethod = "getUserFallback", 
                   commandProperties = {
                       @HystrixProperty(name = "circuitBreaker.requestVolumeThreshold", value = "20"),
                       @HystrixProperty(name = "circuitBreaker.errorThresholdPercentage", value = "50")
                   })
    public User getUserById(Long userId) {
        return userService.getUserById(userId);
    }
    
    // é™çº§æ–¹æ³•ï¼šè¿”å›é»˜è®¤ç”¨æˆ·ä¿¡æ¯
    public User getUserFallback(Long userId) {
        log.warn("ç”¨æˆ·æœåŠ¡ç†”æ–­ï¼Œè¿”å›é»˜è®¤ç”¨æˆ·ä¿¡æ¯, userId: {}", userId);
        
        User defaultUser = new User();
        defaultUser.setId(userId);
        defaultUser.setName("é»˜è®¤ç”¨æˆ·");
        defaultUser.setStatus("æœåŠ¡ç¹å¿™");
        
        return defaultUser;
    }
}
```

**ğŸ“Š è§£å†³æ–¹æ¡ˆ4ï¼šç›‘æ§å‘Šè­¦**
```java
@Component
public class CacheMonitor {
    
    @Scheduled(fixedDelay = 60000)  // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    public void monitorCacheHealth() {
        // â‘  æ£€æŸ¥ç¼“å­˜å‘½ä¸­ç‡
        long hits = getRedisHits();
        long total = getTotalQueries();
        double hitRate = (double) hits / total;
        
        if (hitRate < 0.7) {  // å‘½ä¸­ç‡ä½äº70%
            sendAlert("ç¼“å­˜å‘½ä¸­ç‡è¿‡ä½: " + (hitRate * 100) + "%");
        }
        
        // â‘¡ æ£€æŸ¥Redisè¿æ¥çŠ¶æ€
        try {
            redisTemplate.opsForValue().get("health:check");
        } catch (Exception e) {
            sendAlert("Redisè¿æ¥å¼‚å¸¸: " + e.getMessage());
        }
        
        // â‘¢ æ£€æŸ¥æ•°æ®åº“è¿æ¥æ•°
        int activeConnections = getDatabaseActiveConnections();
        if (activeConnections > 80) {  // è¶…è¿‡80ä¸ªæ´»è·ƒè¿æ¥
            sendAlert("æ•°æ®åº“è¿æ¥æ•°è¿‡é«˜: " + activeConnections);
        }
    }
    
    private void sendAlert(String message) {
        // å‘é€åˆ°ç›‘æ§ç³»ç»Ÿæˆ–é€šçŸ¥å¼€å‘äººå‘˜
        log.error("ç¼“å­˜å‘Šè­¦: {}", message);
        // å®é™…é¡¹ç›®ä¸­å¯ä»¥å‘é€é‚®ä»¶ã€çŸ­ä¿¡ã€é’‰é’‰ç­‰
    }
}
```

### 4.4 ç¼“å­˜ä¸‰å¤§é—®é¢˜å¯¹æ¯”


| é—®é¢˜ç±»å‹ | **è§¦å‘æ¡ä»¶** | **å½±å“èŒƒå›´** | **è§£å†³éš¾åº¦** | **ä¸»è¦è§£å†³æ–¹æ¡ˆ** |
|---------|------------|-------------|-------------|----------------|
| **ç¼“å­˜ç©¿é€** | `æŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®` | **å•ä¸ªkey** | `â˜…â˜†â˜†` | `å¸ƒéš†è¿‡æ»¤å™¨ã€ç©ºå€¼ç¼“å­˜` |
| **ç¼“å­˜å‡»ç©¿** | `çƒ­ç‚¹keyè¿‡æœŸ` | **å•ä¸ªçƒ­ç‚¹key** | `â˜…â˜…â˜†` | `äº’æ–¥é”ã€æ°¸ä¸è¿‡æœŸ` |
| **ç¼“å­˜é›ªå´©** | `å¤§é‡keyåŒæ—¶è¿‡æœŸ` | **æ•´ä¸ªç³»ç»Ÿ** | `â˜…â˜…â˜…` | `éšæœºè¿‡æœŸã€å¤šçº§ç¼“å­˜` |

---

## 5. ğŸ”¥ çƒ­ç‚¹æ•°æ®å¤„ç†


### 5.1 çƒ­ç‚¹æ•°æ®è¯†åˆ«


**ğŸ“Š çƒ­ç‚¹æ•°æ®è¯†åˆ«ç­–ç•¥**
```
è®¿é—®é¢‘ç‡ç»Ÿè®¡ï¼š
â€¢ ä½¿ç”¨Redisçš„INCRç»Ÿè®¡keyè®¿é—®æ¬¡æ•°
â€¢ è®¾ç½®ç»Ÿè®¡å‘¨æœŸï¼ˆå¦‚1å°æ—¶ï¼‰
â€¢ è¶…è¿‡é˜ˆå€¼çš„keyæ ‡è®°ä¸ºçƒ­ç‚¹

è®¿é—®æ¨¡å¼åˆ†æï¼š
â€¢ çŸ­æ—¶é—´å†…å¤§é‡ç›¸åŒkeyè¯·æ±‚
â€¢ QPSçªç„¶æ¿€å¢çš„key
â€¢ ä¸šåŠ¡åœºæ™¯é¢„åˆ¤ï¼šæ˜æ˜Ÿã€çƒ­é—¨å•†å“ç­‰
```

**ğŸ’» çƒ­ç‚¹æ£€æµ‹å®ç°**
```java
@Component
public class HotKeyDetector {
    private static final String HOT_KEY_COUNTER = "hotkey:counter:";
    private static final String HOT_KEY_LIST = "hotkey:list";
    private static final int HOT_THRESHOLD = 100;  // çƒ­ç‚¹é˜ˆå€¼
    
    // è®°å½•keyè®¿é—®
    public void recordKeyAccess(String key) {
        String counterKey = HOT_KEY_COUNTER + key;
        String hourKey = String.valueOf(System.currentTimeMillis() / 3600000);
        
        // ç»Ÿè®¡å½“å‰å°æ—¶å†…çš„è®¿é—®æ¬¡æ•°
        Long count = redisTemplate.opsForValue().increment(counterKey + ":" + hourKey);
        redisTemplate.expire(counterKey + ":" + hourKey, 2, TimeUnit.HOURS);
        
        // åˆ¤æ–­æ˜¯å¦æˆä¸ºçƒ­ç‚¹
        if (count > HOT_THRESHOLD) {
            markAsHotKey(key);
        }
    }
    
    private void markAsHotKey(String key) {
        // å°†çƒ­ç‚¹keyåŠ å…¥çƒ­ç‚¹åˆ—è¡¨
        redisTemplate.opsForSet().add(HOT_KEY_LIST, key);
        log.info("æ£€æµ‹åˆ°çƒ­ç‚¹key: {}", key);
        
        // è§¦å‘çƒ­ç‚¹å¤„ç†ç­–ç•¥
        handleHotKey(key);
    }
}
```

### 5.2 çƒ­ç‚¹æ•°æ®å¤„ç†ç­–ç•¥


**ğŸ›¡ï¸ ç­–ç•¥1ï¼šçƒ­ç‚¹æ•°æ®æ°¸ä¸è¿‡æœŸ**
```java
public void setHotKeyNeverExpire(String key, Object value) {
    // åŒ…è£…æ•°æ®ï¼Œæ·»åŠ é€»è¾‘è¿‡æœŸæ—¶é—´
    HotDataWrapper wrapper = new HotDataWrapper();
    wrapper.setData(value);
    wrapper.setLogicalExpireTime(LocalDateTime.now().plusMinutes(30));
    wrapper.setVersion(System.currentTimeMillis());
    
    // Redisä¸­æ°¸ä¸è¿‡æœŸ
    redisTemplate.opsForValue().set(key, JSON.toJSONString(wrapper));
    
    log.info("çƒ­ç‚¹æ•°æ®è®¾ç½®æ°¸ä¸è¿‡æœŸ: {}", key);
}

// æŸ¥è¯¢æ—¶æ£€æŸ¥é€»è¾‘è¿‡æœŸ
public Object getHotKey(String key) {
    String wrapperJson = redisTemplate.opsForValue().get(key);
    if (wrapperJson != null) {
        HotDataWrapper wrapper = JSON.parseObject(wrapperJson, HotDataWrapper.class);
        
        // æ£€æŸ¥é€»è¾‘è¿‡æœŸæ—¶é—´
        if (wrapper.getLogicalExpireTime().isAfter(LocalDateTime.now())) {
            return wrapper.getData();  // æ•°æ®ä»ç„¶æœ‰æ•ˆ
        } else {
            // æ•°æ®é€»è¾‘è¿‡æœŸï¼Œå¼‚æ­¥åˆ·æ–°
            CompletableFuture.runAsync(() -> refreshHotKey(key));
            return wrapper.getData();  // è¿”å›æ—§æ•°æ®ï¼Œä¿è¯å¯ç”¨æ€§
        }
    }
    
    return loadAndCacheHotKey(key);
}
```

**ğŸ”„ ç­–ç•¥2ï¼šå¤šçº§ç¼“å­˜æ¶æ„**
```java
@Service
public class MultiLevelCacheService {
    
    // L1: æœ¬åœ°ç¼“å­˜ï¼ˆCaffeineï¼‰
    private Cache<String, Object> localCache = Caffeine.newBuilder()
        .maximumSize(1000)
        .expireAfterWrite(5, TimeUnit.MINUTES)
        .build();
    
    // L2: Redisåˆ†å¸ƒå¼ç¼“å­˜
    
    public Object getWithMultiLevel(String key) {
        // â‘  å…ˆæŸ¥æœ¬åœ°ç¼“å­˜
        Object value = localCache.getIfPresent(key);
        if (value != null) {
            return value;
        }
        
        // â‘¡ æŸ¥Redisç¼“å­˜
        String redisValue = redisTemplate.opsForValue().get(key);
        if (redisValue != null) {
            Object data = JSON.parseObject(redisValue, Object.class);
            // å†™å…¥æœ¬åœ°ç¼“å­˜
            localCache.put(key, data);
            return data;
        }
        
        // â‘¢ æŸ¥æ•°æ®åº“
        Object dbValue = loadFromDatabase(key);
        if (dbValue != null) {
            // å†™å…¥Redis
            redisTemplate.opsForValue().set(key, JSON.toJSONString(dbValue), 30, TimeUnit.MINUTES);
            // å†™å…¥æœ¬åœ°ç¼“å­˜
            localCache.put(key, dbValue);
        }
        
        return dbValue;
    }
}
```

### 5.3 ç¼“å­˜é¢„çƒ­æ–¹æ¡ˆ


**ğŸš€ ç³»ç»Ÿå¯åŠ¨æ—¶ç¼“å­˜é¢„çƒ­**
```java
@Component
public class CachePreloader {
    
    @EventListener(ApplicationReadyEvent.class)
    public void preloadCache() {
        log.info("å¼€å§‹ç¼“å­˜é¢„çƒ­...");
        
        // é¢„çƒ­ç”¨æˆ·åŸºç¡€æ•°æ®
        preloadUsers();
        
        // é¢„çƒ­å•†å“ä¿¡æ¯
        preloadProducts();
        
        // é¢„çƒ­é…ç½®ä¿¡æ¯
        preloadConfigurations();
        
        log.info("ç¼“å­˜é¢„çƒ­å®Œæˆ");
    }
    
    private void preloadUsers() {
        // åŠ è½½æ´»è·ƒç”¨æˆ·ï¼ˆæœ€è¿‘7å¤©ç™»å½•ï¼‰
        List<User> activeUsers = userMapper.selectActiveUsers(7);
        
        for (User user : activeUsers) {
            String cacheKey = "user:info:" + user.getId();
            redisTemplate.opsForValue().set(cacheKey, 
                JSON.toJSONString(user), 
                30 + new Random().nextInt(10),  // 30-40åˆ†é’Ÿéšæœºè¿‡æœŸ
                TimeUnit.MINUTES);
        }
        
        log.info("é¢„çƒ­ç”¨æˆ·æ•°æ®: {} ä¸ª", activeUsers.size());
    }
    
    private void preloadProducts() {
        // åŠ è½½çƒ­é—¨å•†å“ï¼ˆé”€é‡å‰100ï¼‰
        List<Product> hotProducts = productMapper.selectTopSelling(100);
        
        for (Product product : hotProducts) {
            String cacheKey = "product:info:" + product.getId();
            redisTemplate.opsForValue().set(cacheKey, 
                JSON.toJSONString(product), 
                60, TimeUnit.MINUTES);
        }
        
        log.info("é¢„çƒ­å•†å“æ•°æ®: {} ä¸ª", hotProducts.size());
    }
}
```

**ğŸ“ˆ åŠ¨æ€é¢„çƒ­ç­–ç•¥**
```java
@Scheduled(fixedDelay = 3600000)  // æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡
public void dynamicPreheat() {
    // â‘  åˆ†æè®¿é—®æ—¥å¿—ï¼Œæ‰¾å‡ºçƒ­ç‚¹æ•°æ®
    List<String> hotKeys = analyzeHotKeysFromLog();
    
    // â‘¡ æ£€æŸ¥è¿™äº›çƒ­ç‚¹æ•°æ®çš„ç¼“å­˜çŠ¶æ€
    for (String key : hotKeys) {
        Long ttl = redisTemplate.getExpire(key);
        
        // å¦‚æœå³å°†è¿‡æœŸæˆ–å·²è¿‡æœŸ
        if (ttl == null || ttl < 600) {  // å°äº10åˆ†é’Ÿ
            // é‡æ–°åŠ è½½æ•°æ®
            Object data = loadDataByKey(key);
            if (data != null) {
                int expireTime = 60 + new Random().nextInt(30);  // 60-90åˆ†é’Ÿ
                redisTemplate.opsForValue().set(key, 
                    JSON.toJSONString(data), 
                    expireTime, TimeUnit.MINUTES);
                log.info("åŠ¨æ€é¢„çƒ­çƒ­ç‚¹æ•°æ®: {}", key);
            }
        }
    }
}
```

---

## 6. ğŸ› ï¸ ç¼“å­˜å®æˆ˜åº”ç”¨


### 6.1 å®Œæ•´çš„ç¼“å­˜æœåŠ¡å®ç°


**ğŸ”§ é€šç”¨ç¼“å­˜æœåŠ¡ç±»**
```java
@Service
public class UniversalCacheService {
    
    // é€šç”¨æŸ¥è¯¢æ–¹æ³•
    public <T> T getWithCache(String key, Class<T> clazz, 
                             Supplier<T> dataLoader, 
                             int expireMinutes) {
        
        // â‘  æŸ¥è¯¢ç¼“å­˜
        String cachedValue = redisTemplate.opsForValue().get(key);
        if (cachedValue != null) {
            if ("null".equals(cachedValue)) {
                return null;  // ç©ºå€¼ç¼“å­˜
            }
            return JSON.parseObject(cachedValue, clazz);
        }
        
        // â‘¡ ç¼“å­˜æœªå‘½ä¸­ï¼Œä½¿ç”¨åˆ†å¸ƒå¼é”é˜²æ­¢å¹¶å‘æŸ¥è¯¢
        String lockKey = "lock:" + key;
        String lockValue = UUID.randomUUID().toString();
        
        try {
            if (redisTemplate.opsForValue().setIfAbsent(lockKey, lockValue, 10, TimeUnit.SECONDS)) {
                
                // â‘¢ è·å–é”æˆåŠŸï¼ŒæŸ¥è¯¢æ•°æ®æº
                T data = dataLoader.get();
                
                if (data != null) {
                    // â‘£ æ•°æ®å­˜åœ¨ï¼Œå†™å…¥ç¼“å­˜
                    int randomExpire = expireMinutes + new Random().nextInt(expireMinutes / 5);
                    redisTemplate.opsForValue().set(key, JSON.toJSONString(data), 
                        randomExpire, TimeUnit.MINUTES);
                } else {
                    // â‘¤ æ•°æ®ä¸å­˜åœ¨ï¼Œç¼“å­˜ç©ºå€¼
                    redisTemplate.opsForValue().set(key, "null", 5, TimeUnit.MINUTES);
                }
                
                return data;
            } else {
                // â‘¥ è·å–é”å¤±è´¥ï¼Œç­‰å¾…å¹¶é‡è¯•
                Thread.sleep(100);
                return getWithCache(key, clazz, dataLoader, expireMinutes);
            }
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            return dataLoader.get();  // å¼‚å¸¸æ—¶ç›´æ¥æŸ¥æ•°æ®åº“
        } finally {
            // â‘¦ é‡Šæ”¾é”
            String currentValue = redisTemplate.opsForValue().get(lockKey);
            if (lockValue.equals(currentValue)) {
                redisTemplate.delete(lockKey);
            }
        }
    }
}
```

### 6.2 å…·ä½“ä¸šåŠ¡åº”ç”¨ç¤ºä¾‹


**ğŸ›ï¸ ç”µå•†åœºæ™¯åº”ç”¨**
```java
@Service
public class ProductCacheService {
    
    // å•†å“è¯¦æƒ…ç¼“å­˜
    public Product getProductDetail(Long productId) {
        return universalCacheService.getWithCache(
            "product:detail:" + productId,
            Product.class,
            () -> productMapper.selectDetailById(productId),
            60  // 1å°æ—¶è¿‡æœŸ
        );
    }
    
    // å•†å“åº“å­˜ç¼“å­˜ï¼ˆæ›´æ–°é¢‘ç¹ï¼‰
    public Integer getProductStock(Long productId) {
        String key = "product:stock:" + productId;
        String stock = redisTemplate.opsForValue().get(key);
        
        if (stock != null) {
            return Integer.valueOf(stock);
        }
        
        // åº“å­˜æ•°æ®ä»æ•°æ®åº“æŸ¥è¯¢
        Integer dbStock = productMapper.selectStockById(productId);
        if (dbStock != null) {
            // åº“å­˜ç¼“å­˜æ—¶é—´è¾ƒçŸ­ï¼š5åˆ†é’Ÿ
            redisTemplate.opsForValue().set(key, dbStock.toString(), 5, TimeUnit.MINUTES);
        }
        
        return dbStock;
    }
    
    // æ›´æ–°å•†å“åº“å­˜
    public void updateProductStock(Long productId, Integer newStock) {
        String stockKey = "product:stock:" + productId;
        String detailKey = "product:detail:" + productId;
        
        // â‘  å…ˆåˆ é™¤ç›¸å…³ç¼“å­˜
        redisTemplate.delete(stockKey);
        redisTemplate.delete(detailKey);
        
        // â‘¡ æ›´æ–°æ•°æ®åº“
        productMapper.updateStock(productId, newStock);
        
        // â‘¢ å»¶æ—¶åŒåˆ 
        CompletableFuture.runAsync(() -> {
            try {
                Thread.sleep(1000);
                redisTemplate.delete(stockKey);
                redisTemplate.delete(detailKey);
            } catch (Exception e) {
                log.error("å»¶æ—¶åˆ é™¤ç¼“å­˜å¤±è´¥", e);
            }
        });
    }
}
```

**ğŸ“± ç”¨æˆ·ä¼šè¯ç¼“å­˜**
```java
@Service
public class UserSessionService {
    
    // ç”¨æˆ·ç™»å½•çŠ¶æ€ç¼“å­˜
    public void cacheUserSession(String token, UserSession session) {
        String key = "session:token:" + token;
        
        // ä¼šè¯ä¿¡æ¯ç¼“å­˜2å°æ—¶
        redisTemplate.opsForValue().set(key, 
            JSON.toJSONString(session), 
            2, TimeUnit.HOURS);
        
        // åŒæ—¶ç»´æŠ¤ç”¨æˆ·çš„æ´»è·ƒçŠ¶æ€
        String activeKey = "user:active:" + session.getUserId();
        redisTemplate.opsForValue().set(activeKey, "true", 2, TimeUnit.HOURS);
    }
    
    // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
    public UserSession getSessionByToken(String token) {
        String key = "session:token:" + token;
        String sessionJson = redisTemplate.opsForValue().get(key);
        
        if (sessionJson != null) {
            UserSession session = JSON.parseObject(sessionJson, UserSession.class);
            
            // åˆ·æ–°è¿‡æœŸæ—¶é—´ï¼ˆæ´»è·ƒç”¨æˆ·å»¶é•¿ä¼šè¯ï¼‰
            redisTemplate.expire(key, 2, TimeUnit.HOURS);
            
            return session;
        }
        
        return null;  // ä¼šè¯ä¸å­˜åœ¨æˆ–å·²è¿‡æœŸ
    }
    
    // ç”¨æˆ·é€€å‡ºï¼Œæ¸…ç†ç¼“å­˜
    public void logout(String token, Long userId) {
        String sessionKey = "session:token:" + token;
        String activeKey = "user:active:" + userId;
        
        // æ¸…ç†æ‰€æœ‰ç›¸å…³ç¼“å­˜
        redisTemplate.delete(sessionKey);
        redisTemplate.delete(activeKey);
        
        // æ¸…ç†ç”¨æˆ·ç›¸å…³çš„ä¸šåŠ¡ç¼“å­˜
        String pattern = "user:*:" + userId;
        Set<String> userKeys = redisTemplate.keys(pattern);
        if (!userKeys.isEmpty()) {
            redisTemplate.delete(userKeys);
        }
    }
}
```

### 6.3 ç¼“å­˜æ€§èƒ½ä¼˜åŒ–


**âš¡ æ‰¹é‡æ“ä½œä¼˜åŒ–**
```java
// æ‰¹é‡è·å–ç”¨æˆ·ä¿¡æ¯
public Map<Long, User> batchGetUsers(List<Long> userIds) {
    Map<Long, User> result = new HashMap<>();
    List<String> cacheKeys = new ArrayList<>();
    
    // â‘  æ„é€ æ‰€æœ‰ç¼“å­˜key
    for (Long userId : userIds) {
        cacheKeys.add("user:info:" + userId);
    }
    
    // â‘¡ æ‰¹é‡æŸ¥è¯¢ç¼“å­˜ï¼ˆä¸€æ¬¡ç½‘ç»œè¯·æ±‚ï¼‰
    List<String> cachedValues = redisTemplate.opsForValue().multiGet(cacheKeys);
    
    List<Long> missUserIds = new ArrayList<>();
    
    // â‘¢ å¤„ç†ç¼“å­˜ç»“æœ
    for (int i = 0; i < userIds.size(); i++) {
        String cachedValue = cachedValues.get(i);
        if (cachedValue != null) {
            User user = JSON.parseObject(cachedValue, User.class);
            result.put(userIds.get(i), user);
        } else {
            missUserIds.add(userIds.get(i));  // è®°å½•ç¼“å­˜missçš„ID
        }
    }
    
    // â‘£ æ‰¹é‡æŸ¥è¯¢æ•°æ®åº“ä¸­missçš„æ•°æ®
    if (!missUserIds.isEmpty()) {
        List<User> dbUsers = userMapper.selectBatchIds(missUserIds);
        
        // â‘¤ æ‰¹é‡å†™å…¥ç¼“å­˜
        Map<String, String> cacheData = new HashMap<>();
        for (User user : dbUsers) {
            result.put(user.getId(), user);
            cacheData.put("user:info:" + user.getId(), JSON.toJSONString(user));
        }
        
        if (!cacheData.isEmpty()) {
            // æ‰¹é‡å†™å…¥Redis
            redisTemplate.opsForValue().multiSet(cacheData);
            // æ‰¹é‡è®¾ç½®è¿‡æœŸæ—¶é—´
            for (String key : cacheData.keySet()) {
                redisTemplate.expire(key, 30, TimeUnit.MINUTES);
            }
        }
    }
    
    return result;
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 ç¼“å­˜è®¾è®¡æ¨¡å¼é€‰æ‹©æŒ‡å—


```
ğŸ”¸ Cache-Asideï¼šæœ€å¸¸ç”¨ï¼Œåº”ç”¨ç¨‹åºå®Œå…¨æ§åˆ¶ç¼“å­˜é€»è¾‘
ğŸ”¸ Read-Throughï¼šé€‚åˆè¯»å¤šå†™å°‘ï¼Œç®€åŒ–ä¸šåŠ¡ä»£ç 
ğŸ”¸ Write-Throughï¼šå¼ºä¸€è‡´æ€§è¦æ±‚ï¼Œå†™æ€§èƒ½è¦æ±‚ä¸é«˜
ğŸ”¸ Write-Backï¼šé«˜æ€§èƒ½è¦æ±‚ï¼Œå¯æ¥å—æœ€ç»ˆä¸€è‡´æ€§
```

### 7.2 ç¼“å­˜ä¸€è‡´æ€§ç­–ç•¥


```
ğŸ”¸ å¼ºä¸€è‡´æ€§ï¼šåˆ†å¸ƒå¼é”ã€ä¸¤é˜¶æ®µæäº¤ï¼ˆå¤æ‚ï¼Œæ€§èƒ½å·®ï¼‰
ğŸ”¸ æœ€ç»ˆä¸€è‡´æ€§ï¼šå»¶æ—¶åŒåˆ ã€å¼‚æ­¥æ›´æ–°ï¼ˆç®€å•ï¼Œæ€§èƒ½å¥½ï¼‰
ğŸ”¸ é€‰æ‹©åŸåˆ™ï¼šæ ¹æ®ä¸šåŠ¡å¯¹æ•°æ®ä¸€è‡´æ€§çš„è¦æ±‚ç¨‹åº¦é€‰æ‹©
```

### 7.3 ç¼“å­˜ä¸‰å¤§é—®é¢˜è§£å†³æ–¹æ¡ˆ


**ğŸ“Š é—®é¢˜è§£å†³ç­–ç•¥æ€»è§ˆ**
```
ç¼“å­˜ç©¿é€ â†’ æŸ¥ä¸å­˜åœ¨çš„æ•°æ®ï¼š
â€¢ ğŸŒ¸ å¸ƒéš†è¿‡æ»¤å™¨ï¼šåœ¨ç¼“å­˜å‰åŠ ä¸€å±‚è¿‡æ»¤
â€¢ ğŸ•³ï¸ ç©ºå€¼ç¼“å­˜ï¼šç¼“å­˜ç©ºç»“æœï¼Œè®¾ç½®è¾ƒçŸ­è¿‡æœŸæ—¶é—´
â€¢ ğŸ›¡ï¸ å‚æ•°æ ¡éªŒï¼šåœ¨æ¥å£å±‚é¢æ ¡éªŒå‚æ•°åˆæ³•æ€§

ç¼“å­˜å‡»ç©¿ â†’ çƒ­ç‚¹keyè¿‡æœŸï¼š
â€¢ ğŸ” äº’æ–¥é”ï¼šåªå…è®¸ä¸€ä¸ªçº¿ç¨‹æŸ¥è¯¢æ•°æ®åº“
â€¢ â™¾ï¸ æ°¸ä¸è¿‡æœŸï¼šçƒ­ç‚¹æ•°æ®é€»è¾‘è¿‡æœŸï¼Œå¼‚æ­¥åˆ·æ–°
â€¢ ğŸ”¥ çƒ­ç‚¹é¢„çƒ­ï¼šæå‰åŠ è½½çƒ­ç‚¹æ•°æ®åˆ°ç¼“å­˜

ç¼“å­˜é›ªå´© â†’ å¤§é‡keyåŒæ—¶è¿‡æœŸï¼š
â€¢ ğŸ² éšæœºè¿‡æœŸï¼šç»™è¿‡æœŸæ—¶é—´åŠ éšæœºå€¼
â€¢ ğŸ—ï¸ å¤šçº§ç¼“å­˜ï¼šå¤šå±‚ç¼“å­˜é™ä½é£é™©
â€¢ ğŸ“Š ç›‘æ§å‘Šè­¦ï¼šåŠæ—¶å‘ç°å’Œå¤„ç†é—®é¢˜
â€¢ ğŸ”„ ç†”æ–­é™çº§ï¼šç³»ç»Ÿè¿‡è½½æ—¶å¯åŠ¨ä¿æŠ¤æœºåˆ¶
```

### 7.4 å®é™…åº”ç”¨æœ€ä½³å®è·µ


**ğŸ¯ ç¼“å­˜ä½¿ç”¨å»ºè®®**
```
æ•°æ®ç‰¹å¾åˆ†æï¼š
â€¢ çƒ­ç‚¹æ•°æ®ï¼šè®¿é—®é¢‘ç‡é«˜ â†’ ç¼“å­˜æ—¶é—´é•¿ï¼Œå¤šçº§ç¼“å­˜
â€¢ å®æ—¶æ•°æ®ï¼šå˜åŒ–é¢‘ç‡é«˜ â†’ ç¼“å­˜æ—¶é—´çŸ­ï¼ŒåŠæ—¶æ›´æ–°
â€¢ ç¨³å®šæ•°æ®ï¼šå¾ˆå°‘å˜åŒ– â†’ ç¼“å­˜æ—¶é—´é•¿ï¼Œæ‰‹åŠ¨åˆ·æ–°

ä¸šåŠ¡åœºæ™¯é€‚é…ï¼š
â€¢ ç”µå•†ç³»ç»Ÿï¼šå•†å“ä¿¡æ¯ç¼“å­˜ï¼Œåº“å­˜å®æ—¶æ€§
â€¢ ç¤¾äº¤ç³»ç»Ÿï¼šç”¨æˆ·ä¿¡æ¯ç¼“å­˜ï¼Œæ¶ˆæ¯åŠæ—¶æ€§
â€¢ å†…å®¹ç³»ç»Ÿï¼šæ–‡ç« å†…å®¹ç¼“å­˜ï¼Œè¯„è®ºå®æ—¶æ€§

æ€§èƒ½ä¼˜åŒ–è¦ç‚¹ï¼š
â€¢ åˆç†è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œé¿å…é›ªå´©
â€¢ ä½¿ç”¨æ‰¹é‡æ“ä½œå‡å°‘ç½‘ç»œå¼€é”€
â€¢ ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡å’Œç³»ç»Ÿæ€§èƒ½
â€¢ å»ºç«‹å®Œå–„çš„é™çº§å’Œç†”æ–­æœºåˆ¶
```

**ğŸ’¡ è®°å¿†è¦ç‚¹**
> **ç¼“å­˜ä¸‰å¤§é—®é¢˜**ï¼šç©¿é€ï¼ˆæŸ¥ä¸åˆ°ï¼‰ã€å‡»ç©¿ï¼ˆçƒ­ç‚¹çˆ†ï¼‰ã€é›ªå´©ï¼ˆé›†ä½“æ­»ï¼‰
> **è§£å†³ä¸‰æ³•å®**ï¼šè¿‡æ»¤å™¨æŒ¡ç©¿é€ã€äº’æ–¥é”é˜²å‡»ç©¿ã€éšæœºåŒ–é¿é›ªå´©
> **ä¸€è‡´æ€§æƒè¡¡**ï¼šå¼ºä¸€è‡´æ¢æ€§èƒ½ï¼Œæœ€ç»ˆä¸€è‡´å¾—é€Ÿåº¦
> **è®¾è®¡å››æ¨¡å¼**ï¼šæ—è·¯æœ€å¸¸ç”¨ï¼Œè¯»ç©¿é€ç®€åŒ–ï¼Œå†™ç©¿é€ä¸€è‡´ï¼Œå†™å›æ€§èƒ½ä¼˜

**ğŸ”„ å­¦ä¹ è·¯å¾„**
```
â‘  ç†è§£ç¼“å­˜åŸºæœ¬æ¦‚å¿µå’Œä½œç”¨
â‘¡ æŒæ¡Cache-Asideæ¨¡å¼çš„å®ç°
â‘¢ äº†è§£ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ
â‘£ å­¦ä¹ ç¼“å­˜ä¸‰å¤§é—®é¢˜çš„è¯†åˆ«å’Œè§£å†³
â‘¤ å®è·µå¤šçº§ç¼“å­˜å’Œçƒ­ç‚¹æ•°æ®å¤„ç†
â‘¥ å»ºç«‹ç›‘æ§å‘Šè­¦å’Œè¿ç»´ä½“ç³»
```