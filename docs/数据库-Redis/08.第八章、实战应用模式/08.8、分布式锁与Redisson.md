---
title: 8ã€åˆ†å¸ƒå¼é”ä¸Redisson
---
## ğŸ“š ç›®å½•

1. [åˆ†å¸ƒå¼é”åŸºç¡€æ¦‚å¿µ](#1-åˆ†å¸ƒå¼é”åŸºç¡€æ¦‚å¿µ)
2. [åŸºç¡€å®ç°æ–¹æ¡ˆ](#2-åŸºç¡€å®ç°æ–¹æ¡ˆ)
3. [åˆ†å¸ƒå¼é”æ ¸å¿ƒè¦ç´ ](#3-åˆ†å¸ƒå¼é”æ ¸å¿ƒè¦ç´ )
4. [é«˜çº§å®ç°æŠ€æœ¯](#4-é«˜çº§å®ç°æŠ€æœ¯)
5. [Redlockç®—æ³•è¯¦è§£](#5-redlockç®—æ³•è¯¦è§£)
6. [Redissonæ¡†æ¶å®æˆ˜](#6-redissonæ¡†æ¶å®æˆ˜)
7. [å®æˆ˜åº”ç”¨åœºæ™¯](#7-å®æˆ˜åº”ç”¨åœºæ™¯)
8. [é—®é¢˜å¤„ç†ä¸æœ€ä½³å®è·µ](#8-é—®é¢˜å¤„ç†ä¸æœ€ä½³å®è·µ)

---

## 1. ğŸ” åˆ†å¸ƒå¼é”åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼é”


**åŸºæœ¬å®šä¹‰**
åˆ†å¸ƒå¼é”æ˜¯åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å®ç°äº’æ–¥è®¿é—®çš„æœºåˆ¶ã€‚å°±åƒå…¬å…±å•æ‰€çš„é—¨é”ï¼ŒåŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªäººä½¿ç”¨ï¼Œå…¶ä»–äººå¿…é¡»æ’é˜Ÿç­‰å¾…ã€‚

```
å•æœºç¯å¢ƒï¼š
çº¿ç¨‹A â†’ æœ¬åœ°é” â†’ è®¿é—®å…±äº«èµ„æº
çº¿ç¨‹B â†’ ç­‰å¾…é”é‡Šæ”¾ â†’ è·å¾—é”åè®¿é—®

åˆ†å¸ƒå¼ç¯å¢ƒï¼š
æœåŠ¡å™¨1 â†’ åˆ†å¸ƒå¼é” â†’ è®¿é—®å…±äº«èµ„æº  
æœåŠ¡å™¨2 â†’ ç­‰å¾…é”é‡Šæ”¾ â†’ è·å¾—é”åè®¿é—®
æœåŠ¡å™¨3 â†’ æ’é˜Ÿç­‰å¾…
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”


**éœ€æ±‚åˆ†æ**
åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¤šä¸ªæœåŠ¡å™¨å¯èƒ½åŒæ—¶æ“ä½œåŒä¸€ä¸ªèµ„æºï¼Œæ²¡æœ‰åè°ƒæœºåˆ¶ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚

**å…¸å‹é—®é¢˜åœºæ™¯**
```
ç”µå•†åº“å­˜é—®é¢˜ï¼š
å•†å“å‰©ä½™ï¼š1ä»¶
è¯·æ±‚ï¼š100äººåŒæ—¶ä¸‹å•
æœåŠ¡å™¨Aï¼šè¯»å–åº“å­˜=1 â†’ æ‰£å‡åº“å­˜ â†’ ç”Ÿæˆè®¢å•
æœåŠ¡å™¨Bï¼šè¯»å–åº“å­˜=1 â†’ æ‰£å‡åº“å­˜ â†’ ç”Ÿæˆè®¢å•
ç»“æœï¼šå–å‡º2ä»¶å•†å“ï¼Œå‡ºç°è¶…å–

æ–‡ä»¶å¤„ç†é—®é¢˜ï¼š
å¤šä¸ªæœåŠ¡åŒæ—¶å¤„ç†åŒä¸€ä¸ªæ–‡ä»¶
å¯èƒ½å¯¼è‡´æ•°æ®æŸåæˆ–é‡å¤å¤„ç†
```

### 1.3 åˆ†å¸ƒå¼é”ä½¿ç”¨åœºæ™¯


**æ ¸å¿ƒåº”ç”¨åœºæ™¯**
```
é˜²é‡å¤æ“ä½œï¼š
â€¢ é˜²æ­¢ç”¨æˆ·é‡å¤æäº¤è¡¨å•
â€¢ é˜²æ­¢å®šæ—¶ä»»åŠ¡é‡å¤æ‰§è¡Œ
â€¢ é˜²æ­¢é‡å¤å‘é€æ¶ˆæ¯

èµ„æºç‹¬å ï¼š
â€¢ åº“å­˜æ‰£å‡æ“ä½œ
â€¢ æ–‡ä»¶ä¸Šä¼ å¤„ç†
â€¢ æ•°æ®å¯¼å…¥å¯¼å‡º

ä¸´ç•ŒåŒºä¿æŠ¤ï¼š
â€¢ å…¨å±€IDç”Ÿæˆ
â€¢ é…ç½®æ›´æ–°æ“ä½œ
â€¢ ç»Ÿè®¡æ•°æ®è®¡ç®—
```

### 1.4 Rediså®ç°é”çš„ä¼˜åŠ¿


**ä¸ºä»€ä¹ˆé€‰æ‹©Redis**
```
æ€§èƒ½ä¼˜åŠ¿ï¼š
â€¢ å†…å­˜æ“ä½œï¼Œå“åº”æ—¶é—´å¾®ç§’çº§
â€¢ å•çº¿ç¨‹æ¨¡å‹ï¼Œé¿å…ç«äº‰æ¡ä»¶
â€¢ æ”¯æŒé«˜å¹¶å‘è®¿é—®

åŠŸèƒ½ä¼˜åŠ¿ï¼š
â€¢ åŸå­æ“ä½œå‘½ä»¤æ”¯æŒ
â€¢ è¿‡æœŸæ—¶é—´è‡ªåŠ¨ç®¡ç†
â€¢ ä¸°å¯Œçš„æ•°æ®ç»“æ„

éƒ¨ç½²ä¼˜åŠ¿ï¼š
â€¢ è½»é‡çº§ï¼Œéƒ¨ç½²ç®€å•
â€¢ è¿ç»´æˆç†Ÿï¼Œç›‘æ§å®Œå–„
â€¢ å®¢æˆ·ç«¯åº“ä¸°å¯Œ
```

**å¯¹æ¯”å…¶ä»–æ–¹æ¡ˆ**
| æŠ€æœ¯æ–¹æ¡ˆ | **æ€§èƒ½** | **å¤æ‚åº¦** | **å¯ç”¨æ€§** | **é€‚ç”¨åœºæ™¯** |
|---------|---------|-----------|-----------|-------------|
| `Redis` | `æé«˜` | `ä¸­ç­‰` | `é«˜` | `é«˜å¹¶å‘Webåº”ç”¨` |
| `ZooKeeper` | `ä¸­ç­‰` | `é«˜` | `æé«˜` | `å¼ºä¸€è‡´æ€§ç³»ç»Ÿ` |
| `æ•°æ®åº“` | `ä½` | `ä½` | `ä¸­ç­‰` | `ç®€å•ä¸šåŠ¡åœºæ™¯` |
| `Etcd` | `é«˜` | `ä¸­ç­‰` | `é«˜` | `äº‘åŸç”Ÿåº”ç”¨` |

### 1.5 é”çš„åŸºæœ¬è¦æ±‚


**åˆ†å¸ƒå¼é”å¿…é¡»æ»¡è¶³çš„æ¡ä»¶**
```
äº’æ–¥æ€§ï¼ˆMutual Exclusionï¼‰ï¼š
â€¢ åŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªå®¢æˆ·ç«¯æŒæœ‰é”
â€¢ ç¡®ä¿å¹¶å‘å®‰å…¨

å®‰å…¨æ€§ï¼ˆSafetyï¼‰ï¼š
â€¢ åªæœ‰é”çš„æŒæœ‰è€…æ‰èƒ½é‡Šæ”¾é”
â€¢ é˜²æ­¢è¯¯åˆ å…¶ä»–å®¢æˆ·ç«¯çš„é”

æ´»æ€§ï¼ˆLivenessï¼‰ï¼š
â€¢ é”æœ€ç»ˆä¸€å®šèƒ½è¢«é‡Šæ”¾
â€¢ é¿å…æ­»é”å¯¼è‡´ç³»ç»Ÿåœæ‘†

å®¹é”™æ€§ï¼ˆFault Toleranceï¼‰ï¼š
â€¢ å®¢æˆ·ç«¯å´©æºƒåé”èƒ½è‡ªåŠ¨é‡Šæ”¾
â€¢ ç½‘ç»œå¼‚å¸¸ä¸å½±å“é”çš„æ­£ç¡®æ€§

é«˜æ€§èƒ½ï¼ˆHigh Performanceï¼‰ï¼š
â€¢ è·å–å’Œé‡Šæ”¾é”çš„æ“ä½œè¦å¿«
â€¢ ä¸èƒ½æˆä¸ºç³»ç»Ÿæ€§èƒ½ç“¶é¢ˆ
```

---

## 2. ğŸ› ï¸ åŸºç¡€å®ç°æ–¹æ¡ˆ


### 2.1 SETNXå®ç°ç®€å•é”


**SETNXåŸºç¡€ç”¨æ³•**
SETNXï¼ˆSET if Not eXistsï¼‰æ˜¯æœ€ç®€å•çš„åˆ†å¸ƒå¼é”å®ç°ï¼Œç±»ä¼¼æŠ¢åº§ä½ï¼šç¬¬ä¸€ä¸ªåä¸‹çš„äººæˆåŠŸï¼Œå…¶ä»–äººåªèƒ½ç­‰å¾…ã€‚

```bash
# åŸºæœ¬è¯­æ³•
SETNX lock_key lock_value
# è¿”å›1ï¼šè®¾ç½®æˆåŠŸï¼Œè·å¾—é”
# è¿”å›0ï¼škeyå·²å­˜åœ¨ï¼Œè·é”å¤±è´¥

# å®é™…ä½¿ç”¨ç¤ºä¾‹
SETNX lock:order:1001 "server-A-thread-123"
# æˆåŠŸè¿”å›ï¼š1
# å¤±è´¥è¿”å›ï¼š0
```

**ç®€å•é”çš„Javaå®ç°**
```java
public class SimpleLock {
    private Jedis jedis;
    
    public boolean tryLock(String lockKey, String clientId) {
        Long result = jedis.setnx(lockKey, clientId);
        return result == 1;
    }
    
    public void releaseLock(String lockKey) {
        jedis.del(lockKey);
    }
    
    // ä½¿ç”¨ç¤ºä¾‹
    public void businessMethod() {
        String lockKey = "lock:business:001";
        String clientId = generateClientId();
        
        if (tryLock(lockKey, clientId)) {
            try {
                // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
                doBusinessLogic();
            } finally {
                releaseLock(lockKey);
            }
        } else {
            System.out.println("è·å–é”å¤±è´¥ï¼Œç¨åé‡è¯•");
        }
    }
}
```

### 2.2 SETNX + EXPIREçš„ä¸¥é‡é—®é¢˜


**é—®é¢˜åˆ†æ**
SETNXå’ŒEXPIREåˆ†ä¸¤æ­¥æ‰§è¡Œï¼Œä¸­é—´å­˜åœ¨æ—¶é—´çª—å£ï¼Œå¯èƒ½å¯¼è‡´æ­»é”ã€‚

```bash
# é”™è¯¯çš„å®ç°æ–¹å¼
SETNX lock:resource "client-1"  # æ­¥éª¤1ï¼šè®¾ç½®é”
EXPIRE lock:resource 30         # æ­¥éª¤2ï¼šè®¾ç½®è¿‡æœŸæ—¶é—´

è‡´å‘½é—®é¢˜ï¼š
å¦‚æœåœ¨æ­¥éª¤1å’Œæ­¥éª¤2ä¹‹é—´ï¼š
â€¢ ç¨‹åºå´©æºƒ
â€¢ ç½‘ç»œä¸­æ–­  
â€¢ ç³»ç»Ÿé‡å¯

ç»“æœï¼šé”è¢«è®¾ç½®ä½†æ°¸ä¸è¿‡æœŸ â†’ æ­»é”ï¼
```

**æ­»é”æ¼”ç¤º**
```java
// å±é™©çš„å®ç°ï¼ˆæ°¸è¿œä¸è¦è¿™æ ·å†™ï¼‰
public boolean badLockImplementation(String lockKey, String clientId) {
    // ç¬¬1æ­¥ï¼šå°è¯•è·å–é”
    Long result = jedis.setnx(lockKey, clientId);
    if (result == 1) {
        // ç¬¬2æ­¥ï¼šè®¾ç½®è¿‡æœŸæ—¶é—´
        // âš ï¸ å¦‚æœè¿™é‡Œå‡ºç°å¼‚å¸¸ï¼Œé”æ°¸è¿œä¸ä¼šè¿‡æœŸ
        jedis.expire(lockKey, 30);
        return true;
    }
    return false;
}
```

### 2.3 SET EX NXå®ç°é«˜çº§é”


**æ ‡å‡†å®ç°è¯­æ³•**
```bash
# Redis 2.6.12+ æ”¯æŒçš„åŸå­æ“ä½œ
SET lock_key lock_value EX expire_seconds NX

# PXç‰ˆæœ¬ï¼ˆæ¯«ç§’çº§è¿‡æœŸæ—¶é—´ï¼‰
SET lock_key lock_value PX expire_milliseconds NX

å‚æ•°è¯´æ˜ï¼š
â€¢ EX secondsï¼šè®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
â€¢ PX millisecondsï¼šè®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰  
â€¢ NXï¼šåªåœ¨keyä¸å­˜åœ¨æ—¶è®¾ç½®
â€¢ æ•´ä¸ªæ“ä½œæ˜¯åŸå­çš„ï¼Œä¸€æ¡å‘½ä»¤å®Œæˆ
```

**åŸºç¡€å®ç°ç¤ºä¾‹**
```bash
# è·å–é”ï¼ˆ30ç§’åè‡ªåŠ¨è¿‡æœŸï¼‰
SET lock:order:1001 "server-A-uuid-123" EX 30 NX
# æˆåŠŸè¿”å›ï¼šOK
# å¤±è´¥è¿”å›ï¼š(nil)

# é‡Šæ”¾é”ï¼ˆç®€å•åˆ é™¤ï¼Œå­˜åœ¨å®‰å…¨é—®é¢˜ï¼‰
DEL lock:order:1001

# PXç‰ˆæœ¬ç¤ºä¾‹ï¼ˆ5000æ¯«ç§’ = 5ç§’ï¼‰
SET lock:cache:update "client-B-uuid-456" PX 5000 NX
```

**Javaæ ‡å‡†å®ç°**
```java
public class StandardDistributedLock {
    private Jedis jedis;
    
    /**
     * å°è¯•è·å–é”
     * @param lockKey é”çš„é”®
     * @param clientId å®¢æˆ·ç«¯å”¯ä¸€æ ‡è¯†
     * @param expireSeconds è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
     */
    public boolean tryLock(String lockKey, String clientId, int expireSeconds) {
        String result = jedis.set(lockKey, clientId, "EX", expireSeconds, "NX");
        return "OK".equals(result);
    }
    
    /**
     * é‡Šæ”¾é”ï¼ˆä¸å®‰å…¨çš„ç‰ˆæœ¬ï¼‰
     */
    public void releaseLockUnsafe(String lockKey) {
        jedis.del(lockKey); // å¯èƒ½è¯¯åˆ å…¶ä»–å®¢æˆ·ç«¯çš„é”
    }
}
```

---

## 3. âš™ï¸ åˆ†å¸ƒå¼é”æ ¸å¿ƒè¦ç´ 


### 3.1 åŸå­æ“ä½œä¿è¯


**åŸå­æ“ä½œçš„é‡è¦æ€§**
åŸå­æ“ä½œå°±åƒè½¬è´¦ï¼šè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ï¼Œä¸èƒ½å‡ºç°ä¸­é—´çŠ¶æ€ã€‚

```
éåŸå­æ“ä½œçš„é£é™©ï¼š
æ“ä½œ1ï¼šSETNXè®¾ç½®é” â†’ æˆåŠŸ
â†“ ç½‘ç»œä¸­æ–­æˆ–ç¨‹åºå´©æºƒ
æ“ä½œ2ï¼šEXPIREè®¾ç½®è¿‡æœŸ â†’ å¤±è´¥
ç»“æœï¼šé”å­˜åœ¨ä½†æ°¸ä¸è¿‡æœŸ

åŸå­æ“ä½œçš„ä¿éšœï¼š
SET key value EX 30 NX â†’ ä¸€æ¡å‘½ä»¤å®Œæˆæ‰€æœ‰æ“ä½œ
è¦ä¹ˆå…¨æˆåŠŸï¼Œè¦ä¹ˆå…¨å¤±è´¥
```

**åŸå­æ“ä½œå®ç°æ–¹å¼**
```bash
# æ–¹å¼1ï¼šSETå‘½ä»¤çš„ç»„åˆå‚æ•°ï¼ˆæ¨èï¼‰
SET lock:resource "client-uuid" EX 30 NX

# æ–¹å¼2ï¼šLuaè„šæœ¬å®ç°å¤æ‚é€»è¾‘
EVAL "
local result = redis.call('SET', KEYS[1], ARGV[1], 'EX', ARGV[2], 'NX')
if result then
    return 1
else  
    return 0
end
" 1 lock:resource client-uuid 30

# æ–¹å¼3ï¼šRedisäº‹åŠ¡ï¼ˆä¸æ¨èç”¨äºåˆ†å¸ƒå¼é”ï¼‰
MULTI
SET lock:resource value
EXPIRE lock:resource 30
EXEC
```

### 3.2 å”¯ä¸€æ ‡è¯†é¿å…è¯¯åˆ 


**å”¯ä¸€æ ‡è¯†çš„å¿…è¦æ€§**
æ¯ä¸ªé”éƒ½éœ€è¦"èº«ä»½è¯"ï¼Œé˜²æ­¢å¼ ä¸‰åˆ é™¤æå››çš„é”ã€‚

```
é—®é¢˜åœºæ™¯ï¼š
æ—¶é—´T1ï¼šæœåŠ¡å™¨Aè·å¾—é”ï¼Œå¼€å§‹å¤„ç†ä¸šåŠ¡
æ—¶é—´T2ï¼šé”è¶…æ—¶è‡ªåŠ¨é‡Šæ”¾ï¼ˆä¸šåŠ¡è¿˜åœ¨æ‰§è¡Œï¼‰
æ—¶é—´T3ï¼šæœåŠ¡å™¨Bè·å¾—ç›¸åŒçš„é”
æ—¶é—´T4ï¼šæœåŠ¡å™¨Aå¤„ç†å®Œæ¯•ï¼Œåˆ é™¤é”
ç»“æœï¼šæœåŠ¡å™¨Aè¯¯åˆ äº†æœåŠ¡å™¨Bçš„é”
```

**å”¯ä¸€æ ‡è¯†è®¾è®¡æ–¹æ¡ˆ**
```java
public class ClientIdGenerator {
    
    // æ–¹æ¡ˆ1ï¼šUUID + çº¿ç¨‹ä¿¡æ¯
    public static String generateUUID() {
        return Thread.currentThread().getName() + "-" + 
               UUID.randomUUID().toString();
    }
    
    // æ–¹æ¡ˆ2ï¼šæœºå™¨æ ‡è¯† + æ—¶é—´æˆ³ + éšæœºæ•°
    public static String generateMachineId() {
        try {
            String hostname = InetAddress.getLocalHost().getHostName();
            long timestamp = System.currentTimeMillis();
            int random = ThreadLocalRandom.current().nextInt(10000);
            return hostname + "-" + timestamp + "-" + random;
        } catch (Exception e) {
            return "unknown-" + System.nanoTime();
        }
    }
    
    // æ–¹æ¡ˆ3ï¼šé›ªèŠ±ç®—æ³•IDï¼ˆæ¨èï¼‰
    public static String generateSnowflakeId() {
        return String.valueOf(SnowflakeIdGenerator.getInstance().nextId());
    }
}

// ä½¿ç”¨ç¤ºä¾‹
String clientId = ClientIdGenerator.generateUUID();
// ç»“æœï¼šmain-550e8400-e29b-41d4-a716-446655440000
```

### 3.3 è¶…æ—¶æœºåˆ¶é˜²æ­»é”


**è¶…æ—¶æ—¶é—´è®¾è®¡**
è¶…æ—¶æœºåˆ¶æ˜¯åˆ†å¸ƒå¼é”çš„å®‰å…¨ç½‘ï¼Œé˜²æ­¢ç¨‹åºå¼‚å¸¸å¯¼è‡´é”æ°¸è¿œæ— æ³•é‡Šæ”¾ã€‚

```
è¶…æ—¶æ—¶é—´è®¡ç®—å…¬å¼ï¼š
é”è¶…æ—¶æ—¶é—´ â‰¥ ä¸šåŠ¡æ‰§è¡Œæ—¶é—´ Ã— å®‰å…¨ç³»æ•°

å®‰å…¨ç³»æ•°å»ºè®®ï¼š
â€¢ å¿«é€Ÿæ“ä½œï¼š1.5å€ï¼ˆå¦‚ç¼“å­˜æ›´æ–°ï¼‰
â€¢ ä¸€èˆ¬ä¸šåŠ¡ï¼š2-3å€ï¼ˆå¦‚è®¢å•å¤„ç†ï¼‰  
â€¢ å¤æ‚ä»»åŠ¡ï¼š3-5å€ï¼ˆå¦‚æ•°æ®å¯¼å‡ºï¼‰

ç¤ºä¾‹ï¼š
è®¢å•å¤„ç†å¹³å‡è€—æ—¶ï¼š5ç§’
é”è¶…æ—¶æ—¶é—´è®¾ç½®ï¼š15ç§’ï¼ˆ5 Ã— 3ï¼‰
```

**è¶…æ—¶æ—¶é—´è®¾ç½®ç­–ç•¥**
```bash
# ä¸åŒä¸šåŠ¡åœºæ™¯çš„è¶…æ—¶è®¾ç½®

# ç¼“å­˜æ›´æ–°ï¼ˆå¿«é€Ÿæ“ä½œï¼‰
SET lock:cache:user:123 "client-1" EX 10 NX

# è®¢å•å¤„ç†ï¼ˆä¸€èˆ¬ä¸šåŠ¡ï¼‰  
SET lock:order:create:456 "client-2" EX 60 NX

# æ•°æ®å¯¼å‡ºï¼ˆé•¿æ—¶é—´ä»»åŠ¡ï¼‰
SET lock:export:report:789 "client-3" EX 1800 NX

# ç§’æ€æ‰£åº“å­˜ï¼ˆæé€Ÿæ“ä½œï¼‰
SET lock:seckill:product:999 "client-4" EX 5 NX
```

### 3.4 é”ç»­æœŸæœºåˆ¶


**ç»­æœŸæœºåˆ¶åŸç†**
é”ç»­æœŸå°±åƒåœè½¦ç»­è´¹ï¼šä¸šåŠ¡è¿˜æ²¡å®Œæˆï¼Œè‡ªåŠ¨å»¶é•¿åœè½¦æ—¶é—´ã€‚

```
é—®é¢˜ï¼šä¸šåŠ¡æ‰§è¡Œæ—¶é—´ä¸å›ºå®š
è®¾ç½®é”è¶…æ—¶ï¼š30ç§’
å®é™…ä¸šåŠ¡è€—æ—¶ï¼š45ç§’
ç»“æœï¼šé”åœ¨ä¸šåŠ¡å®Œæˆå‰å°±å¤±æ•ˆäº†

ç»­æœŸè§£å†³æ–¹æ¡ˆï¼š
1. è®¾ç½®åˆå§‹é”è¶…æ—¶ï¼š30ç§’
2. æ¯éš”20ç§’æ£€æŸ¥ä¸šåŠ¡æ˜¯å¦å®Œæˆ
3. å¦‚æœæœªå®Œæˆï¼Œå»¶é•¿é”æ—¶é—´30ç§’
4. ç›´åˆ°ä¸šåŠ¡å®Œæˆæˆ–æ‰‹åŠ¨é‡Šæ”¾é”
```

**ç»­æœŸæœºåˆ¶å®ç°**
```java
public class LockRenewalManager {
    private ScheduledExecutorService renewalExecutor;
    private Map<String, Future<?>> renewalTasks;
    
    public LockRenewalManager() {
        this.renewalExecutor = Executors.newScheduledThreadPool(5);
        this.renewalTasks = new ConcurrentHashMap<>();
    }
    
    /**
     * è·å–é”å¹¶å¯åŠ¨è‡ªåŠ¨ç»­æœŸ
     */
    public boolean lockWithRenewal(String lockKey, String clientId, int initialExpireSeconds) {
        // 1. è·å–åˆå§‹é”
        String result = jedis.set(lockKey, clientId, "EX", initialExpireSeconds, "NX");
        if (!"OK".equals(result)) {
            return false;
        }
        
        // 2. å¯åŠ¨ç»­æœŸä»»åŠ¡
        int renewInterval = initialExpireSeconds * 2 / 3; // ç»­æœŸé—´éš”ä¸ºè¿‡æœŸæ—¶é—´çš„2/3
        
        Future<?> renewalTask = renewalExecutor.scheduleAtFixedRate(() -> {
            renewLock(lockKey, clientId, initialExpireSeconds);
        }, renewInterval, renewInterval, TimeUnit.SECONDS);
        
        renewalTasks.put(lockKey, renewalTask);
        return true;
    }
    
    /**
     * ç»­æœŸå®ç°ï¼ˆLuaè„šæœ¬ä¿è¯åŸå­æ€§ï¼‰
     */
    private void renewLock(String lockKey, String clientId, int expireSeconds) {
        String luaScript = 
            "if redis.call('GET', KEYS[1]) == ARGV[1] then " +
            "    return redis.call('EXPIRE', KEYS[1], ARGV[2]) " +
            "else " +
            "    return 0 " +
            "end";
        
        try {
            Object result = jedis.eval(luaScript, 
                Collections.singletonList(lockKey),
                Arrays.asList(clientId, String.valueOf(expireSeconds)));
            
            if (!"1".equals(result.toString())) {
                // ç»­æœŸå¤±è´¥ï¼Œåœæ­¢ç»­æœŸä»»åŠ¡
                stopRenewal(lockKey);
            }
        } catch (Exception e) {
            log.error("é”ç»­æœŸå¤±è´¥ï¼š{}", lockKey, e);
            stopRenewal(lockKey);
        }
    }
    
    /**
     * é‡Šæ”¾é”å¹¶åœæ­¢ç»­æœŸ
     */
    public void releaseLock(String lockKey, String clientId) {
        // 1. åœæ­¢ç»­æœŸä»»åŠ¡
        stopRenewal(lockKey);
        
        // 2. é‡Šæ”¾é”
        String luaScript = 
            "if redis.call('GET', KEYS[1]) == ARGV[1] then " +
            "    return redis.call('DEL', KEYS[1]) " +
            "else " +
            "    return 0 " +
            "end";
        
        jedis.eval(luaScript, 
            Collections.singletonList(lockKey),
            Collections.singletonList(clientId));
    }
    
    private void stopRenewal(String lockKey) {
        Future<?> task = renewalTasks.remove(lockKey);
        if (task != null) {
            task.cancel(true);
        }
    }
}
```

---

## 4. ğŸ¯ é«˜çº§å®ç°æŠ€æœ¯


### 4.1 Luaè„šæœ¬ä¿è¯åŸå­æ€§


**ä¸ºä»€ä¹ˆéœ€è¦Luaè„šæœ¬**
Luaè„šæœ¬åœ¨RedisæœåŠ¡å™¨ç«¯æ‰§è¡Œï¼Œä¿è¯æ“ä½œçš„åŸå­æ€§ï¼Œå°±åƒé“¶è¡Œçš„ç‚¹é’æœºï¼šä¸€æ—¦å¼€å§‹å·¥ä½œå°±ä¸èƒ½è¢«æ‰“æ–­ã€‚

```
åˆ†æ­¥æ“ä½œçš„é—®é¢˜ï¼š
1. GET lock:key        # æ£€æŸ¥é”çš„æŒæœ‰è€…
2. åˆ¤æ–­æ˜¯å¦ä¸ºå½“å‰å®¢æˆ·ç«¯
3. DEL lock:key        # åˆ é™¤é”

é£é™©ï¼šæ­¥éª¤2å’Œ3ä¹‹é—´ï¼Œå…¶ä»–å®¢æˆ·ç«¯å¯èƒ½è·å¾—äº†é”
ç»“æœï¼šè¯¯åˆ åˆ«äººçš„é”

Luaè„šæœ¬è§£å†³ï¼š
æ•´ä¸ªæ£€æŸ¥å’Œåˆ é™¤è¿‡ç¨‹åœ¨æœåŠ¡å™¨ç«¯åŸå­æ‰§è¡Œ
ä¸­é—´ä¸ä¼šè¢«å…¶ä»–æ“ä½œæ‰“æ–­
```

**SETNX + EX + LuaåŸå­æ€§å®ç°**
```lua
-- è·å–é”çš„Luaè„šæœ¬
local key = KEYS[1]
local value = ARGV[1] 
local expire = ARGV[2]

local result = redis.call('SET', key, value, 'EX', expire, 'NX')
if result then
    return 1
else
    return 0
end
```

**SETNX + Luaè§£é”å®ç°**
```lua
-- å®‰å…¨é‡Šæ”¾é”çš„Luaè„šæœ¬
local key = KEYS[1]
local expected_value = ARGV[1]

-- æ£€æŸ¥é”æ˜¯å¦ä¸ºå½“å‰å®¢æˆ·ç«¯æŒæœ‰
local current_value = redis.call('GET', key)
if current_value == expected_value then
    -- æ˜¯è‡ªå·±çš„é”ï¼Œå¯ä»¥åˆ é™¤
    return redis.call('DEL', key)
else
    -- ä¸æ˜¯è‡ªå·±çš„é”ï¼Œä¸èƒ½åˆ é™¤
    return 0
end
```

**Javaä¸­ä½¿ç”¨Luaè„šæœ¬**
```java
public class LuaScriptLock {
    private static final String RELEASE_LOCK_SCRIPT = 
        "if redis.call('GET', KEYS[1]) == ARGV[1] then " +
        "    return redis.call('DEL', KEYS[1]) " +
        "else " +
        "    return 0 " +
        "end";
    
    /**
     * å®‰å…¨é‡Šæ”¾é”
     */
    public boolean releaseLock(String lockKey, String clientId) {
        Object result = jedis.eval(RELEASE_LOCK_SCRIPT,
            Collections.singletonList(lockKey),
            Collections.singletonList(clientId));
        
        return Long.valueOf(1).equals(result);
    }
    
    /**
     * å®Œæ•´çš„åŠ é”è§£é”æµç¨‹
     */
    public void safeDistributedLock(String resource) {
        String lockKey = "lock:" + resource;
        String clientId = generateClientId();
        
        try {
            // è·å–é”
            String result = jedis.set(lockKey, clientId, "EX", 30, "NX");
            if (!"OK".equals(result)) {
                throw new LockAcquisitionException("è·å–é”å¤±è´¥");
            }
            
            // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
            doBusinessLogic();
            
        } finally {
            // å®‰å…¨é‡Šæ”¾é”
            boolean released = releaseLock(lockKey, clientId);
            if (!released) {
                log.warn("é”å·²è¢«å…¶ä»–å®¢æˆ·ç«¯æŒæœ‰æˆ–å·²è¿‡æœŸï¼š{}", lockKey);
            }
        }
    }
}
```

### 4.2 å¯é‡å…¥é”è®¾è®¡


**å¯é‡å…¥é”æ¦‚å¿µ**
å¯é‡å…¥é”å…è®¸åŒä¸€çº¿ç¨‹å¤šæ¬¡è·å–åŒä¸€æŠŠé”ï¼Œå°±åƒä½ æ‹¿ç€å®¶é—¨é’¥åŒ™ï¼Œå¯ä»¥å¤šæ¬¡å¼€é—¨è¿›å‡ºã€‚

```
ä¸å¯é‡å…¥é”çš„é—®é¢˜ï¼š
methodA() {
    è·å–é”("lock:user:123")
    methodB()  // è°ƒç”¨å…¶ä»–æ–¹æ³•
    é‡Šæ”¾é”("lock:user:123")
}

methodB() {
    è·å–é”("lock:user:123")  // æ­»é”ï¼å› ä¸ºé”å·²è¢«methodAæŒæœ‰
    // ä¸šåŠ¡é€»è¾‘
    é‡Šæ”¾é”("lock:user:123")
}

å¯é‡å…¥é”çš„è§£å†³ï¼š
åŒä¸€çº¿ç¨‹å¯ä»¥å¤šæ¬¡è·å–ç›¸åŒçš„é”
æ¯æ¬¡è·å–å¢åŠ è®¡æ•°ï¼Œæ¯æ¬¡é‡Šæ”¾å‡å°‘è®¡æ•°
è®¡æ•°ä¸º0æ—¶æ‰çœŸæ­£é‡Šæ”¾é”
```

**å¯é‡å…¥é”å®ç°**
```java
public class ReentrantDistributedLock {
    private static final String REENTRANT_LOCK_SCRIPT = 
        // å¦‚æœé”ä¸å­˜åœ¨ï¼Œè®¾ç½®é”å¹¶è®¡æ•°ä¸º1
        "if redis.call('EXISTS', KEYS[1]) == 0 then " +
        "    redis.call('HSET', KEYS[1], ARGV[1], 1) " +
        "    redis.call('EXPIRE', KEYS[1], ARGV[2]) " +
        "    return 1 " +
        "end " +
        
        // å¦‚æœé”å­˜åœ¨ä¸”ä¸ºå½“å‰å®¢æˆ·ç«¯æŒæœ‰ï¼Œå¢åŠ é‡å…¥è®¡æ•°
        "if redis.call('HGET', KEYS[1], ARGV[1]) then " +
        "    redis.call('HINCRBY', KEYS[1], ARGV[1], 1) " +
        "    redis.call('EXPIRE', KEYS[1], ARGV[2]) " +
        "    return 1 " +
        "end " +
        
        // é”è¢«å…¶ä»–å®¢æˆ·ç«¯æŒæœ‰
        "return 0";
    
    private static final String REENTRANT_UNLOCK_SCRIPT = 
        // æ£€æŸ¥é”æ˜¯å¦ä¸ºå½“å‰å®¢æˆ·ç«¯æŒæœ‰
        "local count = redis.call('HGET', KEYS[1], ARGV[1]) " +
        "if count == false then " +
        "    return 0 " +
        "end " +
        
        // å‡å°‘é‡å…¥è®¡æ•°
        "count = count - 1 " +
        "if count > 0 then " +
        "    redis.call('HSET', KEYS[1], ARGV[1], count) " +
        "    return 0 " +
        "else " +
        "    redis.call('DEL', KEYS[1]) " +
        "    return 1 " +
        "end";
    
    public boolean lock(String lockKey, String clientId, int expireTime) {
        Object result = jedis.eval(REENTRANT_LOCK_SCRIPT,
            Collections.singletonList(lockKey),
            Arrays.asList(clientId, String.valueOf(expireTime)));
        
        return Long.valueOf(1).equals(result);
    }
    
    public boolean unlock(String lockKey, String clientId) {
        Object result = jedis.eval(REENTRANT_UNLOCK_SCRIPT,
            Collections.singletonList(lockKey),
            Collections.singletonList(clientId));
        
        return Long.valueOf(1).equals(result);
    }
}
```

### 4.3 é”ç›‘æ§æœºåˆ¶


**é”çŠ¶æ€ç›‘æ§**
```java
public class DistributedLockMonitor {
    
    /**
     * è·å–æ‰€æœ‰åˆ†å¸ƒå¼é”çš„çŠ¶æ€
     */
    public List<LockInfo> getAllLockStatus() {
        Set<String> lockKeys = jedis.keys("lock:*");
        List<LockInfo> lockInfos = new ArrayList<>();
        
        for (String lockKey : lockKeys) {
            LockInfo info = new LockInfo();
            info.setKey(lockKey);
            info.setHolder(jedis.get(lockKey));
            info.setTtl(jedis.ttl(lockKey));
            info.setCreateTime(extractCreateTime(lockKey));
            
            lockInfos.add(info);
        }
        
        return lockInfos;
    }
    
    /**
     * æ£€æµ‹é•¿æ—¶é—´æŒæœ‰çš„é”
     */
    @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    public void detectLongHeldLocks() {
        List<LockInfo> locks = getAllLockStatus();
        
        for (LockInfo lock : locks) {
            long holdTime = System.currentTimeMillis() - lock.getCreateTime();
            
            if (holdTime > 300000) { // è¶…è¿‡5åˆ†é’Ÿ
                log.warn("æ£€æµ‹åˆ°é•¿æ—¶é—´æŒæœ‰çš„é”ï¼š{}, æŒæœ‰æ—¶é—´ï¼š{}ç§’", 
                    lock.getKey(), holdTime / 1000);
                
                // å‘é€å‘Šè­¦
                sendAlert("é•¿æ—¶é—´æŒé”å‘Šè­¦", lock);
            }
        }
    }
    
    /**
     * ç»Ÿè®¡é”çš„ç«äº‰æƒ…å†µ
     */
    public LockCompetitionStats getLockCompetitionStats(String lockPattern) {
        // ç»Ÿè®¡æŒ‡å®šæ¨¡å¼é”çš„ç«äº‰æ¿€çƒˆç¨‹åº¦
        return calculateCompetitionStats(lockPattern);
    }
    
    /**
     * å¼ºåˆ¶é‡Šæ”¾é”ï¼ˆç®¡ç†å‘˜æ“ä½œï¼‰
     */
    public boolean forceReleaseLock(String lockKey, String reason) {
        log.warn("ç®¡ç†å‘˜å¼ºåˆ¶é‡Šæ”¾é”ï¼š{}, åŸå› ï¼š{}", lockKey, reason);
        return jedis.del(lockKey) > 0;
    }
}
```

---

## 5. ğŸ² Redlockç®—æ³•è¯¦è§£


### 5.1 å¤šå®ä¾‹åŠ é”ç­–ç•¥


**RedlockèƒŒæ™¯**
å•Rediså®ä¾‹å­˜åœ¨å•ç‚¹æ•…éšœé£é™©ï¼ŒRedlocké€šè¿‡å¤šä¸ªRediså®ä¾‹æä¾›æ›´é«˜çš„å¯ç”¨æ€§ã€‚

```
å•å®ä¾‹é£é™©ï¼š
Redisä¸»æœºå®•æœº â†’ æ‰€æœ‰é”ä¸¢å¤± â†’ å¤šå®¢æˆ·ç«¯åŒæ—¶è·å¾—é”

ä¸»ä»å¤åˆ¶é£é™©ï¼š  
ä¸»èŠ‚ç‚¹è®¾ç½®é” â†’ å¼‚æ­¥å¤åˆ¶ç»™ä»èŠ‚ç‚¹ â†’ ä¸»èŠ‚ç‚¹å®•æœº â†’ ä»èŠ‚ç‚¹å‡ä¸» â†’ é”ä¸¢å¤±

Redlockè§£å†³æ€è·¯ï¼š
ä½¿ç”¨å¤šä¸ªå®Œå…¨ç‹¬ç«‹çš„Rediså®ä¾‹ï¼ˆé€šå¸¸3ä¸ªæˆ–5ä¸ªï¼‰
åªæœ‰åœ¨å¤§å¤šæ•°å®ä¾‹ä¸Šéƒ½æˆåŠŸåŠ é”æ‰è®¤ä¸ºè·é”æˆåŠŸ
```

**å¤šå®ä¾‹æ¶æ„è®¾è®¡**
```
Redlockæ ‡å‡†é…ç½®ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å®¢æˆ·ç«¯     â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚ å¹¶è¡Œè¯·æ±‚é”
   â”Œâ”€â”€â”´â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”
   â”‚     â”‚      â”‚      â”‚
â”Œâ”€â”€â–¼â”€â”€â”â”Œâ–¼â”€â”€â”€â”€â”â”Œâ–¼â”€â”€â”€â”€â”â”Œâ–¼â”€â”€â”€â”€â”â”Œâ–¼â”€â”€â”€â”€â”
â”‚Redisâ”‚â”‚Redisâ”‚â”‚Redisâ”‚â”‚Redisâ”‚â”‚Redisâ”‚
â”‚ #1  â”‚â”‚ #2  â”‚â”‚ #3  â”‚â”‚ #4  â”‚â”‚ #5  â”‚
â””â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”˜

è¦æ±‚ï¼šè‡³å°‘3ä¸ªæˆåŠŸæ‰ç®—è·é”æˆåŠŸï¼ˆ5ä¸ªå®ä¾‹çš„è¿‡åŠæ•°ï¼‰
```

### 5.2 è¿‡åŠæ•°æˆåŠŸåŸåˆ™


**è¿‡åŠæ•°åŸåˆ™çš„æ•°å­¦åŸºç¡€**
```
ä¸ºä»€ä¹ˆæ˜¯è¿‡åŠæ•°ï¼Ÿ
â€¢ Nä¸ªRediså®ä¾‹ï¼Œè‡³å°‘éœ€è¦ âŒŠN/2âŒ‹ + 1 ä¸ªæˆåŠŸ
â€¢ 3ä¸ªå®ä¾‹ï¼šè‡³å°‘2ä¸ªæˆåŠŸ
â€¢ 5ä¸ªå®ä¾‹ï¼šè‡³å°‘3ä¸ªæˆåŠŸ

å®‰å…¨æ€§è¯æ˜ï¼š
å¦‚æœæœ‰ä¸¤ä¸ªå®¢æˆ·ç«¯Aå’ŒBåŒæ—¶å°è¯•è·å–é”ï¼š
â€¢ å®¢æˆ·ç«¯Aæœ€å¤šè·å¾—Nä¸ªé”
â€¢ å®¢æˆ·ç«¯Bæœ€å¤šè·å¾—Nä¸ªé”
â€¢ ä½†Aå’ŒBä¸å¯èƒ½éƒ½è¾¾åˆ°è¿‡åŠæ•°
â€¢ å› ä¸º âŒŠN/2âŒ‹ + 1 + âŒŠN/2âŒ‹ + 1 > N

ç¤ºä¾‹ï¼ˆ5ä¸ªå®ä¾‹ï¼‰ï¼š
å®¢æˆ·ç«¯Aè·å¾—3ä¸ªé” â†’ æ»¡è¶³æ¡ä»¶ âœ…  
å®¢æˆ·ç«¯Bæœ€å¤šè·å¾—2ä¸ªé” â†’ ä¸æ»¡è¶³æ¡ä»¶ âŒ
```

**è¿‡åŠæ•°æˆåŠŸåˆ¤æ–­**
```java
public class RedlockImplementation {
    private List<Jedis> redisInstances;
    private final int instanceCount;
    private final int quorum; // è¿‡åŠæ•°æ•°é‡
    
    public RedlockImplementation(List<String> redisUrls) {
        this.instanceCount = redisUrls.size();
        this.quorum = instanceCount / 2 + 1; // è¿‡åŠæ•°è®¡ç®—
        
        // åˆå§‹åŒ–Rediså®ä¾‹è¿æ¥
        this.redisInstances = new ArrayList<>();
        for (String url : redisUrls) {
            redisInstances.add(new Jedis(url));
        }
    }
    
    public boolean redlock(String resource, String value, int ttlMillis) {
        long startTime = System.currentTimeMillis();
        int successCount = 0;
        
        // 1. å¹¶è¡Œå‘æ‰€æœ‰å®ä¾‹è¯·æ±‚é”
        for (Jedis jedis : redisInstances) {
            try {
                String result = jedis.set(resource, value, "PX", ttlMillis, "NX");
                if ("OK".equals(result)) {
                    successCount++;
                }
            } catch (Exception e) {
                // å®ä¾‹ä¸å¯ç”¨ï¼Œç»§ç»­å°è¯•å…¶ä»–å®ä¾‹
                log.warn("Rediså®ä¾‹ä¸å¯ç”¨ï¼š{}", jedis.toString());
            }
        }
        
        // 2. è®¡ç®—è·é”è€—æ—¶
        long elapsedTime = System.currentTimeMillis() - startTime;
        
        // 3. åˆ¤æ–­æ˜¯å¦æ»¡è¶³æˆåŠŸæ¡ä»¶
        boolean lockAcquired = (successCount >= quorum) && 
                              (elapsedTime < ttlMillis);
        
        if (lockAcquired) {
            // è®¡ç®—é”çš„æœ‰æ•ˆæ—¶é—´
            long validityTime = ttlMillis - elapsedTime;
            log.info("Redlockè·å–æˆåŠŸï¼Œæœ‰æ•ˆæ—¶é—´ï¼š{}ms", validityTime);
            return true;
        } else {
            // è·é”å¤±è´¥ï¼Œé‡Šæ”¾å·²è·å¾—çš„é”
            releaseRedlock(resource, value);
            return false;
        }
    }
}
```

### 5.3 æ—¶é’Ÿæ¼‚ç§»å¤„ç†


**æ—¶é’Ÿæ¼‚ç§»é—®é¢˜**
åˆ†å¸ƒå¼ç¯å¢ƒä¸­ä¸åŒæœåŠ¡å™¨çš„æ—¶é’Ÿå¯èƒ½ä¸åŒæ­¥ï¼Œå½±å“é”çš„æœ‰æ•ˆæœŸåˆ¤æ–­ã€‚

```
æ—¶é’Ÿæ¼‚ç§»åœºæ™¯ï¼š
æœåŠ¡å™¨Aæ—¶é—´ï¼š12:00:00
æœåŠ¡å™¨Bæ—¶é—´ï¼š12:00:03 ï¼ˆå¿«3ç§’ï¼‰  
RedisæœåŠ¡å™¨ï¼š12:00:01 ï¼ˆå¿«1ç§’ï¼‰

è®¾ç½®30ç§’é”ï¼š
â€¢ å®¢æˆ·ç«¯è®¤ä¸ºé”30ç§’åè¿‡æœŸ
â€¢ Rediså®é™…ä¸Šå¯èƒ½29ç§’å°±è¿‡æœŸäº†
â€¢ æ—¶é’Ÿä¸ä¸€è‡´å¯¼è‡´é”æå‰å¤±æ•ˆ
```

**æ—¶é’Ÿæ¼‚ç§»åº”å¯¹ç­–ç•¥**
```java
public class ClockDriftHandler {
    private static final int CLOCK_DRIFT_FACTOR = 10; // æ—¶é’Ÿæ¼‚ç§»å®¹é”™æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
    
    public boolean redlockWithDriftTolerance(String resource, String value, int ttlMillis) {
        long startTime = System.currentTimeMillis();
        int successCount = 0;
        
        // è·å–é”çš„è¿‡ç¨‹...
        for (Jedis jedis : redisInstances) {
            // è·é”é€»è¾‘
        }
        
        long elapsedTime = System.currentTimeMillis() - startTime;
        
        // è€ƒè™‘æ—¶é’Ÿæ¼‚ç§»çš„æœ‰æ•ˆæ—¶é—´è®¡ç®—
        long validityTime = ttlMillis - elapsedTime - CLOCK_DRIFT_FACTOR;
        
        boolean lockValid = (successCount >= quorum) && (validityTime > 0);
        
        if (lockValid) {
            log.info("è€ƒè™‘æ—¶é’Ÿæ¼‚ç§»åï¼Œé”çš„å®é™…æœ‰æ•ˆæ—¶é—´ï¼š{}ms", validityTime);
            return true;
        }
        
        return false;
    }
}
```

**æ—¶é’ŸåŒæ­¥å»ºè®®**
```bash
# ç”Ÿäº§ç¯å¢ƒæ—¶é’ŸåŒæ­¥
# 1. å®‰è£…NTPæœåŠ¡
sudo apt-get install ntp

# 2. é…ç½®NTPæœåŠ¡å™¨
sudo vim /etc/ntp.conf
server pool.ntp.org iburst

# 3. å¯åŠ¨NTPåŒæ­¥
sudo systemctl start ntp
sudo systemctl enable ntp

# 4. æ£€æŸ¥æ—¶é’ŸåŒæ­¥çŠ¶æ€
ntpq -p
```

---

## 6. ğŸš€ Redissonæ¡†æ¶å®æˆ˜


### 6.1 Redissonåˆ†å¸ƒå¼é”ä»‹ç»


**Redissonæ¡†æ¶ä¼˜åŠ¿**
Redissonæ˜¯Redisçš„è±ªåç‰ˆå®¢æˆ·ç«¯ï¼ŒæŠŠå¤æ‚çš„åˆ†å¸ƒå¼é”é€»è¾‘å°è£…æˆç®€å•æ˜“ç”¨çš„APIã€‚

```
æ‰‹åŠ¨å®ç°çš„ç—›ç‚¹ï¼š
â€¢ éœ€è¦ç¼–å†™å¤§é‡Luaè„šæœ¬
â€¢ é”ç»­æœŸé€»è¾‘å¤æ‚
â€¢ å¼‚å¸¸å¤„ç†ç¹ç
â€¢ å¯é‡å…¥é”å®ç°å›°éš¾

Redissonçš„ä¼˜åŠ¿ï¼š
â€¢ å¼€ç®±å³ç”¨ï¼ŒAPIç®€æ´
â€¢ è‡ªåŠ¨ç»­æœŸæœºåˆ¶ï¼ˆWatchDogï¼‰
â€¢ å†…ç½®å¯é‡å…¥é”æ”¯æŒ
â€¢ å®Œå–„çš„å¼‚å¸¸å¤„ç†
â€¢ å¤šç§é”ç±»å‹æ”¯æŒ
```

### 6.2 Redissonæ¡†æ¶çš„é”å®ç°


**åŸºç¡€é…ç½®å’Œä½¿ç”¨**
```java
// 1. Mavenä¾èµ–
<dependency>
    <groupId>org.redisson</groupId>
    <artifactId>redisson</artifactId>
    <version>3.17.7</version>
</dependency>

// 2. é…ç½®Redissonå®¢æˆ·ç«¯
@Configuration
public class RedissonConfig {
    
    @Bean
    public RedissonClient redissonClient() {
        Config config = new Config();
        config.useSingleServer()
            .setAddress("redis://localhost:6379")
            .setPassword("your-password")
            .setConnectionMinimumIdleSize(5)
            .setConnectionPoolSize(20)
            .setConnectTimeout(3000)
            .setTimeout(5000);
        
        return Redisson.create(config);
    }
}
```

**åŸºæœ¬é”ä½¿ç”¨**
```java
@Service
public class RedissonLockService {
    @Autowired
    private RedissonClient redisson;
    
    public void processWithLock(String resourceId) {
        // è·å–åˆ†å¸ƒå¼é”å¯¹è±¡
        RLock lock = redisson.getLock("lock:" + resourceId);
        
        try {
            // å°è¯•åŠ é”ï¼šç­‰å¾…æ—¶é—´5ç§’ï¼Œé”è¶…æ—¶30ç§’
            boolean isLocked = lock.tryLock(5, 30, TimeUnit.SECONDS);
            
            if (isLocked) {
                // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
                log.info("è·å¾—é”ï¼Œå¼€å§‹å¤„ç†ä¸šåŠ¡ï¼š{}", resourceId);
                processBusinessLogic(resourceId);
            } else {
                log.warn("è·å–é”è¶…æ—¶ï¼Œèµ„æºæ­£åœ¨è¢«å¤„ç†ï¼š{}", resourceId);
            }
            
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            log.error("é”ç­‰å¾…è¢«ä¸­æ–­", e);
        } finally {
            // æ£€æŸ¥æ˜¯å¦ä¸ºå½“å‰çº¿ç¨‹æŒæœ‰ï¼Œé¿å…è¯¯è§£é”
            if (lock.isHeldByCurrentThread()) {
                lock.unlock();
                log.info("é‡Šæ”¾é”ï¼š{}", resourceId);
            }
        }
    }
}
```

### 6.3 Redissonç»­æœŸæœºåˆ¶ï¼ˆWatchDogï¼‰


**WatchDogè‡ªåŠ¨ç»­æœŸåŸç†**
```
WatchDogå·¥ä½œæœºåˆ¶ï¼š
1. è·å–é”æ—¶ä¸æŒ‡å®šè¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤30ç§’
2. å¯åŠ¨å®šæ—¶ä»»åŠ¡ï¼Œæ¯10ç§’æ£€æŸ¥ä¸€æ¬¡
3. å¦‚æœä¸šåŠ¡çº¿ç¨‹è¿˜æŒæœ‰é”ï¼Œè‡ªåŠ¨ç»­æœŸ30ç§’
4. ä¸šåŠ¡å®Œæˆé‡Šæ”¾é”æ—¶ï¼Œåœæ­¢ç»­æœŸä»»åŠ¡

ç»­æœŸæ—¶é—´çº¿ï¼š
T0: è·å¾—é”ï¼Œè®¾ç½®30ç§’è¿‡æœŸ
T10: WatchDogæ£€æŸ¥ â†’ ä¸šåŠ¡æœªå®Œæˆ â†’ ç»­æœŸè‡³T40
T20: WatchDogæ£€æŸ¥ â†’ ä¸šåŠ¡æœªå®Œæˆ â†’ ç»­æœŸè‡³T50  
T25: ä¸šåŠ¡å®Œæˆï¼Œé‡Šæ”¾é” â†’ åœæ­¢WatchDog
```

**WatchDogä½¿ç”¨ç¤ºä¾‹**
```java
public void longRunningTaskWithWatchDog() {
    RLock lock = redisson.getLock("lock:long:task");
    
    try {
        // ä¸æŒ‡å®šè¶…æ—¶æ—¶é—´ï¼Œå¯ç”¨WatchDogè‡ªåŠ¨ç»­æœŸ
        lock.lock();
        
        log.info("å¼€å§‹æ‰§è¡Œé•¿æ—¶é—´ä»»åŠ¡ï¼ŒWatchDogå°†è‡ªåŠ¨ç»­æœŸ");
        
        // æ¨¡æ‹Ÿé•¿æ—¶é—´ä¸šåŠ¡å¤„ç†ï¼ˆå¯èƒ½è¶…è¿‡30ç§’ï¼‰
        for (int i = 0; i < 100; i++) {
            Thread.sleep(1000); // æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç†
            log.info("å¤„ç†è¿›åº¦ï¼š{}%", i + 1);
        }
        
        log.info("é•¿æ—¶é—´ä»»åŠ¡å®Œæˆ");
        
    } catch (InterruptedException e) {
        Thread.currentThread().interrupt();
    } finally {
        // é‡Šæ”¾é”ï¼ŒWatchDogè‡ªåŠ¨åœæ­¢ç»­æœŸ
        if (lock.isHeldByCurrentThread()) {
            lock.unlock();
        }
    }
}
```

### 6.4 Redissoné«˜çº§åˆ†å¸ƒå¼é”å®è·µ


**å¤šç§é”ç±»å‹æ”¯æŒ**
```java
public class RedissonAdvancedLocks {
    @Autowired
    private RedissonClient redisson;
    
    // 1. å¯é‡å…¥é”ï¼ˆæœ€å¸¸ç”¨ï¼‰
    public void reentrantLockDemo() {
        RLock lock = redisson.getLock("reentrant:lock");
        // æ”¯æŒåŒä¸€çº¿ç¨‹å¤šæ¬¡åŠ é”
    }
    
    // 2. å…¬å¹³é”ï¼ˆæŒ‰è¯·æ±‚é¡ºåºè·å¾—é”ï¼‰
    public void fairLockDemo() {
        RLock fairLock = redisson.getFairLock("fair:lock");
        // å…ˆè¯·æ±‚çš„çº¿ç¨‹å…ˆè·å¾—é”
    }
    
    // 3. å¤šé‡é”ï¼ˆåŒæ—¶é”å®šå¤šä¸ªèµ„æºï¼‰
    public void multiLockDemo() {
        RLock lock1 = redisson.getLock("lock:resource1");
        RLock lock2 = redisson.getLock("lock:resource2");
        RLock lock3 = redisson.getLock("lock:resource3");
        
        RLock multiLock = redisson.getMultiLock(lock1, lock2, lock3);
        // å¿…é¡»åŒæ—¶è·å¾—æ‰€æœ‰é”æ‰æˆåŠŸ
    }
    
    // 4. çº¢é”ï¼ˆRedlockå®ç°ï¼‰
    public void redLockDemo() {
        RLock lock1 = redisson.getLock("redlock:resource");
        RLock lock2 = redisson2.getLock("redlock:resource"); // ä¸åŒRediså®ä¾‹
        RLock lock3 = redisson3.getLock("redlock:resource");
        
        RLock redLock = redisson.getRedLock(lock1, lock2, lock3);
        // Redlockç®—æ³•å®ç°
    }
}
```

---

## 7. ğŸ’¼ å®æˆ˜åº”ç”¨åœºæ™¯


### 7.1 é˜²é‡å¤æäº¤


**é˜²é‡å¤æäº¤å®ç°**
```java
@RestController
public class OrderController {
    @Autowired
    private RedissonClient redisson;
    @Autowired
    private OrderService orderService;
    
    @PostMapping("/order/create")
    public ResponseEntity<String> createOrder(@RequestBody OrderRequest request, 
                                            HttpServletRequest httpRequest) {
        // åŸºäºç”¨æˆ·IDå’Œè¯·æ±‚å‚æ•°ç”Ÿæˆé”key
        String userId = getCurrentUserId();
        String requestHash = calculateRequestHash(request);
        String lockKey = String.format("lock:order:submit:%s:%s", userId, requestHash);
        
        RLock lock = redisson.getLock(lockKey);
        
        try {
            // å°è¯•è·é”ï¼Œç­‰å¾…1ç§’ï¼Œé”æœ‰æ•ˆæœŸ10ç§’
            boolean isLocked = lock.tryLock(1, 10, TimeUnit.SECONDS);
            
            if (!isLocked) {
                return ResponseEntity.badRequest()
                    .body("è®¢å•æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·å‹¿é‡å¤æäº¤");
            }
            
            // æ‰§è¡Œè®¢å•åˆ›å»º
            String orderId = orderService.createOrder(userId, request);
            return ResponseEntity.ok("è®¢å•åˆ›å»ºæˆåŠŸï¼š" + orderId);
            
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            return ResponseEntity.status(500).body("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
        } finally {
            if (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
    }
}
```

### 7.2 åº“å­˜æ‰£å‡åœºæ™¯


**ç”µå•†åº“å­˜æ‰£å‡å®ç°**
```java
@Service
public class InventoryService {
    @Autowired
    private RedissonClient redisson;
    
    /**
     * æ‰£å‡åº“å­˜ï¼ˆé˜²æ­¢è¶…å–ï¼‰
     */
    public boolean reduceInventory(String productId, int quantity) {
        String lockKey = "lock:inventory:" + productId;
        RLock lock = redisson.getLock(lockKey);
        
        try {
            // åº“å­˜æ“ä½œè¦å¿«ï¼Œç­‰å¾…æ—¶é—´çŸ­
            boolean isLocked = lock.tryLock(1, 5, TimeUnit.SECONDS);
            
            if (!isLocked) {
                log.warn("å•†å“{}åº“å­˜é”ç«äº‰æ¿€çƒˆï¼Œè·é”å¤±è´¥", productId);
                return false;
            }
            
            // æŸ¥è¯¢å½“å‰åº“å­˜
            Integer currentStock = getStockFromCache(productId);
            if (currentStock == null) {
                currentStock = getStockFromDatabase(productId);
            }
            
            // æ£€æŸ¥åº“å­˜æ˜¯å¦å……è¶³
            if (currentStock < quantity) {
                log.info("å•†å“{}åº“å­˜ä¸è¶³ï¼Œå½“å‰åº“å­˜ï¼š{}ï¼Œéœ€è¦ï¼š{}", 
                    productId, currentStock, quantity);
                return false;
            }
            
            // æ‰£å‡åº“å­˜
            int newStock = currentStock - quantity;
            
            // æ›´æ–°æ•°æ®åº“
            boolean dbSuccess = updateStockInDatabase(productId, newStock);
            if (!dbSuccess) {
                return false;
            }
            
            // æ›´æ–°ç¼“å­˜
            updateStockCache(productId, newStock);
            
            log.info("åº“å­˜æ‰£å‡æˆåŠŸï¼Œå•†å“ï¼š{}ï¼Œæ‰£å‡ï¼š{}ï¼Œå‰©ä½™ï¼š{}", 
                productId, quantity, newStock);
            return true;
            
        } catch (Exception e) {
            log.error("åº“å­˜æ‰£å‡å¼‚å¸¸ï¼Œå•†å“ï¼š" + productId, e);
            return false;
        } finally {
            if (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
    }
}
```

### 7.3 å®šæ—¶ä»»åŠ¡äº’æ–¥


**å®šæ—¶ä»»åŠ¡åˆ†å¸ƒå¼é”**
```java
@Component
public class ScheduledTaskService {
    @Autowired
    private RedissonClient redisson;
    
    /**
     * æ•°æ®æ¸…ç†ä»»åŠ¡ï¼ˆé˜²æ­¢å¤šå®ä¾‹é‡å¤æ‰§è¡Œï¼‰
     */
    @Scheduled(cron = "0 0 2 * * ?") // æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
    public void cleanupExpiredData() {
        String lockKey = "lock:task:cleanup:expired";
        RLock lock = redisson.getLock(lockKey);
        
        try {
            // ä¸ç­‰å¾…ï¼Œé”æœ‰æ•ˆæœŸ1å°æ—¶
            boolean isLocked = lock.tryLock(0, 3600, TimeUnit.SECONDS);
            
            if (!isLocked) {
                log.info("æ•°æ®æ¸…ç†ä»»åŠ¡æ­£åœ¨å…¶ä»–èŠ‚ç‚¹æ‰§è¡Œï¼Œè·³è¿‡æœ¬æ¬¡æ‰§è¡Œ");
                return;
            }
            
            log.info("å¼€å§‹æ‰§è¡Œæ•°æ®æ¸…ç†ä»»åŠ¡");
            long startTime = System.currentTimeMillis();
            
            // æ‰§è¡Œæ¸…ç†é€»è¾‘
            int deletedCount = performDataCleanup();
            
            long duration = System.currentTimeMillis() - startTime;
            log.info("æ•°æ®æ¸…ç†å®Œæˆï¼Œåˆ é™¤{}æ¡è®°å½•ï¼Œè€—æ—¶{}ms", deletedCount, duration);
            
        } catch (Exception e) {
            log.error("æ•°æ®æ¸…ç†ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸", e);
        } finally {
            if (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
    }
    
    /**
     * æŠ¥è¡¨ç”Ÿæˆä»»åŠ¡
     */
    @Scheduled(fixedRate = 1800000) // æ¯30åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
    public void generateReport() {
        String lockKey = "lock:task:report:generate";
        RLock lock = redisson.getLock(lockKey);
        
        try {
            boolean isLocked = lock.tryLock(5, 1500, TimeUnit.SECONDS);
            
            if (isLocked) {
                log.info("å¼€å§‹ç”ŸæˆæŠ¥è¡¨");
                generateBusinessReport();
                log.info("æŠ¥è¡¨ç”Ÿæˆå®Œæˆ");
            }
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        } finally {
            if (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
    }
}
```

### 7.4 èµ„æºç‹¬å è®¿é—®æ§åˆ¶


**å…±äº«èµ„æºç‹¬å è®¿é—®**
```java
@Service
public class FileProcessService {
    @Autowired  
    private RedissonClient redisson;
    
    /**
     * æ–‡ä»¶å¤„ç†ï¼ˆç¡®ä¿åŒæ—¶åªæœ‰ä¸€ä¸ªæœåŠ¡å¤„ç†åŒä¸€æ–‡ä»¶ï¼‰
     */
    public boolean processFile(String fileName) {
        String lockKey = "lock:file:process:" + fileName;
        RLock lock = redisson.getLock(lockKey);
        
        try {
            // æ–‡ä»¶å¤„ç†å¯èƒ½è€—æ—¶è¾ƒé•¿ï¼Œè®¾ç½®10åˆ†é’Ÿè¶…æ—¶
            boolean isLocked = lock.tryLock(2, 600, TimeUnit.SECONDS);
            
            if (!isLocked) {
                log.warn("æ–‡ä»¶{}æ­£åœ¨è¢«å…¶ä»–æœåŠ¡å¤„ç†", fileName);
                return false;
            }
            
            log.info("å¼€å§‹å¤„ç†æ–‡ä»¶ï¼š{}", fileName);
            
            // æ£€æŸ¥æ–‡ä»¶çŠ¶æ€
            if (isFileAlreadyProcessed(fileName)) {
                log.info("æ–‡ä»¶{}å·²å¤„ç†å®Œæˆï¼Œè·³è¿‡", fileName);
                return true;
            }
            
            // æ‰§è¡Œæ–‡ä»¶å¤„ç†
            FileProcessResult result = doFileProcess(fileName);
            
            // æ ‡è®°æ–‡ä»¶å¤„ç†å®Œæˆ
            markFileAsProcessed(fileName, result);
            
            log.info("æ–‡ä»¶å¤„ç†å®Œæˆï¼š{}ï¼Œç»“æœï¼š{}", fileName, result);
            return true;
            
        } catch (Exception e) {
            log.error("æ–‡ä»¶å¤„ç†å¤±è´¥ï¼š" + fileName, e);
            return false;
        } finally {
            if (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
    }
    
    /**
     * é…ç½®æ›´æ–°ï¼ˆç¡®ä¿é…ç½®æ›´æ–°çš„ä¸€è‡´æ€§ï¼‰
     */
    public boolean updateGlobalConfig(String configKey, String configValue) {
        String lockKey = "lock:config:update:" + configKey;
        RLock lock = redisson.getLock(lockKey);
        
        try {
            boolean isLocked = lock.tryLock(3, 30, TimeUnit.SECONDS);
            
            if (!isLocked) {
                throw new BusinessException("é…ç½®æ­£åœ¨æ›´æ–°ä¸­ï¼Œè¯·ç¨åé‡è¯•");
            }
            
            // æ›´æ–°é…ç½®
            updateConfigInDatabase(configKey, configValue);
            
            // é€šçŸ¥æ‰€æœ‰èŠ‚ç‚¹åˆ·æ–°é…ç½®ç¼“å­˜
            notifyConfigChange(configKey, configValue);
            
            return true;
            
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            return false;
        } finally {
            if (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
    }
}
```

### 7.5 ç§’æ€ç³»ç»Ÿå®æˆ˜æ¡ˆä¾‹


**ç§’æ€ç³»ç»Ÿä¸­çš„åˆ†å¸ƒå¼é”åº”ç”¨**
```java
@Service
public class SeckillService {
    @Autowired
    private RedissonClient redisson;
    
    /**
     * ç§’æ€å•†å“è´­ä¹°
     */
    public SeckillResult seckillProduct(Long productId, Long userId) {
        // 1. é¢„æ£€æŸ¥ï¼ˆæ— é”å¿«é€Ÿå¤±è´¥ï¼‰
        if (!isProductAvailable(productId)) {
            return SeckillResult.fail("å•†å“ä¸å­˜åœ¨æˆ–å·²å”®ç½„");
        }
        
        if (hasUserPurchased(productId, userId)) {
            return SeckillResult.fail("æ¯äººé™è´­ä¸€ä»¶");
        }
        
        // 2. è·å–å•†å“åº“å­˜é”
        String stockLockKey = "lock:seckill:stock:" + productId;
        RLock stockLock = redisson.getLock(stockLockKey);
        
        try {
            // ç§’æ€åœºæ™¯ï¼Œç­‰å¾…æ—¶é—´è¦çŸ­
            boolean isLocked = stockLock.tryLock(100, 3, TimeUnit.MILLISECONDS);
            
            if (!isLocked) {
                return SeckillResult.fail("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
            }
            
            // 3. åŒé‡æ£€æŸ¥åº“å­˜
            Integer currentStock = getSeckillStock(productId);
            if (currentStock == null || currentStock <= 0) {
                return SeckillResult.fail("å•†å“å·²å”®ç½„");
            }
            
            // 4. æ‰§è¡Œæ‰£åº“å­˜å’Œåˆ›å»ºè®¢å•
            return processSeckillOrder(productId, userId, currentStock);
            
        } catch (Exception e) {
            log.error("ç§’æ€å¤„ç†å¼‚å¸¸ï¼Œå•†å“ï¼š{}ï¼Œç”¨æˆ·ï¼š{}", productId, userId, e);
            return SeckillResult.fail("ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•");
        } finally {
            if (stockLock.isHeldByCurrentThread()) {
                stockLock.unlock();
            }
        }
    }
    
    private SeckillResult processSeckillOrder(Long productId, Long userId, Integer currentStock) {
        try {
            // æ‰£å‡åº“å­˜
            updateSeckillStock(productId, currentStock - 1);
            
            // åˆ›å»ºç§’æ€è®¢å•
            String orderId = createSeckillOrder(productId, userId);
            
            // è®°å½•ç”¨æˆ·å·²è´­ä¹°
            markUserPurchased(productId, userId);
            
            log.info("ç§’æ€æˆåŠŸï¼Œå•†å“ï¼š{}ï¼Œç”¨æˆ·ï¼š{}ï¼Œè®¢å•ï¼š{}", productId, userId, orderId);
            return SeckillResult.success(orderId);
            
        } catch (Exception e) {
            log.error("ç§’æ€è®¢å•å¤„ç†å¤±è´¥", e);
            // å›æ»šåº“å­˜
            updateSeckillStock(productId, currentStock);
            return SeckillResult.fail("è®¢å•åˆ›å»ºå¤±è´¥");
        }
    }
}
```

---

## 8. ğŸ”§ é—®é¢˜å¤„ç†ä¸æœ€ä½³å®è·µ


### 8.1 é”è¶…æ—¶å’Œç»­æœŸæœºåˆ¶


**é”è¶…æ—¶é—®é¢˜å¤„ç†**
```java
public class LockTimeoutHandler {
    
    /**
     * å¤„ç†é”è¶…æ—¶çš„ä¸šåŠ¡åœºæ™¯
     */
    public void handleLockTimeout(String resourceId) {
        String lockKey = "lock:business:" + resourceId;
        RLock lock = redisson.getLock(lockKey);
        
        try {
            // è®¾ç½®åˆç†çš„ç­‰å¾…æ—¶é—´å’Œé”è¶…æ—¶æ—¶é—´
            boolean isLocked = lock.tryLock(3, 30, TimeUnit.SECONDS);
            
            if (!isLocked) {
                // è·é”å¤±è´¥çš„å¤„ç†ç­–ç•¥
                handleLockAcquisitionFailure(resourceId);
                return;
            }
            
            // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
            long startTime = System.currentTimeMillis();
            processBusinessLogic(resourceId);
            long duration = System.currentTimeMillis() - startTime;
            
            log.info("ä¸šåŠ¡å¤„ç†å®Œæˆï¼Œè€—æ—¶ï¼š{}ms", duration);
            
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        } finally {
            if (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
    }
    
    private void handleLockAcquisitionFailure(String resourceId) {
        // ç­–ç•¥1ï¼šç›´æ¥è¿”å›å¤±è´¥
        log.warn("èµ„æº{}æ­£åœ¨è¢«å¤„ç†ï¼Œè¯·ç¨åé‡è¯•", resourceId);
        
        // ç­–ç•¥2ï¼šåŠ å…¥é˜Ÿåˆ—å»¶åå¤„ç†
        addToDelayedQueue(resourceId);
        
        // ç­–ç•¥3ï¼šé™çº§å¤„ç†
        performDegradedLogic(resourceId);
    }
}
```

**é˜²æ­¢é”è¶…æ—¶çš„è§£å†³æ–¹æ¡ˆ**
```java
// è§£å†³æ–¹æ¡ˆ1ï¼šä½¿ç”¨Redissonè‡ªåŠ¨ç»­æœŸ
public void useWatchDogRenewal() {
    RLock lock = redisson.getLock("lock:auto:renewal");
    try {
        lock.lock(); // è‡ªåŠ¨å¯ç”¨WatchDogç»­æœŸ
        // ä¸šåŠ¡é€»è¾‘ï¼Œæ— éœ€æ‹…å¿ƒè¶…æ—¶
    } finally {
        lock.unlock();
    }
}

// è§£å†³æ–¹æ¡ˆ2ï¼šæ‰‹åŠ¨ç»­æœŸ
public void manualRenewal() {
    String lockKey = "lock:manual:renewal";
    String clientId = generateClientId();
    
    LockRenewalManager renewal = new LockRenewalManager();
    
    try {
        if (renewal.lockWithRenewal(lockKey, clientId, 30)) {
            // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
            performLongRunningTask();
        }
    } finally {
        renewal.releaseLock(lockKey, clientId);
    }
}

// è§£å†³æ–¹æ¡ˆ3ï¼šé¢„ä¼°ä¸šåŠ¡æ—¶é—´ï¼Œè®¾ç½®å……è¶³çš„é”è¶…æ—¶
public void conservativeTimeout() {
    RLock lock = redisson.getLock("lock:conservative");
    try {
        // é¢„ä¼°ä¸šåŠ¡æœ€å¤§è€—æ—¶60ç§’ï¼Œè®¾ç½®é”è¶…æ—¶180ç§’
        boolean isLocked = lock.tryLock(5, 180, TimeUnit.SECONDS);
        if (isLocked) {
            performBusinessLogic();
        }
    } finally {
        if (lock.isHeldByCurrentThread()) {
            lock.unlock();
        }
    }
}
```

### 8.2 åˆ†å¸ƒå¼é”å¸¸è§é—®é¢˜


**å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ**
```java
public class DistributedLockProblems {
    
    /**
     * é—®é¢˜1ï¼šé”è¶…æ—¶å¯¼è‡´é‡å¤æ‰§è¡Œ
     */
    public void problemTimeout() {
        // é—®é¢˜ï¼šä¸šåŠ¡è€—æ—¶40ç§’ï¼Œé”è¶…æ—¶30ç§’
        // ç»“æœï¼šä¸šåŠ¡è¿˜æ²¡å®Œæˆï¼Œå…¶ä»–çº¿ç¨‹è·å¾—é”å¼€å§‹é‡å¤æ‰§è¡Œ
        
        // è§£å†³æ–¹æ¡ˆï¼š
        RLock lock = redisson.getLock("lock:problem1");
        try {
            // å¯ç”¨è‡ªåŠ¨ç»­æœŸæˆ–è®¾ç½®å……è¶³çš„è¶…æ—¶æ—¶é—´
            lock.lock(); // ä½¿ç”¨WatchDogè‡ªåŠ¨ç»­æœŸ
            
            // æˆ–è€…
            // lock.tryLock(5, 120, TimeUnit.SECONDS); // è®¾ç½®å……è¶³è¶…æ—¶
            
        } finally {
            if (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
    }
    
    /**
     * é—®é¢˜2ï¼šé«˜å¹¶å‘ä¸‹é”ç«äº‰æ¿€çƒˆ
     */
    public void problemHighConcurrency() {
        // é—®é¢˜ï¼š1000ä¸ªè¯·æ±‚åŒæ—¶ç«äº‰ä¸€æŠŠé”ï¼Œæ€§èƒ½å·®
        
        // è§£å†³æ–¹æ¡ˆ1ï¼šç»†åŒ–é”ç²’åº¦
        String userId = getCurrentUserId();
        String lockKey = "lock:user:operation:" + userId; // æŒ‰ç”¨æˆ·IDåˆ†é”
        
        // è§£å†³æ–¹æ¡ˆ2ï¼šåˆ†æ®µé”
        int segment = userId.hashCode() % 10; // åˆ†10ä¸ªæ®µ
        String segmentLockKey = "lock:segment:" + segment;
        
        // è§£å†³æ–¹æ¡ˆ3ï¼šé™æµ + åˆ†å¸ƒå¼é”
        if (!rateLimiter.tryAcquire()) {
            throw new TooManyRequestsException("è¯·æ±‚è¿‡äºé¢‘ç¹");
        }
        
        RLock lock = redisson.getLock(lockKey);
        // åç»­åŠ é”é€»è¾‘...
    }
    
    /**
     * é—®é¢˜3ï¼šRediså®ä¾‹æ•…éšœå¯¼è‡´é”ä¸¢å¤±
     */
    public void problemSinglePointFailure() {
        // é—®é¢˜ï¼šRedisä¸»æœºå®•æœºï¼Œæ‰€æœ‰é”ä¸¢å¤±
        
        // è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨Redlockå¤šå®ä¾‹
        RLock lock1 = redisson1.getLock("redlock:resource");
        RLock lock2 = redisson2.getLock("redlock:resource");
        RLock lock3 = redisson3.getLock("redlock:resource");
        
        RLock redLock = redisson.getRedLock(lock1, lock2, lock3);
        
        try {
            boolean isLocked = redLock.tryLock(5, 30, TimeUnit.SECONDS);
            if (isLocked) {
                // å³ä½¿æŸä¸ªRediså®ä¾‹æ•…éšœï¼Œé”ä»ç„¶æœ‰æ•ˆ
                performCriticalOperation();
            }
        } finally {
            if (redLock.isHeldByCurrentThread()) {
                redLock.unlock();
            }
        }
    }
}
```

### 8.3 é”çš„æœ€ä½³å®è·µ


**ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ**
```java
@Component
public class BestPractices {
    
    /**
     * æ ‡å‡†çš„åˆ†å¸ƒå¼é”ä½¿ç”¨æ¨¡æ¿
     */
    public <T> T executeWithLock(String resource, 
                                Supplier<T> businessLogic, 
                                T defaultValue) {
        // 1. ç”Ÿæˆé”keyå’Œå®¢æˆ·ç«¯æ ‡è¯†
        String lockKey = "lock:best:practice:" + resource;
        RLock lock = redisson.getLock(lockKey);
        
        try {
            // 2. å°è¯•è·é”ï¼ˆåˆç†çš„ç­‰å¾…æ—¶é—´å’Œè¶…æ—¶æ—¶é—´ï¼‰
            boolean isLocked = lock.tryLock(3, 60, TimeUnit.SECONDS);
            
            if (!isLocked) {
                log.warn("è·å–é”å¤±è´¥ï¼Œèµ„æºï¼š{}", resource);
                return defaultValue;
            }
            
            // 3. æ‰§è¡Œä¸šåŠ¡é€»è¾‘
            log.info("è·å¾—é”ï¼Œå¼€å§‹æ‰§è¡Œä¸šåŠ¡ï¼š{}", resource);
            return businessLogic.get();
            
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            log.error("é”ç­‰å¾…è¢«ä¸­æ–­ï¼š{}", resource);
            return defaultValue;
        } catch (Exception e) {
            log.error("ä¸šåŠ¡æ‰§è¡Œå¼‚å¸¸ï¼š{}", resource, e);
            return defaultValue;
        } finally {
            // 4. ç¡®ä¿é”è¢«æ­£ç¡®é‡Šæ”¾
            if (lock.isHeldByCurrentThread()) {
                lock.unlock();
                log.info("é‡Šæ”¾é”ï¼š{}", resource);
            }
        }
    }
}
```

**é”çš„å‘½åè§„èŒƒ**
```java
public class LockNamingConventions {
    
    /**
     * æ ‡å‡†é”å‘½åè§„èŒƒ
     */
    public static class LockKeyBuilder {
        private static final String LOCK_PREFIX = "lock";
        
        // ä¸šåŠ¡æ¨¡å—é”
        public static String buildBusinessLock(String module, String resourceId) {
            return String.format("%s:%s:%s", LOCK_PREFIX, module, resourceId);
            // ç¤ºä¾‹ï¼šlock:order:create:1001
        }
        
        // ç”¨æˆ·æ“ä½œé”
        public static String buildUserLock(String operation, String userId) {
            return String.format("%s:user:%s:%s", LOCK_PREFIX, operation, userId);
            // ç¤ºä¾‹ï¼šlock:user:submit:12345
        }
        
        // å…¨å±€èµ„æºé”
        public static String buildGlobalLock(String resource) {
            return String.format("%s:global:%s", LOCK_PREFIX, resource);
            // ç¤ºä¾‹ï¼šlock:global:config:update
        }
        
        // å®šæ—¶ä»»åŠ¡é”
        public static String buildTaskLock(String taskName) {
            return String.format("%s:task:%s", LOCK_PREFIX, taskName);
            // ç¤ºä¾‹ï¼šlock:task:cleanup:expired
        }
    }
}
```

**æ­»é”é¢„é˜²æªæ–½**
```java
public class DeadlockPrevention {
    
    /**
     * é¢„é˜²æªæ–½1ï¼šå¼ºåˆ¶è®¾ç½®è¶…æ—¶æ—¶é—´
     */
    public void alwaysSetTimeout() {
        RLock lock = redisson.getLock("lock:resource");
        
        // é”™è¯¯ï¼šä¸è®¾ç½®è¶…æ—¶æ—¶é—´
        // lock.lock(); // å¦‚æœWatchDogå¤±æ•ˆï¼Œå¯èƒ½æ­»é”
        
        // æ­£ç¡®ï¼šæ€»æ˜¯è®¾ç½®è¶…æ—¶æ—¶é—´
        try {
            boolean isLocked = lock.tryLock(5, 60, TimeUnit.SECONDS);
            // ä¸šåŠ¡é€»è¾‘
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        } finally {
            if (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
    }
    
    /**
     * é¢„é˜²æªæ–½2ï¼šé”é¡ºåºä¸€è‡´æ€§
     */
    public void consistentLockOrdering() {
        // å¦‚æœéœ€è¦åŒæ—¶é”å®šå¤šä¸ªèµ„æºï¼ŒæŒ‰å›ºå®šé¡ºåºåŠ é”
        String resource1 = "resource:A";
        String resource2 = "resource:B";
        
        // æŒ‰å­—æ¯é¡ºåºæ’åºï¼Œé¿å…æ­»é”
        List<String> resources = Arrays.asList(resource1, resource2);
        Collections.sort(resources);
        
        List<RLock> locks = new ArrayList<>();
        try {
            for (String resource : resources) {
                RLock lock = redisson.getLock("lock:" + resource);
                if (lock.tryLock(1, 30, TimeUnit.SECONDS)) {
                    locks.add(lock);
                } else {
                    throw new LockException("è·å–é”å¤±è´¥ï¼š" + resource);
                }
            }
            
            // æ‰§è¡Œéœ€è¦å¤šä¸ªèµ„æºçš„ä¸šåŠ¡é€»è¾‘
            performMultiResourceOperation();
            
        } finally {
            // æŒ‰ç›¸åé¡ºåºé‡Šæ”¾é”
            Collections.reverse(locks);
            for (RLock lock : locks) {
                if (lock.isHeldByCurrentThread()) {
                    lock.unlock();
                }
            }
        }
    }
}
```

### 8.2 é”çš„ç›‘æ§å’ŒæŠ¥è­¦


**ç›‘æ§ç³»ç»Ÿå®ç°**
```java
@Component
public class LockMonitorService {
    @Autowired
    private RedissonClient redisson;
    
    /**
     * é”çŠ¶æ€ç›‘æ§
     */
    @Scheduled(fixedRate = 30000) // æ¯30ç§’ç›‘æ§ä¸€æ¬¡
    public void monitorLockStatus() {
        try {
            // è·å–æ‰€æœ‰é”ä¿¡æ¯
            Set<String> lockKeys = redisson.getKeys().getKeysByPattern("lock:*");
            
            Map<String, LockMetrics> lockMetrics = new HashMap<>();
            
            for (String lockKey : lockKeys) {
                RLock lock = redisson.getLock(lockKey);
                
                LockMetrics metrics = new LockMetrics();
                metrics.setKey(lockKey);
                metrics.setLocked(lock.isLocked());
                metrics.setRemainingTime(lock.remainTimeToLive());
                metrics.setHoldCount(lock.getHoldCount());
                
                lockMetrics.put(lockKey, metrics);
                
                // æ£€æŸ¥å¼‚å¸¸æƒ…å†µ
                checkLockAnomalies(lockKey, metrics);
            }
            
            // è®°å½•ç›‘æ§æ•°æ®
            recordLockMetrics(lockMetrics);
            
        } catch (Exception e) {
            log.error("é”ç›‘æ§å¼‚å¸¸", e);
        }
    }
    
    /**
     * æ£€æŸ¥é”å¼‚å¸¸æƒ…å†µ
     */
    private void checkLockAnomalies(String lockKey, LockMetrics metrics) {
        // æ£€æŸ¥é•¿æ—¶é—´æŒæœ‰çš„é”
        if (metrics.getRemainingTime() > 600000) { // è¶…è¿‡10åˆ†é’Ÿ
            sendAlert("é•¿æ—¶é—´æŒé”", lockKey, metrics);
        }
        
        // æ£€æŸ¥é«˜é‡å…¥æ¬¡æ•°çš„é”
        if (metrics.getHoldCount() > 50) {
            sendAlert("é«˜é‡å…¥æ¬¡æ•°", lockKey, metrics);
        }
        
        // æ£€æŸ¥é”ç«äº‰æ¿€çƒˆçš„èµ„æº
        if (isHighContentionLock(lockKey)) {
            sendAlert("é”ç«äº‰æ¿€çƒˆ", lockKey, metrics);
        }
    }
    
    /**
     * å‘é€å‘Šè­¦
     */
    private void sendAlert(String alertType, String lockKey, LockMetrics metrics) {
        AlertMessage alert = AlertMessage.builder()
            .type(alertType)
            .lockKey(lockKey)
            .metrics(metrics)
            .timestamp(new Date())
            .build();
        
        // å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ
        alertSender.sendAlert(alert);
        
        log.warn("åˆ†å¸ƒå¼é”å‘Šè­¦ï¼š{}ï¼Œé”ï¼š{}ï¼Œè¯¦æƒ…ï¼š{}", alertType, lockKey, metrics);
    }
}
```

### 8.3 ç»¼åˆæœ€ä½³å®è·µ


**SET NX EXã€RedLockã€é”ç»­çº¦ç»¼åˆåº”ç”¨**
```java
@Service
public class ComprehensiveLockService {
    @Autowired
    private RedissonClient redisson;
    
    /**
     * æ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰æ‹©åˆé€‚çš„é”ç­–ç•¥
     */
    public boolean executeWithOptimalLock(String businessType, String resourceId, Runnable task) {
        switch (businessType) {
            case "FAST_CACHE":
                return executeWithSimpleLock(resourceId, task, 10);
                
            case "NORMAL_BUSINESS":
                return executeWithReentrantLock(resourceId, task);
                
            case "CRITICAL_OPERATION":
                return executeWithRedLock(resourceId, task);
                
            default:
                throw new IllegalArgumentException("ä¸æ”¯æŒçš„ä¸šåŠ¡ç±»å‹ï¼š" + businessType);
        }
    }
    
    /**
     * å¿«é€Ÿç¼“å­˜æ“ä½œï¼šä½¿ç”¨ç®€å•é”
     */
    private boolean executeWithSimpleLock(String resourceId, Runnable task, int timeoutSeconds) {
        RLock lock = redisson.getLock("lock:cache:" + resourceId);
        
        try {
            boolean isLocked = lock.tryLock(1, timeoutSeconds, TimeUnit.SECONDS);
            if (isLocked) {
                task.run();
                return true;
            }
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        } finally {
            if (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
        return false;
    }
    
    /**
     * ä¸€èˆ¬ä¸šåŠ¡æ“ä½œï¼šä½¿ç”¨å¯é‡å…¥é” + è‡ªåŠ¨ç»­æœŸ
     */
    private boolean executeWithReentrantLock(String resourceId, Runnable task) {
        RLock lock = redisson.getLock("lock:business:" + resourceId);
        
        try {
            lock.lock(); // å¯ç”¨WatchDogè‡ªåŠ¨ç»­æœŸ
            task.run();
            return true;
        } finally {
            if (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
    }
    
    /**
     * å…³é”®æ“ä½œï¼šä½¿ç”¨RedLockç®—æ³•
     */
    private boolean executeWithRedLock(String resourceId, Runnable task) {
        // ä½¿ç”¨3ä¸ªRediså®ä¾‹å®ç°RedLock
        RLock lock1 = redisson1.getLock("redlock:critical:" + resourceId);
        RLock lock2 = redisson2.getLock("redlock:critical:" + resourceId);
        RLock lock3 = redisson3.getLock("redlock:critical:" + resourceId);
        
        RLock redLock = redisson.getRedLock(lock1, lock2, lock3);
        
        try {
            boolean isLocked = redLock.tryLock(10, 120, TimeUnit.SECONDS);
            if (isLocked) {
                task.run();
                return true;
            }
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        } finally {
            if (redLock.isHeldByCurrentThread()) {
                redLock.unlock();
            }
        }
        return false;
    }
}
```

### 8.4 æ€§èƒ½ä¼˜åŒ–å’Œè¿ç»´å»ºè®®


**æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**
```java
public class LockPerformanceOptimization {
    
    /**
     * ä¼˜åŒ–1ï¼šå‡å°‘é”çš„æŒæœ‰æ—¶é—´
     */
    public void optimizeLockHoldTime() {
        RLock lock = redisson.getLock("lock:optimize:time");
        
        try {
            if (lock.tryLock(1, 30, TimeUnit.SECONDS)) {
                
                // âŒ é”™è¯¯ï¼šé”å†…åšè€—æ—¶æ“ä½œ
                // String data = queryLargeDataFromDB(); // å¯èƒ½å¾ˆæ…¢
                // processData(data);
                
                // âœ… æ­£ç¡®ï¼šé”å¤–å‡†å¤‡ï¼Œé”å†…å¿«é€Ÿæ“ä½œ
                // å…ˆåœ¨é”å¤–å‡†å¤‡æ•°æ®
            }
        } finally {
            if (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
        
        // é”å¤–å‡†å¤‡æ•°æ®
        String data = queryLargeDataFromDB();
        
        try {
            if (lock.tryLock(1, 10, TimeUnit.SECONDS)) {
                // é”å†…åªåšå¿…è¦çš„åŸå­æ“ä½œ
                updateCriticalData(data);
            }
        } finally {
            if (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
    }
    
    /**
     * ä¼˜åŒ–2ï¼šé”ç²’åº¦ç»†åŒ–
     */
    public void optimizeLockGranularity(String userId, String orderId) {
        // âŒ ç²—ç²’åº¦ï¼šæ‰€æœ‰è®¢å•æ“ä½œå…±ç”¨ä¸€æŠŠé”
        // RLock lock = redisson.getLock("lock:order");
        
        // âœ… ç»†ç²’åº¦ï¼šæ¯ä¸ªè®¢å•ä¸€æŠŠé”
        RLock orderLock = redisson.getLock("lock:order:" + orderId);
        
        // âœ… æ›´ç»†ç²’åº¦ï¼šç”¨æˆ·çº§åˆ«çš„é”
        RLock userLock = redisson.getLock("lock:user:order:" + userId);
        
        // æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©åˆé€‚çš„ç²’åº¦
    }
}
```

**è¿ç»´ç›‘æ§ä»ªè¡¨æ¿**
```java
@RestController
public class LockDashboardController {
    
    @GetMapping("/lock/dashboard")
    public LockDashboard getLockDashboard() {
        LockDashboard dashboard = new LockDashboard();
        
        // å½“å‰æ´»è·ƒé”æ•°é‡
        dashboard.setActiveLockCount(getActiveLockCount());
        
        // é”ç«äº‰æœ€æ¿€çƒˆçš„èµ„æºTop10
        dashboard.setTopContentionLocks(getTopContentionLocks(10));
        
        // å¹³å‡é”æŒæœ‰æ—¶é—´
        dashboard.setAverageLockHoldTime(getAverageLockHoldTime());
        
        // é”è·å–æˆåŠŸç‡
        dashboard.setLockSuccessRate(getLockSuccessRate());
        
        // è¶…æ—¶å‘Šè­¦åˆ—è¡¨
        dashboard.setTimeoutAlerts(getRecentTimeoutAlerts());
        
        return dashboard;
    }
    
    @PostMapping("/lock/force-release")
    public ResponseEntity<String> forceReleaseLock(@RequestParam String lockKey, 
                                                  @RequestParam String reason) {
        log.warn("ç®¡ç†å‘˜å¼ºåˆ¶é‡Šæ”¾é”ï¼š{}ï¼ŒåŸå› ï¼š{}", lockKey, reason);
        
        boolean success = redisson.getLock(lockKey).forceUnlock();
        
        if (success) {
            return ResponseEntity.ok("é”é‡Šæ”¾æˆåŠŸ");
        } else {
            return ResponseEntity.badRequest().body("é”é‡Šæ”¾å¤±è´¥æˆ–é”ä¸å­˜åœ¨");
        }
    }
}
```

### 8.5 æ ¸å¿ƒè¦ç‚¹æ€»ç»“


**å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ**
```
ğŸ”¸ åˆ†å¸ƒå¼é”æœ¬è´¨ï¼šå¤šæœåŠ¡å™¨ç¯å¢ƒä¸‹çš„äº’æ–¥è®¿é—®æ§åˆ¶æœºåˆ¶
ğŸ”¸ åŸºç¡€å®ç°ï¼šSET key value PX milliseconds NX åŸå­æ“ä½œ
ğŸ”¸ æ ¸å¿ƒè¦ç´ ï¼šåŸå­æ“ä½œã€å”¯ä¸€æ ‡è¯†ã€è¶…æ—¶æœºåˆ¶ã€é”ç»­æœŸå››å¤§è¦ç´ 
ğŸ”¸ é«˜çº§å®ç°ï¼šLuaè„šæœ¬ä¿è¯åŸå­æ€§ï¼Œå¯é‡å…¥é”æ”¯æŒé‡å¤åŠ é”
ğŸ”¸ Redlockç®—æ³•ï¼šå¤šå®ä¾‹åŠ é”ï¼Œè¿‡åŠæ•°æˆåŠŸï¼Œå¤„ç†æ—¶é’Ÿæ¼‚ç§»
ğŸ”¸ Redissonæ¡†æ¶ï¼šç”Ÿäº§çº§è§£å†³æ–¹æ¡ˆï¼Œè‡ªåŠ¨ç»­æœŸï¼Œä¸°å¯Œçš„é”ç±»å‹
```

**å…³é”®ç†è§£è¦ç‚¹**
```
å®ç°æ¼”è¿›è·¯çº¿ï¼š
SETNXç®€å•é” â†’ SET EX NXæ ‡å‡†é” â†’ Luaè„šæœ¬åŸå­é” â†’ Redissonæ¡†æ¶é”

æŠ€æœ¯é€‰æ‹©åŸåˆ™ï¼š
â€¢ ç®€å•åœºæ™¯ï¼šSET EX NX + Luaè„šæœ¬
â€¢ å¤æ‚åœºæ™¯ï¼šRedissonæ¡†æ¶
â€¢ é«˜å¯ç”¨åœºæ™¯ï¼šRedlockå¤šå®ä¾‹
â€¢ æ€§èƒ½è¦æ±‚é«˜ï¼šä¼˜åŒ–é”ç²’åº¦å’ŒæŒæœ‰æ—¶é—´

å®‰å…¨æ€§ä¿éšœï¼š
â€¢ åŸå­æ“ä½œé˜²æ­¢ä¸­é—´çŠ¶æ€
â€¢ å”¯ä¸€æ ‡è¯†é˜²æ­¢è¯¯åˆ é”  
â€¢ è¶…æ—¶æœºåˆ¶é˜²æ­¢æ­»é”
â€¢ ç»­æœŸæœºåˆ¶é˜²æ­¢é”æå‰å¤±æ•ˆ
```

**å®é™…åº”ç”¨æŒ‡å¯¼**
```
å¼€å‘é˜¶æ®µï¼š
â€¢ ç†è§£ä¸šåŠ¡åœºæ™¯ï¼Œé€‰æ‹©åˆé€‚çš„é”ç±»å‹
â€¢ è®¾è®¡åˆç†çš„é”ç²’åº¦å’Œå‘½åè§„èŒƒ
â€¢ ç¼–å†™å®Œå–„çš„å¼‚å¸¸å¤„ç†ä»£ç 

æµ‹è¯•é˜¶æ®µï¼š
â€¢ æ¨¡æ‹Ÿé«˜å¹¶å‘åœºæ™¯æµ‹è¯•é”çš„æœ‰æ•ˆæ€§
â€¢ æµ‹è¯•å¼‚å¸¸æƒ…å†µä¸‹çš„é”é‡Šæ”¾
â€¢ éªŒè¯é”çš„æ€§èƒ½è¡¨ç°

ç”Ÿäº§ç¯å¢ƒï¼š
â€¢ å»ºç«‹é”çš„ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶  
â€¢ åˆ¶å®šé”ç›¸å…³çš„è¿ç»´æ“ä½œæ‰‹å†Œ
â€¢ å®šæœŸæ£€æŸ¥é”çš„ä½¿ç”¨æƒ…å†µå’Œæ€§èƒ½æŒ‡æ ‡
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- åˆ†å¸ƒå¼é”ä¿è¯å¤šæœåŠ¡å™¨äº’æ–¥ï¼ŒRedisåšåè°ƒæœ€é«˜æ•ˆ
- SET NX EXåŸå­åŠ é”ï¼ŒLuaè„šæœ¬åŸå­è§£é”ï¼ŒUUIDé˜²è¯¯åˆ 
- å››å¤§è¦ç´ ç¼ºä¸€ä¸å¯ï¼Œè¶…æ—¶ç»­æœŸé˜²æ­»é”
- Redissonæ¡†æ¶æ˜¯é¦–é€‰ï¼ŒWatchDogè‡ªåŠ¨ç»­æœŸçœŸæ–¹ä¾¿
- Redlockç®—æ³•é˜²å•ç‚¹ï¼Œè¿‡åŠæˆåŠŸä¿å®‰å…¨