---
title: 11ã€å…¸å‹åº”ç”¨åœºæ™¯å’Œæœ€ä½³å®è·µ
---
## ğŸ“š ç›®å½•

1. [åº”ç”¨åœºæ™¯æ¦‚è¿°](#1-åº”ç”¨åœºæ™¯æ¦‚è¿°)
2. [æ’è¡Œæ¦œç³»ç»Ÿ](#2-æ’è¡Œæ¦œç³»ç»Ÿ)
3. [å»¶æ—¶ä»»åŠ¡ç³»ç»Ÿ](#3-å»¶æ—¶ä»»åŠ¡ç³»ç»Ÿ)
4. [ç§’æ€ç³»ç»Ÿ](#4-ç§’æ€ç³»ç»Ÿ)
5. [Sessionå…±äº«](#5-sessionå…±äº«)
6. [è®¡æ•°ç»Ÿè®¡ç³»ç»Ÿ](#6-è®¡æ•°ç»Ÿè®¡ç³»ç»Ÿ)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ åº”ç”¨åœºæ™¯æ¦‚è¿°


### 1.1 ä¸ºä»€ä¹ˆRedisé€‚åˆè¿™äº›åœºæ™¯


**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- **é€Ÿåº¦å¿«**ï¼šå†…å­˜å­˜å‚¨ï¼Œæ¯«ç§’çº§å“åº”
- **æ•°æ®ç»“æ„ä¸°å¯Œ**ï¼šä¸åŒåœºæ™¯ç”¨ä¸åŒæ•°æ®ç±»å‹
- **åŸå­æ“ä½œ**ï¼šé«˜å¹¶å‘ä¸‹æ•°æ®ä¸ä¼šé”™ä¹±
- **æŒä¹…åŒ–**ï¼šé‡è¦æ•°æ®ä¸ä¼šä¸¢å¤±

### 1.2 äº”å¤§å…¸å‹åœºæ™¯


```
æ’è¡Œæ¦œç³»ç»Ÿ â†’ ç”¨ZSetæœ‰åºé›†åˆï¼Œè‡ªåŠ¨æ’åº
å»¶æ—¶ä»»åŠ¡ â†’ ç”¨ZSetå­˜æ—¶é—´æˆ³ï¼Œå®šæ—¶è§¦å‘
ç§’æ€ç³»ç»Ÿ â†’ ç”¨åŸå­æ“ä½œï¼Œé˜²æ­¢è¶…å–
Sessionå…±äº« â†’ ç”¨Hashå­˜ç”¨æˆ·çŠ¶æ€ï¼Œé›†ç¾¤å…±äº«
è®¡æ•°ç»Ÿè®¡ â†’ ç”¨String/Hashè®¡æ•°ï¼Œå®æ—¶ç»Ÿè®¡
```

**é€‰æ‹©åŸåˆ™**ï¼š
- ğŸ”¸ **é«˜å¹¶å‘åœºæ™¯**ï¼šåˆ©ç”¨Redisçš„åŸå­æ€§
- ğŸ”¸ **å®æ—¶æ€§è¦æ±‚**ï¼šåˆ©ç”¨å†…å­˜çš„å¿«é€Ÿè®¿é—®
- ğŸ”¸ **æ•°æ®é‡å¤§**ï¼šåˆ©ç”¨Redisçš„å­˜å‚¨æ•ˆç‡
- ğŸ”¸ **å¤æ‚æ“ä½œ**ï¼šåˆ©ç”¨ä¸°å¯Œçš„æ•°æ®ç»“æ„

---

## 2. ğŸ† æ’è¡Œæ¦œç³»ç»Ÿ


### 2.1 æ’è¡Œæ¦œçš„åŸºæœ¬éœ€æ±‚


**å…¸å‹éœ€æ±‚**ï¼š
- å®æ—¶æ›´æ–°ç”¨æˆ·åˆ†æ•°
- æŒ‰åˆ†æ•°é«˜ä½æ’åº
- åˆ†é¡µæŸ¥è¯¢æ’è¡Œæ¦œ
- æŸ¥è¯¢ç‰¹å®šç”¨æˆ·æ’å

**ä¸ºä»€ä¹ˆç”¨ZSet**ï¼šZSetå¤©ç”Ÿå°±æ˜¯ä¸ºæ’åºè€Œç”Ÿçš„æ•°æ®ç»“æ„ã€‚

```
ä¼ ç»Ÿæ•°æ®åº“å®ç°æ’è¡Œæ¦œçš„é—®é¢˜ï¼š
- æ¯æ¬¡æŸ¥è¯¢éƒ½è¦ORDER BYï¼Œå¾ˆæ…¢
- å®æ—¶æ›´æ–°åˆ†æ•°åï¼Œé‡æ–°æ’åºå¼€é”€å¤§
- åˆ†é¡µæŸ¥è¯¢åœ¨å¤§æ•°æ®é‡ä¸‹æ€§èƒ½å·®

Redis ZSetçš„ä¼˜åŠ¿ï¼š
- åˆ†æ•°æ›´æ–°åè‡ªåŠ¨é‡æ’åº
- èŒƒå›´æŸ¥è¯¢æ•ˆç‡é«˜
- æ”¯æŒæ­£åå‘æ’åº
```

### 2.2 æ’è¡Œæ¦œå®ç°


#### ğŸ”¸ åŸºç¡€æ’è¡Œæ¦œæ“ä½œ


```bash
# æ·»åŠ /æ›´æ–°ç”¨æˆ·åˆ†æ•°
ZADD game_rank 1500 "player1"
ZADD game_rank 2000 "player2"  
ZADD game_rank 1800 "player3"

# æ‰¹é‡æ·»åŠ 
ZADD game_rank 2200 "player4" 1200 "player5" 3000 "player6"

# æŸ¥çœ‹æ’è¡Œæ¦œï¼ˆä»é«˜åˆ°ä½ï¼‰
ZREVRANGE game_rank 0 9 WITHSCORES    # å‰10å
```

**å®é™…æ•ˆæœ**ï¼š
```
æ’è¡Œæ¦œç»“æœï¼š
1) "player6"    # 3000åˆ†
2) "player4"    # 2200åˆ†  
3) "player2"    # 2000åˆ†
4) "player3"    # 1800åˆ†
5) "player1"    # 1500åˆ†
6) "player5"    # 1200åˆ†
```

#### ğŸ”¸ åˆ†é¡µæŸ¥è¯¢å®ç°


```bash
# åˆ†é¡µæŸ¥è¯¢æ’è¡Œæ¦œ
# ç¬¬1é¡µï¼ˆå‰10åï¼‰ï¼šZREVRANGE key 0 9
# ç¬¬2é¡µï¼ˆ11-20åï¼‰ï¼šZREVRANGE key 10 19  
# ç¬¬3é¡µï¼ˆ21-30åï¼‰ï¼šZREVRANGE key 20 29

# å®é™…ä½¿ç”¨ç¤ºä¾‹
ZREVRANGE game_rank 0 4 WITHSCORES      # å‰5å
ZREVRANGE game_rank 5 9 WITHSCORES      # 6-10å
```

#### ğŸ”¸ ç”¨æˆ·æ’åæŸ¥è¯¢


```bash
# æŸ¥è¯¢ç‰¹å®šç”¨æˆ·çš„æ’å
ZREVRANK game_rank "player2"    # è¿”å›æ’åï¼ˆä»0å¼€å§‹ï¼‰

# æŸ¥è¯¢ç”¨æˆ·åˆ†æ•°
ZSCORE game_rank "player2"      # è¿”å›2000

# æŸ¥è¯¢ç”¨æˆ·å‘¨å›´æ’å
ZREVRANGE game_rank 1 3 WITHSCORES    # æŸ¥çœ‹ç¬¬2-4å
```

### 2.3 å¢é‡æ›´æ–°ç­–ç•¥


```bash
# ç”¨æˆ·å¾—åˆ†åå¢åŠ åˆ†æ•°
ZINCRBY game_rank 100 "player1"    # player1 å¢åŠ 100åˆ†

# å®é™…åº”ç”¨ä»£ç ç¤ºä¾‹
```

```python
def update_user_score(user_id, score_change):
    """æ›´æ–°ç”¨æˆ·åˆ†æ•°å¹¶è¿”å›æ–°æ’å"""
    # å¢åŠ åˆ†æ•°
    new_score = redis.zincrby("game_rank", score_change, user_id)
    
    # è·å–æ–°æ’å
    rank = redis.zrevrank("game_rank", user_id)
    
    return {
        "user_id": user_id,
        "new_score": new_score,
        "rank": rank + 1  # Redisæ’åä»0å¼€å§‹ï¼Œå±•ç¤ºä»1å¼€å§‹
    }
```

### 2.4 æ’è¡Œæ¦œçš„é«˜çº§åŠŸèƒ½


**å¤šç»´åº¦æ’è¡Œæ¦œ**ï¼š
```bash
# ä¸åŒç±»å‹çš„æ’è¡Œæ¦œ
ZADD daily_rank 1500 "player1"     # æ—¥æ’è¡Œ
ZADD weekly_rank 8500 "player1"    # å‘¨æ’è¡Œ  
ZADD monthly_rank 35000 "player1"  # æœˆæ’è¡Œ

# åŒºåŸŸæ’è¡Œæ¦œ
ZADD rank:beijing 2000 "player1"
ZADD rank:shanghai 1800 "player2"
```

**æ’è¡Œæ¦œæ•°æ®åŒæ­¥**ï¼š
```python
def sync_rankings():
    """å®šæ—¶åŒæ­¥æ’è¡Œæ¦œæ•°æ®"""
    # ä»æ•°æ®åº“è·å–æœ€æ–°åˆ†æ•°
    scores = get_latest_scores_from_db()
    
    # æ‰¹é‡æ›´æ–°åˆ°Redis
    pipeline = redis.pipeline()
    for user_id, score in scores:
        pipeline.zadd("game_rank", {user_id: score})
    pipeline.execute()
```

---

## 3. â° å»¶æ—¶ä»»åŠ¡ç³»ç»Ÿ


### 3.1 ä»€ä¹ˆæ˜¯å»¶æ—¶ä»»åŠ¡


**é€šä¿—è§£é‡Š**ï¼šå»¶æ—¶ä»»åŠ¡å°±åƒå®šé—¹é’Ÿï¼Œåˆ°äº†æŒ‡å®šæ—¶é—´å°±è‡ªåŠ¨æ‰§è¡ŒæŸä¸ªæ“ä½œã€‚

**å…¸å‹åœºæ™¯**ï¼š
- è®¢å•15åˆ†é’Ÿæœªæ”¯ä»˜è‡ªåŠ¨å–æ¶ˆ
- å®šæ—¶å‘é€æé†’æ¶ˆæ¯
- å®šæœŸæ¸…ç†ä¸´æ—¶æ–‡ä»¶
- ä¼šå‘˜åˆ°æœŸæé†’

### 3.2 ä¸ºä»€ä¹ˆç”¨ZSetå®ç°å»¶æ—¶ä»»åŠ¡


**æ ¸å¿ƒæ€è·¯**ï¼šæŠŠæ—¶é—´æˆ³å½“ä½œåˆ†æ•°ï¼Œä»»åŠ¡IDå½“ä½œæˆå‘˜ï¼Œè‡ªç„¶å°±æŒ‰æ—¶é—´æ’åºäº†ã€‚

```
ZSetå»¶æ—¶ä»»åŠ¡é˜Ÿåˆ—ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ—¶é—´æˆ³(åˆ†æ•°)    ä»»åŠ¡ID(æˆå‘˜)         â”‚
â”‚ 1642781400 â†’ order_cancel_1001     â”‚  â† æœ€æ—©æ‰§è¡Œ
â”‚ 1642781460 â†’ remind_user_2002      â”‚
â”‚ 1642781520 â†’ cleanup_temp_3003     â”‚  â† æœ€æ™šæ‰§è¡Œ  
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å®šæ—¶æ‰«ææœ€å°æ—¶é—´æˆ³ï¼Œåˆ°æœŸå°±æ‰§è¡Œ
```

### 3.3 å»¶æ—¶ä»»åŠ¡å®ç°


#### ğŸ”¸ æ·»åŠ å»¶æ—¶ä»»åŠ¡


```bash
# æ·»åŠ å»¶æ—¶ä»»åŠ¡ï¼šä»»åŠ¡ID + æ‰§è¡Œæ—¶é—´æˆ³
ZADD delay_queue 1642781400 "order_cancel_1001"
ZADD delay_queue 1642781460 "remind_user_2002"

# å½“å‰æ—¶é—´ï¼š1642781350
# 1642781400 - 1642781350 = 50ç§’åæ‰§è¡Œç¬¬ä¸€ä¸ªä»»åŠ¡
```

```python
def add_delay_task(task_id, delay_seconds):
    """æ·»åŠ å»¶æ—¶ä»»åŠ¡"""
    import time
    
    # è®¡ç®—æ‰§è¡Œæ—¶é—´æˆ³
    execute_time = time.time() + delay_seconds
    
    # æ·»åŠ åˆ°å»¶æ—¶é˜Ÿåˆ—
    redis.zadd("delay_queue", {task_id: execute_time})
    
    print(f"ä»»åŠ¡ {task_id} å°†åœ¨ {delay_seconds} ç§’åæ‰§è¡Œ")
```

#### ğŸ”¸ æ‰«æå’Œæ‰§è¡Œä»»åŠ¡


```python
def process_delay_tasks():
    """æ‰«æå¹¶æ‰§è¡Œåˆ°æœŸçš„å»¶æ—¶ä»»åŠ¡"""
    import time
    
    current_time = time.time()
    
    # è·å–æ‰€æœ‰åˆ°æœŸçš„ä»»åŠ¡ï¼ˆåˆ†æ•° <= å½“å‰æ—¶é—´ï¼‰
    tasks = redis.zrangebyscore("delay_queue", 0, current_time)
    
    for task_id in tasks:
        # æ‰§è¡Œä»»åŠ¡
        execute_task(task_id)
        
        # ä»é˜Ÿåˆ—ä¸­åˆ é™¤å·²æ‰§è¡Œçš„ä»»åŠ¡
        redis.zrem("delay_queue", task_id)
        
        print(f"æ‰§è¡Œä»»åŠ¡: {task_id}")

def execute_task(task_id):
    """å…·ä½“çš„ä»»åŠ¡æ‰§è¡Œé€»è¾‘"""
    if "order_cancel" in task_id:
        cancel_order(task_id)
    elif "remind_user" in task_id:
        send_reminder(task_id)
```

### 3.4 ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿè®¾è®¡


**å®šæ—¶æ‰«æå™¨**ï¼š
```python
import threading
import time

class DelayTaskScheduler:
    def __init__(self):
        self.running = True
        
    def start_scheduler(self):
        """å¯åŠ¨å®šæ—¶è°ƒåº¦å™¨"""
        def scheduler_loop():
            while self.running:
                process_delay_tasks()
                time.sleep(1)  # æ¯ç§’æ‰«æä¸€æ¬¡
                
        thread = threading.Thread(target=scheduler_loop)
        thread.daemon = True
        thread.start()
    
    def stop_scheduler(self):
        self.running = False
```

**é«˜çº§åŠŸèƒ½**ï¼š
```bash
# æŸ¥çœ‹å³å°†æ‰§è¡Œçš„ä»»åŠ¡
ZRANGE delay_queue 0 4 WITHSCORES

# å–æ¶ˆæŸä¸ªå»¶æ—¶ä»»åŠ¡
ZREM delay_queue "order_cancel_1001"

# æŸ¥çœ‹ä»»åŠ¡é˜Ÿåˆ—é•¿åº¦
ZCARD delay_queue
```

---

## 4. âš¡ ç§’æ€ç³»ç»Ÿ


### 4.1 ç§’æ€ç³»ç»Ÿçš„æ ¸å¿ƒæŒ‘æˆ˜


**é—®é¢˜åˆ†æ**ï¼š
- **é«˜å¹¶å‘**ï¼šç¬é—´å¤§é‡ç”¨æˆ·æŠ¢è´­
- **é˜²è¶…å–**ï¼šåº“å­˜100ä»¶ï¼Œä¸èƒ½å–å‡º101ä»¶
- **å…¬å¹³æ€§**ï¼šå…ˆåˆ°å…ˆå¾—ï¼Œä¸èƒ½æ’é˜Ÿ
- **ç³»ç»Ÿç¨³å®š**ï¼šå¤§æµé‡ä¸‹ä¸èƒ½å´©æºƒ

```
ç§’æ€ç¬é—´çš„æµé‡ç‰¹ç‚¹ï¼š
æ­£å¸¸æ—¶æœŸï¼š  ----____----____----
ç§’æ€ç¬é—´ï¼š  --------â–²â–²â–²â–²â–²â–²--------
                    â”‚
                  ç¬é—´å³°å€¼
```

### 4.2 Redisåœ¨ç§’æ€ä¸­çš„ä½œç”¨


**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- **åŸå­æ€§æ“ä½œ**ï¼š`DECR`å‘½ä»¤ä¿è¯å‡åº“å­˜ä¸ä¼šå‡ºé”™
- **é«˜æ€§èƒ½**ï¼šå†…å­˜æ“ä½œï¼Œæ¯«ç§’çº§å“åº”
- **ç®€å•å¯é **ï¼šä¸éœ€è¦å¤æ‚çš„é”æœºåˆ¶

### 4.3 åº“å­˜æ‰£å‡å®ç°


#### ğŸ”¸ åŸºæœ¬åº“å­˜æ“ä½œ


```bash
# åˆå§‹åŒ–å•†å“åº“å­˜
SET product:1001:stock 100

# ç”¨æˆ·æŠ¢è´­ï¼ˆåŸå­æ€§æ‰£å‡ï¼‰
DECR product:1001:stock

# æ£€æŸ¥åº“å­˜
GET product:1001:stock
```

#### ğŸ”¸ é˜²è¶…å–çš„å®‰å…¨å®ç°


```python
def seckill_purchase(product_id, user_id):
    """ç§’æ€è´­ä¹°ï¼Œé˜²æ­¢è¶…å–"""
    
    # æ£€æŸ¥åº“å­˜å¹¶æ‰£å‡ï¼ˆåŸå­æ“ä½œï¼‰
    current_stock = redis.get(f"product:{product_id}:stock")
    
    if current_stock is None or int(current_stock) <= 0:
        return {"success": False, "message": "å•†å“å·²å”®ç½„"}
    
    # åŸå­æ€§æ‰£å‡åº“å­˜
    new_stock = redis.decr(f"product:{product_id}:stock")
    
    if new_stock < 0:
        # è¶…å–äº†ï¼Œå›æ»šåº“å­˜
        redis.incr(f"product:{product_id}:stock")
        return {"success": False, "message": "å•†å“å·²å”®ç½„"}
    
    # è®°å½•è´­ä¹°æˆåŠŸ
    redis.sadd(f"product:{product_id}:buyers", user_id)
    
    return {
        "success": True, 
        "message": f"æŠ¢è´­æˆåŠŸï¼å‰©ä½™åº“å­˜ï¼š{new_stock}"
    }
```

### 4.4 æµé‡å‰Šå³°ç­–ç•¥


#### ğŸ”¸ é¢„çƒ­å’Œåˆ†æµ


**é¢„çƒ­ç­–ç•¥**ï¼š
```python
def preheat_seckill(product_id, total_stock):
    """ç§’æ€é¢„çƒ­ï¼Œæå‰åŠ è½½åˆ°Redis"""
    
    # è®¾ç½®åº“å­˜
    redis.set(f"product:{product_id}:stock", total_stock)
    
    # è®¾ç½®ç§’æ€å¼€å§‹æ—¶é—´
    start_time = time.time() + 300  # 5åˆ†é’Ÿåå¼€å§‹
    redis.set(f"product:{product_id}:start_time", start_time)
    
    # åˆå§‹åŒ–è´­ä¹°è€…é›†åˆ
    redis.delete(f"product:{product_id}:buyers")
```

**åˆ†æµæœºåˆ¶**ï¼š
```bash
# ä½¿ç”¨å¤šä¸ªåº“å­˜é”®åˆ†æ•£å‹åŠ›
SET product:1001:stock:1 25    # åº“å­˜åˆ†ç‰‡1
SET product:1001:stock:2 25    # åº“å­˜åˆ†ç‰‡2
SET product:1001:stock:3 25    # åº“å­˜åˆ†ç‰‡3
SET product:1001:stock:4 25    # åº“å­˜åˆ†ç‰‡4

# éšæœºé€‰æ‹©åˆ†ç‰‡è¿›è¡Œæ‰£å‡
```

### 4.5 ç§’æ€çŠ¶æ€ç®¡ç†


```python
class SeckillManager:
    def __init__(self, product_id):
        self.product_id = product_id
        
    def check_seckill_status(self):
        """æ£€æŸ¥ç§’æ€çŠ¶æ€"""
        start_time = redis.get(f"product:{self.product_id}:start_time")
        current_time = time.time()
        
        if start_time and current_time < float(start_time):
            return "æœªå¼€å§‹"
        
        stock = redis.get(f"product:{self.product_id}:stock")
        if stock and int(stock) > 0:
            return "è¿›è¡Œä¸­"
        
        return "å·²ç»“æŸ"
    
    def get_seckill_info(self):
        """è·å–ç§’æ€ä¿¡æ¯"""
        return {
            "status": self.check_seckill_status(),
            "remaining_stock": redis.get(f"product:{self.product_id}:stock"),
            "buyers_count": redis.scard(f"product:{self.product_id}:buyers")
        }
```

---

## 5. ğŸ« Sessionå…±äº«


### 5.1 Sessionå…±äº«çš„å¿…è¦æ€§


**é—®é¢˜èƒŒæ™¯**ï¼š
```
å•æœºåº”ç”¨ï¼š
ç”¨æˆ· â†’ æœåŠ¡å™¨A â†’ æœ¬åœ°Sessionå­˜å‚¨
é—®é¢˜ï¼šç”¨æˆ·åªèƒ½å›ºå®šè®¿é—®ä¸€å°æœåŠ¡å™¨

é›†ç¾¤åº”ç”¨ï¼ˆæ— Sessionå…±äº«ï¼‰ï¼š
ç”¨æˆ· â†’ è´Ÿè½½å‡è¡¡ â†’ æœåŠ¡å™¨A/B/C â†’ å„è‡ªçš„Sessionå­˜å‚¨
é—®é¢˜ï¼šç”¨æˆ·åœ¨æœåŠ¡å™¨Aç™»å½•ï¼Œè®¿é—®æœåŠ¡å™¨Bæ—¶å˜æˆæœªç™»å½•çŠ¶æ€
```

**Sessionå…±äº«æ–¹æ¡ˆ**ï¼š
```
é›†ç¾¤åº”ç”¨ï¼ˆRedis Sessionå…±äº«ï¼‰ï¼š
ç”¨æˆ· â†’ è´Ÿè½½å‡è¡¡ â†’ æœåŠ¡å™¨A/B/C â†’ Redisç»Ÿä¸€Sessionå­˜å‚¨
æ•ˆæœï¼šç”¨æˆ·åœ¨ä»»æ„æœåŠ¡å™¨ä¸Šéƒ½èƒ½ä¿æŒç™»å½•çŠ¶æ€
```

### 5.2 ä¸ºä»€ä¹ˆç”¨Hashå­˜å‚¨Session


**Hashçš„ä¼˜åŠ¿**ï¼š
- **ç»“æ„åŒ–å­˜å‚¨**ï¼šç”¨æˆ·ä¿¡æ¯å¤©ç„¶æ˜¯é”®å€¼å¯¹ç»“æ„
- **éƒ¨åˆ†æ›´æ–°**ï¼šåªæ›´æ–°å˜åŒ–çš„å­—æ®µï¼Œä¸ç”¨æ•´ä½“æ›¿æ¢
- **æŸ¥è¯¢çµæ´»**ï¼šå¯ä»¥å•ç‹¬è·å–æŸä¸ªå­—æ®µ
- **å†…å­˜æ•ˆç‡**ï¼šæ¯”Stringå­˜å‚¨JSONæ›´èŠ‚çœç©ºé—´

### 5.3 Sessionå­˜å‚¨å®ç°


#### ğŸ”¸ å­˜å‚¨ç”¨æˆ·Session


```python
def create_session(user_id, user_info, expire_time=1800):
    """åˆ›å»ºç”¨æˆ·Session"""
    
    session_id = f"session:{user_id}:{int(time.time())}"
    
    # å­˜å‚¨Sessionæ•°æ®
    session_data = {
        "user_id": user_id,
        "username": user_info["username"],
        "login_time": int(time.time()),
        "last_activity": int(time.time()),
        "ip_address": user_info.get("ip", "unknown")
    }
    
    # ä½¿ç”¨Hashå­˜å‚¨
    redis.hmset(session_id, session_data)
    
    # è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆ30åˆ†é’Ÿï¼‰
    redis.expire(session_id, expire_time)
    
    return session_id
```

#### ğŸ”¸ SessionéªŒè¯å’Œæ›´æ–°


```python
def validate_session(session_id):
    """éªŒè¯Sessionæ˜¯å¦æœ‰æ•ˆ"""
    
    # æ£€æŸ¥Sessionæ˜¯å¦å­˜åœ¨
    if not redis.exists(session_id):
        return None
        
    # è·å–Sessionæ•°æ®
    session_data = redis.hgetall(session_id)
    
    # æ›´æ–°æœ€åæ´»åŠ¨æ—¶é—´
    redis.hset(session_id, "last_activity", int(time.time()))
    
    # ç»­æœŸSession
    redis.expire(session_id, 1800)
    
    return session_data

def logout_user(session_id):
    """ç”¨æˆ·é€€å‡ºï¼Œåˆ é™¤Session"""
    redis.delete(session_id)
```

### 5.4 å•ç‚¹ç™»å½•(SSO)å®ç°


```python
def sso_login(username, password):
    """å•ç‚¹ç™»å½•å®ç°"""
    
    # éªŒè¯ç”¨æˆ·å¯†ç 
    user = authenticate_user(username, password)
    if not user:
        return None
    
    # æ£€æŸ¥æ˜¯å¦å·²æœ‰Session
    existing_session = redis.get(f"user:{user['id']}:session")
    if existing_session:
        # è¸¢å‡ºä¹‹å‰çš„ç™»å½•
        redis.delete(existing_session)
    
    # åˆ›å»ºæ–°Session
    session_id = create_session(user['id'], user)
    
    # å»ºç«‹ç”¨æˆ·IDåˆ°Sessionçš„æ˜ å°„
    redis.set(f"user:{user['id']}:session", session_id, ex=1800)
    
    return session_id
```

### 5.5 Sessioné›†ç¾¤åŒæ­¥


**å¤šRediså®ä¾‹åŒæ­¥**ï¼š
```python
def sync_session_across_clusters(session_id, session_data):
    """è·¨é›†ç¾¤åŒæ­¥Session"""
    
    # ä¸»Rediså†™å…¥
    redis_master.hmset(session_id, session_data)
    
    # ä»RedisåŒæ­¥
    redis_slaves = [redis_slave1, redis_slave2]
    for slave in redis_slaves:
        try:
            slave.hmset(session_id, session_data)
        except:
            pass  # ä»åº“å¤±è´¥ä¸å½±å“ä¸»è¦åŠŸèƒ½
```

---

## 6. ğŸ“Š è®¡æ•°ç»Ÿè®¡ç³»ç»Ÿ


### 6.1 PV/UVç»Ÿè®¡åŸç†


**æ¦‚å¿µè§£é‡Š**ï¼š
- **PVï¼ˆPage Viewï¼‰**ï¼šé¡µé¢è®¿é—®é‡ï¼Œæ¯æ¬¡åˆ·æ–°éƒ½ç®—ä¸€æ¬¡
- **UVï¼ˆUnique Visitorï¼‰**ï¼šç‹¬ç«‹è®¿å®¢ï¼ŒåŒä¸€ç”¨æˆ·å¤šæ¬¡è®¿é—®åªç®—ä¸€æ¬¡

```
PVç»Ÿè®¡ï¼šç”¨Stringç±»å‹çš„è®¡æ•°å™¨ï¼Œæ¯æ¬¡è®¿é—®INCR
UVç»Ÿè®¡ï¼šç”¨Setç±»å‹å­˜å‚¨ç”¨æˆ·IDï¼Œè‡ªåŠ¨å»é‡

ç¤ºä¾‹ï¼š
ä»Šæ—¥PVï¼š1000æ¬¡  ï¼ˆç”¨æˆ·Aè®¿é—®10æ¬¡ï¼Œç”¨æˆ·Bè®¿é—®5æ¬¡...ï¼‰
ä»Šæ—¥UVï¼š50äºº    ï¼ˆç”¨æˆ·Aã€ç”¨æˆ·Bç­‰50ä¸ªä¸åŒçš„äººï¼‰
```

### 6.2 PVç»Ÿè®¡å®ç°


```bash
# æ¯æ¬¡é¡µé¢è®¿é—®
INCR pv:2024-01-21

# æ¯ä¸ªé¡µé¢å•ç‹¬ç»Ÿè®¡
INCR pv:page:home:2024-01-21
INCR pv:page:product:2024-01-21

# æŸ¥çœ‹ä»Šæ—¥æ€»PV
GET pv:2024-01-21
```

```python
def record_page_view(page_id, user_id=None):
    """è®°å½•é¡µé¢è®¿é—®"""
    from datetime import datetime
    
    today = datetime.now().strftime("%Y-%m-%d")
    
    # PVç»Ÿè®¡ï¼ˆæ€»è®¿é—®é‡ï¼‰
    redis.incr(f"pv:{today}")
    redis.incr(f"pv:page:{page_id}:{today}")
    
    # UVç»Ÿè®¡ï¼ˆç‹¬ç«‹è®¿å®¢ï¼‰
    if user_id:
        redis.sadd(f"uv:{today}", user_id)
        redis.sadd(f"uv:page:{page_id}:{today}", user_id)
        
        # è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆä¿ç•™7å¤©æ•°æ®ï¼‰
        redis.expire(f"uv:{today}", 604800)
```

### 6.3 å®æ—¶è®¡æ•°ç³»ç»Ÿ


#### ğŸ”¸ å¤šç»´åº¦è®¡æ•°


```bash
# æŒ‰ä¸åŒç»´åº¦ç»Ÿè®¡
INCR count:total                    # æ€»è®¡æ•°
INCR count:today:2024-01-21         # ä»Šæ—¥è®¡æ•°  
INCR count:hour:2024-01-21:14       # å°æ—¶è®¡æ•°
INCR count:user:1001                # ç”¨æˆ·è®¡æ•°
```

#### ğŸ”¸ æ»‘åŠ¨çª—å£ç»Ÿè®¡


```python
def sliding_window_counter(key, window_seconds=60):
    """æ»‘åŠ¨çª—å£è®¡æ•°å™¨"""
    import time
    
    current_time = int(time.time())
    
    # ä½¿ç”¨ZSetå®ç°æ»‘åŠ¨çª—å£
    # åˆ†æ•°æ˜¯æ—¶é—´æˆ³ï¼Œæˆå‘˜æ˜¯éšæœºæ•°ï¼ˆä¿è¯å”¯ä¸€æ€§ï¼‰
    
    # æ·»åŠ å½“å‰è®¿é—®è®°å½•
    redis.zadd(f"sliding:{key}", {f"{current_time}_{random.randint(1000,9999)}": current_time})
    
    # åˆ é™¤çª—å£å¤–çš„è®°å½•
    redis.zremrangebyscore(f"sliding:{key}", 0, current_time - window_seconds)
    
    # ç»Ÿè®¡çª—å£å†…çš„è®¿é—®æ¬¡æ•°
    count = redis.zcard(f"sliding:{key}")
    
    return count
```

### 6.4 æ•°æ®èšåˆç»Ÿè®¡


#### ğŸ”¸ æŒ‰æ—¶é—´ç»´åº¦èšåˆ


```python
def aggregate_statistics():
    """æ•°æ®èšåˆç»Ÿè®¡"""
    from datetime import datetime, timedelta
    
    # å°æ—¶æ•°æ®èšåˆåˆ°å¤©
    today = datetime.now().strftime("%Y-%m-%d")
    daily_pv = 0
    
    for hour in range(24):
        hour_key = f"pv:hour:{today}:{hour:02d}"
        hour_pv = redis.get(hour_key) or 0
        daily_pv += int(hour_pv)
    
    # å­˜å‚¨æ—¥ç»Ÿè®¡
    redis.set(f"pv:daily:{today}", daily_pv)
    redis.expire(f"pv:daily:{today}", 2592000)  # ä¿ç•™30å¤©
```

#### ğŸ”¸ ç”¨Hashå­˜å‚¨å¤åˆç»Ÿè®¡


```python
def update_comprehensive_stats(user_id, action):
    """æ›´æ–°ç»¼åˆç»Ÿè®¡æ•°æ®"""
    
    today = datetime.now().strftime("%Y-%m-%d")
    stats_key = f"stats:{today}"
    
    # ä½¿ç”¨Hashå­˜å‚¨å¤šä¸ªç»Ÿè®¡æŒ‡æ ‡
    redis.hincrby(stats_key, "total_pv", 1)
    redis.hincrby(stats_key, f"action_{action}", 1)
    redis.hincrby(stats_key, "total_users", 1)
    
    # è®¾ç½®è¿‡æœŸæ—¶é—´
    redis.expire(stats_key, 604800)  # 7å¤©è¿‡æœŸ
    
    # è·å–å½“å‰ç»Ÿè®¡
    current_stats = redis.hgetall(stats_key)
    return current_stats
```

### 6.5 é«˜çº§ç»Ÿè®¡åŠŸèƒ½


**æ¼æ–—ç»Ÿè®¡**ï¼š
```python
def funnel_analysis(user_id, step):
    """æ¼æ–—åˆ†æç»Ÿè®¡"""
    
    steps = ["visit", "view_product", "add_cart", "checkout", "pay"]
    
    if step in steps:
        redis.sadd(f"funnel:{step}:today", user_id)
        
        # è®¾ç½®è¿‡æœŸ
        redis.expire(f"funnel:{step}:today", 86400)

def get_funnel_data():
    """è·å–æ¼æ–—æ•°æ®"""
    steps = ["visit", "view_product", "add_cart", "checkout", "pay"]
    
    result = {}
    for step in steps:
        count = redis.scard(f"funnel:{step}:today")
        result[step] = count
        
    return result
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„åº”ç”¨åœºæ™¯


```
ğŸ† æ’è¡Œæ¦œç³»ç»Ÿï¼š
æ ¸å¿ƒæŠ€æœ¯ â†’ ZSetæœ‰åºé›†åˆ
å…³é”®æ“ä½œ â†’ ZADDã€ZREVRANGEã€ZRANK
åº”ç”¨ä»·å€¼ â†’ æ¸¸æˆæ’è¡Œã€é”€å”®æ¦œå•ã€è¯„åˆ†ç³»ç»Ÿ

â° å»¶æ—¶ä»»åŠ¡ï¼š  
æ ¸å¿ƒæŠ€æœ¯ â†’ ZSetæ—¶é—´æˆ³æ’åº
å…³é”®æ“ä½œ â†’ ZADDæ·»åŠ ä»»åŠ¡ã€ZRANGEBYSCOREæŸ¥è¯¢åˆ°æœŸä»»åŠ¡
åº”ç”¨ä»·å€¼ â†’ è®¢å•è¶…æ—¶ã€å®šæ—¶æé†’ã€ä»»åŠ¡è°ƒåº¦

âš¡ ç§’æ€ç³»ç»Ÿï¼š
æ ¸å¿ƒæŠ€æœ¯ â†’ StringåŸå­æ“ä½œ
å…³é”®æ“ä½œ â†’ DECRæ‰£å‡åº“å­˜ã€åŸå­æ€§ä¿è¯
åº”ç”¨ä»·å€¼ â†’ é˜²æ­¢è¶…å–ã€é«˜å¹¶å‘å¤„ç†

ğŸ« Sessionå…±äº«ï¼š
æ ¸å¿ƒæŠ€æœ¯ â†’ Hashç»“æ„åŒ–å­˜å‚¨
å…³é”®æ“ä½œ â†’ HMSETå­˜å‚¨ã€HGETALLè·å–ã€EXPIREè¿‡æœŸ
åº”ç”¨ä»·å€¼ â†’ é›†ç¾¤ç™»å½•çŠ¶æ€ã€å•ç‚¹ç™»å½•

ğŸ“Š è®¡æ•°ç»Ÿè®¡ï¼š
æ ¸å¿ƒæŠ€æœ¯ â†’ Stringè®¡æ•°å™¨ã€Setå»é‡
å…³é”®æ“ä½œ â†’ INCRè®¡æ•°ã€SADDå»é‡ç»Ÿè®¡
åº”ç”¨ä»·å€¼ â†’ PV/UVç»Ÿè®¡ã€å®æ—¶æ•°æ®åˆ†æ
```

### 7.2 å…³é”®è®¾è®¡åŸåˆ™


**ğŸ”¹ æ•°æ®ç»“æ„é€‰æ‹©åŸåˆ™**
```
æ’åºéœ€æ±‚ â†’ é€‰æ‹©ZSet
å»é‡éœ€æ±‚ â†’ é€‰æ‹©Set  
è®¡æ•°éœ€æ±‚ â†’ é€‰æ‹©String
ç»“æ„åŒ–æ•°æ® â†’ é€‰æ‹©Hash
ç®€å•å­˜å‚¨ â†’ é€‰æ‹©String
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–åŸåˆ™**
```
åŸå­æ€§ä¿è¯ï¼šåˆ©ç”¨Redisçš„å•çº¿ç¨‹ç‰¹æ€§
å†…å­˜æ•ˆç‡ï¼šé€‰æ‹©æœ€é€‚åˆçš„æ•°æ®ç»“æ„
ç½‘ç»œä¼˜åŒ–ï¼šä½¿ç”¨pipelineæ‰¹é‡æ“ä½œ
æ•°æ®æ¸…ç†ï¼šåˆç†è®¾ç½®è¿‡æœŸæ—¶é—´
```

**ğŸ”¹ å¯é æ€§ä¿è¯åŸåˆ™**
```
é˜²è¶…å–ï¼šä½¿ç”¨åŸå­æ“ä½œæ£€æŸ¥å’Œæ‰£å‡
é˜²å¹¶å‘ï¼šåˆ©ç”¨Redisçš„å•çº¿ç¨‹ç‰¹æ€§
é˜²ä¸¢å¤±ï¼šå…³é”®æ•°æ®åšæŒä¹…åŒ–
é˜²é›ªå´©ï¼šè®¾ç½®éšæœºè¿‡æœŸæ—¶é—´
```

### 7.3 å®é™…å¼€å‘å»ºè®®


**âœ… æœ€ä½³å®è·µ**ï¼š

| åœºæ™¯ç±»å‹ | æ¨èæ–¹æ¡ˆ | æ³¨æ„è¦ç‚¹ |
|---------|---------|---------|
| **æ’è¡Œæ¦œ** | `ZSet + å®šæœŸå½’æ¡£` | æ§åˆ¶æ•°æ®é‡ï¼Œå®šæœŸæ¸…ç†å†å²æ•°æ® |
| **å»¶æ—¶ä»»åŠ¡** | `ZSet + å®šæ—¶æ‰«æ` | æ‰«æé¢‘ç‡ä¸è¦å¤ªé«˜ï¼Œé¿å…ç©ºæ‰«æ |
| **ç§’æ€** | `StringåŸå­æ“ä½œ + é¢„çƒ­` | æå‰é¢„çƒ­æ•°æ®ï¼Œä½¿ç”¨åˆ†ç‰‡å‡å‹ |
| **Session** | `Hash + åˆç†è¿‡æœŸ` | è¿‡æœŸæ—¶é—´è®¾ç½®è¦å¹³è¡¡å®‰å…¨å’Œä½“éªŒ |
| **ç»Ÿè®¡** | `å¤šæ•°æ®ç±»å‹ç»„åˆ` | æ ¹æ®ç»Ÿè®¡ç»´åº¦é€‰æ‹©åˆé€‚ç»“æ„ |

**âš ï¸ å¸¸è§é—®é¢˜**ï¼š
- å¿˜è®°è®¾ç½®è¿‡æœŸæ—¶é—´å¯¼è‡´å†…å­˜æ³„éœ²
- é«˜å¹¶å‘ä¸‹æ²¡æœ‰è€ƒè™‘åŸå­æ€§
- æ•°æ®ç»“æ„é€‰æ‹©ä¸å½“å½±å“æ€§èƒ½
- ç¼ºå°‘å¼‚å¸¸å¤„ç†å’Œå›æ»šæœºåˆ¶

**ğŸš€ è¿›é˜¶æŠ€å·§**ï¼š
- ä½¿ç”¨Luaè„šæœ¬ä¿è¯å¤æ‚æ“ä½œçš„åŸå­æ€§
- åˆç†ä½¿ç”¨pipelineæé«˜æ‰¹é‡æ“ä½œæ•ˆç‡
- ç›‘æ§Rediså†…å­˜ä½¿ç”¨å’Œå‘½ä¸­ç‡
- å»ºç«‹å®Œå–„çš„æ•°æ®å¤‡ä»½å’Œæ¢å¤æœºåˆ¶

**æ ¸å¿ƒè®°å¿†**ï¼š
- Redisä¸åªæ˜¯ç¼“å­˜ï¼Œæ›´æ˜¯é«˜æ€§èƒ½æ•°æ®å¤„ç†å·¥å…·
- åˆé€‚çš„æ•°æ®ç»“æ„è§£å†³ç‰¹å®šé—®é¢˜äº‹åŠåŠŸå€
- åŸå­æ“ä½œæ˜¯é«˜å¹¶å‘åœºæ™¯ä¸‹çš„å®‰å…¨ä¿éšœ
- è¿‡æœŸæ—¶é—´ç®¡ç†æ˜¯å†…å­˜ä¼˜åŒ–çš„é‡è¦æ‰‹æ®µ