---
title: 14ã€æ··åˆæŒä¹…åŒ–é…ç½®ç®¡ç†å’Œå®æˆ˜
---
## ğŸ“š ç›®å½•

1. [æ··åˆæŒä¹…åŒ–åŸºæœ¬æ¦‚å¿µ](#1-æ··åˆæŒä¹…åŒ–åŸºæœ¬æ¦‚å¿µ)
2. [é…ç½®å¯ç”¨æ­¥éª¤è¯¦è§£](#2-é…ç½®å¯ç”¨æ­¥éª¤è¯¦è§£)
3. [æ–‡ä»¶æ ¼å¼ç®¡ç†](#3-æ–‡ä»¶æ ¼å¼ç®¡ç†)
4. [ç‰ˆæœ¬å…¼å®¹æ€§å¤„ç†](#4-ç‰ˆæœ¬å…¼å®¹æ€§å¤„ç†)
5. [å®æˆ˜éƒ¨ç½²æŒ‡å—](#5-å®æˆ˜éƒ¨ç½²æŒ‡å—)
6. [ç›‘æ§ä¸ç»´æŠ¤](#6-ç›‘æ§ä¸ç»´æŠ¤)
7. [æ•…éšœå¤„ç†ä¸å›é€€](#7-æ•…éšœå¤„ç†ä¸å›é€€)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”„ æ··åˆæŒä¹…åŒ–åŸºæœ¬æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯æ··åˆæŒä¹…åŒ–


**é€šä¿—ç†è§£**ï¼šæ··åˆæŒä¹…åŒ–å°±åƒæ˜¯**æ‹ç…§ + å½•åƒ**çš„ç»“åˆæ–¹å¼

```
ä¼ ç»Ÿæ–¹å¼å¯¹æ¯”ï¼š
RDBæ–¹å¼ = æ‹ç…§ç‰‡ï¼š
- ä¿å­˜æŸä¸ªæ—¶é—´ç‚¹çš„å®Œæ•´å¿«ç…§
- æ–‡ä»¶å°ï¼Œæ¢å¤å¿«
- ä½†å¯èƒ½ä¸¢å¤±æœ€æ–°æ•°æ®

AOFæ–¹å¼ = å½•åƒå¸¦ï¼š  
- è®°å½•æ¯ä¸ªæ“ä½œå‘½ä»¤
- æ•°æ®å®‰å…¨ï¼Œä¸¢å¤±å°‘
- ä½†æ–‡ä»¶å¤§ï¼Œæ¢å¤æ…¢

æ··åˆæ–¹å¼ = æ‹ç…§ + å½•åƒï¼š
- åŸºç¡€å¿«ç…§(RDB) + å¢é‡å‘½ä»¤(AOF)
- å…¼å…·ä¸¤è€…ä¼˜åŠ¿
- Redis 4.0+ é»˜è®¤æ¨èæ–¹å¼
```

### 1.2 æ··åˆæŒä¹…åŒ–å·¥ä½œåŸç†


**æ•°æ®å­˜å‚¨æµç¨‹**ï¼š
```
æ··åˆæŒä¹…åŒ–æ–‡ä»¶ç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   RDBå¿«ç…§éƒ¨åˆ†    â”‚ â† åŸºç¡€æ•°æ®å¿«ç…§
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   AOFå‘½ä»¤éƒ¨åˆ†    â”‚ â† å¿«ç…§åçš„å¢é‡å‘½ä»¤
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ—¶é—´è½´ç¤ºä¾‹ï¼š
T1: åšRDBå¿«ç…§     â†’ ä¿å­˜æ‰€æœ‰æ•°æ®çŠ¶æ€
T2: æ‰§è¡ŒSET key1  â†’ è®°å½•åˆ°AOFéƒ¨åˆ†  
T3: æ‰§è¡ŒDEL key2  â†’ è®°å½•åˆ°AOFéƒ¨åˆ†
T4: æ‰§è¡ŒINCR key3 â†’ è®°å½•åˆ°AOFéƒ¨åˆ†
```

**æ¢å¤è¿‡ç¨‹**ï¼š
```
æ•°æ®æ¢å¤æµç¨‹ï¼š
Step 1: åŠ è½½RDBå¿«ç…§éƒ¨åˆ† â†’ æ¢å¤åŸºç¡€æ•°æ®çŠ¶æ€
Step 2: é‡æ”¾AOFå‘½ä»¤éƒ¨åˆ† â†’ æ¢å¤å¢é‡å˜åŒ–
Step 3: å®Œæˆæ•°æ®æ¢å¤   â†’ è¾¾åˆ°æœ€æ–°çŠ¶æ€

æ¢å¤æ—¶é—´ = RDBåŠ è½½æ—¶é—´ + AOFé‡æ”¾æ—¶é—´
        â‰ˆ å¿«ç…§å¤§å°/IOé€Ÿåº¦ + å¢é‡å‘½ä»¤æ•° Ã— æ‰§è¡Œé€Ÿåº¦
```

### 1.3 æ··åˆæŒä¹…åŒ–ä¼˜åŠ¿


| æ–¹é¢ | **çº¯RDB** | **çº¯AOF** | **æ··åˆæ–¹å¼** |
|------|-----------|-----------|-------------|
| **æ–‡ä»¶å¤§å°** | `å°` | `å¤§` | `ä¸­ç­‰` |
| **æ¢å¤é€Ÿåº¦** | `å¿«` | `æ…¢` | `è¾ƒå¿«` |
| **æ•°æ®å®‰å…¨** | `å¯èƒ½ä¸¢å¤±` | `å®‰å…¨` | `å®‰å…¨` |
| **CPUå ç”¨** | `ä½` | `é«˜` | `ä¸­ç­‰` |
| **ç£ç›˜IO** | `ä½` | `é«˜` | `ä¸­ç­‰` |

---

## 2. ğŸ”§ é…ç½®å¯ç”¨æ­¥éª¤è¯¦è§£


### 2.1 æ£€æŸ¥Redisç‰ˆæœ¬å…¼å®¹æ€§


**ç‰ˆæœ¬è¦æ±‚æ£€æŸ¥**ï¼š

```bash
# æŸ¥çœ‹Redisç‰ˆæœ¬
redis-server --version
Redis server v=6.2.6 sha=00000000:0 malloc=jemalloc-5.1.0 bits=64 build=7dd7c95b2eb3cd4e

# æˆ–åœ¨redis-cliä¸­æŸ¥çœ‹
127.0.0.1:6379> INFO server
# Server
redis_version:6.2.6
redis_git_sha1:00000000
redis_git_dirty:0
```

**ç‰ˆæœ¬å…¼å®¹æ€§è¯´æ˜**ï¼š
- **Redis 4.0+**ï¼šæ”¯æŒæ··åˆæŒä¹…åŒ–
- **Redis 3.x**ï¼šä¸æ”¯æŒï¼Œéœ€è¦å‡çº§
- **Redis 5.0+**ï¼šæ··åˆæŒä¹…åŒ–ç¨³å®šç‰ˆæœ¬
- **Redis 6.0+**ï¼šæ€§èƒ½è¿›ä¸€æ­¥ä¼˜åŒ–

### 2.2 é…ç½®æ–‡ä»¶ä¿®æ”¹æ­¥éª¤


**Step 1ï¸âƒ£ï¼šå®šä½é…ç½®æ–‡ä»¶**

```bash
# æŸ¥æ‰¾redis.confä½ç½®
find / -name "redis.conf" 2>/dev/null

# å¸¸è§ä½ç½®ï¼š
/etc/redis/redis.conf          # Ubuntu/Debian
/usr/local/etc/redis.conf      # macOS Homebrew
/opt/redis/redis.conf          # æ‰‹åŠ¨ç¼–è¯‘å®‰è£…
```

**Step 2ï¸âƒ£ï¼šå¤‡ä»½åŸé…ç½®**

```bash
# å¤‡ä»½é…ç½®æ–‡ä»¶ï¼ˆé‡è¦ï¼ï¼‰
cp /etc/redis/redis.conf /etc/redis/redis.conf.backup.$(date +%Y%m%d_%H%M%S)

# éªŒè¯å¤‡ä»½
ls -la /etc/redis/redis.conf*
```

**Step 3ï¸âƒ£ï¼šä¿®æ”¹å…³é”®é…ç½®**

```bash
# ç¼–è¾‘é…ç½®æ–‡ä»¶
vim /etc/redis/redis.conf

# å¿…é¡»ä¿®æ”¹çš„é…ç½®é¡¹ï¼š
# 1. å¯ç”¨AOF
appendonly yes

# 2. å¯ç”¨æ··åˆæŒä¹…åŒ–
aof-use-rdb-preamble yes

# 3. è®¾ç½®AOFæ–‡ä»¶å
appendfilename "appendonly.aof"

# 4. è®¾ç½®fsyncç­–ç•¥ï¼ˆæ¨èeverysecï¼‰
appendfsync everysec

# 5. RDBé…ç½®ï¼ˆä¿æŒé»˜è®¤å³å¯ï¼‰
save 900 1      # 900ç§’å†…è‡³å°‘1ä¸ªkeyæ”¹å˜åˆ™ä¿å­˜
save 300 10     # 300ç§’å†…è‡³å°‘10ä¸ªkeyæ”¹å˜åˆ™ä¿å­˜  
save 60 10000   # 60ç§’å†…è‡³å°‘10000ä¸ªkeyæ”¹å˜åˆ™ä¿å­˜
```

### 2.3 é…ç½®ç”Ÿæ•ˆéªŒè¯


**é‡å¯RedisæœåŠ¡**ï¼š

```bash
# systemdç®¡ç†çš„Redis
sudo systemctl restart redis

# æ‰‹åŠ¨å¯åŠ¨çš„Redis
redis-server /etc/redis/redis.conf

# Dockerä¸­çš„Redis
docker restart redis-container
```

**éªŒè¯é…ç½®ç”Ÿæ•ˆ**ï¼š

```bash
# è¿æ¥Redisæ£€æŸ¥é…ç½®
redis-cli

# æ£€æŸ¥AOFæ˜¯å¦å¯ç”¨
127.0.0.1:6379> CONFIG GET appendonly
1) "appendonly"
2) "yes"

# æ£€æŸ¥æ··åˆæŒä¹…åŒ–æ˜¯å¦å¯ç”¨
127.0.0.1:6379> CONFIG GET aof-use-rdb-preamble  
1) "aof-use-rdb-preamble"
2) "yes"

# æ£€æŸ¥å½“å‰æŒä¹…åŒ–çŠ¶æ€
127.0.0.1:6379> LASTSAVE
(integer) 1643123456    # æœ€åä¸€æ¬¡RDBä¿å­˜æ—¶é—´æˆ³
```

### 2.4 è¿è¡ŒçŠ¶æ€ç›‘æ§


**å®æ—¶ç›‘æ§å‘½ä»¤**ï¼š

```bash
# æŸ¥çœ‹æŒä¹…åŒ–ç›¸å…³ä¿¡æ¯
127.0.0.1:6379> INFO persistence
# Persistence
loading:0
rdb_changes_since_last_save:0
rdb_bgsave_in_progress:0
rdb_last_save_time:1643123456
rdb_last_bgsave_status:ok
rdb_last_bgsave_time_sec:-1
rdb_current_bgsave_time_sec:-1
aof_enabled:1                    # AOFå·²å¯ç”¨
aof_rewrite_in_progress:0
aof_rewrite_scheduled:0
aof_last_rewrite_time_sec:-1
aof_current_rewrite_time_sec:-1
aof_last_bgrewrite_status:ok
aof_last_write_status:ok
aof_current_size:64              # å½“å‰AOFæ–‡ä»¶å¤§å°
aof_base_size:64                 # åŸºç¡€AOFæ–‡ä»¶å¤§å°
```

**æ–‡ä»¶ç›‘æ§**ï¼š

```bash
# æŸ¥çœ‹æŒä¹…åŒ–æ–‡ä»¶
ls -la /var/lib/redis/
-rw-r--r-- 1 redis redis  1024 Jan 28 10:30 dump.rdb
-rw-r--r-- 1 redis redis  2048 Jan 28 10:45 appendonly.aof

# å®æ—¶ç›‘æ§æ–‡ä»¶å¤§å°å˜åŒ–
watch -n 5 'ls -lh /var/lib/redis/'
```

---

## 3. ğŸ“ æ–‡ä»¶æ ¼å¼ç®¡ç†


### 3.1 æ··åˆæ–‡ä»¶ç»“æ„åˆ†æ


**æ–‡ä»¶å†…å®¹ç»„æˆ**ï¼š

```
æ··åˆAOFæ–‡ä»¶ç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        æ–‡ä»¶å¤´æ ‡è¯†                â”‚ â† Redisç‰ˆæœ¬ä¿¡æ¯
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  
â”‚                               â”‚
â”‚         RDBå¿«ç…§æ•°æ®             â”‚ â† äºŒè¿›åˆ¶æ ¼å¼çš„å®Œæ•´æ•°æ®å¿«ç…§
â”‚     ï¼ˆäºŒè¿›åˆ¶æ ¼å¼ï¼‰              â”‚
â”‚                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         AOFå‘½ä»¤åºåˆ—             â”‚ â† æ–‡æœ¬æ ¼å¼çš„Rediså‘½ä»¤
â”‚     *3                        â”‚
â”‚     $3                        â”‚   
â”‚     SET                       â”‚
â”‚     $4                        â”‚
â”‚     key1                      â”‚
â”‚     $6                        â”‚
â”‚     value1                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ–‡ä»¶ç‰¹å¾è¯†åˆ«**ï¼š

```bash
# æ£€æŸ¥æ˜¯å¦ä¸ºæ··åˆæ–‡ä»¶
file /var/lib/redis/appendonly.aof
/var/lib/redis/appendonly.aof: data    # æ··åˆæ–‡ä»¶æ˜¾ç¤ºä¸ºdataï¼ˆåŒ…å«äºŒè¿›åˆ¶ï¼‰

# çº¯AOFæ–‡ä»¶ä¼šæ˜¾ç¤ºä¸ºï¼š
/var/lib/redis/appendonly.aof: ASCII text    # çº¯æ–‡æœ¬æ–‡ä»¶

# æŸ¥çœ‹æ–‡ä»¶å¼€å¤´ï¼ˆæ··åˆæ–‡ä»¶å‰éƒ¨åˆ†æ˜¯äºŒè¿›åˆ¶ï¼‰
hexdump -C /var/lib/redis/appendonly.aof | head -10
```

### 3.2 æ–‡ä»¶å¤§å°å˜åŒ–ç›‘æ§


**å¤§å°å˜åŒ–è§„å¾‹**ï¼š

```bash
# åˆ›å»ºç›‘æ§è„šæœ¬
cat > aof_monitor.sh << 'EOF'
#!/bin/bash

AOF_FILE="/var/lib/redis/appendonly.aof"
LOG_FILE="/var/log/redis/aof_size.log"

while true; do
    if [ -f "$AOF_FILE" ]; then
        SIZE=$(stat -c%s "$AOF_FILE")
        SIZE_MB=$(echo "scale=2; $SIZE/1024/1024" | bc)
        TIMESTAMP=$(date "+%Y-%m-%d %H:%M:%S")
        echo "$TIMESTAMP AOFæ–‡ä»¶å¤§å°: ${SIZE_MB}MB" | tee -a "$LOG_FILE"
    fi
    sleep 300  # æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
done
EOF

chmod +x aof_monitor.sh
```

**å¤§å°å¢é•¿åˆ†æ**ï¼š

| æ—¶æœŸ | **RDBéƒ¨åˆ†** | **AOFéƒ¨åˆ†** | **æ€»å¤§å°** | **å¢é•¿åŸå› ** |
|------|-----------|-----------|-----------|-------------|
| **åˆå§‹åŒ–** | `100MB` | `0MB` | `100MB` | `åŸºç¡€å¿«ç…§` |
| **è¿è¡Œ1å°æ—¶** | `100MB` | `50MB` | `150MB` | `å¢é‡å‘½ä»¤ç´¯ç§¯` |
| **é‡å†™å** | `120MB` | `10MB` | `130MB` | `é‡å†™ä¼˜åŒ–` |
| **è¿è¡Œ6å°æ—¶** | `120MB` | `80MB` | `200MB` | `æŒç»­å†™å…¥` |

### 3.3 æ–‡ä»¶å¤‡ä»½ç­–ç•¥è°ƒæ•´


**æ··åˆæ–‡ä»¶å¤‡ä»½ç‰¹ç‚¹**ï¼š

```bash
# ä¼ ç»ŸAOFå¤‡ä»½ï¼ˆæ–‡ä»¶è¾ƒå¤§ï¼‰
cp appendonly.aof appendonly.aof.backup    # å¤‡ä»½æ•´ä¸ªæ–‡ä»¶

# æ··åˆæ–‡ä»¶å¤‡ä»½ç­–ç•¥
# æ–¹æ¡ˆ1ï¼šå®Œæ•´å¤‡ä»½ï¼ˆæ¨èï¼‰
rsync -av /var/lib/redis/appendonly.aof /backup/redis/$(date +%Y%m%d_%H%M%S)/

# æ–¹æ¡ˆ2ï¼šå¢é‡å¤‡ä»½ï¼ˆå¤æ‚ï¼Œä¸æ¨èï¼‰
# å› ä¸ºæ··åˆæ–‡ä»¶æ ¼å¼å¤æ‚ï¼Œä¸å»ºè®®å¢é‡å¤‡ä»½
```

**å¤‡ä»½é¢‘ç‡å»ºè®®**ï¼š

```
é«˜é‡è¦æ€§ç³»ç»Ÿï¼šæ¯å°æ—¶å¤‡ä»½
ä¸€èˆ¬ä¸šåŠ¡ç³»ç»Ÿï¼šæ¯4-6å°æ—¶å¤‡ä»½
æµ‹è¯•ç¯å¢ƒï¼šæ¯å¤©å¤‡ä»½

å¤‡ä»½ä¿ç•™ç­–ç•¥ï¼š
â€¢ æœ€è¿‘24å°æ—¶ï¼šæ¯å°æ—¶å¤‡ä»½
â€¢ æœ€è¿‘7å¤©ï¼šæ¯å¤©å¤‡ä»½  
â€¢ æœ€è¿‘30å¤©ï¼šæ¯å‘¨å¤‡ä»½
â€¢ é•¿æœŸå½’æ¡£ï¼šæ¯æœˆå¤‡ä»½
```

### 3.4 æ–‡ä»¶ä¼ è¾“æ³¨æ„äº‹é¡¹


**ä¼ è¾“å®‰å…¨æ€§**ï¼š

```bash
# åŠ å¯†ä¼ è¾“ï¼ˆæ¨èï¼‰
scp -C /var/lib/redis/appendonly.aof user@backup-server:/backup/redis/

# å‹ç¼©ä¼ è¾“ï¼ˆèŠ‚çœå¸¦å®½ï¼‰
tar -czf - /var/lib/redis/appendonly.aof | \
  ssh user@backup-server "cat > /backup/redis/aof_$(date +%Y%m%d).tar.gz"

# æ ¡éªŒä¼ è¾“å®Œæ•´æ€§
md5sum /var/lib/redis/appendonly.aof > aof.md5
scp aof.md5 user@backup-server:/backup/redis/
# åœ¨ç›®æ ‡æœåŠ¡å™¨éªŒè¯
ssh user@backup-server "cd /backup/redis && md5sum -c aof.md5"
```

---

## 4. ğŸ”„ ç‰ˆæœ¬å…¼å®¹æ€§å¤„ç†


### 4.1 Redisç‰ˆæœ¬è¦æ±‚


**ç‰ˆæœ¬æ”¯æŒæƒ…å†µ**ï¼š

| Redisç‰ˆæœ¬ | **æ··åˆæŒä¹…åŒ–æ”¯æŒ** | **ç¨³å®šæ€§** | **æ¨èåº¦** |
|-----------|------------------|-----------|-----------|
| **3.xåŠä»¥ä¸‹** | `âŒ ä¸æ”¯æŒ` | `-` | `éœ€è¦å‡çº§` |
| **4.0-4.2** | `âœ… å®éªŒæ€§æ”¯æŒ` | `âš ï¸ ä¸€èˆ¬` | `å¯ç”¨ä½†éœ€æµ‹è¯•` |
| **5.0-5.2** | `âœ… æ­£å¼æ”¯æŒ` | `ğŸŸ¢ ç¨³å®š` | `æ¨èä½¿ç”¨` |
| **6.0+** | `âœ… ä¼˜åŒ–æ”¯æŒ` | `ğŸŸ¢ å¾ˆç¨³å®š` | `å¼ºçƒˆæ¨è` |

### 4.2 è€ç‰ˆæœ¬å‡çº§æ³¨æ„äº‹é¡¹


**å‡çº§å‰å‡†å¤‡**ï¼š

```bash
# 1. æ•°æ®å¤‡ä»½
redis-cli BGSAVE                    # åˆ›å»ºRDBå¿«ç…§
redis-cli BGREWRITEAOF             # é‡å†™AOFæ–‡ä»¶

# 2. æŸ¥çœ‹å½“å‰é…ç½®
redis-cli CONFIG GET "*"           # å¯¼å‡ºæ‰€æœ‰é…ç½®

# 3. æ£€æŸ¥æŒä¹…åŒ–çŠ¶æ€  
redis-cli LASTSAVE                 # æœ€åä¿å­˜æ—¶é—´
redis-cli INFO persistence        # æŒä¹…åŒ–ä¿¡æ¯
```

**å‡çº§æ‰§è¡Œæ­¥éª¤**ï¼š

```bash
# Step 1: åœæ­¢RedisæœåŠ¡
sudo systemctl stop redis

# Step 2: å¤‡ä»½æ•°æ®ç›®å½•
cp -r /var/lib/redis /var/lib/redis.backup.$(date +%Y%m%d)

# Step 3: å‡çº§Redis
# Ubuntu/Debian:
sudo apt update && sudo apt install redis-server

# CentOS/RHEL:  
sudo yum update redis

# Step 4: æ£€æŸ¥é…ç½®å…¼å®¹æ€§
redis-server --test-config -c /etc/redis/redis.conf

# Step 5: å¯åŠ¨æ–°ç‰ˆæœ¬
sudo systemctl start redis
```

### 4.3 é…ç½®è¿ç§»ç­–ç•¥


**é…ç½®æ–‡ä»¶è¿ç§»**ï¼š

```bash
# å¯¹æ¯”æ–°æ—§é…ç½®æ–‡ä»¶
diff /etc/redis/redis.conf /etc/redis/redis.conf.backup

# é‡ç‚¹æ£€æŸ¥çš„é…ç½®é¡¹ï¼š
grep -E "(appendonly|aof-use-rdb-preamble|save)" /etc/redis/redis.conf

# è¾“å‡ºç¤ºä¾‹ï¼š
appendonly yes                    # å¯ç”¨AOF
aof-use-rdb-preamble yes         # å¯ç”¨æ··åˆæŒä¹…åŒ–
save 900 1                       # RDBä¿å­˜ç­–ç•¥
```

**æ–°å¢é…ç½®é¡¹**ï¼š

```bash
# Redis 4.0+ æ–°å¢çš„æ··åˆæŒä¹…åŒ–ç›¸å…³é…ç½®
aof-use-rdb-preamble yes         # å¯ç”¨æ··åˆæ ¼å¼
aof-load-truncated yes           # å…è®¸åŠ è½½ä¸å®Œæ•´çš„AOF
aof-rewrite-incremental-fsync yes # AOFé‡å†™æ—¶å¢é‡åŒæ­¥
```

### 4.4 é™çº§å›é€€æ–¹æ¡ˆ


**ç´§æ€¥å›é€€æ­¥éª¤**ï¼š

```bash
# 1. ç«‹å³åœæ­¢Redis
sudo systemctl stop redis

# 2. æ¢å¤åŸç‰ˆæœ¬
sudo apt install redis-server=æ—§ç‰ˆæœ¬å·    # Debian/Ubuntu
sudo yum downgrade redis                  # CentOS/RHEL

# 3. æ¢å¤é…ç½®æ–‡ä»¶
cp /etc/redis/redis.conf.backup /etc/redis/redis.conf

# 4. æ¢å¤æ•°æ®æ–‡ä»¶
cp /var/lib/redis.backup/dump.rdb /var/lib/redis/
cp /var/lib/redis.backup/appendonly.aof /var/lib/redis/

# 5. å¯åŠ¨æœåŠ¡
sudo systemctl start redis
```

---

## 5. âš¡ å®æˆ˜éƒ¨ç½²æŒ‡å—


### 5.1 åœ¨çº¿åˆ‡æ¢åˆ°æ··åˆæŒä¹…åŒ–


**ğŸ”¥ é›¶åœæœºåˆ‡æ¢æ–¹æ¡ˆ**ï¼š

```bash
# Step 1: ç¡®ä¿å½“å‰æ•°æ®å®‰å…¨
redis-cli BGSAVE                    # åå°ä¿å­˜RDB
redis-cli BGREWRITEAOF             # åå°é‡å†™AOF

# Step 2: ç­‰å¾…åå°æ“ä½œå®Œæˆ
redis-cli LASTSAVE                 # æ£€æŸ¥BGSAVEå®Œæˆ
redis-cli INFO persistence | grep aof_rewrite_in_progress
# aof_rewrite_in_progress:0 è¡¨ç¤ºé‡å†™å®Œæˆ

# Step 3: åŠ¨æ€å¯ç”¨æ··åˆæŒä¹…åŒ–
redis-cli CONFIG SET aof-use-rdb-preamble yes
OK

# Step 4: éªŒè¯é…ç½®ç”Ÿæ•ˆ
redis-cli CONFIG GET aof-use-rdb-preamble
1) "aof-use-rdb-preamble"
2) "yes"

# Step 5: æŒä¹…åŒ–é…ç½®åˆ°æ–‡ä»¶
redis-cli CONFIG REWRITE
```

### 5.2 åˆ‡æ¢è¿‡ç¨‹é£é™©æ§åˆ¶


**é£é™©æ§åˆ¶çŸ©é˜µ**ï¼š

| é£é™©ç±»å‹ | **å¯èƒ½å½±å“** | **é¢„é˜²æªæ–½** | **åº”æ€¥æ–¹æ¡ˆ** |
|---------|-------------|-------------|-------------|
| **é…ç½®é”™è¯¯** | `æœåŠ¡æ— æ³•å¯åŠ¨` | `å¤‡ä»½é…ç½®æ–‡ä»¶` | `æ¢å¤å¤‡ä»½é…ç½®` |
| **æ•°æ®ä¸¢å¤±** | `å†å²æ•°æ®ä¸¢å¤±` | `å¤šé‡å¤‡ä»½æ•°æ®` | `ä»å¤‡ä»½æ¢å¤` |
| **æ€§èƒ½ä¸‹é™** | `å“åº”å˜æ…¢` | `æµ‹è¯•ç¯å¢ƒéªŒè¯` | `å›é€€åŸé…ç½®` |
| **ç£ç›˜ç©ºé—´** | `ç©ºé—´ä¸è¶³` | `ç›‘æ§ç£ç›˜ä½¿ç”¨ç‡` | `æ¸…ç†æˆ–æ‰©å®¹` |

**åˆ‡æ¢æ—¶é—´çª—å£é€‰æ‹©**ï¼š

```
æœ€ä½³åˆ‡æ¢æ—¶æœºï¼š
ğŸŸ¢ ä¸šåŠ¡ä½å³°æœŸï¼šå‡Œæ™¨2-5ç‚¹
ğŸŸ¢ ç»´æŠ¤çª—å£ï¼šè®¡åˆ’ç»´æŠ¤æ—¶é—´
ğŸŸ¢ å‘¨æœ«æ—¶é—´ï¼šç”¨æˆ·è®¿é—®é‡ä½

é¿å…åˆ‡æ¢æ—¶æœºï¼š
ğŸ”´ ä¸šåŠ¡é«˜å³°æœŸï¼šç™½å¤©å·¥ä½œæ—¶é—´
ğŸ”´ æ´»åŠ¨æœŸé—´ï¼šä¿ƒé”€ã€ç§’æ€æ´»åŠ¨
ğŸ”´ å…³é”®èŠ‚ç‚¹ï¼šæœˆæœ«ç»“ç®—ã€å¹´åº¦æ±‡æ€»
```

### 5.3 åˆ‡æ¢åæ€§èƒ½éªŒè¯


**æ€§èƒ½åŸºå‡†æµ‹è¯•**ï¼š

```bash
# åˆ‡æ¢å‰æ€§èƒ½åŸºå‡†
redis-benchmark -t set,get -n 100000 -q
SET: 89285.71 requests per second
GET: 94339.62 requests per second

# åˆ‡æ¢åæ€§èƒ½å¯¹æ¯”
redis-benchmark -t set,get -n 100000 -q  
SET: 87565.43 requests per second    # ç•¥æœ‰ä¸‹é™ï¼ˆæ­£å¸¸ï¼‰
GET: 93458.76 requests per second    # åŸºæœ¬æ— å½±å“

# æ€§èƒ½ä¸‹é™åœ¨5%ä»¥å†…å±äºæ­£å¸¸èŒƒå›´
```

**å…³é”®æŒ‡æ ‡ç›‘æ§**ï¼š

```bash
# ç›‘æ§å†…å­˜ä½¿ç”¨
redis-cli INFO memory | grep used_memory_human
used_memory_human:256.12M

# ç›‘æ§å‘½ä»¤æ‰§è¡Œæ—¶é—´
redis-cli --latency-history -h 127.0.0.1 -p 6379

# ç›‘æ§æŒä¹…åŒ–æ“ä½œ
redis-cli INFO persistence | grep -E "(rdb_last_save_time|aof_last_rewrite_time)"
```

---

## 6. ğŸ“Š ç›‘æ§ä¸ç»´æŠ¤


### 6.1 æ—¥å¸¸ç›‘æ§æŒ‡æ ‡


**æ ¸å¿ƒç›‘æ§é¡¹ç›®**ï¼š

```bash
# åˆ›å»ºç›‘æ§è„šæœ¬
cat > redis_hybrid_monitor.sh << 'EOF'
#!/bin/bash

REDIS_CLI="redis-cli"
LOG_FILE="/var/log/redis/hybrid_monitor.log"

# è·å–æ—¶é—´æˆ³
TIMESTAMP=$(date "+%Y-%m-%d %H:%M:%S")

# æ£€æŸ¥æ··åˆæŒä¹…åŒ–çŠ¶æ€
AOF_ENABLED=$($REDIS_CLI CONFIG GET appendonly | tail -1)
HYBRID_ENABLED=$($REDIS_CLI CONFIG GET aof-use-rdb-preamble | tail -1)

# è·å–æ–‡ä»¶å¤§å°
AOF_SIZE=$(stat -c%s /var/lib/redis/appendonly.aof 2>/dev/null || echo "0")
AOF_SIZE_MB=$(echo "scale=2; $AOF_SIZE/1024/1024" | bc)

# è®°å½•æ—¥å¿—
echo "$TIMESTAMP AOF:$AOF_ENABLED æ··åˆ:$HYBRID_ENABLED æ–‡ä»¶å¤§å°:${AOF_SIZE_MB}MB" >> "$LOG_FILE"
EOF
```

### 6.2 è‡ªåŠ¨ç»´æŠ¤ä»»åŠ¡


**AOFé‡å†™è‡ªåŠ¨è§¦å‘**ï¼š

```bash
# é…ç½®è‡ªåŠ¨é‡å†™æ¡ä»¶
auto-aof-rewrite-percentage 100     # æ–‡ä»¶å¤§å°ç¿»å€æ—¶é‡å†™
auto-aof-rewrite-min-size 64mb      # æœ€å°64MBæ‰è€ƒè™‘é‡å†™

# æ‰‹åŠ¨è§¦å‘é‡å†™
redis-cli BGREWRITEAOF

# æ£€æŸ¥é‡å†™çŠ¶æ€
redis-cli INFO persistence | grep aof_rewrite
```

**å®šæ—¶æ¸…ç†è„šæœ¬**ï¼š

```bash
# åˆ›å»ºæ¸…ç†è„šæœ¬
cat > redis_cleanup.sh << 'EOF'
#!/bin/bash

# æ¸…ç†è¿‡æœŸçš„å¤‡ä»½æ–‡ä»¶ï¼ˆä¿ç•™7å¤©ï¼‰
find /backup/redis/ -name "*.aof" -mtime +7 -delete
find /backup/redis/ -name "*.rdb" -mtime +7 -delete

# å‹ç¼©æ—§çš„æ—¥å¿—æ–‡ä»¶
find /var/log/redis/ -name "*.log" -size +100M -exec gzip {} \;

# è®°å½•æ¸…ç†æ“ä½œ
echo "$(date) Redisæ–‡ä»¶æ¸…ç†å®Œæˆ" >> /var/log/redis/cleanup.log
EOF

# æ·»åŠ åˆ°å®šæ—¶ä»»åŠ¡
crontab -e
0 2 * * * /path/to/redis_cleanup.sh
```

---

## 7. ğŸš¨ æ•…éšœå¤„ç†ä¸å›é€€


### 7.1 å¸¸è§é—®é¢˜è¯Šæ–­


**é—®é¢˜1ï¼šæ··åˆæ–‡ä»¶æŸå**

```bash
# ç—‡çŠ¶ï¼šRediså¯åŠ¨å¤±è´¥ï¼ŒæŠ¥AOFæ–‡ä»¶é”™è¯¯
# è¯Šæ–­å‘½ä»¤
redis-check-aof /var/lib/redis/appendonly.aof

# å¯èƒ½çš„è¾“å‡º
AOF analyzed, error found at position 1234567
The AOF appears to be truncated

# ä¿®å¤æ–¹æ¡ˆ
redis-check-aof --fix /var/lib/redis/appendonly.aof
```

**é—®é¢˜2ï¼šæ€§èƒ½ä¸¥é‡ä¸‹é™**

```bash
# ç—‡çŠ¶ï¼šå†™å…¥æ“ä½œå˜æ…¢
# è¯Šæ–­ï¼šæ£€æŸ¥AOFæ–‡ä»¶å¤§å°
ls -lh /var/lib/redis/appendonly.aof
-rw-r--r-- 1 redis redis 2.1G Jan 28 15:30 appendonly.aof    # æ–‡ä»¶è¿‡å¤§

# è§£å†³ï¼šæ‰‹åŠ¨è§¦å‘AOFé‡å†™
redis-cli BGREWRITEAOF

# éªŒè¯ï¼šç­‰å¾…é‡å†™å®Œæˆ
redis-cli INFO persistence | grep aof_rewrite_in_progress
aof_rewrite_in_progress:0    # 0è¡¨ç¤ºé‡å†™å®Œæˆ
```

### 7.2 ç´§æ€¥å›é€€é¢„æ¡ˆ


**å®Œæ•´å›é€€æ­¥éª¤**ï¼š

```bash
# ç´§æ€¥æƒ…å†µï¼šæ··åˆæŒä¹…åŒ–å‡ºç°ä¸¥é‡é—®é¢˜

# Step 1: ç«‹å³åœæ­¢Redis
sudo systemctl stop redis

# Step 2: ç¦ç”¨æ··åˆæŒä¹…åŒ–
sed -i 's/aof-use-rdb-preamble yes/aof-use-rdb-preamble no/' /etc/redis/redis.conf

# Step 3: ä»æœ€è¿‘çš„RDBæ¢å¤
cp /backup/redis/latest/dump.rdb /var/lib/redis/
rm /var/lib/redis/appendonly.aof    # åˆ é™¤é—®é¢˜AOFæ–‡ä»¶

# Step 4: é‡å¯Redisï¼ˆæ­¤æ—¶åªä½¿ç”¨RDBï¼‰
sudo systemctl start redis

# Step 5: éªŒè¯æ•°æ®å®Œæ•´æ€§
redis-cli DBSIZE                     # æ£€æŸ¥keyæ•°é‡
redis-cli RANDOMKEY                  # éšæœºæ£€æŸ¥æ•°æ®
```

### 7.3 æ•°æ®æ¢å¤éªŒè¯


**æ¢å¤åéªŒè¯æ¸…å•**ï¼š

```bash
# âœ… æœåŠ¡çŠ¶æ€æ£€æŸ¥
sudo systemctl status redis
# â— redis.service - Advanced key-value store
#    Active: active (running)

# âœ… è¿æ¥æµ‹è¯•
redis-cli ping
# PONG

# âœ… æ•°æ®é‡æ£€æŸ¥
redis-cli DBSIZE
(integer) 12345    # ä¸å¤‡ä»½å‰æ•°æ®é‡å¯¹æ¯”

# âœ… å…³é”®æ•°æ®æŠ½æŸ¥
redis-cli GET critical_config_key
"expected_value"    # æ£€æŸ¥å…³é”®é…ç½®æ˜¯å¦æ­£ç¡®

# âœ… æ€§èƒ½æµ‹è¯•
redis-benchmark -t set,get -n 10000 -q
SET: 85000+ requests per second    # æ€§èƒ½åº”è¯¥æ­£å¸¸
GET: 90000+ requests per second
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 æ··åˆæŒä¹…åŒ–æ ¸å¿ƒé…ç½®


```
ğŸ”¸ å¿…é¡»é…ç½®é¡¹ï¼š
â€¢ appendonly yes                 # å¯ç”¨AOF
â€¢ aof-use-rdb-preamble yes      # å¯ç”¨æ··åˆæ ¼å¼

ğŸ”¸ æ¨èé…ç½®é¡¹ï¼š
â€¢ appendfsync everysec          # æ¯ç§’åŒæ­¥ä¸€æ¬¡
â€¢ auto-aof-rewrite-percentage 100  # è‡ªåŠ¨é‡å†™é˜ˆå€¼
â€¢ aof-load-truncated yes        # å…è®¸åŠ è½½æˆªæ–­æ–‡ä»¶
```

### 8.2 ç‰ˆæœ¬å…¼å®¹æ€§è¦ç‚¹


```
âœ… Redis 4.0+ï¼šåŸºæœ¬æ”¯æŒæ··åˆæŒä¹…åŒ–
âœ… Redis 5.0+ï¼šç¨³å®šæ”¯æŒï¼Œæ¨èä½¿ç”¨
âœ… Redis 6.0+ï¼šæ€§èƒ½ä¼˜åŒ–ï¼Œå¼ºçƒˆæ¨è

âš ï¸ å‡çº§æ³¨æ„ï¼š
â€¢ å¿…é¡»å…ˆå¤‡ä»½æ•°æ®
â€¢ æµ‹è¯•ç¯å¢ƒéªŒè¯é…ç½®
â€¢ å‡†å¤‡å›é€€æ–¹æ¡ˆ
```

### 8.3 æ–‡ä»¶ç®¡ç†è¦ç‚¹


```
ğŸ“ æ–‡ä»¶ç»“æ„ï¼šRDBå¿«ç…§ + AOFå‘½ä»¤çš„æ··åˆæ ¼å¼
ğŸ“Š å¤§å°ç›‘æ§ï¼šå®šæœŸæ£€æŸ¥æ–‡ä»¶å¤§å°ï¼Œé¿å…è¿‡å¤§å½±å“æ€§èƒ½
ğŸ’¾ å¤‡ä»½ç­–ç•¥ï¼šå®Œæ•´å¤‡ä»½ï¼Œå®šæœŸæ¸…ç†ï¼ŒåŠ å¯†ä¼ è¾“
ğŸ”„ é‡å†™æœºåˆ¶ï¼šè‡ªåŠ¨é‡å†™ä¼˜åŒ–æ–‡ä»¶å¤§å°å’Œæ¢å¤é€Ÿåº¦
```

### 8.4 å®æˆ˜éƒ¨ç½²å…³é”®ç‚¹


```
ğŸ”§ åœ¨çº¿åˆ‡æ¢ï¼šä½¿ç”¨CONFIG SETåŠ¨æ€å¯ç”¨ï¼Œæ— éœ€é‡å¯
âš¡ æ€§èƒ½éªŒè¯ï¼šåˆ‡æ¢åç›‘æ§å†™å…¥æ€§èƒ½ï¼Œç¡®ä¿æ— æ˜æ˜¾ä¸‹é™
ğŸš¨ é£é™©æ§åˆ¶ï¼šé€‰æ‹©ä½å³°æœŸæ“ä½œï¼Œå‡†å¤‡å›é€€é¢„æ¡ˆ
ğŸ“ˆ æŒç»­ç›‘æ§ï¼šç›‘æ§æ–‡ä»¶å¤§å°ã€é‡å†™é¢‘ç‡ã€ç³»ç»Ÿæ€§èƒ½
```

### 8.5 æ•…éšœå¤„ç†è¦ç‚¹


```
ğŸ” æ•…éšœè¯Šæ–­ï¼š
â€¢ ä½¿ç”¨redis-check-aofæ£€æŸ¥æ–‡ä»¶å®Œæ•´æ€§
â€¢ ç›‘æ§ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ
â€¢ æŸ¥çœ‹Redisæ—¥å¿—æ–‡ä»¶

ğŸ› ï¸ ä¿®å¤æ–¹æ¡ˆï¼š
â€¢ æ–‡ä»¶æŸåï¼šä½¿ç”¨redis-check-aof --fixä¿®å¤
â€¢ æ€§èƒ½é—®é¢˜ï¼šæ‰‹åŠ¨è§¦å‘AOFé‡å†™
â€¢ ä¸¥é‡æ•…éšœï¼šå›é€€åˆ°çº¯RDBæ¨¡å¼

ğŸ’¡ é¢„é˜²æªæ–½ï¼š
â€¢ å®šæœŸå¤‡ä»½æ•°æ®æ–‡ä»¶
â€¢ ç›‘æ§ç£ç›˜ç©ºé—´ä½¿ç”¨
â€¢ è®¾ç½®åˆç†çš„é‡å†™é˜ˆå€¼
```

**è®°å¿†è¦ç‚¹**ï¼š
```
æ··åˆæŒä¹…åŒ–é…ç½®è¦ç‚¹ï¼šç‰ˆæœ¬4.0èµ·ï¼Œé…ç½®ä¸¤è¡Œä»£ç 
æ–‡ä»¶ç®¡ç†æ ¸å¿ƒï¼šç»“æ„æ··åˆè¦ç†è§£ï¼Œå¤§å°ç›‘æ§ä¸èƒ½å¿˜
ç‰ˆæœ¬å‡çº§æ³¨æ„ï¼šå¤‡ä»½å…ˆè¡Œæµ‹è¯•åï¼Œå›é€€é¢„æ¡ˆè¦å‡†å¤‡
å®æˆ˜éƒ¨ç½²é‡ç‚¹ï¼šåœ¨çº¿åˆ‡æ¢å¾ˆå®‰å…¨ï¼Œç›‘æ§éªŒè¯æ˜¯å…³é”®
```