---
title: 4ã€è¯»å†™åˆ†ç¦»å®æˆ˜
---
## ğŸ“š ç›®å½•

1. [è¯»å†™åˆ†ç¦»æ¶æ„è®¾è®¡](#1-è¯»å†™åˆ†ç¦»æ¶æ„è®¾è®¡)
2. [æ•°æ®ä¸€è‡´æ€§å¤„ç†](#2-æ•°æ®ä¸€è‡´æ€§å¤„ç†)
3. [æ•…éšœå¤„ç†æœºåˆ¶](#3-æ•…éšœå¤„ç†æœºåˆ¶)
4. [å®æˆ˜é…ç½®ä¸ç›‘æ§](#4-å®æˆ˜é…ç½®ä¸ç›‘æ§)
5. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#5-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ—ï¸ è¯»å†™åˆ†ç¦»æ¶æ„è®¾è®¡


### 1.1 è¯»å†™åˆ†ç¦»åŸºæœ¬æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯è¯»å†™åˆ†ç¦»**ï¼š
æŠŠæ•°æ®çš„è¯»æ“ä½œå’Œå†™æ“ä½œåˆ†åˆ«äº¤ç»™ä¸åŒçš„æœåŠ¡å™¨å¤„ç†ï¼Œå°±åƒé¤å…é‡Œå¨å¸ˆä¸“é—¨åšèœï¼ŒæœåŠ¡å‘˜ä¸“é—¨ä¸Šèœä¸€æ ·ã€‚

```
ä¼ ç»Ÿå•æœºæ¨¡å¼ï¼š
å®¢æˆ·ç«¯ â†’ RedisæœåŠ¡å™¨ï¼ˆè¯»+å†™ï¼‰
é—®é¢˜ï¼šæ‰€æœ‰å‹åŠ›é›†ä¸­åœ¨ä¸€å°æœºå™¨ä¸Š

è¯»å†™åˆ†ç¦»æ¨¡å¼ï¼š
å®¢æˆ·ç«¯ â†’ ä¸»èŠ‚ç‚¹ï¼ˆåªè´Ÿè´£å†™ï¼‰
       â†’ ä»èŠ‚ç‚¹ï¼ˆåªè´Ÿè´£è¯»ï¼‰
ä¼˜åŠ¿ï¼šå†™å‹åŠ›å’Œè¯»å‹åŠ›åˆ†å¼€æ‰¿æ‹…
```

### 1.2 è¯»å†™åˆ†ç¦»è®¾è®¡åŸåˆ™


**ğŸ¯ æ ¸å¿ƒè®¾è®¡æ€è·¯**ï¼š
- **å†™æ“ä½œé›†ä¸­**ï¼šæ‰€æœ‰å†™æ“ä½œåªèƒ½åœ¨ä¸»èŠ‚ç‚¹æ‰§è¡Œ
- **è¯»æ“ä½œåˆ†æ•£**ï¼šè¯»æ“ä½œå¯ä»¥åœ¨å¤šä¸ªä»èŠ‚ç‚¹æ‰§è¡Œ
- **æ•°æ®åŒæ­¥**ï¼šä¸»èŠ‚ç‚¹çš„æ•°æ®å˜åŒ–è‡ªåŠ¨åŒæ­¥åˆ°ä»èŠ‚ç‚¹
- **è§’è‰²æ˜ç¡®**ï¼šæ¯ä¸ªèŠ‚ç‚¹çš„èŒè´£æ¸…æ™°åˆ†å·¥

**è®¾è®¡åŸåˆ™è¯¦è§£**ï¼š
```
1. å•ä¸€å†™å…¥ç‚¹åŸåˆ™ï¼š
   â€¢ åªæœ‰ä¸»èŠ‚ç‚¹å¯ä»¥æ¥å—å†™æ“ä½œ
   â€¢ é¿å…æ•°æ®å†²çªå’Œä¸ä¸€è‡´
   â€¢ ä¿è¯æ•°æ®çš„æƒå¨æ€§

2. è¯»æ“ä½œè´Ÿè½½åˆ†æ‹…ï¼š
   â€¢ ä»èŠ‚ç‚¹åˆ†æ‹…è¯»æ“ä½œå‹åŠ›
   â€¢ å¯ä»¥éƒ¨ç½²å¤šä¸ªä»èŠ‚ç‚¹
   â€¢ å°±è¿‘è¯»å–æå‡æ€§èƒ½

3. è‡ªåŠ¨æ•°æ®åŒæ­¥ï¼š
   â€¢ ä¸»èŠ‚ç‚¹å˜åŒ–è‡ªåŠ¨æ¨é€åˆ°ä»èŠ‚ç‚¹
   â€¢ ä¿è¯æ•°æ®æœ€ç»ˆä¸€è‡´æ€§
   â€¢ å¼‚æ­¥å¤åˆ¶æå‡å†™æ€§èƒ½
```

### 1.3 æ¶æ„å›¾ç¤º


**åŸºç¡€æ¶æ„ç¤ºæ„**ï¼š
```
                    åº”ç”¨ç¨‹åº
                       â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚å†™æ“ä½œ      â”‚          â”‚è¯»æ“ä½œ
           â–¼           â”‚          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   ä¸»èŠ‚ç‚¹     â”‚    â”‚    â”‚   ä»èŠ‚ç‚¹1    â”‚
    â”‚  (Master)   â”‚â”€â”€â”€â”€â”¼â”€â”€â”€â–¶â”‚  (Slave1)   â”‚
    â”‚ 192.168.1.10â”‚    â”‚    â”‚192.168.1.11 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚           â”‚          â”‚
           â”‚æ•°æ®åŒæ­¥    â”‚          â”‚è¯»æ“ä½œ
           â”‚           â”‚          â”‚
           â–¼           â”‚          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚     æ•°æ®     â”‚â”€â”€â”€â”€â”¼â”€â”€â”€â–¶â”‚   ä»èŠ‚ç‚¹2    â”‚
    â”‚   è‡ªåŠ¨å¤åˆ¶   â”‚    â”‚    â”‚  (Slave2)   â”‚
    â”‚             â”‚         â”‚192.168.1.12 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.4 è´Ÿè½½å‡è¡¡ç­–ç•¥


**å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡**ï¼š
åº”ç”¨ç¨‹åºå†…éƒ¨å®ç°è¯»æ“ä½œçš„è´Ÿè½½åˆ†å‘

```java
public class RedisReadWriteClient {
    private Jedis masterClient;      // ä¸»èŠ‚ç‚¹è¿æ¥
    private List<Jedis> slaveClients; // ä»èŠ‚ç‚¹è¿æ¥æ± 
    private AtomicInteger readIndex = new AtomicInteger(0);
    
    // å†™æ“ä½œ - åªä½¿ç”¨ä¸»èŠ‚ç‚¹
    public void set(String key, String value) {
        masterClient.set(key, value);
    }
    
    // è¯»æ“ä½œ - è½®è¯¢ä»èŠ‚ç‚¹
    public String get(String key) {
        int index = readIndex.getAndIncrement() % slaveClients.size();
        return slaveClients.get(index).get(key);
    }
}
```

**ä»£ç†å±‚è´Ÿè½½å‡è¡¡**ï¼š
ä½¿ç”¨ä¸“é—¨çš„ä»£ç†è½¯ä»¶å®ç°è‡ªåŠ¨è·¯ç”±

```
å®¢æˆ·ç«¯è¯·æ±‚ â†’ Redisä»£ç† â†’ ä¸»/ä»èŠ‚ç‚¹é€‰æ‹©
                â”‚
                â”œâ”€ å†™è¯·æ±‚ â†’ ä¸»èŠ‚ç‚¹
                â””â”€ è¯»è¯·æ±‚ â†’ ä»èŠ‚ç‚¹ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰

å¸¸ç”¨ä»£ç†ï¼š
â€¢ Redis Sentinelï¼šå®˜æ–¹é«˜å¯ç”¨è§£å†³æ–¹æ¡ˆ
â€¢ Codisï¼šè±Œè±†èšå¼€æºä»£ç†
â€¢ Twemproxyï¼šTwitterå¼€æºä»£ç†
```

### 1.5 å®¢æˆ·ç«¯è·¯ç”±å®ç°


**æ™ºèƒ½è·¯ç”±ç­–ç•¥**ï¼š
```java
public class SmartRedisRouter {
    private JedisPool masterPool;
    private List<JedisPool> slavePools;
    
    public String route(String operation, String key) {
        if (isWriteOperation(operation)) {
            // å†™æ“ä½œè·¯ç”±åˆ°ä¸»èŠ‚ç‚¹
            return executeOnMaster(operation, key);
        } else {
            // è¯»æ“ä½œè·¯ç”±åˆ°ä»èŠ‚ç‚¹
            return executeOnSlave(operation, key);
        }
    }
    
    private boolean isWriteOperation(String operation) {
        // åˆ¤æ–­æ˜¯å¦ä¸ºå†™æ“ä½œ
        return Arrays.asList("SET", "DEL", "HSET", "LPUSH").contains(operation);
    }
    
    private JedisPool selectSlavePool() {
        // ä»èŠ‚ç‚¹é€‰æ‹©ç­–ç•¥ï¼šè½®è¯¢ã€éšæœºã€æœ€å°‘è¿æ¥ç­‰
        return slavePools.get(random.nextInt(slavePools.size()));
    }
}
```

---

## 2. ğŸ“Š æ•°æ®ä¸€è‡´æ€§å¤„ç†


### 2.1 ä¸»ä»å»¶è¿Ÿé—®é¢˜åˆ†æ


**å»¶è¿Ÿäº§ç”ŸåŸå› **ï¼š
Redisçš„ä¸»ä»å¤åˆ¶æ˜¯**å¼‚æ­¥è¿›è¡Œ**çš„ï¼Œè¿™æ„å‘³ç€ä¸»èŠ‚ç‚¹æ‰§è¡Œå†™æ“ä½œåï¼Œä¸ä¼šç­‰å¾…ä»èŠ‚ç‚¹ç¡®è®¤å°±è¿”å›ç»™å®¢æˆ·ç«¯ã€‚

```
å»¶è¿Ÿè¿‡ç¨‹ç¤ºæ„ï¼š
æ—¶é—´è½´ï¼š  t1     t2     t3     t4     t5
ä¸»èŠ‚ç‚¹ï¼š  å†™å…¥ â†’ è¿”å› â†’ å‘é€ â†’ ç¡®è®¤
ä»èŠ‚ç‚¹ï¼š               æ¥æ”¶ â†’ å†™å…¥ â†’ å®Œæˆ

å»¶è¿Ÿçª—å£ï¼št2-t5ä¹‹é—´ï¼Œä»èŠ‚ç‚¹æ•°æ®æ˜¯æ—§çš„
```

**å»¶è¿Ÿå½±å“å› ç´ **ï¼š
```
ç½‘ç»œå› ç´ ï¼š
â€¢ ä¸»ä»èŠ‚ç‚¹ä¹‹é—´çš„ç½‘ç»œå»¶è¿Ÿ
â€¢ ç½‘ç»œå¸¦å®½é™åˆ¶
â€¢ ä¸¢åŒ…å’Œé‡ä¼ 

æœåŠ¡å™¨å› ç´ ï¼š
â€¢ ä»èŠ‚ç‚¹å¤„ç†èƒ½åŠ›
â€¢ ç£ç›˜IOæ€§èƒ½
â€¢ å†…å­˜ä½¿ç”¨æƒ…å†µ

æ•°æ®å› ç´ ï¼š
â€¢ å†™æ“ä½œé¢‘ç‡å’Œå¤§å°
â€¢ å¤åˆ¶ç¼“å†²åŒºå¤§å°
â€¢ å¤åˆ¶ç§¯å‹ç¼“å†²åŒºè®¾ç½®
```

### 2.2 å»¶è¿Ÿç›‘æ§å’Œå‘Šè­¦


**ç›‘æ§å…³é”®æŒ‡æ ‡**ï¼š
```bash
# æŸ¥çœ‹ä¸»ä»å»¶è¿ŸçŠ¶æ€
INFO replication

å…³é”®æŒ‡æ ‡ï¼š
â€¢ master_repl_offsetï¼šä¸»èŠ‚ç‚¹å¤åˆ¶åç§»é‡
â€¢ slave_repl_offsetï¼šä»èŠ‚ç‚¹å¤åˆ¶åç§»é‡  
â€¢ master_last_io_seconds_agoï¼šæœ€åä¸€æ¬¡IOæ—¶é—´
â€¢ slave_lagï¼šä»èŠ‚ç‚¹å»¶è¿Ÿç§’æ•°

å»¶è¿Ÿè®¡ç®—ï¼š
å»¶è¿Ÿ = master_repl_offset - slave_repl_offset
```

**ç›‘æ§è„šæœ¬ç¤ºä¾‹**ï¼š
```python
import redis
import time

def monitor_replication_lag():
    master = redis.Redis(host='192.168.1.10', port=6379)
    slave = redis.Redis(host='192.168.1.11', port=6379)
    
    while True:
        # è·å–å¤åˆ¶ä¿¡æ¯
        master_info = master.info('replication')
        slave_info = slave.info('replication')
        
        master_offset = master_info['master_repl_offset']
        slave_offset = slave_info['slave_repl_offset']
        
        lag = master_offset - slave_offset
        
        if lag > 1000:  # å»¶è¿Ÿè¶…è¿‡1000å­—èŠ‚
            print(f"è­¦å‘Šï¼šä¸»ä»å»¶è¿Ÿè¿‡å¤§ {lag} å­—èŠ‚")
        
        time.sleep(10)
```

### 2.3 ä¸€è‡´æ€§è¦æ±‚åœºæ™¯å¤„ç†


**å¼ºä¸€è‡´æ€§éœ€æ±‚åœºæ™¯**ï¼š
å¯¹äºå¿…é¡»ä¿è¯æ•°æ®ä¸€è‡´æ€§çš„ä¸šåŠ¡ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†

```java
public class StrongConsistencyService {
    
    // å¼ºä¸€è‡´æ€§è¯»å–ï¼šä»ä¸»èŠ‚ç‚¹è¯»
    public String getConsistentData(String key) {
        // é‡è¦æ•°æ®å¿…é¡»ä»ä¸»èŠ‚ç‚¹è¯»å–
        return masterClient.get(key);
    }
    
    // å†™åç«‹å³è¯»ï¼šç­‰å¾…åŒæ­¥å®Œæˆ
    public void setAndConfirm(String key, String value) {
        // å†™å…¥ä¸»èŠ‚ç‚¹
        masterClient.set(key, value);
        
        // ç­‰å¾…ä»èŠ‚ç‚¹åŒæ­¥ï¼ˆç®€å•æ–¹å¼ï¼‰
        Thread.sleep(100); // ç­‰å¾…100ms
        
        // ä»ä¸»èŠ‚ç‚¹éªŒè¯
        String result = masterClient.get(key);
        if (!value.equals(result)) {
            throw new RuntimeException("æ•°æ®åŒæ­¥å¤±è´¥");
        }
    }
}
```

**ä¸€è‡´æ€§åœºæ™¯åˆ†ç±»è¡¨**ï¼š

| åœºæ™¯ç±»å‹ | ä¸€è‡´æ€§è¦æ±‚ | å¤„ç†ç­–ç•¥ | ç¤ºä¾‹ä¸šåŠ¡ |
|---------|-----------|---------|---------|
| **é‡‘èäº¤æ˜“** | å¼ºä¸€è‡´æ€§ | ä¸»èŠ‚ç‚¹è¯»å†™ | è´¦æˆ·ä½™é¢æŸ¥è¯¢ |
| **ç”¨æˆ·ç™»å½•** | å¼ºä¸€è‡´æ€§ | ä¸»èŠ‚ç‚¹éªŒè¯ | å¯†ç éªŒè¯ |
| **å•†å“åº“å­˜** | å¼ºä¸€è‡´æ€§ | ä¸»èŠ‚ç‚¹æ“ä½œ | åº“å­˜æ‰£å‡ |
| **å†…å®¹å±•ç¤º** | æœ€ç»ˆä¸€è‡´æ€§ | ä»èŠ‚ç‚¹è¯»å– | æ–‡ç« åˆ—è¡¨ |
| **ç»Ÿè®¡æ•°æ®** | æœ€ç»ˆä¸€è‡´æ€§ | ä»èŠ‚ç‚¹è¯»å– | è®¿é—®è®¡æ•° |
| **ç¼“å­˜æ•°æ®** | æœ€ç»ˆä¸€è‡´æ€§ | ä»èŠ‚ç‚¹è¯»å– | çƒ­é—¨æ¨è |

### 2.4 æœ€ç»ˆä¸€è‡´æ€§æ¥å—åœºæ™¯


**é€‚åˆæœ€ç»ˆä¸€è‡´æ€§çš„ä¸šåŠ¡**ï¼š
è¿™äº›ä¸šåŠ¡å¯ä»¥æ¥å—çŸ­æ—¶é—´çš„æ•°æ®ä¸ä¸€è‡´ï¼Œä¼˜å…ˆè€ƒè™‘æ€§èƒ½ã€‚

```java
public class EventuallyConsistentService {
    
    // å†…å®¹å±•ç¤ºï¼šå¯ä»¥ä»ä»èŠ‚ç‚¹è¯»å–
    public List<Article> getArticleList() {
        // æ–‡ç« åˆ—è¡¨ç¨å¾®å»¶è¿Ÿä¸å½±å“ç”¨æˆ·ä½“éªŒ
        return slaveClient.lrange("articles", 0, 10);
    }
    
    // ç»Ÿè®¡æ•°æ®ï¼šå¯ä»¥æ¥å—å»¶è¿Ÿ
    public long getPageViews(String pageId) {
        // è®¿é—®ç»Ÿè®¡æ•°æ®ç¨æœ‰å»¶è¿Ÿæ˜¯å¯æ¥å—çš„
        return slaveClient.get("views:" + pageId);
    }
    
    // æ¨èå†…å®¹ï¼šå»¶è¿Ÿå½±å“è¾ƒå°
    public List<Product> getRecommendations() {
        // æ¨èç®—æ³•ç»“æœå»¶è¿Ÿå‡ ç§’é’Ÿæ˜¯æ­£å¸¸çš„
        return slaveClient.lrange("recommendations", 0, 20);
    }
}
```

---

## 3. âš ï¸ æ•…éšœå¤„ç†æœºåˆ¶


### 3.1 ä¸»èŠ‚ç‚¹æ•…éšœå¤„ç†


**æ•…éšœæ£€æµ‹æœºåˆ¶**ï¼š
```
è‡ªåŠ¨æ£€æµ‹æ–¹å¼ï¼š
â€¢ å¿ƒè·³æ£€æµ‹ï¼šå®šæœŸpingä¸»èŠ‚ç‚¹
â€¢ è¿æ¥è¶…æ—¶ï¼šè¿æ¥å¤±è´¥æ¬¡æ•°ç»Ÿè®¡
â€¢ å“åº”æ—¶é—´ï¼šå“åº”æ—¶é—´å¼‚å¸¸ç›‘æ§

æ£€æµ‹æµç¨‹ï¼š
å®¢æˆ·ç«¯ â†’ ä¸»èŠ‚ç‚¹è¿æ¥å¤±è´¥ â†’ è§¦å‘æ•…éšœæ£€æµ‹ â†’ å¯åŠ¨æ•…éšœè½¬ç§»
```

**æ•…éšœè½¬ç§»æ­¥éª¤**ï¼š
```bash
# 1. åœæ­¢å¯¹ä¸»èŠ‚ç‚¹çš„å†™æ“ä½œ
# 2. é€‰æ‹©ä¸€ä¸ªä»èŠ‚ç‚¹ä½œä¸ºæ–°ä¸»èŠ‚ç‚¹
redis-cli -h 192.168.1.11 -p 6379
SLAVEOF NO ONE  # å°†ä»èŠ‚ç‚¹æå‡ä¸ºä¸»èŠ‚ç‚¹

# 3. å…¶ä»–ä»èŠ‚ç‚¹æŒ‡å‘æ–°ä¸»èŠ‚ç‚¹  
redis-cli -h 192.168.1.12 -p 6379
SLAVEOF 192.168.1.11 6379

# 4. æ›´æ–°å®¢æˆ·ç«¯é…ç½®
# å°†å†™æ“ä½œè·¯ç”±åˆ°æ–°çš„ä¸»èŠ‚ç‚¹
```

### 3.2 ä»èŠ‚ç‚¹æ•…éšœå¤„ç†


**ä»èŠ‚ç‚¹æ•…éšœå½±å“**ï¼š
ä»èŠ‚ç‚¹æ•…éšœä¸»è¦å½±å“è¯»æ“ä½œçš„æ€§èƒ½ï¼Œä¸ä¼šå½±å“æ•°æ®å®‰å…¨æ€§ã€‚

```
æ•…éšœå¤„ç†ç­–ç•¥ï¼š

å•ä¸ªä»èŠ‚ç‚¹æ•…éšœï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä¸»èŠ‚ç‚¹     â”‚â”€â”€â”€â”€â–¶â”‚   ä»èŠ‚ç‚¹1    â”‚ âœ…æ­£å¸¸
â”‚ (å†™æ“ä½œ)    â”‚     â”‚  (è¯»æ“ä½œ)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚   ä»èŠ‚ç‚¹2    â”‚ âŒæ•…éšœ
                    â”‚    (ç¦»çº¿)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¤„ç†æ–¹å¼ï¼š
1. å°†æ•…éšœèŠ‚ç‚¹ä»è¯»å–æ± ä¸­ç§»é™¤
2. å°†è¯»æ“ä½œåˆ†é…ç»™æ­£å¸¸çš„ä»èŠ‚ç‚¹
3. ä¿®å¤æ•…éšœèŠ‚ç‚¹åé‡æ–°åŠ å…¥
```

**ä»èŠ‚ç‚¹æ¢å¤æµç¨‹**ï¼š
```bash
# 1. æ£€æŸ¥æ•…éšœåŸå› 
redis-cli -h 192.168.1.12 -p 6379 ping

# 2. é‡å¯RedisæœåŠ¡
systemctl restart redis

# 3. é‡æ–°å»ºç«‹ä¸»ä»å…³ç³»
redis-cli -h 192.168.1.12 -p 6379
SLAVEOF 192.168.1.10 6379

# 4. éªŒè¯åŒæ­¥çŠ¶æ€
INFO replication
```

### 3.3 ç½‘ç»œåˆ†åŒºå¤„ç†


**ç½‘ç»œåˆ†åŒºé—®é¢˜**ï¼š
ä¸»ä»èŠ‚ç‚¹ä¹‹é—´ç½‘ç»œè¿æ¥ä¸­æ–­ï¼Œå¯¼è‡´æ•°æ®åŒæ­¥å¤±è´¥ã€‚

```
ç½‘ç»œåˆ†åŒºç¤ºæ„ï¼š
ä¸»èŠ‚ç‚¹                    ä»èŠ‚ç‚¹
   â”‚                        â”‚
   â”‚    ç½‘ç»œè¿æ¥ä¸­æ–­           â”‚
   â”‚ â•³ â•³ â•³ â•³ â•³ â•³ â•³ â•³       â”‚
   â”‚                        â”‚
   â–¼                        â–¼
æŒç»­æ¥å—å†™æ“ä½œ              æ— æ³•è·å–æ–°æ•°æ®
```

**åˆ†åŒºå¤„ç†ç­–ç•¥**ï¼š
```java
public class NetworkPartitionHandler {
    private long maxAllowableDelay = 10; // æœ€å¤§å…è®¸å»¶è¿Ÿç§’æ•°
    
    public boolean isSlaveHealthy(String slaveHost) {
        try {
            Jedis slave = new Jedis(slaveHost, 6379);
            
            // æ£€æŸ¥ä»èŠ‚ç‚¹çŠ¶æ€
            String info = slave.info("replication");
            
            // è§£æå»¶è¿Ÿæ—¶é—´
            if (parseLastIoTime(info) > maxAllowableDelay) {
                return false; // å»¶è¿Ÿè¿‡å¤§ï¼Œè®¤ä¸ºä¸å¥åº·
            }
            
            return true;
        } catch (Exception e) {
            return false; // è¿æ¥å¤±è´¥
        }
    }
}
```

### 3.4 æ‰‹åŠ¨æ•…éšœè½¬ç§»æµç¨‹


**å®Œæ•´è½¬ç§»æ­¥éª¤**ï¼š

**â‘ å‡†å¤‡é˜¶æ®µ**ï¼š
```bash
# æ£€æŸ¥å½“å‰ä¸»ä»çŠ¶æ€
redis-cli -h ä¸»èŠ‚ç‚¹IP info replication
redis-cli -h ä»èŠ‚ç‚¹IP info replication

# ç¡®è®¤æ•°æ®åŒæ­¥è¿›åº¦
# master_repl_offset å’Œ slave_repl_offset åº”è¯¥æ¥è¿‘
```

**â‘¡æ‰§è¡Œè½¬ç§»**ï¼š
```bash
# Step 1: æå‡ä»èŠ‚ç‚¹ä¸ºä¸»èŠ‚ç‚¹
redis-cli -h ä»èŠ‚ç‚¹IP
SLAVEOF NO ONE

# Step 2: æ›´æ–°å…¶ä»–ä»èŠ‚ç‚¹çš„ä¸»èŠ‚ç‚¹æŒ‡å‘
redis-cli -h å…¶ä»–ä»èŠ‚ç‚¹IP  
SLAVEOF æ–°ä¸»èŠ‚ç‚¹IP 6379

# Step 3: éªŒè¯æ–°çš„ä¸»ä»å…³ç³»
redis-cli -h æ–°ä¸»èŠ‚ç‚¹IP info replication
# åº”è¯¥çœ‹åˆ° role:master

redis-cli -h ä»èŠ‚ç‚¹IP info replication  
# åº”è¯¥çœ‹åˆ° role:slave, master_host:æ–°ä¸»èŠ‚ç‚¹IP
```

**â‘¢åº”ç”¨æ›´æ–°**ï¼š
```java
// æ›´æ–°åº”ç”¨ç¨‹åºé…ç½®
public void updateRedisConfig() {
    // åŸä¸»èŠ‚ç‚¹ï¼š192.168.1.10
    // æ–°ä¸»èŠ‚ç‚¹ï¼š192.168.1.11
    
    String oldMaster = "192.168.1.10";
    String newMaster = "192.168.1.11";
    
    // åœæ­¢å†™æ“ä½œ
    stopWriteOperations();
    
    // æ›´æ–°è¿æ¥é…ç½®
    masterClient = new Jedis(newMaster, 6379);
    
    // æ¢å¤å†™æ“ä½œ
    resumeWriteOperations();
}
```

---

## 4. ğŸ› ï¸ å®æˆ˜é…ç½®ä¸ç›‘æ§


### 4.1 ä¸»ä»å¤åˆ¶é…ç½®


**ä¸»èŠ‚ç‚¹é…ç½®** `(redis-master.conf)`ï¼š
```bash
# ç»‘å®šåœ°å€
bind 0.0.0.0
port 6379

# å¤åˆ¶ç›¸å…³é…ç½®
repl-backlog-size 1mb        # å¤åˆ¶ç§¯å‹ç¼“å†²åŒºå¤§å°
repl-backlog-ttl 3600        # ç¼“å†²åŒºTTL
repl-timeout 60              # å¤åˆ¶è¶…æ—¶æ—¶é—´

# å®‰å…¨é…ç½®
requirepass masterpassword   # ä¸»èŠ‚ç‚¹å¯†ç 
```

**ä»èŠ‚ç‚¹é…ç½®** `(redis-slave.conf)`ï¼š
```bash
# ç»‘å®šåœ°å€
bind 0.0.0.0
port 6379

# ä¸»ä»å¤åˆ¶é…ç½®
replicaof 192.168.1.10 6379  # æŒ‡å®šä¸»èŠ‚ç‚¹
masterauth masterpassword    # ä¸»èŠ‚ç‚¹å¯†ç 

# åªè¯»æ¨¡å¼
replica-read-only yes        # ä»èŠ‚ç‚¹åªè¯»

# å¤åˆ¶é…ç½®
replica-serve-stale-data yes # è¿æ¥æ–­å¼€æ—¶ä»æä¾›æ—§æ•°æ®
```

### 4.2 è¯»å†™åˆ†ç¦»ç›‘æ§


**å…³é”®ç›‘æ§è„šæœ¬**ï¼š
```python
import redis
import json
from datetime import datetime

class ReplicationMonitor:
    def __init__(self):
        self.master = redis.Redis(host='192.168.1.10', port=6379)
        self.slaves = [
            redis.Redis(host='192.168.1.11', port=6379),
            redis.Redis(host='192.168.1.12', port=6379)
        ]
    
    def check_replication_health(self):
        """æ£€æŸ¥ä¸»ä»å¤åˆ¶å¥åº·çŠ¶æ€"""
        master_info = self.master.info('replication')
        master_offset = master_info['master_repl_offset']
        
        health_report = {
            'timestamp': datetime.now().isoformat(),
            'master_offset': master_offset,
            'slaves': []
        }
        
        for i, slave in enumerate(self.slaves):
            try:
                slave_info = slave.info('replication')
                slave_offset = slave_info['slave_repl_offset']
                lag = master_offset - slave_offset
                
                slave_health = {
                    'slave_id': i + 1,
                    'offset': slave_offset,
                    'lag_bytes': lag,
                    'status': 'healthy' if lag < 1000 else 'lagging'
                }
                health_report['slaves'].append(slave_health)
                
            except Exception as e:
                slave_health = {
                    'slave_id': i + 1,
                    'status': 'offline',
                    'error': str(e)
                }
                health_report['slaves'].append(slave_health)
        
        return health_report
```

### 4.3 å»¶è¿Ÿä¼˜åŒ–æ–¹æ¡ˆ


**é…ç½®ä¼˜åŒ–**ï¼š
```bash
# ä¸»èŠ‚ç‚¹ä¼˜åŒ–é…ç½®
tcp-keepalive 300           # TCP keepalive
repl-timeout 60             # é€‚å½“çš„è¶…æ—¶æ—¶é—´
client-output-buffer-limit replica 256mb 64mb 60

# ä»èŠ‚ç‚¹ä¼˜åŒ–é…ç½®  
replica-lazy-flush yes      # å¼‚æ­¥åˆ é™¤å¤§é”®
replica-priority 100        # ä»èŠ‚ç‚¹ä¼˜å…ˆçº§
```

**ç½‘ç»œä¼˜åŒ–**ï¼š
```bash
# ç³»ç»Ÿå±‚é¢ç½‘ç»œä¼˜åŒ–
# å¢å¤§TCPç¼“å†²åŒº
echo 'net.core.rmem_max = 16777216' >> /etc/sysctl.conf
echo 'net.core.wmem_max = 16777216' >> /etc/sysctl.conf

# è°ƒæ•´TCPå‚æ•°
echo 'net.ipv4.tcp_window_scaling = 1' >> /etc/sysctl.conf
sysctl -p
```

### 4.4 ä¸€è‡´æ€§ç­–ç•¥å®ç°


**ä¸šåŠ¡å±‚é¢çš„ä¸€è‡´æ€§ä¿è¯**ï¼š
```java
public class ConsistencyStrategy {
    
    // ç­–ç•¥1ï¼šå†™åè¯»ä¸»èŠ‚ç‚¹
    public String writeAndRead(String key, String value) {
        // å†™å…¥ä¸»èŠ‚ç‚¹
        masterClient.set(key, value);
        
        // ç«‹å³ä»ä¸»èŠ‚ç‚¹è¯»å–ï¼Œä¿è¯ä¸€è‡´æ€§
        return masterClient.get(key);
    }
    
    // ç­–ç•¥2ï¼šå»¶è¿Ÿè¯»å–
    public String delayedRead(String key, String value) {
        // å†™å…¥ä¸»èŠ‚ç‚¹  
        masterClient.set(key, value);
        
        // ç­‰å¾…ä¸€æ®µæ—¶é—´ä¿è¯åŒæ­¥
        try {
            Thread.sleep(50); // ç­‰å¾…50ms
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
        
        // ä»ä»èŠ‚ç‚¹è¯»å–
        return slaveClient.get(key);
    }
    
    // ç­–ç•¥3ï¼šç‰ˆæœ¬å·æœºåˆ¶
    public void setWithVersion(String key, String value) {
        long version = System.currentTimeMillis();
        
        // åŒæ—¶è®¾ç½®æ•°æ®å’Œç‰ˆæœ¬å·
        masterClient.set(key, value);
        masterClient.set(key + ":version", String.valueOf(version));
    }
}
```

---

## 5. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 5.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ è¯»å†™åˆ†ç¦»ï¼šä¸»èŠ‚ç‚¹è´Ÿè´£å†™ï¼Œä»èŠ‚ç‚¹è´Ÿè´£è¯»ï¼Œåˆ†å·¥æ˜ç¡®
ğŸ”¸ å¼‚æ­¥å¤åˆ¶ï¼šä¸»ä»æ•°æ®åŒæ­¥æ˜¯å¼‚æ­¥çš„ï¼Œå­˜åœ¨å»¶è¿Ÿçª—å£
ğŸ”¸ è´Ÿè½½å‡è¡¡ï¼šé€šè¿‡å¤šä¸ªä»èŠ‚ç‚¹åˆ†æ‹…è¯»æ“ä½œå‹åŠ›
ğŸ”¸ æ•…éšœè½¬ç§»ï¼šä¸»èŠ‚ç‚¹æ•…éšœæ—¶æå‡ä»èŠ‚ç‚¹ä¸ºæ–°ä¸»èŠ‚ç‚¹
ğŸ”¸ ä¸€è‡´æ€§æƒè¡¡ï¼šæ€§èƒ½ä¸ä¸€è‡´æ€§ä¹‹é—´éœ€è¦å¹³è¡¡é€‰æ‹©
```

### 5.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ è¯»å†™åˆ†ç¦»çš„æœ¬è´¨ä¼˜åŠ¿**ï¼š
```
æ€§èƒ½æå‡ï¼š
â€¢ å†™æ“ä½œå‹åŠ›é›†ä¸­åœ¨ä¸»èŠ‚ç‚¹ä¼˜åŒ–å¤„ç†
â€¢ è¯»æ“ä½œå‹åŠ›åˆ†æ•£åˆ°å¤šä¸ªä»èŠ‚ç‚¹
â€¢ æ•´ä½“ååé‡æˆå€æå‡

æ‰©å±•æ€§ï¼š
â€¢ å¯ä»¥æ ¹æ®è¯»å†™æ¯”ä¾‹è°ƒæ•´ä»èŠ‚ç‚¹æ•°é‡
â€¢ è¯»å¤šå†™å°‘çš„ä¸šåŠ¡ç‰¹åˆ«é€‚åˆ
â€¢ æ°´å¹³æ‰©å±•æˆæœ¬ç›¸å¯¹è¾ƒä½
```

**ğŸ”¹ æ•°æ®ä¸€è‡´æ€§çš„æƒè¡¡**ï¼š
```
å»¶è¿Ÿæ˜¯æ­£å¸¸ç°è±¡ï¼š
â€¢ å¼‚æ­¥å¤åˆ¶æ˜¯æ€§èƒ½å’Œä¸€è‡´æ€§çš„å¹³è¡¡
â€¢ å®Œå…¨åŒæ­¥ä¼šä¸¥é‡å½±å“å†™æ€§èƒ½
â€¢ å¤§éƒ¨åˆ†ä¸šåŠ¡å¯ä»¥æ¥å—çŸ­æš‚å»¶è¿Ÿ

å¤„ç†ç­–ç•¥é€‰æ‹©ï¼š
â€¢ å¼ºä¸€è‡´æ€§ä¸šåŠ¡ï¼šä»ä¸»èŠ‚ç‚¹è¯»å–
â€¢ å¼±ä¸€è‡´æ€§ä¸šåŠ¡ï¼šä»ä»èŠ‚ç‚¹è¯»å–
â€¢ æ··åˆç­–ç•¥ï¼šæ ¹æ®ä¸šåŠ¡é‡è¦æ€§åŠ¨æ€é€‰æ‹©
```

**ğŸ”¹ æ•…éšœå¤„ç†çš„å…³é”®æ€è·¯**ï¼š
```
é¢„é˜²ä¸ºä¸»ï¼š
â€¢ åšå¥½ç›‘æ§ï¼Œæå‰å‘ç°é—®é¢˜
â€¢ åˆç†é…ç½®ï¼Œå‡å°‘æ•…éšœæ¦‚ç‡
â€¢ å®šæœŸæ¼”ç»ƒï¼Œæå‡å¤„ç†èƒ½åŠ›

å¿«é€Ÿæ¢å¤ï¼š
â€¢ è‡ªåŠ¨åŒ–æ•…éšœæ£€æµ‹
â€¢ æ ‡å‡†åŒ–å¤„ç†æµç¨‹
â€¢ åº”ç”¨å±‚å®¹é”™æœºåˆ¶
```

### 5.3 å®è·µç»éªŒæ€»ç»“


**ğŸ“Š é…ç½®å»ºè®®**ï¼š

| é…ç½®é¡¹ | æ¨èå€¼ | è¯´æ˜ |
|--------|--------|------|
| **ä»èŠ‚ç‚¹æ•°é‡** | `2-4ä¸ª` | å¤ªå¤šå½±å“ä¸»èŠ‚ç‚¹æ€§èƒ½ |
| **å¤åˆ¶è¶…æ—¶** | `60ç§’` | æ ¹æ®ç½‘ç»œæƒ…å†µè°ƒæ•´ |
| **ç§¯å‹ç¼“å†²åŒº** | `1-10MB` | æ ¹æ®å†™å…¥é‡è°ƒæ•´ |
| **ç›‘æ§é¢‘ç‡** | `10ç§’` | åŠæ—¶å‘ç°å»¶è¿Ÿé—®é¢˜ |
| **æ•…éšœåˆ‡æ¢** | `æ‰‹åŠ¨æ‰§è¡Œ` | é¿å…è„‘è£‚é—®é¢˜ |

**ğŸ”§ éƒ¨ç½²å»ºè®®**ï¼š
```bash
# ç½‘ç»œè§„åˆ’
ä¸»èŠ‚ç‚¹ï¼šé«˜æ€§èƒ½æœåŠ¡å™¨ï¼ŒSSDç£ç›˜
ä»èŠ‚ç‚¹ï¼šå¯ä»¥ä½¿ç”¨ç›¸å¯¹ä½é…ç½®æœåŠ¡å™¨
ç½‘ç»œï¼šä¸»ä»èŠ‚ç‚¹é—´ä¿è¯ä½å»¶è¿Ÿè¿æ¥

# ç›‘æ§å‘Šè­¦
å»¶è¿Ÿç›‘æ§ï¼šè¶…è¿‡100mså‘Šè­¦
å¯ç”¨æ€§ç›‘æ§ï¼šè¿æ¥å¤±è´¥ç«‹å³å‘Šè­¦
æ€§èƒ½ç›‘æ§ï¼šQPSã€å†…å­˜ä½¿ç”¨ç‡

# å¤‡ä»½ç­–ç•¥
ä¸»èŠ‚ç‚¹ï¼šå®šæœŸå…¨é‡å¤‡ä»½
ä»èŠ‚ç‚¹ï¼šå¯ä»¥ç”¨äºå¤‡ä»½ï¼Œå‡è½»ä¸»èŠ‚ç‚¹å‹åŠ›
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- ä¸»å†™ä»è¯»èŒè´£æ¸…ï¼Œå¼‚æ­¥å¤åˆ¶æœ‰å»¶è¿Ÿ
- å¼ºä¸€è‡´è¯»ä¸»èŠ‚ç‚¹ï¼Œå¼±ä¸€è‡´è¯»ä»èŠ‚ç‚¹
- æ•…éšœè½¬ç§»è¦è°¨æ…ï¼Œç›‘æ§å‘Šè­¦ä¸å¯å°‘
- è¯»å†™åˆ†ç¦»æ€§èƒ½å¥½ï¼Œä¸€è‡´æ€§æƒè¡¡è¦åšåˆ°