---
title: 14ã€Redisæ··åˆæ¶æ„å’Œå¤šæ´»éƒ¨ç½²
---
## ğŸ“š ç›®å½•

1. [æ··åˆæ¶æ„æ¨¡å¼](#1-æ··åˆæ¶æ„æ¨¡å¼)
2. [å¤šæœºæˆ¿éƒ¨ç½²æ–¹æ¡ˆ](#2-å¤šæœºæˆ¿éƒ¨ç½²æ–¹æ¡ˆ)
3. [ç°åº¦å‘å¸ƒç­–ç•¥](#3-ç°åº¦å‘å¸ƒç­–ç•¥)
4. [å®é™…éƒ¨ç½²æ¡ˆä¾‹](#4-å®é™…éƒ¨ç½²æ¡ˆä¾‹)
5. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#5-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”§ æ··åˆæ¶æ„æ¨¡å¼


### 1.1 ä»€ä¹ˆæ˜¯æ··åˆæ¶æ„


**ç®€å•ç†è§£**ï¼šå°±åƒæ­ç§¯æœ¨ï¼ŒæŠŠä¸åŒçš„Rediséƒ¨ç½²æ–¹å¼ç»„åˆèµ·æ¥ï¼Œå‘æŒ¥å„è‡ªä¼˜åŠ¿ã€‚

æ¯”å¦‚ï¼šæŠŠé›†ç¾¤çš„åˆ†ç‰‡èƒ½åŠ› + å“¨å…µçš„é«˜å¯ç”¨ + ä¸»ä»çš„è¯»å†™åˆ†ç¦»ç»„åˆåœ¨ä¸€èµ·ã€‚

```
å•ä¸€æ¶æ„é—®é¢˜ï¼š
ä¸»ä»æ¶æ„ â†’ å†™èƒ½åŠ›æœ‰é™(åªæœ‰ä¸€ä¸ªä¸»èŠ‚ç‚¹)
é›†ç¾¤æ¶æ„ â†’ é…ç½®å¤æ‚ï¼Œå°ä¸šåŠ¡ç”¨ä¸ä¸Š
å“¨å…µæ¶æ„ â†’ ä¸æ”¯æŒæ•°æ®åˆ†ç‰‡

æ··åˆæ¶æ„ä¼˜åŠ¿ï¼š
å–é•¿è¡¥çŸ­ï¼ŒæŒ‰ä¸šåŠ¡éœ€æ±‚çµæ´»ç»„åˆ
```

### 1.2 é›†ç¾¤+å“¨å…µç»„åˆ


**æ ¸å¿ƒæ€è·¯**ï¼šé›†ç¾¤è´Ÿè´£åˆ†ç‰‡ï¼Œå“¨å…µè´Ÿè´£æ¯ä¸ªåˆ†ç‰‡çš„é«˜å¯ç”¨ã€‚

```
æ¶æ„ç¤ºæ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Redisé›†ç¾¤                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   åˆ†ç‰‡1     â”‚  â”‚   åˆ†ç‰‡2     â”‚  â”‚   åˆ†ç‰‡3     â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚ â”‚Master 1â”‚ â”‚  â”‚ â”‚Master 2â”‚ â”‚  â”‚ â”‚Master 3â”‚ â”‚ â”‚
â”‚  â”‚ â”‚        â”‚ â”‚  â”‚ â”‚        â”‚ â”‚  â”‚ â”‚        â”‚ â”‚ â”‚
â”‚  â”‚ â”‚Slave 1 â”‚ â”‚  â”‚ â”‚Slave 2 â”‚ â”‚  â”‚ â”‚Slave 3 â”‚ â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚ å“¨å…µç›‘æ§    â”‚  â”‚ å“¨å…µç›‘æ§    â”‚  â”‚ å“¨å…µç›‘æ§    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é…ç½®è¦ç‚¹**ï¼š
```bash
# æ¯ä¸ªé›†ç¾¤èŠ‚ç‚¹é…ç½®å“¨å…µ
# redis-sentinel-6379.conf
sentinel monitor master-6379 192.168.1.10 6379 2
sentinel down-after-milliseconds master-6379 5000
sentinel failover-timeout master-6379 10000

# redis-sentinel-6380.conf  
sentinel monitor master-6380 192.168.1.11 6380 2
sentinel down-after-milliseconds master-6380 5000
sentinel failover-timeout master-6380 10000
```

### 1.3 å¤šçº§ç¼“å­˜æ¶æ„


**å±‚æ¬¡ç¼“å­˜æ€è·¯**ï¼šåƒä¿„ç½—æ–¯å¥—å¨ƒï¼Œä¸€å±‚å¥—ä¸€å±‚ï¼Œè¶Šé è¿‘ç”¨æˆ·è¶Šå¿«ã€‚

```
å¤šçº§ç¼“å­˜ç¤ºæ„ï¼š
ç”¨æˆ·è¯·æ±‚ 
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æœ¬åœ°ç¼“å­˜    â”‚ â† åº”ç”¨å†…å­˜ç¼“å­˜(å‡ æ¯«ç§’)
â”‚ (L1 Cache)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ (miss)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  
â”‚  Redisç¼“å­˜   â”‚ â† å†…å­˜ç¼“å­˜(1-5æ¯«ç§’)
â”‚ (L2 Cache)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ (miss)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ•°æ®åº“      â”‚ â† æŒä¹…åŒ–å­˜å‚¨(10-100æ¯«ç§’)
â”‚ (Database)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®ç°ç­–ç•¥**ï¼š
```python
class MultiLevelCache:
    def __init__(self):
        self.local_cache = {}  # L1: æœ¬åœ°å†…å­˜ç¼“å­˜
        self.redis_client = redis.Redis()  # L2: Redisç¼“å­˜
    
    def get(self, key):
        # L1ç¼“å­˜æŸ¥æ‰¾
        if key in self.local_cache:
            return self.local_cache[key]
        
        # L2ç¼“å­˜æŸ¥æ‰¾
        value = self.redis_client.get(key)
        if value:
            # å›å†™åˆ°L1ç¼“å­˜
            self.local_cache[key] = value
            return value
        
        # L3æ•°æ®åº“æŸ¥æ‰¾
        value = self.get_from_database(key)
        if value:
            # å›å†™åˆ°L2å’ŒL1
            self.redis_client.setex(key, 300, value)  # 5åˆ†é’Ÿ
            self.local_cache[key] = value
        
        return value
    
    def set(self, key, value):
        # åŒæ—¶æ›´æ–°æ‰€æœ‰å±‚çº§
        self.local_cache[key] = value
        self.redis_client.setex(key, 300, value)
        self.save_to_database(key, value)
```

### 1.4 å†·çƒ­æ•°æ®åˆ†ç¦»


**ä¸šåŠ¡èƒŒæ™¯**ï¼š80%çš„è®¿é—®é›†ä¸­åœ¨20%çš„æ•°æ®ä¸Šã€‚

```
æ•°æ®åˆ†ç±»ï¼š
çƒ­æ•°æ®ï¼šç»å¸¸è®¿é—®çš„æ•°æ®(ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ã€çƒ­é—¨å•†å“)
æ¸©æ•°æ®ï¼šå¶å°”è®¿é—®çš„æ•°æ®(å†å²è®¢å•ã€è€æ–‡ç« )
å†·æ•°æ®ï¼šå¾ˆå°‘è®¿é—®çš„æ•°æ®(å½’æ¡£æ—¥å¿—ã€åˆ é™¤çš„å†…å®¹)

å­˜å‚¨ç­–ç•¥ï¼š
çƒ­æ•°æ® â†’ Rediså†…å­˜å­˜å‚¨(æ¯«ç§’çº§è®¿é—®)
æ¸©æ•°æ® â†’ Redis + æ•°æ®åº“(ç§’çº§è®¿é—®)
å†·æ•°æ® â†’ æ•°æ®åº“æˆ–æ–‡ä»¶å­˜å‚¨(åˆ†é’Ÿçº§è®¿é—®)
```

**è‡ªåŠ¨åˆ†å±‚å®ç°**ï¼š
```python
import time
from collections import defaultdict

class DataTierManager:
    def __init__(self):
        self.access_count = defaultdict(int)
        self.last_access = defaultdict(float)
        self.hot_threshold = 100   # è®¿é—®100æ¬¡ä»¥ä¸Šç®—çƒ­æ•°æ®
        self.cold_threshold = 86400  # 1å¤©æ²¡è®¿é—®ç®—å†·æ•°æ®
    
    def access_data(self, key):
        """è®¿é—®æ•°æ®æ—¶è°ƒç”¨"""
        self.access_count[key] += 1
        self.last_access[key] = time.time()
        
        # æ ¹æ®è®¿é—®é¢‘ç‡å†³å®šå­˜å‚¨å±‚çº§
        if self.access_count[key] > self.hot_threshold:
            self._promote_to_hot(key)
        elif time.time() - self.last_access[key] > self.cold_threshold:
            self._demote_to_cold(key)
    
    def _promote_to_hot(self, key):
        """æå‡ä¸ºçƒ­æ•°æ®"""
        value = self.redis_client.get(key)
        if value:
            # è®¾ç½®æ›´é•¿çš„è¿‡æœŸæ—¶é—´
            self.redis_client.expire(key, 3600)  # 1å°æ—¶
            print(f"æ•°æ®{key}æå‡ä¸ºçƒ­æ•°æ®")
    
    def _demote_to_cold(self, key):
        """é™çº§ä¸ºå†·æ•°æ®"""
        # ä»Redisç§»é™¤ï¼Œåªä¿ç•™åœ¨æ•°æ®åº“
        self.redis_client.delete(key)
        print(f"æ•°æ®{key}é™çº§ä¸ºå†·æ•°æ®")
```

---

## 2. ğŸŒ å¤šæœºæˆ¿éƒ¨ç½²æ–¹æ¡ˆ


### 2.1 ä¸ºä»€ä¹ˆéœ€è¦å¤šæœºæˆ¿


**é£é™©é—®é¢˜**ï¼š
- **æœºæˆ¿æ–­ç”µ**ï¼šæ•´ä¸ªæ•°æ®ä¸­å¿ƒåœæœ
- **ç½‘ç»œæ•…éšœ**ï¼šæŸä¸ªåœ°åŒºæ— æ³•è®¿é—®
- **è‡ªç„¶ç¾å®³**ï¼šåœ°éœ‡ã€ç«ç¾ç­‰æç«¯æƒ…å†µ

**è§£å†³æ€è·¯**ï¼šæŠŠæœåŠ¡éƒ¨ç½²åˆ°ä¸åŒåœ°ç†ä½ç½®çš„æœºæˆ¿ï¼Œä¸€ä¸ªå‡ºé—®é¢˜å…¶ä»–èƒ½æ¥ç®¡ã€‚

### 2.2 åŒåŸåŒæ´»æ¶æ„


**ä»€ä¹ˆæ˜¯åŒåŸåŒæ´»**ï¼šåœ¨åŒä¸€ä¸ªåŸå¸‚çš„ä¸¤ä¸ªæœºæˆ¿éƒ½éƒ¨ç½²å®Œæ•´æœåŠ¡ï¼Œäº’ä¸ºå¤‡ä»½ã€‚

```
åŒåŸåŒæ´»ç¤ºæ„å›¾ï¼š
        ç”¨æˆ·è¯·æ±‚
            |
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   è´Ÿè½½å‡è¡¡å™¨   â”‚
    â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
        â”‚       â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â” â”Œâ”€â–¼â”€â”€â”€â”€â”€â”€â”
   â”‚ æœºæˆ¿A   â”‚ â”‚ æœºæˆ¿B   â”‚
   â”‚Redisé›†ç¾¤â”‚ â”‚Redisé›†ç¾¤â”‚
   â”‚æ•°æ®åº“   â”‚ â”‚æ•°æ®åº“   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”˜
       æ•°æ®åŒæ­¥
```

**åŒæ­¥ç­–ç•¥**ï¼š
```python
class DualActiveSync:
    def __init__(self):
        self.redis_a = redis.Redis(host='æœºæˆ¿A-IP', port=6379)
        self.redis_b = redis.Redis(host='æœºæˆ¿B-IP', port=6379) 
        
    def sync_write(self, key, value):
        """åŒå†™æ¨¡å¼ï¼šåŒæ—¶å†™å…¥ä¸¤ä¸ªæœºæˆ¿"""
        try:
            # å†™å…¥æœºæˆ¿A
            self.redis_a.set(key, value)
            # å†™å…¥æœºæˆ¿B
            self.redis_b.set(key, value)
            return True
        except Exception as e:
            print(f"åŒå†™å¤±è´¥: {e}")
            return False
    
    def sync_read(self, key):
        """ä¼˜å…ˆä»æœ¬åœ°æœºæˆ¿è¯»å–"""
        try:
            # ä¼˜å…ˆè¯»å–æœºæˆ¿A
            value = self.redis_a.get(key)
            if value:
                return value
            
            # é™çº§è¯»å–æœºæˆ¿B
            return self.redis_b.get(key)
        except:
            return None
```

### 2.3 å¼‚åœ°å¤šæ´»æ–¹æ¡ˆ


**åœºæ™¯**ï¼šç”¨æˆ·åˆ†å¸ƒåœ¨åŒ—äº¬ã€ä¸Šæµ·ã€å¹¿å·ï¼Œéœ€è¦å°±è¿‘è®¿é—®ã€‚

```
å¼‚åœ°å¤šæ´»æ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åŒ—äº¬æœºæˆ¿   â”‚  â”‚   ä¸Šæµ·æœºæˆ¿   â”‚  â”‚   å¹¿å·æœºæˆ¿   â”‚
â”‚             â”‚  â”‚             â”‚  â”‚             â”‚
â”‚ Redisé›†ç¾¤    â”‚  â”‚ Redisé›†ç¾¤    â”‚  â”‚ Redisé›†ç¾¤    â”‚
â”‚ (ååŒ—ç”¨æˆ·)   â”‚  â”‚ (åä¸œç”¨æˆ·)   â”‚  â”‚ (åå—ç”¨æˆ·)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚               â”‚               â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   æ•°æ®åŒæ­¥
```

**æ•°æ®ä¸€è‡´æ€§ç­–ç•¥**ï¼š

| æ•°æ®ç±»å‹ | åŒæ­¥ç­–ç•¥ | è¯´æ˜ |
|---------|---------|------|
| **ç”¨æˆ·ä¼šè¯** | å°±è¿‘å­˜å‚¨ | ç”¨æˆ·ç™»å½•ä¿¡æ¯åªå­˜æœ¬åœ°æœºæˆ¿ |
| **å•†å“ä¿¡æ¯** | å…¨å±€åŒæ­¥ | æ‰€æœ‰æœºæˆ¿ä¿æŒä¸€è‡´ |  
| **åº“å­˜æ•°æ®** | å®æ—¶åŒæ­¥ | å…³é”®ä¸šåŠ¡æ•°æ®ï¼Œå¼ºä¸€è‡´æ€§ |
| **æ—¥å¿—æ•°æ®** | å¼‚æ­¥åŒæ­¥ | å…è®¸å»¶è¿Ÿï¼Œæœ€ç»ˆä¸€è‡´å³å¯ |

### 2.4 æ•°æ®åŒæ­¥ç­–ç•¥


**å¼‚æ­¥åŒæ­¥å®ç°**ï¼š
```python
import threading
import queue

class AsyncDataSync:
    def __init__(self):
        self.sync_queue = queue.Queue()
        self.running = True
        
        # å¯åŠ¨åŒæ­¥çº¿ç¨‹
        sync_thread = threading.Thread(target=self._sync_worker)
        sync_thread.start()
    
    def add_sync_task(self, operation, key, value=None):
        """æ·»åŠ åŒæ­¥ä»»åŠ¡"""
        task = {
            'operation': operation,  # SET, DEL, EXPIREç­‰
            'key': key,
            'value': value,
            'timestamp': time.time()
        }
        self.sync_queue.put(task)
    
    def _sync_worker(self):
        """åå°åŒæ­¥å·¥ä½œçº¿ç¨‹"""
        while self.running:
            try:
                # è·å–åŒæ­¥ä»»åŠ¡
                task = self.sync_queue.get(timeout=1)
                
                # æ‰§è¡ŒåŒæ­¥
                self._execute_sync(task)
                
            except queue.Empty:
                continue
            except Exception as e:
                print(f"åŒæ­¥å¤±è´¥: {e}")
    
    def _execute_sync(self, task):
        """æ‰§è¡Œå…·ä½“åŒæ­¥æ“ä½œ"""
        target_redis = redis.Redis(host='ç›®æ ‡æœºæˆ¿IP')
        
        if task['operation'] == 'SET':
            target_redis.set(task['key'], task['value'])
        elif task['operation'] == 'DEL':
            target_redis.delete(task['key'])
        
        print(f"åŒæ­¥å®Œæˆ: {task['key']}")
```

---

## 3. ğŸš€ ç°åº¦å‘å¸ƒç­–ç•¥


### 3.1 ä»€ä¹ˆæ˜¯ç°åº¦å‘å¸ƒ


**é€šä¿—ç†è§£**ï¼šå°±åƒè¯•åƒï¼Œæ–°èœå“å…ˆç»™ä¸€å°éƒ¨åˆ†å®¢äººè¯•åƒï¼Œæ²¡é—®é¢˜å†å…¨é¢æ¨å¹¿ã€‚

**æŠ€æœ¯å«ä¹‰**ï¼šæ–°ç‰ˆæœ¬å…ˆç»™ä¸€å°éƒ¨åˆ†ç”¨æˆ·ä½¿ç”¨ï¼ŒéªŒè¯æ²¡é—®é¢˜åé€æ­¥æ‰©å¤§èŒƒå›´ã€‚

```
ç°åº¦å‘å¸ƒæµç¨‹ï¼š
ç‰ˆæœ¬V1.0 (100%ç”¨æˆ·) 
    â†“
ç‰ˆæœ¬V2.0 (5%ç”¨æˆ·) â† ç°åº¦é˜¶æ®µ
    â†“ (è§‚å¯Ÿæ— é—®é¢˜)
ç‰ˆæœ¬V2.0 (20%ç”¨æˆ·) â† æ‰©å¤§ç°åº¦
    â†“ (ç»§ç»­è§‚å¯Ÿ)  
ç‰ˆæœ¬V2.0 (100%ç”¨æˆ·) â† å…¨é‡å‘å¸ƒ
```

### 3.2 ç‰ˆæœ¬å‡çº§ç­–ç•¥


**æ»šåŠ¨å‡çº§**ï¼šä¸€å°ä¸€å°åœ°å‡çº§ï¼Œä¿è¯æœåŠ¡ä¸ä¸­æ–­ã€‚

```python
class GrayReleaseManager:
    def __init__(self):
        self.redis_old = redis.Redis(host='æ—§ç‰ˆæœ¬é›†ç¾¤')
        self.redis_new = redis.Redis(host='æ–°ç‰ˆæœ¬é›†ç¾¤')
        self.gray_users = set()  # ç°åº¦ç”¨æˆ·åˆ—è¡¨
    
    def add_gray_user(self, user_id):
        """æ·»åŠ ç°åº¦ç”¨æˆ·"""
        self.gray_users.add(user_id)
        # æŒä¹…åŒ–ç°åº¦ç”¨æˆ·åˆ—è¡¨
        r.sadd('gray_users', user_id)
    
    def get_redis_client(self, user_id):
        """æ ¹æ®ç”¨æˆ·å†³å®šä½¿ç”¨å“ªä¸ªRedis"""
        if user_id in self.gray_users:
            return self.redis_new  # ç°åº¦ç”¨æˆ·ä½¿ç”¨æ–°ç‰ˆæœ¬
        else:
            return self.redis_old  # å…¶ä»–ç”¨æˆ·ä½¿ç”¨æ—§ç‰ˆæœ¬
    
    def expand_gray_release(self, percentage):
        """æ‰©å¤§ç°åº¦èŒƒå›´"""
        # æ ¹æ®ç”¨æˆ·IDå“ˆå¸Œå€¼å†³å®šæ˜¯å¦çº³å…¥ç°åº¦
        all_users = get_all_user_ids()
        
        for user_id in all_users:
            hash_value = hash(str(user_id)) % 100
            if hash_value < percentage:
                self.add_gray_user(user_id)
        
        print(f"ç°åº¦æ‰©å¤§åˆ°{percentage}%ç”¨æˆ·")
```

### 3.3 æµé‡åˆ‡æ¢æ–¹æ¡ˆ


**æ™ºèƒ½è·¯ç”±**ï¼šæ ¹æ®ç”¨æˆ·ç‰¹å¾å†³å®šèµ°æ–°ç‰ˆæœ¬è¿˜æ˜¯æ—§ç‰ˆæœ¬ã€‚

```python
def route_request(user_id, request_data):
    """æ™ºèƒ½è¯·æ±‚è·¯ç”±"""
    
    # æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨ç°åº¦åå•
    if r.sismember('gray_users', user_id):
        return handle_request_v2(request_data)
    
    # æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ˜¯å†…éƒ¨å‘˜å·¥(ä¼˜å…ˆä½“éªŒæ–°åŠŸèƒ½)
    if is_internal_user(user_id):
        return handle_request_v2(request_data)
    
    # æ£€æŸ¥æ˜¯å¦æ˜¯VIPç”¨æˆ·(ç¨³å®šæ€§ä¼˜å…ˆ)
    if is_vip_user(user_id):
        return handle_request_v1(request_data)
    
    # æ™®é€šç”¨æˆ·æŒ‰æ¯”ä¾‹åˆ†æµ
    hash_val = hash(str(user_id)) % 100
    gray_percentage = get_gray_percentage()
    
    if hash_val < gray_percentage:
        return handle_request_v2(request_data)
    else:
        return handle_request_v1(request_data)
```

### 3.4 å›æ»šæœºåˆ¶è®¾è®¡


**å¿«é€Ÿå›æ»š**ï¼šå‘ç°é—®é¢˜æ—¶èƒ½å¤Ÿå¿«é€Ÿåˆ‡å›æ—§ç‰ˆæœ¬ã€‚

```python
class RollbackManager:
    def __init__(self):
        self.rollback_threshold = {
            'error_rate': 0.05,    # é”™è¯¯ç‡è¶…è¿‡5%
            'response_time': 1000, # å“åº”æ—¶é—´è¶…è¿‡1ç§’
            'cpu_usage': 0.8       # CPUä½¿ç”¨ç‡è¶…è¿‡80%
        }
    
    def monitor_and_rollback(self):
        """ç›‘æ§æŒ‡æ ‡å¹¶è‡ªåŠ¨å›æ»š"""
        while True:
            metrics = self.get_current_metrics()
            
            # æ£€æŸ¥æ˜¯å¦éœ€è¦å›æ»š
            if self._should_rollback(metrics):
                print("âš ï¸ æ£€æµ‹åˆ°å¼‚å¸¸ï¼Œå¼€å§‹å›æ»š...")
                self.execute_rollback()
                break
            
            time.sleep(10)  # æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡
    
    def _should_rollback(self, metrics):
        """åˆ¤æ–­æ˜¯å¦éœ€è¦å›æ»š"""
        if metrics['error_rate'] > self.rollback_threshold['error_rate']:
            return True
        if metrics['avg_response_time'] > self.rollback_threshold['response_time']:
            return True
        return False
    
    def execute_rollback(self):
        """æ‰§è¡Œå›æ»šæ“ä½œ"""
        # 1. åœæ­¢æ–°ç‰ˆæœ¬æµé‡
        r.set('gray_percentage', 0)
        
        # 2. æ¸…ç©ºç°åº¦ç”¨æˆ·åˆ—è¡¨
        r.delete('gray_users')
        
        # 3. é€šçŸ¥æ‰€æœ‰æœåŠ¡é‡æ–°è·¯ç”±
        r.publish('rollback_channel', 'immediate_rollback')
        
        print("âœ… å›æ»šå®Œæˆï¼Œæ‰€æœ‰æµé‡åˆ‡å›æ—§ç‰ˆæœ¬")
```

---

## 4. ğŸ’¼ å®é™…éƒ¨ç½²æ¡ˆä¾‹


### 4.1 ç”µå•†ç½‘ç«™æ¶æ„æ¡ˆä¾‹


**ä¸šåŠ¡éœ€æ±‚**ï¼š
- ç”¨æˆ·é‡ï¼š1000ä¸‡
- å•†å“é‡ï¼š100ä¸‡  
- è®¢å•é‡ï¼šæ¯ç§’1000ç¬”
- å¯ç”¨æ€§è¦æ±‚ï¼š99.99%

**æ¶æ„è®¾è®¡**ï¼š
```
ç”µå•†Redisæ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                CDNå±‚                        â”‚
â”‚          (é™æ€èµ„æºç¼“å­˜)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Nginxè´Ÿè½½å‡è¡¡                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚             â”‚             â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
â”‚æœºæˆ¿A   â”‚   â”‚  æœºæˆ¿B   â”‚   â”‚  æœºæˆ¿C   â”‚
â”‚       â”‚   â”‚         â”‚   â”‚         â”‚
â”‚ç”¨æˆ·ä¼šè¯â”‚   â”‚å•†å“ä¿¡æ¯  â”‚   â”‚è®¢å•æ•°æ®  â”‚
â”‚è´­ç‰©è½¦  â”‚   â”‚åº“å­˜     â”‚   â”‚æ”¯ä»˜     â”‚
â”‚ä¸ªäººè®¾ç½®â”‚   â”‚è¯„è®º     â”‚   â”‚ç‰©æµ     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ•°æ®åˆ†å¸ƒç­–ç•¥**ï¼š
```python
# æ ¹æ®æ•°æ®ç±»å‹é€‰æ‹©å­˜å‚¨ä½ç½®
def get_redis_client(data_type, user_id=None):
    if data_type == 'session':
        # ä¼šè¯æ•°æ®ï¼šå°±è¿‘å­˜å‚¨
        return get_nearest_redis(user_id)
    elif data_type == 'product':
        # å•†å“æ•°æ®ï¼šè¯»å¤šå†™å°‘ï¼Œå…¨å±€å¤åˆ¶
        return get_product_redis()
    elif data_type == 'order':
        # è®¢å•æ•°æ®ï¼šæŒ‰ç”¨æˆ·IDåˆ†ç‰‡
        shard = hash(user_id) % 3
        return get_order_redis(shard)
```

### 4.2 ç¤¾äº¤å¹³å°æ¶æ„æ¡ˆä¾‹


**ä¸šåŠ¡ç‰¹ç‚¹**ï¼š
- è¯»å¤šå†™å°‘
- çƒ­ç‚¹æ•°æ®æ˜æ˜¾
- å®æ—¶æ€§è¦æ±‚é«˜
- æ•°æ®é‡å·¨å¤§

```
ç¤¾äº¤å¹³å°Redisæ¶æ„ï¼š
ç”¨æˆ·è¯·æ±‚
    â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¥å…¥å±‚       â”‚ â† CDN + è´Ÿè½½å‡è¡¡
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¼“å­˜å±‚       â”‚ â† å¤šçº§Redisç¼“å­˜
â”‚              â”‚   
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   
â”‚ â”‚çƒ­ç‚¹æ•°æ®æ± â”‚ â”‚ â† æ˜æ˜Ÿã€çƒ­æœå†…å®¹
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ç”¨æˆ·æ•°æ®æ± â”‚ â”‚ â† ä¸ªäººä¿¡æ¯ã€å…³ç³»é“¾
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚å†…å®¹æ•°æ®æ± â”‚ â”‚ â† å¾®åšã€è¯„è®ºã€ç‚¹èµ
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å­˜å‚¨å±‚       â”‚ â† MySQL + MongoDB
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 é‡‘èç³»ç»Ÿæ¶æ„æ¡ˆä¾‹


**ç‰¹æ®Šè¦æ±‚**ï¼š
- **å¼ºä¸€è‡´æ€§**ï¼šè´¦æˆ·ä½™é¢ä¸èƒ½å‡ºé”™
- **é«˜å¯ç”¨æ€§**ï¼šäº¤æ˜“æ—¶é—´ä¸èƒ½åœæœ
- **å®¡è®¡è¦æ±‚**ï¼šæ‰€æœ‰æ“ä½œå¿…é¡»è®°å½•

```python
class FinancialRedisCluster:
    def __init__(self):
        # ä¸»é›†ç¾¤ï¼šå¤„ç†äº¤æ˜“
        self.primary_cluster = redis.RedisCluster(
            startup_nodes=[
                {"host": "10.1.1.1", "port": "7000"},
                {"host": "10.1.1.2", "port": "7000"},
            ]
        )
        
        # å¤‡ä»½é›†ç¾¤ï¼šç¾å¤‡
        self.backup_cluster = redis.RedisCluster(
            startup_nodes=[
                {"host": "10.2.1.1", "port": "7000"},
                {"host": "10.2.1.2", "port": "7000"},
            ]
        )
    
    def transfer_money(self, from_account, to_account, amount):
        """è½¬è´¦æ“ä½œ - éœ€è¦å¼ºä¸€è‡´æ€§"""
        
        # ä½¿ç”¨Luaè„šæœ¬ç¡®ä¿åŸå­æ€§
        lua_script = """
        local from_key = KEYS[1]
        local to_key = KEYS[2]  
        local amount = tonumber(ARGV[1])
        local from_balance = redis.call('GET', from_key)
        
        if not from_balance or tonumber(from_balance) < amount then
            return 0  -- ä½™é¢ä¸è¶³
        end
        
        redis.call('DECRBY', from_key, amount)
        redis.call('INCRBY', to_key, amount)
        return 1  -- è½¬è´¦æˆåŠŸ
        """
        
        try:
            result = self.primary_cluster.eval(
                lua_script, 
                2, 
                f"balance:{from_account}", 
                f"balance:{to_account}", 
                amount
            )
            
            if result == 1:
                # è®°å½•äº¤æ˜“æ—¥å¿—
                self._log_transaction(from_account, to_account, amount)
                return True
            else:
                return False
                
        except Exception as e:
            print(f"è½¬è´¦å¤±è´¥: {e}")
            return False
```

---

## 5. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 5.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ··åˆæ¶æ„ï¼šç»„åˆä¸åŒRediséƒ¨ç½²æ–¹å¼ï¼Œå‘æŒ¥å„è‡ªä¼˜åŠ¿
ğŸ”¸ å¤šçº§ç¼“å­˜ï¼šL1æœ¬åœ°ç¼“å­˜ + L2Redisç¼“å­˜ + L3æ•°æ®åº“å­˜å‚¨
ğŸ”¸ å†·çƒ­åˆ†ç¦»ï¼šæ ¹æ®è®¿é—®é¢‘ç‡å°†æ•°æ®å­˜å‚¨åœ¨ä¸åŒå±‚çº§
ğŸ”¸ å¤šæœºæˆ¿éƒ¨ç½²ï¼šé€šè¿‡åœ°ç†åˆ†å¸ƒæå‡å¯ç”¨æ€§å’Œè®¿é—®é€Ÿåº¦
ğŸ”¸ ç°åº¦å‘å¸ƒï¼šæ–°ç‰ˆæœ¬é€æ­¥æ¨å¹¿ï¼Œé™ä½å‘å¸ƒé£é™©
```

### 5.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ æ¶æ„é€‰æ‹©åŸåˆ™**
```
ä¸šåŠ¡è§„æ¨¡å†³å®šæ¶æ„å¤æ‚åº¦ï¼š
- å°é¡¹ç›®ï¼šå•æœºRedis + ä¸»ä»å¤‡ä»½
- ä¸­ç­‰é¡¹ç›®ï¼šé›†ç¾¤ + å“¨å…µ + è¯»å†™åˆ†ç¦»
- å¤§å‹é¡¹ç›®ï¼šå¤šæœºæˆ¿ + æ··åˆæ¶æ„ + ç°åº¦å‘å¸ƒ

æŠ€æœ¯é€‰æ‹©è€ƒè™‘å› ç´ ï¼š
- æ•°æ®é‡å¤§å°
- å¹¶å‘è®¿é—®é‡  
- å¯ç”¨æ€§è¦æ±‚
- æŠ€æœ¯å›¢é˜Ÿèƒ½åŠ›
- è¿ç»´æˆæœ¬
```

**ğŸ”¹ æ•°æ®ä¸€è‡´æ€§æƒè¡¡**
```
å¼ºä¸€è‡´æ€§åœºæ™¯ï¼š
- è´¦æˆ·ä½™é¢ã€åº“å­˜æ•°é‡
- ä½¿ç”¨åŒæ­¥å¤åˆ¶ï¼Œæ€§èƒ½ç¨ä½ä½†æ•°æ®å‡†ç¡®

æœ€ç»ˆä¸€è‡´æ€§åœºæ™¯ï¼š  
- ç”¨æˆ·åŠ¨æ€ã€è¯„è®ºæ•°é‡
- ä½¿ç”¨å¼‚æ­¥å¤åˆ¶ï¼Œæ€§èƒ½å¥½ä½†å¯èƒ½çŸ­æš‚ä¸ä¸€è‡´

é€‰æ‹©åŸåˆ™ï¼š
æ ¹æ®ä¸šåŠ¡å¯¹æ•°æ®å‡†ç¡®æ€§çš„è¦æ±‚æ¥æƒè¡¡
```

**ğŸ”¹ æ•…éšœå¤„ç†ç­–ç•¥**
```
é¢„é˜²æ•…éšœï¼š
- å¤šæœºæˆ¿éƒ¨ç½²é¿å…å•ç‚¹æ•…éšœ
- ç›‘æ§å‘Šè­¦åŠæ—¶å‘ç°é—®é¢˜
- è‡ªåŠ¨åŒ–è¿ç»´å‡å°‘äººä¸ºé”™è¯¯

å¿«é€Ÿæ¢å¤ï¼š
- è‡ªåŠ¨æ•…éšœè½¬ç§»
- ç°åº¦å›æ»šæœºåˆ¶
- æ•°æ®å¤‡ä»½å’Œæ¢å¤
```

### 5.3 å®é™…åº”ç”¨ä»·å€¼


**ä¸šåŠ¡åœºæ™¯åº”ç”¨**ï¼š
- **äº’è”ç½‘å…¬å¸**ï¼šç”¨æˆ·é‡å¤§ï¼Œéœ€è¦åˆ†å¸ƒå¼æ¶æ„
- **é‡‘èæœºæ„**ï¼šå¯ç”¨æ€§å’Œä¸€è‡´æ€§è¦æ±‚æé«˜
- **ç”µå•†å¹³å°**ï¼šä¿ƒé”€æœŸé—´æµé‡æš´å¢éœ€è¦å¼¹æ€§æ‰©å®¹
- **æ¸¸æˆè¡Œä¸š**ï¼šå…¨çƒç”¨æˆ·éœ€è¦å°±è¿‘è®¿é—®

**æ¶æ„æ¼”è¿›è·¯å¾„**ï¼š
```
åˆ›ä¸šé˜¶æ®µï¼š
å•æœºRedis â†’ è§£å†³åŸºæœ¬ç¼“å­˜éœ€æ±‚

å‘å±•é˜¶æ®µï¼š  
ä¸»ä»å¤åˆ¶ â†’ è¯»å†™åˆ†ç¦»ï¼Œæå‡æ€§èƒ½

æˆé•¿é˜¶æ®µï¼š
å“¨å…µé›†ç¾¤ â†’ é«˜å¯ç”¨ï¼Œè‡ªåŠ¨æ•…éšœè½¬ç§»

æˆç†Ÿé˜¶æ®µï¼š
åˆ†å¸ƒå¼é›†ç¾¤ â†’ æµ·é‡æ•°æ®ï¼Œæ°´å¹³æ‰©å±•

å¤§å‹é˜¶æ®µï¼š
æ··åˆæ¶æ„ â†’ å¤šæœºæˆ¿ï¼Œç°åº¦å‘å¸ƒ
```

### 5.4 å®æ–½å»ºè®®


| é˜¶æ®µ | ç”¨æˆ·è§„æ¨¡ | æ¨èæ¶æ„ | å…³é”®è€ƒè™‘ |
|------|---------|---------|----------|
| **èµ·æ­¥æœŸ** | <10ä¸‡ | å•æœº+ä¸»ä» | ç®€å•å¯é ï¼Œæˆæœ¬ä½ |
| **å‘å±•æœŸ** | 10-100ä¸‡ | å“¨å…µé›†ç¾¤ | é«˜å¯ç”¨ï¼Œè¯»å†™åˆ†ç¦» |
| **æˆé•¿æœŸ** | 100-1000ä¸‡ | Redisé›†ç¾¤ | æ•°æ®åˆ†ç‰‡ï¼Œæ°´å¹³æ‰©å±• |
| **æˆç†ŸæœŸ** | >1000ä¸‡ | æ··åˆæ¶æ„ | å¤šæœºæˆ¿ï¼Œç°åº¦å‘å¸ƒ |

**å…³é”®æˆåŠŸå› ç´ **ï¼š
- **æ¸è¿›å¼æ¼”è¿›**ï¼šä¸è¦ä¸€æ­¥åˆ°ä½ï¼Œæ ¹æ®ä¸šåŠ¡å‘å±•é€æ­¥å‡çº§
- **ç›‘æ§å®Œå–„**ï¼šæ²¡æœ‰ç›‘æ§çš„æ¶æ„æ˜¯ç›²é£
- **è‡ªåŠ¨åŒ–è¿ç»´**ï¼šå‡å°‘äººä¸ºæ“ä½œé”™è¯¯
- **åº”æ€¥é¢„æ¡ˆ**ï¼šæå‰å‡†å¤‡å„ç§æ•…éšœåœºæ™¯çš„å¤„ç†æ–¹æ¡ˆ

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- æ¶æ„è®¾è®¡è¦åŒ¹é…ä¸šåŠ¡è§„æ¨¡å’Œéœ€æ±‚
- å¤šæœºæˆ¿éƒ¨ç½²æ˜¯é«˜å¯ç”¨çš„åŸºç¡€
- ç°åº¦å‘å¸ƒæ˜¯é™ä½å˜æ›´é£é™©çš„æœ‰æ•ˆæ‰‹æ®µ
- ç›‘æ§å’Œè‡ªåŠ¨åŒ–æ˜¯å¤§è§„æ¨¡æ¶æ„çš„å¿…éœ€å“