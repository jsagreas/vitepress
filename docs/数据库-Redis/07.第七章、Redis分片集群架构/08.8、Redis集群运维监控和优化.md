---
title: 8ã€Redisé›†ç¾¤è¿ç»´ç›‘æ§å’Œä¼˜åŒ–
---
## ğŸ“š ç›®å½•

1. [é›†ç¾¤ç›‘æ§ä½“ç³»](#1-é›†ç¾¤ç›‘æ§ä½“ç³»)
2. [æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#2-æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)
3. [è¿ç»´ç®¡ç†å®è·µ](#3-è¿ç»´ç®¡ç†å®è·µ)
4. [æ•…éšœå¤„ç†ä¸é¢„é˜²](#4-æ•…éšœå¤„ç†ä¸é¢„é˜²)
5. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#5-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ“Š é›†ç¾¤ç›‘æ§ä½“ç³»


### 1.1 é›†ç¾¤å¥åº·çŠ¶æ€ç›‘æ§


**ğŸ” ä»€ä¹ˆæ˜¯é›†ç¾¤å¥åº·çŠ¶æ€ï¼Ÿ**

Redisé›†ç¾¤çš„å¥åº·çŠ¶æ€å°±åƒäººçš„ä½“æ£€æŠ¥å‘Šï¼Œéœ€è¦æ£€æŸ¥å„ä¸ª"å™¨å®˜"æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚ä¸€ä¸ªå¥åº·çš„é›†ç¾¤åº”è¯¥æ˜¯ï¼šæ‰€æœ‰èŠ‚ç‚¹éƒ½åœ¨çº¿ã€æ§½ä½åˆ†é…å®Œæ•´ã€æ•°æ®åŒæ­¥æ­£å¸¸ã€‚

**ğŸ¥ å¥åº·æ£€æŸ¥çš„æ ¸å¿ƒæŒ‡æ ‡**

```bash
# æ£€æŸ¥é›†ç¾¤æ•´ä½“çŠ¶æ€
redis-cli --cluster check 127.0.0.1:7000

# è¾“å‡ºç¤ºä¾‹ï¼š
>>> Performing Cluster Check (using node 127.0.0.1:7000)
M: a1b2c3d4... 127.0.0.1:7000
   slots:0-5460 (5461 slots) master
   1 additional replica(s)
S: e5f6g7h8... 127.0.0.1:7001  
   slots: (0 slots) slave
   replicates a1b2c3d4...
[OK] All 16384 slots covered.  â† è¿™æ˜¯å¥åº·çš„å…³é”®æŒ‡æ ‡
```

**ğŸ“ˆ Javaç›‘æ§ä»£ç å®ç°**

```java
@Component
public class ClusterHealthMonitor {
    
    // æ£€æŸ¥é›†ç¾¤èŠ‚ç‚¹çŠ¶æ€
    public ClusterHealthReport checkClusterHealth() {
        ClusterHealthReport report = new ClusterHealthReport();
        
        try (JedisCluster cluster = new JedisCluster(nodes)) {
            // è·å–é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯
            Map<String, JedisPool> clusterNodes = cluster.getClusterNodes();
            
            for (Map.Entry<String, JedisPool> entry : clusterNodes.entrySet()) {
                String nodeId = entry.getKey();
                JedisPool pool = entry.getValue();
                
                try (Jedis jedis = pool.getResource()) {
                    // æ£€æŸ¥èŠ‚ç‚¹å“åº”
                    String pong = jedis.ping();
                    report.addNodeStatus(nodeId, "online".equals(pong.toLowerCase()));
                    
                    // æ£€æŸ¥å†…å­˜ä½¿ç”¨
                    String info = jedis.info("memory");
                    long usedMemory = parseMemoryInfo(info);
                    report.addMemoryUsage(nodeId, usedMemory);
                    
                } catch (Exception e) {
                    report.addNodeStatus(nodeId, false);
                }
            }
        }
        
        return report;
    }
}
```

### 1.2 èŠ‚ç‚¹æ€§èƒ½ç›‘æ§


**âš¡ å…³é”®æ€§èƒ½æŒ‡æ ‡ç›‘æ§**

| ç›‘æ§ç»´åº¦ | **å…³é”®æŒ‡æ ‡** | **æ­£å¸¸èŒƒå›´** | **å‘Šè­¦é˜ˆå€¼** |
|---------|------------|------------|-------------|
| **CPUä½¿ç”¨ç‡** | `Redisè¿›ç¨‹CPUå ç”¨` | `< 80%` | `> 90%` |
| **å†…å­˜ä½¿ç”¨** | `å·²ç”¨å†…å­˜/æœ€å¤§å†…å­˜` | `< 70%` | `> 85%` |
| **ç½‘ç»œIO** | `ç½‘ç»œè¾“å…¥è¾“å‡ºé€Ÿç‡` | `< å¸¦å®½80%` | `> å¸¦å®½90%` |
| **å‘½ä»¤å¤„ç†** | `æ¯ç§’å¤„ç†å‘½ä»¤æ•°` | `ä¸šåŠ¡ç›¸å…³` | `å¼‚å¸¸ä¸‹é™50%` |
| **è¿æ¥æ•°** | `å½“å‰å®¢æˆ·ç«¯è¿æ¥æ•°` | `< æœ€å¤§è¿æ¥80%` | `> æœ€å¤§è¿æ¥90%` |

**ğŸ“Š æ€§èƒ½ç›‘æ§è„šæœ¬**

```bash
#!/bin/bash
# cluster_monitor.sh - é›†ç¾¤æ€§èƒ½ç›‘æ§è„šæœ¬

NODES=("127.0.0.1:7000" "127.0.0.1:7001" "127.0.0.1:7002")

for node in "${NODES[@]}"; do
    echo "=== æ£€æŸ¥èŠ‚ç‚¹ $node ==="
    
    # åŸºç¡€è¿é€šæ€§
    redis-cli -h ${node%:*} -p ${node#*:} ping
    
    # å†…å­˜ä½¿ç”¨æƒ…å†µ
    redis-cli -h ${node%:*} -p ${node#*:} info memory | grep used_memory_human
    
    # å‘½ä»¤ç»Ÿè®¡
    redis-cli -h ${node%:*} -p ${node#*:} info stats | grep total_commands_processed
    
    # è¿æ¥æ•°ç»Ÿè®¡
    redis-cli -h ${node%:*} -p ${node#*:} info clients | grep connected_clients
    
    echo ""
done
```

### 1.3 æ§½ä½åˆ†å¸ƒç›‘æ§


**ğŸ¯ ä»€ä¹ˆæ˜¯æ§½ä½åˆ†å¸ƒï¼Ÿ**

Redisé›†ç¾¤æŠŠæ‰€æœ‰æ•°æ®åˆ†æˆ16384ä¸ªæ§½ä½ï¼Œæ¯ä¸ªä¸»èŠ‚ç‚¹è´Ÿè´£ä¸€éƒ¨åˆ†æ§½ä½ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œæ§½ä½åº”è¯¥å‡åŒ€åˆ†å¸ƒï¼Œè¿™æ ·æ•°æ®å’Œè´Ÿè½½æ‰èƒ½å¹³è¡¡ã€‚

```
æ§½ä½åˆ†å¸ƒç¤ºä¾‹ï¼š
èŠ‚ç‚¹A: æ§½ä½ 0-5460     (5461ä¸ªæ§½ä½)  33.3%
èŠ‚ç‚¹B: æ§½ä½ 5461-10922 (5462ä¸ªæ§½ä½)  33.3%  
èŠ‚ç‚¹C: æ§½ä½ 10923-16383(5461ä¸ªæ§½ä½)  33.3%

ç†æƒ³çŠ¶æ€ï¼šå„èŠ‚ç‚¹æ§½ä½æ•°é‡åŸºæœ¬ç›¸ç­‰
```

**ğŸ“Š æ§½ä½åˆ†å¸ƒæ£€æŸ¥å·¥å…·**

```python
#!/usr/bin/env python3
# slot_distribution_check.py

import redis
from collections import defaultdict

def check_slot_distribution():
    # è¿æ¥é›†ç¾¤
    r = redis.Redis(host='127.0.0.1', port=7000, decode_responses=True)
    
    # è·å–é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯
    cluster_info = r.execute_command('CLUSTER', 'NODES')
    
    slot_distribution = defaultdict(int)
    
    for line in cluster_info.strip().split('\n'):
        parts = line.split()
        node_id = parts[0]
        role = parts[2]
        
        if 'master' in role and len(parts) > 8:
            # è§£ææ§½ä½èŒƒå›´
            slots_info = parts[8:]
            for slot_range in slots_info:
                if '-' in slot_range:
                    start, end = map(int, slot_range.split('-'))
                    slot_distribution[node_id] += end - start + 1
                else:
                    slot_distribution[node_id] += 1
    
    # è¾“å‡ºåˆ†å¸ƒæƒ…å†µ
    total_slots = 16384
    for node_id, slot_count in slot_distribution.items():
        percentage = (slot_count / total_slots) * 100
        print(f"èŠ‚ç‚¹ {node_id[:8]}: {slot_count:5d} æ§½ä½ ({percentage:.1f}%)")
        
        # æ£€æŸ¥æ˜¯å¦å‡åŒ€åˆ†å¸ƒ
        if abs(percentage - 33.33) > 5:
            print(f"  âš ï¸  è­¦å‘Šï¼šèŠ‚ç‚¹æ§½ä½åˆ†å¸ƒä¸å‡åŒ€ï¼")

if __name__ == '__main__':
    check_slot_distribution()
```

### 1.4 æ•°æ®å€¾æ–œæ£€æµ‹


**ğŸ¤” ä»€ä¹ˆæ˜¯æ•°æ®å€¾æ–œï¼Ÿ**

æ•°æ®å€¾æ–œå°±æ˜¯é›†ç¾¤ä¸­æŸäº›èŠ‚ç‚¹å­˜å‚¨çš„æ•°æ®é‡æ˜æ˜¾æ¯”å…¶ä»–èŠ‚ç‚¹å¤šã€‚è¿™å°±åƒå‡ ä¸ªäººåˆ†è›‹ç³•ï¼Œæœ‰äººåˆ†åˆ°å¤§å—ï¼Œæœ‰äººåˆ†åˆ°å°å—ï¼Œå¯¼è‡´è´Ÿè½½ä¸å‡åŒ€ã€‚

```
æ•°æ®å€¾æ–œç¤ºä¾‹ï¼š
èŠ‚ç‚¹A: 2GBæ•°æ®  50%  â† æ•°æ®è¿‡å¤šï¼Œå¯èƒ½æˆä¸ºç“¶é¢ˆ
èŠ‚ç‚¹B: 1GBæ•°æ®  25%
èŠ‚ç‚¹C: 1GBæ•°æ®  25%

ç†æƒ³åˆ†å¸ƒï¼š
èŠ‚ç‚¹A: 1.33GB  33.3%
èŠ‚ç‚¹B: 1.33GB  33.3%
èŠ‚ç‚¹C: 1.33GB  33.3%
```

**ğŸ” æ•°æ®å€¾æ–œæ£€æµ‹å·¥å…·**

```bash
#!/bin/bash
# data_skew_detector.sh

echo "Redisé›†ç¾¤æ•°æ®å€¾æ–œæ£€æµ‹"
echo "===================="

declare -A node_memory

# è·å–å„èŠ‚ç‚¹å†…å­˜ä½¿ç”¨
for port in 7000 7001 7002 7003 7004 7005; do
    memory=$(redis-cli -p $port info memory | grep used_memory_human | cut -d: -f2 | tr -d '\r')
    node_memory[$port]=$memory
    echo "èŠ‚ç‚¹ 127.0.0.1:$port å†…å­˜ä½¿ç”¨: $memory"
done

echo ""
echo "æ•°æ®åˆ†å¸ƒåˆ†æï¼š"

# åˆ†ææ•°æ®å€¾æ–œæƒ…å†µ
total_memory=0
for memory in "${node_memory[@]}"; do
    # è½¬æ¢ä¸ºå­—èŠ‚æ•°è¿›è¡Œè®¡ç®—
    memory_bytes=$(echo $memory | sed 's/[A-Za-z]//g')
    total_memory=$((total_memory + memory_bytes))
done

for port in "${!node_memory[@]}"; do
    memory=${node_memory[$port]}
    memory_bytes=$(echo $memory | sed 's/[A-Za-z]//g')
    percentage=$(echo "scale=1; $memory_bytes * 100 / $total_memory" | bc)
    
    echo "èŠ‚ç‚¹ $port: $percentage%"
    
    # æ£€æŸ¥æ˜¯å¦è¶…è¿‡é˜ˆå€¼
    if (( $(echo "$percentage > 40" | bc -l) )); then
        echo "  âš ï¸  è­¦å‘Šï¼šè¯¥èŠ‚ç‚¹æ•°æ®å€¾æ–œä¸¥é‡ï¼"
    fi
done
```

---

## 2. ğŸš€ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


### 2.1 çƒ­ç‚¹æ•°æ®å¤„ç†


**ğŸ”¥ ä»€ä¹ˆæ˜¯çƒ­ç‚¹æ•°æ®é—®é¢˜ï¼Ÿ**

æƒ³è±¡ä¸€ä¸ªå•†åœºï¼Œå¦‚æœæ‰€æœ‰äººéƒ½æŒ¤åˆ°ä¸€ä¸ªæ”¶é“¶å°ï¼Œå…¶ä»–æ”¶é“¶å°ç©ºç€ï¼Œå°±ä¼šé€ æˆæ’é˜Ÿæ‹¥å µã€‚Redisé›†ç¾¤ä¸­ï¼Œå¦‚æœæŸäº›æ•°æ®è¢«å¤§é‡è®¿é—®ï¼Œå¯¹åº”çš„èŠ‚ç‚¹å°±ä¼šæˆä¸ºç“¶é¢ˆã€‚

**çƒ­ç‚¹æ•°æ®äº§ç”Ÿçš„åŸå› ï¼š**
```
1. ä¸šåŠ¡çƒ­ç‚¹ï¼šæ˜æ˜Ÿå•†å“ã€çƒ­é—¨è¯é¢˜
2. æ•°æ®ç»“æ„ï¼šå¤§å‹Hashã€Setç­‰å ç”¨å¤§é‡å†…å­˜
3. è®¿é—®æ¨¡å¼ï¼šæŸäº›keyè¢«é¢‘ç¹è¯»å†™
4. æ—¶é—´èšé›†ï¼šæ´»åŠ¨æœŸé—´çš„çªå‘è®¿é—®
```

**ğŸ› ï¸ çƒ­ç‚¹æ•°æ®å¤„ç†ç­–ç•¥**

```java
@Service
public class HotDataHandler {
    
    // çƒ­ç‚¹æ•°æ®æœ¬åœ°ç¼“å­˜
    private LoadingCache<String, Object> localCache = Caffeine.newBuilder()
            .maximumSize(1000)
            .expireAfterWrite(30, TimeUnit.SECONDS)
            .build(key -> getFromRedisCluster(key));
    
    // å¤šçº§ç¼“å­˜ç­–ç•¥
    public Object getHotData(String key) {
        // L1: æœ¬åœ°ç¼“å­˜ï¼ˆæœ€å¿«ï¼‰
        try {
            return localCache.get(key);
        } catch (Exception e) {
            // L2: Redisç¼“å­˜
            return getFromRedisCluster(key);
        }
    }
    
    // çƒ­ç‚¹æ•°æ®åˆ†æ•£å­˜å‚¨
    public void storeHotData(String key, Object value) {
        // ä¸»å­˜å‚¨
        jedisCluster.setex(key, 3600, JSON.toJSONString(value));
        
        // åˆ›å»ºå¤šä¸ªå‰¯æœ¬åˆ†æ•£åˆ°ä¸åŒèŠ‚ç‚¹
        for (int i = 1; i <= 3; i++) {
            String backupKey = key + ":backup:" + i;
            jedisCluster.setex(backupKey, 3600, JSON.toJSONString(value));
        }
    }
    
    // æ™ºèƒ½è¯»å–ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰
    public Object getHotDataBalanced(String key) {
        // éšæœºé€‰æ‹©ä¸€ä¸ªå‰¯æœ¬è¯»å–
        int replica = new Random().nextInt(3) + 1;
        String readKey = key + ":backup:" + replica;
        
        String data = jedisCluster.get(readKey);
        if (data == null) {
            data = jedisCluster.get(key); // å›é€€åˆ°ä¸»key
        }
        
        return JSON.parseObject(data, Object.class);
    }
}
```

### 2.2 è·¨æ§½æ“ä½œä¼˜åŒ–


**ğŸ¯ ä»€ä¹ˆæ˜¯è·¨æ§½æ“ä½œï¼Ÿ**

Redisé›†ç¾¤ä¸­ï¼Œå¦‚æœä¸€ä¸ªæ“ä½œæ¶‰åŠå¤šä¸ªä¸åœ¨åŒä¸€æ§½ä½çš„keyï¼Œå°±éœ€è¦è·¨æ§½æ“ä½œã€‚è¿™å°±åƒä½ è¦åœ¨ä¸åŒçš„é“¶è¡Œç½‘ç‚¹åŠä¸šåŠ¡ï¼Œæ•ˆç‡ä¼šæ¯”åœ¨åŒä¸€ç½‘ç‚¹ä½ã€‚

```
å•æ§½æ“ä½œï¼ˆé«˜æ•ˆï¼‰ï¼š
MGET user:1001 user:1002  â† å¦‚æœéƒ½åœ¨åŒä¸€æ§½ä½

è·¨æ§½æ“ä½œï¼ˆä½æ•ˆï¼‰ï¼š  
MGET user:1001 order:2001 â† user:1001å’Œorder:2001åœ¨ä¸åŒæ§½ä½
```

**âš¡ è·¨æ§½ä¼˜åŒ–ç­–ç•¥**

```java
public class CrossSlotOptimizer {
    
    // æŒ‰æ§½ä½åˆ†ç»„æ‰¹é‡æ“ä½œ
    public Map<String, String> mgetOptimized(List<String> keys) {
        // æŒ‰æ§½ä½åˆ†ç»„
        Map<Integer, List<String>> slotGroups = groupBySlot(keys);
        Map<String, String> results = new HashMap<>();
        
        // å¹¶è¡Œå¤„ç†æ¯ä¸ªæ§½ä½ç»„
        slotGroups.entrySet().parallelStream().forEach(entry -> {
            List<String> slotKeys = entry.getValue();
            try {
                // å¯¹åŒä¸€æ§½ä½çš„keyè¿›è¡Œæ‰¹é‡æ“ä½œ
                List<String> values = jedisCluster.mget(slotKeys.toArray(new String[0]));
                for (int i = 0; i < slotKeys.size(); i++) {
                    results.put(slotKeys.get(i), values.get(i));
                }
            } catch (Exception e) {
                // å¤„ç†å¼‚å¸¸æƒ…å†µ
                for (String key : slotKeys) {
                    results.put(key, jedisCluster.get(key));
                }
            }
        });
        
        return results;
    }
    
    // è®¡ç®—keyå±äºå“ªä¸ªæ§½ä½
    private Map<Integer, List<String>> groupBySlot(List<String> keys) {
        Map<Integer, List<String>> groups = new HashMap<>();
        
        for (String key : keys) {
            int slot = JedisClusterCRC16.getSlot(key);
            groups.computeIfAbsent(slot, k -> new ArrayList<>()).add(key);
        }
        
        return groups;
    }
}
```

### 2.3 æ‰¹é‡æ“ä½œé™åˆ¶ä¸ä¼˜åŒ–


**ğŸ“¦ æ‰¹é‡æ“ä½œçš„ä¸¤é¢æ€§**

æ‰¹é‡æ“ä½œå°±åƒæ‰¹å‘è´­ç‰©ï¼Œæ•ˆç‡é«˜ä½†æœ‰é£é™©ã€‚ä¸€æ¬¡æ€§æ“ä½œå¤ªå¤šæ•°æ®å¯èƒ½å¯¼è‡´ï¼š
- é˜»å¡å…¶ä»–å®¢æˆ·ç«¯è¯·æ±‚
- ç½‘ç»œä¼ è¾“è¶…æ—¶
- å†…å­˜ä½¿ç”¨å³°å€¼è¿‡é«˜

**ğŸ›ï¸ æ™ºèƒ½æ‰¹é‡å¤„ç†**

```java
public class BatchOperationOptimizer {
    private static final int MAX_BATCH_SIZE = 100;
    private static final int MAX_BATCH_MEMORY = 1024 * 1024; // 1MB
    
    // å®‰å…¨çš„æ‰¹é‡è®¾ç½®
    public void safeBatchSet(Map<String, String> dataMap) {
        List<Map.Entry<String, String>> entries = new ArrayList<>(dataMap.entrySet());
        
        for (int i = 0; i < entries.size(); i += MAX_BATCH_SIZE) {
            int endIndex = Math.min(i + MAX_BATCH_SIZE, entries.size());
            List<Map.Entry<String, String>> batch = entries.subList(i, endIndex);
            
            // æ£€æŸ¥æ‰¹æ¬¡å¤§å°
            int batchMemory = calculateBatchSize(batch);
            if (batchMemory > MAX_BATCH_MEMORY) {
                // è¿›ä¸€æ­¥åˆ†å‰²æ‰¹æ¬¡
                processSmallerBatch(batch);
            } else {
                // æ‰§è¡Œæ‰¹é‡æ“ä½œ
                executeBatch(batch);
            }
            
            // é¿å…è¿ç»­æ‰¹é‡æ“ä½œå¯¼è‡´é˜»å¡
            Thread.sleep(10);
        }
    }
    
    private void executeBatch(List<Map.Entry<String, String>> batch) {
        Pipeline pipeline = jedis.pipelined();
        
        for (Map.Entry<String, String> entry : batch) {
            pipeline.set(entry.getKey(), entry.getValue());
        }
        
        pipeline.sync(); // æ‰§è¡Œæ‰€æœ‰å‘½ä»¤
    }
}
```

### 2.4 ç½‘ç»œå»¶è¿Ÿä¼˜åŒ–


**ğŸŒ ç½‘ç»œä¼˜åŒ–ç­–ç•¥**

```java
public class NetworkOptimizer {
    
    // è¿æ¥æ± ä¼˜åŒ–é…ç½®
    public JedisPoolConfig getOptimalPoolConfig() {
        JedisPoolConfig config = new JedisPoolConfig();
        
        // è¿æ¥æ± å¤§å°ä¼˜åŒ–
        config.setMaxTotal(200);        // æœ€å¤§è¿æ¥æ•°
        config.setMaxIdle(50);         // æœ€å¤§ç©ºé—²è¿æ¥
        config.setMinIdle(10);         // æœ€å°ç©ºé—²è¿æ¥
        
        // è¿æ¥è¶…æ—¶ä¼˜åŒ–
        config.setMaxWaitMillis(3000); // è·å–è¿æ¥æœ€å¤§ç­‰å¾…æ—¶é—´
        
        // è¿æ¥æ£€æµ‹ä¼˜åŒ–
        config.setTestOnBorrow(false); // ä¸åœ¨è·å–æ—¶æµ‹è¯•ï¼Œæå‡æ€§èƒ½
        config.setTestWhileIdle(true); // ç©ºé—²æ—¶æµ‹è¯•è¿æ¥æœ‰æ•ˆæ€§
        config.setTimeBetweenEvictionRunsMillis(30000); // 30ç§’æ£€æµ‹ä¸€æ¬¡
        
        return config;
    }
    
    // å®¢æˆ·ç«¯é…ç½®ä¼˜åŒ–
    public JedisCluster createOptimizedCluster(Set<HostAndPort> nodes) {
        return new JedisCluster(nodes, 
                2000,    // è¿æ¥è¶…æ—¶
                5000,    // è¯»å–è¶…æ—¶
                5,       // é‡è¯•æ¬¡æ•°
                "password", // è®¤è¯å¯†ç 
                getOptimalPoolConfig());
    }
}
```

---

## 3. ğŸ”§ è¿ç»´ç®¡ç†å®è·µ


### 3.1 é›†ç¾¤å·¡æ£€è„šæœ¬


**ğŸ” è‡ªåŠ¨åŒ–å·¡æ£€çš„ä»·å€¼**

è¿ç»´å·¡æ£€å°±åƒåŒ»ç”ŸæŸ¥æˆ¿ï¼Œå®šæœŸæ£€æŸ¥æ¯ä¸ª"ç—…äºº"çš„æƒ…å†µã€‚è‡ªåŠ¨åŒ–å·¡æ£€èƒ½åŠæ—©å‘ç°é—®é¢˜ï¼Œé¿å…å°é—®é¢˜å˜æˆå¤§æ•…éšœã€‚

**ğŸ“‹ ç»¼åˆå·¡æ£€è„šæœ¬**

```bash
#!/bin/bash
# redis_cluster_patrol.sh - Redisé›†ç¾¤è‡ªåŠ¨å·¡æ£€

LOG_FILE="/var/log/redis-patrol-$(date +%Y%m%d).log"
EMAIL_ALERT="admin@company.com"
ALERT_THRESHOLD=85

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a $LOG_FILE
}

# æ£€æŸ¥é›†ç¾¤çŠ¶æ€
check_cluster_status() {
    log "å¼€å§‹æ£€æŸ¥é›†ç¾¤çŠ¶æ€..."
    
    # æ£€æŸ¥é›†ç¾¤æ˜¯å¦OK
    status=$(redis-cli --cluster check 127.0.0.1:7000 2>&1)
    
    if echo "$status" | grep -q "All 16384 slots covered"; then
        log "âœ… é›†ç¾¤çŠ¶æ€æ­£å¸¸ï¼šæ‰€æœ‰æ§½ä½å·²è¦†ç›–"
    else
        log "âŒ é›†ç¾¤çŠ¶æ€å¼‚å¸¸ï¼šå­˜åœ¨æœªè¦†ç›–æ§½ä½"
        send_alert "Redisé›†ç¾¤æ§½ä½è¦†ç›–å¼‚å¸¸" "$status"
    fi
}

# æ£€æŸ¥èŠ‚ç‚¹å¥åº·
check_nodes_health() {
    log "å¼€å§‹æ£€æŸ¥èŠ‚ç‚¹å¥åº·çŠ¶å†µ..."
    
    for port in 7000 7001 7002 7003 7004 7005; do
        # è¿é€šæ€§æ£€æŸ¥
        if redis-cli -p $port ping >/dev/null 2>&1; then
            log "âœ… èŠ‚ç‚¹ 127.0.0.1:$port è¿é€šæ­£å¸¸"
            
            # å†…å­˜ä½¿ç”¨æ£€æŸ¥
            memory_usage=$(redis-cli -p $port info memory | grep used_memory_peak_perc | cut -d: -f2 | tr -d '\r%')
            
            if [ "$memory_usage" -gt "$ALERT_THRESHOLD" ]; then
                log "âš ï¸  èŠ‚ç‚¹ 127.0.0.1:$port å†…å­˜ä½¿ç”¨è¿‡é«˜: ${memory_usage}%"
                send_alert "RedisèŠ‚ç‚¹å†…å­˜å‘Šè­¦" "èŠ‚ç‚¹$portå†…å­˜ä½¿ç”¨${memory_usage}%"
            else
                log "âœ… èŠ‚ç‚¹ 127.0.0.1:$port å†…å­˜ä½¿ç”¨æ­£å¸¸: ${memory_usage}%"
            fi
            
        else
            log "âŒ èŠ‚ç‚¹ 127.0.0.1:$port è¿æ¥å¤±è´¥"
            send_alert "RedisèŠ‚ç‚¹ç¦»çº¿" "èŠ‚ç‚¹127.0.0.1:$portæ— æ³•è¿æ¥"
        fi
    done
}

# æ£€æŸ¥ä¸»ä»åŒæ­¥
check_replication() {
    log "å¼€å§‹æ£€æŸ¥ä¸»ä»åŒæ­¥çŠ¶æ€..."
    
    for port in 7000 7001 7002; do  # ä¸»èŠ‚ç‚¹
        repl_info=$(redis-cli -p $port info replication)
        
        # æ£€æŸ¥ä»èŠ‚ç‚¹è¿æ¥çŠ¶æ€
        connected_slaves=$(echo "$repl_info" | grep connected_slaves | cut -d: -f2 | tr -d '\r')
        
        if [ "$connected_slaves" -gt 0 ]; then
            log "âœ… ä¸»èŠ‚ç‚¹ $port æœ‰ $connected_slaves ä¸ªä»èŠ‚ç‚¹åœ¨çº¿"
        else
            log "âš ï¸  ä¸»èŠ‚ç‚¹ $port æ²¡æœ‰ä»èŠ‚ç‚¹è¿æ¥"
        fi
    done
}

# å‘é€å‘Šè­¦
send_alert() {
    local subject=$1
    local content=$2
    echo "$content" | mail -s "$subject" $EMAIL_ALERT
    log "ğŸ“§ å·²å‘é€å‘Šè­¦é‚®ä»¶: $subject"
}

# ä¸»å‡½æ•°
main() {
    log "========== å¼€å§‹Redisé›†ç¾¤å·¡æ£€ =========="
    
    check_cluster_status
    check_nodes_health  
    check_replication
    
    log "========== å·¡æ£€å®Œæˆ =========="
}

main
```

### 3.2 è‡ªåŠ¨åŒ–éƒ¨ç½²å·¥å…·


**ğŸš€ ä¸€é”®éƒ¨ç½²è„šæœ¬**

```bash
#!/bin/bash
# redis_cluster_deploy.sh

REDIS_VERSION="7.0.11"
CLUSTER_NODES=6
BASE_PORT=7000

# åˆ›å»ºé›†ç¾¤ç›®å½•ç»“æ„
setup_directories() {
    echo "åˆ›å»ºRedisé›†ç¾¤ç›®å½•ç»“æ„..."
    
    for ((i=0; i<$CLUSTER_NODES; i++)); do
        port=$((BASE_PORT + i))
        mkdir -p "/data/redis-cluster/$port"/{conf,data,logs}
    done
}

# ç”Ÿæˆé…ç½®æ–‡ä»¶
generate_config() {
    for ((i=0; i<$CLUSTER_NODES; i++)); do
        port=$((BASE_PORT + i))
        config_file="/data/redis-cluster/$port/conf/redis.conf"
        
        cat > $config_file << EOF
# Redisé›†ç¾¤èŠ‚ç‚¹é…ç½® - ç«¯å£ $port
port $port
cluster-enabled yes
cluster-config-file nodes-$port.conf
cluster-node-timeout 5000
cluster-require-full-coverage no

# æ•°æ®æŒä¹…åŒ–
appendonly yes
appendfsync everysec
save 900 1
save 300 10

# å†…å­˜å’Œè¿æ¥
maxmemory 2gb
maxmemory-policy allkeys-lru
tcp-keepalive 300
timeout 300

# æ—¥å¿—é…ç½®
dir /data/redis-cluster/$port/data
logfile /data/redis-cluster/$port/logs/redis.log
loglevel notice

# ç½‘ç»œä¼˜åŒ–
tcp-backlog 511
bind 0.0.0.0
protected-mode no
EOF
        
        echo "âœ… ç”ŸæˆèŠ‚ç‚¹ $port é…ç½®æ–‡ä»¶"
    done
}

# å¯åŠ¨æ‰€æœ‰èŠ‚ç‚¹
start_nodes() {
    echo "å¯åŠ¨Redisé›†ç¾¤èŠ‚ç‚¹..."
    
    for ((i=0; i<$CLUSTER_NODES; i++)); do
        port=$((BASE_PORT + i))
        config_file="/data/redis-cluster/$port/conf/redis.conf"
        
        redis-server $config_file &
        echo "âœ… å¯åŠ¨èŠ‚ç‚¹ 127.0.0.1:$port"
    done
    
    sleep 3
}

# åˆ›å»ºé›†ç¾¤
create_cluster() {
    echo "åˆ›å»ºRedisé›†ç¾¤..."
    
    nodes=""
    for ((i=0; i<$CLUSTER_NODES; i++)); do
        port=$((BASE_PORT + i))
        nodes="$nodes 127.0.0.1:$port"
    done
    
    redis-cli --cluster create $nodes --cluster-replicas 1 --cluster-yes
    
    echo "ğŸ‰ Redisé›†ç¾¤åˆ›å»ºå®Œæˆï¼"
}

# ä¸»å‡½æ•°
main() {
    echo "========== Redisé›†ç¾¤è‡ªåŠ¨åŒ–éƒ¨ç½² =========="
    
    setup_directories
    generate_config
    start_nodes
    create_cluster
    
    echo "========== éƒ¨ç½²å®Œæˆ =========="
    redis-cli --cluster info 127.0.0.1:7000
}

main
```

### 3.3 å¤‡ä»½ç­–ç•¥åˆ¶å®š


**ğŸ’¾ é›†ç¾¤å¤‡ä»½çš„æŒ‘æˆ˜**

å•æœºRediså¤‡ä»½å¾ˆç®€å•ï¼Œä½†é›†ç¾¤å¤‡ä»½è¦è€ƒè™‘ï¼š
- **æ•°æ®ä¸€è‡´æ€§**ï¼šæ‰€æœ‰èŠ‚ç‚¹çš„å¤‡ä»½æ—¶é—´ç‚¹è¦ä¸€è‡´
- **æ§½ä½å®Œæ•´æ€§**ï¼šç¡®ä¿16384ä¸ªæ§½ä½éƒ½è¢«å¤‡ä»½
- **ä¸»ä»å…³ç³»**ï¼šå¤‡ä»½æ—¶è¦è®°å½•ä¸»ä»æ‹“æ‰‘ç»“æ„

**ğŸ“‹ åˆ†å±‚å¤‡ä»½ç­–ç•¥**

```bash
#!/bin/bash
# cluster_backup.sh

BACKUP_DIR="/backup/redis-cluster/$(date +%Y%m%d)"
NODES=("127.0.0.1:7000" "127.0.0.1:7001" "127.0.0.1:7002")

# å…¨é‡å¤‡ä»½
full_backup() {
    echo "å¼€å§‹Redisé›†ç¾¤å…¨é‡å¤‡ä»½..."
    mkdir -p $BACKUP_DIR
    
    # 1. å¤‡ä»½é›†ç¾¤æ‹“æ‰‘ä¿¡æ¯
    redis-cli --cluster info 127.0.0.1:7000 > $BACKUP_DIR/cluster-topology.info
    redis-cli -p 7000 cluster nodes > $BACKUP_DIR/cluster-nodes.conf
    
    # 2. åŒæ—¶è§¦å‘æ‰€æœ‰èŠ‚ç‚¹çš„RDBå¤‡ä»½
    for node in "${NODES[@]}"; do
        host=${node%:*}
        port=${node#*:}
        
        echo "å¤‡ä»½èŠ‚ç‚¹ $node..."
        redis-cli -h $host -p $port BGSAVE
        
        # ç­‰å¾…å¤‡ä»½å®Œæˆ
        while [ "$(redis-cli -h $host -p $port LASTSAVE)" = "$(redis-cli -h $host -p $port LASTSAVE)" ]; do
            sleep 1
        done
        
        # å¤åˆ¶RDBæ–‡ä»¶
        cp "/data/redis-cluster/$port/data/dump.rdb" "$BACKUP_DIR/dump-$port.rdb"
        echo "âœ… èŠ‚ç‚¹ $port å¤‡ä»½å®Œæˆ"
    done
    
    echo "ğŸ‰ é›†ç¾¤å…¨é‡å¤‡ä»½å®Œæˆ: $BACKUP_DIR"
}

# å¢é‡å¤‡ä»½ï¼ˆAOFï¼‰
incremental_backup() {
    echo "å¼€å§‹Redisé›†ç¾¤å¢é‡å¤‡ä»½..."
    
    for node in "${NODES[@]}"; do
        host=${node%:*}
        port=${node#*:}
        
        # å¤åˆ¶AOFæ–‡ä»¶
        if [ -f "/data/redis-cluster/$port/data/appendonly.aof" ]; then
            cp "/data/redis-cluster/$port/data/appendonly.aof" "$BACKUP_DIR/appendonly-$port.aof"
            echo "âœ… èŠ‚ç‚¹ $port AOFå¤‡ä»½å®Œæˆ"
        fi
    done
}

# å¤‡ä»½æ¸…ç†
cleanup_old_backups() {
    # ä¿ç•™æœ€è¿‘7å¤©çš„å¤‡ä»½
    find /backup/redis-cluster -name "2*" -type d -mtime +7 -exec rm -rf {} \;
    echo "ğŸ—‘ï¸  æ¸…ç†7å¤©å‰çš„å¤‡ä»½æ–‡ä»¶"
}

main() {
    full_backup
    incremental_backup
    cleanup_old_backups
}

main
```

### 3.4 ç‰ˆæœ¬å‡çº§æ–¹æ¡ˆ


**ğŸ”„ æ»šåŠ¨å‡çº§æµç¨‹**

Redisé›†ç¾¤å‡çº§å°±åƒæ›´æ¢è½®èƒï¼Œä¸èƒ½ä¸€æ¬¡æ€§å…¨æ¢ï¼Œè¦ä¸€ä¸ªä¸€ä¸ªæ¥ï¼Œä¿è¯æœåŠ¡ä¸ä¸­æ–­ã€‚

```
å‡çº§æµç¨‹å›¾ï¼š
æ­¥éª¤1: å‡çº§ä»èŠ‚ç‚¹
       Master1 â†’ Slave1(å‡çº§ä¸­)
       Master2 â†’ Slave2  
       Master3 â†’ Slave3

æ­¥éª¤2: ä¸»ä»åˆ‡æ¢
       Slave1(æ–°ç‰ˆæœ¬) â† åˆ‡æ¢ä¸ºä¸»èŠ‚ç‚¹
       Master1(æ—§ç‰ˆæœ¬) â†’ åˆ‡æ¢ä¸ºä»èŠ‚ç‚¹

æ­¥éª¤3: å‡çº§åŸä¸»èŠ‚ç‚¹
       Slave1(æ–°ç‰ˆæœ¬,ä¸») â†’ Master1(å‡çº§ä¸­)

é‡å¤ä»¥ä¸Šæ­¥éª¤å‡çº§æ‰€æœ‰èŠ‚ç‚¹
```

**ğŸ”§ å‡çº§è„šæœ¬å®ç°**

```bash
#!/bin/bash
# rolling_upgrade.sh

NEW_VERSION="7.0.11"
NODES=("7000:7003" "7001:7004" "7002:7005") # master:slaveé…å¯¹

# å•èŠ‚ç‚¹å‡çº§
upgrade_node() {
    local port=$1
    local is_master=$2
    
    echo "å‡çº§èŠ‚ç‚¹ 127.0.0.1:$port..."
    
    # 1. åœæ­¢èŠ‚ç‚¹
    redis-cli -p $port SHUTDOWN SAVE
    sleep 2
    
    # 2. å¤‡ä»½é…ç½®å’Œæ•°æ®
    cp "/data/redis-cluster/$port/conf/redis.conf" "/backup/redis.conf.$port.$(date +%s)"
    cp "/data/redis-cluster/$port/data/dump.rdb" "/backup/dump.$port.$(date +%s).rdb"
    
    # 3. å®‰è£…æ–°ç‰ˆæœ¬
    install_redis_version $NEW_VERSION $port
    
    # 4. å¯åŠ¨èŠ‚ç‚¹
    redis-server "/data/redis-cluster/$port/conf/redis.conf" &
    sleep 5
    
    # 5. éªŒè¯èŠ‚ç‚¹çŠ¶æ€
    if redis-cli -p $port ping | grep -q "PONG"; then
        echo "âœ… èŠ‚ç‚¹ $port å‡çº§æˆåŠŸ"
        return 0
    else
        echo "âŒ èŠ‚ç‚¹ $port å‡çº§å¤±è´¥"
        return 1
    fi
}

# ä¸»ä»åˆ‡æ¢
failover_node() {
    local master_port=$1
    local slave_port=$2
    
    echo "æ‰§è¡Œä¸»ä»åˆ‡æ¢: $master_port -> $slave_port"
    
    # åœ¨ä»èŠ‚ç‚¹æ‰§è¡Œæ•…éšœè½¬ç§»
    redis-cli -p $slave_port CLUSTER FAILOVER
    
    # ç­‰å¾…åˆ‡æ¢å®Œæˆ
    sleep 10
    
    # éªŒè¯åˆ‡æ¢ç»“æœ
    role=$(redis-cli -p $slave_port info replication | grep "role:master")
    if [ -n "$role" ]; then
        echo "âœ… ä¸»ä»åˆ‡æ¢æˆåŠŸ"
    else
        echo "âŒ ä¸»ä»åˆ‡æ¢å¤±è´¥"
        exit 1
    fi
}

# æ»šåŠ¨å‡çº§ä¸»æµç¨‹
rolling_upgrade() {
    for node_pair in "${NODES[@]}"; do
        master_port=${node_pair%:*}
        slave_port=${node_pair#*:}
        
        echo "========== å‡çº§èŠ‚ç‚¹å¯¹ $master_port:$slave_port =========="
        
        # 1. å‡çº§ä»èŠ‚ç‚¹
        upgrade_node $slave_port false
        
        # 2. ä¸»ä»åˆ‡æ¢
        failover_node $master_port $slave_port
        
        # 3. å‡çº§åŸä¸»èŠ‚ç‚¹ï¼ˆç°åœ¨æ˜¯ä»èŠ‚ç‚¹ï¼‰
        upgrade_node $master_port false
        
        echo "âœ… èŠ‚ç‚¹å¯¹å‡çº§å®Œæˆ"
        sleep 30  # ç­‰å¾…é›†ç¾¤ç¨³å®š
    done
}

main() {
    echo "å¼€å§‹Redisé›†ç¾¤æ»šåŠ¨å‡çº§..."
    rolling_upgrade
    echo "ğŸ‰ é›†ç¾¤å‡çº§å®Œæˆï¼"
    
    # æœ€ç»ˆçŠ¶æ€æ£€æŸ¥
    redis-cli --cluster check 127.0.0.1:7000
}

main
```

---

## 4. ğŸš¨ æ•…éšœå¤„ç†ä¸é¢„é˜²


### 4.1 å¸¸è§æ•…éšœåœºæ™¯


**ğŸ’¥ å…¸å‹æ•…éšœç±»å‹**

| æ•…éšœç±»å‹ | **ç—‡çŠ¶è¡¨ç°** | **å¯èƒ½åŸå› ** | **å¤„ç†æ–¹æ³•** |
|---------|------------|-------------|-------------|
| **èŠ‚ç‚¹ç¦»çº¿** | `è¿æ¥è¶…æ—¶ï¼ŒCLUSTER DOWN` | `è¿›ç¨‹å´©æºƒï¼Œç½‘ç»œæ•…éšœ` | `é‡å¯èŠ‚ç‚¹ï¼Œæ•…éšœè½¬ç§»` |
| **ä¸»èŠ‚ç‚¹å®•æœº** | `ä»èŠ‚ç‚¹è‡ªåŠ¨æå‡ä¸ºä¸»` | `ç¡¬ä»¶æ•…éšœï¼Œå†…å­˜ä¸è¶³` | `ç¡®è®¤æ•…éšœè½¬ç§»ï¼Œä¿®å¤åŸä¸»èŠ‚ç‚¹` |
| **æ§½ä½ä¸¢å¤±** | `éƒ¨åˆ†keyæ— æ³•è®¿é—®` | `èŠ‚ç‚¹å¼‚å¸¸é€€å‡º` | `é‡æ–°åˆ†é…æ§½ä½` |
| **æ•°æ®å€¾æ–œ** | `æŸèŠ‚ç‚¹å†…å­˜ä½¿ç”¨è¿‡é«˜` | `çƒ­ç‚¹æ•°æ®ï¼Œæ§½ä½åˆ†å¸ƒä¸å‡` | `é‡æ–°åˆ†ç‰‡ï¼Œçƒ­ç‚¹æ•°æ®ä¼˜åŒ–` |
| **è„‘è£‚é—®é¢˜** | `é›†ç¾¤åˆ†æˆå¤šä¸ªåˆ†åŒº` | `ç½‘ç»œåˆ†åŒºæ•…éšœ` | `åœæ­¢å°‘æ•°æ´¾åˆ†åŒºï¼Œä¿®å¤ç½‘ç»œ` |

### 4.2 æ•…éšœè‡ªåŠ¨æ¢å¤æœºåˆ¶


**ğŸ”„ è‡ªåŠ¨æ•…éšœæ£€æµ‹ä¸å¤„ç†**

```python
#!/usr/bin/env python3
# auto_recovery.py

import redis
import time
import subprocess
import logging
from datetime import datetime

class ClusterAutoRecovery:
    
    def __init__(self):
        self.cluster = redis.Redis(host='127.0.0.1', port=7000, decode_responses=True)
        self.logger = self.setup_logger()
    
    def monitor_cluster(self):
        """æŒç»­ç›‘æ§é›†ç¾¤çŠ¶æ€"""
        while True:
            try:
                self.check_cluster_health()
                self.check_node_performance()
                time.sleep(30)  # 30ç§’æ£€æŸ¥ä¸€æ¬¡
                
            except Exception as e:
                self.logger.error(f"ç›‘æ§å¼‚å¸¸: {e}")
                time.sleep(60)
    
    def check_cluster_health(self):
        """æ£€æŸ¥é›†ç¾¤å¥åº·çŠ¶æ€"""
        try:
            # æ£€æŸ¥é›†ç¾¤ä¿¡æ¯
            cluster_info = self.cluster.execute_command('CLUSTER', 'INFO')
            
            if 'cluster_state:ok' in cluster_info:
                self.logger.info("âœ… é›†ç¾¤çŠ¶æ€æ­£å¸¸")
            else:
                self.logger.warning("âš ï¸ é›†ç¾¤çŠ¶æ€å¼‚å¸¸ï¼Œå¼€å§‹è‡ªåŠ¨æ¢å¤...")
                self.auto_fix_cluster()
                
        except redis.exceptions.ResponseError as e:
            if 'CLUSTERDOWN' in str(e):
                self.logger.error("âŒ é›†ç¾¤å®Œå…¨ä¸å¯ç”¨ï¼Œæ‰§è¡Œç´§æ€¥æ¢å¤")
                self.emergency_recovery()
    
    def auto_fix_cluster(self):
        """è‡ªåŠ¨ä¿®å¤é›†ç¾¤"""
        # æ£€æŸ¥æ§½ä½è¦†ç›–æƒ…å†µ
        result = subprocess.run(['redis-cli', '--cluster', 'check', '127.0.0.1:7000'], 
                               capture_output=True, text=True)
        
        if 'slots covered' not in result.stdout:
            self.logger.info("å‘ç°æ§½ä½æœªå®Œå…¨è¦†ç›–ï¼Œæ‰§è¡Œè‡ªåŠ¨ä¿®å¤...")
            # æ‰§è¡Œæ§½ä½ä¿®å¤
            subprocess.run(['redis-cli', '--cluster', 'fix', '127.0.0.1:7000', '--cluster-yes'])
    
    def emergency_recovery(self):
        """ç´§æ€¥æ¢å¤ç¨‹åº"""
        self.logger.info("æ‰§è¡Œé›†ç¾¤ç´§æ€¥æ¢å¤...")
        
        # 1. å°è¯•é‡å¯æ‰€æœ‰èŠ‚ç‚¹
        for port in range(7000, 7006):
            try:
                subprocess.run(['systemctl', 'restart', f'redis-{port}'])
                time.sleep(2)
            except Exception as e:
                self.logger.error(f"é‡å¯èŠ‚ç‚¹{port}å¤±è´¥: {e}")
        
        # 2. ç­‰å¾…èŠ‚ç‚¹å¯åŠ¨
        time.sleep(10)
        
        # 3. é‡æ–°æ£€æŸ¥é›†ç¾¤çŠ¶æ€
        self.check_cluster_health()
    
    def setup_logger(self):
        logging.basicConfig(
            level=logging.INFO,
            format='%(asctime)s - %(levelname)s - %(message)s',
            handlers=[
                logging.FileHandler('/var/log/redis-auto-recovery.log'),
                logging.StreamHandler()
            ]
        )
        return logging.getLogger('ClusterRecovery')

if __name__ == '__main__':
    recovery = ClusterAutoRecovery()
    recovery.monitor_cluster()
```

### 4.3 æ€§èƒ½é¢„è­¦ç³»ç»Ÿ


**âš ï¸ æ™ºèƒ½é¢„è­¦æœºåˆ¶**

```java
@Component
public class ClusterAlertSystem {
    
    // æ€§èƒ½åŸºçº¿æ•°æ®
    private Map<String, Double> performanceBaseline = new HashMap<>();
    
    @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    public void performanceCheck() {
        for (String node : getClusterNodes()) {
            Map<String, Object> metrics = collectNodeMetrics(node);
            analyzeAndAlert(node, metrics);
        }
    }
    
    private void analyzeAndAlert(String node, Map<String, Object> metrics) {
        double cpuUsage = (Double) metrics.get("cpu_usage");
        double memoryUsage = (Double) metrics.get("memory_usage");
        long commandsPerSec = (Long) metrics.get("commands_per_sec");
        
        // CPUé¢„è­¦
        if (cpuUsage > 80.0) {
            sendAlert("high_cpu", 
                     String.format("èŠ‚ç‚¹%s CPUä½¿ç”¨ç‡è¿‡é«˜: %.1f%%", node, cpuUsage));
        }
        
        // å†…å­˜é¢„è­¦
        if (memoryUsage > 85.0) {
            sendAlert("high_memory",
                     String.format("èŠ‚ç‚¹%s å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: %.1f%%", node, memoryUsage));
        }
        
        // æ€§èƒ½ä¸‹é™é¢„è­¦
        Double baseline = performanceBaseline.get(node);
        if (baseline != null && commandsPerSec < baseline * 0.5) {
            sendAlert("performance_drop",
                     String.format("èŠ‚ç‚¹%s æ€§èƒ½ä¸‹é™è¶…è¿‡50%%", node));
        }
        
        // æ›´æ–°åŸºçº¿æ•°æ®
        performanceBaseline.put(node, (double) commandsPerSec);
    }
    
    private void sendAlert(String alertType, String message) {
        // å‘é€å‘Šè­¦åˆ°ç›‘æ§ç³»ç»Ÿ
        alertService.send(AlertLevel.WARNING, alertType, message);
        
        // è®°å½•å‘Šè­¦æ—¥å¿—
        log.warn("Redisé›†ç¾¤å‘Šè­¦: {}", message);
    }
}
```

### 4.4 å®¹é‡è§„åˆ’ä¸æ‰©ç¼©å®¹


**ğŸ“ˆ é›†ç¾¤æ‰©å®¹ç­–ç•¥**

```bash
#!/bin/bash
# cluster_scale_out.sh

NEW_MASTER_PORT=7006
NEW_SLAVE_PORT=7007

# æ·»åŠ æ–°çš„ä¸»ä»èŠ‚ç‚¹å¯¹
add_nodes() {
    echo "æ·»åŠ æ–°çš„ä¸»ä»èŠ‚ç‚¹..."
    
    # 1. å¯åŠ¨æ–°èŠ‚ç‚¹
    start_new_node $NEW_MASTER_PORT "master"
    start_new_node $NEW_SLAVE_PORT "slave"
    
    # 2. åŠ å…¥é›†ç¾¤
    redis-cli --cluster add-node 127.0.0.1:$NEW_MASTER_PORT 127.0.0.1:7000
    redis-cli --cluster add-node 127.0.0.1:$NEW_SLAVE_PORT 127.0.0.1:7000 \
              --cluster-slave --cluster-master-id $(get_master_id $NEW_MASTER_PORT)
    
    # 3. é‡æ–°åˆ†ç‰‡
    echo "å¼€å§‹é‡æ–°åˆ†ç‰‡..."
    redis-cli --cluster reshard 127.0.0.1:7000 \
              --cluster-from all \
              --cluster-to $(get_master_id $NEW_MASTER_PORT) \
              --cluster-slots 1365 \  # 16384/12â‰ˆ1365ï¼Œå¹³å‡åˆ†é…
              --cluster-yes
    
    echo "âœ… é›†ç¾¤æ‰©å®¹å®Œæˆ"
}

start_new_node() {
    local port=$1
    local role=$2
    
    # åˆ›å»ºèŠ‚ç‚¹ç›®å½•
    mkdir -p "/data/redis-cluster/$port"/{conf,data,logs}
    
    # ç”Ÿæˆé…ç½®æ–‡ä»¶
    generate_node_config $port
    
    # å¯åŠ¨èŠ‚ç‚¹
    redis-server "/data/redis-cluster/$port/conf/redis.conf" &
    
    echo "âœ… æ–°$roleèŠ‚ç‚¹ $port å¯åŠ¨å®Œæˆ"
}

# è·å–èŠ‚ç‚¹ID
get_master_id() {
    local port=$1
    redis-cli -p $port cluster myid
}

main() {
    echo "å¼€å§‹Redisé›†ç¾¤æ‰©å®¹..."
    add_nodes
    
    # éªŒè¯æ‰©å®¹ç»“æœ
    redis-cli --cluster check 127.0.0.1:7000
}

main
```

---

## 5. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 5.1 å¿…é¡»æŒæ¡çš„è¿ç»´æ¦‚å¿µ


```
ğŸ”¸ é›†ç¾¤ç›‘æ§ï¼šå¥åº·çŠ¶æ€ã€æ€§èƒ½æŒ‡æ ‡ã€æ•°æ®åˆ†å¸ƒçš„å®æ—¶ç›‘æ§
ğŸ”¸ æ€§èƒ½ä¼˜åŒ–ï¼šçƒ­ç‚¹å¤„ç†ã€è·¨æ§½ä¼˜åŒ–ã€ç½‘ç»œè°ƒä¼˜çš„ç»¼åˆç­–ç•¥
ğŸ”¸ è¿ç»´è‡ªåŠ¨åŒ–ï¼šå·¡æ£€ã€éƒ¨ç½²ã€å¤‡ä»½ã€å‡çº§çš„è„šæœ¬åŒ–ç®¡ç†
ğŸ”¸ æ•…éšœå¤„ç†ï¼šé¢„é˜²ã€æ£€æµ‹ã€æ¢å¤çš„å®Œæ•´æµç¨‹
ğŸ”¸ å®¹é‡è§„åˆ’ï¼šæ‰©ç¼©å®¹ã€èµ„æºè¯„ä¼°ã€æ€§èƒ½é¢„æµ‹
```

### 5.2 å…³é”®è¿ç»´åŸåˆ™


**ğŸ”¹ é¢„é˜²å¤§äºæ²»ç–—**
```
ç›‘æ§ç­–ç•¥ï¼š
- è®¾ç½®åˆç†çš„å‘Šè­¦é˜ˆå€¼
- å»ºç«‹æ€§èƒ½åŸºçº¿æ•°æ®
- å®æ–½ä¸»åŠ¨å·¡æ£€æœºåˆ¶
- å®šæœŸè¿›è¡Œæ•…éšœæ¼”ç»ƒ
```

**ğŸ”¹ è‡ªåŠ¨åŒ–æ˜¯ç‹é“**
```
è‡ªåŠ¨åŒ–æ”¶ç›Šï¼š
- å‡å°‘äººä¸ºæ“ä½œé”™è¯¯
- æé«˜å“åº”é€Ÿåº¦
- é™ä½è¿ç»´æˆæœ¬
- ä¿è¯æ“ä½œæ ‡å‡†åŒ–
```

**ğŸ”¹ æ•°æ®å®‰å…¨ç¬¬ä¸€**
```
å®‰å…¨åŸåˆ™ï¼š
- å¤‡ä»½ç­–ç•¥è¦å¯é 
- å‡çº§è¦æœ‰å›æ»šæ–¹æ¡ˆ
- é‡è¦æ“ä½œè¦æœ‰ç¡®è®¤æœºåˆ¶
- æ•°æ®è¿ç§»è¦éªŒè¯å®Œæ•´æ€§
```

### 5.3 è¿ç»´æˆç†Ÿåº¦è¯„ä¼°


**ğŸ“Š è¿ç»´èƒ½åŠ›ç­‰çº§**

| ç­‰çº§ | **ç‰¹å¾** | **èƒ½åŠ›æè¿°** |
|------|---------|-------------|
| **L1åŸºç¡€** | `æ‰‹åŠ¨è¿ç»´` | `åŸºæœ¬çš„å¯åœæ“ä½œï¼Œç®€å•ç›‘æ§` |
| **L2æ ‡å‡†** | `è„šæœ¬åŒ–è¿ç»´` | `è‡ªåŠ¨åŒ–å·¡æ£€ï¼Œæ ‡å‡†åŒ–éƒ¨ç½²` |  
| **L3é«˜çº§** | `æ™ºèƒ½è¿ç»´` | `è‡ªåŠ¨æ•…éšœæ¢å¤ï¼Œæ€§èƒ½é¢„æµ‹` |
| **L4ä¸“å®¶** | `è‡ªé€‚åº”è¿ç»´` | `AIè¾…åŠ©å†³ç­–ï¼Œå…¨è‡ªåŠ¨è¿ç»´` |

**ğŸ¯ æå‡è¿ç»´æ°´å¹³çš„è·¯å¾„**
```
æ­¥éª¤1: å»ºç«‹ç›‘æ§ä½“ç³»
- æ­å»ºç›‘æ§å¹³å°
- åˆ¶å®šå‘Šè­¦è§„åˆ™
- å»ºç«‹è¿ç»´æµç¨‹

æ­¥éª¤2: å®ç°è‡ªåŠ¨åŒ–
- ç¼–å†™è¿ç»´è„šæœ¬  
- è‡ªåŠ¨åŒ–éƒ¨ç½²
- è‡ªåŠ¨æ•…éšœå¤„ç†

æ­¥éª¤3: æ™ºèƒ½åŒ–è¿ç»´
- æ€§èƒ½è¶‹åŠ¿åˆ†æ
- å®¹é‡è‡ªåŠ¨è§„åˆ’
- æ™ºèƒ½æ•…éšœé¢„æµ‹
```

### 5.4 å®è·µå»ºè®®ä¸ç»éªŒ


**âœ… è¿ç»´æœ€ä½³å®è·µ**
- å»ºç«‹å®Œæ•´çš„ç›‘æ§å‘Šè­¦ä½“ç³»
- åˆ¶å®šè¯¦ç»†çš„åº”æ€¥é¢„æ¡ˆ
- å®šæœŸè¿›è¡Œæ•…éšœæ¼”ç»ƒ
- ä¿æŒé›†ç¾¤é…ç½®çš„æ ‡å‡†åŒ–
- å»ºç«‹å˜æ›´ç®¡ç†æµç¨‹

**âš ï¸ å¸¸è§è¿ç»´é™·é˜±**
- å¿½è§†æ€§èƒ½åŸºçº¿å»ºç«‹
- ç¼ºä¹è‡ªåŠ¨åŒ–æ•…éšœæ¢å¤
- å¤‡ä»½ç­–ç•¥ä¸å®Œæ•´
- å‡çº§ç¼ºä¹å›æ»šæ–¹æ¡ˆ
- ç›‘æ§å‘Šè­¦ä¸åŠæ—¶

**ğŸ”§ å·¥å…·æ¨è**
- **ç›‘æ§**ï¼šPrometheus + Grafana + Redis Exporter
- **éƒ¨ç½²**ï¼šAnsible + Docker
- **å¤‡ä»½**ï¼šè‡ªç ”è„šæœ¬ + å¯¹è±¡å­˜å‚¨
- **å‘Šè­¦**ï¼šé’‰é’‰ã€å¾®ä¿¡ã€é‚®ä»¶å¤šæ¸ é“
- **æ—¥å¿—**ï¼šELK Stacké›†ä¸­æ—¥å¿—åˆ†æ

**æ ¸å¿ƒè®°å¿†**ï¼š
- Redisé›†ç¾¤è¿ç»´è¦ä»¥ç›‘æ§ä¸ºåŸºç¡€ï¼Œè‡ªåŠ¨åŒ–ä¸ºæ‰‹æ®µ
- é¢„é˜²æ•…éšœæ¯”å¤„ç†æ•…éšœæ›´é‡è¦
- æ€§èƒ½ä¼˜åŒ–è¦åŸºäºæ•°æ®åˆ†æï¼Œä¸èƒ½ç›²ç›®è°ƒä¼˜  
- è¿ç»´å·¥å…·è¦é€æ­¥å®Œå–„ï¼Œå½¢æˆé—­ç¯ç®¡ç†ä½“ç³»