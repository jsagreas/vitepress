---
title: 4ã€å¹¶è¡Œæž„å»ºä¸ŽMatrix
---
## ðŸ“š ç›®å½•

1. [å¹¶è¡Œæž„å»ºåŸºç¡€æ¦‚å¿µ](#1-å¹¶è¡Œæž„å»ºåŸºç¡€æ¦‚å¿µ)
2. [parallelå¹¶è¡Œé…ç½®è¯¦è§£](#2-parallelå¹¶è¡Œé…ç½®è¯¦è§£)
3. [MatrixçŸ©é˜µæž„å»ºæ·±å…¥ç†è§£](#3-MatrixçŸ©é˜µæž„å»ºæ·±å…¥ç†è§£)
4. [å¤šç‰ˆæœ¬æµ‹è¯•å®žæˆ˜åº”ç”¨](#4-å¤šç‰ˆæœ¬æµ‹è¯•å®žæˆ˜åº”ç”¨)
5. [å¤šçŽ¯å¢ƒæž„å»ºç­–ç•¥](#5-å¤šçŽ¯å¢ƒæž„å»ºç­–ç•¥)
6. [åŠ¨æ€é…ç½®ç”ŸæˆæŠ€å·§](#6-åŠ¨æ€é…ç½®ç”ŸæˆæŠ€å·§)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ðŸš€ å¹¶è¡Œæž„å»ºåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯å¹¶è¡Œæž„å»º


**é€šä¿—ç†è§£**ï¼š
æƒ³è±¡ä½ è¦æ´—å¾ˆå¤šè¡£æœï¼Œä¼ ç»Ÿåšæ³•æ˜¯ä¸€ä»¶ä¸€ä»¶æ´—ï¼Œå¾ˆæ…¢ã€‚å¹¶è¡Œæž„å»ºå°±åƒåŒæ—¶å¼€å¯å¤šå°æ´—è¡£æœºï¼Œå¤§å®¶ä¸€èµ·æ´—ï¼Œæ•ˆçŽ‡å¤§å¤§æå‡ï¼

> ðŸ’¡ **æ ¸å¿ƒæ¦‚å¿µ**ï¼šå¹¶è¡Œæž„å»ºæ˜¯æŒ‡åŒæ—¶è¿è¡Œå¤šä¸ªæž„å»ºä»»åŠ¡ï¼Œè€Œä¸æ˜¯æŒ‰é¡ºåºä¸€ä¸ªæŽ¥ä¸€ä¸ªæ‰§è¡Œ

**ä¸ºä»€ä¹ˆéœ€è¦å¹¶è¡Œæž„å»ºï¼Ÿ**
- â±ï¸ **èŠ‚çœæ—¶é—´**ï¼šåŽŸæœ¬20åˆ†é’Ÿçš„ä»»åŠ¡å¯èƒ½5åˆ†é’Ÿå°±å®Œæˆ
- ðŸ”„ **æé«˜æ•ˆçŽ‡**ï¼šå……åˆ†åˆ©ç”¨æœåŠ¡å™¨èµ„æº
- ðŸŽ¯ **å¿«é€Ÿåé¦ˆ**ï¼šå¼€å‘è€…èƒ½æ›´å¿«çœ‹åˆ°æµ‹è¯•ç»“æžœ

### 1.2 GitLab CI/CDä¸­çš„å¹¶è¡Œæœºåˆ¶


```
ä¼ ç»Ÿä¸²è¡Œæ‰§è¡Œï¼š
ä»»åŠ¡A â†’ ä»»åŠ¡B â†’ ä»»åŠ¡C â†’ ä»»åŠ¡D  (æ€»æ—¶é—´: 20åˆ†é’Ÿ)

å¹¶è¡Œæ‰§è¡Œï¼š
ä»»åŠ¡A â”
ä»»åŠ¡B â”œâ”€â”€ åŒæ—¶æ‰§è¡Œ  (æ€»æ—¶é—´: 5åˆ†é’Ÿ)
ä»»åŠ¡C â”¤
ä»»åŠ¡D â”˜
```

**GitLabæ”¯æŒçš„å¹¶è¡Œæ–¹å¼**ï¼š
- ðŸ”¸ **Stageçº§å¹¶è¡Œ**ï¼šåŒä¸€é˜¶æ®µå†…çš„å¤šä¸ªJobåŒæ—¶è¿è¡Œ
- ðŸ”¸ **Parallelé…ç½®**ï¼šå•ä¸ªJobåˆ†æˆå¤šä»½å¹¶è¡Œæ‰§è¡Œ
- ðŸ”¸ **Matrixæž„å»º**ï¼šå¤šä¸ªå‚æ•°ç»„åˆåŒæ—¶æµ‹è¯•

### 1.3 å¹¶è¡Œæž„å»ºçš„æ³¨æ„äº‹é¡¹


> âš ï¸ **é‡è¦æé†’**ï¼šå¹¶è¡Œä¸æ˜¯ä¸‡èƒ½çš„ï¼Œéœ€è¦è€ƒè™‘ä»¥ä¸‹å› ç´ 

| å› ç´  | è¯´æ˜Ž | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| **èµ„æºé™åˆ¶** | Runneræ•°é‡æœ‰é™ | åˆç†è§„åˆ’å¹¶è¡Œåº¦ |
| **ä¾èµ–å…³ç³»** | æœ‰äº›ä»»åŠ¡å¿…é¡»æŒ‰é¡ºåºæ‰§è¡Œ | æ­£ç¡®è®¾ç½®needså…³ç³» |
| **å…±äº«èµ„æº** | æ•°æ®åº“ã€æ–‡ä»¶å†²çª | éš”ç¦»æµ‹è¯•çŽ¯å¢ƒ |

---

## 2. âš¡ parallelå¹¶è¡Œé…ç½®è¯¦è§£


### 2.1 parallelåŸºç¡€è¯­æ³•


**æœ€ç®€å•çš„parallelé…ç½®**ï¼š

```yaml
test_job:
  stage: test
  parallel: 3  # ðŸ”¢ è¿™ä¸ªJobä¼šè¢«åˆ†æˆ3ä¸ªå¹¶è¡Œæ‰§è¡Œ
  script:
    - echo "æˆ‘æ˜¯ç¬¬ $CI_NODE_INDEX ä¸ªå¹¶è¡Œä»»åŠ¡"
    - echo "æ€»å…±æœ‰ $CI_NODE_TOTAL ä¸ªå¹¶è¡Œä»»åŠ¡"
```

**è¿è¡Œæ•ˆæžœ**ï¼š
```
Jobåç§°               çŠ¶æ€        æ‰§è¡Œå†…å®¹
test_job 1/3         âœ… æˆåŠŸ      æˆ‘æ˜¯ç¬¬ 1 ä¸ªå¹¶è¡Œä»»åŠ¡ï¼Œæ€»å…±æœ‰ 3 ä¸ª
test_job 2/3         âœ… æˆåŠŸ      æˆ‘æ˜¯ç¬¬ 2 ä¸ªå¹¶è¡Œä»»åŠ¡ï¼Œæ€»å…±æœ‰ 3 ä¸ª  
test_job 3/3         âœ… æˆåŠŸ      æˆ‘æ˜¯ç¬¬ 3 ä¸ªå¹¶è¡Œä»»åŠ¡ï¼Œæ€»å…±æœ‰ 3 ä¸ª
```

### 2.2 å†…ç½®çŽ¯å¢ƒå˜é‡è¯¦è§£


> ðŸ“ **é‡è¦æ¦‚å¿µ**ï¼šparallelè¿è¡Œæ—¶ï¼ŒGitLabä¼šè‡ªåŠ¨è®¾ç½®è¿™äº›å˜é‡

| å˜é‡å | å«ä¹‰ | å€¼èŒƒå›´ | ç”¨é€”ç¤ºä¾‹ |
|--------|------|--------|----------|
| `$CI_NODE_INDEX` | å½“å‰å¹¶è¡Œä»»åŠ¡çš„ç¼–å· | 1 åˆ° total | åˆ†é…ä¸åŒæµ‹è¯•æ–‡ä»¶ |
| `$CI_NODE_TOTAL` | å¹¶è¡Œä»»åŠ¡æ€»æ•° | ç”¨æˆ·è®¾ç½®çš„æ•°å€¼ | è®¡ç®—å·¥ä½œåˆ†é… |

**å®žé™…åº”ç”¨ç¤ºä¾‹**ï¼š

```yaml
run_tests:
  stage: test
  parallel: 4
  script:
    # ðŸŽ¯ æ ¹æ®ç¼–å·åˆ†é…ä¸åŒçš„æµ‹è¯•æ–‡ä»¶
    - |
      case $CI_NODE_INDEX in
        1) npm test -- tests/unit/ ;;
        2) npm test -- tests/integration/ ;;
        3) npm test -- tests/e2e/ ;;
        4) npm test -- tests/performance/ ;;
      esac
```

### 2.3 æ™ºèƒ½ä»»åŠ¡åˆ†é…


**æŒ‰æ–‡ä»¶æ•°é‡å¹³å‡åˆ†é…**ï¼š

```yaml
test_parallel:
  stage: test
  parallel: 3
  script:
    # ðŸ“Š èŽ·å–æ‰€æœ‰æµ‹è¯•æ–‡ä»¶
    - TEST_FILES=$(find tests/ -name "*.test.js")
    # ðŸ”¢ è®¡ç®—æ¯ä¸ªä»»åŠ¡åº”è¯¥å¤„ç†çš„æ–‡ä»¶æ•°
    - TOTAL_FILES=$(echo $TEST_FILES | wc -w)
    - FILES_PER_JOB=$((TOTAL_FILES / CI_NODE_TOTAL + 1))
    # ðŸ“‚ åˆ†é…æ–‡ä»¶ç»™å½“å‰ä»»åŠ¡
    - START_INDEX=$(((CI_NODE_INDEX - 1) * FILES_PER_JOB + 1))
    - END_INDEX=$((CI_NODE_INDEX * FILES_PER_JOB))
    - MY_FILES=$(echo $TEST_FILES | cut -d' ' -f${START_INDEX}-${END_INDEX})
    # ðŸš€ åªè¿è¡Œåˆ†é…ç»™æˆ‘çš„æµ‹è¯•
    - npm test $MY_FILES
```

---

## 3. ðŸŽ¯ MatrixçŸ©é˜µæž„å»ºæ·±å…¥ç†è§£


### 3.1 Matrixæž„å»ºæ˜¯ä»€ä¹ˆ


**ç”Ÿæ´»åŒ–ç†è§£**ï¼š
Matrixå°±åƒä¸€ä¸ª"æŽ’åˆ—ç»„åˆ"çš„æ¦‚å¿µã€‚æ¯”å¦‚ä½ è¦æµ‹è¯•ä¸€ä¸ªAppï¼š
- åœ¨ **3ç§æ‰‹æœº**ï¼ˆiPhoneã€åŽä¸ºã€å°ç±³ï¼‰ä¸Š
- è¿è¡Œ **2ä¸ªç‰ˆæœ¬**ï¼ˆå…è´¹ç‰ˆã€ä¸“ä¸šç‰ˆï¼‰  
- æ€»å…±éœ€è¦æµ‹è¯• **3Ã—2=6ç§ç»„åˆ**

> ðŸ’¡ **Matrixæž„å»º**ï¼šè‡ªåŠ¨ç”Ÿæˆå¤šç§å‚æ•°ç»„åˆï¼Œæ¯ç§ç»„åˆéƒ½ä¼šåˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„Job

### 3.2 MatrixåŸºç¡€è¯­æ³•


**ç®€å•çš„Matrixç¤ºä¾‹**ï¼š

```yaml
test_matrix:
  stage: test
  parallel:
    matrix:
      - VERSION: ["1.0", "2.0", "3.0"]
        OS: ["ubuntu", "centos"]
  script:
    - echo "æµ‹è¯•ç‰ˆæœ¬ $VERSION åœ¨ $OS ç³»ç»Ÿä¸Š"
    - ./run_tests.sh $VERSION $OS
```

**è‡ªåŠ¨ç”Ÿæˆçš„Job**ï¼š
```
ðŸ“‹ GitLabä¼šè‡ªåŠ¨åˆ›å»º 6 ä¸ªJobï¼š

Job 1: VERSION=1.0, OS=ubuntu    â†’ æµ‹è¯•ç‰ˆæœ¬ 1.0 åœ¨ ubuntu ç³»ç»Ÿä¸Š
Job 2: VERSION=1.0, OS=centos    â†’ æµ‹è¯•ç‰ˆæœ¬ 1.0 åœ¨ centos ç³»ç»Ÿä¸Š  
Job 3: VERSION=2.0, OS=ubuntu    â†’ æµ‹è¯•ç‰ˆæœ¬ 2.0 åœ¨ ubuntu ç³»ç»Ÿä¸Š
Job 4: VERSION=2.0, OS=centos    â†’ æµ‹è¯•ç‰ˆæœ¬ 2.0 åœ¨ centos ç³»ç»Ÿä¸Š
Job 5: VERSION=3.0, OS=ubuntu    â†’ æµ‹è¯•ç‰ˆæœ¬ 3.0 åœ¨ ubuntu ç³»ç»Ÿä¸Š
Job 6: VERSION=3.0, OS=centos    â†’ æµ‹è¯•ç‰ˆæœ¬ 3.0 åœ¨ centos ç³»ç»Ÿä¸Š
```

### 3.3 å¤æ‚Matrixé…ç½®


**å¤šç»´åº¦æµ‹è¯•çŸ©é˜µ**ï¼š

```yaml
comprehensive_test:
  stage: test
  parallel:
    matrix:
      - LANGUAGE: ["java", "python", "nodejs"]
        VERSION: ["8", "11", "17"]
        ENVIRONMENT: ["dev", "staging"]
  variables:
    # ðŸ”§ æ ¹æ®matrixå‚æ•°è®¾ç½®ä¸åŒçš„é•œåƒ
    DOCKER_IMAGE: "${LANGUAGE}:${VERSION}"
  image: $DOCKER_IMAGE
  script:
    - echo "ðŸš€ æµ‹è¯• $LANGUAGE $VERSION åœ¨ $ENVIRONMENT çŽ¯å¢ƒ"
    # ðŸ“ æ ¹æ®è¯­è¨€é€‰æ‹©ä¸åŒçš„æµ‹è¯•å‘½ä»¤
    - |
      case $LANGUAGE in
        java)
          mvn test -Denv=$ENVIRONMENT ;;
        python)
          pytest --env=$ENVIRONMENT ;;
        nodejs)
          npm test -- --env=$ENVIRONMENT ;;
      esac
```

> ðŸ“Š **ç»“æžœ**ï¼šè¿™ä¼šåˆ›å»º 3Ã—3Ã—2 = **18ä¸ªå¹¶è¡ŒJob**

### 3.4 Matrixå˜é‡çš„é«˜çº§ç”¨æ³•


**æ¡ä»¶æ€§Matrixé…ç½®**ï¼š

```yaml
browser_test:
  stage: test
  parallel:
    matrix:
      - BROWSER: "chrome"
        BROWSER_VERSION: ["90", "91", "92"]
      - BROWSER: "firefox"  
        BROWSER_VERSION: ["88", "89"]
      - BROWSER: "safari"
        BROWSER_VERSION: ["14"]
  script:
    - echo "ðŸŒ åœ¨ $BROWSER $BROWSER_VERSION ä¸Šæµ‹è¯•"
    # ðŸŽ­ æ ¹æ®æµè§ˆå™¨ç±»åž‹ä½¿ç”¨ä¸åŒçš„æµ‹è¯•å·¥å…·
    - |
      if [ "$BROWSER" = "safari" ]; then
        # Safariéœ€è¦ç‰¹æ®Šå¤„ç†
        ./safari_test.sh $BROWSER_VERSION
      else
        # Chromeå’ŒFirefoxä½¿ç”¨é€šç”¨å·¥å…·
        ./selenium_test.sh $BROWSER $BROWSER_VERSION
      fi
```

---

## 4. ðŸ”¬ å¤šç‰ˆæœ¬æµ‹è¯•å®žæˆ˜åº”ç”¨


### 4.1 ç¼–ç¨‹è¯­è¨€ç‰ˆæœ¬å…¼å®¹æ€§æµ‹è¯•


**Node.jså¤šç‰ˆæœ¬æµ‹è¯•**ï¼š

```yaml
# ðŸŽ¯ ç›®æ ‡ï¼šç¡®ä¿ä»£ç åœ¨ä¸åŒNode.jsç‰ˆæœ¬ä¸‹éƒ½èƒ½æ­£å¸¸å·¥ä½œ
node_compatibility:
  stage: test
  parallel:
    matrix:
      - NODE_VERSION: ["14", "16", "18", "20"]
  image: node:$NODE_VERSION
  before_script:
    - echo "ðŸ“¦ å½“å‰Node.jsç‰ˆæœ¬: $(node --version)"
    - npm ci  # å®‰è£…ä¾èµ–
  script:
    # âœ… è¿è¡Œæµ‹è¯•å¥—ä»¶
    - npm run test
    # ðŸ” æ£€æŸ¥è¯­æ³•å…¼å®¹æ€§
    - npm run lint
    # ðŸ“Š ç”Ÿæˆè¦†ç›–çŽ‡æŠ¥å‘Š
    - npm run coverage
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 1 week
```

### 4.2 æ•°æ®åº“ç‰ˆæœ¬å…¼å®¹æ€§æµ‹è¯•


**å¤šæ•°æ®åº“ç‰ˆæœ¬æµ‹è¯•**ï¼š

```yaml
database_test:
  stage: test
  parallel:
    matrix:
      - DB_TYPE: "mysql"
        DB_VERSION: ["5.7", "8.0"]
      - DB_TYPE: "postgresql"  
        DB_VERSION: ["12", "13", "14"]
  services:
    # ðŸ—„ï¸ åŠ¨æ€å¯åŠ¨å¯¹åº”ç‰ˆæœ¬çš„æ•°æ®åº“
    - name: $DB_TYPE:$DB_VERSION
      alias: database
  variables:
    # ðŸ”— æ ¹æ®æ•°æ®åº“ç±»åž‹è®¾ç½®è¿žæŽ¥å­—ç¬¦ä¸²
    DATABASE_URL: "$DB_TYPE://user:password@database:5432/testdb"
  script:
    - echo "ðŸ—„ï¸ æµ‹è¯•æ•°æ®åº“: $DB_TYPE $DB_VERSION"
    # ðŸ“‹ è¿è¡Œæ•°æ®åº“è¿ç§»
    - python manage.py migrate
    # ðŸ§ª è¿è¡Œæ•°æ®åº“ç›¸å…³æµ‹è¯•
    - python -m pytest tests/database/
  after_script:
    # ðŸ§¹ æ¸…ç†æµ‹è¯•æ•°æ®
    - python manage.py flush --noinput
```

### 4.3 æ“ä½œç³»ç»Ÿå…¼å®¹æ€§æµ‹è¯•


**è·¨å¹³å°å…¼å®¹æ€§éªŒè¯**ï¼š

```yaml
cross_platform_test:
  stage: test
  parallel:
    matrix:
      - OS_IMAGE: "ubuntu:20.04"
        PACKAGE_MANAGER: "apt"
      - OS_IMAGE: "ubuntu:22.04"
        PACKAGE_MANAGER: "apt"  
      - OS_IMAGE: "centos:7"
        PACKAGE_MANAGER: "yum"
      - OS_IMAGE: "alpine:latest"
        PACKAGE_MANAGER: "apk"
  image: $OS_IMAGE
  before_script:
    # ðŸ› ï¸ æ ¹æ®ç³»ç»Ÿå®‰è£…ä¾èµ–
    - |
      case $PACKAGE_MANAGER in
        apt)
          apt-get update && apt-get install -y python3 python3-pip ;;
        yum)
          yum install -y python3 python3-pip ;;
        apk)
          apk add --no-cache python3 py3-pip ;;
      esac
  script:
    - echo "ðŸ–¥ï¸ æµ‹è¯•ç³»ç»Ÿ: $OS_IMAGE"
    # ðŸ”§ å®‰è£…åº”ç”¨ä¾èµ–
    - pip3 install -r requirements.txt
    # âœ… è¿è¡Œç³»ç»Ÿå…¼å®¹æ€§æµ‹è¯•
    - python3 -m pytest tests/system/
```

---

## 5. ðŸŒ å¤šçŽ¯å¢ƒæž„å»ºç­–ç•¥


### 5.1 çŽ¯å¢ƒéš”ç¦»çš„é‡è¦æ€§


> âš ï¸ **ä¸ºä»€ä¹ˆéœ€è¦å¤šçŽ¯å¢ƒæµ‹è¯•ï¼Ÿ**
> å°±åƒæ±½è½¦è¦åœ¨ä¸åŒè·¯å†µä¸‹æµ‹è¯•ä¸€æ ·ï¼Œè½¯ä»¶ä¹Ÿè¦åœ¨ä¸åŒçŽ¯å¢ƒä¸‹éªŒè¯

**å¸¸è§çŽ¯å¢ƒç±»åž‹**ï¼š
- ðŸ”§ **å¼€å‘çŽ¯å¢ƒ**(dev)ï¼šå¼€å‘äººå‘˜æ—¥å¸¸ä½¿ç”¨
- ðŸ§ª **æµ‹è¯•çŽ¯å¢ƒ**(test)ï¼šQAå›¢é˜Ÿä¸“ç”¨æµ‹è¯•
- ðŸŽ­ **é¢„å‘çŽ¯å¢ƒ**(staging)ï¼šç”Ÿäº§çŽ¯å¢ƒçš„é•œåƒ
- ðŸš€ **ç”Ÿäº§çŽ¯å¢ƒ**(prod)ï¼šçœŸå®žç”¨æˆ·ä½¿ç”¨

### 5.2 å¤šçŽ¯å¢ƒMatrixé…ç½®


**çŽ¯å¢ƒçŸ©é˜µæµ‹è¯•**ï¼š

```yaml
deploy_test:
  stage: deploy
  parallel:
    matrix:
      - ENVIRONMENT: ["dev", "staging", "prod"]
        REGION: ["us-east-1", "eu-west-1", "ap-southeast-1"]
  variables:
    # ðŸ—ï¸ æ ¹æ®çŽ¯å¢ƒè®¾ç½®ä¸åŒçš„é…ç½®
    CONFIG_FILE: "config/${ENVIRONMENT}.yml"
    AWS_REGION: $REGION
  script:
    - echo "ðŸŒ éƒ¨ç½²åˆ° $ENVIRONMENT çŽ¯å¢ƒï¼ŒåŒºåŸŸ: $REGION"
    # ðŸ“‹ åŠ è½½çŽ¯å¢ƒç‰¹å®šé…ç½®
    - cp $CONFIG_FILE app_config.yml
    # ðŸ” è®¾ç½®çŽ¯å¢ƒç‰¹å®šçš„å¯†é’¥
    - aws configure set region $AWS_REGION
    # ðŸš€ æ‰§è¡Œéƒ¨ç½²
    - ./deploy.sh $ENVIRONMENT $REGION
  environment:
    name: $ENVIRONMENT-$REGION
    url: https://$ENVIRONMENT-$REGION.myapp.com
  only:
    # ðŸ”’ åªæœ‰ç‰¹å®šåˆ†æ”¯æ‰èƒ½éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ
    - if: '$ENVIRONMENT == "prod" && $CI_COMMIT_REF_NAME == "main"'
    - if: '$ENVIRONMENT != "prod"'
```

### 5.3 çŽ¯å¢ƒç‰¹å®šé…ç½®ç®¡ç†


**é…ç½®æ–‡ä»¶æ¨¡æ¿åŒ–**ï¼š

```yaml
config_validation:
  stage: test
  parallel:
    matrix:
      - ENV: ["development", "staging", "production"]
  script:
    - echo "ðŸ” éªŒè¯ $ENV çŽ¯å¢ƒé…ç½®"
    # ðŸ“ æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    - test -f "config/$ENV.yml" || (echo "âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨" && exit 1)
    # âœ… éªŒè¯é…ç½®æ ¼å¼
    - python -c "import yaml; yaml.safe_load(open('config/$ENV.yml'))"
    # ðŸ” æ£€æŸ¥å¿…éœ€çš„çŽ¯å¢ƒå˜é‡
    - |
      required_vars="DATABASE_URL REDIS_URL SECRET_KEY"
      for var in $required_vars; do
        if ! grep -q "$var:" "config/$ENV.yml"; then
          echo "âŒ ç¼ºå°‘å¿…éœ€é…ç½®: $var"
          exit 1
        fi
      done
    - echo "âœ… $ENV çŽ¯å¢ƒé…ç½®éªŒè¯é€šè¿‡"
```

---

## 6. ðŸ› ï¸ åŠ¨æ€é…ç½®ç”ŸæˆæŠ€å·§


### 6.1 ä»€ä¹ˆæ˜¯åŠ¨æ€é…ç½®


**é€šä¿—è§£é‡Š**ï¼š
åŠ¨æ€é…ç½®å°±åƒ"é‡èº«å®šåˆ¶"ã€‚ä¸æ˜¯äº‹å…ˆå†™æ­»æ‰€æœ‰å¯èƒ½çš„ç»„åˆï¼Œè€Œæ˜¯æ ¹æ®å®žé™…æƒ…å†µè‡ªåŠ¨ç”Ÿæˆéœ€è¦çš„é…ç½®ã€‚

> ðŸ’¡ **åº”ç”¨åœºæ™¯**ï¼šå½“Matrixç»„åˆå¤ªå¤šæ—¶ï¼Œä½¿ç”¨è„šæœ¬åŠ¨æ€ç”Ÿæˆæ›´çµæ´»

### 6.2 åŸºäºŽæ¡ä»¶çš„åŠ¨æ€Matrix


**åŠ¨æ€ç”Ÿæˆæµ‹è¯•ç»„åˆ**ï¼š

```yaml
# ðŸŽ¯ è¿™ä¸ªJobè´Ÿè´£ç”ŸæˆåŠ¨æ€é…ç½®
generate_matrix:
  stage: prepare
  image: alpine:latest
  before_script:
    - apk add --no-cache jq curl
  script:
    # ðŸ” èŽ·å–å¯ç”¨çš„Node.jsç‰ˆæœ¬
    - |
      # ä»ŽDocker Hub APIèŽ·å–æœ€æ–°ç‰ˆæœ¬
      AVAILABLE_VERSIONS=$(curl -s "https://registry.hub.docker.com/v2/repositories/library/node/tags/" | \
        jq -r '.results[].name' | \
        grep -E '^[0-9]+\.[0-9]+$' | \
        head -5)
      
      # ðŸ“ ç”ŸæˆMatrixé…ç½®
      echo "ç”Ÿæˆçš„ç‰ˆæœ¬åˆ—è¡¨: $AVAILABLE_VERSIONS"
      
      # ðŸ”§ åˆ›å»ºåŠ¨æ€é…ç½®æ–‡ä»¶
      cat > dynamic_matrix.json << EOF
      {
        "include": [
      EOF
      
      # ðŸ”„ å¾ªçŽ¯ç”Ÿæˆæ¯ä¸ªç‰ˆæœ¬çš„é…ç½®
      for version in $AVAILABLE_VERSIONS; do
        cat >> dynamic_matrix.json << EOF
          {
            "NODE_VERSION": "$version",
            "TEST_SUITE": "full"
          },
      EOF
      done
      
      # ðŸŽ¯ æ·»åŠ ç‰¹æ®Šæµ‹è¯•ç»„åˆ
      cat >> dynamic_matrix.json << EOF
          {
            "NODE_VERSION": "lts",
            "TEST_SUITE": "performance"
          }
        ]
      }
      EOF
      
      echo "ðŸ“„ ç”Ÿæˆçš„Matrixé…ç½®:"
      cat dynamic_matrix.json
  artifacts:
    paths:
      - dynamic_matrix.json
    expire_in: 1 hour

# ðŸš€ ä½¿ç”¨åŠ¨æ€ç”Ÿæˆçš„é…ç½®è¿è¡Œæµ‹è¯•
dynamic_test:
  stage: test
  needs: ["generate_matrix"]
  parallel:
    matrix:
      - include: !reference [.dynamic_matrix_config]
  before_script:
    # ðŸ“¥ è¯»å–åŠ¨æ€é…ç½®
    - MATRIX_CONFIG=$(cat dynamic_matrix.json)
    - echo "å½“å‰é…ç½®: $MATRIX_CONFIG"
  script:
    - echo "ðŸ§ª è¿è¡Œ Node.js $NODE_VERSION çš„ $TEST_SUITE æµ‹è¯•"
    # ðŸŽ­ æ ¹æ®æµ‹è¯•å¥—ä»¶ç±»åž‹æ‰§è¡Œä¸åŒå‘½ä»¤
    - |
      case $TEST_SUITE in
        full)
          npm install && npm test ;;
        performance)
          npm install && npm run test:performance ;;
      esac
```

### 6.3 åŸºäºŽå¤–éƒ¨APIçš„åŠ¨æ€é…ç½®


**æ ¹æ®å®žæ—¶æ•°æ®ç”Ÿæˆé…ç½®**ï¼š

```yaml
api_driven_matrix:
  stage: prepare
  script:
    # ðŸŒ ä»ŽAPIèŽ·å–éœ€è¦æµ‹è¯•çš„çŽ¯å¢ƒåˆ—è¡¨
    - |
      ENVIRONMENTS=$(curl -s "https://api.company.com/environments" | \
        jq -r '.active_environments[].name')
      
      echo "ðŸ“‹ æ´»è·ƒçŽ¯å¢ƒåˆ—è¡¨: $ENVIRONMENTS"
      
      # ðŸ”§ ç”Ÿæˆå¯¹åº”çš„Pipelineé…ç½®
      cat > generated_pipeline.yml << EOF
      stages:
        - test
        - deploy
      
      EOF
      
      # ðŸ”„ ä¸ºæ¯ä¸ªçŽ¯å¢ƒç”ŸæˆJob
      for env in $ENVIRONMENTS; do
        cat >> generated_pipeline.yml << EOF
      test_$env:
        stage: test
        script:
          - echo "æµ‹è¯•çŽ¯å¢ƒ: $env"
          - ./run_tests.sh $env
        environment:
          name: $env
          url: https://$env.company.com
      
      EOF
      done
      
      echo "ðŸ“„ ç”Ÿæˆçš„Pipelineé…ç½®:"
      cat generated_pipeline.yml
  artifacts:
    paths:
      - generated_pipeline.yml
```

### 6.4 æ¡ä»¶åŒ–Matrixç”Ÿæˆ


**æ™ºèƒ½è·³è¿‡ä¸å¿…è¦çš„ç»„åˆ**ï¼š

```yaml
smart_matrix:
  stage: test
  parallel:
    matrix:
      - LANGUAGE: ["java", "python", "go"]
        VERSION: ["8", "11", "17"]
        exclude:
          # ðŸš« Pythonä¸éœ€è¦æµ‹è¯•Javaç‰ˆæœ¬
          - LANGUAGE: "python"
            VERSION: "8"
          - LANGUAGE: "python"  
            VERSION: "11"
          - LANGUAGE: "python"
            VERSION: "17"
          # ðŸš« Goä¸éœ€è¦æµ‹è¯•Javaç‰ˆæœ¬  
          - LANGUAGE: "go"
            VERSION: "8"
          - LANGUAGE: "go"
            VERSION: "11"
          - LANGUAGE: "go"
            VERSION: "17"
        include:
          # âœ… ä¸ºPythonæ·»åŠ ç‰¹å®šç‰ˆæœ¬
          - LANGUAGE: "python"
            VERSION: "3.8"
          - LANGUAGE: "python"
            VERSION: "3.9"
          - LANGUAGE: "python"
            VERSION: "3.10"
          # âœ… ä¸ºGoæ·»åŠ ç‰¹å®šç‰ˆæœ¬
          - LANGUAGE: "go"
            VERSION: "1.19"
          - LANGUAGE: "go"
            VERSION: "1.20"
  script:
    - echo "ðŸ”§ æµ‹è¯• $LANGUAGE ç‰ˆæœ¬ $VERSION"
    # ðŸŽ¯ æ ¹æ®è¯­è¨€æ‰§è¡Œç›¸åº”æµ‹è¯•
    - ./test_runner.sh $LANGUAGE $VERSION
```

---

## 7. ðŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŽŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ðŸ”¸ å¹¶è¡Œæž„å»ºï¼šåŒæ—¶è¿è¡Œå¤šä¸ªä»»åŠ¡ï¼Œæé«˜CI/CDæ•ˆçŽ‡
ðŸ”¸ parallelé…ç½®ï¼šå°†å•ä¸ªJobåˆ†æˆå¤šä»½å¹¶è¡Œæ‰§è¡Œ
ðŸ”¸ Matrixæž„å»ºï¼šè‡ªåŠ¨ç”Ÿæˆå¤šç§å‚æ•°ç»„åˆçš„æµ‹è¯•
ðŸ”¸ çŽ¯å¢ƒå˜é‡ï¼š$CI_NODE_INDEX å’Œ $CI_NODE_TOTAL æŽ§åˆ¶å¹¶è¡Œåˆ†é…
ðŸ”¸ åŠ¨æ€é…ç½®ï¼šæ ¹æ®å®žé™…æƒ…å†µè‡ªåŠ¨ç”Ÿæˆæµ‹è¯•ç»„åˆ
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ðŸ”¹ ä½•æ—¶ä½¿ç”¨å¹¶è¡Œæž„å»º**
```
é€‚åˆåœºæ™¯ï¼š
âœ… æµ‹è¯•æ–‡ä»¶å¾ˆå¤šï¼Œå¯ä»¥åˆ†ç»„æ‰§è¡Œ
âœ… éœ€è¦åœ¨å¤šä¸ªçŽ¯å¢ƒ/ç‰ˆæœ¬ä¸Šæµ‹è¯•
âœ… æœ‰è¶³å¤Ÿçš„Runnerèµ„æº
âœ… ä»»åŠ¡ä¹‹é—´ç›¸äº’ç‹¬ç«‹

ä¸é€‚åˆåœºæ™¯ï¼š
âŒ ä»»åŠ¡ä¹‹é—´æœ‰å¼ºä¾èµ–å…³ç³»
âŒ Runnerèµ„æºæœ‰é™
âŒ ä»»åŠ¡æ‰§è¡Œæ—¶é—´å¾ˆçŸ­
```

**ðŸ”¹ Matrix vs Parallelçš„åŒºåˆ«**
```
Parallelï¼š
- ðŸŽ¯ ç”¨äºŽåˆ†å‰²å¤§ä»»åŠ¡
- ðŸ“Š æ‰€æœ‰å­ä»»åŠ¡ä»£ç ç›¸åŒï¼Œåªæ˜¯å¤„ç†ä¸åŒæ•°æ®
- ðŸ”¢ ç”¨æ•°å­—ç´¢å¼•åŒºåˆ†

Matrixï¼š  
- ðŸŽ¯ ç”¨äºŽå¤šç§ç»„åˆæµ‹è¯•
- ðŸ“Š æ¯ä¸ªå­ä»»åŠ¡å‚æ•°ä¸åŒ
- ðŸ·ï¸ ç”¨å‚æ•°åç§°åŒºåˆ†
```

**ðŸ”¹ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**
```
åˆç†è®¾ç½®å¹¶è¡Œåº¦ï¼š
- ðŸ‘¥ ä¸è¦è¶…è¿‡å¯ç”¨Runneræ•°é‡
- âš–ï¸ å¹³è¡¡æ‰§è¡Œæ—¶é—´å’Œèµ„æºæ¶ˆè€—
- ðŸ“Š ç›‘æŽ§å®žé™…æ‰§è¡Œæ•ˆæžœ

å‡å°‘èµ„æºç«žäº‰ï¼š
- ðŸ—„ï¸ ä½¿ç”¨ä¸åŒçš„æ•°æ®åº“å®žä¾‹
- ðŸ“ éš”ç¦»ä¸´æ—¶æ–‡ä»¶ç›®å½•
- ðŸ” é¿å…å…±äº«çŠ¶æ€
```

### 7.3 å®žé™…åº”ç”¨å»ºè®®


**ðŸ”¹ æœ€ä½³å®žè·µ**
- âœ… **åˆç†åˆ†ç»„**ï¼šå°†ç›¸å…³æµ‹è¯•æ”¾åœ¨åŒä¸€ä¸ªparallel jobä¸­
- âœ… **é”™è¯¯éš”ç¦»**ï¼šä¸€ä¸ªå¹¶è¡Œä»»åŠ¡å¤±è´¥ä¸å½±å“å…¶ä»–ä»»åŠ¡
- âœ… **èµ„æºç›‘æŽ§**ï¼šè§‚å¯ŸRunnerä½¿ç”¨æƒ…å†µï¼Œè°ƒæ•´å¹¶è¡Œåº¦
- âœ… **å¤±è´¥é‡è¯•**ï¼šä¸ºç½‘ç»œç›¸å…³çš„æµ‹è¯•é…ç½®é‡è¯•æœºåˆ¶

**ðŸ”¹ å¸¸è§é—®é¢˜è§£å†³**
```
é—®é¢˜ï¼šå¹¶è¡Œä»»åŠ¡æ‰§è¡Œæ—¶é—´å·®å¼‚å¾ˆå¤§
è§£å†³ï¼šé‡æ–°åˆ†é…ä»»åŠ¡ï¼Œè®©æ¯ä¸ªå¹¶è¡Œä»»åŠ¡å·¥ä½œé‡ç›¸è¿‘

é—®é¢˜ï¼šMatrixç”Ÿæˆå¤ªå¤šJobï¼ŒRunnerä¸å¤Ÿç”¨
è§£å†³ï¼šä½¿ç”¨excludeæŽ’é™¤ä¸å¿…è¦ç»„åˆï¼Œæˆ–å¢žåŠ Runner

é—®é¢˜ï¼šå¹¶è¡Œä»»åŠ¡ä¹‹é—´æ•°æ®å†²çª
è§£å†³ï¼šä¸ºæ¯ä¸ªä»»åŠ¡ä½¿ç”¨ç‹¬ç«‹çš„å·¥ä½œç›®å½•å’Œæ•°æ®åº“
```

**ðŸ”¹ è¿›é˜¶æŠ€å·§**
- ðŸŽ¯ **æ™ºèƒ½åˆ†ç»„**ï¼šæ ¹æ®åŽ†å²æ‰§è¡Œæ—¶é—´æ™ºèƒ½åˆ†é…ä»»åŠ¡
- ðŸ“Š **åŠ¨æ€è°ƒæ•´**ï¼šæ ¹æ®Runnerè´Ÿè½½åŠ¨æ€è°ƒæ•´å¹¶è¡Œåº¦
- ðŸ”„ **å¤±è´¥é‡è¯•**ï¼šåªé‡è¯•å¤±è´¥çš„å¹¶è¡Œä»»åŠ¡ï¼Œä¸é‡è¯•æ•´ä¸ªJob
- ðŸ“ˆ **æ€§èƒ½ç›‘æŽ§**ï¼šæ”¶é›†å¹¶è¡Œæ‰§è¡Œçš„æ€§èƒ½æ•°æ®ï¼ŒæŒç»­ä¼˜åŒ–

### 7.4 å­¦ä¹ è·¯å¾„å»ºè®®


**â­ åˆçº§é˜¶æ®µ**ï¼š
1. æŽŒæ¡åŸºç¡€parallelé…ç½®
2. ç†è§£CI_NODE_INDEXå’ŒCI_NODE_TOTAL
3. ç»ƒä¹ ç®€å•çš„æµ‹è¯•æ–‡ä»¶åˆ†ç»„

**â­â­ ä¸­çº§é˜¶æ®µ**ï¼š  
1. å­¦ä¼šMatrixæž„å»ºè¯­æ³•
2. æŽŒæ¡å¤šçŽ¯å¢ƒæµ‹è¯•ç­–ç•¥
3. äº†è§£excludeå’Œincludeç”¨æ³•

**â­â­â­ é«˜çº§é˜¶æ®µ**ï¼š
1. å®žçŽ°åŠ¨æ€é…ç½®ç”Ÿæˆ
2. ä¼˜åŒ–å¹¶è¡Œæ‰§è¡Œæ€§èƒ½
3. å¤„ç†å¤æ‚çš„ä¾èµ–å…³ç³»

**æ ¸å¿ƒè®°å¿†**ï¼š
- å¹¶è¡Œæž„å»ºçœæ—¶é—´ï¼Œåˆç†è§„åˆ’å¾ˆå…³é”®
- Matrixç»„åˆæµ‹è¯•å…¨ï¼Œexcludeå‡å°‘å†—ä½™æº
- åŠ¨æ€é…ç½®æ›´çµæ´»ï¼Œæ ¹æ®éœ€è¦æ¥ç”Ÿæˆ
- ç›‘æŽ§ä¼˜åŒ–ä¸èƒ½åœï¼Œæ•ˆçŽ‡æå‡æ— æ­¢å¢ƒ