---
title: 2ã€Pipelineæ‰§è¡Œæµç¨‹
---
## ğŸ“š ç›®å½•

1. [Pipelineæ‰§è¡ŒåŸºç¡€æ¦‚å¿µ](#1-pipelineæ‰§è¡ŒåŸºç¡€æ¦‚å¿µ)
2. [Pipelineæ‰§è¡Œé¡ºåºè¯¦è§£](#2-pipelineæ‰§è¡Œé¡ºåºè¯¦è§£)
3. [å¹¶è¡Œæ‰§è¡Œé…ç½®](#3-å¹¶è¡Œæ‰§è¡Œé…ç½®)
4. [Jobä¾èµ–å…³ç³»ç®¡ç†](#4-jobä¾èµ–å…³ç³»ç®¡ç†)
5. [needså…³é”®å­—ä½¿ç”¨æŠ€å·§](#5-needså…³é”®å­—ä½¿ç”¨æŠ€å·§)
6. [æ‰§è¡Œå¤±è´¥å¤„ç†ç­–ç•¥](#6-æ‰§è¡Œå¤±è´¥å¤„ç†ç­–ç•¥)
7. [interruptibleä¸­æ–­é…ç½®](#7-interruptibleä¸­æ–­é…ç½®)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ Pipelineæ‰§è¡ŒåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Pipelineæ‰§è¡Œæµç¨‹


**ğŸ”¸ é€šä¿—ç†è§£**
Pipelineæ‰§è¡Œæµç¨‹å°±åƒæ˜¯**å·¥å‚æµæ°´çº¿çš„è¿è½¬è¿‡ç¨‹**ã€‚æƒ³è±¡ä¸€ä¸‹æ±½è½¦ç”Ÿäº§ï¼š

```
åŸææ–™ â†’ é›¶ä»¶åŠ å·¥ â†’ ç»„è£… â†’ æµ‹è¯• â†’ åŒ…è£… â†’ å‡ºå‚
   â†“        â†“       â†“     â†“     â†“     â†“
 ä»£ç æäº¤ â†’ æ„å»ºä»£ç  â†’ æµ‹è¯• â†’ éƒ¨ç½² â†’ éªŒè¯ â†’ ä¸Šçº¿
```

æ¯ä¸ªç¯èŠ‚éƒ½æœ‰**æ˜ç¡®çš„é¡ºåº**å’Œ**ä¾èµ–å…³ç³»**ï¼Œå‰ä¸€æ­¥å®Œæˆäº†ï¼Œåä¸€æ­¥æ‰èƒ½å¼€å§‹ã€‚

### 1.2 Pipelineçš„æ ¸å¿ƒç»„æˆ


**ğŸ”¹ ä¸‰ä¸ªå…³é”®å±‚æ¬¡**

```
Pipeline (ç®¡é“)
    â†“
Stage (é˜¶æ®µ) 
    â†“  
Job (ä»»åŠ¡)
```

**ğŸ’¡ ç”Ÿæ´»ç±»æ¯”**
- **Pipeline**: æ•´ä¸ªè£…ä¿®æˆ¿å­çš„è¿‡ç¨‹
- **Stage**: æ°´ç”µæ”¹é€ ã€è´´ç“·ç –ã€åˆ·å¢™ç­‰å¤§çš„é˜¶æ®µ  
- **Job**: å…·ä½“çš„å°ä»»åŠ¡ï¼Œæ¯”å¦‚"å®‰è£…æ’åº§"ã€"è´´å®¢å…ç“·ç –"

### 1.3 é»˜è®¤æ‰§è¡Œè§„åˆ™


**ğŸ”¸ åŸºæœ¬æ‰§è¡Œé€»è¾‘**
```
â±ï¸ æ—¶é—´é¡ºåº: StageæŒ‰é¡ºåºæ‰§è¡Œï¼Œä¸€ä¸ªé˜¶æ®µå®Œæˆåæ‰èƒ½è¿›å…¥ä¸‹ä¸€ä¸ª
ğŸ”„ å¹¶è¡Œå¤„ç†: åŒä¸€ä¸ªStageå†…çš„Jobå¯ä»¥åŒæ—¶è¿è¡Œ
âš ï¸ å¤±è´¥å¤„ç†: ä»»ä½•ä¸€ä¸ªJobå¤±è´¥ï¼Œæ•´ä¸ªStageå°±ç®—å¤±è´¥
ğŸ”— ä¾èµ–é“¾æ¡: Stageå¤±è´¥åï¼Œåç»­Stageä¸ä¼šæ‰§è¡Œ
```

---

## 2. âš¡ Pipelineæ‰§è¡Œé¡ºåºè¯¦è§£


### 2.1 é»˜è®¤é¡ºåºæ‰§è¡Œ


**ğŸ”¸ æ ‡å‡†çš„æ‰§è¡Œæµç¨‹**

```yaml
# å…¸å‹çš„CI/CDé˜¶æ®µå®šä¹‰
stages:
  - build      # ç¬¬1é˜¶æ®µï¼šæ„å»º
  - test       # ç¬¬2é˜¶æ®µï¼šæµ‹è¯•  
  - deploy     # ç¬¬3é˜¶æ®µï¼šéƒ¨ç½²

# æ‰§è¡Œæµç¨‹å›¾ç¤º
buildé˜¶æ®µ â”€â”€å®Œæˆâ”€â”€â–¶ testé˜¶æ®µ â”€â”€å®Œæˆâ”€â”€â–¶ deployé˜¶æ®µ
    â”‚                   â”‚                  â”‚
    â–¼                   â–¼                  â–¼
æ‰€æœ‰buildä»»åŠ¡å®Œæˆ    æ‰€æœ‰testä»»åŠ¡å®Œæˆ    æ‰€æœ‰deployä»»åŠ¡å®Œæˆ
```

### 2.2 å®é™…æ‰§è¡Œç¤ºä¾‹


```yaml
stages:
  - prepare
  - build
  - test
  - deploy

# å‡†å¤‡é˜¶æ®µçš„ä»»åŠ¡
setup_environment:
  stage: prepare
  script:
    - echo "å‡†å¤‡å¼€å‘ç¯å¢ƒ"
    - mkdir -p build/

# æ„å»ºé˜¶æ®µçš„ä»»åŠ¡  
build_frontend:
  stage: build
  script:
    - echo "æ„å»ºå‰ç«¯ä»£ç "
    - npm run build

build_backend:
  stage: build  
  script:
    - echo "æ„å»ºåç«¯ä»£ç "
    - mvn package
```

**ğŸ“Š æ‰§è¡Œæ—¶é—´çº¿**
```
æ—¶é—´ 0s:  [å‡†å¤‡é˜¶æ®µ] setup_environment å¼€å§‹
æ—¶é—´ 30s: [å‡†å¤‡é˜¶æ®µ] å®Œæˆï¼Œè¿›å…¥æ„å»ºé˜¶æ®µ
æ—¶é—´ 31s: [æ„å»ºé˜¶æ®µ] build_frontend å’Œ build_backend åŒæ—¶å¼€å§‹
æ—¶é—´ 90s: [æ„å»ºé˜¶æ®µ] ä¸¤ä¸ªä»»åŠ¡éƒ½å®Œæˆï¼Œè¿›å…¥æµ‹è¯•é˜¶æ®µ
```

### 2.3 é˜¶æ®µè·³è¿‡å’Œæ¡ä»¶æ‰§è¡Œ


**ğŸ”¸ æŒ‰æ¡ä»¶æ‰§è¡Œé˜¶æ®µ**
```yaml
deploy_production:
  stage: deploy
  script:
    - echo "éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ"
  only:
    - main    # åªæœ‰mainåˆ†æ”¯æ‰æ‰§è¡Œéƒ¨ç½²
  
deploy_staging:
  stage: deploy  
  script:
    - echo "éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ"
  except:
    - main    # é™¤äº†mainåˆ†æ”¯ï¼Œå…¶ä»–åˆ†æ”¯éƒ½éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
```

---

## 3. ğŸ”„ å¹¶è¡Œæ‰§è¡Œé…ç½®


### 3.1 é»˜è®¤å¹¶è¡Œæœºåˆ¶


**ğŸ”¸ åŒé˜¶æ®µå†…çš„å¹¶è¡Œ**

åœ¨åŒä¸€ä¸ªStageä¸­ï¼Œå¤šä¸ªJobä¼š**è‡ªåŠ¨å¹¶è¡Œæ‰§è¡Œ**ï¼Œè¿™å°±åƒé¤å…é‡Œå¤šä¸ªå¨å¸ˆåŒæ—¶åšä¸åŒçš„èœï¼š

```yaml
stage: test

# è¿™ä¸‰ä¸ªæµ‹è¯•ä¼šåŒæ—¶è¿›è¡Œ
unit_test:
  stage: test
  script: ["npm run test:unit"]

integration_test:  
  stage: test
  script: ["npm run test:integration"]

security_test:
  stage: test  
  script: ["npm run test:security"]
```

**ğŸ“ˆ å¹¶è¡Œæ‰§è¡Œå›¾ç¤º**
```
testé˜¶æ®µå¼€å§‹
    â”œâ”€â”€ unit_test        (åŒæ—¶æ‰§è¡Œ)
    â”œâ”€â”€ integration_test (åŒæ—¶æ‰§è¡Œ)  
    â””â”€â”€ security_test    (åŒæ—¶æ‰§è¡Œ)
         â†“
    æ‰€æœ‰æµ‹è¯•å®Œæˆåè¿›å…¥ä¸‹ä¸€é˜¶æ®µ
```

### 3.2 å¹¶è¡Œæ•°é‡æ§åˆ¶


**ğŸ”¸ Runnerå¹¶å‘é™åˆ¶**

> âš ï¸ **é‡è¦æé†’**  
> å¹¶è¡Œæ•°é‡å—åˆ°GitLab Runnerçš„é™åˆ¶ã€‚å¦‚æœä½ åªæœ‰2ä¸ªRunnerï¼Œå³ä½¿å®šä¹‰äº†5ä¸ªå¹¶è¡ŒJobï¼Œä¹Ÿåªèƒ½åŒæ—¶è¿è¡Œ2ä¸ªã€‚

**ğŸ”¸ åˆç†è§„åˆ’å¹¶è¡Œä»»åŠ¡**
```yaml
# âœ… æ¨èï¼šæ ¹æ®å®é™…èµ„æºè§„åˆ’
test_suite_1:
  stage: test
  script: ["æµ‹è¯•æ¨¡å—A"]
  
test_suite_2:
  stage: test  
  script: ["æµ‹è¯•æ¨¡å—B"]

# âŒ é¿å…ï¼šè¿‡å¤šç»†ç²’åº¦çš„å¹¶è¡Œä»»åŠ¡
test_file_1:
  stage: test
  script: ["æµ‹è¯•å•ä¸ªæ–‡ä»¶1"]
# ... å®šä¹‰100ä¸ªç±»ä¼¼ä»»åŠ¡ä¼šå¯¼è‡´èµ„æºæµªè´¹
```

### 3.3 å¹¶è¡Œæ‰§è¡Œçš„ä¼˜åŠ¿ä¸æ³¨æ„äº‹é¡¹


**âœ… å¹¶è¡Œæ‰§è¡Œçš„å¥½å¤„**
- **èŠ‚çœæ—¶é—´**: æ€»æ‰§è¡Œæ—¶é—´å–å†³äºæœ€æ…¢çš„é‚£ä¸ªJob
- **æé«˜æ•ˆç‡**: å……åˆ†åˆ©ç”¨å¯ç”¨çš„Runnerèµ„æº
- **å¿«é€Ÿåé¦ˆ**: æ›´æ—©å‘ç°é—®é¢˜

**âš ï¸ éœ€è¦æ³¨æ„çš„é—®é¢˜**  
- **èµ„æºç«äº‰**: å¤šä¸ªJobå¯èƒ½äº‰å¤ºç›¸åŒèµ„æº
- **ä¾èµ–å†²çª**: ç¡®ä¿å¹¶è¡Œçš„Jobä¹‹é—´æ²¡æœ‰æ•°æ®ä¾èµ–
- **Runnerè´Ÿè½½**: ä¸è¦è¶…å‡ºRunnerçš„å¤„ç†èƒ½åŠ›

---

## 4. ğŸ”— Jobä¾èµ–å…³ç³»ç®¡ç†


### 4.1 ä¼ ç»Ÿçš„Stageä¾èµ–


**ğŸ”¸ Stageçº§åˆ«çš„ä¾èµ–**

ä¼ ç»Ÿæ–¹å¼æ˜¯é€šè¿‡`stages`æ¥æ§åˆ¶ä¾èµ–ï¼Œä½†è¿™ç§æ–¹å¼æ¯”è¾ƒ"ç²—ç³™"ï¼š

```yaml
stages:
  - build
  - test  
  - deploy

# é—®é¢˜ï¼šå³ä½¿åªéœ€è¦å‰ç«¯æµ‹è¯•ï¼Œä¹Ÿè¦ç­‰åç«¯æ„å»ºå®Œæˆ
frontend_test:
  stage: test  # å¿…é¡»ç­‰æ•´ä¸ªbuildé˜¶æ®µå®Œæˆ
  script: ["æµ‹è¯•å‰ç«¯"]

backend_build:
  stage: build
  script: ["æ„å»ºåç«¯"] # å¾ˆæ…¢ï¼Œéœ€è¦10åˆ†é’Ÿ
  
frontend_build:  
  stage: build
  script: ["æ„å»ºå‰ç«¯"] # å¾ˆå¿«ï¼Œåªéœ€è¦2åˆ†é’Ÿ
```

**ğŸ“Š æ—¶é—´æµªè´¹ç¤ºæ„**
```
buildé˜¶æ®µ:  |â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| (10åˆ†é’Ÿï¼Œç­‰åç«¯æ„å»º)
testé˜¶æ®µ:   |â–ˆâ–ˆ| (2åˆ†é’Ÿå‰ç«¯æµ‹è¯•ï¼Œä½†è¦ç­‰10åˆ†é’Ÿåæ‰èƒ½å¼€å§‹)
æ€»è€—æ—¶: 12åˆ†é’Ÿ
```

### 4.2 ç²¾ç¡®çš„Jobä¾èµ–


**ğŸ”¸ ä½¿ç”¨dependencieså…³é”®å­—**

`dependencies`è®©ä½ å¯ä»¥æŒ‡å®š**å…·ä½“éœ€è¦å“ªäº›Jobçš„äº§ç‰©**ï¼š

```yaml
build_frontend:
  stage: build
  script:
    - npm run build
  artifacts:
    paths:
      - dist/

build_backend:
  stage: build  
  script:
    - mvn package
  artifacts:
    paths:
      - target/

# å‰ç«¯æµ‹è¯•åªä¾èµ–å‰ç«¯æ„å»ºçš„ç»“æœ
test_frontend:
  stage: test
  script:
    - npm run test
  dependencies:
    - build_frontend  # åªéœ€è¦å‰ç«¯æ„å»ºçš„äº§ç‰©

# é›†æˆæµ‹è¯•éœ€è¦å‰åç«¯çš„æ„å»ºç»“æœ  
test_integration:
  stage: test
  script:
    - run_integration_tests.sh
  dependencies:
    - build_frontend
    - build_backend
```

**ğŸ’¡ é€šä¿—ç†è§£**
`dependencies`å°±åƒæ˜¯**ç‚¹èœ**ï¼š
- ä¸ç”¨dependenciesï¼šå°±åƒå¥—é¤ï¼Œå¿…é¡»ç­‰æ‰€æœ‰èœéƒ½ä¸Šé½äº†æ‰èƒ½åƒ
- ç”¨äº†dependenciesï¼šå°±åƒå•ç‚¹ï¼Œè°åšå¥½äº†å°±å¯ä»¥å…ˆåƒè°

---

## 5. ğŸ¯ needså…³é”®å­—ä½¿ç”¨æŠ€å·§


### 5.1 needsçš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯needs**

`needs`æ˜¯GitLab CI/CDä¸­æœ€å¼ºå¤§çš„ä¾èµ–æ§åˆ¶å·¥å…·ï¼Œå®ƒè®©ä½ å¯ä»¥**è·¨é˜¶æ®µåˆ›å»ºç²¾ç¡®çš„ä¾èµ–å…³ç³»**ã€‚

**ğŸ’¡ ç”Ÿæ´»ç±»æ¯”**
ä¼ ç»Ÿæ–¹å¼åƒæ˜¯**ä¸¥æ ¼çš„å­¦æ ¡è¯¾ç¨‹è¡¨**ï¼š
- å¿…é¡»ä¸Šå®Œç¬¬ä¸€èŠ‚è¯¾ï¼Œæ‰èƒ½ä¸Šç¬¬äºŒèŠ‚è¯¾
- å³ä½¿ç¬¬äºŒèŠ‚è¯¾å’Œç¬¬ä¸€èŠ‚è¯¾æ²¡å…³ç³»

`needs`åƒæ˜¯**çµæ´»çš„åŸ¹è®­å®‰æ’**ï¼š
- åªè¦æŒæ¡äº†å‰ç½®æŠ€èƒ½ï¼Œå°±å¯ä»¥ç›´æ¥å­¦ä¹ é«˜çº§è¯¾ç¨‹
- ä¸éœ€è¦ç­‰å…¶ä»–æ— å…³çš„è¯¾ç¨‹ç»“æŸ

### 5.2 needsåŸºç¡€ç”¨æ³•


```yaml
stages:
  - build
  - test
  - package
  - deploy

build_app:
  stage: build
  script:
    - echo "æ„å»ºåº”ç”¨"
  artifacts:
    paths:
      - app/

build_docs:
  stage: build
  script:
    - echo "æ„å»ºæ–‡æ¡£"  
  artifacts:
    paths:
      - docs/

# ä½¿ç”¨needsè·³è¿‡é˜¶æ®µé™åˆ¶
package_app:
  stage: package  
  script:
    - echo "æ‰“åŒ…åº”ç”¨"
  needs:
    - build_app    # åªéœ€è¦appæ„å»ºå®Œæˆï¼Œä¸ç”¨ç­‰docs

test_docs:
  stage: test
  script:
    - echo "æµ‹è¯•æ–‡æ¡£"
  needs:
    - build_docs   # åªéœ€è¦docsæ„å»ºå®Œæˆ
```

**ğŸ“Š æ‰§è¡Œæµç¨‹å¯¹æ¯”**

```
ä¼ ç»Ÿæ–¹å¼ (æŒ‰stageæ‰§è¡Œ):
buildé˜¶æ®µ: |â–ˆâ–ˆâ–ˆâ–ˆ| build_app + build_docs (å¹¶è¡Œï¼Œä½†è¦ç­‰éƒ½å®Œæˆ)
testé˜¶æ®µ:  |â–ˆâ–ˆ| test_docs (ç­‰å¾…ä¸Šä¸€é˜¶æ®µå®Œå…¨ç»“æŸ)  
packageé˜¶æ®µ: |â–ˆâ–ˆâ–ˆ| package_app (ç­‰å¾…ä¸Šä¸€é˜¶æ®µå®Œå…¨ç»“æŸ)

ä½¿ç”¨needs:
æ—¶é—´0: build_app å’Œ build_docs åŒæ—¶å¼€å§‹
æ—¶é—´2: build_app å®Œæˆ â†’ package_app ç«‹å³å¼€å§‹
æ—¶é—´3: build_docs å®Œæˆ â†’ test_docs ç«‹å³å¼€å§‹
æ—¶é—´5: package_app å®Œæˆ
æ—¶é—´4: test_docs å®Œæˆ
```

### 5.3 needsçš„é«˜çº§ç”¨æ³•


**ğŸ”¸ è·¨å¤šä¸ªé˜¶æ®µçš„ä¾èµ–**
```yaml
# å¯ä»¥è·¨è¶Šå¤šä¸ªé˜¶æ®µåˆ›å»ºä¾èµ–
deploy_to_production:
  stage: deploy
  script:
    - echo "éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ"
  needs:
    - build_app        # æ¥è‡ªbuildé˜¶æ®µ
    - test_integration # æ¥è‡ªtesté˜¶æ®µ
    - security_scan    # æ¥è‡ªsecurityé˜¶æ®µ
  # ä¸éœ€è¦ç­‰å…¶ä»–æ— å…³çš„Jobå®Œæˆ
```

**ğŸ”¸ æ¡ä»¶åŒ–çš„needs**
```yaml
deploy_with_conditions:
  stage: deploy
  script:
    - echo "æ¡ä»¶éƒ¨ç½²"
  needs:
    - job: build_app
      artifacts: true    # éœ€è¦artifacts
    - job: quick_test
      artifacts: false   # ä¸éœ€è¦artifactsï¼Œåªéœ€è¦JobæˆåŠŸ
  only:
    - main
```

### 5.4 needsä½¿ç”¨æ³¨æ„äº‹é¡¹


**âš ï¸ é‡è¦é™åˆ¶**

1. **å¾ªç¯ä¾èµ–æ£€æŸ¥**
```yaml
# âŒ é”™è¯¯ï¼šä¼šåˆ›å»ºå¾ªç¯ä¾èµ–
job_a:
  needs: [job_b]
  
job_b:
  needs: [job_a]  # å¾ªç¯ä¾èµ–ï¼ŒGitLabä¼šæŠ¥é”™
```

2. **æœ€å¤§ä¾èµ–æ•°é‡**
```yaml
# âš ï¸ æ³¨æ„ï¼šneedsåˆ—è¡¨ä¸è¦è¿‡é•¿
deploy_job:
  needs: 
    - job1
    - job2
    # ... æœ€å¥½ä¸è¶…è¿‡50ä¸ªä¾èµ–
```

**ğŸ’¡ æœ€ä½³å®è·µå»ºè®®**
- âœ… åªæ·»åŠ **çœŸæ­£éœ€è¦**çš„ä¾èµ–
- âœ… ä¿æŒä¾èµ–å…³ç³»**ç®€å•æ¸…æ™°**  
- âœ… å®šæœŸæ£€æŸ¥æ˜¯å¦æœ‰**ä¸å¿…è¦çš„ä¾èµ–**
- âŒ é¿å…åˆ›å»ºè¿‡äºå¤æ‚çš„ä¾èµ–ç½‘ç»œ

---

## 6. ğŸš¨ æ‰§è¡Œå¤±è´¥å¤„ç†ç­–ç•¥


### 6.1 é»˜è®¤å¤±è´¥è¡Œä¸º


**ğŸ”¸ å¤±è´¥çš„è¿é”ååº”**

å½“Pipelineä¸­çš„æŸä¸ªJobå¤±è´¥æ—¶ï¼Œä¼šäº§ç”Ÿ"å¤šç±³è¯ºéª¨ç‰Œ"æ•ˆåº”ï¼š

```
æ­£å¸¸æµç¨‹: build âœ… â†’ test âœ… â†’ deploy âœ…

å¤±è´¥æƒ…å†µ: build âœ… â†’ test âŒ â†’ deploy â¸ï¸ (è¢«è·³è¿‡)
```

**ğŸ’¡ é€šä¿—ç†è§£**
å°±åƒæ˜¯å·¥å‚æµæ°´çº¿ï¼Œå¦‚æœè´¨æ£€å‘ç°äº§å“æœ‰é—®é¢˜ï¼Œåç»­çš„åŒ…è£…å’Œå‘è´§éƒ½ä¼šåœæ­¢ã€‚

### 6.2 allow_failureå®¹é”™é…ç½®


**ğŸ”¸ å…è®¸æŸäº›Jobå¤±è´¥**

æœ‰äº›Jobå¤±è´¥å¹¶ä¸åº”è¯¥é˜»æ­¢æ•´ä¸ªPipelineï¼Œæ¯”å¦‚**ä»£ç è´¨é‡æ£€æŸ¥**æˆ–**æ€§èƒ½æµ‹è¯•**ï¼š

```yaml
# ä¸»è¦æ„å»ºä»»åŠ¡ - ä¸èƒ½å¤±è´¥
build_application:
  stage: build
  script:
    - npm run build

# ä»£ç è´¨é‡æ£€æŸ¥ - å…è®¸å¤±è´¥
code_quality:
  stage: test
  script:
    - npm run lint
    - npm run quality-check
  allow_failure: true    # å³ä½¿å¤±è´¥ä¹Ÿä¸å½±å“Pipeline

# æ€§èƒ½æµ‹è¯• - å…è®¸å¤±è´¥
performance_test:
  stage: test  
  script:
    - npm run performance
  allow_failure: true
  
# éƒ¨ç½²ä»»åŠ¡ - ä¼šæ­£å¸¸æ‰§è¡Œ
deploy_application:
  stage: deploy
  script:
    - npm run deploy
```

**ğŸ“Š æ‰§è¡Œç»“æœå¯¹æ¯”**

```
ä¸ä½¿ç”¨allow_failure:
build âœ… â†’ code_quality âŒ â†’ deploy â¸ï¸ (Pipelineå¤±è´¥)

ä½¿ç”¨allow_failure:  
build âœ… â†’ code_quality âš ï¸ â†’ deploy âœ… (PipelineæˆåŠŸï¼Œä½†æœ‰è­¦å‘Š)
```

### 6.3 retryå¤±è´¥é‡è¯•


**ğŸ”¸ è‡ªåŠ¨é‡è¯•æœºåˆ¶**

ç½‘ç»œé—®é¢˜æˆ–ä¸´æ—¶æ•…éšœå¯èƒ½å¯¼è‡´Jobå¤±è´¥ï¼Œè¿™æ—¶è‡ªåŠ¨é‡è¯•å¾ˆæœ‰ç”¨ï¼š

```yaml
# åŸºç¡€é‡è¯•é…ç½®
deploy_to_server:
  stage: deploy
  script:
    - scp files server:/path/
    - ssh server 'restart_service'
  retry: 2    # å¤±è´¥åæœ€å¤šé‡è¯•2æ¬¡

# é«˜çº§é‡è¯•é…ç½®  
integration_test:
  stage: test
  script:
    - run_integration_tests.sh
  retry:
    max: 3                    # æœ€å¤šé‡è¯•3æ¬¡
    when:                     # åªåœ¨ç‰¹å®šæƒ…å†µä¸‹é‡è¯•
      - runner_system_failure # Runnerç³»ç»Ÿæ•…éšœ
      - stuck_or_timeout_failure # ä»»åŠ¡å¡ä½æˆ–è¶…æ—¶
```

**â±ï¸ é‡è¯•æ—¶é—´çº¿ç¤ºä¾‹**
```
ç¬¬1æ¬¡å°è¯•: âŒ ç½‘ç»œè¶…æ—¶ (30ç§’åé‡è¯•)
ç¬¬2æ¬¡å°è¯•: âŒ è¿æ¥å¤±è´¥ (30ç§’åé‡è¯•)  
ç¬¬3æ¬¡å°è¯•: âœ… æˆåŠŸå®Œæˆ
```

### 6.4 whenæ¡ä»¶æ§åˆ¶


**ğŸ”¸ æ§åˆ¶Jobä½•æ—¶æ‰§è¡Œ**

```yaml
# æ€»æ˜¯æ‰§è¡Œçš„æ¸…ç†ä»»åŠ¡
cleanup_temp_files:
  stage: cleanup
  script:
    - rm -rf /tmp/build_*
  when: always        # æ— è®ºæˆåŠŸå¤±è´¥éƒ½æ‰§è¡Œ

# åªåœ¨æˆåŠŸæ—¶æ‰§è¡Œ  
success_notification:
  stage: notify
  script:
    - send_success_email.sh
  when: on_success    # åªåœ¨PipelineæˆåŠŸæ—¶æ‰§è¡Œ

# åªåœ¨å¤±è´¥æ—¶æ‰§è¡Œ
failure_notification:
  stage: notify  
  script:
    - send_failure_alert.sh
  when: on_failure    # åªåœ¨Pipelineå¤±è´¥æ—¶æ‰§è¡Œ
    
# æ‰‹åŠ¨è§¦å‘
manual_deploy:
  stage: deploy
  script:
    - deploy_to_production.sh
  when: manual        # éœ€è¦æ‰‹åŠ¨ç‚¹å‡»æ‰æ‰§è¡Œ
```

---

## 7. â¸ï¸ interruptibleä¸­æ–­é…ç½®


### 7.1 ä»€ä¹ˆæ˜¯interruptible


**ğŸ”¸ ä¸­æ–­æœºåˆ¶çš„ä½œç”¨**

`interruptible`æ§åˆ¶å½“æœ‰æ–°çš„Pipelineå¯åŠ¨æ—¶ï¼Œ**æ­£åœ¨è¿è¡Œçš„Pipelineæ˜¯å¦å¯ä»¥è¢«ä¸­æ–­**ã€‚

**ğŸ’¡ ç”Ÿæ´»ç±»æ¯”**
æƒ³è±¡ä½ åœ¨**æ’é˜Ÿç­‰ç”µæ¢¯**ï¼š
- `interruptible: true`: åƒæ˜¯æ™®é€šé˜Ÿåˆ—ï¼Œæœ‰æ€¥äº‹çš„äººå¯ä»¥æ’é˜Ÿ
- `interruptible: false`: åƒæ˜¯VIPé€šé“ï¼Œä¸€æ—¦å¼€å§‹å°±ä¸èƒ½è¢«æ‰“æ–­

### 7.2 é»˜è®¤ä¸­æ–­è¡Œä¸º


**ğŸ”¸ GitLabçš„é»˜è®¤è§„åˆ™**

```yaml
# é»˜è®¤æƒ…å†µä¸‹ï¼Œå¤§éƒ¨åˆ†Jobéƒ½æ˜¯å¯ä¸­æ–­çš„
build_job:
  script:
    - npm run build
  # interruptible: true (é»˜è®¤å€¼)

# å½“æ–°çš„commitæ¨é€æ—¶ï¼š
# 1. æ—§çš„Pipelineä¼šè¢«æ ‡è®°ä¸º"canceled"  
# 2. æ–°çš„Pipelineå¼€å§‹æ‰§è¡Œ
# 3. èŠ‚çœRunnerèµ„æº
```

**ğŸ“Š ä¸­æ–­åœºæ™¯ç¤ºä¾‹**
```
æ—¶é—´çº¿ï¼š
10:00 - æäº¤Aè§¦å‘Pipeline Aå¼€å§‹æ‰§è¡Œ
10:05 - æäº¤Bè§¦å‘Pipeline B  
        â†’ Pipeline Aè¢«ä¸­æ–­ âŒ
        â†’ Pipeline Bå¼€å§‹æ‰§è¡Œ â–¶ï¸
```

### 7.3 ç¦ç”¨ä¸­æ–­çš„åœºæ™¯


**ğŸ”¸ å…³é”®ä»»åŠ¡ä¸å¯ä¸­æ–­**

æŸäº›ä»»åŠ¡ä¸€æ—¦å¼€å§‹å°±ä¸åº”è¯¥è¢«ä¸­æ–­ï¼Œæ¯”å¦‚**éƒ¨ç½²ä»»åŠ¡**ï¼š

```yaml
# éƒ¨ç½²ä»»åŠ¡ - ä¸èƒ½è¢«ä¸­æ–­
deploy_to_production:
  stage: deploy
  script:
    - echo "å¼€å§‹éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ"
    - kubectl apply -f deployment.yaml
    - kubectl rollout status deployment/app
  interruptible: false    # éƒ¨ç½²è¿‡ç¨‹ä¸èƒ½è¢«ä¸­æ–­
  
# æ•°æ®åº“è¿ç§» - ä¸èƒ½è¢«ä¸­æ–­  
database_migration:
  stage: migrate
  script:
    - run_database_migration.sh
  interruptible: false    # æ•°æ®åº“æ“ä½œä¸èƒ½è¢«ä¸­æ–­

# æ™®é€šæ„å»º - å¯ä»¥è¢«ä¸­æ–­
build_application:
  stage: build  
  script:
    - npm run build
  interruptible: true     # å¯ä»¥è¢«æ–°çš„æ„å»ºä¸­æ–­
```

### 7.4 åˆç†ä½¿ç”¨ä¸­æ–­é…ç½®


**ğŸ”¸ æ¨èé…ç½®ç­–ç•¥**

| Jobç±»å‹ | **interruptibleè®¾ç½®** | **åŸå› è¯´æ˜** |
|---------|---------------------|-------------|
| ğŸ—ï¸ **æ„å»ºä»»åŠ¡** | `true` | `å¯ä»¥è¢«ä¸­æ–­ï¼ŒèŠ‚çœèµ„æº` |
| ğŸ§ª **æµ‹è¯•ä»»åŠ¡** | `true` | `æ–°ä»£ç çš„æµ‹è¯•æ›´é‡è¦` |
| ğŸš€ **éƒ¨ç½²ä»»åŠ¡** | `false` | `éƒ¨ç½²è¿‡ç¨‹ä¸èƒ½è¢«æ‰“æ–­` |
| ğŸ—ƒï¸ **æ•°æ®åº“æ“ä½œ** | `false` | `æ•°æ®ä¸€è‡´æ€§å¾ˆé‡è¦` |
| ğŸ“§ **é€šçŸ¥ä»»åŠ¡** | `true` | `å¯ä»¥è¢«ä¸­æ–­` |
| ğŸ§¹ **æ¸…ç†ä»»åŠ¡** | `false` | `æ¸…ç†è¿‡ç¨‹åº”è¯¥å®Œæ•´` |

**âœ… æœ€ä½³å®è·µ**
```yaml
stages:
  - build
  - test  
  - deploy
  - cleanup

# å¯ä¸­æ–­çš„ä»»åŠ¡
quick_build:
  stage: build
  script: ["npm run build"]
  interruptible: true

# ä¸å¯ä¸­æ–­çš„å…³é”®ä»»åŠ¡
production_deploy:
  stage: deploy
  script: ["deploy_script.sh"]  
  interruptible: false
  only:
    - main
    
# æ¸…ç†ä»»åŠ¡é€šå¸¸ä¹Ÿä¸åº”è¯¥è¢«ä¸­æ–­
cleanup_resources:
  stage: cleanup
  script: ["cleanup.sh"]
  interruptible: false
  when: always
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 Pipelineæ‰§è¡Œçš„æ ¸å¿ƒåŸç†


**ğŸ”¸ å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ**
```
ğŸ¯ æ‰§è¡Œé¡ºåº: StageæŒ‰é¡ºåºï¼ŒJobå¯å¹¶è¡Œ
ğŸ”— ä¾èµ–å…³ç³»: dependenciesæ§åˆ¶äº§ç‰©ä¾èµ–ï¼Œneedsæ§åˆ¶æ‰§è¡Œä¾èµ–  
ğŸš¨ å¤±è´¥å¤„ç†: allow_failureå…è®¸å®¹é”™ï¼Œretryæä¾›é‡è¯•æœºåˆ¶
â¸ï¸ ä¸­æ–­æ§åˆ¶: interruptibleæ§åˆ¶æ˜¯å¦å¯è¢«æ–°Pipelineä¸­æ–­
```

### 8.2 å…³é”®é…ç½®å¯¹æ¯”


| é…ç½®é¡¹ | **ä½œç”¨** | **é€‚ç”¨åœºæ™¯** | **æ³¨æ„äº‹é¡¹** |
|--------|---------|-------------|-------------|
| `stages` | `æ§åˆ¶å¤§çš„æ‰§è¡Œé¡ºåº` | `æ ‡å‡†æµæ°´çº¿` | `ç²—ç²’åº¦æ§åˆ¶` |
| `dependencies` | `æ§åˆ¶äº§ç‰©ä¾èµ–` | `éœ€è¦ç‰¹å®šæ–‡ä»¶` | `åªå½±å“artifacts` |
| `needs` | `ç²¾ç¡®æ§åˆ¶æ‰§è¡Œä¾èµ–` | `ä¼˜åŒ–æ‰§è¡Œæ—¶é—´` | `é¿å…å¾ªç¯ä¾èµ–` |
| `allow_failure` | `å…è®¸å¤±è´¥ç»§ç»­` | `éå…³é”®ä»»åŠ¡` | `ä»ä¼šæ˜¾ç¤ºè­¦å‘Š` |
| `retry` | `å¤±è´¥è‡ªåŠ¨é‡è¯•` | `ç½‘ç»œæˆ–ä¸´æ—¶æ•…éšœ` | `è®¾ç½®åˆç†æ¬¡æ•°` |
| `interruptible` | `æ§åˆ¶æ˜¯å¦å¯ä¸­æ–­` | `å…³é”®ä»»åŠ¡ä¿æŠ¤` | `å½±å“èµ„æºä½¿ç”¨` |

### 8.3 å®é™…åº”ç”¨å»ºè®®


**ğŸ”¹ å¿«é€Ÿä¼˜åŒ–Pipelineæ€§èƒ½**
1. **è¯†åˆ«ç“¶é¢ˆ**: æ‰¾å‡ºæœ€æ…¢çš„Job
2. **åˆç†å¹¶è¡Œ**: åŒé˜¶æ®µå†…å¢åŠ å¹¶è¡Œä»»åŠ¡
3. **ä½¿ç”¨needs**: å‡å°‘ä¸å¿…è¦çš„ç­‰å¾…æ—¶é—´
4. **å®¹é”™å¤„ç†**: éå…³é”®ä»»åŠ¡ä½¿ç”¨`allow_failure`

**ğŸ”¹ ä¿è¯Pipelineç¨³å®šæ€§**  
1. **å…³é”®ä»»åŠ¡ä¿æŠ¤**: éƒ¨ç½²ç­‰æ“ä½œè®¾ç½®`interruptible: false`
2. **é‡è¯•æœºåˆ¶**: ç½‘ç»œç›¸å…³ä»»åŠ¡é…ç½®`retry`
3. **æ¸…ç†ä»»åŠ¡**: ç¡®ä¿èµ„æºæ¸…ç†ä»»åŠ¡æ€»æ˜¯æ‰§è¡Œ

**ğŸ”¹ æ–°æ‰‹å¸¸çŠ¯é”™è¯¯**
- âŒ æ‰€æœ‰Jobéƒ½æ”¾åœ¨ä¸€ä¸ªStageé‡Œ
- âŒ è¿‡åº¦ä½¿ç”¨needsåˆ›å»ºå¤æ‚ä¾èµ–
- âŒ å¿˜è®°è®¾ç½®å…³é”®ä»»åŠ¡ä¸ºä¸å¯ä¸­æ–­
- âŒ æ²¡æœ‰ä¸ºä¸ç¨³å®šçš„Jobé…ç½®é‡è¯•

### 8.4 å­¦ä¹ æ£€æŸ¥æ¸…å•


**ğŸ“ˆ æŒæ¡ç¨‹åº¦è‡ªæµ‹**
- [ ] èƒ½è§£é‡ŠPipelineã€Stageã€Jobçš„å…³ç³»
- [ ] ä¼šä½¿ç”¨needsä¼˜åŒ–æ‰§è¡Œæ—¶é—´
- [ ] ç†è§£dependencieså’Œneedsçš„åŒºåˆ«
- [ ] ä¼šé…ç½®å¤±è´¥å¤„ç†å’Œé‡è¯•æœºåˆ¶
- [ ] çŸ¥é“ä½•æ—¶ä½¿ç”¨interruptibleé…ç½®

**ğŸ”— æ‰©å±•å­¦ä¹ æ–¹å‘**
- ğŸ¯ è¿›é˜¶: [Pipelineå˜é‡å’Œç¯å¢ƒ](#pipelineå˜é‡)
- ğŸ¯ å®æˆ˜: [å¤šç¯å¢ƒéƒ¨ç½²ç­–ç•¥](#å¤šç¯å¢ƒéƒ¨ç½²)  
- ğŸ¯ ä¼˜åŒ–: [Runnerèµ„æºç®¡ç†](#runnerç®¡ç†)

**ğŸ§  è®°å¿†å£è¯€**
```
Pipelineæ‰§è¡Œæœ‰ç« æ³•ï¼Œ
Stageé¡ºåºJobå¹¶å‘ã€‚
needsè·³é˜¶æ®µå¿«å¦‚é£ï¼Œ
å¤±è´¥é‡è¯•ä¸ç”¨æ„ã€‚
å…³é”®ä»»åŠ¡é˜²ä¸­æ–­ï¼Œ
ä¾èµ–å…³ç³»ç†æ¸…æ¥šã€‚
```