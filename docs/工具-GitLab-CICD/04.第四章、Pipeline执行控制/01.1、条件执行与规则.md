---
title: 1ã€æ¡ä»¶æ‰§è¡Œä¸è§„åˆ™
---
## ğŸ“š ç›®å½•

1. [æ¡ä»¶æ‰§è¡ŒåŸºç¡€æ¦‚å¿µ](#1-æ¡ä»¶æ‰§è¡ŒåŸºç¡€æ¦‚å¿µ)
2. [onlyæ¡ä»¶è§¦å‘æœºåˆ¶](#2-onlyæ¡ä»¶è§¦å‘æœºåˆ¶)
3. [exceptæ’é™¤æ¡ä»¶](#3-exceptæ’é™¤æ¡ä»¶)
4. [rulesè§„åˆ™è¯­æ³•è¯¦è§£](#4-rulesè§„åˆ™è¯­æ³•è¯¦è§£)
5. [workflowå·¥ä½œæµæ§åˆ¶](#5-workflowå·¥ä½œæµæ§åˆ¶)
6. [è§¦å‘ç­–ç•¥å®æˆ˜åº”ç”¨](#6-è§¦å‘ç­–ç•¥å®æˆ˜åº”ç”¨)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ æ¡ä»¶æ‰§è¡ŒåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Pipelineæ‰§è¡Œæ§åˆ¶


**ç®€å•ç†è§£**ï¼šå°±åƒç”Ÿæ´»ä¸­çš„å¼€å…³æ§åˆ¶ï¼ŒPipelineæ‰§è¡Œæ§åˆ¶å†³å®šäº†ä»€ä¹ˆæ—¶å€™è¿è¡Œä»»åŠ¡ï¼Œä»€ä¹ˆæ—¶å€™ä¸è¿è¡Œã€‚

```
ç”Ÿæ´»ä¸­çš„ä¾‹å­ï¼š
ğŸ”¸ åªæœ‰ä¸‹é›¨å¤©æ‰å¼€é›¨åˆ·å™¨ â†’ onlyæ¡ä»¶
ğŸ”¸ é™¤äº†å‘¨æœ«å…¶ä»–æ—¶é—´éƒ½ä¸Šç­ â†’ exceptæ¡ä»¶  
ğŸ”¸ å¦‚æœæ˜¯VIPå®¢æˆ·å°±èµ°ç»¿è‰²é€šé“ â†’ rulesè§„åˆ™
ğŸ”¸ æ•´ä¸ªæµç¨‹çš„å¯åŠ¨å¼€å…³ â†’ workflowæ§åˆ¶
```

**æ ¸å¿ƒä½œç”¨**ï¼š
- **èŠ‚çœèµ„æº**ï¼šä¸å¿…è¦çš„ä»»åŠ¡ä¸è¿è¡Œï¼Œçœé’±çœæ—¶é—´
- **ç²¾ç¡®æ§åˆ¶**ï¼šåªåœ¨éœ€è¦çš„æ—¶å€™è¿è¡Œç‰¹å®šä»»åŠ¡
- **æé«˜æ•ˆç‡**ï¼šé¿å…æ— ç”¨çš„æ„å»ºå’Œéƒ¨ç½²
- **çµæ´»ç®¡ç†**ï¼šæ ¹æ®ä¸åŒæƒ…å†µæ‰§è¡Œä¸åŒç­–ç•¥

### 1.2 æ‰§è¡Œæ§åˆ¶çš„å‘å±•å†ç¨‹


**æŠ€æœ¯æ¼”è¿›**ï¼š
```
GitLab CIæ—©æœŸï¼šonly/exceptï¼ˆç®€å•ç²—æš´ï¼‰
       â†“
GitLab 12.3+ï¼šrulesè¯­æ³•ï¼ˆæ›´ç²¾ç»†ï¼‰
       â†“  
ç°åœ¨æ¨èï¼šrules + workflowï¼ˆæœ€çµæ´»ï¼‰
```

**ä¸ºä»€ä¹ˆè¦å­¦ä¹ **ï¼š
- `only/except`ï¼šè€é¡¹ç›®è¿˜åœ¨ç”¨ï¼Œå¿…é¡»äº†è§£
- `rules`ï¼šæ–°é¡¹ç›®æ¨èï¼ŒåŠŸèƒ½æ›´å¼ºå¤§
- `workflow`ï¼šå…¨å±€æ§åˆ¶ï¼Œé…åˆä½¿ç”¨æ•ˆæœæ›´å¥½

---

## 2. ğŸ›ï¸ onlyæ¡ä»¶è§¦å‘æœºåˆ¶


### 2.1 onlyçš„åŸºæœ¬æ¦‚å¿µ


**é€šä¿—è§£é‡Š**ï¼š`only`å°±åƒä¸€ä¸ª**ç™½åå•**ï¼Œåªæœ‰æ»¡è¶³æ¡ä»¶çš„æƒ…å†µä¸‹ï¼ŒJobæ‰ä¼šè¿è¡Œã€‚

```yaml
# åŸºç¡€è¯­æ³•ç¤ºä¾‹
job_name:
  script:
    - echo "æ‰§è¡Œä»»åŠ¡"
  only:
    - master        # åªåœ¨masteråˆ†æ”¯è¿è¡Œ
    - develop       # åªåœ¨developåˆ†æ”¯è¿è¡Œ
```

### 2.2 åˆ†æ”¯è§¦å‘æ§åˆ¶


**ğŸ”¸ å•åˆ†æ”¯è§¦å‘**
```yaml
deploy_production:
  script:
    - echo "éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ"
  only:
    - master    # åªæœ‰masteråˆ†æ”¯çš„æäº¤æ‰è§¦å‘
```

**ğŸ”¸ å¤šåˆ†æ”¯è§¦å‘**
```yaml
build_test:
  script:
    - npm run build
  only:
    - master
    - develop
    - /^feature\/.*$/    # æ­£åˆ™è¡¨è¾¾å¼ï¼šæ‰€æœ‰feature/å¼€å¤´çš„åˆ†æ”¯
```

**åˆ†æ”¯è§„åˆ™è¯´æ˜**ï¼š
| å†™æ³• | å«ä¹‰ | ç¤ºä¾‹ |
|------|------|------|
| `master` | å®Œå…¨åŒ¹é…åˆ†æ”¯å | åªåŒ¹é…masteråˆ†æ”¯ |
| `/^release\/.*$/` | æ­£åˆ™è¡¨è¾¾å¼åŒ¹é… | åŒ¹é…æ‰€æœ‰release/å¼€å¤´çš„åˆ†æ”¯ |
| `branches` | æ‰€æœ‰åˆ†æ”¯ | ä»»ä½•åˆ†æ”¯éƒ½è§¦å‘ |

### 2.3 è§¦å‘äº‹ä»¶ç±»å‹


**ğŸ“‹ å¸¸ç”¨è§¦å‘äº‹ä»¶**
```yaml
test_job:
  script:
    - npm test
  only:
    - pushes        # ä»£ç æ¨é€æ—¶è§¦å‘
    - merge_requests # åˆå¹¶è¯·æ±‚æ—¶è§¦å‘
    - tags          # æ‰“æ ‡ç­¾æ—¶è§¦å‘
    - web           # æ‰‹åŠ¨è§¦å‘
    - schedules     # å®šæ—¶ä»»åŠ¡è§¦å‘
```

**äº‹ä»¶ç±»å‹è¯¦è§£**ï¼š
```
ğŸ”¸ pushesï¼šæœ€å¸¸ç”¨ï¼Œæ¯æ¬¡git pushéƒ½è§¦å‘
ğŸ”¸ merge_requestsï¼šPR/MRåˆ›å»ºæˆ–æ›´æ–°æ—¶è§¦å‘
ğŸ”¸ tagsï¼šå‘å¸ƒç‰ˆæœ¬æ‰“tagæ—¶è§¦å‘
ğŸ”¸ webï¼šåœ¨GitLabç•Œé¢æ‰‹åŠ¨ç‚¹å‡»è¿è¡Œ
ğŸ”¸ schedulesï¼šå®šæ—¶ä»»åŠ¡ï¼Œæ¯”å¦‚æ¯å¤©å‡Œæ™¨è¿è¡Œ
ğŸ”¸ apiï¼šé€šè¿‡APIè°ƒç”¨è§¦å‘
```

### 2.4 å˜é‡æ¡ä»¶è§¦å‘


**ğŸ”¸ ç¯å¢ƒå˜é‡åˆ¤æ–­**
```yaml
deploy_staging:
  script:
    - deploy.sh staging
  only:
    variables:
      - $DEPLOY_ENV == "staging"    # åªæœ‰å½“ç¯å¢ƒå˜é‡ç­‰äºstagingæ—¶è§¦å‘
```

**ğŸ”¸ å¤æ‚å˜é‡æ¡ä»¶**
```yaml
complex_job:
  script:
    - echo "å¤æ‚æ¡ä»¶ä»»åŠ¡"
  only:
    variables:
      - $CI_COMMIT_REF_NAME == "master"     # åˆ†æ”¯æ˜¯master
      - $CUSTOM_VAR != "skip"               # è‡ªå®šä¹‰å˜é‡ä¸ç­‰äºskip
```

### 2.5 æ–‡ä»¶å˜åŒ–è§¦å‘


**ğŸ”¸ æŒ‡å®šæ–‡ä»¶å˜åŒ–**
```yaml
frontend_build:
  script:
    - npm run build
  only:
    changes:
      - "src/**/*"           # srcç›®å½•ä¸‹ä»»ä½•æ–‡ä»¶å˜åŒ–
      - "package.json"       # package.jsonæ–‡ä»¶å˜åŒ–
      - "*.js"              # æ ¹ç›®å½•ä¸‹jsæ–‡ä»¶å˜åŒ–
```

**æ–‡ä»¶è·¯å¾„è§„åˆ™**ï¼š
```
ğŸ”¸ "src/**/*"ï¼šsrcç›®å½•åŠæ‰€æœ‰å­ç›®å½•çš„æ–‡ä»¶
ğŸ”¸ "*.js"ï¼šå½“å‰ç›®å½•ä¸‹çš„jsæ–‡ä»¶
ğŸ”¸ "docs/*.md"ï¼šdocsç›®å½•ä¸‹çš„markdownæ–‡ä»¶
ğŸ”¸ "**/test/**"ï¼šä»»ä½•è·¯å¾„ä¸‹çš„testç›®å½•
```

---

## 3. ğŸš« exceptæ’é™¤æ¡ä»¶


### 3.1 exceptåŸºæœ¬æ¦‚å¿µ


**é€šä¿—è§£é‡Š**ï¼š`except`å°±åƒä¸€ä¸ª**é»‘åå•**ï¼Œæ»¡è¶³è¿™äº›æ¡ä»¶çš„æƒ…å†µä¸‹ï¼ŒJobä¸ä¼šè¿è¡Œã€‚

```yaml
# åŸºç¡€è¯­æ³•ç¤ºä¾‹
job_name:
  script:
    - echo "æ‰§è¡Œä»»åŠ¡"
  except:
    - master        # é™¤äº†masteråˆ†æ”¯ï¼Œå…¶ä»–éƒ½è¿è¡Œ
    - tags          # é™¤äº†æ‰“æ ‡ç­¾ï¼Œå…¶ä»–éƒ½è¿è¡Œ
```

### 3.2 exceptå®é™…åº”ç”¨


**ğŸ”¸ æ’é™¤ç‰¹å®šåˆ†æ”¯**
```yaml
test_job:
  script:
    - npm test
  except:
    - master                    # é™¤äº†masteråˆ†æ”¯
    - /^release\/.*$/          # é™¤äº†releaseåˆ†æ”¯
```

**ğŸ”¸ æ’é™¤ç‰¹å®šäº‹ä»¶**
```yaml
build_job:
  script:
    - npm run build
  except:
    - tags                     # é™¤äº†æ‰“æ ‡ç­¾çš„æ—¶å€™
    - schedules               # é™¤äº†å®šæ—¶ä»»åŠ¡
```

### 3.3 onlyä¸exceptçš„ç»„åˆä½¿ç”¨


**âš ï¸ é‡è¦è¯´æ˜**ï¼š`only`å’Œ`except`å¯ä»¥åŒæ—¶ä½¿ç”¨ï¼Œä½†è¦ç†è§£ä¼˜å…ˆçº§ã€‚

```yaml
deploy_job:
  script:
    - deploy.sh
  only:
    - branches                 # åªåœ¨åˆ†æ”¯æ¨é€æ—¶
  except:
    - master                  # ä½†æ’é™¤masteråˆ†æ”¯
# ç»“æœï¼šé™¤masterå¤–çš„æ‰€æœ‰åˆ†æ”¯æ¨é€éƒ½ä¼šè§¦å‘
```

**ç»„åˆé€»è¾‘**ï¼š
```
æœ€ç»ˆç»“æœ = onlyæ¡ä»¶ AND (NOT exceptæ¡ä»¶)

ä¾‹å­åˆ†æï¼š
only: [branches]           â†’ æ‰€æœ‰åˆ†æ”¯éƒ½ç¬¦åˆ
except: [master]           â†’ æ’é™¤masteråˆ†æ”¯  
æœ€ç»ˆç»“æœï¼šé™¤masterå¤–çš„æ‰€æœ‰åˆ†æ”¯
```

---

## 4. ğŸ“‹ rulesè§„åˆ™è¯­æ³•è¯¦è§£


### 4.1 ä¸ºä»€ä¹ˆè¦ç”¨rules


**ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜**ï¼š
```yaml
# è€æ–¹å¼ï¼šè¯­æ³•å¤æ‚ï¼Œä¸å¤Ÿçµæ´»
job:
  only:
    - master
    - /^feature\/.*$/
  except:
    variables:
      - $SKIP_BUILD == "true"
```

**rulesçš„ä¼˜åŠ¿**ï¼š
```yaml
# æ–°æ–¹å¼ï¼šé€»è¾‘æ¸…æ™°ï¼Œæ¡ä»¶ä¸°å¯Œ
job:
  rules:
    - if: '$SKIP_BUILD == "true"'
      when: never                    # å¦‚æœè¦è·³è¿‡ï¼Œæ°¸ä¸æ‰§è¡Œ
    - if: '$CI_COMMIT_REF_NAME == "master"'
      when: always                   # masteråˆ†æ”¯æ€»æ˜¯æ‰§è¡Œ
    - if: '$CI_COMMIT_REF_NAME =~ /^feature\/.*$/'
      when: manual                   # featureåˆ†æ”¯æ‰‹åŠ¨æ‰§è¡Œ
```

### 4.2 rulesåŸºæœ¬è¯­æ³•


**ğŸ”¸ æ ¸å¿ƒç»“æ„**
```yaml
job:
  rules:
    - if: "æ¡ä»¶è¡¨è¾¾å¼"
      when: always/never/manual/delayed    # ä½•æ—¶æ‰§è¡Œ
      allow_failure: true/false            # æ˜¯å¦å…è®¸å¤±è´¥
      variables:                           # å˜é‡è®¾ç½®
        VAR_NAME: "value"
```

**whené€‰é¡¹è¯´æ˜**ï¼š
| å€¼ | å«ä¹‰ | ä½¿ç”¨åœºæ™¯ |
|---|------|----------|
| `always` | æ€»æ˜¯æ‰§è¡Œ | å¿…é¡»è¿è¡Œçš„å…³é”®ä»»åŠ¡ |
| `never` | æ°¸ä¸æ‰§è¡Œ | å®Œå…¨è·³è¿‡æŸäº›æƒ…å†µ |
| `manual` | æ‰‹åŠ¨æ‰§è¡Œ | éœ€è¦äººå·¥ç¡®è®¤çš„ä»»åŠ¡ |
| `delayed` | å»¶è¿Ÿæ‰§è¡Œ | è®¾ç½®å»¶è¿Ÿæ—¶é—´åæ‰§è¡Œ |

### 4.3 æ¡ä»¶è¡¨è¾¾å¼è¯¦è§£


**ğŸ”¸ å˜é‡æ¯”è¾ƒ**
```yaml
job:
  rules:
    - if: '$CI_COMMIT_REF_NAME == "master"'        # ç­‰äº
    - if: '$CI_COMMIT_REF_NAME != "develop"'       # ä¸ç­‰äº
    - if: '$CI_PIPELINE_SOURCE == "push"'          # æ¨é€è§¦å‘
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'  # MRè§¦å‘
```

**ğŸ”¸ æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…**
```yaml
job:
  rules:
    - if: '$CI_COMMIT_REF_NAME =~ /^feature\/.*$/'    # åŒ¹é…pattern
    - if: '$CI_COMMIT_REF_NAME !~ /^hotfix\/.*$/'     # ä¸åŒ¹é…pattern
    - if: '$CI_COMMIT_MESSAGE =~ /\[skip ci\]/'       # æäº¤ä¿¡æ¯åŒ…å«skip ci
```

**ğŸ”¸ å˜é‡å­˜åœ¨æ€§åˆ¤æ–­**
```yaml
job:
  rules:
    - if: '$CUSTOM_VAR'                     # å˜é‡å­˜åœ¨ä¸”ä¸ä¸ºç©º
    - if: '$CUSTOM_VAR == null'             # å˜é‡ä¸å­˜åœ¨æˆ–ä¸ºç©º
```

### 4.4 å¤æ‚æ¡ä»¶ç»„åˆ


**ğŸ”¸ é€»è¾‘è¿ç®—ç¬¦**
```yaml
job:
  rules:
    # AND æ¡ä»¶ï¼ˆåŒæ—¶æ»¡è¶³ï¼‰
    - if: '$CI_COMMIT_REF_NAME == "master" && $DEPLOY_ENV == "production"'
      when: always
    
    # OR æ¡ä»¶ï¼ˆæ»¡è¶³å…¶ä¸€ï¼‰  
    - if: '$CI_COMMIT_REF_NAME == "master" || $CI_COMMIT_REF_NAME == "develop"'
      when: always
    
    # æ‹¬å·åˆ†ç»„
    - if: '($CI_COMMIT_REF_NAME == "master" || $CI_COMMIT_REF_NAME == "develop") && $SKIP_DEPLOY != "true"'
      when: always
```

### 4.5 æ–‡ä»¶å˜åŒ–è§„åˆ™


**ğŸ”¸ changesä¸rulesç»“åˆ**
```yaml
frontend_job:
  rules:
    - changes:
        - "src/**/*.js"
        - "src/**/*.vue"
        - "package.json"
      when: always
    - when: never      # æ–‡ä»¶æ²¡å˜åŒ–å°±ä¸æ‰§è¡Œ
```

**ğŸ”¸ å¤æ‚æ–‡ä»¶æ¡ä»¶**
```yaml
test_job:
  rules:
    - if: '$CI_COMMIT_REF_NAME == "master"'
      changes:
        - "tests/**/*"
      when: always
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - "src/**/*"
      when: manual
```

### 4.6 åŠ¨æ€å˜é‡è®¾ç½®


**ğŸ”¸ æ ¹æ®æ¡ä»¶è®¾ç½®ä¸åŒå˜é‡**
```yaml
deploy_job:
  rules:
    - if: '$CI_COMMIT_REF_NAME == "master"'
      variables:
        DEPLOY_ENV: "production"
        REPLICAS: "3"
      when: always
    - if: '$CI_COMMIT_REF_NAME == "develop"'  
      variables:
        DEPLOY_ENV: "staging"
        REPLICAS: "1"
      when: always
```

---

## 5. ğŸ”„ workflowå·¥ä½œæµæ§åˆ¶


### 5.1 workflowåŸºæœ¬æ¦‚å¿µ


**é€šä¿—ç†è§£**ï¼šå¦‚æœè¯´`rules`æ§åˆ¶å•ä¸ªJobï¼Œé‚£ä¹ˆ`workflow`å°±æ˜¯æ§åˆ¶æ•´ä¸ªPipelineçš„**æ€»å¼€å…³**ã€‚

```
ç±»æ¯”ç†è§£ï¼š
ğŸ”¸ workflowï¼šæ§åˆ¶æ•´ä¸ªå·¥å‚æ˜¯å¦å¼€å·¥
ğŸ”¸ job rulesï¼šæ§åˆ¶å·¥å‚é‡Œæ¯ä¸ªè½¦é—´æ˜¯å¦è¿è¡Œ
```

### 5.2 workflowåŸºç¡€è¯­æ³•


**ğŸ”¸ ç®€å•çš„å…¨å±€æ§åˆ¶**
```yaml
# å…¨å±€workflowè®¾ç½®
workflow:
  rules:
    - if: '$CI_COMMIT_MESSAGE =~ /\[skip ci\]/'
      when: never                           # æäº¤ä¿¡æ¯åŒ…å«[skip ci]å°±ä¸è¿è¡Œæ•´ä¸ªpipeline
    - if: '$CI_PIPELINE_SOURCE == "push"'   
      when: always                          # æ¨é€æ—¶æ€»æ˜¯è¿è¡Œ
    - when: never                          # å…¶ä»–æƒ…å†µéƒ½ä¸è¿è¡Œ

# ä¸‹é¢çš„jobsåªæœ‰åœ¨workflowå…è®¸çš„æƒ…å†µä¸‹æ‰ä¼šè€ƒè™‘è¿è¡Œ
build:
  script:
    - echo "æ„å»º"

test:
  script:
    - echo "æµ‹è¯•"
```

### 5.3 åˆ†æ”¯ç­–ç•¥æ§åˆ¶


**ğŸ”¸ åªåœ¨ç‰¹å®šåˆ†æ”¯è¿è¡ŒPipeline**
```yaml
workflow:
  rules:
    - if: '$CI_COMMIT_REF_NAME == "master"'
      when: always
    - if: '$CI_COMMIT_REF_NAME == "develop"'
      when: always  
    - if: '$CI_COMMIT_REF_NAME =~ /^release\/.*$/'
      when: always
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: always
    - when: never    # å…¶ä»–åˆ†æ”¯éƒ½ä¸è¿è¡Œ
```

### 5.4 ç¯å¢ƒå’Œäº‹ä»¶æ§åˆ¶


**ğŸ”¸ æ ¹æ®è§¦å‘æºæ§åˆ¶**
```yaml
workflow:
  rules:
    # æ¨é€åˆ°ä¸»åˆ†æ”¯
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_REF_NAME == "master"'
      when: always
    
    # åˆå¹¶è¯·æ±‚
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: always
    
    # å®šæ—¶ä»»åŠ¡
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: always
      
    # æ‰‹åŠ¨è§¦å‘
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: always
    
    - when: never
```

### 5.5 workflowä¸Job rulesçš„é…åˆ


**ğŸ”¸ ä¸¤å±‚æ§åˆ¶æœºåˆ¶**
```yaml
# ç¬¬ä¸€å±‚ï¼šworkflowæ§åˆ¶æ•´ä¸ªpipeline
workflow:
  rules:
    - if: '$CI_COMMIT_REF_NAME =~ /^(master|develop|release\/.*)$/'
      when: always
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: always  
    - when: never

# ç¬¬äºŒå±‚ï¼šJobçº§åˆ«çš„ç²¾ç»†æ§åˆ¶
build:
  script:
    - npm run build
  rules:
    - when: always    # workflowå…è®¸çš„å‰æä¸‹æ€»æ˜¯è¿è¡Œ

test:
  script:
    - npm test  
  rules:
    - if: '$CI_COMMIT_REF_NAME == "master"'
      when: always
    - when: manual    # å…¶ä»–æƒ…å†µéœ€è¦æ‰‹åŠ¨è§¦å‘

deploy:
  script:
    - deploy.sh
  rules:
    - if: '$CI_COMMIT_REF_NAME == "master"'
      when: manual    # ç”Ÿäº§éƒ¨ç½²éœ€è¦æ‰‹åŠ¨ç¡®è®¤
    - when: never
```

---

## 6. ğŸ¯ è§¦å‘ç­–ç•¥å®æˆ˜åº”ç”¨


### 6.1 æ ‡ç­¾è§¦å‘ç­–ç•¥


**ğŸ”¸ ç‰ˆæœ¬å‘å¸ƒæµç¨‹**
```yaml
# åªæœ‰æ‰“æ ‡ç­¾æ—¶æ‰è§¦å‘å‘å¸ƒ
release_job:
  script:
    - echo "å‘å¸ƒç‰ˆæœ¬ $CI_COMMIT_TAG"
    - docker build -t myapp:$CI_COMMIT_TAG .
    - docker push myapp:$CI_COMMIT_TAG
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'    # åªæœ‰v1.0.0æ ¼å¼çš„æ ‡ç­¾
      when: always
    - when: never
```

**ğŸ”¸ é¢„å‘å¸ƒç‰ˆæœ¬**
```yaml
# åŒºåˆ†æ­£å¼ç‰ˆæœ¬å’Œé¢„å‘å¸ƒç‰ˆæœ¬
stable_release:
  script:
    - echo "å‘å¸ƒç¨³å®šç‰ˆæœ¬"
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/'     # v1.0.0 æ­£å¼ç‰ˆ
      when: always
    - when: never

beta_release:
  script:
    - echo "å‘å¸ƒæµ‹è¯•ç‰ˆæœ¬"  
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+-beta\.\d+$/'  # v1.0.0-beta.1 æµ‹è¯•ç‰ˆ
      when: always
    - when: never
```

### 6.2 æ‰‹åŠ¨è§¦å‘é…ç½®


**ğŸ”¸ å±é™©æ“ä½œéœ€è¦æ‰‹åŠ¨ç¡®è®¤**
```yaml
deploy_production:
  script:
    - echo "éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ"
    - kubectl apply -f k8s/
  rules:
    - if: '$CI_COMMIT_REF_NAME == "master"'
      when: manual              # æ‰‹åŠ¨è§¦å‘
      allow_failure: false      # ä¸å…è®¸å¤±è´¥
  environment:
    name: production
```

**ğŸ”¸ å¯é€‰çš„ä¼˜åŒ–ä»»åŠ¡**
```yaml
performance_test:
  script:
    - echo "è¿è¡Œæ€§èƒ½æµ‹è¯•"
    - npm run test:performance
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: manual              # MRä¸­å¯é€‰è¿è¡Œ
      allow_failure: true       # å…è®¸å¤±è´¥ï¼Œä¸å½±å“æ•´ä¸ªpipeline
    - when: never
```

### 6.3 å®šæ—¶ä»»åŠ¡é…ç½®


**ğŸ”¸ å¤œé—´è‡ªåŠ¨åŒ–ä»»åŠ¡**
```yaml
# åœ¨GitLabé¡¹ç›®è®¾ç½®ä¸­é…ç½®å®šæ—¶ä»»åŠ¡ï¼Œæ¯”å¦‚æ¯å¤©å‡Œæ™¨2ç‚¹
nightly_build:
  script:
    - echo "å¤œé—´æ„å»º"
    - npm run build:full
    - npm run test:integration
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: always
    - when: never
```

**ğŸ”¸ å‘¨æœŸæ€§ç»´æŠ¤ä»»åŠ¡**
```yaml
weekly_cleanup:
  script:
    - echo "æ¸…ç†æ—§çš„Dockeré•œåƒ"
    - docker system prune -f
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $SCHEDULE_TYPE == "weekly"'
      when: always
    - when: never
```

### 6.4 å¤šç¯å¢ƒéƒ¨ç½²ç­–ç•¥


**ğŸ”¸ å®Œæ•´çš„å¤šç¯å¢ƒæµç¨‹**
```yaml
workflow:
  rules:
    - if: '$CI_COMMIT_REF_NAME =~ /^(master|develop|feature\/.*)$/'
      when: always
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: always
    - when: never

# æ„å»ºé˜¶æ®µï¼ˆæ‰€æœ‰åˆ†æ”¯éƒ½æ‰§è¡Œï¼‰
build:
  script:
    - npm run build
  rules:
    - when: always

# æµ‹è¯•é˜¶æ®µï¼ˆæ‰€æœ‰åˆ†æ”¯éƒ½æ‰§è¡Œï¼‰  
test:
  script:
    - npm test
  rules:
    - when: always

# éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒï¼ˆdevelopåˆ†æ”¯è‡ªåŠ¨ï¼Œfeatureåˆ†æ”¯æ‰‹åŠ¨ï¼‰
deploy_dev:
  script:
    - deploy.sh dev
  rules:
    - if: '$CI_COMMIT_REF_NAME == "develop"'
      when: always
    - if: '$CI_COMMIT_REF_NAME =~ /^feature\/.*$/'
      when: manual
    - when: never
  environment:
    name: development

# éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒï¼ˆåªæœ‰developåˆ†æ”¯ï¼Œæ‰‹åŠ¨è§¦å‘ï¼‰
deploy_staging:
  script:
    - deploy.sh staging
  rules:
    - if: '$CI_COMMIT_REF_NAME == "develop"'
      when: manual
    - when: never
  environment:
    name: staging

# éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼ˆåªæœ‰masteråˆ†æ”¯ï¼Œæ‰‹åŠ¨è§¦å‘ï¼‰
deploy_production:
  script:
    - deploy.sh production
  rules:
    - if: '$CI_COMMIT_REF_NAME == "master"'
      when: manual
      allow_failure: false
    - when: never
  environment:
    name: production
```

### 6.5 ç‰¹æ®Šæƒ…å†µå¤„ç†


**ğŸ”¸ è·³è¿‡CIçš„åœºæ™¯**
```yaml
workflow:
  rules:
    - if: '$CI_COMMIT_MESSAGE =~ /\[skip ci\]/'
      when: never
    - if: '$CI_COMMIT_MESSAGE =~ /\[ci skip\]/'  
      when: never
    - if: '$CI_COMMIT_MESSAGE =~ /\[no ci\]/'
      when: never
    - when: always
```

**ğŸ”¸ ç´§æ€¥ä¿®å¤æµç¨‹**
```yaml
hotfix_deploy:
  script:
    - echo "ç´§æ€¥ä¿®å¤éƒ¨ç½²"
    - deploy.sh production --hotfix
  rules:
    - if: '$CI_COMMIT_REF_NAME =~ /^hotfix\/.*$/ && $EMERGENCY == "true"'
      when: always
    - if: '$CI_COMMIT_REF_NAME =~ /^hotfix\/.*$/'
      when: manual
    - when: never
  environment:
    name: production
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ‰§è¡Œæ§åˆ¶æœ¬è´¨ï¼šå†³å®šä»€ä¹ˆæ—¶å€™è¿è¡Œä»€ä¹ˆä»»åŠ¡
ğŸ”¸ only/exceptï¼šè€è¯­æ³•ï¼Œç™½åå•/é»‘åå•é€»è¾‘
ğŸ”¸ rulesï¼šæ–°è¯­æ³•ï¼Œæ¡ä»¶æ›´çµæ´»ï¼Œé€»è¾‘æ›´æ¸…æ™°  
ğŸ”¸ workflowï¼šå…¨å±€æ§åˆ¶ï¼Œæ•´ä¸ªPipelineçš„æ€»å¼€å…³
ğŸ”¸ è§¦å‘ç­–ç•¥ï¼šåˆ†æ”¯ã€æ ‡ç­¾ã€æ‰‹åŠ¨ã€å®šæ—¶ç­‰ä¸åŒåœºæ™¯
```

### 7.2 è¯­æ³•é€‰æ‹©å»ºè®®


**ğŸ”¹ æ¨èä½¿ç”¨é¡ºåº**
```
1. æ–°é¡¹ç›®ï¼šç›´æ¥ç”¨ rules + workflow
2. è€é¡¹ç›®ï¼šé€æ­¥ä» only/except è¿ç§»åˆ° rules
3. å¤æ‚é¡¹ç›®ï¼šworkflow å…¨å±€æ§åˆ¶ + rules ç²¾ç»†æ§åˆ¶
```

**ğŸ”¹ å¸¸è§æ­é…æ¨¡å¼**
```yaml
# æ¨¡å¼1ï¼šç®€å•é¡¹ç›®
workflow:
  rules:
    - if: '$CI_COMMIT_REF_NAME == "master"'
      when: always
    - when: never

# æ¨¡å¼2ï¼šå¤šåˆ†æ”¯é¡¹ç›®  
workflow:
  rules:
    - if: '$CI_COMMIT_REF_NAME =~ /^(master|develop|feature\/.*)$/'
      when: always
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: always
    - when: never

# æ¨¡å¼3ï¼šå®Œå…¨æ‰‹åŠ¨æ§åˆ¶
workflow:
  rules:
    - when: always
    
jobs:
  rules:
    - when: manual
```

### 7.3 å®é™…åº”ç”¨æŒ‡å¯¼


**âœ… æœ€ä½³å®è·µ**
- **æ˜ç¡®åˆ†å·¥**ï¼šworkflowæ§åˆ¶å…¨å±€ï¼Œrulesæ§åˆ¶å…·ä½“Job
- **é€æ­¥æ”¶ç´§**ï¼šä»å®½æ¾æ¡ä»¶å¼€å§‹ï¼Œé€æ­¥åŠ å¼ºæ§åˆ¶
- **ç¯å¢ƒéš”ç¦»**ï¼šä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒè§¦å‘æ¡ä»¶
- **å®‰å…¨ç¬¬ä¸€**ï¼šç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å¿…é¡»æ‰‹åŠ¨ç¡®è®¤

**âŒ å¸¸è§é”™è¯¯**
- è¿‡åº¦å¤æ‚çš„æ¡ä»¶åˆ¤æ–­
- workflowå’Œrulesé€»è¾‘å†²çª
- å¿˜è®°è®¾ç½®é»˜è®¤çš„when: never
- æ²¡æœ‰è€ƒè™‘ç´§æ€¥æƒ…å†µçš„å¤„ç†æµç¨‹

### 7.4 è°ƒè¯•æŠ€å·§


**ğŸ”§ æ’æŸ¥é—®é¢˜çš„æ–¹æ³•**
```
1. æ£€æŸ¥ Pipeline é¡µé¢çš„ "Why didn't this run?" æç¤º
2. åœ¨ rules ä¸­æ·»åŠ  echo è¾“å‡ºå˜é‡å€¼è¿›è¡Œè°ƒè¯•
3. ä½¿ç”¨ GitLab çš„ Pipeline ç¼–è¾‘å™¨éªŒè¯è¯­æ³•
4. ä»ç®€å•æ¡ä»¶å¼€å§‹ï¼Œé€æ­¥æ·»åŠ å¤æ‚é€»è¾‘
```

**ğŸ” å¸¸ç”¨è°ƒè¯•å˜é‡**
```yaml
debug_job:
  script:
    - echo "åˆ†æ”¯å: $CI_COMMIT_REF_NAME"
    - echo "è§¦å‘æº: $CI_PIPELINE_SOURCE"  
    - echo "æäº¤ä¿¡æ¯: $CI_COMMIT_MESSAGE"
    - echo "æ ‡ç­¾: $CI_COMMIT_TAG"
  rules:
    - when: manual
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- Pipelineæ§åˆ¶æœ‰é—¨é“ï¼Œæ¡ä»¶è§¦å‘å¾ˆé‡è¦
- onlyç™½åå•ï¼Œexcepté»‘åå•ï¼Œrulesè§„åˆ™æ›´çµæ´»
- workflowæ˜¯æ€»å¼€å…³ï¼Œå…¨å±€æ§åˆ¶è¦è®°ä½
- åˆ†æ”¯æ ‡ç­¾å’Œæ‰‹åŠ¨ï¼Œä¸åŒåœºæ™¯ä¸åŒç”¨