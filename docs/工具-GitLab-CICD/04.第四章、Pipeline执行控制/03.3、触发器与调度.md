---
title: 3ã€è§¦å‘å™¨ä¸è°ƒåº¦
---
## ğŸ“š ç›®å½•

1. [è§¦å‘å™¨ä¸è°ƒåº¦æ¦‚è¿°](#1-è§¦å‘å™¨ä¸è°ƒåº¦æ¦‚è¿°)
2. [Pipelineå®šæ—¶è°ƒåº¦](#2-Pipelineå®šæ—¶è°ƒåº¦)
3. [æ‰‹åŠ¨è§¦å‘é…ç½®](#3-æ‰‹åŠ¨è§¦å‘é…ç½®)
4. [APIè§¦å‘æ–¹å¼](#4-APIè§¦å‘æ–¹å¼)
5. [Webhookè§¦å‘](#5-Webhookè§¦å‘)
6. [è·¨é¡¹ç›®è§¦å‘](#6-è·¨é¡¹ç›®è§¦å‘)
7. [triggerå…³é”®å­—ä½¿ç”¨](#7-triggerå…³é”®å­—ä½¿ç”¨)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ è§¦å‘å™¨ä¸è°ƒåº¦æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯Pipelineè§¦å‘


**é€šä¿—ç†è§£**ï¼šå°±åƒå®¶é‡Œçš„å®šæ—¶å™¨æˆ–è€…é¥æ§å™¨ä¸€æ ·ï¼ŒPipelineè§¦å‘å°±æ˜¯è®©CI/CDæµç¨‹åœ¨ç‰¹å®šæ—¶é—´æˆ–æ¡ä»¶ä¸‹è‡ªåŠ¨è¿è¡Œã€‚

```
æ—¥å¸¸ç”Ÿæ´»ç±»æ¯”ï¼š
ğŸ  å®šæ—¶å™¨ â†’ æ¯å¤©7ç‚¹å“é“ƒå«ä½ èµ·åºŠ  =  å®šæ—¶è°ƒåº¦
ğŸ® é¥æ§å™¨ â†’ æŒ‰ä¸‹æŒ‰é’®å¼€ç”µè§†      =  æ‰‹åŠ¨è§¦å‘  
ğŸ“± æ‰‹æœºé“ƒå£° â†’ æœ‰ç”µè¯è‡ªåŠ¨å“èµ·    =  äº‹ä»¶è§¦å‘
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦è§¦å‘æ§åˆ¶


**å®é™…åœºæ™¯éœ€æ±‚**ï¼š
- **å®šæœŸä»»åŠ¡**ï¼šæ¯å¤©å‡Œæ™¨è‡ªåŠ¨å¤‡ä»½æ•°æ®åº“
- **ç´§æ€¥ä¿®å¤**ï¼šå‘ç°bugéœ€è¦ç«‹å³æ‰‹åŠ¨è§¦å‘éƒ¨ç½²
- **åä½œå¼€å‘**ï¼šå…¶ä»–é¡¹ç›®å®Œæˆåè‡ªåŠ¨è§¦å‘å½“å‰é¡¹ç›®æ„å»º
- **å¤–éƒ¨é›†æˆ**ï¼šç¬¬ä¸‰æ–¹ç³»ç»Ÿé€šè¿‡APIè§¦å‘æˆ‘ä»¬çš„æµç¨‹

### 1.3 GitLabæ”¯æŒçš„è§¦å‘æ–¹å¼


```
è§¦å‘æ–¹å¼å…¨æ™¯å›¾ï¼š

ç”¨æˆ·æ“ä½œç±»ï¼š
â”œâ”€â”€ æ‰‹åŠ¨è§¦å‘ï¼šç‚¹å‡»æŒ‰é’®è¿è¡Œ
â”œâ”€â”€ ä»£ç æ¨é€ï¼šgit pushè‡ªåŠ¨è§¦å‘
â””â”€â”€ å®šæ—¶è°ƒåº¦ï¼šcronè¡¨è¾¾å¼æ§åˆ¶

ç³»ç»Ÿé›†æˆç±»ï¼š
â”œâ”€â”€ APIè§¦å‘ï¼šç¨‹åºè°ƒç”¨æ¥å£
â”œâ”€â”€ Webhookï¼šå¤–éƒ¨ç³»ç»Ÿå›è°ƒ
â””â”€â”€ è·¨é¡¹ç›®ï¼šé¡¹ç›®é—´è”åŠ¨
```

### 1.4 è§¦å‘æ§åˆ¶çš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ”¸ è§¦å‘æ¡ä»¶**
```
ä»€ä¹ˆæ—¶å€™è¿è¡Œï¼Ÿ
- æ—¶é—´æ¡ä»¶ï¼šæ¯å¤©ã€æ¯å‘¨ã€æ¯æœˆ
- äº‹ä»¶æ¡ä»¶ï¼šä»£ç å˜æ›´ã€APIè°ƒç”¨
- æ‰‹åŠ¨æ¡ä»¶ï¼šç”¨æˆ·ä¸»åŠ¨è§¦å‘
```

**ğŸ”¸ è§¦å‘ç›®æ ‡**
```
è¿è¡Œä»€ä¹ˆå†…å®¹ï¼Ÿ
- å®Œæ•´Pipelineï¼šæ‰€æœ‰é˜¶æ®µéƒ½æ‰§è¡Œ
- ç‰¹å®šJobï¼šåªè¿è¡ŒæŸä¸ªä»»åŠ¡
- ç‰¹å®šåˆ†æ”¯ï¼šæŒ‡å®šåˆ†æ”¯çš„ä»£ç 
```

**ğŸ”¸ è§¦å‘å‚æ•°**
```
æºå¸¦ä»€ä¹ˆä¿¡æ¯ï¼Ÿ
- ç¯å¢ƒå˜é‡ï¼šä¼ é€’é…ç½®å‚æ•°
- åˆ†æ”¯ä¿¡æ¯ï¼šæŒ‡å®šä»£ç ç‰ˆæœ¬
- ç”¨æˆ·ä¿¡æ¯ï¼šè®°å½•è§¦å‘äººå‘˜
```

---

## 2. â° Pipelineå®šæ—¶è°ƒåº¦


### 2.1 å®šæ—¶è°ƒåº¦åŸºæœ¬æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯å®šæ—¶è°ƒåº¦**ï¼šå°±åƒæ‰‹æœºé—¹é’Ÿä¸€æ ·ï¼Œè®©Pipelineåœ¨æŒ‡å®šæ—¶é—´è‡ªåŠ¨è¿è¡Œï¼Œæ— éœ€äººå·¥å¹²é¢„ã€‚

**å¸¸è§ä½¿ç”¨åœºæ™¯**ï¼š
- ğŸŒ™ **å¤œé—´æ„å»º**ï¼šå‡Œæ™¨2ç‚¹è‡ªåŠ¨æ„å»ºï¼Œé¿å¼€å·¥ä½œæ—¶é—´
- ğŸ“Š **æ—¥æŠ¥ç”Ÿæˆ**ï¼šæ¯å¤©æ—©ä¸Š8ç‚¹ç”Ÿæˆå‰ä¸€å¤©çš„æ•°æ®æŠ¥å‘Š  
- ğŸ”„ **å®šæœŸæµ‹è¯•**ï¼šæ¯å‘¨æœ«è¿è¡Œå®Œæ•´çš„å›å½’æµ‹è¯•
- ğŸ’¾ **æ•°æ®å¤‡ä»½**ï¼šæ¯å¤©å‡Œæ™¨è‡ªåŠ¨å¤‡ä»½æ•°æ®åº“

### 2.2 Cronè¡¨è¾¾å¼è¯¦è§£


**ä»€ä¹ˆæ˜¯Cronè¡¨è¾¾å¼**ï¼šä¸€ç§æ—¶é—´æ ¼å¼ï¼Œç”¨5ä¸ªæˆ–6ä¸ªå­—æ®µæè¿°å…·ä½“çš„æ—¶é—´ç‚¹ã€‚

```
Cronè¡¨è¾¾å¼æ ¼å¼ï¼š
åˆ† æ—¶ æ—¥ æœˆ å‘¨

å­—æ®µè¯´æ˜ï¼š
â”Œâ”€â”€ åˆ†é’Ÿ (0-59)
â”‚ â”Œâ”€â”€ å°æ—¶ (0-23)  
â”‚ â”‚ â”Œâ”€â”€ æ—¥æœŸ (1-31)
â”‚ â”‚ â”‚ â”Œâ”€â”€ æœˆä»½ (1-12)
â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€ æ˜ŸæœŸ (0-7, 0å’Œ7éƒ½è¡¨ç¤ºå‘¨æ—¥)
â”‚ â”‚ â”‚ â”‚ â”‚
* * * * *
```

**å¸¸ç”¨æ—¶é—´è¡¨è¾¾å¼ç¤ºä¾‹**ï¼š

| è¡¨è¾¾å¼ | **å«ä¹‰** | **ä½¿ç”¨åœºæ™¯** |
|--------|---------|-------------|
| `0 2 * * *` | `æ¯å¤©å‡Œæ™¨2ç‚¹` | `å¤œé—´æ„å»ºï¼Œä¸å½±å“ç™½å¤©å·¥ä½œ` |
| `0 9 * * 1` | `æ¯å‘¨ä¸€æ—©ä¸Š9ç‚¹` | `å‘¨æŠ¥ç”Ÿæˆï¼Œæ€»ç»“ä¸Šå‘¨å·¥ä½œ` |
| `0 0 1 * *` | `æ¯æœˆ1å·å‡Œæ™¨` | `æœˆåº¦æ•°æ®ç»Ÿè®¡å’Œå¤‡ä»½` |
| `*/15 * * * *` | `æ¯15åˆ†é’Ÿ` | `ç›‘æ§æ£€æŸ¥ï¼ŒåŠæ—¶å‘ç°é—®é¢˜` |
| `0 18 * * 1-5` | `å·¥ä½œæ—¥ä¸‹åˆ6ç‚¹` | `æ¯æ—¥æ„å»ºï¼Œå‡†å¤‡æ¬¡æ—¥å‘å¸ƒ` |

### 2.3 GitLabä¸­é…ç½®å®šæ—¶è°ƒåº¦


**ğŸ”§ Webç•Œé¢é…ç½®æ­¥éª¤**ï¼š

```
é…ç½®è·¯å¾„ï¼š
é¡¹ç›®é¦–é¡µ â†’ Settings â†’ CI/CD â†’ Schedules â†’ New schedule

å¿…å¡«ä¿¡æ¯ï¼š
ğŸ“ Description: è°ƒåº¦ä»»åŠ¡æè¿°ï¼ˆå¦‚ï¼šå¤œé—´è‡ªåŠ¨æ„å»ºï¼‰
â° Cron Syntax: æ—¶é—´è¡¨è¾¾å¼ï¼ˆå¦‚ï¼š0 2 * * *ï¼‰
ğŸŒ Time Zone: æ—¶åŒºé€‰æ‹©ï¼ˆå¦‚ï¼šAsia/Shanghaiï¼‰
ğŸ”„ Target Branch: ç›®æ ‡åˆ†æ”¯ï¼ˆå¦‚ï¼šmainï¼‰
```

**ğŸ“‹ é…ç½®ç¤ºä¾‹**ï¼š
```
ä»»åŠ¡åç§°ï¼šæ¯æ—¥è‡ªåŠ¨æ„å»º
æè¿°ï¼šEvery night build for production
Cronè¡¨è¾¾å¼ï¼š0 2 * * *
æ—¶åŒºï¼šAsia/Shanghai  
ç›®æ ‡åˆ†æ”¯ï¼šmain
æ˜¯å¦æ¿€æ´»ï¼šâœ… Active
```

### 2.4 `.gitlab-ci.yml`ä¸­çš„è°ƒåº¦é…ç½®


**ğŸ”¸ only/exceptè§„åˆ™**
```yaml
# åªåœ¨å®šæ—¶è°ƒåº¦æ—¶è¿è¡Œçš„ä»»åŠ¡
scheduled_backup:
  stage: deploy
  script:
    - echo "å¼€å§‹æ‰§è¡Œå®šæ—¶å¤‡ä»½..."
    - ./backup_database.sh
  only:
    - schedules  # åªåœ¨å®šæ—¶è°ƒåº¦æ—¶æ‰§è¡Œ

# æ’é™¤å®šæ—¶è°ƒåº¦çš„ä»»åŠ¡  
normal_test:
  stage: test
  script:
    - npm test
  except:
    - schedules  # å®šæ—¶è°ƒåº¦æ—¶ä¸æ‰§è¡Œ
```

**ğŸ”¸ rulesè¯­æ³•ï¼ˆæ¨èï¼‰**
```yaml
# ç°ä»£åŒ–çš„æ¡ä»¶æ§åˆ¶
scheduled_deployment:
  stage: deploy
  script:
    - echo "å®šæ—¶éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ"
    - kubectl apply -f production/
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: always
    - when: never  # å…¶ä»–æƒ…å†µä¸æ‰§è¡Œ

# åŒºåˆ†ä¸åŒçš„è°ƒåº¦ä»»åŠ¡
weekly_report:
  stage: report
  script:
    - python generate_weekly_report.py
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule" && $SCHEDULE_TYPE == "weekly"
```

### 2.5 è°ƒåº¦ä»»åŠ¡çš„å˜é‡ä¼ é€’


**ğŸ”¸ é¢„å®šä¹‰å˜é‡**
```yaml
show_schedule_info:
  script:
    - echo "æµæ°´çº¿æ¥æºï¼š$CI_PIPELINE_SOURCE"
    - echo "è°ƒåº¦IDï¼š$CI_PIPELINE_SCHEDULE_ID"  
    - echo "æ˜¯å¦å®šæ—¶è°ƒåº¦ï¼š$CI_SCHEDULE"
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
```

**ğŸ”¸ è‡ªå®šä¹‰è°ƒåº¦å˜é‡**
```
åœ¨Webç•Œé¢è®¾ç½®è°ƒåº¦æ—¶å¯æ·»åŠ å˜é‡ï¼š
DEPLOY_ENV = production
NOTIFICATION_EMAIL = admin@company.com
BACKUP_TYPE = full
```

```yaml
scheduled_task:
  script:
    - echo "éƒ¨ç½²ç¯å¢ƒï¼š$DEPLOY_ENV"
    - echo "é€šçŸ¥é‚®ç®±ï¼š$NOTIFICATION_EMAIL"
    - ./deploy.sh $DEPLOY_ENV
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
```

---

## 3. ğŸ–±ï¸ æ‰‹åŠ¨è§¦å‘é…ç½®


### 3.1 æ‰‹åŠ¨è§¦å‘çš„åº”ç”¨åœºæ™¯


**ä»€ä¹ˆæ—¶å€™éœ€è¦æ‰‹åŠ¨è§¦å‘**ï¼š
- ğŸš¨ **ç´§æ€¥ä¿®å¤**ï¼šå‘ç°ç”Ÿäº§bugï¼Œéœ€è¦ç«‹å³éƒ¨ç½²ä¿®å¤
- ğŸ§ª **æµ‹è¯•éªŒè¯**ï¼šæƒ³è¦æµ‹è¯•æŸä¸ªåŠŸèƒ½ï¼Œæ‰‹åŠ¨è¿è¡Œæµ‹è¯•æµç¨‹
- ğŸš€ **ç‰ˆæœ¬å‘å¸ƒ**ï¼šå‡†å¤‡å¥½æ–°ç‰ˆæœ¬ï¼Œæ‰‹åŠ¨è§¦å‘å‘å¸ƒæµç¨‹
- ğŸ”„ **é‡æ–°æ‰§è¡Œ**ï¼šä¹‹å‰çš„æµç¨‹å¤±è´¥äº†ï¼Œä¿®å¤åé‡æ–°è¿è¡Œ

### 3.2 when: manual åŸºç¡€ç”¨æ³•


**ğŸ”¸ åŸºæœ¬æ‰‹åŠ¨ä»»åŠ¡**
```yaml
# éœ€è¦æ‰‹åŠ¨ç‚¹å‡»æ‰ä¼šæ‰§è¡Œçš„éƒ¨ç½²ä»»åŠ¡
deploy_to_production:
  stage: deploy
  script:
    - echo "å¼€å§‹éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."
    - ./deploy_prod.sh
  when: manual  # è®¾ç½®ä¸ºæ‰‹åŠ¨è§¦å‘
  environment:
    name: production
```

**ğŸ”¸ å…è®¸å¤±è´¥çš„æ‰‹åŠ¨ä»»åŠ¡**
```yaml
optional_cleanup:
  stage: cleanup
  script:
    - echo "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
    - rm -rf /tmp/build_cache/*
  when: manual
  allow_failure: true  # å³ä½¿ä¸æ‰§è¡Œä¹Ÿä¸å½±å“PipelineæˆåŠŸ
```

### 3.3 æ‰‹åŠ¨è§¦å‘çš„é«˜çº§é…ç½®


**ğŸ”¸ æ¡ä»¶æ‰‹åŠ¨è§¦å‘**
```yaml
# åªåœ¨ä¸»åˆ†æ”¯å…è®¸æ‰‹åŠ¨éƒ¨ç½²
manual_deploy:
  stage: deploy
  script:
    - ./deploy.sh
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
    - when: never  # å…¶ä»–åˆ†æ”¯ä¸æ˜¾ç¤ºæ­¤æŒ‰é’®
```

**ğŸ”¸ å¸¦ç¡®è®¤çš„æ‰‹åŠ¨è§¦å‘**
```yaml
dangerous_cleanup:
  stage: cleanup
  script:
    - echo "âš ï¸ æ³¨æ„ï¼šå°†åˆ é™¤æ‰€æœ‰æµ‹è¯•æ•°æ®ï¼"
    - ./cleanup_test_data.sh
  when: manual
  environment:
    name: test
    action: stop  # æ ‡è®°ä¸ºåœæ­¢ç¯å¢ƒçš„æ“ä½œ
```

### 3.4 æ‰‹åŠ¨è§¦å‘çš„ç•Œé¢æ“ä½œ


**ğŸ–±ï¸ åœ¨GitLabç•Œé¢ä¸­çš„æ“ä½œæ­¥éª¤**ï¼š

```
è§¦å‘è·¯å¾„ï¼š
é¡¹ç›®é¦–é¡µ â†’ CI/CD â†’ Pipelines â†’ é€‰æ‹©Pipeline â†’ ç‚¹å‡»æ‰‹åŠ¨ä»»åŠ¡çš„æ’­æ”¾æŒ‰é’®

ç•Œé¢æ˜¾ç¤ºï¼š
ğŸ“Š Pipelineå›¾è¡¨ä¸­æ‰‹åŠ¨ä»»åŠ¡æ˜¾ç¤ºä¸ºï¼šâ¸ï¸ æš‚åœçŠ¶æ€
ğŸ–±ï¸ ç‚¹å‡»æ’­æ”¾æŒ‰é’®ï¼šâ–¶ï¸ å¼€å§‹æ‰§è¡Œ  
ğŸ“ ä»»åŠ¡åç§°ï¼šdeploy_to_production (manual)
âš ï¸ è­¦å‘Šæç¤ºï¼šThis job requires manual action
```

### 3.5 æ‰‹åŠ¨è§¦å‘çš„æœ€ä½³å®è·µ


**ğŸ¯ åˆç†ä½¿ç”¨åŸåˆ™**ï¼š

> ğŸ’¡ **åŸåˆ™1**ï¼šé‡è¦æ“ä½œè®¾ä¸ºæ‰‹åŠ¨
> 
> ç”Ÿäº§éƒ¨ç½²ã€æ•°æ®åˆ é™¤ç­‰é«˜é£é™©æ“ä½œåº”è¯¥è®¾ä¸ºæ‰‹åŠ¨è§¦å‘ï¼Œé¿å…æ„å¤–æ‰§è¡Œ

> âš ï¸ **åŸåˆ™2**ï¼šæä¾›æ¸…æ™°è¯´æ˜  
> 
> æ‰‹åŠ¨ä»»åŠ¡è¦æœ‰æ˜ç¡®çš„åç§°å’Œæè¿°ï¼Œè®©æ“ä½œè€…çŸ¥é“è¿™ä¸ªæŒ‰é’®çš„ä½œç”¨

```yaml
# å¥½çš„å‘½åç¤ºä¾‹
deploy_to_production_manual:
  stage: deploy
  script:
    - echo "ğŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼ˆéœ€è¦ç®¡ç†å‘˜ç¡®è®¤ï¼‰"
    - ./production_deploy.sh
  when: manual
  environment:
    name: production
  only:
    - main
```

---

## 4. ğŸ”Œ APIè§¦å‘æ–¹å¼


### 4.1 APIè§¦å‘çš„åŸºæœ¬æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯APIè§¦å‘**ï¼šé€šè¿‡ç¼–ç¨‹æ–¹å¼è°ƒç”¨GitLabçš„APIæ¥å£æ¥å¯åŠ¨Pipelineï¼Œå°±åƒç”¨ç¨‹åº"æŒ‰ä¸‹"Pipelineçš„è¿è¡ŒæŒ‰é’®ã€‚

**å®é™…åº”ç”¨åœºæ™¯**ï¼š
- ğŸ¤– **è‡ªåŠ¨åŒ–ç³»ç»Ÿ**ï¼šç›‘æ§ç³»ç»Ÿå‘ç°é—®é¢˜åè‡ªåŠ¨è§¦å‘ä¿®å¤æµç¨‹
- ğŸ”— **ç¬¬ä¸‰æ–¹é›†æˆ**ï¼šå…¶ä»–ç³»ç»Ÿï¼ˆå¦‚JIRAã€Jenkinsï¼‰è§¦å‘GitLabæ„å»º
- ğŸ“± **ç§»åŠ¨ç«¯åº”ç”¨**ï¼šé€šè¿‡æ‰‹æœºAppè¿œç¨‹è§¦å‘éƒ¨ç½²
- âš¡ **æ‰¹é‡æ“ä½œ**ï¼šä¸€æ¬¡æ€§è§¦å‘å¤šä¸ªé¡¹ç›®çš„æ„å»º

### 4.2 åˆ›å»ºPipelineè§¦å‘ä»¤ç‰Œ


**ğŸ”‘ è·å–APIä»¤ç‰Œæ­¥éª¤**ï¼š

```
æ“ä½œè·¯å¾„ï¼š
é¡¹ç›®è®¾ç½® â†’ Settings â†’ CI/CD â†’ Pipeline triggers â†’ Add trigger

é…ç½®ä¿¡æ¯ï¼š
ğŸ“ Description: ä»¤ç‰Œç”¨é€”æè¿°ï¼ˆå¦‚ï¼šè‡ªåŠ¨åŒ–ç³»ç»Ÿè§¦å‘ï¼‰
ğŸ” Token: ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆï¼ˆå¦‚ï¼šglptt-xxx...ï¼‰
ğŸ‘¤ Owner: åˆ›å»ºè€…ä¿¡æ¯
```

**ğŸ”’ ä»¤ç‰Œå®‰å…¨ç®¡ç†**ï¼š
- âœ… **ä¸“ç”¨ä»¤ç‰Œ**ï¼šæ¯ä¸ªç”¨é€”åˆ›å»ºç‹¬ç«‹çš„ä»¤ç‰Œ
- âœ… **å®šæœŸè½®æ¢**ï¼šå®šæœŸæ›´æ–°ä»¤ç‰Œå¢å¼ºå®‰å…¨æ€§
- âœ… **æƒé™æ§åˆ¶**ï¼šåªç»™äºˆå¿…è¦çš„è®¿é—®æƒé™
- âŒ **é¿å…æ³„éœ²**ï¼šä¸è¦åœ¨ä»£ç ä¸­ç¡¬ç¼–ç ä»¤ç‰Œ

### 4.3 APIè°ƒç”¨æ–¹æ³•è¯¦è§£


**ğŸ”¸ åŸºç¡€APIè°ƒç”¨**
```bash
# æœ€ç®€å•çš„è§¦å‘æ–¹å¼
curl -X POST \
  --form token=glptt-your-token-here \
  --form ref=main \
  https://gitlab.example.com/api/v4/projects/PROJECT_ID/trigger/pipeline
```

**ğŸ”¸ æºå¸¦å˜é‡çš„APIè°ƒç”¨**
```bash
# ä¼ é€’ç¯å¢ƒå˜é‡
curl -X POST \
  --form token=glptt-your-token-here \
  --form ref=main \
  --form "variables[DEPLOY_ENV]=production" \
  --form "variables[VERSION]=v1.2.3" \
  --form "variables[NOTIFY_EMAIL]=admin@company.com" \
  https://gitlab.example.com/api/v4/projects/PROJECT_ID/trigger/pipeline
```

### 4.4 å®é™…åº”ç”¨ç¤ºä¾‹


**ğŸ”¸ Pythonè„šæœ¬ç¤ºä¾‹**
```python
import requests

def trigger_gitlab_pipeline(project_id, token, branch="main", variables=None):
    """
    è§¦å‘GitLab Pipeline
    
    Args:
        project_id: GitLabé¡¹ç›®ID
        token: è§¦å‘ä»¤ç‰Œ
        branch: ç›®æ ‡åˆ†æ”¯
        variables: ç¯å¢ƒå˜é‡å­—å…¸
    """
    url = f"https://gitlab.example.com/api/v4/projects/{project_id}/trigger/pipeline"
    
    data = {
        'token': token,
        'ref': branch
    }
    
    # æ·»åŠ è‡ªå®šä¹‰å˜é‡
    if variables:
        for key, value in variables.items():
            data[f'variables[{key}]'] = value
    
    response = requests.post(url, data=data)
    
    if response.status_code == 201:
        pipeline_info = response.json()
        print(f"âœ… Pipelineè§¦å‘æˆåŠŸï¼")
        print(f"ğŸ“Š Pipeline ID: {pipeline_info['id']}")
        print(f"ğŸ”— æŸ¥çœ‹åœ°å€: {pipeline_info['web_url']}")
        return pipeline_info
    else:
        print(f"âŒ è§¦å‘å¤±è´¥: {response.status_code}")
        print(f"ğŸ“ é”™è¯¯ä¿¡æ¯: {response.text}")
        return None

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    project_id = "123"
    token = "glptt-your-token-here"
    
    # è§¦å‘ç”Ÿäº§éƒ¨ç½²
    variables = {
        "DEPLOY_ENV": "production",
        "VERSION": "v2.1.0",
        "NOTIFICATION": "true"
    }
    
    trigger_gitlab_pipeline(project_id, token, "main", variables)
```

**ğŸ”¸ Shellè„šæœ¬ç¤ºä¾‹**
```bash
#!/bin/bash

# GitLab Pipelineè§¦å‘è„šæœ¬
PROJECT_ID="123"
TOKEN="glptt-your-token-here"
GITLAB_URL="https://gitlab.example.com"

# å‡½æ•°ï¼šè§¦å‘Pipeline
trigger_pipeline() {
    local branch=${1:-main}
    local env=${2:-staging}
    
    echo "ğŸš€ æ­£åœ¨è§¦å‘Pipeline..."
    echo "ğŸ“‚ é¡¹ç›®ID: $PROJECT_ID"
    echo "ğŸŒ¿ åˆ†æ”¯: $branch"
    echo "ğŸŒ ç¯å¢ƒ: $env"
    
    response=$(curl -s -X POST \
        --form token=$TOKEN \
        --form ref=$branch \
        --form "variables[DEPLOY_ENV]=$env" \
        --form "variables[TRIGGERED_BY]=automation_script" \
        $GITLAB_URL/api/v4/projects/$PROJECT_ID/trigger/pipeline)
    
    # æ£€æŸ¥å“åº”
    if echo $response | grep -q '"id"'; then
        pipeline_id=$(echo $response | grep -o '"id":[0-9]*' | cut -d':' -f2)
        echo "âœ… è§¦å‘æˆåŠŸï¼Pipeline ID: $pipeline_id"
        echo "ğŸ”— æŸ¥çœ‹åœ°å€: $GITLAB_URL/your-project/-/pipelines/$pipeline_id"
    else
        echo "âŒ è§¦å‘å¤±è´¥ï¼"
        echo "ğŸ“ å“åº”å†…å®¹: $response"
    fi
}

# ä½¿ç”¨ç¤ºä¾‹
trigger_pipeline "main" "production"
```

### 4.5 APIå“åº”å¤„ç†


**ğŸ”¸ æˆåŠŸå“åº”ç¤ºä¾‹**
```json
{
  "id": 12345,
  "iid": 67,
  "status": "pending",
  "ref": "main",
  "sha": "a1b2c3d4e5f6...",
  "web_url": "https://gitlab.example.com/project/-/pipelines/12345",
  "created_at": "2025-09-21T10:30:00.000Z",
  "updated_at": "2025-09-21T10:30:00.000Z"
}
```

**ğŸ”¸ é”™è¯¯å¤„ç†**
```python
def handle_api_response(response):
    """å¤„ç†APIå“åº”"""
    if response.status_code == 201:
        return "âœ… è§¦å‘æˆåŠŸ"
    elif response.status_code == 400:
        return "âŒ è¯·æ±‚å‚æ•°é”™è¯¯ï¼ˆæ£€æŸ¥ä»¤ç‰Œå’Œåˆ†æ”¯åï¼‰"
    elif response.status_code == 401:
        return "âŒ è®¤è¯å¤±è´¥ï¼ˆæ£€æŸ¥ä»¤ç‰Œæ˜¯å¦æ­£ç¡®ï¼‰"
    elif response.status_code == 403:
        return "âŒ æƒé™ä¸è¶³ï¼ˆæ£€æŸ¥ä»¤ç‰Œæƒé™ï¼‰"
    elif response.status_code == 404:
        return "âŒ é¡¹ç›®ä¸å­˜åœ¨ï¼ˆæ£€æŸ¥é¡¹ç›®IDï¼‰"
    else:
        return f"âŒ æœªçŸ¥é”™è¯¯: {response.status_code}"
```

---

## 5. ğŸ”— Webhookè§¦å‘


### 5.1 WebhookåŸºæœ¬æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯Webhook**ï¼šå¯ä»¥ç†è§£ä¸º"ç½‘ç»œç‰ˆçš„é—¨é“ƒ"ï¼Œå½“æŸä¸ªäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨"æŒ‰é“ƒé€šçŸ¥"GitLabæ‰§è¡Œç›¸åº”çš„Pipelineã€‚

**ç”Ÿæ´»åŒ–ç†è§£**ï¼š
```
ğŸ“ ç”µè¯é“ƒå£° â†’ æœ‰äººæ‰“ç”µè¯æ—¶è‡ªåŠ¨å“èµ·   = Webhooké€šçŸ¥
ğŸšª é—¨ç¦ç³»ç»Ÿ â†’ åˆ·å¡åè‡ªåŠ¨å¼€é—¨       = äº‹ä»¶è§¦å‘
ğŸ“§ é‚®ä»¶æé†’ â†’ æ”¶åˆ°é‚®ä»¶è‡ªåŠ¨å¼¹çª—     = å›è°ƒæœºåˆ¶
```

**å¸¸è§Webhookåœºæ™¯**ï¼š
- ğŸ›’ **ç”µå•†ç³»ç»Ÿ**ï¼šç”¨æˆ·ä¸‹å•åè‡ªåŠ¨è§¦å‘å‘è´§æµç¨‹
- ğŸ’¬ **å³æ—¶é€šè®¯**ï¼šä»£ç åˆå¹¶åè‡ªåŠ¨é€šçŸ¥å›¢é˜Ÿ
- ğŸ“Š **ç›‘æ§ç³»ç»Ÿ**ï¼šæœåŠ¡å¼‚å¸¸åè‡ªåŠ¨è§¦å‘ä¿®å¤è„šæœ¬
- ğŸ”„ **æ•°æ®åŒæ­¥**ï¼šå¤–éƒ¨æ•°æ®æ›´æ–°åè‡ªåŠ¨åŒæ­¥åˆ°ç³»ç»Ÿ

### 5.2 GitLab Webhooké…ç½®


**ğŸ”§ é…ç½®Webhookæ­¥éª¤**ï¼š

```
è®¾ç½®è·¯å¾„ï¼š
é¡¹ç›®è®¾ç½® â†’ Settings â†’ Webhooks â†’ Add new webhook

å…³é”®é…ç½®ï¼š
ğŸŒ URL: æ¥æ”¶é€šçŸ¥çš„åœ°å€ï¼ˆå¦‚ï¼šhttps://api.example.com/gitlab-webhookï¼‰
ğŸ” Secret Token: å®‰å…¨éªŒè¯ä»¤ç‰Œï¼ˆå¯é€‰ä½†æ¨èï¼‰
ğŸ“¡ Trigger Events: é€‰æ‹©è§¦å‘äº‹ä»¶ç±»å‹
âœ… SSL Verification: å¯ç”¨SSLéªŒè¯ï¼ˆæ¨èï¼‰
```

**ğŸ¯ å¸¸ç”¨è§¦å‘äº‹ä»¶**ï¼š

| äº‹ä»¶ç±»å‹ | **è§¦å‘æ—¶æœº** | **ä½¿ç”¨åœºæ™¯** |
|---------|-------------|-------------|
| `Push events` | `ä»£ç æ¨é€æ—¶` | `è‡ªåŠ¨æ„å»ºå’Œæµ‹è¯•` |
| `Merge request events` | `åˆ›å»º/æ›´æ–°MRæ—¶` | `ä»£ç å®¡æŸ¥æµç¨‹` |
| `Pipeline events` | `PipelineçŠ¶æ€å˜åŒ–` | `æ„å»ºç»“æœé€šçŸ¥` |
| `Release events` | `å‘å¸ƒæ–°ç‰ˆæœ¬æ—¶` | `è‡ªåŠ¨éƒ¨ç½²å‘å¸ƒ` |
| `Wiki page events` | `æ›´æ–°æ–‡æ¡£æ—¶` | `æ–‡æ¡£åŒæ­¥å¤„ç†` |

### 5.3 Webhookæ¥æ”¶ç«¯å®ç°


**ğŸ”¸ Python Flaskç¤ºä¾‹**
```python
from flask import Flask, request, jsonify
import hmac
import hashlib
import requests

app = Flask(__name__)
WEBHOOK_SECRET = "your-secret-token"
GITLAB_TOKEN = "glptt-your-trigger-token"
PROJECT_ID = "123"

@app.route('/gitlab-webhook', methods=['POST'])
def handle_webhook():
    """å¤„ç†GitLab Webhookè¯·æ±‚"""
    
    # éªŒè¯è¯·æ±‚æ¥æº
    if not verify_signature(request):
        return jsonify({"error": "Invalid signature"}), 401
    
    # è§£æè¯·æ±‚æ•°æ®
    data = request.get_json()
    event_type = request.headers.get('X-Gitlab-Event')
    
    print(f"ğŸ“¥ æ”¶åˆ°äº‹ä»¶: {event_type}")
    
    # æ ¹æ®äº‹ä»¶ç±»å‹å¤„ç†
    if event_type == "Push Hook":
        return handle_push_event(data)
    elif event_type == "Merge Request Hook":
        return handle_merge_request_event(data)
    elif event_type == "Pipeline Hook":
        return handle_pipeline_event(data)
    else:
        print(f"âš ï¸ æœªå¤„ç†çš„äº‹ä»¶ç±»å‹: {event_type}")
        return jsonify({"status": "ignored"}), 200

def verify_signature(request):
    """éªŒè¯Webhookç­¾å"""
    signature = request.headers.get('X-Gitlab-Token')
    return signature == WEBHOOK_SECRET

def handle_push_event(data):
    """å¤„ç†ä»£ç æ¨é€äº‹ä»¶"""
    branch = data['ref'].replace('refs/heads/', '')
    commits = data['commits']
    
    print(f"ğŸŒ¿ åˆ†æ”¯: {branch}")
    print(f"ğŸ“ æäº¤æ•°é‡: {len(commits)}")
    
    # åªåœ¨ä¸»åˆ†æ”¯æ¨é€æ—¶è§¦å‘
    if branch == 'main':
        trigger_response = trigger_pipeline(branch, {
            "TRIGGER_SOURCE": "webhook",
            "COMMIT_COUNT": str(len(commits))
        })
        
        if trigger_response:
            return jsonify({
                "status": "pipeline_triggered",
                "pipeline_id": trigger_response.get('id')
            }), 200
    
    return jsonify({"status": "no_action"}), 200

def trigger_pipeline(branch, variables):
    """è§¦å‘GitLab Pipeline"""
    url = f"https://gitlab.example.com/api/v4/projects/{PROJECT_ID}/trigger/pipeline"
    
    data = {
        'token': GITLAB_TOKEN,
        'ref': branch
    }
    
    for key, value in variables.items():
        data[f'variables[{key}]'] = value
    
    response = requests.post(url, data=data)
    return response.json() if response.status_code == 201 else None

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)
```

### 5.4 Webhookå®‰å…¨æ€§é…ç½®


**ğŸ”’ å®‰å…¨æœ€ä½³å®è·µ**ï¼š

> ğŸ” **ç­¾åéªŒè¯**
> 
> ä½¿ç”¨Secret TokenéªŒè¯è¯·æ±‚æ¥æºï¼Œé˜²æ­¢æ¶æ„è¯·æ±‚

```python
def verify_gitlab_signature(request_body, signature, secret):
    """éªŒè¯GitLab Webhookç­¾å"""
    expected_signature = hmac.new(
        secret.encode('utf-8'),
        request_body,
        hashlib.sha256
    ).hexdigest()
    
    return hmac.compare_digest(signature, expected_signature)
```

> ğŸŒ **IPç™½åå•**
> 
> é™åˆ¶åªæœ‰GitLabæœåŠ¡å™¨IPå¯ä»¥è®¿é—®Webhookç«¯ç‚¹

```nginx
# Nginxé…ç½®ç¤ºä¾‹
location /webhook {
    allow 192.168.1.100;  # GitLabæœåŠ¡å™¨IP
    deny all;
    proxy_pass http://webhook-handler;
}
```

### 5.5 Webhookè°ƒè¯•ä¸ç›‘æ§


**ğŸ” è°ƒè¯•å·¥å…·**ï¼š
- **GitLabç•Œé¢**ï¼šSettings â†’ Webhooks â†’ Recent Deliveries
- **æ—¥å¿—è®°å½•**ï¼šè®°å½•æ‰€æœ‰Webhookè¯·æ±‚å’Œå“åº”
- **æµ‹è¯•å·¥å…·**ï¼šä½¿ç”¨ngrokç­‰å·¥å…·æœ¬åœ°æµ‹è¯•

```python
import logging

# é…ç½®æ—¥å¿—
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

@app.route('/gitlab-webhook', methods=['POST'])
def handle_webhook():
    # è®°å½•è¯·æ±‚ä¿¡æ¯
    logger.info(f"ğŸ“¥ Webhookè¯·æ±‚: {request.headers.get('X-Gitlab-Event')}")
    logger.info(f"ğŸ“Š è¯·æ±‚å¤§å°: {len(request.data)} bytes")
    
    try:
        # å¤„ç†é€»è¾‘
        result = process_webhook(request)
        logger.info(f"âœ… å¤„ç†æˆåŠŸ: {result}")
        return result
    except Exception as e:
        logger.error(f"âŒ å¤„ç†å¤±è´¥: {str(e)}")
        return jsonify({"error": "Internal error"}), 500
```

---

## 6. ğŸ”„ è·¨é¡¹ç›®è§¦å‘


### 6.1 è·¨é¡¹ç›®è§¦å‘çš„åº”ç”¨åœºæ™¯


**ä»€ä¹ˆæ˜¯è·¨é¡¹ç›®è§¦å‘**ï¼šå°±åƒ"å¤šç±³è¯ºéª¨ç‰Œ"ä¸€æ ·ï¼Œä¸€ä¸ªé¡¹ç›®çš„Pipelineå®Œæˆåï¼Œè‡ªåŠ¨è§¦å‘å¦ä¸€ä¸ªé¡¹ç›®çš„Pipelineè¿è¡Œã€‚

**å®é™…ä¸šåŠ¡åœºæ™¯**ï¼š
- ğŸ“š **å¾®æœåŠ¡æ¶æ„**ï¼šåç«¯APIæ›´æ–°åï¼Œè‡ªåŠ¨è§¦å‘å‰ç«¯é¡¹ç›®é‡æ–°æ„å»º
- ğŸ”— **ä¾èµ–å…³ç³»**ï¼šåŸºç¡€åº“æ›´æ–°åï¼Œè§¦å‘æ‰€æœ‰ä½¿ç”¨è¯¥åº“çš„é¡¹ç›®æµ‹è¯•
- ğŸš€ **éƒ¨ç½²æµæ°´çº¿**ï¼šä»£ç æ„å»ºå®Œæˆåï¼Œè‡ªåŠ¨è§¦å‘éƒ¨ç½²é¡¹ç›®æ‰§è¡Œå‘å¸ƒ
- ğŸ“¦ **ç»„ä»¶å‘å¸ƒ**ï¼šç»„ä»¶åº“å‘ç‰ˆåï¼Œè§¦å‘ç¤ºä¾‹é¡¹ç›®æ›´æ–°æ¼”ç¤º

```
é¡¹ç›®ä¾èµ–å…³ç³»ç¤ºä¾‹ï¼š
åŸºç¡€ç»„ä»¶åº“ â†’ ä¸šåŠ¡ç»„ä»¶åº“ â†’ å‰ç«¯åº”ç”¨ â†’ é›†æˆæµ‹è¯•
     â†“           â†“          â†“         â†“
   æ„å»ºå®Œæˆ    è‡ªåŠ¨è§¦å‘    è‡ªåŠ¨è§¦å‘   è‡ªåŠ¨è§¦å‘
```

### 6.2 downstreamå…³é”®å­—åŸºç¡€ç”¨æ³•


**ğŸ”¸ åŸºæœ¬è¯­æ³•ç»“æ„**
```yaml
# è§¦å‘ä¸‹æ¸¸é¡¹ç›®çš„åŸºæœ¬é…ç½®
trigger_frontend:
  stage: deploy
  trigger:
    project: group/frontend-app  # ç›®æ ‡é¡¹ç›®è·¯å¾„
    branch: main                 # ç›®æ ‡åˆ†æ”¯
  only:
    - main  # åªåœ¨mainåˆ†æ”¯è§¦å‘
```

**ğŸ”¸ å¤šé¡¹ç›®åŒæ—¶è§¦å‘**
```yaml
# åŒæ—¶è§¦å‘å¤šä¸ªç›¸å…³é¡¹ç›®
trigger_multiple_projects:
  stage: trigger
  parallel:
    matrix:
      - PROJECT: ["group/web-app", "group/mobile-app", "group/api-tests"]
  trigger:
    project: ${PROJECT}
    branch: main
  only:
    - main
```

### 6.3 è·¨é¡¹ç›®å˜é‡ä¼ é€’


**ğŸ”¸ ä¼ é€’æ„å»ºä¿¡æ¯**
```yaml
trigger_deployment:
  stage: deploy
  trigger:
    project: ops/deployment-pipeline
    branch: main
  variables:
    # ä¼ é€’å½“å‰é¡¹ç›®çš„æ„å»ºä¿¡æ¯
    SOURCE_PROJECT: $CI_PROJECT_NAME
    SOURCE_COMMIT: $CI_COMMIT_SHA
    BUILD_VERSION: $CI_PIPELINE_ID
    DEPLOY_ENV: production
    DOCKER_IMAGE: registry.example.com/app:$CI_COMMIT_SHA
```

**ğŸ”¸ æ¡ä»¶å˜é‡ä¼ é€’**
```yaml
# æ ¹æ®åˆ†æ”¯ä¼ é€’ä¸åŒçš„ç¯å¢ƒå˜é‡
trigger_with_conditions:
  stage: trigger
  trigger:
    project: group/target-project
  variables:
    DEPLOY_ENV: $ENVIRONMENT
    NOTIFICATION_ENABLED: "true"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      variables:
        ENVIRONMENT: "production"
        AUTO_DEPLOY: "true"
    - if: $CI_COMMIT_BRANCH == "develop"  
      variables:
        ENVIRONMENT: "staging"
        AUTO_DEPLOY: "false"
```

### 6.4 è§¦å‘ç­–ç•¥é…ç½®


**ğŸ”¸ åŒæ­¥vså¼‚æ­¥è§¦å‘**
```yaml
# åŒæ­¥è§¦å‘ï¼šç­‰å¾…ä¸‹æ¸¸é¡¹ç›®å®Œæˆ
sync_trigger:
  stage: deploy
  trigger:
    project: group/deployment
    strategy: depend  # ç­‰å¾…ä¸‹æ¸¸é¡¹ç›®å®Œæˆ
  timeout: 1h

# å¼‚æ­¥è§¦å‘ï¼šè§¦å‘åä¸ç­‰å¾…
async_trigger:
  stage: deploy  
  trigger:
    project: group/notification
    # é»˜è®¤å°±æ˜¯å¼‚æ­¥ï¼Œè§¦å‘åç«‹å³ç»§ç»­
```

**ğŸ”¸ å¤±è´¥å¤„ç†ç­–ç•¥**
```yaml
# å…è®¸ä¸‹æ¸¸å¤±è´¥
optional_trigger:
  stage: optional
  trigger:
    project: group/optional-tests
  allow_failure: true  # ä¸‹æ¸¸å¤±è´¥ä¸å½±å“å½“å‰Pipeline

# å¿…é¡»æˆåŠŸçš„è§¦å‘
critical_trigger:
  stage: deploy
  trigger:
    project: group/critical-deployment
    strategy: depend
  # allow_failureé»˜è®¤ä¸ºfalseï¼Œä¸‹æ¸¸å¤±è´¥ä¼šå¯¼è‡´å½“å‰Pipelineå¤±è´¥
```

### 6.5 å®é™…åº”ç”¨ç¤ºä¾‹


**ğŸ”¸ å¾®æœåŠ¡æ›´æ–°æµç¨‹**
```yaml
# åç«¯APIé¡¹ç›®çš„.gitlab-ci.yml
stages:
  - build
  - test  
  - trigger

api_build:
  stage: build
  script:
    - docker build -t api:$CI_COMMIT_SHA .
    - docker push registry.example.com/api:$CI_COMMIT_SHA

api_test:
  stage: test
  script:
    - npm test
    - npm run integration-test

# è§¦å‘å‰ç«¯é¡¹ç›®æ›´æ–°
trigger_frontend:
  stage: trigger
  trigger:
    project: frontend/web-app
  variables:
    API_VERSION: $CI_COMMIT_SHA
    UPDATE_REASON: "API updated"
  only:
    - main

# è§¦å‘ç«¯åˆ°ç«¯æµ‹è¯•
trigger_e2e_tests:
  stage: trigger
  trigger:
    project: qa/e2e-tests
    strategy: depend  # ç­‰å¾…æµ‹è¯•å®Œæˆ
  variables:
    API_IMAGE: registry.example.com/api:$CI_COMMIT_SHA
    TEST_ENV: staging
  timeout: 30m
```

**ğŸ”¸ ç»„ä»¶åº“å‘å¸ƒæµç¨‹**
```yaml
# ç»„ä»¶åº“é¡¹ç›®
stages:
  - build
  - publish
  - notify

build_component:
  stage: build
  script:
    - npm run build
    - npm pack

publish_npm:
  stage: publish
  script:
    - npm publish
  only:
    - tags  # åªåœ¨å‘å¸ƒtagæ—¶æ‰§è¡Œ

# é€šçŸ¥æ‰€æœ‰ä½¿ç”¨è¯¥ç»„ä»¶çš„é¡¹ç›®
notify_consumers:
  stage: notify
  trigger:
    project: 
      - apps/admin-dashboard
      - apps/user-portal  
      - apps/mobile-app
  variables:
    COMPONENT_VERSION: $CI_COMMIT_TAG
    UPDATE_TYPE: component_update
  only:
    - tags
```

---

## 7. ğŸ›ï¸ triggerå…³é”®å­—ä½¿ç”¨


### 7.1 triggerå…³é”®å­—å®Œæ•´è¯­æ³•


**triggerå…³é”®å­—**æ˜¯GitLab CI/CDä¸­ç”¨äºè§¦å‘å…¶ä»–Pipelineçš„ä¸“ç”¨é…ç½®ï¼ŒåŠŸèƒ½å¼ºå¤§ä¸”çµæ´»ã€‚

```yaml
# triggerå…³é”®å­—çš„å®Œæ•´è¯­æ³•ç»“æ„
job_name:
  trigger:
    # åŸºæœ¬é…ç½®
    project: group/project-name    # ç›®æ ‡é¡¹ç›®ï¼ˆå¿…éœ€ï¼‰
    branch: main                   # ç›®æ ‡åˆ†æ”¯ï¼ˆå¯é€‰ï¼Œé»˜è®¤default branchï¼‰
    
    # é«˜çº§é…ç½®
    strategy: depend              # ç­‰å¾…ç­–ç•¥ï¼ˆå¯é€‰ï¼šdependï¼‰
    include:                      # åŒ…å«å¤–éƒ¨é…ç½®æ–‡ä»¶
      - local: path/to/file.yml
      - project: group/project
        file: .gitlab-ci.yml
        ref: main
        
    # å‰å‘å£°æ˜ï¼ˆç”¨äºå¤æ‚ä¾èµ–ï¼‰
    forward:
      yaml_variables: true
      pipeline_variables: true
```

### 7.2 includeé…ç½®è¯¦è§£


**ğŸ”¸ æœ¬åœ°æ–‡ä»¶åŒ…å«**
```yaml
# è§¦å‘æ—¶åŒ…å«æœ¬åœ°é…ç½®æ–‡ä»¶
trigger_with_local_config:
  trigger:
    project: group/target-project
    include:
      - local: configs/deployment.yml    # åŒ…å«æœ¬åœ°é…ç½®
      - local: configs/variables.yml     # åŒ…å«å˜é‡å®šä¹‰
```

**ğŸ”¸ è·¨é¡¹ç›®æ–‡ä»¶åŒ…å«**
```yaml
# ä½¿ç”¨å…¶ä»–é¡¹ç›®çš„é…ç½®æ–‡ä»¶
trigger_with_remote_config:
  trigger:
    project: group/deployment-project
    include:
      - project: shared/ci-templates     # å…±äº«é…ç½®é¡¹ç›®
        file: templates/deploy.yml       # å…·ä½“é…ç½®æ–‡ä»¶
        ref: v1.2.0                     # æŒ‡å®šç‰ˆæœ¬
```

### 7.3 å¤æ‚è§¦å‘åœºæ™¯é…ç½®


**ğŸ”¸ æ¡ä»¶è§¦å‘ç»„åˆ**
```yaml
# æ ¹æ®ä¸åŒæ¡ä»¶è§¦å‘ä¸åŒé¡¹ç›®
conditional_triggers:
  stage: trigger
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      variables:
        TARGET_PROJECT: "production/deployment"
        DEPLOY_TYPE: "production"
    - if: $CI_COMMIT_BRANCH == "develop"
      variables:
        TARGET_PROJECT: "staging/deployment"  
        DEPLOY_TYPE: "staging"
    - when: never
  trigger:
    project: $TARGET_PROJECT
  variables:
    DEPLOYMENT_TYPE: $DEPLOY_TYPE
    SOURCE_COMMIT: $CI_COMMIT_SHA
```

**ğŸ”¸ çŸ©é˜µè§¦å‘**
```yaml
# å¹¶è¡Œè§¦å‘å¤šä¸ªç¯å¢ƒ
parallel_deployment:
  stage: deploy
  parallel:
    matrix:
      - ENVIRONMENT: [staging, uat, demo]
        PROJECT_SUFFIX: [web, api, worker]
  trigger:
    project: deployments/${PROJECT_SUFFIX}-${ENVIRONMENT}
  variables:
    DEPLOY_ENV: $ENVIRONMENT
    SERVICE_TYPE: $PROJECT_SUFFIX
    VERSION: $CI_COMMIT_SHA
```

### 7.4 triggerä¸needsçš„ç»„åˆä½¿ç”¨


**ğŸ”¸ ä¾èµ–å…³ç³»æ§åˆ¶**
```yaml
stages:
  - build
  - test
  - trigger

build_app:
  stage: build
  script:
    - docker build -t app:$CI_COMMIT_SHA .

unit_tests:
  stage: test
  script:
    - npm test

integration_tests:
  stage: test
  script:
    - npm run integration

# åªæœ‰åœ¨æ‰€æœ‰æµ‹è¯•é€šè¿‡åæ‰è§¦å‘éƒ¨ç½²
trigger_deployment:
  stage: trigger
  trigger:
    project: ops/deployment
    strategy: depend
  variables:
    APP_IMAGE: app:$CI_COMMIT_SHA
  needs:
    - build_app
    - unit_tests  
    - integration_tests
  only:
    - main
```

### 7.5 é«˜çº§triggerç‰¹æ€§


**ğŸ”¸ çˆ¶å­Pipeline**
```yaml
# åœ¨åŒä¸€é¡¹ç›®å†…åˆ›å»ºå­Pipeline
create_child_pipeline:
  trigger:
    include: child-pipeline.yml
    strategy: depend
  variables:
    CHILD_PIPELINE_TYPE: "feature_test"
    PARENT_COMMIT: $CI_COMMIT_SHA
```

**ğŸ”¸ è·¨ç»„ç»‡è§¦å‘**
```yaml
# è§¦å‘å…¶ä»–ç»„ç»‡çš„é¡¹ç›®ï¼ˆéœ€è¦ç›¸åº”æƒé™ï¼‰
cross_org_trigger:
  trigger:
    project: external-org/external-project
  variables:
    EXTERNAL_TRIGGER: "true"
    SOURCE_ORG: $CI_PROJECT_NAMESPACE
  only:
    - schedules  # åªåœ¨å®šæ—¶è°ƒåº¦æ—¶æ‰§è¡Œ
```

**ğŸ”¸ é”™è¯¯å¤„ç†å’Œé‡è¯•**
```yaml
# å¸¦é‡è¯•æœºåˆ¶çš„è§¦å‘
robust_trigger:
  trigger:
    project: group/unstable-project
    strategy: depend
  variables:
    RETRY_COUNT: "3"
    TIMEOUT: "15m"
  retry:
    max: 2
    when:
      - api_failure
      - stuck_or_timeout_failure
  timeout: 20m
```

### 7.6 triggerçš„è°ƒè¯•å’Œç›‘æ§


**ğŸ” è°ƒè¯•ä¿¡æ¯æ”¶é›†**
```yaml
# æ·»åŠ è°ƒè¯•ä¿¡æ¯çš„è§¦å‘ä»»åŠ¡
debug_trigger:
  trigger:
    project: group/target-project
  variables:
    DEBUG_MODE: "true"
    SOURCE_PROJECT: $CI_PROJECT_PATH
    SOURCE_PIPELINE: $CI_PIPELINE_URL
    TRIGGER_USER: $GITLAB_USER_EMAIL
    TRIGGER_TIME: $CI_PIPELINE_CREATED_AT
  before_script:
    - echo "ğŸ” è§¦å‘è°ƒè¯•ä¿¡æ¯ï¼š"
    - echo "ğŸ“‚ ç›®æ ‡é¡¹ç›®: group/target-project"  
    - echo "ğŸŒ¿ æºåˆ†æ”¯: $CI_COMMIT_BRANCH"
    - echo "ğŸ‘¤ è§¦å‘ç”¨æˆ·: $GITLAB_USER_EMAIL"
    - echo "â° è§¦å‘æ—¶é—´: $(date)"
```

**ğŸ“Š ç›‘æ§è§¦å‘çŠ¶æ€**
```yaml
# è§¦å‘åçš„çŠ¶æ€æ£€æŸ¥
monitor_triggered_pipeline:
  stage: monitor
  image: alpine/curl
  script:
    - echo "ğŸ” æ£€æŸ¥è§¦å‘çš„PipelineçŠ¶æ€..."
    - |
      # ä½¿ç”¨APIæ£€æŸ¥PipelineçŠ¶æ€
      curl -H "PRIVATE-TOKEN: $API_TOKEN" \
        "$CI_API_V4_URL/projects/group%2Ftarget-project/pipelines" \
        | jq '.[] | select(.source=="pipeline") | {id, status, web_url}'
  needs:
    - debug_trigger
  allow_failure: true
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å®šæ—¶è°ƒåº¦ï¼šä½¿ç”¨Cronè¡¨è¾¾å¼å®ç°è‡ªåŠ¨åŒ–å®šæ—¶æ‰§è¡Œ
ğŸ”¸ æ‰‹åŠ¨è§¦å‘ï¼šwhen: manualå®ç°éœ€è¦äººå·¥ç¡®è®¤çš„å…³é”®æ“ä½œ
ğŸ”¸ APIè§¦å‘ï¼šé€šè¿‡ç¨‹åºåŒ–æ–¹å¼è¿œç¨‹æ§åˆ¶Pipelineæ‰§è¡Œ
ğŸ”¸ Webhookè§¦å‘ï¼šå¤–éƒ¨ç³»ç»Ÿäº‹ä»¶é©±åŠ¨çš„è‡ªåŠ¨åŒ–æµç¨‹
ğŸ”¸ è·¨é¡¹ç›®è§¦å‘ï¼šå®ç°é¡¹ç›®é—´çš„ä¾èµ–å’Œåä½œæµç¨‹
ğŸ”¸ triggerå…³é”®å­—ï¼šGitLab CI/CDä¸­æœ€å¼ºå¤§çš„è§¦å‘æ§åˆ¶å·¥å…·
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ è§¦å‘æ–¹å¼çš„é€‰æ‹©åŸåˆ™**
```
å®šæ—¶è°ƒåº¦ â†’ é€‚åˆå‘¨æœŸæ€§ä»»åŠ¡ï¼ˆå¤‡ä»½ã€æŠ¥å‘Šã€ç›‘æ§ï¼‰
æ‰‹åŠ¨è§¦å‘ â†’ é€‚åˆé«˜é£é™©æ“ä½œï¼ˆç”Ÿäº§éƒ¨ç½²ã€æ•°æ®æ¸…ç†ï¼‰
APIè§¦å‘ â†’ é€‚åˆç³»ç»Ÿé›†æˆï¼ˆè‡ªåŠ¨åŒ–å·¥å…·ã€ç¬¬ä¸‰æ–¹ç³»ç»Ÿï¼‰
Webhook â†’ é€‚åˆäº‹ä»¶é©±åŠ¨ï¼ˆä»£ç å˜æ›´ã€å¤–éƒ¨é€šçŸ¥ï¼‰
è·¨é¡¹ç›® â†’ é€‚åˆä¾èµ–ç®¡ç†ï¼ˆå¾®æœåŠ¡ã€ç»„ä»¶æ›´æ–°ï¼‰
```

**ğŸ”¹ å®‰å…¨æ€§è€ƒè™‘**
```
ä»¤ç‰Œç®¡ç†ï¼š
â€¢ å®šæœŸè½®æ¢APIä»¤ç‰Œå’ŒSecret
â€¢ ä½¿ç”¨æœ€å°æƒé™åŸåˆ™
â€¢ é¿å…åœ¨ä»£ç ä¸­ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯

è®¿é—®æ§åˆ¶ï¼š
â€¢ é™åˆ¶æ‰‹åŠ¨è§¦å‘çš„ç”¨æˆ·æƒé™
â€¢ è®¾ç½®IPç™½åå•ä¿æŠ¤Webhookç«¯ç‚¹
â€¢ éªŒè¯è·¨é¡¹ç›®è§¦å‘çš„æƒé™èŒƒå›´
```

**ğŸ”¹ æ€§èƒ½å’Œå¯é æ€§**
```
è¶…æ—¶è®¾ç½®ï¼š
â€¢ ä¸ºé•¿æ—¶é—´è¿è¡Œçš„è§¦å‘ä»»åŠ¡è®¾ç½®åˆç†è¶…æ—¶
â€¢ ä½¿ç”¨strategy: dependæ—¶è¦è€ƒè™‘æ€»ä½“æ‰§è¡Œæ—¶é—´

é”™è¯¯å¤„ç†ï¼š
â€¢ ä¸ºå…³é”®è§¦å‘æ·»åŠ é‡è¯•æœºåˆ¶
â€¢ ä½¿ç”¨allow_failureæ§åˆ¶å¤±è´¥å½±å“èŒƒå›´
â€¢ å»ºç«‹ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶
```

### 8.3 å®é™…åº”ç”¨æœ€ä½³å®è·µ


**ğŸ¯ ç»„åˆä½¿ç”¨ç­–ç•¥**
```
å…¸å‹CI/CDæµç¨‹ï¼š
1. ä»£ç æ¨é€ â†’ è‡ªåŠ¨è§¦å‘æ„å»ºæµ‹è¯•
2. æµ‹è¯•é€šè¿‡ â†’ æ‰‹åŠ¨è§¦å‘ç”Ÿäº§éƒ¨ç½²  
3. éƒ¨ç½²å®Œæˆ â†’ Webhooké€šçŸ¥ç›¸å…³ç³»ç»Ÿ
4. ä¾èµ–æ›´æ–° â†’ è·¨é¡¹ç›®è§¦å‘ä¸‹æ¸¸åº”ç”¨
5. å®šæ—¶ä»»åŠ¡ â†’ å®šæœŸå¥åº·æ£€æŸ¥å’Œæ¸…ç†
```

**ğŸ’¡ è°ƒè¯•å’Œä¼˜åŒ–å»ºè®®**
```
è°ƒè¯•æŠ€å·§ï¼š
â€¢ ä½¿ç”¨echoå‘½ä»¤è¾“å‡ºå…³é”®å˜é‡å’ŒçŠ¶æ€
â€¢ åœ¨GitLabç•Œé¢æŸ¥çœ‹Pipelineå›¾å’Œæ—¥å¿—
â€¢ è®¾ç½®è¯¦ç»†çš„jobæè¿°å’Œå˜é‡ä¼ é€’

ä¼˜åŒ–æ–¹å‘ï¼š
â€¢ å‡å°‘ä¸å¿…è¦çš„è§¦å‘é¢‘ç‡
â€¢ åˆç†ä½¿ç”¨å¹¶è¡Œå’Œä¾èµ–å…³ç³»
â€¢ å®šæœŸæ¸…ç†æ— ç”¨çš„è§¦å‘é…ç½®
```

**ğŸ”§ æ•…éšœæ’æŸ¥æŒ‡å—**
```
å¸¸è§é—®é¢˜ï¼š
âŒ ä»¤ç‰Œè¿‡æœŸæˆ–æƒé™ä¸è¶³
âŒ åˆ†æ”¯åç§°é”™è¯¯æˆ–ä¸å­˜åœ¨
âŒ å˜é‡ä¼ é€’æ ¼å¼ä¸æ­£ç¡®
âŒ ç½‘ç»œè¿æ¥æˆ–APIé™åˆ¶
âŒ å¾ªç¯è§¦å‘å¯¼è‡´çš„æ­»é”

è§£å†³æ€è·¯ï¼š
âœ… æ£€æŸ¥ä»¤ç‰Œæœ‰æ•ˆæ€§å’Œæƒé™
âœ… ç¡®è®¤åˆ†æ”¯å’Œé¡¹ç›®è·¯å¾„æ­£ç¡®
âœ… éªŒè¯å˜é‡æ ¼å¼å’Œå†…å®¹
âœ… æŸ¥çœ‹GitLabç³»ç»Ÿæ—¥å¿—
âœ… è®¾ç½®åˆç†çš„è§¦å‘æ¡ä»¶é¿å…å¾ªç¯
```

### 8.4 å­¦ä¹ è¿›é˜¶å»ºè®®


**ğŸ“š æ·±å…¥å­¦ä¹ æ–¹å‘**
- **GitLab API**ï¼šæŒæ¡æ›´å¤šAPIæ“ä½œï¼Œå®ç°å¤æ‚çš„è‡ªåŠ¨åŒ–é€»è¾‘
- **Pipelineæ¶æ„**ï¼šè®¾è®¡åˆç†çš„å¤šé¡¹ç›®CI/CDæ¶æ„
- **ç›‘æ§é›†æˆ**ï¼šé›†æˆPrometheusã€Grafanaç­‰ç›‘æ§å·¥å…·
- **ChatOps**ï¼šç»“åˆSlackã€Teamsç­‰å®ç°èŠå¤©æœºå™¨äººè§¦å‘

**ğŸ› ï¸ å®è·µé¡¹ç›®å»ºè®®**
- æ­å»ºä¸€ä¸ªå¾®æœåŠ¡CI/CDæµç¨‹ï¼ŒåŒ…å«å¤šé¡¹ç›®è§¦å‘
- å®ç°ä¸€ä¸ªåŸºäºWebhookçš„è‡ªåŠ¨åŒ–éƒ¨ç½²ç³»ç»Ÿ
- åˆ›å»ºå®šæ—¶ä»»åŠ¡è¿›è¡Œç³»ç»Ÿå¥åº·æ£€æŸ¥å’ŒæŠ¥å‘Š
- å¼€å‘APIæ¥å£å®ç°Pipelineçš„å¯è§†åŒ–ç®¡ç†

**æ ¸å¿ƒè®°å¿†**ï¼š
- è§¦å‘å™¨æ˜¯CI/CDè‡ªåŠ¨åŒ–çš„æ ¸å¿ƒï¼Œé€‰æ‹©åˆé€‚çš„è§¦å‘æ–¹å¼è‡³å…³é‡è¦
- å®‰å…¨æ€§å’Œå¯é æ€§æ˜¯è§¦å‘é…ç½®çš„é¦–è¦è€ƒè™‘å› ç´   
- åˆç†çš„è§¦å‘ç­–ç•¥èƒ½å¤§å¤§æå‡å¼€å‘å’Œè¿ç»´æ•ˆç‡
- è°ƒè¯•å’Œç›‘æ§æ˜¯ä¿éšœè§¦å‘ç³»ç»Ÿç¨³å®šè¿è¡Œçš„å…³é”®