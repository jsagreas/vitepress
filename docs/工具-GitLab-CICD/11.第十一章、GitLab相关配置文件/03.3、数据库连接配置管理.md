---
title: 3、数据库连接配置管理
---
## 📚 目录

1. [GitLab数据库配置概述](#1-GitLab数据库配置概述)
2. [PostgreSQL数据库配置段详解](#2-PostgreSQL数据库配置段详解)
3. [外部数据库连接参数配置](#3-外部数据库连接参数配置)
4. [数据库认证与安全配置](#4-数据库认证与安全配置)
5. [连接池与性能优化配置](#5-连接池与性能优化配置)
6. [数据库编码与字符集配置](#6-数据库编码与字符集配置)
7. [备份数据库配置管理](#7-备份数据库配置管理)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🎯 GitLab数据库配置概述


### 1.1 什么是GitLab数据库配置


**简单理解**：就像给GitLab指定一个"仓库"来存放所有重要信息

```
类比理解：
GitLab就像一个图书馆管理员
数据库就像图书馆的书架和档案柜
配置文件就像告诉管理员：
- 书架在哪里（数据库地址）
- 怎么打开柜子（用户名密码）
- 能放多少本书（连接池大小）
```

**💡 为什么需要数据库配置**
- **存储用户信息**：用户账号、权限、项目成员关系
- **保存项目数据**：代码提交记录、分支信息、合并请求
- **记录CI/CD信息**：流水线执行历史、构建日志、部署记录
- **管理系统设置**：GitLab的各种配置选项和系统状态

### 1.2 GitLab支持的数据库类型


| 数据库类型 | **推荐程度** | **适用场景** | **特点说明** |
|-----------|------------|-------------|-------------|
| 🐘 **PostgreSQL** | `⭐⭐⭐⭐⭐` | `生产环境首选` | `性能最优，功能最全，官方强烈推荐` |
| 🐬 **MySQL** | `⭐⭐⭐☆☆` | `现有MySQL环境` | `兼容性好，但某些功能受限` |
| 🗄️ **SQLite** | `⭐⭐☆☆☆` | `开发测试环境` | `轻量级，但不适合生产环境` |

> 💡 **新手建议**  
> 如果你是刚开始学习，强烈建议选择PostgreSQL，因为GitLab的所有功能都是基于PostgreSQL开发和测试的

### 1.3 数据库配置文件位置


**主要配置文件路径**：
```
GitLab配置文件结构：
/etc/gitlab/
├── gitlab.rb              ← 主配置文件（这里配置数据库）
├── gitlab-secrets.json    ← 密钥文件
└── ssl/                   ← SSL证书目录

数据库相关配置都在 gitlab.rb 文件中
```

---

## 2. 🐘 PostgreSQL数据库配置段详解


### 2.1 基本PostgreSQL配置结构


**配置段在gitlab.rb中的位置**：

```ruby
# PostgreSQL数据库配置段
postgresql['enable'] = true                    # 启用内置PostgreSQL
postgresql['data_dir'] = "/var/opt/gitlab/postgresql/data"  # 数据目录
postgresql['log_directory'] = "/var/log/gitlab/postgresql"  # 日志目录

# 数据库连接配置
gitlab_rails['db_adapter'] = 'postgresql'     # 数据库类型
gitlab_rails['db_encoding'] = 'utf8'          # 字符编码
gitlab_rails['db_database'] = 'gitlabhq_production'  # 数据库名
gitlab_rails['db_username'] = 'gitlab'        # 用户名
gitlab_rails['db_password'] = 'your_password' # 密码
```

### 2.2 内置PostgreSQL vs 外部PostgreSQL


**🏠 内置PostgreSQL配置（适合小团队）**：

```ruby
# 使用GitLab自带的PostgreSQL
postgresql['enable'] = true

# 基本设置
postgresql['data_dir'] = "/var/opt/gitlab/postgresql/data"
postgresql['port'] = 5432
postgresql['username'] = "gitlab-psql"

# 内存设置（根据服务器配置调整）
postgresql['shared_buffers'] = "256MB"        # 共享缓冲区
postgresql['effective_cache_size'] = "1GB"    # 有效缓存大小
```

**🌐 外部PostgreSQL配置（适合大型部署）**：

```ruby
# 禁用内置PostgreSQL
postgresql['enable'] = false

# 连接外部数据库
gitlab_rails['db_host'] = '192.168.1.100'     # 数据库服务器IP
gitlab_rails['db_port'] = 5432                # 端口号
gitlab_rails['db_database'] = 'gitlab_prod'   # 数据库名
gitlab_rails['db_username'] = 'gitlab_user'   # 用户名
gitlab_rails['db_password'] = 'secure_pass'   # 密码
```

> ⚠️ **选择建议**  
> - **小团队（<50人）**：使用内置PostgreSQL，配置简单
> - **大团队（>50人）**：使用外部PostgreSQL，性能更好，便于维护

### 2.3 PostgreSQL版本兼容性


**支持的PostgreSQL版本**：

```
GitLab版本兼容性：
┌─────────────────┬──────────────────┬─────────────────┐
│ GitLab版本      │ PostgreSQL版本   │ 推荐说明        │
├─────────────────┼──────────────────┼─────────────────┤
│ 15.0+          │ 12, 13, 14, 15   │ 推荐使用14或15  │
│ 14.0-14.10     │ 11, 12, 13, 14   │ 推荐使用13或14  │
│ 13.0-13.12     │ 11, 12, 13       │ 推荐使用12或13  │
└─────────────────┴──────────────────┴─────────────────┘
```

---

## 3. 🔗 外部数据库连接参数配置


### 3.1 数据库主机地址配置（db_host）


**db_host参数详解**：

```ruby
# 不同类型的主机地址配置
gitlab_rails['db_host'] = 'localhost'         # 本地数据库
gitlab_rails['db_host'] = '192.168.1.100'     # 内网IP地址
gitlab_rails['db_host'] = 'db.company.com'    # 域名地址
gitlab_rails['db_host'] = '/var/run/postgresql' # Unix套接字路径
```

**连接方式对比**：

| 连接方式 | **配置示例** | **适用场景** | **优缺点** |
|---------|-------------|-------------|-----------|
| 🏠 **本地连接** | `'localhost'` | `单机部署` | `速度快，但扩展性差` |
| 🌐 **网络连接** | `'192.168.1.100'` | `分布式部署` | `灵活扩展，但需考虑网络延迟` |
| 📁 **套接字连接** | `'/var/run/postgresql'` | `同机器部署` | `性能最优，但限制在同一台机器` |

### 3.2 端口号配置（db_port）


**端口配置说明**：

```ruby
# 标准PostgreSQL端口
gitlab_rails['db_port'] = 5432                # 默认PostgreSQL端口

# 自定义端口（提高安全性）
gitlab_rails['db_port'] = 15432               # 自定义端口号

# 多实例环境
gitlab_rails['db_port'] = 5433               # 第二个PostgreSQL实例
```

> 💡 **端口选择建议**  
> - **默认端口5432**：适合内网环境，配置简单
> - **自定义端口**：适合对外暴露的环境，增加安全性
> - **防火墙设置**：记得在防火墙中开放对应端口

### 3.3 连接超时和重试配置


**高级连接参数**：

```ruby
# 连接超时设置
gitlab_rails['db_connect_timeout'] = 60       # 连接超时时间（秒）
gitlab_rails['db_reconnect'] = true           # 自动重连
gitlab_rails['db_retry_attempts'] = 3         # 重试次数

# SSL连接配置
gitlab_rails['db_sslmode'] = 'require'        # SSL模式
gitlab_rails['db_sslcert'] = '/path/to/cert'  # SSL证书路径
gitlab_rails['db_sslkey'] = '/path/to/key'    # SSL密钥路径
```

---

## 4. 🔐 数据库认证与安全配置


### 4.1 用户名密码认证设置


**基础认证配置**：

```ruby
# 数据库用户认证
gitlab_rails['db_username'] = 'gitlab'        # 数据库用户名
gitlab_rails['db_password'] = 'your_password' # 数据库密码

# 密码安全建议
gitlab_rails['db_password'] = 'Gl@b2024!Sec'  # 强密码示例
```

**🔒 密码安全最佳实践**：
- ✅ **长度至少12位**：包含大小写字母、数字、特殊字符
- ✅ **避免常见词汇**：不使用gitlab、admin、password等
- ✅ **定期更换**：生产环境建议3-6个月更换一次
- ✅ **权限最小化**：只给GitLab必需的数据库权限

### 4.2 数据库用户权限配置


**PostgreSQL用户权限设置**：

```sql
-- 创建GitLab专用数据库用户
CREATE USER gitlab WITH PASSWORD 'your_secure_password';

-- 创建GitLab数据库
CREATE DATABASE gitlabhq_production OWNER gitlab;

-- 授予必要权限
GRANT ALL PRIVILEGES ON DATABASE gitlabhq_production TO gitlab;
GRANT USAGE, CREATE ON SCHEMA public TO gitlab;
```

> ⚠️ **权限安全提醒**  
> 不要给GitLab用户超级管理员权限，只给操作GitLab数据库的权限即可

### 4.3 SSL加密连接配置


**SSL连接配置详解**：

```ruby
# SSL连接模式选择
gitlab_rails['db_sslmode'] = 'disable'        # 不使用SSL（开发环境）
gitlab_rails['db_sslmode'] = 'require'        # 必须使用SSL（推荐）
gitlab_rails['db_sslmode'] = 'verify-ca'      # 验证CA证书
gitlab_rails['db_sslmode'] = 'verify-full'    # 完全验证（最安全）

# SSL证书配置
gitlab_rails['db_sslcert'] = '/etc/ssl/gitlab-db.crt'
gitlab_rails['db_sslkey'] = '/etc/ssl/gitlab-db.key'
gitlab_rails['db_sslrootcert'] = '/etc/ssl/ca-cert.crt'
```

---

## 5. ⚡ 连接池与性能优化配置


### 5.1 连接池大小配置


**什么是连接池**：
```
类比理解：
连接池就像餐厅的座位数
- 座位太少：客人要排队等待（用户请求等待）
- 座位太多：浪费空间和成本（占用过多内存）
- 合适数量：既能满足需求，又不浪费资源
```

**连接池配置参数**：

```ruby
# 数据库连接池配置
gitlab_rails['db_pool'] = 20                  # 连接池大小

# 根据服务器配置调整
gitlab_rails['db_pool'] = 10                  # 小型部署（<100用户）
gitlab_rails['db_pool'] = 20                  # 中型部署（100-500用户）
gitlab_rails['db_pool'] = 50                  # 大型部署（>500用户）
```

**📊 连接池大小计算公式**：
```
推荐连接池大小 = CPU核心数 × 2 到 CPU核心数 × 4
例如：4核CPU，推荐连接池大小为 8-16

实际配置需考虑：
- 并发用户数量
- 服务器内存大小
- 数据库服务器性能
```

### 5.2 连接超时配置


**连接生命周期管理**：

```ruby
# 连接超时设置
gitlab_rails['db_connect_timeout'] = 60       # 建立连接超时（秒）
gitlab_rails['db_checkout_timeout'] = 5       # 获取连接超时（秒）
gitlab_rails['db_statement_timeout'] = 60000  # SQL语句超时（毫秒）

# 连接保活设置
gitlab_rails['db_keepalives_idle'] = 300      # 空闲保活时间（秒）
gitlab_rails['db_keepalives_interval'] = 30   # 保活间隔（秒）
gitlab_rails['db_keepalives_count'] = 3       # 保活重试次数
```

### 5.3 数据库性能监控配置


**性能监控参数**：

```ruby
# 慢查询日志
postgresql['log_min_duration_statement'] = 1000  # 记录超过1秒的查询
postgresql['log_line_prefix'] = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# 查询统计
postgresql['shared_preload_libraries'] = 'pg_stat_statements'
postgresql['pg_stat_statements.max'] = 10000
postgresql['pg_stat_statements.track'] = 'all'
```

---

## 6. 🔤 数据库编码与字符集配置


### 6.1 数据库编码设置


**字符编码配置**：

```ruby
# 数据库字符编码
gitlab_rails['db_encoding'] = 'utf8'          # UTF-8编码（推荐）
gitlab_rails['db_encoding'] = 'unicode'       # Unicode编码

# 数据库排序规则
gitlab_rails['db_collation'] = 'en_US.UTF-8'  # 英文环境
gitlab_rails['db_collation'] = 'zh_CN.UTF-8'  # 中文环境
```

**🌍 编码选择指南**：

| 编码类型 | **特点** | **适用场景** | **注意事项** |
|---------|---------|-------------|-------------|
| **UTF-8** | `多语言支持` | `国际化项目` | `存储效率最高，推荐使用` |
| **UTF-16** | `固定长度` | `特殊需求` | `占用空间较大` |
| **ASCII** | `纯英文` | `纯英文环境` | `不支持中文等字符` |

### 6.2 字符集兼容性配置


**多语言支持配置**：

```ruby
# 区域设置
gitlab_rails['db_locale'] = 'en_US.UTF-8'     # 默认区域
gitlab_rails['db_lc_collate'] = 'en_US.UTF-8' # 排序规则
gitlab_rails['db_lc_ctype'] = 'en_US.UTF-8'   # 字符分类

# 时区设置
gitlab_rails['time_zone'] = 'Asia/Shanghai'   # 中国时区
gitlab_rails['time_zone'] = 'UTC'             # 国际标准时间
```

> 💡 **中文用户建议**  
> 如果你的团队主要使用中文，建议设置：
> - 编码：`utf8`
> - 区域：`zh_CN.UTF-8`
> - 时区：`Asia/Shanghai`

---

## 7. 💾 备份数据库配置管理


### 7.1 自动备份配置


**GitLab内置备份功能**：

```ruby
# 备份基本设置
gitlab_rails['backup_keep_time'] = 604800     # 保留7天的备份
gitlab_rails['backup_path'] = '/var/opt/gitlab/backups'  # 备份目录

# 备份内容配置
gitlab_rails['backup_archive_permissions'] = 0644       # 备份文件权限
gitlab_rails['backup_pg_schema'] = 'public'             # 备份的数据库schema
```

**自动化备份脚本配置**：

```bash
# 创建定时备份任务（crontab）
# 每天凌晨2点执行备份
0 2 * * * /opt/gitlab/bin/gitlab-backup create CRON=1

# 备份前的数据库检查
gitlab-rake gitlab:check
gitlab-rake gitlab:backup:create
```

### 7.2 备份数据库连接配置


**备份专用数据库配置**：

```ruby
# 备份数据库连接（可选）
gitlab_rails['backup_db_host'] = 'backup-db.company.com'
gitlab_rails['backup_db_port'] = 5432
gitlab_rails['backup_db_username'] = 'backup_user'
gitlab_rails['backup_db_password'] = 'backup_password'

# 备份加密设置
gitlab_rails['backup_encryption_key'] = 'your-encryption-key'
gitlab_rails['backup_upload_connection'] = {
  'provider' => 'AWS',
  'region' => 'us-east-1',
  'aws_access_key_id' => 'your-key',
  'aws_secret_access_key' => 'your-secret'
}
```

### 7.3 数据恢复配置


**数据恢复流程配置**：

```ruby
# 恢复相关配置
gitlab_rails['backup_restore_timeout'] = 3600  # 恢复超时时间（秒）

# 恢复时的数据库连接检查
gitlab_rails['backup_restore_check_database'] = true
```

**🚨 恢复操作示例**：

```bash
# 停止GitLab服务
sudo gitlab-ctl stop unicorn
sudo gitlab-ctl stop puma
sudo gitlab-ctl stop sidekiq

# 恢复备份
sudo gitlab-backup restore BACKUP=备份文件时间戳

# 重启服务
sudo gitlab-ctl restart
sudo gitlab-rake gitlab:check SANITIZE=true
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的数据库配置概念


```
🔸 数据库类型：PostgreSQL是首选，MySQL次选，SQLite仅限测试
🔸 连接方式：内置数据库适合小团队，外部数据库适合大规模部署  
🔸 认证安全：使用强密码，最小权限原则，启用SSL加密
🔸 性能优化：合理设置连接池，配置超时参数，监控慢查询
🔸 字符编码：统一使用UTF-8，支持多语言，设置正确时区
🔸 备份策略：定期自动备份，测试恢复流程，保留适当的备份数量
```

### 8.2 新手常见问题与解决方案


**🔹 连接问题排查**：
```
问题：GitLab无法连接数据库
检查步骤：
1. 确认数据库服务是否启动
2. 检查网络连通性（ping数据库主机）
3. 验证用户名密码是否正确
4. 确认防火墙端口是否开放
5. 查看GitLab日志：/var/log/gitlab/
```

**🔹 性能问题优化**：
```
症状：GitLab响应缓慢
优化步骤：
1. 增加连接池大小
2. 优化数据库配置（shared_buffers等）
3. 检查慢查询日志
4. 考虑升级服务器硬件
5. 使用外部高性能数据库
```

**🔹 备份恢复测试**：
```
最佳实践：
1. 每月至少测试一次完整恢复流程
2. 备份文件存储在不同位置（本地+云端）
3. 记录恢复时间，制定RTO/RPO策略
4. 培训团队成员掌握恢复操作
```

### 8.3 配置模板与实践建议


**🎯 小型团队配置模板**：
```ruby
# 适合50人以下团队
postgresql['enable'] = true
postgresql['shared_buffers'] = "256MB"
gitlab_rails['db_pool'] = 10
gitlab_rails['backup_keep_time'] = 604800
```

**🎯 大型团队配置模板**：
```ruby
# 适合500人以上团队
postgresql['enable'] = false
gitlab_rails['db_host'] = 'external-db.company.com'
gitlab_rails['db_pool'] = 50
gitlab_rails['db_sslmode'] = 'require'
gitlab_rails['backup_keep_time'] = 2592000
```

### 8.4 配置变更与维护流程


**📋 变更检查清单**：
- ✅ 修改配置前备份原文件
- ✅ 在测试环境先验证配置
- ✅ 规划维护窗口时间
- ✅ 准备回滚方案
- ✅ 通知用户维护时间
- ✅ 变更后进行功能验证

> 💡 **核心记忆要点**  
> GitLab数据库配置的本质是告诉GitLab"数据存哪里，怎么存，怎么取"。掌握了连接、认证、性能、备份这四个核心方面，就能满足大部分实际需求。记住：安全第一，性能第二，简单实用最重要！