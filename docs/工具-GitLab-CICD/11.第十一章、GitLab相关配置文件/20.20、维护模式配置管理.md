---
title: 20、维护模式配置管理
---
## 📚 目录

1. [维护模式基础概念](#1-维护模式基础概念)
2. [维护模式开关设置](#2-维护模式开关设置)
3. [系统升级配置](#3-系统升级配置)
4. [数据迁移配置](#4-数据迁移配置)
5. [服务重启策略](#5-服务重启策略)
6. [配置热重载](#6-配置热重载)
7. [版本回滚配置](#7-版本回滚配置)
8. [系统诊断工具](#8-系统诊断工具)
9. [故障排查配置](#9-故障排查配置)
10. [核心要点总结](#10-核心要点总结)

---

## 1. 🔧 维护模式基础概念


### 1.1 什么是维护模式


**简单理解**：维护模式就像给系统挂一块"暂停营业"的牌子，让系统可以安全地进行升级、修复或配置变更。

```
正常运行：           维护模式：
用户 → GitLab       用户 → 维护页面 ❌
  ↓                  ↓
正常功能             "系统维护中，请稍后..."
```

**核心作用**：
- 🛡️ **保护数据安全**：升级时防止数据冲突
- ⏸️ **暂停用户操作**：避免操作影响维护工作
- 🔄 **安全变更**：确保配置修改不被干扰
- 📢 **用户提醒**：告知用户系统状态

### 1.2 维护模式的使用场景


**常见使用时机**：
- 🔄 **系统版本升级**：GitLab大版本更新
- 💾 **数据库维护**：备份、迁移、索引重建
- ⚙️ **配置重大变更**：服务器迁移、架构调整
- 🔧 **故障紧急修复**：解决影响全局的问题
- 🛠️ **硬件维护**：服务器硬件升级或更换

### 1.3 维护模式工作原理


**技术原理图示**：
```
请求流程对比：

正常模式：
用户请求 → Nginx → GitLab应用 → 数据库
                      ↓
                   正常响应

维护模式：
用户请求 → Nginx → 维护页面显示
                      ↓
                 "系统维护中"
```

**核心机制**：
- **请求拦截**：在Web服务器层面拦截用户请求
- **静态页面**：显示预设的维护通知页面
- **后台继续**：GitLab核心服务可以继续运行（仅限管理操作）
- **API阻断**：所有用户API请求被暂停

---

## 2. 🔀 维护模式开关设置


### 2.1 启用维护模式的方法


**方法一：通过配置文件启用**

```ruby
# /etc/gitlab/gitlab.rb
gitlab_rails['maintenance_mode'] = true
gitlab_rails['maintenance_message'] = "系统正在升级维护，预计2小时后恢复"
```

**配置参数说明**：
- `maintenance_mode`: 维护模式开关（true/false）
- `maintenance_message`: 显示给用户的维护信息

**方法二：通过Nginx配置启用**

```nginx
# /var/opt/gitlab/nginx/conf/gitlab-http.conf
location / {
    if (-f /opt/gitlab/embedded/service/gitlab-rails/public/deploy.html) {
        return 503;
    }
    # 其他配置...
}

error_page 503 @maintenance;
location @maintenance {
    root /opt/gitlab/embedded/service/gitlab-rails/public/;
    rewrite ^(.*)$ /deploy.html break;
}
```

### 2.2 维护模式状态检查


**检查当前状态**：

```bash
# 检查维护模式状态
sudo gitlab-rails runner "puts Gitlab::CurrentSettings.maintenance_mode"

# 检查维护信息
sudo gitlab-rails runner "puts Gitlab::CurrentSettings.maintenance_message"
```

**Web界面检查**：
- 访问GitLab首页，如果显示维护页面则说明已启用
- 管理员可以通过特殊URL绕过维护模式

### 2.3 维护页面自定义


**自定义维护页面**：

```html
<!-- /opt/gitlab/embedded/service/gitlab-rails/public/deploy.html -->
<!DOCTYPE html>
<html>
<head>
    <title>系统维护中</title>
    <meta charset="utf-8">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            text-align: center; 
            padding: 50px;
            background: #f8f9fa;
        }
        .maintenance-box {
            max-width: 500px;
            margin: 0 auto;
            padding: 30px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="maintenance-box">
        <h1>🔧 系统维护中</h1>
        <p>我们正在进行系统升级，预计维护时间2小时</p>
        <p>预计恢复时间：今天 18:00</p>
        <p>如有紧急问题，请联系：admin@company.com</p>
    </div>
</body>
</html>
```

**页面要素说明**：
- **维护原因**：告知用户为什么要维护
- **预计时间**：让用户知道大概什么时候恢复
- **联系方式**：紧急情况的联系渠道
- **友好提示**：感谢用户理解的客气话

---

## 3. 🚀 系统升级配置


### 3.1 升级前准备配置


**升级检查清单**：

| 检查项目 | 检查命令 | 预期结果 |
|---------|---------|---------|
| **磁盘空间** | `df -h` | 至少20GB可用空间 |
| **内存使用** | `free -h` | 内存使用率<80% |
| **备份状态** | `gitlab-backup create` | 备份成功完成 |
| **服务状态** | `gitlab-ctl status` | 所有服务正常运行 |

**升级配置设置**：

```ruby
# /etc/gitlab/gitlab.rb - 升级专用配置
# 临时增加资源限制
sidekiq['concurrency'] = 2  # 降低并发，减少资源占用
postgresql['shared_buffers'] = "512MB"  # 临时调整数据库缓存

# 升级期间的安全设置
gitlab_rails['backup_keep_time'] = 604800  # 保留7天备份
gitlab_rails['automatic_migrations'] = true  # 自动执行数据库迁移
```

### 3.2 升级执行配置


**升级步骤配置**：

```bash
# 1. 启用维护模式
sudo gitlab-ctl reconfigure
echo "maintenance_mode=true" >> /etc/gitlab/gitlab.rb

# 2. 停止相关服务（保留数据库）
sudo gitlab-ctl stop unicorn
sudo gitlab-ctl stop sidekiq
sudo gitlab-ctl stop nginx

# 3. 升级软件包
sudo apt update
sudo apt install gitlab-ee=新版本号

# 4. 重新配置
sudo gitlab-ctl reconfigure
sudo gitlab-ctl restart
```

### 3.3 升级后验证配置


**验证脚本示例**：

```bash
#!/bin/bash
# upgrade_check.sh - 升级后检查脚本

echo "🔍 开始升级后检查..."

# 检查GitLab版本
echo "检查版本信息..."
gitlab-rails runner "puts Gitlab::VERSION"

# 检查服务状态
echo "检查服务状态..."
gitlab-ctl status

# 检查数据库连接
echo "检查数据库..."
gitlab-rails runner "puts User.count"

# 检查Git仓库
echo "检查Git功能..."
su - git -c "gitlab-rake gitlab:check"

echo "✅ 检查完成"
```

---

## 4. 💾 数据迁移配置


### 4.1 数据迁移基础概念


**什么是数据迁移**：
数据迁移就像搬家一样，把GitLab的所有数据从一个地方"搬"到另一个地方，确保搬家后一切功能正常。

**迁移场景分类**：
```
服务器迁移：    旧服务器 → 新服务器
存储迁移：      本地存储 → 云存储
数据库迁移：    旧数据库 → 新数据库
版本迁移：      旧版本 → 新版本
```

### 4.2 数据备份迁移配置


**完整备份配置**：

```ruby
# /etc/gitlab/gitlab.rb - 备份配置
gitlab_rails['backup_path'] = '/var/opt/gitlab/backups'
gitlab_rails['backup_keep_time'] = 259200  # 3天
gitlab_rails['backup_upload_connection'] = {
  'provider' => 'AWS',
  'region' => 'us-east-1',
  'aws_access_key_id' => 'your_key',
  'aws_secret_access_key' => 'your_secret'
}
gitlab_rails['backup_upload_remote_directory'] = 'gitlab-backups'
```

**创建迁移备份**：

```bash
# 创建完整备份
sudo gitlab-backup create STRATEGY=copy

# 备份配置文件
sudo cp /etc/gitlab/gitlab.rb /var/opt/gitlab/backups/
sudo cp /etc/gitlab/gitlab-secrets.json /var/opt/gitlab/backups/
```

### 4.3 数据恢复配置


**恢复数据流程**：

```bash
# 1. 停止相关服务
sudo gitlab-ctl stop unicorn
sudo gitlab-ctl stop sidekiq

# 2. 恢复数据
sudo gitlab-backup restore BACKUP=备份文件名

# 3. 恢复配置
sudo cp gitlab.rb /etc/gitlab/
sudo cp gitlab-secrets.json /etc/gitlab/

# 4. 重新配置和启动
sudo gitlab-ctl reconfigure
sudo gitlab-ctl restart
```

### 4.4 增量迁移配置


**增量同步原理**：
```
主服务器：     [数据A] [数据B] [数据C] [新数据D]
               ↓        ↓        ↓        ↓
从服务器：     [数据A] [数据B] [数据C] [同步D]
```

**增量同步配置**：

```bash
# 使用rsync进行增量同步
rsync -avz --progress /var/opt/gitlab/git-data/ \
  user@new-server:/var/opt/gitlab/git-data/

# 同步数据库（使用流复制）
# 主库配置
postgresql['replication_slot_name'] = 'gitlab_replica'
postgresql['wal_level'] = 'replica'
```

---

## 5. 🔄 服务重启策略


### 5.1 重启策略类型


**重启策略对比**：

| 策略类型 | **影响范围** | **停机时间** | **适用场景** |
|---------|-------------|-------------|-------------|
| **滚动重启** | `单个服务` | `几秒到几分钟` | `日常配置更新` |
| **优雅重启** | `全部服务` | `几分钟` | `重大配置变更` |
| **强制重启** | `全部服务` | `立即` | `紧急故障修复` |
| **热重启** | `几乎无影响` | `几乎无` | `动态配置更新` |

### 5.2 优雅重启配置


**优雅重启的含义**：
就像礼貌地请客人离开一样，让正在进行的操作完成，然后再重启服务。

```bash
# 优雅重启单个服务
sudo gitlab-ctl graceful-kill unicorn
sudo gitlab-ctl start unicorn

# 优雅重启所有服务
sudo gitlab-ctl graceful-restart
```

**重启超时配置**：

```ruby
# /etc/gitlab/gitlab.rb
unicorn['worker_timeout'] = 60  # 工作进程超时时间
unicorn['preload_app'] = false  # 关闭预加载，支持优雅重启
sidekiq['shutdown_timeout'] = 30  # Sidekiq停止超时时间
```

### 5.3 服务依赖重启配置


**服务依赖关系图**：
```
Nginx (Web服务器)
  ↓
Unicorn/Puma (应用服务器)
  ↓
PostgreSQL (数据库)
  ↓
Redis (缓存)
  ↓
Sidekiq (后台任务)
```

**依赖重启脚本**：

```bash
#!/bin/bash
# restart_with_dependencies.sh

echo "🔄 开始依赖重启..."

# 1. 停止上层服务
gitlab-ctl stop nginx
gitlab-ctl stop unicorn
gitlab-ctl stop sidekiq

# 2. 重启底层服务
gitlab-ctl restart redis
gitlab-ctl restart postgresql

# 3. 启动上层服务
gitlab-ctl start sidekiq
gitlab-ctl start unicorn
gitlab-ctl start nginx

echo "✅ 重启完成"
```

---

## 6. 🔥 配置热重载


### 6.1 热重载基础概念


**什么是热重载**：
热重载就像给运行中的汽车换轮胎，在不停车的情况下更换零件，系统继续运行的同时更新配置。

**热重载 vs 重启对比**：
```
传统重启：    运行 → 停止 → 更新 → 启动 → 运行
热重载：      运行 → 更新配置 → 继续运行
```

### 6.2 支持热重载的配置项


**可热重载的配置**：

```ruby
# /etc/gitlab/gitlab.rb - 支持热重载的配置
gitlab_rails['time_zone'] = 'Asia/Shanghai'  # ✅ 支持热重载
gitlab_rails['gitlab_email_enabled'] = false  # ✅ 支持热重载
gitlab_rails['gravatar_enabled'] = false      # ✅ 支持热重载

# 不支持热重载的配置（需要重启）
postgresql['port'] = 5432                     # ❌ 需要重启
nginx['listen_port'] = 80                     # ❌ 需要重启
```

### 6.3 热重载操作方法


**发送热重载信号**：

```bash
# 向Unicorn发送USR2信号进行热重载
sudo gitlab-ctl kill HUP unicorn

# 重新加载Nginx配置
sudo gitlab-ctl hup nginx

# 重新加载Sidekiq配置
sudo gitlab-ctl restart sidekiq
```

**验证热重载效果**：

```bash
# 检查进程ID是否变化
ps aux | grep unicorn
# PID不变说明是热重载，PID变化说明是重启
```

### 6.4 动态配置更新


**动态配置管理示例**：

```bash
#!/bin/bash
# hot_reload_config.sh

echo "🔥 执行热重载配置..."

# 1. 备份当前配置
cp /etc/gitlab/gitlab.rb /etc/gitlab/gitlab.rb.backup

# 2. 更新配置
sed -i "s/time_zone = 'UTC'/time_zone = 'Asia\/Shanghai'/" /etc/gitlab/gitlab.rb

# 3. 发送重载信号
gitlab-ctl hup nginx
gitlab-ctl kill HUP unicorn

# 4. 验证配置生效
gitlab-rails runner "puts Time.zone"

echo "✅ 热重载完成"
```

---

## 7. ↩️ 版本回滚配置


### 7.1 回滚基础概念


**什么是版本回滚**：
版本回滚就像时光倒流，把系统恢复到之前正常工作的状态，就像撤销了一次升级操作。

**回滚场景分类**：
```
配置回滚：     新配置有问题 → 恢复旧配置
版本回滚：     新版本有bug → 恢复旧版本  
数据回滚：     数据被破坏 → 恢复备份数据
```

### 7.2 配置文件回滚


**配置版本管理**：

```bash
# 创建配置版本管理目录
sudo mkdir -p /etc/gitlab/versions

# 每次修改前备份配置
sudo cp /etc/gitlab/gitlab.rb /etc/gitlab/versions/gitlab.rb.$(date +%Y%m%d_%H%M%S)

# 查看配置历史
ls -la /etc/gitlab/versions/
```

**快速配置回滚**：

```bash
#!/bin/bash
# config_rollback.sh

echo "📋 可用的配置版本："
ls -la /etc/gitlab/versions/

read -p "请输入要回滚的配置文件名: " config_file

if [ -f "/etc/gitlab/versions/$config_file" ]; then
    # 备份当前配置
    cp /etc/gitlab/gitlab.rb /etc/gitlab/gitlab.rb.before_rollback
    
    # 恢复指定版本
    cp "/etc/gitlab/versions/$config_file" /etc/gitlab/gitlab.rb
    
    # 重新配置
    gitlab-ctl reconfigure
    
    echo "✅ 配置回滚完成"
else
    echo "❌ 配置文件不存在"
fi
```

### 7.3 版本降级配置


**版本降级步骤**：

```bash
# 1. 停止GitLab服务
sudo gitlab-ctl stop

# 2. 卸载当前版本
sudo apt remove gitlab-ee

# 3. 安装目标版本
sudo apt install gitlab-ee=目标版本号

# 4. 恢复配置和数据
sudo cp gitlab.rb.backup /etc/gitlab/gitlab.rb
sudo gitlab-backup restore BACKUP=备份文件名

# 5. 重新配置
sudo gitlab-ctl reconfigure
sudo gitlab-ctl start
```

### 7.4 自动回滚配置


**健康检查回滚脚本**：

```bash
#!/bin/bash
# auto_rollback.sh

# 升级后健康检查
check_health() {
    # 检查HTTP响应
    if curl -f -s http://localhost > /dev/null; then
        echo "✅ HTTP检查通过"
        return 0
    else
        echo "❌ HTTP检查失败"
        return 1
    fi
}

# 执行升级
echo "🚀 开始升级..."
# 升级命令...

# 等待服务启动
sleep 30

# 健康检查
if check_health; then
    echo "✅ 升级成功"
else
    echo "⚠️  升级失败，开始自动回滚..."
    # 执行回滚
    gitlab-backup restore BACKUP=pre_upgrade_backup
    gitlab-ctl reconfigure
    echo "✅ 自动回滚完成"
fi
```

---

## 8. 🔍 系统诊断工具


### 8.1 内置诊断命令


**基础诊断工具**：

```bash
# GitLab健康检查（最重要的诊断命令）
sudo gitlab-rake gitlab:check

# 环境信息检查
sudo gitlab-rake gitlab:env:info

# Git仓库检查
sudo gitlab-rake gitlab:git:fsck

# 数据库检查
sudo gitlab-rake gitlab:db:check

# 配置检查
sudo gitlab-ctl check-config
```

### 8.2 服务状态诊断


**服务状态监控**：

```bash
# 查看所有服务状态
sudo gitlab-ctl status

# 查看服务日志
sudo gitlab-ctl tail

# 查看特定服务日志
sudo gitlab-ctl tail nginx
sudo gitlab-ctl tail unicorn
```

**服务状态解读**：
- `run`: 服务正常运行 ✅
- `down`: 服务已停止 ⏸️
- `fail`: 服务启动失败 ❌

### 8.3 性能诊断配置


**性能监控设置**：

```ruby
# /etc/gitlab/gitlab.rb - 性能监控配置
gitlab_rails['monitoring_whitelist'] = ['127.0.0.1', '::1']
grafana['enable'] = true
prometheus['enable'] = true
prometheus['monitor_kubernetes'] = false
```

**系统资源检查脚本**：

```bash
#!/bin/bash
# system_diagnostic.sh

echo "🔍 GitLab系统诊断报告"
echo "=========================="

# CPU使用率
echo "📊 CPU使用率:"
top -b -n1 | grep "Cpu(s)" | awk '{print $2}' | awk -F'%' '{print $1}'

# 内存使用
echo "💾 内存使用:"
free -h

# 磁盘使用
echo "💿 磁盘使用:"
df -h

# GitLab进程
echo "🔄 GitLab进程:"
ps aux | grep gitlab | grep -v grep

# 网络连接
echo "🌐 网络连接:"
netstat -tlnp | grep -E '(80|443|22)'

echo "=========================="
echo "✅ 诊断完成"
```

---

## 9. 🚨 故障排查配置


### 9.1 常见故障类型


**故障分类表**：

| 故障类型 | **症状表现** | **可能原因** | **优先级** |
|---------|-------------|-------------|-----------|
| **服务无响应** | `无法访问Web界面` | `服务停止/端口被占用` | `🔴 紧急` |
| **登录失败** | `用户无法登录` | `认证配置错误` | `🟡 重要` |
| **Git操作失败** | `push/pull报错` | `SSH配置/权限问题` | `🟡 重要` |
| **性能缓慢** | `页面加载慢` | `资源不足/配置不当` | `🔵 一般` |

### 9.2 日志配置和分析


**关键日志位置**：

```bash
# 主要日志文件位置
/var/log/gitlab/nginx/                 # Web服务器日志
/var/log/gitlab/unicorn/               # 应用服务器日志  
/var/log/gitlab/postgresql/            # 数据库日志
/var/log/gitlab/redis/                 # 缓存日志
/var/log/gitlab/sidekiq/               # 后台任务日志
```

**日志级别配置**：

```ruby
# /etc/gitlab/gitlab.rb - 日志配置
gitlab_rails['log_level'] = 'info'     # debug, info, warn, error
nginx['error_log_level'] = 'error'
postgresql['log_min_duration_statement'] = 1000  # 记录超过1秒的SQL
```

### 9.3 故障自动检测配置


**健康检查脚本**：

```bash
#!/bin/bash
# health_monitor.sh

# 定义检查函数
check_web_service() {
    if curl -f -s http://localhost/users/sign_in > /dev/null; then
        echo "✅ Web服务正常"
        return 0
    else
        echo "❌ Web服务异常"
        return 1
    fi
}

check_database() {
    if gitlab-rails runner "puts User.count" > /dev/null 2>&1; then
        echo "✅ 数据库连接正常"
        return 0
    else
        echo "❌ 数据库连接异常"
        return 1
    fi
}

check_git_service() {
    if su - git -c "gitlab-rake gitlab:check SANITIZE=true" | grep -q "All done"; then
        echo "✅ Git服务正常"
        return 0
    else
        echo "❌ Git服务异常"
        return 1
    fi
}

# 执行检查
echo "🔍 开始健康检查..."
all_good=true

check_web_service || all_good=false
check_database || all_good=false  
check_git_service || all_good=false

if $all_good; then
    echo "✅ 所有服务正常"
    exit 0
else
    echo "⚠️  发现异常，请检查日志"
    exit 1
fi
```

### 9.4 故障恢复配置


**自动恢复策略**：

```bash
# 服务自动重启配置
# /etc/systemd/system/gitlab-runsvdir.service
[Unit]
Description=GitLab Runit supervision process
After=multi-user.target

[Service]
ExecStart=/opt/gitlab/embedded/bin/runsvdir-start
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

**故障恢复脚本**：

```bash
#!/bin/bash
# auto_recovery.sh

echo "🚨 检测到故障，开始自动恢复..."

# 1. 尝试重启服务
gitlab-ctl restart

# 2. 等待服务启动
sleep 30

# 3. 验证恢复状态
if curl -f -s http://localhost > /dev/null; then
    echo "✅ 自动恢复成功"
    # 发送恢复通知
    echo "GitLab服务已自动恢复" | mail -s "GitLab恢复通知" admin@company.com
else
    echo "❌ 自动恢复失败，需要人工干预"
    # 发送故障通知
    echo "GitLab自动恢复失败，请立即检查" | mail -s "GitLab故障告警" admin@company.com
fi
```

---

## 10. 📋 核心要点总结


### 10.1 必须掌握的核心概念


```
🔧 维护模式：系统升级和维护时的安全保护机制
🚀 升级配置：版本更新时的系统配置管理
💾 数据迁移：数据在不同环境间的安全转移
🔄 重启策略：服务重启的不同方式和适用场景
🔥 热重载：无需重启即可更新配置的技术
↩️  版本回滚：出现问题时恢复到之前状态
🔍 系统诊断：发现和定位系统问题的工具
🚨 故障排查：解决系统故障的方法和流程
```

### 10.2 关键操作命令速查


**基础操作**：
```bash
# 启用维护模式
gitlab-ctl reconfigure

# 检查系统状态  
gitlab-ctl status

# 健康检查
gitlab-rake gitlab:check

# 创建备份
gitlab-backup create

# 查看日志
gitlab-ctl tail
```

### 10.3 最佳实践建议


**🔸 维护前准备**
- ✅ 提前通知用户维护时间
- ✅ 创建完整系统备份
- ✅ 准备回滚计划
- ✅ 测试维护步骤

**🔸 操作执行原则**
- ✅ 小步骤，多验证
- ✅ 记录每个操作
- ✅ 遇到问题立即停止
- ✅ 保持冷静，按计划执行

**🔸 故障处理要点**
- ✅ 先看日志，再动手
- ✅ 优先恢复服务，后查原因
- ✅ 记录故障处理过程
- ✅ 分析根本原因，避免重复

### 10.4 实际应用场景


**日常维护场景**：
- 🗓️ **定期备份**：每天自动备份，每周验证备份
- 🔄 **配置更新**：业务需求变更时的配置调整
- 📊 **性能优化**：根据监控数据调整系统参数
- 🚨 **故障处理**：快速响应和解决系统问题

**项目升级场景**：
- 📋 **升级计划**：制定详细的升级时间表
- 🧪 **测试验证**：在测试环境验证升级步骤
- 🚀 **生产升级**：按计划执行生产环境升级
- ✅ **升级验证**：确认所有功能正常工作

**核心记忆要点**：
- 维护模式是系统升级的安全保障
- 备份是所有操作的安全底线
- 监控和日志是故障排查的眼睛
- 计划和测试是成功维护的基础