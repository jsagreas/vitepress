---
title: 19、系统监控配置设置
---
## 📚 目录

1. [监控系统基础概念](#1-监控系统基础概念)
2. [Prometheus监控集成](#2-Prometheus监控集成)
3. [监控指标导出配置](#3-监控指标导出配置)
4. [健康检查端点设置](#4-健康检查端点设置)
5. [性能监控配置](#5-性能监控配置)
6. [资源使用监控](#6-资源使用监控)
7. [告警规则配置](#7-告警规则配置)
8. [监控仪表盘设置](#8-监控仪表盘设置)
9. [监控数据保留策略](#9-监控数据保留策略)
10. [核心要点总结](#10-核心要点总结)

---

## 1. 🔍 监控系统基础概念


### 1.1 什么是GitLab监控


**简单理解**：监控就像给你的GitLab系统装上"体检仪器"，时刻检查系统是否健康运行。

```
想象成医院的监护仪：
病人（GitLab系统）──────→ 监护仪（监控系统）
  ↓                        ↓
身体指标                  系统指标
- 心跳                    - CPU使用率
- 血压                    - 内存使用量  
- 体温                    - 磁盘空间
- 血氧                    - 网络流量
```

**监控的核心作用**：
- 🔸 **预警作用**：系统出问题前就发现异常
- 🔸 **性能分析**：了解系统运行效率如何
- 🔸 **故障定位**：快速找到问题出在哪里
- 🔸 **容量规划**：提前知道何时需要扩容

### 1.2 GitLab监控架构图


```
GitLab系统架构监控视图：

┌─────────────────────────────────────────────────────┐
│                GitLab 监控生态                        │
├─────────────────────────────────────────────────────┤
│  Web界面    │  Git仓库   │  CI/CD管道  │  容器注册表  │
│    ↓            ↓           ↓            ↓         │
├─────────────────────────────────────────────────────┤
│              监控数据采集层                           │
│  • 应用指标   • 系统指标   • 业务指标   • 自定义指标    │
│    ↓            ↓           ↓            ↓         │
├─────────────────────────────────────────────────────┤
│                Prometheus                           │
│              (数据存储与查询)                          │
│                    ↓                               │
├─────────────────────────────────────────────────────┤
│   Grafana仪表盘  │  告警系统   │  API接口          │
│   (数据可视化)    │  (异常通知)  │  (外部集成)        │
└─────────────────────────────────────────────────────┘
```

### 1.3 监控的重要性


**为什么需要监控**：
- ⚡ **快速响应**：问题出现后几分钟内就能发现
- 📊 **数据驱动**：基于真实数据做运维决策
- 🛠️ **主动维护**：不等用户投诉就解决问题
- 💰 **成本控制**：避免资源浪费，优化性能

---

## 2. 📈 Prometheus监控集成


### 2.1 Prometheus是什么


**通俗解释**：Prometheus就像一个**专业的数据收集员**，定期去各个系统"询问"运行状态，然后把这些信息整理存储起来。

**工作原理简化版**：
```
第1步：Prometheus定时"拜访"GitLab
第2步：GitLab告诉Prometheus当前状态数据  
第3步：Prometheus把数据记录在自己的"账本"里
第4步：需要查询时，从"账本"里查找数据
```

### 2.2 启用Prometheus监控


**在gitlab.rb配置文件中启用**：

```ruby
# 启用Prometheus监控
prometheus_monitoring['enable'] = true

# 设置Prometheus监听地址
prometheus['listen_address'] = '0.0.0.0:9090'

# 允许外部访问（生产环境需谨慎）
prometheus['admin_email'] = 'admin@example.com'
```

**配置说明**：
- `enable = true`：就像打开监控系统的"总开关"
- `listen_address`：告诉Prometheus在哪个地址"接听电话"
- `9090`：Prometheus的默认端口号，就像电话号码

### 2.3 集成配置详解


**完整的Prometheus集成配置**：

```ruby
# 基础监控配置
prometheus_monitoring['enable'] = true
prometheus['listen_address'] = '0.0.0.0:9090'
prometheus['scrape_interval'] = 15          # 每15秒采集一次数据
prometheus['scrape_timeout'] = 15           # 采集超时时间
prometheus['chunk_encoding'] = 1            # 数据压缩方式

# 数据保留配置  
prometheus['retention_time'] = '15d'        # 保留15天的监控数据
prometheus['retention_size'] = '10GB'       # 最大存储10GB数据

# 外部访问配置
prometheus['external_url'] = 'http://gitlab.example.com:9090'
```

**重要参数解释**：
- 🕐 **scrape_interval**：采集频率，15秒=每15秒问一次"你好吗？"
- ⏱️ **scrape_timeout**：等待回答的时间，超时就认为系统无响应
- 💾 **retention_time**：数据保留时间，过期自动删除节省空间
- 📏 **retention_size**：存储空间限制，防止硬盘被撑爆

---

## 3. 📊 监控指标导出配置


### 3.1 什么是监控指标


**通俗理解**：监控指标就像汽车仪表盘上的各种表，每个表显示不同的信息。

```
汽车仪表盘对比GitLab监控指标：

汽车仪表盘                    GitLab监控指标
├── 速度表                   ├── 请求处理速度
├── 油量表                   ├── 内存使用量
├── 水温表                   ├── CPU温度
├── 转速表                   ├── 数据库连接数
└── 油压表                   └── 磁盘IO压力
```

### 3.2 GitLab内置指标类型


**核心指标分类**：

| 指标类型 | **说明** | **实际例子** | **重要程度** |
|---------|----------|-------------|-------------|
| 🌐 **Web指标** | `Web界面访问情况` | `页面响应时间、用户登录数` | `⭐⭐⭐` |
| 🔄 **Git指标** | `代码仓库操作` | `push/pull次数、仓库大小` | `⭐⭐⭐` |
| 🚀 **CI/CD指标** | `持续集成情况` | `构建成功率、构建耗时` | `⭐⭐⭐` |
| 💾 **数据库指标** | `数据库性能` | `查询速度、连接数` | `⭐⭐` |
| 🖥️ **系统指标** | `服务器硬件` | `CPU、内存、磁盘使用率` | `⭐⭐⭐` |

### 3.3 指标导出配置


**启用指标导出**：

```ruby
# 启用GitLab指标导出
gitlab_exporter['enable'] = true
gitlab_exporter['listen_address'] = '0.0.0.0'
gitlab_exporter['listen_port'] = 9168

# Web服务指标
puma['exporter_enabled'] = true
puma['exporter_address'] = '0.0.0.0'
puma['exporter_port'] = 8083

# 数据库指标  
postgres_exporter['enable'] = true
postgres_exporter['listen_address'] = '0.0.0.0:9187'

# Redis指标
redis_exporter['enable'] = true
redis_exporter['listen_address'] = '0.0.0.0:9121'
```

**端口功能说明**：
- 🔌 **9168端口**：GitLab主要业务指标
- 🌐 **8083端口**：Web服务器性能指标  
- 🗃️ **9187端口**：数据库相关指标
- ⚡ **9121端口**：缓存系统指标

---

## 4. 🏥 健康检查端点设置


### 4.1 健康检查的概念


**生活化比喻**：健康检查就像每天量体温，快速判断身体是否正常。

```
人体健康检查 ──────→ GitLab健康检查
     ↓                      ↓
   量体温                 访问健康URL
   听心跳                 检查服务状态  
   看脸色                 查看响应时间
     ↓                      ↓
 正常/异常              健康/不健康
```

### 4.2 内置健康检查端点


**GitLab提供的健康检查URL**：

| 检查类型 | **URL路径** | **检查内容** | **用途** |
|---------|------------|-------------|---------|
| 🟢 **基础健康** | `/health` | `GitLab是否在运行` | `负载均衡器检查` |
| 🔍 **就绪状态** | `/readiness` | `所有服务是否就绪` | `部署完成检查` |
| 📊 **存活状态** | `/liveness` | `核心服务是否响应` | `容器编排检查` |
| ⚡ **详细状态** | `/-/health` | `各组件详细状态` | `运维人员检查` |

### 4.3 配置健康检查


**启用和配置健康检查**：

```ruby
# 启用健康检查功能
gitlab_rails['monitoring_whitelist'] = ['127.0.0.1', '192.168.0.0/16']

# 设置健康检查超时时间
gitlab_rails['health_check_grace_period'] = 30

# 配置检查访问令牌（可选）
gitlab_rails['health_check_access_token'] = 'your-secret-token-here'
```

**参数解释**：
- 🔐 **whitelist**：允许哪些IP地址访问健康检查，保护系统安全
- ⏱️ **grace_period**：给系统30秒"缓冲时间"启动
- 🔑 **access_token**：访问健康检查需要的"密码"

### 4.4 健康检查响应示例


**正常健康状态返回**：
```json
{
  "status": "ok",
  "message": "GitLab is healthy",
  "checks": {
    "database": "ok",
    "redis": "ok", 
    "gitaly": "ok"
  }
}
```

**异常状态返回**：
```json
{
  "status": "failed",
  "message": "Database connection failed",
  "checks": {
    "database": "failed",
    "redis": "ok",
    "gitaly": "ok"
  }
}
```

---

## 5. ⚡ 性能监控配置


### 5.1 性能监控的重要性


**为什么要监控性能**：想象GitLab是一条高速公路，性能监控就是监控交通流量。

```
高速公路监控 ──────→ GitLab性能监控
     ↓                    ↓
  车流量统计            请求处理量
  平均车速              平均响应时间  
  拥堵检测              性能瓶颈发现
  事故预警              异常性能告警
```

### 5.2 关键性能指标


**需要重点关注的性能数据**：

| 性能指标 | **正常范围** | **告警阈值** | **影响** |
|---------|-------------|-------------|---------|
| 🚀 **响应时间** | `< 200ms` | `> 1000ms` | `用户体验差` |
| 📈 **并发用户** | `依据规模` | `超过80%设计值` | `系统过载` |
| 💾 **内存使用** | `< 70%` | `> 85%` | `系统变慢` |
| 🔄 **CPU使用** | `< 60%` | `> 80%` | `处理变慢` |
| 💿 **磁盘IO** | `< 80%` | `> 90%` | `操作卡顿` |

### 5.3 性能监控配置


**启用性能指标收集**：

```ruby
# 启用性能监控
gitlab_rails['application_performance_monitoring'] = true

# 配置采样率（1.0 = 100%采样，0.1 = 10%采样）
gitlab_rails['performance_bar_sample_rate'] = 0.1

# Web服务器性能配置
puma['worker_processes'] = 4           # 工作进程数
puma['min_threads'] = 4               # 最小线程数  
puma['max_threads'] = 16              # 最大线程数
puma['worker_timeout'] = 60           # 工作超时时间

# 数据库连接池配置
gitlab_rails['db_pool'] = 10          # 数据库连接池大小
```

**配置说明**：
- 📊 **采样率**：不是每个请求都记录，10%采样=每10个请求记录1个
- 👥 **工作进程**：像雇佣4个员工同时处理用户请求
- 🧵 **线程配置**：每个员工可以同时处理4-16个任务
- 🔗 **连接池**：预先准备10个数据库连接，避免临时创建

---

## 6. 🖥️ 资源使用监控


### 6.1 系统资源监控概念


**系统资源就像家里的水电气**：

```
家庭资源管理 ──────→ 系统资源监控
     ↓                    ↓
   水压监控              内存压力监控
   电量监控              CPU使用监控  
   燃气监控              磁盘空间监控
   网络信号              网络带宽监控
```

### 6.2 启用Node Exporter


**Node Exporter是什么**：专门收集服务器硬件信息的"调查员"。

```ruby
# 启用系统监控
node_exporter['enable'] = true
node_exporter['listen_address'] = '0.0.0.0:9100'

# 监控项目配置
node_exporter['flags'] = {
  'collector.systemd' => nil,           # 监控系统服务
  'collector.processes' => nil,         # 监控进程信息
  'collector.filesystem.ignored-mount-points' => '^/(dev|proc|sys|var/lib/docker/.+)($|/)',
  'collector.netdev.ignored-devices' => '^(veth.*|docker.*|lo)$'
}
```

### 6.3 资源监控告警阈值


**推荐的资源使用告警线**：

| 资源类型 | **警告阈值** | **严重阈值** | **建议措施** |
|---------|-------------|-------------|-------------|
| 💾 **内存使用率** | `75%` | `90%` | `增加内存或优化应用` |
| 🔄 **CPU使用率** | `70%` | `85%` | `升级CPU或优化代码` |
| 💿 **磁盘使用率** | `80%` | `95%` | `清理文件或扩容` |
| 📶 **网络带宽** | `70%` | `90%` | `升级带宽或优化传输` |
| 🔗 **文件描述符** | `80%` | `95%` | `调整系统限制` |

### 6.4 自定义资源监控


**监控GitLab特定资源**：

```ruby
# GitLab存储监控
gitlab_rails['artifacts_expire_at'] = '30 days'     # 构建产物保留期
gitlab_rails['lfs_expire_at'] = '90 days'          # 大文件保留期

# 日志文件大小限制
logging['svlogd_size'] = 200 * 1024 * 1024         # 单个日志文件200MB
logging['svlogd_num'] = 30                          # 保留30个日志文件

# 临时文件清理
gitlab_rails['gitlab_shell_ssh_daemon'] = true
gitlab_rails['time_zone'] = 'Asia/Shanghai'
```

---

## 7. 🚨 告警规则配置


### 7.1 告警系统的作用


**告警就像家里的烟雾报警器**：

```
烟雾报警器 ──────→ GitLab告警系统
     ↓                  ↓
  检测烟雾              检测异常指标
  发出警报              发送告警通知  
  提醒处理              通知运维人员
```

### 7.2 配置AlertManager


**告警管理器配置**：

```ruby
# 启用告警管理器
alertmanager['enable'] = true
alertmanager['listen_address'] = '0.0.0.0:9093'

# 告警配置文件路径
alertmanager['config_file'] = '/var/opt/gitlab/alertmanager/alertmanager.yml'

# 数据保留时间
alertmanager['retention'] = '120h'                 # 保留5天告警数据
```

### 7.3 告警规则示例


**创建常用告警规则**：

```yaml
# /var/opt/gitlab/alertmanager/alertmanager.yml
global:
  smtp_smarthost: 'localhost:587'
  smtp_from: 'alerts@example.com'

route:
  group_by: ['alertname']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 1h
  receiver: 'default'

receivers:
- name: 'default'
  email_configs:
  - to: 'admin@example.com'
    subject: 'GitLab告警：{{ .GroupLabels.alertname }}'
    body: |
      告警详情：
      {{ range .Alerts }}
      - 告警：{{ .Annotations.summary }}
      - 详情：{{ .Annotations.description }}
      - 时间：{{ .StartsAt }}
      {{ end }}
```

### 7.4 常见告警规则


**实用的告警规则配置**：

| 告警类型 | **触发条件** | **告警级别** | **通知方式** |
|---------|-------------|-------------|-------------|
| 🔴 **服务宕机** | `服务无响应超过1分钟` | `严重` | `电话+短信+邮件` |
| 🟠 **高CPU使用** | `CPU使用率>85%持续5分钟` | `警告` | `邮件+企业微信` |
| 🟡 **磁盘空间** | `可用空间<15%` | `注意` | `邮件通知` |
| 🟢 **慢查询** | `数据库查询>3秒` | `信息` | `日志记录` |

---

## 8. 📈 监控仪表盘设置


### 8.1 Grafana仪表盘概念


**Grafana就像汽车的仪表盘**：把各种监控数据用图表直观显示出来。

```
汽车仪表盘 ──────→ Grafana监控仪表盘
     ↓                    ↓
   指针显示              图表显示
   数字显示              数值显示
   警告灯                告警状态
   仪表布局              面板布局
```

### 8.2 启用Grafana


**配置Grafana服务**：

```ruby
# 启用Grafana
grafana['enable'] = true
grafana['listen_address'] = '0.0.0.0'
grafana['listen_port'] = 3000

# 管理员配置
grafana['admin_user'] = 'admin'
grafana['admin_password'] = 'your-secure-password'

# 数据源配置（自动连接Prometheus）
grafana['auto_migrate'] = true
grafana['provision_prometheus'] = true
```

### 8.3 推荐仪表盘布局


**GitLab监控仪表盘结构**：

```
┌─────────────────────────────────────────────────────┐
│                系统概览仪表盘                         │
├─────────────────┬─────────────────┬─────────────────┤
│   服务状态      │   系统资源      │   用户活动      │
│ ✅ Web服务      │ CPU: 45% 📊    │ 在线用户: 128   │
│ ✅ Git服务      │ 内存: 67% 📊   │ 活跃项目: 56    │
│ ✅ 数据库       │ 磁盘: 23% 📊   │ 构建队列: 3     │
├─────────────────┼─────────────────┼─────────────────┤
│        响应时间趋势图            │   错误率统计     │
│    ╭─╮                         │ HTTP 4xx: 2%   │
│  ╭─╯ ╰─╮    今天: 245ms         │ HTTP 5xx: 0.1% │
│╭─╯     ╰─╮  昨天: 198ms         │ 数据库错误: 0   │
├─────────────────────────────────┼─────────────────┤
│           CI/CD管道统计          │   告警状态      │
│ 成功: ████████░░ 85%            │ 🟢 正常: 23     │
│ 失败: ██░░░░░░░░ 12%            │ 🟡 警告: 1      │
│ 取消: █░░░░░░░░░ 3%             │ 🔴 严重: 0      │
└─────────────────────────────────┴─────────────────┘
```

### 8.4 仪表盘配置技巧


**优化仪表盘显示效果**：

- ⭐ **重要指标放顶部**：用户最关心的数据优先显示
- 🎨 **颜色统一规范**：绿色=正常，黄色=警告，红色=异常
- 📊 **图表类型选择**：趋势用折线图，比例用饼图，状态用柱状图
- 🔄 **自动刷新频率**：系统监控30秒，业务监控5分钟

---

## 9. 🗄️ 监控数据保留策略


### 9.1 数据保留的重要性


**为什么要限制数据保留时间**：就像清理手机照片，太多了会占空间变卡。

```
手机存储管理 ──────→ 监控数据管理
     ↓                    ↓
   删除旧照片            删除旧监控数据
   保留重要的            保留关键指标
   压缩存储              数据压缩存储
   分类整理              分级保留策略
```

### 9.2 数据保留配置


**设置不同类型数据的保留期**：

```ruby
# Prometheus数据保留
prometheus['retention_time'] = '15d'        # 原始数据保留15天
prometheus['retention_size'] = '10GB'       # 最大10GB存储

# 不同精度的数据保留策略
prometheus['recording_rules'] = {
  # 5分钟精度保留30天
  '5m_data' => '30d',
  # 1小时精度保留90天  
  '1h_data' => '90d',
  # 1天精度保留1年
  '1d_data' => '365d'
}

# 日志文件保留
logging['svlogd_num'] = 30               # 保留30个日志文件
logging['svlogd_size'] = 200 * 1024 * 1024  # 每个文件200MB
```

### 9.3 数据保留策略表


**推荐的数据保留时间**：

| 数据类型 | **保留时间** | **原因** | **存储空间** |
|---------|-------------|---------|-------------|
| 🔥 **实时指标** | `15天` | `故障排查够用` | `高精度，占空间大` |
| 📊 **每日汇总** | `90天` | `月度分析需要` | `中精度，空间适中` |
| 📈 **月度报告** | `1年` | `年度对比分析` | `低精度，占空间小` |
| 📋 **告警记录** | `6个月` | `历史问题追溯` | `只记录关键信息` |

### 9.4 自动清理配置


**设置自动清理任务**：

```ruby
# 启用自动清理任务
gitlab_rails['cron_jobs'] = {
  # 每天凌晨2点清理过期数据
  'cleanup_old_metrics' => {
    'cron' => '0 2 * * *',
    'job_class' => 'MetricsCleanupWorker'
  },
  
  # 每周清理构建缓存
  'cleanup_build_cache' => {
    'cron' => '0 3 * * 0',
    'job_class' => 'BuildCacheCleanupWorker'  
  }
}

# 自动压缩配置
prometheus['wal_compression'] = true        # 启用WAL压缩
prometheus['compact_range'] = '24h'         # 每24小时压缩一次
```

---

## 10. 📋 核心要点总结


### 10.1 必须掌握的基本概念


```
🔸 监控本质：给GitLab装"体检仪器"，实时了解系统健康状况
🔸 Prometheus：专业的监控数据收集和存储系统  
🔸 健康检查：快速判断GitLab服务是否正常的"体温计"
🔸 性能监控：关注响应时间、并发量等用户体验指标
🔸 资源监控：监控CPU、内存、磁盘等硬件资源使用情况
🔸 告警系统：异常时自动通知运维人员的"报警器"
🔸 数据保留：合理控制监控数据存储时间和空间
```

### 10.2 关键配置要点


**🔹 监控集成的核心步骤**：
```
第1步：启用Prometheus监控收集
第2步：配置各服务的指标导出  
第3步：设置健康检查端点
第4步：建立告警规则和通知
第5步：创建监控仪表盘
第6步：配置数据保留策略
```

**🔹 常用端口记忆**：
```
9090端口：Prometheus主服务
9168端口：GitLab业务指标
8083端口：Web服务器指标
9187端口：数据库指标
9100端口：系统硬件指标
3000端口：Grafana仪表盘
9093端口：告警管理器
```

**🔹 告警阈值建议**：
```
CPU使用率：警告70%，严重85%
内存使用率：警告75%，严重90%  
磁盘使用率：警告80%，严重95%
响应时间：警告1000ms，严重3000ms
错误率：警告5%，严重10%
```

### 10.3 实际应用价值


**🎯 监控的实际好处**：
- **预防故障**：问题发生前就发现并解决
- **快速定位**：出问题时几分钟找到原因
- **性能优化**：基于真实数据进行系统调优
- **容量规划**：提前知道何时需要扩容升级
- **用户体验**：确保GitLab运行流畅稳定

**🔧 运维实践建议**：
- **循序渐进**：先配置基础监控，再逐步完善
- **重点关注**：优先监控影响用户的核心指标
- **告警适度**：避免告警太多产生"狼来了"效应
- **定期检查**：每月检查监控配置是否需要调整
- **文档记录**：记录告警处理流程，方便团队协作

**核心记忆口诀**：
- 监控像体检，时刻看健康
- Prometheus收集，Grafana展现
- 告警要及时，数据要保留
- 配置需合理，运维更轻松