---
title: 4ã€Dockeré•œåƒæ„å»º
---
## ğŸ“š ç›®å½•

1. [Dockerfileç¼–å†™åŸºç¡€](#1-dockerfileç¼–å†™åŸºç¡€)
2. [é•œåƒæ„å»ºPipelineè®¾è®¡](#2-é•œåƒæ„å»ºpipelineè®¾è®¡)
3. [å¤šé˜¶æ®µæ„å»ºä¼˜åŒ–](#3-å¤šé˜¶æ®µæ„å»ºä¼˜åŒ–)
4. [é•œåƒæ ‡ç­¾ç®¡ç†ç­–ç•¥](#4-é•œåƒæ ‡ç­¾ç®¡ç†ç­–ç•¥)
5. [GitLab Container Registry](#5-gitlab-container-registry)
6. [é•œåƒå®‰å…¨æ‰«æ](#6-é•œåƒå®‰å…¨æ‰«æ)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ³ Dockerfileç¼–å†™åŸºç¡€


### 1.1 ä»€ä¹ˆæ˜¯Dockerfile


**ğŸ”¸ ç®€å•ç†è§£**
```
Dockerfile = åˆ¶ä½œé•œåƒçš„é…æ–¹

å°±åƒåšèœéœ€è¦èœè°±ä¸€æ ·ï¼š
èœè°±å‘Šè¯‰ä½ ï¼šå…ˆæ”¾ä»€ä¹ˆï¼Œåæ”¾ä»€ä¹ˆï¼Œæ€ä¹ˆåš
Dockerfileå‘Šè¯‰Dockerï¼šå…ˆè£…ä»€ä¹ˆè½¯ä»¶ï¼Œååšä»€ä¹ˆé…ç½®ï¼Œæ€ä¹ˆè¿è¡Œ

æœ€ç»ˆç›®æ ‡ï¼šæŠŠä½ çš„åº”ç”¨æ‰“åŒ…æˆä¸€ä¸ª"ç›’å­"ï¼Œè¿™ä¸ªç›’å­å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹è¿è¡Œ
```

### 1.2 DockerfileåŸºæœ¬ç»“æ„


**ğŸ“‹ åŸºç¡€æ¶æ„**
```dockerfile
# ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©åŸºç¡€é•œåƒï¼ˆç›¸å½“äºé€‰æ‹©æ“ä½œç³»ç»Ÿï¼‰
FROM node:16-alpine

# ç¬¬äºŒæ­¥ï¼šè®¾ç½®å·¥ä½œç›®å½•ï¼ˆç›¸å½“äºè¿›å…¥æŸä¸ªæ–‡ä»¶å¤¹ï¼‰
WORKDIR /app

# ç¬¬ä¸‰æ­¥ï¼šå¤åˆ¶æ–‡ä»¶ï¼ˆæŠŠé¡¹ç›®æ–‡ä»¶æ‹·è´è¿›å»ï¼‰
COPY package*.json ./
COPY . .

# ç¬¬å››æ­¥ï¼šå®‰è£…ä¾èµ–ï¼ˆå®‰è£…éœ€è¦çš„è½¯ä»¶ï¼‰
RUN npm install

# ç¬¬äº”æ­¥ï¼šæš´éœ²ç«¯å£ï¼ˆå‘Šè¯‰å¤–ç•Œè¿™ä¸ªåº”ç”¨ç”¨å“ªä¸ªç«¯å£ï¼‰
EXPOSE 3000

# ç¬¬å…­æ­¥ï¼šå¯åŠ¨å‘½ä»¤ï¼ˆå®¹å™¨è¿è¡Œæ—¶æ‰§è¡Œä»€ä¹ˆå‘½ä»¤ï¼‰
CMD ["npm", "start"]
```

### 1.3 å¸¸ç”¨DockerfileæŒ‡ä»¤è¯¦è§£


| æŒ‡ä»¤ | **ä½œç”¨** | **é€šä¿—è§£é‡Š** | **ç¤ºä¾‹** |
|------|---------|-------------|---------|
| ğŸ”¸ **FROM** | `é€‰æ‹©åŸºç¡€é•œåƒ` | `é€‰æ‹©"æ“ä½œç³»ç»Ÿ"` | `FROM ubuntu:20.04` |
| ğŸ”¸ **WORKDIR** | `è®¾ç½®å·¥ä½œç›®å½•` | `è¿›å…¥æŸä¸ªæ–‡ä»¶å¤¹` | `WORKDIR /app` |
| ğŸ”¸ **COPY** | `å¤åˆ¶æ–‡ä»¶` | `æŠŠæœ¬åœ°æ–‡ä»¶æ‹·è´åˆ°é•œåƒé‡Œ` | `COPY . /app` |
| ğŸ”¸ **RUN** | `æ‰§è¡Œå‘½ä»¤` | `åœ¨é•œåƒæ„å»ºæ—¶è¿è¡Œå‘½ä»¤` | `RUN apt-get update` |
| ğŸ”¸ **CMD** | `é»˜è®¤å¯åŠ¨å‘½ä»¤` | `å®¹å™¨å¯åŠ¨æ—¶è¿è¡Œä»€ä¹ˆ` | `CMD ["npm", "start"]` |
| ğŸ”¸ **EXPOSE** | `å£°æ˜ç«¯å£` | `å‘Šè¯‰åˆ«äººç”¨å“ªä¸ªç«¯å£è®¿é—®` | `EXPOSE 80` |

### 1.4 å®ç”¨Dockerfileç¤ºä¾‹


**ğŸŒŸ Node.jsåº”ç”¨ç¤ºä¾‹**
```dockerfile
# é€‰æ‹©è½»é‡çº§çš„Node.jsé•œåƒ
FROM node:16-alpine

# åˆ›å»ºappç”¨æˆ·ï¼ˆå®‰å…¨è€ƒè™‘ï¼‰
RUN addgroup -g 1001 -S nodejs
RUN adduser -S nextjs -u 1001

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å…ˆå¤åˆ¶packageæ–‡ä»¶ï¼ˆåˆ©ç”¨Dockerç¼“å­˜ï¼‰
COPY package*.json ./

# å®‰è£…ä¾èµ–
RUN npm ci --only=production

# å¤åˆ¶æºç 
COPY --chown=nextjs:nodejs . .

# åˆ‡æ¢åˆ°érootç”¨æˆ·
USER nextjs

# æš´éœ²ç«¯å£
EXPOSE 3000

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:3000/health || exit 1

# å¯åŠ¨åº”ç”¨
CMD ["npm", "start"]
```

---

## 2. ğŸ”§ é•œåƒæ„å»ºPipelineè®¾è®¡


### 2.1 GitLab CI/CDä¸­çš„é•œåƒæ„å»º


**ğŸ”¸ æ ¸å¿ƒæ¦‚å¿µ**
```
Pipeline = è‡ªåŠ¨åŒ–æµæ°´çº¿

ä¼ ç»Ÿæ–¹å¼ï¼šæ‰‹åŠ¨æ„å»ºé•œåƒ
1. å†™Dockerfile
2. æ‰‹åŠ¨æ‰§è¡Œ docker build
3. æ‰‹åŠ¨æ¨é€åˆ°ä»“åº“

GitLab CI/CDæ–¹å¼ï¼šè‡ªåŠ¨åŒ–æ„å»º
1. æäº¤ä»£ç 
2. GitLabè‡ªåŠ¨æ„å»ºé•œåƒ
3. è‡ªåŠ¨æ¨é€åˆ°ä»“åº“
4. è‡ªåŠ¨éƒ¨ç½²
```

### 2.2 åŸºç¡€æ„å»ºPipeline


**ğŸ“ .gitlab-ci.ymlé…ç½®**
```yaml
# å®šä¹‰æ„å»ºé˜¶æ®µ
stages:
  - build
  - test
  - deploy

# å®šä¹‰å˜é‡
variables:
  DOCKER_IMAGE: $CI_REGISTRY_IMAGE
  DOCKER_TAG: $CI_COMMIT_SHA

# é•œåƒæ„å»ºä»»åŠ¡
build-image:
  stage: build
  image: docker:latest
  services:
    - docker:dind  # Docker in Docker
  before_script:
    # ç™»å½•åˆ°GitLabå®¹å™¨ä»“åº“
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
  script:
    # æ„å»ºé•œåƒ
    - docker build -t $DOCKER_IMAGE:$DOCKER_TAG .
    - docker build -t $DOCKER_IMAGE:latest .
    # æ¨é€é•œåƒ
    - docker push $DOCKER_IMAGE:$DOCKER_TAG
    - docker push $DOCKER_IMAGE:latest
  only:
    - main
    - develop
```

### 2.3 æ„å»ºè¿‡ç¨‹å¯è§†åŒ–


```
ä»£ç æäº¤æµç¨‹ï¼š

å¼€å‘è€…           GitLabä»“åº“        GitLab Runner       Docker Registry
   |                |                   |                    |
   |--[1]git push-->|                   |                    |
   |                |--[2]è§¦å‘Pipeline->|                    |
   |                |                   |--[3]æ‹‰å–ä»£ç -------|
   |                |                   |                    |
   |                |                   |--[4]æ„å»ºé•œåƒ-------|
   |                |                   |                    |
   |                |                   |--[5]æ¨é€é•œåƒ------>|
   |                |<--[6]æ„å»ºå®Œæˆ-----|                    |
```

### 2.4 é«˜çº§æ„å»ºé…ç½®


**ğŸš€ ä¼˜åŒ–åçš„Pipeline**
```yaml
# ä½¿ç”¨æ„å»ºç¼“å­˜æå‡é€Ÿåº¦
build-optimized:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  variables:
    DOCKER_BUILDKIT: 1  # å¯ç”¨BuildKit
  before_script:
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
  script:
    # ä½¿ç”¨ç¼“å­˜æ„å»º
    - docker build 
        --cache-from $CI_REGISTRY_IMAGE:latest
        --tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
        --tag $CI_REGISTRY_IMAGE:latest
        .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE:latest
  retry: 2  # å¤±è´¥é‡è¯•2æ¬¡
  timeout: 30m  # è¶…æ—¶æ—¶é—´30åˆ†é’Ÿ
```

---

## 3. ğŸ—ï¸ å¤šé˜¶æ®µæ„å»ºä¼˜åŒ–


### 3.1 ä»€ä¹ˆæ˜¯å¤šé˜¶æ®µæ„å»º


**ğŸ”¸ æ ¸å¿ƒç†å¿µ**
```
ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜ï¼š
æ„å»ºç¯å¢ƒ = è¿è¡Œç¯å¢ƒ
â†“
é•œåƒå¾ˆå¤§ï¼ŒåŒ…å«å¾ˆå¤šä¸éœ€è¦çš„æ„å»ºå·¥å…·

å¤šé˜¶æ®µæ„å»ºçš„è§£å†³æ–¹æ¡ˆï¼š
æ„å»ºé˜¶æ®µï¼šåŒ…å«ç¼–è¯‘å·¥å…·ã€æºç ç­‰
è¿è¡Œé˜¶æ®µï¼šåªåŒ…å«è¿è¡Œæ—¶éœ€è¦çš„æ–‡ä»¶
â†“
æœ€ç»ˆé•œåƒæ›´å°ã€æ›´å®‰å…¨
```

### 3.2 å¤šé˜¶æ®µæ„å»ºç¤ºä¾‹


**ğŸ“ Node.jså¤šé˜¶æ®µæ„å»º**
```dockerfile
# =====================================
# ç¬¬ä¸€é˜¶æ®µï¼šæ„å»ºé˜¶æ®µï¼ˆbuilderï¼‰
# =====================================
FROM node:16-alpine AS builder

WORKDIR /app

# å¤åˆ¶packageæ–‡ä»¶
COPY package*.json ./

# å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆåŒ…æ‹¬å¼€å‘ä¾èµ–ï¼‰
RUN npm ci

# å¤åˆ¶æºç 
COPY . .

# æ„å»ºåº”ç”¨
RUN npm run build

# =====================================
# ç¬¬äºŒé˜¶æ®µï¼šè¿è¡Œé˜¶æ®µï¼ˆproductionï¼‰
# =====================================
FROM node:16-alpine AS production

# åˆ›å»ºérootç”¨æˆ·
RUN addgroup -g 1001 -S nodejs
RUN adduser -S appuser -u 1001

WORKDIR /app

# åªå¤åˆ¶packageæ–‡ä»¶
COPY package*.json ./

# åªå®‰è£…ç”Ÿäº§ä¾èµ–
RUN npm ci --only=production && npm cache clean --force

# ä»æ„å»ºé˜¶æ®µå¤åˆ¶æ„å»ºç»“æœ
COPY --from=builder --chown=appuser:nodejs /app/dist ./dist

# åˆ‡æ¢ç”¨æˆ·
USER appuser

EXPOSE 3000

CMD ["npm", "start"]
```

### 3.3 æ„å»ºä¼˜åŒ–å¯¹æ¯”


| æ„å»ºæ–¹å¼ | **é•œåƒå¤§å°** | **å®‰å…¨æ€§** | **æ„å»ºæ—¶é—´** | **é€‚ç”¨åœºæ™¯** |
|---------|------------|-----------|-------------|-------------|
| ğŸ”¸ **å•é˜¶æ®µæ„å»º** | `è¾ƒå¤§(500MB+)` | `è¾ƒä½` | `è¾ƒå¿«` | `å¼€å‘ç¯å¢ƒ` |
| ğŸ”¸ **å¤šé˜¶æ®µæ„å»º** | `è¾ƒå°(50MB+)` | `è¾ƒé«˜` | `ç¨æ…¢` | `ç”Ÿäº§ç¯å¢ƒ` |
| ğŸ”¸ **ç²¾ç®€åŸºç¡€é•œåƒ** | `æœ€å°(10MB+)` | `æœ€é«˜` | `æœ€æ…¢` | `ä¸¥æ ¼è¦æ±‚åœºæ™¯` |

### 3.4 æ„å»ºä¼˜åŒ–æœ€ä½³å®è·µ


**ğŸ’¡ ä¼˜åŒ–ç­–ç•¥**
```dockerfile
# 1. é€‰æ‹©åˆé€‚çš„åŸºç¡€é•œåƒ
FROM node:16-alpine  # alpineç‰ˆæœ¬æ¯”ubuntuå°å¾ˆå¤š

# 2. åˆç†å®‰æ’COPYé¡ºåºï¼ˆåˆ©ç”¨Dockerå±‚ç¼“å­˜ï¼‰
COPY package*.json ./  # å…ˆå¤åˆ¶ä¾èµ–æ–‡ä»¶
RUN npm install        # å®‰è£…ä¾èµ–
COPY . .              # å†å¤åˆ¶æºç 

# 3. æ¸…ç†ä¸å¿…è¦æ–‡ä»¶
RUN npm install && npm cache clean --force

# 4. ä½¿ç”¨.dockerignoreæ–‡ä»¶
# .dockerignoreå†…å®¹ï¼š
# node_modules
# .git
# README.md
# .env
```

---

## 4. ğŸ·ï¸ é•œåƒæ ‡ç­¾ç®¡ç†ç­–ç•¥


### 4.1 ä¸ºä»€ä¹ˆéœ€è¦æ ‡ç­¾ç®¡ç†


**ğŸ”¸ æ ‡ç­¾çš„ä½œç”¨**
```
é•œåƒæ ‡ç­¾ = ç‰ˆæœ¬æ ‡è®°

æ²¡æœ‰æ ‡ç­¾ç®¡ç†çš„é—®é¢˜ï¼š
- ä¸çŸ¥é“å“ªä¸ªç‰ˆæœ¬æ˜¯æœ€æ–°çš„
- ä¸çŸ¥é“å“ªä¸ªç‰ˆæœ¬æ˜¯ç¨³å®šçš„
- å›æ»šæ—¶æ‰¾ä¸åˆ°åˆé€‚ç‰ˆæœ¬
- æµ‹è¯•ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒç‰ˆæœ¬æ··ä¹±

æœ‰äº†æ ‡ç­¾ç®¡ç†ï¼š
- æ¸…æ¥šçŸ¥é“ç‰ˆæœ¬å†å²
- æ–¹ä¾¿ç‰ˆæœ¬å›æ»š
- ç¯å¢ƒéš”ç¦»æ˜ç¡®
```

### 4.2 å¸¸ç”¨æ ‡ç­¾ç­–ç•¥


**ğŸ“‹ æ ‡ç­¾è§„èŒƒ**
```yaml
# 1. åŸºäºGitæäº¤çš„æ ‡ç­¾
variables:
  DOCKER_TAG_COMMIT: $CI_COMMIT_SHA        # å…·ä½“æäº¤ï¼ša1b2c3d4
  DOCKER_TAG_BRANCH: $CI_COMMIT_REF_SLUG   # åˆ†æ”¯åï¼šmain, develop
  DOCKER_TAG_LATEST: latest                # æœ€æ–°ç‰ˆæœ¬

# 2. åŸºäºç‰ˆæœ¬å·çš„æ ‡ç­¾
variables:
  DOCKER_TAG_VERSION: v1.2.3               # è¯­ä¹‰åŒ–ç‰ˆæœ¬
  DOCKER_TAG_MAJOR: v1                     # ä¸»ç‰ˆæœ¬
  DOCKER_TAG_MINOR: v1.2                   # æ¬¡ç‰ˆæœ¬

# 3. åŸºäºç¯å¢ƒçš„æ ‡ç­¾
variables:
  DOCKER_TAG_ENV: dev, staging, prod       # ç¯å¢ƒæ ‡ç­¾
```

### 4.3 æ™ºèƒ½æ ‡ç­¾Pipeline


**ğŸš€ åŠ¨æ€æ ‡ç­¾ç”Ÿæˆ**
```yaml
build-with-tags:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  variables:
    DOCKER_IMAGE: $CI_REGISTRY_IMAGE
  before_script:
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
  script:
    # æ„å»ºé•œåƒ
    - docker build -t temp-image .
    
    # åŸºç¡€æ ‡ç­¾ï¼ˆæ€»æ˜¯åˆ›å»ºï¼‰
    - docker tag temp-image $DOCKER_IMAGE:$CI_COMMIT_SHA
    - docker tag temp-image $DOCKER_IMAGE:$CI_COMMIT_REF_SLUG
    
    # æ ¹æ®åˆ†æ”¯æ·»åŠ ç‰¹æ®Šæ ‡ç­¾
    - |
      if [ "$CI_COMMIT_REF_NAME" == "main" ]; then
        docker tag temp-image $DOCKER_IMAGE:latest
        docker tag temp-image $DOCKER_IMAGE:stable
      fi
    
    # å¦‚æœæ˜¯tagæ¨é€ï¼Œæ·»åŠ ç‰ˆæœ¬æ ‡ç­¾
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        docker tag temp-image $DOCKER_IMAGE:$CI_COMMIT_TAG
        # æå–ä¸»ç‰ˆæœ¬å·ï¼ˆv1.2.3 -> v1ï¼‰
        MAJOR_VERSION=$(echo $CI_COMMIT_TAG | cut -d. -f1)
        docker tag temp-image $DOCKER_IMAGE:$MAJOR_VERSION
      fi
    
    # æ¨é€æ‰€æœ‰æ ‡ç­¾
    - docker push $DOCKER_IMAGE --all-tags
  only:
    - main
    - develop
    - tags
```

### 4.4 æ ‡ç­¾æ¸…ç†ç­–ç•¥


**ğŸ§¹ å®šæœŸæ¸…ç†æ—§æ ‡ç­¾**
```yaml
cleanup-old-images:
  stage: cleanup
  image: alpine:latest
  before_script:
    - apk add --no-cache curl jq
  script:
    # è·å–ä»“åº“ä¸­çš„æ ‡ç­¾åˆ—è¡¨
    - |
      TAGS=$(curl -s -H "PRIVATE-TOKEN: $CI_JOB_TOKEN" \
        "$CI_API_V4_URL/projects/$CI_PROJECT_ID/registry/repositories" | \
        jq -r '.[].location')
    
    # åˆ é™¤30å¤©å‰çš„æ ‡ç­¾ï¼ˆä¿ç•™latestå’Œstableï¼‰
    - |
      for tag in $TAGS; do
        if [[ $tag != "latest" && $tag != "stable" ]]; then
          # æ£€æŸ¥æ ‡ç­¾åˆ›å»ºæ—¶é—´ï¼Œåˆ é™¤æ—§æ ‡ç­¾çš„é€»è¾‘
          echo "æ£€æŸ¥æ ‡ç­¾: $tag"
        fi
      done
  when: manual  # æ‰‹åŠ¨è§¦å‘
  only:
    - schedules  # å®šæ—¶ä»»åŠ¡
```

---

## 5. ğŸ“¦ GitLab Container Registry


### 5.1 ä»€ä¹ˆæ˜¯Container Registry


**ğŸ”¸ ç®€å•ç†è§£**
```
Container Registry = Dockeré•œåƒä»“åº“

ç±»æ¯”ç†è§£ï¼š
GitHub = ä»£ç ä»“åº“ï¼Œå­˜æ”¾æºä»£ç 
Docker Hub = å…¬å…±é•œåƒä»“åº“ï¼Œå­˜æ”¾Dockeré•œåƒ
GitLab Container Registry = ç§æœ‰é•œåƒä»“åº“ï¼Œå­˜æ”¾ä½ é¡¹ç›®çš„é•œåƒ

ä¼˜åŠ¿ï¼š
âœ… ä¸GitLabé¡¹ç›®é›†æˆ
âœ… è‡ªåŠ¨åŒ–æƒé™ç®¡ç†
âœ… ç§æœ‰å®‰å…¨
âœ… å…è´¹ä½¿ç”¨
```

### 5.2 RegistryåŸºæœ¬æ“ä½œ


**ğŸ“‹ è®¿é—®åœ°å€æ ¼å¼**
```
Registryåœ°å€æ ¼å¼ï¼š
[GitLabåŸŸå]/[ç¾¤ç»„]/[é¡¹ç›®å]

ç¤ºä¾‹ï¼š
gitlab.com/mycompany/myapp
â””â”€â”€ å®Œæ•´é•œåƒåœ°å€ï¼šregistry.gitlab.com/mycompany/myapp:latest

æ‹‰å–é•œåƒï¼š
docker pull registry.gitlab.com/mycompany/myapp:latest

æ¨é€é•œåƒï¼š
docker push registry.gitlab.com/mycompany/myapp:latest
```

### 5.3 Registryé›†æˆé…ç½®


**âš™ï¸ è‡ªåŠ¨åŒ–é›†æˆ**
```yaml
# GitLab CI/CDè‡ªåŠ¨ä½¿ç”¨Registry
variables:
  # GitLabè‡ªåŠ¨æä¾›è¿™äº›å˜é‡
  CI_REGISTRY: registry.gitlab.com           # Registryåœ°å€
  CI_REGISTRY_IMAGE: $CI_REGISTRY/$CI_PROJECT_PATH  # å®Œæ•´é•œåƒè·¯å¾„
  CI_REGISTRY_USER: gitlab-ci-token         # ç™»å½•ç”¨æˆ·å
  CI_REGISTRY_PASSWORD: $CI_JOB_TOKEN       # ç™»å½•å¯†ç 

docker-build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    # è‡ªåŠ¨ç™»å½•ï¼ˆä½¿ç”¨GitLabæä¾›çš„å‡­æ®ï¼‰
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
  script:
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
```

### 5.4 Registryç®¡ç†ç•Œé¢


**ğŸ–¥ï¸ Webç•Œé¢åŠŸèƒ½**
```
GitLabé¡¹ç›®é¡µé¢ â†’ Container Registry

å¯ä»¥çœ‹åˆ°ï¼š
ğŸ“‹ é•œåƒåˆ—è¡¨
ğŸ“Š é•œåƒå¤§å°
ğŸ·ï¸ æ ‡ç­¾åˆ—è¡¨
ğŸ“… æ¨é€æ—¶é—´
ğŸ—‘ï¸ åˆ é™¤æ“ä½œ

ç®¡ç†åŠŸèƒ½ï¼š
âœ… æŸ¥çœ‹é•œåƒè¯¦æƒ…
âœ… åˆ é™¤ç‰¹å®šæ ‡ç­¾
âœ… æ‰¹é‡åˆ é™¤
âœ… è®¾ç½®æ¸…ç†ç­–ç•¥
```

---

## 6. ğŸ›¡ï¸ é•œåƒå®‰å…¨æ‰«æ


### 6.1 ä¸ºä»€ä¹ˆéœ€è¦å®‰å…¨æ‰«æ


**ğŸ”¸ å®‰å…¨é£é™©**
```
é•œåƒå®‰å…¨é—®é¢˜ï¼š
1. åŸºç¡€é•œåƒæ¼æ´ï¼šæ“ä½œç³»ç»Ÿã€è¿è¡Œæ—¶ç¯å¢ƒçš„å®‰å…¨æ¼æ´
2. ä¾èµ–åŒ…æ¼æ´ï¼šåº”ç”¨ä¾èµ–çš„ç¬¬ä¸‰æ–¹åŒ…å­˜åœ¨æ¼æ´
3. é…ç½®é—®é¢˜ï¼šä¸å®‰å…¨çš„é…ç½®ï¼ˆå¦‚rootç”¨æˆ·è¿è¡Œï¼‰
4. æ•æ„Ÿä¿¡æ¯æ³„éœ²ï¼šå¯†ç ã€å¯†é’¥è¢«æ‰“åŒ…è¿›é•œåƒ

æ‰«æçš„ä»·å€¼ï¼š
âœ… æå‰å‘ç°å®‰å…¨æ¼æ´
âœ… è¯„ä¼°é£é™©ç­‰çº§
âœ… æä¾›ä¿®å¤å»ºè®®
âœ… ç¬¦åˆå®‰å…¨åˆè§„è¦æ±‚
```

### 6.2 GitLabå†…ç½®å®‰å…¨æ‰«æ


**ğŸ” å®¹å™¨æ‰«æé…ç½®**
```yaml
# å¯ç”¨GitLabå®‰å…¨æ‰«æ
include:
  - template: Security/Container-Scanning.gitlab-ci.yml

# è‡ªå®šä¹‰æ‰«æé…ç½®
container_scanning:
  stage: test
  variables:
    CS_IMAGE: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA  # æ‰«æçš„é•œåƒ
    CS_SEVERITY_THRESHOLD: medium                 # é£é™©ç­‰çº§é˜ˆå€¼
  artifacts:
    reports:
      container_scanning: gl-container-scanning-report.json
  dependencies:
    - build-image  # ä¾èµ–æ„å»ºé˜¶æ®µ
```

### 6.3 ç¬¬ä¸‰æ–¹å®‰å…¨æ‰«æå·¥å…·


**ğŸ”§ Trivyæ‰«æç¤ºä¾‹**
```yaml
security-scan:
  stage: security
  image: aquasec/trivy:latest
  services:
    - docker:dind
  variables:
    DOCKER_DRIVER: overlay2
  before_script:
    - export TRIVY_USERNAME=$CI_REGISTRY_USER
    - export TRIVY_PASSWORD=$CI_REGISTRY_PASSWORD
  script:
    # æ‰«æé•œåƒæ¼æ´
    - trivy image --exit-code 0 --severity HIGH,CRITICAL $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    
    # ç”ŸæˆæŠ¥å‘Š
    - trivy image --format json --output trivy-report.json $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
  artifacts:
    reports:
      # GitLabå¯ä»¥è§£æçš„å®‰å…¨æŠ¥å‘Šæ ¼å¼
      container_scanning: trivy-report.json
    expire_in: 1 week
  allow_failure: true  # å…è®¸æ‰«æå¤±è´¥ä½†ä¸é˜»æ­¢æµæ°´çº¿
```

### 6.4 å®‰å…¨æ‰«ææœ€ä½³å®è·µ


**ğŸ’¡ å®‰å…¨ç­–ç•¥**
```yaml
# åˆ†çº§å¤„ç†å®‰å…¨é—®é¢˜
security-gate:
  stage: security-check
  image: alpine:latest
  script:
    # æ£€æŸ¥æ‰«æç»“æœ
    - |
      HIGH_VULNS=$(cat trivy-report.json | jq '.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH") | length')
      CRITICAL_VULNS=$(cat trivy-report.json | jq '.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL") | length')
      
      echo "å‘ç° $CRITICAL_VULNS ä¸ªä¸¥é‡æ¼æ´"
      echo "å‘ç° $HIGH_VULNS ä¸ªé«˜é£é™©æ¼æ´"
      
      # ä¸¥é‡æ¼æ´ç›´æ¥å¤±è´¥
      if [ "$CRITICAL_VULNS" -gt 0 ]; then
        echo "âŒ å­˜åœ¨ä¸¥é‡å®‰å…¨æ¼æ´ï¼Œåœæ­¢éƒ¨ç½²"
        exit 1
      fi
      
      # é«˜é£é™©æ¼æ´è­¦å‘Šä½†ä¸é˜»æ­¢
      if [ "$HIGH_VULNS" -gt 5 ]; then
        echo "âš ï¸  é«˜é£é™©æ¼æ´è¾ƒå¤šï¼Œå»ºè®®ä¿®å¤åéƒ¨ç½²"
      fi
  dependencies:
    - security-scan
```

### 6.5 æ¼æ´ä¿®å¤æŒ‡å¯¼


**ğŸ”§ å¸¸è§ä¿®å¤æ–¹æ³•**
```dockerfile
# 1. æ›´æ–°åŸºç¡€é•œåƒ
FROM node:16-alpine  # é€‰æ‹©è¾ƒæ–°ç‰ˆæœ¬

# 2. æ›´æ–°ç³»ç»ŸåŒ…
RUN apk update && apk upgrade

# 3. åˆ é™¤ä¸å¿…è¦çš„åŒ…
RUN apk del build-dependencies

# 4. ä½¿ç”¨érootç”¨æˆ·
USER 1001

# 5. æœ€å°åŒ–é•œåƒå†…å®¹
# ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºï¼Œåªä¿ç•™è¿è¡Œæ—¶éœ€è¦çš„æ–‡ä»¶
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Dockerfileï¼šåˆ¶ä½œé•œåƒçš„"é…æ–¹"æ–‡ä»¶
ğŸ”¸ å¤šé˜¶æ®µæ„å»ºï¼šåˆ†ç¦»æ„å»ºç¯å¢ƒå’Œè¿è¡Œç¯å¢ƒï¼Œä¼˜åŒ–é•œåƒå¤§å°
ğŸ”¸ æ ‡ç­¾ç®¡ç†ï¼šè§„èŒƒåŒ–ç‰ˆæœ¬æ ‡è®°ï¼Œä¾¿äºç®¡ç†å’Œå›æ»š
ğŸ”¸ Container Registryï¼šGitLabå†…ç½®çš„ç§æœ‰é•œåƒä»“åº“
ğŸ”¸ å®‰å…¨æ‰«æï¼šæ£€æµ‹é•œåƒä¸­çš„å®‰å…¨æ¼æ´
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ Dockerfileç¼–å†™åŸåˆ™**
```
åˆ†å±‚æ„å»ºï¼šæ¯ä¸ªæŒ‡ä»¤åˆ›å»ºä¸€å±‚
ç¼“å­˜ä¼˜åŒ–ï¼šåˆç†å®‰æ’æŒ‡ä»¤é¡ºåº
å®‰å…¨è€ƒè™‘ï¼šä½¿ç”¨érootç”¨æˆ·
ä½“ç§¯æ§åˆ¶ï¼šåˆ é™¤ä¸å¿…è¦æ–‡ä»¶
```

**ğŸ”¹ Pipelineè®¾è®¡æ€è·¯**
```
è‡ªåŠ¨åŒ–ï¼šä»£ç æäº¤è‡ªåŠ¨è§¦å‘æ„å»º
æ ‡å‡†åŒ–ï¼šç»Ÿä¸€çš„æ„å»ºæµç¨‹
å¯é æ€§ï¼šå¤±è´¥é‡è¯•å’Œè¶…æ—¶æ§åˆ¶
æ•ˆç‡ï¼šåˆ©ç”¨ç¼“å­˜åŠ é€Ÿæ„å»º
```

**ğŸ”¹ å®‰å…¨æ‰«æç­–ç•¥**
```
åˆ†çº§å¤„ç†ï¼šä¸¥é‡æ¼æ´é˜»æ­¢éƒ¨ç½²ï¼Œä¸€èˆ¬æ¼æ´è­¦å‘Š
æŒç»­æ‰«æï¼šæ¯æ¬¡æ„å»ºéƒ½è¿›è¡Œæ‰«æ
ä¿®å¤æŒ‡å¯¼ï¼šæä¾›å…·ä½“çš„ä¿®å¤å»ºè®®
åˆè§„è¦æ±‚ï¼šæ»¡è¶³å®‰å…¨åˆè§„æ ‡å‡†
```

### 7.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¸šåŠ¡åœºæ™¯åº”ç”¨**
- **å¿«é€Ÿè¿­ä»£**ï¼šè‡ªåŠ¨åŒ–æ„å»ºæ”¯æŒé¢‘ç¹å‘å¸ƒ
- **ç¯å¢ƒä¸€è‡´æ€§**ï¼šå®¹å™¨åŒ–ç¡®ä¿å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒä¸€è‡´
- **ç‰ˆæœ¬ç®¡ç†**ï¼šæ¸…æ™°çš„æ ‡ç­¾ç­–ç•¥ä¾¿äºç‰ˆæœ¬æ§åˆ¶å’Œå›æ»š
- **å®‰å…¨ä¿éšœ**ï¼šå®‰å…¨æ‰«æé™ä½ç”Ÿäº§ç¯å¢ƒé£é™©

**ğŸ”§ è¿ç»´å®è·µ**
- **æ ‡å‡†åŒ–**ï¼šç»Ÿä¸€çš„é•œåƒæ„å»ºæµç¨‹
- **è‡ªåŠ¨åŒ–**ï¼šå‡å°‘æ‰‹åŠ¨æ“ä½œï¼Œé™ä½å‡ºé”™æ¦‚ç‡
- **å¯è§‚æµ‹æ€§**ï¼šæ„å»ºæ—¥å¿—å’Œæ‰«ææŠ¥å‘Šæä¾›é—®é¢˜è¯Šæ–­ä¿¡æ¯
- **æˆæœ¬æ§åˆ¶**ï¼šé•œåƒä¼˜åŒ–å‡å°‘å­˜å‚¨å’Œä¼ è¾“æˆæœ¬

**æ ¸å¿ƒè®°å¿†**ï¼š
- Dockerfileæ˜¯åˆ¶ä½œé•œåƒçš„é…æ–¹ï¼Œè¦å†™å¾—å®‰å…¨é«˜æ•ˆ
- å¤šé˜¶æ®µæ„å»ºè®©é•œåƒæ›´å°æ›´å®‰å…¨
- æ ‡ç­¾ç®¡ç†è®©ç‰ˆæœ¬æ§åˆ¶æ›´æ¸…æ™°
- å®‰å…¨æ‰«ææ˜¯ç”Ÿäº§ç¯å¢ƒçš„å¿…è¦ä¿éšœ
- GitLab Registryä¸CI/CDå®Œç¾é›†æˆï¼Œç®€åŒ–äº†æ•´ä¸ªå·¥ä½œæµç¨‹