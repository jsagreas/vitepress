---
title: 4、Runner故障排查
---
## 📚 目录

1. [Runner故障排查概述](#1-Runner故障排查概述)
2. [Runner连接问题诊断](#2-Runner连接问题诊断)
3. [Job执行失败分析](#3-Job执行失败分析)
4. [网络连接问题解决](#4-网络连接问题解决)
5. [权限问题排查](#5-权限问题排查)
6. [资源不足处理](#6-资源不足处理)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 🔍 Runner故障排查概述


### 1.1 什么是Runner故障排查


**🤔 简单理解**：
Runner故障排查就像给生病的机器人看病。想象一下，你派了一个机器人去帮你做作业，但是机器人突然不干活了，或者做得不对。这时候你需要检查：机器人是不是听不到你的指令？是不是没有足够的电池？是不是被门锁在外面了？

**🎯 专业定义**：
Runner故障排查是指当GitLab Runner无法正常执行CI/CD任务时，通过系统性的诊断方法找出问题根源并解决的过程。

### 1.2 常见故障类型一览


```
📊 故障分类图：

Runner故障
    ├── 连接问题 🔌
    │   ├── 注册失败
    │   ├── 心跳丢失  
    │   └── Token过期
    │
    ├── 执行问题 ⚙️
    │   ├── Job失败
    │   ├── 超时终止
    │   └── 环境错误
    │
    ├── 网络问题 🌐
    │   ├── DNS解析
    │   ├── 防火墙
    │   └── 代理配置
    │
    ├── 权限问题 🔐
    │   ├── 文件权限
    │   ├── Docker权限
    │   └── 系统权限
    │
    └── 资源问题 💾
        ├── 内存不足
        ├── 磁盘空间
        └── CPU负载
```

### 1.3 故障排查基本思路


**🔄 排查流程**：

**Step 1** 🚨 **观察现象** → 收集错误信息
  ↓
**Step 2** 🔍 **定位范围** → 确定问题类型  
  ↓
**Step 3** 🧪 **逐步测试** → 验证假设
  ↓
**Step 4** 🛠️ **应用解决方案** → 修复问题
  ↓
**Step 5** ✅ **验证修复** → 确认正常

**💡 排查原则**：
- **从简到繁**：先检查基础配置，再深入技术细节
- **由外到内**：先检查网络连接，再检查内部配置
- **记录过程**：每个步骤都要记录，便于后续分析

---

## 2. 🔌 Runner连接问题诊断


### 2.1 Runner注册失败


**😕 问题现象**：
```
ERROR: Registering runner... failed
ERROR: Failed to register runner: 403 Forbidden
```

**🔍 问题原因分析**：

| 🎯 **错误类型** | **可能原因** | **解决思路** |
|----------------|--------------|--------------|
| 🚫 **403 Forbidden** | Token错误或过期 | 检查注册Token |
| 🌐 **Network Error** | 网络连接问题 | 检查网络配置 |
| 🔒 **SSL Error** | 证书问题 | 检查SSL配置 |

**🛠️ 解决步骤**：

**Step 1：验证Token有效性**
```bash
# 检查Token是否正确（在GitLab项目设置中获取）
gitlab-runner register \
  --url "https://gitlab.example.com/" \
  --registration-token "YOUR_TOKEN_HERE"
```

**Step 2：检查网络连接**
```bash
# 测试网络连通性
curl -I https://gitlab.example.com/

# 如果使用自签名证书
curl -k -I https://gitlab.example.com/
```

**Step 3：解决SSL证书问题**
```bash
# 方法1：添加证书信任
gitlab-runner register --tls-ca-file /path/to/certificate.crt

# 方法2：跳过SSL验证（仅测试环境）
gitlab-runner register --tls-skip-verify
```

### 2.2 Runner心跳丢失


**😟 问题现象**：
Runner在GitLab界面显示离线状态，但实际在运行。

**💭 通俗解释**：
就像你的手机明明开着，但朋友总是说你离线。可能是网络信号不好，或者手机设置有问题。

**🔧 诊断方法**：

```bash
# 查看Runner状态
gitlab-runner status

# 查看Runner日志
gitlab-runner --debug run
```

**⚠️ 常见原因**：
- 网络不稳定导致心跳包丢失
- GitLab服务器负载过高
- Runner配置文件中的`check_interval`设置过大

**🎯 解决方案**：
```toml
# 编辑 /etc/gitlab-runner/config.toml
[[runners]]
  name = "my-runner"
  url = "https://gitlab.example.com/"
  token = "xxx"
  executor = "docker"
  
  # 调整心跳间隔（默认3秒）
  check_interval = 1
  
  # 增加网络超时时间
  request_timeout = 30
```

### 2.3 Token过期处理


**🕐 Token过期识别**：
```
ERROR: Failed to process runner: 403 Forbidden
ERROR: Runner token is invalid
```

**🔄 Token更新流程**：

**Step 1：获取新Token**
```
GitLab项目 → Settings → CI/CD → Runners → 复制Registration Token
```

**Step 2：重新注册Runner**
```bash
# 停止旧Runner
gitlab-runner stop

# 删除旧配置
gitlab-runner unregister --name "old-runner-name"

# 重新注册
gitlab-runner register
```

**💡 预防措施**：
- 定期检查Token有效性
- 设置Token过期提醒
- 使用Group级别或Instance级别的Runner减少Token管理

---

## 3. ⚙️ Job执行失败分析


### 3.1 Job失败的常见模式


**📊 失败类型统计**：

| 🎯 **失败类型** | **占比** | **典型特征** | **快速判断** |
|----------------|----------|--------------|--------------|
| 🔧 **构建错误** | 40% | 代码编译失败 | 查看构建日志 |
| 🌐 **依赖问题** | 25% | 包下载失败 | 检查网络和仓库 |
| 🔐 **权限错误** | 20% | 无法访问文件 | 查看权限设置 |
| ⏰ **超时错误** | 10% | 任务运行超时 | 检查timeout配置 |
| 💾 **资源不足** | 5% | 内存/磁盘不够 | 监控系统资源 |

### 3.2 构建错误诊断


**🔍 错误信息解读**：

**代码编译错误示例**：
```
ERROR: Build failed with exit code 1
npm ERR! missing script: build
```

**🧠 解读思路**：
这个错误告诉我们npm找不到名为"build"的脚本。就像你让朋友帮你做一道菜，但是没有给他菜谱一样。

**🛠️ 解决步骤**：

**Step 1：检查package.json**
```json
{
  "scripts": {
    "build": "npm run compile",  // 确保脚本存在
    "test": "jest",
    "start": "node index.js"
  }
}
```

**Step 2：检查工作目录**
```yaml
# .gitlab-ci.yml
build_job:
  stage: build
  script:
    - pwd                    # 确认当前目录
    - ls -la                 # 查看文件列表
    - cat package.json       # 检查文件内容
    - npm run build
```

### 3.3 依赖安装失败


**😤 常见错误**：
```
npm ERR! network timeout
pip install failed: Connection timeout
```

**🌐 网络问题解决**：

**方法1：配置镜像源**
```yaml
before_script:
  # npm镜像
  - npm config set registry https://registry.npmmirror.com/
  
  # pip镜像
  - pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple/
```

**方法2：增加重试机制**
```yaml
build_job:
  script:
    - for i in {1..3}; do npm install && break || sleep 15; done
  retry:
    max: 2
    when: runner_system_failure
```

### 3.4 超时问题处理


**⏰ 超时配置层级**：

```
⏱️ 超时层级图：

GitLab全局设置
    ↓ (覆盖)
项目级别设置  
    ↓ (覆盖)
Job级别设置
    ↓ (覆盖)
Runner配置
```

**🔧 配置超时时间**：
```yaml
# .gitlab-ci.yml
long_running_job:
  script:
    - ./long-script.sh
  timeout: 2h 30m          # Job级别超时
  
variables:
  CI_PIPELINE_TIMEOUT: "3h" # Pipeline级别超时
```

**💡 超时优化策略**：
- **并行化**：将大任务拆分为小任务并行执行
- **缓存**：使用artifacts和cache减少重复工作
- **增量构建**：只构建变更的部分

---

## 4. 🌐 网络连接问题解决


### 4.1 DNS解析问题


**🤔 什么是DNS解析问题**：
DNS就像互联网的电话簿。当你的Runner说"我要访问gitlab.example.com"时，DNS负责告诉它"这个网站的IP地址是192.168.1.100"。如果DNS出问题，就像电话簿页面撕掉了，找不到地址。

**🔍 诊断DNS问题**：
```bash
# 在Runner机器上测试DNS解析
nslookup gitlab.example.com
dig gitlab.example.com

# 测试具体DNS服务器
nslookup gitlab.example.com 8.8.8.8
```

**🛠️ 解决DNS问题**：

**方法1：修改DNS服务器**
```bash
# 编辑 /etc/resolv.conf
nameserver 8.8.8.8
nameserver 114.114.114.114
```

**方法2：使用hosts文件**
```bash
# 编辑 /etc/hosts
192.168.1.100 gitlab.example.com
```

**方法3：Docker Runner的DNS配置**
```toml
[[runners]]
  [runners.docker]
    dns = ["8.8.8.8", "114.114.114.114"]
```

### 4.2 防火墙配置


**🛡️ 防火墙检查清单**：

| 🎯 **检查项目** | **端口/协议** | **说明** |
|----------------|---------------|----------|
| 🔗 **GitLab连接** | TCP 443/80 | HTTPS/HTTP访问 |
| 🐳 **Docker Registry** | TCP 443 | 镜像拉取 |
| 📦 **包管理器** | TCP 443/80 | npm/pip等 |
| 🔄 **Git操作** | TCP 22/443 | SSH/HTTPS克隆 |

**🔧 防火墙配置示例**：
```bash
# Ubuntu/Debian
sudo ufw allow out 443
sudo ufw allow out 80
sudo ufw allow out 22

# CentOS/RHEL
sudo firewall-cmd --permanent --add-port=443/tcp
sudo firewall-cmd --permanent --add-port=80/tcp
sudo firewall-cmd --reload
```

### 4.3 代理服务器配置


**🌉 代理配置场景**：
企业环境中，所有网络访问都需要通过代理服务器，就像进出公司需要通过门卫一样。

**🔧 Runner代理配置**：
```toml
# /etc/gitlab-runner/config.toml
[[runners]]
  environment = [
    "http_proxy=http://proxy.company.com:8080",
    "https_proxy=http://proxy.company.com:8080",
    "no_proxy=localhost,127.0.0.1,gitlab.company.com"
  ]
```

**🐳 Docker Runner代理配置**：
```toml
[[runners]]
  [runners.docker]
    environment = [
      "http_proxy=http://proxy.company.com:8080",
      "https_proxy=http://proxy.company.com:8080"
    ]
```

---

## 5. 🔐 权限问题排查


### 5.1 文件权限问题


**😅 权限问题的通俗理解**：
想象你是一个图书管理员，但是有些书柜你没有钥匙打不开，有些书你只能看不能借走。文件权限就是这样，决定了谁能读、写、执行文件。

**🔍 权限问题诊断**：

**常见权限错误**：
```
Permission denied: cannot create directory
chmod: changing permissions denied
docker: permission denied while trying to connect
```

**🛠️ 权限检查命令**：
```bash
# 查看文件权限
ls -la /path/to/file

# 查看目录权限
ls -ld /path/to/directory

# 查看当前用户
whoami
id
```

### 5.2 Docker权限问题


**🐳 Docker权限问题表现**：
```
docker: Got permission denied while trying to connect to the Docker daemon socket
```

**💭 问题原因**：
Runner用户不在docker组中，无法访问Docker守护进程。

**🔧 解决方法**：
```bash
# 将gitlab-runner用户添加到docker组
sudo usermod -aG docker gitlab-runner

# 重启gitlab-runner服务
sudo systemctl restart gitlab-runner

# 验证权限
sudo -u gitlab-runner docker ps
```

### 5.3 Git仓库权限


**🔑 Git权限配置**：

**SSH密钥配置**：
```bash
# 生成SSH密钥
ssh-keygen -t rsa -b 4096 -C "runner@company.com"

# 添加到ssh-agent
eval "$(ssh-agent -s)"
ssh-add ~/.ssh/id_rsa

# 测试连接
ssh -T git@gitlab.example.com
```

**🔧 在GitLab-CI中使用SSH**：
```yaml
before_script:
  - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
  - eval $(ssh-agent -s)
  - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
  - mkdir -p ~/.ssh
  - chmod 700 ~/.ssh
  - ssh-keyscan gitlab.example.com >> ~/.ssh/known_hosts
```

---

## 6. 💾 资源不足处理


### 6.1 内存不足问题


**🧠 内存不足症状**：
```
Out of memory: Kill process
java.lang.OutOfMemoryError
npm ERR! errno -12
```

**📊 内存使用监控**：
```bash
# 查看内存使用情况
free -h
htop

# 查看进程内存使用
ps aux --sort=-%mem | head -10
```

**🔧 内存问题解决**：

**方法1：增加交换空间**
```bash
# 创建2GB交换文件
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

# 永久生效
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
```

**方法2：优化Job配置**
```yaml
build_job:
  variables:
    # 限制Node.js内存使用
    NODE_OPTIONS: "--max-old-space-size=2048"
    # 限制Java内存使用  
    MAVEN_OPTS: "-Xmx1024m -XX:MaxPermSize=256m"
```

### 6.2 磁盘空间不足


**💿 磁盘空间检查**：
```bash
# 查看磁盘使用情况
df -h

# 查找大文件
du -sh /* | sort -hr | head -10

# 查找Runner工作目录大小
du -sh /builds/*
```

**🧹 磁盘清理策略**：

**自动清理配置**：
```toml
# /etc/gitlab-runner/config.toml
[[runners]]
  [runners.docker]
    # 自动清理Docker容器
    volumes = ["/var/run/docker.sock:/var/run/docker.sock"]
    # 限制并发Job数量
    limit = 2
```

**定期清理脚本**：
```bash
#!/bin/bash
# cleanup-runner.sh

# 清理Docker镜像
docker system prune -f

# 清理旧的构建文件（保留最近7天）
find /builds -type d -mtime +7 -exec rm -rf {} +

# 清理日志文件
find /var/log -name "*.log" -type f -mtime +30 -delete
```

### 6.3 CPU负载过高


**⚡ CPU负载监控**：
```bash
# 查看CPU使用率
top
htop

# 查看系统负载
uptime
iostat 1 5
```

**🔧 CPU负载优化**：

**限制并发Job数量**：
```toml
# /etc/gitlab-runner/config.toml
concurrent = 2  # 全局并发限制

[[runners]]
  limit = 1     # 单个Runner并发限制
```

**优化构建脚本**：
```yaml
build_job:
  script:
    # 限制编译并行度
    - make -j2  # 只使用2个CPU核心
    
    # npm限制并发
    - npm install --jobs=2
```

---

## 7. 📋 核心要点总结


### 7.1 故障排查最佳实践


**🎯 黄金法则**：

```
🔍 观察 → 📝 记录 → 🧪 验证 → 🛠️ 修复 → ✅ 确认
```

**💡 排查技巧**：
- **日志优先**：90%的问题都能从日志中找到线索
- **由简到繁**：先检查基础配置，再深入技术细节  
- **隔离变量**：一次只改一个配置，便于定位问题
- **备份配置**：修改前先备份，出问题能快速回滚

### 7.2 常用故障排查命令


**🔧 必备命令清单**：
```bash
# Runner状态检查
gitlab-runner status
gitlab-runner verify

# 详细日志查看
gitlab-runner --debug run
journalctl -u gitlab-runner -f

# 网络连通性测试
curl -I https://gitlab.example.com/
telnet gitlab.example.com 443

# 系统资源检查
free -h                    # 内存
df -h                      # 磁盘
top                        # CPU
docker system df           # Docker空间
```

### 7.3 预防性维护


**🛡️ 预防措施**：

| 🎯 **维护项目** | **频率** | **具体操作** |
|----------------|----------|-------------|
| 🔍 **日志监控** | 每日 | 检查错误日志 |
| 💾 **磁盘清理** | 每周 | 清理旧构建文件 |
| 🔄 **配置备份** | 每月 | 备份Runner配置 |
| 📊 **性能监控** | 持续 | 监控CPU/内存使用 |
| 🔐 **权限审计** | 每季度 | 检查访问权限 |

### 7.4 故障处理流程图


```
🚨 发现问题
    ↓
📝 收集信息（错误日志、环境信息）
    ↓
🎯 问题分类（连接/执行/网络/权限/资源）
    ↓
🔍 具体诊断
    ├── 连接问题 → 检查Token/网络/SSL
    ├── 执行问题 → 分析构建日志/依赖/超时
    ├── 网络问题 → 测试DNS/防火墙/代理
    ├── 权限问题 → 检查文件/Docker/Git权限
    └── 资源问题 → 监控内存/磁盘/CPU
    ↓
🛠️ 应用解决方案
    ↓
✅ 验证修复效果
    ↓
📚 记录解决过程
```

### 7.5 快速问题定位表


**⚡ 5分钟快速诊断**：

| 🎯 **问题现象** | **首先检查** | **常见解决方案** |
|----------------|-------------|-----------------|
| 🔴 **Runner离线** | 网络连接、Token | 重启Runner服务 |
| ❌ **Job失败** | 构建日志、依赖 | 检查代码和配置 |
| ⏰ **执行超时** | Job配置、资源 | 增加超时时间 |
| 🚫 **权限拒绝** | 文件权限、用户组 | 修改权限设置 |
| 💾 **空间不足** | 磁盘使用率 | 清理旧文件 |

**🧠 核心记忆**：
- Runner故障排查就像医生看病，要有系统的方法
- 90%的问题都能从日志中找到答案
- 先检查基础配置，再深入技术细节
- 预防胜于治疗，定期维护很重要
- 记录每次解决过程，积累经验知识库