---
title: 6ã€é•œåƒä¸æœåŠ¡é…ç½®
---
## ğŸ“š ç›®å½•

1. [é•œåƒé…ç½®åŸºç¡€](#1-é•œåƒé…ç½®åŸºç¡€)
2. [æœåŠ¡é…ç½®è¯¦è§£](#2-æœåŠ¡é…ç½®è¯¦è§£)
3. [è‡ªå®šä¹‰é•œåƒä½¿ç”¨](#3-è‡ªå®šä¹‰é•œåƒä½¿ç”¨)
4. [é•œåƒæ‹‰å–ç­–ç•¥](#4-é•œåƒæ‹‰å–ç­–ç•¥)
5. [å®¹å™¨ç½‘ç»œé…ç½®](#5-å®¹å™¨ç½‘ç»œé…ç½®)
6. [å®è·µæ¡ˆä¾‹](#6-å®è·µæ¡ˆä¾‹)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ³ é•œåƒé…ç½®åŸºç¡€


### 1.1 ä»€ä¹ˆæ˜¯é•œåƒé…ç½®


**ğŸ” ç®€å•ç†è§£**ï¼šé•œåƒå°±åƒæ˜¯ä¸€ä¸ª"ç¨‹åºè¿è¡Œçš„æˆ¿é—´"

```
çœŸå®ä¸–ç•Œç±»æ¯”ï¼š
å¼€å‘è€…éœ€è¦è¿è¡Œä»£ç  = å¨å¸ˆéœ€è¦åšèœ
é•œåƒé…ç½® = ä¸ºå¨å¸ˆå‡†å¤‡ä¸€ä¸ªè£…å¤‡é½å…¨çš„å¨æˆ¿
```

åœ¨GitLab CI/CDä¸­ï¼Œ**é•œåƒ(image)**å†³å®šäº†ä½ çš„ä»£ç åœ¨ä»€ä¹ˆæ ·çš„"ç¯å¢ƒ"ä¸­è¿è¡Œã€‚

### 1.2 image å…³é”®å­—è¯¦è§£


**ğŸ“‹ æ ¸å¿ƒæ¦‚å¿µ**
```yaml
# æœ€ç®€å•çš„é•œåƒé…ç½®
image: node:16

# è¿™å¥è¯çš„æ„æ€æ˜¯ï¼š
# "è¯·ç»™æˆ‘å‡†å¤‡ä¸€ä¸ªå·²ç»å®‰è£…äº†Node.js 16ç‰ˆæœ¬çš„ç¯å¢ƒ"
```

**ğŸ¯ ä¸‰ç§é…ç½®çº§åˆ«**

```
å…¨å±€é•œåƒé…ç½®ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ•´ä¸ªæµæ°´çº¿ä½¿ç”¨   â”‚ â† æ‰€æœ‰jobé»˜è®¤ç”¨è¿™ä¸ªé•œåƒ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Jobçº§åˆ«é•œåƒé…ç½®ï¼š
â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”
â”‚Job1 â”‚Job2 â”‚Job3 â”‚ â† æ¯ä¸ªjobå¯ä»¥ç”¨ä¸åŒé•œåƒ
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜

é˜¶æ®µçº§åˆ«é•œåƒé…ç½®ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ„å»ºé˜¶æ®µ â”‚ æµ‹è¯•é˜¶æ®µ â”‚ â† ä¸åŒé˜¶æ®µç”¨ä¸åŒé•œåƒ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 å¸¸ç”¨é•œåƒç¤ºä¾‹


```yaml
# ğŸŸ¢ æ¨èï¼šå¸¸è§å¼€å‘ç¯å¢ƒé•œåƒ
image: node:16        # Node.jså¼€å‘
image: python:3.9     # Pythonå¼€å‘  
image: openjdk:11     # Javaå¼€å‘
image: nginx:latest   # WebæœåŠ¡å™¨
image: ubuntu:20.04   # é€šç”¨Linuxç¯å¢ƒ

# ğŸ”§ å®é™…é…ç½®ç¤ºä¾‹
stages:
  - build
  - test

# å…¨å±€é•œåƒï¼šæ•´ä¸ªé¡¹ç›®é»˜è®¤ä½¿ç”¨
image: node:16

build_job:
  stage: build
  script:
    - npm install
    - npm run build

test_job:
  stage: test
  # è¿™ä¸ªjobä½¿ç”¨ä¸åŒçš„é•œåƒ
  image: node:18
  script:
    - npm test
```

**ğŸ’¡ é€‰æ‹©é•œåƒçš„åŸåˆ™**
- **åŒ¹é…æŠ€æœ¯æ ˆ**ï¼šNode.jsé¡¹ç›®ç”¨nodeé•œåƒï¼ŒPythoné¡¹ç›®ç”¨pythoné•œåƒ
- **ç‰ˆæœ¬ä¸€è‡´**ï¼šå¼€å‘ç¯å¢ƒå’ŒCIç¯å¢ƒç‰ˆæœ¬ä¿æŒä¸€è‡´
- **é•œåƒå¤§å°**ï¼šä¼˜å…ˆé€‰æ‹©è¾ƒå°çš„é•œåƒï¼ŒåŠ å¿«å¯åŠ¨é€Ÿåº¦

---

## 2. âš™ï¸ æœåŠ¡é…ç½®è¯¦è§£


### 2.1 ä»€ä¹ˆæ˜¯æœåŠ¡é…ç½®


**ğŸ” ç®€å•ç†è§£**ï¼šæœåŠ¡å°±åƒæ˜¯"é…èœ"ï¼Œä¸ºä¸»ç¨‹åºæä¾›æ”¯æŒ

```
é¤å…ç±»æ¯”ï¼š
ä¸»èœ(ä½ çš„ä»£ç ) = éœ€è¦è¿è¡Œçš„ç¨‹åº
é…èœ(services) = æ•°æ®åº“ã€ç¼“å­˜ç­‰è¾…åŠ©æœåŠ¡

å®é™…åº”ç”¨ï¼š
ä½ çš„ç¨‹åºéœ€è¦è¿æ¥æ•°æ®åº“ â†’ å¯åŠ¨MySQLæœåŠ¡
ä½ çš„ç¨‹åºéœ€è¦ç¼“å­˜åŠŸèƒ½ â†’ å¯åŠ¨RedisæœåŠ¡
ä½ çš„ç¨‹åºéœ€è¦æ¶ˆæ¯é˜Ÿåˆ— â†’ å¯åŠ¨RabbitMQæœåŠ¡
```

### 2.2 services å…³é”®å­—ä½¿ç”¨


**ğŸ“‹ åŸºç¡€è¯­æ³•**
```yaml
services:
  - mysql:8.0
  - redis:latest

# è¿™æ„å‘³ç€ï¼š
# 1. å¯åŠ¨ä¸€ä¸ªMySQL 8.0æ•°æ®åº“
# 2. å¯åŠ¨ä¸€ä¸ªRedisç¼“å­˜æœåŠ¡
# 3. ä½ çš„ä»£ç å¯ä»¥è¿æ¥è¿™äº›æœåŠ¡
```

**ğŸ¯ å®Œæ•´é…ç½®ç¤ºä¾‹**
```yaml
stages:
  - test

# æµ‹è¯•éœ€è¦æ•°æ®åº“æ”¯æŒ
test_with_database:
  stage: test
  image: node:16
  services:
    - mysql:8.0
    - redis:6.2
  variables:
    # ğŸ”§ æ•°æ®åº“è¿æ¥é…ç½®
    MYSQL_ROOT_PASSWORD: rootpassword
    MYSQL_DATABASE: testdb
    MYSQL_USER: testuser
    MYSQL_PASSWORD: testpass
  script:
    - npm install
    - npm run test:integration
```

### 2.3 æœåŠ¡ç½‘ç»œè¿æ¥


**ğŸŒ æœåŠ¡è¿æ¥æ–¹å¼**

```
å®¹å™¨ç½‘ç»œç¤ºæ„å›¾ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    ç½‘ç»œè¿æ¥    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä½ çš„ä»£ç    â”‚ â†â”€â”€â”€â”€â”€â”€â”€â”€â†’   â”‚  MySQLæœåŠ¡   â”‚
â”‚  (ä¸»å®¹å™¨)   â”‚              â”‚  (æœåŠ¡å®¹å™¨)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“                           â†‘
     è®¿é—®åœ°å€ï¼š                  è®¿é—®åœ°å€ï¼š
   localhost:3306               mysql:3306
```

**ğŸ’» ä»£ç ä¸­å¦‚ä½•è¿æ¥æœåŠ¡**
```javascript
// åœ¨ä½ çš„æµ‹è¯•ä»£ç ä¸­è¿æ¥MySQL
const mysql = require('mysql2');

const connection = mysql.createConnection({
  host: 'mysql',        // ğŸ¯ æœåŠ¡åä½œä¸ºä¸»æœºå
  user: 'testuser',
  password: 'testpass',
  database: 'testdb'
});

// è¿æ¥Redis
const redis = require('redis');
const client = redis.createClient({
  host: 'redis',        // ğŸ¯ æœåŠ¡åä½œä¸ºä¸»æœºå
  port: 6379
});
```

### 2.4 å¸¸ç”¨æœåŠ¡é…ç½®


| æœåŠ¡ç±»å‹ | **é•œåƒåç§°** | **ç”¨é€”è¯´æ˜** | **è¿æ¥åœ°å€** |
|---------|-------------|-------------|-------------|
| ğŸ—„ï¸ **MySQL** | `mysql:8.0` | `å…³ç³»å‹æ•°æ®åº“` | `mysql:3306` |
| ğŸ”´ **Redis** | `redis:latest` | `ç¼“å­˜æœåŠ¡` | `redis:6379` |
| ğŸ˜ **PostgreSQL** | `postgres:13` | `å…³ç³»å‹æ•°æ®åº“` | `postgres:5432` |
| ğŸƒ **MongoDB** | `mongo:5.0` | `æ–‡æ¡£æ•°æ®åº“` | `mongo:27017` |
| ğŸ° **RabbitMQ** | `rabbitmq:3` | `æ¶ˆæ¯é˜Ÿåˆ—` | `rabbitmq:5672` |

---

## 3. ğŸ¨ è‡ªå®šä¹‰é•œåƒä½¿ç”¨


### 3.1 ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰é•œåƒ


**ğŸ¤” ä»€ä¹ˆæ—¶å€™éœ€è¦è‡ªå®šä¹‰é•œåƒï¼Ÿ**

```
æƒ…å†µå¯¹æ¯”ï¼š

âŒ æ¯æ¬¡éƒ½å®‰è£…ä¾èµ–ï¼š
Jobè¿è¡Œ â†’ å®‰è£…Node.js â†’ å®‰è£…Python â†’ å®‰è£…å·¥å…· â†’ è¿è¡Œä»£ç 
â±ï¸ è€—æ—¶ï¼š5-10åˆ†é’Ÿ

âœ… ä½¿ç”¨è‡ªå®šä¹‰é•œåƒï¼š
Jobè¿è¡Œ â†’ ç›´æ¥è¿è¡Œä»£ç 
â±ï¸ è€—æ—¶ï¼š30ç§’

ç»“è®ºï¼šå½“ä½ éœ€è¦ç‰¹æ®Šçš„è½¯ä»¶ç»„åˆæ—¶ï¼Œè‡ªå®šä¹‰é•œåƒèƒ½å¤§å¤§èŠ‚çœæ—¶é—´
```

### 3.2 åˆ›å»ºè‡ªå®šä¹‰é•œåƒ


**ğŸ”§ Dockerfile ç¤ºä¾‹**
```dockerfile
# åŸºäºå®˜æ–¹Node.jsé•œåƒ
FROM node:16

# å®‰è£…é¢å¤–å·¥å…·
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    curl \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£…å…¨å±€npmåŒ…
RUN npm install -g @vue/cli typescript

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# è¿™ä¸ªé•œåƒç°åœ¨åŒ…å«ï¼šNode.js + Python + Vue CLI + TypeScript
```

### 3.3 ä½¿ç”¨ç§æœ‰é•œåƒä»“åº“


**ğŸ” é…ç½®ç§æœ‰ä»“åº“è®¿é—®**
```yaml
# ä½¿ç”¨å…¬å¸å†…éƒ¨é•œåƒä»“åº“
image: registry.company.com/my-team/custom-node:latest

# éœ€è¦åœ¨GitLabä¸­é…ç½®è®¿é—®å‡­æ®
variables:
  DOCKER_AUTH_CONFIG: |
    {
      "auths": {
        "registry.company.com": {
          "username": "$CI_REGISTRY_USER",
          "password": "$CI_REGISTRY_PASSWORD"
        }
      }
    }
```

**ğŸ—ï¸ é•œåƒç‰ˆæœ¬ç®¡ç†ç­–ç•¥**

```
ç‰ˆæœ¬å‘½åå»ºè®®ï¼š
registry.company.com/team/app:latest     â† æœ€æ–°ç‰ˆæœ¬
registry.company.com/team/app:v1.2.3    â† ç¨³å®šç‰ˆæœ¬
registry.company.com/team/app:dev       â† å¼€å‘ç‰ˆæœ¬

ä½¿ç”¨åŸåˆ™ï¼š
ğŸŸ¢ ç”Ÿäº§ç¯å¢ƒï¼šä½¿ç”¨å…·ä½“ç‰ˆæœ¬å· (v1.2.3)
ğŸŸ¡ æµ‹è¯•ç¯å¢ƒï¼šä½¿ç”¨ç¨³å®šæ ‡ç­¾ (stable)  
ğŸ”´ å¼€å‘ç¯å¢ƒï¼šå¯ä»¥ä½¿ç”¨ latest
```

---

## 4. ğŸ“¥ é•œåƒæ‹‰å–ç­–ç•¥


### 4.1 pull_policy é…ç½®è¯¦è§£


**ğŸ” ä»€ä¹ˆæ˜¯æ‹‰å–ç­–ç•¥ï¼Ÿ**

```
é•œåƒæ‹‰å–å°±åƒ"ä¸‹è½½è½¯ä»¶"ï¼š

alwaysï¼ˆæ€»æ˜¯ä¸‹è½½ï¼‰ï¼š
æ¯æ¬¡éƒ½é‡æ–°ä¸‹è½½æœ€æ–°ç‰ˆæœ¬ â†’ ç¡®ä¿æœ€æ–°ï¼Œä½†é€Ÿåº¦æ…¢

if-not-presentï¼ˆå¦‚æœæœ¬åœ°æ²¡æœ‰æ‰ä¸‹è½½ï¼‰ï¼š
æœ¬åœ°æœ‰å°±ç”¨æœ¬åœ°çš„ â†’ é€Ÿåº¦å¿«ï¼Œä½†å¯èƒ½ä¸æ˜¯æœ€æ–°

neverï¼ˆä»ä¸ä¸‹è½½ï¼‰ï¼š
åªç”¨æœ¬åœ°å·²æœ‰çš„ â†’ æœ€å¿«ï¼Œä½†å¯èƒ½æ‰¾ä¸åˆ°é•œåƒ
```

### 4.2 æ‹‰å–ç­–ç•¥é…ç½®


```yaml
# å…¨å±€æ‹‰å–ç­–ç•¥
variables:
  DOCKER_PULL_POLICY: "if-not-present"

# Jobçº§åˆ«æ‹‰å–ç­–ç•¥  
build_job:
  image: 
    name: node:16
    pull_policy: always    # ğŸ”„ æ€»æ˜¯æ‹‰å–æœ€æ–°é•œåƒ
  script:
    - npm install

test_job:
  image:
    name: my-custom:stable
    pull_policy: if-not-present  # ğŸš€ ä¼˜å…ˆä½¿ç”¨æœ¬åœ°é•œåƒ
  script:
    - npm test
```

### 4.3 ç­–ç•¥é€‰æ‹©æŒ‡å—


```
ğŸ“Š æ€§èƒ½ä¸å‡†ç¡®æ€§å¯¹æ¯”ï¼š

æ‹‰å–ç­–ç•¥         å¯åŠ¨é€Ÿåº¦    é•œåƒæ–°é²œåº¦    é€‚ç”¨åœºæ™¯
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
always          â­â­        â­â­â­â­â­    ç”Ÿäº§éƒ¨ç½²
if-not-present  â­â­â­â­    â­â­â­       æ—¥å¸¸å¼€å‘
never           â­â­â­â­â­  â­           ç¦»çº¿ç¯å¢ƒ

ğŸ¯ æ¨èé…ç½®ï¼š
- å¼€å‘é˜¶æ®µï¼šif-not-present
- ç”Ÿäº§éƒ¨ç½²ï¼šalways
- æµ‹è¯•ç¯å¢ƒï¼šif-not-present
```

---

## 5. ğŸŒ å®¹å™¨ç½‘ç»œé…ç½®


### 5.1 å®¹å™¨ç½‘ç»œåŸºç¡€


**ğŸ” ç®€å•ç†è§£**ï¼šå®¹å™¨ç½‘ç»œå°±åƒ"å®¿èˆçš„å†…éƒ¨ç½‘ç»œ"

```
å®¿èˆç½‘ç»œç±»æ¯”ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æˆ¿é—´A      â”‚     â”‚  æˆ¿é—´B      â”‚
â”‚ (ä½ çš„ä»£ç )   â”‚â”€â”€â”€â”€â†’â”‚ (æ•°æ®åº“)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
   å¯ä»¥äº’ç›¸è®¿é—®ï¼Œå…±äº«ç½‘ç»œ
```

### 5.2 ç½‘ç»œè¿æ¥é…ç½®


**ğŸ”§ æœåŠ¡å‘ç°æœºåˆ¶**
```yaml
test_job:
  services:
    - name: mysql:8.0
      alias: database    # ğŸ¯ ç»™æœåŠ¡èµ·ä¸ªåˆ«å
    - name: redis:6.2
      alias: cache       # ğŸ¯ ç»™Redisèµ·ä¸ªåˆ«å
  script:
    # é€šè¿‡åˆ«åè¿æ¥æœåŠ¡
    - ping database    # è¿æ¥MySQL
    - ping cache       # è¿æ¥Redis
```

**ğŸŒ ç«¯å£æ˜ å°„è¯´æ˜**

```
å®¹å™¨å†…éƒ¨ç½‘ç»œï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    å†…éƒ¨ç«¯å£    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä½ çš„åº”ç”¨      â”‚    :3306      â”‚    MySQL        â”‚
â”‚  (ä¸»å®¹å™¨)       â”‚ â†â”€â”€â”€â”€â”€â”€â”€â”€â†’    â”‚   (æœåŠ¡å®¹å™¨)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è¿æ¥ä»£ç ç¤ºä¾‹ï¼š
const dbConfig = {
  host: 'mysql',        // ä½¿ç”¨æœåŠ¡å
  port: 3306,          // ä½¿ç”¨æ ‡å‡†ç«¯å£
  user: 'root'
};
```

### 5.3 ç½‘ç»œéš”ç¦»ä¸å®‰å…¨


**ğŸ”’ å®‰å…¨é…ç½®**
```yaml
# ç½‘ç»œå®‰å…¨é…ç½®ç¤ºä¾‹
test_secure:
  services:
    - mysql:8.0
  variables:
    # ğŸ” æ•°æ®åº“å®‰å…¨é…ç½®
    MYSQL_ROOT_PASSWORD: $DB_ROOT_PASSWORD    # ä½¿ç”¨CIå˜é‡
    MYSQL_USER: testuser
    MYSQL_PASSWORD: $DB_TEST_PASSWORD
  script:
    - echo "è¿æ¥å®‰å…¨çš„æ•°æ®åº“ç¯å¢ƒ"
```

**âš ï¸ ç½‘ç»œæ³¨æ„äº‹é¡¹**
> ğŸ“ **é‡è¦æé†’**ï¼š
> - å®¹å™¨ä¹‹é—´å¯ä»¥ç›´æ¥é€šè¿‡æœåŠ¡åè®¿é—®
> - ä¸éœ€è¦é…ç½®å¤æ‚çš„IPåœ°å€
> - å¯†ç ç­‰æ•æ„Ÿä¿¡æ¯ä½¿ç”¨CIå˜é‡å­˜å‚¨

---

## 6. ğŸ› ï¸ å®è·µæ¡ˆä¾‹


### 6.1 å®Œæ•´çš„Webåº”ç”¨æµ‹è¯•


```yaml
# ğŸŒŸ å®Œæ•´ç¤ºä¾‹ï¼šWebåº”ç”¨ + æ•°æ®åº“ + ç¼“å­˜
stages:
  - test
  - build

variables:
  # ğŸ”§ å…¨å±€é•œåƒæ‹‰å–ç­–ç•¥
  DOCKER_PULL_POLICY: "if-not-present"

# ğŸ“Š é›†æˆæµ‹è¯• - éœ€è¦å®Œæ•´ç¯å¢ƒ
integration_test:
  stage: test
  image: node:16
  services:
    - name: mysql:8.0
      alias: database
    - name: redis:6.2
      alias: cache
  variables:
    # ğŸ—„ï¸ æ•°æ®åº“é…ç½®
    MYSQL_ROOT_PASSWORD: rootpass
    MYSQL_DATABASE: testdb
    MYSQL_USER: testuser
    MYSQL_PASSWORD: testpass
    # ğŸ”§ åº”ç”¨é…ç½®
    DB_HOST: database
    REDIS_HOST: cache
  script:
    - npm ci                    # å®‰è£…ä¾èµ–
    - npm run migrate          # æ•°æ®åº“è¿ç§»
    - npm run test:integration # é›†æˆæµ‹è¯•
  coverage: '/Lines\s*:\s*(\d+\.?\d*)%/'

# ğŸ—ï¸ æ„å»ºé•œåƒ
build_image:
  stage: build
  image: docker:20.10.16
  services:
    - docker:20.10.16-dind
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
```

### 6.2 å¤šç¯å¢ƒé…ç½®


```yaml
# ğŸ¯ ä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒé…ç½®
.test_template: &test_template
  stage: test
  script:
    - npm test

# ğŸ§ª å¼€å‘ç¯å¢ƒæµ‹è¯•
test_dev:
  <<: *test_template
  image: node:16
  services:
    - mysql:8.0
  variables:
    NODE_ENV: development
  only:
    - develop

# ğŸš€ ç”Ÿäº§ç¯å¢ƒæµ‹è¯•  
test_prod:
  <<: *test_template
  image: 
    name: node:16-alpine
    pull_policy: always
  services:
    - mysql:8.0
  variables:
    NODE_ENV: production
  only:
    - main
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ é•œåƒé…ç½®ï¼šå†³å®šä»£ç è¿è¡Œç¯å¢ƒï¼Œåƒç»™ç¨‹åºå‡†å¤‡"æˆ¿é—´"
ğŸ”¸ æœåŠ¡é…ç½®ï¼šä¸ºç¨‹åºæä¾›æ•°æ®åº“ç­‰è¾…åŠ©æœåŠ¡ï¼Œåƒå‡†å¤‡"é…èœ"  
ğŸ”¸ ç½‘ç»œè¿æ¥ï¼šå®¹å™¨é—´é€šè¿‡æœåŠ¡åç›´æ¥è®¿é—®ï¼Œæ— éœ€å¤æ‚é…ç½®
ğŸ”¸ æ‹‰å–ç­–ç•¥ï¼šæ§åˆ¶ä½•æ—¶ä¸‹è½½é•œåƒï¼Œå¹³è¡¡é€Ÿåº¦ä¸æ–°é²œåº¦
ğŸ”¸ è‡ªå®šä¹‰é•œåƒï¼šæ‰“åŒ…å¸¸ç”¨å·¥å…·ï¼Œé¿å…é‡å¤å®‰è£…
```

### 7.2 å…³é”®é…ç½®è¦ç‚¹


**ğŸ”¹ é•œåƒé€‰æ‹©åŸåˆ™**
```
é€‰æ‹©æ ‡å‡†ï¼š
âœ… åŒ¹é…æŠ€æœ¯æ ˆï¼šNode.jsç”¨nodeé•œåƒï¼ŒPythonç”¨pythoné•œåƒ
âœ… ç‰ˆæœ¬ä¸€è‡´æ€§ï¼šå¼€å‘å’ŒCIç¯å¢ƒç‰ˆæœ¬ä¿æŒä¸€è‡´
âœ… é•œåƒå¤§å°ï¼šä¼˜å…ˆé€‰æ‹©alpineç­‰è½»é‡ç‰ˆæœ¬
âœ… å®˜æ–¹é•œåƒï¼šä¼˜å…ˆä½¿ç”¨å®˜æ–¹ç»´æŠ¤çš„é•œåƒ

å¸¸è§æ­é…ï¼š
å‰ç«¯é¡¹ç›®: node:16-alpine
åç«¯API: python:3.9-slim  
æ•°æ®åº“: mysql:8.0
ç¼“å­˜: redis:6.2-alpine
```

**ğŸ”¹ æœåŠ¡è¿æ¥è¦ç‚¹**
```
è¿æ¥æ–¹å¼ï¼š
ğŸŒ æœåŠ¡åè®¿é—®ï¼šmysqlã€redisã€postgres
ğŸ“¡ æ ‡å‡†ç«¯å£ï¼š3306(MySQL)ã€6379(Redis)ã€5432(PostgreSQL)
ğŸ” å®‰å…¨é…ç½®ï¼šå¯†ç ä½¿ç”¨CIå˜é‡ï¼Œä¸è¦ç¡¬ç¼–ç 

ç½‘ç»œè§„åˆ™ï¼š
- æœåŠ¡ä¹‹é—´å¯ä»¥ç›´æ¥é€šè¿‡åç§°è®¿é—®
- ä¸éœ€è¦é…ç½®IPåœ°å€æˆ–ç«¯å£æ˜ å°„
- ä¸»å®¹å™¨å¯ä»¥è®¿é—®æ‰€æœ‰æœåŠ¡å®¹å™¨
```

### 7.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ æ€§èƒ½ä¼˜åŒ–å»ºè®®**
```
é•œåƒä¼˜åŒ–ï¼š
âš¡ ä½¿ç”¨è½»é‡é•œåƒï¼šalpineç‰ˆæœ¬æ¯”æ ‡å‡†ç‰ˆæœ¬å°50%ä»¥ä¸Š
âš¡ è‡ªå®šä¹‰é•œåƒï¼šå¸¸ç”¨å·¥å…·é¢„è£…ï¼Œé¿å…æ¯æ¬¡é‡æ–°å®‰è£…
âš¡ æ‹‰å–ç­–ç•¥ï¼šå¼€å‘ç¯å¢ƒç”¨if-not-presentï¼Œç”Ÿäº§ç”¨always

æœåŠ¡ä¼˜åŒ–ï¼š
ğŸš€ åªå¯åŠ¨å¿…è¦æœåŠ¡ï¼šæµ‹è¯•éœ€è¦ä»€ä¹ˆæœåŠ¡å°±é…ç½®ä»€ä¹ˆ
ğŸš€ ä½¿ç”¨æœåŠ¡åˆ«åï¼šè®©é…ç½®æ›´æ¸…æ™°æ˜“æ‡‚
ğŸš€ åˆç†é…ç½®èµ„æºï¼šé¿å…æœåŠ¡å¯åŠ¨è¶…æ—¶
```

**ğŸ”§ æ•…éšœæ’æŸ¥æŒ‡å—**
```
å¸¸è§é—®é¢˜ä¸è§£å†³ï¼š

ğŸ”´ é•œåƒæ‹‰å–å¤±è´¥ï¼š
- æ£€æŸ¥é•œåƒåç§°å’Œæ ‡ç­¾æ˜¯å¦æ­£ç¡®
- ç¡®è®¤ç½‘ç»œè¿æ¥å’Œè®¿é—®æƒé™
- å°è¯•ä½¿ç”¨pull_policy: if-not-present

ğŸ”´ æœåŠ¡è¿æ¥å¤±è´¥ï¼š
- ç¡®è®¤æœåŠ¡åç§°æ˜¯å¦æ­£ç¡®
- æ£€æŸ¥ç«¯å£å·æ˜¯å¦ä½¿ç”¨æ ‡å‡†ç«¯å£
- éªŒè¯æœåŠ¡æ˜¯å¦å·²ç»å¯åŠ¨å®Œæˆ

ğŸ”´ ç¯å¢ƒå˜é‡é—®é¢˜ï¼š
- æ£€æŸ¥å˜é‡åæ˜¯å¦æ­£ç¡®
- ç¡®è®¤æ•æ„Ÿä¿¡æ¯ä½¿ç”¨CIå˜é‡å­˜å‚¨
- éªŒè¯å˜é‡ä½œç”¨åŸŸï¼ˆå…¨å±€/Jobçº§åˆ«ï¼‰
```

### 7.4 æœ€ä½³å®è·µæ€»ç»“


**âœ¨ æ¨èé…ç½®æ¨¡å¼**
```yaml
# ğŸ† æœ€ä½³å®è·µæ¨¡æ¿
stages:
  - test
  - build

# å…¨å±€é»˜è®¤é•œåƒ
image: node:16-alpine

# å…¨å±€å˜é‡
variables:
  DOCKER_PULL_POLICY: "if-not-present"

# æµ‹è¯•Job
test:
  stage: test
  services:
    - name: mysql:8.0
      alias: database
  variables:
    MYSQL_ROOT_PASSWORD: $DB_PASSWORD
    DB_HOST: database
  script:
    - npm ci
    - npm test
  coverage: '/Coverage: \d+\.\d+/'
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- é•œåƒæ˜¯ç¯å¢ƒï¼ŒæœåŠ¡æ˜¯é…èœï¼Œç½‘ç»œæ˜¯æ¡¥æ¢
- æœåŠ¡åå°±æ˜¯åœ°å€ï¼Œæ ‡å‡†ç«¯å£ä¸ç”¨æ”¹
- å®‰å…¨ä¿¡æ¯ç”¨å˜é‡ï¼Œç‰ˆæœ¬ç®¡ç†è¦è§„èŒƒ
- æ€§èƒ½ä¼˜åŒ–é€‰è½»é‡ï¼Œæ•…éšœæ’æŸ¥çœ‹æ—¥å¿—