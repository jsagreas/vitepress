---
title: 3ã€Stageé˜¶æ®µä¸Jobé…ç½®
---
## ğŸ“š ç›®å½•

1. [Stageé˜¶æ®µæ¦‚å¿µç†è§£](#1-Stageé˜¶æ®µæ¦‚å¿µç†è§£)
2. [Jobä»»åŠ¡å®šä¹‰ä¸è¯­æ³•](#2-Jobä»»åŠ¡å®šä¹‰ä¸è¯­æ³•)
3. [Scriptè„šæœ¬ç¼–å†™è¯¦è§£](#3-Scriptè„šæœ¬ç¼–å†™è¯¦è§£)
4. [å‰ç½®ä¸åç½®è„šæœ¬é…ç½®](#4-å‰ç½®ä¸åç½®è„šæœ¬é…ç½®)
5. [é˜¶æ®µæ‰§è¡Œé¡ºåºæ§åˆ¶](#5-é˜¶æ®µæ‰§è¡Œé¡ºåºæ§åˆ¶)
6. [Jobå‘½åè§„èŒƒä¸æœ€ä½³å®è·µ](#6-Jobå‘½åè§„èŒƒä¸æœ€ä½³å®è·µ)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ­ Stageé˜¶æ®µæ¦‚å¿µç†è§£


### 1.1 ä»€ä¹ˆæ˜¯Stageé˜¶æ®µ


**ğŸ”¸ é€šä¿—ç†è§£**
æƒ³è±¡ä¸€ä¸‹åˆ¶ä½œä¸€éƒ¨ç”µå½±çš„è¿‡ç¨‹ï¼šå…ˆæ‹æ‘„ã€å†å‰ªè¾‘ã€æœ€åå‘è¡Œã€‚è¿™æ¯ä¸ªæ­¥éª¤å°±æ˜¯ä¸€ä¸ª"é˜¶æ®µ"ã€‚

åœ¨GitLab CI/CDä¸­ï¼Œ`Stage`å°±æ˜¯è¿™æ ·çš„é˜¶æ®µæ¦‚å¿µï¼š
- æŠŠæ•´ä¸ªæ„å»ºè¿‡ç¨‹åˆ†æˆå‡ ä¸ªå¤§æ­¥éª¤
- æ¯ä¸ªé˜¶æ®µæœ‰æ˜ç¡®çš„ç›®çš„å’ŒèŒè´£
- é˜¶æ®µä¹‹é—´æœ‰å…ˆåé¡ºåºï¼Œå‰ä¸€ä¸ªå®Œæˆæ‰èƒ½è¿›è¡Œä¸‹ä¸€ä¸ª

```
è½¯ä»¶å¼€å‘çš„å…¸å‹é˜¶æ®µæµç¨‹ï¼š

å‡†å¤‡ç¯å¢ƒ â†’ ä»£ç æ£€æŸ¥ â†’ æ„å»ºæ‰“åŒ… â†’ æµ‹è¯•éªŒè¯ â†’ éƒ¨ç½²å‘å¸ƒ
   â†“          â†“          â†“          â†“          â†“
 build    â†’  test    â†’  package  â†’  verify  â†’  deploy
```

**ğŸ’¡ ä¸ºä»€ä¹ˆè¦ç”¨é˜¶æ®µ**
- **é€»è¾‘æ¸…æ™°**ï¼šæ¯ä¸ªé˜¶æ®µåšä»€ä¹ˆä¸€ç›®äº†ç„¶
- **ä¾¿äºç®¡ç†**ï¼šå¯ä»¥å•ç‹¬æ§åˆ¶æŸä¸ªé˜¶æ®µçš„æ‰§è¡Œ
- **é”™è¯¯å®šä½**ï¼šå‡ºé—®é¢˜æ—¶èƒ½å¿«é€ŸçŸ¥é“åœ¨å“ªä¸ªç¯èŠ‚
- **å¹¶è¡Œå¤„ç†**ï¼šåŒä¸€é˜¶æ®µå†…çš„ä»»åŠ¡å¯ä»¥åŒæ—¶è¿›è¡Œ

### 1.2 stagesé˜¶æ®µå®šä¹‰è¯­æ³•


**ğŸ“‹ åŸºç¡€å®šä¹‰æ–¹å¼**

```yaml
# .gitlab-ci.yml æ–‡ä»¶å¼€å¤´å®šä¹‰æ‰€æœ‰é˜¶æ®µ
stages:
  - build      # æ„å»ºé˜¶æ®µ
  - test       # æµ‹è¯•é˜¶æ®µ  
  - deploy     # éƒ¨ç½²é˜¶æ®µ
```

> **é‡è¦æç¤º**ï¼š`stages`å®šä¹‰çš„æ˜¯æ•´ä¸ªæµæ°´çº¿çš„é˜¶æ®µé¡ºåºï¼Œå¿…é¡»å†™åœ¨æ–‡ä»¶å¼€å¤´ã€‚

**ğŸ”§ å®é™…åº”ç”¨ç¤ºä¾‹**

```yaml
# å®Œæ•´çš„é˜¶æ®µå®šä¹‰ç¤ºä¾‹
stages:
  - prepare     # å‡†å¤‡ç¯å¢ƒ
  - lint        # ä»£ç æ£€æŸ¥
  - build       # ç¼–è¯‘æ„å»º
  - test        # è¿è¡Œæµ‹è¯•
  - package     # æ‰“åŒ…åº”ç”¨
  - deploy-dev  # éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ
  - deploy-prod # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
```

### 1.3 é˜¶æ®µçš„æ‰§è¡Œç‰¹ç‚¹


```
Stageæ‰§è¡Œè§„å¾‹ï¼š

åŒä¸€é˜¶æ®µå†…ï¼š
Job A â”
Job B â”œâ”€ å¹¶è¡Œæ‰§è¡Œï¼ˆåŒæ—¶è¿›è¡Œï¼‰
Job C â”˜

ä¸åŒé˜¶æ®µé—´ï¼š
Stage 1 â†’ Stage 2 â†’ Stage 3  (é¡ºåºæ‰§è¡Œï¼Œå‰ä¸€ä¸ªå®Œæˆæ‰å¼€å§‹ä¸‹ä¸€ä¸ª)
```

**âš¡ æ‰§è¡Œè§„åˆ™æ€»ç»“**
- **é˜¶æ®µé—´**ï¼šä¸¥æ ¼æŒ‰é¡ºåºæ‰§è¡Œï¼Œä¸èƒ½è·³è·ƒ
- **é˜¶æ®µå†…**ï¼šæ‰€æœ‰Jobå¹¶è¡Œæ‰§è¡Œï¼Œæé«˜æ•ˆç‡
- **å¤±è´¥å¤„ç†**ï¼šä»»ä¸€é˜¶æ®µå¤±è´¥ï¼Œåç»­é˜¶æ®µä¸ä¼šæ‰§è¡Œ
- **è·³è¿‡æœºåˆ¶**ï¼šæŸé˜¶æ®µæ— Jobæ—¶è‡ªåŠ¨è·³è¿‡

---

## 2. âš™ï¸ Jobä»»åŠ¡å®šä¹‰ä¸è¯­æ³•


### 2.1 ä»€ä¹ˆæ˜¯Jobä»»åŠ¡


**ğŸ”¸ ç”Ÿæ´»åŒ–ç†è§£**
å¦‚æœStageæ˜¯"åšé¥­"è¿™ä¸ªå¤§é˜¶æ®µï¼Œé‚£ä¹ˆJobå°±æ˜¯å…·ä½“çš„å°ä»»åŠ¡ï¼š
- æ´—èœï¼ˆä¸€ä¸ªJobï¼‰
- åˆ‡èœï¼ˆä¸€ä¸ªJobï¼‰  
- ç‚’èœï¼ˆä¸€ä¸ªJobï¼‰

åœ¨GitLab CI/CDä¸­ï¼ŒJobæ˜¯å®é™…æ‰§è¡Œå·¥ä½œçš„æœ€å°å•ä½ï¼š
- æ¯ä¸ªJobè¿è¡Œåœ¨ç‹¬ç«‹çš„ç¯å¢ƒä¸­
- JobåŒ…å«å…·ä½“è¦æ‰§è¡Œçš„å‘½ä»¤
- Jobæœ‰è‡ªå·±çš„é…ç½®å’Œè®¾ç½®

### 2.2 Jobå®šä¹‰åŸºç¡€è¯­æ³•


**ğŸ“ Jobçš„åŸºæœ¬ç»“æ„**

```yaml
jobåç§°:
  stage: æ‰€å±é˜¶æ®µåç§°
  script:
    - è¦æ‰§è¡Œçš„å‘½ä»¤1
    - è¦æ‰§è¡Œçš„å‘½ä»¤2
```

**ğŸ¯ å®Œæ•´Jobç¤ºä¾‹**

```yaml
stages:
  - build
  - test

# æ„å»ºJob
compile-app:
  stage: build
  script:
    - echo "å¼€å§‹ç¼–è¯‘åº”ç”¨"
    - npm install
    - npm run build
    - echo "ç¼–è¯‘å®Œæˆ"

# æµ‹è¯•Job  
test-app:
  stage: test
  script:
    - echo "å¼€å§‹è¿è¡Œæµ‹è¯•"
    - npm test
    - echo "æµ‹è¯•å®Œæˆ"
```

### 2.3 Jobé…ç½®é€‰é¡¹è¯¦è§£


**ğŸ”§ å¸¸ç”¨Jobé…ç½®å±æ€§**

| **é…ç½®é¡¹** | **ä½œç”¨** | **ç¤ºä¾‹** | **è¯´æ˜** |
|-----------|---------|---------|---------|
| `stage` | æŒ‡å®šæ‰€å±é˜¶æ®µ | `stage: build` | Jobå½’å±äºå“ªä¸ªStage |
| `script` | æ‰§è¡Œçš„å‘½ä»¤ | `script: [echo hello]` | å…·ä½“è¦è¿è¡Œçš„è„šæœ¬ |
| `image` | è¿è¡Œç¯å¢ƒ | `image: node:16` | ä½¿ç”¨çš„Dockeré•œåƒ |
| `only` | è§¦å‘æ¡ä»¶ | `only: [main]` | ä»…åœ¨mainåˆ†æ”¯è§¦å‘ |
| `except` | æ’é™¤æ¡ä»¶ | `except: [tags]` | æ ‡ç­¾æäº¤æ—¶ä¸æ‰§è¡Œ |
| `when` | æ‰§è¡Œæ—¶æœº | `when: manual` | æ‰‹åŠ¨è§¦å‘æ‰§è¡Œ |

**ğŸ’¡ å®Œæ•´é…ç½®ç¤ºä¾‹**

```yaml
# åŠŸèƒ½ä¸°å¯Œçš„Jobé…ç½®
build-frontend:
  stage: build
  image: node:16-alpine
  script:
    - npm ci
    - npm run build
  only:
    - main
    - develop
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour
```

---

## 3. ğŸ“ Scriptè„šæœ¬ç¼–å†™è¯¦è§£


### 3.1 scriptè„šæœ¬åŸºç¡€æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯script**
`script`å°±æ˜¯Jobè¦æ‰§è¡Œçš„å…·ä½“å‘½ä»¤ï¼Œç±»ä¼¼äºåœ¨ç»ˆç«¯é‡Œæ‰‹åŠ¨è¾“å…¥çš„å‘½ä»¤ã€‚

**ğŸ“‹ scriptçš„ä¸¤ç§å†™æ³•**

```yaml
# æ–¹å¼1ï¼šæ•°ç»„å½¢å¼ï¼ˆæ¨èï¼‰
build-job:
  script:
    - echo "ç¬¬ä¸€æ¡å‘½ä»¤"
    - npm install
    - npm run build

# æ–¹å¼2ï¼šå•è¡Œå½¢å¼
simple-job:
  script: echo "è¿™æ˜¯ä¸€æ¡ç®€å•å‘½ä»¤"
```

### 3.2 è„šæœ¬ç¼–å†™æŠ€å·§


**ğŸ¯ å¤šè¡Œå‘½ä»¤å¤„ç†**

```yaml
complex-build:
  script:
    # è®¾ç½®ç¯å¢ƒå˜é‡
    - export NODE_ENV=production
    # å®‰è£…ä¾èµ–
    - npm ci --only=production
    # ç¼–è¯‘é¡¹ç›®
    - npm run build
    # æ£€æŸ¥æ„å»ºç»“æœ
    - ls -la dist/
    - echo "æ„å»ºäº§ç‰©å¤§å°ï¼š$(du -sh dist/)"
```

**âš¡ é”™è¯¯å¤„ç†æŠ€å·§**

```yaml
robust-job:
  script:
    # ç¡®ä¿å‘½ä»¤å¤±è´¥æ—¶åœæ­¢æ‰§è¡Œ
    - set -e
    # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    - test -f package.json || (echo "package.jsonä¸å­˜åœ¨" && exit 1)
    # æœ‰æ¡ä»¶æ‰§è¡Œå‘½ä»¤
    - if [ "$CI_COMMIT_BRANCH" = "main" ]; then npm run build-prod; else npm run build-dev; fi
```

### 3.3 å¸¸ç”¨è„šæœ¬æ¨¡å¼


**ğŸ”§ ç¯å¢ƒæ£€æŸ¥è„šæœ¬**

```yaml
check-environment:
  script:
    - node --version
    - npm --version
    - echo "å½“å‰åˆ†æ”¯ï¼š$CI_COMMIT_BRANCH"
    - echo "æäº¤IDï¼š$CI_COMMIT_SHA"
```

**ğŸ“¦ æ„å»ºè„šæœ¬æ¨¡å¼**

```yaml
build-application:
  script:
    - echo "ğŸ“¥ å®‰è£…ä¾èµ–..."
    - npm ci
    - echo "ğŸ”§ ç¼–è¯‘ä»£ç ..."
    - npm run build
    - echo "âœ… æ„å»ºå®Œæˆ"
    - ls -la dist/
```

---

## 4. ğŸ”„ å‰ç½®ä¸åç½®è„šæœ¬é…ç½®


### 4.1 before_scriptå‰ç½®è„šæœ¬


**ğŸ”¸ æ¦‚å¿µç†è§£**
`before_script`å°±åƒæ˜¯é¢„ä¹ åŠŸè¯¾ï¼Œåœ¨æ­£å¼å¼€å§‹å·¥ä½œï¼ˆscriptï¼‰ä¹‹å‰å…ˆåšçš„å‡†å¤‡å·¥ä½œã€‚

```
æ‰§è¡Œé¡ºåºï¼š
before_script â†’ script â†’ after_script
    â†“            â†“          â†“
   å‡†å¤‡å·¥ä½œ    â†’ ä¸»è¦å·¥ä½œ â†’ æ”¶å°¾å·¥ä½œ
```

**ğŸ“‹ before_scriptä½¿ç”¨åœºæ™¯**

```yaml
test-app:
  before_script:
    # å‡†å¤‡æµ‹è¯•ç¯å¢ƒ
    - echo "ğŸ”§ å‡†å¤‡æµ‹è¯•ç¯å¢ƒ"
    - npm ci
    - cp config.example.js config.js
    # å¯åŠ¨æµ‹è¯•æ•°æ®åº“
    - docker run -d --name test-db postgres:13
  script:
    # ä¸»è¦æµ‹è¯•å·¥ä½œ
    - echo "ğŸ§ª å¼€å§‹è¿è¡Œæµ‹è¯•"
    - npm test
  after_script:
    # æ¸…ç†æµ‹è¯•ç¯å¢ƒ
    - echo "ğŸ§¹ æ¸…ç†æµ‹è¯•ç¯å¢ƒ"
    - docker stop test-db
    - docker rm test-db
```

### 4.2 after_scriptåç½®è„šæœ¬


**ğŸ”¸ æ¦‚å¿µç†è§£**
`after_script`åƒæ˜¯åšå®Œä½œä¸šåæ•´ç†ä¹¦æ¡Œï¼Œæ— è®ºä¸»è¦å·¥ä½œæ˜¯å¦æˆåŠŸï¼Œéƒ½ä¼šæ‰§è¡Œçš„æ”¶å°¾å·¥ä½œã€‚

**âš ï¸ é‡è¦ç‰¹ç‚¹**
- **æ€»æ˜¯æ‰§è¡Œ**ï¼šå³ä½¿scriptå¤±è´¥ï¼Œafter_scriptä»ä¼šè¿è¡Œ
- **ç‹¬ç«‹ç¯å¢ƒ**ï¼šafter_scriptåœ¨æ–°çš„shellä¸­è¿è¡Œ
- **ä¸å½±å“ç»“æœ**ï¼šafter_scriptå¤±è´¥ä¸ä¼šå½±å“Jobçš„æˆåŠŸçŠ¶æ€

**ğŸ§¹ å…¸å‹æ¸…ç†åœºæ™¯**

```yaml
deploy-job:
  script:
    - echo "éƒ¨ç½²åº”ç”¨åˆ°æœåŠ¡å™¨"
    - scp -r dist/ user@server:/app/
  after_script:
    # æ— è®ºéƒ¨ç½²æˆåŠŸä¸å¦ï¼Œéƒ½è¦æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    - rm -rf temp/
    - echo "ä¸´æ—¶æ–‡ä»¶å·²æ¸…ç†"
    # å‘é€é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
    - curl -X POST $WEBHOOK_URL -d "éƒ¨ç½²ä»»åŠ¡å·²å®Œæˆ"
```

### 4.3 å…¨å±€vså±€éƒ¨è„šæœ¬é…ç½®


**ğŸŒ å…¨å±€é…ç½®**

```yaml
# æ‰€æœ‰Jobéƒ½ä¼šæ‰§è¡Œçš„å…¬å…±è„šæœ¬
default:
  before_script:
    - echo "ğŸš€ å¼€å§‹æ‰§è¡ŒCI/CDæµæ°´çº¿"
    - date
  after_script:
    - echo "âœ… ä»»åŠ¡æ‰§è¡Œå®Œæ¯•"
    - date

stages:
  - test
  - build

# ç»§æ‰¿å…¨å±€é…ç½®çš„Job
test-job:
  stage: test
  script:
    - npm test

# è¦†ç›–å…¨å±€é…ç½®çš„Job
build-job:
  stage: build
  before_script:
    - echo "ğŸ”§ å¼€å§‹æ„å»ºå‰çš„ç‰¹æ®Šå‡†å¤‡"
  script:
    - npm run build
```

---

## 5. ğŸ¯ é˜¶æ®µæ‰§è¡Œé¡ºåºæ§åˆ¶


### 5.1 é»˜è®¤æ‰§è¡Œé¡ºåº


**ğŸ“Š GitLabå†…ç½®é»˜è®¤é˜¶æ®µ**

```
GitLabé»˜è®¤stageé¡ºåºï¼š
.pre â†’ build â†’ test â†’ deploy â†’ .post
```

å¦‚æœä¸å®šä¹‰stagesï¼ŒGitLabä¼šä½¿ç”¨è¿™ä¸ªé»˜è®¤é¡ºåºã€‚

**ğŸ”§ è‡ªå®šä¹‰é¡ºåºæ§åˆ¶**

```yaml
# è‡ªå®šä¹‰é˜¶æ®µé¡ºåº
stages:
  - prepare      # ç¬¬1é˜¶æ®µï¼šç¯å¢ƒå‡†å¤‡
  - validate     # ç¬¬2é˜¶æ®µï¼šä»£ç éªŒè¯  
  - compile      # ç¬¬3é˜¶æ®µï¼šç¼–è¯‘æ„å»º
  - unit-test    # ç¬¬4é˜¶æ®µï¼šå•å…ƒæµ‹è¯•
  - integration  # ç¬¬5é˜¶æ®µï¼šé›†æˆæµ‹è¯•
  - package      # ç¬¬6é˜¶æ®µï¼šæ‰“åŒ…åˆ¶å“
  - deploy-dev   # ç¬¬7é˜¶æ®µï¼šå¼€å‘ç¯å¢ƒéƒ¨ç½²
  - smoke-test   # ç¬¬8é˜¶æ®µï¼šå†’çƒŸæµ‹è¯•
  - deploy-prod  # ç¬¬9é˜¶æ®µï¼šç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
```

### 5.2 é˜¶æ®µé—´ä¾èµ–å…³ç³»


**ğŸ”— ä¾èµ–å…³ç³»å›¾ç¤º**

```
å®é™…é¡¹ç›®ä¸­çš„é˜¶æ®µä¾èµ–ï¼š

ç¯å¢ƒå‡†å¤‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                           â”‚
    â–¼                           â”‚
ä»£ç æ£€æŸ¥ â”€â”€â”€â”€â”                    â”‚
    â”‚       â”‚                   â”‚
    â–¼       â–¼                   â”‚
å•å…ƒæµ‹è¯•   ç¼–è¯‘æ„å»º â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚       â”‚                   â”‚
    â”‚       â–¼                   â”‚
    â””â”€â”€â”€ é›†æˆæµ‹è¯•                 â”‚
            â”‚                   â”‚
            â–¼                   â”‚
        æ‰“åŒ…éƒ¨ç½² â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ’¡ é˜¶æ®µè®¾è®¡åŸåˆ™**
- **é€»è¾‘æ¸…æ™°**ï¼šæ¯ä¸ªé˜¶æ®µèŒè´£æ˜ç¡®
- **å¤±è´¥å¿«é€Ÿ**ï¼šæŠŠå®¹æ˜“å¤±è´¥çš„æ£€æŸ¥æ”¾åœ¨å‰é¢
- **ä¾èµ–åˆç†**ï¼šåé¢çš„é˜¶æ®µä¾èµ–å‰é¢çš„æˆæœ
- **å¹¶è¡Œä¼˜åŒ–**ï¼šåŒé˜¶æ®µå†…ä»»åŠ¡å°½é‡å¯å¹¶è¡Œ

### 5.3 æ¡ä»¶æ§åˆ¶æ‰§è¡Œ


**ğŸ›ï¸ ä½¿ç”¨needså…³é”®å­—**

```yaml
stages:
  - build
  - test
  - deploy

# æ­£å¸¸æŒ‰é˜¶æ®µé¡ºåº
build-job:
  stage: build
  script: npm run build

# å¯ä»¥è·³è¿‡testé˜¶æ®µï¼Œç›´æ¥ä¾èµ–build
deploy-urgent:
  stage: deploy
  needs: [build-job]  # åªè¦build-jobå®Œæˆå°±å¯ä»¥å¼€å§‹
  script: echo "ç´§æ€¥éƒ¨ç½²"
  when: manual

# æ­£å¸¸çš„æµ‹è¯•Job
test-job:
  stage: test
  script: npm test
```

---

## 6. ğŸ“› Jobå‘½åè§„èŒƒä¸æœ€ä½³å®è·µ


### 6.1 Jobå‘½åè§„èŒƒ


**âœ… æ¨èçš„å‘½åæ¨¡å¼**

```yaml
# æ¨¡å¼ï¼šåŠ¨ä½œ-å¯¹è±¡-ç¯å¢ƒ
build-frontend-prod    # æ„å»ºå‰ç«¯ç”Ÿäº§ç‰ˆæœ¬
test-api-unit         # APIå•å…ƒæµ‹è¯•
deploy-app-staging    # éƒ¨ç½²åº”ç”¨åˆ°é¢„å‘ç¯å¢ƒ
lint-code-javascript  # JavaScriptä»£ç æ£€æŸ¥

# æ¨¡å¼ï¼šé˜¶æ®µ:å…·ä½“ä»»åŠ¡
build:compile         # æ„å»ºé˜¶æ®µçš„ç¼–è¯‘ä»»åŠ¡
test:unit            # æµ‹è¯•é˜¶æ®µçš„å•å…ƒæµ‹è¯•
deploy:production    # éƒ¨ç½²é˜¶æ®µçš„ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
```

**âŒ é¿å…çš„å‘½åæ–¹å¼**

```yaml
# å¤ªæ¨¡ç³Š
job1, job2, test

# å¤ªé•¿
build-and-test-frontend-application-for-production-environment

# ç‰¹æ®Šå­—ç¬¦
build@frontend, test#api
```

### 6.2 å‘½åæœ€ä½³å®è·µ


**ğŸ“‹ å®ç”¨å‘½åç¤ºä¾‹**

```yaml
stages:
  - validate
  - build  
  - test
  - deploy

# éªŒè¯é˜¶æ®µ
validate:syntax:
  stage: validate
  script: npm run lint

validate:security:
  stage: validate  
  script: npm audit

# æ„å»ºé˜¶æ®µ
build:frontend:
  stage: build
  script: npm run build:prod

build:backend:
  stage: build
  script: ./gradlew build

# æµ‹è¯•é˜¶æ®µ  
test:unit:
  stage: test
  script: npm run test:unit

test:integration:
  stage: test
  script: npm run test:integration

# éƒ¨ç½²é˜¶æ®µ
deploy:dev:
  stage: deploy
  script: ./deploy.sh dev
  
deploy:prod:
  stage: deploy
  script: ./deploy.sh prod
  when: manual
```

### 6.3 å›¢é˜Ÿåä½œè§„èŒƒ


**ğŸ¤ å›¢é˜Ÿå‘½åçº¦å®š**

| **å‰ç¼€** | **å«ä¹‰** | **ç¤ºä¾‹** | **è¯´æ˜** |
|---------|---------|---------|---------|
| `build:` | æ„å»ºç›¸å…³ | `build:frontend` | ç¼–è¯‘ã€æ‰“åŒ…ä»»åŠ¡ |
| `test:` | æµ‹è¯•ç›¸å…³ | `test:e2e` | å„ç§æµ‹è¯•ä»»åŠ¡ |
| `deploy:` | éƒ¨ç½²ç›¸å…³ | `deploy:staging` | éƒ¨ç½²åˆ°å„ç¯å¢ƒ |
| `check:` | æ£€æŸ¥ç›¸å…³ | `check:security` | ä»£ç æ£€æŸ¥ã€æ‰«æ |
| `publish:` | å‘å¸ƒç›¸å…³ | `publish:npm` | å‘å¸ƒåˆ°ä»“åº“ |

**ğŸ“š æ–‡æ¡£åŒ–å»ºè®®**

```yaml
# åœ¨é¡¹ç›®READMEä¸­è®°å½•å‘½åè§„èŒƒ
#
# Jobå‘½åè§„èŒƒï¼š
# - ä½¿ç”¨å°å†™å­—æ¯å’Œè¿å­—ç¬¦
# - æ ¼å¼ï¼šé˜¶æ®µ:å…·ä½“ä»»åŠ¡:ç¯å¢ƒï¼ˆå¯é€‰ï¼‰
# - ä¾‹å¦‚ï¼šbuild:frontend:prod
#
# Stageå‘½åè§„èŒƒï¼š
# - ä½¿ç”¨æè¿°æ€§çš„è‹±æ–‡å•è¯
# - ä½“ç°æ‰§è¡Œé¡ºåºå’Œé€»è¾‘å…³ç³»
# - ä¾‹å¦‚ï¼švalidate â†’ build â†’ test â†’ deploy
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Stageé˜¶æ®µï¼šCI/CDæµæ°´çº¿çš„é€»è¾‘åˆ†æ®µï¼ŒæŒ‰é¡ºåºæ‰§è¡Œ
ğŸ”¸ Jobä»»åŠ¡ï¼šå®é™…æ‰§è¡Œå·¥ä½œçš„æœ€å°å•ä½ï¼ŒåŒé˜¶æ®µå†…å¹¶è¡Œæ‰§è¡Œ
ğŸ”¸ scriptè„šæœ¬ï¼šJobä¸­è¦æ‰§è¡Œçš„å…·ä½“å‘½ä»¤åˆ—è¡¨
ğŸ”¸ before_scriptï¼šJobæ‰§è¡Œå‰çš„å‡†å¤‡å·¥ä½œ
ğŸ”¸ after_scriptï¼šJobæ‰§è¡Œåçš„æ¸…ç†å·¥ä½œï¼Œæ€»æ˜¯æ‰§è¡Œ
ğŸ”¸ stageså®šä¹‰ï¼šå…¨å±€å®šä¹‰æ‰€æœ‰é˜¶æ®µåŠå…¶æ‰§è¡Œé¡ºåº
ğŸ”¸ Jobå‘½åï¼šä½¿ç”¨æ¸…æ™°ã€ä¸€è‡´çš„å‘½åè§„èŒƒ
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ é˜¶æ®µä¸ä»»åŠ¡çš„å…³ç³»**
```
Stageåƒæ˜¯å·¥å‚çš„ç”Ÿäº§çº¿å·¥åºï¼š
ä¸‹æ–™ â†’ åŠ å·¥ â†’ ç»„è£… â†’ æ£€éªŒ â†’ åŒ…è£…

Jobåƒæ˜¯æ¯ä¸ªå·¥åºä¸­çš„å…·ä½“å·¥ä½œï¼š
ä¸‹æ–™å·¥åºï¼šåˆ‡å‰²ææ–™ã€å‡†å¤‡é›¶ä»¶
åŠ å·¥å·¥åºï¼šæ‰“ç£¨ã€é’»å­”ã€æˆå‹
```

**ğŸ”¹ æ‰§è¡Œé¡ºåºçš„é‡è¦æ€§**
```
ä¸ºä»€ä¹ˆé¡ºåºå¾ˆé‡è¦ï¼š
- ä»£ç æ£€æŸ¥åœ¨æ„å»ºå‰ï¼ˆå‘ç°é—®é¢˜æ—©ï¼‰
- æ„å»ºåœ¨æµ‹è¯•å‰ï¼ˆå…ˆæœ‰äº§ç‰©å†æµ‹è¯•ï¼‰
- æµ‹è¯•åœ¨éƒ¨ç½²å‰ï¼ˆç¡®ä¿è´¨é‡ï¼‰
- éƒ¨ç½²åˆ†ç¯å¢ƒè¿›è¡Œï¼ˆé£é™©æ§åˆ¶ï¼‰
```

**ğŸ”¹ è„šæœ¬ç¼–å†™çš„æŠ€å·§**
```
å¥½çš„è„šæœ¬ç‰¹ç‚¹ï¼š
- æ¯æ¡å‘½ä»¤èŒè´£å•ä¸€
- æœ‰æ¸…æ™°çš„è¾“å‡ºä¿¡æ¯
- åšå¥½é”™è¯¯å¤„ç†
- ä¾¿äºè°ƒè¯•å’Œç»´æŠ¤
```

### 7.3 å®é™…åº”ç”¨åœºæ™¯


**ğŸ’¼ å…¸å‹çš„å‰ç«¯é¡¹ç›®é…ç½®**

```yaml
stages:
  - lint
  - build
  - test
  - deploy

lint:code:
  stage: lint
  script:
    - npm run eslint
    - npm run stylelint

build:dist:
  stage: build
  script:
    - npm ci
    - npm run build:prod
  artifacts:
    paths:
      - dist/

test:unit:
  stage: test
  script:
    - npm run test:coverage

deploy:staging:
  stage: deploy
  script:
    - rsync -av dist/ staging-server:/var/www/
  only:
    - develop

deploy:production:
  stage: deploy
  script:
    - rsync -av dist/ prod-server:/var/www/
  only:
    - main
  when: manual
```

### 7.4 å¸¸è§é—®é¢˜ä¸è§£å†³


**â“ æ–°æ‰‹å¸¸è§é—®é¢˜**

**é—®é¢˜1ï¼šJobæ²¡æœ‰è¿è¡Œ**
```
å¯èƒ½åŸå› ï¼š
- Jobåç§°ä¸stageåç§°å†²çª
- stagesä¸­æ²¡æœ‰å®šä¹‰å¯¹åº”çš„stage
- only/exceptæ¡ä»¶ä¸æ»¡è¶³

è§£å†³æ–¹æ³•ï¼š
- æ£€æŸ¥stageå®šä¹‰
- ç¡®è®¤è§¦å‘æ¡ä»¶
- æŸ¥çœ‹Jobé¡µé¢çš„è·³è¿‡åŸå› 
```

**é—®é¢˜2ï¼šscriptå‘½ä»¤å¤±è´¥**
```
å¯èƒ½åŸå› ï¼š
- å‘½ä»¤è¯­æ³•é”™è¯¯
- ç¯å¢ƒç¼ºå°‘ä¾èµ–
- æƒé™ä¸è¶³

è§£å†³æ–¹æ³•ï¼š
- åœ¨æœ¬åœ°æµ‹è¯•å‘½ä»¤
- æ£€æŸ¥è¿è¡Œç¯å¢ƒ
- æ·»åŠ è°ƒè¯•è¾“å‡º
```

**é—®é¢˜3ï¼šé˜¶æ®µé¡ºåºæ··ä¹±**
```
å¯èƒ½åŸå› ï¼š
- stageså®šä¹‰é¡ºåºä¸å¯¹
- ä½¿ç”¨äº†é»˜è®¤stageåç§°

è§£å†³æ–¹æ³•ï¼š
- æ˜ç¡®å®šä¹‰stages
- æ£€æŸ¥stageåç§°æ‹¼å†™
- ç”»å‡ºæµç¨‹å›¾è§„åˆ’é¡ºåº
```

### 7.5 è¿›é˜¶å­¦ä¹ æ–¹å‘


**ğŸš€ åç»­å­¦ä¹ å»ºè®®**
- **å˜é‡ä½¿ç”¨**ï¼šå­¦ä¹ CI/CDå˜é‡çš„å®šä¹‰å’Œä½¿ç”¨
- **ç¼“å­˜æœºåˆ¶**ï¼šäº†è§£å¦‚ä½•åŠ é€Ÿæ„å»ºè¿‡ç¨‹
- **å¹¶è¡Œç­–ç•¥**ï¼šæŒæ¡Jobå¹¶è¡Œæ‰§è¡Œçš„é…ç½®
- **é”™è¯¯å¤„ç†**ï¼šå­¦ä¹ å¤±è´¥é‡è¯•å’Œé”™è¯¯æ¢å¤
- **å®‰å…¨å®è·µ**ï¼šäº†è§£æ•æ„Ÿä¿¡æ¯çš„å®‰å…¨å¤„ç†

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
Stageåˆ†é˜¶æ®µï¼ŒJobåšä»»åŠ¡
scriptå†™å‘½ä»¤ï¼Œé¡ºåºè¦æ¸…æ¥š
beforeå‡†å¤‡å·¥ä½œï¼Œafteræ¥æ”¶å°¾
å‘½åè¦è§„èŒƒï¼Œç»´æŠ¤æ›´å®¹æ˜“
```