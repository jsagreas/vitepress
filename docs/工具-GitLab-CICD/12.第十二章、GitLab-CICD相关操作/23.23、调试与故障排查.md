---
title: 23、调试与故障排查
---
## 📚 目录


1. [CI/CD调试基础概念](#1-cicd调试基础概念)
2. [本地Pipeline调试](#2-本地pipeline调试)
3. [gitlab-ci-multi-runner本地执行](#3-gitlab-ci-multi-runner本地执行)
4. [配置文件语法检查](#4-配置文件语法检查)
5. [变量值调试输出](#5-变量值调试输出)
6. [Runner连接问题排查](#6-runner连接问题排查)
7. [权限问题诊断](#7-权限问题诊断)
8. [网络连接故障处理](#8-网络连接故障处理)
9. [常见错误解决方案](#9-常见错误解决方案)
10. [核心要点总结](#10-核心要点总结)

---

# 🎯 **学习导航**


**前置知识**：需要了解GitLab CI/CD基本概念、YAML语法 → **当前内容**：调试与故障排查 → **后续学习**：建议深入学习生产环境最佳实践

⏱️ **预计学习时间**：本章节约45分钟 | 实践操作30分钟

🏷️ **知识标签**：`#调试技巧` `#故障排查` `#新手必会` `#实用工具`

---

## 1. 🔍 CI/CD调试基础概念



### 1.1 什么是CI/CD调试



**💡 通俗解释**
想象你在做一道复杂的菜：
- **没有调试**：菜做坏了也不知道哪步出错
- **有调试**：每一步都能检查，出错马上知道原因

CI/CD调试就是这样，让你能够：
- **看到过程**：每一步执行了什么
- **发现问题**：哪里出错了
- **快速修复**：知道怎么改正

**🔸 核心作用**
```
问题发现：及时发现Pipeline执行中的错误
原因定位：快速找到问题的具体位置
解决指导：提供修复问题的具体方法
```

### 1.2 常见的CI/CD问题类型



**📊 问题分类表**

| **问题类型** | **常见症状** | **影响程度** | **解决难度** |
|-------------|-------------|-------------|-------------|
| **配置错误** | `YAML语法错误，Pipeline不启动` | 🔴 高 | ⭐ 简单 |
| **权限问题** | `无法访问仓库或服务` | 🟡 中 | ⭐⭐ 中等 |
| **网络故障** | `下载依赖失败，超时` | 🟡 中 | ⭐⭐⭐ 困难 |
| **环境问题** | `命令找不到，版本不匹配` | 🟡 中 | ⭐⭐ 中等 |

### 1.3 调试思维方式



**🧠 调试策略**
```
🔸 分层思考：从外到内逐层排查
🔸 日志优先：先看日志再猜测
🔸 最小复现：简化问题到最小范围
🔸 对比验证：和正常情况对比差异
```

**💭 新手常见误区**
> ❌ **错误做法**：一看到错误就慌张，随便改配置
> ✅ **正确做法**：冷静看日志，理解错误信息，有针对性地修复

---

## 2. 🏠 本地Pipeline调试



### 2.1 为什么要本地调试



**🤔 问题场景**
你写了一个 `.gitlab-ci.yml` 文件，提交到GitLab后发现Pipeline失败了。如果每次修改都要：
1. 改配置文件
2. 提交到GitLab  
3. 等待Pipeline运行
4. 查看结果

这样太慢了！就像做菜时每试一次味道都要重新做一遍。

**💡 本地调试的好处**
- **快速验证**：几秒钟就能知道配置对不对
- **节省资源**：不消耗GitLab Runner资源
- **方便实验**：可以随意尝试不同配置

### 2.2 本地调试环境准备



**🛠️ 准备工作清单**
- [ ] 安装Docker (用来模拟Pipeline环境)
- [ ] 安装GitLab Runner (本地调试工具)
- [ ] 准备项目代码 (和GitLab上一样的代码)

**📝 环境检查命令**
```bash
# 检查Docker是否安装

docker --version

# 检查GitLab Runner是否安装  

gitlab-runner --version

# 检查当前目录是否有.gitlab-ci.yml

ls -la | grep gitlab-ci
```

### 2.3 本地调试基本流程



**🔄 调试步骤**

**第一步：准备配置文件**
创建一个简单的测试配置：
```yaml
# .gitlab-ci.yml

test-job:
  script:
    - echo "Hello GitLab CI"
    - ls -la
```

**第二步：本地验证语法**
```bash
# 在项目根目录执行

gitlab-runner exec docker test-job
```

**第三步：查看执行结果**
如果成功，你会看到：
```
✅ Job succeeded
```

如果失败，会显示具体错误信息。

### 2.4 本地调试进阶技巧



**🎯 模拟不同环境**
```bash
# 使用不同的Docker镜像测试

gitlab-runner exec docker --docker-image=ubuntu:20.04 test-job

# 模拟特定的CI变量

gitlab-runner exec docker --env CI_COMMIT_REF_NAME=main test-job
```

**📊 调试信息收集**
- **执行日志**：每一步的输出都能看到
- **环境变量**：可以检查变量是否正确设置
- **文件系统**：可以查看生成的文件

**💡 实用建议**
> **先本地后远程**：配置在本地调试通过后，再提交到GitLab
> **逐步增加复杂度**：从简单的 `echo` 开始，逐步添加真实的构建步骤

---

## 3. 🖥️ gitlab-ci-multi-runner本地执行



### 3.1 gitlab-ci-multi-runner简介



**🔸 什么是gitlab-ci-multi-runner**
这是GitLab Runner的旧版本名称，现在统一叫 `gitlab-runner`。但有些教程还在用旧名称，所以你需要知道它们是同一个东西。

**💭 通俗类比**
就像手机的操作系统从iOS 13升级到iOS 14，功能类似但名字变了。

### 3.2 本地执行的核心命令



**🔧 基础执行命令**
```bash
# 最基本的本地执行

gitlab-runner exec docker job-name

# 查看所有可用的job

gitlab-runner exec docker --list
```

**📋 常用参数说明**

| **参数** | **作用** | **示例** |
|---------|---------|---------|
| `--docker-image` | 指定Docker镜像 | `--docker-image=node:16` |
| `--env` | 设置环境变量 | `--env NODE_ENV=production` |
| `--docker-volumes` | 挂载目录 | `--docker-volumes=/tmp:/tmp` |

### 3.3 实际操作示例



**🎪 场景演示：测试Node.js应用**

假设你有这样的 `.gitlab-ci.yml`：
```yaml
stages:
  - test
  - build

test:
  stage: test
  image: node:16
  script:
    - npm install
    - npm test

build:
  stage: build  
  image: node:16
  script:
    - npm run build
```

**本地测试方法：**
```bash
# 测试test阶段

gitlab-runner exec docker test

# 测试build阶段

gitlab-runner exec docker build
```

### 3.4 本地执行的限制



**⚠️ 需要注意的限制**
- **不支持多阶段**：只能单独测试每个job，不能测试整个Pipeline
- **变量限制**：一些GitLab内置变量在本地不可用
- **服务限制**：`services` 配置在本地执行时可能不工作

**💡 解决方案**
```bash
# 手动设置缺失的变量

gitlab-runner exec docker \
  --env CI_COMMIT_SHA=abc123 \
  --env CI_PROJECT_NAME=my-project \
  test-job
```

---

## 4. ✅ 配置文件语法检查



### 4.1 YAML语法基础检查



**🔸 常见YAML语法错误**

**缩进错误** (最常见)
```yaml
# ❌ 错误：缩进不一致

stages:
  - test
 - build  # 这里少了一个空格

# ✅ 正确：缩进一致

stages:
  - test
  - build
```

**引号问题**
```yaml
# ❌ 错误：特殊字符没有引号

script:
  - echo Hello: World

# ✅ 正确：包含冒号的字符串要用引号

script:
  - echo "Hello: World"
```

### 4.2 GitLab CI配置验证工具



**🛠️ 在线验证工具**
1. **GitLab内置验证器**
   - 进入项目 → CI/CD → Pipelines
   - 点击 "CI Lint" 检查语法

2. **本地命令行验证**
```bash
# 使用gitlab-runner验证

gitlab-runner verify

# 检查配置文件语法

yamllint .gitlab-ci.yml
```

### 4.3 配置文件调试技巧



**🔍 分段验证方法**

**第一步：最小化配置**
```yaml
# 先写一个最简单的配置

hello:
  script:
    - echo "Hello World"
```

**第二步：逐步添加复杂度**
```yaml
hello:
  image: ubuntu:20.04
  script:
    - echo "Hello World"
    - pwd
    - ls -la
```

**第三步：添加真实业务逻辑**
```yaml
test:
  image: ubuntu:20.04
  before_script:
    - apt-get update
    - apt-get install -y curl
  script:
    - curl --version
    - echo "环境准备完成"
```

### 4.4 常见配置错误及修复



**📋 错误修复对照表**

| **错误类型** | **错误示例** | **修复方法** |
|-------------|-------------|-------------|
| **缩进错误** | `stages:- test` | 添加正确的空格缩进 |
| **引用错误** | `extends: .template` | 确保模板存在 |
| **变量错误** | `$UNDEFINED_VAR` | 检查变量定义 |

**💡 调试小贴士**
> **复制粘贴陷阱**：从网上复制YAML时，注意缩进可能变成了Tab，要转换成空格
> **编辑器帮助**：使用支持YAML语法高亮的编辑器，比如VS Code

---

## 5. 🔍 变量值调试输出



### 5.1 为什么要调试变量



**🤔 变量调试的重要性**
CI/CD中的变量就像做菜时的调料，用错了整道菜就毁了。常见问题：
- 变量没有定义
- 变量值不是期望的
- 变量在不同环境下值不同

**💭 生活类比**
就像烹饪时需要确认盐是不是糖，CI/CD也需要确认变量值是否正确。

### 5.2 基本变量输出方法



**🔧 简单输出技巧**
```yaml
debug-variables:
  script:
    - echo "项目名称：$CI_PROJECT_NAME"
    - echo "分支名称：$CI_COMMIT_REF_NAME"
    - echo "提交ID：$CI_COMMIT_SHA"
    - echo "当前目录：$(pwd)"
```

**📊 格式化输出**
```yaml
debug-env:
  script:
    - echo "===== 环境信息 ====="
    - echo "操作系统：$(uname -a)"
    - echo "当前用户：$(whoami)"
    - echo "===== GitLab变量 ====="
    - echo "项目：$CI_PROJECT_NAME"
    - echo "分支：$CI_COMMIT_REF_NAME"
```

### 5.3 高级变量调试技巧



**🎯 批量输出环境变量**
```yaml
show-all-env:
  script:
#    # 显示所有以CI_开头的变量
    - env | grep ^CI_ | sort
#    # 显示所有环境变量（谨慎使用，可能包含敏感信息）
    - env | sort
```

**🔒 安全的变量调试**
```yaml
debug-safe:
  script:
#    # 只显示变量名，不显示值
    - env | grep ^CI_ | cut -d'=' -f1
#    # 显示变量长度而不是具体值
    - echo "密码长度：${#SECRET_PASSWORD}"
```

### 5.4 自定义变量调试



**📝 变量定义与调试**
```yaml
variables:
  CUSTOM_VAR: "hello world"
  BUILD_ENV: "production"

test-custom-vars:
  script:
    - echo "自定义变量：$CUSTOM_VAR"
    - echo "构建环境：$BUILD_ENV"
#    # 检查变量是否为空
    - |
      if [ -z "$CUSTOM_VAR" ]; then
        echo "错误：CUSTOM_VAR 未定义"
        exit 1
      else
        echo "变量检查通过"
      fi
```

**⚠️ 安全提醒**
> **敏感信息保护**：不要在日志中输出密码、Token等敏感信息
> **使用Masked Variables**：在GitLab中设置敏感变量时启用"Masked"选项

---

## 6. 🔗 Runner连接问题排查



### 6.1 Runner连接问题的常见症状



**🚨 问题表现**
- Pipeline一直显示"Pending"状态
- 错误信息："No runner available"
- Runner状态显示离线

**💭 形象比喻**
Runner就像外卖小哥，如果小哥收不到订单或者找不到地址，外卖就送不到。

### 6.2 检查Runner注册状态



**🔍 基础检查步骤**

**第一步：查看Runner列表**
在GitLab项目中：
- 进入 Settings → CI/CD
- 展开 "Runners" 部分
- 查看Available runners和Specific runners

**第二步：检查Runner状态**
```bash
# 在Runner服务器上执行

gitlab-runner list

# 查看Runner详细状态

gitlab-runner status
```

**第三步：查看Runner配置**
```bash
# 查看配置文件

cat /etc/gitlab-runner/config.toml
```

### 6.3 Runner连接问题诊断



**🔧 网络连接测试**
```bash
# 测试到GitLab服务器的连接

ping gitlab.example.com

# 测试HTTPS连接

curl -I https://gitlab.example.com

# 测试Runner API连接

curl -H "Authorization: Bearer YOUR_TOKEN" \
  https://gitlab.example.com/api/v4/runners
```

**📋 常见连接问题及解决方案**

| **问题** | **可能原因** | **解决方法** |
|---------|-------------|-------------|
| **无法注册** | Token错误 | 检查Registration Token |
| **连接超时** | 网络问题 | 检查防火墙设置 |
| **SSL错误** | 证书问题 | 配置证书或使用HTTP |

### 6.4 Runner配置修复



**🛠️ 重新注册Runner**
```bash
# 取消注册现有Runner

gitlab-runner unregister --name "my-runner"

# 重新注册

gitlab-runner register \
  --url "https://gitlab.example.com" \
  --registration-token "YOUR_TOKEN" \
  --name "my-runner" \
  --executor "docker"
```

**⚙️ 修改Runner配置**
```toml
# /etc/gitlab-runner/config.toml

[[runners]]
  name = "my-runner"
  url = "https://gitlab.example.com"
  token = "runner-token"
  executor = "docker"
  [runners.docker]
    image = "ubuntu:20.04"
#    # 增加网络超时时间
    network_mode = "host"
```

---

## 7. 🔐 权限问题诊断



### 7.1 权限问题的表现



**🚨 常见权限错误**
- "Permission denied" 
- "Access forbidden"
- "Authentication failed"
- "Unable to clone repository"

**💡 权限问题的本质**
就像你要进入一个需要门禁卡的大楼：
- **没有卡**：完全进不去 (没有权限)
- **卡过期**：之前能进现在不能 (权限过期)
- **卡权限不够**：能进大楼但进不了某些房间 (权限不足)

### 7.2 GitLab权限体系



**👥 用户权限级别**

| **角色** | **权限** | **能做什么** |
|---------|---------|-------------|
| **Guest** | 查看 | 只能查看项目，不能操作 |
| **Reporter** | 读取 | 能下载代码，看Pipeline |
| **Developer** | 开发 | 能推送代码，运行Pipeline |
| **Maintainer** | 维护 | 能管理分支，配置CI/CD |

### 7.3 仓库权限诊断



**🔍 检查代码访问权限**
```yaml
test-git-access:
  script:
#    # 测试是否能克隆仓库
    - git clone $CI_REPOSITORY_URL test-clone
    - cd test-clone
    - git log --oneline -5
```

**📦 检查Registry权限**
```yaml
test-registry-access:
  script:
#    # 测试Docker Registry登录
    - docker login $CI_REGISTRY -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD
    - echo "Registry登录成功"
```

### 7.4 权限问题解决方案



**🔧 常见修复方法**

**SSH密钥问题**
```bash
# 检查SSH密钥

ssh -T git@gitlab.example.com

# 生成新的SSH密钥

ssh-keygen -t rsa -b 4096 -C "your.email@example.com"
```

**Token权限问题**
```yaml
variables:
#  # 确保使用正确作用域的Token
  GITLAB_TOKEN: $CI_JOB_TOKEN  # 内置Token
#  # 或使用个人访问Token
  PERSONAL_TOKEN: $MY_ACCESS_TOKEN
```

**💡 权限调试技巧**
> **最小权限原则**：先给最小权限，确认能工作后再逐步增加
> **权限继承**：检查项目是否从群组继承了权限设置

---

## 8. 🌐 网络连接故障处理



### 8.1 网络问题的识别



**🔍 网络故障的典型症状**
- 下载依赖包失败
- 连接外部服务超时
- Docker镜像拉取失败
- API调用失败

**📊 网络问题分类**

| **问题类型** | **表现** | **影响** |
|-------------|---------|---------|
| **DNS解析** | 找不到域名 | 无法连接任何外部服务 |
| **防火墙** | 特定端口不通 | 某些服务无法访问 |
| **代理设置** | 网络配置错误 | 需要代理的环境无法访问外网 |

### 8.2 网络连接诊断方法



**🔧 基础网络测试**
```yaml
network-test:
  script:
#    # 测试DNS解析
    - nslookup google.com
#    # 测试网络连通性
    - ping -c 3 8.8.8.8
#    # 测试HTTP连接
    - curl -I https://www.google.com
#    # 测试特定端口
    - nc -zv github.com 443
```

**📋 依赖下载测试**
```yaml
dependency-test:
  image: node:16
  script:
#    # 测试npm源连接
    - npm config get registry
    - npm ping
#    # 测试下载速度
    - time npm install lodash --dry-run
```

### 8.3 网络配置优化



**🚀 镜像源配置**
```yaml
# 使用国内镜像源加速

setup-mirrors:
  before_script:
#    # 配置npm镜像
    - npm config set registry https://registry.npmmirror.com
#    # 配置pip镜像
    - pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
```

**⚙️ 代理配置**
```yaml
variables:
  HTTP_PROXY: "http://proxy.company.com:8080"
  HTTPS_PROXY: "http://proxy.company.com:8080"
  NO_PROXY: "localhost,127.0.0.1,.company.com"
```

### 8.4 网络故障应对策略



**🛠️ 重试机制**
```yaml
build-with-retry:
  script:
#    # 设置重试逻辑
    - |
      for i in {1..3}; do
        if npm install; then
          echo "依赖安装成功"
          break
        else
          echo "第 $i 次尝试失败，等待重试..."
          sleep 10
        fi
      done
```

**📱 超时设置**
```yaml
test-with-timeout:
  script:
#    # 设置命令超时
    - timeout 300 npm install
    - timeout 60 npm test
```

---

## 9. 🚨 常见错误解决方案



### 9.1 Pipeline启动失败



**❌ 错误：`yaml invalid`**
```
症状：Pipeline根本不启动，显示YAML语法错误
原因：配置文件格式不正确
```

**✅ 解决方案：**
1. 检查缩进是否正确（必须用空格，不能用Tab）
2. 检查冒号后面是否有空格
3. 使用GitLab的CI Lint工具验证

**❌ 错误：`No stages / jobs for this pipeline`**
```
症状：Pipeline创建了但没有任何Job
原因：没有定义stages或jobs
```

**✅ 解决方案：**
```yaml
# 最简单的修复

stages:
  - test

test-job:
  stage: test
  script:
    - echo "Hello World"
```

### 9.2 Job执行失败



**❌ 错误：`command not found`**
```
症状：脚本中的命令找不到
原因：Docker镜像中没有安装相应的工具
```

**✅ 解决方案：**
```yaml
test-job:
  image: ubuntu:20.04
  before_script:
#    # 安装需要的工具
    - apt-get update
    - apt-get install -y curl wget git
  script:
    - curl --version
```

**❌ 错误：`exit code 1`**
```
症状：脚本执行失败，返回非零退出码
原因：命令执行失败或测试不通过
```

**✅ 解决方案：**
```yaml
test-job:
  script:
#    # 添加错误处理
    - set -e  # 遇到错误立即停止
    - npm test || echo "测试失败但继续执行"
#    # 或者允许失败
  allow_failure: true
```

### 9.3 环境相关错误



**❌ 错误：`Permission denied`**
```
症状：无法访问文件或执行命令
原因：权限不足或文件不可执行
```

**✅ 解决方案：**
```yaml
fix-permissions:
  script:
#    # 给脚本添加执行权限
    - chmod +x ./deploy.sh
    - ./deploy.sh
#    # 或者直接用bash执行
    - bash ./deploy.sh
```

### 9.4 依赖和环境问题



**📋 常见解决方案速查表**

| **错误类型** | **快速解决方案** |
|-------------|-----------------|
| `npm install failed` | 清理缓存：`npm ci --cache .npm` |
| `Docker pull timeout` | 使用本地镜像：`image: local-registry/image` |
| `Out of disk space` | 清理缓存：`docker system prune -f` |
| `Connection refused` | 检查服务是否启动：`services: - redis` |

**💡 调试流程建议**
1. **看错误信息**：仔细阅读完整的错误日志
2. **复现问题**：在本地尝试重现相同错误
3. **逐步简化**：去掉不必要的复杂配置
4. **查看文档**：确认语法和配置是否正确
5. **寻求帮助**：在团队或社区寻求建议

---

## 10. 📋 核心要点总结



### 10.1 必须掌握的调试技能



```
🔸 本地调试：能够在本地验证Pipeline配置
🔸 日志分析：能够读懂CI/CD的错误日志信息
🔸 变量调试：知道如何检查和验证变量值
🔸 权限诊断：能够识别和解决权限相关问题
🔸 网络排查：能够诊断和解决网络连接问题
```

### 10.2 关键理解要点



**🔹 调试的本质**
```
系统化思考：
- 问题现象 → 可能原因 → 验证方法 → 解决方案

分层诊断：
- 配置层：YAML语法和逻辑
- 环境层：Docker镜像和系统环境  
- 网络层：连接和访问权限
- 业务层：具体的构建和测试逻辑
```

**🔹 为什么调试很重要**
```
提高效率：快速定位问题，减少试错时间
保证质量：确保CI/CD流水线稳定可靠
积累经验：调试经验帮助预防类似问题
```

### 10.3 实用调试检查清单



**📝 问题排查步骤**
- [ ] 检查YAML语法是否正确
- [ ] 确认Runner是否正常连接
- [ ] 验证权限设置是否足够
- [ ] 测试网络连接是否正常
- [ ] 检查环境变量是否正确
- [ ] 查看完整的错误日志
- [ ] 尝试本地复现问题

**🛠️ 常用调试工具**
- **GitLab CI Lint**：在线语法检查
- **gitlab-runner exec**：本地执行调试
- **docker logs**：查看容器日志
- **curl/ping**：网络连接测试

### 10.4 最佳实践建议



**💡 调试效率技巧**
- **渐进式调试**：从简单配置开始，逐步增加复杂度
- **保存调试代码**：把常用的调试脚本保存起来重复使用
- **文档记录**：把解决过的问题记录下来，方便团队共享

**🎯 预防问题的方法**
- **本地测试**：配置文件提交前先本地验证
- **模板使用**：使用经过验证的CI/CD模板
- **定期检查**：定期检查Runner状态和权限设置

**🔑 核心记忆要点**
> CI/CD调试三步法：看日志 → 找原因 → 改配置
> 本地调试优先：能在本地解决的问题不要在GitLab上试错
> 系统化排查：按照配置、环境、网络、权限的顺序逐层检查

**🚀 进阶学习方向**
- 学习更高级的GitLab CI/CD功能
- 了解Kubernetes环境下的CI/CD调试
- 掌握性能优化和大规模Pipeline管理