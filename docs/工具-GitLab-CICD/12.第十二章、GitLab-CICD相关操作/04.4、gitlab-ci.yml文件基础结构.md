---
title: 4、gitlab-ci.yml文件基础结构
---
## 📚 目录

1. [YAML语法基础要求](#1-YAML语法基础要求)
2. [文件位置与命名规范](#2-文件位置与命名规范)
3. [基本配置文件结构](#3-基本配置文件结构)
4. [全局关键字配置](#4-全局关键字配置)
5. [作业定义基础语法](#5-作业定义基础语法)
6. [缩进与格式要求](#6-缩进与格式要求)
7. [注释编写规范](#7-注释编写规范)
8. [配置文件验证方法](#8-配置文件验证方法)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 📝 YAML语法基础要求


### 1.1 什么是YAML

🎯 **简单理解**：YAML就像一份"配置清单"，用来告诉GitLab该做什么

```
生活中的类比：
做菜食谱：
  材料：
    - 土豆 3个
    - 胡萝卜 2根
  步骤：
    1. 洗菜切块
    2. 下锅炒制

YAML配置：
jobs:
  build:
    - 准备环境
    - 编译代码
  test:
    - 运行测试
```

**🔸 YAML的核心特点**
- **人类友好**：比JSON更容易阅读和编写
- **层次清晰**：用缩进表示层级关系
- **数据类型丰富**：支持字符串、数字、列表、对象
- **注释支持**：可以添加说明文字

### 1.2 YAML基本数据类型

**📊 常用数据类型对照**

| 类型 | **YAML写法** | **说明** | **GitLab CI中的用途** |
|------|-------------|---------|---------------------|
| 🔸 **字符串** | `name: "项目名称"` | `文本内容` | `作业名称、脚本命令` |
| 🔸 **数字** | `timeout: 30` | `数值` | `超时时间、重试次数` |
| 🔸 **布尔值** | `allow_failure: true` | `真假值` | `是否允许失败` |
| 🔸 **列表** | `- 命令1\n- 命令2` | `多个项目` | `脚本命令列表` |
| 🔸 **对象** | `variables:\n  KEY: value` | `键值对` | `环境变量配置` |

### 1.3 YAML语法注意事项

**⚠️ 常见语法陷阱**

```yaml
# ✅ 正确写法
stages:
  - build
  - test
  - deploy

variables:
  DATABASE_URL: "mysql://localhost"
  DEBUG: true

# ❌ 错误写法示例
stages:
- build    # 缺少空格
- test
-deploy    # 缺少空格

variables:
DATABASE_URL: mysql://localhost  # 缩进错误
  DEBUG:true                     # 冒号后缺少空格
```

**💡 语法记忆技巧**
```
记忆口诀：
- 冒号后面跟空格
- 短横线后要空格  
- 缩进对齐很重要
- 引号保护特殊字符
```

---

## 2. 📁 文件位置与命名规范


### 2.1 标准文件位置

🎯 **文件位置就像房子的门牌号，GitLab需要知道在哪里找到配置**

```
项目根目录结构：
my-project/
├── .gitlab-ci.yml     ← GitLab CI配置文件（必须在这里）
├── src/               ← 源代码目录
├── tests/             ← 测试代码目录
├── README.md          ← 项目说明
└── package.json       ← 项目依赖
```

**🔸 为什么必须在根目录**
- GitLab会自动在根目录查找这个文件
- 就像快递员知道在门口找收件人一样
- 位置错了，GitLab就找不到，CI/CD不会运行

### 2.2 文件命名规则

**📋 命名规范详解**

正确命名格式：
- **标准名称**：`.gitlab-ci.yml`
- **必须小写**：不能写成 `.GitLab-CI.yml`
- **前面有点号**：表示这是隐藏文件
- **连字符连接**：不能用下划线 `.gitlab_ci.yml`

**🔧 其他可选名称**
```
GitLab也认识这些名字：
✅ .gitlab-ci.yml      (最推荐)
✅ .gitlab-ci.yaml     (yaml后缀也可以)
✅ gitlab-ci.yml       (没有前面的点也行)

❌ 不认识的名字：
❌ .gitlabci.yml       (缺少连字符)
❌ .gitlab-ci.YML      (大写后缀)
❌ ci.yml              (名字不对)
```

### 2.3 多文件配置策略

**🔀 大项目的文件组织**

当项目很大时，可以把配置分成多个文件：

```
项目结构：
my-project/
├── .gitlab-ci.yml           ← 主配置文件
├── .gitlab/
│   └── ci/
│       ├── build.yml        ← 构建相关配置
│       ├── test.yml         ← 测试相关配置
│       └── deploy.yml       ← 部署相关配置
```

主配置文件引用其他文件：
```yaml
# .gitlab-ci.yml
include:
  - '.gitlab/ci/build.yml'
  - '.gitlab/ci/test.yml'
  - '.gitlab/ci/deploy.yml'
```

---

## 3. 🏗️ 基本配置文件结构


### 3.1 配置文件的整体架构

🎯 **配置文件就像一份工作计划，告诉GitLab按什么顺序做什么事**

```
典型的GitLab CI配置结构：

第一部分：全局设置
- 阶段定义（stages）
- 全局变量（variables）
- 默认设置（default）

第二部分：具体工作
- 构建作业（build job）
- 测试作业（test job）  
- 部署作业（deploy job）

第三部分：特殊配置
- 缓存设置（cache）
- 镜像配置（image）
```

### 3.2 最简单的配置示例

**📝 新手第一个配置文件**

```yaml
# 这是一个最简单的GitLab CI配置
# 只做一件事：输出"Hello World"

hello_world:
  script:
    - echo "Hello, GitLab CI!"
```

**💡 这个配置做了什么**
1. 定义了一个名叫 `hello_world` 的作业
2. 作业执行一条命令：输出文字
3. GitLab看到代码变化后，会自动运行这个作业

### 3.3 标准结构配置示例

**🔧 包含常用功能的完整示例**

```yaml
# 定义CI/CD的执行阶段
stages:
  - build    # 第一阶段：构建
  - test     # 第二阶段：测试  
  - deploy   # 第三阶段：部署

# 全局变量设置
variables:
  PROJECT_NAME: "my-awesome-project"
  NODE_VERSION: "18"

# 构建阶段的作业
build_job:
  stage: build
  script:
    - echo "开始构建项目 $PROJECT_NAME"
    - npm install
    - npm run build

# 测试阶段的作业  
test_job:
  stage: test
  script:
    - echo "开始运行测试"
    - npm run test

# 部署阶段的作业
deploy_job:
  stage: deploy
  script:
    - echo "开始部署应用"
    - npm run deploy
  only:
    - main    # 只在main分支运行部署
```

### 3.4 配置文件的执行逻辑

**🔄 GitLab如何处理配置文件**

```
执行流程：
1. 代码推送到GitLab
2. GitLab发现.gitlab-ci.yml文件
3. 解析配置文件内容
4. 按stages定义的顺序执行
5. 每个stage内的jobs可以并行运行
6. 只有前一个stage成功，才执行下一个stage

时间线示例：
时间点1: build_job 开始执行
时间点2: build_job 执行完成 ✅
时间点3: test_job 开始执行
时间点4: test_job 执行完成 ✅  
时间点5: deploy_job 开始执行
时间点6: deploy_job 执行完成 ✅
```

---

## 4. 🌍 全局关键字配置


### 4.1 stages阶段定义

🎯 **stages就像工厂的流水线，定义了工作的先后顺序**

**🔸 为什么需要阶段**
```
生活中的类比：
做饭流程：
1. 买菜（采购阶段）
2.洗菜切菜（准备阶段）  
3. 炒菜（制作阶段）
4. 装盘（完成阶段）

CI/CD流程：
1. build（构建阶段）
2. test（测试阶段）
3. deploy（部署阶段）
```

**📋 常见阶段配置**
```yaml
# 基础三阶段
stages:
  - build
  - test  
  - deploy

# 详细五阶段
stages:
  - prepare    # 准备阶段
  - build      # 构建阶段
  - test       # 测试阶段
  - security   # 安全扫描阶段
  - deploy     # 部署阶段

# 带清理的六阶段
stages:
  - .pre       # 前置阶段（GitLab内置）
  - build
  - test
  - deploy
  - cleanup    # 清理阶段
  - .post      # 后置阶段（GitLab内置）
```

### 4.2 variables全局变量

**🔧 全局变量就像项目的"设置面板"**

**基础变量配置：**
```yaml
variables:
  # 项目基本信息
  PROJECT_NAME: "my-project"
  VERSION: "1.0.0"
  
  # 环境配置
  NODE_ENV: "production"
  DATABASE_URL: "mysql://localhost:3306/mydb"
  
  # 构建配置
  BUILD_TIMEOUT: "30m"
  RETRY_COUNT: 2
```

**💡 变量使用方法**
```yaml
variables:
  APP_NAME: "awesome-app"
  
build_job:
  script:
    - echo "正在构建 $APP_NAME"           # Linux/Mac方式
    - echo "正在构建 %APP_NAME%"         # Windows方式  
    - echo "版本号是 ${VERSION:-1.0.0}"  # 带默认值
```

### 4.3 default默认设置

**🎯 default让所有作业都有相同的基础配置**

```yaml
# 为所有作业设置默认值
default:
  image: node:18-alpine    # 默认使用的Docker镜像
  timeout: 1h              # 默认超时时间
  retry: 2                 # 默认重试次数
  
  before_script:           # 每个作业前都执行
    - echo "作业开始执行"
    - npm install
    
  after_script:            # 每个作业后都执行
    - echo "作业执行完成"
    - npm run cleanup

# 具体作业可以覆盖默认设置
special_job:
  image: python:3.9        # 覆盖默认镜像
  timeout: 30m             # 覆盖默认超时
  script:
    - python test.py
```

### 4.4 workflow工作流控制

**🔄 控制整个CI/CD流程何时运行**

```yaml
# 控制CI/CD什么时候运行
workflow:
  rules:
    # 只在这些情况下运行CI/CD
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'   # 合并请求时
    - if: '$CI_COMMIT_BRANCH == "main"'                    # main分支时
    - if: '$CI_COMMIT_TAG'                                 # 有标签时

# 或者简单的分支控制
workflow:
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"'
```

---

## 5. 🛠️ 作业定义基础语法


### 5.1 作业的基本组成

🎯 **每个作业就像一个"任务卡片"，告诉执行者要做什么**

**🔸 作业的必需元素**
```yaml
job_name:                # 作业名称（必需）
  script:                # 要执行的命令（必需）
    - echo "Hello"
    - npm install
```

**🔸 作业的可选元素**
```yaml
complete_job:
  stage: build           # 属于哪个阶段
  image: node:18          # 使用什么环境
  variables:             # 作业专用变量
    NODE_ENV: development
  before_script:         # 主脚本前执行
    - npm install
  script:               # 主要工作脚本
    - npm run build
  after_script:         # 主脚本后执行  
    - npm run cleanup
  only:                 # 什么情况下运行
    - main
  when: on_success      # 何时执行（成功后/失败后/总是）
  allow_failure: false  # 是否允许失败
```

### 5.2 script脚本编写

**📝 script是作业的核心，定义具体要做的事情**

**单行命令：**
```yaml
simple_job:
  script: echo "这是一个简单命令"

# 或者用数组形式
simple_job:
  script:
    - echo "这也是一个简单命令"
```

**多行命令：**
```yaml
complex_job:
  script:
    - echo "开始执行复杂任务"
    - npm install           # 安装依赖
    - npm run test         # 运行测试
    - npm run build        # 构建项目
    - echo "任务执行完成"
```

**💡 脚本编写技巧**
```yaml
# 1. 添加调试信息
debug_job:
  script:
    - echo "当前目录: $(pwd)"
    - echo "文件列表: $(ls -la)"
    - echo "环境变量: $NODE_ENV"

# 2. 错误处理
robust_job:
  script:
    - set -e                    # 遇到错误立即停止
    - npm install || exit 1     # 安装失败就退出
    - npm test || echo "测试失败但继续"

# 3. 条件执行
conditional_job:
  script:
    - |
      if [ "$CI_COMMIT_BRANCH" == "main" ]; then
        echo "这是主分支，执行特殊操作"
        npm run deploy
      else
        echo "这是其他分支，只执行测试"
        npm test
      fi
```

### 5.3 作业依赖与顺序

**🔗 控制作业之间的执行关系**

**阶段依赖（自动）：**
```yaml
stages:
  - build
  - test

build_job:
  stage: build      # 先执行
  script:
    - npm run build

test_job:
  stage: test       # 后执行（自动等待build阶段完成）
  script:
    - npm test
```

**手动依赖控制：**
```yaml
# 使用needs关键字
integration_test:
  stage: test
  needs: ["build_job"]    # 明确指定依赖哪个作业
  script:
    - npm run integration-test

deploy_job:
  stage: deploy
  needs: 
    - build_job           # 需要构建完成
    - test_job           # 需要测试通过
  script:
    - npm run deploy
```

---

## 6. 📏 缩进与格式要求


### 6.1 缩进规则详解

🎯 **YAML的缩进就像写作文的段落，层次要清晰**

**🔸 缩进基本规则**
- **只能用空格**，不能用Tab键
- **同级元素**缩进必须相同
- **子级元素**比父级多缩进2个空格（推荐）

**正确缩进示例：**
```yaml
# 层级1：顶级配置
stages:
  - build        # 层级2：比stages多2个空格
  - test
  - deploy

variables:
  NODE_ENV: production    # 层级2：变量定义

build_job:
  stage: build           # 层级2：作业属性
  variables:
    BUILD_ENV: development    # 层级3：作业内变量
  script:
    - echo "开始构建"          # 层级3：脚本命令
    - npm install
```

**❌ 常见缩进错误**
```yaml
# 错误1：缩进不一致
stages:
  - build
   - test      # 比build多了一个空格，错误！

# 错误2：使用Tab键
variables:
	NODE_ENV: production    # 用了Tab键，错误！

# 错误3：缺少缩进
build_job:
stage: build              # 应该缩进2个空格，错误！
```

### 6.2 格式化最佳实践

**✨ 让配置文件更易读的格式技巧**

**空行使用：**
```yaml
# 用空行分隔不同部分
stages:
  - build
  - test
  - deploy

variables:
  NODE_ENV: production
  DEBUG: false

# 构建相关作业
build_job:
  stage: build
  script:
    - npm run build

# 测试相关作业  
test_job:
  stage: test
  script:
    - npm test
```

**对齐美化：**
```yaml
# 冒号对齐，方便阅读
variables:
  PROJECT_NAME:    "my-project"
  NODE_VERSION:    "18"
  DATABASE_URL:    "mysql://localhost"
  DEBUG_ENABLED:   true
  RETRY_COUNT:     2
```

### 6.3 编辑器配置建议

**🔧 IDE设置让YAML编写更轻松**

**VS Code配置：**
```json
{
  "editor.insertSpaces": true,
  "editor.tabSize": 2,
  "editor.detectIndentation": false,
  "yaml.schemas": {
    "https://gitlab.com/gitlab-org/gitlab/-/raw/master/app/assets/javascripts/editor/schema/ci.json": ".gitlab-ci.yml"
  }
}
```

**推荐VS Code插件：**
- **GitLab Workflow**：GitLab官方插件
- **YAML**：YAML语法支持
- **Prettier**：代码格式化

---

## 7. 💬 注释编写规范


### 7.1 注释的作用与重要性

🎯 **注释就像代码的"说明书"，帮助团队理解配置的目的**

**🔸 为什么要写注释**
```
团队协作：新同事能快速理解配置
维护更新：几个月后还能记得为什么这样配置
问题排查：出问题时能快速定位原因
知识传承：配置背后的业务逻辑得以保留
```

### 7.2 注释语法与位置

**📝 YAML注释的正确写法**

**基本注释语法：**
```yaml
# 这是一行注释
stages:
  - build    # 行尾注释
  - test
  - deploy

# 多行注释可以这样写
# 第一行说明
# 第二行说明
variables:
  NODE_ENV: production
```

**注释位置建议：**
```yaml
# ===========================================
# GitLab CI/CD 配置文件
# 项目：我的Web应用
# 维护人：开发团队
# 最后更新：2024-01-15
# ===========================================

# 定义CI/CD执行阶段
stages:
  - build      # 构建阶段：编译代码，生成产物
  - test       # 测试阶段：运行单元测试和集成测试
  - deploy     # 部署阶段：发布到生产环境

# 全局环境变量
variables:
  NODE_VERSION: "18"          # Node.js版本
  DATABASE_URL: $DB_URL       # 数据库连接（来自CI/CD变量）
```

### 7.3 注释内容规范

**📋 写什么样的注释最有用**

**✅ 好的注释示例：**
```yaml
# 构建作业 - 编译TypeScript并打包静态资源
build_job:
  stage: build
  image: node:18-alpine    # 使用轻量级Alpine镜像减少构建时间
  cache:
    paths:
      - node_modules/    # 缓存依赖减少安装时间
  script:
    - npm ci             # 使用ci命令确保依赖版本一致
    - npm run build      # 执行构建脚本
  artifacts:
    paths:
      - dist/            # 保存构建产物供后续阶段使用
    expire_in: 1 hour    # 1小时后自动清理，节省存储空间

# 部署作业 - 仅在main分支执行
deploy_job:
  stage: deploy
  script:
    - echo "部署到生产环境"
  only:
    - main               # 安全考虑：只有主分支才能部署到生产环境
  when: manual           # 手动触发：避免意外部署
```

**❌ 不好的注释示例：**
```yaml
# 这是build作业          # 废话，看名字就知道
build_job:
  script:
    - npm install        # 安装npm包（说了等于没说）
```

### 7.4 文档化注释

**📚 配置文件的自我说明**

```yaml
# ===========================================
# 项目CI/CD配置说明
# ===========================================
# 
# 本配置文件定义了以下CI/CD流程：
# 1. 代码推送触发自动构建
# 2. 构建成功后运行自动化测试
# 3. 测试通过后可手动部署到生产环境
#
# 环境要求：
# - Node.js 18+
# - npm 8+
# - Docker支持
#
# CI/CD变量设置（在GitLab项目设置中配置）：
# - DATABASE_URL: 数据库连接字符串
# - API_KEY: 第三方服务API密钥
# - DEPLOY_TOKEN: 部署访问令牌
#
# 维护说明：
# - 修改此文件前请先在feature分支测试
# - 重大变更需要团队review
# - 部署相关配置修改需要运维团队确认
# ===========================================

stages:
  - build
  - test  
  - deploy
```

---

## 8. ✅ 配置文件验证方法


### 8.1 GitLab内置验证工具

🎯 **GitLab提供了多种方式检查配置文件是否正确**

**🔸 CI Lint工具**
```
使用方法：
1. 打开GitLab项目页面
2. 进入 CI/CD → Pipelines
3. 点击 "CI Lint" 按钮
4. 粘贴配置文件内容
5. 点击 "Validate" 验证

功能：
- 检查YAML语法错误
- 验证GitLab CI关键字
- 显示详细错误信息
- 模拟配置解析过程
```

**🔸 Pipeline编辑器**
```
位置：项目页面 → CI/CD → Editor

优势：
- 实时语法检查
- 自动补全功能
- 错误高亮显示
- 直接提交修改
```

### 8.2 本地验证方法

**💻 在本地检查配置文件**

**使用yamllint工具：**
```bash
# 安装yamllint
pip install yamllint

# 检查YAML语法
yamllint .gitlab-ci.yml

# 自定义检查规则
yamllint -d "{extends: default, rules: {line-length: {max: 120}}}" .gitlab-ci.yml
```

**使用GitLab CLI：**
```bash
# 安装GitLab CLI
npm install -g @gitbeaker/cli

# 验证配置文件
gitlab-ci-lint .gitlab-ci.yml

# 或者用curl直接调用API
curl --header "Content-Type: application/json" \
     --data '{"content": "'"$(cat .gitlab-ci.yml | sed 's/"/\\"/g' | tr '\n' ' ')"'"}' \
     "https://gitlab.com/api/v4/ci/lint"
```

### 8.3 常见错误诊断

**🔍 配置文件错误的快速定位**

**语法错误类型：**

错误类型1 - 缩进问题：
```yaml
# ❌ 错误示例
stages:
  - build
 - test        # 缩进不一致

# ✅ 正确示例  
stages:
  - build
  - test        # 缩进对齐
```

错误类型2 - 冒号空格：
```yaml
# ❌ 错误示例
variables:
  NODE_ENV:production    # 冒号后缺少空格

# ✅ 正确示例
variables:
  NODE_ENV: production   # 冒号后有空格
```

错误类型3 - 关键字拼写：
```yaml
# ❌ 错误示例
build_job:
  scripts:               # 应该是script不是scripts
    - npm run build

# ✅ 正确示例
build_job:
  script:                # 正确的关键字
    - npm run build
```

### 8.4 验证自动化

**⚒️ 让验证成为开发流程的一部分**

**Git pre-commit钩子：**
```bash
#!/bin/bash
# .git/hooks/pre-commit

# 检查.gitlab-ci.yml文件
if [ -f ".gitlab-ci.yml" ]; then
    echo "检查GitLab CI配置文件..."
    
    # 使用yamllint检查语法
    if ! yamllint .gitlab-ci.yml; then
        echo "❌ GitLab CI配置文件语法错误"
        exit 1
    fi
    
    echo "✅ GitLab CI配置文件检查通过"
fi
```

**VS Code配置：**
```json
{
  "yaml.validate": true,
  "yaml.schemas": {
    "https://gitlab.com/gitlab-org/gitlab/-/raw/master/app/assets/javascripts/editor/schema/ci.json": ".gitlab-ci.yml"
  },
  "files.associations": {
    ".gitlab-ci.yml": "yaml"
  }
}
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的核心概念


```
🔸 YAML语法：缩进对齐、冒号空格、数据类型使用
🔸 文件位置：根目录下的.gitlab-ci.yml文件
🔸 基本结构：stages定义阶段，jobs定义具体工作
🔸 全局配置：variables、default、workflow控制整体行为
🔸 作业定义：script是核心，stage决定执行顺序
🔸 格式规范：2空格缩进、空行分隔、注释说明
🔸 验证方法：GitLab内置工具、本地检查、自动化验证
```

### 9.2 关键理解要点


**🔹 YAML语法的核心要点**
```
记忆技巧：
- 缩进像楼梯，每层2个空格
- 冒号像标点，后面跟空格
- 短横线像列表，前面要对齐
- 引号像保护，特殊字符要用

实际意义：
- 语法正确是CI/CD运行的前提
- 格式整齐提高团队协作效率
- 注释充分帮助后期维护
```

**🔹 配置文件结构的设计思路**
```
分层设计：
全局配置 → 定义整体行为
阶段定义 → 确定执行顺序  
作业配置 → 具体执行内容

执行逻辑：
顺序执行 → stages按序运行
并行优化 → 同stage内jobs可并行
依赖控制 → needs关键字精确控制
```

**🔹 作业定义的最佳实践**
```
命名规范：
- 作业名称要见名知意
- 使用下划线连接单词
- 避免特殊字符和空格

脚本编写：
- 一个作业专注一个目标
- 添加必要的调试信息
- 考虑错误处理和重试
- 使用环境变量提高灵活性
```

### 9.3 实际应用价值


**🎯 新手学习路径**
```
第一步：掌握YAML基础语法
- 练习缩进和格式
- 理解数据类型
- 学会使用验证工具

第二步：理解GitLab CI概念
- stages和jobs的关系
- 执行顺序和依赖
- 变量的使用方法

第三步：编写简单配置
- 从hello world开始
- 逐步添加复杂功能
- 在测试环境验证效果

第四步：优化和维护
- 添加详细注释
- 使用最佳实践
- 建立验证流程
```

**🔧 团队协作建议**
- **代码审查**：配置文件修改也需要团队review
- **文档维护**：及时更新配置说明和注释
- **培训分享**：团队内部分享CI/CD最佳实践
- **模板复用**：建立项目配置模板库

**📈 持续改进方向**
- **自动化验证**：集成到开发工具和流程中
- **监控告警**：关注CI/CD执行效果和问题
- **性能优化**：优化构建时间和资源使用
- **安全加固**：保护敏感信息和部署流程

**核心记忆要点**：
- YAML语法是基础，格式正确是前提
- 配置结构要清晰，stages和jobs要理解
- 注释文档很重要，团队协作少不了
- 验证工具要善用，问题发现在本地