---
title: 13ã€éƒ¨ç½²è„šæœ¬ç¼–å†™
---
## ğŸ“š ç›®å½•

1. [éƒ¨ç½²è„šæœ¬åŸºç¡€æ¦‚å¿µ](#1-éƒ¨ç½²è„šæœ¬åŸºç¡€æ¦‚å¿µ)
2. [éƒ¨ç½²å‘½ä»¤è„šæœ¬ç¼–å†™](#2-éƒ¨ç½²å‘½ä»¤è„šæœ¬ç¼–å†™)
3. [æœåŠ¡å™¨è¿æ¥é…ç½®](#3-æœåŠ¡å™¨è¿æ¥é…ç½®)
4. [æ–‡ä»¶ä¼ è¾“æ–¹æ³•](#4-æ–‡ä»¶ä¼ è¾“æ–¹æ³•)
5. [æœåŠ¡é‡å¯å‘½ä»¤](#5-æœåŠ¡é‡å¯å‘½ä»¤)
6. [éƒ¨ç½²å‰åæ£€æŸ¥](#6-éƒ¨ç½²å‰åæ£€æŸ¥)
7. [å›æ»šè„šæœ¬å‡†å¤‡](#7-å›æ»šè„šæœ¬å‡†å¤‡)
8. [éƒ¨ç½²æ—¥å¿—è®°å½•](#8-éƒ¨ç½²æ—¥å¿—è®°å½•)
9. [éƒ¨ç½²çŠ¶æ€éªŒè¯](#9-éƒ¨ç½²çŠ¶æ€éªŒè¯)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸš€ éƒ¨ç½²è„šæœ¬åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯éƒ¨ç½²è„šæœ¬


**ğŸ“ ç®€å•ç†è§£**
éƒ¨ç½²è„šæœ¬å°±åƒæ˜¯ä½ ç»™æœåŠ¡å™¨å†™çš„ä¸€ä»½"ä½¿ç”¨è¯´æ˜ä¹¦"ï¼Œå‘Šè¯‰å®ƒæ€ä¹ˆæŠŠä½ çš„ä»£ç å˜æˆçœŸæ­£è¿è¡Œçš„ç½‘ç«™æˆ–åº”ç”¨ã€‚

```
ç”Ÿæ´»ç±»æ¯”ï¼š
å°±åƒä½ æ¬å®¶æ—¶çš„æ¸…å•ï¼š
1. æ‰“åŒ…ç‰©å“ â†’ æ„å»ºä»£ç 
2.è¿è¾“åˆ°æ–°å®¶ â†’ ä¼ è¾“æ–‡ä»¶
3.æ•´ç†æ‘†æ”¾ â†’ éƒ¨ç½²é…ç½®
4. æ£€æŸ¥æ°´ç”µ â†’ æœåŠ¡éªŒè¯

éƒ¨ç½²è„šæœ¬å°±æ˜¯è¿™ä¸ª"æ¬å®¶æ¸…å•"çš„è‡ªåŠ¨åŒ–ç‰ˆæœ¬
```

**ğŸ¯ æ ¸å¿ƒä½œç”¨**
- **è‡ªåŠ¨åŒ–æ“ä½œ**ï¼šä»£æ›¿æ‰‹åŠ¨ä¸€æ­¥æ­¥æ“ä½œ
- **å‡å°‘é”™è¯¯**ï¼šé¿å…äººä¸ºå¤±è¯¯
- **æé«˜æ•ˆç‡**ï¼šä¸€é”®å®Œæˆéƒ¨ç½²
- **ä¿è¯ä¸€è‡´æ€§**ï¼šæ¯æ¬¡éƒ¨ç½²éƒ½æŒ‰åŒæ ·æµç¨‹

### 1.2 éƒ¨ç½²è„šæœ¬çš„ç»„æˆéƒ¨åˆ†


```
å®Œæ•´éƒ¨ç½²æµç¨‹ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä»£ç ä»“åº“   â”‚â”€â”€â”€â–¶â”‚  GitLab CI  â”‚â”€â”€â”€â–¶â”‚  ç›®æ ‡æœåŠ¡å™¨  â”‚
â”‚             â”‚    â”‚             â”‚    â”‚             â”‚
â”‚ æºä»£ç       â”‚    â”‚ æ„å»º+æµ‹è¯•   â”‚    â”‚ è¿è¡Œåº”ç”¨    â”‚
â”‚ é…ç½®æ–‡ä»¶    â”‚    â”‚ æ‰“åŒ…éƒ¨ç½²    â”‚    â”‚ æä¾›æœåŠ¡    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”§ ä¸»è¦ç»„ä»¶**
- **è¿æ¥é…ç½®**ï¼šæ€ä¹ˆè¿åˆ°æœåŠ¡å™¨
- **æ–‡ä»¶ä¼ è¾“**ï¼šæ€ä¹ˆæŠŠä»£ç ä¼ è¿‡å»
- **ç¯å¢ƒå‡†å¤‡**ï¼šå®‰è£…ä¾èµ–ã€é…ç½®ç¯å¢ƒ
- **æœåŠ¡ç®¡ç†**ï¼šå¯åŠ¨ã€åœæ­¢ã€é‡å¯åº”ç”¨
- **éªŒè¯æ£€æŸ¥**ï¼šç¡®ä¿éƒ¨ç½²æˆåŠŸ

### 1.3 éƒ¨ç½²æ–¹å¼å¯¹æ¯”


| éƒ¨ç½²æ–¹å¼ | **è¯´æ˜** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** | **é€‚ç”¨åœºæ™¯** |
|---------|---------|---------|---------|-------------|
| ğŸ”§ **æ‰‹åŠ¨éƒ¨ç½²** | `äººå·¥æ“ä½œæœåŠ¡å™¨` | `çµæ´»å¯æ§` | `è€—æ—¶æ˜“é”™` | `å°é¡¹ç›®æµ‹è¯•` |
| ğŸ¤– **è„šæœ¬éƒ¨ç½²** | `è‡ªåŠ¨åŒ–è„šæœ¬æ‰§è¡Œ` | `å¿«é€Ÿä¸€è‡´` | `éœ€è¦ç¼–å†™` | `ä¸­å°é¡¹ç›®` |
| ğŸ³ **å®¹å™¨éƒ¨ç½²** | `Dockerå®¹å™¨åŒ–` | `ç¯å¢ƒç»Ÿä¸€` | `å­¦ä¹ æˆæœ¬` | `å¾®æœåŠ¡æ¶æ„` |
| â˜ï¸ **äº‘åŸç”Ÿéƒ¨ç½²** | `K8sç­‰å¹³å°` | `é«˜å¯ç”¨å¼¹æ€§` | `å¤æ‚åº¦é«˜` | `å¤§å‹ç³»ç»Ÿ` |

---

## 2. ğŸ“ éƒ¨ç½²å‘½ä»¤è„šæœ¬ç¼–å†™


### 2.1 åŸºç¡€Shellè„šæœ¬ç»“æ„


**ğŸ”¸ è„šæœ¬æ¨¡æ¿**
```bash
#!/bin/bash
# éƒ¨ç½²è„šæœ¬åŸºç¡€æ¨¡æ¿

# 1. è®¾ç½®é”™è¯¯å¤„ç†
set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
set -u  # ä½¿ç”¨æœªå®šä¹‰å˜é‡æ—¶æŠ¥é”™

# 2. å®šä¹‰å˜é‡
PROJECT_NAME="my-web-app"
DEPLOY_DIR="/var/www/${PROJECT_NAME}"
BACKUP_DIR="/var/backups/${PROJECT_NAME}"
LOG_FILE="/var/log/deploy.log"

# 3. è®°å½•æ—¥å¿—å‡½æ•°
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a $LOG_FILE
}

# 4. ä¸»è¦éƒ¨ç½²é€»è¾‘
main() {
    log "å¼€å§‹éƒ¨ç½² ${PROJECT_NAME}"
    
    # è¿™é‡Œå†™å…·ä½“çš„éƒ¨ç½²æ­¥éª¤
    
    log "éƒ¨ç½²å®Œæˆ"
}

# 5. æ‰§è¡Œä¸»å‡½æ•°
main "$@"
```

**ğŸ’¡ è„šæœ¬ç¼–å†™è¦ç‚¹**
- **é”™è¯¯å¤„ç†**ï¼š`set -e` ç¡®ä¿å‡ºé”™æ—¶åœæ­¢
- **æ—¥å¿—è®°å½•**ï¼šæ¯ä¸ªé‡è¦æ­¥éª¤éƒ½è¦è®°å½•
- **å˜é‡å®šä¹‰**ï¼šæŠŠå¯å˜çš„ä¿¡æ¯å®šä¹‰ä¸ºå˜é‡
- **å‡½æ•°å°è£…**ï¼šæŠŠå¤æ‚é€»è¾‘å°è£…æˆå‡½æ•°

### 2.2 å¸¸ç”¨éƒ¨ç½²å‘½ä»¤è¯¦è§£


**ğŸ”§ æ–‡ä»¶æ“ä½œå‘½ä»¤**
```bash
# åˆ›å»ºç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
mkdir -p /var/www/myapp

# å¤åˆ¶æ–‡ä»¶å¹¶ä¿ç•™æƒé™
cp -r source/ destination/

# ç§»åŠ¨æ–‡ä»¶ï¼ˆé‡å‘½åï¼‰
mv old_name new_name

# ä¿®æ”¹æ–‡ä»¶æƒé™
chmod 755 script.sh      # å¯æ‰§è¡Œæƒé™
chmod 644 config.txt     # åªè¯»æƒé™

# ä¿®æ”¹æ–‡ä»¶æ‰€æœ‰è€…
chown www-data:www-data /var/www/myapp
```

**ğŸ”„ æœåŠ¡ç®¡ç†å‘½ä»¤**
```bash
# systemdæœåŠ¡ç®¡ç†ï¼ˆç°ä»£Linuxç³»ç»Ÿï¼‰
systemctl start myapp      # å¯åŠ¨æœåŠ¡
systemctl stop myapp       # åœæ­¢æœåŠ¡
systemctl restart myapp    # é‡å¯æœåŠ¡
systemctl status myapp     # æŸ¥çœ‹çŠ¶æ€
systemctl enable myapp     # å¼€æœºè‡ªå¯

# ä¼ ç»ŸæœåŠ¡ç®¡ç†
service nginx restart      # é‡å¯nginx
service mysql status       # æŸ¥çœ‹mysqlçŠ¶æ€
```

### 2.3 å®é™…éƒ¨ç½²è„šæœ¬ç¤ºä¾‹


```bash
#!/bin/bash
# Node.jsåº”ç”¨éƒ¨ç½²è„šæœ¬ç¤ºä¾‹

# é…ç½®å˜é‡
APP_NAME="my-node-app"
APP_DIR="/var/www/${APP_NAME}"
TEMP_DIR="/tmp/${APP_NAME}_deploy"
PORT=3000

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

# æ£€æŸ¥Node.jsç¯å¢ƒ
check_environment() {
    log "æ£€æŸ¥è¿è¡Œç¯å¢ƒ..."
    
    if ! command -v node &> /dev/null; then
        log "é”™è¯¯ï¼šæœªå®‰è£…Node.js"
        exit 1
    fi
    
    if ! command -v npm &> /dev/null; then
        log "é”™è¯¯ï¼šæœªå®‰è£…npm"
        exit 1
    fi
    
    log "ç¯å¢ƒæ£€æŸ¥é€šè¿‡"
}

# å¤‡ä»½å½“å‰ç‰ˆæœ¬
backup_current() {
    log "å¤‡ä»½å½“å‰ç‰ˆæœ¬..."
    
    if [ -d "$APP_DIR" ]; then
        cp -r "$APP_DIR" "/var/backups/${APP_NAME}_$(date +%Y%m%d_%H%M%S)"
        log "å¤‡ä»½å®Œæˆ"
    else
        log "é¦–æ¬¡éƒ¨ç½²ï¼Œæ— éœ€å¤‡ä»½"
    fi
}

# éƒ¨ç½²æ–°ç‰ˆæœ¬
deploy_new_version() {
    log "éƒ¨ç½²æ–°ç‰ˆæœ¬..."
    
    # åˆ›å»ºåº”ç”¨ç›®å½•
    mkdir -p "$APP_DIR"
    
    # è§£å‹æˆ–å¤åˆ¶æ–°ç‰ˆæœ¬æ–‡ä»¶
    cp -r "$TEMP_DIR"/* "$APP_DIR"/
    
    # å®‰è£…ä¾èµ–
    cd "$APP_DIR"
    npm install --production
    
    log "æ–‡ä»¶éƒ¨ç½²å®Œæˆ"
}

# é‡å¯åº”ç”¨æœåŠ¡
restart_service() {
    log "é‡å¯åº”ç”¨æœåŠ¡..."
    
    # åœæ­¢æ—§è¿›ç¨‹
    pkill -f "node.*${APP_NAME}" || true
    
    # å¯åŠ¨æ–°è¿›ç¨‹
    cd "$APP_DIR"
    nohup node app.js > /var/log/${APP_NAME}.log 2>&1 &
    
    log "æœåŠ¡é‡å¯å®Œæˆ"
}

# ä¸»å‡½æ•°
main() {
    log "å¼€å§‹éƒ¨ç½² ${APP_NAME}"
    
    check_environment
    backup_current
    deploy_new_version
    restart_service
    
    log "éƒ¨ç½²å®Œæˆï¼"
}

main "$@"
```

---

## 3. ğŸ” æœåŠ¡å™¨è¿æ¥é…ç½®


### 3.1 SSHè¿æ¥åŸºç¡€


**ğŸ”‘ ä»€ä¹ˆæ˜¯SSH**
SSHå°±åƒæ˜¯ä½ å®¶çš„"é’¥åŒ™"ï¼Œè®©ä½ èƒ½å¤Ÿå®‰å…¨åœ°è¿œç¨‹æ“æ§æœåŠ¡å™¨ï¼Œå°±åƒåœ¨è‡ªå·±ç”µè„‘ä¸Šæ“ä½œä¸€æ ·ã€‚

```
è¿æ¥è¿‡ç¨‹ç±»æ¯”ï¼š
1. æ‹¿å‡ºé’¥åŒ™ â†’ SSHç§é’¥
2. æ’å…¥é—¨é” â†’ è¿æ¥æœåŠ¡å™¨
3. éªŒè¯èº«ä»½ â†’ å…¬é’¥éªŒè¯
4. å¼€é—¨è¿›å…¥ â†’ è·å¾—æ“ä½œæƒé™
```

**ğŸ”§ SSHå¯†é’¥é…ç½®**
```bash
# 1. ç”ŸæˆSSHå¯†é’¥å¯¹
ssh-keygen -t rsa -b 4096 -C "your_email@example.com"

# 2. å¤åˆ¶å…¬é’¥åˆ°æœåŠ¡å™¨
ssh-copy-id user@server_ip

# 3. æµ‹è¯•è¿æ¥
ssh user@server_ip

# 4. é…ç½®å…å¯†ç™»å½•
# ç¼–è¾‘ ~/.ssh/config æ–‡ä»¶
Host myserver
    HostName 192.168.1.100
    User deploy
    IdentityFile ~/.ssh/id_rsa
    Port 22
```

### 3.2 GitLab CIä¸­çš„SSHé…ç½®


**ğŸ“‹ CIå˜é‡é…ç½®**
```yaml
# åœ¨GitLabé¡¹ç›®è®¾ç½® â†’ CI/CD â†’ Variables ä¸­æ·»åŠ ï¼š

# SSHç§é’¥ï¼ˆéœ€è¦base64ç¼–ç ï¼‰
SSH_PRIVATE_KEY: |
  -----BEGIN OPENSSH PRIVATE KEY-----
  ...ç§é’¥å†…å®¹...
  -----END OPENSSH PRIVATE KEY-----

# æœåŠ¡å™¨ä¿¡æ¯
DEPLOY_HOST: "192.168.1.100"
DEPLOY_USER: "deploy"
DEPLOY_PATH: "/var/www/myapp"
```

**ğŸ”§ CIè„šæœ¬ä¸­ä½¿ç”¨SSH**
```yaml
deploy:
  stage: deploy
  image: alpine:latest
  before_script:
    # å®‰è£…SSHå®¢æˆ·ç«¯
    - apk add --no-cache openssh-client
    
    # é…ç½®SSH
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $DEPLOY_HOST >> ~/.ssh/known_hosts
    
  script:
    # è¿œç¨‹æ‰§è¡Œéƒ¨ç½²å‘½ä»¤
    - ssh $DEPLOY_USER@$DEPLOY_HOST "bash /path/to/deploy.sh"
```

### 3.3 å®‰å…¨é…ç½®æœ€ä½³å®è·µ


**ğŸ›¡ï¸ å®‰å…¨è¦ç‚¹**
```bash
# 1. ä¿®æ”¹SSHé»˜è®¤ç«¯å£
# ç¼–è¾‘ /etc/ssh/sshd_config
Port 2222  # æ”¹ä¸ºé22ç«¯å£

# 2. ç¦ç”¨å¯†ç ç™»å½•
PasswordAuthentication no
PubkeyAuthentication yes

# 3. é™åˆ¶ç™»å½•ç”¨æˆ·
AllowUsers deploy

# 4. è®¾ç½®ç™»å½•è¶…æ—¶
ClientAliveInterval 300
ClientAliveCountMax 2
```

**âš ï¸ å¸¸è§å®‰å…¨é—®é¢˜**
- âŒ **ä½¿ç”¨å¼±å¯†ç **ï¼šå®¹æ˜“è¢«æš´åŠ›ç ´è§£
- âŒ **rootç›´æ¥ç™»å½•**ï¼šæƒé™è¿‡å¤§é£é™©é«˜
- âŒ **ä¸æ›´æ¢é»˜è®¤ç«¯å£**ï¼šå®¹æ˜“è¢«æ‰«ææ”»å‡»
- âœ… **ä½¿ç”¨å¯†é’¥è®¤è¯**ï¼šæ›´å®‰å…¨å¯é 
- âœ… **åˆ›å»ºä¸“ç”¨éƒ¨ç½²ç”¨æˆ·**ï¼šæƒé™æœ€å°åŒ–

---

## 4. ğŸ“¦ æ–‡ä»¶ä¼ è¾“æ–¹æ³•


### 4.1 æ–‡ä»¶ä¼ è¾“æ–¹å¼å¯¹æ¯”


| ä¼ è¾“æ–¹å¼ | **è¯´æ˜** | **å®‰å…¨æ€§** | **é€Ÿåº¦** | **é€‚ç”¨åœºæ™¯** |
|---------|---------|-----------|----------|-------------|
| ğŸ” **SCP** | `SSHæ–‡ä»¶å¤åˆ¶` | `â­â­â­â­â­` | `â­â­â­` | `å°æ–‡ä»¶ä¼ è¾“` |
| ğŸ“ **SFTP** | `SSHæ–‡ä»¶ä¼ è¾“åè®®` | `â­â­â­â­â­` | `â­â­â­` | `æ‰¹é‡æ–‡ä»¶æ“ä½œ` |
| ğŸ“‹ **rsync** | `åŒæ­¥å·¥å…·` | `â­â­â­â­` | `â­â­â­â­â­` | `å¤§é‡æ–‡ä»¶åŒæ­¥` |
| ğŸŒ **FTP** | `æ–‡ä»¶ä¼ è¾“åè®®` | `â­â­` | `â­â­â­â­` | `ä¸æ¨èä½¿ç”¨` |

### 4.2 SCPæ–‡ä»¶ä¼ è¾“


**ğŸ”§ åŸºæœ¬ç”¨æ³•**
```bash
# ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨
scp local_file.txt user@server:/remote/path/

# ä¸Šä¼ æ•´ä¸ªç›®å½•
scp -r local_directory/ user@server:/remote/path/

# ä»æœåŠ¡å™¨ä¸‹è½½æ–‡ä»¶
scp user@server:/remote/file.txt ./local_path/

# ä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„ä¸»æœºåˆ«å
scp -r ./build/ myserver:/var/www/app/
```

**ğŸ’¡ SCPå‚æ•°è¯´æ˜**
- `-r`ï¼šé€’å½’å¤åˆ¶ç›®å½•
- `-p`ï¼šä¿ç•™æ–‡ä»¶æ—¶é—´å’Œæƒé™
- `-v`ï¼šæ˜¾ç¤ºè¯¦ç»†è¿‡ç¨‹
- `-C`ï¼šå¯ç”¨å‹ç¼©ä¼ è¾“

### 4.3 rsyncé«˜æ•ˆåŒæ­¥


**ğŸš€ ä¸ºä»€ä¹ˆé€‰æ‹©rsync**
rsyncå°±åƒæ˜¯ä¸€ä¸ª"èªæ˜çš„æ¬è¿å·¥"ï¼Œå®ƒåªæ¬è¿å˜åŒ–çš„éƒ¨åˆ†ï¼Œå¤§å¤§æé«˜æ•ˆç‡ã€‚

```
ä¼ ç»Ÿå¤åˆ¶ vs rsyncï¼š

ä¼ ç»Ÿå¤åˆ¶ï¼š
æ–‡ä»¶A (1MB) â†’ å…¨éƒ¨ä¼ è¾“ 1MB
æ–‡ä»¶B (2MB) â†’ å…¨éƒ¨ä¼ è¾“ 2MB
æ€»è®¡ï¼š3MB

rsyncåŒæ­¥ï¼š
æ–‡ä»¶A (åªæœ‰10KBå˜åŒ–) â†’ ä¼ è¾“ 10KB
æ–‡ä»¶B (æ— å˜åŒ–) â†’ è·³è¿‡
æ€»è®¡ï¼š10KB
```

**ğŸ”§ rsyncå®ç”¨å‘½ä»¤**
```bash
# åŸºæœ¬åŒæ­¥
rsync -avz source/ user@server:/destination/

# å‚æ•°è§£é‡Šï¼š
# -a: å½’æ¡£æ¨¡å¼ï¼ˆä¿ç•™æƒé™ã€æ—¶é—´ç­‰ï¼‰
# -v: æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
# -z: å‹ç¼©ä¼ è¾“

# åˆ é™¤ç›®æ ‡å¤šä½™æ–‡ä»¶
rsync -avz --delete source/ user@server:/destination/

# æ’é™¤ç‰¹å®šæ–‡ä»¶
rsync -avz --exclude='*.log' --exclude='node_modules/' \
      source/ user@server:/destination/

# åªä¼ è¾“æ›´æ–°çš„æ–‡ä»¶
rsync -avz --update source/ user@server:/destination/
```

### 4.4 GitLab CIä¸­çš„æ–‡ä»¶ä¼ è¾“


**ğŸ“‹ ä½¿ç”¨artifactsä¼ è¾“**
```yaml
# Stage 1: æ„å»º
build:
  stage: build
  script:
    - npm install
    - npm run build
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour

# Stage 2: éƒ¨ç½²
deploy:
  stage: deploy
  script:
    # ä½¿ç”¨rsyncä¼ è¾“æ„å»ºäº§ç‰©
    - rsync -avz --delete dist/ $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH/
```

**ğŸ”§ å¤§æ–‡ä»¶ä¼ è¾“ä¼˜åŒ–**
```bash
# åˆ†æ­¥ä¼ è¾“å¤§æ–‡ä»¶
transfer_files() {
    log "å¼€å§‹ä¼ è¾“æ–‡ä»¶..."
    
    # 1. å…ˆä¼ è¾“é…ç½®æ–‡ä»¶
    rsync -avz config/ $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH/config/
    
    # 2. å†ä¼ è¾“åº”ç”¨æ–‡ä»¶
    rsync -avz --exclude='*.log' app/ $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH/app/
    
    # 3. æœ€åä¼ è¾“èµ„æºæ–‡ä»¶
    rsync -avz --compress-level=9 assets/ $DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH/assets/
    
    log "æ–‡ä»¶ä¼ è¾“å®Œæˆ"
}
```

---

## 5. ğŸ”„ æœåŠ¡é‡å¯å‘½ä»¤


### 5.1 æœåŠ¡ç®¡ç†åŸºç¡€


**ğŸ¯ ä»€ä¹ˆæ˜¯æœåŠ¡é‡å¯**
æœåŠ¡é‡å¯å°±åƒæ˜¯ç»™åº”ç”¨"é‡æ–°å¼€æœº"ï¼Œè®©å®ƒåŠ è½½æœ€æ–°çš„ä»£ç å’Œé…ç½®ã€‚

```
æœåŠ¡çŠ¶æ€å˜åŒ–ï¼š
è¿è¡Œä¸­ â†’ åœæ­¢ â†’ å¯åŠ¨ â†’ è¿è¡Œä¸­
  â†‘                        â†“
  â””â”€â”€ é‡å¯è¿‡ç¨‹å®Œæˆ â†â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”§ æœåŠ¡ç®¡ç†æ–¹å¼**
```bash
# ç°ä»£Linuxç³»ç»Ÿï¼ˆsystemdï¼‰
systemctl status myapp      # æŸ¥çœ‹çŠ¶æ€
systemctl start myapp       # å¯åŠ¨
systemctl stop myapp        # åœæ­¢
systemctl restart myapp     # é‡å¯
systemctl reload myapp      # é‡è½½é…ç½®

# ä¼ ç»Ÿç³»ç»Ÿï¼ˆSysV initï¼‰
service myapp status
service myapp start
service myapp stop
service myapp restart
```

### 5.2 ä¸åŒåº”ç”¨çš„é‡å¯æ–¹æ³•


**ğŸŒ WebæœåŠ¡å™¨é‡å¯**
```bash
# Nginxé‡å¯
nginx_restart() {
    log "é‡å¯NginxæœåŠ¡..."
    
    # æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•
    nginx -t
    if [ $? -eq 0 ]; then
        systemctl reload nginx  # å¹³æ»‘é‡å¯
        log "Nginxé‡å¯æˆåŠŸ"
    else
        log "Nginxé…ç½®é”™è¯¯ï¼Œé‡å¯å¤±è´¥"
        exit 1
    fi
}

# Apacheé‡å¯
apache_restart() {
    log "é‡å¯ApacheæœåŠ¡..."
    
    # æ£€æŸ¥é…ç½®
    apache2ctl configtest
    if [ $? -eq 0 ]; then
        systemctl restart apache2
        log "Apacheé‡å¯æˆåŠŸ"
    else
        log "Apacheé…ç½®é”™è¯¯"
        exit 1
    fi
}
```

**ğŸŸ¢ Node.jsåº”ç”¨é‡å¯**
```bash
# ä½¿ç”¨PM2ç®¡ç†Node.jsåº”ç”¨
node_restart() {
    log "é‡å¯Node.jsåº”ç”¨..."
    
    # æ£€æŸ¥PM2æ˜¯å¦å®‰è£…
    if ! command -v pm2 &> /dev/null; then
        log "PM2æœªå®‰è£…ï¼Œä½¿ç”¨ä¼ ç»Ÿæ–¹å¼é‡å¯"
        pkill -f "node.*myapp"
        cd /var/www/myapp
        nohup node app.js > /var/log/myapp.log 2>&1 &
    else
        # ä½¿ç”¨PM2é‡å¯
        pm2 restart myapp
        pm2 save  # ä¿å­˜è¿›ç¨‹åˆ—è¡¨
    fi
    
    log "Node.jsåº”ç”¨é‡å¯å®Œæˆ"
}
```

**â˜• Javaåº”ç”¨é‡å¯**
```bash
# Spring Bootåº”ç”¨é‡å¯
java_restart() {
    log "é‡å¯Javaåº”ç”¨..."
    
    APP_NAME="myapp"
    APP_JAR="/var/www/myapp/app.jar"
    APP_PID="/var/run/myapp.pid"
    
    # åœæ­¢æ—§è¿›ç¨‹
    if [ -f "$APP_PID" ]; then
        kill -9 $(cat $APP_PID)
        rm -f $APP_PID
    fi
    
    # å¯åŠ¨æ–°è¿›ç¨‹
    cd /var/www/myapp
    java -jar $APP_JAR > /var/log/myapp.log 2>&1 &
    echo $! > $APP_PID
    
    log "Javaåº”ç”¨é‡å¯å®Œæˆ"
}
```

### 5.3 å¹³æ»‘é‡å¯ç­–ç•¥


**ğŸ”„ é›¶åœæœºéƒ¨ç½²**
```bash
# è“ç»¿éƒ¨ç½²ç¤ºä¾‹
blue_green_deploy() {
    log "å¼€å§‹è“ç»¿éƒ¨ç½²..."
    
    BLUE_PORT=3001
    GREEN_PORT=3002
    CURRENT_PORT=$(get_current_port)
    
    if [ "$CURRENT_PORT" = "$BLUE_PORT" ]; then
        NEW_PORT=$GREEN_PORT
        OLD_PORT=$BLUE_PORT
    else
        NEW_PORT=$BLUE_PORT
        OLD_PORT=$GREEN_PORT
    fi
    
    log "å½“å‰ç«¯å£: $OLD_PORT, æ–°ç«¯å£: $NEW_PORT"
    
    # åœ¨æ–°ç«¯å£å¯åŠ¨åº”ç”¨
    start_app_on_port $NEW_PORT
    
    # å¥åº·æ£€æŸ¥
    if health_check $NEW_PORT; then
        # åˆ‡æ¢è´Ÿè½½å‡è¡¡å™¨
        switch_load_balancer $NEW_PORT
        
        # åœæ­¢æ—§åº”ç”¨
        stop_app_on_port $OLD_PORT
        
        log "è“ç»¿éƒ¨ç½²æˆåŠŸ"
    else
        log "æ–°ç‰ˆæœ¬å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œå›æ»š"
        stop_app_on_port $NEW_PORT
        exit 1
    fi
}
```

---

## 6. âœ… éƒ¨ç½²å‰åæ£€æŸ¥


### 6.1 éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•


**ğŸ” ç¯å¢ƒæ£€æŸ¥**
```bash
pre_deploy_check() {
    log "å¼€å§‹éƒ¨ç½²å‰æ£€æŸ¥..."
    
    # 1. æ£€æŸ¥ç£ç›˜ç©ºé—´
    check_disk_space() {
        AVAILABLE=$(df /var/www | awk 'NR==2{printf "%.0f", $4/1024}')
        if [ $AVAILABLE -lt 1024 ]; then  # å°äº1GB
            log "è­¦å‘Šï¼šç£ç›˜ç©ºé—´ä¸è¶³ ${AVAILABLE}MB"
            exit 1
        fi
        log "ç£ç›˜ç©ºé—´æ£€æŸ¥é€šè¿‡: ${AVAILABLE}MB"
    }
    
    # 2. æ£€æŸ¥å†…å­˜ä½¿ç”¨
    check_memory() {
        MEMORY=$(free -m | awk 'NR==2{printf "%.0f", $7}')
        if [ $MEMORY -lt 256 ]; then  # å°äº256MB
            log "è­¦å‘Šï¼šå¯ç”¨å†…å­˜ä¸è¶³ ${MEMORY}MB"
            exit 1
        fi
        log "å†…å­˜æ£€æŸ¥é€šè¿‡: ${MEMORY}MB"
    }
    
    # 3. æ£€æŸ¥ç«¯å£å ç”¨
    check_port() {
        PORT=$1
        if lsof -Pi :$PORT -sTCP:LISTEN -t >/dev/null; then
            log "ç«¯å£ $PORT æ­£åœ¨ä½¿ç”¨ä¸­"
        else
            log "ç«¯å£ $PORT å¯ç”¨"
        fi
    }
    
    # 4. æ£€æŸ¥ä¾èµ–æœåŠ¡
    check_services() {
        SERVICES=("nginx" "mysql" "redis")
        for service in "${SERVICES[@]}"; do
            if systemctl is-active --quiet $service; then
                log "æœåŠ¡ $service è¿è¡Œæ­£å¸¸"
            else
                log "è­¦å‘Šï¼šæœåŠ¡ $service æœªè¿è¡Œ"
            fi
        done
    }
    
    check_disk_space
    check_memory
    check_port 3000
    check_services
    
    log "éƒ¨ç½²å‰æ£€æŸ¥å®Œæˆ"
}
```

### 6.2 ä»£ç è´¨é‡æ£€æŸ¥


**ğŸ“‹ ä»£ç æ£€æŸ¥è„šæœ¬**
```bash
code_quality_check() {
    log "å¼€å§‹ä»£ç è´¨é‡æ£€æŸ¥..."
    
    # 1. è¯­æ³•æ£€æŸ¥
    if [ -f "package.json" ]; then
        log "æ£€æŸ¥JavaScriptè¯­æ³•..."
        npm run lint || {
            log "ä»£ç è¯­æ³•æ£€æŸ¥å¤±è´¥"
            exit 1
        }
    fi
    
    # 2. å®‰å…¨æ¼æ´æ£€æŸ¥
    if command -v npm &> /dev/null; then
        log "æ£€æŸ¥ä¾èµ–å®‰å…¨æ¼æ´..."
        npm audit --audit-level moderate || {
            log "å‘ç°å®‰å…¨æ¼æ´ï¼Œè¯·ä¿®å¤åé‡æ–°éƒ¨ç½²"
            exit 1
        }
    fi
    
    # 3. é…ç½®æ–‡ä»¶æ£€æŸ¥
    check_config_files() {
        CONFIG_FILES=("config/database.yml" "config/app.conf")
        for config in "${CONFIG_FILES[@]}"; do
            if [ ! -f "$config" ]; then
                log "é”™è¯¯ï¼šç¼ºå°‘é…ç½®æ–‡ä»¶ $config"
                exit 1
            fi
        done
        log "é…ç½®æ–‡ä»¶æ£€æŸ¥é€šè¿‡"
    }
    
    check_config_files
    log "ä»£ç è´¨é‡æ£€æŸ¥å®Œæˆ"
}
```

### 6.3 éƒ¨ç½²åéªŒè¯


**ğŸ” å¥åº·æ£€æŸ¥å®ç°**
```bash
health_check() {
    local HOST=${1:-localhost}
    local PORT=${2:-3000}
    local TIMEOUT=${3:-30}
    
    log "å¼€å§‹å¥åº·æ£€æŸ¥ ${HOST}:${PORT}"
    
    # 1. ç«¯å£è¿é€šæ€§æ£€æŸ¥
    check_port_connection() {
        for i in $(seq 1 $TIMEOUT); do
            if nc -z $HOST $PORT; then
                log "ç«¯å£è¿æ¥æˆåŠŸ"
                return 0
            fi
            log "ç­‰å¾…æœåŠ¡å¯åŠ¨... ($i/$TIMEOUT)"
            sleep 1
        done
        log "ç«¯å£è¿æ¥è¶…æ—¶"
        return 1
    }
    
    # 2. HTTPå“åº”æ£€æŸ¥
    check_http_response() {
        local URL="http://${HOST}:${PORT}/health"
        
        for i in $(seq 1 10); do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $URL)
            if [ "$HTTP_CODE" = "200" ]; then
                log "HTTPå¥åº·æ£€æŸ¥é€šè¿‡"
                return 0
            fi
            log "HTTPæ£€æŸ¥å¤±è´¥ï¼ŒçŠ¶æ€ç : $HTTP_CODE"
            sleep 2
        done
        return 1
    }
    
    # 3. ä¸šåŠ¡åŠŸèƒ½æ£€æŸ¥
    check_business_logic() {
        # æ£€æŸ¥æ•°æ®åº“è¿æ¥
        if command -v mysql &> /dev/null; then
            mysql -u$DB_USER -p$DB_PASS -h$DB_HOST -e "SELECT 1" > /dev/null 2>&1
            if [ $? -eq 0 ]; then
                log "æ•°æ®åº“è¿æ¥æ­£å¸¸"
            else
                log "æ•°æ®åº“è¿æ¥å¤±è´¥"
                return 1
            fi
        fi
        
        # æ£€æŸ¥å…³é”®API
        API_URL="http://${HOST}:${PORT}/api/status"
        RESPONSE=$(curl -s $API_URL | jq -r '.status' 2>/dev/null)
        if [ "$RESPONSE" = "ok" ]; then
            log "APIçŠ¶æ€æ£€æŸ¥é€šè¿‡"
        else
            log "APIçŠ¶æ€å¼‚å¸¸: $RESPONSE"
            return 1
        fi
    }
    
    if check_port_connection && check_http_response && check_business_logic; then
        log "å¥åº·æ£€æŸ¥å…¨éƒ¨é€šè¿‡"
        return 0
    else
        log "å¥åº·æ£€æŸ¥å¤±è´¥"
        return 1
    fi
}
```

---

## 7. â†©ï¸ å›æ»šè„šæœ¬å‡†å¤‡


### 7.1 å›æ»šæœºåˆ¶è®¾è®¡


**ğŸ”„ ä»€ä¹ˆæ˜¯å›æ»š**
å›æ»šå°±åƒæ˜¯"åæ‚”è¯"ï¼Œå½“æ–°ç‰ˆæœ¬æœ‰é—®é¢˜æ—¶ï¼Œèƒ½å¿«é€Ÿå›åˆ°ä¸Šä¸€ä¸ªæ­£å¸¸ç‰ˆæœ¬ã€‚

```
ç‰ˆæœ¬ç®¡ç†æµç¨‹ï¼š
v1.0 (å½“å‰) â†’ v2.0 (éƒ¨ç½²) â†’ å‘ç°é—®é¢˜ â†’ å›æ»šåˆ° v1.0
  â†‘                                           â†“
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å¿«é€Ÿæ¢å¤æœåŠ¡ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ“‹ å›æ»šç­–ç•¥å¯¹æ¯”**

| å›æ»šæ–¹å¼ | **é€Ÿåº¦** | **æ•°æ®é£é™©** | **å¤æ‚åº¦** | **é€‚ç”¨åœºæ™¯** |
|---------|----------|-------------|-----------|-------------|
| ğŸ”„ **ä»£ç å›æ»š** | `â­â­â­â­â­` | `â­â­â­â­` | `â­â­` | `çº¯ä»£ç é—®é¢˜` |
| ğŸ—„ï¸ **æ•°æ®åº“å›æ»š** | `â­â­` | `â­â­` | `â­â­â­â­` | `ç»“æ„å˜æ›´` |
| ğŸ“¦ **å®¹å™¨å›æ»š** | `â­â­â­â­` | `â­â­â­â­â­` | `â­â­â­` | `å®¹å™¨åŒ–åº”ç”¨` |
| ğŸŒ **æµé‡åˆ‡æ¢** | `â­â­â­â­â­` | `â­â­â­â­â­` | `â­â­â­â­` | `è“ç»¿éƒ¨ç½²` |

### 7.2 è‡ªåŠ¨å¤‡ä»½ç³»ç»Ÿ


**ğŸ’¾ å¤‡ä»½è„šæœ¬å®ç°**
```bash
create_backup() {
    local BACKUP_TYPE=${1:-"full"}
    local TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    local BACKUP_DIR="/var/backups/${APP_NAME}"
    
    log "åˆ›å»ºå¤‡ä»½: $BACKUP_TYPE"
    
    # åˆ›å»ºå¤‡ä»½ç›®å½•
    mkdir -p "$BACKUP_DIR"
    
    case $BACKUP_TYPE in
        "code")
            backup_code $TIMESTAMP
            ;;
        "database")
            backup_database $TIMESTAMP
            ;;
        "config")
            backup_config $TIMESTAMP
            ;;
        "full")
            backup_code $TIMESTAMP
            backup_database $TIMESTAMP
            backup_config $TIMESTAMP
            ;;
    esac
    
    # æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘5ä¸ªï¼‰
    cleanup_old_backups
}

backup_code() {
    local TIMESTAMP=$1
    local CODE_BACKUP="$BACKUP_DIR/code_$TIMESTAMP.tar.gz"
    
    log "å¤‡ä»½ä»£ç æ–‡ä»¶..."
    tar -czf "$CODE_BACKUP" -C /var/www "$APP_NAME"
    
    if [ $? -eq 0 ]; then
        log "ä»£ç å¤‡ä»½å®Œæˆ: $CODE_BACKUP"
        echo "$CODE_BACKUP" > "$BACKUP_DIR/latest_code"
    else
        log "ä»£ç å¤‡ä»½å¤±è´¥"
        exit 1
    fi
}

backup_database() {
    local TIMESTAMP=$1
    local DB_BACKUP="$BACKUP_DIR/database_$TIMESTAMP.sql"
    
    log "å¤‡ä»½æ•°æ®åº“..."
    mysqldump -u$DB_USER -p$DB_PASS $DB_NAME > "$DB_BACKUP"
    
    if [ $? -eq 0 ]; then
        gzip "$DB_BACKUP"
        log "æ•°æ®åº“å¤‡ä»½å®Œæˆ: ${DB_BACKUP}.gz"
        echo "${DB_BACKUP}.gz" > "$BACKUP_DIR/latest_database"
    else
        log "æ•°æ®åº“å¤‡ä»½å¤±è´¥"
        exit 1
    fi
}
```

### 7.3 å¿«é€Ÿå›æ»šè„šæœ¬


**âš¡ ä¸€é”®å›æ»šå®ç°**
```bash
#!/bin/bash
# å¿«é€Ÿå›æ»šè„šæœ¬

BACKUP_DIR="/var/backups/${APP_NAME}"
APP_DIR="/var/www/${APP_NAME}"

rollback() {
    local ROLLBACK_TYPE=${1:-"code"}
    
    log "å¼€å§‹å›æ»šæ“ä½œ: $ROLLBACK_TYPE"
    
    # ç¡®è®¤æ“ä½œ
    echo "âš ï¸  è­¦å‘Šï¼šå³å°†å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬"
    echo "æŒ‰ Enter ç»§ç»­ï¼ŒCtrl+C å–æ¶ˆ"
    read -r
    
    case $ROLLBACK_TYPE in
        "code")
            rollback_code
            ;;
        "database")
            rollback_database
            ;;
        "full")
            rollback_code
            rollback_database
            ;;
    esac
    
    # é‡å¯æœåŠ¡
    restart_services
    
    # éªŒè¯å›æ»š
    if health_check; then
        log "âœ… å›æ»šæˆåŠŸï¼"
    else
        log "âŒ å›æ»šåéªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç³»ç»ŸçŠ¶æ€"
    fi
}

rollback_code() {
    log "å›æ»šä»£ç æ–‡ä»¶..."
    
    # è·å–æœ€æ–°å¤‡ä»½
    LATEST_BACKUP=$(cat "$BACKUP_DIR/latest_code" 2>/dev/null)
    
    if [ ! -f "$LATEST_BACKUP" ]; then
        log "é”™è¯¯ï¼šæ‰¾ä¸åˆ°ä»£ç å¤‡ä»½æ–‡ä»¶"
        exit 1
    fi
    
    # åœæ­¢åº”ç”¨
    systemctl stop $APP_NAME
    
    # å¤‡ä»½å½“å‰ç‰ˆæœ¬ï¼ˆä»¥é˜²å›æ»šå¤±è´¥ï¼‰
    mv "$APP_DIR" "${APP_DIR}_failed_$(date +%s)"
    
    # æ¢å¤ä»£ç 
    mkdir -p "$(dirname $APP_DIR)"
    tar -xzf "$LATEST_BACKUP" -C "$(dirname $APP_DIR)"
    
    log "ä»£ç å›æ»šå®Œæˆ"
}

rollback_database() {
    log "å›æ»šæ•°æ®åº“..."
    
    LATEST_DB_BACKUP=$(cat "$BACKUP_DIR/latest_database" 2>/dev/null)
    
    if [ ! -f "$LATEST_DB_BACKUP" ]; then
        log "é”™è¯¯ï¼šæ‰¾ä¸åˆ°æ•°æ®åº“å¤‡ä»½æ–‡ä»¶"
        exit 1
    fi
    
    # ç¡®è®¤æ•°æ®åº“å›æ»š
    echo "âš ï¸  æ•°æ®åº“å›æ»šå°†ä¸¢å¤±æœ€æ–°æ•°æ®ï¼Œç¡®è®¤ç»§ç»­ï¼Ÿ(yes/no)"
    read -r confirm
    if [ "$confirm" != "yes" ]; then
        log "ç”¨æˆ·å–æ¶ˆæ•°æ®åº“å›æ»š"
        return 0
    fi
    
    # æ¢å¤æ•°æ®åº“
    gunzip -c "$LATEST_DB_BACKUP" | mysql -u$DB_USER -p$DB_PASS $DB_NAME
    
    log "æ•°æ®åº“å›æ»šå®Œæˆ"
}

# å‘½ä»¤è¡Œè°ƒç”¨
case ${1:-"help"} in
    "code")
        rollback code
        ;;
    "database")
        rollback database
        ;;
    "full")
        rollback full
        ;;
    *)
        echo "ç”¨æ³•: $0 {code|database|full}"
        echo "  code     - ä»…å›æ»šä»£ç "
        echo "  database - ä»…å›æ»šæ•°æ®åº“"  
        echo "  full     - å®Œæ•´å›æ»š"
        ;;
esac
```

---

## 8. ğŸ“Š éƒ¨ç½²æ—¥å¿—è®°å½•


### 8.1 æ—¥å¿—ç³»ç»Ÿè®¾è®¡


**ğŸ“ ä¸ºä»€ä¹ˆéœ€è¦éƒ¨ç½²æ—¥å¿—**
éƒ¨ç½²æ—¥å¿—å°±åƒæ˜¯"è¡Œè½¦è®°å½•ä»ª"ï¼Œè®°å½•éƒ¨ç½²è¿‡ç¨‹ä¸­çš„æ¯ä¸€ä¸ªæ­¥éª¤ï¼Œå‡ºé—®é¢˜æ—¶èƒ½å¿«é€Ÿå®šä½åŸå› ã€‚

```
æ—¥å¿—è®°å½•å†…å®¹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ“ä½œæ—¶é—´    â”‚ â†’ ä»€ä¹ˆæ—¶å€™æ‰§è¡Œçš„
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ‰§è¡Œç”¨æˆ·    â”‚ â†’ è°æ‰§è¡Œçš„æ“ä½œ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  
â”‚ æ“ä½œæ­¥éª¤    â”‚ â†’ å…·ä½“åšäº†ä»€ä¹ˆ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ‰§è¡Œç»“æœ    â”‚ â†’ æˆåŠŸè¿˜æ˜¯å¤±è´¥
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é”™è¯¯ä¿¡æ¯    â”‚ â†’ å¤±è´¥çš„è¯¦ç»†åŸå› 
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”§ æ—¥å¿—çº§åˆ«å®šä¹‰**
```bash
# æ—¥å¿—çº§åˆ«å’Œé¢œè‰²
LOG_LEVEL_DEBUG=0
LOG_LEVEL_INFO=1
LOG_LEVEL_WARN=2
LOG_LEVEL_ERROR=3

# å½“å‰æ—¥å¿—çº§åˆ«ï¼ˆå¯é…ç½®ï¼‰
CURRENT_LOG_LEVEL=${LOG_LEVEL:-$LOG_LEVEL_INFO}

# æ—¥å¿—å‡½æ•°å®ç°
log_debug() {
    [ $CURRENT_LOG_LEVEL -le $LOG_LEVEL_DEBUG ] && 
        echo -e "\033[36m[DEBUG $(date '+%H:%M:%S')] $1\033[0m" | tee -a $LOG_FILE
}

log_info() {
    [ $CURRENT_LOG_LEVEL -le $LOG_LEVEL_INFO ] && 
        echo -e "\033[32m[INFO  $(date '+%H:%M:%S')] $1\033[0m" | tee -a $LOG_FILE
}

log_warn() {
    [ $CURRENT_LOG_LEVEL -le $LOG_LEVEL_WARN ] && 
        echo -e "\033[33m[WARN  $(date '+%H:%M:%S')] $1\033[0m" | tee -a $LOG_FILE
}

log_error() {
    [ $CURRENT_LOG_LEVEL -le $LOG_LEVEL_ERROR ] && 
        echo -e "\033[31m[ERROR $(date '+%H:%M:%S')] $1\033[0m" | tee -a $LOG_FILE
}
```

### 8.2 ç»“æ„åŒ–æ—¥å¿—è®°å½•


**ğŸ“‹ è¯¦ç»†æ—¥å¿—å®ç°**
```bash
# åˆ›å»ºéƒ¨ç½²ä¼šè¯
init_deploy_session() {
    DEPLOY_ID="deploy_$(date +%Y%m%d_%H%M%S)_$$"
    DEPLOY_LOG_DIR="/var/log/deploy"
    DEPLOY_LOG_FILE="$DEPLOY_LOG_DIR/${DEPLOY_ID}.log"
    
    mkdir -p "$DEPLOY_LOG_DIR"
    
    # è®°å½•éƒ¨ç½²å¼€å§‹ä¿¡æ¯
    cat > "$DEPLOY_LOG_FILE" << EOF
===============================================
éƒ¨ç½²ä¼šè¯å¼€å§‹
===============================================
éƒ¨ç½²ID: $DEPLOY_ID
å¼€å§‹æ—¶é—´: $(date)
æ‰§è¡Œç”¨æˆ·: $(whoami)
ä¸»æœºå: $(hostname)
Gitåˆ†æ”¯: $(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")
Gitæäº¤: $(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
===============================================
EOF
    
    log_info "éƒ¨ç½²ä¼šè¯åˆå§‹åŒ–: $DEPLOY_ID"
}

# è®°å½•æ­¥éª¤æ‰§è¡Œ
log_step() {
    local STEP_NAME=$1
    local STEP_STATUS=${2:-"START"}
    local STEP_MESSAGE=${3:-""}
    
    cat >> "$DEPLOY_LOG_FILE" << EOF

[$(date '+%Y-%m-%d %H:%M:%S')] [$STEP_STATUS] $STEP_NAME
$([ -n "$STEP_MESSAGE" ] && echo "æ¶ˆæ¯: $STEP_MESSAGE")
---
EOF
    
    case $STEP_STATUS in
        "START")
            log_info "å¼€å§‹æ­¥éª¤: $STEP_NAME"
            ;;
        "SUCCESS")
            log_info "å®Œæˆæ­¥éª¤: $STEP_NAME"
            ;;
        "ERROR")
            log_error "æ­¥éª¤å¤±è´¥: $STEP_NAME - $STEP_MESSAGE"
            ;;
        "SKIP")
            log_warn "è·³è¿‡æ­¥éª¤: $STEP_NAME - $STEP_MESSAGE"
            ;;
    esac
}

# è®°å½•å‘½ä»¤æ‰§è¡Œ
execute_with_log() {
    local COMMAND=$1
    local DESCRIPTION=${2:-$COMMAND}
    
    log_step "$DESCRIPTION" "START"
    
    # æ‰§è¡Œå‘½ä»¤å¹¶è®°å½•è¾“å‡º
    {
        echo "æ‰§è¡Œå‘½ä»¤: $COMMAND"
        echo "è¾“å‡º:"
        eval "$COMMAND" 2>&1
        echo "é€€å‡ºç : $?"
    } >> "$DEPLOY_LOG_FILE"
    
    local EXIT_CODE=$?
    
    if [ $EXIT_CODE -eq 0 ]; then
        log_step "$DESCRIPTION" "SUCCESS"
    else
        log_step "$DESCRIPTION" "ERROR" "å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºç : $EXIT_CODE"
        return $EXIT_CODE
    fi
}
```

### 8.3 æ—¥å¿—åˆ†æå’Œç›‘æ§


**ğŸ“Š æ—¥å¿—åˆ†æè„šæœ¬**
```bash
analyze_deploy_logs() {
    local LOG_DIR="/var/log/deploy"
    local DAYS=${1:-7}  # åˆ†ææœ€è¿‘7å¤©
    
    echo "ğŸ“Š éƒ¨ç½²æ—¥å¿—åˆ†ææŠ¥å‘Š"
    echo "========================================"
    
    # ç»Ÿè®¡éƒ¨ç½²æ¬¡æ•°
    TOTAL_DEPLOYS=$(find "$LOG_DIR" -name "deploy_*.log" -mtime -$DAYS | wc -l)
    echo "ğŸ“ˆ æœ€è¿‘${DAYS}å¤©éƒ¨ç½²æ¬¡æ•°: $TOTAL_DEPLOYS"
    
    # ç»Ÿè®¡æˆåŠŸç‡
    SUCCESS_COUNT=$(grep -l "éƒ¨ç½²å®Œæˆ" "$LOG_DIR"/deploy_*.log 2>/dev/null | wc -l)
    if [ $TOTAL_DEPLOYS -gt 0 ]; then
        SUCCESS_RATE=$((SUCCESS_COUNT * 100 / TOTAL_DEPLOYS))
        echo "âœ… éƒ¨ç½²æˆåŠŸç‡: ${SUCCESS_RATE}%"
    fi
    
    # æœ€è¿‘å¤±è´¥çš„éƒ¨ç½²
    echo ""
    echo "âŒ æœ€è¿‘å¤±è´¥çš„éƒ¨ç½²:"
    grep -l "ERROR" "$LOG_DIR"/deploy_*.log 2>/dev/null | tail -5 | while read log_file; do
        DEPLOY_TIME=$(grep "å¼€å§‹æ—¶é—´:" "$log_file" | cut -d' ' -f2-)
        echo "  - $(basename $log_file): $DEPLOY_TIME"
    done
    
    # éƒ¨ç½²è€—æ—¶ç»Ÿè®¡
    echo ""
    echo "â±ï¸  å¹³å‡éƒ¨ç½²æ—¶é—´åˆ†æ:"
    calculate_deploy_times "$LOG_DIR" $DAYS
}

# å®æ—¶æ—¥å¿—ç›‘æ§
monitor_current_deploy() {
    local DEPLOY_LOG=${1:-$(ls -t /var/log/deploy/deploy_*.log | head -1)}
    
    if [ ! -f "$DEPLOY_LOG" ]; then
        log_error "æ²¡æœ‰æ‰¾åˆ°å½“å‰éƒ¨ç½²æ—¥å¿—"
        return 1
    fi
    
    echo "ğŸ” å®æ—¶ç›‘æ§éƒ¨ç½²æ—¥å¿—: $(basename $DEPLOY_LOG)"
    echo "æŒ‰ Ctrl+C é€€å‡ºç›‘æ§"
    echo "========================================"
    
    tail -f "$DEPLOY_LOG" | while read line; do
        # æ ¹æ®æ—¥å¿—å†…å®¹æ·»åŠ é¢œè‰²
        if echo "$line" | grep -q "ERROR"; then
            echo -e "\033[31m$line\033[0m"  # çº¢è‰²
        elif echo "$line" | grep -q "SUCCESS"; then
            echo -e "\033[32m$line\033[0m"  # ç»¿è‰²
        elif echo "$line" | grep -q "WARN"; then
            echo -e "\033[33m$line\033[0m"  # é»„è‰²
        else
            echo "$line"
        fi
    done
}
```

---

## 9. ğŸ” éƒ¨ç½²çŠ¶æ€éªŒè¯


### 9.1 å¤šå±‚æ¬¡éªŒè¯ä½“ç³»


**ğŸ¯ éªŒè¯å±‚æ¬¡è®¾è®¡**
```
éªŒè¯é‡‘å­—å¡”ï¼š
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚  ä¸šåŠ¡åŠŸèƒ½   â”‚ â† æœ€é‡è¦ä½†æœ€æ…¢
      â”‚    éªŒè¯     â”‚
      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
      â”‚  æ¥å£å“åº”   â”‚ â† ä¸­ç­‰é‡è¦å’Œé€Ÿåº¦
      â”‚    éªŒè¯     â”‚
      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
      â”‚  æœåŠ¡çŠ¶æ€   â”‚ â† æœ€å¿«ä½†åŸºç¡€
      â”‚    éªŒè¯     â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ“‹ éªŒè¯æ£€æŸ¥æ¸…å•**
- [ ] **åŸºç¡€è®¾æ–½éªŒè¯**ï¼šæœåŠ¡å™¨ã€ç½‘ç»œã€å­˜å‚¨
- [ ] **æœåŠ¡çŠ¶æ€éªŒè¯**ï¼šè¿›ç¨‹ã€ç«¯å£ã€èµ„æº
- [ ] **æ¥å£åŠŸèƒ½éªŒè¯**ï¼šAPIå“åº”ã€æ•°æ®åº“è¿æ¥
- [ ] **ä¸šåŠ¡é€»è¾‘éªŒè¯**ï¼šå…³é”®åŠŸèƒ½ã€ç”¨æˆ·æµç¨‹
- [ ] **æ€§èƒ½æŒ‡æ ‡éªŒè¯**ï¼šå“åº”æ—¶é—´ã€ååé‡

### 9.2 è‡ªåŠ¨åŒ–éªŒè¯è„šæœ¬


**ğŸ”§ ç»¼åˆéªŒè¯å®ç°**
```bash
#!/bin/bash
# éƒ¨ç½²éªŒè¯è„šæœ¬

validate_deployment() {
    local APP_NAME=${1:-"myapp"}
    local VALIDATION_CONFIG="validation.conf"
    
    log_info "å¼€å§‹éƒ¨ç½²éªŒè¯: $APP_NAME"
    
    # åŠ è½½éªŒè¯é…ç½®
    load_validation_config
    
    # æ‰§è¡Œå„å±‚éªŒè¯
    local validation_passed=true
    
    validate_infrastructure || validation_passed=false
    validate_services || validation_passed=false
    validate_endpoints || validation_passed=false
    validate_business_logic || validation_passed=false
    
    # ç”ŸæˆéªŒè¯æŠ¥å‘Š
    generate_validation_report $validation_passed
    
    if [ "$validation_passed" = true ]; then
        log_info "âœ… æ‰€æœ‰éªŒè¯é€šè¿‡ï¼Œéƒ¨ç½²æˆåŠŸ"
        return 0
    else
        log_error "âŒ éªŒè¯å¤±è´¥ï¼Œå»ºè®®å›æ»š"
        return 1
    fi
}

# åŸºç¡€è®¾æ–½éªŒè¯
validate_infrastructure() {
    log_step "åŸºç¡€è®¾æ–½éªŒè¯" "START"
    
    local checks_passed=true
    
    # æ£€æŸ¥ç£ç›˜ç©ºé—´
    check_disk_usage() {
        local usage=$(df /var/www | awk 'NR==2{print $5}' | sed 's/%//')
        if [ $usage -gt 85 ]; then
            log_error "ç£ç›˜ä½¿ç”¨ç‡è¿‡é«˜: ${usage}%"
            return 1
        fi
        log_debug "ç£ç›˜ä½¿ç”¨ç‡æ­£å¸¸: ${usage}%"
    }
    
    # æ£€æŸ¥å†…å­˜ä½¿ç”¨
    check_memory_usage() {
        local mem_usage=$(free | awk 'NR==2{printf "%.0f", $3*100/$2}')
        if [ $mem_usage -gt 90 ]; then
            log_warn "å†…å­˜ä½¿ç”¨ç‡è¾ƒé«˜: ${mem_usage}%"
        fi
        log_debug "å†…å­˜ä½¿ç”¨ç‡: ${mem_usage}%"
    }
    
    # æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
    check_network() {
        if ! ping -c 1 8.8.8.8 >/dev/null 2>&1; then
            log_error "ç½‘ç»œè¿æ¥å¼‚å¸¸"
            return 1
        fi
        log_debug "ç½‘ç»œè¿æ¥æ­£å¸¸"
    }
    
    check_disk_usage || checks_passed=false
    check_memory_usage
    check_network || checks_passed=false
    
    if [ "$checks_passed" = true ]; then
        log_step "åŸºç¡€è®¾æ–½éªŒè¯" "SUCCESS"
        return 0
    else
        log_step "åŸºç¡€è®¾æ–½éªŒè¯" "ERROR"
        return 1
    fi
}

# æœåŠ¡çŠ¶æ€éªŒè¯
validate_services() {
    log_step "æœåŠ¡çŠ¶æ€éªŒè¯" "START"
    
    local services_ok=true
    
    # æ£€æŸ¥åº”ç”¨è¿›ç¨‹
    check_app_process() {
        if pgrep -f "$APP_NAME" >/dev/null; then
            local pid=$(pgrep -f "$APP_NAME")
            local cpu_usage=$(ps -p $pid -o %cpu --no-headers)
            local mem_usage=$(ps -p $pid -o %mem --no-headers)
            log_debug "åº”ç”¨è¿›ç¨‹è¿è¡Œä¸­ PID:$pid CPU:${cpu_usage}% MEM:${mem_usage}%"
        else
            log_error "åº”ç”¨è¿›ç¨‹æœªè¿è¡Œ"
            return 1
        fi
    }
    
    # æ£€æŸ¥ç«¯å£ç›‘å¬
    check_port_listening() {
        local port=${APP_PORT:-3000}
        if netstat -tuln | grep ":$port " >/dev/null; then
            log_debug "ç«¯å£ $port ç›‘å¬æ­£å¸¸"
        else
            log_error "ç«¯å£ $port æœªç›‘å¬"
            return 1
        fi
    }
    
    # æ£€æŸ¥ä¾èµ–æœåŠ¡
    check_dependent_services() {
        local services=("nginx" "mysql" "redis")
        for service in "${services[@]}"; do
            if systemctl is-active --quiet $service; then
                log_debug "ä¾èµ–æœåŠ¡ $service è¿è¡Œæ­£å¸¸"
            else
                log_warn "ä¾èµ–æœåŠ¡ $service æœªè¿è¡Œ"
            fi
        done
    }
    
    check_app_process || services_ok=false
    check_port_listening || services_ok=false
    check_dependent_services
    
    if [ "$services_ok" = true ]; then
        log_step "æœåŠ¡çŠ¶æ€éªŒè¯" "SUCCESS"
        return 0
    else
        log_step "æœåŠ¡çŠ¶æ€éªŒè¯" "ERROR"
        return 1
    fi
}

# æ¥å£éªŒè¯
validate_endpoints() {
    log_step "æ¥å£éªŒè¯" "START"
    
    local endpoints_ok=true
    local base_url="http://localhost:${APP_PORT:-3000}"
    
    # å¥åº·æ£€æŸ¥æ¥å£
    check_health_endpoint() {
        local health_url="$base_url/health"
        local response=$(curl -s -w "%{http_code}" -o /dev/null $health_url)
        
        if [ "$response" = "200" ]; then
            log_debug "å¥åº·æ£€æŸ¥æ¥å£æ­£å¸¸"
        else
            log_error "å¥åº·æ£€æŸ¥æ¥å£å¼‚å¸¸: $response"
            return 1
        fi
    }
    
    # å…³é”®APIæ¥å£
    check_api_endpoints() {
        local api_endpoints=("/api/status" "/api/version" "/api/info")
        
        for endpoint in "${api_endpoints[@]}"; do
            local url="$base_url$endpoint"
            local response=$(curl -s -w "%{http_code}" -o /dev/null $url)
            
            if [ "$response" = "200" ]; then
                log_debug "APIæ¥å£æ­£å¸¸: $endpoint"
            else
                log_warn "APIæ¥å£å¼‚å¸¸: $endpoint ($response)"
            fi
        done
    }
    
    # æ•°æ®åº“è¿æ¥æ£€æŸ¥
    check_database_connection() {
        local db_check_url="$base_url/api/db/status"
        local response=$(curl -s $db_check_url | jq -r '.status' 2>/dev/null)
        
        if [ "$response" = "connected" ]; then
            log_debug "æ•°æ®åº“è¿æ¥æ­£å¸¸"
        else
            log_error "æ•°æ®åº“è¿æ¥å¼‚å¸¸"
            return 1
        fi
    }
    
    check_health_endpoint || endpoints_ok=false
    check_api_endpoints
    check_database_connection || endpoints_ok=false
    
    if [ "$endpoints_ok" = true ]; then
        log_step "æ¥å£éªŒè¯" "SUCCESS"
        return 0
    else
        log_step "æ¥å£éªŒè¯" "ERROR"
        return 1
    fi
}

# ä¸šåŠ¡é€»è¾‘éªŒè¯
validate_business_logic() {
    log_step "ä¸šåŠ¡é€»è¾‘éªŒè¯" "START"
    
    local business_ok=true
    
    # ç”¨æˆ·æ³¨å†Œæµç¨‹æµ‹è¯•
    test_user_registration() {
        local test_user="test_$(date +%s)"
        local register_url="$base_url/api/register"
        
        local response=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "{\"username\":\"$test_user\",\"email\":\"$test_user@test.com\"}" \
            $register_url)
        
        if echo "$response" | jq -e '.success' >/dev/null 2>&1; then
            log_debug "ç”¨æˆ·æ³¨å†ŒåŠŸèƒ½æ­£å¸¸"
            
            # æ¸…ç†æµ‹è¯•æ•°æ®
            cleanup_test_user $test_user
        else
            log_error "ç”¨æˆ·æ³¨å†ŒåŠŸèƒ½å¼‚å¸¸"
            return 1
        fi
    }
    
    # æ•°æ®æŸ¥è¯¢æµ‹è¯•
    test_data_query() {
        local query_url="$base_url/api/users?limit=1"
        local response=$(curl -s $query_url)
        
        if echo "$response" | jq -e '.data | length' >/dev/null 2>&1; then
            log_debug "æ•°æ®æŸ¥è¯¢åŠŸèƒ½æ­£å¸¸"
        else
            log_error "æ•°æ®æŸ¥è¯¢åŠŸèƒ½å¼‚å¸¸"
            return 1
        fi
    }
    
    # ç¼“å­˜åŠŸèƒ½æµ‹è¯•
    test_cache_function() {
        local cache_url="$base_url/api/cache/test"
        
        # ç¬¬ä¸€æ¬¡è¯·æ±‚ï¼ˆç¼“å­˜MISSï¼‰
        local start_time=$(date +%s%N)
        curl -s $cache_url >/dev/null
        local first_time=$(( ($(date +%s%N) - start_time) / 1000000 ))
        
        # ç¬¬äºŒæ¬¡è¯·æ±‚ï¼ˆç¼“å­˜HITï¼‰
        start_time=$(date +%s%N)
        curl -s $cache_url >/dev/null
        local second_time=$(( ($(date +%s%N) - start_time) / 1000000 ))
        
        if [ $second_time -lt $((first_time / 2)) ]; then
            log_debug "ç¼“å­˜åŠŸèƒ½æ­£å¸¸ (${first_time}ms -> ${second_time}ms)"
        else
            log_warn "ç¼“å­˜åŠŸèƒ½å¯èƒ½å¼‚å¸¸"
        fi
    }
    
    test_user_registration || business_ok=false
    test_data_query || business_ok=false
    test_cache_function
    
    if [ "$business_ok" = true ]; then
        log_step "ä¸šåŠ¡é€»è¾‘éªŒè¯" "SUCCESS"
        return 0
    else
        log_step "ä¸šåŠ¡é€»è¾‘éªŒè¯" "ERROR"
        return 1
    fi
}
```

### 9.3 éªŒè¯æŠ¥å‘Šç”Ÿæˆ


**ğŸ“Š éªŒè¯æŠ¥å‘Šæ¨¡æ¿**
```bash
generate_validation_report() {
    local validation_passed=$1
    local report_file="/var/log/deploy/validation_$(date +%Y%m%d_%H%M%S).html"
    
    cat > "$report_file" << EOF
<!DOCTYPE html>
<html>
<head>
    <title>éƒ¨ç½²éªŒè¯æŠ¥å‘Š</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .header { background: #f0f0f0; padding: 10px; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <div class="header">
        <h1>éƒ¨ç½²éªŒè¯æŠ¥å‘Š</h1>
        <p>ç”Ÿæˆæ—¶é—´: $(date)</p>
        <p>åº”ç”¨åç§°: $APP_NAME</p>
        <p>éƒ¨ç½²ID: $DEPLOY_ID</p>
        <p class="$([ "$validation_passed" = true ] && echo 'success' || echo 'error')">
            éªŒè¯ç»“æœ: $([ "$validation_passed" = true ] && echo 'âœ… é€šè¿‡' || echo 'âŒ å¤±è´¥')
        </p>
    </div>
    
    <h2>éªŒè¯è¯¦æƒ…</h2>
    <table>
        <tr><th>éªŒè¯é¡¹ç›®</th><th>çŠ¶æ€</th><th>è¯¦æƒ…</th></tr>
$(generate_validation_table)
    </table>
    
    <h2>ç³»ç»ŸçŠ¶æ€</h2>
    <pre>$(get_system_status)</pre>
    
    <h2>å»ºè®®æ“ä½œ</h2>
    <p>$(get_recommendations $validation_passed)</p>
</body>
</html>
EOF
    
    log_info "éªŒè¯æŠ¥å‘Šå·²ç”Ÿæˆ: $report_file"
}

get_recommendations() {
    local passed=$1
    
    if [ "$passed" = true ]; then
        echo "âœ… éƒ¨ç½²éªŒè¯å…¨éƒ¨é€šè¿‡ï¼Œç³»ç»Ÿè¿è¡Œæ­£å¸¸ã€‚å»ºè®®ç»§ç»­ç›‘æ§å…³é”®æŒ‡æ ‡ã€‚"
    else
        echo "âŒ éƒ¨ç½²éªŒè¯å­˜åœ¨å¤±è´¥é¡¹ï¼Œå¼ºçƒˆå»ºè®®ï¼š"
        echo "1. æ£€æŸ¥å¤±è´¥çš„éªŒè¯é¡¹è¯¦ç»†æ—¥å¿—"
        echo "2. ä¿®å¤é—®é¢˜æˆ–è€ƒè™‘å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬"
        echo "3. é‡æ–°æ‰§è¡ŒéªŒè¯ç¡®ä¿ç³»ç»Ÿç¨³å®š"
    fi
}
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ éƒ¨ç½²è„šæœ¬æœ¬è´¨ï¼šè‡ªåŠ¨åŒ–çš„"æ“ä½œæ‰‹å†Œ"ï¼Œå‡å°‘äººä¸ºé”™è¯¯
ğŸ”¸ è¿æ¥é…ç½®ï¼šSSHå¯†é’¥è®¤è¯ï¼Œå®‰å…¨å¯é çš„æœåŠ¡å™¨è¿æ¥
ğŸ”¸ æ–‡ä»¶ä¼ è¾“ï¼šrsyncä¸ºä¸»ï¼Œå…¼é¡¾å®‰å…¨æ€§å’Œæ•ˆç‡
ğŸ”¸ æœåŠ¡ç®¡ç†ï¼šsystemctlç°ä»£åŒ–ç®¡ç†ï¼Œæ”¯æŒå¹³æ»‘é‡å¯
ğŸ”¸ å¤šå±‚éªŒè¯ï¼šåŸºç¡€è®¾æ–½â†’æœåŠ¡çŠ¶æ€â†’æ¥å£â†’ä¸šåŠ¡é€»è¾‘
ğŸ”¸ å›æ»šæœºåˆ¶ï¼šå¿«é€Ÿæ¢å¤çš„"åæ‚”è¯"ï¼Œé™ä½å‘å¸ƒé£é™©
ğŸ”¸ æ—¥å¿—è®°å½•ï¼šå®Œæ•´çš„æ“ä½œè®°å½•ï¼Œé—®é¢˜æ’æŸ¥çš„é‡è¦ä¾æ®
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ éƒ¨ç½²è„šæœ¬çš„æ ¸å¿ƒä»·å€¼**
```
è‡ªåŠ¨åŒ–ä¼˜åŠ¿ï¼š
- å‡å°‘äººä¸ºé”™è¯¯ï¼šè„šæœ¬æ‰§è¡Œæ¯”æ‰‹åŠ¨æ“ä½œæ›´å¯é 
- æé«˜æ•ˆç‡ï¼šä¸€é”®éƒ¨ç½²ï¼ŒèŠ‚çœå¤§é‡æ—¶é—´
- ä¿è¯ä¸€è‡´æ€§ï¼šæ¯æ¬¡éƒ¨ç½²éƒ½æŒ‰ç›¸åŒæµç¨‹
- ä¾¿äºå›æ»šï¼šæ ‡å‡†åŒ–çš„å¤‡ä»½å’Œæ¢å¤æµç¨‹

å®é™…åº”ç”¨ï¼š
- å°å›¢é˜Ÿï¼šå‡å°‘è¿ç»´å·¥ä½œé‡
- å¤§å›¢é˜Ÿï¼šç¡®ä¿éƒ¨ç½²æ ‡å‡†åŒ–
- é¢‘ç¹å‘å¸ƒï¼šæé«˜å‘å¸ƒæ•ˆç‡
- å…³é”®ç³»ç»Ÿï¼šé™ä½å‘å¸ƒé£é™©
```

**ğŸ”¹ å®‰å…¨é…ç½®çš„é‡è¦æ€§**
```
SSHå®‰å…¨ç­–ç•¥ï¼š
- å¯†é’¥è®¤è¯ > å¯†ç è®¤è¯ï¼šæ›´å®‰å…¨çš„èº«ä»½éªŒè¯
- ä¸“ç”¨éƒ¨ç½²ç”¨æˆ·ï¼šæœ€å°æƒé™åŸåˆ™
- éæ ‡å‡†ç«¯å£ï¼šå‡å°‘æ‰«ææ”»å‡»
- å®šæœŸè½®æ¢å¯†é’¥ï¼šé™ä½æ³„éœ²é£é™©

æ–‡ä»¶ä¼ è¾“å®‰å…¨ï¼š
- ä½¿ç”¨åŠ å¯†ä¼ è¾“ï¼šé˜²æ­¢ä¸­é—´äººæ”»å‡»
- éªŒè¯æ–‡ä»¶å®Œæ•´æ€§ï¼šç¡®ä¿ä¼ è¾“æ— è¯¯
- æƒé™æ§åˆ¶ï¼šåˆé€‚çš„æ–‡ä»¶æƒé™è®¾ç½®
```

**ğŸ”¹ éªŒè¯æœºåˆ¶çš„å±‚æ¬¡è®¾è®¡**
```
éªŒè¯é‡‘å­—å¡”ç†å¿µï¼š
- åŸºç¡€éªŒè¯ï¼ˆå¿«é€Ÿï¼‰ï¼šè¿›ç¨‹ã€ç«¯å£ã€åŸºç¡€è¿æ¥
- æ¥å£éªŒè¯ï¼ˆä¸­ç­‰ï¼‰ï¼šHTTPå“åº”ã€APIå¯ç”¨æ€§
- ä¸šåŠ¡éªŒè¯ï¼ˆæ·±å…¥ï¼‰ï¼šæ ¸å¿ƒåŠŸèƒ½ã€ç”¨æˆ·æµç¨‹

å¹³è¡¡è€ƒè™‘ï¼š
- éªŒè¯æ·±åº¦ vs æ‰§è¡Œæ—¶é—´
- è‡ªåŠ¨åŒ– vs æ‰‹åŠ¨æ£€æŸ¥
- è¦†ç›–ç‡ vs ç»´æŠ¤æˆæœ¬
```

### 10.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ“‹ éƒ¨ç½²è„šæœ¬ç¼–å†™æ£€æŸ¥æ¸…å•**
- [ ] **é”™è¯¯å¤„ç†**ï¼š`set -e` ç¡®ä¿å‡ºé”™åœæ­¢
- [ ] **æ—¥å¿—è®°å½•**ï¼šæ¯ä¸ªå…³é”®æ­¥éª¤éƒ½è¦è®°å½•
- [ ] **å˜é‡ç®¡ç†**ï¼šé‡è¦é…ç½®å‚æ•°åŒ–
- [ ] **æƒé™æ£€æŸ¥**ï¼šç¡®ä¿æœ‰è¶³å¤Ÿçš„æ“ä½œæƒé™
- [ ] **å¤‡ä»½æœºåˆ¶**ï¼šéƒ¨ç½²å‰è‡ªåŠ¨å¤‡ä»½
- [ ] **éªŒè¯æµç¨‹**ï¼šéƒ¨ç½²åè‡ªåŠ¨éªŒè¯
- [ ] **å›æ»šå‡†å¤‡**ï¼šå¤±è´¥æ—¶èƒ½å¿«é€Ÿå›æ»š

**ğŸ¯ å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ**

| é—®é¢˜ç±»å‹ | **ç°è±¡** | **å¯èƒ½åŸå› ** | **è§£å†³æ–¹æ³•** |
|---------|---------|-------------|-------------|
| ğŸ” **è¿æ¥å¤±è´¥** | `SSHè¿æ¥è¢«æ‹’ç»` | `å¯†é’¥æƒé™ã€é˜²ç«å¢™` | `æ£€æŸ¥SSHé…ç½®å’Œç½‘ç»œ` |
| ğŸ“ **æ–‡ä»¶ä¼ è¾“æ…¢** | `ä¼ è¾“é€Ÿåº¦å¾ˆæ…¢` | `ç½‘ç»œå¸¦å®½ã€æ–‡ä»¶å¤§å°` | `ä½¿ç”¨rsyncå‹ç¼©ä¼ è¾“` |
| ğŸ”„ **æœåŠ¡å¯åŠ¨å¤±è´¥** | `åº”ç”¨æ— æ³•å¯åŠ¨` | `ç«¯å£å ç”¨ã€ä¾èµ–ç¼ºå¤±` | `æ£€æŸ¥ç«¯å£å’Œä¾èµ–æœåŠ¡` |
| ğŸ” **éªŒè¯å¤±è´¥** | `å¥åº·æ£€æŸ¥ä¸é€šè¿‡` | `æœåŠ¡æœªå®Œå…¨å¯åŠ¨` | `å¢åŠ å¯åŠ¨ç­‰å¾…æ—¶é—´` |
| ğŸ’¾ **ç£ç›˜ç©ºé—´ä¸è¶³** | `éƒ¨ç½²ä¸­æ–­` | `æ—¥å¿—æ–‡ä»¶ã€ä¸´æ—¶æ–‡ä»¶` | `æ¸…ç†ç£ç›˜ç©ºé—´` |

**ğŸ¯ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ³¨æ„äº‹é¡¹**
- **ğŸ• éƒ¨ç½²æ—¶æœº**ï¼šé€‰æ‹©ä¸šåŠ¡ä½å³°æœŸè¿›è¡Œéƒ¨ç½²
- **ğŸ‘¥ å›¢é˜Ÿåä½œ**ï¼šéƒ¨ç½²å‰é€šçŸ¥ç›¸å…³å›¢é˜Ÿæˆå‘˜
- **ğŸ”„ åˆ†æ‰¹éƒ¨ç½²**ï¼šå¤§å‹ç³»ç»Ÿé‡‡ç”¨ç°åº¦å‘å¸ƒ
- **ğŸ“Š ç›‘æ§å‘Šè­¦**ï¼šéƒ¨ç½²åå¯†åˆ‡ç›‘æ§ç³»ç»ŸæŒ‡æ ‡
- **ğŸ“ åº”æ€¥é¢„æ¡ˆ**ï¼šå‡†å¤‡ç´§æ€¥è”ç³»æ–¹å¼å’Œå›æ»šè®¡åˆ’

### 10.4 è¿›é˜¶éƒ¨ç½²æŠ€å·§


**ğŸš€ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**
```bash
# å¹¶è¡Œå¤„ç†æå‡æ•ˆç‡
optimize_deployment() {
    log_info "å¯ç”¨éƒ¨ç½²ä¼˜åŒ–..."
    
    # å¹¶è¡Œæ–‡ä»¶ä¼ è¾“
    {
        rsync -avz app/ $DEPLOY_HOST:$DEPLOY_PATH/app/ &
        PID1=$!
        
        rsync -avz config/ $DEPLOY_HOST:$DEPLOY_PATH/config/ &
        PID2=$!
        
        # ç­‰å¾…å¹¶è¡Œä»»åŠ¡å®Œæˆ
        wait $PID1 && log_debug "åº”ç”¨æ–‡ä»¶ä¼ è¾“å®Œæˆ"
        wait $PID2 && log_debug "é…ç½®æ–‡ä»¶ä¼ è¾“å®Œæˆ"
    }
    
    # é¢„çƒ­ç¼“å­˜
    warmup_cache() {
        log_info "é¢„çƒ­åº”ç”¨ç¼“å­˜..."
        local urls=("/api/config" "/api/user/profile" "/api/dashboard")
        
        for url in "${urls[@]}"; do
            curl -s "http://localhost:3000$url" >/dev/null &
        done
        wait
        log_debug "ç¼“å­˜é¢„çƒ­å®Œæˆ"
    }
    
    warmup_cache
}
```

**ğŸ”§ é«˜çº§è„šæœ¬æŠ€å·§**
```bash
# æ™ºèƒ½é‡è¯•æœºåˆ¶
retry_with_backoff() {
    local command="$1"
    local max_attempts=${2:-3}
    local delay=${3:-1}
    
    local attempt=1
    while [ $attempt -le $max_attempts ]; do
        log_debug "å°è¯•æ‰§è¡Œå‘½ä»¤ (ç¬¬${attempt}æ¬¡): $command"
        
        if eval "$command"; then
            log_debug "å‘½ä»¤æ‰§è¡ŒæˆåŠŸ"
            return 0
        fi
        
        if [ $attempt -lt $max_attempts ]; then
            log_warn "å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œ${delay}ç§’åé‡è¯•..."
            sleep $delay
            delay=$((delay * 2))  # æŒ‡æ•°é€€é¿
        fi
        
        attempt=$((attempt + 1))
    done
    
    log_error "å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œå·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•°"
    return 1
}

# ä½¿ç”¨ç¤ºä¾‹
retry_with_backoff "systemctl start myapp" 3 2
```

**ğŸ“Š éƒ¨ç½²æŒ‡æ ‡æ”¶é›†**
```bash
collect_deployment_metrics() {
    local start_time=$1
    local end_time=$(date +%s)
    local duration=$((end_time - start_time))
    
    # è®¡ç®—éƒ¨ç½²è€—æ—¶
    local minutes=$((duration / 60))
    local seconds=$((duration % 60))
    
    # æ”¶é›†ç³»ç»ŸæŒ‡æ ‡
    local cpu_usage=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1)
    local mem_usage=$(free -m | awk 'NR==2{printf "%.1f", $3*100/$2}')
    local disk_usage=$(df /var/www | awk 'NR==2{print $5}' | sed 's/%//')
    
    # ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Š
    cat >> "/var/log/deploy/metrics.log" << EOF
$(date '+%Y-%m-%d %H:%M:%S'),${duration},${cpu_usage},${mem_usage},${disk_usage}
EOF
    
    log_info "ğŸ“Š éƒ¨ç½²æŒ‡æ ‡:"
    log_info "  â±ï¸  éƒ¨ç½²è€—æ—¶: ${minutes}åˆ†${seconds}ç§’"
    log_info "  ğŸ’» CPUä½¿ç”¨ç‡: ${cpu_usage}%"
    log_info "  ğŸ§  å†…å­˜ä½¿ç”¨ç‡: ${mem_usage}%"
    log_info "  ğŸ’¾ ç£ç›˜ä½¿ç”¨ç‡: ${disk_usage}%"
}
```

### 10.5 GitLab CIé›†æˆç¤ºä¾‹


**ğŸ“‹ å®Œæ•´çš„CIéƒ¨ç½²é…ç½®**
```yaml
# .gitlab-ci.yml éƒ¨ç½²é˜¶æ®µé…ç½®
deploy_production:
  stage: deploy
  image: alpine:latest
  variables:
    DEPLOY_SCRIPT: "scripts/deploy.sh"
    VALIDATION_SCRIPT: "scripts/validate.sh"
  
  before_script:
    # å®‰è£…å¿…è¦å·¥å…·
    - apk add --no-cache openssh-client rsync curl jq
    
    # é…ç½®SSH
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh && chmod 700 ~/.ssh
    - ssh-keyscan $DEPLOY_HOST >> ~/.ssh/known_hosts
    
    # åˆ›å»ºéƒ¨ç½²ç›®å½•
    - mkdir -p deploy_package
    - cp -r dist/* deploy_package/
    - cp $DEPLOY_SCRIPT deploy_package/
    - cp $VALIDATION_SCRIPT deploy_package/
  
  script:
    # ä¼ è¾“éƒ¨ç½²åŒ…
    - rsync -avz deploy_package/ $DEPLOY_USER@$DEPLOY_HOST:/tmp/deploy/
    
    # æ‰§è¡Œè¿œç¨‹éƒ¨ç½²
    - |
      ssh $DEPLOY_USER@$DEPLOY_HOST "
        cd /tmp/deploy &&
        chmod +x $DEPLOY_SCRIPT $VALIDATION_SCRIPT &&
        ./$DEPLOY_SCRIPT $CI_COMMIT_SHA &&
        ./$VALIDATION_SCRIPT
      "
  
  after_script:
    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    - ssh $DEPLOY_USER@$DEPLOY_HOST "rm -rf /tmp/deploy"
  
  artifacts:
    reports:
      # æ”¶é›†éƒ¨ç½²æŠ¥å‘Š
      junit: deploy_report.xml
    paths:
      - deploy_logs/
    expire_in: 1 week
  
  only:
    - main
  when: manual  # æ‰‹åŠ¨è§¦å‘ç”Ÿäº§éƒ¨ç½²
```

**ğŸ¯ å®ç”¨éƒ¨ç½²æŠ€å·§æ€»ç»“**

> **ğŸ’¡ ä¸€åˆ†é’ŸæŒæ¡éƒ¨ç½²è„šæœ¬æ ¸å¿ƒ**
> 1. **å®‰å…¨ç¬¬ä¸€**ï¼šSSHå¯†é’¥è®¤è¯ï¼Œä¸“ç”¨éƒ¨ç½²ç”¨æˆ·
> 2. **è‡ªåŠ¨å¤‡ä»½**ï¼šéƒ¨ç½²å‰å¿…é¡»å¤‡ä»½ï¼Œå‡ºé”™èƒ½å¿«é€Ÿå›æ»š
> 3. **å¤šå±‚éªŒè¯**ï¼šä»åŸºç¡€è®¾æ–½åˆ°ä¸šåŠ¡åŠŸèƒ½ï¼Œç¡®ä¿éƒ¨ç½²æˆåŠŸ
> 4. **è¯¦ç»†æ—¥å¿—**ï¼šè®°å½•æ¯ä¸ªæ­¥éª¤ï¼Œæ–¹ä¾¿é—®é¢˜æ’æŸ¥
> 5. **å¼‚å¸¸å¤„ç†**ï¼šè„šæœ¬è¦èƒ½å¤„ç†å„ç§å¼‚å¸¸æƒ…å†µ

### 10.6 æœ€ä½³å®è·µé€ŸæŸ¥


**â­ å¿…é¡»ç†è§£çš„æ ¸å¿ƒæ¦‚å¿µ**
- **éƒ¨ç½²å°±æ˜¯æ¬å®¶**ï¼šæŠŠä»£ç ä»å¼€å‘ç¯å¢ƒ"æ¬"åˆ°ç”Ÿäº§ç¯å¢ƒ
- **è„šæœ¬å°±æ˜¯æ¸…å•**ï¼šè‡ªåŠ¨åŒ–æ‰§è¡Œçš„æ“ä½œæ­¥éª¤æ¸…å•
- **éªŒè¯å°±æ˜¯æ£€æŸ¥**ï¼šç¡®ä¿"æ¬å®¶"åä¸€åˆ‡æ­£å¸¸å·¥ä½œ
- **å›æ»šå°±æ˜¯åæ‚”è¯**ï¼šå‡ºé—®é¢˜æ—¶èƒ½å¿«é€Ÿå›åˆ°å®‰å…¨çŠ¶æ€

**ğŸš¨ å¸¸è§é”™è¯¯é¿å…**
- âŒ **ç›´æ¥åœ¨ç”Ÿäº§æœåŠ¡å™¨ä¸Šä¿®æ”¹ä»£ç **ï¼šå®¹æ˜“å‡ºé”™ä¸”éš¾ä»¥è¿½è¸ª
- âŒ **æ²¡æœ‰å¤‡ä»½å°±éƒ¨ç½²**ï¼šå‡ºé—®é¢˜æ—¶æ— æ³•å¿«é€Ÿæ¢å¤
- âŒ **è·³è¿‡éªŒè¯æ­¥éª¤**ï¼šé—®é¢˜å¯èƒ½åœ¨ç”¨æˆ·ä½¿ç”¨æ—¶æ‰æš´éœ²
- âŒ **ä½¿ç”¨rootç”¨æˆ·éƒ¨ç½²**ï¼šå®‰å…¨é£é™©å¾ˆå¤§
- âŒ **éƒ¨ç½²æ—¶ä¸é€šçŸ¥å›¢é˜Ÿ**ï¼šå¯èƒ½å½±å“å…¶ä»–äººçš„å·¥ä½œ

**ğŸ¯ è®°å¿†å£è¯€**
> **éƒ¨ç½²è„šæœ¬ç¼–å†™è¦è¯€ï¼š**
> - å®‰å…¨è¿æ¥æ˜¯åŸºç¡€ï¼ŒSSHå¯†é’¥è¦é…å¥½
> - æ–‡ä»¶ä¼ è¾“ç”¨rsyncï¼Œå¢é‡åŒæ­¥æ•ˆç‡é«˜  
> - æœåŠ¡é‡å¯è¦å¹³æ»‘ï¼Œå¥åº·æ£€æŸ¥ä¸èƒ½å°‘
> - å¤‡ä»½å›æ»šè¦å‡†å¤‡ï¼Œæ—¥å¿—è®°å½•è¦è¯¦ç»†
> - éªŒè¯æµ‹è¯•è¦å……åˆ†ï¼Œé—®é¢˜å‘ç°è¦è¶æ—©

**æ ¸å¿ƒè®°å¿†**ï¼š
- éƒ¨ç½²è„šæœ¬è®©æ‰‹åŠ¨æ“ä½œå˜è‡ªåŠ¨ï¼Œå‡å°‘é”™è¯¯æé«˜æ•ˆç‡
- SSHé…ç½®æ˜¯å®‰å…¨åŸºç¡€ï¼Œå¯†é’¥è®¤è¯æ¯”å¯†ç å®‰å…¨
- rsyncæ˜¯æ–‡ä»¶ä¼ è¾“åˆ©å™¨ï¼Œåªä¼ å˜åŒ–æ–‡ä»¶èŠ‚çœæ—¶é—´
- å¤šå±‚éªŒè¯ç¡®ä¿è´¨é‡ï¼Œä»åŸºç¡€è®¾æ–½åˆ°ä¸šåŠ¡åŠŸèƒ½
- å®Œæ•´çš„æ—¥å¿—æ˜¯é—®é¢˜æ’æŸ¥çš„é‡è¦çº¿ç´¢
- å›æ»šæœºåˆ¶æ˜¯å®‰å…¨ç½‘ï¼Œè®©éƒ¨ç½²æ›´æœ‰ä¿¡å¿ƒ