---
title: 16ã€æ¡ä»¶æ‰§è¡Œä¸åˆ†æ”¯ç­–ç•¥
---
## ğŸ“š ç›®å½•

1. [æ¡ä»¶æ‰§è¡ŒåŸºç¡€æ¦‚å¿µ](#1-æ¡ä»¶æ‰§è¡ŒåŸºç¡€æ¦‚å¿µ)
2. [åˆ†æ”¯ç‰¹å®šPipeline](#2-åˆ†æ”¯ç‰¹å®šPipeline)
3. [æ ‡ç­¾è§¦å‘éƒ¨ç½²](#3-æ ‡ç­¾è§¦å‘éƒ¨ç½²)
4. [åˆå¹¶è¯·æ±‚Pipeline](#4-åˆå¹¶è¯·æ±‚Pipeline)
5. [å®šæ—¶Pipelineè®¾ç½®](#5-å®šæ—¶Pipelineè®¾ç½®)
6. [æ‰‹åŠ¨è§¦å‘é…ç½®](#6-æ‰‹åŠ¨è§¦å‘é…ç½®)
7. [æ¡ä»¶å˜é‡åˆ¤æ–­](#7-æ¡ä»¶å˜é‡åˆ¤æ–­)
8. [æ–‡ä»¶å˜åŒ–æ£€æµ‹](#8-æ–‡ä»¶å˜åŒ–æ£€æµ‹)
9. [å¤æ‚æ¡ä»¶ç»„åˆ](#9-å¤æ‚æ¡ä»¶ç»„åˆ)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ æ¡ä»¶æ‰§è¡ŒåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯æ¡ä»¶æ‰§è¡Œ


**é€šä¿—ç†è§£**ï¼šæ¡ä»¶æ‰§è¡Œå°±åƒç”Ÿæ´»ä¸­çš„"å¦‚æœ...é‚£ä¹ˆ..."é€»è¾‘

```
ç”Ÿæ´»ä¸­çš„ä¾‹å­ï¼š
å¦‚æœä¸‹é›¨ â†’ é‚£ä¹ˆå¸¦ä¼
å¦‚æœæ˜¯å‘¨æœ« â†’ é‚£ä¹ˆä¸ç”¨ä¸Šç­
å¦‚æœè€ƒè¯•åŠæ ¼ â†’ é‚£ä¹ˆå¯ä»¥æ¯•ä¸š

GitLab CI/CDä¸­ï¼š
å¦‚æœæ˜¯ä¸»åˆ†æ”¯ â†’ é‚£ä¹ˆè‡ªåŠ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
å¦‚æœæ˜¯å¼€å‘åˆ†æ”¯ â†’ é‚£ä¹ˆåªè¿è¡Œæµ‹è¯•
å¦‚æœæ–‡ä»¶æœ‰å˜åŒ– â†’ é‚£ä¹ˆé‡æ–°æ„å»º
```

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- **æ¡ä»¶æ‰§è¡Œ**ï¼šæ ¹æ®ç‰¹å®šæ¡ä»¶å†³å®šæ˜¯å¦è¿è¡ŒæŸä¸ªä»»åŠ¡
- **è§¦å‘æ¡ä»¶**ï¼šæ»¡è¶³ä»€ä¹ˆæƒ…å†µä¸‹æ‰æ‰§è¡Œ
- **æ‰§è¡Œç­–ç•¥**ï¼šå¦‚ä½•æ§åˆ¶ä»»åŠ¡çš„è¿è¡Œæ—¶æœº

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦æ¡ä»¶æ‰§è¡Œ


**å®é™…åœºæ™¯é—®é¢˜**ï¼š
```
æ²¡æœ‰æ¡ä»¶æ§åˆ¶çš„é—®é¢˜ï¼š
âŒ æ¯æ¬¡æäº¤éƒ½éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼ˆå¤ªå±é™©ï¼‰
âŒ æµ‹è¯•ä»£ç ä¹Ÿè§¦å‘æ­£å¼å‘å¸ƒï¼ˆæµªè´¹èµ„æºï¼‰
âŒ æ–‡æ¡£ä¿®æ”¹ä¹Ÿé‡æ–°ç¼–è¯‘æ•´ä¸ªé¡¹ç›®ï¼ˆæ•ˆç‡ä½ï¼‰

æœ‰äº†æ¡ä»¶æ§åˆ¶çš„å¥½å¤„ï¼š
âœ… åªæœ‰ç¨³å®šåˆ†æ”¯æ‰éƒ¨ç½²ç”Ÿäº§ç¯å¢ƒ
âœ… å¼€å‘åˆ†æ”¯åªè¿è¡Œæµ‹è¯•å’Œæ£€æŸ¥
âœ… æ ¹æ®æ–‡ä»¶å˜åŒ–æ™ºèƒ½é€‰æ‹©æ‰§è¡Œä»»åŠ¡
```

### 1.3 æ¡ä»¶æ‰§è¡Œçš„åŸºæœ¬è¯­æ³•


```yaml
# åŸºæœ¬æ¡ä»¶è¯­æ³•
job_name:
  script:
    - echo "æ‰§è¡Œä»»åŠ¡"
  rules:  # è§„åˆ™æ¡ä»¶
    - if: $CI_COMMIT_BRANCH == "main"  # å¦‚æœæ˜¯ä¸»åˆ†æ”¯
  # æˆ–è€…ä½¿ç”¨ only/exceptï¼ˆæ—§è¯­æ³•ï¼‰
  only:
    - main  # åªåœ¨mainåˆ†æ”¯æ‰§è¡Œ
```

**è¯­æ³•å¯¹æ¯”**ï¼š
```yaml
# æ–°è¯­æ³•ï¼ˆæ¨èï¼‰- æ›´çµæ´»å¼ºå¤§
rules:
  - if: $CI_COMMIT_BRANCH == "main"
    when: always
  - when: never

# æ—§è¯­æ³•ï¼ˆç®€å•åœºæ™¯ï¼‰- ç®€æ´æ˜“æ‡‚  
only:
  - main
except:
  - develop
```

---

## 2. ğŸŒ¿ åˆ†æ”¯ç‰¹å®šPipeline


### 2.1 åˆ†æ”¯ç­–ç•¥åŸºç¡€


**åˆ†æ”¯ç®¡ç†ç­–ç•¥**ï¼šä¸åŒåˆ†æ”¯æœ‰ä¸åŒçš„ç”¨é€”å’Œé‡è¦ç¨‹åº¦

```
å…¸å‹çš„Gitåˆ†æ”¯ç­–ç•¥ï¼š

main/masteråˆ†æ”¯
â”œâ”€â”€ ç”Ÿäº§ç¯å¢ƒä»£ç 
â”œâ”€â”€ æœ€ç¨³å®šçš„ç‰ˆæœ¬
â””â”€â”€ éœ€è¦ä¸¥æ ¼çš„éƒ¨ç½²æµç¨‹

developåˆ†æ”¯  
â”œâ”€â”€ å¼€å‘ç¯å¢ƒä»£ç 
â”œâ”€â”€ åŠŸèƒ½é›†æˆå’Œæµ‹è¯•
â””â”€â”€ å¯ä»¥è‡ªåŠ¨éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ

feature/*åˆ†æ”¯
â”œâ”€â”€ æ–°åŠŸèƒ½å¼€å‘
â”œâ”€â”€ ä¸ªäººå¼€å‘åˆ†æ”¯
â””â”€â”€ åªéœ€è¦åŸºæœ¬æµ‹è¯•
```

### 2.2 åˆ†æ”¯ç‰¹å®šé…ç½®


**ä¸ºä¸åŒåˆ†æ”¯è®¾ç½®ä¸åŒçš„Pipeline**ï¼š

```yaml
# ç”Ÿäº§ç¯å¢ƒéƒ¨ç½² - åªåœ¨mainåˆ†æ”¯
deploy_production:
  stage: deploy
  script:
    - echo "éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ"
    - kubectl apply -f production.yaml
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  environment:
    name: production
    url: https://myapp.com

# æµ‹è¯•ç¯å¢ƒéƒ¨ç½² - åªåœ¨developåˆ†æ”¯
deploy_staging:
  stage: deploy
  script:
    - echo "éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ"
    - kubectl apply -f staging.yaml
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
  environment:
    name: staging
    url: https://staging.myapp.com

# å¼€å‘ç¯å¢ƒ - åŠŸèƒ½åˆ†æ”¯
deploy_dev:
  stage: deploy
  script:
    - echo "éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ"
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^feature\/.*/  # æ­£åˆ™åŒ¹é…feature/å¼€å¤´çš„åˆ†æ”¯
```

### 2.3 åˆ†æ”¯ä¿æŠ¤ç­–ç•¥


**ä¿æŠ¤é‡è¦åˆ†æ”¯**ï¼š

```yaml
# å±é™©æ“ä½œåªèƒ½åœ¨ç‰¹å®šåˆ†æ”¯æ‰§è¡Œ
dangerous_deploy:
  script:
    - echo "æ‰§è¡Œæ•°æ®åº“è¿ç§»"
    - python manage.py migrate
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual  # éœ€è¦æ‰‹åŠ¨ç¡®è®¤
    - when: never   # å…¶ä»–åˆ†æ”¯æ°¸ä¸æ‰§è¡Œ

# ä¸åŒåˆ†æ”¯çš„æµ‹è¯•çº§åˆ«
comprehensive_tests:
  script:
    - echo "è¿è¡Œå…¨é‡æµ‹è¯•"
    - npm run test:all
  rules:
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"

basic_tests:
  script:
    - echo "è¿è¡ŒåŸºç¡€æµ‹è¯•"
    - npm run test:unit
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^feature\/.*/
```

---

## 3. ğŸ·ï¸ æ ‡ç­¾è§¦å‘éƒ¨ç½²


### 3.1 Gitæ ‡ç­¾çš„æ¦‚å¿µ


**æ ‡ç­¾æ˜¯ä»€ä¹ˆ**ï¼šæ ‡ç­¾å°±åƒä¹¦ç­¾ï¼Œæ ‡è®°ä»£ç çš„ç‰¹å®šç‰ˆæœ¬

```
Gitæ ‡ç­¾çš„ä½œç”¨ï¼š
ğŸ“Œ æ ‡è®°å‘å¸ƒç‰ˆæœ¬ï¼šv1.0.0, v2.1.3
ğŸ“Œ è®°å½•é‡è¦èŠ‚ç‚¹ï¼šhotfix-20240901
ğŸ“Œ è§¦å‘ç‰¹æ®Šæ“ä½œï¼šå‘å¸ƒã€éƒ¨ç½²ã€æ‰“åŒ…

å®é™…ä½¿ç”¨åœºæ™¯ï¼š
å¼€å‘å®Œæˆ â†’ æ‰“æ ‡ç­¾ â†’ è‡ªåŠ¨å‘å¸ƒ
```

**åˆ›å»ºæ ‡ç­¾çš„æ–¹å¼**ï¼š
```bash
# æœ¬åœ°æ‰“æ ‡ç­¾
git tag v1.0.0
git push origin v1.0.0

# æˆ–è€…åœ¨GitLabç•Œé¢æ“ä½œ
é¡¹ç›®é¡µé¢ â†’ Repository â†’ Tags â†’ New tag
```

### 3.2 æ ‡ç­¾è§¦å‘Pipeline


**åŸºäºæ ‡ç­¾çš„è‡ªåŠ¨éƒ¨ç½²**ï¼š

```yaml
# ç‰ˆæœ¬å‘å¸ƒ - åªåœ¨æ‰“æ ‡ç­¾æ—¶è§¦å‘
release_build:
  stage: build
  script:
    - echo "æ„å»ºå‘å¸ƒç‰ˆæœ¬ $CI_COMMIT_TAG"
    - docker build -t myapp:$CI_COMMIT_TAG .
    - docker push myapp:$CI_COMMIT_TAG
  rules:
    - if: $CI_COMMIT_TAG  # å½“å­˜åœ¨æ ‡ç­¾æ—¶æ‰§è¡Œ

# æ­£å¼ç‰ˆæœ¬å‘å¸ƒ - åªåœ¨ç‰ˆæœ¬å·æ ‡ç­¾æ—¶
production_release:
  stage: deploy
  script:
    - echo "å‘å¸ƒæ­£å¼ç‰ˆæœ¬"
    - helm upgrade --install myapp ./helm-chart --set image.tag=$CI_COMMIT_TAG
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/  # åŒ¹é… v1.2.3 æ ¼å¼
  environment:
    name: production

# é¢„å‘å¸ƒç‰ˆæœ¬ - betaæ ‡ç­¾
beta_release:
  stage: deploy
  script:
    - echo "å‘å¸ƒBetaç‰ˆæœ¬"
  rules:
    - if: $CI_COMMIT_TAG =~ /^v.*-beta$/  # åŒ¹é… v1.0.0-beta æ ¼å¼
```

### 3.3 è¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶


**ç‰ˆæœ¬å·è§„åˆ™**ï¼šä½¿ç”¨æ ‡å‡†çš„ç‰ˆæœ¬å·æ ¼å¼

```yaml
# ä¸åŒç±»å‹çš„ç‰ˆæœ¬å‘å¸ƒ
variables:
  MAJOR_VERSION: "ä¸»ç‰ˆæœ¬å·å˜åŒ–æ—¶"  # v1.0.0 â†’ v2.0.0
  MINOR_VERSION: "æ–°åŠŸèƒ½æ—¶"       # v1.0.0 â†’ v1.1.0  
  PATCH_VERSION: "Bugä¿®å¤æ—¶"      # v1.0.0 â†’ v1.0.1

# æ ¹æ®ç‰ˆæœ¬ç±»å‹æ‰§è¡Œä¸åŒæ“ä½œ
major_release:
  script:
    - echo "é‡å¤§ç‰ˆæœ¬å‘å¸ƒï¼Œéœ€è¦é¢å¤–æ£€æŸ¥"
    - run_migration_check.sh
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.0\.0$/

patch_release:
  script:
    - echo "è¡¥ä¸ç‰ˆæœ¬ï¼Œå¿«é€Ÿå‘å¸ƒ"
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.[1-9]\d*$/
```

---

## 4. ğŸ”€ åˆå¹¶è¯·æ±‚Pipeline


### 4.1 åˆå¹¶è¯·æ±‚çš„å·¥ä½œæµç¨‹


**ä»€ä¹ˆæ˜¯åˆå¹¶è¯·æ±‚ï¼ˆMerge Requestï¼‰**ï¼š

```
åˆå¹¶è¯·æ±‚æµç¨‹ï¼š
1. å¼€å‘è€…åœ¨featureåˆ†æ”¯å¼€å‘
2. æäº¤åˆå¹¶è¯·æ±‚åˆ°mainåˆ†æ”¯
3. è‡ªåŠ¨è§¦å‘Pipelineæ£€æŸ¥ä»£ç 
4. é€šè¿‡æ£€æŸ¥åæ‰èƒ½åˆå¹¶

è¿™æ ·åšçš„å¥½å¤„ï¼š
âœ… ä»£ç å®¡æŸ¥ï¼šå›¢é˜Ÿæˆå‘˜å¯ä»¥reviewä»£ç 
âœ… è‡ªåŠ¨æ£€æŸ¥ï¼šCI/CDè‡ªåŠ¨æµ‹è¯•ä»£ç è´¨é‡
âœ… ä¿æŠ¤ä¸»åˆ†æ”¯ï¼šé˜²æ­¢æœ‰é—®é¢˜çš„ä»£ç è¿›å…¥ä¸»åˆ†æ”¯
```

### 4.2 åˆå¹¶è¯·æ±‚Pipelineé…ç½®


**ä¸“é—¨ä¸ºåˆå¹¶è¯·æ±‚è®¾è®¡çš„Pipeline**ï¼š

```yaml
# åˆå¹¶è¯·æ±‚æ—¶çš„ä»£ç æ£€æŸ¥
mr_code_quality:
  stage: test
  script:
    - echo "æ£€æŸ¥ä»£ç è´¨é‡"
    - eslint src/
    - sonar-scanner
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  artifacts:
    reports:
      codequality: codequality.json

# åˆå¹¶è¯·æ±‚æ—¶çš„å®‰å…¨æ‰«æ
mr_security_scan:
  stage: test
  script:
    - echo "å®‰å…¨æ¼æ´æ‰«æ"
    - safety check
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# å†’çƒŸæµ‹è¯• - å¿«é€ŸéªŒè¯åŸºæœ¬åŠŸèƒ½
mr_smoke_test:
  stage: test
  script:
    - echo "è¿è¡Œå†’çƒŸæµ‹è¯•"
    - npm run test:smoke
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
```

### 4.3 åˆå¹¶è¯·æ±‚çŠ¶æ€æ§åˆ¶


**é˜»æ­¢æœ‰é—®é¢˜çš„ä»£ç åˆå¹¶**ï¼š

```yaml
# å¿…é¡»é€šè¿‡çš„æ£€æŸ¥
required_checks:
  stage: test
  script:
    - echo "æ‰§è¡Œå¿…è¦æ£€æŸ¥"
    - npm test
    - npm run lint
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  allow_failure: false  # ä¸å…è®¸å¤±è´¥

# å¯é€‰çš„æ£€æŸ¥
optional_checks:
  stage: test
  script:
    - echo "æ‰§è¡Œå¯é€‰æ£€æŸ¥"
    - npm run test:performance
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  allow_failure: true   # å…è®¸å¤±è´¥
```

**åœ¨GitLabè®¾ç½®ä¸­é…ç½®**ï¼š
```
é¡¹ç›®è®¾ç½® â†’ General â†’ Merge requests
â˜‘ï¸ Pipelines must succeed
â˜‘ï¸ All discussions must be resolved
```

---

## 5. â° å®šæ—¶Pipelineè®¾ç½®


### 5.1 ä¸ºä»€ä¹ˆéœ€è¦å®šæ—¶ä»»åŠ¡


**å®šæ—¶Pipelineçš„åº”ç”¨åœºæ™¯**ï¼š

```
æ—¥å¸¸ç»´æŠ¤ä»»åŠ¡ï¼š
ğŸ• æ¯å¤©å‡Œæ™¨ï¼šæ•°æ®åº“å¤‡ä»½
ğŸ• æ¯å‘¨ä¸€ï¼šå®‰å…¨æ‰«æ
ğŸ• æ¯æœˆæœ«ï¼šç”Ÿæˆç»Ÿè®¡æŠ¥å‘Š

æŒç»­ç›‘æ§ï¼š
ğŸ” æ¯å°æ—¶ï¼šå¥åº·æ£€æŸ¥
ğŸ” æ¯å¤©ï¼šä¾èµ–åº“æ›´æ–°æ£€æŸ¥
ğŸ” æ¯å‘¨ï¼šæ€§èƒ½æµ‹è¯•
```

### 5.2 è®¾ç½®å®šæ—¶è§¦å‘


**åœ¨GitLabç•Œé¢è®¾ç½®å®šæ—¶Pipeline**ï¼š

```
æ­¥éª¤ï¼š
1. é¡¹ç›®é¡µé¢ â†’ CI/CD â†’ Schedules
2. ç‚¹å‡» "New schedule"
3. è®¾ç½®æè¿°ï¼šå¦‚ "æ¯æ—¥å¤‡ä»½"
4. è®¾ç½®Cronè¡¨è¾¾å¼ï¼šå¦‚ "0 2 * * *"ï¼ˆæ¯å¤©å‡Œæ™¨2ç‚¹ï¼‰
5. é€‰æ‹©ç›®æ ‡åˆ†æ”¯ï¼šé€šå¸¸æ˜¯main
6. ä¿å­˜è®¾ç½®
```

**Cronè¡¨è¾¾å¼å¿«é€Ÿå…¥é—¨**ï¼š
```
æ ¼å¼ï¼šåˆ† æ—¶ æ—¥ æœˆ å‘¨
ç¤ºä¾‹ï¼š
0 2 * * *     # æ¯å¤©å‡Œæ™¨2ç‚¹
0 9 * * 1     # æ¯å‘¨ä¸€ä¸Šåˆ9ç‚¹  
0 0 1 * *     # æ¯æœˆ1å·å‡Œæ™¨
0 */6 * * *   # æ¯6å°æ—¶ä¸€æ¬¡
```

### 5.3 å®šæ—¶ä»»åŠ¡Pipelineé…ç½®


```yaml
# æ•°æ®åº“å¤‡ä»½ä»»åŠ¡
backup_database:
  stage: maintenance
  script:
    - echo "å¼€å§‹æ•°æ®åº“å¤‡ä»½"
    - pg_dump myapp > backup_$(date +%Y%m%d).sql
    - aws s3 cp backup_*.sql s3://myapp-backups/
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      variables:
        TASK_TYPE: "backup"
  only:
    variables:
      - $TASK_TYPE == "backup"

# å®‰å…¨æ‰«æä»»åŠ¡
security_audit:
  stage: security
  script:
    - echo "æ‰§è¡Œå®‰å…¨å®¡è®¡"
    - nmap -sV myapp.com
    - npm audit
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      variables:
        TASK_TYPE: "security"

# æ€§èƒ½æµ‹è¯•
performance_test:
  stage: test
  script:
    - echo "è¿è¡Œæ€§èƒ½æµ‹è¯•"
    - k6 run performance-test.js
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      variables:
        TASK_TYPE: "performance"
```

---

## 6. ğŸ–±ï¸ æ‰‹åŠ¨è§¦å‘é…ç½®


### 6.1 æ‰‹åŠ¨è§¦å‘çš„ä½¿ç”¨åœºæ™¯


**ä»€ä¹ˆæ—¶å€™éœ€è¦æ‰‹åŠ¨è§¦å‘**ï¼š

```
é«˜é£é™©æ“ä½œï¼š
ğŸš¨ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
ğŸš¨ æ•°æ®åº“è¿ç§»
ğŸš¨ ç³»ç»Ÿç»´æŠ¤

ä¸´æ—¶éœ€æ±‚ï¼š
âš¡ ç´§æ€¥ä¿®å¤éƒ¨ç½²
âš¡ ç‰¹æ®Šæµ‹è¯•æ‰§è¡Œ
âš¡ ä¸€æ¬¡æ€§æ•°æ®å¤„ç†
```

### 6.2 æ‰‹åŠ¨è§¦å‘é…ç½®


```yaml
# æ‰‹åŠ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
manual_production_deploy:
  stage: deploy
  script:
    - echo "æ‰‹åŠ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ"
    - kubectl apply -f production.yaml
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual  # éœ€è¦æ‰‹åŠ¨ç‚¹å‡»æ‰æ‰§è¡Œ
  environment:
    name: production

# æ•°æ®åº“ç»´æŠ¤ä»»åŠ¡
database_maintenance:
  stage: maintenance
  script:
    - echo "æ‰§è¡Œæ•°æ®åº“ç»´æŠ¤"
    - python manage.py cleanup_old_data
  when: manual
  allow_failure: false

# å¯é€‰çš„æ‰‹åŠ¨ä»»åŠ¡
optional_manual_task:
  stage: deploy
  script:
    - echo "å¯é€‰çš„éƒ¨ç½²ä»»åŠ¡"
  when: manual
  allow_failure: true  # å³ä½¿ä¸æ‰§è¡Œä¹Ÿä¸å½±å“PipelineæˆåŠŸ
```

### 6.3 æ‰‹åŠ¨è§¦å‘çš„ç•Œé¢æ“ä½œ


**å¦‚ä½•æ‰‹åŠ¨è§¦å‘ä»»åŠ¡**ï¼š

```
åœ¨GitLabç•Œé¢ï¼š
1. è¿›å…¥é¡¹ç›®çš„ CI/CD â†’ Pipelines
2. æ‰¾åˆ°å¯¹åº”çš„Pipeline
3. ç‚¹å‡»æ‰‹åŠ¨ä»»åŠ¡æ—è¾¹çš„"æ’­æ”¾"æŒ‰é’®
4. ç¡®è®¤æ‰§è¡Œ

æˆ–è€…ï¼š
1. åœ¨Pipelineè¯¦æƒ…é¡µé¢
2. æ‰¾åˆ°æ ‡è®°ä¸º"manual"çš„ä»»åŠ¡
3. ç‚¹å‡»ä»»åŠ¡åç§°
4. ç‚¹å‡»"Run job"æŒ‰é’®
```

---

## 7. ğŸ”§ æ¡ä»¶å˜é‡åˆ¤æ–­


### 7.1 GitLab CI/CDå˜é‡åŸºç¡€


**å†…ç½®å˜é‡**ï¼šGitLabè‡ªåŠ¨æä¾›çš„ç¯å¢ƒä¿¡æ¯

```yaml
# å¸¸ç”¨çš„å†…ç½®å˜é‡
variables:
  # åˆ†æ”¯ç›¸å…³
  - $CI_COMMIT_BRANCH      # å½“å‰åˆ†æ”¯å
  - $CI_DEFAULT_BRANCH     # é»˜è®¤åˆ†æ”¯åï¼ˆé€šå¸¸æ˜¯mainï¼‰
  - $CI_COMMIT_TAG         # æ ‡ç­¾å
  
  # é¡¹ç›®ç›¸å…³  
  - $CI_PROJECT_NAME       # é¡¹ç›®åç§°
  - $CI_PROJECT_PATH       # é¡¹ç›®è·¯å¾„
  
  # Pipelineç›¸å…³
  - $CI_PIPELINE_SOURCE    # è§¦å‘æ¥æº
  - $CI_JOB_STAGE         # å½“å‰é˜¶æ®µå
```

### 7.2 è‡ªå®šä¹‰å˜é‡æ¡ä»¶åˆ¤æ–­


```yaml
# é¡¹ç›®çº§å˜é‡è®¾ç½®
variables:
  DEPLOY_ENVIRONMENT: "staging"
  ENABLE_TESTS: "true"
  
# åŸºäºè‡ªå®šä¹‰å˜é‡çš„æ¡ä»¶
conditional_deploy:
  script:
    - echo "éƒ¨ç½²åˆ° $DEPLOY_ENVIRONMENT ç¯å¢ƒ"
  rules:
    - if: $DEPLOY_ENVIRONMENT == "production"
      when: manual
    - if: $DEPLOY_ENVIRONMENT == "staging"
      when: always

# åŠŸèƒ½å¼€å…³
feature_tests:
  script:
    - echo "è¿è¡ŒåŠŸèƒ½æµ‹è¯•"
    - npm run test:features
  rules:
    - if: $ENABLE_TESTS == "true"

# ç¯å¢ƒç‰¹å®šçš„é…ç½®
environment_setup:
  script:
    - |
      if [ "$DEPLOY_ENVIRONMENT" = "production" ]; then
        echo "é…ç½®ç”Ÿäº§ç¯å¢ƒ"
        cp config.prod.json config.json
      else
        echo "é…ç½®å¼€å‘ç¯å¢ƒ"  
        cp config.dev.json config.json
      fi
  rules:
    - if: $DEPLOY_ENVIRONMENT
```

### 7.3 å¤æ‚å˜é‡æ¡ä»¶


```yaml
# å¤šæ¡ä»¶ç»„åˆ
complex_conditions:
  script:
    - echo "æ‰§è¡Œå¤æ‚æ¡ä»¶ä»»åŠ¡"
  rules:
    # ç”Ÿäº§åˆ†æ”¯ä¸”æœ‰æ ‡ç­¾
    - if: $CI_COMMIT_BRANCH == "main" && $CI_COMMIT_TAG
      variables:
        DEPLOY_TYPE: "release"
    # å¼€å‘åˆ†æ”¯
    - if: $CI_COMMIT_BRANCH == "develop"
      variables:
        DEPLOY_TYPE: "staging"
    # å…¶ä»–æƒ…å†µä¸æ‰§è¡Œ
    - when: never

# å˜é‡ä¸ºç©ºçš„åˆ¤æ–­
check_required_vars:
  script:
    - echo "æ£€æŸ¥å¿…è¦å˜é‡"
  rules:
    - if: $REQUIRED_VAR == null
      when: never
    - when: always
```

---

## 8. ğŸ“ æ–‡ä»¶å˜åŒ–æ£€æµ‹


### 8.1 ä¸ºä»€ä¹ˆéœ€è¦æ–‡ä»¶å˜åŒ–æ£€æµ‹


**ä¼˜åŒ–Pipelineæ‰§è¡Œæ•ˆç‡**ï¼š

```
é—®é¢˜åœºæ™¯ï¼š
ğŸ“ åªä¿®æ”¹äº†READMEæ–‡æ¡£ â†’ ä¸éœ€è¦é‡æ–°ç¼–è¯‘ä»£ç 
ğŸ¨ åªæ”¹äº†CSSæ ·å¼ â†’ ä¸éœ€è¦é‡æ–°è¿è¡Œåç«¯æµ‹è¯•
ğŸ“Š åªæ›´æ–°äº†æ•°æ®åº“é…ç½® â†’ å‰ç«¯ä¸éœ€è¦é‡æ–°æ„å»º

è§£å†³æ–¹æ¡ˆï¼š
âœ… æ£€æµ‹æ–‡ä»¶å˜åŒ–
âœ… åªè¿è¡Œç›¸å…³çš„ä»»åŠ¡
âœ… èŠ‚çœæ—¶é—´å’Œèµ„æº
```

### 8.2 åŸºæœ¬æ–‡ä»¶å˜åŒ–æ£€æµ‹


```yaml
# å‰ç«¯ä»£ç å˜åŒ–æ—¶æ‰æ„å»ºå‰ç«¯
frontend_build:
  stage: build
  script:
    - echo "æ„å»ºå‰ç«¯ä»£ç "
    - npm run build
  rules:
    - changes:
        - "frontend/**/*"      # frontendç›®å½•ä¸‹ä»»ä½•æ–‡ä»¶å˜åŒ–
        - "package.json"       # ä¾èµ–æ–‡ä»¶å˜åŒ–
        - "webpack.config.js"  # æ„å»ºé…ç½®å˜åŒ–

# åç«¯ä»£ç å˜åŒ–æ—¶æ‰è¿è¡Œåç«¯æµ‹è¯•
backend_test:
  stage: test
  script:
    - echo "è¿è¡Œåç«¯æµ‹è¯•"
    - python -m pytest
  rules:
    - changes:
        - "backend/**/*.py"    # Pythonæ–‡ä»¶å˜åŒ–
        - "requirements.txt"   # ä¾èµ–å˜åŒ–
        - "pytest.ini"        # æµ‹è¯•é…ç½®å˜åŒ–

# æ•°æ®åº“ç›¸å…³æ–‡ä»¶å˜åŒ–æ—¶æ‰§è¡Œè¿ç§»æ£€æŸ¥
database_check:
  stage: test
  script:
    - echo "æ£€æŸ¥æ•°æ®åº“è¿ç§»"
    - python manage.py check --deploy
  rules:
    - changes:
        - "migrations/**/*"
        - "models.py"
```

### 8.3 ç²¾ç¡®çš„æ–‡ä»¶åŒ¹é…


```yaml
# ä½¿ç”¨é€šé…ç¬¦åŒ¹é…
docker_build:
  script:
    - docker build .
  rules:
    - changes:
        - "Dockerfile*"        # åŒ¹é… Dockerfile, Dockerfile.prod ç­‰
        - "docker-compose*.yml" # åŒ¹é…ç›¸å…³çš„composeæ–‡ä»¶
        - "requirements.txt"

# æ’é™¤æŸäº›æ–‡ä»¶
code_quality:
  script:
    - echo "ä»£ç è´¨é‡æ£€æŸ¥"
    - eslint src/
  rules:
    - changes:
        - "src/**/*.js"
        - "src/**/*.ts"
      if: $CI_PIPELINE_SOURCE != "schedule"  # æ’é™¤å®šæ—¶ä»»åŠ¡

# æ–‡æ¡£å˜åŒ–æ—¶çš„ç‰¹æ®Šå¤„ç†
docs_deploy:
  script:
    - echo "éƒ¨ç½²æ–‡æ¡£"
    - mkdocs build
    - rsync -av site/ docs-server:/var/www/docs/
  rules:
    - changes:
        - "docs/**/*"
        - "mkdocs.yml"
```

---

## 9. ğŸ­ å¤æ‚æ¡ä»¶ç»„åˆ


### 9.1 å¤šæ¡ä»¶é€»è¾‘ç»„åˆ


**ç»„åˆä¸åŒç±»å‹çš„æ¡ä»¶**ï¼š

```yaml
# å¤åˆæ¡ä»¶ç¤ºä¾‹
sophisticated_deploy:
  stage: deploy
  script:
    - echo "æ‰§è¡Œå¤æ‚éƒ¨ç½²é€»è¾‘"
  rules:
    # æ¡ä»¶1ï¼šä¸»åˆ†æ”¯ + æœ‰æ ‡ç­¾ + æ‰‹åŠ¨è§¦å‘
    - if: $CI_COMMIT_BRANCH == "main" && $CI_COMMIT_TAG && $CI_PIPELINE_SOURCE == "web"
      when: always
      variables:
        DEPLOY_ENV: "production"
    
    # æ¡ä»¶2ï¼šå¼€å‘åˆ†æ”¯ + æ–‡ä»¶å˜åŒ–
    - if: $CI_COMMIT_BRANCH == "develop"
      changes:
        - "src/**/*"
        - "config/**/*"
      variables:
        DEPLOY_ENV: "staging"
    
    # æ¡ä»¶3ï¼šåˆå¹¶è¯·æ±‚ + ç‰¹å®šæ ‡ç­¾
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_LABELS =~ /deploy/
      variables:
        DEPLOY_ENV: "review"
    
    # é»˜è®¤æƒ…å†µï¼šä¸æ‰§è¡Œ
    - when: never
```

### 9.2 æ¡ä»¶æ¨¡æ¿åŒ–


**åˆ›å»ºå¯å¤ç”¨çš„æ¡ä»¶æ¨¡æ¿**ï¼š

```yaml
# å®šä¹‰æ¡ä»¶æ¨¡æ¿
.production_rules: &production_rules
  rules:
    - if: $CI_COMMIT_BRANCH == "main" && $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
      when: manual
    - when: never

.staging_rules: &staging_rules
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
      when: always
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: always
    - when: never

# ä½¿ç”¨æ¨¡æ¿
production_deploy:
  stage: deploy
  script:
    - echo "ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²"
  <<: *production_rules
  environment:
    name: production

staging_deploy:
  stage: deploy
  script:
    - echo "æµ‹è¯•ç¯å¢ƒéƒ¨ç½²"
  <<: *staging_rules
  environment:
    name: staging
```

### 9.3 åŠ¨æ€æ¡ä»¶åˆ¤æ–­


```yaml
# åŸºäºPipelineå˜é‡çš„åŠ¨æ€æ¡ä»¶
dynamic_job:
  stage: deploy
  script:
    - |
      # åœ¨è„šæœ¬ä¸­è¿›è¡Œå¤æ‚åˆ¤æ–­
      if [[ "$CI_COMMIT_BRANCH" == "main" ]]; then
        if [[ -n "$CI_COMMIT_TAG" ]]; then
          echo "æ‰§è¡Œç”Ÿäº§éƒ¨ç½²"
          deploy_to_production.sh
        else
          echo "ä¸»åˆ†æ”¯ä½†æ— æ ‡ç­¾ï¼Œæ‰§è¡Œé¢„ç”Ÿäº§éƒ¨ç½²"
          deploy_to_preprod.sh
        fi
      elif [[ "$CI_COMMIT_BRANCH" == "develop" ]]; then
        echo "æ‰§è¡Œå¼€å‘ç¯å¢ƒéƒ¨ç½²"
        deploy_to_dev.sh
      else
        echo "åŠŸèƒ½åˆ†æ”¯ï¼Œåªè¿è¡Œæµ‹è¯•"
        run_tests.sh
      fi
  rules:
    - if: $CI_COMMIT_BRANCH =~ /^(main|develop|feature\/.*)$/

# åŸºäºå¤–éƒ¨APIçš„æ¡ä»¶åˆ¤æ–­
api_condition_job:
  stage: deploy
  script:
    - |
      # è°ƒç”¨å¤–éƒ¨APIæ£€æŸ¥éƒ¨ç½²æƒé™
      PERMISSION=$(curl -s "https://api.company.com/deploy-permission?branch=$CI_COMMIT_BRANCH")
      if [[ "$PERMISSION" == "allowed" ]]; then
        echo "æœ‰éƒ¨ç½²æƒé™ï¼Œå¼€å§‹éƒ¨ç½²"
        deploy.sh
      else
        echo "æ— éƒ¨ç½²æƒé™ï¼Œè·³è¿‡éƒ¨ç½²"
        exit 0
      fi
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 æ¡ä»¶æ‰§è¡Œçš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ¡ä»¶æ‰§è¡Œï¼šæ ¹æ®ç‰¹å®šæ¡ä»¶å†³å®šä»»åŠ¡æ˜¯å¦è¿è¡Œ
ğŸ”¸ åˆ†æ”¯ç­–ç•¥ï¼šä¸åŒåˆ†æ”¯æ‰§è¡Œä¸åŒçš„Pipelineé€»è¾‘
ğŸ”¸ æ ‡ç­¾è§¦å‘ï¼šä½¿ç”¨Gitæ ‡ç­¾è§¦å‘ç‰¹å®šçš„éƒ¨ç½²æµç¨‹
ğŸ”¸ åˆå¹¶è¯·æ±‚ï¼šåœ¨ä»£ç åˆå¹¶å‰è¿›è¡Œè‡ªåŠ¨åŒ–æ£€æŸ¥
ğŸ”¸ å®šæ—¶ä»»åŠ¡ï¼šå®šæœŸæ‰§è¡Œç»´æŠ¤å’Œç›‘æ§ä»»åŠ¡
ğŸ”¸ æ‰‹åŠ¨è§¦å‘ï¼šé«˜é£é™©æ“ä½œéœ€è¦äººå·¥ç¡®è®¤
ğŸ”¸ æ–‡ä»¶æ£€æµ‹ï¼šæ ¹æ®æ–‡ä»¶å˜åŒ–æ™ºèƒ½é€‰æ‹©æ‰§è¡Œä»»åŠ¡
```

### 10.2 å…³é”®è¯­æ³•å¯¹æ¯”


| **è¯­æ³•ç±»å‹** | **é€‚ç”¨åœºæ™¯** | **ä¼˜åŠ¿** | **ç¤ºä¾‹** |
|-------------|-------------|---------|---------|
| `rules` | å¤æ‚æ¡ä»¶åˆ¤æ–­ | çµæ´»å¼ºå¤§ï¼Œæ”¯æŒå¤šç§æ¡ä»¶ç»„åˆ | `if: $CI_COMMIT_BRANCH == "main"` |
| `only/except` | ç®€å•åˆ†æ”¯æ§åˆ¶ | è¯­æ³•ç®€æ´ï¼Œæ˜“äºç†è§£ | `only: [main, develop]` |
| `changes` | æ–‡ä»¶å˜åŒ–æ£€æµ‹ | ä¼˜åŒ–æ‰§è¡Œæ•ˆç‡ï¼ŒèŠ‚çœèµ„æº | `changes: ["src/**/*"]` |
| `when` | æ‰§è¡Œæ—¶æœºæ§åˆ¶ | æ§åˆ¶ä»»åŠ¡æ‰§è¡Œæ–¹å¼ | `when: manual` |

### 10.3 æœ€ä½³å®è·µå»ºè®®


**ğŸ¯ åˆ†æ”¯ç®¡ç†**ï¼š
```
âœ… ç”Ÿäº§åˆ†æ”¯ä½¿ç”¨æ‰‹åŠ¨éƒ¨ç½²
âœ… å¼€å‘åˆ†æ”¯å¯ä»¥è‡ªåŠ¨éƒ¨ç½²
âœ… åŠŸèƒ½åˆ†æ”¯åªè¿è¡Œæµ‹è¯•
âœ… ä½¿ç”¨åˆ†æ”¯ä¿æŠ¤è§„åˆ™
```

**ğŸ¯ æ€§èƒ½ä¼˜åŒ–**ï¼š
```
âœ… ä½¿ç”¨æ–‡ä»¶å˜åŒ–æ£€æµ‹å‡å°‘ä¸å¿…è¦çš„æ„å»º
âœ… åˆç†è®¾ç½®ç¼“å­˜ç­–ç•¥
âœ… é¿å…åœ¨æ‰€æœ‰åˆ†æ”¯éƒ½è¿è¡Œé‡å‹ä»»åŠ¡
âœ… ä½¿ç”¨å¹¶è¡Œæ‰§è¡Œæé«˜æ•ˆç‡
```

**ğŸ¯ å®‰å…¨è€ƒè™‘**ï¼š
```
âœ… æ•æ„Ÿæ“ä½œéœ€è¦æ‰‹åŠ¨ç¡®è®¤
âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²éœ€è¦å®¡æ‰¹æµç¨‹
âœ… ä½¿ç”¨ç¯å¢ƒå˜é‡ç®¡ç†æ•æ„Ÿä¿¡æ¯
âœ… å®šæœŸè¿›è¡Œå®‰å…¨æ‰«æ
```

### 10.4 å¸¸è§é—®é¢˜è§£å†³


**â“ é—®é¢˜1ï¼šæ¡ä»¶ä¸ç”Ÿæ•ˆ**
```yaml
# é”™è¯¯å†™æ³•
rules:
  - if: $CI_COMMIT_BRANCH = "main"  # å•ä¸ªç­‰å·

# æ­£ç¡®å†™æ³•  
rules:
  - if: $CI_COMMIT_BRANCH == "main"  # åŒç­‰å·
```

**â“ é—®é¢˜2ï¼šæ–‡ä»¶æ£€æµ‹ä¸å‡†ç¡®**
```yaml
# é—®é¢˜ï¼šè·¯å¾„ä¸å¯¹
changes:
  - "frontend/*"      # åªåŒ¹é…ä¸€å±‚

# è§£å†³ï¼šä½¿ç”¨é€’å½’åŒ¹é…
changes:
  - "frontend/**/*"   # åŒ¹é…æ‰€æœ‰å­ç›®å½•
```

**â“ é—®é¢˜3ï¼šæ‰‹åŠ¨ä»»åŠ¡è¢«è·³è¿‡**
```yaml
# é—®é¢˜ï¼šæ¡ä»¶ä¸æ»¡è¶³æ—¶è·³è¿‡
rules:
  - if: $CI_COMMIT_BRANCH == "main"
    when: manual

# è§£å†³ï¼šæ·»åŠ é»˜è®¤è§„åˆ™
rules:
  - if: $CI_COMMIT_BRANCH == "main"
    when: manual
  - when: never  # å…¶ä»–æƒ…å†µä¸æ‰§è¡Œ
```

### 10.5 å®é™…åº”ç”¨åœºæ™¯æ€»ç»“


**ğŸ”§ å¼€å‘æµç¨‹**ï¼š
- **åŠŸèƒ½å¼€å‘**ï¼šfeatureåˆ†æ”¯åªè¿è¡ŒåŸºæœ¬æµ‹è¯•
- **é›†æˆæµ‹è¯•**ï¼šdevelopåˆ†æ”¯è‡ªåŠ¨éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
- **ç”Ÿäº§å‘å¸ƒ**ï¼šmainåˆ†æ”¯æ‰“æ ‡ç­¾åæ‰‹åŠ¨éƒ¨ç½²

**â° ç»´æŠ¤ä»»åŠ¡**ï¼š
- **æ—¥å¸¸å¤‡ä»½**ï¼šæ¯å¤©è‡ªåŠ¨æ‰§è¡Œæ•°æ®å¤‡ä»½
- **å®‰å…¨æ‰«æ**ï¼šæ¯å‘¨è¿›è¡Œå®‰å…¨æ¼æ´æ£€æŸ¥
- **æ€§èƒ½ç›‘æ§**ï¼šå®šæœŸè¿è¡Œæ€§èƒ½æµ‹è¯•

**ğŸš€ éƒ¨ç½²ç­–ç•¥**ï¼š
- **è“ç»¿éƒ¨ç½²**ï¼šä½¿ç”¨æ¡ä»¶æ§åˆ¶æµé‡åˆ‡æ¢
- **é‡‘ä¸é›€å‘å¸ƒ**ï¼šåŸºäºå˜é‡æ§åˆ¶å‘å¸ƒæ¯”ä¾‹
- **å›æ»šæœºåˆ¶**ï¼šæ£€æµ‹åˆ°é—®é¢˜æ—¶è‡ªåŠ¨å›æ»š

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- æ¡ä»¶æ‰§è¡Œæ™ºèƒ½æ§ï¼Œåˆ†æ”¯æ ‡ç­¾å„ä¸åŒ
- æ‰‹åŠ¨è§¦å‘ä¿å®‰å…¨ï¼Œæ–‡ä»¶æ£€æµ‹çœèµ„æº
- è§„åˆ™è¯­æ³•è¦è®°ç‰¢ï¼Œå®è·µåº”ç”¨è§çœŸç« 