---
title: 3、GitLab Runner安装与注册
---
## 📚 目录

1. [GitLab Runner基础认知](#1-gitlab-runner基础认知)
2. [Runner类型深度解析](#2-runner类型深度解析)
3. [Linux环境安装实战](#3-linux环境安装实战)
4. [Runner注册详细流程](#4-runner注册详细流程)
5. [Executor执行器选择指南](#5-executor执行器选择指南)
6. [配置文件管理与维护](#6-配置文件管理与维护)
7. [Runner运维实践](#7-runner运维实践)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🤖 GitLab Runner基础认知


### 1.1 什么是GitLab Runner


**🔸 通俗理解**
```
想象一下：
你写好了代码推送到GitLab，但代码需要自动测试、编译、部署
就像工厂需要工人来生产产品一样
GitLab Runner就是这个"数字工人"

GitLab (老板) → 发布任务 → Runner (工人) → 执行任务 → 返回结果
```

**🎯 核心定义**
- **本质**：GitLab Runner是一个**独立的程序**，专门用来执行CI/CD任务
- **作用**：接收GitLab发来的任务，在指定环境中执行，然后把结果反馈回去
- **比喻**：就像是GitLab的"外包工人"，专门干活但不住在GitLab里

### 1.2 Runner的工作机制


**📋 工作流程图示**
```
GitLab Server                    GitLab Runner
     |                               |
     |--[1]发布新任务 job----------->|
     |   (测试、构建、部署等)          |
     |                               |--[2]拉取代码
     |                               |--[3]执行脚本
     |                               |--[4]生成结果
     |<--[5]返回执行结果--------------|
     |   (成功/失败 + 日志)           |
```

**💡 关键理解点**
- Runner **主动向GitLab询问**有没有新任务（轮询机制）
- GitLab **不会主动推送**任务给Runner
- 一个GitLab可以有**多个Runner**同时工作
- Runner可以安装在**任何地方**（自己电脑、服务器、云端）

---

## 2. 🏷️ Runner类型深度解析


### 2.1 Shared Runner vs Specific Runner


**🌐 Shared Runner（共享型）**
```
特点说明：
┌─────────────────────────────────────┐
│              GitLab                 │
├─────────────────────────────────────┤
│  项目A   项目B   项目C   项目D      │
│    |       |       |       |       │
│    └───────┼───────┼───────┘       │
│            │       │               │
└────────────┼───────┼───────────────┘
             │       │
        ┌────▼───────▼────┐
        │  Shared Runner  │
        │   (公共工人)    │
        └─────────────────┘
```

**优势**：
- 🔸 **资源共享**：多个项目共用一个Runner，节省资源
- 🔸 **管理简单**：管理员统一维护，开发者无需关心
- 🔸 **快速启动**：新项目立即可用，无需额外配置

**劣势**：
- ❌ **排队等待**：忙时需要排队，执行速度可能较慢
- ❌ **安全限制**：不能执行需要特殊权限的任务
- ❌ **环境限制**：无法定制特殊的执行环境

**🎯 Specific Runner（专用型）**
```
专用模式：
┌─────────────────┐    ┌─────────────────┐
│     项目A       │    │     项目B       │
│                 │    │                 │
│       |         │    │       |         │
└───────┼─────────┘    └───────┼─────────┘
        │                      │
   ┌────▼────┐            ┌────▼────┐
   │Runner-A │            │Runner-B │
   │(专属工人)│            │(专属工人)│
   └─────────┘            └─────────┘
```

**优势**：
- ✅ **独享资源**：不用排队，执行速度快
- ✅ **环境定制**：可以安装项目特需的软件和环境
- ✅ **安全隔离**：可以访问内网资源，执行敏感操作

**劣势**：
- 💰 **成本较高**：需要独立的服务器资源
- 🔧 **维护复杂**：需要自己管理和维护

### 2.2 如何选择Runner类型


| 场景 | **推荐类型** | **理由说明** |
|------|-------------|-------------|
| 🎓 **学习测试** | `Shared Runner` | `免费使用，快速上手` |
| 🏢 **企业项目** | `Specific Runner` | `性能稳定，安全可控` |
| 🔒 **内网部署** | `Specific Runner` | `需要访问内网资源` |
| 🚀 **高频构建** | `Specific Runner` | `避免排队，提升效率` |

---

## 3. 💻 Linux环境安装实战


### 3.1 安装前的准备工作


**🔧 环境检查清单**
- ✅ **操作系统**：Ubuntu 16.04+ 或 CentOS 7+
- ✅ **网络连接**：确保能访问GitLab服务器
- ✅ **权限要求**：root权限或sudo权限
- ✅ **存储空间**：至少2GB可用空间

**📋 获取安装信息**
```
需要准备的信息：
1. GitLab服务器地址：https://gitlab.example.com
2. Registration Token：在GitLab项目设置中获取
3. Runner标签：给Runner打标签，方便识别
```

### 3.2 Ubuntu/Debian安装步骤


**第一步：下载官方安装脚本**
```bash
# 添加GitLab官方仓库
curl -L "https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.deb.sh" | sudo bash
```

**第二步：安装GitLab Runner**
```bash
# 安装最新版本
sudo apt-get install gitlab-runner

# 验证安装是否成功
gitlab-runner --version
```

**🎯 安装结果验证**
```
成功输出示例：
Version:      15.11.0
Git revision: 436955cb
Git branch:   15-11-stable
GO version:   go1.19.8
Built:        2023-04-22T09:36:42+0000
OS/Arch:      linux/amd64
```

### 3.3 CentOS/RHEL安装步骤


**第一步：添加官方仓库**
```bash
# 添加GitLab Runner仓库
curl -L "https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.rpm.sh" | sudo bash
```

**第二步：安装运行器**
```bash
# 使用yum安装
sudo yum install gitlab-runner

# 检查服务状态
sudo systemctl status gitlab-runner
```

### 3.4 常见安装问题解决


**❌ 问题1：网络连接超时**
```
解决方案：
• 检查防火墙设置
• 使用国内镜像源
• 配置代理服务器
```

**❌ 问题2：权限不足**
```
解决方案：
• 确保使用sudo权限
• 检查用户组设置
• 避免使用root用户直接安装
```

---

## 4. 🔐 Runner注册详细流程


### 4.1 注册前的信息收集


**📋 必需信息清单**
```
需要从GitLab获取：
┌─────────────────────────────────────────┐
│ GitLab项目 → Settings → CI/CD           │
│ ↓                                       │
│ Runners section → Expand                │
│ ↓                                       │
│ 复制以下信息：                          │
│ • GitLab URL: https://gitlab.xxx.com    │
│ • Registration Token: glrt-xxxxxxxxxxxx │
└─────────────────────────────────────────┘
```

### 4.2 交互式注册流程


**🚀 启动注册命令**
```bash
# 开始注册过程
sudo gitlab-runner register
```

**📝 注册对话流程**
```
系统提示                          你的输入示例
─────────────────────────────────────────────────
Enter GitLab instance URL:    →  https://gitlab.example.com
Enter registration token:     →  glrt-xxxxxxxxxxxxxxxxx
Enter description:            →  我的第一个Runner
Enter tags:                   →  test,build,deploy
Enter executor:               →  shell
```

### 4.3 注册参数详细说明


**🔸 GitLab URL**
- **作用**：告诉Runner去哪里领取任务
- **格式**：完整的GitLab服务器地址
- **示例**：`https://gitlab.com` 或 `https://your-gitlab.com`

**🔸 Registration Token**
- **作用**：身份验证令牌，证明你有权限注册Runner
- **获取位置**：项目设置 → CI/CD → Runners
- **安全提示**：这个Token很重要，不要泄露给别人

**🔸 Description（描述）**
- **作用**：给Runner起个名字，方便识别
- **建议**：用有意义的名称，如"生产环境Runner"、"测试服务器"

**🔸 Tags（标签）**
- **作用**：给Runner贴标签，CI脚本可以指定使用哪些标签的Runner
- **格式**：用逗号分隔，如`test,build,deploy`
- **用途**：实现任务的精准分配

### 4.4 非交互式注册


**⚡ 一键注册命令**
```bash
# 适合脚本化部署
sudo gitlab-runner register \
  --non-interactive \
  --url "https://gitlab.example.com" \
  --registration-token "glrt-xxxxxxxxxxxx" \
  --description "生产环境Runner" \
  --tag-list "production,deploy" \
  --executor "shell"
```

---

## 5. ⚙️ Executor执行器选择指南


### 5.1 什么是Executor


**🎯 通俗解释**
```
Executor就是"执行方式"：
┌─────────────────────────────────────────┐
│  你的CI任务需要在哪里执行？              │
├─────────────────────────────────────────┤
│  🖥️  直接在服务器上 → Shell Executor     │
│  🐳  在Docker容器里 → Docker Executor   │
│  ☁️  在虚拟机里    → VirtualBox等       │
└─────────────────────────────────────────┘
```

### 5.2 Shell Executor详解


**🔸 工作原理**
```
Shell执行方式：
服务器环境
├── GitLab Runner
├── 你的项目代码
├── 构建工具 (npm, maven等)
└── 部署脚本

任务直接在服务器上执行，使用服务器已安装的软件
```

**✅ 适用场景**
- 🎯 **简单项目**：不需要复杂环境隔离
- 🎯 **快速部署**：直接在生产服务器上部署
- 🎯 **学习阶段**：配置简单，容易理解

**❌ 注意事项**
- 💡 **环境污染**：多个项目可能互相影响
- 💡 **安全风险**：任务可以访问服务器的所有资源
- 💡 **依赖管理**：需要手动安装所需软件

### 5.3 Docker Executor详解


**🔸 工作原理**
```
Docker执行方式：
服务器环境
├── GitLab Runner
├── Docker Engine
└── 容器实例
    ├── 项目代码
    ├── 运行环境
    └── 构建工具

每个任务在独立的容器中执行，执行完毕后销毁
```

**✅ 适用场景**
- 🎯 **环境隔离**：不同项目使用不同的运行环境
- 🎯 **标准化**：确保每次执行环境一致
- 🎯 **多语言**：轻松切换不同语言环境

**🔧 Docker配置示例**
```bash
# 注册时选择docker
sudo gitlab-runner register \
  --executor "docker" \
  --docker-image "ubuntu:20.04"
```

### 5.4 Executor选择建议


| 使用场景 | **推荐Executor** | **原因分析** |
|---------|-----------------|-------------|
| 🎓 **新手学习** | `Shell` | `配置简单，容易理解` |
| 🏢 **企业生产** | `Docker` | `环境隔离，安全稳定` |
| 🚀 **快速原型** | `Shell` | `部署快速，调试方便` |
| 🔒 **多租户** | `Docker` | `严格隔离，互不影响` |

---

## 6. 📁 配置文件管理与维护


### 6.1 配置文件位置与结构


**📍 配置文件位置**
```
Linux系统中的位置：
/etc/gitlab-runner/config.toml

权限说明：
• 文件所有者：gitlab-runner用户
• 文件权限：600 (只有所有者可读写)
• 重要提示：不要用root直接编辑
```

### 6.2 配置文件内容解析


**📋 典型配置文件结构**
```toml
# 全局设置
concurrent = 4  # 最多同时执行4个任务
check_interval = 0  # 检查新任务的间隔

# Session服务器配置
[session_server]
  session_timeout = 1800

# Runner具体配置
[[runners]]
  name = "我的第一个Runner"  # Runner名称
  url = "https://gitlab.example.com"  # GitLab地址
  token = "glrt-xxxxxxxxxxxx"  # 注册后生成的Token
  executor = "shell"  # 执行器类型
  
  # Shell执行器特定配置
  [runners.custom_build_dir]
  
  [runners.cache]
    Type = "s3"  # 缓存类型
    
  [runners.cache.s3]
  
  [runners.cache.gcs]
  
  [runners.cache.azure]
```

### 6.3 重要配置参数说明


**🔸 concurrent（并发数）**
```
作用：控制Runner最多同时执行几个任务
建议值：
• 单核CPU：1-2
• 双核CPU：2-4  
• 四核CPU：4-8

实际影响：
concurrent = 1  → 任务排队执行
concurrent = 4  → 最多4个任务同时跑
```

**🔸 check_interval（检查间隔）**
```
作用：Runner多久向GitLab询问一次新任务
单位：秒
建议值：
• 0：使用默认值(3秒)
• 30：每30秒检查一次
• 不建议设置过小，避免频繁请求
```

### 6.4 配置文件安全维护


**🔒 安全注意事项**
- ✅ **权限控制**：确保只有gitlab-runner用户可以访问
- ✅ **备份配置**：定期备份配置文件
- ✅ **Token保护**：不要将Token提交到代码仓库

**🔧 常用维护命令**
```bash
# 查看配置文件
sudo cat /etc/gitlab-runner/config.toml

# 备份配置文件
sudo cp /etc/gitlab-runner/config.toml /etc/gitlab-runner/config.toml.backup

# 验证配置文件语法
sudo gitlab-runner verify
```

---

## 7. 🛠️ Runner运维实践


### 7.1 Runner状态管理


**📊 查看Runner状态**
```bash
# 查看所有已注册的Runner
sudo gitlab-runner list

# 查看Runner服务状态
sudo systemctl status gitlab-runner

# 查看Runner实时日志
sudo journalctl -u gitlab-runner -f
```

**🔄 Runner服务控制**
```bash
# 启动Runner服务
sudo systemctl start gitlab-runner

# 停止Runner服务
sudo systemctl stop gitlab-runner

# 重启Runner服务
sudo systemctl restart gitlab-runner

# 设置开机自启
sudo systemctl enable gitlab-runner
```

### 7.2 标签管理与使用


**🏷️ 标签的作用机制**
```
CI脚本中指定标签：
┌─────────────────────────────┐
│ job_name:                   │
│   tags:                     │
│     - production            │
│     - deploy                │
│   script:                   │
│     - echo "部署到生产环境"   │
└─────────────────────────────┘
         ↓
只有带有production和deploy标签的Runner会执行此任务
```

**🎯 标签最佳实践**
```
推荐的标签命名方式：
• 环境标签：dev, test, staging, production
• 功能标签：build, test, deploy, release
• 技术标签：docker, node, java, python
• 平台标签：linux, windows, macos

标签组合示例：
tags: ["production", "deploy", "linux"]
→ 生产环境部署用的Linux Runner
```

### 7.3 Runner性能监控


**📈 关键监控指标**
```
Runner健康状态检查：
┌─────────────────────────────────────┐
│ 1. CPU使用率：应保持在80%以下       │
│ 2. 内存使用率：避免内存不足         │
│ 3. 磁盘空间：确保有足够构建空间     │
│ 4. 网络连接：检查与GitLab的连通性   │
│ 5. 任务队列：观察任务排队情况       │
└─────────────────────────────────────┘
```

**🔧 性能优化建议**
- **并发控制**：根据硬件资源调整concurrent参数
- **缓存机制**：配置适当的缓存减少重复下载
- **清理策略**：定期清理构建产物和临时文件
- **资源分配**：为不同类型任务分配专门的Runner

### 7.4 常见问题排查


**❌ 问题：Runner无法连接GitLab**
```
排查步骤：
1. 检查网络连接：ping gitlab.example.com
2. 验证URL配置：确保config.toml中URL正确
3. 检查Token：Token是否过期或被撤销
4. 防火墙设置：确保端口443/80开放
```

**❌ 问题：任务执行失败**
```
排查步骤：
1. 查看任务日志：GitLab Web界面查看详细错误
2. 检查Runner日志：sudo journalctl -u gitlab-runner
3. 验证环境：确保执行环境有必需的软件
4. 权限检查：确保gitlab-runner用户有足够权限
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的关键概念


```
🔸 Runner本质：独立程序，专门执行CI/CD任务的"数字工人"
🔸 类型区别：Shared Runner(共享) vs Specific Runner(专用)
🔸 执行器选择：Shell(直接执行) vs Docker(容器隔离)
🔸 注册流程：获取Token → 运行注册命令 → 配置参数
🔸 配置管理：config.toml文件控制Runner行为
🔸 标签机制：通过标签实现任务与Runner的精准匹配
```

### 8.2 新手入门路径


**🎯 学习建议顺序**
```
第1步：理解Runner基本概念
• 什么是Runner
• Runner的作用和工作机制

第2步：动手安装注册
• 在测试环境安装Runner
• 完成第一次注册流程

第3步：掌握基础运维
• 查看Runner状态
• 理解配置文件
• 学会基础故障排查

第4步：深入高级特性
• 标签管理策略
• 性能优化配置
• 企业级部署方案
```

### 8.3 实际应用场景


**🏢 企业环境部署建议**
- **开发环境**：使用Shared Runner，快速启动
- **测试环境**：专用Runner，环境稳定
- **生产环境**：专用Runner + Docker，安全隔离
- **特殊需求**：根据技术栈配置专门的Runner

### 8.4 安全与维护要点


**🔒 安全最佳实践**
```
• Token保护：不要泄露Registration Token
• 权限最小化：Runner只给必需的权限
• 定期更新：保持Runner版本最新
• 监控告警：设置Runner状态监控
• 备份配置：定期备份配置文件
```

**🔧 运维检查清单**
```
日常维护：
✅ 检查Runner运行状态
✅ 监控资源使用情况
✅ 清理构建缓存和临时文件
✅ 查看任务执行日志

定期维护：
✅ 更新Runner版本
✅ 备份配置文件
✅ 检查安全设置
✅ 优化性能配置
```

**核心记忆**：
- GitLab Runner是CI/CD的执行引擎，负责实际执行构建、测试、部署任务
- 选择合适的Runner类型和执行器是成功的关键
- 标签机制让任务分配更加精准和灵活
- 良好的运维实践确保CI/CD流程稳定可靠