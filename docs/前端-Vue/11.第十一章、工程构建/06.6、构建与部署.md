---
title: 6、构建与部署
---
## 📚 目录

1. [构建基础概念](#1-构建基础概念)
2. [生产环境构建](#2-生产环境构建)
3. [代码分割与懒加载](#3-代码分割与懒加载)
4. [打包优化策略](#4-打包优化策略)
5. [静态资源与CDN](#5-静态资源与cdn)
6. [服务器部署](#6-服务器部署)
7. [路由配置与跨域](#7-路由配置与跨域)
8. [多环境配置](#8-多环境配置)
9. [持续集成CI/CD](#9-持续集成cicd)
10. [核心要点总结](#10-核心要点总结)

---

## 1. 🏗️ 构建基础概念


### 1.1 什么是构建


> 💡 **简单理解**：构建就是把你写的Vue代码"翻译"成浏览器能理解的代码

**构建过程**就像**翻译官**：
- 你写的`.vue`文件 → 浏览器认识的`.html/.js/.css`
- ES6语法 → ES5语法（兼容老浏览器）
- 大文件 → 压缩的小文件
- 多个文件 → 合并后的文件

```
开发时的代码               构建后的代码
┌─────────────┐           ┌─────────────┐
│ App.vue     │           │ index.html  │
│ main.js     │  ──构建──> │ app.js      │
│ style.css   │           │ app.css     │
│ images/     │           │ images/     │
└─────────────┘           └─────────────┘
   开发环境                  生产环境
```

### 1.2 为什么需要构建


**🎯 核心目标**：让网站**加载更快**，**体验更好**

```
🔍 开发环境 vs 生产环境：

开发环境（写代码时）：
✅ 代码可读性好
✅ 调试方便
✅ 热更新快
❌ 文件大，加载慢
❌ 代码未压缩

生产环境（用户访问）：
✅ 文件小，加载快
✅ 代码压缩优化
✅ 缓存策略好
❌ 代码不可读
❌ 调试困难
```

---

## 2. 🚀 生产环境构建


### 2.1 执行构建命令


**最简单的构建**：
```bash
# 一键构建生产环境代码
npm run build
```

> 📖 **过程解释**：这个命令会把整个项目"打包"成可以放到服务器上的文件

**构建后的文件结构**：
```
dist/                    ← 构建后的文件夹
├── index.html          ← 入口页面
├── js/
│   ├── app.js          ← 主要业务代码
│   ├── vendor.js       ← 第三方库代码
│   └── runtime.js      ← 运行时代码
├── css/
│   └── app.css         ← 样式文件
└── img/                ← 图片资源
```

### 2.2 构建配置优化


**基础配置示例**：
```javascript
// vue.config.js
module.exports = {
  // 生产环境路径
  publicPath: './',
  
  // 输出目录
  outputDir: 'dist',
  
  // 生产环境不生成source map（减小文件大小）
  productionSourceMap: false,
  
  // CSS分离
  css: {
    extract: true
  }
}
```

> ⚠️ **注意**：`publicPath: './'` 让网站可以放在任意目录下运行

---

## 3. ✂️ 代码分割与懒加载


### 3.1 什么是代码分割


> 💡 **通俗理解**：不要一次性加载所有代码，用到什么再加载什么

**传统方式问题**：
```
用户访问首页 → 下载整个网站代码 → 等待时间长
```

**代码分割优势**：
```
用户访问首页 → 只下载首页代码 → 快速展示
用户点击其他页面 → 再下载对应代码 → 按需加载
```

### 3.2 路由懒加载实现


**普通导入（不推荐）**：
```javascript
// 一次性加载所有页面
import Home from '@/views/Home.vue'
import About from '@/views/About.vue'
import Product from '@/views/Product.vue'
```

**懒加载导入（推荐）**：
```javascript
// 用到才加载
const routes = [
  {
    path: '/',
    component: () => import('@/views/Home.vue')
  },
  {
    path: '/about',
    component: () => import('@/views/About.vue')
  },
  {
    path: '/product',
    component: () => import('@/views/Product.vue')
  }
]
```

> 🔧 **实践效果**：首页加载速度提升50%以上

### 3.3 组件懒加载


**大组件按需加载**：
```javascript
export default {
  components: {
    // 只有使用时才加载这个组件
    HeavyChart: () => import('@/components/HeavyChart.vue')
  },
  
  methods: {
    async showChart() {
      // 动态显示图表
      this.showHeavyChart = true
    }
  }
}
```

---

## 4. 🎯 打包优化策略


### 4.1 文件压缩优化


**启用Gzip压缩**：
```javascript
// vue.config.js
const CompressionPlugin = require('compression-webpack-plugin')

module.exports = {
  configureWebpack: {
    plugins: [
      new CompressionPlugin({
        test: /\.(js|css)$/,
        threshold: 10240, // 10KB以上才压缩
        deleteOriginalAssets: false
      })
    ]
  }
}
```

> 📊 **压缩效果**：文件大小通常减少60-80%

### 4.2 第三方库优化


**CDN引入大型库**：
```javascript
// vue.config.js
module.exports = {
  configureWebpack: {
    externals: {
      'vue': 'Vue',
      'element-ui': 'ELEMENT'
    }
  }
}
```

**在index.html中引入CDN**：
```html
<!DOCTYPE html>
<html>
<head>
  <!-- 从CDN加载Vue和Element UI -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/element-ui"></script>
</head>
</html>
```

> 🚀 **好处**：减少打包体积，利用CDN加速

### 4.3 图片优化


**图片压缩配置**：
```javascript
// vue.config.js
module.exports = {
  chainWebpack: config => {
    // 图片压缩
    config.module
      .rule('images')
      .use('image-webpack-loader')
      .loader('image-webpack-loader')
      .options({
        mozjpeg: { quality: 80 },
        pngquant: { quality: [0.6, 0.8] }
      })
  }
}
```

---

## 5. 🌐 静态资源与CDN


### 5.1 什么是CDN


> 💡 **简单理解**：CDN就像**快递站点**，让用户从最近的地方获取文件

```
CDN工作原理：

用户在北京 ─┐
用户在上海 ─┼─→ 就近的CDN节点 ─→ 快速获取文件
用户在广州 ─┘

而不是所有用户都从：
服务器（可能在国外） ─→ 慢速获取文件
```

### 5.2 静态资源CDN配置


**配置静态资源CDN地址**：
```javascript
// vue.config.js
module.exports = {
  publicPath: process.env.NODE_ENV === 'production' 
    ? 'https://cdn.example.com/' 
    : './'
}
```

**环境变量配置**：
```bash
# .env.production
VUE_APP_CDN_URL=https://cdn.example.com
```

### 5.3 资源上传CDN


**自动上传脚本示例**：
```javascript
// 构建完成后自动上传到CDN
const fs = require('fs')
const path = require('path')

// 构建完成钩子
module.exports = {
  configureWebpack: {
    plugins: [
      {
        apply: (compiler) => {
          compiler.hooks.done.tap('upload-cdn', () => {
            // 上传dist目录到CDN
            console.log('正在上传文件到CDN...')
          })
        }
      }
    ]
  }
}
```

---

## 6. 🖥️ 服务器部署


### 6.1 静态文件服务器部署


**Nginx部署配置**：
```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    # 网站根目录
    root /var/www/your-vue-app/dist;
    index index.html;
    
    # 处理Vue路由
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

> 📖 **解释**：`try_files` 让所有路由都指向 `index.html`，由Vue Router处理

### 6.2 简单部署步骤


**部署流程**：
```bash
# 1. 本地构建
npm run build

# 2. 上传文件到服务器
scp -r dist/* user@server:/var/www/html/

# 3. 重启Web服务器
sudo systemctl restart nginx
```

**验证部署**：
```bash
# 检查文件是否上传成功
ls -la /var/www/html/

# 检查网站是否可访问
curl http://your-domain.com
```

---

## 7. 🌍 路由配置与跨域


### 7.1 History模式配置


**Router配置**：
```javascript
// router/index.js
const router = new VueRouter({
  mode: 'history', // 使用HTML5 History模式
  base: '/app/',   // 如果部署在子目录
  routes: [...]
})
```

> ⚠️ **重要**：History模式需要服务器配合，否则刷新页面会出现404

**模式对比**：
```
Hash模式：
网址：http://example.com/#/about
✅ 无需服务器配置
❌ URL有#号不美观

History模式：
网址：http://example.com/about  
✅ URL美观
❌ 需要服务器配置
```

### 7.2 跨域问题解决


**开发环境代理配置**：
```javascript
// vue.config.js
module.exports = {
  devServer: {
    proxy: {
      '/api': {
        target: 'http://localhost:3000',
        changeOrigin: true,
        pathRewrite: {
          '^/api': '/api'
        }
      }
    }
  }
}
```

**生产环境解决方案**：
```javascript
// 后端设置CORS headers
app.use((req, res, next) => {
  res.header('Access-Control-Allow-Origin', 'https://your-domain.com')
  res.header('Access-Control-Allow-Methods', 'GET,POST,PUT,DELETE')
  next()
})
```

---

## 8. 🔧 多环境配置


### 8.1 环境文件配置


**创建环境配置文件**：
```bash
.env                # 默认环境
.env.development    # 开发环境
.env.test          # 测试环境  
.env.production    # 生产环境
```

**配置示例**：
```bash
# .env.development
NODE_ENV=development
VUE_APP_API_URL=http://localhost:3000/api
VUE_APP_TITLE=开发环境

# .env.production  
NODE_ENV=production
VUE_APP_API_URL=https://api.example.com
VUE_APP_TITLE=生产环境
```

### 8.2 代码中使用环境变量


```javascript
// 在代码中使用
export default {
  data() {
    return {
      apiUrl: process.env.VUE_APP_API_URL,
      title: process.env.VUE_APP_TITLE
    }
  },
  
  created() {
    console.log('当前环境:', process.env.NODE_ENV)
  }
}
```

### 8.3 构建不同环境


```bash
# 构建测试环境
npm run build --mode test

# 构建生产环境  
npm run build --mode production
```

---

## 9. 🔄 持续集成CI/CD


### 9.1 什么是CI/CD


> 💡 **通俗理解**：CI/CD就像**自动化工厂流水线**

```
传统部署：
写代码 → 手动测试 → 手动构建 → 手动部署
     ↓
  费时费力，容易出错

CI/CD自动化：
写代码 → 自动测试 → 自动构建 → 自动部署
     ↓
  快速可靠，减少人工错误
```

### 9.2 GitHub Actions配置


**简单的CI/CD配置**：
```yaml
# .github/workflows/deploy.yml
name: Build and Deploy

on:
  push:
    branches: [ main ]

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v2
      
    - name: 安装Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '16'
        
    - name: 安装依赖
      run: npm install
      
    - name: 构建项目
      run: npm run build
      
    - name: 部署到服务器
      run: |
        # 上传文件到服务器的脚本
        echo "部署完成"
```

### 9.3 自动化部署流程


```
完整CI/CD流程：

1. 代码提交 → Git仓库
         ↓
2. 触发CI → 自动测试
         ↓
3. 测试通过 → 自动构建
         ↓  
4. 构建成功 → 自动部署
         ↓
5. 部署完成 → 通知开发者
```

---

## 10. 📋 核心要点总结


### 10.1 必须掌握的核心概念


```
🔸 构建：把开发代码转换成生产代码的过程
🔸 代码分割：按需加载，提升首屏加载速度
🔸 CDN：内容分发网络，让用户就近获取资源
🔸 部署：把构建好的代码放到服务器供用户访问
🔸 多环境：开发、测试、生产环境的不同配置
🔸 CI/CD：自动化的代码集成和部署流程
```

### 10.2 关键操作流程


**🔹 标准部署流程**：
```
1. npm run build          ← 构建生产代码
2. 上传dist文件到服务器    ← 文件传输
3. 配置Web服务器          ← Nginx/Apache配置
4. 测试网站访问           ← 验证部署成功
```

**🔹 性能优化要点**：
```
代码分割 → 减少首屏加载时间
CDN加速 → 提升资源加载速度
Gzip压缩 → 减小文件传输大小
缓存策略 → 提升二次访问速度
```

### 10.3 常见问题解决


| 问题 | 原因 | 解决方案 |
|------|------|----------|
| **刷新页面404** | History模式未配置 | 服务器配置`try_files` |
| **资源加载失败** | 路径配置错误 | 检查`publicPath`配置 |
| **跨域请求失败** | 同源策略限制 | 配置CORS或代理 |
| **首屏加载慢** | 代码未分割 | 启用路由懒加载 |

### 10.4 最佳实践建议


**🎯 性能优化**：
- ✅ 启用代码分割和懒加载
- ✅ 使用CDN加速静态资源
- ✅ 开启Gzip压缩
- ✅ 合理设置缓存策略

**🔧 部署安全**：
- ✅ 使用环境变量管理配置
- ✅ 不在代码中硬编码敏感信息
- ✅ 设置合适的CORS策略
- ✅ 定期更新依赖版本

**🚀 开发效率**：
- ✅ 建立CI/CD自动化流程
- ✅ 多环境配置管理
- ✅ 自动化测试集成
- ✅ 监控和日志系统

**核心记忆**：
- 构建优化提升用户体验
- 代码分割按需加载资源
- CDN加速全球用户访问
- CI/CD自动化提升效率