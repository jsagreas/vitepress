---
title: 3ã€CSRFä¸ç‚¹å‡»åŠ«æŒé˜²æŠ¤
---
## ğŸ“š ç›®å½•

1. [CSRFè·¨ç«™è¯·æ±‚ä¼ªé€ æ”»å‡»](#1-CSRFè·¨ç«™è¯·æ±‚ä¼ªé€ æ”»å‡»)
2. [TokenéªŒè¯æœºåˆ¶](#2-TokenéªŒè¯æœºåˆ¶)
3. [Cookieå®‰å…¨å±æ€§é…ç½®](#3-Cookieå®‰å…¨å±æ€§é…ç½®)
4. [è¯·æ±‚å¤´éªŒè¯é˜²æŠ¤](#4-è¯·æ±‚å¤´éªŒè¯é˜²æŠ¤)
5. [ç‚¹å‡»åŠ«æŒæ”»å‡»ä¸é˜²æŠ¤](#5-ç‚¹å‡»åŠ«æŒæ”»å‡»ä¸é˜²æŠ¤)
6. [CookieåŠ«æŒé˜²æŠ¤æŠ€æœ¯](#6-CookieåŠ«æŒé˜²æŠ¤æŠ€æœ¯)
7. [ç»¼åˆé˜²æŠ¤ç­–ç•¥](#7-ç»¼åˆé˜²æŠ¤ç­–ç•¥)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ CSRFè·¨ç«™è¯·æ±‚ä¼ªé€ æ”»å‡»


### 1.1 CSRFæ˜¯ä»€ä¹ˆ


**ğŸ’¡ é€šä¿—è§£é‡Š**ï¼š
CSRFï¼ˆCross-Site Request Forgeryï¼‰å°±åƒæœ‰äºº**å†’ç”¨ä½ çš„èº«ä»½**å»é“¶è¡Œå–é’±ã€‚æ”»å‡»è€…åˆ©ç”¨ä½ å·²ç»ç™»å½•çš„ç½‘ç«™èº«ä»½ï¼Œ**å·å·æ‰§è¡Œä½ ä¸çŸ¥é“çš„æ“ä½œ**ã€‚

```
ç°å®åœºæ™¯ç±»æ¯”ï¼š
ä½ ç™»å½•äº†é“¶è¡Œç½‘ç«™ â†’ é“¶è¡Œè®¤è¯†ä½ ï¼ˆé€šè¿‡Cookieï¼‰
æ¶æ„ç½‘ç«™è¶æœºå‘èµ·è½¬è´¦è¯·æ±‚ â†’ é“¶è¡Œä»¥ä¸ºæ˜¯ä½ å‘èµ·çš„
ç»“æœï¼šä½ çš„é’±è¢«å·å·è½¬èµ°äº†ï¼
```

### 1.2 CSRFæ”»å‡»åŸç†


**ğŸ” æ”»å‡»æµç¨‹**ï¼š
```
ç”¨æˆ·ç™»å½•è¿‡ç¨‹ï¼š                     CSRFæ”»å‡»è¿‡ç¨‹ï¼š
                                  
ç”¨æˆ· â†’ é“¶è¡Œç½‘ç«™                    æ¶æ„ç½‘ç«™ â†’ ç”¨æˆ·æµè§ˆå™¨
     ï¼ˆè¾“å…¥è´¦å·å¯†ç ï¼‰                        ï¼ˆå‘é€æ¶æ„é¡µé¢ï¼‰
                                           â†“
é“¶è¡Œç½‘ç«™ â†’ ç”¨æˆ·æµè§ˆå™¨               ç”¨æˆ·æµè§ˆå™¨ â†’ é“¶è¡Œç½‘ç«™
        ï¼ˆè¿”å›Cookieï¼‰                      ï¼ˆæºå¸¦Cookieå‘é€è½¬è´¦è¯·æ±‚ï¼‰
                                           â†“
ç”¨æˆ·è·å¾—ç™»å½•çŠ¶æ€                    é“¶è¡Œç½‘ç«™ â†’ æ‰§è¡Œè½¬è´¦
                                           ï¼ˆä»¥ä¸ºæ˜¯ç”¨æˆ·æœ¬äººæ“ä½œï¼‰
```

### 1.3 CSRFæ”»å‡»ç¤ºä¾‹


**âŒ æ¶æ„ç½‘ç«™ä»£ç **ï¼š
```html
<!-- ç”¨æˆ·è®¿é—®æ¶æ„ç½‘ç«™æ—¶ï¼Œè‡ªåŠ¨å‘é“¶è¡Œå‘èµ·è½¬è´¦è¯·æ±‚ -->
<form action="https://bank.com/transfer" method="POST" style="display:none">
    <input name="to" value="æ”»å‡»è€…è´¦å·">
    <input name="amount" value="10000">
</form>

<script>
// é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æäº¤è¡¨å•
document.forms[0].submit();
</script>
```

**âš ï¸ æ”»å‡»æˆåŠŸçš„æ¡ä»¶**ï¼š
- âœ… ç”¨æˆ·å·²ç»ç™»å½•ç›®æ ‡ç½‘ç«™ï¼ˆCookieæœ‰æ•ˆï¼‰
- âœ… ç›®æ ‡ç½‘ç«™æ²¡æœ‰CSRFé˜²æŠ¤
- âœ… ç”¨æˆ·è®¿é—®äº†æ¶æ„ç½‘ç«™
- âœ… æ¶æ„è¯·æ±‚æ ¼å¼æ­£ç¡®

### 1.4 CSRFæ”»å‡»çš„å±å®³


**ğŸš¨ å¸¸è§å±å®³åœºæ™¯**ï¼š

| æ”»å‡»ç›®æ ‡ | **å±å®³åæœ** | **æ”»å‡»ç¤ºä¾‹** |
|---------|------------|-------------|
| ğŸ¦ **é‡‘èç½‘ç«™** | `èµ„é‡‘è¢«ç›—è½¬` | `è‡ªåŠ¨è½¬è´¦ã€ä¿®æ”¹æ”¶æ¬¾äºº` |
| ğŸ“§ **é‚®ç®±ç³»ç»Ÿ** | `é‚®ä»¶è¢«ç¯¡æ”¹` | `è‡ªåŠ¨è½¬å‘é‚®ä»¶ã€ä¿®æ”¹å¯†ç ` |
| ğŸ‘¤ **ç¤¾äº¤ç½‘ç«™** | `è´¦å·è¢«æ§åˆ¶` | `è‡ªåŠ¨å‘å¸–ã€æ·»åŠ å¥½å‹` |
| ğŸ›’ **è´­ç‰©ç½‘ç«™** | `æ¶æ„ä¸‹å•` | `ä¿®æ”¹æ”¶è´§åœ°å€ã€è´­ä¹°å•†å“` |
| âš™ï¸ **ç®¡ç†åå°** | `ç³»ç»Ÿè¢«ç ´å` | `åˆ é™¤ç”¨æˆ·ã€ä¿®æ”¹æƒé™` |

---

## 2. ğŸ” TokenéªŒè¯æœºåˆ¶


### 2.1 Tokenæ˜¯ä»€ä¹ˆ


**ğŸ’¡ é€šä¿—è§£é‡Š**ï¼š
Tokenå°±åƒæ˜¯**é“¶è¡Œç»™ä½ çš„å¯†ä»¤ç‰Œ**ã€‚æ¯æ¬¡æ“ä½œæ—¶ï¼Œé™¤äº†è¦è¯æ˜èº«ä»½ï¼ˆCookieï¼‰ï¼Œè¿˜è¦å‡ºç¤ºè¿™ä¸ª**éšæœºç”Ÿæˆçš„ä»¤ç‰Œ**ï¼Œæ”»å‡»è€…æ— æ³•ä¼ªé€ ã€‚

```
æ²¡æœ‰Tokençš„æƒ…å†µï¼š
ç”¨æˆ·ï¼šæˆ‘è¦è½¬è´¦ï¼ˆåªæœ‰èº«ä»½è¯ï¼‰
é“¶è¡Œï¼šå¥½çš„ï¼Œæ‰§è¡Œè½¬è´¦

æœ‰Tokençš„æƒ…å†µï¼š
ç”¨æˆ·ï¼šæˆ‘è¦è½¬è´¦ï¼ˆèº«ä»½è¯ + ä»Šæ—¥å¯†ä»¤ï¼‰
é“¶è¡Œï¼šå¯†ä»¤æ­£ç¡®ï¼Œæ‰§è¡Œè½¬è´¦
æ”»å‡»è€…ï¼šæˆ‘è¦è½¬è´¦ï¼ˆåªæœ‰èº«ä»½è¯ï¼‰
é“¶è¡Œï¼šæ²¡æœ‰å¯†ä»¤ï¼Œæ‹’ç»æ“ä½œï¼
```

### 2.2 CSRF Tokenå·¥ä½œåŸç†


**ğŸ”„ TokenéªŒè¯æµç¨‹**ï¼š
```
æ­¥éª¤1: ç”¨æˆ·è®¿é—®é¡µé¢
ç”¨æˆ· â†’ æœåŠ¡å™¨ï¼šè¯·æ±‚è½¬è´¦é¡µé¢
æœåŠ¡å™¨ â†’ ç”¨æˆ·ï¼šè¿”å›é¡µé¢ + CSRF Token

æ­¥éª¤2: ç”¨æˆ·æäº¤æ“ä½œ
ç”¨æˆ· â†’ æœåŠ¡å™¨ï¼šè½¬è´¦è¯·æ±‚ + Token
æœåŠ¡å™¨ï¼šéªŒè¯Tokenæ˜¯å¦æ­£ç¡®
      â†“
   Tokenæ­£ç¡®ï¼Ÿ â†’ æ‰§è¡Œæ“ä½œ
   Tokené”™è¯¯ï¼Ÿ â†’ æ‹’ç»æ“ä½œ
```

### 2.3 Tokenå®ç°æ–¹æ¡ˆ


**ğŸ› ï¸ æœåŠ¡ç«¯ç”ŸæˆToken**ï¼š
```java
// ç”ŸæˆéšæœºToken
public class CSRFTokenUtil {
    public static String generateToken() {
        return UUID.randomUUID().toString();
    }
    
    // å°†Tokenå­˜å‚¨åˆ°Session
    public static void storeToken(HttpSession session, String token) {
        session.setAttribute("csrf_token", token);
    }
    
    // éªŒè¯Token
    public static boolean validateToken(HttpSession session, String token) {
        String sessionToken = (String) session.getAttribute("csrf_token");
        return sessionToken != null && sessionToken.equals(token);
    }
}
```

**ğŸ¯ å‰ç«¯ä½¿ç”¨Token**ï¼š
```html
<!-- åœ¨è¡¨å•ä¸­æ·»åŠ éšè—çš„Tokenå­—æ®µ -->
<form action="/transfer" method="post">
    <input type="hidden" name="csrf_token" value="${csrfToken}">
    <input name="to" placeholder="æ”¶æ¬¾äºº">
    <input name="amount" placeholder="é‡‘é¢">
    <button type="submit">è½¬è´¦</button>
</form>
```

### 2.4 Tokençš„å®‰å…¨è¦æ±‚


**âœ… Tokenå¿…é¡»æ»¡è¶³çš„æ¡ä»¶**ï¼š
```
ğŸ”¸ éšæœºæ€§å¼ºï¼šä½¿ç”¨å¼ºéšæœºæ•°ç”Ÿæˆ
ğŸ”¸ ä¸å¯é¢„æµ‹ï¼šæ¯æ¬¡ç”Ÿæˆéƒ½ä¸åŒ
ğŸ”¸ æœ‰æ•ˆæœŸé™ï¼šè®¾ç½®åˆç†è¿‡æœŸæ—¶é—´
ğŸ”¸ ä¸€æ¬¡æ€§ä½¿ç”¨ï¼šç”¨å®Œå³ä½œåºŸï¼ˆå¯é€‰ï¼‰
ğŸ”¸ ç»‘å®šç”¨æˆ·ï¼šä¸ç”¨æˆ·Sessionå…³è”
```

---

## 3. ğŸª Cookieå®‰å…¨å±æ€§é…ç½®


### 3.1 SameSiteå±æ€§è¯¦è§£


**ğŸ’¡ SameSiteæ˜¯ä»€ä¹ˆ**ï¼š
SameSiteå‘Šè¯‰æµè§ˆå™¨**ä»€ä¹ˆæ—¶å€™å¯ä»¥å‘é€Cookie**ã€‚å°±åƒé—¨å«è§„å®šï¼Œåªæœ‰ç‰¹å®šæƒ…å†µä¸‹æ‰èƒ½è¿›å…¥å¤§æ¥¼ã€‚

**ğŸ”§ SameSiteä¸‰ç§æ¨¡å¼**ï¼š

| æ¨¡å¼ | **è¡Œä¸ºè§„åˆ™** | **å®‰å…¨ç­‰çº§** | **é€‚ç”¨åœºæ™¯** |
|------|------------|-------------|-------------|
| ğŸš« **Strict** | `åªæœ‰åŒç«™è¯·æ±‚æ‰å‘é€Cookie` | `æœ€é«˜` | `é«˜å®‰å…¨è¦æ±‚åœºæ™¯` |
| âš¡ **Lax** | `å¯¼èˆªè¯·æ±‚å¯ä»¥ï¼Œæäº¤è¡¨å•ä¸è¡Œ` | `ä¸­ç­‰` | `å¹³è¡¡å®‰å…¨å’Œå¯ç”¨æ€§` |
| ğŸ”“ **None** | `æ‰€æœ‰è·¨ç«™è¯·æ±‚éƒ½å‘é€Cookie` | `æœ€ä½` | `éœ€è¦è·¨åŸŸåŠŸèƒ½` |

### 3.2 SameSiteå®é™…æ•ˆæœ


**ğŸ¯ Strictæ¨¡å¼ç¤ºä¾‹**ï¼š
```javascript
// è®¾ç½®Strictæ¨¡å¼Cookie
document.cookie = "session_id=abc123; SameSite=Strict; Secure; HttpOnly";

/*
æ•ˆæœï¼š
âœ… ç”¨æˆ·ç›´æ¥è®¿é—® yoursite.com â†’ Cookieå‘é€
âŒ ä»æ¶æ„ç½‘ç«™è·³è½¬åˆ° yoursite.com â†’ Cookieä¸å‘é€
âŒ æ¶æ„ç½‘ç«™å‘ yoursite.com å‘è¯·æ±‚ â†’ Cookieä¸å‘é€
*/
```

**âš¡ Laxæ¨¡å¼ç¤ºä¾‹**ï¼š
```javascript
// è®¾ç½®Laxæ¨¡å¼Cookieï¼ˆé»˜è®¤å€¼ï¼‰
document.cookie = "session_id=abc123; SameSite=Lax; Secure; HttpOnly";

/*
æ•ˆæœï¼š
âœ… ç”¨æˆ·ç‚¹å‡»é“¾æ¥è·³è½¬ â†’ Cookieå‘é€
âœ… ç”¨æˆ·ç›´æ¥è®¿é—®ç½‘ç«™ â†’ Cookieå‘é€
âŒ AJAX/Fetchè·¨åŸŸè¯·æ±‚ â†’ Cookieä¸å‘é€
âŒ è¡¨å•è·¨åŸŸæäº¤ â†’ Cookieä¸å‘é€
*/
```

### 3.3 å…¶ä»–Cookieå®‰å…¨å±æ€§


**ğŸ”’ å®Œæ•´çš„å®‰å…¨Cookieé…ç½®**ï¼š
```javascript
// æœ€å®‰å…¨çš„Cookieè®¾ç½®
document.cookie = `session_id=abc123; 
    SameSite=Strict;     // åªå…è®¸åŒç«™è¯·æ±‚
    Secure;              // åªèƒ½é€šè¿‡HTTPSä¼ è¾“
    HttpOnly;            // ç¦æ­¢JavaScriptè®¿é—®
    Max-Age=3600;        // 1å°æ—¶åè¿‡æœŸ
    Path=/;              // æ•´ä¸ªç½‘ç«™æœ‰æ•ˆ
    Domain=.example.com`; // æŒ‡å®šåŸŸå
```

**ğŸ“‹ å„å±æ€§ä½œç”¨è¯´æ˜**ï¼š
- **Secure**ï¼šåªæœ‰HTTPSè¿æ¥æ‰å‘é€Cookie
- **HttpOnly**ï¼šé˜²æ­¢JavaScriptè¯»å–Cookieï¼ˆé˜²XSSï¼‰
- **Max-Age/Expires**ï¼šè®¾ç½®Cookieè¿‡æœŸæ—¶é—´
- **Path**ï¼šé™åˆ¶Cookieçš„æœ‰æ•ˆè·¯å¾„
- **Domain**ï¼šé™åˆ¶Cookieçš„æœ‰æ•ˆåŸŸå

---

## 4. ğŸ” è¯·æ±‚å¤´éªŒè¯é˜²æŠ¤


### 4.1 Refererå¤´æ£€æŸ¥


**ğŸ’¡ Refereræ˜¯ä»€ä¹ˆ**ï¼š
Refererå¤´å‘Šè¯‰æœåŠ¡å™¨**è¿™ä¸ªè¯·æ±‚æ˜¯ä»å“ªä¸ªé¡µé¢å‘èµ·çš„**ã€‚å°±åƒå¿«é€’åŒ…è£¹ä¸Šçš„å‘ä»¶åœ°å€ã€‚

**ğŸ” RefereréªŒè¯åŸç†**ï¼š
```
æ­£å¸¸è¯·æ±‚ï¼š
ç”¨æˆ·åœ¨ bank.com é¡µé¢ç‚¹å‡»è½¬è´¦
Referer: https://bank.com/transfer-page
æœåŠ¡å™¨ï¼šè¯·æ±‚æ¥æºæ­£ç¡®ï¼Œå…è®¸æ“ä½œ

CSRFæ”»å‡»ï¼š
æ¶æ„ç½‘ç«™ evil.com å‘èµ·è½¬è´¦è¯·æ±‚
Referer: https://evil.com/attack-page
æœåŠ¡å™¨ï¼šè¯·æ±‚æ¥æºå¯ç–‘ï¼Œæ‹’ç»æ“ä½œ
```

**ğŸ› ï¸ RefereréªŒè¯å®ç°**ï¼š
```java
public boolean validateReferer(HttpServletRequest request) {
    String referer = request.getHeader("Referer");
    String serverName = request.getServerName();
    
    // æ£€æŸ¥Refereræ˜¯å¦æ¥è‡ªæœ¬ç«™
    if (referer == null || !referer.contains(serverName)) {
        return false; // æ‹’ç»è¯·æ±‚
    }
    return true; // å…è®¸è¯·æ±‚
}
```

### 4.2 Originå¤´æ£€æŸ¥


**ğŸ¯ Originä¸Refererçš„åŒºåˆ«**ï¼š
```
Referer: https://bank.com/transfer-page?user=123
Origin:  https://bank.com

Originæ›´ç®€æ´ï¼šåªåŒ…å«åè®®ã€åŸŸåã€ç«¯å£
Refereræ›´è¯¦ç»†ï¼šåŒ…å«å®Œæ•´çš„æ¥æºURLè·¯å¾„
```

**âœ… OriginéªŒè¯çš„ä¼˜åŠ¿**ï¼š
- ğŸ”¸ **ä¿¡æ¯ä¸æ³„éœ²**ï¼šä¸åŒ…å«æ•æ„Ÿçš„URLå‚æ•°
- ğŸ”¸ **æ›´å¯é **ï¼šæµè§ˆå™¨å¼ºåˆ¶å‘é€ï¼Œéš¾ä»¥ç¯¡æ”¹
- ğŸ”¸ **éšç§å‹å¥½**ï¼šä¸æš´éœ²ç”¨æˆ·æµè§ˆè·¯å¾„

**ğŸ› ï¸ OriginéªŒè¯å®ç°**ï¼š
```java
public boolean validateOrigin(HttpServletRequest request) {
    String origin = request.getHeader("Origin");
    String allowedOrigin = "https://bank.com";
    
    return allowedOrigin.equals(origin);
}
```

### 4.3 åŒé‡éªŒè¯ç­–ç•¥


**ğŸ›¡ï¸ ç»„åˆéªŒè¯æ–¹æ¡ˆ**ï¼š
```java
public boolean isValidRequest(HttpServletRequest request) {
    // 1. æ£€æŸ¥CSRF Token
    boolean tokenValid = validateCSRFToken(request);
    
    // 2. æ£€æŸ¥è¯·æ±‚æ¥æº
    boolean originValid = validateOrigin(request) || validateReferer(request);
    
    // ä¸¤ä¸ªæ¡ä»¶éƒ½æ»¡è¶³æ‰å…è®¸
    return tokenValid && originValid;
}
```

---

## 5. ğŸ­ ç‚¹å‡»åŠ«æŒæ”»å‡»ä¸é˜²æŠ¤


### 5.1 ç‚¹å‡»åŠ«æŒæ˜¯ä»€ä¹ˆ


**ğŸ’¡ é€šä¿—è§£é‡Š**ï¼š
ç‚¹å‡»åŠ«æŒå°±åƒ**å¥—å¨ƒé™·é˜±**ã€‚æ”»å‡»è€…æŠŠä½ è¦æ“ä½œçš„ç½‘ç«™**è—åœ¨é€æ˜å±‚ä¸‹é¢**ï¼Œä½ ä»¥ä¸ºç‚¹å‡»çš„æ˜¯æ— å®³æŒ‰é’®ï¼Œå®é™…ä¸Šç‚¹å‡»äº†å±é™©æ“ä½œã€‚

```
ç”¨æˆ·çœ‹åˆ°çš„ï¼š                   å®é™…æƒ…å†µï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   [å…è´¹æ¸¸æˆ]     â”‚           â”‚  é€æ˜çš„é“¶è¡Œé¡µé¢   â”‚ â† çœŸå®ç‚¹å‡»ç›®æ ‡
â”‚   ç‚¹å‡»å¼€å§‹ç©ï¼   â”‚           â”‚  [ç¡®è®¤è½¬è´¦]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†‘                              â†‘
   ç”¨æˆ·ä»¥ä¸ºç‚¹è¿™é‡Œ               å®é™…ç‚¹å‡»åˆ°è¿™é‡Œ
```

### 5.2 ç‚¹å‡»åŠ«æŒæ”»å‡»ç¤ºä¾‹


**âŒ æ¶æ„ç½‘ç«™ä»£ç **ï¼š
```html
<!DOCTYPE html>
<html>
<head>
    <style>
    #victim-site {
        position: absolute;
        top: 0;
        left: 0;
        opacity: 0.1;        /* å‡ ä¹é€æ˜ */
        z-index: 1000;       /* ç½®äºæœ€é¡¶å±‚ */
        width: 500px;
        height: 300px;
    }
    
    #fake-content {
        position: absolute;
        top: 50px;
        left: 100px;
        z-index: 1;          /* åœ¨ä¸‹å±‚ */
    }
    </style>
</head>
<body>
    <!-- å‡çš„è¯±é¥µå†…å®¹ -->
    <div id="fake-content">
        <h2>æ­å–œï¼æ‚¨ä¸­å¥–äº†ï¼</h2>
        <button>ç‚¹å‡»é¢†å–å¥–å“</button>
    </div>
    
    <!-- çœŸå®çš„é“¶è¡Œé¡µé¢ï¼ˆé€æ˜ï¼‰ -->
    <iframe id="victim-site" src="https://bank.com/transfer"></iframe>
</body>
</html>
```

### 5.3 X-Frame-Optionsé˜²æŠ¤


**ğŸ›¡ï¸ X-Frame-Optionsæ˜¯ä»€ä¹ˆ**ï¼š
è¿™ä¸ªHTTPå¤´å‘Šè¯‰æµè§ˆå™¨**æˆ‘çš„ç½‘é¡µä¸èƒ½è¢«åµŒå…¥åˆ°å…¶ä»–ç½‘ç«™çš„æ¡†æ¶ä¸­**ï¼Œå°±åƒç»™ç½‘é¡µåŠ äº†é˜²æŠ¤ç½©ã€‚

**ğŸ”§ X-Frame-Optionsä¸‰ç§è®¾ç½®**ï¼š

| å€¼ | **ä½œç”¨æ•ˆæœ** | **é€‚ç”¨åœºæ™¯** |
|---|------------|-------------|
| `DENY` | **å®Œå…¨ç¦æ­¢æ¡†æ¶åµŒå…¥** | `é«˜å®‰å…¨è¦æ±‚çš„é¡µé¢` |
| `SAMEORIGIN` | **åªå…è®¸åŒåŸŸåµŒå…¥** | `éœ€è¦å†…éƒ¨æ¡†æ¶çš„åº”ç”¨` |
| `ALLOW-FROM` | **åªå…è®¸æŒ‡å®šåŸŸåµŒå…¥** | `éœ€è¦ç‰¹å®šç¬¬ä¸‰æ–¹é›†æˆ` |

**âœ… æœåŠ¡å™¨é…ç½®ç¤ºä¾‹**ï¼š
```java
// Java Servleté…ç½®
response.setHeader("X-Frame-Options", "DENY");

// æˆ–è€…åªå…è®¸åŒæº
response.setHeader("X-Frame-Options", "SAMEORIGIN");
```

```nginx
# Nginxé…ç½®
add_header X-Frame-Options "SAMEORIGIN" always;
```

### 5.4 Content Security Policyé˜²æŠ¤


**ğŸš€ CSPæ›´å¼ºå¤§çš„é˜²æŠ¤**ï¼š
```http
Content-Security-Policy: frame-ancestors 'none';          // ç¦æ­¢æ‰€æœ‰åµŒå…¥
Content-Security-Policy: frame-ancestors 'self';          // åªå…è®¸åŒæº
Content-Security-Policy: frame-ancestors 'self' *.bank.com;  // å…è®¸ç‰¹å®šåŸŸå
```

**ğŸ’ª CSPç›¸æ¯”X-Frame-Optionsçš„ä¼˜åŠ¿**ï¼š
- ğŸ”¸ **æ›´çµæ´»**ï¼šæ”¯æŒå¤šåŸŸåç™½åå•
- ğŸ”¸ **æ›´ç°ä»£**ï¼šæ–°æ ‡å‡†ï¼ŒåŠŸèƒ½æ›´å¼º
- ğŸ”¸ **å‘å‰å…¼å®¹**ï¼šåŒæ—¶è®¾ç½®ä¸¤ä¸ªå¤´éƒ¨

---

## 6. ğŸª CookieåŠ«æŒé˜²æŠ¤æŠ€æœ¯


### 6.1 CookieåŠ«æŒæ˜¯ä»€ä¹ˆ


**ğŸ’¡ é€šä¿—è§£é‡Š**ï¼š
CookieåŠ«æŒå°±åƒ**å·èµ°ä½ çš„é—¨ç¦å¡**ã€‚æ”»å‡»è€…è·å–äº†ä½ çš„ç™»å½•å‡­è¯ï¼ˆCookieï¼‰ï¼Œå°±èƒ½**å†’å……ä½ çš„èº«ä»½**è®¿é—®ç½‘ç«™ã€‚

```
æ­£å¸¸æƒ…å†µï¼š
ä½ çš„æµè§ˆå™¨ â†’ Cookie[session=abc123] â†’ æœåŠ¡å™¨è¯†åˆ«ä½ 

åŠ«æŒæƒ…å†µï¼š
æ”»å‡»è€…æµè§ˆå™¨ â†’ Cookie[session=abc123] â†’ æœåŠ¡å™¨è¯¯è®¤ä¸ºæ˜¯ä½ 
```

### 6.2 CookieåŠ«æŒçš„å¸¸è§æ–¹å¼


**ğŸ¯ ä¸»è¦æ”»å‡»é€”å¾„**ï¼š

| æ”»å‡»æ–¹å¼ | **æ”»å‡»åŸç†** | **é˜²æŠ¤é‡ç‚¹** |
|---------|------------|-------------|
| ğŸŒ **ç½‘ç»œçªƒå¬** | `HTTPæ˜æ–‡ä¼ è¾“è¢«æˆªè·` | `ä½¿ç”¨HTTPSåŠ å¯†` |
| ğŸ’‰ **XSSæ”»å‡»** | `æ¶æ„è„šæœ¬è¯»å–Cookie` | `è®¾ç½®HttpOnlyå±æ€§` |
| ğŸ”— **ä¸­é—´äººæ”»å‡»** | `ä¼ªé€ WiFiçƒ­ç‚¹æˆªè·` | `éªŒè¯è¯ä¹¦ï¼Œé¿å…å…¬å…±WiFi` |
| ğŸ¦  **æ¶æ„è½¯ä»¶** | `æœ¬åœ°æœ¨é©¬ç¨‹åºçªƒå–` | `åŠæ—¶æ›´æ–°ç³»ç»Ÿå’Œæµè§ˆå™¨` |

### 6.3 HttpOnlyå±æ€§é˜²æŠ¤


**ğŸ”’ HttpOnlyå·¥ä½œåŸç†**ï¼š
```javascript
// æ²¡æœ‰HttpOnlyçš„Cookie
document.cookie = "session=abc123";
console.log(document.cookie); // å¯ä»¥è¯»å–åˆ°ï¼šsession=abc123

// è®¾ç½®HttpOnlyçš„Cookieï¼ˆæœåŠ¡ç«¯è®¾ç½®ï¼‰
Set-Cookie: session=abc123; HttpOnly
console.log(document.cookie); // è¯»ä¸åˆ°sessionè¿™ä¸ªCookie
```

**âœ… HttpOnlyçš„ä¿æŠ¤æ•ˆæœ**ï¼š
- ğŸ”¸ **é˜²æ­¢XSSè¯»å–**ï¼šæ¶æ„è„šæœ¬æ— æ³•è·å–Cookie
- ğŸ”¸ **æ­£å¸¸åŠŸèƒ½ä¸å—å½±å“**ï¼šæµè§ˆå™¨ä»ä¼šè‡ªåŠ¨å‘é€Cookie
- ğŸ”¸ **ç®€å•æœ‰æ•ˆ**ï¼šåªéœ€æ·»åŠ ä¸€ä¸ªå±æ€§

### 6.4 Secureå±æ€§é˜²æŠ¤


**ğŸ” Secureå±æ€§ä½œç”¨**ï¼š
```javascript
// åªèƒ½åœ¨HTTPSä¸‹ä¼ è¾“çš„Cookie
Set-Cookie: session=abc123; Secure

/*
æ•ˆæœï¼š
âœ… HTTPSè¿æ¥ï¼šCookieæ­£å¸¸å‘é€
âŒ HTTPè¿æ¥ï¼šCookieä¸ä¼šå‘é€
*/
```

### 6.5 Cookieå®Œæ•´æ€§éªŒè¯


**ğŸ›¡ï¸ Cookieç­¾åæœºåˆ¶**ï¼š
```java
// ç”Ÿæˆå¸¦ç­¾åçš„Cookie
public String createSignedCookie(String value, String secretKey) {
    String signature = hmacSha256(value, secretKey);
    return value + "." + signature;
}

// éªŒè¯Cookieå®Œæ•´æ€§
public boolean validateCookie(String cookie, String secretKey) {
    String[] parts = cookie.split("\\.");
    if (parts.length != 2) return false;
    
    String value = parts[0];
    String signature = parts[1];
    String expectedSignature = hmacSha256(value, secretKey);
    
    return signature.equals(expectedSignature);
}
```

---

## 7. ğŸ›¡ï¸ ç»¼åˆé˜²æŠ¤ç­–ç•¥


### 7.1 å¤šå±‚æ¬¡é˜²æŠ¤ä½“ç³»


**ğŸ¯ é˜²æŠ¤ç­–ç•¥ç»„åˆ**ï¼š
```
ç¬¬ä¸€å±‚ï¼šè¯·æ±‚æ¥æºéªŒè¯
â”œâ”€ Origin/Refererå¤´æ£€æŸ¥
â”œâ”€ SameSite Cookieå±æ€§
â””â”€ HTTPSå¼ºåˆ¶è·³è½¬

ç¬¬äºŒå±‚ï¼šèº«ä»½ç¡®è®¤æœºåˆ¶
â”œâ”€ CSRF TokenéªŒè¯
â”œâ”€ åŒå› ç´ è®¤è¯
â””â”€ éªŒè¯ç ç¡®è®¤

ç¬¬ä¸‰å±‚ï¼šå†…å®¹å®‰å…¨é˜²æŠ¤
â”œâ”€ X-Frame-Optionsè®¾ç½®
â”œâ”€ CSPç­–ç•¥é…ç½®
â””â”€ Cookieå®‰å…¨å±æ€§

ç¬¬å››å±‚ï¼šç›‘æ§å’Œå“åº”
â”œâ”€ å¼‚å¸¸è¯·æ±‚ç›‘æ§
â”œâ”€ IPåœ°å€åˆ†æ
â””â”€ ç”¨æˆ·è¡Œä¸ºæ£€æµ‹
```

### 7.2 æœ€ä½³å®è·µé…ç½®


**â­ æ¨èçš„å®‰å…¨é…ç½®**ï¼š
```java
// å®Œæ•´çš„å®‰å…¨é…ç½®ç¤ºä¾‹
public class SecurityConfig {
    
    // 1. Cookieå®‰å…¨è®¾ç½®
    public void configureSecureCookie(HttpServletResponse response) {
        String cookie = "session_id=" + generateSessionId() + 
                       "; HttpOnly" +           // é˜²æ­¢XSSè¯»å–
                       "; Secure" +             // ä»…HTTPSä¼ è¾“
                       "; SameSite=Strict" +    // é˜²æ­¢CSRF
                       "; Max-Age=3600" +       // 1å°æ—¶è¿‡æœŸ
                       "; Path=/";              // å…¨ç«™æœ‰æ•ˆ
        
        response.addHeader("Set-Cookie", cookie);
    }
    
    // 2. é˜²æŠ¤å¤´è®¾ç½®
    public void configureSecurityHeaders(HttpServletResponse response) {
        response.setHeader("X-Frame-Options", "SAMEORIGIN");
        response.setHeader("X-Content-Type-Options", "nosniff");
        response.setHeader("X-XSS-Protection", "1; mode=block");
        response.setHeader("Content-Security-Policy", 
                          "frame-ancestors 'self'; default-src 'self'");
    }
    
    // 3. CSRF TokenéªŒè¯
    public boolean validateRequest(HttpServletRequest request) {
        return validateCSRFToken(request) && 
               validateOrigin(request) && 
               checkRateLimit(request);
    }
}
```

### 7.3 åº”æ€¥å“åº”é¢„æ¡ˆ


**ğŸš¨ å‘ç°æ”»å‡»æ—¶çš„å¤„ç†æ­¥éª¤**ï¼š
```
å‘ç°å¼‚å¸¸ â†’ ç«‹å³åˆ†æ â†’ ç¡®è®¤æ”»å‡» â†’ åº”æ€¥å“åº”

æ­¥éª¤1: ğŸ” å¿«é€Ÿåˆ†æ
â”œâ”€ æŸ¥çœ‹è®¿é—®æ—¥å¿—
â”œâ”€ æ£€æŸ¥å¼‚å¸¸è¯·æ±‚
â””â”€ åˆ†ææ”»å‡»ç‰¹å¾

æ­¥éª¤2: ğŸ›¡ï¸ ç´§æ€¥é˜²æŠ¤
â”œâ”€ ä¸´æ—¶å°ç¦å¯ç–‘IP
â”œâ”€ åŠ å¼ºéªŒè¯æœºåˆ¶
â””â”€ é€šçŸ¥ç›¸å…³ç”¨æˆ·

æ­¥éª¤3: ğŸ”§ å½»åº•ä¿®å¤
â”œâ”€ ä¿®è¡¥å®‰å…¨æ¼æ´
â”œâ”€ æ›´æ–°é˜²æŠ¤ç­–ç•¥
â””â”€ åŠ å¼ºç›‘æ§æœºåˆ¶
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ CSRFæ”»å‡»ï¼šåˆ©ç”¨ç”¨æˆ·èº«ä»½æ‰§è¡Œæœªæˆæƒæ“ä½œ
ğŸ”¸ TokenéªŒè¯ï¼šé€šè¿‡éšæœºä»¤ç‰Œç¡®è®¤è¯·æ±‚åˆæ³•æ€§
ğŸ”¸ SameSite Cookieï¼šæ§åˆ¶è·¨ç«™è¯·æ±‚æ—¶Cookieå‘é€è§„åˆ™
ğŸ”¸ è¯·æ±‚å¤´éªŒè¯ï¼šæ£€æŸ¥Origin/Refererç¡®è®¤è¯·æ±‚æ¥æº
ğŸ”¸ ç‚¹å‡»åŠ«æŒï¼šé€šè¿‡é€æ˜æ¡†æ¶è¯±å¯¼ç”¨æˆ·è¯¯æ“ä½œ
ğŸ”¸ CookieåŠ«æŒï¼šçªƒå–ç”¨æˆ·ç™»å½•å‡­è¯å†’å……èº«ä»½
```

### 8.2 å…³é”®é˜²æŠ¤è¦ç‚¹


**ğŸ›¡ï¸ CSRFé˜²æŠ¤æ ¸å¿ƒ**ï¼š
```
Tokenæœºåˆ¶ï¼šæ¯ä¸ªæ•æ„Ÿæ“ä½œéƒ½éœ€è¦ä»¤ç‰ŒéªŒè¯
Cookieå®‰å…¨ï¼šè®¾ç½®SameSite/HttpOnly/Secureå±æ€§
æ¥æºéªŒè¯ï¼šæ£€æŸ¥è¯·æ±‚çš„Originå’ŒRefererå¤´
ç”¨æˆ·ç¡®è®¤ï¼šé‡è¦æ“ä½œéœ€è¦é¢å¤–ç¡®è®¤æ­¥éª¤
```

**ğŸ­ ç‚¹å‡»åŠ«æŒé˜²æŠ¤æ ¸å¿ƒ**ï¼š
```
X-Frame-Optionsï¼šç¦æ­¢æˆ–é™åˆ¶é¡µé¢è¢«åµŒå…¥æ¡†æ¶
CSPç­–ç•¥ï¼šä½¿ç”¨frame-ancestorsæŒ‡ä»¤ç²¾ç¡®æ§åˆ¶
ç”¨æˆ·æ•™è‚²ï¼šæé†’ç”¨æˆ·æ³¨æ„å¯ç–‘çš„é¡µé¢å¸ƒå±€
```

**ğŸª Cookieå®‰å…¨æ ¸å¿ƒ**ï¼š
```
HttpOnlyï¼šé˜²æ­¢JavaScriptè¯»å–Cookie
Secureï¼šå¼ºåˆ¶HTTPSä¼ è¾“
SameSiteï¼šæ§åˆ¶è·¨ç«™å‘é€è§„åˆ™
ç­¾åéªŒè¯ï¼šç¡®ä¿Cookieå®Œæ•´æ€§
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ ä¸åŒåœºæ™¯çš„é˜²æŠ¤é‡ç‚¹**ï¼š

| åº”ç”¨ç±»å‹ | **ä¸»è¦å¨èƒ** | **æ ¸å¿ƒé˜²æŠ¤** |
|---------|------------|-------------|
| ğŸ¦ **é‡‘èç³»ç»Ÿ** | `èµ„é‡‘å®‰å…¨` | `å¼ºåˆ¶Token+åŒå› ç´ è®¤è¯` |
| ğŸ“§ **é‚®ç®±ç³»ç»Ÿ** | `è´¦å·åŠ«æŒ` | `SameSite Strict+OriginéªŒè¯` |
| ğŸ›’ **ç”µå•†å¹³å°** | `æ¶æ„ä¸‹å•` | `TokenéªŒè¯+è¡Œä¸ºåˆ†æ` |
| âš™ï¸ **ç®¡ç†åå°** | `æƒé™æ»¥ç”¨` | `ä¸¥æ ¼çš„æ¡†æ¶é˜²æŠ¤+IPé™åˆ¶` |

**âœ… æ£€æŸ¥æ¸…å•**ï¼š
- [ ] æ‰€æœ‰æ•æ„Ÿæ“ä½œéƒ½æœ‰TokenéªŒè¯
- [ ] Cookieè®¾ç½®äº†å®Œæ•´çš„å®‰å…¨å±æ€§
- [ ] é¡µé¢è®¾ç½®äº†X-Frame-Optionså¤´
- [ ] å®æ–½äº†Origin/RefereréªŒè¯
- [ ] å»ºç«‹äº†å¼‚å¸¸ç›‘æ§æœºåˆ¶
- [ ] åˆ¶å®šäº†åº”æ€¥å“åº”é¢„æ¡ˆ

**æ ¸å¿ƒè®°å¿†**ï¼š
- CSRFé˜²æŠ¤é Tokenï¼Œæ¥æºéªŒè¯åŒä¿é™©
- ç‚¹å‡»åŠ«æŒç”¨æ¡†æ¶ï¼Œé€æ˜é™·é˜±è¦æé˜²
- Cookieå®‰å…¨ä¸‰å±æ€§ï¼ŒHttpOnlyé˜²XSSå·å–
- å¤šå±‚é˜²æŠ¤ç»„åˆç”¨ï¼Œç›‘æ§å“åº”ä¸èƒ½æ¾