---
title: 30ã€Springé›†æˆé—®é¢˜
---
## ğŸ“š ç›®å½•

1. [Springé›†æˆåŸºç¡€æ¦‚å¿µ](#1-Springé›†æˆåŸºç¡€æ¦‚å¿µ)
2. [é…ç½®æ–‡ä»¶å‚æ•°é—®é¢˜](#2-é…ç½®æ–‡ä»¶å‚æ•°é—®é¢˜)
3. [Beanç”Ÿå‘½å‘¨æœŸç®¡ç†](#3-Beanç”Ÿå‘½å‘¨æœŸç®¡ç†)
4. [æ³¨è§£é…ç½®å¸¸è§é—®é¢˜](#4-æ³¨è§£é…ç½®å¸¸è§é—®é¢˜)
5. [ç›‘å¬å™¨é…ç½®å¼‚å¸¸](#5-ç›‘å¬å™¨é…ç½®å¼‚å¸¸)
6. [äº‹åŠ¡ç®¡ç†é›†æˆ](#6-äº‹åŠ¡ç®¡ç†é›†æˆ)
7. [è¿æ¥å·¥å‚é…ç½®](#7-è¿æ¥å·¥å‚é…ç½®)
8. [æ¨¡æ¿ç±»ä½¿ç”¨é—®é¢˜](#8-æ¨¡æ¿ç±»ä½¿ç”¨é—®é¢˜)
9. [è‡ªåŠ¨é…ç½®å†²çª](#9-è‡ªåŠ¨é…ç½®å†²çª)
10. [ç‰ˆæœ¬å…¼å®¹æ€§é—®é¢˜](#10-ç‰ˆæœ¬å…¼å®¹æ€§é—®é¢˜)
11. [æµ‹è¯•ç¯å¢ƒé…ç½®](#11-æµ‹è¯•ç¯å¢ƒé…ç½®)
12. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#12-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ± Springé›†æˆåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Spring RabbitMQé›†æˆ


**ç®€å•ç†è§£**ï¼šå°±æ˜¯è®©Springæ¡†æ¶å’ŒRabbitMQæ¶ˆæ¯é˜Ÿåˆ—"æ‰‹æ‹‰æ‰‹"å·¥ä½œï¼Œè®©æˆ‘ä»¬åœ¨Springé¡¹ç›®ä¸­è½»æ¾ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—åŠŸèƒ½ã€‚

```
ä¼ ç»Ÿæ–¹å¼ï¼š                     Springé›†æˆæ–¹å¼ï¼š
ç¨‹åºå‘˜æ‰‹å†™ä»£ç  â†’ RabbitMQ     Springè‡ªåŠ¨ç®¡ç† â†’ RabbitMQ
(å¤æ‚ã€å®¹æ˜“å‡ºé”™)                (ç®€å•ã€ç¨³å®šå¯é )
```

**æ ¸å¿ƒä»·å€¼**ï¼š
- ğŸ”„ **è‡ªåŠ¨ç®¡ç†è¿æ¥**ï¼šä¸ç”¨æ‰‹åŠ¨å¼€å…³è¿æ¥
- ğŸ› ï¸ **ç®€åŒ–é…ç½®**ï¼šç”¨æ³¨è§£å’Œé…ç½®æ–‡ä»¶å°±èƒ½æå®š
- ğŸ“¦ **ç»Ÿä¸€ç®¡ç†**ï¼šæ¶ˆæ¯é˜Ÿåˆ—å’Œä¸šåŠ¡é€»è¾‘éƒ½åœ¨Springå®¹å™¨ä¸­
- ğŸ”’ **äº‹åŠ¡æ”¯æŒ**ï¼šå¯ä»¥å’Œæ•°æ®åº“äº‹åŠ¡ä¸€èµ·ç®¡ç†

### 1.2 Spring AMQPæ ¸å¿ƒç»„ä»¶


**ç»„ä»¶å…³ç³»å›¾**ï¼š
```
Springåº”ç”¨
    â†“
RabbitTemplate (å‘é€æ¶ˆæ¯çš„å·¥å…·)
    â†“
ConnectionFactory (è¿æ¥å·¥å‚)
    â†“
RabbitMQæœåŠ¡å™¨

åå‘æ¥æ”¶ï¼š
RabbitMQæœåŠ¡å™¨
    â†“
MessageListener (æ¶ˆæ¯ç›‘å¬å™¨)
    â†“
@RabbitListener (æ³¨è§£ç›‘å¬)
    â†“
ä¸šåŠ¡å¤„ç†æ–¹æ³•
```

**ä¸»è¦ç»„ä»¶è¯´æ˜**ï¼š
- **RabbitTemplate**ï¼šå‘é€æ¶ˆæ¯çš„"å¿«é€’å‘˜"
- **ConnectionFactory**ï¼šå»ºç«‹è¿æ¥çš„"æ¡¥æ¢"
- **@RabbitListener**ï¼šæ¥æ”¶æ¶ˆæ¯çš„"æ”¶ä»¶äºº"
- **RabbitAdmin**ï¼šç®¡ç†é˜Ÿåˆ—å’Œäº¤æ¢æœºçš„"ç®¡ç†å‘˜"

---

## 2. âš™ï¸ é…ç½®æ–‡ä»¶å‚æ•°é—®é¢˜


### 2.1 å¸¸è§é…ç½®é”™è¯¯ç±»å‹


**ğŸš¨ å…¸å‹é”™è¯¯åœºæ™¯**ï¼š

| é”™è¯¯ç±»å‹ | ç—‡çŠ¶è¡¨ç° | æ–°æ‰‹æ˜“çŠ¯æŒ‡æ•° |
|---------|---------|-------------|
| ç«¯å£é…ç½®é”™è¯¯ | è¿æ¥è¶…æ—¶ | â­â­â­â­â­ |
| è™šæ‹Ÿä¸»æœºé”™è¯¯ | è®¤è¯å¤±è´¥ | â­â­â­â­ |
| ç”¨æˆ·åå¯†ç é”™è¯¯ | ç™»å½•è¢«æ‹’ç» | â­â­â­â­â­ |
| é˜Ÿåˆ—åç§°ä¸åŒ¹é… | æ¶ˆæ¯å‘é€å¤±è´¥ | â­â­â­ |

### 2.2 application.ymlé…ç½®è¯¦è§£


**âœ… æ­£ç¡®é…ç½®ç¤ºä¾‹**ï¼š
```yaml
spring:
  rabbitmq:
    # åŸºç¡€è¿æ¥é…ç½®
    host: localhost          # RabbitMQæœåŠ¡å™¨åœ°å€
    port: 5672              # é»˜è®¤ç«¯å£(ç®¡ç†ç•Œé¢æ˜¯15672)
    username: guest         # ç”¨æˆ·å
    password: guest         # å¯†ç 
    virtual-host: /         # è™šæ‹Ÿä¸»æœº(é»˜è®¤æ˜¯/)
    
    # è¿æ¥æ± é…ç½®
    connection-timeout: 15s  # è¿æ¥è¶…æ—¶æ—¶é—´
    
    # å‘å¸ƒè€…ç¡®è®¤æœºåˆ¶
    publisher-confirm-type: correlated  # å¼€å¯å‘å¸ƒç¡®è®¤
    publisher-returns: true             # å¼€å¯å‘å¸ƒè¿”å›
    
    # æ¶ˆè´¹è€…é…ç½®
    listener:
      simple:
        acknowledge-mode: manual        # æ‰‹åŠ¨ç¡®è®¤æ¨¡å¼
        retry:
          enabled: true                # å¼€å¯é‡è¯•
          max-attempts: 3              # æœ€å¤§é‡è¯•æ¬¡æ•°
```

**âŒ å¸¸è§é”™è¯¯é…ç½®**ï¼š
```yaml
# é”™è¯¯1ï¼šç«¯å£ææ··äº†
spring:
  rabbitmq:
    port: 15672  # âŒ è¿™æ˜¯ç®¡ç†ç•Œé¢ç«¯å£ï¼Œä¸æ˜¯æ¶ˆæ¯ç«¯å£ï¼

# é”™è¯¯2ï¼šè™šæ‹Ÿä¸»æœºæ ¼å¼é”™è¯¯  
spring:
  rabbitmq:
    virtual-host: test  # âŒ åº”è¯¥æ˜¯ /test

# é”™è¯¯3ï¼šç¡®è®¤æ¨¡å¼é…ç½®é”™è¯¯
spring:
  rabbitmq:
    listener:
      simple:
        acknowledge-mode: auto  # âŒ æ‹¼å†™é”™è¯¯ï¼Œåº”è¯¥æ˜¯automatic
```

### 2.3 é…ç½®éªŒè¯æ–¹æ³•


**ğŸ” å¿«é€Ÿæ£€æŸ¥é…ç½®æ˜¯å¦æ­£ç¡®**ï¼š

```java
@Component
public class RabbitMQConfigChecker {
    
    @Autowired
    private ConnectionFactory connectionFactory;
    
    @PostConstruct
    public void checkConnection() {
        try {
            Connection connection = connectionFactory.createConnection();
            System.out.println("âœ… RabbitMQè¿æ¥æˆåŠŸï¼");
            connection.close();
        } catch (Exception e) {
            System.err.println("âŒ RabbitMQè¿æ¥å¤±è´¥ï¼š" + e.getMessage());
        }
    }
}
```

---

## 3. ğŸ”„ Beanç”Ÿå‘½å‘¨æœŸç®¡ç†


### 3.1 Beanç”Ÿå‘½å‘¨æœŸé—®é¢˜åŸç†


**ä¸ºä»€ä¹ˆä¼šæœ‰ç”Ÿå‘½å‘¨æœŸé—®é¢˜**ï¼š
Springå®¹å™¨ç®¡ç†Beançš„åˆ›å»ºã€åˆå§‹åŒ–ã€ä½¿ç”¨ã€é”€æ¯è¿‡ç¨‹ï¼Œå¦‚æœæ—¶æœºä¸å¯¹å°±ä¼šå‡ºé—®é¢˜ã€‚

```
Springå®¹å™¨å¯åŠ¨æµç¨‹ï¼š
1. åˆ›å»ºBeanå®ä¾‹
2. æ³¨å…¥ä¾èµ–
3. åˆå§‹åŒ–Bean
4. Beanå¯ä»¥ä½¿ç”¨
5. å®¹å™¨å…³é—­æ—¶é”€æ¯Bean

é—®é¢˜å¸¸å‡ºç°åœ¨ï¼šæ­¥éª¤2å’Œ3ä¹‹é—´
```

### 3.2 å¸¸è§ç”Ÿå‘½å‘¨æœŸé—®é¢˜


**ğŸ”¸ é—®é¢˜ä¸€ï¼šä¾èµ–æ³¨å…¥æ—¶æœºé”™è¯¯**

```java
// âŒ é”™è¯¯åšæ³•ï¼šåœ¨æ„é€ å‡½æ•°ä¸­ä½¿ç”¨RabbitTemplate
@Service
public class MessageService {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    public MessageService() {
        // âŒ è¿™æ—¶rabbitTemplateè¿˜æ˜¯nullï¼
        rabbitTemplate.convertAndSend("test.queue", "hello");
    }
}
```

**âœ… æ­£ç¡®åšæ³•**ï¼š
```java
@Service
public class MessageService {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    // âœ… åœ¨åˆå§‹åŒ–æ–¹æ³•ä¸­ä½¿ç”¨
    @PostConstruct
    public void init() {
        rabbitTemplate.convertAndSend("test.queue", "hello");
    }
}
```

**ğŸ”¸ é—®é¢˜äºŒï¼šç›‘å¬å™¨å¯åŠ¨é¡ºåºé—®é¢˜**

```java
// âŒ å¯èƒ½å‡ºç°é˜Ÿåˆ—è¿˜æ²¡åˆ›å»ºï¼Œç›‘å¬å™¨å°±å¯åŠ¨äº†
@Component
public class QueueConfig {
    
    @Bean
    public Queue testQueue() {
        return new Queue("test.queue");
    }
}

@Component  
public class MessageListener {
    
    // âŒ é˜Ÿåˆ—å¯èƒ½è¿˜æ²¡åˆ›å»ºå®Œæˆ
    @RabbitListener(queues = "test.queue")
    public void handleMessage(String message) {
        System.out.println("æ”¶åˆ°æ¶ˆæ¯ï¼š" + message);
    }
}
```

**âœ… è§£å†³æ–¹æ¡ˆ**ï¼š
```java
@Component
@DependsOn("rabbitAdmin")  // âœ… ç¡®ä¿RabbitAdminå…ˆåˆ›å»º
public class MessageListener {
    
    @RabbitListener(queues = "test.queue")
    public void handleMessage(String message) {
        System.out.println("æ”¶åˆ°æ¶ˆæ¯ï¼š" + message);
    }
}
```

### 3.3 ç”Ÿå‘½å‘¨æœŸæœ€ä½³å®è·µ


**ğŸ“‹ æ¨èçš„Beanåˆ›å»ºé¡ºåº**ï¼š

```java
@Configuration
public class RabbitMQConfig {
    
    // 1ï¸âƒ£ é¦–å…ˆåˆ›å»ºè¿æ¥å·¥å‚
    @Bean
    @Primary
    public ConnectionFactory connectionFactory() {
        CachingConnectionFactory factory = new CachingConnectionFactory();
        factory.setHost("localhost");
        factory.setPort(5672);
        return factory;
    }
    
    // 2ï¸âƒ£ ç„¶ååˆ›å»ºRabbitAdmin
    @Bean
    public RabbitAdmin rabbitAdmin(ConnectionFactory connectionFactory) {
        return new RabbitAdmin(connectionFactory);
    }
    
    // 3ï¸âƒ£ åˆ›å»ºé˜Ÿåˆ—ã€äº¤æ¢æœº
    @Bean
    public Queue testQueue() {
        return QueueBuilder.durable("test.queue").build();
    }
    
    // 4ï¸âƒ£ æœ€ååˆ›å»ºRabbitTemplate
    @Bean
    public RabbitTemplate rabbitTemplate(ConnectionFactory connectionFactory) {
        return new RabbitTemplate(connectionFactory);
    }
}
```

---

## 4. ğŸ“ æ³¨è§£é…ç½®å¸¸è§é—®é¢˜


### 4.1 @RabbitListeneræ³¨è§£é—®é¢˜


**ğŸ”¸ å¸¸è§é”™è¯¯ç±»å‹**ï¼š

| é”™è¯¯ç±»å‹ | è¡¨ç°ç—‡çŠ¶ | è§£å†³éš¾åº¦ |
|---------|---------|---------|
| é˜Ÿåˆ—åå†™é”™ | ç›‘å¬å™¨ä¸å·¥ä½œ | â­ |
| å‚æ•°ç±»å‹ä¸åŒ¹é… | ååºåˆ—åŒ–å¤±è´¥ | â­â­â­ |
| å¼‚å¸¸å¤„ç†ç¼ºå¤± | æ¶ˆæ¯é‡å¤æ¶ˆè´¹ | â­â­â­â­ |
| å¹¶å‘é…ç½®é”™è¯¯ | æ€§èƒ½é—®é¢˜ | â­â­â­ |

**âŒ å…¸å‹é”™è¯¯ç¤ºä¾‹**ï¼š
```java
public class MessageListener {
    
    // é”™è¯¯1ï¼šé˜Ÿåˆ—åæ‹¼å†™é”™è¯¯
    @RabbitListener(queues = "test_queue")  // âŒ å®é™…é˜Ÿåˆ—åæ˜¯test.queue
    public void handleMessage1(String message) {
        // æ°¸è¿œä¸ä¼šæ”¶åˆ°æ¶ˆæ¯
    }
    
    // é”™è¯¯2ï¼šå‚æ•°ç±»å‹ä¸åŒ¹é…
    @RabbitListener(queues = "user.queue")
    public void handleMessage2(String message) {  // âŒ å®é™…å‘é€çš„æ˜¯Userå¯¹è±¡
        // ä¼šæŠ¥JSONååºåˆ—åŒ–é”™è¯¯
    }
    
    // é”™è¯¯3ï¼šæ²¡æœ‰å¼‚å¸¸å¤„ç†
    @RabbitListener(queues = "order.queue")
    public void handleMessage3(String message) {
        int result = 10 / 0;  // âŒ è¿è¡Œæ—¶å¼‚å¸¸ä¼šå¯¼è‡´æ¶ˆæ¯é‡å¤æ¶ˆè´¹
    }
}
```

**âœ… æ­£ç¡®åšæ³•**ï¼š
```java
@Component
public class MessageListener {
    
    private static final Logger logger = LoggerFactory.getLogger(MessageListener.class);
    
    // âœ… æ­£ç¡®çš„ç›‘å¬å™¨å†™æ³•
    @RabbitListener(queues = "user.queue")
    public void handleUserMessage(
        @Payload User user,                    // æ˜ç¡®æŒ‡å®šå‚æ•°ç±»å‹
        @Header Map<String, Object> headers,   // è·å–æ¶ˆæ¯å¤´
        Channel channel,                       // è·å–ä¿¡é“ç”¨äºæ‰‹åŠ¨ç¡®è®¤
        @Header(AmqpHeaders.DELIVERY_TAG) long deliveryTag
    ) {
        try {
            // ä¸šåŠ¡å¤„ç†é€»è¾‘
            processUser(user);
            
            // æ‰‹åŠ¨ç¡®è®¤æ¶ˆæ¯
            channel.basicAck(deliveryTag, false);
            logger.info("ç”¨æˆ·æ¶ˆæ¯å¤„ç†æˆåŠŸï¼š{}", user.getName());
            
        } catch (Exception e) {
            logger.error("ç”¨æˆ·æ¶ˆæ¯å¤„ç†å¤±è´¥", e);
            try {
                // æ‹’ç»æ¶ˆæ¯ï¼Œä¸é‡æ–°å…¥é˜Ÿ
                channel.basicReject(deliveryTag, false);
            } catch (IOException ioException) {
                logger.error("æ¶ˆæ¯ç¡®è®¤å¤±è´¥", ioException);
            }
        }
    }
    
    private void processUser(User user) {
        // å…·ä½“ä¸šåŠ¡é€»è¾‘
    }
}
```

### 4.2 @EnableRabbitæ³¨è§£é—®é¢˜


**ğŸ”¸ å¿˜è®°å¯ç”¨æ³¨è§£**ï¼š
```java
// âŒ å¿˜è®°æ·»åŠ @EnableRabbit
@SpringBootApplication
public class Application {
    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }
}
```

**âœ… æ­£ç¡®é…ç½®**ï¼š
```java
@SpringBootApplication
@EnableRabbit  // âœ… å¯ç”¨RabbitMQæ³¨è§£æ”¯æŒ
public class Application {
    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }
}
```

### 4.3 æ¶ˆæ¯è½¬æ¢å™¨é…ç½®


**ğŸ”¸ æ¶ˆæ¯è½¬æ¢é—®é¢˜**ï¼š
å½“å‘é€Javaå¯¹è±¡æ—¶ï¼Œéœ€è¦é…ç½®åˆé€‚çš„æ¶ˆæ¯è½¬æ¢å™¨ã€‚

```java
@Configuration
public class RabbitMQConfig {
    
    // âœ… é…ç½®JSONæ¶ˆæ¯è½¬æ¢å™¨
    @Bean
    public RabbitTemplate rabbitTemplate(ConnectionFactory connectionFactory) {
        RabbitTemplate template = new RabbitTemplate(connectionFactory);
        
        // è®¾ç½®JSONè½¬æ¢å™¨
        template.setMessageConverter(new Jackson2JsonMessageConverter());
        
        return template;
    }
    
    // âœ… é…ç½®ç›‘å¬å™¨å®¹å™¨å·¥å‚
    @Bean
    public RabbitListenerContainerFactory<?> rabbitListenerContainerFactory(
            ConnectionFactory connectionFactory) {
        
        SimpleRabbitListenerContainerFactory factory = 
            new SimpleRabbitListenerContainerFactory();
        factory.setConnectionFactory(connectionFactory);
        
        // è®¾ç½®JSONè½¬æ¢å™¨
        factory.setMessageConverter(new Jackson2JsonMessageConverter());
        
        return factory;
    }
}
```

---

## 5. ğŸ‘‚ ç›‘å¬å™¨é…ç½®å¼‚å¸¸


### 5.1 ç›‘å¬å™¨ä¸å·¥ä½œçš„åŸå› 


**ğŸ” å¸¸è§åŸå› æ’æŸ¥æ¸…å•**ï¼š

- [ ] **é˜Ÿåˆ—æ˜¯å¦å­˜åœ¨** - é˜Ÿåˆ—åæ˜¯å¦æ­£ç¡®
- [ ] **ç›‘å¬å™¨æ˜¯å¦æ³¨å†Œ** - Springæ˜¯å¦æ‰«æåˆ°ç›‘å¬å™¨ç±»
- [ ] **è¿æ¥æ˜¯å¦æ­£å¸¸** - RabbitMQæœåŠ¡æ˜¯å¦å¯ç”¨
- [ ] **æƒé™æ˜¯å¦è¶³å¤Ÿ** - ç”¨æˆ·æ˜¯å¦æœ‰é˜Ÿåˆ—è¯»å–æƒé™

### 5.2 ç›‘å¬å™¨å®¹å™¨é…ç½®


**ğŸ”¸ åŸºç¡€å®¹å™¨é…ç½®**ï¼š
```java
@Configuration
public class RabbitListenerConfig {
    
    @Bean
    public SimpleRabbitListenerContainerFactory rabbitListenerContainerFactory(
            ConnectionFactory connectionFactory) {
        
        SimpleRabbitListenerContainerFactory factory = 
            new SimpleRabbitListenerContainerFactory();
        
        // åŸºç¡€é…ç½®
        factory.setConnectionFactory(connectionFactory);
        factory.setConcurrentConsumers(2);        // åˆå§‹æ¶ˆè´¹è€…æ•°é‡
        factory.setMaxConcurrentConsumers(5);     // æœ€å¤§æ¶ˆè´¹è€…æ•°é‡
        factory.setPrefetchCount(10);             // é¢„å–æ¶ˆæ¯æ•°é‡
        
        // ç¡®è®¤æ¨¡å¼
        factory.setAcknowledgeMode(AcknowledgeMode.MANUAL);
        
        // é‡è¯•é…ç½®
        factory.setDefaultRequeueRejected(false); // æ‹’ç»çš„æ¶ˆæ¯ä¸é‡æ–°å…¥é˜Ÿ
        
        return factory;
    }
}
```

### 5.3 ç›‘å¬å™¨æ€§èƒ½è°ƒä¼˜


**ğŸ“Š æ€§èƒ½å‚æ•°å¯¹æ¯”è¡¨**ï¼š

| å‚æ•° | é»˜è®¤å€¼ | æ¨èå€¼ | è¯´æ˜ |
|------|--------|-------|------|
| `concurrentConsumers` | 1 | 2-4 | å¹¶å‘æ¶ˆè´¹è€…æ•°é‡ |
| `maxConcurrentConsumers` | 1 | CPUæ ¸æ•°Ã—2 | æœ€å¤§æ¶ˆè´¹è€…æ•°é‡ |
| `prefetchCount` | 1 | 10-50 | é¢„å–æ¶ˆæ¯æ•°é‡ |
| `receiveTimeout` | 1000ms | 2000ms | æ¥æ”¶è¶…æ—¶æ—¶é—´ |

**ğŸ’¡ æ€§èƒ½è°ƒä¼˜å»ºè®®**ï¼š
```java
// âœ… é«˜æ€§èƒ½ç›‘å¬å™¨é…ç½®
@RabbitListener(
    queues = "high.performance.queue",
    concurrency = "2-8"  // åŠ¨æ€è°ƒæ•´æ¶ˆè´¹è€…æ•°é‡
)
public void handleHighVolumeMessage(String message) {
    // é«˜ååé‡æ¶ˆæ¯å¤„ç†
}

// âœ… ä½å»¶è¿Ÿç›‘å¬å™¨é…ç½®  
@RabbitListener(
    queues = "low.latency.queue",
    concurrency = "1"    // å•æ¶ˆè´¹è€…ä¿è¯é¡ºåº
)
public void handleLowLatencyMessage(String message) {
    // ä½å»¶è¿Ÿæ¶ˆæ¯å¤„ç†
}
```

---

## 6. ğŸ” äº‹åŠ¡ç®¡ç†é›†æˆ


### 6.1 äº‹åŠ¡ç®¡ç†åŸºæœ¬æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯æ¶ˆæ¯äº‹åŠ¡**ï¼š
å°±æ˜¯è®©æ¶ˆæ¯å‘é€å’Œæ•°æ®åº“æ“ä½œ"è¦ä¹ˆä¸€èµ·æˆåŠŸï¼Œè¦ä¹ˆä¸€èµ·å¤±è´¥"çš„æœºåˆ¶ã€‚

```
åœºæ™¯ä¸¾ä¾‹ï¼šç”¨æˆ·ä¸‹å•æµç¨‹
1. åœ¨æ•°æ®åº“ä¸­åˆ›å»ºè®¢å•è®°å½•
2. å‘é€è®¢å•æ¶ˆæ¯åˆ°RabbitMQ
3. å¦‚æœä»»ä½•ä¸€æ­¥å¤±è´¥ï¼Œéƒ½è¦å›æ»š

ç›®æ ‡ï¼šä¿è¯æ•°æ®ä¸€è‡´æ€§
```

### 6.2 äº‹åŠ¡é…ç½®æ–¹å¼


**ğŸ”¸ æ–¹å¼ä¸€ï¼šSpringäº‹åŠ¡ç®¡ç†å™¨**

```java
@Configuration
@EnableTransactionManagement
public class TransactionConfig {
    
    // âœ… é…ç½®RabbitMQäº‹åŠ¡ç®¡ç†å™¨
    @Bean
    public RabbitTransactionManager rabbitTransactionManager(
            ConnectionFactory connectionFactory) {
        return new RabbitTransactionManager(connectionFactory);
    }
    
    // âœ… é…ç½®äº‹åŠ¡æ¨¡æ¿
    @Bean
    public RabbitTemplate transactionalRabbitTemplate(
            ConnectionFactory connectionFactory) {
        RabbitTemplate template = new RabbitTemplate(connectionFactory);
        template.setChannelTransacted(true);  // å¼€å¯äº‹åŠ¡
        return template;
    }
}
```

**ğŸ”¸ æ–¹å¼äºŒï¼šä½¿ç”¨@Transactionalæ³¨è§£**

```java
@Service
public class OrderService {
    
    @Autowired
    private OrderRepository orderRepository;
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    // âœ… åŒæ—¶ç®¡ç†æ•°æ®åº“å’Œæ¶ˆæ¯äº‹åŠ¡
    @Transactional(rollbackFor = Exception.class)
    public void createOrder(Order order) {
        try {
            // 1. ä¿å­˜è®¢å•åˆ°æ•°æ®åº“
            orderRepository.save(order);
            
            // 2. å‘é€è®¢å•æ¶ˆæ¯
            rabbitTemplate.convertAndSend("order.exchange", "order.created", order);
            
            System.out.println("è®¢å•åˆ›å»ºæˆåŠŸï¼š" + order.getId());
            
        } catch (Exception e) {
            // å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œæ•°æ®åº“å’Œæ¶ˆæ¯éƒ½ä¼šå›æ»š
            throw new RuntimeException("è®¢å•åˆ›å»ºå¤±è´¥", e);
        }
    }
}
```

### 6.3 äº‹åŠ¡å¸¸è§é—®é¢˜


**ğŸš¨ é—®é¢˜ä¸€ï¼šäº‹åŠ¡é…ç½®ä¸ç”Ÿæ•ˆ**

```java
// âŒ é”™è¯¯ï¼šæ²¡æœ‰å¼€å¯äº‹åŠ¡æ”¯æŒ
@Bean
public RabbitTemplate rabbitTemplate(ConnectionFactory connectionFactory) {
    RabbitTemplate template = new RabbitTemplate(connectionFactory);
    // å¿˜è®°è®¾ç½®channelTransactedä¸ºtrue
    return template;
}

// âœ… æ­£ç¡®ï¼šå¼€å¯äº‹åŠ¡æ”¯æŒ
@Bean
public RabbitTemplate rabbitTemplate(ConnectionFactory connectionFactory) {
    RabbitTemplate template = new RabbitTemplate(connectionFactory);
    template.setChannelTransacted(true);  // å¼€å¯äº‹åŠ¡
    return template;
}
```

**ğŸš¨ é—®é¢˜äºŒï¼šäº‹åŠ¡è¾¹ç•Œä¸æ˜ç¡®**

```java
@Service  
public class UserService {
    
    @Transactional
    public void processUser(User user) {
        // æ•°æ®åº“æ“ä½œåœ¨äº‹åŠ¡ä¸­
        userRepository.save(user);
        
        // âŒ è¿™ä¸ªæ–¹æ³•è°ƒç”¨ä¼šå¼€å¯æ–°äº‹åŠ¡
        messageService.sendUserMessage(user);
    }
}

@Service
public class MessageService {
    
    @Transactional(propagation = Propagation.REQUIRES_NEW)  // âŒ æ–°äº‹åŠ¡
    public void sendUserMessage(User user) {
        rabbitTemplate.convertAndSend("user.queue", user);
    }
}
```

**âœ… æ­£ç¡®åšæ³•ï¼šç»Ÿä¸€äº‹åŠ¡è¾¹ç•Œ**

```java
@Service
public class UserService {
    
    @Transactional
    public void processUser(User user) {
        // æ•°æ®åº“æ“ä½œ
        userRepository.save(user);
        
        // æ¶ˆæ¯å‘é€ï¼Œä½¿ç”¨ç›¸åŒäº‹åŠ¡
        rabbitTemplate.convertAndSend("user.queue", user);
    }
}
```

---

## 7. ğŸ”Œ è¿æ¥å·¥å‚é…ç½®


### 7.1 è¿æ¥å·¥å‚åŸºæœ¬æ¦‚å¿µ


**è¿æ¥å·¥å‚çš„ä½œç”¨**ï¼š
å°±åƒç”µè¯æ€»æœºä¸€æ ·ï¼Œè´Ÿè´£å»ºç«‹å’Œç®¡ç†åº”ç”¨ç¨‹åºåˆ°RabbitMQæœåŠ¡å™¨çš„è¿æ¥ã€‚

```
åº”ç”¨ç¨‹åº â†’ è¿æ¥å·¥å‚ â†’ RabbitMQè¿æ¥ â†’ æ¶ˆæ¯æ”¶å‘

å¥½å¤„ï¼š
- è¿æ¥å¤ç”¨ï¼ˆä¸ç”¨æ¯æ¬¡éƒ½å»ºç«‹æ–°è¿æ¥ï¼‰
- è¿æ¥æ± ç®¡ç†ï¼ˆæ§åˆ¶è¿æ¥æ•°é‡ï¼‰
- è‡ªåŠ¨é‡è¿ï¼ˆç½‘ç»œæ–­å¼€æ—¶è‡ªåŠ¨æ¢å¤ï¼‰
```

### 7.2 è¿æ¥æ± é…ç½®è¯¦è§£


**ğŸ”¸ åŸºç¡€è¿æ¥æ± é…ç½®**ï¼š

```java
@Configuration
public class ConnectionFactoryConfig {
    
    @Bean
    public CachingConnectionFactory connectionFactory() {
        CachingConnectionFactory factory = new CachingConnectionFactory();
        
        // åŸºæœ¬è¿æ¥ä¿¡æ¯
        factory.setHost("localhost");
        factory.setPort(5672);
        factory.setUsername("admin");
        factory.setPassword("admin123");
        factory.setVirtualHost("/");
        
        // è¿æ¥æ± é…ç½®
        factory.setConnectionCacheSize(10);      // è¿æ¥ç¼“å­˜å¤§å°
        factory.setChannelCacheSize(100);        // ä¿¡é“ç¼“å­˜å¤§å°
        factory.setConnectionTimeout(15000);     // è¿æ¥è¶…æ—¶15ç§’
        
        // å‘å¸ƒè€…ç¡®è®¤
        factory.setPublisherConfirmType(CachingConnectionFactory.ConfirmType.CORRELATED);
        factory.setPublisherReturns(true);
        
        return factory;
    }
}
```

### 7.3 è¿æ¥é—®é¢˜è¯Šæ–­


**ğŸ” è¿æ¥é—®é¢˜æ’æŸ¥æ­¥éª¤**ï¼š

```java
@Component
public class ConnectionDiagnostic {
    
    @Autowired
    private ConnectionFactory connectionFactory;
    
    @PostConstruct
    public void diagnoseConnection() {
        
        System.out.println("ğŸ” å¼€å§‹è¯Šæ–­RabbitMQè¿æ¥...");
        
        // 1ï¸âƒ£ æ£€æŸ¥åŸºæœ¬è¿æ¥
        checkBasicConnection();
        
        // 2ï¸âƒ£ æ£€æŸ¥æƒé™
        checkPermissions();
        
        // 3ï¸âƒ£ æ£€æŸ¥é˜Ÿåˆ—è®¿é—®
        checkQueueAccess();
    }
    
    private void checkBasicConnection() {
        try {
            Connection connection = connectionFactory.createConnection();
            System.out.println("âœ… åŸºæœ¬è¿æ¥æ­£å¸¸");
            connection.close();
        } catch (Exception e) {
            System.err.println("âŒ è¿æ¥å¤±è´¥ï¼š" + e.getMessage());
            
            // å¸¸è§é”™è¯¯åˆ†æ
            if (e.getMessage().contains("Connection refused")) {
                System.err.println("ğŸ’¡ å¯èƒ½åŸå› ï¼šRabbitMQæœåŠ¡æœªå¯åŠ¨æˆ–ç«¯å£é”™è¯¯");
            } else if (e.getMessage().contains("ACCESS_REFUSED")) {
                System.err.println("ğŸ’¡ å¯èƒ½åŸå› ï¼šç”¨æˆ·åå¯†ç é”™è¯¯æˆ–æƒé™ä¸è¶³");
            }
        }
    }
    
    private void checkPermissions() {
        try {
            Connection connection = connectionFactory.createConnection();
            Channel channel = connection.createChannel();
            
            // å°è¯•å£°æ˜ä¸€ä¸ªä¸´æ—¶é˜Ÿåˆ—
            channel.queueDeclare("test.connection.queue", false, true, true, null);
            System.out.println("âœ… æƒé™æ£€æŸ¥é€šè¿‡");
            
            channel.close();
            connection.close();
        } catch (Exception e) {
            System.err.println("âŒ æƒé™æ£€æŸ¥å¤±è´¥ï¼š" + e.getMessage());
        }
    }
    
    private void checkQueueAccess() {
        // é˜Ÿåˆ—è®¿é—®æ£€æŸ¥é€»è¾‘
    }
}
```

---

## 8. ğŸ“¨ æ¨¡æ¿ç±»ä½¿ç”¨é—®é¢˜


### 8.1 RabbitTemplateåŸºæœ¬ç”¨æ³•


**RabbitTemplateæ˜¯ä»€ä¹ˆ**ï¼š
å°±åƒé‚®å±€çš„é‚®é€’å‘˜ï¼Œä¸“é—¨è´Ÿè´£æŠŠæ¶ˆæ¯ä»ä½ çš„åº”ç”¨ç¨‹åºé€åˆ°RabbitMQé˜Ÿåˆ—é‡Œã€‚

**ğŸ”¸ åŸºæœ¬å‘é€æ¶ˆæ¯**ï¼š
```java
@Service
public class MessageSender {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    // âœ… ç®€å•å‘é€å­—ç¬¦ä¸²æ¶ˆæ¯
    public void sendSimpleMessage(String message) {
        rabbitTemplate.convertAndSend("simple.queue", message);
    }
    
    // âœ… å‘é€å¯¹è±¡æ¶ˆæ¯
    public void sendUserMessage(User user) {
        rabbitTemplate.convertAndSend("user.exchange", "user.create", user);
    }
    
    // âœ… å‘é€å¸¦å±æ€§çš„æ¶ˆæ¯
    public void sendMessageWithProperties(String message) {
        MessageProperties properties = new MessageProperties();
        properties.setDeliveryMode(MessageDeliveryMode.PERSISTENT);  // æŒä¹…åŒ–
        properties.setPriority(5);  // è®¾ç½®ä¼˜å…ˆçº§
        
        Message msg = new Message(message.getBytes(), properties);
        rabbitTemplate.send("priority.queue", msg);
    }
}
```

### 8.2 å¸¸è§ä½¿ç”¨é”™è¯¯


**ğŸš¨ é”™è¯¯ä¸€ï¼šé˜Ÿåˆ—æˆ–äº¤æ¢æœºä¸å­˜åœ¨**

```java
// âŒ å‘é€åˆ°ä¸å­˜åœ¨çš„é˜Ÿåˆ—
public void sendMessage() {
    // å¦‚æœ"nonexistent.queue"ä¸å­˜åœ¨ï¼Œæ¶ˆæ¯ä¼šä¸¢å¤±
    rabbitTemplate.convertAndSend("nonexistent.queue", "hello");
}

// âœ… æ­£ç¡®åšæ³•ï¼šå…ˆç¡®ä¿é˜Ÿåˆ—å­˜åœ¨
@Component
public class QueueInitializer {
    
    @Autowired
    private RabbitAdmin rabbitAdmin;
    
    @PostConstruct
    public void initQueues() {
        // ç¡®ä¿é˜Ÿåˆ—å­˜åœ¨
        Queue queue = new Queue("my.queue", true);
        rabbitAdmin.declareQueue(queue);
    }
}
```

**ğŸš¨ é”™è¯¯äºŒï¼šæ¶ˆæ¯åºåˆ—åŒ–é—®é¢˜**

```java
// âŒ å‘é€æ— æ³•åºåˆ—åŒ–çš„å¯¹è±¡
public void sendComplexObject() {
    ComplexObject obj = new ComplexObject();
    obj.setNonSerializableField(new Thread());  // æ— æ³•åºåˆ—åŒ–
    
    rabbitTemplate.convertAndSend("test.queue", obj);  // ä¼šæŠ¥é”™
}

// âœ… æ­£ç¡®åšæ³•ï¼šç¡®ä¿å¯¹è±¡å¯åºåˆ—åŒ–
public class User implements Serializable {
    private String name;
    private int age;
    // getter/setter...
}
```

### 8.3 å‘é€ç¡®è®¤æœºåˆ¶


**ä¸ºä»€ä¹ˆéœ€è¦å‘é€ç¡®è®¤**ï¼š
ç¡®ä¿æ¶ˆæ¯çœŸçš„é€åˆ°äº†RabbitMQï¼Œå°±åƒå¿«é€’éœ€è¦ç­¾æ”¶å›æ‰§ä¸€æ ·ã€‚

```java
@Service
public class ReliableMessageSender {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    @PostConstruct
    public void setupConfirms() {
        
        // âœ… é…ç½®å‘é€ç¡®è®¤å›è°ƒ
        rabbitTemplate.setConfirmCallback((correlationData, ack, cause) -> {
            if (ack) {
                System.out.println("âœ… æ¶ˆæ¯å‘é€æˆåŠŸ");
            } else {
                System.err.println("âŒ æ¶ˆæ¯å‘é€å¤±è´¥ï¼š" + cause);
                // è¿™é‡Œå¯ä»¥å®ç°é‡å‘é€»è¾‘
            }
        });
        
        // âœ… é…ç½®è¿”å›å›è°ƒï¼ˆå½“æ¶ˆæ¯æ— æ³•è·¯ç”±æ—¶ï¼‰
        rabbitTemplate.setReturnsCallback(returnedMessage -> {
            System.err.println("âŒ æ¶ˆæ¯æ— æ³•è·¯ç”±ï¼š" + returnedMessage.getMessage());
            System.err.println("äº¤æ¢æœºï¼š" + returnedMessage.getExchange());
            System.err.println("è·¯ç”±é”®ï¼š" + returnedMessage.getRoutingKey());
            
            // å¤„ç†æ— æ³•è·¯ç”±çš„æ¶ˆæ¯
            handleUnroutableMessage(returnedMessage);
        });
    }
    
    public void sendReliableMessage(String message) {
        // ä½¿ç”¨correlationDataæ¥è·Ÿè¸ªæ¶ˆæ¯
        CorrelationData correlationData = new CorrelationData(UUID.randomUUID().toString());
        
        rabbitTemplate.convertAndSend(
            "user.exchange", 
            "user.create", 
            message, 
            correlationData
        );
    }
    
    private void handleUnroutableMessage(ReturnedMessage returnedMessage) {
        // å¤„ç†æ— æ³•è·¯ç”±çš„æ¶ˆæ¯ï¼Œæ¯”å¦‚è®°å½•æ—¥å¿—ã€å‘é€å‘Šè­¦ç­‰
    }
}
```

---

## 9. âš¡ è‡ªåŠ¨é…ç½®å†²çª


### 9.1 Spring Bootè‡ªåŠ¨é…ç½®åŸç†


**è‡ªåŠ¨é…ç½®æ˜¯ä»€ä¹ˆ**ï¼š
Spring Bootä¼šæ ¹æ®ä½ çš„ä¾èµ–è‡ªåŠ¨é…ç½®RabbitMQç›¸å…³çš„Beanï¼Œä½†æœ‰æ—¶å€™è‡ªåŠ¨é…ç½®å’Œæ‰‹åŠ¨é…ç½®ä¼š"æ‰“æ¶"ã€‚

```
Spring Bootå¯åŠ¨æ—¶ï¼š
1. æ‰«æclasspathä¸­çš„ä¾èµ–
2. å‘ç°spring-boot-starter-amqp
3. è‡ªåŠ¨åˆ›å»ºConnectionFactoryã€RabbitTemplateç­‰
4. å¦‚æœä½ ä¹Ÿæ‰‹åŠ¨åˆ›å»ºäº†ï¼Œå°±ä¼šå†²çª
```

### 9.2 å¸¸è§å†²çªåœºæ™¯


**ğŸš¨ å†²çªåœºæ™¯ä¸€ï¼šå¤šä¸ªConnectionFactory**

```java
// âŒ è¿™æ ·ä¼šåˆ›å»ºå¤šä¸ªConnectionFactory
@Configuration
public class ConflictConfig {
    
    // Spring Bootå·²ç»è‡ªåŠ¨åˆ›å»ºäº†ä¸€ä¸ª
    @Bean
    public ConnectionFactory connectionFactory1() {
        return new CachingConnectionFactory("localhost");
    }
    
    // åˆæ‰‹åŠ¨åˆ›å»ºäº†ä¸€ä¸ª
    @Bean  
    public ConnectionFactory connectionFactory2() {
        return new CachingConnectionFactory("remote-host");
    }
}
```

**âœ… è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨@Primaryæˆ–@Qualifier**

```java
@Configuration
public class FixedConfig {
    
    // âœ… æ ‡è®°ä¸ºä¸»è¦çš„ConnectionFactory
    @Bean
    @Primary
    public ConnectionFactory primaryConnectionFactory() {
        CachingConnectionFactory factory = new CachingConnectionFactory("localhost");
        // è‡ªå®šä¹‰é…ç½®
        return factory;
    }
    
    // âœ… ä¸ºç‰¹æ®Šç”¨é€”åˆ›å»ºé¢å¤–çš„ConnectionFactory
    @Bean
    @Qualifier("remote")
    public ConnectionFactory remoteConnectionFactory() {
        return new CachingConnectionFactory("remote-host");
    }
}

// âœ… ä½¿ç”¨æ—¶æ˜ç¡®æŒ‡å®š
@Service
public class MultiConnectionService {
    
    @Autowired
    @Qualifier("remote")
    private ConnectionFactory remoteConnectionFactory;
}
```

### 9.3 ç¦ç”¨è‡ªåŠ¨é…ç½®


**å½“è‡ªåŠ¨é…ç½®ä¸ç¬¦åˆéœ€æ±‚æ—¶**ï¼š

```java
// âœ… æ–¹æ³•ä¸€ï¼šåœ¨å¯åŠ¨ç±»ä¸­æ’é™¤è‡ªåŠ¨é…ç½®
@SpringBootApplication(exclude = {RabbitAutoConfiguration.class})
public class Application {
    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }
}

// âœ… æ–¹æ³•äºŒï¼šåœ¨é…ç½®æ–‡ä»¶ä¸­æ’é™¤
# application.yml
spring:
  autoconfigure:
    exclude:
      - org.springframework.boot.autoconfigure.amqp.RabbitAutoConfiguration
```

**ç„¶åå®Œå…¨æ‰‹åŠ¨é…ç½®**ï¼š
```java
@Configuration
@EnableRabbit
public class ManualRabbitConfig {
    
    @Bean
    public ConnectionFactory connectionFactory() {
        // å®Œå…¨è‡ªå®šä¹‰çš„è¿æ¥å·¥å‚
        CachingConnectionFactory factory = new CachingConnectionFactory();
        // è¯¦ç»†é…ç½®...
        return factory;
    }
    
    @Bean
    public RabbitTemplate rabbitTemplate() {
        // å®Œå…¨è‡ªå®šä¹‰çš„æ¨¡æ¿
        return new RabbitTemplate(connectionFactory());
    }
    
    @Bean
    public RabbitAdmin rabbitAdmin() {
        return new RabbitAdmin(connectionFactory());
    }
}
```

---

## 10. ğŸ”„ ç‰ˆæœ¬å…¼å®¹æ€§é—®é¢˜


### 10.1 ç‰ˆæœ¬å…¼å®¹æ€§æ¦‚è¿°


**ä¸ºä»€ä¹ˆä¼šæœ‰ç‰ˆæœ¬é—®é¢˜**ï¼š
ä¸åŒç‰ˆæœ¬çš„Springã€Spring Bootã€Spring AMQPä¹‹é—´å¯èƒ½ä¸å…¼å®¹ï¼Œå°±åƒä¸åŒç‰ˆæœ¬çš„æ‰‹æœºç³»ç»Ÿä¸€æ ·ã€‚

### 10.2 ç‰ˆæœ¬å¯¹åº”å…³ç³»è¡¨


**ğŸ“Š ä¸»è¦ç‰ˆæœ¬å…¼å®¹æ€§å¯¹ç…§**ï¼š

| Spring Boot | Spring AMQP | RabbitMQ Client | æ¨è RabbitMQ Server |
|-------------|-------------|-----------------|---------------------|
| 2.7.x | 2.4.x | 5.16.x | 3.9.x |
| 2.6.x | 2.3.x | 5.13.x | 3.8.x |
| 2.5.x | 2.3.x | 5.12.x | 3.8.x |
| 2.4.x | 2.2.x | 5.10.x | 3.8.x |

**ğŸ” å¦‚ä½•æŸ¥çœ‹å½“å‰ç‰ˆæœ¬**ï¼š

```xml
<!-- pom.xmlä¸­æŸ¥çœ‹ä¾èµ–ç‰ˆæœ¬ -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-amqp</artifactId>
    <version>2.7.0</version>
</dependency>
```

```java
// ä»£ç ä¸­æŸ¥çœ‹ç‰ˆæœ¬ä¿¡æ¯
@Component
public class VersionChecker {
    
    @PostConstruct
    public void checkVersions() {
        System.out.println("Spring Bootç‰ˆæœ¬ï¼š" + SpringBootVersion.getVersion());
        System.out.println("Spring AMQPç‰ˆæœ¬ï¼š" + org.springframework.amqp.core.AmqpVersion.getVersion());
        
        // æ£€æŸ¥RabbitMQå®¢æˆ·ç«¯ç‰ˆæœ¬
        String clientVersion = com.rabbitmq.client.impl.Version.VERSION;
        System.out.println("RabbitMQå®¢æˆ·ç«¯ç‰ˆæœ¬ï¼š" + clientVersion);
    }
}
```

### 10.3 å¸¸è§ç‰ˆæœ¬é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ


**ğŸš¨ é—®é¢˜ä¸€ï¼šæ–¹æ³•ä¸å­˜åœ¨**

```java
// âŒ åœ¨æ—§ç‰ˆæœ¬ä¸­å¯èƒ½ä¸å­˜åœ¨çš„æ–¹æ³•
rabbitTemplate.convertSendAndReceive("queue", message, Duration.ofSeconds(5));

// âœ… å…¼å®¹æ€§æ›´å¥½çš„å†™æ³•
rabbitTemplate.convertSendAndReceive("queue", message);
```

**ğŸš¨ é—®é¢˜äºŒï¼šé…ç½®å±æ€§å˜æ›´**

```yaml
# âŒ æ—§ç‰ˆæœ¬é…ç½®ï¼ˆå¯èƒ½ä¸å…¼å®¹ï¼‰
spring:
  rabbitmq:
    listener:
      acknowledge-mode: manual

# âœ… æ–°ç‰ˆæœ¬é…ç½®
spring:
  rabbitmq:
    listener:
      simple:
        acknowledge-mode: manual
```

**ğŸš¨ é—®é¢˜ä¸‰ï¼šä¾èµ–å†²çª**

```xml
<!-- âœ… ç»Ÿä¸€ç®¡ç†ç‰ˆæœ¬ï¼Œé¿å…å†²çª -->
<dependencyManagement>
    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-dependencies</artifactId>
            <version>2.7.0</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
    </dependencies>
</dependencyManagement>
```

### 10.4 å‡çº§å»ºè®®


**ğŸ”„ å®‰å…¨å‡çº§æ­¥éª¤**ï¼š

```
1ï¸âƒ£ æŸ¥çœ‹å½“å‰ç‰ˆæœ¬å…¼å®¹æ€§
2ï¸âƒ£ é˜…è¯»ç‰ˆæœ¬å‡çº§è¯´æ˜
3ï¸âƒ£ åœ¨æµ‹è¯•ç¯å¢ƒå…ˆå‡çº§
4ï¸âƒ£ è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
5ï¸âƒ£ ç”Ÿäº§ç¯å¢ƒè°¨æ…å‡çº§
```

**ğŸ’¡ å‡çº§æœ€ä½³å®è·µ**ï¼š
```java
// âœ… ä½¿ç”¨åºŸå¼ƒæ£€æŸ¥
@SuppressWarnings("deprecation")  // æš‚æ—¶å¿½ç•¥åºŸå¼ƒè­¦å‘Š
public void oldMethodUsage() {
    // ä½¿ç”¨æ—§æ–¹æ³•ï¼Œä½†è®¡åˆ’åœ¨ä¸‹ä¸ªç‰ˆæœ¬ä¸­æ›¿æ¢
}

// âœ… ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥
@ConditionalOnClass(name = "org.springframework.amqp.rabbit.connection.CachingConnectionFactory")
@Configuration
public class CompatibilityConfig {
    // åªåœ¨ç‰¹å®šç±»å­˜åœ¨æ—¶æ‰é…ç½®
}
```

---

## 11. ğŸ§ª æµ‹è¯•ç¯å¢ƒé…ç½®


### 11.1 æµ‹è¯•ç¯å¢ƒçš„é‡è¦æ€§


**ä¸ºä»€ä¹ˆéœ€è¦ä¸“é—¨çš„æµ‹è¯•é…ç½®**ï¼š
æµ‹è¯•æ—¶ä¸æƒ³å½±å“çœŸå®çš„RabbitMQæœåŠ¡å™¨ï¼Œéœ€è¦ç‹¬ç«‹çš„ã€å¯æ§çš„æµ‹è¯•ç¯å¢ƒã€‚

```
å¼€å‘ç¯å¢ƒï¼šlocalhost:5672  (æœ¬åœ°RabbitMQ)
æµ‹è¯•ç¯å¢ƒï¼štestcontainer     (Dockerå®¹å™¨)
ç”Ÿäº§ç¯å¢ƒï¼šprod-rabbitmq     (ç”Ÿäº§æœåŠ¡å™¨)

å„ç¯å¢ƒéš”ç¦»ï¼Œé¿å…ç›¸äº’å½±å“
```

### 11.2 åµŒå…¥å¼æµ‹è¯•é…ç½®


**ğŸ”¸ ä½¿ç”¨TestContainersè¿›è¡Œé›†æˆæµ‹è¯•**ï¼š

```java
@SpringBootTest
@Testcontainers
public class RabbitMQIntegrationTest {
    
    // âœ… å¯åŠ¨æµ‹è¯•ç”¨çš„RabbitMQå®¹å™¨
    @Container
    static RabbitMQContainer rabbitMQ = new RabbitMQContainer("rabbitmq:3.9-management")
            .withExposedPorts(5672, 15672);
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    @Autowired
    private TestMessageListener messageListener;
    
    @DynamicPropertySource
    static void configureProperties(DynamicPropertyRegistry registry) {
        // âœ… åŠ¨æ€é…ç½®æµ‹è¯•å±æ€§
        registry.add("spring.rabbitmq.host", rabbitMQ::getHost);
        registry.add("spring.rabbitmq.port", rabbitMQ::getAmqpPort);
        registry.add("spring.rabbitmq.username", () -> "guest");
        registry.add("spring.rabbitmq.password", () -> "guest");
    }
    
    @Test
    public void testMessageSendAndReceive() throws InterruptedException {
        // å‘é€æµ‹è¯•æ¶ˆæ¯
        String testMessage = "Hello Test!";
        rabbitTemplate.convertAndSend("test.queue", testMessage);
        
        // ç­‰å¾…æ¶ˆæ¯å¤„ç†
        Thread.sleep(1000);
        
        // éªŒè¯æ¶ˆæ¯è¢«æ­£ç¡®æ¥æ”¶
        assertThat(messageListener.getReceivedMessages())
            .contains(testMessage);
    }
}
```

**ğŸ”¸ æµ‹è¯•é…ç½®æ–‡ä»¶**ï¼š

```yaml
# application-test.yml
spring:
  profiles: test
  rabbitmq:
    host: ${TEST_RABBITMQ_HOST:localhost}
    port: ${TEST_RABBITMQ_PORT:5672}
    username: test-user
    password: test-password
    virtual-host: /test
    
# æµ‹è¯•ä¸“ç”¨é…ç½®
logging:
  level:
    org.springframework.amqp: DEBUG
    
# ç¦ç”¨æŸäº›ç”Ÿäº§ç¯å¢ƒåŠŸèƒ½
management:
  endpoints:
    enabled-by-default: false
```

### 11.3 å•å…ƒæµ‹è¯•æœ€ä½³å®è·µ


**ğŸ”¸ Mock RabbitTemplate**ï¼š

```java
@ExtendWith(MockitoExtension.class)
public class MessageServiceTest {
    
    @Mock
    private RabbitTemplate rabbitTemplate;
    
    @InjectMocks
    private MessageService messageService;
    
    @Test
    public void testSendUserMessage() {
        // å‡†å¤‡æµ‹è¯•æ•°æ®
        User user = new User("å¼ ä¸‰", 25);
        
        // æ‰§è¡Œæµ‹è¯•
        messageService.sendUserMessage(user);
        
        // éªŒè¯æ–¹æ³•è°ƒç”¨
        verify(rabbitTemplate).convertAndSend(
            eq("user.exchange"),
            eq("user.create"),
            eq(user)
        );
    }
}
```

**ğŸ”¸ æµ‹è¯•ç›‘å¬å™¨**ï¼š

```java
@Component
@Profile("test")  // åªåœ¨æµ‹è¯•ç¯å¢ƒç”Ÿæ•ˆ
public class TestMessageListener {
    
    private final List<String> receivedMessages = new ArrayList<>();
    
    @RabbitListener(queues = "test.queue")
    public void handleTestMessage(String message) {
        receivedMessages.add(message);
        System.out.println("æµ‹è¯•æ¥æ”¶åˆ°æ¶ˆæ¯ï¼š" + message);
    }
    
    public List<String> getReceivedMessages() {
        return new ArrayList<>(receivedMessages);
    }
    
    public void clearMessages() {
        receivedMessages.clear();
    }
}
```

### 11.4 æµ‹è¯•æ•°æ®ç®¡ç†


**ğŸ”¸ æµ‹è¯•æ•°æ®éš”ç¦»**ï¼š

```java
@TestMethodOrder(OrderAnnotation.class)
public class OrderedRabbitMQTest {
    
    @BeforeEach
    public void setUp() {
        // æ¸…ç†æµ‹è¯•é˜Ÿåˆ—
        rabbitAdmin.purgeQueue("test.queue");
    }
    
    @Test
    @Order(1)
    public void testSendMessage() {
        // ç¬¬ä¸€ä¸ªæµ‹è¯•
    }
    
    @Test  
    @Order(2)
    public void testReceiveMessage() {
        // ç¬¬äºŒä¸ªæµ‹è¯•
    }
    
    @AfterEach
    public void tearDown() {
        // æ¸…ç†æµ‹è¯•æ•°æ®
        testMessageListener.clearMessages();
    }
}
```

---

## 12. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 12.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Springé›†æˆæœ¬è´¨ï¼šè®©Springå®¹å™¨ç®¡ç†RabbitMQç›¸å…³ç»„ä»¶
ğŸ”¸ é…ç½®ä¼˜å…ˆçº§ï¼šä»£ç é…ç½® > é…ç½®æ–‡ä»¶ > è‡ªåŠ¨é…ç½®
ğŸ”¸ Beanç”Ÿå‘½å‘¨æœŸï¼šæ³¨æ„ä¾èµ–æ³¨å…¥æ—¶æœºå’Œåˆå§‹åŒ–é¡ºåº
ğŸ”¸ äº‹åŠ¡ç®¡ç†ï¼šç†è§£æ¶ˆæ¯äº‹åŠ¡å’Œæ•°æ®åº“äº‹åŠ¡çš„å…³ç³»
ğŸ”¸ ç‰ˆæœ¬å…¼å®¹ï¼šä¸åŒç‰ˆæœ¬é—´å¯èƒ½å­˜åœ¨APIå˜åŒ–
```

### 12.2 å¸¸è§é—®é¢˜è§£å†³æ€è·¯


**ğŸ”¹ é—®é¢˜æ’æŸ¥æ­¥éª¤**ï¼š
```
1ï¸âƒ£ æ£€æŸ¥é…ç½®æ–‡ä»¶å‚æ•°æ˜¯å¦æ­£ç¡®
2ï¸âƒ£ éªŒè¯RabbitMQæœåŠ¡å™¨è¿æ¥çŠ¶æ€  
3ï¸âƒ£ æŸ¥çœ‹Springå®¹å™¨Beanåˆ›å»ºæ—¥å¿—
4ï¸âƒ£ æ£€æŸ¥é˜Ÿåˆ—å’Œäº¤æ¢æœºæ˜¯å¦å­˜åœ¨
5ï¸âƒ£ éªŒè¯ç”¨æˆ·æƒé™å’Œè™šæ‹Ÿä¸»æœºé…ç½®
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–è¦ç‚¹**ï¼š
```
è¿æ¥æ± é…ç½®ï¼šåˆç†è®¾ç½®è¿æ¥å’Œä¿¡é“ç¼“å­˜å¤§å°
ç›‘å¬å™¨è°ƒä¼˜ï¼šæ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹é…ç½®å¹¶å‘æ•°é‡
æ¶ˆæ¯ç¡®è®¤ï¼šé€‰æ‹©åˆé€‚çš„ç¡®è®¤æ¨¡å¼
äº‹åŠ¡ä½¿ç”¨ï¼šé¿å…ä¸å¿…è¦çš„äº‹åŠ¡å¼€é”€
```

### 12.3 æœ€ä½³å®è·µå»ºè®®


**ğŸ“‹ å¼€å‘è§„èŒƒ**ï¼š

| æ–¹é¢ | æ¨èåšæ³• | é¿å…åšæ³• |
|------|---------|---------|
| **é…ç½®ç®¡ç†** | ä½¿ç”¨é…ç½®æ–‡ä»¶ç»Ÿä¸€ç®¡ç† | ç¡¬ç¼–ç è¿æ¥ä¿¡æ¯ |
| **å¼‚å¸¸å¤„ç†** | å®Œå–„çš„try-catchå’Œæ—¥å¿— | å¿½ç•¥å¼‚å¸¸ |
| **æµ‹è¯•è¦†ç›–** | ç¼–å†™é›†æˆæµ‹è¯•å’Œå•å…ƒæµ‹è¯• | åªæ‰‹åŠ¨æµ‹è¯• |
| **ç›‘æ§å‘Šè­¦** | é…ç½®è¿æ¥å’Œé˜Ÿåˆ—ç›‘æ§ | æ²¡æœ‰ç›‘æ§æªæ–½ |

**ğŸ’¡ è®°å¿†è¦ç‚¹**ï¼š
- **é…ç½®ä¸ºç‹**ï¼šå¤§éƒ¨åˆ†é—®é¢˜éƒ½æ˜¯é…ç½®ä¸å½“å¯¼è‡´çš„
- **å…ˆè¿åç”¨**ï¼šç¡®ä¿è¿æ¥æ­£å¸¸åå†è¿›è¡Œä¸šåŠ¡æ“ä½œ
- **æµ‹è¯•å…ˆè¡Œ**ï¼šå¤æ‚é›†æˆä¸€å®šè¦æœ‰å®Œå–„çš„æµ‹è¯•
- **ç‰ˆæœ¬åŒ¹é…**ï¼šå‡çº§æ—¶æ³¨æ„ç‰ˆæœ¬å…¼å®¹æ€§
- **ç›‘æ§å¿…å¤‡**ï¼šç”Ÿäº§ç¯å¢ƒå¿…é¡»æœ‰ç›‘æ§å’Œå‘Šè­¦

**ğŸ¯ å­¦ä¹ å»ºè®®**ï¼š
1. å…ˆæŒæ¡åŸºç¡€é…ç½®ï¼Œèƒ½è·‘é€šç®€å•ç¤ºä¾‹
2. ç†è§£Spring Beanç”Ÿå‘½å‘¨æœŸç®¡ç†æœºåˆ¶
3. å­¦ä¼šè¯»æ‡‚é”™è¯¯æ—¥å¿—ï¼Œå¿«é€Ÿå®šä½é—®é¢˜
4. å®è·µä¸åŒåœºæ™¯çš„äº‹åŠ¡ç®¡ç†æ–¹æ¡ˆ
5. å»ºç«‹å®Œæ•´çš„æµ‹è¯•ç¯å¢ƒå’Œæµ‹è¯•ç”¨ä¾‹

é€šè¿‡æŒæ¡è¿™äº›çŸ¥è¯†ç‚¹ï¼Œä½ å°±èƒ½å¤Ÿç†Ÿç»ƒåœ°åœ¨Springé¡¹ç›®ä¸­é›†æˆå’Œä½¿ç”¨RabbitMQï¼Œè§£å†³å¸¸è§çš„é›†æˆé—®é¢˜ï¼Œå¹¶æ„å»ºç¨³å®šå¯é çš„æ¶ˆæ¯ç³»ç»Ÿï¼