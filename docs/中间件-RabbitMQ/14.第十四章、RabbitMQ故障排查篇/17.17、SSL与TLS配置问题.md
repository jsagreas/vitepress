---
title: 17ã€SSLä¸TLSé…ç½®é—®é¢˜
---
## ğŸ“š ç›®å½•


1. [SSL/TLSåŸºç¡€æ¦‚å¿µ](#1-ssl-tlsåŸºç¡€æ¦‚å¿µ)
2. [RabbitMQ SSLé…ç½®åŸç†](#2-rabbitmq-sslé…ç½®åŸç†)
3. [è¯ä¹¦ç›¸å…³é—®é¢˜](#3-è¯ä¹¦ç›¸å…³é—®é¢˜)
4. [è¿æ¥æ¡æ‰‹é—®é¢˜](#4-è¿æ¥æ¡æ‰‹é—®é¢˜)
5. [æ€§èƒ½ä¸å…¼å®¹æ€§é—®é¢˜](#5-æ€§èƒ½ä¸å…¼å®¹æ€§é—®é¢˜)
6. [å®æˆ˜æ•…éšœæ’æŸ¥æµç¨‹](#6-å®æˆ˜æ•…éšœæ’æŸ¥æµç¨‹)
7. [æœ€ä½³å®è·µå»ºè®®](#7-æœ€ä½³å®è·µå»ºè®®)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” SSL/TLSåŸºç¡€æ¦‚å¿µ



### 1.1 ä»€ä¹ˆæ˜¯SSL/TLS



**ğŸ”¸ SSL/TLSç®€å•ç†è§£**
```
æ™®é€šHTTPé€šä¿¡ï¼š
å®¢æˆ·ç«¯ ----æ˜æ–‡æ•°æ®----> æœåŠ¡å™¨
       å®¹æ˜“è¢«çªƒå¬å’Œç¯¡æ”¹

HTTPSé€šä¿¡ï¼š
å®¢æˆ·ç«¯ ----åŠ å¯†æ•°æ®----> æœåŠ¡å™¨
       æ•°æ®å®‰å…¨ä¼ è¾“
```

**ğŸ’¡ æ ¸å¿ƒæ¦‚å¿µè§£é‡Š**
- **SSL**ï¼šå®‰å…¨å¥—æ¥å­—å±‚ï¼ˆSecure Sockets Layerï¼‰ï¼Œè€ç‰ˆæœ¬çš„å®‰å…¨åè®®
- **TLS**ï¼šä¼ è¾“å±‚å®‰å…¨ï¼ˆTransport Layer Securityï¼‰ï¼ŒSSLçš„å‡çº§ç‰ˆï¼Œç°åœ¨ä¸»æµä½¿ç”¨
- **ä½œç”¨**ï¼šå°±åƒç»™æ•°æ®ç©¿ä¸Šä¸€ä»¶"é˜²æŠ¤æœ"ï¼Œé˜²æ­¢æ•°æ®åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­è¢«å·çœ‹æˆ–ç¯¡æ”¹

**ğŸ¯ åœ¨RabbitMQä¸­çš„ä½œç”¨**
```
æ²¡æœ‰SSL/TLSçš„RabbitMQï¼š
åº”ç”¨ç¨‹åº ----æ˜æ–‡æ¶ˆæ¯----> RabbitMQæœåŠ¡å™¨
         è´¦å·å¯†ç ã€æ¶ˆæ¯å†…å®¹éƒ½æ˜¯æ˜æ–‡ä¼ è¾“

æœ‰SSL/TLSçš„RabbitMQï¼š
åº”ç”¨ç¨‹åº ----åŠ å¯†æ¶ˆæ¯----> RabbitMQæœåŠ¡å™¨
         æ‰€æœ‰æ•°æ®éƒ½ç»è¿‡åŠ å¯†ä¿æŠ¤
```

### 1.2 SSL/TLSå·¥ä½œåŸç†



**ğŸ”„ æ¡æ‰‹è¿‡ç¨‹ç®€åŒ–ç†è§£**

```
æ¡æ‰‹è¿‡ç¨‹å°±åƒä¸¤ä¸ªäººè§é¢æ—¶çš„å¯¹è¯ï¼š

ç¬¬1æ­¥ï¼šå®¢æˆ·ç«¯è¯´è¯
"ä½ å¥½ï¼Œæˆ‘æ”¯æŒè¿™äº›åŠ å¯†æ–¹å¼ï¼šAESã€DES..."

ç¬¬2æ­¥ï¼šæœåŠ¡å™¨å›åº”  
"ä½ å¥½ï¼Œæˆ‘é€‰æ‹©AESåŠ å¯†ï¼Œè¿™æ˜¯æˆ‘çš„èº«ä»½è¯æ˜ï¼ˆè¯ä¹¦ï¼‰"

ç¬¬3æ­¥ï¼šå®¢æˆ·ç«¯éªŒè¯
"è®©æˆ‘éªŒè¯ä½ çš„èº«ä»½è¯æ˜æ˜¯å¦çœŸå®æœ‰æ•ˆ"

ç¬¬4æ­¥ï¼šå»ºç«‹å¯†é’¥
"éªŒè¯é€šè¿‡ï¼Œæˆ‘ä»¬ç”¨è¿™ä¸ªå¯†é’¥æ¥åŠ å¯†é€šä¿¡"

ç¬¬5æ­¥ï¼šå¼€å§‹å®‰å…¨é€šä¿¡
åç»­æ‰€æœ‰æ•°æ®éƒ½ç”¨åå•†å¥½çš„å¯†é’¥åŠ å¯†ä¼ è¾“
```

**âš¡ å…³é”®ç»„ä»¶**
- **è¯ä¹¦**ï¼šæœåŠ¡å™¨çš„"èº«ä»½è¯"ï¼Œè¯æ˜è‡ªå·±æ˜¯çœŸçš„
- **ç§é’¥**ï¼šæœåŠ¡å™¨çš„"ç­¾åç¬”"ï¼Œç”¨æ¥è¯æ˜è¯ä¹¦æ˜¯è‡ªå·±çš„
- **CAè¯ä¹¦**ï¼šé¢å‘æœºæ„çš„"å°ç« "ï¼Œè¯æ˜è¯ä¹¦æ˜¯å¯ä¿¡çš„

---

## 2. ğŸ—ï¸ RabbitMQ SSLé…ç½®åŸç†



### 2.1 RabbitMQ SSLæ¶æ„



**ğŸ“‹ SSLåœ¨RabbitMQä¸­çš„ä½ç½®**

```
åº”ç”¨å±‚åº”ç”¨ç¨‹åºï¼ˆProducer/Consumerï¼‰
    â†“
ä¼ è¾“å±‚SSL/TLSåŠ å¯†å±‚
    â†“  
ç½‘ç»œå±‚TCPè¿æ¥
    â†“
RabbitMQæœåŠ¡å™¨
```

**ğŸ”§ ä¸»è¦é…ç½®æ–‡ä»¶**
- **rabbitmq.conf**ï¼šä¸»é…ç½®æ–‡ä»¶ï¼Œå®šä¹‰SSLç›‘å¬ç«¯å£å’ŒåŸºæœ¬è®¾ç½®
- **è¯ä¹¦æ–‡ä»¶**ï¼šåŒ…å«æœåŠ¡å™¨è¯ä¹¦ã€ç§é’¥ã€CAè¯ä¹¦ç­‰æ–‡ä»¶

### 2.2 åŸºæœ¬é…ç½®ç»“æ„



**ğŸ“ å…¸å‹SSLé…ç½®ç¤ºä¾‹**
```erlang
# rabbitmq.conf æ ¸å¿ƒSSLé…ç½®

listeners.ssl.default = 5671
ssl_options.cacertfile = /path/to/ca_certificate.pem
ssl_options.certfile   = /path/to/server_certificate.pem
ssl_options.keyfile    = /path/to/server_key.pem
ssl_options.verify     = verify_peer
ssl_options.fail_if_no_peer_cert = true
```

**ğŸ’­ é…ç½®å«ä¹‰è§£é‡Š**
- `listeners.ssl.default = 5671`ï¼šSSLç›‘å¬ç«¯å£ï¼ˆé€šå¸¸5671æ˜¯é»˜è®¤SSLç«¯å£ï¼‰
- `cacertfile`ï¼šCAè¯ä¹¦æ–‡ä»¶ï¼Œç”¨æ¥éªŒè¯å®¢æˆ·ç«¯è¯ä¹¦
- `certfile`ï¼šæœåŠ¡å™¨è¯ä¹¦æ–‡ä»¶ï¼ŒæœåŠ¡å™¨çš„"èº«ä»½è¯"
- `keyfile`ï¼šæœåŠ¡å™¨ç§é’¥æ–‡ä»¶ï¼ŒæœåŠ¡å™¨çš„"ç­¾åç¬”"
- `verify_peer`ï¼šè¦æ±‚éªŒè¯å®¢æˆ·ç«¯è¯ä¹¦
- `fail_if_no_peer_cert`ï¼šå¦‚æœå®¢æˆ·ç«¯æ²¡æœ‰è¯ä¹¦å°±æ‹’ç»è¿æ¥

---

## 3. ğŸ“œ è¯ä¹¦ç›¸å…³é—®é¢˜



### 3.1 è¯ä¹¦æ–‡ä»¶è·¯å¾„é”™è¯¯



**ğŸš¨ é—®é¢˜ç°è±¡**
```bash
# å¯åŠ¨RabbitMQæ—¶å‡ºç°é”™è¯¯

ERROR: Failed to load SSL certificate file: /wrong/path/server.pem
ERROR: SSL listener failed to start
```

**ğŸ” é—®é¢˜åŸå› **
- é…ç½®æ–‡ä»¶ä¸­çš„è¯ä¹¦è·¯å¾„å†™é”™äº†
- è¯ä¹¦æ–‡ä»¶è¢«ç§»åŠ¨æˆ–åˆ é™¤äº†
- æ–‡ä»¶åæ‹¼å†™é”™è¯¯

**âœ… è§£å†³æ–¹æ¡ˆ**

| æ­¥éª¤ | æ“ä½œ | è¯´æ˜ |
|------|------|------|
| **1.æ£€æŸ¥æ–‡ä»¶** | `ls -la /path/to/certificates/` | ç¡®è®¤æ–‡ä»¶æ˜¯å¦å­˜åœ¨ |
| **2.éªŒè¯è·¯å¾„** | å¯¹æ¯”é…ç½®æ–‡ä»¶ä¸­çš„è·¯å¾„ä¸å®é™…è·¯å¾„ | ç¡®ä¿è·¯å¾„å®Œå…¨åŒ¹é… |
| **3.æ£€æŸ¥æƒé™** | `ls -la /path/to/server.pem` | ç¡®ä¿RabbitMQè¿›ç¨‹æœ‰è¯»å–æƒé™ |
| **4.æ›´æ–°é…ç½®** | ä¿®æ”¹rabbitmq.confä¸­çš„æ­£ç¡®è·¯å¾„ | ä½¿ç”¨ç»å¯¹è·¯å¾„æ›´å®‰å…¨ |

**ğŸ’¡ æœ€ä½³å®è·µ**
```bash
# å»ºè®®çš„è¯ä¹¦ç›®å½•ç»“æ„

/etc/rabbitmq/certs/
â”œâ”€â”€ ca_certificate.pem     # CAè¯ä¹¦
â”œâ”€â”€ server_certificate.pem # æœåŠ¡å™¨è¯ä¹¦  
â””â”€â”€ server_key.pem         # æœåŠ¡å™¨ç§é’¥

# è®¾ç½®æ­£ç¡®çš„æ–‡ä»¶æƒé™

chmod 644 /etc/rabbitmq/certs/*.pem
chmod 600 /etc/rabbitmq/certs/server_key.pem  # ç§é’¥æ–‡ä»¶æ›´ä¸¥æ ¼
chown rabbitmq:rabbitmq /etc/rabbitmq/certs/*
```

### 3.2 è¯ä¹¦è¿‡æœŸæˆ–æ— æ•ˆ



**ğŸš¨ é—®é¢˜ç°è±¡**
```
SSL handshake failed: certificate verify failed
Certificate has expired
Certificate not yet valid
```

**ğŸ” æ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæœŸ**
```bash
# æŸ¥çœ‹è¯ä¹¦è¯¦ç»†ä¿¡æ¯

openssl x509 -in server_certificate.pem -text -noout

# é‡ç‚¹å…³æ³¨è¿™ä¸¤è¡Œï¼š

#   Not Before: Jan  1 00:00:00 2024 GMT    # è¯ä¹¦ç”Ÿæ•ˆæ—¶é—´

#   Not After : Dec 31 23:59:59 2024 GMT    # è¯ä¹¦è¿‡æœŸæ—¶é—´

```

**âœ… è§£å†³æ­¥éª¤**

1. **ğŸ”¸ è¯ä¹¦å·²è¿‡æœŸ**
   ```bash
#   # ç”Ÿæˆæ–°çš„è¯ä¹¦ï¼ˆè‡ªç­¾åç¤ºä¾‹ï¼‰
   openssl req -x509 -newkey rsa:2048 -keyout server_key.pem \
     -out server_certificate.pem -days 365 -nodes
   ```

2. **ğŸ”¸ è¯ä¹¦æ—¶é—´æœªåˆ°**
   - æ£€æŸ¥æœåŠ¡å™¨ç³»ç»Ÿæ—¶é—´æ˜¯å¦æ­£ç¡®
   - ä½¿ç”¨`date`å‘½ä»¤ç¡®è®¤å½“å‰æ—¶é—´
   - å¿…è¦æ—¶åŒæ­¥ç³»ç»Ÿæ—¶é—´ï¼š`ntpdate time.nist.gov`

3. **ğŸ”¸ è¯ä¹¦æ ¼å¼é”™è¯¯**
   ```bash
#   # æ£€æŸ¥è¯ä¹¦æ ¼å¼
   openssl x509 -in server_certificate.pem -text -noout
#   # å¦‚æœå‡ºé”™ï¼Œè¯´æ˜è¯ä¹¦æ–‡ä»¶æŸåæˆ–æ ¼å¼ä¸å¯¹
   ```

### 3.3 CAè¯ä¹¦é“¾ä¸å®Œæ•´



**ğŸš¨ é—®é¢˜ç°è±¡**
```
SSL handshake failed: unable to get local issuer certificate
Certificate chain incomplete
```

**ğŸ’­ é—®é¢˜è§£é‡Š**
æƒ³è±¡è¯ä¹¦éªŒè¯å°±åƒéªŒè¯ä¸€ä¸ªäººçš„èº«ä»½ï¼š
- **ä¸ªäººèº«ä»½è¯**ï¼šæœåŠ¡å™¨è¯ä¹¦
- **æ´¾å‡ºæ‰€å°ç« **ï¼šä¸­é—´CAè¯ä¹¦  
- **å…¬å®‰éƒ¨å°ç« **ï¼šæ ¹CAè¯ä¹¦

å¦‚æœç¼ºå°‘ä¸­é—´ç¯èŠ‚ï¼Œæ•´ä¸ªä¿¡ä»»é“¾å°±æ–­äº†ã€‚

**âœ… è§£å†³æ–¹æ¡ˆ**
```bash
# 1. æ£€æŸ¥è¯ä¹¦é“¾

openssl verify -CAfile ca_certificate.pem server_certificate.pem

# 2. å¦‚æœè¯ä¹¦é“¾ä¸å®Œæ•´ï¼Œéœ€è¦åˆå¹¶è¯ä¹¦

cat server_certificate.pem intermediate_ca.pem root_ca.pem > full_chain.pem

# 3. æ›´æ–°é…ç½®ä½¿ç”¨å®Œæ•´è¯ä¹¦é“¾

ssl_options.certfile = /path/to/full_chain.pem
```

---

## 4. ğŸ¤ è¿æ¥æ¡æ‰‹é—®é¢˜



### 4.1 åŠ å¯†ç®—æ³•ä¸åŒ¹é…



**ğŸš¨ é—®é¢˜ç°è±¡**
```
SSL handshake failed: no shared cipher
Client and server have no common encryption algorithms
```

**ğŸ’­ é—®é¢˜è§£é‡Š**
å°±åƒä¸¤ä¸ªäººè¦å¯¹æš—å·ï¼Œä½†æ˜¯ç”¨çš„"å¯†ç æœ¬"ä¸ä¸€æ ·ï¼š
- å®¢æˆ·ç«¯è¯´ï¼š"æˆ‘ä¼šAES-256ã€DES"
- æœåŠ¡å™¨è¯´ï¼š"æˆ‘åªä¼šRSAã€3DES"  
- ç»“æœï¼šæ²¡æœ‰å…±åŒè¯­è¨€ï¼Œæ— æ³•å»ºç«‹è¿æ¥

**âœ… è§£å†³æ–¹æ¡ˆ**

1. **ğŸ”¸ æŸ¥çœ‹æ”¯æŒçš„åŠ å¯†ç®—æ³•**
   ```bash
#   # æŸ¥çœ‹å®¢æˆ·ç«¯æ”¯æŒçš„ç®—æ³•
   openssl ciphers -v
   
#   # æµ‹è¯•æœåŠ¡å™¨SSLé…ç½®
   openssl s_client -connect rabbitmq-server:5671 -cipher 'AES256-SHA'
   ```

2. **ğŸ”¸ é…ç½®å…¼å®¹çš„åŠ å¯†ç®—æ³•**
   ```erlang
#   # åœ¨rabbitmq.confä¸­æŒ‡å®šåŠ å¯†å¥—ä»¶
   ssl_options.ciphers.1 = ECDHE-RSA-AES256-GCM-SHA384
   ssl_options.ciphers.2 = ECDHE-RSA-AES128-GCM-SHA256
   ssl_options.ciphers.3 = AES256-SHA
   ```

### 4.2 åè®®ç‰ˆæœ¬ä¸å…¼å®¹



**ğŸš¨ é—®é¢˜ç°è±¡**
```
SSL handshake failed: wrong version number
Protocol version mismatch
```

**ğŸ” å¸¸è§ç‰ˆæœ¬å†²çª**

| é—®é¢˜åœºæ™¯ | å®¢æˆ·ç«¯ç‰ˆæœ¬ | æœåŠ¡å™¨ç‰ˆæœ¬ | è§£å†³æ–¹æ¡ˆ |
|----------|------------|------------|----------|
| **è€å®¢æˆ·ç«¯** | SSLv3 | TLSv1.2 | å‡çº§å®¢æˆ·ç«¯æˆ–é™ä½æœåŠ¡å™¨è¦æ±‚ |
| **æ–°å®¢æˆ·ç«¯** | TLSv1.3 | TLSv1.1 | å‡çº§æœåŠ¡å™¨æˆ–é™ä½å®¢æˆ·ç«¯è¦æ±‚ |
| **ä¸¥æ ¼æœåŠ¡å™¨** | TLSv1.0 | åªæ¥å—TLSv1.2+ | é…ç½®æœåŠ¡å™¨æ”¯æŒæ›´å¤šç‰ˆæœ¬ |

**âœ… é…ç½®åè®®ç‰ˆæœ¬**
```erlang
# é…ç½®æ”¯æŒçš„TLSç‰ˆæœ¬

ssl_options.versions.1 = tlsv1.2
ssl_options.versions.2 = tlsv1.3

# å¦‚æœéœ€è¦å…¼å®¹è€ç‰ˆæœ¬ï¼ˆä¸æ¨èï¼‰

ssl_options.versions.3 = tlsv1.1
```

### 4.3 SSLæ¡æ‰‹è¶…æ—¶



**ğŸš¨ é—®é¢˜ç°è±¡**
```
Connection timeout during SSL handshake
SSL handshake timed out after 30 seconds
```

**ğŸ” è¶…æ—¶åŸå› åˆ†æ**

```
æ­£å¸¸æ¡æ‰‹æµç¨‹ï¼š        è¶…æ—¶æƒ…å†µï¼š
å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨         å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨
    â†“                      â†“
æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯         âŒ æ— å“åº”æˆ–å“åº”æ…¢
    â†“                      â†“  
æ¡æ‰‹å®Œæˆ âœ…              è¶…æ—¶å¤±è´¥ âŒ
```

**âœ… è§£å†³æ–¹æ¡ˆ**

1. **ğŸ”¸ è°ƒæ•´è¶…æ—¶æ—¶é—´**
   ```erlang
#   # å¢åŠ SSLæ¡æ‰‹è¶…æ—¶æ—¶é—´
   ssl_options.handshake_timeout = 10000  # 10ç§’ï¼ˆé»˜è®¤5ç§’ï¼‰
   ```

2. **ğŸ”¸ ç½‘ç»œè¿é€šæ€§æ£€æŸ¥**
   ```bash
#   # æ£€æŸ¥ç«¯å£æ˜¯å¦å¯è¾¾
   telnet rabbitmq-server 5671
   
#   # æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
   iptables -L | grep 5671
   ```

3. **ğŸ”¸ è¯ä¹¦å¤„ç†ä¼˜åŒ–**
   - ä½¿ç”¨è¾ƒå°çš„è¯ä¹¦æ–‡ä»¶
   - é¿å…è¿‡é•¿çš„è¯ä¹¦é“¾
   - æ£€æŸ¥è¯ä¹¦æ˜¯å¦æŸå

---

## 5. âš¡ æ€§èƒ½ä¸å…¼å®¹æ€§é—®é¢˜



### 5.1 åŠ å¯†æ€§èƒ½å½±å“



**ğŸ“Š æ€§èƒ½å¯¹æ¯”åˆ†æ**

| è¿æ¥ç±»å‹ | ååé‡ | CPUä½¿ç”¨ç‡ | å†…å­˜ä½¿ç”¨ | å»¶è¿Ÿ |
|----------|--------|-----------|----------|------|
| **æ™®é€šè¿æ¥** | 100% | åŸºå‡† | åŸºå‡† | åŸºå‡† |
| **SSLè¿æ¥** | 80-90% | +20-30% | +10-15% | +5-10ms |

**ğŸ’¡ æ€§èƒ½å½±å“è¯´æ˜**
SSLåŠ å¯†å°±åƒç»™æ¯ä¸ªåŒ…è£¹éƒ½è¦åŒ…è£…ä¸€å±‚ä¿æŠ¤è†œï¼š
- **å¥½å¤„**ï¼šæ•°æ®æ›´å®‰å…¨
- **ä»£ä»·**ï¼šåŒ…è£…å’Œæ‹†åŒ…éœ€è¦æ—¶é—´ï¼Œå ç”¨æ›´å¤šèµ„æº

**ğŸš€ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**

1. **ğŸ”¸ ç¡¬ä»¶åŠ é€Ÿ**
   ```bash
#   # æ£€æŸ¥CPUæ˜¯å¦æ”¯æŒAESç¡¬ä»¶åŠ é€Ÿ
   grep -i aes /proc/cpuinfo
   
#   # ä½¿ç”¨æ”¯æŒç¡¬ä»¶åŠ é€Ÿçš„åŠ å¯†ç®—æ³•
   ssl_options.ciphers.1 = ECDHE-RSA-AES256-GCM-SHA384
   ```

2. **ğŸ”¸ è¿æ¥å¤ç”¨**
   ```java
   // å®¢æˆ·ç«¯ä»£ç ç¤ºä¾‹ï¼šé‡ç”¨SSLè¿æ¥
   ConnectionFactory factory = new ConnectionFactory();
   factory.setHost("rabbitmq-server");
   factory.setPort(5671);
   factory.useSslProtocol();
   
   // åˆ›å»ºè¿æ¥æ± ï¼Œé¿å…é¢‘ç¹å»ºç«‹SSLè¿æ¥
   Connection connection = factory.newConnection();
   // é‡ç”¨è¿™ä¸ªè¿æ¥åˆ›å»ºå¤šä¸ªChannel
   ```

3. **ğŸ”¸ åˆç†çš„åŠ å¯†ç®—æ³•é€‰æ‹©**
   ```erlang
#   # å¹³è¡¡å®‰å…¨æ€§å’Œæ€§èƒ½
   ssl_options.ciphers.1 = ECDHE-RSA-AES128-GCM-SHA256  # æ€§èƒ½è¾ƒå¥½
   ssl_options.ciphers.2 = ECDHE-RSA-AES256-GCM-SHA384  # å®‰å…¨æ€§æ›´é«˜
   ```

### 5.2 è¯ä¹¦åŸŸåä¸åŒ¹é…



**ğŸš¨ é—®é¢˜ç°è±¡**
```
SSL handshake failed: hostname verification failed
Certificate subject name does not match hostname
```

**ğŸ’­ é—®é¢˜è§£é‡Š**
å°±åƒèº«ä»½è¯ä¸Šçš„åœ°å€å’Œä½ å®é™…å±…ä½åœ°å€ä¸ç¬¦ï¼š
- **è¯ä¹¦ä¸­çš„åŸŸå**ï¼šexample.com
- **å®é™…è¿æ¥çš„åœ°å€**ï¼š192.168.1.100
- **ç»“æœ**ï¼šç³»ç»Ÿè®¤ä¸ºè¿™æ˜¯å†’å……çš„æœåŠ¡å™¨

**âœ… è§£å†³æ–¹æ¡ˆ**

1. **ğŸ”¸ ç”ŸæˆåŒ…å«æ­£ç¡®åŸŸåçš„è¯ä¹¦**
   ```bash
#   # åˆ›å»ºåŒ…å«å¤šä¸ªåŸŸåçš„è¯ä¹¦
   openssl req -x509 -newkey rsa:2048 -keyout server_key.pem \
     -out server_certificate.pem -days 365 -nodes \
     -subj "/CN=rabbitmq-server" \
     -addext "subjectAltName=DNS:rabbitmq-server,DNS:localhost,IP:192.168.1.100"
   ```

2. **ğŸ”¸ å®¢æˆ·ç«¯è·³è¿‡åŸŸåéªŒè¯ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰**
   ```java
   // Javaå®¢æˆ·ç«¯ç¤ºä¾‹
   ConnectionFactory factory = new ConnectionFactory();
   factory.setHost("192.168.1.100");
   factory.setPort(5671);
   
   // è·³è¿‡åŸŸåéªŒè¯ï¼ˆä»…é™å¼€å‘ç¯å¢ƒï¼‰
   factory.useSslProtocol(SSLContext.getDefault());
   factory.enableHostnameVerification(false);
   ```

### 5.3 å®¢æˆ·ç«¯è¯ä¹¦éªŒè¯å¤±è´¥



**ğŸš¨ é—®é¢˜ç°è±¡**
```
SSL handshake failed: peer did not return a certificate
Client certificate required but not provided
```

**ğŸ’­ åŒå‘è®¤è¯è¯´æ˜**
```
å•å‘è®¤è¯ï¼ˆå¸¸è§ï¼‰ï¼š           åŒå‘è®¤è¯ï¼ˆæ›´å®‰å…¨ï¼‰ï¼š
å®¢æˆ·ç«¯éªŒè¯æœåŠ¡å™¨               å®¢æˆ·ç«¯éªŒè¯æœåŠ¡å™¨
     â†“                    +    æœåŠ¡å™¨éªŒè¯å®¢æˆ·ç«¯
   è¿æ¥å»ºç«‹                        â†“
                              è¿æ¥å»ºç«‹
```

**âœ… è§£å†³æ–¹æ¡ˆ**

1. **ğŸ”¸ ç”Ÿæˆå®¢æˆ·ç«¯è¯ä¹¦**
   ```bash
#   # ç”Ÿæˆå®¢æˆ·ç«¯ç§é’¥
   openssl genrsa -out client_key.pem 2048
   
#   # ç”Ÿæˆå®¢æˆ·ç«¯è¯ä¹¦è¯·æ±‚
   openssl req -new -key client_key.pem -out client.csr
   
#   # ç”¨CAç­¾å‘å®¢æˆ·ç«¯è¯ä¹¦
   openssl x509 -req -in client.csr -CA ca_certificate.pem \
     -CAkey ca_private_key.pem -CAcreateserial \
     -out client_certificate.pem -days 365
   ```

2. **ğŸ”¸ å®¢æˆ·ç«¯ä½¿ç”¨è¯ä¹¦è¿æ¥**
   ```java
   // é…ç½®å®¢æˆ·ç«¯è¯ä¹¦
   KeyStore keyStore = KeyStore.getInstance("PKCS12");
   keyStore.load(new FileInputStream("client.p12"), "password".toCharArray());
   
   KeyManagerFactory kmf = KeyManagerFactory.getInstance("SunX509");
   kmf.init(keyStore, "password".toCharArray());
   
   SSLContext sslContext = SSLContext.getInstance("TLS");
   sslContext.init(kmf.getKeyManagers(), null, null);
   
   ConnectionFactory factory = new ConnectionFactory();
   factory.useSslProtocol(sslContext);
   ```

---

## 6. ğŸ”§ å®æˆ˜æ•…éšœæ’æŸ¥æµç¨‹



### 6.1 ç³»ç»ŸåŒ–æ’æŸ¥æ­¥éª¤



**ğŸ“‹ æ•…éšœæ’æŸ¥æ£€æŸ¥æ¸…å•**

- [ ] **ğŸ”¸ ç¬¬1æ­¥ï¼šåŸºç¡€è¿é€šæ€§æ£€æŸ¥**
  ```bash
#  # æ£€æŸ¥ç«¯å£æ˜¯å¦ç›‘å¬
  netstat -tlnp | grep 5671
  
#  # æ£€æŸ¥é˜²ç«å¢™
  iptables -L | grep 5671
  
#  # æµ‹è¯•ç½‘ç»œè¿æ¥
  telnet rabbitmq-server 5671
  ```

- [ ] **ğŸ”¸ ç¬¬2æ­¥ï¼šè¯ä¹¦æ–‡ä»¶æ£€æŸ¥**
  ```bash
#  # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
  ls -la /etc/rabbitmq/certs/
  
#  # æ£€æŸ¥æ–‡ä»¶æƒé™
  ls -la /etc/rabbitmq/certs/*.pem
  
#  # éªŒè¯è¯ä¹¦æœ‰æ•ˆæ€§
  openssl x509 -in server_certificate.pem -text -noout
  ```

- [ ] **ğŸ”¸ ç¬¬3æ­¥ï¼šé…ç½®æ–‡ä»¶æ£€æŸ¥**
  ```bash
#  # æ£€æŸ¥RabbitMQé…ç½®
  rabbitmq-diagnostics environment | grep ssl
  
#  # éªŒè¯é…ç½®è¯­æ³•
  rabbitmq-diagnostics check_config
  ```

- [ ] **ğŸ”¸ ç¬¬4æ­¥ï¼šSSLæ¡æ‰‹æµ‹è¯•**
  ```bash
#  # æµ‹è¯•SSLè¿æ¥
  openssl s_client -connect rabbitmq-server:5671 -verify_return_error
  
#  # æŸ¥çœ‹æ¡æ‰‹è¯¦æƒ…
  openssl s_client -connect rabbitmq-server:5671 -debug
  ```

### 6.2 å¸¸è§é”™è¯¯ç é€ŸæŸ¥



| é”™è¯¯ç  | å«ä¹‰ | å¸¸è§åŸå›  | å¿«é€Ÿè§£å†³ |
|--------|------|----------|----------|
| **SSL_ERROR_WANT_READ** | ç­‰å¾…è¯»å–æ•°æ® | ç½‘ç»œå»¶è¿Ÿæˆ–ä¸­æ–­ | æ£€æŸ¥ç½‘ç»œè¿æ¥ |
| **SSL_ERROR_WANT_WRITE** | ç­‰å¾…å†™å…¥æ•°æ® | ç¼“å†²åŒºæ»¡ | æ£€æŸ¥ç½‘ç»œå¸¦å®½ |
| **SSL_ERROR_SYSCALL** | ç³»ç»Ÿè°ƒç”¨é”™è¯¯ | è¿æ¥è¢«é‡ç½® | æ£€æŸ¥é˜²ç«å¢™è®¾ç½® |
| **SSL_ERROR_SSL** | SSLåè®®é”™è¯¯ | è¯ä¹¦æˆ–é…ç½®é—®é¢˜ | æ£€æŸ¥è¯ä¹¦å’Œé…ç½® |

### 6.3 æ—¥å¿—åˆ†ææŠ€å·§



**ğŸ“ å…³é”®æ—¥å¿—ä½ç½®**
```bash
# RabbitMQä¸»æ—¥å¿—

tail -f /var/log/rabbitmq/rabbit@hostname.log

# ä¸“é—¨æŸ¥çœ‹SSLç›¸å…³æ—¥å¿—

grep -i ssl /var/log/rabbitmq/rabbit@hostname.log

# æŸ¥çœ‹æ¡æ‰‹å¤±è´¥æ—¥å¿—

grep -i "handshake\|ssl\|tls" /var/log/rabbitmq/rabbit@hostname.log
```

**ğŸ” æ—¥å¿—å…³é”®è¯**
- `ssl_handshake_failure`ï¼šSSLæ¡æ‰‹å¤±è´¥
- `certificate_verify_failed`ï¼šè¯ä¹¦éªŒè¯å¤±è´¥
- `no_cipher_overlap`ï¼šåŠ å¯†ç®—æ³•ä¸åŒ¹é…
- `protocol_version`ï¼šåè®®ç‰ˆæœ¬é—®é¢˜

---

## 7. ğŸ’¡ æœ€ä½³å®è·µå»ºè®®



### 7.1 ç”Ÿäº§ç¯å¢ƒSSLé…ç½®



**ğŸ† æ¨èé…ç½®æ¨¡æ¿**
```erlang
# /etc/rabbitmq/rabbitmq.conf


# SSLç›‘å¬é…ç½®


listeners.ssl.default = 5671

# è¯ä¹¦æ–‡ä»¶è·¯å¾„ï¼ˆä½¿ç”¨ç»å¯¹è·¯å¾„ï¼‰


ssl_options.cacertfile = /etc/rabbitmq/certs/ca_certificate.pem
ssl_options.certfile   = /etc/rabbitmq/certs/server_certificate.pem
ssl_options.keyfile    = /etc/rabbitmq/certs/server_key.pem

# å®‰å…¨è®¾ç½®


ssl_options.verify               = verify_peer
ssl_options.fail_if_no_peer_cert = true
ssl_options.honor_cipher_order   = true

# åè®®ç‰ˆæœ¬ï¼ˆåªå…è®¸å®‰å…¨ç‰ˆæœ¬ï¼‰


ssl_options.versions.1 = tlsv1.2
ssl_options.versions.2 = tlsv1.3

# æ¨èçš„åŠ å¯†å¥—ä»¶


ssl_options.ciphers.1 = ECDHE-RSA-AES256-GCM-SHA384
ssl_options.ciphers.2 = ECDHE-RSA-AES128-GCM-SHA256
ssl_options.ciphers.3 = ECDHE-RSA-CHACHA20-POLY1305

# æ€§èƒ½ä¼˜åŒ–


ssl_options.handshake_timeout = 10000
ssl_options.ssl_app_data_buffer_size = 32768
```

### 7.2 è¯ä¹¦ç®¡ç†ç­–ç•¥



**ğŸ“… è¯ä¹¦ç”Ÿå‘½å‘¨æœŸç®¡ç†**

```
è¯ä¹¦ç”³è¯· â†’ éƒ¨ç½²é…ç½® â†’ ç›‘æ§è¿‡æœŸ â†’ ç»­æœŸæ›´æ–° â†’ æ—§è¯ä¹¦æ¸…ç†
    â†“         â†“         â†“         â†“         â†“
  é€‰æ‹©CA     æµ‹è¯•éªŒè¯   è®¾ç½®å‘Šè­¦   å¹³æ»‘åˆ‡æ¢   å¤‡ä»½å½’æ¡£
```

**âš ï¸ è¯ä¹¦æ›´æ–°æ³¨æ„äº‹é¡¹**
- **ğŸ”¸ æå‰å‡†å¤‡**ï¼šè¯ä¹¦åˆ°æœŸå‰30å¤©å¼€å§‹å‡†å¤‡æ–°è¯ä¹¦
- **ğŸ”¸ ç°åº¦æ›´æ–°**ï¼šå…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯æ–°è¯ä¹¦
- **ğŸ”¸ å›æ»šè®¡åˆ’**ï¼šä¿ç•™æ—§è¯ä¹¦ä½œä¸ºåº”æ€¥å¤‡ä»½
- **ğŸ”¸ ç›‘æ§å‘Šè­¦**ï¼šè®¾ç½®è¯ä¹¦è¿‡æœŸæé†’

### 7.3 å®‰å…¨åŠ å›ºå»ºè®®



**ğŸ›¡ï¸ å®‰å…¨é…ç½®æ¸…å•**

- [ ] **ç¦ç”¨ä¸å®‰å…¨çš„åè®®ç‰ˆæœ¬**
  ```erlang
#  # åªå…è®¸TLS 1.2å’Œ1.3
  ssl_options.versions.1 = tlsv1.2
  ssl_options.versions.2 = tlsv1.3
  ```

- [ ] **ä½¿ç”¨å¼ºåŠ å¯†ç®—æ³•**
  ```erlang
#  # ä¼˜å…ˆä½¿ç”¨ECDHEå’ŒAES-GCM
  ssl_options.ciphers.1 = ECDHE-RSA-AES256-GCM-SHA384
  ssl_options.honor_cipher_order = true
  ```

- [ ] **å¯ç”¨å®Œç¾å‰å‘ä¿å¯†ï¼ˆPFSï¼‰**
  ```erlang
#  # ç¡®ä¿ä½¿ç”¨æ”¯æŒPFSçš„åŠ å¯†å¥—ä»¶
  ssl_options.ciphers.1 = ECDHE-RSA-AES256-GCM-SHA384
  ssl_options.ciphers.2 = ECDHE-RSA-AES128-GCM-SHA256
  ```

- [ ] **å®šæœŸæ›´æ–°è¯ä¹¦**
  ```bash
#  # è®¾ç½®è¯ä¹¦åˆ°æœŸç›‘æ§
  */0 12 * * * /usr/local/bin/check_cert_expiry.sh
  ```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“



### 8.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ



```
ğŸ”¸ SSL/TLSä½œç”¨ï¼šä¸ºRabbitMQé€šä¿¡æä¾›åŠ å¯†ä¿æŠ¤
ğŸ”¸ è¯ä¹¦ç»„ä»¶ï¼šæœåŠ¡å™¨è¯ä¹¦ã€ç§é’¥ã€CAè¯ä¹¦çš„ä½œç”¨å’Œå…³ç³»
ğŸ”¸ æ¡æ‰‹è¿‡ç¨‹ï¼šå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å»ºç«‹å®‰å…¨è¿æ¥çš„æ­¥éª¤
ğŸ”¸ åŒå‘è®¤è¯ï¼šä¸ä»…éªŒè¯æœåŠ¡å™¨ï¼Œä¹Ÿè¦éªŒè¯å®¢æˆ·ç«¯èº«ä»½
ğŸ”¸ æ€§èƒ½å½±å“ï¼šSSLä¼šå¢åŠ CPUå’Œå†…å­˜ä½¿ç”¨ï¼Œä½†å¯ä»¥ä¼˜åŒ–
```

### 8.2 å…³é”®æ•…éšœæ’æŸ¥è¦ç‚¹



**ğŸ”¹ è¯ä¹¦é—®é¢˜æ’æŸ¥æ€è·¯**
```
æ–‡ä»¶å­˜åœ¨æ€§ â†’ è·¯å¾„æ­£ç¡®æ€§ â†’ æƒé™åˆæ³•æ€§ â†’ å†…å®¹æœ‰æ•ˆæ€§ â†’ é…ç½®åŒ¹é…æ€§
```

**ğŸ”¹ è¿æ¥é—®é¢˜æ’æŸ¥æ€è·¯**  
```
ç½‘ç»œè¿é€š â†’ ç«¯å£ç›‘å¬ â†’ åè®®ç‰ˆæœ¬ â†’ åŠ å¯†ç®—æ³• â†’ è¯ä¹¦éªŒè¯
```

**ğŸ”¹ æ€§èƒ½é—®é¢˜æ’æŸ¥æ€è·¯**
```
ç¡¬ä»¶èƒ½åŠ› â†’ ç®—æ³•é€‰æ‹© â†’ è¿æ¥å¤ç”¨ â†’ é…ç½®ä¼˜åŒ– â†’ ç›‘æ§åˆ†æ
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼



**ğŸ¯ ä¸åŒç¯å¢ƒçš„é…ç½®ç­–ç•¥**

| ç¯å¢ƒç±»å‹ | å®‰å…¨è¦æ±‚ | æ€§èƒ½è¦æ±‚ | æ¨èé…ç½® |
|----------|----------|----------|----------|
| **å¼€å‘ç¯å¢ƒ** | ä½ | ä¸€èˆ¬ | è‡ªç­¾åè¯ä¹¦ï¼Œç®€å•é…ç½® |
| **æµ‹è¯•ç¯å¢ƒ** | ä¸­ | ä¸€èˆ¬ | æ¨¡æ‹Ÿç”Ÿäº§ç¯å¢ƒé…ç½® |
| **ç”Ÿäº§ç¯å¢ƒ** | é«˜ | é«˜ | CAè¯ä¹¦ï¼Œå®Œæ•´å®‰å…¨é…ç½® |

**ğŸ”§ æ•…éšœé¢„é˜²æªæ–½**
- **å®šæœŸæ£€æŸ¥**ï¼šæ¯æœˆæ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæœŸ
- **è‡ªåŠ¨åŒ–ç›‘æ§**ï¼šè®¾ç½®è¯ä¹¦è¿‡æœŸå‘Šè­¦
- **æ–‡æ¡£ç»´æŠ¤**ï¼šè®°å½•é…ç½®å˜æ›´å’Œæ•…éšœå¤„ç†è¿‡ç¨‹
- **åº”æ€¥é¢„æ¡ˆ**ï¼šå‡†å¤‡è¯ä¹¦é—®é¢˜çš„å¿«é€Ÿæ¢å¤æ–¹æ¡ˆ

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- SSL/TLSä¸ºRabbitMQæä¾›å®‰å…¨é€šä¿¡ä¿éšœ
- è¯ä¹¦æ˜¯å®‰å…¨è¿æ¥çš„åŸºç¡€ï¼Œè·¯å¾„ã€æƒé™ã€æœ‰æ•ˆæœŸéƒ½å¾ˆé‡è¦
- æ¡æ‰‹å¤±è´¥é€šå¸¸æ˜¯åè®®ç‰ˆæœ¬æˆ–åŠ å¯†ç®—æ³•ä¸åŒ¹é…
- æ€§èƒ½å’Œå®‰å…¨éœ€è¦å¹³è¡¡ï¼Œé€‰æ‹©åˆé€‚çš„åŠ å¯†ç®—æ³•
- ç³»ç»ŸåŒ–çš„æ•…éšœæ’æŸ¥æµç¨‹èƒ½å¿«é€Ÿå®šä½é—®é¢˜