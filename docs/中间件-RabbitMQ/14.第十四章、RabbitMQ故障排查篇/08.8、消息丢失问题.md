---
title: 8ã€æ¶ˆæ¯ä¸¢å¤±é—®é¢˜
---
## ğŸ“š ç›®å½•

1. [ä»€ä¹ˆæ˜¯æ¶ˆæ¯ä¸¢å¤±é—®é¢˜](#1-ä»€ä¹ˆæ˜¯æ¶ˆæ¯ä¸¢å¤±é—®é¢˜)
2. [æ¶ˆæ¯ä¼ é€’é“¾è·¯åˆ†æ](#2-æ¶ˆæ¯ä¼ é€’é“¾è·¯åˆ†æ)
3. [ç”Ÿäº§è€…ç«¯æ¶ˆæ¯ä¸¢å¤±](#3-ç”Ÿäº§è€…ç«¯æ¶ˆæ¯ä¸¢å¤±)
4. [RabbitMQæœåŠ¡ç«¯æ¶ˆæ¯ä¸¢å¤±](#4-rabbitmqæœåŠ¡ç«¯æ¶ˆæ¯ä¸¢å¤±)
5. [æ¶ˆè´¹è€…ç«¯æ¶ˆæ¯ä¸¢å¤±](#5-æ¶ˆè´¹è€…ç«¯æ¶ˆæ¯ä¸¢å¤±)
6. [ç½‘ç»œå¼‚å¸¸å¯¼è‡´çš„æ¶ˆæ¯ä¸¢å¤±](#6-ç½‘ç»œå¼‚å¸¸å¯¼è‡´çš„æ¶ˆæ¯ä¸¢å¤±)
7. [ç»¼åˆè§£å†³æ–¹æ¡ˆ](#7-ç»¼åˆè§£å†³æ–¹æ¡ˆ)
8. [æœ€ä½³å®è·µä¸ç›‘æ§](#8-æœ€ä½³å®è·µä¸ç›‘æ§)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸš¨ ä»€ä¹ˆæ˜¯æ¶ˆæ¯ä¸¢å¤±é—®é¢˜


### 1.1 æ¶ˆæ¯ä¸¢å¤±çš„æœ¬è´¨


**ç®€å•ç†è§£**ï¼šå°±åƒå¯„å¿«é€’ä¸€æ ·ï¼Œä½ æŠŠåŒ…è£¹äº¤ç»™å¿«é€’å‘˜ï¼Œä½†åŒ…è£¹åœ¨è¿è¾“è¿‡ç¨‹ä¸­ä¸¢äº†ï¼Œæ”¶ä»¶äººæ²¡æœ‰æ”¶åˆ°ã€‚

```
æ­£å¸¸æµç¨‹ï¼š
ç”Ÿäº§è€… â†’ [å‘é€æ¶ˆæ¯] â†’ RabbitMQ â†’ [æŠ•é€’æ¶ˆæ¯] â†’ æ¶ˆè´¹è€… âœ…

å¼‚å¸¸æƒ…å†µï¼š
ç”Ÿäº§è€… â†’ [å‘é€æ¶ˆæ¯] â†’ âŒ æ¶ˆæ¯ä¸¢å¤± âŒ â†’ æ¶ˆè´¹è€…æ”¶ä¸åˆ°
```

**æ¶ˆæ¯ä¸¢å¤±çš„ä¸¥é‡æ€§**ï¼š
- ğŸ”´ **è®¢å•å¤„ç†**ï¼šç”¨æˆ·ä¸‹å•ï¼Œä½†è®¢å•ä¿¡æ¯ä¸¢å¤±ï¼Œå¯¼è‡´æ— æ³•å¤„ç†
- ğŸ”´ **æ”¯ä»˜é€šçŸ¥**ï¼šæ”¯ä»˜æˆåŠŸï¼Œä½†é€šçŸ¥æ¶ˆæ¯ä¸¢å¤±ï¼Œå•†å“æ— æ³•å‘è´§
- ğŸ”´ **æ—¥å¿—è®°å½•**ï¼šé‡è¦æ“ä½œæ—¥å¿—ä¸¢å¤±ï¼Œå½±å“é—®é¢˜æ’æŸ¥
- ğŸ”´ **ç”¨æˆ·é€šçŸ¥**ï¼šçŸ­ä¿¡ã€é‚®ä»¶é€šçŸ¥ä¸¢å¤±ï¼Œç”¨æˆ·ä½“éªŒå·®

### 1.2 æ¶ˆæ¯ä¸¢å¤±çš„å¸¸è§è¡¨ç°


**ä¸šåŠ¡å±‚é¢çš„ç—‡çŠ¶**ï¼š
```
âŒ ç”¨æˆ·æŠ•è¯‰ï¼šæ˜æ˜æ“ä½œæˆåŠŸäº†ï¼Œä½†æ²¡æœ‰æ”¶åˆ°é€šçŸ¥
âŒ æ•°æ®ä¸ä¸€è‡´ï¼šAç³»ç»Ÿæ˜¾ç¤ºæˆåŠŸï¼ŒBç³»ç»Ÿæ²¡æœ‰å¯¹åº”è®°å½•
âŒ æµç¨‹ä¸­æ–­ï¼šå·¥ä½œæµç¨‹åœ¨æŸä¸ªç¯èŠ‚å¡ä½ï¼Œåç»­æ­¥éª¤æ— æ³•æ‰§è¡Œ
âŒ ç»Ÿè®¡æ•°æ®å¼‚å¸¸ï¼šå®é™…æ“ä½œæ•°å’Œç»Ÿè®¡æ•°ä¸åŒ¹é…
```

**æŠ€æœ¯å±‚é¢çš„è¡¨ç°**ï¼š
- æ¶ˆæ¯å‘é€åæ²¡æœ‰æ”¶åˆ°ç¡®è®¤
- é˜Ÿåˆ—ä¸­æ¶ˆæ¯æ•°é‡å¼‚å¸¸å‡å°‘
- æ¶ˆè´¹è€…é•¿æ—¶é—´æ²¡æœ‰æ”¶åˆ°æ¶ˆæ¯
- ç›‘æ§æ˜¾ç¤ºæ¶ˆæ¯æŠ•é€’å¤±è´¥ç‡è¿‡é«˜

---

## 2. ğŸ”„ æ¶ˆæ¯ä¼ é€’é“¾è·¯åˆ†æ


### 2.1 æ¶ˆæ¯ä¼ é€’çš„å®Œæ•´é“¾è·¯


```
å®Œæ•´çš„æ¶ˆæ¯ä¼ é€’é“¾è·¯ï¼š

ç”Ÿäº§è€…åº”ç”¨    â†’    RabbitMQæœåŠ¡ç«¯    â†’    æ¶ˆè´¹è€…åº”ç”¨
    â†“               â†“                    â†“
[1]æ¶ˆæ¯ç”Ÿæˆ      [3]æ¶ˆæ¯å­˜å‚¨           [5]æ¶ˆæ¯æ¶ˆè´¹
[2]ç½‘ç»œå‘é€      [4]æ¶ˆæ¯è·¯ç”±           [6]ä¸šåŠ¡å¤„ç†
```

**æ¯ä¸ªç¯èŠ‚çš„æ½œåœ¨é£é™©**ï¼š

| ç¯èŠ‚ | **å¯èƒ½çš„ä¸¢å¤±åŸå› ** | **é£é™©ç­‰çº§** |
|------|------------------|-------------|
| **ç”Ÿäº§è€…â†’RabbitMQ** | `ç½‘ç»œä¸­æ–­ã€è¿æ¥æ–­å¼€ã€å‘é€å¤±è´¥` | `ğŸ”´ é«˜é£é™©` |
| **RabbitMQå†…éƒ¨** | `æœåŠ¡é‡å¯ã€ç£ç›˜æ•…éšœã€å†…å­˜ä¸è¶³` | `ğŸŸ¡ ä¸­é£é™©` |
| **RabbitMQâ†’æ¶ˆè´¹è€…** | `æ¶ˆè´¹è€…å®•æœºã€ç½‘ç»œé—®é¢˜ã€å¤„ç†å¼‚å¸¸` | `ğŸ”´ é«˜é£é™©` |

### 2.2 æ¶ˆæ¯çŠ¶æ€è½¬æ¢å›¾


```
æ¶ˆæ¯çš„ç”Ÿå‘½å‘¨æœŸçŠ¶æ€ï¼š

[ç”Ÿäº§è€…åˆ›å»º] â†’ [å‘é€ä¸­] â†’ [åˆ°è¾¾Exchange] â†’ [è·¯ç”±åˆ°Queue] 
                â†“           â†“              â†“
             [å‘é€å¤±è´¥]   [è·¯ç”±å¤±è´¥]     [å­˜å‚¨æˆåŠŸ]
                                         â†“
                                    [ç­‰å¾…æ¶ˆè´¹]
                                         â†“
                                   [æ¶ˆè´¹è€…æ¥æ”¶] â†’ [å¤„ç†å®Œæˆ]
                                         â†“
                                    [å¤„ç†å¤±è´¥]
```

---

## 3. ğŸ­ ç”Ÿäº§è€…ç«¯æ¶ˆæ¯ä¸¢å¤±


### 3.1 å‘é€ç¡®è®¤æœºåˆ¶ç¼ºå¤±


**é—®é¢˜æè¿°**ï¼šç”Ÿäº§è€…å‘é€æ¶ˆæ¯åä¸çŸ¥é“æ˜¯å¦æˆåŠŸåˆ°è¾¾RabbitMQã€‚

**ç®€å•æ¯”å–»**ï¼šå°±åƒå‘å¾®ä¿¡ä¸çœ‹æ˜¯å¦æ˜¾ç¤º"å·²é€è¾¾"ï¼Œä¸çŸ¥é“å¯¹æ–¹æ˜¯å¦æ”¶åˆ°ã€‚

```java
// âŒ é”™è¯¯åšæ³•ï¼šå‘é€åä¸ç®¡ç»“æœ
public class UnsafeProducer {
    public void sendMessage(String message) {
        // ç›´æ¥å‘é€ï¼Œä¸å…³å¿ƒæ˜¯å¦æˆåŠŸ
        rabbitTemplate.convertAndSend("exchange", "routing.key", message);
        // è¿™é‡Œä¸çŸ¥é“æ¶ˆæ¯æ˜¯å¦çœŸçš„å‘é€æˆåŠŸï¼
    }
}
```

**è§£å†³æ–¹æ¡ˆ - å‘é€ç¡®è®¤**ï¼š

```java
// âœ… æ­£ç¡®åšæ³•ï¼šä½¿ç”¨å‘é€ç¡®è®¤
@Configuration
public class RabbitConfig {
    
    @Bean
    public RabbitTemplate rabbitTemplate(ConnectionFactory connectionFactory) {
        RabbitTemplate template = new RabbitTemplate(connectionFactory);
        
        // å¼€å¯å‘é€ç¡®è®¤
        template.setConfirmCallback((correlationData, ack, cause) -> {
            if (ack) {
                log.info("æ¶ˆæ¯å‘é€æˆåŠŸï¼š{}", correlationData);
            } else {
                log.error("æ¶ˆæ¯å‘é€å¤±è´¥ï¼š{}ï¼ŒåŸå› ï¼š{}", correlationData, cause);
                // å¯ä»¥è¿›è¡Œé‡è¯•æˆ–è®°å½•åˆ°å¤±è´¥é˜Ÿåˆ—
            }
        });
        
        return template;
    }
}

// å®‰å…¨çš„ç”Ÿäº§è€…
public class SafeProducer {
    
    public void sendMessage(String message) {
        // ç”Ÿæˆå”¯ä¸€IDç”¨äºè¿½è¸ª
        CorrelationData correlationData = new CorrelationData(UUID.randomUUID().toString());
        
        try {
            rabbitTemplate.convertAndSend("exchange", "routing.key", message, correlationData);
            log.info("æ¶ˆæ¯å·²å‘é€ï¼Œç­‰å¾…ç¡®è®¤ï¼š{}", correlationData.getId());
        } catch (Exception e) {
            log.error("å‘é€æ¶ˆæ¯å¼‚å¸¸ï¼š", e);
            // å¯ä»¥é‡è¯•æˆ–è®°å½•å¤±è´¥
        }
    }
}
```

### 3.2 ç½‘ç»œè¿æ¥å¼‚å¸¸


**é—®é¢˜åœºæ™¯**ï¼šç½‘ç»œä¸ç¨³å®šå¯¼è‡´æ¶ˆæ¯å‘é€ä¸­æ–­ã€‚

```java
// âœ… å¸¦é‡è¯•æœºåˆ¶çš„å‘é€
@Component
public class RetryableProducer {
    
    private final RetryTemplate retryTemplate;
    
    public RetryableProducer() {
        this.retryTemplate = RetryTemplate.builder()
            .maxAttempts(3)  // æœ€å¤šé‡è¯•3æ¬¡
            .fixedBackoff(1000)  // é—´éš”1ç§’
            .retryOn(AmqpException.class)  // é‡åˆ°AMQPå¼‚å¸¸æ—¶é‡è¯•
            .build();
    }
    
    public void sendWithRetry(String message) {
        retryTemplate.execute(context -> {
            rabbitTemplate.convertAndSend("exchange", "routing.key", message);
            return null;
        });
    }
}
```

### 3.3 äº¤æ¢æœºä¸å­˜åœ¨


**é—®é¢˜æè¿°**ï¼šå‘é€åˆ°ä¸å­˜åœ¨çš„äº¤æ¢æœºï¼Œæ¶ˆæ¯ä¼šè¢«ç›´æ¥ä¸¢å¼ƒã€‚

```java
// âœ… æ£€æŸ¥äº¤æ¢æœºæ˜¯å¦å­˜åœ¨
@Service
public class ExchangeCheckProducer {
    
    @Autowired
    private RabbitAdmin rabbitAdmin;
    
    public void sendMessage(String exchangeName, String routingKey, String message) {
        // å‘é€å‰æ£€æŸ¥äº¤æ¢æœºæ˜¯å¦å­˜åœ¨
        if (!exchangeExists(exchangeName)) {
            log.error("äº¤æ¢æœºä¸å­˜åœ¨ï¼š{}", exchangeName);
            throw new IllegalArgumentException("äº¤æ¢æœºä¸å­˜åœ¨ï¼š" + exchangeName);
        }
        
        rabbitTemplate.convertAndSend(exchangeName, routingKey, message);
    }
    
    private boolean exchangeExists(String exchangeName) {
        try {
            // å°è¯•å£°æ˜äº¤æ¢æœºï¼Œå¦‚æœä¸å­˜åœ¨ä¼šæŠ›å¼‚å¸¸
            rabbitAdmin.declareExchange(new DirectExchange(exchangeName, true, false));
            return true;
        } catch (Exception e) {
            return false;
        }
    }
}
```

---

## 4. ğŸª RabbitMQæœåŠ¡ç«¯æ¶ˆæ¯ä¸¢å¤±


### 4.1 æ¶ˆæ¯æœªæŒä¹…åŒ–


**é—®é¢˜æ ¸å¿ƒ**ï¼šæ¶ˆæ¯åªå­˜åœ¨å†…å­˜ä¸­ï¼ŒæœåŠ¡é‡å¯åå°±ä¸¢å¤±äº†ã€‚

**ç”Ÿæ´»æ¯”å–»**ï¼šå°±åƒæŠŠé‡è¦æ–‡ä»¶åªæ”¾åœ¨ç”µè„‘å†…å­˜é‡Œï¼Œä¸€æ–­ç”µå°±å…¨æ²¡äº†ã€‚

```java
// âŒ é”™è¯¯é…ç½®ï¼šæ¶ˆæ¯ä¸æŒä¹…åŒ–
@Configuration
public class NonDurableConfig {
    
    @Bean
    public Queue nonDurableQueue() {
        // ç¬¬äºŒä¸ªå‚æ•°falseè¡¨ç¤ºä¸æŒä¹…åŒ–ï¼Œé‡å¯åé˜Ÿåˆ—æ¶ˆå¤±
        return new Queue("test.queue", false);
    }
    
    @Bean
    public DirectExchange nonDurableExchange() {
        // ä¸æŒä¹…åŒ–çš„äº¤æ¢æœº
        return new DirectExchange("test.exchange", false, false);
    }
}

// âœ… æ­£ç¡®é…ç½®ï¼šæ¶ˆæ¯æŒä¹…åŒ–
@Configuration
public class DurableConfig {
    
    @Bean
    public Queue durableQueue() {
        return QueueBuilder.durable("test.queue")  // é˜Ÿåˆ—æŒä¹…åŒ–
            .build();
    }
    
    @Bean
    public DirectExchange durableExchange() {
        return ExchangeBuilder.directExchange("test.exchange")
            .durable(true)  // äº¤æ¢æœºæŒä¹…åŒ–
            .build();
    }
    
    @Bean
    public RabbitTemplate persistentTemplate(ConnectionFactory connectionFactory) {
        RabbitTemplate template = new RabbitTemplate(connectionFactory);
        // è®¾ç½®æ¶ˆæ¯æŒä¹…åŒ–
        template.setMessageConverter(new Jackson2JsonMessageConverter());
        return template;
    }
}
```

**å‘é€æŒä¹…åŒ–æ¶ˆæ¯**ï¼š

```java
public void sendPersistentMessage(String message) {
    rabbitTemplate.convertAndSend("test.exchange", "test.key", message, msg -> {
        // è®¾ç½®æ¶ˆæ¯ä¸ºæŒä¹…åŒ–
        msg.getMessageProperties().setDeliveryMode(MessageDeliveryMode.PERSISTENT);
        return msg;
    });
}
```

### 4.2 å†…å­˜é™åˆ¶å¯¼è‡´æ¶ˆæ¯ä¸¢å¼ƒ


**é—®é¢˜æè¿°**ï¼šRabbitMQå†…å­˜ä¸è¶³æ—¶ä¼šä¸¢å¼ƒæ¶ˆæ¯ã€‚

**é…ç½®ç›‘æ§**ï¼š

```bash
# æŸ¥çœ‹å†…å­˜ä½¿ç”¨æƒ…å†µ
rabbitmqctl status

# è®¾ç½®å†…å­˜é˜ˆå€¼ï¼ˆåœ¨rabbitmq.confä¸­ï¼‰
vm_memory_high_watermark.relative = 0.6  # ä½¿ç”¨60%å†…å­˜æ—¶å¼€å§‹é™åˆ¶

# è®¾ç½®ç£ç›˜ç©ºé—´é˜ˆå€¼
disk_free_limit.relative = 2.0  # è‡³å°‘ä¿ç•™2GBç£ç›˜ç©ºé—´
```

### 4.3 é›†ç¾¤èŠ‚ç‚¹æ•…éšœ


**é—®é¢˜åœºæ™¯**ï¼šåœ¨é›†ç¾¤ç¯å¢ƒä¸­ï¼Œå¦‚æœæ¶ˆæ¯åªå­˜åœ¨äºå•ä¸ªèŠ‚ç‚¹ï¼Œè¯¥èŠ‚ç‚¹æ•…éšœä¼šå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ã€‚

```java
// âœ… é…ç½®é•œåƒé˜Ÿåˆ—ä¿è¯é«˜å¯ç”¨
@Configuration
public class HaConfig {
    
    @Bean
    public Queue haQueue() {
        return QueueBuilder.durable("ha.queue")
            .withArgument("x-ha-policy", "all")  // åœ¨æ‰€æœ‰èŠ‚ç‚¹é•œåƒ
            .withArgument("x-ha-sync-mode", "automatic")  // è‡ªåŠ¨åŒæ­¥
            .build();
    }
}
```

---

## 5. ğŸ‘¤ æ¶ˆè´¹è€…ç«¯æ¶ˆæ¯ä¸¢å¤±


### 5.1 è‡ªåŠ¨ACKå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±


**é—®é¢˜æ ¸å¿ƒ**ï¼šæ¶ˆæ¯ä¸€è¢«æ¶ˆè´¹è€…æ¥æ”¶å°±è‡ªåŠ¨ç¡®è®¤ï¼Œä½†å¦‚æœå¤„ç†å¤±è´¥ï¼Œæ¶ˆæ¯å°±ä¸¢å¤±äº†ã€‚

**é”™è¯¯ç¤ºä¾‹**ï¼š

```java
// âŒ è‡ªåŠ¨ACK - é«˜é£é™©ï¼
@RabbitListener(queues = "test.queue")
public void handleMessage(String message) {
    // å¦‚æœè¿™é‡ŒæŠ›å¼‚å¸¸ï¼Œæ¶ˆæ¯å·²ç»è¢«è‡ªåŠ¨ç¡®è®¤ï¼Œå°±ä¸¢å¤±äº†ï¼
    processMessage(message);  // å¯èƒ½å¤±è´¥
}
```

**æ­£ç¡®åšæ³• - æ‰‹åŠ¨ACK**ï¼š

```java
// âœ… æ‰‹åŠ¨ACK - å®‰å…¨å¯é 
@RabbitListener(queues = "test.queue", ackMode = "MANUAL")
public void handleMessageSafely(String message, Channel channel, 
                               @Header(AmqpHeaders.DELIVERY_TAG) long deliveryTag) {
    try {
        // å¤„ç†ä¸šåŠ¡é€»è¾‘
        processMessage(message);
        
        // å¤„ç†æˆåŠŸï¼Œæ‰‹åŠ¨ç¡®è®¤
        channel.basicAck(deliveryTag, false);
        log.info("æ¶ˆæ¯å¤„ç†æˆåŠŸï¼š{}", message);
        
    } catch (Exception e) {
        log.error("æ¶ˆæ¯å¤„ç†å¤±è´¥ï¼š{}", message, e);
        
        try {
            // å¤„ç†å¤±è´¥ï¼Œæ‹’ç»æ¶ˆæ¯å¹¶é‡æ–°å…¥é˜Ÿ
            channel.basicNack(deliveryTag, false, true);
        } catch (IOException ioException) {
            log.error("æ‹’ç»æ¶ˆæ¯å¤±è´¥", ioException);
        }
    }
}
```

### 5.2 æ¶ˆè´¹è€…å¼‚å¸¸é€€å‡º


**é—®é¢˜åœºæ™¯**ï¼šæ¶ˆè´¹è€…åº”ç”¨çªç„¶å´©æºƒï¼Œæ­£åœ¨å¤„ç†çš„æ¶ˆæ¯ä¸¢å¤±ã€‚

```java
// âœ… ä¼˜é›…å…³é—­å¤„ç†
@Component
public class GracefulShutdownConsumer {
    
    @PreDestroy
    public void shutdown() {
        log.info("æ¶ˆè´¹è€…æ­£åœ¨ä¼˜é›…å…³é—­...");
        // åœæ­¢æ¥æ”¶æ–°æ¶ˆæ¯
        // ç­‰å¾…å½“å‰æ¶ˆæ¯å¤„ç†å®Œæˆ
    }
    
    @RabbitListener(queues = "test.queue")
    public void handleMessage(String message) {
        try {
            processMessage(message);
        } catch (Exception e) {
            // è®°å½•å¤±è´¥æ¶ˆæ¯ï¼Œç”¨äºåç»­é‡è¯•
            saveFailedMessage(message, e);
            throw e;  // é‡æ–°æŠ›å‡ºå¼‚å¸¸ï¼Œè§¦å‘é‡è¯•æœºåˆ¶
        }
    }
    
    private void saveFailedMessage(String message, Exception e) {
        // å°†å¤±è´¥æ¶ˆæ¯ä¿å­˜åˆ°æ•°æ®åº“æˆ–æ–‡ä»¶
        FailedMessage failedMsg = new FailedMessage(message, e.getMessage(), new Date());
        failedMessageRepository.save(failedMsg);
    }
}
```

### 5.3 å¤„ç†æ—¶é—´è¿‡é•¿å¯¼è‡´è¶…æ—¶


**é—®é¢˜æè¿°**ï¼šæ¶ˆæ¯å¤„ç†æ—¶é—´å¤ªé•¿ï¼Œè¿æ¥è¶…æ—¶å¯¼è‡´æ¶ˆæ¯é‡æ–°å…¥é˜Ÿæˆ–ä¸¢å¤±ã€‚

```java
// âœ… åˆç†è®¾ç½®è¶…æ—¶æ—¶é—´
@Configuration
public class ConsumerConfig {
    
    @Bean
    public SimpleRabbitListenerContainerFactory rabbitListenerContainerFactory(
            ConnectionFactory connectionFactory) {
        
        SimpleRabbitListenerContainerFactory factory = new SimpleRabbitListenerContainerFactory();
        factory.setConnectionFactory(connectionFactory);
        
        // è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
        factory.setDefaultRequeueRejected(true);  // æ‹’ç»æ—¶é‡æ–°å…¥é˜Ÿ
        factory.setAcknowledgeMode(AcknowledgeMode.MANUAL);  // æ‰‹åŠ¨ç¡®è®¤
        
        return factory;
    }
}

// å¯¹äºè€—æ—¶æ“ä½œï¼Œè€ƒè™‘åˆ†è§£ä»»åŠ¡
@RabbitListener(queues = "long.task.queue")
public void handleLongTask(String taskData) {
    try {
        // å°†å¤§ä»»åŠ¡åˆ†è§£ä¸ºå°ä»»åŠ¡
        List<String> subTasks = splitTask(taskData);
        
        for (String subTask : subTasks) {
            processSubTask(subTask);
            // å®šæœŸæ£€æŸ¥æ˜¯å¦éœ€è¦ä¸­æ–­
            if (Thread.interrupted()) {
                throw new InterruptedException("ä»»åŠ¡è¢«ä¸­æ–­");
            }
        }
        
    } catch (Exception e) {
        log.error("é•¿ä»»åŠ¡å¤„ç†å¤±è´¥", e);
        throw e;
    }
}
```

---

## 6. ğŸŒ ç½‘ç»œå¼‚å¸¸å¯¼è‡´çš„æ¶ˆæ¯ä¸¢å¤±


### 6.1 ç½‘ç»œåˆ†åŒºé—®é¢˜


**é—®é¢˜æè¿°**ï¼šç½‘ç»œä¸ç¨³å®šå¯¼è‡´ç”Ÿäº§è€…ã€RabbitMQã€æ¶ˆè´¹è€…ä¹‹é—´è¿æ¥ä¸­æ–­ã€‚

```
ç½‘ç»œåˆ†åŒºç¤ºä¾‹ï¼š
ç”Ÿäº§è€… â†---X---â†’ RabbitMQ â†---X---â†’ æ¶ˆè´¹è€…
       ç½‘ç»œä¸­æ–­           ç½‘ç»œä¸­æ–­
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```java
// âœ… è¿æ¥æ¢å¤æœºåˆ¶
@Configuration
public class ConnectionConfig {
    
    @Bean
    public CachingConnectionFactory connectionFactory() {
        CachingConnectionFactory factory = new CachingConnectionFactory("localhost");
        
        // å¯ç”¨è‡ªåŠ¨æ¢å¤
        factory.getRabbitConnectionFactory().setAutomaticRecoveryEnabled(true);
        // è®¾ç½®ç½‘ç»œæ¢å¤é—´éš”
        factory.getRabbitConnectionFactory().setNetworkRecoveryInterval(5000);
        // è®¾ç½®è¿æ¥è¶…æ—¶
        factory.getRabbitConnectionFactory().setConnectionTimeout(30000);
        
        return factory;
    }
}
```

### 6.2 é˜²æ­¢ç½‘ç»œæŠ–åŠ¨


**å¿ƒè·³æ£€æµ‹é…ç½®**ï¼š

```java
@Bean
public ConnectionFactory heartbeatConnectionFactory() {
    CachingConnectionFactory factory = new CachingConnectionFactory();
    
    // è®¾ç½®å¿ƒè·³é—´éš”ï¼ˆç§’ï¼‰
    factory.getRabbitConnectionFactory().setRequestedHeartbeat(Duration.ofSeconds(30));
    
    // è®¾ç½®è¿æ¥åç§°ï¼Œä¾¿äºç›‘æ§
    factory.getRabbitConnectionFactory().setClientProperties(
        Collections.singletonMap("connection_name", "my-app-connection")
    );
    
    return factory;
}
```

---

## 7. ğŸ›  ç»¼åˆè§£å†³æ–¹æ¡ˆ


### 7.1 ç«¯åˆ°ç«¯æ¶ˆæ¯å¯é æ€§ä¿éšœ


```
å®Œæ•´çš„å¯é æ€§é“¾è·¯ï¼š

ç”Ÿäº§è€…ç«¯          RabbitMQç«¯          æ¶ˆè´¹è€…ç«¯
   â†“                 â†“                 â†“
[å‘é€ç¡®è®¤]      [æ¶ˆæ¯æŒä¹…åŒ–]        [æ‰‹åŠ¨ACK]
[é‡è¯•æœºåˆ¶]      [é›†ç¾¤é•œåƒ]          [å¼‚å¸¸å¤„ç†]
[ç½‘ç»œæ¢å¤]      [ç›‘æ§å‘Šè­¦]          [ä¼˜é›…å…³é—­]
```

### 7.2 ç»¼åˆé…ç½®ç¤ºä¾‹


```java
// âœ… å®Œæ•´çš„å¯é æ€§é…ç½®
@Configuration
@EnableRabbit
public class ReliableRabbitConfig {
    
    @Bean
    public ConnectionFactory connectionFactory() {
        CachingConnectionFactory factory = new CachingConnectionFactory("localhost");
        
        // è¿æ¥å¯é æ€§é…ç½®
        factory.getRabbitConnectionFactory().setAutomaticRecoveryEnabled(true);
        factory.getRabbitConnectionFactory().setNetworkRecoveryInterval(5000);
        factory.getRabbitConnectionFactory().setRequestedHeartbeat(Duration.ofSeconds(30));
        
        return factory;
    }
    
    @Bean
    public RabbitTemplate rabbitTemplate(ConnectionFactory connectionFactory) {
        RabbitTemplate template = new RabbitTemplate(connectionFactory);
        
        // å‘é€ç¡®è®¤
        template.setConfirmCallback((correlationData, ack, cause) -> {
            if (!ack) {
                log.error("æ¶ˆæ¯å‘é€å¤±è´¥ï¼š{}ï¼ŒåŸå› ï¼š{}", correlationData, cause);
                // å¯ä»¥å®ç°é‡å‘é€»è¾‘
            }
        });
        
        // æ¶ˆæ¯æ— æ³•è·¯ç”±æ—¶çš„å›è°ƒ
        template.setReturnsCallback(returnedMessage -> {
            log.error("æ¶ˆæ¯æ— æ³•è·¯ç”±ï¼š{}", returnedMessage);
            // å¯ä»¥å®ç°è¡¥å¿é€»è¾‘
        });
        
        // å¼€å¯å¼ºåˆ¶è¿”å›
        template.setMandatory(true);
        
        return template;
    }
    
    @Bean
    public Queue reliableQueue() {
        return QueueBuilder.durable("reliable.queue")
            .withArgument("x-message-ttl", 60000)  // æ¶ˆæ¯TTL
            .withArgument("x-dead-letter-exchange", "dlx.exchange")  // æ­»ä¿¡äº¤æ¢æœº
            .build();
    }
    
    @Bean
    public DirectExchange reliableExchange() {
        return ExchangeBuilder.directExchange("reliable.exchange")
            .durable(true)
            .build();
    }
}
```

### 7.3 æ¶ˆæ¯é‡è¯•ç­–ç•¥


```java
// âœ… æ™ºèƒ½é‡è¯•æœºåˆ¶
@Component
public class MessageRetryHandler {
    
    private final RedisTemplate<String, String> redisTemplate;
    private final RabbitTemplate rabbitTemplate;
    
    @RabbitListener(queues = "business.queue")
    public void handleMessage(String message, 
                             @Header(AmqpHeaders.DELIVERY_TAG) long deliveryTag,
                             Channel channel) {
        
        String messageId = extractMessageId(message);
        int retryCount = getRetryCount(messageId);
        
        try {
            processBusinessLogic(message);
            
            // å¤„ç†æˆåŠŸï¼Œæ¸…é™¤é‡è¯•è®¡æ•°
            clearRetryCount(messageId);
            channel.basicAck(deliveryTag, false);
            
        } catch (Exception e) {
            if (retryCount < 3) {  // æœ€å¤šé‡è¯•3æ¬¡
                // å¢åŠ é‡è¯•è®¡æ•°
                incrementRetryCount(messageId);
                
                // å»¶è¿Ÿé‡æ–°å…¥é˜Ÿ
                try {
                    Thread.sleep(1000 * (retryCount + 1));  // æŒ‡æ•°é€€é¿
                    channel.basicNack(deliveryTag, false, true);
                } catch (Exception ex) {
                    log.error("é‡è¯•å¤±è´¥", ex);
                }
                
            } else {
                // è¶…è¿‡é‡è¯•æ¬¡æ•°ï¼Œå‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—
                sendToDeadLetterQueue(message, e);
                channel.basicAck(deliveryTag, false);  // ç¡®è®¤æ¶ˆæ¯ï¼Œé¿å…æ— é™å¾ªç¯
            }
        }
    }
    
    private int getRetryCount(String messageId) {
        String count = redisTemplate.opsForValue().get("retry:" + messageId);
        return count == null ? 0 : Integer.parseInt(count);
    }
    
    private void incrementRetryCount(String messageId) {
        redisTemplate.opsForValue().increment("retry:" + messageId);
        redisTemplate.expire("retry:" + messageId, Duration.ofHours(1));
    }
}
```

---

## 8. ğŸ“Š æœ€ä½³å®è·µä¸ç›‘æ§


### 8.1 æ¶ˆæ¯å¯é æ€§æ£€æŸ¥æ¸…å•


**å‘é€å‰æ£€æŸ¥**ï¼š
- âœ… äº¤æ¢æœºæ˜¯å¦å­˜åœ¨ä¸”é…ç½®æ­£ç¡®
- âœ… è·¯ç”±é”®æ˜¯å¦æ­£ç¡®
- âœ… æ¶ˆæ¯æ˜¯å¦è®¾ç½®æŒä¹…åŒ–
- âœ… æ˜¯å¦å¼€å¯å‘é€ç¡®è®¤

**RabbitMQé…ç½®æ£€æŸ¥**ï¼š
- âœ… é˜Ÿåˆ—æ˜¯å¦æŒä¹…åŒ–
- âœ… äº¤æ¢æœºæ˜¯å¦æŒä¹…åŒ–  
- âœ… æ˜¯å¦é…ç½®é›†ç¾¤é•œåƒ
- âœ… å†…å­˜å’Œç£ç›˜é˜ˆå€¼æ˜¯å¦åˆç†

**æ¶ˆè´¹ç«¯æ£€æŸ¥**ï¼š
- âœ… æ˜¯å¦ä½¿ç”¨æ‰‹åŠ¨ACK
- âœ… å¼‚å¸¸å¤„ç†æ˜¯å¦å®Œå–„
- âœ… æ˜¯å¦é…ç½®é‡è¯•æœºåˆ¶
- âœ… æ˜¯å¦æœ‰æ­»ä¿¡é˜Ÿåˆ—å…œåº•

### 8.2 ç›‘æ§æŒ‡æ ‡


**å…³é”®ç›‘æ§é¡¹**ï¼š

| æŒ‡æ ‡ | **é˜ˆå€¼å»ºè®®** | **è¯´æ˜** |
|------|-------------|---------|
| `æ¶ˆæ¯å‘é€æˆåŠŸç‡` | `> 99.9%` | `ç›‘æ§ç”Ÿäº§è€…å‘é€ç¡®è®¤ç‡` |
| `æ¶ˆæ¯æ¶ˆè´¹æˆåŠŸç‡` | `> 99.5%` | `ç›‘æ§æ¶ˆè´¹è€…å¤„ç†æˆåŠŸç‡` |
| `é˜Ÿåˆ—ç§¯å‹æ•°é‡` | `< 1000æ¡` | `é˜²æ­¢æ¶ˆæ¯å †ç§¯` |
| `è¿æ¥æ•°` | `< 80%æœ€å¤§å€¼` | `ç›‘æ§è¿æ¥æ± ä½¿ç”¨æƒ…å†µ` |
| `å†…å­˜ä½¿ç”¨ç‡` | `< 70%` | `é˜²æ­¢å†…å­˜ä¸è¶³å¯¼è‡´ä¸¢æ¶ˆæ¯` |

**ç›‘æ§å®ç°**ï¼š

```java
@Component
public class RabbitMetrics {
    
    private final MeterRegistry meterRegistry;
    private final RabbitAdmin rabbitAdmin;
    
    @Scheduled(fixedRate = 30000)  // 30ç§’æ£€æŸ¥ä¸€æ¬¡
    public void collectMetrics() {
        
        // æ£€æŸ¥é˜Ÿåˆ—æ¶ˆæ¯æ•°é‡
        Properties queueProperties = rabbitAdmin.getQueueProperties("important.queue");
        if (queueProperties != null) {
            int messageCount = (Integer) queueProperties.get("QUEUE_MESSAGE_COUNT");
            
            // è®°å½•æŒ‡æ ‡
            meterRegistry.gauge("rabbitmq.queue.message.count", messageCount);
            
            // å‘Šè­¦æ£€æŸ¥
            if (messageCount > 1000) {
                log.warn("é˜Ÿåˆ—æ¶ˆæ¯ç§¯å‹ï¼Œå½“å‰æ•°é‡ï¼š{}", messageCount);
                // å¯ä»¥å‘é€å‘Šè­¦é€šçŸ¥
            }
        }
    }
}
```

### 8.3 æ•…éšœæ¢å¤æµç¨‹


```
æ•…éšœå‘ç° â†’ å¿«é€Ÿæ­¢æŸ â†’ æ ¹å› åˆ†æ â†’ æ¢å¤æ•°æ® â†’ é¢„é˜²æ”¹è¿›

è¯¦ç»†æ­¥éª¤ï¼š
1. ã€å‘ç°é˜¶æ®µã€‘ç›‘æ§å‘Šè­¦ â†’ ç¡®è®¤å½±å“èŒƒå›´
2. ã€æ­¢æŸé˜¶æ®µã€‘åœæ­¢é—®é¢˜æœåŠ¡ â†’ åˆ‡æ¢å¤‡ç”¨æ–¹æ¡ˆ  
3. ã€åˆ†æé˜¶æ®µã€‘æŸ¥çœ‹æ—¥å¿— â†’ å®šä½æ ¹æœ¬åŸå› 
4. ã€æ¢å¤é˜¶æ®µã€‘ä¿®å¤é—®é¢˜ â†’ é‡æ–°å¤„ç†ä¸¢å¤±æ¶ˆæ¯
5. ã€æ”¹è¿›é˜¶æ®µã€‘æ›´æ–°ç›‘æ§ â†’ å®Œå–„å®¹é”™æœºåˆ¶
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„é˜²ä¸¢å¤±è¦ç‚¹


```
ğŸ”¸ ç”Ÿäº§è€…ç«¯ï¼šå¼€å¯å‘é€ç¡®è®¤ï¼Œå®ç°é‡è¯•æœºåˆ¶ï¼Œæ£€æŸ¥äº¤æ¢æœºå­˜åœ¨æ€§
ğŸ”¸ RabbitMQç«¯ï¼šæ¶ˆæ¯æŒä¹…åŒ–ï¼Œé˜Ÿåˆ—æŒä¹…åŒ–ï¼Œé›†ç¾¤é•œåƒé…ç½®
ğŸ”¸ æ¶ˆè´¹è€…ç«¯ï¼šä½¿ç”¨æ‰‹åŠ¨ACKï¼Œå®Œå–„å¼‚å¸¸å¤„ç†ï¼Œå®ç°ä¼˜é›…å…³é—­
ğŸ”¸ ç½‘ç»œå±‚é¢ï¼šè¿æ¥æ¢å¤ï¼Œå¿ƒè·³æ£€æµ‹ï¼Œè¶…æ—¶è®¾ç½®
ğŸ”¸ ç›‘æ§å‘Šè­¦ï¼šå…³é”®æŒ‡æ ‡ç›‘æ§ï¼Œæ•…éšœå¿«é€Ÿå‘ç°ï¼Œæ¢å¤æµç¨‹
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ æ¶ˆæ¯ä¸¢å¤±çš„æœ¬è´¨**
```
æ ¸å¿ƒç†è§£ï¼š
- æ¶ˆæ¯ä¼ é€’æ˜¯ä¸€ä¸ªå¤šç¯èŠ‚è¿‡ç¨‹ï¼Œä»»ä½•ç¯èŠ‚å‡ºé—®é¢˜éƒ½å¯èƒ½ä¸¢å¤±
- é»˜è®¤é…ç½®å¾€å¾€ä¼˜å…ˆè€ƒè™‘æ€§èƒ½è€Œéå¯é æ€§
- å¯é æ€§éœ€è¦åœ¨æ€§èƒ½å’Œä¸€è‡´æ€§ä¹‹é—´åšæƒè¡¡
```

**ğŸ”¹ å¯é æ€§çš„ä»£ä»·**
```
æƒè¡¡è€ƒè™‘ï¼š
- æŒä¹…åŒ–ä¼šé™ä½æ€§èƒ½ï¼Œä½†ä¿è¯æ•°æ®å®‰å…¨
- ç¡®è®¤æœºåˆ¶å¢åŠ å»¶è¿Ÿï¼Œä½†é¿å…æ¶ˆæ¯ä¸¢å¤±  
- é‡è¯•æœºåˆ¶å¯èƒ½é‡å¤å¤„ç†ï¼Œä½†ä¿è¯æœ€ç»ˆæˆåŠŸ
- ç›‘æ§å¢åŠ å¤æ‚åº¦ï¼Œä½†ä¾¿äºåŠæ—¶å‘ç°é—®é¢˜
```

**ğŸ”¹ é€‰æ‹©åˆé€‚çš„ç­–ç•¥**
```
ä¸šåŠ¡æ•æ„Ÿåº¦åˆ†çº§ï¼š
ğŸ”´ å…³é”®ä¸šåŠ¡ï¼šæ”¯ä»˜ã€è®¢å• â†’ æœ€é«˜å¯é æ€§ï¼Œå¯æ¥å—æ€§èƒ½æŸå¤±
ğŸŸ¡ é‡è¦ä¸šåŠ¡ï¼šé€šçŸ¥ã€æ—¥å¿— â†’ å¹³è¡¡å¯é æ€§å’Œæ€§èƒ½
ğŸŸ¢ ä¸€èˆ¬ä¸šåŠ¡ï¼šç»Ÿè®¡ã€æ¨è â†’ ä¼˜å…ˆæ€§èƒ½ï¼Œé€‚åº¦å¯é æ€§
```

### 9.3 å®é™…åº”ç”¨ä»·å€¼


**ç”µå•†ç³»ç»Ÿåº”ç”¨**ï¼š
- **è®¢å•å¤„ç†**ï¼šç¡®ä¿è®¢å•æ¶ˆæ¯ä¸ä¸¢å¤±ï¼Œé¿å…æ¼å•
- **æ”¯ä»˜å›è°ƒ**ï¼šä¿è¯æ”¯ä»˜çŠ¶æ€æ­£ç¡®æ›´æ–°
- **åº“å­˜æ‰£å‡**ï¼šé˜²æ­¢è¶…å–å’Œåº“å­˜ä¸å‡†
- **ç‰©æµè·Ÿè¸ª**ï¼šç¡®ä¿çŠ¶æ€æ›´æ–°åŠæ—¶å‡†ç¡®

**é‡‘èç³»ç»Ÿåº”ç”¨**ï¼š
- **äº¤æ˜“è®°å½•**ï¼šç¡®ä¿æ¯ç¬”äº¤æ˜“éƒ½æœ‰å®Œæ•´è®°å½•
- **é£æ§è§„åˆ™**ï¼šåŠæ—¶è§¦å‘é£é™©æ£€æµ‹
- **æ¸…ç®—ç»“ç®—**ï¼šä¿è¯èµ„é‡‘æµè½¬å‡†ç¡®æ€§

**ç›‘æ§ç³»ç»Ÿåº”ç”¨**ï¼š
- **æ—¥å¿—æ”¶é›†**ï¼šé‡è¦æ—¥å¿—ä¸èƒ½ä¸¢å¤±
- **æŒ‡æ ‡é‡‡é›†**ï¼šç¡®ä¿ç›‘æ§æ•°æ®å®Œæ•´
- **å‘Šè­¦é€šçŸ¥**ï¼šå…³é”®å‘Šè­¦å¿…é¡»é€è¾¾

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- ä¸‰ç«¯é˜²æŠ¤è¦åšå…¨ï¼Œç”Ÿäº§å­˜å‚¨æ¶ˆè´¹ç«¯
- ç¡®è®¤æŒä¹…æ‰‹åŠ¨ACKï¼Œé‡è¯•ç›‘æ§ä¸èƒ½ç¼º  
- ç½‘ç»œå¼‚å¸¸è¦è€ƒè™‘ï¼Œæ¢å¤æœºåˆ¶é¡»å»ºç«‹
- ä¸šåŠ¡é‡è¦åˆ†ç­‰çº§ï¼Œå¯é æ€§èƒ½è¦æƒè¡¡