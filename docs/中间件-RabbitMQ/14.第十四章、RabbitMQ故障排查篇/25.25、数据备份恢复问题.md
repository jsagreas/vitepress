---
title: 25ã€æ•°æ®å¤‡ä»½æ¢å¤é—®é¢˜
---
## ğŸ“š ç›®å½•

1. [æ•°æ®å¤‡ä»½æ¢å¤åŸºç¡€æ¦‚å¿µ](#1-æ•°æ®å¤‡ä»½æ¢å¤åŸºç¡€æ¦‚å¿µ)
2. [å¤‡ä»½ç­–ç•¥è®¾è®¡ä¸å®æ–½](#2-å¤‡ä»½ç­–ç•¥è®¾è®¡ä¸å®æ–½)
3. [æ•°æ®æ¢å¤æ“ä½œå®æˆ˜](#3-æ•°æ®æ¢å¤æ“ä½œå®æˆ˜)
4. [é«˜çº§å¤‡ä»½æ¢å¤æŠ€æœ¯](#4-é«˜çº§å¤‡ä»½æ¢å¤æŠ€æœ¯)
5. [æ•…éšœæ’æŸ¥ä¸é—®é¢˜è§£å†³](#5-æ•…éšœæ’æŸ¥ä¸é—®é¢˜è§£å†³)
6. [æœ€ä½³å®è·µä¸è¿ç»´å»ºè®®](#6-æœ€ä½³å®è·µä¸è¿ç»´å»ºè®®)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ’¾ æ•°æ®å¤‡ä»½æ¢å¤åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯RabbitMQæ•°æ®å¤‡ä»½


**ğŸ’¡ é€šä¿—ç†è§£**
æƒ³è±¡ä½ çš„æ‰‹æœºé‡Œæœ‰é‡è¦ç…§ç‰‡ï¼Œä½ ä¼šå®šæœŸå¤‡ä»½åˆ°äº‘ç›˜ã€‚RabbitMQå¤‡ä»½å°±æ˜¯æŠŠæ¶ˆæ¯é˜Ÿåˆ—çš„"é‡è¦æ•°æ®"ä¿å­˜èµ·æ¥ï¼Œé˜²æ­¢æ„å¤–ä¸¢å¤±ã€‚

**ğŸ”¸ RabbitMQéœ€è¦å¤‡ä»½çš„æ•°æ®**
```
æ ¸å¿ƒæ•°æ®ç±»å‹ï¼š

ğŸ“‹ å…ƒæ•°æ®ï¼ˆMetadataï¼‰
â€¢ é˜Ÿåˆ—å®šä¹‰ï¼šé˜Ÿåˆ—åç§°ã€å±æ€§ã€å‚æ•°
â€¢ äº¤æ¢å™¨é…ç½®ï¼šäº¤æ¢å™¨ç±»å‹ã€è·¯ç”±è§„åˆ™
â€¢ ç»‘å®šå…³ç³»ï¼šé˜Ÿåˆ—ä¸äº¤æ¢å™¨çš„è¿æ¥å…³ç³»
â€¢ ç”¨æˆ·æƒé™ï¼šç”¨æˆ·è´¦å·ã€è§’è‰²ã€è®¿é—®æƒé™
â€¢ è™šæ‹Ÿä¸»æœºï¼švhosté…ç½®ä¿¡æ¯

ğŸ’Œ æ¶ˆæ¯æ•°æ®ï¼ˆMessage Dataï¼‰
â€¢ æŒä¹…åŒ–æ¶ˆæ¯ï¼šå­˜å‚¨åœ¨ç£ç›˜ä¸Šçš„æ¶ˆæ¯å†…å®¹
â€¢ æ¶ˆæ¯å±æ€§ï¼šä¼˜å…ˆçº§ã€è¿‡æœŸæ—¶é—´ç­‰
â€¢ æ¶ˆæ¯çŠ¶æ€ï¼šå·²ç¡®è®¤ã€æœªç¡®è®¤çŠ¶æ€

âš™ï¸ é…ç½®æ•°æ®ï¼ˆConfigurationï¼‰
â€¢ é›†ç¾¤é…ç½®ï¼šèŠ‚ç‚¹ä¿¡æ¯ã€é›†ç¾¤çŠ¶æ€
â€¢ æ’ä»¶é…ç½®ï¼šå¯ç”¨çš„æ’ä»¶åŠå…¶è®¾ç½®
â€¢ ç­–ç•¥é…ç½®ï¼šé˜Ÿåˆ—ç­–ç•¥ã€äº¤æ¢å™¨ç­–ç•¥
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦å¤‡ä»½æ¢å¤


**ğŸš¨ å¸¸è§æ•°æ®ä¸¢å¤±åœºæ™¯**
```
ç¡¬ä»¶æ•…éšœï¼š
æœåŠ¡å™¨ç¡¬ç›˜æŸå â†’ æ•°æ®å…¨éƒ¨ä¸¢å¤±
å†…å­˜æ•…éšœ â†’ æœªæŒä¹…åŒ–æ¶ˆæ¯ä¸¢å¤±

è½¯ä»¶é—®é¢˜ï¼š
RabbitMQå´©æºƒ â†’ å†…å­˜æ•°æ®ä¸¢å¤±
é…ç½®é”™è¯¯ â†’ é˜Ÿåˆ—è¢«è¯¯åˆ é™¤

äººä¸ºé”™è¯¯ï¼š
ç®¡ç†å‘˜è¯¯æ“ä½œ â†’ åˆ é™¤é‡è¦é˜Ÿåˆ—
é…ç½®é”™è¯¯ â†’ æ¶ˆæ¯è·¯ç”±å¤±è´¥

ç¯å¢ƒé—®é¢˜ï¼š
æœºæˆ¿æ–­ç”µ â†’ æœåŠ¡å™¨å¼‚å¸¸å…³æœº
ç½‘ç»œæ•…éšœ â†’ é›†ç¾¤èŠ‚ç‚¹å¤±è”
```

**âœ… å¤‡ä»½çš„ä»·å€¼**
- **æ•°æ®å®‰å…¨**ï¼šé˜²æ­¢æ„å¤–æ•°æ®ä¸¢å¤±
- **ä¸šåŠ¡è¿ç»­æ€§**ï¼šå¿«é€Ÿæ¢å¤æœåŠ¡
- **åˆè§„è¦æ±‚**ï¼šæ»¡è¶³æ•°æ®ä¿æŠ¤è§„å®š
- **æ•…éšœæ¢å¤**ï¼šç¾éš¾åå¿«é€Ÿé‡å»º

### 1.3 RabbitMQå­˜å‚¨æœºåˆ¶


**ğŸ“ æ•°æ®å­˜å‚¨ä½ç½®**
```
Linuxç³»ç»Ÿé»˜è®¤è·¯å¾„ï¼š
/var/lib/rabbitmq/mnesia/

ç›®å½•ç»“æ„ï¼š
rabbitmq@ä¸»æœºå/
â”œâ”€â”€ FALLBACK.BUP          # å›é€€å¤‡ä»½æ–‡ä»¶
â”œâ”€â”€ cluster_nodes.config  # é›†ç¾¤èŠ‚ç‚¹é…ç½®
â”œâ”€â”€ nodes_running_at_shutdown # å…³æœºæ—¶è¿è¡Œçš„èŠ‚ç‚¹
â”œâ”€â”€ rabbit@ä¸»æœºå/
â”‚   â”œâ”€â”€ DECISION_TAB.LOG  # å†³ç­–è¡¨æ—¥å¿—
â”‚   â”œâ”€â”€ LATEST.LOG        # æœ€æ–°æ—¥å¿—
â”‚   â”œâ”€â”€ LOCK             # é”æ–‡ä»¶
â”‚   â”œâ”€â”€ schema.DAT       # æ¨¡å¼æ•°æ®
â”‚   â”œâ”€â”€ msg_store_persistent/  # æŒä¹…åŒ–æ¶ˆæ¯å­˜å‚¨
â”‚   â””â”€â”€ msg_store_transient/   # ä¸´æ—¶æ¶ˆæ¯å­˜å‚¨
```

**ğŸ” æ•°æ®æ–‡ä»¶è§£æ**
```
schema.DATï¼š
â€¢ å­˜å‚¨é˜Ÿåˆ—ã€äº¤æ¢å™¨ã€ç»‘å®šå…³ç³»ç­‰å…ƒæ•°æ®
â€¢ äºŒè¿›åˆ¶æ ¼å¼ï¼ŒåŒ…å«å®Œæ•´çš„æ•°æ®åº“æ¨¡å¼

msg_store_persistent/ï¼š
â€¢ æŒä¹…åŒ–æ¶ˆæ¯çš„å®é™…å­˜å‚¨ä½ç½®
â€¢ æŒ‰æ–‡ä»¶å¤§å°åˆ†ç‰‡å­˜å‚¨ï¼ˆé»˜è®¤16MBä¸€ä¸ªæ–‡ä»¶ï¼‰

LATEST.LOGï¼š
â€¢ Mnesiaæ•°æ®åº“çš„äº‹åŠ¡æ—¥å¿—
â€¢ è®°å½•æœ€è¿‘çš„æ•°æ®å˜æ›´æ“ä½œ
```

---

## 2. ğŸ“‹ å¤‡ä»½ç­–ç•¥è®¾è®¡ä¸å®æ–½


### 2.1 å¤‡ä»½ç­–ç•¥ç±»å‹


**ğŸ”¸ å…¨é‡å¤‡ä»½ vs å¢é‡å¤‡ä»½**

```
å…¨é‡å¤‡ä»½ï¼ˆFull Backupï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®Œæ•´çš„RabbitMQæ•°æ®å¿«ç…§          â”‚
â”‚  â”œâ”€â”€ æ‰€æœ‰é˜Ÿåˆ—å’Œäº¤æ¢å™¨           â”‚
â”‚  â”œâ”€â”€ å®Œæ•´çš„æ¶ˆæ¯æ•°æ®             â”‚
â”‚  â”œâ”€â”€ ç”¨æˆ·æƒé™é…ç½®               â”‚
â”‚  â””â”€â”€ é›†ç¾¤çŠ¶æ€ä¿¡æ¯               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜ç‚¹ï¼š
â€¢ æ¢å¤ç®€å•ï¼Œä¸€æ­¥åˆ°ä½
â€¢ æ•°æ®å®Œæ•´æ€§å¥½
â€¢ ä¸ä¾èµ–å†å²å¤‡ä»½

ç¼ºç‚¹ï¼š
â€¢ å¤‡ä»½æ—¶é—´é•¿
â€¢ å ç”¨å­˜å‚¨ç©ºé—´å¤§
â€¢ å¯¹ç³»ç»Ÿæ€§èƒ½å½±å“å¤§

å¢é‡å¤‡ä»½ï¼ˆIncremental Backupï¼‰ï¼š
ç¬¬1å¤©: [å…¨é‡å¤‡ä»½]
ç¬¬2å¤©: [å…¨é‡] + [å¢é‡1]
ç¬¬3å¤©: [å…¨é‡] + [å¢é‡1] + [å¢é‡2]

ä¼˜ç‚¹ï¼š
â€¢ å¤‡ä»½é€Ÿåº¦å¿«
â€¢ å­˜å‚¨ç©ºé—´çœ
â€¢ å¯¹ç³»ç»Ÿå½±å“å°

ç¼ºç‚¹ï¼š
â€¢ æ¢å¤å¤æ‚ï¼Œéœ€è¦å¤šä¸ªæ–‡ä»¶
â€¢ ä¾èµ–å¤‡ä»½é“¾å®Œæ•´æ€§
```

### 2.2 å®šä¹‰å¤‡ä»½ç­–ç•¥


**ğŸ“… å¤‡ä»½é¢‘ç‡è®¾è®¡**
```java
// å¤‡ä»½ç­–ç•¥é…ç½®ç¤ºä¾‹
public class BackupStrategy {
    
    // é«˜é¢‘ä¸šåŠ¡åœºæ™¯
    public static final String HIGH_FREQUENCY = """
        æ¯æ—¥å…¨é‡å¤‡ä»½ï¼šå‡Œæ™¨2:00æ‰§è¡Œ
        æ¯4å°æ—¶å¢é‡å¤‡ä»½ï¼š6:00, 10:00, 14:00, 18:00, 22:00
        
        é€‚ç”¨åœºæ™¯ï¼š
        â€¢ ç”µå•†è®¢å•ç³»ç»Ÿ
        â€¢ é‡‘èäº¤æ˜“ç³»ç»Ÿ
        â€¢ å®æ—¶æ•°æ®å¤„ç†
        """;
    
    // ä¸­é¢‘ä¸šåŠ¡åœºæ™¯
    public static final String MEDIUM_FREQUENCY = """
        æ¯å‘¨å…¨é‡å¤‡ä»½ï¼šå‘¨æ—¥å‡Œæ™¨æ‰§è¡Œ
        æ¯æ—¥å¢é‡å¤‡ä»½ï¼šå‡Œæ™¨3:00æ‰§è¡Œ
        
        é€‚ç”¨åœºæ™¯ï¼š
        â€¢ ä¼ä¸šå†…éƒ¨ç³»ç»Ÿ
        â€¢ æ—¥å¿—æ”¶é›†ç³»ç»Ÿ
        â€¢ æ™®é€šWebåº”ç”¨
        """;
    
    // ä½é¢‘ä¸šåŠ¡åœºæ™¯
    public static final String LOW_FREQUENCY = """
        æ¯æœˆå…¨é‡å¤‡ä»½ï¼šæœˆåˆæ‰§è¡Œ
        æ¯å‘¨å¢é‡å¤‡ä»½ï¼šå‘¨æ—¥æ‰§è¡Œ
        
        é€‚ç”¨åœºæ™¯ï¼š
        â€¢ æµ‹è¯•ç¯å¢ƒ
        â€¢ å¼€å‘ç¯å¢ƒ
        â€¢ å½’æ¡£ç³»ç»Ÿ
        """;
}
```

### 2.3 å¤‡ä»½è„šæœ¬å®ç°


**ğŸ”§ åŸºç¡€å¤‡ä»½è„šæœ¬**
```bash
#!/bin/bash
# RabbitMQè‡ªåŠ¨å¤‡ä»½è„šæœ¬

# é…ç½®å˜é‡
BACKUP_DIR="/opt/rabbitmq-backup"
DATE=$(date +%Y%m%d_%H%M%S)
RABBITMQ_DATA_DIR="/var/lib/rabbitmq"
LOG_FILE="/var/log/rabbitmq-backup.log"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR/$DATE

# è®°å½•å¼€å§‹æ—¶é—´
echo "[$(date)] å¼€å§‹å¤‡ä»½RabbitMQæ•°æ®" >> $LOG_FILE

# 1. åœæ­¢RabbitMQæœåŠ¡ï¼ˆå¯é€‰ï¼Œçƒ­å¤‡ä»½å¯è·³è¿‡ï¼‰
# systemctl stop rabbitmq-server

# 2. å¯¼å‡ºé…ç½®å’Œå®šä¹‰
rabbitmqctl export_definitions $BACKUP_DIR/$DATE/definitions.json

# 3. å¤‡ä»½æ•°æ®æ–‡ä»¶
tar -czf $BACKUP_DIR/$DATE/mnesia_data.tar.gz \
    -C $RABBITMQ_DATA_DIR mnesia/

# 4. å¤‡ä»½é…ç½®æ–‡ä»¶
cp /etc/rabbitmq/rabbitmq.conf $BACKUP_DIR/$DATE/
cp -r /etc/rabbitmq/conf.d/ $BACKUP_DIR/$DATE/ 2>/dev/null || true

# 5. åˆ›å»ºå¤‡ä»½ä¿¡æ¯æ–‡ä»¶
cat > $BACKUP_DIR/$DATE/backup_info.txt << EOF
å¤‡ä»½æ—¶é—´: $(date)
RabbitMQç‰ˆæœ¬: $(rabbitmqctl version)
é›†ç¾¤çŠ¶æ€: $(rabbitmqctl cluster_status)
èŠ‚ç‚¹çŠ¶æ€: $(rabbitmqctl node_health_check)
EOF

# 6. é‡å¯æœåŠ¡ï¼ˆå¦‚æœä¹‹å‰åœæ­¢äº†ï¼‰
# systemctl start rabbitmq-server

# 7. éªŒè¯å¤‡ä»½å®Œæ•´æ€§
if [ -f "$BACKUP_DIR/$DATE/definitions.json" ] && \
   [ -f "$BACKUP_DIR/$DATE/mnesia_data.tar.gz" ]; then
    echo "[$(date)] å¤‡ä»½æˆåŠŸå®Œæˆ: $BACKUP_DIR/$DATE" >> $LOG_FILE
else
    echo "[$(date)] å¤‡ä»½å¤±è´¥ï¼" >> $LOG_FILE
    exit 1
fi

# 8. æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™7å¤©ï¼‰
find $BACKUP_DIR -type d -mtime +7 -exec rm -rf {} \;

echo "[$(date)] å¤‡ä»½ä»»åŠ¡å®Œæˆ" >> $LOG_FILE
```

### 2.4 å¤‡ä»½æ–‡ä»¶å®Œæ•´æ€§æ£€æŸ¥


**ğŸ” å®Œæ•´æ€§éªŒè¯æ–¹æ³•**

```bash
#!/bin/bash
# å¤‡ä»½å®Œæ•´æ€§æ£€æŸ¥è„šæœ¬

check_backup_integrity() {
    local backup_path=$1
    local errors=0
    
    echo "æ£€æŸ¥å¤‡ä»½: $backup_path"
    
    # æ£€æŸ¥å¿…éœ€æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    required_files=(
        "definitions.json"
        "mnesia_data.tar.gz"
        "rabbitmq.conf"
        "backup_info.txt"
    )
    
    for file in "${required_files[@]}"; do
        if [ ! -f "$backup_path/$file" ]; then
            echo "âŒ ç¼ºå°‘æ–‡ä»¶: $file"
            ((errors++))
        else
            echo "âœ… æ–‡ä»¶å­˜åœ¨: $file"
        fi
    done
    
    # æ£€æŸ¥JSONæ–‡ä»¶æ ¼å¼
    if [ -f "$backup_path/definitions.json" ]; then
        if python3 -m json.tool "$backup_path/definitions.json" > /dev/null 2>&1; then
            echo "âœ… definitions.json æ ¼å¼æ­£ç¡®"
        else
            echo "âŒ definitions.json æ ¼å¼é”™è¯¯"
            ((errors++))
        fi
    fi
    
    # æ£€æŸ¥å‹ç¼©æ–‡ä»¶å®Œæ•´æ€§
    if [ -f "$backup_path/mnesia_data.tar.gz" ]; then
        if tar -tzf "$backup_path/mnesia_data.tar.gz" > /dev/null 2>&1; then
            echo "âœ… mnesia_data.tar.gz å®Œæ•´"
        else
            echo "âŒ mnesia_data.tar.gz æŸå"
            ((errors++))
        fi
    fi
    
    # è¿”å›æ£€æŸ¥ç»“æœ
    if [ $errors -eq 0 ]; then
        echo "ğŸ‰ å¤‡ä»½å®Œæ•´æ€§æ£€æŸ¥é€šè¿‡"
        return 0
    else
        echo "âš ï¸  å‘ç° $errors ä¸ªé—®é¢˜"
        return 1
    fi
}
```

---

## 3. ğŸ”„ æ•°æ®æ¢å¤æ“ä½œå®æˆ˜


### 3.1 æ¢å¤å‰çš„å‡†å¤‡å·¥ä½œ


**âš ï¸ æ¢å¤å‰æ£€æŸ¥æ¸…å•**
```
ç¯å¢ƒå‡†å¤‡ï¼š
â˜ ç¡®è®¤RabbitMQç‰ˆæœ¬å…¼å®¹æ€§
â˜ æ£€æŸ¥ç£ç›˜ç©ºé—´æ˜¯å¦å……è¶³
â˜ å¤‡ä»½å½“å‰æ•°æ®ï¼ˆä»¥é˜²æ¢å¤å¤±è´¥ï¼‰
â˜ é€šçŸ¥ç›¸å…³ä¸šåŠ¡ç³»ç»Ÿåœæ­¢æ¶ˆæ¯å‘é€
â˜ ç¡®è®¤æ¢å¤æ—¶é—´çª—å£

æƒé™æ£€æŸ¥ï¼š
â˜ ç¡®è®¤æ“ä½œè´¦å·æœ‰è¶³å¤Ÿæƒé™
â˜ æ£€æŸ¥æ–‡ä»¶ç›®å½•è®¿é—®æƒé™
â˜ éªŒè¯RabbitMQæœåŠ¡æ§åˆ¶æƒé™

ç½‘ç»œæ£€æŸ¥ï¼š
â˜ ç¡®è®¤é›†ç¾¤ç½‘ç»œè¿é€šæ€§
â˜ æ£€æŸ¥é˜²ç«å¢™é…ç½®
â˜ éªŒè¯åŸŸåè§£ææ­£ç¡®æ€§
```

### 3.2 å®Œæ•´æ¢å¤æµç¨‹


**ğŸ”§ æ ‡å‡†æ¢å¤æ­¥éª¤**

```bash
#!/bin/bash
# RabbitMQæ•°æ®æ¢å¤è„šæœ¬

restore_rabbitmq() {
    local backup_path=$1
    local restore_log="/var/log/rabbitmq-restore.log"
    
    echo "[$(date)] å¼€å§‹æ¢å¤RabbitMQæ•°æ®" >> $restore_log
    
    # æ­¥éª¤1: åœæ­¢RabbitMQæœåŠ¡
    echo "åœæ­¢RabbitMQæœåŠ¡..."
    systemctl stop rabbitmq-server
    sleep 5
    
    # æ­¥éª¤2: å¤‡ä»½å½“å‰æ•°æ®ï¼ˆä»¥é˜²ä¸‡ä¸€ï¼‰
    echo "å¤‡ä»½å½“å‰æ•°æ®..."
    mv /var/lib/rabbitmq/mnesia /var/lib/rabbitmq/mnesia.backup.$(date +%s)
    
    # æ­¥éª¤3: æ¢å¤æ•°æ®æ–‡ä»¶
    echo "æ¢å¤æ•°æ®æ–‡ä»¶..."
    cd /var/lib/rabbitmq
    tar -xzf $backup_path/mnesia_data.tar.gz
    chown -R rabbitmq:rabbitmq mnesia/
    
    # æ­¥éª¤4: æ¢å¤é…ç½®æ–‡ä»¶
    echo "æ¢å¤é…ç½®æ–‡ä»¶..."
    cp $backup_path/rabbitmq.conf /etc/rabbitmq/
    if [ -d "$backup_path/conf.d" ]; then
        cp -r $backup_path/conf.d/* /etc/rabbitmq/conf.d/
    fi
    
    # æ­¥éª¤5: å¯åŠ¨RabbitMQæœåŠ¡
    echo "å¯åŠ¨RabbitMQæœåŠ¡..."
    systemctl start rabbitmq-server
    
    # æ­¥éª¤6: ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨
    echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
    sleep 30
    
    # æ­¥éª¤7: æ¢å¤å®šä¹‰ï¼ˆå¦‚æœéœ€è¦ï¼‰
    if [ -f "$backup_path/definitions.json" ]; then
        echo "æ¢å¤é˜Ÿåˆ—å’Œäº¤æ¢å™¨å®šä¹‰..."
        rabbitmqctl import_definitions $backup_path/definitions.json
    fi
    
    # æ­¥éª¤8: éªŒè¯æ¢å¤ç»“æœ
    echo "éªŒè¯æ¢å¤ç»“æœ..."
    if rabbitmqctl node_health_check; then
        echo "[$(date)] æ¢å¤æˆåŠŸå®Œæˆ" >> $restore_log
        echo "âœ… RabbitMQæ¢å¤æˆåŠŸ"
    else
        echo "[$(date)] æ¢å¤å¤±è´¥" >> $restore_log
        echo "âŒ RabbitMQæ¢å¤å¤±è´¥"
        return 1
    fi
}
```

### 3.3 æ¢å¤æ•°æ®éªŒè¯


**âœ… éªŒè¯æ­¥éª¤è¯¦è§£**

```bash
# æ•°æ®æ¢å¤éªŒè¯è„šæœ¬
verify_restore() {
    echo "=== RabbitMQæ¢å¤éªŒè¯ ==="
    
    # 1. æ£€æŸ¥æœåŠ¡çŠ¶æ€
    echo "1. æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
    if systemctl is-active rabbitmq-server > /dev/null; then
        echo "âœ… RabbitMQæœåŠ¡æ­£åœ¨è¿è¡Œ"
    else
        echo "âŒ RabbitMQæœåŠ¡æœªè¿è¡Œ"
        return 1
    fi
    
    # 2. æ£€æŸ¥èŠ‚ç‚¹å¥åº·çŠ¶æ€
    echo "2. æ£€æŸ¥èŠ‚ç‚¹å¥åº·çŠ¶æ€..."
    if rabbitmqctl node_health_check > /dev/null 2>&1; then
        echo "âœ… èŠ‚ç‚¹å¥åº·çŠ¶æ€æ­£å¸¸"
    else
        echo "âŒ èŠ‚ç‚¹å¥åº·çŠ¶æ€å¼‚å¸¸"
    fi
    
    # 3. æ£€æŸ¥é›†ç¾¤çŠ¶æ€ï¼ˆå¦‚æœæ˜¯é›†ç¾¤ï¼‰
    echo "3. æ£€æŸ¥é›†ç¾¤çŠ¶æ€..."
    cluster_status=$(rabbitmqctl cluster_status)
    echo "$cluster_status"
    
    # 4. æ£€æŸ¥é˜Ÿåˆ—åˆ—è¡¨
    echo "4. æ£€æŸ¥é˜Ÿåˆ—åˆ—è¡¨..."
    queues=$(rabbitmqctl list_queues name messages)
    echo "$queues"
    
    # 5. æ£€æŸ¥äº¤æ¢å™¨
    echo "5. æ£€æŸ¥äº¤æ¢å™¨..."
    exchanges=$(rabbitmqctl list_exchanges name type)
    echo "$exchanges"
    
    # 6. æ£€æŸ¥ç”¨æˆ·æƒé™
    echo "6. æ£€æŸ¥ç”¨æˆ·æƒé™..."
    users=$(rabbitmqctl list_users)
    echo "$users"
    
    # 7. æµ‹è¯•æ¶ˆæ¯å‘é€æ¥æ”¶
    echo "7. æµ‹è¯•æ¶ˆæ¯å‘é€æ¥æ”¶..."
    test_queue="restore_test_queue"
    
    # åˆ›å»ºæµ‹è¯•é˜Ÿåˆ—
    rabbitmqadmin declare queue name=$test_queue
    
    # å‘é€æµ‹è¯•æ¶ˆæ¯
    rabbitmqadmin publish exchange="" routing_key=$test_queue payload="test message"
    
    # æ¥æ”¶æµ‹è¯•æ¶ˆæ¯
    message=$(rabbitmqadmin get queue=$test_queue)
    
    if [[ $message == *"test message"* ]]; then
        echo "âœ… æ¶ˆæ¯æ”¶å‘æµ‹è¯•é€šè¿‡"
    else
        echo "âŒ æ¶ˆæ¯æ”¶å‘æµ‹è¯•å¤±è´¥"
    fi
    
    # æ¸…ç†æµ‹è¯•é˜Ÿåˆ—
    rabbitmqadmin delete queue name=$test_queue
    
    echo "=== éªŒè¯å®Œæˆ ==="
}
```

---

## 4. ğŸš€ é«˜çº§å¤‡ä»½æ¢å¤æŠ€æœ¯


### 4.1 å¢é‡å¤‡ä»½é…ç½®


**ğŸ“ˆ å¢é‡å¤‡ä»½åŸç†**

```
å¢é‡å¤‡ä»½å·¥ä½œæœºåˆ¶ï¼š

æ—¶é—´è½´ï¼š
T0 â”€â”€â”€â”€â”€â”€ T1 â”€â”€â”€â”€â”€â”€ T2 â”€â”€â”€â”€â”€â”€ T3
â”‚         â”‚         â”‚         â”‚
å…¨é‡å¤‡ä»½   å¢é‡1     å¢é‡2     å¢é‡3

å¢é‡1: T0åˆ°T1æœŸé—´çš„å˜åŒ–
å¢é‡2: T1åˆ°T2æœŸé—´çš„å˜åŒ–
å¢é‡3: T2åˆ°T3æœŸé—´çš„å˜åŒ–

æ¢å¤æ—¶éœ€è¦ï¼š
å…¨é‡å¤‡ä»½ + å¢é‡1 + å¢é‡2 + å¢é‡3
```

**ğŸ”§ å¢é‡å¤‡ä»½å®ç°**

```bash
#!/bin/bash
# å¢é‡å¤‡ä»½è„šæœ¬

incremental_backup() {
    local backup_base_dir="/opt/rabbitmq-backup"
    local date_str=$(date +%Y%m%d_%H%M%S)
    local last_backup_file="$backup_base_dir/.last_backup_time"
    
    # è·å–ä¸Šæ¬¡å¤‡ä»½æ—¶é—´
    if [ -f "$last_backup_file" ]; then
        last_backup_time=$(cat $last_backup_file)
        echo "ä¸Šæ¬¡å¤‡ä»½æ—¶é—´: $last_backup_time"
    else
        echo "é¦–æ¬¡å¤‡ä»½ï¼Œæ‰§è¡Œå…¨é‡å¤‡ä»½"
        full_backup
        return
    fi
    
    # åˆ›å»ºå¢é‡å¤‡ä»½ç›®å½•
    inc_dir="$backup_base_dir/incremental_$date_str"
    mkdir -p $inc_dir
    
    # æŸ¥æ‰¾è‡ªä¸Šæ¬¡å¤‡ä»½ä»¥æ¥ä¿®æ”¹çš„æ–‡ä»¶
    find /var/lib/rabbitmq/mnesia -newer $last_backup_file -type f \
        -exec cp --parents {} $inc_dir \;
    
    # å¯¼å‡ºå½“å‰å®šä¹‰ï¼ˆç”¨äºå¯¹æ¯”ï¼‰
    rabbitmqctl export_definitions $inc_dir/definitions.json
    
    # åˆ›å»ºå¢é‡å¤‡ä»½ä¿¡æ¯
    cat > $inc_dir/incremental_info.txt << EOF
å¢é‡å¤‡ä»½æ—¶é—´: $(date)
åŸºäºå¤‡ä»½æ—¶é—´: $last_backup_time
å˜æ›´æ–‡ä»¶åˆ—è¡¨:
$(find /var/lib/rabbitmq/mnesia -newer $last_backup_file -type f)
EOF
    
    # æ›´æ–°æœ€åå¤‡ä»½æ—¶é—´
    date > $last_backup_file
    
    echo "å¢é‡å¤‡ä»½å®Œæˆ: $inc_dir"
}
```

### 4.2 è·¨ç‰ˆæœ¬æ•°æ®è¿ç§»


**ğŸ”„ ç‰ˆæœ¬å…¼å®¹æ€§å¤„ç†**

```
RabbitMQç‰ˆæœ¬è¿ç§»å…¼å®¹æ€§ï¼š

å‘ä¸Šå…¼å®¹ï¼ˆé€šå¸¸æ”¯æŒï¼‰ï¼š
3.6.x â†’ 3.7.x â†’ 3.8.x â†’ 3.9.x â†’ 3.10.x

è¿ç§»æ³¨æ„äº‹é¡¹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ£€æŸ¥ç‰ˆæœ¬å…¼å®¹æ€§                    â”‚
â”‚ 2. æ›´æ–°Erlangç‰ˆæœ¬                    â”‚
â”‚ 3. å¤‡ä»½å®Œæ•´æ•°æ®                      â”‚
â”‚ 4. æµ‹è¯•ç¯å¢ƒå…ˆéªŒè¯                    â”‚
â”‚ 5. é€æ­¥å‡çº§ï¼ˆä¸è¦è·¨å¤šä¸ªä¸»ç‰ˆæœ¬ï¼‰       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”§ è·¨ç‰ˆæœ¬è¿ç§»è„šæœ¬**

```bash
#!/bin/bash
# è·¨ç‰ˆæœ¬è¿ç§»è„šæœ¬

migrate_version() {
    local source_version=$1
    local target_version=$2
    local backup_path=$3
    
    echo "å¼€å§‹ç‰ˆæœ¬è¿ç§»: $source_version â†’ $target_version"
    
    # ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥
    case "$source_version,$target_version" in
        "3.6.*,3.7.*"|"3.7.*,3.8.*"|"3.8.*,3.9.*")
            echo "âœ… ç‰ˆæœ¬å…¼å®¹ï¼Œå¯ä»¥ç›´æ¥è¿ç§»"
            ;;
        "3.6.*,3.8.*"|"3.6.*,3.9.*")
            echo "âš ï¸  è·¨ç‰ˆæœ¬è¿ç§»ï¼Œéœ€è¦åˆ†æ­¥è¿›è¡Œ"
            echo "å»ºè®®è·¯å¾„: 3.6 â†’ 3.7 â†’ 3.8 â†’ 3.9"
            return 1
            ;;
        *)
            echo "âŒ ä¸æ”¯æŒçš„ç‰ˆæœ¬è¿ç§»è·¯å¾„"
            return 1
            ;;
    esac
    
    # 1. åœæ­¢æ—§ç‰ˆæœ¬æœåŠ¡
    systemctl stop rabbitmq-server
    
    # 2. å®‰è£…æ–°ç‰ˆæœ¬
    install_new_version $target_version
    
    # 3. è¿ç§»æ•°æ®æ ¼å¼ï¼ˆå¦‚æœéœ€è¦ï¼‰
    if need_schema_migration $source_version $target_version; then
        migrate_schema $backup_path
    fi
    
    # 4. æ¢å¤æ•°æ®
    restore_rabbitmq $backup_path
    
    # 5. éªŒè¯è¿ç§»ç»“æœ
    verify_migration $source_version $target_version
}

# æ¨¡å¼è¿ç§»å‡½æ•°
migrate_schema() {
    local backup_path=$1
    
    echo "æ‰§è¡Œæ¨¡å¼è¿ç§»..."
    
    # ä½¿ç”¨rabbitmqctlè¿›è¡Œæ¨¡å¼å‡çº§
    rabbitmqctl eval 'mnesia:transform_table(rabbit_user, ignore, record_info(fields, rabbit_user)).'
    
    echo "æ¨¡å¼è¿ç§»å®Œæˆ"
}
```

### 4.3 å¤‡ä»½å­˜å‚¨ç®¡ç†


**â˜ï¸ å¤šå­˜å‚¨ç­–ç•¥**

```
å­˜å‚¨ç­–ç•¥è®¾è®¡ï¼š

æœ¬åœ°å­˜å‚¨ï¼š
/opt/rabbitmq-backup/
â”œâ”€â”€ daily/           # æ¯æ—¥å¤‡ä»½
â”œâ”€â”€ weekly/          # æ¯å‘¨å¤‡ä»½  
â”œâ”€â”€ monthly/         # æ¯æœˆå¤‡ä»½
â””â”€â”€ emergency/       # ç´§æ€¥å¤‡ä»½

è¿œç¨‹å­˜å‚¨ï¼š
äº‘å­˜å‚¨ï¼ˆS3ã€OSSç­‰ï¼‰
â”œâ”€â”€ production/      # ç”Ÿäº§ç¯å¢ƒå¤‡ä»½
â”œâ”€â”€ staging/         # æµ‹è¯•ç¯å¢ƒå¤‡ä»½
â””â”€â”€ archive/         # å½’æ¡£å¤‡ä»½

ç½‘ç»œå­˜å‚¨ï¼š
NFS/CIFSå…±äº«
â”œâ”€â”€ current/         # å½“å‰å¤‡ä»½
â”œâ”€â”€ history/         # å†å²å¤‡ä»½
â””â”€â”€ disaster/        # ç¾å¤‡å­˜å‚¨
```

---

## 5. ğŸ”§ æ•…éšœæ’æŸ¥ä¸é—®é¢˜è§£å†³


### 5.1 å¸¸è§å¤‡ä»½é—®é¢˜


**âŒ å¤‡ä»½å¤±è´¥æ’æŸ¥**

| é—®é¢˜ç°è±¡ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ¡ˆ |
|---------|---------|---------|
| `æƒé™æ‹’ç»` | æ–‡ä»¶æƒé™ä¸è¶³ | `chown -R rabbitmq:rabbitmq /backup/path` |
| `ç£ç›˜ç©ºé—´ä¸è¶³` | å¤‡ä»½ç›®å½•ç©ºé—´æ»¡ | æ¸…ç†æ—§å¤‡ä»½æˆ–æ›´æ¢å­˜å‚¨ä½ç½® |
| `æ–‡ä»¶é”å®š` | RabbitMQæ­£åœ¨å†™å…¥ | ä½¿ç”¨çƒ­å¤‡ä»½æˆ–åœæœåŠ¡å¤‡ä»½ |
| `ç½‘ç»œè¶…æ—¶` | è¿œç¨‹å­˜å‚¨è¿æ¥å¤±è´¥ | æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œå­˜å‚¨æœåŠ¡ |
| `æ ¼å¼é”™è¯¯` | JSONå¯¼å‡ºå¤±è´¥ | æ£€æŸ¥é˜Ÿåˆ—çŠ¶æ€å’Œæƒé™é…ç½® |

**ğŸ” å¤‡ä»½æ—¥å¿—åˆ†æ**

```bash
# å¤‡ä»½æ•…éšœè¯Šæ–­è„šæœ¬
diagnose_backup_issue() {
    echo "=== å¤‡ä»½æ•…éšœè¯Šæ–­ ==="
    
    # 1. æ£€æŸ¥ç£ç›˜ç©ºé—´
    echo "1. ç£ç›˜ç©ºé—´æ£€æŸ¥:"
    df -h /opt/rabbitmq-backup
    
    # 2. æ£€æŸ¥æƒé™
    echo "2. æƒé™æ£€æŸ¥:"
    ls -la /var/lib/rabbitmq/mnesia/
    
    # 3. æ£€æŸ¥è¿›ç¨‹çŠ¶æ€
    echo "3. RabbitMQè¿›ç¨‹çŠ¶æ€:"
    ps aux | grep rabbitmq
    
    # 4. æ£€æŸ¥ç«¯å£å ç”¨
    echo "4. ç«¯å£å ç”¨æ£€æŸ¥:"
    netstat -tlnp | grep :5672
    
    # 5. æ£€æŸ¥æ—¥å¿—é”™è¯¯
    echo "5. æœ€è¿‘çš„é”™è¯¯æ—¥å¿—:"
    tail -50 /var/log/rabbitmq/rabbit@*.log | grep -i error
    
    # 6. æ£€æŸ¥å¤‡ä»½ç›®å½•
    echo "6. å¤‡ä»½ç›®å½•çŠ¶æ€:"
    ls -la /opt/rabbitmq-backup/
}
```

### 5.2 æ¢å¤å¤±è´¥å¤„ç†


**ğŸš¨ æ¢å¤è¿‡ç¨‹æ•…éšœ**

```
æ¢å¤å¤±è´¥å¸¸è§åŸå› å’Œè§£å†³æ–¹æ¡ˆï¼š

1. ç‰ˆæœ¬ä¸å…¼å®¹
   ç°è±¡: å¯åŠ¨åæŠ¥é”™"schema version mismatch"
   è§£å†³: ä½¿ç”¨compatibleç‰ˆæœ¬æˆ–è¿›è¡Œschemaè¿ç§»
   
2. æ–‡ä»¶æŸå
   ç°è±¡: æ— æ³•è§£å‹æˆ–è¯»å–å¤‡ä»½æ–‡ä»¶
   è§£å†³: ä½¿ç”¨è¾ƒæ—©çš„å¤‡ä»½æ–‡ä»¶æˆ–ä¿®å¤å·¥å…·
   
3. æƒé™é—®é¢˜
   ç°è±¡: æœåŠ¡å¯åŠ¨å¤±è´¥ï¼Œæƒé™æ‹’ç»
   è§£å†³: ä¿®æ­£æ–‡ä»¶å’Œç›®å½•æƒé™
   
4. ç£ç›˜ç©ºé—´ä¸è¶³
   ç°è±¡: æ¢å¤è¿‡ç¨‹ä¸­æ­¢
   è§£å†³: æ¸…ç†ç©ºé—´æˆ–æ›´æ¢æ¢å¤ä½ç½®
   
5. é›†ç¾¤é…ç½®å†²çª
   ç°è±¡: èŠ‚ç‚¹æ— æ³•åŠ å…¥é›†ç¾¤
   è§£å†³: é‡æ–°é…ç½®é›†ç¾¤æˆ–å•èŠ‚ç‚¹æ¢å¤
```

**ğŸ”§ æ¢å¤æ•‘æ´è„šæœ¬**

```bash
#!/bin/bash
# æ¢å¤æ•‘æ´è„šæœ¬

rescue_restore() {
    echo "=== å¯åŠ¨æ¢å¤æ•‘æ´ç¨‹åº ==="
    
    # 1. å¼ºåˆ¶åœæ­¢æ‰€æœ‰RabbitMQè¿›ç¨‹
    pkill -f rabbitmq
    pkill -f beam.smp
    sleep 5
    
    # 2. æ¸…ç†å¯èƒ½çš„é”æ–‡ä»¶
    find /var/lib/rabbitmq -name "*.lock" -delete
    find /var/lib/rabbitmq -name "*.LCK" -delete
    
    # 3. é‡ç½®æ–‡ä»¶æƒé™
    chown -R rabbitmq:rabbitmq /var/lib/rabbitmq
    chmod -R 755 /var/lib/rabbitmq
    
    # 4. æ£€æŸ¥å¹¶ä¿®å¤mnesiaæ•°æ®åº“
    su - rabbitmq -c "erl -mnesia dir '/var/lib/rabbitmq/mnesia' -eval 'mnesia:info()' -s init stop"
    
    # 5. å•èŠ‚ç‚¹æ¨¡å¼å¯åŠ¨
    echo "å°è¯•å•èŠ‚ç‚¹æ¨¡å¼å¯åŠ¨..."
    RABBITMQ_NODE_TYPE=disc rabbitmq-server -detached
    sleep 10
    
    # 6. æ£€æŸ¥å¯åŠ¨çŠ¶æ€
    if rabbitmqctl node_health_check; then
        echo "âœ… æ•‘æ´æˆåŠŸï¼ŒRabbitMQå·²å¯åŠ¨"
    else
        echo "âŒ æ•‘æ´å¤±è´¥ï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†"
    fi
}
```

### 5.3 æ•°æ®ä¸¢å¤±å¤„ç†


**ğŸ’¥ ç¾éš¾æ¢å¤æµç¨‹**

```
æ•°æ®ä¸¢å¤±åœºæ™¯å¤„ç†ï¼š

å®Œå…¨ä¸¢å¤±æ¢å¤æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. è¯„ä¼°æŸå¤±èŒƒå›´                      â”‚
â”‚ 2. æŸ¥æ‰¾å¯ç”¨å¤‡ä»½                      â”‚  
â”‚ 3. å»ºç«‹ä¸´æ—¶ç¯å¢ƒ                      â”‚
â”‚ 4. æ¢å¤åŸºç¡€è®¾æ–½                      â”‚
â”‚ 5. æ¢å¤æ•°æ®å’Œé…ç½®                    â”‚
â”‚ 6. éªŒè¯æ•°æ®å®Œæ•´æ€§                    â”‚
â”‚ 7. åˆ‡æ¢ä¸šåŠ¡æµé‡                      â”‚
â”‚ 8. ç›‘æ§ç³»ç»Ÿç¨³å®šæ€§                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

éƒ¨åˆ†ä¸¢å¤±æ¢å¤ï¼š
â€¢ é˜Ÿåˆ—ä¸¢å¤±ï¼šé‡å»ºé˜Ÿåˆ—å’Œç»‘å®šå…³ç³»
â€¢ æ¶ˆæ¯ä¸¢å¤±ï¼šä»ç”Ÿäº§è€…é‡æ–°å‘é€
â€¢ é…ç½®ä¸¢å¤±ï¼šä»é…ç½®å¤‡ä»½æ¢å¤
â€¢ ç”¨æˆ·ä¸¢å¤±ï¼šé‡å»ºç”¨æˆ·å’Œæƒé™
```

---

## 6. ğŸ’¡ æœ€ä½³å®è·µä¸è¿ç»´å»ºè®®


### 6.1 è‡ªåŠ¨åŒ–å¤‡ä»½è„šæœ¬


**âš™ï¸ ç”Ÿäº§çº§è‡ªåŠ¨åŒ–å¤‡ä»½**

```bash
#!/bin/bash
# ç”Ÿäº§çº§è‡ªåŠ¨åŒ–å¤‡ä»½è„šæœ¬

# é…ç½®å‚æ•°
BACKUP_ROOT="/opt/rabbitmq-backup"
REMOTE_BACKUP_HOST="backup.company.com"
REMOTE_BACKUP_PATH="/backup/rabbitmq"
RETENTION_DAYS=30
NOTIFICATION_EMAIL="admin@company.com"

# ä¸»å¤‡ä»½å‡½æ•°
main_backup() {
    local timestamp=$(date +%Y%m%d_%H%M%S)
    local backup_dir="$BACKUP_ROOT/$timestamp"
    local log_file="$BACKUP_ROOT/backup_$timestamp.log"
    
    # åˆ›å»ºå¤‡ä»½ç›®å½•
    mkdir -p $backup_dir
    
    # å¼€å§‹å¤‡ä»½
    {
        echo "å¼€å§‹å¤‡ä»½: $(date)"
        
        # å¥åº·æ£€æŸ¥
        if ! rabbitmqctl node_health_check; then
            echo "é”™è¯¯: RabbitMQèŠ‚ç‚¹ä¸å¥åº·"
            exit 1
        fi
        
        # å¯¼å‡ºå®šä¹‰
        rabbitmqctl export_definitions $backup_dir/definitions.json
        
        # å¤‡ä»½æ•°æ®æ–‡ä»¶ï¼ˆçƒ­å¤‡ä»½ï¼‰
        rsync -av /var/lib/rabbitmq/mnesia/ $backup_dir/mnesia/
        
        # å¤‡ä»½é…ç½®
        cp -r /etc/rabbitmq/ $backup_dir/config/
        
        # ç”Ÿæˆå¤‡ä»½å…ƒä¿¡æ¯
        cat > $backup_dir/metadata.json << EOF
{
    "backup_time": "$(date -Iseconds)",
    "rabbitmq_version": "$(rabbitmqctl version)",
    "backup_type": "full",
    "backup_size": "$(du -sh $backup_dir | cut -f1)"
}
EOF
        
        # å‹ç¼©å¤‡ä»½
        tar -czf $backup_dir.tar.gz -C $BACKUP_ROOT $(basename $backup_dir)
        rm -rf $backup_dir
        
        # åŒæ­¥åˆ°è¿œç¨‹
        rsync -av $backup_dir.tar.gz $REMOTE_BACKUP_HOST:$REMOTE_BACKUP_PATH/
        
        # æ¸…ç†æ—§å¤‡ä»½
        find $BACKUP_ROOT -name "*.tar.gz" -mtime +$RETENTION_DAYS -delete
        
        echo "å¤‡ä»½å®Œæˆ: $(date)"
        
    } 2>&1 | tee $log_file
    
    # å‘é€é€šçŸ¥
    if [ ${PIPESTATUS[0]} -eq 0 ]; then
        send_notification "SUCCESS" $log_file
    else
        send_notification "FAILED" $log_file
    fi
}

# é€šçŸ¥å‡½æ•°
send_notification() {
    local status=$1
    local log_file=$2
    
    case $status in
        "SUCCESS")
            subject="RabbitMQå¤‡ä»½æˆåŠŸ - $(hostname)"
            ;;
        "FAILED")
            subject="RabbitMQå¤‡ä»½å¤±è´¥ - $(hostname)"
            ;;
    esac
    
    # å‘é€é‚®ä»¶é€šçŸ¥
    mail -s "$subject" $NOTIFICATION_EMAIL < $log_file
}

# æ‰§è¡Œå¤‡ä»½
main_backup
```

### 6.2 ç¾éš¾æ¢å¤æ¼”ç»ƒ


**ğŸ¯ å®šæœŸæ¼”ç»ƒè®¡åˆ’**

```
ç¾éš¾æ¢å¤æ¼”ç»ƒæ—¶é—´è¡¨ï¼š

æœˆåº¦æ¼”ç»ƒï¼š
â€¢ æ¢å¤å•ä¸ªé˜Ÿåˆ—
â€¢ éªŒè¯å¤‡ä»½å®Œæ•´æ€§
â€¢ æµ‹è¯•ç›‘æ§å‘Šè­¦

å­£åº¦æ¼”ç»ƒï¼š
â€¢ å®Œæ•´ç³»ç»Ÿæ¢å¤
â€¢ è·¨æœºæˆ¿åˆ‡æ¢
â€¢ ä¸šåŠ¡è¿ç»­æ€§æµ‹è¯•

å¹´åº¦æ¼”ç»ƒï¼š
â€¢ å…¨é‡æ•°æ®æ¢å¤
â€¢ å¤šæ•…éšœåœºæ™¯æ¨¡æ‹Ÿ
â€¢ åº”æ€¥å“åº”æµç¨‹

æ¼”ç»ƒè®°å½•æ¨¡æ¿ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ¼”ç»ƒæ—¶é—´: 2024å¹´XæœˆXæ—¥              â”‚
â”‚ æ¼”ç»ƒç±»å‹: å®Œæ•´æ¢å¤æ¼”ç»ƒ               â”‚
â”‚ å‚ä¸äººå‘˜: è¿ç»´ã€å¼€å‘ã€æµ‹è¯•           â”‚
â”‚ æ¼”ç»ƒåœºæ™¯: ä¸»æœºæˆ¿æ–­ç”µï¼Œæ•°æ®å…¨ä¸¢å¤±     â”‚
â”‚ æ¢å¤æ—¶é—´: 30åˆ†é’Ÿ                    â”‚
â”‚ å‘ç°é—®é¢˜: å¤‡ä»½æ–‡ä»¶æƒé™é—®é¢˜           â”‚
â”‚ æ”¹è¿›æªæ–½: ä¼˜åŒ–å¤‡ä»½è„šæœ¬æƒé™è®¾ç½®       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.3 ä¸šåŠ¡è¿ç»­æ€§ä¿è¯


**ğŸ”„ ä¸šåŠ¡è¿ç»­æ€§ç­–ç•¥**

```
ä¸šåŠ¡è¿ç»­æ€§ä¿è¯æªæ–½ï¼š

æŠ€æœ¯å±‚é¢ï¼š
â€¢ ä¸»ä»å¤åˆ¶ï¼šæ•°æ®å®æ—¶åŒæ­¥
â€¢ é›†ç¾¤éƒ¨ç½²ï¼šå¤šèŠ‚ç‚¹å®¹é”™
â€¢ è´Ÿè½½å‡è¡¡ï¼šæµé‡åˆ†å‘
â€¢ å¥åº·æ£€æŸ¥ï¼šè‡ªåŠ¨æ•…éšœæ£€æµ‹

æµç¨‹å±‚é¢ï¼š
â€¢ åº”æ€¥é¢„æ¡ˆï¼šæ˜ç¡®è´£ä»»åˆ†å·¥
â€¢ å¤‡ä»½ç­–ç•¥ï¼šå¤šå±‚æ¬¡æ•°æ®ä¿æŠ¤  
â€¢ ç›‘æ§å‘Šè­¦ï¼šåŠæ—¶å‘ç°é—®é¢˜
â€¢ æ¼”ç»ƒéªŒè¯ï¼šç¡®ä¿æ–¹æ¡ˆå¯è¡Œ

ä¸šåŠ¡å±‚é¢ï¼š
â€¢ æ¶ˆæ¯æŒä¹…åŒ–ï¼šé˜²æ­¢æ•°æ®ä¸¢å¤±
â€¢ é‡è¯•æœºåˆ¶ï¼šå¤„ç†ä¸´æ—¶æ•…éšœ
â€¢ é™çº§ç­–ç•¥ï¼šæ ¸å¿ƒåŠŸèƒ½ä¼˜å…ˆ
â€¢ é€šçŸ¥æœºåˆ¶ï¼šåŠæ—¶å‘ŠçŸ¥ç”¨æˆ·
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å¤‡ä»½ç±»å‹ï¼šå…¨é‡å¤‡ä»½ã€å¢é‡å¤‡ä»½çš„åŒºåˆ«å’Œåº”ç”¨åœºæ™¯
ğŸ”¸ æ•°æ®å†…å®¹ï¼šå…ƒæ•°æ®ã€æ¶ˆæ¯æ•°æ®ã€é…ç½®æ•°æ®çš„å¤‡ä»½æ–¹æ³•
ğŸ”¸ æ¢å¤æµç¨‹ï¼šå®Œæ•´çš„æ•°æ®æ¢å¤æ­¥éª¤å’ŒéªŒè¯æ–¹æ³•
ğŸ”¸ æ•…éšœæ’æŸ¥ï¼šå¸¸è§å¤‡ä»½æ¢å¤é—®é¢˜çš„è¯Šæ–­å’Œè§£å†³
ğŸ”¸ è‡ªåŠ¨åŒ–ï¼šç”Ÿäº§çº§å¤‡ä»½è„šæœ¬çš„ç¼–å†™å’Œç»´æŠ¤
ğŸ”¸ ç¾éš¾æ¢å¤ï¼šä¸šåŠ¡è¿ç»­æ€§ä¿è¯å’Œåº”æ€¥å“åº”
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å¤‡ä»½ç­–ç•¥çš„é€‰æ‹©**
```
é€‰æ‹©åŸåˆ™ï¼š
â€¢ ä¸šåŠ¡é‡è¦æ€§ï¼šæ ¸å¿ƒä¸šåŠ¡é«˜é¢‘å¤‡ä»½
â€¢ æ•°æ®å˜åŒ–é¢‘ç‡ï¼šå˜åŒ–å¿«çš„è¦é¢‘ç¹å¤‡ä»½
â€¢ æ¢å¤æ—¶é—´è¦æ±‚ï¼šRTOè¶ŠçŸ­å¤‡ä»½è¶Šé¢‘ç¹
â€¢ å­˜å‚¨æˆæœ¬è€ƒè™‘ï¼šå¹³è¡¡å¤‡ä»½é¢‘ç‡å’Œæˆæœ¬
```

**ğŸ”¹ æ¢å¤æ“ä½œçš„æ³¨æ„äº‹é¡¹**
```
å…³é”®è¦ç‚¹ï¼š
â€¢ æ¢å¤å‰ä¸€å®šè¦åšå½“å‰æ•°æ®å¤‡ä»½
â€¢ ä¸¥æ ¼æŒ‰ç…§æ¢å¤æµç¨‹æ“ä½œ
â€¢ æ¢å¤åå¿…é¡»è¿›è¡Œå®Œæ•´æ€§éªŒè¯
â€¢ æµ‹è¯•ç¯å¢ƒå…ˆéªŒè¯å†åˆ°ç”Ÿäº§ç¯å¢ƒ
```

**ğŸ”¹ è‡ªåŠ¨åŒ–çš„é‡è¦æ€§**
```
è‡ªåŠ¨åŒ–ä»·å€¼ï¼š
â€¢ å‡å°‘äººä¸ºé”™è¯¯ï¼šæ ‡å‡†åŒ–æ“ä½œæµç¨‹
â€¢ æé«˜æ•ˆç‡ï¼šå®šæ—¶è‡ªåŠ¨æ‰§è¡Œ
â€¢ ç¡®ä¿ä¸€è‡´æ€§ï¼šæ ‡å‡†åŒ–å¤‡ä»½æ ¼å¼
â€¢ åŠæ—¶å‘ç°é—®é¢˜ï¼šè‡ªåŠ¨ç›‘æ§å‘Šè­¦
```

### 7.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ç”Ÿäº§ç¯å¢ƒåº”ç”¨**
- **æ•°æ®å®‰å…¨**ï¼šå»ºç«‹å®Œå–„çš„æ•°æ®ä¿æŠ¤ä½“ç³»
- **ä¸šåŠ¡è¿ç»­æ€§**ï¼šç¡®ä¿æœåŠ¡é«˜å¯ç”¨
- **åˆè§„è¦æ±‚**ï¼šæ»¡è¶³æ•°æ®å¤‡ä»½ç›¸å…³è§„å®š
- **æˆæœ¬æ§åˆ¶**ï¼šä¼˜åŒ–å­˜å‚¨å’Œè¿ç»´æˆæœ¬

**ğŸ”§ è¿ç»´å®è·µä»·å€¼**
- **æ•…éšœæ¢å¤**ï¼šå¿«é€Ÿå¤„ç†ç”Ÿäº§äº‹æ•…
- **ç‰ˆæœ¬å‡çº§**ï¼šå®‰å…¨çš„å‡çº§è¿ç§»æ–¹æ¡ˆ
- **å®¹é‡è§„åˆ’**ï¼šåŸºäºå¤‡ä»½æ•°æ®åˆ†æè¶‹åŠ¿
- **å®‰å…¨å®¡è®¡**ï¼šå¤‡ä»½æ“ä½œçš„æ—¥å¿—è®°å½•

**æ ¸å¿ƒè®°å¿†**ï¼š
- å¤‡ä»½æ˜¯ä¿é™©ï¼Œæ¢å¤æ˜¯æ•‘å‘½ç¨»è‰
- è‡ªåŠ¨åŒ–å¤‡ä»½ï¼Œæ‰‹åŠ¨éªŒè¯æ¢å¤
- å¤‡ä»½è¦å…¨é¢ï¼Œæ¢å¤è¦éªŒè¯
- æ¼”ç»ƒå¸¸æ€åŒ–ï¼Œåº”æ€¥æœ‰ä¿éšœ