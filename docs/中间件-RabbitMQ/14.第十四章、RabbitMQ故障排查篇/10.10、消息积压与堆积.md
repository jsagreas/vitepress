---
title: 10ã€æ¶ˆæ¯ç§¯å‹ä¸å †ç§¯
---
## ğŸ“š ç›®å½•

1. [æ¶ˆæ¯ç§¯å‹é—®é¢˜æ¦‚è¿°](#1-æ¶ˆæ¯ç§¯å‹é—®é¢˜æ¦‚è¿°)
2. [æ¶ˆè´¹è€…å¤„ç†èƒ½åŠ›åˆ†æ](#2-æ¶ˆè´¹è€…å¤„ç†èƒ½åŠ›åˆ†æ)
3. [é˜Ÿåˆ—é…ç½®ä¸ç®¡ç†](#3-é˜Ÿåˆ—é…ç½®ä¸ç®¡ç†)
4. [æ­»ä¿¡é˜Ÿåˆ—å¤„ç†æœºåˆ¶](#4-æ­»ä¿¡é˜Ÿåˆ—å¤„ç†æœºåˆ¶)
5. [æ¶ˆè´¹è€…æ‰©å®¹ç­–ç•¥](#5-æ¶ˆè´¹è€…æ‰©å®¹ç­–ç•¥)
6. [æµæ§ä¸èƒŒå‹æœºåˆ¶](#6-æµæ§ä¸èƒŒå‹æœºåˆ¶)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸš¨ æ¶ˆæ¯ç§¯å‹é—®é¢˜æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯æ¶ˆæ¯ç§¯å‹


**ğŸ”¸ ç®€å•ç†è§£**
```
å°±åƒå¿«é€’ä»“åº“å †æ»¡äº†åŒ…è£¹ï¼Œä½†é…é€å‘˜ä¸å¤Ÿç”¨
ç”Ÿäº§è€… â†’ å‘é€æ¶ˆæ¯å¤ªå¿« (è¿›è´§é€Ÿåº¦å¿«)
æ¶ˆè´¹è€… â†’ å¤„ç†æ¶ˆæ¯å¤ªæ…¢ (é…é€é€Ÿåº¦æ…¢)
ç»“æœ â†’ é˜Ÿåˆ—ä¸­æ¶ˆæ¯è¶Šæ¥è¶Šå¤š (ä»“åº“çˆ†æ»¡)
```

**ğŸ“Š ç§¯å‹ç°è±¡è¡¨ç°**
```
ç›‘æ§æŒ‡æ ‡å¼‚å¸¸ï¼š
â€¢ é˜Ÿåˆ—é•¿åº¦æŒç»­å¢é•¿ ğŸ“ˆ
â€¢ æ¶ˆæ¯å¤„ç†å»¶è¿Ÿå¢åŠ  â°
â€¢ æ¶ˆè´¹è€…CPU/å†…å­˜å ç”¨é«˜ ğŸ’»
â€¢ ç³»ç»Ÿå“åº”æ—¶é—´å˜æ…¢ ğŸŒ
```

### 1.2 ç§¯å‹äº§ç”Ÿçš„æ ¹æœ¬åŸå› 


**âš–ï¸ ç”Ÿäº§æ¶ˆè´¹ä¸å¹³è¡¡**
```
ç”Ÿäº§é€Ÿåº¦ > æ¶ˆè´¹é€Ÿåº¦ = æ¶ˆæ¯ç§¯å‹

å¸¸è§åŸå› ï¼š
ğŸ”¸ æ¶ˆè´¹è€…å¤„ç†é€»è¾‘å¤æ‚ï¼Œå•æ¡æ¶ˆæ¯è€—æ—¶é•¿
ğŸ”¸ æ¶ˆè´¹è€…æ•°é‡ä¸è¶³ï¼Œå¤„ç†èƒ½åŠ›æœ‰é™
ğŸ”¸ ç½‘ç»œIOé˜»å¡ï¼Œæ•°æ®åº“æŸ¥è¯¢æ…¢
ğŸ”¸ æ¶ˆè´¹è€…é¢‘ç¹é‡å¯ï¼Œå¤„ç†ä¸­æ–­
ğŸ”¸ ä¸šåŠ¡é«˜å³°æœŸï¼Œæ¶ˆæ¯é‡çªç„¶æ¿€å¢
```

### 1.3 ç§¯å‹å¸¦æ¥çš„å½±å“


**âš ï¸ ç³»ç»Ÿæ€§é£é™©**
```
å†…å­˜æ¶ˆè€—ï¼šé˜Ÿåˆ—å ç”¨å¤§é‡å†…å­˜
ç£ç›˜å‹åŠ›ï¼šæ¶ˆæ¯æŒä¹…åŒ–å¯¼è‡´ç£ç›˜æ»¡
å»¶è¿Ÿå¢åŠ ï¼šæ¶ˆæ¯å¤„ç†æ—¶æ•ˆæ€§ä¸‹é™
æœåŠ¡é›ªå´©ï¼šä¾èµ–æœåŠ¡å“åº”è¶…æ—¶
ç”¨æˆ·ä½“éªŒï¼šåŠŸèƒ½å“åº”ç¼“æ…¢ç”šè‡³å¤±æ•ˆ
```

---

## 2. ğŸ‘¥ æ¶ˆè´¹è€…å¤„ç†èƒ½åŠ›åˆ†æ


### 2.1 æ¶ˆè´¹è€…æ€§èƒ½è¯„ä¼°


**ğŸ“ å…³é”®æ€§èƒ½æŒ‡æ ‡**
```
ååé‡æŒ‡æ ‡ï¼š
â€¢ TPS (æ¯ç§’å¤„ç†æ¶ˆæ¯æ•°)
â€¢ å¹³å‡å¤„ç†æ—¶é—´
â€¢ å³°å€¼å¤„ç†èƒ½åŠ›

ç¤ºä¾‹è®¡ç®—ï¼š
å•ä¸ªæ¶ˆè´¹è€…å¹³å‡å¤„ç†æ—¶é—´ï¼š200ms
ç†è®ºæœ€å¤§TPSï¼š1000ms Ã· 200ms = 5æ¡/ç§’
å®é™…TPSï¼šè€ƒè™‘ç½‘ç»œå»¶è¿Ÿï¼Œçº¦4æ¡/ç§’
```

**ğŸ” æ€§èƒ½ç“¶é¢ˆè¯†åˆ«**
```
CPUå¯†é›†å‹å¤„ç†ï¼š
âœ… ä¼˜åŒ–ç®—æ³•é€»è¾‘
âœ… å¢åŠ å¹¶å‘å¤„ç†
âœ… ä½¿ç”¨ç¼“å­˜å‡å°‘è®¡ç®—

IOå¯†é›†å‹å¤„ç†ï¼š
âœ… æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–
âœ… å¼‚æ­¥IOå¤„ç†
âœ… æ‰¹é‡æ“ä½œå‡å°‘ç½‘ç»œè°ƒç”¨
```

### 2.2 æ¶ˆè´¹è€…æ•°é‡é…ç½®


**ğŸ¯ æœ€ä¼˜æ¶ˆè´¹è€…æ•°é‡è®¡ç®—**
```
åŸºç¡€å…¬å¼ï¼š
æ¶ˆè´¹è€…æ•°é‡ = ç›®æ ‡TPS Ã· å•ä¸ªæ¶ˆè´¹è€…TPS

å®é™…æ¡ˆä¾‹ï¼š
ä¸šåŠ¡è¦æ±‚ï¼š1000æ¡/ç§’
å•ä¸ªæ¶ˆè´¹è€…ï¼š50æ¡/ç§’
ç†è®ºéœ€è¦ï¼š1000 Ã· 50 = 20ä¸ªæ¶ˆè´¹è€…
å®é™…é…ç½®ï¼š25ä¸ªæ¶ˆè´¹è€… (ç•™20%ä½™é‡)
```

| åœºæ™¯ç±»å‹ | **æ¶ˆè´¹è€…é…ç½®å»ºè®®** | **æ³¨æ„äº‹é¡¹** |
|---------|------------------|-------------|
| ğŸƒâ€â™‚ï¸ **é«˜å¹¶å‘åœºæ™¯** | `æ¶ˆè´¹è€…æ•° = CPUæ ¸å¿ƒæ•° Ã— 2` | `é¿å…è¿‡åº¦ç«äº‰èµ„æº` |
| ğŸ’¾ **IOå¯†é›†å‹** | `æ¶ˆè´¹è€…æ•° = æ ¸å¿ƒæ•° Ã— 4-8` | `å…³æ³¨æ•°æ®åº“è¿æ¥æ± ` |
| ğŸ§® **è®¡ç®—å¯†é›†å‹** | `æ¶ˆè´¹è€…æ•° = CPUæ ¸å¿ƒæ•°` | `é¿å…ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€` |

### 2.3 æ¶ˆè´¹è€…ä»£ç ä¼˜åŒ–


**âš¡ å¤„ç†é€»è¾‘ä¼˜åŒ–**
```java
// âŒ ä½æ•ˆçš„æ¶ˆè´¹è€…å®ç°
@RabbitListener(queues = "order.queue")
public void processOrder(OrderMessage msg) {
    // åŒæ­¥æ•°æ®åº“æ“ä½œ - é˜»å¡
    User user = userService.getUserById(msg.getUserId());
    
    // åŒæ­¥HTTPè°ƒç”¨ - é˜»å¡
    PaymentResult result = paymentService.processPayment(msg);
    
    // æ¯æ¡æ¶ˆæ¯éƒ½å†™æ—¥å¿— - IOå¼€é”€
    logger.info("å¤„ç†è®¢å•: {}", msg.getOrderId());
}

// âœ… é«˜æ•ˆçš„æ¶ˆè´¹è€…å®ç°  
@RabbitListener(queues = "order.queue")
public void processOrderOptimized(OrderMessage msg) {
    try {
        // å¼‚æ­¥å¤„ç†
        CompletableFuture<User> userFuture = 
            userService.getUserByIdAsync(msg.getUserId());
            
        // æ‰¹é‡å¤„ç†æœºåˆ¶
        orderBatchProcessor.addToBuffer(msg);
        
        // ç¼“å­˜å¸¸ç”¨æ•°æ®
        if (needUserInfo) {
            User user = userCache.get(msg.getUserId());
        }
    } catch (Exception e) {
        // é”™è¯¯å¤„ç†
        handleProcessingError(msg, e);
    }
}
```

---

## 3. ğŸ“‹ é˜Ÿåˆ—é…ç½®ä¸ç®¡ç†


### 3.1 é˜Ÿåˆ—é•¿åº¦é™åˆ¶è®¾ç½®


**ğŸ”§ é˜Ÿåˆ—é•¿åº¦é…ç½®**
```java
// å£°æ˜é˜Ÿåˆ—æ—¶è®¾ç½®é•¿åº¦é™åˆ¶
@Bean
public Queue orderQueue() {
    return QueueBuilder.durable("order.queue")
        .maxLength(10000)                    // æœ€å¤§æ¶ˆæ¯æ•°
        .maxLengthBytes(1024 * 1024 * 100)  // æœ€å¤§å­—èŠ‚æ•° 100MB
        .overflow(QueueBuilder.OverflowBehavior.DROP_HEAD) // æº¢å‡ºç­–ç•¥
        .build();
}
```

**ğŸ“Š æº¢å‡ºç­–ç•¥å¯¹æ¯”**
```
DROP_HEAD (ä¸¢å¼ƒå¤´éƒ¨):
é€‚ç”¨åœºæ™¯ï¼šå®æ—¶æ€§è¦æ±‚é«˜ï¼Œå¯æ¥å—ä¸¢å¤±æ—§æ¶ˆæ¯
é£é™©ï¼šå¯èƒ½ä¸¢å¤±é‡è¦å†å²æ•°æ®

REJECT_PUBLISH (æ‹’ç»å‘å¸ƒ):
é€‚ç”¨åœºæ™¯ï¼šä¸èƒ½ä¸¢å¤±ä»»ä½•æ¶ˆæ¯
é£é™©ï¼šå‘é€æ–¹éœ€è¦å¤„ç†å‘é€å¤±è´¥
```

### 3.2 æ¶ˆæ¯è¿‡æœŸç­–ç•¥é…ç½®


**â° TTL (Time To Live) è®¾ç½®**
```java
// æ¶ˆæ¯çº§åˆ«TTL
@RabbitListener(queues = "order.queue")
public void processOrder(
    @Payload OrderMessage msg,
    @Header Map<String, Object> headers
) {
    // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦è¿‡æœŸ
    Long timestamp = (Long) headers.get("timestamp");
    if (System.currentTimeMillis() - timestamp > 30000) {
        log.warn("æ¶ˆæ¯å·²è¿‡æœŸï¼Œè·³è¿‡å¤„ç†: {}", msg.getOrderId());
        return;
    }
    
    // æ­£å¸¸å¤„ç†é€»è¾‘
    processOrderLogic(msg);
}

// é˜Ÿåˆ—çº§åˆ«TTLé…ç½®
@Bean  
public Queue orderQueueWithTTL() {
    return QueueBuilder.durable("order.queue")
        .ttl(30000)  // 30ç§’è¿‡æœŸ
        .build();
}
```

### 3.3 ä¼˜å…ˆçº§é˜Ÿåˆ—é…ç½®


**ğŸ¯ æ¶ˆæ¯ä¼˜å…ˆçº§å¤„ç†**
```java
// å£°æ˜ä¼˜å…ˆçº§é˜Ÿåˆ—
@Bean
public Queue priorityQueue() {
    return QueueBuilder.durable("priority.queue")
        .maxPriority(10)  // æ”¯æŒ0-10ä¼˜å…ˆçº§
        .build();
}

// å‘é€å¸¦ä¼˜å…ˆçº§çš„æ¶ˆæ¯
@Service
public class OrderProducer {
    
    public void sendUrgentOrder(OrderMessage msg) {
        rabbitTemplate.convertAndSend("priority.queue", msg, 
            message -> {
                message.getMessageProperties().setPriority(9); // é«˜ä¼˜å…ˆçº§
                return message;
            });
    }
    
    public void sendNormalOrder(OrderMessage msg) {
        rabbitTemplate.convertAndSend("priority.queue", msg,
            message -> {
                message.getMessageProperties().setPriority(1); // ä½ä¼˜å…ˆçº§
                return message;
            });
    }
}
```

---

## 4. â˜ ï¸ æ­»ä¿¡é˜Ÿåˆ—å¤„ç†æœºåˆ¶


### 4.1 æ­»ä¿¡äº§ç”ŸåŸå› 


**ğŸ”¸ ä»€ä¹ˆæ˜¯æ­»ä¿¡**
```
æ­»ä¿¡ = æ— æ³•æ­£å¸¸å¤„ç†çš„æ¶ˆæ¯

äº§ç”Ÿåœºæ™¯ï¼š
ğŸš¨ æ¶ˆæ¯è¢«æ¶ˆè´¹è€…æ‹’ç» (reject/nack) ä¸”ä¸é‡æ–°å…¥é˜Ÿ
â° æ¶ˆæ¯TTLè¿‡æœŸ
ğŸ“ é˜Ÿåˆ—è¾¾åˆ°æœ€å¤§é•¿åº¦é™åˆ¶
ğŸ”„ æ¶ˆæ¯é‡è¯•æ¬¡æ•°è¶…è¿‡é™åˆ¶
```

### 4.2 æ­»ä¿¡é˜Ÿåˆ—é…ç½®


**âšš æ­»ä¿¡äº¤æ¢å™¨å’Œé˜Ÿåˆ—è®¾ç½®**
```java
@Configuration
public class DeadLetterConfig {
    
    // æ­£å¸¸ä¸šåŠ¡é˜Ÿåˆ—
    @Bean
    public Queue orderQueue() {
        return QueueBuilder.durable("order.queue")
            .deadLetterExchange("order.dlx")     // æ­»ä¿¡äº¤æ¢å™¨
            .deadLetterRoutingKey("order.dead")  // æ­»ä¿¡è·¯ç”±é”®
            .ttl(60000)  // 1åˆ†é’Ÿè¿‡æœŸ
            .build();
    }
    
    // æ­»ä¿¡äº¤æ¢å™¨
    @Bean
    public DirectExchange deadLetterExchange() {
        return new DirectExchange("order.dlx");
    }
    
    // æ­»ä¿¡é˜Ÿåˆ—
    @Bean
    public Queue deadLetterQueue() {
        return QueueBuilder.durable("order.dead.queue").build();
    }
    
    // ç»‘å®šæ­»ä¿¡é˜Ÿåˆ—
    @Bean
    public Binding deadLetterBinding() {
        return BindingBuilder
            .bind(deadLetterQueue())
            .to(deadLetterExchange())
            .with("order.dead");
    }
}
```

### 4.3 æ­»ä¿¡å¤„ç†ç­–ç•¥


**ğŸ”„ æ­»ä¿¡å¤„ç†æ¶ˆè´¹è€…**
```java
@Component
public class DeadLetterHandler {
    
    @RabbitListener(queues = "order.dead.queue")
    public void handleDeadLetter(
        @Payload OrderMessage msg,
        @Header Map<String, Object> headers
    ) {
        // åˆ†ææ­»ä¿¡åŸå› 
        String reason = analyzeDeadLetterReason(headers);
        
        switch (reason) {
            case "EXPIRED":
                handleExpiredMessage(msg);
                break;
            case "REJECTED":
                handleRejectedMessage(msg);
                break;
            case "MAX_LENGTH":
                handleMaxLengthMessage(msg);
                break;
            default:
                handleUnknownDeadLetter(msg);
        }
    }
    
    private void handleExpiredMessage(OrderMessage msg) {
        // è®°å½•è¿‡æœŸæ¶ˆæ¯
        log.warn("è®¢å•æ¶ˆæ¯è¿‡æœŸ: {}", msg.getOrderId());
        
        // æ ¹æ®ä¸šåŠ¡å†³å®šæ˜¯å¦éœ€è¦è¡¥å¿å¤„ç†
        if (isImportantOrder(msg)) {
            // å‘é€å‘Šè­¦
            alertService.sendExpiredOrderAlert(msg);
            // å¯èƒ½éœ€è¦äººå·¥å¤„ç†
            manualProcessService.addToManualQueue(msg);
        }
    }
    
    private void handleRejectedMessage(OrderMessage msg) {
        // åˆ†ææ‹’ç»åŸå› 
        int retryCount = getRetryCount(msg);
        
        if (retryCount < 3) {
            // å»¶è¿Ÿé‡è¯•
            delayedRetryService.scheduleRetry(msg, retryCount + 1);
        } else {
            // å½»åº•å¤±è´¥ï¼Œè®°å½•å¹¶å‘Šè­¦
            failureService.recordPermanentFailure(msg);
        }
    }
}
```

---

## 5. ğŸ“ˆ æ¶ˆè´¹è€…æ‰©å®¹ç­–ç•¥


### 5.1 æ°´å¹³æ‰©å®¹æ–¹æ¡ˆ


**ğŸš€ åŠ¨æ€æ‰©å®¹å®ç°**
```java
@Component
public class ConsumerScaler {
    
    @Autowired
    private RabbitListenerEndpointRegistry registry;
    
    // ç›‘æ§é˜Ÿåˆ—é•¿åº¦ï¼ŒåŠ¨æ€è°ƒæ•´æ¶ˆè´¹è€…
    @Scheduled(fixedRate = 30000) // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
    public void scaleConsumers() {
        QueueInfo queueInfo = getQueueInfo("order.queue");
        
        int messageCount = queueInfo.getMessageCount();
        int currentConsumers = getCurrentConsumerCount();
        
        if (messageCount > 1000 && currentConsumers < 10) {
            // æ‰©å®¹ï¼šå¢åŠ æ¶ˆè´¹è€…
            scaleUp("order.queue", 2);
        } else if (messageCount < 100 && currentConsumers > 2) {
            // ç¼©å®¹ï¼šå‡å°‘æ¶ˆè´¹è€…
            scaleDown("order.queue", 1);
        }
    }
    
    private void scaleUp(String queueName, int count) {
        for (int i = 0; i < count; i++) {
            createDynamicConsumer(queueName);
        }
        log.info("é˜Ÿåˆ— {} æ‰©å®¹ {} ä¸ªæ¶ˆè´¹è€…", queueName, count);
    }
}
```

### 5.2 æ¶ˆæ¯åˆ†æµå¤„ç†


**ğŸŒŠ æŒ‰ä¸šåŠ¡ç±»å‹åˆ†æµ**
```java
// å‘é€ç«¯åˆ†æµç­–ç•¥
@Service
public class OrderRoutingService {
    
    public void routeOrder(OrderMessage order) {
        String routingKey;
        
        // æ ¹æ®è®¢å•é‡‘é¢åˆ†æµ
        if (order.getAmount().compareTo(new BigDecimal("1000")) > 0) {
            routingKey = "order.high.value";      // é«˜ä»·å€¼è®¢å•
        } else if (order.getAmount().compareTo(new BigDecimal("100")) > 0) {
            routingKey = "order.medium.value";    // ä¸­ç­‰ä»·å€¼è®¢å•
        } else {
            routingKey = "order.low.value";       // ä½ä»·å€¼è®¢å•
        }
        
        rabbitTemplate.convertAndSend("order.topic", routingKey, order);
    }
}

// ä¸åŒé˜Ÿåˆ—åˆ†åˆ«å¤„ç†
@Component  
public class OrderConsumers {
    
    // é«˜ä»·å€¼è®¢å•ï¼šå°‘é‡æ¶ˆè´¹è€…ï¼Œä»”ç»†å¤„ç†
    @RabbitListener(queues = "order.high.queue", concurrency = "2-3")
    public void processHighValueOrder(OrderMessage msg) {
        // ä¸¥æ ¼éªŒè¯å’Œå¤„ç†
        validateHighValueOrder(msg);
        processOrderWithExtraValidation(msg);
    }
    
    // ä½ä»·å€¼è®¢å•ï¼šå¤šä¸ªæ¶ˆè´¹è€…ï¼Œå¿«é€Ÿå¤„ç†
    @RabbitListener(queues = "order.low.queue", concurrency = "5-10")
    public void processLowValueOrder(OrderMessage msg) {
        // å¿«é€Ÿå¤„ç†
        processOrderQuickly(msg);
    }
}
```

### 5.3 æ‰¹é‡å¤„ç†ä¼˜åŒ–


**ğŸ“¦ æ‰¹é‡æ¶ˆè´¹å®ç°**
```java
@Component
public class BatchOrderProcessor {
    
    private final List<OrderMessage> buffer = new ArrayList<>();
    private final Object lock = new Object();
    
    @RabbitListener(queues = "order.queue")
    public void collectMessage(OrderMessage msg) {
        synchronized (lock) {
            buffer.add(msg);
            
            // è¾¾åˆ°æ‰¹é‡å¤§å°æˆ–æ—¶é—´é—´éš”ï¼Œè§¦å‘æ‰¹é‡å¤„ç†
            if (buffer.size() >= 50) {
                processBatch(new ArrayList<>(buffer));
                buffer.clear();
            }
        }
    }
    
    // å®šæ—¶å¤„ç†æœªæ»¡æ‰¹æ¬¡çš„æ¶ˆæ¯
    @Scheduled(fixedRate = 5000) // æ¯5ç§’
    public void processTimedBatch() {
        synchronized (lock) {
            if (!buffer.isEmpty()) {
                processBatch(new ArrayList<>(buffer));
                buffer.clear();
            }
        }
    }
    
    private void processBatch(List<OrderMessage> orders) {
        log.info("æ‰¹é‡å¤„ç† {} æ¡è®¢å•", orders.size());
        
        // æ‰¹é‡æ•°æ®åº“æ“ä½œ
        orderService.batchInsert(orders);
        
        // æ‰¹é‡é€šçŸ¥
        notificationService.batchNotify(orders);
    }
}
```

---

## 6. ğŸŒŠ æµæ§ä¸èƒŒå‹æœºåˆ¶


### 6.1 æ¶ˆè´¹è€…é¢„å–æ§åˆ¶


**âš™ï¸ Prefetch é…ç½®**
```java
@Configuration
public class RabbitConfig {
    
    @Bean
    public SimpleRabbitListenerContainerFactory rabbitListenerContainerFactory() {
        SimpleRabbitListenerContainerFactory factory = 
            new SimpleRabbitListenerContainerFactory();
        factory.setConnectionFactory(connectionFactory());
        
        // æ ¸å¿ƒé…ç½®ï¼šæ§åˆ¶æ¯ä¸ªæ¶ˆè´¹è€…é¢„å–çš„æ¶ˆæ¯æ•°é‡
        factory.setPrefetchCount(10);  // æ¯ä¸ªæ¶ˆè´¹è€…æœ€å¤šé¢„å–10æ¡æ¶ˆæ¯
        
        // å…¶ä»–ç›¸å…³é…ç½®
        factory.setConcurrentConsumers(2);    // æœ€å°‘2ä¸ªå¹¶å‘æ¶ˆè´¹è€…
        factory.setMaxConcurrentConsumers(5); // æœ€å¤š5ä¸ªå¹¶å‘æ¶ˆè´¹è€…
        
        return factory;
    }
}
```

**ğŸ“Š Prefetch å€¼é€‰æ‹©ç­–ç•¥**
```
Prefetch å€¼å»ºè®®ï¼š

å¤„ç†æ—¶é—´çŸ­ (< 100ms)ï¼š
â€¢ Prefetch = 50-100
â€¢ å‡å°‘ç½‘ç»œå¾€è¿”æ¬¡æ•°

å¤„ç†æ—¶é—´ä¸­ç­‰ (100ms-1s)ï¼š
â€¢ Prefetch = 10-20  
â€¢ å¹³è¡¡ååé‡å’Œå†…å­˜å ç”¨

å¤„ç†æ—¶é—´é•¿ (> 1s)ï¼š
â€¢ Prefetch = 1-5
â€¢ é¿å…æ¶ˆæ¯ç§¯å‹åœ¨æ¶ˆè´¹è€…ç«¯
```

### 6.2 èƒŒå‹æœºåˆ¶å®ç°


**ğŸ”„ è‡ªé€‚åº”æµæ§**
```java
@Component
public class AdaptiveConsumer {
    
    private volatile int currentPrefetch = 10;
    private final AtomicInteger processingCount = new AtomicInteger(0);
    
    @RabbitListener(queues = "order.queue")
    public void processOrder(OrderMessage msg) {
        try {
            processingCount.incrementAndGet();
            
            // ç›‘æ§å¤„ç†æ—¶é—´
            long startTime = System.currentTimeMillis();
            
            // å®é™…ä¸šåŠ¡å¤„ç†
            handleOrder(msg);
            
            long processingTime = System.currentTimeMillis() - startTime;
            
            // æ ¹æ®å¤„ç†æ—¶é—´è°ƒæ•´é¢„å–æ•°é‡
            adjustPrefetchCount(processingTime);
            
        } finally {
            processingCount.decrementAndGet();
        }
    }
    
    private void adjustPrefetchCount(long processingTime) {
        if (processingTime > 1000 && currentPrefetch > 5) {
            // å¤„ç†æ…¢ï¼Œå‡å°‘é¢„å–
            currentPrefetch = Math.max(5, currentPrefetch - 1);
            updatePrefetchCount(currentPrefetch);
        } else if (processingTime < 100 && currentPrefetch < 50) {
            // å¤„ç†å¿«ï¼Œå¢åŠ é¢„å–
            currentPrefetch = Math.min(50, currentPrefetch + 1);
            updatePrefetchCount(currentPrefetch);
        }
    }
}
```

### 6.3 æµæ§ç­–ç•¥é…ç½®


**âš¡ å¤šå±‚æ¬¡æµæ§**
```
ç¬¬ä¸€å±‚ï¼šè¿æ¥çº§åˆ«æµæ§
â€¢ æ§åˆ¶æ€»çš„ç½‘ç»œè¿æ¥æ•°
â€¢ é¿å…è¿æ¥èµ„æºè€—å°½

ç¬¬äºŒå±‚ï¼šé€šé“çº§åˆ«æµæ§  
â€¢ æ§åˆ¶æ¯ä¸ªè¿æ¥çš„é€šé“æ•°
â€¢ é™åˆ¶å¹¶å‘æ“ä½œæ•°é‡

ç¬¬ä¸‰å±‚ï¼šæ¶ˆè´¹è€…çº§åˆ«æµæ§
â€¢ æ§åˆ¶Prefetchæ•°é‡
â€¢ é˜²æ­¢æ¶ˆè´¹è€…è¿‡è½½

ç¬¬å››å±‚ï¼šä¸šåŠ¡çº§åˆ«æµæ§
â€¢ æ ¹æ®ä¸šåŠ¡å¤„ç†èƒ½åŠ›åŠ¨æ€è°ƒæ•´
â€¢ å®ç°çœŸæ­£çš„æ™ºèƒ½æµæ§
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ¶ˆæ¯ç§¯å‹ï¼šç”Ÿäº§é€Ÿåº¦ > æ¶ˆè´¹é€Ÿåº¦å¯¼è‡´çš„é˜Ÿåˆ—å †ç§¯
ğŸ”¸ æ¶ˆè´¹è€…ä¼˜åŒ–ï¼šæå‡å•ä¸ªæ¶ˆè´¹è€…å¤„ç†èƒ½åŠ›çš„å…³é”®
ğŸ”¸ æ°´å¹³æ‰©å®¹ï¼šé€šè¿‡å¢åŠ æ¶ˆè´¹è€…æ•°é‡æå‡æ•´ä½“å¤„ç†èƒ½åŠ›
ğŸ”¸ æ­»ä¿¡å¤„ç†ï¼šæ— æ³•æ­£å¸¸å¤„ç†çš„æ¶ˆæ¯çš„å…œåº•æ–¹æ¡ˆ
ğŸ”¸ æµæ§æœºåˆ¶ï¼šé€šè¿‡Prefetchç­‰å‚æ•°æ§åˆ¶æ¶ˆæ¯æµé‡
ğŸ”¸ æ‰¹é‡å¤„ç†ï¼šé€šè¿‡æ‰¹å¤„ç†æå‡ç³»ç»Ÿååé‡
```

### 7.2 å…³é”®è§£å†³æ€è·¯


**ğŸ”¹ è¯Šæ–­é—®é¢˜çš„æ­¥éª¤**
```
æ­¥éª¤1ï¼šç›‘æ§é˜Ÿåˆ—é•¿åº¦å˜åŒ–è¶‹åŠ¿
æ­¥éª¤2ï¼šåˆ†ææ¶ˆè´¹è€…å¤„ç†æ€§èƒ½
æ­¥éª¤3ï¼šæ£€æŸ¥ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ  
æ­¥éª¤4ï¼šè¯„ä¼°ä¸šåŠ¡å¤„ç†é€»è¾‘æ•ˆç‡
æ­¥éª¤5ï¼šç¡®å®šæ‰©å®¹æˆ–ä¼˜åŒ–æ–¹æ¡ˆ
```

**ğŸ”¹ ä¼˜åŒ–ç­–ç•¥é€‰æ‹©**
```
çŸ­æœŸè§£å†³ï¼ˆç´§æ€¥ï¼‰ï¼š
â€¢ å¿«é€Ÿå¢åŠ æ¶ˆè´¹è€…æ•°é‡
â€¢ ä¸´æ—¶æé«˜Prefetchå€¼
â€¢ å¯ç”¨æ‰¹é‡å¤„ç†

é•¿æœŸä¼˜åŒ–ï¼ˆæ ¹æœ¬ï¼‰ï¼š
â€¢ ä¼˜åŒ–æ¶ˆè´¹è€…å¤„ç†é€»è¾‘
â€¢ å®ç°è‡ªé€‚åº”æ‰©ç¼©å®¹
â€¢ å®Œå–„ç›‘æ§å‘Šè­¦æœºåˆ¶
```

### 7.3 æœ€ä½³å®è·µå»ºè®®


**ğŸ’¡ é…ç½®å»ºè®®**
- **é˜Ÿåˆ—é•¿åº¦é™åˆ¶**ï¼šæ ¹æ®å†…å­˜å®¹é‡è®¾ç½®åˆç†ä¸Šé™
- **æ¶ˆè´¹è€…æ•°é‡**ï¼šCPUæ ¸å¿ƒæ•°çš„2-4å€ä½œä¸ºèµ·ç‚¹
- **Prefetchå€¼**ï¼šå¤„ç†æ—¶é—´è¶Šé•¿ï¼Œå€¼åº”è¯¥è¶Šå°
- **æ­»ä¿¡TTL**ï¼šæ ¹æ®ä¸šåŠ¡å®¹å¿åº¦è®¾ç½®ï¼Œé€šå¸¸30-300ç§’

**âš ï¸ å¸¸è§è¯¯åŒº**
```
è¯¯åŒº1ï¼šç›²ç›®å¢åŠ æ¶ˆè´¹è€…æ•°é‡
æ­£è§£ï¼šå…ˆä¼˜åŒ–å•ä¸ªæ¶ˆè´¹è€…æ€§èƒ½ï¼Œå†è€ƒè™‘æ‰©å®¹

è¯¯åŒº2ï¼šPrefetchå€¼è®¾ç½®è¿‡å¤§
æ­£è§£ï¼šæ ¹æ®å¤„ç†æ—¶é—´å’Œå†…å­˜æƒ…å†µåˆç†è®¾ç½®

è¯¯åŒº3ï¼šå¿½ç•¥æ­»ä¿¡é˜Ÿåˆ—ç›‘æ§
æ­£è§£ï¼šæ­»ä¿¡ç§¯å‹åŒæ ·éœ€è¦åŠæ—¶å¤„ç†

è¯¯åŒº4ï¼šåªå…³æ³¨å³°å€¼ï¼Œå¿½ç•¥å¹³å‡å€¼
æ­£è§£ï¼šæŒ‰å¹³å‡è´Ÿè½½é…ç½®ï¼Œç”¨å¼¹æ€§æ‰©å®¹åº”å¯¹å³°å€¼
```

### 7.4 ç›‘æ§å‘Šè­¦æŒ‡æ ‡


| ç›‘æ§æŒ‡æ ‡ | **æ­£å¸¸èŒƒå›´** | **å‘Šè­¦é˜ˆå€¼** | **å¤„ç†å»ºè®®** |
|---------|-------------|-------------|-------------|
| ğŸ“Š **é˜Ÿåˆ—é•¿åº¦** | `< 1000æ¡` | `> 5000æ¡` | `ç«‹å³æ‰©å®¹æ¶ˆè´¹è€…` |
| â±ï¸ **æ¶ˆæ¯å»¶è¿Ÿ** | `< 30ç§’` | `> 120ç§’` | `æ£€æŸ¥å¤„ç†é€»è¾‘` |
| ğŸ’¾ **å†…å­˜ä½¿ç”¨** | `< 70%` | `> 85%` | `å¢åŠ é˜Ÿåˆ—é™åˆ¶` |
| ğŸ”„ **æ­»ä¿¡ç‡** | `< 1%` | `> 5%` | `æ’æŸ¥ä¸šåŠ¡é€»è¾‘` |

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- ç§¯å‹é—®é¢˜è¦é¢„é˜²ï¼Œç›‘æ§å‘Šè­¦æ˜¯å…³é”®
- æ¶ˆè´¹èƒ½åŠ›è¦æå‡ï¼Œæ‰©å®¹ä¼˜åŒ–å¹¶è¡Œ
- æ­»ä¿¡æœºåˆ¶åšå…œåº•ï¼Œæµæ§èƒŒå‹ä¿ç¨³å®š
- æ‰¹é‡å¤„ç†ææ•ˆç‡ï¼Œè‡ªé€‚åº”è°ƒæ•´æœ€æ™ºèƒ½