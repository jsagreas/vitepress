---
title: 22ã€Federationè”é‚¦é—®é¢˜
---
## ğŸ“š ç›®å½•

1. [Federationè”é‚¦æ¦‚å¿µç†è§£](#1-Federationè”é‚¦æ¦‚å¿µç†è§£)
2. [è”é‚¦é…ç½®é—®é¢˜è¯Šæ–­](#2-è”é‚¦é…ç½®é—®é¢˜è¯Šæ–­)
3. [ç½‘ç»œè¿æ¥ä¸è®¤è¯é—®é¢˜](#3-ç½‘ç»œè¿æ¥ä¸è®¤è¯é—®é¢˜)
4. [æ¶ˆæ¯è½¬å‘ä¸æ€§èƒ½é—®é¢˜](#4-æ¶ˆæ¯è½¬å‘ä¸æ€§èƒ½é—®é¢˜)
5. [ç›‘æ§ä¸æ•…éšœå¤„ç†](#5-ç›‘æ§ä¸æ•…éšœå¤„ç†)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ Federationè”é‚¦æ¦‚å¿µç†è§£


### 1.1 ä»€ä¹ˆæ˜¯RabbitMQè”é‚¦


**é€šä¿—è§£é‡Š**ï¼šæƒ³è±¡ä¸€ä¸‹å¤šä¸ªåŸå¸‚çš„é‚®å±€ç³»ç»Ÿï¼Œæ¯ä¸ªåŸå¸‚éƒ½æœ‰è‡ªå·±çš„é‚®å±€ï¼ˆRabbitMQèŠ‚ç‚¹ï¼‰ï¼Œä½†æ˜¯å®ƒä»¬ä¹‹é—´éœ€è¦äº’ç›¸è½¬å‘é‚®ä»¶ã€‚Federationå°±åƒæ˜¯å»ºç«‹äº†åŸå¸‚é—´çš„é‚®ä»¶è½¬å‘åè®®ï¼Œè®©ä¸åŒåœ°åŒºçš„é‚®å±€èƒ½å¤Ÿåä½œå¤„ç†é‚®ä»¶ã€‚

```
ç®€å•ç†è§£è”é‚¦çš„ä½œç”¨ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    è½¬å‘æ¶ˆæ¯    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åŒ—äº¬æœºæˆ¿    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”‚  ä¸Šæµ·æœºæˆ¿    â”‚
â”‚ RabbitMQ-A  â”‚              â”‚ RabbitMQ-B  â”‚
â”‚ Exchange: X â”‚              â”‚ Exchange: X â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å½“æ¶ˆæ¯å‘åˆ°åŒ—äº¬çš„Exchange Xæ—¶ï¼Œå¯ä»¥è‡ªåŠ¨è½¬å‘åˆ°ä¸Šæµ·çš„Exchange X
```

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- **ä¸Šæ¸¸èŠ‚ç‚¹ï¼ˆUpstreamï¼‰**ï¼šæ¶ˆæ¯çš„æºå¤´ï¼Œæ¯”å¦‚åŒ—äº¬æœºæˆ¿
- **ä¸‹æ¸¸èŠ‚ç‚¹ï¼ˆDownstreamï¼‰**ï¼šæ¥æ”¶æ¶ˆæ¯çš„ç›®æ ‡ï¼Œæ¯”å¦‚ä¸Šæµ·æœºæˆ¿
- **è”é‚¦é“¾æ¥ï¼ˆFederation Linkï¼‰**ï¼šè¿æ¥ä¸Šä¸‹æ¸¸çš„"ç®¡é“"
- **è”é‚¦Exchange**ï¼šå‚ä¸è”é‚¦çš„äº¤æ¢å™¨

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦Federation


**å®é™…åº”ç”¨åœºæ™¯**ï¼š

**ğŸ¢ è·¨æœºæˆ¿éƒ¨ç½²**
```
åœºæ™¯ï¼šå…¬å¸åœ¨åŒ—äº¬ã€ä¸Šæµ·éƒ½æœ‰æœºæˆ¿
é—®é¢˜ï¼šä¸¤åœ°çš„åº”ç”¨éœ€è¦å…±äº«æ¶ˆæ¯
è§£å†³ï¼šé€šè¿‡Federationè®©ä¸¤åœ°RabbitMQåä½œ

ç”Ÿäº§è€…(åŒ—äº¬) â†’ Exchange(åŒ—äº¬) â†’ Federation â†’ Exchange(ä¸Šæµ·) â†’ æ¶ˆè´¹è€…(ä¸Šæµ·)
```

**ğŸŒ å¼‚åœ°å¤‡ä»½**
```
ä¸»æœºæˆ¿ï¼šå¤„ç†æ—¥å¸¸ä¸šåŠ¡æ¶ˆæ¯
å¤‡æœºæˆ¿ï¼šæ¥æ”¶ä¸»æœºæˆ¿çš„æ¶ˆæ¯å‰¯æœ¬ï¼Œç”¨äºç¾å¤‡

ä¸»æœºæˆ¿æ•…éšœæ—¶ï¼Œå¤‡æœºæˆ¿å¯ä»¥ç»§ç»­æä¾›æœåŠ¡
```

**ğŸ“¡ æ¶ˆæ¯åˆ†å‘**
```
ä¸­å¿ƒèŠ‚ç‚¹ï¼šæ¥æ”¶æ‰€æœ‰æ¶ˆæ¯
åˆ†æ”¯èŠ‚ç‚¹ï¼šå„è‡ªå¤„ç†ç‰¹å®šåŒºåŸŸçš„æ¶ˆæ¯

ä¸­å¿ƒ â†’ ååŒ—åˆ†æ”¯
     â†’ åå—åˆ†æ”¯  
     â†’ åä¸œåˆ†æ”¯
```

### 1.3 Federation vs Clusterçš„åŒºåˆ«


| ç‰¹æ€§ | **Federationè”é‚¦** | **Clusteré›†ç¾¤** |
|------|-------------------|----------------|
| **ç½‘ç»œè¦æ±‚** | å¯è·¨å¹¿åŸŸç½‘ï¼Œå®¹å¿ç½‘ç»œä¸­æ–­ | éœ€è¦ç¨³å®šçš„å±€åŸŸç½‘ |
| **æ•°æ®ä¸€è‡´æ€§** | æœ€ç»ˆä¸€è‡´æ€§ | å¼ºä¸€è‡´æ€§ |
| **æ•…éšœå½±å“** | å•ä¸ªèŠ‚ç‚¹æ•…éšœä¸å½±å“å…¶ä»–èŠ‚ç‚¹ | èŠ‚ç‚¹æ•…éšœå¯èƒ½å½±å“æ•´ä¸ªé›†ç¾¤ |
| **ä½¿ç”¨åœºæ™¯** | è·¨æœºæˆ¿ã€å¼‚åœ°éƒ¨ç½² | åŒæœºæˆ¿å†…çš„é«˜å¯ç”¨ |
| **é…ç½®å¤æ‚åº¦** | ç›¸å¯¹ç®€å• | ç›¸å¯¹å¤æ‚ |

---

## 2. ğŸ”§ è”é‚¦é…ç½®é—®é¢˜è¯Šæ–­


### 2.1 è”é‚¦é“¾æ¥é…ç½®é”™è¯¯


**ğŸš¨ å¸¸è§é—®é¢˜**ï¼šè”é‚¦é“¾æ¥æ— æ³•å»ºç«‹

**é—®é¢˜ç°è±¡**ï¼š
```bash
# æŸ¥çœ‹è”é‚¦çŠ¶æ€æ—¶æ˜¾ç¤ºè¿æ¥å¤±è´¥
sudo rabbitmqctl eval 'rabbit_federation_status:status().'

# å¯èƒ½çœ‹åˆ°çš„é”™è¯¯ä¿¡æ¯
{error, {connection_failed, "Connection refused"}}
{error, {authentication_failed, "Access refused for user"}}
```

**ğŸ“‹ è¯Šæ–­æ­¥éª¤**ï¼š

**æ­¥éª¤1ï¼šæ£€æŸ¥è”é‚¦æ’ä»¶æ˜¯å¦å¯ç”¨**
```bash
# æŸ¥çœ‹æ’ä»¶çŠ¶æ€
sudo rabbitmq-plugins list | grep federation

# å¯ç”¨è”é‚¦æ’ä»¶
sudo rabbitmq-plugins enable rabbitmq_federation
sudo rabbitmq-plugins enable rabbitmq_federation_management
```

**æ­¥éª¤2ï¼šæ£€æŸ¥ä¸Šæ¸¸é…ç½®**
```bash
# æŸ¥çœ‹ä¸Šæ¸¸é…ç½®
sudo rabbitmqctl list_parameters -p /

# æ­£ç¡®çš„ä¸Šæ¸¸é…ç½®ç¤ºä¾‹
sudo rabbitmqctl set_parameter federation-upstream my-upstream \
'{"uri":"amqp://user:pass@upstream-host:5672/%2f","expires":3600000}'
```

**ğŸ” é…ç½®å‚æ•°è¯¦è§£**ï¼š

| å‚æ•° | **è¯´æ˜** | **ç¤ºä¾‹å€¼** |
|------|---------|-----------|
| `uri` | ä¸Šæ¸¸èŠ‚ç‚¹çš„è¿æ¥åœ°å€ | `amqp://user:pass@192.168.1.100:5672/%2f` |
| `expires` | æ¶ˆæ¯è¿‡æœŸæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ | `3600000`ï¼ˆ1å°æ—¶ï¼‰ |
| `message-ttl` | æ¶ˆæ¯ç”Ÿå­˜æ—¶é—´ | `60000`ï¼ˆ1åˆ†é’Ÿï¼‰ |
| `max-hops` | æœ€å¤§è·³è½¬æ¬¡æ•° | `1`ï¼ˆé˜²æ­¢å¾ªç¯ï¼‰ |

### 2.2 ä¸Šæ¸¸Exchangeé…ç½®é—®é¢˜


**âŒ é”™è¯¯é…ç½®ç¤ºä¾‹**ï¼š
```bash
# é”™è¯¯ï¼šExchangeåç§°ä¸åŒ¹é…
# ä¸Šæ¸¸æœ‰ 'orders' Exchangeï¼Œä¸‹æ¸¸é…ç½®æˆäº† 'order'
sudo rabbitmqctl set_parameter federation-upstream orders-upstream \
'{"uri":"amqp://user:pass@upstream:5672","exchange":"order"}'  # åç§°é”™è¯¯
```

**âœ… æ­£ç¡®é…ç½®ç¤ºä¾‹**ï¼š
```bash
# 1. ç¡®ä¿ä¸Šæ¸¸Exchangeå­˜åœ¨
sudo rabbitmqctl -n upstream-node list_exchanges

# 2. æ­£ç¡®é…ç½®è”é‚¦ä¸Šæ¸¸
sudo rabbitmqctl set_parameter federation-upstream orders-upstream \
'{"uri":"amqp://user:pass@upstream:5672","exchange":"orders"}'  # åç§°æ­£ç¡®

# 3. é…ç½®è”é‚¦ç­–ç•¥
sudo rabbitmqctl set_policy fed-orders "^orders$" \
'{"federation-upstream":"orders-upstream"}' --apply-to exchanges
```

**ğŸ”§ é…ç½®éªŒè¯æ–¹æ³•**ï¼š
```bash
# éªŒè¯Exchangeæ˜¯å¦æ­£ç¡®è”é‚¦
sudo rabbitmqctl list_exchanges name policy | grep orders

# åº”è¯¥çœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼š
# orders    fed-orders
```

### 2.3 è”é‚¦ç­–ç•¥é…ç½®ä¸å½“


**ç­–ç•¥é…ç½®çš„ä½œç”¨**ï¼šå‘Šè¯‰RabbitMQå“ªäº›Exchangeéœ€è¦è”é‚¦ï¼Œä»¥åŠå¦‚ä½•è”é‚¦ã€‚

**ğŸ¯ ç­–ç•¥é…ç½®è¦ç´ **ï¼š

**åŸºæœ¬è¯­æ³•**ï¼š
```bash
sudo rabbitmqctl set_policy ç­–ç•¥åç§° "åŒ¹é…æ¨¡å¼" 'è”é‚¦å‚æ•°' --apply-to exchanges
```

**å®é™…ç¤ºä¾‹**ï¼š
```bash
# ä¸ºæ‰€æœ‰ä»¥ 'fed.' å¼€å¤´çš„Exchangeé…ç½®è”é‚¦
sudo rabbitmqctl set_policy fed-policy "^fed\." \
'{"federation-upstream-set":"all"}' --apply-to exchanges

# ä¸ºç‰¹å®šExchangeé…ç½®è”é‚¦
sudo rabbitmqctl set_policy orders-fed "^orders$" \
'{"federation-upstream":"orders-upstream"}' --apply-to exchanges
```

**âš ï¸ å¸¸è§é…ç½®é”™è¯¯**ï¼š

| é”™è¯¯ç±»å‹ | **é”™è¯¯ç¤ºä¾‹** | **æ­£ç¡®åšæ³•** |
|---------|-------------|-------------|
| æ­£åˆ™è¡¨è¾¾å¼é”™è¯¯ | `"orders"` | `"^orders$"` |
| å‚æ•°æ ¼å¼é”™è¯¯ | `"federation-upstream:upstream"` | `'{"federation-upstream":"upstream"}'` |
| åº”ç”¨å¯¹è±¡é”™è¯¯ | `--apply-to queues` | `--apply-to exchanges` |

---

## 3. ğŸŒ ç½‘ç»œè¿æ¥ä¸è®¤è¯é—®é¢˜


### 3.1 ç½‘ç»œè¿æ¥ä¸­æ–­è¯Šæ–­


**ğŸ” ç½‘ç»œè¿æ¥æ£€æŸ¥æ¸…å•**ï¼š

**æ­¥éª¤1ï¼šåŸºç¡€ç½‘ç»œè¿é€šæ€§**
```bash
# æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
ping upstream-host

# æ£€æŸ¥ç«¯å£è¿é€šæ€§  
telnet upstream-host 5672
# æˆ–è€…ä½¿ç”¨
nc -zv upstream-host 5672
```

**æ­¥éª¤2ï¼šé˜²ç«å¢™æ£€æŸ¥**
```bash
# æ£€æŸ¥æœ¬åœ°é˜²ç«å¢™çŠ¶æ€
sudo ufw status
# æˆ–è€…
sudo iptables -L

# æ£€æŸ¥RabbitMQç«¯å£æ˜¯å¦å¼€æ”¾
sudo netstat -tlnp | grep 5672
```

**æ­¥éª¤3ï¼šRabbitMQæœåŠ¡çŠ¶æ€**
```bash
# æ£€æŸ¥ä¸Šæ¸¸èŠ‚ç‚¹æœåŠ¡çŠ¶æ€
sudo rabbitmqctl -n upstream-node status

# æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦å¯è¾¾
sudo rabbitmqctl -n upstream-node ping
```

**ğŸ“Š ç½‘ç»œé—®é¢˜æ’æŸ¥æµç¨‹å›¾**ï¼š
```
ç½‘ç»œè¿æ¥é—®é¢˜
    â†“
1. ping ç›®æ ‡ä¸»æœº
    â†“ (å¤±è´¥)
æ£€æŸ¥è·¯ç”±/DNS
    â†“ (æˆåŠŸ)
2. telnet ç›®æ ‡ç«¯å£
    â†“ (å¤±è´¥)  
æ£€æŸ¥é˜²ç«å¢™/ç«¯å£
    â†“ (æˆåŠŸ)
3. æ£€æŸ¥RabbitMQæœåŠ¡
    â†“ (å¤±è´¥)
å¯åŠ¨RabbitMQæœåŠ¡
    â†“ (æˆåŠŸ)
4. æ£€æŸ¥è®¤è¯é…ç½®
```

### 3.2 è®¤è¯å‡­æ®é…ç½®é”™è¯¯


**ğŸ” è®¤è¯é—®é¢˜çš„å¸¸è§è¡¨ç°**ï¼š

**é”™è¯¯æ—¥å¿—ç¤ºä¾‹**ï¼š
```
{error, {authentication_failed, "Access refused for user 'feduser'"}}
{error, {authorization_failed, "User 'feduser' lacks configure permission"}}
```

**ğŸ“ è®¤è¯é…ç½®æ­¥éª¤**ï¼š

**æ­¥éª¤1ï¼šåˆ›å»ºè”é‚¦ä¸“ç”¨ç”¨æˆ·**
```bash
# åœ¨ä¸Šæ¸¸èŠ‚ç‚¹åˆ›å»ºç”¨æˆ·
sudo rabbitmqctl add_user feduser fedpassword

# è®¾ç½®ç”¨æˆ·æƒé™ï¼ˆé‡è¦ï¼šéœ€è¦configureã€readã€writeæƒé™ï¼‰
sudo rabbitmqctl set_permissions -p / feduser ".*" ".*" ".*"

# ä¸ºç”¨æˆ·è®¾ç½®æ ‡ç­¾ï¼ˆå¯é€‰ï¼Œä½†æ¨èï¼‰
sudo rabbitmqctl set_user_tags feduser federation
```

**æ­¥éª¤2ï¼šéªŒè¯ç”¨æˆ·æƒé™**
```bash
# æŸ¥çœ‹ç”¨æˆ·æƒé™
sudo rabbitmqctl list_user_permissions feduser

# åº”è¯¥çœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼š
# vhost   configure   write   read
# /       .*          .*      .*
```

**æ­¥éª¤3ï¼šæµ‹è¯•è¿æ¥**
```bash
# ä½¿ç”¨åˆ›å»ºçš„ç”¨æˆ·æµ‹è¯•è¿æ¥
rabbitmqadmin -H upstream-host -u feduser -p fedpassword list exchanges
```

**ğŸ”§ æƒé™è¯´æ˜è¡¨**ï¼š

| æƒé™ç±»å‹ | **ä½œç”¨** | **è”é‚¦éœ€è¦çš„æƒé™** |
|---------|---------|------------------|
| `configure` | åˆ›å»º/åˆ é™¤èµ„æº | `.*`ï¼ˆéœ€è¦åˆ›å»ºå†…éƒ¨é˜Ÿåˆ—ï¼‰ |
| `write` | å‘å¸ƒæ¶ˆæ¯ | `.*`ï¼ˆéœ€è¦å‘å¸ƒè½¬å‘çš„æ¶ˆæ¯ï¼‰ |
| `read` | æ¶ˆè´¹æ¶ˆæ¯ | `.*`ï¼ˆéœ€è¦è¯»å–ä¸Šæ¸¸æ¶ˆæ¯ï¼‰ |

### 3.3 SSL/TLSè¿æ¥é—®é¢˜


**ğŸ”’ AMQPSè¿æ¥é…ç½®**ï¼š

**æ­£ç¡®çš„SSLè¿æ¥URIæ ¼å¼**ï¼š
```bash
# åŸºæœ¬AMQPSè¿æ¥
"amqps://feduser:fedpass@upstream-host:5671/%2f"

# å¸¦è¯ä¹¦éªŒè¯çš„è¿æ¥
"amqps://feduser:fedpass@upstream-host:5671/%2f?cacertfile=/path/to/ca.pem&certfile=/path/to/client.crt&keyfile=/path/to/client.key"
```

**SSLé—®é¢˜è¯Šæ–­**ï¼š
```bash
# æµ‹è¯•SSLè¿æ¥
openssl s_client -connect upstream-host:5671

# æ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæ€§
openssl x509 -in /path/to/cert.pem -text -noout
```

---

## 4. ğŸ“¡ æ¶ˆæ¯è½¬å‘ä¸æ€§èƒ½é—®é¢˜


### 4.1 æ¶ˆæ¯è½¬å‘å»¶è¿Ÿåˆ†æ


**ğŸŒ è½¬å‘å»¶è¿Ÿçš„å¸¸è§åŸå› **ï¼š

**ç½‘ç»œå»¶è¿Ÿ**ï¼š
```
åŸå› ï¼šè·¨åœ°åŸŸç½‘ç»œå»¶è¿Ÿé«˜
è§£å†³ï¼š
- é€‰æ‹©æ›´è¿‘çš„èŠ‚ç‚¹
- ä½¿ç”¨ä¸“çº¿è¿æ¥
- ä¼˜åŒ–ç½‘ç»œè·¯ç”±
```

**æ¶ˆæ¯ç§¯å‹**ï¼š
```
æ£€æŸ¥å‘½ä»¤ï¼š
sudo rabbitmqctl list_queues name messages

è¯Šæ–­æ–¹æ³•ï¼š
1. æŸ¥çœ‹è”é‚¦å†…éƒ¨é˜Ÿåˆ—ç§¯å‹æƒ…å†µ
2. æ£€æŸ¥ä¸‹æ¸¸æ¶ˆè´¹èƒ½åŠ›
3. ç›‘æ§ç½‘ç»œå¸¦å®½ä½¿ç”¨æƒ…å†µ
```

**ğŸ¯ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**ï¼š

**è°ƒæ•´è”é‚¦å‚æ•°**ï¼š
```bash
# å¢åŠ é¢„å–æ•°é‡ä»¥æé«˜ååé‡
sudo rabbitmqctl set_parameter federation-upstream fast-upstream \
'{"uri":"amqp://user:pass@upstream:5672","prefetch-count":1000}'

# è®¾ç½®æ¶ˆæ¯æ‰¹é‡å¤§å°
sudo rabbitmqctl set_parameter federation-upstream batch-upstream \
'{"uri":"amqp://user:pass@upstream:5672","ack-mode":"on-publish"}'
```

**å‚æ•°è°ƒä¼˜è¡¨**ï¼š

| å‚æ•° | **é»˜è®¤å€¼** | **ä¼˜åŒ–å»ºè®®** | **é€‚ç”¨åœºæ™¯** |
|------|-----------|-------------|-------------|
| `prefetch-count` | 1000 | æ ¹æ®ç½‘ç»œæƒ…å†µè°ƒæ•´ | é«˜ååé‡åœºæ™¯ |
| `reconnect-delay` | 5 | ç¼©çŸ­é‡è¿å»¶è¿Ÿ | ç½‘ç»œä¸ç¨³å®šç¯å¢ƒ |
| `ack-mode` | `on-confirm` | `on-publish`ï¼ˆé£é™©è¾ƒé«˜ä½†æ›´å¿«ï¼‰ | å¯¹ä¸¢å¤±å®¹å¿åº¦é«˜çš„åœºæ™¯ |

### 4.2 å¾ªç¯è”é‚¦æ£€æµ‹ä¸é¢„é˜²


**âš ï¸ å¾ªç¯è”é‚¦çš„å±å®³**ï¼šæ¶ˆæ¯åœ¨èŠ‚ç‚¹é—´æ— é™å¾ªç¯ï¼Œå¯¼è‡´æ¶ˆæ¯é£æš´ã€‚

**å¾ªç¯ç¤ºä¾‹**ï¼š
```
èŠ‚ç‚¹A â†’ èŠ‚ç‚¹B â†’ èŠ‚ç‚¹C â†’ èŠ‚ç‚¹A ï¼ˆå½¢æˆå¾ªç¯ï¼‰
```

**ğŸ›¡ï¸ é¢„é˜²æªæ–½**ï¼š

**æ–¹æ³•1ï¼šè®¾ç½®æœ€å¤§è·³æ•°**
```bash
sudo rabbitmqctl set_parameter federation-upstream safe-upstream \
'{"uri":"amqp://user:pass@upstream:5672","max-hops":1}'
```

**æ–¹æ³•2ï¼šä½¿ç”¨å•å‘è”é‚¦**
```
è®¾è®¡åŸåˆ™ï¼š
ä¸»æœºæˆ¿ â†’ åˆ†æ”¯æœºæˆ¿ ï¼ˆåªèƒ½å•å‘è½¬å‘ï¼‰
é¿å…ï¼šåˆ†æ”¯æœºæˆ¿ â†’ ä¸»æœºæˆ¿ çš„åå‘è”é‚¦
```

**æ–¹æ³•3ï¼šç›‘æ§æ¶ˆæ¯å¤´**
```bash
# æ£€æŸ¥æ¶ˆæ¯çš„è”é‚¦ä¿¡æ¯
sudo rabbitmqctl eval 'rabbit_federation_util:federation_info_to_headers([]).'
```

### 4.3 æ€§èƒ½å½±å“è¯„ä¼°


**ğŸ“Š æ€§èƒ½ç›‘æ§æŒ‡æ ‡**ï¼š

**å…³é”®æŒ‡æ ‡è¡¨**ï¼š

| æŒ‡æ ‡ç±»å‹ | **ç›‘æ§é¡¹** | **æ­£å¸¸èŒƒå›´** | **å¼‚å¸¸é˜ˆå€¼** |
|---------|-----------|-------------|-------------|
| å»¶è¿Ÿ | æ¶ˆæ¯è½¬å‘å»¶è¿Ÿ | < 100ms | > 1000ms |
| ååé‡ | æ¯ç§’è½¬å‘æ¶ˆæ¯æ•° | æ ¹æ®ä¸šåŠ¡éœ€æ±‚ | ä½äºæœŸæœ›50% |
| é”™è¯¯ç‡ | è½¬å‘å¤±è´¥ç‡ | < 0.1% | > 1% |
| èµ„æº | CPU/å†…å­˜ä½¿ç”¨ç‡ | < 70% | > 90% |

**æ€§èƒ½æµ‹è¯•è„šæœ¬**ï¼š
```bash
# ç®€å•æ€§èƒ½æµ‹è¯•
for i in {1..1000}; do
  rabbitmqadmin publish exchange=fed.test routing_key=test payload="test message $i"
done

# ç›‘æ§è½¬å‘æƒ…å†µ
watch -n 1 'rabbitmqctl list_queues name messages'
```

---

## 5. ğŸ“Š ç›‘æ§ä¸æ•…éšœå¤„ç†


### 5.1 è”é‚¦çŠ¶æ€ç›‘æ§


**ğŸ” ç›‘æ§å‘½ä»¤å¤§å…¨**ï¼š

**åŸºç¡€çŠ¶æ€æ£€æŸ¥**ï¼š
```bash
# æŸ¥çœ‹è”é‚¦çŠ¶æ€æ€»è§ˆ
sudo rabbitmqctl eval 'rabbit_federation_status:status().'

# æŸ¥çœ‹è”é‚¦é“¾æ¥çŠ¶æ€
sudo rabbitmqctl eval 'rabbit_federation_link:list().'

# æŸ¥çœ‹è”é‚¦å‚æ•°
sudo rabbitmqctl list_parameters
```

**è¯¦ç»†ä¿¡æ¯æŸ¥çœ‹**ï¼š
```bash
# æŸ¥çœ‹ç‰¹å®šExchangeçš„è”é‚¦ä¿¡æ¯
sudo rabbitmqctl list_exchanges name policy federation_info

# æŸ¥çœ‹è”é‚¦å†…éƒ¨é˜Ÿåˆ—
sudo rabbitmqctl list_queues name | grep 'federation:'
```

**ğŸ“ˆ Webç®¡ç†ç•Œé¢ç›‘æ§**ï¼š

åœ¨RabbitMQç®¡ç†ç•Œé¢ä¸­ï¼š
1. è¿›å…¥ **Admin** â†’ **Federation Status**
2. æŸ¥çœ‹ **Federation Links** çŠ¶æ€
3. ç›‘æ§ **Federation Queues** çš„æ¶ˆæ¯å †ç§¯

**çŠ¶æ€è¯´æ˜è¡¨**ï¼š

| çŠ¶æ€ | **å«ä¹‰** | **å¤„ç†å»ºè®®** |
|------|---------|-------------|
| `running` | è”é‚¦æ­£å¸¸è¿è¡Œ | ç»§ç»­ç›‘æ§ |
| `{error, econnrefused}` | è¿æ¥è¢«æ‹’ç» | æ£€æŸ¥ç½‘ç»œå’ŒæœåŠ¡ |
| `{error, access_refused}` | è®¤è¯å¤±è´¥ | æ£€æŸ¥ç”¨æˆ·æƒé™ |
| `{error, not_found}` | èµ„æºä¸å­˜åœ¨ | æ£€æŸ¥Exchangeé…ç½® |

### 5.2 æ•…éšœè½¬ç§»æœºåˆ¶


**ğŸ”„ è‡ªåŠ¨æ•…éšœè½¬ç§»é…ç½®**ï¼š

**å¤šä¸Šæ¸¸é…ç½®**ï¼š
```bash
# é…ç½®ä¸»ä¸Šæ¸¸
sudo rabbitmqctl set_parameter federation-upstream primary-upstream \
'{"uri":"amqp://user:pass@primary:5672"}'

# é…ç½®å¤‡ç”¨ä¸Šæ¸¸  
sudo rabbitmqctl set_parameter federation-upstream backup-upstream \
'{"uri":"amqp://user:pass@backup:5672"}'

# é…ç½®ä¸Šæ¸¸é›†åˆï¼ˆå®ç°æ•…éšœè½¬ç§»ï¼‰
sudo rabbitmqctl set_parameter federation-upstream-set ha-upstreams \
'[{"upstream":"primary-upstream"},{"upstream":"backup-upstream"}]'

# åº”ç”¨æ•…éšœè½¬ç§»ç­–ç•¥
sudo rabbitmqctl set_policy ha-fed "^ha\." \
'{"federation-upstream-set":"ha-upstreams"}' --apply-to exchanges
```

**æ•…éšœè½¬ç§»é€»è¾‘**ï¼š
```
1. ä¼˜å…ˆè¿æ¥ primary-upstream
2. primary å¤±è´¥æ—¶ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ° backup-upstream  
3. primary æ¢å¤åï¼Œå¯é…ç½®æ˜¯å¦è‡ªåŠ¨åˆ‡å›
```

### 5.3 æ•…éšœæ’æŸ¥æµç¨‹


**ğŸ”§ ç³»ç»ŸåŒ–æ’æŸ¥æ­¥éª¤**ï¼š

**æ­¥éª¤1ï¼šç¡®è®¤é—®é¢˜èŒƒå›´**
```bash
# æ£€æŸ¥æ‰€æœ‰è”é‚¦çŠ¶æ€
sudo rabbitmqctl eval 'rabbit_federation_status:status().'

# è¯†åˆ«é—®é¢˜è”é‚¦é“¾æ¥
sudo rabbitmqctl list_exchanges name policy | grep -v "^$"
```

**æ­¥éª¤2ï¼šæ£€æŸ¥åŸºç¡€è®¾æ–½**
```bash
# ç½‘ç»œè¿é€šæ€§
ping upstream-host && telnet upstream-host 5672

# æœåŠ¡çŠ¶æ€
sudo rabbitmqctl status

# èµ„æºä½¿ç”¨æƒ…å†µ
sudo rabbitmqctl environment | grep memory
```

**æ­¥éª¤3ï¼šæ£€æŸ¥é…ç½®**
```bash
# éªŒè¯è”é‚¦é…ç½®
sudo rabbitmqctl list_parameters

# éªŒè¯ç­–ç•¥é…ç½®
sudo rabbitmqctl list_policies
```

**æ­¥éª¤4ï¼šæŸ¥çœ‹æ—¥å¿—**
```bash
# æŸ¥çœ‹RabbitMQæ—¥å¿—
sudo tail -f /var/log/rabbitmq/rabbit@hostname.log

# è¿‡æ»¤è”é‚¦ç›¸å…³æ—¥å¿—
sudo grep -i federation /var/log/rabbitmq/rabbit@hostname.log
```

**ğŸš¨ å¸¸è§æ•…éšœè§£å†³æ–¹æ¡ˆ**ï¼š

| æ•…éšœç°è±¡ | **å¯èƒ½åŸå› ** | **è§£å†³æ–¹æ¡ˆ** |
|---------|-------------|-------------|
| è”é‚¦é“¾æ¥ä¸€ç›´é‡è¿ | ç½‘ç»œä¸ç¨³å®š | å¢åŠ  `reconnect-delay` å‚æ•° |
| æ¶ˆæ¯ä¸¢å¤± | `ack-mode` é…ç½®ä¸å½“ | æ”¹ä¸º `on-confirm` æ¨¡å¼ |
| æ€§èƒ½ä¸‹é™ | é¢„å–æ•°é‡è¿‡å° | å¢åŠ  `prefetch-count` |
| å†…å­˜å ç”¨é«˜ | æ¶ˆæ¯ç§¯å‹ | æ£€æŸ¥ä¸‹æ¸¸æ¶ˆè´¹èƒ½åŠ› |

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Federationæœ¬è´¨ï¼šè·¨èŠ‚ç‚¹çš„æ¶ˆæ¯è½¬å‘æœºåˆ¶ï¼Œé€‚ç”¨äºå¼‚åœ°éƒ¨ç½²
ğŸ”¸ æ ¸å¿ƒç»„ä»¶ï¼šä¸Šæ¸¸èŠ‚ç‚¹ã€ä¸‹æ¸¸èŠ‚ç‚¹ã€è”é‚¦é“¾æ¥ã€è”é‚¦ç­–ç•¥
ğŸ”¸ é…ç½®è¦ç´ ï¼šæ­£ç¡®çš„URIã€åˆé€‚çš„æƒé™ã€åŒ¹é…çš„ç­–ç•¥
ğŸ”¸ ç›‘æ§é‡ç‚¹ï¼šé“¾æ¥çŠ¶æ€ã€è½¬å‘æ€§èƒ½ã€é”™è¯¯ç‡ã€èµ„æºä½¿ç”¨
ğŸ”¸ æ•…éšœé¢„é˜²ï¼šé¿å…å¾ªç¯è”é‚¦ã€é…ç½®æ•…éšœè½¬ç§»ã€å®šæœŸç›‘æ§
```

### 6.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ Federation vs Clusterçš„é€‰æ‹©**
```
é€‰æ‹©Federationçš„åœºæ™¯ï¼š
- è·¨åœ°åŸŸéƒ¨ç½²ï¼ˆå¦‚åŒ—äº¬-ä¸Šæµ·ï¼‰
- ç½‘ç»œä¸ç¨³å®šç¯å¢ƒ
- éœ€è¦æ¾è€¦åˆçš„æ¶æ„
- ç¾å¤‡å’Œå®¹é”™éœ€æ±‚

é€‰æ‹©Clusterçš„åœºæ™¯ï¼š
- åŒæœºæˆ¿å†…çš„é«˜å¯ç”¨
- éœ€è¦å¼ºä¸€è‡´æ€§
- ç½‘ç»œç¨³å®šçš„ç¯å¢ƒ
```

**ğŸ”¹ é…ç½®çš„é‡è¦æ€§**
```
é…ç½®é”™è¯¯æ˜¯è”é‚¦é—®é¢˜çš„ä¸»è¦åŸå› ï¼š
- URIæ ¼å¼å¿…é¡»æ­£ç¡®
- ç”¨æˆ·æƒé™å¿…é¡»å®Œæ•´ï¼ˆconfigureã€readã€writeï¼‰
- ç­–ç•¥åŒ¹é…æ¨¡å¼è¦å‡†ç¡®
- å‚æ•°æ ¼å¼è¦ç¬¦åˆJSONè§„èŒƒ
```

**ğŸ”¹ æ€§èƒ½ä¸å¯é æ€§çš„å¹³è¡¡**
```
é«˜æ€§èƒ½é…ç½®ï¼š
- å¢åŠ prefetch-count
- ä½¿ç”¨on-publishç¡®è®¤æ¨¡å¼
- å‡å°‘ç½‘ç»œå¾€è¿”æ¬¡æ•°

é«˜å¯é æ€§é…ç½®ï¼š
- ä½¿ç”¨on-confirmç¡®è®¤æ¨¡å¼
- é…ç½®å¤šä¸ªä¸Šæ¸¸å®ç°æ•…éšœè½¬ç§»
- è®¾ç½®åˆç†çš„é‡è¿å»¶è¿Ÿ
```

### 6.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ æœ€ä½³å®è·µ**
- **ç½‘ç»œè§„åˆ’**ï¼šç¡®ä¿ä¸Šä¸‹æ¸¸èŠ‚ç‚¹é—´ç½‘ç»œç¨³å®šå¯é 
- **æƒé™ç®¡ç†**ï¼šä¸ºè”é‚¦åˆ›å»ºä¸“ç”¨ç”¨æˆ·ï¼Œé¿å…ä½¿ç”¨adminç”¨æˆ·
- **ç›‘æ§å‘Šè­¦**ï¼šå»ºç«‹å®Œå–„çš„ç›‘æ§ä½“ç³»ï¼ŒåŠæ—¶å‘ç°é—®é¢˜
- **æ•…éšœé¢„æ¡ˆ**ï¼šé…ç½®å¤šä¸Šæ¸¸å®ç°è‡ªåŠ¨æ•…éšœè½¬ç§»

**ğŸ”§ å¸¸è§é—®é¢˜é¢„é˜²**
- **é¿å…å¾ªç¯**ï¼šè®¾è®¡å•å‘è”é‚¦æ‹“æ‰‘ï¼Œè®¾ç½®max-hopsé™åˆ¶
- **æ€§èƒ½ä¼˜åŒ–**ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚è°ƒæ•´é¢„å–å’Œç¡®è®¤å‚æ•°
- **å®šæœŸç»´æŠ¤**ï¼šæ£€æŸ¥è”é‚¦çŠ¶æ€ï¼Œæ¸…ç†æ— ç”¨çš„å†…éƒ¨é˜Ÿåˆ—

**æ ¸å¿ƒè®°å¿†**ï¼š
- Federationæ˜¯RabbitMQè·¨èŠ‚ç‚¹åä½œçš„é‡è¦æœºåˆ¶
- é…ç½®æ­£ç¡®æ˜¯è”é‚¦æˆåŠŸçš„å…³é”®
- ç›‘æ§å’Œæ•…éšœè½¬ç§»æ˜¯è”é‚¦å¯é è¿è¡Œçš„ä¿éšœ
- æ€§èƒ½è°ƒä¼˜éœ€è¦ç»“åˆå…·ä½“çš„ä¸šåŠ¡åœºæ™¯