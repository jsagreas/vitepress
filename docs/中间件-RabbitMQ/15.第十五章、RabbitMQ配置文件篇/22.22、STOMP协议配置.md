---
title: 22、STOMP协议配置
---
## 📚 目录

1. [STOMP协议基础概念](#1-STOMP协议基础概念)
2. [STOMP监听器配置](#2-STOMP监听器配置)
3. [用户认证与安全配置](#3-用户认证与安全配置)
4. [跨域与Web集成配置](#4-跨域与Web集成配置)
5. [交换器与消息处理配置](#5-交换器与消息处理配置)
6. [高级功能配置](#6-高级功能配置)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 🌐 STOMP协议基础概念


### 1.1 什么是STOMP协议


**🔸 STOMP协议简介**
```
STOMP = Simple Text Oriented Messaging Protocol
中文：简单文本定向消息协议

通俗理解：
STOMP就像是消息传递的"普通话"
- 简单：用纯文本格式，人类可读
- 通用：各种编程语言都能理解
- 轻量：不需要复杂的二进制解析
```

**💡 为什么需要STOMP**
```
现实类比：
RabbitMQ原生协议 = 专业对讲机（功能强大但复杂）
STOMP协议 = 普通电话（简单易用，人人会用）

适用场景：
✅ Web浏览器直接连接消息队列
✅ 移动应用轻量级消息传递
✅ 简单的发布/订阅模式
✅ 实时聊天、通知推送等
```

### 1.2 STOMP工作原理


**🔄 STOMP消息流程**
```
Web浏览器                RabbitMQ服务器
    |                         |
    |--[CONNECT]------------>|  建立连接
    |<--[CONNECTED]----------|  确认连接
    |                         |
    |--[SUBSCRIBE /topic]--->|  订阅主题
    |<--[MESSAGE]------------|  接收消息
    |                         |
    |--[SEND /queue]-------->|  发送消息
    |                         |
    |--[DISCONNECT]--------->|  断开连接
```

**📋 STOMP消息格式示例**
```
SEND
destination:/queue/test
content-type:text/plain

Hello World!
```

---

## 2. 🔌 STOMP监听器配置


### 2.1 TCP监听器配置


**🔸 基础TCP监听配置**
```bash
# stomp.listeners.tcp - STOMP TCP监听器
stomp.listeners.tcp.default = 61613

# 通俗解释：
# 就像给STOMP协议开了一个专门的"门"
# 61613是STOMP协议的标准端口号
# 客户端通过这个端口连接到RabbitMQ
```

**⚙️ 多端口监听配置**
```bash
# 配置多个TCP监听端口
stomp.listeners.tcp.1 = 61613
stomp.listeners.tcp.2 = 61614

# 实际应用场景：
# 端口61613：给Web应用使用
# 端口61614：给移动应用使用
# 这样可以分别管理不同类型的客户端
```

### 2.2 SSL安全监听器配置


**🔐 SSL监听器基础配置**
```bash
# stomp.listeners.ssl - STOMP SSL监听器
stomp.listeners.ssl.default = 61614

# 通俗理解：
# SSL就像给普通电话加了"加密器"
# 传输的消息都会被加密保护
# 61614是STOMP over SSL的常用端口
```

**🔒 SSL完整配置示例**
```bash
# SSL监听端口
stomp.listeners.ssl.default = 61614

# SSL证书配置（需要配合RabbitMQ主配置）
ssl_options.cacertfile = /path/to/ca_certificate.pem
ssl_options.certfile   = /path/to/server_certificate.pem
ssl_options.keyfile    = /path/to/server_key.pem
ssl_options.verify     = verify_peer
ssl_options.fail_if_no_peer_cert = true

# 使用场景：
# 生产环境必须使用SSL加密
# 防止消息在网络传输中被窃听
```

---

## 3. 👤 用户认证与安全配置


### 3.1 默认用户配置


**🔸 默认用户设置**
```bash
# stomp.default_user - STOMP默认用户
stomp.default_user = guest

# stomp.default_pass - STOMP默认密码  
stomp.default_pass = guest

# 通俗解释：
# 这就像给你的消息系统设置了一个"万能钥匙"
# 当客户端没有提供用户名密码时，就用这个默认账号
# guest/guest是RabbitMQ的出厂默认设置
```

**⚠️ 安全注意事项**
```bash
# 生产环境安全配置
stomp.default_user = stomp_user
stomp.default_pass = your_secure_password_123

# 为什么要修改默认密码？
# guest/guest是公开的默认密码
# 黑客很容易猜到并入侵系统
# 生产环境必须使用强密码
```

### 3.2 用户权限管理


**📊 用户权限配置示例**
```bash
# 创建专门的STOMP用户
rabbitmqctl add_user stomp_user strong_password
rabbitmqctl set_permissions -p / stomp_user ".*" ".*" ".*"

# 权限说明：
# ".*" ".*" ".*" 分别表示：
# 配置权限、写权限、读权限
# ".*" 表示允许所有操作（通配符）
```

---

## 4. 🌍 跨域与Web集成配置


### 4.1 跨域访问配置


**🔸 允许源模式配置**
```bash
# stomp.allow_origin_patterns - 允许源模式
stomp.allow_origin_patterns.*  = *

# 通俗理解：
# 这就像给你家门上装了"访客名单"
# * 表示允许任何网站访问（相当于不设防）
# 实际使用中应该限制特定域名
```

**🎯 生产环境跨域配置**
```bash
# 限制特定域名访问
stomp.allow_origin_patterns.1 = https://myapp.com
stomp.allow_origin_patterns.2 = https://admin.myapp.com
stomp.allow_origin_patterns.3 = http://localhost:3000

# 安全说明：
# 只允许你自己的网站访问消息队列
# 防止其他恶意网站盗用你的消息服务
# localhost:3000 用于本地开发测试
```

### 4.2 SockJS集成配置


**🔸 SockJS URL配置**
```bash
# stomp.sockjs_url - SockJS URL
stomp.sockjs_url = /stomp

# 什么是SockJS？
# SockJS是一个JavaScript库，提供WebSocket的备选方案
# 当WebSocket不可用时，自动降级到其他传输方式
# 就像"智能网络适配器"，确保连接稳定
```

**🌐 Web客户端连接示例**
```javascript
// 前端JavaScript代码示例
var client = Stomp.over(new SockJS('http://localhost:15674/stomp'));

client.connect('stomp_user', 'password', function(frame) {
    console.log('连接成功: ' + frame);
    
    // 订阅消息
    client.subscribe('/queue/test', function(message) {
        console.log('收到消息: ' + message.body);
    });
});
```

---

## 5. 📬 交换器与消息处理配置


### 5.1 默认交换器配置


**🔸 默认主题交换器**
```bash
# stomp.default_topic_exchange - 默认主题交换器
stomp.default_topic_exchange = amq.topic

# 通俗理解：
# 交换器就像"邮件分拣中心"
# amq.topic是专门处理主题订阅的分拣中心
# 当你订阅"/topic/news"时，消息会通过这个交换器路由
```

**📋 交换器类型对比**
| 交换器类型 | **说明** | **使用场景** | **STOMP中的应用** |
|-----------|----------|--------------|------------------|
| 🎯 **direct** | `点对点精确匹配` | `任务队列` | `/queue/` 前缀 |
| 📢 **topic** | `主题模式匹配` | `发布订阅` | `/topic/` 前缀 |
| 📻 **fanout** | `广播所有队列` | `系统广播` | `/exchange/` 前缀 |

### 5.2 消息重排队配置


**🔸 NACK重新排队设置**
```bash
# stomp.default_nack_requeue - 默认NACK重新排队
stomp.default_nack_requeue = true

# 什么是NACK？
# NACK = Negative Acknowledgment（否定确认）
# 当消息处理失败时，客户端发送NACK表示"我处理不了"
# true表示把消息重新放回队列，让其他消费者试试
```

**🔄 消息处理流程**
```
消息队列                    消费者                     处理结果
    |                        |                          |
    |--[发送消息]------------>|                          |
    |                        |--[处理消息]------------>|成功
    |<--[ACK确认]-------------|<--[返回成功]------------|
    |                        |                          |
    |--[发送消息]------------>|                          |
    |                        |--[处理消息]------------>|失败
    |<--[NACK拒绝]-----------|<--[返回失败]------------|
    |                        |                          |
    |--[重新排队消息]-------->|（等待其他消费者处理）      |
```

---

## 6. 🔧 高级功能配置


### 6.1 跟踪与调试配置


**🔸 跟踪功能启用**
```bash
# stomp.trace - 跟踪启用
stomp.trace = false

# 跟踪功能说明：
# true：记录所有STOMP协议的交互细节
# false：正常运行，不记录详细日志
# 开发阶段建议开启，生产环境建议关闭
```

**🔍 跟踪日志示例**
```bash
# 开启跟踪后，日志会显示详细信息：
# STOMP CONNECT frame received
# STOMP CONNECTED frame sent  
# STOMP SUBSCRIBE frame received
# STOMP MESSAGE frame sent

# 用途：
# 调试连接问题
# 分析消息流向
# 性能问题排查
```

### 6.2 代理协议配置


**🔸 代理协议支持**
```bash
# stomp.proxy_protocol - 代理协议
stomp.proxy_protocol = false

# 什么是代理协议？
# 当RabbitMQ部署在负载均衡器后面时使用
# 能够获取客户端的真实IP地址
# 就像"透明代理"，保留原始连接信息
```

**🏗️ 代理协议应用架构**
```
客户端                负载均衡器              RabbitMQ
 |                      |                      |
 |--[连接请求]--------->|                      |
 |   IP: 192.168.1.100  |                      |
 |                      |--[转发+真实IP]----->|
 |                      |                      |
 |<--[响应]-------------|<--[响应]-------------|
```

---

## 7. 📋 核心要点总结


### 7.1 必须掌握的基本概念


```
🔸 STOMP协议：简单文本消息协议，Web应用的消息传递标准
🔸 监听器配置：TCP和SSL两种连接方式，端口61613/61614
🔸 用户认证：默认用户配置和权限管理
🔸 跨域配置：允许Web浏览器跨域访问消息队列
🔸 交换器配置：默认使用amq.topic处理主题订阅
🔸 消息处理：NACK重排队机制保证消息不丢失
```

### 7.2 关键理解要点


**🔹 STOMP vs 原生AMQP**
```
STOMP协议优势：
✅ 简单易用，文本格式易于调试
✅ Web浏览器原生支持
✅ 跨语言、跨平台兼容性好
✅ 学习成本低

AMQP协议优势：
✅ 功能更强大，支持复杂路由
✅ 性能更高，二进制协议效率好
✅ 更适合企业级应用
✅ 事务支持更完善
```

**🔹 安全配置重点**
```
开发环境：
• 可以使用默认guest/guest
• 允许所有源访问（*）
• 开启跟踪调试

生产环境：
• 必须修改默认密码
• 限制特定域名访问
• 关闭跟踪功能
• 启用SSL加密
```

### 7.3 实际应用价值


**🎯 典型应用场景**
- **实时聊天系统**：Web浏览器直接连接消息队列
- **股票行情推送**：实时数据广播到多个客户端
- **系统监控告警**：服务器状态实时推送到管理界面
- **协同办公系统**：多用户实时协作功能

**🔧 配置最佳实践**
- **端口规划**：TCP用于内网，SSL用于公网
- **用户管理**：为不同应用创建专门的用户账号
- **权限控制**：按最小权限原则分配队列访问权限
- **性能优化**：生产环境关闭不必要的跟踪功能

**核心记忆要点**：
- STOMP让Web应用轻松使用消息队列
- 安全配置是生产环境的重中之重
- 跨域配置决定了哪些网站能访问你的消息服务
- 合理的交换器配置能提高消息路由效率