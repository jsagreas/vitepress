---
title: 15ã€Prometheusç›‘æ§é…ç½®
---
## ğŸ“š ç›®å½•

1. [Prometheusç›‘æ§åŸºç¡€æ¦‚å¿µ](#1-prometheusç›‘æ§åŸºç¡€æ¦‚å¿µ)
2. [RabbitMQç›‘æ§æ’ä»¶å¯ç”¨](#2-rabbitmqç›‘æ§æ’ä»¶å¯ç”¨)
3. [åŸºç¡€ç«¯å£ä¸è¿æ¥é…ç½®](#3-åŸºç¡€ç«¯å£ä¸è¿æ¥é…ç½®)
4. [ç›‘æ§æ•°æ®æ ¼å¼ä¸è·¯å¾„](#4-ç›‘æ§æ•°æ®æ ¼å¼ä¸è·¯å¾„)
5. [æ€§èƒ½ä¼˜åŒ–é…ç½®é€‰é¡¹](#5-æ€§èƒ½ä¼˜åŒ–é…ç½®é€‰é¡¹)
6. [æ¶ˆè´¹è€…ç›‘æ§é…ç½®](#6-æ¶ˆè´¹è€…ç›‘æ§é…ç½®)
7. [è™šæ‹Ÿä¸»æœºç›‘æ§è®¾ç½®](#7-è™šæ‹Ÿä¸»æœºç›‘æ§è®¾ç½®)
8. [ç›´æ–¹å›¾æ¡¶é…ç½®](#8-ç›´æ–¹å›¾æ¡¶é…ç½®)
9. [ç›‘æ§é…ç½®å®æˆ˜æ¡ˆä¾‹](#9-ç›‘æ§é…ç½®å®æˆ˜æ¡ˆä¾‹)
10. [æ•…éšœæ’æŸ¥ä¸ä¼˜åŒ–](#10-æ•…éšœæ’æŸ¥ä¸ä¼˜åŒ–)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” Prometheusç›‘æ§åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Prometheusç›‘æ§


**ğŸŒŸ ç®€å•ç†è§£Prometheus**

Prometheuså°±åƒæ˜¯ä¸€ä¸ª"æ•°æ®æ”¶é›†å‘˜"ï¼Œä¸“é—¨è´Ÿè´£ä»RabbitMQé‚£é‡Œæ”¶é›†å„ç§è¿è¡Œæ•°æ®ï¼Œæ¯”å¦‚ï¼š
- é˜Ÿåˆ—é‡Œæœ‰å¤šå°‘æ¶ˆæ¯
- æœ‰å¤šå°‘æ¶ˆè´¹è€…åœ¨å·¥ä½œ
- ç³»ç»Ÿè¿è¡Œæ˜¯å¦æ­£å¸¸

æƒ³è±¡ä¸€ä¸‹ï¼ŒRabbitMQå°±åƒä¸€ä¸ªå¿™ç¢Œçš„é‚®å±€ï¼ŒPrometheuså°±æ˜¯é‚£ä¸ªè´Ÿè´£ç»Ÿè®¡é‚®å±€è¿è¥æ•°æ®çš„å·¥ä½œäººå‘˜ã€‚

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦ç›‘æ§RabbitMQ


**ğŸ’¡ ç›‘æ§çš„é‡è¦æ€§**

```
å®é™…ä¸šåŠ¡åœºæ™¯ï¼š
ğŸª ç”µå•†ç³»ç»Ÿï¼šè®¢å•æ¶ˆæ¯ç§¯å‹äº†å—ï¼Ÿ
ğŸ“± å³æ—¶é€šè®¯ï¼šæ¶ˆæ¯å‘é€æ˜¯å¦åŠæ—¶ï¼Ÿ
ğŸ’° æ”¯ä»˜ç³»ç»Ÿï¼šå…³é”®æ¶ˆæ¯æœ‰æ²¡æœ‰ä¸¢å¤±ï¼Ÿ

ç›‘æ§èƒ½å‘Šè¯‰æˆ‘ä»¬ï¼š
âœ… ç³»ç»Ÿå¥åº·çŠ¶å†µå¦‚ä½•
âœ… æ€§èƒ½ç“¶é¢ˆåœ¨å“ªé‡Œ  
âœ… ä»€ä¹ˆæ—¶å€™éœ€è¦æ‰©å®¹
âœ… å‡ºé—®é¢˜æ—¶å¿«é€Ÿå®šä½åŸå› 
```

### 1.3 RabbitMQä¸Prometheusçš„å·¥ä½œå…³ç³»


```
å·¥ä½œæµç¨‹ç¤ºæ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â‘ æ”¶é›†æ•°æ®    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RabbitMQ   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚ Prometheus  â”‚
â”‚   æœåŠ¡å™¨     â”‚                 â”‚   ç›‘æ§ç³»ç»Ÿ   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†‘                              â†“
      â”‚                         â‘¡å­˜å‚¨&åˆ†æ
   åº”ç”¨ç¨‹åº                          â†“
   å‘é€æ¶ˆæ¯                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚   Grafana   â”‚
                              â”‚   å¯è§†åŒ–ç•Œé¢ â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç®€å•è¯´å°±æ˜¯ï¼š
RabbitMQæä¾›æ•°æ® â†’ Prometheusæ”¶é›†æ•°æ® â†’ Grafanaå±•ç¤ºå›¾è¡¨
```

---

## 2. ğŸš€ RabbitMQç›‘æ§æ’ä»¶å¯ç”¨


### 2.1 æ£€æŸ¥æ’ä»¶çŠ¶æ€


**ğŸ” æŸ¥çœ‹å½“å‰æ’ä»¶æƒ…å†µ**

é¦–å…ˆéœ€è¦ç¡®è®¤RabbitMQçš„Prometheusæ’ä»¶æ˜¯å¦å·²ç»å®‰è£…å’Œå¯ç”¨ï¼š

```bash
# æŸ¥çœ‹æ‰€æœ‰å¯ç”¨æ’ä»¶
rabbitmq-plugins list

# ä¸“é—¨æŸ¥çœ‹prometheusç›¸å…³æ’ä»¶
rabbitmq-plugins list | grep prometheus
```

ä½ ä¼šçœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„è¾“å‡ºï¼š
```
[  ] rabbitmq_prometheus           3.8.19
```

å‰é¢çš„`[ ]`è¡¨ç¤ºæ’ä»¶æœªå¯ç”¨ï¼Œå¦‚æœæ˜¯`[E]`å°±è¡¨ç¤ºå·²å¯ç”¨ã€‚

### 2.2 å¯ç”¨Prometheusæ’ä»¶


**âš¡ å¯ç”¨ç›‘æ§åŠŸèƒ½**

```bash
# å¯ç”¨prometheusæ’ä»¶
rabbitmq-plugins enable rabbitmq_prometheus

# éªŒè¯æ’ä»¶å·²å¯ç”¨
rabbitmq-plugins list | grep prometheus
# åº”è¯¥æ˜¾ç¤ºï¼š[E] rabbitmq_prometheus
```

> ğŸ’¡ **æ–°æ‰‹æç¤º**ï¼šå¯ç”¨æ’ä»¶åï¼ŒRabbitMQä¼šè‡ªåŠ¨é‡å¯ç›¸å…³æœåŠ¡ï¼Œè¿™æ˜¯æ­£å¸¸ç°è±¡ï¼Œä¸è¦æ‹…å¿ƒã€‚

### 2.3 éªŒè¯ç›‘æ§ç«¯ç‚¹


**âœ… ç¡®è®¤ç›‘æ§æ¥å£å¯ç”¨**

å¯ç”¨æ’ä»¶åï¼Œå¯ä»¥é€šè¿‡æµè§ˆå™¨æˆ–curlå‘½ä»¤æµ‹è¯•ç›‘æ§ç«¯ç‚¹ï¼š

```bash
# æµ‹è¯•é»˜è®¤ç›‘æ§ç«¯ç‚¹
curl http://localhost:15692/metrics

# å¦‚æœçœ‹åˆ°å¤§é‡ä»¥rabbitmqå¼€å¤´çš„æŒ‡æ ‡æ•°æ®ï¼Œè¯´æ˜é…ç½®æˆåŠŸ
```

---

## 3. ğŸ”Œ åŸºç¡€ç«¯å£ä¸è¿æ¥é…ç½®


### 3.1 prometheus.tcp.porté…ç½®


**ğŸšª è®¾ç½®ç›‘æ§æ•°æ®ç«¯å£**

è¿™ä¸ªé…ç½®å†³å®šäº†Prometheusä»å“ªä¸ªç«¯å£è·å–RabbitMQçš„ç›‘æ§æ•°æ®ï¼š

```ini
# åœ¨rabbitmq.confä¸­é…ç½®
prometheus.tcp.port = 15692
```

**ä¸ºä»€ä¹ˆé€‰æ‹©15692ç«¯å£ï¼Ÿ**
- RabbitMQç®¡ç†ç•Œé¢é»˜è®¤æ˜¯15672
- ç›‘æ§ç«¯å£15692ä¸ç®¡ç†ç«¯å£ç›¸è¿‘ï¼Œä¾¿äºè®°å¿†
- é¿å…ä¸å…¶ä»–æœåŠ¡ç«¯å£å†²çª

### 3.2 prometheus.ssl.porté…ç½®


**ğŸ”’ å®‰å…¨è¿æ¥é…ç½®**

å¦‚æœä½ çš„ç¯å¢ƒéœ€è¦SSLåŠ å¯†è¿æ¥ï¼ˆç‰¹åˆ«æ˜¯ç”Ÿäº§ç¯å¢ƒï¼‰ï¼Œå¯ä»¥é…ç½®SSLç«¯å£ï¼š

```ini
# SSLç›‘æ§ç«¯å£é…ç½®
prometheus.ssl.port = 15691

# åŒæ—¶éœ€è¦é…ç½®SSLè¯ä¹¦
ssl_options.cacertfile = /path/to/ca.pem
ssl_options.certfile   = /path/to/server.pem
ssl_options.keyfile    = /path/to/server.key
```

> âš ï¸ **æ³¨æ„**ï¼šSSLé…ç½®éœ€è¦æœ‰æ•ˆçš„è¯ä¹¦æ–‡ä»¶ï¼Œå¦åˆ™ç›‘æ§ä¼šå¤±è´¥ã€‚

### 3.3 ç«¯å£è®¿é—®éªŒè¯


**ğŸ”§ æµ‹è¯•ç«¯å£è¿é€šæ€§**

```bash
# æµ‹è¯•TCPç«¯å£
telnet localhost 15692

# æµ‹è¯•HTTPè®¿é—®
curl -I http://localhost:15692/metrics

# æµ‹è¯•SSLç«¯å£ï¼ˆå¦‚æœé…ç½®äº†ï¼‰
curl -k https://localhost:15691/metrics
```

---

## 4. ğŸ“Š ç›‘æ§æ•°æ®æ ¼å¼ä¸è·¯å¾„


### 4.1 prometheus.pathé…ç½®


**ğŸ›£ï¸ è‡ªå®šä¹‰ç›‘æ§è·¯å¾„**

é»˜è®¤æƒ…å†µä¸‹ï¼Œç›‘æ§æ•°æ®çš„è®¿é—®è·¯å¾„æ˜¯`/metrics`ï¼Œä½†ä½ å¯ä»¥è‡ªå®šä¹‰ï¼š

```ini
# è‡ªå®šä¹‰ç›‘æ§æ•°æ®è·¯å¾„
prometheus.path = /custom/metrics
```

è¿™æ ·é…ç½®åï¼Œè®¿é—®åœ°å€å°±å˜æˆäº†ï¼š`http://localhost:15692/custom/metrics`

**ä»€ä¹ˆæ—¶å€™éœ€è¦è‡ªå®šä¹‰è·¯å¾„ï¼Ÿ**
- å®‰å…¨è€ƒè™‘ï¼šéšè—é»˜è®¤è·¯å¾„
- ç»Ÿä¸€è§„èŒƒï¼šå…¬å¸æœ‰ç»Ÿä¸€çš„ç›‘æ§è·¯å¾„æ ‡å‡†
- é¿å…å†²çªï¼šå½“æœ‰å¤šä¸ªæœåŠ¡ä½¿ç”¨ç›¸åŒè·¯å¾„æ—¶

### 4.2 prometheus.formaté…ç½®


**ğŸ“‹ æ•°æ®æ ¼å¼é€‰æ‹©**

Prometheusæ”¯æŒä¸åŒçš„æ•°æ®æ ¼å¼ï¼š

```ini
# è®¾ç½®æ•°æ®æ ¼å¼ï¼ˆé»˜è®¤æ˜¯prometheusæ ¼å¼ï¼‰
prometheus.format = prometheus

# å¯é€‰æ ¼å¼ï¼š
# prometheus - æ ‡å‡†Prometheusæ ¼å¼
# json - JSONæ ¼å¼ï¼ˆä¾¿äºè°ƒè¯•ï¼‰
```

**æ ¼å¼å¯¹æ¯”**ï¼š

| æ ¼å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| **prometheus** | æ ‡å‡†æ ¼å¼ï¼Œæ€§èƒ½å¥½ | å¯è¯»æ€§å·® | ç”Ÿäº§ç¯å¢ƒ |
| **json** | æ˜“è¯»æ˜“è°ƒè¯• | æ•°æ®é‡å¤§ | å¼€å‘è°ƒè¯• |

### 4.3 ç›‘æ§æ•°æ®ç¤ºä¾‹


**ğŸ“ˆ å®é™…ç›‘æ§æ•°æ®é•¿ä»€ä¹ˆæ ·**

Prometheusæ ¼å¼çš„æ•°æ®ç¤ºä¾‹ï¼š
```
# HELP rabbitmq_queues Total number of queues
# TYPE rabbitmq_queues gauge
rabbitmq_queues{vhost="/"} 5

# HELP rabbitmq_consumers Total number of consumers
# TYPE rabbitmq_consumers gauge
rabbitmq_consumers{vhost="/",queue="user_notifications"} 2
```

JSONæ ¼å¼çš„æ•°æ®ç¤ºä¾‹ï¼š
```json
{
  "rabbitmq_queues": [
    {"vhost": "/", "value": 5}
  ],
  "rabbitmq_consumers": [
    {"vhost": "/", "queue": "user_notifications", "value": 2}
  ]
}
```

---

## 5. âš¡ æ€§èƒ½ä¼˜åŒ–é…ç½®é€‰é¡¹


### 5.1 prometheus.compact_tablesé…ç½®


**ğŸ“¦ æ•°æ®å‹ç¼©ä¼˜åŒ–**

å½“ä½ çš„RabbitMQæœ‰å¤§é‡é˜Ÿåˆ—å’Œäº¤æ¢å™¨æ—¶ï¼Œç›‘æ§æ•°æ®ä¼šå˜å¾—å¾ˆå¤§ã€‚å¯ç”¨å‹ç¼©å¯ä»¥å‡å°‘ç½‘ç»œä¼ è¾“ï¼š

```ini
# å¯ç”¨è¡¨æ ¼æ•°æ®å‹ç¼©
prometheus.compact_tables = true
```

**å‹ç¼©æ•ˆæœå¯¹æ¯”**ï¼š
```
æœªå‹ç¼©ï¼šçº¦100KBç›‘æ§æ•°æ®
å‹ç¼©åï¼šçº¦30-40KBç›‘æ§æ•°æ®
èŠ‚çœï¼š60-70%çš„ä¼ è¾“é‡
```

> ğŸ’¡ **æ–°æ‰‹å»ºè®®**ï¼šå¦‚æœä½ çš„é˜Ÿåˆ—æ•°é‡è¶…è¿‡100ä¸ªï¼Œå»ºè®®å¯ç”¨æ­¤é€‰é¡¹ã€‚

### 5.2 prometheus.return_per_object_metricsé…ç½®


**ğŸ¯ è¯¦ç»†å¯¹è±¡ç›‘æ§**

è¿™ä¸ªé€‰é¡¹æ§åˆ¶æ˜¯å¦ä¸ºæ¯ä¸ªé˜Ÿåˆ—ã€äº¤æ¢å™¨ç­‰å¯¹è±¡è¿”å›è¯¦ç»†æŒ‡æ ‡ï¼š

```ini
# è¿”å›æ¯ä¸ªå¯¹è±¡çš„è¯¦ç»†æŒ‡æ ‡
prometheus.return_per_object_metrics = true
```

**é…ç½®å½±å“**ï¼š

å½“è®¾ç½®ä¸º`true`æ—¶ï¼Œä½ ä¼šå¾—åˆ°ï¼š
- æ¯ä¸ªé˜Ÿåˆ—çš„æ¶ˆæ¯æ•°é‡
- æ¯ä¸ªäº¤æ¢å™¨çš„æ¶ˆæ¯æµé‡
- æ¯ä¸ªè¿æ¥çš„è¯¦ç»†çŠ¶æ€

å½“è®¾ç½®ä¸º`false`æ—¶ï¼Œåªä¼šå¾—åˆ°ï¼š
- æ€»ä½“ç»Ÿè®¡æ•°æ®
- èšåˆæŒ‡æ ‡

**å¦‚ä½•é€‰æ‹©**ï¼š
- **å¼€å‘ç¯å¢ƒ**ï¼šå»ºè®®è®¾ä¸º`true`ï¼Œä¾¿äºè¯¦ç»†è°ƒè¯•
- **ç”Ÿäº§ç¯å¢ƒ**ï¼šæ ¹æ®ç›‘æ§ç³»ç»Ÿè´Ÿè½½å†³å®šï¼Œé˜Ÿåˆ—å¾ˆå¤šæ—¶å¯è®¾ä¸º`false`

---

## 6. ğŸ‘¥ æ¶ˆè´¹è€…ç›‘æ§é…ç½®


### 6.1 prometheus.aggregate_consumer_metricsé…ç½®


**ğŸ“Š æ¶ˆè´¹è€…æŒ‡æ ‡èšåˆ**

è¿™ä¸ªé…ç½®å†³å®šå¦‚ä½•ç»Ÿè®¡æ¶ˆè´¹è€…ç›¸å…³çš„ç›‘æ§æ•°æ®ï¼š

```ini
# èšåˆæ¶ˆè´¹è€…æŒ‡æ ‡
prometheus.aggregate_consumer_metrics = true
```

**èšåˆ vs éèšåˆçš„åŒºåˆ«**ï¼š

**èšåˆæ¨¡å¼ï¼ˆæ¨èï¼‰**ï¼š
```
rabbitmq_consumers_total{vhost="/"} 10
rabbitmq_consumer_utilisation{vhost="/"} 0.85
```

**éèšåˆæ¨¡å¼**ï¼š
```
rabbitmq_consumers{vhost="/",queue="orders"} 3
rabbitmq_consumers{vhost="/",queue="notifications"} 2  
rabbitmq_consumers{vhost="/",queue="emails"} 5
```

### 6.2 æ¶ˆè´¹è€…ç›‘æ§çš„å®ç”¨ä»·å€¼


**ğŸ’¼ ä¸šåŠ¡åœºæ™¯åº”ç”¨**

```
ç”µå•†è®¢å•å¤„ç†åœºæ™¯ï¼š
è®¢å•é˜Ÿåˆ—æ¶ˆè´¹è€…æ•°é‡ = 5ä¸ª
å¦‚æœçªç„¶é™åˆ°1ä¸ªï¼Œè¯´æ˜ï¼š
âŒ å¯èƒ½æœ‰æ¶ˆè´¹è€…ç¨‹åºå´©æºƒ
âŒ æœåŠ¡å™¨èµ„æºä¸è¶³
âŒ ç½‘ç»œè¿æ¥é—®é¢˜

é€šè¿‡ç›‘æ§å¯ä»¥ï¼š
âœ… åŠæ—¶å‘ç°é—®é¢˜
âœ… è‡ªåŠ¨è§¦å‘å‘Šè­¦
âœ… å¿«é€Ÿæ¢å¤æœåŠ¡
```

### 6.3 æ¶ˆè´¹è€…ç›‘æ§é…ç½®å»ºè®®


**âš™ï¸ æ ¹æ®åœºæ™¯é€‰æ‹©é…ç½®**

| ä¸šåŠ¡åœºæ™¯ | å»ºè®®é…ç½® | åŸå›  |
|----------|----------|------|
| **å°å‹åº”ç”¨** | `aggregate = true` | å‡å°‘ç›‘æ§å¤æ‚åº¦ |
| **å¾®æœåŠ¡æ¶æ„** | `aggregate = false` | éœ€è¦ç»†ç²’åº¦ç›‘æ§ |
| **é«˜å¹¶å‘ç³»ç»Ÿ** | `aggregate = true` | å‡å°‘ç›‘æ§å¼€é”€ |

---

## 7. ğŸ  è™šæ‹Ÿä¸»æœºç›‘æ§è®¾ç½®


### 7.1 prometheus.prefix_per_vhost_metricsé…ç½®


**ğŸ·ï¸ è™šæ‹Ÿä¸»æœºæŒ‡æ ‡å‰ç¼€**

å½“ä½ ä½¿ç”¨å¤šä¸ªè™šæ‹Ÿä¸»æœºæ—¶ï¼Œè¿™ä¸ªé…ç½®èƒ½è®©ç›‘æ§æ•°æ®æ›´æ¸…æ™°ï¼š

```ini
# ä¸ºè™šæ‹Ÿä¸»æœºæŒ‡æ ‡æ·»åŠ å‰ç¼€
prometheus.prefix_per_vhost_metrics = true
```

**é…ç½®æ•ˆæœå¯¹æ¯”**ï¼š

**ä¸ä½¿ç”¨å‰ç¼€**ï¼š
```
rabbitmq_queue_messages{vhost="/",queue="orders"} 100
rabbitmq_queue_messages{vhost="/api",queue="orders"} 50
```

**ä½¿ç”¨å‰ç¼€**ï¼š
```
rabbitmq_vhost_default_queue_messages{queue="orders"} 100
rabbitmq_vhost_api_queue_messages{queue="orders"} 50
```

### 7.2 å¤šç§Ÿæˆ·ç¯å¢ƒçš„ç›‘æ§


**ğŸ¢ ä¼ä¸šçº§åº”ç”¨åœºæ™¯**

```
å…¸å‹å¤šç§Ÿæˆ·åœºæ™¯ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è™šæ‹Ÿä¸»æœº "/"  â”‚ â† é»˜è®¤ç¯å¢ƒ
â”‚ - ç”¨æˆ·æœåŠ¡    â”‚
â”‚ - è®¢å•æœåŠ¡    â”‚  
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è™šæ‹Ÿä¸»æœº"/api"â”‚ â† APIæœåŠ¡  
â”‚ - å¤–éƒ¨æ¥å£    â”‚
â”‚ - ç¬¬ä¸‰æ–¹é›†æˆ  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  
â”‚è™šæ‹Ÿä¸»æœº"/test"â”‚ â† æµ‹è¯•ç¯å¢ƒ
â”‚ - åŠŸèƒ½æµ‹è¯•    â”‚
â”‚ - å‹åŠ›æµ‹è¯•    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

ä½¿ç”¨å‰ç¼€åï¼Œæ¯ä¸ªè™šæ‹Ÿä¸»æœºçš„ç›‘æ§æ•°æ®éƒ½æœ‰æ¸…æ™°çš„æ ‡è¯†ï¼Œæ–¹ä¾¿è¿ç»´äººå‘˜å¿«é€Ÿå®šä½é—®é¢˜ã€‚

---

## 8. ğŸ“ˆ ç›´æ–¹å›¾æ¡¶é…ç½®


### 8.1 prometheus.bucketsæ¦‚å¿µç†è§£


**ğŸ“Š ä»€ä¹ˆæ˜¯ç›´æ–¹å›¾æ¡¶**

ç›´æ–¹å›¾æ¡¶å°±åƒæ˜¯æŠŠæ•°æ®åˆ†ç±»æ”¾åˆ°ä¸åŒçš„"æ¡¶"é‡Œï¼Œç”¨æ¥ç»Ÿè®¡å»¶è¿Ÿåˆ†å¸ƒï¼š

```
æ¶ˆæ¯å¤„ç†æ—¶é—´åˆ†å¸ƒï¼š
æ¡¶1 (0-1ms):   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 60%çš„æ¶ˆæ¯
æ¡¶2 (1-10ms):  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     40%çš„æ¶ˆæ¯  
æ¡¶3 (10-100ms): â–ˆâ–ˆ          5%çš„æ¶ˆæ¯
æ¡¶4 (100ms+):   â–Œ           1%çš„æ¶ˆæ¯
```

### 8.2 bucketsé…ç½®è¯¦è§£


**âš™ï¸ è‡ªå®šä¹‰æ¡¶é…ç½®**

```ini
# è‡ªå®šä¹‰ç›´æ–¹å›¾æ¡¶è¾¹ç•Œï¼ˆå•ä½ï¼šæ¯«ç§’ï¼‰
prometheus.buckets = 1,5,10,25,50,100,250,500,1000,2500,5000,10000,30000
```

**æ¡¶è¾¹ç•Œé€‰æ‹©åŸåˆ™**ï¼š
- **å¯†é›†åŒºé—´**ï¼šåœ¨æœŸæœ›å€¼é™„è¿‘è®¾ç½®æ›´å¤šæ¡¶
- **ç¨€ç–åŒºé—´**ï¼šåœ¨æå€¼åŒºåŸŸè®¾ç½®è¾ƒå°‘æ¡¶
- **ä¸šåŠ¡ç›¸å…³**ï¼šæ ¹æ®SLAè¦æ±‚è®¾ç½®å…³é”®é˜ˆå€¼

### 8.3 ä¸åŒä¸šåŠ¡åœºæ™¯çš„æ¡¶é…ç½®


**ğŸ¯ é’ˆå¯¹æ€§é…ç½®ç¤ºä¾‹**

**é«˜é¢‘äº¤æ˜“ç³»ç»Ÿ**ï¼ˆè¦æ±‚æä½å»¶è¿Ÿï¼‰ï¼š
```ini
prometheus.buckets = 0.1,0.5,1,2,5,10,20,50,100
```

**æ™®é€šWebåº”ç”¨**ï¼ˆå¹³è¡¡æ€§èƒ½å’Œèµ„æºï¼‰ï¼š
```ini  
prometheus.buckets = 1,5,10,25,50,100,250,500,1000
```

**æ‰¹å¤„ç†ç³»ç»Ÿ**ï¼ˆå…è®¸è¾ƒé«˜å»¶è¿Ÿï¼‰ï¼š
```ini
prometheus.buckets = 100,500,1000,5000,10000,30000,60000
```

### 8.4 æ¡¶é…ç½®çš„ç›‘æ§æ•ˆæœ


**ğŸ“Š å®é™…ç›‘æ§æ•°æ®ç¤ºä¾‹**

é…ç½®ç”Ÿæ•ˆåï¼Œä½ ä¼šçœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„ç›‘æ§æ•°æ®ï¼š
```
rabbitmq_queue_messages_deliver_duration_bucket{le="1"} 1250
rabbitmq_queue_messages_deliver_duration_bucket{le="5"} 2100  
rabbitmq_queue_messages_deliver_duration_bucket{le="10"} 2300
rabbitmq_queue_messages_deliver_duration_bucket{le="+Inf"} 2400
```

è¿™å‘Šè¯‰æˆ‘ä»¬ï¼š
- 1mså†…å®Œæˆçš„æ“ä½œï¼š1250æ¬¡
- 5mså†…å®Œæˆçš„æ“ä½œï¼š2100æ¬¡  
- 10mså†…å®Œæˆçš„æ“ä½œï¼š2300æ¬¡
- æ€»æ“ä½œæ•°ï¼š2400æ¬¡

---

## 9. ğŸ› ï¸ ç›‘æ§é…ç½®å®æˆ˜æ¡ˆä¾‹


### 9.1 åŸºç¡€ç›‘æ§é…ç½®


**ğŸ“ æ–°æ‰‹å…¥é—¨é…ç½®**

è¿™æ˜¯ä¸€ä¸ªé€‚åˆæ–°æ‰‹çš„åŸºç¡€é…ç½®ï¼Œè¦†ç›–äº†ä¸»è¦ç›‘æ§éœ€æ±‚ï¼š

```ini
# RabbitMQ Prometheusç›‘æ§åŸºç¡€é…ç½®
# é€‚ç”¨äºï¼šå°å‹åº”ç”¨ã€å­¦ä¹ ç¯å¢ƒ

# åŸºç¡€ç«¯å£é…ç½®
prometheus.tcp.port = 15692

# ç›‘æ§è·¯å¾„ï¼ˆä½¿ç”¨é»˜è®¤ï¼‰
prometheus.path = /metrics

# æ•°æ®æ ¼å¼
prometheus.format = prometheus

# æ€§èƒ½ä¼˜åŒ–é…ç½®
prometheus.compact_tables = true
prometheus.return_per_object_metrics = true

# æ¶ˆè´¹è€…ç›‘æ§
prometheus.aggregate_consumer_metrics = true

# è™šæ‹Ÿä¸»æœºç›‘æ§
prometheus.prefix_per_vhost_metrics = false

# ç›´æ–¹å›¾æ¡¶ï¼ˆé€‚åˆä¸€èˆ¬åº”ç”¨ï¼‰
prometheus.buckets = 1,5,10,25,50,100,250,500,1000,5000
```

### 9.2 ç”Ÿäº§ç¯å¢ƒé…ç½®


**ğŸ­ ä¼ä¸šçº§ç›‘æ§é…ç½®**

```ini
# RabbitMQ Prometheusç”Ÿäº§ç¯å¢ƒé…ç½®
# é€‚ç”¨äºï¼šé«˜å¹¶å‘ã€å¤šæœåŠ¡ã€ä¸¥æ ¼ç›‘æ§è¦æ±‚

# ç«¯å£é…ç½®ï¼ˆä½¿ç”¨SSLï¼‰
prometheus.tcp.port = 15692
prometheus.ssl.port = 15691

# å®‰å…¨è·¯å¾„
prometheus.path = /internal/metrics

# æ€§èƒ½ä¼˜åŒ–
prometheus.compact_tables = true
prometheus.return_per_object_metrics = false  # å‡å°‘ç›‘æ§å¼€é”€

# æ¶ˆè´¹è€…ç›‘æ§èšåˆ
prometheus.aggregate_consumer_metrics = true

# è™šæ‹Ÿä¸»æœºå‰ç¼€ï¼ˆä¾¿äºå¤šç§Ÿæˆ·ç®¡ç†ï¼‰
prometheus.prefix_per_vhost_metrics = true

# ç»†ç²’åº¦ç›´æ–¹å›¾æ¡¶
prometheus.buckets = 0.5,1,2,5,10,20,50,100,200,500,1000,2000,5000,10000
```

### 9.3 é«˜æ€§èƒ½åœºæ™¯é…ç½®


**ğŸš€ ä¼˜åŒ–æ€§èƒ½çš„é…ç½®**

å½“RabbitMQå¤„ç†å¤§é‡æ¶ˆæ¯æ—¶ï¼Œéœ€è¦ç‰¹åˆ«ä¼˜åŒ–ç›‘æ§é…ç½®ï¼š

```ini
# é«˜æ€§èƒ½åœºæ™¯ç›‘æ§é…ç½®
# é€‚ç”¨äºï¼šæ¯ç§’ä¸‡çº§æ¶ˆæ¯ã€å¤§é‡é˜Ÿåˆ—

# åŸºç¡€é…ç½®
prometheus.tcp.port = 15692
prometheus.path = /metrics
prometheus.format = prometheus

# å…³é”®æ€§èƒ½ä¼˜åŒ–
prometheus.compact_tables = true
prometheus.return_per_object_metrics = false  # å…³é—­è¯¦ç»†å¯¹è±¡ç›‘æ§
prometheus.aggregate_consumer_metrics = true  # èšåˆæ¶ˆè´¹è€…æŒ‡æ ‡

# ç®€åŒ–è™šæ‹Ÿä¸»æœºç›‘æ§
prometheus.prefix_per_vhost_metrics = false

# è¾ƒå°‘çš„æ¡¶æ•°é‡ï¼ˆå‡å°‘è®¡ç®—å¼€é”€ï¼‰
prometheus.buckets = 1,10,50,100,500,1000,5000
```

---

## 10. ğŸ”§ æ•…éšœæ’æŸ¥ä¸ä¼˜åŒ–


### 10.1 å¸¸è§ç›‘æ§é—®é¢˜è¯Šæ–­


**âŒ é—®é¢˜1ï¼šæ— æ³•è®¿é—®ç›‘æ§ç«¯ç‚¹**

**ç—‡çŠ¶**ï¼šè®¿é—®`http://localhost:15692/metrics`è¿”å›è¿æ¥å¤±è´¥

**æ’æŸ¥æ­¥éª¤**ï¼š
1. æ£€æŸ¥æ’ä»¶çŠ¶æ€ï¼š`rabbitmq-plugins list | grep prometheus`
2. æŸ¥çœ‹ç«¯å£ç›‘å¬ï¼š`netstat -tlnp | grep 15692`  
3. æ£€æŸ¥é˜²ç«å¢™ï¼š`sudo ufw status`
4. æŸ¥çœ‹RabbitMQæ—¥å¿—ï¼š`sudo journalctl -u rabbitmq-server`

**è§£å†³æ–¹æ³•**ï¼š
```bash
# é‡æ–°å¯ç”¨æ’ä»¶
rabbitmq-plugins disable rabbitmq_prometheus
rabbitmq-plugins enable rabbitmq_prometheus

# é‡å¯RabbitMQæœåŠ¡
sudo systemctl restart rabbitmq-server
```

### 10.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®


**âš¡ ç›‘æ§ç³»ç»Ÿä¼˜åŒ–**

**é—®é¢˜2ï¼šç›‘æ§æ•°æ®é‡è¿‡å¤§**

å½“ä½ æœ‰æ•°ç™¾ä¸ªé˜Ÿåˆ—æ—¶ï¼Œç›‘æ§æ•°æ®å¯èƒ½è¾¾åˆ°å‡ MBï¼Œå½±å“Prometheusæ”¶é›†æ€§èƒ½ã€‚

**ä¼˜åŒ–ç­–ç•¥**ï¼š

| é…ç½®é¡¹ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ•ˆæœ |
|--------|--------|--------|------|
| `return_per_object_metrics` | `true` | `false` | å‡å°‘70%æ•°æ®é‡ |
| `compact_tables` | `false` | `true` | å‹ç¼©30%ä½“ç§¯ |
| `aggregate_consumer_metrics` | `false` | `true` | å‡å°‘50%æŒ‡æ ‡æ•° |

### 10.3 ç›‘æ§æ•°æ®éªŒè¯


**âœ… ç¡®ä¿ç›‘æ§æ•°æ®å‡†ç¡®æ€§**

```bash
# æ£€æŸ¥åŸºç¡€æŒ‡æ ‡
curl -s http://localhost:15692/metrics | grep rabbitmq_queues

# éªŒè¯é˜Ÿåˆ—æ•°é‡
rabbitmqctl list_queues | wc -l

# å¯¹æ¯”ä¸¤ä¸ªæ•°å­—æ˜¯å¦ä¸€è‡´
```

**ç›‘æ§æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥**ï¼š
```bash
#!/bin/bash
# ç›‘æ§æ•°æ®éªŒè¯è„šæœ¬

echo "=== RabbitMQç›‘æ§æ•°æ®éªŒè¯ ==="

# è·å–å®é™…é˜Ÿåˆ—æ•°
ACTUAL_QUEUES=$(rabbitmqctl list_queues --silent | wc -l)

# è·å–ç›‘æ§æŠ¥å‘Šçš„é˜Ÿåˆ—æ•°  
MONITORED_QUEUES=$(curl -s http://localhost:15692/metrics | grep "rabbitmq_queues{" | awk -F' ' '{print $2}')

echo "å®é™…é˜Ÿåˆ—æ•°: $ACTUAL_QUEUES"
echo "ç›‘æ§é˜Ÿåˆ—æ•°: $MONITORED_QUEUES"

if [ "$ACTUAL_QUEUES" -eq "$MONITORED_QUEUES" ]; then
    echo "âœ… ç›‘æ§æ•°æ®ä¸€è‡´"
else
    echo "âŒ ç›‘æ§æ•°æ®ä¸ä¸€è‡´ï¼Œéœ€è¦æ£€æŸ¥é…ç½®"
fi
```

---

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒé…ç½®


```
ğŸ”¸ æ’ä»¶å¯ç”¨ï¼šrabbitmq-plugins enable rabbitmq_prometheus
ğŸ”¸ åŸºç¡€ç«¯å£ï¼šprometheus.tcp.port = 15692
ğŸ”¸ ç›‘æ§è·¯å¾„ï¼šprometheus.path = /metrics
ğŸ”¸ æ•°æ®æ ¼å¼ï¼šprometheus.format = prometheus
ğŸ”¸ æ€§èƒ½ä¼˜åŒ–ï¼šprometheus.compact_tables = true
```

### 11.2 é…ç½®é€‰æ‹©æŒ‡å—


**ğŸ¯ æ ¹æ®ç¯å¢ƒé€‰æ‹©é…ç½®**

**å¼€å‘ç¯å¢ƒæ¨è**ï¼š
- âœ… `return_per_object_metrics = true`ï¼ˆè¯¦ç»†ç›‘æ§ï¼‰
- âœ… `aggregate_consumer_metrics = false`ï¼ˆä¾¿äºè°ƒè¯•ï¼‰
- âœ… `prefix_per_vhost_metrics = false`ï¼ˆç®€åŒ–é…ç½®ï¼‰

**ç”Ÿäº§ç¯å¢ƒæ¨è**ï¼š
- âœ… `return_per_object_metrics = false`ï¼ˆå‡å°‘å¼€é”€ï¼‰
- âœ… `aggregate_consumer_metrics = true`ï¼ˆèšåˆç»Ÿè®¡ï¼‰
- âœ… `compact_tables = true`ï¼ˆæ•°æ®å‹ç¼©ï¼‰

### 11.3 ç›‘æ§é…ç½®çš„ä¸šåŠ¡ä»·å€¼


**ğŸ’¡ å®é™…åº”ç”¨æ”¶ç›Š**

```
æ•…éšœé¢„é˜²ï¼š
ğŸ“Š é˜Ÿåˆ—ç§¯å‹ç›‘æ§ â†’ æå‰å‘ç°æ€§èƒ½ç“¶é¢ˆ
ğŸ”„ æ¶ˆè´¹è€…ç›‘æ§ â†’ åŠæ—¶å‘ç°æœåŠ¡å¼‚å¸¸
âš¡ å»¶è¿Ÿç›‘æ§ â†’ ä¿éšœç”¨æˆ·ä½“éªŒ

è¿ç»´æ•ˆç‡ï¼š
ğŸ“ˆ å¯è§†åŒ–ç›‘æ§ â†’ å‡å°‘äººå·¥å·¡æ£€
ğŸš¨ è‡ªåŠ¨å‘Šè­¦ â†’ å¿«é€Ÿå“åº”é—®é¢˜
ğŸ“‹ å†å²æ•°æ® â†’ å®¹é‡è§„åˆ’å‚è€ƒ
```

### 11.4 æ–°æ‰‹å­¦ä¹ å»ºè®®


**ğŸ“š å¾ªåºæ¸è¿›çš„å­¦ä¹ è·¯å¾„**

1. **ç¬¬ä¸€æ­¥**ï¼šä½¿ç”¨åŸºç¡€é…ç½®ï¼Œç†Ÿæ‚‰ç›‘æ§ç•Œé¢
2. **ç¬¬äºŒæ­¥**ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚è°ƒæ•´é…ç½®å‚æ•°
3. **ç¬¬ä¸‰æ­¥**ï¼šç»“åˆGrafanaåˆ›å»ºç›‘æ§çœ‹æ¿
4. **ç¬¬å››æ­¥**ï¼šè®¾ç½®å‘Šè­¦è§„åˆ™ï¼Œå®ç°ä¸»åŠ¨ç›‘æ§

### 11.5 é…ç½®æ¨¡æ¿æ€»ç»“


**ğŸ“‹ å¿«é€Ÿå‚è€ƒé…ç½®**

```ini
# ğŸ”° æ–°æ‰‹æ¨èé…ç½®
prometheus.tcp.port = 15692
prometheus.compact_tables = true
prometheus.return_per_object_metrics = true
prometheus.aggregate_consumer_metrics = true

# ğŸ­ ç”Ÿäº§ç¯å¢ƒé…ç½®  
prometheus.tcp.port = 15692
prometheus.ssl.port = 15691
prometheus.compact_tables = true
prometheus.return_per_object_metrics = false
prometheus.aggregate_consumer_metrics = true
prometheus.prefix_per_vhost_metrics = true

# ğŸš€ é«˜æ€§èƒ½é…ç½®
prometheus.tcp.port = 15692
prometheus.compact_tables = true
prometheus.return_per_object_metrics = false
prometheus.aggregate_consumer_metrics = true
prometheus.buckets = 1,10,50,100,500,1000
```

**ğŸ’¡ è®°ä½æ ¸å¿ƒåŸåˆ™**ï¼š
- ç›‘æ§é…ç½®è¦ç¬¦åˆå®é™…ä¸šåŠ¡éœ€æ±‚
- å¼€å‘ç¯å¢ƒé‡è°ƒè¯•ï¼Œç”Ÿäº§ç¯å¢ƒé‡æ€§èƒ½
- å®šæœŸéªŒè¯ç›‘æ§æ•°æ®çš„å‡†ç¡®æ€§
- ç›‘æ§é…ç½®è°ƒæ•´è¦é€æ­¥è¿›è¡Œï¼Œè§‚å¯Ÿæ•ˆæœ