---
title: 1ã€å‘é€æ€§èƒ½è°ƒä¼˜
---
## ğŸ“š ç›®å½•

1. [ç”Ÿäº§è€…æ€§èƒ½ä¼˜åŒ–æ¦‚è¿°](#1-ç”Ÿäº§è€…æ€§èƒ½ä¼˜åŒ–æ¦‚è¿°)
2. [æ‰¹é‡å‘é€ç­–ç•¥](#2-æ‰¹é‡å‘é€ç­–ç•¥)
3. [å¼‚æ­¥å‘é€æ¨¡å¼](#3-å¼‚æ­¥å‘é€æ¨¡å¼)
4. [è¿æ¥å¤ç”¨ä¼˜åŒ–](#4-è¿æ¥å¤ç”¨ä¼˜åŒ–)
5. [åºåˆ—åŒ–ä¼˜åŒ–](#5-åºåˆ—åŒ–ä¼˜åŒ–)
6. [å†…å­˜ç®¡ç†ä¼˜åŒ–](#6-å†…å­˜ç®¡ç†ä¼˜åŒ–)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸš€ ç”Ÿäº§è€…æ€§èƒ½ä¼˜åŒ–æ¦‚è¿°


### 1.1 ä¸ºä»€ä¹ˆéœ€è¦æ€§èƒ½ä¼˜åŒ–


**ğŸ”¸ ç°å®åœºæ™¯ç†è§£**
```
æƒ³è±¡ä¸€ä¸ªç”µå•†ç½‘ç«™çš„è®¢å•ç³»ç»Ÿï¼š
- åŒ11æœŸé—´ï¼šæ¯ç§’10ä¸‡è®¢å•äº§ç”Ÿ
- æ¯ä¸ªè®¢å•ï¼šéœ€è¦å‘é€å¤šæ¡æ¶ˆæ¯ï¼ˆåº“å­˜ã€ç‰©æµã€æ”¯ä»˜ç­‰ï¼‰
- å¦‚æœæ¶ˆæ¯å‘é€æ…¢ï¼šç³»ç»Ÿä¼šå¡é¡¿ï¼Œç”¨æˆ·ä½“éªŒå·®

å°±åƒå¿«é€’å…¬å¸ï¼š
å•ä»¶å‘è´§ vs æ‰¹é‡å‘è´§ï¼Œæ•ˆç‡å®Œå…¨ä¸åŒ
```

**ğŸ’¡ æ€§èƒ½ç“¶é¢ˆåˆ†æ**
```
ç”Ÿäº§è€…å‘é€æ¶ˆæ¯çš„ä¸»è¦è€—æ—¶ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åº”ç”¨ç¨‹åºé€»è¾‘    â”‚ â† 5%
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ¶ˆæ¯åºåˆ—åŒ–      â”‚ â† 15%
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç½‘ç»œä¼ è¾“       â”‚ â† 60%
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  RabbitMQå¤„ç†   â”‚ â† 20%
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç½‘ç»œä¼ è¾“æ˜¯æœ€å¤§ç“¶é¢ˆï¼
```

### 1.2 ä¼˜åŒ–ç­–ç•¥æ€»è§ˆ


**ğŸ¯ äº”å¤§ä¼˜åŒ–æ–¹å‘**
- **æ‰¹é‡å‘é€**ï¼šå‡å°‘ç½‘ç»œå¾€è¿”æ¬¡æ•°
- **å¼‚æ­¥å‘é€**ï¼šé¿å…é˜»å¡ç­‰å¾…
- **è¿æ¥å¤ç”¨**ï¼šå‡å°‘è¿æ¥å»ºç«‹å¼€é”€
- **åºåˆ—åŒ–ä¼˜åŒ–**ï¼šå‡å°‘æ¶ˆæ¯ä½“ç§¯
- **å†…å­˜ç®¡ç†**ï¼šé¿å…é¢‘ç¹åƒåœ¾å›æ”¶

---

## 2. ğŸ“¦ æ‰¹é‡å‘é€ç­–ç•¥


### 2.1 ä»€ä¹ˆæ˜¯æ‰¹é‡å‘é€


**ğŸ”¸ åŸºæœ¬æ¦‚å¿µ**
```
å•æ¡å‘é€ vs æ‰¹é‡å‘é€å¯¹æ¯”ï¼š

å•æ¡å‘é€ï¼ˆæ•ˆç‡ä½ï¼‰ï¼š
å‘é€æ¶ˆæ¯1 â†’ ç­‰å¾…ç¡®è®¤ â†’ å‘é€æ¶ˆæ¯2 â†’ ç­‰å¾…ç¡®è®¤ â†’ ...
ç½‘ç»œå¾€è¿”ï¼šNæ¬¡

æ‰¹é‡å‘é€ï¼ˆæ•ˆç‡é«˜ï¼‰ï¼š
æ‰“åŒ…æ¶ˆæ¯[1,2,3...N] â†’ ä¸€æ¬¡å‘é€ â†’ ä¸€æ¬¡ç¡®è®¤
ç½‘ç»œå¾€è¿”ï¼š1æ¬¡
```

**ğŸ’¡ ç”Ÿæ´»ä¸­çš„ç±»æ¯”**
```
å°±åƒå¯„å¿«é€’ï¼š
- å•ä»¶å¯„é€ï¼šæ¯ä¸ªåŒ…è£¹éƒ½è¦è·‘ä¸€è¶Ÿå¿«é€’ç‚¹
- æ‰¹é‡å¯„é€ï¼šæ”¶é›†ä¸€å †åŒ…è£¹ï¼Œä¸€æ¬¡æ€§é€åˆ°å¿«é€’ç‚¹

æ•ˆç‡æå‡æ˜¾è€Œæ˜“è§ï¼
```

### 2.2 æ‰¹é‡å‘é€å®ç°æ–¹æ¡ˆ


#### ğŸ”§ æ–¹æ¡ˆä¸€ï¼šæ‰‹åŠ¨æ‰¹é‡æ”¶é›†


```java
public class BatchMessageSender {
    private List<String> messageQueue = new ArrayList<>();
    private final int BATCH_SIZE = 100;
    
    public void sendMessage(String message) {
        messageQueue.add(message);
        
        // è¾¾åˆ°æ‰¹é‡å¤§å°å°±å‘é€
        if (messageQueue.size() >= BATCH_SIZE) {
            sendBatch();
        }
    }
    
    private void sendBatch() {
        // æ‰¹é‡å‘é€é€»è¾‘
        for (String msg : messageQueue) {
            channel.basicPublish("", "queue", null, msg.getBytes());
        }
        messageQueue.clear();
    }
}
```

#### â° æ–¹æ¡ˆäºŒï¼šå®šæ—¶æ‰¹é‡å‘é€


```java
public class TimerBatchSender {
    private List<String> messageBuffer = new ArrayList<>();
    private final ScheduledExecutorService scheduler = 
        Executors.newScheduledThreadPool(1);
    
    public TimerBatchSender() {
        // æ¯ç§’å‘é€ä¸€æ¬¡æ‰¹é‡æ¶ˆæ¯
        scheduler.scheduleAtFixedRate(this::flushMessages, 
            0, 1, TimeUnit.SECONDS);
    }
    
    public synchronized void addMessage(String message) {
        messageBuffer.add(message);
    }
    
    private synchronized void flushMessages() {
        if (!messageBuffer.isEmpty()) {
            // å‘é€æ‰€æœ‰ç¼“å­˜çš„æ¶ˆæ¯
            sendBatch(new ArrayList<>(messageBuffer));
            messageBuffer.clear();
        }
    }
}
```

### 2.3 æ‰¹é‡å¤§å°é€‰æ‹©


**ğŸ“Š æ‰¹é‡å¤§å°å¯¹æ¯”**
| æ‰¹é‡å¤§å° | **ååé‡** | **å»¶è¿Ÿ** | **å†…å­˜å ç”¨** | **é€‚ç”¨åœºæ™¯** |
|---------|-----------|---------|-------------|-------------|
| 1-10æ¡ | `ä½` | `æä½` | `å°` | `å®æ—¶æ€§è¦æ±‚é«˜` |
| 50-100æ¡ | `ä¸­ç­‰` | `ä½` | `ä¸­ç­‰` | `å¹³è¡¡åœºæ™¯` |
| 500-1000æ¡ | `é«˜` | `ä¸­ç­‰` | `è¾ƒå¤§` | `ååé‡ä¼˜å…ˆ` |
| 5000+æ¡ | `æé«˜` | `é«˜` | `å¤§` | `ç¦»çº¿æ‰¹å¤„ç†` |

**ğŸ¯ é€‰æ‹©å»ºè®®**
```
å®æ—¶äº¤æ˜“ç³»ç»Ÿï¼šæ‰¹é‡å¤§å° 10-50
è®¢å•å¤„ç†ç³»ç»Ÿï¼šæ‰¹é‡å¤§å° 100-200  
æ—¥å¿—æ”¶é›†ç³»ç»Ÿï¼šæ‰¹é‡å¤§å° 500-1000
æ•°æ®åŒæ­¥ç³»ç»Ÿï¼šæ‰¹é‡å¤§å° 1000+
```

---

## 3. âš¡ å¼‚æ­¥å‘é€æ¨¡å¼


### 3.1 åŒæ­¥ vs å¼‚æ­¥å‘é€


**ğŸ”¸ åŒæ­¥å‘é€é—®é¢˜**
```
åŒæ­¥å‘é€æµç¨‹ï¼š
åº”ç”¨ â†’ å‘é€æ¶ˆæ¯ â†’ ç­‰å¾…ç¡®è®¤ â†’ ç»§ç»­å¤„ç†
      â†‘_______ç­‰å¾…æ—¶é—´_______â†‘

é—®é¢˜ï¼šæ¯æ¬¡å‘é€éƒ½è¦ç­‰å¾…ï¼Œä¸¥é‡å½±å“ååé‡
```

**ğŸ’¡ å¼‚æ­¥å‘é€ä¼˜åŠ¿**
```
å¼‚æ­¥å‘é€æµç¨‹ï¼š
åº”ç”¨ â†’ å‘é€æ¶ˆæ¯ â†’ ç«‹å³ç»§ç»­å¤„ç†
             â†“
         åå°å¤„ç†ç¡®è®¤

ä¼˜åŠ¿ï¼šä¸é˜»å¡ä¸»çº¿ç¨‹ï¼Œå¤§å¹…æå‡æ€§èƒ½
```

### 3.2 å¼‚æ­¥å‘é€å®ç°


#### ğŸ”§ åŸºç¡€å¼‚æ­¥å‘é€


```java
public class AsyncMessageSender {
    private final ExecutorService executor = 
        Executors.newFixedThreadPool(10);
    
    public void sendMessageAsync(String message) {
        // å¼‚æ­¥æ‰§è¡Œå‘é€ä»»åŠ¡
        executor.submit(() -> {
            try {
                channel.basicPublish("", "queue", null, message.getBytes());
                System.out.println("æ¶ˆæ¯å‘é€æˆåŠŸ: " + message);
            } catch (Exception e) {
                System.err.println("æ¶ˆæ¯å‘é€å¤±è´¥: " + e.getMessage());
            }
        });
    }
    
    public void sendMessageWithCallback(String message, 
                                      Runnable onSuccess, 
                                      Consumer<Exception> onError) {
        executor.submit(() -> {
            try {
                channel.basicPublish("", "queue", null, message.getBytes());
                onSuccess.run();
            } catch (Exception e) {
                onError.accept(e);
            }
        });
    }
}
```

#### ğŸ“‹ ä½¿ç”¨CompletableFuture


```java
public class FutureMessageSender {
    
    public CompletableFuture<Void> sendMessageAsync(String message) {
        return CompletableFuture.runAsync(() -> {
            try {
                channel.basicPublish("", "queue", null, message.getBytes());
            } catch (IOException e) {
                throw new RuntimeException(e);
            }
        });
    }
    
    // æ‰¹é‡å¼‚æ­¥å‘é€
    public CompletableFuture<Void> sendBatchAsync(List<String> messages) {
        List<CompletableFuture<Void>> futures = messages.stream()
            .map(this::sendMessageAsync)
            .collect(Collectors.toList());
            
        return CompletableFuture.allOf(
            futures.toArray(new CompletableFuture[0]));
    }
}
```

### 3.3 å¼‚æ­¥å‘é€æ³¨æ„äº‹é¡¹


> âš ï¸ **é‡è¦æé†’**
> 
> **å¼‚æ­¥å‘é€çš„é£é™©ï¼š**
> - æ¶ˆæ¯å¯èƒ½ä¸¢å¤±ï¼ˆå‘é€å¤±è´¥æ—¶ï¼‰
> - éš¾ä»¥ä¿è¯æ¶ˆæ¯é¡ºåº
> - é”™è¯¯å¤„ç†å¤æ‚
> 
> **è§£å†³æ–¹æ¡ˆï¼š**
> - å®ç°é‡è¯•æœºåˆ¶
> - ä½¿ç”¨æŒä¹…åŒ–é˜Ÿåˆ—
> - åˆç†çš„é”™è¯¯å¤„ç†ç­–ç•¥

---

## 4. ğŸ”— è¿æ¥å¤ç”¨ä¼˜åŒ–


### 4.1 è¿æ¥ä¸é€šé“çš„å…³ç³»


**ğŸ”¸ æ¦‚å¿µç†è§£**
```
RabbitMQè¿æ¥æ¨¡å‹ï¼š

åº”ç”¨ç¨‹åº
    â†“
Connectionï¼ˆTCPè¿æ¥ï¼‰
    â†“
Channelï¼ˆè™šæ‹Ÿè¿æ¥ï¼‰
    â†“
RabbitMQæœåŠ¡å™¨

ç±»æ¯”ï¼š
Connection = é«˜é€Ÿå…¬è·¯
Channel = é«˜é€Ÿå…¬è·¯ä¸Šçš„è½¦é“
```

**ğŸ’¡ ä¸ºä»€ä¹ˆè¦å¤ç”¨è¿æ¥**
```
åˆ›å»ºè¿æ¥çš„å¼€é”€ï¼š
1. å»ºç«‹TCPè¿æ¥
2. AMQPæ¡æ‰‹
3. èº«ä»½éªŒè¯
4. åˆ†é…èµ„æº

æ¯æ¬¡åˆ›å»ºè¿æ¥å°±åƒæ¯æ¬¡å‡ºé—¨éƒ½è¦ä¿®è·¯ï¼Œéå¸¸æµªè´¹ï¼
```

### 4.2 è¿æ¥æ± å®ç°


#### ğŸŠâ€â™‚ï¸ ç®€å•è¿æ¥æ± 


```java
public class RabbitMQConnectionPool {
    private final BlockingQueue<Connection> connectionPool;
    private final ConnectionFactory factory;
    private final int maxConnections;
    
    public RabbitMQConnectionPool(int maxConnections) {
        this.maxConnections = maxConnections;
        this.connectionPool = new LinkedBlockingQueue<>();
        this.factory = new ConnectionFactory();
        
        // åˆå§‹åŒ–è¿æ¥æ± 
        initializePool();
    }
    
    private void initializePool() {
        for (int i = 0; i < maxConnections; i++) {
            try {
                Connection conn = factory.newConnection();
                connectionPool.offer(conn);
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }
    
    public Connection borrowConnection() throws InterruptedException {
        return connectionPool.take(); // é˜»å¡è·å–è¿æ¥
    }
    
    public void returnConnection(Connection connection) {
        if (connection != null && connection.isOpen()) {
            connectionPool.offer(connection);
        }
    }
}
```

#### ğŸ”§ çº¿ç¨‹å®‰å…¨çš„é€šé“ç®¡ç†


```java
public class ChannelManager {
    private final ThreadLocal<Channel> channelHolder = new ThreadLocal<>();
    private final Connection connection;
    
    public ChannelManager(Connection connection) {
        this.connection = connection;
    }
    
    public Channel getChannel() {
        Channel channel = channelHolder.get();
        if (channel == null || !channel.isOpen()) {
            try {
                channel = connection.createChannel();
                channelHolder.set(channel);
            } catch (IOException e) {
                throw new RuntimeException("åˆ›å»ºé€šé“å¤±è´¥", e);
            }
        }
        return channel;
    }
    
    public void closeChannel() {
        Channel channel = channelHolder.get();
        if (channel != null) {
            try {
                channel.close();
            } catch (Exception e) {
                // å¿½ç•¥å…³é—­å¼‚å¸¸
            } finally {
                channelHolder.remove();
            }
        }
    }
}
```

### 4.3 è¿æ¥å¤ç”¨æœ€ä½³å®è·µ


**ğŸ¯ è¿æ¥æ•°é‡è§„åˆ’**
```
æ¨èé…ç½®ï¼š

å°å‹åº”ç”¨ï¼ˆQPS < 1000ï¼‰ï¼š
- è¿æ¥æ•°ï¼š1-2ä¸ª
- æ¯è¿æ¥é€šé“æ•°ï¼š10-20ä¸ª

ä¸­å‹åº”ç”¨ï¼ˆQPS 1000-10000ï¼‰ï¼š
- è¿æ¥æ•°ï¼š3-5ä¸ª  
- æ¯è¿æ¥é€šé“æ•°ï¼š20-50ä¸ª

å¤§å‹åº”ç”¨ï¼ˆQPS > 10000ï¼‰ï¼š
- è¿æ¥æ•°ï¼š5-10ä¸ª
- æ¯è¿æ¥é€šé“æ•°ï¼š50-100ä¸ª
```

**ğŸ“‹ è¿æ¥ç®¡ç†ç­–ç•¥**
| ç­–ç•¥ç±»å‹ | **é€‚ç”¨åœºæ™¯** | **ä¼˜åŠ¿** | **åŠ£åŠ¿** |
|---------|-------------|---------|---------|
| **å•è¿æ¥å¤šé€šé“** | `å°å‹åº”ç”¨` | `ç®€å•æ˜“ç®¡ç†` | `å•ç‚¹æ•…éšœé£é™©` |
| **è¿æ¥æ± ** | `ä¸­å‹åº”ç”¨` | `æ€§èƒ½å¥½ï¼Œå¯æ‰©å±•` | `å¤æ‚åº¦é«˜` |
| **åˆ†åŒºè¿æ¥** | `å¤§å‹åº”ç”¨` | `é«˜å¯ç”¨ï¼Œé«˜æ€§èƒ½` | `ç®¡ç†å¤æ‚` |

---

## 5. ğŸ”„ åºåˆ—åŒ–ä¼˜åŒ–


### 5.1 åºåˆ—åŒ–å¯¹æ€§èƒ½çš„å½±å“


**ğŸ”¸ åºåˆ—åŒ–å¼€é”€åˆ†æ**
```
æ¶ˆæ¯å‘é€å…¨æµç¨‹ï¼š
å¯¹è±¡ â†’ åºåˆ—åŒ– â†’ ç½‘ç»œä¼ è¾“ â†’ ååºåˆ—åŒ– â†’ å¯¹è±¡

åºåˆ—åŒ–å½±å“ï¼š
- CPUæ¶ˆè€—ï¼šåºåˆ—åŒ–/ååºåˆ—åŒ–è®¡ç®—
- ç½‘ç»œå¸¦å®½ï¼šåºåˆ—åŒ–åçš„æ•°æ®å¤§å°
- å†…å­˜å ç”¨ï¼šåºåˆ—åŒ–è¿‡ç¨‹ä¸­çš„ä¸´æ—¶å¯¹è±¡
```

**ğŸ“Š ä¸åŒåºåˆ—åŒ–æ–¹å¼å¯¹æ¯”**
| åºåˆ—åŒ–æ–¹å¼ | **é€Ÿåº¦** | **ä½“ç§¯** | **å¯è¯»æ€§** | **å…¼å®¹æ€§** |
|-----------|---------|---------|-----------|-----------|
| **JavaåŸç”Ÿ** | `æ…¢` | `å¤§` | `å·®` | `Javaé™å®š` |
| **JSON** | `ä¸­ç­‰` | `ä¸­ç­‰` | `å¥½` | `è·¨è¯­è¨€` |
| **Protocol Buffers** | `å¿«` | `å°` | `å·®` | `è·¨è¯­è¨€` |
| **MessagePack** | `å¿«` | `å°` | `å·®` | `è·¨è¯­è¨€` |
| **Avro** | `å¿«` | `å°` | `ä¸­ç­‰` | `è·¨è¯­è¨€` |

### 5.2 é€‰æ‹©åˆé€‚çš„åºåˆ—åŒ–æ–¹æ¡ˆ


#### ğŸ“„ JSONåºåˆ—åŒ–ï¼ˆæ¨èå…¥é—¨ï¼‰


```java
public class JsonMessageSender {
    private final ObjectMapper objectMapper = new ObjectMapper();
    
    public void sendOrder(Order order) {
        try {
            // å¯¹è±¡è½¬JSON
            String json = objectMapper.writeValueAsString(order);
            
            // å‘é€æ¶ˆæ¯
            channel.basicPublish("", "order-queue", null, json.getBytes());
            
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}

// ä½¿ç”¨ç¤ºä¾‹
Order order = new Order("12345", "ç”¨æˆ·A", 99.99);
sender.sendOrder(order);
```

#### âš¡ Protocol Buffersï¼ˆæ¨èé«˜æ€§èƒ½ï¼‰


```java
// 1. å…ˆå®šä¹‰.protoæ–‡ä»¶
syntax = "proto3";

message OrderProto {
    string order_id = 1;
    string user_name = 2;
    double amount = 3;
}

// 2. Javaä»£ç ä½¿ç”¨
public class ProtobufMessageSender {
    
    public void sendOrder(String orderId, String userName, double amount) {
        try {
            // æ„å»ºProtobufå¯¹è±¡
            OrderProto order = OrderProto.newBuilder()
                .setOrderId(orderId)
                .setUserName(userName)  
                .setAmount(amount)
                .build();
            
            // åºåˆ—åŒ–ä¸ºå­—èŠ‚æ•°ç»„
            byte[] data = order.toByteArray();
            
            // å‘é€æ¶ˆæ¯
            channel.basicPublish("", "order-queue", null, data);
            
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

### 5.3 åºåˆ—åŒ–ä¼˜åŒ–æŠ€å·§


**ğŸ¯ å‡å°‘åºåˆ—åŒ–æ•°æ®é‡**
```java
// ä¸å¥½çš„åšæ³•ï¼šå‘é€å®Œæ•´å¯¹è±¡
public class BadOrder {
    private String orderId;
    private String userName;
    private List<OrderItem> items; // å¯èƒ½å¾ˆå¤§
    private Date createTime;
    private String description; // å¯èƒ½å¾ˆé•¿
    // ... å¾ˆå¤šå…¶ä»–å­—æ®µ
}

// å¥½çš„åšæ³•ï¼šåªå‘é€å¿…è¦æ•°æ®
public class OrderEvent {
    private String orderId;    // åªè¦ID
    private String eventType;  // äº‹ä»¶ç±»å‹
    private double amount;     // å…³é”®é‡‘é¢
    
    // å…¶ä»–è¯¦ç»†ä¿¡æ¯é€šè¿‡IDæŸ¥è¯¢æ•°æ®åº“è·å–
}
```

**ğŸ’¡ åºåˆ—åŒ–ç¼“å­˜ç­–ç•¥**
```java
public class CachedSerializer {
    private final Map<Class<?>, ObjectMapper> mapperCache = new ConcurrentHashMap<>();
    
    public String serialize(Object obj) {
        ObjectMapper mapper = mapperCache.computeIfAbsent(
            obj.getClass(), 
            k -> new ObjectMapper()
        );
        
        try {
            return mapper.writeValueAsString(obj);
        } catch (Exception e) {
            throw new RuntimeException(e);
        }
    }
}
```

---

## 6. ğŸ§  å†…å­˜ç®¡ç†ä¼˜åŒ–


### 6.1 å†…å­˜é—®é¢˜åˆ†æ


**ğŸ”¸ å¸¸è§å†…å­˜é—®é¢˜**
```
ç”Ÿäº§è€…å†…å­˜é—®é¢˜ï¼š
1. æ¶ˆæ¯å †ç§¯ï¼šå‘é€å¤ªå¿«ï¼Œæ¥ä¸åŠå¤„ç†
2. è¿æ¥æ³„æ¼ï¼šè¿æ¥æ²¡æœ‰æ­£ç¡®å…³é—­
3. å¤§å¯¹è±¡ï¼šå•ä¸ªæ¶ˆæ¯ä½“ç§¯è¿‡å¤§
4. é¢‘ç¹GCï¼šå¤§é‡ä¸´æ—¶å¯¹è±¡åˆ›å»º
```

**ğŸ’¡ å†…å­˜ä½¿ç”¨ç›‘æ§**
```
å…³é”®æŒ‡æ ‡ï¼š
- å †å†…å­˜ä½¿ç”¨ç‡
- GCé¢‘ç‡å’Œæ—¶é—´
- è¿æ¥æ•°é‡
- æ¶ˆæ¯é˜Ÿåˆ—é•¿åº¦
```

### 6.2 å†…å­˜ä¼˜åŒ–ç­–ç•¥


#### ğŸ”§ å¯¹è±¡å¤ç”¨


```java
public class ObjectPoolMessageSender {
    // å¤ç”¨StringBuilderå‡å°‘å¯¹è±¡åˆ›å»º
    private final ThreadLocal<StringBuilder> stringBuilderPool = 
        ThreadLocal.withInitial(() -> new StringBuilder(1024));
    
    // å¤ç”¨ByteArrayOutputStream
    private final ThreadLocal<ByteArrayOutputStream> byteStreamPool =
        ThreadLocal.withInitial(() -> new ByteArrayOutputStream(1024));
    
    public void sendMessage(Object data) {
        StringBuilder sb = stringBuilderPool.get();
        ByteArrayOutputStream baos = byteStreamPool.get();
        
        try {
            // é‡ç½®ç¼“å†²åŒº
            sb.setLength(0);
            baos.reset();
            
            // ä½¿ç”¨å¤ç”¨çš„å¯¹è±¡
            String json = buildJson(data, sb);
            byte[] bytes = json.getBytes();
            
            channel.basicPublish("", "queue", null, bytes);
            
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    private String buildJson(Object data, StringBuilder sb) {
        // ä½¿ç”¨StringBuilderæ„å»ºJSONï¼Œé¿å…å­—ç¬¦ä¸²æ‹¼æ¥
        sb.append("{\"data\":\"").append(data.toString()).append("\"}");
        return sb.toString();
    }
}
```

#### ğŸ“‹ å†…å­˜é™åˆ¶è®¾ç½®


```java
public class MemoryLimitedSender {
    private final AtomicLong memoryUsage = new AtomicLong(0);
    private final long MAX_MEMORY = 100 * 1024 * 1024; // 100MBé™åˆ¶
    
    public boolean sendMessage(String message) {
        byte[] data = message.getBytes();
        long currentMemory = memoryUsage.addAndGet(data.length);
        
        if (currentMemory > MAX_MEMORY) {
            memoryUsage.addAndGet(-data.length); // å›æ»š
            System.out.println("å†…å­˜ä½¿ç”¨è¶…é™ï¼Œæ‹’ç»å‘é€æ¶ˆæ¯");
            return false;
        }
        
        try {
            channel.basicPublish("", "queue", null, data);
            return true;
        } catch (Exception e) {
            memoryUsage.addAndGet(-data.length); // å‘é€å¤±è´¥ï¼Œå›æ»šå†…å­˜è®¡æ•°
            return false;
        } finally {
            // æ¨¡æ‹Ÿæ¶ˆæ¯å¤„ç†å®Œæˆï¼Œé‡Šæ”¾å†…å­˜è®¡æ•°
            scheduleMemoryRelease(data.length);
        }
    }
    
    private void scheduleMemoryRelease(int size) {
        // å»¶è¿Ÿé‡Šæ”¾å†…å­˜è®¡æ•°ï¼ˆæ¨¡æ‹Ÿæ¶ˆæ¯è¢«æ¶ˆè´¹ï¼‰
        CompletableFuture.delayedExecutor(1, TimeUnit.SECONDS)
            .execute(() -> memoryUsage.addAndGet(-size));
    }
}
```

### 6.3 JVMè°ƒä¼˜å»ºè®®


**ğŸ¯ JVMå‚æ•°æ¨è**
```bash
# ç”Ÿäº§ç¯å¢ƒJVMå‚æ•°ç¤ºä¾‹
java -Xms2g -Xmx4g \
     -XX:+UseG1GC \
     -XX:MaxGCPauseMillis=200 \
     -XX:+HeapDumpOnOutOfMemoryError \
     -XX:HeapDumpPath=/logs/heapdump \
     -jar rabbitmq-producer.jar
```

**ğŸ“Š å†…å­˜åˆ†é…å»ºè®®**
| åº”ç”¨è§„æ¨¡ | **å †å†…å­˜** | **æ–°ç”Ÿä»£** | **GCç®—æ³•** |
|---------|-----------|-----------|-----------|
| **å°å‹åº”ç”¨** | `1-2GB` | `256-512MB` | `G1GC` |
| **ä¸­å‹åº”ç”¨** | `4-8GB` | `1-2GB` | `G1GC` |
| **å¤§å‹åº”ç”¨** | `8-16GB` | `2-4GB` | `G1GC` |

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 æ€§èƒ½ä¼˜åŒ–æ ¸å¿ƒç­–ç•¥


```
ğŸ”¸ æ‰¹é‡å‘é€ï¼šå‡å°‘ç½‘ç»œå¼€é”€ï¼Œæå‡ååé‡
ğŸ”¸ å¼‚æ­¥å‘é€ï¼šé¿å…é˜»å¡ï¼Œæé«˜å¹¶å‘èƒ½åŠ›  
ğŸ”¸ è¿æ¥å¤ç”¨ï¼šå‡å°‘è¿æ¥å¼€é”€ï¼Œåˆç†èµ„æºåˆ©ç”¨
ğŸ”¸ åºåˆ—åŒ–ä¼˜åŒ–ï¼šé€‰æ‹©é«˜æ•ˆåºåˆ—åŒ–ï¼Œå‡å°‘æ•°æ®é‡
ğŸ”¸ å†…å­˜ç®¡ç†ï¼šé¿å…å†…å­˜æ³„æ¼ï¼Œä¼˜åŒ–GCæ€§èƒ½
```

### 7.2 ä¼˜åŒ–æ•ˆæœå¯¹æ¯”


**ğŸ“Š ä¼˜åŒ–å‰åæ€§èƒ½å¯¹æ¯”**
| ä¼˜åŒ–é¡¹ç›® | **ä¼˜åŒ–å‰** | **ä¼˜åŒ–å** | **æå‡å¹…åº¦** |
|---------|-----------|-----------|-------------|
| **æ¶ˆæ¯å‘é€ååé‡** | `1000 msg/s` | `10000 msg/s` | `10å€` |
| **å“åº”æ—¶é—´** | `100ms` | `10ms` | `90%é™ä½` |
| **å†…å­˜ä½¿ç”¨** | `2GB` | `800MB` | `60%å‡å°‘` |
| **CPUä½¿ç”¨ç‡** | `80%` | `30%` | `62%é™ä½` |

### 7.3 å®è·µå»ºè®®


**ğŸ¯ ä¼˜åŒ–ä¼˜å…ˆçº§**
1. **ç¬¬ä¸€ä¼˜å…ˆçº§**ï¼šè¿æ¥å¤ç”¨ + æ‰¹é‡å‘é€
2. **ç¬¬äºŒä¼˜å…ˆçº§**ï¼šå¼‚æ­¥å‘é€ + åºåˆ—åŒ–ä¼˜åŒ–
3. **ç¬¬ä¸‰ä¼˜å…ˆçº§**ï¼šå†…å­˜ç®¡ç† + JVMè°ƒä¼˜

**ğŸ’¡ ç›‘æ§æŒ‡æ ‡**
```
å…³é”®ç›‘æ§æŒ‡æ ‡ï¼š
- æ¶ˆæ¯å‘é€TPSï¼ˆæ¯ç§’äº‹åŠ¡æ•°ï¼‰
- å¹³å‡å“åº”æ—¶é—´
- é”™è¯¯ç‡
- å†…å­˜ä½¿ç”¨ç‡
- GCé¢‘ç‡
- è¿æ¥æ•°é‡
```

**ğŸ“‹ å¸¸è§é—®é¢˜è§£å†³**

> âŒ **é—®é¢˜1**ï¼šæ‰¹é‡å‘é€å¯¼è‡´æ¶ˆæ¯å»¶è¿Ÿ
> âœ… **è§£å†³**ï¼šè®¾ç½®åˆç†çš„æ‰¹é‡å¤§å°å’Œè¶…æ—¶æ—¶é—´

> âŒ **é—®é¢˜2**ï¼šå¼‚æ­¥å‘é€æ¶ˆæ¯ä¸¢å¤±  
> âœ… **è§£å†³**ï¼šå®ç°ç¡®è®¤æœºåˆ¶å’Œé‡è¯•ç­–ç•¥

> âŒ **é—®é¢˜3**ï¼šè¿æ¥æ± è€—å°½
> âœ… **è§£å†³**ï¼šç›‘æ§è¿æ¥ä½¿ç”¨æƒ…å†µï¼Œåˆç†è®¾ç½®æ± å¤§å°

> âŒ **é—®é¢˜4**ï¼šå†…å­˜æº¢å‡º
> âœ… **è§£å†³**ï¼šé™åˆ¶æ¶ˆæ¯å¤§å°ï¼Œå®ç°èƒŒå‹æœºåˆ¶

**æ ¸å¿ƒè®°å¿†**ï¼š
- RabbitMQç”Ÿäº§è€…ä¼˜åŒ–é‡ç‚¹åœ¨å‡å°‘ç½‘ç»œå¼€é”€
- æ‰¹é‡+å¼‚æ­¥æ˜¯æå‡æ€§èƒ½çš„é»„é‡‘ç»„åˆ
- è¿æ¥å¤ç”¨æ¯”åˆ›å»ºæ–°è¿æ¥æ•ˆç‡é«˜10å€ä»¥ä¸Š
- é€‰æ‹©åˆé€‚çš„åºåˆ—åŒ–æ–¹æ¡ˆèƒ½å‡å°‘50%çš„æ•°æ®ä¼ è¾“
- å†…å­˜ç®¡ç†ä¸å½“ä¼šå¯¼è‡´é¢‘ç¹GCå½±å“æ€§èƒ½