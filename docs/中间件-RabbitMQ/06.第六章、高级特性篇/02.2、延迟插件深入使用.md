---
title: 2ã€å»¶è¿Ÿæ’ä»¶æ·±å…¥ä½¿ç”¨
---
## ğŸ“š ç›®å½•

1. [å»¶è¿Ÿæ’ä»¶åŸºç¡€æ¦‚å¿µ](#1-å»¶è¿Ÿæ’ä»¶åŸºç¡€æ¦‚å¿µ)
2. [rabbitmq-delayed-message-exchangeæ’ä»¶è¯¦è§£](#2-rabbitmq-delayed-message-exchangeæ’ä»¶è¯¦è§£)
3. [x-delayed-messageç±»å‹æ·±å…¥ç†è§£](#3-x-delayed-messageç±»å‹æ·±å…¥ç†è§£)
4. [x-delayå¤´éƒ¨è®¾ç½®å®æˆ˜](#4-x-delayå¤´éƒ¨è®¾ç½®å®æˆ˜)
5. [å»¶è¿Ÿç²¾åº¦ä¸é™åˆ¶åˆ†æ](#5-å»¶è¿Ÿç²¾åº¦ä¸é™åˆ¶åˆ†æ)
6. [æ€§èƒ½å½±å“åˆ†æä¸ä¼˜åŒ–](#6-æ€§èƒ½å½±å“åˆ†æä¸ä¼˜åŒ–)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ å»¶è¿Ÿæ’ä»¶åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯å»¶è¿Ÿæ¶ˆæ¯


**ğŸ”¸ ç”Ÿæ´»åŒ–ç†è§£**
å»¶è¿Ÿæ¶ˆæ¯å°±åƒæˆ‘ä»¬ç”Ÿæ´»ä¸­çš„"å®šæ—¶æé†’"ï¼š
```
ç°å®åœºæ™¯ï¼š
è®¾å®šé—¹é’Ÿ â†’ æŒ‡å®šæ—¶é—´åå“èµ· â†’ æé†’æˆ‘ä»¬åšæŸäº‹

å»¶è¿Ÿæ¶ˆæ¯ï¼š
å‘é€æ¶ˆæ¯ â†’ æŒ‡å®šæ—¶é—´åæŠ•é€’ â†’ è§¦å‘ä¸šåŠ¡å¤„ç†
```

**ğŸ’¡ æ ¸å¿ƒæ¦‚å¿µ**
```
å»¶è¿Ÿæ¶ˆæ¯ = ç°åœ¨å‘é€ + æœªæ¥æŠ•é€’
â€¢ å‘é€æ—¶é—´ï¼šç«‹å³å‘é€åˆ°MQ
â€¢ æŠ•é€’æ—¶é—´ï¼šæŒ‰è®¾å®šå»¶è¿Ÿåæ‰åˆ°è¾¾æ¶ˆè´¹è€…
â€¢ åº”ç”¨åœºæ™¯ï¼šå®šæ—¶ä»»åŠ¡ã€è¶…æ—¶å¤„ç†ã€ä¸šåŠ¡æµç¨‹æ§åˆ¶
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦å»¶è¿Ÿæ¶ˆæ¯


**ğŸ”¸ å®é™…ä¸šåŠ¡éœ€æ±‚**
```
è®¢å•æ”¯ä»˜åœºæ™¯ï¼š
ä¸‹å• â†’ 15åˆ†é’Ÿåæ£€æŸ¥ â†’ æœªæ”¯ä»˜åˆ™å–æ¶ˆè®¢å•

ç”¨æˆ·æ³¨å†Œåœºæ™¯ï¼š
æ³¨å†Œ â†’ 24å°æ—¶åæ£€æŸ¥ â†’ æœªæ¿€æ´»åˆ™åˆ é™¤è´¦å·

ä¼šå‘˜åˆ°æœŸåœºæ™¯ï¼š
ä¼šå‘˜åˆ°æœŸå‰3å¤© â†’ å‘é€ç»­è´¹æé†’ â†’ æå‡ç”¨æˆ·ä½“éªŒ
```

**âš–ï¸ ä¼ ç»Ÿæ–¹æ¡ˆ vs å»¶è¿Ÿæ¶ˆæ¯**
| å¯¹æ¯”é¡¹ | **ä¼ ç»Ÿè½®è¯¢æ–¹æ¡ˆ** | **å»¶è¿Ÿæ¶ˆæ¯æ–¹æ¡ˆ** | **ä¼˜åŠ¿å¯¹æ¯”** |
|--------|----------------|----------------|-------------|
| ğŸ”„ **å®æ—¶æ€§** | `å®šæ—¶æ‰«æï¼Œæœ‰å»¶è¿Ÿ` | `ç²¾ç¡®åˆ°ç§’çº§` | `å»¶è¿Ÿæ¶ˆæ¯æ›´å‡†ç¡®` |
| ğŸ’¾ **èµ„æºæ¶ˆè€—** | `æŒç»­æŸ¥è¯¢æ•°æ®åº“` | `å†…å­˜æš‚å­˜ï¼ŒæŒ‰æ—¶æŠ•é€’` | `å»¶è¿Ÿæ¶ˆæ¯æ›´èŠ‚çœ` |
| ğŸ¯ **å‡†ç¡®æ€§** | `å¯èƒ½é—æ¼æˆ–é‡å¤` | `ä¿è¯ä¸€æ¬¡æŠ•é€’` | `å»¶è¿Ÿæ¶ˆæ¯æ›´å¯é ` |
| ğŸ”§ **ç»´æŠ¤æ€§** | `å¤æ‚çš„å®šæ—¶ä»»åŠ¡` | `ç®€å•çš„æ¶ˆæ¯å‘é€` | `å»¶è¿Ÿæ¶ˆæ¯æ›´ç®€å•` |

---

## 2. ğŸ”Œ rabbitmq-delayed-message-exchangeæ’ä»¶è¯¦è§£


### 2.1 æ’ä»¶åŸºæœ¬ä»‹ç»


**ğŸ”¸ æ’ä»¶æœ¬è´¨**
```
rabbitmq-delayed-message-exchange æ˜¯ RabbitMQ çš„å®˜æ–¹æ’ä»¶
ä½œç”¨ï¼šä¸º RabbitMQ å¢åŠ åŸç”Ÿçš„å»¶è¿Ÿæ¶ˆæ¯åŠŸèƒ½
åŸç†ï¼šåœ¨äº¤æ¢æœºå±‚é¢æš‚å­˜æ¶ˆæ¯ï¼Œåˆ°æ—¶é—´åæ‰è·¯ç”±åˆ°é˜Ÿåˆ—
```

**ğŸ’¡ å·¥ä½œåŸç†å›¾ç¤º**
```
ä¼ ç»Ÿæ¶ˆæ¯æµç¨‹ï¼š
ç”Ÿäº§è€… â†’ Exchange â†’ Queue â†’ æ¶ˆè´¹è€…
         (ç«‹å³è·¯ç”±)

å»¶è¿Ÿæ¶ˆæ¯æµç¨‹ï¼š
ç”Ÿäº§è€… â†’ Delayed Exchange â†’ [æš‚å­˜åŒº] â†’ Queue â†’ æ¶ˆè´¹è€…
         (å»¶è¿Ÿè·¯ç”±)            (åˆ°æ—¶æŠ•é€’)
```

### 2.2 æ’ä»¶å®‰è£…ä¸å¯ç”¨


**ğŸ”§ å®‰è£…æ­¥éª¤**
```bash
# 1. ä¸‹è½½æ’ä»¶ï¼ˆç‰ˆæœ¬è¦åŒ¹é…RabbitMQç‰ˆæœ¬ï¼‰
wget https://github.com/rabbitmq/rabbitmq-delayed-message-exchange/releases/download/v3.10.2/rabbitmq_delayed_message_exchange-3.10.2.ez

# 2. å¤åˆ¶åˆ°æ’ä»¶ç›®å½•
cp rabbitmq_delayed_message_exchange-3.10.2.ez $RABBITMQ_HOME/plugins/

# 3. å¯ç”¨æ’ä»¶
rabbitmq-plugins enable rabbitmq_delayed_message_exchange

# 4. éªŒè¯æ’ä»¶çŠ¶æ€
rabbitmq-plugins list | grep delayed
```

**âœ… å®‰è£…éªŒè¯**
```bash
# æŸ¥çœ‹æ’ä»¶æ˜¯å¦æ­£å¸¸å¯ç”¨
rabbitmqctl status | grep delayed

# é€šè¿‡ç®¡ç†ç•Œé¢éªŒè¯ï¼ˆhttp://localhost:15672ï¼‰
# Exchangesé¡µé¢ â†’ Add Exchange â†’ Typeä¸‹æ‹‰æ¡†åº”è¯¥æœ‰ x-delayed-message é€‰é¡¹
```

### 2.3 æ’ä»¶ç‰¹æ€§ä¸é™åˆ¶


**ğŸŒŸ æ ¸å¿ƒç‰¹æ€§**
```
æ”¯æŒç‰¹æ€§ï¼š
â€¢ ä»»æ„æ—¶é•¿å»¶è¿Ÿï¼ˆæ¯«ç§’çº§ç²¾åº¦ï¼‰
â€¢ æŒä¹…åŒ–å»¶è¿Ÿæ¶ˆæ¯ï¼ˆé‡å¯ä¸ä¸¢å¤±ï¼‰
â€¢ é›†ç¾¤æ¨¡å¼æ”¯æŒ
â€¢ ä¸ç°æœ‰ä»£ç å…¼å®¹
â€¢ æ”¯æŒæ¶ˆæ¯ç¡®è®¤æœºåˆ¶
```

**âš ï¸ ä½¿ç”¨é™åˆ¶**
```
æ³¨æ„äº‹é¡¹ï¼š
â€¢ å»¶è¿Ÿæ¶ˆæ¯å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼ˆå¤§é‡å»¶è¿Ÿæ¶ˆæ¯ä¼šå ç”¨å†…å­˜ï¼‰
â€¢ æœ€å¤§å»¶è¿Ÿæ—¶é—´å—ç³»ç»Ÿé™åˆ¶ï¼ˆé€šå¸¸ä¸º2^32-1æ¯«ç§’ï¼‰
â€¢ ä¸æ”¯æŒæ¶ˆæ¯ä¼˜å…ˆçº§
â€¢ å»¶è¿Ÿç²¾åº¦ä¾èµ–ç³»ç»Ÿæ—¶é’Ÿ
```

---

## 3. ğŸ“‹ x-delayed-messageç±»å‹æ·±å…¥ç†è§£


### 3.1 Exchangeç±»å‹è¯´æ˜


**ğŸ”¸ ä»€ä¹ˆæ˜¯x-delayed-message**
```
x-delayed-message æ˜¯æ’ä»¶æä¾›çš„æ–°äº¤æ¢æœºç±»å‹
æœ¬è´¨ï¼šåœ¨åŸæœ‰äº¤æ¢æœºç±»å‹åŸºç¡€ä¸Šå¢åŠ å»¶è¿ŸåŠŸèƒ½
æ”¯æŒï¼šdirectã€topicã€fanoutã€headers ç­‰æ‰€æœ‰è·¯ç”±ç±»å‹
```

**ğŸ’¡ ç±»å‹å¯¹æ¯”**
```
æ™®é€šExchangeï¼š
Type: direct/topic/fanout â†’ ç«‹å³è·¯ç”±æ¶ˆæ¯

å»¶è¿ŸExchangeï¼š
Type: x-delayed-message â†’ å…ˆæš‚å­˜ï¼Œåè·¯ç”±
Arguments: x-delayed-type = direct/topic/fanout â†’ æŒ‡å®šçœŸå®è·¯ç”±ç±»å‹
```

### 3.2 åˆ›å»ºå»¶è¿Ÿäº¤æ¢æœº


**ğŸ”§ Javaä»£ç åˆ›å»º**
```java
// åˆ›å»ºå»¶è¿Ÿäº¤æ¢æœºçš„å®Œæ•´ç¤ºä¾‹
@Configuration
public class DelayedExchangeConfig {
    
    // åˆ›å»ºå»¶è¿Ÿäº¤æ¢æœº
    @Bean
    public Exchange delayedExchange() {
        Map<String, Object> args = new HashMap<>();
        // æŒ‡å®šçœŸå®çš„è·¯ç”±ç±»å‹ï¼ˆè¿™é‡Œä½¿ç”¨directï¼‰
        args.put("x-delayed-type", "direct");
        
        return ExchangeBuilder
                .directExchange("delayed.exchange")  // äº¤æ¢æœºåç§°
                .delayed()                           // å£°æ˜ä¸ºå»¶è¿Ÿç±»å‹
                .withArguments(args)                 // ä¼ å…¥å‚æ•°
                .durable(true)                       // æŒä¹…åŒ–
                .build();
    }
    
    // åˆ›å»ºæ™®é€šé˜Ÿåˆ—ï¼ˆç”¨äºæ¥æ”¶å»¶è¿Ÿæ¶ˆæ¯ï¼‰
    @Bean
    public Queue delayedQueue() {
        return QueueBuilder
                .durable("delayed.queue")
                .build();
    }
    
    // ç»‘å®šå…³ç³»
    @Bean
    public Binding delayedBinding() {
        return BindingBuilder
                .bind(delayedQueue())
                .to(delayedExchange())
                .with("delayed.routing.key")         // è·¯ç”±é”®
                .noargs();
    }
}
```

**ğŸŒ ç®¡ç†ç•Œé¢åˆ›å»º**
```
æ­¥éª¤è¯´æ˜ï¼š
1. ç™»å½•RabbitMQç®¡ç†ç•Œé¢ï¼ˆhttp://localhost:15672ï¼‰
2. è¿›å…¥ Exchanges é¡µé¢
3. ç‚¹å‡» "Add a new exchange"
4. å¡«å†™é…ç½®ï¼š
   - Name: delayed.exchange
   - Type: x-delayed-messageï¼ˆæ’ä»¶å®‰è£…åå¯è§ï¼‰
   - Arguments: x-delayed-type = direct
   - Durable: Yes
5. ç‚¹å‡» "Add exchange" å®Œæˆåˆ›å»º
```

### 3.3 å»¶è¿Ÿäº¤æ¢æœºå·¥ä½œæœºåˆ¶


**ğŸ”„ æ¶ˆæ¯å¤„ç†æµç¨‹**
```
æ¶ˆæ¯å‘é€é˜¶æ®µï¼š
1. ç”Ÿäº§è€…å‘é€å¸¦æœ‰ x-delay å¤´éƒ¨çš„æ¶ˆæ¯
2. å»¶è¿Ÿäº¤æ¢æœºæ¥æ”¶æ¶ˆæ¯
3. æ£€æŸ¥ x-delay å€¼ï¼Œè®¡ç®—æŠ•é€’æ—¶é—´
4. å°†æ¶ˆæ¯æš‚å­˜åœ¨å†…éƒ¨å­˜å‚¨ä¸­

æ¶ˆæ¯æŠ•é€’é˜¶æ®µï¼š
1. å»¶è¿Ÿæ—¶é—´åˆ°è¾¾
2. äº¤æ¢æœºæ ¹æ® x-delayed-type å‚æ•°è·¯ç”±æ¶ˆæ¯
3. æ¶ˆæ¯æ­£å¸¸æŠ•é€’åˆ°ç»‘å®šçš„é˜Ÿåˆ—
4. æ¶ˆè´¹è€…æ¥æ”¶å¹¶å¤„ç†æ¶ˆæ¯
```

**ğŸ’¾ å†…éƒ¨å­˜å‚¨æœºåˆ¶**
```
å­˜å‚¨ç‰¹ç‚¹ï¼š
â€¢ å»¶è¿Ÿæ¶ˆæ¯å­˜å‚¨åœ¨Exchangeå†…éƒ¨ï¼ˆä¸åœ¨Queueä¸­ï¼‰
â€¢ ä½¿ç”¨å†…å­˜å­˜å‚¨ï¼Œæ”¯æŒæŒä¹…åŒ–åˆ°ç£ç›˜
â€¢ é‡å¯åå»¶è¿Ÿæ¶ˆæ¯ä¼šæ¢å¤ï¼ˆå¦‚æœè®¾ç½®äº†æŒä¹…åŒ–ï¼‰
â€¢ å¤§é‡å»¶è¿Ÿæ¶ˆæ¯ä¼šå ç”¨ç›¸åº”å†…å­˜ç©ºé—´
```

---

## 4. â° x-delayå¤´éƒ¨è®¾ç½®å®æˆ˜


### 4.1 x-delayå¤´éƒ¨åŸºç¡€


**ğŸ”¸ å¤´éƒ¨ä½œç”¨è¯´æ˜**
```
x-delayï¼šæ¶ˆæ¯å¤´éƒ¨å±æ€§ï¼ŒæŒ‡å®šå»¶è¿Ÿæ—¶é—´
å•ä½ï¼šæ¯«ç§’ï¼ˆmillisecondsï¼‰
ç±»å‹ï¼šæ•´æ•°ï¼ˆIntegerï¼‰
èŒƒå›´ï¼š0 åˆ° 2^32-1 æ¯«ç§’ï¼ˆçº¦49å¤©ï¼‰
```

**ğŸ’¡ æ—¶é—´è®¡ç®—åŠ©æ‰‹**
```
å¸¸ç”¨æ—¶é—´æ¢ç®—ï¼š
â€¢ 1ç§’ = 1,000æ¯«ç§’
â€¢ 1åˆ†é’Ÿ = 60,000æ¯«ç§’
â€¢ 1å°æ—¶ = 3,600,000æ¯«ç§’
â€¢ 1å¤© = 86,400,000æ¯«ç§’

å®é™…ç¤ºä¾‹ï¼š
â€¢ å»¶è¿Ÿ5ç§’ï¼šx-delay = 5000
â€¢ å»¶è¿Ÿ10åˆ†é’Ÿï¼šx-delay = 600000
â€¢ å»¶è¿Ÿ1å°æ—¶ï¼šx-delay = 3600000
```

### 4.2 å‘é€å»¶è¿Ÿæ¶ˆæ¯å®æˆ˜


**ğŸ”§ Spring Bootå‘é€ç¤ºä¾‹**
```java
@Service
public class DelayedMessageService {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    /**
     * å‘é€å»¶è¿Ÿæ¶ˆæ¯ - åŸºç¡€ç‰ˆæœ¬
     * @param message æ¶ˆæ¯å†…å®¹
     * @param delaySeconds å»¶è¿Ÿç§’æ•°
     */
    public void sendDelayedMessage(String message, int delaySeconds) {
        // è®¡ç®—å»¶è¿Ÿæ¯«ç§’æ•°
        int delayMillis = delaySeconds * 1000;
        
        // è®¾ç½®æ¶ˆæ¯å±æ€§
        rabbitTemplate.convertAndSend(
            "delayed.exchange",           // äº¤æ¢æœºåç§°
            "delayed.routing.key",        // è·¯ç”±é”®
            message,                      // æ¶ˆæ¯å†…å®¹
            messageProcessor -> {
                // è®¾ç½®å»¶è¿Ÿæ—¶é—´
                messageProcessor.getMessageProperties()
                    .setHeader("x-delay", delayMillis);
                return messageProcessor;
            }
        );
        
        log.info("å‘é€å»¶è¿Ÿæ¶ˆæ¯ï¼š{}, å»¶è¿Ÿ{}ç§’", message, delaySeconds);
    }
    
    /**
     * å‘é€å»¶è¿Ÿæ¶ˆæ¯ - å¢å¼ºç‰ˆæœ¬
     * @param message æ¶ˆæ¯å†…å®¹
     * @param delayMillis å»¶è¿Ÿæ¯«ç§’æ•°
     * @param routingKey è·¯ç”±é”®
     */
    public void sendDelayedMessageAdvanced(Object message, 
                                         long delayMillis, 
                                         String routingKey) {
        // éªŒè¯å»¶è¿Ÿæ—¶é—´èŒƒå›´
        if (delayMillis < 0 || delayMillis > Integer.MAX_VALUE) {
            throw new IllegalArgumentException("å»¶è¿Ÿæ—¶é—´è¶…å‡ºèŒƒå›´");
        }
        
        // åˆ›å»ºæ¶ˆæ¯å±æ€§
        MessageProperties properties = new MessageProperties();
        properties.setHeader("x-delay", delayMillis);
        properties.setDeliveryMode(MessageDeliveryMode.PERSISTENT); // æŒä¹…åŒ–
        properties.setContentType("application/json");
        
        // åºåˆ—åŒ–æ¶ˆæ¯
        String jsonMessage = JSON.toJSONString(message);
        Message msg = new Message(jsonMessage.getBytes(StandardCharsets.UTF_8), properties);
        
        // å‘é€æ¶ˆæ¯
        rabbitTemplate.send("delayed.exchange", routingKey, msg);
        
        log.info("å‘é€å»¶è¿Ÿæ¶ˆæ¯åˆ°è·¯ç”±é”®ï¼š{}, å»¶è¿Ÿ{}æ¯«ç§’", routingKey, delayMillis);
    }
}
```

**ğŸ¯ ä¸šåŠ¡åœºæ™¯åº”ç”¨**
```java
@RestController
public class OrderController {
    
    @Autowired
    private DelayedMessageService delayedMessageService;
    
    /**
     * åˆ›å»ºè®¢å• - è‡ªåŠ¨è®¾ç½®æ”¯ä»˜è¶…æ—¶æ£€æŸ¥
     */
    @PostMapping("/order/create")
    public ResponseEntity<String> createOrder(@RequestBody OrderDTO orderDTO) {
        // 1. åˆ›å»ºè®¢å•
        Order order = orderService.createOrder(orderDTO);
        
        // 2. å‘é€å»¶è¿Ÿæ¶ˆæ¯ - 15åˆ†é’Ÿåæ£€æŸ¥æ”¯ä»˜çŠ¶æ€
        PaymentCheckMessage checkMessage = PaymentCheckMessage.builder()
            .orderId(order.getId())
            .createTime(System.currentTimeMillis())
            .action("PAYMENT_TIMEOUT_CHECK")
            .build();
            
        // å»¶è¿Ÿ15åˆ†é’Ÿ = 15 * 60 * 1000 = 900000æ¯«ç§’
        delayedMessageService.sendDelayedMessageAdvanced(
            checkMessage, 
            900000L, 
            "order.payment.check"
        );
        
        log.info("è®¢å•åˆ›å»ºæˆåŠŸï¼Œå·²è®¾ç½®15åˆ†é’Ÿæ”¯ä»˜è¶…æ—¶æ£€æŸ¥ï¼Œè®¢å•IDï¼š{}", order.getId());
        return ResponseEntity.ok("è®¢å•åˆ›å»ºæˆåŠŸ");
    }
    
    /**
     * ç”¨æˆ·æ³¨å†Œ - è®¾ç½®æ¿€æ´»æé†’
     */
    @PostMapping("/user/register")
    public ResponseEntity<String> registerUser(@RequestBody UserDTO userDTO) {
        // 1. åˆ›å»ºç”¨æˆ·
        User user = userService.createUser(userDTO);
        
        // 2. å‘é€æ¿€æ´»é‚®ä»¶
        emailService.sendActivationEmail(user);
        
        // 3. è®¾ç½®å»¶è¿Ÿæé†’ - 24å°æ—¶åæ£€æŸ¥æ¿€æ´»çŠ¶æ€
        UserActivationCheckMessage checkMessage = UserActivationCheckMessage.builder()
            .userId(user.getId())
            .email(user.getEmail())
            .registerTime(System.currentTimeMillis())
            .build();
            
        // å»¶è¿Ÿ24å°æ—¶ = 24 * 60 * 60 * 1000 = 86400000æ¯«ç§’
        delayedMessageService.sendDelayedMessageAdvanced(
            checkMessage, 
            86400000L, 
            "user.activation.check"
        );
        
        return ResponseEntity.ok("æ³¨å†ŒæˆåŠŸï¼Œè¯·æŸ¥æ”¶æ¿€æ´»é‚®ä»¶");
    }
}
```

### 4.3 æ¶ˆè´¹å»¶è¿Ÿæ¶ˆæ¯


**ğŸ”§ æ¶ˆè´¹è€…å®ç°**
```java
@Component
public class DelayedMessageConsumer {
    
    /**
     * è®¢å•æ”¯ä»˜è¶…æ—¶æ£€æŸ¥æ¶ˆè´¹è€…
     */
    @RabbitListener(queues = "delayed.queue")
    public void handlePaymentTimeoutCheck(
            @Payload String messageBody,
            @Header Map<String, Object> headers,
            Channel channel,
            @Header(AmqpHeaders.DELIVERY_TAG) long deliveryTag) {
        
        try {
            log.info("æ¥æ”¶åˆ°å»¶è¿Ÿæ¶ˆæ¯ï¼š{}", messageBody);
            
            // è§£ææ¶ˆæ¯
            PaymentCheckMessage checkMessage = JSON.parseObject(messageBody, PaymentCheckMessage.class);
            
            // æ£€æŸ¥è®¢å•æ”¯ä»˜çŠ¶æ€
            Order order = orderService.getOrder(checkMessage.getOrderId());
            if (order == null) {
                log.warn("è®¢å•ä¸å­˜åœ¨ï¼š{}", checkMessage.getOrderId());
                channel.basicAck(deliveryTag, false);
                return;
            }
            
            // å¦‚æœè®¢å•ä»æœªæ”¯ä»˜ï¼Œæ‰§è¡Œå–æ¶ˆé€»è¾‘
            if (order.getStatus() == OrderStatus.UNPAID) {
                log.info("è®¢å•æ”¯ä»˜è¶…æ—¶ï¼Œå¼€å§‹å–æ¶ˆè®¢å•ï¼š{}", order.getId());
                
                // å–æ¶ˆè®¢å•
                orderService.cancelOrder(order.getId(), "æ”¯ä»˜è¶…æ—¶è‡ªåŠ¨å–æ¶ˆ");
                
                // å‘é€å–æ¶ˆé€šçŸ¥
                notificationService.sendOrderCancelNotification(order);
                
                log.info("è®¢å•å–æ¶ˆå®Œæˆï¼š{}", order.getId());
            } else {
                log.info("è®¢å•å·²æ”¯ä»˜ï¼Œæ— éœ€å¤„ç†ï¼š{}", order.getId());
            }
            
            // ç¡®è®¤æ¶ˆæ¯
            channel.basicAck(deliveryTag, false);
            
        } catch (Exception e) {
            log.error("å¤„ç†å»¶è¿Ÿæ¶ˆæ¯å¤±è´¥ï¼š{}", messageBody, e);
            // æ ¹æ®ä¸šåŠ¡éœ€è¦å†³å®šæ˜¯å¦é‡è¯•
            try {
                channel.basicReject(deliveryTag, false); // ä¸é‡æ–°å…¥é˜Ÿ
            } catch (IOException ioException) {
                log.error("æ¶ˆæ¯ç¡®è®¤å¤±è´¥", ioException);
            }
        }
    }
    
    /**
     * ç”¨æˆ·æ¿€æ´»æ£€æŸ¥æ¶ˆè´¹è€…
     */
    @RabbitListener(queues = "user.activation.queue")
    public void handleUserActivationCheck(
            @Payload String messageBody,
            Channel channel,
            @Header(AmqpHeaders.DELIVERY_TAG) long deliveryTag) {
        
        try {
            UserActivationCheckMessage checkMessage = JSON.parseObject(messageBody, UserActivationCheckMessage.class);
            
            // æ£€æŸ¥ç”¨æˆ·æ¿€æ´»çŠ¶æ€
            User user = userService.getUser(checkMessage.getUserId());
            if (user != null && !user.isActivated()) {
                // ç”¨æˆ·æœªæ¿€æ´»ï¼Œå‘é€æé†’é‚®ä»¶
                emailService.sendActivationReminder(user);
                log.info("å‘é€æ¿€æ´»æé†’é‚®ä»¶ç»™ç”¨æˆ·ï¼š{}", user.getEmail());
            }
            
            channel.basicAck(deliveryTag, false);
            
        } catch (Exception e) {
            log.error("å¤„ç†ç”¨æˆ·æ¿€æ´»æ£€æŸ¥å¤±è´¥ï¼š{}", messageBody, e);
            try {
                channel.basicReject(deliveryTag, false);
            } catch (IOException ioException) {
                log.error("æ¶ˆæ¯ç¡®è®¤å¤±è´¥", ioException);
            }
        }
    }
}
```

---

## 5. ğŸ¯ å»¶è¿Ÿç²¾åº¦ä¸é™åˆ¶åˆ†æ


### 5.1 å»¶è¿Ÿç²¾åº¦å½±å“å› ç´ 


**ğŸ”¸ ç²¾åº¦çº§åˆ«è¯´æ˜**
```
ç†è®ºç²¾åº¦ï¼šæ¯«ç§’çº§ï¼ˆæœ€å°1æ¯«ç§’ï¼‰
å®é™…ç²¾åº¦ï¼šå—å¤šä¸ªå› ç´ å½±å“

å½±å“å› ç´ ï¼š
â€¢ ç³»ç»Ÿæ—¶é’Ÿç²¾åº¦ï¼ˆé€šå¸¸ä¸ºæ¯«ç§’çº§ï¼‰
â€¢ JVMåƒåœ¾å›æ”¶ï¼ˆå¯èƒ½é€ æˆå»¶è¿Ÿï¼‰
â€¢ ç½‘ç»œå»¶è¿Ÿï¼ˆæ¶ˆæ¯ä¼ è¾“æ—¶é—´ï¼‰
â€¢ æœåŠ¡å™¨è´Ÿè½½ï¼ˆCPUã€å†…å­˜å‹åŠ›ï¼‰
â€¢ RabbitMQå†…éƒ¨è°ƒåº¦å™¨ç²¾åº¦
```

**â±ï¸ å®é™…ç²¾åº¦æµ‹è¯•**
```java
@Component
public class DelayPrecisionTest {
    
    @Autowired
    private DelayedMessageService delayedMessageService;
    
    /**
     * æµ‹è¯•å»¶è¿Ÿç²¾åº¦
     */
    public void testDelayPrecision() {
        long sendTime = System.currentTimeMillis();
        
        // å‘é€1ç§’å»¶è¿Ÿæ¶ˆæ¯
        delayedMessageService.sendDelayedMessage(
            "ç²¾åº¦æµ‹è¯•æ¶ˆæ¯,å‘é€æ—¶é—´:" + sendTime, 1
        );
        
        log.info("æ¶ˆæ¯å‘é€æ—¶é—´ï¼š{}", new Date(sendTime));
    }
    
    @RabbitListener(queues = "delayed.queue")
    public void receiveTestMessage(String message) {
        long receiveTime = System.currentTimeMillis();
        log.info("æ¶ˆæ¯æ¥æ”¶æ—¶é—´ï¼š{}", new Date(receiveTime));
        log.info("æ¥æ”¶æ¶ˆæ¯ï¼š{}", message);
        
        // æå–å‘é€æ—¶é—´å¹¶è®¡ç®—å®é™…å»¶è¿Ÿ
        String[] parts = message.split(":");
        if (parts.length > 1) {
            long sendTime = Long.parseLong(parts[1]);
            long actualDelay = receiveTime - sendTime;
            log.info("é¢„æœŸå»¶è¿Ÿï¼š1000msï¼Œå®é™…å»¶è¿Ÿï¼š{}msï¼Œè¯¯å·®ï¼š{}ms", 
                    actualDelay, Math.abs(actualDelay - 1000));
        }
    }
}
```

### 5.2 æ—¶é—´èŒƒå›´é™åˆ¶


**ğŸ”¸ å»¶è¿Ÿæ—¶é—´é™åˆ¶**
```
æœ€å°å»¶è¿Ÿï¼š0æ¯«ç§’ï¼ˆç«‹å³æŠ•é€’ï¼‰
æœ€å¤§å»¶è¿Ÿï¼š2^32-1 æ¯«ç§’ â‰ˆ 2,147,483,647æ¯«ç§’
æ¢ç®—ï¼šçº¦49.7å¤©

è¶…è¿‡èŒƒå›´çš„å¤„ç†ï¼š
â€¢ å°äº0ï¼šå½“ä½œ0å¤„ç†ï¼ˆç«‹å³æŠ•é€’ï¼‰
â€¢ å¤§äºæœ€å¤§å€¼ï¼šæŠ›å‡ºå¼‚å¸¸æˆ–å½“ä½œæœ€å¤§å€¼å¤„ç†
```

**ğŸ“Š æ—¶é—´èŒƒå›´å®ç”¨å¯¹ç…§è¡¨**
| æ—¶é—´æè¿° | **æ¯«ç§’æ•°** | **æ˜¯å¦æ”¯æŒ** | **å®é™…åº”ç”¨** |
|----------|-----------|-------------|-------------|
| 1ç§’ | `1,000` | âœ… å®Œç¾æ”¯æŒ | `çŸ­ä¿¡éªŒè¯ç ` |
| 1åˆ†é’Ÿ | `60,000` | âœ… å®Œç¾æ”¯æŒ | `ç¼“å­˜åˆ·æ–°` |
| 1å°æ—¶ | `3,600,000` | âœ… å®Œç¾æ”¯æŒ | `è®¢å•è¶…æ—¶` |
| 1å¤© | `86,400,000` | âœ… å®Œç¾æ”¯æŒ | `ç”¨æˆ·æ¿€æ´»` |
| 1å‘¨ | `604,800,000` | âœ… å®Œç¾æ”¯æŒ | `ä¼šå‘˜åˆ°æœŸæé†’` |
| 1ä¸ªæœˆ | `2,592,000,000` | âŒ è¶…å‡ºèŒƒå›´ | `éœ€è¦å…¶ä»–æ–¹æ¡ˆ` |

### 5.3 è¾¹ç•Œæƒ…å†µå¤„ç†


**ğŸ”§ å®‰å…¨å»¶è¿Ÿå‘é€å·¥å…·**
```java
@Component
public class SafeDelayedSender {
    
    private static final long MAX_DELAY_MILLIS = 2147483647L; // æœ€å¤§å»¶è¿Ÿ
    private static final long ONE_DAY_MILLIS = 86400000L;     // ä¸€å¤©æ¯«ç§’æ•°
    
    @Autowired
    private DelayedMessageService delayedMessageService;
    
    /**
     * å®‰å…¨å‘é€å»¶è¿Ÿæ¶ˆæ¯ - è‡ªåŠ¨å¤„ç†è¾¹ç•Œæƒ…å†µ
     */
    public void sendSafeDelayedMessage(String message, long delayMillis, String routingKey) {
        // è¾¹ç•Œæ£€æŸ¥
        if (delayMillis < 0) {
            log.warn("å»¶è¿Ÿæ—¶é—´å°äº0ï¼Œè°ƒæ•´ä¸ºç«‹å³å‘é€");
            delayMillis = 0;
        }
        
        if (delayMillis > MAX_DELAY_MILLIS) {
            log.warn("å»¶è¿Ÿæ—¶é—´è¶…è¿‡æœ€å¤§å€¼({})ï¼Œè°ƒæ•´ä¸ºæœ€å¤§å»¶è¿Ÿ", MAX_DELAY_MILLIS);
            delayMillis = MAX_DELAY_MILLIS;
        }
        
        // å‘é€æ¶ˆæ¯
        delayedMessageService.sendDelayedMessageAdvanced(message, delayMillis, routingKey);
        
        // è®°å½•æ—¥å¿—
        log.info("å®‰å…¨å‘é€å»¶è¿Ÿæ¶ˆæ¯ï¼šå»¶è¿Ÿ{}æ¯«ç§’ ({}å¤©)", 
                delayMillis, delayMillis / ONE_DAY_MILLIS);
    }
    
    /**
     * é•¿æœŸå»¶è¿Ÿæ¶ˆæ¯å¤„ç†æ–¹æ¡ˆ
     * å¯¹äºè¶…è¿‡49å¤©çš„å»¶è¿Ÿï¼Œåˆ†é˜¶æ®µå¤„ç†
     */
    public void sendLongTermDelayedMessage(String message, long totalDelayDays, String finalRoutingKey) {
        if (totalDelayDays <= 49) {
            // åœ¨èŒƒå›´å†…ï¼Œç›´æ¥å‘é€
            long delayMillis = totalDelayDays * ONE_DAY_MILLIS;
            sendSafeDelayedMessage(message, delayMillis, finalRoutingKey);
        } else {
            // è¶…å‡ºèŒƒå›´ï¼Œä½¿ç”¨åˆ†é˜¶æ®µæ–¹æ¡ˆ
            log.info("æ€»å»¶è¿Ÿ{}å¤©è¶…å‡ºèŒƒå›´ï¼Œä½¿ç”¨åˆ†é˜¶æ®µå»¶è¿Ÿ", totalDelayDays);
            
            // ç¬¬ä¸€é˜¶æ®µï¼šå»¶è¿Ÿ49å¤©åé‡æ–°è¯„ä¼°
            LongTermDelayMessage stageMessage = LongTermDelayMessage.builder()
                .originalMessage(message)
                .remainingDays(totalDelayDays - 49)
                .finalRoutingKey(finalRoutingKey)
                .stage(1)
                .build();
                
            sendSafeDelayedMessage(
                JSON.toJSONString(stageMessage), 
                MAX_DELAY_MILLIS, 
                "long.term.delay.stage"
            );
        }
    }
    
    /**
     * åˆ†é˜¶æ®µå»¶è¿Ÿæ¶ˆæ¯å¤„ç†å™¨
     */
    @RabbitListener(queues = "long.term.delay.queue")
    public void handleLongTermStage(String messageBody) {
        LongTermDelayMessage stageMessage = JSON.parseObject(messageBody, LongTermDelayMessage.class);
        
        if (stageMessage.getRemainingDays() <= 49) {
            // æœ€åé˜¶æ®µï¼Œå‘é€åˆ°æœ€ç»ˆç›®æ ‡
            long finalDelayMillis = stageMessage.getRemainingDays() * ONE_DAY_MILLIS;
            sendSafeDelayedMessage(
                stageMessage.getOriginalMessage(), 
                finalDelayMillis, 
                stageMessage.getFinalRoutingKey()
            );
            log.info("é•¿æœŸå»¶è¿Ÿæ¶ˆæ¯æœ€åé˜¶æ®µï¼šè¿˜éœ€å»¶è¿Ÿ{}å¤©", stageMessage.getRemainingDays());
        } else {
            // ç»§ç»­ä¸‹ä¸€é˜¶æ®µ
            stageMessage.setRemainingDays(stageMessage.getRemainingDays() - 49);
            stageMessage.setStage(stageMessage.getStage() + 1);
            
            sendSafeDelayedMessage(
                JSON.toJSONString(stageMessage), 
                MAX_DELAY_MILLIS, 
                "long.term.delay.stage"
            );
            log.info("é•¿æœŸå»¶è¿Ÿæ¶ˆæ¯ç¬¬{}é˜¶æ®µï¼šè¿˜éœ€å»¶è¿Ÿ{}å¤©", 
                    stageMessage.getStage(), stageMessage.getRemainingDays());
        }
    }
}
```

---

## 6. ğŸ“Š æ€§èƒ½å½±å“åˆ†æä¸ä¼˜åŒ–


### 6.1 å†…å­˜ä½¿ç”¨åˆ†æ


**ğŸ”¸ å†…å­˜å ç”¨æœºåˆ¶**
```
å­˜å‚¨ä½ç½®ï¼šå»¶è¿Ÿæ¶ˆæ¯å­˜å‚¨åœ¨Exchangeå†…å­˜ä¸­
å ç”¨è®¡ç®—ï¼šæ¯æ¡æ¶ˆæ¯å ç”¨ = æ¶ˆæ¯å¤§å° + å…ƒæ•°æ®å¼€é”€

å½±å“å› ç´ ï¼š
â€¢ å»¶è¿Ÿæ¶ˆæ¯æ•°é‡
â€¢ å•æ¡æ¶ˆæ¯å¤§å°  
â€¢ å»¶è¿Ÿæ—¶é—´é•¿çŸ­
â€¢ é›†ç¾¤èŠ‚ç‚¹æ•°é‡
```

**ğŸ“Š å†…å­˜ä½¿ç”¨ä¼°ç®—**
```java
@Component
public class DelayedMessageMemoryAnalyzer {
    
    /**
     * ä¼°ç®—å»¶è¿Ÿæ¶ˆæ¯å†…å­˜å ç”¨
     */
    public void analyzeMemoryUsage() {
        // å‡è®¾åœºæ™¯ï¼šç”µå•†å¹³å°è®¢å•è¶…æ—¶æ£€æŸ¥
        int dailyOrders = 10000;              // æ¯æ—¥è®¢å•é‡
        int messageSize = 500;                // æ¯æ¡æ¶ˆæ¯500å­—èŠ‚
        int metadataOverhead = 200;           // å…ƒæ•°æ®å¼€é”€200å­—èŠ‚
        int delayMinutes = 15;                // å»¶è¿Ÿ15åˆ†é’Ÿ
        
        // è®¡ç®—åŒæ—¶å­˜åœ¨çš„å»¶è¿Ÿæ¶ˆæ¯æ•°é‡
        double messagesPerMinute = dailyOrders / (24.0 * 60);  // æ¯åˆ†é’Ÿè®¢å•æ•°
        int concurrentMessages = (int)(messagesPerMinute * delayMinutes); // åŒæ—¶å­˜åœ¨çš„æ¶ˆæ¯æ•°
        
        // è®¡ç®—å†…å­˜å ç”¨
        long memoryPerMessage = messageSize + metadataOverhead;
        long totalMemoryBytes = concurrentMessages * memoryPerMessage;
        long totalMemoryMB = totalMemoryBytes / 1024 / 1024;
        
        log.info("=== å»¶è¿Ÿæ¶ˆæ¯å†…å­˜åˆ†æ ===");
        log.info("æ¯æ—¥è®¢å•é‡ï¼š{}", dailyOrders);
        log.info("å»¶è¿Ÿæ—¶é—´ï¼š{}åˆ†é’Ÿ", delayMinutes);
        log.info("åŒæ—¶å­˜åœ¨çš„å»¶è¿Ÿæ¶ˆæ¯æ•°ï¼š{}", concurrentMessages);
        log.info("æ¯æ¡æ¶ˆæ¯å†…å­˜å ç”¨ï¼š{}å­—èŠ‚", memoryPerMessage);
        log.info("æ€»å†…å­˜å ç”¨ï¼š{}MB", totalMemoryMB);
    }
}

// è¿è¡Œç»“æœç¤ºä¾‹ï¼š
// æ¯æ—¥è®¢å•é‡ï¼š10000
// å»¶è¿Ÿæ—¶é—´ï¼š15åˆ†é’Ÿ  
// åŒæ—¶å­˜åœ¨çš„å»¶è¿Ÿæ¶ˆæ¯æ•°ï¼š104
// æ¯æ¡æ¶ˆæ¯å†…å­˜å ç”¨ï¼š700å­—èŠ‚
// æ€»å†…å­˜å ç”¨ï¼š0.07MB ï¼ˆå¾ˆå°çš„å†…å­˜å ç”¨ï¼‰
```

### 6.2 æ€§èƒ½åŸºå‡†æµ‹è¯•


**ğŸ”§ æ€§èƒ½æµ‹è¯•å·¥å…·**
```java
@Component
public class DelayedMessageBenchmark {
    
    @Autowired
    private DelayedMessageService delayedMessageService;
    
    private final AtomicLong sentCount = new AtomicLong(0);
    private final AtomicLong receivedCount = new AtomicLong(0);
    
    /**
     * æ‰¹é‡å‘é€æ€§èƒ½æµ‹è¯•
     */
    public void benchmarkSendPerformance(int messageCount, int delaySeconds) {
        long startTime = System.currentTimeMillis();
        
        ExecutorService executor = Executors.newFixedThreadPool(10);
        CountDownLatch latch = new CountDownLatch(messageCount);
        
        for (int i = 0; i < messageCount; i++) {
            final int messageId = i;
            executor.submit(() -> {
                try {
                    String message = String.format("æ€§èƒ½æµ‹è¯•æ¶ˆæ¯-%d", messageId);
                    delayedMessageService.sendDelayedMessage(message, delaySeconds);
                    sentCount.incrementAndGet();
                } finally {
                    latch.countDown();
                }
            });
        }
        
        try {
            latch.await();
            long endTime = System.currentTimeMillis();
            long duration = endTime - startTime;
            
            log.info("=== å‘é€æ€§èƒ½æµ‹è¯•ç»“æœ ===");
            log.info("æ¶ˆæ¯æ•°é‡ï¼š{}", messageCount);
            log.info("å»¶è¿Ÿæ—¶é—´ï¼š{}ç§’", delaySeconds);
            log.info("æ€»è€—æ—¶ï¼š{}ms", duration);
            log.info("å‘é€é€Ÿç‡ï¼š{} æ¶ˆæ¯/ç§’", messageCount * 1000.0 / duration);
            
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        } finally {
            executor.shutdown();
        }
    }
    
    /**
     * å»¶è¿Ÿç²¾åº¦æµ‹è¯•
     */
    @RabbitListener(queues = "benchmark.queue")
    public void handleBenchmarkMessage(String message) {
        receivedCount.incrementAndGet();
        
        // è§£ææ¶ˆæ¯IDå’Œå‘é€æ—¶é—´
        if (message.startsWith("ç²¾åº¦æµ‹è¯•-")) {
            String[] parts = message.split("-");
            if (parts.length >= 3) {
                long sendTime = Long.parseLong(parts[2]);
                long receiveTime = System.currentTimeMillis();
                long actualDelay = receiveTime - sendTime;
                
                log.info("æ¶ˆæ¯IDï¼š{}ï¼Œå®é™…å»¶è¿Ÿï¼š{}ms", parts[1], actualDelay);
            }
        }
    }
    
    /**
     * è·å–æµ‹è¯•ç»Ÿè®¡
     */
    public void printStatistics() {
        log.info("=== æµ‹è¯•ç»Ÿè®¡ ===");
        log.info("å·²å‘é€æ¶ˆæ¯ï¼š{}", sentCount.get());
        log.info("å·²æ¥æ”¶æ¶ˆæ¯ï¼š{}", receivedCount.get());
        log.info("æ¶ˆæ¯ä¸¢å¤±ç‡ï¼š{}%", 
                (sentCount.get() - receivedCount.get()) * 100.0 / sentCount.get());
    }
}
```

### 6.3 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


**ğŸš€ ä¼˜åŒ–å»ºè®®**
```
å†…å­˜ä¼˜åŒ–ï¼š
â€¢ æ§åˆ¶åŒæ—¶å­˜åœ¨çš„å»¶è¿Ÿæ¶ˆæ¯æ•°é‡
â€¢ ä½¿ç”¨æ¶ˆæ¯å‹ç¼©å‡å°‘å†…å­˜å ç”¨
â€¢ å®šæœŸç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ
â€¢ åˆç†è®¾ç½®æ¶ˆæ¯è¿‡æœŸæ—¶é—´

ç½‘ç»œä¼˜åŒ–ï¼š
â€¢ æ‰¹é‡å‘é€å»¶è¿Ÿæ¶ˆæ¯
â€¢ ä½¿ç”¨è¿æ¥æ± ç®¡ç†è¿æ¥
â€¢ å¯ç”¨æ¶ˆæ¯ç¡®è®¤æœºåˆ¶
â€¢ åˆç†è®¾ç½®æ¶ˆæ¯åºåˆ—åŒ–æ ¼å¼

ä¸šåŠ¡ä¼˜åŒ–ï¼š
â€¢ é¿å…å‘é€è¿‡é•¿çš„å»¶è¿Ÿæ—¶é—´
â€¢ åˆç†æ‹†åˆ†å¤§æ¶ˆæ¯
â€¢ ä½¿ç”¨åˆé€‚çš„è·¯ç”±ç­–ç•¥
â€¢ å®ç°æ¶ˆæ¯å»é‡æœºåˆ¶
```

**ğŸ”§ ä¼˜åŒ–å®ç°**
```java
@Configuration
public class DelayedMessageOptimization {
    
    /**
     * é…ç½®è¿æ¥å·¥å‚ä¼˜åŒ–å‚æ•°
     */
    @Bean
    public ConnectionFactory connectionFactory() {
        CachingConnectionFactory factory = new CachingConnectionFactory();
        factory.setHost("localhost");
        factory.setPort(5672);
        factory.setUsername("guest");
        factory.setPassword("guest");
        
        // è¿æ¥æ± ä¼˜åŒ–
        factory.setConnectionCacheSize(10);     // è¿æ¥ç¼“å­˜å¤§å°
        factory.setChannelCacheSize(100);       // ä¿¡é“ç¼“å­˜å¤§å°
        factory.setChannelCheckoutTimeout(5000); // ä¿¡é“è·å–è¶…æ—¶
        
        // ç¡®è®¤æ¨¡å¼ä¼˜åŒ–
        factory.setPublisherConfirmType(CachingConnectionFactory.ConfirmType.CORRELATED);
        factory.setPublisherReturns(true);
        
        return factory;
    }
    
    /**
     * é…ç½®RabbitTemplateä¼˜åŒ–å‚æ•°
     */
    @Bean
    public RabbitTemplate rabbitTemplate(ConnectionFactory connectionFactory) {
        RabbitTemplate template = new RabbitTemplate(connectionFactory);
        
        // æ¶ˆæ¯åºåˆ—åŒ–ä¼˜åŒ–
        template.setMessageConverter(new Jackson2JsonMessageConverter());
        
        // ç¡®è®¤å›è°ƒ
        template.setConfirmCallback((correlationData, ack, cause) -> {
            if (!ack) {
                log.error("æ¶ˆæ¯å‘é€å¤±è´¥ï¼š{}", cause);
            }
        });
        
        // è¿”å›å›è°ƒ
        template.setReturnsCallback(returned -> {
            log.error("æ¶ˆæ¯è·¯ç”±å¤±è´¥ï¼š{}", returned.getMessage());
        });
        
        return template;
    }
    
    /**
     * æ‰¹é‡å»¶è¿Ÿæ¶ˆæ¯å‘é€å™¨
     */
    @Component
    public static class BatchDelayedSender {
        
        @Autowired
        private RabbitTemplate rabbitTemplate;
        
        /**
         * æ‰¹é‡å‘é€å»¶è¿Ÿæ¶ˆæ¯
         */
        public void sendBatch(List<DelayedMessageRequest> requests) {
            List<Message> messages = requests.stream()
                .map(this::buildMessage)
                .collect(Collectors.toList());
                
            // ä½¿ç”¨äº‹åŠ¡æ‰¹é‡å‘é€
            rabbitTemplate.execute(channel -> {
                channel.txSelect();
                try {
                    for (int i = 0; i < messages.size(); i++) {
                        DelayedMessageRequest request = requests.get(i);
                        channel.basicPublish(
                            request.getExchange(),
                            request.getRoutingKey(),
                            null,
                            messages.get(i).getBody()
                        );
                    }
                    channel.txCommit();
                    log.info("æ‰¹é‡å‘é€{}æ¡å»¶è¿Ÿæ¶ˆæ¯æˆåŠŸ", messages.size());
                } catch (Exception e) {
                    channel.txRollback();
                    log.error("æ‰¹é‡å‘é€å»¶è¿Ÿæ¶ˆæ¯å¤±è´¥", e);
                    throw new RuntimeException(e);
                }
                return null;
            });
        }
        
        private Message buildMessage(DelayedMessageRequest request) {
            MessageProperties properties = new MessageProperties();
            properties.setHeader("x-delay", request.getDelayMillis());
            properties.setDeliveryMode(MessageDeliveryMode.PERSISTENT);
            
            return new Message(request.getMessageBody().getBytes(), properties);
        }
    }
}
```

### 6.4 ç›‘æ§ä¸å‘Šè­¦


**ğŸ“Š ç›‘æ§æŒ‡æ ‡**
```java
@Component
public class DelayedMessageMonitor {
    
    private final MeterRegistry meterRegistry;
    private final Counter delayedMessageSentCounter;
    private final Timer delayedMessageLatencyTimer;
    private final Gauge delayedMessageMemoryGauge;
    
    public DelayedMessageMonitor(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.delayedMessageSentCounter = Counter.builder("delayed.message.sent")
            .description("å‘é€çš„å»¶è¿Ÿæ¶ˆæ¯æ•°é‡")
            .register(meterRegistry);
            
        this.delayedMessageLatencyTimer = Timer.builder("delayed.message.latency")
            .description("å»¶è¿Ÿæ¶ˆæ¯ç²¾åº¦")
            .register(meterRegistry);
            
        this.delayedMessageMemoryGauge = Gauge.builder("delayed.message.memory")
            .description("å»¶è¿Ÿæ¶ˆæ¯å†…å­˜å ç”¨")
            .register(meterRegistry, this, DelayedMessageMonitor::getMemoryUsage);
    }
    
    /**
     * è®°å½•å‘é€æŒ‡æ ‡
     */
    public void recordSent(String routingKey, long delayMillis) {
        delayedMessageSentCounter.increment(
            Tags.of(
                "routing.key", routingKey,
                "delay.range", getDelayRange(delayMillis)
            )
        );
    }
    
    /**
     * è®°å½•å»¶è¿Ÿç²¾åº¦
     */
    public void recordLatency(long expectedDelayMillis, long actualDelayMillis) {
        long latencyError = Math.abs(actualDelayMillis - expectedDelayMillis);
        delayedMessageLatencyTimer.record(latencyError, TimeUnit.MILLISECONDS);
    }
    
    private String getDelayRange(long delayMillis) {
        if (delayMillis < 60000) return "minute";
        if (delayMillis < 3600000) return "hour";
        if (delayMillis < 86400000) return "day";
        return "week";
    }
    
    private double getMemoryUsage() {
        // é€šè¿‡RabbitMQ Management APIè·å–å†…å­˜ä½¿ç”¨æƒ…å†µ
        // è¿™é‡Œç®€åŒ–ä¸ºæ¨¡æ‹Ÿå€¼
        return Runtime.getRuntime().totalMemory() - Runtime.getRuntime().freeMemory();
    }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å»¶è¿Ÿæ’ä»¶æœ¬è´¨ï¼šä¸ºRabbitMQå¢åŠ åŸç”Ÿå»¶è¿Ÿæ¶ˆæ¯åŠŸèƒ½
ğŸ”¸ x-delayed-messageï¼šæ–°çš„äº¤æ¢æœºç±»å‹ï¼Œæ”¯æŒæ‰€æœ‰è·¯ç”±æ¨¡å¼
ğŸ”¸ x-delayå¤´éƒ¨ï¼šæŒ‡å®šå»¶è¿Ÿæ—¶é—´çš„æ ¸å¿ƒå‚æ•°ï¼Œå•ä½æ¯«ç§’
ğŸ”¸ å·¥ä½œåŸç†ï¼šæ¶ˆæ¯åœ¨Exchangeå±‚æš‚å­˜ï¼Œåˆ°æ—¶é—´åè·¯ç”±åˆ°é˜Ÿåˆ—
ğŸ”¸ æ€§èƒ½ç‰¹ç‚¹ï¼šå†…å­˜å­˜å‚¨ï¼Œæ”¯æŒæŒä¹…åŒ–ï¼Œæœ‰æ—¶é—´å’Œç²¾åº¦é™åˆ¶
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å»¶è¿Ÿæ¶ˆæ¯ vs å®šæ—¶ä»»åŠ¡**
```
å»¶è¿Ÿæ¶ˆæ¯ä¼˜åŠ¿ï¼š
â€¢ ç²¾ç¡®åˆ°æ¯«ç§’çº§
â€¢ è‡ªåŠ¨æŒä¹…åŒ–å’Œæ¢å¤
â€¢ é›†ç¾¤é«˜å¯ç”¨æ”¯æŒ
â€¢ ä¸æ¶ˆæ¯ç³»ç»Ÿé›†æˆ

é€‚ç”¨åœºæ™¯åˆ¤æ–­ï¼š
â€¢ éœ€è¦ç²¾ç¡®å»¶è¿Ÿ â†’ å»¶è¿Ÿæ¶ˆæ¯
â€¢ éœ€è¦å¤æ‚è°ƒåº¦ â†’ å®šæ—¶ä»»åŠ¡
â€¢ éœ€è¦é›†ç¾¤æ”¯æŒ â†’ å»¶è¿Ÿæ¶ˆæ¯
â€¢ éœ€è¦äº‹åŠ¡ä¿è¯ â†’ å»¶è¿Ÿæ¶ˆæ¯
```

**ğŸ”¹ æ’ä»¶å®‰è£…è¦ç‚¹**
```
ç‰ˆæœ¬åŒ¹é…ï¼šæ’ä»¶ç‰ˆæœ¬å¿…é¡»ä¸RabbitMQç‰ˆæœ¬åŒ¹é…
å®‰è£…éªŒè¯ï¼šé€šè¿‡ç®¡ç†ç•Œé¢ç¡®è®¤x-delayed-messageç±»å‹å¯ç”¨
é›†ç¾¤å®‰è£…ï¼šæ‰€æœ‰èŠ‚ç‚¹éƒ½éœ€è¦å®‰è£…å¹¶å¯ç”¨æ’ä»¶
å‡çº§æ³¨æ„ï¼šå‡çº§RabbitMQæ—¶åŒæ­¥å‡çº§æ’ä»¶
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–å…³é”®**
```
å†…å­˜æ§åˆ¶ï¼š
â€¢ ç›‘æ§å»¶è¿Ÿæ¶ˆæ¯æ•°é‡
â€¢ æ§åˆ¶å•æ¡æ¶ˆæ¯å¤§å°
â€¢ åˆç†è®¾ç½®å»¶è¿Ÿæ—¶é—´

å‘é€ä¼˜åŒ–ï¼š
â€¢ ä½¿ç”¨è¿æ¥æ± 
â€¢ æ‰¹é‡å‘é€æ¶ˆæ¯
â€¢ å¯ç”¨å‘é€ç¡®è®¤

æ¶ˆè´¹ä¼˜åŒ–ï¼š
â€¢ åˆç†è®¾ç½®é¢„å–å€¼
â€¢ å®ç°å¹‚ç­‰æ¶ˆè´¹
â€¢ ä¼˜åŒ–æ¶ˆæ¯å¤„ç†é€»è¾‘
```

### 7.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¸šåŠ¡åœºæ™¯åº”ç”¨**
- **è®¢å•ç³»ç»Ÿ**ï¼šæ”¯ä»˜è¶…æ—¶è‡ªåŠ¨å–æ¶ˆï¼Œæå‡ç”¨æˆ·ä½“éªŒ
- **ç”¨æˆ·ç³»ç»Ÿ**ï¼šæ³¨å†Œæ¿€æ´»æé†’ï¼Œæé«˜æ¿€æ´»ç‡
- **è¥é”€ç³»ç»Ÿ**ï¼šå®šæ—¶æ¨é€æ´»åŠ¨ä¿¡æ¯ï¼Œç²¾å‡†è¥é”€
- **ä¼šå‘˜ç³»ç»Ÿ**ï¼šåˆ°æœŸæé†’ç»­è´¹ï¼Œå‡å°‘ç”¨æˆ·æµå¤±

**ğŸ”§ æŠ€æœ¯æ¶æ„ä¼˜åŠ¿**
- **è§£è€¦åˆ**ï¼šå¼‚æ­¥å¤„ç†å»¶è¿Ÿä¸šåŠ¡é€»è¾‘
- **é«˜å¯ç”¨**ï¼šé›†ç¾¤æ¨¡å¼æ”¯æŒæ•…éšœæ¢å¤
- **æ˜“ç»´æŠ¤**ï¼šç»Ÿä¸€çš„æ¶ˆæ¯å¤„ç†æœºåˆ¶
- **å¯æ‰©å±•**ï¼šæ°´å¹³æ‰©å±•æ¶ˆè´¹è€…èŠ‚ç‚¹

**ğŸ’¡ æœ€ä½³å®è·µæ€»ç»“**
```
è®¾è®¡åŸåˆ™ï¼š
â€¢ æ¶ˆæ¯å¹‚ç­‰ï¼šåŒä¸€æ¶ˆæ¯å¤šæ¬¡æ¶ˆè´¹ç»“æœä¸€è‡´
â€¢ è¶…æ—¶å¤„ç†ï¼šè®¾ç½®åˆç†çš„æ¶ˆæ¯TTL
â€¢ ç›‘æ§å‘Šè­¦ï¼šå®æ—¶ç›‘æ§å»¶è¿Ÿæ¶ˆæ¯çŠ¶æ€
â€¢ å¼‚å¸¸å¤„ç†ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

æ€§èƒ½è°ƒä¼˜ï¼š
â€¢ æ ¹æ®ä¸šåŠ¡é‡è°ƒæ•´å†…å­˜é…ç½®
â€¢ åˆç†è®¾ç½®æ¶ˆè´¹è€…å¹¶å‘æ•°
â€¢ ä½¿ç”¨åˆé€‚çš„åºåˆ—åŒ–æ–¹å¼
â€¢ å®šæœŸæ¸…ç†è¿‡æœŸæ¶ˆæ¯
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- å»¶è¿Ÿæ’ä»¶è®©æ¶ˆæ¯"æŒ‰æ—¶æŠ•é€’"ï¼Œè§£å†³å®šæ—¶ä¸šåŠ¡éœ€æ±‚
- x-delayed-messageæ˜¯äº¤æ¢æœºç±»å‹ï¼Œx-delayæ˜¯æ—¶é—´å‚æ•°
- å†…å­˜å­˜å‚¨è¦æ§åˆ¶æ•°é‡ï¼Œç²¾åº¦å—é™è¦åˆç†è§„åˆ’
- ä¸šåŠ¡è§£è€¦æå‡ç”¨æˆ·ä½“éªŒï¼Œå¼‚æ­¥å¤„ç†ä¿è¯æ€§èƒ½