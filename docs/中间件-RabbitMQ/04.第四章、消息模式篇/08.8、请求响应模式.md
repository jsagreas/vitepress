---
title: 8ã€è¯·æ±‚å“åº”æ¨¡å¼
---
## ğŸ“š ç›®å½•

1. [è¯·æ±‚å“åº”æ¨¡å¼æ¦‚è¿°](#1-è¯·æ±‚å“åº”æ¨¡å¼æ¦‚è¿°)
2. [å¼‚æ­¥è¯·æ±‚å“åº”æœºåˆ¶](#2-å¼‚æ­¥è¯·æ±‚å“åº”æœºåˆ¶)
3. [æ¶ˆæ¯å…³è”æœºåˆ¶è¯¦è§£](#3-æ¶ˆæ¯å…³è”æœºåˆ¶è¯¦è§£)
4. [å“åº”è·¯ç”±è®¾è®¡](#4-å“åº”è·¯ç”±è®¾è®¡)
5. [çŠ¶æ€ç®¡ç†ä¸å¹¶å‘å¤„ç†](#5-çŠ¶æ€ç®¡ç†ä¸å¹¶å‘å¤„ç†)
6. [å®æˆ˜æ¡ˆä¾‹ä¸æœ€ä½³å®è·µ](#6-å®æˆ˜æ¡ˆä¾‹ä¸æœ€ä½³å®è·µ)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ è¯·æ±‚å“åº”æ¨¡å¼æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯è¯·æ±‚å“åº”æ¨¡å¼


**ç®€å•ç†è§£**ï¼šå°±åƒä½ åœ¨é¤å…ç‚¹é¤ä¸€æ ·ï¼Œä½ ä¸‹å•ï¼ˆå‘è¯·æ±‚ï¼‰ï¼ŒæœåŠ¡å‘˜è®°å½•è®¢å•ï¼Œå¨å¸ˆåšå¥½åç«¯ä¸Šæ¥ï¼ˆè¿”å›å“åº”ï¼‰ã€‚

```
ç°å®ç”Ÿæ´»ç±»æ¯”ï¼š
å®¢æˆ·ç‚¹é¤ â†’ æœåŠ¡å‘˜è®°å½• â†’ å¨å¸ˆåˆ¶ä½œ â†’ æœåŠ¡å‘˜é€é¤ â†’ å®¢æˆ·ç”¨é¤

RabbitMQä¸­ï¼š
å®¢æˆ·ç«¯å‘è¯·æ±‚ â†’ é˜Ÿåˆ—å­˜å‚¨ â†’ æœåŠ¡ç«¯å¤„ç† â†’ å“åº”é˜Ÿåˆ— â†’ å®¢æˆ·ç«¯æ”¶åˆ°ç»“æœ
```

**ğŸ”¸ æ ¸å¿ƒç‰¹ç‚¹**
- **å¼‚æ­¥å¤„ç†**ï¼šå‘å‡ºè¯·æ±‚åä¸éœ€è¦ä¸€ç›´ç­‰å¾…ï¼Œå¯ä»¥å»åšå…¶ä»–äº‹
- **è§£è€¦åˆ**ï¼šè¯·æ±‚æ–¹å’Œå¤„ç†æ–¹äº’ä¸ä¾èµ–ï¼Œé€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—è¿æ¥
- **å¯é æ€§**ï¼šå³ä½¿æŸä¸€æ–¹æš‚æ—¶ä¸åœ¨çº¿ï¼Œæ¶ˆæ¯ä¹Ÿä¸ä¼šä¸¢å¤±
- **æ‰©å±•æ€§**ï¼šå¯ä»¥æœ‰å¤šä¸ªå¤„ç†è€…åŒæ—¶å·¥ä½œï¼Œæé«˜æ•ˆç‡

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦è¯·æ±‚å“åº”æ¨¡å¼


**ğŸ¤” ä¼ ç»ŸåŒæ­¥è°ƒç”¨çš„é—®é¢˜**
```
ä¼ ç»Ÿæ–¹å¼çš„ç—›ç‚¹ï¼š
âŒ å¿…é¡»ç­‰å¾…ï¼šå‘å‡ºè¯·æ±‚åå¿…é¡»ç­‰åˆ°å“åº”æ‰èƒ½ç»§ç»­
âŒ å®¹æ˜“è¶…æ—¶ï¼šç½‘ç»œå»¶è¿Ÿæˆ–æœåŠ¡å¿™ç¢Œæ—¶å®¹æ˜“å¤±è´¥
âŒ ç´§è€¦åˆï¼šè°ƒç”¨æ–¹å’Œè¢«è°ƒç”¨æ–¹å¿…é¡»åŒæ—¶åœ¨çº¿
âŒ éš¾æ‰©å±•ï¼šå¤„ç†èƒ½åŠ›å—é™äºå•ä¸ªæœåŠ¡å®ä¾‹
```

**âœ… å¼‚æ­¥è¯·æ±‚å“åº”çš„ä¼˜åŠ¿**
- **æé«˜å“åº”é€Ÿåº¦**ï¼šå‘å‡ºè¯·æ±‚ç«‹å³è¿”å›ï¼Œæ— éœ€ç­‰å¾…å¤„ç†å®Œæˆ
- **å¢å¼ºå¯é æ€§**ï¼šè¯·æ±‚ä¿å­˜åœ¨é˜Ÿåˆ—ä¸­ï¼Œä¸ä¼šå› ä¸ºç½‘ç»œé—®é¢˜ä¸¢å¤±
- **æ”¯æŒè´Ÿè½½å‡è¡¡**ï¼šå¤šä¸ªå¤„ç†è€…å¯ä»¥åŒæ—¶å·¥ä½œ
- **æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ**ï¼šç”¨æˆ·ä¸ä¼šæ„Ÿè§‰åˆ°"å¡é¡¿"

### 1.3 é€‚ç”¨åœºæ™¯åˆ†æ


**ğŸ“Š åœºæ™¯é€‚ç”¨æ€§è¯„ä¼°**
| åœºæ™¯ç±»å‹ | é€‚ç”¨åº¦ | æ¨èæŒ‡æ•° | å…¸å‹åº”ç”¨ |
|----------|--------|----------|----------|
| ğŸ¢ **å¾®æœåŠ¡é€šä¿¡** | é«˜ | â­â­â­â­â­ | æœåŠ¡é—´å¼‚æ­¥è°ƒç”¨ |
| ğŸ“Š **æ•°æ®åˆ†æ** | é«˜ | â­â­â­â­â­ | æŠ¥è¡¨ç”Ÿæˆè¯·æ±‚ |
| ğŸ›’ **ç”µå•†è®¢å•** | é«˜ | â­â­â­â­ | è®¢å•å¤„ç†æµç¨‹ |
| ğŸ“± **å®æ—¶èŠå¤©** | ä½ | â­â­ | éœ€è¦æä½å»¶è¿Ÿ |

---

## 2. âš¡ å¼‚æ­¥è¯·æ±‚å“åº”æœºåˆ¶


### 2.1 åŸºæœ¬å·¥ä½œæµç¨‹


**ğŸ”„ å®Œæ•´æµç¨‹å›¾è§£**
```
è¯·æ±‚æ–¹(Client)          æ¶ˆæ¯é˜Ÿåˆ—           å¤„ç†æ–¹(Server)
     |                     |                    |
     |--[1]å‘é€è¯·æ±‚-------->|                    |
     |   RequestQueue      |                    |
     |                     |--[2]è½¬å‘è¯·æ±‚------>|
     |                     |                    |
     |                     |<--[3]å‘é€å“åº”------|
     |                     |   ResponseQueue    |
     |<--[4]è¿”å›ç»“æœ-------|                    |
     |                     |                    |
```

**ğŸ“‹ è¯¦ç»†æ­¥éª¤è¯´æ˜**
```
Step 1 ğŸš€ å®¢æˆ·ç«¯å‡†å¤‡è¯·æ±‚
- ç”Ÿæˆå”¯ä¸€çš„correlationIdï¼ˆè¯·æ±‚æ ‡è¯†ï¼‰
- åˆ›å»ºä¸´æ—¶å“åº”é˜Ÿåˆ—æˆ–ä½¿ç”¨å›è°ƒé˜Ÿåˆ—
- å‘é€è¯·æ±‚æ¶ˆæ¯åˆ°è¯·æ±‚é˜Ÿåˆ—

Step 2 ğŸ“¨ æ¶ˆæ¯è·¯ç”±ä¼ é€’
- RabbitMQæ¥æ”¶è¯·æ±‚æ¶ˆæ¯
- æ ¹æ®è·¯ç”±è§„åˆ™åˆ†å‘ç»™å¯ç”¨çš„å¤„ç†è€…
- ä¿è¯æ¶ˆæ¯çš„å¯é ä¼ é€’

Step 3 âš™ï¸ æœåŠ¡ç«¯å¤„ç†è¯·æ±‚
- ä»è¯·æ±‚é˜Ÿåˆ—è·å–æ¶ˆæ¯
- è§£æè¯·æ±‚å†…å®¹å¹¶å¤„ç†ä¸šåŠ¡é€»è¾‘
- å‡†å¤‡å“åº”æ•°æ®

Step 4 ğŸ“¤ å‘é€å“åº”ç»“æœ
- ä½¿ç”¨è¯·æ±‚ä¸­çš„correlationIdæ ‡è¯†å“åº”
- å°†ç»“æœå‘é€åˆ°æŒ‡å®šçš„å“åº”é˜Ÿåˆ—
- å®¢æˆ·ç«¯æ¥æ”¶å¹¶åŒ¹é…å¯¹åº”çš„è¯·æ±‚
```

### 2.2 æ ¸å¿ƒç»„ä»¶è¯¦è§£


**ğŸ—ï¸ æ¶æ„ç»„ä»¶è¯´æ˜**
```
ğŸ”¸ è¯·æ±‚é˜Ÿåˆ— (Request Queue)
ä½œç”¨ï¼šå­˜å‚¨å¾…å¤„ç†çš„è¯·æ±‚æ¶ˆæ¯
ç‰¹ç‚¹ï¼šæŒä¹…åŒ–ã€å¯è·¯ç”±ã€æ”¯æŒä¼˜å…ˆçº§

ğŸ”¸ å“åº”é˜Ÿåˆ— (Reply Queue)  
ä½œç”¨ï¼šå­˜å‚¨å¤„ç†å®Œæˆçš„å“åº”æ¶ˆæ¯
ç‰¹ç‚¹ï¼šå¯ä»¥æ˜¯ä¸´æ—¶é˜Ÿåˆ—æˆ–ä¸“ç”¨é˜Ÿåˆ—

ğŸ”¸ å…³è”æ ‡è¯† (Correlation ID)
ä½œç”¨ï¼šå°†è¯·æ±‚å’Œå“åº”è¿›è¡ŒåŒ¹é…
ç‰¹ç‚¹ï¼šå”¯ä¸€æ€§ã€å¯è¿½è¸ªæ€§

ğŸ”¸ å›è°ƒåœ°å€ (Reply-To)
ä½œç”¨ï¼šå‘Šè¯‰å¤„ç†è€…å°†ç»“æœå‘é€åˆ°å“ªé‡Œ
ç‰¹ç‚¹ï¼šçµæ´»æŒ‡å®šå“åº”ç›®æ ‡
```

### 2.3 æ¶ˆæ¯å±æ€§è®¾è®¡


**ğŸ“„ å…³é”®æ¶ˆæ¯å±æ€§**
```java
// è¯·æ±‚æ¶ˆæ¯çš„å…³é”®å±æ€§
public class RequestMessage {
    private String correlationId;    // è¯·æ±‚å”¯ä¸€æ ‡è¯†
    private String replyTo;         // å“åº”é˜Ÿåˆ—åç§°
    private String content;         // è¯·æ±‚å†…å®¹
    private long timestamp;         // å‘é€æ—¶é—´
    private int priority;           // æ¶ˆæ¯ä¼˜å…ˆçº§
}

// å®é™…ä½¿ç”¨ç¤ºä¾‹
AMQP.BasicProperties props = new AMQP.BasicProperties.Builder()
    .correlationId(UUID.randomUUID().toString())  // ç”Ÿæˆå”¯ä¸€ID
    .replyTo("response_queue_" + clientId)        // æŒ‡å®šå“åº”é˜Ÿåˆ—
    .timestamp(new Date())                        // è®¾ç½®æ—¶é—´æˆ³
    .build();
```

---

## 3. ğŸ”— æ¶ˆæ¯å…³è”æœºåˆ¶è¯¦è§£


### 3.1 correlationIdçš„é‡è¦æ€§


**ğŸ¯ ä¸ºä»€ä¹ˆéœ€è¦correlationId**

æƒ³è±¡ä½ åœ¨ä¸€ä¸ªç¹å¿™çš„å¿«é¤åº—ï¼š
- ä½ ç‚¹äº†ä¸€ä¸ªæ±‰å ¡ï¼Œæ”¶é“¶å‘˜ç»™ä½ ä¸€ä¸ªå·ç ç‰Œï¼ˆè¿™å°±æ˜¯correlationIdï¼‰
- å¨æˆ¿åšå¥½åï¼Œä¼šå–Šä½ çš„å·ç 
- ä½ å¬åˆ°è‡ªå·±çš„å·ç ï¼Œå°±çŸ¥é“è¿™æ˜¯ä½ çš„æ±‰å ¡

åœ¨RabbitMQä¸­ä¹Ÿæ˜¯ä¸€æ ·çš„é“ç†ï¼š
```
é—®é¢˜åœºæ™¯ï¼š
å®¢æˆ·ç«¯åŒæ—¶å‘å‡ºå¤šä¸ªè¯·æ±‚ â†’ å¦‚ä½•çŸ¥é“æ”¶åˆ°çš„å“åº”å¯¹åº”å“ªä¸ªè¯·æ±‚ï¼Ÿ

è§£å†³æ–¹æ¡ˆï¼š
æ¯ä¸ªè¯·æ±‚éƒ½å¸¦ä¸Šå”¯ä¸€çš„correlationId â†’ å“åº”æ—¶åŸæ ·è¿”å› â†’ å®¢æˆ·ç«¯åŒ¹é…
```

**ğŸ’¡ correlationIdç”Ÿæˆç­–ç•¥**
```java
// ç­–ç•¥1ï¼šUUIDï¼ˆæ¨èï¼‰
String correlationId = UUID.randomUUID().toString();
// ä¼˜ç‚¹ï¼šå…¨å±€å”¯ä¸€ï¼Œå†²çªæ¦‚ç‡æä½
// ç¼ºç‚¹ï¼šå­—ç¬¦ä¸²è¾ƒé•¿

// ç­–ç•¥2ï¼šæ—¶é—´æˆ³ + éšæœºæ•°
String correlationId = System.currentTimeMillis() + "_" + 
                      ThreadLocalRandom.current().nextInt(1000);
// ä¼˜ç‚¹ï¼šåŒ…å«æ—¶é—´ä¿¡æ¯ï¼Œä¾¿äºè°ƒè¯•
// ç¼ºç‚¹ï¼šéœ€è¦ä¿è¯çº¿ç¨‹å®‰å…¨

// ç­–ç•¥3ï¼šå®¢æˆ·ç«¯ID + åºåˆ—å·
String correlationId = clientId + "_" + atomicCounter.incrementAndGet();
// ä¼˜ç‚¹ï¼šä¾¿äºè¿½è¸ªæ¥æº
// ç¼ºç‚¹ï¼šéœ€è¦ç»´æŠ¤è®¡æ•°å™¨çŠ¶æ€
```

### 3.2 å“åº”åŒ¹é…æœºåˆ¶


**ğŸ” å®¢æˆ·ç«¯å“åº”åŒ¹é…é€»è¾‘**
```java
public class ResponseMatcher {
    // å­˜å‚¨å¾…å“åº”çš„è¯·æ±‚
    private final Map<String, CompletableFuture<String>> pendingRequests = 
        new ConcurrentHashMap<>();
    
    // å‘é€è¯·æ±‚
    public CompletableFuture<String> sendRequest(String request) {
        String correlationId = UUID.randomUUID().toString();
        CompletableFuture<String> future = new CompletableFuture<>();
        
        // è®°å½•ç­‰å¾…å“åº”çš„è¯·æ±‚
        pendingRequests.put(correlationId, future);
        
        // å‘é€è¯·æ±‚æ¶ˆæ¯
        publishRequest(request, correlationId);
        
        return future;
    }
    
    // å¤„ç†å“åº”
    public void handleResponse(String correlationId, String response) {
        CompletableFuture<String> future = pendingRequests.remove(correlationId);
        if (future != null) {
            future.complete(response);  // å®Œæˆå¯¹åº”çš„è¯·æ±‚
        }
    }
}
```

**â° è¶…æ—¶å¤„ç†æœºåˆ¶**
```java
// å¸¦è¶…æ—¶çš„è¯·æ±‚å¤„ç†
public CompletableFuture<String> sendRequestWithTimeout(String request, 
                                                        long timeoutMs) {
    String correlationId = UUID.randomUUID().toString();
    CompletableFuture<String> future = new CompletableFuture<>();
    
    pendingRequests.put(correlationId, future);
    
    // è®¾ç½®è¶…æ—¶å¤„ç†
    scheduler.schedule(() -> {
        CompletableFuture<String> timeoutFuture = pendingRequests.remove(correlationId);
        if (timeoutFuture != null) {
            timeoutFuture.completeExceptionally(
                new TimeoutException("è¯·æ±‚è¶…æ—¶ï¼š" + correlationId));
        }
    }, timeoutMs, TimeUnit.MILLISECONDS);
    
    publishRequest(request, correlationId);
    return future;
}
```

### 3.3 å¤šå®¢æˆ·ç«¯åœºæ™¯å¤„ç†


**ğŸŒ å¤šå®¢æˆ·ç«¯å“åº”éš”ç¦»**
```
åœºæ™¯æè¿°ï¼š
å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶ä½¿ç”¨åŒä¸€ä¸ªRabbitMQæœåŠ¡

é—®é¢˜ï¼š
å¦‚ä½•ä¿è¯å®¢æˆ·ç«¯Açš„å“åº”ä¸ä¼šè¢«å®¢æˆ·ç«¯Bæ”¶åˆ°ï¼Ÿ

è§£å†³æ–¹æ¡ˆï¼š
æ–¹æ¡ˆ1: æ¯ä¸ªå®¢æˆ·ç«¯ä½¿ç”¨ç‹¬ç«‹çš„å“åº”é˜Ÿåˆ—
æ–¹æ¡ˆ2: ä½¿ç”¨ç»Ÿä¸€å“åº”é˜Ÿåˆ— + æ¶ˆæ¯è¿‡æ»¤
æ–¹æ¡ˆ3: åŸºäºè¿æ¥çš„é˜Ÿåˆ—éš”ç¦»
```

**ğŸ”§ æ–¹æ¡ˆ1ï¼šç‹¬ç«‹å“åº”é˜Ÿåˆ—**
```java
public class IsolatedResponseClient {
    private String clientId;
    private String responseQueueName;
    
    public IsolatedResponseClient(String clientId) {
        this.clientId = clientId;
        // æ¯ä¸ªå®¢æˆ·ç«¯åˆ›å»ºä¸“å±å“åº”é˜Ÿåˆ—
        this.responseQueueName = "response_" + clientId + "_" + 
                                System.currentTimeMillis();
        
        // åˆ›å»ºä¸´æ—¶é˜Ÿåˆ—ï¼Œå®¢æˆ·ç«¯æ–­å¼€æ—¶è‡ªåŠ¨åˆ é™¤
        channel.queueDeclare(responseQueueName, false, true, true, null);
    }
    
    // å‘é€è¯·æ±‚æ—¶æŒ‡å®šè‡ªå·±çš„å“åº”é˜Ÿåˆ—
    private void sendRequest(String request) {
        String correlationId = UUID.randomUUID().toString();
        
        AMQP.BasicProperties props = new AMQP.BasicProperties.Builder()
            .correlationId(correlationId)
            .replyTo(responseQueueName)  // ä½¿ç”¨ä¸“å±é˜Ÿåˆ—
            .build();
            
        channel.basicPublish("", REQUEST_QUEUE, props, request.getBytes());
    }
}
```

---

## 4. ğŸš€ å“åº”è·¯ç”±è®¾è®¡


### 4.1 å“åº”é˜Ÿåˆ—ç­–ç•¥


**ğŸ“Š ä¸åŒå“åº”é˜Ÿåˆ—ç­–ç•¥å¯¹æ¯”**
| ç­–ç•¥ç±»å‹ | **ä¼˜ç‚¹** | **ç¼ºç‚¹** | **é€‚ç”¨åœºæ™¯** |
|---------|----------|----------|-------------|
| ğŸ¯ **ä¸“å±é˜Ÿåˆ—** | éš”ç¦»æ€§å¥½ï¼Œæ— å¹²æ‰° | èµ„æºæ¶ˆè€—å¤§ | é•¿è¿æ¥å®¢æˆ·ç«¯ |
| ğŸ”„ **å…±äº«é˜Ÿåˆ—** | èµ„æºèŠ‚çœï¼Œç®¡ç†ç®€å• | éœ€è¦æ¶ˆæ¯è¿‡æ»¤ | çŸ­è¿æ¥è¯·æ±‚ |
| â±ï¸ **ä¸´æ—¶é˜Ÿåˆ—** | è‡ªåŠ¨æ¸…ç†ï¼Œæ— æ®‹ç•™ | åˆ›å»ºå¼€é”€å¤§ | ä¸€æ¬¡æ€§è¯·æ±‚ |

### 4.2 åŠ¨æ€è·¯ç”±å®ç°


**ğŸ”€ åŸºäºä¸šåŠ¡çš„åŠ¨æ€è·¯ç”±**
```java
public class DynamicResponseRouter {
    
    // æ ¹æ®è¯·æ±‚ç±»å‹å†³å®šå“åº”è·¯ç”±
    public String determineReplyQueue(String requestType, String clientId) {
        switch (requestType) {
            case "USER_QUERY":
                return "user_response_" + clientId;
            case "ORDER_PROCESS":
                return "order_response_" + clientId;
            case "PAYMENT_CHECK":
                return "payment_response_" + clientId;
            default:
                return "default_response_" + clientId;
        }
    }
    
    // å‘é€è¯·æ±‚æ—¶åŠ¨æ€è®¾ç½®è·¯ç”±
    public void sendTypedRequest(String requestType, String content, String clientId) {
        String replyQueue = determineReplyQueue(requestType, clientId);
        String correlationId = UUID.randomUUID().toString();
        
        // ç¡®ä¿å“åº”é˜Ÿåˆ—å­˜åœ¨
        ensureQueueExists(replyQueue);
        
        AMQP.BasicProperties props = new AMQP.BasicProperties.Builder()
            .correlationId(correlationId)
            .replyTo(replyQueue)
            .type(requestType)  // è®¾ç½®æ¶ˆæ¯ç±»å‹
            .build();
            
        channel.basicPublish("", "request_queue", props, content.getBytes());
    }
    
    private void ensureQueueExists(String queueName) {
        try {
            channel.queueDeclarePassive(queueName);
        } catch (IOException e) {
            // é˜Ÿåˆ—ä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒ
            channel.queueDeclare(queueName, false, false, true, null);
        }
    }
}
```

### 4.3 å“åº”è·¯ç”±ä¼˜åŒ–


**âš¡ è·¯ç”±æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**
```
ğŸ”¸ é˜Ÿåˆ—é¢„åˆ›å»º
- æå‰åˆ›å»ºå¸¸ç”¨çš„å“åº”é˜Ÿåˆ—
- é¿å…è¿è¡Œæ—¶åˆ›å»ºçš„å¼€é”€
- ä½¿ç”¨è¿æ¥æ± å¤ç”¨é˜Ÿåˆ—

ğŸ”¸ è·¯ç”±è§„åˆ™ç¼“å­˜
- ç¼“å­˜è·¯ç”±å†³ç­–ç»“æœ
- å‡å°‘é‡å¤è®¡ç®—å¼€é”€
- å®šæœŸæ›´æ–°ç¼“å­˜å†…å®¹

ğŸ”¸ æ‰¹é‡å“åº”å¤„ç†
- å°†å¤šä¸ªå“åº”æ‰“åŒ…å‘é€
- å‡å°‘ç½‘ç»œå¾€è¿”æ¬¡æ•°
- æé«˜æ•´ä½“ååé‡
```

**ğŸ’¡ å®ç”¨ä¼˜åŒ–æŠ€å·§**
```java
public class OptimizedResponseRouter {
    private final Map<String, String> routeCache = new ConcurrentHashMap<>();
    private final Set<String> preCreatedQueues = ConcurrentHashMap.newKeySet();
    
    // ç¼“å­˜è·¯ç”±å†³ç­–
    public String getReplyQueue(String requestType, String clientId) {
        String cacheKey = requestType + ":" + clientId;
        return routeCache.computeIfAbsent(cacheKey, 
            k -> determineReplyQueue(requestType, clientId));
    }
    
    // é¢„åˆ›å»ºé˜Ÿåˆ—
    public void preCreateQueues(String clientId) {
        String[] queueTypes = {"user_response", "order_response", "payment_response"};
        
        for (String type : queueTypes) {
            String queueName = type + "_" + clientId;
            if (preCreatedQueues.add(queueName)) {
                channel.queueDeclare(queueName, false, false, true, null);
            }
        }
    }
}
```

---

## 5. ğŸ›ï¸ çŠ¶æ€ç®¡ç†ä¸å¹¶å‘å¤„ç†


### 5.1 è¯·æ±‚çŠ¶æ€ç”Ÿå‘½å‘¨æœŸ


**ğŸ“‹ è¯·æ±‚çŠ¶æ€è½¬æ¢å›¾**
```
[å‘èµ·] â†’ [å‘é€ä¸­] â†’ [å·²å‘é€] â†’ [å¤„ç†ä¸­] â†’ [å·²å®Œæˆ]
  â†“         â†“         â†“         â†“         â†“
[å¤±è´¥]   [å‘é€å¤±è´¥] [ç­‰å¾…è¶…æ—¶] [å¤„ç†å¤±è´¥] [å“åº”æ¥æ”¶]
```

**ğŸ”„ çŠ¶æ€ç®¡ç†å®ç°**
```java
public enum RequestStatus {
    CREATED("åˆ›å»º"),
    SENDING("å‘é€ä¸­"), 
    SENT("å·²å‘é€"),
    PROCESSING("å¤„ç†ä¸­"),
    COMPLETED("å·²å®Œæˆ"),
    TIMEOUT("è¶…æ—¶"),
    FAILED("å¤±è´¥");
    
    private final String description;
    
    RequestStatus(String description) {
        this.description = description;
    }
}

public class RequestTracker {
    private final Map<String, RequestInfo> requestMap = new ConcurrentHashMap<>();
    
    public static class RequestInfo {
        private String correlationId;
        private RequestStatus status;
        private long createTime;
        private long updateTime;
        private String errorMessage;
        
        // çŠ¶æ€æ›´æ–°æ–¹æ³•
        public void updateStatus(RequestStatus newStatus) {
            this.status = newStatus;
            this.updateTime = System.currentTimeMillis();
        }
    }
    
    // è·Ÿè¸ªè¯·æ±‚çŠ¶æ€
    public void trackRequest(String correlationId) {
        RequestInfo info = new RequestInfo();
        info.correlationId = correlationId;
        info.status = RequestStatus.CREATED;
        info.createTime = System.currentTimeMillis();
        
        requestMap.put(correlationId, info);
    }
    
    // æ›´æ–°è¯·æ±‚çŠ¶æ€
    public void updateRequestStatus(String correlationId, RequestStatus status) {
        RequestInfo info = requestMap.get(correlationId);
        if (info != null) {
            info.updateStatus(status);
        }
    }
}
```

### 5.2 å¹¶å‘è¯·æ±‚å¤„ç†


**âš¡ é«˜å¹¶å‘åœºæ™¯ä¼˜åŒ–**
```java
public class ConcurrentRequestHandler {
    private final ExecutorService executor = Executors.newFixedThreadPool(50);
    private final Semaphore requestLimiter = new Semaphore(100); // é™åˆ¶å¹¶å‘æ•°
    
    // å¹¶å‘å‘é€è¯·æ±‚
    public CompletableFuture<String> sendConcurrentRequest(String request) {
        return CompletableFuture.supplyAsync(() -> {
            try {
                // è·å–è®¸å¯ï¼Œé™åˆ¶å¹¶å‘æ•°é‡
                requestLimiter.acquire();
                
                // å®é™…å‘é€é€»è¾‘
                return sendRequestInternal(request);
                
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
                throw new RuntimeException("è¯·æ±‚è¢«ä¸­æ–­", e);
            } finally {
                // é‡Šæ”¾è®¸å¯
                requestLimiter.release();
            }
        }, executor);
    }
    
    // æ‰¹é‡è¯·æ±‚å¤„ç†
    public List<CompletableFuture<String>> sendBatchRequests(List<String> requests) {
        return requests.stream()
                      .map(this::sendConcurrentRequest)
                      .collect(Collectors.toList());
    }
}
```

### 5.3 é”™è¯¯æ¢å¤æœºåˆ¶


**ğŸ›¡ï¸ å®¹é”™å¤„ç†ç­–ç•¥**
```java
public class ResilientRequestHandler {
    private final int maxRetries = 3;
    private final long retryDelayMs = 1000;
    
    // å¸¦é‡è¯•çš„è¯·æ±‚å‘é€
    public CompletableFuture<String> sendWithRetry(String request) {
        return sendWithRetry(request, 0);
    }
    
    private CompletableFuture<String> sendWithRetry(String request, int attempt) {
        return sendRequestInternal(request)
            .exceptionally(throwable -> {
                if (attempt < maxRetries) {
                    // ç­‰å¾…åé‡è¯•
                    try {
                        Thread.sleep(retryDelayMs * (attempt + 1)); // æŒ‡æ•°é€€é¿
                        return sendWithRetry(request, attempt + 1).get();
                    } catch (Exception e) {
                        throw new RuntimeException("é‡è¯•å¤±è´¥", e);
                    }
                } else {
                    throw new RuntimeException("è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°", throwable);
                }
            });
    }
    
    // æ–­è·¯å™¨æ¨¡å¼
    public class CircuitBreaker {
        private volatile boolean isOpen = false;
        private volatile long lastFailureTime = 0;
        private final long timeoutMs = 60000; // 1åˆ†é’Ÿåå°è¯•æ¢å¤
        
        public boolean allowRequest() {
            if (!isOpen) {
                return true;
            }
            
            // è¶…æ—¶åå°è¯•æ¢å¤
            if (System.currentTimeMillis() - lastFailureTime > timeoutMs) {
                isOpen = false;
                return true;
            }
            
            return false;
        }
        
        public void recordFailure() {
            isOpen = true;
            lastFailureTime = System.currentTimeMillis();
        }
    }
}
```

---

## 6. ğŸ› ï¸ å®æˆ˜æ¡ˆä¾‹ä¸æœ€ä½³å®è·µ


### 6.1 ç”µå•†è®¢å•å¤„ç†æ¡ˆä¾‹


**ğŸ“‹ ä¸šåŠ¡åœºæ™¯æè¿°**
- ç”¨æˆ·ä¸‹å•åï¼Œéœ€è¦æ£€æŸ¥åº“å­˜ã€è®¡ç®—ä»·æ ¼ã€æ‰£å‡åº“å­˜ã€ç”Ÿæˆè®¢å•
- æ•´ä¸ªæµç¨‹å¯èƒ½éœ€è¦å‡ ç§’é’Ÿï¼Œç”¨æˆ·ä¸åº”è¯¥ä¸€ç›´ç­‰å¾…
- éœ€è¦å®æ—¶æ›´æ–°è®¢å•çŠ¶æ€ï¼Œè®©ç”¨æˆ·çŸ¥é“å¤„ç†è¿›åº¦

**ğŸ”§ å®Œæ•´å®ç°æ–¹æ¡ˆ**
```java
// è®¢å•è¯·æ±‚å¤„ç†å™¨
public class OrderRequestHandler {
    
    // è®¢å•è¯·æ±‚æ•°æ®ç»“æ„
    public static class OrderRequest {
        private String userId;
        private List<OrderItem> items;
        private String deliveryAddress;
        private String paymentMethod;
    }
    
    // è®¢å•å“åº”æ•°æ®ç»“æ„
    public static class OrderResponse {
        private String orderId;
        private String status;
        private BigDecimal totalAmount;
        private String estimatedDelivery;
        private String errorMessage;
    }
    
    // å‘é€è®¢å•è¯·æ±‚
    public CompletableFuture<OrderResponse> submitOrder(OrderRequest request) {
        String correlationId = "ORDER_" + UUID.randomUUID().toString();
        String replyQueue = "order_response_" + request.getUserId();
        
        // ç¡®ä¿å“åº”é˜Ÿåˆ—å­˜åœ¨
        createResponseQueueIfNotExists(replyQueue);
        
        // æ„å»ºè¯·æ±‚æ¶ˆæ¯
        String requestJson = JsonUtils.toJson(request);
        
        AMQP.BasicProperties props = new AMQP.BasicProperties.Builder()
            .correlationId(correlationId)
            .replyTo(replyQueue)
            .type("ORDER_SUBMIT")
            .timestamp(new Date())
            .build();
        
        // å‘é€è¯·æ±‚
        channel.basicPublish("", "order_request_queue", props, requestJson.getBytes());
        
        // è¿”å›Futureç”¨äºå¼‚æ­¥è·å–ç»“æœ
        return waitForResponse(correlationId);
    }
    
    // å¤„ç†è®¢å•è¯·æ±‚ï¼ˆæœåŠ¡ç«¯ï¼‰
    public void processOrderRequest(String requestJson, AMQP.BasicProperties props) {
        String correlationId = props.getCorrelationId();
        String replyTo = props.getReplyTo();
        
        try {
            OrderRequest request = JsonUtils.fromJson(requestJson, OrderRequest.class);
            
            // ä¸šåŠ¡å¤„ç†æµç¨‹
            OrderResponse response = new OrderResponse();
            
            // 1. æ£€æŸ¥åº“å­˜
            if (!checkInventory(request.getItems())) {
                response.setStatus("INVENTORY_INSUFFICIENT");
                response.setErrorMessage("åº“å­˜ä¸è¶³");
                sendResponse(response, correlationId, replyTo);
                return;
            }
            
            // 2. è®¡ç®—ä»·æ ¼
            BigDecimal totalAmount = calculateTotalAmount(request.getItems());
            response.setTotalAmount(totalAmount);
            
            // 3. åˆ›å»ºè®¢å•
            String orderId = createOrder(request, totalAmount);
            response.setOrderId(orderId);
            response.setStatus("ORDER_CREATED");
            
            // 4. æ‰£å‡åº“å­˜
            deductInventory(request.getItems());
            
            sendResponse(response, correlationId, replyTo);
            
        } catch (Exception e) {
            // é”™è¯¯å¤„ç†
            OrderResponse errorResponse = new OrderResponse();
            errorResponse.setStatus("PROCESSING_ERROR");
            errorResponse.setErrorMessage(e.getMessage());
            sendResponse(errorResponse, correlationId, replyTo);
        }
    }
}
```

### 6.2 å®æ—¶èŠå¤©ç³»ç»Ÿæ¡ˆä¾‹


**ğŸ’¬ èŠå¤©æ¶ˆæ¯æŠ•é€’ç¡®è®¤**
```java
public class ChatMessageHandler {
    
    // å‘é€èŠå¤©æ¶ˆæ¯å¹¶ç­‰å¾…é€è¾¾ç¡®è®¤
    public CompletableFuture<MessageDeliveryStatus> sendMessage(ChatMessage message) {
        String correlationId = "MSG_" + message.getMessageId();
        String replyQueue = "delivery_confirm_" + message.getSenderId();
        
        // æ„å»ºæ¶ˆæ¯
        String messageJson = JsonUtils.toJson(message);
        
        AMQP.BasicProperties props = new AMQP.BasicProperties.Builder()
            .correlationId(correlationId)
            .replyTo(replyQueue)
            .type("CHAT_MESSAGE")
            .priority(message.isUrgent() ? 5 : 1)  // ç´§æ€¥æ¶ˆæ¯ä¼˜å…ˆçº§æ›´é«˜
            .build();
        
        // å‘é€åˆ°èŠå¤©æ¶ˆæ¯é˜Ÿåˆ—
        channel.basicPublish("chat_exchange", 
                            "chat.message." + message.getReceiverId(), 
                            props, messageJson.getBytes());
        
        return waitForDeliveryConfirmation(correlationId);
    }
    
    // å¤„ç†æ¶ˆæ¯æŠ•é€’ï¼ˆæ¥æ”¶æ–¹ï¼‰
    public void handleMessageDelivery(String messageJson, AMQP.BasicProperties props) {
        try {
            ChatMessage message = JsonUtils.fromJson(messageJson, ChatMessage.class);
            
            // æŠ•é€’ç»™ç”¨æˆ·
            boolean delivered = deliverToUser(message);
            
            // å‘é€æŠ•é€’ç¡®è®¤
            MessageDeliveryStatus status = new MessageDeliveryStatus();
            status.setMessageId(message.getMessageId());
            status.setDelivered(delivered);
            status.setDeliveryTime(new Date());
            
            sendDeliveryConfirmation(status, props.getCorrelationId(), props.getReplyTo());
            
        } catch (Exception e) {
            // æŠ•é€’å¤±è´¥ç¡®è®¤
            MessageDeliveryStatus failStatus = new MessageDeliveryStatus();
            failStatus.setDelivered(false);
            failStatus.setErrorMessage(e.getMessage());
            
            sendDeliveryConfirmation(failStatus, props.getCorrelationId(), props.getReplyTo());
        }
    }
}
```

### 6.3 æœ€ä½³å®è·µæ€»ç»“


**ğŸ“‹ è®¾è®¡åŸåˆ™**
```
ğŸ¯ å•ä¸€èŒè´£åŸåˆ™
- æ¯ä¸ªé˜Ÿåˆ—åªå¤„ç†ä¸€ç§ç±»å‹çš„è¯·æ±‚
- é¿å…æ··åˆä¸åŒä¸šåŠ¡é€»è¾‘

ğŸ”„ å¹‚ç­‰æ€§è®¾è®¡
- é‡å¤å‘é€åŒä¸€è¯·æ±‚åº”è¯¥å¾—åˆ°ç›¸åŒç»“æœ
- ä½¿ç”¨ä¸šåŠ¡å”¯ä¸€æ ‡è¯†é˜²æ­¢é‡å¤å¤„ç†

â±ï¸ è¶…æ—¶æœºåˆ¶
- ä¸ºæ¯ä¸ªè¯·æ±‚è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
- è¶…æ—¶åè¿›è¡Œæ¸…ç†ï¼Œé‡Šæ”¾èµ„æº

ğŸ›¡ï¸ é”™è¯¯å¤„ç†
- åŒºåˆ†å¯é‡è¯•é”™è¯¯å’Œä¸å¯é‡è¯•é”™è¯¯
- æä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œé”™è¯¯ç 
```

**âš¡ æ€§èƒ½ä¼˜åŒ–å»ºè®®**
```
ğŸ“Š ç›‘æ§æŒ‡æ ‡
- è¯·æ±‚å“åº”æ—¶é—´åˆ†å¸ƒ
- é˜Ÿåˆ—ç§¯å‹æƒ…å†µ
- é”™è¯¯ç‡ç»Ÿè®¡

ğŸ”§ è°ƒä¼˜å‚æ•°
- åˆç†è®¾ç½®é˜Ÿåˆ—prefetchæ•°é‡
- ä¼˜åŒ–æ¶ˆæ¯åºåˆ—åŒ–æ–¹å¼
- ä½¿ç”¨è¿æ¥æ± å¤ç”¨è¿æ¥

ğŸ’¾ èµ„æºç®¡ç†
- å®šæœŸæ¸…ç†è¿‡æœŸçš„å“åº”é˜Ÿåˆ—
- é™åˆ¶å•ä¸ªå®¢æˆ·ç«¯çš„å¹¶å‘è¯·æ±‚æ•°
- å®ç°ä¼˜é›…çš„æœåŠ¡å…³é—­æµç¨‹
```

**ğŸ” æ•…éšœæ’æŸ¥æŠ€å·§**
```
å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆï¼š

â“ å“åº”ä¸¢å¤±
â†’ æ£€æŸ¥correlationIdæ˜¯å¦æ­£ç¡®
â†’ ç¡®è®¤å“åº”é˜Ÿåˆ—é…ç½®
â†’ éªŒè¯æ¶ˆæ¯è·¯ç”±è§„åˆ™

â“ å“åº”å»¶è¿Ÿé«˜
â†’ ç›‘æ§é˜Ÿåˆ—ç§¯å‹æƒ…å†µ
â†’ æ£€æŸ¥å¤„ç†è€…æ•°é‡æ˜¯å¦è¶³å¤Ÿ
â†’ ä¼˜åŒ–ä¸šåŠ¡å¤„ç†é€»è¾‘

â“ å†…å­˜æ³„æ¼
â†’ æ£€æŸ¥æ˜¯å¦åŠæ—¶æ¸…ç†è¿‡æœŸè¯·æ±‚
â†’ ç¡®è®¤å“åº”é˜Ÿåˆ—æ˜¯å¦æ­£å¸¸æ¶ˆè´¹
â†’ é¿å…æ— é™æœŸç­‰å¾…å“åº”
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ è¯·æ±‚å“åº”æ¨¡å¼ï¼šå¼‚æ­¥çš„é—®ç­”æœºåˆ¶ï¼Œè§£è€¦è¯·æ±‚æ–¹å’Œå¤„ç†æ–¹
ğŸ”¸ correlationIdï¼šè¯·æ±‚å“åº”åŒ¹é…çš„å…³é”®ï¼Œç¡®ä¿æ¶ˆæ¯æ­£ç¡®å…³è”
ğŸ”¸ å“åº”è·¯ç”±ï¼šçµæ´»çš„å“åº”æŠ•é€’ç­–ç•¥ï¼Œæ”¯æŒå¤šç§ä¸šåŠ¡åœºæ™¯
ğŸ”¸ çŠ¶æ€ç®¡ç†ï¼šå…¨ç¨‹è·Ÿè¸ªè¯·æ±‚ç”Ÿå‘½å‘¨æœŸï¼Œæä¾›å¯é æ€§ä¿éšœ
ğŸ”¸ å¹¶å‘å¤„ç†ï¼šæ”¯æŒé«˜å¹¶å‘è¯·æ±‚ï¼Œåˆç†æ§åˆ¶èµ„æºæ¶ˆè€—
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆé€‰æ‹©å¼‚æ­¥æ¨¡å¼**
```
æ€§èƒ½ä¼˜åŠ¿ï¼š
- å®¢æˆ·ç«¯ä¸éœ€è¦ç­‰å¾…ï¼Œæé«˜å“åº”é€Ÿåº¦
- æ”¯æŒå¤šä¸ªå¤„ç†è€…å¹¶è¡Œå·¥ä½œ
- è§£è€¦å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„ç”Ÿå‘½å‘¨æœŸ

å¯é æ€§ä¼˜åŠ¿ï¼š
- è¯·æ±‚ä¿å­˜åœ¨é˜Ÿåˆ—ä¸­ï¼Œä¸ä¼šä¸¢å¤±
- æ”¯æŒé‡è¯•å’Œé”™è¯¯æ¢å¤
- æä¾›å®Œæ•´çš„å¤„ç†çŠ¶æ€è·Ÿè¸ª
```

**ğŸ”¹ å…³è”æœºåˆ¶çš„ç²¾å¦™è®¾è®¡**
```
è®¾è®¡æ€æƒ³ï¼š
- æ¯ä¸ªè¯·æ±‚éƒ½æœ‰å”¯ä¸€æ ‡è¯†(correlationId)
- å“åº”æ—¶åŸæ ·è¿”å›è¿™ä¸ªæ ‡è¯†
- å®¢æˆ·ç«¯é€šè¿‡æ ‡è¯†åŒ¹é…å¯¹åº”å…³ç³»

å®é™…æ•ˆæœï¼š
- æ”¯æŒä¹±åºå“åº”å¤„ç†
- å…è®¸å¤šä¸ªè¯·æ±‚å¹¶å‘æ‰§è¡Œ
- æä¾›ç²¾ç¡®çš„è¯·æ±‚è·Ÿè¸ªèƒ½åŠ›
```

**ğŸ”¹ å“åº”è·¯ç”±çš„çµæ´»æ€§**
```
è®¾è®¡è€ƒè™‘ï¼š
- ä¸åŒå®¢æˆ·ç«¯ä½¿ç”¨ä¸åŒå“åº”é˜Ÿåˆ—
- æ”¯æŒåŸºäºä¸šåŠ¡ç±»å‹çš„è·¯ç”±
- å¯ä»¥åŠ¨æ€è°ƒæ•´è·¯ç”±ç­–ç•¥

ä¸šåŠ¡ä»·å€¼ï¼š
- é¿å…å“åº”ä¸²æ‰°é—®é¢˜
- æ”¯æŒä¸ªæ€§åŒ–å¤„ç†æµç¨‹
- ä¾¿äºç›‘æ§å’Œæ•…éšœå®šä½
```

### 7.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¸šåŠ¡åœºæ™¯åº”ç”¨**
- **å¾®æœåŠ¡æ¶æ„**ï¼šæœåŠ¡é—´å¼‚æ­¥é€šä¿¡çš„æ ‡å‡†æ¨¡å¼
- **è®¢å•å¤„ç†ç³»ç»Ÿ**ï¼šå¤æ‚ä¸šåŠ¡æµç¨‹çš„å¯é æ‰§è¡Œ
- **æ•°æ®åˆ†æå¹³å°**ï¼šå¤§æ•°æ®å¤„ç†ä»»åŠ¡çš„å¼‚æ­¥æäº¤
- **æ¶ˆæ¯æ¨é€æœåŠ¡**ï¼šæ¶ˆæ¯æŠ•é€’çŠ¶æ€çš„å®æ—¶ç¡®è®¤

**ğŸ”§ æŠ€æœ¯å®è·µ**
- **ç³»ç»Ÿè§£è€¦**ï¼šé™ä½æœåŠ¡é—´çš„ç›´æ¥ä¾èµ–å…³ç³»
- **æ€§èƒ½æå‡**ï¼šé€šè¿‡å¼‚æ­¥å¤„ç†æé«˜ç³»ç»Ÿååé‡
- **å¯é æ€§ä¿éšœ**ï¼šæä¾›å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- **ç›‘æ§è¿ç»´**ï¼šå…¨ç¨‹è·Ÿè¸ªè¯·æ±‚çŠ¶æ€ï¼Œä¾¿äºé—®é¢˜å®šä½

**æ ¸å¿ƒè®°å¿†**ï¼š
- è¯·æ±‚å“åº”æ¨¡å¼æ˜¯RabbitMQä¸­å®ç°å¼‚æ­¥è°ƒç”¨çš„æ ¸å¿ƒæ¨¡å¼
- correlationIdæ˜¯è¯·æ±‚å“åº”åŒ¹é…çš„å…³é”®æœºåˆ¶
- åˆç†çš„å“åº”è·¯ç”±è®¾è®¡èƒ½æœ‰æ•ˆé¿å…æ¶ˆæ¯ä¸²æ‰°
- çŠ¶æ€ç®¡ç†å’Œå¹¶å‘æ§åˆ¶æ˜¯ç”Ÿäº§ç¯å¢ƒçš„å¿…å¤‡èƒ½åŠ›
- å®é™…åº”ç”¨ä¸­è¦é‡ç‚¹å…³æ³¨è¶…æ—¶å¤„ç†å’Œé”™è¯¯æ¢å¤