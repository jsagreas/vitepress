---
title: 8ã€ä»£ç†è´Ÿè½½å‡è¡¡
---
## ğŸ“š ç›®å½•

1. [è´Ÿè½½å‡è¡¡åŸºç¡€æ¦‚å¿µ](#1-è´Ÿè½½å‡è¡¡åŸºç¡€æ¦‚å¿µ)
2. [HAProxyè´Ÿè½½å‡è¡¡é…ç½®](#2-HAProxyè´Ÿè½½å‡è¡¡é…ç½®)
3. [Nginx TCPä»£ç†é…ç½®](#3-Nginx-TCPä»£ç†é…ç½®)
4. [Keepalivedé«˜å¯ç”¨æ–¹æ¡ˆ](#4-Keepalivedé«˜å¯ç”¨æ–¹æ¡ˆ)
5. [å¥åº·æ£€æŸ¥æœºåˆ¶](#5-å¥åº·æ£€æŸ¥æœºåˆ¶)
6. [SSLç»ˆç»“å¤„ç†](#6-SSLç»ˆç»“å¤„ç†)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ è´Ÿè½½å‡è¡¡åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯RabbitMQè´Ÿè½½å‡è¡¡


**ç®€å•ç†è§£**ï¼šè´Ÿè½½å‡è¡¡å°±åƒä¸€ä¸ªæ™ºèƒ½åˆ†æµå™¨ï¼ŒæŠŠå®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚å‡åŒ€åˆ†å‘åˆ°å¤šä¸ªRabbitMQæœåŠ¡å™¨ä¸Šï¼Œé¿å…æŸä¸€å°æœåŠ¡å™¨è¿‡è½½ã€‚

```
å®¢æˆ·ç«¯è¯·æ±‚åˆ†å‘ç¤ºæ„å›¾ï¼š
     å®¢æˆ·ç«¯åº”ç”¨
         |
    [è´Ÿè½½å‡è¡¡å™¨]  â† æ™ºèƒ½åˆ†å‘å™¨
    /    |    \
   /     |     \
RabbitMQ1  RabbitMQ2  RabbitMQ3
```

**ä¸ºä»€ä¹ˆéœ€è¦è´Ÿè½½å‡è¡¡ï¼Ÿ**
- **é¿å…å•ç‚¹æ•…éšœ**ï¼šä¸€å°æœåŠ¡å™¨å®•æœºï¼Œå…¶ä»–æœåŠ¡å™¨ç»§ç»­å·¥ä½œ
- **æå‡æ€§èƒ½**ï¼šå¤šå°æœåŠ¡å™¨åˆ†æ‹…è´Ÿè½½ï¼Œå¤„ç†èƒ½åŠ›ç¿»å€
- **ç”¨æˆ·ä½“éªŒ**ï¼šå®¢æˆ·ç«¯æ— éœ€å…³å¿ƒå…·ä½“è¿æ¥å“ªå°æœåŠ¡å™¨

### 1.2 è´Ÿè½½å‡è¡¡çš„æ ¸å¿ƒä½œç”¨


â”Œâ”€ æ ¸å¿ƒåŠŸèƒ½ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ **æµé‡åˆ†å‘**ï¼šåˆç†åˆ†é…è¿æ¥è¯·æ±‚    â”‚
â”‚ **æ•…éšœè½¬ç§»**ï¼šè‡ªåŠ¨åˆ‡æ¢åˆ°å¥åº·èŠ‚ç‚¹  â”‚
â”‚ **å¥åº·æ£€æŸ¥**ï¼šç›‘æ§åç«¯æœåŠ¡çŠ¶æ€    â”‚
â”‚ **SSLå¤„ç†**ï¼šç»Ÿä¸€ç®¡ç†è¯ä¹¦å’ŒåŠ å¯†   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

**å®é™…åº”ç”¨åœºæ™¯**ï¼š
ğŸ”¸ **ç”µå•†ç³»ç»Ÿ**ï¼šè®¢å•é«˜å³°æœŸå¤šå°æ¶ˆæ¯é˜Ÿåˆ—åˆ†æ‹…å‹åŠ›
ğŸ”¸ **é‡‘èäº¤æ˜“**ï¼šç¡®ä¿äº¤æ˜“æ¶ˆæ¯ä¸å› å•ç‚¹æ•…éšœä¸¢å¤±
ğŸ”¸ **ç‰©è”ç½‘**ï¼šæµ·é‡è®¾å¤‡æ¶ˆæ¯éœ€è¦å¤šèŠ‚ç‚¹å¤„ç†

---

## 2. âš–ï¸ HAProxyè´Ÿè½½å‡è¡¡é…ç½®


### 2.1 HAProxyåŸºæœ¬æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯HAProxyï¼Ÿ**
HAProxyæ˜¯ä¸€ä¸ªå…è´¹çš„é«˜æ€§èƒ½è´Ÿè½½å‡è¡¡å™¨ï¼Œå°±åƒä¸€ä¸ªè¶…çº§æ™ºèƒ½çš„äº¤é€šæŒ‡æŒ¥å‘˜ï¼Œä¸“é—¨è´Ÿè´£æŠŠç½‘ç»œè¯·æ±‚åˆç†åˆ†é…åˆ°ä¸åŒçš„æœåŠ¡å™¨ã€‚

**HAProxyçš„ä¼˜åŠ¿**ï¼š
- ğŸš€ **æ€§èƒ½æé«˜**ï¼šå•æœºå¯å¤„ç†æ•°ä¸‡å¹¶å‘è¿æ¥
- ğŸ” **å¥åº·æ£€æŸ¥**ï¼šè‡ªåŠ¨æ£€æµ‹æœåŠ¡å™¨æ˜¯å¦æ­£å¸¸
- ğŸ“Š **ç›‘æ§å‹å¥½**ï¼šæä¾›è¯¦ç»†çš„çŠ¶æ€é¡µé¢
- ğŸ›¡ï¸ **ç¨³å®šå¯é **ï¼šä¹…ç»è€ƒéªŒçš„å¼€æºé¡¹ç›®

### 2.2 HAProxyé…ç½®å®æˆ˜


**é…ç½®æ–‡ä»¶ç»“æ„**ï¼š
```
/etc/haproxy/haproxy.cfg

é…ç½®åˆ†ä¸ºå››ä¸ªéƒ¨åˆ†ï¼š
â”Œâ”€ global     â† å…¨å±€è®¾ç½®
â”œâ”€ defaults   â† é»˜è®¤å‚æ•°
â”œâ”€ frontend   â† å‰ç«¯æ¥å…¥ç‚¹
â””â”€ backend    â† åç«¯æœåŠ¡ç»„
```

**å®Œæ•´é…ç½®ç¤ºä¾‹**ï¼š
```bash
# ==== å…¨å±€é…ç½® ====
global
    # æœ€å¤§è¿æ¥æ•°
    maxconn 4096
    # è¿è¡Œç”¨æˆ·
    user haproxy
    group haproxy
    # è¿›ç¨‹IDæ–‡ä»¶
    pidfile /var/run/haproxy.pid
    # æ—¥å¿—é…ç½®
    log 127.0.0.1:514 local0

# ==== é»˜è®¤é…ç½® ====
defaults
    mode tcp                    # TCPæ¨¡å¼ï¼Œé€‚åˆRabbitMQ
    timeout connect 10s         # è¿æ¥è¶…æ—¶
    timeout client 1m           # å®¢æˆ·ç«¯è¶…æ—¶
    timeout server 1m           # æœåŠ¡å™¨è¶…æ—¶
    option tcplog               # å¯ç”¨TCPæ—¥å¿—

# ==== ç»Ÿè®¡é¡µé¢ ====
listen stats
    bind *:8080                 # ç›‘å¬8080ç«¯å£
    stats enable                # å¯ç”¨ç»Ÿè®¡
    stats uri /haproxy          # è®¿é—®è·¯å¾„
    stats refresh 30s           # åˆ·æ–°é—´éš”

# ==== RabbitMQç®¡ç†ç•Œé¢è´Ÿè½½å‡è¡¡ ====
frontend rabbitmq_management
    bind *:15672                # ç›‘å¬ç®¡ç†ç•Œé¢ç«¯å£
    mode http                   # HTTPæ¨¡å¼
    default_backend rabbitmq_management_servers

backend rabbitmq_management_servers
    mode http
    balance roundrobin          # è½®è¯¢ç®—æ³•
    option httpchk GET /api/overview  # å¥åº·æ£€æŸ¥
    server rabbit1 192.168.1.10:15672 check
    server rabbit2 192.168.1.11:15672 check
    server rabbit3 192.168.1.12:15672 check

# ==== RabbitMQ AMQPåè®®è´Ÿè½½å‡è¡¡ ====
frontend rabbitmq_amqp
    bind *:5672                 # ç›‘å¬AMQPç«¯å£
    mode tcp                    # TCPæ¨¡å¼
    default_backend rabbitmq_amqp_servers

backend rabbitmq_amqp_servers
    mode tcp
    balance leastconn           # æœ€å°‘è¿æ¥ç®—æ³•
    option tcp-check            # TCPå¥åº·æ£€æŸ¥
    server rabbit1 192.168.1.10:5672 check inter 5s
    server rabbit2 192.168.1.11:5672 check inter 5s
    server rabbit3 192.168.1.12:5672 check inter 5s backup  # å¤‡ç”¨æœåŠ¡å™¨
```

### 2.3 è´Ÿè½½å‡è¡¡ç®—æ³•è¯¦è§£


| ç®—æ³•ç±»å‹ | **å·¥ä½œåŸç†** | **é€‚ç”¨åœºæ™¯** | **ä¼˜ç¼ºç‚¹** |
|---------|------------|-------------|-----------|
| ğŸ”„ **roundrobin** | `æŒ‰é¡ºåºè½®æµåˆ†é…` | `æœåŠ¡å™¨æ€§èƒ½ç›¸åŒ` | `ç®€å•å…¬å¹³ï¼Œä½†ä¸è€ƒè™‘è´Ÿè½½` |
| âš–ï¸ **leastconn** | `åˆ†é…ç»™è¿æ¥æ•°æœ€å°‘çš„æœåŠ¡å™¨` | `é•¿è¿æ¥åº”ç”¨` | `è€ƒè™‘å®æ—¶è´Ÿè½½ï¼Œæ¨èä½¿ç”¨` |
| ğŸ¯ **source** | `æ ¹æ®å®¢æˆ·ç«¯IPå“ˆå¸Œåˆ†é…` | `éœ€è¦ä¼šè¯ä¿æŒ` | `åŒä¸€å®¢æˆ·ç«¯å›ºå®šæœåŠ¡å™¨` |
| ğŸ“Š **uri** | `æ ¹æ®è¯·æ±‚URIå“ˆå¸Œåˆ†é…` | `ç¼“å­˜å‹å¥½åœºæ™¯` | `ç›¸åŒè¯·æ±‚åˆ°åŒä¸€æœåŠ¡å™¨` |

ğŸ’¡ **æ¨èé€‰æ‹©**ï¼š
- **AMQPè¿æ¥**ï¼šä½¿ç”¨ `leastconn`ï¼Œå› ä¸ºRabbitMQè¿æ¥é€šå¸¸æ˜¯é•¿è¿æ¥
- **ç®¡ç†ç•Œé¢**ï¼šä½¿ç”¨ `roundrobin`ï¼Œè®¿é—®ç›¸å¯¹ç®€å•

### 2.4 å¯åŠ¨å’Œæµ‹è¯•


**å¯åŠ¨HAProxy**ï¼š
```bash
# æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•
haproxy -c -f /etc/haproxy/haproxy.cfg

# å¯åŠ¨æœåŠ¡
systemctl start haproxy
systemctl enable haproxy

# æŸ¥çœ‹çŠ¶æ€
systemctl status haproxy
```

**æµ‹è¯•è´Ÿè½½å‡è¡¡**ï¼š
```bash
# æµ‹è¯•è¿æ¥åˆ†å‘
for i in {1..5}; do
  curl -s http://localhost:8080/haproxy | grep "rabbit"
  sleep 1
done

# æŸ¥çœ‹ç»Ÿè®¡é¡µé¢
æµè§ˆå™¨è®¿é—®ï¼šhttp://ä½ çš„æœåŠ¡å™¨IP:8080/haproxy
```

---

## 3. ğŸŒ Nginx TCPä»£ç†é…ç½®


### 3.1 Nginx Streamæ¨¡å—


**ä»€ä¹ˆæ˜¯Nginx TCPä»£ç†ï¼Ÿ**
Nginxä¸ä»…èƒ½åšWebæœåŠ¡å™¨ï¼Œè¿˜èƒ½åšTCP/UDPä»£ç†ã€‚é€šè¿‡Streamæ¨¡å—ï¼Œå®ƒå¯ä»¥ä»£ç†RabbitMQçš„TCPè¿æ¥ï¼Œå°±åƒä¸€ä¸ªç½‘ç»œä¸­è½¬ç«™ã€‚

**Streamæ¨¡å—ç‰¹ç‚¹**ï¼š
- ğŸ”„ **å››å±‚ä»£ç†**ï¼šå·¥ä½œåœ¨ä¼ è¾“å±‚ï¼Œæ”¯æŒTCP/UDP
- âš¡ **é«˜æ€§èƒ½**ï¼šåŸºäºäº‹ä»¶é©±åŠ¨ï¼Œå¹¶å‘èƒ½åŠ›å¼º
- ğŸ”§ **é…ç½®ç®€å•**ï¼šè¯­æ³•ç±»ä¼¼HTTPé…ç½®å—
- ğŸ“Š **è´Ÿè½½å‡è¡¡**ï¼šæ”¯æŒå¤šç§åˆ†å‘ç®—æ³•

### 3.2 Nginxé…ç½®å®æˆ˜


**æ£€æŸ¥Streamæ¨¡å—**ï¼š
```bash
# æŸ¥çœ‹nginxæ˜¯å¦åŒ…å«streamæ¨¡å—
nginx -V 2>&1 | grep -o with-stream

# å¦‚æœæ²¡æœ‰ï¼Œéœ€è¦é‡æ–°ç¼–è¯‘æˆ–å®‰è£…åŒ…å«streamçš„ç‰ˆæœ¬
```

**ä¸»é…ç½®æ–‡ä»¶è°ƒæ•´**ï¼š
```nginx
# /etc/nginx/nginx.conf

# HTTPé…ç½®å—ï¼ˆåŸæœ‰é…ç½®ä¿æŒä¸å˜ï¼‰
http {
    # ... åŸæœ‰HTTPé…ç½®
}

# æ–°å¢Streamé…ç½®å—
stream {
    # æ—¥å¿—æ ¼å¼
    log_format proxy '$remote_addr [$time_local] '
                    '$protocol $status $bytes_sent $bytes_received '
                    '$session_time "$upstream_addr" '
                    '"$upstream_bytes_sent" "$upstream_bytes_received" "$upstream_connect_time"';

    # è®¿é—®æ—¥å¿—
    access_log /var/log/nginx/tcp-access.log proxy;

    # åŒ…å«Streamé…ç½®æ–‡ä»¶
    include /etc/nginx/stream.d/*.conf;
}
```

**RabbitMQä»£ç†é…ç½®**ï¼š
```nginx
# /etc/nginx/stream.d/rabbitmq.conf

# å®šä¹‰ä¸Šæ¸¸æœåŠ¡å™¨ç»„
upstream rabbitmq_backend {
    least_conn;                    # æœ€å°‘è¿æ¥ç®—æ³•
    server 192.168.1.10:5672 max_fails=3 fail_timeout=30s;
    server 192.168.1.11:5672 max_fails=3 fail_timeout=30s;
    server 192.168.1.12:5672 max_fails=3 fail_timeout=30s backup;
}

# AMQPåè®®ä»£ç†
server {
    listen 5672;                   # ç›‘å¬ç«¯å£
    proxy_pass rabbitmq_backend;   # è½¬å‘åˆ°åç«¯
    proxy_timeout 1s;              # ä»£ç†è¶…æ—¶
    proxy_responses 1;             # æœŸæœ›çš„å“åº”æ•°
    proxy_connect_timeout 1s;      # è¿æ¥è¶…æ—¶
    error_log /var/log/nginx/rabbitmq_tcp.log;
}

# ç®¡ç†ç•Œé¢ä»£ç†
upstream rabbitmq_management {
    server 192.168.1.10:15672;
    server 192.168.1.11:15672;
    server 192.168.1.12:15672;
}

server {
    listen 15672;
    proxy_pass rabbitmq_management;
    proxy_timeout 3s;
    proxy_responses 1;
    proxy_connect_timeout 1s;
}
```

### 3.3 å¥åº·æ£€æŸ¥é…ç½®


**è¢«åŠ¨å¥åº·æ£€æŸ¥**ï¼ˆNginxè‡ªå¸¦ï¼‰ï¼š
```nginx
upstream rabbitmq_backend {
    server 192.168.1.10:5672 max_fails=3 fail_timeout=30s;
    # max_fails: å¤±è´¥3æ¬¡æ ‡è®°ä¸ºä¸å¯ç”¨
    # fail_timeout: 30ç§’åé‡æ–°å°è¯•
}
```

**ä¸»åŠ¨å¥åº·æ£€æŸ¥**ï¼ˆéœ€è¦Nginx Plusæˆ–ç¬¬ä¸‰æ–¹æ¨¡å—ï¼‰ï¼š
```nginx
# ä½¿ç”¨nginx-upstream-check-module
upstream rabbitmq_backend {
    server 192.168.1.10:5672;
    server 192.168.1.11:5672;
    
    check interval=3000 rise=2 fall=5 timeout=1000 type=tcp;
    # interval: æ£€æŸ¥é—´éš”3ç§’
    # rise: æˆåŠŸ2æ¬¡è®¤ä¸ºæ¢å¤
    # fall: å¤±è´¥5æ¬¡è®¤ä¸ºä¸‹çº¿
    # timeout: è¶…æ—¶æ—¶é—´1ç§’
}
```

### 3.4 å¯åŠ¨å’ŒéªŒè¯


**é‡è½½Nginxé…ç½®**ï¼š
```bash
# æµ‹è¯•é…ç½®æ–‡ä»¶
nginx -t

# é‡è½½é…ç½®
nginx -s reload

# æŸ¥çœ‹è¿›ç¨‹
ps aux | grep nginx
```

**è¿æ¥æµ‹è¯•**ï¼š
```bash
# æµ‹è¯•TCPè¿æ¥
telnet localhost 5672

# ä½¿ç”¨RabbitMQå®¢æˆ·ç«¯æµ‹è¯•
rabbitmqctl -H localhost:5672 list_queues
```

---

## 4. ğŸ›¡ï¸ Keepalivedé«˜å¯ç”¨æ–¹æ¡ˆ


### 4.1 KeepalivedåŸºæœ¬æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯Keepalivedï¼Ÿ**
æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœè´Ÿè½½å‡è¡¡å™¨æœ¬èº«å‡ºæ•…éšœäº†æ€ä¹ˆåŠï¼ŸKeepalivedå°±æ˜¯è´Ÿè½½å‡è¡¡å™¨çš„"ä¿é•–"ï¼Œå½“ä¸»è´Ÿè½½å‡è¡¡å™¨å‡ºé—®é¢˜æ—¶ï¼Œå¤‡ç”¨çš„ç«‹å³é¡¶ä¸Šï¼Œç¡®ä¿æœåŠ¡ä¸ä¸­æ–­ã€‚

**VRRPåè®®**ï¼š
```
è™šæ‹ŸIPæ¼‚ç§»ç¤ºæ„å›¾ï¼š

æ­£å¸¸çŠ¶æ€ï¼š
[HAProxyä¸»] â† VIP(192.168.1.100)
[HAProxyå¤‡] â† å¾…æœºçŠ¶æ€

æ•…éšœåˆ‡æ¢ï¼š
[HAProxyä¸»] â† æ•…éšœ
[HAProxyå¤‡] â† VIP(192.168.1.100) æ¼‚ç§»åˆ°å¤‡æœº
```

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- ğŸ¯ **VIP**ï¼šè™šæ‹ŸIPï¼Œå®¢æˆ·ç«¯åªéœ€è¦è¿æ¥è¿™ä¸ªIP
- ğŸ‘‘ **MASTER**ï¼šä¸»æœåŠ¡å™¨ï¼Œæ­£å¸¸æƒ…å†µä¸‹å¤„ç†æ‰€æœ‰è¯·æ±‚
- ğŸ›¡ï¸ **BACKUP**ï¼šå¤‡æœåŠ¡å™¨ï¼Œä¸»æœåŠ¡å™¨æ•…éšœæ—¶æ¥ç®¡
- ğŸ’“ **å¿ƒè·³æ£€æµ‹**ï¼šå®šæœŸæ£€æŸ¥ä¸»æœåŠ¡å™¨æ˜¯å¦æ­£å¸¸

### 4.2 Keepalivedé…ç½®å®æˆ˜


**ä¸»æœåŠ¡å™¨é…ç½®**ï¼š
```bash
# /etc/keepalived/keepalived.conf (ä¸»æœåŠ¡å™¨)

global_defs {
    # é‚®ä»¶é€šçŸ¥é…ç½®
    notification_email {
        admin@company.com
    }
    notification_email_from keepalived@server1
    smtp_server 127.0.0.1
    smtp_connect_timeout 30
    # æœåŠ¡å™¨æ ‡è¯†
    router_id RABBITMQ_LB_01
}

# å¥åº·æ£€æŸ¥è„šæœ¬
vrrp_script chk_haproxy {
    script "/etc/keepalived/check_haproxy.sh"  # æ£€æŸ¥è„šæœ¬è·¯å¾„
    interval 2      # æ£€æŸ¥é—´éš”2ç§’
    timeout 2       # è¶…æ—¶æ—¶é—´
    weight -2       # å¤±è´¥æ—¶ä¼˜å…ˆçº§å‡2
    fall 3          # è¿ç»­å¤±è´¥3æ¬¡è®¤ä¸ºå¤±è´¥
    rise 2          # è¿ç»­æˆåŠŸ2æ¬¡è®¤ä¸ºæ¢å¤
}

# VRRPå®ä¾‹é…ç½®
vrrp_instance VI_1 {
    state MASTER           # è§’è‰²ï¼šä¸»æœåŠ¡å™¨
    interface eth0         # ç½‘ç»œæ¥å£
    virtual_router_id 51   # è™šæ‹Ÿè·¯ç”±IDï¼ˆä¸»å¤‡å¿…é¡»ç›¸åŒï¼‰
    priority 100           # ä¼˜å…ˆçº§ï¼ˆä¸»æœåŠ¡å™¨è®¾ç½®è¾ƒé«˜ï¼‰
    advert_int 1          # å¿ƒè·³é—´éš”1ç§’
    
    # è®¤è¯é…ç½®
    authentication {
        auth_type PASS
        auth_pass mypassword123
    }
    
    # è™šæ‹ŸIPé…ç½®
    virtual_ipaddress {
        192.168.1.100/24 dev eth0  # VIPåœ°å€
    }
    
    # å…³è”å¥åº·æ£€æŸ¥
    track_script {
        chk_haproxy
    }
    
    # çŠ¶æ€å˜åŒ–æ—¶æ‰§è¡Œçš„è„šæœ¬
    notify_master "/etc/keepalived/notify_master.sh"
    notify_backup "/etc/keepalived/notify_backup.sh"
    notify_fault "/etc/keepalived/notify_fault.sh"
}
```

**å¤‡æœåŠ¡å™¨é…ç½®**ï¼š
```bash
# /etc/keepalived/keepalived.conf (å¤‡æœåŠ¡å™¨)

global_defs {
    notification_email {
        admin@company.com
    }
    notification_email_from keepalived@server2
    smtp_server 127.0.0.1
    smtp_connect_timeout 30
    router_id RABBITMQ_LB_02    # ä¸åŒçš„æ ‡è¯†
}

vrrp_script chk_haproxy {
    script "/etc/keepalived/check_haproxy.sh"
    interval 2
    timeout 2
    weight -2
    fall 3
    rise 2
}

vrrp_instance VI_1 {
    state BACKUP           # è§’è‰²ï¼šå¤‡æœåŠ¡å™¨
    interface eth0
    virtual_router_id 51   # ä¸ä¸»æœåŠ¡å™¨ç›¸åŒ
    priority 90            # ä¼˜å…ˆçº§ä½äºä¸»æœåŠ¡å™¨
    advert_int 1
    
    authentication {
        auth_type PASS
        auth_pass mypassword123  # ä¸ä¸»æœåŠ¡å™¨ç›¸åŒ
    }
    
    virtual_ipaddress {
        192.168.1.100/24 dev eth0
    }
    
    track_script {
        chk_haproxy
    }
}
```

### 4.3 å¥åº·æ£€æŸ¥è„šæœ¬


**HAProxyæ£€æŸ¥è„šæœ¬**ï¼š
```bash
#!/bin/bash
# /etc/keepalived/check_haproxy.sh

# æ£€æŸ¥HAProxyè¿›ç¨‹æ˜¯å¦è¿è¡Œ
if ! pgrep haproxy > /dev/null; then
    echo "HAProxy process not found"
    exit 1
fi

# æ£€æŸ¥HAProxyç»Ÿè®¡é¡µé¢æ˜¯å¦å¯è®¿é—®
if ! curl -f http://localhost:8080/haproxy > /dev/null 2>&1; then
    echo "HAProxy stats page not accessible"
    exit 1
fi

# æ£€æŸ¥æ˜¯å¦èƒ½è¿æ¥åˆ°RabbitMQåç«¯
if ! nc -z 192.168.1.10 5672; then
    echo "Cannot connect to RabbitMQ backend"
    exit 1
fi

echo "HAProxy is healthy"
exit 0
```

**çŠ¶æ€å˜åŒ–é€šçŸ¥è„šæœ¬**ï¼š
```bash
#!/bin/bash
# /etc/keepalived/notify_master.sh

echo "$(date): Becoming MASTER" >> /var/log/keepalived.log
# å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é¢å¤–çš„æ“ä½œï¼Œæ¯”å¦‚å‘é€é€šçŸ¥é‚®ä»¶
```

**è„šæœ¬æƒé™è®¾ç½®**ï¼š
```bash
chmod +x /etc/keepalived/check_haproxy.sh
chmod +x /etc/keepalived/notify_master.sh
chmod +x /etc/keepalived/notify_backup.sh
```

### 4.4 å¯åŠ¨å’Œæµ‹è¯•


**å¯åŠ¨Keepalived**ï¼š
```bash
# å¯åŠ¨æœåŠ¡
systemctl start keepalived
systemctl enable keepalived

# æŸ¥çœ‹çŠ¶æ€
systemctl status keepalived

# æŸ¥çœ‹æ—¥å¿—
tail -f /var/log/messages | grep keepalived
```

**æ•…éšœè½¬ç§»æµ‹è¯•**ï¼š
```bash
# 1. æŸ¥çœ‹å½“å‰VIPä½ç½®
ip addr show eth0 | grep 192.168.1.100

# 2. åœæ­¢ä¸»æœåŠ¡å™¨çš„HAProxy
systemctl stop haproxy

# 3. è§‚å¯ŸVIPæ˜¯å¦æ¼‚ç§»åˆ°å¤‡æœåŠ¡å™¨
# ç­‰å¾…å‡ ç§’åå†æ¬¡æŸ¥çœ‹
ip addr show eth0 | grep 192.168.1.100

# 4. æ¢å¤ä¸»æœåŠ¡å™¨
systemctl start haproxy
# VIPåº”è¯¥é‡æ–°æ¼‚ç§»å›ä¸»æœåŠ¡å™¨
```

---

## 5. ğŸ” å¥åº·æ£€æŸ¥æœºåˆ¶


### 5.1 å¥åº·æ£€æŸ¥çš„é‡è¦æ€§


**ä¸ºä»€ä¹ˆéœ€è¦å¥åº·æ£€æŸ¥ï¼Ÿ**
å°±åƒåŒ»ç”Ÿå®šæœŸç»™ç—…äººåšä½“æ£€ä¸€æ ·ï¼Œè´Ÿè½½å‡è¡¡å™¨éœ€è¦å®šæœŸæ£€æŸ¥åç«¯æœåŠ¡å™¨æ˜¯å¦æ­£å¸¸å·¥ä½œï¼ŒåŠæ—¶å‘ç°é—®é¢˜å¹¶é¿å…æŠŠè¯·æ±‚å‘é€åˆ°æ•…éšœæœåŠ¡å™¨ã€‚

**å¥åº·æ£€æŸ¥çš„å±‚æ¬¡**ï¼š
```
æ£€æŸ¥å±‚æ¬¡ä»æµ…åˆ°æ·±ï¼š

ğŸ”¸ ç½‘ç»œå±‚æ£€æŸ¥   â† pingé€šä¸é€š
ğŸ”¸ ä¼ è¾“å±‚æ£€æŸ¥   â† ç«¯å£å¼€ä¸å¼€  
ğŸ”¸ åº”ç”¨å±‚æ£€æŸ¥   â† æœåŠ¡èƒ½ä¸èƒ½ç”¨
ğŸ”¸ ä¸šåŠ¡å±‚æ£€æŸ¥   â† åŠŸèƒ½æ­£ä¸æ­£å¸¸
```

### 5.2 ä¸åŒå±‚æ¬¡çš„æ£€æŸ¥æ–¹æ³•


**TCPè¿æ¥æ£€æŸ¥**ï¼š
```bash
# HAProxy TCPæ£€æŸ¥é…ç½®
backend rabbitmq_servers
    option tcp-check
    tcp-check connect port 5672
    server rabbit1 192.168.1.10:5672 check inter 5s
```

**HTTPå¥åº·æ£€æŸ¥**ï¼š
```bash
# HAProxy HTTPæ£€æŸ¥é…ç½®
backend rabbitmq_management
    option httpchk GET /api/overview
    http-check expect status 200
    server rabbit1 192.168.1.10:15672 check inter 10s
```

**è‡ªå®šä¹‰æ£€æŸ¥è„šæœ¬**ï¼š
```bash
#!/bin/bash
# /usr/local/bin/rabbitmq_health_check.sh

# æ£€æŸ¥RabbitMQç®¡ç†API
RESPONSE=$(curl -s -u admin:password http://localhost:15672/api/overview)

# æ£€æŸ¥å“åº”æ˜¯å¦åŒ…å«æ­£å¸¸çš„JSONæ•°æ®
if echo "$RESPONSE" | grep -q '"rabbitmq_version"'; then
    echo "RabbitMQ is healthy"
    exit 0
else
    echo "RabbitMQ health check failed"
    exit 1
fi
```

### 5.3 å¥åº·æ£€æŸ¥å‚æ•°ä¼˜åŒ–


**å‚æ•°å«ä¹‰è§£é‡Š**ï¼š
- **interval**ï¼šæ£€æŸ¥é—´éš”æ—¶é—´
- **timeout**ï¼šå•æ¬¡æ£€æŸ¥è¶…æ—¶æ—¶é—´
- **rise**ï¼šè¿ç»­æˆåŠŸå‡ æ¬¡è®¤ä¸ºæ¢å¤
- **fall**ï¼šè¿ç»­å¤±è´¥å‡ æ¬¡è®¤ä¸ºæ•…éšœ

**æ¨èé…ç½®**ï¼š
```bash
# ç”Ÿäº§ç¯å¢ƒæ¨èå‚æ•°
server rabbit1 192.168.1.10:5672 check \
    inter 3s \      # 3ç§’æ£€æŸ¥ä¸€æ¬¡
    timeout 2s \    # 2ç§’è¶…æ—¶
    rise 2 \        # æˆåŠŸ2æ¬¡è®¤ä¸ºæ¢å¤
    fall 3 \        # å¤±è´¥3æ¬¡è®¤ä¸ºæ•…éšœ
    maxconn 100     # æœ€å¤§è¿æ¥æ•°é™åˆ¶
```

**å‚æ•°è°ƒä¼˜åŸåˆ™**ï¼š
- ğŸš€ **å¿«é€Ÿå‘ç°**ï¼šintervalä¸è¦å¤ªé•¿ï¼Œå»ºè®®3-5ç§’
- ğŸ›¡ï¸ **é¿å…è¯¯åˆ¤**ï¼šfallæ¬¡æ•°é€‚ä¸­ï¼Œé¿å…å¶å‘ç½‘ç»œæŠ–åŠ¨
- âš¡ **å¿«é€Ÿæ¢å¤**ï¼šriseæ¬¡æ•°ä¸è¦å¤ªå¤šï¼Œæ¢å¤è¦åŠæ—¶

---

## 6. ğŸ” SSLç»ˆç»“å¤„ç†


### 6.1 SSLç»ˆç»“æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯SSLç»ˆç»“ï¼Ÿ**
SSLç»ˆç»“å°±åƒä¸€ä¸ª"è§£å¯†æœåŠ¡å°"ï¼Œå®¢æˆ·ç«¯å‘æ¥çš„åŠ å¯†æ•°æ®åœ¨è´Ÿè½½å‡è¡¡å™¨è¿™é‡Œè§£å¯†ï¼Œç„¶åä»¥æ˜æ–‡å½¢å¼è½¬å‘ç»™åç«¯æœåŠ¡å™¨ï¼Œè¿™æ ·å¯ä»¥å‡è½»åç«¯æœåŠ¡å™¨çš„CPUè´Ÿæ‹…ã€‚

**SSLç»ˆç»“çš„å¥½å¤„**ï¼š
- ğŸ”“ **æ€§èƒ½æå‡**ï¼šåç«¯æœåŠ¡å™¨æ— éœ€å¤„ç†åŠ å¯†è§£å¯†
- ğŸ¯ **ç»Ÿä¸€ç®¡ç†**ï¼šè¯ä¹¦é›†ä¸­ç®¡ç†ï¼Œä¾¿äºç»´æŠ¤
- ğŸ“Š **å†…å®¹æ£€æŸ¥**ï¼šå¯ä»¥æ£€æŸ¥å’Œè¿‡æ»¤è¯·æ±‚å†…å®¹
- ğŸ”„ **ç¼“å­˜å‹å¥½**ï¼šæ˜æ–‡æ•°æ®ä¾¿äºç¼“å­˜å¤„ç†

### 6.2 HAProxy SSLé…ç½®


**è¯ä¹¦å‡†å¤‡**ï¼š
```bash
# åˆå¹¶è¯ä¹¦å’Œç§é’¥ä¸ºHAProxyæ ¼å¼
cat your_domain.crt your_domain.key > /etc/ssl/certs/rabbitmq.pem

# è®¾ç½®æƒé™
chmod 600 /etc/ssl/certs/rabbitmq.pem
chown haproxy:haproxy /etc/ssl/certs/rabbitmq.pem
```

**SSLå‰ç«¯é…ç½®**ï¼š
```bash
# HAProxy SSLé…ç½®
frontend rabbitmq_amqps
    bind *:5671 ssl crt /etc/ssl/certs/rabbitmq.pem  # SSLç›‘å¬
    mode tcp
    default_backend rabbitmq_amqp_servers

# ç®¡ç†ç•Œé¢HTTPS
frontend rabbitmq_https
    bind *:443 ssl crt /etc/ssl/certs/rabbitmq.pem
    mode http
    # å¼ºåˆ¶HTTPSé‡å®šå‘
    redirect scheme https if !{ ssl_fc }
    default_backend rabbitmq_management_servers
```

**é«˜çº§SSLé…ç½®**ï¼š
```bash
# å®‰å…¨çš„SSLé…ç½®
frontend rabbitmq_secure
    bind *:5671 ssl crt /etc/ssl/certs/rabbitmq.pem \
        ssl-min-ver TLSv1.2 \              # æœ€ä½TLSç‰ˆæœ¬
        ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384 \
        no-sslv3 \                         # ç¦ç”¨SSLv3
        no-tlsv10 \                        # ç¦ç”¨TLSv1.0
        no-tlsv11                          # ç¦ç”¨TLSv1.1
```

### 6.3 Nginx SSLé…ç½®


**Nginx SSLç»ˆç»“**ï¼š
```nginx
# /etc/nginx/stream.d/rabbitmq-ssl.conf

# SSLä¸Šæ¸¸ä»£ç†
map $ssl_preread_server_name $backend_pool {
    rabbitmq.example.com rabbitmq_backend;
    default rabbitmq_backend;
}

# AMQPSä»£ç† (5671ç«¯å£)
server {
    listen 5671 ssl;
    ssl_certificate /etc/ssl/certs/rabbitmq.crt;
    ssl_certificate_key /etc/ssl/private/rabbitmq.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
    
    proxy_pass rabbitmq_backend;
    proxy_ssl off;  # åç«¯ä½¿ç”¨æ˜æ–‡è¿æ¥
}
```

### 6.4 å®¢æˆ·ç«¯è¿æ¥é…ç½®


**å®¢æˆ·ç«¯SSLè¿æ¥ç¤ºä¾‹**ï¼š
```python
import pika
import ssl

# SSLè¿æ¥å‚æ•°
ssl_context = ssl.create_default_context()
ssl_context.check_hostname = False  # å¦‚æœä½¿ç”¨è‡ªç­¾åè¯ä¹¦

# è¿æ¥å‚æ•°
connection_params = pika.ConnectionParameters(
    host='rabbitmq.example.com',
    port=5671,
    ssl_options=pika.SSLOptions(ssl_context),
    credentials=pika.PlainCredentials('username', 'password')
)

# å»ºç«‹è¿æ¥
connection = pika.BlockingConnection(connection_params)
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ è´Ÿè½½å‡è¡¡ä½œç”¨ï¼šæµé‡åˆ†å‘ã€æ•…éšœè½¬ç§»ã€æ€§èƒ½æå‡
ğŸ”¸ HAProxyç‰¹ç‚¹ï¼šé«˜æ€§èƒ½ã€å¥åº·æ£€æŸ¥ã€ç›‘æ§å‹å¥½
ğŸ”¸ Nginx Streamï¼šå››å±‚ä»£ç†ã€äº‹ä»¶é©±åŠ¨ã€é…ç½®ç®€å•
ğŸ”¸ Keepalivedæœºåˆ¶ï¼šVIPæ¼‚ç§»ã€ä¸»å¤‡åˆ‡æ¢ã€å¿ƒè·³æ£€æµ‹
ğŸ”¸ å¥åº·æ£€æŸ¥å±‚æ¬¡ï¼šç½‘ç»œã€ä¼ è¾“ã€åº”ç”¨ã€ä¸šåŠ¡å››ä¸ªå±‚æ¬¡
ğŸ”¸ SSLç»ˆç»“ä¼˜åŠ¿ï¼šæ€§èƒ½æå‡ã€ç»Ÿä¸€ç®¡ç†ã€å†…å®¹æ£€æŸ¥
```

### 7.2 å…³é”®é…ç½®è¦ç‚¹


**ğŸ”¹ è´Ÿè½½å‡è¡¡ç®—æ³•é€‰æ‹©**
```
AMQPè¿æ¥æ¨èï¼šleastconnï¼ˆæœ€å°‘è¿æ¥ï¼‰
ç®¡ç†ç•Œé¢æ¨èï¼šroundrobinï¼ˆè½®è¯¢ï¼‰
ä¼šè¯ä¿æŒéœ€æ±‚ï¼šsourceï¼ˆæºIPå“ˆå¸Œï¼‰
```

**ğŸ”¹ å¥åº·æ£€æŸ¥å‚æ•°**
```
æ£€æŸ¥é—´éš”ï¼š3-5ç§’
è¶…æ—¶æ—¶é—´ï¼š2ç§’
æ•…éšœé˜ˆå€¼ï¼šè¿ç»­å¤±è´¥3æ¬¡
æ¢å¤é˜ˆå€¼ï¼šè¿ç»­æˆåŠŸ2æ¬¡
```

**ğŸ”¹ é«˜å¯ç”¨é…ç½®**
```
ä¸»å¤‡ä¼˜å…ˆçº§ï¼šä¸»æœåŠ¡å™¨100ï¼Œå¤‡æœåŠ¡å™¨90
å¿ƒè·³é—´éš”ï¼š1ç§’
è™šæ‹Ÿè·¯ç”±IDï¼šä¸»å¤‡å¿…é¡»ç›¸åŒ
è®¤è¯å¯†ç ï¼šä¸»å¤‡å¿…é¡»ç›¸åŒ
```

### 7.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ“Š æ–¹æ¡ˆé€‰æ‹©å»ºè®®**ï¼š

| åœºæ™¯ | **æ¨èæ–¹æ¡ˆ** | **ç†ç”±** |
|------|------------|---------|
| ğŸ¢ **å°å‹åº”ç”¨** | `Nginx + Keepalived` | `é…ç½®ç®€å•ï¼Œèµ„æºå ç”¨å°‘` |
| ğŸ­ **ä¸­å‹åº”ç”¨** | `HAProxy + Keepalived` | `åŠŸèƒ½ä¸°å¯Œï¼Œç›‘æ§å®Œå–„` |
| ğŸŒ **å¤§å‹åº”ç”¨** | `å¤šå±‚è´Ÿè½½å‡è¡¡` | `å‰ç«¯Nginxï¼Œåç«¯HAProxy` |
| ğŸ”’ **å®‰å…¨è¦æ±‚é«˜** | `HAProxy SSLç»ˆç»“` | `è¯ä¹¦ç®¡ç†é›†ä¸­ï¼Œå®‰å…¨é…ç½®ä¸°å¯Œ` |

**ğŸ¯ éƒ¨ç½²æœ€ä½³å®è·µ**ï¼š
1. **è§„åˆ’å…ˆè¡Œ**ï¼šç¡®å®šVIPåœ°å€å’Œç«¯å£åˆ†é…
2. **é€æ­¥éƒ¨ç½²**ï¼šå…ˆéƒ¨ç½²å•å°ï¼Œæµ‹è¯•æ— è¯¯åæ‰©å±•
3. **ç›‘æ§å‘Šè­¦**ï¼šé…ç½®æ—¥å¿—å’Œç›‘æ§ç³»ç»Ÿ
4. **å®šæœŸæ¼”ç»ƒ**ï¼šå®šæœŸè¿›è¡Œæ•…éšœè½¬ç§»æµ‹è¯•
5. **æ–‡æ¡£ç»´æŠ¤**ï¼šè®°å½•é…ç½®å’Œæ“ä½œæ­¥éª¤

**ğŸ”§ æ•…éšœæ’æŸ¥æ€è·¯**ï¼š
```
è¿æ¥é—®é¢˜æ’æŸ¥é¡ºåºï¼š
1. æ£€æŸ¥VIPæ˜¯å¦æ­£ç¡®ç»‘å®š
2. æ£€æŸ¥è´Ÿè½½å‡è¡¡å™¨æœåŠ¡çŠ¶æ€
3. æ£€æŸ¥åç«¯æœåŠ¡å™¨å¥åº·çŠ¶æ€
4. æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
5. æ£€æŸ¥é˜²ç«å¢™å’Œå®‰å…¨ç»„è®¾ç½®
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- è´Ÿè½½å‡è¡¡æ˜¯é«˜å¯ç”¨RabbitMQçš„åŸºç¡€ç»„ä»¶
- HAProxyå’ŒNginxå„æœ‰ä¼˜åŠ¿ï¼Œæ ¹æ®éœ€æ±‚é€‰æ‹©
- Keepalivedç¡®ä¿è´Ÿè½½å‡è¡¡å™¨æœ¬èº«çš„é«˜å¯ç”¨
- å¥åº·æ£€æŸ¥æ˜¯ä¿è¯æœåŠ¡è´¨é‡çš„å…³é”®æœºåˆ¶
- SSLç»ˆç»“å¯ä»¥æå‡æ€§èƒ½å¹¶ç®€åŒ–è¯ä¹¦ç®¡ç†
- é…ç½®å‚æ•°éœ€è¦æ ¹æ®å®é™…ç¯å¢ƒè°ƒä¼˜
- å®šæœŸæµ‹è¯•å’Œç›‘æ§æ˜¯è¿ç»´çš„é‡è¦ç¯èŠ‚