---
title: 2ã€é›†ç¾¤éƒ¨ç½²å®æˆ˜
---
## ğŸ“š ç›®å½•

1. [é›†ç¾¤éƒ¨ç½²åŸºç¡€æ¦‚å¿µ](#1-é›†ç¾¤éƒ¨ç½²åŸºç¡€æ¦‚å¿µ)
2. [æ‰‹åŠ¨é›†ç¾¤æ­å»ºè¯¦è§£](#2-æ‰‹åŠ¨é›†ç¾¤æ­å»ºè¯¦è§£)
3. [è‡ªåŠ¨é›†ç¾¤å‘ç°æœºåˆ¶](#3-è‡ªåŠ¨é›†ç¾¤å‘ç°æœºåˆ¶)
4. [Dockeré›†ç¾¤éƒ¨ç½²å®æˆ˜](#4-Dockeré›†ç¾¤éƒ¨ç½²å®æˆ˜)
5. [Kubernetesé›†ç¾¤éƒ¨ç½²](#5-Kubernetesé›†ç¾¤éƒ¨ç½²)
6. [ç½‘ç»œé…ç½®ä¸é˜²ç«å¢™](#6-ç½‘ç»œé…ç½®ä¸é˜²ç«å¢™)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ—ï¸ é›†ç¾¤éƒ¨ç½²åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯RabbitMQé›†ç¾¤


ğŸ¤” **å…ˆæƒ³æƒ³è¿™ä¸ªåœºæ™¯**ï¼š
å‡å¦‚ä½ å¼€äº†ä¸€å®¶å¿«é€’å…¬å¸ï¼Œåªæœ‰ä¸€ä¸ªè¥ä¸šç‚¹ã€‚å¦‚æœè¿™ä¸ªè¥ä¸šç‚¹å‡ºé—®é¢˜äº†ï¼Œæ•´ä¸ªå…¬å¸å°±æ²¡æ³•è¿è¥äº†ã€‚æ€ä¹ˆåŠï¼Ÿå¾ˆç®€å• - å¼€å¤šä¸ªè¥ä¸šç‚¹ï¼

**RabbitMQé›†ç¾¤å°±æ˜¯è¿™ä¸ªé“ç†**ï¼š
```
å•èŠ‚ç‚¹RabbitMQï¼š           é›†ç¾¤RabbitMQï¼š
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ RabbitMQâ”‚              â”‚RabbitMQ1â”‚â”€â”€â”‚RabbitMQ2â”‚â”€â”€â”‚RabbitMQ3â”‚
    â”‚  èŠ‚ç‚¹   â”‚              â”‚  èŠ‚ç‚¹   â”‚  â”‚  èŠ‚ç‚¹   â”‚  â”‚  èŠ‚ç‚¹   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    å•ç‚¹æ•…éšœé£é™©                    é«˜å¯ç”¨ï¼Œè´Ÿè½½åˆ†æ‘Š
```

ğŸ·ï¸ **é›†ç¾¤** = å¤šä¸ªRabbitMQèŠ‚ç‚¹ååŒå·¥ä½œï¼Œåƒä¸€ä¸ªæ•´ä½“ä¸€æ ·å¯¹å¤–æä¾›æœåŠ¡

### 1.2 é›†ç¾¤çš„æ ¸å¿ƒä»·å€¼


ğŸ’¡ **ä¸ºä»€ä¹ˆè¦ç”¨é›†ç¾¤**ï¼š

**é«˜å¯ç”¨æ€§**ï¼šä¸€ä¸ªèŠ‚ç‚¹æŒ‚äº†ï¼Œå…¶ä»–èŠ‚ç‚¹ç»§ç»­å·¥ä½œ
```
èŠ‚ç‚¹1æ•…éšœ â†’ èŠ‚ç‚¹2ã€3ç»§ç»­æœåŠ¡ â†’ ç”¨æˆ·æ„ŸçŸ¥ä¸åˆ°é—®é¢˜
```

**è´Ÿè½½åˆ†æ‹…**ï¼šå¤šä¸ªèŠ‚ç‚¹åˆ†æ‘Šå·¥ä½œå‹åŠ›
```
1000ä¸ªè¿æ¥ â†’ èŠ‚ç‚¹1:300ä¸ª + èŠ‚ç‚¹2:350ä¸ª + èŠ‚ç‚¹3:350ä¸ª
```

**æ°´å¹³æ‰©å±•**ï¼šä¸šåŠ¡å¢é•¿æ—¶å¯ä»¥åŠ æ›´å¤šèŠ‚ç‚¹
```
ä¸šåŠ¡ç¿»å€ â†’ å†åŠ 2ä¸ªèŠ‚ç‚¹ â†’ å¤„ç†èƒ½åŠ›ç¿»å€
```

### 1.3 é›†ç¾¤çš„å·¥ä½œåŸç†


ğŸ” **æ·±å…¥ç†è§£**ï¼šRabbitMQé›†ç¾¤ä¸æ˜¯ç®€å•çš„"å¤åˆ¶ç²˜è´´"

**å…ƒæ•°æ®å…±äº«**ï¼š
- é˜Ÿåˆ—å®šä¹‰ã€äº¤æ¢å™¨å®šä¹‰ â†’ æ‰€æœ‰èŠ‚ç‚¹éƒ½çŸ¥é“
- å°±åƒå…¬å¸æ‰€æœ‰è¥ä¸šç‚¹éƒ½çŸ¥é“ä¸šåŠ¡è§„åˆ™

**æ¶ˆæ¯å­˜å‚¨**ï¼š
- æ¶ˆæ¯æœ¬èº«åªå­˜åœ¨æŸä¸ªèŠ‚ç‚¹ä¸Š
- å…¶ä»–èŠ‚ç‚¹çŸ¥é“æ¶ˆæ¯åœ¨å“ªé‡Œï¼Œå¯ä»¥ä»£ä¸ºè½¬å‘

```
å®¢æˆ·ç«¯è¿æ¥èŠ‚ç‚¹1 â†’ è¦è®¿é—®èŠ‚ç‚¹2ä¸Šçš„é˜Ÿåˆ— â†’ èŠ‚ç‚¹1å¸®å¿™è½¬å‘
å°±åƒä½ åœ¨Aè¥ä¸šç‚¹åŠäº‹ï¼Œä½†èµ„æ–™åœ¨Bè¥ä¸šç‚¹ï¼ŒAç‚¹å¸®ä½ è”ç³»Bç‚¹
```

---

## 2. ğŸ› ï¸ æ‰‹åŠ¨é›†ç¾¤æ­å»ºè¯¦è§£


### 2.1 å‡†å¤‡å·¥ä½œ


ğŸ“‹ **å‰ç½®æ¡ä»¶**ï¼š

**æœåŠ¡å™¨å‡†å¤‡**ï¼š
- 3å°LinuxæœåŠ¡å™¨ï¼ˆæ¨èCentOS 7+æˆ–Ubuntu 18+ï¼‰
- æ¯å°è‡³å°‘2GBå†…å­˜ï¼ŒåŒæ ¸CPU
- ç½‘ç»œäº’é€šï¼Œé˜²ç«å¢™æ­£ç¡®é…ç½®

**ä¸»æœºè§„åˆ’**ï¼š
```
rabbit-node1: 192.168.1.101
rabbit-node2: 192.168.1.102  
rabbit-node3: 192.168.1.103
```

ğŸ”§ **ç³»ç»Ÿé…ç½®**ï¼š

**1. ä¿®æ”¹ä¸»æœºå**ï¼ˆæ¯å°æœºå™¨ï¼‰ï¼š
```bash
# èŠ‚ç‚¹1
hostnamectl set-hostname rabbit-node1

# èŠ‚ç‚¹2  
hostnamectl set-hostname rabbit-node2

# èŠ‚ç‚¹3
hostnamectl set-hostname rabbit-node3
```

**2. é…ç½®hostsæ–‡ä»¶**ï¼ˆæ¯å°æœºå™¨éƒ½è¦é…ç½®ï¼‰ï¼š
```bash
vim /etc/hosts

# æ·»åŠ ä»¥ä¸‹å†…å®¹
192.168.1.101 rabbit-node1
192.168.1.102 rabbit-node2
192.168.1.103 rabbit-node3
```

ğŸ’­ **ä¸ºä»€ä¹ˆè¦é…ç½®hosts**ï¼šå°±åƒç»™æ¯ä¸ªäººèµ·ä¸ªåå­—ï¼Œæ–¹ä¾¿ç›¸äº’è¯†åˆ«å’Œé€šä¿¡

### 2.2 å®‰è£…RabbitMQ


ğŸ¯ **åœ¨æ¯å°æœºå™¨ä¸Šå®‰è£…**ï¼š

**1. å®‰è£…Erlang**ï¼ˆRabbitMQçš„è¿è¡Œç¯å¢ƒï¼‰ï¼š
```bash
# CentOS
yum install -y erlang

# Ubuntu
apt-get install -y erlang
```

**2. å®‰è£…RabbitMQ**ï¼š
```bash
# CentOS
yum install -y rabbitmq-server

# Ubuntu
apt-get install -y rabbitmq-server
```

**3. å¯åŠ¨æœåŠ¡**ï¼š
```bash
systemctl start rabbitmq-server
systemctl enable rabbitmq-server
```

âœ… **éªŒè¯å®‰è£…**ï¼š
```bash
systemctl status rabbitmq-server
# çœ‹åˆ° "active (running)" å°±è¡¨ç¤ºæˆåŠŸ
```

### 2.3 é›†ç¾¤æ­å»ºæ­¥éª¤


ğŸ”‘ **æ ¸å¿ƒæ¦‚å¿µ**ï¼šErlang Cookie
- å°±åƒå›¢é˜Ÿçš„"æš—å·"ï¼Œåªæœ‰çŸ¥é“æš—å·çš„èŠ‚ç‚¹æ‰èƒ½åŠ å…¥é›†ç¾¤
- æ‰€æœ‰èŠ‚ç‚¹å¿…é¡»ä½¿ç”¨ç›¸åŒçš„cookie

**æ­¥éª¤1ï¼šåŒæ­¥Erlang Cookie**

åœ¨èŠ‚ç‚¹1æŸ¥çœ‹cookieï¼š
```bash
cat /var/lib/rabbitmq/.erlang.cookie
# è¾“å‡ºç±»ä¼¼ï¼šABCDEFGHIJKLMNOP1234567890
```

å¤åˆ¶è¿™ä¸ªcookieåˆ°å…¶ä»–èŠ‚ç‚¹ï¼š
```bash
# åœ¨èŠ‚ç‚¹2å’ŒèŠ‚ç‚¹3ä¸Šæ‰§è¡Œ
echo "ABCDEFGHIJKLMNOP1234567890" > /var/lib/rabbitmq/.erlang.cookie
chown rabbitmq:rabbitmq /var/lib/rabbitmq/.erlang.cookie
chmod 400 /var/lib/rabbitmq/.erlang.cookie
```

**æ­¥éª¤2ï¼šé‡å¯æ‰€æœ‰èŠ‚ç‚¹**ï¼š
```bash
systemctl restart rabbitmq-server
```

**æ­¥éª¤3ï¼šåˆ›å»ºé›†ç¾¤**

åœ¨èŠ‚ç‚¹2ä¸Šæ‰§è¡Œï¼ˆåŠ å…¥èŠ‚ç‚¹1ï¼‰ï¼š
```bash
rabbitmqctl stop_app
rabbitmqctl join_cluster rabbit@rabbit-node1
rabbitmqctl start_app
```

åœ¨èŠ‚ç‚¹3ä¸Šæ‰§è¡Œï¼ˆåŠ å…¥èŠ‚ç‚¹1ï¼‰ï¼š
```bash
rabbitmqctl stop_app
rabbitmqctl join_cluster rabbit@rabbit-node1
rabbitmqctl start_app
```

**æ­¥éª¤4ï¼šéªŒè¯é›†ç¾¤**ï¼š
```bash
rabbitmqctl cluster_status
```

ğŸ‰ **æˆåŠŸæ ‡å¿—**ï¼š
```
Cluster status of node rabbit@rabbit-node1
[{nodes,[{disc,[rabbit@rabbit-node1,rabbit@rabbit-node2,rabbit@rabbit-node3]}]}]
```

### 2.4 é›†ç¾¤ç®¡ç†å¸¸ç”¨å‘½ä»¤


ğŸ“‹ **ç®¡ç†å‘½ä»¤æ¸…å•**ï¼š

| å‘½ä»¤ | ä½œç”¨ | ç¤ºä¾‹ |
|------|------|------|
| `cluster_status` | æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ | `rabbitmqctl cluster_status` |
| `join_cluster` | åŠ å…¥é›†ç¾¤ | `rabbitmqctl join_cluster rabbit@node1` |
| `forget_cluster_node` | ç§»é™¤èŠ‚ç‚¹ | `rabbitmqctl forget_cluster_node rabbit@node2` |
| `force_reset` | å¼ºåˆ¶é‡ç½®èŠ‚ç‚¹ | `rabbitmqctl force_reset` |

ğŸš¨ **é‡è¦æé†’**ï¼š
- ç§»é™¤èŠ‚ç‚¹å‰è¦å…ˆåœæ­¢åº”ç”¨ï¼š`rabbitmqctl stop_app`
- é‡ç½®èŠ‚ç‚¹ä¼šæ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Œæ…ç”¨ï¼

---

## 3. ğŸ¤– è‡ªåŠ¨é›†ç¾¤å‘ç°æœºåˆ¶


### 3.1 ä¸ºä»€ä¹ˆéœ€è¦è‡ªåŠ¨å‘ç°


ğŸ¤” **æ€è€ƒåœºæ™¯**ï¼š
æ‰‹åŠ¨æ­å»ºé›†ç¾¤å°±åƒæ‰‹å·¥ç»„è£…å®¶å…·ï¼Œè™½ç„¶å¯è¡Œä½†å¾ˆéº»çƒ¦ã€‚å¦‚æœæœ‰100å°æœåŠ¡å™¨è¦ç»„é›†ç¾¤ï¼Œæ‰‹åŠ¨ä¸€ä¸ªä¸ªé…ç½®ä¼šç´¯æ­»äººã€‚

**è‡ªåŠ¨å‘ç°çš„ä»·å€¼**ï¼š
- æ–°èŠ‚ç‚¹å¯åŠ¨åè‡ªåŠ¨åŠ å…¥é›†ç¾¤
- æ— éœ€æ‰‹åŠ¨æ‰§è¡Œjoinå‘½ä»¤
- ç‰¹åˆ«é€‚åˆäº‘ç¯å¢ƒå’Œå®¹å™¨åŒ–éƒ¨ç½²

### 3.2 DNSå‘ç°æœºåˆ¶


ğŸ·ï¸ **DNSå‘ç°** = é€šè¿‡DNSè§£ææ‰¾åˆ°é›†ç¾¤ä¸­çš„å…¶ä»–èŠ‚ç‚¹

**å·¥ä½œåŸç†**ï¼š
```
1. é…ç½®ä¸€ä¸ªDNSåŸŸåï¼Œæ¯”å¦‚ï¼šrabbitmq.example.com
2. è¿™ä¸ªåŸŸåè§£æåˆ°æ‰€æœ‰RabbitMQèŠ‚ç‚¹IP
3. æ–°èŠ‚ç‚¹å¯åŠ¨æ—¶æŸ¥è¯¢DNSï¼Œè‡ªåŠ¨å‘ç°å…¶ä»–èŠ‚ç‚¹
```

**é…ç½®ç¤ºä¾‹**ï¼š

åˆ›å»ºé…ç½®æ–‡ä»¶ `/etc/rabbitmq/rabbitmq.conf`ï¼š
```ini
# DNSå‘ç°é…ç½®
cluster_formation.peer_discovery_backend = rabbit_peer_discovery_dns
cluster_formation.dns.hostname = rabbitmq.example.com
cluster_formation.node_cleanup.only_log_warning = true
```

DNSè®°å½•é…ç½®ï¼š
```
rabbitmq.example.com A 192.168.1.101
rabbitmq.example.com A 192.168.1.102  
rabbitmq.example.com A 192.168.1.103
```

### 3.3 Consulå‘ç°æœºåˆ¶


ğŸ·ï¸ **Consul** = ä¸“é—¨åšæœåŠ¡å‘ç°çš„å·¥å…·ï¼Œåƒä¸€ä¸ª"ç”µè¯é»„é¡µ"

**å·¥ä½œæµç¨‹**ï¼š
```
èŠ‚ç‚¹å¯åŠ¨ â†’ å‘Consulæ³¨å†Œè‡ªå·± â†’ æŸ¥è¯¢Consulè·å–å…¶ä»–èŠ‚ç‚¹ â†’ è‡ªåŠ¨ç»„æˆé›†ç¾¤
```

**é…ç½®ç¤ºä¾‹**ï¼š
```ini
cluster_formation.peer_discovery_backend = rabbit_peer_discovery_consul
cluster_formation.consul.host = consul.example.com
cluster_formation.consul.service_name = rabbitmq
```

### 3.4 AWS/äº‘å¹³å°å‘ç°


â˜ï¸ **äº‘ç¯å¢ƒç‰¹è‰²**ï¼šäº‘å¹³å°æä¾›æ ‡ç­¾å’ŒAPIæ¥å‘ç°å®ä¾‹

**AWS EC2å‘ç°é…ç½®**ï¼š
```ini
cluster_formation.peer_discovery_backend = rabbit_peer_discovery_aws
cluster_formation.aws.region = us-west-2
cluster_formation.aws.use_autoscaling_group = true
```

**å·¥ä½œåŸç†**ï¼š
- æŸ¥è¯¢åŒä¸€ä¸ªAuto Scaling Groupä¸­çš„å®ä¾‹
- æ ¹æ®æ ‡ç­¾ç­›é€‰RabbitMQå®ä¾‹
- è‡ªåŠ¨ç»„æˆé›†ç¾¤

---

## 4. ğŸ³ Dockeré›†ç¾¤éƒ¨ç½²å®æˆ˜


### 4.1 Dockeré›†ç¾¤çš„ä¼˜åŠ¿


ğŸ’¡ **ä¸ºä»€ä¹ˆç”¨Dockeréƒ¨ç½²é›†ç¾¤**ï¼š

**ç¯å¢ƒä¸€è‡´æ€§**ï¼šæ¯ä¸ªå®¹å™¨ç¯å¢ƒå®Œå…¨ç›¸åŒï¼Œé¿å…"æˆ‘è¿™é‡Œå¥½å¥½çš„"é—®é¢˜
**å¿«é€Ÿéƒ¨ç½²**ï¼šå‡ åˆ†é’Ÿå°±èƒ½æ­å»ºå¥½é›†ç¾¤
**æ˜“äºç®¡ç†**ï¼šå®¹å™¨çš„å¯åœã€ç›‘æ§éƒ½å¾ˆæ–¹ä¾¿

### 4.2 Docker Composeé›†ç¾¤éƒ¨ç½²


ğŸ› ï¸ **å®æˆ˜éƒ¨ç½²**ï¼š

åˆ›å»º `docker-compose.yml` æ–‡ä»¶ï¼š
```yaml
version: '3.8'

services:
  rabbitmq1:
    image: rabbitmq:3.11-management
    hostname: rabbitmq1
    environment:
      RABBITMQ_ERLANG_COOKIE: "mycookie123456"
      RABBITMQ_DEFAULT_USER: "admin"
      RABBITMQ_DEFAULT_PASS: "admin123"
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq1_data:/var/lib/rabbitmq
    networks:
      - rabbitmq-cluster

  rabbitmq2:
    image: rabbitmq:3.11-management
    hostname: rabbitmq2
    environment:
      RABBITMQ_ERLANG_COOKIE: "mycookie123456"
    volumes:
      - rabbitmq2_data:/var/lib/rabbitmq
    networks:
      - rabbitmq-cluster
    depends_on:
      - rabbitmq1

  rabbitmq3:
    image: rabbitmq:3.11-management
    hostname: rabbitmq3
    environment:
      RABBITMQ_ERLANG_COOKIE: "mycookie123456"
    volumes:
      - rabbitmq3_data:/var/lib/rabbitmq
    networks:
      - rabbitmq-cluster
    depends_on:
      - rabbitmq1

volumes:
  rabbitmq1_data:
  rabbitmq2_data:
  rabbitmq3_data:

networks:
  rabbitmq-cluster:
    driver: bridge
```

**å¯åŠ¨é›†ç¾¤**ï¼š
```bash
docker-compose up -d
```

**æ‰‹åŠ¨ç»„å»ºé›†ç¾¤**ï¼š
```bash
# èŠ‚ç‚¹2åŠ å…¥é›†ç¾¤
docker exec rabbitmq2 rabbitmqctl stop_app
docker exec rabbitmq2 rabbitmqctl join_cluster rabbit@rabbitmq1
docker exec rabbitmq2 rabbitmqctl start_app

# èŠ‚ç‚¹3åŠ å…¥é›†ç¾¤
docker exec rabbitmq3 rabbitmqctl stop_app
docker exec rabbitmq3 rabbitmqctl join_cluster rabbit@rabbitmq1
docker exec rabbitmq3 rabbitmqctl start_app
```

### 4.3 ä½¿ç”¨è‡ªåŠ¨å‘ç°çš„Dockeré›†ç¾¤


ğŸ¤– **æ›´æ™ºèƒ½çš„æ–¹å¼**ï¼š

ä¿®æ”¹ `docker-compose.yml`ï¼Œæ·»åŠ è‡ªåŠ¨å‘ç°é…ç½®ï¼š
```yaml
services:
  rabbitmq1:
    image: rabbitmq:3.11-management
    hostname: rabbitmq1
    environment:
      RABBITMQ_ERLANG_COOKIE: "mycookie123456"
      RABBITMQ_DEFAULT_USER: "admin"
      RABBITMQ_DEFAULT_PASS: "admin123"
    volumes:
      - ./rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - rabbitmq-cluster

  # å…¶ä»–èŠ‚ç‚¹é…ç½®ç±»ä¼¼...
```

åˆ›å»º `rabbitmq.conf` æ–‡ä»¶ï¼š
```ini
# é›†ç¾¤é…ç½®
cluster_formation.peer_discovery_backend = rabbit_peer_discovery_classic_config
cluster_formation.classic_config.nodes.1 = rabbit@rabbitmq1
cluster_formation.classic_config.nodes.2 = rabbit@rabbitmq2
cluster_formation.classic_config.nodes.3 = rabbit@rabbitmq3

# è‡ªåŠ¨åŠ å…¥é›†ç¾¤
cluster_formation.randomized_startup_delay_range.min = 0
cluster_formation.randomized_startup_delay_range.max = 2
```

---

## 5. â˜¸ï¸ Kubernetesé›†ç¾¤éƒ¨ç½²


### 5.1 K8séƒ¨ç½²çš„ä¼˜åŠ¿


ğŸ¯ **Kubernetesçš„ç‰¹è‰²**ï¼š

**è‡ªåŠ¨åŒ–ç®¡ç†**ï¼šPodè‡ªåŠ¨è°ƒåº¦ã€æ•…éšœè‡ªæ„ˆ
**æœåŠ¡å‘ç°**ï¼šå†…ç½®DNSæœåŠ¡å‘ç°
**è´Ÿè½½å‡è¡¡**ï¼šServiceè‡ªåŠ¨åˆ†å‘æµé‡
**æ»šåŠ¨æ›´æ–°**ï¼šä¸åœæœºå‡çº§

### 5.2 StatefulSetéƒ¨ç½²æ–¹æ¡ˆ


ğŸ·ï¸ **StatefulSet** = Kubernetesä¸­ä¸“é—¨ç®¡ç†æœ‰çŠ¶æ€åº”ç”¨çš„æ§åˆ¶å™¨

**ä¸ºä»€ä¹ˆç”¨StatefulSet**ï¼š
- RabbitMQèŠ‚ç‚¹éœ€è¦å›ºå®šçš„ç½‘ç»œæ ‡è¯†
- éœ€è¦æŒä¹…åŒ–å­˜å‚¨
- å¯åŠ¨é¡ºåºå¾ˆé‡è¦

**éƒ¨ç½²é…ç½®**ï¼š

åˆ›å»º `rabbitmq-statefulset.yaml`ï¼š
```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: rabbitmq
spec:
  serviceName: rabbitmq
  replicas: 3
  selector:
    matchLabels:
      app: rabbitmq
  template:
    metadata:
      labels:
        app: rabbitmq
    spec:
      containers:
      - name: rabbitmq
        image: rabbitmq:3.11-management
        env:
        - name: RABBITMQ_ERLANG_COOKIE
          value: "mycookie123456"
        - name: RABBITMQ_DEFAULT_USER
          value: "admin"
        - name: RABBITMQ_DEFAULT_PASS
          value: "admin123"
        ports:
        - containerPort: 5672
        - containerPort: 15672
        volumeMounts:
        - name: rabbitmq-data
          mountPath: /var/lib/rabbitmq
        - name: rabbitmq-config
          mountPath: /etc/rabbitmq
      volumes:
      - name: rabbitmq-config
        configMap:
          name: rabbitmq-config
  volumeClaimTemplates:
  - metadata:
      name: rabbitmq-data
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 10Gi
```

**åˆ›å»ºé…ç½®æ–‡ä»¶**ï¼š
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: rabbitmq-config
data:
  rabbitmq.conf: |
    cluster_formation.peer_discovery_backend = rabbit_peer_discovery_k8s
    cluster_formation.k8s.host = kubernetes.default
    cluster_formation.k8s.address_type = hostname
    cluster_formation.k8s.service_name = rabbitmq
    cluster_formation.node_cleanup.interval = 10
    cluster_formation.node_cleanup.only_log_warning = true
```

**éƒ¨ç½²å‘½ä»¤**ï¼š
```bash
kubectl apply -f rabbitmq-statefulset.yaml
```

### 5.3 ç›‘æ§å’Œç®¡ç†


ğŸ“Š **é›†ç¾¤çŠ¶æ€æ£€æŸ¥**ï¼š

```bash
# æŸ¥çœ‹PodçŠ¶æ€
kubectl get pods -l app=rabbitmq

# æŸ¥çœ‹é›†ç¾¤çŠ¶æ€
kubectl exec rabbitmq-0 -- rabbitmqctl cluster_status

# è®¿é—®ç®¡ç†ç•Œé¢
kubectl port-forward service/rabbitmq 15672:15672
```

---

## 6. ğŸŒ ç½‘ç»œé…ç½®ä¸é˜²ç«å¢™


### 6.1 RabbitMQç«¯å£è¯¦è§£


ğŸ“‹ **é‡è¦ç«¯å£æ¸…å•**ï¼š

| ç«¯å£ | ç”¨é€” | å¿…é¡»å¼€æ”¾ |
|------|------|----------|
| **5672** | AMQPåè®®ç«¯å£ | âœ… å®¢æˆ·ç«¯è¿æ¥ |
| **15672** | Webç®¡ç†ç•Œé¢ | âœ… ç®¡ç†éœ€è¦ |
| **25672** | é›†ç¾¤é€šä¿¡ç«¯å£ | âœ… èŠ‚ç‚¹é—´é€šä¿¡ |
| **4369** | Erlangç«¯å£æ˜ å°„ | âœ… é›†ç¾¤å¿…éœ€ |
| **35672-35682** | CLIå·¥å…·ç«¯å£èŒƒå›´ | âš ï¸ ç®¡ç†å·¥å…· |

ğŸ” **æ·±å…¥ç†è§£**ï¼š

**5672ç«¯å£**ï¼šåº”ç”¨ç¨‹åºè¿æ¥RabbitMQçš„"å¤§é—¨"
**25672ç«¯å£**ï¼šé›†ç¾¤èŠ‚ç‚¹é—´çš„"å†…éƒ¨ç”µè¯çº¿"  
**4369ç«¯å£**ï¼šErlangçš„"ç”µè¯æ€»æœº"ï¼Œå¸®åŠ©æ‰¾åˆ°å…¶ä»–èŠ‚ç‚¹

### 6.2 é˜²ç«å¢™é…ç½®


ğŸ›¡ï¸ **CentOS/RHELé˜²ç«å¢™é…ç½®**ï¼š

```bash
# å¼€æ”¾RabbitMQç›¸å…³ç«¯å£
firewall-cmd --permanent --add-port=5672/tcp
firewall-cmd --permanent --add-port=15672/tcp
firewall-cmd --permanent --add-port=25672/tcp
firewall-cmd --permanent --add-port=4369/tcp
firewall-cmd --permanent --add-port=35672-35682/tcp

# é‡æ–°åŠ è½½é˜²ç«å¢™
firewall-cmd --reload

# éªŒè¯é…ç½®
firewall-cmd --list-ports
```

**Ubuntué˜²ç«å¢™é…ç½®**ï¼š
```bash
# å¼€æ”¾ç«¯å£
ufw allow 5672/tcp
ufw allow 15672/tcp
ufw allow 25672/tcp
ufw allow 4369/tcp
ufw allow 35672:35682/tcp

# é‡æ–°åŠ è½½
ufw reload
```

### 6.3 ç½‘ç»œæ•…éšœæ’æŸ¥


ğŸ”§ **å¸¸è§é—®é¢˜è¯Šæ–­**ï¼š

**1. èŠ‚ç‚¹æ— æ³•åŠ å…¥é›†ç¾¤**ï¼š

æ£€æŸ¥ç½‘ç»œè¿é€šæ€§ï¼š
```bash
# æµ‹è¯•ç«¯å£è¿é€šæ€§
telnet rabbit-node1 25672

# æµ‹è¯•Erlangè¿æ¥
erl -name test@$(hostname) -setcookie mycookie123456 -eval "net_adm:ping('rabbit@rabbit-node1')."
```

**2. é›†ç¾¤åˆ†è£‚ï¼ˆSplit Brainï¼‰**ï¼š

æ£€æŸ¥ç½‘ç»œåˆ†åŒºï¼š
```bash
rabbitmqctl cluster_status
# æŸ¥çœ‹æ˜¯å¦æœ‰ç½‘ç»œåˆ†åŒºä¿¡æ¯
```

ä¿®å¤åˆ†åŒºï¼š
```bash
# é‡å¯åˆ†åŒºèŠ‚ç‚¹
rabbitmqctl stop_app
rabbitmqctl start_app
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 éƒ¨ç½²æ–¹å¼å¯¹æ¯”


| éƒ¨ç½²æ–¹å¼ | **é€‚ç”¨åœºæ™¯** | **ä¼˜åŠ¿** | **åŠ£åŠ¿** |
|---------|-------------|----------|----------|
| **æ‰‹åŠ¨éƒ¨ç½²** | ä¼ ç»Ÿç‰©ç†æœº/è™šæ‹Ÿæœº | å®Œå…¨æ§åˆ¶ï¼Œç¨³å®šå¯é  | éƒ¨ç½²å¤æ‚ï¼Œæ‰©å±•å›°éš¾ |
| **Docker** | å¼€å‘æµ‹è¯•ç¯å¢ƒ | å¿«é€Ÿéƒ¨ç½²ï¼Œç¯å¢ƒä¸€è‡´ | ç”Ÿäº§ç¯å¢ƒéœ€è€ƒè™‘æŒä¹…åŒ– |
| **Kubernetes** | äº‘åŸç”Ÿç”Ÿäº§ç¯å¢ƒ | è‡ªåŠ¨åŒ–ç®¡ç†ï¼Œå¼¹æ€§æ‰©å±• | å­¦ä¹ æˆæœ¬é«˜ï¼Œå¤æ‚åº¦å¤§ |

### 7.2 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒçŸ¥è¯†


ğŸ”‘ **å…³é”®æ¦‚å¿µ**ï¼š
- **Erlang Cookie**ï¼šé›†ç¾¤èŠ‚ç‚¹çš„"èº«ä»½è¯"ï¼Œå¿…é¡»ç›¸åŒ
- **é›†ç¾¤å‘ç°**ï¼šæ‰‹åŠ¨vsè‡ªåŠ¨ï¼Œæ ¹æ®ç¯å¢ƒé€‰æ‹©
- **ç½‘ç»œç«¯å£**ï¼š5672/15672/25672/4369ï¼Œç¼ºä¸€ä¸å¯
- **èŠ‚ç‚¹ç±»å‹**ï¼šç£ç›˜èŠ‚ç‚¹vså†…å­˜èŠ‚ç‚¹ï¼Œå½±å“æ•°æ®æŒä¹…åŒ–

ğŸ¯ **æœ€ä½³å®è·µ**ï¼š
- ç”Ÿäº§ç¯å¢ƒè‡³å°‘3ä¸ªèŠ‚ç‚¹ï¼ˆå¥‡æ•°ä¸ªï¼Œé¿å…è„‘è£‚ï¼‰
- ä½¿ç”¨è‡ªåŠ¨å‘ç°æœºåˆ¶ï¼Œå‡å°‘è¿ç»´å¤æ‚åº¦
- ç›‘æ§é›†ç¾¤çŠ¶æ€ï¼ŒåŠæ—¶å‘ç°å’Œå¤„ç†é—®é¢˜
- å®šæœŸå¤‡ä»½é›†ç¾¤é…ç½®å’Œé‡è¦æ•°æ®

ğŸ’¡ **æ–°æ‰‹é¿å‘æŒ‡å—**ï¼š
- Cookieä¸ä¸€è‡´ â†’ èŠ‚ç‚¹æ— æ³•åŠ å…¥é›†ç¾¤
- é˜²ç«å¢™æœªå¼€æ”¾ç«¯å£ â†’ è¿æ¥å¤±è´¥
- ä¸»æœºåè§£æé”™è¯¯ â†’ é›†ç¾¤é€šä¿¡å¼‚å¸¸
- æ—¶é—´ä¸åŒæ­¥ â†’ å¯èƒ½å¯¼è‡´å¥‡æ€ªé—®é¢˜

### 7.3 æ•…éšœæ’æŸ¥æ€è·¯


ğŸ” **é—®é¢˜è¯Šæ–­æ­¥éª¤**ï¼š

1. **åŸºç¡€æ£€æŸ¥**ï¼šæœåŠ¡æ˜¯å¦å¯åŠ¨ï¼Ÿç«¯å£æ˜¯å¦ç›‘å¬ï¼Ÿ
2. **ç½‘ç»œæ£€æŸ¥**ï¼šèŠ‚ç‚¹é—´æ˜¯å¦èƒ½pingé€šï¼Ÿç«¯å£æ˜¯å¦å¼€æ”¾ï¼Ÿ
3. **é…ç½®æ£€æŸ¥**ï¼šCookieæ˜¯å¦ä¸€è‡´ï¼Ÿé…ç½®æ–‡ä»¶æ˜¯å¦æ­£ç¡®ï¼Ÿ
4. **æ—¥å¿—æŸ¥çœ‹**ï¼šç³»ç»Ÿæ—¥å¿—å’ŒRabbitMQæ—¥å¿—æœ‰ä»€ä¹ˆå¼‚å¸¸ï¼Ÿ

**å¸¸ç”¨è¯Šæ–­å‘½ä»¤**ï¼š
```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
systemctl status rabbitmq-server

# æ£€æŸ¥ç«¯å£ç›‘å¬
netstat -tulpn | grep beam

# æŸ¥çœ‹é›†ç¾¤çŠ¶æ€
rabbitmqctl cluster_status

# æŸ¥çœ‹æ—¥å¿—
tail -f /var/log/rabbitmq/rabbit@hostname.log
```

ğŸ“ **å­¦ä¹ å»ºè®®**ï¼š
- å…ˆä»å•èŠ‚ç‚¹ç†Ÿæ‚‰ï¼Œå†å°è¯•é›†ç¾¤
- åœ¨è™šæ‹Ÿæœºç¯å¢ƒå¤šç»ƒä¹ ï¼Œç†Ÿæ‚‰å„ç§éƒ¨ç½²æ–¹å¼
- é‡ç‚¹ç†è§£é›†ç¾¤çš„å·¥ä½œåŸç†ï¼Œè€Œä¸æ˜¯æ­»è®°å‘½ä»¤
- å¤šçœ‹æ—¥å¿—ï¼ŒåŸ¹å…»æ•…éšœè¯Šæ–­èƒ½åŠ›

**è®°ä½**ï¼šé›†ç¾¤éƒ¨ç½²çœ‹èµ·æ¥å¤æ‚ï¼Œä½†æŒæ¡æ ¸å¿ƒåŸç†åå°±æ˜¯é‡å¤çš„æ“ä½œã€‚å¤šç»ƒä¹ ï¼Œå¤šæ€è€ƒï¼Œå¾ˆå¿«å°±èƒ½ç†Ÿç»ƒæŒæ¡ï¼