---
title: 6ã€æ­»ä¿¡é˜Ÿåˆ—DLX
---
## ğŸ“š ç›®å½•

1. [æ­»ä¿¡é˜Ÿåˆ—åŸºæœ¬æ¦‚å¿µ](#1-æ­»ä¿¡é˜Ÿåˆ—åŸºæœ¬æ¦‚å¿µ)
2. [æ­»ä¿¡äº§ç”Ÿçš„ä¸‰ç§æ¡ä»¶](#2-æ­»ä¿¡äº§ç”Ÿçš„ä¸‰ç§æ¡ä»¶)
3. [æ­»ä¿¡äº¤æ¢æœºDLXé…ç½®è¯¦è§£](#3-æ­»ä¿¡äº¤æ¢æœºDLXé…ç½®è¯¦è§£)
4. [æ­»ä¿¡è·¯ç”±é”®é…ç½®ç­–ç•¥](#4-æ­»ä¿¡è·¯ç”±é”®é…ç½®ç­–ç•¥)
5. [æ¶ˆæ¯é‡è¯•æœºåˆ¶è®¾è®¡](#5-æ¶ˆæ¯é‡è¯•æœºåˆ¶è®¾è®¡)
6. [å¼‚å¸¸æ¶ˆæ¯å¤„ç†æœ€ä½³å®è·µ](#6-å¼‚å¸¸æ¶ˆæ¯å¤„ç†æœ€ä½³å®è·µ)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ’€ æ­»ä¿¡é˜Ÿåˆ—åŸºæœ¬æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯æ­»ä¿¡é˜Ÿåˆ—


**ğŸ”¸ æ ¸å¿ƒå®šä¹‰**
æ­»ä¿¡é˜Ÿåˆ—ï¼ˆDead Letter Queueï¼Œç®€ç§°DLQï¼‰å°±åƒæ˜¯æ¶ˆæ¯çš„"åƒåœ¾å›æ”¶ç«™"ã€‚å½“æ¶ˆæ¯åœ¨æ­£å¸¸é˜Ÿåˆ—ä¸­æ— æ³•è¢«æ­£å¸¸å¤„ç†æ—¶ï¼Œå®ƒä»¬ä¸ä¼šæ¶ˆå¤±ï¼Œè€Œæ˜¯è¢«è½¬å‘åˆ°ç‰¹æ®Šçš„æ­»ä¿¡é˜Ÿåˆ—ä¸­è¿›è¡Œåç»­å¤„ç†ã€‚

```
ğŸ  ç”Ÿæ´»ç±»æ¯”
å°±åƒæˆ‘ä»¬å¯„å¿«é€’ï¼š
- æ­£å¸¸æƒ…å†µï¼šå¿«é€’ â†’ æ”¶ä»¶äººç­¾æ”¶ âœ…
- å¼‚å¸¸æƒ…å†µï¼šå¿«é€’ â†’ æ— äººç­¾æ”¶ â†’ é€€å›å‘ä»¶äºº ğŸ“¦

æ­»ä¿¡é˜Ÿåˆ—å°±æ˜¯RabbitMQçš„"é€€ä»¶å¤„ç†ä¸­å¿ƒ"
```

**ğŸ”¸ æ­»ä¿¡é˜Ÿåˆ—çš„ä½œç”¨**
```
é—®é¢˜è§£å†³ï¼š
âœ… é˜²æ­¢æ¶ˆæ¯ä¸¢å¤±ï¼šå¼‚å¸¸æ¶ˆæ¯æœ‰åœ°æ–¹å­˜æ”¾
âœ… ä¾¿äºæ’æŸ¥é—®é¢˜ï¼šå¯ä»¥æŸ¥çœ‹å¤±è´¥æ¶ˆæ¯çš„è¯¦æƒ…
âœ… æ”¯æŒé‡æ–°å¤„ç†ï¼šå¯ä»¥é‡æ–°æŠ•é€’æ­»ä¿¡æ¶ˆæ¯
âœ… ç³»ç»Ÿç¨³å®šæ€§ï¼šé¿å…å¼‚å¸¸æ¶ˆæ¯é˜»å¡æ­£å¸¸æµç¨‹
```

### 1.2 æ­»ä¿¡é˜Ÿåˆ—æ¶æ„å›¾


```
æ­£å¸¸æ¶ˆæ¯æµç¨‹ï¼š
ç”Ÿäº§è€… â†’ äº¤æ¢æœº â†’ æ­£å¸¸é˜Ÿåˆ— â†’ æ¶ˆè´¹è€…å¤„ç†æˆåŠŸ âœ…

æ­»ä¿¡æ¶ˆæ¯æµç¨‹ï¼š
ç”Ÿäº§è€… â†’ äº¤æ¢æœº â†’ æ­£å¸¸é˜Ÿåˆ— â†’ æ¶ˆè´¹è€…å¤„ç†å¤±è´¥ âŒ
                    â†“
                æ­»ä¿¡äº¤æ¢æœº(DLX) â†’ æ­»ä¿¡é˜Ÿåˆ— â†’ äººå·¥å¤„ç†

æ¶æ„ç¤ºæ„å›¾ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Producer  â”‚â”€â”€â”€â†’â”‚   Exchange  â”‚â”€â”€â”€â†’â”‚ Normal Queueâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚ âŒ å¤„ç†å¤±è´¥
                                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Dead Letter â”‚â†â”€â”€â”€â”‚  DL Exchangeâ”‚â†â”€â”€â”€â”‚  Failed Msg â”‚
â”‚    Queue    â”‚    â”‚    (DLX)    â”‚    â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 ä¸ºä»€ä¹ˆéœ€è¦æ­»ä¿¡é˜Ÿåˆ—


**ğŸ¤” æ²¡æœ‰æ­»ä¿¡é˜Ÿåˆ—çš„é—®é¢˜**
```
é—®é¢˜åœºæ™¯ï¼š
âŒ æ¶ˆæ¯å¤„ç†å¤±è´¥åç›´æ¥ä¸¢å¤±
âŒ æ— æ³•çŸ¥é“å“ªäº›æ¶ˆæ¯å‡ºäº†é—®é¢˜  
âŒ æ— æ³•è¿›è¡Œé—®é¢˜æ’æŸ¥å’Œä¿®å¤
âŒ ç³»ç»Ÿå¼‚å¸¸æ—¶æ¶ˆæ¯ç§¯å‹é˜»å¡
```

**âœ… æœ‰äº†æ­»ä¿¡é˜Ÿåˆ—çš„å¥½å¤„**
```
è§£å†³æ–¹æ¡ˆï¼š
ğŸ”¸ å¼‚å¸¸æ¶ˆæ¯ç»Ÿä¸€æ”¶é›†ï¼šæ‰€æœ‰å¤±è´¥æ¶ˆæ¯éƒ½æœ‰å»å¤„
ğŸ”¸ ä¾¿äºé—®é¢˜è¯Šæ–­ï¼šå¯ä»¥æŸ¥çœ‹å¤±è´¥åŸå› å’Œæ¶ˆæ¯å†…å®¹
ğŸ”¸ æ”¯æŒæ¶ˆæ¯é‡è¯•ï¼šä¿®å¤é—®é¢˜åå¯ä»¥é‡æ–°å¤„ç†
ğŸ”¸ ç³»ç»Ÿç›‘æ§å‘Šè­¦ï¼šå¯ä»¥ç›‘æ§æ­»ä¿¡é˜Ÿåˆ—é•¿åº¦
```

---

## 2. âš ï¸ æ­»ä¿¡äº§ç”Ÿçš„ä¸‰ç§æ¡ä»¶


æ­»ä¿¡ä¸æ˜¯éšä¾¿äº§ç”Ÿçš„ï¼Œå¿…é¡»æ»¡è¶³ç‰¹å®šæ¡ä»¶ã€‚å°±åƒå­¦ç”Ÿè¢«"ç•™çº§"éœ€è¦æ»¡è¶³ä¸€å®šæ¡ä»¶ä¸€æ ·ã€‚

### 2.1 æ¡ä»¶ä¸€ï¼šæ¶ˆæ¯è¢«æ‹’ç»ä¸”ä¸é‡æ–°å…¥é˜Ÿ


**ğŸ”¸ ä»€ä¹ˆæƒ…å†µä¸‹ä¼šè¢«æ‹’ç»**
```
æ¶ˆè´¹è€…æ‹’ç»æ¶ˆæ¯çš„ä¸¤ç§æ–¹å¼ï¼š

æ–¹å¼1ï¼šbasic.reject
channel.basicReject(deliveryTag, false); // falseè¡¨ç¤ºä¸é‡æ–°å…¥é˜Ÿ

æ–¹å¼2ï¼šbasic.nack  
channel.basicNack(deliveryTag, false, false); // æœ€åä¸€ä¸ªfalseè¡¨ç¤ºä¸é‡æ–°å…¥é˜Ÿ
```

**ğŸ’¡ é€šä¿—ç†è§£**
å°±åƒå¿«é€’å‘˜é€è´§ï¼š
- æ”¶ä»¶äººæ‹’æ”¶ä¸”ä¸è¦æ±‚é‡æ–°æŠ•é€’ â†’ å¿«é€’å˜æˆæ­»ä¿¡
- æ”¶ä»¶äººæ‹’æ”¶ä½†è¦æ±‚é‡æ–°æŠ•é€’ â†’ å¿«é€’é‡æ–°æ’é˜Ÿ

**ğŸ“ ä»£ç ç¤ºä¾‹**
```java
// æ¶ˆè´¹è€…å¤„ç†æ¶ˆæ¯
@RabbitListener(queues = "normal.queue")
public void handleMessage(String message, Channel channel, 
                         @Header(AmqpHeaders.DELIVERY_TAG) long deliveryTag) {
    try {
        // ä¸šåŠ¡å¤„ç†
        processMessage(message);
        // å¤„ç†æˆåŠŸï¼Œç¡®è®¤æ¶ˆæ¯
        channel.basicAck(deliveryTag, false);
        
    } catch (BusinessException e) {
        // ä¸šåŠ¡å¼‚å¸¸ï¼Œæ‹’ç»æ¶ˆæ¯ä¸”ä¸é‡æ–°å…¥é˜Ÿ â†’ å˜æˆæ­»ä¿¡
        channel.basicReject(deliveryTag, false);
        
    } catch (Exception e) {
        // ç³»ç»Ÿå¼‚å¸¸ï¼Œæ‹’ç»æ¶ˆæ¯ä½†é‡æ–°å…¥é˜Ÿ â†’ é‡æ–°å¤„ç†
        channel.basicReject(deliveryTag, true);
    }
}
```

### 2.2 æ¡ä»¶äºŒï¼šæ¶ˆæ¯TTLè¿‡æœŸ


**ğŸ”¸ TTLæ˜¯ä»€ä¹ˆ**
TTLï¼ˆTime To Liveï¼‰å°±æ˜¯æ¶ˆæ¯çš„"ä¿è´¨æœŸ"ã€‚å°±åƒé£Ÿå“è¿‡æœŸåä¸èƒ½åƒä¸€æ ·ï¼Œæ¶ˆæ¯è¿‡æœŸåä¹Ÿä¼šå˜æˆæ­»ä¿¡ã€‚

**ğŸ”¸ TTLçš„ä¸¤ç§è®¾ç½®æ–¹å¼**

| è®¾ç½®æ–¹å¼ | ä½œç”¨èŒƒå›´ | ä¼˜å…ˆçº§ | ä½¿ç”¨åœºæ™¯ |
|---------|---------|--------|----------|
| **é˜Ÿåˆ—TTL** | æ•´ä¸ªé˜Ÿåˆ—çš„æ‰€æœ‰æ¶ˆæ¯ | ä½ | ç»Ÿä¸€çš„è¿‡æœŸç­–ç•¥ |
| **æ¶ˆæ¯TTL** | å•ä¸ªæ¶ˆæ¯ | é«˜ | ä¸ªæ€§åŒ–çš„è¿‡æœŸæ—¶é—´ |

**ğŸ“ é˜Ÿåˆ—TTLé…ç½®ç¤ºä¾‹**
```java
// åˆ›å»ºé˜Ÿåˆ—æ—¶è®¾ç½®TTL
@Bean
public Queue normalQueue() {
    return QueueBuilder.durable("normal.queue")
            .ttl(30000)  // 30ç§’åè¿‡æœŸ
            .deadLetterExchange("dlx.exchange")  // æŒ‡å®šæ­»ä¿¡äº¤æ¢æœº
            .build();
}
```

**ğŸ“ æ¶ˆæ¯TTLé…ç½®ç¤ºä¾‹**
```java
// å‘é€æ¶ˆæ¯æ—¶è®¾ç½®TTL
@Autowired
private RabbitTemplate rabbitTemplate;

public void sendMessageWithTTL(String message) {
    MessageProperties properties = new MessageProperties();
    properties.setExpiration("10000");  // 10ç§’åè¿‡æœŸ
    
    Message msg = new Message(message.getBytes(), properties);
    rabbitTemplate.send("normal.exchange", "normal.key", msg);
}
```

### 2.3 æ¡ä»¶ä¸‰ï¼šé˜Ÿåˆ—é•¿åº¦è¶…è¿‡æœ€å¤§é™åˆ¶


**ğŸ”¸ ä»€ä¹ˆæ˜¯é˜Ÿåˆ—é•¿åº¦é™åˆ¶**
å°±åƒåœè½¦åœºæœ‰åœè½¦ä½é™åˆ¶ä¸€æ ·ï¼Œé˜Ÿåˆ—ä¹Ÿå¯ä»¥è®¾ç½®æœ€å¤§æ¶ˆæ¯æ•°é‡ã€‚å½“æ–°æ¶ˆæ¯è¿›æ¥æ—¶ï¼Œå¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œæœ€è€çš„æ¶ˆæ¯å°±ä¼šè¢«æŒ¤å‡ºå»å˜æˆæ­»ä¿¡ã€‚

**ğŸ”¸ é˜Ÿåˆ—é•¿åº¦çš„ä¸¤ç§é™åˆ¶æ–¹å¼**

```
é™åˆ¶ç±»å‹ï¼š
ğŸ”¸ æœ€å¤§æ¶ˆæ¯æ•°é‡ï¼ˆmax-lengthï¼‰ï¼šé™åˆ¶æ¶ˆæ¯ä¸ªæ•°
ğŸ”¸ æœ€å¤§é˜Ÿåˆ—å¤§å°ï¼ˆmax-length-bytesï¼‰ï¼šé™åˆ¶æ€»å­—èŠ‚æ•°

æŒ¤å‡ºç­–ç•¥ï¼š
ğŸ“¤ é˜Ÿåˆ—å¤´éƒ¨æ¶ˆæ¯è¢«æŒ¤å‡ºï¼ˆFIFOåŸåˆ™ï¼‰
ğŸ“¥ æ–°æ¶ˆæ¯ä»é˜Ÿåˆ—å°¾éƒ¨è¿›å…¥
```

**ğŸ“ é…ç½®ç¤ºä¾‹**
```java
@Bean
public Queue limitedQueue() {
    return QueueBuilder.durable("limited.queue")
            .maxLength(1000)          // æœ€å¤š1000æ¡æ¶ˆæ¯
            .maxLengthBytes(1048576)  // æœ€å¤š1MBæ•°æ®
            .deadLetterExchange("dlx.exchange")
            .build();
}
```

**ğŸ  ç”Ÿæ´»ç±»æ¯”**
```
åœè½¦åœºç±»æ¯”ï¼š
ğŸš— åœè½¦åœºæœ€å¤šåœ100è¾†è½¦ï¼ˆmax-length=100ï¼‰
ğŸš— æ–°è½¦è¿›æ¥æ—¶ï¼Œå¦‚æœåœè½¦åœºæ»¡äº†
ğŸš— æœ€æ—©åœçš„é‚£è¾†è½¦è¢«"è¯·å‡ºå»"ï¼ˆå˜æˆæ­»ä¿¡ï¼‰
ğŸš— æ–°è½¦åœåœ¨ç©ºå‡ºæ¥çš„ä½ç½®
```

---

## 3. ğŸ”„ æ­»ä¿¡äº¤æ¢æœºDLXé…ç½®è¯¦è§£


### 3.1 ä»€ä¹ˆæ˜¯æ­»ä¿¡äº¤æ¢æœºï¼ˆDLXï¼‰


**ğŸ”¸ æ ¸å¿ƒæ¦‚å¿µ**
æ­»ä¿¡äº¤æ¢æœºï¼ˆDead Letter Exchangeï¼ŒDLXï¼‰å°±åƒæ˜¯"å¼‚å¸¸æ¶ˆæ¯çš„ä¸­è½¬ç«™"ã€‚å½“æ¶ˆæ¯å˜æˆæ­»ä¿¡æ—¶ï¼Œå®ƒä»¬ä¸ä¼šç›´æ¥è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—ï¼Œè€Œæ˜¯å…ˆå‘é€åˆ°æ­»ä¿¡äº¤æ¢æœºï¼Œå†ç”±æ­»ä¿¡äº¤æ¢æœºè·¯ç”±åˆ°å…·ä½“çš„æ­»ä¿¡é˜Ÿåˆ—ã€‚

```
æ¶ˆæ¯æµè½¬è·¯å¾„ï¼š
æ­£å¸¸é˜Ÿåˆ— â†’ æ¶ˆæ¯å˜æˆæ­»ä¿¡ â†’ æ­»ä¿¡äº¤æ¢æœº(DLX) â†’ æ­»ä¿¡é˜Ÿåˆ—

ğŸ  ç”Ÿæ´»ç±»æ¯”ï¼š
å°±åƒåŒ»é™¢çš„æ€¥è¯Šç§‘ï¼š
- æ™®é€šç—…äºº â†’ æ™®é€šç§‘å®¤
- æ€¥è¯Šç—…äºº â†’ æ€¥è¯Šç§‘ï¼ˆDLXï¼‰â†’ é‡ç—‡ç›‘æŠ¤å®¤ï¼ˆæ­»ä¿¡é˜Ÿåˆ—ï¼‰
```

### 3.2 é…ç½®æ­»ä¿¡äº¤æ¢æœºçš„ä¸‰ç§æ–¹å¼


#### ğŸ”§ æ–¹å¼ä¸€ï¼šå£°æ˜é˜Ÿåˆ—æ—¶é…ç½®


```java
// åˆ›å»ºæ™®é€šé˜Ÿåˆ—ï¼ŒæŒ‡å®šæ­»ä¿¡äº¤æ¢æœº
@Bean
public Queue normalQueue() {
    return QueueBuilder.durable("order.queue")
            .deadLetterExchange("order.dlx")     // æŒ‡å®šæ­»ä¿¡äº¤æ¢æœº
            .deadLetterRoutingKey("order.dead")  // æŒ‡å®šæ­»ä¿¡è·¯ç”±é”®
            .ttl(30000)                          // 30ç§’TTL
            .build();
}

// åˆ›å»ºæ­»ä¿¡äº¤æ¢æœº
@Bean
public DirectExchange deadLetterExchange() {
    return new DirectExchange("order.dlx");
}

// åˆ›å»ºæ­»ä¿¡é˜Ÿåˆ—
@Bean
public Queue deadLetterQueue() {
    return QueueBuilder.durable("order.dead.queue").build();
}

// ç»‘å®šæ­»ä¿¡äº¤æ¢æœºå’Œæ­»ä¿¡é˜Ÿåˆ—
@Bean
public Binding deadLetterBinding() {
    return BindingBuilder
            .bind(deadLetterQueue())
            .to(deadLetterExchange())
            .with("order.dead");
}
```

#### ğŸ”§ æ–¹å¼äºŒï¼šä½¿ç”¨æ³¨è§£é…ç½®


```java
@Component
public class OrderMessageHandler {
    
    @RabbitListener(bindings = @QueueBinding(
        value = @Queue(value = "order.queue", durable = "true",
                arguments = {
                    @Argument(name = "x-dead-letter-exchange", value = "order.dlx"),
                    @Argument(name = "x-dead-letter-routing-key", value = "order.dead"),
                    @Argument(name = "x-message-ttl", value = "30000", type = "java.lang.Integer")
                }),
        exchange = @Exchange("order.exchange"),
        key = "order.create"
    ))
    public void handleOrderMessage(String message) {
        // å¤„ç†è®¢å•æ¶ˆæ¯
        System.out.println("å¤„ç†è®¢å•: " + message);
    }
}
```

#### ğŸ”§ æ–¹å¼ä¸‰ï¼šç®¡ç†ç•Œé¢é…ç½®


```
Webç®¡ç†ç•Œé¢é…ç½®æ­¥éª¤ï¼š
1ï¸âƒ£ è¿›å…¥RabbitMQç®¡ç†ç•Œé¢
2ï¸âƒ£ ç‚¹å‡» Queues æ ‡ç­¾
3ï¸âƒ£ ç‚¹å‡»è¦é…ç½®çš„é˜Ÿåˆ—åç§°
4ï¸âƒ£ åœ¨Argumentséƒ¨åˆ†æ·»åŠ ï¼š
   - x-dead-letter-exchange: order.dlx
   - x-dead-letter-routing-key: order.dead
5ï¸âƒ£ ç‚¹å‡»Updateä¿å­˜
```

### 3.3 æ­»ä¿¡äº¤æ¢æœºçš„ç±»å‹é€‰æ‹©


| äº¤æ¢æœºç±»å‹ | é€‚ç”¨åœºæ™¯ | è·¯ç”±è§„åˆ™ | é…ç½®å¤æ‚åº¦ |
|-----------|---------|----------|-----------|
| **Direct** | ğŸ¯ ç®€å•çš„æ­»ä¿¡å¤„ç† | ç²¾ç¡®åŒ¹é…è·¯ç”±é”® | â­â­ |
| **Topic** | ğŸ”€ å¤æ‚çš„æ­»ä¿¡åˆ†ç±» | é€šé…ç¬¦åŒ¹é… | â­â­â­ |
| **Fanout** | ğŸ“¢ æ­»ä¿¡å¹¿æ’­å¤„ç† | å¿½ç•¥è·¯ç”±é”® | â­ |
| **Headers** | ğŸ·ï¸ åŸºäºæ¶ˆæ¯å¤´è·¯ç”± | æ¶ˆæ¯å±æ€§åŒ¹é… | â­â­â­â­ |

**ğŸ’¡ é€‰æ‹©å»ºè®®**
- **åˆå­¦è€…æ¨è**ï¼šDirectç±»å‹ï¼Œç®€å•ç›´æ¥
- **å¤šä¸šåŠ¡åœºæ™¯**ï¼šTopicç±»å‹ï¼Œçµæ´»è·¯ç”±
- **ç›‘æ§å‘Šè­¦åœºæ™¯**ï¼šFanoutç±»å‹ï¼Œå¹¿æ’­é€šçŸ¥

---

## 4. ğŸ—ï¸ æ­»ä¿¡è·¯ç”±é”®é…ç½®ç­–ç•¥


### 4.1 æ­»ä¿¡è·¯ç”±é”®çš„ä½œç”¨æœºåˆ¶


**ğŸ”¸ è·¯ç”±é”®å†³å®šæ­»ä¿¡å»å‘**
æ­»ä¿¡è·¯ç”±é”®ï¼ˆDead Letter Routing Keyï¼‰å†³å®šäº†æ­»ä¿¡æ¶ˆæ¯æœ€ç»ˆä¼šè¢«è·¯ç”±åˆ°å“ªä¸ªæ­»ä¿¡é˜Ÿåˆ—ã€‚å°±åƒé‚®ä»¶çš„é‚®æ”¿ç¼–ç å†³å®šé‚®ä»¶çš„æŠ•é€’åœ°å€ä¸€æ ·ã€‚

```
è·¯ç”±è¿‡ç¨‹ï¼š
æ¶ˆæ¯å˜æˆæ­»ä¿¡ â†’ ä½¿ç”¨æ­»ä¿¡è·¯ç”±é”® â†’ è·¯ç”±åˆ°å¯¹åº”æ­»ä¿¡é˜Ÿåˆ—

ğŸ  é‚®ä»¶ç±»æ¯”ï¼š
åŸå§‹æ¶ˆæ¯ = æ™®é€šé‚®ä»¶ + æ”¶ä»¶åœ°å€
æ­»ä¿¡æ¶ˆæ¯ = é€€ä»¶é‚®ä»¶ + é€€ä»¶åœ°å€ï¼ˆæ­»ä¿¡è·¯ç”±é”®ï¼‰
```

### 4.2 æ­»ä¿¡è·¯ç”±é”®çš„ä¸‰ç§æ¥æº


#### ğŸ”¸ æ¥æºä¸€ï¼šé˜Ÿåˆ—é…ç½®çš„å›ºå®šè·¯ç”±é”®


```java
// é…ç½®å›ºå®šçš„æ­»ä¿¡è·¯ç”±é”®
@Bean
public Queue orderQueue() {
    return QueueBuilder.durable("order.queue")
            .deadLetterExchange("business.dlx")
            .deadLetterRoutingKey("order.failed")  // å›ºå®šè·¯ç”±é”®
            .build();
}
```

**é€‚ç”¨åœºæ™¯**ï¼šå•ä¸€ä¸šåŠ¡åœºæ™¯ï¼Œæ­»ä¿¡å¤„ç†é€»è¾‘ç»Ÿä¸€

#### ğŸ”¸ æ¥æºäºŒï¼šä½¿ç”¨åŸå§‹æ¶ˆæ¯çš„è·¯ç”±é”®


```java
// ä¸é…ç½®æ­»ä¿¡è·¯ç”±é”®ï¼Œä½¿ç”¨åŸå§‹è·¯ç”±é”®
@Bean  
public Queue userQueue() {
    return QueueBuilder.durable("user.queue")
            .deadLetterExchange("business.dlx")
            // ä¸è®¾ç½®deadLetterRoutingKeyï¼Œä½¿ç”¨åŸå§‹è·¯ç”±é”®
            .build();
}
```

**è·¯ç”±é”®ç»§æ‰¿ç¤ºä¾‹**ï¼š
```
åŸå§‹æ¶ˆæ¯è·¯ç”±é”®ï¼šuser.register
æ­»ä¿¡æ¶ˆæ¯è·¯ç”±é”®ï¼šuser.register ï¼ˆç»§æ‰¿åŸå§‹è·¯ç”±é”®ï¼‰
```

#### ğŸ”¸ æ¥æºä¸‰ï¼šåŠ¨æ€è·¯ç”±é”®ç­–ç•¥


```java
// åŸºäºä¸šåŠ¡ç±»å‹çš„åŠ¨æ€è·¯ç”±é”®
@Component
public class BusinessMessageHandler {
    
    @RabbitListener(queues = "business.queue")
    public void handleMessage(
            @Payload String message,
            @Header("businessType") String businessType,
            Channel channel,
            @Header(AmqpHeaders.DELIVERY_TAG) long deliveryTag) {
        
        try {
            processBusinessMessage(message, businessType);
            channel.basicAck(deliveryTag, false);
            
        } catch (Exception e) {
            // æ ¹æ®ä¸šåŠ¡ç±»å‹å†³å®šæ­»ä¿¡è·¯ç”±é”®
            // é€šè¿‡é˜Ÿåˆ—é…ç½®å®ç°åŠ¨æ€è·¯ç”±
            channel.basicReject(deliveryTag, false);
        }
    }
}
```

### 4.3 æ­»ä¿¡è·¯ç”±é”®çš„è®¾è®¡æ¨¡å¼


#### ğŸ“‹ æ¨¡å¼ä¸€ï¼šä¸šåŠ¡ç±»å‹åˆ†ç±»


```
è·¯ç”±é”®è®¾è®¡ï¼š
order.failed    â†’ è®¢å•ç›¸å…³æ­»ä¿¡
user.failed     â†’ ç”¨æˆ·ç›¸å…³æ­»ä¿¡  
payment.failed  â†’ æ”¯ä»˜ç›¸å…³æ­»ä¿¡
notify.failed   â†’ é€šçŸ¥ç›¸å…³æ­»ä¿¡

é˜Ÿåˆ—ç»‘å®šï¼š
business.dlx â†’ order.failed    â†’ order.dead.queue
business.dlx â†’ user.failed     â†’ user.dead.queue
business.dlx â†’ payment.failed  â†’ payment.dead.queue
business.dlx â†’ notify.failed   â†’ notify.dead.queue
```

#### ğŸ“‹ æ¨¡å¼äºŒï¼šé”™è¯¯çº§åˆ«åˆ†ç±»


```
è·¯ç”±é”®è®¾è®¡ï¼š
critical.error  â†’ ä¸¥é‡é”™è¯¯ï¼Œéœ€è¦ç«‹å³å¤„ç†
warning.error   â†’ è­¦å‘Šé”™è¯¯ï¼Œéœ€è¦å…³æ³¨
info.error      â†’ ä¿¡æ¯é”™è¯¯ï¼Œå¯å»¶åå¤„ç†

å¤„ç†ç­–ç•¥ï¼š
critical.error  â†’ ç«‹å³å‘Šè­¦ + äººå·¥å¤„ç†
warning.error   â†’ å®šæœŸæ£€æŸ¥ + è‡ªåŠ¨é‡è¯•
info.error      â†’ æ—¥å¿—è®°å½• + ç»Ÿè®¡åˆ†æ
```

#### ğŸ“‹ æ¨¡å¼ä¸‰ï¼šé‡è¯•æ¬¡æ•°åˆ†ç±»


```java
// åŸºäºé‡è¯•æ¬¡æ•°çš„è·¯ç”±é”®è®¾è®¡
public class RetryMessageHandler {
    
    private static final String RETRY_COUNT_HEADER = "x-retry-count";
    
    @RabbitListener(queues = "business.queue")
    public void handleMessage(Message message, Channel channel,
                             @Header(AmqpHeaders.DELIVERY_TAG) long deliveryTag) {
        try {
            // ä¸šåŠ¡å¤„ç†
            processMessage(message);
            channel.basicAck(deliveryTag, false);
            
        } catch (Exception e) {
            int retryCount = getRetryCount(message);
            
            if (retryCount < 3) {
                // é‡è¯•æ¬¡æ•°æœªè¾¾ä¸Šé™ï¼Œé‡æ–°å…¥é˜Ÿ
                incrementRetryCount(message);
                channel.basicReject(deliveryTag, true);
            } else {
                // é‡è¯•æ¬¡æ•°è¾¾åˆ°ä¸Šé™ï¼Œè¿›å…¥æ­»ä¿¡é˜Ÿåˆ—
                channel.basicReject(deliveryTag, false);
            }
        }
    }
    
    private int getRetryCount(Message message) {
        Object count = message.getMessageProperties()
                      .getHeaders().get(RETRY_COUNT_HEADER);
        return count != null ? (Integer) count : 0;
    }
}
```

---

## 5. ğŸ”„ æ¶ˆæ¯é‡è¯•æœºåˆ¶è®¾è®¡


### 5.1 é‡è¯•æœºåˆ¶çš„åŸºæœ¬åŸç†


**ğŸ”¸ ä¸ºä»€ä¹ˆéœ€è¦é‡è¯•**
åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç½‘ç»œæŠ–åŠ¨ã€æœåŠ¡ä¸´æ—¶ä¸å¯ç”¨ç­‰æƒ…å†µå¾ˆå¸¸è§ã€‚é‡è¯•æœºåˆ¶å¯ä»¥æé«˜ç³»ç»Ÿçš„å¥å£®æ€§ï¼Œé¿å…å› ä¸ºä¸´æ—¶æ€§é—®é¢˜å¯¼è‡´æ¶ˆæ¯å¤„ç†å¤±è´¥ã€‚

```
ğŸ  ç”Ÿæ´»ç±»æ¯”ï¼š
æ‰“ç”µè¯æ²¡äººæ¥ â†’ è¿‡ä¸€ä¼šå†æ‰“ â†’ è¿˜æ˜¯æ²¡äººæ¥ â†’ å†è¿‡ä¸€ä¼šæ‰“
å¦‚æœé‡è¯•å¤šæ¬¡éƒ½å¤±è´¥ â†’ å¯èƒ½å¯¹æ–¹æ‰‹æœºå…³æœºäº† â†’ ä¸å†é‡è¯•
```

**ğŸ”¸ é‡è¯•æœºåˆ¶çš„æ ¸å¿ƒè¦ç´ **
```
é‡è¯•ç­–ç•¥è¦ç´ ï¼š
ğŸ”¸ é‡è¯•æ¬¡æ•°ï¼šæœ€å¤šé‡è¯•å‡ æ¬¡
ğŸ”¸ é‡è¯•é—´éš”ï¼šæ¯æ¬¡é‡è¯•çš„æ—¶é—´é—´éš”
ğŸ”¸ é€€é¿ç­–ç•¥ï¼šå›ºå®šé—´éš” vs æŒ‡æ•°é€€é¿
ğŸ”¸ å¤±è´¥å¤„ç†ï¼šé‡è¯•è€—å°½åçš„å¤„ç†æ–¹å¼
```

### 5.2 é‡è¯•æ¬¡æ•°æ§åˆ¶ç­–ç•¥


#### ğŸ“Š é‡è¯•æ¬¡æ•°è®¾è®¡åŸåˆ™


| ä¸šåŠ¡ç±»å‹ | æ¨èé‡è¯•æ¬¡æ•° | ç†ç”± | ç¤ºä¾‹åœºæ™¯ |
|---------|-------------|------|----------|
| **å®æ—¶ä¸šåŠ¡** | 1-2æ¬¡ | å¿«é€Ÿå¤±è´¥ï¼Œé¿å…é˜»å¡ | ç”¨æˆ·ç™»å½•ã€å®æ—¶æŸ¥è¯¢ |
| **é‡è¦ä¸šåŠ¡** | 3-5æ¬¡ | å¹³è¡¡å¯é æ€§å’Œæ€§èƒ½ | è®¢å•æ”¯ä»˜ã€æ•°æ®åŒæ­¥ |
| **æ‰¹å¤„ç†ä¸šåŠ¡** | 5-10æ¬¡ | å®¹é”™æ€§è¦æ±‚é«˜ | æ•°æ®å¯¼å…¥ã€æ‰¹é‡é€šçŸ¥ |

#### ğŸ“ é‡è¯•æ¬¡æ•°å®ç°æ–¹æ¡ˆ


**æ–¹æ¡ˆä¸€ï¼šæ¶ˆæ¯å¤´è®°å½•é‡è¯•æ¬¡æ•°**
```java
@Component
public class RetryableMessageHandler {
    
    private static final int MAX_RETRY_COUNT = 3;
    private static final String RETRY_HEADER = "x-retry-count";
    
    @RabbitListener(queues = "order.queue")
    public void handleOrderMessage(
            Message message,
            Channel channel,
            @Header(AmqpHeaders.DELIVERY_TAG) long deliveryTag) {
        
        try {
            // ä¸šåŠ¡å¤„ç†
            processOrder(new String(message.getBody()));
            // å¤„ç†æˆåŠŸ
            channel.basicAck(deliveryTag, false);
            
        } catch (Exception e) {
            int currentRetryCount = getCurrentRetryCount(message);
            
            if (currentRetryCount < MAX_RETRY_COUNT) {
                // å¯ä»¥é‡è¯•
                rejectAndRetry(message, channel, deliveryTag, currentRetryCount);
            } else {
                // é‡è¯•æ¬¡æ•°è€—å°½ï¼Œè¿›å…¥æ­»ä¿¡é˜Ÿåˆ—
                channel.basicReject(deliveryTag, false);
                log.error("æ¶ˆæ¯é‡è¯•æ¬¡æ•°è€—å°½ï¼Œè¿›å…¥æ­»ä¿¡é˜Ÿåˆ—: {}", new String(message.getBody()));
            }
        }
    }
    
    private int getCurrentRetryCount(Message message) {
        Map<String, Object> headers = message.getMessageProperties().getHeaders();
        Object retryCount = headers.get(RETRY_HEADER);
        return retryCount != null ? (Integer) retryCount : 0;
    }
    
    private void rejectAndRetry(Message message, Channel channel, 
                               long deliveryTag, int currentRetryCount) throws IOException {
        // å¢åŠ é‡è¯•æ¬¡æ•°
        message.getMessageProperties().getHeaders()
               .put(RETRY_HEADER, currentRetryCount + 1);
        
        // é‡æ–°å‘é€åˆ°é˜Ÿåˆ—ï¼ˆä¹Ÿå¯ä»¥é€‰æ‹©é‡æ–°å…¥é˜Ÿï¼‰
        channel.basicReject(deliveryTag, true);
        
        log.warn("æ¶ˆæ¯å¤„ç†å¤±è´¥ï¼Œé‡è¯•ç¬¬{}æ¬¡", currentRetryCount + 1);
    }
}
```

### 5.3 é‡è¯•é—´éš”ç­–ç•¥è®¾è®¡


#### â° å›ºå®šé—´éš”é‡è¯•


```java
// é…ç½®å›ºå®šé—´éš”çš„é‡è¯•é˜Ÿåˆ—
@Configuration
public class RetryQueueConfig {
    
    // åŸå§‹é˜Ÿåˆ—
    @Bean
    public Queue originalQueue() {
        return QueueBuilder.durable("order.queue")
                .deadLetterExchange("retry.dlx")
                .deadLetterRoutingKey("order.retry.5s")
                .build();
    }
    
    // 5ç§’å»¶è¿Ÿé‡è¯•é˜Ÿåˆ—
    @Bean
    public Queue retryQueue5s() {
        return QueueBuilder.durable("order.retry.5s.queue")
                .ttl(5000)  // 5ç§’åè¿‡æœŸ
                .deadLetterExchange("order.exchange")  // è¿‡æœŸåå›åˆ°åŸå§‹äº¤æ¢æœº
                .deadLetterRoutingKey("order.process")
                .build();
    }
    
    // é‡è¯•äº¤æ¢æœº
    @Bean
    public DirectExchange retryExchange() {
        return new DirectExchange("retry.dlx");
    }
}
```

#### ğŸ“ˆ æŒ‡æ•°é€€é¿é‡è¯•


```java
@Component
public class ExponentialBackoffRetry {
    
    private static final int[] RETRY_DELAYS = {1000, 2000, 4000, 8000, 16000}; // 1s, 2s, 4s, 8s, 16s
    
    @RabbitListener(queues = "business.queue")
    public void handleMessage(Message message, Channel channel,
                             @Header(AmqpHeaders.DELIVERY_TAG) long deliveryTag) {
        try {
            processBusinessMessage(message);
            channel.basicAck(deliveryTag, false);
            
        } catch (Exception e) {
            int retryCount = getCurrentRetryCount(message);
            
            if (retryCount < RETRY_DELAYS.length) {
                // å‘é€åˆ°å¯¹åº”å»¶è¿Ÿçš„é‡è¯•é˜Ÿåˆ—
                sendToRetryQueue(message, retryCount);
                channel.basicAck(deliveryTag, false);  // ç¡®è®¤åŸæ¶ˆæ¯
            } else {
                // é‡è¯•æ¬¡æ•°è€—å°½
                channel.basicReject(deliveryTag, false);
            }
        }
    }
    
    private void sendToRetryQueue(Message message, int retryCount) {
        // å¢åŠ é‡è¯•æ¬¡æ•°
        message.getMessageProperties().getHeaders().put("x-retry-count", retryCount + 1);
        
        // è®¡ç®—å»¶è¿Ÿæ—¶é—´
        int delay = RETRY_DELAYS[retryCount];
        String retryQueueName = "business.retry." + delay + "ms.queue";
        
        // å‘é€åˆ°å¯¹åº”çš„å»¶è¿Ÿé˜Ÿåˆ—
        rabbitTemplate.send(retryQueueName, message);
        
        log.info("æ¶ˆæ¯å‘é€åˆ°é‡è¯•é˜Ÿåˆ—: {}, å»¶è¿Ÿ: {}ms", retryQueueName, delay);
    }
}
```

### 5.4 é‡è¯•é˜Ÿåˆ—æ¶æ„è®¾è®¡


```
å®Œæ•´çš„é‡è¯• + æ­»ä¿¡æ¶æ„ï¼š

                    â”Œâ”€ 1så»¶è¿Ÿé˜Ÿåˆ— â”€â”
ä¸šåŠ¡é˜Ÿåˆ— â†’ å¤„ç†å¤±è´¥ â”€â”¼â”€ 2så»¶è¿Ÿé˜Ÿåˆ— â”€â”¼â†’ é‡è¯•è€—å°½ â†’ æ­»ä¿¡é˜Ÿåˆ—
                    â””â”€ 4så»¶è¿Ÿé˜Ÿåˆ— â”€â”˜

å…·ä½“æµç¨‹ï¼š
1ï¸âƒ£ æ¶ˆæ¯åœ¨ä¸šåŠ¡é˜Ÿåˆ—å¤„ç†å¤±è´¥
2ï¸âƒ£ æ ¹æ®é‡è¯•æ¬¡æ•°å‘é€åˆ°å¯¹åº”å»¶è¿Ÿé˜Ÿåˆ—
3ï¸âƒ£ å»¶è¿Ÿé˜Ÿåˆ—TTLåˆ°æœŸåï¼Œæ¶ˆæ¯é‡æ–°å›åˆ°ä¸šåŠ¡é˜Ÿåˆ—
4ï¸âƒ£ å¦‚æœé‡è¯•æ¬¡æ•°è€—å°½ï¼Œæ¶ˆæ¯è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—
```

---

## 6. ğŸ› ï¸ å¼‚å¸¸æ¶ˆæ¯å¤„ç†æœ€ä½³å®è·µ


### 6.1 æ­»ä¿¡é˜Ÿåˆ—ç›‘æ§ä¸å‘Šè­¦


**ğŸ”¸ ç›‘æ§æŒ‡æ ‡è®¾è®¡**
```java
@Component
public class DeadLetterMonitor {
    
    @Autowired
    private RabbitAdmin rabbitAdmin;
    
    @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    public void monitorDeadLetterQueues() {
        // æ£€æŸ¥æ­»ä¿¡é˜Ÿåˆ—é•¿åº¦
        Properties queueProperties = rabbitAdmin.getQueueProperties("order.dead.queue");
        
        if (queueProperties != null) {
            int messageCount = (Integer) queueProperties.get("QUEUE_MESSAGE_COUNT");
            
            // è®¾ç½®å‘Šè­¦é˜ˆå€¼
            if (messageCount > 100) {
                sendAlert("æ­»ä¿¡é˜Ÿåˆ—æ¶ˆæ¯æ•°é‡å¼‚å¸¸", 
                         "é˜Ÿåˆ—: order.dead.queue, æ¶ˆæ¯æ•°é‡: " + messageCount);
            }
            
            // è®°å½•ç›‘æ§æŒ‡æ ‡
            recordMetric("dead_letter_queue_size", messageCount);
        }
    }
    
    private void sendAlert(String title, String content) {
        // å‘é€å‘Šè­¦é€šçŸ¥ï¼ˆé‚®ä»¶ã€çŸ­ä¿¡ã€é’‰é’‰ç­‰ï¼‰
        log.error("å‘Šè­¦: {} - {}", title, content);
    }
}
```

### 6.2 æ­»ä¿¡æ¶ˆæ¯äººå·¥å¤„ç†


#### ğŸ”§ æ­»ä¿¡æ¶ˆæ¯æŸ¥çœ‹å·¥å…·


```java
@RestController
@RequestMapping("/admin/deadletter")
public class DeadLetterAdminController {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    // æŸ¥çœ‹æ­»ä¿¡é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯
    @GetMapping("/messages/{queueName}")
    public List<MessageInfo> getDeadLetterMessages(@PathVariable String queueName) {
        List<MessageInfo> messages = new ArrayList<>();
        
        // ä»æ­»ä¿¡é˜Ÿåˆ—ä¸­è·å–æ¶ˆæ¯ï¼ˆä¸ç¡®è®¤ï¼ŒåªæŸ¥çœ‹ï¼‰
        for (int i = 0; i < 10; i++) { // æœ€å¤šæŸ¥çœ‹10æ¡
            Message message = rabbitTemplate.receive(queueName, 1000); // 1ç§’è¶…æ—¶
            if (message != null) {
                MessageInfo info = new MessageInfo();
                info.setBody(new String(message.getBody()));
                info.setHeaders(message.getMessageProperties().getHeaders());
                info.setTimestamp(message.getMessageProperties().getTimestamp());
                messages.add(info);
            } else {
                break;
            }
        }
        
        return messages;
    }
    
    // é‡æ–°å¤„ç†æ­»ä¿¡æ¶ˆæ¯
    @PostMapping("/reprocess/{queueName}")
    public String reprocessDeadLetterMessages(@PathVariable String queueName,
                                             @RequestParam String targetExchange,
                                             @RequestParam String targetRoutingKey) {
        int reprocessedCount = 0;
        
        while (true) {
            Message message = rabbitTemplate.receive(queueName, 1000);
            if (message == null) break;
            
            // æ¸…é™¤é‡è¯•æ¬¡æ•°ï¼Œé‡æ–°å‘é€
            message.getMessageProperties().getHeaders().remove("x-retry-count");
            rabbitTemplate.send(targetExchange, targetRoutingKey, message);
            reprocessedCount++;
        }
        
        return String.format("æˆåŠŸé‡æ–°å¤„ç† %d æ¡æ­»ä¿¡æ¶ˆæ¯", reprocessedCount);
    }
}
```

#### ğŸ“‹ æ­»ä¿¡æ¶ˆæ¯åˆ†ææŠ¥å‘Š


```java
@Service
public class DeadLetterAnalysisService {
    
    public DeadLetterReport generateReport(String queueName, LocalDate startDate, LocalDate endDate) {
        DeadLetterReport report = new DeadLetterReport();
        
        // ç»Ÿè®¡æ­»ä¿¡æ¶ˆæ¯æ•°é‡
        report.setTotalCount(getDeadLetterCount(queueName, startDate, endDate));
        
        // åˆ†æå¤±è´¥åŸå› 
        Map<String, Integer> failureReasons = analyzeFailureReasons(queueName);
        report.setFailureReasons(failureReasons);
        
        // åˆ†æå¤±è´¥æ—¶é—´åˆ†å¸ƒ
        Map<String, Integer> timeDistribution = analyzeTimeDistribution(queueName);
        report.setTimeDistribution(timeDistribution);
        
        // æä¾›å¤„ç†å»ºè®®
        List<String> suggestions = generateSuggestions(failureReasons);
        report.setSuggestions(suggestions);
        
        return report;
    }
    
    private List<String> generateSuggestions(Map<String, Integer> failureReasons) {
        List<String> suggestions = new ArrayList<>();
        
        for (Map.Entry<String, Integer> entry : failureReasons.entrySet()) {
            String reason = entry.getKey();
            int count = entry.getValue();
            
            if (reason.contains("timeout")) {
                suggestions.add("å»ºè®®å¢åŠ è¶…æ—¶æ—¶é—´æˆ–ä¼˜åŒ–æœåŠ¡å“åº”é€Ÿåº¦");
            } else if (reason.contains("connection")) {
                suggestions.add("å»ºè®®æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒæœåŠ¡å¯ç”¨æ€§");
            } else if (count > 100) {
                suggestions.add("è¯¥ç±»å‹é”™è¯¯æ•°é‡è¾ƒå¤šï¼Œå»ºè®®ä¼˜å…ˆå¤„ç†: " + reason);
            }
        }
        
        return suggestions;
    }
}
```

### 6.3 æ­»ä¿¡æ¶ˆæ¯é¢„é˜²ç­–ç•¥


#### ğŸ›¡ï¸ æ¶ˆæ¯å¹‚ç­‰æ€§è®¾è®¡


```java
@Component
public class IdempotentMessageHandler {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    private static final String PROCESSED_KEY_PREFIX = "msg:processed:";
    private static final int EXPIRE_SECONDS = 3600; // 1å°æ—¶è¿‡æœŸ
    
    @RabbitListener(queues = "order.queue")
    public void handleOrderMessage(
            @Payload OrderMessage orderMessage,
            @Header("messageId") String messageId,
            Channel channel,
            @Header(AmqpHeaders.DELIVERY_TAG) long deliveryTag) {
        
        try {
            // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²å¤„ç†
            String processedKey = PROCESSED_KEY_PREFIX + messageId;
            if (redisTemplate.hasKey(processedKey)) {
                log.info("æ¶ˆæ¯å·²å¤„ç†è¿‡ï¼Œè·³è¿‡: {}", messageId);
                channel.basicAck(deliveryTag, false);
                return;
            }
            
            // å¤„ç†ä¸šåŠ¡é€»è¾‘
            processOrderMessage(orderMessage);
            
            // æ ‡è®°æ¶ˆæ¯å·²å¤„ç†
            redisTemplate.opsForValue().set(processedKey, "processed", EXPIRE_SECONDS, TimeUnit.SECONDS);
            
            // ç¡®è®¤æ¶ˆæ¯
            channel.basicAck(deliveryTag, false);
            
        } catch (Exception e) {
            log.error("å¤„ç†è®¢å•æ¶ˆæ¯å¤±è´¥: {}", messageId, e);
            channel.basicReject(deliveryTag, false);
        }
    }
}
```

#### ğŸ” æ¶ˆæ¯éªŒè¯æœºåˆ¶


```java
@Component
public class MessageValidator {
    
    public void validateOrderMessage(OrderMessage message) throws ValidationException {
        List<String> errors = new ArrayList<>();
        
        // å¿…å¡«å­—æ®µéªŒè¯
        if (StringUtils.isEmpty(message.getOrderId())) {
            errors.add("è®¢å•IDä¸èƒ½ä¸ºç©º");
        }
        
        if (message.getAmount() == null || message.getAmount().compareTo(BigDecimal.ZERO) <= 0) {
            errors.add("è®¢å•é‡‘é¢å¿…é¡»å¤§äº0");
        }
        
        if (StringUtils.isEmpty(message.getUserId())) {
            errors.add("ç”¨æˆ·IDä¸èƒ½ä¸ºç©º");
        }
        
        // ä¸šåŠ¡è§„åˆ™éªŒè¯
        if (message.getAmount().compareTo(new BigDecimal("100000")) > 0) {
            errors.add("å•ç¬”è®¢å•é‡‘é¢ä¸èƒ½è¶…è¿‡10ä¸‡å…ƒ");
        }
        
        // æ•°æ®æ ¼å¼éªŒè¯
        if (!isValidOrderId(message.getOrderId())) {
            errors.add("è®¢å•IDæ ¼å¼ä¸æ­£ç¡®");
        }
        
        if (!errors.isEmpty()) {
            throw new ValidationException("æ¶ˆæ¯éªŒè¯å¤±è´¥: " + String.join(", ", errors));
        }
    }
    
    private boolean isValidOrderId(String orderId) {
        // è®¢å•IDæ ¼å¼ï¼šORDER + 8ä½æ•°å­—
        return orderId != null && orderId.matches("^ORDER\\d{8}$");
    }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ­»ä¿¡é˜Ÿåˆ—æœ¬è´¨ï¼šå¼‚å¸¸æ¶ˆæ¯çš„æ”¶é›†å’Œå¤„ç†æœºåˆ¶
ğŸ”¸ æ­»ä¿¡äº§ç”Ÿæ¡ä»¶ï¼šæ‹’ç»+ä¸é‡å…¥é˜Ÿã€TTLè¿‡æœŸã€é˜Ÿåˆ—é•¿åº¦è¶…é™
ğŸ”¸ æ­»ä¿¡äº¤æ¢æœºDLXï¼šæ­»ä¿¡æ¶ˆæ¯çš„è·¯ç”±ä¸­è½¬ç«™
ğŸ”¸ æ­»ä¿¡è·¯ç”±é”®ï¼šå†³å®šæ­»ä¿¡æ¶ˆæ¯çš„æœ€ç»ˆå»å‘
ğŸ”¸ é‡è¯•æœºåˆ¶ï¼šæé«˜ç³»ç»Ÿå¥å£®æ€§çš„é‡è¦æ‰‹æ®µ
ğŸ”¸ ç›‘æ§å‘Šè­¦ï¼šåŠæ—¶å‘ç°å’Œå¤„ç†å¼‚å¸¸æƒ…å†µ
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ æ­»ä¿¡é˜Ÿåˆ—ä¸æ˜¯åƒåœ¾ç®±**
```
æ­£ç¡®ç†è§£ï¼š
âœ… æ­»ä¿¡é˜Ÿåˆ—æ˜¯å¼‚å¸¸æ¶ˆæ¯çš„ä¸´æ—¶å­˜æ”¾å¤„
âœ… æ­»ä¿¡æ¶ˆæ¯å¯ä»¥é‡æ–°å¤„ç†å’Œæ¢å¤
âœ… æ­»ä¿¡é˜Ÿåˆ—å¸®åŠ©ç³»ç»Ÿæ›´åŠ ç¨³å®šå¯é 

é”™è¯¯ç†è§£ï¼š
âŒ æ­»ä¿¡é˜Ÿåˆ—æ˜¯æ— ç”¨æ¶ˆæ¯çš„åƒåœ¾ç®±
âŒ è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—çš„æ¶ˆæ¯å°±å½»åº•å¤±è´¥äº†
âŒ æ­»ä¿¡é˜Ÿåˆ—åªæ˜¯ä¸ºäº†é¿å…æ¶ˆæ¯ä¸¢å¤±
```

**ğŸ”¹ é‡è¯•æœºåˆ¶çš„è®¾è®¡åŸåˆ™**
```
å¹³è¡¡è€ƒè™‘ï¼š
ğŸ”¸ é‡è¯•æ¬¡æ•°ï¼šä¸èƒ½å¤ªå°‘ï¼ˆå®¹é”™æ€§å·®ï¼‰ä¹Ÿä¸èƒ½å¤ªå¤šï¼ˆå½±å“æ€§èƒ½ï¼‰
ğŸ”¸ é‡è¯•é—´éš”ï¼šé¿å…é¢‘ç¹é‡è¯•åŠ é‡ç³»ç»Ÿè´Ÿæ‹…
ğŸ”¸ é€€é¿ç­–ç•¥ï¼šæŒ‡æ•°é€€é¿æ¯”å›ºå®šé—´éš”æ›´åˆç†
ğŸ”¸ å¿«é€Ÿå¤±è´¥ï¼šå¯¹äºæ˜ç¡®çš„ä¸šåŠ¡é”™è¯¯ï¼Œä¸éœ€è¦é‡è¯•
```

**ğŸ”¹ æ­»ä¿¡è·¯ç”±é”®çš„é€‰æ‹©ç­–ç•¥**
```
è®¾è®¡åŸåˆ™ï¼š
ğŸ”¸ ä¸šåŠ¡åˆ†ç±»ï¼šä¸åŒä¸šåŠ¡ç±»å‹çš„æ­»ä¿¡åˆ†åˆ«å¤„ç†
ğŸ”¸ é”™è¯¯åˆ†çº§ï¼šæ ¹æ®é”™è¯¯ä¸¥é‡ç¨‹åº¦åˆ†ç±»å¤„ç†
ğŸ”¸ å¤„ç†ç­–ç•¥ï¼šä¸åŒç±»å‹çš„æ­»ä¿¡é‡‡ç”¨ä¸åŒå¤„ç†æ–¹å¼
ğŸ”¸ æ‰©å±•æ€§ï¼šè·¯ç”±é”®è®¾è®¡è¦è€ƒè™‘æœªæ¥æ‰©å±•éœ€æ±‚
```

### 7.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ æå‡ç³»ç»Ÿå¯é æ€§**
- **æ¶ˆæ¯ä¸ä¸¢å¤±**ï¼šå¼‚å¸¸æ¶ˆæ¯æœ‰åœ°æ–¹å­˜æ”¾å’Œå¤„ç†
- **æ•…éšœå¯æ¢å¤**ï¼šç³»ç»Ÿæ¢å¤åå¯ä»¥é‡æ–°å¤„ç†æ­»ä¿¡æ¶ˆæ¯
- **é—®é¢˜å¯è¿½è¸ª**ï¼šé€šè¿‡æ­»ä¿¡é˜Ÿåˆ—åˆ†æç³»ç»Ÿé—®é¢˜

**ğŸ”§ ä¼˜åŒ–è¿ç»´æ•ˆç‡**
- **è‡ªåŠ¨åŒ–é‡è¯•**ï¼šå‡å°‘äººå·¥å¹²é¢„ï¼Œæé«˜å¤„ç†æ•ˆç‡
- **ç›‘æ§å‘Šè­¦**ï¼šåŠæ—¶å‘ç°é—®é¢˜ï¼Œå¿«é€Ÿå“åº”
- **æ•°æ®åˆ†æ**ï¼šé€šè¿‡æ­»ä¿¡æ•°æ®ä¼˜åŒ–ç³»ç»Ÿè®¾è®¡

**ğŸ’¡ ä¸šåŠ¡åœºæ™¯åº”ç”¨**
- **è®¢å•ç³»ç»Ÿ**ï¼šæ”¯ä»˜å¤±è´¥çš„è®¢å•è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—ç­‰å¾…å¤„ç†
- **é€šçŸ¥ç³»ç»Ÿ**ï¼šå‘é€å¤±è´¥çš„é€šçŸ¥æ¶ˆæ¯å¯ä»¥é‡æ–°å°è¯•
- **æ•°æ®åŒæ­¥**ï¼šåŒæ­¥å¤±è´¥çš„æ•°æ®å¯ä»¥é‡æ–°åŒæ­¥

### 7.4 æœ€ä½³å®è·µæ€»ç»“


**ğŸ“ é…ç½®å»ºè®®**
```
ğŸ”¸ TTLè®¾ç½®ï¼šæ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹è®¾ç½®åˆç†çš„æ¶ˆæ¯è¿‡æœŸæ—¶é—´
ğŸ”¸ é˜Ÿåˆ—é•¿åº¦ï¼šè®¾ç½®é€‚å½“çš„é˜Ÿåˆ—é•¿åº¦é™åˆ¶ï¼Œé¿å…å†…å­˜æº¢å‡º
ğŸ”¸ é‡è¯•æ¬¡æ•°ï¼šä¸€èˆ¬è®¾ç½®3-5æ¬¡é‡è¯•ï¼Œé¿å…æ— é™é‡è¯•
ğŸ”¸ ç›‘æ§é˜ˆå€¼ï¼šè®¾ç½®æ­»ä¿¡é˜Ÿåˆ—é•¿åº¦å‘Šè­¦é˜ˆå€¼
```

**ğŸ› ï¸ å¼€å‘å»ºè®®**
```
ğŸ”¸ å¹‚ç­‰æ€§è®¾è®¡ï¼šç¡®ä¿é‡è¯•ä¸ä¼šäº§ç”Ÿå‰¯ä½œç”¨
ğŸ”¸ å¼‚å¸¸åˆ†ç±»ï¼šåŒºåˆ†ä¸šåŠ¡å¼‚å¸¸å’Œç³»ç»Ÿå¼‚å¸¸
ğŸ”¸ æ—¥å¿—å®Œå–„ï¼šè®°å½•è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ä¾¿äºæ’æŸ¥
ğŸ”¸ é™çº§ç­–ç•¥ï¼šè®¾è®¡åˆç†çš„é™çº§å’Œè¡¥å¿æœºåˆ¶
```

**ğŸ” è¿ç»´å»ºè®®**
```
ğŸ”¸ å®šæœŸæ£€æŸ¥ï¼šå®šæœŸæ£€æŸ¥æ­»ä¿¡é˜Ÿåˆ—çŠ¶æ€
ğŸ”¸ åŠæ—¶å¤„ç†ï¼šå‘ç°æ­»ä¿¡æ¶ˆæ¯è¦åŠæ—¶åˆ†æå¤„ç†
ğŸ”¸ å®¹é‡è§„åˆ’ï¼šé¢„ä¼°æ­»ä¿¡é˜Ÿåˆ—çš„å®¹é‡éœ€æ±‚
ğŸ”¸ å¤‡ä»½æ¢å¤ï¼šåˆ¶å®šæ­»ä¿¡æ•°æ®çš„å¤‡ä»½å’Œæ¢å¤ç­–ç•¥
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
ğŸ¯ æ­»ä¿¡ä¸‰æ¡ä»¶ï¼šæ‹’ç»ã€è¿‡æœŸã€é˜Ÿåˆ—æ»¡
ğŸ”„ DLXæ¥ä¸­è½¬ï¼Œè·¯ç”±é”®å®šæ–¹å‘
ğŸ” é‡è¯•è¦é€‚åº¦ï¼Œç›‘æ§ä¸èƒ½å¿˜
ğŸ› ï¸ äººå·¥æ¥å¤„ç†ï¼Œç³»ç»Ÿæ›´å¥å£®
```

### 7.5 è¿›é˜¶å­¦ä¹ æ–¹å‘


**ğŸ“š æ·±å…¥ç†è§£**
- **æ¶ˆæ¯ä¸­é—´ä»¶è®¾è®¡åŸç†**ï¼šäº†è§£å…¶ä»–MQçš„æ­»ä¿¡å®ç°
- **åˆ†å¸ƒå¼ç³»ç»Ÿå¯é æ€§**ï¼šå­¦ä¹ CAPç†è®ºå’Œåˆ†å¸ƒå¼äº‹åŠ¡
- **å¾®æœåŠ¡å®¹é”™æ¨¡å¼**ï¼šç†Ÿæ‚‰ç†”æ–­å™¨ã€é™æµå™¨ç­‰æ¨¡å¼

**ğŸš€ å®è·µæå‡**
- **æ­å»ºå®Œæ•´çš„æ­»ä¿¡å¤„ç†ç³»ç»Ÿ**ï¼šåŒ…å«ç›‘æ§ã€å‘Šè­¦ã€äººå·¥å¤„ç†
- **æ€§èƒ½è°ƒä¼˜**ï¼šä¼˜åŒ–æ­»ä¿¡å¤„ç†çš„æ€§èƒ½å’Œèµ„æºä½¿ç”¨
- **æ•…éšœæ¼”ç»ƒ**ï¼šæ¨¡æ‹Ÿå„ç§å¼‚å¸¸æƒ…å†µæµ‹è¯•æ­»ä¿¡æœºåˆ¶