---
title: 29、Federation联邦命令
---
## 📚 目录

1. [Shovel铲子的基本概念](#1-Shovel铲子的基本概念)
2. [Shovel插件管理](#2-Shovel插件管理)
3. [Shovel配置与设置](#3-Shovel配置与设置)
4. [Shovel监控与状态查看](#4-Shovel监控与状态查看)
5. [Shovel生命周期管理](#5-Shovel生命周期管理)
6. [实际应用场景](#6-实际应用场景)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 🔧 Shovel铲子的基本概念


### 1.1 什么是RabbitMQ Shovel


> 📌 **核心概念**  
> Shovel（铲子）是RabbitMQ的一个插件，它的作用就像一个"搬运工"，可以把消息从一个地方"铲"到另一个地方

**通俗理解**：
```
想象一下现实中的铲子：
🏠 家里的沙子 → 🚚 用铲子装车 → 🏗️ 运到工地

RabbitMQ Shovel也是类似：
📨 源队列的消息 → 🔄 Shovel搬运 → 📬 目标队列
```

**Shovel解决什么问题**：
- **跨集群消息传输**：不同RabbitMQ集群之间传递消息
- **数据迁移**：将旧系统的消息搬到新系统
- **消息备份**：把重要消息复制一份到备份系统
- **系统集成**：连接不同的消息系统

### 1.2 Shovel的工作原理


```
消息流向示意图：
源端 RabbitMQ                    目标端 RabbitMQ
┌─────────────┐                 ┌─────────────┐
│   Queue A   │ ──── Shovel ──→ │   Queue B   │
│  [msg1]     │     (铲子)      │   [msg1]    │
│  [msg2]     │                 │   [msg2]    │
│  [msg3]     │                 │   [msg3]    │
└─────────────┘                 └─────────────┘

工作过程：
1. Shovel从源队列消费消息
2. 将消息发布到目标队列  
3. 确认消息处理完成
4. 继续处理下一条消息
```

**核心特点**：
- ✅ **可靠传输**：确保消息不丢失
- ✅ **自动重连**：网络断开后自动恢复
- ✅ **灵活配置**：支持各种传输场景
- ✅ **监控友好**：提供详细的状态信息

---

## 2. 🚀 Shovel插件管理


### 2.1 启用Shovel功能


**基础插件启用**：
```bash
# 启用核心Shovel插件
rabbitmq-plugins enable rabbitmq_shovel
```

> 💡 **实用技巧**  
> 这个命令会激活Shovel的基本功能，但还不包括Web管理界面

**管理界面插件启用**：
```bash
# 启用Shovel的Web管理插件
rabbitmq-plugins enable rabbitmq_shovel_management
```

> 📌 **重要说明**  
> 启用管理插件后，你就可以在RabbitMQ的Web界面中看到Shovel的状态和配置了

### 2.2 插件状态检查


**查看插件状态**：
```bash
# 查看所有插件状态
rabbitmq-plugins list

# 输出示例：
[E*] rabbitmq_shovel                3.8.0
[E*] rabbitmq_shovel_management     3.8.0
```

**状态标识说明**：
- `[E*]` = 已启用且正在运行
- `[ *]` = 可用但未启用
- `[e*]` = 隐式启用（被其他插件依赖）

---

## 3. ⚙️ Shovel配置与设置


### 3.1 创建Shovel配置


**基本设置命令**：
```bash
rabbitmqctl set_parameter shovel {name} {definition}
```

> 🌱 **入门理解**  
> 这里的`{name}`是你给这个铲子起的名字，`{definition}`是具体的配置信息

**实际配置示例**：
```bash
# 创建一个简单的消息搬运铲子
rabbitmqctl set_parameter shovel my-shovel '
{
  "src-uri": "amqp://guest:guest@localhost:5672/%2f",
  "src-queue": "source_queue",
  "dest-uri": "amqp://user:pass@remote-server:5672/vhost",
  "dest-queue": "target_queue"
}'
```

### 3.2 配置参数详解


**核心配置项说明**：

| 配置项 | **作用说明** | **示例值** |
|--------|-------------|-----------|
| `src-uri` | **源端连接地址** | `amqp://localhost:5672` |
| `src-queue` | **源队列名称** | `orders_queue` |
| `dest-uri` | **目标端连接地址** | `amqp://backup-server:5672` |
| `dest-queue` | **目标队列名称** | `backup_orders` |

**高级配置选项**：
```json
{
  "src-uri": "amqp://source-server:5672",
  "src-queue": "my_queue",
  "dest-uri": "amqp://target-server:5672", 
  "dest-queue": "backup_queue",
  "prefetch-count": 1000,
  "reconnect-delay": 5,
  "ack-mode": "on-confirm"
}
```

> ⚠️ **注意事项**  
> 配置中的URI必须包含正确的用户名、密码和虚拟主机信息

### 3.3 设置Shovel参数


**单独设置参数**：
```bash
rabbitmqctl set_shovel_parameter {name} {key} {value}
```

**常用参数设置**：
```bash
# 设置预取数量（一次处理多少条消息）
rabbitmqctl set_shovel_parameter my-shovel prefetch-count 500

# 设置重连延迟（网络断开后多久重试）
rabbitmqctl set_shovel_parameter my-shovel reconnect-delay 10
```

---

## 4. 📊 Shovel监控与状态查看


### 4.1 查看Shovel状态


**查看所有Shovel**：
```bash
rabbitmqctl list_parameters component shovel
```

**输出示例**：
```
component name      value
shovel    my-shovel {"src-uri":"amqp://localhost:5672",...}
shovel    backup    {"src-uri":"amqp://prod:5672",...}
```

### 4.2 详细状态信息


**获取运行状态**：
```bash
rabbitmqctl eval 'rabbit_shovel_status:status().'
```

**查看特定铲子状态**：
```bash
rabbitmqctl shovel_status
```

**状态信息解读**：
```
Shovel状态示例：
┌──────────────┬─────────────┬──────────────┐
│ Shovel名称   │ 连接状态    │ 消息计数     │
├──────────────┼─────────────┼──────────────┤
│ my-shovel    │ running     │ 1500 msgs    │
│ backup       │ terminated  │ 890 msgs     │
│ sync-orders  │ starting    │ 0 msgs       │
└──────────────┴─────────────┴──────────────┘
```

**状态类型说明**：
- 🟢 **running** - 正常运行中
- 🔴 **terminated** - 已停止
- 🟡 **starting** - 启动中
- 🟠 **flow_controlled** - 流量控制中

---

## 5. 🔄 Shovel生命周期管理


### 5.1 重启Shovel


**重启指定铲子**：
```bash
rabbitmqctl restart_shovel {name}
```

**实际使用**：
```bash
# 重启名为 my-shovel 的铲子
rabbitmqctl restart_shovel my-shovel
```

> 💡 **使用场景**  
> 当铲子配置更改后，或者出现连接问题时，可以用重启来解决

### 5.2 删除Shovel


**删除铲子配置**：
```bash
rabbitmqctl delete_shovel {name}
```

**清除参数配置**：
```bash
rabbitmqctl clear_parameter shovel {name}
```

**使用示例**：
```bash
# 方法1：直接删除铲子
rabbitmqctl delete_shovel my-shovel

# 方法2：清除参数（效果相同）
rabbitmqctl clear_parameter shovel my-shovel
```

---

## 6. 🎯 实际应用场景


### 6.1 跨数据中心消息同步


**场景描述**：
```
北京机房 RabbitMQ → 上海机房 RabbitMQ
订单处理结果      同步备份
```

**配置方案**：
```bash
rabbitmqctl set_parameter shovel beijing-to-shanghai '
{
  "src-uri": "amqp://beijing-mq:5672/orders",
  "src-queue": "processed_orders",
  "dest-uri": "amqp://shanghai-mq:5672/backup", 
  "dest-queue": "orders_backup",
  "ack-mode": "on-confirm"
}'
```

### 6.2 系统迁移数据搬运


**场景描述**：
```
旧系统消息队列 → 新系统消息队列
平滑过渡期间  保证数据一致
```

**配置步骤**：
```bash
# 步骤1：创建迁移铲子
rabbitmqctl set_parameter shovel migration-shovel '
{
  "src-uri": "amqp://old-system:5672",
  "src-queue": "legacy_queue", 
  "dest-uri": "amqp://new-system:5672",
  "dest-queue": "modern_queue"
}'

# 步骤2：监控迁移进度
rabbitmqctl shovel_status
```

### 6.3 消息路由分发


**多目标分发示例**：
```
源队列：user_events
├── Shovel1 → analytics_queue  (数据分析)
├── Shovel2 → audit_queue      (审计日志)  
└── Shovel3 → backup_queue     (数据备份)
```

---

## 7. 📋 核心要点总结


### 7.1 必须掌握的基本概念


```
🔸 Shovel本质：RabbitMQ的消息搬运工具
🔸 核心作用：跨集群、跨系统的消息传输
🔸 工作原理：从源端消费，向目标端发布
🔸 可靠性：支持确认机制，保证消息不丢失
```

### 7.2 关键命令速查


| 命令类型 | **命令** | **作用** |
|---------|---------|---------|
| 🚀 **插件管理** | `rabbitmq-plugins enable rabbitmq_shovel` | 启用铲子功能 |
| ⚙️ **配置管理** | `rabbitmqctl set_parameter shovel name config` | 创建铲子 |
| 📊 **状态查看** | `rabbitmqctl shovel_status` | 查看运行状态 |
| 🔄 **生命周期** | `rabbitmqctl restart_shovel name` | 重启铲子 |
| 🗑️ **清理操作** | `rabbitmqctl delete_shovel name` | 删除铲子 |

### 7.3 实际应用指导


**✅ 适用场景**：
- 跨数据中心的消息同步
- 系统迁移期间的数据搬运
- 消息备份和灾难恢复
- 不同版本RabbitMQ之间的数据传输

**⚠️ 注意事项**：
- 确保网络连接稳定可靠
- 合理设置预取数量避免内存压力
- 监控铲子状态及时发现问题
- 根据业务需求选择合适的确认模式

### 7.4 最佳实践建议


> 🔥 **生产环境建议**  
> 1. **监控为先**：定期检查Shovel状态，设置告警
> 2. **容错设计**：配置自动重连和错误处理
> 3. **性能调优**：根据消息量调整预取参数
> 4. **安全配置**：使用专用用户和权限控制

**核心记忆口诀**：
```
铲子搬运跨集群，消息传输有保障
配置监控不可少，重启删除要记牢
生产使用需谨慎，网络稳定是关键
```