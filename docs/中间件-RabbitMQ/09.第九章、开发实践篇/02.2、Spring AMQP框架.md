---
title: 2ã€Spring AMQPæ¡†æ¶
---
## ğŸ“š ç›®å½•

1. [Spring AMQPæ¡†æ¶æ¦‚è¿°](#1-Spring-AMQPæ¡†æ¶æ¦‚è¿°)
2. [RabbitTemplateæ ¸å¿ƒä½¿ç”¨](#2-RabbitTemplateæ ¸å¿ƒä½¿ç”¨)
3. [æ¶ˆæ¯ç›‘å¬ä¸æ³¨è§£é…ç½®](#3-æ¶ˆæ¯ç›‘å¬ä¸æ³¨è§£é…ç½®)
4. [æ¶ˆæ¯è½¬æ¢å™¨é…ç½®](#4-æ¶ˆæ¯è½¬æ¢å™¨é…ç½®)
5. [é‡è¯•æœºåˆ¶è®¾è®¡](#5-é‡è¯•æœºåˆ¶è®¾è®¡)
6. [å¼‚å¸¸å¤„ç†ç­–ç•¥](#6-å¼‚å¸¸å¤„ç†ç­–ç•¥)
7. [äº‹åŠ¡æ”¯æŒ](#7-äº‹åŠ¡æ”¯æŒ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒŸ Spring AMQPæ¡†æ¶æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯Spring AMQP


**ğŸ”¸ ç®€å•ç†è§£**
Spring AMQPå°±åƒæ˜¯Springä¸ºRabbitMQä¸“é—¨æ‰“é€ çš„"ç¿»è¯‘å®˜"ï¼Œå¸®æˆ‘ä»¬ç”¨Javaæ›´ç®€å•åœ°æ“ä½œRabbitMQã€‚

```
åŸå§‹æ–¹å¼ï¼šè‡ªå·±å†™ä»£ç è¿æ¥RabbitMQ â†’ å¾ˆå¤æ‚
Spring AMQPï¼šæä¾›ç°æˆå·¥å…·å’Œæ³¨è§£ â†’ è¶…ç®€å•

å°±åƒï¼š
åŸæ¥è¦è‡ªå·±é€ è½¦ â†’ ç°åœ¨ç›´æ¥å¼€ç°æˆçš„è½¦
åŸæ¥è¦å†™å¾ˆå¤šä»£ç  â†’ ç°åœ¨åªéœ€å‡ ä¸ªæ³¨è§£
```

**ğŸ’¡ æ ¸å¿ƒä»·å€¼**
- **ç®€åŒ–å¼€å‘**ï¼šä¸ç”¨å†™å¤æ‚çš„è¿æ¥ä»£ç 
- **è‡ªåŠ¨ç®¡ç†**ï¼šè¿æ¥æ± ã€å¼‚å¸¸å¤„ç†éƒ½å¸®ä½ æå®š
- **Springé›†æˆ**ï¼šå®Œç¾èå…¥Springç”Ÿæ€
- **é…ç½®ç®€å•**ï¼šåŸºæœ¬ä¸ç”¨å†™XMLé…ç½®

### 1.2 æ ¸å¿ƒç»„ä»¶ä¸€è§ˆ


```
Spring AMQPå…¨å®¶æ¡¶ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            åº”ç”¨å±‚                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  RabbitTemplate    @RabbitListener  â”‚ â† ä½ ä¸»è¦ç”¨çš„
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    æ¶ˆæ¯è½¬æ¢å™¨        é‡è¯•æœºåˆ¶         â”‚ â† é…ç½®ç”¨çš„
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚       Spring AMQP æ ¸å¿ƒ              â”‚ â† æ¡†æ¶å±‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚        RabbitMQ Java Client         â”‚ â† åº•å±‚é©±åŠ¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ¯ ä¸»è¦è§’è‰²**
- **RabbitTemplate**ï¼šå‘é€æ¶ˆæ¯çš„å·¥å…·ï¼ˆåƒé‚®é€’å‘˜ï¼‰
- **@RabbitListener**ï¼šæ¥æ”¶æ¶ˆæ¯çš„æ³¨è§£ï¼ˆåƒæ”¶ä»¶äººï¼‰
- **æ¶ˆæ¯è½¬æ¢å™¨**ï¼šJavaå¯¹è±¡å’Œæ¶ˆæ¯äº’è½¬ï¼ˆåƒç¿»è¯‘ï¼‰
- **è¿æ¥å·¥å‚**ï¼šç®¡ç†åˆ°RabbitMQçš„è¿æ¥ï¼ˆåƒç”µè¯çº¿ï¼‰

### 1.3 å¿«é€Ÿä¸Šæ‰‹é…ç½®


**ğŸ“¦ Mavenä¾èµ–**
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-amqp</artifactId>
</dependency>
```

**âš™ï¸ åŸºç¡€é…ç½®**
```yml
spring:
  rabbitmq:
    host: localhost          # RabbitMQæœåŠ¡å™¨åœ°å€
    port: 5672              # ç«¯å£å·
    username: guest         # ç”¨æˆ·å
    password: guest         # å¯†ç 
    virtual-host: /         # è™šæ‹Ÿä¸»æœº
```

---

## 2. ğŸ“¨ RabbitTemplateæ ¸å¿ƒä½¿ç”¨


### 2.1 RabbitTemplateæ˜¯ä»€ä¹ˆ


**ğŸ”¸ ç®€å•æ¯”å–»**
RabbitTemplateå°±åƒä½ çš„"ä¸“å±é‚®é€’å‘˜"ï¼Œä½ åªéœ€è¦å‘Šè¯‰å®ƒï¼š
- ğŸ“® å¾€å“ªä¸ªé‚®ç®±å‘ï¼ˆExchangeï¼‰
- ğŸ·ï¸ ç”¨ä»€ä¹ˆæ ‡ç­¾ï¼ˆRoutingKeyï¼‰  
- ğŸ“¦ å‘ä»€ä¹ˆå†…å®¹ï¼ˆMessageï¼‰

å®ƒå°±å¸®ä½ æŠŠæ¶ˆæ¯é€åˆ°RabbitMQï¼

### 2.2 åŸºæœ¬å‘é€æ¶ˆæ¯


**ğŸš€ æœ€ç®€å•çš„å‘é€æ–¹å¼**
```java
@Service
public class MessageSender {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    // æœ€ç®€å•ï¼šç›´æ¥å‘é€åˆ°é˜Ÿåˆ—
    public void sendToQueue(String message) {
        rabbitTemplate.convertAndSend("my-queue", message);
        // ç›¸å½“äºï¼šæŠŠmessageç›´æ¥ä¸¢åˆ°my-queueé˜Ÿåˆ—é‡Œ
    }
    
    // é€šè¿‡äº¤æ¢æœºå‘é€
    public void sendToExchange(String message) {
        rabbitTemplate.convertAndSend(
            "my-exchange",      // äº¤æ¢æœºåç§°
            "my-routing-key",   // è·¯ç”±é”®
            message             // æ¶ˆæ¯å†…å®¹
        );
    }
}
```

**ğŸ’¡ ä¸‰ç§å‘é€æ¨¡å¼å¯¹æ¯”**

| æ–¹å¼ | ä½¿ç”¨åœºæ™¯ | ä¼˜ç¼ºç‚¹ |
|------|---------|--------|
| `convertAndSend(queue, message)` | ç›´æ¥é˜Ÿåˆ— | ğŸ”¸ ç®€å•ç›´æ¥<br>ğŸ”¸ é€‚åˆç‚¹å¯¹ç‚¹ |
| `convertAndSend(exchange, routingKey, message)` | é€šè¿‡äº¤æ¢æœº | ğŸ”¸ çµæ´»è·¯ç”±<br>ğŸ”¸ æ”¯æŒå¹¿æ’­ |
| `send(message)` | å‘é€åŸå§‹Messageå¯¹è±¡ | ğŸ”¸ å®Œå…¨æ§åˆ¶<br>ğŸ”¸ è¾ƒå¤æ‚ |

### 2.3 å‘é€å¤æ‚å¯¹è±¡


**ğŸ“¦ å‘é€Javaå¯¹è±¡**
```java
// ç”¨æˆ·ä¿¡æ¯ç±»
public class User {
    private String name;
    private int age;
    // getter/setter...
}

@Service
public class UserService {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    // å‘é€ç”¨æˆ·å¯¹è±¡
    public void sendUser(User user) {
        rabbitTemplate.convertAndSend("user-queue", user);
        // Springä¼šè‡ªåŠ¨æŠŠUserå¯¹è±¡è½¬æˆJSONå‘é€
    }
    
    // å‘é€Mapæ•°æ®
    public void sendUserInfo(String name, int age) {
        Map<String, Object> userInfo = new HashMap<>();
        userInfo.put("name", name);
        userInfo.put("age", age);
        
        rabbitTemplate.convertAndSend("user-info-queue", userInfo);
    }
}
```

### 2.4 æ¶ˆæ¯å±æ€§è®¾ç½®


**ğŸ·ï¸ è®¾ç½®æ¶ˆæ¯å±æ€§**
```java
public void sendWithProperties(String message) {
    // è®¾ç½®æ¶ˆæ¯å±æ€§
    rabbitTemplate.convertAndSend(
        "my-exchange", 
        "my-key", 
        message, 
        messagePostProcessor -> {
            // è®¾ç½®æ¶ˆæ¯ID
            messagePostProcessor.getMessageProperties()
                .setMessageId(UUID.randomUUID().toString());
            
            // è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆ10ç§’ï¼‰
            messagePostProcessor.getMessageProperties()
                .setExpiration("10000");
            
            // è®¾ç½®ä¼˜å…ˆçº§
            messagePostProcessor.getMessageProperties()
                .setPriority(5);
            
            return messagePostProcessor;
        }
    );
}
```

### 2.5 å‘é€å¹¶ç­‰å¾…å›å¤


**ğŸ”„ åŒæ­¥ç­‰å¾…å›å¤**
```java
public String sendAndReceive(String question) {
    // å‘é€æ¶ˆæ¯å¹¶ç­‰å¾…å›å¤ï¼ˆç±»ä¼¼HTTPè¯·æ±‚-å“åº”ï¼‰
    String answer = (String) rabbitTemplate.convertSendAndReceive(
        "question-exchange",
        "ask",
        question
    );
    
    return answer; // ç­‰å¾…å¯¹æ–¹å›å¤çš„ç­”æ¡ˆ
}

// è®¾ç½®è¶…æ—¶æ—¶é—´çš„ç‰ˆæœ¬
public String sendAndReceiveWithTimeout(String question) {
    rabbitTemplate.setReceiveTimeout(5000); // 5ç§’è¶…æ—¶
    
    String answer = (String) rabbitTemplate.convertSendAndReceive(
        "question-exchange",
        "ask", 
        question
    );
    
    return answer != null ? answer : "æ²¡æœ‰æ”¶åˆ°å›å¤";
}
```

---

## 3. ğŸ‘‚ æ¶ˆæ¯ç›‘å¬ä¸æ³¨è§£é…ç½®


### 3.1 @RabbitListeneråŸºç¡€ä½¿ç”¨


**ğŸ”¸ ä»€ä¹ˆæ˜¯@RabbitListener**
è¿™ä¸ªæ³¨è§£å°±åƒç»™ä½ çš„æ–¹æ³•è´´äº†ä¸ªæ ‡ç­¾ï¼š"æˆ‘è¦ç›‘å¬æŸä¸ªé˜Ÿåˆ—çš„æ¶ˆæ¯"ã€‚ä¸€æ—¦æœ‰æ¶ˆæ¯æ¥äº†ï¼ŒSpringå°±ä¼šè‡ªåŠ¨è°ƒç”¨ä½ çš„æ–¹æ³•ã€‚

**ğŸ“© æœ€ç®€å•çš„ç›‘å¬**
```java
@Component
public class MessageListener {
    
    // ç›‘å¬æŒ‡å®šé˜Ÿåˆ—
    @RabbitListener(queues = "my-queue")
    public void handleMessage(String message) {
        System.out.println("æ”¶åˆ°æ¶ˆæ¯ï¼š" + message);
        // å¤„ç†æ¶ˆæ¯çš„ä¸šåŠ¡é€»è¾‘
    }
    
    // ç›‘å¬å¤šä¸ªé˜Ÿåˆ—
    @RabbitListener(queues = {"queue1", "queue2", "queue3"})
    public void handleMultipleQueues(String message) {
        System.out.println("ä»å¤šä¸ªé˜Ÿåˆ—æ”¶åˆ°ï¼š" + message);
    }
}
```

### 3.2 è‡ªåŠ¨åˆ›å»ºé˜Ÿåˆ—å’Œäº¤æ¢æœº


**ğŸ—ï¸ å£°æ˜å¼é…ç½®**
```java
@Component
public class QueueListener {
    
    // è‡ªåŠ¨åˆ›å»ºé˜Ÿåˆ—å¹¶ç›‘å¬
    @RabbitListener(queuesToDeclare = @Queue("auto-created-queue"))
    public void handleAutoQueue(String message) {
        System.out.println("è‡ªåŠ¨åˆ›å»ºçš„é˜Ÿåˆ—æ”¶åˆ°ï¼š" + message);
    }
    
    // åˆ›å»ºæŒä¹…åŒ–é˜Ÿåˆ—
    @RabbitListener(queuesToDeclare = @Queue(
        value = "durable-queue",
        durable = "true"  // æŒä¹…åŒ–
    ))
    public void handleDurableQueue(String message) {
        System.out.println("æŒä¹…åŒ–é˜Ÿåˆ—æ”¶åˆ°ï¼š" + message);
    }
}
```

**ğŸ”— å®Œæ•´çš„äº¤æ¢æœº+é˜Ÿåˆ—+ç»‘å®š**
```java
@Component
public class CompleteListener {
    
    @RabbitListener(bindings = @QueueBinding(
        value = @Queue("user-notifications"),           // é˜Ÿåˆ—å
        exchange = @Exchange("user-events"),            // äº¤æ¢æœºå
        key = "user.registered"                         // è·¯ç”±é”®
    ))
    public void handleUserRegistered(String message) {
        System.out.println("ç”¨æˆ·æ³¨å†Œäº‹ä»¶ï¼š" + message);
    }
    
    // Fanoutäº¤æ¢æœºï¼ˆå¹¿æ’­ï¼‰
    @RabbitListener(bindings = @QueueBinding(
        value = @Queue("news-subscriber-1"),
        exchange = @Exchange(value = "news-broadcast", type = "fanout")
    ))
    public void handleNews(String news) {
        System.out.println("æ”¶åˆ°æ–°é—»å¹¿æ’­ï¼š" + news);
    }
}
```

### 3.3 æ¥æ”¶ä¸åŒç±»å‹çš„æ¶ˆæ¯


**ğŸ“¦ æ¥æ”¶å¯¹è±¡ç±»å‹**
```java
@Component
public class UserEventListener {
    
    // æ¥æ”¶Userå¯¹è±¡
    @RabbitListener(queues = "user-queue")
    public void handleUser(User user) {
        System.out.println("æ”¶åˆ°ç”¨æˆ·ï¼š" + user.getName());
        // Springè‡ªåŠ¨æŠŠJSONè½¬æˆUserå¯¹è±¡
    }
    
    // æ¥æ”¶Mapæ•°æ®
    @RabbitListener(queues = "data-queue")
    public void handleMapData(Map<String, Object> data) {
        System.out.println("æ”¶åˆ°æ•°æ®ï¼š" + data);
    }
    
    // æ¥æ”¶åŸå§‹Messageå¯¹è±¡ï¼ˆè·å–æ›´å¤šä¿¡æ¯ï¼‰
    @RabbitListener(queues = "raw-queue")
    public void handleRawMessage(Message message) {
        String content = new String(message.getBody());
        String messageId = message.getMessageProperties().getMessageId();
        
        System.out.println("æ¶ˆæ¯IDï¼š" + messageId);
        System.out.println("æ¶ˆæ¯å†…å®¹ï¼š" + content);
    }
}
```

### 3.4 æ¡ä»¶ç›‘å¬å’Œæ¶ˆæ¯è¿‡æ»¤


**ğŸ¯ æ ¹æ®æ¶ˆæ¯å¤´è¿‡æ»¤**
```java
@Component
public class ConditionalListener {
    
    // åªå¤„ç†VIPç”¨æˆ·çš„æ¶ˆæ¯
    @RabbitListener(
        queues = "user-actions",
        containerFactory = "rabbitListenerContainerFactory"
    )
    @Header("userType")  // è·å–æ¶ˆæ¯å¤´
    public void handleVipUser(String action, @Header String userType) {
        if ("VIP".equals(userType)) {
            System.out.println("VIPç”¨æˆ·è¡Œä¸ºï¼š" + action);
            // ç‰¹æ®Šå¤„ç†VIPç”¨æˆ·
        }
    }
    
    // SpELè¡¨è¾¾å¼è¿‡æ»¤
    @RabbitListener(
        queues = "orders",
        condition = "headers['orderAmount'] > 1000"  // åªå¤„ç†1000å…ƒä»¥ä¸Šè®¢å•
    )
    public void handleLargeOrder(String order) {
        System.out.println("å¤§é¢è®¢å•ï¼š" + order);
    }
}
```

### 3.5 å¹¶å‘ç›‘å¬æ§åˆ¶


**âš¡ å¹¶å‘æ•°é‡è®¾ç½®**
```java
@Configuration
@EnableRabbit
public class RabbitConfig {
    
    @Bean
    public SimpleRabbitListenerContainerFactory rabbitListenerContainerFactory(
            ConnectionFactory connectionFactory) {
        SimpleRabbitListenerContainerFactory factory = 
            new SimpleRabbitListenerContainerFactory();
        factory.setConnectionFactory(connectionFactory);
        
        // è®¾ç½®å¹¶å‘æ•°é‡
        factory.setConcurrentConsumers(2);     // æœ€å°‘2ä¸ªæ¶ˆè´¹è€…
        factory.setMaxConcurrentConsumers(5);  // æœ€å¤š5ä¸ªæ¶ˆè´¹è€…
        
        return factory;
    }
}

// åœ¨ç›‘å¬å™¨ä¸­æŒ‡å®šå¹¶å‘æ•°
@RabbitListener(
    queues = "high-volume-queue",
    concurrency = "3-10"  // 3åˆ°10ä¸ªå¹¶å‘æ¶ˆè´¹è€…
)
public void handleHighVolume(String message) {
    // å¤„ç†å¤§é‡æ¶ˆæ¯
}
```

---

## 4. ğŸ”„ æ¶ˆæ¯è½¬æ¢å™¨é…ç½®


### 4.1 æ¶ˆæ¯è½¬æ¢å™¨çš„ä½œç”¨


**ğŸ”¸ ç®€å•ç†è§£**
æ¶ˆæ¯è½¬æ¢å™¨å°±åƒ"ç¿»è¯‘å®˜"ï¼Œè´Ÿè´£åœ¨Javaå¯¹è±¡å’ŒRabbitMQæ¶ˆæ¯ä¹‹é—´äº’ç›¸ç¿»è¯‘ã€‚

```
å‘é€æ—¶ï¼šJavaå¯¹è±¡ â†’ ç¿»è¯‘ â†’ å­—èŠ‚æ•°ç»„ â†’ RabbitMQ
æ¥æ”¶æ—¶ï¼šRabbitMQ â†’ å­—èŠ‚æ•°ç»„ â†’ ç¿»è¯‘ â†’ Javaå¯¹è±¡

é»˜è®¤ç¿»è¯‘å®˜ï¼šSimpleMessageConverterï¼ˆåªèƒ½å¤„ç†ç®€å•ç±»å‹ï¼‰
å‡çº§ç¿»è¯‘å®˜ï¼šJackson2JsonMessageConverterï¼ˆèƒ½å¤„ç†å¤æ‚å¯¹è±¡ï¼‰
```

### 4.2 é»˜è®¤è½¬æ¢å™¨çš„é™åˆ¶


**âš ï¸ é»˜è®¤è½¬æ¢å™¨é—®é¢˜**
```java
// é»˜è®¤è½¬æ¢å™¨åªèƒ½å¤„ç†è¿™äº›ç±»å‹ï¼š
String message = "hello";           // âœ… å¯ä»¥
byte[] bytes = "hello".getBytes();  // âœ… å¯ä»¥  
User user = new User();             // âŒ ä¸è¡Œï¼ä¼šæŠ¥é”™

// é”™è¯¯ç¤ºä¾‹
@RabbitListener(queues = "user-queue")
public void handleUser(User user) {  // æ”¶ä¸åˆ°ï¼Œä¼šæŠ¥é”™
    System.out.println(user.getName());
}
```

### 4.3 é…ç½®JSONè½¬æ¢å™¨


**ğŸ› ï¸ é…ç½®Jacksonè½¬æ¢å™¨**
```java
@Configuration
@EnableRabbit
public class RabbitConfig {
    
    @Bean
    public RabbitTemplate rabbitTemplate(ConnectionFactory connectionFactory) {
        RabbitTemplate template = new RabbitTemplate(connectionFactory);
        
        // è®¾ç½®JSONè½¬æ¢å™¨
        template.setMessageConverter(new Jackson2JsonMessageConverter());
        
        return template;
    }
    
    @Bean
    public SimpleRabbitListenerContainerFactory rabbitListenerContainerFactory(
            ConnectionFactory connectionFactory) {
        SimpleRabbitListenerContainerFactory factory = 
            new SimpleRabbitListenerContainerFactory();
        factory.setConnectionFactory(connectionFactory);
        
        // ç›‘å¬å™¨ä¹Ÿè¦è®¾ç½®JSONè½¬æ¢å™¨
        factory.setMessageConverter(new Jackson2JsonMessageConverter());
        
        return factory;
    }
}
```

**ğŸ“¦ ç°åœ¨å¯ä»¥å‘é€å¤æ‚å¯¹è±¡äº†**
```java
@Service
public class UserService {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    public void sendUser(User user) {
        // ç°åœ¨å¯ä»¥ç›´æ¥å‘é€Userå¯¹è±¡
        rabbitTemplate.convertAndSend("user-queue", user);
        // è‡ªåŠ¨è½¬æˆJSONï¼š{"name":"å¼ ä¸‰","age":25}
    }
}

@Component
public class UserListener {
    
    @RabbitListener(queues = "user-queue")
    public void handleUser(User user) {
        // è‡ªåŠ¨ä»JSONè½¬æˆUserå¯¹è±¡
        System.out.println("æ”¶åˆ°ç”¨æˆ·ï¼š" + user.getName());
    }
}
```

### 4.4 è‡ªå®šä¹‰è½¬æ¢å™¨


**ğŸ¨ åˆ›å»ºè‡ªå®šä¹‰è½¬æ¢å™¨**
```java
public class CustomMessageConverter implements MessageConverter {
    
    @Override
    public Message toMessage(Object object, MessageProperties properties) {
        // Javaå¯¹è±¡ â†’ æ¶ˆæ¯
        if (object instanceof User) {
            User user = (User) object;
            String json = "è‡ªå®šä¹‰æ ¼å¼ï¼š" + user.getName() + "," + user.getAge();
            return new Message(json.getBytes(), properties);
        }
        return null;
    }
    
    @Override
    public Object fromMessage(Message message) {
        // æ¶ˆæ¯ â†’ Javaå¯¹è±¡
        String content = new String(message.getBody());
        if (content.startsWith("è‡ªå®šä¹‰æ ¼å¼ï¼š")) {
            String[] parts = content.substring(5).split(",");
            User user = new User();
            user.setName(parts[0]);
            user.setAge(Integer.parseInt(parts[1]));
            return user;
        }
        return null;
    }
}
```

### 4.5 æ¶ˆæ¯ç±»å‹è¯†åˆ«


**ğŸ·ï¸ æ·»åŠ ç±»å‹ä¿¡æ¯**
```java
@Configuration
public class RabbitConfig {
    
    @Bean
    public Jackson2JsonMessageConverter jsonMessageConverter() {
        Jackson2JsonMessageConverter converter = new Jackson2JsonMessageConverter();
        
        // æ¶ˆæ¯ä¸­åŒ…å«Javaç±»å‹ä¿¡æ¯
        converter.setCreateMessageIds(true);
        
        return converter;
    }
}

// å‘é€çš„æ¶ˆæ¯ä¼šè‡ªåŠ¨å¸¦ä¸Šç±»å‹ä¿¡æ¯
// æ¥æ”¶æ—¶èƒ½æ­£ç¡®è½¬æ¢æˆå¯¹åº”çš„Javaç±»å‹
```

---

## 5. ğŸ”„ é‡è¯•æœºåˆ¶è®¾è®¡


### 5.1 ä¸ºä»€ä¹ˆéœ€è¦é‡è¯•


**ğŸ”¸ ç°å®åœºæ™¯**
æƒ³è±¡ä¸€ä¸‹è¿™äº›æƒ…å†µï¼š
- ğŸ“Š **æ•°æ®åº“è¿æ¥è¶…æ—¶**ï¼šæ­£åœ¨ä¿å­˜è®¢å•æ—¶æ•°æ®åº“æŒ‚äº†
- ğŸŒ **ç½‘ç»œè¯·æ±‚å¤±è´¥**ï¼šè°ƒç”¨ç¬¬ä¸‰æ–¹APIæ—¶ç½‘ç»œæŠ–åŠ¨
- ğŸ’¾ **æ–‡ä»¶å†™å…¥å¤±è´¥**ï¼šç£ç›˜ç©ºé—´ä¸è¶³å¯¼è‡´å†™å…¥å¤±è´¥

å¦‚æœä¸é‡è¯•ï¼Œè¿™äº›ä¸´æ—¶æ€§é—®é¢˜ä¼šå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ï¼

**âš ï¸ æ²¡æœ‰é‡è¯•çš„åæœ**
```java
@RabbitListener(queues = "order-queue")
public void processOrder(Order order) {
    try {
        orderService.saveOrder(order);  // å¦‚æœè¿™é‡Œå¤±è´¥äº†
    } catch (Exception e) {
        // æ¶ˆæ¯å°±ä¸¢å¤±äº†ï¼è®¢å•æ²¡ä¿å­˜æˆåŠŸ
        System.out.println("è®¢å•å¤„ç†å¤±è´¥ï¼š" + e.getMessage());
    }
}
```

### 5.2 Spring AMQPé‡è¯•é…ç½®


**ğŸ› ï¸ åŸºç¡€é‡è¯•é…ç½®**
```yml
spring:
  rabbitmq:
    listener:
      simple:
        retry:
          enabled: true           # å¼€å¯é‡è¯•
          max-attempts: 3         # æœ€å¤šé‡è¯•3æ¬¡
          initial-interval: 1000  # ç¬¬ä¸€æ¬¡é‡è¯•é—´éš”1ç§’
          multiplier: 2           # æ¯æ¬¡é—´éš”ç¿»å€
          max-interval: 10000     # æœ€å¤§é—´éš”10ç§’
```

**ğŸ“Š é‡è¯•æ—¶é—´è®¡ç®—**
```
ç¬¬1æ¬¡å¤±è´¥ â†’ ç­‰å¾…1ç§’ â†’ ç¬¬1æ¬¡é‡è¯•
ç¬¬2æ¬¡å¤±è´¥ â†’ ç­‰å¾…2ç§’ â†’ ç¬¬2æ¬¡é‡è¯•  
ç¬¬3æ¬¡å¤±è´¥ â†’ ç­‰å¾…4ç§’ â†’ ç¬¬3æ¬¡é‡è¯•
ç¬¬4æ¬¡å¤±è´¥ â†’ ä¸å†é‡è¯•ï¼Œè¿›å…¥æ­»ä¿¡é˜Ÿåˆ—æˆ–ä¸¢å¼ƒ
```

### 5.3 Javaé…ç½®é‡è¯•ç­–ç•¥


**âš™ï¸ ä»£ç é…ç½®é‡è¯•**
```java
@Configuration
@EnableRabbit
public class RabbitRetryConfig {
    
    @Bean
    public SimpleRabbitListenerContainerFactory rabbitListenerContainerFactory(
            ConnectionFactory connectionFactory) {
        SimpleRabbitListenerContainerFactory factory = 
            new SimpleRabbitListenerContainerFactory();
        factory.setConnectionFactory(connectionFactory);
        
        // é…ç½®é‡è¯•ç­–ç•¥
        RetryTemplate retryTemplate = new RetryTemplate();
        
        // å›ºå®šé—´éš”é‡è¯•ç­–ç•¥
        FixedBackOffPolicy backOffPolicy = new FixedBackOffPolicy();
        backOffPolicy.setBackOffPeriod(2000);  // æ¯æ¬¡é‡è¯•é—´éš”2ç§’
        retryTemplate.setBackOffPolicy(backOffPolicy);
        
        // é‡è¯•æ¬¡æ•°ç­–ç•¥
        SimpleRetryPolicy retryPolicy = new SimpleRetryPolicy();
        retryPolicy.setMaxAttempts(3);  // æœ€å¤šé‡è¯•3æ¬¡
        retryTemplate.setRetryPolicy(retryPolicy);
        
        factory.setRetryTemplate(retryTemplate);
        
        return factory;
    }
}
```

### 5.4 æŒ‡æ•°é€€é¿é‡è¯•


**ğŸ“ˆ æ™ºèƒ½é‡è¯•é—´éš”**
```java
@Bean
public RetryTemplate retryTemplate() {
    RetryTemplate retryTemplate = new RetryTemplate();
    
    // æŒ‡æ•°é€€é¿ç­–ç•¥ï¼ˆé—´éš”è¶Šæ¥è¶Šé•¿ï¼‰
    ExponentialBackOffPolicy backOffPolicy = new ExponentialBackOffPolicy();
    backOffPolicy.setInitialInterval(1000);    // åˆå§‹é—´éš”1ç§’
    backOffPolicy.setMultiplier(2.0);          // æ¯æ¬¡ç¿»å€
    backOffPolicy.setMaxInterval(30000);       // æœ€å¤§é—´éš”30ç§’
    retryTemplate.setBackOffPolicy(backOffPolicy);
    
    // åªé‡è¯•ç‰¹å®šå¼‚å¸¸
    Map<Class<? extends Throwable>, Boolean> retryableExceptions = 
        new HashMap<>();
    retryableExceptions.put(DataAccessException.class, true);   // æ•°æ®åº“å¼‚å¸¸é‡è¯•
    retryableExceptions.put(ConnectException.class, true);      // è¿æ¥å¼‚å¸¸é‡è¯•
    retryableExceptions.put(IllegalArgumentException.class, false); // å‚æ•°å¼‚å¸¸ä¸é‡è¯•
    
    SimpleRetryPolicy retryPolicy = new SimpleRetryPolicy(3, retryableExceptions);
    retryTemplate.setRetryPolicy(retryPolicy);
    
    return retryTemplate;
}
```

### 5.5 é‡è¯•å¤±è´¥åçš„å¤„ç†


**ğŸš¨ æœ€ç»ˆå¤±è´¥å¤„ç†**
```java
@Configuration
public class RabbitConfig {
    
    @Bean
    public SimpleRabbitListenerContainerFactory rabbitListenerContainerFactory(
            ConnectionFactory connectionFactory) {
        SimpleRabbitListenerContainerFactory factory = 
            new SimpleRabbitListenerContainerFactory();
        factory.setConnectionFactory(connectionFactory);
        
        // é‡è¯•é…ç½®
        RetryTemplate retryTemplate = createRetryTemplate();
        factory.setRetryTemplate(retryTemplate);
        
        // é‡è¯•å¤±è´¥åçš„å¤„ç†ç­–ç•¥
        factory.setRecoveryCallback(context -> {
            // è·å–å¤±è´¥çš„æ¶ˆæ¯
            Message failedMessage = (Message) context.getAttribute("message");
            Exception lastException = context.getLastThrowable();
            
            // è®°å½•å¤±è´¥æ—¥å¿—
            System.err.println("æ¶ˆæ¯æœ€ç»ˆå¤„ç†å¤±è´¥ï¼š" + lastException.getMessage());
            
            // å‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—æˆ–è€…ä¿å­˜åˆ°æ•°æ®åº“
            sendToDeadLetterQueue(failedMessage);
            
            return null;
        });
        
        return factory;
    }
    
    private void sendToDeadLetterQueue(Message message) {
        // å‘é€åˆ°ä¸“é—¨å¤„ç†å¤±è´¥æ¶ˆæ¯çš„é˜Ÿåˆ—
        rabbitTemplate.send("dead-letter-exchange", "failed", message);
    }
}
```

### 5.6 ç›‘å¬å™¨çº§åˆ«çš„é‡è¯•


**ğŸ¯ é’ˆå¯¹ç‰¹å®šç›‘å¬å™¨çš„é‡è¯•**
```java
@Component
public class OrderListener {
    
    // é‡è¦è®¢å•ï¼šé‡è¯•å¤šæ¬¡
    @RabbitListener(
        queues = "important-orders",
        containerFactory = "highRetryContainerFactory"  // ä½¿ç”¨é«˜é‡è¯•æ¬¡æ•°çš„å·¥å‚
    )
    public void handleImportantOrder(Order order) {
        orderService.processImportantOrder(order);
    }
    
    // æ™®é€šæ¶ˆæ¯ï¼šé‡è¯•å°‘æ¬¡
    @RabbitListener(
        queues = "normal-messages", 
        containerFactory = "normalRetryContainerFactory"  // ä½¿ç”¨æ™®é€šé‡è¯•æ¬¡æ•°çš„å·¥å‚
    )
    public void handleNormalMessage(String message) {
        messageService.processMessage(message);
    }
}
```

---

## 6. âš ï¸ å¼‚å¸¸å¤„ç†ç­–ç•¥


### 6.1 å¼‚å¸¸å¤„ç†çš„é‡è¦æ€§


**ğŸ”¸ ä¸ºä»€ä¹ˆè¦å¤„ç†å¼‚å¸¸**
åœ¨æ¶ˆæ¯å¤„ç†ä¸­ï¼Œå¼‚å¸¸å¦‚æœä¸å¦¥å–„å¤„ç†ï¼Œä¼šå¯¼è‡´ï¼š
- ğŸ’€ **æ¶ˆæ¯ä¸¢å¤±**ï¼šå¼‚å¸¸åæ¶ˆæ¯å¯èƒ½è¢«ä¸¢å¼ƒ
- ğŸ”„ **æ— é™é‡è¯•**ï¼šä¸€ç›´é‡è¯•å¯¼è‡´é˜Ÿåˆ—é˜»å¡
- ğŸ’¥ **ç³»ç»Ÿå´©æºƒ**ï¼šå¼‚å¸¸ä¼ æ’­å¯¼è‡´æ•´ä¸ªåº”ç”¨æŒ‚æ‰

**ğŸ“Š å¼‚å¸¸ç±»å‹åˆ†æ**
```
ä¸šåŠ¡å¼‚å¸¸ï¼ˆå¯é‡è¯•ï¼‰ï¼š
â”œâ”€â”€ æ•°æ®åº“è¿æ¥è¶…æ—¶     â†’ é‡è¯•æœ‰æ„ä¹‰
â”œâ”€â”€ ç½‘ç»œè¯·æ±‚å¤±è´¥       â†’ é‡è¯•æœ‰æ„ä¹‰
â””â”€â”€ æ–‡ä»¶è¯»å†™å¤±è´¥       â†’ é‡è¯•æœ‰æ„ä¹‰

é€»è¾‘å¼‚å¸¸ï¼ˆä¸å¯é‡è¯•ï¼‰ï¼š
â”œâ”€â”€ å‚æ•°æ ¡éªŒå¤±è´¥       â†’ é‡è¯•æ— æ„ä¹‰
â”œâ”€â”€ æ•°æ®æ ¼å¼é”™è¯¯       â†’ é‡è¯•æ— æ„ä¹‰
â””â”€â”€ ä¸šåŠ¡è§„åˆ™è¿å       â†’ é‡è¯•æ— æ„ä¹‰
```

### 6.2 ç›‘å¬å™¨å¼‚å¸¸å¤„ç†


**ğŸ›¡ï¸ åŸºç¡€å¼‚å¸¸æ•è·**
```java
@Component
public class SafeMessageListener {
    
    @RabbitListener(queues = "user-actions")
    public void handleUserAction(String action) {
        try {
            // ä¸šåŠ¡å¤„ç†é€»è¾‘
            userService.processAction(action);
            
        } catch (IllegalArgumentException e) {
            // å‚æ•°é”™è¯¯ï¼Œè®°å½•æ—¥å¿—ï¼Œä¸é‡è¯•
            log.error("ç”¨æˆ·è¡Œä¸ºå‚æ•°é”™è¯¯ï¼š{}, æ¶ˆæ¯ï¼š{}", e.getMessage(), action);
            
        } catch (DataAccessException e) {
            // æ•°æ®åº“å¼‚å¸¸ï¼Œåº”è¯¥é‡è¯•
            log.warn("æ•°æ®åº“è®¿é—®å¼‚å¸¸ï¼Œå°†é‡è¯•ï¼š{}", e.getMessage());
            throw e;  // é‡æ–°æŠ›å‡ºï¼Œè§¦å‘é‡è¯•æœºåˆ¶
            
        } catch (Exception e) {
            // å…¶ä»–æœªçŸ¥å¼‚å¸¸
            log.error("å¤„ç†ç”¨æˆ·è¡Œä¸ºæ—¶å‘ç”ŸæœªçŸ¥å¼‚å¸¸ï¼š{}, æ¶ˆæ¯ï¼š{}", e.getMessage(), action);
            // å†³å®šæ˜¯å¦é‡è¯•è¿˜æ˜¯ä¸¢å¼ƒ
            handleUnknownException(e, action);
        }
    }
    
    private void handleUnknownException(Exception e, String action) {
        // æ ¹æ®å¼‚å¸¸ç±»å‹å†³å®šå¤„ç†ç­–ç•¥
        if (e instanceof RuntimeException) {
            // è¿è¡Œæ—¶å¼‚å¸¸ï¼Œå¯èƒ½æ˜¯ä¸´æ—¶é—®é¢˜ï¼Œé‡è¯•
            throw e;
        } else {
            // å…¶ä»–å¼‚å¸¸ï¼Œè®°å½•åä¸¢å¼ƒ
            saveFailedMessage(action, e.getMessage());
        }
    }
}
```

### 6.3 å…¨å±€å¼‚å¸¸å¤„ç†å™¨


**ğŸŒ ç»Ÿä¸€å¼‚å¸¸å¤„ç†**
```java
@Component
public class GlobalRabbitExceptionHandler implements RabbitListenerErrorHandler {
    
    @Override
    public Object handleError(Message amqpMessage, org.springframework.messaging.Message<?> message, 
                             ListenerExecutionFailedException exception) {
        
        // è·å–å¼‚å¸¸ä¿¡æ¯
        String queueName = amqpMessage.getMessageProperties().getConsumerQueue();
        Object payload = message.getPayload();
        Throwable cause = exception.getCause();
        
        log.error("é˜Ÿåˆ— {} å¤„ç†æ¶ˆæ¯å¤±è´¥ï¼Œæ¶ˆæ¯å†…å®¹ï¼š{}, å¼‚å¸¸ï¼š{}", 
                 queueName, payload, cause.getMessage());
        
        // æ ¹æ®å¼‚å¸¸ç±»å‹å†³å®šå¤„ç†ç­–ç•¥
        if (cause instanceof IllegalArgumentException) {
            // å‚æ•°å¼‚å¸¸ï¼Œå‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—
            sendToDeadLetterQueue(amqpMessage, "INVALID_ARGUMENT");
            
        } else if (cause instanceof DataAccessException) {
            // æ•°æ®åº“å¼‚å¸¸ï¼Œè®°å½•åé‡è¯•ï¼ˆé€šè¿‡æŠ›å‡ºå¼‚å¸¸ï¼‰
            log.warn("æ•°æ®åº“å¼‚å¸¸ï¼Œæ¶ˆæ¯å°†è¢«é‡è¯•");
            throw exception;
            
        } else {
            // æœªçŸ¥å¼‚å¸¸ï¼Œä¿å­˜é”™è¯¯ä¿¡æ¯
            saveErrorLog(queueName, payload, cause);
        }
        
        return null;
    }
}

// åœ¨ç›‘å¬å™¨ä¸­ä½¿ç”¨å…¨å±€å¼‚å¸¸å¤„ç†å™¨
@RabbitListener(queues = "orders", errorHandler = "globalRabbitExceptionHandler")
public void handleOrder(Order order) {
    orderService.processOrder(order);
}
```

### 6.4 æ­»ä¿¡é˜Ÿåˆ—å¼‚å¸¸å¤„ç†


**â˜ ï¸ é…ç½®æ­»ä¿¡é˜Ÿåˆ—**
```java
@Configuration
public class DeadLetterConfig {
    
    // æ™®é€šé˜Ÿåˆ—
    @Bean
    public Queue normalQueue() {
        return QueueBuilder.durable("normal-queue")
                .withArgument("x-dead-letter-exchange", "dlx-exchange")  // æ­»ä¿¡äº¤æ¢æœº
                .withArgument("x-dead-letter-routing-key", "failed")     // æ­»ä¿¡è·¯ç”±é”®
                .build();
    }
    
    // æ­»ä¿¡äº¤æ¢æœº
    @Bean
    public DirectExchange deadLetterExchange() {
        return new DirectExchange("dlx-exchange");
    }
    
    // æ­»ä¿¡é˜Ÿåˆ—
    @Bean
    public Queue deadLetterQueue() {
        return QueueBuilder.durable("dead-letter-queue").build();
    }
    
    // ç»‘å®šæ­»ä¿¡é˜Ÿåˆ—
    @Bean
    public Binding deadLetterBinding() {
        return BindingBuilder.bind(deadLetterQueue())
                .to(deadLetterExchange())
                .with("failed");
    }
}
```

**ğŸ¥ æ­»ä¿¡é˜Ÿåˆ—ç›‘å¬å¤„ç†**
```java
@Component
public class DeadLetterHandler {
    
    @RabbitListener(queues = "dead-letter-queue")
    public void handleDeadLetter(Message message) {
        // è·å–å¤±è´¥åŸå› 
        Map<String, Object> headers = message.getMessageProperties().getHeaders();
        String reason = (String) headers.get("x-first-death-reason");
        
        log.error("æ”¶åˆ°æ­»ä¿¡æ¶ˆæ¯ï¼Œå¤±è´¥åŸå› ï¼š{}", reason);
        
        // æ ¹æ®å¤±è´¥åŸå› å†³å®šå¤„ç†æ–¹å¼
        switch (reason) {
            case "rejected":
                // æ¶ˆæ¯è¢«æ‹’ç»ï¼Œå¯èƒ½æ˜¯ä¸šåŠ¡é€»è¾‘é—®é¢˜
                handleRejectedMessage(message);
                break;
                
            case "expired":
                // æ¶ˆæ¯è¿‡æœŸï¼Œå¯èƒ½éœ€è¦é‡æ–°å‘é€
                handleExpiredMessage(message);
                break;
                
            default:
                // å…¶ä»–åŸå› ï¼Œä¿å­˜åˆ°æ•°æ®åº“ç­‰å¾…äººå·¥å¤„ç†
                saveForManualProcessing(message);
        }
    }
    
    private void handleRejectedMessage(Message message) {
        // åˆ†ææ¶ˆæ¯å†…å®¹ï¼Œå°è¯•ä¿®å¤åé‡æ–°å‘é€
        String content = new String(message.getBody());
        log.info("å°è¯•ä¿®å¤è¢«æ‹’ç»çš„æ¶ˆæ¯ï¼š{}", content);
        
        // ä¿®å¤é€»è¾‘...
        // é‡æ–°å‘é€åˆ°åŸé˜Ÿåˆ—
    }
}
```

### 6.5 å¼‚å¸¸åˆ†ç±»å¤„ç†ç­–ç•¥


**ğŸ“‹ å¼‚å¸¸å¤„ç†å†³ç­–è¡¨**

| å¼‚å¸¸ç±»å‹ | å¤„ç†ç­–ç•¥ | æ˜¯å¦é‡è¯• | å¤‡æ³¨ |
|----------|----------|----------|------|
| `IllegalArgumentException` | è®°å½•æ—¥å¿— + æ­»ä¿¡é˜Ÿåˆ— | âŒ å¦ | å‚æ•°é”™è¯¯ï¼Œé‡è¯•æ— æ„ä¹‰ |
| `DataAccessException` | è®°å½•æ—¥å¿— + é‡è¯• | âœ… æ˜¯ | æ•°æ®åº“é—®é¢˜ï¼Œå¯èƒ½æ¢å¤ |
| `ConnectException` | è®°å½•æ—¥å¿— + é‡è¯• | âœ… æ˜¯ | ç½‘ç»œé—®é¢˜ï¼Œå¯èƒ½æ¢å¤ |
| `JsonProcessingException` | è®°å½•æ—¥å¿— + æ­»ä¿¡é˜Ÿåˆ— | âŒ å¦ | JSONæ ¼å¼é”™è¯¯ |
| `BusinessException` | è®°å½•æ—¥å¿— + æ­»ä¿¡é˜Ÿåˆ— | âŒ å¦ | ä¸šåŠ¡è§„åˆ™è¿å |
| `TimeoutException` | è®°å½•æ—¥å¿— + é‡è¯• | âœ… æ˜¯ | è¶…æ—¶é—®é¢˜ï¼Œå¯èƒ½æ¢å¤ |

**ğŸ¯ å®ç°å¼‚å¸¸åˆ†ç±»å¤„ç†**
```java
@Component
public class SmartExceptionHandler {
    
    @RabbitListener(queues = "smart-queue")
    public void handleMessage(String message) {
        try {
            businessService.process(message);
            
        } catch (Exception e) {
            ExceptionStrategy strategy = getExceptionStrategy(e);
            strategy.handle(e, message);
        }
    }
    
    private ExceptionStrategy getExceptionStrategy(Exception e) {
        if (e instanceof IllegalArgumentException) {
            return new NoRetryStrategy();      // ä¸é‡è¯•ç­–ç•¥
        } else if (e instanceof DataAccessException) {
            return new RetryStrategy(3);       // é‡è¯•3æ¬¡ç­–ç•¥
        } else if (e instanceof ConnectException) {
            return new ExponentialRetryStrategy(); // æŒ‡æ•°é€€é¿é‡è¯•
        } else {
            return new DefaultStrategy();      // é»˜è®¤ç­–ç•¥
        }
    }
}
```

---

## 7. ğŸ’¾ äº‹åŠ¡æ”¯æŒ


### 7.1 ä»€ä¹ˆæ˜¯RabbitMQäº‹åŠ¡


**ğŸ”¸ ç®€å•ç†è§£**
RabbitMQäº‹åŠ¡å°±åƒé“¶è¡Œè½¬è´¦ï¼šè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ï¼Œä¸ä¼šå‡ºç°è½¬å‡ºæˆåŠŸä½†è½¬å…¥å¤±è´¥çš„æƒ…å†µã€‚

```
æ²¡æœ‰äº‹åŠ¡çš„é—®é¢˜ï¼š
1. å‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ—A âœ… æˆåŠŸ
2. å‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ—B âŒ å¤±è´¥
3. æ›´æ–°æ•°æ®åº“çŠ¶æ€ âœ… æˆåŠŸ

ç»“æœï¼šæ•°æ®ä¸ä¸€è‡´ï¼

æœ‰äº‹åŠ¡çš„æ•ˆæœï¼š
1. å¼€å§‹äº‹åŠ¡
2. å‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ—A
3. å‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ—B  â† å¦‚æœè¿™é‡Œå¤±è´¥
4. æ›´æ–°æ•°æ®åº“çŠ¶æ€
5. æäº¤äº‹åŠ¡ â† å…¨éƒ¨å›æ»šï¼Œä¿è¯ä¸€è‡´æ€§
```

### 7.2 Spring AMQPäº‹åŠ¡é…ç½®


**âš™ï¸ å¼€å¯äº‹åŠ¡æ”¯æŒ**
```java
@Configuration
@EnableRabbit
@EnableTransactionManagement  // å¼€å¯Springäº‹åŠ¡ç®¡ç†
public class RabbitTransactionConfig {
    
    @Bean
    public RabbitTransactionManager rabbitTransactionManager(
            ConnectionFactory connectionFactory) {
        return new RabbitTransactionManager(connectionFactory);
    }
    
    @Bean
    public RabbitTemplate rabbitTemplate(ConnectionFactory connectionFactory) {
        RabbitTemplate template = new RabbitTemplate(connectionFactory);
        
        // å¼€å¯äº‹åŠ¡æ¨¡å¼
        template.setChannelTransacted(true);
        
        return template;
    }
}
```

**ğŸ“Š é…ç½®æ–‡ä»¶å¼€å¯äº‹åŠ¡**
```yml
spring:
  rabbitmq:
    template:
      transacted: true        # å¼€å¯RabbitTemplateäº‹åŠ¡
    listener:
      simple:
        transacted: true      # å¼€å¯ç›‘å¬å™¨äº‹åŠ¡
        acknowledge-mode: auto # è‡ªåŠ¨ç¡®è®¤æ¨¡å¼
```

### 7.3 å£°æ˜å¼äº‹åŠ¡ä½¿ç”¨


**ğŸ¯ @Transactionalæ³¨è§£**
```java
@Service
public class OrderService {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    @Autowired
    private OrderRepository orderRepository;
    
    // å£°æ˜å¼äº‹åŠ¡ï¼šåŒ…å«æ•°æ®åº“å’ŒMQæ“ä½œ
    @Transactional(rollbackFor = Exception.class)
    public void processOrder(Order order) {
        try {
            // 1. ä¿å­˜è®¢å•åˆ°æ•°æ®åº“
            orderRepository.save(order);
            
            // 2. å‘é€è®¢å•åˆ›å»ºäº‹ä»¶
            rabbitTemplate.convertAndSend(
                "order-events", 
                "order.created", 
                order
            );
            
            // 3. å‘é€åº“å­˜æ‰£å‡æ¶ˆæ¯
            rabbitTemplate.convertAndSend(
                "inventory-commands",
                "inventory.decrease",
                new InventoryCommand(order.getProductId(), order.getQuantity())
            );
            
            // 4. å‘é€æ”¯ä»˜è¯·æ±‚
            rabbitTemplate.convertAndSend(
                "payment-requests",
                "payment.request",
                new PaymentRequest(order.getId(), order.getAmount())
            );
            
            // å¦‚æœä»»ä½•ä¸€æ­¥å¤±è´¥ï¼Œæ‰€æœ‰æ“ä½œéƒ½ä¼šå›æ»š
            
        } catch (Exception e) {
            log.error("è®¢å•å¤„ç†å¤±è´¥ï¼Œäº‹åŠ¡å°†å›æ»šï¼š{}", e.getMessage());
            throw e;  // è§¦å‘äº‹åŠ¡å›æ»š
        }
    }
}
```

### 7.4 ç¼–ç¨‹å¼äº‹åŠ¡ä½¿ç”¨


**ğŸ”§ æ‰‹åŠ¨æ§åˆ¶äº‹åŠ¡**
```java
@Service
public class PaymentService {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    @Autowired
    private PlatformTransactionManager transactionManager;
    
    public void processPayment(Payment payment) {
        // æ‰‹åŠ¨åˆ›å»ºäº‹åŠ¡
        TransactionDefinition def = new DefaultTransactionDefinition();
        TransactionStatus status = transactionManager.getTransaction(def);
        
        try {
            // ä¸šåŠ¡é€»è¾‘
            validatePayment(payment);
            
            // å‘é€æ”¯ä»˜æˆåŠŸæ¶ˆæ¯
            rabbitTemplate.convertAndSend(
                "payment-events",
                "payment.success", 
                payment
            );
            
            // å‘é€é€šçŸ¥æ¶ˆæ¯
            rabbitTemplate.convertAndSend(
                "notifications",
                "user.notify",
                "æ”¯ä»˜æˆåŠŸï¼š" + payment.getAmount()
            );
            
            // æ‰‹åŠ¨æäº¤äº‹åŠ¡
            transactionManager.commit(status);
            
        } catch (Exception e) {
            // æ‰‹åŠ¨å›æ»šäº‹åŠ¡
            transactionManager.rollback(status);
            log.error("æ”¯ä»˜å¤„ç†å¤±è´¥ï¼š{}", e.getMessage());
            throw e;
        }
    }
}
```

### 7.5 æ¶ˆè´¹è€…äº‹åŠ¡å¤„ç†


**ğŸ“¨ æ¶ˆè´¹æ¶ˆæ¯çš„äº‹åŠ¡**
```java
@Component
public class TransactionalConsumer {
    
    @Autowired
    private OrderService orderService;
    
    @Autowired
    private EmailService emailService;
    
    // æ¶ˆè´¹è€…äº‹åŠ¡ï¼šå¤„ç†æ¶ˆæ¯æ—¶çš„äº‹åŠ¡æ§åˆ¶
    @RabbitListener(queues = "order-processing")
    @Transactional(rollbackFor = Exception.class)
    public void handleOrderProcessing(Order order) {
        try {
            // 1. æ›´æ–°è®¢å•çŠ¶æ€
            orderService.updateOrderStatus(order.getId(), "PROCESSING");
            
            // 2. å‘é€ç¡®è®¤é‚®ä»¶
            emailService.sendOrderConfirmation(order);
            
            // 3. å‘é€åç»­å¤„ç†æ¶ˆæ¯
            rabbitTemplate.convertAndSend(
                "order-fulfillment",
                "fulfill.order",
                order
            );
            
            // å¦‚æœä»»ä½•æ­¥éª¤å¤±è´¥ï¼Œæ¶ˆæ¯ä¼šè¢«é‡æ–°æŠ•é€’
            
        } catch (Exception e) {
            log.error("è®¢å•å¤„ç†å¤±è´¥ï¼Œæ¶ˆæ¯å°†é‡è¯•ï¼š{}", e.getMessage());
            throw e;  // æ¶ˆæ¯ä¸ä¼šè¢«ç¡®è®¤ï¼Œä¼šé‡æ–°æŠ•é€’
        }
    }
}
```

### 7.6 äº‹åŠ¡æ€§èƒ½è€ƒè™‘


**âš¡ äº‹åŠ¡ vs ç¡®è®¤æœºåˆ¶æ€§èƒ½å¯¹æ¯”**

| ç‰¹æ€§ | äº‹åŠ¡æ¨¡å¼ | ç¡®è®¤æ¨¡å¼ | å»ºè®®ä½¿ç”¨åœºæ™¯ |
|------|----------|----------|-------------|
| **æ€§èƒ½** | ğŸŒ è¾ƒæ…¢ï¼ˆçº¦é™ä½50%ï¼‰ | ğŸš€ è¾ƒå¿« | é«˜æ€§èƒ½è¦æ±‚ç”¨ç¡®è®¤æ¨¡å¼ |
| **å¯é æ€§** | ğŸ›¡ï¸ éå¸¸é«˜ | ğŸ”’ é«˜ | é«˜å¯é æ€§è¦æ±‚ç”¨äº‹åŠ¡ |
| **å¤æ‚åº¦** | ğŸ“š è¾ƒå¤æ‚ | ğŸ“ ç®€å• | ç®€å•åœºæ™¯ç”¨ç¡®è®¤æ¨¡å¼ |
| **èµ„æºæ¶ˆè€—** | ğŸ’¾ è¾ƒé«˜ | ğŸ’¡ è¾ƒä½ | èµ„æºå—é™ç”¨ç¡®è®¤æ¨¡å¼ |

**ğŸ¯ é€‰æ‹©å»ºè®®**
```java
// é«˜å¯é æ€§åœºæ™¯ï¼šä½¿ç”¨äº‹åŠ¡
@Transactional
public void criticalOperation() {
    // é‡‘èäº¤æ˜“ã€è®¢å•å¤„ç†ç­‰
}

// é«˜æ€§èƒ½åœºæ™¯ï¼šä½¿ç”¨ç¡®è®¤æœºåˆ¶
@RabbitListener(queues = "logs", ackMode = "AUTO")
public void handleLogs(String log) {
    // æ—¥å¿—å¤„ç†ã€ç›‘æ§æ•°æ®ç­‰
}

// å¹³è¡¡åœºæ™¯ï¼šä½¿ç”¨æ‰‹åŠ¨ç¡®è®¤
@RabbitListener(queues = "notifications", ackMode = "MANUAL")
public void handleNotification(String notification, Channel channel, 
                              @Header(AmqpHeaders.DELIVERY_TAG) long tag) {
    try {
        notificationService.send(notification);
        channel.basicAck(tag, false);  // æ‰‹åŠ¨ç¡®è®¤
    } catch (Exception e) {
        channel.basicNack(tag, false, true);  // æ‹’ç»å¹¶é‡æ–°å…¥é˜Ÿ
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Spring AMQPæœ¬è´¨ï¼šSpringä¸ºRabbitMQæä¾›çš„ç®€åŒ–å¼€å‘æ¡†æ¶
ğŸ”¸ RabbitTemplateï¼šå‘é€æ¶ˆæ¯çš„æ ¸å¿ƒå·¥å…·ï¼Œåƒä¸“å±é‚®é€’å‘˜
ğŸ”¸ @RabbitListenerï¼šæ¥æ”¶æ¶ˆæ¯çš„æ³¨è§£ï¼Œè‡ªåŠ¨ç›‘å¬æŒ‡å®šé˜Ÿåˆ—
ğŸ”¸ æ¶ˆæ¯è½¬æ¢å™¨ï¼šJavaå¯¹è±¡ä¸æ¶ˆæ¯é—´çš„ç¿»è¯‘å®˜ï¼Œé»˜è®¤ç”¨JSON
ğŸ”¸ é‡è¯•æœºåˆ¶ï¼šä¸´æ—¶å¤±è´¥æ—¶çš„è‡ªåŠ¨é‡è¯•ï¼Œé¿å…æ¶ˆæ¯ä¸¢å¤±
ğŸ”¸ å¼‚å¸¸å¤„ç†ï¼šåŒºåˆ†å¯é‡è¯•å’Œä¸å¯é‡è¯•å¼‚å¸¸ï¼Œåˆ¶å®šä¸åŒç­–ç•¥
ğŸ”¸ äº‹åŠ¡æ”¯æŒï¼šä¿è¯æ“ä½œçš„åŸå­æ€§ï¼Œè¦ä¹ˆå…¨æˆåŠŸè¦ä¹ˆå…¨å¤±è´¥
```

### 8.2 å…³é”®é…ç½®è¦ç‚¹


**ğŸ› ï¸ åŸºç¡€é…ç½®æ£€æŸ¥æ¸…å•**
- â˜‘ **ä¾èµ–å¼•å…¥**ï¼š`spring-boot-starter-amqp`
- â˜‘ **è¿æ¥é…ç½®**ï¼šhostã€portã€usernameã€password
- â˜‘ **JSONè½¬æ¢å™¨**ï¼š`Jackson2JsonMessageConverter`
- â˜‘ **é‡è¯•ç­–ç•¥**ï¼šenabledã€max-attemptsã€intervals
- â˜‘ **å¼‚å¸¸å¤„ç†**ï¼šå…¨å±€å¤„ç†å™¨æˆ–ç›‘å¬å™¨çº§åˆ«
- â˜‘ **äº‹åŠ¡é…ç½®**ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©å¼€å¯

**ğŸ“Š å¼€å‘æ¨¡å¼é€‰æ‹©**

| åœºæ™¯ç±»å‹ | æ¨èé…ç½® | æ ¸å¿ƒç‰¹ç‚¹ |
|----------|----------|----------|
| **ç®€å•æ¶ˆæ¯** | é»˜è®¤é…ç½® + @RabbitListener | ğŸ”¸ å¿«é€Ÿå¼€å‘<br>ğŸ”¸ è‡ªåŠ¨ç®¡ç† |
| **å¤æ‚å¯¹è±¡** | JSONè½¬æ¢å™¨ + å¯¹è±¡ç›‘å¬ | ğŸ”¸ ç±»å‹å®‰å…¨<br>ğŸ”¸ åºåˆ—åŒ–é€æ˜ |
| **é«˜å¯é æ€§** | äº‹åŠ¡ + é‡è¯• + æ­»ä¿¡é˜Ÿåˆ— | ğŸ”¸ æ•°æ®ä¸€è‡´<br>ğŸ”¸ ä¸ä¸¢æ¶ˆæ¯ |
| **é«˜æ€§èƒ½** | ç¡®è®¤æœºåˆ¶ + å¹¶å‘æ¶ˆè´¹ | ğŸ”¸ ååé‡é«˜<br>ğŸ”¸ å»¶è¿Ÿä½ |

### 8.3 æœ€ä½³å®è·µæŒ‡å—


**ğŸ¯ å‘é€æ¶ˆæ¯æœ€ä½³å®è·µ**
```java
// âœ… å¥½çš„åšæ³•
@Service
public class MessageSender {
    
    public void sendUserEvent(User user, String eventType) {
        UserEvent event = new UserEvent(user, eventType, System.currentTimeMillis());
        
        rabbitTemplate.convertAndSend(
            "user-events",           // æ˜ç¡®çš„äº¤æ¢æœºå
            "user." + eventType,     // æ¸…æ™°çš„è·¯ç”±é”®
            event,                   // ç»“æ„åŒ–çš„æ¶ˆæ¯å¯¹è±¡
            message -> {
                message.getMessageProperties().setMessageId(UUID.randomUUID().toString());
                message.getMessageProperties().setPriority(5);
                return message;
            }
        );
    }
}

// âŒ é¿å…çš„åšæ³•
public void badSend(String data) {
    rabbitTemplate.convertAndSend("queue", data);  // é˜Ÿåˆ—åä¸æ¸…æ™°ï¼Œæ¶ˆæ¯æ ¼å¼ä¸æ˜ç¡®
}
```

**ğŸ‘‚ æ¶ˆè´¹æ¶ˆæ¯æœ€ä½³å®è·µ**
```java
// âœ… å¥½çš„åšæ³•
@Component
public class UserEventListener {
    
    @RabbitListener(
        bindings = @QueueBinding(
            value = @Queue(value = "user-registration-handler", durable = "true"),
            exchange = @Exchange("user-events"),
            key = "user.registered"
        ),
        containerFactory = "userEventContainerFactory"
    )
    public void handleUserRegistration(UserEvent event) {
        try {
            validateEvent(event);
            userService.processRegistration(event.getUser());
            
        } catch (ValidationException e) {
            log.warn("ç”¨æˆ·æ³¨å†Œäº‹ä»¶æ ¼å¼é”™è¯¯ï¼š{}", e.getMessage());
            // ä¸é‡è¯•ï¼Œç›´æ¥ä¸¢å¼ƒæˆ–å‘é€åˆ°æ­»ä¿¡é˜Ÿåˆ—
        } catch (Exception e) {
            log.error("å¤„ç†ç”¨æˆ·æ³¨å†Œå¤±è´¥ï¼Œå°†é‡è¯•ï¼š{}", e.getMessage());
            throw e;  // é‡æ–°æŠ›å‡ºè§¦å‘é‡è¯•
        }
    }
    
    private void validateEvent(UserEvent event) {
        if (event.getUser() == null || event.getEventType() == null) {
            throw new ValidationException("äº‹ä»¶æ•°æ®ä¸å®Œæ•´");
        }
    }
}
```

**ğŸ”§ é…ç½®ç®¡ç†æœ€ä½³å®è·µ**
```java
// âœ… ç¯å¢ƒåŒ–é…ç½®
@Configuration
@EnableRabbit
@Profile("!test")  // æµ‹è¯•ç¯å¢ƒä¸å¯ç”¨
public class RabbitProductionConfig {
    
    @Bean
    @ConditionalOnProperty(name = "app.rabbitmq.high-availability", havingValue = "true")
    public SimpleRabbitListenerContainerFactory highAvailabilityFactory() {
        // é«˜å¯ç”¨é…ç½®ï¼šäº‹åŠ¡ + é‡è¯• + æ­»ä¿¡é˜Ÿåˆ—
    }
    
    @Bean
    @ConditionalOnProperty(name = "app.rabbitmq.high-performance", havingValue = "true") 
    public SimpleRabbitListenerContainerFactory highPerformanceFactory() {
        // é«˜æ€§èƒ½é…ç½®ï¼šå¹¶å‘æ¶ˆè´¹ + æ‰‹åŠ¨ç¡®è®¤
    }
}
```

### 8.4 å¸¸è§é—®é¢˜è§£å†³


**ğŸ› é—®é¢˜è¯Šæ–­æ£€æŸ¥è¡¨**

| é—®é¢˜ç°è±¡ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ¡ˆ |
|----------|----------|----------|
| æ¶ˆæ¯å‘é€å¤±è´¥ | è¿æ¥é…ç½®é”™è¯¯ | æ£€æŸ¥hostã€portã€credentials |
| æ¥æ”¶ä¸åˆ°æ¶ˆæ¯ | é˜Ÿåˆ—ç»‘å®šé”™è¯¯ | æ£€æŸ¥exchangeã€routing-keyã€queue |
| å¯¹è±¡åºåˆ—åŒ–å¤±è´¥ | è½¬æ¢å™¨æœªé…ç½® | é…ç½®Jackson2JsonMessageConverter |
| æ¶ˆæ¯é‡å¤å¤„ç† | é‡è¯•æœºåˆ¶é—®é¢˜ | æ£€æŸ¥é‡è¯•é…ç½®å’Œå¼‚å¸¸å¤„ç† |
| æ€§èƒ½é—®é¢˜ | äº‹åŠ¡æ¨¡å¼å¼€é”€ | è€ƒè™‘ä½¿ç”¨ç¡®è®¤æœºåˆ¶æ›¿ä»£äº‹åŠ¡ |

**ğŸš¨ ç›‘æ§æŒ‡æ ‡å»ºè®®**
- **æ¶ˆæ¯å‘é€æˆåŠŸç‡**ï¼šå‘é€æˆåŠŸ/æ€»å‘é€æ•°
- **æ¶ˆæ¯å¤„ç†å»¶è¿Ÿ**ï¼šä»å‘é€åˆ°å¤„ç†å®Œæˆçš„æ—¶é—´
- **é‡è¯•æ¬¡æ•°ç»Ÿè®¡**ï¼šç›‘æ§å“ªäº›æ¶ˆæ¯éœ€è¦é‡è¯•
- **æ­»ä¿¡é˜Ÿåˆ—å¤§å°**ï¼šç›‘æ§å¤±è´¥æ¶ˆæ¯æ•°é‡
- **æ¶ˆè´¹è€…æ€§èƒ½**ï¼šæ¯ç§’å¤„ç†æ¶ˆæ¯æ•°é‡

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
Spring AMQPå¾ˆç®€å•ï¼ŒRabbitTemplateå‘æ¶ˆæ¯
@RabbitListeneræ¥æ¥æ”¶ï¼ŒJSONè½¬æ¢è¦é…ç½®
é‡è¯•å¼‚å¸¸è¦å¤„ç†ï¼Œäº‹åŠ¡å¯é æ€§èƒ½è¡¡é‡
```