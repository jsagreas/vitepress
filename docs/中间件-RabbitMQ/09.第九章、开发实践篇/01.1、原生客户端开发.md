---
title: 1ã€åŸç”Ÿå®¢æˆ·ç«¯å¼€å‘
---
## ğŸ“š ç›®å½•

1. [åŸç”Ÿå®¢æˆ·ç«¯æ¦‚è¿°](#1-åŸç”Ÿå®¢æˆ·ç«¯æ¦‚è¿°)
2. [ç¯å¢ƒæ­å»ºä¸ä¾èµ–é…ç½®](#2-ç¯å¢ƒæ­å»ºä¸ä¾èµ–é…ç½®)
3. [ConnectionFactoryè¯¦è§£](#3-connectionfactoryè¯¦è§£)
4. [Connectionä¸Channelç®¡ç†](#4-connectionä¸channelç®¡ç†)
5. [åŸºç¡€æ¶ˆæ¯æ“ä½œ](#5-åŸºç¡€æ¶ˆæ¯æ“ä½œ)
6. [å¼‚å¸¸å¤„ç†æœºåˆ¶](#6-å¼‚å¸¸å¤„ç†æœºåˆ¶)
7. [èµ„æºç®¡ç†ç­–ç•¥](#7-èµ„æºç®¡ç†ç­–ç•¥)
8. [çº¿ç¨‹å®‰å…¨é—®é¢˜](#8-çº¿ç¨‹å®‰å…¨é—®é¢˜)
9. [å®è·µæ¡ˆä¾‹](#9-å®è·µæ¡ˆä¾‹)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒŸ åŸç”Ÿå®¢æˆ·ç«¯æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯åŸç”Ÿå®¢æˆ·ç«¯


**ğŸ“‹ åŸºæœ¬æ¦‚å¿µ**
```
RabbitMQåŸç”Ÿå®¢æˆ·ç«¯ï¼š
â€¢ å®˜æ–¹æä¾›çš„Javaå®¢æˆ·ç«¯åº“
â€¢ ç›´æ¥ä½¿ç”¨AMQPåè®®ä¸RabbitMQæœåŠ¡å™¨é€šä¿¡
â€¢ æä¾›æœ€åº•å±‚ã€æœ€çµæ´»çš„æ“ä½œæ¥å£
â€¢ ä¸ä¾èµ–ä»»ä½•æ¡†æ¶ï¼Œå¯ä»¥åœ¨ä»»ä½•Javaé¡¹ç›®ä¸­ä½¿ç”¨
```

**ğŸ¯ ä¸ºä»€ä¹ˆè¦å­¦åŸç”Ÿå®¢æˆ·ç«¯**
- **ç†è§£åº•å±‚åŸç†**ï¼šæŒæ¡RabbitMQçš„æ ¸å¿ƒå·¥ä½œæœºåˆ¶
- **æ¡†æ¶åŸºç¡€**ï¼šSpring AMQPç­‰æ¡†æ¶åº•å±‚éƒ½æ˜¯åŸºäºåŸç”Ÿå®¢æˆ·ç«¯
- **çµæ´»æ§åˆ¶**ï¼šå¯ä»¥ç²¾ç¡®æ§åˆ¶æ¯ä¸€ä¸ªæ“ä½œç»†èŠ‚
- **è½»é‡çº§åº”ç”¨**ï¼šä¸éœ€è¦å¼•å…¥é‡å‹æ¡†æ¶çš„åœºæ™¯

### 1.2 æ ¸å¿ƒç»„ä»¶æ¶æ„


```
RabbitMQ Javaå®¢æˆ·ç«¯æ¶æ„ï¼š

åº”ç”¨ç¨‹åº
    â†“
ConnectionFactory (è¿æ¥å·¥å‚)
    â†“
Connection (TCPè¿æ¥)
    â†“
Channel (é€šé“)
    â†“
Exchangeã€Queueã€Binding (æ¶ˆæ¯è·¯ç”±)
    â†“
Message (æ¶ˆæ¯)
```

**ğŸ”¸ ç»„ä»¶è¯´æ˜**
- **ConnectionFactory**ï¼šè´Ÿè´£åˆ›å»ºåˆ°RabbitMQæœåŠ¡å™¨çš„è¿æ¥
- **Connection**ï¼šä»£è¡¨ä¸€ä¸ªTCPè¿æ¥ï¼Œçº¿ç¨‹å®‰å…¨
- **Channel**ï¼šåœ¨è¿æ¥å†…çš„è™šæ‹Ÿé€šé“ï¼Œå¤§éƒ¨åˆ†æ“ä½œéƒ½åœ¨Channelä¸Šè¿›è¡Œ
- **Exchange/Queue**ï¼šæ¶ˆæ¯è·¯ç”±çš„æ ¸å¿ƒç»„ä»¶

---

## 2. ğŸ“¦ ç¯å¢ƒæ­å»ºä¸ä¾èµ–é…ç½®


### 2.1 Mavenä¾èµ–é…ç½®


```xml
<!-- RabbitMQå®˜æ–¹Javaå®¢æˆ·ç«¯ -->
<dependency>
    <groupId>com.rabbitmq</groupId>
    <artifactId>amqp-client</artifactId>
    <version>5.17.0</version>
</dependency>

<!-- æ—¥å¿—ä¾èµ–ï¼ˆå¯é€‰ä½†æ¨èï¼‰ -->
<dependency>
    <groupId>org.slf4j</groupId>
    <artifactId>slf4j-simple</artifactId>
    <version>1.7.36</version>
</dependency>
```

### 2.2 Gradleä¾èµ–é…ç½®


```gradle
dependencies {
    implementation 'com.rabbitmq:amqp-client:5.17.0'
    implementation 'org.slf4j:slf4j-simple:1.7.36'
}
```

### 2.3 å¿«é€ŸéªŒè¯ç¯å¢ƒ


```java
import com.rabbitmq.client.Connection;
import com.rabbitmq.client.ConnectionFactory;

public class QuickTest {
    public static void main(String[] args) {
        try {
            ConnectionFactory factory = new ConnectionFactory();
            factory.setHost("localhost");
            Connection connection = factory.newConnection();
            System.out.println("âœ… è¿æ¥æˆåŠŸï¼");
            connection.close();
        } catch (Exception e) {
            System.out.println("âŒ è¿æ¥å¤±è´¥ï¼š" + e.getMessage());
        }
    }
}
```

---

## 3. ğŸ”§ ConnectionFactoryè¯¦è§£


### 3.1 åŸºæœ¬é…ç½®


**ğŸ“‹ ConnectionFactoryæ˜¯ä»€ä¹ˆ**
```
ConnectionFactory (è¿æ¥å·¥å‚)ï¼š
â€¢ è´Ÿè´£åˆ›å»ºåˆ°RabbitMQæœåŠ¡å™¨çš„è¿æ¥
â€¢ ç±»ä¼¼äºæ•°æ®åº“è¿æ¥æ± çš„é…ç½®ç±»
â€¢ è®¾ç½®è¿æ¥å‚æ•°ï¼šä¸»æœºã€ç«¯å£ã€ç”¨æˆ·åã€å¯†ç ç­‰
â€¢ ä¸€ä¸ªåº”ç”¨é€šå¸¸åªéœ€è¦ä¸€ä¸ªConnectionFactoryå®ä¾‹
```

```java
// åŸºç¡€é…ç½®ç¤ºä¾‹
ConnectionFactory factory = new ConnectionFactory();

// ğŸ  æœåŠ¡å™¨åœ°å€é…ç½®
factory.setHost("localhost");          // ä¸»æœºåœ°å€
factory.setPort(5672);                 // ç«¯å£å·(é»˜è®¤5672)
factory.setVirtualHost("/");           // è™šæ‹Ÿä¸»æœº(é»˜è®¤"/")

// ğŸ‘¤ è®¤è¯ä¿¡æ¯é…ç½®
factory.setUsername("guest");          // ç”¨æˆ·å(é»˜è®¤guest)
factory.setPassword("guest");          // å¯†ç (é»˜è®¤guest)
```

### 3.2 é«˜çº§é…ç½®å‚æ•°


```java
// ğŸ”„ è¿æ¥è¶…æ—¶è®¾ç½®
factory.setConnectionTimeout(30000);   // è¿æ¥è¶…æ—¶30ç§’
factory.setHandshakeTimeout(10000);    // æ¡æ‰‹è¶…æ—¶10ç§’
factory.setShutdownTimeout(10000);     // å…³é—­è¶…æ—¶10ç§’

// ğŸ’“ å¿ƒè·³æœºåˆ¶
factory.setRequestedHeartbeat(60);     // å¿ƒè·³é—´éš”60ç§’

// ğŸ” è‡ªåŠ¨æ¢å¤æœºåˆ¶
factory.setAutomaticRecoveryEnabled(true);  // å¯ç”¨è‡ªåŠ¨æ¢å¤
factory.setNetworkRecoveryInterval(5000);   // æ¢å¤é—´éš”5ç§’
```

### 3.3 SSL/TLSå®‰å…¨é…ç½®


```java
// ğŸ”’ å¯ç”¨SSLè¿æ¥
factory.useSslProtocol();              // ä½¿ç”¨é»˜è®¤SSL
// æˆ–è€…æŒ‡å®šSSLä¸Šä¸‹æ–‡
// factory.useSslProtocol(sslContext);

// è®¾ç½®SSLç«¯å£
factory.setPort(5671);                 // SSLé»˜è®¤ç«¯å£5671
```

### 3.4 è¿æ¥å·¥å‚æœ€ä½³å®è·µ


```java
public class RabbitMQConfig {
    private static final ConnectionFactory factory = new ConnectionFactory();
    
    static {
        // ğŸ“ åŸºç¡€é…ç½®
        factory.setHost("localhost");
        factory.setPort(5672);
        factory.setUsername("guest");
        factory.setPassword("guest");
        factory.setVirtualHost("/");
        
        // âš¡ æ€§èƒ½ä¼˜åŒ–é…ç½®
        factory.setConnectionTimeout(10000);
        factory.setRequestedHeartbeat(60);
        factory.setAutomaticRecoveryEnabled(true);
    }
    
    public static ConnectionFactory getFactory() {
        return factory;
    }
}
```

---

## 4. ğŸ”— Connectionä¸Channelç®¡ç†


### 4.1 Connectionè¿æ¥ç®¡ç†


**ğŸ“‹ Connectionæ˜¯ä»€ä¹ˆ**
```
Connection (è¿æ¥)ï¼š
â€¢ ä»£è¡¨å®¢æˆ·ç«¯ä¸RabbitMQæœåŠ¡å™¨ä¹‹é—´çš„TCPè¿æ¥
â€¢ ä¸€ä¸ªConnectionå¯ä»¥åŒ…å«å¤šä¸ªChannel
â€¢ çº¿ç¨‹å®‰å…¨ï¼Œå¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹å…±äº«
â€¢ ç±»ä¼¼äºæ•°æ®åº“è¿æ¥ï¼Œéœ€è¦å¦¥å–„ç®¡ç†å…¶ç”Ÿå‘½å‘¨æœŸ
```

```java
// åˆ›å»ºè¿æ¥
ConnectionFactory factory = new ConnectionFactory();
factory.setHost("localhost");

Connection connection = null;
try {
    // ğŸš€ å»ºç«‹è¿æ¥
    connection = factory.newConnection();
    System.out.println("è¿æ¥çŠ¶æ€ï¼š" + (connection.isOpen() ? "å¼€å¯" : "å…³é—­"));
    
} catch (Exception e) {
    System.err.println("è¿æ¥å¤±è´¥ï¼š" + e.getMessage());
} finally {
    // ğŸ”š ç¡®ä¿è¿æ¥å…³é—­
    if (connection != null && connection.isOpen()) {
        try {
            connection.close();
        } catch (Exception e) {
            System.err.println("å…³é—­è¿æ¥å¤±è´¥ï¼š" + e.getMessage());
        }
    }
}
```

### 4.2 Channelé€šé“ç®¡ç†


**ğŸ“‹ Channelæ˜¯ä»€ä¹ˆ**
```
Channel (é€šé“)ï¼š
â€¢ åœ¨Connectionå†…çš„è™šæ‹Ÿé€šé“
â€¢ å¤§éƒ¨åˆ†AMQPæ“ä½œéƒ½åœ¨Channelä¸Šæ‰§è¡Œ
â€¢ è½»é‡çº§ï¼Œåˆ›å»ºå’Œé”€æ¯æˆæœ¬ä½
â€¢ ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ¯ä¸ªçº¿ç¨‹åº”è¯¥ä½¿ç”¨ç‹¬ç«‹çš„Channel
```

```java
Connection connection = factory.newConnection();

// åˆ›å»ºé€šé“
Channel channel = connection.createChannel();

try {
    // åœ¨é€šé“ä¸Šæ‰§è¡Œæ“ä½œ
    channel.queueDeclare("test_queue", false, false, false, null);
    
    // æ£€æŸ¥é€šé“çŠ¶æ€
    if (channel.isOpen()) {
        System.out.println("âœ… é€šé“æ­£å¸¸å·¥ä½œ");
    }
    
} finally {
    // å…³é—­é€šé“
    if (channel.isOpen()) {
        channel.close();
    }
}
```

### 4.3 èµ„æºç®¡ç†æ¨¡å¼


**ğŸ¯ Try-with-resourcesæ¨¡å¼ï¼ˆæ¨èï¼‰**
```java
try (Connection connection = factory.newConnection();
     Channel channel = connection.createChannel()) {
    
    // æ‰§è¡Œä¸šåŠ¡æ“ä½œ
    channel.queueDeclare("my_queue", true, false, false, null);
    channel.basicPublish("", "my_queue", null, "Hello World".getBytes());
    
    // èµ„æºä¼šè‡ªåŠ¨å…³é—­ï¼Œæ— éœ€æ‰‹åŠ¨å¤„ç†
} catch (Exception e) {
    System.err.println("æ“ä½œå¤±è´¥ï¼š" + e.getMessage());
}
```

---

## 5. ğŸ“¨ åŸºç¡€æ¶ˆæ¯æ“ä½œ


### 5.1 é˜Ÿåˆ—å£°æ˜


**ğŸ“‹ é˜Ÿåˆ—å£°æ˜çš„ä½œç”¨**
```
é˜Ÿåˆ—å£°æ˜ (queueDeclare)ï¼š
â€¢ åˆ›å»ºä¸€ä¸ªé˜Ÿåˆ—ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
â€¢ éªŒè¯é˜Ÿåˆ—çš„å±æ€§ï¼ˆå¦‚æœå·²å­˜åœ¨ï¼‰
â€¢ ç¡®ä¿é˜Ÿåˆ—åœ¨ä½¿ç”¨å‰å­˜åœ¨
â€¢ ç±»ä¼¼äºæ•°æ®åº“ä¸­çš„"CREATE TABLE IF NOT EXISTS"
```

```java
try (Connection connection = factory.newConnection();
     Channel channel = connection.createChannel()) {
    
    // ğŸ“ åŸºç¡€é˜Ÿåˆ—å£°æ˜
    channel.queueDeclare(
        "my_queue",    // é˜Ÿåˆ—åç§°
        true,          // durableï¼šæ˜¯å¦æŒä¹…åŒ–
        false,         // exclusiveï¼šæ˜¯å¦æ’ä»–æ€§
        false,         // autoDeleteï¼šæ˜¯å¦è‡ªåŠ¨åˆ é™¤
        null           // argumentsï¼šå…¶ä»–å±æ€§
    );
}
```

**ğŸ”¸ å‚æ•°è¯¦è§£**
- **queue**ï¼šé˜Ÿåˆ—åç§°ï¼Œå¿…é¡»å”¯ä¸€
- **durable**ï¼štrue=æŒä¹…åŒ–ï¼ˆæœåŠ¡å™¨é‡å¯åé˜Ÿåˆ—ä»å­˜åœ¨ï¼‰
- **exclusive**ï¼štrue=æ’ä»–æ€§ï¼ˆåªæœ‰å½“å‰è¿æ¥å¯è®¿é—®ï¼‰
- **autoDelete**ï¼štrue=è‡ªåŠ¨åˆ é™¤ï¼ˆæœ€åä¸€ä¸ªæ¶ˆè´¹è€…æ–­å¼€ååˆ é™¤ï¼‰
- **arguments**ï¼šæ‰©å±•å±æ€§ï¼ˆTTLã€æ­»ä¿¡é˜Ÿåˆ—ç­‰ï¼‰

### 5.2 å‘é€æ¶ˆæ¯


**ğŸ“‹ æ¶ˆæ¯å‘å¸ƒè¿‡ç¨‹**
```
æ¶ˆæ¯å‘å¸ƒæµç¨‹ï¼š
åº”ç”¨ç¨‹åº â†’ Channel â†’ Exchange â†’ Routing â†’ Queue â†’ å­˜å‚¨
```

```java
// ğŸš€ å‘é€ç®€å•æ¶ˆæ¯
String message = "Hello RabbitMQ!";
channel.basicPublish(
    "",              // exchangeï¼šäº¤æ¢æœºåç§°ï¼ˆ""è¡¨ç¤ºé»˜è®¤äº¤æ¢æœºï¼‰
    "my_queue",      // routingKeyï¼šè·¯ç”±é”®ï¼ˆå¯¹äºé»˜è®¤äº¤æ¢æœºï¼Œå°±æ˜¯é˜Ÿåˆ—åï¼‰
    null,            // propsï¼šæ¶ˆæ¯å±æ€§
    message.getBytes("UTF-8")  // bodyï¼šæ¶ˆæ¯å†…å®¹
);
```

**ğŸ“‹ å¸¦å±æ€§çš„æ¶ˆæ¯å‘é€**
```java
// è®¾ç½®æ¶ˆæ¯å±æ€§
AMQP.BasicProperties props = new AMQP.BasicProperties.Builder()
    .messageId("msg_001")
    .timestamp(new Date())
    .expiration("60000")  // 60ç§’åè¿‡æœŸ
    .deliveryMode(2)      // 2=æŒä¹…åŒ–æ¶ˆæ¯
    .build();

channel.basicPublish("", "my_queue", props, "é‡è¦æ¶ˆæ¯".getBytes("UTF-8"));
```

### 5.3 æ¥æ”¶æ¶ˆæ¯


**ğŸ¯ æ‹‰å–æ¨¡å¼ï¼ˆPullï¼‰**
```java
// æ‰‹åŠ¨æ‹‰å–ä¸€æ¡æ¶ˆæ¯
GetResponse response = channel.basicGet("my_queue", true);  // true=è‡ªåŠ¨ç¡®è®¤
if (response != null) {
    String message = new String(response.getBody(), "UTF-8");
    System.out.println("ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯ï¼š" + message);
} else {
    System.out.println("ğŸ“­ é˜Ÿåˆ—ä¸ºç©º");
}
```

**ğŸ¯ æ¨é€æ¨¡å¼ï¼ˆPushï¼‰**
```java
// å®šä¹‰æ¶ˆæ¯å¤„ç†å™¨
DeliverCallback deliverCallback = (consumerTag, delivery) -> {
    String message = new String(delivery.getBody(), "UTF-8");
    System.out.println("ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯ï¼š" + message);
};

// å®šä¹‰å–æ¶ˆå›è°ƒ
CancelCallback cancelCallback = consumerTag -> {
    System.out.println("âŒ æ¶ˆè´¹è€…è¢«å–æ¶ˆï¼š" + consumerTag);
};

// å¼€å§‹æ¶ˆè´¹
channel.basicConsume(
    "my_queue",        // é˜Ÿåˆ—å
    true,              // autoAckï¼šè‡ªåŠ¨ç¡®è®¤
    deliverCallback,   // æ¶ˆæ¯å¤„ç†å›è°ƒ
    cancelCallback     // å–æ¶ˆå›è°ƒ
);
```

---

## 6. âš ï¸ å¼‚å¸¸å¤„ç†æœºåˆ¶


### 6.1 å¸¸è§å¼‚å¸¸ç±»å‹


**ğŸ“‹ RabbitMQå¼‚å¸¸ä½“ç³»**
```
RabbitMQå¼‚å¸¸ç±»å‹ï¼š

ğŸ”¸ IOException
  â””â”€â”€ ç½‘ç»œè¿æ¥é—®é¢˜ã€æœåŠ¡å™¨ä¸å¯è¾¾

ğŸ”¸ AlreadyClosedException  
  â””â”€â”€ åœ¨å·²å…³é—­çš„è¿æ¥/é€šé“ä¸Šæ“ä½œ

ğŸ”¸ ShutdownSignalException
  â””â”€â”€ è¿æ¥/é€šé“è¢«å¼‚å¸¸å…³é—­

ğŸ”¸ TimeoutException
  â””â”€â”€ æ“ä½œè¶…æ—¶

ğŸ”¸ AuthenticationFailureException
  â””â”€â”€ è®¤è¯å¤±è´¥
```

### 6.2 è¿æ¥çº§åˆ«å¼‚å¸¸å¤„ç†


```java
public class ConnectionManager {
    private ConnectionFactory factory;
    
    public Connection createConnection() throws IOException, TimeoutException {
        try {
            Connection connection = factory.newConnection();
            
            // æ·»åŠ å…³é—­ç›‘å¬å™¨
            connection.addShutdownListener(shutdownSignal -> {
                if (!shutdownSignal.isInitiatedByApplication()) {
                    System.err.println("ğŸš¨ è¿æ¥å¼‚å¸¸å…³é—­ï¼š" + shutdownSignal.getReason());
                    // è¿™é‡Œå¯ä»¥å®ç°é‡è¿é€»è¾‘
                }
            });
            
            return connection;
            
        } catch (AuthenticationFailureException e) {
            System.err.println("âŒ è®¤è¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå¯†ç ");
            throw e;
        } catch (IOException e) {
            System.err.println("âŒ ç½‘ç»œè¿æ¥å¤±è´¥ï¼š" + e.getMessage());
            throw e;
        }
    }
}
```

### 6.3 Channelçº§åˆ«å¼‚å¸¸å¤„ç†


```java
public void safeChannelOperation(Channel channel) {
    try {
        // æ‰§è¡Œå¯èƒ½å¤±è´¥çš„æ“ä½œ
        channel.queueDeclare("test_queue", true, false, false, null);
        channel.basicPublish("", "test_queue", null, "test".getBytes());
        
    } catch (AlreadyClosedException e) {
        System.err.println("âŒ é€šé“å·²å…³é—­ï¼Œæ— æ³•æ‰§è¡Œæ“ä½œ");
        // é‡æ–°åˆ›å»ºé€šé“
        
    } catch (IOException e) {
        System.err.println("âŒ IOå¼‚å¸¸ï¼š" + e.getMessage());
        // æ ¹æ®å…·ä½“é”™è¯¯ç±»å‹å¤„ç†
        
    } catch (Exception e) {
        System.err.println("âŒ æœªçŸ¥å¼‚å¸¸ï¼š" + e.getMessage());
    }
}
```

### 6.4 ä¼˜é›…çš„å¼‚å¸¸å¤„ç†æ¨¡å¼


```java
public class RabbitMQTemplate {
    private ConnectionFactory factory;
    
    public <T> T execute(ChannelCallback<T> callback) {
        Connection connection = null;
        Channel channel = null;
        
        try {
            connection = factory.newConnection();
            channel = connection.createChannel();
            
            return callback.doInRabbit(channel);
            
        } catch (Exception e) {
            System.err.println("ğŸš¨ æ“ä½œå¤±è´¥ï¼š" + e.getMessage());
            return null;
            
        } finally {
            // å®‰å…¨å…³é—­èµ„æº
            closeQuietly(channel);
            closeQuietly(connection);
        }
    }
    
    private void closeQuietly(AutoCloseable resource) {
        if (resource != null) {
            try {
                resource.close();
            } catch (Exception e) {
                // é™é»˜å…³é—­ï¼Œè®°å½•æ—¥å¿—
                System.err.println("âš ï¸ å…³é—­èµ„æºæ—¶å‘ç”Ÿå¼‚å¸¸ï¼š" + e.getMessage());
            }
        }
    }
    
    @FunctionalInterface
    public interface ChannelCallback<T> {
        T doInRabbit(Channel channel) throws Exception;
    }
}
```

---

## 7. ğŸ›¡ï¸ èµ„æºç®¡ç†ç­–ç•¥


### 7.1 è¿æ¥æ± ç®¡ç†


**ğŸ“‹ ä¸ºä»€ä¹ˆéœ€è¦è¿æ¥æ± **
```
è¿æ¥æ± çš„ä½œç”¨ï¼š
â€¢ Connectionåˆ›å»ºæˆæœ¬é«˜ï¼ˆTCPè¿æ¥+è®¤è¯ï¼‰
â€¢ é¿å…é¢‘ç¹åˆ›å»ºå’Œé”€æ¯è¿æ¥
â€¢ æ§åˆ¶è¿æ¥æ•°é‡ï¼Œé˜²æ­¢èµ„æºè€—å°½
â€¢ æä¾›è¿æ¥å¤ç”¨ï¼Œæå‡æ€§èƒ½
```

```java
public class ConnectionPool {
    private final Queue<Connection> pool = new ConcurrentLinkedQueue<>();
    private final ConnectionFactory factory;
    private final int maxConnections;
    private final AtomicInteger currentConnections = new AtomicInteger(0);
    
    public ConnectionPool(ConnectionFactory factory, int maxConnections) {
        this.factory = factory;
        this.maxConnections = maxConnections;
    }
    
    public Connection borrowConnection() throws IOException, TimeoutException {
        Connection connection = pool.poll();
        
        if (connection == null || !connection.isOpen()) {
            if (currentConnections.get() < maxConnections) {
                connection = factory.newConnection();
                currentConnections.incrementAndGet();
            } else {
                throw new RuntimeException("è¿æ¥æ± å·²æ»¡ï¼Œæ— æ³•åˆ›å»ºæ–°è¿æ¥");
            }
        }
        
        return connection;
    }
    
    public void returnConnection(Connection connection) {
        if (connection != null && connection.isOpen()) {
            pool.offer(connection);
        }
    }
}
```

### 7.2 Channelç®¡ç†ç­–ç•¥


**ğŸ¯ ThreadLocalæ¨¡å¼**
```java
public class ChannelManager {
    private static final ThreadLocal<Channel> channelHolder = new ThreadLocal<>();
    private final Connection connection;
    
    public ChannelManager(Connection connection) {
        this.connection = connection;
    }
    
    public Channel getCurrentChannel() throws IOException {
        Channel channel = channelHolder.get();
        
        if (channel == null || !channel.isOpen()) {
            channel = connection.createChannel();
            channelHolder.set(channel);
        }
        
        return channel;
    }
    
    public void closeCurrentChannel() {
        Channel channel = channelHolder.get();
        if (channel != null) {
            try {
                channel.close();
            } catch (Exception e) {
                // è®°å½•æ—¥å¿—
            } finally {
                channelHolder.remove();
            }
        }
    }
}
```

### 7.3 èµ„æºç”Ÿå‘½å‘¨æœŸç®¡ç†


```java
public class RabbitMQManager implements AutoCloseable {
    private final ConnectionFactory factory;
    private final List<Connection> connections = new ArrayList<>();
    
    public RabbitMQManager() {
        this.factory = new ConnectionFactory();
        // é…ç½®factory...
        
        // æ³¨å†Œå…³é—­é’©å­
        Runtime.getRuntime().addShutdownHook(new Thread(this::close));
    }
    
    public Connection createConnection() throws IOException, TimeoutException {
        Connection connection = factory.newConnection();
        connections.add(connection);
        return connection;
    }
    
    @Override
    public void close() {
        System.out.println("ğŸ”„ æ­£åœ¨å…³é—­RabbitMQè¿æ¥...");
        
        for (Connection connection : connections) {
            try {
                if (connection.isOpen()) {
                    connection.close();
                }
            } catch (Exception e) {
                System.err.println("âš ï¸ å…³é—­è¿æ¥å¤±è´¥ï¼š" + e.getMessage());
            }
        }
        
        connections.clear();
        System.out.println("âœ… æ‰€æœ‰è¿æ¥å·²å…³é—­");
    }
}
```

---

## 8. ğŸ”’ çº¿ç¨‹å®‰å…¨é—®é¢˜


### 8.1 çº¿ç¨‹å®‰å…¨æ€§åˆ†æ


**ğŸ“‹ RabbitMQå®¢æˆ·ç«¯çº¿ç¨‹å®‰å…¨æ€§**
```
ç»„ä»¶çº¿ç¨‹å®‰å…¨æ€§ï¼š

âœ… ConnectionFactoryï¼šçº¿ç¨‹å®‰å…¨
   å¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹å…±äº«ä½¿ç”¨

âœ… Connectionï¼šçº¿ç¨‹å®‰å…¨  
   å¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹å…±äº«

âŒ Channelï¼šéçº¿ç¨‹å®‰å…¨
   æ¯ä¸ªçº¿ç¨‹åº”è¯¥ä½¿ç”¨ç‹¬ç«‹çš„Channel

âŒ Consumerï¼šéçº¿ç¨‹å®‰å…¨
   æ¶ˆæ¯å¤„ç†å›è°ƒåœ¨å•ä¸€çº¿ç¨‹ä¸­æ‰§è¡Œ
```

### 8.2 é”™è¯¯çš„å¤šçº¿ç¨‹ä½¿ç”¨


```java
// âŒ é”™è¯¯ç¤ºä¾‹ï¼šå¤šçº¿ç¨‹å…±äº«Channel
public class BadExample {
    private static Channel sharedChannel;  // å±é™©ï¼
    
    public static void main(String[] args) throws Exception {
        Connection connection = factory.newConnection();
        sharedChannel = connection.createChannel();
        
        // å¤šä¸ªçº¿ç¨‹åŒæ—¶ä½¿ç”¨åŒä¸€ä¸ªChannel - ä¼šå‡ºç°é—®é¢˜ï¼
        for (int i = 0; i < 10; i++) {
            new Thread(() -> {
                try {
                    sharedChannel.basicPublish("", "queue", null, "msg".getBytes());
                } catch (Exception e) {
                    System.err.println("å‘é€å¤±è´¥ï¼š" + e.getMessage());
                }
            }).start();
        }
    }
}
```

### 8.3 æ­£ç¡®çš„å¤šçº¿ç¨‹æ¨¡å¼


**ğŸ¯ æ¯çº¿ç¨‹ç‹¬ç«‹Channel**
```java
public class ThreadSafePublisher {
    private final Connection connection;
    
    public ThreadSafePublisher(Connection connection) {
        this.connection = connection;
    }
    
    public void publishMessage(String message) {
        // æ¯æ¬¡æ“ä½œåˆ›å»ºæ–°çš„Channel
        try (Channel channel = connection.createChannel()) {
            channel.basicPublish("", "my_queue", null, message.getBytes());
        } catch (Exception e) {
            System.err.println("å‘é€å¤±è´¥ï¼š" + e.getMessage());
        }
    }
}

// ä½¿ç”¨ç¤ºä¾‹
ThreadSafePublisher publisher = new ThreadSafePublisher(connection);

// å¤šçº¿ç¨‹å®‰å…¨ä½¿ç”¨
for (int i = 0; i < 10; i++) {
    final int msgId = i;
    new Thread(() -> {
        publisher.publishMessage("æ¶ˆæ¯" + msgId);
    }).start();
}
```

**ğŸ¯ ThreadLocalæ¨¡å¼**
```java
public class ThreadLocalChannelManager {
    private final Connection connection;
    private final ThreadLocal<Channel> channelThreadLocal = new ThreadLocal<>();
    
    public ThreadLocalChannelManager(Connection connection) {
        this.connection = connection;
    }
    
    public Channel getChannel() throws IOException {
        Channel channel = channelThreadLocal.get();
        
        if (channel == null || !channel.isOpen()) {
            channel = connection.createChannel();
            channelThreadLocal.set(channel);
        }
        
        return channel;
    }
    
    public void closeChannel() {
        Channel channel = channelThreadLocal.get();
        if (channel != null) {
            try {
                channel.close();
            } catch (Exception e) {
                // è®°å½•æ—¥å¿—
            } finally {
                channelThreadLocal.remove();
            }
        }
    }
}
```

---

## 9. ğŸ› ï¸ å®è·µæ¡ˆä¾‹


### 9.1 ç®€å•ç”Ÿäº§è€…-æ¶ˆè´¹è€…


```java
// ç”Ÿäº§è€…
public class SimpleProducer {
    public static void main(String[] args) {
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost("localhost");
        
        try (Connection connection = factory.newConnection();
             Channel channel = connection.createChannel()) {
            
            // å£°æ˜é˜Ÿåˆ—
            channel.queueDeclare("task_queue", true, false, false, null);
            
            // å‘é€æ¶ˆæ¯
            for (int i = 1; i <= 10; i++) {
                String message = "ä»»åŠ¡æ¶ˆæ¯ " + i;
                
                // è®¾ç½®æ¶ˆæ¯æŒä¹…åŒ–
                AMQP.BasicProperties props = MessageProperties.PERSISTENT_TEXT_PLAIN;
                
                channel.basicPublish("", "task_queue", props, message.getBytes("UTF-8"));
                System.out.println("ğŸ“¤ å‘é€æ¶ˆæ¯ï¼š" + message);
            }
            
        } catch (Exception e) {
            System.err.println("å‘é€å¤±è´¥ï¼š" + e.getMessage());
        }
    }
}
```

```java
// æ¶ˆè´¹è€…
public class SimpleConsumer {
    public static void main(String[] args) throws Exception {
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost("localhost");
        
        Connection connection = factory.newConnection();
        Channel channel = connection.createChannel();
        
        // å£°æ˜é˜Ÿåˆ—ï¼ˆç¡®ä¿é˜Ÿåˆ—å­˜åœ¨ï¼‰
        channel.queueDeclare("task_queue", true, false, false, null);
        
        // è®¾ç½®å…¬å¹³åˆ†å‘
        channel.basicQos(1);
        
        System.out.println("ğŸ”„ ç­‰å¾…æ¶ˆæ¯ï¼ŒæŒ‰Ctrl+Cé€€å‡º...");
        
        // å®šä¹‰æ¶ˆæ¯å¤„ç†é€»è¾‘
        DeliverCallback deliverCallback = (consumerTag, delivery) -> {
            String message = new String(delivery.getBody(), "UTF-8");
            System.out.println("ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯ï¼š" + message);
            
            try {
                // æ¨¡æ‹Ÿå¤„ç†æ—¶é—´
                Thread.sleep(1000);
                System.out.println("âœ… å¤„ç†å®Œæˆï¼š" + message);
                
                // æ‰‹åŠ¨ç¡®è®¤
                channel.basicAck(delivery.getEnvelope().getDeliveryTag(), false);
                
            } catch (Exception e) {
                System.err.println("âŒ å¤„ç†å¤±è´¥ï¼š" + e.getMessage());
                // æ‹’ç»æ¶ˆæ¯å¹¶é‡æ–°å…¥é˜Ÿ
                channel.basicNack(delivery.getEnvelope().getDeliveryTag(), false, true);
            }
        };
        
        // å¼€å§‹æ¶ˆè´¹ï¼ˆæ‰‹åŠ¨ç¡®è®¤æ¨¡å¼ï¼‰
        channel.basicConsume("task_queue", false, deliverCallback, consumerTag -> {});
        
        // ä¿æŒç¨‹åºè¿è¡Œ
        Thread.currentThread().join();
    }
}
```

### 9.2 å‘å¸ƒ-è®¢é˜…æ¨¡å¼


```java
// å‘å¸ƒè€…
public class Publisher {
    public static void main(String[] args) {
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost("localhost");
        
        try (Connection connection = factory.newConnection();
             Channel channel = connection.createChannel()) {
            
            // å£°æ˜äº¤æ¢æœº
            channel.exchangeDeclare("logs", "fanout");
            
            // å‘å¸ƒæ¶ˆæ¯
            String message = "é‡è¦æ—¥å¿—æ¶ˆæ¯ï¼šç³»ç»Ÿå¯åŠ¨å®Œæˆ";
            channel.basicPublish("logs", "", null, message.getBytes("UTF-8"));
            
            System.out.println("ğŸ“¢ å‘å¸ƒæ¶ˆæ¯ï¼š" + message);
            
        } catch (Exception e) {
            System.err.println("å‘å¸ƒå¤±è´¥ï¼š" + e.getMessage());
        }
    }
}
```

```java
// è®¢é˜…è€…
public class Subscriber {
    public static void main(String[] args) throws Exception {
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost("localhost");
        
        Connection connection = factory.newConnection();
        Channel channel = connection.createChannel();
        
        // å£°æ˜äº¤æ¢æœº
        channel.exchangeDeclare("logs", "fanout");
        
        // å£°æ˜ä¸´æ—¶é˜Ÿåˆ—
        String queueName = channel.queueDeclare().getQueue();
        channel.queueBind(queueName, "logs", "");
        
        System.out.println("ğŸ“º è®¢é˜…è€…å¯åŠ¨ï¼Œç­‰å¾…æ¶ˆæ¯...");
        
        DeliverCallback deliverCallback = (consumerTag, delivery) -> {
            String message = new String(delivery.getBody(), "UTF-8");
            System.out.println("ğŸ“¨ æ¥æ”¶åˆ°æ—¥å¿—ï¼š" + message);
        };
        
        channel.basicConsume(queueName, true, deliverCallback, consumerTag -> {});
        
        // ä¿æŒè¿è¡Œ
        Thread.currentThread().join();
    }
}
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ amqp-clientï¼šRabbitMQå®˜æ–¹Javaå®¢æˆ·ç«¯åº“
ğŸ”¸ ConnectionFactoryï¼šè¿æ¥å·¥å‚ï¼Œè´Ÿè´£åˆ›å»ºè¿æ¥çš„é…ç½®ç±»
ğŸ”¸ Connectionï¼šTCPè¿æ¥ï¼Œçº¿ç¨‹å®‰å…¨ï¼Œå¯å…±äº«
ğŸ”¸ Channelï¼šè™šæ‹Ÿé€šé“ï¼Œéçº¿ç¨‹å®‰å…¨ï¼Œæ‰§è¡ŒAMQPæ“ä½œçš„ä¸»è¦æ¥å£
ğŸ”¸ èµ„æºç®¡ç†ï¼šåˆç†çš„åˆ›å»ºã€ä½¿ç”¨å’Œå…³é—­ç­–ç•¥
ğŸ”¸ å¼‚å¸¸å¤„ç†ï¼šç½‘ç»œå¼‚å¸¸ã€è®¤è¯å¼‚å¸¸ã€æ“ä½œå¼‚å¸¸çš„å¤„ç†
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ èµ„æºå±‚æ¬¡å…³ç³»**
```
ConnectionFactory (å·¥å‚)
    â†“ åˆ›å»º
Connection (è¿æ¥) - çº¿ç¨‹å®‰å…¨ï¼Œå¯å…±äº«
    â†“ åˆ›å»º
Channel (é€šé“) - éçº¿ç¨‹å®‰å…¨ï¼Œæ¯çº¿ç¨‹ç‹¬ç«‹ä½¿ç”¨
    â†“ æ‰§è¡Œ
AMQPæ“ä½œ (é˜Ÿåˆ—ã€äº¤æ¢æœºã€æ¶ˆæ¯)
```

**ğŸ”¹ çº¿ç¨‹å®‰å…¨åŸåˆ™**
```
âœ… å¯ä»¥å…±äº«ï¼šConnectionFactoryã€Connection
âŒ ä¸èƒ½å…±äº«ï¼šChannelï¼ˆæ¯ä¸ªçº¿ç¨‹ä½¿ç”¨ç‹¬ç«‹çš„Channelï¼‰
ğŸ¯ æœ€ä½³å®è·µï¼štry-with-resourcesæˆ–ThreadLocalæ¨¡å¼
```

**ğŸ”¹ å¼‚å¸¸å¤„ç†ç­–ç•¥**
```
è¿æ¥çº§å¼‚å¸¸ï¼šé‡è¿æœºåˆ¶ã€ç›‘å¬å™¨
é€šé“çº§å¼‚å¸¸ï¼šé‡å»ºé€šé“ã€ä¼˜é›…é™çº§
ä¸šåŠ¡å¼‚å¸¸ï¼šæ¶ˆæ¯ç¡®è®¤ã€é‡è¯•æœºåˆ¶
èµ„æºæ¸…ç†ï¼šfinallyå—ã€try-with-resources
```

### 10.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ å¼€å‘å»ºè®®**
- **å­¦ä¹ è·¯å¾„**ï¼šå…ˆæŒæ¡åŸºç¡€APIï¼Œå†å­¦ä¹ æ¡†æ¶å°è£…
- **èµ„æºç®¡ç†**ï¼šä½¿ç”¨è¿æ¥æ± ï¼Œé¿å…é¢‘ç¹åˆ›å»ºè¿æ¥
- **çº¿ç¨‹å®‰å…¨**ï¼šæ¯ä¸ªçº¿ç¨‹ä½¿ç”¨ç‹¬ç«‹çš„Channel
- **å¼‚å¸¸å¤„ç†**ï¼šå»ºç«‹å®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œæ¢å¤æœºåˆ¶

**ğŸ’¡ æœ€ä½³å®è·µ**
- ä½¿ç”¨try-with-resourcesç®¡ç†èµ„æº
- åˆç†é…ç½®è¿æ¥å‚æ•°ï¼ˆè¶…æ—¶ã€å¿ƒè·³ç­‰ï¼‰
- å®ç°ä¼˜é›…å…³é—­æœºåˆ¶
- æ·»åŠ ç›‘æ§å’Œæ—¥å¿—è®°å½•

**ğŸ”§ å¸¸è§é—®é¢˜è§£å†³**
- **è¿æ¥å¤±è´¥**ï¼šæ£€æŸ¥ç½‘ç»œã€ç«¯å£ã€è®¤è¯ä¿¡æ¯
- **å†…å­˜æ³„æ¼**ï¼šç¡®ä¿æ­£ç¡®å…³é—­Connectionå’ŒChannel
- **çº¿ç¨‹é—®é¢˜**ï¼šé¿å…å¤šçº¿ç¨‹å…±äº«Channel
- **æ€§èƒ½é—®é¢˜**ï¼šä½¿ç”¨è¿æ¥æ± ï¼Œåˆç†è®¾ç½®prefetch

**æ ¸å¿ƒè®°å¿†**ï¼š
- åŸç”Ÿå®¢æˆ·ç«¯æ˜¯ç†è§£RabbitMQçš„åŸºç¡€
- Connectionçº¿ç¨‹å®‰å…¨å¯å…±äº«ï¼ŒChanneléçº¿ç¨‹å®‰å…¨éœ€ç‹¬ç«‹
- èµ„æºç®¡ç†å’Œå¼‚å¸¸å¤„ç†æ˜¯ç”Ÿäº§ç¯å¢ƒçš„å…³é”®
- æŒæ¡åŸç”ŸAPIæœ‰åŠ©äºç†è§£æ¡†æ¶çš„å°è£…åŸç†