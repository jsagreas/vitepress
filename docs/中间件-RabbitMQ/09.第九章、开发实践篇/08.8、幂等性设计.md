---
title: 8ã€å¹‚ç­‰æ€§è®¾è®¡
---
## ğŸ“š ç›®å½•

1. [å¹‚ç­‰æ€§åŸºæœ¬æ¦‚å¿µ](#1-å¹‚ç­‰æ€§åŸºæœ¬æ¦‚å¿µ)
2. [æ¶ˆæ¯é‡å¤äº§ç”Ÿçš„åŸå› ](#2-æ¶ˆæ¯é‡å¤äº§ç”Ÿçš„åŸå› )
3. [å”¯ä¸€æ ‡è¯†ç¬¦è®¾è®¡ç­–ç•¥](#3-å”¯ä¸€æ ‡è¯†ç¬¦è®¾è®¡ç­–ç•¥)
4. [å»é‡ç­–ç•¥å®ç°æ–¹æ¡ˆ](#4-å»é‡ç­–ç•¥å®ç°æ–¹æ¡ˆ)
5. [çŠ¶æ€ç®¡ç†ä¸æŒä¹…åŒ–](#5-çŠ¶æ€ç®¡ç†ä¸æŒä¹…åŒ–)
6. [ä¸šåŠ¡å±‚å¹‚ç­‰æ€§å¤„ç†](#6-ä¸šåŠ¡å±‚å¹‚ç­‰æ€§å¤„ç†)
7. [æœ€ä½³å®è·µä¸å¸¸è§é™·é˜±](#7-æœ€ä½³å®è·µä¸å¸¸è§é™·é˜±)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ å¹‚ç­‰æ€§åŸºæœ¬æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯å¹‚ç­‰æ€§


**ğŸ’¡ é€šä¿—ç†è§£**
å¹‚ç­‰æ€§å°±åƒæŒ‰ç”µæ¢¯æŒ‰é’®ä¸€æ · - ä¸ç®¡ä½ æŒ‰å‡ æ¬¡ï¼Œç”µæ¢¯éƒ½åªä¼šæ¥ä¸€æ¬¡ã€‚åœ¨æ¶ˆæ¯ç³»ç»Ÿä¸­ï¼ŒåŒæ ·çš„æ¶ˆæ¯å¤„ç†å¤šæ¬¡ï¼Œç»“æœåº”è¯¥å’Œå¤„ç†ä¸€æ¬¡å®Œå…¨ä¸€æ ·ã€‚

**ğŸ”¸ æ ¸å¿ƒå®šä¹‰**
```
å¹‚ç­‰æ€§ï¼ˆIdempotenceï¼‰ï¼šåŒä¸€ä¸ªæ“ä½œæ‰§è¡Œå¤šæ¬¡çš„ç»“æœä¸æ‰§è¡Œä¸€æ¬¡çš„ç»“æœå®Œå…¨ç›¸åŒ

æ•°å­¦è¡¨è¾¾ï¼šf(f(x)) = f(x)
å®é™…åº”ç”¨ï¼šé‡å¤å¤„ç†åŒä¸€æ¡æ¶ˆæ¯ï¼Œä¸šåŠ¡çŠ¶æ€ä¸ä¼šå‘ç”Ÿå¼‚å¸¸å˜åŒ–
```

**ğŸ“‹ ç”Ÿæ´»ä¸­çš„å¹‚ç­‰æ€§ä¾‹å­**
| æ“ä½œç±»å‹ | **å¹‚ç­‰æ€§** | **è¯´æ˜** |
|---------|-----------|----------|
| ğŸ  **å¼€é—¨** | `æ˜¯` | `é—¨å¼€ç€æ—¶å†å¼€é—¨ï¼Œè¿˜æ˜¯å¼€ç€` |
| ğŸ’° **é“¶è¡Œè½¬è´¦** | `å¦` | `è½¬è´¦100å…ƒæ‰§è¡Œ2æ¬¡ = è½¬è´¦200å…ƒ` |
| ğŸ“ **è®¾ç½®ç”¨æˆ·å** | `æ˜¯` | `è®¾ç½®ç”¨æˆ·åä¸º"å¼ ä¸‰"æ‰§è¡Œå¤šæ¬¡ï¼Œè¿˜æ˜¯"å¼ ä¸‰"` |
| ğŸ›’ **å•†å“ä¸‹å•** | `å¦` | `ä¸‹åŒä¸€ä¸ªè®¢å•å¤šæ¬¡ = å¤šä¸ªè®¢å•` |

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦å¹‚ç­‰æ€§


**ğŸš¨ æ¶ˆæ¯é‡å¤çš„å±å®³**
```
çœŸå®ä¸šåŠ¡åœºæ™¯é—®é¢˜ï¼š

ç”µå•†ä¸‹å•ï¼š
ç”¨æˆ·ç‚¹å‡»"æäº¤è®¢å•" â†’ æ¶ˆæ¯é‡å¤ â†’ ç”Ÿæˆå¤šä¸ªé‡å¤è®¢å• â†’ ç”¨æˆ·è¢«é‡å¤æ‰£æ¬¾

åº“å­˜æ‰£å‡ï¼š
æ‰£å‡åº“å­˜æ¶ˆæ¯é‡å¤ â†’ åŒä¸€å•†å“è¢«å¤šæ¬¡æ‰£å‡ â†’ åº“å­˜æ•°æ®é”™è¯¯

ç§¯åˆ†å¥–åŠ±ï¼š
ç”¨æˆ·å®Œæˆä»»åŠ¡ â†’ ç§¯åˆ†å¥–åŠ±æ¶ˆæ¯é‡å¤ â†’ ç”¨æˆ·è·å¾—å¤šå€ç§¯åˆ† â†’ ä¸šåŠ¡æŸå¤±
```

**ğŸ’° ä¸šåŠ¡æŸå¤±åˆ†æ**
```
è´¢åŠ¡æŸå¤±ï¼š
â€¢ é‡å¤æ‰£æ¬¾å¯¼è‡´ç”¨æˆ·æŠ•è¯‰å’Œé€€æ¬¾
â€¢ åº“å­˜é”™è¯¯å¯¼è‡´è¶…å–æˆ–å°‘å–
â€¢ é‡å¤å¥–åŠ±å¯¼è‡´æˆæœ¬å¢åŠ 

æŠ€æœ¯å€ºåŠ¡ï¼š
â€¢ æ•°æ®ä¸ä¸€è‡´éœ€è¦äººå·¥ä¿®å¤
â€¢ ç³»ç»Ÿå¯é æ€§ä¸‹é™
â€¢ ç”¨æˆ·ä½“éªŒå˜å·®

è¿ç»´æˆæœ¬ï¼š
â€¢ éœ€è¦ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶
â€¢ éœ€è¦æ•°æ®ä¿®å¤å·¥å…·
â€¢ éœ€è¦åº”æ€¥å¤„ç†æµç¨‹
```

### 1.3 å¹‚ç­‰æ€§çš„åˆ†ç±»


**ğŸ”¸ ä¸åŒå±‚çº§çš„å¹‚ç­‰æ€§**
```
æ¶ˆæ¯å±‚å¹‚ç­‰æ€§ï¼š
ç¡®ä¿åŒä¸€æ¡æ¶ˆæ¯åªè¢«æ¶ˆè´¹ä¸€æ¬¡
å®ç°ï¼šæ¶ˆæ¯å»é‡ã€å”¯ä¸€æ ‡è¯†

ä¸šåŠ¡å±‚å¹‚ç­‰æ€§ï¼š
ç¡®ä¿åŒä¸€ä¸ªä¸šåŠ¡æ“ä½œåªç”Ÿæ•ˆä¸€æ¬¡
å®ç°ï¼šä¸šåŠ¡çŠ¶æ€æ£€æŸ¥ã€åˆ†å¸ƒå¼é”

æ¥å£å±‚å¹‚ç­‰æ€§ï¼š
ç¡®ä¿åŒä¸€ä¸ªæ¥å£è°ƒç”¨å¤šæ¬¡ç»“æœä¸€è‡´
å®ç°ï¼šä»¤ç‰Œæœºåˆ¶ã€çŠ¶æ€æœºè®¾è®¡
```

---

## 2. ğŸ”„ æ¶ˆæ¯é‡å¤äº§ç”Ÿçš„åŸå› 


### 2.1 ç½‘ç»œå±‚é¢çš„é‡å¤


**ğŸŒ ç½‘ç»œå¼‚å¸¸å¯¼è‡´é‡å¤**
```
æ¶ˆæ¯å‘é€é‡å¤åœºæ™¯ï¼š

ç”Ÿäº§è€… â†’ RabbitMQ
    â†“
ç½‘ç»œè¶…æ—¶ï¼Œç”Ÿäº§è€…è®¤ä¸ºå‘é€å¤±è´¥
    â†“
ç”Ÿäº§è€…é‡æ–°å‘é€ç›¸åŒæ¶ˆæ¯
    â†“
å®é™…ä¸Šç¬¬ä¸€æ¡æ¶ˆæ¯å·²ç»åˆ°è¾¾RabbitMQ
ç»“æœï¼šåŒä¸€æ¡æ¶ˆæ¯åœ¨é˜Ÿåˆ—ä¸­å­˜åœ¨ä¸¤ä»½
```

**ğŸ’» ä»£ç ç¤ºä¾‹ï¼šç”Ÿäº§è€…é‡è¯•**
```java
// å®¹æ˜“äº§ç”Ÿé‡å¤çš„ä»£ç 
public void sendMessage(String message) {
    for (int i = 0; i < 3; i++) {  // é‡è¯•3æ¬¡
        try {
            rabbitTemplate.convertAndSend("exchange", "routing.key", message);
            return;  // å‘é€æˆåŠŸ
        } catch (Exception e) {
            // ç½‘ç»œå¼‚å¸¸ï¼Œå¯èƒ½æ¶ˆæ¯å·²ç»å‘é€æˆåŠŸä½†æ²¡æ”¶åˆ°ç¡®è®¤
            if (i == 2) throw e;
        }
    }
}
```

### 2.2 æ¶ˆè´¹è€…å¤„ç†é‡å¤


**âš¡ æ¶ˆè´¹ç¡®è®¤æœºåˆ¶å¯¼è‡´é‡å¤**
```
æ¶ˆè´¹é‡å¤çš„å…¸å‹æµç¨‹ï¼š

æ¶ˆè´¹è€…æ¥æ”¶æ¶ˆæ¯ â†’ å¤„ç†ä¸šåŠ¡é€»è¾‘ â†’ å‡†å¤‡å‘é€ACK
    â†“
ç½‘ç»œæ–­å¼€ï¼ŒACKæœªå‘é€æˆåŠŸ
    â†“
RabbitMQè®¤ä¸ºæ¶ˆæ¯æœªè¢«å¤„ç†ï¼Œé‡æ–°æŠ•é€’
    â†“
æ¶ˆè´¹è€…å†æ¬¡æ¥æ”¶åˆ°ç›¸åŒæ¶ˆæ¯
ç»“æœï¼šåŒä¸€æ¡æ¶ˆæ¯è¢«å¤„ç†ä¸¤æ¬¡
```

**ğŸ”§ é—®é¢˜ä»£ç ç¤ºä¾‹**
```java
@RabbitListener(queues = "order.queue")
public void handleOrder(OrderMessage message) {
    // ä¸šåŠ¡å¤„ç†
    orderService.createOrder(message);  // å¯èƒ½é‡å¤æ‰§è¡Œ
    
    // åº“å­˜æ‰£å‡
    inventoryService.reduceStock(message.getProductId(), message.getQuantity);
    
    // æ²¡æœ‰å¹‚ç­‰æ€§ä¿æŠ¤ï¼Œé‡å¤æ¶ˆè´¹ä¼šå¯¼è‡´é—®é¢˜
}
```

### 2.3 RabbitMQé›†ç¾¤é‡å¤


**ğŸ—ï¸ é›†ç¾¤ç¯å¢ƒä¸‹çš„é‡å¤**
```
é›†ç¾¤æ•…éšœæ¢å¤åœºæ™¯ï¼š

ä¸»èŠ‚ç‚¹æ•…éšœ â†’ æ¶ˆæ¯å·²å†™å…¥ä¸»èŠ‚ç‚¹ä½†æœªåŒæ­¥åˆ°ä»èŠ‚ç‚¹
    â†“
ä»èŠ‚ç‚¹æå‡ä¸ºä¸»èŠ‚ç‚¹
    â†“
åŸä¸»èŠ‚ç‚¹æ¢å¤ï¼Œæ¶ˆæ¯å¯èƒ½é‡å¤å‡ºç°
    â†“
ç›¸åŒæ¶ˆæ¯åœ¨ä¸åŒèŠ‚ç‚¹éƒ½å­˜åœ¨
```

### 2.4 åº”ç”¨é‡å¯å¯¼è‡´é‡å¤


**ğŸ”„ åº”ç”¨é‡å¯æ—¶çš„é‡å¤**
```
åº”ç”¨é‡å¯é‡å¤åœºæ™¯ï¼š

æ¶ˆè´¹è€…æ­£åœ¨å¤„ç†æ¶ˆæ¯
    â†“
åº”ç”¨é‡å¯ï¼ˆæ¶ˆæ¯æœªACKï¼‰
    â†“
RabbitMQå°†æ¶ˆæ¯é‡æ–°æŠ•é€’ç»™å…¶ä»–æ¶ˆè´¹è€…
    â†“
å¦‚æœç¬¬ä¸€ä¸ªæ¶ˆè´¹è€…å·²ç»å¤„ç†äº†ä¸šåŠ¡é€»è¾‘
ç»“æœï¼šä¸šåŠ¡é€»è¾‘é‡å¤æ‰§è¡Œ
```

---

## 3. ğŸ†” å”¯ä¸€æ ‡è¯†ç¬¦è®¾è®¡ç­–ç•¥


### 3.1 æ¶ˆæ¯IDè®¾è®¡åŸåˆ™


**ğŸ¯ å¥½çš„æ¶ˆæ¯IDç‰¹å¾**
```
å…¨å±€å”¯ä¸€æ€§ï¼š
åœ¨æ•´ä¸ªç³»ç»Ÿä¸­ç»å¯¹ä¸ä¼šé‡å¤
ç¤ºä¾‹ï¼šUUIDã€é›ªèŠ±ç®—æ³•ID

ä¸šåŠ¡ç›¸å…³æ€§ï¼š
èƒ½å¤Ÿå…³è”åˆ°å…·ä½“çš„ä¸šåŠ¡æ“ä½œ
ç¤ºä¾‹ï¼šè®¢å•å·+æ“ä½œç±»å‹+æ—¶é—´æˆ³

å¯è¯»æ€§ï¼š
ä¾¿äºé—®é¢˜æ’æŸ¥å’Œæ—¥å¿—è¿½è¸ª
ç¤ºä¾‹ï¼šORDER_CREATE_20250920_001

æ—¶åºæ€§ï¼š
åŒ…å«æ—¶é—´ä¿¡æ¯ï¼Œä¾¿äºæ’åºå’Œè¿‡æœŸå¤„ç†
ç¤ºä¾‹ï¼šå¸¦æ—¶é—´æˆ³çš„ID
```

### 3.2 UUIDæ–¹æ¡ˆ


**ğŸ“ UUIDå®ç°æ–¹å¼**
```java
public class MessageIdGenerator {
    
    // æ–¹æ¡ˆ1ï¼šæ ‡å‡†UUID
    public static String generateUUID() {
        return UUID.randomUUID().toString();
        // è¾“å‡ºï¼š550e8400-e29b-41d4-a716-446655440000
    }
    
    // æ–¹æ¡ˆ2ï¼šç´§å‡‘UUIDï¼ˆå»æ‰çŸ­æ¨ªçº¿ï¼‰
    public static String generateCompactUUID() {
        return UUID.randomUUID().toString().replace("-", "");
        // è¾“å‡ºï¼š550e8400e29b41d4a716446655440000
    }
    
    // æ–¹æ¡ˆ3ï¼šä¸šåŠ¡å‰ç¼€+UUID
    public static String generateBusinessUUID(String prefix) {
        return prefix + "_" + UUID.randomUUID().toString();
        // è¾“å‡ºï¼šORDER_550e8400-e29b-41d4-a716-446655440000
    }
}
```

**âš–ï¸ UUIDä¼˜ç¼ºç‚¹åˆ†æ**
| ç‰¹æ€§ | **ä¼˜ç‚¹** | **ç¼ºç‚¹** |
|------|---------|----------|
| ğŸ¯ **å”¯ä¸€æ€§** | `å‡ ä¹100%ä¿è¯å…¨å±€å”¯ä¸€` | `ç†è®ºä¸Šæœ‰æå°æ¦‚ç‡é‡å¤` |
| ğŸ’¾ **å­˜å‚¨** | `ä¸éœ€è¦ä¸­å¿ƒåŒ–ç”Ÿæˆå™¨` | `å­—ç¬¦ä¸²è¾ƒé•¿ï¼Œå ç”¨ç©ºé—´å¤§` |
| ğŸ” **å¯è¯»æ€§** | `æ ‡å‡†æ ¼å¼ï¼Œå·¥å…·æ”¯æŒå¥½` | `æ— ä¸šåŠ¡å«ä¹‰ï¼Œè°ƒè¯•å›°éš¾` |
| âš¡ **æ€§èƒ½** | `æœ¬åœ°ç”Ÿæˆï¼Œé€Ÿåº¦å¿«` | `ä½œä¸ºæ•°æ®åº“ä¸»é”®æ€§èƒ½è¾ƒå·®` |

### 3.3 é›ªèŠ±ç®—æ³•æ–¹æ¡ˆ


**â„ï¸ é›ªèŠ±ç®—æ³•åŸç†**
```
é›ªèŠ±IDç»“æ„ï¼ˆ64ä½ï¼‰ï¼š

1ä½ç¬¦å·ä½ + 41ä½æ—¶é—´æˆ³ + 10ä½æœºå™¨ID + 12ä½åºåˆ—å·
|0|000...000|000000000|000000000000|
 â†‘     â†‘        â†‘           â†‘
ç¬¦å·   æ—¶é—´æˆ³   æœºå™¨æ ‡è¯†    åºåˆ—å·

ä¼˜åŠ¿ï¼š
â€¢ è¶‹åŠ¿é€’å¢ï¼Œå¯¹æ•°æ®åº“å‹å¥½
â€¢ åŒ…å«æ—¶é—´ä¿¡æ¯ï¼Œä¾¿äºæ’åº
â€¢ æ€§èƒ½é«˜ï¼Œæ¯æ¯«ç§’å¯ç”Ÿæˆ4096ä¸ªID
```

**ğŸ’» é›ªèŠ±ç®—æ³•å®ç°**
```java
public class SnowflakeIdGenerator {
    private static final long START_TIMESTAMP = 1609459200000L; // 2021-01-01
    private static final long SEQUENCE_BITS = 12;
    private static final long MACHINE_BITS = 10;
    
    private static final long MAX_SEQUENCE = (1L << SEQUENCE_BITS) - 1;
    private static final long MAX_MACHINE_NUM = (1L << MACHINE_BITS) - 1;
    
    private final long machineId;
    private long sequence = 0L;
    private long lastTimestamp = -1L;
    
    public SnowflakeIdGenerator(long machineId) {
        if (machineId > MAX_MACHINE_NUM || machineId < 0) {
            throw new IllegalArgumentException("æœºå™¨IDè¶…å‡ºèŒƒå›´");
        }
        this.machineId = machineId;
    }
    
    public synchronized long nextId() {
        long currentTimestamp = System.currentTimeMillis();
        
        if (currentTimestamp < lastTimestamp) {
            throw new RuntimeException("æ—¶é’Ÿå›æ‹¨å¼‚å¸¸");
        }
        
        if (currentTimestamp == lastTimestamp) {
            sequence = (sequence + 1) & MAX_SEQUENCE;
            if (sequence == 0) {
                currentTimestamp = getNextTimestamp(lastTimestamp);
            }
        } else {
            sequence = 0L;
        }
        
        lastTimestamp = currentTimestamp;
        
        return ((currentTimestamp - START_TIMESTAMP) << (SEQUENCE_BITS + MACHINE_BITS))
                | (machineId << SEQUENCE_BITS)
                | sequence;
    }
    
    private long getNextTimestamp(long lastTimestamp) {
        long timestamp = System.currentTimeMillis();
        while (timestamp <= lastTimestamp) {
            timestamp = System.currentTimeMillis();
        }
        return timestamp;
    }
}
```

### 3.4 ä¸šåŠ¡ç›¸å…³IDè®¾è®¡


**ğŸ·ï¸ ä¸šåŠ¡IDç»„åˆç­–ç•¥**
```java
public class BusinessMessageId {
    
    // è®¢å•ç›¸å…³æ¶ˆæ¯ID
    public static String createOrderMessageId(Long orderId, String operation) {
        return String.format("ORDER_%s_%s_%d", 
            operation, 
            orderId, 
            System.currentTimeMillis());
        // ç¤ºä¾‹ï¼šORDER_CREATE_123456_1726825800000
    }
    
    // ç”¨æˆ·ç›¸å…³æ¶ˆæ¯ID  
    public static String createUserMessageId(Long userId, String action) {
        return String.format("USER_%s_%s_%s", 
            action,
            userId,
            LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyyMMddHHmmss")));
        // ç¤ºä¾‹ï¼šUSER_REGISTER_789_20250920143000
    }
    
    // é€šç”¨ä¸šåŠ¡æ¶ˆæ¯ID
    public static String createBusinessMessageId(String module, String operation, String businessKey) {
        return String.format("%s_%s_%s_%d", 
            module.toUpperCase(),
            operation.toUpperCase(), 
            businessKey,
            System.nanoTime());
    }
}
```

**ğŸ“Š ä¸åŒIDæ–¹æ¡ˆå¯¹æ¯”**
| IDç±»å‹ | **é€‚ç”¨åœºæ™¯** | **ç¤ºä¾‹** | **ä¼˜åŠ¿** | **åŠ£åŠ¿** |
|--------|-------------|----------|----------|----------|
| ğŸ†” **UUID** | `é€šç”¨åœºæ™¯` | `550e8400-e29b...` | `ç®€å•å¯é ` | `æ— åºï¼Œå ç”¨ç©ºé—´å¤§` |
| â„ï¸ **é›ªèŠ±ID** | `é«˜å¹¶å‘åœºæ™¯` | `1726825800001234567` | `æœ‰åºï¼Œæ€§èƒ½é«˜` | `éœ€è¦æœºå™¨IDç®¡ç†` |
| ğŸ·ï¸ **ä¸šåŠ¡ID** | `ä¸šåŠ¡å…³è”åœºæ™¯` | `ORDER_CREATE_123_...` | `å¯è¯»æ€§å¼º` | `è®¾è®¡å¤æ‚` |
| ğŸ”¢ **è‡ªå¢ID** | `å•æœºç®€å•åœºæ™¯` | `1, 2, 3, 4...` | `ç®€å•æœ‰åº` | `åˆ†å¸ƒå¼å›°éš¾` |

---

## 4. ğŸ” å»é‡ç­–ç•¥å®ç°æ–¹æ¡ˆ


### 4.1 Rediså»é‡æ–¹æ¡ˆ


**ğŸ’¾ åŸºäºRedis Setçš„å»é‡**
```java
@Service
public class RedisDeduplicationService {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    private static final String DEDUP_KEY_PREFIX = "msg:dedup:";
    private static final int EXPIRE_SECONDS = 3600; // 1å°æ—¶è¿‡æœŸ
    
    /**
     * æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²å¤„ç†ï¼ˆåŸå­æ“ä½œï¼‰
     */
    public boolean isMessageProcessed(String messageId) {
        String key = DEDUP_KEY_PREFIX + messageId;
        
        // ä½¿ç”¨SET NX EXå‘½ä»¤ï¼ŒåŸå­æ€§æ“ä½œ
        Boolean result = redisTemplate.execute((RedisCallback<Boolean>) connection -> {
            byte[] keyBytes = key.getBytes();
            byte[] valueBytes = "1".getBytes();
            
            // SET key value NX EX seconds
            return connection.set(keyBytes, valueBytes, 
                Expiration.seconds(EXPIRE_SECONDS), 
                RedisStringCommands.SetOption.SET_IF_ABSENT);
        });
        
        // å¦‚æœè®¾ç½®æˆåŠŸï¼Œè¯´æ˜æ˜¯ç¬¬ä¸€æ¬¡å¤„ç†
        return result != null && result;
    }
    
    /**
     * æ ‡è®°æ¶ˆæ¯å·²å¤„ç†
     */
    public void markMessageProcessed(String messageId) {
        String key = DEDUP_KEY_PREFIX + messageId;
        redisTemplate.opsForValue().set(key, "processed", EXPIRE_SECONDS, TimeUnit.SECONDS);
    }
    
    /**
     * æ£€æŸ¥å¹¶æ ‡è®°æ¶ˆæ¯ï¼ˆæ¨èä½¿ç”¨ï¼‰
     */
    public boolean checkAndMarkMessage(String messageId) {
        String key = DEDUP_KEY_PREFIX + messageId;
        String luaScript = 
            "if redis.call('exists', KEYS[1]) == 1 then " +
            "    return 0 " +  // å·²å­˜åœ¨ï¼Œè¿”å›0
            "else " +
            "    redis.call('setex', KEYS[1], ARGV[1], ARGV[2]) " +
            "    return 1 " +  // ä¸å­˜åœ¨ï¼Œè®¾ç½®åè¿”å›1
            "end";
            
        Long result = redisTemplate.execute(
            RedisScript.of(luaScript, Long.class),
            Collections.singletonList(key),
            String.valueOf(EXPIRE_SECONDS),
            "processed"
        );
        
        return result != null && result == 1;
    }
}
```

**âš¡ Rediså»é‡ä½¿ç”¨ç¤ºä¾‹**
```java
@RabbitListener(queues = "order.queue")
public void handleOrderMessage(OrderMessage message, 
                             @Header Map<String, Object> headers) {
    
    String messageId = (String) headers.get("messageId");
    
    // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²å¤„ç†
    if (!deduplicationService.checkAndMarkMessage(messageId)) {
        log.info("æ¶ˆæ¯å·²å¤„ç†ï¼Œè·³è¿‡: {}", messageId);
        return;
    }
    
    try {
        // å¤„ç†ä¸šåŠ¡é€»è¾‘
        orderService.processOrder(message);
        log.info("æ¶ˆæ¯å¤„ç†æˆåŠŸ: {}", messageId);
        
    } catch (Exception e) {
        // å¤„ç†å¤±è´¥ï¼Œç§»é™¤å»é‡æ ‡è®°
        redisTemplate.delete(DEDUP_KEY_PREFIX + messageId);
        throw e;
    }
}
```

### 4.2 æ•°æ®åº“å»é‡æ–¹æ¡ˆ


**ğŸ—ƒï¸ æ•°æ®åº“å”¯ä¸€çº¦æŸå»é‡**
```sql
-- åˆ›å»ºæ¶ˆæ¯å¤„ç†è®°å½•è¡¨
CREATE TABLE message_dedup (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    message_id VARCHAR(128) NOT NULL UNIQUE,  -- å”¯ä¸€çº¦æŸ
    processed_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    business_type VARCHAR(50),
    INDEX idx_message_id (message_id),
    INDEX idx_processed_time (processed_time)
);

-- å®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®
DELETE FROM message_dedup 
WHERE processed_time < DATE_SUB(NOW(), INTERVAL 1 DAY);
```

**ğŸ’» æ•°æ®åº“å»é‡å®ç°**
```java
@Service
public class DatabaseDeduplicationService {
    
    @Autowired
    private JdbcTemplate jdbcTemplate;
    
    /**
     * æ£€æŸ¥å¹¶è®°å½•æ¶ˆæ¯å¤„ç†
     */
    @Transactional
    public boolean checkAndRecordMessage(String messageId, String businessType) {
        try {
            // å°è¯•æ’å…¥è®°å½•
            String sql = "INSERT INTO message_dedup (message_id, business_type) VALUES (?, ?)";
            int result = jdbcTemplate.update(sql, messageId, businessType);
            
            return result > 0; // æ’å…¥æˆåŠŸè¯´æ˜æ˜¯ç¬¬ä¸€æ¬¡å¤„ç†
            
        } catch (DuplicateKeyException e) {
            // ä¸»é”®å†²çªï¼Œè¯´æ˜æ¶ˆæ¯å·²å¤„ç†
            log.info("æ¶ˆæ¯å·²å¤„ç†: {}", messageId);
            return false;
        }
    }
    
    /**
     * ä½¿ç”¨å­˜å‚¨è¿‡ç¨‹å®ç°åŸå­æ€§æ£€æŸ¥
     */
    public boolean atomicCheckAndRecord(String messageId, String businessType) {
        String sql = "CALL check_and_record_message(?, ?, ?)";
        
        SqlParameterSource params = new MapSqlParameterSource()
            .addValue("p_message_id", messageId)
            .addValue("p_business_type", businessType)
            .addValue("p_result", null);
            
        Map<String, Object> result = namedJdbcTemplate.call(
            connection -> connection.prepareCall(sql), 
            params);
            
        return (Boolean) result.get("p_result");
    }
}

-- å­˜å‚¨è¿‡ç¨‹ç¤ºä¾‹
DELIMITER $$
CREATE PROCEDURE check_and_record_message(
    IN p_message_id VARCHAR(128),
    IN p_business_type VARCHAR(50),
    OUT p_result BOOLEAN
)
BEGIN
    DECLARE record_count INT DEFAULT 0;
    
    -- æ£€æŸ¥æ˜¯å¦å­˜åœ¨
    SELECT COUNT(*) INTO record_count 
    FROM message_dedup 
    WHERE message_id = p_message_id;
    
    IF record_count = 0 THEN
        -- ä¸å­˜åœ¨ï¼Œæ’å…¥è®°å½•
        INSERT INTO message_dedup (message_id, business_type) 
        VALUES (p_message_id, p_business_type);
        SET p_result = TRUE;
    ELSE
        -- å·²å­˜åœ¨
        SET p_result = FALSE;
    END IF;
END$$
DELIMITER ;
```

### 4.3 å†…å­˜å»é‡æ–¹æ¡ˆ


**ğŸ§  æœ¬åœ°ç¼“å­˜å»é‡ï¼ˆé€‚ç”¨äºå•æœºï¼‰**
```java
@Component
public class LocalDeduplicationService {
    
    // ä½¿ç”¨Guava Cacheå®ç°LRUç¼“å­˜
    private final Cache<String, Boolean> processedMessages = CacheBuilder.newBuilder()
        .maximumSize(10000)  // æœ€å¤§ç¼“å­˜æ•°é‡
        .expireAfterWrite(1, TimeUnit.HOURS)  // 1å°æ—¶åè¿‡æœŸ
        .build();
    
    /**
     * æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²å¤„ç†
     */
    public boolean isMessageProcessed(String messageId) {
        return processedMessages.getIfPresent(messageId) != null;
    }
    
    /**
     * æ ‡è®°æ¶ˆæ¯å·²å¤„ç†
     */
    public void markMessageProcessed(String messageId) {
        processedMessages.put(messageId, Boolean.TRUE);
    }
    
    /**
     * åŸå­æ€§æ£€æŸ¥å¹¶æ ‡è®°
     */
    public boolean checkAndMarkMessage(String messageId) {
        // ä½¿ç”¨putIfAbsentå®ç°åŸå­æ€§
        Boolean existing = processedMessages.asMap().putIfAbsent(messageId, Boolean.TRUE);
        return existing == null; // è¿”å›trueè¡¨ç¤ºæ˜¯ç¬¬ä¸€æ¬¡å¤„ç†
    }
}
```

### 4.4 æ··åˆå»é‡ç­–ç•¥


**ğŸ”„ å¤šå±‚å»é‡æœºåˆ¶**
```java
@Service
public class HybridDeduplicationService {
    
    @Autowired
    private LocalDeduplicationService localService;
    
    @Autowired  
    private RedisDeduplicationService redisService;
    
    @Autowired
    private DatabaseDeduplicationService dbService;
    
    /**
     * å¤šå±‚å»é‡æ£€æŸ¥
     */
    public boolean isFirstTimeProcessing(String messageId, String businessType) {
        
        // ç¬¬ä¸€å±‚ï¼šæœ¬åœ°ç¼“å­˜æ£€æŸ¥ï¼ˆæœ€å¿«ï¼‰
        if (localService.isMessageProcessed(messageId)) {
            log.debug("æœ¬åœ°ç¼“å­˜å‘½ä¸­ï¼Œæ¶ˆæ¯å·²å¤„ç†: {}", messageId);
            return false;
        }
        
        // ç¬¬äºŒå±‚ï¼šRedisæ£€æŸ¥ï¼ˆè¾ƒå¿«ï¼‰
        if (!redisService.checkAndMarkMessage(messageId)) {
            // Redisä¸­å·²å­˜åœ¨ï¼ŒåŒæ—¶æ›´æ–°æœ¬åœ°ç¼“å­˜
            localService.markMessageProcessed(messageId);
            log.debug("Redisç¼“å­˜å‘½ä¸­ï¼Œæ¶ˆæ¯å·²å¤„ç†: {}", messageId);
            return false;
        }
        
        // ç¬¬ä¸‰å±‚ï¼šæ•°æ®åº“æ£€æŸ¥ï¼ˆå…œåº•ï¼‰
        if (!dbService.checkAndRecordMessage(messageId, businessType)) {
            log.debug("æ•°æ®åº“è®°å½•å­˜åœ¨ï¼Œæ¶ˆæ¯å·²å¤„ç†: {}", messageId);
            return false;
        }
        
        // æ‰€æœ‰å±‚çº§éƒ½é€šè¿‡ï¼Œæ ‡è®°ä¸ºå·²å¤„ç†
        localService.markMessageProcessed(messageId);
        
        log.info("é¦–æ¬¡å¤„ç†æ¶ˆæ¯: {}", messageId);
        return true;
    }
}
```

**ğŸ“Š ä¸åŒå»é‡æ–¹æ¡ˆå¯¹æ¯”**
| æ–¹æ¡ˆç±»å‹ | **æ€§èƒ½** | **å¯é æ€§** | **æ‰©å±•æ€§** | **é€‚ç”¨åœºæ™¯** |
|---------|---------|-----------|-----------|-------------|
| ğŸ§  **å†…å­˜ç¼“å­˜** | `æé«˜` | `ä½` | `å•æœº` | `å•æœºé«˜é¢‘åœºæ™¯` |
| ğŸ’¾ **Redis** | `é«˜` | `é«˜` | `é›†ç¾¤` | `åˆ†å¸ƒå¼é«˜å¹¶å‘` |
| ğŸ—ƒï¸ **æ•°æ®åº“** | `ä¸­ç­‰` | `æé«˜` | `é›†ç¾¤` | `å¼ºä¸€è‡´æ€§è¦æ±‚` |
| ğŸ”„ **æ··åˆç­–ç•¥** | `é«˜` | `æé«˜` | `é›†ç¾¤` | `ç”Ÿäº§ç¯å¢ƒæ¨è` |

---

## 5. ğŸ’¾ çŠ¶æ€ç®¡ç†ä¸æŒä¹…åŒ–


### 5.1 æ¶ˆæ¯çŠ¶æ€è®¾è®¡


**ğŸ“Š æ¶ˆæ¯å¤„ç†çŠ¶æ€æ¨¡å‹**
```java
public enum MessageStatus {
    PENDING("å¾…å¤„ç†"),
    PROCESSING("å¤„ç†ä¸­"), 
    COMPLETED("å·²å®Œæˆ"),
    FAILED("å¤„ç†å¤±è´¥"),
    EXPIRED("å·²è¿‡æœŸ");
    
    private final String description;
    
    MessageStatus(String description) {
        this.description = description;
    }
}

@Entity
@Table(name = "message_processing_log")
public class MessageProcessingLog {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(name = "message_id", unique = true, nullable = false)
    private String messageId;
    
    @Enumerated(EnumType.STRING)
    @Column(name = "status")
    private MessageStatus status;
    
    @Column(name = "business_type")
    private String businessType;
    
    @Column(name = "retry_count")
    private Integer retryCount = 0;
    
    @Column(name = "created_time")
    private LocalDateTime createdTime;
    
    @Column(name = "updated_time") 
    private LocalDateTime updatedTime;
    
    @Column(name = "error_message", length = 1000)
    private String errorMessage;
    
    @Column(name = "processing_node")
    private String processingNode; // å¤„ç†èŠ‚ç‚¹æ ‡è¯†
    
    // getters and setters...
}
```

### 5.2 çŠ¶æ€æµè½¬ç®¡ç†


**ğŸ”„ çŠ¶æ€æœºå®ç°**
```java
@Service
public class MessageStatusManager {
    
    @Autowired
    private MessageProcessingLogRepository repository;
    
    /**
     * å¼€å§‹å¤„ç†æ¶ˆæ¯
     */
    @Transactional
    public boolean startProcessing(String messageId, String businessType) {
        try {
            MessageProcessingLog log = new MessageProcessingLog();
            log.setMessageId(messageId);
            log.setBusinessType(businessType);
            log.setStatus(MessageStatus.PROCESSING);
            log.setProcessingNode(getLocalNodeId());
            log.setCreatedTime(LocalDateTime.now());
            log.setUpdatedTime(LocalDateTime.now());
            
            repository.save(log);
            return true;
            
        } catch (DataIntegrityViolationException e) {
            // æ¶ˆæ¯å·²å­˜åœ¨ï¼Œæ£€æŸ¥çŠ¶æ€
            return handleExistingMessage(messageId);
        }
    }
    
    /**
     * å®Œæˆæ¶ˆæ¯å¤„ç†
     */
    @Transactional
    public void completeProcessing(String messageId) {
        MessageProcessingLog log = repository.findByMessageId(messageId);
        if (log != null && log.getStatus() == MessageStatus.PROCESSING) {
            log.setStatus(MessageStatus.COMPLETED);
            log.setUpdatedTime(LocalDateTime.now());
            repository.save(log);
        }
    }
    
    /**
     * æ ‡è®°å¤„ç†å¤±è´¥
     */
    @Transactional 
    public void markProcessingFailed(String messageId, String errorMessage) {
        MessageProcessingLog log = repository.findByMessageId(messageId);
        if (log != null) {
            log.setStatus(MessageStatus.FAILED);
            log.setErrorMessage(errorMessage);
            log.setRetryCount(log.getRetryCount() + 1);
            log.setUpdatedTime(LocalDateTime.now());
            repository.save(log);
        }
    }
    
    /**
     * å¤„ç†å·²å­˜åœ¨çš„æ¶ˆæ¯
     */
    private boolean handleExistingMessage(String messageId) {
        MessageProcessingLog existing = repository.findByMessageId(messageId);
        
        if (existing == null) return false;
        
        switch (existing.getStatus()) {
            case COMPLETED:
                log.info("æ¶ˆæ¯å·²å®Œæˆå¤„ç†: {}", messageId);
                return false; // ä¸éœ€è¦é‡æ–°å¤„ç†
                
            case PROCESSING:
                // æ£€æŸ¥æ˜¯å¦å¤„ç†è¶…æ—¶
                if (isProcessingTimeout(existing)) {
                    log.warn("æ¶ˆæ¯å¤„ç†è¶…æ—¶ï¼Œé‡æ–°å¤„ç†: {}", messageId);
                    existing.setStatus(MessageStatus.PENDING);
                    existing.setUpdatedTime(LocalDateTime.now());
                    repository.save(existing);
                    return true;
                }
                return false;
                
            case FAILED:
                if (existing.getRetryCount() < MAX_RETRY_COUNT) {
                    log.info("æ¶ˆæ¯å¤„ç†å¤±è´¥ï¼Œå‡†å¤‡é‡è¯•: {}", messageId);
                    return true;
                }
                return false;
                
            default:
                return true;
        }
    }
    
    private boolean isProcessingTimeout(MessageProcessingLog log) {
        return log.getUpdatedTime().isBefore(
            LocalDateTime.now().minusMinutes(PROCESSING_TIMEOUT_MINUTES));
    }
}
```

### 5.3 åˆ†å¸ƒå¼é”ä¿è¯


**ğŸ”’ åŸºäºRedisçš„åˆ†å¸ƒå¼é”**
```java
@Component
public class RedisDistributedLock {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    private static final String LOCK_PREFIX = "msg:lock:";
    private static final int DEFAULT_EXPIRE_SECONDS = 300; // 5åˆ†é’Ÿ
    
    /**
     * è·å–åˆ†å¸ƒå¼é”
     */
    public boolean acquireLock(String messageId, String nodeId, int expireSeconds) {
        String lockKey = LOCK_PREFIX + messageId;
        String lockValue = nodeId + ":" + System.currentTimeMillis();
        
        // ä½¿ç”¨Luaè„šæœ¬ä¿è¯åŸå­æ€§
        String luaScript = 
            "if redis.call('exists', KEYS[1]) == 0 then " +
            "    redis.call('setex', KEYS[1], ARGV[1], ARGV[2]) " +
            "    return 1 " +
            "else " +
            "    return 0 " +
            "end";
            
        Long result = redisTemplate.execute(
            RedisScript.of(luaScript, Long.class),
            Collections.singletonList(lockKey),
            String.valueOf(expireSeconds),
            lockValue
        );
        
        return result != null && result == 1;
    }
    
    /**
     * é‡Šæ”¾åˆ†å¸ƒå¼é”
     */
    public boolean releaseLock(String messageId, String nodeId) {
        String lockKey = LOCK_PREFIX + messageId;
        
        // åªæœ‰é”çš„æŒæœ‰è€…æ‰èƒ½é‡Šæ”¾
        String luaScript = 
            "if redis.call('get', KEYS[1]) == ARGV[1] then " +
            "    return redis.call('del', KEYS[1]) " +
            "else " +
            "    return 0 " +
            "end";
            
        String expectedValue = nodeId + ":*"; // ç®€åŒ–åŒ¹é…
        
        Long result = redisTemplate.execute(
            RedisScript.of(luaScript, Long.class),
            Collections.singletonList(lockKey),
            expectedValue
        );
        
        return result != null && result == 1;
    }
}
```

### 5.4 æŒä¹…åŒ–å­˜å‚¨ä¼˜åŒ–


**ğŸ“ˆ å­˜å‚¨æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**
```java
@Service
public class OptimizedMessageStorage {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private JdbcTemplate jdbcTemplate;
    
    /**
     * æ‰¹é‡æŒä¹…åŒ–æ¶ˆæ¯çŠ¶æ€
     */
    @Scheduled(fixedDelay = 5000) // æ¯5ç§’æ‰§è¡Œä¸€æ¬¡
    public void batchPersistMessageStatus() {
        
        // ä»Redisè·å–å¾…æŒä¹…åŒ–çš„æ¶ˆæ¯çŠ¶æ€
        Set<String> pendingKeys = redisTemplate.keys("msg:pending:*");
        
        if (pendingKeys.isEmpty()) return;
        
        List<MessageProcessingLog> batchData = new ArrayList<>();
        
        for (String key : pendingKeys) {
            MessageProcessingLog log = (MessageProcessingLog) redisTemplate.opsForValue().get(key);
            if (log != null) {
                batchData.add(log);
            }
        }
        
        // æ‰¹é‡æ’å…¥æ•°æ®åº“
        if (!batchData.isEmpty()) {
            batchInsertMessageLogs(batchData);
            
            // æ¸…ç†Redisä¸­çš„ä¸´æ—¶æ•°æ®
            redisTemplate.delete(pendingKeys);
        }
    }
    
    /**
     * æ‰¹é‡æ’å…¥æ•°æ®åº“
     */
    private void batchInsertMessageLogs(List<MessageProcessingLog> logs) {
        String sql = "INSERT INTO message_processing_log " +
                    "(message_id, status, business_type, retry_count, created_time, updated_time) " +
                    "VALUES (?, ?, ?, ?, ?, ?) " +
                    "ON DUPLICATE KEY UPDATE " +
                    "status = VALUES(status), retry_count = VALUES(retry_count), " +
                    "updated_time = VALUES(updated_time)";
        
        jdbcTemplate.batchUpdate(sql, new BatchPreparedStatementSetter() {
            @Override
            public void setValues(PreparedStatement ps, int i) throws SQLException {
                MessageProcessingLog log = logs.get(i);
                ps.setString(1, log.getMessageId());
                ps.setString(2, log.getStatus().name());
                ps.setString(3, log.getBusinessType());
                ps.setInt(4, log.getRetryCount());
                ps.setTimestamp(5, Timestamp.valueOf(log.getCreatedTime()));
                ps.setTimestamp(6, Timestamp.valueOf(log.getUpdatedTime()));
            }
            
            @Override
            public int getBatchSize() {
                return logs.size();
            }
        });
    }
}
```

---

## 6. ğŸ¢ ä¸šåŠ¡å±‚å¹‚ç­‰æ€§å¤„ç†


### 6.1 ä¸šåŠ¡å¹‚ç­‰æ€§è®¾è®¡åŸåˆ™


**ğŸ¯ ä¸šåŠ¡å±‚å¹‚ç­‰æ€§è¦ç‚¹**
```
çŠ¶æ€æ£€æŸ¥åŸåˆ™ï¼š
åœ¨æ‰§è¡Œä¸šåŠ¡æ“ä½œå‰ï¼Œå…ˆæ£€æŸ¥ä¸šåŠ¡å¯¹è±¡çš„å½“å‰çŠ¶æ€
ç¡®ä¿æ“ä½œçš„å‰ç½®æ¡ä»¶æ»¡è¶³

ç»“æœä¸€è‡´åŸåˆ™ï¼š
å¤šæ¬¡æ‰§è¡Œç›¸åŒæ“ä½œï¼Œä¸šåŠ¡ç»“æœä¿æŒä¸€è‡´
ä¸èƒ½å› ä¸ºé‡å¤æ‰§è¡Œè€Œäº§ç”Ÿå‰¯ä½œç”¨

åŸå­æ“ä½œåŸåˆ™ï¼š
ä¸šåŠ¡æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥
é¿å…ä¸­é—´çŠ¶æ€çš„ä¸ä¸€è‡´
```

### 6.2 è®¢å•å¤„ç†å¹‚ç­‰æ€§


**ğŸ›’ è®¢å•åˆ›å»ºå¹‚ç­‰æ€§ç¤ºä¾‹**
```java
@Service
@Transactional
public class OrderService {
    
    @Autowired
    private OrderRepository orderRepository;
    
    @Autowired
    private InventoryService inventoryService;
    
    @Autowired
    private PaymentService paymentService;
    
    /**
     * å¹‚ç­‰çš„è®¢å•åˆ›å»º
     */
    public OrderResult createOrder(CreateOrderMessage message) {
        String orderId = message.getOrderId();
        
        // 1. æ£€æŸ¥è®¢å•æ˜¯å¦å·²å­˜åœ¨
        Order existingOrder = orderRepository.findByOrderId(orderId);
        if (existingOrder != null) {
            return handleExistingOrder(existingOrder, message);
        }
        
        // 2. éªŒè¯åº“å­˜ï¼ˆå¹‚ç­‰æ£€æŸ¥ï¼‰
        if (!inventoryService.checkAndReserveStock(message.getProductId(), 
                                                  message.getQuantity(), 
                                                  orderId)) {
            throw new BusinessException("åº“å­˜ä¸è¶³");
        }
        
        try {
            // 3. åˆ›å»ºè®¢å•
            Order order = new Order();
            order.setOrderId(orderId);
            order.setUserId(message.getUserId());
            order.setProductId(message.getProductId());
            order.setQuantity(message.getQuantity());
            order.setAmount(message.getAmount());
            order.setStatus(OrderStatus.CREATED);
            order.setCreatedTime(LocalDateTime.now());
            
            order = orderRepository.save(order);
            
            // 4. å¤„ç†æ”¯ä»˜ï¼ˆå¦‚æœéœ€è¦ï¼‰
            if (message.getPaymentRequired()) {
                PaymentResult paymentResult = paymentService.processPayment(
                    orderId, message.getAmount(), message.getPaymentMethod());
                    
                if (paymentResult.isSuccess()) {
                    order.setStatus(OrderStatus.PAID);
                    orderRepository.save(order);
                }
            }
            
            return OrderResult.success(order);
            
        } catch (Exception e) {
            // å¤±è´¥æ—¶é‡Šæ”¾åº“å­˜
            inventoryService.releaseStock(message.getProductId(), 
                                        message.getQuantity(), 
                                        orderId);
            throw e;
        }
    }
    
    /**
     * å¤„ç†å·²å­˜åœ¨çš„è®¢å•
     */
    private OrderResult handleExistingOrder(Order existingOrder, CreateOrderMessage message) {
        
        // æ£€æŸ¥è®¢å•å†…å®¹æ˜¯å¦ä¸€è‡´
        if (!isOrderContentMatch(existingOrder, message)) {
            throw new BusinessException("è®¢å•å†…å®¹ä¸åŒ¹é…ï¼Œå¯èƒ½æ˜¯é‡å¤çš„è®¢å•ID");
        }
        
        // æ ¹æ®è®¢å•çŠ¶æ€å†³å®šå¤„ç†æ–¹å¼
        switch (existingOrder.getStatus()) {
            case CREATED:
                // è®¢å•å·²åˆ›å»ºä½†æœªæ”¯ä»˜ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦è¡¥å……æ”¯ä»˜æµç¨‹
                if (message.getPaymentRequired() && existingOrder.getPaymentStatus() == null) {
                    return continuePaymentProcess(existingOrder, message);
                }
                return OrderResult.success(existingOrder);
                
            case PAID:
            case COMPLETED:
                // è®¢å•å·²å®Œæˆï¼Œç›´æ¥è¿”å›
                return OrderResult.success(existingOrder);
                
            case CANCELLED:
                // è®¢å•å·²å–æ¶ˆï¼Œä¸å…è®¸é‡æ–°å¤„ç†
                throw new BusinessException("è®¢å•å·²å–æ¶ˆï¼Œæ— æ³•é‡æ–°å¤„ç†");
                
            default:
                return OrderResult.success(existingOrder);
        }
    }
    
    private boolean isOrderContentMatch(Order order, CreateOrderMessage message) {
        return Objects.equals(order.getUserId(), message.getUserId()) &&
               Objects.equals(order.getProductId(), message.getProductId()) &&
               Objects.equals(order.getQuantity(), message.getQuantity()) &&
               Objects.equals(order.getAmount(), message.getAmount());
    }
}
```

### 6.3 åº“å­˜æ‰£å‡å¹‚ç­‰æ€§


**ğŸ“¦ åº“å­˜æœåŠ¡å¹‚ç­‰æ€§å®ç°**
```java
@Service
public class InventoryService {
    
    @Autowired
    private InventoryRepository inventoryRepository;
    
    @Autowired
    private StockReservationRepository reservationRepository;
    
    /**
     * å¹‚ç­‰çš„åº“å­˜æ£€æŸ¥å’Œé¢„ç•™
     */
    @Transactional
    public boolean checkAndReserveStock(Long productId, Integer quantity, String orderId) {
        
        // 1. æ£€æŸ¥æ˜¯å¦å·²ç»é¢„ç•™è¿‡
        StockReservation existing = reservationRepository.findByOrderId(orderId);
        if (existing != null) {
            return handleExistingReservation(existing, productId, quantity);
        }
        
        // 2. æ£€æŸ¥åº“å­˜æ˜¯å¦å……è¶³
        Inventory inventory = inventoryRepository.findByProductIdForUpdate(productId);
        if (inventory == null || inventory.getAvailableStock() < quantity) {
            return false;
        }
        
        // 3. é¢„ç•™åº“å­˜
        inventory.setAvailableStock(inventory.getAvailableStock() - quantity);
        inventory.setReservedStock(inventory.getReservedStock() + quantity);
        inventoryRepository.save(inventory);
        
        // 4. è®°å½•é¢„ç•™ä¿¡æ¯
        StockReservation reservation = new StockReservation();
        reservation.setOrderId(orderId);
        reservation.setProductId(productId);
        reservation.setQuantity(quantity);
        reservation.setStatus(ReservationStatus.RESERVED);
        reservation.setCreatedTime(LocalDateTime.now());
        reservationRepository.save(reservation);
        
        return true;
    }
    
    /**
     * å¤„ç†å·²å­˜åœ¨çš„åº“å­˜é¢„ç•™
     */
    private boolean handleExistingReservation(StockReservation reservation, 
                                            Long productId, Integer quantity) {
        
        // æ£€æŸ¥é¢„ç•™ä¿¡æ¯æ˜¯å¦åŒ¹é…
        if (!Objects.equals(reservation.getProductId(), productId) || 
            !Objects.equals(reservation.getQuantity(), quantity)) {
            throw new BusinessException("åº“å­˜é¢„ç•™ä¿¡æ¯ä¸åŒ¹é…");
        }
        
        // æ ¹æ®é¢„ç•™çŠ¶æ€å¤„ç†
        switch (reservation.getStatus()) {
            case RESERVED:
                return true; // å·²é¢„ç•™ï¼Œç›´æ¥è¿”å›æˆåŠŸ
                
            case CONFIRMED:
                return true; // å·²ç¡®è®¤ï¼Œè¯´æ˜åº“å­˜å·²æ­£å¼æ‰£å‡
                
            case RELEASED:
                // å·²é‡Šæ”¾ï¼Œéœ€è¦é‡æ–°é¢„ç•™
                return checkAndReserveStock(productId, quantity, reservation.getOrderId());
                
            default:
                return false;
        }
    }
    
    /**
     * ç¡®è®¤åº“å­˜æ‰£å‡ï¼ˆè®¢å•æ”¯ä»˜æˆåŠŸåè°ƒç”¨ï¼‰
     */
    @Transactional
    public void confirmStockDeduction(String orderId) {
        StockReservation reservation = reservationRepository.findByOrderId(orderId);
        
        if (reservation != null && reservation.getStatus() == ReservationStatus.RESERVED) {
            
            // æ›´æ–°åº“å­˜ï¼ˆä»é¢„ç•™è½¬ä¸ºå®é™…æ‰£å‡ï¼‰
            Inventory inventory = inventoryRepository.findByProductIdForUpdate(reservation.getProductId());
            inventory.setReservedStock(inventory.getReservedStock() - reservation.getQuantity());
            inventory.setSoldStock(inventory.getSoldStock() + reservation.getQuantity());
            inventoryRepository.save(inventory);
            
            // æ›´æ–°é¢„ç•™çŠ¶æ€
            reservation.setStatus(ReservationStatus.CONFIRMED);
            reservation.setConfirmedTime(LocalDateTime.now());
            reservationRepository.save(reservation);
        }
    }
}
```

### 6.4 æ”¯ä»˜å¤„ç†å¹‚ç­‰æ€§


**ğŸ’° æ”¯ä»˜æœåŠ¡å¹‚ç­‰æ€§è®¾è®¡**
```java
@Service
public class PaymentService {
    
    @Autowired
    private PaymentRecordRepository paymentRepository;
    
    @Autowired
    private ThirdPartyPaymentClient paymentClient;
    
    /**
     * å¹‚ç­‰çš„æ”¯ä»˜å¤„ç†
     */
    @Transactional
    public PaymentResult processPayment(String orderId, BigDecimal amount, String paymentMethod) {
        
        // 1. æ£€æŸ¥æ”¯ä»˜è®°å½•æ˜¯å¦å­˜åœ¨
        PaymentRecord existingPayment = paymentRepository.findByOrderId(orderId);
        if (existingPayment != null) {
            return handleExistingPayment(existingPayment, amount, paymentMethod);
        }
        
        // 2. åˆ›å»ºæ”¯ä»˜è®°å½•
        PaymentRecord payment = new PaymentRecord();
        payment.setOrderId(orderId);
        payment.setAmount(amount);
        payment.setPaymentMethod(paymentMethod);
        payment.setStatus(PaymentStatus.PENDING);
        payment.setCreatedTime(LocalDateTime.now());
        
        // ç”Ÿæˆå”¯ä¸€çš„æ”¯ä»˜æµæ°´å·
        String paymentId = generatePaymentId(orderId);
        payment.setPaymentId(paymentId);
        
        payment = paymentRepository.save(payment);
        
        try {
            // 3. è°ƒç”¨ç¬¬ä¸‰æ–¹æ”¯ä»˜
            ThirdPartyPaymentRequest request = new ThirdPartyPaymentRequest();
            request.setMerchantOrderId(orderId);
            request.setPaymentId(paymentId); // ä½¿ç”¨å”¯ä¸€IDä¿è¯å¹‚ç­‰æ€§
            request.setAmount(amount);
            request.setPaymentMethod(paymentMethod);
            
            ThirdPartyPaymentResponse response = paymentClient.createPayment(request);
            
            // 4. æ›´æ–°æ”¯ä»˜çŠ¶æ€
            payment.setThirdPartyTransactionId(response.getTransactionId());
            payment.setStatus(PaymentStatus.PROCESSING);
            payment.setUpdatedTime(LocalDateTime.now());
            paymentRepository.save(payment);
            
            return PaymentResult.success(payment);
            
        } catch (Exception e) {
            // æ”¯ä»˜å¤±è´¥ï¼Œæ›´æ–°çŠ¶æ€
            payment.setStatus(PaymentStatus.FAILED);
            payment.setErrorMessage(e.getMessage());
            payment.setUpdatedTime(LocalDateTime.now());
            paymentRepository.save(payment);
            
            throw new PaymentException("æ”¯ä»˜å¤„ç†å¤±è´¥", e);
        }
    }
    
    /**
     * å¤„ç†å·²å­˜åœ¨çš„æ”¯ä»˜è®°å½•
     */
    private PaymentResult handleExistingPayment(PaymentRecord payment, 
                                              BigDecimal amount, 
                                              String paymentMethod) {
        
        // æ£€æŸ¥æ”¯ä»˜é‡‘é¢å’Œæ–¹å¼æ˜¯å¦ä¸€è‡´
        if (payment.getAmount().compareTo(amount) != 0 || 
            !Objects.equals(payment.getPaymentMethod(), paymentMethod)) {
            throw new BusinessException("æ”¯ä»˜ä¿¡æ¯ä¸åŒ¹é…");
        }
        
        switch (payment.getStatus()) {
            case SUCCESS:
                return PaymentResult.success(payment);
                
            case PROCESSING:
                // æŸ¥è¯¢ç¬¬ä¸‰æ–¹æ”¯ä»˜çŠ¶æ€
                return queryAndUpdatePaymentStatus(payment);
                
            case FAILED:
                // æ”¯ä»˜å¤±è´¥ï¼Œå¯ä»¥é‡æ–°å‘èµ·
                if (canRetryPayment(payment)) {
                    return retryPayment(payment);
                }
                return PaymentResult.failed(payment.getErrorMessage());
                
            case PENDING:
                // ç»§ç»­å¤„ç†
                return continuePaymentProcess(payment);
                
            default:
                return PaymentResult.failed("æœªçŸ¥çš„æ”¯ä»˜çŠ¶æ€");
        }
    }
    
    private String generatePaymentId(String orderId) {
        return "PAY_" + orderId + "_" + System.currentTimeMillis();
    }
}
```

---

## 7. ğŸ¯ æœ€ä½³å®è·µä¸å¸¸è§é™·é˜±


### 7.1 è®¾è®¡æœ€ä½³å®è·µ


**âœ… æ¨èçš„è®¾è®¡æ¨¡å¼**

**ğŸ”¸ æ¶ˆæ¯IDè®¾è®¡æœ€ä½³å®è·µ**
```java
public class MessageIdBestPractices {
    
    /**
     * æ¨èï¼šä¸šåŠ¡è¯­ä¹‰åŒ–ID
     */
    public static String createSemanticMessageId(String businessType, 
                                                String businessKey, 
                                                String operation) {
        return String.format("%s_%s_%s_%d", 
            businessType.toUpperCase(),
            operation.toUpperCase(), 
            businessKey,
            System.currentTimeMillis());
    }
    
    /**
     * æ¨èï¼šå¸¦æ ¡éªŒä½çš„ID
     */
    public static String createChecksumMessageId(String baseId) {
        int checksum = Math.abs(baseId.hashCode() % 1000);
        return baseId + "_" + String.format("%03d", checksum);
    }
    
    /**
     * æ¨èï¼šåˆ†å±‚IDè®¾è®¡
     */
    public static class LayeredMessageId {
        private final String module;      // æ¨¡å—æ ‡è¯†
        private final String operation;   // æ“ä½œç±»å‹
        private final String businessKey; // ä¸šåŠ¡ä¸»é”®
        private final long timestamp;     // æ—¶é—´æˆ³
        private final String nodeId;      // èŠ‚ç‚¹æ ‡è¯†
        
        public String generate() {
            return String.format("%s.%s.%s.%d.%s", 
                module, operation, businessKey, timestamp, nodeId);
        }
    }
}
```

**ğŸ”¸ å¹‚ç­‰æ€§æ£€æŸ¥æ¨¡æ¿**
```java
@Component
public class IdempotencyTemplate {
    
    /**
     * é€šç”¨å¹‚ç­‰æ€§å¤„ç†æ¨¡æ¿
     */
    public <T> T executeWithIdempotency(String messageId, 
                                       String businessType,
                                       Supplier<T> businessLogic) {
        
        // 1. å¹‚ç­‰æ€§æ£€æŸ¥
        if (!isFirstTimeProcessing(messageId, businessType)) {
            return getExistingResult(messageId);
        }
        
        try {
            // 2. æ‰§è¡Œä¸šåŠ¡é€»è¾‘
            T result = businessLogic.get();
            
            // 3. è®°å½•å¤„ç†ç»“æœ
            recordProcessingResult(messageId, result);
            
            return result;
            
        } catch (Exception e) {
            // 4. å¤„ç†å¤±è´¥ï¼Œæ¸…ç†å¹‚ç­‰æ€§æ ‡è®°
            cleanupIdempotencyMark(messageId);
            throw e;
        }
    }
    
    /**
     * å¼‚æ­¥ä¸šåŠ¡çš„å¹‚ç­‰æ€§å¤„ç†
     */
    @Async
    public CompletableFuture<Void> executeAsyncWithIdempotency(String messageId,
                                                              String businessType, 
                                                              Runnable businessLogic) {
        return CompletableFuture.runAsync(() -> {
            executeWithIdempotency(messageId, businessType, () -> {
                businessLogic.run();
                return null;
            });
        });
    }
}
```

### 7.2 å¸¸è§é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ


**âŒ é™·é˜±1ï¼šæ—¶é—´çª—å£é—®é¢˜**
```java
// é”™è¯¯ç¤ºä¾‹ï¼šæ²¡æœ‰è€ƒè™‘æ—¶é—´çª—å£
@RabbitListener(queues = "order.queue")
public void handleOrder(OrderMessage message) {
    String messageId = message.getMessageId();
    
    // é—®é¢˜ï¼šå¦‚æœæ¶ˆæ¯å¤„ç†æ—¶é—´å¾ˆé•¿ï¼Œå¯èƒ½å¯¼è‡´è¶…æ—¶é‡å¤æŠ•é€’
    if (redisTemplate.hasKey("processed:" + messageId)) {
        return; // å·²å¤„ç†ï¼Œè·³è¿‡
    }
    
    // é•¿æ—¶é—´ä¸šåŠ¡å¤„ç†
    processLongRunningBusiness(message); // å¯èƒ½éœ€è¦5åˆ†é’Ÿ
    
    // è®¾ç½®å·²å¤„ç†æ ‡è®°
    redisTemplate.opsForValue().set("processed:" + messageId, "1", 1, TimeUnit.HOURS);
}

// æ­£ç¡®ç¤ºä¾‹ï¼šæå‰è®¾ç½®å¤„ç†æ ‡è®°
@RabbitListener(queues = "order.queue")
public void handleOrderCorrect(OrderMessage message) {
    String messageId = message.getMessageId();
    
    // å…ˆè®¾ç½®å¤„ç†ä¸­çŠ¶æ€
    String lockKey = "processing:" + messageId;
    Boolean acquired = redisTemplate.opsForValue().setIfAbsent(
        lockKey, "processing", 10, TimeUnit.MINUTES);
        
    if (!acquired) {
        log.info("æ¶ˆæ¯æ­£åœ¨å¤„ç†ä¸­æˆ–å·²å¤„ç†: {}", messageId);
        return;
    }
    
    try {
        processLongRunningBusiness(message);
        
        // å¤„ç†å®Œæˆï¼Œæ›´æ–°çŠ¶æ€
        redisTemplate.opsForValue().set("processed:" + messageId, "completed", 1, TimeUnit.HOURS);
        
    } finally {
        // æ¸…ç†å¤„ç†ä¸­æ ‡è®°
        redisTemplate.delete(lockKey);
    }
}
```

**âŒ é™·é˜±2ï¼šéƒ¨åˆ†æˆåŠŸçš„å¹‚ç­‰æ€§**
```java
// é”™è¯¯ç¤ºä¾‹ï¼šæ²¡æœ‰è€ƒè™‘éƒ¨åˆ†æˆåŠŸçš„æƒ…å†µ
@Transactional
public void processOrder(OrderMessage message) {
    String messageId = message.getMessageId();
    
    if (isMessageProcessed(messageId)) {
        return;
    }
    
    // æ­¥éª¤1ï¼šåˆ›å»ºè®¢å•
    createOrder(message);
    
    // æ­¥éª¤2ï¼šæ‰£å‡åº“å­˜  
    reduceInventory(message);
    
    // æ­¥éª¤3ï¼šå‘é€é€šçŸ¥ï¼ˆå¤–éƒ¨è°ƒç”¨ï¼Œå¯èƒ½å¤±è´¥ï¼‰
    sendNotification(message); // å¦‚æœè¿™é‡Œå¤±è´¥ï¼Œå‰é¢çš„æ“ä½œå·²ç»æˆåŠŸ
    
    // æ ‡è®°æ¶ˆæ¯å·²å¤„ç†
    markMessageProcessed(messageId);
}

// æ­£ç¡®ç¤ºä¾‹ï¼šä½¿ç”¨çŠ¶æ€è®°å½•éƒ¨åˆ†æˆåŠŸ
@Transactional
public void processOrderCorrect(OrderMessage message) {
    String messageId = message.getMessageId();
    
    ProcessingState state = getProcessingState(messageId);
    
    if (state.isCompleted()) {
        return;
    }
    
    // æ­¥éª¤1ï¼šåˆ›å»ºè®¢å•
    if (!state.isOrderCreated()) {
        createOrder(message);
        state.setOrderCreated(true);
        updateProcessingState(messageId, state);
    }
    
    // æ­¥éª¤2ï¼šæ‰£å‡åº“å­˜
    if (!state.isInventoryReduced()) {
        reduceInventory(message);
        state.setInventoryReduced(true);
        updateProcessingState(messageId, state);
    }
    
    // æ­¥éª¤3ï¼šå‘é€é€šçŸ¥
    if (!state.isNotificationSent()) {
        sendNotification(message);
        state.setNotificationSent(true);
        updateProcessingState(messageId, state);
    }
    
    // æ ‡è®°å®Œå…¨å®Œæˆ
    state.setCompleted(true);
    updateProcessingState(messageId, state);
}
```

**âŒ é™·é˜±3ï¼šä¸åŒä¸šåŠ¡ä½¿ç”¨ç›¸åŒmessageId**
```java
// é”™è¯¯ç¤ºä¾‹ï¼šæ‰€æœ‰ä¸šåŠ¡å…±äº«ä¸€ä¸ªå»é‡ç©ºé—´
public class MessageProcessor {
    
    @RabbitListener(queues = "user.register.queue")
    public void handleUserRegister(UserMessage message) {
        String messageId = message.getMessageId(); // å¦‚ï¼šMSG_123
        
        if (isProcessed(messageId)) return; // å¯èƒ½ä¸å…¶ä»–ä¸šåŠ¡å†²çª
        
        // å¤„ç†ç”¨æˆ·æ³¨å†Œ
        processUserRegister(message);
        markProcessed(messageId);
    }
    
    @RabbitListener(queues = "order.create.queue") 
    public void handleOrderCreate(OrderMessage message) {
        String messageId = message.getMessageId(); // å¦‚æœä¹Ÿæ˜¯ï¼šMSG_123
        
        if (isProcessed(messageId)) return; // é”™è¯¯ï¼šè¢«ç”¨æˆ·æ³¨å†Œä¸šåŠ¡æ ‡è®°ä¸ºå·²å¤„ç†
        
        // æ°¸è¿œä¸ä¼šæ‰§è¡Œ
        processOrderCreate(message);
        markProcessed(messageId);
    }
}

// æ­£ç¡®ç¤ºä¾‹ï¼šä¸šåŠ¡éš”ç¦»çš„å»é‡ç©ºé—´
public class MessageProcessorCorrect {
    
    @RabbitListener(queues = "user.register.queue")
    public void handleUserRegister(UserMessage message) {
        String messageId = "USER_REGISTER:" + message.getMessageId();
        
        if (isProcessed(messageId)) return;
        
        processUserRegister(message);
        markProcessed(messageId);
    }
    
    @RabbitListener(queues = "order.create.queue")
    public void handleOrderCreate(OrderMessage message) {
        String messageId = "ORDER_CREATE:" + message.getMessageId();
        
        if (isProcessed(messageId)) return;
        
        processOrderCreate(message);
        markProcessed(messageId);
    }
}
```

### 7.3 æ€§èƒ½ä¼˜åŒ–å»ºè®®


**âš¡ å»é‡æ€§èƒ½ä¼˜åŒ–**
```java
public class PerformanceOptimizedDeduplication {
    
    // ä¼˜åŒ–1ï¼šæ‰¹é‡æ£€æŸ¥
    public Map<String, Boolean> batchCheckMessages(List<String> messageIds) {
        
        // ä½¿ç”¨pipelineå‡å°‘ç½‘ç»œå¾€è¿”
        List<Object> results = redisTemplate.executePipelined(
            (RedisCallback<Object>) connection -> {
                for (String messageId : messageIds) {
                    connection.exists(("dedup:" + messageId).getBytes());
                }
                return null;
            });
            
        Map<String, Boolean> resultMap = new HashMap<>();
        for (int i = 0; i < messageIds.size(); i++) {
            resultMap.put(messageIds.get(i), (Boolean) results.get(i));
        }
        
        return resultMap;
    }
    
    // ä¼˜åŒ–2ï¼šæœ¬åœ°ç¼“å­˜+è¿œç¨‹ç¼“å­˜
    private final LoadingCache<String, Boolean> localCache = CacheBuilder.newBuilder()
        .maximumSize(10000)
        .expireAfterWrite(5, TimeUnit.MINUTES)
        .build(new CacheLoader<String, Boolean>() {
            @Override
            public Boolean load(String messageId) {
                return checkRedisProcessed(messageId);
            }
        });
        
    public boolean isMessageProcessedOptimized(String messageId) {
        try {
            return localCache.get(messageId);
        } catch (Exception e) {
            return checkRedisProcessed(messageId);
        }
    }
    
    // ä¼˜åŒ–3ï¼šå¼‚æ­¥æ¸…ç†è¿‡æœŸæ•°æ®
    @Scheduled(fixedDelay = 60000) // æ¯åˆ†é’Ÿæ‰§è¡Œ
    public void cleanupExpiredMessages() {
        
        // ä½¿ç”¨Luaè„šæœ¬æ‰¹é‡æ¸…ç†
        String luaScript = 
            "local keys = redis.call('keys', ARGV[1]) " +
            "local count = 0 " +
            "for i=1,#keys do " +
            "    local ttl = redis.call('ttl', keys[i]) " +
            "    if ttl > 0 and ttl < tonumber(ARGV[2]) then " +
            "        redis.call('del', keys[i]) " +
            "        count = count + 1 " +
            "    end " +
            "end " +
            "return count";
            
        Long cleanedCount = redisTemplate.execute(
            RedisScript.of(luaScript, Long.class),
            Collections.emptyList(),
            "dedup:*",
            "300" // 5åˆ†é’Ÿå†…è¿‡æœŸçš„éƒ½æ¸…ç†
        );
        
        log.debug("æ¸…ç†è¿‡æœŸæ¶ˆæ¯æ•°é‡: {}", cleanedCount);
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å¹‚ç­‰æ€§æœ¬è´¨ï¼šåŒä¸€æ“ä½œæ‰§è¡Œå¤šæ¬¡ç»“æœç›¸åŒï¼Œå¦‚åŒæŒ‰ç”µæ¢¯æŒ‰é’®
ğŸ”¸ äº§ç”ŸåŸå› ï¼šç½‘ç»œé‡è¯•ã€æ¶ˆè´¹ç¡®è®¤å¤±è´¥ã€ç³»ç»Ÿé‡å¯ç­‰å¯¼è‡´æ¶ˆæ¯é‡å¤
ğŸ”¸ å”¯ä¸€æ ‡è¯†ï¼šUUIDã€é›ªèŠ±ç®—æ³•ã€ä¸šåŠ¡IDç­‰æ–¹æ¡ˆè®¾è®¡æ¶ˆæ¯å”¯ä¸€æ ‡è¯†
ğŸ”¸ å»é‡ç­–ç•¥ï¼šRedisã€æ•°æ®åº“ã€å†…å­˜ç¼“å­˜ç­‰å¤šç§å»é‡å®ç°æ–¹æ¡ˆ
ğŸ”¸ çŠ¶æ€ç®¡ç†ï¼šæ¶ˆæ¯å¤„ç†çŠ¶æ€æµè½¬å’ŒæŒä¹…åŒ–å­˜å‚¨
ğŸ”¸ ä¸šåŠ¡å¹‚ç­‰ï¼šè®¢å•ã€åº“å­˜ã€æ”¯ä»˜ç­‰ä¸šåŠ¡å±‚é¢çš„å¹‚ç­‰æ€§è®¾è®¡
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å¹‚ç­‰æ€§è®¾è®¡çš„æ ¸å¿ƒæ€è·¯**
```
æå‰æ£€æŸ¥ï¼š
åœ¨å¤„ç†ä¸šåŠ¡é€»è¾‘å‰ï¼Œå…ˆæ£€æŸ¥æ˜¯å¦å·²å¤„ç†è¿‡
é¿å…é‡å¤æ‰§è¡Œé€ æˆçš„ä¸šåŠ¡é—®é¢˜

çŠ¶æ€é©±åŠ¨ï¼š
åŸºäºçŠ¶æ€æœºè®¾è®¡ï¼Œæ¯ä¸ªçŠ¶æ€éƒ½æ˜¯å¹‚ç­‰çš„
æ”¯æŒéƒ¨åˆ†æˆåŠŸåœºæ™¯çš„æ¢å¤å¤„ç†

åŸå­æ“ä½œï¼š
æ£€æŸ¥å’Œæ ‡è®°æ“ä½œè¦åŸå­æ‰§è¡Œ
é¿å…å¹¶å‘æƒ…å†µä¸‹çš„ç«æ€æ¡ä»¶
```

**ğŸ”¹ ä¸åŒåœºæ™¯çš„é€‰æ‹©ç­–ç•¥**
```
é«˜å¹¶å‘åœºæ™¯ï¼š
é€‰æ‹©Redis + æœ¬åœ°ç¼“å­˜çš„æ··åˆæ–¹æ¡ˆ
ä¼˜å…ˆè€ƒè™‘æ€§èƒ½ï¼Œé€‚å½“ç‰ºç‰²ä¸€è‡´æ€§

å¼ºä¸€è‡´æ€§åœºæ™¯ï¼š
é€‰æ‹©æ•°æ®åº“å”¯ä¸€çº¦æŸæ–¹æ¡ˆ
ç¡®ä¿æ•°æ®çš„å¼ºä¸€è‡´æ€§è¦æ±‚

ç®€å•åœºæ™¯ï¼š
é€‰æ‹©å†…å­˜ç¼“å­˜æˆ–ç®€å•Redisæ–¹æ¡ˆ
é™ä½ç³»ç»Ÿå¤æ‚åº¦ï¼Œæ»¡è¶³åŸºæœ¬éœ€æ±‚
```

### 8.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ’¼ ä¸šåŠ¡ä»·å€¼**
- **é¿å…æŸå¤±**ï¼šé˜²æ­¢é‡å¤æ‰£æ¬¾ã€é‡å¤å¥–åŠ±ç­‰ä¸šåŠ¡æŸå¤±
- **æå‡ä½“éªŒ**ï¼šé¿å…é‡å¤æ“ä½œç»™ç”¨æˆ·å¸¦æ¥çš„å›°æ‰°
- **æ•°æ®ä¸€è‡´**ï¼šä¿è¯ä¸šåŠ¡æ•°æ®çš„å‡†ç¡®æ€§å’Œä¸€è‡´æ€§

**ğŸ”§ æŠ€æœ¯ä»·å€¼**
- **ç³»ç»Ÿç¨³å®š**ï¼šæé«˜åˆ†å¸ƒå¼ç³»ç»Ÿçš„å¯é æ€§
- **è¿ç»´ç®€åŒ–**ï¼šå‡å°‘å› é‡å¤å¤„ç†å¯¼è‡´çš„æ•°æ®ä¿®å¤å·¥ä½œ
- **æ‰©å±•æ€§å¥½**ï¼šæ”¯æŒç³»ç»Ÿçš„æ°´å¹³æ‰©å±•

**ğŸ“š å­¦ä¹ è¦ç‚¹**
- **ç†è§£åŸç†**ï¼šæ·±å…¥ç†è§£å¹‚ç­‰æ€§çš„æœ¬è´¨å’Œå¿…è¦æ€§
- **æŒæ¡æ–¹æ³•**ï¼šç†Ÿç»ƒè¿ç”¨å„ç§å»é‡ç­–ç•¥å’Œå®ç°æ–¹æ¡ˆ
- **å…³æ³¨ç»†èŠ‚**ï¼šæ³¨æ„å¹¶å‘ã€å¼‚å¸¸ã€æ—¶é—´çª—å£ç­‰è¾¹ç•Œæƒ…å†µ
- **ä¸šåŠ¡æ€ç»´**ï¼šä»ä¸šåŠ¡è§’åº¦è®¾è®¡å¹‚ç­‰æ€§ï¼Œè€Œä¸æ˜¯çº¯æŠ€æœ¯å®ç°

### 8.4 å®æˆ˜ç»éªŒæ€»ç»“


**ğŸ¯ è®¾è®¡checklist**
```
æ¶ˆæ¯IDè®¾è®¡ï¼š
â˜‘ï¸ æ˜¯å¦å…¨å±€å”¯ä¸€ï¼Ÿ
â˜‘ï¸ æ˜¯å¦åŒ…å«ä¸šåŠ¡è¯­ä¹‰ï¼Ÿ
â˜‘ï¸ æ˜¯å¦ä¾¿äºé—®é¢˜è¿½è¸ªï¼Ÿ
â˜‘ï¸ æ˜¯å¦è€ƒè™‘äº†åˆ†å¸ƒå¼ç¯å¢ƒï¼Ÿ

å»é‡æ–¹æ¡ˆé€‰æ‹©ï¼š
â˜‘ï¸ æ€§èƒ½è¦æ±‚æ˜¯å¦æ»¡è¶³ï¼Ÿ
â˜‘ï¸ ä¸€è‡´æ€§è¦æ±‚æ˜¯å¦æ»¡è¶³ï¼Ÿ
â˜‘ï¸ æ‰©å±•æ€§æ˜¯å¦è€ƒè™‘ï¼Ÿ
â˜‘ï¸ è¿ç»´å¤æ‚åº¦æ˜¯å¦å¯æ¥å—ï¼Ÿ

ä¸šåŠ¡å¹‚ç­‰è®¾è®¡ï¼š
â˜‘ï¸ æ˜¯å¦è€ƒè™‘äº†éƒ¨åˆ†æˆåŠŸåœºæ™¯ï¼Ÿ
â˜‘ï¸ çŠ¶æ€æµè½¬æ˜¯å¦æ¸…æ™°ï¼Ÿ
â˜‘ï¸ å¼‚å¸¸å¤„ç†æ˜¯å¦å®Œæ•´ï¼Ÿ
â˜‘ï¸ å¹¶å‘å®‰å…¨æ˜¯å¦ä¿è¯ï¼Ÿ
```

**âš ï¸ å¸¸è§é—®é¢˜æ’æŸ¥**
```
æ¶ˆæ¯é‡å¤å¤„ç†ï¼š
1. æ£€æŸ¥æ¶ˆæ¯IDæ˜¯å¦çœŸæ­£å”¯ä¸€
2. ç¡®è®¤å»é‡é€»è¾‘æ˜¯å¦æ­£ç¡®
3. æŸ¥çœ‹æ˜¯å¦å­˜åœ¨æ—¶é—´çª—å£é—®é¢˜
4. éªŒè¯å¹¶å‘å¤„ç†æ˜¯å¦å®‰å…¨

ä¸šåŠ¡æ•°æ®å¼‚å¸¸ï¼š
1. æ£€æŸ¥ä¸šåŠ¡å¹‚ç­‰æ€§è®¾è®¡
2. æŸ¥çœ‹çŠ¶æ€æµè½¬æ˜¯å¦æ­£ç¡®
3. ç¡®è®¤å¼‚å¸¸å›æ»šæ˜¯å¦å®Œæ•´
4. éªŒè¯åˆ†å¸ƒå¼äº‹åŠ¡æ˜¯å¦ä¸€è‡´

æ€§èƒ½é—®é¢˜ï¼š
1. æ£€æŸ¥å»é‡æŸ¥è¯¢æ˜¯å¦æœ‰ç´¢å¼•
2. ç¡®è®¤ç¼“å­˜å‘½ä¸­ç‡æ˜¯å¦åˆç†
3. æŸ¥çœ‹æ˜¯å¦å­˜åœ¨é”ç«äº‰
4. éªŒè¯æ‰¹é‡æ“ä½œæ˜¯å¦ä¼˜åŒ–
```

**ğŸš€ è¿›é˜¶ä¼˜åŒ–æ–¹å‘**
```
æ¶æ„å±‚é¢ï¼š
â€¢ æ¶ˆæ¯åˆ†ç‰‡ï¼šæŒ‰ä¸šåŠ¡ç±»å‹åˆ†ç‰‡å‡å°‘å†²çª
â€¢ å¼‚æ­¥å¤„ç†ï¼šä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—è§£è€¦å»é‡å’Œä¸šåŠ¡å¤„ç†
â€¢ ç¼“å­˜åˆ†å±‚ï¼šå¤šçº§ç¼“å­˜æå‡æ€§èƒ½
â€¢ ç›‘æ§å‘Šè­¦ï¼šå®Œå–„çš„ç›‘æ§å’Œå‘Šè­¦ä½“ç³»

æŠ€æœ¯å±‚é¢ï¼š
â€¢ å¸ƒéš†è¿‡æ»¤å™¨ï¼šå¤§è§„æ¨¡åœºæ™¯ä¸‹çš„é¢„è¿‡æ»¤
â€¢ åˆ†å¸ƒå¼é”ä¼˜åŒ–ï¼šå‡å°‘é”ç²’åº¦å’ŒæŒæœ‰æ—¶é—´
â€¢ æ•°æ®åº“ä¼˜åŒ–ï¼šåˆ†åº“åˆ†è¡¨ã€è¯»å†™åˆ†ç¦»
â€¢ å†…å­˜ä¼˜åŒ–ï¼šåˆç†çš„ç¼“å­˜è¿‡æœŸå’Œæ¸…ç†ç­–ç•¥
```

**ğŸ’¡ æœ€åçš„å»ºè®®**

> ğŸ”‘ **æ ¸å¿ƒåŸåˆ™**ï¼šå¹‚ç­‰æ€§è®¾è®¡è¦ä»ä¸šåŠ¡è§’åº¦å‡ºå‘ï¼ŒæŠ€æœ¯æ‰‹æ®µåªæ˜¯å®ç°æ–¹å¼ã€‚ç†è§£ä¸šåŠ¡éœ€æ±‚ï¼Œé€‰æ‹©åˆé€‚çš„æŠ€æœ¯æ–¹æ¡ˆï¼Œå…³æ³¨è¾¹ç•Œæƒ…å†µï¼Œåšå¥½ç›‘æ§å’Œå¼‚å¸¸å¤„ç†ã€‚

> âš¡ **æ€§èƒ½å¹³è¡¡**ï¼šä¸è¦ä¸ºäº†è¿½æ±‚æè‡´æ€§èƒ½è€Œç‰ºç‰²æ•°æ®ä¸€è‡´æ€§ï¼Œä¹Ÿä¸è¦ä¸ºäº†ä¿è¯ä¸€è‡´æ€§è€Œå¿½ç•¥æ€§èƒ½è¦æ±‚ã€‚åœ¨å…·ä½“åœºæ™¯ä¸‹æ‰¾åˆ°æœ€åˆé€‚çš„å¹³è¡¡ç‚¹ã€‚

> ğŸ›¡ï¸ **é˜²å¾¡ç¼–ç¨‹**ï¼šå‡è®¾ä¸€åˆ‡éƒ½å¯èƒ½å‡ºé”™ï¼Œç½‘ç»œä¼šæ–­å¼€ï¼ŒæœåŠ¡ä¼šé‡å¯ï¼Œæ¶ˆæ¯ä¼šé‡å¤ã€‚è®¾è®¡æ—¶è¦è€ƒè™‘å„ç§å¼‚å¸¸æƒ…å†µï¼Œåšå¥½å…œåº•æ–¹æ¡ˆã€‚

> ğŸ“ˆ **æŒç»­ä¼˜åŒ–**ï¼šå¹‚ç­‰æ€§è®¾è®¡ä¸æ˜¯ä¸€æ¬¡æ€§çš„å·¥ä½œï¼Œéœ€è¦æ ¹æ®ä¸šåŠ¡å‘å±•å’Œç³»ç»Ÿå˜åŒ–æŒç»­ä¼˜åŒ–ã€‚å®šæœŸreviewå’Œé‡æ„ï¼Œä¿æŒç³»ç»Ÿçš„å¥åº·å‘å±•ã€‚

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- å¹‚ç­‰å¦‚æŒ‰é’®ï¼Œå¤šæŒ‰ä¸€ä¸ªæ ·
- æ¶ˆæ¯IDå”¯ä¸€ï¼Œå»é‡è¦åœ¨å…ˆ  
- çŠ¶æ€è¦ç®¡ç†ï¼Œä¸šåŠ¡éœ€ä¿éšœ
- æ€§èƒ½ä¸ä¸€è‡´ï¼Œå¹³è¡¡æ˜¯å…³é”®