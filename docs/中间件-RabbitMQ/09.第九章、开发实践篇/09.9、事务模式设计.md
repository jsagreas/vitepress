---
title: 9ã€äº‹åŠ¡æ¨¡å¼è®¾è®¡
---
## ğŸ“š ç›®å½•

1. [åˆ†å¸ƒå¼äº‹åŠ¡æ¦‚å¿µç†è§£](#1-åˆ†å¸ƒå¼äº‹åŠ¡æ¦‚å¿µç†è§£)
2. [RabbitMQä¸­çš„äº‹åŠ¡æ¨¡å¼](#2-RabbitMQä¸­çš„äº‹åŠ¡æ¨¡å¼)
3. [Sagaæ¨¡å¼å®ç°](#3-Sagaæ¨¡å¼å®ç°)
4. [å‘ä»¶ç®±æ¨¡å¼è®¾è®¡](#4-å‘ä»¶ç®±æ¨¡å¼è®¾è®¡)
5. [æœ€ç»ˆä¸€è‡´æ€§ä¿éšœ](#5-æœ€ç»ˆä¸€è‡´æ€§ä¿éšœ)
6. [è¡¥å¿æœºåˆ¶è®¾è®¡](#6-è¡¥å¿æœºåˆ¶è®¾è®¡)
7. [å®æˆ˜æ¡ˆä¾‹åˆ†æ](#7-å®æˆ˜æ¡ˆä¾‹åˆ†æ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ åˆ†å¸ƒå¼äº‹åŠ¡æ¦‚å¿µç†è§£


### 1.1 ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼äº‹åŠ¡


**ç®€å•ç†è§£**ï¼šåˆ†å¸ƒå¼äº‹åŠ¡å°±åƒæ˜¯åœ¨å¤šä¸ªä¸åŒçš„é“¶è¡Œä¹‹é—´è½¬è´¦ï¼Œè¦ç¡®ä¿è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚

```
ä¼ ç»Ÿå•æœºäº‹åŠ¡ï¼š                 åˆ†å¸ƒå¼äº‹åŠ¡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ•°æ®åº“A    â”‚               â”‚ æœåŠ¡A   â”‚â”€â”€â”€â”€â”‚ æœåŠ¡B   â”‚â”€â”€â”€â”€â”‚ æœåŠ¡C   â”‚
â”‚ è½¬è´¦æ“ä½œ     â”‚               â”‚ è®¢å•    â”‚    â”‚ æ”¯ä»˜    â”‚    â”‚ åº“å­˜    â”‚
â”‚ âœ… åŸå­æ€§   â”‚               â”‚ ç³»ç»Ÿ    â”‚    â”‚ ç³»ç»Ÿ    â”‚    â”‚ ç³»ç»Ÿ    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     ä¸€ä¸ªç³»ç»Ÿ                        ä¸‰ä¸ªç³»ç»Ÿéœ€è¦ååŒå·¥ä½œ
```

**ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼äº‹åŠ¡**ï¼š
- **ç³»ç»Ÿæ‹†åˆ†**ï¼šå¾®æœåŠ¡æ¶æ„ä¸‹ï¼Œä¸€ä¸ªä¸šåŠ¡æ¶‰åŠå¤šä¸ªæœåŠ¡
- **æ•°æ®åˆ†æ•£**ï¼šæ•°æ®åˆ†å¸ƒåœ¨ä¸åŒçš„æ•°æ®åº“ä¸­
- **ä¸€è‡´æ€§è¦æ±‚**ï¼šéœ€è¦ä¿è¯æ‰€æœ‰æ“ä½œè¦ä¹ˆå…¨æˆåŠŸï¼Œè¦ä¹ˆå…¨å¤±è´¥

### 1.2 åˆ†å¸ƒå¼äº‹åŠ¡çš„æŒ‘æˆ˜


**ğŸ”¸ ç½‘ç»œå»¶è¿Ÿä¸æ•…éšœ**
```
é—®é¢˜åœºæ™¯ï¼š
ç”¨æˆ·ä¸‹å• â†’ æ‰£åº“å­˜ â†’ æ‰£æ¬¾ â†’ å‘è´§

å¦‚æœåœ¨æ‰£æ¬¾æ—¶ç½‘ç»œæ–­äº†ï¼š
âœ… è®¢å•å·²åˆ›å»º
âœ… åº“å­˜å·²æ‰£å‡  
âŒ æ‰£æ¬¾å¤±è´¥
âŒ æ— æ³•å‘è´§

ç»“æœï¼šæ•°æ®ä¸ä¸€è‡´ï¼Œç”¨æˆ·æ²¡ä»˜é’±ä½†å•†å“è¢«æ‰£äº†
```

**ğŸ”¸ æ€§èƒ½ä¸å¯ç”¨æ€§æƒè¡¡**
```
å¼ºä¸€è‡´æ€§è¦æ±‚ï¼š
- æ‰€æœ‰æ“ä½œå¿…é¡»ç­‰å¾…ç¡®è®¤
- æ€§èƒ½ä¸‹é™ï¼Œå»¶è¿Ÿå¢åŠ 
- ä»»ä¸€æœåŠ¡æ•…éšœå½±å“å…¨å±€

æœ€ç»ˆä¸€è‡´æ€§ï¼š
- å…è®¸çŸ­æš‚çš„æ•°æ®ä¸ä¸€è‡´
- æ€§èƒ½æ›´å¥½ï¼Œå¯ç”¨æ€§æ›´é«˜
- é€šè¿‡è¡¥å¿æœºåˆ¶ä¿è¯æœ€ç»ˆä¸€è‡´
```

### 1.3 äº‹åŠ¡çš„ACIDç‰¹æ€§åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„å˜åŒ–


| ç‰¹æ€§ | **å•æœºäº‹åŠ¡** | **åˆ†å¸ƒå¼äº‹åŠ¡** | **å®ç°éš¾åº¦** |
|------|-------------|---------------|-------------|
| ğŸ”¸ **åŸå­æ€§(A)** | `æ•°æ®åº“ä¿è¯` | `éœ€è¦åè°ƒå™¨ç®¡ç†` | `â­â­â­â­` |
| ğŸ”¸ **ä¸€è‡´æ€§(C)** | `çº¦æŸæ£€æŸ¥` | `ä¸šåŠ¡å±‚ä¿è¯` | `â­â­â­â­â­` |
| ğŸ”¸ **éš”ç¦»æ€§(I)** | `é”æœºåˆ¶` | `åˆ†å¸ƒå¼é”æˆ–ç‰ˆæœ¬æ§åˆ¶` | `â­â­â­â­â­` |
| ğŸ”¸ **æŒä¹…æ€§(D)** | `æ—¥å¿—æœºåˆ¶` | `å¤šå‰¯æœ¬å­˜å‚¨` | `â­â­â­` |

---

## 2. ğŸ› ï¸ RabbitMQä¸­çš„äº‹åŠ¡æ¨¡å¼


### 2.1 RabbitMQäº‹åŠ¡æœºåˆ¶æ¦‚è§ˆ


**RabbitMQæä¾›çš„äº‹åŠ¡ä¿éšœ**ï¼š
- **å‘é€ç¡®è®¤**ï¼šç¡®ä¿æ¶ˆæ¯æˆåŠŸåˆ°è¾¾äº¤æ¢æœº
- **æŒä¹…åŒ–**ï¼šæ¶ˆæ¯å­˜å‚¨åˆ°ç£ç›˜ï¼ŒæœåŠ¡é‡å¯ä¸ä¸¢å¤±
- **æ¶ˆè´¹ç¡®è®¤**ï¼šç¡®ä¿æ¶ˆæ¯è¢«æ­£ç¡®å¤„ç†

```
äº‹åŠ¡æµç¨‹å›¾ï¼š
å‘é€æ–¹                    RabbitMQ                 æ¥æ”¶æ–¹
  |                         |                        |
  |--[1] å¼€å¯äº‹åŠ¡----------->|                        |
  |--[2] å‘é€æ¶ˆæ¯----------->|                        |
  |                         |--[3] å­˜å‚¨æ¶ˆæ¯--------->|æ•°æ®åº“
  |--[4] æäº¤äº‹åŠ¡----------->|                        |
  |<-[5] ç¡®è®¤æˆåŠŸ------------|                        |
  |                         |--[6] æŠ•é€’æ¶ˆæ¯--------->|
  |                         |<-[7] ACKç¡®è®¤-----------|
```

### 2.2 å‘å¸ƒç¡®è®¤æœºåˆ¶ï¼ˆPublisher Confirmsï¼‰


**ä»€ä¹ˆæ˜¯å‘å¸ƒç¡®è®¤**ï¼šå‘é€æ–¹ç¡®ä¿æ¶ˆæ¯å·²ç»è¢«RabbitMQæ¥æ”¶å¹¶å¤„ç†ã€‚

```java
// åŸºæœ¬å‘å¸ƒç¡®è®¤è®¾ç½®
public class PublisherConfirmDemo {
    
    public void sendWithConfirm(String message) {
        try {
            // å¼€å¯å‘å¸ƒç¡®è®¤æ¨¡å¼
            channel.confirmSelect();
            
            // å‘é€æ¶ˆæ¯
            channel.basicPublish("exchange", "routing.key", 
                MessageProperties.PERSISTENT_TEXT_PLAIN, 
                message.getBytes());
            
            // ç­‰å¾…ç¡®è®¤ï¼ˆåŒæ­¥æ–¹å¼ï¼‰
            boolean confirmed = channel.waitForConfirms(5000); // ç­‰å¾…5ç§’
            
            if (confirmed) {
                System.out.println("âœ… æ¶ˆæ¯å‘é€æˆåŠŸ");
            } else {
                System.out.println("âŒ æ¶ˆæ¯å‘é€å¤±è´¥ï¼Œéœ€è¦é‡è¯•");
                // é‡è¯•é€»è¾‘
                retryMessage(message);
            }
            
        } catch (Exception e) {
            System.out.println("âš ï¸ å‘é€å¼‚å¸¸ï¼š" + e.getMessage());
            // å¼‚å¸¸å¤„ç†é€»è¾‘
        }
    }
}
```

**å¼‚æ­¥ç¡®è®¤å¤„ç†**ï¼ˆæ¨èæ–¹å¼ï¼‰ï¼š
```java
public class AsyncPublisherConfirm {
    
    public void setupAsyncConfirm() {
        // ç¡®è®¤ç›‘å¬å™¨
        channel.addConfirmListener(
            // æˆåŠŸç¡®è®¤å›è°ƒ
            (deliveryTag, multiple) -> {
                System.out.println("âœ… æ¶ˆæ¯ç¡®è®¤æˆåŠŸ: " + deliveryTag);
                // ä»å¾…ç¡®è®¤é˜Ÿåˆ—ä¸­ç§»é™¤
                removeFromPendingConfirms(deliveryTag, multiple);
            },
            // å¤±è´¥ç¡®è®¤å›è°ƒ  
            (deliveryTag, multiple) -> {
                System.out.println("âŒ æ¶ˆæ¯ç¡®è®¤å¤±è´¥: " + deliveryTag);
                // é‡è¯•å¤±è´¥çš„æ¶ˆæ¯
                retryFailedMessages(deliveryTag, multiple);
            }
        );
    }
}
```

### 2.3 æ¶ˆæ¯æŒä¹…åŒ–ä¿éšœ


**ä¸‰å±‚æŒä¹…åŒ–ä¿éšœ**ï¼š
```java
// 1. äº¤æ¢æœºæŒä¹…åŒ–
channel.exchangeDeclare("durable.exchange", "direct", 
                       true,    // durable = trueï¼ŒæŒä¹…åŒ–äº¤æ¢æœº
                       false,   // autoDelete = false
                       null);

// 2. é˜Ÿåˆ—æŒä¹…åŒ–  
channel.queueDeclare("durable.queue",
                    true,     // durable = trueï¼ŒæŒä¹…åŒ–é˜Ÿåˆ—
                    false,    // exclusive = false
                    false,    // autoDelete = false
                    null);

// 3. æ¶ˆæ¯æŒä¹…åŒ–
channel.basicPublish("durable.exchange", "routing.key",
                    MessageProperties.PERSISTENT_TEXT_PLAIN, // æŒä¹…åŒ–æ¶ˆæ¯
                    message.getBytes());
```

**æŒä¹…åŒ–çš„ä»£ä»·ä¸æƒè¡¡**ï¼š
```
æŒä¹…åŒ–çº§åˆ«å¯¹æ¯”ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    æ¨¡å¼     â”‚   æ€§èƒ½      â”‚   å¯é æ€§    â”‚   ä½¿ç”¨åœºæ™¯   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å…¨éƒ¨å†…å­˜    â”‚   ğŸš€ğŸš€ğŸš€   â”‚    âš ï¸      â”‚  é«˜é¢‘ä½ä»·å€¼  â”‚
â”‚ éƒ¨åˆ†æŒä¹…åŒ–  â”‚   ğŸš€ğŸš€     â”‚   â­â­â­    â”‚  å¹³è¡¡åœºæ™¯   â”‚
â”‚ å…¨éƒ¨æŒä¹…åŒ–  â”‚   ğŸš€       â”‚  â­â­â­â­â­  â”‚  å…³é”®ä¸šåŠ¡   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. ğŸ”„ Sagaæ¨¡å¼å®ç°


### 3.1 ä»€ä¹ˆæ˜¯Sagaæ¨¡å¼


**Sagaæ¨¡å¼ç†è§£**ï¼šæŠŠä¸€ä¸ªå¤§çš„åˆ†å¸ƒå¼äº‹åŠ¡æ‹†åˆ†æˆå¤šä¸ªå°çš„æœ¬åœ°äº‹åŠ¡ï¼Œæ¯ä¸ªå°äº‹åŠ¡éƒ½æœ‰å¯¹åº”çš„è¡¥å¿æ“ä½œã€‚

```
è®¢å•ä¸šåŠ¡Sagaç¤ºä¾‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1.åˆ›å»ºè®¢å•   â”‚â”€â”€â”€â–¶â”‚ 2.æ‰£å‡åº“å­˜   â”‚â”€â”€â”€â–¶â”‚ 3.æ‰£å‡ç§¯åˆ†   â”‚â”€â”€â”€â–¶â”‚ 4.å‘é€é€šçŸ¥   â”‚
â”‚   (+è®¢å•)   â”‚    â”‚   (-åº“å­˜)   â”‚    â”‚   (-ç§¯åˆ†)   â”‚    â”‚   (+é€šçŸ¥)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                  â”‚                  â”‚                  â”‚
       â–¼                  â–¼                  â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¡¥å¿:åˆ é™¤è®¢å•â”‚    â”‚è¡¥å¿:æ¢å¤åº“å­˜ â”‚    â”‚è¡¥å¿:æ¢å¤ç§¯åˆ† â”‚    â”‚è¡¥å¿:æ’¤é”€é€šçŸ¥ â”‚
â”‚   (-è®¢å•)   â”‚    â”‚   (+åº“å­˜)   â”‚    â”‚   (+ç§¯åˆ†)   â”‚    â”‚   (-é€šçŸ¥)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¦‚æœç¬¬3æ­¥å¤±è´¥ï¼Œå°±æ‰§è¡Œå‰é¢æ­¥éª¤çš„è¡¥å¿æ“ä½œï¼š2â†’1
```

### 3.2 ç¼–æ’å¼Sagaå®ç°


**ä¸­å¤®åè°ƒå™¨æ¨¡å¼**ï¼š
```java
// Sagaåè°ƒå™¨
public class OrderSagaOrchestrator {
    
    private RabbitTemplate rabbitTemplate;
    private SagaStateManager stateManager;
    
    public void processOrder(OrderRequest request) {
        String sagaId = UUID.randomUUID().toString();
        
        // è®°å½•SagaçŠ¶æ€
        SagaState state = new SagaState(sagaId, request);
        stateManager.save(state);
        
        try {
            // æ­¥éª¤1ï¼šåˆ›å»ºè®¢å•
            executeStep1_CreateOrder(sagaId, request);
            
        } catch (Exception e) {
            // å¯åŠ¨è¡¥å¿æµç¨‹
            startCompensation(sagaId, 0);
        }
    }
    
    // æ­¥éª¤1ï¼šåˆ›å»ºè®¢å•
    private void executeStep1_CreateOrder(String sagaId, OrderRequest request) {
        OrderCreateCommand command = new OrderCreateCommand(sagaId, request);
        
        rabbitTemplate.convertAndSend("saga.exchange", "order.create", command);
        
        // æ›´æ–°çŠ¶æ€ï¼šç­‰å¾…è®¢å•åˆ›å»ºç»“æœ
        stateManager.updateState(sagaId, SagaStep.ORDER_CREATING);
    }
    
    // å¤„ç†è®¢å•åˆ›å»ºæˆåŠŸäº‹ä»¶
    @RabbitListener(queues = "saga.order.created")
    public void handleOrderCreated(OrderCreatedEvent event) {
        String sagaId = event.getSagaId();
        
        try {
            // æ­¥éª¤2ï¼šæ‰£å‡åº“å­˜
            executeStep2_ReduceInventory(sagaId, event.getOrderId());
            
        } catch (Exception e) {
            // è¡¥å¿ï¼šåˆ é™¤å·²åˆ›å»ºçš„è®¢å•
            compensateStep1_DeleteOrder(sagaId, event.getOrderId());
        }
    }
}
```

### 3.3 äº‹ä»¶é©±åŠ¨å¼Sagaå®ç°


**å»ä¸­å¿ƒåŒ–æ¨¡å¼**ï¼šæ¯ä¸ªæœåŠ¡è´Ÿè´£è‡ªå·±çš„äº‹åŠ¡å’Œè¡¥å¿é€»è¾‘ã€‚

```java
// è®¢å•æœåŠ¡
@Component
public class OrderService {
    
    @RabbitListener(queues = "order.create.queue")
    public void createOrder(OrderCreateCommand command) {
        try {
            // åˆ›å»ºè®¢å•
            Order order = orderRepository.save(new Order(command));
            
            // å‘å¸ƒè®¢å•åˆ›å»ºæˆåŠŸäº‹ä»¶
            OrderCreatedEvent event = new OrderCreatedEvent(
                command.getSagaId(), order.getId(), order.getItems()
            );
            rabbitTemplate.convertAndSend("saga.events", "order.created", event);
            
        } catch (Exception e) {
            // å‘å¸ƒè®¢å•åˆ›å»ºå¤±è´¥äº‹ä»¶
            OrderCreateFailedEvent failEvent = new OrderCreateFailedEvent(
                command.getSagaId(), e.getMessage()
            );
            rabbitTemplate.convertAndSend("saga.events", "order.create.failed", failEvent);
        }
    }
    
    // è¡¥å¿æ“ä½œï¼šåˆ é™¤è®¢å•
    @RabbitListener(queues = "order.compensate.queue")
    public void compensateOrder(OrderCompensateCommand command) {
        try {
            orderRepository.deleteById(command.getOrderId());
            
            // å‘å¸ƒè¡¥å¿æˆåŠŸäº‹ä»¶
            OrderCompensatedEvent event = new OrderCompensatedEvent(
                command.getSagaId(), command.getOrderId()
            );
            rabbitTemplate.convertAndSend("saga.events", "order.compensated", event);
            
        } catch (Exception e) {
            // è¡¥å¿å¤±è´¥å¤„ç†
            handleCompensationFailure(command, e);
        }
    }
}
```

**åº“å­˜æœåŠ¡çš„å¯¹åº”å®ç°**ï¼š
```java
@Component
public class InventoryService {
    
    // ç›‘å¬è®¢å•åˆ›å»ºæˆåŠŸäº‹ä»¶
    @RabbitListener(queues = "inventory.order.created.queue")
    public void handleOrderCreated(OrderCreatedEvent event) {
        try {
            // æ‰£å‡åº“å­˜
            for (OrderItem item : event.getItems()) {
                inventoryRepository.reduceStock(item.getProductId(), item.getQuantity());
            }
            
            // å‘å¸ƒåº“å­˜æ‰£å‡æˆåŠŸäº‹ä»¶
            InventoryReducedEvent successEvent = new InventoryReducedEvent(
                event.getSagaId(), event.getOrderId()
            );
            rabbitTemplate.convertAndSend("saga.events", "inventory.reduced", successEvent);
            
        } catch (InsufficientStockException e) {
            // åº“å­˜ä¸è¶³ï¼Œå‘å¸ƒå¤±è´¥äº‹ä»¶
            InventoryReduceFailedEvent failEvent = new InventoryReduceFailedEvent(
                event.getSagaId(), event.getOrderId(), "åº“å­˜ä¸è¶³"
            );
            rabbitTemplate.convertAndSend("saga.events", "inventory.reduce.failed", failEvent);
        }
    }
}
```

### 3.4 Sagaæ¨¡å¼çš„ä¼˜ç¼ºç‚¹å¯¹æ¯”


| æ–¹é¢ | **ç¼–æ’å¼Saga** | **äº‹ä»¶é©±åŠ¨å¼Saga** |
|------|----------------|-------------------|
| **å¤æ‚åº¦** | `ä¸­å¤®åè°ƒå™¨å¤æ‚` | `åˆ†å¸ƒå¼é€»è¾‘å¤æ‚` |
| **è€¦åˆåº¦** | `é«˜è€¦åˆ` | `ä½è€¦åˆ` |
| **å¯è§†åŒ–** | `æµç¨‹æ¸…æ™°` | `æµç¨‹åˆ†æ•£` |
| **æ‰©å±•æ€§** | `æ‰©å±•å›°éš¾` | `æ‰©å±•å®¹æ˜“` |
| **æ•…éšœå¤„ç†** | `é›†ä¸­å¤„ç†` | `åˆ†å¸ƒå¼å¤„ç†` |
| **é€‚ç”¨åœºæ™¯** | `ç®€å•æµç¨‹` | `å¤æ‚ä¸šåŠ¡` |

---

## 4. ğŸ“¤ å‘ä»¶ç®±æ¨¡å¼è®¾è®¡


### 4.1 å‘ä»¶ç®±æ¨¡å¼åŸç†


**ä»€ä¹ˆæ˜¯å‘ä»¶ç®±æ¨¡å¼**ï¼šå°±åƒå‘é‚®ä»¶ä¸€æ ·ï¼Œå…ˆæŠŠè¦å‘çš„æ¶ˆæ¯ä¿å­˜åœ¨"å‘ä»¶ç®±"é‡Œï¼Œç„¶åå†é€ä¸ªå‘é€å‡ºå»ã€‚

```
å‘ä»¶ç®±æ¨¡å¼æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä¸šåŠ¡æ“ä½œ   â”‚    â”‚   æ¶ˆæ¯å‘ä»¶ç®±  â”‚    â”‚   æ¶ˆæ¯é˜Ÿåˆ—   â”‚
â”‚             â”‚    â”‚             â”‚    â”‚             â”‚
â”‚ 1.æ‰§è¡Œä¸šåŠ¡   â”‚â”€â”€â”€â–¶â”‚ 2.ä¿å­˜æ¶ˆæ¯   â”‚â”€â”€â”€â–¶â”‚ 3.å‘é€æ¶ˆæ¯   â”‚
â”‚ 2.ä¿å­˜æ¶ˆæ¯   â”‚    â”‚   åˆ°æ•°æ®åº“   â”‚    â”‚   åˆ°RabbitMQ â”‚
â”‚  (åŒä¸€äº‹åŠ¡)  â”‚    â”‚             â”‚    â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     åŸå­æ“ä½œ          æœ¬åœ°å­˜å‚¨           å¼‚æ­¥å‘é€
```

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- **åŸå­æ€§ä¿è¯**ï¼šä¸šåŠ¡æ“ä½œå’Œæ¶ˆæ¯ä¿å­˜åœ¨åŒä¸€ä¸ªæœ¬åœ°äº‹åŠ¡ä¸­
- **æœ€ç»ˆä¸€è‡´æ€§**ï¼šå³ä½¿æ¶ˆæ¯å‘é€å¤±è´¥ï¼Œä¹Ÿå¯ä»¥é‡è¯•
- **æ€§èƒ½ä¼˜åŒ–**ï¼šå¼‚æ­¥å‘é€ï¼Œä¸é˜»å¡ä¸šåŠ¡æµç¨‹

### 4.2 å‘ä»¶ç®±æ¨¡å¼å®ç°


**æ•°æ®åº“è¡¨è®¾è®¡**ï¼š
```sql
-- å‘ä»¶ç®±è¡¨
CREATE TABLE outbox_events (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    aggregate_id VARCHAR(255) NOT NULL,      -- ä¸šåŠ¡èšåˆID
    event_type VARCHAR(255) NOT NULL,        -- äº‹ä»¶ç±»å‹
    event_data JSON NOT NULL,                -- äº‹ä»¶æ•°æ®
    routing_key VARCHAR(255),                -- è·¯ç”±é”®
    exchange_name VARCHAR(255),              -- äº¤æ¢æœºåç§°
    status VARCHAR(50) DEFAULT 'PENDING',    -- çŠ¶æ€ï¼šPENDING/SENT/FAILED
    retry_count INT DEFAULT 0,               -- é‡è¯•æ¬¡æ•°
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_status_created (status, created_at),
    INDEX idx_aggregate_id (aggregate_id)
);
```

**ä¸šåŠ¡æœåŠ¡å®ç°**ï¼š
```java
@Service
@Transactional
public class OrderService {
    
    @Autowired
    private OrderRepository orderRepository;
    
    @Autowired
    private OutboxEventRepository outboxRepository;
    
    public void createOrder(CreateOrderRequest request) {
        try {
            // 1. æ‰§è¡Œä¸šåŠ¡æ“ä½œ
            Order order = new Order(request);
            Order savedOrder = orderRepository.save(order);
            
            // 2. ä¿å­˜å‘ä»¶ç®±äº‹ä»¶ï¼ˆåŒä¸€äº‹åŠ¡ï¼‰
            OutboxEvent event = new OutboxEvent();
            event.setAggregateId(savedOrder.getId().toString());
            event.setEventType("OrderCreated");
            event.setEventData(buildOrderCreatedEventData(savedOrder));
            event.setExchangeName("order.events");
            event.setRoutingKey("order.created");
            event.setStatus(OutboxStatus.PENDING);
            
            outboxRepository.save(event);
            
            // äº‹åŠ¡æäº¤åï¼Œä¸šåŠ¡æ“ä½œå’Œäº‹ä»¶éƒ½å·²æŒä¹…åŒ–
            
        } catch (Exception e) {
            // äº‹åŠ¡å›æ»šï¼Œä¸šåŠ¡æ“ä½œå’Œäº‹ä»¶éƒ½ä¸ä¼šä¿å­˜
            throw new OrderCreationException("è®¢å•åˆ›å»ºå¤±è´¥", e);
        }
    }
    
    private String buildOrderCreatedEventData(Order order) {
        OrderCreatedEvent event = new OrderCreatedEvent();
        event.setOrderId(order.getId());
        event.setUserId(order.getUserId());
        event.setAmount(order.getTotalAmount());
        event.setItems(order.getItems());
        
        return JsonUtils.toJson(event);
    }
}
```

### 4.3 å‘ä»¶ç®±äº‹ä»¶å‘å¸ƒå™¨


**å®šæ—¶ä»»åŠ¡å‘å¸ƒå™¨**ï¼š
```java
@Component
public class OutboxEventPublisher {
    
    @Autowired
    private OutboxEventRepository outboxRepository;
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡å¾…å‘é€äº‹ä»¶
    @Scheduled(fixedDelay = 5000)
    public void publishPendingEvents() {
        List<OutboxEvent> pendingEvents = outboxRepository
            .findByStatusOrderByCreatedAt(OutboxStatus.PENDING, PageRequest.of(0, 100));
            
        for (OutboxEvent event : pendingEvents) {
            try {
                publishEvent(event);
                
            } catch (Exception e) {
                handlePublishFailure(event, e);
            }
        }
    }
    
    private void publishEvent(OutboxEvent event) {
        try {
            // å‘é€æ¶ˆæ¯åˆ°RabbitMQ
            rabbitTemplate.convertAndSend(
                event.getExchangeName(),
                event.getRoutingKey(),
                event.getEventData()
            );
            
            // æ ‡è®°ä¸ºå·²å‘é€
            event.setStatus(OutboxStatus.SENT);
            event.setUpdatedAt(LocalDateTime.now());
            outboxRepository.save(event);
            
            System.out.println("âœ… äº‹ä»¶å‘å¸ƒæˆåŠŸ: " + event.getId());
            
        } catch (Exception e) {
            throw new EventPublishException("äº‹ä»¶å‘å¸ƒå¤±è´¥", e);
        }
    }
    
    private void handlePublishFailure(OutboxEvent event, Exception e) {
        event.setRetryCount(event.getRetryCount() + 1);
        
        if (event.getRetryCount() >= 5) {
            // é‡è¯•æ¬¡æ•°è¿‡å¤šï¼Œæ ‡è®°ä¸ºå¤±è´¥
            event.setStatus(OutboxStatus.FAILED);
            System.out.println("âŒ äº‹ä»¶å‘å¸ƒå¤±è´¥ï¼Œé‡è¯•æ¬¡æ•°è¿‡å¤š: " + event.getId());
            
            // å¯ä»¥å‘é€å‘Šè­¦æˆ–è®°å½•åˆ°æ­»ä¿¡é˜Ÿåˆ—
            sendToDeadLetterQueue(event);
        }
        
        outboxRepository.save(event);
    }
}
```

### 4.4 å‘ä»¶ç®±æ¨¡å¼çš„å˜ç§


**CDCï¼ˆChange Data Captureï¼‰æ¨¡å¼**ï¼š
```
æ•°æ®åº“å˜æ›´æ•è·ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä¸šåŠ¡è¡¨     â”‚    â”‚   CDCç»„ä»¶    â”‚    â”‚  æ¶ˆæ¯é˜Ÿåˆ—    â”‚
â”‚             â”‚    â”‚             â”‚    â”‚             â”‚
â”‚ INSERT/     â”‚â”€â”€â”€â–¶â”‚ ç›‘å¬æ•°æ®åº“   â”‚â”€â”€â”€â–¶â”‚  å‘é€å˜æ›´    â”‚
â”‚ UPDATE/     â”‚    â”‚   å˜æ›´æ—¥å¿—   â”‚    â”‚    äº‹ä»¶     â”‚
â”‚ DELETE      â”‚    â”‚             â”‚    â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜åŠ¿ï¼šæ— éœ€ä¿®æ”¹ä¸šåŠ¡ä»£ç ï¼Œè‡ªåŠ¨æ•è·æ•°æ®å˜æ›´
å·¥å…·ï¼šDebezium, Maxwell, Canalç­‰
```

---

## 5. âš–ï¸ æœ€ç»ˆä¸€è‡´æ€§ä¿éšœ


### 5.1 æœ€ç»ˆä¸€è‡´æ€§çš„æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯æœ€ç»ˆä¸€è‡´æ€§**ï¼šç³»ç»Ÿåœ¨ä¸€æ®µæ—¶é—´åä¼šè¾¾åˆ°ä¸€è‡´çŠ¶æ€ï¼Œä½†åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å¯èƒ½ä¼šå‡ºç°çŸ­æš‚çš„ä¸ä¸€è‡´ã€‚

```
ç”µå•†ä¸‹å•åœºæ™¯çš„ä¸€è‡´æ€§çº§åˆ«ï¼š

å¼ºä¸€è‡´æ€§è¦æ±‚ï¼š
ä¸‹å•ç¬é—´ â†’ åº“å­˜ç«‹å³æ‰£å‡ â†’ æ”¯ä»˜ç«‹å³å®Œæˆ â†’ è®¢å•ç«‹å³ç”Ÿæˆ
ä¼˜ç‚¹ï¼šæ•°æ®å‡†ç¡®   ç¼ºç‚¹ï¼šæ€§èƒ½å·®ï¼Œå¯ç”¨æ€§ä½

æœ€ç»ˆä¸€è‡´æ€§ï¼š
ä¸‹å• â†’ å¼‚æ­¥æ‰£åº“å­˜ â†’ å¼‚æ­¥æ”¯ä»˜ â†’ å¼‚æ­¥æ›´æ–°è®¢å•çŠ¶æ€
        â†“             â†“           â†“
    (å¯èƒ½å»¶è¿Ÿ)    (å¯èƒ½å»¶è¿Ÿ)   (å¯èƒ½å»¶è¿Ÿ)
        â†“             â†“           â†“
      æœ€ç»ˆåŒæ­¥ â† â† â† â† â† â† â† â† â† â† â† â† â†
      
ä¼˜ç‚¹ï¼šæ€§èƒ½å¥½ï¼Œå¯ç”¨æ€§é«˜   ç¼ºç‚¹ï¼šçŸ­æš‚ä¸ä¸€è‡´
```

### 5.2 ä¸€è‡´æ€§çº§åˆ«é€‰æ‹©


**ä¸šåŠ¡åœºæ™¯ä¸ä¸€è‡´æ€§è¦æ±‚**ï¼š
```
ä¸€è‡´æ€§è¦æ±‚åˆ†çº§ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    ä¸šåŠ¡åœºæ™¯     â”‚   ä¸€è‡´æ€§è¦æ±‚  â”‚   å®ç°æ–¹å¼    â”‚   ç”¨æˆ·ä½“éªŒ    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é“¶è¡Œè½¬è´¦        â”‚   å¼ºä¸€è‡´æ€§    â”‚  åˆ†å¸ƒå¼äº‹åŠ¡   â”‚  ç­‰å¾…æ—¶é—´é•¿   â”‚
â”‚ ç”µå•†ä¸‹å•        â”‚  æœ€ç»ˆä¸€è‡´æ€§   â”‚  å¼‚æ­¥è¡¥å¿    â”‚  å¿«é€Ÿå“åº”    â”‚
â”‚ ç¤¾äº¤ç‚¹èµ        â”‚   å¼±ä¸€è‡´æ€§    â”‚  å¼‚æ­¥æ›´æ–°    â”‚  å®æ—¶åé¦ˆ    â”‚
â”‚ æ•°æ®ç»Ÿè®¡        â”‚   å¼±ä¸€è‡´æ€§    â”‚  å®šæ—¶åŒæ­¥    â”‚  å»¶è¿Ÿå¯æ¥å—   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 å¹‚ç­‰æ€§ä¿éšœ


**ä»€ä¹ˆæ˜¯å¹‚ç­‰æ€§**ï¼šåŒæ ·çš„æ“ä½œæ‰§è¡Œå¤šæ¬¡ï¼Œç»“æœåº”è¯¥æ˜¯ä¸€æ ·çš„ã€‚

```java
// æ¶ˆæ¯å¤„ç†çš„å¹‚ç­‰æ€§å®ç°
@Component
public class PaymentProcessor {
    
    @Autowired
    private PaymentRepository paymentRepository;
    
    @RabbitListener(queues = "payment.process.queue")
    public void processPayment(PaymentMessage message) {
        String idempotencyKey = message.getIdempotencyKey();
        
        // 1. æ£€æŸ¥æ˜¯å¦å·²å¤„ç†è¿‡
        if (paymentRepository.existsByIdempotencyKey(idempotencyKey)) {
            System.out.println("ğŸ’¡ æ”¯ä»˜å·²å¤„ç†è¿‡ï¼Œè·³è¿‡: " + idempotencyKey);
            return;  // å¹‚ç­‰å¤„ç†
        }
        
        try {
            // 2. å¤„ç†æ”¯ä»˜ä¸šåŠ¡
            Payment payment = new Payment();
            payment.setIdempotencyKey(idempotencyKey);
            payment.setOrderId(message.getOrderId());
            payment.setAmount(message.getAmount());
            payment.setStatus(PaymentStatus.PROCESSING);
            
            // 3. è°ƒç”¨æ”¯ä»˜æ¥å£
            PaymentResult result = paymentGateway.processPayment(message);
            
            if (result.isSuccess()) {
                payment.setStatus(PaymentStatus.SUCCESS);
                payment.setTransactionId(result.getTransactionId());
            } else {
                payment.setStatus(PaymentStatus.FAILED);
                payment.setFailureReason(result.getFailureReason());
            }
            
            // 4. ä¿å­˜æ”¯ä»˜è®°å½•ï¼ˆåŒ…å«å¹‚ç­‰é”®ï¼‰
            paymentRepository.save(payment);
            
            // 5. å‘å¸ƒæ”¯ä»˜ç»“æœäº‹ä»¶
            publishPaymentResultEvent(payment);
            
        } catch (Exception e) {
            // å¼‚å¸¸å¤„ç†ï¼šè®°å½•å¤±è´¥çŠ¶æ€
            recordPaymentFailure(idempotencyKey, message, e);
        }
    }
}
```

**å¹‚ç­‰é”®çš„ç”Ÿæˆç­–ç•¥**ï¼š
```java
public class IdempotencyKeyGenerator {
    
    // æ–¹å¼1ï¼šä¸šåŠ¡å­—æ®µç»„åˆ
    public static String generateForOrder(String orderId, String userId) {
        return "order_" + orderId + "_" + userId;
    }
    
    // æ–¹å¼2ï¼šæ¶ˆæ¯ID + æ“ä½œç±»å‹
    public static String generateForMessage(String messageId, String operation) {
        return operation + "_" + messageId;
    }
    
    // æ–¹å¼3ï¼šæ—¶é—´çª—å£ + ä¸šåŠ¡æ ‡è¯†
    public static String generateWithTimeWindow(String businessId) {
        long timeWindow = System.currentTimeMillis() / (5 * 60 * 1000); // 5åˆ†é’Ÿçª—å£
        return businessId + "_" + timeWindow;
    }
}
```

### 5.4 æ•°æ®æœ€ç»ˆä¸€è‡´æ€§æ£€æŸ¥


**æ•°æ®å¯¹è´¦æœºåˆ¶**ï¼š
```java
@Component
public class DataConsistencyChecker {
    
    // æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡å¯¹è´¦
    @Scheduled(cron = "0 0 * * * ?")
    public void checkOrderConsistency() {
        LocalDateTime checkTime = LocalDateTime.now().minusHours(1);
        
        // æŸ¥æ‰¾ä¸€å°æ—¶å‰åˆ›å»ºä½†çŠ¶æ€ä¸ä¸€è‡´çš„è®¢å•
        List<Order> inconsistentOrders = orderRepository
            .findInconsistentOrders(checkTime);
            
        for (Order order : inconsistentOrders) {
            reconcileOrder(order);
        }
    }
    
    private void reconcileOrder(Order order) {
        try {
            // 1. æ£€æŸ¥åº“å­˜çŠ¶æ€
            InventoryStatus inventoryStatus = inventoryService
                .checkInventoryStatus(order.getId());
                
            // 2. æ£€æŸ¥æ”¯ä»˜çŠ¶æ€  
            PaymentStatus paymentStatus = paymentService
                .checkPaymentStatus(order.getId());
                
            // 3. æ ¹æ®æ£€æŸ¥ç»“æœå†³å®šè¡¥å¿æ“ä½œ
            if (inventoryStatus == InventoryStatus.REDUCED && 
                paymentStatus == PaymentStatus.FAILED) {
                
                // æ”¯ä»˜å¤±è´¥ä½†åº“å­˜å·²æ‰£ï¼Œéœ€è¦æ¢å¤åº“å­˜
                compensateInventory(order);
                
            } else if (inventoryStatus == InventoryStatus.INSUFFICIENT && 
                      paymentStatus == PaymentStatus.SUCCESS) {
                
                // åº“å­˜ä¸è¶³ä½†æ”¯ä»˜æˆåŠŸï¼Œéœ€è¦é€€æ¬¾
                compensatePayment(order);
            }
            
        } catch (Exception e) {
            // å¯¹è´¦å¼‚å¸¸ï¼Œè®°å½•æ—¥å¿—å¹¶å‘Šè­¦
            alertInconsistentData(order, e);
        }
    }
}
```

---

## 6. ğŸ”§ è¡¥å¿æœºåˆ¶è®¾è®¡


### 6.1 è¡¥å¿æ“ä½œçš„è®¾è®¡åŸåˆ™


**è¡¥å¿æ“ä½œå¿…é¡»æ»¡è¶³çš„ç‰¹æ€§**ï¼š
- **å¹‚ç­‰æ€§**ï¼šå¤šæ¬¡æ‰§è¡Œç»“æœç›¸åŒ
- **å¯é‡è¯•**ï¼šå¤±è´¥åå¯ä»¥é‡æ–°æ‰§è¡Œ
- **å¯å›æ»š**ï¼šèƒ½å¤Ÿæ’¤é”€ä¹‹å‰çš„æ“ä½œ

```
è¡¥å¿æ“ä½œè®¾è®¡ç¤ºä¾‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    åŸå§‹æ“ä½œ      â”‚    è¡¥å¿æ“ä½œ      â”‚    æ³¨æ„äº‹é¡¹      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åˆ›å»ºè®¢å•         â”‚ åˆ é™¤è®¢å•         â”‚ æ£€æŸ¥è®¢å•çŠ¶æ€     â”‚
â”‚ æ‰£å‡åº“å­˜         â”‚ æ¢å¤åº“å­˜         â”‚ é˜²æ­¢è¶…å–        â”‚
â”‚ æ‰£å‡ç§¯åˆ†         â”‚ æ¢å¤ç§¯åˆ†         â”‚ æ£€æŸ¥ç§¯åˆ†ä½™é¢     â”‚
â”‚ å‘é€é‚®ä»¶         â”‚ å‘é€æ’¤é”€é‚®ä»¶     â”‚ è®°å½•é‚®ä»¶çŠ¶æ€     â”‚
â”‚ è°ƒç”¨ç¬¬ä¸‰æ–¹API    â”‚ è°ƒç”¨æ’¤é”€API      â”‚ æ£€æŸ¥APIçŠ¶æ€     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 è¡¥å¿ç­–ç•¥å®ç°


**é‡è¯•æœºåˆ¶è®¾è®¡**ï¼š
```java
@Component
public class CompensationManager {
    
    private static final int MAX_RETRY_COUNT = 3;
    private static final long RETRY_DELAY_MS = 1000;
    
    public void executeCompensation(CompensationTask task) {
        int retryCount = 0;
        
        while (retryCount < MAX_RETRY_COUNT) {
            try {
                // æ‰§è¡Œè¡¥å¿æ“ä½œ
                task.execute();
                
                // æˆåŠŸåˆ™è·³å‡ºå¾ªç¯
                System.out.println("âœ… è¡¥å¿æ“ä½œæˆåŠŸ: " + task.getTaskId());
                return;
                
            } catch (Exception e) {
                retryCount++;
                
                if (retryCount >= MAX_RETRY_COUNT) {
                    // é‡è¯•æ¬¡æ•°ç”¨å®Œï¼Œè®°å½•å¤±è´¥
                    handleCompensationFailure(task, e);
                    break;
                }
                
                // ç­‰å¾…åé‡è¯•
                try {
                    Thread.sleep(RETRY_DELAY_MS * retryCount); // é€’å¢å»¶è¿Ÿ
                } catch (InterruptedException ie) {
                    Thread.currentThread().interrupt();
                    break;
                }
                
                System.out.println("âš ï¸ è¡¥å¿æ“ä½œé‡è¯• " + retryCount + "/" + MAX_RETRY_COUNT 
                                 + ": " + task.getTaskId());
            }
        }
    }
    
    private void handleCompensationFailure(CompensationTask task, Exception e) {
        // 1. è®°å½•è¡¥å¿å¤±è´¥æ—¥å¿—
        compensationFailureRepository.save(
            new CompensationFailure(task.getTaskId(), e.getMessage())
        );
        
        // 2. å‘é€å‘Šè­¦é€šçŸ¥
        alertService.sendCompensationFailureAlert(task, e);
        
        // 3. äººå·¥å¹²é¢„å¤„ç†
        manualInterventionQueue.add(task);
    }
}
```

**åˆ†å±‚è¡¥å¿ç­–ç•¥**ï¼š
```java
public class LayeredCompensationStrategy {
    
    public void handleSagaFailure(String sagaId, int failedStep) {
        switch (failedStep) {
            case 1: // è®¢å•åˆ›å»ºå¤±è´¥
                // æ— éœ€è¡¥å¿ï¼Œç›´æ¥è¿”å›å¤±è´¥
                notifyUserOrderFailed(sagaId);
                break;
                
            case 2: // åº“å­˜æ‰£å‡å¤±è´¥  
                // è¡¥å¿ï¼šåˆ é™¤å·²åˆ›å»ºçš„è®¢å•
                compensateOrderCreation(sagaId);
                break;
                
            case 3: // æ”¯ä»˜å¤±è´¥
                // è¡¥å¿ï¼šæ¢å¤åº“å­˜ + åˆ é™¤è®¢å•
                compensateInventoryReduction(sagaId);
                compensateOrderCreation(sagaId);
                break;
                
            case 4: // é€šçŸ¥å‘é€å¤±è´¥
                // è¡¥å¿ï¼šé€€æ¬¾ + æ¢å¤åº“å­˜ + åˆ é™¤è®¢å•
                compensatePayment(sagaId);
                compensateInventoryReduction(sagaId);
                compensateOrderCreation(sagaId);
                break;
        }
    }
}
```

### 6.3 äººå·¥å¹²é¢„æœºåˆ¶


**å½“è‡ªåŠ¨è¡¥å¿å¤±è´¥æ—¶çš„å¤„ç†**ï¼š
```java
@RestController
@RequestMapping("/admin/compensation")
public class ManualCompensationController {
    
    @GetMapping("/failed-tasks")
    public List<FailedCompensationTask> getFailedTasks() {
        return compensationService.getFailedTasks();
    }
    
    @PostMapping("/retry/{taskId}")
    public ResponseEntity<?> retryCompensation(@PathVariable String taskId) {
        try {
            compensationService.manualRetry(taskId);
            return ResponseEntity.ok("é‡è¯•æˆåŠŸ");
            
        } catch (Exception e) {
            return ResponseEntity.badRequest()
                .body("é‡è¯•å¤±è´¥: " + e.getMessage());
        }
    }
    
    @PostMapping("/mark-resolved/{taskId}")
    public ResponseEntity<?> markResolved(@PathVariable String taskId, 
                                        @RequestBody String resolution) {
        compensationService.markManuallyResolved(taskId, resolution);
        return ResponseEntity.ok("å·²æ ‡è®°ä¸ºäººå·¥è§£å†³");
    }
}
```

---

## 7. ğŸ¯ å®æˆ˜æ¡ˆä¾‹åˆ†æ


### 7.1 ç”µå•†è®¢å•ç³»ç»Ÿçš„å®Œæ•´äº‹åŠ¡è®¾è®¡


**ä¸šåŠ¡æµç¨‹åˆ†æ**ï¼š
```
ç”¨æˆ·ä¸‹å•å®Œæ•´æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1.åˆ›å»ºè®¢å•  â”‚â”€â”€â”€â–¶â”‚  2.æ£€æŸ¥åº“å­˜  â”‚â”€â”€â”€â–¶â”‚   3.æ‰£æ¬¾    â”‚â”€â”€â”€â–¶â”‚  4.å®‰æ’å‘è´§  â”‚
â”‚   è®¢å•æœåŠ¡   â”‚    â”‚   åº“å­˜æœåŠ¡   â”‚    â”‚   æ”¯ä»˜æœåŠ¡   â”‚    â”‚   ç‰©æµæœåŠ¡   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                  â”‚                  â”‚                  â”‚
       â–¼                  â–¼                  â–¼                  â–¼
å¦‚æœå¤±è´¥çš„è¡¥å¿æ“ä½œï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     æ— æ“ä½œ   â”‚    â”‚   åˆ é™¤è®¢å•   â”‚    â”‚æ¢å¤åº“å­˜+åˆ å•â”‚    â”‚å…¨éƒ¨å›æ»šæ“ä½œ  â”‚
â”‚             â”‚    â”‚             â”‚    â”‚             â”‚    â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…·ä½“å®ç°æ¶æ„**ï¼š
```java
// è®¢å•èšåˆæ ¹
@Entity
public class Order {
    private String id;
    private String userId;
    private OrderStatus status;
    private List<OrderItem> items;
    private BigDecimal totalAmount;
    
    // å‘ä»¶ç®±äº‹ä»¶åˆ—è¡¨
    @Transient
    private List<DomainEvent> domainEvents = new ArrayList<>();
    
    public void createOrder(CreateOrderRequest request) {
        // ä¸šåŠ¡é€»è¾‘éªŒè¯
        validateOrderRequest(request);
        
        // è®¾ç½®è®¢å•å±æ€§
        this.id = generateOrderId();
        this.userId = request.getUserId();
        this.items = request.getItems();
        this.totalAmount = calculateTotalAmount(items);
        this.status = OrderStatus.PENDING;
        
        // æ·»åŠ é¢†åŸŸäº‹ä»¶
        addDomainEvent(new OrderCreatedEvent(this));
    }
    
    public void confirmPayment(String paymentId, BigDecimal amount) {
        if (this.status != OrderStatus.PENDING) {
            throw new IllegalStateException("è®¢å•çŠ¶æ€ä¸æ­£ç¡®");
        }
        
        if (!this.totalAmount.equals(amount)) {
            throw new IllegalArgumentException("æ”¯ä»˜é‡‘é¢ä¸åŒ¹é…");
        }
        
        this.status = OrderStatus.PAID;
        addDomainEvent(new OrderPaidEvent(this.id, paymentId, amount));
    }
}
```

### 7.2 åº“å­˜æœåŠ¡çš„äº‹åŠ¡å¤„ç†


**åº“å­˜æœåŠ¡å®ç°**ï¼š
```java
@Service
public class InventoryService {
    
    @Autowired
    private InventoryRepository inventoryRepository;
    
    @Autowired
    private OutboxEventRepository outboxRepository;
    
    @RabbitListener(queues = "inventory.check.queue")
    @Transactional
    public void handleOrderCreated(OrderCreatedEvent event) {
        try {
            // 1. æ£€æŸ¥åº“å­˜
            for (OrderItem item : event.getItems()) {
                Inventory inventory = inventoryRepository
                    .findByProductId(item.getProductId());
                    
                if (inventory.getStock() < item.getQuantity()) {
                    throw new InsufficientStockException(
                        "å•†å“åº“å­˜ä¸è¶³: " + item.getProductId()
                    );
                }
            }
            
            // 2. é¢„æ‰£åº“å­˜
            for (OrderItem item : event.getItems()) {
                inventoryRepository.reserveStock(
                    item.getProductId(), 
                    item.getQuantity(),
                    event.getOrderId()  // é¢„æ‰£è®°å½•
                );
            }
            
            // 3. è®°å½•åº“å­˜æ£€æŸ¥æˆåŠŸäº‹ä»¶
            OutboxEvent outboxEvent = new OutboxEvent();
            outboxEvent.setEventType("InventoryReserved");
            outboxEvent.setAggregateId(event.getOrderId());
            outboxEvent.setEventData(JsonUtils.toJson(
                new InventoryReservedEvent(event.getOrderId(), event.getItems())
            ));
            outboxRepository.save(outboxEvent);
            
        } catch (InsufficientStockException e) {
            // åº“å­˜ä¸è¶³ï¼Œå‘å¸ƒåº“å­˜æ£€æŸ¥å¤±è´¥äº‹ä»¶
            publishInventoryCheckFailedEvent(event.getOrderId(), e.getMessage());
        }
    }
    
    // è¡¥å¿æ“ä½œï¼šé‡Šæ”¾é¢„æ‰£åº“å­˜
    @RabbitListener(queues = "inventory.compensate.queue")
    @Transactional
    public void compensateReservation(InventoryCompensateCommand command) {
        try {
            inventoryRepository.releaseReservedStock(
                command.getOrderId()
            );
            
            publishInventoryCompensatedEvent(command.getOrderId());
            
        } catch (Exception e) {
            // è¡¥å¿å¤±è´¥ï¼Œéœ€è¦äººå·¥å¤„ç†
            handleCompensationFailure(command, e);
        }
    }
}
```

### 7.3 ç›‘æ§å’Œå‘Šè­¦è®¾è®¡


**å…³é”®æŒ‡æ ‡ç›‘æ§**ï¼š
```java
@Component
public class TransactionMonitor {
    
    private MeterRegistry meterRegistry;
    
    // äº‹åŠ¡æˆåŠŸç‡ç›‘æ§
    public void recordTransactionResult(String transactionType, boolean success) {
        Timer.Sample sample = Timer.start(meterRegistry);
        
        Counter.builder("transaction.count")
            .tag("type", transactionType)
            .tag("result", success ? "success" : "failure")
            .register(meterRegistry)
            .increment();
            
        sample.stop(Timer.builder("transaction.duration")
            .tag("type", transactionType)
            .register(meterRegistry));
    }
    
    // è¡¥å¿æ“ä½œç›‘æ§
    public void recordCompensationResult(String compensationType, boolean success) {
        Counter.builder("compensation.count")
            .tag("type", compensationType)
            .tag("result", success ? "success" : "failure")
            .register(meterRegistry)
            .increment();
    }
    
    // æ¶ˆæ¯é‡è¯•ç›‘æ§
    @EventListener
    public void handleMessageRetry(MessageRetryEvent event) {
        Gauge.builder("message.retry.count")
            .tag("queue", event.getQueueName())
            .register(meterRegistry, () -> event.getRetryCount());
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ åˆ†å¸ƒå¼äº‹åŠ¡ï¼šè·¨å¤šä¸ªæœåŠ¡çš„äº‹åŠ¡æ“ä½œï¼Œéœ€è¦ä¿è¯æ•°æ®ä¸€è‡´æ€§
ğŸ”¸ Sagaæ¨¡å¼ï¼šé•¿äº‹åŠ¡åˆ†è§£ä¸ºå¤šä¸ªçŸ­äº‹åŠ¡ï¼Œæ¯ä¸ªéƒ½æœ‰è¡¥å¿æ“ä½œ
ğŸ”¸ å‘ä»¶ç®±æ¨¡å¼ï¼šæœ¬åœ°äº‹åŠ¡ä¿è¯ä¸šåŠ¡å’Œæ¶ˆæ¯çš„åŸå­æ€§
ğŸ”¸ æœ€ç»ˆä¸€è‡´æ€§ï¼šå…è®¸çŸ­æš‚ä¸ä¸€è‡´ï¼Œé€šè¿‡è¡¥å¿æœºåˆ¶æœ€ç»ˆè¾¾åˆ°ä¸€è‡´
ğŸ”¸ è¡¥å¿æœºåˆ¶ï¼šäº‹åŠ¡å¤±è´¥æ—¶çš„å›æ»šå’Œä¿®å¤ç­–ç•¥
```

### 8.2 å…³é”®æŠ€æœ¯è¦ç‚¹


**ğŸ”¹ äº‹åŠ¡æ¨¡å¼é€‰æ‹©åŸåˆ™**
```
ä¸šåŠ¡åœºæ™¯å†³å®šæŠ€æœ¯æ–¹æ¡ˆï¼š
- å¼ºä¸€è‡´æ€§è¦æ±‚ â†’ åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆ2PC/3PCï¼‰
- æ€§èƒ½ä¼˜å…ˆåœºæ™¯ â†’ æœ€ç»ˆä¸€è‡´æ€§ï¼ˆSaga/å‘ä»¶ç®±ï¼‰
- ç®€å•ä¸šåŠ¡æµç¨‹ â†’ ç¼–æ’å¼Saga
- å¤æ‚ä¸šåŠ¡é€»è¾‘ â†’ äº‹ä»¶é©±åŠ¨Saga
```

**ğŸ”¹ å¯é æ€§ä¿éšœç­–ç•¥**
```
å¤šå±‚æ¬¡çš„å¯é æ€§ä¿éšœï¼š
1. æ¶ˆæ¯æŒä¹…åŒ–ï¼šé˜²æ­¢æ¶ˆæ¯ä¸¢å¤±
2. å‘å¸ƒç¡®è®¤ï¼šç¡®ä¿æ¶ˆæ¯åˆ°è¾¾é˜Ÿåˆ—
3. æ¶ˆè´¹ç¡®è®¤ï¼šç¡®ä¿æ¶ˆæ¯è¢«æ­£ç¡®å¤„ç†  
4. å¹‚ç­‰å¤„ç†ï¼šé˜²æ­¢é‡å¤å¤„ç†
5. è¡¥å¿æœºåˆ¶ï¼šå¤„ç†å¼‚å¸¸æƒ…å†µ
6. ç›‘æ§å‘Šè­¦ï¼šåŠæ—¶å‘ç°é—®é¢˜
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–è€ƒè™‘**
```
æ€§èƒ½ä¸ä¸€è‡´æ€§çš„å¹³è¡¡ï¼š
- å¼‚æ­¥å¤„ç†æå‡æ€§èƒ½
- æ‰¹é‡æ“ä½œå‡å°‘ç½‘ç»œå¼€é”€
- åˆç†è®¾ç½®é‡è¯•ç­–ç•¥
- é¿å…åˆ†å¸ƒå¼é”çš„è¿‡åº¦ä½¿ç”¨
- ä½¿ç”¨ç¼“å­˜å‡å°‘æ•°æ®åº“å‹åŠ›
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


**é€‚ç”¨åœºæ™¯åˆ¤æ–­**ï¼š
- âœ… **ç”µå•†ä¸‹å•**ï¼šå¤šæœåŠ¡åè°ƒï¼Œé€‚åˆSagaæ¨¡å¼
- âœ… **æ”¯ä»˜ç³»ç»Ÿ**ï¼šé«˜å¯é æ€§è¦æ±‚ï¼Œä½¿ç”¨å‘ä»¶ç®±æ¨¡å¼
- âœ… **åº“å­˜ç®¡ç†**ï¼šéœ€è¦è¡¥å¿æœºåˆ¶ï¼Œé˜²æ­¢è¶…å–
- âœ… **è®¢å•å±¥çº¦**ï¼šé•¿æµç¨‹ï¼Œé€‚åˆäº‹ä»¶é©±åŠ¨æ¶æ„

**é¿å…å¸¸è§é™·é˜±**ï¼š
- âŒ **è¿‡åº¦è®¾è®¡**ï¼šç®€å•åœºæ™¯ä¸è¦ä½¿ç”¨å¤æ‚çš„åˆ†å¸ƒå¼äº‹åŠ¡
- âŒ **å¿½ç•¥å¹‚ç­‰æ€§**ï¼šé‡å¤å¤„ç†å¯¼è‡´æ•°æ®é”™è¯¯
- âŒ **è¡¥å¿æ“ä½œä¸å½“**ï¼šè¡¥å¿é€»è¾‘ä¸å®Œæ•´æˆ–æœ‰bug
- âŒ **ç›‘æ§ä¸è¶³**ï¼šæ— æ³•åŠæ—¶å‘ç°å’Œå¤„ç†å¼‚å¸¸

### 8.4 æœ€ä½³å®è·µå»ºè®®


```
è®¾è®¡åŸåˆ™ï¼š
1. ä¼˜å…ˆé€‰æ‹©æœ€ç»ˆä¸€è‡´æ€§è€Œéå¼ºä¸€è‡´æ€§
2. è¡¥å¿æ“ä½œå¿…é¡»å¹‚ç­‰ä¸”å¯é‡è¯•
3. é‡è¦ä¸šåŠ¡æ“ä½œéœ€è¦äººå·¥å…œåº•æœºåˆ¶
4. å®Œå–„çš„ç›‘æ§å’Œå‘Šè­¦ä½“ç³»
5. è¯¦ç»†çš„æ“ä½œæ—¥å¿—å’Œå®¡è®¡è·Ÿè¸ª

å¼€å‘å»ºè®®ï¼š
1. å…ˆè®¾è®¡æ­£å¸¸æµç¨‹ï¼Œå†è®¾è®¡å¼‚å¸¸å¤„ç†
2. æ¯ä¸ªæœåŠ¡è´Ÿè´£è‡ªå·±çš„æ•°æ®ä¸€è‡´æ€§
3. ä½¿ç”¨äº‹ä»¶æº¯æºè®°å½•å®Œæ•´çš„æ“ä½œå†å²
4. å®šæœŸè¿›è¡Œæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥å’Œä¿®å¤
5. å»ºç«‹å®Œå–„çš„æµ‹è¯•å’Œæ¼”ç»ƒæœºåˆ¶
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- åˆ†å¸ƒå¼äº‹åŠ¡é‡åœ¨è®¾è®¡ï¼Œè€ŒéæŠ€æœ¯å®ç°
- æœ€ç»ˆä¸€è‡´æ€§é€šå¸¸æ¯”å¼ºä¸€è‡´æ€§æ›´å®ç”¨
- è¡¥å¿æœºåˆ¶æ˜¯åˆ†å¸ƒå¼äº‹åŠ¡çš„æ ¸å¿ƒä¿éšœ
- ç›‘æ§å’Œäººå·¥å¹²é¢„æ˜¯å¿…è¦çš„å…œåº•æ‰‹æ®µ
- ä¸šåŠ¡åœºæ™¯å†³å®šæŠ€æœ¯é€‰å‹ï¼Œä¸è¦è¿‡åº¦è®¾è®¡