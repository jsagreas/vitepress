---
title: 5ã€é£æ§ç³»ç»Ÿè®¾è®¡
---
## ğŸ“š ç›®å½•

1. [é£æ§ç³»ç»ŸåŸºç¡€æ¦‚å¿µ](#1-é£æ§ç³»ç»ŸåŸºç¡€æ¦‚å¿µ)
2. [RabbitMQåœ¨é£æ§ä¸­çš„ä½œç”¨](#2-RabbitMQåœ¨é£æ§ä¸­çš„ä½œç”¨)
3. [å®æ—¶é£æ§è§„åˆ™è®¾è®¡](#3-å®æ—¶é£æ§è§„åˆ™è®¾è®¡)
4. [å¼‚å¸¸è¡Œä¸ºæ£€æµ‹å®ç°](#4-å¼‚å¸¸è¡Œä¸ºæ£€æµ‹å®ç°)
5. [é»‘åå•åŒæ­¥æœºåˆ¶](#5-é»‘åå•åŒæ­¥æœºåˆ¶)
6. [äººå·¥å®¡æ ¸æµç¨‹è®¾è®¡](#6-äººå·¥å®¡æ ¸æµç¨‹è®¾è®¡)
7. [é£é™©è¯„åˆ†ç³»ç»Ÿæ¶æ„](#7-é£é™©è¯„åˆ†ç³»ç»Ÿæ¶æ„)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ›¡ï¸ é£æ§ç³»ç»ŸåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯é£æ§ç³»ç»Ÿ


**é£æ§ç³»ç»Ÿå°±åƒé“¶è¡Œçš„"æ™ºèƒ½ä¿å®‰"**ï¼Œå®ƒçš„ä½œç”¨æ˜¯ï¼š

```
ç°å®ç±»æ¯”ï¼š
é“¶è¡Œä¿å®‰ â†’ è§‚å¯Ÿå¯ç–‘è¡Œä¸º â†’ åŠæ—¶é˜»æ­¢ â†’ ä¿æŠ¤èµ„é‡‘å®‰å…¨
é£æ§ç³»ç»Ÿ â†’ ç›‘æ§äº¤æ˜“è¡Œä¸º â†’ å®æ—¶æ‹¦æˆª â†’ é˜²èŒƒé‡‘èé£é™©
```

**é£æ§ç³»ç»Ÿçš„æ ¸å¿ƒèŒè´£**ï¼š
- **ğŸ” å®æ—¶ç›‘æ§**ï¼šåƒç›‘æ§æ‘„åƒå¤´ä¸€æ ·ï¼Œ24å°æ—¶ç›‘æ§æ‰€æœ‰äº¤æ˜“
- **âš¡ å¿«é€Ÿå“åº”**ï¼šå‘ç°å¼‚å¸¸ç«‹å³å¤„ç†ï¼Œä¸èƒ½ç­‰ç¬¬äºŒå¤©
- **ğŸ¯ ç²¾å‡†è¯†åˆ«**ï¼šåŒºåˆ†æ­£å¸¸ç”¨æˆ·å’Œå¯ç–‘è¡Œä¸º
- **ğŸ“Š é£é™©è¯„ä¼°**ï¼šç»™æ¯ç¬”äº¤æ˜“æ‰“ä¸ª"é£é™©åˆ†æ•°"

### 1.2 é£æ§ç³»ç»Ÿçš„å·¥ä½œæµç¨‹


```
ç”¨æˆ·å‘èµ·äº¤æ˜“
      â†“
  é£æ§ç³»ç»Ÿæ£€æµ‹ â† è¿™é‡Œéœ€è¦æå¿«çš„å“åº”é€Ÿåº¦
      â†“
 â”Œâ”€é£é™©è¯„åˆ†â”€â”
 â”‚         â”‚
ä½é£é™©    é«˜é£é™©
 â”‚         â”‚
ç›´æ¥é€šè¿‡  äººå·¥å®¡æ ¸/æ‹’ç»
```

> ğŸ’¡ **å…³é”®ç†è§£**  
> é£æ§ç³»ç»Ÿæœ€é‡è¦çš„æ˜¯**é€Ÿåº¦**å’Œ**å‡†ç¡®æ€§**ã€‚ç”¨æˆ·è½¬è´¦æ—¶ä¸èƒ½ç­‰å‡ åˆ†é’Ÿæ‰çŸ¥é“ç»“æœï¼Œå¿…é¡»ç§’çº§å“åº”ã€‚

### 1.3 ä¼ ç»Ÿé£æ§ç³»ç»Ÿçš„ç—›ç‚¹


**ä¸ºä»€ä¹ˆéœ€è¦ç”¨RabbitMQï¼Ÿ**

| **ä¼ ç»Ÿæ–¹æ¡ˆé—®é¢˜** | **å…·ä½“è¡¨ç°** | **å½±å“ç»“æœ** |
|----------------|-------------|-------------|
| ğŸ¢ **å¤„ç†é€Ÿåº¦æ…¢** | åŒæ­¥è°ƒç”¨å¤šä¸ªé£æ§è§„åˆ™ | ç”¨æˆ·ç­‰å¾…æ—¶é—´é•¿ |
| ğŸ’¥ **ç³»ç»Ÿè€¦åˆå¼º** | ä¸€ä¸ªè§„åˆ™æ•…éšœå½±å“å…¨éƒ¨ | æ•´ä¸ªäº¤æ˜“è¢«é˜»æ–­ |
| ğŸ“ˆ **æ‰©å±•æ€§å·®** | æ–°å¢è§„åˆ™éœ€è¦æ”¹ä»£ç  | ä¸Šçº¿å‘¨æœŸé•¿ |
| ğŸ”„ **å®æ—¶æ€§ä¸è¶³** | é»‘åå•æ›´æ–°å»¶è¿Ÿ | é£é™©ç”¨æˆ·ç»§ç»­ä½œæ¶ |

---

## 2. ğŸš€ RabbitMQåœ¨é£æ§ä¸­çš„ä½œç”¨


### 2.1 è§£å†³æ–¹æ¡ˆæ¶æ„


```
äº¤æ˜“è¯·æ±‚ â†’ [APIç½‘å…³] â†’ [é£æ§æ¶ˆæ¯é˜Ÿåˆ—] â†’ [å¤šä¸ªé£æ§è§„åˆ™å¹¶è¡Œå¤„ç†]
                                           â†“
            [ç»“æœæ±‡æ€»] â† [é£æ§å†³ç­–å¼•æ“] â† [å„è§„åˆ™ç»“æœ]
                â†“
            è¿”å›å†³ç­–ç»“æœ
```

**RabbitMQçš„æ ¸å¿ƒä»·å€¼**ï¼š

```
ğŸ”¸ å¼‚æ­¥å¤„ç†ï¼šé£æ§æ£€æµ‹ä¸é˜»å¡äº¤æ˜“æµç¨‹
ğŸ”¸ è§£è€¦åˆï¼šå„ä¸ªé£æ§è§„åˆ™ç‹¬ç«‹è¿è¡Œ
ğŸ”¸ é«˜å¯ç”¨ï¼šæŸä¸ªè§„åˆ™æ•…éšœä¸å½±å“å…¶ä»–è§„åˆ™
ğŸ”¸ å¯æ‰©å±•ï¼šæ–°å¢é£æ§è§„åˆ™å°±åƒæ·»åŠ æ–°çš„æ¶ˆè´¹è€…
ğŸ”¸ å®æ—¶æ€§ï¼šæ¶ˆæ¯é©±åŠ¨ï¼Œæ¯«ç§’çº§å“åº”
```

### 2.2 æ¶ˆæ¯é˜Ÿåˆ—è®¾è®¡æ¨¡å¼


**1. Fanoutæ¨¡å¼ - å¹¿æ’­é£æ§æ£€æµ‹**

```
äº¤æ˜“æ¶ˆæ¯ â†’ [é£æ§Exchange] â†’ é˜Ÿåˆ—1(åæ´—é’±è§„åˆ™)
                          â†’ é˜Ÿåˆ—2(å¼‚å¸¸è¡Œä¸ºæ£€æµ‹)  
                          â†’ é˜Ÿåˆ—3(é»‘åå•æ£€æŸ¥)
                          â†’ é˜Ÿåˆ—4(é£é™©è¯„åˆ†)
```

> ğŸ“Œ **åº”ç”¨åœºæ™¯**  
> ä¸€ç¬”äº¤æ˜“éœ€è¦åŒæ—¶è¢«å¤šä¸ªé£æ§è§„åˆ™æ£€æµ‹ï¼Œå°±åƒå®‰æ£€æ—¶éœ€è¦è¿‡Xå…‰ã€é‡‘å±æ¢æµ‹å™¨ã€äººå·¥æ£€æŸ¥ä¸€æ ·ã€‚

**2. Topicæ¨¡å¼ - ç²¾å‡†è·¯ç”±**

```java
// ä¸åŒç±»å‹äº¤æ˜“èµ°ä¸åŒé£æ§æµç¨‹
transfer.domestic.small    â†’ ç®€åŒ–é£æ§
transfer.international.*   â†’ ä¸¥æ ¼é£æ§  
payment.credit_card.*      â†’ ä¿¡ç”¨å¡ä¸“ç”¨é£æ§
```

**3. å·¥ä½œé˜Ÿåˆ—æ¨¡å¼ - è´Ÿè½½å‡è¡¡**

```
é«˜å¹¶å‘äº¤æ˜“ â†’ [é£æ§é˜Ÿåˆ—] â†’ æ¶ˆè´¹è€…1
                       â†’ æ¶ˆè´¹è€…2  
                       â†’ æ¶ˆè´¹è€…3
```

---

## 3. âš¡ å®æ—¶é£æ§è§„åˆ™è®¾è®¡


### 3.1 é£æ§è§„åˆ™çš„åˆ†ç±»


**æŒ‰å¤„ç†æ—¶é—´åˆ†ç±»**ï¼š

| **è§„åˆ™ç±»å‹** | **å¤„ç†æ—¶é—´** | **å…¸å‹åº”ç”¨** | **RabbitMQç­–ç•¥** |
|-------------|-------------|-------------|------------------|
| ğŸƒ **ç§’çº§è§„åˆ™** | < 100ms | é»‘åå•æ£€æŸ¥ã€é™é¢æ ¡éªŒ | ä¼˜å…ˆé˜Ÿåˆ—ï¼Œé¢„åŠ è½½æ•°æ® |
| ğŸš¶ **åˆ†é’Ÿçº§è§„åˆ™** | 1-5åˆ†é’Ÿ | è¡Œä¸ºæ¨¡å¼åˆ†æ | æ™®é€šé˜Ÿåˆ—ï¼Œå¼‚æ­¥å¤„ç† |
| ğŸŒ **å°æ—¶çº§è§„åˆ™** | > 30åˆ†é’Ÿ | å¤æ‚å…³è”åˆ†æ | å»¶è¿Ÿé˜Ÿåˆ—ï¼Œæ‰¹é‡å¤„ç† |

### 3.2 å®æ—¶é£æ§è§„åˆ™å®ç°


**é»‘åå•æ£€æŸ¥è§„åˆ™ç¤ºä¾‹**ï¼š

```java
@Component
public class BlacklistRiskRule {
    
    @RabbitListener(queues = "risk.blacklist.queue")
    public void checkBlacklist(TransactionMessage transaction) {
        
        // 1. å¿«é€Ÿæ£€æŸ¥ - ä¼˜å…ˆæ£€æŸ¥é«˜é£é™©ç”¨æˆ·
        if (isInBlacklist(transaction.getUserId())) {
            // ç«‹å³æ‹’ç»
            sendRiskResult(transaction, "REJECT", "ç”¨æˆ·åœ¨é»‘åå•ä¸­");
            return;
        }
        
        // 2. æ·±åº¦æ£€æŸ¥ - æ£€æŸ¥å…³è”è´¦æˆ·
        if (hasBlacklistConnection(transaction)) {
            sendRiskResult(transaction, "REVIEW", "å­˜åœ¨é»‘åå•å…³è”");
            return;
        }
        
        // 3. é€šè¿‡æ£€æŸ¥
        sendRiskResult(transaction, "PASS", "é»‘åå•æ£€æŸ¥é€šè¿‡");
    }
    
    private boolean isInBlacklist(String userId) {
        // ä»Redisç¼“å­˜å¿«é€ŸæŸ¥è¯¢
        return redisTemplate.hasKey("blacklist:" + userId);
    }
}
```

**é™é¢è§„åˆ™æ£€æŸ¥**ï¼š

```java
@RabbitListener(queues = "risk.limit.queue")
public void checkTransactionLimit(TransactionMessage transaction) {
    
    String userId = transaction.getUserId();
    BigDecimal amount = transaction.getAmount();
    
    // æ£€æŸ¥å•ç¬”é™é¢
    if (amount.compareTo(getSingleLimit(userId)) > 0) {
        sendRiskResult(transaction, "REJECT", "è¶…è¿‡å•ç¬”é™é¢");
        return;
    }
    
    // æ£€æŸ¥æ—¥ç´¯è®¡é™é¢  
    BigDecimal dailySum = getDailySum(userId);
    if (dailySum.add(amount).compareTo(getDailyLimit(userId)) > 0) {
        sendRiskResult(transaction, "REJECT", "è¶…è¿‡æ—¥ç´¯è®¡é™é¢");
        return;
    }
    
    sendRiskResult(transaction, "PASS", "é™é¢æ£€æŸ¥é€šè¿‡");
}
```

### 3.3 è§„åˆ™ä¼˜å…ˆçº§è®¾è®¡


```java
// ä½¿ç”¨RabbitMQçš„ä¼˜å…ˆçº§é˜Ÿåˆ—
@RabbitListener(queues = "risk.priority.queue")
public void processRiskCheck(
    @Payload TransactionMessage transaction,
    @Header Map<String, Object> headers) {
    
    Integer priority = (Integer) headers.get("x-priority");
    
    switch (priority) {
        case 10: // æœ€é«˜ä¼˜å…ˆçº§ - å¤§é¢äº¤æ˜“
            processHighValueTransaction(transaction);
            break;
        case 5:  // ä¸­ç­‰ä¼˜å…ˆçº§ - å¯ç–‘è¡Œä¸º
            processSuspiciousBehavior(transaction);
            break;
        case 1:  // ä½ä¼˜å…ˆçº§ - å¸¸è§„æ£€æŸ¥
            processRoutineCheck(transaction);
            break;
    }
}
```

---

## 4. ğŸ” å¼‚å¸¸è¡Œä¸ºæ£€æµ‹å®ç°


### 4.1 å¼‚å¸¸è¡Œä¸ºçš„ç±»å‹


**ä»€ä¹ˆæ˜¯å¼‚å¸¸è¡Œä¸ºï¼Ÿç”¨ç”Ÿæ´»ä¾‹å­æ¥ç†è§£**ï¼š

```
æ­£å¸¸è¡Œä¸ºï¼šå°æ˜å¹³æ—¶åœ¨ATMå–200å…ƒï¼Œä»Šå¤©ä¹Ÿå–200å…ƒ âœ…
å¼‚å¸¸è¡Œä¸ºï¼šå°æ˜å¹³æ—¶å–200å…ƒï¼Œä»Šå¤©çªç„¶å–50000å…ƒ âš ï¸

æ­£å¸¸è¡Œä¸ºï¼šç”¨æˆ·ç™½å¤©9ç‚¹è½¬è´¦ç»™æœ‹å‹ âœ…  
å¼‚å¸¸è¡Œä¸ºï¼šç”¨æˆ·å‡Œæ™¨3ç‚¹è½¬è´¦ç»™é™Œç”Ÿäºº âš ï¸
```

**ä¸»è¦å¼‚å¸¸è¡Œä¸ºç±»å‹**ï¼š

| **å¼‚å¸¸ç±»å‹** | **è¯†åˆ«ç‰¹å¾** | **é£é™©ç­‰çº§** |
|-------------|-------------|-------------|
| ğŸ’° **é‡‘é¢å¼‚å¸¸** | äº¤æ˜“é‡‘é¢è¿œè¶…å†å²å¹³å‡å€¼ | ğŸ”´ é«˜é£é™© |
| â° **æ—¶é—´å¼‚å¸¸** | éå¸¸è§„æ—¶é—´æ®µäº¤æ˜“ | ğŸŸ¡ ä¸­é£é™© |
| ğŸ“ **åœ°ç‚¹å¼‚å¸¸** | å¼‚åœ°ç™»å½•è½¬è´¦ | ğŸŸ¡ ä¸­é£é™© |
| ğŸ”„ **é¢‘ç‡å¼‚å¸¸** | çŸ­æ—¶é—´å¤§é‡äº¤æ˜“ | ğŸ”´ é«˜é£é™© |
| ğŸ‘¥ **å¯¹è±¡å¼‚å¸¸** | å‘å¤šä¸ªé™Œç”Ÿè´¦æˆ·è½¬è´¦ | ğŸ”´ é«˜é£é™© |

### 4.2 å¼‚å¸¸æ£€æµ‹ç®—æ³•å®ç°


**åŸºäºå†å²è¡Œä¸ºçš„å¼‚å¸¸æ£€æµ‹**ï¼š

```java
@Component  
public class BehaviorAnomalyDetector {
    
    @RabbitListener(queues = "risk.behavior.queue")
    public void detectAnomaly(TransactionMessage transaction) {
        
        // è·å–ç”¨æˆ·å†å²è¡Œä¸ºç”»åƒ
        UserBehaviorProfile profile = getUserProfile(transaction.getUserId());
        
        // 1. é‡‘é¢å¼‚å¸¸æ£€æµ‹
        double amountScore = calculateAmountAnomalyScore(
            transaction.getAmount(), profile.getAvgAmount());
            
        // 2. æ—¶é—´å¼‚å¸¸æ£€æµ‹  
        double timeScore = calculateTimeAnomalyScore(
            transaction.getTimestamp(), profile.getActiveHours());
            
        // 3. ç»¼åˆè¯„åˆ†
        double totalScore = amountScore * 0.4 + timeScore * 0.3 + ...;
        
        if (totalScore > 0.8) {
            sendRiskResult(transaction, "REVIEW", "è¡Œä¸ºå¼‚å¸¸è¯„åˆ†: " + totalScore);
        } else {
            sendRiskResult(transaction, "PASS", "è¡Œä¸ºæ­£å¸¸");
        }
    }
    
    private double calculateAmountAnomalyScore(BigDecimal amount, BigDecimal avgAmount) {
        // ä½¿ç”¨æ ‡å‡†å·®æ£€æµ‹å¼‚å¸¸
        double ratio = amount.divide(avgAmount, 2, RoundingMode.HALF_UP).doubleValue();
        if (ratio > 5.0) return 1.0;  // è¶…è¿‡å¹³å‡å€¼5å€è®¤ä¸ºé«˜åº¦å¼‚å¸¸
        if (ratio > 2.0) return 0.6;  // è¶…è¿‡å¹³å‡å€¼2å€è®¤ä¸ºä¸­åº¦å¼‚å¸¸
        return 0.1;  // æ­£å¸¸èŒƒå›´
    }
}
```

### 4.3 å®æ—¶è¡Œä¸ºç›‘æ§


**æ»‘åŠ¨çª—å£æ£€æµ‹**ï¼š

```java
@RabbitListener(queues = "risk.frequency.queue")
public void checkTransactionFrequency(TransactionMessage transaction) {
    
    String userId = transaction.getUserId();
    String windowKey = "freq:" + userId + ":" + getCurrentHour();
    
    // ä½¿ç”¨Redisè®¡æ•°å™¨å®ç°æ»‘åŠ¨çª—å£
    Long count = redisTemplate.opsForValue().increment(windowKey);
    redisTemplate.expire(windowKey, 1, TimeUnit.HOURS);
    
    // æ£€æŸ¥é¢‘ç‡æ˜¯å¦å¼‚å¸¸
    if (count > 10) {  // 1å°æ—¶å†…è¶…è¿‡10ç¬”äº¤æ˜“
        sendRiskResult(transaction, "REVIEW", "äº¤æ˜“é¢‘ç‡å¼‚å¸¸: " + count + "ç¬”/å°æ—¶");
    } else {
        sendRiskResult(transaction, "PASS", "äº¤æ˜“é¢‘ç‡æ­£å¸¸");
    }
}
```

---

## 5. ğŸ“‹ é»‘åå•åŒæ­¥æœºåˆ¶


### 5.1 é»‘åå•ç®¡ç†çš„æŒ‘æˆ˜


**ä¸ºä»€ä¹ˆé»‘åå•åŒæ­¥å¾ˆé‡è¦ï¼Ÿ**

```
åœºæ™¯ï¼š
ä¸Šåˆ10ç‚¹ - ç”¨æˆ·Aè¢«å‘ç°æ´—é’±ï¼ŒåŠ å…¥é»‘åå•
ä¸Šåˆ10ç‚¹01åˆ† - ç”¨æˆ·Aåˆå‘èµ·ä¸€ç¬”å¤§é¢è½¬è´¦
é—®é¢˜ï¼šå¦‚æœé»‘åå•æ²¡åŠæ—¶åŒæ­¥ï¼Œè¿™ç¬”è½¬è´¦å¯èƒ½ä¼šæˆåŠŸï¼
```

**ä¼ ç»ŸåŒæ­¥æ–¹å¼çš„é—®é¢˜**ï¼š
- **â° å»¶è¿Ÿé«˜**ï¼šæ•°æ®åº“è½®è¯¢ï¼Œå‡ åˆ†é’Ÿæ‰æ›´æ–°ä¸€æ¬¡
- **ğŸ’¾ èµ„æºæµªè´¹**ï¼šé¢‘ç¹æŸ¥è¯¢æ•°æ®åº“æ¶ˆè€—æ€§èƒ½  
- **ğŸ”„ æ•°æ®ä¸ä¸€è‡´**ï¼šå¤šä¸ªæœåŠ¡èŠ‚ç‚¹æ›´æ–°æ—¶é—´ä¸åŒ

### 5.2 åŸºäºRabbitMQçš„é»‘åå•åŒæ­¥


**å‘å¸ƒ-è®¢é˜…æ¨¡å¼å®ç°å®æ—¶åŒæ­¥**ï¼š

```
é»‘åå•ç®¡ç†ç³»ç»Ÿ â†’ [é»‘åå•æ›´æ–°Exchange] â†’ é£æ§æœåŠ¡1
                                    â†’ é£æ§æœåŠ¡2
                                    â†’ é£æ§æœåŠ¡3
                                    â†’ ç¼“å­˜æœåŠ¡
```

**å®ç°ä»£ç **ï¼š

```java
// é»‘åå•æ›´æ–°å‘å¸ƒè€…
@Service
public class BlacklistUpdateService {
    
    public void addToBlacklist(String userId, String reason) {
        // 1. æ•°æ®åº“æ›´æ–°
        blacklistRepository.save(new BlacklistRecord(userId, reason));
        
        // 2. å‘å¸ƒæ›´æ–°æ¶ˆæ¯
        BlacklistUpdateMessage message = new BlacklistUpdateMessage();
        message.setUserId(userId);
        message.setOperation("ADD");
        message.setReason(reason);
        message.setTimestamp(System.currentTimeMillis());
        
        rabbitTemplate.convertAndSend("blacklist.update.exchange", "", message);
    }
}

// é»‘åå•æ›´æ–°æ¶ˆè´¹è€…
@Component
public class BlacklistSyncConsumer {
    
    @RabbitListener(queues = "blacklist.sync.queue")
    public void syncBlacklist(BlacklistUpdateMessage message) {
        
        String userId = message.getUserId();
        
        switch (message.getOperation()) {
            case "ADD":
                // ç«‹å³æ·»åŠ åˆ°æœ¬åœ°ç¼“å­˜
                redisTemplate.opsForSet().add("blacklist", userId);
                log.info("ç”¨æˆ·{}å·²åŠ å…¥é»‘åå•: {}", userId, message.getReason());
                break;
                
            case "REMOVE":
                // ç«‹å³ä»æœ¬åœ°ç¼“å­˜ç§»é™¤
                redisTemplate.opsForSet().remove("blacklist", userId);
                log.info("ç”¨æˆ·{}å·²ç§»å‡ºé»‘åå•", userId);
                break;
        }
    }
}
```

### 5.3 å¤šçº§ç¼“å­˜ç­–ç•¥


```java
@Component
public class BlacklistCacheManager {
    
    // æœ¬åœ°ç¼“å­˜ - æœ€å¿«è®¿é—®
    private final Cache<String, Boolean> localCache = 
        Caffeine.newBuilder().maximumSize(10000).expireAfterWrite(5, TimeUnit.MINUTES).build();
    
    public boolean isInBlacklist(String userId) {
        // 1. å…ˆæŸ¥æœ¬åœ°ç¼“å­˜
        Boolean result = localCache.getIfPresent(userId);
        if (result != null) {
            return result;
        }
        
        // 2. æŸ¥Redisç¼“å­˜  
        Boolean redisResult = redisTemplate.opsForSet().isMember("blacklist", userId);
        if (redisResult != null) {
            localCache.put(userId, redisResult);
            return redisResult;
        }
        
        // 3. æœ€åæŸ¥æ•°æ®åº“
        boolean dbResult = blacklistRepository.existsByUserId(userId);
        localCache.put(userId, dbResult);
        return dbResult;
    }
    
    @RabbitListener(queues = "blacklist.cache.invalidate")
    public void invalidateCache(String userId) {
        // æ”¶åˆ°æ›´æ–°æ¶ˆæ¯æ—¶æ¸…é™¤æœ¬åœ°ç¼“å­˜
        localCache.invalidate(userId);
    }
}
```

---

## 6. ğŸ‘¨â€ğŸ’¼ äººå·¥å®¡æ ¸æµç¨‹è®¾è®¡


### 6.1 ä»€ä¹ˆæ—¶å€™éœ€è¦äººå·¥å®¡æ ¸


**è‡ªåŠ¨åŒ–vsäººå·¥å®¡æ ¸çš„åˆ†å·¥**ï¼š

```
è‡ªåŠ¨åŒ–å¤„ç†ï¼š
- æ˜ç¡®çš„è§„åˆ™è¿åï¼ˆå¦‚é»‘åå•ç”¨æˆ·ï¼‰
- ç®€å•çš„é™é¢æ£€æŸ¥
- å¸¸è§çš„å¼‚å¸¸æ¨¡å¼

äººå·¥å®¡æ ¸ï¼š  
- å¤æ‚çš„å¯ç–‘è¡Œä¸º
- ä»‹äºé£é™©ä¸´ç•Œå€¼çš„äº¤æ˜“
- æ–°å‹æ”»å‡»æ¨¡å¼
- å¤§é¢ç‰¹æ®Šäº¤æ˜“
```

### 6.2 äººå·¥å®¡æ ¸é˜Ÿåˆ—è®¾è®¡


**å®¡æ ¸ä¼˜å…ˆçº§é˜Ÿåˆ—**ï¼š

```java
public enum ReviewPriority {
    URGENT(10),     // ç´§æ€¥ - å¤§é¢å¯ç–‘äº¤æ˜“
    HIGH(7),        // é«˜ä¼˜å…ˆçº§ - å·²çŸ¥é£é™©ç”¨æˆ·
    NORMAL(5),      // æ™®é€š - ä¸€èˆ¬å¯ç–‘è¡Œä¸º  
    LOW(1);         // ä½ä¼˜å…ˆçº§ - ä¾‹è¡Œæ£€æŸ¥
}

@Service
public class ManualReviewService {
    
    public void submitForReview(TransactionMessage transaction, String riskReason) {
        
        ReviewTask task = new ReviewTask();
        task.setTransactionId(transaction.getTransactionId());
        task.setUserId(transaction.getUserId());
        task.setAmount(transaction.getAmount());
        task.setRiskReason(riskReason);
        task.setSubmitTime(System.currentTimeMillis());
        
        // æ ¹æ®é£é™©ç­‰çº§ç¡®å®šä¼˜å…ˆçº§
        int priority = determinePriority(transaction, riskReason);
        
        // å‘é€åˆ°ç›¸åº”ä¼˜å…ˆçº§çš„å®¡æ ¸é˜Ÿåˆ—
        MessageProperties properties = new MessageProperties();
        properties.setPriority(priority);
        
        Message message = new Message(JSON.toJSONBytes(task), properties);
        rabbitTemplate.send("review.exchange", "review.queue", message);
    }
}
```

### 6.3 å®¡æ ¸å·¥ä½œå°æ¶ˆè´¹è€…


```java
@Component
public class ReviewWorkbenchConsumer {
    
    @RabbitListener(queues = "review.urgent.queue")
    public void processUrgentReview(ReviewTask task) {
        // ç´§æ€¥å®¡æ ¸ - ç«‹å³æ¨é€ç»™åœ¨çº¿å®¡æ ¸å‘˜
        notifyOnlineReviewers(task);
        updateTaskStatus(task.getTaskId(), "URGENT_ASSIGNED");
    }
    
    @RabbitListener(queues = "review.normal.queue") 
    public void processNormalReview(ReviewTask task) {
        // æ™®é€šå®¡æ ¸ - åŠ å…¥å®¡æ ¸å‘˜å·¥ä½œé˜Ÿåˆ—
        assignToAvailableReviewer(task);
        updateTaskStatus(task.getTaskId(), "PENDING_REVIEW");
    }
    
    private void notifyOnlineReviewers(ReviewTask task) {
        // é€šè¿‡WebSocketæ¨é€ç»™åœ¨çº¿å®¡æ ¸å‘˜
        OnlineReviewer reviewer = getAvailableReviewer();
        if (reviewer != null) {
            websocketService.pushUrgentTask(reviewer.getId(), task);
        } else {
            // æ²¡æœ‰åœ¨çº¿å®¡æ ¸å‘˜åˆ™å‘é€è­¦æŠ¥
            alertService.sendNoReviewerAlert(task);
        }
    }
}
```

### 6.4 å®¡æ ¸ç»“æœå¤„ç†


```java
@Service
public class ReviewResultProcessor {
    
    @RabbitListener(queues = "review.result.queue")
    public void processReviewResult(ReviewResultMessage result) {
        
        String transactionId = result.getTransactionId();
        ReviewDecision decision = result.getDecision();
        
        switch (decision) {
            case APPROVE:
                // å®¡æ ¸é€šè¿‡ - ç»§ç»­äº¤æ˜“æµç¨‹
                continueTransaction(transactionId);
                updateRiskProfile(result.getUserId(), "APPROVED");
                break;
                
            case REJECT:
                // å®¡æ ¸æ‹’ç» - æ‹’ç»äº¤æ˜“å¹¶è®°å½•
                rejectTransaction(transactionId, result.getRejectReason());
                updateRiskProfile(result.getUserId(), "REJECTED");
                break;
                
            case ESCALATE:
                // å‡çº§å®¡æ ¸ - è½¬ç»™é«˜çº§å®¡æ ¸å‘˜
                escalateToSeniorReviewer(result);
                break;
        }
        
        // è®°å½•å®¡æ ¸æ—¥å¿—
        auditLogService.recordReviewDecision(result);
    }
}
```

---

## 7. ğŸ“Š é£é™©è¯„åˆ†ç³»ç»Ÿæ¶æ„


### 7.1 é£é™©è¯„åˆ†çš„åŸºæœ¬æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯é£é™©è¯„åˆ†ï¼Ÿ**

```
ç±»æ¯”ï¼šä¿¡ç”¨å¡ç”³è¯·æ—¶çš„ä¿¡ç”¨è¯„åˆ†
è¾“å…¥ï¼šå¹´é¾„ã€æ”¶å…¥ã€å·¥ä½œã€ä¿¡ç”¨è®°å½•
è¾“å‡ºï¼šä¿¡ç”¨åˆ†æ•° (300-850)
å†³ç­–ï¼šåˆ†æ•°é«˜â†’æ‰¹å‡†ï¼Œåˆ†æ•°ä½â†’æ‹’ç»

é£é™©è¯„åˆ†ç³»ç»Ÿï¼š  
è¾“å…¥ï¼šç”¨æˆ·è¡Œä¸ºã€äº¤æ˜“ç‰¹å¾ã€å†å²è®°å½•
è¾“å‡ºï¼šé£é™©åˆ†æ•° (0-100)
å†³ç­–ï¼šåˆ†æ•°ä½â†’é€šè¿‡ï¼Œåˆ†æ•°é«˜â†’å®¡æ ¸/æ‹’ç»
```

### 7.2 è¯„åˆ†è§„åˆ™è®¾è®¡


**åˆ†å±‚è¯„åˆ†æ¶æ„**ï¼š

```
ç¬¬ä¸€å±‚ï¼šåŸºç¡€é£é™©å› å­
â”œâ”€ ç”¨æˆ·ç­‰çº§è¯„åˆ† (0-20åˆ†)
â”œâ”€ äº¤æ˜“é‡‘é¢è¯„åˆ† (0-20åˆ†)  
â”œâ”€ æ—¶é—´åœ°ç‚¹è¯„åˆ† (0-20åˆ†)
â”œâ”€ è¡Œä¸ºæ¨¡å¼è¯„åˆ† (0-20åˆ†)
â””â”€ è®¾å¤‡ç¯å¢ƒè¯„åˆ† (0-20åˆ†)

ç¬¬äºŒå±‚ï¼šè§„åˆ™æƒé‡è°ƒæ•´
â”œâ”€ é»‘åå•ç”¨æˆ· (+50åˆ†)
â”œâ”€ æ–°æ³¨å†Œç”¨æˆ· (+10åˆ†)
â”œâ”€ VIPç”¨æˆ· (-10åˆ†)
â””â”€ å¼‚å¸¸è®¾å¤‡ (+15åˆ†)

ç¬¬ä¸‰å±‚ï¼šæœ€ç»ˆè¯„åˆ†
æ€»è¯„åˆ† = Î£(åŸºç¡€è¯„åˆ† Ã— æƒé‡) + è°ƒæ•´åˆ†
```

### 7.3 å®æ—¶è¯„åˆ†è®¡ç®—


```java
@Component
public class RiskScoringEngine {
    
    @RabbitListener(queues = "risk.scoring.queue")
    public void calculateRiskScore(TransactionMessage transaction) {
        
        RiskScoreCard scoreCard = new RiskScoreCard();
        
        // 1. åŸºç¡€è¯„åˆ†è®¡ç®—
        int userLevelScore = calculateUserLevelScore(transaction.getUserId());
        int amountScore = calculateAmountScore(transaction.getAmount());
        int timeScore = calculateTimeScore(transaction.getTimestamp());
        int behaviorScore = calculateBehaviorScore(transaction);
        int deviceScore = calculateDeviceScore(transaction.getDeviceInfo());
        
        scoreCard.setBaseScore(userLevelScore + amountScore + timeScore + 
                              behaviorScore + deviceScore);
        
        // 2. è§„åˆ™æƒé‡è°ƒæ•´
        applyRiskRules(scoreCard, transaction);
        
        // 3. å†å²è¡Œä¸ºåŠ æƒ
        applyHistoryWeight(scoreCard, transaction.getUserId());
        
        // 4. å‘é€è¯„åˆ†ç»“æœ
        RiskScoreResult result = new RiskScoreResult();
        result.setTransactionId(transaction.getTransactionId());
        result.setFinalScore(scoreCard.getFinalScore());
        result.setRiskLevel(determineRiskLevel(scoreCard.getFinalScore()));
        
        rabbitTemplate.convertAndSend("risk.score.result", result);
    }
    
    private int calculateAmountScore(BigDecimal amount) {
        // é‡‘é¢è¶Šå¤§ï¼Œé£é™©åˆ†è¶Šé«˜
        if (amount.compareTo(new BigDecimal("100000")) > 0) return 20;
        if (amount.compareTo(new BigDecimal("50000")) > 0) return 15;
        if (amount.compareTo(new BigDecimal("10000")) > 0) return 10;
        return 5;
    }
    
    private void applyRiskRules(RiskScoreCard scoreCard, TransactionMessage transaction) {
        // é»‘åå•æ£€æŸ¥
        if (isInBlacklist(transaction.getUserId())) {
            scoreCard.addAdjustment("BLACKLIST", 50);
        }
        
        // æ–°ç”¨æˆ·æ£€æŸ¥
        if (isNewUser(transaction.getUserId())) {
            scoreCard.addAdjustment("NEW_USER", 10);
        }
        
        // VIPç”¨æˆ·ä¼˜æƒ 
        if (isVipUser(transaction.getUserId())) {
            scoreCard.addAdjustment("VIP_USER", -10);
        }
    }
}
```

### 7.4 è¯„åˆ†ç»“æœå¤„ç†


**åŸºäºè¯„åˆ†çš„å†³ç­–é€»è¾‘**ï¼š

```java
@Component
public class RiskDecisionEngine {
    
    @RabbitListener(queues = "risk.decision.queue")
    public void makeRiskDecision(RiskScoreResult scoreResult) {
        
        int score = scoreResult.getFinalScore();
        String transactionId = scoreResult.getTransactionId();
        
        RiskDecision decision;
        
        if (score >= 80) {
            // é«˜é£é™© - ç›´æ¥æ‹’ç»
            decision = new RiskDecision("REJECT", "é£é™©è¯„åˆ†è¿‡é«˜: " + score);
            
        } else if (score >= 60) {
            // ä¸­é£é™© - äººå·¥å®¡æ ¸
            decision = new RiskDecision("REVIEW", "é£é™©è¯„åˆ†ä¸­ç­‰: " + score);
            
        } else if (score >= 40) {
            // ä½é£é™© - é¢å¤–éªŒè¯
            decision = new RiskDecision("VERIFY", "éœ€è¦é¢å¤–éªŒè¯: " + score);
            
        } else {
            // å¾ˆä½é£é™© - ç›´æ¥é€šè¿‡
            decision = new RiskDecision("PASS", "é£é™©è¯„åˆ†è¾ƒä½: " + score);
        }
        
        // å‘é€å†³ç­–ç»“æœ
        decision.setTransactionId(transactionId);
        decision.setScore(score);
        decision.setTimestamp(System.currentTimeMillis());
        
        rabbitTemplate.convertAndSend("risk.decision.result", decision);
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ é£æ§ç³»ç»Ÿæœ¬è´¨ï¼šå®æ—¶ç›‘æ§å’Œé£é™©é˜²èŒƒçš„æ™ºèƒ½ä¿å®‰ç³»ç»Ÿ
ğŸ”¸ RabbitMQä»·å€¼ï¼šæä¾›å¼‚æ­¥ã€è§£è€¦ã€é«˜å¯ç”¨çš„æ¶ˆæ¯å¤„ç†èƒ½åŠ›
ğŸ”¸ å®æ—¶æ€§è¦æ±‚ï¼šé£æ§æ£€æµ‹å¿…é¡»åœ¨æ¯«ç§’çº§åˆ«å®Œæˆå“åº”
ğŸ”¸ å¤šå±‚é˜²æŠ¤ï¼šé»‘åå•â†’è§„åˆ™æ£€æŸ¥â†’å¼‚å¸¸æ£€æµ‹â†’é£é™©è¯„åˆ†â†’äººå·¥å®¡æ ¸
ğŸ”¸ æ•°æ®ä¸€è‡´æ€§ï¼šé»‘åå•ç­‰å…³é”®æ•°æ®å¿…é¡»å®æ—¶åŒæ­¥
```

### 8.2 å…³é”®æ¶æ„è®¾è®¡åŸåˆ™


**ğŸ”¹ å¼‚æ­¥è§£è€¦è®¾è®¡**
```
æ ¸å¿ƒæ€æƒ³ï¼šé£æ§æ£€æµ‹ä¸èƒ½é˜»å¡ä¸šåŠ¡æµç¨‹
å®ç°æ–¹å¼ï¼šæ¶ˆæ¯é˜Ÿåˆ— + å¹¶è¡Œå¤„ç†
æ”¶ç›Šæ•ˆæœï¼šç”¨æˆ·ä½“éªŒæå‡ï¼Œç³»ç»Ÿç¨³å®šæ€§å¢å¼º
```

**ğŸ”¹ åˆ†å±‚é˜²æŠ¤ç­–ç•¥**
```
ç¬¬ä¸€å±‚ï¼šå¿«é€Ÿè§„åˆ™ï¼ˆé»‘åå•ã€é™é¢ï¼‰
ç¬¬äºŒå±‚ï¼šè¡Œä¸ºåˆ†æï¼ˆå¼‚å¸¸æ£€æµ‹ï¼‰
ç¬¬ä¸‰å±‚ï¼šç»¼åˆè¯„åˆ†ï¼ˆé£é™©é‡åŒ–ï¼‰
ç¬¬å››å±‚ï¼šäººå·¥å®¡æ ¸ï¼ˆå¤æ‚å†³ç­–ï¼‰
```

**ğŸ”¹ å®æ—¶æ•°æ®åŒæ­¥**
```
æŒ‘æˆ˜ï¼šå¤šä¸ªæœåŠ¡èŠ‚ç‚¹çš„æ•°æ®ä¸€è‡´æ€§
è§£å†³ï¼šåŸºäºæ¶ˆæ¯çš„å‘å¸ƒ-è®¢é˜…æ¨¡å¼
å…³é”®ï¼šå¤šçº§ç¼“å­˜ + å¤±æ•ˆé€šçŸ¥æœºåˆ¶
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


**âœ… é€‚ç”¨åœºæ™¯**ï¼š
- é‡‘èäº¤æ˜“é£æ§
- ç”µå•†åæ¬ºè¯ˆ  
- ç¤¾äº¤å¹³å°å†…å®¹å®¡æ ¸
- æ¸¸æˆåä½œå¼Šç³»ç»Ÿ

**âš ï¸ æ³¨æ„äº‹é¡¹**ï¼š
- æ¶ˆæ¯é¡ºåºæ€§è¦æ±‚é«˜çš„åœºæ™¯éœ€è¦ç‰¹æ®Šå¤„ç†
- éœ€è¦è€ƒè™‘æ¶ˆæ¯ä¸¢å¤±å’Œé‡å¤çš„å¤„ç†æœºåˆ¶
- é£æ§è§„åˆ™è¦æ”¯æŒçƒ­æ›´æ–°ï¼Œé¿å…é‡å¯æœåŠ¡

**ğŸ’¡ æœ€ä½³å®è·µ**ï¼š
- ä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—å¤„ç†ç´§æ€¥é£æ§äº‹ä»¶
- å»ºç«‹å®Œå–„çš„ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶
- å®šæœŸè¯„ä¼°å’Œè°ƒæ•´é£æ§è§„åˆ™çš„å‡†ç¡®æ€§

### 8.4 å­¦ä¹ æ£€éªŒæ¸…å•


**âœ… è‡ªæ£€æ¸…å•**ï¼š
- [ ] ç†è§£é£æ§ç³»ç»Ÿçš„åŸºæœ¬å·¥ä½œåŸç†
- [ ] æŒæ¡RabbitMQåœ¨é£æ§ä¸­çš„åº”ç”¨æ¨¡å¼
- [ ] èƒ½è®¾è®¡å®æ—¶é£æ§è§„åˆ™çš„æ¶ˆæ¯å¤„ç†æµç¨‹
- [ ] äº†è§£é»‘åå•åŒæ­¥çš„æŠ€æœ¯æŒ‘æˆ˜å’Œè§£å†³æ–¹æ¡ˆ
- [ ] èƒ½å®ç°åŸºäºæ¶ˆæ¯é˜Ÿåˆ—çš„äººå·¥å®¡æ ¸æµç¨‹
- [ ] æŒæ¡é£é™©è¯„åˆ†ç³»ç»Ÿçš„åˆ†å±‚æ¶æ„è®¾è®¡

> ğŸ¯ **æ ¸å¿ƒè®°å¿†**  
> RabbitMQè®©é£æ§ç³»ç»Ÿå˜å¾—"åˆå¿«åˆç¨³"ï¼šå¿«é€Ÿå“åº”ç”¨æˆ·è¯·æ±‚ï¼Œç¨³å®šå¤„ç†å„ç§é£é™©åœºæ™¯ã€‚é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—å®ç°å¼‚æ­¥è§£è€¦ï¼Œè®©å¤æ‚çš„é£æ§é€»è¾‘å˜å¾—ç®€å•å¯é ã€‚

**ğŸ“š æ‰©å±•å­¦ä¹ **ï¼š
- æœºå™¨å­¦ä¹ åœ¨é£æ§ä¸­çš„åº”ç”¨
- å¤§æ•°æ®å®æ—¶è®¡ç®—æ¡†æ¶ï¼ˆå¦‚Flinkï¼‰ç»“åˆRabbitMQ
- å¾®æœåŠ¡æ¶æ„ä¸‹çš„åˆ†å¸ƒå¼é£æ§ç³»ç»Ÿè®¾è®¡