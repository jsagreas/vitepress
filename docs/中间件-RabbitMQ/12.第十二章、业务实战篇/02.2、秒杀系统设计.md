---
title: 2ã€ç§’æ€ç³»ç»Ÿè®¾è®¡
---
## ğŸ“š ç›®å½•

1. [ç§’æ€ç³»ç»Ÿæ ¸å¿ƒé—®é¢˜](#1-ç§’æ€ç³»ç»Ÿæ ¸å¿ƒé—®é¢˜)
2. [æµé‡å‰Šå³°è®¾è®¡](#2-æµé‡å‰Šå³°è®¾è®¡)
3. [åº“å­˜é¢„æ‰£æœºåˆ¶](#3-åº“å­˜é¢„æ‰£æœºåˆ¶)
4. [å¼‚æ­¥ä¸‹å•å¤„ç†](#4-å¼‚æ­¥ä¸‹å•å¤„ç†)
5. [è¶…å–é˜²æŠ¤ç­–ç•¥](#5-è¶…å–é˜²æŠ¤ç­–ç•¥)
6. [æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ](#6-æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ)
7. [å®Œæ•´æ¶æ„å®ç°](#7-å®Œæ•´æ¶æ„å®ç°)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ ç§’æ€ç³»ç»Ÿæ ¸å¿ƒé—®é¢˜


### 1.1 ä»€ä¹ˆæ˜¯ç§’æ€ç³»ç»Ÿ

**ç®€å•ç†è§£**ï¼šç§’æ€å°±æ˜¯åœ¨çŸ­æ—¶é—´å†…ï¼Œå¤§é‡ç”¨æˆ·åŒæ—¶æŠ¢è´­é™é‡å•†å“çš„åœºæ™¯

```
æ™®é€šè´­ç‰© vs ç§’æ€åœºæ™¯ï¼š

æ™®é€šè´­ç‰©ï¼š
ç”¨æˆ·æ•°é‡ï¼šåˆ†æ•£ï¼Œéšæœºè®¿é—®
å•†å“åº“å­˜ï¼šå……è¶³ï¼Œä¸ç”¨æ‹…å¿ƒæŠ¢å…‰
ç³»ç»Ÿå‹åŠ›ï¼šæ­£å¸¸è´Ÿè½½ï¼Œå¹³ç¨³å¤„ç†

ç§’æ€åœºæ™¯ï¼š
ç”¨æˆ·æ•°é‡ï¼šé›†ä¸­ï¼Œç¬é—´çˆ†å‘ï¼ˆå¦‚10ä¸‡äººåŒæ—¶ç‚¹å‡»ï¼‰
å•†å“åº“å­˜ï¼šç¨€ç¼ºï¼Œå¯èƒ½åªæœ‰100ä»¶å•†å“
ç³»ç»Ÿå‹åŠ›ï¼šæé«˜è´Ÿè½½ï¼Œå®¹æ˜“å®•æœº
```

### 1.2 ç§’æ€ç³»ç»Ÿçš„æŠ€æœ¯æŒ‘æˆ˜


**ğŸ”¸ ç¬æ—¶é«˜å¹¶å‘**
```
æŒ‘æˆ˜æè¿°ï¼š
- å¹³æ—¶ç½‘ç«™1000äººåœ¨çº¿ï¼Œç§’æ€æ—¶ç¬é—´10ä¸‡äººæ¶Œå…¥
- å°±åƒå¹³æ—¶2è½¦é“çš„é©¬è·¯ï¼Œçªç„¶æœ‰100è¾†è½¦åŒæ—¶é€šè¿‡

æŠ€æœ¯é—®é¢˜ï¼š
- æœåŠ¡å™¨æ‰¿å—ä¸äº†å·¨å¤§è®¿é—®é‡
- æ•°æ®åº“è¿æ¥æ•°çˆ†æ»¡
- ç½‘ç»œå¸¦å®½ä¸å¤Ÿç”¨
```

**ğŸ”¸ æ•°æ®ä¸€è‡´æ€§**
```
é—®é¢˜åœºæ™¯ï¼š
å•†å“åº“å­˜åªæœ‰100ä»¶ï¼Œä½†æœ‰10000äººåŒæ—¶ä¸‹å•æˆåŠŸ
å°±åƒ100å¼ ç”µå½±ç¥¨ï¼Œå´å–å‡ºäº†10000å¼ 

äº§ç”ŸåŸå› ï¼š
- å¤šä¸ªç”¨æˆ·åŒæ—¶è¯»å–åº“å­˜æ•°é‡
- ç³»ç»Ÿæ¥ä¸åŠæ›´æ–°åº“å­˜çŠ¶æ€
- ç¼ºä¹æœ‰æ•ˆçš„å¹¶å‘æ§åˆ¶
```

**ğŸ”¸ ç³»ç»Ÿç¨³å®šæ€§**
```
å¸¸è§é—®é¢˜ï¼š
- æœåŠ¡å™¨å®•æœºï¼šæ‰¿å—ä¸äº†é«˜å¹¶å‘è®¿é—®
- æ•°æ®åº“å´©æºƒï¼šå¤§é‡æŸ¥è¯¢å’Œæ›´æ–°æ“ä½œ
- ç”¨æˆ·ä½“éªŒå·®ï¼šé¡µé¢åŠ è½½æ…¢æˆ–æ— æ³•è®¿é—®
```

### 1.3 RabbitMQåœ¨ç§’æ€ä¸­çš„ä½œç”¨


**ğŸ’¡ æ ¸å¿ƒä»·å€¼ï¼šå‰Šå³°å¡«è°·**
```
ä¼ ç»ŸåŒæ­¥å¤„ç†ï¼š
ç”¨æˆ·ç‚¹å‡» â†’ ç«‹å³æ‰£åº“å­˜ â†’ ç«‹å³åˆ›å»ºè®¢å• â†’ è¿”å›ç»“æœ
é—®é¢˜ï¼šæ‰€æœ‰æ“ä½œéƒ½åœ¨ç¬é—´å®Œæˆï¼Œå‹åŠ›å·¨å¤§

RabbitMQå¼‚æ­¥å¤„ç†ï¼š
ç”¨æˆ·ç‚¹å‡» â†’ å¿«é€Ÿå“åº”"æ’é˜Ÿä¸­" â†’ æ¶ˆæ¯é˜Ÿåˆ—ç¼“å­˜è¯·æ±‚ â†’ åå°æ…¢æ…¢å¤„ç†
ä¼˜åŠ¿ï¼šæŠŠç¬é—´çš„å·¨å¤§å‹åŠ›åˆ†æ•£åˆ°æ—¶é—´è½´ä¸Š
```

**ğŸ“Š å‰Šå³°æ•ˆæœå¯¹æ¯”**
```
ä¼ ç»Ÿæ–¹å¼å‹åŠ›å›¾ï¼š
å‹åŠ› â–²
    â”‚     â•­â”€â•®
    â”‚     â”‚ â”‚  â† ç¬é—´å‹åŠ›å³°å€¼ï¼Œå®¹æ˜“å®•æœº
    â”‚     â”‚ â”‚
    â””â”€â”€â”€â”€â”€â”´â”€â”´â”€â”€â”€â”€â”€â”€â†’ æ—¶é—´

RabbitMQå‰Šå³°åï¼š
å‹åŠ› â–²
    â”‚   â•­â”€â”€â”€â”€â”€â•®
    â”‚  â•±       â•²  â† å‹åŠ›å¹³ç¼“é‡Šæ”¾ï¼Œç³»ç»Ÿç¨³å®š
    â”‚ â•±         â•²
    â””â•±â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•²â”€â”€â†’ æ—¶é—´
```

---

## 2. ğŸŒŠ æµé‡å‰Šå³°è®¾è®¡


### 2.1 å‰Šå³°çš„åŸºæœ¬æ€è·¯


**ğŸ”¸ ä»€ä¹ˆæ˜¯æµé‡å‰Šå³°**
æŠŠç¬é—´çš„å·¨å¤§æµé‡"å‰Š"æ‰å³°å€¼ï¼Œ"å¡«"å¹³åˆ°ä¸€ä¸ªç³»ç»Ÿèƒ½æ‰¿å—çš„æ°´å¹³

```
ç”Ÿæ´»æ¯”å–»ï¼š
å°±åƒåŒ»é™¢æŒ‚å·ï¼Œä¸è®©æ‰€æœ‰ç—…äººåŒæ—¶æ¶Œåˆ°åŒ»ç”Ÿé¢å‰
è€Œæ˜¯é€šè¿‡æ’é˜Ÿå«å·ï¼Œè®©åŒ»ç”ŸæŒ‰è‡ªå·±çš„èŠ‚å¥çœ‹ç—…

æŠ€æœ¯å®ç°ï¼š
ä¸è®©æ‰€æœ‰ç”¨æˆ·è¯·æ±‚ç›´æ¥æ‰“åˆ°æ•°æ®åº“
è€Œæ˜¯é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—æ’é˜Ÿï¼Œè®©æ•°æ®åº“æŒ‰å¤„ç†èƒ½åŠ›æ¶ˆè´¹
```

### 2.2 RabbitMQå‰Šå³°æ¶æ„è®¾è®¡


```
ç§’æ€æµé‡å‰Šå³°æ¶æ„ï¼š

ç”¨æˆ·è¯·æ±‚ â†’ æ¥å…¥å±‚ â†’ é˜Ÿåˆ—ç¼“å†² â†’ ä¸šåŠ¡å¤„ç† â†’ æ•°æ®å­˜å‚¨
   â†“         â†“         â†“         â†“         â†“
 10ä¸‡QPS   éªŒè¯é™æµ   æ¶ˆæ¯é˜Ÿåˆ—   å¼‚æ­¥å¤„ç†   ç¨³å®šå†™å…¥
                    (å‰Šå³°ç‚¹)   1000QPS
```

**ğŸ”§ æ ¸å¿ƒç»„ä»¶è®¾è®¡**
```java
// 1. ç§’æ€è¯·æ±‚æ¥æ”¶æ¥å£
@RestController
public class SeckillController {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    // ç”¨æˆ·ç‚¹å‡»ç§’æ€æŒ‰é’®
    @PostMapping("/seckill")
    public ApiResponse seckill(@RequestBody SeckillRequest request) {
        
        // åŸºç¡€éªŒè¯ï¼ˆå¿«é€Ÿå¤±è´¥ï¼‰
        if (!validateRequest(request)) {
            return ApiResponse.fail("è¯·æ±‚å‚æ•°é”™è¯¯");
        }
        
        // å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆå¼‚æ­¥å¤„ç†ï¼‰
        SeckillMessage message = new SeckillMessage();
        message.setUserId(request.getUserId());
        message.setProductId(request.getProductId());
        message.setRequestTime(System.currentTimeMillis());
        
        rabbitTemplate.convertAndSend("seckill.queue", message);
        
        // å¿«é€Ÿè¿”å›ï¼ˆä¸ç­‰å¾…å¤„ç†ç»“æœï¼‰
        return ApiResponse.success("å·²åŠ å…¥æ’é˜Ÿï¼Œè¯·ç¨å€™æŸ¥çœ‹ç»“æœ");
    }
}
```

### 2.3 å¤šçº§å‰Šå³°ç­–ç•¥


**ğŸ”¸ ç¬¬ä¸€çº§ï¼šæ¥å…¥å±‚é™æµ**
```java
// ä½¿ç”¨ä»¤ç‰Œæ¡¶é™æµ
@Component
public class RateLimiter {
    
    // æ¯ç§’å…è®¸1000ä¸ªè¯·æ±‚é€šè¿‡
    private final Bucket bucket = Bucket4j.builder()
            .addLimit(Bandwidth.classic(1000, Refill.intervally(1000, Duration.ofSeconds(1))))
            .build();
    
    public boolean tryAcquire() {
        return bucket.tryConsume(1);
    }
}

@RestController
public class SeckillController {
    
    @Autowired
    private RateLimiter rateLimiter;
    
    @PostMapping("/seckill")
    public ApiResponse seckill(@RequestBody SeckillRequest request) {
        
        // ç¬¬ä¸€çº§å‰Šå³°ï¼šé™æµ
        if (!rateLimiter.tryAcquire()) {
            return ApiResponse.fail("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
        }
        
        // ç»§ç»­åç»­å¤„ç†...
    }
}
```

**ğŸ”¸ ç¬¬äºŒçº§ï¼šæ¶ˆæ¯é˜Ÿåˆ—ç¼“å†²**
```yaml
# RabbitMQé˜Ÿåˆ—é…ç½®
rabbitmq:
  queue:
    seckill:
      name: "seckill.queue"
      durable: true  # é˜Ÿåˆ—æŒä¹…åŒ–
      max-length: 100000  # æœ€å¤§é˜Ÿåˆ—é•¿åº¦
      ttl: 300000  # æ¶ˆæ¯5åˆ†é’Ÿè¿‡æœŸ
```

**ğŸ”¸ ç¬¬ä¸‰çº§ï¼šæ¶ˆè´¹è€…é™é€Ÿ**
```java
@RabbitListener(queues = "seckill.queue")
public class SeckillConsumer {
    
    // é™åˆ¶å¹¶å‘æ¶ˆè´¹è€…æ•°é‡
    @RabbitListener(
        queues = "seckill.queue",
        concurrency = "1-10"  // æœ€å°‘1ä¸ªï¼Œæœ€å¤š10ä¸ªæ¶ˆè´¹è€…
    )
    public void processSeckill(SeckillMessage message) {
        
        // æ§åˆ¶å¤„ç†é€Ÿåº¦ï¼Œé¿å…å‹å®æ•°æ®åº“
        try {
            Thread.sleep(10); // æ¯ä¸ªè¯·æ±‚å¤„ç†10ms
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
        
        // å®é™…ä¸šåŠ¡å¤„ç†
        seckillService.processSeckillOrder(message);
    }
}
```

---

## 3. ğŸ“¦ åº“å­˜é¢„æ‰£æœºåˆ¶


### 3.1 ä»€ä¹ˆæ˜¯åº“å­˜é¢„æ‰£


**ğŸ”¸ ä¼ ç»Ÿåº“å­˜æ‰£å‡é—®é¢˜**
```
é—®é¢˜åœºæ™¯ï¼š
1. ç”¨æˆ·AæŸ¥è¯¢åº“å­˜ï¼šè¿˜æœ‰1ä»¶
2. ç”¨æˆ·BæŸ¥è¯¢åº“å­˜ï¼šè¿˜æœ‰1ä»¶  
3. ç”¨æˆ·Aä¸‹å•æˆåŠŸï¼šåº“å­˜å˜0
4. ç”¨æˆ·Bä¸‹å•æˆåŠŸï¼šåº“å­˜å˜-1 âŒè¶…å–äº†ï¼

æ ¹æœ¬åŸå› ï¼šæŸ¥è¯¢å’Œæ‰£å‡ä¸æ˜¯åŸå­æ“ä½œ
```

**ğŸ”¸ é¢„æ‰£æœºåˆ¶è§£å†³æ–¹æ¡ˆ**
```
é¢„æ‰£æµç¨‹ï¼š
1. ç”¨æˆ·è¯·æ±‚è¿›å…¥é˜Ÿåˆ—æ—¶ï¼Œç«‹å³é¢„æ‰£åº“å­˜
2. å¦‚æœé¢„æ‰£æˆåŠŸï¼Œæ‰å…è®¸è¿›å…¥åç»­å¤„ç†
3. æœ€ç»ˆå¤„ç†æ—¶ï¼Œå°†é¢„æ‰£è½¬ä¸ºå®é™…æ‰£å‡

ä¼˜åŠ¿ï¼šæŠŠåº“å­˜ç«äº‰å‰ç§»ï¼Œé¿å…æ·±åº¦å¤„ç†åå‘ç°åº“å­˜ä¸è¶³
```

### 3.2 Redisé¢„æ‰£åº“å­˜å®ç°


**ğŸ”§ åŸºäºRedisçš„åŸå­æ“ä½œ**
```java
@Service
public class StockService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    /**
     * é¢„æ‰£åº“å­˜ - åŸå­æ“ä½œ
     */
    public boolean preDeductStock(Long productId, Integer quantity) {
        String stockKey = "stock:" + productId;
        
        // ä½¿ç”¨Luaè„šæœ¬ä¿è¯åŸå­æ€§
        String luaScript = 
            "local stock = redis.call('get', KEYS[1]) " +
            "if stock and tonumber(stock) >= tonumber(ARGV[1]) then " +
            "    redis.call('decrby', KEYS[1], ARGV[1]) " +
            "    return 1 " +
            "else " +
            "    return 0 " +
            "end";
        
        Long result = redisTemplate.execute(
            new DefaultRedisScript<>(luaScript, Long.class),
            Collections.singletonList(stockKey),
            quantity
        );
        
        return result != null && result == 1;
    }
    
    /**
     * æ¢å¤åº“å­˜ï¼ˆè®¢å•å–æ¶ˆæ—¶ï¼‰
     */
    public void restoreStock(Long productId, Integer quantity) {
        String stockKey = "stock:" + productId;
        redisTemplate.opsForValue().increment(stockKey, quantity);
    }
}
```

### 3.3 é¢„æ‰£æœºåˆ¶é›†æˆåˆ°ç§’æ€æµç¨‹


```java
@Component
public class SeckillConsumer {
    
    @Autowired
    private StockService stockService;
    
    @RabbitListener(queues = "seckill.queue")
    public void processSeckill(SeckillMessage message) {
        
        try {
            // 1. é¢„æ‰£åº“å­˜æ£€æŸ¥
            boolean stockDeducted = stockService.preDeductStock(
                message.getProductId(), 1
            );
            
            if (!stockDeducted) {
                // åº“å­˜ä¸è¶³ï¼Œç›´æ¥è¿”å›å¤±è´¥
                notifyUser(message.getUserId(), "å•†å“å·²å”®ç½„");
                return;
            }
            
            // 2. åˆ›å»ºè®¢å•ï¼ˆå¯èƒ½å¤±è´¥ï¼‰
            boolean orderCreated = createOrder(message);
            
            if (!orderCreated) {
                // è®¢å•åˆ›å»ºå¤±è´¥ï¼Œæ¢å¤åº“å­˜
                stockService.restoreStock(message.getProductId(), 1);
                notifyUser(message.getUserId(), "è®¢å•åˆ›å»ºå¤±è´¥");
                return;
            }
            
            // 3. æ‰£å‡æ•°æ®åº“åº“å­˜ï¼ˆæœ€ç»ˆç¡®è®¤ï¼‰
            confirmStockDeduction(message.getProductId(), 1);
            
            // 4. é€šçŸ¥ç”¨æˆ·æˆåŠŸ
            notifyUser(message.getUserId(), "æŠ¢è´­æˆåŠŸï¼");
            
        } catch (Exception e) {
            // å¼‚å¸¸æ—¶æ¢å¤åº“å­˜
            stockService.restoreStock(message.getProductId(), 1);
            log.error("ç§’æ€å¤„ç†å¼‚å¸¸", e);
        }
    }
}
```

---

## 4. âš¡ å¼‚æ­¥ä¸‹å•å¤„ç†


### 4.1 ä¸ºä»€ä¹ˆéœ€è¦å¼‚æ­¥ä¸‹å•


**ğŸ”¸ åŒæ­¥ä¸‹å•çš„é—®é¢˜**
```
åŒæ­¥æµç¨‹ï¼š
ç”¨æˆ·ç‚¹å‡» â†’ éªŒè¯ç”¨æˆ· â†’ æ£€æŸ¥åº“å­˜ â†’ åˆ›å»ºè®¢å• â†’ æ‰£åº“å­˜ â†’ è¿”å›ç»“æœ
è€—æ—¶ï¼š     50ms    +   100ms   +   200ms  +  150ms  +  100ms = 600ms

é—®é¢˜åˆ†æï¼š
- ç”¨æˆ·ç­‰å¾…æ—¶é—´é•¿ï¼Œä½“éªŒå·®
- æ•°æ®åº“å‹åŠ›å¤§ï¼Œå®¹æ˜“å‡ºç°é”ç­‰å¾…
- ä»»ä½•ä¸€æ­¥å¤±è´¥ï¼Œæ•´ä¸ªæµç¨‹é‡æ¥
```

**ğŸ”¸ å¼‚æ­¥ä¸‹å•çš„ä¼˜åŠ¿**
```
å¼‚æ­¥æµç¨‹ï¼š
ç”¨æˆ·ç‚¹å‡» â†’ å¿«é€Ÿå“åº”"å¤„ç†ä¸­" â†’ åå°å¼‚æ­¥å¤„ç† â†’ é€šçŸ¥ç»“æœ
è€—æ—¶ï¼š     50ms     ç«‹å³è¿”å›        æ— æ„ŸçŸ¥å¤„ç†     æ¨é€é€šçŸ¥

ä¼˜åŠ¿åˆ†æï¼š
- ç”¨æˆ·å“åº”å¿«ï¼Œä½“éªŒå¥½
- ç³»ç»Ÿå‹åŠ›åˆ†æ•£ï¼Œç¨³å®šæ€§é«˜
- å¯ä»¥æ‰¹é‡å¤„ç†ï¼Œæé«˜æ•ˆç‡
```

### 4.2 å¼‚æ­¥ä¸‹å•é˜Ÿåˆ—è®¾è®¡


**ğŸ“‹ é˜Ÿåˆ—ç»“æ„è®¾è®¡**
```
ç§’æ€å¼‚æ­¥å¤„ç†é˜Ÿåˆ—æ¶æ„ï¼š

å¿«é€Ÿå“åº”é˜Ÿåˆ— â†’ è®¢å•å¤„ç†é˜Ÿåˆ— â†’ åº“å­˜æ›´æ–°é˜Ÿåˆ— â†’ é€šçŸ¥é˜Ÿåˆ—
     â†“              â†“              â†“           â†“
  ç”¨æˆ·è¯·æ±‚éªŒè¯    åˆ›å»ºè®¢å•æ•°æ®    æ›´æ–°åº“å­˜çŠ¶æ€   å‘é€ç»“æœé€šçŸ¥
   (æ¯«ç§’çº§)       (ç§’çº§)         (ç§’çº§)       (ç§’çº§)
```

**ğŸ”§ å¤šé˜Ÿåˆ—é…ç½®**
```java
@Configuration
public class SeckillQueueConfig {
    
    // ä¸»é˜Ÿåˆ—ï¼šæ¥æ”¶ç§’æ€è¯·æ±‚
    @Bean
    public Queue seckillQueue() {
        return QueueBuilder.durable("seckill.main.queue")
                .withArgument("x-max-length", 100000)
                .withArgument("x-message-ttl", 300000)
                .build();
    }
    
    // è®¢å•å¤„ç†é˜Ÿåˆ—
    @Bean
    public Queue orderQueue() {
        return QueueBuilder.durable("seckill.order.queue")
                .withArgument("x-max-length", 50000)
                .build();
    }
    
    // é€šçŸ¥é˜Ÿåˆ—
    @Bean
    public Queue notifyQueue() {
        return QueueBuilder.durable("seckill.notify.queue")
                .build();
    }
    
    // æ­»ä¿¡é˜Ÿåˆ—ï¼ˆå¤„ç†å¤±è´¥çš„æ¶ˆæ¯ï¼‰
    @Bean
    public Queue deadLetterQueue() {
        return QueueBuilder.durable("seckill.dead.queue").build();
    }
}
```

### 4.3 åˆ†é˜¶æ®µå¼‚æ­¥å¤„ç†


**ğŸ”¸ ç¬¬ä¸€é˜¶æ®µï¼šå¿«é€Ÿé¢„å¤„ç†**
```java
@RabbitListener(queues = "seckill.main.queue")
public class SeckillPreProcessor {
    
    public void preProcess(SeckillMessage message) {
        
        // å¿«é€ŸéªŒè¯ï¼ˆä¸æŸ¥æ•°æ®åº“ï¼‰
        if (!quickValidate(message)) {
            return;
        }
        
        // é¢„æ‰£Redisåº“å­˜
        if (!stockService.preDeductStock(message.getProductId(), 1)) {
            notifyUser(message.getUserId(), "å•†å“å·²å”®ç½„");
            return;
        }
        
        // è½¬å…¥è®¢å•å¤„ç†é˜Ÿåˆ—
        rabbitTemplate.convertAndSend("seckill.order.queue", message);
    }
}
```

**ğŸ”¸ ç¬¬äºŒé˜¶æ®µï¼šè®¢å•åˆ›å»º**
```java
@RabbitListener(queues = "seckill.order.queue")
public class OrderProcessor {
    
    public void createOrder(SeckillMessage message) {
        
        try {
            // åˆ›å»ºè®¢å•è®°å½•
            Order order = new Order();
            order.setUserId(message.getUserId());
            order.setProductId(message.getProductId());
            order.setStatus(OrderStatus.PENDING);
            order.setCreateTime(new Date());
            
            orderService.save(order);
            
            // å‘é€åˆ°åº“å­˜æ›´æ–°é˜Ÿåˆ—
            StockUpdateMessage stockMsg = new StockUpdateMessage();
            stockMsg.setOrderId(order.getId());
            stockMsg.setProductId(message.getProductId());
            stockMsg.setQuantity(1);
            
            rabbitTemplate.convertAndSend("seckill.stock.queue", stockMsg);
            
        } catch (Exception e) {
            // è®¢å•åˆ›å»ºå¤±è´¥ï¼Œæ¢å¤åº“å­˜
            stockService.restoreStock(message.getProductId(), 1);
            notifyUser(message.getUserId(), "ç³»ç»Ÿç¹å¿™ï¼Œè¯·é‡è¯•");
        }
    }
}
```

**ğŸ”¸ ç¬¬ä¸‰é˜¶æ®µï¼šæœ€ç»ˆç¡®è®¤**
```java
@RabbitListener(queues = "seckill.stock.queue")
public class StockUpdateProcessor {
    
    public void updateStock(StockUpdateMessage message) {
        
        try {
            // æ›´æ–°æ•°æ®åº“åº“å­˜
            productService.deductStock(message.getProductId(), message.getQuantity());
            
            // æ›´æ–°è®¢å•çŠ¶æ€
            orderService.confirmOrder(message.getOrderId());
            
            // å‘é€æˆåŠŸé€šçŸ¥
            NotifyMessage notifyMsg = new NotifyMessage();
            notifyMsg.setUserId(orderService.getUserId(message.getOrderId()));
            notifyMsg.setMessage("æ­å–œæ‚¨ï¼ç§’æ€æˆåŠŸï¼Œè®¢å•å·ï¼š" + message.getOrderId());
            
            rabbitTemplate.convertAndSend("seckill.notify.queue", notifyMsg);
            
        } catch (Exception e) {
            // å¤„ç†å¤±è´¥ï¼Œå›æ»š
            handleFailure(message);
        }
    }
}
```

---

## 5. ğŸ›¡ï¸ è¶…å–é˜²æŠ¤ç­–ç•¥


### 5.1 è¶…å–é—®é¢˜åˆ†æ


**ğŸ”¸ ä»€ä¹ˆæ˜¯è¶…å–**
```
è¶…å–åœºæ™¯ï¼š
å•†å“åº“å­˜ï¼š100ä»¶
å‚ä¸ç§’æ€ï¼š10000äºº
ç»“æœï¼šå–å‡ºäº†120ä»¶ âŒ

è¶…å–å±å®³ï¼š
- ç”¨æˆ·ä½“éªŒå·®ï¼šä»˜æ¬¾åè¢«å‘ŠçŸ¥æ²¡è´§
- å•†ä¸šæŸå¤±ï¼šéœ€è¦èµ”å¿æˆ–é€€æ¬¾
- ç³»ç»Ÿå¯ä¿¡åº¦ä¸‹é™
```

**ğŸ”¸ è¶…å–äº§ç”Ÿçš„æ ¹æœ¬åŸå› **
```
å¹¶å‘ç«äº‰æ¡ä»¶ï¼š
æ—¶é—´ç‚¹  çº¿ç¨‹A          çº¿ç¨‹B          åº“å­˜çŠ¶æ€
T1     è¯»å–åº“å­˜=1      è¯»å–åº“å­˜=1      1
T2     æ£€æŸ¥é€šè¿‡        æ£€æŸ¥é€šè¿‡        1  
T3     æ‰£å‡åº“å­˜        æ‰£å‡åº“å­˜        -1 âŒè¶…å–

é—®é¢˜æ ¹æºï¼šè¯»å–å’Œæ‰£å‡ä¸æ˜¯åŸå­æ“ä½œ
```

### 5.2 å¤šå±‚é˜²æŠ¤æœºåˆ¶


**ğŸ”¸ ç¬¬ä¸€å±‚ï¼šRedisåŸå­æ“ä½œ**
```java
@Service
public class AtomicStockService {
    
    /**
     * åŸå­æ‰£å‡åº“å­˜
     */
    public boolean atomicDeductStock(Long productId, Integer quantity) {
        
        String luaScript = 
            "local key = KEYS[1] " +
            "local deduct = tonumber(ARGV[1]) " +
            "local current = tonumber(redis.call('get', key)) " +
            "if current and current >= deduct then " +
            "    redis.call('decrby', key, deduct) " +
            "    return current - deduct " +  // è¿”å›å‰©ä½™åº“å­˜
            "else " +
            "    return -1 " +  // åº“å­˜ä¸è¶³
            "end";
        
        String stockKey = "product:stock:" + productId;
        Long remaining = redisTemplate.execute(
            new DefaultRedisScript<>(luaScript, Long.class),
            Collections.singletonList(stockKey),
            quantity
        );
        
        return remaining != null && remaining >= 0;
    }
}
```

**ğŸ”¸ ç¬¬äºŒå±‚ï¼šæ•°æ®åº“ä¹è§‚é”**
```java
@Entity
public class Product {
    
    @Id
    private Long id;
    
    private Integer stock;
    
    @Version  // ä¹è§‚é”ç‰ˆæœ¬å·
    private Integer version;
    
    // getters and setters...
}

@Service
public class ProductService {
    
    /**
     * ä¹è§‚é”æ‰£å‡åº“å­˜
     */
    @Transactional
    public boolean deductStockWithOptimisticLock(Long productId, Integer quantity) {
        
        // æŸ¥è¯¢å½“å‰åº“å­˜å’Œç‰ˆæœ¬å·
        Product product = productRepository.findById(productId);
        
        if (product.getStock() < quantity) {
            return false;
        }
        
        // å°è¯•æ›´æ–°ï¼ˆå¸¦ç‰ˆæœ¬å·æ£€æŸ¥ï¼‰
        int updated = productRepository.updateStockWithVersion(
            productId, 
            product.getStock() - quantity,
            product.getVersion()
        );
        
        return updated > 0;  // æ›´æ–°æˆåŠŸè¡¨ç¤ºæ²¡æœ‰å¹¶å‘å†²çª
    }
}
```

**ğŸ”¸ ç¬¬ä¸‰å±‚ï¼šåˆ†å¸ƒå¼é”**
```java
@Service
public class DistributedLockStockService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    /**
     * åˆ†å¸ƒå¼é”ä¿æŠ¤åº“å­˜æ“ä½œ
     */
    public boolean deductStockWithLock(Long productId, Integer quantity) {
        
        String lockKey = "lock:product:" + productId;
        String lockValue = UUID.randomUUID().toString();
        
        try {
            // è·å–åˆ†å¸ƒå¼é”
            Boolean locked = redisTemplate.opsForValue()
                .setIfAbsent(lockKey, lockValue, Duration.ofSeconds(10));
            
            if (!locked) {
                return false; // è·å–é”å¤±è´¥
            }
            
            // åœ¨é”ä¿æŠ¤ä¸‹è¿›è¡Œåº“å­˜æ“ä½œ
            return performStockDeduction(productId, quantity);
            
        } finally {
            // é‡Šæ”¾é”
            releaseLock(lockKey, lockValue);
        }
    }
    
    private void releaseLock(String lockKey, String lockValue) {
        String luaScript = 
            "if redis.call('get', KEYS[1]) == ARGV[1] then " +
            "    return redis.call('del', KEYS[1]) " +
            "else " +
            "    return 0 " +
            "end";
        
        redisTemplate.execute(
            new DefaultRedisScript<>(luaScript, Long.class),
            Collections.singletonList(lockKey),
            lockValue
        );
    }
}
```

### 5.3 å®Œæ•´é˜²è¶…å–æµç¨‹


```java
@Service
public class SeckillService {
    
    /**
     * å®Œæ•´çš„é˜²è¶…å–ç§’æ€æµç¨‹
     */
    public SeckillResult processSeckill(Long userId, Long productId) {
        
        // ç¬¬ä¸€æ­¥ï¼šRedisé¢„æ£€æŸ¥ï¼ˆå¿«é€Ÿå¤±è´¥ï¼‰
        if (!redisStockService.checkStock(productId, 1)) {
            return SeckillResult.fail("å•†å“å·²å”®ç½„");
        }
        
        // ç¬¬äºŒæ­¥ï¼šRedisåŸå­æ‰£å‡
        if (!redisStockService.atomicDeductStock(productId, 1)) {
            return SeckillResult.fail("å•†å“å·²å”®ç½„");
        }
        
        try {
            // ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºè®¢å•
            Order order = createOrder(userId, productId);
            
            // ç¬¬å››æ­¥ï¼šæ•°æ®åº“ä¹è§‚é”ç¡®è®¤
            boolean dbSuccess = productService.deductStockWithOptimisticLock(productId, 1);
            
            if (!dbSuccess) {
                // æ•°æ®åº“æ‰£å‡å¤±è´¥ï¼Œå›æ»šRedis
                redisStockService.restoreStock(productId, 1);
                orderService.cancelOrder(order.getId());
                return SeckillResult.fail("ç³»ç»Ÿç¹å¿™ï¼Œè¯·é‡è¯•");
            }
            
            // ç¬¬äº”æ­¥ï¼šç¡®è®¤è®¢å•
            orderService.confirmOrder(order.getId());
            
            return SeckillResult.success("ç§’æ€æˆåŠŸï¼", order.getId());
            
        } catch (Exception e) {
            // å¼‚å¸¸å›æ»š
            redisStockService.restoreStock(productId, 1);
            throw e;
        }
    }
}
```

---

## 6. ğŸš€ æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ


### 6.1 Redisæ€§èƒ½ä¼˜åŒ–


**ğŸ”¸ åˆç†çš„æ•°æ®ç»“æ„é€‰æ‹©**
```java
// ä¼˜åŒ–å‰ï¼šä½¿ç”¨Stringå­˜å‚¨å¤æ‚æ•°æ®
redisTemplate.opsForValue().set("product:1", JSON.toJSONString(product));

// ä¼˜åŒ–åï¼šä½¿ç”¨Hashå­˜å‚¨ç»“æ„åŒ–æ•°æ®
Map<String, Object> productHash = new HashMap<>();
productHash.put("stock", product.getStock());
productHash.put("price", product.getPrice());
productHash.put("status", product.getStatus());
redisTemplate.opsForHash().putAll("product:1", productHash);

// åŸå­æ“ä½œä¼˜åŒ–ï¼šæ‰¹é‡æ›´æ–°
String luaScript = 
    "redis.call('hmset', KEYS[1], 'stock', ARGV[1], 'sales', ARGV[2]) " +
    "return redis.call('hgetall', KEYS[1])";
```

**ğŸ”¸ è¿æ¥æ± ä¼˜åŒ–**
```yaml
# application.yml
spring:
  redis:
    lettuce:
      pool:
        max-active: 20    # æœ€å¤§è¿æ¥æ•°
        max-idle: 10      # æœ€å¤§ç©ºé—²è¿æ¥
        min-idle: 5       # æœ€å°ç©ºé—²è¿æ¥
        max-wait: 2000ms  # æœ€å¤§ç­‰å¾…æ—¶é—´
    timeout: 1000ms       # è¿æ¥è¶…æ—¶
```

### 6.2 RabbitMQæ€§èƒ½ä¼˜åŒ–


**ğŸ”¸ ç”Ÿäº§è€…ä¼˜åŒ–**
```java
@Configuration
public class RabbitMQConfig {
    
    @Bean
    public RabbitTemplate rabbitTemplate(ConnectionFactory connectionFactory) {
        RabbitTemplate template = new RabbitTemplate(connectionFactory);
        
        // å¼€å¯å‘é€ç¡®è®¤
        template.setConfirmCallback((correlationData, ack, cause) -> {
            if (!ack) {
                log.error("æ¶ˆæ¯å‘é€å¤±è´¥: {}", cause);
                // é‡è¯•æˆ–è®°å½•å¤±è´¥æ¶ˆæ¯
            }
        });
        
        // å¼€å¯è¿”å›ç¡®è®¤
        template.setReturnsCallback(returned -> {
            log.error("æ¶ˆæ¯è·¯ç”±å¤±è´¥: {}", returned);
        });
        
        return template;
    }
}

// æ‰¹é‡å‘é€ä¼˜åŒ–
@Service
public class BatchSender {
    
    public void batchSend(List<SeckillMessage> messages) {
        
        // ä½¿ç”¨äº‹åŠ¡æ‰¹é‡å‘é€
        rabbitTemplate.execute(channel -> {
            channel.txSelect();
            try {
                for (SeckillMessage message : messages) {
                    channel.basicPublish("", "seckill.queue", 
                        null, serialize(message));
                }
                channel.txCommit();
            } catch (Exception e) {
                channel.txRollback();
                throw e;
            }
            return null;
        });
    }
}
```

**ğŸ”¸ æ¶ˆè´¹è€…ä¼˜åŒ–**
```java
@Component
public class OptimizedConsumer {
    
    @RabbitListener(
        queues = "seckill.queue",
        concurrency = "5-15",  // åŠ¨æ€è°ƒæ•´æ¶ˆè´¹è€…æ•°é‡
        containerFactory = "customContainerFactory"
    )
    public void consume(
        @Payload SeckillMessage message,
        @Header Map<String, Object> headers,
        Channel channel,
        @Header(AmqpHeaders.DELIVERY_TAG) long deliveryTag
    ) {
        
        try {
            // æ‰¹é‡ç¡®è®¤ä¼˜åŒ–
            if (deliveryTag % 10 == 0) {
                channel.basicAck(deliveryTag, true); // æ‰¹é‡ç¡®è®¤å‰10æ¡
            }
            
            // ä¸šåŠ¡å¤„ç†
            processSeckill(message);
            
        } catch (Exception e) {
            // é‡è¯•æœºåˆ¶
            int retryCount = getRetryCount(headers);
            if (retryCount < 3) {
                // é‡æ–°æŠ•é€’
                requeue(message, retryCount + 1);
            } else {
                // è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—
                channel.basicNack(deliveryTag, false, false);
            }
        }
    }
}
```

### 6.3 æ•°æ®åº“ä¼˜åŒ–


**ğŸ”¸ ç´¢å¼•ä¼˜åŒ–**
```sql
-- ä¸ºç§’æ€æŸ¥è¯¢åˆ›å»ºå¤åˆç´¢å¼•
CREATE INDEX idx_product_seckill ON products(id, status, stock, start_time);

-- ä¸ºè®¢å•æŸ¥è¯¢åˆ›å»ºç´¢å¼•  
CREATE INDEX idx_order_user_time ON orders(user_id, create_time);

-- åˆ†ææŸ¥è¯¢è®¡åˆ’
EXPLAIN SELECT * FROM products WHERE id = 1 AND status = 1;
```

**ğŸ”¸ è¯»å†™åˆ†ç¦»**
```java
@Configuration
public class DataSourceConfig {
    
    @Primary
    @Bean("masterDataSource")
    public DataSource masterDataSource() {
        // ä¸»åº“é…ç½®ï¼ˆå†™æ“ä½œï¼‰
        return DataSourceBuilder.create()
            .url("jdbc:mysql://master-db:3306/seckill")
            .build();
    }
    
    @Bean("slaveDataSource")  
    public DataSource slaveDataSource() {
        // ä»åº“é…ç½®ï¼ˆè¯»æ“ä½œï¼‰
        return DataSourceBuilder.create()
            .url("jdbc:mysql://slave-db:3306/seckill")
            .build();
    }
}

@Service
public class SeckillService {
    
    @Transactional(readOnly = true)
    @DataSource("slave")  // æŸ¥è¯¢ä½¿ç”¨ä»åº“
    public Product getProduct(Long productId) {
        return productRepository.findById(productId);
    }
    
    @Transactional
    @DataSource("master")  // æ›´æ–°ä½¿ç”¨ä¸»åº“
    public void updateStock(Long productId, Integer quantity) {
        productRepository.deductStock(productId, quantity);
    }
}
```

---

## 7. ğŸ—ï¸ å®Œæ•´æ¶æ„å®ç°


### 7.1 æ•´ä½“æ¶æ„å›¾


```
ç§’æ€ç³»ç»Ÿå®Œæ•´æ¶æ„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·å±‚                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ‰‹æœºAPP â”‚ å¾®ä¿¡å°ç¨‹åº â”‚ ç½‘é¡µç«¯  â”‚ H5é¡µé¢ â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚      CDN/è´Ÿè½½å‡è¡¡      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ¥å…¥å±‚                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Nginx â”‚ é™æµç»„ä»¶ â”‚ å‚æ•°éªŒè¯ â”‚ é»‘åå•æ£€æŸ¥ â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    åº”ç”¨æœåŠ¡å±‚        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 æ¶ˆæ¯é˜Ÿåˆ—å±‚                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¿«é€Ÿé˜Ÿåˆ— â”‚ è®¢å•é˜Ÿåˆ— â”‚ åº“å­˜é˜Ÿåˆ— â”‚ é€šçŸ¥é˜Ÿåˆ— â”‚ æ­»ä¿¡é˜Ÿåˆ—  â”‚     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚     ä¸šåŠ¡å¤„ç†å±‚       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ•°æ®å­˜å‚¨å±‚                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Redisç¼“å­˜ â”‚ MySQLä¸»åº“ â”‚ MySQLä»åº“ â”‚ æ—¥å¿—å­˜å‚¨ â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 æ ¸å¿ƒä»£ç å®ç°


**ğŸ”§ ä¸»è¦é…ç½®ç±»**
```java
@Configuration
@EnableRabbit
public class SeckillConfig {
    
    // ç§’æ€ä¸»é˜Ÿåˆ—
    @Bean
    public Queue seckillMainQueue() {
        return QueueBuilder.durable("seckill.main")
            .withArgument("x-max-length", 100000)
            .withArgument("x-message-ttl", 300000)
            .withArgument("x-dead-letter-exchange", "seckill.dead.exchange")
            .build();
    }
    
    // æ­»ä¿¡äº¤æ¢æœº
    @Bean
    public DirectExchange deadLetterExchange() {
        return new DirectExchange("seckill.dead.exchange");
    }
    
    // æ¶ˆè´¹è€…å®¹å™¨å·¥å‚
    @Bean
    public SimpleRabbitListenerContainerFactory containerFactory(
        ConnectionFactory connectionFactory) {
        
        SimpleRabbitListenerContainerFactory factory = 
            new SimpleRabbitListenerContainerFactory();
        factory.setConnectionFactory(connectionFactory);
        factory.setConcurrentConsumers(5);
        factory.setMaxConcurrentConsumers(15);
        factory.setPrefetchCount(1);
        factory.setAcknowledgeMode(AcknowledgeMode.MANUAL);
        
        return factory;
    }
}
```

**ğŸ¯ å®Œæ•´ä¸šåŠ¡æµç¨‹**
```java
@Service
@Slf4j
public class CompleteSeckillService {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    @Autowired
    private RedisStockService redisStockService;
    
    @Autowired
    private OrderService orderService;
    
    /**
     * ç§’æ€å…¥å£æ–¹æ³•
     */
    public SeckillResult seckill(SeckillRequest request) {
        
        // 1. å¿«é€ŸéªŒè¯
        if (!validateRequest(request)) {
            return SeckillResult.fail("è¯·æ±‚å‚æ•°é”™è¯¯");
        }
        
        // 2. ç”¨æˆ·é™åˆ¶æ£€æŸ¥ï¼ˆé˜²æ­¢åŒä¸€ç”¨æˆ·é‡å¤æŠ¢è´­ï¼‰
        if (!checkUserLimit(request.getUserId(), request.getProductId())) {
            return SeckillResult.fail("æ‚¨å·²å‚ä¸è¿‡è¯¥å•†å“çš„ç§’æ€");
        }
        
        // 3. å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—
        SeckillMessage message = SeckillMessage.builder()
            .userId(request.getUserId())
            .productId(request.getProductId())
            .requestId(UUID.randomUUID().toString())
            .timestamp(System.currentTimeMillis())
            .build();
        
        try {
            rabbitTemplate.convertAndSend("seckill.main", message);
            
            // 4. å¿«é€Ÿè¿”å›
            return SeckillResult.processing("å·²æäº¤ç”³è¯·ï¼Œè¯·ç¨åæŸ¥çœ‹ç»“æœ", 
                message.getRequestId());
                
        } catch (Exception e) {
            log.error("å‘é€æ¶ˆæ¯å¤±è´¥", e);
            return SeckillResult.fail("ç³»ç»Ÿç¹å¿™ï¼Œè¯·é‡è¯•");
        }
    }
    
    /**
     * å¼‚æ­¥å¤„ç†ç§’æ€æ¶ˆæ¯
     */
    @RabbitListener(queues = "seckill.main")
    public void processSeckillMessage(
        SeckillMessage message,
        Channel channel,
        @Header(AmqpHeaders.DELIVERY_TAG) long deliveryTag
    ) {
        
        try {
            // å¤„ç†ç§’æ€é€»è¾‘
            SeckillResult result = handleSeckill(message);
            
            // é€šçŸ¥ç”¨æˆ·ç»“æœ
            notifyUser(message.getUserId(), result);
            
            // æ‰‹åŠ¨ç¡®è®¤æ¶ˆæ¯
            channel.basicAck(deliveryTag, false);
            
        } catch (Exception e) {
            log.error("å¤„ç†ç§’æ€æ¶ˆæ¯å¤±è´¥", e);
            handleFailure(message, channel, deliveryTag);
        }
    }
    
    private SeckillResult handleSeckill(SeckillMessage message) {
        
        // 1. é¢„æ‰£Redisåº“å­˜
        if (!redisStockService.preDeductStock(message.getProductId(), 1)) {
            return SeckillResult.fail("å•†å“å·²å”®ç½„");
        }
        
        try {
            // 2. åˆ›å»ºè®¢å•
            Order order = orderService.createSeckillOrder(
                message.getUserId(), message.getProductId());
            
            // 3. ç¡®è®¤æ•°æ®åº“åº“å­˜
            boolean stockConfirmed = confirmDatabaseStock(
                message.getProductId(), 1);
            
            if (!stockConfirmed) {
                // åº“å­˜ç¡®è®¤å¤±è´¥ï¼Œå›æ»š
                redisStockService.restoreStock(message.getProductId(), 1);
                orderService.cancelOrder(order.getId());
                return SeckillResult.fail("åº“å­˜ä¸è¶³");
            }
            
            // 4. è®¢å•æ”¯ä»˜å€’è®¡æ—¶
            startPaymentCountdown(order.getId());
            
            return SeckillResult.success("ç§’æ€æˆåŠŸï¼è¯·åœ¨15åˆ†é’Ÿå†…å®Œæˆæ”¯ä»˜", 
                order.getId());
            
        } catch (Exception e) {
            // å¼‚å¸¸å›æ»š
            redisStockService.restoreStock(message.getProductId(), 1);
            throw e;
        }
    }
}
```

### 7.3 ç›‘æ§å’Œå‘Šè­¦


**ğŸ“Š å…³é”®æŒ‡æ ‡ç›‘æ§**
```java
@Component
public class SeckillMonitor {
    
    private final MeterRegistry meterRegistry;
    
    // ç›‘æ§æŒ‡æ ‡
    private final Counter seckillRequestCounter;
    private final Counter seckillSuccessCounter;
    private final Timer seckillProcessTimer;
    private final Gauge queueSizeGauge;
    
    public SeckillMonitor(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        
        // åˆå§‹åŒ–ç›‘æ§æŒ‡æ ‡
        this.seckillRequestCounter = Counter.builder("seckill.request.total")
            .description("ç§’æ€è¯·æ±‚æ€»æ•°")
            .register(meterRegistry);
            
        this.seckillSuccessCounter = Counter.builder("seckill.success.total")
            .description("ç§’æ€æˆåŠŸæ€»æ•°")
            .register(meterRegistry);
            
        this.seckillProcessTimer = Timer.builder("seckill.process.duration")
            .description("ç§’æ€å¤„ç†è€—æ—¶")
            .register(meterRegistry);
    }
    
    public void recordRequest() {
        seckillRequestCounter.increment();
    }
    
    public void recordSuccess() {
        seckillSuccessCounter.increment();
    }
    
    public Timer.Sample startTimer() {
        return Timer.start(meterRegistry);
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æµé‡å‰Šå³°ï¼šæŠŠç¬é—´é«˜å¹¶å‘åˆ†æ•£åˆ°æ—¶é—´è½´ä¸Šï¼Œä¿æŠ¤ç³»ç»Ÿç¨³å®š
ğŸ”¸ åº“å­˜é¢„æ‰£ï¼šåœ¨Redisä¸­æå‰æ‰£å‡åº“å­˜ï¼Œé¿å…æ·±åº¦å¤„ç†åå‘ç°åº“å­˜ä¸è¶³
ğŸ”¸ å¼‚æ­¥å¤„ç†ï¼šç”¨æ¶ˆæ¯é˜Ÿåˆ—è§£è€¦ï¼Œå¿«é€Ÿå“åº”ç”¨æˆ·ï¼Œåå°æ…¢æ…¢å¤„ç†
ğŸ”¸ è¶…å–é˜²æŠ¤ï¼šå¤šå±‚é˜²æŠ¤æœºåˆ¶ï¼Œç¡®ä¿åº“å­˜æ•°æ®çš„å‡†ç¡®æ€§
ğŸ”¸ æ€§èƒ½ä¼˜åŒ–ï¼šä»Redisã€RabbitMQã€æ•°æ®åº“å¤šä¸ªç»´åº¦ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½
```

### 8.2 å…³é”®æŠ€æœ¯è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆè¦ç”¨æ¶ˆæ¯é˜Ÿåˆ—**
```
ç›´æ¥è®¿é—®æ•°æ®åº“çš„é—®é¢˜ï¼š
- ç¬é—´10ä¸‡è¯·æ±‚ç›´æ¥æ‰“åˆ°æ•°æ®åº“
- æ•°æ®åº“è¿æ¥æ•°çˆ†æ»¡ï¼Œç³»ç»Ÿå´©æºƒ
- ç”¨æˆ·ä½“éªŒå·®ï¼Œå¤§é‡è¯·æ±‚å¤±è´¥

æ¶ˆæ¯é˜Ÿåˆ—çš„ä»·å€¼ï¼š
- æ¥æ”¶10ä¸‡è¯·æ±‚ï¼Œä½†åªç”¨1000çš„é€Ÿåº¦å¤„ç†
- æ•°æ®åº“å‹åŠ›å¯æ§ï¼Œç³»ç»Ÿç¨³å®šè¿è¡Œ  
- ç”¨æˆ·å¿«é€Ÿå¾—åˆ°å“åº”ï¼Œä½“éªŒè‰¯å¥½
```

**ğŸ”¹ å¤šå±‚é˜²æŠ¤çš„å¿…è¦æ€§**
```
å•ä¸€é˜²æŠ¤çš„è„†å¼±æ€§ï¼š
- åªç”¨Redisï¼šæ–­ç”µé‡å¯åæ•°æ®ä¸¢å¤±
- åªç”¨æ•°æ®åº“ï¼šå¹¶å‘é«˜æ—¶æ€§èƒ½å·®
- åªç”¨é”ï¼šå½±å“ç³»ç»Ÿååé‡

å¤šå±‚é˜²æŠ¤çš„ä¼˜åŠ¿ï¼š
- Rediså¿«é€Ÿæ‹¦æˆªï¼šå¤§éƒ¨åˆ†æ— æ•ˆè¯·æ±‚è¢«å¿«é€Ÿè¿‡æ»¤
- æ•°æ®åº“ç¡®è®¤ï¼šä¿è¯æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§
- å¼‚å¸¸å›æ»šï¼šä»»ä½•ç¯èŠ‚å¤±è´¥éƒ½èƒ½æ¢å¤çŠ¶æ€
```

### 8.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ’¡ ä¸šåŠ¡åœºæ™¯é€‚ç”¨æ€§**
- **ç”µå•†ç§’æ€**ï¼šé™æ—¶æŠ¢è´­ã€æ–°å“é¦–å‘ã€æ¸…ä»“ç”©å–
- **ç¥¨åŠ¡ç³»ç»Ÿ**ï¼šæ¼”å”±ä¼šé—¨ç¥¨ã€ç«è½¦ç¥¨ã€ç”µå½±ç¥¨
- **æ¸¸æˆé“å…·**ï¼šé™é‡çš®è‚¤ã€ç¨€æœ‰è£…å¤‡ã€ç¤¼åŒ…æŠ¢è´­
- **é‡‘èäº§å“**ï¼šé™é¢ç†è´¢ã€ä¿é™©äº§å“ã€ä¿¡è´·é¢åº¦

**ğŸ”§ æŠ€æœ¯èƒ½åŠ›æå‡**
- **é«˜å¹¶å‘å¤„ç†**ï¼šæŒæ¡å¤§æµé‡ç³»ç»Ÿçš„è®¾è®¡æ€è·¯
- **åˆ†å¸ƒå¼åè°ƒ**ï¼šç†è§£å¤šæœåŠ¡é—´çš„æ•°æ®ä¸€è‡´æ€§
- **æ€§èƒ½ä¼˜åŒ–**ï¼šå­¦ä¼šç³»ç»Ÿç“¶é¢ˆåˆ†æå’Œä¼˜åŒ–æ–¹æ³•
- **è¿ç»´ç›‘æ§**ï¼šå»ºç«‹å®Œå–„çš„ç³»ç»Ÿç›‘æ§å’Œå‘Šè­¦æœºåˆ¶

### 8.4 å­¦ä¹ å»ºè®®


**ğŸ“š å¾ªåºæ¸è¿›çš„å­¦ä¹ è·¯å¾„**
```
ç¬¬ä¸€é˜¶æ®µï¼šç†è§£åŸºæœ¬æ¦‚å¿µ
- ä»€ä¹ˆæ˜¯ç§’æ€ç³»ç»Ÿ
- ä¸ºä»€ä¹ˆéœ€è¦æ¶ˆæ¯é˜Ÿåˆ—
- è¶…å–é—®é¢˜çš„æœ¬è´¨

ç¬¬äºŒé˜¶æ®µï¼šæŒæ¡æ ¸å¿ƒæŠ€æœ¯
- RabbitMQçš„åŸºæœ¬ä½¿ç”¨
- Redisçš„åŸå­æ“ä½œ
- æ•°æ®åº“çš„ä¹è§‚é”

ç¬¬ä¸‰é˜¶æ®µï¼šç³»ç»Ÿæ¶æ„è®¾è®¡
- å¤šå±‚é˜Ÿåˆ—çš„è®¾è®¡æ€è·¯
- å¼‚æ­¥å¤„ç†çš„æµç¨‹è®¾è®¡
- ç›‘æ§å’Œå®¹é”™æœºåˆ¶

ç¬¬å››é˜¶æ®µï¼šæ€§èƒ½ä¼˜åŒ–å®è·µ
- å‹åŠ›æµ‹è¯•å’Œç“¶é¢ˆåˆ†æ
- å„ç»„ä»¶çš„å‚æ•°è°ƒä¼˜
- çº¿ä¸Šé—®é¢˜çš„æ’æŸ¥å¤„ç†
```

**âš ï¸ å¸¸è§è¯¯åŒºé¿å…**
```
è¯¯åŒº1ï¼šè®¤ä¸ºå•çº¯æé«˜æœåŠ¡å™¨é…ç½®å°±èƒ½è§£å†³é—®é¢˜
æ­£è§£ï¼šç§’æ€æ˜¯æ¶æ„é—®é¢˜ï¼Œä¸æ˜¯ç¡¬ä»¶é—®é¢˜

è¯¯åŒº2ï¼šå®Œå…¨ä¾èµ–æ•°æ®åº“äº‹åŠ¡ä¿è¯ä¸€è‡´æ€§
æ­£è§£ï¼šæ•°æ®åº“æ˜¯ç“¶é¢ˆï¼Œè¦ç”¨ç¼“å­˜åˆ†æ‹…å‹åŠ›

è¯¯åŒº3ï¼šå¿½è§†ç”¨æˆ·ä½“éªŒï¼Œåªå…³æ³¨æŠ€æœ¯å®ç°
æ­£è§£ï¼šå¿«é€Ÿå“åº”ç”¨æˆ·ï¼Œå¼‚æ­¥å¤„ç†æ˜¯å…³é”®

è¯¯åŒº4ï¼šè¿‡åº¦å¤æ‚åŒ–ï¼Œå¼•å…¥å¤ªå¤šæŠ€æœ¯ç»„ä»¶
æ­£è§£ï¼šæ ¹æ®å®é™…ä¸šåŠ¡é‡é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆ
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- å‰Šå³°å¡«è°·ä¿ç¨³å®šï¼Œé¢„æ‰£åº“å­˜é˜²è¶…å–
- å¼‚æ­¥å¤„ç†å¿«å“åº”ï¼Œå¤šå±‚é˜²æŠ¤æ•°æ®å‡†
- ç›‘æ§å‘Šè­¦ä¸å¯å°‘ï¼Œæ€§èƒ½ä¼˜åŒ–è¦æŒç»­

**å®æˆ˜æé†’**ï¼š
- ç§’æ€ç³»ç»Ÿè¦åœ¨ä¸šåŠ¡é«˜å³°å‰å……åˆ†æµ‹è¯•
- å‡†å¤‡å¥½é™çº§å’Œç†”æ–­æœºåˆ¶
- å»ºç«‹å®Œå–„çš„æ•°æ®æ¢å¤æµç¨‹
- å…³æ³¨ç”¨æˆ·ä½“éªŒå’Œå®¢æœå¤„ç†èƒ½åŠ›