---
title: 4ã€æ”¯ä»˜ç³»ç»Ÿé›†æˆ
---
## ğŸ“š ç›®å½•

1. [æ”¯ä»˜ç³»ç»Ÿçš„æ¶ˆæ¯ä¼ é€’éœ€æ±‚](#1-æ”¯ä»˜ç³»ç»Ÿçš„æ¶ˆæ¯ä¼ é€’éœ€æ±‚)
2. [æ”¯ä»˜çŠ¶æ€åŒæ­¥æœºåˆ¶](#2-æ”¯ä»˜çŠ¶æ€åŒæ­¥æœºåˆ¶)
3. [å¯¹è´¦æ•°æ®å¤„ç†å®ç°](#3-å¯¹è´¦æ•°æ®å¤„ç†å®ç°)
4. [é£æ§è§„åˆ™è§¦å‘ç³»ç»Ÿ](#4-é£æ§è§„åˆ™è§¦å‘ç³»ç»Ÿ)
5. [æ¸…ç®—ç»“ç®—æµç¨‹è®¾è®¡](#5-æ¸…ç®—ç»“ç®—æµç¨‹è®¾è®¡)
6. [å¼‚å¸¸äº¤æ˜“å¤„ç†æ–¹æ¡ˆ](#6-å¼‚å¸¸äº¤æ˜“å¤„ç†æ–¹æ¡ˆ)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ’° æ”¯ä»˜ç³»ç»Ÿçš„æ¶ˆæ¯ä¼ é€’éœ€æ±‚


### 1.1 æ”¯ä»˜ç³»ç»ŸåŸºæœ¬æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯æ”¯ä»˜ç³»ç»Ÿï¼Ÿ**
ç®€å•ç†è§£ï¼Œæ”¯ä»˜ç³»ç»Ÿå°±åƒä¸€ä¸ªé’±æ¬¾ä¸­è½¬ç«™ï¼š
- ç”¨æˆ·åœ¨ç½‘ä¸Šä¹°ä¸œè¥¿ï¼Œç‚¹å‡»"æ”¯ä»˜"
- ç³»ç»Ÿè¦å¤„ç†ä»ä½ çš„é“¶è¡Œå¡åˆ°å•†å®¶è´¦æˆ·çš„è½¬è´¦
- æ•´ä¸ªè¿‡ç¨‹æ¶‰åŠå¤šä¸ªé“¶è¡Œã€ç¬¬ä¸‰æ–¹æ”¯ä»˜ç­‰

**ä¸ºä»€ä¹ˆéœ€è¦æ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿ**
```
ä¼ ç»Ÿåšæ³•çš„é—®é¢˜ï¼š
ç”¨æˆ·æ”¯ä»˜ â†’ ç›´æ¥è°ƒç”¨é“¶è¡Œæ¥å£ â†’ ç­‰å¾…ç»“æœ

é—®é¢˜ï¼š
â€¢ é“¶è¡Œå“åº”æ…¢ï¼Œç”¨æˆ·ç­‰å¾—æ€¥ â±ï¸
â€¢ ç½‘ç»œæ•…éšœå¯èƒ½ä¸¢å¤±äº¤æ˜“ âŒ
â€¢ å¤§é‡å¹¶å‘æ—¶ç³»ç»Ÿå®¹æ˜“å´©æºƒ ğŸ’¥

æœ‰äº†RabbitMQçš„å¥½å¤„ï¼š
ç”¨æˆ·æ”¯ä»˜ â†’ ç«‹å³è¿”å›"å¤„ç†ä¸­" â†’ åå°æ…¢æ…¢å¤„ç†
```

### 1.2 æ”¯ä»˜ç³»ç»Ÿæ¶æ„å›¾


```
æ”¯ä»˜æµç¨‹æ¶æ„ï¼š

å‰ç«¯åº”ç”¨                    æ”¯ä»˜ç½‘å…³                    æ ¸å¿ƒç³»ç»Ÿ
   |                         |                          |
   |--[1]æ”¯ä»˜è¯·æ±‚----------->|                          |
   |<-[2]ç«‹å³å“åº”"å¤„ç†ä¸­"-----|                          |
   |                         |--[3]æ¶ˆæ¯é˜Ÿåˆ—------------>|é“¶è¡Œæ¥å£
   |                         |                          |é£æ§ç³»ç»Ÿ
   |<-[4]æœ€ç»ˆçŠ¶æ€é€šçŸ¥---------|<-[5]å¤„ç†ç»“æœ-------------| |å¯¹è´¦ç³»ç»Ÿ
   |                         |                          |æ¸…ç®—ç³»ç»Ÿ

å…³é”®ç‰¹ç‚¹ï¼š
âœ“ å¼‚æ­¥å¤„ç†ï¼šç”¨æˆ·ä¸ç”¨å¹²ç­‰
âœ“ è§£è€¦ç³»ç»Ÿï¼šå„éƒ¨åˆ†ç‹¬ç«‹è¿è¡Œ
âœ“ é«˜å¯é ï¼šæ¶ˆæ¯ä¸ä¼šä¸¢å¤±
```

### 1.3 æ ¸å¿ƒä¸šåŠ¡æµç¨‹


**ğŸ”„ æ”¯ä»˜çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸ**
```
1. å‘èµ·æ”¯ä»˜ â†’ 2. é£æ§æ£€æŸ¥ â†’ 3. é“¶è¡Œæ‰£æ¬¾ â†’ 4. çŠ¶æ€åŒæ­¥ â†’ 5. å¯¹è´¦ç¡®è®¤
     |              |              |              |              |
  æ¶ˆæ¯é€šçŸ¥      é£æ§é˜Ÿåˆ—        æ”¯ä»˜é˜Ÿåˆ—        çŠ¶æ€é˜Ÿåˆ—        å¯¹è´¦é˜Ÿåˆ—
```

**ğŸ’¡ é€šä¿—ç†è§£**
> æƒ³è±¡ä½ åœ¨ç½‘ä¸Šä¹°ä¸œè¥¿ä»˜æ¬¾ï¼š
> 1. ç‚¹å‡»æ”¯ä»˜ï¼ˆå‘èµ·ï¼‰
> 2. ç³»ç»Ÿæ£€æŸ¥æ˜¯å¦å¯ç–‘ï¼ˆé£æ§ï¼‰
> 3. ä»ä½ å¡é‡Œæ‰£é’±ï¼ˆé“¶è¡Œå¤„ç†ï¼‰
> 4. å‘Šè¯‰ä½ å’Œå•†å®¶ç»“æœï¼ˆçŠ¶æ€åŒæ­¥ï¼‰
> 5. æ™šä¸Šå¯¹è´¦ç¡®ä¿æ²¡é—®é¢˜ï¼ˆå¯¹è´¦ï¼‰

---

## 2. ğŸ“¡ æ”¯ä»˜çŠ¶æ€åŒæ­¥æœºåˆ¶


### 2.1 çŠ¶æ€åŒæ­¥çš„å¿…è¦æ€§


**ä¸ºä»€ä¹ˆè¦åŒæ­¥çŠ¶æ€ï¼Ÿ**
```
æ”¯ä»˜æ¶‰åŠå¤šä¸ªç³»ç»Ÿï¼š
â€¢ ç”¨æˆ·ç³»ç»Ÿï¼šéœ€è¦çŸ¥é“æ‰£æ¬¾æˆåŠŸæ²¡
â€¢ å•†å®¶ç³»ç»Ÿï¼šéœ€è¦çŸ¥é“èƒ½ä¸èƒ½å‘è´§
â€¢ è´¢åŠ¡ç³»ç»Ÿï¼šéœ€è¦è®°å½•æ”¶æ”¯æµæ°´
â€¢ é£æ§ç³»ç»Ÿï¼šéœ€è¦åˆ†æäº¤æ˜“æ¨¡å¼

å¦‚æœä¸åŒæ­¥ï¼š
âŒ ç”¨æˆ·æ˜¾ç¤ºå¤±è´¥ï¼Œå®é™…å·²æ‰£æ¬¾
âŒ å•†å®¶ä»¥ä¸ºæ²¡æ”¶åˆ°é’±ï¼Œä¸å‘è´§
âŒ è´¢åŠ¡è´¦ç›®å¯¹ä¸ä¸Š
```

### 2.2 çŠ¶æ€åŒæ­¥å®ç°


**ğŸ—ï¸ Exchangeå’ŒQueueè®¾è®¡**
```
æ”¯ä»˜çŠ¶æ€åŒæ­¥æ¶æ„ï¼š

                   payment.status.exchange (Topic Exchange)
                            |
            +---------------+---------------+
            |               |               |
    payment.success   payment.failed   payment.timeout
         é˜Ÿåˆ—            é˜Ÿåˆ—             é˜Ÿåˆ—
            |               |               |
    [ç”¨æˆ·é€šçŸ¥æœåŠ¡]    [å¼‚å¸¸å¤„ç†æœåŠ¡]   [è¶…æ—¶å¤„ç†æœåŠ¡]
    [å•†å®¶é€šçŸ¥æœåŠ¡]    [é€€æ¬¾æœåŠ¡]       [äººå·¥å®¡æ ¸]
    [ç§¯åˆ†æœåŠ¡]        [æ—¥å¿—æœåŠ¡]       [è¡¥å¿æœåŠ¡]
```

**ğŸ’» æ ¸å¿ƒä»£ç å®ç°**
```java
@Component
public class PaymentStatusSyncService {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    // å‘é€æ”¯ä»˜çŠ¶æ€å˜æ›´æ¶ˆæ¯
    public void syncPaymentStatus(PaymentStatusEvent event) {
        String routingKey = buildRoutingKey(event.getStatus());
        
        // æ„å»ºæ¶ˆæ¯å†…å®¹
        PaymentMessage message = PaymentMessage.builder()
            .orderId(event.getOrderId())
            .userId(event.getUserId())
            .amount(event.getAmount())
            .status(event.getStatus())
            .timestamp(System.currentTimeMillis())
            .build();
        
        // å‘é€åˆ°çŠ¶æ€äº¤æ¢æœº
        rabbitTemplate.convertAndSend(
            "payment.status.exchange", 
            routingKey, 
            message
        );
    }
    
    // æ ¹æ®çŠ¶æ€æ„å»ºè·¯ç”±é”®
    private String buildRoutingKey(PaymentStatus status) {
        switch (status) {
            case SUCCESS: return "payment.success";
            case FAILED:  return "payment.failed";
            case TIMEOUT: return "payment.timeout";
            default:      return "payment.unknown";
        }
    }
}
```

### 2.3 å¤šç³»ç»Ÿæ¶ˆè´¹å¤„ç†


**ğŸ“± ç”¨æˆ·é€šçŸ¥æœåŠ¡**
```java
@RabbitListener(queues = "payment.success.user.queue")
public class UserNotificationService {
    
    public void handlePaymentSuccess(PaymentMessage message) {
        // ç»™ç”¨æˆ·å‘é€æ”¯ä»˜æˆåŠŸé€šçŸ¥
        notificationService.sendToUser(
            message.getUserId(),
            "æ”¯ä»˜æˆåŠŸï¼Œè®¢å•å·ï¼š" + message.getOrderId()
        );
        
        // æ›´æ–°ç”¨æˆ·ç§¯åˆ†
        pointService.addPoints(message.getUserId(), 
                              calculatePoints(message.getAmount()));
    }
}
```

**ğŸª å•†å®¶é€šçŸ¥æœåŠ¡**
```java
@RabbitListener(queues = "payment.success.merchant.queue")
public class MerchantNotificationService {
    
    public void handlePaymentSuccess(PaymentMessage message) {
        // é€šçŸ¥å•†å®¶å¯ä»¥å‘è´§äº†
        Order order = orderService.getById(message.getOrderId());
        
        // æ›´æ–°è®¢å•çŠ¶æ€ä¸º"å·²ä»˜æ¬¾ï¼Œå¾…å‘è´§"
        order.setStatus(OrderStatus.PAID);
        orderService.update(order);
        
        // å‘é€å‘è´§æé†’
        merchantService.notifyToShip(order.getMerchantId(), order);
    }
}
```

### 2.4 çŠ¶æ€åŒæ­¥æœ€ä½³å®è·µ


**âš¡ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**
```
æ‰¹é‡å¤„ç†ä¼˜åŒ–ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1ç§’å†…æ”¶é›† â†’ æ‰¹é‡å‘é€ â†’ å‡å°‘ç½‘ç»œå¼€é”€  â”‚
â”‚ å•æ¡å¤„ç†     100æ¡æ¶ˆæ¯     èŠ‚çœ90%æ—¶é—´ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å»é‡å¤„ç†ï¼š
â€¢ æ¶ˆæ¯IDç¡®ä¿å¹‚ç­‰æ€§
â€¢ æ•°æ®åº“å”¯ä¸€ç´¢å¼•é˜²é‡å¤
â€¢ Redisç¼“å­˜æœ€è¿‘å¤„ç†è®°å½•
```

**ğŸ”’ å¯é æ€§ä¿éšœ**
```markdown
å¯é æ€§ä¿éšœæªæ–½ï¼š

ğŸ”¸ æ¶ˆæ¯æŒä¹…åŒ–
â€¢ äº¤æ¢æœºï¼šdurable=true
â€¢ é˜Ÿåˆ—ï¼šdurable=true  
â€¢ æ¶ˆæ¯ï¼šdelivery_mode=2

ğŸ”¸ æ¶ˆè´¹ç¡®è®¤
â€¢ æ‰‹åŠ¨ACKæ¨¡å¼
â€¢ ä¸šåŠ¡å¤„ç†æˆåŠŸæ‰ç¡®è®¤
â€¢ å¼‚å¸¸æ—¶æ¶ˆæ¯é‡æ–°å…¥é˜Ÿ

ğŸ”¸ æ­»ä¿¡å¤„ç†
â€¢ è¶…è¿‡é‡è¯•æ¬¡æ•°è¿›æ­»ä¿¡é˜Ÿåˆ—
â€¢ äººå·¥ä»‹å…¥å¤„ç†å¼‚å¸¸æ¶ˆæ¯
```

---

## 3. ğŸ“Š å¯¹è´¦æ•°æ®å¤„ç†å®ç°


### 3.1 å¯¹è´¦ä¸šåŠ¡èƒŒæ™¯


**ä»€ä¹ˆæ˜¯å¯¹è´¦ï¼Ÿ**
ç®€å•è¯´å°±æ˜¯"æ ¸å¯¹è´¦ç›®"ï¼š
```
æ—¥å¸¸ç”Ÿæ´»çš„å¯¹è´¦ï¼š
ä½ çš„é“¶è¡Œå¡æµæ°´ vs ä½ çš„æ¶ˆè´¹è®°å½•

æ”¯ä»˜ç³»ç»Ÿçš„å¯¹è´¦ï¼š
æˆ‘ä»¬ç³»ç»Ÿçš„äº¤æ˜“è®°å½• vs é“¶è¡Œ/æ”¯ä»˜å®çš„äº¤æ˜“è®°å½•

ç›®çš„ï¼šç¡®ä¿è´¦ç›®ä¸€è‡´ï¼Œå‘ç°é—®é¢˜åŠæ—¶å¤„ç†
```

**ğŸ•’ å¯¹è´¦æ—¶æœºå’Œé¢‘ç‡**
```
T+0å¯¹è´¦ï¼šå®æ—¶å¯¹è´¦ï¼ˆé‡è¦äº¤æ˜“ï¼‰
T+1å¯¹è´¦ï¼šæ¬¡æ—¥å¯¹è´¦ï¼ˆæ—¥å¸¸äº¤æ˜“ï¼‰
æœˆåº¦å¯¹è´¦ï¼šæœˆæœ«å…¨é‡å¯¹è´¦ï¼ˆè´¢åŠ¡è¦æ±‚ï¼‰

å¯¹è´¦æ–‡ä»¶è·å–æ—¶é—´ï¼š
é“¶è¡Œï¼šé€šå¸¸æ¬¡æ—¥ä¸Šåˆ8ç‚¹åæä¾›
æ”¯ä»˜å®ï¼š0ç‚¹åå¯è·å–å‰ä¸€æ—¥æ•°æ®
å¾®ä¿¡ï¼šå‡Œæ™¨2ç‚¹åå¯è·å–å‰ä¸€æ—¥æ•°æ®
```

### 3.2 å¯¹è´¦æ•°æ®æµç¨‹è®¾è®¡


**ğŸ“‚ å¯¹è´¦æ–‡ä»¶å¤„ç†æµç¨‹**
```
å¯¹è´¦æ–‡ä»¶å¤„ç†æ¶æ„ï¼š

å®šæ—¶ä»»åŠ¡                 æ–‡ä»¶é˜Ÿåˆ—                 å¤„ç†æœåŠ¡
   |                      |                        |
   |--[1]è§¦å‘ä¸‹è½½--------->|                        |
   |                      |--[2]æ–‡ä»¶æ¶ˆæ¯---------->|è§£ææœåŠ¡
   |                      |                        |æ¯”å¯¹æœåŠ¡
   |<-[3]å¤„ç†ç»“æœé€šçŸ¥------|<-[4]ç»“æœæ¶ˆæ¯-----------|å·®å¼‚å¤„ç†
   |                      |                        |æŠ¥å‘Šç”Ÿæˆ

æ¶ˆæ¯æµè½¬ï¼š
file.download â†’ file.parse â†’ file.compare â†’ file.report
```

**ğŸ’» æ–‡ä»¶å¤„ç†å®ç°**
```java
@Component
public class ReconciliationFileProcessor {
    
    // å®šæ—¶ä¸‹è½½å¯¹è´¦æ–‡ä»¶
    @Scheduled(cron = "0 30 8 * * ?") // æ¯å¤©8:30è§¦å‘
    public void downloadReconciliationFiles() {
        LocalDate yesterday = LocalDate.now().minusDays(1);
        
        // å‘é€ä¸‹è½½ä»»åŠ¡åˆ°é˜Ÿåˆ—
        DownloadTask task = DownloadTask.builder()
            .date(yesterday)
            .channels(Arrays.asList("alipay", "wechat", "bank"))
            .build();
            
        rabbitTemplate.convertAndSend(
            "reconciliation.download.queue", 
            task
        );
    }
}

@RabbitListener(queues = "reconciliation.download.queue")
public class FileDownloadService {
    
    public void downloadFile(DownloadTask task) {
        for (String channel : task.getChannels()) {
            try {
                // ä¸‹è½½å¯¹è´¦æ–‡ä»¶
                File file = channelService.downloadFile(channel, task.getDate());
                
                // å‘é€è§£æä»»åŠ¡
                ParseTask parseTask = ParseTask.builder()
                    .channel(channel)
                    .filePath(file.getPath())
                    .date(task.getDate())
                    .build();
                    
                rabbitTemplate.convertAndSend(
                    "reconciliation.parse.queue", 
                    parseTask
                );
                
            } catch (Exception e) {
                handleDownloadError(channel, task.getDate(), e);
            }
        }
    }
}
```

### 3.3 æ•°æ®è§£æå’Œæ¯”å¯¹


**ğŸ“‹ æ–‡ä»¶è§£ææœåŠ¡**
```java
@RabbitListener(queues = "reconciliation.parse.queue")
public class FileParseService {
    
    public void parseFile(ParseTask task) {
        List<TransactionRecord> records = new ArrayList<>();
        
        try (BufferedReader reader = Files.newBufferedReader(
                Paths.get(task.getFilePath()))) {
            
            String line;
            while ((line = reader.readLine()) != null) {
                // è§£ææ¯è¡Œæ•°æ®
                TransactionRecord record = parseLine(line, task.getChannel());
                if (record != null) {
                    records.add(record);
                }
            }
            
            // å‘é€æ¯”å¯¹ä»»åŠ¡
            CompareTask compareTask = CompareTask.builder()
                .channel(task.getChannel())
                .date(task.getDate())
                .externalRecords(records)
                .build();
                
            rabbitTemplate.convertAndSend(
                "reconciliation.compare.queue", 
                compareTask
            );
            
        } catch (IOException e) {
            handleParseError(task, e);
        }
    }
    
    // è§£æå•è¡Œæ•°æ®
    private TransactionRecord parseLine(String line, String channel) {
        // æ ¹æ®ä¸åŒæ¸ é“çš„æ ¼å¼è§£æ
        switch (channel) {
            case "alipay":  return parseAlipayLine(line);
            case "wechat":  return parseWechatLine(line);
            case "bank":    return parseBankLine(line);
            default:        return null;
        }
    }
}
```

### 3.4 å·®å¼‚å¤„ç†å’ŒæŠ¥å‘Š


**ğŸ” æ•°æ®æ¯”å¯¹é€»è¾‘**
```java
@RabbitListener(queues = "reconciliation.compare.queue")
public class ReconciliationCompareService {
    
    public void compareRecords(CompareTask task) {
        // è·å–æˆ‘ä»¬ç³»ç»Ÿçš„äº¤æ˜“è®°å½•
        List<TransactionRecord> internalRecords = 
            transactionService.getByDate(task.getDate(), task.getChannel());
        
        // æ‰§è¡Œæ¯”å¯¹
        ReconciliationResult result = performComparison(
            internalRecords, 
            task.getExternalRecords()
        );
        
        // å‘é€ç»“æœå¤„ç†ä»»åŠ¡
        ResultTask resultTask = ResultTask.builder()
            .result(result)
            .channel(task.getChannel())
            .date(task.getDate())
            .build();
            
        rabbitTemplate.convertAndSend(
            "reconciliation.result.queue", 
            resultTask
        );
    }
    
    private ReconciliationResult performComparison(
            List<TransactionRecord> internal,
            List<TransactionRecord> external) {
        
        ReconciliationResult result = new ReconciliationResult();
        
        // é‡‘é¢ä¸ç¬¦
        List<AmountMismatch> amountMismatches = findAmountMismatches(internal, external);
        result.setAmountMismatches(amountMismatches);
        
        // æˆ‘ä»¬æœ‰ï¼Œå¯¹æ–¹æ²¡æœ‰ï¼ˆå¯èƒ½æ˜¯å¯¹æ–¹æ¼å•ï¼‰
        List<TransactionRecord> missingInExternal = findMissingInExternal(internal, external);
        result.setMissingInExternal(missingInExternal);
        
        // å¯¹æ–¹æœ‰ï¼Œæˆ‘ä»¬æ²¡æœ‰ï¼ˆå¯èƒ½æ˜¯æˆ‘ä»¬æ¼å•ï¼‰
        List<TransactionRecord> missingInInternal = findMissingInInternal(internal, external);
        result.setMissingInInternal(missingInInternal);
        
        return result;
    }
}
```

**ğŸ“ˆ å¯¹è´¦æŠ¥å‘Šç”Ÿæˆ**
```markdown
ğŸ“Š **å¯¹è´¦ç»“æœç¤ºä¾‹**

2025-09-19 æ”¯ä»˜å®æ¸ é“å¯¹è´¦æŠ¥å‘Š
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… **å¯¹è´¦æ¦‚å†µ**
- æ€»äº¤æ˜“ç¬”æ•°ï¼š1,234 ç¬”
- åŒ¹é…æˆåŠŸï¼š1,230 ç¬” (99.7%)
- å‘ç°å·®å¼‚ï¼š4 ç¬” (0.3%)

âŒ **å·®å¼‚æ˜ç»†**
1. é‡‘é¢ä¸ç¬¦ï¼š2ç¬”
   - è®¢å• 20250919001: æˆ‘ä»¬ 100.00ï¼Œæ”¯ä»˜å® 99.99
   - è®¢å• 20250919002: æˆ‘ä»¬ 200.00ï¼Œæ”¯ä»˜å® 200.01

2. å¯¹æ–¹æ¼å•ï¼š1ç¬”
   - è®¢å• 20250919003: æˆ‘ä»¬æœ‰è®°å½•ï¼Œæ”¯ä»˜å®æ— 

3. æˆ‘ä»¬æ¼å•ï¼š1ç¬”
   - å¤–éƒ¨å•å· 2025091900456: æ”¯ä»˜å®æœ‰ï¼Œæˆ‘ä»¬æ— 

ğŸ”§ **å¤„ç†å»ºè®®**
- é‡‘é¢å·®å¼‚ï¼šè”ç³»æ¸ é“æ–¹æ ¸å®
- æ¼å•é—®é¢˜ï¼šæ£€æŸ¥ç³»ç»Ÿæ—¥å¿—ï¼Œè¡¥å•å¤„ç†
```

---

## 4. ğŸ›¡ï¸ é£æ§è§„åˆ™è§¦å‘ç³»ç»Ÿ


### 4.1 é£æ§ç³»ç»Ÿæ¦‚è¿°


**ä»€ä¹ˆæ˜¯é£æ§ï¼Ÿ**
é£æ§å°±æ˜¯"é£é™©æ§åˆ¶"çš„ç®€ç§°ï¼Œæƒ³è±¡æˆé“¶è¡Œçš„ä¿å®‰ï¼š
```
ç”Ÿæ´»ä¸­çš„é£æ§ä¾‹å­ï¼š
â€¢ ATMè¿ç»­è¾“é”™3æ¬¡å¯†ç  â†’ é”å¡
â€¢ ä¿¡ç”¨å¡å¼‚åœ°æ¶ˆè´¹ â†’ çŸ­ä¿¡ç¡®è®¤
â€¢ å¤§é¢è½¬è´¦ â†’ æ‰‹æœºéªŒè¯ç 

æ”¯ä»˜ç³»ç»Ÿçš„é£æ§ï¼š
â€¢ æ£€æµ‹å¯ç–‘äº¤æ˜“æ¨¡å¼
â€¢ é˜»æ­¢æ¬ºè¯ˆäº¤æ˜“
â€¢ ä¿æŠ¤ç”¨æˆ·èµ„é‡‘å®‰å…¨
```

### 4.2 é£æ§è§„åˆ™å¼•æ“


**ğŸ”§ è§„åˆ™å¼•æ“æ¶æ„**
```
é£æ§å¤„ç†æµç¨‹ï¼š

æ”¯ä»˜è¯·æ±‚ â†’ è§„åˆ™å¼•æ“ â†’ é£é™©è¯„åˆ† â†’ å¤„ç†å†³ç­–
    |          |          |          |
    |      [è§„åˆ™é˜Ÿåˆ—]  [è¯„åˆ†é˜Ÿåˆ—]  [å†³ç­–é˜Ÿåˆ—]
    |          |          |          |
    |      è§„åˆ™æœåŠ¡   è¯„åˆ†æœåŠ¡   å†³ç­–æœåŠ¡
    â†“          â†“          â†“          â†“
ç«‹å³å“åº”   è§„åˆ™åŒ¹é…   é£é™©è®¡ç®—   æ‰§è¡ŒåŠ¨ä½œ
```

**ğŸ’» é£æ§æ¶ˆæ¯å¤„ç†**
```java
@Component
public class RiskControlService {
    
    // æ¥æ”¶æ”¯ä»˜è¯·æ±‚ï¼Œå¼€å§‹é£æ§æ£€æŸ¥
    @RabbitListener(queues = "payment.risk.check.queue")
    public void checkRisk(PaymentRequest request) {
        
        // æ„å»ºé£æ§ä¸Šä¸‹æ–‡
        RiskContext context = RiskContext.builder()
            .userId(request.getUserId())
            .amount(request.getAmount())
            .paymentMethod(request.getPaymentMethod())
            .deviceInfo(request.getDeviceInfo())
            .timestamp(System.currentTimeMillis())
            .build();
        
        // å‘é€åˆ°è§„åˆ™åŒ¹é…é˜Ÿåˆ—
        rabbitTemplate.convertAndSend(
            "risk.rule.match.queue", 
            context
        );
    }
}

@RabbitListener(queues = "risk.rule.match.queue")
public class RiskRuleMatchService {
    
    public void matchRules(RiskContext context) {
        List<RiskRule> matchedRules = new ArrayList<>();
        
        // æ£€æŸ¥å„ç§é£æ§è§„åˆ™
        matchedRules.addAll(checkAmountRules(context));
        matchedRules.addAll(checkFrequencyRules(context));
        matchedRules.addAll(checkDeviceRules(context));
        matchedRules.addAll(checkLocationRules(context));
        
        if (!matchedRules.isEmpty()) {
            // å‘é€åˆ°è¯„åˆ†é˜Ÿåˆ—
            RiskMatchResult result = RiskMatchResult.builder()
                .context(context)
                .matchedRules(matchedRules)
                .build();
                
            rabbitTemplate.convertAndSend(
                "risk.score.calculate.queue", 
                result
            );
        } else {
            // æ— é£é™©ï¼Œç›´æ¥é€šè¿‡
            approvePayment(context);
        }
    }
}
```

### 4.3 å¸¸è§é£æ§è§„åˆ™


**ğŸ’° é‡‘é¢è§„åˆ™æ£€æŸ¥**
```java
private List<RiskRule> checkAmountRules(RiskContext context) {
    List<RiskRule> triggeredRules = new ArrayList<>();
    
    // å¤§é¢äº¤æ˜“è§„åˆ™
    if (context.getAmount().compareTo(new BigDecimal("10000")) > 0) {
        triggeredRules.add(RiskRule.builder()
            .ruleId("AMOUNT_001")
            .ruleName("å¤§é¢äº¤æ˜“")
            .description("å•ç¬”äº¤æ˜“è¶…è¿‡1ä¸‡å…ƒ")
            .riskScore(50)
            .build());
    }
    
    // å°é¢é«˜é¢‘è§„åˆ™
    BigDecimal todayTotal = getTodayTotalAmount(context.getUserId());
    if (todayTotal.compareTo(new BigDecimal("50000")) > 0) {
        triggeredRules.add(RiskRule.builder()
            .ruleId("AMOUNT_002")
            .ruleName("æ—¥ç´¯è®¡å¤§é¢")
            .description("æ—¥ç´¯è®¡äº¤æ˜“è¶…è¿‡5ä¸‡å…ƒ")
            .riskScore(30)
            .build());
    }
    
    return triggeredRules;
}
```

**âš¡ é¢‘ç‡è§„åˆ™æ£€æŸ¥**
```java
private List<RiskRule> checkFrequencyRules(RiskContext context) {
    List<RiskRule> triggeredRules = new ArrayList<>();
    
    // æ£€æŸ¥æœ€è¿‘1åˆ†é’Ÿå†…çš„äº¤æ˜“æ¬¡æ•°
    int recentCount = getRecentTransactionCount(
        context.getUserId(), 
        Duration.ofMinutes(1)
    );
    
    if (recentCount > 5) {
        triggeredRules.add(RiskRule.builder()
            .ruleId("FREQ_001")
            .ruleName("é«˜é¢‘äº¤æ˜“")
            .description("1åˆ†é’Ÿå†…äº¤æ˜“è¶…è¿‡5æ¬¡")
            .riskScore(40)
            .build());
    }
    
    return triggeredRules;
}
```

### 4.4 é£é™©è¯„åˆ†å’Œå†³ç­–


**ğŸ“Š é£é™©è¯„åˆ†è®¡ç®—**
```java
@RabbitListener(queues = "risk.score.calculate.queue")
public class RiskScoreService {
    
    public void calculateScore(RiskMatchResult matchResult) {
        RiskContext context = matchResult.getContext();
        List<RiskRule> rules = matchResult.getMatchedRules();
        
        // è®¡ç®—åŸºç¡€åˆ†æ•°
        int baseScore = rules.stream()
            .mapToInt(RiskRule::getRiskScore)
            .sum();
        
        // ç”¨æˆ·å†å²è¡Œä¸ºåŠ æƒ
        double userFactor = getUserRiskFactor(context.getUserId());
        
        // è®¾å¤‡ä¿¡ä»»åº¦åŠ æƒ
        double deviceFactor = getDeviceRiskFactor(context.getDeviceInfo());
        
        // æœ€ç»ˆé£é™©åˆ†æ•°
        int finalScore = (int) (baseScore * userFactor * deviceFactor);
        
        // å‘é€åˆ°å†³ç­–é˜Ÿåˆ—
        RiskDecision decision = RiskDecision.builder()
            .context(context)
            .riskScore(finalScore)
            .matchedRules(rules)
            .build();
            
        rabbitTemplate.convertAndSend(
            "risk.decision.queue", 
            decision
        );
    }
}
```

**âš–ï¸ é£æ§å†³ç­–æ‰§è¡Œ**
```java
@RabbitListener(queues = "risk.decision.queue")
public class RiskDecisionService {
    
    public void makeDecision(RiskDecision decision) {
        int score = decision.getRiskScore();
        RiskContext context = decision.getContext();
        
        if (score < 30) {
            // ä½é£é™©ï¼šç›´æ¥é€šè¿‡
            approvePayment(context, "ä½é£é™©è‡ªåŠ¨é€šè¿‡");
            
        } else if (score < 70) {
            // ä¸­ç­‰é£é™©ï¼šéœ€è¦é¢å¤–éªŒè¯
            requireAdditionalVerification(context);
            
        } else {
            // é«˜é£é™©ï¼šæ‹’ç»äº¤æ˜“
            rejectPayment(context, "é«˜é£é™©äº¤æ˜“ï¼Œå·²æ‹’ç»");
            
            // åŒæ—¶è§¦å‘äººå·¥å®¡æ ¸
            triggerManualReview(decision);
        }
    }
    
    private void requireAdditionalVerification(RiskContext context) {
        // å‘é€çŸ­ä¿¡éªŒè¯ç 
        smsService.sendVerificationCode(context.getUserId());
        
        // é€šçŸ¥å‰ç«¯éœ€è¦é¢å¤–éªŒè¯
        notificationService.requireVerification(
            context.getUserId(), 
            "ä¸ºäº†æ‚¨çš„èµ„é‡‘å®‰å…¨ï¼Œè¯·è¾“å…¥çŸ­ä¿¡éªŒè¯ç "
        );
    }
}
```

---

## 5. ğŸ’³ æ¸…ç®—ç»“ç®—æµç¨‹è®¾è®¡


### 5.1 æ¸…ç®—ç»“ç®—åŸºç¡€æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯æ¸…ç®—å’Œç»“ç®—ï¼Ÿ**
```
ç”Ÿæ´»åŒ–ç†è§£ï¼š

æ¸…ç®— = ç®—è´¦
â€¢ ä»Šå¤©å•†å®¶å–äº†å¤šå°‘é’±
â€¢ å¹³å°æ”¶äº†å¤šå°‘æ‰‹ç»­è´¹
â€¢ ç¨è´¹è¦æ‰£å¤šå°‘

ç»“ç®— = æ‰“é’±
â€¢ æŠŠç®—å¥½çš„é’±è½¬ç»™å•†å®¶
â€¢ ä»å•†å®¶è´¦æˆ·æ‰£é™¤è´¹ç”¨
â€¢ æ›´æ–°å„æ–¹è´¦æˆ·ä½™é¢

æ—¶é—´å…³ç³»ï¼š
T+0ï¼šå½“å¤©æ¸…ç®—å½“å¤©ç»“ç®—ï¼ˆå®æ—¶ï¼‰
T+1ï¼šå½“å¤©æ¸…ç®—æ¬¡æ—¥ç»“ç®—ï¼ˆå¸¸è§ï¼‰
T+3ï¼šå½“å¤©æ¸…ç®—ç¬¬3å¤©ç»“ç®—ï¼ˆé“¶è¡Œï¼‰
```

### 5.2 æ¸…ç®—æµç¨‹è®¾è®¡


**ğŸ”„ æ¸…ç®—æ¶ˆæ¯æµç¨‹**
```
æ¸…ç®—å¤„ç†æ¶æ„ï¼š

å®šæ—¶è§¦å‘                æ¸…ç®—é˜Ÿåˆ—                ç»“ç®—é˜Ÿåˆ—
    |                     |                     |
    |--[1]å¯åŠ¨æ¸…ç®—------->|                     |
    |                     |--[2]æ•°æ®è®¡ç®—------->|
    |                     |                     |--[3]èµ„é‡‘åˆ’æ‹¨----->é“¶è¡Œç³»ç»Ÿ
    |<-[4]å®Œæˆé€šçŸ¥--------|<-[5]ç»“ç®—ç»“æœ--------|<-[6]é“¶è¡Œç¡®è®¤-----|
```

**ğŸ’» æ¸…ç®—æœåŠ¡å®ç°**
```java
@Component
public class SettlementService {
    
    // æ¯æ—¥å®šæ—¶æ¸…ç®—
    @Scheduled(cron = "0 0 2 * * ?") // æ¯å¤©å‡Œæ™¨2ç‚¹
    public void triggerDailySettlement() {
        LocalDate settleDate = LocalDate.now().minusDays(1);
        
        // å‘èµ·æ¸…ç®—ä»»åŠ¡
        SettlementTask task = SettlementTask.builder()
            .settleDate(settleDate)
            .type(SettlementType.DAILY)
            .build();
            
        rabbitTemplate.convertAndSend(
            "settlement.calculate.queue", 
            task
        );
    }
}

@RabbitListener(queues = "settlement.calculate.queue")
public class SettlementCalculateService {
    
    public void calculateSettlement(SettlementTask task) {
        // æŒ‰å•†å®¶åˆ†ç»„è®¡ç®—
        List<String> merchantIds = getMerchantIds(task.getSettleDate());
        
        for (String merchantId : merchantIds) {
            // è®¡ç®—å•ä¸ªå•†å®¶çš„æ¸…ç®—æ•°æ®
            MerchantSettlement settlement = calculateMerchantSettlement(
                merchantId, 
                task.getSettleDate()
            );
            
            if (settlement.getSettleAmount().compareTo(BigDecimal.ZERO) > 0) {
                // å‘é€åˆ°ç»“ç®—é˜Ÿåˆ—
                rabbitTemplate.convertAndSend(
                    "settlement.transfer.queue", 
                    settlement
                );
            }
        }
    }
    
    private MerchantSettlement calculateMerchantSettlement(
            String merchantId, LocalDate date) {
        
        // è·å–äº¤æ˜“æ•°æ®
        List<Transaction> transactions = 
            transactionService.getByMerchantAndDate(merchantId, date);
        
        // è®¡ç®—æ€»äº¤æ˜“é‡‘é¢
        BigDecimal totalAmount = transactions.stream()
            .map(Transaction::getAmount)
            .reduce(BigDecimal.ZERO, BigDecimal::add);
        
        // è®¡ç®—æ‰‹ç»­è´¹
        BigDecimal feeRate = getFeeRate(merchantId);
        BigDecimal totalFee = totalAmount.multiply(feeRate);
        
        // è®¡ç®—å®é™…ç»“ç®—é‡‘é¢
        BigDecimal settleAmount = totalAmount.subtract(totalFee);
        
        return MerchantSettlement.builder()
            .merchantId(merchantId)
            .settleDate(date)
            .totalAmount(totalAmount)
            .totalFee(totalFee)
            .settleAmount(settleAmount)
            .transactions(transactions)
            .build();
    }
}
```

### 5.3 ç»“ç®—æ‰§è¡Œ


**ğŸ’° èµ„é‡‘åˆ’æ‹¨å®ç°**
```java
@RabbitListener(queues = "settlement.transfer.queue")
public class SettlementTransferService {
    
    public void executeTransfer(MerchantSettlement settlement) {
        try {
            // åˆ›å»ºç»“ç®—è®°å½•
            SettlementRecord record = createSettlementRecord(settlement);
            
            // è°ƒç”¨é“¶è¡Œè½¬è´¦æ¥å£
            TransferResult result = bankService.transfer(
                PLATFORM_ACCOUNT,           // å¹³å°è´¦æˆ·
                settlement.getMerchantAccount(), // å•†å®¶è´¦æˆ·
                settlement.getSettleAmount(),    // ç»“ç®—é‡‘é¢
                "å•†å®¶ç»“ç®—-" + settlement.getSettleDate()
            );
            
            if (result.isSuccess()) {
                // è½¬è´¦æˆåŠŸï¼Œæ›´æ–°çŠ¶æ€
                record.setStatus(SettlementStatus.SUCCESS);
                record.setBankTransactionId(result.getTransactionId());
                settlementRecordService.update(record);
                
                // é€šçŸ¥å•†å®¶
                notifyMerchant(settlement, result);
                
            } else {
                // è½¬è´¦å¤±è´¥ï¼Œæ ‡è®°å¤±è´¥åŸå› 
                record.setStatus(SettlementStatus.FAILED);
                record.setFailReason(result.getErrorMessage());
                settlementRecordService.update(record);
                
                // å‘é€åˆ°é‡è¯•é˜Ÿåˆ—
                retryTransfer(settlement);
            }
            
        } catch (Exception e) {
            handleTransferError(settlement, e);
        }
    }
    
    private void retryTransfer(MerchantSettlement settlement) {
        // å¢åŠ é‡è¯•æ¬¡æ•°
        settlement.incrementRetryCount();
        
        if (settlement.getRetryCount() < MAX_RETRY_COUNT) {
            // å»¶è¿Ÿé‡è¯•ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
            int delaySeconds = (int) Math.pow(2, settlement.getRetryCount()) * 60;
            
            rabbitTemplate.convertAndSend(
                "settlement.retry.queue",
                settlement,
                message -> {
                    message.getMessageProperties().setDelay(delaySeconds * 1000);
                    return message;
                }
            );
        } else {
            // è¶…è¿‡é‡è¯•æ¬¡æ•°ï¼Œäººå·¥å¤„ç†
            manualReviewService.addSettlementFailure(settlement);
        }
    }
}
```

### 5.4 ç»“ç®—å¯¹è´¦


**ğŸ“‹ ç»“ç®—å¯¹è´¦æµç¨‹**
```java
@RabbitListener(queues = "settlement.reconcile.queue")
public class SettlementReconcileService {
    
    public void reconcileSettlement(SettlementReconcileTask task) {
        LocalDate reconcileDate = task.getReconcileDate();
        
        // è·å–æˆ‘ä»¬çš„ç»“ç®—è®°å½•
        List<SettlementRecord> ourRecords = 
            settlementService.getSuccessRecords(reconcileDate);
        
        // è·å–é“¶è¡Œçš„æµæ°´è®°å½•
        List<BankTransaction> bankTransactions = 
            bankService.getTransactions(reconcileDate);
        
        // æ‰§è¡Œå¯¹è´¦
        SettlementReconcileResult result = performReconcile(
            ourRecords, 
            bankTransactions
        );
        
        // å¤„ç†å¯¹è´¦ç»“æœ
        handleReconcileResult(result);
    }
    
    private SettlementReconcileResult performReconcile(
            List<SettlementRecord> ourRecords,
            List<BankTransaction> bankTransactions) {
        
        SettlementReconcileResult result = new SettlementReconcileResult();
        
        // æŒ‰é‡‘é¢å’Œå•†å®¶è´¦æˆ·åŒ¹é…
        for (SettlementRecord record : ourRecords) {
            BankTransaction matched = bankTransactions.stream()
                .filter(bt -> bt.getAmount().equals(record.getAmount()))
                .filter(bt -> bt.getTargetAccount().equals(record.getMerchantAccount()))
                .findFirst()
                .orElse(null);
                
            if (matched != null) {
                result.addMatched(record, matched);
                bankTransactions.remove(matched);
            } else {
                result.addUnmatched(record);
            }
        }
        
        // å‰©ä½™çš„é“¶è¡Œäº¤æ˜“ä¸ºå¤šä½™è®°å½•
        result.setExtraTransactions(bankTransactions);
        
        return result;
    }
}
```

---

## 6. âš ï¸ å¼‚å¸¸äº¤æ˜“å¤„ç†æ–¹æ¡ˆ


### 6.1 å¼‚å¸¸äº¤æ˜“ç±»å‹


**ğŸš¨ å¸¸è§å¼‚å¸¸æƒ…å†µ**
```
æ”¯ä»˜å¼‚å¸¸åˆ†ç±»ï¼š

1. æŠ€æœ¯å¼‚å¸¸
   â€¢ ç½‘ç»œè¶…æ—¶ â†’ çŠ¶æ€ä¸æ˜
   â€¢ ç³»ç»Ÿæ•…éšœ â†’ å¤„ç†ä¸­æ–­
   â€¢ æ•°æ®åº“å¼‚å¸¸ â†’ è®°å½•ä¸¢å¤±

2. ä¸šåŠ¡å¼‚å¸¸  
   â€¢ ä½™é¢ä¸è¶³ â†’ æ‰£æ¬¾å¤±è´¥
   â€¢ è´¦æˆ·å†»ç»“ â†’ æ— æ³•æ”¯ä»˜
   â€¢ é™é¢è¶…é™ â†’ æ‹’ç»äº¤æ˜“

3. é£æ§å¼‚å¸¸
   â€¢ å¯ç–‘äº¤æ˜“ â†’ äººå·¥å®¡æ ¸
   â€¢ é»‘åå• â†’ ç›´æ¥æ‹’ç»
   â€¢ è®¾å¤‡å¼‚å¸¸ â†’ é¢å¤–éªŒè¯
```

### 6.2 å¼‚å¸¸æ£€æµ‹æœºåˆ¶


**ğŸ” å¼‚å¸¸ç›‘æ§å®ç°**
```java
@Component
public class AbnormalTransactionDetector {
    
    // ç›‘æ§æ”¯ä»˜è¶…æ—¶
    @RabbitListener(queues = "payment.timeout.monitor.queue")
    public void monitorPaymentTimeout(PaymentTimeoutEvent event) {
        // æ£€æŸ¥æ”¯ä»˜æ˜¯å¦è¶…æ—¶
        Payment payment = paymentService.getById(event.getPaymentId());
        
        long elapsedTime = System.currentTimeMillis() - payment.getCreateTime();
        if (elapsedTime > PAYMENT_TIMEOUT_THRESHOLD) {
            
            // åˆ›å»ºè¶…æ—¶å¼‚å¸¸
            AbnormalTransaction abnormal = AbnormalTransaction.builder()
                .paymentId(payment.getId())
                .type(AbnormalType.TIMEOUT)
                .description("æ”¯ä»˜è¶…æ—¶ï¼š" + elapsedTime + "ms")
                .severity(AbnormalSeverity.MEDIUM)
                .build();
            
            // å‘é€åˆ°å¼‚å¸¸å¤„ç†é˜Ÿåˆ—
            rabbitTemplate.convertAndSend(
                "abnormal.transaction.queue", 
                abnormal
            );
        }
    }
    
    // ç›‘æ§è¿ç»­å¤±è´¥
    @EventListener
    public void onPaymentFailed(PaymentFailedEvent event) {
        String userId = event.getUserId();
        
        // æ£€æŸ¥æœ€è¿‘å¤±è´¥æ¬¡æ•°
        int recentFailCount = getRecentFailCount(userId, Duration.ofMinutes(30));
        
        if (recentFailCount >= 5) {
            AbnormalTransaction abnormal = AbnormalTransaction.builder()
                .userId(userId)
                .type(AbnormalType.FREQUENT_FAILURE)
                .description("30åˆ†é’Ÿå†…è¿ç»­å¤±è´¥" + recentFailCount + "æ¬¡")
                .severity(AbnormalSeverity.HIGH)
                .build();
                
            rabbitTemplate.convertAndSend(
                "abnormal.transaction.queue", 
                abnormal
            );
        }
    }
}
```

### 6.3 å¼‚å¸¸å¤„ç†ç­–ç•¥


**ğŸ”§ åˆ†çº§å¤„ç†æœºåˆ¶**
```java
@RabbitListener(queues = "abnormal.transaction.queue")
public class AbnormalTransactionHandler {
    
    public void handleAbnormal(AbnormalTransaction abnormal) {
        switch (abnormal.getSeverity()) {
            case LOW:
                handleLowSeverity(abnormal);
                break;
            case MEDIUM:
                handleMediumSeverity(abnormal);
                break;
            case HIGH:
                handleHighSeverity(abnormal);
                break;
            case CRITICAL:
                handleCriticalSeverity(abnormal);
                break;
        }
    }
    
    private void handleLowSeverity(AbnormalTransaction abnormal) {
        // ä½ç­‰çº§ï¼šä»…è®°å½•æ—¥å¿—
        logService.logAbnormal(abnormal);
    }
    
    private void handleMediumSeverity(AbnormalTransaction abnormal) {
        // ä¸­ç­‰çº§ï¼šè®°å½• + ç›‘æ§å‘Šè­¦
        logService.logAbnormal(abnormal);
        alertService.sendAlert(
            "æ£€æµ‹åˆ°ä¸­ç­‰å¼‚å¸¸ï¼š" + abnormal.getDescription()
        );
        
        // å¦‚æœæ˜¯è¶…æ—¶ï¼ŒæŸ¥è¯¢çœŸå®çŠ¶æ€
        if (abnormal.getType() == AbnormalType.TIMEOUT) {
            queryRealPaymentStatus(abnormal.getPaymentId());
        }
    }
    
    private void handleHighSeverity(AbnormalTransaction abnormal) {
        // é«˜ç­‰çº§ï¼šå‘Šè­¦ + è‡ªåŠ¨å¤„ç†
        alertService.sendUrgentAlert(abnormal);
        
        if (abnormal.getType() == AbnormalType.FREQUENT_FAILURE) {
            // ä¸´æ—¶é™åˆ¶ç”¨æˆ·æ”¯ä»˜
            userService.temporaryLimitPayment(
                abnormal.getUserId(), 
                Duration.ofHours(1)
            );
        }
    }
    
    private void handleCriticalSeverity(AbnormalTransaction abnormal) {
        // ä¸¥é‡çº§ï¼šç«‹å³å‘Šè­¦ + äººå·¥ä»‹å…¥
        alertService.sendCriticalAlert(abnormal);
        manualReviewService.requireImmediateReview(abnormal);
        
        // å¯èƒ½éœ€è¦ç´§æ€¥æªæ–½
        if (abnormal.getType() == AbnormalType.SUSPECTED_FRAUD) {
            securityService.freezeAccount(abnormal.getUserId());
        }
    }
}
```

### 6.4 è¡¥å¿å’Œæ¢å¤æœºåˆ¶


**ğŸ”„ çŠ¶æ€æŸ¥è¯¢å’Œè¡¥å¿**
```java
@Component
public class PaymentCompensationService {
    
    // æŸ¥è¯¢é“¶è¡ŒçœŸå®æ”¯ä»˜çŠ¶æ€
    private void queryRealPaymentStatus(String paymentId) {
        CompensationTask task = CompensationTask.builder()
            .paymentId(paymentId)
            .type(CompensationType.STATUS_QUERY)
            .build();
            
        rabbitTemplate.convertAndSend(
            "payment.compensation.queue", 
            task
        );
    }
    
    @RabbitListener(queues = "payment.compensation.queue")
    public void executeCompensation(CompensationTask task) {
        Payment payment = paymentService.getById(task.getPaymentId());
        
        try {
            // æŸ¥è¯¢é“¶è¡ŒçœŸå®çŠ¶æ€
            PaymentStatusResult result = bankService.queryPaymentStatus(
                payment.getBankTransactionId()
            );
            
            if (result.getStatus() != payment.getStatus()) {
                // çŠ¶æ€ä¸ä¸€è‡´ï¼Œéœ€è¦è¡¥å¿
                compensatePaymentStatus(payment, result.getStatus());
            }
            
        } catch (Exception e) {
            // æŸ¥è¯¢å¤±è´¥ï¼Œç¨åé‡è¯•
            scheduleRetryCompensation(task);
        }
    }
    
    private void compensatePaymentStatus(Payment payment, PaymentStatus realStatus) {
        // æ›´æ–°æ”¯ä»˜çŠ¶æ€
        payment.setStatus(realStatus);
        payment.setCompensated(true);
        paymentService.update(payment);
        
        // å‘é€çŠ¶æ€åŒæ­¥æ¶ˆæ¯
        PaymentStatusEvent event = PaymentStatusEvent.builder()
            .paymentId(payment.getId())
            .orderId(payment.getOrderId())
            .userId(payment.getUserId())
            .newStatus(realStatus)
            .compensated(true)
            .build();
            
        rabbitTemplate.convertAndSend(
            "payment.status.sync.queue", 
            event
        );
        
        // è®°å½•è¡¥å¿æ—¥å¿—
        compensationLogService.log(payment, realStatus, "çŠ¶æ€è¡¥å¿");
    }
}
```

**ğŸ’° èµ„é‡‘è¡¥å¿å¤„ç†**
```java
@Component
public class FundsCompensationService {
    
    // å¤„ç†é‡å¤æ‰£æ¬¾è¡¥å¿
    public void compensateDuplicatePayment(String paymentId) {
        Payment payment = paymentService.getById(paymentId);
        
        // åˆ›å»ºé€€æ¬¾è¡¥å¿
        RefundCompensation compensation = RefundCompensation.builder()
            .originalPaymentId(paymentId)
            .refundAmount(payment.getAmount())
            .reason("é‡å¤æ‰£æ¬¾è¡¥å¿")
            .build();
            
        rabbitTemplate.convertAndSend(
            "refund.compensation.queue", 
            compensation
        );
    }
    
    @RabbitListener(queues = "refund.compensation.queue")
    public void executeRefundCompensation(RefundCompensation compensation) {
        try {
            // è°ƒç”¨é“¶è¡Œé€€æ¬¾æ¥å£
            RefundResult result = bankService.refund(
                compensation.getOriginalPaymentId(),
                compensation.getRefundAmount(),
                compensation.getReason()
            );
            
            if (result.isSuccess()) {
                // é€€æ¬¾æˆåŠŸï¼Œæ›´æ–°çŠ¶æ€
                compensationService.markSuccess(compensation, result);
                
                // é€šçŸ¥ç”¨æˆ·
                notificationService.notifyRefundSuccess(compensation);
                
            } else {
                // é€€æ¬¾å¤±è´¥ï¼Œè®°å½•å¹¶é‡è¯•
                compensationService.markFailed(compensation, result.getErrorMessage());
                scheduleRetryRefund(compensation);
            }
            
        } catch (Exception e) {
            handleRefundError(compensation, e);
        }
    }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 æ”¯ä»˜ç³»ç»Ÿé›†æˆæ ¸å¿ƒè¦ç‚¹


**ğŸ¯ å…³é”®æ¦‚å¿µç†è§£**
```
æ”¯ä»˜ç³»ç»Ÿ = èµ„é‡‘æµè½¬çš„ä¸­ä»‹
æ¶ˆæ¯é˜Ÿåˆ— = å¼‚æ­¥å¤„ç†çš„åˆ©å™¨
çŠ¶æ€åŒæ­¥ = å¤šç³»ç»Ÿåè°ƒçš„åŸºç¡€
å¯¹è´¦å¤„ç† = èµ„é‡‘å®‰å…¨çš„ä¿éšœ
é£æ§ç³»ç»Ÿ = é£é™©é˜²èŒƒçš„å±éšœ
æ¸…ç®—ç»“ç®— = èµ„é‡‘åˆ†é…çš„æ‰§è¡Œ
å¼‚å¸¸å¤„ç† = ç³»ç»Ÿç¨³å®šçš„å®ˆæŠ¤
```

### 7.2 æ ¸å¿ƒä¸šåŠ¡æµç¨‹


**ğŸ”„ ç«¯åˆ°ç«¯æµç¨‹å›é¡¾**
```
æ”¯ä»˜å®Œæ•´é“¾è·¯ï¼š

ç”¨æˆ·å‘èµ·æ”¯ä»˜
    â†“
é£æ§æ£€æŸ¥ â†’ é€šè¿‡/æ‹’ç»/äººå·¥å®¡æ ¸
    â†“
é“¶è¡Œæ‰£æ¬¾ â†’ æˆåŠŸ/å¤±è´¥/è¶…æ—¶
    â†“
çŠ¶æ€åŒæ­¥ â†’ ç”¨æˆ·/å•†å®¶/è´¢åŠ¡ç³»ç»Ÿ
    â†“
T+1å¯¹è´¦ â†’ å‘ç°å·®å¼‚åŠæ—¶å¤„ç†
    â†“
å®šæœŸæ¸…ç®— â†’ å•†å®¶èµ„é‡‘ç»“ç®—
    â†“
å¼‚å¸¸ç›‘æ§ â†’ æŒç»­æ£€æµ‹å’Œè¡¥å¿
```

### 7.3 æŠ€æœ¯æ¶æ„è¦ç‚¹


**ğŸ—ï¸ æ¶ˆæ¯é˜Ÿåˆ—è®¾è®¡åŸåˆ™**
```
äº¤æ¢æœºè®¾è®¡ï¼š
â€¢ Topic Exchangeï¼šçµæ´»è·¯ç”±
â€¢ æŒä¹…åŒ–ï¼šä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±
â€¢ æ­»ä¿¡é˜Ÿåˆ—ï¼šå¤„ç†å¼‚å¸¸æ¶ˆæ¯

é˜Ÿåˆ—è®¾è®¡ï¼š
â€¢ ä¸šåŠ¡éš”ç¦»ï¼šä¸åŒä¸šåŠ¡ç‹¬ç«‹é˜Ÿåˆ—
â€¢ ä¼˜å…ˆçº§ï¼šé‡è¦ä¸šåŠ¡ä¼˜å…ˆå¤„ç†
â€¢ ç›‘æ§å‘Šè­¦ï¼šåŠæ—¶å‘ç°é—®é¢˜

æ¶ˆæ¯è®¾è®¡ï¼š
â€¢ å¹‚ç­‰æ€§ï¼šé‡å¤æ¶ˆè´¹æ— å‰¯ä½œç”¨
â€¢ å¯è¿½æº¯ï¼šå®Œæ•´çš„å¤„ç†é“¾è·¯
â€¢ å®¹é”™æ€§ï¼šå¼‚å¸¸æ—¶ä¼˜é›…é™çº§
```

### 7.4 æœ€ä½³å®è·µæ€»ç»“


**âœ… æ ¸å¿ƒæœ€ä½³å®è·µ**

1. **å¯é æ€§ä¿éšœ**
   - æ¶ˆæ¯æŒä¹…åŒ– + æ‰‹åŠ¨ACK
   - é‡è¯•æœºåˆ¶ + æ­»ä¿¡å¤„ç†
   - çŠ¶æ€æŸ¥è¯¢ + è¡¥å¿æœºåˆ¶

2. **æ€§èƒ½ä¼˜åŒ–**
   - æ‰¹é‡å¤„ç†å‡å°‘ç½‘ç»œå¼€é”€
   - å¼‚æ­¥å¤„ç†æå‡ç”¨æˆ·ä½“éªŒ
   - åˆç†çš„é˜Ÿåˆ—åˆ†åŒºç­–ç•¥

3. **ç›‘æ§è¿ç»´**
   - å®æ—¶ç›‘æ§å…³é”®æŒ‡æ ‡
   - å®Œå–„çš„æ—¥å¿—è®°å½•
   - è‡ªåŠ¨åŒ–çš„å¼‚å¸¸å¤„ç†

4. **å®‰å…¨é˜²æŠ¤**
   - å¤šå±‚æ¬¡é£æ§è§„åˆ™
   - æ•æ„Ÿä¿¡æ¯åŠ å¯†ä¼ è¾“
   - è®¿é—®æƒé™ä¸¥æ ¼æ§åˆ¶

### 7.5 å­¦ä¹ æ£€æŸ¥æ¸…å•


**ğŸ“ æŒæ¡ç¨‹åº¦è‡ªæ£€**
- [ ] ç†è§£æ”¯ä»˜ç³»ç»Ÿä¸ºä»€ä¹ˆéœ€è¦æ¶ˆæ¯é˜Ÿåˆ—
- [ ] æŒæ¡æ”¯ä»˜çŠ¶æ€åŒæ­¥çš„å®ç°æ–¹å¼
- [ ] äº†è§£å¯¹è´¦æ–‡ä»¶çš„å¤„ç†æµç¨‹
- [ ] ç†è§£é£æ§è§„åˆ™å¼•æ“çš„å·¥ä½œåŸç†
- [ ] æŒæ¡æ¸…ç®—ç»“ç®—çš„ä¸šåŠ¡æµç¨‹
- [ ] äº†è§£å¼‚å¸¸äº¤æ˜“çš„æ£€æµ‹å’Œå¤„ç†
- [ ] èƒ½å¤Ÿè®¾è®¡å¯é çš„æ¶ˆæ¯ä¼ é€’æ–¹æ¡ˆ

**ğŸ’¡ è®°å¿†è¦ç‚¹**
> æ”¯ä»˜ç³»ç»Ÿé›†æˆçš„æ ¸å¿ƒï¼š**å¯é ã€åŠæ—¶ã€å®‰å…¨**
> - å¯é ï¼šæ¶ˆæ¯ä¸ä¸¢å¤±ï¼ŒçŠ¶æ€å¿…åŒæ­¥
> - åŠæ—¶ï¼šå¼‚æ­¥å¤„ç†ï¼Œå¿«é€Ÿå“åº”
> - å®‰å…¨ï¼šé£æ§ä¿æŠ¤ï¼Œå¼‚å¸¸ç›‘æ§

**ğŸš€ è¿›é˜¶å­¦ä¹ æ–¹å‘**
- åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†
- å¾®æœåŠ¡æ¶æ„ä¸‹çš„æ”¯ä»˜ç³»ç»Ÿ
- åŒºå—é“¾æ”¯ä»˜æŠ€æœ¯
- è·¨å¢ƒæ”¯ä»˜è§£å†³æ–¹æ¡ˆ