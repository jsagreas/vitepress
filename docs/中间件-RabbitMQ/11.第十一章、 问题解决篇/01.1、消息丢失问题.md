---
title: 1ã€æ¶ˆæ¯ä¸¢å¤±é—®é¢˜
---
## ğŸ“š ç›®å½•

1. [æ¶ˆæ¯ä¸¢å¤±é—®é¢˜å…¨é¢åˆ†æ](#1-æ¶ˆæ¯ä¸¢å¤±é—®é¢˜å…¨é¢åˆ†æ)
2. [ä¸¢å¤±åœºæ™¯æ·±åº¦å‰–æ](#2-ä¸¢å¤±åœºæ™¯æ·±åº¦å‰–æ)
3. [ç¡®è®¤æœºåˆ¶æ£€æŸ¥ä¸é…ç½®](#3-ç¡®è®¤æœºåˆ¶æ£€æŸ¥ä¸é…ç½®)
4. [æŒä¹…åŒ–éªŒè¯ä¸æœ€ä½³å®è·µ](#4-æŒä¹…åŒ–éªŒè¯ä¸æœ€ä½³å®è·µ)
5. [ç½‘ç»œé—®é¢˜æ’æŸ¥æŠ€å·§](#5-ç½‘ç»œé—®é¢˜æ’æŸ¥æŠ€å·§)
6. [ç›‘æ§å‘Šè­¦ä½“ç³»å»ºè®¾](#6-ç›‘æ§å‘Šè­¦ä½“ç³»å»ºè®¾)
7. [ç»¼åˆè§£å†³æ–¹æ¡ˆ](#7-ç»¼åˆè§£å†³æ–¹æ¡ˆ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” æ¶ˆæ¯ä¸¢å¤±é—®é¢˜å…¨é¢åˆ†æ


### 1.1 ä»€ä¹ˆæ˜¯æ¶ˆæ¯ä¸¢å¤±


**ğŸ¯ ç®€å•ç†è§£**ï¼šå°±åƒå¯„å¿«é€’ä¸€æ ·ï¼Œä½ æŠŠåŒ…è£¹äº¤ç»™å¿«é€’å‘˜ï¼Œä½†åŒ…è£¹åœ¨è·¯ä¸Šæˆ–è€…ç›®çš„åœ°ä¸¢äº†ï¼Œæ”¶ä»¶äººæ²¡æ”¶åˆ°ã€‚

```
ç°å®ç”Ÿæ´»ç±»æ¯”ï¼š
å¯„å¿«é€’æµç¨‹         RabbitMQæ¶ˆæ¯æµç¨‹
å‘ä»¶äºº â†’ å¿«é€’å‘˜    ç”Ÿäº§è€… â†’ RabbitMQ
å¿«é€’å‘˜ â†’ ä¸­è½¬ç«™    RabbitMQ â†’ é˜Ÿåˆ—å­˜å‚¨  
ä¸­è½¬ç«™ â†’ æ´¾é€å‘˜    é˜Ÿåˆ— â†’ æ¶ˆè´¹è€…
æ´¾é€å‘˜ â†’ æ”¶ä»¶äºº    æ¶ˆè´¹è€… â†’ ä¸šåŠ¡å¤„ç†

ä¸¢å¤±å¯èƒ½å‘ç”Ÿåœ¨ä»»ä½•ä¸€ä¸ªç¯èŠ‚ï¼
```

### 1.2 æ¶ˆæ¯ä¸¢å¤±çš„å½±å“


**ğŸ’¥ ä¸šåŠ¡å½±å“ç¤ºä¾‹**ï¼š
- **è®¢å•ç³»ç»Ÿ**ï¼šç”¨æˆ·ä¸‹å•åï¼Œè®¢å•æ¶ˆæ¯ä¸¢å¤± â†’ å•†å“æ‰£åº“å­˜ä½†è®¢å•æ²¡åˆ›å»º
- **æ”¯ä»˜ç³»ç»Ÿ**ï¼šæ”¯ä»˜æˆåŠŸæ¶ˆæ¯ä¸¢å¤± â†’ é’±æ‰£äº†ä½†è®¢å•çŠ¶æ€æ²¡æ›´æ–°  
- **é€šçŸ¥ç³»ç»Ÿ**ï¼šçŸ­ä¿¡/é‚®ä»¶æ¶ˆæ¯ä¸¢å¤± â†’ ç”¨æˆ·æ”¶ä¸åˆ°é‡è¦é€šçŸ¥

> âš ï¸ **å…³é”®è®¤çŸ¥**  
> æ¶ˆæ¯ä¸¢å¤±ä¸æ˜¯ç®€å•çš„"é‡å‘ä¸€æ¬¡"å°±èƒ½è§£å†³ï¼Œéœ€è¦ä»æ¶æ„è®¾è®¡å±‚é¢ä¿è¯å¯é æ€§

### 1.3 RabbitMQæ¶ˆæ¯æµè½¬å…¨è·¯å¾„


```
å®Œæ•´çš„æ¶ˆæ¯ç”Ÿå‘½å‘¨æœŸï¼š

[ç”Ÿäº§è€…] --â‘ å‘é€--> [Exchange] --â‘¡è·¯ç”±--> [Queue] --â‘¢æŠ•é€’--> [æ¶ˆè´¹è€…]
    â†“              â†“            â†“            â†“
 ç¡®è®¤æœºåˆ¶        è·¯ç”±ç¡®è®¤      æŒä¹…åŒ–å­˜å‚¨    æ¶ˆè´¹ç¡®è®¤
```

**ğŸ”¸ æ¯ä¸ªç¯èŠ‚çš„ä½œç”¨**ï¼š
- **â‘ å‘é€é˜¶æ®µ**ï¼šç”Ÿäº§è€…æŠŠæ¶ˆæ¯å‘ç»™RabbitMQçš„äº¤æ¢æœº
- **â‘¡è·¯ç”±é˜¶æ®µ**ï¼šäº¤æ¢æœºæ ¹æ®è·¯ç”±è§„åˆ™æŠŠæ¶ˆæ¯å‘åˆ°å¯¹åº”é˜Ÿåˆ—
- **â‘¢æŠ•é€’é˜¶æ®µ**ï¼šé˜Ÿåˆ—æŠŠæ¶ˆæ¯æŠ•é€’ç»™æ¶ˆè´¹è€…
- **â‘£å¤„ç†é˜¶æ®µ**ï¼šæ¶ˆè´¹è€…å¤„ç†æ¶ˆæ¯å¹¶ç¡®è®¤

---

## 2. ğŸ“‹ ä¸¢å¤±åœºæ™¯æ·±åº¦å‰–æ


### 2.1 ç”Ÿäº§è€…ç«¯æ¶ˆæ¯ä¸¢å¤±


**ğŸ”¸ é—®é¢˜åœºæ™¯**ï¼šç”Ÿäº§è€…ä»¥ä¸ºæ¶ˆæ¯å‘é€æˆåŠŸäº†ï¼Œå®é™…ä¸ŠRabbitMQæ²¡æ”¶åˆ°

```java
// âŒ é”™è¯¯åšæ³•ï¼šfire-and-forgetï¼ˆå‘äº†å°±å¿˜ï¼‰
public void sendOrderMessage(Order order) {
    // åªç®¡å‘é€ï¼Œä¸ç®¡æ˜¯å¦æˆåŠŸ
    rabbitTemplate.convertAndSend("order.exchange", "order.create", order);
    System.out.println("è®¢å•æ¶ˆæ¯å·²å‘é€"); // å…¶å®å¯èƒ½å¤±è´¥äº†ï¼
}
```

**ğŸ’¡ ä¸ºä»€ä¹ˆä¼šä¸¢å¤±**ï¼š
- **ç½‘ç»œå¼‚å¸¸**ï¼šç½‘ç»œæ–­å¼€ã€è¶…æ—¶ã€ä¸¢åŒ…
- **RabbitMQå¼‚å¸¸**ï¼šæœåŠ¡é‡å¯ã€å†…å­˜ä¸è¶³ã€ç£ç›˜æ»¡äº†
- **æƒé™é—®é¢˜**ï¼šç”¨æˆ·æ²¡æœ‰å‘é€æƒé™
- **å‚æ•°é”™è¯¯**ï¼šäº¤æ¢æœºä¸å­˜åœ¨ã€è·¯ç”±keyé”™è¯¯

### 2.2 RabbitMQæœåŠ¡ç«¯æ¶ˆæ¯ä¸¢å¤±


**ğŸ”¸ é—®é¢˜åœºæ™¯**ï¼šRabbitMQæ”¶åˆ°äº†æ¶ˆæ¯ï¼Œä½†è¿˜æ²¡æ¥å¾—åŠæŒä¹…åŒ–å°±å®•æœºäº†

```
æ—¶é—´çº¿æ¼”ç¤ºï¼š
10:00:01 - ç”Ÿäº§è€…å‘é€æ¶ˆæ¯"è®¢å•123"
10:00:02 - RabbitMQæ”¶åˆ°æ¶ˆæ¯ï¼Œå­˜åœ¨å†…å­˜ä¸­
10:00:03 - ğŸ’¥ æœåŠ¡å™¨çªç„¶æ–­ç”µ
10:00:04 - æ¶ˆæ¯æ°¸è¿œä¸¢å¤±ï¼ˆå› ä¸ºåªåœ¨å†…å­˜ï¼Œæ²¡å†™ç¡¬ç›˜ï¼‰
```

**ğŸ’¡ ä¸ºä»€ä¹ˆä¼šä¸¢å¤±**ï¼š
- **å†…å­˜å­˜å‚¨**ï¼šæ¶ˆæ¯åªåœ¨å†…å­˜ä¸­ï¼Œæ²¡æœ‰æŒä¹…åŒ–åˆ°ç£ç›˜
- **æœåŠ¡é‡å¯**ï¼šRabbitMQé‡å¯æ—¶æ¸…ç©ºå†…å­˜
- **ç¡¬ä»¶æ•…éšœ**ï¼šæœåŠ¡å™¨å®•æœºã€ç£ç›˜æŸå

### 2.3 æ¶ˆè´¹è€…ç«¯æ¶ˆæ¯ä¸¢å¤±


**ğŸ”¸ é—®é¢˜åœºæ™¯**ï¼šæ¶ˆè´¹è€…æ”¶åˆ°æ¶ˆæ¯ä½†å¤„ç†å¤±è´¥ï¼Œæ¶ˆæ¯å´è¢«æ ‡è®°ä¸º"å·²å¤„ç†"

```java
// âŒ é”™è¯¯åšæ³•ï¼šè‡ªåŠ¨ç¡®è®¤æ¨¡å¼
@RabbitListener(queues = "order.queue")
public void handleOrder(Order order) {
    try {
        // å¤„ç†è®¢å•é€»è¾‘
        orderService.createOrder(order);
    } catch (Exception e) {
        // ğŸ’¥ å¤„ç†å¤±è´¥äº†ï¼Œä½†æ¶ˆæ¯å·²ç»è¢«è‡ªåŠ¨ç¡®è®¤åˆ é™¤ï¼
        log.error("è®¢å•å¤„ç†å¤±è´¥", e);
        // æ¶ˆæ¯ä¸¢å¤±ï¼Œæ— æ³•é‡è¯•
    }
}
```

**ğŸ’¡ ä¸ºä»€ä¹ˆä¼šä¸¢å¤±**ï¼š
- **è‡ªåŠ¨ç¡®è®¤**ï¼šæ¶ˆæ¯ä¸€è¢«æ¥æ”¶å°±ç¡®è®¤ï¼Œä¸ç®¡æ˜¯å¦å¤„ç†æˆåŠŸ
- **å¼‚å¸¸å¤„ç†ä¸å½“**ï¼šå¤„ç†å¼‚å¸¸æ—¶æ²¡æœ‰æ‹’ç»æ¶ˆæ¯
- **æ¶ˆè´¹è€…å®•æœº**ï¼šå¤„ç†è¿‡ç¨‹ä¸­æ¶ˆè´¹è€…å´©æºƒ

### 2.4 ç½‘ç»œå±‚æ¶ˆæ¯ä¸¢å¤±


**ğŸ”¸ é—®é¢˜åœºæ™¯**ï¼šæ¶ˆæ¯åœ¨ç½‘ç»œä¼ è¾“è¿‡ç¨‹ä¸­ä¸¢å¤±

```
ç½‘ç»œé—®é¢˜ç¤ºä¾‹ï¼š
ç”Ÿäº§è€… --[ç½‘ç»œ]-- RabbitMQ --[ç½‘ç»œ]-- æ¶ˆè´¹è€…
         â†‘ä¸¢åŒ…              â†‘è¿æ¥æ–­å¼€
```

**ğŸ’¡ å¸¸è§ç½‘ç»œé—®é¢˜**ï¼š
- **ç½‘ç»œåˆ†åŒº**ï¼šç”Ÿäº§è€…å’ŒRabbitMQä¹‹é—´ç½‘ç»œä¸­æ–­
- **è¿æ¥è¶…æ—¶**ï¼šç½‘ç»œå»¶è¿Ÿå¯¼è‡´è¿æ¥è¶…æ—¶
- **è´Ÿè½½å‡è¡¡é—®é¢˜**ï¼šLBé…ç½®ä¸å½“å¯¼è‡´è¿æ¥å¼‚å¸¸

---

## 3. âœ… ç¡®è®¤æœºåˆ¶æ£€æŸ¥ä¸é…ç½®


### 3.1 ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶ï¼ˆPublisher Confirmsï¼‰


**ğŸ¯ æ ¸å¿ƒåŸç†**ï¼šç”Ÿäº§è€…å‘é€æ¶ˆæ¯åï¼Œç­‰å¾…RabbitMQçš„ç¡®è®¤å›å¤

```java
@Configuration
public class RabbitConfig {
    
    @Bean
    public RabbitTemplate rabbitTemplate(ConnectionFactory connectionFactory) {
        RabbitTemplate template = new RabbitTemplate(connectionFactory);
        
        // å¼€å¯å‘é€ç¡®è®¤
        template.setConfirmCallback((correlationData, ack, cause) -> {
            if (ack) {
                log.info("æ¶ˆæ¯å‘é€æˆåŠŸï¼š{}", correlationData.getId());
            } else {
                log.error("æ¶ˆæ¯å‘é€å¤±è´¥ï¼š{}ï¼ŒåŸå› ï¼š{}", correlationData.getId(), cause);
                // è¿™é‡Œå¯ä»¥å®ç°é‡å‘é€»è¾‘
            }
        });
        
        return template;
    }
}
```

**ğŸ”§ å®é™…ä½¿ç”¨ç¤ºä¾‹**ï¼š

```java
@Service
public class OrderMessageSender {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    public void sendOrderMessage(Order order) {
        // åˆ›å»ºå…³è”æ•°æ®ï¼Œç”¨äºè¿½è¸ªæ¶ˆæ¯
        CorrelationData correlationData = new CorrelationData(order.getId());
        
        try {
            rabbitTemplate.convertAndSend(
                "order.exchange", 
                "order.create", 
                order, 
                correlationData
            );
            log.info("è®¢å•æ¶ˆæ¯å·²å‘é€ï¼Œç­‰å¾…ç¡®è®¤ï¼š{}", order.getId());
        } catch (Exception e) {
            log.error("å‘é€è®¢å•æ¶ˆæ¯å¼‚å¸¸ï¼š{}", order.getId(), e);
        }
    }
}
```

### 3.2 äº¤æ¢æœºç¡®è®¤æœºåˆ¶ï¼ˆPublisher Returnsï¼‰


**ğŸ¯ æ ¸å¿ƒåŸç†**ï¼šå½“æ¶ˆæ¯æ— æ³•è·¯ç”±åˆ°é˜Ÿåˆ—æ—¶ï¼ŒRabbitMQä¼šè¿”å›æ¶ˆæ¯ç»™ç”Ÿäº§è€…

```java
@Bean
public RabbitTemplate rabbitTemplate(ConnectionFactory connectionFactory) {
    RabbitTemplate template = new RabbitTemplate(connectionFactory);
    
    // å¼€å¯è¿”å›ç¡®è®¤
    template.setMandatory(true);
    template.setReturnsCallback((returned) -> {
        log.error("æ¶ˆæ¯è·¯ç”±å¤±è´¥ - äº¤æ¢æœºï¼š{}ï¼Œè·¯ç”±keyï¼š{}ï¼Œæ¶ˆæ¯ï¼š{}", 
            returned.getExchange(),
            returned.getRoutingKey(), 
            returned.getMessage()
        );
        // è¿™é‡Œå¯ä»¥å®ç°æ¶ˆæ¯é‡è·¯ç”±æˆ–å‘Šè­¦
    });
    
    return template;
}
```

### 3.3 æ¶ˆè´¹è€…ç¡®è®¤æœºåˆ¶ï¼ˆConsumer Acknowledgmentsï¼‰


**ğŸ¯ æ ¸å¿ƒåŸç†**ï¼šæ¶ˆè´¹è€…å¤„ç†å®Œæ¶ˆæ¯åï¼Œä¸»åŠ¨å‘Šè¯‰RabbitMQ"æˆ‘å¤„ç†å®Œäº†"

```yaml
# application.yml é…ç½®
spring:
  rabbitmq:
    listener:
      simple:
        acknowledge-mode: manual  # æ‰‹åŠ¨ç¡®è®¤æ¨¡å¼
```

```java
@Component
public class OrderConsumer {
    
    @RabbitListener(queues = "order.queue")
    public void handleOrder(Order order, Channel channel, @Header(AmqpHeaders.DELIVERY_TAG) long deliveryTag) {
        try {
            // å¤„ç†è®¢å•ä¸šåŠ¡é€»è¾‘
            orderService.createOrder(order);
            
            // âœ… å¤„ç†æˆåŠŸï¼Œæ‰‹åŠ¨ç¡®è®¤
            channel.basicAck(deliveryTag, false);
            log.info("è®¢å•å¤„ç†æˆåŠŸï¼š{}", order.getId());
            
        } catch (BusinessException e) {
            // ä¸šåŠ¡å¼‚å¸¸ï¼Œæ‹’ç»æ¶ˆæ¯ä¸”ä¸é‡æ–°å…¥é˜Ÿ
            channel.basicReject(deliveryTag, false);
            log.error("è®¢å•ä¸šåŠ¡å¤„ç†å¤±è´¥ï¼š{}", order.getId(), e);
            
        } catch (Exception e) {
            // ç³»ç»Ÿå¼‚å¸¸ï¼Œæ‹’ç»æ¶ˆæ¯å¹¶é‡æ–°å…¥é˜Ÿ
            channel.basicReject(deliveryTag, true);
            log.error("è®¢å•ç³»ç»Ÿå¤„ç†å¼‚å¸¸ï¼š{}", order.getId(), e);
        }
    }
}
```

### 3.4 ç¡®è®¤æœºåˆ¶å¯¹æ¯”è¡¨


| ç¡®è®¤ç±»å‹ | **ä½œç”¨èŒƒå›´** | **ç¡®è®¤å†…å®¹** | **å¤±è´¥å¤„ç†** | **æ€§èƒ½å½±å“** |
|---------|-------------|-------------|-------------|-------------|
| ğŸ”¸ **Publisher Confirms** | `ç”Ÿäº§è€…â†’RabbitMQ` | `æ¶ˆæ¯æ˜¯å¦åˆ°è¾¾RabbitMQ` | `é‡å‘æˆ–å‘Šè­¦` | `ä¸­ç­‰` |
| ğŸ”¸ **Publisher Returns** | `äº¤æ¢æœºâ†’é˜Ÿåˆ—` | `æ¶ˆæ¯æ˜¯å¦è·¯ç”±åˆ°é˜Ÿåˆ—` | `é‡è·¯ç”±æˆ–å‘Šè­¦` | `è¾ƒå°` |
| ğŸ”¸ **Consumer Acks** | `é˜Ÿåˆ—â†’æ¶ˆè´¹è€…` | `æ¶ˆæ¯æ˜¯å¦å¤„ç†æˆåŠŸ` | `é‡è¯•æˆ–ä¸¢å¼ƒ` | `è¾ƒå¤§` |

---

## 4. ğŸ’¾ æŒä¹…åŒ–éªŒè¯ä¸æœ€ä½³å®è·µ


### 4.1 ä»€ä¹ˆæ˜¯æŒä¹…åŒ–


**ğŸ¯ ç®€å•ç†è§£**ï¼šæŠŠé‡è¦çš„ä¸œè¥¿å†™åˆ°ç¡¬ç›˜ä¸Šï¼Œè¿™æ ·å³ä½¿åœç”µé‡å¯ä¹Ÿä¸ä¼šä¸¢å¤±

```
å†…å­˜ vs ç¡¬ç›˜å­˜å‚¨ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    å†…å­˜      â”‚    â”‚    ç¡¬ç›˜      â”‚
â”‚ é€Ÿåº¦ï¼šå¾ˆå¿«   â”‚    â”‚ é€Ÿåº¦ï¼šè¾ƒæ…¢   â”‚
â”‚ æ–­ç”µï¼šä¸¢å¤±   â”‚    â”‚ æ–­ç”µï¼šä¿ç•™   â”‚
â”‚ å®¹é‡ï¼šè¾ƒå°   â”‚    â”‚ å®¹é‡ï¼šå¾ˆå¤§   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 ä¸‰å±‚æŒä¹…åŒ–é…ç½®


**ğŸ”¸ ç¬¬ä¸€å±‚ï¼šäº¤æ¢æœºæŒä¹…åŒ–**

```java
@Bean
public TopicExchange orderExchange() {
    return ExchangeBuilder
        .topicExchange("order.exchange")
        .durable(true)  // ğŸ”¥ æŒä¹…åŒ–äº¤æ¢æœº
        .build();
}
```

**ğŸ”¸ ç¬¬äºŒå±‚ï¼šé˜Ÿåˆ—æŒä¹…åŒ–**

```java
@Bean  
public Queue orderQueue() {
    return QueueBuilder
        .durable("order.queue")  // ğŸ”¥ æŒä¹…åŒ–é˜Ÿåˆ—
        .build();
}
```

**ğŸ”¸ ç¬¬ä¸‰å±‚ï¼šæ¶ˆæ¯æŒä¹…åŒ–**

```java
public void sendPersistentMessage(Order order) {
    rabbitTemplate.convertAndSend(
        "order.exchange",
        "order.create", 
        order,
        message -> {
            // ğŸ”¥ è®¾ç½®æ¶ˆæ¯æŒä¹…åŒ–
            message.getMessageProperties().setDeliveryMode(MessageDeliveryMode.PERSISTENT);
            return message;
        }
    );
}
```

### 4.3 æŒä¹…åŒ–éªŒè¯æ–¹æ³•


**ğŸ“‹ éªŒè¯æ­¥éª¤**ï¼š

1. **å‘é€æŒä¹…åŒ–æ¶ˆæ¯**
2. **åœæ­¢RabbitMQæœåŠ¡**
3. **é‡å¯RabbitMQæœåŠ¡** 
4. **æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦è¿˜åœ¨**

```bash
# 1. å‘é€æ¶ˆæ¯åï¼ŒæŸ¥çœ‹é˜Ÿåˆ—çŠ¶æ€
rabbitmqctl list_queues name messages

# 2. åœæ­¢RabbitMQ
sudo systemctl stop rabbitmq-server

# 3. å¯åŠ¨RabbitMQ  
sudo systemctl start rabbitmq-server

# 4. å†æ¬¡æŸ¥çœ‹é˜Ÿåˆ—çŠ¶æ€
rabbitmqctl list_queues name messages
```

### 4.4 æŒä¹…åŒ–æ€§èƒ½ä¼˜åŒ–


**âš¡ æ‰¹é‡åˆ·ç›˜é…ç½®**ï¼š

```java
@Configuration
public class RabbitPersistenceConfig {
    
    @Bean
    public RabbitTemplate rabbitTemplate(ConnectionFactory connectionFactory) {
        RabbitTemplate template = new RabbitTemplate(connectionFactory);
        
        // æ‰¹é‡å‘å¸ƒï¼Œæé«˜æŒä¹…åŒ–æ€§èƒ½
        ((CachingConnectionFactory) connectionFactory).setPublisherConfirmType(
            CachingConnectionFactory.ConfirmType.CORRELATED
        );
        
        return template;
    }
}
```

> ğŸ’¡ **æ€§èƒ½æç¤º**  
> æŒä¹…åŒ–ä¼šé™ä½æ€§èƒ½ï¼Œä½†ä¿è¯å¯é æ€§ã€‚æ ¹æ®ä¸šåŠ¡é‡è¦ç¨‹åº¦é€‰æ‹©æ˜¯å¦æŒä¹…åŒ–

---

## 5. ğŸŒ ç½‘ç»œé—®é¢˜æ’æŸ¥æŠ€å·§


### 5.1 ç½‘ç»œè¿æ¥æ£€æŸ¥


**ğŸ”§ åŸºç¡€è¿æ¥æµ‹è¯•**ï¼š

```bash
# æ£€æŸ¥RabbitMQç«¯å£æ˜¯å¦å¯è¾¾
telnet rabbitmq-server 5672

# æ£€æŸ¥ç®¡ç†ç•Œé¢ç«¯å£
telnet rabbitmq-server 15672

# æ£€æŸ¥ç½‘ç»œå»¶è¿Ÿ
ping rabbitmq-server
```

### 5.2 è¿æ¥å‚æ•°ä¼˜åŒ–


```java
@Bean
public ConnectionFactory connectionFactory() {
    CachingConnectionFactory factory = new CachingConnectionFactory("rabbitmq-server");
    factory.setUsername("admin");
    factory.setPassword("password");
    
    // ğŸ”§ ç½‘ç»œä¼˜åŒ–é…ç½®
    factory.setConnectionTimeout(10000);     // è¿æ¥è¶…æ—¶10ç§’
    factory.setRequestedHeartBeat(60);       // å¿ƒè·³60ç§’
    factory.setNetworkRecoveryInterval(5000); // è‡ªåŠ¨æ¢å¤é—´éš”5ç§’
    
    return factory;
}
```

### 5.3 å¸¸è§ç½‘ç»œé—®é¢˜è§£å†³


**ğŸ“‹ é—®é¢˜è¯Šæ–­æ¸…å•**ï¼š

- [x] **DNSè§£æ**ï¼š`nslookup rabbitmq-server`
- [x] **é˜²ç«å¢™**ï¼šæ£€æŸ¥5672ã€15672ç«¯å£æ˜¯å¦å¼€æ”¾
- [x] **è´Ÿè½½å‡è¡¡**ï¼šæ£€æŸ¥LBå¥åº·æ£€æŸ¥é…ç½®
- [x] **ç½‘ç»œåˆ†åŒº**ï¼šæŸ¥çœ‹RabbitMQé›†ç¾¤çŠ¶æ€

```bash
# æŸ¥çœ‹RabbitMQç½‘ç»œåˆ†åŒºçŠ¶æ€
rabbitmq-diagnostics cluster_status

# æŸ¥çœ‹è¿æ¥çŠ¶æ€
rabbitmqctl list_connections name state
```

---

## 6. ğŸ“Š ç›‘æ§å‘Šè­¦ä½“ç³»å»ºè®¾


### 6.1 å…³é”®ç›‘æ§æŒ‡æ ‡


**ğŸ¯ å¿…ç›‘æ§æŒ‡æ ‡**ï¼š

| æŒ‡æ ‡ç±»å‹ | **æŒ‡æ ‡åç§°** | **æ­£å¸¸å€¼** | **å‘Šè­¦é˜ˆå€¼** | **å½±å“** |
|---------|-------------|-----------|-------------|---------|
| ğŸ”¸ **é˜Ÿåˆ—** | `é˜Ÿåˆ—é•¿åº¦` | `< 1000` | `> 5000` | `æ¶ˆæ¯ç§¯å‹` |
| ğŸ”¸ **è¿æ¥** | `è¿æ¥æ•°` | `ç¨³å®š` | `çªç„¶ä¸‹é™50%` | `ç½‘ç»œé—®é¢˜` |
| ğŸ”¸ **å†…å­˜** | `å†…å­˜ä½¿ç”¨ç‡` | `< 80%` | `> 90%` | `æ€§èƒ½ä¸‹é™` |
| ğŸ”¸ **ç£ç›˜** | `ç£ç›˜ä½¿ç”¨ç‡` | `< 80%` | `> 90%` | `æ¶ˆæ¯ä¸¢å¤±é£é™©` |

### 6.2 ç›‘æ§é…ç½®ç¤ºä¾‹


```java
@Component
public class RabbitMQMonitor {
    
    @Autowired
    private RabbitAdmin rabbitAdmin;
    
    @Scheduled(fixedDelay = 30000) // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
    public void monitorQueues() {
        Properties props = rabbitAdmin.getQueueProperties("order.queue");
        if (props != null) {
            Integer messageCount = (Integer) props.get("QUEUE_MESSAGE_COUNT");
            if (messageCount > 5000) {
                // å‘é€å‘Šè­¦
                alertService.sendAlert("é˜Ÿåˆ—æ¶ˆæ¯ç§¯å‹å‘Šè­¦", "è®¢å•é˜Ÿåˆ—æ¶ˆæ¯æ•°ï¼š" + messageCount);
            }
        }
    }
}
```

### 6.3 å‘Šè­¦é€šçŸ¥é…ç½®


```java
@Service
public class AlertService {
    
    public void sendAlert(String title, String message) {
        // çŸ­ä¿¡å‘Šè­¦
        smsService.send("ç®¡ç†å‘˜æ‰‹æœº", title + ": " + message);
        
        // é‚®ä»¶å‘Šè­¦  
        emailService.send("admin@company.com", title, message);
        
        // é’‰é’‰ç¾¤å‘Šè­¦
        dingTalkService.sendGroupMessage(title + "\n" + message);
    }
}
```

---

## 7. ğŸ› ï¸ ç»¼åˆè§£å†³æ–¹æ¡ˆ


### 7.1 å®Œæ•´çš„å¯é æ€§ä¿éšœæ–¹æ¡ˆ


```java
@Service
public class ReliableMessageService {
    
    private final RabbitTemplate rabbitTemplate;
    private final RedisTemplate<String, Object> redisTemplate;
    
    /**
     * å¯é æ¶ˆæ¯å‘é€
     */
    public void sendReliableMessage(String exchange, String routingKey, Object message) {
        String messageId = UUID.randomUUID().toString();
        
        try {
            // 1. è®°å½•æ¶ˆæ¯åˆ°æ•°æ®åº“ï¼ˆäº‹åŠ¡æ€§å‘ä»¶ç®±æ¨¡å¼ï¼‰
            saveMessageRecord(messageId, exchange, routingKey, message);
            
            // 2. å‘é€æ¶ˆæ¯å¹¶ç­‰å¾…ç¡®è®¤
            CorrelationData correlationData = new CorrelationData(messageId);
            rabbitTemplate.convertAndSend(exchange, routingKey, message, correlationData);
            
            // 3. è®¾ç½®é‡è¯•ä»»åŠ¡
            scheduleRetryIfNeeded(messageId, 3); // 3åˆ†é’Ÿåæ£€æŸ¥
            
        } catch (Exception e) {
            log.error("å‘é€å¯é æ¶ˆæ¯å¤±è´¥ï¼š{}", messageId, e);
            throw new MessageSendException("æ¶ˆæ¯å‘é€å¤±è´¥", e);
        }
    }
    
    /**
     * æ¶ˆæ¯ç¡®è®¤å›è°ƒ
     */
    @EventListener
    public void handleConfirm(MessageConfirmEvent event) {
        if (event.isAck()) {
            // ç¡®è®¤æˆåŠŸï¼Œæ ‡è®°æ¶ˆæ¯ä¸ºå·²å‘é€
            updateMessageStatus(event.getMessageId(), "SENT");
        } else {
            // ç¡®è®¤å¤±è´¥ï¼Œå®‰æ’é‡è¯•
            scheduleRetry(event.getMessageId());
        }
    }
}
```

### 7.2 æ¶ˆè´¹è€…å¹‚ç­‰æ€§ä¿è¯


```java
@Component
public class IdempotentOrderConsumer {
    
    @RabbitListener(queues = "order.queue")
    public void handleOrder(Order order, Channel channel, @Header(AmqpHeaders.DELIVERY_TAG) long deliveryTag) {
        String orderId = order.getId();
        String lockKey = "order:lock:" + orderId;
        
        try {
            // åˆ†å¸ƒå¼é”é˜²æ­¢é‡å¤å¤„ç†
            if (redisTemplate.opsForValue().setIfAbsent(lockKey, "processing", Duration.ofMinutes(5))) {
                
                // å¹‚ç­‰æ€§æ£€æŸ¥
                if (orderService.isOrderExists(orderId)) {
                    log.info("è®¢å•å·²å­˜åœ¨ï¼Œè·³è¿‡å¤„ç†ï¼š{}", orderId);
                    channel.basicAck(deliveryTag, false);
                    return;
                }
                
                // å¤„ç†è®¢å•
                orderService.createOrder(order);
                channel.basicAck(deliveryTag, false);
                
            } else {
                // å…¶ä»–å®ä¾‹æ­£åœ¨å¤„ç†ï¼Œç¨åé‡è¯•
                channel.basicReject(deliveryTag, true);
            }
            
        } catch (Exception e) {
            log.error("è®¢å•å¤„ç†å¼‚å¸¸ï¼š{}", orderId, e);
            channel.basicReject(deliveryTag, true);
        } finally {
            redisTemplate.delete(lockKey);
        }
    }
}
```

### 7.3 æ•…éšœæ¢å¤ç­–ç•¥


**ğŸ”„ è‡ªåŠ¨æ¢å¤æœºåˆ¶**ï¼š

```java
@Component
public class MessageRecoveryService {
    
    @Scheduled(cron = "0 */5 * * * ?") // æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
    public void recoverLostMessages() {
        // æŸ¥æ‰¾è¶…æ—¶æœªç¡®è®¤çš„æ¶ˆæ¯
        List<MessageRecord> timeoutMessages = messageRepository.findTimeoutMessages();
        
        for (MessageRecord record : timeoutMessages) {
            if (record.getRetryCount() < 3) {
                // é‡è¯•å‘é€
                resendMessage(record);
            } else {
                // è½¬å…¥æ­»ä¿¡é˜Ÿåˆ—
                sendToDeadLetterQueue(record);
            }
        }
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ¶ˆæ¯ä¸¢å¤±ï¼šå‘é€ã€å­˜å‚¨ã€æ¶ˆè´¹ä»»ä½•ç¯èŠ‚éƒ½å¯èƒ½ä¸¢å¤±
ğŸ”¸ ç¡®è®¤æœºåˆ¶ï¼šç”Ÿäº§è€…ç¡®è®¤ + æ¶ˆè´¹è€…ç¡®è®¤ = ç«¯åˆ°ç«¯å¯é æ€§  
ğŸ”¸ æŒä¹…åŒ–ï¼šäº¤æ¢æœº + é˜Ÿåˆ— + æ¶ˆæ¯ ä¸‰å±‚æŒä¹…åŒ–
ğŸ”¸ ç½‘ç»œç›‘æ§ï¼šè¿æ¥çŠ¶æ€ã€å»¶è¿Ÿã€åˆ†åŒºæ£€æµ‹
ğŸ”¸ å‘Šè­¦ä½“ç³»ï¼šå…³é”®æŒ‡æ ‡ç›‘æ§ + åŠæ—¶é€šçŸ¥
```

### 8.2 é—®é¢˜æ’æŸ¥æ€è·¯


**ğŸ”¹ ç³»ç»ŸåŒ–æ’æŸ¥æ­¥éª¤**ï¼š
```
1ï¸âƒ£ ç¡®å®šä¸¢å¤±ä½ç½®ï¼šç”Ÿäº§è€…ã€RabbitMQã€æ¶ˆè´¹è€…ï¼Ÿ
2ï¸âƒ£ æ£€æŸ¥ç¡®è®¤æœºåˆ¶ï¼šæ˜¯å¦å¼€å¯ã€å›è°ƒæ˜¯å¦æ­£å¸¸ï¼Ÿ
3ï¸âƒ£ éªŒè¯æŒä¹…åŒ–ï¼šé…ç½®æ˜¯å¦æ­£ç¡®ã€ç£ç›˜æ˜¯å¦æ­£å¸¸ï¼Ÿ
4ï¸âƒ£ ç½‘ç»œè¿æ¥æµ‹è¯•ï¼šå»¶è¿Ÿã€ä¸¢åŒ…ã€åˆ†åŒºæ£€æŸ¥
5ï¸âƒ£ ç›‘æ§æ•°æ®åˆ†æï¼šå†å²è¶‹åŠ¿ã€å¼‚å¸¸æ—¶é—´ç‚¹
```

### 8.3 æœ€ä½³å®è·µå»ºè®®


**ğŸ¯ ç”Ÿäº§ç¯å¢ƒå»ºè®®**ï¼š
- âœ… **å¼€å¯æ‰€æœ‰ç¡®è®¤æœºåˆ¶**ï¼šè™½ç„¶æ€§èƒ½ç•¥ä½ï¼Œä½†å¯é æ€§æœ€é«˜
- âœ… **é‡è¦æ¶ˆæ¯å¿…é¡»æŒä¹…åŒ–**ï¼šè®¢å•ã€æ”¯ä»˜ã€æ ¸å¿ƒä¸šåŠ¡æ¶ˆæ¯
- âœ… **å®ç°æ¶ˆè´¹å¹‚ç­‰æ€§**ï¼šé˜²æ­¢é‡å¤å¤„ç†é€ æˆä¸šåŠ¡é—®é¢˜
- âœ… **å»ºç«‹å®Œå–„ç›‘æ§**ï¼šæå‰å‘ç°é—®é¢˜ï¼Œå¿«é€Ÿå®šä½æ•…éšœ
- âœ… **åˆ¶å®šæ•…éšœé¢„æ¡ˆ**ï¼šæ¶ˆæ¯ç§¯å‹ã€æœåŠ¡å®•æœºçš„åº”å¯¹æ–¹æ¡ˆ

### 8.4 æ€§èƒ½ä¸å¯é æ€§å¹³è¡¡


| åœºæ™¯ç±»å‹ | **å¯é æ€§è¦æ±‚** | **æ€§èƒ½è¦æ±‚** | **æ¨èæ–¹æ¡ˆ** |
|---------|---------------|-------------|-------------|
| ğŸ”¸ **æ ¸å¿ƒä¸šåŠ¡** | `æé«˜` | `ä¸­ç­‰` | `å…¨é‡ç¡®è®¤+æŒä¹…åŒ–` |
| ğŸ”¸ **ä¸€èˆ¬ä¸šåŠ¡** | `é«˜` | `é«˜` | `ç”Ÿäº§è€…ç¡®è®¤+é˜Ÿåˆ—æŒä¹…åŒ–` |
| ğŸ”¸ **æ—¥å¿—æ”¶é›†** | `ä¸­ç­‰` | `æé«˜` | `æœ€å°ç¡®è®¤+å†…å­˜é˜Ÿåˆ—` |

> ğŸ¯ **æ ¸å¿ƒè®°å¿†**  
> æ¶ˆæ¯å¯é æ€§ = ç¡®è®¤æœºåˆ¶ + æŒä¹…åŒ– + ç›‘æ§å‘Šè­¦  
> é—®é¢˜æ’æŸ¥ = åˆ†æ®µå®šä½ + é€å±‚éªŒè¯ + æ•°æ®åˆ†æ  
> ç”Ÿäº§åº”ç”¨ = ä¸šåŠ¡é‡è¦æ€§ + æ€§èƒ½æƒè¡¡ + æ•…éšœé¢„æ¡ˆ