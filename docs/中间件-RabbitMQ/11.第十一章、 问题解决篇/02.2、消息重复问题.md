---
title: 2ã€æ¶ˆæ¯é‡å¤é—®é¢˜
---
## ğŸ“š ç›®å½•

1. [æ¶ˆæ¯é‡å¤ç°è±¡æ¦‚è¿°](#1-æ¶ˆæ¯é‡å¤ç°è±¡æ¦‚è¿°)
2. [é‡å¤äº§ç”Ÿçš„æ ¹æœ¬åŸå› ](#2-é‡å¤äº§ç”Ÿçš„æ ¹æœ¬åŸå› )
3. [ç½‘ç»œé‡è¯•å¯¹æ¶ˆæ¯é‡å¤çš„å½±å“](#3-ç½‘ç»œé‡è¯•å¯¹æ¶ˆæ¯é‡å¤çš„å½±å“)
4. [å¹‚ç­‰æ€§å®ç°ç­–ç•¥](#4-å¹‚ç­‰æ€§å®ç°ç­–ç•¥)
5. [å»é‡ç­–ç•¥ä¸æŠ€æœ¯æ–¹æ¡ˆ](#5-å»é‡ç­–ç•¥ä¸æŠ€æœ¯æ–¹æ¡ˆ)
6. [ä¸šåŠ¡å±‚å¤„ç†æœ€ä½³å®è·µ](#6-ä¸šåŠ¡å±‚å¤„ç†æœ€ä½³å®è·µ)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” æ¶ˆæ¯é‡å¤ç°è±¡æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯æ¶ˆæ¯é‡å¤é—®é¢˜


**ç®€å•ç†è§£**ï¼šå°±åƒä½ å‘å¾®ä¿¡æ—¶ç½‘ç»œä¸å¥½ï¼Œç‚¹äº†å¥½å‡ æ¬¡å‘é€æŒ‰é’®ï¼Œç»“æœæœ‹å‹æ”¶åˆ°äº†å¤šæ¡ç›¸åŒçš„æ¶ˆæ¯ã€‚

```
æ­£å¸¸æƒ…å†µï¼šå‘é€1æ¡ â†’ æ¥æ”¶1æ¡ âœ…
é‡å¤æƒ…å†µï¼šå‘é€1æ¡ â†’ æ¥æ”¶2æ¡æˆ–æ›´å¤š âŒ

å®é™…è¡¨ç°ï¼š
è®¢å•ç³»ç»Ÿï¼šä¸€ä¸ªè®¢å•è¢«å¤„ç†äº†å¤šæ¬¡
æ”¯ä»˜ç³»ç»Ÿï¼šåŒä¸€ç¬”è®¢å•è¢«é‡å¤æ‰£æ¬¾
åº“å­˜ç³»ç»Ÿï¼šåŒä¸€å•†å“è¢«é‡å¤å‡åº“å­˜
```

### 1.2 æ¶ˆæ¯é‡å¤çš„å…¸å‹åœºæ™¯


**ğŸ“Š å¸¸è§é‡å¤åœºæ™¯ç»Ÿè®¡**

| åœºæ™¯ç±»å‹ | **å‘ç”Ÿæ¦‚ç‡** | **å½±å“ç¨‹åº¦** | **å…¸å‹è¡¨ç°** |
|---------|------------|-------------|-------------|
| ğŸŒ **ç½‘ç»œæŠ–åŠ¨** | `85%` | `ä¸­ç­‰` | `æ¶ˆè´¹è€…æ¥æ”¶é‡å¤æ¶ˆæ¯` |
| ğŸ”„ **é‡å¯æ¢å¤** | `60%` | `é«˜` | `é‡å¯åé‡å¤å¤„ç†æœªç¡®è®¤æ¶ˆæ¯` |
| âš¡ **è¶…æ—¶é‡å‘** | `40%` | `ä¸­ç­‰` | `ç”Ÿäº§è€…è¶…æ—¶åé‡å¤å‘é€` |
| ğŸš¨ **å¼‚å¸¸é‡è¯•** | `30%` | `é«˜` | `å¤„ç†å¼‚å¸¸åé‡å¤æ¶ˆè´¹` |

### 1.3 é‡å¤æ¶ˆæ¯çš„ä¸šåŠ¡å½±å“


**ğŸ’° ä¸šåŠ¡é£é™©è¯„ä¼°**

```
ç”µå•†åœºæ™¯å½±å“ï¼š
â”Œâ”€ è®¢å•é‡å¤å¤„ç† â”€â”
â”‚ â€¢ é‡å¤æ‰£åº“å­˜   â”‚ â†’ åº“å­˜æ•°æ®é”™è¯¯
â”‚ â€¢ é‡å¤å‘è´§     â”‚ â†’ ç‰©æµæˆæœ¬å¢åŠ   
â”‚ â€¢ é‡å¤æ‰£æ¬¾     â”‚ â†’ å®¢æˆ·æŠ•è¯‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é‡‘èåœºæ™¯å½±å“ï¼š
â”Œâ”€ æ”¯ä»˜é‡å¤å¤„ç† â”€â”
â”‚ â€¢ é‡å¤è½¬è´¦     â”‚ â†’ èµ„é‡‘æŸå¤±
â”‚ â€¢ é‡å¤è®°è´¦     â”‚ â†’ è´¦åŠ¡ä¸å¹³
â”‚ â€¢ é‡å¤é€šçŸ¥     â”‚ â†’ ç³»ç»Ÿæ··ä¹±
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸ” é‡å¤äº§ç”Ÿçš„æ ¹æœ¬åŸå› 


### 2.1 åˆ†å¸ƒå¼ç³»ç»Ÿçš„å›ºæœ‰ç‰¹æ€§


**æ ¸å¿ƒç†è§£**ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç½‘ç»œæ˜¯ä¸å¯é çš„ï¼Œè¿™æ˜¯é‡å¤é—®é¢˜çš„æ ¹æºã€‚

```
åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„æ¶ˆæ¯ä¼ é€’ï¼š

ç”Ÿäº§è€… â”€â”€â”€â”€ç½‘ç»œâ”€â”€â”€â”€â†’ RabbitMQ â”€â”€â”€â”€ç½‘ç»œâ”€â”€â”€â”€â†’ æ¶ˆè´¹è€…
   â†‘                    â†‘                    â†‘
ç½‘ç»œå»¶è¿Ÿ              æœåŠ¡é‡å¯            å¤„ç†è¶…æ—¶
è¿æ¥æ–­å¼€              å†…å­˜ä¸è¶³            å¼‚å¸¸é‡è¯•
```

### 2.2 At-Least-Onceè¯­ä¹‰çš„å¿…ç„¶ç»“æœ


**é€šä¿—è§£é‡Š**ï¼šRabbitMQä¿è¯æ¶ˆæ¯"è‡³å°‘æŠ•é€’ä¸€æ¬¡"ï¼Œè¿™æ„å‘³ç€å¯èƒ½æŠ•é€’å¤šæ¬¡ã€‚

```java
// RabbitMQçš„æ¶ˆæ¯æŠ•é€’ä¿è¯
At-Least-Once è¯­ä¹‰è¯´æ˜ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… ä¿è¯ï¼šæ¶ˆæ¯ä¸ä¼šä¸¢å¤±            â”‚
â”‚ âŒ ä¸ä¿è¯ï¼šæ¶ˆæ¯ä¸ä¼šé‡å¤          â”‚
â”‚ ğŸ“‹ ç»“æœï¼šå¯èƒ½æ”¶åˆ°é‡å¤æ¶ˆæ¯        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

// è¿™å°±åƒå¿«é€’å‘˜çš„å·¥ä½œåŸåˆ™
å¿«é€’å‘˜ï¼šç¡®ä¿åŒ…è£¹ä¸€å®šé€åˆ°ï¼ˆè‡³å°‘ä¸€æ¬¡ï¼‰
å¯èƒ½ï¼šå¦‚æœæ²¡æ”¶åˆ°ç­¾æ”¶ç¡®è®¤ï¼Œä¼šå†é€ä¸€æ¬¡
ç»“æœï¼šä½ å¯èƒ½æ”¶åˆ°é‡å¤çš„åŒ…è£¹
```

### 2.3 ç¡®è®¤æœºåˆ¶å¤±æ•ˆåœºæ™¯


**ğŸ”§ ACKç¡®è®¤å¤±è´¥çš„å¸¸è§æƒ…å†µ**

```
ç¡®è®¤æœºåˆ¶å¤±æ•ˆæµç¨‹å›¾ï¼š

æ¶ˆè´¹è€…æ¥æ”¶æ¶ˆæ¯ â†’ å¼€å§‹å¤„ç† â†’ å¤„ç†å®Œæˆ â†’ å‘é€ACKç¡®è®¤
                                        â†“
                                    ç½‘ç»œä¸­æ–­âŒ
                                        â†“
                              RabbitMQæœªæ”¶åˆ°ç¡®è®¤
                                        â†“
                                æ¶ˆæ¯é‡æ–°æŠ•é€’ ğŸ’«
```

**å…·ä½“å¤±æ•ˆåœºæ™¯**ï¼š

```
åœºæ™¯1ï¼šç½‘ç»œé—ªæ–­
â€¢ æ¶ˆè´¹è€…å¤„ç†å®Œæ¶ˆæ¯ âœ…
â€¢ å‘é€ACKæ—¶ç½‘ç»œæ–­å¼€ âŒ  
â€¢ RabbitMQè®¤ä¸ºæ¶ˆæ¯æœªå¤„ç† âŒ
â€¢ é‡æ–°æŠ•é€’æ¶ˆæ¯ ğŸ’«

åœºæ™¯2ï¼šå¤„ç†è¶…æ—¶
â€¢ æ¶ˆæ¯å¤„ç†æ—¶é—´è¿‡é•¿ â°
â€¢ è¶…è¿‡ACKè¶…æ—¶æ—¶é—´ âŒ
â€¢ RabbitMQä¸»åŠ¨é‡æ–°æŠ•é€’ ğŸ’«

åœºæ™¯3ï¼šæ¶ˆè´¹è€…é‡å¯
â€¢ æ¶ˆæ¯å¤„ç†åˆ°ä¸€åŠ â³
â€¢ æ¶ˆè´¹è€…è¿›ç¨‹é‡å¯ ğŸ”„
â€¢ æ¶ˆæ¯çŠ¶æ€ä¸¢å¤± âŒ
â€¢ RabbitMQé‡æ–°æŠ•é€’ ğŸ’«
```

---

## 3. ğŸŒ ç½‘ç»œé‡è¯•å¯¹æ¶ˆæ¯é‡å¤çš„å½±å“


### 3.1 ç½‘ç»œé‡è¯•æœºåˆ¶è¯¦è§£


**ç®€å•ç†è§£**ï¼šå°±åƒæ‰“ç”µè¯æ—¶ä¿¡å·ä¸å¥½ï¼Œä½ ä¼šæŒ‚æ–­é‡æ‹¨ï¼Œä½†å¯¹æ–¹å¯èƒ½å…¶å®å·²ç»æ¥é€šäº†ã€‚

```
ç½‘ç»œé‡è¯•å¯¼è‡´é‡å¤çš„è¿‡ç¨‹ï¼š

æ­¥éª¤1ï¼šç”Ÿäº§è€…å‘é€æ¶ˆæ¯
æ­¥éª¤2ï¼šç½‘ç»œä¼ è¾“ä¸­æ–­
æ­¥éª¤3ï¼šç”Ÿäº§è€…è®¤ä¸ºå‘é€å¤±è´¥
æ­¥éª¤4ï¼šç”Ÿäº§è€…é‡è¯•å‘é€
æ­¥éª¤5ï¼šå®é™…ä¸Šä¸¤æ¬¡éƒ½æˆåŠŸäº†

ç»“æœï¼šRabbitMQæ”¶åˆ°2æ¡ç›¸åŒæ¶ˆæ¯
```

### 3.2 é‡è¯•é…ç½®å¯¹é‡å¤çš„å½±å“


**âš™ï¸ é‡è¯•å‚æ•°é…ç½®ç¤ºä¾‹**

```java
// Spring Boot é…ç½®é‡è¯•å‚æ•°
spring:
  rabbitmq:
    template:
      retry:
        enabled: true
        initial-interval: 1000    # åˆå§‹é‡è¯•é—´éš”
        max-attempts: 3           # æœ€å¤§é‡è¯•æ¬¡æ•°  
        max-interval: 10000       # æœ€å¤§é‡è¯•é—´éš”
        multiplier: 2             # é‡è¯•é—´éš”å€æ•°

// é‡è¯•æ¬¡æ•°ä¸é‡å¤é£é™©çš„å…³ç³»
é‡è¯•æ¬¡æ•°è¶Šå¤š â†’ é‡å¤æ¶ˆæ¯è¶Šå¤š â†’ ä¸šåŠ¡é£é™©è¶Šå¤§
```

**ğŸ“Š é‡è¯•ç­–ç•¥å¯¹æ¯”**

| é‡è¯•ç­–ç•¥ | **é‡å¤æ¦‚ç‡** | **å¯é æ€§** | **é€‚ç”¨åœºæ™¯** |
|---------|------------|-----------|-------------|
| ğŸš« **ä¸é‡è¯•** | `ä½` | `ä½` | `å…è®¸å¶å°”ä¸¢å¤±` |
| ğŸ”„ **å›ºå®šé‡è¯•** | `ä¸­` | `ä¸­` | `ä¸€èˆ¬ä¸šåŠ¡åœºæ™¯` |
| ğŸ“ˆ **æŒ‡æ•°é€€é¿** | `ä¸­` | `é«˜` | `é‡è¦ä¸šåŠ¡åœºæ™¯` |
| â™¾ï¸ **æ— é™é‡è¯•** | `é«˜` | `æé«˜` | `ç»ä¸èƒ½ä¸¢å¤±` |

### 3.3 ç½‘ç»œåˆ†åŒºå¯¹é‡å¤çš„åŠ å‰§ä½œç”¨


**ğŸŒ ç½‘ç»œåˆ†åŒºåœºæ™¯åˆ†æ**

```
ç½‘ç»œåˆ†åŒºç¤ºä¾‹ï¼š

æ­£å¸¸ç½‘ç»œï¼š
ç”Ÿäº§è€… â†â†’ RabbitMQ â†â†’ æ¶ˆè´¹è€…
        ç¨³å®šè¿æ¥

ç½‘ç»œåˆ†åŒºï¼š
ç”Ÿäº§è€… â†Ã—â†’ RabbitMQ â†â†’ æ¶ˆè´¹è€…
        è¿æ¥ä¸­æ–­    è¿æ¥æ­£å¸¸

å½±å“ï¼š
â€¢ ç”Ÿäº§è€…é‡è¯•å‘é€æ¶ˆæ¯
â€¢ æ¶ˆè´¹è€…æ­£å¸¸æ¥æ”¶æ—§æ¶ˆæ¯  
â€¢ ç½‘ç»œæ¢å¤åæ¥æ”¶é‡è¯•æ¶ˆæ¯
â€¢ å½¢æˆæ¶ˆæ¯é‡å¤
```

---

## 4. ğŸ’¡ å¹‚ç­‰æ€§å®ç°ç­–ç•¥


### 4.1 ä»€ä¹ˆæ˜¯å¹‚ç­‰æ€§


**é€šä¿—ç†è§£**ï¼šå¹‚ç­‰æ€§å°±åƒç”µæ¢¯æŒ‰é’®ï¼Œæ— è®ºæŒ‰å¤šå°‘æ¬¡ï¼Œç”µæ¢¯åªä¼šæ¥ä¸€æ¬¡ã€‚

```
å¹‚ç­‰æ€§çš„æ ¸å¿ƒæ¦‚å¿µï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ•°å­¦å®šä¹‰ï¼šf(x) = f(f(x))        â”‚
â”‚ ä¸šåŠ¡å®šä¹‰ï¼šå¤šæ¬¡æ“ä½œ = ä¸€æ¬¡æ“ä½œ   â”‚  
â”‚ å®é™…æ„ä¹‰ï¼šé‡å¤æ‰§è¡Œæ— å‰¯ä½œç”¨      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¸¾ä¾‹è¯´æ˜ï¼š
å¹‚ç­‰æ“ä½œï¼šè®¾ç½®ç”¨æˆ·å¹´é¾„ä¸º25å²ï¼ˆæ‰§è¡Œå¤šæ¬¡ç»“æœä¸€æ ·ï¼‰
éå¹‚ç­‰æ“ä½œï¼šç”¨æˆ·ä½™é¢+100å…ƒï¼ˆæ‰§è¡Œå¤šæ¬¡ç»“æœç´¯åŠ ï¼‰
```

### 4.2 ä¸šåŠ¡å±‚å¹‚ç­‰æ€§è®¾è®¡


**ğŸ¯ å¹‚ç­‰æ€§è®¾è®¡æ¨¡å¼**

```java
// æ¨¡å¼1ï¼šçŠ¶æ€æ£€æŸ¥æ¨¡å¼
public class OrderService {
    
    public void processOrder(String orderId) {
        // 1. æ£€æŸ¥è®¢å•çŠ¶æ€
        Order order = orderRepository.findById(orderId);
        if (order.getStatus() == OrderStatus.PROCESSED) {
            return; // å·²å¤„ç†ï¼Œç›´æ¥è¿”å›
        }
        
        // 2. æ‰§è¡Œä¸šåŠ¡é€»è¾‘
        order.setStatus(OrderStatus.PROCESSED);
        orderRepository.save(order);
        
        // 3. æ‰§è¡Œåç»­æ“ä½œ
        inventoryService.reduceStock(order.getProductId());
    }
}

// æ ¸å¿ƒæ€æƒ³ï¼šå…ˆæ£€æŸ¥å†æ‰§è¡Œ
```

**æ¨¡å¼2ï¼šå”¯ä¸€çº¦æŸæ¨¡å¼**

```java
// æ•°æ®åº“è¡¨è®¾è®¡
CREATE TABLE order_process_log (
    id BIGINT PRIMARY KEY,
    order_id VARCHAR(50) UNIQUE,  -- å”¯ä¸€çº¦æŸ
    process_time DATETIME,
    status VARCHAR(20)
);

// ä¸šåŠ¡ä»£ç 
public void processOrder(String orderId) {
    try {
        // æ’å…¥å¤„ç†è®°å½•ï¼ˆä¾èµ–å”¯ä¸€çº¦æŸï¼‰
        processLogRepository.insert(orderId, now(), "PROCESSING");
        
        // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
        doOrderProcess(orderId);
        
        // æ›´æ–°çŠ¶æ€
        processLogRepository.updateStatus(orderId, "COMPLETED");
        
    } catch (DuplicateKeyException e) {
        // é‡å¤å¤„ç†ï¼Œç›´æ¥è¿”å›
        log.info("Order {} already processed", orderId);
    }
}
```

### 4.3 åˆ†å¸ƒå¼å¹‚ç­‰æ€§å®ç°


**ğŸ” åˆ†å¸ƒå¼é”æ–¹æ¡ˆ**

```java
// Redisåˆ†å¸ƒå¼é”å®ç°å¹‚ç­‰
@Service
public class OrderService {
    
    @Autowired
    private RedisTemplate redisTemplate;
    
    public void processOrder(String orderId) {
        String lockKey = "order:lock:" + orderId;
        String lockValue = UUID.randomUUID().toString();
        
        try {
            // è·å–åˆ†å¸ƒå¼é”
            Boolean acquired = redisTemplate.opsForValue()
                .setIfAbsent(lockKey, lockValue, Duration.ofMinutes(5));
                
            if (!acquired) {
                log.info("Order {} is being processed", orderId);
                return; // æ­£åœ¨å¤„ç†ä¸­
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²å¤„ç†
            if (isOrderProcessed(orderId)) {
                return; // å·²å¤„ç†å®Œæˆ
            }
            
            // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
            doOrderProcess(orderId);
            
        } finally {
            // é‡Šæ”¾é”
            releaseLock(lockKey, lockValue);
        }
    }
}
```

---

## 5. ğŸ›¡ï¸ å»é‡ç­–ç•¥ä¸æŠ€æœ¯æ–¹æ¡ˆ


### 5.1 æ¶ˆæ¯çº§åˆ«å»é‡


**ğŸ“‹ æ¶ˆæ¯å”¯ä¸€æ ‡è¯†è®¾è®¡**

```java
// æ–¹æ¡ˆ1ï¼šä¸šåŠ¡IDä½œä¸ºæ¶ˆæ¯å”¯ä¸€æ ‡è¯†
public class MessagePublisher {
    
    public void publishOrderMessage(Order order) {
        // ä½¿ç”¨è®¢å•IDä½œä¸ºæ¶ˆæ¯çš„å”¯ä¸€æ ‡è¯†
        String messageId = "order:" + order.getId();
        
        rabbitTemplate.convertAndSend(
            "order.exchange",
            "order.created", 
            order,
            message -> {
                message.getMessageProperties().setMessageId(messageId);
                return message;
            }
        );
    }
}

// æ¶ˆè´¹è€…ç«¯å»é‡
@RabbitListener(queues = "order.queue")
public void handleOrderMessage(
    @Payload Order order,
    @Header Map<String, Object> headers
) {
    String messageId = (String) headers.get("message_id");
    
    // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²å¤„ç†
    if (messageProcessedCache.containsKey(messageId)) {
        log.info("Message {} already processed", messageId);
        return; // é‡å¤æ¶ˆæ¯ï¼Œç›´æ¥è¿”å›
    }
    
    // å¤„ç†æ¶ˆæ¯
    processOrder(order);
    
    // è®°å½•å·²å¤„ç†
    messageProcessedCache.put(messageId, true);
}
```

### 5.2 åŸºäºç¼“å­˜çš„å»é‡æ–¹æ¡ˆ


**ğŸ—ƒï¸ Redisç¼“å­˜å»é‡å®ç°**

```java
@Component
public class MessageDeduplication {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    private static final String DEDUP_PREFIX = "msg:dedup:";
    private static final Duration EXPIRE_TIME = Duration.ofHours(24);
    
    /**
     * æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦é‡å¤
     * @param messageId æ¶ˆæ¯å”¯ä¸€æ ‡è¯†
     * @return true-é‡å¤ï¼Œfalse-é¦–æ¬¡å¤„ç†
     */
    public boolean isDuplicate(String messageId) {
        String key = DEDUP_PREFIX + messageId;
        
        // ä½¿ç”¨SETNXå®ç°åŸå­æ€§æ£€æŸ¥å’Œè®¾ç½®
        Boolean result = redisTemplate.opsForValue()
            .setIfAbsent(key, "processed", EXPIRE_TIME);
            
        return !result; // falseè¡¨ç¤ºé‡å¤ï¼Œtrueè¡¨ç¤ºé¦–æ¬¡
    }
    
    /**
     * æ ‡è®°æ¶ˆæ¯å·²å¤„ç†
     */
    public void markProcessed(String messageId) {
        String key = DEDUP_PREFIX + messageId;
        redisTemplate.opsForValue().set(key, "processed", EXPIRE_TIME);
    }
}

// ä½¿ç”¨ç¤ºä¾‹
@RabbitListener(queues = "order.queue")
public void handleMessage(Order order) {
    String messageId = generateMessageId(order);
    
    // å»é‡æ£€æŸ¥
    if (messageDeduplication.isDuplicate(messageId)) {
        log.info("Duplicate message ignored: {}", messageId);
        return;
    }
    
    try {
        // å¤„ç†ä¸šåŠ¡é€»è¾‘
        orderService.processOrder(order);
        
    } catch (Exception e) {
        // å¤„ç†å¤±è´¥æ—¶æ¸…é™¤å»é‡æ ‡è®°ï¼Œå…è®¸é‡è¯•
        redisTemplate.delete(DEDUP_PREFIX + messageId);
        throw e;
    }
}
```

### 5.3 æ•°æ®åº“å»é‡æ–¹æ¡ˆ


**ğŸ—„ï¸ æ•°æ®åº“è¡¨è®¾è®¡å»é‡**

```sql
-- æ¶ˆæ¯å»é‡è¡¨è®¾è®¡
CREATE TABLE message_deduplication (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    message_id VARCHAR(100) UNIQUE NOT NULL,
    message_content TEXT,
    processed_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    status ENUM('PROCESSING', 'COMPLETED', 'FAILED') DEFAULT 'PROCESSING',
    
    INDEX idx_message_id (message_id),
    INDEX idx_processed_time (processed_time)
);

-- å®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®
DELETE FROM message_deduplication 
WHERE processed_time < DATE_SUB(NOW(), INTERVAL 7 DAY);
```

```java
// æ•°æ®åº“å»é‡æœåŠ¡
@Service
@Transactional
public class DatabaseDeduplicationService {
    
    public boolean tryProcessMessage(String messageId, String content) {
        try {
            // æ’å…¥å»é‡è®°å½•
            DeduplicationRecord record = new DeduplicationRecord();
            record.setMessageId(messageId);
            record.setMessageContent(content);
            record.setStatus("PROCESSING");
            
            deduplicationRepository.save(record);
            return true; // é¦–æ¬¡å¤„ç†
            
        } catch (DataIntegrityViolationException e) {
            // å”¯ä¸€çº¦æŸå†²çªï¼Œè¯´æ˜æ˜¯é‡å¤æ¶ˆæ¯
            log.info("Duplicate message detected: {}", messageId);
            return false;
        }
    }
    
    public void markCompleted(String messageId) {
        deduplicationRepository.updateStatus(messageId, "COMPLETED");
    }
    
    public void markFailed(String messageId) {
        deduplicationRepository.updateStatus(messageId, "FAILED");
    }
}
```

---

## 6. ğŸ¢ ä¸šåŠ¡å±‚å¤„ç†æœ€ä½³å®è·µ


### 6.1 è®¾è®¡åŸåˆ™ä¸æ¨¡å¼


**ğŸ¯ æ ¸å¿ƒè®¾è®¡åŸåˆ™**

```
åŸåˆ™1ï¼šä¼˜å…ˆä¸šåŠ¡å¹‚ç­‰è®¾è®¡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ ä»ä¸šåŠ¡é€»è¾‘å±‚é¢é¿å…é‡å¤å½±å“ â”‚
â”‚ â€¢ è®¾è®¡å¤©ç„¶å¹‚ç­‰çš„ä¸šåŠ¡æ“ä½œ    â”‚
â”‚ â€¢ çŠ¶æ€æœºé©±åŠ¨çš„ä¸šåŠ¡æµç¨‹      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åŸåˆ™2ï¼šå¤šå±‚é˜²æŠ¤ç­–ç•¥
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬1å±‚ï¼šæ¶ˆæ¯å»é‡              â”‚
â”‚ ç¬¬2å±‚ï¼šä¸šåŠ¡å¹‚ç­‰              â”‚  
â”‚ ç¬¬3å±‚ï¼šæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 å…·ä½“ä¸šåŠ¡åœºæ™¯å¤„ç†


**ğŸ’° æ”¯ä»˜ä¸šåŠ¡å¹‚ç­‰å¤„ç†**

```java
@Service
public class PaymentService {
    
    public PaymentResult processPayment(PaymentRequest request) {
        String paymentId = request.getPaymentId();
        
        // 1. æ£€æŸ¥æ”¯ä»˜è®°å½•æ˜¯å¦å­˜åœ¨
        Payment existingPayment = paymentRepository.findByPaymentId(paymentId);
        if (existingPayment != null) {
            return buildResultFromExisting(existingPayment);
        }
        
        // 2. åˆ›å»ºæ”¯ä»˜è®°å½•ï¼ˆçŠ¶æ€ï¼šå¤„ç†ä¸­ï¼‰
        Payment payment = new Payment();
        payment.setPaymentId(paymentId);
        payment.setAmount(request.getAmount());
        payment.setStatus(PaymentStatus.PROCESSING);
        
        try {
            paymentRepository.save(payment);
        } catch (DataIntegrityViolationException e) {
            // å¹¶å‘æƒ…å†µä¸‹çš„é‡å¤åˆ›å»ºï¼Œé‡æ–°æŸ¥è¯¢
            return buildResultFromExisting(
                paymentRepository.findByPaymentId(paymentId)
            );
        }
        
        // 3. æ‰§è¡Œæ”¯ä»˜é€»è¾‘
        try {
            PaymentResult result = doPayment(request);
            
            // 4. æ›´æ–°æ”¯ä»˜çŠ¶æ€
            payment.setStatus(result.isSuccess() ? 
                PaymentStatus.SUCCESS : PaymentStatus.FAILED);
            payment.setTransactionId(result.getTransactionId());
            paymentRepository.save(payment);
            
            return result;
            
        } catch (Exception e) {
            // 5. å¼‚å¸¸å¤„ç†
            payment.setStatus(PaymentStatus.FAILED);
            payment.setErrorMessage(e.getMessage());
            paymentRepository.save(payment);
            throw e;
        }
    }
}
```

**ğŸ“¦ åº“å­˜æ‰£å‡å¹‚ç­‰å¤„ç†**

```java
@Service
public class InventoryService {
    
    public void reduceInventory(String productId, int quantity, String requestId) {
        // 1. æ£€æŸ¥æ‰£å‡è®°å½•
        InventoryLog log = inventoryLogRepository.findByRequestId(requestId);
        if (log != null) {
            if (log.getStatus() == InventoryLogStatus.SUCCESS) {
                return; // å·²æˆåŠŸæ‰£å‡
            } else if (log.getStatus() == InventoryLogStatus.PROCESSING) {
                throw new BusinessException("åº“å­˜æ‰£å‡æ­£åœ¨å¤„ç†ä¸­");
            }
        }
        
        // 2. åˆ›å»ºæ‰£å‡æ—¥å¿—
        log = new InventoryLog();
        log.setRequestId(requestId);
        log.setProductId(productId);
        log.setQuantity(quantity);
        log.setStatus(InventoryLogStatus.PROCESSING);
        inventoryLogRepository.save(log);
        
        try {
            // 3. æ‰§è¡Œåº“å­˜æ‰£å‡ï¼ˆä½¿ç”¨ä¹è§‚é”ï¼‰
            int updated = inventoryRepository.reduceStock(productId, quantity);
            if (updated == 0) {
                throw new BusinessException("åº“å­˜ä¸è¶³æˆ–äº§å“ä¸å­˜åœ¨");
            }
            
            // 4. æ›´æ–°æ—¥å¿—çŠ¶æ€
            log.setStatus(InventoryLogStatus.SUCCESS);
            inventoryLogRepository.save(log);
            
        } catch (Exception e) {
            // 5. å¤±è´¥å¤„ç†
            log.setStatus(InventoryLogStatus.FAILED);
            log.setErrorMessage(e.getMessage());
            inventoryLogRepository.save(log);
            throw e;
        }
    }
}
```

### 6.3 ç›‘æ§ä¸å‘Šè­¦æœºåˆ¶


**ğŸ“Š é‡å¤æ¶ˆæ¯ç›‘æ§**

```java
@Component
public class DuplicateMessageMonitor {
    
    private final MeterRegistry meterRegistry;
    private final Counter duplicateCounter;
    
    public DuplicateMessageMonitor(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        this.duplicateCounter = Counter.builder("duplicate.messages")
            .description("é‡å¤æ¶ˆæ¯è®¡æ•°")
            .register(meterRegistry);
    }
    
    public void recordDuplicate(String messageType, String messageId) {
        // è®°å½•é‡å¤æ¶ˆæ¯æŒ‡æ ‡
        duplicateCounter.increment(
            Tags.of(
                "type", messageType,
                "severity", getDuplicateSeverity(messageType)
            )
        );
        
        // æ—¥å¿—è®°å½•
        log.warn("Duplicate message detected: type={}, id={}", 
            messageType, messageId);
        
        // é«˜é¢‘é‡å¤å‘Šè­¦
        checkHighFrequencyDuplicate(messageType);
    }
    
    private void checkHighFrequencyDuplicate(String messageType) {
        // æ£€æŸ¥æœ€è¿‘5åˆ†é’Ÿå†…çš„é‡å¤é¢‘ç‡
        double recentRate = duplicateCounter.count();
        if (recentRate > THRESHOLD) {
            alertService.sendAlert(
                "é«˜é¢‘é‡å¤æ¶ˆæ¯å‘Šè­¦", 
                String.format("æ¶ˆæ¯ç±»å‹ %s åœ¨5åˆ†é’Ÿå†…é‡å¤ %.0f æ¬¡", messageType, recentRate)
            );
        }
    }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ é‡å¤æ ¹æºï¼šåˆ†å¸ƒå¼ç³»ç»Ÿç½‘ç»œä¸å¯é  + At-Least-Onceè¯­ä¹‰
ğŸ”¸ å½±å“èŒƒå›´ï¼šæ•°æ®ä¸€è‡´æ€§ã€ä¸šåŠ¡æ­£ç¡®æ€§ã€ç³»ç»Ÿæ€§èƒ½
ğŸ”¸ è§£å†³æ€è·¯ï¼šé¢„é˜² + æ£€æµ‹ + å¤„ç†çš„å¤šå±‚é˜²æŠ¤
ğŸ”¸ æ ¸å¿ƒæŠ€æœ¯ï¼šå¹‚ç­‰æ€§è®¾è®¡ã€å»é‡ç­–ç•¥ã€çŠ¶æ€ç®¡ç†
ğŸ”¸ æœ€ä½³å®è·µï¼šä¸šåŠ¡å±‚å¹‚ç­‰ä¼˜å…ˆã€æŠ€æœ¯æ‰‹æ®µè¾…åŠ©
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆä¼šäº§ç”Ÿé‡å¤æ¶ˆæ¯**
```
æ ¹æœ¬åŸå› ï¼š
â€¢ ç½‘ç»œæ˜¯ä¸å¯é çš„ï¼ˆå»¶è¿Ÿã€ä¸¢åŒ…ã€åˆ†åŒºï¼‰
â€¢ ç¡®è®¤æœºåˆ¶æœ‰æ—¶æ•ˆæ€§ï¼ˆè¶…æ—¶ã€é‡å¯ã€å¼‚å¸¸ï¼‰
â€¢ é‡è¯•æœºåˆ¶çš„å¿…è¦æ€§ï¼ˆä¿è¯å¯é æŠ•é€’ï¼‰

å®é™…è¡¨ç°ï¼š
â€¢ æ¶ˆè´¹è€…å¤„ç†å®Œä½†ACKä¸¢å¤± â†’ æ¶ˆæ¯é‡æ–°æŠ•é€’
â€¢ ç½‘ç»œæŠ–åŠ¨å¯¼è‡´é‡è¯• â†’ äº§ç”Ÿé‡å¤æ¶ˆæ¯  
â€¢ ç³»ç»Ÿé‡å¯æ¢å¤ â†’ é‡å¤å¤„ç†æœªç¡®è®¤æ¶ˆæ¯
```

**ğŸ”¹ å¹‚ç­‰æ€§çš„æ ¸å¿ƒä»·å€¼**
```
è§£å†³æ€è·¯ï¼š
â€¢ è®©é‡å¤æ‰§è¡Œæ— å®³åŒ–
â€¢ ä»æ ¹æœ¬ä¸Šè§£å†³é‡å¤å½±å“
â€¢ æå‡ç³»ç»Ÿå¥å£®æ€§

å®ç°æ–¹å¼ï¼š
â€¢ çŠ¶æ€æ£€æŸ¥ï¼šå…ˆæŸ¥åæ”¹
â€¢ å”¯ä¸€çº¦æŸï¼šæ•°æ®åº“å±‚é˜²æŠ¤
â€¢ åˆ†å¸ƒå¼é”ï¼šå¹¶å‘æ§åˆ¶
â€¢ å»é‡ç¼“å­˜ï¼šæŠ€æœ¯æ‰‹æ®µè¾…åŠ©
```

**ğŸ”¹ ä¸šåŠ¡è®¾è®¡çš„é‡è¦æ€§**
```
ä¼˜å…ˆçº§æ’åºï¼š
1. ä¸šåŠ¡å¹‚ç­‰è®¾è®¡ï¼ˆæ²»æœ¬ï¼‰
2. æ¶ˆæ¯å»é‡æœºåˆ¶ï¼ˆæ²»æ ‡ï¼‰  
3. ç›‘æ§å‘Šè­¦æœºåˆ¶ï¼ˆå‘ç°ï¼‰
4. æ•°æ®ä¿®å¤æœºåˆ¶ï¼ˆå…œåº•ï¼‰

è®¾è®¡åŸåˆ™ï¼š
â€¢ ä¸šåŠ¡çŠ¶æ€é©±åŠ¨
â€¢ æ“ä½œåŸå­æ€§ä¿è¯
â€¢ å¼‚å¸¸æƒ…å†µè€ƒè™‘
â€¢ å¹¶å‘å®‰å…¨å¤„ç†
```

### 7.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ è§£å†³å®é™…é—®é¢˜**
- **ç”µå•†ç³»ç»Ÿ**ï¼šé¿å…é‡å¤ä¸‹å•ã€é‡å¤æ‰£åº“å­˜
- **æ”¯ä»˜ç³»ç»Ÿ**ï¼šé˜²æ­¢é‡å¤æ‰£æ¬¾ã€é‡å¤è½¬è´¦
- **é€šçŸ¥ç³»ç»Ÿ**ï¼šé¿å…é‡å¤å‘é€çŸ­ä¿¡ã€é‚®ä»¶
- **æ•°æ®åŒæ­¥**ï¼šé˜²æ­¢é‡å¤å†™å…¥ã€æ•°æ®é”™ä¹±

**ğŸ”§ æå‡ç³»ç»Ÿè´¨é‡**
- **æ•°æ®ä¸€è‡´æ€§**ï¼šä¿è¯ä¸šåŠ¡æ•°æ®çš„æ­£ç¡®æ€§
- **ç”¨æˆ·ä½“éªŒ**ï¼šé¿å…é‡å¤æ“ä½œå¸¦æ¥çš„å›°æ‰°
- **è¿ç»´æ•ˆç‡**ï¼šå‡å°‘äººå·¥ä»‹å…¥å¤„ç†é‡å¤é—®é¢˜
- **ç³»ç»Ÿç¨³å®šæ€§**ï¼šæé«˜åˆ†å¸ƒå¼ç³»ç»Ÿçš„å¥å£®æ€§

**æ ¸å¿ƒè®°å¿†**ï¼š
- é‡å¤æ¶ˆæ¯æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„å¸¸è§é—®é¢˜
- å¹‚ç­‰æ€§è®¾è®¡æ˜¯æ ¹æœ¬è§£å†³æ–¹æ¡ˆ
- å¤šå±‚é˜²æŠ¤æ¯”å•ä¸€æ‰‹æ®µæ›´å¯é 
- ä¸šåŠ¡å±‚å¤„ç†ä¼˜äºæŠ€æœ¯å±‚å¤„ç†
- ç›‘æ§é¢„è­¦æœ‰åŠ©äºåŠæ—¶å‘ç°é—®é¢˜