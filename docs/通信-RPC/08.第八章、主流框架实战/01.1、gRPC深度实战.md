---
title: 1ã€gRPCæ·±åº¦å®æˆ˜
---
## ğŸ“š ç›®å½•

1. [gRPCæ ¸å¿ƒæ¦‚å¿µç†è§£](#1-grpcæ ¸å¿ƒæ¦‚å¿µç†è§£)
2. [ç¯å¢ƒæ­å»ºå’Œå‡†å¤‡](#2-ç¯å¢ƒæ­å»ºå’Œå‡†å¤‡)
3. [Protobufæ–‡ä»¶ç¼–å†™å®æˆ˜](#3-protobufæ–‡ä»¶ç¼–å†™å®æˆ˜)
4. [å››ç§æœåŠ¡ç±»å‹è¯¦è§£](#4-å››ç§æœåŠ¡ç±»å‹è¯¦è§£)
5. [å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å®ç°](#5-å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å®ç°)
6. [é«˜çº§ç‰¹æ€§åº”ç”¨](#6-é«˜çº§ç‰¹æ€§åº”ç”¨)
7. [ç”Ÿäº§ç¯å¢ƒå®è·µ](#7-ç”Ÿäº§ç¯å¢ƒå®è·µ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ gRPCæ ¸å¿ƒæ¦‚å¿µç†è§£


### 1.1 gRPCåˆ°åº•æ˜¯ä»€ä¹ˆ


**ç®€å•ç†è§£**ï¼šgRPCå°±åƒæ‰“ç”µè¯ä¸€æ ·ï¼Œä½ æ‹¿èµ·ç”µè¯ç›´æ¥è¯´"å¸®æˆ‘æŸ¥ä¸€ä¸‹å¤©æ°”"ï¼Œå¯¹æ–¹ç›´æ¥å‘Šè¯‰ä½ ç»“æœã€‚

```
ä¼ ç»ŸAPIè°ƒç”¨æ–¹å¼ï¼š
ä½  â†’ å†™HTTPè¯·æ±‚ â†’ åŒ…è£…JSONæ•°æ® â†’ å‘é€ç»™æœåŠ¡å™¨ â†’ è§£æJSONå“åº”

gRPCè°ƒç”¨æ–¹å¼ï¼š
ä½  â†’ ç›´æ¥è°ƒç”¨æ–¹æ³• â†’ grpc.getWeather("åŒ—äº¬") â†’ å¾—åˆ°ç»“æœ
```

**ğŸ”¸ æ ¸å¿ƒä¼˜åŠ¿**
- **åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·è°ƒç”¨è¿œç¨‹æœåŠ¡**
- **è‡ªåŠ¨å¤„ç†ç½‘ç»œä¼ è¾“ç»†èŠ‚**
- **æ•°æ®ä¼ è¾“æ•ˆç‡æ¯”JSONé«˜å¾ˆå¤š**
- **è‡ªåŠ¨ç”Ÿæˆå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä»£ç **

### 1.2 gRPCå·¥ä½œåŸç†


```
å®¢æˆ·ç«¯                        æœåŠ¡ç«¯
   |                            |
   |--[1]è°ƒç”¨getUserInfo()----->|
   |   (åƒæœ¬åœ°æ–¹æ³•è°ƒç”¨)          |
   |                            |--[2]æ‰§è¡ŒçœŸå®ä¸šåŠ¡é€»è¾‘
   |                            |   æŸ¥è¯¢æ•°æ®åº“è·å–ç”¨æˆ·ä¿¡æ¯
   |<--[3]è¿”å›Userå¯¹è±¡----------|
   |   (ç›´æ¥å¾—åˆ°ç»“æœå¯¹è±¡)        |
```

**ğŸ’¡ å…³é”®ç†è§£**ï¼š
- **å®¢æˆ·ç«¯**ï¼šä½ åªéœ€è¦è°ƒç”¨æ–¹æ³•ï¼Œä¸ç®¡ç½‘ç»œä¼ è¾“
- **gRPCæ¡†æ¶**ï¼šè‡ªåŠ¨å¤„ç†åºåˆ—åŒ–ã€ç½‘ç»œé€šä¿¡ã€é”™è¯¯å¤„ç†
- **æœåŠ¡ç«¯**ï¼šåªå†™ä¸šåŠ¡é€»è¾‘ï¼Œä¸ç®¡ç½‘ç»œç»†èŠ‚

---

## 2. ğŸ› ï¸ ç¯å¢ƒæ­å»ºå’Œå‡†å¤‡


### 2.1 éœ€è¦å®‰è£…çš„å·¥å…·


**ğŸ”¸ æ ¸å¿ƒå·¥å…·æ¸…å•**
```bash
# 1. Protocol Buffersç¼–è¯‘å™¨ - ç”¨æ¥æŠŠ.protoæ–‡ä»¶å˜æˆä»£ç 
brew install protobuf  # Macç³»ç»Ÿ
# æˆ–è€… apt-get install protobuf-compiler  # Ubuntuç³»ç»Ÿ

# 2. å„è¯­è¨€çš„gRPCæ’ä»¶
# Javaé¡¹ç›®åœ¨pom.xmlä¸­æ·»åŠ ä¾èµ–
# Python: pip install grpcio grpcio-tools
# Go: go get google.golang.org/grpc
```

**ğŸ’¡ å·¥å…·ä½œç”¨è§£é‡Š**ï¼š
- **protoc**ï¼šæŠŠä½ å†™çš„.protoæ–‡ä»¶"ç¿»è¯‘"æˆå„ç§ç¼–ç¨‹è¯­è¨€çš„ä»£ç 
- **gRPCåº“**ï¼šæä¾›ç½‘ç»œé€šä¿¡ã€åºåˆ—åŒ–ç­‰åº•å±‚åŠŸèƒ½
- **è¯­è¨€æ’ä»¶**ï¼šè®©protocçŸ¥é“æ€ä¹ˆç”Ÿæˆç‰¹å®šè¯­è¨€çš„ä»£ç 

### 2.2 Javaç¯å¢ƒé…ç½®ç¤ºä¾‹


```xml
<!-- pom.xml - Mavené¡¹ç›®é…ç½® -->
<dependencies>
    <!-- gRPCæ ¸å¿ƒåº“ -->
    <dependency>
        <groupId>io.grpc</groupId>
        <artifactId>grpc-netty-shaded</artifactId>
        <version>1.58.0</version>
    </dependency>
    
    <!-- Protocol Buffersæ”¯æŒ -->
    <dependency>
        <groupId>io.grpc</groupId>
        <artifactId>grpc-protobuf</artifactId>
        <version>1.58.0</version>
    </dependency>
    
    <!-- gRPC Stubç”Ÿæˆ -->
    <dependency>
        <groupId>io.grpc</groupId>
        <artifactId>grpc-stub</artifactId>
        <version>1.58.0</version>
    </dependency>
</dependencies>

<!-- è‡ªåŠ¨ç”Ÿæˆä»£ç çš„æ’ä»¶ -->
<plugins>
    <plugin>
        <groupId>io.grpc</groupId>
        <artifactId>protoc-gen-grpc-java</artifactId>
        <version>1.58.0</version>
    </plugin>
</plugins>
```

### 2.3 éªŒè¯ç¯å¢ƒæ˜¯å¦æ­£ç¡®


```bash
# æ£€æŸ¥protocæ˜¯å¦å®‰è£…æˆåŠŸ
protoc --version
# åº”è¯¥è¾“å‡ºç±»ä¼¼ï¼šlibprotoc 3.21.12

# æ£€æŸ¥å„è¯­è¨€æ’ä»¶
protoc --grpc_java_out=. --plugin=protoc-gen-grpc-java
# å¦‚æœæ²¡æŠ¥é”™è¯´æ˜æ’ä»¶å®‰è£…æ­£ç¡®
```

---

## 3. ğŸ“ Protobufæ–‡ä»¶ç¼–å†™å®æˆ˜


### 3.1 ä»€ä¹ˆæ˜¯.protoæ–‡ä»¶


**ç®€å•ç†è§£**ï¼š.protoæ–‡ä»¶å°±åƒæ˜¯"åˆåŒ"ï¼Œå®šä¹‰äº†å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¹‹é—´æ€ä¹ˆäº¤æµã€‚

```
æƒ³è±¡ä½ è¦å¼€ä¸€å®¶é¤å…ï¼š
.protoæ–‡ä»¶ = èœå•
- å®šä¹‰æœ‰ä»€ä¹ˆèœ(æœåŠ¡æ–¹æ³•)
- æ¯é“èœéœ€è¦ä»€ä¹ˆææ–™(è¯·æ±‚å‚æ•°) 
- æœ€ç»ˆä¸Šä»€ä¹ˆèœ(è¿”å›ç»“æœ)

å®¢æˆ·ç«¯ = é¡¾å®¢ï¼Œçœ‹ç€èœå•ç‚¹èœ
æœåŠ¡ç«¯ = å¨å¸ˆï¼ŒæŒ‰èœå•åšèœ
```

### 3.2 åŸºç¡€.protoæ–‡ä»¶ç»“æ„


```protobuf
// user_service.proto - ç”¨æˆ·æœåŠ¡å®šä¹‰
syntax = "proto3";  // ä½¿ç”¨proto3è¯­æ³•(æœ€æ–°ç‰ˆæœ¬)

package com.example.user;  // åŒ…å,é¿å…å‘½åå†²çª

// å¯¼å…¥å…¶ä»–protoæ–‡ä»¶(å¦‚æœéœ€è¦)
// import "common.proto";

// å®šä¹‰æœåŠ¡ - ç›¸å½“äºé¤å…èœå•
service UserService {
    // è·å–ç”¨æˆ·ä¿¡æ¯ - ç®€å•è¯·æ±‚å“åº”
    rpc GetUser(GetUserRequest) returns (UserResponse);
    
    // è·å–ç”¨æˆ·åˆ—è¡¨ - æœåŠ¡ç«¯æµå¼å“åº”
    rpc ListUsers(ListUsersRequest) returns (stream UserResponse);
}

// å®šä¹‰è¯·æ±‚æ¶ˆæ¯ - ç‚¹èœæ—¶å‘Šè¯‰æœåŠ¡å‘˜çš„ä¿¡æ¯
message GetUserRequest {
    int64 user_id = 1;        // ç”¨æˆ·IDï¼Œç¼–å·1
    string username = 2;      // ç”¨æˆ·åï¼Œç¼–å·2
}

// å®šä¹‰å“åº”æ¶ˆæ¯ - æœåŠ¡å‘˜è¿”å›ç»™ä½ çš„ä¿¡æ¯
message UserResponse {
    int64 id = 1;
    string name = 2;
    string email = 3;
    int32 age = 4;
}

message ListUsersRequest {
    int32 page_size = 1;      // æ¯é¡µæ•°é‡
    string page_token = 2;    // åˆ†é¡µä»¤ç‰Œ
}
```

**ğŸ”¸ å…³é”®ç†è§£**ï¼š
- **service**ï¼šå®šä¹‰å¯ä»¥è°ƒç”¨çš„æ–¹æ³•ï¼ˆèœå•ä¸Šçš„èœå“ï¼‰
- **message**ï¼šå®šä¹‰æ•°æ®ç»“æ„ï¼ˆèœå“çš„é…æ–™å’Œæˆå“ï¼‰
- **å­—æ®µç¼–å·**ï¼šæ¯ä¸ªå­—æ®µéƒ½æœ‰å”¯ä¸€ç¼–å·ï¼Œç”¨äºåºåˆ—åŒ–

### 3.3 Protobufé«˜çº§ç‰¹æ€§


**ğŸ”¹ å¸¸ç”¨æ•°æ®ç±»å‹**
```protobuf
message AdvancedMessage {
    // åŸºç¡€ç±»å‹
    string name = 1;          // å­—ç¬¦ä¸²
    int32 age = 2;            // 32ä½æ•´æ•°
    bool is_active = 3;       // å¸ƒå°”å€¼
    double salary = 4;        // åŒç²¾åº¦æµ®ç‚¹æ•°
    
    // é‡å¤å­—æ®µ - ç›¸å½“äºæ•°ç»„/åˆ—è¡¨
    repeated string hobbies = 5;
    repeated int32 scores = 6;
    
    // Mapç±»å‹ - é”®å€¼å¯¹
    map<string, string> metadata = 7;
    
    // æšä¸¾ç±»å‹
    Status status = 8;
    
    // åµŒå¥—æ¶ˆæ¯
    Address home_address = 9;
    
    // oneof - å¤šé€‰ä¸€
    oneof contact {
        string email = 10;
        string phone = 11;
    }
}

// æšä¸¾å®šä¹‰
enum Status {
    UNKNOWN = 0;    // æšä¸¾å¿…é¡»ä»0å¼€å§‹
    ACTIVE = 1;
    INACTIVE = 2;
    SUSPENDED = 3;
}

// åµŒå¥—æ¶ˆæ¯
message Address {
    string street = 1;
    string city = 2;
    string country = 3;
}
```

**ğŸ’¡ å­—æ®µè§£é‡Š**ï¼š
- **repeated**ï¼šè¡¨ç¤ºè¿™ä¸ªå­—æ®µå¯ä»¥æœ‰å¤šä¸ªå€¼ï¼ˆæ•°ç»„ï¼‰
- **map**ï¼šé”®å€¼å¯¹æ•°æ®ï¼Œæ¯”å¦‚å­˜å‚¨ç”¨æˆ·çš„è‡ªå®šä¹‰å±æ€§
- **oneof**ï¼šå¤šä¸ªå­—æ®µä¸­åªèƒ½è®¾ç½®ä¸€ä¸ªï¼Œæ¯”å¦‚è”ç³»æ–¹å¼åªèƒ½æ˜¯é‚®ç®±æˆ–ç”µè¯
- **æšä¸¾**ï¼šé¢„å®šä¹‰çš„å¸¸é‡å€¼ï¼Œæ¯”å¦‚ç”¨æˆ·çŠ¶æ€

### 3.4 ç”Ÿæˆä»£ç 


```bash
# ç”ŸæˆJavaä»£ç 
protoc --java_out=src/main/java \
       --grpc-java_out=src/main/java \
       --plugin=protoc-gen-grpc-java=/path/to/plugin \
       user_service.proto

# ç”ŸæˆPythonä»£ç   
python -m grpc_tools.protoc \
       --python_out=. \
       --grpc_python_out=. \
       user_service.proto

# ç”ŸæˆGoä»£ç 
protoc --go_out=. --go-grpc_out=. user_service.proto
```

**ç”Ÿæˆçš„æ–‡ä»¶è¯´æ˜**ï¼š
```
Javaç”Ÿæˆæ–‡ä»¶ï¼š
â”œâ”€â”€ UserServiceProto.java     # æ¶ˆæ¯ç±»å®šä¹‰
â”œâ”€â”€ UserServiceGrpc.java      # æœåŠ¡æ¥å£å’ŒStub
â””â”€â”€ å„ç§Message.java          # æ¯ä¸ªmessageå¯¹åº”ä¸€ä¸ªç±»

ç”Ÿæˆåä½ å°±å¯ä»¥åƒä½¿ç”¨æ™®é€šJavaç±»ä¸€æ ·ä½¿ç”¨è¿™äº›æ¶ˆæ¯äº†ï¼
```

---

## 4. ğŸ”„ å››ç§æœåŠ¡ç±»å‹è¯¦è§£


### 4.1 æœåŠ¡ç±»å‹æ¦‚è¿°


```
gRPCçš„å››ç§äº¤æµæ–¹å¼å°±åƒä¸åŒçš„å¯¹è¯æ¨¡å¼ï¼š

1. Unary         - ä¸€é—®ä¸€ç­”ï¼ˆæ‰“ç”µè¯é—®å¤©æ°”ï¼‰
2. Server Stream - æˆ‘é—®ä½ æŒç»­å›ç­”ï¼ˆè‚¡ç¥¨å®æ—¶ä»·æ ¼ï¼‰  
3. Client Stream - æˆ‘æŒç»­è¯´ä½ æœ€åå›ç­”ï¼ˆä¸Šä¼ æ–‡ä»¶ï¼‰
4. Bidirectional - æˆ‘ä»¬æŒç»­å¯¹è¯ï¼ˆèŠå¤©å®¤ï¼‰
```

### 4.2 Unary RPC - ç®€å•è¯·æ±‚å“åº”


**ğŸ”¸ ä½¿ç”¨åœºæ™¯**ï¼šå¤§éƒ¨åˆ†APIè°ƒç”¨éƒ½æ˜¯è¿™ç§æ¨¡å¼

```protobuf
// å®šä¹‰æœåŠ¡
service UserService {
    rpc GetUser(GetUserRequest) returns (UserResponse);
}
```

```java
// æœåŠ¡ç«¯å®ç°
@Override
public void getUser(GetUserRequest request, 
                   StreamObserver<UserResponse> responseObserver) {
    // 1. è·å–è¯·æ±‚æ•°æ®
    long userId = request.getUserId();
    
    // 2. æ‰§è¡Œä¸šåŠ¡é€»è¾‘
    User user = userRepository.findById(userId);
    
    // 3. æ„å»ºå“åº”
    UserResponse response = UserResponse.newBuilder()
        .setId(user.getId())
        .setName(user.getName())
        .setEmail(user.getEmail())
        .build();
    
    // 4. è¿”å›ç»“æœ
    responseObserver.onNext(response);
    responseObserver.onCompleted();
}

// å®¢æˆ·ç«¯è°ƒç”¨
UserResponse response = userStub.getUser(
    GetUserRequest.newBuilder().setUserId(123).build()
);
```

**ğŸ’¡ å…³é”®ç†è§£**ï¼š
- **å®¢æˆ·ç«¯**ï¼šå‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œç­‰å¾…ä¸€ä¸ªå“åº”
- **æœåŠ¡ç«¯**ï¼šæ¥æ”¶è¯·æ±‚ï¼Œå¤„ç†ä¸šåŠ¡é€»è¾‘ï¼Œè¿”å›ä¸€ä¸ªç»“æœ

### 4.3 Server Streaming - æœåŠ¡ç«¯æµ


**ğŸ”¸ ä½¿ç”¨åœºæ™¯**ï¼šéœ€è¦è¿”å›å¤§é‡æ•°æ®æˆ–å®æ—¶æ•°æ®æ¨é€

```protobuf
service StockService {
    // è·å–è‚¡ç¥¨å®æ—¶ä»·æ ¼ - æœåŠ¡ç«¯æŒç»­æ¨é€æ•°æ®
    rpc GetStockPrice(StockRequest) returns (stream StockPrice);
}
```

```java
// æœåŠ¡ç«¯å®ç° - æŒç»­å‘é€æ•°æ®
@Override
public void getStockPrice(StockRequest request,
                         StreamObserver<StockPrice> responseObserver) {
    String symbol = request.getSymbol();
    
    // æ¨¡æ‹ŸæŒç»­æ¨é€è‚¡ç¥¨ä»·æ ¼
    for (int i = 0; i < 10; i++) {
        StockPrice price = StockPrice.newBuilder()
            .setSymbol(symbol)
            .setPrice(100.0 + Math.random() * 50)
            .setTimestamp(System.currentTimeMillis())
            .build();
            
        // å‘é€ä¸€æ¡æ•°æ®
        responseObserver.onNext(price);
        
        // ç­‰å¾…1ç§’å†å‘é€ä¸‹ä¸€æ¡
        Thread.sleep(1000);
    }
    
    // è¡¨ç¤ºæ•°æ®å‘é€å®Œæ¯•
    responseObserver.onCompleted();
}

// å®¢æˆ·ç«¯æ¥æ”¶æµæ•°æ®
Iterator<StockPrice> priceStream = stockStub.getStockPrice(
    StockRequest.newBuilder().setSymbol("AAPL").build()
);

while (priceStream.hasNext()) {
    StockPrice price = priceStream.next();
    System.out.println("è‚¡ç¥¨ä»·æ ¼: " + price.getPrice());
}
```

**ğŸ’¡ æµçš„æ¦‚å¿µ**ï¼š
- å°±åƒæ°´é¾™å¤´å‡ºæ°´ï¼ŒæœåŠ¡ç«¯æŒç»­"æµå‡º"æ•°æ®
- å®¢æˆ·ç«¯æŒç»­æ¥æ”¶ï¼Œç›´åˆ°æœåŠ¡ç«¯å…³é—­æµ

### 4.4 Client Streaming - å®¢æˆ·ç«¯æµ


**ğŸ”¸ ä½¿ç”¨åœºæ™¯**ï¼šä¸Šä¼ å¤§æ–‡ä»¶ã€æ‰¹é‡æ•°æ®æäº¤

```protobuf
service FileService {
    // ä¸Šä¼ æ–‡ä»¶ - å®¢æˆ·ç«¯åˆ†å—ä¸Šä¼ 
    rpc UploadFile(stream FileChunk) returns (UploadResponse);
}
```

```java
// æœåŠ¡ç«¯æ¥æ”¶æµæ•°æ®
@Override
public StreamObserver<FileChunk> uploadFile(
    StreamObserver<UploadResponse> responseObserver) {
    
    return new StreamObserver<FileChunk>() {
        private ByteArrayOutputStream fileData = new ByteArrayOutputStream();
        
        @Override
        public void onNext(FileChunk chunk) {
            // æ¥æ”¶æ¯ä¸ªæ–‡ä»¶å—
            try {
                fileData.write(chunk.getData().toByteArray());
                System.out.println("æ¥æ”¶åˆ°æ–‡ä»¶å—ï¼Œå¤§å°: " + chunk.getData().size());
            } catch (IOException e) {
                onError(e);
            }
        }
        
        @Override
        public void onCompleted() {
            // å®¢æˆ·ç«¯å‘é€å®Œæ¯•ï¼Œä¿å­˜æ–‡ä»¶
            try {
                Files.write(Paths.get("uploaded_file.dat"), fileData.toByteArray());
                
                UploadResponse response = UploadResponse.newBuilder()
                    .setSuccess(true)
                    .setMessage("æ–‡ä»¶ä¸Šä¼ æˆåŠŸ")
                    .build();
                    
                responseObserver.onNext(response);
                responseObserver.onCompleted();
            } catch (IOException e) {
                responseObserver.onError(e);
            }
        }
        
        @Override
        public void onError(Throwable t) {
            System.err.println("ä¸Šä¼ å‡ºé”™: " + t.getMessage());
        }
    };
}
```

### 4.5 Bidirectional Streaming - åŒå‘æµ


**ğŸ”¸ ä½¿ç”¨åœºæ™¯**ï¼šèŠå¤©å®¤ã€å®æ—¶åä½œã€æ¸¸æˆ

```protobuf
service ChatService {
    // èŠå¤©å®¤ - åŒå‘å®æ—¶é€šä¿¡
    rpc Chat(stream ChatMessage) returns (stream ChatMessage);
}
```

```java
// æœåŠ¡ç«¯å®ç°åŒå‘æµ
private final Set<StreamObserver<ChatMessage>> clients = new HashSet<>();

@Override
public StreamObserver<ChatMessage> chat(
    StreamObserver<ChatMessage> responseObserver) {
    
    // æ–°å®¢æˆ·ç«¯åŠ å…¥
    clients.add(responseObserver);
    
    return new StreamObserver<ChatMessage>() {
        @Override
        public void onNext(ChatMessage message) {
            // å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰å®¢æˆ·ç«¯
            synchronized (clients) {
                for (StreamObserver<ChatMessage> client : clients) {
                    try {
                        client.onNext(message);
                    } catch (Exception e) {
                        // å®¢æˆ·ç«¯æ–­å¼€è¿æ¥ï¼Œç§»é™¤
                        clients.remove(client);
                    }
                }
            }
        }
        
        @Override
        public void onCompleted() {
            clients.remove(responseObserver);
        }
        
        @Override
        public void onError(Throwable t) {
            clients.remove(responseObserver);
        }
    };
}
```

**ğŸ”„ å››ç§ç±»å‹å¯¹æ¯”è¡¨**

| ç±»å‹ | **å®¢æˆ·ç«¯** | **æœåŠ¡ç«¯** | **å…¸å‹åœºæ™¯** | **å¤æ‚åº¦** |
|------|-----------|-----------|-------------|-----------|
| **Unary** | `å‘é€1æ¬¡è¯·æ±‚` | `è¿”å›1æ¬¡å“åº”` | `REST APIè°ƒç”¨` | `â­` |
| **Server Streaming** | `å‘é€1æ¬¡è¯·æ±‚` | `è¿”å›å¤šæ¬¡å“åº”` | `æ•°æ®æ¨é€ã€è®¢é˜…` | `â­â­` |
| **Client Streaming** | `å‘é€å¤šæ¬¡è¯·æ±‚` | `è¿”å›1æ¬¡å“åº”` | `æ–‡ä»¶ä¸Šä¼ ã€æ‰¹é‡æäº¤` | `â­â­` |
| **Bidirectional** | `å‘é€å¤šæ¬¡è¯·æ±‚` | `è¿”å›å¤šæ¬¡å“åº”` | `èŠå¤©ã€å®æ—¶åä½œ` | `â­â­â­` |

---

## 5. ğŸ’» å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å®ç°


### 5.1 æœåŠ¡ç«¯å®Œæ•´å®ç°


```java
// UserServiceImpl.java - æœåŠ¡å®ç°
public class UserServiceImpl extends UserServiceGrpc.UserServiceImplBase {
    
    private final UserRepository userRepository;
    
    public UserServiceImpl(UserRepository userRepository) {
        this.userRepository = userRepository;
    }
    
    @Override
    public void getUser(GetUserRequest request,
                       StreamObserver<UserResponse> responseObserver) {
        try {
            // 1. å‚æ•°éªŒè¯
            if (request.getUserId() <= 0) {
                responseObserver.onError(Status.INVALID_ARGUMENT
                    .withDescription("ç”¨æˆ·IDå¿…é¡»å¤§äº0")
                    .asRuntimeException());
                return;
            }
            
            // 2. ä¸šåŠ¡é€»è¾‘
            User user = userRepository.findById(request.getUserId());
            if (user == null) {
                responseObserver.onError(Status.NOT_FOUND
                    .withDescription("ç”¨æˆ·ä¸å­˜åœ¨")
                    .asRuntimeException());
                return;
            }
            
            // 3. æ„å»ºå“åº”
            UserResponse response = UserResponse.newBuilder()
                .setId(user.getId())
                .setName(user.getName())
                .setEmail(user.getEmail())
                .setAge(user.getAge())
                .build();
            
            // 4. è¿”å›ç»“æœ
            responseObserver.onNext(response);
            responseObserver.onCompleted();
            
        } catch (Exception e) {
            responseObserver.onError(Status.INTERNAL
                .withDescription("æœåŠ¡å™¨å†…éƒ¨é”™è¯¯: " + e.getMessage())
                .asRuntimeException());
        }
    }
}

// GrpcServer.java - æœåŠ¡å™¨å¯åŠ¨
public class GrpcServer {
    private final int port;
    private final Server server;
    
    public GrpcServer(int port) {
        this.port = port;
        this.server = ServerBuilder.forPort(port)
            .addService(new UserServiceImpl(new UserRepository()))
            .build();
    }
    
    public void start() throws IOException {
        server.start();
        System.out.println("gRPCæœåŠ¡å™¨å·²å¯åŠ¨ï¼Œç›‘å¬ç«¯å£: " + port);
        
        // ä¼˜é›…å…³é—­
        Runtime.getRuntime().addShutdownHook(new Thread(() -> {
            System.out.println("æ­£åœ¨å…³é—­gRPCæœåŠ¡å™¨...");
            GrpcServer.this.stop();
        }));
    }
    
    public void stop() {
        if (server != null) {
            server.shutdown();
        }
    }
    
    // é˜»å¡ç­‰å¾…æœåŠ¡å™¨å…³é—­
    public void blockUntilShutdown() throws InterruptedException {
        if (server != null) {
            server.awaitTermination();
        }
    }
    
    public static void main(String[] args) throws Exception {
        GrpcServer server = new GrpcServer(9090);
        server.start();
        server.blockUntilShutdown();
    }
}
```

### 5.2 å®¢æˆ·ç«¯å®Œæ•´å®ç°


```java
// GrpcClient.java - å®¢æˆ·ç«¯
public class GrpcClient {
    private final ManagedChannel channel;
    private final UserServiceGrpc.UserServiceBlockingStub blockingStub;
    private final UserServiceGrpc.UserServiceStub asyncStub;
    
    public GrpcClient(String host, int port) {
        // åˆ›å»ºè¿æ¥é€šé“
        this.channel = ManagedChannelBuilder.forAddress(host, port)
            .usePlaintext()  // å¼€å‘ç¯å¢ƒä¸ä½¿ç”¨TLS
            .build();
            
        // åˆ›å»ºé˜»å¡å¼å®¢æˆ·ç«¯
        this.blockingStub = UserServiceGrpc.newBlockingStub(channel);
        // åˆ›å»ºå¼‚æ­¥å®¢æˆ·ç«¯
        this.asyncStub = UserServiceGrpc.newStub(channel);
    }
    
    // åŒæ­¥è°ƒç”¨ç¤ºä¾‹
    public void getUserSync(long userId) {
        try {
            GetUserRequest request = GetUserRequest.newBuilder()
                .setUserId(userId)
                .build();
                
            UserResponse response = blockingStub.getUser(request);
            
            System.out.println("ç”¨æˆ·ä¿¡æ¯: " + response.getName() + 
                             " (" + response.getEmail() + ")");
                             
        } catch (StatusRuntimeException e) {
            System.err.println("è°ƒç”¨å¤±è´¥: " + e.getStatus());
        }
    }
    
    // å¼‚æ­¥è°ƒç”¨ç¤ºä¾‹
    public void getUserAsync(long userId) {
        GetUserRequest request = GetUserRequest.newBuilder()
            .setUserId(userId)
            .build();
            
        asyncStub.getUser(request, new StreamObserver<UserResponse>() {
            @Override
            public void onNext(UserResponse response) {
                System.out.println("å¼‚æ­¥è·å–ç”¨æˆ·: " + response.getName());
            }
            
            @Override
            public void onError(Throwable t) {
                System.err.println("å¼‚æ­¥è°ƒç”¨å‡ºé”™: " + t.getMessage());
            }
            
            @Override
            public void onCompleted() {
                System.out.println("å¼‚æ­¥è°ƒç”¨å®Œæˆ");
            }
        });
    }
    
    public void shutdown() throws InterruptedException {
        channel.shutdown().awaitTermination(5, TimeUnit.SECONDS);
    }
    
    public static void main(String[] args) throws Exception {
        GrpcClient client = new GrpcClient("localhost", 9090);
        
        try {
            // åŒæ­¥è°ƒç”¨
            client.getUserSync(123);
            
            // å¼‚æ­¥è°ƒç”¨
            client.getUserAsync(456);
            Thread.sleep(1000); // ç­‰å¾…å¼‚æ­¥è°ƒç”¨å®Œæˆ
            
        } finally {
            client.shutdown();
        }
    }
}
```

### 5.3 æµ‹è¯•å’Œè¿è¡Œ


```bash
# 1. å¯åŠ¨æœåŠ¡ç«¯
java -cp target/classes GrpcServer

# è¾“å‡ºï¼šgRPCæœåŠ¡å™¨å·²å¯åŠ¨ï¼Œç›‘å¬ç«¯å£: 9090

# 2. è¿è¡Œå®¢æˆ·ç«¯æµ‹è¯•
java -cp target/classes GrpcClient

# è¾“å‡ºï¼šç”¨æˆ·ä¿¡æ¯: å¼ ä¸‰ (zhangsan@example.com)
```

**ğŸ’¡ è°ƒè¯•æŠ€å·§**ï¼š
```java
// æ·»åŠ æ—¥å¿—è®°å½•
private static final Logger logger = LoggerFactory.getLogger(UserServiceImpl.class);

@Override
public void getUser(GetUserRequest request, StreamObserver<UserResponse> responseObserver) {
    logger.info("æ¥æ”¶åˆ°è·å–ç”¨æˆ·è¯·æ±‚: userId={}", request.getUserId());
    // ... ä¸šåŠ¡é€»è¾‘
    logger.info("æˆåŠŸè¿”å›ç”¨æˆ·ä¿¡æ¯: name={}", response.getName());
}
```

---

## 6. âš¡ é«˜çº§ç‰¹æ€§åº”ç”¨


### 6.1 æ‹¦æˆªå™¨å¼€å‘


**ğŸ”¸ æ‹¦æˆªå™¨å°±åƒå®‰æ£€é—¨**ï¼šæ‰€æœ‰è¯·æ±‚éƒ½è¦ç»è¿‡æ£€æŸ¥

```java
// è®¤è¯æ‹¦æˆªå™¨ - æ£€æŸ¥ç”¨æˆ·èº«ä»½
public class AuthInterceptor implements ServerInterceptor {
    
    @Override
    public <ReqT, RespT> ServerCall.Listener<ReqT> interceptCall(
        ServerCall<ReqT, RespT> call,
        Metadata headers,
        ServerCallHandler<ReqT, RespT> next) {
        
        // è·å–è¯·æ±‚å¤´ä¸­çš„è®¤è¯ä¿¡æ¯
        String token = headers.get(Metadata.Key.of("authorization", Metadata.ASCII_STRING_MARSHALLER));
        
        if (token == null || !isValidToken(token)) {
            call.close(Status.UNAUTHENTICATED.withDescription("éœ€è¦è®¤è¯"), new Metadata());
            return new ServerCall.Listener<ReqT>() {};
        }
        
        // è®¤è¯é€šè¿‡ï¼Œç»§ç»­å¤„ç†è¯·æ±‚
        return next.startCall(call, headers);
    }
    
    private boolean isValidToken(String token) {
        // éªŒè¯tokençš„é€»è¾‘
        return "valid-token".equals(token);
    }
}

// åœ¨æœåŠ¡å™¨ä¸­æ·»åŠ æ‹¦æˆªå™¨
Server server = ServerBuilder.forPort(9090)
    .addService(new UserServiceImpl())
    .intercept(new AuthInterceptor())  // æ·»åŠ è®¤è¯æ‹¦æˆªå™¨
    .build();
```

### 6.2 å¥åº·æ£€æŸ¥


**ğŸ”¸ å¥åº·æ£€æŸ¥è®©ä½ çŸ¥é“æœåŠ¡æ˜¯å¦æ­£å¸¸**

```java
// æ·»åŠ å¥åº·æ£€æŸ¥æœåŠ¡
HealthStatusManager healthStatusManager = new HealthStatusManager();

Server server = ServerBuilder.forPort(9090)
    .addService(new UserServiceImpl())
    .addService(healthStatusManager.getHealthService())
    .build();

// è®¾ç½®æœåŠ¡å¥åº·çŠ¶æ€
healthStatusManager.setStatus("UserService", HealthCheckResponse.ServingStatus.SERVING);

// æ£€æŸ¥å¥åº·çŠ¶æ€çš„å®¢æˆ·ç«¯ä»£ç 
HealthGrpc.HealthBlockingStub healthStub = HealthGrpc.newBlockingStub(channel);
HealthCheckResponse response = healthStub.check(
    HealthCheckRequest.newBuilder().setService("UserService").build()
);

if (response.getStatus() == HealthCheckResponse.ServingStatus.SERVING) {
    System.out.println("æœåŠ¡è¿è¡Œæ­£å¸¸");
} else {
    System.out.println("æœåŠ¡ä¸å¯ç”¨");
}
```

### 6.3 è´Ÿè½½å‡è¡¡é…ç½®


```java
// å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡é…ç½®
ManagedChannel channel = ManagedChannelBuilder.forTarget("dns:///user-service:9090")
    .defaultLoadBalancingPolicy("round_robin")  // è½®è¯¢è´Ÿè½½å‡è¡¡
    .usePlaintext()
    .build();

// é…ç½®å¤šä¸ªæœåŠ¡ç«¯åœ°å€
NameResolverRegistry.getDefaultRegistry().register(new DnsNameResolverProvider());
```

---

## 7. ğŸš€ ç”Ÿäº§ç¯å¢ƒå®è·µ


### 7.1 æ€§èƒ½è°ƒä¼˜é…ç½®


```java
// æœåŠ¡ç«¯æ€§èƒ½ä¼˜åŒ–é…ç½®
Server server = NettyServerBuilder.forPort(9090)
    .addService(new UserServiceImpl())
    // çº¿ç¨‹æ± é…ç½®
    .executor(Executors.newFixedThreadPool(100))
    // è¿æ¥å‚æ•°è°ƒä¼˜
    .keepAliveTime(30, TimeUnit.SECONDS)
    .keepAliveTimeout(5, TimeUnit.SECONDS)
    .permitKeepAliveWithoutCalls(true)
    // æ¶ˆæ¯å¤§å°é™åˆ¶
    .maxInboundMessageSize(16 * 1024 * 1024)  // 16MB
    .build();

// å®¢æˆ·ç«¯è¿æ¥æ± é…ç½®
ManagedChannel channel = NettyChannelBuilder.forAddress("localhost", 9090)
    .keepAliveTime(30, TimeUnit.SECONDS)
    .keepAliveTimeout(5, TimeUnit.SECONDS)
    .keepAliveWithoutCalls(true)
    .maxInboundMessageSize(16 * 1024 * 1024)
    .usePlaintext()
    .build();
```

### 7.2 å¸¸è§é—®é¢˜æ’æŸ¥


**ğŸ”¸ é—®é¢˜1ï¼šè¿æ¥è¶…æ—¶**
```java
// ç—‡çŠ¶ï¼šå®¢æˆ·ç«¯è¿æ¥æœåŠ¡ç«¯è¶…æ—¶
// åŸå› ï¼šç½‘ç»œé—®é¢˜æˆ–æœåŠ¡ç«¯æœªå¯åŠ¨
// è§£å†³ï¼šæ·»åŠ è¶…æ—¶å’Œé‡è¯•é…ç½®

UserServiceGrpc.UserServiceBlockingStub stub = UserServiceGrpc.newBlockingStub(channel)
    .withDeadlineAfter(5, TimeUnit.SECONDS);  // è®¾ç½®5ç§’è¶…æ—¶
```

**ğŸ”¸ é—®é¢˜2ï¼šåºåˆ—åŒ–é”™è¯¯**
```bash
# ç—‡çŠ¶ï¼šprotoæ–‡ä»¶ä¿®æ”¹åå®¢æˆ·ç«¯æœåŠ¡ç«¯ä¸å…¼å®¹
# åŸå› ï¼šprotoç‰ˆæœ¬ä¸ä¸€è‡´
# è§£å†³ï¼šé‡æ–°ç”Ÿæˆå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä»£ç 

protoc --java_out=src/main/java user_service.proto
```

**ğŸ”¸ é—®é¢˜3ï¼šå†…å­˜æ³„æ¼**
```java
// ç—‡çŠ¶ï¼šé•¿æ—¶é—´è¿è¡Œåå†…å­˜å ç”¨è¿‡é«˜
// åŸå› ï¼šChannelæ²¡æœ‰æ­£ç¡®å…³é—­
// è§£å†³ï¼šç¡®ä¿å…³é—­è¿æ¥

public void shutdown() {
    try {
        channel.shutdown().awaitTermination(5, TimeUnit.SECONDS);
    } catch (InterruptedException e) {
        channel.shutdownNow();
    }
}
```

### 7.3 ç›‘æ§å’Œæ—¥å¿—


```java
// æ·»åŠ ç›‘æ§æŒ‡æ ‡
public class MetricsInterceptor implements ServerInterceptor {
    private final Counter requestCounter = Counter.build()
        .name("grpc_requests_total")
        .help("Total gRPC requests")
        .labelNames("method", "status")
        .register();
    
    @Override
    public <ReqT, RespT> ServerCall.Listener<ReqT> interceptCall(
        ServerCall<ReqT, RespT> call, Metadata headers, ServerCallHandler<ReqT, RespT> next) {
        
        String methodName = call.getMethodDescriptor().getFullMethodName();
        
        return new ForwardingServerCallListener.SimpleForwardingServerCallListener<ReqT>(
            next.startCall(call, headers)) {
            
            @Override
            public void onComplete() {
                requestCounter.labels(methodName, "success").inc();
                super.onComplete();
            }
            
            @Override
            public void onCancel() {
                requestCounter.labels(methodName, "cancelled").inc();
                super.onCancel();
            }
        };
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ gRPCæœ¬è´¨ï¼šè®©è¿œç¨‹è°ƒç”¨åƒæœ¬åœ°æ–¹æ³•è°ƒç”¨ä¸€æ ·ç®€å•
ğŸ”¸ Protobufï¼šå®šä¹‰æœåŠ¡æ¥å£å’Œæ•°æ®ç»“æ„çš„"åˆåŒ"
ğŸ”¸ å››ç§æœåŠ¡ç±»å‹ï¼šä¸€é—®ä¸€ç­”ã€æœåŠ¡ç«¯æµã€å®¢æˆ·ç«¯æµã€åŒå‘æµ
ğŸ”¸ ä»£ç ç”Ÿæˆï¼šprotoæ–‡ä»¶è‡ªåŠ¨ç”Ÿæˆå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä»£ç 
ğŸ”¸ é«˜çº§ç‰¹æ€§ï¼šæ‹¦æˆªå™¨ã€å¥åº·æ£€æŸ¥ã€è´Ÿè½½å‡è¡¡
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ gRPCçš„æ ¸å¿ƒä»·å€¼**
```
å¼€å‘æ•ˆç‡ï¼š
- å†™.protoæ–‡ä»¶å®šä¹‰æ¥å£
- è‡ªåŠ¨ç”Ÿæˆå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä»£ç 
- åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·è°ƒç”¨è¿œç¨‹æœåŠ¡

æ€§èƒ½ä¼˜åŠ¿ï¼š
- ä½¿ç”¨HTTP/2åè®®ï¼Œæ”¯æŒå¤šè·¯å¤ç”¨
- Protocol Buffersåºåˆ—åŒ–æ•ˆç‡é«˜
- æ”¯æŒæµå¼æ•°æ®ä¼ è¾“
```

**ğŸ”¹ ä½•æ—¶é€‰æ‹©gRPC**
```
âœ… é€‚åˆåœºæ™¯ï¼š
- å¾®æœåŠ¡å†…éƒ¨é€šä¿¡
- éœ€è¦é«˜æ€§èƒ½çš„æœåŠ¡è°ƒç”¨
- å¤šè¯­è¨€æœåŠ¡äº’ç›¸è°ƒç”¨
- éœ€è¦æµå¼æ•°æ®ä¼ è¾“

âŒ ä¸é€‚åˆåœºæ™¯ï¼š
- æµè§ˆå™¨ç›´æ¥è°ƒç”¨ï¼ˆéœ€è¦grpc-webï¼‰
- ç®€å•çš„RESTful API
- éœ€è¦äººç±»å¯è¯»çš„æ•°æ®æ ¼å¼
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ å¼€å‘æµç¨‹æ€»ç»“**
1. **è®¾è®¡é˜¶æ®µ**ï¼šç¼–å†™.protoæ–‡ä»¶å®šä¹‰æœåŠ¡æ¥å£
2. **ç”Ÿæˆä»£ç **ï¼šä½¿ç”¨protocç”Ÿæˆå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä»£ç 
3. **å®ç°æœåŠ¡**ï¼šç¼–å†™ä¸šåŠ¡é€»è¾‘å®ç°æœåŠ¡æ¥å£
4. **å¯åŠ¨æœåŠ¡**ï¼šé…ç½®å’Œå¯åŠ¨gRPCæœåŠ¡å™¨
5. **å®¢æˆ·ç«¯è°ƒç”¨**ï¼šä½¿ç”¨ç”Ÿæˆçš„stubè°ƒç”¨æœåŠ¡
6. **æµ‹è¯•éªŒè¯**ï¼šç«¯åˆ°ç«¯æµ‹è¯•ç¡®ä¿åŠŸèƒ½æ­£ç¡®

**ğŸ”§ æœ€ä½³å®è·µ**
- **æ¥å£è®¾è®¡**ï¼šä¿æŒæ¥å£ç®€æ´ï¼Œåˆç†ä½¿ç”¨æµå¼API
- **é”™è¯¯å¤„ç†**ï¼šä½¿ç”¨gRPCçŠ¶æ€ç è§„èŒƒé”™è¯¯ä¿¡æ¯
- **æ€§èƒ½ä¼˜åŒ–**ï¼šåˆç†é…ç½®è¿æ¥æ± å’Œè¶…æ—¶æ—¶é—´
- **ç›‘æ§å‘Šè­¦**ï¼šæ·»åŠ æ‹¦æˆªå™¨æ”¶é›†ç›‘æ§æŒ‡æ ‡
- **ç‰ˆæœ¬ç®¡ç†**ï¼šprotoæ–‡ä»¶å˜æ›´è¦å‘åå…¼å®¹

**æ ¸å¿ƒè®°å¿†**ï¼š
- gRPCè®©è¿œç¨‹è°ƒç”¨åƒæœ¬åœ°è°ƒç”¨ä¸€æ ·ç®€å•
- Protobufå®šä¹‰æ¥å£ï¼Œè‡ªåŠ¨ç”Ÿæˆä»£ç 
- å››ç§æœåŠ¡ç±»å‹åº”å¯¹ä¸åŒåœºæ™¯éœ€æ±‚  
- æ‹¦æˆªå™¨æä¾›æ¨ªåˆ‡å…³æ³¨ç‚¹æ”¯æŒ
- ç”Ÿäº§ç¯å¢ƒéœ€è¦è€ƒè™‘æ€§èƒ½å’Œç›‘æ§