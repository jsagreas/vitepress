---
title: 2ã€å¼‚æ­¥ç¼–ç¨‹ä¸å¹¶å‘ä¼˜åŒ–
---
## ğŸ“š ç›®å½•

1. [åŒæ­¥ä¸å¼‚æ­¥çš„æœ¬è´¨å·®å¼‚](#1-åŒæ­¥ä¸å¼‚æ­¥çš„æœ¬è´¨å·®å¼‚)
2. [å¼‚æ­¥è°ƒç”¨æå‡æ€§èƒ½çš„åŸç†](#2-å¼‚æ­¥è°ƒç”¨æå‡æ€§èƒ½çš„åŸç†)
3. [å¼‚æ­¥ç¼–ç¨‹æ¨¡å‹è¯¦è§£](#3-å¼‚æ­¥ç¼–ç¨‹æ¨¡å‹è¯¦è§£)
4. [å“åº”å¼ç¼–ç¨‹å®æˆ˜](#4-å“åº”å¼ç¼–ç¨‹å®æˆ˜)
5. [å¼‚æ­¥ç¼–ç¨‹çš„æŒ‘æˆ˜ä¸è§£å†³æ–¹æ¡ˆ](#5-å¼‚æ­¥ç¼–ç¨‹çš„æŒ‘æˆ˜ä¸è§£å†³æ–¹æ¡ˆ)
6. [RPCä¸­çš„å¼‚æ­¥åº”ç”¨å®è·µ](#6-rpcä¸­çš„å¼‚æ­¥åº”ç”¨å®è·µ)
7. [æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ](#7-æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”„ åŒæ­¥ä¸å¼‚æ­¥çš„æœ¬è´¨å·®å¼‚


### 1.1 ä»€ä¹ˆæ˜¯åŒæ­¥è°ƒç”¨ï¼Ÿ


**ğŸ¤” é€šä¿—ç†è§£**ï¼šå°±åƒæ‰“ç”µè¯ï¼Œä½ å¿…é¡»ç­‰å¯¹æ–¹æ¥å¬å¹¶å›ç­”å®Œï¼Œæ‰èƒ½ç»§ç»­è¯´è¯

```
åŒæ­¥è°ƒç”¨çš„æ‰§è¡Œè¿‡ç¨‹ï¼š
å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚ â†’ ç­‰å¾…æœåŠ¡å™¨å¤„ç† â†’ æ”¶åˆ°å“åº” â†’ ç»§ç»­æ‰§è¡Œåç»­ä»£ç 
     â†“              â†“                â†“            â†“
  ç«‹å³æ‰§è¡Œ        çº¿ç¨‹è¢«é˜»å¡        çº¿ç¨‹è§£é™¤é˜»å¡    ç»§ç»­ä¸šåŠ¡é€»è¾‘
```

**ğŸ“‹ åŒæ­¥è°ƒç”¨ç‰¹ç‚¹**ï¼š
- âœ… **ç®€å•ç›´è§‚**ï¼šä»£ç é€»è¾‘æ¸…æ™°ï¼Œå®¹æ˜“ç†è§£
- âœ… **é¡ºåºæ‰§è¡Œ**ï¼šä¸¥æ ¼æŒ‰ç…§ä»£ç é¡ºåºæ‰§è¡Œ
- âŒ **çº¿ç¨‹é˜»å¡**ï¼šè°ƒç”¨æœŸé—´çº¿ç¨‹æ— æ³•å¤„ç†å…¶ä»–ä»»åŠ¡
- âŒ **èµ„æºæµªè´¹**ï¼šå¤§é‡çº¿ç¨‹ç­‰å¾…IOæ“ä½œå®Œæˆ

```java
// å…¸å‹çš„åŒæ­¥RPCè°ƒç”¨
public String getUserInfo(String userId) {
    // çº¿ç¨‹åœ¨è¿™é‡Œç­‰å¾…ï¼Œä»€ä¹ˆéƒ½ä¸èƒ½åš
    String result = rpcClient.call("getUserService", userId);
    // åªæœ‰æ‹¿åˆ°ç»“æœæ‰èƒ½ç»§ç»­æ‰§è¡Œ
    return result;
}
```

### 1.2 ä»€ä¹ˆæ˜¯å¼‚æ­¥è°ƒç”¨ï¼Ÿ


**ğŸ¤” é€šä¿—ç†è§£**ï¼šå°±åƒå‘å¾®ä¿¡ï¼Œä½ å‘å®Œæ¶ˆæ¯å°±å¯ä»¥å»åšåˆ«çš„äº‹ï¼Œå¯¹æ–¹å›å¤äº†ä¼šé€šçŸ¥ä½ 

```
å¼‚æ­¥è°ƒç”¨çš„æ‰§è¡Œè¿‡ç¨‹ï¼š
å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚ â†’ ç«‹å³è¿”å›Future â†’ ç»§ç»­æ‰§è¡Œå…¶ä»–ä»»åŠ¡ â†’ åœ¨éœ€è¦æ—¶è·å–ç»“æœ
     â†“                â†“                â†“                â†“
  ç«‹å³æ‰§è¡Œ        ä¸ç­‰å¾…å“åº”        çº¿ç¨‹ç»§ç»­å·¥ä½œ      ä¸»åŠ¨æ£€æŸ¥æˆ–å›è°ƒé€šçŸ¥
```

**ğŸ“‹ å¼‚æ­¥è°ƒç”¨ç‰¹ç‚¹**ï¼š
- âœ… **éé˜»å¡**ï¼šçº¿ç¨‹ä¸ä¼šè¢«æŒ‚èµ·ç­‰å¾…
- âœ… **é«˜å¹¶å‘**ï¼šä¸€ä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªè¯·æ±‚
- âœ… **èµ„æºé«˜æ•ˆ**ï¼šå……åˆ†åˆ©ç”¨çº¿ç¨‹èµ„æº
- âŒ **å¤æ‚æ€§**ï¼šéœ€è¦å¤„ç†å›è°ƒã€çŠ¶æ€ç®¡ç†ç­‰

```java
// å…¸å‹çš„å¼‚æ­¥RPCè°ƒç”¨
public CompletableFuture<String> getUserInfoAsync(String userId) {
    // ç«‹å³è¿”å›ï¼Œçº¿ç¨‹ä¸ä¼šé˜»å¡
    return rpcClient.callAsync("getUserService", userId)
                   .thenApply(result -> {
                       // ç»“æœå›æ¥æ—¶è‡ªåŠ¨æ‰§è¡Œ
                       return processResult(result);
                   });
}
```

### 1.3 æ€§èƒ½å¯¹æ¯”ï¼šä¸€ä¸ªç”ŸåŠ¨çš„ä¾‹å­


**ğŸª å’–å•¡åº—ç±»æ¯”**ï¼š

```
åŒæ­¥æ¨¡å¼ï¼ˆä¼ ç»Ÿå’–å•¡åº—ï¼‰ï¼š
é¡¾å®¢Aç‚¹å• â†’ ç­‰å¾…åˆ¶ä½œ â†’ ä»˜æ¬¾èµ°äºº â†’ é¡¾å®¢Bæ‰èƒ½ç‚¹å•
         5åˆ†é’Ÿç­‰å¾…    æ’é˜Ÿç­‰å¾…

å¼‚æ­¥æ¨¡å¼ï¼ˆç°ä»£å’–å•¡åº—ï¼‰ï¼š
é¡¾å®¢Aç‚¹å• â†’ æ‹¿å·ç ç‰Œ â†’ å»åº§ä½ç­‰å¾… â†’ é¡¾å®¢Bç«‹å³ç‚¹å•
         åŒæ—¶åˆ¶ä½œ     å¹¶è¡Œå¤„ç†

ç»“æœï¼šå¼‚æ­¥æ¨¡å¼å¯ä»¥åŒæ—¶æœåŠ¡å¤šä¸ªé¡¾å®¢ï¼
```

**ğŸ“Š æ€§èƒ½æ•°æ®å¯¹æ¯”**ï¼š

| è°ƒç”¨æ–¹å¼ | **å•æ¬¡è€—æ—¶** | **å¹¶å‘å¤„ç†èƒ½åŠ›** | **ååé‡** | **èµ„æºåˆ©ç”¨ç‡** |
|---------|------------|----------------|-----------|--------------|
| ğŸŒ **åŒæ­¥è°ƒç”¨** | `100ms` | `1ä¸ªè¯·æ±‚/çº¿ç¨‹` | `ä½` | `çº¿ç¨‹å¤§é‡ç­‰å¾…ï¼Œæµªè´¹ä¸¥é‡` |
| âš¡ **å¼‚æ­¥è°ƒç”¨** | `100ms` | `æ•°ç™¾ä¸ªè¯·æ±‚/çº¿ç¨‹` | `é«˜` | `çº¿ç¨‹å……åˆ†åˆ©ç”¨ï¼Œæ•ˆç‡æé«˜` |

---

## 2. ğŸš€ å¼‚æ­¥è°ƒç”¨æå‡æ€§èƒ½çš„åŸç†


### 2.1 çº¿ç¨‹èµ„æºçš„åˆç†åˆ©ç”¨


**ğŸ¤” é—®é¢˜æœ¬è´¨**ï¼šä¸ºä»€ä¹ˆåŒæ­¥è°ƒç”¨æ€§èƒ½å·®ï¼Ÿ

```
ä¼ ç»ŸåŒæ­¥æ¨¡å¼çš„é—®é¢˜ï¼š
â”Œâ”€ çº¿ç¨‹1 â”€â”  â”Œâ”€ ç½‘ç»œIOç­‰å¾…100ms â”€â”  â”Œâ”€ å¤„ç†ç»“æœ â”€â”
â”‚ å‘èµ·è¯·æ±‚ â”‚â”€â”€â”‚     ä»€ä¹ˆéƒ½ä¸åš     â”‚â”€â”€â”‚   ç»§ç»­æ‰§è¡Œ   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  âŒ èµ„æºæµªè´¹ï¼

å¼‚æ­¥æ¨¡å¼çš„ä¼˜åŠ¿ï¼š
çº¿ç¨‹1: å‘èµ·è¯·æ±‚A â†’ å‘èµ·è¯·æ±‚B â†’ å‘èµ·è¯·æ±‚C â†’ å¤„ç†Açš„ç»“æœ â†’ å¤„ç†Bçš„ç»“æœ
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
ç½‘ç»œ:    Aç­‰å¾…100ms                Bç­‰å¾…100ms  Cç­‰å¾…100ms
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
ç»“æœ:   âœ… åŒæ—¶å¤„ç†3ä¸ªè¯·æ±‚ï¼      âœ… çº¿ç¨‹å§‹ç»ˆåœ¨å·¥ä½œï¼
```

### 2.2 å¼‚æ­¥è°ƒç”¨çš„æ ¸å¿ƒä¼˜åŠ¿


**ğŸ’¡ æ€§èƒ½æå‡çš„å…³é”®ç‚¹**ï¼š

1. **çº¿ç¨‹æ± å¤ç”¨**ï¼šå°‘é‡çº¿ç¨‹å¤„ç†å¤§é‡è¯·æ±‚
   ```java
   // å‡è®¾æœ‰10ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± 
   // åŒæ­¥ï¼šæœ€å¤šåŒæ—¶å¤„ç†10ä¸ªè¯·æ±‚
   // å¼‚æ­¥ï¼šå¯ä»¥åŒæ—¶å¤„ç†æ•°åƒä¸ªè¯·æ±‚
   ExecutorService executor = Executors.newFixedThreadPool(10);
   ```

2. **IOç­‰å¾…æ—¶é—´å¤ç”¨**ï¼šç­‰å¾…æœŸé—´å¤„ç†å…¶ä»–ä»»åŠ¡
   ```
   æ—¶é—´çº¿å¯¹æ¯”ï¼š
   åŒæ­¥ï¼šè¯·æ±‚1(100msç­‰å¾…) â†’ è¯·æ±‚2(100msç­‰å¾…) â†’ è¯·æ±‚3(100msç­‰å¾…) = 300ms
   å¼‚æ­¥ï¼šè¯·æ±‚1ã€2ã€3åŒæ—¶å‘èµ·(100msåå…¨éƒ¨è¿”å›) = 100ms
   ```

3. **å†…å­˜ä½¿ç”¨ä¼˜åŒ–**ï¼šé¿å…å¤§é‡çº¿ç¨‹æ ˆå†…å­˜å ç”¨
   ```
   åŒæ­¥æ¨¡å¼ï¼š1000ä¸ªå¹¶å‘ = 1000ä¸ªçº¿ç¨‹ â‰ˆ 1GBå†…å­˜
   å¼‚æ­¥æ¨¡å¼ï¼š1000ä¸ªå¹¶å‘ = 10ä¸ªçº¿ç¨‹ â‰ˆ 10MBå†…å­˜
   ```

### 2.3 ååé‡æå‡å®ä¾‹


**ğŸ“ˆ çœŸå®æ€§èƒ½æµ‹è¯•æ•°æ®**ï¼š

```
æµ‹è¯•åœºæ™¯ï¼šè°ƒç”¨è¿œç¨‹æœåŠ¡ï¼Œæ¯æ¬¡è€—æ—¶100ms
å¹¶å‘è¯·æ±‚æ•°ï¼š1000ä¸ª

åŒæ­¥è°ƒç”¨ç»“æœï¼š
â”œâ”€ ä½¿ç”¨çº¿ç¨‹ï¼š1000ä¸ª
â”œâ”€ æ€»è€—æ—¶ï¼šçº¦100ç§’ï¼ˆä¸²è¡Œæ‰§è¡Œï¼‰
â”œâ”€ ååé‡ï¼š10 QPS
â””â”€ å†…å­˜å ç”¨ï¼šçº¦1GB

å¼‚æ­¥è°ƒç”¨ç»“æœï¼š
â”œâ”€ ä½¿ç”¨çº¿ç¨‹ï¼š10ä¸ª
â”œâ”€ æ€»è€—æ—¶ï¼šçº¦100msï¼ˆå¹¶è¡Œæ‰§è¡Œï¼‰
â”œâ”€ ååé‡ï¼š10000 QPS
â””â”€ å†…å­˜å ç”¨ï¼šçº¦10MB

æ€§èƒ½æå‡ï¼š1000å€ï¼
```

---

## 3. ğŸ› ï¸ å¼‚æ­¥ç¼–ç¨‹æ¨¡å‹è¯¦è§£


### 3.1 Futureæ¨¡å¼ï¼šæœ€åŸºç¡€çš„å¼‚æ­¥


**ğŸ¤” ä»€ä¹ˆæ˜¯Futureï¼Ÿ**
Futureå°±åƒä¸€å¼ "æè´§å•"ï¼Œä½ ç°åœ¨æ‹¿åˆ°æè´§å•ï¼Œä½†çœŸæ­£çš„è´§ç‰©ç¨åæ‰èƒ½å–åˆ°ã€‚

```java
// Futureçš„åŸºæœ¬ä½¿ç”¨
public void futureExample() {
    ExecutorService executor = Executors.newFixedThreadPool(5);
    
    // æäº¤ä»»åŠ¡ï¼Œç«‹å³å¾—åˆ°Future"æè´§å•"
    Future<String> future = executor.submit(() -> {
        Thread.sleep(1000); // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
        return "ä»»åŠ¡å®Œæˆï¼";
    });
    
    // å¯ä»¥å…ˆåšå…¶ä»–äº‹æƒ…
    System.out.println("ä»»åŠ¡å·²æäº¤ï¼Œæˆ‘å»åšå…¶ä»–äº‹...");
    
    try {
        // éœ€è¦ç»“æœæ—¶å†"æè´§"
        String result = future.get(); // è¿™é‡Œä¼šç­‰å¾…ç›´åˆ°æœ‰ç»“æœ
        System.out.println("å¾—åˆ°ç»“æœï¼š" + result);
    } catch (Exception e) {
        e.printStackTrace();
    }
}
```

**ğŸ“‹ Futureçš„ç‰¹ç‚¹**ï¼š
- âœ… ç®€å•æ˜“æ‡‚ï¼Œå­¦ä¹ æˆæœ¬ä½
- âœ… æ ‡å‡†JDKæ”¯æŒï¼Œå…¼å®¹æ€§å¥½
- âŒ åŠŸèƒ½æœ‰é™ï¼Œä¸æ”¯æŒç»„åˆæ“ä½œ
- âŒ è·å–ç»“æœæ—¶ä»ä¼šé˜»å¡

### 3.2 CompletableFutureï¼šå¢å¼ºç‰ˆå¼‚æ­¥


**ğŸ¤” CompletableFutureè§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ**
å¦‚æœè¯´Futureæ˜¯"å•å‘æè´§å•"ï¼ŒCompletableFutureå°±æ˜¯"æ™ºèƒ½æè´§å•"ï¼Œè´§ç‰©åˆ°äº†ä¼šä¸»åŠ¨é€šçŸ¥ä½ ã€‚

```java
// CompletableFutureçš„å¼ºå¤§åŠŸèƒ½
public void completableFutureExample() {
    
    // å¼‚æ­¥æ‰§è¡Œä»»åŠ¡
    CompletableFuture<String> future1 = CompletableFuture.supplyAsync(() -> {
        // æ¨¡æ‹Ÿè°ƒç”¨ç”¨æˆ·æœåŠ¡
        return "ç”¨æˆ·ä¿¡æ¯ï¼šå¼ ä¸‰";
    });
    
    CompletableFuture<String> future2 = CompletableFuture.supplyAsync(() -> {
        // æ¨¡æ‹Ÿè°ƒç”¨è®¢å•æœåŠ¡  
        return "è®¢å•ä¿¡æ¯ï¼š3ä¸ªå•†å“";
    });
    
    // ç»„åˆä¸¤ä¸ªå¼‚æ­¥ç»“æœ
    CompletableFuture<String> combinedFuture = future1.thenCombine(future2, 
        (userInfo, orderInfo) -> {
            return "ç”¨æˆ·ï¼š" + userInfo + "ï¼Œ" + orderInfo;
        });
    
    // å¼‚æ­¥å¤„ç†æœ€ç»ˆç»“æœï¼Œä¸é˜»å¡å½“å‰çº¿ç¨‹
    combinedFuture.thenAccept(result -> {
        System.out.println("æœ€ç»ˆç»“æœï¼š" + result);
    });
    
    System.out.println("æˆ‘ä¸ç”¨ç­‰å¾…ï¼Œç»§ç»­æ‰§è¡Œå…¶ä»–é€»è¾‘...");
}
```

**ğŸ”§ CompletableFutureçš„æ ¸å¿ƒæ–¹æ³•**ï¼š

```java
// åˆ›å»ºå¼‚æ­¥ä»»åŠ¡
CompletableFuture.supplyAsync(() -> "è¿”å›å€¼")    // æœ‰è¿”å›å€¼
CompletableFuture.runAsync(() -> {})             // æ— è¿”å›å€¼

// ä¸²è”æ“ä½œï¼ˆä¸Šä¸€æ­¥å®Œæˆåæ‰§è¡Œï¼‰
.thenApply(result -> "è½¬æ¢ç»“æœ")                 // è½¬æ¢ç»“æœ
.thenAccept(result -> {})                       // æ¶ˆè´¹ç»“æœ
.thenRun(() -> {})                              // æ‰§è¡ŒåŠ¨ä½œ

// ç»„åˆæ“ä½œï¼ˆç­‰å¤šä¸ªä»»åŠ¡å®Œæˆï¼‰
.thenCombine(other, (r1, r2) -> "ç»„åˆç»“æœ")     // ç»„åˆä¸¤ä¸ªç»“æœ
.allOf(f1, f2, f3)                             // ç­‰å¾…æ‰€æœ‰å®Œæˆ
.anyOf(f1, f2, f3)                             // ç­‰å¾…ä»»æ„ä¸€ä¸ªå®Œæˆ
```

### 3.3 RxJavaï¼šå“åº”å¼ç¼–ç¨‹


**ğŸ¤” ä»€ä¹ˆæ˜¯å“åº”å¼ç¼–ç¨‹ï¼Ÿ**
æƒ³è±¡ä½ è®¢é˜…äº†ä¸€ä¸ªæ–°é—»æ¨é€ï¼Œæœ‰æ–°æ¶ˆæ¯æ—¶ä¼šè‡ªåŠ¨æ¨é€ç»™ä½ ï¼Œä½ å¯ä»¥é€‰æ‹©å¦‚ä½•å¤„ç†è¿™äº›æ¶ˆæ¯ã€‚

```java
// RxJavaçš„æµå¼å¤„ç†
public void rxJavaExample() {
    
    // åˆ›å»ºæ•°æ®æµ
    Observable<String> userIds = Observable.just("user1", "user2", "user3");
    
    userIds
        .flatMap(userId -> {
            // å¼‚æ­¥è°ƒç”¨RPCæœåŠ¡
            return Observable.fromCallable(() -> rpcService.getUser(userId))
                           .subscribeOn(Schedulers.io()); // åœ¨IOçº¿ç¨‹æ‰§è¡Œ
        })
        .filter(user -> user.isActive()) // è¿‡æ»¤æ´»è·ƒç”¨æˆ·
        .map(user -> user.getName())     // æå–ç”¨æˆ·å
        .observeOn(AndroidSchedulers.mainThread()) // åˆ‡æ¢åˆ°ä¸»çº¿ç¨‹
        .subscribe(
            userName -> System.out.println("æ´»è·ƒç”¨æˆ·ï¼š" + userName),
            error -> System.err.println("å‡ºé”™äº†ï¼š" + error)
        );
}
```

**ğŸ“‹ RxJavaé€‚ç”¨åœºæ™¯**ï¼š
- âœ… éœ€è¦å¤„ç†æ•°æ®æµçš„åœºæ™¯
- âœ… å¤æ‚çš„å¼‚æ­¥æ“ä½œç»„åˆ
- âœ… äº‹ä»¶é©±åŠ¨çš„ç¼–ç¨‹æ¨¡å¼
- âŒ å­¦ä¹ æˆæœ¬è¾ƒé«˜
- âŒ è°ƒè¯•ç›¸å¯¹å›°éš¾

### 3.4 åç¨‹ï¼šæœ€ä¼˜é›…çš„å¼‚æ­¥


**ğŸ¤” ä»€ä¹ˆæ˜¯åç¨‹ï¼Ÿ**
åç¨‹è®©å¼‚æ­¥ä»£ç å†™èµ·æ¥åƒåŒæ­¥ä»£ç ä¸€æ ·ç®€å•ï¼Œä½†æ‰§è¡Œèµ·æ¥å´æ˜¯å¼‚æ­¥çš„ã€‚

```kotlin
// Kotlinåç¨‹ç¤ºä¾‹
suspend fun getUserOrderInfo(userId: String): String {
    
    // çœ‹èµ·æ¥æ˜¯åŒæ­¥ä»£ç ï¼Œå®é™…æ˜¯å¼‚æ­¥æ‰§è¡Œ
    val userInfo = async { rpcService.getUser(userId) }
    val orderInfo = async { rpcService.getOrders(userId) }
    
    // ç­‰å¾…ä¸¤ä¸ªå¼‚æ­¥è°ƒç”¨å®Œæˆ
    val user = userInfo.await()
    val orders = orderInfo.await()
    
    return "ç”¨æˆ·ï¼š${user.name}ï¼Œè®¢å•æ•°ï¼š${orders.size}"
}

// ä½¿ç”¨åç¨‹
fun main() {
    runBlocking {
        val result = getUserOrderInfo("12345")
        println(result)
    }
}
```

**ğŸŒŸ åç¨‹çš„ä¼˜åŠ¿**ï¼š
- âœ… ä»£ç ç®€æ´ï¼Œæ˜“äºç†è§£
- âœ… æ€§èƒ½ä¼˜å¼‚ï¼Œè½»é‡çº§çº¿ç¨‹
- âœ… å¼‚å¸¸å¤„ç†æœºåˆ¶å®Œå–„
- âŒ è¯­è¨€æ”¯æŒæœ‰é™ï¼ˆKotlinã€Goç­‰ï¼‰

---

## 4. ğŸŒŠ å“åº”å¼ç¼–ç¨‹å®æˆ˜


### 4.1 èƒŒå‹å¤„ç†ï¼šé˜²æ­¢ç³»ç»Ÿè¿‡è½½


**ğŸ¤” ä»€ä¹ˆæ˜¯èƒŒå‹é—®é¢˜ï¼Ÿ**
æƒ³è±¡ä¸€ä¸ªæ°´ç®¡ï¼Œå¦‚æœæ°´æµå…¥çš„é€Ÿåº¦æ¯”æµå‡ºé€Ÿåº¦å¿«ï¼Œæ°´ç®¡å°±ä¼šçˆ†è£‚ã€‚åœ¨ç¼–ç¨‹ä¸­ï¼Œæ•°æ®ç”Ÿäº§é€Ÿåº¦è¶…è¿‡å¤„ç†é€Ÿåº¦æ—¶ï¼Œå°±ä¼šå‡ºç°èƒŒå‹é—®é¢˜ã€‚

```java
// èƒŒå‹é—®é¢˜çš„è§£å†³æ–¹æ¡ˆ
public void backpressureExample() {
    
    Flowable<String> dataStream = Flowable.create(emitter -> {
        // å¿«é€Ÿç”Ÿäº§æ•°æ®
        for (int i = 0; i < 1000000; i++) {
            emitter.onNext("æ•°æ®" + i);
        }
        emitter.onComplete();
    }, BackpressureStrategy.BUFFER); // ç¼“å†²ç­–ç•¥
    
    dataStream
        .onBackpressureBuffer(1000)  // é™åˆ¶ç¼“å†²åŒºå¤§å°
        .observeOn(Schedulers.computation())
        .subscribe(
            data -> {
                // æ…¢é€Ÿå¤„ç†æ•°æ®
                Thread.sleep(10);
                System.out.println("å¤„ç†ï¼š" + data);
            },
            error -> System.err.println("èƒŒå‹é”™è¯¯ï¼š" + error)
        );
}
```

**ğŸ›¡ï¸ èƒŒå‹å¤„ç†ç­–ç•¥**ï¼š

| ç­–ç•¥ | **è¯´æ˜** | **é€‚ç”¨åœºæ™¯** |
|-----|---------|-------------|
| `BUFFER` | `ç¼“å­˜æ‰€æœ‰æ•°æ®` | `å†…å­˜å……è¶³ï¼Œæ•°æ®é‡è¦` |
| `DROP` | `ä¸¢å¼ƒæœ€æ–°æ•°æ®` | `å¯ä»¥ä¸¢å¤±éƒ¨åˆ†æ•°æ®` |
| `LATEST` | `åªä¿ç•™æœ€æ–°æ•°æ®` | `åªå…³å¿ƒæœ€æ–°çŠ¶æ€` |
| `ERROR` | `æŠ›å‡ºå¼‚å¸¸` | `ä¸å…è®¸æ•°æ®ä¸¢å¤±` |

### 4.2 æµå¼æ•°æ®å¤„ç†


**ğŸ¯ å®é™…åº”ç”¨åœºæ™¯ï¼šå®æ—¶æ—¥å¿—å¤„ç†**

```java
// å®æ—¶å¤„ç†RPCè°ƒç”¨æ—¥å¿—
public void streamProcessingExample() {
    
    Observable<RpcLog> logStream = getRpcLogStream();
    
    logStream
        .buffer(5, TimeUnit.SECONDS)          // 5ç§’ä¸€æ‰¹
        .flatMap(logs -> Observable.fromIterable(logs))
        .groupBy(log -> log.getServiceName()) // æŒ‰æœåŠ¡åˆ†ç»„
        .flatMap(grouped -> 
            grouped.scan(new ServiceStats(), (stats, log) -> {
                // ç´¯è®¡ç»Ÿè®¡ä¿¡æ¯
                stats.addLog(log);
                return stats;
            })
        )
        .filter(stats -> stats.getErrorRate() > 0.1) // é”™è¯¯ç‡è¶…è¿‡10%
        .subscribe(stats -> {
            // å‘é€å‘Šè­¦
            alertService.sendAlert("æœåŠ¡å¼‚å¸¸ï¼š" + stats.getServiceName() +
                                 "ï¼Œé”™è¯¯ç‡ï¼š" + stats.getErrorRate());
        });
}

// RPCæ—¥å¿—æ•°æ®ç±»
class RpcLog {
    private String serviceName;
    private boolean isSuccess;
    private long responseTime;
    // getter/setter...
}

// ç»Ÿè®¡ä¿¡æ¯ç±»
class ServiceStats {
    private int totalCalls;
    private int errorCalls;
    private String serviceName;
    
    public double getErrorRate() {
        return (double) errorCalls / totalCalls;
    }
    // å…¶ä»–æ–¹æ³•...
}
```

---

## 5. ğŸ˜° å¼‚æ­¥ç¼–ç¨‹çš„æŒ‘æˆ˜ä¸è§£å†³æ–¹æ¡ˆ


### 5.1 å›è°ƒåœ°ç‹±é—®é¢˜


**ğŸ¤” ä»€ä¹ˆæ˜¯å›è°ƒåœ°ç‹±ï¼Ÿ**
å½“å¼‚æ­¥è°ƒç”¨å±‚å±‚åµŒå¥—æ—¶ï¼Œä»£ç ä¼šå˜å¾—éå¸¸éš¾ä»¥é˜…è¯»å’Œç»´æŠ¤ï¼Œå°±åƒåœ°ç‹±ä¸€æ ·ç—›è‹¦ã€‚

```java
// âŒ å…¸å‹çš„å›è°ƒåœ°ç‹±
public void callbackHellExample(String userId) {
    
    // è·å–ç”¨æˆ·ä¿¡æ¯
    rpcService.getUserAsync(userId, new Callback<User>() {
        @Override
        public void onSuccess(User user) {
            // è·å–ç”¨æˆ·è®¢å•
            rpcService.getOrdersAsync(user.getId(), new Callback<List<Order>>() {
                @Override
                public void onSuccess(List<Order> orders) {
                    // è·å–è®¢å•è¯¦æƒ…
                    rpcService.getOrderDetailsAsync(orders.get(0).getId(), new Callback<OrderDetail>() {
                        @Override
                        public void onSuccess(OrderDetail detail) {
                            // ç»ˆäºå¾—åˆ°ç»“æœï¼
                            System.out.println("è®¢å•è¯¦æƒ…ï¼š" + detail);
                        }
                        
                        @Override
                        public void onError(Exception e) {
                            // é”™è¯¯å¤„ç†1
                        }
                    });
                }
                
                @Override
                public void onError(Exception e) {
                    // é”™è¯¯å¤„ç†2
                }
            });
        }
        
        @Override
        public void onError(Exception e) {
            // é”™è¯¯å¤„ç†3
        }
    });
}
```

**âœ… Promise/Futureæ¨¡å¼è§£å†³æ–¹æ¡ˆ**ï¼š

```java
// âœ… ä½¿ç”¨CompletableFutureé“¾å¼è°ƒç”¨
public CompletableFuture<OrderDetail> getOrderDetailChain(String userId) {
    
    return rpcService.getUserAsync(userId)
                    .thenCompose(user -> 
                        rpcService.getOrdersAsync(user.getId()))
                    .thenCompose(orders -> 
                        rpcService.getOrderDetailsAsync(orders.get(0).getId()))
                    .exceptionally(ex -> {
                        // ç»Ÿä¸€çš„é”™è¯¯å¤„ç†
                        System.err.println("è°ƒç”¨å¤±è´¥ï¼š" + ex.getMessage());
                        return null;
                    });
}
```

**ğŸŒŸ async/awaitæ¨¡å¼ï¼ˆåç¨‹é£æ ¼ï¼‰**ï¼š

```kotlin
// âœ… åç¨‹è®©å¼‚æ­¥ä»£ç åƒåŒæ­¥ä»£ç 
suspend fun getOrderDetail(userId: String): OrderDetail? {
    return try {
        val user = rpcService.getUser(userId)
        val orders = rpcService.getOrders(user.id)
        val detail = rpcService.getOrderDetails(orders[0].id)
        detail
    } catch (e: Exception) {
        println("è°ƒç”¨å¤±è´¥ï¼š${e.message}")
        null
    }
}
```

### 5.2 å¼‚æ­¥è°ƒç”¨çš„é”™è¯¯å¤„ç†


**ğŸš¨ å¼‚æ­¥é”™è¯¯å¤„ç†çš„æŒ‘æˆ˜**ï¼š
- é”™è¯¯å¯èƒ½åœ¨ä»»ä½•æ—¶å€™å‘ç”Ÿ
- é”™è¯¯å¤„ç†ä»£ç åˆ†æ•£åœ¨å„ä¸ªå›è°ƒä¸­
- å¾ˆéš¾è¿›è¡Œç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œé‡è¯•

**ğŸ’¡ æœ€ä½³å®è·µï¼šç»Ÿä¸€é”™è¯¯å¤„ç†**ï¼š

```java
// æ„å»ºé”™è¯¯å¤„ç†æœºåˆ¶
public class AsyncErrorHandler {
    
    public static <T> CompletableFuture<T> withRetry(
            Supplier<CompletableFuture<T>> supplier, 
            int maxRetries) {
        
        return supplier.get()
            .exceptionally(throwable -> {
                if (maxRetries > 0 && isRetryable(throwable)) {
                    // é€’å½’é‡è¯•
                    return withRetry(supplier, maxRetries - 1).join();
                } else {
                    // è®°å½•é”™è¯¯æ—¥å¿—
                    logger.error("å¼‚æ­¥è°ƒç”¨å¤±è´¥", throwable);
                    throw new RuntimeException(throwable);
                }
            });
    }
    
    private static boolean isRetryable(Throwable throwable) {
        // åˆ¤æ–­æ˜¯å¦å¯é‡è¯•ï¼ˆç½‘ç»œè¶…æ—¶ã€è¿æ¥å¤±è´¥ç­‰ï¼‰
        return throwable instanceof TimeoutException || 
               throwable instanceof ConnectException;
    }
}

// ä½¿ç”¨ç»Ÿä¸€é”™è¯¯å¤„ç†
CompletableFuture<User> userFuture = AsyncErrorHandler.withRetry(
    () -> rpcService.getUserAsync(userId), 
    3  // æœ€å¤šé‡è¯•3æ¬¡
);
```

### 5.3 å¼‚æ­¥è°ƒç”¨é“¾çš„ä¸Šä¸‹æ–‡ä¼ é€’


**ğŸ¤” ä¸Šä¸‹æ–‡ä¼ é€’é—®é¢˜**ï¼š
åœ¨å¼‚æ­¥è°ƒç”¨ä¸­ï¼Œå¦‚ä½•ä¼ é€’ç”¨æˆ·èº«ä»½ã€è¿½è¸ªIDã€äº‹åŠ¡ä¸Šä¸‹æ–‡ç­‰ä¿¡æ¯ï¼Ÿ

```java
// ä¸Šä¸‹æ–‡ä¼ é€’çš„è§£å†³æ–¹æ¡ˆ
public class AsyncContext {
    private static final ThreadLocal<Map<String, Object>> context = 
        new ThreadLocal<Map<String, Object>>() {
            @Override
            protected Map<String, Object> initialValue() {
                return new HashMap<>();
            }
        };
    
    public static void put(String key, Object value) {
        context.get().put(key, value);
    }
    
    public static <T> T get(String key) {
        return (T) context.get().get(key);
    }
    
    public static Map<String, Object> getAll() {
        return new HashMap<>(context.get());
    }
    
    public static void setAll(Map<String, Object> ctx) {
        context.get().clear();
        context.get().putAll(ctx);
    }
}

// å¼‚æ­¥è°ƒç”¨æ—¶ä¼ é€’ä¸Šä¸‹æ–‡
public CompletableFuture<String> processWithContext(String userId) {
    
    // ä¿å­˜å½“å‰ä¸Šä¸‹æ–‡
    Map<String, Object> currentContext = AsyncContext.getAll();
    
    return CompletableFuture.supplyAsync(() -> {
        // åœ¨å¼‚æ­¥çº¿ç¨‹ä¸­æ¢å¤ä¸Šä¸‹æ–‡
        AsyncContext.setAll(currentContext);
        
        String traceId = AsyncContext.get("traceId");
        System.out.println("å¤„ç†ç”¨æˆ·ï¼š" + userId + "ï¼Œè¿½è¸ªIDï¼š" + traceId);
        
        return rpcService.getUser(userId);
    });
}
```

---

## 6. ğŸ¯ RPCä¸­çš„å¼‚æ­¥åº”ç”¨å®è·µ


### 6.1 å®¢æˆ·ç«¯å¼‚æ­¥è°ƒç”¨å®ç°


**ğŸ“ å¼‚æ­¥RPCå®¢æˆ·ç«¯è®¾è®¡**ï¼š

```java
public class AsyncRpcClient {
    
    private final ExecutorService executor = Executors.newFixedThreadPool(20);
    private final Map<String, CompletableFuture<Object>> pendingCalls = 
        new ConcurrentHashMap<>();
    
    // å¼‚æ­¥è°ƒç”¨æ–¹æ³•
    public <T> CompletableFuture<T> callAsync(String serviceName, 
                                             String methodName, 
                                             Object... args) {
        
        // ç”Ÿæˆè¯·æ±‚ID
        String requestId = generateRequestId();
        
        // åˆ›å»ºFutureç”¨äºè¿”å›ç»“æœ
        CompletableFuture<T> future = new CompletableFuture<>();
        pendingCalls.put(requestId, (CompletableFuture<Object>) future);
        
        // å¼‚æ­¥å‘é€è¯·æ±‚
        executor.submit(() -> {
            try {
                RpcRequest request = new RpcRequest(requestId, serviceName, methodName, args);
                sendRequest(request);
            } catch (Exception e) {
                future.completeExceptionally(e);
                pendingCalls.remove(requestId);
            }
        });
        
        return future;
    }
    
    // å¤„ç†å“åº”
    public void handleResponse(RpcResponse response) {
        CompletableFuture<Object> future = pendingCalls.remove(response.getRequestId());
        if (future != null) {
            if (response.hasError()) {
                future.completeExceptionally(new RuntimeException(response.getError()));
            } else {
                future.complete(response.getResult());
            }
        }
    }
}
```

### 6.2 æœåŠ¡ç«¯å¼‚æ­¥å¤„ç†


**ğŸ–¥ï¸ å¼‚æ­¥æœåŠ¡ç«¯å®ç°**ï¼š

```java
public class AsyncRpcServer {
    
    private final ExecutorService businessExecutor = Executors.newFixedThreadPool(50);
    
    public void handleRequest(RpcRequest request, Channel channel) {
        
        // ç«‹å³è¿”å›ï¼Œä¸é˜»å¡ç½‘ç»œçº¿ç¨‹
        businessExecutor.submit(() -> {
            try {
                // å¼‚æ­¥æ‰§è¡Œä¸šåŠ¡é€»è¾‘
                Object result = invokeService(request);
                
                // æ„é€ å“åº”
                RpcResponse response = new RpcResponse(request.getRequestId(), result);
                
                // å†™å›å“åº”
                channel.writeAndFlush(response);
                
            } catch (Exception e) {
                RpcResponse errorResponse = new RpcResponse(request.getRequestId(), e);
                channel.writeAndFlush(errorResponse);
            }
        });
    }
    
    private Object invokeService(RpcRequest request) {
        // å®é™…çš„æœåŠ¡è°ƒç”¨é€»è¾‘
        return serviceRegistry.getService(request.getServiceName())
                             .invoke(request.getMethodName(), request.getArgs());
    }
}
```

### 6.3 æ‰¹é‡è°ƒç”¨ä¼˜åŒ–


**ğŸš€ æ‰¹é‡å¼‚æ­¥è°ƒç”¨æå‡æ•ˆç‡**ï¼š

```java
public class BatchAsyncCaller {
    
    // æ‰¹é‡è·å–ç”¨æˆ·ä¿¡æ¯
    public CompletableFuture<List<User>> getUsersBatch(List<String> userIds) {
        
        // å°†ç”¨æˆ·IDåˆ†æ‰¹å¤„ç†
        List<List<String>> batches = partition(userIds, 50); // æ¯æ‰¹50ä¸ª
        
        // å¹¶è¡Œå¤„ç†æ¯ä¸€æ‰¹
        List<CompletableFuture<List<User>>> batchFutures = batches.stream()
            .map(batch -> rpcClient.callAsync("userService", "getUsersBatch", batch))
            .collect(Collectors.toList());
        
        // ç­‰å¾…æ‰€æœ‰æ‰¹æ¬¡å®Œæˆå¹¶åˆå¹¶ç»“æœ
        return CompletableFuture.allOf(batchFutures.toArray(new CompletableFuture[0]))
            .thenApply(v -> 
                batchFutures.stream()
                           .map(CompletableFuture::join)
                           .flatMap(List::stream)
                           .collect(Collectors.toList())
            );
    }
    
    // åˆ†æ‰¹å·¥å…·æ–¹æ³•
    private <T> List<List<T>> partition(List<T> list, int size) {
        List<List<T>> partitions = new ArrayList<>();
        for (int i = 0; i < list.size(); i += size) {
            partitions.add(list.subList(i, Math.min(i + size, list.size())));
        }
        return partitions;
    }
}
```

---

## 7. âœ¨ æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ


### 7.1 çº¿ç¨‹æ± é…ç½®ä¼˜åŒ–


**ğŸ¯ åˆç†é…ç½®çº¿ç¨‹æ± å‚æ•°**ï¼š

```java
public class OptimalThreadPoolConfig {
    
    // CPUå¯†é›†å‹ä»»åŠ¡ï¼šçº¿ç¨‹æ•° = CPUæ ¸å¿ƒæ•° + 1
    private static final ExecutorService cpuIntensivePool = 
        Executors.newFixedThreadPool(Runtime.getRuntime().availableProcessors() + 1);
    
    // IOå¯†é›†å‹ä»»åŠ¡ï¼šçº¿ç¨‹æ•° = CPUæ ¸å¿ƒæ•° * 2
    private static final ExecutorService ioIntensivePool = 
        new ThreadPoolExecutor(
            Runtime.getRuntime().availableProcessors() * 2,     // æ ¸å¿ƒçº¿ç¨‹æ•°
            Runtime.getRuntime().availableProcessors() * 4,     // æœ€å¤§çº¿ç¨‹æ•°  
            60L, TimeUnit.SECONDS,                              // ç©ºé—²æ—¶é—´
            new LinkedBlockingQueue<>(1000),                    // å·¥ä½œé˜Ÿåˆ—
            new ThreadFactory() {
                private final AtomicInteger counter = new AtomicInteger(1);
                @Override
                public Thread newThread(Runnable r) {
                    Thread t = new Thread(r, "async-rpc-" + counter.getAndIncrement());
                    t.setDaemon(true);
                    return t;
                }
            },
            new ThreadPoolExecutor.CallerRunsPolicy()           // æ‹’ç»ç­–ç•¥
        );
    
    public static ExecutorService getExecutor(boolean ioCpuIntensive) {
        return ioCpuIntensive ? cpuIntensivePool : ioIntensivePool;
    }
}
```

### 7.2 è¿æ¥æ± ç®¡ç†


**ğŸŠ å¼‚æ­¥è°ƒç”¨çš„è¿æ¥æ± ä¼˜åŒ–**ï¼š

```java
public class AsyncConnectionPool {
    
    private final Queue<Channel> availableConnections = new ConcurrentLinkedQueue<>();
    private final AtomicInteger totalConnections = new AtomicInteger(0);
    private final int maxConnections = 100;
    
    public CompletableFuture<Channel> getConnection() {
        
        // å°è¯•ä»æ± ä¸­è·å–ç°æœ‰è¿æ¥
        Channel channel = availableConnections.poll();
        if (channel != null && channel.isActive()) {
            return CompletableFuture.completedFuture(channel);
        }
        
        // å¦‚æœæ²¡æœ‰å¯ç”¨è¿æ¥ä¸”æœªè¾¾åˆ°æœ€å¤§æ•°é‡ï¼Œåˆ›å»ºæ–°è¿æ¥
        if (totalConnections.get() < maxConnections) {
            return createNewConnection();
        }
        
        // ç­‰å¾…è¿æ¥å¯ç”¨
        return waitForConnection();
    }
    
    private CompletableFuture<Channel> createNewConnection() {
        
        CompletableFuture<Channel> future = new CompletableFuture<>();
        
        Bootstrap bootstrap = new Bootstrap()
            .group(workerGroup)
            .channel(NioSocketChannel.class)
            .handler(new ChannelInitializer<SocketChannel>() {
                @Override
                protected void initChannel(SocketChannel ch) {
                    ch.pipeline()
                      .addLast(new RpcEncoder())
                      .addLast(new RpcDecoder())
                      .addLast(new AsyncRpcClientHandler());
                }
            });
        
        ChannelFuture connectFuture = bootstrap.connect(serverHost, serverPort);
        connectFuture.addListener((ChannelFutureListener) channelFuture -> {
            if (channelFuture.isSuccess()) {
                totalConnections.incrementAndGet();
                future.complete(channelFuture.channel());
            } else {
                future.completeExceptionally(channelFuture.cause());
            }
        });
        
        return future;
    }
    
    public void returnConnection(Channel channel) {
        if (channel.isActive()) {
            availableConnections.offer(channel);
        } else {
            totalConnections.decrementAndGet();
        }
    }
}
```

### 7.3 è¶…æ—¶å’Œé‡è¯•ç­–ç•¥


**â° æ™ºèƒ½è¶…æ—¶å’Œé‡è¯•æœºåˆ¶**ï¼š

```java
public class SmartRetryStrategy {
    
    public <T> CompletableFuture<T> callWithRetry(
            Supplier<CompletableFuture<T>> supplier,
            int maxRetries,
            Duration baseTimeout) {
        
        return callWithRetryInternal(supplier, maxRetries, baseTimeout, 1);
    }
    
    private <T> CompletableFuture<T> callWithRetryInternal(
            Supplier<CompletableFuture<T>> supplier,
            int retriesLeft,
            Duration baseTimeout,
            int attempt) {
        
        // æŒ‡æ•°é€€é¿ï¼šæ¯æ¬¡é‡è¯•è¶…æ—¶æ—¶é—´ç¿»å€
        Duration currentTimeout = baseTimeout.multipliedBy(1L << (attempt - 1));
        
        CompletableFuture<T> future = supplier.get();
        
        // è®¾ç½®è¶…æ—¶
        CompletableFuture<T> timeoutFuture = future
            .completeOnTimeout(null, currentTimeout.toMillis(), TimeUnit.MILLISECONDS);
        
        return timeoutFuture.handle((result, throwable) -> {
            if (throwable == null && result != null) {
                return CompletableFuture.completedFuture(result);
            }
            
            // åˆ¤æ–­æ˜¯å¦éœ€è¦é‡è¯•
            if (retriesLeft > 0 && shouldRetry(throwable)) {
                
                // ç­‰å¾…ä¸€æ®µæ—¶é—´å†é‡è¯•ï¼ˆé€€é¿ï¼‰
                long backoffMs = Math.min(1000 * (1L << (attempt - 1)), 10000);
                
                return CompletableFuture
                    .delayedExecutor(backoffMs, TimeUnit.MILLISECONDS)
                    .execute(() -> {})
                    .thenCompose(v -> callWithRetryInternal(
                        supplier, retriesLeft - 1, baseTimeout, attempt + 1));
            } else {
                // é‡è¯•æ¬¡æ•°ç”¨å®Œæˆ–ä¸å¯é‡è¯•é”™è¯¯
                CompletableFuture<T> failedFuture = new CompletableFuture<>();
                failedFuture.completeExceptionally(
                    throwable != null ? throwable : new TimeoutException());
                return failedFuture;
            }
        }).thenCompose(f -> f);
    }
    
    private boolean shouldRetry(Throwable throwable) {
        // ç½‘ç»œç›¸å…³é”™è¯¯å¯ä»¥é‡è¯•
        return throwable instanceof TimeoutException ||
               throwable instanceof ConnectException ||
               throwable instanceof IOException;
    }
}
```

### 7.4 ç›‘æ§å’ŒæŒ‡æ ‡


**ğŸ“Š å¼‚æ­¥è°ƒç”¨æ€§èƒ½ç›‘æ§**ï¼š

```java
public class AsyncRpcMetrics {
    
    private final Counter totalCalls = Counter.build()
        .name("rpc_calls_total")
        .help("Total RPC calls")
        .labelNames("service", "method", "status")
        .register();
        
    private final Histogram responseTime = Histogram.build()
        .name("rpc_response_time_seconds")
        .help("RPC response time")
        .labelNames("service", "method")
        .register();
        
    private final Gauge pendingCalls = Gauge.build()
        .name("rpc_pending_calls")
        .help("Number of pending RPC calls")
        .register();
    
    public <T> CompletableFuture<T> monitoredCall(
            String service, 
            String method,
            Supplier<CompletableFuture<T>> supplier) {
        
        Timer.Sample sample = Timer.start();
        pendingCalls.inc();
        
        return supplier.get()
            .whenComplete((result, throwable) -> {
                pendingCalls.dec();
                sample.stop(responseTime.labels(service, method));
                
                String status = throwable == null ? "success" : "error";
                totalCalls.labels(service, method, status).inc();
                
                if (throwable != null) {
                    logger.error("RPCè°ƒç”¨å¤±è´¥ - æœåŠ¡:{}, æ–¹æ³•:{}", service, method, throwable);
                }
            });
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ åŒæ­¥vså¼‚æ­¥ï¼šé˜»å¡ç­‰å¾…vséé˜»å¡æ‰§è¡Œçš„æœ¬è´¨åŒºåˆ«
ğŸ”¸ æ€§èƒ½æå‡åŸç†ï¼šçº¿ç¨‹å¤ç”¨ã€IOæ—¶é—´å¤ç”¨ã€å†…å­˜ä¼˜åŒ–
ğŸ”¸ å¼‚æ­¥ç¼–ç¨‹æ¨¡å‹ï¼šFutureã€CompletableFutureã€RxJavaã€åç¨‹
ğŸ”¸ å“åº”å¼ç¼–ç¨‹ï¼šèƒŒå‹å¤„ç†ã€æµå¼æ•°æ®å¤„ç†
ğŸ”¸ æŒ‘æˆ˜è§£å†³ï¼šå›è°ƒåœ°ç‹±ã€é”™è¯¯å¤„ç†ã€ä¸Šä¸‹æ–‡ä¼ é€’
ğŸ”¸ RPCåº”ç”¨ï¼šå®¢æˆ·ç«¯å¼‚æ­¥ã€æœåŠ¡ç«¯å¼‚æ­¥ã€æ‰¹é‡ä¼˜åŒ–
ğŸ”¸ æ€§èƒ½ä¼˜åŒ–ï¼šçº¿ç¨‹æ± é…ç½®ã€è¿æ¥æ± ç®¡ç†ã€é‡è¯•ç­–ç•¥
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å¼‚æ­¥çš„æœ¬è´¨ä¼˜åŠ¿**
```
èµ„æºåˆ©ç”¨ç‡ï¼š
- åŒæ­¥ï¼šçº¿ç¨‹å¤§é‡æ—¶é—´åœ¨ç­‰å¾…ï¼Œèµ„æºæµªè´¹
- å¼‚æ­¥ï¼šçº¿ç¨‹å§‹ç»ˆåœ¨å·¥ä½œï¼Œèµ„æºå……åˆ†åˆ©ç”¨

å¹¶å‘å¤„ç†èƒ½åŠ›ï¼š
- åŒæ­¥ï¼šå—é™äºçº¿ç¨‹æ•°é‡
- å¼‚æ­¥ï¼šå¯ä»¥å¤„ç†è¿œè¶…çº¿ç¨‹æ•°çš„å¹¶å‘è¯·æ±‚

ååé‡æå‡ï¼š
- åŒæ­¥ï¼šä¸²è¡Œå¤„ç†ï¼Œæ€§èƒ½çº¿æ€§å¢é•¿
- å¼‚æ­¥ï¼šå¹¶è¡Œå¤„ç†ï¼Œæ€§èƒ½æŒ‡æ•°å¢é•¿
```

**ğŸ”¹ é€‰æ‹©å¼‚æ­¥ç¼–ç¨‹æ¨¡å‹çš„è€ƒè™‘**
```
Futureï¼š
âœ… ç®€å•æ˜“ç”¨ï¼Œå­¦ä¹ æˆæœ¬ä½
âŒ åŠŸèƒ½æœ‰é™ï¼Œç»„åˆèƒ½åŠ›å·®

CompletableFutureï¼š
âœ… åŠŸèƒ½ä¸°å¯Œï¼Œç»„åˆèƒ½åŠ›å¼º
âœ… JDKåŸç”Ÿæ”¯æŒï¼Œå…¼å®¹æ€§å¥½
âŒ APIç¨å¤æ‚

RxJavaï¼š
âœ… æµå¼å¤„ç†ï¼ŒåŠŸèƒ½æœ€å¼ºå¤§
âŒ å­¦ä¹ æˆæœ¬é«˜ï¼Œè°ƒè¯•å›°éš¾

åç¨‹ï¼š
âœ… ä»£ç æœ€ç®€æ´ï¼Œæ€§èƒ½æœ€ä¼˜
âŒ è¯­è¨€æ”¯æŒæœ‰é™
```

**ğŸ”¹ å¼‚æ­¥ç¼–ç¨‹çš„æœ€ä½³å®è·µ**
```
è®¾è®¡åŸåˆ™ï¼š
- ä¼˜å…ˆä½¿ç”¨å¼‚æ­¥ï¼Œä½†ä¸è¦è¿‡åº¦å¼‚æ­¥åŒ–
- ç®€å•åœºæ™¯ç”¨Futureï¼Œå¤æ‚åœºæ™¯ç”¨CompletableFuture
- é‡è§†é”™è¯¯å¤„ç†å’Œè¶…æ—¶è®¾ç½®
- åšå¥½ç›‘æ§å’Œæ€§èƒ½è°ƒä¼˜

å¸¸è§é™·é˜±ï¼š
- å¿˜è®°å¤„ç†å¼‚å¸¸ï¼Œå¯¼è‡´è°ƒç”¨æ°¸è¿œä¸è¿”å›
- çº¿ç¨‹æ± é…ç½®ä¸å½“ï¼Œåè€Œé™ä½æ€§èƒ½  
- å¿½ç•¥èƒŒå‹é—®é¢˜ï¼Œå¯¼è‡´å†…å­˜æº¢å‡º
- ä¸Šä¸‹æ–‡ä¼ é€’ä¸å½“ï¼Œä¸¢å¤±é‡è¦ä¿¡æ¯
```

### 8.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¸šåŠ¡åœºæ™¯åº”ç”¨**
- **ç”µå•†ç³»ç»Ÿ**ï¼šå¼‚æ­¥æŸ¥è¯¢å•†å“ã€åº“å­˜ã€ä»·æ ¼ä¿¡æ¯å¹¶è¡Œç»„åˆ
- **ç¤¾äº¤åº”ç”¨**ï¼šå¼‚æ­¥åŠ è½½ç”¨æˆ·ä¿¡æ¯ã€å¥½å‹åŠ¨æ€ã€æ¨èå†…å®¹
- **é‡‘èç³»ç»Ÿ**ï¼šå¼‚æ­¥è°ƒç”¨é£æ§ã€å¾ä¿¡ã€é¢åº¦ç­‰å¤šä¸ªæœåŠ¡
- **å†…å®¹å¹³å°**ï¼šå¼‚æ­¥å¤„ç†è§†é¢‘è½¬ç ã€å›¾ç‰‡å¤„ç†ã€å†…å®¹å®¡æ ¸

**ğŸ”§ æŠ€æœ¯æ¶æ„æ”¶ç›Š**
- **æ€§èƒ½æå‡**ï¼šååé‡æå‡5-10å€ï¼Œå“åº”æ—¶é—´æ˜¾è‘—é™ä½
- **èµ„æºèŠ‚çœ**ï¼šæœåŠ¡å™¨æˆæœ¬é™ä½50-80%ï¼Œå†…å­˜å ç”¨å¤§å¹…å‡å°‘
- **å¯æ‰©å±•æ€§**ï¼šç³»ç»Ÿå¤„ç†èƒ½åŠ›éšä¸šåŠ¡å¢é•¿çº¿æ€§æ‰©å±•
- **ç”¨æˆ·ä½“éªŒ**ï¼šé¡µé¢åŠ è½½æ›´å¿«ï¼Œæ“ä½œå“åº”æ›´åŠæ—¶

**æ ¸å¿ƒè®°å¿†**ï¼š
- å¼‚æ­¥ç¼–ç¨‹æ˜¯æ€§èƒ½ä¼˜åŒ–çš„é“¶å¼¹ï¼Œä½†ä¸æ˜¯ä¸‡èƒ½è¯
- åˆç†é€‰æ‹©å¼‚æ­¥æ¨¡å‹ï¼Œé‡è§†é”™è¯¯å¤„ç†å’Œç›‘æ§
- ä»ç®€å•åœºæ™¯å¼€å§‹ï¼Œé€æ­¥æŒæ¡å¤æ‚çš„å¼‚æ­¥ç¼–ç¨‹æŠ€å·§
- å¼‚æ­¥åŒ–æ”¹é€ éœ€è¦å…¨é“¾è·¯è€ƒè™‘ï¼Œä¸èƒ½åªæ”¹ä¸€ä¸ªç¯èŠ‚