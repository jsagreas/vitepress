---
title: 4ã€æœåŠ¡é™çº§ä¸é™æµ
---
## ğŸ“š ç›®å½•

1. [æœåŠ¡é™çº§æ ¸å¿ƒæ¦‚å¿µ](#1-æœåŠ¡é™çº§æ ¸å¿ƒæ¦‚å¿µ)
2. [ç†”æ–­é™çº§æœºåˆ¶](#2-ç†”æ–­é™çº§æœºåˆ¶)
3. [é™çº§ç­–ç•¥ä¸è§¦å‘æ¡ä»¶](#3-é™çº§ç­–ç•¥ä¸è§¦å‘æ¡ä»¶)
4. [é™æµç®—æ³•è¯¦è§£](#4-é™æµç®—æ³•è¯¦è§£)
5. [é™æµç²’åº¦è®¾è®¡](#5-é™æµç²’åº¦è®¾è®¡)
6. [èƒŒå‹å¤„ç†æœºåˆ¶](#6-èƒŒå‹å¤„ç†æœºåˆ¶)
7. [è‡ªé€‚åº”é™æµç­–ç•¥](#7-è‡ªé€‚åº”é™æµç­–ç•¥)
8. [å®¹é”™ç­–ç•¥å¯¹æ¯”](#8-å®¹é”™ç­–ç•¥å¯¹æ¯”)
9. [æœ€ä½³å®è·µæŒ‡å—](#9-æœ€ä½³å®è·µæŒ‡å—)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ›¡ï¸ æœåŠ¡é™çº§æ ¸å¿ƒæ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯æœåŠ¡é™çº§


**é€šä¿—ç†è§£**ï¼šå°±åƒæ±½è½¦çˆ¬å¡æ—¶è‡ªåŠ¨é™æ¡£ä¸€æ ·ï¼Œå½“ç³»ç»Ÿå‹åŠ›å¤§æ—¶ï¼Œæš‚æ—¶å…³é—­ä¸€äº›éæ ¸å¿ƒåŠŸèƒ½ï¼Œä¿è¯ä¸»è¦åŠŸèƒ½æ­£å¸¸è¿è¡Œã€‚

```
æ—¥å¸¸ç”Ÿæ´»ä¾‹å­ï¼š
ğŸ¥ åŒ»é™¢æŒ‚å·ç³»ç»Ÿï¼š
æ­£å¸¸æ—¶ï¼šåœ¨çº¿æŒ‚å· + ä¸“å®¶æ¨è + ç—…å†æŸ¥è¯¢ + å¥åº·å’¨è¯¢
é«˜å³°æ—¶ï¼šåªä¿ç•™åœ¨çº¿æŒ‚å·ï¼Œå…¶ä»–åŠŸèƒ½æš‚åœ

ğŸ›’ ç”µå•†ç½‘ç«™åŒ11ï¼š
æ­£å¸¸æ—¶ï¼šå•†å“æµè§ˆ + æ¨èç®—æ³• + è¯„è®ºå±•ç¤º + ä¸ªæ€§åŒ–æœåŠ¡
é«˜å³°æ—¶ï¼šåªä¿ç•™å•†å“æµè§ˆå’Œä¸‹å•ï¼Œæ¨èç­‰åŠŸèƒ½é™çº§
```

**ğŸ”¸ æ ¸å¿ƒå®šä¹‰**
```
æœåŠ¡é™çº§ï¼šå½“ç³»ç»Ÿå‹åŠ›è¿‡å¤§æˆ–ä¾èµ–æœåŠ¡å¼‚å¸¸æ—¶ï¼Œ
ä¸»åŠ¨å…³é—­éƒ¨åˆ†åŠŸèƒ½æˆ–è¿”å›ç®€åŒ–ç»“æœï¼Œ
ç¡®ä¿æ ¸å¿ƒä¸šåŠ¡æ­£å¸¸è¿è¡Œçš„ä¿æŠ¤æœºåˆ¶ã€‚

ç›®æ ‡ï¼š
â€¢ ä¿æŠ¤ç³»ç»Ÿç¨³å®šæ€§
â€¢ ç¡®ä¿æ ¸å¿ƒåŠŸèƒ½å¯ç”¨
â€¢ é¿å…ç³»ç»Ÿå…¨é¢å´©æºƒ
â€¢ æä¾›åŸºç¡€æœåŠ¡èƒ½åŠ›
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦æœåŠ¡é™çº§


**ç³»ç»Ÿå‹åŠ›åœºæ™¯**ï¼š
```
ğŸ”¥ æµé‡æ¿€å¢ï¼š
åŒ11è´­ç‰©èŠ‚ â†’ æµé‡æ˜¯å¹³æ—¶çš„100å€
æ˜¥è¿æŠ¢ç¥¨ â†’ ç¬é—´ç™¾ä¸‡ç”¨æˆ·åŒæ—¶è®¿é—®
çƒ­ç‚¹äº‹ä»¶ â†’ æ–°é—»ç½‘ç«™è®¿é—®é‡æš´æ¶¨

âš ï¸ ä¾èµ–æ•…éšœï¼š
æ•°æ®åº“è¿æ¥è¶…æ—¶ â†’ æŸ¥è¯¢æœåŠ¡ä¸å¯ç”¨
ç¬¬ä¸‰æ–¹APIæ•…éšœ â†’ æ”¯ä»˜åŠŸèƒ½å—å½±å“
ç½‘ç»œåˆ†åŒº â†’ å¾®æœåŠ¡é—´é€šä¿¡å¼‚å¸¸
```

**ä¸é™çº§çš„åæœ**ï¼š
```
âŒ é›ªå´©æ•ˆåº”ï¼š
ä¸€ä¸ªæœåŠ¡æ•…éšœ â†’ è°ƒç”¨æ–¹æ’é˜Ÿç­‰å¾… â†’ èµ„æºè€—å°½ â†’ æ•´ä¸ªç³»ç»Ÿå´©æºƒ

âŒ èµ„æºæµªè´¹ï¼š
æ‰€æœ‰è¯·æ±‚éƒ½å°è¯•è°ƒç”¨æ•…éšœæœåŠ¡ â†’ CPUå’Œå†…å­˜æŒç»­æ¶ˆè€— â†’ ç³»ç»Ÿå“åº”å˜æ…¢

âŒ ç”¨æˆ·ä½“éªŒå·®ï¼š
é¡µé¢ä¸€ç›´è½¬åœˆ â†’ ç”¨æˆ·ç­‰å¾…æ—¶é—´è¿‡é•¿ â†’ æœ€ç»ˆè¶…æ—¶æŠ¥é”™
```

### 1.3 é™çº§çš„åŸºæœ¬æ€è·¯


**ğŸ”¸ ä¼˜å…ˆçº§åˆ’åˆ†**
```
æ ¸å¿ƒåŠŸèƒ½ï¼ˆç»å¯¹ä¸èƒ½é™çº§ï¼‰ï¼š
â€¢ ç”¨æˆ·ç™»å½•
â€¢ è®¢å•æ”¯ä»˜
â€¢ æ ¸å¿ƒä¸šåŠ¡æµç¨‹

é‡è¦åŠŸèƒ½ï¼ˆå¯ä»¥ç®€åŒ–ï¼‰ï¼š
â€¢ å•†å“æ¨è â†’ è¿”å›çƒ­é—¨å•†å“
â€¢ ä¸ªæ€§åŒ–å†…å®¹ â†’ è¿”å›é€šç”¨å†…å®¹
â€¢ å®æ—¶æ•°æ® â†’ è¿”å›ç¼“å­˜æ•°æ®

æ¬¡è¦åŠŸèƒ½ï¼ˆå¯ä»¥å…³é—­ï¼‰ï¼š
â€¢ è¯„è®ºåŠŸèƒ½
â€¢ åˆ†äº«åŠŸèƒ½
â€¢ ç»Ÿè®¡åˆ†æ
```

---

## 2. âš¡ ç†”æ–­é™çº§æœºåˆ¶


### 2.1 ç†”æ–­å™¨å·¥ä½œåŸç†


**é€šä¿—æ¯”å–»**ï¼šå°±åƒå®¶é‡Œçš„ä¿é™©ä¸ï¼Œå½“ç”µæµè¿‡å¤§æ—¶è‡ªåŠ¨æ–­å¼€ï¼Œä¿æŠ¤ç”µå™¨ä¸è¢«çƒ§åã€‚

```
å®¶ç”¨ä¿é™©ä¸ vs æœåŠ¡ç†”æ–­å™¨ï¼š

ä¿é™©ä¸ï¼š              æœåŠ¡ç†”æ–­å™¨ï¼š
ç”µæµè¿‡å¤§ â†’ è‡ªåŠ¨æ–­å¼€    æœåŠ¡å¼‚å¸¸ â†’ åœæ­¢è°ƒç”¨
ä¿æŠ¤ç”µå™¨è®¾å¤‡          ä¿æŠ¤è°ƒç”¨æ–¹ç³»ç»Ÿ
æ‰‹åŠ¨æ¢å¤ä¾›ç”µ          è‡ªåŠ¨å°è¯•æ¢å¤
```

**ğŸ”¸ ç†”æ–­å™¨çŠ¶æ€è½¬æ¢**
```
ä¸‰ç§çŠ¶æ€ï¼š

ğŸ’š å…³é—­çŠ¶æ€(Closed)ï¼š
æ­£å¸¸æƒ…å†µä¸‹ï¼Œæ‰€æœ‰è¯·æ±‚æ­£å¸¸é€šè¿‡
ç»Ÿè®¡æˆåŠŸ/å¤±è´¥æ¬¡æ•°

ğŸ”´ æ‰“å¼€çŠ¶æ€(Open)ï¼š
å¤±è´¥ç‡è¶…è¿‡é˜ˆå€¼ï¼Œç†”æ–­å™¨æ‰“å¼€
æ‰€æœ‰è¯·æ±‚ç›´æ¥è¿”å›å¤±è´¥ï¼Œä¸è°ƒç”¨æœåŠ¡

ğŸŸ¡ åŠå¼€çŠ¶æ€(Half-Open)ï¼š
ç»è¿‡ä¸€æ®µæ—¶é—´åï¼Œå…è®¸å°‘é‡è¯·æ±‚å°è¯•
å¦‚æœæˆåŠŸåˆ™æ¢å¤ï¼Œå¤±è´¥åˆ™ç»§ç»­ç†”æ–­
```

### 2.2 ç†”æ–­å™¨çŠ¶æ€è½¬æ¢å›¾


```
æ­£å¸¸æœåŠ¡è°ƒç”¨
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    å¤±è´¥ç‡è¶…é˜ˆå€¼    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å…³é—­çŠ¶æ€  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”‚ æ‰“å¼€çŠ¶æ€  â”‚
â”‚ (Closed) â”‚                  â”‚ (Open)   â”‚
â”‚æ­£å¸¸è°ƒç”¨   â”‚                  â”‚ç›´æ¥å¤±è´¥   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â–²                             â”‚
     â”‚ å°è¯•æˆåŠŸ                     â”‚ è¶…æ—¶åå°è¯•
     â”‚                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åŠå¼€çŠ¶æ€  â”‚                  â”‚          â”‚
â”‚(Half-Open)â”‚                  â”‚   ç­‰å¾…   â”‚
â”‚å°‘é‡å°è¯•   â”‚                  â”‚   æ¢å¤   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 ç†”æ–­å™¨é…ç½®å‚æ•°


```java
// ç®€åŒ–çš„ç†”æ–­å™¨é…ç½®ç¤ºä¾‹
@Component
public class CircuitBreakerConfig {
    
    // å¤±è´¥ç‡é˜ˆå€¼ï¼š50%å¤±è´¥å°±ç†”æ–­
    private double failureThreshold = 0.5;
    
    // æœ€å°è¯·æ±‚æ•°ï¼šè‡³å°‘10ä¸ªè¯·æ±‚æ‰å¼€å§‹ç»Ÿè®¡
    private int minimumRequestThreshold = 10;
    
    // ç­‰å¾…æ—¶é—´ï¼šç†”æ–­åç­‰å¾…30ç§’å†å°è¯•
    private long waitDurationInMillis = 30000;
    
    // åŠå¼€çŠ¶æ€å…è®¸çš„è¯·æ±‚æ•°
    private int permittedCallsInHalfOpenState = 3;
}
```

**ğŸ”¸ å…³é”®å‚æ•°è§£é‡Š**
```
å¤±è´¥ç‡é˜ˆå€¼ï¼š
â€¢ è®¾ç½®è¿‡ä½ï¼šæ­£å¸¸æŠ–åŠ¨å°±ç†”æ–­ï¼Œå½±å“ç”¨æˆ·ä½“éªŒ
â€¢ è®¾ç½®è¿‡é«˜ï¼šæœåŠ¡å·²ç»å¾ˆä¸ç¨³å®šäº†æ‰ç†”æ–­ï¼Œä¿æŠ¤æ•ˆæœå·®
â€¢ å»ºè®®ï¼š50%-70%

æœ€å°è¯·æ±‚æ•°ï¼š
â€¢ é¿å…å› ä¸ºå‡ ä¸ªè¯·æ±‚å¤±è´¥å°±è¯¯åˆ¤
â€¢ å»ºè®®ï¼š10-20ä¸ªè¯·æ±‚

ç­‰å¾…æ—¶é—´ï¼š
â€¢ ç»™ä¸‹æ¸¸æœåŠ¡æ¢å¤çš„æ—¶é—´
â€¢ å»ºè®®ï¼š30ç§’-2åˆ†é’Ÿ
```

---

## 3. ğŸ”„ é™çº§ç­–ç•¥ä¸è§¦å‘æ¡ä»¶


### 3.1 é™çº§ç­–ç•¥åˆ†ç±»


**ğŸ”¸ è¿”å›é»˜è®¤å€¼ç­–ç•¥**
```java
// å•†å“æ¨èæœåŠ¡é™çº§
public List<Product> getRecommendations(String userId) {
    try {
        return recommendationService.getPersonalized(userId);
    } catch (Exception e) {
        // é™çº§ï¼šè¿”å›çƒ­é—¨å•†å“
        return getHotProducts();
    }
}

private List<Product> getHotProducts() {
    // è¿”å›é¢„å…ˆå‡†å¤‡çš„çƒ­é—¨å•†å“åˆ—è¡¨
    return Arrays.asList(
        new Product("iPhone 15", "çƒ­é—¨æ‰‹æœº"),
        new Product("MacBook Pro", "çƒ­é—¨ç”µè„‘")
    );
}
```

**é€šä¿—ç†è§£**ï¼šå°±åƒé¤å…èœå“å–å®Œäº†ï¼Œæ¨èæ‹›ç‰Œèœä»£æ›¿ã€‚

**ğŸ”¸ è°ƒç”¨å¤‡ç”¨æœåŠ¡ç­–ç•¥**
```java
// æ”¯ä»˜æœåŠ¡é™çº§
public PaymentResult processPayment(PaymentRequest request) {
    try {
        // ä¼˜å…ˆä½¿ç”¨ä¸»æ”¯ä»˜é€šé“
        return primaryPaymentService.pay(request);
    } catch (Exception e) {
        try {
            // é™çº§åˆ°å¤‡ç”¨æ”¯ä»˜é€šé“
            return backupPaymentService.pay(request);
        } catch (Exception e2) {
            // æœ€ç»ˆé™çº§ï¼šå»¶è¿Ÿå¤„ç†
            return new PaymentResult("DELAYED", "æ”¯ä»˜å»¶è¿Ÿå¤„ç†");
        }
    }
}
```

**é€šä¿—ç†è§£**ï¼šå°±åƒä¸»æ”¶é“¶å°åäº†ï¼Œé¡¾å®¢å»å¤‡ç”¨æ”¶é“¶å°ç»“è´¦ã€‚

**ğŸ”¸ å¿«é€Ÿå¤±è´¥ç­–ç•¥**
```java
// éæ ¸å¿ƒåŠŸèƒ½å¿«é€Ÿå¤±è´¥
public String getUserAvatar(String userId) {
    if (avatarService.isCircuitBreakerOpen()) {
        // å¿«é€Ÿå¤±è´¥ï¼Œè¿”å›é»˜è®¤å¤´åƒ
        return "default-avatar.png";
    }
    
    try {
        return avatarService.getAvatar(userId);
    } catch (Exception e) {
        return "default-avatar.png";
    }
}
```

**é€šä¿—ç†è§£**ï¼šå°±åƒç”µæ¢¯åäº†ç›´æ¥èµ°æ¥¼æ¢¯ï¼Œä¸ç­‰ä¿®å¥½ã€‚

### 3.2 é™çº§è§¦å‘æ¡ä»¶


**ğŸ”¸ åŸºäºå“åº”æ—¶é—´**
```java
@Component
public class ResponseTimeBasedDegradation {
    
    private static final long TIMEOUT_THRESHOLD = 3000; // 3ç§’è¶…æ—¶
    
    public String callService() {
        long startTime = System.currentTimeMillis();
        
        try {
            String result = externalService.call();
            long duration = System.currentTimeMillis() - startTime;
            
            if (duration > TIMEOUT_THRESHOLD) {
                // å“åº”æ—¶é—´è¿‡é•¿ï¼Œæ ‡è®°é™çº§
                degradationManager.markSlow();
            }
            
            return result;
        } catch (TimeoutException e) {
            // è¶…æ—¶ç›´æ¥é™çº§
            return getFallbackResult();
        }
    }
}
```

**ğŸ”¸ åŸºäºé”™è¯¯ç‡**
```java
// é”™è¯¯ç‡ç»Ÿè®¡å™¨
public class ErrorRateMonitor {
    private int totalCalls = 0;
    private int errorCalls = 0;
    
    public boolean shouldDegrade() {
        if (totalCalls < 10) return false; // æ ·æœ¬å¤ªå°‘ä¸åˆ¤æ–­
        
        double errorRate = (double) errorCalls / totalCalls;
        return errorRate > 0.5; // é”™è¯¯ç‡è¶…è¿‡50%å°±é™çº§
    }
    
    public void recordSuccess() {
        totalCalls++;
    }
    
    public void recordError() {
        totalCalls++;
        errorCalls++;
    }
}
```

**ğŸ”¸ åŸºäºç³»ç»Ÿèµ„æº**
```java
// ç³»ç»Ÿèµ„æºç›‘æ§
public class SystemResourceMonitor {
    
    public boolean shouldDegrade() {
        // CPUä½¿ç”¨ç‡è¶…è¿‡80%
        if (getCpuUsage() > 0.8) return true;
        
        // å†…å­˜ä½¿ç”¨ç‡è¶…è¿‡85%
        if (getMemoryUsage() > 0.85) return true;
        
        // è¿æ¥æ± ä½¿ç”¨ç‡è¶…è¿‡90%
        if (getConnectionPoolUsage() > 0.9) return true;
        
        return false;
    }
}
```

### 3.3 é™çº§å†³ç­–æµç¨‹å›¾


```
è¯·æ±‚åˆ°è¾¾
    â”‚
    â–¼
ç³»ç»Ÿèµ„æºæ£€æŸ¥
    â”‚
    â”œâ”€æ­£å¸¸â”€â”€â†’ ç»§ç»­å¤„ç†
    â”‚
    â””â”€å¼‚å¸¸â”€â”€â†’ æ£€æŸ¥æœåŠ¡çŠ¶æ€
                â”‚
                â”œâ”€ç†”æ–­å™¨æ‰“å¼€â”€â”€â†’ å¿«é€Ÿå¤±è´¥
                â”‚
                â”œâ”€å“åº”æ—¶é—´æ…¢â”€â”€â†’ é™çº§å¤„ç†
                â”‚
                â””â”€é”™è¯¯ç‡é«˜â”€â”€â”€â”€â†’ å¤‡ç”¨æ–¹æ¡ˆ
```

---

## 4. ğŸš° é™æµç®—æ³•è¯¦è§£


### 4.1 å›ºå®šçª—å£ç®—æ³•


**é€šä¿—ç†è§£**ï¼šå°±åƒé“¶è¡Œæ¯å°æ—¶åªèƒ½åŠç†100ç¬”ä¸šåŠ¡ï¼Œæ¯å°æ—¶é‡æ–°è®¡æ•°ã€‚

```
æ—¶é—´è½´ç¤ºä¾‹ï¼š
9:00-10:00  |â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 100ä¸ªè¯·æ±‚ âœ“
10:00-11:00 |â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 100ä¸ªè¯·æ±‚ âœ“
11:00-12:00 |â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 100ä¸ªè¯·æ±‚ âœ“

é—®é¢˜ï¼šä¸´ç•Œç‚¹çªåˆº
9:59åˆ†ï¼šæ¥äº†100ä¸ªè¯·æ±‚ âœ“
10:01åˆ†ï¼šåˆæ¥100ä¸ªè¯·æ±‚ âœ“
â†’ 2åˆ†é’Ÿå†…å¤„ç†äº†200ä¸ªè¯·æ±‚ï¼Œå®é™…è¶…è¿‡äº†é™åˆ¶
```

```java
// å›ºå®šçª—å£é™æµå™¨
public class FixedWindowRateLimiter {
    private int limit;              // çª—å£é™åˆ¶
    private long windowSizeInMs;    // çª—å£å¤§å°
    private int counter = 0;        // å½“å‰è®¡æ•°
    private long windowStart;       // çª—å£å¼€å§‹æ—¶é—´
    
    public FixedWindowRateLimiter(int limit, long windowSizeInMs) {
        this.limit = limit;
        this.windowSizeInMs = windowSizeInMs;
        this.windowStart = System.currentTimeMillis();
    }
    
    public boolean allowRequest() {
        long now = System.currentTimeMillis();
        
        // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡ç½®çª—å£
        if (now - windowStart >= windowSizeInMs) {
            counter = 0;
            windowStart = now;
        }
        
        // æ£€æŸ¥æ˜¯å¦è¶…è¿‡é™åˆ¶
        if (counter >= limit) {
            return false;
        }
        
        counter++;
        return true;
    }
}
```

**ğŸ”¸ ä¼˜ç¼ºç‚¹åˆ†æ**
```
âœ… ä¼˜ç‚¹ï¼š
â€¢ å®ç°ç®€å•
â€¢ å†…å­˜å ç”¨å°
â€¢ æ€§èƒ½é«˜æ•ˆ

âŒ ç¼ºç‚¹ï¼š
â€¢ ä¸´ç•Œç‚¹çªåˆºé—®é¢˜
â€¢ é™æµä¸å¤Ÿå¹³æ»‘
â€¢ æ— æ³•åº”å¯¹çªå‘æµé‡
```

### 4.2 æ»‘åŠ¨çª—å£ç®—æ³•


**é€šä¿—ç†è§£**ï¼šå°±åƒç»Ÿè®¡æœ€è¿‘1å°æ—¶çš„ä¸šåŠ¡é‡ï¼Œæ¯åˆ†é’Ÿéƒ½é‡æ–°è®¡ç®—æœ€è¿‘60åˆ†é’Ÿçš„æ€»æ•°ã€‚

```
æ»‘åŠ¨çª—å£ç¤ºä¾‹ï¼ˆæ¯åˆ†é’Ÿæ»‘åŠ¨ï¼‰ï¼š
æ—¶é—´: 9:00  9:01  9:02  9:03  9:04  9:05
è¯·æ±‚: [10] [15] [20] [12] [18] [25]
      â””â”€â”€â”€â”€â”€æœ€è¿‘5åˆ†é’Ÿæ€»è®¡ï¼š100â”€â”€â”€â”€â”€â”˜

ä¸‹ä¸€åˆ†é’Ÿï¼š
æ—¶é—´: 9:01  9:02  9:03  9:04  9:05  9:06
è¯·æ±‚: [15] [20] [12] [18] [25] [30]
      â””â”€â”€â”€â”€â”€æœ€è¿‘5åˆ†é’Ÿæ€»è®¡ï¼š120â”€â”€â”€â”€â”€â”˜
```

```java
// æ»‘åŠ¨çª—å£é™æµå™¨
public class SlidingWindowRateLimiter {
    private int limit;
    private long windowSizeInMs;
    private int subWindowCount;     // å­çª—å£æ•°é‡
    private int[] subWindowCounters; // æ¯ä¸ªå­çª—å£çš„è®¡æ•°
    private long subWindowSizeInMs; // å­çª—å£å¤§å°
    private long lastUpdateTime;
    
    public SlidingWindowRateLimiter(int limit, long windowSizeInMs, int subWindowCount) {
        this.limit = limit;
        this.windowSizeInMs = windowSizeInMs;
        this.subWindowCount = subWindowCount;
        this.subWindowCounters = new int[subWindowCount];
        this.subWindowSizeInMs = windowSizeInMs / subWindowCount;
        this.lastUpdateTime = System.currentTimeMillis();
    }
    
    public boolean allowRequest() {
        long now = System.currentTimeMillis();
        updateWindow(now);
        
        // è®¡ç®—å½“å‰çª—å£å†…çš„æ€»è¯·æ±‚æ•°
        int totalCount = 0;
        for (int count : subWindowCounters) {
            totalCount += count;
        }
        
        if (totalCount >= limit) {
            return false;
        }
        
        // åœ¨å½“å‰å­çª—å£ä¸­å¢åŠ è®¡æ•°
        int currentSubWindow = (int) ((now / subWindowSizeInMs) % subWindowCount);
        subWindowCounters[currentSubWindow]++;
        return true;
    }
    
    private void updateWindow(long now) {
        long timePassed = now - lastUpdateTime;
        long subWindowsPassed = timePassed / subWindowSizeInMs;
        
        if (subWindowsPassed > 0) {
            // æ¸…ç†è¿‡æœŸçš„å­çª—å£
            for (int i = 0; i < Math.min(subWindowsPassed, subWindowCount); i++) {
                int indexToClear = (int) (((lastUpdateTime / subWindowSizeInMs) + i + 1) % subWindowCount);
                subWindowCounters[indexToClear] = 0;
            }
            lastUpdateTime = now;
        }
    }
}
```

### 4.3 ä»¤ç‰Œæ¡¶ç®—æ³•


**é€šä¿—ç†è§£**ï¼šå°±åƒæ¸¸æˆå…çš„ä»£å¸æœºï¼Œå®šæœŸå¾€æ¡¶é‡Œæ”¾ä»£å¸ï¼Œç”¨æˆ·æ¥äº†å…ˆå–ä»£å¸ï¼Œæœ‰ä»£å¸å°±èƒ½ç©ã€‚

```
ä»¤ç‰Œæ¡¶å·¥ä½œç¤ºä¾‹ï¼š
æ¡¶å®¹é‡ï¼š10ä¸ªä»¤ç‰Œ
ç”Ÿæˆé€Ÿç‡ï¼šæ¯ç§’2ä¸ªä»¤ç‰Œ

æ—¶é—´çº¿ï¼š
0ç§’ï¼šæ¡¶é‡Œæœ‰10ä¸ªä»¤ç‰Œ [â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢]
1ç§’ï¼šç”Ÿæˆ2ä¸ªï¼Œæ¡¶æ»¡äº†   [â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢] (å¤šçš„ä¸¢å¼ƒ)
ç”¨æˆ·æ¥äº†ï¼šå–5ä¸ªä»¤ç‰Œ   [â€¢â€¢â€¢â€¢â€¢     ]
2ç§’ï¼šç”Ÿæˆ2ä¸ªä»¤ç‰Œ      [â€¢â€¢â€¢â€¢â€¢â€¢â€¢   ]
çªå‘æµé‡ï¼šå–7ä¸ªä»¤ç‰Œ   [          ] (æ¡¶ç©ºäº†)
æ–°ç”¨æˆ·ï¼šæ— ä»¤ç‰Œï¼Œé™æµ   [          ] âŒ
3ç§’ï¼šç”Ÿæˆ2ä¸ªä»¤ç‰Œ      [â€¢â€¢        ]
```

```java
// ä»¤ç‰Œæ¡¶é™æµå™¨
public class TokenBucketRateLimiter {
    private int capacity;           // æ¡¶å®¹é‡
    private double tokensPerSecond; // æ¯ç§’ç”Ÿæˆä»¤ç‰Œæ•°
    private double tokens;          // å½“å‰ä»¤ç‰Œæ•°
    private long lastRefillTime;    // ä¸Šæ¬¡è¡¥å……æ—¶é—´
    
    public TokenBucketRateLimiter(int capacity, double tokensPerSecond) {
        this.capacity = capacity;
        this.tokensPerSecond = tokensPerSecond;
        this.tokens = capacity;     // åˆå§‹æ—¶æ¡¶æ˜¯æ»¡çš„
        this.lastRefillTime = System.currentTimeMillis();
    }
    
    public boolean allowRequest() {
        return allowRequest(1);
    }
    
    public boolean allowRequest(int requestTokens) {
        refillTokens();
        
        if (tokens >= requestTokens) {
            tokens -= requestTokens;
            return true;
        }
        
        return false;
    }
    
    private void refillTokens() {
        long now = System.currentTimeMillis();
        double timePassedInSeconds = (now - lastRefillTime) / 1000.0;
        
        // è®¡ç®—è¿™æ®µæ—¶é—´åº”è¯¥ç”Ÿæˆçš„ä»¤ç‰Œæ•°
        double tokensToAdd = timePassedInSeconds * tokensPerSecond;
        
        // æ›´æ–°ä»¤ç‰Œæ•°ï¼Œä¸èƒ½è¶…è¿‡æ¡¶å®¹é‡
        tokens = Math.min(capacity, tokens + tokensToAdd);
        lastRefillTime = now;
    }
}
```

**ğŸ”¸ ä»¤ç‰Œæ¡¶ç‰¹ç‚¹**
```
âœ… ä¼˜ç‚¹ï¼š
â€¢ æ”¯æŒçªå‘æµé‡ï¼ˆæ¡¶é‡Œæœ‰å­˜é‡ä»¤ç‰Œï¼‰
â€¢ é™æµæ•ˆæœå¹³æ»‘
â€¢ å¯ä»¥æ§åˆ¶çªå‘æµé‡å¤§å°

ğŸ¯ é€‚ç”¨åœºæ™¯ï¼š
â€¢ éœ€è¦æ”¯æŒçªå‘æµé‡çš„åœºæ™¯
â€¢ å¯¹å“åº”æ—¶é—´è¦æ±‚é«˜çš„æœåŠ¡
â€¢ ç”¨æˆ·ä½“éªŒæ•æ„Ÿçš„åº”ç”¨
```

### 4.4 æ¼æ¡¶ç®—æ³•


**é€šä¿—ç†è§£**ï¼šå°±åƒæ¼æ–—ï¼Œä¸ç®¡ä¸Šé¢å€’å¤šå°‘æ°´ï¼Œä¸‹é¢éƒ½æ˜¯å›ºå®šé€Ÿåº¦æµå‡ºã€‚

```
æ¼æ¡¶å·¥ä½œç¤ºä¾‹ï¼š
æ¼æ¡¶å®¹é‡ï¼š10ä¸ªè¯·æ±‚
æ¼å‡ºé€Ÿç‡ï¼šæ¯ç§’2ä¸ªè¯·æ±‚

è¯·æ±‚æµå…¥æƒ…å†µï¼š
æ—¶é—´  â”‚ æµå…¥ â”‚ æ¡¶å†… â”‚ æµå‡º â”‚ è¯´æ˜
0ç§’   â”‚  5   â”‚  5   â”‚  0   â”‚ æ­£å¸¸æµå…¥
1ç§’   â”‚  3   â”‚  6   â”‚  2   â”‚ æ¼å‡º2ä¸ªï¼Œå‰©6ä¸ª
2ç§’   â”‚  8   â”‚ 10   â”‚  2   â”‚ æ¡¶æ»¡äº†ï¼Œå¤šçš„4ä¸ªè¢«ä¸¢å¼ƒ
3ç§’   â”‚  2   â”‚ 10   â”‚  2   â”‚ æ¡¶æ»¡ï¼Œæ–°æ¥çš„2ä¸ªè¢«ä¸¢å¼ƒ
4ç§’   â”‚  0   â”‚  8   â”‚  2   â”‚ ç»§ç»­æ¼å‡º
```

```java
// æ¼æ¡¶é™æµå™¨
public class LeakyBucketRateLimiter {
    private int capacity;           // æ¡¶å®¹é‡
    private double leakRate;        // æ¼å‡ºé€Ÿç‡ï¼ˆæ¯ç§’ï¼‰
    private int currentVolume;      // å½“å‰æ°´é‡
    private long lastLeakTime;      // ä¸Šæ¬¡æ¼æ°´æ—¶é—´
    
    public LeakyBucketRateLimiter(int capacity, double leakRate) {
        this.capacity = capacity;
        this.leakRate = leakRate;
        this.currentVolume = 0;
        this.lastLeakTime = System.currentTimeMillis();
    }
    
    public boolean allowRequest() {
        leak(); // å…ˆæ¼æ°´
        
        if (currentVolume < capacity) {
            currentVolume++;
            return true;
        }
        
        return false; // æ¡¶æ»¡äº†ï¼Œæ‹’ç»è¯·æ±‚
    }
    
    private void leak() {
        long now = System.currentTimeMillis();
        double timePassedInSeconds = (now - lastLeakTime) / 1000.0;
        
        // è®¡ç®—è¿™æ®µæ—¶é—´åº”è¯¥æ¼å‡ºçš„æ°´é‡
        int volumeToLeak = (int) (timePassedInSeconds * leakRate);
        
        // æ›´æ–°å½“å‰æ°´é‡
        currentVolume = Math.max(0, currentVolume - volumeToLeak);
        lastLeakTime = now;
    }
}
```

**ğŸ”¸ æ¼æ¡¶ç‰¹ç‚¹**
```
âœ… ä¼˜ç‚¹ï¼š
â€¢ è¾“å‡ºé€Ÿç‡å®Œå…¨ç¨³å®š
â€¢ èƒ½å¤Ÿå¹³æ»‘çªå‘æµé‡
â€¢ ä¿æŠ¤ä¸‹æ¸¸æœåŠ¡

âŒ ç¼ºç‚¹ï¼š
â€¢ ä¸æ”¯æŒçªå‘æµé‡
â€¢ å¯èƒ½å½±å“ç”¨æˆ·ä½“éªŒ

ğŸ¯ é€‚ç”¨åœºæ™¯ï¼š
â€¢ ä¸‹æ¸¸æœåŠ¡å¤„ç†èƒ½åŠ›å›ºå®š
â€¢ éœ€è¦ä¸¥æ ¼æ§åˆ¶æµé‡çš„åœºæ™¯
â€¢ å¯¹æµé‡å¹³æ»‘æ€§è¦æ±‚é«˜çš„ç³»ç»Ÿ
```

### 4.5 ç®—æ³•å¯¹æ¯”æ€»ç»“


| ç®—æ³•ç±»å‹ | **çªå‘æµé‡** | **æµé‡å¹³æ»‘åº¦** | **å®ç°å¤æ‚åº¦** | **é€‚ç”¨åœºæ™¯** |
|---------|------------|-------------|-------------|-------------|
| ğŸ”„ **å›ºå®šçª—å£** | `ä¸æ”¯æŒ` | `è¾ƒå·®` | `ç®€å•` | `è®¡æ•°ç»Ÿè®¡` |
| ğŸ“Š **æ»‘åŠ¨çª—å£** | `éƒ¨åˆ†æ”¯æŒ` | `è‰¯å¥½` | `ä¸­ç­‰` | `ç²¾ç¡®é™æµ` |
| ğŸª£ **ä»¤ç‰Œæ¡¶** | `æ”¯æŒ` | `è‰¯å¥½` | `ä¸­ç­‰` | `ç”¨æˆ·ä½“éªŒæ•æ„Ÿ` |
| ğŸ•³ï¸ **æ¼æ¡¶** | `ä¸æ”¯æŒ` | `ä¼˜ç§€` | `ä¸­ç­‰` | `ä¿æŠ¤ä¸‹æ¸¸` |

---

## 5. ğŸ¯ é™æµç²’åº¦è®¾è®¡


### 5.1 å…¨å±€é™æµ


**é€šä¿—ç†è§£**ï¼šå°±åƒæ•´ä¸ªå•†åœºçš„æ€»å®¢æµé‡æ§åˆ¶ï¼Œä¸ç®¡æ˜¯å“ªä¸ªå•†é“ºï¼Œæ€»äººæ•°ä¸èƒ½è¶…è¿‡é™åˆ¶ã€‚

```java
// å…¨å±€é™æµå™¨
@Component
public class GlobalRateLimiter {
    private final TokenBucketRateLimiter globalLimiter;
    
    public GlobalRateLimiter() {
        // å…¨å±€æ¯ç§’1000ä¸ªè¯·æ±‚
        this.globalLimiter = new TokenBucketRateLimiter(1000, 1000);
    }
    
    public boolean allowRequest(String requestId) {
        if (!globalLimiter.allowRequest()) {
            log.info("å…¨å±€é™æµè§¦å‘ï¼Œæ‹’ç»è¯·æ±‚ï¼š{}", requestId);
            return false;
        }
        return true;
    }
}
```

**ğŸ”¸ å…¨å±€é™æµç‰¹ç‚¹**
```
âœ… ä¼˜ç‚¹ï¼š
â€¢ ä¿æŠ¤æ•´ä¸ªç³»ç»Ÿä¸è¢«å‹å®
â€¢ å®ç°ç®€å•
â€¢ èµ„æºæ¶ˆè€—å°‘

âŒ ç¼ºç‚¹ï¼š
â€¢ æ— æ³•åŒºåˆ†è¯·æ±‚ç±»å‹
â€¢ å¯èƒ½å½±å“é‡è¦ä¸šåŠ¡
â€¢ ç²’åº¦å¤ªç²—

ğŸ¯ é€‚ç”¨åœºæ™¯ï¼š
â€¢ ç³»ç»Ÿæ€»ä½“ä¿æŠ¤
â€¢ é˜²æ­¢æ¶æ„æ”»å‡»
â€¢ åŸºç¡€è®¾æ–½é™æµ
```

### 5.2 å•æœºé™æµ


**é€šä¿—ç†è§£**ï¼šæ¯å°æœåŠ¡å™¨éƒ½æœ‰è‡ªå·±çš„é™æµå™¨ï¼Œå°±åƒæ¯ä¸ªæ”¶é“¶å°éƒ½æœ‰å¤„ç†é€Ÿåº¦é™åˆ¶ã€‚

```java
// å•æœºé™æµå™¨
@Component
public class LocalRateLimiter {
    private final Map<String, TokenBucketRateLimiter> limiters = new ConcurrentHashMap<>();
    
    public boolean allowRequest(String apiPath) {
        TokenBucketRateLimiter limiter = limiters.computeIfAbsent(apiPath, 
            key -> createLimiterForApi(key));
        
        return limiter.allowRequest();
    }
    
    private TokenBucketRateLimiter createLimiterForApi(String apiPath) {
        // æ ¹æ®APIè·¯å¾„è®¾ç½®ä¸åŒçš„é™æµå‚æ•°
        switch (apiPath) {
            case "/api/login":
                return new TokenBucketRateLimiter(10, 10);    // ç™»å½•æ¥å£ï¼šæ¯ç§’10æ¬¡
            case "/api/search":
                return new TokenBucketRateLimiter(100, 100);  // æœç´¢æ¥å£ï¼šæ¯ç§’100æ¬¡
            case "/api/upload":
                return new TokenBucketRateLimiter(5, 5);      // ä¸Šä¼ æ¥å£ï¼šæ¯ç§’5æ¬¡
            default:
                return new TokenBucketRateLimiter(50, 50);    // é»˜è®¤ï¼šæ¯ç§’50æ¬¡
        }
    }
}
```

### 5.3 æ¥å£é™æµ


**é€šä¿—ç†è§£**ï¼šä¸åŒçš„é“¶è¡Œä¸šåŠ¡æœ‰ä¸åŒçš„å¤„ç†é€Ÿåº¦ï¼Œå–é’±å¿«ï¼Œè´·æ¬¾å®¡æ ¸æ…¢ã€‚

```java
// æ¥å£çº§åˆ«é™æµ
@RestController
public class ApiController {
    
    @GetMapping("/api/user/profile")
    @RateLimit(value = 100, timeWindow = 60) // æ¯åˆ†é’Ÿ100æ¬¡
    public UserProfile getUserProfile(@RequestParam String userId) {
        return userService.getProfile(userId);
    }
    
    @PostMapping("/api/user/update")
    @RateLimit(value = 10, timeWindow = 60)  // æ¯åˆ†é’Ÿ10æ¬¡
    public void updateUserProfile(@RequestBody UserProfile profile) {
        userService.updateProfile(profile);
    }
    
    @PostMapping("/api/payment")
    @RateLimit(value = 5, timeWindow = 60)   // æ¯åˆ†é’Ÿ5æ¬¡
    public PaymentResult processPayment(@RequestBody PaymentRequest request) {
        return paymentService.process(request);
    }
}
```

### 5.4 ç”¨æˆ·é™æµ


**é€šä¿—ç†è§£**ï¼šæ¯ä¸ªç”¨æˆ·éƒ½æœ‰è‡ªå·±çš„ä½¿ç”¨é…é¢ï¼Œå°±åƒæ¯ä¸ªäººçš„æ‰‹æœºæµé‡å¥—é¤ã€‚

```java
// ç”¨æˆ·çº§åˆ«é™æµ
@Component
public class UserRateLimiter {
    private final Map<String, TokenBucketRateLimiter> userLimiters = new ConcurrentHashMap<>();
    
    public boolean allowUserRequest(String userId, String apiPath) {
        String key = userId + ":" + apiPath;
        TokenBucketRateLimiter limiter = userLimiters.computeIfAbsent(key, 
            k -> createUserLimiter(userId, apiPath));
        
        return limiter.allowRequest();
    }
    
    private TokenBucketRateLimiter createUserLimiter(String userId, String apiPath) {
        UserLevel userLevel = getUserLevel(userId);
        
        // æ ¹æ®ç”¨æˆ·ç­‰çº§è®¾ç½®ä¸åŒé™åˆ¶
        switch (userLevel) {
            case VIP:
                return new TokenBucketRateLimiter(1000, 1000); // VIPç”¨æˆ·ï¼šæ¯ç§’1000æ¬¡
            case PREMIUM:
                return new TokenBucketRateLimiter(500, 500);   // é«˜çº§ç”¨æˆ·ï¼šæ¯ç§’500æ¬¡
            case NORMAL:
                return new TokenBucketRateLimiter(100, 100);   // æ™®é€šç”¨æˆ·ï¼šæ¯ç§’100æ¬¡
            default:
                return new TokenBucketRateLimiter(10, 10);     // å…è´¹ç”¨æˆ·ï¼šæ¯ç§’10æ¬¡
        }
    }
}
```

### 5.5 é™æµç²’åº¦ç»„åˆç­–ç•¥


```java
// å¤šçº§é™æµç»„åˆ
@Component
public class HierarchicalRateLimiter {
    
    @Autowired
    private GlobalRateLimiter globalLimiter;
    
    @Autowired
    private LocalRateLimiter localLimiter;
    
    @Autowired
    private UserRateLimiter userLimiter;
    
    public boolean allowRequest(String userId, String apiPath, String requestId) {
        // ç¬¬ä¸€çº§ï¼šå…¨å±€é™æµ
        if (!globalLimiter.allowRequest(requestId)) {
            return false;
        }
        
        // ç¬¬äºŒçº§ï¼šæ¥å£é™æµ
        if (!localLimiter.allowRequest(apiPath)) {
            return false;
        }
        
        // ç¬¬ä¸‰çº§ï¼šç”¨æˆ·é™æµ
        if (!userLimiter.allowUserRequest(userId, apiPath)) {
            return false;
        }
        
        return true;
    }
}
```

---

## 6. ğŸŒŠ èƒŒå‹å¤„ç†æœºåˆ¶


### 6.1 ä»€ä¹ˆæ˜¯èƒŒå‹


**é€šä¿—ç†è§£**ï¼šå°±åƒæ°´ç®¡ï¼Œå¦‚æœå‡ºæ°´å£å¤ªå°ï¼Œä¸Šæ¸¸æ°´å‹ä¼šè¶Šæ¥è¶Šå¤§ï¼Œæœ€ç»ˆå¯èƒ½çˆ†ç®¡ã€‚

```
ç³»ç»ŸèƒŒå‹ç¤ºä¾‹ï¼š
ç”¨æˆ·è¯·æ±‚ â”€â”€â†’ æ¥å£æœåŠ¡ â”€â”€â†’ æ•°æ®åº“
æ¯ç§’1000æ¬¡    æ¯ç§’500æ¬¡    æ¯ç§’100æ¬¡

ç»“æœï¼š
â€¢ æ¥å£æœåŠ¡ç§¯å‹500ä¸ªè¯·æ±‚/ç§’
â€¢ æ•°æ®åº“ç§¯å‹400ä¸ªè¯·æ±‚/ç§’
â€¢ ç³»ç»Ÿå†…å­˜è¶Šæ¥è¶Šé«˜
â€¢ å“åº”æ—¶é—´è¶Šæ¥è¶Šæ…¢
```

### 6.2 é˜Ÿåˆ—ç§¯å‹å¤„ç†


**ğŸ”¸ é˜Ÿåˆ—ç›‘æ§**
```java
// é˜Ÿåˆ—ç§¯å‹ç›‘æ§
@Component
public class QueueBackpressureMonitor {
    private final BlockingQueue<Request> requestQueue;
    private final int maxQueueSize = 1000;
    private final int warningThreshold = 800;
    
    public QueueBackpressureMonitor() {
        this.requestQueue = new ArrayBlockingQueue<>(maxQueueSize);
    }
    
    public boolean enqueue(Request request) {
        int currentSize = requestQueue.size();
        
        // æ£€æŸ¥é˜Ÿåˆ—ç§¯å‹æƒ…å†µ
        if (currentSize >= maxQueueSize) {
            // é˜Ÿåˆ—æ»¡äº†ï¼Œç›´æ¥æ‹’ç»
            return false;
        }
        
        if (currentSize >= warningThreshold) {
            // é˜Ÿåˆ—æ¥è¿‘æ»¡äº†ï¼Œè§¦å‘å‘Šè­¦
            alertManager.sendAlert("é˜Ÿåˆ—ç§¯å‹ä¸¥é‡ï¼š" + currentSize);
        }
        
        return requestQueue.offer(request);
    }
}
```

**ğŸ”¸ åŠ¨æ€é˜Ÿåˆ—è°ƒæ•´**
```java
// è‡ªé€‚åº”é˜Ÿåˆ—å¤§å°
public class AdaptiveQueue {
    private BlockingQueue<Request> queue;
    private int baseCapacity = 100;
    private int maxCapacity = 1000;
    private double cpuThreshold = 0.8;
    
    public void adjustQueueSize() {
        double cpuUsage = getCpuUsage();
        
        if (cpuUsage > cpuThreshold) {
            // CPUå‹åŠ›å¤§ï¼Œå‡å°é˜Ÿåˆ—å®¹é‡
            int newCapacity = Math.max(baseCapacity, queue.size() / 2);
            resizeQueue(newCapacity);
        } else {
            // CPUå‹åŠ›å°ï¼Œå¯ä»¥å¢å¤§é˜Ÿåˆ—å®¹é‡
            int newCapacity = Math.min(maxCapacity, baseCapacity * 2);
            resizeQueue(newCapacity);
        }
    }
}
```

### 6.3 æ‹’ç»ç­–ç•¥


**ğŸ”¸ ç›´æ¥æ‹’ç»ç­–ç•¥**
```java
// å¿«é€Ÿå¤±è´¥ç­–ç•¥
public class FailFastRejectionHandler {
    
    public void handleRejection(Request request) {
        // ç«‹å³è¿”å›é”™è¯¯ï¼Œä¸ç­‰å¾…
        sendErrorResponse(request, "ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
        
        // è®°å½•æ‹’ç»æ—¥å¿—
        log.warn("è¯·æ±‚è¢«æ‹’ç»ï¼š{}, å½“å‰è´Ÿè½½ï¼š{}", 
                request.getId(), getCurrentLoad());
    }
    
    private void sendErrorResponse(Request request, String message) {
        Response response = new Response();
        response.setStatusCode(503); // Service Unavailable
        response.setMessage(message);
        request.getChannel().sendResponse(response);
    }
}
```

**ğŸ”¸ ä¼˜é›…é™çº§ç­–ç•¥**
```java
// é™çº§å¤„ç†ç­–ç•¥
public class GracefulDegradationHandler {
    
    public void handleRejection(Request request) {
        // æ ¹æ®è¯·æ±‚ç±»å‹é€‰æ‹©é™çº§ç­–ç•¥
        String requestType = request.getType();
        
        switch (requestType) {
            case "USER_PROFILE":
                // è¿”å›ç¼“å­˜çš„ç”¨æˆ·ä¿¡æ¯
                sendCachedProfile(request);
                break;
                
            case "RECOMMENDATION":
                // è¿”å›çƒ­é—¨æ¨è
                sendHotRecommendations(request);
                break;
                
            case "SEARCH":
                // è¿”å›ç®€åŒ–æœç´¢ç»“æœ
                sendSimpleSearchResult(request);
                break;
                
            default:
                // é»˜è®¤å¿«é€Ÿå¤±è´¥
                sendErrorResponse(request, "ç³»ç»Ÿç¹å¿™");
        }
    }
}
```

### 6.4 æµæ§åè®®


**ğŸ”¸ ç®€å•æµæ§åè®®**
```java
// åŸºäºçª—å£çš„æµæ§
public class WindowBasedFlowControl {
    private int windowSize = 100;      // çª—å£å¤§å°
    private int sentCount = 0;         // å·²å‘é€æ•°é‡
    private int ackedCount = 0;        // å·²ç¡®è®¤æ•°é‡
    
    public boolean canSend() {
        // æ£€æŸ¥æ˜¯å¦è¿˜èƒ½å‘é€
        return (sentCount - ackedCount) < windowSize;
    }
    
    public void sendRequest(Request request) {
        if (canSend()) {
            doSend(request);
            sentCount++;
        } else {
            // çª—å£æ»¡äº†ï¼Œæš‚åœå‘é€
            waitForAck();
        }
    }
    
    public void onAckReceived() {
        ackedCount++;
        // çª—å£æœ‰ç©ºé—´äº†ï¼Œå¯ä»¥ç»§ç»­å‘é€
        notifyCanSend();
    }
}
```

---

## 7. ğŸ¤– è‡ªé€‚åº”é™æµç­–ç•¥


### 7.1 åŸºäºç³»ç»ŸæŒ‡æ ‡çš„é™æµ


**é€šä¿—ç†è§£**ï¼šå°±åƒæ™ºèƒ½ç©ºè°ƒï¼Œæ ¹æ®å®¤æ¸©è‡ªåŠ¨è°ƒèŠ‚åˆ¶å†·å¼ºåº¦ã€‚

```java
// è‡ªé€‚åº”é™æµå™¨
@Component
public class AdaptiveRateLimiter {
    private TokenBucketRateLimiter limiter;
    private double baseLimitPerSecond = 1000;    // åŸºç¡€é™æµå€¼
    private double currentLimitPerSecond;        // å½“å‰é™æµå€¼
    
    public AdaptiveRateLimiter() {
        this.currentLimitPerSecond = baseLimitPerSecond;
        this.limiter = new TokenBucketRateLimiter(1000, currentLimitPerSecond);
    }
    
    public boolean allowRequest() {
        adjustLimitBasedOnSystemMetrics();
        return limiter.allowRequest();
    }
    
    private void adjustLimitBasedOnSystemMetrics() {
        double cpuUsage = getCpuUsage();
        double memoryUsage = getMemoryUsage();
        double responseTime = getAverageResponseTime();
        
        // è®¡ç®—ç³»ç»Ÿå‹åŠ›æŒ‡æ•°
        double pressureIndex = calculatePressureIndex(cpuUsage, memoryUsage, responseTime);
        
        // æ ¹æ®å‹åŠ›è°ƒæ•´é™æµ
        adjustLimit(pressureIndex);
    }
    
    private double calculatePressureIndex(double cpu, double memory, double responseTime) {
        // ç»¼åˆè¯„ä¼°ç³»ç»Ÿå‹åŠ›ï¼ˆ0-1ä¹‹é—´ï¼Œ1è¡¨ç¤ºå‹åŠ›æœ€å¤§ï¼‰
        double cpuPressure = Math.min(1.0, cpu / 0.8);           // CPUè¶…è¿‡80%å¼€å§‹æœ‰å‹åŠ›
        double memoryPressure = Math.min(1.0, memory / 0.85);    // å†…å­˜è¶…è¿‡85%å¼€å§‹æœ‰å‹åŠ›
        double timePressure = Math.min(1.0, responseTime / 1000); // å“åº”æ—¶é—´è¶…è¿‡1ç§’å¼€å§‹æœ‰å‹åŠ›
        
        // å–æœ€å¤§å€¼ä½œä¸ºç³»ç»Ÿå‹åŠ›
        return Math.max(Math.max(cpuPressure, memoryPressure), timePressure);
    }
    
    private void adjustLimit(double pressureIndex) {
        if (pressureIndex > 0.8) {
            // é«˜å‹åŠ›ï¼šå¤§å¹…é™ä½é™æµ
            currentLimitPerSecond = baseLimitPerSecond * 0.3;
        } else if (pressureIndex > 0.6) {
            // ä¸­ç­‰å‹åŠ›ï¼šé€‚åº¦é™ä½é™æµ
            currentLimitPerSecond = baseLimitPerSecond * 0.6;
        } else if (pressureIndex > 0.4) {
            // è½»å¾®å‹åŠ›ï¼šå°å¹…é™ä½é™æµ
            currentLimitPerSecond = baseLimitPerSecond * 0.8;
        } else {
            // ä½å‹åŠ›ï¼šæ¢å¤æ­£å¸¸é™æµ
            currentLimitPerSecond = baseLimitPerSecond;
        }
        
        // æ›´æ–°é™æµå™¨
        updateLimiter();
    }
    
    private void updateLimiter() {
        // é‡æ–°åˆ›å»ºé™æµå™¨ï¼ˆå®é™…å®ç°ä¸­å¯ä»¥åŠ¨æ€è°ƒæ•´ï¼‰
        limiter = new TokenBucketRateLimiter(1000, currentLimitPerSecond);
        
        log.info("è‡ªé€‚åº”é™æµè°ƒæ•´ï¼š{} req/sec", currentLimitPerSecond);
    }
}
```

### 7.2 åŸºäºæˆåŠŸç‡çš„é™æµ


```java
// åŸºäºæˆåŠŸç‡çš„è‡ªé€‚åº”é™æµ
public class SuccessRateAdaptiveLimiter {
    private double successRate = 1.0;           // æˆåŠŸç‡
    private int totalRequests = 0;              // æ€»è¯·æ±‚æ•°
    private int successfulRequests = 0;         // æˆåŠŸè¯·æ±‚æ•°
    private TokenBucketRateLimiter limiter;
    
    public boolean allowRequest() {
        updateSuccessRate();
        adjustLimitBasedOnSuccessRate();
        
        if (limiter.allowRequest()) {
            totalRequests++;
            return true;
        }
        return false;
    }
    
    public void recordSuccess() {
        successfulRequests++;
    }
    
    public void recordFailure() {
        // å¤±è´¥ä¸å¢åŠ æˆåŠŸè®¡æ•°ï¼Œä½†æ€»æ•°å·²ç»åœ¨allowRequestä¸­å¢åŠ äº†
    }
    
    private void updateSuccessRate() {
        if (totalRequests > 0) {
            successRate = (double) successfulRequests / totalRequests;
        }
        
        // æ¯1000ä¸ªè¯·æ±‚é‡ç½®ç»Ÿè®¡ï¼ˆæ»‘åŠ¨çª—å£ï¼‰
        if (totalRequests >= 1000) {
            totalRequests = 0;
            successfulRequests = 0;
        }
    }
    
    private void adjustLimitBasedOnSuccessRate() {
        double limitPerSecond;
        
        if (successRate > 0.95) {
            // æˆåŠŸç‡å¾ˆé«˜ï¼Œå¯ä»¥å¢åŠ é™æµ
            limitPerSecond = 1000;
        } else if (successRate > 0.8) {
            // æˆåŠŸç‡è¾ƒé«˜ï¼Œä¿æŒå½“å‰é™æµ
            limitPerSecond = 800;
        } else if (successRate > 0.6) {
            // æˆåŠŸç‡ä¸€èˆ¬ï¼Œé€‚åº¦é™æµ
            limitPerSecond = 500;
        } else {
            // æˆåŠŸç‡ä½ï¼Œä¸¥æ ¼é™æµ
            limitPerSecond = 200;
        }
        
        limiter = new TokenBucketRateLimiter(1000, limitPerSecond);
    }
}
```

### 7.3 å¤šæŒ‡æ ‡ç»¼åˆå†³ç­–


```java
// å¤šæŒ‡æ ‡ç»¼åˆè‡ªé€‚åº”é™æµ
public class ComprehensiveAdaptiveLimiter {
    
    public class SystemMetrics {
        double cpuUsage;
        double memoryUsage;
        double responseTime;
        double successRate;
        int activeConnections;
        int queueSize;
    }
    
    public double calculateOptimalLimit(SystemMetrics metrics) {
        double baseLimitPerSecond = 1000;
        
        // å„é¡¹æŒ‡æ ‡çš„æƒé‡è°ƒæ•´å› å­
        double cpuFactor = calculateCpuFactor(metrics.cpuUsage);
        double memoryFactor = calculateMemoryFactor(metrics.memoryUsage);
        double responseFactor = calculateResponseFactor(metrics.responseTime);
        double successFactor = calculateSuccessFactor(metrics.successRate);
        double connectionFactor = calculateConnectionFactor(metrics.activeConnections);
        double queueFactor = calculateQueueFactor(metrics.queueSize);
        
        // å–æœ€ä¿å®ˆçš„å› å­ï¼ˆæœ€å°å€¼ï¼‰
        double adjustmentFactor = Math.min(Math.min(Math.min(cpuFactor, memoryFactor), 
                                         Math.min(responseFactor, successFactor)),
                                         Math.min(connectionFactor, queueFactor));
        
        return baseLimitPerSecond * adjustmentFactor;
    }
    
    private double calculateCpuFactor(double cpuUsage) {
        if (cpuUsage < 0.5) return 1.0;      // CPUä½¿ç”¨ç‡50%ä»¥ä¸‹ï¼Œä¸é™åˆ¶
        if (cpuUsage < 0.7) return 0.8;      // 50-70%ï¼Œè½»å¾®é™åˆ¶
        if (cpuUsage < 0.8) return 0.5;      // 70-80%ï¼Œä¸­ç­‰é™åˆ¶
        if (cpuUsage < 0.9) return 0.3;      // 80-90%ï¼Œä¸¥æ ¼é™åˆ¶
        return 0.1;                          // 90%ä»¥ä¸Šï¼Œä¸¥é‡é™åˆ¶
    }
    
    private double calculateMemoryFactor(double memoryUsage) {
        if (memoryUsage < 0.6) return 1.0;
        if (memoryUsage < 0.75) return 0.8;
        if (memoryUsage < 0.85) return 0.5;
        if (memoryUsage < 0.95) return 0.2;
        return 0.05;
    }
    
    // å…¶ä»–æŒ‡æ ‡å› å­è®¡ç®—æ–¹æ³•ç±»ä¼¼...
}
```

---

## 8. âš”ï¸ å®¹é”™ç­–ç•¥å¯¹æ¯”


### 8.1 å¿«é€Ÿå¤±è´¥ vs æ•…éšœè½¬ç§»


**ğŸ”¸ å¿«é€Ÿå¤±è´¥ï¼ˆFail Fastï¼‰**
```
ç‰¹ç‚¹ï¼š
â€¢ å‘ç°é—®é¢˜ç«‹å³è¿”å›é”™è¯¯
â€¢ ä¸ç­‰å¾…ã€ä¸é‡è¯•
â€¢ èµ„æºæ¶ˆè€—æœ€å°‘

é€‚ç”¨åœºæ™¯ï¼š
â€¢ éæ ¸å¿ƒåŠŸèƒ½
â€¢ å¯¹å“åº”æ—¶é—´è¦æ±‚é«˜
â€¢ ç³»ç»Ÿèµ„æºç´§å¼ 

ç¤ºä¾‹ï¼šç”¨æˆ·å¤´åƒåŠ è½½å¤±è´¥ â†’ ç«‹å³æ˜¾ç¤ºé»˜è®¤å¤´åƒ
```

```java
// å¿«é€Ÿå¤±è´¥ç¤ºä¾‹
public String getUserAvatar(String userId) {
    if (avatarService.isDown()) {
        // å¿«é€Ÿå¤±è´¥ï¼Œç«‹å³è¿”å›é»˜è®¤å¤´åƒ
        return "default-avatar.png";
    }
    
    try {
        return avatarService.getAvatar(userId);
    } catch (Exception e) {
        return "default-avatar.png";
    }
}
```

**ğŸ”¸ æ•…éšœè½¬ç§»ï¼ˆFailoverï¼‰**
```
ç‰¹ç‚¹ï¼š
â€¢ ä¸»æœåŠ¡å¤±è´¥ååˆ‡æ¢åˆ°å¤‡ç”¨æœåŠ¡
â€¢ æä¾›ç›¸åŒæˆ–ç±»ä¼¼çš„åŠŸèƒ½
â€¢ ä¿è¯æœåŠ¡è¿ç»­æ€§

é€‚ç”¨åœºæ™¯ï¼š
â€¢ æ ¸å¿ƒä¸šåŠ¡åŠŸèƒ½
â€¢ é«˜å¯ç”¨æ€§è¦æ±‚
â€¢ æœ‰å¤‡ç”¨èµ„æº

ç¤ºä¾‹ï¼šä¸»æ”¯ä»˜é€šé“æ•…éšœ â†’ è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨æ”¯ä»˜é€šé“
```

```java
// æ•…éšœè½¬ç§»ç¤ºä¾‹
public PaymentResult processPayment(PaymentRequest request) {
    try {
        return primaryPaymentService.pay(request);
    } catch (Exception e) {
        log.warn("ä¸»æ”¯ä»˜æœåŠ¡å¼‚å¸¸ï¼Œåˆ‡æ¢åˆ°å¤‡ç”¨æœåŠ¡", e);
        return backupPaymentService.pay(request);
    }
}
```

### 8.2 ç­–ç•¥é€‰æ‹©å†³ç­–æ ‘


```
è¯·æ±‚åˆ°è¾¾
    â”‚
    â–¼
æ ¸å¿ƒä¸šåŠ¡ï¼Ÿ
    â”‚
    â”œâ”€æ˜¯â”€â”€â†’ æœ‰å¤‡ç”¨æœåŠ¡ï¼Ÿ
    â”‚       â”‚
    â”‚       â”œâ”€æ˜¯â”€â”€â†’ æ•…éšœè½¬ç§»
    â”‚       â””â”€å¦â”€â”€â†’ é™çº§å¤„ç†
    â”‚
    â””â”€å¦â”€â”€â†’ å“åº”æ—¶é—´æ•æ„Ÿï¼Ÿ
            â”‚
            â”œâ”€æ˜¯â”€â”€â†’ å¿«é€Ÿå¤±è´¥
            â””â”€å¦â”€â”€â†’ é‡è¯•æœºåˆ¶
```

### 8.3 å®¹é”™ç­–ç•¥ç»„åˆ


```java
// å¤šé‡å®¹é”™ç­–ç•¥
@Component
public class MultipleFaultToleranceStrategy {
    
    public Object handleRequest(Request request) {
        String businessType = request.getBusinessType();
        
        // æ ¹æ®ä¸šåŠ¡ç±»å‹é€‰æ‹©å®¹é”™ç­–ç•¥
        switch (businessType) {
            case "CRITICAL":
                return handleCriticalBusiness(request);
            case "IMPORTANT":
                return handleImportantBusiness(request);
            case "NORMAL":
                return handleNormalBusiness(request);
            default:
                return handleOptionalBusiness(request);
        }
    }
    
    private Object handleCriticalBusiness(Request request) {
        // æ ¸å¿ƒä¸šåŠ¡ï¼šæ•…éšœè½¬ç§» + é‡è¯• + é™çº§
        try {
            return primaryService.process(request);
        } catch (Exception e) {
            try {
                return backupService.process(request);
            } catch (Exception e2) {
                return degradationService.processWithBasicFeature(request);
            }
        }
    }
    
    private Object handleOptionalBusiness(Request request) {
        // å¯é€‰ä¸šåŠ¡ï¼šå¿«é€Ÿå¤±è´¥
        if (systemUnderPressure()) {
            return getDefaultResult();
        }
        
        try {
            return optionalService.process(request);
        } catch (Exception e) {
            return getDefaultResult();
        }
    }
}
```

---

## 9. ğŸ’¡ æœ€ä½³å®è·µæŒ‡å—


### 9.1 é™çº§æ–¹æ¡ˆè®¾è®¡åŸåˆ™


**ğŸ”¸ åˆ†çº§é™çº§åŸåˆ™**
```
L0 - å®Œå…¨æ­£å¸¸ï¼šæ‰€æœ‰åŠŸèƒ½æ­£å¸¸è¿è¡Œ
L1 - è½»åº¦é™çº§ï¼šå…³é—­éæ ¸å¿ƒåŠŸèƒ½ï¼ˆå¦‚æ¨èã€å¹¿å‘Šï¼‰
L2 - ä¸­åº¦é™çº§ï¼šç®€åŒ–æ ¸å¿ƒåŠŸèƒ½ï¼ˆå¦‚è¿”å›ç¼“å­˜æ•°æ®ï¼‰
L3 - é‡åº¦é™çº§ï¼šåªä¿ç•™æœ€åŸºæœ¬åŠŸèƒ½ï¼ˆå¦‚ç™»å½•ã€æŸ¥çœ‹ï¼‰
L4 - ç´§æ€¥é™çº§ï¼šåœæ­¢æœåŠ¡ï¼Œè¿”å›ç»´æŠ¤é¡µé¢
```

```java
// åˆ†çº§é™çº§å®ç°
@Component
public class DegradationLevelManager {
    private int currentLevel = 0;
    
    public Object processRequest(Request request) {
        switch (currentLevel) {
            case 0:
                return processNormally(request);
            case 1:
                return processWithoutOptional(request);
            case 2:
                return processWithCache(request);
            case 3:
                return processBasicOnly(request);
            case 4:
                return maintenanceResponse();
            default:
                return processNormally(request);
        }
    }
    
    public void upgradeDegradationLevel() {
        if (currentLevel < 4) {
            currentLevel++;
            log.warn("é™çº§ç­‰çº§æå‡åˆ°ï¼šL{}", currentLevel);
        }
    }
    
    public void downgradeDegradationLevel() {
        if (currentLevel > 0) {
            currentLevel--;
            log.info("é™çº§ç­‰çº§é™ä½åˆ°ï¼šL{}", currentLevel);
        }
    }
}
```

**ğŸ”¸ é¢„æ¡ˆå‡†å¤‡åŸåˆ™**
```java
// é™çº§é¢„æ¡ˆé…ç½®
@Configuration
public class DegradationPlanConfig {
    
    @Bean
    public Map<String, DegradationPlan> degradationPlans() {
        Map<String, DegradationPlan> plans = new HashMap<>();
        
        // ç”¨æˆ·æœåŠ¡é™çº§é¢„æ¡ˆ
        plans.put("user-service", DegradationPlan.builder()
            .fallbackData(getUserFallbackData())
            .cacheExpiry(300) // ç¼“å­˜5åˆ†é’Ÿ
            .retryAttempts(2)
            .timeoutMs(1000)
            .build());
        
        // æ¨èæœåŠ¡é™çº§é¢„æ¡ˆ
        plans.put("recommendation-service", DegradationPlan.builder()
            .fallbackData(getHotProducts())
            .cacheExpiry(600) // ç¼“å­˜10åˆ†é’Ÿ
            .retryAttempts(0) // ä¸é‡è¯•
            .timeoutMs(500)
            .build());
        
        return plans;
    }
}
```

### 9.2 é™æµå‚æ•°è°ƒä¼˜æŒ‡å—


**ğŸ”¸ å‚æ•°è°ƒä¼˜æ­¥éª¤**
```
1. åŸºçº¿æµ‹è¯•ï¼š
   - æµ‹è¯•ç³»ç»Ÿåœ¨æ­£å¸¸è´Ÿè½½ä¸‹çš„è¡¨ç°
   - è®°å½•CPUã€å†…å­˜ã€å“åº”æ—¶é—´ç­‰æŒ‡æ ‡
   - ç¡®å®šç³»ç»Ÿçš„å¤„ç†èƒ½åŠ›ä¸Šé™

2. é€æ­¥åŠ å‹ï¼š
   - ä»50%å®¹é‡å¼€å§‹æµ‹è¯•
   - é€æ­¥å¢åŠ åˆ°80%ã€100%ã€120%
   - è§‚å¯Ÿç³»ç»Ÿå„é¡¹æŒ‡æ ‡çš„å˜åŒ–

3. ç¡®å®šé˜ˆå€¼ï¼š
   - æ‰¾åˆ°ç³»ç»Ÿå¼€å§‹å‡ºç°é—®é¢˜çš„ä¸´ç•Œç‚¹
   - è®¾ç½®é™æµé˜ˆå€¼ä¸ºè¯¥ç‚¹çš„80%
   - ç•™å‡º20%çš„å®‰å…¨ä½™é‡

4. åŠ¨æ€è°ƒæ•´ï¼š
   - æ ¹æ®å®é™…è¿è¡Œæƒ…å†µè°ƒæ•´å‚æ•°
   - å…³æ³¨ä¸šåŠ¡æŒ‡æ ‡å’Œç”¨æˆ·ä½“éªŒ
   - å®šæœŸå›é¡¾å’Œä¼˜åŒ–
```

**ğŸ”¸ å¸¸ç”¨å‚æ•°æ¨èå€¼**
```java
// ä¸åŒåœºæ™¯çš„é™æµå‚æ•°æ¨è
public class RateLimitingRecommendations {
    
    // Web APIæ¥å£
    public static RateLimitConfig getWebApiConfig() {
        return RateLimitConfig.builder()
            .globalLimit(1000)        // å…¨å±€æ¯ç§’1000æ¬¡
            .userLimit(10)            // å•ç”¨æˆ·æ¯ç§’10æ¬¡
            .burstSize(50)            // å…è®¸çªå‘50æ¬¡
            .windowSizeInSeconds(60)  // 60ç§’çª—å£
            .build();
    }
    
    // æ”¯ä»˜æ¥å£
    public static RateLimitConfig getPaymentConfig() {
        return RateLimitConfig.builder()
            .globalLimit(100)         // å…¨å±€æ¯ç§’100æ¬¡
            .userLimit(1)             // å•ç”¨æˆ·æ¯ç§’1æ¬¡
            .burstSize(5)             // å…è®¸çªå‘5æ¬¡
            .windowSizeInSeconds(300) // 5åˆ†é’Ÿçª—å£
            .build();
    }
    
    // æœç´¢æ¥å£
    public static RateLimitConfig getSearchConfig() {
        return RateLimitConfig.builder()
            .globalLimit(2000)        // å…¨å±€æ¯ç§’2000æ¬¡
            .userLimit(20)            // å•ç”¨æˆ·æ¯ç§’20æ¬¡
            .burstSize(100)           // å…è®¸çªå‘100æ¬¡
            .windowSizeInSeconds(60)  // 60ç§’çª—å£
            .build();
    }
}
```

### 9.3 ç›‘æ§å‘Šè­¦è®¾ç½®


**ğŸ”¸ å…³é”®ç›‘æ§æŒ‡æ ‡**
```java
// ç›‘æ§æŒ‡æ ‡æ”¶é›†å™¨
@Component
public class MetricsCollector {
    
    @EventListener
    public void onRequestProcessed(RequestProcessedEvent event) {
        // è®°å½•è¯·æ±‚å¤„ç†æŒ‡æ ‡
        if (event.isRateLimited()) {
            rateLimitedCounter.increment();
        }
        
        if (event.isDegraded()) {
            degradedRequestCounter.increment();
        }
        
        responseTimeHistogram.record(event.getResponseTime());
        
        if (event.isSuccess()) {
            successCounter.increment();
        } else {
            errorCounter.increment();
        }
    }
    
    @Scheduled(fixedRate = 30000) // æ¯30ç§’è®¡ç®—ä¸€æ¬¡
    public void calculateMetrics() {
        double errorRate = calculateErrorRate();
        double responseTimeP99 = responseTimeHistogram.percentile(0.99);
        int currentQps = getCurrentQps();
        
        // æ£€æŸ¥å‘Šè­¦æ¡ä»¶
        checkAlertConditions(errorRate, responseTimeP99, currentQps);
    }
    
    private void checkAlertConditions(double errorRate, double responseTime, int qps) {
        if (errorRate > 0.05) { // é”™è¯¯ç‡è¶…è¿‡5%
            alertManager.sendAlert("é”™è¯¯ç‡è¿‡é«˜ï¼š" + errorRate);
        }
        
        if (responseTime > 2000) { // P99å“åº”æ—¶é—´è¶…è¿‡2ç§’
            alertManager.sendAlert("å“åº”æ—¶é—´è¿‡é•¿ï¼š" + responseTime + "ms");
        }
        
        if (qps > 1500) { // QPSè¶…è¿‡é¢„è®¾é˜ˆå€¼
            alertManager.sendAlert("æµé‡è¿‡é«˜ï¼š" + qps + " req/s");
        }
    }
}
```

### 9.4 æ¸è¿›å¼å‘å¸ƒç­–ç•¥


```java
// æ¸è¿›å¼é™æµå‘å¸ƒ
@Component
public class GradualRolloutLimiter {
    private double rolloutPercentage = 0.1; // ä»10%å¼€å§‹
    
    public boolean shouldApplyNewLimit(String userId) {
        // åŸºäºç”¨æˆ·IDå“ˆå¸Œå†³å®šæ˜¯å¦åº”ç”¨æ–°é™æµç­–ç•¥
        int hash = Math.abs(userId.hashCode());
        double userPercentile = (hash % 100) / 100.0;
        
        return userPercentile < rolloutPercentage;
    }
    
    @Scheduled(fixedRate = 300000) // æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    public void adjustRolloutPercentage() {
        double currentErrorRate = getCurrentErrorRate();
        
        if (currentErrorRate < 0.01) { // é”™è¯¯ç‡ä½äº1%
            // å¯ä»¥å¢åŠ å‘å¸ƒæ¯”ä¾‹
            rolloutPercentage = Math.min(1.0, rolloutPercentage + 0.1);
        } else if (currentErrorRate > 0.05) { // é”™è¯¯ç‡é«˜äº5%
            // éœ€è¦å›æ»š
            rolloutPercentage = Math.max(0.0, rolloutPercentage - 0.2);
        }
        
        log.info("æ¸è¿›å¼å‘å¸ƒæ¯”ä¾‹è°ƒæ•´ä¸ºï¼š{}%", rolloutPercentage * 100);
    }
}
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æœåŠ¡é™çº§ï¼šç³»ç»Ÿå‹åŠ›å¤§æ—¶ä¸»åŠ¨å…³é—­éæ ¸å¿ƒåŠŸèƒ½ï¼Œä¿è¯æ ¸å¿ƒä¸šåŠ¡æ­£å¸¸
ğŸ”¸ ç†”æ–­å™¨ï¼šæœåŠ¡å¼‚å¸¸æ—¶è‡ªåŠ¨æ–­å¼€è°ƒç”¨ï¼Œä¿æŠ¤ç³»ç»Ÿç¨³å®šæ€§
ğŸ”¸ é™æµç®—æ³•ï¼šæ§åˆ¶ç³»ç»Ÿæµé‡ï¼Œé˜²æ­¢è¿‡è½½ï¼ˆä»¤ç‰Œæ¡¶ã€æ¼æ¡¶ã€æ»‘åŠ¨çª—å£ï¼‰
ğŸ”¸ èƒŒå‹å¤„ç†ï¼šå½“å¤„ç†èƒ½åŠ›è·Ÿä¸ä¸Šè¯·æ±‚é€Ÿåº¦æ—¶çš„åº”å¯¹ç­–ç•¥
ğŸ”¸ è‡ªé€‚åº”é™æµï¼šæ ¹æ®ç³»ç»Ÿå®æ—¶çŠ¶æ€åŠ¨æ€è°ƒæ•´é™æµå‚æ•°
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ é™çº§çš„æœ¬è´¨**
```
é™çº§ä¸æ˜¯ç³»ç»Ÿæ•…éšœï¼Œè€Œæ˜¯ä¸»åŠ¨çš„ä¿æŠ¤æœºåˆ¶
ç›®æ ‡æ˜¯"ä¿è¯æ ¸å¿ƒåŠŸèƒ½å¯ç”¨"è€Œä¸æ˜¯"æ‰€æœ‰åŠŸèƒ½éƒ½è¦å·¥ä½œ"
å°±åƒç´§æ€¥æƒ…å†µä¸‹æ±½è½¦å…³é—­ç©ºè°ƒä¿è¯å‘åŠ¨æœºæ­£å¸¸å·¥ä½œ
```

**ğŸ”¹ é™æµç®—æ³•é€‰æ‹©**
```
å›ºå®šçª—å£ï¼šå®ç°ç®€å•ï¼Œä½†æœ‰çªåˆºé—®é¢˜ â†’ é€‚åˆç®€å•è®¡æ•°
æ»‘åŠ¨çª—å£ï¼šå¹³æ»‘é™æµï¼Œå®ç°å¤æ‚ â†’ é€‚åˆç²¾ç¡®æ§åˆ¶
ä»¤ç‰Œæ¡¶ï¼šæ”¯æŒçªå‘æµé‡ â†’ é€‚åˆç”¨æˆ·ä½“éªŒæ•æ„Ÿåœºæ™¯
æ¼æ¡¶ï¼šè¾“å‡ºå¹³æ»‘ â†’ é€‚åˆä¿æŠ¤ä¸‹æ¸¸ç³»ç»Ÿ
```

**ğŸ”¹ å®¹é”™ç­–ç•¥é€‰æ‹©**
```
å¿«é€Ÿå¤±è´¥ï¼šèµ„æºæ¶ˆè€—å°ï¼Œå“åº”å¿« â†’ é€‚åˆéæ ¸å¿ƒåŠŸèƒ½
æ•…éšœè½¬ç§»ï¼šä¿è¯å¯ç”¨æ€§ï¼Œæˆæœ¬é«˜ â†’ é€‚åˆæ ¸å¿ƒä¸šåŠ¡
é™çº§å¤„ç†ï¼šæä¾›åŸºç¡€æœåŠ¡ â†’ é€‚åˆå¯ç®€åŒ–çš„åŠŸèƒ½
```

### 10.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ”¸ è®¾è®¡åŸåˆ™**
- **åˆ†çº§è®¾è®¡**ï¼šä¸åŒé‡è¦æ€§çš„åŠŸèƒ½é‡‡ç”¨ä¸åŒçš„å®¹é”™ç­–ç•¥
- **é¢„æ¡ˆå‡†å¤‡**ï¼šæå‰å‡†å¤‡å¥½å„ç§å¼‚å¸¸æƒ…å†µçš„åº”å¯¹æ–¹æ¡ˆ
- **ç›‘æ§ä¸ºå…ˆ**ï¼šå®Œå–„çš„ç›‘æ§æ˜¯å®¹é”™æœºåˆ¶æœ‰æ•ˆè¿è¡Œçš„åŸºç¡€
- **æ¸è¿›å‘å¸ƒ**ï¼šæ–°çš„å®¹é”™ç­–ç•¥è¦å°èŒƒå›´éªŒè¯åå†å…¨é¢æ¨å¹¿

**ğŸ”¸ å‚æ•°è°ƒä¼˜**
- **ä»ä¿å®ˆå¼€å§‹**ï¼šåˆå§‹å‚æ•°è®¾ç½®åä¿å®ˆï¼Œé¿å…è¿‡åº¦é™åˆ¶
- **æ•°æ®é©±åŠ¨**ï¼šåŸºäºçœŸå®çš„ç›‘æ§æ•°æ®è°ƒæ•´å‚æ•°
- **å®šæœŸå›é¡¾**ï¼šä¸šåŠ¡å˜åŒ–æ—¶è¦é‡æ–°è¯„ä¼°å®¹é”™å‚æ•°
- **A/Bæµ‹è¯•**ï¼šé€šè¿‡å¯¹æ¯”æµ‹è¯•éªŒè¯å®¹é”™ç­–ç•¥çš„æ•ˆæœ

**ğŸ”¸ è¿ç»´è¦ç‚¹**
- **å¿«é€Ÿå“åº”**ï¼šå»ºç«‹å¿«é€Ÿçš„å‘Šè­¦å’Œå“åº”æœºåˆ¶
- **æ‰‹åŠ¨å¹²é¢„**ï¼šä¿ç•™æ‰‹åŠ¨è°ƒæ•´å®¹é”™ç­‰çº§çš„èƒ½åŠ›
- **æ•…éšœæ¼”ç»ƒ**ï¼šå®šæœŸè¿›è¡Œæ•…éšœåœºæ™¯æ¼”ç»ƒ
- **ç»éªŒç§¯ç´¯**ï¼šè®°å½•å’Œåˆ†ææ¯æ¬¡æ•…éšœçš„å¤„ç†è¿‡ç¨‹

### 10.4 å¸¸è§è¯¯åŒºé¿å…


```
âŒ è¯¯åŒº1ï¼šæ‰€æœ‰æœåŠ¡éƒ½ç”¨ç›¸åŒçš„é™æµå‚æ•°
âœ… æ­£ç¡®ï¼šæ ¹æ®æœåŠ¡ç‰¹ç‚¹è®¾ç½®ä¸åŒçš„é™æµç­–ç•¥

âŒ è¯¯åŒº2ï¼šè®¾ç½®é™æµåå°±ä¸ç®¡äº†
âœ… æ­£ç¡®ï¼šæŒç»­ç›‘æ§å’Œè°ƒä¼˜é™æµå‚æ•°

âŒ è¯¯åŒº3ï¼šé™çº§å°±æ˜¯è¿”å›é”™è¯¯
âœ… æ­£ç¡®ï¼šé™çº§åº”è¯¥æä¾›æ›¿ä»£æ–¹æ¡ˆï¼Œä¿è¯åŸºç¡€åŠŸèƒ½

âŒ è¯¯åŒº4ï¼šç†”æ–­å™¨ä¸€æ‰“å¼€å°±ç­‰ç€æ¢å¤
âœ… æ­£ç¡®ï¼šä¸»åŠ¨ç›‘æ§ä¸‹æ¸¸æœåŠ¡çŠ¶æ€ï¼ŒåŠæ—¶æ¢å¤

âŒ è¯¯åŒº5ï¼šåªå…³æ³¨æŠ€æœ¯æŒ‡æ ‡ï¼Œå¿½ç•¥ä¸šåŠ¡å½±å“
âœ… æ­£ç¡®ï¼šå¹³è¡¡æŠ€æœ¯ä¿æŠ¤å’Œç”¨æˆ·ä½“éªŒ
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
æœåŠ¡é™çº§æœ‰é¢„æ¡ˆï¼Œæ ¸å¿ƒåŠŸèƒ½è¦ä¿å…¨
é™æµç®—æ³•è¦é€‰å¯¹ï¼Œçªå‘å¹³æ»‘å„æœ‰ä½
ç†”æ–­ä¿æŠ¤é˜²é›ªå´©ï¼Œå¿«é€Ÿå¤±è´¥æˆ–è½¬ç§»
èƒŒå‹å¤„ç†æ§é˜Ÿåˆ—ï¼Œè‡ªé€‚åº”è°ƒæœ€ç»™åŠ›
ç›‘æ§å‘Šè­¦ä¸èƒ½å°‘ï¼Œæ¸è¿›å‘å¸ƒé£é™©å°
```