---
title: 1ã€èº«ä»½è®¤è¯ä¸æˆæƒ
---
## ğŸ“š ç›®å½•

1. [è®¤è¯ä¸æˆæƒåŸºç¡€æ¦‚å¿µ](#1-è®¤è¯ä¸æˆæƒåŸºç¡€æ¦‚å¿µ)
2. [Tokenè®¤è¯æœºåˆ¶](#2-Tokenè®¤è¯æœºåˆ¶)
3. [è¯ä¹¦è®¤è¯è¯¦è§£](#3-è¯ä¹¦è®¤è¯è¯¦è§£)
4. [æˆæƒæ¨¡å‹æ·±å…¥](#4-æˆæƒæ¨¡å‹æ·±å…¥)
5. [OAuth2ä¸JWTå®æˆ˜](#5-OAuth2ä¸JWTå®æˆ˜)
6. [åŒå‘è®¤è¯æœºåˆ¶](#6-åŒå‘è®¤è¯æœºåˆ¶)
7. [æƒé™æ§åˆ¶ä¸è®¿é—®é™åˆ¶](#7-æƒé™æ§åˆ¶ä¸è®¿é—®é™åˆ¶)
8. [å•ç‚¹ç™»å½•SSOå®ç°](#8-å•ç‚¹ç™»å½•SSOå®ç°)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” è®¤è¯ä¸æˆæƒåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯è®¤è¯å’Œæˆæƒï¼Ÿ


> ğŸ’¡ **é€šä¿—ç†è§£**ï¼šè®¤è¯å°±æ˜¯éªŒè¯"ä½ æ˜¯è°"ï¼Œæˆæƒå°±æ˜¯å†³å®š"ä½ èƒ½åšä»€ä¹ˆ"

```
ç°å®ç”Ÿæ´»ç±»æ¯”ï¼š
è¿›å…¥åŠå…¬å¤§æ¥¼æ—¶ï¼š
1. åˆ·å‘˜å·¥å¡ â†’ è®¤è¯ï¼ˆè¯æ˜ä½ æ˜¯å…¬å¸å‘˜å·¥ï¼‰
2. è¿›å…¥ç‰¹å®šæ¥¼å±‚ â†’ æˆæƒï¼ˆä½ çš„æƒé™å†³å®šèƒ½å»å“ªäº›æ¥¼å±‚ï¼‰

RPCæœåŠ¡ä¸­ï¼š
1. å®¢æˆ·ç«¯æä¾›èº«ä»½å‡­è¯ â†’ è®¤è¯
2. æœåŠ¡ç«¯æ£€æŸ¥æ“ä½œæƒé™ â†’ æˆæƒ
```

### 1.2 ä¸ºä»€ä¹ˆRPCéœ€è¦å®‰å…¨æœºåˆ¶ï¼Ÿ


**ğŸš¨ å®‰å…¨é£é™©**ï¼š
```
æ— ä¿æŠ¤çš„RPCæœåŠ¡é¢ä¸´çš„é—®é¢˜ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ¶æ„å®¢æˆ·ç«¯    â”‚â”€â”€â”€â†’â”‚   RPCæœåŠ¡ç«¯     â”‚
â”‚                 â”‚    â”‚  ä»»ä½•äººéƒ½èƒ½è°ƒç”¨  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¯èƒ½å¯¼è‡´ï¼š
â€¢ æ•°æ®æ³„éœ²ï¼šæ•æ„Ÿä¿¡æ¯è¢«çªƒå–
â€¢ æœåŠ¡æ»¥ç”¨ï¼šæ¥å£è¢«æ¶æ„è°ƒç”¨
â€¢ æƒé™è¶Šç•Œï¼šæ™®é€šç”¨æˆ·æ‰§è¡Œç®¡ç†å‘˜æ“ä½œ
â€¢ æ‹’ç»æœåŠ¡ï¼šå¤§é‡æ— æ•ˆè¯·æ±‚å¯¼è‡´æœåŠ¡ç˜«ç—ª
```

### 1.3 è®¤è¯å’Œæˆæƒçš„åŒºåˆ«


| æ–¹é¢ | **è®¤è¯ (Authentication)** | **æˆæƒ (Authorization)** |
|------|-------------------------|------------------------|
| **ç›®çš„** | éªŒè¯èº«ä»½çœŸå®æ€§ | æ§åˆ¶è®¿é—®æƒé™ |
| **é—®é¢˜** | "ä½ æ˜¯è°ï¼Ÿ" | "ä½ èƒ½åšä»€ä¹ˆï¼Ÿ" |
| **æ—¶æœº** | ç¬¬ä¸€æ­¥ï¼Œå»ºç«‹ä¿¡ä»» | ç¬¬äºŒæ­¥ï¼Œæƒé™æ£€æŸ¥ |
| **ç»“æœ** | èº«ä»½ç¡®è®¤ | æƒé™èŒƒå›´ |

---

## 2. ğŸ« Tokenè®¤è¯æœºåˆ¶


### 2.1 ä»€ä¹ˆæ˜¯Tokenè®¤è¯ï¼Ÿ


> ğŸ’¡ **Tokenå°±åƒä¸´æ—¶é€šè¡Œè¯**ï¼šç”¨æˆ·ç™»å½•åè·å¾—ä¸€ä¸ªä»¤ç‰Œï¼Œåç»­è¯·æ±‚æºå¸¦è¿™ä¸ªä»¤ç‰Œè¯æ˜èº«ä»½

**ğŸ”‘ Tokenè®¤è¯æµç¨‹**ï¼š
```
ç”¨æˆ·ç™»å½•æµç¨‹ï¼š
ç”¨æˆ·ç«¯                    è®¤è¯æœåŠ¡                  ä¸šåŠ¡æœåŠ¡
  |                        |                        |
  |--[1]ç”¨æˆ·åå¯†ç ç™»å½•----->|                        |
  |                        |--[2]éªŒè¯ç”¨æˆ·ä¿¡æ¯------->|æ•°æ®åº“
  |                        |<-[3]éªŒè¯æˆåŠŸ-----------|
  |<--[4]è¿”å›Token---------|                        |
  |                        |                        |
  |--[5]æºå¸¦Tokenè¯·æ±‚æ¥å£---------------->|
  |                                       |--[6]éªŒè¯Token
  |<--[7]è¿”å›ä¸šåŠ¡æ•°æ®---------------------|
```

### 2.2 JWT Tokenè¯¦è§£


**ğŸ¯ JWTæ˜¯ä»€ä¹ˆï¼Ÿ**
> JWT (JSON Web Token) æ˜¯ä¸€ç§å¼€æ”¾æ ‡å‡†ï¼Œç”¨äºåœ¨å„æ–¹ä¹‹é—´å®‰å…¨ä¼ è¾“ä¿¡æ¯

**JWTç»“æ„è§£æ**ï¼š
```
JWT Tokenæ ¼å¼ï¼šHeader.Payload.Signature

ç¤ºä¾‹JWTï¼š
eyJhbGciOiJIUzI1NiJ9.eyJ1c2VySWQiOjEyM30.Hs_LFNEw-dELJLtYWC8UITd

åˆ†è§£åï¼š
Header:  {"alg":"HS256","typ":"JWT"}
Payload: {"userId":123,"exp":1640995200}  
Signature: Hs_LFNEw-dELJLtYWC8UITd (ç­¾åéªŒè¯)
```

**ğŸ’» JWTå®ç°ç¤ºä¾‹**ï¼š
```java
// JWTç”Ÿæˆ
public String generateToken(Long userId) {
    return JWT.create()
        .withSubject(userId.toString())           // ç”¨æˆ·ID
        .withExpiresAt(new Date(System.currentTimeMillis() + 86400000)) // 24å°æ—¶è¿‡æœŸ
        .sign(Algorithm.HMAC256("your-secret-key"));
}

// JWTéªŒè¯
public Long validateToken(String token) {
    try {
        DecodedJWT jwt = JWT.require(Algorithm.HMAC256("your-secret-key"))
            .build()
            .verify(token);
        return Long.parseLong(jwt.getSubject());
    } catch (Exception e) {
        throw new RuntimeException("Tokenæ— æ•ˆ");
    }
}
```

### 2.3 è‡ªå®šä¹‰Tokenæ–¹æ¡ˆ


**ğŸ”§ ç®€å•Tokenå®ç°**ï¼š
```java
// è‡ªå®šä¹‰Tokenæ ¼å¼ï¼šuserId:timestamp:signature
public class CustomTokenService {
    private String secretKey = "mySecretKey";
    
    // ç”ŸæˆToken
    public String generateToken(Long userId) {
        long timestamp = System.currentTimeMillis();
        String data = userId + ":" + timestamp;
        String signature = md5(data + secretKey);
        return data + ":" + signature;
    }
    
    // éªŒè¯Token
    public Long validateToken(String token) {
        String[] parts = token.split(":");
        if (parts.length != 3) return null;
        
        String data = parts[0] + ":" + parts[1];
        String expectedSignature = md5(data + secretKey);
        
        if (!expectedSignature.equals(parts[2])) {
            return null; // ç­¾åä¸åŒ¹é…
        }
        
        long timestamp = Long.parseLong(parts[1]);
        if (System.currentTimeMillis() - timestamp > 86400000) {
            return null; // Tokenå·²è¿‡æœŸ
        }
        
        return Long.parseLong(parts[0]);
    }
}
```

### 2.4 API Keyè®¤è¯


**ğŸ”‘ API Keyæ˜¯ä»€ä¹ˆï¼Ÿ**
> API Keyå°±åƒé—¨ç¦å¡å·ï¼Œæ¯ä¸ªå®¢æˆ·ç«¯åˆ†é…ä¸€ä¸ªå”¯ä¸€å¯†é’¥

**API Keyä½¿ç”¨æ–¹å¼**ï¼š
```java
// 1. è¯·æ±‚å¤´æ–¹å¼
curl -H "X-API-Key: ak_1234567890abcdef" http://api.example.com/users

// 2. æŸ¥è¯¢å‚æ•°æ–¹å¼  
curl "http://api.example.com/users?api_key=ak_1234567890abcdef"

// 3. æœåŠ¡ç«¯éªŒè¯
@RestController
public class ApiController {
    
    @Autowired
    private ApiKeyService apiKeyService;
    
    @GetMapping("/users")
    public List<User> getUsers(@RequestHeader("X-API-Key") String apiKey) {
        if (!apiKeyService.isValidKey(apiKey)) {
            throw new UnauthorizedException("æ— æ•ˆçš„API Key");
        }
        return userService.getUsers();
    }
}
```

---

## 3. ğŸ“œ è¯ä¹¦è®¤è¯è¯¦è§£


### 3.1 ä»€ä¹ˆæ˜¯è¯ä¹¦è®¤è¯ï¼Ÿ


> ğŸ’¡ **è¯ä¹¦è®¤è¯å°±åƒèº«ä»½è¯**ï¼šé€šè¿‡æ•°å­—è¯ä¹¦è¯æ˜èº«ä»½ï¼Œæ¯”å¯†ç æ›´å®‰å…¨å¯é 

**ğŸ† è¯ä¹¦è®¤è¯ä¼˜åŠ¿**ï¼š
```
å¯†ç è®¤è¯ vs è¯ä¹¦è®¤è¯ï¼š

å¯†ç è®¤è¯ï¼š
ç”¨æˆ·ç«¯ --[ç”¨æˆ·å+å¯†ç ]--> æœåŠ¡ç«¯
â€¢ å®¹æ˜“è¢«ç ´è§£æˆ–æ³„éœ²
â€¢ éœ€è¦è®°å¿†ç®¡ç†
â€¢ ä¼ è¾“è¿‡ç¨‹å¯èƒ½è¢«æˆªè·

è¯ä¹¦è®¤è¯ï¼š
ç”¨æˆ·ç«¯ --[æ•°å­—è¯ä¹¦+ç§é’¥ç­¾å]--> æœåŠ¡ç«¯  
â€¢ åŸºäºéå¯¹ç§°åŠ å¯†ï¼Œæéš¾ç ´è§£
â€¢ æ— éœ€è®°å¿†ï¼Œå­˜å‚¨åœ¨è®¾å¤‡ä¸­
â€¢ ç­¾åéªŒè¯ç¡®ä¿æœªè¢«ç¯¡æ”¹
```

### 3.2 X.509è¯ä¹¦è¯¦è§£


**ğŸ“‹ X.509è¯ä¹¦åŒ…å«ä»€ä¹ˆï¼Ÿ**
```
X.509è¯ä¹¦å†…å®¹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç‰ˆæœ¬å·ï¼šV3                   â”‚
â”‚ åºåˆ—å·ï¼š123456789           â”‚
â”‚ ç­¾åç®—æ³•ï¼šSHA256-RSA        â”‚
â”‚ é¢å‘è€…ï¼šCAæœºæ„ä¿¡æ¯          â”‚
â”‚ æœ‰æ•ˆæœŸï¼š2024-01-01 åˆ° 2025  â”‚
â”‚ ä¸»ä½“ï¼šæœåŠ¡åç§°/åŸŸå         â”‚
â”‚ å…¬é’¥ï¼šRSA 2048ä½           â”‚
â”‚ æ‰©å±•å­—æ®µï¼šç”¨é€”é™åˆ¶ç­‰        â”‚
â”‚ æ•°å­—ç­¾åï¼šCAçš„ç­¾å          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ’» è¯ä¹¦ç”Ÿæˆç¤ºä¾‹**ï¼š
```bash
# 1. ç”Ÿæˆç§é’¥
openssl genrsa -out server.key 2048

# 2. ç”Ÿæˆè¯ä¹¦ç­¾åè¯·æ±‚
openssl req -new -key server.key -out server.csr \
    -subj "/C=CN/ST=Beijing/L=Beijing/O=MyCompany/CN=api.mycompany.com"

# 3. ç”Ÿæˆè‡ªç­¾åè¯ä¹¦
openssl x509 -req -in server.csr -signkey server.key -out server.crt -days 365
```

### 3.3 åŒå‘TLSè®¤è¯


**ğŸ” ä»€ä¹ˆæ˜¯åŒå‘TLSï¼Ÿ**
> ä¸ä»…æœåŠ¡ç«¯è¦è¯æ˜èº«ä»½ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯ä¹Ÿè¦è¯æ˜èº«ä»½ç»™æœåŠ¡ç«¯

**åŒå‘TLSæ¡æ‰‹è¿‡ç¨‹**ï¼š
```
å®¢æˆ·ç«¯                               æœåŠ¡ç«¯
  |                                    |
  |--[1]Client Hello---------------->|
  |<--[2]Server Hello + æœåŠ¡ç«¯è¯ä¹¦----|
  |<--[3]Certificate Request---------|  è¦æ±‚å®¢æˆ·ç«¯è¯ä¹¦
  |--[4]å®¢æˆ·ç«¯è¯ä¹¦ + å®Œæˆæ¡æ‰‹------->|
  |<--[5]æ¡æ‰‹å®Œæˆ--------------------|
  |                                    |
  |====== åŠ å¯†é€šé“å»ºç«‹å®Œæˆ ======|
```

**Javaä¸­çš„åŒå‘TLSé…ç½®**ï¼š
```java
// å®¢æˆ·ç«¯é…ç½®
SSLContext sslContext = SSLContext.getInstance("TLS");
KeyManagerFactory kmf = KeyManagerFactory.getInstance("SunX509");
kmf.init(clientKeyStore, "password".toCharArray());

TrustManagerFactory tmf = TrustManagerFactory.getInstance("SunX509");
tmf.init(trustStore);

sslContext.init(kmf.getKeyManagers(), tmf.getTrustManagers(), null);

// æœåŠ¡ç«¯é…ç½®  
@Bean
public TomcatServletWebServerFactory servletContainer() {
    TomcatServletWebServerFactory factory = new TomcatServletWebServerFactory();
    factory.addConnectorCustomizers(connector -> {
        connector.setSecure(true);
        connector.setProperty("SSLEnabled", "true");
        connector.setProperty("keystoreFile", "server.p12");
        connector.setProperty("keystorePass", "password");
        connector.setProperty("truststoreFile", "truststore.p12");
        connector.setProperty("clientAuth", "true"); // è¦æ±‚å®¢æˆ·ç«¯è¯ä¹¦
    });
    return factory;
}
```

---

## 4. âš–ï¸ æˆæƒæ¨¡å‹æ·±å…¥


### 4.1 RBACï¼šåŸºäºè§’è‰²çš„æƒé™æ§åˆ¶


**ğŸ­ RBACæ˜¯ä»€ä¹ˆï¼Ÿ**
> RBACå°±åƒå…¬å¸çš„èŒä½ä½“ç³»ï¼šä¸åŒèŒä½æœ‰ä¸åŒæƒé™ï¼Œå‘˜å·¥æ ¹æ®èŒä½è·å¾—å¯¹åº”æƒé™

**RBACæ¨¡å‹ç»“æ„**ï¼š
```
RBACæƒé™æ¨¡å‹ï¼š
ç”¨æˆ·(User) â† åˆ†é… â†’ è§’è‰²(Role) â† æˆæƒ â†’ æƒé™(Permission)

ä¸¾ä¾‹è¯´æ˜ï¼š
ç”¨æˆ·ï¼šå¼ ä¸‰ã€æå››ã€ç‹äº”
è§’è‰²ï¼šç®¡ç†å‘˜ã€ç¼–è¾‘è€…ã€æŸ¥çœ‹è€…  
æƒé™ï¼šè¯»å–ã€å†™å…¥ã€åˆ é™¤

å…³ç³»æ˜ å°„ï¼š
å¼ ä¸‰ â†’ ç®¡ç†å‘˜è§’è‰² â†’ è¯»å–+å†™å…¥+åˆ é™¤æƒé™
æå›› â†’ ç¼–è¾‘è€…è§’è‰² â†’ è¯»å–+å†™å…¥æƒé™
ç‹äº” â†’ æŸ¥çœ‹è€…è§’è‰² â†’ è¯»å–æƒé™
```

**ğŸ’» RBACå®ç°ç¤ºä¾‹**ï¼š
```java
@Entity
public class User {
    private Long id;
    private String username;
    @ManyToMany
    private Set<Role> roles; // ç”¨æˆ·æ‹¥æœ‰çš„è§’è‰²
}

@Entity  
public class Role {
    private Long id;
    private String name;
    @ManyToMany
    private Set<Permission> permissions; // è§’è‰²æ‹¥æœ‰çš„æƒé™
}

@Entity
public class Permission {
    private Long id;
    private String resource; // èµ„æºåç§°ï¼Œå¦‚ "user"
    private String action;   // æ“ä½œåç§°ï¼Œå¦‚ "read", "write"
}

// æƒé™æ£€æŸ¥æœåŠ¡
@Service
public class AuthorizationService {
    
    public boolean hasPermission(Long userId, String resource, String action) {
        User user = userRepository.findById(userId);
        return user.getRoles().stream()
            .flatMap(role -> role.getPermissions().stream())
            .anyMatch(perm -> perm.getResource().equals(resource) 
                           && perm.getAction().equals(action));
    }
}
```

### 4.2 ABACï¼šåŸºäºå±æ€§çš„æƒé™æ§åˆ¶


**ğŸ·ï¸ ABACæ˜¯ä»€ä¹ˆï¼Ÿ**
> ABACåƒæ™ºèƒ½é—¨ç¦ç³»ç»Ÿï¼šæ ¹æ®äººå‘˜å±æ€§ã€æ—¶é—´ã€åœ°ç‚¹ç­‰å¤šä¸ªæ¡ä»¶å†³å®šæ˜¯å¦å…è®¸è®¿é—®

**ABAC vs RBACå¯¹æ¯”**ï¼š
```
åœºæ™¯ï¼šè®¿é—®ç”¨æˆ·æ•°æ®

RBACæ–¹å¼ï¼š
if (ç”¨æˆ·.è§’è‰² == "æ•°æ®ç®¡ç†å‘˜") {
    å…è®¸è®¿é—®;
}

ABACæ–¹å¼ï¼š  
if (ç”¨æˆ·.éƒ¨é—¨ == "äººäº‹éƒ¨" && 
    å½“å‰æ—¶é—´ åœ¨ å·¥ä½œæ—¶é—´ && 
    è®¿é—®çš„æ•°æ®.éƒ¨é—¨ == ç”¨æˆ·.éƒ¨é—¨ &&
    ç”¨æˆ·.çº§åˆ« >= æ•°æ®.æ•æ„Ÿçº§åˆ«) {
    å…è®¸è®¿é—®;
}
```

**ğŸ’» ABACå®ç°ç¤ºä¾‹**ï¼š
```java
public class PolicyEngine {
    
    public boolean evaluate(Subject subject, Resource resource, Action action, Environment env) {
        // æ„å»ºå±æ€§é›†åˆ
        Map<String, Object> attributes = new HashMap<>();
        attributes.put("subject.department", subject.getDepartment());
        attributes.put("subject.level", subject.getLevel());
        attributes.put("resource.sensitivity", resource.getSensitivity());
        attributes.put("environment.time", env.getCurrentTime());
        attributes.put("environment.location", env.getLocation());
        
        // è¯„ä¼°ç­–ç•¥è§„åˆ™
        return evaluateRules(attributes);
    }
    
    private boolean evaluateRules(Map<String, Object> attributes) {
        // è§„åˆ™1ï¼šåŒéƒ¨é—¨è®¿é—®é™åˆ¶
        if (!attributes.get("subject.department").equals(attributes.get("resource.department"))) {
            return false;
        }
        
        // è§„åˆ™2ï¼šçº§åˆ«æƒé™æ£€æŸ¥
        if ((Integer)attributes.get("subject.level") < (Integer)attributes.get("resource.sensitivity")) {
            return false;
        }
        
        // è§„åˆ™3ï¼šå·¥ä½œæ—¶é—´é™åˆ¶
        LocalTime currentTime = (LocalTime)attributes.get("environment.time");
        if (currentTime.isBefore(LocalTime.of(9, 0)) || currentTime.isAfter(LocalTime.of(18, 0))) {
            return false;
        }
        
        return true;
    }
}
```

---

## 5. ğŸ”‘ OAuth2ä¸JWTå®æˆ˜


### 5.1 OAuth2åœ¨RPCä¸­çš„åº”ç”¨


**ğŸ¤ OAuth2æ˜¯ä»€ä¹ˆï¼Ÿ**
> OAuth2å°±åƒé…’åº—æˆ¿å¡ç³»ç»Ÿï¼šä½ å¯ä»¥æˆæƒåˆ«äººä½¿ç”¨ä½ çš„æˆ¿é—´ï¼Œä½†ä¸éœ€è¦ç»™ä»–ä»¬ä½ çš„å¯†ç 

**OAuth2æˆæƒæµç¨‹**ï¼š
```
å¾®æœåŠ¡OAuth2æµç¨‹ï¼š

å®¢æˆ·ç«¯åº”ç”¨                æˆæƒæœåŠ¡å™¨                 èµ„æºæœåŠ¡å™¨(RPCæœåŠ¡)
     |                        |                           |
     |--[1]è¯·æ±‚æˆæƒç --------->|                           |
     |<--[2]è¿”å›æˆæƒç ---------|                           |
     |--[3]æˆæƒç æ¢å–Token---->|                           |
     |<--[4]è¿”å›Access Token---|                           |
     |                        |                           |
     |--[5]æºå¸¦Tokenè°ƒç”¨RPCæ¥å£------------------------>|
     |                        |<--[6]éªŒè¯Token-------------|
     |                        |---[7]Tokenæœ‰æ•ˆæ€§ç¡®è®¤------>|
     |<--[8]è¿”å›å—ä¿æŠ¤èµ„æº------------------------|
```

**ğŸ’» OAuth2å®¢æˆ·ç«¯å®ç°**ï¼š
```java
@Service
public class OAuth2ClientService {
    
    @Value("${oauth2.authorization-server.token-uri}")
    private String tokenUri;
    
    @Value("${oauth2.client.id}")
    private String clientId;
    
    @Value("${oauth2.client.secret}")
    private String clientSecret;
    
    // è·å–è®¿é—®ä»¤ç‰Œ
    public String getAccessToken(String authorizationCode) {
        RestTemplate restTemplate = new RestTemplate();
        
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);
        
        MultiValueMap<String, String> params = new LinkedMultiValueMap<>();
        params.add("grant_type", "authorization_code");
        params.add("client_id", clientId);
        params.add("client_secret", clientSecret);
        params.add("code", authorizationCode);
        
        HttpEntity<MultiValueMap<String, String>> request = new HttpEntity<>(params, headers);
        
        TokenResponse response = restTemplate.postForObject(tokenUri, request, TokenResponse.class);
        return response.getAccessToken();
    }
}
```

### 5.2 JWTåœ¨æœåŠ¡é—´è®¤è¯ä¸­çš„åº”ç”¨


**ğŸ”„ æœåŠ¡é—´JWTä¼ é€’**ï¼š
```
ç”¨æˆ·è¯·æ±‚ â†’ ç½‘å…³ â†’ æœåŠ¡A â†’ æœåŠ¡B â†’ æœåŠ¡C

æ¯ä¸ªæœåŠ¡éƒ½éœ€è¦éªŒè¯JWTï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æœåŠ¡A       â”‚â”€â”€â”€â†’â”‚   æœåŠ¡B       â”‚â”€â”€â”€â†’â”‚   æœåŠ¡C       â”‚
â”‚ 1.éªŒè¯JWT     â”‚    â”‚ 1.éªŒè¯JWT     â”‚    â”‚ 1.éªŒè¯JWT     â”‚  
â”‚ 2.è§£æç”¨æˆ·ä¿¡æ¯ â”‚    â”‚ 2.è§£æç”¨æˆ·ä¿¡æ¯ â”‚    â”‚ 2.è§£æç”¨æˆ·ä¿¡æ¯ â”‚
â”‚ 3.ä¼ é€’JWT     â”‚    â”‚ 3.ä¼ é€’JWT     â”‚    â”‚ 3.å¤„ç†ä¸šåŠ¡    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ’» æœåŠ¡é—´JWTä¼ é€’å®ç°**ï¼š
```java
// RPCå®¢æˆ·ç«¯æ‹¦æˆªå™¨ï¼šè‡ªåŠ¨æ·»åŠ JWT
@Component
public class JwtClientInterceptor implements RequestInterceptor {
    
    @Override
    public void apply(RequestTemplate template) {
        String jwt = getCurrentJwt(); // ä»ä¸Šä¸‹æ–‡è·å–JWT
        if (jwt != null) {
            template.header("Authorization", "Bearer " + jwt);
        }
    }
    
    private String getCurrentJwt() {
        // ä»ThreadLocalæˆ–è¯·æ±‚ä¸Šä¸‹æ–‡è·å–JWT
        return RequestContextHolder.getCurrentRequest().getHeader("Authorization");
    }
}

// RPCæœåŠ¡ç«¯æ‹¦æˆªå™¨ï¼šéªŒè¯JWT
@Component  
public class JwtServerInterceptor implements HandlerInterceptor {
    
    @Autowired
    private JwtTokenUtil jwtTokenUtil;
    
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {
        String token = extractToken(request);
        if (token == null || !jwtTokenUtil.validateToken(token)) {
            response.setStatus(HttpStatus.UNAUTHORIZED.value());
            return false;
        }
        
        // å°†ç”¨æˆ·ä¿¡æ¯è®¾ç½®åˆ°ä¸Šä¸‹æ–‡
        UserContext.setCurrentUser(jwtTokenUtil.parseToken(token));
        return true;
    }
    
    private String extractToken(HttpServletRequest request) {
        String bearerToken = request.getHeader("Authorization");
        if (bearerToken != null && bearerToken.startsWith("Bearer ")) {
            return bearerToken.substring(7);
        }
        return null;
    }
}
```

---

## 6. ğŸ¤ åŒå‘è®¤è¯æœºåˆ¶


### 6.1 ä»€ä¹ˆæ˜¯åŒå‘è®¤è¯ï¼Ÿ


> ğŸ’¡ **åŒå‘è®¤è¯**ï¼šä¸ä»…æœåŠ¡ç«¯è¦éªŒè¯å®¢æˆ·ç«¯èº«ä»½ï¼Œå®¢æˆ·ç«¯ä¹Ÿè¦éªŒè¯æœåŠ¡ç«¯èº«ä»½

**ğŸ”„ åŒå‘è®¤è¯æµç¨‹**ï¼š
```
å•å‘è®¤è¯ï¼ˆå¸¸è§çš„HTTPSï¼‰ï¼š
å®¢æˆ·ç«¯ â†’ éªŒè¯æœåŠ¡ç«¯è¯ä¹¦ â†’ ä¿¡ä»»æœåŠ¡ç«¯

åŒå‘è®¤è¯ï¼ˆmTLSï¼‰ï¼š  
å®¢æˆ·ç«¯ â†â†’ ç›¸äº’éªŒè¯è¯ä¹¦ â†â†’ æœåŠ¡ç«¯
      â†‘                    â†“
   éªŒè¯æœåŠ¡ç«¯è¯ä¹¦      éªŒè¯å®¢æˆ·ç«¯è¯ä¹¦
```

### 6.2 mTLSåœ¨RPCä¸­çš„å®ç°


**ğŸ’» gRPC mTLSé…ç½®**ï¼š
```java
// æœåŠ¡ç«¯é…ç½®
@Configuration
public class GrpcServerConfig {
    
    @Bean
    public NettyChannelBuilder createSecureChannel() throws Exception {
        // åŠ è½½æœåŠ¡ç«¯è¯ä¹¦å’Œç§é’¥
        File certFile = new File("server.crt");
        File keyFile = new File("server.key");
        
        // åŠ è½½å®¢æˆ·ç«¯CAè¯ä¹¦ï¼ˆç”¨äºéªŒè¯å®¢æˆ·ç«¯ï¼‰
        File caCertFile = new File("ca.crt");
        
        SslContext sslContext = GrpcSslContexts.forServer(certFile, keyFile)
            .trustManager(caCertFile) // ä¿¡ä»»çš„å®¢æˆ·ç«¯CA
            .clientAuth(ClientAuth.REQUIRE) // è¦æ±‚å®¢æˆ·ç«¯è¯ä¹¦
            .build();
            
        return NettyChannelBuilder.forAddress("localhost", 9090)
            .sslContext(sslContext)
            .build();
    }
}

// å®¢æˆ·ç«¯é…ç½®
@Configuration  
public class GrpcClientConfig {
    
    @Bean
    public ManagedChannel createSecureChannel() throws Exception {
        // åŠ è½½å®¢æˆ·ç«¯è¯ä¹¦å’Œç§é’¥
        File clientCertFile = new File("client.crt");
        File clientKeyFile = new File("client.key");
        
        // åŠ è½½æœåŠ¡ç«¯CAè¯ä¹¦ï¼ˆç”¨äºéªŒè¯æœåŠ¡ç«¯ï¼‰
        File caCertFile = new File("ca.crt");
        
        SslContext sslContext = GrpcSslContexts.forClient()
            .keyManager(clientCertFile, clientKeyFile) // å®¢æˆ·ç«¯èº«ä»½
            .trustManager(caCertFile) // ä¿¡ä»»çš„æœåŠ¡ç«¯CA
            .build();
            
        return NettyChannelBuilder.forAddress("localhost", 9090)
            .sslContext(sslContext)
            .build();
    }
}
```

### 6.3 èº«ä»½ä¿¡æ¯ä¼ é€’


**ğŸ“‹ è°ƒç”¨é“¾ä¸­èº«ä»½ä¿¡æ¯ä¼ é€’**ï¼š
```
è¯·æ±‚æµå‘ï¼šç”¨æˆ· â†’ æœåŠ¡A â†’ æœåŠ¡B â†’ æœåŠ¡C

èº«ä»½ä¿¡æ¯ä¼ é€’æ–¹å¼ï¼š
1. JWT Tokenä¼ é€’ï¼š
   æ¯ä¸ªæœåŠ¡è§£æJWTè·å–ç”¨æˆ·ä¿¡æ¯
   
2. è¯·æ±‚å¤´ä¼ é€’ï¼š
   X-User-ID: 123
   X-User-Role: admin
   X-Trace-ID: abc-def-123
   
3. ä¸Šä¸‹æ–‡å¯¹è±¡ä¼ é€’ï¼š
   UserContextåœ¨æ•´ä¸ªè°ƒç”¨é“¾ä¸­ä¿æŒç”¨æˆ·çŠ¶æ€
```

**ğŸ’» ç”¨æˆ·ä¸Šä¸‹æ–‡å®ç°**ï¼š
```java
// ç”¨æˆ·ä¸Šä¸‹æ–‡
public class UserContext {
    private static final ThreadLocal<UserInfo> context = new ThreadLocal<>();
    
    public static void setCurrentUser(UserInfo user) {
        context.set(user);
    }
    
    public static UserInfo getCurrentUser() {
        return context.get();
    }
    
    public static void clear() {
        context.remove();
    }
}

// RPCè°ƒç”¨æ‹¦æˆªå™¨
@Component
public class UserContextInterceptor {
    
    // å®¢æˆ·ç«¯å‘é€è¯·æ±‚å‰
    public void beforeRequest(RpcRequest request) {
        UserInfo currentUser = UserContext.getCurrentUser();
        if (currentUser != null) {
            request.addHeader("X-User-ID", currentUser.getUserId().toString());
            request.addHeader("X-User-Role", currentUser.getRole());
            request.addHeader("X-User-Name", currentUser.getUsername());
        }
    }
    
    // æœåŠ¡ç«¯æ¥æ”¶è¯·æ±‚å
    public void afterReceive(RpcRequest request) {
        String userId = request.getHeader("X-User-ID");
        String role = request.getHeader("X-User-Role");
        String username = request.getHeader("X-User-Name");
        
        if (userId != null) {
            UserInfo user = new UserInfo(Long.parseLong(userId), username, role);
            UserContext.setCurrentUser(user);
        }
    }
}
```

---

## 7. ğŸ›¡ï¸ æƒé™æ§åˆ¶ä¸è®¿é—®é™åˆ¶


### 7.1 ç»†ç²’åº¦æƒé™ç®¡ç†


**ğŸ¯ ä»€ä¹ˆæ˜¯ç»†ç²’åº¦æƒé™ï¼Ÿ**
> ä¸ä»…æ§åˆ¶èƒ½ä¸èƒ½è®¿é—®ï¼Œè¿˜æ§åˆ¶èƒ½è®¿é—®å“ªäº›æ•°æ®ã€èƒ½æ‰§è¡Œå“ªäº›æ“ä½œ

**æƒé™æ§åˆ¶ç»´åº¦**ï¼š
```
å¤šç»´åº¦æƒé™æ§åˆ¶ï¼š

åŠŸèƒ½æƒé™ï¼šèƒ½è®¿é—®å“ªäº›æ¥å£
   âœ… /user/list    - æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨
   âŒ /user/delete  - åˆ é™¤ç”¨æˆ·
   
æ•°æ®æƒé™ï¼šèƒ½æ“ä½œå“ªäº›æ•°æ®  
   âœ… è‡ªå·±éƒ¨é—¨çš„ç”¨æˆ·æ•°æ®
   âŒ å…¶ä»–éƒ¨é—¨çš„ç”¨æˆ·æ•°æ®
   
æ“ä½œæƒé™ï¼šèƒ½æ‰§è¡Œå“ªäº›æ“ä½œ
   âœ… æŸ¥è¯¢ã€ä¿®æ”¹
   âŒ åˆ é™¤ã€å¯¼å‡º
   
æ—¶é—´æƒé™ï¼šä»€ä¹ˆæ—¶é—´èƒ½è®¿é—®
   âœ… å·¥ä½œæ—¶é—´ 9:00-18:00
   âŒ éå·¥ä½œæ—¶é—´
```

**ğŸ’» ç»†ç²’åº¦æƒé™å®ç°**ï¼š
```java
// æƒé™æ³¨è§£
@Target({ElementType.METHOD})
@Retention(RetentionPolicy.RUNTIME)
public @interface RequirePermission {
    String resource();           // èµ„æºåç§°
    String action();            // æ“ä½œç±»å‹
    String dataScope() default ""; // æ•°æ®èŒƒå›´
}

// æƒé™åˆ‡é¢
@Aspect
@Component
public class PermissionAspect {
    
    @Around("@annotation(permission)")
    public Object checkPermission(ProceedingJoinPoint joinPoint, RequirePermission permission) throws Throwable {
        UserInfo currentUser = UserContext.getCurrentUser();
        if (currentUser == null) {
            throw new UnauthorizedException("ç”¨æˆ·æœªç™»å½•");
        }
        
        // 1. æ£€æŸ¥åŠŸèƒ½æƒé™
        if (!hasPermission(currentUser, permission.resource(), permission.action())) {
            throw new ForbiddenException("æ— æƒé™è®¿é—®");
        }
        
        // 2. åº”ç”¨æ•°æ®æƒé™è¿‡æ»¤
        if (!permission.dataScope().isEmpty()) {
            applyDataScopeFilter(joinPoint, currentUser, permission.dataScope());
        }
        
        return joinPoint.proceed();
    }
    
    // ä½¿ç”¨ç¤ºä¾‹
    @RequirePermission(resource = "user", action = "read", dataScope = "department")
    public List<User> getUserList(UserQuery query) {
        // æ–¹æ³•æ‰§è¡Œå‰å·²ç»åº”ç”¨äº†æ•°æ®æƒé™è¿‡æ»¤
        return userService.findUsers(query);
    }
}
```

### 7.2 APIè®¿é—®é™åˆ¶


**ğŸš¦ è®¿é—®é™åˆ¶ç±»å‹**ï¼š
```
é™æµæ§åˆ¶ï¼šé˜²æ­¢æ¥å£è¢«æ¶æ„è°ƒç”¨
IPç™½åå•ï¼šåªå…è®¸ç‰¹å®šIPè®¿é—®
æ—¶é—´çª—å£ï¼šé™åˆ¶è®¿é—®æ—¶é—´æ®µ  
è°ƒç”¨é¢‘æ¬¡ï¼šé™åˆ¶å•ä½æ—¶é—´å†…è°ƒç”¨æ¬¡æ•°
```

**ğŸ’» è®¿é—®é™åˆ¶å®ç°**ï¼š
```java
// é™æµæ³¨è§£
@Target({ElementType.METHOD})  
@Retention(RetentionPolicy.RUNTIME)
public @interface RateLimit {
    int limit() default 10;        // é™åˆ¶æ¬¡æ•°
    int windowSize() default 60;   // æ—¶é—´çª—å£ï¼ˆç§’ï¼‰
    String key() default "";       // é™æµkey
}

// é™æµåˆ‡é¢
@Aspect
@Component
public class RateLimitAspect {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    @Around("@annotation(rateLimit)")
    public Object doRateLimit(ProceedingJoinPoint joinPoint, RateLimit rateLimit) throws Throwable {
        String key = buildKey(joinPoint, rateLimit);
        
        // ä½¿ç”¨Rediså®ç°æ»‘åŠ¨çª—å£é™æµ
        long currentTime = System.currentTimeMillis();
        long windowStart = currentTime - rateLimit.windowSize() * 1000;
        
        // æ¸…é™¤è¿‡æœŸè®°å½•
        redisTemplate.opsForZSet().removeRangeByScore(key, 0, windowStart);
        
        // æ£€æŸ¥å½“å‰çª—å£å†…è¯·æ±‚æ•°é‡
        Long count = redisTemplate.opsForZSet().count(key, windowStart, currentTime);
        if (count >= rateLimit.limit()) {
            throw new RateLimitException("è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•");
        }
        
        // è®°å½•æœ¬æ¬¡è¯·æ±‚
        redisTemplate.opsForZSet().add(key, String.valueOf(currentTime), currentTime);
        redisTemplate.expire(key, rateLimit.windowSize(), TimeUnit.SECONDS);
        
        return joinPoint.proceed();
    }
    
    // ä½¿ç”¨ç¤ºä¾‹
    @RateLimit(limit = 100, windowSize = 60) // æ¯åˆ†é’Ÿæœ€å¤š100æ¬¡è¯·æ±‚
    public Result getUserInfo(Long userId) {
        return userService.getUserInfo(userId);
    }
}
```

---

## 8. ğŸ« å•ç‚¹ç™»å½•SSOå®ç°


### 8.1 ä»€ä¹ˆæ˜¯å•ç‚¹ç™»å½•ï¼Ÿ


> ğŸ’¡ **SSO**ï¼šä¸€æ¬¡ç™»å½•ï¼Œåˆ°å¤„é€šè¡Œã€‚å°±åƒæ¸¸ä¹å›­çš„é€šç¥¨ï¼Œä¹°ä¸€å¼ ç¥¨å¯ä»¥ç©æ‰€æœ‰é¡¹ç›®

**ğŸª SSOåº”ç”¨åœºæ™¯**ï¼š
```
ä¼ä¸šå†…éƒ¨ç³»ç»Ÿï¼š
ç”¨æˆ·åœ¨OAç³»ç»Ÿç™»å½•å â†’ è‡ªåŠ¨ç™»å½•é‚®ä»¶ç³»ç»Ÿ â†’ è‡ªåŠ¨ç™»å½•è´¢åŠ¡ç³»ç»Ÿ

å¾®æœåŠ¡æ¶æ„ï¼š  
ç”¨æˆ·åœ¨Webå‰ç«¯ç™»å½• â†’ è‡ªåŠ¨è°ƒç”¨ç”¨æˆ·æœåŠ¡ â†’ è‡ªåŠ¨è°ƒç”¨è®¢å•æœåŠ¡
```

### 8.2 åŸºäºJWTçš„SSOå®ç°


**ğŸ”„ JWT SSOæµç¨‹**ï¼š
```
SSOç™»å½•æµç¨‹ï¼š

ç”¨æˆ·             è®¤è¯ä¸­å¿ƒ           åº”ç”¨A            åº”ç”¨B
 |                 |                |                |  
 |--[1]ç™»å½•------->|                |                |
 |<--[2]JWT Token--|                |                |
 |                 |                |                |
 |--[3]æºå¸¦JWTè®¿é—®åº”ç”¨A----------->|                |
 |                 |<--[4]éªŒè¯JWT----|                |
 |                 |---[5]ç”¨æˆ·ä¿¡æ¯-->|                |
 |<--[6]åº”ç”¨Aé¡µé¢--------------------|                |
 |                 |                |                |
 |--[7]æºå¸¦JWTè®¿é—®åº”ç”¨B--------------------------->|
 |                 |<--[8]éªŒè¯JWT-------------------|
 |                 |---[9]ç”¨æˆ·ä¿¡æ¯----------------->|
 |<--[10]åº”ç”¨Bé¡µé¢---------------------------|
```

**ğŸ’» SSOè®¤è¯ä¸­å¿ƒå®ç°**ï¼š
```java
@RestController
@RequestMapping("/sso")
public class SsoController {
    
    @Autowired
    private JwtTokenUtil jwtTokenUtil;
    
    @Autowired  
    private UserService userService;
    
    // SSOç™»å½•æ¥å£
    @PostMapping("/login")
    public SsoLoginResponse login(@RequestBody LoginRequest request) {
        // éªŒè¯ç”¨æˆ·åå¯†ç 
        User user = userService.authenticate(request.getUsername(), request.getPassword());
        if (user == null) {
            throw new AuthenticationException("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯");
        }
        
        // ç”ŸæˆJWT Token
        String token = jwtTokenUtil.generateToken(user);
        
        return SsoLoginResponse.builder()
            .token(token)
            .user(user)
            .expiresIn(jwtTokenUtil.getExpirationTime())
            .build();
    }
    
    // SSOç”¨æˆ·ä¿¡æ¯éªŒè¯æ¥å£
    @GetMapping("/userinfo")
    public User getUserInfo(@RequestHeader("Authorization") String token) {
        String jwt = token.replace("Bearer ", "");
        if (!jwtTokenUtil.validateToken(jwt)) {
            throw new UnauthorizedException("Tokenæ— æ•ˆ");
        }
        
        Long userId = jwtTokenUtil.getUserIdFromToken(jwt);
        return userService.findById(userId);
    }
}
```

### 8.3 å¾®æœåŠ¡ä¸­çš„SSOé›†æˆ


**ğŸ”§ ç»Ÿä¸€è®¤è¯ç½‘å…³**ï¼š
```java
// APIç½‘å…³è®¤è¯è¿‡æ»¤å™¨
@Component
public class SsoAuthFilter implements GatewayFilter {
    
    @Autowired
    private SsoClient ssoClient;
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        String token = extractToken(exchange.getRequest());
        
        if (token == null) {
            return unauthorized(exchange);
        }
        
        // è°ƒç”¨SSOè®¤è¯ä¸­å¿ƒéªŒè¯token
        return ssoClient.validateToken(token)
            .flatMap(user -> {
                // éªŒè¯æˆåŠŸï¼Œæ·»åŠ ç”¨æˆ·ä¿¡æ¯åˆ°è¯·æ±‚å¤´
                ServerHttpRequest modifiedRequest = exchange.getRequest().mutate()
                    .header("X-User-ID", user.getId().toString())
                    .header("X-User-Name", user.getUsername())
                    .header("X-User-Role", user.getRole())
                    .build();
                    
                return chain.filter(exchange.mutate().request(modifiedRequest).build());
            })
            .onErrorReturn(unauthorized(exchange));
    }
    
    private String extractToken(ServerHttpRequest request) {
        String bearerToken = request.getHeaders().getFirst("Authorization");
        if (bearerToken != null && bearerToken.startsWith("Bearer ")) {
            return bearerToken.substring(7);
        }
        return null;
    }
}
```

**ğŸ¯ å¾®æœåŠ¡SSOå®¢æˆ·ç«¯**ï¼š
```java
// SSOå®¢æˆ·ç«¯SDK
@Component
public class SsoClient {
    
    @Value("${sso.server.url}")
    private String ssoServerUrl;
    
    private RestTemplate restTemplate = new RestTemplate();
    
    // éªŒè¯Tokenå¹¶è·å–ç”¨æˆ·ä¿¡æ¯
    public User validateToken(String token) {
        try {
            HttpHeaders headers = new HttpHeaders();
            headers.setBearerAuth(token);
            HttpEntity<String> entity = new HttpEntity<>(headers);
            
            ResponseEntity<User> response = restTemplate.exchange(
                ssoServerUrl + "/sso/userinfo",
                HttpMethod.GET,
                entity,
                User.class
            );
            
            return response.getBody();
        } catch (Exception e) {
            throw new UnauthorizedException("TokenéªŒè¯å¤±è´¥");
        }
    }
}

// å¾®æœåŠ¡ä¸­çš„ä½¿ç”¨
@RestController  
public class OrderController {
    
    @GetMapping("/orders")
    public List<Order> getOrders(HttpServletRequest request) {
        // ä»ç½‘å…³ä¼ é€’çš„è¯·æ±‚å¤´è·å–ç”¨æˆ·ä¿¡æ¯
        String userId = request.getHeader("X-User-ID");
        String userName = request.getHeader("X-User-Name");
        
        // åŸºäºç”¨æˆ·ä¿¡æ¯è¿›è¡Œä¸šåŠ¡å¤„ç†
        return orderService.getOrdersByUserId(Long.parseLong(userId));
    }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 è®¤è¯æœºåˆ¶é€‰æ‹©æŒ‡å—


> âš ï¸ **é‡è¦æé†’**ï¼šé€‰æ‹©è®¤è¯æœºåˆ¶è¦æ ¹æ®å®é™…åœºæ™¯ï¼Œæ²¡æœ‰ä¸‡èƒ½æ–¹æ¡ˆ

| åœºæ™¯ | **æ¨èæ–¹æ¡ˆ** | **é€‚ç”¨åŸå› ** | **æ³¨æ„äº‹é¡¹** |
|------|------------|------------|------------|
| **å†…éƒ¨å¾®æœåŠ¡** | JWT + mTLS | æ— çŠ¶æ€ï¼Œæ€§èƒ½å¥½ | æ³¨æ„Tokenè¿‡æœŸå¤„ç† |
| **å¯¹å¤–API** | API Key | ç®€å•å¯æ§ | åšå¥½å¯†é’¥ç®¡ç† |  
| **ä¼ä¸šçº§åº”ç”¨** | OAuth2 + RBAC | æ ‡å‡†åŒ–ï¼ŒåŠŸèƒ½å®Œæ•´ | å¤æ‚åº¦è¾ƒé«˜ |
| **é«˜å®‰å…¨è¦æ±‚** | è¯ä¹¦è®¤è¯ | å®‰å…¨æ€§æœ€é«˜ | è¯ä¹¦ç®¡ç†å¤æ‚ |

### 9.2 æƒé™æ§åˆ¶æœ€ä½³å®è·µ


**ğŸ¯ æƒé™è®¾è®¡åŸåˆ™**ï¼š
```
æœ€å°æƒé™åŸåˆ™ï¼š
â€¢ ç”¨æˆ·é»˜è®¤æ— æƒé™
â€¢ æŒ‰éœ€åˆ†é…æœ€å°å¿…è¦æƒé™
â€¢ å®šæœŸå®¡æŸ¥å’Œå›æ”¶æƒé™

åˆ†å±‚æƒé™æ§åˆ¶ï¼š
â€¢ ç½‘å…³å±‚ï¼šåŸºç¡€è®¤è¯å’Œè·¯ç”±æ§åˆ¶
â€¢ æœåŠ¡å±‚ï¼šä¸šåŠ¡æƒé™éªŒè¯
â€¢ æ•°æ®å±‚ï¼šæ•°æ®è®¿é—®æƒé™è¿‡æ»¤

æƒé™ç¼“å­˜ç­–ç•¥ï¼š
â€¢ é¢‘ç¹æŸ¥è¯¢çš„æƒé™ä¿¡æ¯è¦ç¼“å­˜
â€¢ æƒé™å˜æ›´æ—¶åŠæ—¶æ¸…ç†ç¼“å­˜
â€¢ è®¾ç½®åˆç†çš„ç¼“å­˜è¿‡æœŸæ—¶é—´
```

### 9.3 å®‰å…¨å®æ–½å»ºè®®


**ğŸ”’ å®‰å…¨åŠ å›ºæªæ–½**ï¼š
```
ä¼ è¾“å®‰å…¨ï¼š
âœ… ä½¿ç”¨HTTPS/TLSåŠ å¯†é€šä¿¡
âœ… æ•æ„Ÿæ•°æ®ä¸åœ¨URLä¸­ä¼ é€’
âœ… ä½¿ç”¨å®‰å…¨çš„å¯†ç ç®—æ³•

å­˜å‚¨å®‰å…¨ï¼š
âœ… å¯†ç ä½¿ç”¨ç›å€¼å“ˆå¸Œå­˜å‚¨
âœ… æ•æ„Ÿé…ç½®åŠ å¯†ä¿å­˜
âœ… å®šæœŸè½®æ¢å¯†é’¥å’Œè¯ä¹¦

è®¿é—®æ§åˆ¶ï¼š
âœ… å®æ–½IPç™½åå•
âœ… è®¾ç½®åˆç†çš„ä¼šè¯è¶…æ—¶
âœ… è®°å½•è¯¦ç»†çš„å®¡è®¡æ—¥å¿—
```

### 9.4 å¸¸è§å®‰å…¨é™·é˜±


> ğŸš¨ **é¿å…è¿™äº›å¸¸è§é”™è¯¯**ï¼š

```
âŒ é”™è¯¯åšæ³•ï¼š
â€¢ åœ¨å®¢æˆ·ç«¯å­˜å‚¨æ•æ„Ÿä¿¡æ¯
â€¢ ä½¿ç”¨å¼±å¯†ç æˆ–é»˜è®¤å¯†ç 
â€¢ å¿½ç•¥Tokenè¿‡æœŸå¤„ç†
â€¢ æƒé™æ ¡éªŒé€»è¾‘å†™åœ¨å®¢æˆ·ç«¯
â€¢ ç›´æ¥åœ¨URLä¸­ä¼ é€’å¯†ç 

âœ… æ­£ç¡®åšæ³•ï¼š
â€¢ æ•æ„Ÿä¿¡æ¯åªåœ¨æœåŠ¡ç«¯å¤„ç†
â€¢ å¼ºåˆ¶ä½¿ç”¨å¤æ‚å¯†ç ç­–ç•¥
â€¢ å®ç°Tokenè‡ªåŠ¨åˆ·æ–°æœºåˆ¶
â€¢ æƒé™éªŒè¯å¿…é¡»åœ¨æœåŠ¡ç«¯
â€¢ ä½¿ç”¨POSTè¯·æ±‚ä¼ é€’è®¤è¯ä¿¡æ¯
```

### 9.5 æ ¸å¿ƒè®°å¿†è¦ç‚¹


**ğŸ¯ å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- **è®¤è¯è§£å†³"æ˜¯è°"ï¼Œæˆæƒè§£å†³"èƒ½åšä»€ä¹ˆ"**
- **Tokenè®¤è¯é€‚åˆæ— çŠ¶æ€æœåŠ¡ï¼Œè¯ä¹¦è®¤è¯é€‚åˆé«˜å®‰å…¨åœºæ™¯**  
- **RBACé€‚åˆæ ‡å‡†æƒé™ç®¡ç†ï¼ŒABACé€‚åˆå¤æ‚æƒé™æ§åˆ¶**
- **åŒå‘è®¤è¯æä¾›æ›´é«˜å®‰å…¨æ€§ï¼Œä½†å¢åŠ å¤æ‚åº¦**
- **SSOå®ç°ç”¨æˆ·ä½“éªŒå’Œå®‰å…¨çš„å¹³è¡¡**

**è®°å¿†å£è¯€**ï¼š
```
è®¤è¯æˆæƒä¸¤æ­¥èµ°ï¼ŒTokenè¯ä¹¦å„æœ‰ä¼˜
è§’è‰²å±æ€§æ§æƒé™ï¼ŒåŒå‘è®¤è¯æ›´å®‰å…¨  
å•ç‚¹ç™»å½•ç”¨æˆ·çˆ½ï¼Œå®‰å…¨æœºåˆ¶è¦é…é½
```