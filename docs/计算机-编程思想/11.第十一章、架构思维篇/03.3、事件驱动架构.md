---
title: 3ã€äº‹ä»¶é©±åŠ¨æ¶æ„
---
## ğŸ“š ç›®å½•

1. [äº‹ä»¶é©±åŠ¨æ¶æ„æ¦‚è¿°](#1-äº‹ä»¶é©±åŠ¨æ¶æ„æ¦‚è¿°)
2. [äº‹ä»¶è®¾è®¡åŸåˆ™ä¸è§„èŒƒ](#2-äº‹ä»¶è®¾è®¡åŸåˆ™ä¸è§„èŒƒ)
3. [äº‹ä»¶æ€»çº¿æ¶æ„è®¾è®¡](#3-äº‹ä»¶æ€»çº¿æ¶æ„è®¾è®¡)
4. [äº‹ä»¶å¼‚æ­¥å¤„ç†æœºåˆ¶](#4-äº‹ä»¶å¼‚æ­¥å¤„ç†æœºåˆ¶)
5. [äº‹ä»¶æº¯æºè®¾è®¡ä¸å®ç°](#5-äº‹ä»¶æº¯æºè®¾è®¡ä¸å®ç°)
6. [CQRSå‘½ä»¤æŸ¥è¯¢èŒè´£åˆ†ç¦»](#6-CQRSå‘½ä»¤æŸ¥è¯¢èŒè´£åˆ†ç¦»)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ­ äº‹ä»¶é©±åŠ¨æ¶æ„æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯äº‹ä»¶é©±åŠ¨æ¶æ„


**ğŸ”¸ é€šä¿—ç†è§£**
äº‹ä»¶é©±åŠ¨æ¶æ„å°±åƒç°å®ç”Ÿæ´»ä¸­çš„"è®¢é˜…é€šçŸ¥"æœºåˆ¶ï¼š

```
ç°å®ä¾‹å­ï¼š
ğŸ”” è®¢é¤APP â†’ å¨å¸ˆåšèœ â†’ é€šçŸ¥éª‘æ‰‹ â†’ é€šçŸ¥é¡¾å®¢
æ¯ä¸ªç¯èŠ‚éƒ½æ˜¯"äº‹ä»¶"ï¼Œå„ä¸ªè§’è‰²æ ¹æ®äº‹ä»¶åšå‡ºå“åº”

ç¼–ç¨‹ä¸–ç•Œï¼š
ğŸ’¾ ç”¨æˆ·ä¸‹å• â†’ å‘å¸ƒè®¢å•äº‹ä»¶ â†’ åº“å­˜ç³»ç»Ÿå‡åº“å­˜ â†’ æ”¯ä»˜ç³»ç»Ÿæ‰£æ¬¾ â†’ ç‰©æµç³»ç»Ÿå‘è´§
```

**ğŸ“‹ æ ¸å¿ƒæ¦‚å¿µ**
- **äº‹ä»¶**ï¼šç³»ç»Ÿä¸­å‘ç”Ÿçš„é‡è¦çŠ¶æ€å˜åŒ–
- **å‘å¸ƒè€…**ï¼šäº§ç”Ÿäº‹ä»¶çš„ç»„ä»¶
- **è®¢é˜…è€…**ï¼šç›‘å¬å¹¶å¤„ç†äº‹ä»¶çš„ç»„ä»¶
- **äº‹ä»¶æ€»çº¿**ï¼šè¿æ¥å‘å¸ƒè€…å’Œè®¢é˜…è€…çš„ä¸­ä»‹

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦äº‹ä»¶é©±åŠ¨æ¶æ„


**ğŸ¯ è§£å†³çš„æ ¸å¿ƒé—®é¢˜**

```
ä¼ ç»ŸåŒæ­¥è°ƒç”¨çš„é—®é¢˜ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®¢å•æœåŠ¡  â”‚â”€â”€â”€â”€â–¶â”‚ åº“å­˜æœåŠ¡  â”‚â”€â”€â”€â”€â–¶â”‚ æ”¯ä»˜æœåŠ¡  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
é—®é¢˜ï¼šä»»ä½•ä¸€ç¯å‡ºé”™ï¼Œæ•´ä¸ªæµç¨‹å¤±è´¥
```

```
äº‹ä»¶é©±åŠ¨æ¶æ„çš„ä¼˜åŠ¿ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®¢å•æœåŠ¡  â”‚â”€â”€â”€â”€â–¶â”‚   äº‹ä»¶æ€»çº¿    â”‚â—€â”€â”€â”€â”€â”‚ åº“å­˜æœåŠ¡  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚             â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚             â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚             â”‚â—€â”€â”€â”€â”€â”‚ æ”¯ä»˜æœåŠ¡  â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ä¼˜åŠ¿ï¼šæ¾è€¦åˆï¼Œå„æœåŠ¡ç‹¬ç«‹å¤„ç†
```

**ğŸ’¡ æ ¸å¿ƒä¼˜åŠ¿**
- âœ… **æ¾è€¦åˆ**ï¼šæœåŠ¡ä¹‹é—´ä¸ç›´æ¥ä¾èµ–
- âœ… **é«˜æ‰©å±•æ€§**ï¼šæ–°å¢æœåŠ¡åªéœ€è®¢é˜…äº‹ä»¶
- âœ… **å®¹é”™æ€§**ï¼šå•ä¸ªæœåŠ¡æ•…éšœä¸å½±å“å…¶ä»–æœåŠ¡
- âœ… **å¼‚æ­¥å¤„ç†**ï¼šæé«˜ç³»ç»Ÿå“åº”é€Ÿåº¦

### 1.3 åŸºæœ¬å·¥ä½œåŸç†


**ğŸ”„ äº‹ä»¶æµè½¬è¿‡ç¨‹**

```
æ­¥éª¤1ï¼šäº‹ä»¶äº§ç”Ÿ
ç”¨æˆ·ä¸‹å• â†’ è®¢å•æœåŠ¡ç”Ÿæˆ"è®¢å•åˆ›å»ºäº‹ä»¶"

æ­¥éª¤2ï¼šäº‹ä»¶å‘å¸ƒ
è®¢å•æœåŠ¡å°†äº‹ä»¶å‘é€åˆ°äº‹ä»¶æ€»çº¿

æ­¥éª¤3ï¼šäº‹ä»¶åˆ†å‘
äº‹ä»¶æ€»çº¿å°†äº‹ä»¶æ¨é€ç»™æ‰€æœ‰è®¢é˜…è€…

æ­¥éª¤4ï¼šäº‹ä»¶å¤„ç†
å„ä¸ªæœåŠ¡æ¥æ”¶äº‹ä»¶å¹¶æ‰§è¡Œç›¸åº”ä¸šåŠ¡é€»è¾‘
```

**ğŸª ç®€å•ä»£ç ç¤ºä¾‹**

```java
// äº‹ä»¶å®šä¹‰
public class OrderCreatedEvent {
    private String orderId;
    private String userId;
    private BigDecimal amount;
    // æ„é€ å‡½æ•°å’Œgetter...
}

// äº‹ä»¶å‘å¸ƒ
@Service
public class OrderService {
    @Autowired
    private EventPublisher eventPublisher;
    
    public void createOrder(Order order) {
        // 1. ä¿å­˜è®¢å•
        saveOrder(order);
        
        // 2. å‘å¸ƒäº‹ä»¶
        OrderCreatedEvent event = new OrderCreatedEvent(
            order.getId(), order.getUserId(), order.getAmount()
        );
        eventPublisher.publish(event);
    }
}

// äº‹ä»¶ç›‘å¬
@Component
public class InventoryService {
    @EventListener
    public void handleOrderCreated(OrderCreatedEvent event) {
        // å‡åº“å­˜é€»è¾‘
        reduceInventory(event.getOrderId());
    }
}
```

---

## 2. ğŸ¨ äº‹ä»¶è®¾è®¡åŸåˆ™ä¸è§„èŒƒ


### 2.1 äº‹ä»¶è®¾è®¡çš„æ ¸å¿ƒåŸåˆ™


**ğŸ”¸ å•ä¸€èŒè´£åŸåˆ™**
æ¯ä¸ªäº‹ä»¶åªè¡¨è¾¾ä¸€ä¸ªæ˜ç¡®çš„ä¸šåŠ¡å«ä¹‰

```java
// âŒ é”™è¯¯è®¾è®¡ï¼šäº‹ä»¶åŒ…å«å¤ªå¤šä¿¡æ¯
public class UserOperationEvent {
    private String userId;
    private String operation; // "login", "logout", "update_profile"
    private Object data;      // ä¸æ˜ç¡®çš„æ•°æ®
}

// âœ… æ­£ç¡®è®¾è®¡ï¼šäº‹ä»¶èŒè´£å•ä¸€
public class UserLoginEvent {
    private String userId;
    private String loginTime;
    private String ipAddress;
}

public class UserLogoutEvent {
    private String userId;
    private String logoutTime;
}
```

**ğŸ”¸ ä¸å¯å˜æ€§åŸåˆ™**
äº‹ä»¶ä¸€æ—¦åˆ›å»ºå°±ä¸åº”è¯¥è¢«ä¿®æ”¹

```java
// âœ… äº‹ä»¶å¯¹è±¡è®¾è®¡ä¸ºä¸å¯å˜
public final class PaymentCompletedEvent {
    private final String paymentId;
    private final BigDecimal amount;
    private final String timestamp;
    
    public PaymentCompletedEvent(String paymentId, BigDecimal amount) {
        this.paymentId = paymentId;
        this.amount = amount;
        this.timestamp = Instant.now().toString();
    }
    
    // åªæä¾›getterï¼Œä¸æä¾›setter
    public String getPaymentId() { return paymentId; }
    public BigDecimal getAmount() { return amount; }
    public String getTimestamp() { return timestamp; }
}
```

### 2.2 äº‹ä»¶å‘½åè§„èŒƒ


**ğŸ“ å‘½åæœ€ä½³å®è·µ**

| åŸåˆ™ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| **è¿‡å»æ—¶æ€** | äº‹ä»¶è¡¨ç¤ºå·²ç»å‘ç”Ÿçš„äº‹æƒ… | `OrderCreated`ã€`PaymentCompleted` |
| **ä¸šåŠ¡è¯­è¨€** | ä½¿ç”¨ä¸šåŠ¡é¢†åŸŸçš„æœ¯è¯­ | `CustomerRegistered` è€Œä¸æ˜¯ `UserInserted` |
| **å…·ä½“æ˜ç¡®** | é¿å…æ¨¡ç³Šçš„è¯æ±‡ | `ProductOutOfStock` è€Œä¸æ˜¯ `ProductChanged` |

```java
// âœ… è‰¯å¥½çš„äº‹ä»¶å‘½å
public class CustomerRegistered { }      // å®¢æˆ·æ³¨å†Œå®Œæˆ
public class OrderCancelled { }          // è®¢å•å·²å–æ¶ˆ  
public class InventoryReserved { }       // åº“å­˜å·²é¢„ç•™
public class PaymentFailed { }           // æ”¯ä»˜å¤±è´¥

// âŒ ä¸å¥½çš„äº‹ä»¶å‘½å
public class CustomerEvent { }           // å¤ªæ¨¡ç³Š
public class OrderUpdate { }             // ä¸çŸ¥é“å…·ä½“æ›´æ–°äº†ä»€ä¹ˆ
public class ProcessComplete { }         // ä¸çŸ¥é“ä»€ä¹ˆæµç¨‹
```

### 2.3 äº‹ä»¶ç»“æ„è®¾è®¡


**ğŸ—ï¸ æ ‡å‡†äº‹ä»¶ç»“æ„**

```java
public abstract class BaseEvent {
    private final String eventId;        // äº‹ä»¶å”¯ä¸€æ ‡è¯†
    private final String eventType;      // äº‹ä»¶ç±»å‹
    private final String timestamp;      // å‘ç”Ÿæ—¶é—´
    private final String source;         // äº‹ä»¶æº
    private final String version;        // äº‹ä»¶ç‰ˆæœ¬
    
    protected BaseEvent(String eventType, String source) {
        this.eventId = UUID.randomUUID().toString();
        this.eventType = eventType;
        this.timestamp = Instant.now().toString();
        this.source = source;
        this.version = "1.0";
    }
}

public class OrderCreatedEvent extends BaseEvent {
    private final String orderId;
    private final String customerId;
    private final BigDecimal totalAmount;
    private final List<OrderItem> items;
    
    public OrderCreatedEvent(String orderId, String customerId, 
                           BigDecimal totalAmount, List<OrderItem> items) {
        super("OrderCreated", "order-service");
        this.orderId = orderId;
        this.customerId = customerId;
        this.totalAmount = totalAmount;
        this.items = Collections.unmodifiableList(items);
    }
}
```

**ğŸ“‹ äº‹ä»¶å…ƒæ•°æ®è¯´æ˜**

```
ğŸ”¸ eventIdï¼šå…¨å±€å”¯ä¸€æ ‡è¯†ï¼Œç”¨äºå»é‡å’Œè¿½è¸ª
ğŸ”¸ eventTypeï¼šäº‹ä»¶ç±»å‹ï¼Œä¾¿äºè·¯ç”±å’Œè¿‡æ»¤
ğŸ”¸ timestampï¼šäº‹ä»¶å‘ç”Ÿæ—¶é—´ï¼Œç”¨äºæ’åºå’Œè¿½æº¯
ğŸ”¸ sourceï¼šäº‹ä»¶æ¥æºæœåŠ¡ï¼Œä¾¿äºè°ƒè¯•å’Œç›‘æ§
ğŸ”¸ versionï¼šäº‹ä»¶ç‰ˆæœ¬ï¼Œæ”¯æŒäº‹ä»¶ç»“æ„æ¼”è¿›
```

---

## 3. ğŸšŒ äº‹ä»¶æ€»çº¿æ¶æ„è®¾è®¡


### 3.1 äº‹ä»¶æ€»çº¿çš„æœ¬è´¨


**ğŸ”¸ ä»€ä¹ˆæ˜¯äº‹ä»¶æ€»çº¿**
äº‹ä»¶æ€»çº¿å°±åƒåŸå¸‚çš„å…¬äº¤ç³»ç»Ÿï¼Œè´Ÿè´£æŠŠ"æ¶ˆæ¯ä¹˜å®¢"ä»"å‘å¸ƒç«™"è¿é€åˆ°"è®¢é˜…ç«™"ï¼š

```
ç°å®å…¬äº¤ç³»ç»Ÿï¼š
ğŸšŒ ä¹˜å®¢åœ¨ç«™ç‚¹Aä¸Šè½¦ â†’ å…¬äº¤è½¦è¿è¾“ â†’ ä¹˜å®¢åœ¨ç«™ç‚¹Bä¸‹è½¦

äº‹ä»¶æ€»çº¿ç³»ç»Ÿï¼š
ğŸ“¤ æœåŠ¡Aå‘å¸ƒäº‹ä»¶ â†’ äº‹ä»¶æ€»çº¿ä¼ é€’ â†’ æœåŠ¡Bæ¥æ”¶äº‹ä»¶
```

**ğŸ’¡ æ ¸å¿ƒèŒè´£**
- ğŸ“® **äº‹ä»¶æ¥æ”¶**ï¼šæ¥å—å„æœåŠ¡å‘å¸ƒçš„äº‹ä»¶
- ğŸšš **äº‹ä»¶è·¯ç”±**ï¼šå°†äº‹ä»¶å‘é€ç»™å¯¹åº”çš„è®¢é˜…è€…
- ğŸ“Š **äº‹ä»¶å­˜å‚¨**ï¼šå¯é€‰çš„äº‹ä»¶æŒä¹…åŒ–
- ğŸ”„ **é‡è¯•æœºåˆ¶**ï¼šå¤„ç†å¤±è´¥æ—¶çš„é‡è¯•é€»è¾‘

### 3.2 äº‹ä»¶æ€»çº¿çš„æ¶æ„æ¨¡å¼


**ğŸ—ï¸ é›†ä¸­å¼äº‹ä»¶æ€»çº¿**

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚                 â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚               â”‚   äº‹ä»¶æ€»çº¿ä¸­å¿ƒ    â”‚              â”‚
    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚                 â”‚ â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚   â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚  â”‚
    â”‚   â”‚                                         â”‚  â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â–¼â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â–¼â”€â”
â”‚ è®¢å•æœåŠ¡   â”‚  â”‚ ç”¨æˆ·æœåŠ¡ â”‚  â”‚ æ”¯ä»˜æœåŠ¡ â”‚  â”‚  åº“å­˜æœåŠ¡   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜ç‚¹ï¼šç»Ÿä¸€ç®¡ç†ï¼Œå®¹æ˜“ç›‘æ§
ç¼ºç‚¹ï¼šå•ç‚¹æ•…éšœé£é™©
```

**ğŸ•¸ï¸ åˆ†å¸ƒå¼äº‹ä»¶æ€»çº¿**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®¢å•æœåŠ¡ â”‚â—€â”€â”€â”€â”€â–¶â”‚ æ¶ˆæ¯é˜Ÿåˆ— â”‚â—€â”€â”€â”€â”€â–¶â”‚ åº“å­˜æœåŠ¡ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚               â”‚               â”‚
     â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ æ¶ˆæ¯é˜Ÿåˆ— â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ æ”¯ä»˜æœåŠ¡ â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜ç‚¹ï¼šé«˜å¯ç”¨ï¼Œæ€§èƒ½å¥½
ç¼ºç‚¹ï¼šå¤æ‚åº¦è¾ƒé«˜
```

### 3.3 äº‹ä»¶æ€»çº¿å®ç°ç¤ºä¾‹


**ğŸ”§ ç®€å•çš„å†…å­˜äº‹ä»¶æ€»çº¿**

```java
@Component
public class SimpleEventBus {
    // å­˜å‚¨äº‹ä»¶ç±»å‹ä¸ç›‘å¬å™¨çš„æ˜ å°„å…³ç³»
    private final Map<Class<?>, List<EventListener>> listeners = new ConcurrentHashMap<>();
    
    /**
     * æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨
     */
    public <T> void subscribe(Class<T> eventType, EventListener<T> listener) {
        listeners.computeIfAbsent(eventType, k -> new ArrayList<>()).add(listener);
    }
    
    /**
     * å‘å¸ƒäº‹ä»¶
     */
    public <T> void publish(T event) {
        Class<?> eventType = event.getClass();
        List<EventListener> eventListeners = listeners.get(eventType);
        
        if (eventListeners != null) {
            for (EventListener listener : eventListeners) {
                try {
                    // å¼‚æ­¥å¤„ç†äº‹ä»¶
                    CompletableFuture.runAsync(() -> listener.handle(event));
                } catch (Exception e) {
                    System.err.println("äº‹ä»¶å¤„ç†å¤±è´¥: " + e.getMessage());
                }
            }
        }
    }
}

// äº‹ä»¶ç›‘å¬å™¨æ¥å£
@FunctionalInterface
public interface EventListener<T> {
    void handle(T event);
}

// ä½¿ç”¨ç¤ºä¾‹
@Service
public class OrderService {
    @Autowired
    private SimpleEventBus eventBus;
    
    public void createOrder(Order order) {
        // ä¸šåŠ¡é€»è¾‘...
        
        // å‘å¸ƒäº‹ä»¶
        eventBus.publish(new OrderCreatedEvent(order.getId(), order.getCustomerId()));
    }
}

@Component
public class InventoryListener {
    
    @PostConstruct
    public void init() {
        // æ³¨å†Œç›‘å¬å™¨
        eventBus.subscribe(OrderCreatedEvent.class, this::handleOrderCreated);
    }
    
    private void handleOrderCreated(OrderCreatedEvent event) {
        // å¤„ç†åº“å­˜é€»è¾‘
        System.out.println("å‡å°‘å•†å“åº“å­˜ï¼Œè®¢å•ID: " + event.getOrderId());
    }
}
```

### 3.4 äº‹ä»¶è·¯ç”±ç­–ç•¥


**ğŸ“ åŸºäºäº‹ä»¶ç±»å‹è·¯ç”±**

```java
public class EventRouter {
    private final Map<String, List<String>> routingTable = new HashMap<>();
    
    public EventRouter() {
        // é…ç½®è·¯ç”±è§„åˆ™
        routingTable.put("OrderCreated", Arrays.asList("inventory-service", "payment-service"));
        routingTable.put("PaymentCompleted", Arrays.asList("order-service", "notification-service"));
    }
    
    public List<String> getTargetServices(String eventType) {
        return routingTable.getOrDefault(eventType, Collections.emptyList());
    }
}
```

**ğŸ¯ åŸºäºå†…å®¹è·¯ç”±**

```java
public class ContentBasedRouter {
    
    public List<String> route(Event event) {
        List<String> targets = new ArrayList<>();
        
        if (event instanceof OrderCreatedEvent) {
            OrderCreatedEvent orderEvent = (OrderCreatedEvent) event;
            
            // æ ¹æ®è®¢å•é‡‘é¢è·¯ç”±
            if (orderEvent.getAmount().compareTo(new BigDecimal("1000")) > 0) {
                targets.add("risk-management-service"); // å¤§é¢è®¢å•é£æ§
            }
            
            // æ ¹æ®ç”¨æˆ·ç±»å‹è·¯ç”±
            if (orderEvent.getCustomerType().equals("VIP")) {
                targets.add("vip-service"); // VIPç”¨æˆ·ç‰¹æ®Šå¤„ç†
            }
        }
        
        return targets;
    }
}
```

---

## 4. âš¡ äº‹ä»¶å¼‚æ­¥å¤„ç†æœºåˆ¶


### 4.1 ä¸ºä»€ä¹ˆéœ€è¦å¼‚æ­¥å¤„ç†


**ğŸ”¸ åŒæ­¥å¤„ç†çš„é—®é¢˜**

```java
// âŒ åŒæ­¥å¤„ç†ï¼šé˜»å¡ç­‰å¾…
public void processOrder(Order order) {
    saveOrder(order);           // 50ms
    updateInventory(order);     // 100ms 
    sendEmail(order);           // 200ms
    generateInvoice(order);     // 150ms
    // æ€»è€—æ—¶ï¼š500msï¼Œç”¨æˆ·éœ€è¦ç­‰å¾…
}
```

**ğŸ”¸ å¼‚æ­¥å¤„ç†çš„ä¼˜åŠ¿**

```java
// âœ… å¼‚æ­¥å¤„ç†ï¼šç«‹å³å“åº”
public void processOrder(Order order) {
    saveOrder(order);                    // 50ms
    publishEvent(new OrderCreated(order)); // 5ms
    // æ€»è€—æ—¶ï¼š55msï¼Œç”¨æˆ·å¿«é€Ÿå¾—åˆ°å“åº”
    // å…¶ä»–å¤„ç†åœ¨åå°å¼‚æ­¥è¿›è¡Œ
}
```

**ğŸ’¡ å¼‚æ­¥å¤„ç†çš„å¥½å¤„**
- âš¡ **å“åº”å¿«é€Ÿ**ï¼šç”¨æˆ·ä¸éœ€è¦ç­‰å¾…æ‰€æœ‰æ“ä½œå®Œæˆ
- ğŸ”„ **ç³»ç»Ÿè§£è€¦**ï¼šå‘å¸ƒè€…ä¸å…³å¿ƒå¤„ç†è€…çš„æ‰§è¡Œæ—¶é—´
- ğŸ“ˆ **ååé‡é«˜**ï¼šå¯ä»¥å¹¶è¡Œå¤„ç†å¤šä¸ªäº‹ä»¶
- ğŸ›¡ï¸ **å®¹é”™æ€§å¼º**ï¼šå•ä¸ªå¤„ç†å¤±è´¥ä¸å½±å“å…¶ä»–æ“ä½œ

### 4.2 å¼‚æ­¥å¤„ç†å®ç°æ–¹å¼


**ğŸ­ åŸºäºçº¿ç¨‹æ± çš„å¼‚æ­¥å¤„ç†**

```java
@Component
public class AsyncEventProcessor {
    
    // åˆ›å»ºä¸“é—¨çš„çº¿ç¨‹æ± å¤„ç†äº‹ä»¶
    private final ExecutorService eventExecutor = Executors.newFixedThreadPool(10);
    
    @EventListener
    public void handleOrderCreated(OrderCreatedEvent event) {
        // æäº¤åˆ°çº¿ç¨‹æ± å¼‚æ­¥æ‰§è¡Œ
        eventExecutor.submit(() -> {
            try {
                processOrderCreated(event);
            } catch (Exception e) {
                handleException(event, e);
            }
        });
    }
    
    private void processOrderCreated(OrderCreatedEvent event) {
        // å…·ä½“çš„ä¸šåŠ¡å¤„ç†é€»è¾‘
        updateInventory(event.getOrderId());
        sendNotification(event.getCustomerId());
    }
    
    private void handleException(OrderCreatedEvent event, Exception e) {
        // å¼‚å¸¸å¤„ç†ï¼šè®°å½•æ—¥å¿—ã€é‡è¯•ã€è¡¥å¿ç­‰
        System.err.println("å¤„ç†è®¢å•äº‹ä»¶å¤±è´¥: " + event.getOrderId() + ", é”™è¯¯: " + e.getMessage());
    }
}
```

**ğŸ“¨ åŸºäºæ¶ˆæ¯é˜Ÿåˆ—çš„å¼‚æ­¥å¤„ç†**

```java
// å‘å¸ƒäº‹ä»¶åˆ°æ¶ˆæ¯é˜Ÿåˆ—
@Service
public class EventPublisher {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    public void publish(Object event) {
        String eventType = event.getClass().getSimpleName();
        
        // å‘é€åˆ°å¯¹åº”çš„é˜Ÿåˆ—
        rabbitTemplate.convertAndSend(
            "event.exchange",     // äº¤æ¢æœº
            eventType,           // è·¯ç”±é”®
            event               // äº‹ä»¶å†…å®¹
        );
    }
}

// ä»æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹äº‹ä»¶
@Component
public class InventoryEventListener {
    
    @RabbitListener(queues = "inventory.queue")
    public void handleOrderCreated(OrderCreatedEvent event) {
        // å¼‚æ­¥å¤„ç†åº“å­˜æ›´æ–°
        inventoryService.reserveItems(event.getOrderId(), event.getItems());
    }
}
```

### 4.3 å¼‚æ­¥å¤„ç†çš„é‡è¯•æœºåˆ¶


**ğŸ”„ æŒ‡æ•°é€€é¿é‡è¯•ç­–ç•¥**

```java
@Component
public class RetryableEventHandler {
    
    private final int MAX_RETRY_ATTEMPTS = 3;
    
    @EventListener
    @Retryable(value = {Exception.class}, maxAttempts = 3, backoff = @Backoff(delay = 1000, multiplier = 2))
    public void handlePaymentEvent(PaymentEvent event) {
        try {
            processPayment(event);
        } catch (Exception e) {
            System.err.println("æ”¯ä»˜å¤„ç†å¤±è´¥ï¼Œå‡†å¤‡é‡è¯•...");
            throw e; // é‡æ–°æŠ›å‡ºå¼‚å¸¸è§¦å‘é‡è¯•
        }
    }
    
    @Recover
    public void recover(Exception e, PaymentEvent event) {
        // æ‰€æœ‰é‡è¯•éƒ½å¤±è´¥åçš„å…œåº•å¤„ç†
        System.err.println("æ”¯ä»˜å¤„ç†æœ€ç»ˆå¤±è´¥ï¼Œè½¬å…¥äººå·¥å¤„ç†é˜Ÿåˆ—");
        moveToManualProcessQueue(event);
    }
}
```

**ğŸ¥ æ­»ä¿¡é˜Ÿåˆ—å¤„ç†**

```java
@Configuration
public class DeadLetterConfig {
    
    @Bean
    public Queue paymentQueue() {
        return QueueBuilder.durable("payment.queue")
            .withArgument("x-dead-letter-exchange", "dlx.exchange")  // æ­»ä¿¡äº¤æ¢æœº
            .withArgument("x-dead-letter-routing-key", "payment.dlq") // æ­»ä¿¡è·¯ç”±é”®
            .withArgument("x-message-ttl", 30000) // æ¶ˆæ¯30ç§’è¿‡æœŸ
            .build();
    }
    
    @Bean
    public Queue deadLetterQueue() {
        return QueueBuilder.durable("payment.dlq").build();
    }
}

@Component
public class DeadLetterHandler {
    
    @RabbitListener(queues = "payment.dlq")
    public void handleDeadLetter(PaymentEvent event, @Header Map<String, Object> headers) {
        // å¤„ç†è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—çš„æ¶ˆæ¯
        System.out.println("å¤„ç†æ­»ä¿¡æ¶ˆæ¯: " + event.getPaymentId());
        
        // å¯ä»¥è¿›è¡Œä»¥ä¸‹æ“ä½œï¼š
        // 1. è®°å½•åˆ°æ•°æ®åº“ä¾›åç»­åˆ†æ
        // 2. å‘é€å‘Šè­¦é€šçŸ¥è¿ç»´äººå‘˜
        // 3. è½¬å…¥äººå·¥å¤„ç†æµç¨‹
    }
}
```

### 4.4 äº‹ä»¶å¤„ç†çš„å¹‚ç­‰æ€§


**ğŸ”’ å¹‚ç­‰æ€§çš„é‡è¦æ€§**
ç”±äºç½‘ç»œé—®é¢˜æˆ–é‡è¯•æœºåˆ¶ï¼ŒåŒä¸€ä¸ªäº‹ä»¶å¯èƒ½è¢«å¤„ç†å¤šæ¬¡ï¼Œéœ€è¦ä¿è¯å¤„ç†ç»“æœçš„ä¸€è‡´æ€§ï¼š

```java
@Service
public class IdempotentEventHandler {
    
    // ä½¿ç”¨Rediså­˜å‚¨å·²å¤„ç†çš„äº‹ä»¶ID
    @Autowired
    private StringRedisTemplate redisTemplate;
    
    @EventListener
    public void handleOrderCreated(OrderCreatedEvent event) {
        String eventId = event.getEventId();
        String lockKey = "event:lock:" + eventId;
        
        // å°è¯•è·å–åˆ†å¸ƒå¼é”
        Boolean locked = redisTemplate.opsForValue().setIfAbsent(lockKey, "1", Duration.ofMinutes(5));
        
        if (Boolean.TRUE.equals(locked)) {
            try {
                // æ£€æŸ¥æ˜¯å¦å·²ç»å¤„ç†è¿‡
                if (!isEventProcessed(eventId)) {
                    processOrderCreated(event);
                    markEventProcessed(eventId);
                }
            } finally {
                redisTemplate.delete(lockKey); // é‡Šæ”¾é”
            }
        }
    }
    
    private boolean isEventProcessed(String eventId) {
        return redisTemplate.hasKey("processed:event:" + eventId);
    }
    
    private void markEventProcessed(String eventId) {
        redisTemplate.opsForValue().set("processed:event:" + eventId, "1", Duration.ofDays(7));
    }
}
```

---

## 5. ğŸ“š äº‹ä»¶æº¯æºè®¾è®¡ä¸å®ç°


### 5.1 ä»€ä¹ˆæ˜¯äº‹ä»¶æº¯æº


**ğŸ”¸ é€šä¿—ç†è§£**
äº‹ä»¶æº¯æºå°±åƒé“¶è¡Œè´¦æˆ·çš„æµæ°´è®°å½•ï¼Œè®°å½•æ¯ä¸€ç¬”æ“ä½œï¼Œè€Œä¸æ˜¯åªè®°å½•æœ€ç»ˆä½™é¢ï¼š

```
ä¼ ç»Ÿæ–¹å¼ï¼ˆå­˜å‚¨å½“å‰çŠ¶æ€ï¼‰ï¼š
ç”¨æˆ·ä½™é¢è¡¨ï¼šuserId=123, balance=1000

äº‹ä»¶æº¯æºæ–¹å¼ï¼ˆå­˜å‚¨æ“ä½œå†å²ï¼‰ï¼š
äº‹ä»¶1ï¼šç”¨æˆ·123å¼€æˆ·ï¼Œå­˜å…¥2000å…ƒ
äº‹ä»¶2ï¼šç”¨æˆ·123è´­ä¹°å•†å“ï¼Œæ”¯å‡º500å…ƒ  
äº‹ä»¶3ï¼šç”¨æˆ·123æ”¶åˆ°é€€æ¬¾ï¼Œæ”¶å…¥300å…ƒ
äº‹ä»¶4ï¼šç”¨æˆ·123è½¬è´¦ï¼Œæ”¯å‡º800å…ƒ
å½“å‰ä½™é¢ = 2000 - 500 + 300 - 800 = 1000å…ƒ
```

**ğŸ’¡ æ ¸å¿ƒæ€æƒ³**
- ğŸ¦ **å­˜å‚¨äº‹ä»¶æµ**ï¼šä¿å­˜å¯¼è‡´çŠ¶æ€å˜åŒ–çš„æ‰€æœ‰äº‹ä»¶
- ğŸ”„ **çŠ¶æ€é‡å»º**ï¼šé€šè¿‡é‡æ”¾äº‹ä»¶æ¥é‡å»ºå½“å‰çŠ¶æ€
- ğŸ“œ **å®Œæ•´å†å²**ï¼šä¿ç•™ç³»ç»Ÿçš„å®Œæ•´å˜æ›´å†å²

### 5.2 äº‹ä»¶æº¯æºçš„ä¼˜åŠ¿


**ğŸ¯ ä¸»è¦ä¼˜åŠ¿**

```
ğŸ”¸ å®¡è®¡è¿½è¸ªï¼šå¯ä»¥è¿½æº¯ä»»ä½•æ—¶åˆ»çš„ç³»ç»ŸçŠ¶æ€
ğŸ”¸ æ—¶é—´æ—…è¡Œï¼šå¯ä»¥æŸ¥çœ‹å†å²ä»»æ„æ—¶é—´ç‚¹çš„æ•°æ®
ğŸ”¸ è°ƒè¯•å‹å¥½ï¼šå¯ä»¥é‡æ”¾äº‹ä»¶æµè¿›è¡Œé—®é¢˜è¯Šæ–­
ğŸ”¸ æ•°æ®æ¢å¤ï¼šé€šè¿‡äº‹ä»¶é‡æ”¾æ¢å¤æ•°æ®
ğŸ”¸ åˆ†ææ”¯æŒï¼šåŸºäºäº‹ä»¶æµè¿›è¡Œä¸šåŠ¡åˆ†æ
```

**ğŸ“Š å¯¹æ¯”ä¼ ç»ŸCRUDæ–¹å¼**

| ç‰¹æ€§ | ä¼ ç»ŸCRUD | äº‹ä»¶æº¯æº |
|------|----------|----------|
| **æ•°æ®å­˜å‚¨** | å½“å‰çŠ¶æ€ | äº‹ä»¶å†å² |
| **å†å²è¿½è¸ª** | å›°éš¾ | å¤©ç„¶æ”¯æŒ |
| **å¹¶å‘å†²çª** | é”æœºåˆ¶ | ä¹è§‚å¹¶å‘ |
| **å®¡è®¡èƒ½åŠ›** | éœ€é¢å¤–å®ç° | å†…å»ºæ”¯æŒ |
| **å¤æ‚åº¦** | ç®€å• | è¾ƒå¤æ‚ |

### 5.3 äº‹ä»¶æº¯æºå®ç°ç¤ºä¾‹


**ğŸ—ï¸ äº‹ä»¶å­˜å‚¨ç»“æ„**

```java
// äº‹ä»¶å®ä½“
@Entity
public class EventStore {
    @Id
    private String eventId;
    
    private String aggregateId;    // èšåˆæ ¹ID
    private String eventType;      // äº‹ä»¶ç±»å‹
    private String eventData;      // äº‹ä»¶æ•°æ®(JSON)
    private String metadata;       // å…ƒæ•°æ®
    private long version;          // äº‹ä»¶ç‰ˆæœ¬å·
    private LocalDateTime timestamp; // æ—¶é—´æˆ³
    
    // æ„é€ å‡½æ•°å’Œgetter/setter...
}

// è´¦æˆ·èšåˆæ ¹
public class Account {
    private String accountId;
    private BigDecimal balance;
    private List<Event> uncommittedEvents = new ArrayList<>();
    
    // é€šè¿‡äº‹ä»¶é‡å»ºè´¦æˆ·çŠ¶æ€
    public static Account fromHistory(List<Event> events) {
        Account account = new Account();
        for (Event event : events) {
            account.apply(event);
        }
        return account;
    }
    
    // å¤„ç†å­˜æ¬¾äº‹ä»¶
    public void deposit(BigDecimal amount) {
        DepositEvent event = new DepositEvent(accountId, amount);
        apply(event);
        uncommittedEvents.add(event);
    }
    
    // åº”ç”¨äº‹ä»¶åˆ°å½“å‰çŠ¶æ€
    private void apply(Event event) {
        if (event instanceof DepositEvent) {
            DepositEvent depositEvent = (DepositEvent) event;
            this.balance = this.balance.add(depositEvent.getAmount());
        } else if (event instanceof WithdrawEvent) {
            WithdrawEvent withdrawEvent = (WithdrawEvent) event;
            this.balance = this.balance.subtract(withdrawEvent.getAmount());
        }
    }
}
```

**ğŸ’¾ äº‹ä»¶å­˜å‚¨åº“**

```java
@Repository
public class EventStoreRepository {
    
    @Autowired
    private JdbcTemplate jdbcTemplate;
    
    /**
     * ä¿å­˜äº‹ä»¶åˆ°äº‹ä»¶å­˜å‚¨
     */
    public void saveEvents(String aggregateId, List<Event> events, long expectedVersion) {
        for (Event event : events) {
            String sql = "INSERT INTO event_store (event_id, aggregate_id, event_type, event_data, version, timestamp) VALUES (?, ?, ?, ?, ?, ?)";
            
            jdbcTemplate.update(sql,
                event.getEventId(),
                aggregateId,
                event.getClass().getSimpleName(),
                toJson(event),
                ++expectedVersion,
                LocalDateTime.now()
            );
        }
    }
    
    /**
     * è·å–èšåˆçš„æ‰€æœ‰äº‹ä»¶
     */
    public List<Event> getEventsForAggregate(String aggregateId) {
        String sql = "SELECT * FROM event_store WHERE aggregate_id = ? ORDER BY version";
        
        return jdbcTemplate.query(sql, new Object[]{aggregateId}, (rs, rowNum) -> {
            String eventType = rs.getString("event_type");
            String eventData = rs.getString("event_data");
            return fromJson(eventData, getEventClass(eventType));
        });
    }
    
    /**
     * è·å–æŒ‡å®šç‰ˆæœ¬åçš„äº‹ä»¶
     */
    public List<Event> getEventsForAggregateAfterVersion(String aggregateId, long version) {
        String sql = "SELECT * FROM event_store WHERE aggregate_id = ? AND version > ? ORDER BY version";
        
        return jdbcTemplate.query(sql, new Object[]{aggregateId, version}, (rs, rowNum) -> {
            String eventType = rs.getString("event_type");
            String eventData = rs.getString("event_data");
            return fromJson(eventData, getEventClass(eventType));
        });
    }
}
```

### 5.4 å¿«ç…§æœºåˆ¶ä¼˜åŒ–


**ğŸ“¸ ä¸ºä»€ä¹ˆéœ€è¦å¿«ç…§**
å½“äº‹ä»¶æ•°é‡å¾ˆå¤šæ—¶ï¼Œé‡å»ºçŠ¶æ€ä¼šå¾ˆæ…¢ï¼Œå¿«ç…§å¯ä»¥åŠ é€Ÿè¿™ä¸ªè¿‡ç¨‹ï¼š

```java
// å¿«ç…§å®ä½“
@Entity
public class Snapshot {
    @Id
    private String aggregateId;
    private String aggregateType;
    private String snapshotData;  // èšåˆçŠ¶æ€çš„JSON
    private long version;         // å¿«ç…§æ—¶çš„ç‰ˆæœ¬å·
    private LocalDateTime timestamp;
}

// å¿«ç…§æœåŠ¡
@Service
public class SnapshotService {
    
    private static final int SNAPSHOT_FREQUENCY = 100; // æ¯100ä¸ªäº‹ä»¶åˆ›å»ºä¸€æ¬¡å¿«ç…§
    
    /**
     * åŠ è½½èšåˆï¼ˆä¼˜å…ˆä½¿ç”¨å¿«ç…§ï¼‰
     */
    public Account loadAccount(String accountId) {
        // 1. å°è¯•åŠ è½½æœ€æ–°å¿«ç…§
        Snapshot snapshot = snapshotRepository.findLatestSnapshot(accountId);
        
        Account account;
        long fromVersion = 0;
        
        if (snapshot != null) {
            // ä»å¿«ç…§æ¢å¤
            account = fromJson(snapshot.getSnapshotData(), Account.class);
            fromVersion = snapshot.getVersion();
        } else {
            // åˆ›å»ºæ–°è´¦æˆ·
            account = new Account(accountId);
        }
        
        // 2. åº”ç”¨å¿«ç…§åçš„äº‹ä»¶
        List<Event> events = eventStoreRepository.getEventsForAggregateAfterVersion(accountId, fromVersion);
        for (Event event : events) {
            account.apply(event);
        }
        
        // 3. æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ›å»ºæ–°å¿«ç…§
        if (events.size() >= SNAPSHOT_FREQUENCY) {
            createSnapshot(account);
        }
        
        return account;
    }
    
    private void createSnapshot(Account account) {
        Snapshot snapshot = new Snapshot();
        snapshot.setAggregateId(account.getAccountId());
        snapshot.setAggregateType("Account");
        snapshot.setSnapshotData(toJson(account));
        snapshot.setVersion(account.getVersion());
        snapshot.setTimestamp(LocalDateTime.now());
        
        snapshotRepository.save(snapshot);
    }
}
```

---

## 6. ğŸ”„ CQRSå‘½ä»¤æŸ¥è¯¢èŒè´£åˆ†ç¦»


### 6.1 ä»€ä¹ˆæ˜¯CQRS


**ğŸ”¸ é€šä¿—ç†è§£**
CQRSå°±åƒå›¾ä¹¦é¦†çš„å€Ÿè¿˜ä¹¦å’ŒæŸ¥ä¹¦ç³»ç»Ÿåˆ†ç¦»ï¼š

```
ä¼ ç»Ÿæ–¹å¼ï¼ˆåŒä¸€ä¸ªç³»ç»Ÿï¼‰ï¼š
ğŸ“š å›¾ä¹¦ç®¡ç†ç³»ç»Ÿ
â”œâ”€â”€ å€Ÿä¹¦åŠŸèƒ½ï¼ˆå†™æ“ä½œï¼‰
â”œâ”€â”€ è¿˜ä¹¦åŠŸèƒ½ï¼ˆå†™æ“ä½œï¼‰  
â”œâ”€â”€ æŸ¥æ‰¾å›¾ä¹¦ï¼ˆè¯»æ“ä½œï¼‰
â””â”€â”€ ç»Ÿè®¡æŠ¥è¡¨ï¼ˆè¯»æ“ä½œï¼‰

CQRSæ–¹å¼ï¼ˆåˆ†ç¦»ç³»ç»Ÿï¼‰ï¼š
ğŸ“ å€Ÿè¿˜ä¹¦ç³»ç»Ÿï¼ˆå‘½ä»¤ç«¯ï¼‰        ğŸ“Š æŸ¥è¯¢ç»Ÿè®¡ç³»ç»Ÿï¼ˆæŸ¥è¯¢ç«¯ï¼‰
â”œâ”€â”€ å€Ÿä¹¦åŠŸèƒ½                 â”œâ”€â”€ å›¾ä¹¦æŸ¥æ‰¾
â”œâ”€â”€ è¿˜ä¹¦åŠŸèƒ½        åŒæ­¥      â”œâ”€â”€ åº“å­˜ç»Ÿè®¡
â””â”€â”€ æ–°ä¹¦å…¥åº“        â”€â”€â”€â”€â†’    â””â”€â”€ å€Ÿé˜…æŠ¥è¡¨
```

**ğŸ’¡ æ ¸å¿ƒæ€æƒ³**
- âœï¸ **å‘½ä»¤ç«¯ï¼ˆCommandï¼‰**ï¼šè´Ÿè´£å¤„ç†å†™æ“ä½œï¼Œæ”¹å˜ç³»ç»ŸçŠ¶æ€
- ğŸ“– **æŸ¥è¯¢ç«¯ï¼ˆQueryï¼‰**ï¼šè´Ÿè´£å¤„ç†è¯»æ“ä½œï¼Œæä¾›æ•°æ®æŸ¥è¯¢
- ğŸ”„ **æ•°æ®åŒæ­¥**ï¼šå‘½ä»¤ç«¯çš„å˜æ›´åŒæ­¥åˆ°æŸ¥è¯¢ç«¯

### 6.2 CQRSè§£å†³çš„é—®é¢˜


**ğŸ¯ ä¼ ç»Ÿæ¶æ„çš„ç—›ç‚¹**

```java
// âŒ ä¼ ç»Ÿæ¶æ„ï¼šè¯»å†™æ··åˆ
@Entity
public class Order {
    private String id;
    private String customerId;
    private List<OrderItem> items;
    private OrderStatus status;
    private BigDecimal totalAmount;
    
    // æ—¢è¦æ”¯æŒå¤æ‚çš„å†™æ“ä½œ
    public void addItem(OrderItem item) { ... }
    public void cancel() { ... }
    public void ship() { ... }
    
    // åˆè¦æ”¯æŒå¤æ‚çš„æŸ¥è¯¢éœ€æ±‚
    public List<Order> findOrdersByCustomerAndDateRange(...) { ... }
    public OrderStatistics getOrderStatistics(...) { ... }
    public List<Order> findTopSellingProducts(...) { ... }
}
```

**âœ… CQRSæ¶æ„çš„ä¼˜åŠ¿**

```java
// âœ… å‘½ä»¤ç«¯ï¼šä¸“æ³¨å†™æ“ä½œ
public class OrderCommandModel {
    public void createOrder(CreateOrderCommand command) {
        // ä¸“æ³¨ä¸šåŠ¡é€»è¾‘å’Œæ•°æ®ä¸€è‡´æ€§
    }
    
    public void cancelOrder(CancelOrderCommand command) {
        // ä¸“æ³¨å‘½ä»¤å¤„ç†
    }
}

// âœ… æŸ¥è¯¢ç«¯ï¼šä¸“æ³¨è¯»æ“ä½œ
public class OrderQueryModel {
    public List<OrderView> findOrdersByCustomer(String customerId) {
        // ä¼˜åŒ–çš„æŸ¥è¯¢ç»“æ„
    }
    
    public OrderStatistics getStatistics(StatisticsQuery query) {
        // é¢„è®¡ç®—çš„ç»Ÿè®¡æ•°æ®
    }
}
```

### 6.3 CQRSæ¶æ„å®ç°


**ğŸ—ï¸ å‘½ä»¤ç«¯å®ç°**

```java
// å‘½ä»¤å®šä¹‰
public class CreateOrderCommand {
    private final String customerId;
    private final List<OrderItemDto> items;
    private final String deliveryAddress;
    
    // æ„é€ å‡½æ•°...
}

// å‘½ä»¤å¤„ç†å™¨
@Component
public class OrderCommandHandler {
    
    @Autowired
    private OrderRepository orderRepository;
    
    @Autowired
    private EventPublisher eventPublisher;
    
    @CommandHandler
    public void handle(CreateOrderCommand command) {
        // 1. ä¸šåŠ¡éªŒè¯
        validateCommand(command);
        
        // 2. åˆ›å»ºè®¢å•èšåˆ
        Order order = new Order(
            UUID.randomUUID().toString(),
            command.getCustomerId(),
            command.getItems()
        );
        
        // 3. ä¿å­˜åˆ°å†™æ•°æ®åº“
        orderRepository.save(order);
        
        // 4. å‘å¸ƒé¢†åŸŸäº‹ä»¶
        eventPublisher.publish(new OrderCreatedEvent(
            order.getId(),
            order.getCustomerId(),
            order.getTotalAmount()
        ));
    }
    
    private void validateCommand(CreateOrderCommand command) {
        if (command.getItems().isEmpty()) {
            throw new IllegalArgumentException("è®¢å•è‡³å°‘åŒ…å«ä¸€ä¸ªå•†å“");
        }
        // å…¶ä»–ä¸šåŠ¡éªŒè¯...
    }
}
```

**ğŸ“Š æŸ¥è¯¢ç«¯å®ç°**

```java
// æŸ¥è¯¢æ¨¡å‹ï¼ˆè¯»ä¼˜åŒ–çš„æ•°æ®ç»“æ„ï¼‰
@Entity
@Table(name = "order_view")
public class OrderView {
    @Id
    private String orderId;
    private String customerName;     // å†—ä½™å®¢æˆ·å§“åï¼Œé¿å…å…³è”æŸ¥è¯¢
    private String customerEmail;    // å†—ä½™å®¢æˆ·é‚®ç®±
    private BigDecimal totalAmount;
    private String status;
    private LocalDateTime orderDate;
    private int itemCount;           // é¢„è®¡ç®—çš„å•†å“æ•°é‡
    
    // getter/setter...
}

// æŸ¥è¯¢å¤„ç†å™¨
@Component
public class OrderQueryHandler {
    
    @Autowired
    private OrderViewRepository orderViewRepository;
    
    @QueryHandler
    public List<OrderView> handle(FindOrdersByCustomerQuery query) {
        return orderViewRepository.findByCustomerId(
            query.getCustomerId(),
            PageRequest.of(query.getPage(), query.getSize())
        );
    }
    
    @QueryHandler
    public OrderStatistics handle(GetOrderStatisticsQuery query) {
        // ä»é¢„è®¡ç®—çš„ç»Ÿè®¡è¡¨æŸ¥è¯¢
        return statisticsRepository.getStatisticsByDateRange(
            query.getStartDate(), 
            query.getEndDate()
        );
    }
}
```

### 6.4 æ•°æ®åŒæ­¥æœºåˆ¶


**ğŸ”„ äº‹ä»¶é©±åŠ¨çš„æ•°æ®åŒæ­¥**

```java
// æŸ¥è¯¢ç«¯äº‹ä»¶å¤„ç†å™¨
@Component
public class OrderViewProjector {
    
    @Autowired
    private OrderViewRepository orderViewRepository;
    
    @Autowired
    private CustomerService customerService;
    
    @EventHandler
    public void on(OrderCreatedEvent event) {
        // è·å–å®¢æˆ·ä¿¡æ¯ï¼ˆå¯èƒ½æ¥è‡ªç¼“å­˜æˆ–å…¶ä»–æœåŠ¡ï¼‰
        Customer customer = customerService.getCustomer(event.getCustomerId());
        
        // åˆ›å»ºæŸ¥è¯¢æ¨¡å‹
        OrderView orderView = new OrderView();
        orderView.setOrderId(event.getOrderId());
        orderView.setCustomerName(customer.getName());
        orderView.setCustomerEmail(customer.getEmail());
        orderView.setTotalAmount(event.getTotalAmount());
        orderView.setStatus("CREATED");
        orderView.setOrderDate(LocalDateTime.now());
        orderView.setItemCount(event.getItems().size());
        
        // ä¿å­˜åˆ°æŸ¥è¯¢æ•°æ®åº“
        orderViewRepository.save(orderView);
    }
    
    @EventHandler
    public void on(OrderShippedEvent event) {
        // æ›´æ–°è®¢å•çŠ¶æ€
        OrderView orderView = orderViewRepository.findById(event.getOrderId())
            .orElseThrow(() -> new RuntimeException("è®¢å•è§†å›¾ä¸å­˜åœ¨"));
        
        orderView.setStatus("SHIPPED");
        orderViewRepository.save(orderView);
    }
}
```

**âš¡ æœ€ç»ˆä¸€è‡´æ€§å¤„ç†**

```java
@Component
public class ConsistencyChecker {
    
    @Scheduled(fixedDelay = 60000) // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    public void checkConsistency() {
        // æ£€æŸ¥å‘½ä»¤ç«¯å’ŒæŸ¥è¯¢ç«¯çš„æ•°æ®ä¸€è‡´æ€§
        List<String> commandOrderIds = commandRepository.getAllOrderIds();
        List<String> queryOrderIds = queryRepository.getAllOrderIds();
        
        // æ‰¾å‡ºä¸ä¸€è‡´çš„è®¢å•
        Set<String> missingInQuery = new HashSet<>(commandOrderIds);
        missingInQuery.removeAll(queryOrderIds);
        
        // ä¿®å¤ä¸ä¸€è‡´çš„æ•°æ®
        for (String orderId : missingInQuery) {
            Order order = commandRepository.findById(orderId);
            rebuildOrderView(order);
        }
    }
    
    private void rebuildOrderView(Order order) {
        // ä»å‘½ä»¤ç«¯é‡å»ºæŸ¥è¯¢ç«¯è§†å›¾
        OrderView orderView = OrderViewBuilder.fromOrder(order);
        queryRepository.save(orderView);
    }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ”¸ äº‹ä»¶é©±åŠ¨æ¶æ„åŸºç¡€**
```
ğŸ’¡ äº‹ä»¶ï¼šç³»ç»ŸçŠ¶æ€å˜åŒ–çš„è®°å½•
ğŸšŒ äº‹ä»¶æ€»çº¿ï¼šè¿æ¥å‘å¸ƒè€…å’Œè®¢é˜…è€…çš„ä¸­ä»‹
âš¡ å¼‚æ­¥å¤„ç†ï¼šæé«˜å“åº”é€Ÿåº¦å’Œç³»ç»Ÿååé‡
ğŸ“š äº‹ä»¶æº¯æºï¼šé€šè¿‡äº‹ä»¶å†å²é‡å»ºç³»ç»ŸçŠ¶æ€
ğŸ”„ CQRSï¼šå‘½ä»¤æŸ¥è¯¢èŒè´£åˆ†ç¦»ï¼Œä¼˜åŒ–è¯»å†™æ€§èƒ½
```

### 7.2 å…³é”®è®¾è®¡åŸåˆ™


**ğŸ¯ äº‹ä»¶è®¾è®¡åŸåˆ™**
- âœ… **å•ä¸€èŒè´£**ï¼šä¸€ä¸ªäº‹ä»¶è¡¨è¾¾ä¸€ä¸ªæ˜ç¡®çš„ä¸šåŠ¡å«ä¹‰
- âœ… **ä¸å¯å˜æ€§**ï¼šäº‹ä»¶ä¸€æ—¦åˆ›å»ºä¸èƒ½ä¿®æ”¹
- âœ… **ä¸šåŠ¡è¯­è¨€**ï¼šä½¿ç”¨é¢†åŸŸä¸“å®¶èƒ½ç†è§£çš„æœ¯è¯­
- âœ… **è¿‡å»æ—¶æ€**ï¼šäº‹ä»¶åä½¿ç”¨è¿‡å»æ—¶ï¼Œè¡¨ç¤ºå·²å‘ç”Ÿçš„äº‹æƒ…

**ğŸ—ï¸ æ¶æ„è®¾è®¡åŸåˆ™**
- ğŸ”¸ **æ¾è€¦åˆ**ï¼šç»„ä»¶é—´é€šè¿‡äº‹ä»¶é€šä¿¡ï¼Œå‡å°‘ç›´æ¥ä¾èµ–
- ğŸ”¸ **é«˜å†…èš**ï¼šç›¸å…³çš„ä¸šåŠ¡é€»è¾‘èšåˆåœ¨ä¸€èµ·
- ğŸ”¸ **å¯æ‰©å±•**ï¼šæ–°åŠŸèƒ½é€šè¿‡å¢åŠ äº‹ä»¶ç›‘å¬å™¨å®ç°
- ğŸ”¸ **å®¹é”™æ€§**ï¼šå•ä¸ªç»„ä»¶æ•…éšœä¸å½±å“æ•´ä½“ç³»ç»Ÿ

### 7.3 å®è·µè¦ç‚¹æ€»ç»“


**âš¡ å¼‚æ­¥å¤„ç†æœ€ä½³å®è·µ**
```
ğŸ”„ é‡è¯•æœºåˆ¶ï¼šæŒ‡æ•°é€€é¿ + æœ€å¤§é‡è¯•æ¬¡æ•°
ğŸ¥ æ­»ä¿¡é˜Ÿåˆ—ï¼šå¤„ç†æœ€ç»ˆå¤±è´¥çš„æ¶ˆæ¯
ğŸ”’ å¹‚ç­‰æ€§ï¼šç¡®ä¿é‡å¤å¤„ç†ä¸äº§ç”Ÿå‰¯ä½œç”¨
ğŸ“Š ç›‘æ§å‘Šè­¦ï¼šåŠæ—¶å‘ç°å’Œå¤„ç†å¼‚å¸¸
```

**ğŸ“š äº‹ä»¶æº¯æºåº”ç”¨åœºæ™¯**
```
âœ… å®¡è®¡è¦æ±‚é«˜çš„ä¸šåŠ¡ï¼šé‡‘èã€åŒ»ç–—ã€æ³•å¾‹
âœ… éœ€è¦å†å²è¿½æº¯ï¼šè®¢å•çŠ¶æ€å˜æ›´ã€åº“å­˜å˜åŒ–
âœ… å¤æ‚ä¸šåŠ¡æµç¨‹ï¼šå·¥ä½œæµã€çŠ¶æ€æœº
âœ… åˆ†æéœ€æ±‚å¼ºï¼šç”¨æˆ·è¡Œä¸ºåˆ†æã€ä¸šåŠ¡è¶‹åŠ¿
```

**ğŸ”„ CQRSé€‚ç”¨æ¡ä»¶**
```
âœ… è¯»å†™æ¯”ä¾‹å·®å¼‚å¤§ï¼šè¯»å¤šå†™å°‘æˆ–å†™å¤šè¯»å°‘
âœ… æŸ¥è¯¢å¤æ‚ï¼šéœ€è¦è·¨å¤šä¸ªèšåˆçš„å¤æ‚æŸ¥è¯¢
âœ… æ€§èƒ½è¦æ±‚é«˜ï¼šè¯»å†™éœ€è¦ä¸åŒçš„ä¼˜åŒ–ç­–ç•¥
âœ… å›¢é˜Ÿè§„æ¨¡å¤§ï¼šå¯ä»¥åˆ†å·¥å¼€å‘å‘½ä»¤ç«¯å’ŒæŸ¥è¯¢ç«¯
```

### 7.4 æ¶æ„æ¼”è¿›å»ºè®®


**ğŸ“ˆ æ¸è¿›å¼é‡‡ç”¨ç­–ç•¥**
```
ç¬¬ä¸€é˜¶æ®µï¼šä»ç®€å•çš„äº‹ä»¶é€šçŸ¥å¼€å§‹
ç¬¬äºŒé˜¶æ®µï¼šå¼•å…¥äº‹ä»¶æ€»çº¿ï¼Œå®ç°ç³»ç»Ÿè§£è€¦
ç¬¬ä¸‰é˜¶æ®µï¼šåœ¨å…³é”®ä¸šåŠ¡å¼•å…¥äº‹ä»¶æº¯æº
ç¬¬å››é˜¶æ®µï¼šåœ¨å¤æ‚æŸ¥è¯¢åœºæ™¯å¼•å…¥CQRS
```

**âš ï¸ å¸¸è§é™·é˜±ä¸é¿å‘æŒ‡å—**
```
âŒ è¿‡åº¦è®¾è®¡ï¼šä¸è¦ä¸€å¼€å§‹å°±é‡‡ç”¨æ‰€æœ‰æ¨¡å¼
âŒ äº‹ä»¶æ³›æ»¥ï¼šé¿å…ä¸ºæ¯ä¸ªå°å˜åŒ–éƒ½åˆ›å»ºäº‹ä»¶
âŒ å¿½ç•¥ç›‘æ§ï¼šäº‹ä»¶é©±åŠ¨ç³»ç»Ÿæ›´éœ€è¦å®Œå–„çš„ç›‘æ§
âŒ æ•°æ®ä¸€è‡´æ€§ï¼šç†è§£æœ€ç»ˆä¸€è‡´æ€§çš„ä¸šåŠ¡å½±å“
```

**ğŸ¯ æ ¸å¿ƒä»·å€¼æ€»ç»“**
äº‹ä»¶é©±åŠ¨æ¶æ„é€šè¿‡äº‹ä»¶è¿™ä¸ªç»Ÿä¸€çš„æŠ½è±¡ï¼Œå®ç°äº†ç³»ç»Ÿçš„**æ¾è€¦åˆ**ã€**é«˜æ‰©å±•æ€§**å’Œ**å®¹é”™æ€§**ã€‚è™½ç„¶å¢åŠ äº†ç³»ç»Ÿå¤æ‚åº¦ï¼Œä½†åœ¨å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œè¿™ç§æ¶æ„èƒ½å¤Ÿå¸¦æ¥æ˜¾è‘—çš„ä¸šåŠ¡ä»·å€¼å’ŒæŠ€æœ¯ä¼˜åŠ¿ã€‚

**è®°å¿†å£è¯€**ï¼š
- äº‹ä»¶é©±åŠ¨è§£è€¦åˆï¼Œå¼‚æ­¥å¤„ç†ææ€§èƒ½
- æº¯æºé‡æ”¾çœ‹å†å²ï¼ŒCQRSåˆ†ç¦»è¯»å’Œå†™
- æœ€ç»ˆä¸€è‡´å¯æ¥å—ï¼Œç›‘æ§å‘Šè­¦ä¸å¯å°‘