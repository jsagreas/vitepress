---
title: 5ã€åˆ†å¸ƒå¼æ•°æ®
---
## ğŸ“š ç›®å½•

1. [åˆ†å¸ƒå¼æ•°æ®æ¦‚è¿°](#1-åˆ†å¸ƒå¼æ•°æ®æ¦‚è¿°)
2. [æ•°æ®å¤åˆ¶ç­–ç•¥](#2-æ•°æ®å¤åˆ¶ç­–ç•¥)
3. [åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†](#3-åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†)
4. [æœ€ç»ˆä¸€è‡´æ€§è®¾è®¡](#4-æœ€ç»ˆä¸€è‡´æ€§è®¾è®¡)
5. [å†²çªè§£å†³ç­–ç•¥](#5-å†²çªè§£å†³ç­–ç•¥)
6. [æ•°æ®åŒæ­¥æœºåˆ¶](#6-æ•°æ®åŒæ­¥æœºåˆ¶)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ åˆ†å¸ƒå¼æ•°æ®æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼æ•°æ®


**ğŸ”¸ ç®€å•ç†è§£**
åˆ†å¸ƒå¼æ•°æ®å°±åƒæ˜¯æŠŠä¸€æœ¬å¤§è¯å…¸åˆ†æˆå¤šå†Œï¼Œåˆ†åˆ«æ”¾åœ¨ä¸åŒçš„å›¾ä¹¦é¦†é‡Œã€‚æ¯ä¸ªå›¾ä¹¦é¦†éƒ½æœ‰éƒ¨åˆ†å†…å®¹ï¼Œä½†åˆèµ·æ¥å°±æ˜¯å®Œæ•´çš„è¯å…¸ã€‚

```
å•æœºæ•°æ®ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®Œæ•´æ•°æ®åº“  â”‚  â† æ‰€æœ‰æ•°æ®éƒ½åœ¨ä¸€å°æœºå™¨ä¸Š
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åˆ†å¸ƒå¼æ•°æ®ï¼š
â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”
â”‚æ•°æ®A â”‚  â”‚æ•°æ®B â”‚  â”‚æ•°æ®C â”‚  â† æ•°æ®åˆ†æ•£åœ¨å¤šå°æœºå™¨ä¸Š
â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜
  æœºå™¨1     æœºå™¨2     æœºå™¨3
```

**ğŸ¯ ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼æ•°æ®**
- **å®¹é‡é—®é¢˜**ï¼šå•æœºè£…ä¸ä¸‹æµ·é‡æ•°æ®
- **æ€§èƒ½é—®é¢˜**ï¼šå•æœºå¤„ç†èƒ½åŠ›æœ‰é™
- **å¯é æ€§é—®é¢˜**ï¼šå•æœºæ•…éšœä¼šå¯¼è‡´å…¨éƒ¨æ•°æ®ä¸¢å¤±
- **åœ°ç†åˆ†å¸ƒ**ï¼šç”¨æˆ·åˆ†å¸ƒåœ¨å…¨çƒå„åœ°ï¼Œå°±è¿‘è®¿é—®æ›´å¿«

### 1.2 åˆ†å¸ƒå¼æ•°æ®é¢ä¸´çš„æ ¸å¿ƒæŒ‘æˆ˜


**ğŸš¨ ä¸»è¦å›°éš¾**
```
ä¸€è‡´æ€§é—®é¢˜ï¼š
å¤šä¸ªå‰¯æœ¬çš„æ•°æ®å¦‚ä½•ä¿æŒä¸€è‡´ï¼Ÿ

å¯ç”¨æ€§é—®é¢˜ï¼š
éƒ¨åˆ†æœºå™¨æ•…éšœæ—¶ï¼Œç³»ç»Ÿè¿˜èƒ½æ­£å¸¸å·¥ä½œå—ï¼Ÿ

åˆ†åŒºå®¹é”™æ€§ï¼š
ç½‘ç»œä¸­æ–­æ—¶ï¼Œç³»ç»Ÿå¦‚ä½•å¤„ç†ï¼Ÿ

æ€§èƒ½é—®é¢˜ï¼š
åˆ†å¸ƒå¼å¸¦æ¥çš„é¢å¤–å¼€é”€å¦‚ä½•æ§åˆ¶ï¼Ÿ
```

**ğŸ’¡ CAPå®šç†ç®€å•ç†è§£**
> ğŸ“‹ **CAPå®šç†**ï¼šåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œä¸€è‡´æ€§(C)ã€å¯ç”¨æ€§(A)ã€åˆ†åŒºå®¹é”™æ€§(P)ä¸‰è€…æœ€å¤šåªèƒ½åŒæ—¶ä¿è¯ä¸¤ä¸ª

```
å°±åƒé±¼ä¸ç†ŠæŒä¸å¯å…¼å¾—ï¼š
- è¦ä¸€è‡´æ€§ + å¯ç”¨æ€§ â†’ ç½‘ç»œå¿…é¡»å®Œç¾ï¼ˆç°å®ä¸å¯èƒ½ï¼‰
- è¦ä¸€è‡´æ€§ + åˆ†åŒºå®¹é”™ â†’ å¯èƒ½æš‚æ—¶ä¸å¯ç”¨
- è¦å¯ç”¨æ€§ + åˆ†åŒºå®¹é”™ â†’ å¯èƒ½æ•°æ®ä¸ä¸€è‡´
```

---

## 2. ğŸ“‹ æ•°æ®å¤åˆ¶ç­–ç•¥


### 2.1 ä»€ä¹ˆæ˜¯æ•°æ®å¤åˆ¶


**ğŸ”¸ åŸºæœ¬æ¦‚å¿µ**
æ•°æ®å¤åˆ¶å°±åƒæ˜¯æŠŠé‡è¦æ–‡ä»¶å¤å°å¤šä»½ï¼Œåˆ†åˆ«å­˜æ”¾åœ¨ä¸åŒåœ°æ–¹ï¼Œè¿™æ ·å³ä½¿ä¸€ä»½ä¸¢äº†ï¼Œå…¶ä»–åœ°æ–¹è¿˜æœ‰å¤‡ä»½ã€‚

```
åŸå§‹æ•°æ®ï¼šç”¨æˆ·ä¿¡æ¯è¡¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ID â”‚ å§“å â”‚å¹´é¾„â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1  â”‚å¼ ä¸‰ â”‚ 25 â”‚
â”‚ 2  â”‚æå›› â”‚ 30 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¤åˆ¶åï¼š
æœåŠ¡å™¨A         æœåŠ¡å™¨B         æœåŠ¡å™¨C
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ç”¨æˆ·è¡¨å‰¯æœ¬1â”‚   â”‚ç”¨æˆ·è¡¨å‰¯æœ¬2â”‚   â”‚ç”¨æˆ·è¡¨å‰¯æœ¬3â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ä¸»ä»å¤åˆ¶ï¼ˆMaster-Slaveï¼‰


**ğŸ¯ å·¥ä½œåŸç†**
å°±åƒç­çº§é‡Œæœ‰ä¸€ä¸ªç­é•¿ï¼ˆä¸»åº“ï¼‰ï¼Œå…¶ä»–åŒå­¦ï¼ˆä»åº“ï¼‰éƒ½è¦æŠ„ç­é•¿çš„ç¬”è®°ã€‚

```
å†™æ“ä½œæµç¨‹ï¼š
å®¢æˆ·ç«¯ â†’ ä¸»åº“ â†’ ä»åº“1
              â†’ ä»åº“2
              â†’ ä»åº“3

è¯»æ“ä½œæµç¨‹ï¼š
å®¢æˆ·ç«¯ â†’ ä»åº“ï¼ˆä»»æ„ä¸€ä¸ªï¼‰
```

**ğŸ’» ç®€å•ç¤ºä¾‹**
```python
class MasterSlaveDB:
    def __init__(self):
        self.master = {}  # ä¸»åº“
        self.slaves = [{}, {}, {}]  # ä»åº“åˆ—è¡¨
    
    def write(self, key, value):
        # å†™å…¥ä¸»åº“
        self.master[key] = value
        
        # åŒæ­¥åˆ°æ‰€æœ‰ä»åº“
        for slave in self.slaves:
            slave[key] = value
        
        print(f"å†™å…¥å®Œæˆ: {key} = {value}")
    
    def read(self, key):
        # ä»ä»»æ„ä»åº“è¯»å–
        slave = random.choice(self.slaves)
        return slave.get(key)
```

**âœ… ä¼˜ç‚¹**
- è¯»æ€§èƒ½å¥½ï¼šå¤šä¸ªä»åº“åˆ†æ‹…è¯»å‹åŠ›
- å®ç°ç®€å•ï¼šé€»è¾‘æ¸…æ™°æ˜“æ‡‚

**âŒ ç¼ºç‚¹**
- å†™æ€§èƒ½ç“¶é¢ˆï¼šæ‰€æœ‰å†™æ“ä½œéƒ½è¦ç»è¿‡ä¸»åº“
- å•ç‚¹æ•…éšœï¼šä¸»åº“æŒ‚æ‰å°±ä¸èƒ½å†™å…¥

### 2.3 ä¸»ä¸»å¤åˆ¶ï¼ˆMaster-Masterï¼‰


**ğŸ”¸ åŸºæœ¬ç†å¿µ**
å°±åƒä¸¤ä¸ªç­é•¿äº’ç›¸æŠ„å¯¹æ–¹çš„ç¬”è®°ï¼Œä»»ä½•ä¸€ä¸ªéƒ½å¯ä»¥è®°å½•æ–°å†…å®¹ã€‚

```
åŒä¸»æ¶æ„ï¼š
   å®¢æˆ·ç«¯A              å®¢æˆ·ç«¯B
      â†“                    â†“
   ä¸»åº“A â†â”€â”€â”€â”€â”€åŒæ­¥â”€â”€â”€â”€â†’ ä¸»åº“B
```

**âš ï¸ ä¸»è¦é—®é¢˜ï¼šå†™å…¥å†²çª**
```
å†²çªåœºæ™¯ï¼š
æ—¶é—´T1: ä¸»åº“Aå†™å…¥ ç”¨æˆ·1.å¹´é¾„ = 25
æ—¶é—´T1: ä¸»åº“Bå†™å…¥ ç”¨æˆ·1.å¹´é¾„ = 30  (åŒæ—¶å‘ç”Ÿ)

ç»“æœ: ä¸¤ä¸ªä¸»åº“çš„æ•°æ®ä¸ä¸€è‡´äº†ï¼
```

### 2.4 å¤šä¸»å¤åˆ¶ç­–ç•¥


**ğŸ›¡ï¸ å†²çªè§£å†³æ–¹æ¡ˆ**

```
1. æœ€åå†™å…¥è·èƒœ (Last Write Wins)
æ ¹æ®æ—¶é—´æˆ³ï¼Œæœ€æ–°çš„å†™å…¥è·èƒœ

2. ä¸šåŠ¡è§„åˆ™å†³å®š
æ ¹æ®å…·ä½“ä¸šåŠ¡é€»è¾‘è§£å†³å†²çª

3. åˆå¹¶ç­–ç•¥
å°†å†²çªçš„å€¼è¿›è¡Œåˆå¹¶
```

**ğŸ’» å†²çªè§£å†³ç¤ºä¾‹**
```python
def resolve_conflict(value_a, value_b, timestamp_a, timestamp_b):
    """æœ€åå†™å…¥è·èƒœç­–ç•¥"""
    if timestamp_a > timestamp_b:
        return value_a
    else:
        return value_b

# ä½¿ç”¨ç¤ºä¾‹
user_age_a = {"value": 25, "timestamp": "2024-01-01 10:00"}
user_age_b = {"value": 30, "timestamp": "2024-01-01 10:01"}

final_age = resolve_conflict(
    user_age_a["value"], user_age_b["value"],
    user_age_a["timestamp"], user_age_b["timestamp"]
)
print(f"æœ€ç»ˆå¹´é¾„: {final_age}")  # è¾“å‡º: 30
```

---

## 3. ğŸ”„ åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†


### 3.1 ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼äº‹åŠ¡


**ğŸ”¸ ç”Ÿæ´»ç±»æ¯”**
åˆ†å¸ƒå¼äº‹åŠ¡å°±åƒç½‘ä¸Šè´­ç‰©ï¼šéœ€è¦åŒæ—¶å®Œæˆæ‰£æ¬¾ï¼ˆé“¶è¡Œç³»ç»Ÿï¼‰å’Œå‡åº“å­˜ï¼ˆå•†åŸç³»ç»Ÿï¼‰ã€‚å¦‚æœä»»ä½•ä¸€æ­¥å¤±è´¥ï¼Œæ•´ä¸ªè´­ä¹°è¿‡ç¨‹éƒ½è¦æ’¤é”€ã€‚

```
å•æœºäº‹åŠ¡ï¼šåœ¨ä¸€ä¸ªæ•°æ®åº“å†…å®Œæˆ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ•°æ®åº“A       â”‚
â”‚ æ‰£æ¬¾ â†’ å‡åº“å­˜   â”‚ â† è¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å¤±è´¥
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åˆ†å¸ƒå¼äº‹åŠ¡ï¼šè·¨å¤šä¸ªç³»ç»Ÿå®Œæˆ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é“¶è¡Œç³»ç»Ÿ â”‚     â”‚ å•†åŸç³»ç»Ÿ â”‚
â”‚   æ‰£æ¬¾   â”‚ â†â†’ â”‚  å‡åº“å­˜  â”‚ â† è¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å¤±è´¥
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 ACIDç‰¹æ€§åœ¨åˆ†å¸ƒå¼ç¯å¢ƒçš„æŒ‘æˆ˜


**ğŸ“‹ ACIDå›é¡¾**
- **A**tomicityï¼ˆåŸå­æ€§ï¼‰ï¼šè¦ä¹ˆå…¨åšï¼Œè¦ä¹ˆå…¨ä¸åš
- **C**onsistencyï¼ˆä¸€è‡´æ€§ï¼‰ï¼šæ•°æ®å§‹ç»ˆæœ‰æ•ˆ
- **I**solationï¼ˆéš”ç¦»æ€§ï¼‰ï¼šäº‹åŠ¡ä¹‹é—´ä¸äº’ç›¸å¹²æ‰°
- **D**urabilityï¼ˆæŒä¹…æ€§ï¼‰ï¼šæäº¤åæ°¸ä¹…ä¿å­˜

**ğŸš¨ åˆ†å¸ƒå¼ç¯å¢ƒçš„å›°éš¾**
```
ç½‘ç»œå»¶è¿Ÿï¼šä¸åŒç³»ç»Ÿé—´é€šä¿¡éœ€è¦æ—¶é—´
ç½‘ç»œåˆ†åŒºï¼šç³»ç»Ÿé—´å¯èƒ½æš‚æ—¶æ— æ³•é€šä¿¡
ç³»ç»Ÿæ•…éšœï¼šä»»ä½•ä¸€ä¸ªç³»ç»Ÿéƒ½å¯èƒ½æŒ‚æ‰
æ€§èƒ½å½±å“ï¼šåè°ƒå¤šä¸ªç³»ç»Ÿä¼šå¾ˆæ…¢
```

### 3.3 ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰


**ğŸ¯ åŸºæœ¬æ€æƒ³**
å°±åƒç»„ç»‡èšé¤ï¼Œå…ˆé—®å¤§å®¶æœ‰æ²¡æœ‰æ—¶é—´ï¼ˆå‡†å¤‡é˜¶æ®µï¼‰ï¼Œç¡®è®¤éƒ½OKåå†ç¡®å®šæ—¶é—´åœ°ç‚¹ï¼ˆæäº¤é˜¶æ®µï¼‰ã€‚

**ğŸ“Š æ‰§è¡Œæµç¨‹**
```
é˜¶æ®µ1ï¼šå‡†å¤‡é˜¶æ®µï¼ˆPrepare Phaseï¼‰
åè°ƒè€…                    å‚ä¸è€…A         å‚ä¸è€…B
   |                        |               |
   |----"å‡†å¤‡äº‹åŠ¡A"--------->|               |
   |----"å‡†å¤‡äº‹åŠ¡B"------------------------>|
   |<---"å‡†å¤‡å°±ç»ª"----------|               |
   |<---"å‡†å¤‡å°±ç»ª"-------------------------|
   
é˜¶æ®µ2ï¼šæäº¤é˜¶æ®µï¼ˆCommit Phaseï¼‰  
   |----"æäº¤äº‹åŠ¡"---------->|               |
   |----"æäº¤äº‹åŠ¡"------------------------>|
   |<---"æäº¤å®Œæˆ"----------|               |
   |<---"æäº¤å®Œæˆ"-------------------------|
```

**ğŸ’» ä»£ç ç¤ºä¾‹**
```python
class TwoPhaseCommit:
    def __init__(self):
        self.participants = []  # å‚ä¸è€…åˆ—è¡¨
    
    def execute_transaction(self, operations):
        # é˜¶æ®µ1ï¼šå‡†å¤‡é˜¶æ®µ
        prepared = []
        for participant in self.participants:
            if participant.prepare(operations):
                prepared.append(participant)
            else:
                # æœ‰å‚ä¸è€…å‡†å¤‡å¤±è´¥ï¼Œå›æ»š
                self.abort(prepared)
                return False
        
        # é˜¶æ®µ2ï¼šæäº¤é˜¶æ®µ
        for participant in prepared:
            participant.commit()
        
        return True
    
    def abort(self, prepared_participants):
        """å›æ»šå·²å‡†å¤‡çš„å‚ä¸è€…"""
        for participant in prepared_participants:
            participant.rollback()
```

**âŒ 2PCçš„é—®é¢˜**
- **é˜»å¡é—®é¢˜**ï¼šåè°ƒè€…æŒ‚æ‰æ—¶ï¼Œæ‰€æœ‰å‚ä¸è€…éƒ½è¦ç­‰å¾…
- **å•ç‚¹æ•…éšœ**ï¼šåè°ƒè€…æ˜¯æ•´ä¸ªç³»ç»Ÿçš„ç“¶é¢ˆ
- **æ€§èƒ½è¾ƒå·®**ï¼šéœ€è¦å¤šè½®ç½‘ç»œé€šä¿¡

### 3.4 ä¸‰é˜¶æ®µæäº¤ï¼ˆ3PCï¼‰


**ğŸ”§ æ”¹è¿›æ€è·¯**
åœ¨2PCåŸºç¡€ä¸Šå¢åŠ ä¸€ä¸ª"å¯ä»¥æäº¤"é˜¶æ®µï¼Œå‡å°‘é˜»å¡æ—¶é—´ã€‚

```
é˜¶æ®µ1ï¼šå‡†å¤‡é˜¶æ®µ     â†’ è¯¢é—®èƒ½å¦æ‰§è¡Œ
é˜¶æ®µ2ï¼šé¢„æäº¤é˜¶æ®µ   â†’ ç¡®è®¤å¯ä»¥æ‰§è¡Œ  
é˜¶æ®µ3ï¼šæ­£å¼æäº¤é˜¶æ®µ â†’ çœŸæ­£æ‰§è¡Œ
```

---

## 4. âš–ï¸ æœ€ç»ˆä¸€è‡´æ€§è®¾è®¡


### 4.1 ä»€ä¹ˆæ˜¯æœ€ç»ˆä¸€è‡´æ€§


**ğŸ”¸ é€šä¿—ç†è§£**
æœ€ç»ˆä¸€è‡´æ€§å°±åƒæœ‹å‹åœˆçš„ç‚¹èµæ•°ï¼Œä½ ç‚¹èµåå¯èƒ½ä¸ä¼šç«‹å³æ˜¾ç¤ºï¼Œä½†è¿‡ä¸€ä¼šå„¿è‚¯å®šä¼šæ›´æ–°åˆ°æ­£ç¡®çš„æ•°å­—ã€‚

```
å¼ºä¸€è‡´æ€§ï¼š
ç”¨æˆ·Aç‚¹èµ â†’ ç«‹å³æ‰€æœ‰äººéƒ½çœ‹åˆ°ç‚¹èµæ•°+1

æœ€ç»ˆä¸€è‡´æ€§ï¼š
ç”¨æˆ·Aç‚¹èµ â†’ æš‚æ—¶å¯èƒ½çœ‹åˆ°æ—§çš„ç‚¹èµæ•° â†’ è¿‡ä¸€ä¼šå„¿æ›´æ–°ä¸ºæ­£ç¡®æ•°å­—
```

### 4.2 BASEç†è®º


**ğŸ“‹ BASE vs ACID**
- **BA**sically Availableï¼ˆåŸºæœ¬å¯ç”¨ï¼‰ï¼šç³»ç»Ÿå¤§éƒ¨åˆ†æ—¶é—´æ˜¯å¯ç”¨çš„
- **S**oft stateï¼ˆè½¯çŠ¶æ€ï¼‰ï¼šå…è®¸ç³»ç»Ÿå­˜åœ¨ä¸­é—´çŠ¶æ€
- **E**ventual consistencyï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰ï¼šæœ€ç»ˆä¼šè¾¾åˆ°ä¸€è‡´çŠ¶æ€

```
ACIDé€‚åˆï¼šé“¶è¡Œè½¬è´¦ï¼ˆå¿…é¡»å¼ºä¸€è‡´ï¼‰
BASEé€‚åˆï¼šç¤¾äº¤ç½‘ç»œï¼ˆå¯ä»¥æœ€ç»ˆä¸€è‡´ï¼‰
```

### 4.3 æœ€ç»ˆä¸€è‡´æ€§çš„å®ç°æ–¹å¼


**ğŸ”„ å¼‚æ­¥å¤åˆ¶**
```python
class EventualConsistency:
    def __init__(self):
        self.primary_db = {}
        self.replica_dbs = [{}, {}, {}]
        self.pending_updates = []  # å¾…åŒæ­¥çš„æ›´æ–°
    
    def write(self, key, value):
        # ç«‹å³å†™å…¥ä¸»åº“
        self.primary_db[key] = value
        
        # å¼‚æ­¥åŒæ­¥åˆ°å‰¯æœ¬åº“
        self.pending_updates.append({"key": key, "value": value})
        self.async_sync()
        
        return True  # ç«‹å³è¿”å›æˆåŠŸ
    
    def async_sync(self):
        """å¼‚æ­¥åŒæ­¥åˆ°å‰¯æœ¬åº“"""
        while self.pending_updates:
            update = self.pending_updates.pop(0)
            for replica in self.replica_dbs:
                try:
                    replica[update["key"]] = update["value"]
                except Exception:
                    # åŒæ­¥å¤±è´¥ï¼Œç¨åé‡è¯•
                    self.pending_updates.append(update)
                    break
```

**â° æ—¶é—´çª—å£è®¾è®¡**
```
è®¾è®¡åŸåˆ™ï¼š
- 99%çš„æƒ…å†µä¸‹ï¼Œ1ç§’å†…è¾¾åˆ°ä¸€è‡´
- 99.9%çš„æƒ…å†µä¸‹ï¼Œ10ç§’å†…è¾¾åˆ°ä¸€è‡´
- 100%çš„æƒ…å†µä¸‹ï¼Œ1åˆ†é’Ÿå†…è¾¾åˆ°ä¸€è‡´
```

---

## 5. âš”ï¸ å†²çªè§£å†³ç­–ç•¥


### 5.1 å†²çªäº§ç”Ÿçš„åŸå› 


**ğŸ”¸ å…¸å‹å†²çªåœºæ™¯**
```
åœºæ™¯1ï¼šå¹¶å‘å†™å…¥
ç”¨æˆ·A: ä¿®æ”¹å•†å“ä»·æ ¼ 100 â†’ 90
ç”¨æˆ·B: ä¿®æ”¹å•†å“ä»·æ ¼ 100 â†’ 80
åŒæ—¶å‘ç”Ÿï¼Œå“ªä¸ªç”Ÿæ•ˆï¼Ÿ

åœºæ™¯2ï¼šç½‘ç»œåˆ†åŒº
åŒ—äº¬æœºæˆ¿: åº“å­˜ 50 â†’ 45 ï¼ˆå–å‡º5ä¸ªï¼‰
ä¸Šæµ·æœºæˆ¿: åº“å­˜ 50 â†’ 40 ï¼ˆå–å‡º10ä¸ªï¼‰
ç½‘ç»œæ¢å¤åï¼Œåº“å­˜åº”è¯¥æ˜¯å¤šå°‘ï¼Ÿ
```

### 5.2 åŸºäºæ—¶é—´æˆ³çš„è§£å†³


**â° æœ€åå†™å…¥è·èƒœï¼ˆLWWï¼‰**
```python
class TimestampConflictResolver:
    def resolve(self, value_a, timestamp_a, value_b, timestamp_b):
        """åŸºäºæ—¶é—´æˆ³è§£å†³å†²çª"""
        if timestamp_a > timestamp_b:
            return value_a
        elif timestamp_b > timestamp_a:
            return value_b
        else:
            # æ—¶é—´æˆ³ç›¸åŒï¼Œä½¿ç”¨å…¶ä»–è§„åˆ™ï¼ˆå¦‚æœºå™¨IDï¼‰
            return self.tie_breaker(value_a, value_b)
    
    def tie_breaker(self, value_a, value_b):
        """æ—¶é—´æˆ³ç›¸åŒæ—¶çš„å†³èƒœè§„åˆ™"""
        # å¯ä»¥ä½¿ç”¨æœºå™¨IDã€å“ˆå¸Œå€¼ç­‰
        return value_a if hash(str(value_a)) > hash(str(value_b)) else value_b
```

### 5.3 åŸºäºä¸šåŠ¡è§„åˆ™çš„è§£å†³


**ğŸ¯ ä¸šåŠ¡ä¼˜å…ˆçº§**
```python
class BusinessRuleResolver:
    def resolve_price_conflict(self, price_a, price_b):
        """ä»·æ ¼å†²çªï¼šé€‰æ‹©æ›´ä½çš„ä»·æ ¼ï¼ˆå¯¹ç”¨æˆ·å‹å¥½ï¼‰"""
        return min(price_a, price_b)
    
    def resolve_inventory_conflict(self, inventory_a, inventory_b):
        """åº“å­˜å†²çªï¼šé€‰æ‹©æ›´ä¿å®ˆçš„æ•°å­—ï¼ˆé¿å…è¶…å–ï¼‰"""
        return min(inventory_a, inventory_b)
    
    def resolve_user_profile_conflict(self, profile_a, profile_b):
        """ç”¨æˆ·èµ„æ–™å†²çªï¼šåˆå¹¶éç©ºå­—æ®µ"""
        merged = {}
        for key in set(profile_a.keys()) | set(profile_b.keys()):
            value_a = profile_a.get(key)
            value_b = profile_b.get(key)
            
            if value_a and value_b:
                # éƒ½æœ‰å€¼ï¼Œé€‰æ‹©æœ€æ–°çš„
                merged[key] = max(value_a, value_b, key=lambda x: x.get('timestamp', 0))
            else:
                # é€‰æ‹©éç©ºçš„å€¼
                merged[key] = value_a or value_b
        
        return merged
```

### 5.4 å‘é‡æ—¶é’Ÿï¼ˆVector Clockï¼‰


**ğŸ”¸ åŸºæœ¬æ¦‚å¿µ**
å‘é‡æ—¶é’Ÿå°±åƒç»™æ¯ä¸ªå‚ä¸è€…å‘ä¸€ä¸ªè®¡æ•°å™¨ï¼Œè®°å½•å„è‡ªçš„æ“ä½œæ¬¡æ•°ï¼Œç”¨æ¥åˆ¤æ–­äº‹ä»¶çš„å…ˆåå…³ç³»ã€‚

```
å‘é‡æ—¶é’Ÿç¤ºä¾‹ï¼š
èŠ‚ç‚¹A: [A:1, B:0, C:0]  # Aæ“ä½œäº†1æ¬¡
èŠ‚ç‚¹B: [A:1, B:1, C:0]  # Bçœ‹åˆ°Açš„1æ¬¡æ“ä½œï¼Œè‡ªå·±æ“ä½œäº†1æ¬¡
èŠ‚ç‚¹C: [A:1, B:1, C:1]  # Cçœ‹åˆ°Aå’ŒBå„1æ¬¡æ“ä½œï¼Œè‡ªå·±æ“ä½œäº†1æ¬¡
```

**ğŸ’» ç®€å•å®ç°**
```python
class VectorClock:
    def __init__(self, node_id, nodes):
        self.node_id = node_id
        self.clock = {node: 0 for node in nodes}
    
    def tick(self):
        """æœ¬åœ°æ“ä½œï¼Œæ—¶é’Ÿ+1"""
        self.clock[self.node_id] += 1
    
    def update(self, other_clock):
        """æ”¶åˆ°å…¶ä»–èŠ‚ç‚¹æ¶ˆæ¯ï¼Œæ›´æ–°æ—¶é’Ÿ"""
        for node in self.clock:
            self.clock[node] = max(self.clock[node], other_clock.get(node, 0))
        self.tick()  # ç„¶åæœ¬åœ°æ—¶é’Ÿ+1
    
    def compare(self, other_clock):
        """æ¯”è¾ƒä¸¤ä¸ªå‘é‡æ—¶é’Ÿçš„å…³ç³»"""
        self_greater = all(self.clock[k] >= other_clock.get(k, 0) for k in self.clock)
        other_greater = all(other_clock.get(k, 0) >= self.clock[k] for k in self.clock)
        
        if self_greater and not other_greater:
            return "after"
        elif other_greater and not self_greater:
            return "before"
        else:
            return "concurrent"  # å¹¶å‘äº‹ä»¶
```

---

## 6. ğŸ”„ æ•°æ®åŒæ­¥æœºåˆ¶


### 6.1 æ¨é€ vs æ‹‰å–æ¨¡å¼


**ğŸ“¤ æ¨é€æ¨¡å¼ï¼ˆPushï¼‰**
å°±åƒå¾®ä¿¡ç¾¤èŠï¼Œæœ‰äººå‘æ¶ˆæ¯åä¸»åŠ¨æ¨é€ç»™æ‰€æœ‰æˆå‘˜ã€‚

```python
class PushSync:
    def __init__(self):
        self.subscribers = []  # è®¢é˜…è€…åˆ—è¡¨
    
    def add_subscriber(self, subscriber):
        self.subscribers.append(subscriber)
    
    def update_data(self, key, value):
        # æ›´æ–°æœ¬åœ°æ•°æ®
        self.local_data[key] = value
        
        # ä¸»åŠ¨æ¨é€ç»™æ‰€æœ‰è®¢é˜…è€…
        for subscriber in self.subscribers:
            try:
                subscriber.receive_update(key, value)
            except Exception as e:
                print(f"æ¨é€å¤±è´¥: {e}")
```

**ğŸ“¥ æ‹‰å–æ¨¡å¼ï¼ˆPullï¼‰**
å°±åƒæŸ¥çœ‹é‚®ç®±ï¼Œéœ€è¦ä¸»åŠ¨å»æ£€æŸ¥æ˜¯å¦æœ‰æ–°é‚®ä»¶ã€‚

```python
class PullSync:
    def __init__(self):
        self.version = 0  # æ•°æ®ç‰ˆæœ¬å·
        self.data = {}
    
    def get_updates_since(self, last_version):
        """è·å–æŒ‡å®šç‰ˆæœ¬ä¹‹åçš„æ›´æ–°"""
        if last_version < self.version:
            return {
                "version": self.version,
                "data": self.data,
                "has_updates": True
            }
        return {"has_updates": False}
    
    def poll_for_updates(self, source, last_version):
        """å®šæœŸæ‹‰å–æ›´æ–°"""
        updates = source.get_updates_since(last_version)
        if updates["has_updates"]:
            self.apply_updates(updates["data"])
            return updates["version"]
        return last_version
```

### 6.2 å¢é‡åŒæ­¥ vs å…¨é‡åŒæ­¥


**ğŸ”„ å¢é‡åŒæ­¥**
åªåŒæ­¥å˜åŒ–çš„éƒ¨åˆ†ï¼Œå°±åƒåªå‘é€æ–‡ä»¶çš„ä¿®æ”¹éƒ¨åˆ†ã€‚

```python
class IncrementalSync:
    def __init__(self):
        self.change_log = []  # å˜æ›´æ—¥å¿—
    
    def record_change(self, operation, key, value):
        """è®°å½•æ•°æ®å˜æ›´"""
        change = {
            "timestamp": time.time(),
            "operation": operation,  # INSERT, UPDATE, DELETE
            "key": key,
            "value": value
        }
        self.change_log.append(change)
    
    def get_changes_since(self, timestamp):
        """è·å–æŒ‡å®šæ—¶é—´ä¹‹åçš„å˜æ›´"""
        return [change for change in self.change_log 
                if change["timestamp"] > timestamp]
    
    def apply_changes(self, changes):
        """åº”ç”¨å˜æ›´åˆ°æœ¬åœ°æ•°æ®"""
        for change in changes:
            if change["operation"] == "INSERT":
                self.data[change["key"]] = change["value"]
            elif change["operation"] == "UPDATE":
                self.data[change["key"]] = change["value"]
            elif change["operation"] == "DELETE":
                del self.data[change["key"]]
```

**ğŸ“¦ å…¨é‡åŒæ­¥**
ä¼ è¾“æ‰€æœ‰æ•°æ®ï¼Œç¡®ä¿å®Œå…¨ä¸€è‡´ã€‚

```python
class FullSync:
    def full_sync(self, target):
        """å…¨é‡åŒæ­¥åˆ°ç›®æ ‡èŠ‚ç‚¹"""
        # ç”Ÿæˆæœ¬åœ°æ•°æ®å¿«ç…§
        snapshot = self.create_snapshot()
        
        # ä¼ è¾“åˆ°ç›®æ ‡èŠ‚ç‚¹
        target.replace_all_data(snapshot)
    
    def create_snapshot(self):
        """åˆ›å»ºæ•°æ®å¿«ç…§"""
        return {
            "timestamp": time.time(),
            "data": dict(self.data),  # å¤åˆ¶æ‰€æœ‰æ•°æ®
            "checksum": self.calculate_checksum()
        }
    
    def replace_all_data(self, snapshot):
        """ç”¨å¿«ç…§æ›¿æ¢æ‰€æœ‰æœ¬åœ°æ•°æ®"""
        if self.verify_checksum(snapshot):
            self.data = snapshot["data"]
            return True
        return False
```

### 6.3 å¿ƒè·³æ£€æµ‹æœºåˆ¶


**ğŸ’“ ä¿æŒè¿æ¥æ´»è·ƒ**
```python
class HeartbeatMonitor:
    def __init__(self, interval=30):
        self.interval = interval  # å¿ƒè·³é—´éš”ï¼ˆç§’ï¼‰
        self.last_heartbeat = {}  # è®°å½•å„èŠ‚ç‚¹æœ€åå¿ƒè·³æ—¶é—´
    
    def send_heartbeat(self, target_node):
        """å‘é€å¿ƒè·³"""
        message = {
            "type": "heartbeat",
            "timestamp": time.time(),
            "node_id": self.node_id
        }
        target_node.receive_heartbeat(message)
    
    def receive_heartbeat(self, message):
        """æ¥æ”¶å¿ƒè·³"""
        node_id = message["node_id"]
        self.last_heartbeat[node_id] = message["timestamp"]
    
    def check_node_health(self, node_id, timeout=90):
        """æ£€æŸ¥èŠ‚ç‚¹å¥åº·çŠ¶æ€"""
        last_time = self.last_heartbeat.get(node_id, 0)
        current_time = time.time()
        
        if current_time - last_time > timeout:
            return "unhealthy"
        return "healthy"
```

### 6.4 æ•°æ®æ ¡éªŒæœºåˆ¶


**ğŸ” ç¡®ä¿æ•°æ®æ­£ç¡®æ€§**
```python
import hashlib

class DataValidator:
    def calculate_checksum(self, data):
        """è®¡ç®—æ•°æ®æ ¡éªŒå’Œ"""
        data_str = str(sorted(data.items()))
        return hashlib.md5(data_str.encode()).hexdigest()
    
    def compare_data_integrity(self, local_data, remote_data):
        """æ¯”è¾ƒæ•°æ®å®Œæ•´æ€§"""
        local_checksum = self.calculate_checksum(local_data)
        remote_checksum = self.calculate_checksum(remote_data)
        
        return {
            "is_consistent": local_checksum == remote_checksum,
            "local_checksum": local_checksum,
            "remote_checksum": remote_checksum
        }
    
    def repair_inconsistency(self, local_data, remote_data):
        """ä¿®å¤æ•°æ®ä¸ä¸€è‡´"""
        differences = []
        all_keys = set(local_data.keys()) | set(remote_data.keys())
        
        for key in all_keys:
            local_value = local_data.get(key)
            remote_value = remote_data.get(key)
            
            if local_value != remote_value:
                differences.append({
                    "key": key,
                    "local_value": local_value,
                    "remote_value": remote_value
                })
        
        return differences
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ åˆ†å¸ƒå¼æ•°æ®æœ¬è´¨ï¼šå°†æ•°æ®åˆ†æ•£å­˜å‚¨åœ¨å¤šå°æœºå™¨ä¸Š
ğŸ”¸ CAPå®šç†ï¼šä¸€è‡´æ€§ã€å¯ç”¨æ€§ã€åˆ†åŒºå®¹é”™æ€§ä¸å¯å…¼å¾—
ğŸ”¸ æ•°æ®å¤åˆ¶ï¼šä¸»ä»å¤åˆ¶ã€ä¸»ä¸»å¤åˆ¶çš„ä¼˜ç¼ºç‚¹
ğŸ”¸ åˆ†å¸ƒå¼äº‹åŠ¡ï¼š2PCã€3PCçš„å·¥ä½œåŸç†å’Œé—®é¢˜
ğŸ”¸ æœ€ç»ˆä¸€è‡´æ€§ï¼šBASEç†è®ºï¼Œå¼‚æ­¥è¾¾åˆ°ä¸€è‡´çŠ¶æ€
ğŸ”¸ å†²çªè§£å†³ï¼šæ—¶é—´æˆ³ã€ä¸šåŠ¡è§„åˆ™ã€å‘é‡æ—¶é’Ÿ
ğŸ”¸ æ•°æ®åŒæ­¥ï¼šæ¨æ‹‰æ¨¡å¼ã€å¢é‡å…¨é‡ã€å¿ƒè·³æ£€æµ‹
```

### 7.2 å…³é”®è®¾è®¡æ€è·¯


**ğŸ”¹ ä¸€è‡´æ€§çº§åˆ«çš„é€‰æ‹©**
```
å¼ºä¸€è‡´æ€§ï¼š
- é€‚ç”¨åœºæ™¯ï¼šé‡‘èäº¤æ˜“ã€è´¦æˆ·ä½™é¢
- ä»£ä»·ï¼šæ€§èƒ½è¾ƒä½ï¼Œå¯ç”¨æ€§å—é™

æœ€ç»ˆä¸€è‡´æ€§ï¼š
- é€‚ç”¨åœºæ™¯ï¼šç¤¾äº¤ç½‘ç»œã€å†…å®¹æ¨è
- ä¼˜åŠ¿ï¼šé«˜æ€§èƒ½ï¼Œé«˜å¯ç”¨æ€§
```

**ğŸ”¹ å¤åˆ¶ç­–ç•¥çš„æƒè¡¡**
```
ä¸»ä»å¤åˆ¶ï¼š
âœ… è¯»æ€§èƒ½å¥½ï¼Œå®ç°ç®€å•
âŒ å†™æ€§èƒ½ç“¶é¢ˆï¼Œå•ç‚¹æ•…éšœ

ä¸»ä¸»å¤åˆ¶ï¼š
âœ… å†™æ€§èƒ½å¥½ï¼Œæ— å•ç‚¹æ•…éšœ  
âŒ å†²çªå¤„ç†å¤æ‚
```

**ğŸ”¹ åŒæ­¥æœºåˆ¶çš„é€‰æ‹©**
```
æ¨é€æ¨¡å¼ï¼š
âœ… å®æ—¶æ€§å¥½ï¼Œå»¶è¿Ÿä½
âŒ ç½‘ç»œå¼€é”€å¤§ï¼Œå¯èƒ½æ¨é€å¤±è´¥

æ‹‰å–æ¨¡å¼ï¼š
âœ… å¯é æ€§å¥½ï¼Œå®¹é”™æ€§å¼º
âŒ å®æ—¶æ€§å·®ï¼Œéœ€è¦è½®è¯¢
```

### 7.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ è®¾è®¡åŸåˆ™**
- **ä¸šåŠ¡ä¼˜å…ˆ**ï¼šæ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹é€‰æ‹©ä¸€è‡´æ€§çº§åˆ«
- **æ¸è¿›å¼**ï¼šä»ç®€å•æ–¹æ¡ˆå¼€å§‹ï¼Œé€æ­¥ä¼˜åŒ–
- **å¯è§‚æµ‹**ï¼šæ·»åŠ ç›‘æ§å’ŒæŠ¥è­¦æœºåˆ¶
- **å®¹é”™æ€§**ï¼šè€ƒè™‘å„ç§æ•…éšœåœºæ™¯

**ğŸ› ï¸ æœ€ä½³å®è·µ**
- **æ•°æ®åˆ†ç‰‡**ï¼šåˆç†åˆ†å¸ƒæ•°æ®ï¼Œé¿å…çƒ­ç‚¹
- **ç¼“å­˜ç­–ç•¥**ï¼šå‡å°‘è·¨ç½‘ç»œçš„æ•°æ®è®¿é—®
- **å¼‚æ­¥å¤„ç†**ï¼šæé«˜ç³»ç»Ÿå“åº”é€Ÿåº¦
- **å®šæœŸæ ¡éªŒ**ï¼šç¡®ä¿æ•°æ®ä¸€è‡´æ€§

**ğŸ“Š æ€§èƒ½ä¼˜åŒ–**
- **å°±è¿‘è®¿é—®**ï¼šæ•°æ®æ”¾åœ¨ç¦»ç”¨æˆ·è¿‘çš„åœ°æ–¹
- **æ‰¹é‡æ“ä½œ**ï¼šå‡å°‘ç½‘ç»œäº¤äº’æ¬¡æ•°
- **å‹ç¼©ä¼ è¾“**ï¼šå‡å°‘ç½‘ç»œå¸¦å®½æ¶ˆè€—
- **æ™ºèƒ½è·¯ç”±**ï¼šé€‰æ‹©æœ€ä¼˜çš„æ•°æ®å‰¯æœ¬

**æ ¸å¿ƒè®°å¿†**ï¼š
- åˆ†å¸ƒå¼æ•°æ®è¿½æ±‚çš„æ˜¯å¯ç”¨æ€§å’Œæ‰©å±•æ€§
- ä¸€è‡´æ€§æ˜¯æœ‰ä»£ä»·çš„ï¼Œéœ€è¦æ ¹æ®ä¸šåŠ¡æƒè¡¡
- å†²çªä¸å¯é¿å…ï¼Œå…³é”®æ˜¯å¦‚ä½•ä¼˜é›…åœ°è§£å†³
- ç›‘æ§å’Œè¿ç»´æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„ç”Ÿå‘½çº¿