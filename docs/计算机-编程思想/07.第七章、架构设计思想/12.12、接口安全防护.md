---
title: 12ã€æ¥å£å®‰å…¨é˜²æŠ¤
---
## ğŸ“š ç›®å½•

1. [æ¥å£å®‰å…¨åŸºç¡€è®¤çŸ¥](#1-æ¥å£å®‰å…¨åŸºç¡€è®¤çŸ¥)
2. [å‚æ•°æ ¡éªŒç­–ç•¥](#2-å‚æ•°æ ¡éªŒç­–ç•¥)
3. [æƒé™æ§åˆ¶è®¾è®¡](#3-æƒé™æ§åˆ¶è®¾è®¡)
4. [é˜²æ”»å‡»æœºåˆ¶](#4-é˜²æ”»å‡»æœºåˆ¶)
5. [æ¥å£é™æµä¿æŠ¤](#5-æ¥å£é™æµä¿æŠ¤)
6. [é˜²å¾¡æ€§ç¼–ç¨‹](#6-é˜²å¾¡æ€§ç¼–ç¨‹)
7. [å®‰å…¨æ„è¯†ä¸ç³»ç»Ÿè®¾è®¡](#7-å®‰å…¨æ„è¯†ä¸ç³»ç»Ÿè®¾è®¡)
8. [æ¶æ„è®¾è®¡æ¨¡å¼åº”ç”¨](#8-æ¶æ„è®¾è®¡æ¨¡å¼åº”ç”¨)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ›¡ï¸ æ¥å£å®‰å…¨åŸºç¡€è®¤çŸ¥


### 1.1 ä»€ä¹ˆæ˜¯æ¥å£å®‰å…¨é˜²æŠ¤


**é€šä¿—ç†è§£**ï¼šæ¥å£å®‰å…¨é˜²æŠ¤å°±åƒç»™ä½ å®¶çš„é—¨å®‰è£…å¤šé“é”

```
ç°å®ä¸­çš„å®‰å…¨é˜²æŠ¤ï¼š           æ¥å£å®‰å…¨é˜²æŠ¤ï¼š
é—¨ç¦å¡éªŒè¯èº«ä»½    â†â†’    æƒé™æ§åˆ¶éªŒè¯
å®‰ä¿æ£€æŸ¥åŒ…è£¹      â†â†’    å‚æ•°æ ¡éªŒè¿‡æ»¤
ç›‘æ§å¼‚å¸¸è¡Œä¸º      â†â†’    é˜²æ”»å‡»æ£€æµ‹
æ§åˆ¶è®¿é—®é¢‘ç‡      â†â†’    æ¥å£é™æµ
```

**ğŸ’¡ æ ¸å¿ƒæ€æƒ³**
> æ°¸è¿œä¸è¦ç›¸ä¿¡å¤–éƒ¨è¾“å…¥ï¼Œä»»ä½•æ¥è‡ªå¤–éƒ¨çš„æ•°æ®éƒ½å¯èƒ½æ˜¯æ¶æ„çš„

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦æ¥å£å®‰å…¨


**ğŸš¨ å¸¸è§å®‰å…¨å¨èƒ**
```
SQLæ³¨å…¥æ”»å‡»ï¼š
æ¶æ„è¾“å…¥: '; DROP TABLE users; --
å¦‚æœä¸æ ¡éªŒ: ç›´æ¥æ‰§è¡Œï¼Œæ•°æ®åº“è¢«åˆ é™¤

XSSæ”»å‡»ï¼š
æ¶æ„è¾“å…¥: <script>alert('hack')</script>
å¦‚æœä¸è¿‡æ»¤: åœ¨é¡µé¢æ‰§è¡Œæ¶æ„è„šæœ¬

é‡æ”¾æ”»å‡»ï¼š
é»‘å®¢æˆªè·: ç”¨æˆ·çš„æ”¯ä»˜è¯·æ±‚
é‡å¤å‘é€: å¯¼è‡´é‡å¤æ‰£æ¬¾
```

### 1.3 å®‰å…¨é˜²æŠ¤çš„å±‚æ¬¡æ¨¡å‹


```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         åº”ç”¨å±‚å®‰å…¨               â”‚ â† ä¸šåŠ¡é€»è¾‘éªŒè¯
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         æ¥å£å±‚å®‰å…¨               â”‚ â† å‚æ•°æ ¡éªŒã€æƒé™æ§åˆ¶
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         ç½‘ç»œå±‚å®‰å…¨               â”‚ â† HTTPSã€é˜²ç«å¢™
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         ç³»ç»Ÿå±‚å®‰å…¨               â”‚ â† æ“ä½œç³»ç»Ÿã€æœåŠ¡å™¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. âœ… å‚æ•°æ ¡éªŒç­–ç•¥


### 2.1 å‚æ•°æ ¡éªŒçš„é‡è¦æ€§


**ğŸ¯ æ ¸å¿ƒåŸåˆ™**ï¼šæ‰€æœ‰è¾“å…¥å‚æ•°å¿…é¡»æ ¡éªŒ

> ğŸ’¡ **å®‰å…¨é‡‘å¾‹**ï¼šNever trust user inputï¼ˆæ°¸è¿œä¸è¦ç›¸ä¿¡ç”¨æˆ·è¾“å…¥ï¼‰

### 2.2 æ ¡éªŒç­–ç•¥åˆ†å±‚


**ğŸ“‹ ä¸‰å±‚æ ¡éªŒä½“ç³»**
```
â”Œâ”€ å‰ç«¯æ ¡éªŒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä½œç”¨: ç”¨æˆ·ä½“éªŒä¼˜åŒ–              â”‚
â”‚ ç‰¹ç‚¹: å¯è¢«ç»•è¿‡ï¼Œä¸èƒ½ä½œä¸ºå®‰å…¨ä¿éšœ  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€ åç«¯æ ¡éªŒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä½œç”¨: çœŸæ­£çš„å®‰å…¨é˜²çº¿            â”‚
â”‚ ç‰¹ç‚¹: å¿…é¡»å®Œæ•´ä¸¥æ ¼ï¼Œä¸èƒ½çœç•¥    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€ æ•°æ®åº“çº¦æŸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä½œç”¨: æœ€åä¸€é“é˜²çº¿              â”‚
â”‚ ç‰¹ç‚¹: æ•°æ®å®Œæ•´æ€§ä¿éšœ            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 å‚æ•°æ ¡éªŒçš„å…·ä½“å®ç°


**ğŸ” åŸºç¡€æ ¡éªŒç±»å‹**

```java
// ç”¨æˆ·æ³¨å†Œæ¥å£çš„å‚æ•°æ ¡éªŒç¤ºä¾‹
public class UserRegistrationValidator {
    
    public ValidationResult validate(UserInfo user) {
        ValidationResult result = new ValidationResult();
        
        // 1. å¿…å¡«æ ¡éªŒ
        if (isEmpty(user.getUsername())) {
            result.addError("ç”¨æˆ·åä¸èƒ½ä¸ºç©º");
        }
        
        // 2. æ ¼å¼æ ¡éªŒ
        if (!isValidEmail(user.getEmail())) {
            result.addError("é‚®ç®±æ ¼å¼ä¸æ­£ç¡®");
        }
        
        // 3. é•¿åº¦æ ¡éªŒ
        if (user.getPassword().length() < 8) {
            result.addError("å¯†ç é•¿åº¦ä¸èƒ½å°‘äº8ä½");
        }
        
        // 4. ç‰¹æ®Šå­—ç¬¦æ ¡éªŒï¼ˆé˜²SQLæ³¨å…¥ï¼‰
        if (containsSqlKeywords(user.getUsername())) {
            result.addError("ç”¨æˆ·ååŒ…å«éæ³•å­—ç¬¦");
        }
        
        return result;
    }
    
    // æ£€æŸ¥æ˜¯å¦åŒ…å«SQLå…³é”®å­—
    private boolean containsSqlKeywords(String input) {
        String[] sqlKeywords = {"SELECT", "DROP", "DELETE", "INSERT", "UPDATE"};
        String upperInput = input.toUpperCase();
        for (String keyword : sqlKeywords) {
            if (upperInput.contains(keyword)) {
                return true;
            }
        }
        return false;
    }
}
```

**ğŸ“ æ ¡éªŒè§„åˆ™è®¾è®¡**

| æ ¡éªŒç±»å‹ | **è¯´æ˜** | **ç¤ºä¾‹** |
|---------|---------|---------|
| `å¿…å¡«æ ¡éªŒ` | å…³é”®å­—æ®µä¸èƒ½ä¸ºç©º | ç”¨æˆ·åã€å¯†ç ã€æ‰‹æœºå· |
| `æ ¼å¼æ ¡éªŒ` | ç¬¦åˆç‰¹å®šæ ¼å¼è¦æ±‚ | é‚®ç®±ã€èº«ä»½è¯ã€é“¶è¡Œå¡å· |
| `é•¿åº¦æ ¡éªŒ` | æ§åˆ¶è¾“å…¥é•¿åº¦èŒƒå›´ | å¯†ç 8-20ä½ï¼Œæ˜µç§°2-10ä½ |
| `èŒƒå›´æ ¡éªŒ` | æ•°å€¼åœ¨åˆç†èŒƒå›´å†… | å¹´é¾„1-120ï¼Œé‡‘é¢>0 |
| `ç™½åå•æ ¡éªŒ` | åªå…è®¸é¢„å®šä¹‰çš„å€¼ | æ€§åˆ«åªèƒ½æ˜¯ç”·/å¥³ |

### 2.4 é˜²æ³¨å…¥æ”»å‡»çš„å‚æ•°å¤„ç†


**ğŸ›¡ï¸ SQLæ³¨å…¥é˜²æŠ¤**

```java
// âŒ é”™è¯¯åšæ³•ï¼šç›´æ¥æ‹¼æ¥SQL
public User getUserByName(String username) {
    String sql = "SELECT * FROM users WHERE username = '" + username + "'";
    // å¦‚æœusername = "admin'; DROP TABLE users; --"
    // å®é™…æ‰§è¡Œ: SELECT * FROM users WHERE username = 'admin'; DROP TABLE users; --'
    return jdbcTemplate.query(sql);
}

// âœ… æ­£ç¡®åšæ³•ï¼šä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
public User getUserByName(String username) {
    String sql = "SELECT * FROM users WHERE username = ?";
    return jdbcTemplate.queryForObject(sql, new Object[]{username}, UserMapper.class);
}
```

**ğŸ”’ XSSæ”»å‡»é˜²æŠ¤**

```java
// HTMLç‰¹æ®Šå­—ç¬¦è½¬ä¹‰
public String escapeHtml(String input) {
    if (input == null) return null;
    
    return input.replace("&", "&amp;")
                .replace("<", "&lt;")
                .replace(">", "&gt;")
                .replace("\"", "&quot;")
                .replace("'", "&#x27;");
}

// ä½¿ç”¨ç¤ºä¾‹
String userInput = "<script>alert('xss')</script>";
String safeOutput = escapeHtml(userInput);
// ç»“æœ: &lt;script&gt;alert(&#x27;xss&#x27;)&lt;/script&gt;
```

---

## 3. ğŸ” æƒé™æ§åˆ¶è®¾è®¡


### 3.1 æƒé™æ§åˆ¶çš„åŸºæœ¬æ¦‚å¿µ


**ğŸ¯ ä»€ä¹ˆæ˜¯æƒé™æ§åˆ¶**

æƒé™æ§åˆ¶å°±åƒå…¬å¸çš„é—¨ç¦ç³»ç»Ÿï¼š
- **èº«ä»½è®¤è¯**ï¼šä½ æ˜¯è°ï¼Ÿï¼ˆåˆ·å·¥å¡ï¼‰
- **æƒé™æˆæƒ**ï¼šä½ èƒ½åšä»€ä¹ˆï¼Ÿï¼ˆè¿›å“ªäº›æˆ¿é—´ï¼‰
- **æƒé™æ ¡éªŒ**ï¼šæ¯æ¬¡éƒ½è¦æ£€æŸ¥ï¼ˆæ¯ä¸ªé—¨éƒ½è¦åˆ·å¡ï¼‰

### 3.2 æƒé™æ§åˆ¶æ¨¡å‹


**ğŸ“Š RBACæƒé™æ¨¡å‹**
```
ç”¨æˆ·(User) â†â†’ è§’è‰²(Role) â†â†’ æƒé™(Permission)

ç¤ºä¾‹ï¼š
å¼ ä¸‰ â†’ è´¢åŠ¡ç»ç† â†’ {æŸ¥çœ‹è´¢åŠ¡æŠ¥è¡¨, å®¡æ‰¹æŠ¥é”€, å¯¼å‡ºæ•°æ®}
æå›› â†’ æ™®é€šå‘˜å·¥ â†’ {æŸ¥çœ‹ä¸ªäººå·¥èµ„, æäº¤æŠ¥é”€ç”³è¯·}
```

**ğŸ”— æƒé™å…³ç³»å›¾**
```
        ç”¨æˆ·
         â”‚
    â”Œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”
    â”‚    â”‚    â”‚
  è§’è‰²1 è§’è‰²2 è§’è‰²3
    â”‚    â”‚    â”‚
    â””â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”˜
         â”‚
       æƒé™é›†åˆ
```

### 3.3 æƒé™æ ¡éªŒçš„å®ç°æ–¹å¼


**ğŸ› ï¸ åŸºäºæ³¨è§£çš„æƒé™æ§åˆ¶**

```java
// æƒé™æ³¨è§£å®šä¹‰
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface RequiresPermission {
    String value(); // éœ€è¦çš„æƒé™
}

// æ¥å£æ–¹æ³•ä¸Šä½¿ç”¨
@RestController
public class UserController {
    
    @RequiresPermission("user:view")
    @GetMapping("/users")
    public List<User> getAllUsers() {
        return userService.getAllUsers();
    }
    
    @RequiresPermission("user:delete")
    @DeleteMapping("/users/{id}")
    public void deleteUser(@PathVariable Long id) {
        userService.deleteUser(id);
    }
}

// æƒé™æ‹¦æˆªå™¨
@Component
public class PermissionInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler) {
        
        // è·å–æ–¹æ³•ä¸Šçš„æƒé™æ³¨è§£
        RequiresPermission permission = getMethodAnnotation(handler);
        if (permission == null) {
            return true; // æ— éœ€æƒé™æ£€æŸ¥
        }
        
        // è·å–å½“å‰ç”¨æˆ·
        User currentUser = getCurrentUser(request);
        if (currentUser == null) {
            throw new UnauthorizedException("ç”¨æˆ·æœªç™»å½•");
        }
        
        // æ£€æŸ¥æƒé™
        if (!hasPermission(currentUser, permission.value())) {
            throw new ForbiddenException("æƒé™ä¸è¶³");
        }
        
        return true;
    }
}
```

### 3.4 æœ€å°æƒé™åŸåˆ™


**ğŸ”¸ æ ¸å¿ƒæ€æƒ³**ï¼šç”¨æˆ·åªæ‹¥æœ‰å®Œæˆå·¥ä½œæ‰€å¿…éœ€çš„æœ€å°æƒé™

```java
// æƒé™è®¾è®¡ç¤ºä¾‹
public class PermissionDesign {
    
    // âŒ é”™è¯¯ï¼šæƒé™è¿‡å¤§
    public class BadPermissionDesign {
        // ç»™å‰ç«¯å¼€å‘è€…æ•°æ®åº“ç®¡ç†å‘˜æƒé™
        User frontendDev = new User("å¼ ä¸‰", "ADMIN");
    }
    
    // âœ… æ­£ç¡®ï¼šæœ€å°æƒé™
    public class GoodPermissionDesign {
        // å‰ç«¯å¼€å‘è€…åªæœ‰å¿…è¦æƒé™
        User frontendDev = new User("å¼ ä¸‰", Arrays.asList(
            "project:view",    // æŸ¥çœ‹é¡¹ç›®
            "code:commit",     // æäº¤ä»£ç 
            "bug:report"       // æŠ¥å‘ŠBug
        ));
    }
}
```

---

## 4. ğŸš« é˜²æ”»å‡»æœºåˆ¶


### 4.1 å¸¸è§æ”»å‡»ç±»å‹åŠé˜²æŠ¤


**ğŸ’£ é‡æ”¾æ”»å‡»é˜²æŠ¤**

> **ä»€ä¹ˆæ˜¯é‡æ”¾æ”»å‡»**ï¼šé»‘å®¢æˆªè·æ­£å¸¸çš„ç½‘ç»œè¯·æ±‚ï¼Œç„¶åé‡å¤å‘é€ï¼Œé€ æˆé‡å¤æ“ä½œ

**ğŸ›¡ï¸ é˜²é‡æ”¾æ”»å‡»æ–¹æ¡ˆ**

```java
// åŸºäºæ—¶é—´æˆ³å’Œç­¾åçš„é˜²é‡æ”¾
public class AntiReplayService {
    
    private static final long VALID_TIME_WINDOW = 5 * 60 * 1000; // 5åˆ†é’Ÿæœ‰æ•ˆæœŸ
    private Set<String> usedNonces = new ConcurrentHashMap<>();
    
    public boolean validateRequest(ApiRequest request) {
        // 1. æ£€æŸ¥æ—¶é—´æˆ³
        long timestamp = request.getTimestamp();
        long currentTime = System.currentTimeMillis();
        
        if (Math.abs(currentTime - timestamp) > VALID_TIME_WINDOW) {
            return false; // è¯·æ±‚è¿‡æœŸ
        }
        
        // 2. æ£€æŸ¥éšæœºæ•°ï¼ˆé˜²æ­¢é‡å¤ï¼‰
        String nonce = request.getNonce();
        if (usedNonces.contains(nonce)) {
            return false; // é‡å¤è¯·æ±‚
        }
        
        // 3. éªŒè¯ç­¾å
        String expectedSign = calculateSign(request);
        if (!expectedSign.equals(request.getSignature())) {
            return false; // ç­¾åæ— æ•ˆ
        }
        
        // è®°å½•å·²ä½¿ç”¨çš„éšæœºæ•°
        usedNonces.add(nonce);
        return true;
    }
    
    // è®¡ç®—ç­¾å
    private String calculateSign(ApiRequest request) {
        String data = request.getParams() + request.getTimestamp() + request.getNonce();
        return MD5Utils.encrypt(data + SECRET_KEY);
    }
}
```

**ğŸ” æš´åŠ›ç ´è§£é˜²æŠ¤**

```java
// ç™»å½•å¤±è´¥æ¬¡æ•°é™åˆ¶
@Service
public class LoginAttemptService {
    
    private final int MAX_ATTEMPTS = 5;
    private final long LOCK_TIME = 30 * 60 * 1000; // 30åˆ†é’Ÿé”å®š
    
    private Map<String, AttemptInfo> attemptCache = new ConcurrentHashMap<>();
    
    public boolean isBlocked(String username) {
        AttemptInfo info = attemptCache.get(username);
        if (info == null) return false;
        
        // å¦‚æœé”å®šæ—¶é—´å·²è¿‡ï¼Œæ¸…é™¤è®°å½•
        if (System.currentTimeMillis() - info.getLastAttempt() > LOCK_TIME) {
            attemptCache.remove(username);
            return false;
        }
        
        return info.getAttemptCount() >= MAX_ATTEMPTS;
    }
    
    public void recordFailedAttempt(String username) {
        AttemptInfo info = attemptCache.getOrDefault(username, new AttemptInfo());
        info.incrementAttempt();
        info.setLastAttempt(System.currentTimeMillis());
        attemptCache.put(username, info);
    }
    
    public void recordSuccessfulLogin(String username) {
        attemptCache.remove(username); // ç™»å½•æˆåŠŸï¼Œæ¸…é™¤å¤±è´¥è®°å½•
    }
}
```

### 4.2 è¾“å…¥éªŒè¯ä¸è¿‡æ»¤


**ğŸ§¹ å±é™©å­—ç¬¦è¿‡æ»¤**

```java
public class InputSanitizer {
    
    // å±é™©å­—ç¬¦æ¨¡å¼
    private static final Pattern SCRIPT_PATTERN = 
        Pattern.compile("<script[^>]*>.*?</script>", Pattern.CASE_INSENSITIVE);
    private static final Pattern SQL_PATTERN = 
        Pattern.compile("(SELECT|INSERT|UPDATE|DELETE|DROP|CREATE|ALTER)", 
                       Pattern.CASE_INSENSITIVE);
    
    public String sanitizeInput(String input) {
        if (input == null) return null;
        
        String result = input;
        
        // ç§»é™¤è„šæœ¬æ ‡ç­¾
        result = SCRIPT_PATTERN.matcher(result).replaceAll("");
        
        // è½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦
        result = escapeHtml(result);
        
        // æ£€æŸ¥SQLå…³é”®å­—
        if (SQL_PATTERN.matcher(result).find()) {
            throw new SecurityException("è¾“å…¥åŒ…å«å±é™©å­—ç¬¦");
        }
        
        return result;
    }
}
```

---

## 5. ğŸš¦ æ¥å£é™æµä¿æŠ¤


### 5.1 ä¸ºä»€ä¹ˆéœ€è¦æ¥å£é™æµ


**ğŸ’¡ é™æµçš„ç›®çš„**

å°±åƒé«˜é€Ÿå…¬è·¯çš„æ”¶è´¹ç«™ï¼Œæ§åˆ¶é€šè¡Œé€Ÿåº¦é˜²æ­¢æ‹¥å µï¼š
- **ä¿æŠ¤ç³»ç»Ÿ**ï¼šé˜²æ­¢ç³»ç»Ÿè¢«å¤§é‡è¯·æ±‚å‹å®
- **å…¬å¹³ä½¿ç”¨**ï¼šé˜²æ­¢æŸä¸ªç”¨æˆ·å ç”¨è¿‡å¤šèµ„æº
- **é˜²æ¶æ„æ”»å‡»**ï¼šé™åˆ¶æ¶æ„è¯·æ±‚çš„é¢‘ç‡

### 5.2 é™æµç®—æ³•è¯¦è§£


**ğŸª£ ä»¤ç‰Œæ¡¶ç®—æ³•**

> **å½¢è±¡æ¯”å–»**ï¼šåƒé“¶è¡Œå–å·æœºï¼Œæ¯ç§’äº§ç”Ÿå›ºå®šæ•°é‡çš„å·ç ï¼ˆä»¤ç‰Œï¼‰ï¼Œç”¨æˆ·æ¥äº†å…ˆå–å·ï¼Œæ²¡å·å°±ç­‰å¾…

```java
public class TokenBucketLimiter {
    private final int capacity;        // æ¡¶å®¹é‡
    private final int refillRate;      // æ¯ç§’è¡¥å……é€Ÿç‡
    private int currentTokens;         // å½“å‰ä»¤ç‰Œæ•°
    private long lastRefillTime;       // ä¸Šæ¬¡è¡¥å……æ—¶é—´
    
    public TokenBucketLimiter(int capacity, int refillRate) {
        this.capacity = capacity;
        this.refillRate = refillRate;
        this.currentTokens = capacity;
        this.lastRefillTime = System.currentTimeMillis();
    }
    
    public synchronized boolean tryAcquire() {
        refillTokens(); // å…ˆè¡¥å……ä»¤ç‰Œ
        
        if (currentTokens > 0) {
            currentTokens--;
            return true; // è·å–æˆåŠŸ
        }
        return false; // è·å–å¤±è´¥ï¼Œéœ€è¦ç­‰å¾…
    }
    
    private void refillTokens() {
        long currentTime = System.currentTimeMillis();
        long timePassed = currentTime - lastRefillTime;
        
        // è®¡ç®—åº”è¯¥è¡¥å……çš„ä»¤ç‰Œæ•°
        int tokensToAdd = (int) (timePassed / 1000 * refillRate);
        if (tokensToAdd > 0) {
            currentTokens = Math.min(capacity, currentTokens + tokensToAdd);
            lastRefillTime = currentTime;
        }
    }
}
```

**â° æ»‘åŠ¨çª—å£ç®—æ³•**

```java
public class SlidingWindowLimiter {
    private final int windowSize;      // çª—å£å¤§å°ï¼ˆç§’ï¼‰
    private final int maxRequests;     // æœ€å¤§è¯·æ±‚æ•°
    private final Queue<Long> requests; // è¯·æ±‚æ—¶é—´é˜Ÿåˆ—
    
    public SlidingWindowLimiter(int windowSize, int maxRequests) {
        this.windowSize = windowSize;
        this.maxRequests = maxRequests;
        this.requests = new LinkedList<>();
    }
    
    public synchronized boolean tryAcquire() {
        long currentTime = System.currentTimeMillis();
        
        // ç§»é™¤çª—å£å¤–çš„è¯·æ±‚
        while (!requests.isEmpty() && 
               currentTime - requests.peek() > windowSize * 1000) {
            requests.poll();
        }
        
        // æ£€æŸ¥æ˜¯å¦è¶…è¿‡é™åˆ¶
        if (requests.size() < maxRequests) {
            requests.offer(currentTime);
            return true;
        }
        
        return false;
    }
}
```

### 5.3 å¤šçº§é™æµç­–ç•¥


**ğŸ“Š é™æµå±‚æ¬¡è®¾è®¡**

```
â”Œâ”€ å…¨å±€é™æµ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ QPS: 10000/ç§’                 â”‚ â† ç³»ç»Ÿæ•´ä½“ä¿æŠ¤
â”œâ”€ ç”¨æˆ·é™æµ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ™®é€šç”¨æˆ·: 100/åˆ†é’Ÿ              â”‚ â† ç”¨æˆ·çº§åˆ«é™åˆ¶
â”‚ VIPç”¨æˆ·:  1000/åˆ†é’Ÿ            â”‚
â”œâ”€ æ¥å£é™æµ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æŸ¥è¯¢æ¥å£: 1000/åˆ†é’Ÿ             â”‚ â† æ¥å£çº§åˆ«é™åˆ¶
â”‚ å†™å…¥æ¥å£: 100/åˆ†é’Ÿ              â”‚
â””â”€ IPé™æµ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ å•IP: 500/åˆ†é’Ÿ                â”‚ â† IPçº§åˆ«é™åˆ¶
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”§ Spring Booté›†æˆç¤ºä¾‹**

```java
@Component
public class RateLimitingInterceptor implements HandlerInterceptor {
    
    private Map<String, TokenBucketLimiter> userLimiters = new ConcurrentHashMap<>();
    private Map<String, TokenBucketLimiter> ipLimiters = new ConcurrentHashMap<>();
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler) throws Exception {
        
        String userId = getCurrentUserId(request);
        String clientIp = getClientIp(request);
        
        // ç”¨æˆ·çº§é™æµ
        if (!checkUserRateLimit(userId)) {
            response.setStatus(429); // Too Many Requests
            response.getWriter().write("ç”¨æˆ·è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•");
            return false;
        }
        
        // IPçº§é™æµ
        if (!checkIpRateLimit(clientIp)) {
            response.setStatus(429);
            response.getWriter().write("IPè¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•");
            return false;
        }
        
        return true;
    }
    
    private boolean checkUserRateLimit(String userId) {
        TokenBucketLimiter limiter = userLimiters.computeIfAbsent(userId, 
            k -> new TokenBucketLimiter(100, 10)); // 100å®¹é‡ï¼Œæ¯ç§’10ä¸ªä»¤ç‰Œ
        return limiter.tryAcquire();
    }
}
```

---

## 6. ğŸ›¡ï¸ é˜²å¾¡æ€§ç¼–ç¨‹


### 6.1 é˜²å¾¡æ€§ç¼–ç¨‹çš„æ ¸å¿ƒæ€æƒ³


**ğŸ’¡ ä»€ä¹ˆæ˜¯é˜²å¾¡æ€§ç¼–ç¨‹**

> é˜²å¾¡æ€§ç¼–ç¨‹å°±åƒå¼€è½¦æ—¶ç³»å®‰å…¨å¸¦ï¼Œå³ä½¿ä½ æ˜¯å¥½å¸æœºï¼Œä¹Ÿè¦é˜²èŒƒå…¶ä»–äººçš„å¤±è¯¯

**ğŸ¯ æ ¸å¿ƒåŸåˆ™**
- **è¾“å…¥æ ¡éªŒ**ï¼šæ°¸è¿œä¸ç›¸ä¿¡å¤–éƒ¨è¾“å…¥
- **æœ€å°æƒé™åŸåˆ™**ï¼šåªç»™å¿…è¦çš„æƒé™
- **å¤±è´¥å®‰å…¨**ï¼šç³»ç»Ÿå‡ºé”™æ—¶ä¿æŒå®‰å…¨çŠ¶æ€
- **æ·±åº¦é˜²å¾¡**ï¼šå¤šå±‚é˜²æŠ¤ï¼Œä¸ä¾èµ–å•ç‚¹

### 6.2 è¾“å…¥æ ¡éªŒçš„æ·±åº¦é˜²å¾¡


**ğŸ“ å…¨æ–¹ä½è¾“å…¥æ ¡éªŒ**

```java
public class DefensiveInputValidator {
    
    public void processUserData(String userData) {
        // ç¬¬ä¸€å±‚ï¼šç©ºå€¼æ£€æŸ¥
        if (userData == null || userData.trim().isEmpty()) {
            throw new IllegalArgumentException("ç”¨æˆ·æ•°æ®ä¸èƒ½ä¸ºç©º");
        }
        
        // ç¬¬äºŒå±‚ï¼šé•¿åº¦æ£€æŸ¥
        if (userData.length() > 1000) {
            throw new IllegalArgumentException("ç”¨æˆ·æ•°æ®é•¿åº¦è¶…å‡ºé™åˆ¶");
        }
        
        // ç¬¬ä¸‰å±‚ï¼šæ ¼å¼æ£€æŸ¥
        if (!isValidFormat(userData)) {
            throw new IllegalArgumentException("ç”¨æˆ·æ•°æ®æ ¼å¼ä¸æ­£ç¡®");
        }
        
        // ç¬¬å››å±‚ï¼šå®‰å…¨æ£€æŸ¥
        if (containsMaliciousContent(userData)) {
            throw new SecurityException("ç”¨æˆ·æ•°æ®åŒ…å«æ¶æ„å†…å®¹");
        }
        
        // ç¬¬äº”å±‚ï¼šä¸šåŠ¡é€»è¾‘æ£€æŸ¥
        if (!isBusinessValid(userData)) {
            throw new BusinessException("ç”¨æˆ·æ•°æ®ä¸ç¬¦åˆä¸šåŠ¡è§„åˆ™");
        }
        
        // ç»è¿‡å±‚å±‚æ ¡éªŒåæ‰å¤„ç†
        doProcessUserData(userData);
    }
    
    private boolean isValidFormat(String data) {
        // æ£€æŸ¥æ˜¯å¦ç¬¦åˆé¢„æœŸæ ¼å¼
        return data.matches("^[a-zA-Z0-9\\s]+$");
    }
    
    private boolean containsMaliciousContent(String data) {
        // æ£€æŸ¥æ˜¯å¦åŒ…å«æ¶æ„å†…å®¹
        String[] maliciousPatterns = {"<script", "javascript:", "onload="};
        String lowerData = data.toLowerCase();
        
        for (String pattern : maliciousPatterns) {
            if (lowerData.contains(pattern)) {
                return true;
            }
        }
        return false;
    }
}
```

### 6.3 æœ€å°æƒé™åŸåˆ™çš„å®è·µ


**ğŸ” æƒé™æœ€å°åŒ–è®¾è®¡**

```java
// âŒ ä¸å¥½çš„åšæ³•ï¼šè¿‡åº¦æˆæƒ
public class BadPermissionExample {
    public void processOrder(Long orderId) {
        // ç»™äº†æ•°æ®åº“å…¨éƒ¨æƒé™
        Connection conn = getAdminConnection();
        // å¯ä»¥æ‰§è¡Œä»»ä½•SQLï¼Œé£é™©å¾ˆå¤§
        Statement stmt = conn.createStatement();
        stmt.execute("SELECT * FROM orders WHERE id = " + orderId);
    }
}

// âœ… å¥½çš„åšæ³•ï¼šæœ€å°æƒé™
public class GoodPermissionExample {
    public void processOrder(Long orderId) {
        // åªç»™æŸ¥è¯¢ç‰¹å®šè¡¨çš„æƒé™
        OrderRepository orderRepo = getOrderRepository();
        
        // ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ï¼Œé˜²SQLæ³¨å…¥
        Order order = orderRepo.findById(orderId);
        
        // è¿›ä¸€æ­¥æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®è¿™ä¸ªè®¢å•
        if (!currentUser.canAccessOrder(order)) {
            throw new UnauthorizedException("æ— æƒé™è®¿é—®æ­¤è®¢å•");
        }
        
        processValidOrder(order);
    }
}
```

### 6.4 å¼‚å¸¸å¤„ç†çš„å®‰å…¨è€ƒè™‘


**âš ï¸ å®‰å…¨çš„å¼‚å¸¸å¤„ç†**

```java
public class SecureExceptionHandling {
    
    // âŒ ä¸å®‰å…¨ï¼šæš´éœ²ç³»ç»Ÿä¿¡æ¯
    public ResponseEntity<String> badExceptionHandling() {
        try {
            // ä¸šåŠ¡é€»è¾‘
            return processData();
        } catch (SQLException e) {
            // ç›´æ¥è¿”å›æ•°æ®åº“é”™è¯¯ä¿¡æ¯ï¼Œæ³„éœ²ç³»ç»Ÿä¿¡æ¯
            return ResponseEntity.status(500)
                .body("æ•°æ®åº“é”™è¯¯ï¼š" + e.getMessage());
        }
    }
    
    // âœ… å®‰å…¨ï¼šéšè—ç³»ç»Ÿä¿¡æ¯
    public ResponseEntity<ApiResponse> goodExceptionHandling() {
        try {
            // ä¸šåŠ¡é€»è¾‘
            return processData();
        } catch (SQLException e) {
            // è®°å½•è¯¦ç»†é”™è¯¯ä¿¡æ¯åˆ°æ—¥å¿—
            logger.error("æ•°æ®åº“æ“ä½œå¤±è´¥", e);
            
            // è¿”å›é€šç”¨é”™è¯¯ä¿¡æ¯ç»™ç”¨æˆ·
            return ResponseEntity.status(500)
                .body(new ApiResponse("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•"));
        } catch (BusinessException e) {
            // ä¸šåŠ¡å¼‚å¸¸å¯ä»¥è¿”å›å…·ä½“ä¿¡æ¯
            return ResponseEntity.status(400)
                .body(new ApiResponse(e.getMessage()));
        } catch (Exception e) {
            // æœªçŸ¥å¼‚å¸¸ï¼Œè®°å½•æ—¥å¿—ä½†ä¸æš´éœ²ç»†èŠ‚
            logger.error("æœªçŸ¥é”™è¯¯", e);
            return ResponseEntity.status(500)
                .body(new ApiResponse("ç³»ç»Ÿé”™è¯¯"));
        }
    }
}
```

---

## 7. ğŸ§  å®‰å…¨æ„è¯†ä¸ç³»ç»Ÿè®¾è®¡


### 7.1 å®‰å…¨æ„è¯†çš„é‡è¦æ€§


**ğŸ¯ å®‰å…¨æ€ç»´æ¨¡å¼**

> å®‰å…¨ä¸æ˜¯åŠŸèƒ½ï¼Œè€Œæ˜¯ä¸€ç§æ€ç»´æ–¹å¼ï¼Œéœ€è¦è´¯ç©¿æ•´ä¸ªå¼€å‘è¿‡ç¨‹

**ğŸ“Š å®‰å…¨å¼€å‘ç”Ÿå‘½å‘¨æœŸ**
```
éœ€æ±‚åˆ†æé˜¶æ®µ â†’ å®‰å…¨éœ€æ±‚è¯†åˆ«
    â†“
è®¾è®¡é˜¶æ®µ â†’ å¨èƒå»ºæ¨¡åˆ†æ
    â†“
ç¼–ç é˜¶æ®µ â†’ å®‰å…¨ç¼–ç è§„èŒƒ
    â†“
æµ‹è¯•é˜¶æ®µ â†’ å®‰å…¨æµ‹è¯•éªŒè¯
    â†“
éƒ¨ç½²é˜¶æ®µ â†’ å®‰å…¨é…ç½®æ£€æŸ¥
    â†“
è¿ç»´é˜¶æ®µ â†’ å®‰å…¨ç›‘æ§å‘Šè­¦
```

### 7.2 é˜²å¾¡æ€§ä»£ç è®¾è®¡çš„ç³»ç»Ÿæ–¹æ³•


**ğŸ—ï¸ ç³»ç»Ÿæ€§å®‰å…¨è®¾è®¡**

```java
// å®‰å…¨è®¾è®¡æ¨¡å¼ï¼šé˜²å¾¡å¼APIè®¾è®¡
public class SecureApiDesign {
    
    // 1. è¾“å…¥éªŒè¯å±‚
    @Component
    public class InputValidationLayer {
        public ValidatedInput validate(RawInput input) {
            // ç»Ÿä¸€çš„è¾“å…¥éªŒè¯é€»è¾‘
            return new ValidatedInput(input);
        }
    }
    
    // 2. æƒé™æ§åˆ¶å±‚
    @Component
    public class AuthorizationLayer {
        public void checkPermission(User user, String operation) {
            if (!user.hasPermission(operation)) {
                throw new UnauthorizedException();
            }
        }
    }
    
    // 3. ä¸šåŠ¡é€»è¾‘å±‚
    @Service
    public class BusinessLogicLayer {
        @Autowired
        private InputValidationLayer validator;
        @Autowired
        private AuthorizationLayer authLayer;
        
        public ApiResponse processRequest(RawInput input, User user) {
            // 1. éªŒè¯è¾“å…¥
            ValidatedInput validInput = validator.validate(input);
            
            // 2. æ£€æŸ¥æƒé™
            authLayer.checkPermission(user, "PROCESS_REQUEST");
            
            // 3. æ‰§è¡Œä¸šåŠ¡é€»è¾‘
            return doBusinessLogic(validInput);
        }
    }
}
```

### 7.3 å®‰å…¨é…ç½®çš„æœ€ä½³å®è·µ


**âš™ï¸ å®‰å…¨é…ç½®æ£€æŸ¥æ¸…å•**

```yaml
# application-security.yml
security:
  # 1. ä¼šè¯å®‰å…¨
  session:
    timeout: 30m                # ä¼šè¯è¶…æ—¶
    cookie:
      secure: true             # åªå…è®¸HTTPSä¼ è¾“
      httpOnly: true           # é˜²æ­¢XSSæ”»å‡»
      sameSite: strict         # é˜²æ­¢CSRFæ”»å‡»
  
  # 2. å¯†ç ç­–ç•¥
  password:
    minLength: 8               # æœ€å°é•¿åº¦
    requireUppercase: true     # éœ€è¦å¤§å†™å­—æ¯
    requireLowercase: true     # éœ€è¦å°å†™å­—æ¯
    requireNumbers: true       # éœ€è¦æ•°å­—
    requireSpecialChars: true  # éœ€è¦ç‰¹æ®Šå­—ç¬¦
  
  # 3. æ¥å£é™æµ
  rateLimit:
    global: 10000/minute       # å…¨å±€é™æµ
    perUser: 1000/minute       # ç”¨æˆ·é™æµ
    perIp: 500/minute          # IPé™æµ
  
  # 4. å®‰å…¨å¤´è®¾ç½®
  headers:
    frameOptions: DENY         # é˜²æ­¢ç‚¹å‡»åŠ«æŒ
    contentTypeOptions: nosniff # é˜²æ­¢MIMEç±»å‹å—…æ¢
    xssProtection: "1; mode=block" # XSSä¿æŠ¤
```

---

## 8. ğŸ›ï¸ æ¶æ„è®¾è®¡æ¨¡å¼åº”ç”¨


### 8.1 è¡Œä¸ºæŠ½è±¡åœ¨APIè®¾è®¡ä¸­çš„åº”ç”¨


**ğŸ¯ è¡Œä¸ºå°è£…çš„å®‰å…¨ä¼˜åŠ¿**

```java
// å°†å®‰å…¨æ£€æŸ¥æŠ½è±¡ä¸ºè¡Œä¸º
public interface SecureOperation<T, R> {
    R execute(T input) throws SecurityException;
    
    default R executeSecurely(T input, SecurityContext context) {
        // 1. é¢„å¤„ç†å®‰å…¨æ£€æŸ¥
        validateInput(input);
        checkPermissions(context);
        
        // 2. æ‰§è¡Œæ ¸å¿ƒæ“ä½œ
        R result = execute(input);
        
        // 3. åå¤„ç†å®‰å…¨æ£€æŸ¥
        validateOutput(result);
        auditLog(input, result, context);
        
        return result;
    }
    
    default void validateInput(T input) {
        if (input == null) {
            throw new SecurityException("è¾“å…¥ä¸èƒ½ä¸ºç©º");
        }
    }
    
    default void checkPermissions(SecurityContext context) {
        if (!context.hasRequiredPermissions()) {
            throw new SecurityException("æƒé™ä¸è¶³");
        }
    }
}

// å…·ä½“ä¸šåŠ¡æ“ä½œå®ç°
@Service
public class UserService implements SecureOperation<UserRequest, User> {
    
    @Override
    public User execute(UserRequest request) {
        // çº¯ç²¹çš„ä¸šåŠ¡é€»è¾‘ï¼Œä¸ç”¨å…³å¿ƒå®‰å…¨æ£€æŸ¥
        return createUser(request);
    }
    
    // å¯¹å¤–æä¾›çš„å®‰å…¨æ¥å£
    public User createUserSecurely(UserRequest request, SecurityContext context) {
        return executeSecurely(request, context);
    }
}
```

### 8.2 ç­–ç•¥æ¨¡å¼åœ¨å®‰å…¨éªŒè¯ä¸­çš„åº”ç”¨


**ğŸ”„ æ­¥éª¤æŠ½è±¡ä¸ç­–ç•¥æ¨¡å¼ç»“åˆ**

```java
// éªŒè¯ç­–ç•¥æ¥å£
public interface ValidationStrategy {
    ValidationResult validate(Object input);
    int getPriority(); // éªŒè¯ä¼˜å…ˆçº§
}

// å…·ä½“éªŒè¯ç­–ç•¥
@Component
public class InputFormatValidator implements ValidationStrategy {
    @Override
    public ValidationResult validate(Object input) {
        // æ ¼å¼éªŒè¯é€»è¾‘
        return ValidationResult.success();
    }
    
    @Override
    public int getPriority() {
        return 1; // ç¬¬ä¸€æ­¥ï¼šæ ¼å¼éªŒè¯
    }
}

@Component
public class SecurityValidator implements ValidationStrategy {
    @Override
    public ValidationResult validate(Object input) {
        // å®‰å…¨éªŒè¯é€»è¾‘
        return ValidationResult.success();
    }
    
    @Override
    public int getPriority() {
        return 2; // ç¬¬äºŒæ­¥ï¼šå®‰å…¨éªŒè¯
    }
}

// éªŒè¯å™¨ç®¡ç†ç±»
@Service
public class ValidationManager {
    
    @Autowired
    private List<ValidationStrategy> validators;
    
    public ValidationResult validateAll(Object input) {
        // æŒ‰ä¼˜å…ˆçº§æ’åº
        List<ValidationStrategy> sortedValidators = validators.stream()
            .sorted(Comparator.comparing(ValidationStrategy::getPriority))
            .collect(Collectors.toList());
        
        // ä¾æ¬¡æ‰§è¡ŒéªŒè¯
        for (ValidationStrategy validator : sortedValidators) {
            ValidationResult result = validator.validate(input);
            if (!result.isValid()) {
                return result; // éªŒè¯å¤±è´¥ï¼Œç«‹å³è¿”å›
            }
        }
        
        return ValidationResult.success();
    }
}
```

### 8.3 æ¥å£å¥‘çº¦è®¾è®¡


**ğŸ“œ ç”¨æ¥å£å®šä¹‰å¥‘çº¦ï¼Œå®ç°çµæ´»æ›¿æ¢**

```java
// å®‰å…¨æœåŠ¡å¥‘çº¦å®šä¹‰
public interface SecurityService {
    
    /**
     * ç”¨æˆ·è®¤è¯
     * å¥‘çº¦ï¼šè¾“å…¥ç”¨æˆ·å‡­è¯ï¼Œè¿”å›è®¤è¯ç»“æœ
     * å¼‚å¸¸ï¼šè®¤è¯å¤±è´¥æŠ›å‡ºAuthenticationException
     */
    AuthenticationResult authenticate(UserCredentials credentials) 
        throws AuthenticationException;
    
    /**
     * æƒé™æ£€æŸ¥
     * å¥‘çº¦ï¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æ‰§è¡ŒæŒ‡å®šæ“ä½œçš„æƒé™
     * å‰ç½®æ¡ä»¶ï¼šç”¨æˆ·å·²é€šè¿‡è®¤è¯
     */
    boolean hasPermission(User user, String operation);
    
    /**
     * ä¼šè¯ç®¡ç†
     * å¥‘çº¦ï¼šåˆ›å»ºå®‰å…¨ä¼šè¯ï¼Œè®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´
     */
    Session createSession(User user);
}

// åŸºç¡€å®ç°
@Service("basicSecurityService")
public class BasicSecurityServiceImpl implements SecurityService {
    // åŸºç¡€å®‰å…¨åŠŸèƒ½å®ç°
}

// é«˜çº§å®ç°ï¼ˆå¢å¼ºå®‰å…¨ï¼‰
@Service("enhancedSecurityService")
public class EnhancedSecurityServiceImpl implements SecurityService {
    // å¢å¼ºå®‰å…¨åŠŸèƒ½ï¼šåŒå› å­è®¤è¯ã€è¯¦ç»†å®¡è®¡æ—¥å¿—ç­‰
}

// æ ¹æ®é…ç½®é€‰æ‹©å®ç°
@Configuration
public class SecurityConfiguration {
    
    @Bean
    @Primary
    public SecurityService securityService(
            @Value("${security.level:basic}") String securityLevel) {
        
        if ("enhanced".equals(securityLevel)) {
            return new EnhancedSecurityServiceImpl();
        }
        return new BasicSecurityServiceImpl();
    }
}
```

### 8.4 å•å…ƒæµ‹è¯•å‹å¥½çš„æ¥å£è®¾è®¡


**ğŸ§ª ä¾¿äºæµ‹è¯•çš„å®‰å…¨ä»£ç è®¾è®¡**

```java
// å¯æµ‹è¯•çš„å®‰å…¨æœåŠ¡è®¾è®¡
@Service
public class TestableSecurityService {
    
    private final PasswordEncoder passwordEncoder;
    private final UserRepository userRepository;
    private final AuditLogger auditLogger;
    
    // æ„é€ å‡½æ•°æ³¨å…¥ï¼Œä¾¿äºMock
    public TestableSecurityService(PasswordEncoder passwordEncoder,
                                 UserRepository userRepository,
                                 AuditLogger auditLogger) {
        this.passwordEncoder = passwordEncoder;
        this.userRepository = userRepository;
        this.auditLogger = auditLogger;
    }
    
    // çº¯å‡½æ•°è®¾è®¡ï¼Œä¾¿äºæµ‹è¯•
    public boolean validatePassword(String rawPassword, String encodedPassword) {
        return passwordEncoder.matches(rawPassword, encodedPassword);
    }
    
    // ä¾èµ–æ³¨å…¥ï¼Œä¾¿äºMock
    public User authenticateUser(String username, String password) {
        User user = userRepository.findByUsername(username);
        if (user == null) {
            auditLogger.logFailedLogin(username, "ç”¨æˆ·ä¸å­˜åœ¨");
            return null;
        }
        
        if (!validatePassword(password, user.getPassword())) {
            auditLogger.logFailedLogin(username, "å¯†ç é”™è¯¯");
            return null;
        }
        
        auditLogger.logSuccessfulLogin(username);
        return user;
    }
}

// å¯¹åº”çš„å•å…ƒæµ‹è¯•
@ExtendWith(MockitoExtension.class)
class TestableSecurityServiceTest {
    
    @Mock
    private PasswordEncoder passwordEncoder;
    @Mock
    private UserRepository userRepository;
    @Mock
    private AuditLogger auditLogger;
    
    @InjectMocks
    private TestableSecurityService securityService;
    
    @Test
    void testAuthenticateUser_Success() {
        // Given
        String username = "testuser";
        String password = "password123";
        User mockUser = new User(username, "encodedPassword");
        
        when(userRepository.findByUsername(username)).thenReturn(mockUser);
        when(passwordEncoder.matches(password, "encodedPassword")).thenReturn(true);
        
        // When
        User result = securityService.authenticateUser(username, password);
        
        // Then
        assertThat(result).isNotNull();
        assertThat(result.getUsername()).isEqualTo(username);
        verify(auditLogger).logSuccessfulLogin(username);
    }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„å®‰å…¨ç†å¿µ


```
ğŸ”¸ æ°¸è¿œä¸è¦ç›¸ä¿¡ç”¨æˆ·è¾“å…¥ - æ‰€æœ‰å¤–éƒ¨æ•°æ®éƒ½éœ€è¦éªŒè¯
ğŸ”¸ æœ€å°æƒé™åŸåˆ™ - åªç»™å¿…è¦çš„æƒé™ï¼Œä¸å¤šç»™ä¸€åˆ†
ğŸ”¸ æ·±åº¦é˜²å¾¡ç­–ç•¥ - å¤šå±‚é˜²æŠ¤ï¼Œä¸ä¾èµ–å•ä¸€é˜²çº¿
ğŸ”¸ å¤±è´¥å®‰å…¨è®¾è®¡ - ç³»ç»Ÿå‡ºé”™æ—¶ä¿æŒå®‰å…¨çŠ¶æ€
ğŸ”¸ å®‰å…¨æ˜¯è¿‡ç¨‹ä¸æ˜¯ç»“æœ - éœ€è¦æŒç»­å…³æ³¨å’Œæ”¹è¿›
```

### 9.2 å…³é”®å®è·µè¦ç‚¹


**ğŸ›¡ï¸ å‚æ•°æ ¡éªŒå¿…å¤‡æ¸…å•**
- âœ… å¿…å¡«å­—æ®µæ£€æŸ¥
- âœ… æ•°æ®ç±»å‹éªŒè¯  
- âœ… é•¿åº¦èŒƒå›´é™åˆ¶
- âœ… æ ¼å¼è§„åˆ™æ ¡éªŒ
- âœ… æ¶æ„å­—ç¬¦è¿‡æ»¤
- âœ… SQLæ³¨å…¥é˜²æŠ¤
- âœ… XSSæ”»å‡»é˜²æŠ¤

**ğŸ” æƒé™æ§åˆ¶å…³é”®ç‚¹**
- âœ… èº«ä»½è®¤è¯åœ¨å‰
- âœ… æƒé™æ ¡éªŒåœ¨æ¯ä¸ªå…³é”®æ“ä½œç‚¹
- âœ… ä¼šè¯ç®¡ç†è¦å®‰å…¨
- âœ… æœ€å°æƒé™åŸåˆ™
- âœ… æƒé™å˜æ›´è¦å®¡è®¡

**ğŸš¦ é™æµä¿æŠ¤ç­–ç•¥**
- âœ… å¤šå±‚æ¬¡é™æµï¼šå…¨å±€ã€ç”¨æˆ·ã€IPã€æ¥å£
- âœ… åˆç†è®¾ç½®é˜ˆå€¼ï¼Œé¿å…è¯¯æ€æ­£å¸¸ç”¨æˆ·
- âœ… æä¾›å‹å¥½çš„é™æµæç¤ºä¿¡æ¯
- âœ… è€ƒè™‘VIPç”¨æˆ·çš„å·®å¼‚åŒ–ç­–ç•¥

### 9.3 è®¾è®¡æ¨¡å¼åº”ç”¨


**ğŸ—ï¸ æ¶æ„è®¾è®¡æœ€ä½³å®è·µ**

> ğŸ’¡ **è®°å¿†è¦ç‚¹**ï¼šå®‰å…¨åŠŸèƒ½è¦"æŠ½è±¡åŒ–ã€å¯é…ç½®ã€å¯æµ‹è¯•"

- **è¡Œä¸ºæŠ½è±¡**ï¼šæŠŠå®‰å…¨æ£€æŸ¥æŠ½è±¡æˆé€šç”¨è¡Œä¸º
- **ç­–ç•¥æ¨¡å¼**ï¼šä¸åŒåœºæ™¯ä½¿ç”¨ä¸åŒçš„å®‰å…¨ç­–ç•¥
- **æ¥å£å¥‘çº¦**ï¼šç”¨æ¥å£å®šä¹‰å®‰å…¨è§„èŒƒï¼Œå®ç°å¯æ›¿æ¢
- **ä¾èµ–æ³¨å…¥**ï¼šä¾¿äºæµ‹è¯•å’ŒåŠŸèƒ½æ‰©å±•

### 9.4 å®é™…åº”ç”¨å»ºè®®


**ğŸ“š å¼€å‘å®è·µæŒ‡å¯¼**

```
ä»£ç ç¼–å†™æ—¶ï¼š
â€¢ æ¯ä¸ªæ¥å£éƒ½è¦è€ƒè™‘å®‰å…¨æ€§
â€¢ å¼‚å¸¸å¤„ç†ä¸èƒ½æš´éœ²ç³»ç»Ÿä¿¡æ¯
â€¢ æ•æ„Ÿæ•°æ®è¦åŠ å¯†å­˜å‚¨
â€¢ æ—¥å¿—è®°å½•è¦åŒ…å«å®‰å…¨å®¡è®¡ä¿¡æ¯

æ¶æ„è®¾è®¡æ—¶ï¼š
â€¢ å®‰å…¨åŠŸèƒ½è¦æ¨¡å—åŒ–è®¾è®¡
â€¢ è€ƒè™‘ä¸åŒå®‰å…¨ç­‰çº§çš„éœ€æ±‚
â€¢ é¢„ç•™å®‰å…¨åŠŸèƒ½çš„æ‰©å±•ç‚¹
â€¢ åˆ¶å®šç»Ÿä¸€çš„å®‰å…¨è§„èŒƒ

å›¢é˜Ÿåä½œæ—¶ï¼š
â€¢ å»ºç«‹å®‰å…¨ç¼–ç è§„èŒƒ
â€¢ è¿›è¡Œå®‰å…¨ä»£ç è¯„å®¡
â€¢ å®šæœŸè¿›è¡Œå®‰å…¨åŸ¹è®­
â€¢ å»ºç«‹å®‰å…¨äº‹ä»¶å“åº”æœºåˆ¶
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- æ¥å£å®‰å…¨æ˜¯ç³»ç»Ÿå®‰å…¨çš„ç¬¬ä¸€é“é˜²çº¿
- å‚æ•°æ ¡éªŒã€æƒé™æ§åˆ¶ã€é˜²æ”»å‡»ã€é™æµä¿æŠ¤ç¼ºä¸€ä¸å¯  
- é˜²å¾¡æ€§ç¼–ç¨‹è¦æˆä¸ºç¼–ç ä¹ æƒ¯
- å®‰å…¨è®¾è®¡è¦è´¯ç©¿æ•´ä¸ªå¼€å‘ç”Ÿå‘½å‘¨æœŸ