---
title: 3ã€äº‹ä»¶é©±åŠ¨æ¶æ„
---
## ğŸ“š ç›®å½•

1. [äº‹ä»¶é©±åŠ¨æ¶æ„æ¦‚è¿°](#1-äº‹ä»¶é©±åŠ¨æ¶æ„æ¦‚è¿°)
2. [äº‹ä»¶æ€»çº¿è®¾è®¡](#2-äº‹ä»¶æ€»çº¿è®¾è®¡)
3. [æ¶ˆæ¯é˜Ÿåˆ—åº”ç”¨](#3-æ¶ˆæ¯é˜Ÿåˆ—åº”ç”¨)
4. [å‘å¸ƒè®¢é˜…æ¶æ„](#4-å‘å¸ƒè®¢é˜…æ¶æ„)
5. [CQRSæ¨¡å¼](#5-CQRSæ¨¡å¼)
6. [äº‹ä»¶æº¯æº](#6-äº‹ä»¶æº¯æº)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ äº‹ä»¶é©±åŠ¨æ¶æ„æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯äº‹ä»¶é©±åŠ¨æ¶æ„


**ğŸ”¸ é€šä¿—ç†è§£**
```
æƒ³è±¡ä¸€ä¸‹ç°å®ç”Ÿæ´»ä¸­çš„åœºæ™¯ï¼š
- ä½ ç‚¹å‡»ç½‘é¡µæŒ‰é’® â†’ è§¦å‘ç‚¹å‡»äº‹ä»¶ â†’ æ‰§è¡Œç›¸åº”æ“ä½œ
- é“¶è¡Œè½¬è´¦æˆåŠŸ â†’ è§¦å‘è½¬è´¦äº‹ä»¶ â†’ å‘é€çŸ­ä¿¡é€šçŸ¥ã€è®°å½•æ—¥å¿—
- ç”¨æˆ·ä¸‹è®¢å• â†’ è§¦å‘è®¢å•äº‹ä»¶ â†’ å‡åº“å­˜ã€å‘é‚®ä»¶ã€ç”Ÿæˆå‘ç¥¨

è¿™å°±æ˜¯äº‹ä»¶é©±åŠ¨ï¼šæŸä»¶äº‹æƒ…å‘ç”Ÿäº†ï¼ˆäº‹ä»¶ï¼‰ï¼Œç³»ç»Ÿè‡ªåŠ¨åšå‡ºå“åº”
```

**ğŸ“‹ æ ¸å¿ƒå®šä¹‰**
- **äº‹ä»¶ï¼ˆEventï¼‰**ï¼šç³»ç»Ÿä¸­å‘ç”Ÿçš„é‡è¦äº‹æƒ…çš„è®°å½•
- **äº‹ä»¶é©±åŠ¨**ï¼šç³»ç»Ÿé€šè¿‡ç›‘å¬å’Œå“åº”äº‹ä»¶æ¥å·¥ä½œ
- **æ¾è€¦åˆ**ï¼šä¸åŒæ¨¡å—é€šè¿‡äº‹ä»¶é€šä¿¡ï¼Œäº’ä¸ç›´æ¥ä¾èµ–

### 1.2 ä¸ºä»€ä¹ˆè¦ç”¨äº‹ä»¶é©±åŠ¨


**ğŸ¯ ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜**
```java
// ä¼ ç»Ÿç´§è€¦åˆæ–¹å¼
public class OrderService {
    private InventoryService inventory;
    private EmailService emailService;
    private LogService logService;
    
    public void createOrder(Order order) {
        // åˆ›å»ºè®¢å•
        saveOrder(order);
        
        // ç›´æ¥è°ƒç”¨å…¶ä»–æœåŠ¡
        inventory.reduceStock(order);     // ç´§è€¦åˆ
        emailService.sendConfirm(order);  // ç´§è€¦åˆ
        logService.recordOrder(order);    // ç´§è€¦åˆ
    }
}

é—®é¢˜ï¼š
âŒ æ‰€æœ‰æœåŠ¡éƒ½è¦ç›´æ¥ä¾èµ–
âŒ ä¸€ä¸ªæœåŠ¡å‡ºé”™å½±å“æ•´ä¸ªæµç¨‹
âŒ éš¾ä»¥æ‰©å±•æ–°åŠŸèƒ½
âŒ ä»£ç å¤æ‚éš¾ç»´æŠ¤
```

**âœ… äº‹ä»¶é©±åŠ¨çš„ä¼˜åŠ¿**
```java
// äº‹ä»¶é©±åŠ¨æ–¹å¼
public class OrderService {
    private EventBus eventBus;
    
    public void createOrder(Order order) {
        // åªè´Ÿè´£åˆ›å»ºè®¢å•
        saveOrder(order);
        
        // å‘å¸ƒäº‹ä»¶ï¼Œè®©å…¶ä»–æœåŠ¡è‡ªå·±å¤„ç†
        eventBus.publish(new OrderCreatedEvent(order));
    }
}

ä¼˜åŠ¿ï¼š
âœ… æœåŠ¡é—´æ¾è€¦åˆ
âœ… å®¹æ˜“æ‰©å±•æ–°åŠŸèƒ½
âœ… æ•…éšœéš”ç¦»æ€§å¥½
âœ… ä»£ç æ¸…æ™°ç®€æ´
```

### 1.3 äº‹ä»¶é©±åŠ¨çš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ”§ åŸºæœ¬ç»„ä»¶**
```
äº‹ä»¶ç”Ÿäº§è€…ï¼ˆPublisherï¼‰ï¼šå‘å¸ƒäº‹ä»¶çš„ç»„ä»¶
         â†“
    äº‹ä»¶æ€»çº¿ï¼ˆEvent Busï¼‰ï¼šä¼ é€’äº‹ä»¶çš„ä¸­é—´ä»¶
         â†“
äº‹ä»¶æ¶ˆè´¹è€…ï¼ˆSubscriberï¼‰ï¼šå¤„ç†äº‹ä»¶çš„ç»„ä»¶

å®é™…ä¾‹å­ï¼š
è®¢å•æœåŠ¡ â†’ å‘å¸ƒ"è®¢å•åˆ›å»º"äº‹ä»¶ â†’ äº‹ä»¶æ€»çº¿ â†’ åº“å­˜æœåŠ¡æ¥æ”¶å¹¶å¤„ç†
```

---

## 2. ğŸšŒ äº‹ä»¶æ€»çº¿è®¾è®¡


### 2.1 ä»€ä¹ˆæ˜¯äº‹ä»¶æ€»çº¿


**ğŸ”¸ é€šä¿—ç†è§£**
```
äº‹ä»¶æ€»çº¿å°±åƒå…¬äº¤è½¦ç«™ï¼š
- ä¹˜å®¢ï¼ˆäº‹ä»¶ï¼‰åœ¨è½¦ç«™ç­‰è½¦
- å…¬äº¤è½¦ï¼ˆäº‹ä»¶æ€»çº¿ï¼‰è´Ÿè´£è¿é€ä¹˜å®¢
- ä¸åŒè·¯çº¿çš„è½¦ï¼ˆä¸åŒç±»å‹äº‹ä»¶ï¼‰å»å¾€ä¸åŒç›®çš„åœ°
- ä¹˜å®¢ä¸éœ€è¦çŸ¥é“å¸æœºæ˜¯è°ï¼Œå¸æœºä¹Ÿä¸éœ€è¦çŸ¥é“ä¹˜å®¢è¦åšä»€ä¹ˆ

äº‹ä»¶æ€»çº¿ = äº‹ä»¶çš„"è¿è¾“å…¬å¸"
```

**ğŸ“‹ æ ¸å¿ƒèŒè´£**
- **äº‹ä»¶æ¥æ”¶**ï¼šæ¥æ”¶å„ç§äº‹ä»¶
- **äº‹ä»¶è·¯ç”±**ï¼šå°†äº‹ä»¶å‘é€ç»™æ­£ç¡®çš„å¤„ç†è€…
- **äº‹ä»¶ç¼“å­˜**ï¼šä¸´æ—¶å­˜å‚¨äº‹ä»¶
- **å¤±è´¥é‡è¯•**ï¼šå¤„ç†å¤±è´¥æ—¶é‡æ–°å°è¯•

### 2.2 ç®€å•äº‹ä»¶æ€»çº¿å®ç°


**ğŸ”§ åŸºç¡€ç‰ˆæœ¬**
```java
public class SimpleEventBus {
    // å­˜å‚¨äº‹ä»¶ç›‘å¬å™¨
    private Map<Class<?>, List<EventHandler>> handlers = new HashMap<>();
    
    // æ³¨å†Œäº‹ä»¶å¤„ç†å™¨
    public <T> void subscribe(Class<T> eventType, EventHandler<T> handler) {
        handlers.computeIfAbsent(eventType, k -> new ArrayList<>()).add(handler);
    }
    
    // å‘å¸ƒäº‹ä»¶
    public void publish(Object event) {
        Class<?> eventType = event.getClass();
        List<EventHandler> eventHandlers = handlers.get(eventType);
        
        if (eventHandlers != null) {
            for (EventHandler handler : eventHandlers) {
                try {
                    handler.handle(event);
                } catch (Exception e) {
                    // è®°å½•é”™è¯¯ï¼Œç»§ç»­å¤„ç†å…¶ä»–äº‹ä»¶
                    System.err.println("å¤„ç†äº‹ä»¶å¤±è´¥: " + e.getMessage());
                }
            }
        }
    }
}

// äº‹ä»¶å¤„ç†å™¨æ¥å£
@FunctionalInterface
public interface EventHandler<T> {
    void handle(T event);
}
```

**ğŸ¯ ä½¿ç”¨ç¤ºä¾‹**
```java
// å®šä¹‰äº‹ä»¶
public class OrderCreatedEvent {
    private final String orderId;
    private final double amount;
    
    public OrderCreatedEvent(String orderId, double amount) {
        this.orderId = orderId;
        this.amount = amount;
    }
    
    // getters...
}

// ä½¿ç”¨äº‹ä»¶æ€»çº¿
public class EventBusExample {
    public static void main(String[] args) {
        SimpleEventBus eventBus = new SimpleEventBus();
        
        // æ³¨å†Œäº‹ä»¶å¤„ç†å™¨
        eventBus.subscribe(OrderCreatedEvent.class, event -> {
            System.out.println("åº“å­˜æœåŠ¡ï¼šå‡å°‘åº“å­˜ï¼Œè®¢å•å·ï¼š" + event.getOrderId());
        });
        
        eventBus.subscribe(OrderCreatedEvent.class, event -> {
            System.out.println("é‚®ä»¶æœåŠ¡ï¼šå‘é€ç¡®è®¤é‚®ä»¶ï¼Œé‡‘é¢ï¼š" + event.getAmount());
        });
        
        // å‘å¸ƒäº‹ä»¶
        eventBus.publish(new OrderCreatedEvent("ORD-001", 299.99));
    }
}
```

### 2.3 é«˜çº§äº‹ä»¶æ€»çº¿ç‰¹æ€§


**âš¡ å¼‚æ­¥å¤„ç†**
```java
public class AsyncEventBus {
    private ExecutorService executor = Executors.newFixedThreadPool(10);
    private Map<Class<?>, List<EventHandler>> handlers = new HashMap<>();
    
    public void publish(Object event) {
        Class<?> eventType = event.getClass();
        List<EventHandler> eventHandlers = handlers.get(eventType);
        
        if (eventHandlers != null) {
            for (EventHandler handler : eventHandlers) {
                // å¼‚æ­¥å¤„ç†äº‹ä»¶
                executor.submit(() -> {
                    try {
                        handler.handle(event);
                    } catch (Exception e) {
                        handleError(event, e);
                    }
                });
            }
        }
    }
    
    private void handleError(Object event, Exception e) {
        // é”™è¯¯å¤„ç†é€»è¾‘
        System.err.println("å¼‚æ­¥å¤„ç†äº‹ä»¶å¤±è´¥: " + e.getMessage());
    }
}
```

**ğŸ”„ äº‹ä»¶æ€»çº¿æ¶æ„å›¾**
```
åº”ç”¨å±‚
â”œâ”€â”€ è®¢å•æœåŠ¡ â”€â”€â”
â”œâ”€â”€ ç”¨æˆ·æœåŠ¡ â”€â”€â”¤
â””â”€â”€ æ”¯ä»˜æœåŠ¡ â”€â”€â”¤
              â”‚
              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  äº‹ä»¶æ€»çº¿    â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚  â”‚äº‹ä»¶é˜Ÿåˆ—â”‚  â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚  â”‚è·¯ç”±å™¨ â”‚  â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
å¤„ç†å±‚
â”œâ”€â”€ åº“å­˜æœåŠ¡ â”€â”€â”¤
â”œâ”€â”€ é‚®ä»¶æœåŠ¡ â”€â”€â”¤
â””â”€â”€ æ—¥å¿—æœåŠ¡ â”€â”€â”˜
```

---

## 3. ğŸ“® æ¶ˆæ¯é˜Ÿåˆ—åº”ç”¨


### 3.1 æ¶ˆæ¯é˜Ÿåˆ—æ˜¯ä»€ä¹ˆ


**ğŸ”¸ é€šä¿—ç†è§£**
```
æ¶ˆæ¯é˜Ÿåˆ—å°±åƒé‚®å±€ï¼š
- ä½ å†™ä¿¡ï¼ˆå‘é€æ¶ˆæ¯ï¼‰æŠ•åˆ°é‚®ç®±
- é‚®å±€ï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰è´Ÿè´£ä¿ç®¡å’Œä¼ é€’
- æ”¶ä¿¡äººï¼ˆæ¶ˆè´¹è€…ï¼‰ä»é‚®ç®±å–ä¿¡
- å³ä½¿æ”¶ä¿¡äººä¸åœ¨å®¶ï¼Œä¿¡ä¹Ÿä¼šè¢«ä¿å­˜

æ¶ˆæ¯é˜Ÿåˆ— = å¯é çš„"é‚®é€’æœåŠ¡"
```

**ğŸ“‹ æ ¸å¿ƒç‰¹ç‚¹**
- **å¼‚æ­¥é€šä¿¡**ï¼šå‘é€è€…ä¸éœ€è¦ç­‰å¾…æ¥æ”¶è€…ç«‹å³å¤„ç†
- **å¯é ä¼ é€’**ï¼šæ¶ˆæ¯ä¸ä¼šä¸¢å¤±
- **å‰Šå³°å¡«è°·**ï¼šå¹³è¡¡ç³»ç»Ÿè´Ÿè½½
- **è§£è€¦åˆ**ï¼šå‘é€è€…å’Œæ¥æ”¶è€…äº’ä¸ä¾èµ–

### 3.2 æ¶ˆæ¯é˜Ÿåˆ—åœ¨äº‹ä»¶é©±åŠ¨ä¸­çš„ä½œç”¨


**ğŸ¯ ä¸ºä»€ä¹ˆéœ€è¦æ¶ˆæ¯é˜Ÿåˆ—**
```java
// æ²¡æœ‰æ¶ˆæ¯é˜Ÿåˆ—çš„é—®é¢˜
public void handleOrderEvent(OrderEvent event) {
    // å¦‚æœå¤„ç†é‡å¤§ï¼Œç³»ç»Ÿå¯èƒ½å´©æºƒ
    processInventory(event);   // å¯èƒ½å¾ˆæ…¢
    sendEmail(event);          // å¯èƒ½å¤±è´¥
    updateAnalytics(event);    // å¯èƒ½è¶…æ—¶
}

é—®é¢˜ï¼š
âŒ å¤„ç†æ…¢çš„æ“ä½œé˜»å¡æ•´ä¸ªæµç¨‹
âŒ ä¸€ä¸ªå¤±è´¥å¯¼è‡´å…¨éƒ¨å¤±è´¥
âŒ é«˜å³°æœŸç³»ç»Ÿå®¹æ˜“å´©æºƒ
```

**âœ… ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—çš„ä¼˜åŠ¿**
```java
// ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—
public void handleOrderEvent(OrderEvent event) {
    // å¿«é€Ÿå‘é€åˆ°é˜Ÿåˆ—ï¼Œç«‹å³è¿”å›
    messageQueue.send("inventory-queue", event);
    messageQueue.send("email-queue", event);
    messageQueue.send("analytics-queue", event);
}

// å„ä¸ªæœåŠ¡ç‹¬ç«‹å¤„ç†
public class InventoryService {
    @MessageListener("inventory-queue")
    public void handleInventory(OrderEvent event) {
        // ç‹¬ç«‹å¤„ç†ï¼Œä¸å½±å“å…¶ä»–æœåŠ¡
        processInventory(event);
    }
}

ä¼˜åŠ¿ï¼š
âœ… å¿«é€Ÿå“åº”
âœ… æ•…éšœéš”ç¦»
âœ… è‡ªåŠ¨é‡è¯•
âœ… è´Ÿè½½å‡è¡¡
```

### 3.3 å¸¸è§æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å¼


**ğŸ“Š æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å¼å¯¹æ¯”**

| æ¨¡å¼ | **ç‰¹ç‚¹** | **ä½¿ç”¨åœºæ™¯** | **ä¼˜ç¼ºç‚¹** |
|------|---------|-------------|-----------|
| ğŸ”„ **ç‚¹å¯¹ç‚¹** | `ä¸€å¯¹ä¸€é€šä¿¡` | `ä»»åŠ¡åˆ†å‘` | `ç®€å•å¯é ï¼Œä½†æ‰©å±•æ€§å·®` |
| ğŸ“¡ **å‘å¸ƒè®¢é˜…** | `ä¸€å¯¹å¤šå¹¿æ’­` | `äº‹ä»¶é€šçŸ¥` | `çµæ´»æ‰©å±•ï¼Œä½†å¤æ‚åº¦é«˜` |
| ğŸ“ **ä¸»é¢˜åˆ†åŒº** | `åˆ†ç±»å¤„ç†` | `æ—¥å¿—å¤„ç†` | `é«˜ååï¼Œä½†é¡ºåºéš¾ä¿è¯` |

**ğŸ”§ ç®€å•å®ç°ç¤ºä¾‹**
```java
// ç®€å•çš„å†…å­˜æ¶ˆæ¯é˜Ÿåˆ—
public class SimpleMessageQueue {
    private Map<String, Queue<Object>> queues = new HashMap<>();
    private Map<String, List<MessageConsumer>> consumers = new HashMap<>();
    
    // å‘é€æ¶ˆæ¯
    public void send(String queueName, Object message) {
        queues.computeIfAbsent(queueName, k -> new LinkedList<>()).offer(message);
        notifyConsumers(queueName);
    }
    
    // æ³¨å†Œæ¶ˆè´¹è€…
    public void subscribe(String queueName, MessageConsumer consumer) {
        consumers.computeIfAbsent(queueName, k -> new ArrayList<>()).add(consumer);
    }
    
    // é€šçŸ¥æ¶ˆè´¹è€…å¤„ç†æ¶ˆæ¯
    private void notifyConsumers(String queueName) {
        Queue<Object> queue = queues.get(queueName);
        List<MessageConsumer> queueConsumers = consumers.get(queueName);
        
        if (queue != null && queueConsumers != null && !queue.isEmpty()) {
            Object message = queue.poll();
            for (MessageConsumer consumer : queueConsumers) {
                try {
                    consumer.consume(message);
                } catch (Exception e) {
                    // å¤„ç†å¤±è´¥ï¼Œå¯ä»¥é‡æ–°æ”¾å›é˜Ÿåˆ—
                    queue.offer(message);
                    break;
                }
            }
        }
    }
}
```

---

## 4. ğŸ“¡ å‘å¸ƒè®¢é˜…æ¶æ„


### 4.1 å‘å¸ƒè®¢é˜…æ¨¡å¼åŸç†


**ğŸ”¸ é€šä¿—ç†è§£**
```
å‘å¸ƒè®¢é˜…å°±åƒè®¢é˜…æŠ¥çº¸ï¼š
- æŠ¥ç¤¾ï¼ˆå‘å¸ƒè€…ï¼‰å°åˆ·æŠ¥çº¸
- ä½ è®¢é˜…äº†ä½“è‚²æŠ¥ï¼ˆè®¢é˜…ä¸»é¢˜ï¼‰
- é‚®é€’å‘˜ï¼ˆæ¶ˆæ¯ä¸­é—´ä»¶ï¼‰æ¯å¤©é€æŠ¥çº¸ç»™ä½ 
- ä½ ä¸éœ€è¦çŸ¥é“æŠ¥ç¤¾åœ¨å“ªï¼ŒæŠ¥ç¤¾ä¹Ÿä¸çŸ¥é“ä½ æ˜¯è°

æ ¸å¿ƒï¼šå‘å¸ƒè€…å’Œè®¢é˜…è€…å®Œå…¨ä¸çŸ¥é“å¯¹æ–¹çš„å­˜åœ¨
```

**ğŸ“‹ æ ¸å¿ƒç»„ä»¶**
```
å‘å¸ƒè€…ï¼ˆPublisherï¼‰ï¼šå‘å¸ƒæ¶ˆæ¯çš„ç»„ä»¶
     â†“
ä¸»é¢˜ï¼ˆTopicï¼‰ï¼šæ¶ˆæ¯çš„åˆ†ç±»æ ‡ç­¾
     â†“
è®¢é˜…è€…ï¼ˆSubscriberï¼‰ï¼šæ¥æ”¶æ¶ˆæ¯çš„ç»„ä»¶

æµç¨‹ï¼š
1. è®¢é˜…è€…è®¢é˜…æ„Ÿå…´è¶£çš„ä¸»é¢˜
2. å‘å¸ƒè€…å‘ä¸»é¢˜å‘å¸ƒæ¶ˆæ¯  
3. ç³»ç»Ÿè‡ªåŠ¨å°†æ¶ˆæ¯æ¨é€ç»™æ‰€æœ‰è®¢é˜…è€…
```

### 4.2 å‘å¸ƒè®¢é˜…æ¶æ„å®ç°


**ğŸ”§ åŸºç¡€å®ç°**
```java
public class PubSubSystem {
    // ä¸»é¢˜ -> è®¢é˜…è€…åˆ—è¡¨
    private Map<String, List<Subscriber>> subscribers = new HashMap<>();
    
    // è®¢é˜…ä¸»é¢˜
    public void subscribe(String topic, Subscriber subscriber) {
        subscribers.computeIfAbsent(topic, k -> new ArrayList<>()).add(subscriber);
        System.out.println("è®¢é˜…æˆåŠŸï¼š" + topic);
    }
    
    // å–æ¶ˆè®¢é˜…
    public void unsubscribe(String topic, Subscriber subscriber) {
        List<Subscriber> topicSubscribers = subscribers.get(topic);
        if (topicSubscribers != null) {
            topicSubscribers.remove(subscriber);
        }
    }
    
    // å‘å¸ƒæ¶ˆæ¯
    public void publish(String topic, Object message) {
        List<Subscriber> topicSubscribers = subscribers.get(topic);
        if (topicSubscribers != null) {
            for (Subscriber subscriber : topicSubscribers) {
                try {
                    subscriber.onMessage(topic, message);
                } catch (Exception e) {
                    System.err.println("è®¢é˜…è€…å¤„ç†å¤±è´¥: " + e.getMessage());
                }
            }
        }
        System.out.println("å‘å¸ƒæ¶ˆæ¯åˆ°ä¸»é¢˜ " + topic + ": " + message);
    }
}

// è®¢é˜…è€…æ¥å£
@FunctionalInterface
public interface Subscriber {
    void onMessage(String topic, Object message);
}
```

**ğŸ¯ å®é™…ä½¿ç”¨ç¤ºä¾‹**
```java
public class PubSubExample {
    public static void main(String[] args) {
        PubSubSystem pubSub = new PubSubSystem();
        
        // è®¢é˜…è€…1ï¼šåº“å­˜æœåŠ¡
        Subscriber inventoryService = (topic, message) -> {
            if ("order.created".equals(topic)) {
                System.out.println("åº“å­˜æœåŠ¡ï¼šå¤„ç†è®¢å• " + message);
            }
        };
        
        // è®¢é˜…è€…2ï¼šé‚®ä»¶æœåŠ¡
        Subscriber emailService = (topic, message) -> {
            if ("order.created".equals(topic)) {
                System.out.println("é‚®ä»¶æœåŠ¡ï¼šå‘é€ç¡®è®¤é‚®ä»¶ " + message);
            }
        };
        
        // è®¢é˜…è€…3ï¼šç§¯åˆ†æœåŠ¡
        Subscriber pointService = (topic, message) -> {
            if ("order.created".equals(topic)) {
                System.out.println("ç§¯åˆ†æœåŠ¡ï¼šå¢åŠ ç§¯åˆ† " + message);
            }
        };
        
        // æ³¨å†Œè®¢é˜…
        pubSub.subscribe("order.created", inventoryService);
        pubSub.subscribe("order.created", emailService);
        pubSub.subscribe("order.created", pointService);
        
        // å‘å¸ƒäº‹ä»¶
        pubSub.publish("order.created", "è®¢å•å·ï¼šORD-12345");
        
        // è¾“å‡ºï¼š
        // åº“å­˜æœåŠ¡ï¼šå¤„ç†è®¢å• è®¢å•å·ï¼šORD-12345
        // é‚®ä»¶æœåŠ¡ï¼šå‘é€ç¡®è®¤é‚®ä»¶ è®¢å•å·ï¼šORD-12345
        // ç§¯åˆ†æœåŠ¡ï¼šå¢åŠ ç§¯åˆ† è®¢å•å·ï¼šORD-12345
    }
}
```

### 4.3 é«˜çº§å‘å¸ƒè®¢é˜…ç‰¹æ€§


**âš¡ ä¸»é¢˜å±‚æ¬¡ç»“æ„**
```java
// æ”¯æŒå±‚æ¬¡åŒ–ä¸»é¢˜
public class HierarchicalPubSub {
    
    public void subscribe(String topicPattern, Subscriber subscriber) {
        // æ”¯æŒé€šé…ç¬¦è®¢é˜…
        // "order.*" å¯ä»¥æ¥æ”¶ "order.created", "order.cancelled" ç­‰
        // "order.created.*" å¯ä»¥æ¥æ”¶ "order.created.inventory", "order.created.email" ç­‰
    }
    
    public void publish(String topic, Object message) {
        // æ ¹æ®ä¸»é¢˜å±‚æ¬¡ç»“æ„åˆ†å‘æ¶ˆæ¯
        notifyMatchingSubscribers(topic, message);
    }
    
    private void notifyMatchingSubscribers(String topic, Object message) {
        // æŸ¥æ‰¾æ‰€æœ‰åŒ¹é…çš„è®¢é˜…è€…
        // ä¾‹å¦‚ï¼šå‘å¸ƒ "order.created" æ¶ˆæ¯æ—¶
        // "order.*" å’Œ "order.created" çš„è®¢é˜…è€…éƒ½ä¼šæ”¶åˆ°
    }
}
```

**ğŸ“Š å‘å¸ƒè®¢é˜…æ¶æ„å›¾**
```
å‘å¸ƒè€…å±‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è®¢å•æœåŠ¡    â”‚  â”‚  ç”¨æˆ·æœåŠ¡    â”‚  â”‚  æ”¯ä»˜æœåŠ¡    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                â”‚                â”‚
       â–¼                â–¼                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å‘å¸ƒè®¢é˜…ä¸­å¿ƒ                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚order.*   â”‚ â”‚user.*    â”‚ â”‚payment.* â”‚      â”‚
â”‚  â”‚ä¸»é¢˜      â”‚ â”‚ä¸»é¢˜      â”‚ â”‚ä¸»é¢˜      â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                â”‚                â”‚
       â–¼                â–¼                â–¼
è®¢é˜…è€…å±‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åº“å­˜æœåŠ¡    â”‚  â”‚  é‚®ä»¶æœåŠ¡    â”‚  â”‚  æ—¥å¿—æœåŠ¡    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. ğŸ”„ CQRSæ¨¡å¼


### 5.1 ä»€ä¹ˆæ˜¯CQRS


**ğŸ”¸ é€šä¿—ç†è§£**
```
CQRS = Command Query Responsibility Segregation
ä¸­æ–‡ï¼šå‘½ä»¤æŸ¥è¯¢èŒè´£åˆ†ç¦»

å°±åƒå›¾ä¹¦é¦†çš„ä¸¤ä¸ªçª—å£ï¼š
- å€Ÿä¹¦çª—å£ï¼ˆå†™æ“ä½œï¼‰ï¼šä¸“é—¨å¤„ç†å€Ÿä¹¦ã€è¿˜ä¹¦ç­‰ä¿®æ”¹æ“ä½œ
- æŸ¥è¯¢çª—å£ï¼ˆè¯»æ“ä½œï¼‰ï¼šä¸“é—¨å¤„ç†æŸ¥ä¹¦ã€æŸ¥ä¿¡æ¯ç­‰æŸ¥è¯¢æ“ä½œ
- ä¸¤ä¸ªçª—å£åˆ†å·¥æ˜ç¡®ï¼Œäº’ä¸å¹²æ‰°ï¼Œæ•ˆç‡æ›´é«˜

CQRSï¼šæŠŠæ•°æ®çš„"å†™"å’Œ"è¯»"åˆ†å¼€å¤„ç†
```

**ğŸ“‹ æ ¸å¿ƒæ€æƒ³**
- **å‘½ä»¤ï¼ˆCommandï¼‰**ï¼šä¿®æ”¹æ•°æ®çš„æ“ä½œï¼ˆå¢åˆ æ”¹ï¼‰
- **æŸ¥è¯¢ï¼ˆQueryï¼‰**ï¼šè¯»å–æ•°æ®çš„æ“ä½œï¼ˆæŸ¥ï¼‰
- **èŒè´£åˆ†ç¦»**ï¼šå†™å’Œè¯»ä½¿ç”¨ä¸åŒçš„æ¨¡å‹
- **æ€§èƒ½ä¼˜åŒ–**ï¼šé’ˆå¯¹æ€§ä¼˜åŒ–è¯»å†™æ€§èƒ½

### 5.2 ä¸ºä»€ä¹ˆéœ€è¦CQRS


**ğŸ¯ ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜**
```java
// ä¼ ç»Ÿçš„å•ä¸€æ¨¡å‹
public class OrderService {
    
    // æ—¢è¦æ”¯æŒå¤æ‚çš„å†™æ“ä½œ
    public void createOrder(CreateOrderCommand cmd) {
        // å¤æ‚çš„ä¸šåŠ¡é€»è¾‘
        validateOrder(cmd);
        calculatePrice(cmd);
        checkInventory(cmd);
        saveOrder(cmd);
        updateInventory(cmd);
        // ... å¾ˆå¤šå†™æ“ä½œé€»è¾‘
    }
    
    // åˆè¦æ”¯æŒå¤æ‚çš„æŸ¥è¯¢
    public OrderView getOrderDetails(String orderId) {
        // éœ€è¦å…³è”å¾ˆå¤šè¡¨
        Order order = orderRepo.findById(orderId);
        Customer customer = customerRepo.findById(order.getCustomerId());
        List<OrderItem> items = itemRepo.findByOrderId(orderId);
        // ... å¤æ‚çš„æŸ¥è¯¢é€»è¾‘
        return buildOrderView(order, customer, items);
    }
}

é—®é¢˜ï¼š
âŒ è¯»å†™éœ€æ±‚å†²çªï¼ˆå†™è¦ä¸€è‡´æ€§ï¼Œè¯»è¦æ€§èƒ½ï¼‰
âŒ æ¨¡å‹å¤æ‚éš¾ç»´æŠ¤
âŒ éš¾ä»¥ç‹¬ç«‹ä¼˜åŒ–
âŒ æ‰©å±•æ€§å·®
```

**âœ… CQRSçš„è§£å†³æ–¹æ¡ˆ**
```java
// å‘½ä»¤ç«¯ï¼šä¸“æ³¨å†™æ“ä½œ
public class OrderCommandService {
    public void handle(CreateOrderCommand cmd) {
        // ä¸“æ³¨ä¸šåŠ¡é€»è¾‘ï¼Œä¸è€ƒè™‘æŸ¥è¯¢éœ€æ±‚
        Order order = new Order(cmd);
        order.validate();
        order.calculateTotal();
        orderRepository.save(order);
        
        // å‘å¸ƒäº‹ä»¶ç»™æŸ¥è¯¢ç«¯
        eventBus.publish(new OrderCreatedEvent(order));
    }
}

// æŸ¥è¯¢ç«¯ï¼šä¸“æ³¨è¯»æ“ä½œ
public class OrderQueryService {
    public OrderView getOrderView(String orderId) {
        // ä¸“æ³¨æŸ¥è¯¢æ€§èƒ½ï¼Œä½¿ç”¨ä¼˜åŒ–çš„æ•°æ®ç»“æ„
        return orderViewRepository.findById(orderId);
    }
    
    @EventHandler
    public void handle(OrderCreatedEvent event) {
        // æ„å»ºæŸ¥è¯¢ä¸“ç”¨çš„æ•°æ®è§†å›¾
        OrderView view = new OrderView(event);
        orderViewRepository.save(view);
    }
}
```

### 5.3 CQRSå®ç°ç¤ºä¾‹


**ğŸ”§ å®Œæ•´ç¤ºä¾‹**
```java
// å‘½ä»¤å®šä¹‰
public class CreateOrderCommand {
    private String customerId;
    private List<OrderItem> items;
    // getters, setters...
}

// å‘½ä»¤å¤„ç†å™¨
@Component
public class OrderCommandHandler {
    private OrderRepository orderRepo;
    private EventBus eventBus;
    
    public void handle(CreateOrderCommand command) {
        // 1. ä¸šåŠ¡é€»è¾‘å¤„ç†
        Order order = Order.create(command);
        order.validate();
        
        // 2. ä¿å­˜åˆ°å†™åº“
        orderRepo.save(order);
        
        // 3. å‘å¸ƒäº‹ä»¶
        eventBus.publish(new OrderCreatedEvent(order.getId(), order.getCustomerId(), 
                                              order.getTotal(), order.getItems()));
    }
}

// æŸ¥è¯¢æ¨¡å‹
public class OrderView {
    private String orderId;
    private String customerName;  // å·²ç»å…³è”å¥½å®¢æˆ·ä¿¡æ¯
    private BigDecimal total;
    private String status;
    private List<OrderItemView> items;  // å·²ç»å…³è”å¥½å•†å“ä¿¡æ¯
    // getters, setters...
}

// æŸ¥è¯¢å¤„ç†å™¨
@Component
public class OrderQueryHandler {
    private OrderViewRepository viewRepo;
    
    public OrderView getOrder(String orderId) {
        return viewRepo.findById(orderId);
    }
    
    public List<OrderView> getCustomerOrders(String customerId) {
        return viewRepo.findByCustomerId(customerId);
    }
    
    // ç›‘å¬äº‹ä»¶ï¼Œæ›´æ–°æŸ¥è¯¢æ¨¡å‹
    @EventHandler
    public void handle(OrderCreatedEvent event) {
        OrderView view = new OrderView();
        view.setOrderId(event.getOrderId());
        // ä»å…¶ä»–æœåŠ¡è·å–å®¢æˆ·ä¿¡æ¯ï¼Œæ„å»ºå®Œæ•´è§†å›¾
        Customer customer = customerService.getCustomer(event.getCustomerId());
        view.setCustomerName(customer.getName());
        view.setTotal(event.getTotal());
        // ...
        viewRepo.save(view);
    }
}
```

**ğŸ“Š CQRSæ¶æ„å›¾**
```
å‰ç«¯åº”ç”¨
    â”‚
    â”œâ”€å†™è¯·æ±‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                      â”‚
    â–¼                      â–¼
å‘½ä»¤ç«¯ï¼ˆå†™ï¼‰              æŸ¥è¯¢ç«¯ï¼ˆè¯»ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚å‘½ä»¤å¤„ç†å™¨    â”‚           â”‚æŸ¥è¯¢å¤„ç†å™¨    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ä¸šåŠ¡æ¨¡å‹      â”‚           â”‚æŸ¥è¯¢æ¨¡å‹      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚å†™æ•°æ®åº“      â”‚â”€â”€äº‹ä»¶â”€â”€â–¶  â”‚è¯»æ•°æ®åº“      â”‚
â”‚(å…³ç³»å‹)      â”‚           â”‚(æ–‡æ¡£/ç¼“å­˜)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.4 CQRSçš„ä¼˜ç¼ºç‚¹


**âœ… ä¼˜åŠ¿**
- **æ€§èƒ½ä¼˜åŒ–**ï¼šè¯»å†™åˆ†åˆ«ä¼˜åŒ–ï¼ŒæŸ¥è¯¢æ›´å¿«
- **ç‹¬ç«‹æ‰©å±•**ï¼šè¯»å†™å¯ä»¥ç‹¬ç«‹æ‰©å±•
- **æ¨¡å‹æ¸…æ™°**ï¼šèŒè´£åˆ†ç¦»ï¼Œä»£ç æ›´æ¸…æ™°
- **æŠ€æœ¯é€‰æ‹©**ï¼šè¯»å†™å¯ä»¥é€‰æ‹©ä¸åŒæŠ€æœ¯æ ˆ

**âŒ æŒ‘æˆ˜**
- **å¤æ‚æ€§å¢åŠ **ï¼šéœ€è¦ç»´æŠ¤ä¸¤å¥—æ¨¡å‹
- **æ•°æ®ä¸€è‡´æ€§**ï¼šæœ€ç»ˆä¸€è‡´æ€§ï¼Œä¸æ˜¯å¼ºä¸€è‡´
- **å­¦ä¹ æˆæœ¬**ï¼šå›¢é˜Ÿéœ€è¦ç†è§£æ–°æ¶æ„
- **è°ƒè¯•å›°éš¾**ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿè°ƒè¯•å¤æ‚

---

## 6. ğŸ“š äº‹ä»¶æº¯æº


### 6.1 ä»€ä¹ˆæ˜¯äº‹ä»¶æº¯æº


**ğŸ”¸ é€šä¿—ç†è§£**
```
äº‹ä»¶æº¯æºå°±åƒé“¶è¡Œçš„æµæ°´è´¦ï¼š
- ä¼ ç»Ÿæ–¹å¼ï¼šåªè®°å½•è´¦æˆ·ä½™é¢ï¼ˆå½“å‰çŠ¶æ€ï¼‰
- äº‹ä»¶æº¯æºï¼šè®°å½•æ¯ä¸€ç¬”äº¤æ˜“ï¼ˆæ‰€æœ‰äº‹ä»¶ï¼‰

é“¶è¡Œæµæ°´ç¤ºä¾‹ï¼š
åˆå§‹ä½™é¢ï¼š0å…ƒ
äº‹ä»¶1ï¼šå­˜å…¥1000å…ƒ â†’ ä½™é¢1000å…ƒ  
äº‹ä»¶2ï¼šæ”¯å‡º200å…ƒ â†’ ä½™é¢800å…ƒ
äº‹ä»¶3ï¼šå­˜å…¥500å…ƒ â†’ ä½™é¢1300å…ƒ

ä»»ä½•æ—¶å€™éƒ½å¯ä»¥é‡æ–°è®¡ç®—å½“å‰ä½™é¢ï¼Œä¹Ÿå¯ä»¥æŸ¥çœ‹å†å²çŠ¶æ€
```

**ğŸ“‹ æ ¸å¿ƒæ¦‚å¿µ**
- **äº‹ä»¶å­˜å‚¨**ï¼šæ‰€æœ‰æ”¹å˜éƒ½è®°å½•ä¸ºäº‹ä»¶
- **çŠ¶æ€é‡å»º**ï¼šé€šè¿‡å›æ”¾äº‹ä»¶é‡å»ºå½“å‰çŠ¶æ€
- **æ—¶é—´æ—…è¡Œ**ï¼šå¯ä»¥æŸ¥çœ‹ä»»æ„æ—¶é—´ç‚¹çš„çŠ¶æ€
- **ä¸å¯å˜æ€§**ï¼šäº‹ä»¶ä¸€æ—¦è®°å½•å°±ä¸èƒ½ä¿®æ”¹

### 6.2 ä¸ºä»€ä¹ˆä½¿ç”¨äº‹ä»¶æº¯æº


**ğŸ¯ ä¼ ç»Ÿæ–¹å¼çš„å±€é™**
```java
// ä¼ ç»Ÿæ–¹å¼ï¼šåªä¿å­˜å½“å‰çŠ¶æ€
public class Account {
    private String id;
    private BigDecimal balance;  // åªçŸ¥é“å½“å‰ä½™é¢
    
    public void withdraw(BigDecimal amount) {
        this.balance = this.balance.subtract(amount);
        // ä¸¢å¤±äº†å–æ¬¾çš„å†å²ä¿¡æ¯
    }
}

é—®é¢˜ï¼š
âŒ æ— æ³•çŸ¥é“ä½™é¢å¦‚ä½•å˜åŒ–çš„
âŒ æ— æ³•å®¡è®¡å†å²æ“ä½œ
âŒ æ— æ³•å›æ»šåˆ°å†å²çŠ¶æ€
âŒ è°ƒè¯•å›°éš¾
```

**âœ… äº‹ä»¶æº¯æºçš„ä¼˜åŠ¿**
```java
// äº‹ä»¶æº¯æºï¼šè®°å½•æ‰€æœ‰å˜åŒ–äº‹ä»¶
public class AccountEvents {
    public static class AccountOpened {
        private String accountId;
        private BigDecimal initialBalance;
    }
    
    public static class MoneyDeposited {
        private String accountId;
        private BigDecimal amount;
        private LocalDateTime timestamp;
    }
    
    public static class MoneyWithdrawn {
        private String accountId;
        private BigDecimal amount;
        private LocalDateTime timestamp;
    }
}

// é€šè¿‡äº‹ä»¶é‡å»ºçŠ¶æ€
public class Account {
    private String id;
    private BigDecimal balance = BigDecimal.ZERO;
    
    // åº”ç”¨äº‹ä»¶æ¥æ”¹å˜çŠ¶æ€
    public void apply(AccountOpened event) {
        this.id = event.getAccountId();
        this.balance = event.getInitialBalance();
    }
    
    public void apply(MoneyDeposited event) {
        this.balance = this.balance.add(event.getAmount());
    }
    
    public void apply(MoneyWithdrawn event) {
        this.balance = this.balance.subtract(event.getAmount());
    }
}
```

### 6.3 äº‹ä»¶æº¯æºå®ç°


**ğŸ”§ äº‹ä»¶å­˜å‚¨å®ç°**
```java
// äº‹ä»¶å­˜å‚¨æ¥å£
public interface EventStore {
    void saveEvents(String aggregateId, List<Event> events, int expectedVersion);
    List<Event> getEvents(String aggregateId);
    List<Event> getEvents(String aggregateId, int fromVersion);
}

// ç®€å•çš„å†…å­˜äº‹ä»¶å­˜å‚¨
public class InMemoryEventStore implements EventStore {
    private Map<String, List<Event>> events = new HashMap<>();
    
    @Override
    public void saveEvents(String aggregateId, List<Event> newEvents, int expectedVersion) {
        List<Event> existingEvents = events.computeIfAbsent(aggregateId, k -> new ArrayList<>());
        
        // æ£€æŸ¥ç‰ˆæœ¬å†²çª
        if (existingEvents.size() != expectedVersion) {
            throw new ConcurrencyException("ç‰ˆæœ¬å†²çª");
        }
        
        // æ·»åŠ æ–°äº‹ä»¶
        existingEvents.addAll(newEvents);
        
        System.out.println("ä¿å­˜äº‹ä»¶ï¼š" + aggregateId + " -> " + newEvents.size() + "ä¸ªäº‹ä»¶");
    }
    
    @Override
    public List<Event> getEvents(String aggregateId) {
        return events.getOrDefault(aggregateId, new ArrayList<>());
    }
    
    @Override
    public List<Event> getEvents(String aggregateId, int fromVersion) {
        List<Event> allEvents = getEvents(aggregateId);
        return allEvents.subList(fromVersion, allEvents.size());
    }
}

// èšåˆæ ¹åŸºç±»
public abstract class AggregateRoot {
    protected String id;
    protected int version = 0;
    private List<Event> uncommittedEvents = new ArrayList<>();
    
    // åº”ç”¨äº‹ä»¶ï¼ˆé‡å»ºçŠ¶æ€æ—¶ä½¿ç”¨ï¼‰
    public void loadFromHistory(List<Event> events) {
        for (Event event : events) {
            applyEvent(event);
            this.version++;
        }
    }
    
    // äº§ç”Ÿæ–°äº‹ä»¶ï¼ˆä¸šåŠ¡æ“ä½œæ—¶ä½¿ç”¨ï¼‰
    protected void raiseEvent(Event event) {
        applyEvent(event);
        uncommittedEvents.add(event);
        this.version++;
    }
    
    // è·å–æœªæäº¤çš„äº‹ä»¶
    public List<Event> getUncommittedEvents() {
        return new ArrayList<>(uncommittedEvents);
    }
    
    // æ ‡è®°äº‹ä»¶å·²æäº¤
    public void markEventsAsCommitted() {
        uncommittedEvents.clear();
    }
    
    protected abstract void applyEvent(Event event);
}
```

**ğŸ¯ é“¶è¡Œè´¦æˆ·ç¤ºä¾‹**
```java
// é“¶è¡Œè´¦æˆ·èšåˆ
public class BankAccount extends AggregateRoot {
    private BigDecimal balance = BigDecimal.ZERO;
    private boolean isOpen = false;
    
    // ä¸šåŠ¡æ–¹æ³•ï¼šå¼€æˆ·
    public static BankAccount openAccount(String accountId, BigDecimal initialBalance) {
        BankAccount account = new BankAccount();
        account.raiseEvent(new AccountOpenedEvent(accountId, initialBalance));
        return account;
    }
    
    // ä¸šåŠ¡æ–¹æ³•ï¼šå­˜æ¬¾
    public void deposit(BigDecimal amount) {
        if (!isOpen) throw new IllegalStateException("è´¦æˆ·æœªå¼€é€š");
        if (amount.compareTo(BigDecimal.ZERO) <= 0) throw new IllegalArgumentException("é‡‘é¢å¿…é¡»å¤§äº0");
        
        raiseEvent(new MoneyDepositedEvent(this.id, amount));
    }
    
    // ä¸šåŠ¡æ–¹æ³•ï¼šå–æ¬¾
    public void withdraw(BigDecimal amount) {
        if (!isOpen) throw new IllegalStateException("è´¦æˆ·æœªå¼€é€š");
        if (amount.compareTo(BigDecimal.ZERO) <= 0) throw new IllegalArgumentException("é‡‘é¢å¿…é¡»å¤§äº0");
        if (balance.compareTo(amount) < 0) throw new IllegalStateException("ä½™é¢ä¸è¶³");
        
        raiseEvent(new MoneyWithdrawnEvent(this.id, amount));
    }
    
    // åº”ç”¨äº‹ä»¶æ”¹å˜çŠ¶æ€
    @Override
    protected void applyEvent(Event event) {
        if (event instanceof AccountOpenedEvent) {
            AccountOpenedEvent e = (AccountOpenedEvent) event;
            this.id = e.getAccountId();
            this.balance = e.getInitialBalance();
            this.isOpen = true;
        } else if (event instanceof MoneyDepositedEvent) {
            MoneyDepositedEvent e = (MoneyDepositedEvent) event;
            this.balance = this.balance.add(e.getAmount());
        } else if (event instanceof MoneyWithdrawnEvent) {
            MoneyWithdrawnEvent e = (MoneyWithdrawnEvent) event;
            this.balance = this.balance.subtract(e.getAmount());
        }
    }
    
    public BigDecimal getBalance() { return balance; }
    public boolean isOpen() { return isOpen; }
}

// ä½¿ç”¨ç¤ºä¾‹
public class EventSourcingExample {
    public static void main(String[] args) {
        EventStore eventStore = new InMemoryEventStore();
        
        // åˆ›å»ºè´¦æˆ·
        BankAccount account = BankAccount.openAccount("ACC-001", new BigDecimal("1000"));
        account.deposit(new BigDecimal("500"));
        account.withdraw(new BigDecimal("200"));
        
        // ä¿å­˜äº‹ä»¶
        eventStore.saveEvents(account.getId(), account.getUncommittedEvents(), 0);
        account.markEventsAsCommitted();
        
        System.out.println("å½“å‰ä½™é¢ï¼š" + account.getBalance());  // 1300
        
        // ä»äº‹ä»¶é‡å»ºè´¦æˆ·çŠ¶æ€
        BankAccount rebuiltAccount = new BankAccount();
        List<Event> history = eventStore.getEvents("ACC-001");
        rebuiltAccount.loadFromHistory(history);
        
        System.out.println("é‡å»ºåä½™é¢ï¼š" + rebuiltAccount.getBalance());  // 1300
    }
}
```

### 6.4 äº‹ä»¶æº¯æºçš„é«˜çº§ç‰¹æ€§


**ğŸ“Š å¿«ç…§ä¼˜åŒ–**
```java
// å¯¹äºäº‹ä»¶å¾ˆå¤šçš„èšåˆï¼Œå¯ä»¥å®šæœŸåˆ›å»ºå¿«ç…§
public class SnapshotStore {
    private Map<String, Snapshot> snapshots = new HashMap<>();
    
    public void saveSnapshot(String aggregateId, Object state, int version) {
        snapshots.put(aggregateId, new Snapshot(state, version));
    }
    
    public Snapshot getSnapshot(String aggregateId) {
        return snapshots.get(aggregateId);
    }
}

// ä½¿ç”¨å¿«ç…§å¿«é€Ÿé‡å»ºçŠ¶æ€
public BankAccount loadFromSnapshot(String accountId) {
    Snapshot snapshot = snapshotStore.getSnapshot(accountId);
    if (snapshot != null) {
        BankAccount account = (BankAccount) snapshot.getState();
        
        // åªéœ€è¦åº”ç”¨å¿«ç…§ä¹‹åçš„äº‹ä»¶
        List<Event> recentEvents = eventStore.getEvents(accountId, snapshot.getVersion());
        account.loadFromHistory(recentEvents);
        
        return account;
    } else {
        // æ²¡æœ‰å¿«ç…§ï¼Œä»å¤´é‡å»º
        return loadFromHistory(accountId);
    }
}
```

**â° æ—¶é—´æ—…è¡ŒæŸ¥è¯¢**
```java
public class TimeQueryService {
    
    // æŸ¥è¯¢æŒ‡å®šæ—¶é—´ç‚¹çš„è´¦æˆ·çŠ¶æ€
    public BankAccount getAccountAtTime(String accountId, LocalDateTime timestamp) {
        List<Event> allEvents = eventStore.getEvents(accountId);
        
        // è¿‡æ»¤å‡ºæŒ‡å®šæ—¶é—´ä¹‹å‰çš„äº‹ä»¶
        List<Event> eventsUntilTime = allEvents.stream()
            .filter(event -> event.getTimestamp().isBefore(timestamp))
            .collect(Collectors.toList());
        
        // é‡å»ºé‚£ä¸ªæ—¶é—´ç‚¹çš„çŠ¶æ€
        BankAccount account = new BankAccount();
        account.loadFromHistory(eventsUntilTime);
        
        return account;
    }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 äº‹ä»¶é©±åŠ¨æ¶æ„æ ¸å¿ƒç†å¿µ


```
ğŸ”¸ äº‹ä»¶é©±åŠ¨ï¼šç³»ç»Ÿé€šè¿‡äº‹ä»¶æ¥åè°ƒå„ä¸ªç»„ä»¶çš„å·¥ä½œ
ğŸ”¸ æ¾è€¦åˆï¼šç»„ä»¶é—´é€šè¿‡äº‹ä»¶é€šä¿¡ï¼Œå‡å°‘ç›´æ¥ä¾èµ–
ğŸ”¸ å¼‚æ­¥å¤„ç†ï¼šæé«˜ç³»ç»Ÿå“åº”æ€§å’Œååé‡
ğŸ”¸ å¯æ‰©å±•æ€§ï¼šå®¹æ˜“æ·»åŠ æ–°åŠŸèƒ½è€Œä¸å½±å“ç°æœ‰ä»£ç 
ğŸ”¸ æ•…éšœéš”ç¦»ï¼šä¸€ä¸ªç»„ä»¶æ•…éšœä¸ä¼šå½±å“æ•´ä¸ªç³»ç»Ÿ
```

### 7.2 äº”å¤§æ ¸å¿ƒç»„ä»¶


**ğŸšŒ äº‹ä»¶æ€»çº¿è®¾è®¡**
```
ä½œç”¨ï¼šäº‹ä»¶çš„ä¸­å¤®è°ƒåº¦å™¨
æ ¸å¿ƒåŠŸèƒ½ï¼šæ¥æ”¶ã€è·¯ç”±ã€åˆ†å‘äº‹ä»¶
å®ç°è¦ç‚¹ï¼šæ”¯æŒå¼‚æ­¥ã€é”™è¯¯å¤„ç†ã€ç›‘æ§
ä½¿ç”¨åœºæ™¯ï¼šå†…éƒ¨ç»„ä»¶é€šä¿¡ã€æ¨¡å—è§£è€¦
```

**ğŸ“® æ¶ˆæ¯é˜Ÿåˆ—åº”ç”¨**
```
ä½œç”¨ï¼šå¯é çš„å¼‚æ­¥æ¶ˆæ¯ä¼ é€’
æ ¸å¿ƒåŠŸèƒ½ï¼šæ¶ˆæ¯æŒä¹…åŒ–ã€å‰Šå³°å¡«è°·ã€æ•…éšœé‡è¯•
å®ç°è¦ç‚¹ï¼šæŒä¹…åŒ–ã€é¡ºåºä¿è¯ã€é‡å¤å¤„ç†
ä½¿ç”¨åœºæ™¯ï¼šè·¨æœåŠ¡é€šä¿¡ã€é«˜å³°å¤„ç†ã€ä»»åŠ¡è°ƒåº¦
```

**ğŸ“¡ å‘å¸ƒè®¢é˜…æ¶æ„**
```
ä½œç”¨ï¼šä¸€å¯¹å¤šçš„æ¶ˆæ¯åˆ†å‘æ¨¡å¼
æ ¸å¿ƒåŠŸèƒ½ï¼šä¸»é¢˜ç®¡ç†ã€è®¢é˜…ç®¡ç†ã€æ¶ˆæ¯å¹¿æ’­
å®ç°è¦ç‚¹ï¼šä¸»é¢˜å±‚æ¬¡ã€åŠ¨æ€è®¢é˜…ã€è¿‡æ»¤æœºåˆ¶
ä½¿ç”¨åœºæ™¯ï¼šäº‹ä»¶é€šçŸ¥ã€å¹¿æ’­æ¶ˆæ¯ã€æ’ä»¶ç³»ç»Ÿ
```

**ğŸ”„ CQRSæ¨¡å¼**
```
ä½œç”¨ï¼šè¯»å†™åˆ†ç¦»çš„æ¶æ„æ¨¡å¼
æ ¸å¿ƒåŠŸèƒ½ï¼šå‘½ä»¤å¤„ç†ã€æŸ¥è¯¢ä¼˜åŒ–ã€æ¨¡å‹åˆ†ç¦»
å®ç°è¦ç‚¹ï¼šæ•°æ®åŒæ­¥ã€ä¸€è‡´æ€§ä¿è¯ã€æ€§èƒ½ä¼˜åŒ–
ä½¿ç”¨åœºæ™¯ï¼šå¤æ‚æŸ¥è¯¢ã€é«˜å¹¶å‘ã€æ€§èƒ½ä¼˜åŒ–
```

**ğŸ“š äº‹ä»¶æº¯æº**
```
ä½œç”¨ï¼šåŸºäºäº‹ä»¶çš„çŠ¶æ€ç®¡ç†
æ ¸å¿ƒåŠŸèƒ½ï¼šäº‹ä»¶å­˜å‚¨ã€çŠ¶æ€é‡å»ºã€å†å²æŸ¥è¯¢
å®ç°è¦ç‚¹ï¼šäº‹ä»¶è®¾è®¡ã€å¿«ç…§ä¼˜åŒ–ã€ç‰ˆæœ¬æ§åˆ¶
ä½¿ç”¨åœºæ™¯ï¼šå®¡è®¡éœ€æ±‚ã€è°ƒè¯•åˆ†æã€æ—¶é—´æ—…è¡Œ
```

### 7.3 æ¶æ„é€‰æ‹©æŒ‡å—


**ğŸ¯ ä½•æ—¶ä½¿ç”¨äº‹ä»¶é©±åŠ¨æ¶æ„**
```
âœ… é€‚ç”¨åœºæ™¯ï¼š
- ç³»ç»Ÿç»„ä»¶è¾ƒå¤šï¼Œéœ€è¦è§£è€¦
- æœ‰å¼‚æ­¥å¤„ç†éœ€æ±‚
- éœ€è¦é«˜å¯æ‰©å±•æ€§
- ä¸šåŠ¡æµç¨‹å¤æ‚ï¼Œéœ€è¦æµç¨‹ç¼–æ’

âŒ ä¸é€‚ç”¨åœºæ™¯ï¼š
- ç®€å•çš„å•ä½“åº”ç”¨
- å¼ºä¸€è‡´æ€§è¦æ±‚æé«˜
- å›¢é˜Ÿç¼ºä¹åˆ†å¸ƒå¼ç»éªŒ
- è°ƒè¯•å’Œç›‘æ§èƒ½åŠ›ä¸è¶³
```

**ğŸ“Š ç»„ä»¶é€‰æ‹©å¯¹æ¯”**

| éœ€æ±‚åœºæ™¯ | **æ¨èæ–¹æ¡ˆ** | **æ ¸å¿ƒè€ƒè™‘** |
|---------|-------------|-------------|
| ğŸ”„ **ç®€å•è§£è€¦** | `äº‹ä»¶æ€»çº¿` | `å¼€å‘ç®€å•ï¼Œæ€§èƒ½å¥½` |
| ğŸ“® **å¯é ä¼ é€’** | `æ¶ˆæ¯é˜Ÿåˆ—` | `æŒä¹…åŒ–ï¼Œä¸ä¸¢æ¶ˆæ¯` |
| ğŸ“¡ **çµæ´»è®¢é˜…** | `å‘å¸ƒè®¢é˜…` | `åŠ¨æ€æ‰©å±•ï¼ŒåŠŸèƒ½ä¸°å¯Œ` |
| ğŸ”„ **è¯»å†™åˆ†ç¦»** | `CQRS` | `æ€§èƒ½ä¼˜åŒ–ï¼Œæ¨¡å‹æ¸…æ™°` |
| ğŸ“š **å†å²è¿½æº¯** | `äº‹ä»¶æº¯æº` | `å®Œæ•´å†å²ï¼Œå®¡è®¡å‹å¥½` |

### 7.4 å®è·µå»ºè®®


**ğŸ› ï¸ å¼€å‘å»ºè®®**
```
ä»ç®€å•å¼€å§‹ï¼šå…ˆç”¨äº‹ä»¶æ€»çº¿ï¼Œé€æ­¥å¼•å…¥å…¶ä»–ç»„ä»¶
ç»Ÿä¸€äº‹ä»¶æ ¼å¼ï¼šå®šä¹‰æ ‡å‡†çš„äº‹ä»¶ç»“æ„å’Œå‘½åè§„èŒƒ
é”™è¯¯å¤„ç†ï¼šè®¾è®¡å®Œå–„çš„é‡è¯•ã€é™çº§ã€æŠ¥è­¦æœºåˆ¶
ç›‘æ§ä½“ç³»ï¼šå»ºç«‹äº‹ä»¶æµé‡ã€å¤„ç†å»¶è¿Ÿã€é”™è¯¯ç‡ç›‘æ§
æ–‡æ¡£ç»´æŠ¤ï¼šè®°å½•äº‹ä»¶å®šä¹‰ã€æµç¨‹å›¾ã€ä¾èµ–å…³ç³»
```

**âš¡ æ€§èƒ½ä¼˜åŒ–**
```
æ‰¹é‡å¤„ç†ï¼šæ‰¹é‡å‘é€å’Œå¤„ç†äº‹ä»¶
å¼‚æ­¥ä¼˜å…ˆï¼šå°½é‡ä½¿ç”¨å¼‚æ­¥å¤„ç†
ç¼“å­˜ç­–ç•¥ï¼šç¼“å­˜å¸¸ç”¨æŸ¥è¯¢ç»“æœ
åˆ†åŒºç­–ç•¥ï¼šæŒ‰ä¸šåŠ¡ç‰¹å¾åˆ†åŒºå¤„ç†
èƒŒå‹æ§åˆ¶ï¼šé˜²æ­¢ç”Ÿäº§è€…é€Ÿåº¦è¿‡å¿«
```

**ğŸ”’ å¯é æ€§ä¿è¯**
```
å¹‚ç­‰è®¾è®¡ï¼šç¡®ä¿é‡å¤å¤„ç†ä¸ä¼šäº§ç”Ÿå‰¯ä½œç”¨
é¡ºåºä¿è¯ï¼šåœ¨éœ€è¦æ—¶ä¿è¯äº‹ä»¶å¤„ç†é¡ºåº
æ•…éšœéš”ç¦»ï¼šä¸€ä¸ªå¤„ç†å™¨æ•…éšœä¸å½±å“å…¶ä»–
æ•°æ®ä¸€è‡´æ€§ï¼šè®¾è®¡åˆç†çš„æœ€ç»ˆä¸€è‡´æ€§ç­–ç•¥
é™çº§æ–¹æ¡ˆï¼šå…³é”®æµç¨‹è¦æœ‰é™çº§é¢„æ¡ˆ
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- äº‹ä»¶é©±åŠ¨æ¶æ„é€šè¿‡äº‹ä»¶è§£è€¦ç³»ç»Ÿç»„ä»¶
- äº”å¤§ç»„ä»¶å„æœ‰ç‰¹è‰²ï¼ŒæŒ‰éœ€é€‰æ‹©ç»„åˆä½¿ç”¨
- ä»ç®€å•äº‹ä»¶æ€»çº¿å¼€å§‹ï¼Œé€æ­¥æ¼”è¿›åˆ°å¤æ‚æ¶æ„
- é‡è§†ç›‘æ§ã€é”™è¯¯å¤„ç†å’Œä¸€è‡´æ€§è®¾è®¡