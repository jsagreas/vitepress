---
title: 9ã€Asyncä¸Awaitæ€ç»´
---
## ğŸ“š ç›®å½•

1. [åŒæ­¥é£æ ¼å¼‚æ­¥ç¼–ç¨‹](#1-åŒæ­¥é£æ ¼å¼‚æ­¥ç¼–ç¨‹)
2. [å¼‚æ­¥å‡½æ•°è®¾è®¡](#2-å¼‚æ­¥å‡½æ•°è®¾è®¡)
3. [é”™è¯¯å¤„ç†æœºåˆ¶](#3-é”™è¯¯å¤„ç†æœºåˆ¶)
4. [å¹¶å‘å¼‚æ­¥æ“ä½œ](#4-å¹¶å‘å¼‚æ­¥æ“ä½œ)
5. [å¼‚æ­¥æ€§èƒ½ä¼˜åŒ–](#5-å¼‚æ­¥æ€§èƒ½ä¼˜åŒ–)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”„ åŒæ­¥é£æ ¼å¼‚æ­¥ç¼–ç¨‹


### 1.1 ä»€ä¹ˆæ˜¯Async/Await


**ğŸ’¡ æ ¸å¿ƒæ¦‚å¿µ**
> **Async/Await**ï¼šä¸€ç§è®©å¼‚æ­¥ä»£ç çœ‹èµ·æ¥åƒåŒæ­¥ä»£ç çš„ç¼–ç¨‹æ¨¡å¼
> 
> **æœ¬è´¨**ï¼šæŠŠå¤æ‚çš„å¼‚æ­¥æ“ä½œåŒ…è£…æˆç®€å•æ˜“æ‡‚çš„åŒæ­¥å†™æ³•

**ğŸ”¸ ä¼ ç»Ÿå¼‚æ­¥ vs Async/Awaitå¯¹æ¯”**

```
ä¼ ç»Ÿå›è°ƒåœ°ç‹±ï¼š                    Async/Awaitç®€æ´å†™æ³•ï¼š
getData(function(a) {             async function processData() {
  getMoreData(a, function(b) {       const a = await getData();
    getEvenMore(b, function(c) {     const b = await getMoreData(a);
      getFinalData(c, function(d) {  const c = await getEvenMore(b);
        // ä½¿ç”¨d                      const d = await getFinalData(c);
      });                            return d;  // ç›´æ¥ä½¿ç”¨d
    });                            }
  });
});
```

### 1.2 Async/Awaitçš„å·¥ä½œåŸç†


**ğŸ§  æ€ç»´ç†è§£**
```
æƒ³è±¡å¼‚æ­¥æ“ä½œæ˜¯"ç­‰å¤–å–"ï¼š

ä¼ ç»Ÿæ–¹å¼ï¼ˆå›è°ƒï¼‰ï¼š
ç‚¹é¤ â†’ ç»™åº—å®¶ç•™ç”µè¯ â†’ åšå…¶ä»–äº‹
     â†“
   åº—å®¶æ‰“ç”µè¯ â†’ å»å–é¤ â†’ ç»§ç»­åšå…¶ä»–äº‹

Async/Awaitæ–¹å¼ï¼š
ç‚¹é¤ â†’ ç­‰å¾…(await) â†’ ç›´æ¥æ‹¿åˆ°å¤–å– â†’ ç»§ç»­åé¢çš„äº‹
```

**ğŸ”§ åŸºæœ¬è¯­æ³•ç»“æ„**
```javascript
// 1. å£°æ˜å¼‚æ­¥å‡½æ•°
async function å‡½æ•°å() {
  // 2. ç­‰å¾…å¼‚æ­¥æ“ä½œå®Œæˆ
  const ç»“æœ = await å¼‚æ­¥æ“ä½œ();
  // 3. åƒä½¿ç”¨åŒæ­¥ç»“æœä¸€æ ·ä½¿ç”¨
  return ç»“æœ;
}
```

### 1.3 åŒæ­¥é£æ ¼çš„ä¼˜åŠ¿


**âœ… ä»£ç å¯è¯»æ€§æå‡**
```javascript
// âŒ å›è°ƒåœ°ç‹± - éš¾ä»¥ç†è§£
function getUserProfile(userId, callback) {
  getUser(userId, function(user) {
    if (user) {
      getProfile(user.id, function(profile) {
        if (profile) {
          getPosts(profile.id, function(posts) {
            callback({user, profile, posts});
          });
        }
      });
    }
  });
}

// âœ… Async/Await - æ¸…æ™°æ˜“æ‡‚
async function getUserProfile(userId) {
  const user = await getUser(userId);
  if (!user) return null;
  
  const profile = await getProfile(user.id);
  if (!profile) return null;
  
  const posts = await getPosts(profile.id);
  return {user, profile, posts};
}
```

**âœ… é”™è¯¯å¤„ç†ç®€åŒ–**
```javascript
// âŒ å›è°ƒä¸­çš„é”™è¯¯å¤„ç†å¤æ‚
function processData(callback) {
  getData(function(err, data) {
    if (err) return callback(err);
    
    transformData(data, function(err, transformed) {
      if (err) return callback(err);
      
      saveData(transformed, function(err, result) {
        if (err) return callback(err);
        callback(null, result);
      });
    });
  });
}

// âœ… ç»Ÿä¸€çš„try/catchå¤„ç†
async function processData() {
  try {
    const data = await getData();
    const transformed = await transformData(data);
    const result = await saveData(transformed);
    return result;
  } catch (error) {
    // ç»Ÿä¸€é”™è¯¯å¤„ç†
    throw error;
  }
}
```

---

## 2. ğŸ—ï¸ å¼‚æ­¥å‡½æ•°è®¾è®¡


### 2.1 å¼‚æ­¥å‡½æ•°è®¾è®¡åŸåˆ™


**ğŸ¯ æ ¸å¿ƒè®¾è®¡æ€è·¯**
```
å•ä¸€èŒè´£åŸåˆ™ï¼šæ¯ä¸ªå¼‚æ­¥å‡½æ•°åªåšä¸€ä»¶äº‹
è¾“å…¥è¾“å‡ºæ¸…æ™°ï¼šæ˜ç¡®çš„å‚æ•°å’Œè¿”å›å€¼
é”™è¯¯è¾¹ç•Œæ˜ç¡®ï¼šæ¸…æ¥šä»€ä¹ˆæƒ…å†µä¸‹ä¼šå‡ºé”™
èµ„æºç®¡ç†è‰¯å¥½ï¼šåŠæ—¶é‡Šæ”¾èµ„æºå’Œè¿æ¥
```

**ğŸ“‹ è®¾è®¡æ£€æŸ¥æ¸…å•**
- [ ] å‡½æ•°åæ¸…æ¥šè¡¨è¾¾å¼‚æ­¥æ“ä½œçš„ç›®çš„
- [ ] å‚æ•°éªŒè¯å’Œé»˜è®¤å€¼å¤„ç†
- [ ] æ˜ç¡®çš„è¿”å›å€¼ç±»å‹
- [ ] å®Œå–„çš„é”™è¯¯å¤„ç†
- [ ] é€‚å½“çš„è¶…æ—¶æ§åˆ¶

### 2.2 å¼‚æ­¥å‡½æ•°å‘½åè§„èŒƒ


**âœ… å¥½çš„å‘½åæ¨¡å¼**
```javascript
// æ˜ç¡®è¡¨è¾¾å¼‚æ­¥æ“ä½œ
async function fetchUserData(userId) { }     // è·å–ç”¨æˆ·æ•°æ®
async function saveUserProfile(profile) { } // ä¿å­˜ç”¨æˆ·èµ„æ–™
async function deletePost(postId) { }       // åˆ é™¤å¸–å­
async function validateEmail(email) { }     // éªŒè¯é‚®ç®±

// è¿”å›å€¼ç±»å‹æ¸…æ™°
async function getUserList() { }             // è¿”å›ç”¨æˆ·åˆ—è¡¨
async function checkUserExists(id) { }      // è¿”å›boolean
async function countUserPosts(id) { }       // è¿”å›æ•°å­—
```

**âŒ é¿å…çš„å‘½åæ–¹å¼**
```javascript
// ä¸æ¸…æ¥šæ˜¯å¦å¼‚æ­¥
function process() { }          // ä¸çŸ¥é“å¤„ç†ä»€ä¹ˆ
function handle() { }           // ä¸çŸ¥é“å¤„ç†ä»€ä¹ˆ
function doSomething() { }      // å®Œå…¨ä¸æ˜ç¡®

// å®¹æ˜“è¯¯è§£
async function getUser() { }    // å¯èƒ½ä»¥ä¸ºæ˜¯åŒæ­¥è·å–
function fetchData() { }        // ä¸çŸ¥é“æ˜¯å¦å¼‚æ­¥
```

### 2.3 å‚æ•°è®¾è®¡æ¨¡å¼


**ğŸ”§ å‚æ•°ç»„ç»‡ç­–ç•¥**
```javascript
// âœ… å‚æ•°å°‘æ—¶ç›´æ¥ä¼ é€’
async function getUser(userId) {
  // éªŒè¯å‚æ•°
  if (!userId) throw new Error('ç”¨æˆ·IDä¸èƒ½ä¸ºç©º');
  
  const user = await db.users.findById(userId);
  return user;
}

// âœ… å‚æ•°å¤šæ—¶ä½¿ç”¨é…ç½®å¯¹è±¡
async function searchUsers({
  keyword = '',           // æœç´¢å…³é”®è¯
  page = 1,              // é¡µç 
  pageSize = 10,         // æ¯é¡µæ•°é‡
  sortBy = 'created',    // æ’åºå­—æ®µ
  order = 'desc'         // æ’åºæ–¹å‘
} = {}) {
  // å‚æ•°éªŒè¯
  if (page < 1) page = 1;
  if (pageSize > 100) pageSize = 100;
  
  const users = await db.users.search({
    keyword, page, pageSize, sortBy, order
  });
  
  return users;
}

// âœ… å¤æ‚æ“ä½œçš„åˆ†æ­¥è®¾è®¡
async function createUserWithProfile({
  username,      // å¿…å¡«ï¼šç”¨æˆ·å
  email,         // å¿…å¡«ï¼šé‚®ç®±
  password,      // å¿…å¡«ï¼šå¯†ç 
  profile = {}   // å¯é€‰ï¼šä¸ªäººèµ„æ–™
}) {
  // 1. åˆ›å»ºç”¨æˆ·
  const user = await createUser({username, email, password});
  
  // 2. åˆ›å»ºä¸ªäººèµ„æ–™
  if (Object.keys(profile).length > 0) {
    const userProfile = await createProfile({
      userId: user.id,
      ...profile
    });
    user.profile = userProfile;
  }
  
  return user;
}
```

### 2.4 è¿”å›å€¼è®¾è®¡æ¨¡å¼


**ğŸ“Š ç»Ÿä¸€è¿”å›æ ¼å¼**
```javascript
// âœ… ç®€å•æ“ä½œç›´æ¥è¿”å›æ•°æ®
async function getUser(id) {
  const user = await db.users.findById(id);
  return user;  // ç›´æ¥è¿”å›ç”¨æˆ·å¯¹è±¡æˆ–null
}

// âœ… å¤æ‚æ“ä½œè¿”å›ç»“æ„åŒ–ç»“æœ
async function getUsersWithPagination(page, pageSize) {
  const offset = (page - 1) * pageSize;
  
  const [users, total] = await Promise.all([
    db.users.find().skip(offset).limit(pageSize),
    db.users.countDocuments()
  ]);
  
  return {
    data: users,           // å®é™…æ•°æ®
    pagination: {          // åˆ†é¡µä¿¡æ¯
      page,
      pageSize,
      total,
      totalPages: Math.ceil(total / pageSize)
    }
  };
}

// âœ… æ“ä½œç»“æœè¿”å›çŠ¶æ€ä¿¡æ¯
async function updateUser(id, updates) {
  try {
    const result = await db.users.updateOne({_id: id}, updates);
    
    return {
      success: true,
      modified: result.modifiedCount > 0,
      data: await db.users.findById(id)
    };
  } catch (error) {
    return {
      success: false,
      error: error.message
    };
  }
}
```

---

## 3. ğŸš¨ é”™è¯¯å¤„ç†æœºåˆ¶


### 3.1 Try/CatchåŸºç¡€æ¨¡å¼


**ğŸ’¡ åŸºæœ¬é”™è¯¯å¤„ç†æ€ç»´**
> **æ ¸å¿ƒæ€æƒ³**ï¼šæŠŠå¯èƒ½å‡ºé”™çš„å¼‚æ­¥æ“ä½œæ”¾åœ¨tryå—ä¸­ï¼Œç”¨catchç»Ÿä¸€å¤„ç†é”™è¯¯

```javascript
// åŸºæœ¬æ¨¡å¼
async function safeAsyncOperation() {
  try {
    const result = await riskyAsyncOperation();
    return result;
  } catch (error) {
    // å¤„ç†é”™è¯¯
    console.error('æ“ä½œå¤±è´¥:', error.message);
    throw error;  // é‡æ–°æŠ›å‡ºæˆ–è¿”å›é»˜è®¤å€¼
  }
}
```

**ğŸ”§ å®é™…åº”ç”¨ç¤ºä¾‹**
```javascript
// ç½‘ç»œè¯·æ±‚é”™è¯¯å¤„ç†
async function fetchUserData(userId) {
  try {
    // å¯èƒ½å¤±è´¥çš„ç½‘ç»œè¯·æ±‚
    const response = await fetch(`/api/users/${userId}`);
    
    // æ£€æŸ¥å“åº”çŠ¶æ€
    if (!response.ok) {
      throw new Error(`è¯·æ±‚å¤±è´¥: ${response.status}`);
    }
    
    const userData = await response.json();
    return userData;
    
  } catch (error) {
    // åŒºåˆ†ä¸åŒç±»å‹çš„é”™è¯¯
    if (error.name === 'TypeError') {
      throw new Error('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
    } else if (error.message.includes('404')) {
      throw new Error('ç”¨æˆ·ä¸å­˜åœ¨');
    } else {
      throw new Error('è·å–ç”¨æˆ·æ•°æ®å¤±è´¥');
    }
  }
}
```

### 3.2 åˆ†å±‚é”™è¯¯å¤„ç†


**ğŸ—ï¸ é”™è¯¯å¤„ç†å±‚æ¬¡**
```
ä¸šåŠ¡é€»è¾‘å±‚ â†’ æ£€æŸ¥ä¸šåŠ¡è§„åˆ™é”™è¯¯
æœåŠ¡è°ƒç”¨å±‚ â†’ æ£€æŸ¥æœåŠ¡å¯ç”¨æ€§é”™è¯¯  
æ•°æ®è®¿é—®å±‚ â†’ æ£€æŸ¥æ•°æ®åº“è¿æ¥é”™è¯¯
ç½‘ç»œè¯·æ±‚å±‚ â†’ æ£€æŸ¥ç½‘ç»œé€šä¿¡é”™è¯¯
```

**ğŸ“‹ åˆ†å±‚å¤„ç†ç¤ºä¾‹**
```javascript
// æ•°æ®è®¿é—®å±‚ - å¤„ç†æ•°æ®åº“é”™è¯¯
async function getUserFromDB(userId) {
  try {
    const user = await db.users.findById(userId);
    return user;
  } catch (error) {
    if (error.code === 'ECONNREFUSED') {
      throw new Error('æ•°æ®åº“è¿æ¥å¤±è´¥');
    }
    throw new Error('æ•°æ®æŸ¥è¯¢å¤±è´¥');
  }
}

// ä¸šåŠ¡é€»è¾‘å±‚ - å¤„ç†ä¸šåŠ¡è§„åˆ™é”™è¯¯
async function getActiveUser(userId) {
  try {
    const user = await getUserFromDB(userId);
    
    if (!user) {
      throw new Error('ç”¨æˆ·ä¸å­˜åœ¨');
    }
    
    if (!user.isActive) {
      throw new Error('ç”¨æˆ·è´¦å·å·²è¢«ç¦ç”¨');
    }
    
    return user;
  } catch (error) {
    // è®°å½•ä¸šåŠ¡é”™è¯¯æ—¥å¿—
    logger.warn(`è·å–æ´»è·ƒç”¨æˆ·å¤±è´¥: ${userId}`, error);
    throw error;
  }
}

// æ§åˆ¶å™¨å±‚ - å¤„ç†ç”¨æˆ·ç•Œé¢é”™è¯¯
async function handleGetUser(req, res) {
  try {
    const user = await getActiveUser(req.params.id);
    res.json({success: true, data: user});
  } catch (error) {
    // ç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼
    res.status(400).json({
      success: false,
      message: error.message
    });
  }
}
```

### 3.3 é”™è¯¯æ¢å¤ç­–ç•¥


**ğŸ”„ é‡è¯•æœºåˆ¶**
```javascript
// å¸¦é‡è¯•çš„å¼‚æ­¥æ“ä½œ
async function fetchWithRetry(url, maxRetries = 3) {
  let lastError;
  
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      const response = await fetch(url);
      if (response.ok) {
        return await response.json();
      }
      throw new Error(`HTTP ${response.status}`);
    } catch (error) {
      lastError = error;
      
      // æœ€åä¸€æ¬¡å°è¯•å¤±è´¥å°±æŠ›å‡ºé”™è¯¯
      if (attempt === maxRetries) {
        throw new Error(`${maxRetries}æ¬¡é‡è¯•åä»ç„¶å¤±è´¥: ${error.message}`);
      }
      
      // ç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•
      const delay = attempt * 1000; // é€’å¢å»¶è¿Ÿ
      await new Promise(resolve => setTimeout(resolve, delay));
    }
  }
}
```

**ğŸ›¡ï¸ é™çº§å¤„ç†**
```javascript
// æœåŠ¡é™çº§ç¤ºä¾‹
async function getUserRecommendations(userId) {
  try {
    // å°è¯•ä»æ¨èæœåŠ¡è·å–
    const recommendations = await recommendationService.getForUser(userId);
    return recommendations;
  } catch (error) {
    console.warn('æ¨èæœåŠ¡ä¸å¯ç”¨ï¼Œä½¿ç”¨é»˜è®¤æ¨è');
    
    // é™çº§åˆ°é»˜è®¤æ¨è
    return await getDefaultRecommendations();
  }
}

async function getDefaultRecommendations() {
  // è¿”å›çƒ­é—¨å†…å®¹ä½œä¸ºé»˜è®¤æ¨è
  return await db.posts.find({isHot: true}).limit(10);
}
```

---

## 4. ğŸ”€ å¹¶å‘å¼‚æ­¥æ“ä½œ


### 4.1 å¹¶å‘ vs ä¸²è¡Œæ‰§è¡Œ


**ğŸ’¡ åŸºæœ¬æ¦‚å¿µç†è§£**
```
ä¸²è¡Œæ‰§è¡Œï¼ˆç­‰ä¸€ä¸ªåšå®Œå†åšä¸‹ä¸€ä¸ªï¼‰ï¼š
ä»»åŠ¡A â€”â€”â€”â€”â€”â€”> ä»»åŠ¡B â€”â€”â€”â€”â€”â€”> ä»»åŠ¡C
æ—¶é—´:  3ç§’        2ç§’        1ç§’
æ€»æ—¶é—´: 6ç§’

å¹¶å‘æ‰§è¡Œï¼ˆåŒæ—¶å¯åŠ¨å¤šä¸ªä»»åŠ¡ï¼‰ï¼š
ä»»åŠ¡A â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”>
ä»»åŠ¡B â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”>
ä»»åŠ¡C â€”â€”â€”â€”â€”â€”>
æ—¶é—´:  3ç§’ï¼ˆæ‰€æœ‰ä»»åŠ¡ä¸­æœ€é•¿çš„æ—¶é—´ï¼‰
```

**ğŸ”§ ä»£ç å¯¹æ¯”ç¤ºä¾‹**
```javascript
// âŒ ä¸²è¡Œæ‰§è¡Œ - æ…¢
async function getDataSerially() {
  const user = await getUser();      // ç­‰1ç§’
  const posts = await getPosts();    // ç­‰2ç§’  
  const comments = await getComments(); // ç­‰1ç§’
  
  return {user, posts, comments};     // æ€»å…±ç­‰4ç§’
}

// âœ… å¹¶å‘æ‰§è¡Œ - å¿«
async function getDataConcurrently() {
  // åŒæ—¶å¯åŠ¨æ‰€æœ‰å¼‚æ­¥æ“ä½œ
  const [user, posts, comments] = await Promise.all([
    getUser(),      // 1ç§’
    getPosts(),     // 2ç§’
    getComments()   // 1ç§’
  ]);
  
  return {user, posts, comments};  // æ€»å…±ç­‰2ç§’ï¼ˆæœ€é•¿çš„æ“ä½œæ—¶é—´ï¼‰
}
```

### 4.2 Promise.all å®Œå…¨å¹¶å‘


**ğŸ¯ ä½¿ç”¨åœºæ™¯**
> **é€‚ç”¨æƒ…å†µ**ï¼šå¤šä¸ªå¼‚æ­¥æ“ä½œäº’ä¸ä¾èµ–ï¼Œéœ€è¦ç­‰æ‰€æœ‰æ“ä½œéƒ½å®Œæˆ

```javascript
// é¡µé¢åˆå§‹åŒ–æ•°æ®åŠ è½½
async function initializePage(userId) {
  try {
    // åŒæ—¶è·å–å¤šç§æ•°æ®
    const [
      userInfo,
      userPosts,
      notifications,
      settings
    ] = await Promise.all([
      fetchUserInfo(userId),      // è·å–ç”¨æˆ·ä¿¡æ¯
      fetchUserPosts(userId),     // è·å–ç”¨æˆ·å¸–å­
      fetchNotifications(userId), // è·å–é€šçŸ¥
      fetchUserSettings(userId)   // è·å–ç”¨æˆ·è®¾ç½®
    ]);
    
    return {
      userInfo,
      userPosts,
      notifications,
      settings
    };
  } catch (error) {
    // ä»»ä½•ä¸€ä¸ªå¤±è´¥ï¼Œæ•´ä½“å¤±è´¥
    throw new Error(`é¡µé¢åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
  }
}
```

**âš ï¸ æ³¨æ„äº‹é¡¹**
```javascript
// Promise.allçš„"ä¸€ä¸ªå¤±è´¥ï¼Œå…¨éƒ¨å¤±è´¥"ç‰¹æ€§
async function demonstratePromiseAllFailure() {
  try {
    const [result1, result2, result3] = await Promise.all([
      asyncOperation1(),  // æˆåŠŸ
      asyncOperation2(),  // å¤±è´¥ âŒ
      asyncOperation3()   // æˆåŠŸ
    ]);
  } catch (error) {
    // å› ä¸ºoperation2å¤±è´¥ï¼Œå…¶ä»–æˆåŠŸçš„ç»“æœä¹Ÿæ‹¿ä¸åˆ°
    console.log('æ‰€æœ‰æ“ä½œéƒ½è¢«å–æ¶ˆäº†');
  }
}
```

### 4.3 Promise.allSettled å®¹é”™å¹¶å‘


**ğŸ›¡ï¸ ä½¿ç”¨åœºæ™¯**
> **é€‚ç”¨æƒ…å†µ**ï¼šå¸Œæœ›æ‰€æœ‰æ“ä½œéƒ½æ‰§è¡Œå®Œï¼Œä¸è®ºæˆåŠŸå¤±è´¥

```javascript
// æ‰¹é‡å¤„ç†ç”¨æˆ·æ•°æ®ï¼Œå…è®¸éƒ¨åˆ†å¤±è´¥
async function batchProcessUsers(userIds) {
  const results = await Promise.allSettled(
    userIds.map(id => processUser(id))
  );
  
  // åˆ†åˆ«å¤„ç†æˆåŠŸå’Œå¤±è´¥çš„ç»“æœ
  const successful = [];
  const failed = [];
  
  results.forEach((result, index) => {
    if (result.status === 'fulfilled') {
      successful.push({
        userId: userIds[index],
        data: result.value
      });
    } else {
      failed.push({
        userId: userIds[index],
        error: result.reason.message
      });
    }
  });
  
  return {
    successful,
    failed,
    total: userIds.length
  };
}
```

### 4.4 Promise.race ç«é€Ÿæ‰§è¡Œ


**ğŸƒ ä½¿ç”¨åœºæ™¯**
> **é€‚ç”¨æƒ…å†µ**ï¼šåªè¦æœ‰ä¸€ä¸ªæ“ä½œå®Œæˆå°±å¯ä»¥ç»§ç»­ï¼Œæ¯”å¦‚è¶…æ—¶æ§åˆ¶

```javascript
// å¸¦è¶…æ—¶çš„ç½‘ç»œè¯·æ±‚
async function fetchWithTimeout(url, timeout = 5000) {
  const fetchPromise = fetch(url);
  const timeoutPromise = new Promise((_, reject) => {
    setTimeout(() => reject(new Error('è¯·æ±‚è¶…æ—¶')), timeout);
  });
  
  try {
    // å“ªä¸ªå…ˆå®Œæˆå°±ç”¨å“ªä¸ªç»“æœ
    const response = await Promise.race([fetchPromise, timeoutPromise]);
    return await response.json();
  } catch (error) {
    if (error.message === 'è¯·æ±‚è¶…æ—¶') {
      throw new Error('ç½‘ç»œè¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•');
    }
    throw error;
  }
}

// å¤šæ•°æ®æºç«é€Ÿè·å–
async function getDataFromFastestSource(id) {
  const sources = [
    fetchFromCache(id),      // ç¼“å­˜ï¼ˆé€šå¸¸æœ€å¿«ï¼‰
    fetchFromDatabase(id),   // æ•°æ®åº“
    fetchFromAPI(id)        // å¤–éƒ¨API
  ];
  
  try {
    // è¿”å›æœ€å…ˆå“åº”çš„æ•°æ®æºç»“æœ
    const result = await Promise.race(sources);
    return result;
  } catch (error) {
    // å¦‚æœæœ€å¿«çš„å¤±è´¥äº†ï¼Œå¯ä»¥å°è¯•å…¶ä»–æ–¹å¼
    throw new Error('æ‰€æœ‰æ•°æ®æºéƒ½ä¸å¯ç”¨');
  }
}
```

### 4.5 æ§åˆ¶å¹¶å‘æ•°é‡


**ğŸ›ï¸ å¹¶å‘æ§åˆ¶çš„å¿…è¦æ€§**
```
é—®é¢˜åœºæ™¯ï¼š
åŒæ—¶å‘èµ·1000ä¸ªç½‘ç»œè¯·æ±‚ â†’ æœåŠ¡å™¨å‹å® âŒ
åŒæ—¶å¤„ç†1000ä¸ªæ–‡ä»¶   â†’ å†…å­˜è€—å°½ âŒ
åŒæ—¶è¿æ¥1000ä¸ªæ•°æ®åº“ â†’ è¿æ¥æ± çˆ†æ»¡ âŒ

è§£å†³æ–¹æ¡ˆï¼š
é™åˆ¶åŒæ—¶æ‰§è¡Œçš„å¼‚æ­¥æ“ä½œæ•°é‡
```

**ğŸ”§ å¹¶å‘æ§åˆ¶å®ç°**
```javascript
// æ§åˆ¶å¹¶å‘æ•°é‡çš„å·¥å…·å‡½æ•°
async function concurrentMap(items, asyncFn, concurrency = 3) {
  const results = [];
  const executing = [];
  
  for (const item of items) {
    // åˆ›å»ºå¼‚æ­¥æ“ä½œ
    const promise = asyncFn(item).then(result => {
      // æ“ä½œå®Œæˆåä»æ‰§è¡Œåˆ—è¡¨ä¸­ç§»é™¤
      executing.splice(executing.indexOf(promise), 1);
      return result;
    });
    
    results.push(promise);
    executing.push(promise);
    
    // å¦‚æœè¾¾åˆ°å¹¶å‘é™åˆ¶ï¼Œç­‰å¾…ä¸€ä¸ªæ“ä½œå®Œæˆ
    if (executing.length >= concurrency) {
      await Promise.race(executing);
    }
  }
  
  // ç­‰å¾…æ‰€æœ‰æ“ä½œå®Œæˆ
  return Promise.all(results);
}

// ä½¿ç”¨ç¤ºä¾‹ï¼šæ‰¹é‡ä¸‹è½½å›¾ç‰‡
async function downloadImages(imageUrls) {
  const downloadImage = async (url) => {
    const response = await fetch(url);
    const blob = await response.blob();
    return blob;
  };
  
  // æœ€å¤šåŒæ—¶ä¸‹è½½5å¼ å›¾ç‰‡
  const images = await concurrentMap(imageUrls, downloadImage, 5);
  return images;
}
```

---

## 5. âš¡ å¼‚æ­¥æ€§èƒ½ä¼˜åŒ–


### 5.1 é¿å…ä¸å¿…è¦çš„ç­‰å¾…


**ğŸ’¡ ä¼˜åŒ–æ€ç»´**
> **æ ¸å¿ƒåŸåˆ™**ï¼šèƒ½å¹¶è¡Œçš„ä¸ä¸²è¡Œï¼Œèƒ½é¢„åŠ è½½çš„ä¸ç­‰å¾…ï¼Œèƒ½ç¼“å­˜çš„ä¸é‡å¤

**ğŸ”§ é¢„åŠ è½½ä¼˜åŒ–**
```javascript
// âŒ ç­‰ç”¨æˆ·ç‚¹å‡»æ‰å¼€å§‹åŠ è½½
async function handleUserClick(userId) {
  showLoading();
  const userData = await fetchUserData(userId);  // ç”¨æˆ·ç­‰å¾…ä¸­...
  hideLoading();
  showUserData(userData);
}

// âœ… é¢„æµ‹ç”¨æˆ·è¡Œä¸ºï¼Œæå‰åŠ è½½
class UserDataManager {
  constructor() {
    this.cache = new Map();
    this.loadingPromises = new Map();
  }
  
  // é¢„åŠ è½½å¯èƒ½éœ€è¦çš„æ•°æ®
  preloadUserData(userId) {
    if (!this.cache.has(userId) && !this.loadingPromises.has(userId)) {
      const promise = fetchUserData(userId).then(data => {
        this.cache.set(userId, data);
        this.loadingPromises.delete(userId);
        return data;
      });
      this.loadingPromises.set(userId, promise);
    }
  }
  
  // è·å–æ•°æ®ï¼ˆå¯èƒ½å·²ç»é¢„åŠ è½½å®Œæˆï¼‰
  async getUserData(userId) {
    // å¦‚æœå·²ç¼“å­˜ï¼Œç›´æ¥è¿”å›
    if (this.cache.has(userId)) {
      return this.cache.get(userId);
    }
    
    // å¦‚æœæ­£åœ¨åŠ è½½ï¼Œç­‰å¾…å®Œæˆ
    if (this.loadingPromises.has(userId)) {
      return await this.loadingPromises.get(userId);
    }
    
    // å¦åˆ™ç°åœ¨å¼€å§‹åŠ è½½
    return await this.fetchAndCache(userId);
  }
}
```

### 5.2 æ™ºèƒ½ç¼“å­˜ç­–ç•¥


**ğŸ—„ï¸ ç¼“å­˜å±‚æ¬¡è®¾è®¡**
```javascript
class MultiLevelCache {
  constructor() {
    this.memoryCache = new Map();      // å†…å­˜ç¼“å­˜ï¼ˆæœ€å¿«ï¼‰
    this.localStorageCache = null;     // æœ¬åœ°å­˜å‚¨ç¼“å­˜
    this.maxMemoryItems = 100;         // å†…å­˜ç¼“å­˜é™åˆ¶
  }
  
  async get(key) {
    // 1. å…ˆæŸ¥å†…å­˜ç¼“å­˜
    if (this.memoryCache.has(key)) {
      return this.memoryCache.get(key);
    }
    
    // 2. å†æŸ¥æœ¬åœ°å­˜å‚¨
    const localData = localStorage.getItem(key);
    if (localData) {
      const parsed = JSON.parse(localData);
      // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
      if (Date.now() < parsed.expiry) {
        // æ”¾å…¥å†…å­˜ç¼“å­˜ä»¥ä¾¿ä¸‹æ¬¡æ›´å¿«è®¿é—®
        this.memoryCache.set(key, parsed.data);
        return parsed.data;
      }
    }
    
    // 3. éƒ½æ²¡æœ‰ï¼Œè¿”å›null
    return null;
  }
  
  async set(key, data, ttl = 300000) { // é»˜è®¤5åˆ†é’Ÿè¿‡æœŸ
    // å†…å­˜ç¼“å­˜å¤§å°æ§åˆ¶
    if (this.memoryCache.size >= this.maxMemoryItems) {
      const firstKey = this.memoryCache.keys().next().value;
      this.memoryCache.delete(firstKey);
    }
    
    // å­˜å…¥å†…å­˜ç¼“å­˜
    this.memoryCache.set(key, data);
    
    // å­˜å…¥æœ¬åœ°å­˜å‚¨ï¼ˆå¸¦è¿‡æœŸæ—¶é—´ï¼‰
    const cacheData = {
      data,
      expiry: Date.now() + ttl
    };
    localStorage.setItem(key, JSON.stringify(cacheData));
  }
}

// ä½¿ç”¨ç¼“å­˜çš„å¼‚æ­¥å‡½æ•°
const cache = new MultiLevelCache();

async function getCachedUserData(userId) {
  const cacheKey = `user_${userId}`;
  
  // å…ˆå°è¯•ä»ç¼“å­˜è·å–
  let userData = await cache.get(cacheKey);
  
  if (!userData) {
    // ç¼“å­˜æ²¡æœ‰ï¼Œä»æœåŠ¡å™¨è·å–
    userData = await fetchUserData(userId);
    // å­˜å…¥ç¼“å­˜
    await cache.set(cacheKey, userData);
  }
  
  return userData;
}
```

### 5.3 æ‰¹é‡æ“ä½œä¼˜åŒ–


**ğŸ“¦ æ‰¹é‡å¤„ç†æ€ç»´**
```javascript
// âŒ é€ä¸ªå¤„ç†æ•ˆç‡ä½
async function processUsersOneByOne(userIds) {
  const results = [];
  for (const userId of userIds) {
    const user = await processUser(userId);  // æ¯æ¬¡ç­‰å¾…
    results.push(user);
  }
  return results;  // å¦‚æœæœ‰100ä¸ªç”¨æˆ·ï¼Œä¸²è¡Œæ‰§è¡Œå¾ˆæ…¢
}

// âœ… æ‰¹é‡APIè°ƒç”¨
async function procesUsersBatch(userIds) {
  // 1. åˆ†æ‰¹å¤„ç†ï¼Œé¿å…å•æ¬¡è¯·æ±‚è¿‡å¤§
  const batchSize = 20;
  const batches = [];
  
  for (let i = 0; i < userIds.length; i += batchSize) {
    batches.push(userIds.slice(i, i + batchSize));
  }
  
  // 2. å¹¶å‘å¤„ç†æ‰€æœ‰æ‰¹æ¬¡
  const batchPromises = batches.map(batch => 
    procesUsersBatchAPI(batch)  // è°ƒç”¨æ‰¹é‡å¤„ç†API
  );
  
  const batchResults = await Promise.all(batchPromises);
  
  // 3. åˆå¹¶æ‰€æœ‰æ‰¹æ¬¡ç»“æœ
  return batchResults.flat();
}

// æ‰¹é‡APIè°ƒç”¨ç¤ºä¾‹
async function procesUsersBatchAPI(userIds) {
  const response = await fetch('/api/users/batch-process', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({userIds})
  });
  
  return await response.json();
}
```

### 5.4 èµ„æºç®¡ç†ä¼˜åŒ–


**ğŸ”§ è¿æ¥æ± ç®¡ç†**
```javascript
// æ•°æ®åº“è¿æ¥æ± ç¤ºä¾‹
class ConnectionPool {
  constructor(maxConnections = 10) {
    this.maxConnections = maxConnections;
    this.activeConnections = 0;
    this.waitingQueue = [];
  }
  
  async getConnection() {
    if (this.activeConnections < this.maxConnections) {
      this.activeConnections++;
      return await this.createConnection();
    } else {
      // ç­‰å¾…è¿æ¥å¯ç”¨
      return new Promise((resolve) => {
        this.waitingQueue.push(resolve);
      });
    }
  }
  
  releaseConnection(connection) {
    this.activeConnections--;
    
    // å¦‚æœæœ‰ç­‰å¾…çš„è¯·æ±‚ï¼Œåˆ†é…è¿æ¥
    if (this.waitingQueue.length > 0) {
      const waitingResolve = this.waitingQueue.shift();
      this.activeConnections++;
      waitingResolve(connection);
    } else {
      // å…³é—­è¿æ¥
      connection.close();
    }
  }
  
  async executeQuery(sql) {
    const connection = await this.getConnection();
    try {
      const result = await connection.query(sql);
      return result;
    } finally {
      this.releaseConnection(connection);
    }
  }
}
```

### 5.5 å†…å­˜ä½¿ç”¨ä¼˜åŒ–


**ğŸ’¾ æµå¼å¤„ç†å¤§æ•°æ®**
```javascript
// âŒ ä¸€æ¬¡æ€§åŠ è½½å¤§æ–‡ä»¶åˆ°å†…å­˜
async function processLargeFileBadly(filePath) {
  const fileContent = await fs.readFile(filePath, 'utf8');  // å¯èƒ½å‡ GB
  const lines = fileContent.split('\n');
  
  const results = [];
  for (const line of lines) {
    results.push(await processLine(line));
  }
  return results;  // å†…å­˜çˆ†ç‚¸ âŒ
}

// âœ… æµå¼å¤„ç†ï¼Œé€è¡Œè¯»å–
async function processLargeFileWell(filePath) {
  const results = [];
  const fileStream = fs.createReadStream(filePath);
  const lineReader = readline.createInterface({
    input: fileStream,
    crlfDelay: Infinity
  });
  
  const concurrentProcessor = new ConcurrentProcessor(5); // å¹¶å‘æ§åˆ¶
  
  for await (const line of lineReader) {
    // å¹¶å‘å¤„ç†ï¼Œä½†æ§åˆ¶å†…å­˜ä½¿ç”¨
    const result = await concurrentProcessor.process(line);
    results.push(result);
    
    // å®šæœŸé‡Šæ”¾å†…å­˜
    if (results.length % 1000 === 0) {
      await savePartialResults(results.splice(0, 1000));
    }
  }
  
  // å¤„ç†å‰©ä½™æ•°æ®
  if (results.length > 0) {
    await savePartialResults(results);
  }
}
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 Async/Awaitæ ¸å¿ƒç†å¿µ


**ğŸ¯ å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ**
```
ğŸ”¸ åŒæ­¥é£æ ¼å¼‚æ­¥ç¼–ç¨‹ï¼šè®©å¼‚æ­¥ä»£ç çœ‹èµ·æ¥åƒåŒæ­¥ä»£ç 
ğŸ”¸ asyncå‡½æ•°ï¼šè¿”å›Promiseçš„å‡½æ•°å£°æ˜æ–¹å¼
ğŸ”¸ awaitè¡¨è¾¾å¼ï¼šç­‰å¾…Promiseå®Œæˆå¹¶è¿”å›ç»“æœ
ğŸ”¸ é”™è¯¯å¤„ç†ï¼šä½¿ç”¨try/catchç»Ÿä¸€å¤„ç†å¼‚æ­¥é”™è¯¯
ğŸ”¸ å¹¶å‘æ§åˆ¶ï¼šåˆç†ä½¿ç”¨Promise.allã€Promise.raceç­‰
```

### 6.2 è®¾è®¡åŸåˆ™æ€»ç»“


**âœ… å‡½æ•°è®¾è®¡æœ€ä½³å®è·µ**
- **å‘½åæ¸…æ™°**ï¼šå‡½æ•°åæ˜ç¡®è¡¨è¾¾å¼‚æ­¥æ“ä½œçš„ç›®çš„
- **å‚æ•°åˆç†**ï¼šå°‘å‚æ•°ç›´æ¥ä¼ é€’ï¼Œå¤šå‚æ•°ç”¨é…ç½®å¯¹è±¡
- **è¿”å›å€¼æ˜ç¡®**ï¼šè¿”å›ç±»å‹å’Œæ ¼å¼è¦ç»Ÿä¸€
- **é”™è¯¯å¤„ç†å®Œå–„**ï¼šåˆ†å±‚å¤„ç†ï¼Œé”™è¯¯ä¿¡æ¯è¦æœ‰æ„ä¹‰
- **èµ„æºç®¡ç†**ï¼šåŠæ—¶é‡Šæ”¾è¿æ¥å’Œèµ„æº

**âœ… æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**
- **èƒ½å¹¶è¡Œçš„ä¸ä¸²è¡Œ**ï¼šä½¿ç”¨Promise.allå¹¶å‘æ‰§è¡Œ
- **æ™ºèƒ½ç¼“å­˜**ï¼šå¤šå±‚ç¼“å­˜ï¼Œé¿å…é‡å¤è¯·æ±‚
- **æ‰¹é‡æ“ä½œ**ï¼šå‡å°‘ç½‘ç»œè¯·æ±‚æ¬¡æ•°
- **èµ„æºå¤ç”¨**ï¼šè¿æ¥æ± ã€å¯¹è±¡æ± ç­‰
- **å†…å­˜æ§åˆ¶**ï¼šæµå¼å¤„ç†å¤§æ•°æ®

### 6.3 å¸¸è§é™·é˜±é¿å…


**âŒ æ–°æ‰‹å¸¸çŠ¯é”™è¯¯**
```javascript
// 1. å¿˜è®°awaitï¼Œæ‹¿åˆ°Promiseè€Œä¸æ˜¯ç»“æœ
const user = getUserData(id);  // âŒ useræ˜¯Promise
const user = await getUserData(id);  // âœ… useræ˜¯å®é™…æ•°æ®

// 2. ä¸²è¡Œæ‰§è¡Œå¯ä»¥å¹¶è¡Œçš„æ“ä½œ  
const a = await getA();  // âŒ ä¸²è¡Œ
const b = await getB();
// æ”¹ä¸ºï¼š
const [a, b] = await Promise.all([getA(), getB()]);  // âœ… å¹¶è¡Œ

// 3. æ²¡æœ‰é”™è¯¯å¤„ç†
const result = await riskyOperation();  // âŒ æ²¡æœ‰é”™è¯¯å¤„ç†
// æ”¹ä¸ºï¼š
try {
  const result = await riskyOperation();  // âœ… æœ‰é”™è¯¯å¤„ç†
} catch (error) {
  handleError(error);
}
```

### 6.4 å®é™…åº”ç”¨æŒ‡å—


**ğŸš€ å¼€å‘å®è·µå»ºè®®**
```
å‰ç«¯åº”ç”¨ï¼š
- APIè°ƒç”¨ä½¿ç”¨async/awaitæ›¿ä»£å›è°ƒ
- é¡µé¢æ•°æ®åŠ è½½ä¼˜åŒ–å¹¶å‘è·å–
- ç”¨æˆ·äº¤äº’å“åº”çš„å¼‚æ­¥å¤„ç†

åç«¯æœåŠ¡ï¼š
- æ•°æ®åº“æ“ä½œçš„å¼‚æ­¥å¤„ç†
- å¾®æœåŠ¡é—´çš„å¼‚æ­¥é€šä¿¡
- æ–‡ä»¶å¤„ç†å’Œæ‰¹é‡æ“ä½œ

é€šç”¨åŸåˆ™ï¼š
- ä»æœ€ç®€å•çš„async/awaitå¼€å§‹
- é€æ­¥å¼•å…¥å¹¶å‘å’Œé”™è¯¯å¤„ç†
- å…³æ³¨æ€§èƒ½ç“¶é¢ˆå¹¶ä¼˜åŒ–
- å»ºç«‹ç»Ÿä¸€çš„å¼‚æ­¥æ“ä½œè§„èŒƒ
```

**ğŸ’¡ è®°å¿†å£è¯€**
```
asyncå£°æ˜å¼‚æ­¥å‡½æ•°ï¼Œawaitç­‰å¾…ç»“æœæ¥
try/catché”™è¯¯è¦å¤„ç†ï¼ŒPromise.allå¹¶å‘å¿«
ç¼“å­˜é¢„è½½æ€§èƒ½å¥½ï¼Œæ‰¹é‡æ“ä½œæ•ˆç‡é«˜
èµ„æºç®¡ç†è¦åšå¥½ï¼Œå†…å­˜æ§åˆ¶ä¸èƒ½å°‘
```

**ğŸ¯ å­¦ä¹ è¿›é˜¶è·¯å¾„**
1. **åŸºç¡€æŒæ¡**ï¼šasync/awaitåŸºæœ¬è¯­æ³•å’Œé”™è¯¯å¤„ç†
2. **å¹¶å‘ç†è§£**ï¼šPromise.allã€raceã€allSettledçš„ä½¿ç”¨
3. **æ€§èƒ½ä¼˜åŒ–**ï¼šç¼“å­˜ã€æ‰¹é‡ã€å¹¶å‘æ§åˆ¶
4. **æ¶æ„è®¾è®¡**ï¼šå¼‚æ­¥æ“ä½œçš„æ•´ä½“è®¾è®¡æ¨¡å¼
5. **å®æˆ˜åº”ç”¨**ï¼šç»“åˆå…·ä½“ä¸šåŠ¡åœºæ™¯ä¼˜åŒ–å¼‚æ­¥ä»£ç 