---
title: 4ã€å¹¶å‘ä¼˜åŒ–æ€ç»´
---
## ğŸ“š ç›®å½•

1. [å¹¶å‘vså¹¶è¡Œï¼šæ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#1-å¹¶å‘vså¹¶è¡Œæ€§èƒ½ä¼˜åŒ–ç­–ç•¥)
2. [çº¿ç¨‹æ± è®¾è®¡ï¼šé«˜æ•ˆè®¾è®¡åŸåˆ™](#2-çº¿ç¨‹æ± è®¾è®¡é«˜æ•ˆè®¾è®¡åŸåˆ™)
3. [é”ä¼˜åŒ–ç­–ç•¥ï¼šå‡å°‘é”ç«äº‰](#3-é”ä¼˜åŒ–ç­–ç•¥å‡å°‘é”ç«äº‰)
4. [æ— é”ç¼–ç¨‹ï¼šLock-freeæ€§èƒ½ä¼˜åŠ¿](#4-æ— é”ç¼–ç¨‹lock-freeæ€§èƒ½ä¼˜åŠ¿)
5. [å¼‚æ­¥ç¼–ç¨‹æ¨¡å¼ï¼šæ€§èƒ½æå‡ä¹‹é“](#5-å¼‚æ­¥ç¼–ç¨‹æ¨¡å¼æ€§èƒ½æå‡ä¹‹é“)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”„ å¹¶å‘vså¹¶è¡Œï¼šæ€§èƒ½ä¼˜åŒ–ç­–ç•¥


### 1.1 å¹¶å‘ä¸å¹¶è¡Œçš„æœ¬è´¨åŒºåˆ«


**ğŸ”¸ é€šä¿—ç†è§£**
```
æ—¥å¸¸ç”Ÿæ´»æ¯”å–»ï¼š

å¹¶å‘ï¼ˆConcurrencyï¼‰ï¼š
ä¸€ä¸ªäººåŒæ—¶å¤„ç†å¤šä»¶äº‹ - è½®æµåš
æ¯”å¦‚ï¼šè¾¹ç…®é¥­è¾¹çœ‹ç”µè§†è¾¹æ¥ç”µè¯
å®é™…ï¼šå¿«é€Ÿåˆ‡æ¢ï¼Œçœ‹èµ·æ¥åŒæ—¶è¿›è¡Œ

å¹¶è¡Œï¼ˆParallelismï¼‰ï¼š
å¤šä¸ªäººå„è‡ªå¤„ç†ä¸åŒäº‹æƒ… - çœŸæ­£åŒæ—¶
æ¯”å¦‚ï¼š3ä¸ªäººåˆ†åˆ«ç…®é¥­ã€æ´—è¡£ã€æ‰“æ‰«
å®é™…ï¼šçœŸçš„åœ¨åŒä¸€æ—¶åˆ»è¿›è¡Œ
```

**ğŸ’¡ æŠ€æœ¯å±‚é¢çš„åŒºåˆ«**
```
å¹¶å‘ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä»»åŠ¡A   â”‚â†’â”‚ ä»»åŠ¡B   â”‚â†’â”‚ ä»»åŠ¡A   â”‚  CPU1
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
å¿«é€Ÿåˆ‡æ¢æ‰§è¡Œï¼Œå®è§‚ä¸ŠåŒæ—¶è¿›è¡Œ

å¹¶è¡Œï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä»»åŠ¡A   â”‚  â”‚ ä»»åŠ¡A   â”‚  â”‚ ä»»åŠ¡A   â”‚  CPU1
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä»»åŠ¡B   â”‚  â”‚ ä»»åŠ¡B   â”‚  â”‚ ä»»åŠ¡B   â”‚  CPU2
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
çœŸæ­£åŒæ—¶æ‰§è¡Œ
```

### 1.2 å¹¶å‘ä¼˜åŒ–ç­–ç•¥


**ğŸ¯ æ ¸å¿ƒä¼˜åŒ–æ€è·¯**
```
å‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼š
â€¢ ä»»åŠ¡åˆå¹¶ï¼šå°†å°ä»»åŠ¡åˆå¹¶æˆå¤§ä»»åŠ¡
â€¢ äº²å’Œæ€§è®¾ç½®ï¼šå°†ç›¸å…³ä»»åŠ¡ç»‘å®šåˆ°åŒä¸€CPU
â€¢ åˆç†çš„çº¿ç¨‹æ•°é‡ï¼šé¿å…è¿‡å¤šçº¿ç¨‹ç«äº‰

å‡å°‘é”ç«äº‰ï¼š
â€¢ é”ç²’åº¦æ§åˆ¶ï¼šç»†åŒ–é”çš„èŒƒå›´
â€¢ è¯»å†™åˆ†ç¦»ï¼šä½¿ç”¨è¯»å†™é”
â€¢ æ— é”è®¾è®¡ï¼šä½¿ç”¨åŸå­æ“ä½œ
```

**ğŸ’» å®é™…ä¼˜åŒ–ç¤ºä¾‹**
```java
// âŒ å¹¶å‘æ€§èƒ½å·®çš„å†™æ³•
public class BadConcurrency {
    private List<String> data = new ArrayList<>();
    
    public synchronized void addData(String item) {
        data.add(item);  // æ•´ä¸ªæ–¹æ³•éƒ½è¢«é”ä½
        processData();   // è€—æ—¶æ“ä½œä¹Ÿåœ¨é”å†…
    }
}

// âœ… å¹¶å‘æ€§èƒ½å¥½çš„å†™æ³•
public class GoodConcurrency {
    private ConcurrentLinkedQueue<String> data = new ConcurrentLinkedQueue<>();
    
    public void addData(String item) {
        data.offer(item);  // æ— é”æ“ä½œ
        // processData();  // è€—æ—¶æ“ä½œç§»åˆ°é”å¤–
    }
}
```

### 1.3 å¹¶è¡Œä¼˜åŒ–ç­–ç•¥


**ğŸš€ å¹¶è¡Œä¼˜åŒ–é‡ç‚¹**
```
æ•°æ®å¹¶è¡Œï¼š
â€¢ å°†å¤§æ•°æ®é›†åˆ†å‰²
â€¢ å¤šçº¿ç¨‹/è¿›ç¨‹å¹¶è¡Œå¤„ç†
â€¢ æœ€ååˆå¹¶ç»“æœ

ä»»åŠ¡å¹¶è¡Œï¼š
â€¢ å°†å¤§ä»»åŠ¡åˆ†è§£
â€¢ ä¸åŒçº¿ç¨‹å¤„ç†ä¸åŒå­ä»»åŠ¡
â€¢ æµæ°´çº¿å¼å¤„ç†
```

**ğŸ“Š å¹¶è¡Œæ€§èƒ½å¯¹æ¯”**
```
æ•°æ®è§„æ¨¡    ä¸²è¡Œè€—æ—¶    2çº¿ç¨‹å¹¶è¡Œ    4çº¿ç¨‹å¹¶è¡Œ    8çº¿ç¨‹å¹¶è¡Œ
100ä¸‡       1000ms     520ms       280ms       150ms
1000ä¸‡      10s        5.2s        2.8s        1.5s
1äº¿         100s       52s         28s         15s

ç†æƒ³åŠ é€Ÿæ¯” = æ ¸å¿ƒæ•°
å®é™…åŠ é€Ÿæ¯” < ç†æƒ³åŠ é€Ÿæ¯”ï¼ˆå› ä¸ºåŒæ­¥å¼€é”€ï¼‰
```

---

## 2. ğŸŠâ€â™‚ï¸ çº¿ç¨‹æ± è®¾è®¡ï¼šé«˜æ•ˆè®¾è®¡åŸåˆ™


### 2.1 çº¿ç¨‹æ± çš„æ ¸å¿ƒä»·å€¼


**ğŸ¯ ä¸ºä»€ä¹ˆéœ€è¦çº¿ç¨‹æ± **
```
é—®é¢˜ï¼šé¢‘ç¹åˆ›å»ºé”€æ¯çº¿ç¨‹çš„ä»£ä»·

åˆ›å»ºçº¿ç¨‹çš„æˆæœ¬ï¼š
â€¢ åˆ†é…æ ˆç©ºé—´ï¼ˆé€šå¸¸1-8MBï¼‰
â€¢ ç³»ç»Ÿè°ƒç”¨å¼€é”€
â€¢ çº¿ç¨‹åˆå§‹åŒ–å¼€é”€

é”€æ¯çº¿ç¨‹çš„æˆæœ¬ï¼š
â€¢ èµ„æºå›æ”¶
â€¢ ç³»ç»Ÿè°ƒç”¨
â€¢ å†…å­˜æ¸…ç†

çº¿ç¨‹æ± çš„ä»·å€¼ï¼š
â€¢ å¤ç”¨çº¿ç¨‹ï¼Œé¿å…é¢‘ç¹åˆ›å»ºé”€æ¯
â€¢ æ§åˆ¶å¹¶å‘æ•°é‡ï¼Œé¿å…èµ„æºè€—å°½
â€¢ æä¾›ä»»åŠ¡é˜Ÿåˆ—ï¼Œå¹³æ»‘å¤„ç†çªå‘è¯·æ±‚
```

**ğŸ“ˆ æ€§èƒ½æå‡æ•ˆæœ**
```
åœºæ™¯å¯¹æ¯”ï¼š

ç›´æ¥åˆ›å»ºçº¿ç¨‹ï¼š
æ¯ä¸ªè¯·æ±‚ â†’ åˆ›å»ºæ–°çº¿ç¨‹ â†’ æ‰§è¡Œ â†’ é”€æ¯çº¿ç¨‹
è€—æ—¶ï¼šåˆ›å»º(5ms) + æ‰§è¡Œ(10ms) + é”€æ¯(3ms) = 18ms

ä½¿ç”¨çº¿ç¨‹æ± ï¼š
æ¯ä¸ªè¯·æ±‚ â†’ ä»æ± ä¸­è·å–çº¿ç¨‹ â†’ æ‰§è¡Œ â†’ å½’è¿˜çº¿ç¨‹
è€—æ—¶ï¼šè·å–(0.1ms) + æ‰§è¡Œ(10ms) + å½’è¿˜(0.1ms) = 10.2ms

æ€§èƒ½æå‡ï¼šçº¦76%ï¼
```

### 2.2 çº¿ç¨‹æ± æ ¸å¿ƒå‚æ•°è®¾è®¡


**ğŸ”§ å…³é”®å‚æ•°è¯´æ˜**
```java
ThreadPoolExecutor pool = new ThreadPoolExecutor(
    corePoolSize,    // æ ¸å¿ƒçº¿ç¨‹æ•°ï¼šä¸€ç›´ä¿æ´»çš„çº¿ç¨‹
    maximumPoolSize, // æœ€å¤§çº¿ç¨‹æ•°ï¼šé«˜å³°æœŸæœ€å¤šçº¿ç¨‹
    keepAliveTime,   // ç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´
    timeUnit,        // æ—¶é—´å•ä½
    workQueue,       // ä»»åŠ¡é˜Ÿåˆ—ï¼šå­˜æ”¾ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡
    threadFactory,   // çº¿ç¨‹å·¥å‚ï¼šåˆ›å»ºçº¿ç¨‹çš„æ–¹å¼
    rejectedHandler  // æ‹’ç»ç­–ç•¥ï¼šé˜Ÿåˆ—æ»¡æ—¶å¦‚ä½•å¤„ç†
);
```

**ğŸ“Š å‚æ•°è®¾ç½®æŒ‡å¯¼åŸåˆ™**

| å‚æ•°ç±»å‹ | **IOå¯†é›†å‹ä»»åŠ¡** | **CPUå¯†é›†å‹ä»»åŠ¡** | **æ··åˆå‹ä»»åŠ¡** |
|---------|-----------------|------------------|----------------|
| ğŸ”¸ **æ ¸å¿ƒçº¿ç¨‹æ•°** | `2 Ã— CPUæ ¸å¿ƒæ•°` | `CPUæ ¸å¿ƒæ•°` | `1.5 Ã— CPUæ ¸å¿ƒæ•°` |
| ğŸ”¸ **æœ€å¤§çº¿ç¨‹æ•°** | `æ ¸å¿ƒçº¿ç¨‹æ•° Ã— 2` | `æ ¸å¿ƒçº¿ç¨‹æ•° + 1` | `æ ¸å¿ƒçº¿ç¨‹æ•° Ã— 1.5` |
| ğŸ”¸ **é˜Ÿåˆ—å®¹é‡** | `è¾ƒå¤§(1000+)` | `è¾ƒå°(100-500)` | `ä¸­ç­‰(500-1000)` |

### 2.3 çº¿ç¨‹æ± ä¼˜åŒ–å®è·µ


**ğŸ’¡ é«˜æ•ˆçº¿ç¨‹æ± è®¾è®¡**
```java
public class OptimizedThreadPool {
    
    // âœ… é’ˆå¯¹ä¸åŒä»»åŠ¡ç±»å‹ä¼˜åŒ–
    public static ThreadPoolExecutor createIOPool() {
        return new ThreadPoolExecutor(
            16,  // IOå¯†é›†ï¼šå¤šçº¿ç¨‹ç­‰å¾…IO
            32,
            60L, TimeUnit.SECONDS,
            new LinkedBlockingQueue<>(1000),
            new ThreadFactory() {
                private AtomicInteger counter = new AtomicInteger(0);
                public Thread newThread(Runnable r) {
                    Thread t = new Thread(r, "io-pool-" + counter.incrementAndGet());
                    t.setDaemon(false);  // éå®ˆæŠ¤çº¿ç¨‹
                    return t;
                }
            },
            new ThreadPoolExecutor.CallerRunsPolicy()  // è°ƒç”¨è€…æ‰§è¡Œç­–ç•¥
        );
    }
    
    public static ThreadPoolExecutor createCPUPool() {
        int cores = Runtime.getRuntime().availableProcessors();
        return new ThreadPoolExecutor(
            cores,     // CPUå¯†é›†ï¼šé¿å…è¿‡å¤šçº¿ç¨‹ç«äº‰
            cores + 1,
            30L, TimeUnit.SECONDS,
            new LinkedBlockingQueue<>(200),
            r -> new Thread(r, "cpu-pool"),
            new ThreadPoolExecutor.AbortPolicy()  // ç›´æ¥æ‹’ç»ç­–ç•¥
        );
    }
}
```

**âš ï¸ å¸¸è§è®¾è®¡é™·é˜±**
```java
// âŒ å¸¸è§é”™è¯¯
ThreadPoolExecutor badPool = new ThreadPoolExecutor(
    1, 1,  // çº¿ç¨‹æ•°å¤ªå°‘ï¼Œæˆä¸ºç“¶é¢ˆ
    0L, TimeUnit.MILLISECONDS,
    new LinkedBlockingQueue<>(),  // æ— ç•Œé˜Ÿåˆ—ï¼Œå¯èƒ½OOM
    Executors.defaultThreadFactory(),
    new ThreadPoolExecutor.DiscardPolicy()  // é™é»˜ä¸¢å¼ƒï¼Œéš¾ä»¥å‘ç°é—®é¢˜
);

// âœ… æ­£ç¡®åšæ³•
ThreadPoolExecutor goodPool = new ThreadPoolExecutor(
    8, 16,  // åˆç†çš„çº¿ç¨‹æ•°èŒƒå›´
    60L, TimeUnit.SECONDS,
    new LinkedBlockingQueue<>(1000),  // æœ‰ç•Œé˜Ÿåˆ—
    new NamedThreadFactory("business"),
    new ThreadPoolExecutor.CallerRunsPolicy()  // é™çº§ç­–ç•¥
);
```

---

## 3. ğŸ”’ é”ä¼˜åŒ–ç­–ç•¥ï¼šå‡å°‘é”ç«äº‰


### 3.1 é”ç«äº‰çš„æ€§èƒ½å½±å“


**ğŸ¯ é”ç«äº‰çš„æœ¬è´¨é—®é¢˜**
```
é”ç«äº‰å¯¼è‡´çš„æ€§èƒ½æŸå¤±ï¼š

ç­‰å¾…æ—¶é—´ï¼š
çº¿ç¨‹A â”€â”€è·å¾—é”â”€â”€> æ‰§è¡Œ â”€â”€é‡Šæ”¾é”â”€â”€>
çº¿ç¨‹B        â””ç­‰å¾…â”˜     æ‰§è¡Œ
çº¿ç¨‹C          â””ç­‰å¾…ç­‰å¾…â”˜ æ‰§è¡Œ

ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼š
â€¢ çº¿ç¨‹é˜»å¡ â†’ å†…æ ¸æ€åˆ‡æ¢
â€¢ çº¿ç¨‹å”¤é†’ â†’ é‡æ–°è°ƒåº¦
â€¢ CPUç¼“å­˜å¤±æ•ˆ

å†…å­˜åŒæ­¥ï¼š
â€¢ ç¼“å­˜ä¸€è‡´æ€§åè®®å¼€é”€
â€¢ å†…å­˜å±éšœæŒ‡ä»¤
â€¢ è·¨CPUæ ¸å¿ƒé€šä¿¡
```

**ğŸ“Š é”ç«äº‰æ€§èƒ½æ•°æ®**
```
ç«äº‰ç¨‹åº¦    å“åº”æ—¶é—´    ååé‡ä¸‹é™
ä½ç«äº‰      +5%        -2%
ä¸­ç«äº‰      +50%       -30%
é«˜ç«äº‰      +300%      -80%
```

### 3.2 é”ç²’åº¦ä¼˜åŒ–ç­–ç•¥


**ğŸ”¸ ç»†åŒ–é”ç²’åº¦**
```java
// âŒ ç²—ç²’åº¦é” - æ•´ä¸ªå¯¹è±¡è¢«é”
public class CoarseLock {
    private Map<String, Integer> data = new HashMap<>();
    
    public synchronized void updateUserScore(String user, int score) {
        data.put(user, score);  // æ‰€æœ‰ç”¨æˆ·æ›´æ–°éƒ½è¦æ’é˜Ÿ
    }
    
    public synchronized int getUserScore(String user) {
        return data.get(user);  // è¯»å–ä¹Ÿè¦æ’é˜Ÿç­‰å¾…
    }
}

// âœ… ç»†ç²’åº¦é” - åˆ†æ®µé”
public class FineGrainedLock {
    private final int segments = 16;
    private final Object[] locks = new Object[segments];
    private final Map<String, Integer>[] maps = new Map[segments];
    
    public FineGrainedLock() {
        for (int i = 0; i < segments; i++) {
            locks[i] = new Object();
            maps[i] = new HashMap<>();
        }
    }
    
    private int getSegment(String key) {
        return Math.abs(key.hashCode()) % segments;
    }
    
    public void updateUserScore(String user, int score) {
        int segment = getSegment(user);
        synchronized (locks[segment]) {  // åªé”å¯¹åº”æ®µ
            maps[segment].put(user, score);
        }
    }
}
```

### 3.3 è¯»å†™åˆ†ç¦»ä¼˜åŒ–


**ğŸ”„ è¯»å†™é”çš„å¨åŠ›**
```java
// âœ… è¯»å†™é”ä¼˜åŒ– - è¯»ä¸äº’æ–¥
public class ReadWriteOptimized {
    private final ReadWriteLock rwLock = new ReentrantReadWriteLock();
    private final Lock readLock = rwLock.readLock();
    private final Lock writeLock = rwLock.writeLock();
    private Map<String, String> cache = new HashMap<>();
    
    // è¯»æ“ä½œï¼šå¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è¯»
    public String getValue(String key) {
        readLock.lock();
        try {
            return cache.get(key);
        } finally {
            readLock.unlock();
        }
    }
    
    // å†™æ“ä½œï¼šç‹¬å è®¿é—®
    public void setValue(String key, String value) {
        writeLock.lock();
        try {
            cache.put(key, value);
        } finally {
            writeLock.unlock();
        }
    }
}
```

**ğŸ“ˆ è¯»å†™é”æ€§èƒ½æå‡**
```
åœºæ™¯ï¼šè¯»å¤šå†™å°‘ï¼ˆè¯»å†™æ¯”ä¾‹ 8:2ï¼‰

æ™®é€šsynchronizedï¼š
æ‰€æœ‰æ“ä½œéƒ½äº’æ–¥ï¼Œååé‡ = 100 ops/s

è¯»å†™é”ï¼š
è¯»æ“ä½œå¹¶å‘ï¼Œå†™æ“ä½œç‹¬å ï¼Œååé‡ = 400 ops/s
æ€§èƒ½æå‡ï¼š4å€ï¼
```

### 3.4 é”æ¶ˆé™¤å’Œé”ç²—åŒ–


**ğŸš€ JVMè‡ªåŠ¨ä¼˜åŒ–**
```java
// é”æ¶ˆé™¤ç¤ºä¾‹
public String createString() {
    // StringBufferå†…éƒ¨æœ‰åŒæ­¥ï¼Œä½†è¿™é‡Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®
    StringBuffer sb = new StringBuffer();  // JVMä¼šæ¶ˆé™¤å†…éƒ¨çš„é”
    sb.append("Hello");
    sb.append(" World");
    return sb.toString();
}

// é”ç²—åŒ–ç¤ºä¾‹
public void appendStrings(StringBuffer sb) {
    // åŸæœ¬æ¯æ¬¡appendéƒ½è¦è·å–é”
    sb.append("a");  // è·å–é”
    sb.append("b");  // è·å–é”  
    sb.append("c");  // è·å–é”
    
    // JVMä¼˜åŒ–åï¼šç²—åŒ–ä¸ºä¸€ä¸ªå¤§é”
    // lock -> append("a") + append("b") + append("c") -> unlock
}
```

---

## 4. ğŸš« æ— é”ç¼–ç¨‹ï¼šLock-freeæ€§èƒ½ä¼˜åŠ¿


### 4.1 æ— é”ç¼–ç¨‹çš„æ ¸å¿ƒæ€æƒ³


**ğŸ¯ æ— é”ç¼–ç¨‹çš„æœ¬è´¨**
```
ä¼ ç»Ÿé”æœºåˆ¶ï¼š
çº¿ç¨‹A: è·å–é” â†’ ä¿®æ”¹æ•°æ® â†’ é‡Šæ”¾é”
çº¿ç¨‹B:      ç­‰å¾… â†’ è·å–é” â†’ ä¿®æ”¹æ•°æ® â†’ é‡Šæ”¾é”
çº¿ç¨‹C:           ç­‰å¾…ç­‰å¾… â†’ è·å–é” â†’ ...

æ— é”æœºåˆ¶ï¼š
çº¿ç¨‹A: è¯»å– â†’ è®¡ç®—æ–°å€¼ â†’ CASå°è¯•æ›´æ–° â†’ æˆåŠŸ
çº¿ç¨‹B: è¯»å– â†’ è®¡ç®—æ–°å€¼ â†’ CASå°è¯•æ›´æ–° â†’ å¤±è´¥é‡è¯• â†’ æˆåŠŸ
çº¿ç¨‹C: è¯»å– â†’ è®¡ç®—æ–°å€¼ â†’ CASå°è¯•æ›´æ–° â†’ æˆåŠŸ

æ ¸å¿ƒï¼šç”¨åŸå­æ“ä½œæ›¿ä»£é”ï¼Œé¿å…çº¿ç¨‹é˜»å¡
```

**âš¡ CASï¼ˆCompare-And-Swapï¼‰åŸç†**
```
CASæ“ä½œçš„ä¸‰ä¸ªå‚æ•°ï¼š
â€¢ å†…å­˜ä½ç½® V
â€¢ é¢„æœŸåŸå€¼ A  
â€¢ æ–°å€¼ B

CASçš„æ‰§è¡Œé€»è¾‘ï¼š
if (V == A) {
    V = B;  // åŸå­æ“ä½œï¼šæ¯”è¾ƒå¹¶äº¤æ¢
    return true;
} else {
    return false;  // å…¶ä»–çº¿ç¨‹å·²ç»ä¿®æ”¹äº†V
}
```

### 4.2 æ— é”æ•°æ®ç»“æ„å®ç°


**ğŸ”¸ æ— é”è®¡æ•°å™¨**
```java
// âŒ æœ‰é”ç‰ˆæœ¬
public class LockCounter {
    private int count = 0;
    
    public synchronized int increment() {
        return ++count;  // éœ€è¦è·å–é”
    }
}

// âœ… æ— é”ç‰ˆæœ¬
public class LockFreeCounter {
    private AtomicInteger count = new AtomicInteger(0);
    
    public int increment() {
        return count.incrementAndGet();  // åŸå­æ“ä½œï¼Œæ— éœ€é”
    }
    
    // æ‰‹åŠ¨å®ç°CASç‰ˆæœ¬
    public int incrementManual() {
        int current;
        int next;
        do {
            current = count.get();     // è¯»å–å½“å‰å€¼
            next = current + 1;        // è®¡ç®—æ–°å€¼
        } while (!count.compareAndSet(current, next));  // CASé‡è¯•
        return next;
    }
}
```

**ğŸ”— æ— é”æ ˆå®ç°**
```java
public class LockFreeStack<T> {
    private AtomicReference<Node<T>> head = new AtomicReference<>();
    
    private static class Node<T> {
        final T data;
        Node<T> next;
        
        Node(T data) { this.data = data; }
    }
    
    public void push(T item) {
        Node<T> newNode = new Node<>(item);
        Node<T> currentHead;
        
        do {
            currentHead = head.get();      // è¯»å–å½“å‰å¤´èŠ‚ç‚¹
            newNode.next = currentHead;    // æ–°èŠ‚ç‚¹æŒ‡å‘å½“å‰å¤´
        } while (!head.compareAndSet(currentHead, newNode));  // CASæ›´æ–°å¤´èŠ‚ç‚¹
    }
    
    public T pop() {
        Node<T> currentHead;
        Node<T> newHead;
        
        do {
            currentHead = head.get();
            if (currentHead == null) return null;  // æ ˆä¸ºç©º
            newHead = currentHead.next;
        } while (!head.compareAndSet(currentHead, newHead));
        
        return currentHead.data;
    }
}
```

### 4.3 æ— é”ç¼–ç¨‹çš„æ€§èƒ½ä¼˜åŠ¿


**ğŸ“Š æ€§èƒ½å¯¹æ¯”æ•°æ®**
```
åœºæ™¯ï¼šé«˜å¹¶å‘è®¡æ•°å™¨ï¼ˆ16çº¿ç¨‹ï¼‰

æœ‰é”ç‰ˆæœ¬ï¼ˆsynchronizedï¼‰ï¼š
â€¢ ååé‡ï¼š200ä¸‡æ¬¡/ç§’
â€¢ å¹³å‡å»¶è¿Ÿï¼š0.8ms
â€¢ 99%å»¶è¿Ÿï¼š15ms

æ— é”ç‰ˆæœ¬ï¼ˆAtomicIntegerï¼‰ï¼š
â€¢ ååé‡ï¼š800ä¸‡æ¬¡/ç§’
â€¢ å¹³å‡å»¶è¿Ÿï¼š0.2ms  
â€¢ 99%å»¶è¿Ÿï¼š1ms

æ€§èƒ½æå‡ï¼š4å€ååé‡ï¼Œå»¶è¿Ÿé™ä½75%
```

**âš ï¸ æ— é”ç¼–ç¨‹çš„å±€é™æ€§**
```
ABAé—®é¢˜ï¼š
1. çº¿ç¨‹Aè¯»å–å€¼ä¸ºA
2. çº¿ç¨‹Bå°†Aæ”¹ä¸ºBï¼Œåˆæ”¹å›A
3. çº¿ç¨‹Açš„CASæ“ä½œæˆåŠŸï¼Œä½†å®é™…ä¸Šå€¼å·²ç»è¢«ä¿®æ”¹è¿‡

è§£å†³æ–¹æ¡ˆï¼š
â€¢ ä½¿ç”¨ç‰ˆæœ¬å·ï¼ˆAtomicStampedReferenceï¼‰
â€¢ ä½¿ç”¨å¼•ç”¨æ ‡è®°ï¼ˆAtomicMarkableReferenceï¼‰

å¤æ‚åº¦é—®é¢˜ï¼š
â€¢ ç®€å•æ“ä½œé€‚åˆæ— é”
â€¢ å¤æ‚æ“ä½œå®ç°å›°éš¾
â€¢ è°ƒè¯•éš¾åº¦å¤§
```

---

## 5. âš¡ å¼‚æ­¥ç¼–ç¨‹æ¨¡å¼ï¼šæ€§èƒ½æå‡ä¹‹é“


### 5.1 å¼‚æ­¥ç¼–ç¨‹çš„æ ¸å¿ƒä»·å€¼


**ğŸ¯ å¼‚æ­¥vsåŒæ­¥çš„æ€§èƒ½å·®å¼‚**
```
åŒæ­¥ç¼–ç¨‹æ¨¡å‹ï¼š
è¯·æ±‚1 â†’ å¤„ç† â†’ ç­‰å¾…IO â†’ è¿”å›ç»“æœ â”
                              â”œâ”€ ä¸²è¡Œæ‰§è¡Œï¼Œèµ„æºåˆ©ç”¨ç‡ä½
è¯·æ±‚2 â†’       ç­‰å¾… â†’ å¤„ç† â†’ ç­‰å¾…IO â†’ è¿”å›ç»“æœ

å¼‚æ­¥ç¼–ç¨‹æ¨¡å‹ï¼š
è¯·æ±‚1 â†’ å¤„ç† â†’ å‘èµ·IO â†’ å¤„ç†å…¶ä»–è¯·æ±‚
è¯·æ±‚2 â†’ å¤„ç† â†’ å‘èµ·IO â†’ å¤„ç†å…¶ä»–è¯·æ±‚  
è¯·æ±‚3 â†’ å¤„ç† â†’ å‘èµ·IO â†’ å¤„ç†å…¶ä»–è¯·æ±‚
      â†“
    IOå®Œæˆå›è°ƒ â†’ è¿”å›ç»“æœ
```

**ğŸ“ˆ æ€§èƒ½æå‡æ•ˆæœ**
```
WebæœåŠ¡å™¨å¯¹æ¯”ï¼š

ä¼ ç»Ÿçº¿ç¨‹æ¨¡å‹ï¼ˆTomcaté»˜è®¤ï¼‰ï¼š
â€¢ æ¯è¯·æ±‚ä¸€çº¿ç¨‹
â€¢ 200ä¸ªå¹¶å‘è¿æ¥ = 200ä¸ªçº¿ç¨‹
â€¢ å†…å­˜å ç”¨ï¼š200 Ã— 8MB = 1.6GB
â€¢ ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€å¤§

å¼‚æ­¥æ¨¡å‹ï¼ˆNetty/Node.jsï¼‰ï¼š
â€¢ äº‹ä»¶å¾ªç¯ + å°‘é‡çº¿ç¨‹
â€¢ 10000ä¸ªå¹¶å‘è¿æ¥ = 10-20ä¸ªçº¿ç¨‹
â€¢ å†…å­˜å ç”¨ï¼š20 Ã— 8MB = 160MB
â€¢ å‡ ä¹æ— ä¸Šä¸‹æ–‡åˆ‡æ¢

å¹¶å‘èƒ½åŠ›æå‡ï¼š50å€ä»¥ä¸Šï¼
```

### 5.2 Javaå¼‚æ­¥ç¼–ç¨‹å®è·µ


**ğŸ”¸ CompletableFutureå¼‚æ­¥ç¼–ç¨‹**
```java
public class AsyncProgramming {
    
    // âŒ åŒæ­¥ç‰ˆæœ¬ - ä¸²è¡Œæ‰§è¡Œ
    public String fetchUserInfo(String userId) {
        String userProfile = callUserService(userId);    // 100ms
        String userOrders = callOrderService(userId);    // 150ms  
        String userPrefs = callPreferenceService(userId); // 80ms
        
        return combineResults(userProfile, userOrders, userPrefs);
        // æ€»è€—æ—¶ï¼š100 + 150 + 80 = 330ms
    }
    
    // âœ… å¼‚æ­¥ç‰ˆæœ¬ - å¹¶è¡Œæ‰§è¡Œ
    public CompletableFuture<String> fetchUserInfoAsync(String userId) {
        CompletableFuture<String> profileFuture = 
            CompletableFuture.supplyAsync(() -> callUserService(userId));
            
        CompletableFuture<String> ordersFuture = 
            CompletableFuture.supplyAsync(() -> callOrderService(userId));
            
        CompletableFuture<String> prefsFuture = 
            CompletableFuture.supplyAsync(() -> callPreferenceService(userId));
        
        return CompletableFuture.allOf(profileFuture, ordersFuture, prefsFuture)
            .thenApply(v -> combineResults(
                profileFuture.join(),
                ordersFuture.join(), 
                prefsFuture.join()
            ));
        // æ€»è€—æ—¶ï¼šmax(100, 150, 80) = 150msï¼Œæå‡55%ï¼
    }
}
```

**ğŸ”„ å¼‚æ­¥ç¼–ç¨‹æ¨¡å¼**
```java
public class AsyncPatterns {
    
    // é“¾å¼å¼‚æ­¥æ“ä½œ
    public CompletableFuture<String> processUserData(String userId) {
        return CompletableFuture
            .supplyAsync(() -> fetchUser(userId))           // æ­¥éª¤1
            .thenCompose(user -> validateUser(user))        // æ­¥éª¤2
            .thenCompose(user -> enrichUserData(user))      // æ­¥éª¤3
            .thenApply(user -> formatResult(user))          // æ­¥éª¤4
            .exceptionally(throwable -> {                   // å¼‚å¸¸å¤„ç†
                log.error("å¤„ç†ç”¨æˆ·æ•°æ®å¤±è´¥", throwable);
                return "é»˜è®¤ç»“æœ";
            });
    }
    
    // ç»„åˆå¤šä¸ªå¼‚æ­¥æ“ä½œ
    public CompletableFuture<OrderSummary> createOrderSummary(String userId) {
        CompletableFuture<User> userFuture = fetchUserAsync(userId);
        CompletableFuture<List<Order>> ordersFuture = fetchOrdersAsync(userId);
        CompletableFuture<Double> balanceFuture = fetchBalanceAsync(userId);
        
        return CompletableFuture.allOf(userFuture, ordersFuture, balanceFuture)
            .thenApply(v -> new OrderSummary(
                userFuture.join(),
                ordersFuture.join(),
                balanceFuture.join()
            ));
    }
}
```

### 5.3 äº‹ä»¶é©±åŠ¨æ¶æ„


**ğŸ® äº‹ä»¶å¾ªç¯æ¨¡å‹**
```
äº‹ä»¶å¾ªç¯æ¶æ„ï¼š

â”Œâ”€ äº‹ä»¶é˜Ÿåˆ— â”€â”
â”‚ è¯·æ±‚A      â”‚
â”‚ è¯·æ±‚B      â”‚  â†’ äº‹ä»¶å¾ªç¯çº¿ç¨‹ â†’ å¤„ç†é€»è¾‘ â†’ å‘èµ·å¼‚æ­¥IO
â”‚ è¯·æ±‚C      â”‚        â†‘                        â†“
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€ IOå®Œæˆå›è°ƒ â†â”€â”€â”€ å¼‚æ­¥IOæ“ä½œ

ç‰¹ç‚¹ï¼š
â€¢ å•çº¿ç¨‹äº‹ä»¶å¾ªç¯ï¼ˆé¿å…é”ç«äº‰ï¼‰
â€¢ éé˜»å¡IOæ“ä½œ
â€¢ äº‹ä»¶é©±åŠ¨å›è°ƒ
â€¢ é«˜å¹¶å‘ä½å»¶è¿Ÿ
```

**ğŸ’¡ äº‹ä»¶é©±åŠ¨æœ€ä½³å®è·µ**
```java
// âœ… å¼‚æ­¥äº‹ä»¶å¤„ç†
@Component
public class OrderEventHandler {
    
    @Async("orderPool")
    @EventListener
    public void handleOrderCreated(OrderCreatedEvent event) {
        // å¼‚æ­¥å¤„ç†ï¼Œä¸é˜»å¡ä¸»æµç¨‹
        sendConfirmationEmail(event.getOrder());
        updateInventory(event.getOrder());
        syncToDataWarehouse(event.getOrder());
    }
    
    @Async("notificationPool")  
    @EventListener
    public void handlePaymentCompleted(PaymentCompletedEvent event) {
        // ä¸åŒäº‹ä»¶ç”¨ä¸åŒçº¿ç¨‹æ± 
        sendPaymentNotification(event);
        updateOrderStatus(event);
    }
}

// é…ç½®å¼‚æ­¥çº¿ç¨‹æ± 
@Configuration
@EnableAsync
public class AsyncConfig {
    
    @Bean("orderPool")
    public TaskExecutor orderTaskExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(5);
        executor.setMaxPoolSize(10);
        executor.setQueueCapacity(200);
        executor.setThreadNamePrefix("order-async-");
        return executor;
    }
}
```

### 5.4 å¼‚æ­¥ç¼–ç¨‹çš„æ³¨æ„äº‹é¡¹


**âš ï¸ å¸¸è§é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ**
```java
// âŒ é˜»å¡å¼‚æ­¥çº¿ç¨‹æ± 
CompletableFuture.supplyAsync(() -> {
    Thread.sleep(5000);  // é˜»å¡çº¿ç¨‹æ± çº¿ç¨‹
    return "result";
}, commonPool);  // å¯èƒ½è€—å°½å…¬å…±çº¿ç¨‹æ± 

// âœ… æ­£ç¡®çš„å¼‚æ­¥è°ƒç”¨
CompletableFuture.supplyAsync(() -> {
    return callExternalApiAsync();  // çœŸæ­£çš„å¼‚æ­¥è°ƒç”¨
}, customExecutor);

// âŒ å¼‚å¸¸å¤„ç†ä¸å½“
CompletableFuture.supplyAsync(() -> {
    return riskyOperation();  // å¯èƒ½æŠ›å¼‚å¸¸
}).thenApply(result -> {
    return processResult(result);  // å¼‚å¸¸ä¼šä¼ æ’­
});

// âœ… å®Œå–„çš„å¼‚å¸¸å¤„ç†
CompletableFuture.supplyAsync(() -> {
    return riskyOperation();
}).handle((result, throwable) -> {
    if (throwable != null) {
        log.error("æ“ä½œå¤±è´¥", throwable);
        return getDefaultResult();  // é™çº§å¤„ç†
    }
    return result;
}).thenApply(result -> processResult(result));
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å¹¶å‘vså¹¶è¡Œï¼šç†è§£åŒºåˆ«ï¼Œé€‰æ‹©åˆé€‚çš„ä¼˜åŒ–ç­–ç•¥
ğŸ”¸ çº¿ç¨‹æ± è®¾è®¡ï¼šæ ¹æ®ä»»åŠ¡ç‰¹æ€§é…ç½®å‚æ•°ï¼Œé¿å…èµ„æºæµªè´¹
ğŸ”¸ é”ä¼˜åŒ–ï¼šå‡å°‘é”ç²’åº¦ï¼Œä½¿ç”¨è¯»å†™é”ï¼Œé¿å…é”ç«äº‰
ğŸ”¸ æ— é”ç¼–ç¨‹ï¼šåˆ©ç”¨CASå®ç°é«˜æ€§èƒ½æ•°æ®ç»“æ„
ğŸ”¸ å¼‚æ­¥ç¼–ç¨‹ï¼šæé«˜èµ„æºåˆ©ç”¨ç‡ï¼Œå®ç°é«˜å¹¶å‘
```

### 6.2 æ€§èƒ½ä¼˜åŒ–çš„æ ¸å¿ƒæ€è·¯


**ğŸ”¹ å‡å°‘ç­‰å¾…æ—¶é—´**
```
ç­–ç•¥ä¼˜å…ˆçº§ï¼š
1. æ— é” > ç»†ç²’åº¦é” > ç²—ç²’åº¦é”
2. å¼‚æ­¥ > åŒæ­¥
3. å¹¶è¡Œ > ä¸²è¡Œ
4. ç¼“å­˜ > è®¡ç®—
```

**ğŸ”¹ æé«˜èµ„æºåˆ©ç”¨ç‡**
```
å…³é”®æŒ‡æ ‡ï¼š
â€¢ CPUåˆ©ç”¨ç‡ï¼šé¿å…çº¿ç¨‹é˜»å¡
â€¢ å†…å­˜åˆ©ç”¨ç‡ï¼šåˆç†çš„çº¿ç¨‹æ•°å’Œé˜Ÿåˆ—å¤§å°
â€¢ IOåˆ©ç”¨ç‡ï¼šå¼‚æ­¥æ“ä½œï¼Œé¿å…ç­‰å¾…
â€¢ ç¼“å­˜å‘½ä¸­ç‡ï¼šå‡å°‘é‡å¤è®¡ç®—å’ŒIO
```

### 6.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ’¡ æŠ€æœ¯é€‰å‹å†³ç­–**
```
åœºæ™¯åˆ†æï¼š

CPUå¯†é›†å‹ï¼š
âœ… çº¿ç¨‹æ•° = CPUæ ¸å¿ƒæ•°
âœ… æ— é”æ•°æ®ç»“æ„
âŒ é¿å…è¿‡å¤šçº¿ç¨‹ç«äº‰

IOå¯†é›†å‹ï¼š
âœ… å¼‚æ­¥ç¼–ç¨‹æ¨¡å¼
âœ… è¾ƒå¤šçº¿ç¨‹æ•°ï¼ˆ2å€CPUæ ¸å¿ƒæ•°ï¼‰
âœ… äº‹ä»¶é©±åŠ¨æ¶æ„

æ··åˆå‹ï¼š
âœ… åˆ†ç¦»å¤„ç†ï¼šCPUä»»åŠ¡ + IOä»»åŠ¡
âœ… ä¸åŒçº¿ç¨‹æ± ç­–ç•¥
âœ… è¯»å†™åˆ†ç¦»
```

**ğŸ¯ æ€§èƒ½ä¼˜åŒ–æ­¥éª¤**
```
1. æ€§èƒ½åˆ†æï¼šæ‰¾å‡ºç“¶é¢ˆç‚¹
2. é€‰æ‹©ç­–ç•¥ï¼šæ ¹æ®åœºæ™¯é€‰æ‹©ä¼˜åŒ–æ–¹å‘
3. å®æ–½ä¼˜åŒ–ï¼šæ¸è¿›å¼æ”¹è¿›
4. æ€§èƒ½æµ‹è¯•ï¼šéªŒè¯ä¼˜åŒ–æ•ˆæœ
5. ç›‘æ§å‘Šè­¦ï¼šæŒç»­å…³æ³¨æ€§èƒ½æŒ‡æ ‡
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- å¹¶å‘æ˜¯å¤šä»»åŠ¡äº¤æ›¿ï¼Œå¹¶è¡Œæ˜¯å¤šä»»åŠ¡åŒæ—¶
- çº¿ç¨‹æ± å¤ç”¨èµ„æºï¼Œå‚æ•°è®¾ç½®è¦åˆç†
- é”ç«äº‰æ˜¯æ€§èƒ½æ€æ‰‹ï¼Œèƒ½é¿å…å°±é¿å…
- æ— é”ç¼–ç¨‹ç”¨CASï¼Œç®€å•åœºæ™¯å¨åŠ›å¤§
- å¼‚æ­¥ç¼–ç¨‹é‡Šæ”¾çº¿ç¨‹ï¼Œé«˜å¹¶å‘çš„å¿…å¤‡ç¥å™¨