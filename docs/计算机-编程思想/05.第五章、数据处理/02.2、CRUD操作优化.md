---
title: 2ã€CRUDæ“ä½œä¼˜åŒ–
---
## ğŸ“š ç›®å½•

1. [CRUDæ“ä½œåŸºç¡€è®¤çŸ¥](#1-CRUDæ“ä½œåŸºç¡€è®¤çŸ¥)
2. [å¢åˆ æ”¹æŸ¥æœ€ä½³å®è·µ](#2-å¢åˆ æ”¹æŸ¥æœ€ä½³å®è·µ)
3. [æ‰¹é‡æ“ä½œä¼˜åŒ–ç­–ç•¥](#3-æ‰¹é‡æ“ä½œä¼˜åŒ–ç­–ç•¥)
4. [åˆ†é¡µæŸ¥è¯¢è®¾è®¡ä¸ä¼˜åŒ–](#4-åˆ†é¡µæŸ¥è¯¢è®¾è®¡ä¸ä¼˜åŒ–)
5. [è½¯åˆ é™¤vsç¡¬åˆ é™¤é€‰æ‹©](#5-è½¯åˆ é™¤vsç¡¬åˆ é™¤é€‰æ‹©)
6. [CRUDæ“ä½œæ€ç»´ä½“ç³»](#6-CRUDæ“ä½œæ€ç»´ä½“ç³»)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ CRUDæ“ä½œåŸºç¡€è®¤çŸ¥


### 1.1 ä»€ä¹ˆæ˜¯CRUDæ“ä½œ


**ğŸ”¸ åŸºæœ¬æ¦‚å¿µ**
```
CRUD = Create + Read + Update + Delete
ä¸­æ–‡å«ä¹‰ï¼šå¢åŠ  + æŸ¥è¯¢ + ä¿®æ”¹ + åˆ é™¤

ç®€å•ç†è§£ï¼š
å°±åƒç®¡ç†ä¸€ä¸ªç”µè¯æœ¬ï¼š
ğŸ“ Create(å¢åŠ )ï¼šæ·»åŠ æ–°è”ç³»äºº
ğŸ‘€ Read(æŸ¥è¯¢)ï¼šæŸ¥æ‰¾æŸä¸ªäººçš„ç”µè¯
âœï¸ Update(ä¿®æ”¹)ï¼šæ›´æ–°è”ç³»äººä¿¡æ¯  
ğŸ—‘ï¸ Delete(åˆ é™¤)ï¼šåˆ é™¤ä¸éœ€è¦çš„è”ç³»äºº
```

**ğŸ’¡ ä¸ºä»€ä¹ˆCRUDå¦‚æ­¤é‡è¦**
```
å‡ ä¹æ‰€æœ‰è½¯ä»¶ç³»ç»Ÿçš„æ ¸å¿ƒæ“ä½œï¼š
â€¢ ç”¨æˆ·ç®¡ç†ç³»ç»Ÿï¼šæ³¨å†Œã€ç™»å½•ã€ä¿®æ”¹èµ„æ–™ã€æ³¨é”€è´¦å·
â€¢ ç”µå•†ç³»ç»Ÿï¼šæ·»åŠ å•†å“ã€æœç´¢å•†å“ã€æ›´æ–°åº“å­˜ã€ä¸‹æ¶å•†å“
â€¢ ç¤¾äº¤ç³»ç»Ÿï¼šå‘å¸ƒåŠ¨æ€ã€æµè§ˆä¿¡æ¯ã€ç¼–è¾‘å†…å®¹ã€åˆ é™¤å¸–å­

CRUDæ˜¯æ•°æ®æ“ä½œçš„åŸºæœ¬åŠ¨ä½œï¼Œå°±åƒäººçš„"è¡£é£Ÿä½è¡Œ"ä¸€æ ·åŸºç¡€
```

### 1.2 CRUDæ“ä½œçš„ç°å®æŒ‘æˆ˜


**âš ï¸ å¸¸è§é—®é¢˜åœºæ™¯**
```
æ€§èƒ½é—®é¢˜ï¼š
â€¢ ä¸€æ¬¡æŸ¥è¯¢è¿”å›10ä¸‡æ¡æ•°æ®ï¼Œé¡µé¢å¡æ­»
â€¢ é€æ¡æ’å…¥1000æ¡è®°å½•ï¼Œç­‰å¾…10åˆ†é’Ÿ
â€¢ é¢‘ç¹çš„å°æ‰¹é‡æ›´æ–°ï¼Œæ•°æ®åº“å‹åŠ›å±±å¤§

æ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼š
â€¢ ä¸¤ä¸ªäººåŒæ—¶ä¿®æ”¹åŒä¸€æ¡è®°å½•ï¼Œåè€…è¦†ç›–å‰è€…
â€¢ åˆ é™¤ç”¨æˆ·åï¼Œç›¸å…³è®¢å•æ•°æ®å­¤ç«‹å­˜åœ¨
â€¢ å¹¶å‘æ’å…¥å¯¼è‡´é‡å¤æ•°æ®

ç”¨æˆ·ä½“éªŒé—®é¢˜ï¼š
â€¢ ç¿»é¡µæŸ¥è¯¢è¶Šå¾€åè¶Šæ…¢
â€¢ å¤§æ–‡ä»¶ä¸Šä¼ æ²¡æœ‰è¿›åº¦æç¤º
â€¢ è¯¯åˆ æ•°æ®æ— æ³•æ‰¾å›
```

---

## 2. ğŸ“‹ å¢åˆ æ”¹æŸ¥æœ€ä½³å®è·µ


### 2.1 Create(æ–°å¢)æœ€ä½³å®è·µ


**ğŸ”¸ å•æ¡æ’å…¥ä¼˜åŒ–**
```java
// âŒ é”™è¯¯åšæ³•ï¼šæ¯æ¬¡æ’å…¥éƒ½å»ºç«‹è¿æ¥
public void addUser(User user) {
    Connection conn = getConnection();
    PreparedStatement ps = conn.prepareStatement(
        "INSERT INTO users (name, email) VALUES (?, ?)");
    ps.setString(1, user.getName());
    ps.setString(2, user.getEmail());
    ps.executeUpdate();
    closeConnection(conn); // é¢‘ç¹å¼€å…³è¿æ¥
}

// âœ… æ­£ç¡®åšæ³•ï¼šå¤ç”¨è¿æ¥ï¼Œå¤„ç†å¼‚å¸¸
public void addUser(User user) {
    String sql = "INSERT INTO users (name, email, created_time) VALUES (?, ?, NOW())";
    try (PreparedStatement ps = connection.prepareStatement(sql)) {
        ps.setString(1, user.getName());
        ps.setString(2, user.getEmail());
        int result = ps.executeUpdate();
        if (result <= 0) {
            throw new RuntimeException("æ’å…¥å¤±è´¥");
        }
    } catch (SQLException e) {
        log.error("æ·»åŠ ç”¨æˆ·å¤±è´¥", e);
        throw new BusinessException("æ·»åŠ ç”¨æˆ·å¤±è´¥");
    }
}
```

**ğŸ’¡ æ–°å¢æ“ä½œæ ¸å¿ƒæ€ç»´**
```
ğŸ¯ ä¸»é”®ç”Ÿæˆç­–ç•¥ï¼š
â€¢ è‡ªå¢IDï¼šæ•°æ®åº“è‡ªåŠ¨ç”Ÿæˆï¼Œç®€å•å¯é 
â€¢ UUIDï¼šå…¨å±€å”¯ä¸€ï¼Œä½†å ç”¨ç©ºé—´å¤§
â€¢ é›ªèŠ±ç®—æ³•ï¼šåˆ†å¸ƒå¼åœºæ™¯ä¸‹çš„å”¯ä¸€ID

ğŸ¯ é‡å¤æ•°æ®å¤„ç†ï¼š
â€¢ ä¸šåŠ¡å”¯ä¸€æ€§æ£€æŸ¥ï¼šæ’å…¥å‰å…ˆæŸ¥è¯¢æ˜¯å¦å­˜åœ¨
â€¢ æ•°æ®åº“çº¦æŸï¼šè®¾ç½®å”¯ä¸€ç´¢å¼•é˜²æ­¢é‡å¤
â€¢ å¹‚ç­‰æ€§è®¾è®¡ï¼šåŒä¸€è¯·æ±‚å¤šæ¬¡æ‰§è¡Œç»“æœä¸€è‡´

ğŸ¯ æ•°æ®å®Œæ•´æ€§ï¼š
â€¢ å¿…å¡«å­—æ®µæ ¡éªŒï¼šç¡®ä¿å…³é”®ä¿¡æ¯ä¸ä¸ºç©º
â€¢ é»˜è®¤å€¼è®¾ç½®ï¼šåˆ›å»ºæ—¶é—´ã€çŠ¶æ€ç­‰å­—æ®µ
â€¢ å…³è”æ•°æ®æ£€æŸ¥ï¼šå¤–é”®çº¦æŸå’Œä¸šåŠ¡é€»è¾‘æ£€æŸ¥
```

### 2.2 Read(æŸ¥è¯¢)æœ€ä½³å®è·µ


**ğŸ”¸ åŸºç¡€æŸ¥è¯¢ä¼˜åŒ–**
```java
// âŒ æŸ¥è¯¢æ‰€æœ‰å­—æ®µï¼Œæµªè´¹èµ„æº
public List<User> getUsers() {
    return jdbcTemplate.query("SELECT * FROM users", userRowMapper);
}

// âœ… åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ
public List<User> getUserList() {
    String sql = "SELECT id, name, email FROM users WHERE status = 1 ORDER BY created_time DESC";
    return jdbcTemplate.query(sql, userRowMapper);
}

// âœ… å¸¦æ¡ä»¶çš„ç²¾ç¡®æŸ¥è¯¢
public User getUserByEmail(String email) {
    String sql = "SELECT id, name, email FROM users WHERE email = ? AND status = 1";
    List<User> users = jdbcTemplate.query(sql, userRowMapper, email);
    return users.isEmpty() ? null : users.get(0);
}
```

**ğŸ’¡ æŸ¥è¯¢æ“ä½œæ ¸å¿ƒæ€ç»´**
```
ğŸ¯ æŸ¥è¯¢æ•ˆç‡ä¼˜åŒ–ï¼š
â€¢ ç´¢å¼•åˆ©ç”¨ï¼šåœ¨ç»å¸¸æŸ¥è¯¢çš„å­—æ®µä¸Šå»ºç«‹ç´¢å¼•
â€¢ æŸ¥è¯¢æ¡ä»¶ï¼šä½¿ç”¨WHEREæ¡ä»¶ç¼©å°ç»“æœé›†
â€¢ å­—æ®µé€‰æ‹©ï¼šåªæŸ¥è¯¢çœŸæ­£éœ€è¦çš„å­—æ®µ

ğŸ¯ ç»“æœå¤„ç†ï¼š
â€¢ ç©ºç»“æœå¤„ç†ï¼šæŸ¥è¯¢æ— ç»“æœæ—¶çš„å‹å¥½æç¤º
â€¢ ç»“æœæ˜ å°„ï¼šæ•°æ®åº“å­—æ®µåˆ°å¯¹è±¡å±æ€§çš„è½¬æ¢
â€¢ åˆ†é¡µå¤„ç†ï¼šå¤§é‡æ•°æ®çš„åˆ†æ‰¹æ¬¡å¤„ç†
```

### 2.3 Update(ä¿®æ”¹)æœ€ä½³å®è·µ


**ğŸ”¸ å®‰å…¨æ›´æ–°æ“ä½œ**
```java
// âŒ å±é™©åšæ³•ï¼šæ²¡æœ‰WHEREæ¡ä»¶ï¼Œä¼šæ›´æ–°æ‰€æœ‰è®°å½•
public void updateUserName(String name) {
    jdbcTemplate.update("UPDATE users SET name = ?", name);
}

// âœ… å®‰å…¨åšæ³•ï¼šæ˜ç¡®çš„WHEREæ¡ä»¶
public boolean updateUser(Long userId, String name, String email) {
    String sql = "UPDATE users SET name = ?, email = ?, updated_time = NOW() " +
                "WHERE id = ? AND status = 1";
    int affected = jdbcTemplate.update(sql, name, email, userId);
    return affected > 0;
}

// âœ… ä¹è§‚é”æ§åˆ¶å¹¶å‘
public boolean updateUserWithVersion(User user) {
    String sql = "UPDATE users SET name = ?, email = ?, version = version + 1, " +
                "updated_time = NOW() WHERE id = ? AND version = ?";
    int affected = jdbcTemplate.update(sql, 
        user.getName(), user.getEmail(), user.getId(), user.getVersion());
    return affected > 0; // å¦‚æœè¿”å›0ï¼Œè¯´æ˜ç‰ˆæœ¬å†²çª
}
```

**ğŸ’¡ æ›´æ–°æ“ä½œæ ¸å¿ƒæ€ç»´**
```
ğŸ¯ å¹¶å‘æ§åˆ¶ï¼š
â€¢ ä¹è§‚é”ï¼šé€šè¿‡ç‰ˆæœ¬å·é˜²æ­¢æ•°æ®è¦†ç›–
â€¢ æ‚²è§‚é”ï¼šé€šè¿‡è¡Œé”ä¿è¯æ•°æ®ä¸€è‡´æ€§
â€¢ å­—æ®µçº§æ›´æ–°ï¼šåªæ›´æ–°çœŸæ­£å˜åŒ–çš„å­—æ®µ

ğŸ¯ å®‰å…¨æ€§ä¿éšœï¼š
â€¢ WHEREæ¡ä»¶ï¼šæ°¸è¿œä¸è¦æ‰§è¡Œæ— æ¡ä»¶çš„UPDATE
â€¢ æƒé™æ£€æŸ¥ï¼šç¡®è®¤ç”¨æˆ·æœ‰æƒé™ä¿®æ”¹è¿™æ¡æ•°æ®
â€¢ æ•°æ®æ ¡éªŒï¼šæ›´æ–°å‰éªŒè¯æ•°æ®çš„åˆæ³•æ€§
```

### 2.4 Delete(åˆ é™¤)æœ€ä½³å®è·µ


**ğŸ”¸ å®‰å…¨åˆ é™¤ç­–ç•¥**
```java
// âŒ ç‰©ç†åˆ é™¤ï¼šæ•°æ®å½»åº•æ¶ˆå¤±ï¼Œæ— æ³•æ¢å¤
public void hardDeleteUser(Long userId) {
    jdbcTemplate.update("DELETE FROM users WHERE id = ?", userId);
}

// âœ… è½¯åˆ é™¤ï¼šåªæ ‡è®°åˆ é™¤ï¼Œå¯ä»¥æ¢å¤
public boolean softDeleteUser(Long userId) {
    String sql = "UPDATE users SET status = 0, deleted_time = NOW() WHERE id = ? AND status = 1";
    int affected = jdbcTemplate.update(sql, userId);
    return affected > 0;
}

// âœ… å…³è”æ•°æ®å¤„ç†
public void deleteUserSafely(Long userId) {
    // 1. æ£€æŸ¥æ˜¯å¦æœ‰å…³è”æ•°æ®
    if (hasActiveOrders(userId)) {
        throw new BusinessException("ç”¨æˆ·æœ‰æœªå®Œæˆè®¢å•ï¼Œæ— æ³•åˆ é™¤");
    }
    
    // 2. è½¯åˆ é™¤ç”¨æˆ·
    softDeleteUser(userId);
    
    // 3. å¤„ç†ç›¸å…³æ•°æ®
    softDeleteUserProfiles(userId);
}
```

---

## 3. âš¡ æ‰¹é‡æ“ä½œä¼˜åŒ–ç­–ç•¥


### 3.1 æ‰¹é‡æ’å…¥ä¼˜åŒ–


**ğŸ”¸ æ‰¹é‡æ’å…¥çš„å¿…è¦æ€§**
```
åœºæ™¯å¯¹æ¯”ï¼š
å•æ¡æ’å…¥1000æ¡ç”¨æˆ·æ•°æ®ï¼š
â€¢ å»ºç«‹1000æ¬¡æ•°æ®åº“è¿æ¥
â€¢ æ‰§è¡Œ1000æ¬¡SQLè¯­å¥  
â€¢ æ€»è€—æ—¶ï¼šçº¦30ç§’

æ‰¹é‡æ’å…¥1000æ¡ç”¨æˆ·æ•°æ®ï¼š
â€¢ å»ºç«‹1æ¬¡æ•°æ®åº“è¿æ¥
â€¢ æ‰§è¡Œ1æ¬¡æ‰¹é‡SQLè¯­å¥
â€¢ æ€»è€—æ—¶ï¼šçº¦2ç§’

æ€§èƒ½æå‡ï¼š15å€ï¼
```

**ğŸ’¡ æ‰¹é‡æ’å…¥å®ç°æ–¹å¼**

**æ–¹å¼ä¸€ï¼šæ‰¹é‡INSERTè¯­å¥**
```java
public void batchInsertUsers(List<User> users) {
    // åˆ†æ‰¹å¤„ç†ï¼Œæ¯æ‰¹1000æ¡
    int batchSize = 1000;
    
    for (int i = 0; i < users.size(); i += batchSize) {
        int end = Math.min(i + batchSize, users.size());
        List<User> batch = users.subList(i, end);
        
        // æ„å»ºæ‰¹é‡æ’å…¥SQL
        StringBuilder sql = new StringBuilder();
        sql.append("INSERT INTO users (name, email) VALUES ");
        
        List<Object> params = new ArrayList<>();
        for (int j = 0; j < batch.size(); j++) {
            if (j > 0) sql.append(", ");
            sql.append("(?, ?)");
            params.add(batch.get(j).getName());
            params.add(batch.get(j).getEmail());
        }
        
        jdbcTemplate.update(sql.toString(), params.toArray());
    }
}
```

**æ–¹å¼äºŒï¼šPreparedStatementæ‰¹å¤„ç†**
```java
public void batchInsertUsersWithPS(List<User> users) {
    String sql = "INSERT INTO users (name, email) VALUES (?, ?)";
    
    try (PreparedStatement ps = connection.prepareStatement(sql)) {
        for (User user : users) {
            ps.setString(1, user.getName());
            ps.setString(2, user.getEmail());
            ps.addBatch(); // æ·»åŠ åˆ°æ‰¹å¤„ç†
            
            // æ¯1000æ¡æ‰§è¡Œä¸€æ¬¡
            if (ps.getParameterMetaData().getParameterCount() % 1000 == 0) {
                ps.executeBatch();
                ps.clearBatch();
            }
        }
        
        // å¤„ç†å‰©ä½™çš„æ•°æ®
        ps.executeBatch();
    }
}
```

### 3.2 æ‰¹é‡æ›´æ–°ä¼˜åŒ–


**ğŸ”¸ æ‰¹é‡æ›´æ–°ç­–ç•¥**
```java
// âœ… æ‰¹é‡æ›´æ–°ç”¨æˆ·çŠ¶æ€
public void batchUpdateUserStatus(List<Long> userIds, int status) {
    // æ–¹å¼1ï¼šINæ¡ä»¶æ‰¹é‡æ›´æ–°
    if (userIds.size() <= 1000) { // MySQL INæ¡ä»¶å»ºè®®ä¸è¶…è¿‡1000ä¸ª
        String sql = "UPDATE users SET status = ? WHERE id IN (" +
                    String.join(",", Collections.nCopies(userIds.size(), "?")) + ")";
        
        List<Object> params = new ArrayList<>();
        params.add(status);
        params.addAll(userIds);
        
        jdbcTemplate.update(sql, params.toArray());
    } else {
        // æ–¹å¼2ï¼šåˆ†æ‰¹æ›´æ–°
        for (int i = 0; i < userIds.size(); i += 1000) {
            List<Long> batch = userIds.subList(i, Math.min(i + 1000, userIds.size()));
            batchUpdateUserStatus(batch, status);
        }
    }
}
```

### 3.3 æ‰¹é‡å¤„ç†æ ¸å¿ƒåŸåˆ™


**ğŸ“Š æ‰¹é‡å¤„ç†æ€ç»´å¯¼å›¾**
```
æ‰¹é‡å¤„ç†ä¼˜åŒ–
â”œâ”€â”€ å‡å°‘ç½‘ç»œIO
â”‚   â”œâ”€â”€ åˆå¹¶å¤šæ¬¡è¯·æ±‚ä¸ºä¸€æ¬¡
â”‚   â””â”€â”€ å‡å°‘æ•°æ®ä¼ è¾“æ¬¡æ•°
â”œâ”€â”€ å‡å°‘æ•°æ®åº“è¿æ¥å¼€é”€  
â”‚   â”œâ”€â”€ å¤ç”¨æ•°æ®åº“è¿æ¥
â”‚   â””â”€â”€ å‡å°‘è¿æ¥å»ºç«‹/é‡Šæ”¾
â”œâ”€â”€ æé«˜SQLæ‰§è¡Œæ•ˆç‡
â”‚   â”œâ”€â”€ æ‰¹é‡SQLè¯­å¥
â”‚   â””â”€â”€ å‡å°‘SQLè§£ææ¬¡æ•°
â””â”€â”€ å†…å­˜ä¼˜åŒ–
    â”œâ”€â”€ åˆ†æ‰¹å¤„ç†å¤§æ•°æ®é›†
    â””â”€â”€ åŠæ—¶é‡Šæ”¾å†…å­˜èµ„æº
```

**âš ï¸ æ‰¹é‡å¤„ç†æ³¨æ„äº‹é¡¹**
```
ğŸ”¸ æ‰¹æ¬¡å¤§å°æ§åˆ¶ï¼š
â€¢ å¤ªå°ï¼šæ€§èƒ½æå‡ä¸æ˜æ˜¾
â€¢ å¤ªå¤§ï¼šå†…å­˜å ç”¨è¿‡å¤šï¼Œå¯èƒ½è¶…æ—¶
â€¢ å»ºè®®ï¼š500-2000æ¡ä¸ºä¸€æ‰¹

ğŸ”¸ äº‹åŠ¡æ§åˆ¶ï¼š
â€¢ å¤§æ‰¹é‡æ“ä½œè¦åˆ†äº‹åŠ¡å¤„ç†
â€¢ é¿å…é•¿æ—¶é—´é”è¡¨
â€¢ å¤±è´¥å›æ»šç­–ç•¥

ğŸ”¸ é”™è¯¯å¤„ç†ï¼š
â€¢ éƒ¨åˆ†å¤±è´¥çš„å¤„ç†ç­–ç•¥
â€¢ é”™è¯¯æ—¥å¿—è®°å½•
â€¢ é‡è¯•æœºåˆ¶è®¾è®¡
```

---

## 4. ğŸ“„ åˆ†é¡µæŸ¥è¯¢è®¾è®¡ä¸ä¼˜åŒ–


### 4.1 åˆ†é¡µæŸ¥è¯¢çš„å¿…è¦æ€§


**ğŸ”¸ ä¸ºä»€ä¹ˆéœ€è¦åˆ†é¡µæŸ¥è¯¢**
```
é—®é¢˜åœºæ™¯ï¼š
ç”¨æˆ·è¡¨æœ‰100ä¸‡æ¡è®°å½•ï¼Œå¦‚æœä¸€æ¬¡æ€§æŸ¥è¯¢ï¼š

SELECT * FROM users; 

åæœï¼š
â€¢ å†…å­˜å ç”¨ï¼šçº¦500MBæ•°æ®åŠ è½½åˆ°å†…å­˜
â€¢ ç½‘ç»œä¼ è¾“ï¼šå¤§é‡æ•°æ®ä¼ è¾“è€—æ—¶
â€¢ ç”¨æˆ·ä½“éªŒï¼šé¡µé¢å“åº”ç¼“æ…¢ï¼Œç”šè‡³å´©æºƒ
â€¢ æœåŠ¡å™¨å‹åŠ›ï¼šCPUå’Œå†…å­˜èµ„æºè€—å°½

è§£å†³æ–¹æ¡ˆï¼šåˆ†é¡µæŸ¥è¯¢
æ¯æ¬¡åªæŸ¥è¯¢20-50æ¡è®°å½•ï¼Œç”¨æˆ·ä½“éªŒå¥½ï¼Œç³»ç»Ÿèµ„æºå ç”¨ä½
```

### 4.2 åˆ†é¡µæŸ¥è¯¢å®ç°æ–¹å¼


**ğŸ”¸ åŸºç¡€åˆ†é¡µå®ç°**
```java
// âœ… åŸºç¡€åˆ†é¡µæŸ¥è¯¢
public PageResult<User> getUsersByPage(int pageNum, int pageSize) {
    // 1. å‚æ•°æ ¡éªŒ
    if (pageNum < 1) pageNum = 1;
    if (pageSize < 10 || pageSize > 100) pageSize = 20;
    
    // 2. è®¡ç®—åç§»é‡
    int offset = (pageNum - 1) * pageSize;
    
    // 3. æŸ¥è¯¢æ•°æ®
    String sql = "SELECT id, name, email FROM users " +
                "WHERE status = 1 ORDER BY created_time DESC " +
                "LIMIT ? OFFSET ?";
    List<User> users = jdbcTemplate.query(sql, userRowMapper, pageSize, offset);
    
    // 4. æŸ¥è¯¢æ€»æ•°
    String countSql = "SELECT COUNT(*) FROM users WHERE status = 1";
    Long total = jdbcTemplate.queryForObject(countSql, Long.class);
    
    // 5. æ„å»ºåˆ†é¡µç»“æœ
    return new PageResult<>(users, total, pageNum, pageSize);
}
```

**ğŸ”¸ åˆ†é¡µç»“æœå¯¹è±¡è®¾è®¡**
```java
public class PageResult<T> {
    private List<T> data;          // å½“å‰é¡µæ•°æ®
    private Long total;            // æ€»è®°å½•æ•°
    private Integer pageNum;       // å½“å‰é¡µç 
    private Integer pageSize;      // æ¯é¡µå¤§å°
    private Integer totalPages;    // æ€»é¡µæ•°
    private Boolean hasNext;       // æ˜¯å¦æœ‰ä¸‹ä¸€é¡µ
    private Boolean hasPrevious;   // æ˜¯å¦æœ‰ä¸Šä¸€é¡µ
    
    public PageResult(List<T> data, Long total, Integer pageNum, Integer pageSize) {
        this.data = data;
        this.total = total;
        this.pageNum = pageNum;
        this.pageSize = pageSize;
        this.totalPages = (int) Math.ceil((double) total / pageSize);
        this.hasNext = pageNum < totalPages;
        this.hasPrevious = pageNum > 1;
    }
}
```

### 4.3 åˆ†é¡µæŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–


**ğŸ”¸ æ·±åˆ†é¡µé—®é¢˜**
```
æ€§èƒ½å¯¹æ¯”ï¼š
SELECT * FROM users ORDER BY id LIMIT 20 OFFSET 0;        -- 0.01ç§’
SELECT * FROM users ORDER BY id LIMIT 20 OFFSET 100000;   -- 0.5ç§’
SELECT * FROM users ORDER BY id LIMIT 20 OFFSET 1000000;  -- 5ç§’

é—®é¢˜åŸå› ï¼š
MySQLéœ€è¦æ‰«æå‰é¢çš„100ä¸‡æ¡è®°å½•ï¼Œç„¶åä¸¢å¼ƒï¼Œåªè¿”å›æœ€å20æ¡
è¿™å°±åƒè¦ç¬¬100ä¸‡æœ¬ä¹¦ï¼Œå´è¦ä»ç¬¬1æœ¬å¼€å§‹ç¿»ä¸€æ ·ä½æ•ˆ
```

**ğŸ’¡ æ·±åˆ†é¡µä¼˜åŒ–æ–¹æ¡ˆ**

**æ–¹æ¡ˆä¸€ï¼šæ¸¸æ ‡åˆ†é¡µï¼ˆæ¨èï¼‰**
```java
// âœ… ä½¿ç”¨IDæ¸¸æ ‡ä¼˜åŒ–æ·±åˆ†é¡µ
public List<User> getUsersByIdCursor(Long lastId, int pageSize) {
    String sql = "SELECT id, name, email FROM users " +
                "WHERE status = 1 AND id > ? " +
                "ORDER BY id ASC LIMIT ?";
    return jdbcTemplate.query(sql, userRowMapper, lastId, pageSize);
}

// å‰ç«¯ä½¿ç”¨æ–¹å¼ï¼š
// ç¬¬ä¸€é¡µï¼šgetUsersByIdCursor(0, 20)
// ç¬¬äºŒé¡µï¼šgetUsersByIdCursor(ä¸Šä¸€é¡µæœ€åä¸€æ¡è®°å½•çš„ID, 20)
```

**æ–¹æ¡ˆäºŒï¼šå»¶è¿Ÿå…³è”ä¼˜åŒ–**
```java
// âœ… å»¶è¿Ÿå…³è”å‡å°‘æ•°æ®ä¼ è¾“
public PageResult<User> getUsersByPageOptimized(int pageNum, int pageSize) {
    int offset = (pageNum - 1) * pageSize;
    
    // 1. å…ˆåªæŸ¥è¯¢IDï¼ˆä¸»é”®æŸ¥è¯¢å¾ˆå¿«ï¼‰
    String idSql = "SELECT id FROM users WHERE status = 1 " +
                  "ORDER BY created_time DESC LIMIT ? OFFSET ?";
    List<Long> ids = jdbcTemplate.queryForList(idSql, Long.class, pageSize, offset);
    
    if (ids.isEmpty()) {
        return new PageResult<>(Collections.emptyList(), 0L, pageNum, pageSize);
    }
    
    // 2. æ ¹æ®IDæŸ¥è¯¢å®Œæ•´æ•°æ®
    String dataSql = "SELECT id, name, email FROM users WHERE id IN (" +
                    String.join(",", Collections.nCopies(ids.size(), "?")) + ")";
    List<User> users = jdbcTemplate.query(dataSql, userRowMapper, ids.toArray());
    
    // 3. æŸ¥è¯¢æ€»æ•°ï¼ˆå¯ä»¥è€ƒè™‘ç¼“å­˜ï¼‰
    String countSql = "SELECT COUNT(*) FROM users WHERE status = 1";
    Long total = jdbcTemplate.queryForObject(countSql, Long.class);
    
    return new PageResult<>(users, total, pageNum, pageSize);
}
```

### 4.4 åˆ†é¡µæŸ¥è¯¢æœ€ä½³å®è·µ


**ğŸ“‹ åˆ†é¡µæŸ¥è¯¢æ ¸å¿ƒç­–ç•¥**
```
ğŸ¯ é˜²æ­¢æµ·é‡æ•°æ®æ‹‰å–ç­–ç•¥ï¼š

1ï¸âƒ£ é¡µé¢å¤§å°é™åˆ¶ï¼š
   â€¢ æœ€å°å€¼ï¼š10æ¡ï¼ˆé¿å…é¢‘ç¹ç¿»é¡µï¼‰
   â€¢ æœ€å¤§å€¼ï¼š100æ¡ï¼ˆé˜²æ­¢ä¸€æ¬¡æ‹‰å–è¿‡å¤šï¼‰
   â€¢ é»˜è®¤å€¼ï¼š20æ¡ï¼ˆå¹³è¡¡ä½“éªŒå’Œæ€§èƒ½ï¼‰

2ï¸âƒ£ æ·±åˆ†é¡µé™åˆ¶ï¼š
   â€¢ é™åˆ¶æœ€å¤§é¡µç ï¼šå¦‚åªå…è®¸æŸ¥è¯¢å‰1000é¡µ
   â€¢ å¼•å¯¼ç”¨æˆ·ä½¿ç”¨æœç´¢è€Œä¸æ˜¯ç¿»é¡µ
   â€¢ æä¾›"ä¸‹ä¸€é¡µ"è€Œä¸æ˜¯"è·³è½¬åˆ°ç¬¬Né¡µ"

3ï¸âƒ£ ç¼“å­˜ç­–ç•¥ï¼š
   â€¢ ç¼“å­˜æ€»æ•°ç»Ÿè®¡ï¼ˆé¿å…é‡å¤COUNTæŸ¥è¯¢ï¼‰
   â€¢ ç¼“å­˜çƒ­é—¨é¡µé¢æ•°æ®
   â€¢ åˆç†è®¾ç½®ç¼“å­˜è¿‡æœŸæ—¶é—´
```

**âš ï¸ åˆ†é¡µæŸ¥è¯¢æ³¨æ„äº‹é¡¹**
```
ğŸ”¸ æ•°æ®ä¸€è‡´æ€§ï¼š
â€¢ æŸ¥è¯¢è¿‡ç¨‹ä¸­æ•°æ®å¯èƒ½å‘ç”Ÿå˜åŒ–
â€¢ æ–°å¢/åˆ é™¤æ•°æ®å¯èƒ½å¯¼è‡´é‡å¤æˆ–é—æ¼
â€¢ å¯ä»¥æ¥å—å¼±ä¸€è‡´æ€§ï¼Œæ³¨é‡ç”¨æˆ·ä½“éªŒ

ğŸ”¸ æ’åºç¨³å®šæ€§ï¼š
â€¢ å¿…é¡»æœ‰æ˜ç¡®çš„æ’åºå­—æ®µ
â€¢ å»ºè®®ä½¿ç”¨å”¯ä¸€å­—æ®µæ’åºï¼ˆå¦‚ID+æ—¶é—´ï¼‰
â€¢ é¿å…ä½¿ç”¨å¯é‡å¤å€¼æ’åº

ğŸ”¸ ç”¨æˆ·ä½“éªŒï¼š
â€¢ æ˜¾ç¤ºæ€»è®°å½•æ•°å’Œæ€»é¡µæ•°
â€¢ æä¾›å¿«é€Ÿè·³è½¬åŠŸèƒ½
â€¢ åŠ è½½çŠ¶æ€æç¤º
```

---

## 5. ğŸ—‘ï¸ è½¯åˆ é™¤vsç¡¬åˆ é™¤é€‰æ‹©


### 5.1 åˆ é™¤æ–¹å¼å¯¹æ¯”


**ğŸ”¸ ç¡¬åˆ é™¤ï¼ˆç‰©ç†åˆ é™¤ï¼‰**
```java
// ç¡¬åˆ é™¤ï¼šæ•°æ®å½»åº•æ¶ˆå¤±
public void hardDelete(Long userId) {
    String sql = "DELETE FROM users WHERE id = ?";
    jdbcTemplate.update(sql, userId);
}

ç‰¹ç‚¹ï¼š
âœ… ä¼˜ç‚¹ï¼š
â€¢ èŠ‚çœå­˜å‚¨ç©ºé—´
â€¢ æŸ¥è¯¢æ€§èƒ½å¥½ï¼ˆæ•°æ®é‡å°ï¼‰
â€¢ æ•°æ®ç»“æ„ç®€å•

âŒ ç¼ºç‚¹ï¼š
â€¢ æ•°æ®æ— æ³•æ¢å¤
â€¢ å®¡è®¡å›°éš¾
â€¢ å¯èƒ½ç ´åæ•°æ®å®Œæ•´æ€§
```

**ğŸ”¸ è½¯åˆ é™¤ï¼ˆé€»è¾‘åˆ é™¤ï¼‰**
```java
// è½¯åˆ é™¤ï¼šåªæ ‡è®°åˆ é™¤çŠ¶æ€
public void softDelete(Long userId) {
    String sql = "UPDATE users SET deleted = 1, deleted_time = NOW() WHERE id = ?";
    jdbcTemplate.update(sql, userId);
}

// æŸ¥è¯¢æ—¶è¿‡æ»¤å·²åˆ é™¤æ•°æ®
public List<User> getActiveUsers() {
    String sql = "SELECT * FROM users WHERE deleted = 0";
    return jdbcTemplate.query(sql, userRowMapper);
}

ç‰¹ç‚¹ï¼š
âœ… ä¼˜ç‚¹ï¼š
â€¢ æ•°æ®å¯ä»¥æ¢å¤
â€¢ ä¾¿äºå®¡è®¡å’Œç»Ÿè®¡
â€¢ ä¿æŒæ•°æ®å®Œæ•´æ€§

âŒ ç¼ºç‚¹ï¼š
â€¢ å ç”¨æ›´å¤šå­˜å‚¨ç©ºé—´
â€¢ æŸ¥è¯¢éœ€è¦é¢å¤–æ¡ä»¶
â€¢ æ•°æ®åº“æ€§èƒ½å¯èƒ½ä¸‹é™
```

### 5.2 åˆ é™¤æ–¹å¼é€‰æ‹©ç­–ç•¥


**ğŸ“Š åˆ é™¤æ–¹å¼é€‰æ‹©æŒ‡å—**

| ä¸šåŠ¡åœºæ™¯ | **æ¨èæ–¹å¼** | **åŸå› è¯´æ˜** |
|---------|------------|-------------|
| ğŸ¦ **é‡‘èç³»ç»Ÿ** | `è½¯åˆ é™¤` | `ç›‘ç®¡è¦æ±‚ï¼Œæ•°æ®ä¸èƒ½çœŸæ­£åˆ é™¤` |
| ğŸ“Š **æ•°æ®åˆ†æ** | `è½¯åˆ é™¤` | `å†å²æ•°æ®å¯¹åˆ†ææœ‰ä»·å€¼` |
| ğŸ‘¥ **ç”¨æˆ·è´¦æˆ·** | `è½¯åˆ é™¤` | `ç”¨æˆ·å¯èƒ½éœ€è¦æ¢å¤è´¦æˆ·` |
| ğŸ“ **å†…å®¹ç®¡ç†** | `è½¯åˆ é™¤` | `è¯¯åˆ å†…å®¹éœ€è¦èƒ½å¤Ÿæ¢å¤` |
| ğŸ—‚ï¸ **æ—¥å¿—æ•°æ®** | `ç¡¬åˆ é™¤` | `è¿‡æœŸæ—¥å¿—æ²¡æœ‰ä¿ç•™ä»·å€¼` |
| ğŸ§¹ **ä¸´æ—¶æ–‡ä»¶** | `ç¡¬åˆ é™¤` | `å ç”¨ç©ºé—´ï¼Œæ— ä¿ç•™å¿…è¦` |

**ğŸ’¡ æ··åˆåˆ é™¤ç­–ç•¥**
```java
public class SmartDeleteService {
    
    // ä¸šåŠ¡æ•°æ®ï¼šè½¯åˆ é™¤
    public void deleteUser(Long userId) {
        // 1. è½¯åˆ é™¤ç”¨æˆ·
        userRepository.softDelete(userId);
        
        // 2. ç¡¬åˆ é™¤æ•æ„Ÿæ•°æ®
        userRepository.hardDeleteSensitiveData(userId);
        
        // 3. å®šæ—¶æ¸…ç†ï¼š30å¤©åç¡¬åˆ é™¤
        scheduleHardDelete(userId, 30);
    }
    
    // ç³»ç»Ÿæ•°æ®ï¼šç›´æ¥ç¡¬åˆ é™¤
    public void cleanupLogs(Date beforeDate) {
        String sql = "DELETE FROM system_logs WHERE created_time < ?";
        jdbcTemplate.update(sql, beforeDate);
    }
}
```

### 5.3 è½¯åˆ é™¤å®ç°æœ€ä½³å®è·µ


**ğŸ”¸ è½¯åˆ é™¤å­—æ®µè®¾è®¡**
```sql
-- æ–¹æ¡ˆä¸€ï¼šå•ä¸ªåˆ é™¤æ ‡å¿—
ALTER TABLE users ADD COLUMN deleted TINYINT(1) DEFAULT 0;
ALTER TABLE users ADD COLUMN deleted_time DATETIME NULL;

-- æ–¹æ¡ˆäºŒï¼šçŠ¶æ€å­—æ®µ
ALTER TABLE users ADD COLUMN status TINYINT(1) DEFAULT 1; 
-- 1:æ­£å¸¸ 0:åˆ é™¤ 2:ç¦ç”¨

-- æ–¹æ¡ˆä¸‰ï¼šåˆ é™¤æ—¶é—´æˆ³ï¼ˆæ¨èï¼‰
ALTER TABLE users ADD COLUMN deleted_at DATETIME NULL;
-- NULLè¡¨ç¤ºæœªåˆ é™¤ï¼Œæœ‰å€¼è¡¨ç¤ºåˆ é™¤æ—¶é—´
```

**ğŸ’¡ è½¯åˆ é™¤æŸ¥è¯¢ä¼˜åŒ–**
```java
// âœ… ç»Ÿä¸€çš„æŸ¥è¯¢åŸºç±»
public abstract class BaseRepository<T> {
    
    // æŸ¥è¯¢æœªåˆ é™¤çš„æ•°æ®
    protected String addNotDeletedCondition(String sql) {
        if (sql.toLowerCase().contains("where")) {
            return sql + " AND deleted_at IS NULL";
        } else {
            return sql + " WHERE deleted_at IS NULL";
        }
    }
    
    // ç»Ÿä¸€æŸ¥è¯¢æ–¹æ³•
    public List<T> findAll() {
        String sql = addNotDeletedCondition("SELECT * FROM " + getTableName());
        return jdbcTemplate.query(sql, getRowMapper());
    }
}

// ä¸ºåˆ é™¤å­—æ®µæ·»åŠ ç´¢å¼•ï¼Œæé«˜æŸ¥è¯¢æ€§èƒ½
CREATE INDEX idx_users_deleted_at ON users(deleted_at);
```

**ğŸ”¸ è½¯åˆ é™¤æ•°æ®æ¢å¤**
```java
// æ•°æ®æ¢å¤åŠŸèƒ½
public boolean recoverUser(Long userId) {
    String sql = "UPDATE users SET deleted_at = NULL WHERE id = ? AND deleted_at IS NOT NULL";
    int affected = jdbcTemplate.update(sql, userId);
    return affected > 0;
}

// æ‰¹é‡æ¸…ç†è¿‡æœŸçš„è½¯åˆ é™¤æ•°æ®
@Scheduled(cron = "0 0 2 * * ?") // æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
public void cleanupExpiredSoftDeletedData() {
    // æ¸…ç†30å¤©å‰è½¯åˆ é™¤çš„æ•°æ®
    Date expireDate = Date.from(Instant.now().minus(30, ChronoUnit.DAYS));
    String sql = "DELETE FROM users WHERE deleted_at < ?";
    int cleaned = jdbcTemplate.update(sql, expireDate);
    log.info("æ¸…ç†è¿‡æœŸè½¯åˆ é™¤æ•°æ®ï¼š{} æ¡", cleaned);
}
```

---

## 6. ğŸ§  CRUDæ“ä½œæ€ç»´ä½“ç³»


### 6.1 æ–°å¢æ€ç»´ï¼ˆCreate Thinkingï¼‰


**ğŸ”¸ æ‰¹é‡æ’å…¥æ€ç»´**
```
å•æ¡æ’å…¥ vs æ‰¹é‡æ’å…¥çš„æ€ç»´è½¬æ¢ï¼š

ä¼ ç»Ÿæ€ç»´ï¼š
for (User user : users) {
    insertUser(user); // å¾ªç¯æ’å…¥ï¼Œæ€§èƒ½å·®
}

æ‰¹é‡æ€ç»´ï¼š
1ï¸âƒ£ æ•°æ®é¢„å¤„ç†ï¼šéªŒè¯ã€å»é‡ã€æ ¼å¼åŒ–
2ï¸âƒ£ åˆ†æ‰¹å¤„ç†ï¼šé¿å…å•æ¬¡æ’å…¥è¿‡å¤šæ•°æ®
3ï¸âƒ£ äº‹åŠ¡æ§åˆ¶ï¼šä¿è¯æ•°æ®ä¸€è‡´æ€§
4ï¸âƒ£ å¼‚å¸¸å¤„ç†ï¼šéƒ¨åˆ†å¤±è´¥çš„è¡¥å¿æœºåˆ¶

æ ¸å¿ƒåŸåˆ™ï¼šå‡å°‘æ•°æ®åº“äº¤äº’æ¬¡æ•°ï¼Œæé«˜æ•´ä½“æ€§èƒ½
```

**ğŸ’¡ ä¸»é”®ç”Ÿæˆç­–ç•¥æ€ç»´**
```
ğŸ¯ ä¸»é”®ç”Ÿæˆé€‰æ‹©æ€ç»´ï¼š

æ•°æ®åº“è‡ªå¢IDï¼š
â€¢ é€‚ç”¨ï¼šå•åº“åœºæ™¯
â€¢ ä¼˜ç‚¹ï¼šç®€å•ã€è¿ç»­ã€æ€§èƒ½å¥½
â€¢ ç¼ºç‚¹ï¼šåˆ†åº“åˆ†è¡¨å›°éš¾

UUIDï¼š
â€¢ é€‚ç”¨ï¼šåˆ†å¸ƒå¼åœºæ™¯
â€¢ ä¼˜ç‚¹ï¼šå…¨å±€å”¯ä¸€ã€æ— ä¾èµ–
â€¢ ç¼ºç‚¹ï¼šå­˜å‚¨ç©ºé—´å¤§ã€æ— åº

é›ªèŠ±ç®—æ³•ï¼š
â€¢ é€‚ç”¨ï¼šé«˜å¹¶å‘åˆ†å¸ƒå¼
â€¢ ä¼˜ç‚¹ï¼šæœ‰åºã€é«˜æ€§èƒ½ã€ä¿¡æ¯ä¸°å¯Œ
â€¢ ç¼ºç‚¹ï¼šä¾èµ–æ—¶é’Ÿã€å®ç°å¤æ‚

é€‰æ‹©æ ‡å‡†ï¼šæ ¹æ®ä¸šåŠ¡è§„æ¨¡å’Œæ¶æ„ç‰¹ç‚¹é€‰æ‹©
```

**ğŸ”¸ é‡å¤å¤„ç†æ€ç»´**
```java
// é‡å¤æ•°æ®å¤„ç†çš„æ€ç»´å±‚æ¬¡
public class DuplicateHandlingStrategy {
    
    // å±‚æ¬¡1ï¼šæ•°æ®åº“çº¦æŸé˜²é‡
    // CREATE UNIQUE INDEX uk_user_email ON users(email);
    
    // å±‚æ¬¡2ï¼šä¸šåŠ¡é€»è¾‘é˜²é‡
    public void addUser(User user) {
        if (userExists(user.getEmail())) {
            throw new BusinessException("é‚®ç®±å·²å­˜åœ¨");
        }
        insertUser(user);
    }
    
    // å±‚æ¬¡3ï¼šå¹‚ç­‰æ€§è®¾è®¡ï¼ˆæ¨èï¼‰
    public void addUserIdempotent(User user, String requestId) {
        // 1. æ£€æŸ¥è¯·æ±‚æ˜¯å¦å·²å¤„ç†
        if (isRequestProcessed(requestId)) {
            return; // è¯·æ±‚å·²å¤„ç†ï¼Œç›´æ¥è¿”å›
        }
        
        // 2. å°è¯•æ’å…¥ï¼Œå¦‚æœé‡å¤åˆ™å¿½ç•¥
        try {
            insertUser(user);
            markRequestProcessed(requestId);
        } catch (DuplicateKeyException e) {
            log.info("ç”¨æˆ·å·²å­˜åœ¨ï¼Œå¿½ç•¥é‡å¤æ’å…¥: {}", user.getEmail());
        }
    }
}
```

### 6.2 æŸ¥è¯¢æ€ç»´ï¼ˆRead Thinkingï¼‰


**ğŸ”¸ åˆ†é¡µæŸ¥è¯¢æ€ç»´**
```
åˆ†é¡µæŸ¥è¯¢çš„æ€ç»´è¿›åŒ–ï¼š

åˆçº§æ€ç»´ï¼šèƒ½æŸ¥å‡ºæ•°æ®å°±è¡Œ
SELECT * FROM users LIMIT 20 OFFSET 1000000; -- æ·±åˆ†é¡µæ€§èƒ½å·®

ä¸­çº§æ€ç»´ï¼šè€ƒè™‘æ€§èƒ½ä¼˜åŒ–
SELECT * FROM users WHERE id > 1000000 LIMIT 20; -- æ¸¸æ ‡åˆ†é¡µ

é«˜çº§æ€ç»´ï¼šäº§å“å’ŒæŠ€æœ¯å¹³è¡¡
â€¢ é™åˆ¶æœ€å¤§æŸ¥è¯¢é¡µæ•°
â€¢ å¼•å¯¼ç”¨æˆ·ä½¿ç”¨ç­›é€‰è€Œä¸æ˜¯ç¿»é¡µ
â€¢ æä¾›æœç´¢åŠŸèƒ½æ›¿ä»£æ·±åº¦åˆ†é¡µ
â€¢ æ— é™æ»šåŠ¨æ›¿ä»£ä¼ ç»Ÿåˆ†é¡µ

æ ¸å¿ƒï¼šä¸æ˜¯çº¯æŠ€æœ¯é—®é¢˜ï¼Œæ˜¯äº§å“è®¾è®¡é—®é¢˜
```

**ğŸ’¡ æ¡ä»¶æ„å»ºæ€ç»´**
```java
// åŠ¨æ€æŸ¥è¯¢æ¡ä»¶æ„å»ºæ€ç»´
public class QueryConditionBuilder {
    
    // âŒ å­—ç¬¦ä¸²æ‹¼æ¥ï¼ˆSQLæ³¨å…¥é£é™©ï¼‰
    public String buildQuery(String name, Integer age) {
        return "SELECT * FROM users WHERE name = '" + name + "' AND age = " + age;
    }
    
    // âœ… å‚æ•°åŒ–æŸ¥è¯¢ï¼ˆå®‰å…¨ï¼‰
    public QueryCondition buildSafeQuery(UserQueryParam param) {
        StringBuilder sql = new StringBuilder("SELECT * FROM users WHERE 1=1");
        List<Object> params = new ArrayList<>();
        
        if (StringUtils.isNotBlank(param.getName())) {
            sql.append(" AND name LIKE ?");
            params.add("%" + param.getName() + "%");
        }
        
        if (param.getAge() != null) {
            sql.append(" AND age = ?");
            params.add(param.getAge());
        }
        
        if (param.getStatus() != null) {
            sql.append(" AND status = ?");
            params.add(param.getStatus());
        }
        
        return new QueryCondition(sql.toString(), params);
    }
}
```

**ğŸ”¸ ç»“æœæ˜ å°„æ€ç»´**
```java
// ç»“æœæ˜ å°„çš„å±‚æ¬¡æ€ç»´
public class ResultMappingStrategy {
    
    // å±‚æ¬¡1ï¼šç›´æ¥æ˜ å°„
    public User mapToUser(ResultSet rs) throws SQLException {
        User user = new User();
        user.setId(rs.getLong("id"));
        user.setName(rs.getString("name"));
        return user;
    }
    
    // å±‚æ¬¡2ï¼šDTOåˆ†å±‚
    public UserDTO mapToUserDTO(User user) {
        UserDTO dto = new UserDTO();
        dto.setId(user.getId());
        dto.setName(user.getName());
        // åªæš´éœ²éœ€è¦çš„å­—æ®µï¼Œéšè—æ•æ„Ÿä¿¡æ¯
        return dto;
    }
    
    // å±‚æ¬¡3ï¼šæŒ‰éœ€æ˜ å°„
    public <T> T mapToTarget(ResultSet rs, Class<T> targetClass) {
        // æ ¹æ®ç›®æ ‡ç±»å‹åŠ¨æ€æ˜ å°„ï¼Œé¿å…å†—ä½™æ•°æ®ä¼ è¾“
        return objectMapper.convertValue(extractData(rs), targetClass);
    }
}
```

### 6.3 æ›´æ–°æ€ç»´ï¼ˆUpdate Thinkingï¼‰


**ğŸ”¸ ä¹è§‚é”æ€ç»´**
```java
// ä¹è§‚é”çš„æ€ç»´å±‚æ¬¡
public class OptimisticLockStrategy {
    
    // åŸºç¡€ç‰ˆæœ¬æ§åˆ¶
    public boolean updateUserWithVersion(User user) {
        String sql = "UPDATE users SET name = ?, version = version + 1 " +
                    "WHERE id = ? AND version = ?";
        int affected = jdbcTemplate.update(sql, 
            user.getName(), user.getId(), user.getVersion());
        return affected > 0;
    }
    
    // é‡è¯•æœºåˆ¶
    public void updateUserWithRetry(User user) {
        int maxRetries = 3;
        for (int i = 0; i < maxRetries; i++) {
            // é‡æ–°è·å–æœ€æ–°ç‰ˆæœ¬
            User latestUser = getUserById(user.getId());
            user.setVersion(latestUser.getVersion());
            
            if (updateUserWithVersion(user)) {
                return; // æ›´æ–°æˆåŠŸ
            }
            
            // çŸ­æš‚ä¼‘çœ åé‡è¯•
            try {
                Thread.sleep(50 * (i + 1));
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
                break;
            }
        }
        throw new BusinessException("æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•");
    }
}
```

**ğŸ’¡ å­—æ®µæ›´æ–°æ€ç»´**
```java
// å­—æ®µçº§æ›´æ–°çš„æ€ç»´è¿›åŒ–
public class FieldUpdateStrategy {
    
    // âŒ å…¨é‡æ›´æ–°ï¼ˆæµªè´¹èµ„æºï¼‰
    public void updateUserFull(User user) {
        String sql = "UPDATE users SET name = ?, email = ?, age = ?, status = ? WHERE id = ?";
        jdbcTemplate.update(sql, user.getName(), user.getEmail(), 
            user.getAge(), user.getStatus(), user.getId());
    }
    
    // âœ… å­—æ®µçº§æ›´æ–°ï¼ˆé«˜æ•ˆï¼‰
    public void updateUserFields(Long userId, Map<String, Object> fields) {
        if (fields.isEmpty()) return;
        
        StringBuilder sql = new StringBuilder("UPDATE users SET ");
        List<Object> params = new ArrayList<>();
        
        boolean first = true;
        for (Map.Entry<String, Object> entry : fields.entrySet()) {
            if (!first) sql.append(", ");
            sql.append(entry.getKey()).append(" = ?");
            params.add(entry.getValue());
            first = false;
        }
        
        sql.append(" WHERE id = ?");
        params.add(userId);
        
        jdbcTemplate.update(sql.toString(), params.toArray());
    }
    
    // âœ… æ™ºèƒ½å·®å¼‚æ›´æ–°
    public void updateUserSmart(User oldUser, User newUser) {
        Map<String, Object> changes = new HashMap<>();
        
        if (!Objects.equals(oldUser.getName(), newUser.getName())) {
            changes.put("name", newUser.getName());
        }
        if (!Objects.equals(oldUser.getEmail(), newUser.getEmail())) {
            changes.put("email", newUser.getEmail());
        }
        
        if (!changes.isEmpty()) {
            changes.put("updated_time", new Date());
            updateUserFields(oldUser.getId(), changes);
        }
    }
}
```

**ğŸ”¸ æ‰¹é‡æ›´æ–°æ€ç»´**
```
æ‰¹é‡æ›´æ–°çš„æ€ç»´å±‚æ¬¡ï¼š

ç®€å•æ€ç»´ï¼šå¾ªç¯å•æ¡æ›´æ–°
for (User user : users) {
    updateUser(user); // æ€§èƒ½å·®
}

ä¼˜åŒ–æ€ç»´ï¼šçœŸæ­£çš„æ‰¹é‡æ›´æ–°
â€¢ ç›¸åŒæ›´æ–°ï¼šä½¿ç”¨INæ¡ä»¶ä¸€æ¬¡æ›´æ–°å¤šæ¡
â€¢ ä¸åŒæ›´æ–°ï¼šä½¿ç”¨CASE WHENæ‰¹é‡æ›´æ–°
â€¢ ä¸´æ—¶è¡¨ï¼šå¤æ‚æ‰¹é‡æ›´æ–°ä½¿ç”¨ä¸´æ—¶è¡¨

ç­–ç•¥æ€ç»´ï¼šæ ¹æ®æ•°æ®ç‰¹ç‚¹é€‰æ‹©æ–¹æ¡ˆ
â€¢ æ•°æ®é‡å°ï¼šç›´æ¥æ‰¹é‡SQL
â€¢ æ•°æ®é‡å¤§ï¼šåˆ†æ‰¹å¤„ç†
â€¢ æ›´æ–°å¤æ‚ï¼šä¸´æ—¶è¡¨+JOINæ›´æ–°
```

### 6.4 åˆ é™¤æ€ç»´ï¼ˆDelete Thinkingï¼‰


**ğŸ”¸ è½¯åˆ é™¤æ€ç»´**
```java
// è½¯åˆ é™¤çš„æ€ç»´å±‚æ¬¡
public class SoftDeleteStrategy {
    
    // åŸºç¡€è½¯åˆ é™¤
    public void softDelete(Long id) {
        String sql = "UPDATE users SET deleted_at = NOW() WHERE id = ?";
        jdbcTemplate.update(sql, id);
    }
    
    // å…³è”å¤„ç†æ€ç»´
    public void deleteUserCascade(Long userId) {
        // 1. æ£€æŸ¥å…³è”æ•°æ®
        checkDependencies(userId);
        
        // 2. è½¯åˆ é™¤ç”¨æˆ·
        softDeleteUser(userId);
        
        // 3. å¤„ç†å…³è”æ•°æ®
        softDeleteUserProfiles(userId);
        softDeleteUserSettings(userId);
        
        // 4. è®°å½•åˆ é™¤æ—¥å¿—
        logDeletion(userId, "ç”¨æˆ·åˆ é™¤");
    }
    
    // æƒé™æ£€æŸ¥æ€ç»´
    public void deleteWithPermission(Long userId, Long operatorId) {
        // 1. æƒé™æ£€æŸ¥
        if (!hasDeletePermission(operatorId, userId)) {
            throw new BusinessException("æ— åˆ é™¤æƒé™");
        }
        
        // 2. ä¸šåŠ¡è§„åˆ™æ£€æŸ¥
        if (!canBeDeleted(userId)) {
            throw new BusinessException("å½“å‰çŠ¶æ€ä¸å…è®¸åˆ é™¤");
        }
        
        // 3. æ‰§è¡Œåˆ é™¤
        deleteUserCascade(userId);
    }
}
```

**ğŸ’¡ å…³è”åˆ é™¤æ€ç»´**
```
å…³è”åˆ é™¤çš„æ€ç»´æ¡†æ¶ï¼š

æ£€æŸ¥é˜¶æ®µï¼š
â€¢ æ˜¯å¦æœ‰å¤–é”®çº¦æŸï¼Ÿ
â€¢ æ˜¯å¦æœ‰ä¸šåŠ¡å…³è”ï¼Ÿ
â€¢ åˆ é™¤åæ˜¯å¦å½±å“å…¶ä»–åŠŸèƒ½ï¼Ÿ

å¤„ç†ç­–ç•¥ï¼š
â€¢ çº§è”åˆ é™¤ï¼šåˆ é™¤ä¸»è®°å½•æ—¶åŒæ—¶åˆ é™¤ç›¸å…³è®°å½•
â€¢ ç½®ç©ºå¤„ç†ï¼šå°†å…³è”å­—æ®µè®¾ä¸ºNULL
â€¢ é˜»æ­¢åˆ é™¤ï¼šæœ‰å…³è”æ•°æ®æ—¶ä¸å…è®¸åˆ é™¤
â€¢ è½¯åˆ é™¤ï¼šæ ‡è®°åˆ é™¤ä½†ä¿ç•™æ•°æ®

é€‰æ‹©åŸåˆ™ï¼š
æ ¹æ®ä¸šåŠ¡è§„åˆ™å’Œæ•°æ®é‡è¦æ€§é€‰æ‹©åˆé€‚ç­–ç•¥
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ CRUDæœ¬è´¨ï¼šå¢åˆ æ”¹æŸ¥æ˜¯æ‰€æœ‰ä¸šåŠ¡ç³»ç»Ÿçš„åŸºç¡€æ“ä½œ
ğŸ”¸ æ€§èƒ½ä¼˜åŒ–ï¼šæ‰¹é‡æ“ä½œæ¯”å•æ¡æ“ä½œæ•ˆç‡é«˜10-100å€
ğŸ”¸ åˆ†é¡µæŸ¥è¯¢ï¼šé˜²æ­¢ä¸€æ¬¡æ€§åŠ è½½æµ·é‡æ•°æ®çš„æ ¸å¿ƒæ‰‹æ®µ
ğŸ”¸ åˆ é™¤ç­–ç•¥ï¼šè½¯åˆ é™¤é€‚åˆä¸šåŠ¡æ•°æ®ï¼Œç¡¬åˆ é™¤é€‚åˆç³»ç»Ÿæ•°æ®
ğŸ”¸ æ“ä½œæ€ç»´ï¼šæ¯ç§æ“ä½œéƒ½æœ‰å¯¹åº”çš„æœ€ä½³å®è·µå’Œæ€ç»´æ–¹å¼
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ æ‰¹é‡æ“ä½œçš„ä»·å€¼**
```
æ€§èƒ½æå‡åŸç†ï¼š
â€¢ å‡å°‘ç½‘ç»œå¾€è¿”ï¼š1æ¬¡è¯·æ±‚ä»£æ›¿Næ¬¡è¯·æ±‚
â€¢ å‡å°‘è¿æ¥å¼€é”€ï¼šå¤ç”¨æ•°æ®åº“è¿æ¥
â€¢ å‡å°‘SQLè§£æï¼šä¸€æ¬¡è§£ææ‰§è¡Œå¤šæ¡æ•°æ®
â€¢ æé«˜ååé‡ï¼šå……åˆ†åˆ©ç”¨æ•°æ®åº“å¤„ç†èƒ½åŠ›

åº”ç”¨åœºæ™¯ï¼š
â€¢ æ•°æ®å¯¼å…¥ï¼šæ‰¹é‡æ’å…¥æ–°ç”¨æˆ·
â€¢ çŠ¶æ€æ›´æ–°ï¼šæ‰¹é‡æ›´æ–°è®¢å•çŠ¶æ€
â€¢ æ•°æ®æ¸…ç†ï¼šæ‰¹é‡åˆ é™¤è¿‡æœŸæ•°æ®
```

**ğŸ”¹ åˆ†é¡µæŸ¥è¯¢çš„æ·±åº¦æ€è€ƒ**
```
ä¸ä»…æ˜¯æŠ€æœ¯é—®é¢˜ï¼Œæ›´æ˜¯äº§å“è®¾è®¡é—®é¢˜ï¼š
â€¢ ç”¨æˆ·çœŸçš„éœ€è¦æŸ¥çœ‹ç¬¬1000é¡µå—ï¼Ÿ
â€¢ èƒ½å¦ç”¨æœç´¢ä»£æ›¿åˆ†é¡µï¼Ÿ
â€¢ æ— é™æ»šåŠ¨æ˜¯å¦æ›´é€‚åˆï¼Ÿ

æŠ€æœ¯å®ç°è¦ç‚¹ï¼š
â€¢ æµ…åˆ†é¡µï¼šæ™®é€šLIMIT OFFSET
â€¢ æ·±åˆ†é¡µï¼šæ¸¸æ ‡åˆ†é¡µï¼ˆID > lastIdï¼‰
â€¢ æ€§èƒ½ä¼˜åŒ–ï¼šå»¶è¿Ÿå…³è”ã€ç´¢å¼•ä¼˜åŒ–
```

**ğŸ”¹ è½¯åˆ é™¤vsç¡¬åˆ é™¤çš„é€‰æ‹©é€»è¾‘**
```
é€‰æ‹©æ ‡å‡†ï¼š
â€¢ æ•°æ®é‡è¦æ€§ï¼šé‡è¦æ•°æ®ç”¨è½¯åˆ é™¤
â€¢ æ¢å¤éœ€æ±‚ï¼šå¯èƒ½éœ€è¦æ¢å¤ç”¨è½¯åˆ é™¤
â€¢ å®¡è®¡è¦æ±‚ï¼šéœ€è¦å®¡è®¡è½¨è¿¹ç”¨è½¯åˆ é™¤
â€¢ å­˜å‚¨æˆæœ¬ï¼šæˆæœ¬æ•æ„Ÿç”¨ç¡¬åˆ é™¤

å®ç°è¦ç‚¹ï¼š
â€¢ æŸ¥è¯¢è¿‡æ»¤ï¼šæ‰€æœ‰æŸ¥è¯¢éƒ½è¦è¿‡æ»¤åˆ é™¤æ•°æ®
â€¢ ç´¢å¼•ä¼˜åŒ–ï¼šä¸ºåˆ é™¤æ ‡å¿—å­—æ®µå»ºç´¢å¼•
â€¢ å®šæœŸæ¸…ç†ï¼šè½¯åˆ é™¤æ•°æ®çš„å®šæœŸç¡¬åˆ é™¤
```

### 7.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ æ€§èƒ½ä¼˜åŒ–å®æˆ˜**
```
æ‰¹é‡æ“ä½œä¼˜åŒ–ï¼š
â€¢ å•æ¬¡æ“ä½œ â†’ æ‰¹é‡æ“ä½œï¼šæ€§èƒ½æå‡10-100å€
â€¢ æ‰¹æ¬¡å¤§å°ï¼š500-2000æ¡ä¸ºæœ€ä½³
â€¢ äº‹åŠ¡æ§åˆ¶ï¼šå¤§æ‰¹é‡è¦åˆ†äº‹åŠ¡å¤„ç†

åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–ï¼š
â€¢ é™åˆ¶é¡µé¢å¤§å°ï¼š10-100æ¡
â€¢ æ·±åˆ†é¡µä¼˜åŒ–ï¼šä½¿ç”¨æ¸¸æ ‡åˆ†é¡µ
â€¢ ç¼“å­˜ç­–ç•¥ï¼šç¼“å­˜æ€»æ•°å’Œçƒ­é—¨é¡µé¢

åˆ é™¤æ“ä½œä¼˜åŒ–ï¼š
â€¢ ä¸šåŠ¡æ•°æ®ï¼šä¼˜å…ˆè€ƒè™‘è½¯åˆ é™¤
â€¢ æ‰¹é‡åˆ é™¤ï¼šä½¿ç”¨INæ¡ä»¶æˆ–EXISTS
â€¢ å…³è”å¤„ç†ï¼šçº§è”åˆ é™¤æˆ–ç½®ç©ºå¤„ç†
```

**ğŸ”§ ä»£ç å®ç°è¦ç‚¹**
```
å®‰å…¨æ€§ä¿éšœï¼š
â€¢ å‚æ•°åŒ–æŸ¥è¯¢ï¼šé˜²æ­¢SQLæ³¨å…¥
â€¢ æƒé™æ£€æŸ¥ï¼šç¡®ä¿æ“ä½œæƒé™
â€¢ æ•°æ®æ ¡éªŒï¼šéªŒè¯æ•°æ®åˆæ³•æ€§

é”™è¯¯å¤„ç†ï¼š
â€¢ å¼‚å¸¸æ•è·ï¼šå¤„ç†æ•°æ®åº“å¼‚å¸¸
â€¢ äº‹åŠ¡å›æ»šï¼šå¤±è´¥æ—¶å›æ»šæ“ä½œ
â€¢ æ—¥å¿—è®°å½•ï¼šè®°å½•æ“ä½œè½¨è¿¹

æ€§èƒ½ç›‘æ§ï¼š
â€¢ æ‰§è¡Œæ—¶é—´ï¼šç›‘æ§æ…¢æŸ¥è¯¢
â€¢ èµ„æºä½¿ç”¨ï¼šç›‘æ§å†…å­˜å’ŒCPU
â€¢ å¹¶å‘æ§åˆ¶ï¼šé˜²æ­¢é”å†²çª
```

### 7.4 è¿›é˜¶å­¦ä¹ æ–¹å‘


**ğŸ“š æ·±å…¥å­¦ä¹ å»ºè®®**
```
æ•°æ®åº“ä¼˜åŒ–ï¼š
â€¢ ç´¢å¼•è®¾è®¡ï¼šå¤åˆç´¢å¼•ã€è¦†ç›–ç´¢å¼•
â€¢ æŸ¥è¯¢ä¼˜åŒ–ï¼šæ‰§è¡Œè®¡åˆ’åˆ†æ
â€¢ åˆ†åº“åˆ†è¡¨ï¼šå¤§æ•°æ®é‡å¤„ç†

æ¶æ„è®¾è®¡ï¼š
â€¢ è¯»å†™åˆ†ç¦»ï¼šæé«˜æŸ¥è¯¢æ€§èƒ½
â€¢ ç¼“å­˜ç­–ç•¥ï¼šRedisç¼“å­˜è®¾è®¡
â€¢ æ¶ˆæ¯é˜Ÿåˆ—ï¼šå¼‚æ­¥å¤„ç†ä¼˜åŒ–

ç›‘æ§è¿ç»´ï¼š
â€¢ æ€§èƒ½ç›‘æ§ï¼šAPMå·¥å…·ä½¿ç”¨
â€¢ æ…¢æŸ¥è¯¢åˆ†æï¼šå®šä½æ€§èƒ½ç“¶é¢ˆ
â€¢ å®¹é‡è§„åˆ’ï¼šé¢„ä¼°èµ„æºéœ€æ±‚
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
CRUDæ“ä½œè¦ä¼˜åŒ–ï¼Œæ‰¹é‡å¤„ç†æ•ˆç‡é«˜
åˆ†é¡µæŸ¥è¯¢é˜²æµ·é‡ï¼Œæ¸¸æ ‡ç¿»é¡µæ€§èƒ½å¥½  
è½¯åˆ ç¡¬åˆ çœ‹åœºæ™¯ï¼Œä¸šåŠ¡æ•°æ®è¦ä¿ç•™
æƒé™æ£€æŸ¥ä¸èƒ½å°‘ï¼Œå¼‚å¸¸å¤„ç†è¦å‘¨åˆ°
```