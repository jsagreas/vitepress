---
title: 4ã€è§’è‰²æµ‹è¯•éªŒè¯
---
## ğŸ“š ç›®å½•

1. [è§’è‰²æµ‹è¯•æ¦‚è¿°](#1-è§’è‰²æµ‹è¯•æ¦‚è¿°)
2. [Moleculeæµ‹è¯•æ¡†æ¶](#2-Moleculeæµ‹è¯•æ¡†æ¶)
3. [æµ‹è¯•ç±»å‹è¯¦è§£](#3-æµ‹è¯•ç±»å‹è¯¦è§£)
4. [å®é™…æµ‹è¯•å®è·µ](#4-å®é™…æµ‹è¯•å®è·µ)
5. [CI/CDé›†æˆæµ‹è¯•](#5-CI-CDé›†æˆæµ‹è¯•)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ§ª è§’è‰²æµ‹è¯•æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯Ansibleè§’è‰²æµ‹è¯•


**ç®€å•ç†è§£**ï¼šå°±åƒæˆ‘ä»¬å†™ç¨‹åºè¦æµ‹è¯•ä»£ç æ˜¯å¦æ­£ç¡®ä¸€æ ·ï¼ŒAnsibleè§’è‰²ä¹Ÿéœ€è¦æµ‹è¯•æ¥ä¿è¯å®ƒèƒ½æ­£å¸¸å·¥ä½œã€‚

```
ä¼ ç»Ÿæ‰‹å·¥æµ‹è¯•ï¼š                  è‡ªåŠ¨åŒ–æµ‹è¯•ï¼š
å†™å¥½è§’è‰² â†’ æ‰‹åŠ¨åœ¨æœåŠ¡å™¨ä¸Šè·‘    å†™å¥½è§’è‰² â†’ è‡ªåŠ¨æµ‹è¯•è„šæœ¬éªŒè¯
çœ‹çœ‹æœ‰æ²¡æœ‰æŠ¥é”™ â†’ æ£€æŸ¥ç»“æœ      å¤šç§ç¯å¢ƒåŒæ—¶æµ‹è¯• â†’ è‡ªåŠ¨æŠ¥å‘Š
è´¹æ—¶è´¹åŠ›ï¼Œå®¹æ˜“å‡ºé”™               å¿«é€Ÿå¯é ï¼ŒæŒç»­éªŒè¯
```

**ä¸ºä»€ä¹ˆéœ€è¦è§’è‰²æµ‹è¯•**ï¼š
- âœ… **ç¡®ä¿åŠŸèƒ½æ­£ç¡®**ï¼šè§’è‰²ç¡®å®èƒ½å®Œæˆé¢„æœŸä»»åŠ¡
- âœ… **é¿å…ç¯å¢ƒé—®é¢˜**ï¼šä¸åŒæ“ä½œç³»ç»Ÿä¸Šéƒ½èƒ½æ­£å¸¸å·¥ä½œ
- âœ… **ä¿è¯å¹‚ç­‰æ€§**ï¼šå¤šæ¬¡è¿è¡Œç»“æœä¸€è‡´
- âœ… **æé«˜ä»£ç è´¨é‡**ï¼šå‘ç°æ½œåœ¨é—®é¢˜å’Œä¸è§„èŒƒå†™æ³•

### 1.2 æµ‹è¯•ç­–ç•¥åˆ†å±‚


```
æµ‹è¯•é‡‘å­—å¡”æ¨¡å‹ï¼š

        é›†æˆæµ‹è¯• ğŸ”º
       /           \
      åŠŸèƒ½æµ‹è¯• ğŸ”»     
     /         \     
   è¯­æ³•æµ‹è¯• ğŸ”»ğŸ”»ğŸ”»
  
åº•å±‚ï¼šè¯­æ³•æ£€æŸ¥ï¼ˆæœ€å¤šï¼Œæœ€å¿«ï¼‰
ä¸­å±‚ï¼šåŠŸèƒ½æµ‹è¯•ï¼ˆé€‚é‡ï¼Œä¸­ç­‰é€Ÿåº¦ï¼‰  
é¡¶å±‚ï¼šé›†æˆæµ‹è¯•ï¼ˆæœ€å°‘ï¼Œæœ€æ…¢ä½†æœ€å…¨é¢ï¼‰
```

**å„å±‚æµ‹è¯•ä½œç”¨**ï¼š

| æµ‹è¯•å±‚çº§ | **ä¸»è¦ç›®çš„** | **æ£€æŸ¥å†…å®¹** | **è¿è¡Œé¢‘ç‡** |
|---------|------------|-------------|------------|
| ğŸ” **è¯­æ³•æµ‹è¯•** | `æ£€æŸ¥ä»£ç æ ¼å¼` | `YAMLè¯­æ³•ã€Ansibleè§„èŒƒ` | `æ¯æ¬¡æäº¤` |
| âš™ï¸ **å•å…ƒæµ‹è¯•** | `éªŒè¯æ¨¡å—åŠŸèƒ½` | `ä»»åŠ¡æ‰§è¡Œã€å˜é‡å¤„ç†` | `æ¯æ¬¡æ„å»º` |
| ğŸ”§ **åŠŸèƒ½æµ‹è¯•** | `æµ‹è¯•å®Œæ•´åœºæ™¯` | `è§’è‰²æ•´ä½“æ•ˆæœ` | `æ¯æ—¥æ„å»º` |
| ğŸŒ **é›†æˆæµ‹è¯•** | `å¤šè§’è‰²åä½œ` | `æ•´å¥—æ–¹æ¡ˆéªŒè¯` | `ç‰ˆæœ¬å‘å¸ƒ` |

### 1.3 æµ‹è¯•ç¯å¢ƒè¦æ±‚


**æµ‹è¯•ç¯å¢ƒç‰¹ç‚¹**ï¼š
- **éš”ç¦»æ€§**ï¼šä¸å½±å“ç”Ÿäº§ç¯å¢ƒ
- **å¯é‡å¤**ï¼šæ¯æ¬¡æµ‹è¯•ç¯å¢ƒä¸€è‡´
- **å¤šæ ·æ€§**ï¼šè¦†ç›–ä¸åŒæ“ä½œç³»ç»Ÿ
- **è‡ªåŠ¨åŒ–**ï¼šæ— éœ€äººå·¥å¹²é¢„

```
æµ‹è¯•ç¯å¢ƒæ„æˆï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ§åˆ¶èŠ‚ç‚¹      â”‚    â”‚   æµ‹è¯•ç›®æ ‡      â”‚
â”‚   (Ansible)     â”‚â”€â”€â”€â”€â”‚  (Dockerå®¹å™¨)   â”‚
â”‚   + Molecule    â”‚    â”‚  Ubuntu/CentOS  â”‚
â”‚   + æµ‹è¯•è„šæœ¬    â”‚    â”‚  + æµ‹è¯•åº”ç”¨     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸ”¬ Moleculeæµ‹è¯•æ¡†æ¶


### 2.1 Moleculeæ¡†æ¶ä»‹ç»


**Moleculeæ˜¯ä»€ä¹ˆ**ï¼šAnsibleå®˜æ–¹æ¨èçš„è§’è‰²æµ‹è¯•æ¡†æ¶ï¼Œä¸“é—¨ç”¨æ¥æµ‹è¯•Ansibleè§’è‰²çš„å·¥å…·ã€‚

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- ğŸ—ï¸ **ç¯å¢ƒç®¡ç†**ï¼šè‡ªåŠ¨åˆ›å»ºå’Œé”€æ¯æµ‹è¯•ç¯å¢ƒ
- ğŸ§ª **æµ‹è¯•æ‰§è¡Œ**ï¼šè¿è¡Œå„ç§ç±»å‹çš„æµ‹è¯•
- ğŸ“Š **ç»“æœæŠ¥å‘Š**ï¼šç”Ÿæˆè¯¦ç»†çš„æµ‹è¯•æŠ¥å‘Š
- ğŸ”„ **ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼šå®Œæ•´çš„æµ‹è¯•æµç¨‹æ§åˆ¶

### 2.2 Moleculeå®‰è£…é…ç½®


**å®‰è£…Molecule**ï¼š
```bash
# åŸºç¡€å®‰è£…
pip install molecule

# å®Œæ•´å®‰è£…ï¼ˆåŒ…å«Dockeræ”¯æŒï¼‰
pip install 'molecule[docker]'

# éªŒè¯å®‰è£…
molecule --version
```

**åˆå§‹åŒ–è§’è‰²æµ‹è¯•**ï¼š
```bash
# åœ¨è§’è‰²ç›®å½•ä¸­åˆå§‹åŒ–æµ‹è¯•
cd my-role
molecule init scenario

# æˆ–åˆ›å»ºæ–°è§’è‰²æ—¶ç›´æ¥åŒ…å«æµ‹è¯•
molecule init role my-new-role --driver-name docker
```

### 2.3 Moleculeé…ç½®æ–‡ä»¶è¯¦è§£


**molecule.ymlé…ç½®**ï¼š
```yaml
# molecule/default/molecule.yml
dependency:
  name: galaxy              # ä¾èµ–ç®¡ç†å™¨
driver:
  name: docker             # æµ‹è¯•å¹³å°ï¼ˆdocker/vagrant/ec2ç­‰ï¼‰
platforms:
  - name: instance-ubuntu    # æµ‹è¯•å®ä¾‹åç§°
    image: ubuntu:20.04     # ä½¿ç”¨çš„é•œåƒ
    pre_build_image: false  # æ˜¯å¦é¢„æ„å»ºé•œåƒ
  - name: instance-centos
    image: centos:8
    pre_build_image: false
provisioner:
  name: ansible            # ä½¿ç”¨Ansibleä½œä¸ºé…ç½®å·¥å…·
  inventory:
    host_vars:
      instance-ubuntu:
        ansible_python_interpreter: /usr/bin/python3
verifier:
  name: testinfra          # éªŒè¯å·¥å…·
```

**æµ‹è¯•åœºæ™¯é…ç½®**ï¼š
```yaml
# ä¸åŒåœºæ™¯å¯ä»¥æœ‰ä¸åŒé…ç½®
scenario:
  name: default            # åœºæ™¯åç§°
  test_sequence:           # æµ‹è¯•æ­¥éª¤åºåˆ—
    - dependency           # å®‰è£…ä¾èµ–
    - cleanup             # æ¸…ç†ç¯å¢ƒ
    - destroy             # é”€æ¯å®ä¾‹
    - syntax              # è¯­æ³•æ£€æŸ¥
    - create              # åˆ›å»ºå®ä¾‹
    - prepare             # å‡†å¤‡ç¯å¢ƒ
    - converge            # æ‰§è¡Œè§’è‰²
    - idempotence         # å¹‚ç­‰æ€§æµ‹è¯•
    - side_effect         # å‰¯ä½œç”¨æµ‹è¯•
    - verify              # éªŒè¯ç»“æœ
    - cleanup             # æ¸…ç†
    - destroy             # é”€æ¯
```

### 2.4 æµ‹è¯•æ–‡ä»¶ç»“æ„


```
è§’è‰²æµ‹è¯•ç›®å½•ç»“æ„ï¼š
my-role/
â”œâ”€â”€ tasks/
â”‚   â””â”€â”€ main.yml
â”œâ”€â”€ molecule/                    â† æµ‹è¯•ç›¸å…³æ–‡ä»¶
â”‚   â””â”€â”€ default/                â† é»˜è®¤æµ‹è¯•åœºæ™¯
â”‚       â”œâ”€â”€ molecule.yml        â† Moleculeé…ç½®
â”‚       â”œâ”€â”€ converge.yml        â† æµ‹è¯•playbook
â”‚       â”œâ”€â”€ verify.yml          â† éªŒè¯è„šæœ¬
â”‚       â””â”€â”€ prepare.yml         â† ç¯å¢ƒå‡†å¤‡è„šæœ¬
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ test_default.py         â† Pythonæµ‹è¯•è„šæœ¬
â””â”€â”€ meta/
    â””â”€â”€ main.yml
```

---

## 3. ğŸ“‹ æµ‹è¯•ç±»å‹è¯¦è§£


### 3.1 è¯­æ³•æ£€æŸ¥æµ‹è¯•


**ç›®çš„**ï¼šæ£€æŸ¥Ansibleä»£ç çš„è¯­æ³•æ­£ç¡®æ€§å’Œè§„èŒƒæ€§ã€‚

**æ£€æŸ¥å†…å®¹**ï¼š
- âœ… **YAMLè¯­æ³•**ï¼šç¼©è¿›ã€æ ¼å¼æ˜¯å¦æ­£ç¡®
- âœ… **Ansibleè§„èŒƒ**ï¼šæ¨¡å—ä½¿ç”¨æ˜¯å¦ç¬¦åˆæœ€ä½³å®è·µ
- âœ… **å˜é‡å‘½å**ï¼šå˜é‡åæ˜¯å¦ç¬¦åˆè§„èŒƒ
- âœ… **ä»»åŠ¡ç»“æ„**ï¼šä»»åŠ¡å®šä¹‰æ˜¯å¦å®Œæ•´

**å®ç°æ–¹å¼**ï¼š
```bash
# Ansibleå†…ç½®è¯­æ³•æ£€æŸ¥
ansible-playbook --syntax-check site.yml

# ä½¿ç”¨ansible-lintè¿›è¡Œæ›´ä¸¥æ ¼æ£€æŸ¥
pip install ansible-lint
ansible-lint my-role/

# é›†æˆåˆ°Moleculeä¸­
molecule syntax
```

**å¸¸è§è¯­æ³•é—®é¢˜**ï¼š
```yaml
# âŒ é”™è¯¯å†™æ³•
- name: install package
  yum: name=nginx state=present    # ä¸æ¨èçš„å†™æ³•

# âœ… æ­£ç¡®å†™æ³•  
- name: Install nginx package
  yum:
    name: nginx
    state: present
```

### 3.2 å¹‚ç­‰æ€§æµ‹è¯•


**ä»€ä¹ˆæ˜¯å¹‚ç­‰æ€§**ï¼šåŒæ ·çš„æ“ä½œæ‰§è¡Œå¤šæ¬¡ï¼Œç»“æœåº”è¯¥æ˜¯ä¸€æ ·çš„ã€‚

**ä¸ºä»€ä¹ˆé‡è¦**ï¼š
- ğŸ”„ **é‡å¤æ‰§è¡Œå®‰å…¨**ï¼šå¤šæ¬¡è¿è¡Œä¸ä¼šé€ æˆé—®é¢˜
- ğŸ¯ **çŠ¶æ€ä¸€è‡´æ€§**ï¼šç¡®ä¿æœ€ç»ˆçŠ¶æ€ç¬¦åˆé¢„æœŸ
- âš¡ **æ€§èƒ½ä¼˜åŒ–**ï¼šé¿å…ä¸å¿…è¦çš„é‡å¤æ“ä½œ

**æµ‹è¯•åŸç†**ï¼š
```
ç¬¬ä¸€æ¬¡æ‰§è¡Œè§’è‰² â†’ è®°å½•å˜åŒ–
ç¬¬äºŒæ¬¡æ‰§è¡Œè§’è‰² â†’ æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
å¦‚æœç¬¬äºŒæ¬¡ä»æœ‰å˜åŒ– â†’ å¹‚ç­‰æ€§æµ‹è¯•å¤±è´¥
```

**å®ç°ç¤ºä¾‹**ï¼š
```bash
# Moleculeè‡ªåŠ¨è¿›è¡Œå¹‚ç­‰æ€§æµ‹è¯•
molecule converge    # ç¬¬ä¸€æ¬¡æ‰§è¡Œ
molecule idempotence # å¹‚ç­‰æ€§æµ‹è¯•ï¼ˆç¬¬äºŒæ¬¡æ‰§è¡Œï¼‰
```

**å¹‚ç­‰æ€§ç¼–å†™æŠ€å·§**ï¼š
```yaml
# âœ… è‰¯å¥½çš„å¹‚ç­‰æ€§ç¤ºä¾‹
- name: Ensure nginx is installed
  package:
    name: nginx
    state: present

- name: Ensure nginx config is present
  template:
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
  notify: restart nginx

# âŒ ç ´åå¹‚ç­‰æ€§çš„ä¾‹å­
- name: Add line to file
  shell: echo "new line" >> /etc/hosts    # æ¯æ¬¡éƒ½ä¼šæ·»åŠ 
```

### 3.3 å•å…ƒæµ‹è¯•


**ç›®çš„**ï¼šæµ‹è¯•è§’è‰²ä¸­çš„å•ä¸ªä»»åŠ¡æˆ–åŠŸèƒ½æ¨¡å—ã€‚

**æµ‹è¯•é‡ç‚¹**ï¼š
- ğŸ“ **ä»»åŠ¡æ‰§è¡Œç»“æœ**ï¼šä»»åŠ¡æ˜¯å¦æˆåŠŸå®Œæˆ
- ğŸ”§ **æ–‡ä»¶å’Œé…ç½®**ï¼šç”Ÿæˆçš„æ–‡ä»¶å†…å®¹æ˜¯å¦æ­£ç¡®
- ğŸ”— **æœåŠ¡çŠ¶æ€**ï¼šæœåŠ¡æ˜¯å¦æ­£ç¡®å¯åŠ¨
- ğŸ“Š **å˜é‡å¤„ç†**ï¼šå˜é‡æ˜¯å¦æ­£ç¡®è®¾ç½®å’Œä½¿ç”¨

**ä½¿ç”¨testinfraè¿›è¡ŒéªŒè¯**ï¼š
```python
# tests/test_default.py
import pytest

def test_nginx_installed(host):
    """æµ‹è¯•nginxæ˜¯å¦å®‰è£…"""
    nginx = host.package("nginx")
    assert nginx.is_installed

def test_nginx_running(host):
    """æµ‹è¯•nginxæœåŠ¡æ˜¯å¦è¿è¡Œ"""
    nginx = host.service("nginx")
    assert nginx.is_running
    assert nginx.is_enabled

def test_nginx_config(host):
    """æµ‹è¯•nginxé…ç½®æ–‡ä»¶"""
    config = host.file("/etc/nginx/nginx.conf")
    assert config.exists
    assert config.contains("server_name")
    assert config.user == "root"
    assert config.mode == 0o644

def test_nginx_listening(host):
    """æµ‹è¯•nginxç«¯å£ç›‘å¬"""
    assert host.socket("tcp://0.0.0.0:80").is_listening
```

### 3.4 é›†æˆæµ‹è¯•


**ç›®çš„**ï¼šæµ‹è¯•å¤šä¸ªè§’è‰²ååŒå·¥ä½œçš„æ•ˆæœã€‚

**æµ‹è¯•åœºæ™¯**ï¼š
- ğŸ”— **è§’è‰²ä¾èµ–**ï¼šä¾èµ–çš„è§’è‰²æ˜¯å¦æ­£ç¡®å®‰è£…
- ğŸŒ **æœåŠ¡äº¤äº’**ï¼šä¸åŒæœåŠ¡ä¹‹é—´æ˜¯å¦èƒ½æ­£å¸¸é€šä¿¡
- ğŸ“‹ **å®Œæ•´æµç¨‹**ï¼šæ•´å¥—éƒ¨ç½²æ–¹æ¡ˆæ˜¯å¦å·¥ä½œæ­£å¸¸

**é›†æˆæµ‹è¯•ç¤ºä¾‹**ï¼š
```yaml
# molecule/integration/converge.yml
---
- name: Integration test playbook
  hosts: all
  roles:
    - role: database           # å…ˆå®‰è£…æ•°æ®åº“
    - role: application        # å†å®‰è£…åº”ç”¨
    - role: loadbalancer      # æœ€åé…ç½®è´Ÿè½½å‡è¡¡

- name: Verify integration
  hosts: all
  tasks:
    - name: Test application connectivity
      uri:
        url: "http://{{ ansible_default_ipv4.address }}/health"
        status_code: 200
```

### 3.5 å¤šå¹³å°æµ‹è¯•


**ç›®çš„**ï¼šç¡®ä¿è§’è‰²åœ¨ä¸åŒæ“ä½œç³»ç»Ÿä¸Šéƒ½èƒ½æ­£å¸¸å·¥ä½œã€‚

**å¹³å°é…ç½®**ï¼š
```yaml
# molecule.ymlä¸­çš„å¤šå¹³å°é…ç½®
platforms:
  - name: ubuntu-18
    image: ubuntu:18.04
    platform: linux/amd64
  - name: ubuntu-20  
    image: ubuntu:20.04
    platform: linux/amd64
  - name: centos-7
    image: centos:7
    platform: linux/amd64
  - name: centos-8
    image: centos:8
    platform: linux/amd64
```

**è·¨å¹³å°å…¼å®¹æ€§å¤„ç†**ï¼š
```yaml
# å¤„ç†ä¸åŒå¹³å°çš„åŒ…ç®¡ç†å™¨
- name: Install packages (Ubuntu/Debian)
  apt:
    name: "{{ packages }}"
    state: present
  when: ansible_os_family == "Debian"

- name: Install packages (CentOS/RHEL)
  yum:
    name: "{{ packages }}"  
    state: present
  when: ansible_os_family == "RedHat"
```

---

## 4. ğŸ› ï¸ å®é™…æµ‹è¯•å®è·µ


### 4.1 åˆ›å»ºå®Œæ•´çš„æµ‹è¯•ç¤ºä¾‹


è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªnginxè§’è‰²çš„å®Œæ•´æµ‹è¯•ï¼š

**è§’è‰²ä»»åŠ¡**ï¼š
```yaml
# tasks/main.yml
---
- name: Install nginx
  package:
    name: nginx
    state: present

- name: Copy nginx config
  template:
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
  notify: restart nginx

- name: Start and enable nginx
  service:
    name: nginx
    state: started
    enabled: yes

- name: Open firewall for nginx
  firewalld:
    service: http
    permanent: yes
    state: enabled
  when: ansible_os_family == "RedHat"
```

**æµ‹è¯•é…ç½®**ï¼š
```yaml
# molecule/default/molecule.yml
dependency:
  name: galaxy
driver:
  name: docker
platforms:
  - name: nginx-ubuntu
    image: ubuntu:20.04
    pre_build_image: false
  - name: nginx-centos
    image: centos:8
    pre_build_image: false
provisioner:
  name: ansible
  inventory:
    host_vars:
      nginx-ubuntu:
        ansible_python_interpreter: /usr/bin/python3
verifier:
  name: testinfra
```

**éªŒè¯è„šæœ¬**ï¼š
```python
# molecule/default/tests/test_default.py
import pytest

@pytest.mark.parametrize("package", [
    "nginx"
])
def test_packages(host, package):
    """éªŒè¯è½¯ä»¶åŒ…å®‰è£…"""
    pkg = host.package(package)
    assert pkg.is_installed

def test_nginx_config(host):
    """éªŒè¯é…ç½®æ–‡ä»¶"""
    config = host.file("/etc/nginx/nginx.conf")
    assert config.exists
    assert config.is_file

def test_nginx_service(host):
    """éªŒè¯æœåŠ¡çŠ¶æ€"""
    service = host.service("nginx")
    assert service.is_running
    assert service.is_enabled

def test_nginx_socket(host):
    """éªŒè¯ç«¯å£ç›‘å¬"""
    assert host.socket("tcp://0.0.0.0:80").is_listening
```

### 4.2 æ‰§è¡Œæµ‹è¯•æµç¨‹


**å®Œæ•´æµ‹è¯•å‘½ä»¤**ï¼š
```bash
# æ‰§è¡Œæ‰€æœ‰æµ‹è¯•æ­¥éª¤
molecule test

# åˆ†æ­¥æ‰§è¡Œæµ‹è¯•
molecule create      # åˆ›å»ºæµ‹è¯•ç¯å¢ƒ
molecule converge    # æ‰§è¡Œè§’è‰²
molecule verify      # éªŒè¯ç»“æœ
molecule destroy     # æ¸…ç†ç¯å¢ƒ
```

**æµ‹è¯•è¾“å‡ºè§£è¯»**ï¼š
```
æµ‹è¯•æ‰§è¡Œè¿‡ç¨‹ï¼š
âœ… dependency      # å®‰è£…Galaxyä¾èµ–
âœ… cleanup         # æ¸…ç†æ—§ç¯å¢ƒ  
âœ… destroy         # é”€æ¯æ—§å®ä¾‹
âœ… syntax          # è¯­æ³•æ£€æŸ¥
âœ… create          # åˆ›å»ºæ–°å®ä¾‹
âœ… prepare         # å‡†å¤‡æµ‹è¯•ç¯å¢ƒ
âœ… converge        # æ‰§è¡Œè§’è‰²ï¼ˆç¬¬ä¸€æ¬¡ï¼‰
âœ… idempotence     # å¹‚ç­‰æ€§æµ‹è¯•ï¼ˆç¬¬äºŒæ¬¡æ‰§è¡Œï¼‰
âœ… side_effect     # å‰¯ä½œç”¨æ£€æŸ¥
âœ… verify          # è¿è¡ŒéªŒè¯è„šæœ¬
âœ… cleanup         # æ¸…ç†
âœ… destroy         # é”€æ¯å®ä¾‹

æµ‹è¯•ç»“æœï¼šPASSED âœ…
```

### 4.3 è°ƒè¯•æµ‹è¯•é—®é¢˜


**å¸¸è§é—®é¢˜æ’æŸ¥**ï¼š

**é—®é¢˜1ï¼šå®¹å™¨å¯åŠ¨å¤±è´¥**
```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
molecule --debug create

# æ‰‹åŠ¨æµ‹è¯•å®¹å™¨
docker run -it ubuntu:20.04 /bin/bash
```

**é—®é¢˜2ï¼šä»»åŠ¡æ‰§è¡Œå¤±è´¥**
```bash
# ä¿ç•™ç¯å¢ƒè¿›è¡Œè°ƒè¯•
molecule converge --debug

# è¿›å…¥å®¹å™¨è°ƒè¯•
docker exec -it <container_id> /bin/bash
```

**é—®é¢˜3ï¼šéªŒè¯å¤±è´¥**
```bash
# å•ç‹¬è¿è¡ŒéªŒè¯
molecule verify

# æŸ¥çœ‹éªŒè¯è¯¦ç»†è¾“å‡º
molecule --debug verify
```

### 4.4 æµ‹è¯•æœ€ä½³å®è·µ


**ç¼–å†™é«˜è´¨é‡æµ‹è¯•**ï¼š

| å®è·µåŸåˆ™ | **å…·ä½“åšæ³•** | **é¿å…é—®é¢˜** |
|---------|-------------|-------------|
| ğŸ¯ **æµ‹è¯•ç‹¬ç«‹æ€§** | `æ¯ä¸ªæµ‹è¯•äº’ä¸ä¾èµ–` | `ä¸€ä¸ªæµ‹è¯•å¤±è´¥å½±å“å…¶ä»–` |
| ğŸ“ **æµ‹è¯•è¦†ç›–å…¨é¢** | `è¦†ç›–ä¸»è¦åŠŸèƒ½ç‚¹` | `é—æ¼å…³é”®æµ‹è¯•åœºæ™¯` |
| âš¡ **æ‰§è¡Œé€Ÿåº¦å¿«** | `ä½¿ç”¨è½»é‡çº§é•œåƒ` | `æµ‹è¯•è¿è¡Œæ—¶é—´è¿‡é•¿` |
| ğŸ”„ **å¯é‡å¤æ‰§è¡Œ** | `æ¯æ¬¡ç»“æœä¸€è‡´` | `æµ‹è¯•ç»“æœä¸ç¨³å®š` |

**æµ‹è¯•æ•°æ®ç®¡ç†**ï¼š
```yaml
# ä½¿ç”¨å˜é‡ç®¡ç†æµ‹è¯•æ•°æ®
# molecule/default/group_vars/all.yml
test_packages:
  - nginx
  - curl

test_services:
  - nginx

test_ports:
  - 80
  - 443
```

---

## 5. ğŸš€ CI/CDé›†æˆæµ‹è¯•


### 5.1 æŒç»­é›†æˆæ¦‚å¿µ


**ä»€ä¹ˆæ˜¯CI/CDä¸­çš„æµ‹è¯•**ï¼šå°†Ansibleè§’è‰²æµ‹è¯•é›†æˆåˆ°ä»£ç çš„æŒç»­é›†æˆå’Œéƒ¨ç½²æµç¨‹ä¸­ã€‚

**é›†æˆçš„å¥½å¤„**ï¼š
- âš¡ **å¿«é€Ÿåé¦ˆ**ï¼šä»£ç æäº¤åç«‹å³å¾—åˆ°æµ‹è¯•ç»“æœ
- ğŸ›¡ï¸ **è´¨é‡ä¿è¯**ï¼šç¡®ä¿åˆå¹¶çš„ä»£ç éƒ½ç»è¿‡æµ‹è¯•
- ğŸ”„ **è‡ªåŠ¨åŒ–æµç¨‹**ï¼šå‡å°‘æ‰‹åŠ¨æ“ä½œå’Œäººä¸ºé”™è¯¯

### 5.2 GitHub Actionsé›†æˆ


**é…ç½®æ–‡ä»¶ç¤ºä¾‹**ï¼š
```yaml
# .github/workflows/ci.yml
name: CI
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        distro:
          - ubuntu2004
          - centos8
        
    steps:
    - name: Check out code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        pip install molecule molecule-docker
        
    - name: Run Molecule tests
      run: molecule test
      env:
        MOLECULE_DISTRO: ${{ matrix.distro }}
```

### 5.3 Jenkinsé›†æˆ


**Jenkinsfileç¤ºä¾‹**ï¼š
```groovy
pipeline {
    agent any
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Install Dependencies') {
            steps {
                sh 'pip install molecule molecule-docker'
            }
        }
        
        stage('Lint') {
            steps {
                sh 'ansible-lint .'
            }
        }
        
        stage('Test') {
            parallel {
                stage('Ubuntu') {
                    steps {
                        sh 'MOLECULE_DISTRO=ubuntu2004 molecule test'
                    }
                }
                stage('CentOS') {
                    steps {
                        sh 'MOLECULE_DISTRO=centos8 molecule test'
                    }
                }
            }
        }
    }
    
    post {
        always {
            publishTestResults testResultsPattern: '**/test-*.xml'
        }
    }
}
```

### 5.4 æµ‹è¯•æŠ¥å‘Šå’Œé€šçŸ¥


**ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š**ï¼š
```bash
# ç”ŸæˆJUnitæ ¼å¼æŠ¥å‘Š
molecule --base-config molecule.yml test --junit-xml results.xml

# ç”ŸæˆHTMLæŠ¥å‘Š
pytest --html=report.html --self-contained-html
```

**é›†æˆé€šçŸ¥æœºåˆ¶**ï¼š
```yaml
# æµ‹è¯•å¤±è´¥æ—¶å‘é€é€šçŸ¥
- name: Notify on failure
  uses: 8398a7/action-slack@v3
  with:
    status: ${{ job.status }}
    text: 'Ansible role test failed!'
  if: failure()
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ è§’è‰²æµ‹è¯•é‡è¦æ€§ï¼šç¡®ä¿ä»£ç è´¨é‡ï¼Œé¿å…ç”Ÿäº§é—®é¢˜
ğŸ”¸ Moleculeæ¡†æ¶ï¼šAnsibleå®˜æ–¹æµ‹è¯•å·¥å…·ï¼ŒåŠŸèƒ½å…¨é¢
ğŸ”¸ æµ‹è¯•ç±»å‹åˆ†å±‚ï¼šè¯­æ³•â†’å•å…ƒâ†’é›†æˆï¼Œé€å±‚éªŒè¯
ğŸ”¸ å¹‚ç­‰æ€§æµ‹è¯•ï¼šé‡å¤æ‰§è¡Œç»“æœä¸€è‡´ï¼Œç”Ÿäº§ç¯å¢ƒå®‰å…¨
ğŸ”¸ å¤šå¹³å°æµ‹è¯•ï¼šç¡®ä¿è·¨ç³»ç»Ÿå…¼å®¹æ€§
ğŸ”¸ CI/CDé›†æˆï¼šè‡ªåŠ¨åŒ–æµ‹è¯•ï¼Œæé«˜å¼€å‘æ•ˆç‡
```

### 6.2 å…³é”®ç†è§£è¦ç‚¹


**æµ‹è¯•ç­–ç•¥é€‰æ‹©**ï¼š
- **å¼€å‘é˜¶æ®µ**ï¼šé‡ç‚¹è¿›è¡Œè¯­æ³•æ£€æŸ¥å’Œå•å…ƒæµ‹è¯•
- **é›†æˆé˜¶æ®µ**ï¼šè¿›è¡ŒåŠŸèƒ½æµ‹è¯•å’Œé›†æˆæµ‹è¯•  
- **å‘å¸ƒé˜¶æ®µ**ï¼šå…¨é¢çš„å¤šå¹³å°æµ‹è¯•

**æµ‹è¯•ç¯å¢ƒç®¡ç†**ï¼š
- **éš”ç¦»åŸåˆ™**ï¼šæµ‹è¯•ç¯å¢ƒä¸ç”Ÿäº§ç¯å¢ƒå®Œå…¨éš”ç¦»
- **æ ‡å‡†åŒ–**ï¼šä½¿ç”¨å®¹å™¨ä¿è¯ç¯å¢ƒä¸€è‡´æ€§
- **è‡ªåŠ¨åŒ–**ï¼šé€šè¿‡å·¥å…·è‡ªåŠ¨åˆ›å»ºå’Œé”€æ¯

**è´¨é‡ä¿è¯æµç¨‹**ï¼š
```
ä»£ç ç¼–å†™ â†’ è¯­æ³•æ£€æŸ¥ â†’ å•å…ƒæµ‹è¯• â†’ é›†æˆæµ‹è¯• â†’ å¤šå¹³å°éªŒè¯ â†’ éƒ¨ç½²ä¸Šçº¿
    â†“         â†“         â†“         â†“         â†“         â†“
  IDEæ£€æŸ¥   ansible-lint  molecule   testinfra   CI/CD    ç›‘æ§å‘Šè­¦
```

### 6.3 å®é™…åº”ç”¨ä»·å€¼


**å¯¹ä¸ªäººå¼€å‘è€…**ï¼š
- ğŸ“ˆ **æå‡ä»£ç è´¨é‡**ï¼šå‘ç°æ½œåœ¨é—®é¢˜ï¼Œè§„èŒƒä»£ç é£æ ¼
- âš¡ **åŠ å¿«è°ƒè¯•é€Ÿåº¦**ï¼šå¿«é€Ÿå®šä½é—®é¢˜ï¼Œå‡å°‘è¯•é”™æ—¶é—´
- ğŸ¯ **å¢å¼ºä¿¡å¿ƒ**ï¼šå……åˆ†æµ‹è¯•åçš„ä»£ç æ›´å¯é 

**å¯¹å›¢é˜Ÿåä½œ**ï¼š
- ğŸ¤ **ç»Ÿä¸€æ ‡å‡†**ï¼šå›¢é˜Ÿæˆå‘˜éµå¾ªç›¸åŒçš„æµ‹è¯•è§„èŒƒ
- ğŸ”„ **æŒç»­é›†æˆ**ï¼šè‡ªåŠ¨åŒ–æµ‹è¯•å‡å°‘äººå·¥éªŒè¯å·¥ä½œ
- ğŸ“Š **è´¨é‡åº¦é‡**ï¼šé€šè¿‡æµ‹è¯•è¦†ç›–ç‡ç­‰æŒ‡æ ‡é‡åŒ–ä»£ç è´¨é‡

**å¯¹ç”Ÿäº§ç¯å¢ƒ**ï¼š
- ğŸ›¡ï¸ **é™ä½é£é™©**ï¼šå‡å°‘å› ä»£ç é—®é¢˜å¯¼è‡´çš„ç”Ÿäº§æ•…éšœ
- ğŸ“ˆ **æé«˜æ•ˆç‡**ï¼šè‡ªåŠ¨åŒ–æµ‹è¯•æ¯”æ‰‹å·¥æµ‹è¯•æ›´å¿«æ›´å‡†ç¡®
- ğŸ”„ **æ”¯æŒå¿«é€Ÿè¿­ä»£**ï¼šå¯é çš„æµ‹è¯•æ”¯æ’‘é¢‘ç¹çš„ä»£ç æ›´æ–°

### 6.4 å­¦ä¹ å»ºè®®


**å­¦ä¹ è·¯å¾„**ï¼š
1. **åŸºç¡€è¯­æ³•æµ‹è¯•** â†’ æŒæ¡ansible-lintä½¿ç”¨
2. **Moleculeå…¥é—¨** â†’ å­¦ä¼šåˆ›å»ºç®€å•æµ‹è¯•  
3. **ç¼–å†™éªŒè¯è„šæœ¬** â†’ ç†Ÿç»ƒä½¿ç”¨testinfra
4. **å¤šå¹³å°æµ‹è¯•** â†’ å¤„ç†è·¨ç³»ç»Ÿå…¼å®¹é—®é¢˜
5. **CI/CDé›†æˆ** â†’ æ„å»ºè‡ªåŠ¨åŒ–æµ‹è¯•æµç¨‹

**å®è·µå»ºè®®**ï¼š
- ğŸš€ **ä»ç®€å•å¼€å§‹**ï¼šå…ˆä¸ºç°æœ‰è§’è‰²æ·»åŠ åŸºç¡€æµ‹è¯•
- ğŸ”„ **æŒç»­æ”¹è¿›**ï¼šæ ¹æ®å®é™…ä½¿ç”¨æƒ…å†µå®Œå–„æµ‹è¯•ç”¨ä¾‹
- ğŸ“š **å­¦ä¹ æœ€ä½³å®è·µ**ï¼šå‚è€ƒå¼€æºé¡¹ç›®çš„æµ‹è¯•æ–¹æ³•
- ğŸ¤ **å›¢é˜Ÿæ¨å¹¿**ï¼šåœ¨å›¢é˜Ÿä¸­å»ºç«‹æµ‹è¯•æ–‡åŒ–

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- æµ‹è¯•æ˜¯ä¿è¯è§’è‰²è´¨é‡çš„é‡è¦æ‰‹æ®µï¼Œä¸æ˜¯å¯æœ‰å¯æ— çš„
- Moleculeæä¾›å®Œæ•´çš„æµ‹è¯•ç”Ÿå‘½å‘¨æœŸç®¡ç†
- å¹‚ç­‰æ€§æ˜¯Ansibleè§’è‰²çš„æ ¸å¿ƒç‰¹æ€§ï¼Œå¿…é¡»é€šè¿‡æµ‹è¯•éªŒè¯
- å¤šå¹³å°æµ‹è¯•ç¡®ä¿è§’è‰²çš„é€šç”¨æ€§å’Œå¯ç§»æ¤æ€§
- CI/CDé›†æˆè®©æµ‹è¯•æˆä¸ºå¼€å‘æµç¨‹çš„è‡ªç„¶ç»„æˆéƒ¨åˆ†