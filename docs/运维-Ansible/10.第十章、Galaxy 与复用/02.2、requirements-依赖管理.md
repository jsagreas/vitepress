---
title: 2ã€requirements-ä¾èµ–ç®¡ç†
---
## ðŸ“š ç›®å½•

1. [ä¾èµ–ç®¡ç†åŸºç¡€æ¦‚å¿µ](#1-ä¾èµ–ç®¡ç†åŸºç¡€æ¦‚å¿µ)
2. [requirements.ymlæ–‡ä»¶è¯¦è§£](#2-requirementsymlæ–‡ä»¶è¯¦è§£)
3. [ä¾èµ–å£°æ˜Žä¸Žç‰ˆæœ¬æŽ§åˆ¶](#3-ä¾èµ–å£°æ˜Žä¸Žç‰ˆæœ¬æŽ§åˆ¶)
4. [è§’è‰²ä¸ŽCollectionå®‰è£…ç®¡ç†](#4-è§’è‰²ä¸Žcollectionå®‰è£…ç®¡ç†)
5. [ä¼ä¸šçº§ä¾èµ–ç®¡ç†å®žè·µ](#5-ä¼ä¸šçº§ä¾èµ–ç®¡ç†å®žè·µ)
6. [çŽ¯å¢ƒéš”ç¦»ä¸Žç¦»çº¿éƒ¨ç½²](#6-çŽ¯å¢ƒéš”ç¦»ä¸Žç¦»çº¿éƒ¨ç½²)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ðŸŽ¯ ä¾èµ–ç®¡ç†åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Ansibleä¾èµ–ç®¡ç†


**ç®€å•ç†è§£**ï¼šå°±åƒæ‰‹æœºåº”ç”¨å•†åº—ä¸€æ ·ï¼ŒAnsibleæœ‰è‡ªå·±çš„"åº”ç”¨å•†åº—"å«Galaxyï¼Œé‡Œé¢æœ‰å„ç§çŽ°æˆçš„è§’è‰²å’Œé›†åˆï¼Œæˆ‘ä»¬å¯ä»¥ç›´æŽ¥ä¸‹è½½ä½¿ç”¨ã€‚

```
çŽ°å®žç±»æ¯”ï¼š
æ‰‹æœºåº”ç”¨å•†åº— â†’ Ansible Galaxy
å®‰è£…å¾®ä¿¡ã€QQ â†’ å®‰è£…è§’è‰²ã€Collection  
åº”ç”¨æ›´æ–° â†’ ä¾èµ–æ›´æ–°
åº”ç”¨åˆ—è¡¨ â†’ requirements.ymlæ–‡ä»¶
```

**æ ¸å¿ƒä½œç”¨**ï¼š
- **é¿å…é‡å¤é€ è½®å­**ï¼šåˆ«äººå†™å¥½çš„åŠŸèƒ½ç›´æŽ¥æ‹¿æ¥ç”¨
- **æ ‡å‡†åŒ–ç®¡ç†**ï¼šç»Ÿä¸€ç®¡ç†é¡¹ç›®ä¸­ç”¨åˆ°çš„æ‰€æœ‰å¤–éƒ¨ç»„ä»¶
- **ç‰ˆæœ¬æŽ§åˆ¶**ï¼šç¡®ä¿å›¢é˜Ÿä½¿ç”¨ç›¸åŒç‰ˆæœ¬çš„ä¾èµ–
- **è‡ªåŠ¨åŒ–å®‰è£…**ï¼šä¸€é”®å®‰è£…é¡¹ç›®æ‰€éœ€çš„æ‰€æœ‰ä¾èµ–

### 1.2 ä¾èµ–ç®¡ç†çš„ä¸¤ä¸ªå±‚é¢


**ðŸ“¦ è§’è‰²ä¾èµ–ï¼ˆRolesï¼‰**
```
ä½œç”¨ï¼šé¢„åˆ¶çš„ä»»åŠ¡é›†åˆ
ä¾‹å­ï¼šå®‰è£…Nginxçš„è§’è‰²ã€é…ç½®MySQLçš„è§’è‰²
ç‰¹ç‚¹ï¼šåŠŸèƒ½ç›¸å¯¹å•ä¸€ï¼Œä¸“æ³¨ç‰¹å®šä»»åŠ¡
```

**ðŸ“š é›†åˆä¾èµ–ï¼ˆCollectionsï¼‰**
```
ä½œç”¨ï¼šå¤šä¸ªè§’è‰²å’Œæ¨¡å—çš„æ‰“åŒ…é›†åˆ
ä¾‹å­ï¼šAWSæ“ä½œé›†åˆã€Kubernetesç®¡ç†é›†åˆ
ç‰¹ç‚¹ï¼šåŠŸèƒ½ä¸°å¯Œï¼Œæä¾›å®Œæ•´è§£å†³æ–¹æ¡ˆ
```

### 1.3 ä¸ºä»€ä¹ˆéœ€è¦requirements.yml


**é—®é¢˜åœºæ™¯**ï¼š
```
å›¢é˜Ÿåä½œé—®é¢˜ï¼š
å¼ ä¸‰ï¼šæˆ‘ç”¨çš„æ˜¯nginxè§’è‰²v1.5ï¼Œä¸€åˆ‡æ­£å¸¸
æŽå››ï¼šæˆ‘ç”¨çš„æ˜¯nginxè§’è‰²v2.0ï¼Œé…ç½®ä¸å…¼å®¹
çŽ‹äº”ï¼šæˆ‘æ‰¾ä¸åˆ°ä½ ä»¬ç”¨çš„è§’è‰²åœ¨å“ªé‡Œ

è§£å†³æ–¹æ¡ˆï¼š
ç”¨requirements.ymlç»Ÿä¸€å£°æ˜Žï¼š
- ç”¨ä»€ä¹ˆè§’è‰²/é›†åˆ
- ç”¨å“ªä¸ªç‰ˆæœ¬
- ä»Žå“ªé‡ŒèŽ·å–
```

---

## 2. ðŸ“‹ requirements.ymlæ–‡ä»¶è¯¦è§£


### 2.1 æ–‡ä»¶åŸºæœ¬ç»“æž„


**æ ¸å¿ƒç†è§£**ï¼šrequirements.ymlå°±æ˜¯ä¸€ä¸ª"è´­ç‰©æ¸…å•"ï¼Œåˆ—å‡ºé¡¹ç›®éœ€è¦å“ªäº›å¤–éƒ¨ç»„ä»¶ã€‚

```yaml
# requirements.yml - é¡¹ç›®ä¾èµ–æ¸…å•
---
# è§’è‰²ä¾èµ–åˆ—è¡¨
roles:
  - name: geerlingguy.nginx      # è§’è‰²åç§°
    version: "2.8.0"             # æŒ‡å®šç‰ˆæœ¬
  - src: https://github.com/user/my-role.git  # ä»ŽGitä»“åº“å®‰è£…
    name: custom-role            # æœ¬åœ°å¼•ç”¨å
    version: main               # Gitåˆ†æ”¯/æ ‡ç­¾

# é›†åˆä¾èµ–åˆ—è¡¨  
collections:
  - name: community.general      # é›†åˆåç§°
    version: ">=3.0.0,<4.0.0"   # ç‰ˆæœ¬èŒƒå›´
  - name: ansible.posix
    version: "1.4.0"
```

### 2.2 è§’è‰²ä¾èµ–é…ç½®è¯¦è§£


**ðŸ”§ åŸºç¡€è§’è‰²å£°æ˜Ž**
```yaml
roles:
  # æœ€ç®€å•çš„æ–¹å¼ - ä»ŽGalaxyå®‰è£…æœ€æ–°ç‰ˆæœ¬
  - geerlingguy.mysql
  
  # æŒ‡å®šå…·ä½“ç‰ˆæœ¬
  - name: geerlingguy.nginx
    version: "2.8.0"
    
  # ä»ŽGitHubå®‰è£…
  - src: https://github.com/elastic/ansible-elasticsearch.git
    name: elasticsearch
    version: "v7.10.0"
```

**ðŸŽ¯ é«˜çº§é…ç½®é€‰é¡¹**
```yaml
roles:
  # å®Œæ•´é…ç½®ç¤ºä¾‹
  - name: custom-web-server           # æœ¬åœ°å¼•ç”¨å
    src: git+https://gitlab.company.com/infra/web-role.git
    version: "v2.1.0"                 # Gitæ ‡ç­¾
    scm: git                          # ç‰ˆæœ¬æŽ§åˆ¶ç³»ç»Ÿ
    
  # ä»ŽtaråŒ…å®‰è£…
  - src: https://releases.company.com/roles/database-role.tar.gz
    name: database-role
    
  # ä»Žæœ¬åœ°è·¯å¾„å®‰è£…ï¼ˆå¼€å‘çŽ¯å¢ƒï¼‰
  - src: ../shared-roles/monitoring
    name: monitoring-role
```

### 2.3 é›†åˆä¾èµ–é…ç½®


**ðŸ“š åŸºç¡€é›†åˆé…ç½®**
```yaml
collections:
  # åŸºç¡€è¯­æ³•
  - community.general
  - ansible.posix
  
  # æŒ‡å®šç‰ˆæœ¬
  - name: community.docker
    version: "2.7.0"
    
  # ç‰ˆæœ¬èŒƒå›´çº¦æŸ
  - name: kubernetes.core
    version: ">=2.3.0,<3.0.0"    # å¤§äºŽç­‰äºŽ2.3.0ï¼Œå°äºŽ3.0.0
```

**ðŸ”’ ç‰ˆæœ¬çº¦æŸè¯­æ³•**
```yaml
collections:
  - name: community.general
    version: "5.5.0"              # ç²¾ç¡®ç‰ˆæœ¬
    
  - name: ansible.posix  
    version: ">=1.4.0"            # å¤§äºŽç­‰äºŽ1.4.0
    
  - name: community.crypto
    version: ">=2.0.0,<3.0.0"     # ç‰ˆæœ¬èŒƒå›´
    
  - name: community.mysql
    version: "~=3.2.0"            # å…¼å®¹ç‰ˆæœ¬ï¼ˆ3.2.xï¼‰
```

---

## 3. ðŸŽ¨ ä¾èµ–å£°æ˜Žä¸Žç‰ˆæœ¬æŽ§åˆ¶


### 3.1 ç‰ˆæœ¬çº¦æŸç­–ç•¥


**ðŸ’¡ ç†è§£ç‰ˆæœ¬çº¦æŸçš„é‡è¦æ€§**

```
ç”Ÿäº§çŽ¯å¢ƒåœºæ™¯ï¼š
æƒ…å†µ1ï¼šä¸é”å®šç‰ˆæœ¬ â†’ å¯èƒ½èŽ·å¾—æœ€æ–°åŠŸèƒ½ï¼Œä½†æœ‰å…¼å®¹æ€§é£Žé™©
æƒ…å†µ2ï¼šé”å®šç²¾ç¡®ç‰ˆæœ¬ â†’ ç¨³å®šå¯é ï¼Œä½†é”™è¿‡å®‰å…¨æ›´æ–°
æƒ…å†µ3ï¼šæ™ºèƒ½èŒƒå›´çº¦æŸ â†’ å¹³è¡¡ç¨³å®šæ€§å’Œæ›´æ–°

æœ€ä½³å®žè·µï¼šæ ¹æ®çŽ¯å¢ƒé‡‡ç”¨ä¸åŒç­–ç•¥
```

**ðŸŽ¯ ç‰ˆæœ¬çº¦æŸå®žç”¨æŒ‡å—**

| çº¦æŸç±»åž‹ | è¯­æ³•ç¤ºä¾‹ | é€‚ç”¨åœºæ™¯ | ç‰¹ç‚¹è¯´æ˜Ž |
|---------|---------|---------|---------|
| **ç²¾ç¡®ç‰ˆæœ¬** | `version: "2.8.0"` | `ç”Ÿäº§çŽ¯å¢ƒ` | `å®Œå…¨å¯é¢„æœŸï¼Œæœ€ç¨³å®š` |
| **æœ€å°ç‰ˆæœ¬** | `version: ">=2.5.0"` | `å¼€å‘çŽ¯å¢ƒ` | `ä¿è¯åŠŸèƒ½å¯ç”¨ï¼ŒèŽ·å¾—æ›´æ–°` |
| **èŒƒå›´çº¦æŸ** | `version: ">=2.5.0,<3.0.0"` | `æµ‹è¯•çŽ¯å¢ƒ` | `å¹³è¡¡ç¨³å®šæ€§å’ŒåŠŸèƒ½` |
| **å…¼å®¹ç‰ˆæœ¬** | `version: "~=2.8.0"` | `é¢„å‘å¸ƒçŽ¯å¢ƒ` | `å…è®¸å°ç‰ˆæœ¬æ›´æ–°` |
| **æŽ’é™¤ç‰ˆæœ¬** | `version: "!=2.7.5"` | `ç‰¹æ®Šæƒ…å†µ` | `é¿å¼€å·²çŸ¥é—®é¢˜ç‰ˆæœ¬` |

### 3.2 æ¥æºæŒ‡å®šè¯¦è§£


**ðŸ“ å¤šç§ä¾èµ–æ¥æº**

```yaml
roles:
  # Galaxyå®˜æ–¹ä»“åº“ï¼ˆé»˜è®¤ï¼‰
  - geerlingguy.nginx
  
  # GitHubå…¬å¼€ä»“åº“
  - src: https://github.com/user/role-name.git
    name: role-name
    
  # ä¼ä¸šç§æœ‰Gitä»“åº“
  - src: git+ssh://git@gitlab.company.com:infra/web-role.git
    name: web-role
    version: production
    
  # HTTP/HTTPSåŽ‹ç¼©åŒ…
  - src: https://files.company.com/ansible/roles/db-role.tar.gz
    name: db-role
    
  # æœ¬åœ°æ–‡ä»¶è·¯å¾„
  - src: /shared/roles/common-tasks
    name: common-tasks
```

**ðŸ” ç§æœ‰ä»“åº“è®¤è¯é…ç½®**

```bash
# SSHå¯†é’¥é…ç½®ï¼ˆæŽ¨èï¼‰
ssh-add ~/.ssh/company_deploy_key

# æˆ–åœ¨~/.ssh/configä¸­é…ç½®
Host gitlab.company.com
    HostName gitlab.company.com
    User git
    IdentityFile ~/.ssh/company_deploy_key
```

### 3.3 ä¾èµ–é”å®šæœºåˆ¶


**ðŸ”’ é”å®šæ–‡ä»¶æ¦‚å¿µ**

```yaml
# requirements-lock.ymlï¼ˆæ‰‹åŠ¨ç»´æŠ¤ï¼‰
---
roles:
  - name: geerlingguy.nginx
    version: "2.8.0"
    src: https://galaxy.ansible.com/api/v1/roles/geerlingguy.nginx/
    checksum: sha256:abc123def456...
    
collections:
  - name: community.general
    version: "5.5.0" 
    installed_at: "2024-09-19T10:30:00Z"
```

**ðŸ’¡ ç‰ˆæœ¬é”å®šæœ€ä½³å®žè·µ**
```
å¼€å‘é˜¶æ®µï¼šä½¿ç”¨èŒƒå›´çº¦æŸï¼Œå¿«é€Ÿè¿­ä»£
æµ‹è¯•é˜¶æ®µï¼šé”å®šå…·ä½“ç‰ˆæœ¬ï¼Œç¡®ä¿æµ‹è¯•ä¸€è‡´æ€§
ç”Ÿäº§é˜¶æ®µï¼šä¸¥æ ¼é”å®šç‰ˆæœ¬ï¼Œå˜æ›´éœ€è¦å®¡æ‰¹æµç¨‹
```

---

## 4. ðŸš€ è§’è‰²ä¸ŽCollectionå®‰è£…ç®¡ç†


### 4.1 åŸºç¡€å®‰è£…å‘½ä»¤


**ðŸ“¦ ä¸€é”®å®‰è£…æ‰€æœ‰ä¾èµ–**

```bash
# å®‰è£…requirements.ymlä¸­çš„æ‰€æœ‰ä¾èµ–
ansible-galaxy install -r requirements.yml

# å¼ºåˆ¶é‡æ–°å®‰è£…ï¼ˆè¦†ç›–çŽ°æœ‰ç‰ˆæœ¬ï¼‰
ansible-galaxy install -r requirements.yml --force

# å®‰è£…åˆ°æŒ‡å®šç›®å½•
ansible-galaxy install -r requirements.yml -p ./roles/
```

**ðŸ”§ å•ç‹¬ç®¡ç†è§’è‰²å’Œé›†åˆ**

```bash
# åªå®‰è£…è§’è‰²
ansible-galaxy role install -r requirements.yml

# åªå®‰è£…é›†åˆ  
ansible-galaxy collection install -r requirements.yml

# æŸ¥çœ‹å·²å®‰è£…çš„è§’è‰²
ansible-galaxy list

# æŸ¥çœ‹å·²å®‰è£…çš„é›†åˆ
ansible-galaxy collection list
```

### 4.2 æ‰¹é‡å®‰è£…ä¸Žæ›´æ–°


**âš¡ æ‰¹é‡æ“ä½œå®žç”¨æŠ€å·§**

```bash
# æ‰¹é‡æ›´æ–°æ‰€æœ‰ä¾èµ–åˆ°æœ€æ–°ç‰ˆæœ¬
ansible-galaxy install -r requirements.yml --force

# æ£€æŸ¥å“ªäº›ä¾èµ–æœ‰æ›´æ–°
ansible-galaxy collection list --format=json | jq '.collections'

# å®‰è£…æ—¶æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
ansible-galaxy install -r requirements.yml -v
```

**ðŸ“Š å®‰è£…çŠ¶æ€è·Ÿè¸ª**

```bash
#!/bin/bash
# install-dependencies.sh - æ™ºèƒ½å®‰è£…è„šæœ¬

echo "ðŸ“¦ å¼€å§‹å®‰è£…Ansibleä¾èµ–..."

# æ£€æŸ¥requirements.ymlæ˜¯å¦å­˜åœ¨
if [ ! -f "requirements.yml" ]; then
    echo "âŒ requirements.ymlæ–‡ä»¶ä¸å­˜åœ¨"
    exit 1
fi

# åˆ›å»ºå®‰è£…æ—¥å¿—
LOG_FILE="install_$(date +%Y%m%d_%H%M%S).log"

# å®‰è£…ä¾èµ–å¹¶è®°å½•æ—¥å¿—
ansible-galaxy install -r requirements.yml --force 2>&1 | tee $LOG_FILE

# éªŒè¯å®‰è£…ç»“æžœ
echo "âœ… ä¾èµ–å®‰è£…å®Œæˆï¼Œè¯¦ç»†æ—¥å¿—ï¼š$LOG_FILE"
ansible-galaxy list
```

### 4.3 ä¾èµ–æ›´æ–°ç®¡ç†


**ðŸ”„ å®‰å…¨çš„æ›´æ–°æµç¨‹**

```
æ›´æ–°å‰æ£€æŸ¥ï¼š
1. å¤‡ä»½å½“å‰çŽ¯å¢ƒ
2. æŸ¥çœ‹æ›´æ–°æ—¥å¿—ï¼ˆCHANGELOGï¼‰
3. åœ¨æµ‹è¯•çŽ¯å¢ƒéªŒè¯
4. ç”Ÿäº§çŽ¯å¢ƒåˆ†æ‰¹æ›´æ–°
```

**æ›´æ–°ç­–ç•¥è„šæœ¬**
```bash
# åˆ›å»ºæ›´æ–°å‰çš„å¿«ç…§
create_snapshot() {
    echo "ðŸ“¸ åˆ›å»ºä¾èµ–å¿«ç…§..."
    ansible-galaxy list > snapshot_$(date +%Y%m%d).txt
    cp requirements.yml requirements_backup_$(date +%Y%m%d).yml
}

# å®‰å…¨æ›´æ–°å‡½æ•°
safe_update() {
    create_snapshot
    
    echo "ðŸ”„ å¼€å§‹æ›´æ–°ä¾èµ–..."
    ansible-galaxy install -r requirements.yml --force
    
    echo "âœ… æ›´æ–°å®Œæˆï¼Œè¯·è¿è¡Œæµ‹è¯•éªŒè¯"
}
```

---

## 5. ðŸ¢ ä¼ä¸šçº§ä¾èµ–ç®¡ç†å®žè·µ


### 5.1 ä¼ä¸šä»“åº“é…ç½®


**ðŸ”§ ç§æœ‰Galaxyé…ç½®**

```ini
# ~/.ansible/galaxy_token
# æˆ–é€šè¿‡çŽ¯å¢ƒå˜é‡è®¾ç½®
export ANSIBLE_GALAXY_SERVER_URL=https://galaxy.company.com/api/
export ANSIBLE_GALAXY_TOKEN=your_private_token_here
```

**ðŸ“ ä¼ä¸šçº§ç›®å½•ç»“æž„**
```
project/
â”œâ”€â”€ requirements/
â”‚   â”œâ”€â”€ common.yml          # é€šç”¨ä¾èµ–
â”‚   â”œâ”€â”€ development.yml     # å¼€å‘çŽ¯å¢ƒç‰¹æœ‰ä¾èµ–  
â”‚   â”œâ”€â”€ production.yml      # ç”Ÿäº§çŽ¯å¢ƒä¾èµ–
â”‚   â””â”€â”€ testing.yml         # æµ‹è¯•çŽ¯å¢ƒä¾èµ–
â”œâ”€â”€ ansible.cfg             # é¡¹ç›®é…ç½®
â””â”€â”€ inventory/
    â”œâ”€â”€ dev/
    â”œâ”€â”€ test/
    â””â”€â”€ prod/
```

### 5.2 å¤šçŽ¯å¢ƒä¾èµ–ç®¡ç†


**ðŸŽ¯ çŽ¯å¢ƒéš”ç¦»ç­–ç•¥**

```yaml
# requirements/common.yml - é€šç”¨ä¾èµ–
---
collections:
  - name: community.general
    version: "5.5.0"
  - name: ansible.posix
    version: "1.4.0"

roles:
  - name: geerlingguy.common
    version: "1.9.0"
```

```yaml
# requirements/production.yml - ç”Ÿäº§çŽ¯å¢ƒ
---
# å¼•å…¥é€šç”¨ä¾èµ–
- include: common.yml

# ç”Ÿäº§çŽ¯å¢ƒç‰¹æœ‰ä¾èµ–
collections:
  - name: community.crypto
    version: "2.14.0"        # é”å®šç¨³å®šç‰ˆæœ¬
    
roles:
  - name: security.hardening
    version: "3.1.0"         # å®‰å…¨åŠ å›ºè§’è‰²
```

**ðŸ”€ æ¡ä»¶æ€§ä¾èµ–å®‰è£…**

```bash
#!/bin/bash
# install_by_env.sh - æŒ‰çŽ¯å¢ƒå®‰è£…ä¾èµ–

ENVIRONMENT=${1:-development}

echo "ðŸŽ¯ ä¸º $ENVIRONMENT çŽ¯å¢ƒå®‰è£…ä¾èµ–"

# æ ¹æ®çŽ¯å¢ƒé€‰æ‹©requirementsæ–‡ä»¶
case $ENVIRONMENT in
    "production")
        REQ_FILE="requirements/production.yml"
        ;;
    "testing") 
        REQ_FILE="requirements/testing.yml"
        ;;
    *)
        REQ_FILE="requirements/development.yml"
        ;;
esac

if [ -f "$REQ_FILE" ]; then
    ansible-galaxy install -r "$REQ_FILE"
else
    echo "âŒ æœªæ‰¾åˆ°çŽ¯å¢ƒé…ç½®æ–‡ä»¶ï¼š$REQ_FILE"
    exit 1
fi
```

### 5.3 ä¼ä¸šä»“åº“æœ€ä½³å®žè·µ


**ðŸ—ï¸ å†…éƒ¨è§’è‰²è§„èŒƒ**

```yaml
# ä¼ä¸šå†…éƒ¨è§’è‰²å‘½åè§„èŒƒ
roles:
  # ä½¿ç”¨å…¬å¸å‰ç¼€
  - company.web-server        # å…¬å¸æ ‡å‡†WebæœåŠ¡å™¨é…ç½®
  - company.database         # å…¬å¸æ ‡å‡†æ•°æ®åº“é…ç½®  
  - company.monitoring       # å…¬å¸ç›‘æŽ§æ ‡å‡†
  - company.security         # å…¬å¸å®‰å…¨åŸºçº¿
  
  # ç‰ˆæœ¬è§„èŒƒï¼šä¸»ç‰ˆæœ¬.æ¬¡ç‰ˆæœ¬.ä¿®è®¢ç‰ˆæœ¬
  - name: company.web-server
    version: "2.1.3"
    
  # æ¥æºè§„èŒƒï¼šç»Ÿä¸€ä»Žä¼ä¸šä»“åº“èŽ·å–
  - src: https://galaxy.company.com/company/web-server
    name: company.web-server
```

---

## 6. ðŸ”’ çŽ¯å¢ƒéš”ç¦»ä¸Žç¦»çº¿éƒ¨ç½²


### 6.1 çŽ¯å¢ƒéš”ç¦»å®žçŽ°


**ðŸ“¦ è™šæ‹ŸçŽ¯å¢ƒéš”ç¦»**

```bash
# åˆ›å»ºé¡¹ç›®ä¸“ç”¨çŽ¯å¢ƒ
python3 -m venv ansible-env
source ansible-env/bin/activate

# å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„Ansible
pip install ansible==6.5.0

# è®¾ç½®è§’è‰²å’Œé›†åˆçš„ç‹¬ç«‹å­˜å‚¨è·¯å¾„
export ANSIBLE_ROLES_PATH=./project-roles
export ANSIBLE_COLLECTIONS_PATH=./project-collections

# å®‰è£…é¡¹ç›®ä¾èµ–
ansible-galaxy install -r requirements.yml
```

**ðŸ—‚ï¸ é¡¹ç›®éš”ç¦»ç›®å½•ç»“æž„**
```
project-ansible/
â”œâ”€â”€ venv/                   # Pythonè™šæ‹ŸçŽ¯å¢ƒ
â”œâ”€â”€ collections/            # é¡¹ç›®é›†åˆå­˜å‚¨
â”œâ”€â”€ roles/                  # é¡¹ç›®è§’è‰²å­˜å‚¨
â”œâ”€â”€ requirements.yml        # ä¾èµ–å£°æ˜Ž
â”œâ”€â”€ ansible.cfg            # é¡¹ç›®é…ç½®
â””â”€â”€ activate.sh            # çŽ¯å¢ƒæ¿€æ´»è„šæœ¬
```

```bash
# activate.sh - çŽ¯å¢ƒæ¿€æ´»è„šæœ¬
#!/bin/bash
echo "ðŸš€ æ¿€æ´»Ansibleé¡¹ç›®çŽ¯å¢ƒ..."

# æ¿€æ´»Pythonè™šæ‹ŸçŽ¯å¢ƒ
source venv/bin/activate

# è®¾ç½®Ansibleè·¯å¾„
export ANSIBLE_ROLES_PATH="$(pwd)/roles"
export ANSIBLE_COLLECTIONS_PATH="$(pwd)/collections" 
export ANSIBLE_CONFIG="$(pwd)/ansible.cfg"

echo "âœ… çŽ¯å¢ƒå·²æ¿€æ´»"
echo "è§’è‰²è·¯å¾„ï¼š$ANSIBLE_ROLES_PATH"
echo "é›†åˆè·¯å¾„ï¼š$ANSIBLE_COLLECTIONS_PATH"
```

### 6.2 ç¦»çº¿å®‰è£…å®žè·µ


**ðŸ“¥ ä¾èµ–æ‰“åŒ…ä¸Žåˆ†å‘**

```bash
# 1. åœ¨è”ç½‘çŽ¯å¢ƒä¸‹è½½æ‰€æœ‰ä¾èµ–
mkdir ansible-offline-bundle
cd ansible-offline-bundle

# ä¸‹è½½ä¾èµ–åˆ°æœ¬åœ°
ansible-galaxy install -r ../requirements.yml -p ./roles/
ansible-galaxy collection download -r ../requirements.yml -p ./collections/

# 2. åˆ›å»ºç¦»çº¿å®‰è£…åŒ…
tar -czf ansible-deps-$(date +%Y%m%d).tar.gz roles/ collections/
```

**ðŸ”§ ç¦»çº¿çŽ¯å¢ƒå®‰è£…**

```bash
# åœ¨ç¦»çº¿çŽ¯å¢ƒè§£åŽ‹å¹¶å®‰è£…
tar -xzf ansible-deps-20240919.tar.gz

# å®‰è£…è§’è‰²
ansible-galaxy install -p /opt/ansible/roles roles/*.tar.gz

# å®‰è£…é›†åˆ
ansible-galaxy collection install collections/*.tar.gz -p /opt/ansible/collections

# é…ç½®ansible.cfg
cat >> /etc/ansible/ansible.cfg << EOF
[defaults]
roles_path = /opt/ansible/roles
collections_path = /opt/ansible/collections
EOF
```

### 6.3 ç¦»çº¿éƒ¨ç½²è‡ªåŠ¨åŒ–


**ðŸ¤– ç¦»çº¿éƒ¨ç½²è„šæœ¬**

```bash
#!/bin/bash
# offline-deploy.sh - ç¦»çº¿çŽ¯å¢ƒè‡ªåŠ¨éƒ¨ç½²

BUNDLE_FILE="$1"
INSTALL_DIR="${2:-/opt/ansible}"

if [ -z "$BUNDLE_FILE" ]; then
    echo "âŒ ä½¿ç”¨æ–¹æ³•: $0 <bundle_file> [install_dir]"
    exit 1
fi

echo "ðŸ“¦ å¼€å§‹ç¦»çº¿éƒ¨ç½²Ansibleä¾èµ–..."

# åˆ›å»ºå®‰è£…ç›®å½•
sudo mkdir -p "$INSTALL_DIR/roles" "$INSTALL_DIR/collections"

# è§£åŽ‹ä¾èµ–åŒ…
TEMP_DIR=$(mktemp -d)
tar -xzf "$BUNDLE_FILE" -C "$TEMP_DIR"

# å®‰è£…è§’è‰²
if [ -d "$TEMP_DIR/roles" ]; then
    echo "ðŸŽ­ å®‰è£…è§’è‰²..."
    sudo cp -r "$TEMP_DIR/roles/"* "$INSTALL_DIR/roles/"
fi

# å®‰è£…é›†åˆ
if [ -d "$TEMP_DIR/collections" ]; then
    echo "ðŸ“š å®‰è£…é›†åˆ..."
    for collection in "$TEMP_DIR/collections/"*.tar.gz; do
        ansible-galaxy collection install "$collection" -p "$INSTALL_DIR/collections/"
    done
fi

# æ›´æ–°é…ç½®
echo "âš™ï¸ æ›´æ–°é…ç½®..."
sudo tee /etc/ansible/ansible.cfg > /dev/null << EOF
[defaults]
roles_path = $INSTALL_DIR/roles
collections_path = $INSTALL_DIR/collections
EOF

echo "âœ… ç¦»çº¿éƒ¨ç½²å®Œæˆï¼"
echo "è§’è‰²å®‰è£…ä½ç½®ï¼š$INSTALL_DIR/roles"
echo "é›†åˆå®‰è£…ä½ç½®ï¼š$INSTALL_DIR/collections"

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
rm -rf "$TEMP_DIR"
```

---

## 7. ðŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŽŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```yaml
ðŸ”¸ requirements.ymlï¼šé¡¹ç›®ä¾èµ–çš„"è´­ç‰©æ¸…å•"
ðŸ”¸ è§’è‰²vsé›†åˆï¼šå•ä¸€åŠŸèƒ½ vs å®Œæ•´è§£å†³æ–¹æ¡ˆ
ðŸ”¸ ç‰ˆæœ¬çº¦æŸï¼šç²¾ç¡®ç‰ˆæœ¬ã€èŒƒå›´çº¦æŸã€å…¼å®¹ç‰ˆæœ¬
ðŸ”¸ æ¥æºæŒ‡å®šï¼šGalaxyã€Gitä»“åº“ã€æœ¬åœ°è·¯å¾„ã€åŽ‹ç¼©åŒ…
ðŸ”¸ çŽ¯å¢ƒéš”ç¦»ï¼šä¸åŒçŽ¯å¢ƒä½¿ç”¨ä¸åŒä¾èµ–ç‰ˆæœ¬
ðŸ”¸ ç¦»çº¿éƒ¨ç½²ï¼šæ— ç½‘ç»œçŽ¯å¢ƒä¸‹çš„ä¾èµ–ç®¡ç†
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ðŸ”¹ ä¾èµ–ç®¡ç†çš„æœ¬è´¨**
```
ç›®æ ‡ï¼šè®©å›¢é˜Ÿä½¿ç”¨ç»Ÿä¸€çš„å¤–éƒ¨ç»„ä»¶
æ‰‹æ®µï¼šé€šè¿‡requirements.ymlå£°æ˜Žå¼ç®¡ç†
æ•ˆæžœï¼šé¿å…çŽ¯å¢ƒå·®å¼‚ï¼Œæé«˜åä½œæ•ˆçŽ‡
```

**ðŸ”¹ ç‰ˆæœ¬æŽ§åˆ¶ç­–ç•¥**
```
å¼€å‘çŽ¯å¢ƒï¼šå…è®¸è¾ƒæ–°ç‰ˆæœ¬ï¼Œå¿«é€ŸèŽ·å¾—æ–°åŠŸèƒ½
æµ‹è¯•çŽ¯å¢ƒï¼šé”å®šç‰ˆæœ¬ï¼Œç¡®ä¿æµ‹è¯•ç»“æžœå¯é‡çŽ°  
ç”Ÿäº§çŽ¯å¢ƒï¼šä¸¥æ ¼é”å®šï¼Œå˜æ›´éœ€è¦å……åˆ†æµ‹è¯•
```

**ðŸ”¹ ä¼ä¸šå®žè·µé‡ç‚¹**
```
æ ‡å‡†åŒ–ï¼šç»Ÿä¸€çš„å‘½åè§„èŒƒå’Œç‰ˆæœ¬ç­–ç•¥
è‡ªåŠ¨åŒ–ï¼šè„šæœ¬åŒ–çš„å®‰è£…å’Œæ›´æ–°æµç¨‹
å®‰å…¨æ€§ï¼šç§æœ‰ä»“åº“å’Œè®¿é—®æŽ§åˆ¶
å¯é æ€§ï¼šç¦»çº¿éƒ¨ç½²å’ŒçŽ¯å¢ƒéš”ç¦»èƒ½åŠ›
```

### 7.3 å®žé™…åº”ç”¨ä»·å€¼


| åº”ç”¨åœºæ™¯ | æ ¸å¿ƒä»·å€¼ | å®žçŽ°æ–¹å¼ |
|---------|---------|---------|
| **å›¢é˜Ÿåä½œ** | `ç»Ÿä¸€ä¾èµ–ç‰ˆæœ¬` | `requirements.yml + ç‰ˆæœ¬é”å®š` |
| **çŽ¯å¢ƒç®¡ç†** | `éš”ç¦»ä¸åŒçŽ¯å¢ƒ` | `å¤šä¸ªrequirementsæ–‡ä»¶ + æ¡ä»¶å®‰è£…` |
| **ç¦»çº¿éƒ¨ç½²** | `æ— ç½‘ç»œçŽ¯å¢ƒéƒ¨ç½²` | `ä¾èµ–æ‰“åŒ… + æœ¬åœ°å®‰è£…` |
| **ä¼ä¸šæ²»ç†** | `æ ‡å‡†åŒ–ç®¡ç†` | `ç§æœ‰ä»“åº“ + å‘½åè§„èŒƒ` |

### 7.4 å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥


```bash
# ðŸ“¥ å®‰è£…ä¾èµ–
ansible-galaxy install -r requirements.yml          # å®‰è£…æ‰€æœ‰ä¾èµ–
ansible-galaxy install -r requirements.yml --force  # å¼ºåˆ¶é‡è£…

# ðŸ“‹ æŸ¥çœ‹ä¾èµ–  
ansible-galaxy list                                  # æŸ¥çœ‹å·²å®‰è£…è§’è‰²
ansible-galaxy collection list                      # æŸ¥çœ‹å·²å®‰è£…é›†åˆ

# ðŸ”„ æ›´æ–°ä¾èµ–
ansible-galaxy install -r requirements.yml --force  # æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬

# ðŸ—‘ï¸ æ¸…ç†ä¾èµ–
ansible-galaxy remove role-name                     # åˆ é™¤æŒ‡å®šè§’è‰²
```

**ðŸ’¡ è®°å¿†è¦ç‚¹**ï¼š
- requirements.ymlæ˜¯é¡¹ç›®ä¾èµ–çš„"è´­ç‰©æ¸…å•"
- ç‰ˆæœ¬çº¦æŸè¦æ ¹æ®çŽ¯å¢ƒåˆ¶å®šä¸åŒç­–ç•¥  
- ä¼ä¸šçŽ¯å¢ƒè¦è€ƒè™‘ç§æœ‰ä»“åº“å’Œæ ‡å‡†åŒ–
- ç¦»çº¿éƒ¨ç½²éœ€è¦æå‰æ‰“åŒ…æ‰€æœ‰ä¾èµ–
- çŽ¯å¢ƒéš”ç¦»é¿å…ä¸åŒé¡¹ç›®é—´çš„ä¾èµ–å†²çª