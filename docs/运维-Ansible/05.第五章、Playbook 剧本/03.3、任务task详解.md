---
title: 3、任务task详解
---
## 📚 目录

1. [任务基本概念](#1-任务基本概念)
2. [任务基本语法](#2-任务基本语法)
3. [模块调用与参数传递](#3-模块调用与参数传递)
4. [任务命名与组织](#4-任务命名与组织)
5. [任务执行控制](#5-任务执行控制)
6. [任务状态与返回值](#6-任务状态与返回值)
7. [条件任务](#7-条件任务)
8. [循环任务](#8-循环任务)
9. [任务最佳实践](#9-任务最佳实践)
10. [核心要点总结](#10-核心要点总结)

---

## 1. 🎯 任务基本概念


### 1.1 什么是任务(Task)


**任务定义**：任务是Ansible Playbook中的基本执行单元，相当于一条具体的操作指令。

**通俗理解**：
```
就像生活中的待办清单：
待办事项：
1. 安装软件包 ← 这是一个任务
2. 创建用户   ← 这是一个任务  
3. 启动服务   ← 这是一个任务

每个任务都是一个具体的操作步骤
```

### 1.2 任务的作用


**核心作用**：
- **执行操作**：调用模块完成具体工作
- **状态管理**：确保系统达到期望状态
- **结果反馈**：返回执行结果和状态信息
- **流程控制**：支持条件判断和循环执行

**任务与模块的关系**：
```
任务(Task) = 模块(Module) + 参数(Parameters) + 控制逻辑

举例：
任务："安装nginx软件包"
├── 使用模块：yum
├── 传递参数：name=nginx, state=present  
└── 控制逻辑：when条件、循环等
```

---

## 2. 📝 任务基本语法


### 2.1 最简单的任务格式


**基础语法结构**：
```yaml
- name: 任务描述名称
  模块名:
    参数1: 值1
    参数2: 值2
```

**实际示例**：
```yaml
- name: 安装nginx软件包
  yum:
    name: nginx
    state: present
```

### 2.2 任务的完整语法结构


**完整格式展示**：
```yaml
tasks:
  - name: 任务描述                    # 任务名称(可选但推荐)
    模块名:                          # 要调用的模块
      参数名1: 参数值1               # 模块参数
      参数名2: 参数值2
    when: 条件表达式                 # 执行条件(可选)
    loop: 循环列表                   # 循环控制(可选)
    register: 变量名                 # 结果保存(可选)
    tags: [标签1, 标签2]             # 任务标签(可选)
    ignore_errors: yes               # 忽略错误(可选)
```

### 2.3 语法要点说明


**YAML格式要求**：
- **缩进一致**：使用空格缩进，不能用Tab
- **列表格式**：tasks下的每个任务用 `-` 开头
- **键值对**：参数使用 `key: value` 格式
- **引号使用**：包含特殊字符时需要引号

> 💡 **新手提示**：YAML对缩进非常敏感，建议使用支持YAML语法高亮的编辑器

---

## 3. 🔧 模块调用与参数传递


### 3.1 模块调用的三种方式


#### 方式一：标准格式(推荐)

```yaml
- name: 创建目录
  file:
    path: /opt/myapp
    state: directory
    mode: '0755'
    owner: root
```

#### 方式二：单行格式

```yaml
- name: 创建目录
  file: path=/opt/myapp state=directory mode=0755
```

#### 方式三：简化格式

```yaml
- name: 执行命令
  command: ls -la /tmp
```

**选择建议**：
- **复杂参数**：使用标准格式，可读性更好
- **简单操作**：可使用单行或简化格式
- **团队协作**：统一使用标准格式

### 3.2 参数传递方法详解


**字符串参数**：
```yaml
- name: 创建用户
  user:
    name: "myuser"           # 用户名
    shell: "/bin/bash"       # 登录shell
    comment: "My App User"   # 用户描述
```

**数值参数**：
```yaml
- name: 设置文件权限
  file:
    path: /tmp/test.txt
    mode: 0644              # 八进制数值
    owner: 1000             # 用户ID
```

**布尔参数**：
```yaml
- name: 安装软件包
  yum:
    name: git
    state: present
    update_cache: yes       # 布尔值：yes/no, true/false
```

**列表参数**：
```yaml
- name: 安装多个软件包
  yum:
    name:                   # 列表格式
      - git
      - vim  
      - curl
    state: present
```

**字典参数**：
```yaml
- name: 配置防火墙规则
  firewalld:
    port: "{{ item.port }}/{{ item.proto }}"
    permanent: "{{ item.permanent }}"
    state: enabled
```

### 3.3 变量在参数中的使用


**使用变量**：
```yaml
vars:
  app_name: nginx
  app_version: "1.18"

tasks:
  - name: 安装指定版本软件
    yum:
      name: "{{ app_name }}-{{ app_version }}"  # 变量引用
      state: present
```

**变量使用注意事项**：
- 变量必须用 `{{ }}` 包围
- 字符串开头是变量时要加引号
- 可以进行简单的字符串拼接

---

## 4. 📋 任务命名与组织


### 4.1 任务命名规范


**为什么要命名**：
```
没有名称的任务：
TASK [yum] *******************
ok: [server1]

有名称的任务：  
TASK [安装nginx软件包] *********
ok: [server1]

清晰度对比一目了然！
```

**命名最佳实践**：
```yaml
# ❌ 不好的命名
- name: install
  yum: name=nginx state=present

# ✅ 好的命名  
- name: 安装nginx web服务器
  yum: name=nginx state=present

# ✅ 更好的命名(包含版本信息)
- name: 安装nginx 1.18版本用于web服务
  yum: name=nginx-1.18 state=present
```

**命名建议**：
- **描述性强**：说明具体要做什么
- **简洁明了**：不要太长但要清晰
- **动词开头**：安装、配置、启动、创建等
- **包含关键信息**：软件名称、配置项等

### 4.2 任务分组组织


**使用标签分组**：
```yaml
tasks:
  - name: 安装web服务相关软件包
    yum:
      name: "{{ item }}"
      state: present
    loop:
      - nginx
      - php
      - mysql
    tags:
      - install
      - web

  - name: 配置nginx主配置文件
    template:
      src: nginx.conf.j2
      dest: /etc/nginx/nginx.conf
    tags:
      - config
      - web
      - nginx
```

**按功能模块组织**：
```yaml
# 安装阶段任务
- name: 安装基础软件包
  yum: name={{ item }} state=present
  loop: [git, vim, curl]
  tags: install

# 配置阶段任务  
- name: 配置系统参数
  sysctl: name={{ item.key }} value={{ item.value }}
  loop: "{{ sysctl_params }}"
  tags: config

# 服务阶段任务
- name: 启动并启用服务
  service: name={{ item }} state=started enabled=yes
  loop: [nginx, mysql]
  tags: service
```

---

## 5. ⚡ 任务执行控制


### 5.1 任务执行顺序


**默认执行顺序**：
```yaml
tasks:
  - name: 第一个任务          # 1. 首先执行
    debug: msg="Step 1"
    
  - name: 第二个任务          # 2. 然后执行  
    debug: msg="Step 2"
    
  - name: 第三个任务          # 3. 最后执行
    debug: msg="Step 3"
```

**顺序执行的重要性**：
```yaml
# 正确的顺序
- name: 1. 安装软件包
  yum: name=nginx state=present

- name: 2. 配置文件  
  template: src=nginx.conf.j2 dest=/etc/nginx/nginx.conf

- name: 3. 启动服务
  service: name=nginx state=started

# 如果顺序错误，可能导致启动失败或配置丢失
```

### 5.2 错误处理控制


**默认错误处理**：
```yaml
- name: 可能失败的任务
  command: /some/command/that/might/fail
  # 默认：如果失败，整个playbook停止执行
```

**忽略错误继续执行**：
```yaml
- name: 尝试操作，失败也要继续
  command: some_command_might_fail
  ignore_errors: yes              # 忽略错误继续执行
```

**失败时执行特定操作**：
```yaml
- name: 关键操作
  service: name=nginx state=started
  register: nginx_result           # 保存执行结果

- name: 失败时的备用方案
  debug: msg="nginx启动失败，请检查配置"
  when: nginx_result.failed        # 当nginx启动失败时执行
```

### 5.3 任务执行条件


**基本条件判断**：
```yaml
- name: 仅在CentOS系统上安装
  yum: name=nginx state=present
  when: ansible_os_family == "RedHat"

- name: 仅在Ubuntu系统上安装  
  apt: name=nginx state=present
  when: ansible_os_family == "Debian"
```

**多条件判断**：
```yaml
- name: 复杂条件判断
  service: name=firewalld state=stopped
  when: 
    - ansible_os_family == "RedHat"
    - ansible_distribution_major_version >= "7"
    - firewall_enabled == false
```

---

## 6. 📊 任务状态与返回值


### 6.1 任务执行状态


**四种主要状态**：

| 状态 | 颜色显示 | 含义说明 | 触发条件 |
|------|----------|----------|----------|
| **ok** | 🟢 绿色 | 任务成功执行，没有变化 | 目标状态已存在 |
| **changed** | 🟡 黄色 | 任务成功执行，产生了变化 | 系统状态被修改 |
| **failed** | 🔴 红色 | 任务执行失败 | 命令出错或条件不满足 |
| **skipped** | 🔵 蓝色 | 任务被跳过 | when条件为false |

**状态示例演示**：
```yaml
# ok状态：文件已存在
- name: 确保目录存在
  file: path=/tmp/test state=directory
  # 如果目录已存在 → ok状态

# changed状态：创建了新文件
- name: 创建配置文件
  copy: content="test" dest=/tmp/new_file.txt
  # 如果文件不存在，创建后 → changed状态

# failed状态：权限不足
- name: 修改系统文件
  file: path=/etc/passwd mode=0777
  # 普通用户执行 → failed状态

# skipped状态：条件不满足
- name: 仅在生产环境执行
  debug: msg="生产环境任务"
  when: environment == "production"
  # 如果environment != "production" → skipped状态
```

### 6.2 register保存返回值


**基本用法**：
```yaml
- name: 检查服务状态
  command: systemctl is-active nginx
  register: nginx_status          # 保存命令执行结果

- name: 显示检查结果
  debug: 
    msg: "Nginx状态：{{ nginx_status.stdout }}"
```

**返回值结构**：
```yaml
# register变量包含的主要信息
nginx_status:
  cmd: ["systemctl", "is-active", "nginx"]    # 执行的命令
  stdout: "active"                            # 标准输出
  stderr: ""                                  # 错误输出  
  rc: 0                                       # 返回码(0表示成功)
  changed: false                              # 是否产生变化
  failed: false                               # 是否失败
```

**实际应用示例**：
```yaml
- name: 获取磁盘使用情况
  command: df -h /
  register: disk_usage

- name: 磁盘空间不足时发出警告
  debug: 
    msg: "⚠️ 根分区空间不足，请及时清理"
  when: "'9[0-9]%' in disk_usage.stdout"      # 使用量超过90%时警告
```

---

## 7. 🎛️ 条件任务


### 7.1 when条件基础


**基本语法**：
```yaml
- name: 任务名称
  模块名: 参数
  when: 条件表达式
```

**常用条件表达式**：
```yaml
# 字符串比较
when: ansible_hostname == "web01"
when: ansible_os_family == "RedHat"

# 数值比较  
when: ansible_memtotal_mb > 4000
when: ansible_processor_vcpus >= 2

# 布尔判断
when: database_enabled == true
when: debug_mode

# 变量存在性检查
when: mysql_password is defined
when: backup_dir is not defined
```

### 7.2 多条件组合


**AND条件(所有条件都要满足)**：
```yaml
- name: 高配置服务器的特殊设置
  sysctl: name=vm.swappiness value=10
  when:
    - ansible_memtotal_mb > 8000        # 内存大于8GB
    - ansible_processor_vcpus >= 4      # CPU核心数≥4
    - ansible_os_family == "RedHat"     # RedHat系统
```

**OR条件(满足任一条件即可)**：
```yaml
- name: 在开发或测试环境执行
  debug: msg="非生产环境任务"
  when: environment == "dev" or environment == "test"

# 或者使用列表形式
when: environment in ["dev", "test", "staging"]
```

### 7.3 基于执行结果的条件


**根据上一个任务的结果执行**：
```yaml
- name: 检查nginx配置文件
  command: nginx -t
  register: nginx_config_check
  ignore_errors: yes

- name: 配置文件正确时重启服务
  service: name=nginx state=restarted
  when: nginx_config_check.rc == 0        # 返回码为0表示配置正确

- name: 配置文件错误时显示错误信息
  debug: msg="Nginx配置文件有误：{{ nginx_config_check.stderr }}"
  when: nginx_config_check.rc != 0        # 返回码非0表示有错误
```

**实际应用场景**：
```yaml
- name: 检查是否需要重启
  stat: path=/var/run/reboot-required
  register: reboot_required

- name: 提示需要重启系统
  debug: 
    msg: "🔄 系统更新完成，建议重启服务器"
  when: reboot_required.stat.exists       # 文件存在表示需要重启
```

---

## 8. 🔄 循环任务


### 8.1 loop基本用法


**简单列表循环**：
```yaml
- name: 安装多个软件包
  yum:
    name: "{{ item }}"
    state: present
  loop:
    - git
    - vim
    - curl
    - wget
```

**等效的传统写法(不推荐)**：
```yaml
# 旧版本的with_items写法，现在推荐用loop
- name: 安装多个软件包
  yum:
    name: "{{ item }}"
    state: present
  with_items:
    - git
    - vim
    - curl
```

### 8.2 复杂数据结构循环


**字典列表循环**：
```yaml
- name: 创建多个用户
  user:
    name: "{{ item.name }}"
    shell: "{{ item.shell }}"
    groups: "{{ item.groups }}"
  loop:
    - name: alice
      shell: /bin/bash
      groups: wheel
    - name: bob  
      shell: /bin/zsh
      groups: users
    - name: charlie
      shell: /bin/bash
      groups: wheel,docker
```

**嵌套循环**：
```yaml
- name: 为每个用户创建多个目录
  file:
    path: "/home/{{ item.0 }}/{{ item.1 }}"
    state: directory
    owner: "{{ item.0 }}"
  loop: "{{ users | product(directories) | list }}"
  vars:
    users: [alice, bob, charlie]
    directories: [Documents, Downloads, Projects]
```

### 8.3 循环控制与优化


**循环中的条件控制**：
```yaml
- name: 为管理员用户安装sudo权限
  user:
    name: "{{ item.name }}"
    groups: wheel
  loop: "{{ all_users }}"
  when: item.role == "admin"              # 只对管理员用户操作
```

**循环标签和注册**：
```yaml
- name: 检查服务状态
  service_facts:
  loop: [nginx, mysql, redis]
  register: service_results
  loop_control:
    label: "检查 {{ item }} 服务"         # 显示友好的循环标签
```

**处理循环结果**：
```yaml
- name: 显示所有检查结果
  debug:
    msg: "服务 {{ item.item }} 状态：{{ 'running' if item.ansible_facts.services[item.item + '.service'].state == 'running' else 'stopped' }}"
  loop: "{{ service_results.results }}"
```

---

## 9. 🎯 任务最佳实践


### 9.1 任务设计原则


**幂等性原则**：
```yaml
# ✅ 好的做法：幂等性操作
- name: 确保nginx服务正在运行
  service: 
    name: nginx 
    state: started
  # 无论执行多少次，结果都一样

# ❌ 避免的做法：非幂等操作  
- name: 向文件追加内容
  shell: echo "new line" >> /tmp/file.txt
  # 每次执行都会添加新行
```

**原子性原则**：
```yaml
# ✅ 一个任务做一件事
- name: 安装nginx
  yum: name=nginx state=present

- name: 启动nginx服务  
  service: name=nginx state=started

- name: 设置nginx开机启动
  service: name=nginx enabled=yes

# ❌ 避免在一个任务中做太多事情
- name: 安装并配置nginx
  shell: |
    yum install -y nginx
    systemctl start nginx  
    systemctl enable nginx
    # 任何一步失败都会影响整个任务
```

### 9.2 性能优化建议


**减少不必要的任务执行**：
```yaml
- name: 检查配置文件是否存在
  stat: path=/etc/nginx/nginx.conf
  register: nginx_config

- name: 仅在配置文件不存在时创建
  template:
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
  when: not nginx_config.stat.exists     # 避免重复创建
```

**批量操作优化**：
```yaml
# ✅ 批量安装(效率高)
- name: 批量安装软件包
  yum:
    name: [git, vim, curl, wget]
    state: present

# ❌ 逐个安装(效率低)  
- name: 安装git
  yum: name=git state=present
- name: 安装vim
  yum: name=vim state=present
# ... 重复多次
```

### 9.3 错误处理最佳实践


**分级错误处理**：
```yaml
# 关键任务：必须成功
- name: 安装核心服务
  yum: name=nginx state=present
  # 不设置ignore_errors，失败时停止playbook

# 可选任务：失败可忽略
- name: 安装可选工具
  yum: name=htop state=present  
  ignore_errors: yes

# 清理任务：总是执行
- name: 清理临时文件
  file: path=/tmp/ansible_temp state=absent
  ignore_errors: yes
```

**完善的错误信息**：
```yaml
- name: 验证配置文件语法
  command: nginx -t
  register: config_check
  failed_when: config_check.rc != 0

- name: 配置错误时显示详细信息
  fail:
    msg: |
      ❌ Nginx配置文件语法错误！
      错误信息：{{ config_check.stderr }}
      请检查配置文件：/etc/nginx/nginx.conf
  when: config_check.rc != 0
```

### 9.4 可读性和维护性


**使用变量提高灵活性**：
```yaml
vars:
  web_packages:
    - nginx
    - php-fpm
    - mysql-server
  
  web_services:
    - nginx
    - php-fpm  
    - mysqld

tasks:
  - name: 安装web服务软件包
    yum: name="{{ web_packages }}" state=present
    
  - name: 启动web服务
    service: name="{{ item }}" state=started enabled=yes
    loop: "{{ web_services }}"
```

**添加适当的注释**：
```yaml
# 数据库初始化阶段
- name: 创建数据库目录
  file: path={{ mysql_datadir }} state=directory
  
  # 注意：首次初始化可能需要较长时间
- name: 初始化MySQL数据库
  command: mysqld --initialize-insecure --user=mysql --datadir={{ mysql_datadir }}
  when: mysql_initialized.stat.exists == false
```

---

## 10. 📋 核心要点总结


### 10.1 必须掌握的核心概念


```yaml
🔸 任务本质：Playbook中的基本执行单元，调用模块完成具体操作
🔸 基本语法：name + 模块 + 参数的YAML结构
🔸 执行控制：when条件、loop循环、register结果保存
🔸 状态管理：ok/changed/failed/skipped四种状态
🔸 最佳实践：幂等性、原子性、错误处理、性能优化
```

### 10.2 关键理解要点


**🔹 任务设计思维**
```
单一职责：一个任务只做一件事
幂等操作：多次执行结果相同  
状态导向：关注期望状态而非执行过程
错误预期：考虑失败场景和处理方案
```

**🔹 参数传递要点**
```
格式规范：使用标准YAML格式提高可读性
变量使用：{{ }} 包围，字符串开头要引号
数据类型：字符串、数值、布尔值、列表、字典
引用方式：直接值、变量引用、表达式计算
```

**🔹 控制流程核心**
```
条件执行：when关键字控制任务是否执行
循环处理：loop关键字处理批量操作
结果利用：register保存结果供后续任务使用
标签管理：tags实现任务分组和选择执行
```

### 10.3 实际应用指导


**任务规划建议**：
- **安装阶段**：软件包安装、依赖处理
- **配置阶段**：配置文件、参数设置  
- **服务阶段**：服务启动、状态检查
- **验证阶段**：功能测试、状态确认

**性能优化策略**：
- **批量操作**：能批量就不单独处理
- **条件过滤**：减少不必要的任务执行
- **结果复用**：register结果供多个任务使用
- **并发控制**：合理设置并发数量

### 10.4 常见问题避免


**语法问题**：
```yaml
# ❌ 缩进错误
- name: 任务
yum: name=nginx                    # 缺少缩进

# ✅ 正确缩进  
- name: 任务
  yum: name=nginx                  # 正确缩进
```

**逻辑问题**：
```yaml
# ❌ 顺序错误
- name: 启动服务
  service: name=nginx state=started
- name: 安装软件                   # 应该先安装再启动
  yum: name=nginx state=present

# ✅ 正确顺序
- name: 安装软件  
  yum: name=nginx state=present
- name: 启动服务
  service: name=nginx state=started
```

**安全问题**：
```yaml
# ❌ 硬编码敏感信息
- name: 配置数据库密码
  lineinfile: 
    line: "password=123456"        # 密码硬编码

# ✅ 使用变量和加密
- name: 配置数据库密码
  lineinfile:
    line: "password={{ mysql_password }}"  # 使用加密变量
```

### 10.5 学习进阶路径


**基础掌握**：
- ✅ 理解任务的基本概念和作用
- ✅ 掌握YAML语法和任务格式  
- ✅ 学会使用常用模块和参数

**进阶技能**：
- 🔧 灵活使用条件和循环控制
- 🔧 合理处理任务执行结果
- 🔧 设计高效的任务执行流程

**高级应用**：
- 🚀 任务性能优化和并发控制
- 🚀 复杂场景下的错误处理
- 🚀 大规模环境下的任务设计

> 💡 **学习建议**：从简单的任务开始，逐步增加复杂度。多实践、多测试，在实际项目中积累经验。

**核心记忆口诀**：
- 任务调模块，参数要传好
- 条件控执行，循环批量跑  
- 结果要保存，状态要知道
- 幂等是关键，错误处理巧