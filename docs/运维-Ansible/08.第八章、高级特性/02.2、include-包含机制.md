---
title: 2ã€include-åŒ…å«æœºåˆ¶
---
## ğŸ“š ç›®å½•

1. [åŒ…å«æœºåˆ¶åŸºç¡€æ¦‚å¿µ](#1-åŒ…å«æœºåˆ¶åŸºç¡€æ¦‚å¿µ)
2. [include_tasksä»»åŠ¡åŒ…å«](#2-include_tasksä»»åŠ¡åŒ…å«)
3. [include_varså˜é‡åŒ…å«](#3-include_varså˜é‡åŒ…å«)
4. [åŠ¨æ€åŒ…å«vsé™æ€åŒ…å«](#4-åŠ¨æ€åŒ…å«vsé™æ€åŒ…å«)
5. [å˜é‡ä¼ é€’ä¸ä½œç”¨åŸŸ](#5-å˜é‡ä¼ é€’ä¸ä½œç”¨åŸŸ)
6. [æ¡ä»¶åŒ…å«ä¸å¾ªç¯åŒ…å«](#6-æ¡ä»¶åŒ…å«ä¸å¾ªç¯åŒ…å«)
7. [ç»„ç»‡ç»“æ„è®¾è®¡æœ€ä½³å®è·µ](#7-ç»„ç»‡ç»“æ„è®¾è®¡æœ€ä½³å®è·µ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ§© åŒ…å«æœºåˆ¶åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯åŒ…å«æœºåˆ¶


**ğŸ”¸ æ ¸å¿ƒç†å¿µ**
åŒ…å«æœºåˆ¶å°±åƒæ­ç§¯æœ¨ä¸€æ ·ï¼ŒæŠŠå¤æ‚çš„ä»»åŠ¡æ‹†åˆ†æˆå°å—ï¼Œç„¶ååœ¨éœ€è¦çš„æ—¶å€™ç»„è£…ä½¿ç”¨ã€‚

```
ä¼ ç»Ÿæ–¹å¼ï¼ˆä¸€ä¸ªå¤§æ–‡ä»¶ï¼‰ï¼š
playbook.yml [1000è¡Œ]
â”œâ”€â”€ å®‰è£…è½¯ä»¶ [200è¡Œ]
â”œâ”€â”€ é…ç½®æ–‡ä»¶ [300è¡Œ]
â”œâ”€â”€ å¯åŠ¨æœåŠ¡ [200è¡Œ]
â””â”€â”€ æ£€æŸ¥çŠ¶æ€ [300è¡Œ]

åŒ…å«æœºåˆ¶ï¼ˆæ¨¡å—åŒ–ï¼‰ï¼š
playbook.yml [50è¡Œ]
â”œâ”€â”€ include: install.yml
â”œâ”€â”€ include: config.yml  
â”œâ”€â”€ include: service.yml
â””â”€â”€ include: check.yml
```

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦åŒ…å«æœºåˆ¶**
```
è§£å†³çš„é—®é¢˜ï¼š
âœ… ä»£ç é‡å¤ï¼šåŒæ ·çš„ä»»åŠ¡å†™å¤šæ¬¡
âœ… æ–‡ä»¶è¿‡å¤§ï¼šå•ä¸ªæ–‡ä»¶å‡ ç™¾ä¸Šåƒè¡Œéš¾ç»´æŠ¤
âœ… é€»è¾‘æ··ä¹±ï¼šä¸åŒåŠŸèƒ½æ··åœ¨ä¸€èµ·
âœ… å›¢é˜Ÿåä½œï¼šå¤šäººåŒæ—¶ç¼–è¾‘ä¸€ä¸ªæ–‡ä»¶å†²çª

å¸¦æ¥çš„å¥½å¤„ï¼š
ğŸ¯ æ¨¡å—åŒ–ï¼šåŠŸèƒ½ç‹¬ç«‹ï¼ŒèŒè´£æ¸…æ™°
ğŸ¯ å¯é‡ç”¨ï¼šä¸€æ¬¡ç¼–å†™ï¼Œå¤šå¤„ä½¿ç”¨
ğŸ¯ æ˜“ç»´æŠ¤ï¼šä¿®æ”¹å±€éƒ¨ä¸å½±å“æ•´ä½“
ğŸ¯ æ˜“ç†è§£ï¼šæ¯ä¸ªæ–‡ä»¶åŠŸèƒ½å•ä¸€æ˜ç¡®
```

### 1.2 åŒ…å«æœºåˆ¶çš„ä¸‰å¤§ç±»å‹


**ğŸ“‹ AnsibleåŒ…å«ç±»å‹å¯¹æ¯”**

| åŒ…å«ç±»å‹ | **ç”¨é€”** | **åŒ…å«å†…å®¹** | **ä½¿ç”¨åœºæ™¯** |
|---------|---------|-------------|-------------|
| `include_tasks` | ä»»åŠ¡åŒ…å« | `.yml`ä»»åŠ¡æ–‡ä»¶ | å¤ç”¨ä»»åŠ¡é€»è¾‘ |
| `include_vars` | å˜é‡åŒ…å« | `.yml`å˜é‡æ–‡ä»¶ | åŠ¨æ€åŠ è½½é…ç½® |
| `include` | é€šç”¨åŒ…å« | ä»»åŠ¡æˆ–å˜é‡æ–‡ä»¶ | å…¼å®¹æ—§ç‰ˆæœ¬ |

**ğŸ”§ åŸºæœ¬è¯­æ³•ç»“æ„**
```yaml
# ä»»åŠ¡åŒ…å«è¯­æ³•
- include_tasks: æ–‡ä»¶è·¯å¾„
  vars:
    å˜é‡å: å˜é‡å€¼

# å˜é‡åŒ…å«è¯­æ³•  
- include_vars: æ–‡ä»¶è·¯å¾„
  when: æ¡ä»¶è¡¨è¾¾å¼
```

---

## 2. âš™ï¸ include_tasksä»»åŠ¡åŒ…å«


### 2.1 åŸºç¡€ä»»åŠ¡åŒ…å«


**ğŸ”¸ ç®€å•çš„ä»»åŠ¡åŒ…å«ç¤ºä¾‹**

åˆ›å»ºç‹¬ç«‹çš„ä»»åŠ¡æ–‡ä»¶ï¼š
```yaml
# tasks/install_nginx.yml
---
- name: å®‰è£…nginxè½¯ä»¶åŒ…
  yum:
    name: nginx
    state: present

- name: å¯åŠ¨nginxæœåŠ¡
  service:
    name: nginx
    state: started
    enabled: yes
```

åœ¨ä¸»playbookä¸­åŒ…å«ï¼š
```yaml
# main.yml
---
- hosts: web_servers
  tasks:
    - name: åŒ…å«nginxå®‰è£…ä»»åŠ¡
      include_tasks: tasks/install_nginx.yml
```

**ğŸ’¡ ç†è§£è¦ç‚¹**
- `include_tasks`å°±åƒè°ƒç”¨å‡½æ•°ï¼ŒæŠŠå¤–éƒ¨æ–‡ä»¶çš„ä»»åŠ¡"å¤åˆ¶"åˆ°å½“å‰ä½ç½®
- è¢«åŒ…å«çš„æ–‡ä»¶å¿…é¡»æ˜¯æœ‰æ•ˆçš„YAMLä»»åŠ¡åˆ—è¡¨
- åŒ…å«åå°±åƒè¿™äº›ä»»åŠ¡ç›´æ¥å†™åœ¨ä¸»æ–‡ä»¶ä¸­ä¸€æ ·

### 2.2 å¸¦å‚æ•°çš„ä»»åŠ¡åŒ…å«


**ğŸ”§ å‚æ•°åŒ–ä»»åŠ¡æ–‡ä»¶**
```yaml
# tasks/install_service.yml
---
- name: å®‰è£…{{ service_name }}è½¯ä»¶åŒ…
  yum:
    name: "{{ service_name }}"
    state: present

- name: å¯åŠ¨{{ service_name }}æœåŠ¡
  service:
    name: "{{ service_name }}"
    state: "{{ service_state | default('started') }}"
    enabled: "{{ service_enabled | default(true) }}"
```

**ä½¿ç”¨æ—¶ä¼ é€’å‚æ•°**ï¼š
```yaml
# main.yml
- hosts: web_servers
  tasks:
    - name: å®‰è£…nginx
      include_tasks: tasks/install_service.yml
      vars:
        service_name: nginx
        service_state: started
        
    - name: å®‰è£…apache
      include_tasks: tasks/install_service.yml  
      vars:
        service_name: httpd
        service_enabled: false
```

**âš¡ å®é™…åº”ç”¨åœºæ™¯**
> ğŸ’¡ **ä½¿ç”¨æŠ€å·§**ï¼šä¸€ä¸ªé€šç”¨çš„æœåŠ¡å®‰è£…æ¨¡æ¿ï¼Œå¯ä»¥å®‰è£…ä¸åŒçš„æœåŠ¡ï¼Œé¿å…é‡å¤ç¼–å†™ç±»ä¼¼ä»£ç 

### 2.3 åŠ¨æ€æ–‡ä»¶ååŒ…å«


**ğŸ¯ æ ¹æ®æ¡ä»¶åŒ…å«ä¸åŒæ–‡ä»¶**
```yaml
# ç›®å½•ç»“æ„
tasks/
â”œâ”€â”€ install_centos.yml    # CentOSå®‰è£…æ­¥éª¤
â”œâ”€â”€ install_ubuntu.yml    # Ubuntuå®‰è£…æ­¥éª¤
â””â”€â”€ install_debian.yml    # Debianå®‰è£…æ­¥éª¤

# main.yml
- hosts: all
  tasks:
    - name: æ ¹æ®æ“ä½œç³»ç»ŸåŒ…å«å¯¹åº”å®‰è£…ä»»åŠ¡
      include_tasks: "tasks/install_{{ ansible_os_family | lower }}.yml"
```

**å„æ“ä½œç³»ç»Ÿçš„å…·ä½“å®ç°**ï¼š
```yaml
# tasks/install_redhat.yml
- name: ä½¿ç”¨yumå®‰è£…è½¯ä»¶
  yum:
    name: "{{ packages }}"
    state: present

# tasks/install_debian.yml  
- name: ä½¿ç”¨aptå®‰è£…è½¯ä»¶
  apt:
    name: "{{ packages }}"
    state: present
    update_cache: yes
```

---

## 3. ğŸ“Š include_varså˜é‡åŒ…å«


### 3.1 åŸºç¡€å˜é‡åŒ…å«


**ğŸ”¸ å˜é‡æ–‡ä»¶ç»„ç»‡**
```yaml
# vars/database.yml
---
db_host: localhost
db_port: 3306
db_name: myapp
db_user: appuser
db_password: "{{ vault_db_password }}"

database_config:
  max_connections: 100
  timeout: 30
  charset: utf8mb4
```

**åœ¨playbookä¸­åŠ è½½å˜é‡**ï¼š
```yaml
# main.yml
- hosts: db_servers
  tasks:
    - name: åŠ è½½æ•°æ®åº“é…ç½®å˜é‡
      include_vars: vars/database.yml
      
    - name: æ˜¾ç¤ºæ•°æ®åº“é…ç½®
      debug:
        msg: "æ•°æ®åº“åœ°å€: {{ db_host }}:{{ db_port }}"
```

### 3.2 æ¡ä»¶åŒ–å˜é‡åŒ…å«


**ğŸ¯ æ ¹æ®ç¯å¢ƒåŠ è½½ä¸åŒé…ç½®**
```
ç¯å¢ƒé…ç½®ç›®å½•ç»“æ„ï¼š
vars/
â”œâ”€â”€ dev.yml        # å¼€å‘ç¯å¢ƒé…ç½®
â”œâ”€â”€ test.yml       # æµ‹è¯•ç¯å¢ƒé…ç½®  
â”œâ”€â”€ prod.yml       # ç”Ÿäº§ç¯å¢ƒé…ç½®
â””â”€â”€ common.yml     # é€šç”¨é…ç½®
```

**ç¯å¢ƒé…ç½®æ–‡ä»¶ç¤ºä¾‹**ï¼š
```yaml
# vars/dev.yml
---
app_debug: true
log_level: debug
db_host: dev-db.company.com
redis_host: dev-redis.company.com

# vars/prod.yml
---
app_debug: false
log_level: error  
db_host: prod-db.company.com
redis_host: prod-redis.company.com
```

**åŠ¨æ€åŠ è½½é…ç½®**ï¼š
```yaml
# main.yml
- hosts: app_servers
  vars:
    env: "{{ target_env | default('dev') }}"
  tasks:
    - name: åŠ è½½é€šç”¨é…ç½®
      include_vars: vars/common.yml
      
    - name: åŠ è½½ç¯å¢ƒç‰¹å®šé…ç½®
      include_vars: "vars/{{ env }}.yml"
      
    - name: éƒ¨ç½²åº”ç”¨
      template:
        src: app.conf.j2
        dest: /etc/app/app.conf
```

**ğŸ“‹ ä½¿ç”¨æ–¹å¼**ï¼š
```bash
# éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ
ansible-playbook main.yml -e "target_env=dev"

# éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ  
ansible-playbook main.yml -e "target_env=prod"
```

### 3.3 å¾ªç¯åŠ è½½å˜é‡æ–‡ä»¶


**ğŸ”„ æ‰¹é‡åŠ è½½å¤šä¸ªå˜é‡æ–‡ä»¶**
```yaml
- hosts: web_servers
  vars:
    config_files:
      - database.yml
      - cache.yml
      - logging.yml
      - security.yml
  tasks:
    - name: æ‰¹é‡åŠ è½½é…ç½®æ–‡ä»¶
      include_vars: "vars/{{ item }}"
      loop: "{{ config_files }}"
      
    - name: éªŒè¯å˜é‡åŠ è½½
      debug:
        var: "{{ item }}"
      loop:
        - db_host
        - cache_server
        - log_level
```

---

## 4. ğŸ”„ åŠ¨æ€åŒ…å«vsé™æ€åŒ…å«


### 4.1 åŒ…å«æ—¶æœºå¯¹æ¯”


**ğŸ“Š åŠ¨æ€vsé™æ€åŒ…å«ç‰¹ç‚¹**

```
é™æ€åŒ…å«ç‰¹ç‚¹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è§£æé˜¶æ®µï¼šplaybookå¯åŠ¨æ—¶    â”‚ 
â”‚ è§£ææ—¶æœºï¼šç«‹å³å±•å¼€æ‰€æœ‰å†…å®¹  â”‚
â”‚ æ€§èƒ½ï¼šè§£æå¿«ï¼Œæ‰§è¡Œå¿«        â”‚
â”‚ çµæ´»æ€§ï¼šæ¡ä»¶åˆ¤æ–­æœ‰é™        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åŠ¨æ€åŒ…å«ç‰¹ç‚¹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è§£æé˜¶æ®µï¼šä»»åŠ¡æ‰§è¡Œæ—¶        â”‚
â”‚ è§£ææ—¶æœºï¼šè¿è¡Œæ—¶åŠ¨æ€å†³å®š    â”‚  
â”‚ æ€§èƒ½ï¼šè§£ææ…¢ï¼Œä½†æ›´çµæ´»      â”‚
â”‚ çµæ´»æ€§ï¼šæ”¯æŒè¿è¡Œæ—¶æ¡ä»¶      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 é™æ€åŒ…å«ç¤ºä¾‹


**ğŸ”§ ä½¿ç”¨import_tasksï¼ˆé™æ€ï¼‰**
```yaml
# main.yml
- hosts: web_servers
  tasks:
    # é™æ€åŒ…å«ï¼šåœ¨playbookè§£ææ—¶å°±ç¡®å®šåŒ…å«å†…å®¹
    - import_tasks: tasks/prepare.yml
    - import_tasks: tasks/install.yml
    - import_tasks: tasks/configure.yml
```

**ç‰¹ç‚¹è¯´æ˜**ï¼š
> âš ï¸ **æ³¨æ„**ï¼šé™æ€åŒ…å«åœ¨playbookå¼€å§‹è§£ææ—¶å°±æŠŠæ‰€æœ‰ä»»åŠ¡å±•å¼€ï¼Œå°±åƒç›´æ¥å†™åœ¨ä¸»æ–‡ä»¶ä¸­ä¸€æ ·

### 4.3 åŠ¨æ€åŒ…å«ç¤ºä¾‹


**âš¡ ä½¿ç”¨include_tasksï¼ˆåŠ¨æ€ï¼‰**
```yaml
# main.yml  
- hosts: web_servers
  tasks:
    - name: æ£€æŸ¥æœåŠ¡çŠ¶æ€
      service_facts:
      
    - name: æ ¹æ®æœåŠ¡çŠ¶æ€å†³å®šåŒ…å«å“ªäº›ä»»åŠ¡
      include_tasks: tasks/repair.yml
      when: ansible_facts.services['nginx.service'].state != 'running'
      
    - name: æ ¹æ®ä¸»æœºé…ç½®é€‰æ‹©ä¼˜åŒ–æ–¹æ¡ˆ
      include_tasks: "tasks/optimize_{{ ansible_processor_cores }}_cores.yml"
```

**ğŸ¯ åŠ¨æ€åŒ…å«çš„å…¸å‹åœºæ™¯**ï¼š
```yaml
- name: æ ¹æ®é”™è¯¯ç±»å‹æ‰§è¡Œä¸åŒä¿®å¤æµç¨‹
  include_tasks: "tasks/fix_{{ error_type }}.yml"
  vars:
    error_details: "{{ current_error }}"
  when: error_type is defined
```

---

## 5. ğŸ”— å˜é‡ä¼ é€’ä¸ä½œç”¨åŸŸ


### 5.1 å˜é‡ä½œç”¨åŸŸè§„åˆ™


**ğŸ“‹ Ansibleå˜é‡ä½œç”¨åŸŸå±‚æ¬¡**
```
å˜é‡ä½œç”¨åŸŸï¼ˆä»é«˜åˆ°ä½ä¼˜å…ˆçº§ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‘½ä»¤è¡Œå˜é‡ -e    â”‚ â† æœ€é«˜ä¼˜å…ˆçº§
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ includeæ—¶ä¼ é€’    â”‚ 
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  
â”‚ playbook vars   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ host_vars       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ group_vars      â”‚ â† æœ€ä½ä¼˜å…ˆçº§
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 å˜é‡ä¼ é€’æœºåˆ¶


**ğŸ”§ å‘åŒ…å«çš„ä»»åŠ¡ä¼ é€’å˜é‡**
```yaml
# tasks/backup.yml
---
- name: åˆ›å»ºå¤‡ä»½ç›®å½•
  file:
    path: "{{ backup_dir }}/{{ backup_date }}"
    state: directory
    
- name: å¤‡ä»½é…ç½®æ–‡ä»¶
  copy:
    src: "{{ config_file }}"
    dest: "{{ backup_dir }}/{{ backup_date }}/{{ config_file | basename }}"
    backup: yes

# main.yml
- hosts: db_servers  
  vars:
    backup_base: /opt/backups
  tasks:
    - name: æ‰§è¡Œæ•°æ®åº“é…ç½®å¤‡ä»½
      include_tasks: tasks/backup.yml
      vars:
        backup_dir: "{{ backup_base }}/database"
        backup_date: "{{ ansible_date_time.date }}"
        config_file: /etc/mysql/my.cnf
        
    - name: æ‰§è¡Œåº”ç”¨é…ç½®å¤‡ä»½  
      include_tasks: tasks/backup.yml
      vars:
        backup_dir: "{{ backup_base }}/application"
        backup_date: "{{ ansible_date_time.date }}"
        config_file: /etc/app/app.conf
```

### 5.3 å˜é‡ç»§æ‰¿ä¸è¦†ç›–


**âš¡ å˜é‡è¦†ç›–ç¤ºä¾‹**
```yaml
# main.yml
- hosts: web_servers
  vars:
    # å…¨å±€é»˜è®¤å€¼
    service_port: 80
    service_user: www-data
    
  tasks:
    - name: å®‰è£…æ ‡å‡†webæœåŠ¡
      include_tasks: tasks/install_web.yml
      # ä½¿ç”¨é»˜è®¤ç«¯å£80
      
    - name: å®‰è£…SSL webæœåŠ¡  
      include_tasks: tasks/install_web.yml
      vars:
        # è¦†ç›–ç«¯å£ä¸º443
        service_port: 443
        ssl_enabled: true
```

**ğŸ“ ç†è§£è¦ç‚¹**ï¼š
> ğŸ’¡ **å…³é”®æ¦‚å¿µ**ï¼šåŒ…å«æ—¶ä¼ é€’çš„å˜é‡ä¼šè¦†ç›–åŒåçš„å…¨å±€å˜é‡ï¼Œä½†åªåœ¨è¢«åŒ…å«çš„ä»»åŠ¡ä¸­ç”Ÿæ•ˆ

---

## 6. ğŸ”€ æ¡ä»¶åŒ…å«ä¸å¾ªç¯åŒ…å«


### 6.1 æ¡ä»¶åŒ–åŒ…å«


**ğŸ¯ åŸºäºæ¡ä»¶çš„åŒ…å«æ§åˆ¶**
```yaml
# main.yml
- hosts: all
  tasks:
    - name: æ”¶é›†ç³»ç»Ÿä¿¡æ¯
      setup:
      
    - name: ä»…åœ¨CentOSç³»ç»Ÿä¸Šå®‰è£…EPEL
      include_tasks: tasks/install_epel.yml
      when: ansible_os_family == "RedHat"
      
    - name: ä»…åœ¨å†…å­˜å¤§äº4GBæ—¶å¯ç”¨ç¼“å­˜
      include_tasks: tasks/configure_cache.yml  
      when: ansible_memtotal_mb > 4096
      
    - name: ä»…åœ¨ç”Ÿäº§ç¯å¢ƒå¯ç”¨ç›‘æ§
      include_tasks: tasks/setup_monitoring.yml
      when: environment == "production"
```

**ğŸ”§ å¤æ‚æ¡ä»¶ç¤ºä¾‹**ï¼š
```yaml
- name: æ ¹æ®å¤šä¸ªæ¡ä»¶å†³å®šæ˜¯å¦åŒ…å«
  include_tasks: tasks/performance_tuning.yml
  when:
    - ansible_processor_cores >= 4
    - ansible_memtotal_mb >= 8192  
    - server_role == "database"
```

### 6.2 å¾ªç¯åŒ…å«


**ğŸ”„ ä½¿ç”¨loopå¾ªç¯åŒ…å«**
```yaml
# ä¸ºå¤šä¸ªæœåŠ¡æ‰§è¡Œç›¸åŒæ“ä½œ
- hosts: app_servers
  vars:
    services:
      - name: nginx
        port: 80
        config_template: nginx.conf.j2
      - name: php-fpm
        port: 9000  
        config_template: php-fpm.conf.j2
      - name: redis
        port: 6379
        config_template: redis.conf.j2
        
  tasks:
    - name: ä¸ºæ¯ä¸ªæœåŠ¡æ‰§è¡Œå®‰è£…é…ç½®
      include_tasks: tasks/service_setup.yml
      loop: "{{ services }}"
      vars:
        current_service: "{{ item }}"
```

**å¯¹åº”çš„ä»»åŠ¡æ–‡ä»¶**ï¼š
```yaml
# tasks/service_setup.yml  
---
- name: å®‰è£…{{ current_service.name }}
  yum:
    name: "{{ current_service.name }}"
    state: present
    
- name: é…ç½®{{ current_service.name }}
  template:
    src: "{{ current_service.config_template }}"
    dest: "/etc/{{ current_service.name }}/{{ current_service.name }}.conf"
  notify: restart {{ current_service.name }}
```

### 6.3 åµŒå¥—å¾ªç¯åŒ…å«


**ğŸ¯ å¤æ‚çš„åµŒå¥—åœºæ™¯**
```yaml
# ä¸ºå¤šä¸ªç¯å¢ƒçš„å¤šä¸ªåº”ç”¨æ‰§è¡Œéƒ¨ç½²
- hosts: app_servers
  vars:
    environments: [dev, test, prod]
    applications: [web, api, worker]
    
  tasks:
    - name: ä¸ºæ¯ä¸ªç¯å¢ƒçš„æ¯ä¸ªåº”ç”¨æ‰§è¡Œéƒ¨ç½²
      include_tasks: tasks/deploy_app.yml
      loop: "{{ environments | product(applications) | list }}"  
      vars:
        env_name: "{{ item.0 }}"
        app_name: "{{ item.1 }}"
```

---

## 7. ğŸ—ï¸ ç»„ç»‡ç»“æ„è®¾è®¡æœ€ä½³å®è·µ


### 7.1 æ ‡å‡†ç›®å½•ç»“æ„è®¾è®¡


**ğŸ“‚ æ¨èçš„é¡¹ç›®ç›®å½•ç»“æ„**
```
ansible-project/
â”œâ”€â”€ playbooks/              # ä¸»playbookæ–‡ä»¶
â”‚   â”œâ”€â”€ site.yml            # ä¸»å…¥å£æ–‡ä»¶
â”‚   â”œâ”€â”€ webservers.yml      # webæœåŠ¡å™¨éƒ¨ç½²
â”‚   â””â”€â”€ databases.yml       # æ•°æ®åº“éƒ¨ç½²
â”œâ”€â”€ roles/                  # è§’è‰²ç›®å½•ï¼ˆæ¨èä½¿ç”¨ï¼‰
â”œâ”€â”€ tasks/                  # ç‹¬ç«‹ä»»åŠ¡æ–‡ä»¶
â”‚   â”œâ”€â”€ common/            # é€šç”¨ä»»åŠ¡
â”‚   â”‚   â”œâ”€â”€ security.yml   # å®‰å…¨åŠ å›º
â”‚   â”‚   â””â”€â”€ monitoring.yml # ç›‘æ§è®¾ç½®
â”‚   â”œâ”€â”€ web/              # webç›¸å…³ä»»åŠ¡  
â”‚   â”‚   â”œâ”€â”€ install.yml   # å®‰è£…ä»»åŠ¡
â”‚   â”‚   â”œâ”€â”€ config.yml    # é…ç½®ä»»åŠ¡
â”‚   â”‚   â””â”€â”€ deploy.yml    # éƒ¨ç½²ä»»åŠ¡
â”‚   â””â”€â”€ database/         # æ•°æ®åº“ç›¸å…³
â”œâ”€â”€ vars/                 # å˜é‡æ–‡ä»¶
â”‚   â”œâ”€â”€ common.yml        # é€šç”¨å˜é‡
â”‚   â”œâ”€â”€ dev.yml          # å¼€å‘ç¯å¢ƒ
â”‚   â”œâ”€â”€ test.yml         # æµ‹è¯•ç¯å¢ƒ  
â”‚   â””â”€â”€ prod.yml         # ç”Ÿäº§ç¯å¢ƒ
â”œâ”€â”€ templates/           # æ¨¡æ¿æ–‡ä»¶
â”œâ”€â”€ files/              # é™æ€æ–‡ä»¶
â””â”€â”€ inventory/          # ä¸»æœºæ¸…å•
```

### 7.2 æ¨¡å—åŒ–è®¾è®¡åŸåˆ™


**ğŸ¯ å•ä¸€èŒè´£åŸåˆ™**
```yaml
# âŒ ä¸å¥½çš„åšæ³•ï¼šä¸€ä¸ªæ–‡ä»¶åŒ…å«å¤šç§åŠŸèƒ½
# tasks/everything.yml
- name: å®‰è£…nginx
  yum: name=nginx state=present
- name: é…ç½®nginx  
  template: src=nginx.conf dest=/etc/nginx/nginx.conf
- name: å®‰è£…mysql
  yum: name=mysql state=present
- name: é…ç½®mysql
  template: src=my.cnf dest=/etc/my.cnf

# âœ… å¥½çš„åšæ³•ï¼šæŒ‰åŠŸèƒ½æ‹†åˆ†æ–‡ä»¶
# tasks/nginx/install.yml
- name: å®‰è£…nginx
  yum: name=nginx state=present

# tasks/nginx/config.yml  
- name: é…ç½®nginx
  template: src=nginx.conf dest=/etc/nginx/nginx.conf
```

**ğŸ”§ å‚æ•°åŒ–è®¾è®¡**
```yaml
# tasks/service_manager.yml - é€šç”¨æœåŠ¡ç®¡ç†æ¨¡æ¿
---
- name: å®‰è£…{{ service.name }}æœåŠ¡
  package:
    name: "{{ service.package | default(service.name) }}"
    state: present
  
- name: é…ç½®{{ service.name }}æœåŠ¡
  template:
    src: "{{ service.config_template }}"
    dest: "{{ service.config_path }}"
  when: service.config_template is defined
  notify: "restart {{ service.name }}"
  
- name: å¯åŠ¨{{ service.name }}æœåŠ¡
  service:
    name: "{{ service.name }}"
    state: "{{ service.state | default('started') }}"
    enabled: "{{ service.enabled | default(true) }}"
```

### 7.3 å‘½åè§„èŒƒä¸æ³¨é‡Š


**ğŸ“ æ–‡ä»¶å‘½åè§„èŒƒ**
```
æ¨èçš„å‘½åè§„èŒƒï¼š
âœ… install_nginx.yml        # åŠ¨è¯_å¯¹è±¡.yml
âœ… configure_database.yml   # åŠŸèƒ½æ¸…æ™°æ˜ç¡®
âœ… backup_configs.yml       # æ“ä½œç›®çš„æ˜ç¡®
âœ… check_system_health.yml  # æ£€æŸ¥ç±»ä»»åŠ¡

âŒ é¿å…çš„å‘½åï¼š
âŒ task1.yml               # æ— æ„ä¹‰å‘½å
âŒ stuff.yml               # ä¸æ˜ç¡®ç”¨é€”  
âŒ temp.yml                # ä¸´æ—¶æ€§å‘½å
```

**ğŸ’¡ æ³¨é‡Šæœ€ä½³å®è·µ**
```yaml
# tasks/deploy_application.yml
---
# åº”ç”¨éƒ¨ç½²ä»»åŠ¡é›†åˆ
# åŠŸèƒ½ï¼šéƒ¨ç½²æŒ‡å®šç‰ˆæœ¬çš„åº”ç”¨åˆ°ç›®æ ‡æœåŠ¡å™¨
# ä¾èµ–ï¼šéœ€è¦é¢„å…ˆè®¾ç½®app_versionå’Œapp_nameå˜é‡
# ä½œè€…ï¼šè¿ç»´å›¢é˜Ÿ
# æ›´æ–°ï¼š2024-01-15

- name: åˆ›å»ºåº”ç”¨ç›®å½•
  file:
    path: "/opt/{{ app_name }}"
    state: directory
    owner: "{{ app_user | default('app') }}"
    mode: '0755'
  # ä¸ºåº”ç”¨åˆ›å»ºä¸“ç”¨ç›®å½•ï¼Œç¡®ä¿æƒé™æ­£ç¡®

- name: ä¸‹è½½åº”ç”¨åŒ…  
  get_url:
    url: "{{ app_download_url }}/{{ app_name }}-{{ app_version }}.tar.gz"
    dest: "/tmp/{{ app_name }}-{{ app_version }}.tar.gz"
    timeout: 300
  # ä»ä»“åº“ä¸‹è½½æŒ‡å®šç‰ˆæœ¬çš„åº”ç”¨åŒ…ï¼Œè®¾ç½®åˆç†è¶…æ—¶æ—¶é—´
```

### 7.4 é”™è¯¯å¤„ç†ä¸å›æ»šæœºåˆ¶


**ğŸ›¡ï¸ é”™è¯¯å¤„ç†è®¾è®¡**
```yaml
# tasks/safe_deploy.yml
---
- name: å¤‡ä»½å½“å‰ç‰ˆæœ¬
  include_tasks: tasks/backup_current.yml
  tags: backup

- name: éƒ¨ç½²æ–°ç‰ˆæœ¬
  include_tasks: tasks/deploy_new.yml
  tags: deploy
  # å¦‚æœéƒ¨ç½²å¤±è´¥ï¼Œæ•è·é”™è¯¯ä½†ç»§ç»­æ‰§è¡Œ
  ignore_errors: yes
  register: deploy_result
  
- name: æ£€æŸ¥éƒ¨ç½²ç»“æœ
  include_tasks: tasks/verify_deploy.yml
  tags: verify
  when: deploy_result is succeeded
  
- name: å›æ»šåˆ°å¤‡ä»½ç‰ˆæœ¬
  include_tasks: tasks/rollback.yml  
  tags: rollback
  when: deploy_result is failed
  
- name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
  include_tasks: tasks/cleanup.yml
  tags: cleanup
  # æ— è®ºæˆåŠŸå¤±è´¥éƒ½è¦æ‰§è¡Œæ¸…ç†
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ åŒ…å«æœºåˆ¶æœ¬è´¨ï¼šæ¨¡å—åŒ–ç»„ç»‡ï¼Œæé«˜ä»£ç å¤ç”¨æ€§å’Œå¯ç»´æŠ¤æ€§
ğŸ”¸ ä¸‰ç§åŒ…å«ç±»å‹ï¼šinclude_tasksï¼ˆä»»åŠ¡ï¼‰ã€include_varsï¼ˆå˜é‡ï¼‰ã€includeï¼ˆé€šç”¨ï¼‰
ğŸ”¸ åŠ¨æ€vsé™æ€ï¼šinclude_tasksï¼ˆè¿è¡Œæ—¶ï¼‰vs import_tasksï¼ˆè§£ææ—¶ï¼‰
ğŸ”¸ å˜é‡ä½œç”¨åŸŸï¼šåŒ…å«æ—¶ä¼ é€’çš„å˜é‡ä¼˜å…ˆçº§é«˜äºå…¨å±€å˜é‡
ğŸ”¸ æ¡ä»¶ä¸å¾ªç¯ï¼šæ”¯æŒwhenæ¡ä»¶å’Œloopå¾ªç¯ï¼Œå®ç°çµæ´»æ§åˆ¶
```

### 8.2 å®ç”¨æŠ€å·§æ€»ç»“


**ğŸ”¹ è®¾è®¡åŸåˆ™**
```
æ¨¡å—åŒ–åŸåˆ™ï¼š
â€¢ å•ä¸€èŒè´£ï¼šæ¯ä¸ªæ–‡ä»¶åªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½
â€¢ å‚æ•°åŒ–è®¾è®¡ï¼šé€šè¿‡å˜é‡ä½¿ä»»åŠ¡æ›´é€šç”¨
â€¢ åˆç†æŠ½è±¡ï¼šæå–å…¬å…±é€»è¾‘ï¼Œå‡å°‘é‡å¤

ç»„ç»‡åŸåˆ™ï¼š
â€¢ ç›®å½•ç»“æ„æ¸…æ™°ï¼šæŒ‰åŠŸèƒ½å’Œå±‚æ¬¡ç»„ç»‡æ–‡ä»¶
â€¢ å‘½åè§„èŒƒç»Ÿä¸€ï¼šä½¿ç”¨åŠ¨è¯_å¯¹è±¡çš„å‘½åæ–¹å¼
â€¢ æ–‡æ¡£æ³¨é‡Šå®Œå–„ï¼šè¯´æ˜åŠŸèƒ½ã€ä¾èµ–ã€ä½¿ç”¨æ–¹æ³•
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–**
```
é€‰æ‹©åˆé€‚çš„åŒ…å«æ–¹å¼ï¼š
â€¢ é™æ€åŒ…å«ï¼šå†…å®¹å›ºå®šï¼Œè¿½æ±‚æ€§èƒ½
â€¢ åŠ¨æ€åŒ…å«ï¼šéœ€è¦è¿è¡Œæ—¶åˆ¤æ–­ï¼Œè¿½æ±‚çµæ´»æ€§

å‡å°‘åµŒå¥—å±‚æ¬¡ï¼š
â€¢ é¿å…è¿‡æ·±çš„åŒ…å«åµŒå¥—
â€¢ åˆç†ä½¿ç”¨è§’è‰²(roles)æ›¿ä»£å¤æ‚åŒ…å«
```

**ğŸ”¹ å¸¸è§é™·é˜±é¿å…**
```
å˜é‡ä½œç”¨åŸŸæ··ä¹±ï¼š
â€¢ æ˜ç¡®å˜é‡çš„ä½œç”¨èŒƒå›´
â€¢ é¿å…åŒåå˜é‡åœ¨ä¸åŒå±‚æ¬¡å‡ºç°

æ–‡ä»¶è·¯å¾„é”™è¯¯ï¼š
â€¢ ä½¿ç”¨ç›¸å¯¹è·¯å¾„æ—¶æ³¨æ„å½“å‰ç›®å½•
â€¢ å»ºè®®ä½¿ç”¨ç»å¯¹è·¯å¾„æˆ–ç›¸å¯¹äºplaybookçš„è·¯å¾„

å¾ªç¯åŒ…å«æ€§èƒ½ï¼š
â€¢ é¿å…åœ¨å¾ªç¯ä¸­åŒ…å«å¤§é‡ä»»åŠ¡æ–‡ä»¶
â€¢ è€ƒè™‘å°†å¾ªç¯é€»è¾‘ç§»åˆ°è¢«åŒ…å«çš„æ–‡ä»¶ä¸­
```

### 8.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¸šåŠ¡åœºæ™¯åº”ç”¨**
- **ç¯å¢ƒéƒ¨ç½²**ï¼šå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒçš„å·®å¼‚åŒ–éƒ¨ç½²
- **æœåŠ¡ç®¡ç†**ï¼šå¤šä¸ªç›¸ä¼¼æœåŠ¡çš„ç»Ÿä¸€ç®¡ç†æ¨¡æ¿
- **é…ç½®ç®¡ç†**ï¼šæŒ‰ä¸šåŠ¡æ¨¡å—ç»„ç»‡é…ç½®ï¼Œä¾¿äºç»´æŠ¤
- **åº”ç”¨å‘å¸ƒ**ï¼šæ ‡å‡†åŒ–çš„éƒ¨ç½²æµç¨‹ï¼Œæ”¯æŒå›æ»šæœºåˆ¶

**ğŸ”§ å›¢é˜Ÿåä½œ**
- **èŒè´£åˆ†å·¥**ï¼šä¸åŒæˆå‘˜ç»´æŠ¤ä¸åŒæ¨¡å—çš„ä»»åŠ¡æ–‡ä»¶
- **ä»£ç å¤ç”¨**ï¼šå…¬å…±ä»»åŠ¡æ¨¡æ¿ä¾›å…¨å›¢é˜Ÿä½¿ç”¨
- **ç‰ˆæœ¬ç®¡ç†**ï¼šæ¨¡å—åŒ–æ–‡ä»¶ä¾¿äºGitç‰ˆæœ¬æ§åˆ¶
- **çŸ¥è¯†ä¼ æ‰¿**ï¼šæ–°æˆå‘˜å¿«é€Ÿç†è§£å’Œä¸Šæ‰‹ç‰¹å®šæ¨¡å—

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- åŒ…å«æœºåˆ¶è®©Ansibleä»£ç åƒç§¯æœ¨ä¸€æ ·çµæ´»ç»„è£…
- include_tasksç”¨äºä»»åŠ¡å¤ç”¨ï¼Œinclude_varsç”¨äºé…ç½®ç®¡ç†
- åˆç†çš„ç›®å½•ç»“æ„å’Œå‘½åè§„èŒƒæ˜¯å›¢é˜Ÿåä½œçš„åŸºç¡€
- åŠ¨æ€åŒ…å«æä¾›çµæ´»æ€§ï¼Œé™æ€åŒ…å«æä¾›æ€§èƒ½ä¼˜åŠ¿