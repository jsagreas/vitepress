---
title: 3ã€playbookå‰§æœ¬é…ç½®æ–‡ä»¶
---
## ğŸ“š ç›®å½•

1. [ä»€ä¹ˆæ˜¯Ansible Playbook](#1-ä»€ä¹ˆæ˜¯ansible-playbook)
2. [PlaybookåŸºç¡€ç»“æ„](#2-playbookåŸºç¡€ç»“æ„)
3. [æ ¸å¿ƒé…ç½®é¡¹è¯¦è§£](#3-æ ¸å¿ƒé…ç½®é¡¹è¯¦è§£)
4. [å˜é‡å®šä¹‰ä¸ä½¿ç”¨](#4-å˜é‡å®šä¹‰ä¸ä½¿ç”¨)
5. [ä»»åŠ¡ä¸å¤„ç†ç¨‹åº](#5-ä»»åŠ¡ä¸å¤„ç†ç¨‹åº)
6. [æƒé™ä¸æ‰§è¡Œæ§åˆ¶](#6-æƒé™ä¸æ‰§è¡Œæ§åˆ¶)
7. [é«˜çº§é…ç½®ç­–ç•¥](#7-é«˜çº§é…ç½®ç­–ç•¥)
8. [å®æˆ˜é…ç½®ç¤ºä¾‹](#8-å®æˆ˜é…ç½®ç¤ºä¾‹)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ­ ä»€ä¹ˆæ˜¯Ansible Playbook


### 1.1 é€šä¿—ç†è§£Playbook


> ğŸ’¡ **ç”Ÿæ´»æ¯”å–»**
> 
> æƒ³è±¡ä½ è¦æ•™æœ‹å‹åšä¸€é“èœï¼Œä½ ä¼šå†™ä¸‹è¯¦ç»†çš„é£Ÿè°±ï¼šå‡†å¤‡ä»€ä¹ˆé£Ÿæã€æŒ‰ä»€ä¹ˆé¡ºåºæ“ä½œã€ç«å€™æ€ä¹ˆæ§åˆ¶ã€‚Playbookå°±æ˜¯ç»™æœåŠ¡å™¨çš„"é£Ÿè°±"ï¼Œå‘Šè¯‰å®ƒè¦åšä»€ä¹ˆäº‹æƒ…ã€æŒ‰ä»€ä¹ˆæ­¥éª¤æ¥ã€‚

**ğŸ”¸ æ ¸å¿ƒæ¦‚å¿µ**
```
Playbook = å‰§æœ¬æ–‡ä»¶
å°±åƒæˆå‰§æ¼”å‘˜æ‹¿ç€å‰§æœ¬æŒ‰å‰§æƒ…è¡¨æ¼”ä¸€æ ·
Ansibleæ‹¿ç€Playbookæ–‡ä»¶æŒ‰é…ç½®æ‰§è¡Œä»»åŠ¡

ç®€å•æ¥è¯´ï¼š
- ä½ å†™å‰§æœ¬ï¼ˆYAMLæ–‡ä»¶ï¼‰
- Ansibleå½“æ¼”å‘˜ï¼ˆæ‰§è¡Œå·¥å…·ï¼‰  
- æœåŠ¡å™¨æ˜¯èˆå°ï¼ˆç›®æ ‡ä¸»æœºï¼‰
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦Playbook


**ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜**
```
æ‰‹åŠ¨éƒ¨ç½²ï¼š
å¼ ä¸‰éƒ¨ç½² â†’ æœåŠ¡å™¨Aé…ç½®
æå››éƒ¨ç½² â†’ æœåŠ¡å™¨Bé…ç½®ï¼ˆå¯èƒ½ä¸ä¸€æ ·ï¼ï¼‰
ç‹äº”éƒ¨ç½² â†’ æœåŠ¡å™¨Cé…ç½®ï¼ˆåˆä¸ä¸€æ ·äº†ï¼ï¼‰

ç»“æœï¼šæ¯å°æœåŠ¡å™¨é…ç½®éƒ½ä¸åŒï¼Œéš¾ä»¥ç»´æŠ¤
```

**Playbookçš„ä¼˜åŠ¿**
```
è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼š
åŒä¸€ä¸ªplaybook.ymlæ–‡ä»¶
â”œâ”€ éƒ¨ç½²åˆ°æœåŠ¡å™¨A â†’ é…ç½®å®Œå…¨ä¸€è‡´
â”œâ”€ éƒ¨ç½²åˆ°æœåŠ¡å™¨B â†’ é…ç½®å®Œå…¨ä¸€è‡´  
â””â”€ éƒ¨ç½²åˆ°æœåŠ¡å™¨C â†’ é…ç½®å®Œå…¨ä¸€è‡´

ç»“æœï¼šæ‰€æœ‰æœåŠ¡å™¨é…ç½®æ ‡å‡†åŒ–ï¼Œæ˜“äºç»´æŠ¤
```

### 1.3 Playbookæ–‡ä»¶ç±»å‹


| æ–‡ä»¶å | ä½œç”¨ | **ä½¿ç”¨åœºæ™¯** |
|--------|------|-------------|
| ğŸ“„ `playbook.yml` | **é€šç”¨å‰§æœ¬æ–‡ä»¶** | `å•ä¸ªåº”ç”¨æˆ–æœåŠ¡çš„éƒ¨ç½²é…ç½®` |
| ğŸ“„ `site.yml` | **ç«™ç‚¹ä¸»å‰§æœ¬** | `æ•´ä¸ªç½‘ç«™æˆ–ç³»ç»Ÿçš„å®Œæ•´éƒ¨ç½²` |
| ğŸ“„ `webserver.yml` | **ä¸“ç”¨å‰§æœ¬** | `ç‰¹å®šæœåŠ¡ï¼ˆå¦‚WebæœåŠ¡å™¨ï¼‰çš„é…ç½®` |

---

## 2. ğŸ“‹ PlaybookåŸºç¡€ç»“æ„


### 2.1 æœ€ç®€å•çš„Playbookç»“æ„


```yaml
---
# è¿™æ˜¯ä¸€ä¸ªæœ€åŸºç¡€çš„Playbookç¤ºä¾‹
- name: æˆ‘çš„ç¬¬ä¸€ä¸ªPlaybook          # å‰§æœ¬åç§°ï¼ˆå¯é€‰ä½†å»ºè®®åŠ ä¸Šï¼‰
  hosts: webservers                  # ç›®æ ‡ä¸»æœºç»„
  tasks:                            # ä»»åŠ¡åˆ—è¡¨
    - name: ç¡®ä¿nginxå·²å®‰è£…          # ä»»åŠ¡åç§°  
      yum:                          # ä½¿ç”¨yumæ¨¡å—
        name: nginx                 # è½¯ä»¶åŒ…åç§°
        state: present              # ç¡®ä¿å·²å®‰è£…
```

**ğŸ” ç»“æ„è§£æ**
```
YAMLæ–‡ä»¶ç»“æ„å›¾ï¼š
playbook.yml
â”œâ”€ name: å‰§æœ¬åç§° (å¯é€‰)
â”œâ”€ hosts: ç›®æ ‡ä¸»æœºç»„ (å¿…éœ€)
â”œâ”€ vars: å˜é‡å®šä¹‰ (å¯é€‰)
â”œâ”€ tasks: ä»»åŠ¡åˆ—è¡¨ (å¿…éœ€)
â”‚   â”œâ”€ name: ä»»åŠ¡1åç§°
â”‚   â”œâ”€ æ¨¡å—å: æ¨¡å—å‚æ•°
â”‚   â”œâ”€ name: ä»»åŠ¡2åç§°  
â”‚   â””â”€ æ¨¡å—å: æ¨¡å—å‚æ•°
â””â”€ handlers: å¤„ç†ç¨‹åº (å¯é€‰)
```

### 2.2 å®Œæ•´ç»“æ„ç¤ºä¾‹


```yaml
---
# å®Œæ•´çš„Playbookç»“æ„ç¤ºä¾‹
- name: éƒ¨ç½²WebæœåŠ¡å™¨                # å‰§æœ¬æè¿°
  hosts: webservers                  # ç›®æ ‡ä¸»æœºç»„
  become: yes                        # æå‡æƒé™
  gather_facts: yes                  # æ”¶é›†ä¸»æœºä¿¡æ¯
  
  vars:                             # å®šä¹‰å˜é‡
    nginx_port: 80
    app_name: "my-website"
  
  vars_files:                       # å¤–éƒ¨å˜é‡æ–‡ä»¶
    - "vars/main.yml"
    - "vars/{{ ansible_os_family }}.yml"
  
  pre_tasks:                        # å‰ç½®ä»»åŠ¡
    - name: æ›´æ–°åŒ…ç®¡ç†å™¨ç¼“å­˜
      yum:
        update_cache: yes
  
  tasks:                           # ä¸»è¦ä»»åŠ¡
    - name: å®‰è£…nginx
      yum:
        name: nginx
        state: present
      notify: é‡å¯nginxæœåŠ¡         # è§¦å‘å¤„ç†ç¨‹åº
  
  handlers:                        # å¤„ç†ç¨‹åº
    - name: é‡å¯nginxæœåŠ¡
      service:
        name: nginx
        state: restarted
  
  post_tasks:                      # åç½®ä»»åŠ¡
    - name: éªŒè¯æœåŠ¡çŠ¶æ€
      service:
        name: nginx
        state: started
```

---

## 3. ğŸ¯ æ ¸å¿ƒé…ç½®é¡¹è¯¦è§£


### 3.1 hosts - ç›®æ ‡ä¸»æœºé…ç½®


**ğŸ”¸ åŸºæœ¬ç”¨æ³•**
```yaml
# æ–¹å¼1ï¼šæŒ‡å®šä¸»æœºç»„
hosts: webservers

# æ–¹å¼2ï¼šæŒ‡å®šå¤šä¸ªä¸»æœºç»„  
hosts: webservers:dbservers

# æ–¹å¼3ï¼šæŒ‡å®šå…·ä½“IP
hosts: 192.168.1.10

# æ–¹å¼4ï¼šæ‰€æœ‰ä¸»æœº
hosts: all

# æ–¹å¼5ï¼šæ’é™¤æŸäº›ä¸»æœº
hosts: all:!production
```

**ğŸ” ä¸»æœºç»„åŒ¹é…æ¨¡å¼**
```
webservers          â†’ ç²¾ç¡®åŒ¹é…webserversç»„
web*               â†’ åŒ¹é…ä»¥webå¼€å¤´çš„æ‰€æœ‰ç»„  
webservers[0]      â†’ webserversç»„çš„ç¬¬ä¸€å°ä¸»æœº
webservers[0:2]    â†’ webserversç»„çš„å‰3å°ä¸»æœº
~(web|db).*        â†’ æ­£åˆ™åŒ¹é…webæˆ–dbå¼€å¤´çš„ç»„
```

### 3.2 become - æƒé™æå‡é…ç½®


**ğŸ”’ æƒé™æå‡çš„é‡è¦æ€§**
```
ä¸ºä»€ä¹ˆéœ€è¦æƒé™æå‡ï¼Ÿ

æ™®é€šç”¨æˆ·æƒé™ï¼š
âŒ ä¸èƒ½å®‰è£…è½¯ä»¶åŒ…
âŒ ä¸èƒ½ä¿®æ”¹ç³»ç»Ÿé…ç½®  
âŒ ä¸èƒ½å¯åœç³»ç»ŸæœåŠ¡
âŒ ä¸èƒ½è®¿é—®æ•æ„Ÿæ–‡ä»¶

rootæƒé™ï¼š
âœ… å¯ä»¥å®‰è£…è½¯ä»¶åŒ…
âœ… å¯ä»¥ä¿®æ”¹ç³»ç»Ÿé…ç½®
âœ… å¯ä»¥ç®¡ç†ç³»ç»ŸæœåŠ¡
âœ… å¯ä»¥è®¿é—®æ‰€æœ‰æ–‡ä»¶
```

**æƒé™æå‡é…ç½®é€‰é¡¹**
```yaml
# åŸºç¡€é…ç½®
become: yes                    # å¯ç”¨æƒé™æå‡
become_method: sudo           # æå‡æ–¹å¼ï¼ˆé»˜è®¤sudoï¼‰
become_user: root            # æå‡åˆ°å“ªä¸ªç”¨æˆ·ï¼ˆé»˜è®¤rootï¼‰
become_flags: '-H -S -n'     # sudoå‚æ•°

# å®é™…åº”ç”¨ç¤ºä¾‹
- name: å®‰è£…è½¯ä»¶éœ€è¦rootæƒé™
  hosts: servers
  become: yes                 # æ•´ä¸ªplayéƒ½ä½¿ç”¨sudo
  tasks:
    - name: å®‰è£…nginx
      yum:
        name: nginx
        state: present
    
    - name: åˆ›å»ºæ™®é€šç”¨æˆ·æ–‡ä»¶
      copy:
        content: "hello world"
        dest: /home/user/test.txt
      become: no              # è¿™ä¸ªä»»åŠ¡ä¸éœ€è¦sudo
```

### 3.3 gather_facts - ç³»ç»Ÿä¿¡æ¯æ”¶é›†


**ğŸ” ä»€ä¹ˆæ˜¯Facts**
```
Facts = ç›®æ ‡ä¸»æœºçš„ç³»ç»Ÿä¿¡æ¯
åŒ…æ‹¬ï¼š
- æ“ä½œç³»ç»Ÿç±»å‹å’Œç‰ˆæœ¬
- CPUã€å†…å­˜ä¿¡æ¯  
- ç½‘ç»œé…ç½®
- ç£ç›˜ä½¿ç”¨æƒ…å†µ
- ç¯å¢ƒå˜é‡ç­‰

ç±»ä¼¼äºï¼šç»™ä¸»æœºåšä¸ª"ä½“æ£€æŠ¥å‘Š"
```

**gather_factsé…ç½®**
```yaml
# æ”¶é›†ç³»ç»Ÿä¿¡æ¯ï¼ˆé»˜è®¤å¼€å¯ï¼‰
gather_facts: yes

# ä¸æ”¶é›†ç³»ç»Ÿä¿¡æ¯ï¼ˆæé«˜æ‰§è¡Œé€Ÿåº¦ï¼‰
gather_facts: no

# ä½¿ç”¨æ”¶é›†åˆ°çš„ä¿¡æ¯
- name: æ ¹æ®æ“ä½œç³»ç»Ÿå®‰è£…è½¯ä»¶åŒ…
  hosts: all
  gather_facts: yes
  tasks:
    - name: åœ¨CentOSä¸Šå®‰è£…httpd
      yum:
        name: httpd
        state: present
      when: ansible_os_family == "RedHat"    # ä½¿ç”¨factså˜é‡
    
    - name: åœ¨Ubuntuä¸Šå®‰è£…apache2  
      apt:
        name: apache2
        state: present
      when: ansible_os_family == "Debian"
```

---

## 4. ğŸ“¦ å˜é‡å®šä¹‰ä¸ä½¿ç”¨


### 4.1 vars - ç›´æ¥å˜é‡å®šä¹‰


> ğŸ’¡ **å˜é‡å°±åƒç¼–ç¨‹ä¸­çš„"å¸¸é‡"**
> 
> æŠŠç»å¸¸å˜åŒ–çš„å€¼ï¼ˆå¦‚ç«¯å£å·ã€è·¯å¾„ã€ç‰ˆæœ¬å·ï¼‰å®šä¹‰æˆå˜é‡ï¼Œè¿™æ ·ä¿®æ”¹æ—¶åªéœ€è¦æ”¹ä¸€ä¸ªåœ°æ–¹ï¼Œè€Œä¸æ˜¯æ»¡æ–‡ä»¶æ‰¾

**åŸºç¡€å˜é‡å®šä¹‰**
```yaml
- name: ä½¿ç”¨å˜é‡çš„ç¤ºä¾‹
  hosts: webservers
  vars:
    # å­—ç¬¦ä¸²å˜é‡
    app_name: "my-awesome-app"
    
    # æ•°å­—å˜é‡
    nginx_port: 80
    worker_processes: 4
    
    # å¸ƒå°”å˜é‡
    enable_ssl: true
    debug_mode: false
    
    # åˆ—è¡¨å˜é‡
    packages:
      - nginx
      - mysql-server
      - php
    
    # å­—å…¸å˜é‡
    database:
      host: "localhost"
      port: 3306
      name: "myapp"
      user: "appuser"
  
  tasks:
    - name: å®‰è£…è½¯ä»¶åŒ…
      yum:
        name: "{{ packages }}"        # ä½¿ç”¨åˆ—è¡¨å˜é‡
        state: present
    
    - name: é…ç½®nginxç«¯å£
      lineinfile:
        path: /etc/nginx/nginx.conf
        regexp: 'listen\s+\d+'
        line: "listen {{ nginx_port }};"    # ä½¿ç”¨å˜é‡
```

### 4.2 vars_files - å¤–éƒ¨å˜é‡æ–‡ä»¶


**ğŸ”¸ ä¸ºä»€ä¹ˆä½¿ç”¨å¤–éƒ¨å˜é‡æ–‡ä»¶ï¼Ÿ**
```
é—®é¢˜åœºæ™¯ï¼š
å¼€å‘ç¯å¢ƒ â†’ æ•°æ®åº“ç«¯å£3306ï¼Œè°ƒè¯•æ¨¡å¼å¼€å¯
æµ‹è¯•ç¯å¢ƒ â†’ æ•°æ®åº“ç«¯å£3307ï¼Œè°ƒè¯•æ¨¡å¼å¼€å¯  
ç”Ÿäº§ç¯å¢ƒ â†’ æ•°æ®åº“ç«¯å£3306ï¼Œè°ƒè¯•æ¨¡å¼å…³é—­

ä¼ ç»Ÿæ–¹å¼ï¼šéœ€è¦3ä¸ªä¸åŒçš„playbookæ–‡ä»¶
å¤–éƒ¨å˜é‡ï¼šåªéœ€1ä¸ªplaybook + 3ä¸ªå˜é‡æ–‡ä»¶
```

**æ–‡ä»¶ç»“æ„ç¤ºä¾‹**
```
project/
â”œâ”€ ğŸ“„ playbook.yml          # ä¸»å‰§æœ¬æ–‡ä»¶
â”œâ”€ ğŸ“ vars/                 # å˜é‡æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€ ğŸ“„ common.yml        # é€šç”¨å˜é‡
â”‚   â”œâ”€ ğŸ“„ development.yml   # å¼€å‘ç¯å¢ƒå˜é‡
â”‚   â”œâ”€ ğŸ“„ production.yml    # ç”Ÿäº§ç¯å¢ƒå˜é‡
â”‚   â””â”€ ğŸ“„ RedHat.yml        # RedHatç³»ç»Ÿä¸“ç”¨å˜é‡
â””â”€ ğŸ“ group_vars/           # ä¸»æœºç»„å˜é‡ç›®å½•
    â”œâ”€ ğŸ“„ webservers.yml
    â””â”€ ğŸ“„ dbservers.yml
```

**å®é™…ä½¿ç”¨ç¤ºä¾‹**
```yaml
# playbook.yml - ä¸»æ–‡ä»¶
---
- name: å¤šç¯å¢ƒéƒ¨ç½²
  hosts: "{{ target_hosts }}"
  vars_files:
    - "vars/common.yml"                    # é€šç”¨å˜é‡
    - "vars/{{ env }}.yml"                 # ç¯å¢ƒç‰¹å®šå˜é‡
    - "vars/{{ ansible_os_family }}.yml"  # ç³»ç»Ÿç‰¹å®šå˜é‡
  
  tasks:
    - name: åˆ›å»ºåº”ç”¨ç›®å½•
      file:
        path: "{{ app_path }}"
        state: directory

# vars/common.yml - é€šç”¨å˜é‡
app_name: "myapp"
log_level: "info"

# vars/development.yml - å¼€å‘ç¯å¢ƒ
app_path: "/opt/myapp-dev"
database_host: "dev-db.company.com"
debug: true

# vars/production.yml - ç”Ÿäº§ç¯å¢ƒ  
app_path: "/opt/myapp"
database_host: "prod-db.company.com"
debug: false
```

**ğŸš€ ä½¿ç”¨å‘½ä»¤**
```bash
# éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ
ansible-playbook -i inventory playbook.yml -e "env=development target_hosts=dev-servers"

# éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
ansible-playbook -i inventory playbook.yml -e "env=production target_hosts=prod-servers"
```

---

## 5. ğŸ”§ ä»»åŠ¡ä¸å¤„ç†ç¨‹åº


### 5.1 tasks - ä»»åŠ¡åˆ—è¡¨è¯¦è§£


**ğŸ”¸ ä»»åŠ¡çš„æœ¬è´¨**
```
ä»»åŠ¡ = è¦æ‰§è¡Œçš„æ“ä½œ
æ¯ä¸ªä»»åŠ¡ = è°ƒç”¨ä¸€ä¸ªAnsibleæ¨¡å—æ¥å®Œæˆç‰¹å®šå·¥ä½œ

ç±»æ¯”ç†è§£ï¼š
ä»»åŠ¡åˆ—è¡¨ = å·¥ä½œæ¸…å•
æ¯ä¸ªä»»åŠ¡ = æ¸…å•ä¸Šçš„ä¸€é¡¹å·¥ä½œ
Ansible = æŒ‰æ¸…å•é€é¡¹å®Œæˆå·¥ä½œçš„åŠ©æ‰‹
```

**åŸºç¡€ä»»åŠ¡æ ¼å¼**
```yaml
tasks:
  - name: ä»»åŠ¡æè¿°ï¼ˆå¼ºçƒˆå»ºè®®å†™ï¼Œä¾¿äºè°ƒè¯•ï¼‰
    æ¨¡å—å:                    # å¦‚yumã€copyã€serviceç­‰
      å‚æ•°1: å€¼1
      å‚æ•°2: å€¼2
    register: ç»“æœå˜é‡å       # å¯é€‰ï¼šä¿å­˜ä»»åŠ¡ç»“æœ
    when: æ¡ä»¶è¡¨è¾¾å¼          # å¯é€‰ï¼šæ¡ä»¶æ‰§è¡Œ
    tags:                    # å¯é€‰ï¼šä»»åŠ¡æ ‡ç­¾
      - tag1
      - tag2
```

**å®é™…ä»»åŠ¡ç¤ºä¾‹**
```yaml
tasks:
  # æ–‡ä»¶æ“ä½œä»»åŠ¡
  - name: åˆ›å»ºé…ç½®æ–‡ä»¶
    copy:
      content: |
        server {
          listen {{ nginx_port }};
          server_name {{ server_name }};
        }
      dest: /etc/nginx/conf.d/{{ app_name }}.conf
      owner: nginx
      group: nginx
      mode: '0644'
    notify: é‡æ–°åŠ è½½nginx
  
  # æœåŠ¡ç®¡ç†ä»»åŠ¡
  - name: å¯åŠ¨å¹¶è®¾ç½®nginxå¼€æœºè‡ªå¯
    service:
      name: nginx
      state: started
      enabled: yes
  
  # å‘½ä»¤æ‰§è¡Œä»»åŠ¡  
  - name: æ£€æŸ¥nginxé…ç½®è¯­æ³•
    command: nginx -t
    register: nginx_syntax_check
    changed_when: false        # è¯¥å‘½ä»¤ä¸ä¼šæ”¹å˜ç³»ç»ŸçŠ¶æ€
  
  # æ¡ä»¶æ‰§è¡Œä»»åŠ¡
  - name: æ˜¾ç¤ºé…ç½®æ£€æŸ¥ç»“æœ
    debug:
      msg: "nginxé…ç½®è¯­æ³•æ£€æŸ¥é€šè¿‡"
    when: nginx_syntax_check.rc == 0
```

### 5.2 handlers - å¤„ç†ç¨‹åºè¯¦è§£


**ğŸ”¸ ä»€ä¹ˆæ˜¯Handlerï¼Ÿ**
```
Handler = äº‹ä»¶å¤„ç†ç¨‹åº
ç±»ä¼¼äºç¼–ç¨‹ä¸­çš„"äº‹ä»¶ç›‘å¬å™¨"

å·¥ä½œåŸç†ï¼š
1. ä»»åŠ¡æ‰§è¡Œæ—¶å¯ä»¥"é€šçŸ¥"(notify)ä¸€ä¸ªhandler
2. Handleråªæœ‰åœ¨è¢«é€šçŸ¥æ—¶æ‰ä¼šæ‰§è¡Œ
3. ç›¸åŒçš„handleråœ¨ä¸€æ¬¡playbookè¿è¡Œä¸­åªä¼šæ‰§è¡Œä¸€æ¬¡
4. Handleræ€»æ˜¯åœ¨æ‰€æœ‰ä»»åŠ¡å®Œæˆåæ‰æ‰§è¡Œ
```

**ğŸ“Š Handleræ‰§è¡Œæ—¶åºå›¾**
```
æ‰§è¡Œæµç¨‹ï¼š
ä»»åŠ¡1 â”€â”€notifyâ”€â”€â”
ä»»åŠ¡2 â”€â”€notifyâ”€â”€â”¼â”€â†’ Handler Queue
ä»»åŠ¡3           â”‚
ä»»åŠ¡4 â”€â”€notifyâ”€â”€â”˜
      â†“
  æ‰€æœ‰ä»»åŠ¡å®Œæˆ
      â†“  
  æ‰§è¡Œæ‰€æœ‰Handlerï¼ˆå»é‡ï¼‰
```

**Handlerå®é™…åº”ç”¨**
```yaml
# é…ç½®æ–‡ä»¶å˜æ›´åé‡å¯æœåŠ¡çš„å…¸å‹åœºæ™¯
tasks:
  - name: æ›´æ–°nginxä¸»é…ç½®æ–‡ä»¶
    template:
      src: nginx.conf.j2
      dest: /etc/nginx/nginx.conf
    notify:
      - æ£€æŸ¥nginxé…ç½®
      - é‡å¯nginxæœåŠ¡
  
  - name: æ›´æ–°è™šæ‹Ÿä¸»æœºé…ç½®
    template:
      src: vhost.conf.j2  
      dest: /etc/nginx/conf.d/{{ item }}.conf
    loop:
      - site1
      - site2
    notify:
      - æ£€æŸ¥nginxé…ç½®
      - é‡å¯nginxæœåŠ¡        # å³ä½¿å¤šæ¬¡notifyï¼Œä¹Ÿåªæ‰§è¡Œä¸€æ¬¡

handlers:
  - name: æ£€æŸ¥nginxé…ç½®
    command: nginx -t
    
  - name: é‡å¯nginxæœåŠ¡
    service:
      name: nginx
      state: restarted
    listen: "é‡å¯webæœåŠ¡"     # å¯é€‰ï¼šç›‘å¬åˆ«å

# ä½¿ç”¨ç›‘å¬åˆ«åçš„æ–¹å¼
  - name: æ›´æ–°é…ç½®æ–‡ä»¶
    copy:
      src: app.conf
      dest: /etc/app.conf  
    notify: "é‡å¯webæœåŠ¡"     # é€šè¿‡åˆ«åè§¦å‘handler
```

### 5.3 pre_tasks å’Œ post_tasks


**ğŸ”¸ ä»»åŠ¡æ‰§è¡Œé¡ºåº**
```
å®Œæ•´æ‰§è¡Œé¡ºåºï¼š
1. pre_tasks     (å‰ç½®ä»»åŠ¡)
   â†“
2. handlers      (å‰ç½®ä»»åŠ¡è§¦å‘çš„å¤„ç†ç¨‹åº)
   â†“  
3. roles         (è§’è‰²ä»»åŠ¡ï¼Œå¦‚æœæœ‰)
   â†“
4. tasks         (ä¸»è¦ä»»åŠ¡)
   â†“
5. post_tasks    (åç½®ä»»åŠ¡)  
   â†“
6. handlers      (ä¸»è¦ä»»åŠ¡å’Œåç½®ä»»åŠ¡è§¦å‘çš„å¤„ç†ç¨‹åº)
```

**å®é™…åº”ç”¨åœºæ™¯**
```yaml
- name: åº”ç”¨éƒ¨ç½²æµç¨‹
  hosts: webservers
  
  pre_tasks:                    # éƒ¨ç½²å‰å‡†å¤‡
    - name: åœæ­¢åº”ç”¨æœåŠ¡
      service:
        name: myapp
        state: stopped
    
    - name: å¤‡ä»½å½“å‰ç‰ˆæœ¬
      archive:
        path: /opt/myapp
        dest: /backup/myapp-{{ ansible_date_time.date }}.tar.gz
  
  tasks:                       # ä¸»è¦éƒ¨ç½²ä»»åŠ¡
    - name: éƒ¨ç½²æ–°ç‰ˆæœ¬
      unarchive:
        src: myapp-v2.0.tar.gz
        dest: /opt/myapp
    
    - name: æ›´æ–°é…ç½®æ–‡ä»¶
      template:
        src: config.j2
        dest: /opt/myapp/config.yml
  
  post_tasks:                  # éƒ¨ç½²åéªŒè¯
    - name: å¯åŠ¨åº”ç”¨æœåŠ¡
      service:
        name: myapp
        state: started
    
    - name: ç­‰å¾…æœåŠ¡å¯åŠ¨
      wait_for:
        port: 8080
        delay: 10
    
    - name: å¥åº·æ£€æŸ¥
      uri:
        url: "http://{{ inventory_hostname }}:8080/health"
        method: GET
      register: health_check
    
    - name: éªŒè¯éƒ¨ç½²æˆåŠŸ
      debug:
        msg: "åº”ç”¨éƒ¨ç½²æˆåŠŸï¼Œå¥åº·æ£€æŸ¥é€šè¿‡"
      when: health_check.status == 200
```

---

## 6. âš™ï¸ æƒé™ä¸æ‰§è¡Œæ§åˆ¶


### 6.1 become æƒé™æå‡è¿›é˜¶


**ğŸ”’ å¤šå±‚çº§æƒé™æ§åˆ¶**
```yaml
# Playçº§åˆ«æƒé™è®¾ç½®
- name: ç³»ç»Ÿç®¡ç†ä»»åŠ¡
  hosts: servers
  become: yes                # æ•´ä¸ªplayä½¿ç”¨sudo
  become_user: root         # æå‡åˆ°rootç”¨æˆ·
  
  tasks:
    - name: å®‰è£…ç³»ç»Ÿè½¯ä»¶ï¼ˆéœ€è¦rootæƒé™ï¼‰
      yum:
        name: htop
        state: present
      # ç»§æ‰¿playçº§åˆ«çš„becomeè®¾ç½®
    
    - name: åˆ›å»ºæ™®é€šç”¨æˆ·æ–‡ä»¶
      copy:
        content: "hello"
        dest: /tmp/test.txt  
      become: no            # ä»»åŠ¡çº§åˆ«ï¼šå–æ¶ˆæƒé™æå‡
    
    - name: ä»¥ç‰¹å®šç”¨æˆ·èº«ä»½æ‰§è¡Œ
      command: whoami
      become: yes
      become_user: nginx    # ä»»åŠ¡çº§åˆ«ï¼šæå‡åˆ°nginxç”¨æˆ·
      register: current_user
```

**æƒé™æå‡æ–¹æ³•å¯¹æ¯”**

| æ–¹æ³• | **é€‚ç”¨åœºæ™¯** | **å®‰å…¨æ€§** | **é…ç½®å¤æ‚åº¦** |
|------|-------------|-----------|--------------|
| ğŸ” `sudo` | **Linuxæ ‡å‡†æ–¹å¼** | `â­â­â­â­` | `ç®€å•` |
| ğŸ” `su` | **ä¼ ç»ŸUnixæ–¹å¼** | `â­â­â­` | `ç®€å•` |  
| ğŸ” `pbrun` | **ä¼ä¸šçº§æƒé™ç®¡ç†** | `â­â­â­â­â­` | `å¤æ‚` |
| ğŸ” `dzdo` | **Centrifyç¯å¢ƒ** | `â­â­â­â­` | `ä¸­ç­‰` |

### 6.2 serial - ä¸²è¡Œæ‰§è¡Œæ§åˆ¶


**ğŸ”¸ ä¸ºä»€ä¹ˆéœ€è¦ä¸²è¡Œæ‰§è¡Œï¼Ÿ**
```
å¹¶è¡Œæ‰§è¡Œé—®é¢˜ï¼š
â”œâ”€ æœåŠ¡å™¨Aï¼šæ­£åœ¨é‡å¯æ•°æ®åº“
â”œâ”€ æœåŠ¡å™¨Bï¼šæ­£åœ¨é‡å¯æ•°æ®åº“    â† åŒæ—¶é‡å¯ä¼šå¯¼è‡´æœåŠ¡å®Œå…¨ä¸å¯ç”¨  
â”œâ”€ æœåŠ¡å™¨Cï¼šæ­£åœ¨é‡å¯æ•°æ®åº“
â””â”€ æœåŠ¡å™¨Dï¼šæ­£åœ¨é‡å¯æ•°æ®åº“

ä¸²è¡Œæ‰§è¡Œè§£å†³ï¼š
â”œâ”€ æœåŠ¡å™¨Aï¼šé‡å¯å®Œæˆ âœ…
â”œâ”€ æœåŠ¡å™¨Bï¼šå¼€å§‹é‡å¯        â† ç¡®ä¿å§‹ç»ˆæœ‰æœåŠ¡å™¨åœ¨æä¾›æœåŠ¡
â”œâ”€ æœåŠ¡å™¨Cï¼šç­‰å¾…ä¸­
â””â”€ æœåŠ¡å™¨Dï¼šç­‰å¾…ä¸­
```

**serialé…ç½®é€‰é¡¹**
```yaml
# æ–¹å¼1ï¼šå›ºå®šæ•°é‡ä¸²è¡Œ
- name: æ»šåŠ¨æ›´æ–°æ•°æ®åº“
  hosts: database_servers
  serial: 1                    # æ¯æ¬¡åªæ“ä½œ1å°æœåŠ¡å™¨
  
  tasks:
    - name: åœæ­¢æ•°æ®åº“æœåŠ¡
      service:
        name: mysql
        state: stopped
    
    - name: å‡çº§æ•°æ®åº“
      yum:
        name: mysql-server
        state: latest
    
    - name: å¯åŠ¨æ•°æ®åº“æœåŠ¡
      service:
        name: mysql  
        state: started

# æ–¹å¼2ï¼šæŒ‰ç™¾åˆ†æ¯”ä¸²è¡Œ
- name: æ»šåŠ¨æ›´æ–°WebæœåŠ¡å™¨
  hosts: webservers
  serial: "25%"               # æ¯æ¬¡æ“ä½œ25%çš„æœåŠ¡å™¨
  
# æ–¹å¼3ï¼šåˆ†é˜¶æ®µä¸²è¡Œ
- name: åˆ†æ‰¹æ›´æ–°
  hosts: all_servers  
  serial:
    - 1                       # ç¬¬ä¸€æ‰¹ï¼š1å°æœåŠ¡å™¨
    - 25%                     # ç¬¬äºŒæ‰¹ï¼š25%çš„æœåŠ¡å™¨
    - 100%                    # ç¬¬ä¸‰æ‰¹ï¼šå‰©ä½™æ‰€æœ‰æœåŠ¡å™¨
```

### 6.3 strategy - æ‰§è¡Œç­–ç•¥


**ğŸ”¸ æ‰§è¡Œç­–ç•¥ç±»å‹**

**linear ç­–ç•¥ï¼ˆé»˜è®¤ï¼‰**
```
æ‰§è¡Œæ–¹å¼ï¼šæ‰€æœ‰ä¸»æœºåŒæ­¥æ‰§è¡Œæ¯ä¸ªä»»åŠ¡

ä¸»æœºA: [ä»»åŠ¡1] â†’ [ä»»åŠ¡2] â†’ [ä»»åŠ¡3] â†’ å®Œæˆ
ä¸»æœºB: [ä»»åŠ¡1] â†’ [ä»»åŠ¡2] â†’ [ä»»åŠ¡3] â†’ å®Œæˆ
ä¸»æœºC: [ä»»åŠ¡1] â†’ [ä»»åŠ¡2] â†’ [ä»»åŠ¡3] â†’ å®Œæˆ

ç‰¹ç‚¹ï¼šç­‰å¾…æœ€æ…¢çš„ä¸»æœºå®Œæˆå½“å‰ä»»åŠ¡ï¼Œæ‰å¼€å§‹ä¸‹ä¸€ä¸ªä»»åŠ¡
é€‚ç”¨ï¼šéœ€è¦ç¡®ä¿æ‰€æœ‰ä¸»æœºçŠ¶æ€ä¸€è‡´çš„åœºæ™¯
```

**free ç­–ç•¥**
```
æ‰§è¡Œæ–¹å¼ï¼šä¸»æœºç‹¬ç«‹æ‰§è¡Œï¼Œä¸ç­‰å¾…å…¶ä»–ä¸»æœº

ä¸»æœºA: [ä»»åŠ¡1] â†’ [ä»»åŠ¡2] â†’ [ä»»åŠ¡3] â†’ å®Œæˆ
ä¸»æœºB: [ä»»åŠ¡1] ------> [ä»»åŠ¡2] â†’ [ä»»åŠ¡3] â†’ å®Œæˆ  
ä¸»æœºC: [ä»»åŠ¡1] â†’ [ä»»åŠ¡2] â†’ [ä»»åŠ¡3] ---------> å®Œæˆ

ç‰¹ç‚¹ï¼šå„ä¸»æœºæŒ‰è‡ªå·±çš„èŠ‚å¥æ‰§è¡Œ
é€‚ç”¨ï¼šä¸»æœºé—´æ— ä¾èµ–å…³ç³»ï¼Œè¿½æ±‚æœ€å¤§æ‰§è¡Œæ•ˆç‡
```

**é…ç½®ç¤ºä¾‹**
```yaml
# ä½¿ç”¨freeç­–ç•¥åŠ å¿«æ‰§è¡Œ
- name: å¿«é€Ÿè½¯ä»¶å®‰è£…
  hosts: all
  strategy: free              # å„ä¸»æœºå¹¶å‘æ‰§è¡Œ
  
  tasks:
    - name: æ›´æ–°åŒ…ç¼“å­˜
      yum:
        update_cache: yes
    
    - name: å®‰è£…åŸºç¡€è½¯ä»¶
      yum:
        name: 
          - vim
          - git  
          - htop
        state: present

# ä½¿ç”¨linearç­–ç•¥ç¡®ä¿é¡ºåº
- name: æ•°æ®åº“é›†ç¾¤é…ç½®
  hosts: database_cluster
  strategy: linear            # ç¡®ä¿åŒæ­¥æ‰§è¡Œ
  
  tasks:
    - name: é…ç½®ä¸»ä»å…³ç³»
      mysql_replication:
        mode: changeprimary
        master_host: "{{ master_host }}"
```

---

## 7. ğŸ›ï¸ é«˜çº§é…ç½®ç­–ç•¥


### 7.1 max_fail_percentage - å¤±è´¥å®¹å¿åº¦


**ğŸ”¸ ä»€ä¹ˆæ˜¯å¤±è´¥ç™¾åˆ†æ¯”æ§åˆ¶ï¼Ÿ**
```
åœºæ™¯é—®é¢˜ï¼š
æœ‰10å°WebæœåŠ¡å™¨ï¼Œå¦‚æœå…¶ä¸­3å°éƒ¨ç½²å¤±è´¥äº†ï¼Œ
æ˜¯å¦åº”è¯¥ç»§ç»­åœ¨å‰©ä½™7å°ä¸Šéƒ¨ç½²ï¼Ÿ

ç­”æ¡ˆå–å†³äºä¸šåŠ¡éœ€æ±‚ï¼š
- å…³é”®ä¸šåŠ¡ï¼šå“ªæ€•1å°å¤±è´¥éƒ½è¦åœæ­¢ï¼Œæ£€æŸ¥é—®é¢˜
- ä¸€èˆ¬ä¸šåŠ¡ï¼šå°‘é‡å¤±è´¥å¯æ¥å—ï¼Œç»§ç»­éƒ¨ç½²å…¶ä»–æœåŠ¡å™¨
```

**é…ç½®ç¤ºä¾‹**
```yaml
# ä¸¥æ ¼æ¨¡å¼ï¼šä¸å…è®¸ä»»ä½•å¤±è´¥
- name: å…³é”®ä¸šåŠ¡éƒ¨ç½²
  hosts: critical_servers
  max_fail_percentage: 0      # 0%å¤±è´¥ç‡ï¼Œä»»ä½•å¤±è´¥éƒ½åœæ­¢
  
  tasks:
    - name: éƒ¨ç½²å…³é”®åº”ç”¨
      copy:
        src: critical-app.jar
        dest: /opt/app/

# å®¹é”™æ¨¡å¼ï¼šå…è®¸ä¸€å®šå¤±è´¥ç‡
- name: æ‰¹é‡è½¯ä»¶æ›´æ–°
  hosts: web_farm            # å‡è®¾æœ‰100å°WebæœåŠ¡å™¨
  max_fail_percentage: 10    # å…è®¸10%å¤±è´¥ç‡ï¼ˆå³10å°æœåŠ¡å™¨å¤±è´¥ï¼‰
  
  tasks:
    - name: æ›´æ–°WebæœåŠ¡å™¨è½¯ä»¶
      yum:
        name: httpd
        state: latest

# ç»“åˆserialä½¿ç”¨
- name: æ»šåŠ¨æ›´æ–°
  hosts: load_balanced_servers  
  serial: 2                   # æ¯æ‰¹2å°æœåŠ¡å™¨
  max_fail_percentage: 50     # æ¯æ‰¹å…è®¸50%å¤±è´¥ï¼ˆå³1å°å¤±è´¥ï¼‰
```

### 7.2 any_errors_fatal - å…¨å±€é”™è¯¯æ§åˆ¶


**ğŸ”¸ é”™è¯¯ä¼ æ’­æœºåˆ¶**
```yaml
# é»˜è®¤è¡Œä¸ºï¼šå•æœºå¤±è´¥ä¸å½±å“å…¶ä»–æœºå™¨
- name: é»˜è®¤é”™è¯¯å¤„ç†
  hosts: webservers
  # any_errors_fatal: false  # é»˜è®¤å€¼
  
  tasks:
    - name: å¯èƒ½å¤±è´¥çš„ä»»åŠ¡
      command: /bin/might-fail
      # å³ä½¿æŸå°æœåŠ¡å™¨æ‰§è¡Œå¤±è´¥ï¼Œå…¶ä»–æœåŠ¡å™¨ç»§ç»­æ‰§è¡Œ

# ä¸¥æ ¼æ¨¡å¼ï¼šä¸€å°å¤±è´¥ï¼Œå…¨éƒ¨åœæ­¢
- name: ä¸¥æ ¼é”™è¯¯å¤„ç†  
  hosts: database_cluster
  any_errors_fatal: true     # ä»»ä½•é”™è¯¯éƒ½æ˜¯è‡´å‘½çš„
  
  tasks:
    - name: æ•°æ®åº“schemaæ›´æ–°
      mysql_db:
        name: myapp
        state: import
        target: schema.sql
      # å¦‚æœä»»ä½•ä¸€å°æ•°æ®åº“æœåŠ¡å™¨å¤±è´¥ï¼Œæ‰€æœ‰æœåŠ¡å™¨éƒ½åœæ­¢æ‰§è¡Œ
```

**ğŸ¯ ä½¿ç”¨åœºæ™¯å»ºè®®**

| åœºæ™¯ç±»å‹ | **é…ç½®å»ºè®®** | **åŸå› ** |
|----------|-------------|----------|
| ğŸ¢ **æ•°æ®åº“é›†ç¾¤** | `any_errors_fatal: true` | `æ•°æ®ä¸€è‡´æ€§è¦æ±‚é«˜` |
| ğŸŒ **WebæœåŠ¡å™¨é›†ç¾¤** | `max_fail_percentage: 20` | `å…è®¸éƒ¨åˆ†å¤±è´¥ï¼Œä¿æŒæœåŠ¡å¯ç”¨` |
| ğŸ›¡ï¸ **å®‰å…¨æ›´æ–°** | `any_errors_fatal: true` | `å®‰å…¨è¡¥ä¸å¿…é¡»å…¨éƒ¨æˆåŠŸ` |
| ğŸ“¦ **è½¯ä»¶åˆ†å‘** | `max_fail_percentage: 10` | `å°‘é‡å¤±è´¥å¯åç»­ä¿®å¤` |

### 7.3 tags - æ ‡ç­¾ç³»ç»Ÿ


**ğŸ”¸ æ ‡ç­¾çš„ä½œç”¨**
```
æ ‡ç­¾ = ä»»åŠ¡åˆ†ç»„æ ‡è®°
ä½œç”¨ï¼šé€‰æ‹©æ€§æ‰§è¡Œéƒ¨åˆ†ä»»åŠ¡

å®é™…åœºæ™¯ï¼š
å®Œæ•´éƒ¨ç½²ï¼šå®‰è£…è½¯ä»¶ + é…ç½®æ–‡ä»¶ + å¯åŠ¨æœåŠ¡ + æµ‹è¯•
ä»…æ›´æ–°é…ç½®ï¼šè·³è¿‡å®‰è£…ï¼Œåªæ‰§è¡Œé…ç½®ç›¸å…³ä»»åŠ¡
ä»…é‡å¯æœåŠ¡ï¼šè·³è¿‡å®‰è£…å’Œé…ç½®ï¼Œåªé‡å¯æœåŠ¡
```

**æ ‡ç­¾ä½¿ç”¨ç¤ºä¾‹**
```yaml
- name: å®Œæ•´Webåº”ç”¨éƒ¨ç½²
  hosts: webservers
  
  tasks:
    - name: å®‰è£…nginx
      yum:
        name: nginx
        state: present
      tags:
        - install
        - packages
    
    - name: å®‰è£…PHP
      yum:
        name: php-fpm
        state: present  
      tags:
        - install
        - packages
        - php
    
    - name: é…ç½®nginxä¸»é…ç½®æ–‡ä»¶
      template:
        src: nginx.conf.j2
        dest: /etc/nginx/nginx.conf
      tags:
        - config
        - nginx-config
      notify: é‡å¯nginx
    
    - name: é…ç½®PHP-FPM
      template:
        src: php-fpm.conf.j2
        dest: /etc/php-fpm.conf
      tags:
        - config  
        - php-config
      notify: é‡å¯php-fpm
    
    - name: å¯åŠ¨æœåŠ¡
      service:
        name: "{{ item }}"
        state: started
        enabled: yes
      loop:
        - nginx
        - php-fpm
      tags:
        - service
        - start
    
    - name: è¿è¡Œæµ‹è¯•
      uri:
        url: "http://{{ inventory_hostname }}/test.php"
      tags:
        - test
        - verify

  handlers:
    - name: é‡å¯nginx
      service:
        name: nginx
        state: restarted
      tags:
        - service
    
    - name: é‡å¯php-fpm
      service:
        name: php-fpm
        state: restarted  
      tags:
        - service
```

**ğŸš€ æ ‡ç­¾æ‰§è¡Œå‘½ä»¤**
```bash
# å®Œæ•´éƒ¨ç½²
ansible-playbook site.yml

# åªæ‰§è¡Œå®‰è£…ä»»åŠ¡
ansible-playbook site.yml --tags "install"

# åªæ›´æ–°é…ç½®
ansible-playbook site.yml --tags "config"

# åªé‡å¯æœåŠ¡ï¼ˆåŒ…æ‹¬handlersï¼‰
ansible-playbook site.yml --tags "service"

# æ‰§è¡Œå¤šä¸ªæ ‡ç­¾
ansible-playbook site.yml --tags "config,service"

# è·³è¿‡æŸäº›æ ‡ç­¾
ansible-playbook site.yml --skip-tags "test"

# è·³è¿‡å®‰è£…ï¼Œåªæ‰§è¡Œé…ç½®å’ŒæœåŠ¡
ansible-playbook site.yml --skip-tags "install,test"
```

---

## 8. ğŸš€ å®æˆ˜é…ç½®ç¤ºä¾‹


### 8.1 å®Œæ•´çš„Webåº”ç”¨éƒ¨ç½²


```yaml
---
# ğŸ“„ site.yml - å®Œæ•´Webåº”ç”¨éƒ¨ç½²å‰§æœ¬
- name: ğŸŒ éƒ¨ç½²LAMPæ¶æ„Webåº”ç”¨
  hosts: webservers
  become: yes
  gather_facts: yes
  serial: "30%"                      # åˆ†æ‰¹éƒ¨ç½²ï¼Œé¿å…æœåŠ¡ä¸­æ–­
  max_fail_percentage: 20            # å…è®¸20%å¤±è´¥ç‡
  
  vars:
    app_name: "my-web-app"
    app_version: "v2.1.0"  
    web_port: 80
    ssl_port: 443
    
  vars_files:
    - "vars/{{ env }}.yml"           # ç¯å¢ƒç‰¹å®šå˜é‡
    - "vars/secrets.yml"             # æ•æ„Ÿä¿¡æ¯ï¼ˆå»ºè®®åŠ å¯†ï¼‰
  
  pre_tasks:
    - name: ğŸ” æ£€æŸ¥ç³»ç»Ÿè¦æ±‚
      assert:
        that:
          - ansible_memtotal_mb >= 1024
          - ansible_processor_vcpus >= 1
        fail_msg: "ç³»ç»Ÿä¸æ»¡è¶³æœ€ä½è¦æ±‚ï¼šå†…å­˜>=1GBï¼ŒCPU>=1æ ¸"
      tags: [pre-check]
    
    - name: ğŸ“‹ åˆ›å»ºéƒ¨ç½²æ—¥å¿—
      copy:
        content: |
          éƒ¨ç½²å¼€å§‹æ—¶é—´: {{ ansible_date_time.iso8601 }}
          æ“ä½œç”¨æˆ·: {{ ansible_user }}
          ç›®æ ‡ä¸»æœº: {{ inventory_hostname }}
          åº”ç”¨ç‰ˆæœ¬: {{ app_version }}
        dest: "/var/log/{{ app_name }}-deploy.log"
      tags: [logging]
  
  tasks:
    # è½¯ä»¶åŒ…å®‰è£…
    - name: ğŸ“¦ å®‰è£…WebæœåŠ¡å™¨è½¯ä»¶åŒ…
      yum:
        name:
          - httpd
          - php
          - php-mysql
          - mysql-server
        state: present
      tags: [install, packages]
    
    # é…ç½®æ–‡ä»¶ç®¡ç†
    - name: âš™ï¸ é…ç½®Apacheè™šæ‹Ÿä¸»æœº
      template:
        src: templates/vhost.conf.j2
        dest: "/etc/httpd/conf.d/{{ app_name }}.conf"
        backup: yes                  # è‡ªåŠ¨å¤‡ä»½åŸé…ç½®
      notify: 
        - æ£€æŸ¥Apacheé…ç½®
        - é‡æ–°åŠ è½½Apache
      tags: [config, apache]
    
    - name: ğŸ”’ é…ç½®SSLè¯ä¹¦
      copy:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        owner: root
        group: root
        mode: "{{ item.mode }}"
      loop:
        - { src: "certs/{{ app_name }}.crt", dest: "/etc/ssl/certs/{{ app_name }}.crt", mode: "0644" }
        - { src: "certs/{{ app_name }}.key", dest: "/etc/ssl/private/{{ app_name }}.key", mode: "0600" }
      when: enable_ssl | default(false)
      tags: [config, ssl]
    
    # åº”ç”¨éƒ¨ç½²  
    - name: ğŸš€ éƒ¨ç½²åº”ç”¨ä»£ç 
      unarchive:
        src: "releases/{{ app_name }}-{{ app_version }}.tar.gz"
        dest: "/var/www/html/"
        owner: apache
        group: apache
        creates: "/var/www/html/{{ app_name }}/index.php"
      tags: [deploy, code]
    
    - name: ğŸ”§ è®¾ç½®åº”ç”¨é…ç½®æ–‡ä»¶
      template:
        src: templates/app-config.php.j2  
        dest: "/var/www/html/{{ app_name }}/config.php"
        owner: apache
        group: apache
        mode: '0640'                 # é…ç½®æ–‡ä»¶åªæœ‰apacheç”¨æˆ·å¯è¯»
      tags: [deploy, config]
    
    # æ•°æ®åº“åˆå§‹åŒ–
    - name: ğŸ—„ï¸ å¯åŠ¨MySQLæœåŠ¡
      service:
        name: mysqld
        state: started
        enabled: yes
      tags: [database, service]
    
    - name: ğŸ—ï¸ åˆ›å»ºåº”ç”¨æ•°æ®åº“
      mysql_db:
        name: "{{ db_name }}"
        state: present
      tags: [database, init]
    
    - name: ğŸ‘¤ åˆ›å»ºæ•°æ®åº“ç”¨æˆ·
      mysql_user:
        name: "{{ db_user }}"
        password: "{{ db_password }}"
        priv: "{{ db_name }}.*:ALL"
        state: present
      no_log: yes                    # ä¸è®°å½•å¯†ç åˆ°æ—¥å¿—
      tags: [database, user]
  
  handlers:
    - name: æ£€æŸ¥Apacheé…ç½®
      command: httpd -t
      changed_when: false
      
    - name: é‡æ–°åŠ è½½Apache
      service:
        name: httpd
        state: reloaded
    
    - name: é‡å¯Apache
      service:
        name: httpd
        state: restarted
      listen: "é‡å¯webæœåŠ¡"
  
  post_tasks:
    - name: ğŸŒ å¯åŠ¨WebæœåŠ¡
      service:
        name: httpd
        state: started
        enabled: yes
      tags: [service]
    
    - name: â³ ç­‰å¾…æœåŠ¡å¯åŠ¨
      wait_for:
        port: "{{ web_port }}"
        delay: 5
        timeout: 30
      tags: [verify]
    
    - name: ğŸ” å¥åº·æ£€æŸ¥
      uri:
        url: "http://{{ inventory_hostname }}/{{ app_name }}/health.php"
        status_code: 200
      register: health_check
      retries: 3
      delay: 10
      tags: [verify, test]
    
    - name: âœ… éƒ¨ç½²æˆåŠŸé€šçŸ¥
      debug:
        msg: |
          ğŸ‰ {{ app_name }} {{ app_version }} éƒ¨ç½²æˆåŠŸï¼
          è®¿é—®åœ°å€: http://{{ inventory_hostname }}/{{ app_name }}
          å¥åº·çŠ¶æ€: {{ health_check.status }}
      when: health_check.status == 200
      tags: [notify]
```

### 8.2 é…å¥—å˜é‡æ–‡ä»¶


```yaml
# ğŸ“„ vars/production.yml - ç”Ÿäº§ç¯å¢ƒå˜é‡
---
env: "production"
enable_ssl: true
web_port: 80  
ssl_port: 443

# æ•°æ®åº“é…ç½®
db_host: "prod-db.company.com"
db_name: "myapp_prod"
db_user: "app_user"

# æ€§èƒ½é…ç½®
apache_max_clients: 150
php_memory_limit: "256M"

# æ—¥å¿—çº§åˆ«
log_level: "error"
debug_mode: false

# ğŸ“„ vars/development.yml - å¼€å‘ç¯å¢ƒå˜é‡  
---
env: "development"
enable_ssl: false
web_port: 8080

# æ•°æ®åº“é…ç½®
db_host: "localhost"
db_name: "myapp_dev" 
db_user: "dev_user"

# æ€§èƒ½é…ç½®
apache_max_clients: 50
php_memory_limit: "512M"

# æ—¥å¿—çº§åˆ«
log_level: "debug"
debug_mode: true
```

### 8.3 æ¨¡æ¿æ–‡ä»¶ç¤ºä¾‹


```apache
# ğŸ“„ templates/vhost.conf.j2 - Apacheè™šæ‹Ÿä¸»æœºæ¨¡æ¿
<VirtualHost *:{{ web_port }}>
    ServerName {{ server_name | default(inventory_hostname) }}
    DocumentRoot /var/www/html/{{ app_name }}
    
    # æ—¥å¿—é…ç½®
    ErrorLog /var/log/httpd/{{ app_name }}_error.log
    CustomLog /var/log/httpd/{{ app_name }}_access.log combined
    LogLevel {{ log_level }}
    
    # PHPé…ç½®
    <Directory "/var/www/html/{{ app_name }}">
        AllowOverride All
        Require all granted
        
        # å¼€å‘ç¯å¢ƒæ˜¾ç¤ºé”™è¯¯
        {% if debug_mode %}
        php_flag display_errors on
        php_value error_reporting "E_ALL"
        {% endif %}
    </Directory>
    
    # SSLé…ç½®ï¼ˆå¦‚æœå¯ç”¨ï¼‰
    {% if enable_ssl %}
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/{{ app_name }}.crt
    SSLCertificateKeyFile /etc/ssl/private/{{ app_name }}.key
    {% endif %}
</VirtualHost>

{% if enable_ssl %}
# HTTPSé‡å®šå‘
<VirtualHost *:80>
    ServerName {{ server_name | default(inventory_hostname) }}
    Redirect permanent / https://{{ server_name | default(inventory_hostname) }}/
</VirtualHost>
{% endif %}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ”¸ Playbookæœ¬è´¨ï¼šç»™æœåŠ¡å™¨çš„"æ“ä½œæ‰‹å†Œ"ï¼Œæ ‡å‡†åŒ–éƒ¨ç½²æµç¨‹
ğŸ”¸ YAMLè¯­æ³•ï¼šç¼©è¿›æ•æ„Ÿï¼Œç”¨ç©ºæ ¼ä¸ç”¨Tabï¼Œæ³¨æ„è¯­æ³•è§„èŒƒ
ğŸ”¸ æ¨¡å—åŒ–æ€ç»´ï¼šæ¯ä¸ªä»»åŠ¡è°ƒç”¨ä¸€ä¸ªæ¨¡å—å®Œæˆç‰¹å®šåŠŸèƒ½
ğŸ”¸ å¹‚ç­‰æ€§åŸç†ï¼šå¤šæ¬¡æ‰§è¡Œç›¸åŒç»“æœï¼ŒAnsibleè‡ªåŠ¨åˆ¤æ–­æ˜¯å¦éœ€è¦æ”¹å˜
ğŸ”¸ å˜é‡çµæ´»è¿ç”¨ï¼šæé«˜é…ç½®å¤ç”¨æ€§ï¼Œæ”¯æŒå¤šç¯å¢ƒéƒ¨ç½²
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ Playbookè®¾è®¡æ€è·¯**
```
å±‚æ¬¡åŒ–è®¾è®¡ï¼š
â”œâ”€ Playçº§åˆ«ï¼šå®šä¹‰ä½œç”¨èŒƒå›´ï¼ˆå“ªäº›ä¸»æœºï¼‰
â”œâ”€ Taskçº§åˆ«ï¼šå…·ä½“æ“ä½œæ­¥éª¤ï¼ˆåšä»€ä¹ˆäº‹ï¼‰
â”œâ”€ Moduleçº§åˆ«ï¼šæ‰§è¡Œå·¥å…·ï¼ˆæ€ä¹ˆåšï¼‰
â””â”€ Handlerçº§åˆ«ï¼šäº‹ä»¶å“åº”ï¼ˆåç»­å¤„ç†ï¼‰

å®é™…åº”ç”¨ï¼š
å…ˆæ•´ä½“è§„åˆ’ â†’ å†åˆ†è§£ä»»åŠ¡ â†’ æœ€åä¼˜åŒ–ç»†èŠ‚
```

**ğŸ”¹ å˜é‡ä½¿ç”¨æœ€ä½³å®è·µ**
```
å˜é‡åˆ†å±‚ç®¡ç†ï¼š
â”œâ”€ å…¨å±€å˜é‡ï¼šæ‰€æœ‰ç¯å¢ƒé€šç”¨ï¼ˆå¦‚åº”ç”¨åç§°ï¼‰
â”œâ”€ ç¯å¢ƒå˜é‡ï¼šç‰¹å®šç¯å¢ƒä¸“ç”¨ï¼ˆå¦‚æ•°æ®åº“åœ°å€ï¼‰  
â”œâ”€ ä¸»æœºç»„å˜é‡ï¼šç‰¹å®šæœåŠ¡å™¨ç»„ä¸“ç”¨ï¼ˆå¦‚ç«¯å£é…ç½®ï¼‰
â””â”€ ä¸»æœºå˜é‡ï¼šå•ä¸ªæœåŠ¡å™¨ä¸“ç”¨ï¼ˆå¦‚IPåœ°å€ï¼‰

ä¼˜å…ˆçº§ï¼šå‘½ä»¤è¡Œå˜é‡ > ä»»åŠ¡å˜é‡ > ä¸»æœºå˜é‡ > ç»„å˜é‡
```

**ğŸ”¹ é”™è¯¯å¤„ç†ç­–ç•¥**
```
å®¹é”™çº§åˆ«é€‰æ‹©ï¼š
ä¸¥æ ¼æ¨¡å¼ï¼šany_errors_fatal=trueï¼ˆæ•°æ®åº“ã€å®‰å…¨æ›´æ–°ï¼‰
å®¹é”™æ¨¡å¼ï¼šmax_fail_percentage=10%ï¼ˆæ‰¹é‡éƒ¨ç½²ï¼‰
å¿½ç•¥æ¨¡å¼ï¼šignore_errors=trueï¼ˆéå…³é”®ä»»åŠ¡ï¼‰
```

### 9.3 å®é™…åº”ç”¨æŒ‡å—


**ğŸ¯ æ–°æ‰‹å­¦ä¹ è·¯å¾„**
```
ç¬¬1é˜¶æ®µï¼šåŸºç¡€è¯­æ³•
â”œâ”€ æŒæ¡YAMLè¯­æ³•è§„åˆ™
â”œâ”€ ç†è§£PlaybookåŸºæœ¬ç»“æ„  
â”œâ”€ å­¦ä¼šä½¿ç”¨å¸¸ç”¨æ¨¡å—ï¼ˆyumã€copyã€serviceç­‰ï¼‰
â””â”€ ç»ƒä¹ ç¼–å†™ç®€å•çš„å•ä»»åŠ¡Playbook

ç¬¬2é˜¶æ®µï¼šè¿›é˜¶ç‰¹æ€§
â”œâ”€ æŒæ¡å˜é‡å®šä¹‰å’Œä½¿ç”¨
â”œâ”€ å­¦ä¼šHandleräº‹ä»¶å¤„ç†
â”œâ”€ ç†è§£æ¡ä»¶æ‰§è¡Œå’Œå¾ªç¯
â””â”€ ç»ƒä¹ å¤šä»»åŠ¡å¤æ‚Playbook

ç¬¬3é˜¶æ®µï¼šç”Ÿäº§å®è·µ
â”œâ”€ å­¦ä¼šå¤šç¯å¢ƒé…ç½®ç®¡ç†
â”œâ”€ æŒæ¡é”™è¯¯å¤„ç†å’Œå®¹é”™
â”œâ”€ ç†è§£æ€§èƒ½ä¼˜åŒ–ç­–ç•¥
â””â”€ å®è·µå®Œæ•´é¡¹ç›®éƒ¨ç½²
```

**âš ï¸ å¸¸è§é™·é˜±ä¸é¿å‘æŒ‡å—**

| é—®é¢˜ç±»å‹ | **å¸¸è§é”™è¯¯** | **æ­£ç¡®åšæ³•** | **é¿å‘æç¤º** |
|----------|-------------|-------------|-------------|
| ğŸ”¤ **è¯­æ³•é”™è¯¯** | `ä½¿ç”¨Tabç¼©è¿›` | `ç»Ÿä¸€ä½¿ç”¨ç©ºæ ¼ç¼©è¿›` | `é…ç½®ç¼–è¾‘å™¨æ˜¾ç¤ºç©ºæ ¼` |
| ğŸ” **æƒé™é—®é¢˜** | `å¿˜è®°become: yes` | `éœ€è¦ç®¡ç†å‘˜æƒé™æ—¶å¼€å¯` | `æµ‹è¯•æ—¶å…ˆç”¨æ™®é€šæƒé™` |
| ğŸ“¦ **æ¨¡å—ä½¿ç”¨** | `æ¨¡å—å‚æ•°é”™è¯¯` | `æŸ¥é˜…å®˜æ–¹æ–‡æ¡£` | `å…ˆç”¨ansible-docæ£€æŸ¥` |
| ğŸ”„ **Handlerä¸æ‰§è¡Œ** | `notifyåç§°ä¸åŒ¹é…` | `æ£€æŸ¥åç§°å®Œå…¨ä¸€è‡´` | `ä½¿ç”¨ansible-playbook -vvvè°ƒè¯•` |

### 9.4 ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ


**ğŸ”’ å®‰å…¨è€ƒè™‘**
```yaml
# æ•æ„Ÿä¿¡æ¯å¤„ç†
vars_files:
  - "vault/secrets.yml"      # ä½¿ç”¨ansible-vaultåŠ å¯†

# æƒé™æœ€å°åŒ–åŸåˆ™  
become_user: "{{ app_user }}"  # ä¸è¦æ€»æ˜¯ç”¨root

# å®¡è®¡æ—¥å¿—
- name: è®°å½•æ“ä½œæ—¥å¿—
  lineinfile:
    path: /var/log/ansible-ops.log
    line: "{{ ansible_date_time.iso8601 }} - {{ ansible_user }} - {{ ansible_play_name }}"
```

**ğŸ“Š ç›‘æ§ä¸è°ƒè¯•**
```bash
# è¯¦ç»†è¾“å‡ºæ¨¡å¼
ansible-playbook -vvv playbook.yml

# æ£€æŸ¥æ¨¡å¼ï¼ˆdry-runï¼‰
ansible-playbook --check playbook.yml

# è¯­æ³•æ£€æŸ¥
ansible-playbook --syntax-check playbook.yml

# åˆ—å‡ºä»»åŠ¡
ansible-playbook --list-tasks playbook.yml
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
ğŸ“ Playbookå†™å‰§æœ¬ï¼ŒYAMLè¯­æ³•è¦è§„èŒƒ
ğŸ¯ ä¸»æœºä»»åŠ¡è¦åˆ†æ¸…ï¼Œå˜é‡Handlerç”¨å¤„æ˜  
ğŸ”„ ä¸²è¡Œå¹¶è¡Œçœ‹éœ€æ±‚ï¼Œå®¹é”™ç­–ç•¥ä¿ç¨³å®š
ğŸ·ï¸ æ ‡ç­¾åˆ†ç»„ä¾¿ç®¡ç†ï¼Œæµ‹è¯•éªŒè¯æœ€é‡è¦
```