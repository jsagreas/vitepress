---
title: 6、ansible-vault加密配置
---
## 📚 目录

1. [ansible-vault基本概念](#1-ansible-vault基本概念)
2. [密码文件配置详解](#2-密码文件配置详解)
3. [身份标识管理](#3-身份标识管理)
4. [加密操作实践](#4-加密操作实践)
5. [多重密码管理](#5-多重密码管理)
6. [实际应用场景](#6-实际应用场景)
7. [最佳实践指南](#7-最佳实践指南)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🔐 ansible-vault基本概念


### 1.1 什么是ansible-vault


**🔸 简单理解**
```
ansible-vault = Ansible的保险箱
就像银行保险箱一样，用来保护重要的"秘密信息"
```

**📋 核心作用**
- **加密敏感数据**: 把密码、API密钥等重要信息"上锁"
- **安全存储**: 即使别人拿到配置文件，也看不到真实内容
- **团队协作**: 多人开发时安全共享敏感配置

### 1.2 为什么需要加密配置


**🌰 生活类比**
```
没有加密的配置文件 = 把银行卡密码写在纸上
使用vault加密 = 把密码放进保险箱，只有钥匙持有者能看到
```

**⚠️ 常见的敏感信息**
- 数据库密码
- API密钥和令牌  
- SSL证书私钥
- 云服务访问密钥
- 第三方服务认证信息

**💡 不加密的风险**
> ❌ **安全隐患**  
> 配置文件可能被意外提交到公开代码仓库，导致敏感信息泄露

### 1.3 vault工作原理


**🔧 加密流程图**
```
原始敏感数据 ──加密──▶ 加密后的文件 ──解密──▶ Ansible使用
    ↑                        ↑                    ↑
  明文密码              看起来像乱码           自动还原
```

**📊 加密前后对比**

| **加密前** | **加密后** |
|-----------|-----------|
| `db_password: mypassword123` | `$ANSIBLE_VAULT;1.1;AES256...` |
| **任何人都能看到** | **只有持有密钥的人能解密** |

---

## 2. 🔑 密码文件配置详解


### 2.1 vault_password_file - 密码文件路径


**🔸 配置含义**
```ini
# ansible.cfg

[defaults]
vault_password_file = /path/to/.vault_pass
```

**💡 通俗解释**: 告诉Ansible去哪里找"开锁的钥匙"

**🌰 实际使用示例**
```ini
# 方式1: 使用绝对路径

vault_password_file = /home/admin/.ansible_vault_pass

# 方式2: 使用相对路径

vault_password_file = ./.vault_pass

# 方式3: 使用脚本动态获取密码

vault_password_file = ./scripts/get_vault_pass.sh
```

### 2.2 密码文件创建和管理


**🚀 创建密码文件步骤**
1️⃣ 创建密码文件
```bash
# 创建密码文件并写入密码

echo "your_strong_password" > .vault_pass
```

2️⃣ 设置文件权限
```bash
# 只有文件所有者能读取

chmod 600 .vault_pass
```

3️⃣ 验证配置
```bash
# 测试密码文件是否工作正常

ansible-vault view encrypted_file.yml
```

**⚠️ 安全注意事项**
> 🔒 **权限控制**  
> 密码文件必须设置严格权限(600)，防止其他用户读取

### 2.3 ask_vault_pass - 交互式密码输入


**🔸 配置方式**
```ini
[defaults]
ask_vault_pass = True
```

**💭 使用场景对比**

| **场景** | **推荐方式** | **理由** |
|---------|-------------|---------|
| **开发环境** | `ask_vault_pass = True` | `手动输入更安全` |
| **CI/CD自动化** | `vault_password_file` | `无人值守运行` |
| **团队协作** | `vault_identity_list` | `多人多密码管理` |

---

## 3. 🏷️ 身份标识管理


### 3.1 vault_identity - 密码身份标识


**🔸 基本概念**
```
vault_identity = 给不同的密码贴上"标签"
就像家里有多把钥匙，每把钥匙上贴个标签说明用途
```

**📋 配置格式**
```ini
[defaults]
vault_identity = dev@/path/to/dev_vault_pass
```

**🌰 实际应用示例**
```ini
# 开发环境的vault身份

vault_identity = dev@./vault_passwords/dev.pass

# 生产环境的vault身份  

vault_identity = prod@./vault_passwords/prod.pass
```

### 3.2 vault_identity_list - 多身份管理


**🔸 配置方式**
```ini
[defaults]
vault_identity_list = dev@dev_vault_pass, prod@prod_vault_pass, test@test_vault_pass
```

**💡 使用场景**
```
开发团队情况：
- 开发环境密码：开发人员都知道
- 测试环境密码：QA团队管理  
- 生产环境密码：运维团队专管

使用vault_identity_list可以在一个配置中管理所有环境
```

**🏗️ 多环境架构图**
```
项目根目录
├── ansible.cfg                 ← 配置多个vault身份
├── vault_passwords/
│   ├── dev.pass                ← 开发环境密码
│   ├── test.pass               ← 测试环境密码
│   └── prod.pass               ← 生产环境密码
└── vars/
    ├── dev_secrets.yml         ← 开发环境加密变量
    ├── test_secrets.yml        ← 测试环境加密变量
    └── prod_secrets.yml        ← 生产环境加密变量
```

### 3.3 vault_id - 加密时指定身份


**🔧 加密时指定身份**
```bash
# 使用dev身份加密文件

ansible-vault encrypt --vault-id dev@dev_vault_pass secrets.yml

# 使用prod身份加密文件

ansible-vault encrypt --vault-id prod@prod_vault_pass prod_secrets.yml
```

**📊 身份标识的好处**

| **优势** | **说明** | **实际价值** |
|---------|---------|-------------|
| **环境隔离** | `不同环境使用不同密码` | `开发环境泄露不影响生产` |
| **权限分离** | `不同团队管理不同密码` | `职责明确，安全可控` |
| **灵活管理** | `可以随时更换特定环境密码` | `出问题时快速响应` |

---

## 4. 🛠️ 加密操作实践


### 4.1 基础加密操作


**🔸 vault_encrypt - 加密文件**
```bash
# 基本加密操作

ansible-vault encrypt secrets.yml

# 使用指定密码文件加密

ansible-vault encrypt --vault-password-file .vault_pass secrets.yml

# 使用身份标识加密

ansible-vault encrypt --vault-id prod@prod_vault_pass secrets.yml
```

**🔸 vault_decrypt - 解密文件**
```bash
# 解密文件到原文件

ansible-vault decrypt secrets.yml

# 解密到新文件

ansible-vault decrypt --output=secrets_plain.yml secrets.yml
```

### 4.2 日常维护操作


**🔸 vault_view - 查看加密内容**
```bash
# 查看加密文件内容（不解密文件本身）

ansible-vault view secrets.yml
```

**💡 使用场景**: 想看看加密文件里有什么，但不想解密整个文件

**🔸 vault_edit - 编辑加密文件**
```bash
# 直接编辑加密文件

ansible-vault edit secrets.yml
```

**🌰 工作流程**:
```
1. 命令执行后自动解密
2. 打开编辑器让你修改
3. 保存时自动重新加密
```

**🔸 vault_rekey - 更换密码**
```bash
# 更换加密密码

ansible-vault rekey secrets.yml
```

**⚠️ 使用提醒**
> 💡 **密码更换时机**  
> 当团队成员离职或密码可能泄露时，应及时使用rekey更换密码

### 4.3 encrypted_variables - 变量级加密


**🔸 概念理解**
```
文件级加密 = 整个文件都加密，像个密码箱
变量级加密 = 只加密文件中的某些变量，其他内容明文可见
```

**📋 变量级加密示例**
```yaml
# vars/secrets.yml

database_host: localhost          # 明文
database_port: 5432              # 明文
database_user: admin             # 明文
database_password: !vault |      # 只有密码加密
  $ANSIBLE_VAULT;1.1;AES256
  66633339383...
```

**🔧 创建加密变量**
```bash
# 交互式创建加密变量

ansible-vault encrypt_string 'my_secret_password' --name 'database_password'
```

**💪 变量级加密优势**
- ✅ 文件大部分内容可读
- ✅ 便于代码审查和维护
- ✅ 只保护真正敏感的信息

---

## 5. 🔄 多重密码管理


### 5.1 multiple_vault_passwords - 多密码概念


**🔸 应用场景**
```
大型项目常见情况：
- 不同环境需要不同密码保护
- 不同团队负责不同密码
- 历史遗留多套密码体系
```

**📋 配置示例**
```ini
[defaults]
vault_identity_list = dev@./passwords/dev.pass, 
                     prod@./passwords/prod.pass,
                     legacy@./passwords/old.pass
```

### 5.2 密码管理策略


**🔸 环境分离策略**
```yaml
# group_vars/dev/vault.yml (使用dev密码加密)

vault_db_password: !vault |
  $ANSIBLE_VAULT;1.1;AES256;dev
  58373...

# group_vars/prod/vault.yml (使用prod密码加密)  

vault_db_password: !vault |
  $ANSIBLE_VAULT;1.1;AES256;prod
  72829...
```

**🏗️ 密码管理架构**
```
密码管理层级：
├── 全局密码 (vault_password_file)
├── 环境密码 (dev, test, prod)  
├── 团队密码 (backend, frontend, ops)
└── 服务密码 (database, api, cache)
```

### 5.3 密码轮换最佳实践


**📅 轮换计划**

| **密码类型** | **轮换频率** | **负责人** |
|-------------|-------------|-----------|
| **开发环境** | `每月` | `开发团队` |
| **测试环境** | `每季度` | `QA团队` |
| **生产环境** | `每年或安全事件后` | `运维团队` |

**🚀 轮换操作流程**
1️⃣ 生成新密码
2️⃣ 使用`ansible-vault rekey`更新
3️⃣ 通知相关团队成员
4️⃣ 更新CI/CD系统配置
5️⃣ 验证所有环境正常工作

---

## 6. 🎯 实际应用场景


### 6.1 Web应用部署场景


**🌐 典型Web项目结构**
```
web-app-deployment/
├── ansible.cfg                     ← vault配置
├── .vault_pass                     ← 密码文件
├── playbooks/
│   └── deploy.yml                  ← 部署剧本
├── group_vars/
│   ├── all/
│   │   └── vault.yml               ← 加密的全局配置
│   ├── production/
│   │   └── vault.yml               ← 生产环境敏感配置
│   └── staging/
│       └── vault.yml               ← 测试环境敏感配置
└── host_vars/
    └── web01/
        └── vault.yml               ← 单台服务器特定配置
```

**🔐 敏感配置示例**
```yaml
# group_vars/production/vault.yml

vault_database_url: !vault |
  $ANSIBLE_VAULT;1.1;AES256
  363763...

vault_api_keys:
  aws_access_key: !vault |
    $ANSIBLE_VAULT;1.1;AES256
    847392...
  
  redis_password: !vault |
    $ANSIBLE_VAULT;1.1;AES256
    928473...
```

### 6.2 CI/CD集成场景


**🔧 Jenkins流水线配置**
```groovy
pipeline {
    stages {
        stage('Deploy') {
            steps {
                // 从Jenkins凭据管理获取vault密码
                withCredentials([string(credentialsId: 'ansible-vault-pass', variable: 'VAULT_PASS')]) {
                    sh '''
                        echo "$VAULT_PASS" > .vault_pass
                        chmod 600 .vault_pass
                        ansible-playbook -i inventory deploy.yml
                        rm .vault_pass
                    '''
                }
            }
        }
    }
}
```

**🎯 关键配置要点**
- ✅ vault密码存储在CI/CD系统的凭据管理中
- ✅ 使用后立即删除临时密码文件
- ✅ 确保只有授权用户能访问生产部署

### 6.3 团队协作场景


**👥 多团队权限分配**

| **团队** | **环境权限** | **vault身份** | **实际权限** |
|---------|-------------|--------------|-------------|
| **开发团队** | `dev, staging` | `dev@dev.pass` | `可以查看开发和测试环境配置` |
| **运维团队** | `所有环境` | `全部身份` | `生产环境完全控制权` |
| **QA团队** | `staging` | `test@test.pass` | `只能操作测试环境` |

**🔄 权限管理流程**
```
新员工入职 ──▶ 分配对应环境的vault密码
员工转岗 ──▶ 回收原权限，分配新权限  
员工离职 ──▶ 轮换所有相关密码
```

---

## 7. 🏆 最佳实践指南


### 7.1 密码安全管理


**🔒 密码强度要求**
```bash
# 推荐的密码生成方式

openssl rand -base64 32 > .vault_pass

# 或使用密码管理器生成强密码

# 密码要求：至少20位，包含大小写字母、数字、特殊字符

```

**📁 文件权限设置**
```bash
# 密码文件严格权限

chmod 600 .vault_pass

# 加密文件正常权限

chmod 644 encrypted_vars.yml

# 目录权限

chmod 700 vault_passwords/
```

### 7.2 版本控制管理


**✅ 应该提交的文件**
- 加密后的配置文件 (`*.yml`)
- ansible.cfg配置文件
- 部署脚本和playbook

**❌ 不应该提交的文件**
- 密码文件 (`.vault_pass`)
- 解密后的配置文件
- 临时文件

**📝 .gitignore示例**
```gitignore
# Vault密码文件

.vault_pass
*_vault_pass
vault_passwords/

# 解密后的临时文件  

*_decrypted.yml
secrets_plain.yml
```

### 7.3 监控和审计


**📊 建议监控的指标**
- vault文件的访问记录
- 密码更换操作日志
- 解密操作频率统计
- 异常访问告警

**🔍 审计检查清单**
- [ ] 密码文件权限是否正确(600)
- [ ] 是否有密码文件意外提交到代码仓库
- [ ] 团队成员权限是否及时更新
- [ ] 密码轮换是否按计划执行
- [ ] CI/CD系统vault配置是否安全

### 7.4 故障排除指南


**⚠️ 常见问题解决**

| **问题现象** | **可能原因** | **解决方案** |
|-------------|-------------|-------------|
| `密码验证失败` | `密码文件内容错误` | `检查.vault_pass文件内容` |
| `权限拒绝错误` | `文件权限设置不当` | `chmod 600设置正确权限` |
| `找不到密码文件` | `路径配置错误` | `检查ansible.cfg中路径设置` |
| `解密失败` | `使用了错误的vault_id` | `确认加密时使用的身份标识` |

**🚨 紧急恢复流程**
```
1. 如果密码丢失：
   - 检查备份系统
   - 联系原加密操作人员
   - 必要时重新生成敏感数据

2. 如果密码泄露：
   - 立即轮换所有相关密码
   - 重新加密所有文件
   - 审查访问日志
   - 通知安全团队
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的基本概念


```
🔸 ansible-vault：Ansible的加密工具，保护敏感配置
🔸 vault_password_file：告诉Ansible在哪找解密密码
🔸 vault_identity：给不同密码贴标签，方便多环境管理
🔸 加密操作：encrypt加密、decrypt解密、edit编辑、view查看
🔸 安全原则：密码文件权限600，不提交到版本控制
```

### 8.2 关键理解要点


**🔹 加密的本质**
```
加密 = 把重要信息放进保险箱
密码文件 = 保险箱的钥匙  
解密 = 用钥匙打开保险箱取信息
```

**🔹 多身份管理的价值**
```
就像一串钥匙：
- 每把钥匙开不同的门(环境)
- 不同的人有不同的钥匙(权限)
- 丢了一把不影响其他门的安全
```

**🔹 文件级vs变量级加密**
```
文件级：整个文件都是密文，像个密码箱
变量级：只加密敏感部分，其他内容可读
选择原则：看是否需要审查非敏感内容
```

### 8.3 实际应用价值


**📈 安全收益**
- **数据保护**: 敏感信息即使泄露也无法直接使用
- **权限控制**: 不同环境使用不同密码，避免权限滥用
- **合规要求**: 满足企业安全和审计要求

**🚀 运维效率**
- **自动化部署**: CI/CD系统可以安全地使用加密配置
- **团队协作**: 多人开发时安全共享配置
- **环境管理**: 统一管理多环境的敏感配置

### 8.4 学习检查清单


**📚 基础技能掌握**
- [ ] 能创建和配置vault密码文件
- [ ] 会使用基本的加密解密操作
- [ ] 理解文件权限设置的重要性
- [ ] 能配置多身份管理

**🔧 进阶技能掌握**  
- [ ] 能设计多环境的密码管理策略
- [ ] 会集成CI/CD系统的vault配置
- [ ] 能处理常见的故障和问题
- [ ] 理解安全审计的要点

**💡 实践经验积累**
- [ ] 在实际项目中使用过vault加密
- [ ] 参与过密码轮换操作
- [ ] 处理过团队权限变更
- [ ] 建立过完整的安全管理流程

**核心记忆口诀**：
- vault保护敏感信息，密码文件是关键
- 权限设置要严格，版本控制需谨慎
- 多环境多身份，安全管理要规范
- 加密解密要熟练，故障排查有方法