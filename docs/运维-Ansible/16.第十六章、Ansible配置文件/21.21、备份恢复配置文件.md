---
title: 21、备份恢复配置文件
---
## 📚 目录

1. [Ansible备份系统概念入门](#1-Ansible备份系统概念入门)
2. [基础备份配置详解](#2-基础备份配置详解)
3. [恢复配置策略](#3-恢复配置策略)
4. [调度与时间管理](#4-调度与时间管理)
5. [数据保留与清理策略](#5-数据保留与清理策略)
6. [压缩与加密配置](#6-压缩与加密配置)
7. [存储与传输配置](#7-存储与传输配置)
8. [数据库备份专项配置](#8-数据库备份专项配置)
9. [文件与系统备份配置](#9-文件与系统备份配置)
10. [高级备份策略](#10-高级备份策略)
11. [核心要点总结](#11-核心要点总结)

---

## 1. 🎯 Ansible备份系统概念入门


### 1.1 什么是Ansible备份配置

🔧 **简单理解**：Ansible备份配置就像制定一套"自动保险箱"的规则

```
生活中的类比：
定期存钱到银行 → 定期备份数据到安全位置
银行有不同类型账户 → 备份有不同存储方式
存钱有定期计划 → 备份有调度策略
重要文件放保险柜 → 重要数据要加密存储
```

**🔸 Ansible备份系统的核心价值**
```
自动化管理：
- 一次配置，长期有效
- 多台服务器统一管理
- 减少人为操作失误

灵活性强：
- 支持多种数据库和文件系统
- 可配置不同备份策略
- 灵活的调度和存储选项

可靠性高：
- 备份完整性验证
- 多重安全保障
- 详细的日志记录
```

### 1.2 备份配置文件结构概览

**📁 典型的Ansible备份项目结构**

```
ansible-backup-project/
├── playbooks/                    ← 主要执行文件
│   ├── backup-playbook.yml      ← 备份主剧本
│   └── restore-playbook.yml     ← 恢复主剧本
├── roles/                        ← 功能模块
│   ├── mysql-backup/            ← MySQL备份角色
│   ├── postgresql-backup/       ← PostgreSQL备份角色
│   └── file-backup/             ← 文件备份角色
├── group_vars/                   ← 组变量配置
│   ├── all.yml                  ← 全局配置
│   ├── database.yml             ← 数据库配置
│   └── webservers.yml           ← Web服务器配置
├── host_vars/                    ← 主机特定配置
├── inventory/                    ← 主机清单
└── templates/                    ← 配置文件模板
    ├── backup-config.j2         ← 备份配置模板
    └── cron-backup.j2           ← 定时任务模板
```

### 1.3 配置文件的分类和作用

**🎨 不同配置文件的职责分工**

| 配置类型 | **文件位置** | **主要作用** | **配置内容** |
|---------|-------------|-------------|-------------|
| 📋 **全局配置** | `group_vars/all.yml` | `整体策略设定` | `备份路径、保留天数、通知设置` |
| 🗄️ **数据库配置** | `group_vars/database.yml` | `数据库备份设置` | `连接信息、备份参数、压缩选项` |
| 📂 **主机配置** | `host_vars/hostname.yml` | `单机特殊设置` | `特定路径、个性化参数` |
| ⏰ **调度配置** | `templates/cron-backup.j2` | `定时任务设置` | `执行时间、频率、优先级` |

---

## 2. 🛠️ 基础备份配置详解


### 2.1 全局备份配置 (backup_config)

**📋 核心备份参数设置**

在 `group_vars/all.yml` 中定义全局备份策略：

```yaml
# 备份基础配置
backup_config:
  # 备份根目录 - 所有备份文件的起始位置
  base_path: "/opt/backups"
  
  # 临时目录 - 备份过程中的工作区域
  temp_path: "/tmp/backup-temp"
  
  # 备份文件命名规则 - 便于识别和管理
  naming_pattern: "{{ inventory_hostname }}_{{ backup_type }}_{{ ansible_date_time.epoch }}"
  
  # 默认保留策略 - 防止磁盘空间耗尽
  default_retention_days: 7
  
  # 并行备份数量 - 控制系统负载
  max_parallel_backups: 2
  
  # 备份验证 - 确保备份文件完整性
  verify_backups: true
  
  # 日志配置 - 记录备份过程和结果
  logging:
    enabled: true
    log_file: "/var/log/ansible-backup.log"
    log_level: "INFO"
```

**💡 配置参数详解**
```
base_path 解释：
- 这是所有备份文件的"家目录"
- 建议选择空间充足的磁盘分区
- 需要确保Ansible有写入权限

naming_pattern 解释：
- {{ inventory_hostname }}：主机名
- {{ backup_type }}：备份类型（mysql/files/system）
- {{ ansible_date_time.epoch }}：时间戳
- 示例：web01_mysql_1642789200.sql.gz

max_parallel_backups 解释：
- 控制同时运行的备份任务数量
- 避免系统负载过高影响正常业务
- 根据服务器性能调整此参数
```

### 2.2 备份目标配置

**🎯 指定需要备份的内容**

```yaml
# 备份目标配置
backup_targets:
  # 数据库备份目标
  databases:
    - name: "production_db"
      type: "mysql"
      enabled: true
      priority: 1  # 优先级：1=最高，3=最低
    
    - name: "user_data"
      type: "postgresql"
      enabled: true
      priority: 1
  
  # 文件系统备份目标
  filesystems:
    - name: "web_content"
      path: "/var/www/html"
      enabled: true
      priority: 2
      
    - name: "user_uploads"
      path: "/opt/uploads"
      enabled: true
      priority: 2
  
  # 系统配置备份
  system_configs:
    - name: "nginx_config"
      paths:
        - "/etc/nginx"
        - "/etc/ssl/certs"
      enabled: true
      priority: 3
```

**🔧 backup_targets 配置要点**
```
priority 优先级说明：
1 = 关键数据，优先备份，优先恢复
2 = 重要数据，正常处理
3 = 一般数据，最后处理

enabled 开关作用：
- 可以临时关闭某些备份而不删除配置
- 方便在维护期间调整备份策略
- 支持按环境启用不同的备份目标

type 类型说明：
- mysql/postgresql/mongodb：数据库类型
- files：文件系统备份
- system：系统配置备份
```

### 2.3 通知配置

**📧 备份结果通知设置**

```yaml
# 通知配置
notification_config:
  # 邮件通知
  email:
    enabled: true
    smtp_server: "smtp.company.com"
    smtp_port: 587
    sender: "backup-system@company.com"
    recipients:
      - "admin@company.com"
      - "devops@company.com"
    
    # 通知条件
    notify_on_success: false  # 成功时不通知（避免邮件轰炸）
    notify_on_failure: true   # 失败时立即通知
    notify_on_warning: true   # 警告时通知
  
  # Slack通知
  slack:
    enabled: false
    webhook_url: "{{ vault_slack_webhook }}"
    channel: "#ops-alerts"
    
  # 企业微信通知
  wechat:
    enabled: false
    webhook_url: "{{ vault_wechat_webhook }}"
```

---

## 3. 🔄 恢复配置策略


### 3.1 恢复配置基础 (restore_config)

**🎯 数据恢复的核心配置**

```yaml
# 恢复配置
restore_config:
  # 恢复模式设置
  default_restore_mode: "safe"  # safe/force/interactive
  
  # 恢复前备份 - 安全措施
  backup_before_restore: true
  backup_suffix: "_pre_restore"
  
  # 恢复验证 - 确保数据完整性
  verify_after_restore: true
  verification_timeout: 300  # 5分钟超时
  
  # 恢复日志
  log_restore_operations: true
  restore_log_path: "/var/log/ansible-restore.log"
  
  # 权限恢复
  restore_permissions: true
  restore_ownership: true
```

**💡 恢复模式详解**
```
safe 模式（推荐）：
- 恢复前会检查目标是否存在
- 存在冲突时会提示用户确认
- 自动创建恢复前备份

force 模式（谨慎使用）：
- 强制覆盖现有数据
- 不进行安全检查
- 适用于紧急恢复场景

interactive 模式：
- 每个步骤都会询问用户
- 适合复杂恢复场景
- 提供最大的控制灵活性
```

### 3.2 数据库恢复专项配置

**🗄️ 不同数据库的恢复策略**

```yaml
# 数据库恢复配置
database_restore_config:
  mysql:
    # 恢复前准备
    stop_service: true          # 恢复前停止MySQL服务
    create_db_if_missing: true  # 数据库不存在时自动创建
    
    # 恢复选项
    force_recreate: false       # 是否强制重建数据库
    skip_grant_tables: false    # 跳过权限表（紧急情况）
    
    # 恢复后验证
    run_repair: true           # 恢复后运行修复
    verify_tables: true        # 验证表完整性
  
  postgresql:
    # PostgreSQL特有设置
    drop_connections: true      # 断开现有连接
    vacuum_after_restore: true  # 恢复后清理
    analyze_after_restore: true # 恢复后更新统计信息
```

### 3.3 文件恢复配置

**📂 文件系统恢复设置**

```yaml
# 文件恢复配置
file_restore_config:
  # 恢复路径策略
  preserve_path_structure: true    # 保持目录结构
  create_missing_directories: true # 自动创建缺失目录
  
  # 权限处理
  restore_file_permissions: true   # 恢复文件权限
  restore_file_ownership: true     # 恢复文件所有者
  
  # 冲突处理
  overwrite_existing: "prompt"     # 覆盖策略：prompt/yes/no/backup
  conflict_resolution: "interactive" # 冲突解决方式
  
  # 恢复验证
  verify_file_integrity: true     # 验证文件完整性（MD5检查）
  compare_file_sizes: true        # 比较文件大小
```

**🔧 overwrite_existing 选项说明**
```
prompt（推荐）：
- 遇到同名文件时询问用户
- 提供跳过、覆盖、重命名选项
- 最安全的处理方式

yes：
- 自动覆盖所有冲突文件
- 适合已确认安全的恢复操作
- 节省时间但风险较高

no：
- 跳过所有冲突文件
- 只恢复不冲突的文件
- 适合部分恢复场景

backup：
- 将现有文件重命名为备份
- 然后恢复新文件
- 既安全又完整
```

---

## 4. ⏰ 调度与时间管理


### 4.1 调度配置详解 (schedule_config)

**🕐 自动化备份时间安排**

```yaml
# 调度配置
schedule_config:
  # 全量备份调度
  full_backup:
    enabled: true
    cron_expression: "0 2 * * 0"    # 每周日凌晨2点
    timezone: "Asia/Shanghai"        # 时区设置
    random_delay: 600               # 随机延迟0-10分钟
  
  # 增量备份调度
  incremental_backup:
    enabled: true
    cron_expression: "0 3 * * 1-6"  # 周一到周六凌晨3点
    timezone: "Asia/Shanghai"
    random_delay: 300               # 随机延迟0-5分钟
  
  # 配置备份调度（频率较高）
  config_backup:
    enabled: true
    cron_expression: "0 */6 * * *"   # 每6小时一次
    timezone: "Asia/Shanghai"
    random_delay: 60                # 随机延迟0-1分钟
```

**📅 Cron表达式快速参考**
```
格式：分 时 日 月 周
示例解释：

"0 2 * * 0" 
→ 每周日凌晨2:00执行

"0 3 * * 1-6" 
→ 周一到周六凌晨3:00执行

"0 */6 * * *" 
→ 每天每6小时执行（0:00, 6:00, 12:00, 18:00）

"30 1 1 * *" 
→ 每月1号凌晨1:30执行

"0 22 * * 5" 
→ 每周五晚上10:00执行
```

### 4.2 调度冲突避免配置

**⚖️ 避免多个任务同时运行**

```yaml
# 调度冲突管理
schedule_conflict_management:
  # 任务锁定机制
  use_lock_files: true
  lock_file_path: "/tmp/ansible-backup.lock"
  lock_timeout: 7200  # 2小时超时自动解锁
  
  # 资源限制
  max_concurrent_jobs: 1      # 最多同时运行的备份任务
  cpu_limit_percent: 80       # CPU使用率限制
  memory_limit_mb: 2048       # 内存使用限制
  
  # 业务时间避让
  avoid_business_hours: true
  business_start_hour: 8      # 业务开始时间
  business_end_hour: 18       # 业务结束时间
  force_stop_at_business_time: true  # 业务时间强制停止备份
```

### 4.3 节假日和维护窗口配置

**📆 特殊时间的调度策略**

```yaml
# 特殊时间配置
special_time_config:
  # 节假日配置
  holidays:
    enabled: true
    holiday_list:
      - "2024-01-01"  # 元旦
      - "2024-02-10"  # 春节
      - "2024-05-01"  # 劳动节
      - "2024-10-01"  # 国庆节
    
    # 节假日策略
    skip_routine_backup: false    # 不跳过常规备份
    extend_retention: true        # 延长保留时间
    holiday_retention_days: 30    # 节假日备份保留30天
  
  # 维护窗口配置
  maintenance_windows:
    enabled: true
    windows:
      - name: "weekly_maintenance"
        start_time: "02:00"
        end_time: "04:00"
        days: ["Sunday"]
        action: "pause_backups"     # 暂停备份
      
      - name: "monthly_maintenance"
        start_time: "01:00"
        end_time: "05:00"
        days: ["first_sunday"]      # 每月第一个周日
        action: "reschedule"        # 重新调度到其他时间
```

---

## 5. 🗂️ 数据保留与清理策略


### 5.1 保留策略配置 (retention_config)

**🗄️ 智能的数据生命周期管理**

```yaml
# 保留配置
retention_config:
  # 基础保留策略
  default_policy:
    daily_backups_keep: 7      # 每日备份保留7天
    weekly_backups_keep: 4     # 每周备份保留4周
    monthly_backups_keep: 12   # 每月备份保留12个月
    yearly_backups_keep: 3     # 年度备份保留3年
  
  # 按备份类型的差异化策略
  type_specific_policies:
    # 数据库备份（重要，保留时间较长）
    database:
      daily_keep: 30
      weekly_keep: 12
      monthly_keep: 24
      yearly_keep: 5
    
    # 文件备份（一般重要，标准保留）
    files:
      daily_keep: 7
      weekly_keep: 4
      monthly_keep: 6
      yearly_keep: 2
    
    # 配置备份（变化频繁，短期保留）
    config:
      daily_keep: 14
      weekly_keep: 8
      monthly_keep: 3
      yearly_keep: 1
```

**🎯 保留策略的设计理念**
```
分层保留原则：
近期：高频率保留 → 便于快速恢复近期变更
中期：周期性保留 → 平衡存储成本和恢复需求
长期：稀疏保留 → 应对监管要求和重大回滚

重要性分级：
数据库 > 业务文件 > 系统配置 > 临时文件
保留时间和频率按重要性递减

自动化清理：
- 避免手动清理的遗漏和错误
- 确保存储空间的可持续使用
- 降低运维工作量
```

### 5.2 清理策略配置

**🧹 自动化清理机制**

```yaml
# 清理策略配置
cleanup_config:
  # 清理执行时机
  auto_cleanup: true
  cleanup_schedule: "0 4 * * *"    # 每天凌晨4点清理
  cleanup_before_backup: true      # 备份前清理腾出空间
  
  # 安全清理设置
  dry_run_first: true             # 先执行模拟清理
  confirm_before_delete: false    # 自动清理无需确认
  backup_file_list_before_cleanup: true  # 清理前备份文件列表
  
  # 清理规则
  cleanup_rules:
    # 基于时间的清理
    - type: "time_based"
      max_age_days: 90            # 超过90天的文件
      apply_to: ["logs", "temp"]
    
    # 基于空间的清理
    - type: "space_based"
      keep_free_space_gb: 10      # 保持10GB空闲空间
      cleanup_order: "oldest_first" # 优先删除最旧的文件
    
    # 基于数量的清理
    - type: "count_based"
      max_files: 100              # 最多保留100个备份文件
      cleanup_strategy: "fifo"    # 先进先出
```

### 5.3 存储空间监控配置

**📊 主动监控存储状态**

```yaml
# 存储监控配置
storage_monitoring:
  # 空间监控阈值
  disk_usage_warning_percent: 80   # 使用率80%时警告
  disk_usage_critical_percent: 90  # 使用率90%时紧急清理
  
  # 监控检查频率
  check_interval_minutes: 30       # 每30分钟检查一次
  
  # 紧急处理策略
  emergency_cleanup:
    enabled: true
    aggressive_cleanup_percent: 95 # 使用率95%时激进清理
    emergency_retention_days: 3    # 紧急情况下只保留3天
    
  # 预测性清理
  predictive_cleanup:
    enabled: true
    growth_rate_analysis: true     # 分析增长率
    predict_days_ahead: 7          # 预测7天后的空间需求
```

---

## 6. 🔒 压缩与加密配置


### 6.1 压缩配置详解 (compression_config)

**📦 优化存储空间的压缩策略**

```yaml
# 压缩配置
compression_config:
  # 全局压缩设置
  default_compression: true
  compression_algorithm: "gzip"    # gzip/bzip2/xz/lz4
  compression_level: 6             # 1-9级，6为平衡点
  
  # 按文件类型的压缩策略
  file_type_settings:
    # 数据库文件（高压缩比）
    database:
      enabled: true
      algorithm: "gzip"
      level: 9                     # 最高压缩比
      
    # 日志文件（快速压缩）
    logs:
      enabled: true
      algorithm: "lz4"             # 快速压缩算法
      level: 1
      
    # 图片/视频文件（跳过压缩）
    media:
      enabled: false               # 已压缩格式无需重复压缩
      
    # 文档文件（标准压缩）
    documents:
      enabled: true
      algorithm: "gzip"
      level: 6
```

**⚡ 压缩算法选择指南**
```
gzip（推荐）：
✓ 压缩比好，兼容性强
✓ CPU占用适中
✓ 几乎所有系统都支持
× 压缩速度中等

lz4（高性能）：
✓ 压缩/解压速度极快
✓ CPU占用很低
✓ 适合实时备份
× 压缩比相对较低

xz（高压缩比）：
✓ 压缩比最高，节省存储
× CPU占用较高
× 压缩时间较长
× 适合长期存储备份

bzip2（平衡选择）：
✓ 压缩比优于gzip
× 速度慢于gzip
× 使用相对较少
```

### 6.2 加密配置详解 (encryption_config)

**🔐 数据安全的加密保护**

```yaml
# 加密配置
encryption_config:
  # 全局加密策略
  encryption_enabled: true
  encryption_algorithm: "AES-256-CBC"  # 加密算法
  key_derivation: "PBKDF2"            # 密钥派生算法
  
  # 密钥管理
  key_management:
    # 密钥存储方式
    key_storage: "file"          # file/vault/env/external
    key_file_path: "/etc/backup-keys/master.key"
    key_rotation_days: 90        # 90天轮换密钥
    
    # 密钥备份
    backup_keys: true
    key_backup_location: "/secure/key-backup/"
    
  # 加密范围配置
  encryption_scope:
    # 数据库备份（强制加密）
    database_backups: "required"
    
    # 敏感文件（强制加密）
    sensitive_files: "required"
    
    # 普通文件（可选加密）
    regular_files: "optional"
    
    # 日志文件（通常不加密）
    log_files: "disabled"
  
  # 性能优化
  performance_settings:
    # 并行加密进程数
    parallel_encryption_jobs: 2
    
    # 加密块大小（影响内存使用）
    encryption_block_size: "64KB"
    
    # 加密验证
    verify_encrypted_data: true
```

### 6.3 压缩加密组合策略

**🔄 压缩和加密的最佳配置**

```yaml
# 压缩加密组合配置
compression_encryption_pipeline:
  # 处理顺序（重要）
  processing_order: "compress_then_encrypt"  # 先压缩后加密
  
  # 组合策略
  strategies:
    # 高安全性策略（金融、医疗）
    high_security:
      compression: true
      compression_level: 9
      encryption: true
      encryption_algorithm: "AES-256-GCM"
      
    # 平衡策略（一般企业）
    balanced:
      compression: true
      compression_level: 6
      encryption: true
      encryption_algorithm: "AES-256-CBC"
      
    # 高性能策略（大数据量）
    high_performance:
      compression: true
      compression_algorithm: "lz4"
      compression_level: 1
      encryption: true
      encryption_algorithm: "ChaCha20-Poly1305"  # 高性能加密
```

**💡 压缩加密的最佳实践**
```
处理顺序选择：
压缩→加密（推荐）：
- 压缩效果更好（原始数据压缩比高）
- 加密数据更小，传输更快
- 标准做法，兼容性好

加密→压缩（特殊场景）：
- 某些合规要求必须先加密
- 压缩效果会显著降低
- 增加不必要的处理复杂度

性能考虑：
- CPU性能好：选择高压缩比
- 存储空间小：必须高压缩
- 网络带宽小：优先压缩
- 安全要求高：必须加密
```

---

## 7. 📡 存储与传输配置


### 7.1 存储配置详解 (storage_config)

**💾 多样化的存储选择**

```yaml
# 存储配置
storage_config:
  # 本地存储配置
  local_storage:
    enabled: true
    base_path: "/opt/backups"
    # 存储层次结构
    directory_structure: "{{ inventory_hostname }}/{{ backup_type }}/{{ ansible_date_time.year }}/{{ ansible_date_time.month }}"
    
    # 权限设置
    directory_permissions: "0750"
    file_permissions: "0640"
    owner: "backup"
    group: "backup"
    
    # 本地存储限制
    max_storage_size_gb: 500    # 最大占用500GB
    cleanup_when_full: true     # 空间不足时自动清理
  
  # 网络存储配置
  network_storage:
    # NFS存储
    nfs:
      enabled: false
      server: "nfs-server.company.com"
      export_path: "/exports/backups"
      mount_point: "/mnt/nfs-backup"
      mount_options: "rw,hard,intr,rsize=8192,wsize=8192"
    
    # SMB/CIFS存储
    smb:
      enabled: false
      server: "file-server.company.com"
      share_name: "backups"
      mount_point: "/mnt/smb-backup"
      credentials_file: "/etc/backup-smb-credentials"
  
  # 云存储配置
  cloud_storage:
    # AWS S3
    s3:
      enabled: false
      bucket_name: "company-backups"
      region: "ap-northeast-1"
      storage_class: "STANDARD_IA"    # 标准-不频繁访问
      
    # 阿里云OSS
    oss:
      enabled: false
      bucket_name: "company-backup-oss"
      endpoint: "oss-cn-hangzhou.aliyuncs.com"
      storage_class: "IA"             # 低频访问
```

### 7.2 传输配置

**🚀 安全高效的数据传输**

```yaml
# 传输配置
transfer_config:
  # 传输方式
  default_method: "rsync"         # rsync/scp/sftp/ftp
  
  # rsync配置（推荐）
  rsync:
    options: "-avz --progress --partial"  # 归档、详细、压缩、进度、断点续传
    bandwidth_limit_kbps: 10240           # 限制带宽10MB/s
    ssh_options: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
    delete_after_transfer: false          # 传输后不删除本地文件
    
    # 传输重试
    retry_attempts: 3
    retry_delay_seconds: 30
  
  # 安全传输设置
  security:
    use_encryption: true          # 使用加密传输
    verify_host_key: true         # 验证主机密钥
    use_key_auth: true           # 使用密钥认证
    private_key_path: "/etc/backup-keys/id_rsa"
    
    # 传输验证
    verify_transfer: true         # 验证传输完整性
    checksum_algorithm: "md5"     # 校验算法
```

### 7.3 多存储策略配置

**🎯 3-2-1备份策略实现**

```yaml
# 多存储策略（3-2-1原则）
multi_storage_strategy:
  # 3-2-1策略解释：
  # 3份副本：1份原始数据 + 2份备份
  # 2种介质：本地存储 + 远程存储
  # 1份离线：异地或云端存储
  
  strategy_321:
    enabled: true
    
    # 第一份：本地快速恢复
    primary_storage:
      type: "local"
      path: "/opt/backups/primary"
      retention_days: 7
      purpose: "快速恢复"
    
    # 第二份：网络存储
    secondary_storage:
      type: "nfs"
      server: "backup-server.company.com"
      path: "/backups/secondary"
      retention_days: 30
      purpose: "中期存储"
    
    # 第三份：云端长期存储
    tertiary_storage:
      type: "s3"
      bucket: "company-longterm-backup"
      storage_class: "GLACIER"      # 冷存储
      retention_days: 365
      purpose: "长期归档"
  
  # 存储同步策略
  sync_strategy:
    # 实时同步（重要数据）
    realtime_sync:
      enabled: true
      sync_immediately: true
      targets: ["primary_storage"]
    
    # 定时同步（一般数据）
    scheduled_sync:
      enabled: true
      sync_schedule: "0 6 * * *"    # 每天早上6点同步
      targets: ["secondary_storage", "tertiary_storage"]
```

---

## 8. 🗄️ 数据库备份专项配置


### 8.1 MySQL备份配置 (mysql_backup)

**🐬 MySQL数据库专业备份设置**

```yaml
# MySQL备份配置
mysql_backup:
  # 连接配置
  connection:
    host: "{{ ansible_default_ipv4.address }}"
    port: 3306
    user: "backup_user"
    password: "{{ vault_mysql_backup_password }}"
    
    # 连接选项
    socket: "/var/run/mysqld/mysqld.sock"  # 本地连接优先使用socket
    charset: "utf8mb4"
    connection_timeout: 30
  
  # 备份参数
  backup_options:
    # mysqldump参数
    single_transaction: true      # 事务一致性
    routines: true               # 包含存储过程和函数
    triggers: true               # 包含触发器
    events: true                 # 包含事件
    hex_blob: true              # 二进制数据十六进制编码
    
    # 数据选择
    databases: "all"             # all/指定数据库列表
    ignore_databases:            # 忽略的数据库
      - "information_schema"
      - "performance_schema"
      - "mysql"
      - "sys"
    
    ignore_tables:               # 忽略的表（支持通配符）
      - "*.log_*"               # 所有以log_开头的表
      - "temp_*.*"              # 所有临时表
  
  # 备份文件设置
  file_settings:
    filename_format: "mysql_backup_{{ ansible_date_time.epoch }}.sql"
    compression: true
    compression_format: "gzip"   # gzip/bzip2
    
    # 文件分割（大数据库）
    split_large_files: true
    max_file_size_mb: 2048      # 超过2GB分割
```

**🔧 MySQL备份最佳实践配置**
```
生产环境推荐设置：

备份用户权限：
GRANT SELECT, LOCK TABLES, SHOW VIEW, EVENT, TRIGGER ON *.* TO 'backup_user'@'localhost';
GRANT RELOAD, REPLICATION CLIENT ON *.* TO 'backup_user'@'localhost';

关键参数说明：
single_transaction = true
→ 保证InnoDB表的事务一致性
→ 备份时不锁定表，业务可正常运行

routines = true
→ 备份存储过程和函数
→ 确保应用逻辑的完整性

hex_blob = true  
→ 二进制数据用十六进制表示
→ 避免字符编码问题
```

### 8.2 PostgreSQL备份配置 (postgresql_backup)

**🐘 PostgreSQL数据库备份设置**

```yaml
# PostgreSQL备份配置
postgresql_backup:
  # 连接配置
  connection:
    host: "localhost"
    port: 5432
    user: "backup_user"
    database: "postgres"        # 连接到默认数据库
    
    # 认证设置
    password: "{{ vault_postgres_backup_password }}"
    # 或使用.pgpass文件
    use_pgpass_file: true
    pgpass_file: "/home/backup/.pgpass"
  
  # 备份工具选择
  backup_tool: "pg_dump"        # pg_dump/pg_dumpall
  
  # pg_dump参数
  dump_options:
    format: "custom"            # custom/plain/directory/tar
    verbose: true               # 详细输出
    
    # 备份内容
    data_only: false            # 仅数据
    schema_only: false          # 仅结构
    blobs: true                 # 包含大对象
    
    # 压缩设置
    compress_level: 6           # 0-9压缩级别
    
    # 并行备份（directory格式）
    parallel_jobs: 4            # 并行作业数
  
  # 数据库选择
  database_selection:
    mode: "include"             # include/exclude/all
    databases:                  # 包含的数据库
      - "production_db"
      - "user_data_db"
    exclude_databases:          # 排除的数据库
      - "template0"
      - "template1"
```

### 8.3 MongoDB备份配置 (mongodb_backup)

**🍃 MongoDB数据库备份设置**

```yaml
# MongoDB备份配置
mongodb_backup:
  # 连接配置
  connection:
    host: "localhost"
    port: 27017
    
    # 认证信息
    username: "backup_user"
    password: "{{ vault_mongodb_backup_password }}"
    auth_database: "admin"      # 认证数据库
    
    # 复制集配置
    replica_set: "rs0"          # 复制集名称
    read_preference: "secondary" # 从副本读取（减少主库压力）
  
  # 备份工具
  backup_tool: "mongodump"     # mongodump/mongoexport
  
  # mongodump参数
  dump_options:
    # 输出格式
    archive: true               # 输出为单个归档文件
    gzip: true                 # 启用压缩
    
    # 数据选择
    databases: []              # 空表示所有数据库
    collections: []            # 指定集合
    
    # 查询过滤
    query: "{}"                # 查询条件（JSON格式）
    
    # 并行设置
    num_parallel_collections: 4 # 并行备份的集合数
  
  # 一致性设置
  consistency:
    oplog: true                # 包含oplog（确保一致性）
    oplog_limit: 86400         # oplog时间限制（秒）
```

---

## 9. 📁 文件与系统备份配置


### 9.1 文件备份配置 (file_backup)

**📂 文件系统备份的精细化管理**

```yaml
# 文件备份配置
file_backup:
  # 全局文件备份设置
  global_settings:
    backup_method: "rsync"      # rsync/tar/cp
    preserve_permissions: true   # 保留权限
    preserve_ownership: true     # 保留所有者
    preserve_timestamps: true    # 保留时间戳
    follow_symlinks: false      # 不跟随符号链接
  
  # 备份目标配置
  backup_targets:
    # Web内容备份
    - name: "web_content"
      source_path: "/var/www/html"
      enabled: true
      priority: 1
      
      # 包含/排除规则
      include_patterns:
        - "*.html"
        - "*.css"
        - "*.js"
        - "*.php"
        - "uploads/"
      
      exclude_patterns:
        - "cache/*"
        - "*.tmp"
        - ".git/*"
        - "node_modules/*"
    
    # 用户数据备份
    - name: "user_data"
      source_path: "/home"
      enabled: true
      priority: 2
      
      # 大小限制
      max_file_size_mb: 100      # 跳过超过100MB的文件
      
      exclude_patterns:
        - ".cache/*"
        - ".thumbnails/*"
        - "*.iso"
        - "*.vmdk"
    
    # 应用配置备份
    - name: "app_configs"
      source_paths:              # 多个源路径
        - "/etc/nginx"
        - "/etc/apache2"
        - "/etc/ssl"
      enabled: true
      priority: 3
```

### 9.2 系统备份配置 (system_backup)

**⚙️ 系统级配置和状态备份**

```yaml
# 系统备份配置
system_backup:
  # 系统配置备份
  system_configs:
    enabled: true
    
    # 配置文件路径
    config_paths:
      - "/etc"                  # 系统配置目录
      - "/usr/local/etc"        # 本地配置
      - "/opt/*/conf"           # 应用配置（通配符）
    
    # 排除敏感文件
    exclude_sensitive:
      - "/etc/shadow"
      - "/etc/gshadow"
      - "*/password*"
      - "*/secret*"
    
    # 特殊处理
    mask_passwords: true        # 屏蔽密码字段
    anonymize_usernames: false  # 是否匿名化用户名
  
  # 系统状态备份
  system_state:
    enabled: true
    
    # 收集的系统信息
    collect_info:
      # 软件包信息
      package_list: true        # dpkg -l / rpm -qa
      package_sources: true     # /etc/apt/sources.list
      
      # 服务状态
      service_status: true      # systemctl list-units
      enabled_services: true    # systemctl list-unit-files
      
      # 网络配置
      network_config: true      # ip addr, route, iptables
      firewall_rules: true      # iptables-save, ufw status
      
      # 用户和权限
      user_accounts: true       # /etc/passwd (无密码)
      sudo_config: true         # /etc/sudoers
      
      # 系统信息
      hardware_info: true       # lshw, lscpu, lsmem
      kernel_modules: true      # lsmod
      cron_jobs: true          # crontab -l for all users
  
  # 自定义脚本备份
  custom_scripts:
    enabled: true
    
    # 备份前执行的脚本
    pre_backup_scripts:
      - name: "collect_logs"
        path: "/usr/local/bin/collect-app-logs.sh"
        timeout: 300
      
      - name: "database_status"
        path: "/usr/local/bin/check-db-status.sh"
        timeout: 60
    
    # 备份后执行的脚本
    post_backup_scripts:
      - name: "verify_backup"
        path: "/usr/local/bin/verify-backup-integrity.sh"
        timeout: 600
```

### 9.3 应用数据备份配置

**🏗️ 特定应用的数据备份策略**

```yaml
# 应用数据备份配置
application_backup:
  # Docker容器备份
  docker:
    enabled: false
    
    # 容器数据备份
    container_data:
      # 数据卷备份
      backup_volumes: true
      volume_backup_method: "tar"  # tar/rsync
      
      # 容器状态备份
      export_containers: true      # 导出容器为镜像
      save_compose_files: true     # 备份docker-compose.yml
    
    # 容器选择
    container_selection:
      mode: "include"             # include/exclude/all
      containers:
        - "web_app"
        - "database"
        - "redis"
  
  # Git仓库备份
  git_repositories:
    enabled: false
    
    # 仓库路径
    repo_paths:
      - "/opt/projects"
      - "/var/git"
    
    # 备份选项
    backup_options:
      clone_bare: true            # 克隆为裸仓库
      include_hooks: true         # 包含Git钩子
      compress_repos: true        # 压缩仓库
```

---

## 10. 🚀 高级备份策略


### 10.1 增量备份配置 (incremental_backup)

**📈 高效的增量备份策略**

```yaml
# 增量备份配置
incremental_backup:
  # 增量备份策略
  strategy: "timestamp_based"    # timestamp_based/checksum_based/database_log
  
  # 基于时间戳的增量备份
  timestamp_based:
    enabled: true
    
    # 基准设置
    full_backup_frequency: "weekly"  # weekly/monthly
    full_backup_day: "sunday"        # 全量备份日
    
    # 增量备份设置
    incremental_frequency: "daily"   # 增量备份频率
    reference_file: "/opt/backups/.last_backup_timestamp"
    
    # 文件选择策略
    selection_criteria:
      modified_after_last_backup: true    # 修改时间晚于上次备份
      created_after_last_backup: true     # 创建时间晚于上次备份
      min_file_age_minutes: 5             # 最小文件年龄（避免正在写入的文件）
  
  # 基于校验和的增量备份（精确但耗时）
  checksum_based:
    enabled: false
    checksum_algorithm: "md5"      # md5/sha1/sha256
    checksum_cache_file: "/opt/backups/.checksum_cache"
    
    # 性能优化
    parallel_checksum_jobs: 4      # 并行计算校验和
    cache_checksums: true          # 缓存校验和避免重复计算
    incremental_checksum: true     # 仅对修改的文件重新计算
```

### 10.2 差异备份配置 (differential_backup)

**📊 差异备份的高效实现**

```yaml
# 差异备份配置
differential_backup:
  # 差异备份策略
  enabled: true
  
  # 基准全量备份
  baseline_backup:
    frequency: "weekly"           # 每周一次全量备份
    retention_period: "monthly"   # 全量备份保留一个月
    
  # 差异备份设置
  differential_settings:
    # 差异检测方法
    detection_method: "file_modification_time"  # 文件修改时间
    # detection_method: "content_hash"          # 内容哈希（更精确）
    
    # 差异备份频率
    frequency: "daily"
    
    # 差异备份保留策略
    retention_days: 7             # 差异备份保留7天
    
    # 链式差异备份
    chain_differentials: false    # false=相对于全量备份，true=相对于上一次差异备份
  
  # 恢复策略配置
  restore_strategy:
    # 恢复顺序：全量备份 + 最新差异备份
    restore_order:
      1: "latest_full_backup"
      2: "latest_differential_backup"
    
    # 验证恢复完整性
    verify_restore: true
    verification_method: "file_count_and_size"
```

### 10.3 备份验证配置 (verification_config)

**✅ 确保备份质量的验证机制**

```yaml
# 验证配置
verification_config:
  # 备份完整性验证
  integrity_verification:
    enabled: true
    
    # 验证方法
    methods:
      # 文件完整性检查
      - type: "file_integrity"
        checksum_algorithm: "sha256"
        verify_all_files: false        # 验证所有文件（耗时）
        sample_verification: true      # 抽样验证
        sample_percentage: 10          # 验证10%的文件
      
      # 压缩文件完整性
      - type: "archive_integrity"
        test_extraction: true          # 测试解压缩
        extract_sample_files: true     # 解压部分文件验证
      
      # 数据库备份验证
      - type: "database_verification"
        test_restore: false            # 不进行完整恢复测试（耗时）
        syntax_check: true             # SQL语法检查
        connection_test: true          # 连接测试
  
  # 备份可用性验证
  usability_verification:
    enabled: true
    
    # 定期恢复测试
    restore_testing:
      frequency: "monthly"             # 每月一次
      test_environment: "test_server"  # 测试服务器
      test_scope: "sample_data"        # sample_data/full_data
      
      # 自动化恢复测试
      automated_tests:
        - name: "database_restore_test"
          type: "mysql"
          test_queries:
            - "SELECT COUNT(*) FROM users"
            - "SELECT * FROM config LIMIT 1"
        
        - name: "file_restore_test"
          type: "files"
          test_files:
            - "/etc/nginx/nginx.conf"
            - "/var/www/html/index.html"
  
  # 验证报告
  reporting:
    generate_reports: true
    report_format: "html"            # html/json/text
    report_path: "/var/log/backup-verification-reports/"
    
    # 报告内容
    include_in_report:
      - verification_summary
      - failed_verifications
      - performance_metrics
      - recommendations
```

---

## 11. 📋 核心要点总结


### 11.1 必须掌握的核心概念


```
🔸 备份配置体系：全局配置→类型配置→主机配置的层次结构
🔸 调度管理：cron表达式、冲突避免、业务时间避让
🔸 保留策略：分层保留、自动清理、存储空间管理
🔸 压缩加密：算法选择、性能平衡、安全性保证
🔸 存储策略：本地存储、网络存储、云存储的组合使用
🔸 数据库备份：MySQL、PostgreSQL、MongoDB的专业配置
🔸 增量差异：增量备份、差异备份的原理和配置
🔸 验证机制：完整性验证、可用性验证、自动化测试
```

### 11.2 关键理解要点


**🔹 配置文件的层次化管理**
```
配置优先级（从高到低）：
host_vars（主机特定）> group_vars（组配置）> 默认值

实际应用策略：
- 通用设置放在group_vars/all.yml
- 数据库设置放在group_vars/database.yml  
- 特殊主机设置放在host_vars/hostname.yml
- 敏感信息使用ansible-vault加密
```

**🔹 备份策略的3-2-1原则**
```
3份数据：
- 1份原始生产数据
- 2份备份副本（不同位置）

2种存储介质：
- 本地快速存储（SSD/机械硬盘）
- 远程存储（网络存储/云存储）

1份离线存储：
- 异地备份或冷存储
- 防范区域性灾难和网络攻击
```

**🔹 备份性能优化策略**
```
时间优化：
- 增量备份减少数据量
- 并行备份提高效率  
- 业务低峰期执行

空间优化：
- 压缩减少存储占用
- 智能保留策略
- 重复数据删除

资源优化：
- 限制CPU和内存使用
- 网络带宽控制
- 磁盘I/O优先级调整
```

### 11.3 实际应用价值


**🎯 企业级应用场景**
- **金融系统**：严格的数据保护和合规要求
- **电商平台**：大数据量的高效备份和快速恢复
- **医疗系统**：长期数据保留和隐私保护
- **教育机构**：多样化数据的统一备份管理

**🔧 运维最佳实践**
- **标准化配置**：建立企业级备份配置模板
- **自动化运维**：减少人工干预和操作错误
- **监控告警**：及时发现备份失败和异常情况
- **定期测试**：验证备份可用性和恢复流程

**📈 技术发展趋势**
- **云原生备份**：容器化应用的备份策略
- **智能化管理**：AI辅助的备份策略优化
- **实时备份**：近实时的数据保护技术
- **跨云备份**：多云环境的统一备份管理

**核心记忆口诀**：
- 配置分层管理清，调度策略要精准
- 压缩加密保安全，存储多样降风险  
- 数据库备份有专门，文件系统全覆盖
- 增量差异提效率，验证测试保质量