---
title: 15ã€å®¹å™¨åŒ–é…ç½®æ–‡ä»¶
---
## ğŸ“š ç›®å½•

1. [å®¹å™¨åŒ–é…ç½®æ¦‚è¿°](#1-å®¹å™¨åŒ–é…ç½®æ¦‚è¿°)
2. [Ansible-Runnerè¿è¡Œå™¨é…ç½®](#2-Ansible-Runnerè¿è¡Œå™¨é…ç½®)
3. [æ‰§è¡Œç¯å¢ƒé…ç½®è¯¦è§£](#3-æ‰§è¡Œç¯å¢ƒé…ç½®è¯¦è§£)
4. [å®¹å™¨è¿æ¥æ’ä»¶é…ç½®](#4-å®¹å™¨è¿æ¥æ’ä»¶é…ç½®)
5. [å®¹å™¨æ¸…å•ç®¡ç†](#5-å®¹å™¨æ¸…å•ç®¡ç†)
6. [Dockerä¸Podmané›†æˆ](#6-Dockerä¸Podmané›†æˆ)
7. [Kubernetesé›†æˆé…ç½®](#7-Kubernetesé›†æˆé…ç½®)
8. [å®¹å™¨åŒ–å®è·µæŒ‡å—](#8-å®¹å™¨åŒ–å®è·µæŒ‡å—)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ³ å®¹å™¨åŒ–é…ç½®æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯Ansibleå®¹å™¨åŒ–


**ğŸ”¸ å®¹å™¨åŒ–çš„æœ¬è´¨**
```
ä¼ ç»ŸAnsibleè¿è¡Œæ–¹å¼ï¼š
ä¸»æœº â†’ å®‰è£…Ansible â†’ æ‰§è¡Œä»»åŠ¡ â†’ ç›®æ ‡æœºå™¨

å®¹å™¨åŒ–Ansibleè¿è¡Œæ–¹å¼ï¼š
ä¸»æœº â†’ å®¹å™¨(åŒ…å«Ansible) â†’ æ‰§è¡Œä»»åŠ¡ â†’ ç›®æ ‡æœºå™¨

ä¼˜åŠ¿ï¼šç¯å¢ƒéš”ç¦»ã€ç‰ˆæœ¬ç»Ÿä¸€ã€éƒ¨ç½²ç®€å•
```

**ğŸ’¡ ä¸ºä»€ä¹ˆè¦å®¹å™¨åŒ–**
- **ç¯å¢ƒä¸€è‡´æ€§**ï¼šæ‰€æœ‰äººç”¨ç›¸åŒçš„Ansibleç‰ˆæœ¬å’Œä¾èµ–
- **éš”ç¦»æ€§**ï¼šä¸æ±¡æŸ“ä¸»æœºç¯å¢ƒï¼Œé¿å…ä¾èµ–å†²çª
- **å¯ç§»æ¤æ€§**ï¼šä¸€æ¬¡æ„å»ºï¼Œåˆ°å¤„è¿è¡Œ
- **ç‰ˆæœ¬ç®¡ç†**ï¼šå¯ä»¥åŒæ—¶ä½¿ç”¨å¤šä¸ªAnsibleç‰ˆæœ¬

### 1.2 å®¹å™¨åŒ–æ ¸å¿ƒç»„ä»¶


```
Ansibleå®¹å™¨åŒ–æ¶æ„å›¾ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä¸»æœºæ“ä½œç³»ç»Ÿ       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   å®¹å™¨å¼•æ“          â”‚ â† Docker/Podman/Buildah
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Ansibleå®¹å™¨       â”‚ â† åŒ…å«AnsibleåŠå…¶ä¾èµ–
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Ansible Core    â”‚ â”‚ â† æ ¸å¿ƒæ‰§è¡Œå¼•æ“
â”‚ â”‚ Collections     â”‚ â”‚ â† å„ç§åŠŸèƒ½é›†åˆ
â”‚ â”‚ Pythonä¾èµ–      â”‚ â”‚ â† è¿è¡Œæ—¶ç¯å¢ƒ
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   é…ç½®æ–‡ä»¶          â”‚ â† æœ¬ç« é‡ç‚¹å†…å®¹
â”‚ â€¢ ansible.cfg      â”‚
â”‚ â€¢ inventory         â”‚
â”‚ â€¢ playbooks        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸš€ Ansible-Runnerè¿è¡Œå™¨é…ç½®


### 2.1 ä»€ä¹ˆæ˜¯Ansible-Runner


**ğŸ”¸ æ ¸å¿ƒæ¦‚å¿µ**
- **Ansible-Runner**ï¼šAnsibleçš„å®˜æ–¹å®¹å™¨åŒ–è¿è¡Œå·¥å…·
- **ä½œç”¨**ï¼šå°†Ansibleä»»åŠ¡æ‰“åŒ…æˆå®¹å™¨è¿è¡Œ
- **ä¼˜åŠ¿**ï¼šæ ‡å‡†åŒ–ã€éš”ç¦»ã€æ˜“äºé›†æˆCI/CD

### 2.2 Runneré¡¹ç›®ç»“æ„


```
å…¸å‹çš„ansible-runneré¡¹ç›®ç»“æ„ï¼š

my-ansible-project/
â”œâ”€â”€ project/                    â† é¡¹ç›®æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ playbook.yml           â† ä¸»è¦çš„å‰§æœ¬æ–‡ä»¶
â”‚   â”œâ”€â”€ roles/                 â† è§’è‰²ç›®å½•
â”‚   â””â”€â”€ group_vars/            â† ç»„å˜é‡
â”œâ”€â”€ inventory/                  â† æ¸…å•ç›®å½•
â”‚   â””â”€â”€ hosts                  â† ä¸»æœºæ¸…å•
â”œâ”€â”€ env/                       â† ç¯å¢ƒé…ç½®
â”‚   â”œâ”€â”€ settings               â† è¿è¡Œè®¾ç½®
â”‚   â””â”€â”€ ssh_key                â† SSHå¯†é’¥
â””â”€â”€ artifacts/                 â† è¿è¡Œç»“æœè¾“å‡º
    â”œâ”€â”€ stdout                 â† æ ‡å‡†è¾“å‡º
    â””â”€â”€ job_events/           â† ä»»åŠ¡äº‹ä»¶
```

### 2.3 RunneråŸºç¡€é…ç½®


**ğŸ”§ settingsæ–‡ä»¶é…ç½®**
```ini
# env/settings - è¿è¡Œå™¨åŸºæœ¬è®¾ç½®
[defaults]
host_key_checking = False       # è·³è¿‡SSHä¸»æœºå¯†é’¥æ£€æŸ¥
timeout = 300                  # ä»»åŠ¡è¶…æ—¶æ—¶é—´(ç§’)
forks = 5                      # å¹¶å‘æ‰§è¡Œæ•°
gather_facts = True            # æ˜¯å¦æ”¶é›†ä¸»æœºä¿¡æ¯

[ssh_connection]
ssh_args = -o ControlMaster=auto -o ControlPersist=60s
control_path_dir = /tmp/.ansible-cp
```

**ğŸ’» è¿è¡Œå‘½ä»¤ç¤ºä¾‹**
```bash
# åŸºæœ¬è¿è¡Œå‘½ä»¤
ansible-runner run /path/to/project -p playbook.yml

# ä½¿ç”¨å®¹å™¨è¿è¡Œ
ansible-runner run /path/to/project -p playbook.yml \
  --container-image quay.io/ansible/ansible-runner:latest
```

---

## 3. ğŸ—ï¸ æ‰§è¡Œç¯å¢ƒé…ç½®è¯¦è§£


### 3.1 execution-environment.ymlè¯¦è§£


**ğŸ”¸ ä»€ä¹ˆæ˜¯æ‰§è¡Œç¯å¢ƒé…ç½®**
- **æ‰§è¡Œç¯å¢ƒ**ï¼šåŒ…å«AnsibleåŠå…¶ä¾èµ–çš„å®¹å™¨é•œåƒ
- **é…ç½®æ–‡ä»¶**ï¼š`execution-environment.yml`
- **ä½œç”¨**ï¼šå®šä¹‰å®¹å™¨é•œåƒæ„å»ºè§„åˆ™

**ğŸ“‹ å®Œæ•´é…ç½®ç¤ºä¾‹**
```yaml
# execution-environment.yml
---
version: 3

# åŸºç¡€é•œåƒé…ç½®
build_arg_defaults:
  ANSIBLE_GALAXY_CLI_COLLECTION_OPTS: "--pre"

# ä¾èµ–é…ç½®
dependencies:
  galaxy: requirements.yml          # Galaxyä¾èµ–
  python: requirements.txt          # Pythonä¾èµ–  
  system: bindep.txt               # ç³»ç»ŸåŒ…ä¾èµ–

# é•œåƒä¿¡æ¯
images:
  base_image:
    name: 'registry.redhat.io/ubi8/ubi:latest'

# æ„å»ºæ­¥éª¤
additional_build_steps:
  prepend_base: |
    RUN whoami
    RUN cat /etc/os-release
  prepend_galaxy: |
    RUN ansible-galaxy collection install community.general
  prepend_builder: |
    RUN pip3 install --upgrade pip setuptools
  append_final: |
    RUN ls -la /usr/share/ansible
```

### 3.2 ä¾èµ–æ–‡ä»¶é…ç½®


**ğŸ”¸ Galaxyä¾èµ– (requirements.yml)**
```yaml
# requirements.yml - Collectionä¾èµ–é…ç½®
---
collections:
  # Dockeræ“ä½œé›†åˆ
  - name: community.docker
    version: ">=3.0.0"
  
  # Kubernetesæ“ä½œé›†åˆ  
  - name: kubernetes.core
    version: ">=2.3.0"
    
  # é€šç”¨å·¥å…·é›†åˆ
  - name: community.general
    version: ">=6.0.0"

  # ä»Gitå®‰è£…å¼€å‘ç‰ˆæœ¬
  - name: https://github.com/my-org/my-collection.git
    type: git
    version: main
```

**ğŸ”¸ Pythonä¾èµ– (requirements.txt)**
```txt
# requirements.txt - PythonåŒ…ä¾èµ–
docker>=6.0.0              # Docker SDK
kubernetes>=24.0.0          # Kuberneteså®¢æˆ·ç«¯
openshift>=0.13.0          # OpenShiftå®¢æˆ·ç«¯
jmespath>=1.0.0            # JSONæŸ¥è¯¢è¯­è¨€
netaddr>=0.8.0             # ç½‘ç»œåœ°å€å¤„ç†
```

**ğŸ”¸ ç³»ç»Ÿä¾èµ– (bindep.txt)**
```txt
# bindep.txt - ç³»ç»ŸåŒ…ä¾èµ–é…ç½®
git [platform:rpm platform:deb]       # Gitç‰ˆæœ¬æ§åˆ¶
rsync [platform:rpm platform:deb]     # æ–‡ä»¶åŒæ­¥å·¥å…·
openssh-clients [platform:rpm]        # SSHå®¢æˆ·ç«¯(RPM)
openssh-client [platform:deb]         # SSHå®¢æˆ·ç«¯(DEB)
```

### 3.3 Dockerfileæ·±åº¦å®šåˆ¶


**ğŸ”¸ è‡ªå®šä¹‰Dockerfile**
```dockerfile
# Dockerfile - å®Œå…¨è‡ªå®šä¹‰å®¹å™¨é•œåƒ
FROM registry.redhat.io/ubi8/ubi:latest

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /tmp/build

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN dnf -y update && \
    dnf -y install python3 python3-pip git rsync openssh-clients && \
    dnf clean all

# å®‰è£…Ansible
RUN pip3 install ansible-core>=2.14

# å®‰è£…Collections
COPY requirements.yml /tmp/requirements.yml
RUN ansible-galaxy collection install -r /tmp/requirements.yml

# åˆ›å»ºè¿è¡Œç”¨æˆ·
RUN useradd -u 1000 -m ansible
USER 1000

# è®¾ç½®å…¥å£ç‚¹
ENTRYPOINT ["ansible-playbook"]
```

---

## 4. ğŸ”Œ å®¹å™¨è¿æ¥æ’ä»¶é…ç½®


### 4.1 è¿æ¥æ’ä»¶æ¦‚è¿°


**ğŸ”¸ ä»€ä¹ˆæ˜¯è¿æ¥æ’ä»¶**
```
è¿æ¥æ’ä»¶ä½œç”¨å›¾ï¼š

Ansibleæ§åˆ¶èŠ‚ç‚¹ â”€â”€è¿æ¥æ’ä»¶â”€â”€â†’ ç›®æ ‡å®¹å™¨
                    â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚         â”‚         â”‚
    docker_connection â”‚  podman_connection
                      â”‚
              buildah_connection
```

- **è¿æ¥æ’ä»¶**ï¼šAnsibleä¸ç›®æ ‡ç³»ç»Ÿé€šä¿¡çš„æ¡¥æ¢
- **å®¹å™¨è¿æ¥**ï¼šä¸“é—¨ç”¨äºæ“ä½œå®¹å™¨çš„è¿æ¥æ–¹å¼
- **ä¼˜åŠ¿**ï¼šæ— éœ€SSHï¼Œç›´æ¥æ“ä½œå®¹å™¨å†…éƒ¨

### 4.2 Dockerè¿æ¥æ’ä»¶é…ç½®


**ğŸ”¸ åŸºæœ¬é…ç½®**
```yaml
# inventoryä¸­çš„Dockerè¿æ¥é…ç½®
[docker_containers]
web_container ansible_connection=docker
db_container ansible_connection=docker

[docker_containers:vars]
# æŒ‡å®šDockerè¿æ¥æ’ä»¶
ansible_connection=docker
# Dockerå®ˆæŠ¤è¿›ç¨‹åœ°å€
ansible_docker_host=unix://var/run/docker.sock  
# å®¹å™¨å†…çš„Pythonè§£é‡Šå™¨è·¯å¾„
ansible_python_interpreter=/usr/bin/python3
```

**ğŸ”§ é«˜çº§é…ç½®é€‰é¡¹**
```yaml
# group_vars/docker_containers.yml
---
# Dockerè¿æ¥é…ç½®
ansible_connection: docker

# è¿æ¥è¶…æ—¶è®¾ç½®
ansible_docker_timeout: 30

# ä¸´æ—¶ç›®å½•é…ç½®
remote_tmp: /tmp/.ansible-tmp

# æƒé™æå‡é…ç½®
become: true
become_method: sudo
become_user: root

# Dockerå¼•æ“é…ç½®
docker_host: "tcp://docker.example.com:2376"  # è¿œç¨‹Docker
docker_tls_verify: true                       # TLSéªŒè¯
docker_cert_path: "/home/user/.docker"        # è¯ä¹¦è·¯å¾„
```

### 4.3 Podmanè¿æ¥æ’ä»¶é…ç½®


**ğŸ”¸ Podman vs Dockerå¯¹æ¯”**

| ç‰¹æ€§ | **Docker** | **Podman** |
|------|-----------|-----------|
| **æ¶æ„** | `å®ˆæŠ¤è¿›ç¨‹æ¨¡å¼` | `æ— å®ˆæŠ¤è¿›ç¨‹` |
| **æƒé™** | `éœ€è¦rootæƒé™` | `æ”¯æŒrootless` |
| **å®‰å…¨æ€§** | `ç›¸å¯¹è¾ƒä½` | `æ›´å®‰å…¨` |
| **å…¼å®¹æ€§** | `Docker API` | `å…¼å®¹Dockerå‘½ä»¤` |

**ğŸ”§ Podmanè¿æ¥é…ç½®**
```yaml
# inventoryé…ç½®
[podman_containers]
app_container ansible_connection=podman

[podman_containers:vars]
ansible_connection=podman
# Podman socketè·¯å¾„
ansible_podman_socket=unix:///run/user/1000/podman/podman.sock
# æ‰§è¡Œç”¨æˆ·
ansible_user=myuser
```

### 4.4 Buildahè¿æ¥æ’ä»¶


**ğŸ”¸ Buildahç‰¹ç‚¹**
- **ä¸“ç”¨äºæ„å»º**ï¼šä¸“é—¨ç”¨äºå®¹å™¨é•œåƒæ„å»º
- **OCIæ ‡å‡†**ï¼šç¬¦åˆå¼€æ”¾å®¹å™¨æ ‡å‡†
- **æ— å®ˆæŠ¤è¿›ç¨‹**ï¼šç±»ä¼¼Podmanæ¶æ„

**ğŸ”§ é…ç½®ç¤ºä¾‹**
```yaml
# Buildahè¿æ¥é…ç½®
[buildah_containers]
build_container ansible_connection=buildah

[buildah_containers:vars]
ansible_connection=buildah
buildah_format=oci                    # é•œåƒæ ¼å¼
buildah_isolation=chroot             # éš”ç¦»æ¨¡å¼
```

---

## 5. ğŸ“‹ å®¹å™¨æ¸…å•ç®¡ç†


### 5.1 ä»€ä¹ˆæ˜¯å®¹å™¨æ¸…å•


**ğŸ”¸ å®¹å™¨æ¸…å•æ¦‚å¿µ**
- **container_inventory**ï¼šä¸“é—¨ç®¡ç†å®¹å™¨çš„æ¸…å•
- **åŠ¨æ€å‘ç°**ï¼šè‡ªåŠ¨å‘ç°è¿è¡Œä¸­çš„å®¹å™¨
- **åˆ†ç»„ç®¡ç†**ï¼šæŒ‰ç…§æ ‡ç­¾ã€ç½‘ç»œç­‰åˆ†ç»„

### 5.2 DockeråŠ¨æ€æ¸…å•


**ğŸ”§ Dockeræ¸…å•æ’ä»¶é…ç½®**
```yaml
# docker_inventory.yml
---
plugin: community.docker.docker_containers

# Dockerè¿æ¥é…ç½®
docker_host: unix://var/run/docker.sock
api_version: auto

# å®¹å™¨è¿‡æ»¤
filters:
  status: running                     # åªåŒ…å«è¿è¡Œä¸­çš„å®¹å™¨
  label: "environment=production"     # æŒ‰æ ‡ç­¾è¿‡æ»¤

# åˆ†ç»„è§„åˆ™
groups:
  # æŒ‰é•œåƒåˆ†ç»„
  docker_image_nginx: docker_image == 'nginx'
  docker_image_mysql: docker_image == 'mysql'
  
  # æŒ‰ç½‘ç»œåˆ†ç»„  
  frontend_network: "'frontend' in docker_networks"
  backend_network: "'backend' in docker_networks"

# å˜é‡è®¾ç½®
compose:
  ansible_host: docker_name
  ansible_connection: docker
  docker_image: docker_image
  docker_networks: docker_networks
```

**ğŸ’» ä½¿ç”¨åŠ¨æ€æ¸…å•**
```bash
# æµ‹è¯•æ¸…å•
ansible-inventory -i docker_inventory.yml --list

# ä½¿ç”¨æ¸…å•è¿è¡Œå‰§æœ¬
ansible-playbook -i docker_inventory.yml site.yml
```

### 5.3 KubernetesåŠ¨æ€æ¸…å•


**ğŸ”§ K8sæ¸…å•æ’ä»¶é…ç½®**
```yaml
# k8s_inventory.yml  
---
plugin: kubernetes.core.k8s

# è¿æ¥é…ç½®
kubeconfig: ~/.kube/config
context: production-cluster

# èµ„æºç±»å‹
connections:
  - kubeconfig: ~/.kube/config
    
# åŒ…å«çš„èµ„æº
resources:
  - group: ""
    api_version: v1
    kind: Pod
    namespace: default

# åˆ†ç»„è§„åˆ™
groups:
  # æŒ‰å‘½åç©ºé—´åˆ†ç»„
  k8s_namespace_default: k8s_namespace == "default"
  k8s_namespace_kube_system: k8s_namespace == "kube-system"
  
  # æŒ‰åº”ç”¨æ ‡ç­¾åˆ†ç»„
  k8s_app_nginx: k8s_labels.app == "nginx"
  k8s_app_mysql: k8s_labels.app == "mysql"
```

---

## 6. ğŸ‹ Dockerä¸Podmané›†æˆ


### 6.1 Community.Dockeré›†åˆè¯¦è§£


**ğŸ”¸ é›†åˆåŠŸèƒ½æ¦‚è¿°**
```
community.dockeré›†åˆæä¾›çš„æ¨¡å—ï¼š

å®¹å™¨ç®¡ç†ï¼š
â”œâ”€â”€ docker_container    â† å®¹å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†
â”œâ”€â”€ docker_image       â† é•œåƒç®¡ç†  
â””â”€â”€ docker_compose     â† Composeç¼–æ’

ç½‘ç»œç®¡ç†ï¼š
â”œâ”€â”€ docker_network     â† ç½‘ç»œåˆ›å»ºå’Œç®¡ç†
â””â”€â”€ docker_volume      â† å·ç®¡ç†

ç³»ç»Ÿç®¡ç†ï¼š
â”œâ”€â”€ docker_info        â† Dockerç³»ç»Ÿä¿¡æ¯
â”œâ”€â”€ docker_login       â† ä»“åº“ç™»å½•
â””â”€â”€ docker_prune       â† æ¸…ç†èµ„æº
```

**ğŸ”§ å®¹å™¨ç®¡ç†ç¤ºä¾‹**
```yaml
---
- name: å®¹å™¨ç®¡ç†ç¤ºä¾‹
  hosts: localhost
  tasks:
    # åˆ›å»ºå¹¶å¯åŠ¨å®¹å™¨
    - name: å¯åŠ¨Nginxå®¹å™¨
      community.docker.docker_container:
        name: web_server
        image: nginx:latest
        state: started
        ports:
          - "80:80"
          - "443:443"
        volumes:
          - "/host/data:/var/www/html"
        environment:
          NGINX_HOST: example.com
        restart_policy: always
        
    # åœæ­¢å¹¶åˆ é™¤å®¹å™¨
    - name: åœæ­¢å®¹å™¨
      community.docker.docker_container:
        name: web_server
        state: absent
```

### 6.2 ç½‘ç»œå’Œå·é…ç½®


**ğŸ”¸ ç½‘ç»œç®¡ç†**
```yaml
- name: Dockerç½‘ç»œç®¡ç†
  hosts: localhost
  tasks:
    # åˆ›å»ºè‡ªå®šä¹‰ç½‘ç»œ
    - name: åˆ›å»ºå‰ç«¯ç½‘ç»œ
      community.docker.docker_network:
        name: frontend_network
        driver: bridge
        ipam_config:
          - subnet: 172.20.0.0/16
            gateway: 172.20.0.1
    
    # è¿æ¥å®¹å™¨åˆ°ç½‘ç»œ
    - name: è¿æ¥å®¹å™¨åˆ°ç½‘ç»œ
      community.docker.docker_container:
        name: app_container
        networks:
          - name: frontend_network
            ipv4_address: 172.20.0.10
```

**ğŸ”¸ å·ç®¡ç†**
```yaml
- name: Dockerå·ç®¡ç†
  tasks:
    # åˆ›å»ºæ•°æ®å·
    - name: åˆ›å»ºåº”ç”¨æ•°æ®å·
      community.docker.docker_volume:
        name: app_data
        driver: local
        driver_options:
          type: none
          o: bind
          device: /host/app/data
    
    # ä½¿ç”¨å·
    - name: å¯åŠ¨å¸¦å·çš„å®¹å™¨
      community.docker.docker_container:
        name: database
        image: mysql:8.0
        volumes:
          - app_data:/var/lib/mysql
```

### 6.3 Podmanç‰¹å®šé…ç½®


**ğŸ”¸ Podmané›†åˆä½¿ç”¨**
```yaml
---
- name: Podmanå®¹å™¨ç®¡ç†
  hosts: localhost
  tasks:
    # ä½¿ç”¨Podmanè¿è¡Œå®¹å™¨
    - name: åˆ›å»ºPodmanå®¹å™¨
      containers.podman.podman_container:
        name: redis_cache
        image: redis:alpine
        state: started
        publish:
          - "6379:6379"
        # Podmanç‰¹æœ‰é€‰é¡¹
        userns: keep-id              # ä¿æŒç”¨æˆ·å‘½åç©ºé—´
        security_opt:
          - "label=disable"          # ç¦ç”¨SELinuxæ ‡ç­¾
```

---

## 7. â˜¸ï¸ Kubernetesé›†æˆé…ç½®


### 7.1 Kubernetes.Coreé›†åˆ


**ğŸ”¸ æ ¸å¿ƒæ¨¡å—æ¦‚è§ˆ**
```
kubernetes.coreé›†åˆæ¶æ„ï¼š

èµ„æºç®¡ç†ï¼š
â”œâ”€â”€ k8s                â† é€šç”¨èµ„æºç®¡ç†
â”œâ”€â”€ k8s_info          â† èµ„æºä¿¡æ¯æŸ¥è¯¢
â””â”€â”€ k8s_scale         â† èµ„æºæ‰©ç¼©å®¹

é…ç½®ç®¡ç†ï¼š
â”œâ”€â”€ k8s_config_resource_name  â† é…ç½®èµ„æº
â””â”€â”€ k8s_drain                 â† èŠ‚ç‚¹ç»´æŠ¤

è¿æ¥é…ç½®ï¼š
â”œâ”€â”€ kubeconfig        â† é›†ç¾¤è¿æ¥é…ç½®
â””â”€â”€ k8s_auth          â† è®¤è¯é…ç½®
```

### 7.2 åŸºç¡€K8sé…ç½®


**ğŸ”§ é›†ç¾¤è¿æ¥é…ç½®**
```yaml
# group_vars/k8s_cluster.yml
---
# Kubernetesè¿æ¥é…ç½®
k8s_auth:
  kubeconfig: /home/ansible/.kube/config
  context: production-cluster

# é»˜è®¤å‘½åç©ºé—´
k8s_namespace: default

# APIæœåŠ¡å™¨é…ç½®
k8s_host: https://k8s-api.example.com:6443
k8s_verify_ssl: true
k8s_ca_cert: /etc/ssl/certs/k8s-ca.crt

# è®¤è¯ä»¤ç‰Œ
k8s_api_key: "{{ vault_k8s_token }}"
```

**ğŸš€ èµ„æºéƒ¨ç½²ç¤ºä¾‹**
```yaml
---
- name: Kubernetesåº”ç”¨éƒ¨ç½²
  hosts: localhost
  tasks:
    # éƒ¨ç½²åº”ç”¨
    - name: éƒ¨ç½²Webåº”ç”¨
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: web-app
            namespace: production
          spec:
            replicas: 3
            selector:
              matchLabels:
                app: web-app
            template:
              metadata:
                labels:
                  app: web-app
              spec:
                containers:
                - name: web
                  image: nginx:1.21
                  ports:
                  - containerPort: 80
                  
    # åˆ›å»ºæœåŠ¡
    - name: åˆ›å»ºæœåŠ¡
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: web-service
          spec:
            selector:
              app: web-app
            ports:
            - port: 80
              targetPort: 80
            type: LoadBalancer
```

---

## 8. ğŸ› ï¸ å®¹å™¨åŒ–å®è·µæŒ‡å—


### 8.1 ç¯å¢ƒé…ç½®æœ€ä½³å®è·µ


**ğŸ”¸ é…ç½®å±‚æ¬¡ç»“æ„**
```
é…ç½®ä¼˜å…ˆçº§ï¼ˆä»é«˜åˆ°ä½ï¼‰ï¼š

1. å‘½ä»¤è¡Œå‚æ•°        â† ä¸´æ—¶è¦†ç›–
   --extra-vars      
   
2. å‰§æœ¬å˜é‡          â† å‰§æœ¬çº§é…ç½®
   vars:
   
3. æ¸…å•å˜é‡          â† ä¸»æœº/ç»„é…ç½®
   host_vars/
   group_vars/
   
4. è§’è‰²é»˜è®¤å€¼        â† è§’è‰²é…ç½®
   defaults/main.yml
   
5. é…ç½®æ–‡ä»¶          â† å…¨å±€é…ç½®
   ansible.cfg
```

**âš™ï¸ å®¹å™¨ç‰¹å®šé…ç½®**
```yaml
# group_vars/containers.yml
---
# å®¹å™¨é€šç”¨é…ç½®
ansible_python_interpreter: /usr/bin/python3

# è¿œç¨‹ä¸´æ—¶ç›®å½•
remote_tmp: /tmp/.ansible-tmp-${USER}

# å®¹å™¨å¼•æ“é€‰æ‹©
container_engine: docker  # å¯é€‰: docker, podman, buildah

# ç½‘ç»œæ¨¡å¼
network_mode: bridge      # å¯é€‰: bridge, host, none

# æƒé™æå‡
become_method: sudo       # å®¹å™¨å†…æƒé™æå‡æ–¹å¼
```

### 8.2 æ€§èƒ½è°ƒä¼˜é…ç½®


**âš¡ å¹¶å‘å’Œè¶…æ—¶è®¾ç½®**
```ini
# ansible.cfg å®¹å™¨åŒ–æ€§èƒ½é…ç½®
[defaults]
# å¹¶å‘æ•°ï¼ˆå®¹å™¨ç¯å¢ƒå¯é€‚å½“å¢åŠ ï¼‰
forks = 20

# SSHè¿æ¥å¤ç”¨ï¼ˆå®¹å™¨é—´ç½‘ç»œè¾ƒå¿«ï¼‰
[ssh_connection]
ssh_args = -o ControlMaster=auto -o ControlPersist=300s
pipelining = True

# è¶…æ—¶è®¾ç½®
timeout = 60
gather_timeout = 30
```

**ğŸš€ ç¼“å­˜é…ç½®**
```ini
# äº‹å®ç¼“å­˜é…ç½®ï¼ˆé¿å…é‡å¤æ”¶é›†ï¼‰
[defaults]
gathering = smart
fact_caching = jsonfile
fact_caching_connection = /tmp/ansible_fact_cache
fact_caching_timeout = 3600
```

### 8.3 å®‰å…¨é…ç½®


**ğŸ”’ å®‰å…¨æœ€ä½³å®è·µ**
```yaml
# å®‰å…¨é…ç½®ç¤ºä¾‹
---
# å®¹å™¨å®‰å…¨é…ç½®
container_security_opts:
  - "no-new-privileges:true"    # ç¦æ­¢æå‡æƒé™
  - "seccomp=unconfined"       # ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤
  
# ç”¨æˆ·æ˜ å°„
container_user_ns_mode: "host"  # ç”¨æˆ·å‘½åç©ºé—´æ¨¡å¼

# åªè¯»æ ¹æ–‡ä»¶ç³»ç»Ÿ
container_read_only: true

# ä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿ
container_tmpfs:
  - /tmp
  - /var/tmp

# èµ„æºé™åˆ¶
container_memory_limit: "512m"
container_cpu_limit: "1.0"
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å®¹å™¨åŒ–æœ¬è´¨ï¼šå°†AnsibleåŠå…¶ä¾èµ–æ‰“åŒ…åˆ°å®¹å™¨ä¸­è¿è¡Œ
ğŸ”¸ æ‰§è¡Œç¯å¢ƒï¼šé€šè¿‡execution-environment.ymlå®šä¹‰å®¹å™¨æ„å»ºè§„åˆ™
ğŸ”¸ è¿æ¥æ’ä»¶ï¼šdocker/podman/buildahè¿æ¥æ’ä»¶ç”¨äºæ“ä½œå®¹å™¨
ğŸ”¸ åŠ¨æ€æ¸…å•ï¼šè‡ªåŠ¨å‘ç°å’Œç®¡ç†å®¹å™¨èµ„æº
ğŸ”¸ é›†åˆé›†æˆï¼šcommunity.dockerå’Œkubernetes.coreæä¾›å®¹å™¨æ“ä½œèƒ½åŠ›
```

### 9.2 å…³é”®é…ç½®è¦ç‚¹


**ğŸ”¹ é…ç½®æ–‡ä»¶å±‚æ¬¡**
```
ç¯å¢ƒéš”ç¦» â†’ ç‰ˆæœ¬ç»Ÿä¸€ â†’ éƒ¨ç½²ç®€å• â†’ è¿ç»´é«˜æ•ˆ

execution-environment.yml  â† å®šä¹‰å®¹å™¨æ„å»º
ansible.cfg               â† è¿è¡Œæ—¶é…ç½®  
inventory                 â† ç›®æ ‡ä¸»æœºç®¡ç†
group_vars/              â† åˆ†ç»„é…ç½®
```

**ğŸ”¹ è¿æ¥æ–¹å¼é€‰æ‹©**
```
SSHè¿æ¥ï¼šä¼ ç»Ÿæ–¹å¼ï¼Œé€‚ç”¨äºè™šæ‹Ÿæœºå’Œç‰©ç†æœº
Dockerè¿æ¥ï¼šç›´æ¥æ“ä½œå®¹å™¨å†…éƒ¨ï¼Œæ— éœ€SSH
Podmanè¿æ¥ï¼šrootlesså®¹å™¨ï¼Œå®‰å…¨æ€§æ›´é«˜
Kubernetesè¿æ¥ï¼šäº‘åŸç”Ÿåº”ç”¨ç®¡ç†
```

**ğŸ”¹ æœ€ä½³å®è·µåŸåˆ™**
```
å®‰å…¨æ€§ï¼šç”¨æˆ·æƒé™ã€èµ„æºé™åˆ¶ã€å®‰å…¨ä¸Šä¸‹æ–‡
æ€§èƒ½ï¼šå¹¶å‘è®¾ç½®ã€ç¼“å­˜æœºåˆ¶ã€ç½‘ç»œä¼˜åŒ–
å¯ç»´æŠ¤æ€§ï¼šé…ç½®åˆ†å±‚ã€æ¨¡å—åŒ–ã€æ–‡æ¡£å®Œå–„
å…¼å®¹æ€§ï¼šå¤šå¼•æ“æ”¯æŒã€ç‰ˆæœ¬ç®¡ç†ã€å¹³å°é€‚é…
```

### 9.3 å®é™…åº”ç”¨ä»·å€¼


- **å¼€å‘ç¯å¢ƒ**ï¼šå¿«é€Ÿæ­å»ºä¸€è‡´çš„å¼€å‘ç¯å¢ƒ
- **CI/CDé›†æˆ**ï¼šåœ¨æµæ°´çº¿ä¸­ä½¿ç”¨å®¹å™¨åŒ–Ansible
- **äº‘åŸç”Ÿéƒ¨ç½²**ï¼šKubernetesåº”ç”¨çš„è‡ªåŠ¨åŒ–ç®¡ç†
- **æ··åˆäº‘ç®¡ç†**ï¼šç»Ÿä¸€ç®¡ç†ä¼ ç»Ÿå’Œå®¹å™¨åŒ–åº”ç”¨
- **å®‰å…¨åˆè§„**ï¼šé€šè¿‡å®¹å™¨éš”ç¦»é™ä½å®‰å…¨é£é™©

**æ ¸å¿ƒè®°å¿†**ï¼š
- å®¹å™¨åŒ–Ansibleè§£å†³ç¯å¢ƒä¸€è‡´æ€§é—®é¢˜
- execution-environment.ymlæ˜¯å®¹å™¨æ„å»ºçš„æ ¸å¿ƒ
- ä¸åŒè¿æ¥æ’ä»¶é€‚ç”¨äºä¸åŒçš„å®¹å™¨åœºæ™¯
- åŠ¨æ€æ¸…å•èƒ½è‡ªåŠ¨å‘ç°å’Œç®¡ç†å®¹å™¨èµ„æº
- å®‰å…¨å’Œæ€§èƒ½é…ç½®æ˜¯ç”Ÿäº§ç¯å¢ƒçš„å…³é”®