---
title: 4ã€è§’è‰²rolesé…ç½®æ–‡ä»¶
---
## ğŸ“š ç›®å½•

1. [è§’è‰²rolesçš„æ ¸å¿ƒæ¦‚å¿µ](#1-è§’è‰²rolesçš„æ ¸å¿ƒæ¦‚å¿µ)
2. [rolesç›®å½•ç»“æ„è¯¦è§£](#2-rolesç›®å½•ç»“æ„è¯¦è§£)
3. [æ ¸å¿ƒé…ç½®æ–‡ä»¶æ·±å…¥è§£æ](#3-æ ¸å¿ƒé…ç½®æ–‡ä»¶æ·±å…¥è§£æ)
4. [è§’è‰²ä¾èµ–ä¸å…ƒæ•°æ®é…ç½®](#4-è§’è‰²ä¾èµ–ä¸å…ƒæ•°æ®é…ç½®)
5. [æ’ä»¶æ‰©å±•é…ç½®](#5-æ’ä»¶æ‰©å±•é…ç½®)
6. [æœ€ä½³å®è·µä¸å¸¸è§é—®é¢˜](#6-æœ€ä½³å®è·µä¸å¸¸è§é—®é¢˜)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ è§’è‰²rolesçš„æ ¸å¿ƒæ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Ansibleè§’è‰²

**ğŸ”¸ é€šä¿—ç†è§£**
æƒ³è±¡ä½ åœ¨å¨æˆ¿åšèœï¼Œè§’è‰²(roles)å°±åƒæ˜¯ä¸€å¥—å®Œæ•´çš„èœè°±ï¼Œé‡Œé¢åŒ…å«äº†ï¼š
- é£Ÿææ¸…å•ï¼ˆå˜é‡ï¼‰
- åˆ¶ä½œæ­¥éª¤ï¼ˆä»»åŠ¡ï¼‰
- å·¥å…·å‡†å¤‡ï¼ˆæ–‡ä»¶å’Œæ¨¡æ¿ï¼‰
- æ³¨æ„äº‹é¡¹ï¼ˆå¤„ç†ç¨‹åºï¼‰

```
ä¼ ç»Ÿæ–¹å¼ï¼šä¸€ä¸ªå¤§çš„playbookæ–‡ä»¶ï¼Œæ‰€æœ‰å†…å®¹æ··åœ¨ä¸€èµ·
è§’è‰²æ–¹å¼ï¼šæŠŠç›¸å…³åŠŸèƒ½åˆ†é—¨åˆ«ç±»ï¼Œç»„ç»‡æˆç‹¬ç«‹çš„è§’è‰²åŒ…
```

**ğŸ’¡ è§’è‰²çš„æ ¸å¿ƒä»·å€¼**
- **ä»£ç å¤ç”¨**ï¼šå†™ä¸€æ¬¡ï¼Œåˆ°å¤„ä½¿ç”¨
- **æ¨¡å—åŒ–ç®¡ç†**ï¼šåŠŸèƒ½ç‹¬ç«‹ï¼Œä¾¿äºç»´æŠ¤
- **å›¢é˜Ÿåä½œ**ï¼šä¸åŒäººè´Ÿè´£ä¸åŒè§’è‰²
- **æ ‡å‡†åŒ–éƒ¨ç½²**ï¼šç»Ÿä¸€çš„ç›®å½•ç»“æ„å’Œè§„èŒƒ

### 1.2 è§’è‰²åœ¨Ansibleä¸­çš„åœ°ä½

```
Ansibleæ¶æ„å±‚æ¬¡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Playbook     â”‚ â† è°ƒç”¨è§’è‰²çš„å‰§æœ¬
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     Roles       â”‚ â† åŠŸèƒ½æ¨¡å—åŒ–çš„è§’è‰²
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     Tasks       â”‚ â† å…·ä½“çš„æ‰§è¡Œä»»åŠ¡
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    Modules      â”‚ â† åº•å±‚çš„åŠŸèƒ½æ¨¡å—
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸ“ rolesç›®å½•ç»“æ„è¯¦è§£


### 2.1 æ ‡å‡†è§’è‰²ç›®å½•ç»“æ„

```
my-role/                    # è§’è‰²æ ¹ç›®å½•
â”œâ”€â”€ meta/                   # è§’è‰²å…ƒæ•°æ®ï¼ˆä¾èµ–ã€ä¿¡æ¯ï¼‰
â”‚   â””â”€â”€ main.yml           # è§’è‰²çš„"èº«ä»½è¯"
â”œâ”€â”€ tasks/                  # ä¸»è¦ä»»åŠ¡ç›®å½•
â”‚   â””â”€â”€ main.yml           # æ ¸å¿ƒä»»åŠ¡æ–‡ä»¶
â”œâ”€â”€ handlers/               # äº‹ä»¶å¤„ç†ç›®å½•
â”‚   â””â”€â”€ main.yml           # å¤„ç†ç¨‹åºå®šä¹‰
â”œâ”€â”€ templates/              # æ¨¡æ¿æ–‡ä»¶ç›®å½•
â”‚   â””â”€â”€ config.j2          # Jinja2æ¨¡æ¿æ–‡ä»¶
â”œâ”€â”€ files/                  # é™æ€æ–‡ä»¶ç›®å½•
â”‚   â””â”€â”€ script.sh          # éœ€è¦å¤åˆ¶çš„æ–‡ä»¶
â”œâ”€â”€ vars/                   # è§’è‰²å˜é‡ç›®å½•
â”‚   â””â”€â”€ main.yml           # è§’è‰²ä¸“ç”¨å˜é‡
â”œâ”€â”€ defaults/               # é»˜è®¤å˜é‡ç›®å½•
â”‚   â””â”€â”€ main.yml           # å¯è¦†ç›–çš„é»˜è®¤å€¼
â”œâ”€â”€ library/                # è‡ªå®šä¹‰æ¨¡å—ç›®å½•
â”œâ”€â”€ module_utils/           # æ¨¡å—å·¥å…·ç›®å½•
â”œâ”€â”€ lookup_plugins/         # æŸ¥æ‰¾æ’ä»¶ç›®å½•
â”œâ”€â”€ filter_plugins/         # è¿‡æ»¤å™¨æ’ä»¶ç›®å½•
â””â”€â”€ test_plugins/           # æµ‹è¯•æ’ä»¶ç›®å½•
```

### 2.2 ç›®å½•åŠŸèƒ½å¯¹æ¯”è¡¨


| ç›®å½• | **å¿…éœ€** | **åŠŸèƒ½è¯´æ˜** | **ä½¿ç”¨åœºæ™¯** |
|------|----------|-------------|-------------|
| `meta/` | âœ… | è§’è‰²ä¿¡æ¯å’Œä¾èµ– | å®šä¹‰è§’è‰²å…³ç³» |
| `tasks/` | âœ… | ä¸»è¦æ‰§è¡Œä»»åŠ¡ | æ ¸å¿ƒåŠŸèƒ½å®ç° |
| `handlers/` | ğŸŸ¡ | äº‹ä»¶è§¦å‘å¤„ç† | æœåŠ¡é‡å¯ç­‰ |
| `templates/` | ğŸŸ¡ | åŠ¨æ€é…ç½®æ–‡ä»¶ | é…ç½®æ–‡ä»¶ç”Ÿæˆ |
| `files/` | ğŸŸ¡ | é™æ€æ–‡ä»¶å­˜æ”¾ | è„šæœ¬ã€è¯ä¹¦ç­‰ |
| `vars/` | ğŸŸ¡ | è§’è‰²å›ºå®šå˜é‡ | ä¸å¯å˜é…ç½® |
| `defaults/` | ğŸŸ¡ | è§’è‰²é»˜è®¤å˜é‡ | å¯è¦†ç›–é…ç½® |

**ğŸ” ç›®å½•é€‰æ‹©æŒ‡å—**
- **å¿…é¡»æœ‰**ï¼š`meta/` å’Œ `tasks/` - è§’è‰²çš„æ ¸å¿ƒ
- **å»ºè®®æœ‰**ï¼š`defaults/` - æä¾›çµæ´»æ€§
- **æŒ‰éœ€æ·»åŠ **ï¼šå…¶ä»–ç›®å½•æ ¹æ®åŠŸèƒ½éœ€è¦

---

## 3. ğŸ”§ æ ¸å¿ƒé…ç½®æ–‡ä»¶æ·±å…¥è§£æ


### 3.1 tasks/main.yml - ä»»åŠ¡ä¸»æ–‡ä»¶


**ğŸ”¸ æ–‡ä»¶ä½œç”¨**
è¿™æ˜¯è§’è‰²çš„"å¤§è„‘"ï¼Œå®šä¹‰äº†è§’è‰²è¦æ‰§è¡Œçš„æ‰€æœ‰ä»»åŠ¡æ­¥éª¤ã€‚

```yaml
# tasks/main.yml - ç¤ºä¾‹ï¼šWebæœåŠ¡å™¨è§’è‰²
---
# ğŸ’¡ å®‰è£…è½¯ä»¶åŒ…
- name: å®‰è£…Apache HTTPæœåŠ¡å™¨
  package:
    name: httpd
    state: present

# ğŸ’¡ é…ç½®æ–‡ä»¶å¤„ç†
- name: ç”ŸæˆApacheé…ç½®æ–‡ä»¶
  template:
    src: httpd.conf.j2
    dest: /etc/httpd/conf/httpd.conf
  notify: restart httpd    # è§¦å‘å¤„ç†ç¨‹åº

# ğŸ’¡ å¯åŠ¨æœåŠ¡
- name: ç¡®ä¿ApacheæœåŠ¡è¿è¡Œ
  service:
    name: httpd
    state: started
    enabled: yes
```

**ğŸ“‹ ä»»åŠ¡æ–‡ä»¶ç»„ç»‡æŠ€å·§**
```yaml
# æ–¹å¼1ï¼šå•æ–‡ä»¶åŒ…å«æ‰€æœ‰ä»»åŠ¡ï¼ˆé€‚åˆç®€å•è§’è‰²ï¼‰
- name: æ‰§è¡Œä»»åŠ¡A
- name: æ‰§è¡Œä»»åŠ¡B

# æ–¹å¼2ï¼šæ‹†åˆ†ä¸ºå¤šä¸ªæ–‡ä»¶ï¼ˆé€‚åˆå¤æ‚è§’è‰²ï¼‰
- import_tasks: install.yml    # å®‰è£…ç›¸å…³ä»»åŠ¡
- import_tasks: config.yml     # é…ç½®ç›¸å…³ä»»åŠ¡
- import_tasks: service.yml    # æœåŠ¡ç›¸å…³ä»»åŠ¡
```

### 3.2 handlers/main.yml - äº‹ä»¶å¤„ç†æ–‡ä»¶


**ğŸ”¸ å¤„ç†ç¨‹åºæ¦‚å¿µ**
å¤„ç†ç¨‹åºå°±åƒ"æ¶ˆé˜²é˜Ÿ"ï¼Œå¹³æ—¶ä¸å·¥ä½œï¼Œåªæœ‰æ¥åˆ°"notify"é€šçŸ¥æ—¶æ‰æ‰§è¡Œã€‚

```yaml
# handlers/main.yml
---
- name: restart httpd
  service:
    name: httpd
    state: restarted

- name: reload nginx
  service:
    name: nginx
    state: reloaded

- name: restart database
  service:
    name: mysql
    state: restarted
```

**âš¡ å¤„ç†ç¨‹åºè§¦å‘æµç¨‹**
```
ä»»åŠ¡æ‰§è¡Œ â†’ å‘ç”Ÿæ”¹å˜ â†’ å‘é€notify â†’ è§¦å‘handler â†’ æ‰§è¡Œå¤„ç†ç¨‹åº
    â†“
é…ç½®æ–‡ä»¶ä¿®æ”¹ â†’ notify: restart httpd â†’ é‡å¯ApacheæœåŠ¡
```

### 3.3 templates/ - åŠ¨æ€æ¨¡æ¿ç›®å½•


**ğŸ”¸ æ¨¡æ¿æ–‡ä»¶æ¦‚å¿µ**
æ¨¡æ¿å°±åƒ"å¡«ç©ºé¢˜"ï¼Œä½¿ç”¨Jinja2è¯­æ³•ï¼Œå¯ä»¥æ ¹æ®å˜é‡åŠ¨æ€ç”Ÿæˆé…ç½®æ–‡ä»¶ã€‚

```jinja2
# templates/httpd.conf.j2
ServerName {{ ansible_hostname }}
Listen {{ http_port | default(80) }}

{% for vhost in virtual_hosts %}
<VirtualHost *:{{ http_port }}>
    ServerName {{ vhost.name }}
    DocumentRoot {{ vhost.docroot }}
</VirtualHost>
{% endfor %}
```

**ğŸ”„ æ¨¡æ¿ä½¿ç”¨ç¤ºä¾‹**
```yaml
# åœ¨tasksä¸­ä½¿ç”¨æ¨¡æ¿
- name: ç”Ÿæˆé…ç½®æ–‡ä»¶
  template:
    src: httpd.conf.j2          # æ¨¡æ¿æºæ–‡ä»¶
    dest: /etc/httpd/conf/httpd.conf  # ç›®æ ‡ä½ç½®
    owner: root
    group: root
    mode: '0644'
```

### 3.4 files/ - é™æ€æ–‡ä»¶ç›®å½•


**ğŸ”¸ é™æ€æ–‡ä»¶ç”¨é€”**
å­˜æ”¾ä¸éœ€è¦åŠ¨æ€ç”Ÿæˆçš„æ–‡ä»¶ï¼Œæ¯”å¦‚è„šæœ¬ã€è¯ä¹¦ã€é™æ€é…ç½®ç­‰ã€‚

```
files/
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ backup.sh           # å¤‡ä»½è„šæœ¬
â”‚   â””â”€â”€ cleanup.sh          # æ¸…ç†è„šæœ¬
â”œâ”€â”€ ssl/
â”‚   â”œâ”€â”€ server.crt          # SSLè¯ä¹¦
â”‚   â””â”€â”€ server.key          # ç§é’¥æ–‡ä»¶
â””â”€â”€ configs/
    â””â”€â”€ static-config.conf  # é™æ€é…ç½®æ–‡ä»¶
```

```yaml
# ä½¿ç”¨é™æ€æ–‡ä»¶
- name: å¤åˆ¶å¤‡ä»½è„šæœ¬
  copy:
    src: scripts/backup.sh    # files/ç›®å½•ä¸‹çš„ç›¸å¯¹è·¯å¾„
    dest: /usr/local/bin/backup.sh
    mode: '0755'
```

---

## 4. ğŸ—ï¸ è§’è‰²ä¾èµ–ä¸å…ƒæ•°æ®é…ç½®


### 4.1 meta/main.yml - è§’è‰²å…ƒæ•°æ®


**ğŸ”¸ å…ƒæ•°æ®æ–‡ä»¶ä½œç”¨**
å°±åƒè§’è‰²çš„"èº«ä»½è¯"ï¼Œè®°å½•äº†è§’è‰²çš„åŸºæœ¬ä¿¡æ¯ã€ä¾èµ–å…³ç³»ç­‰é‡è¦ä¿¡æ¯ã€‚

```yaml
# meta/main.yml - å®Œæ•´ç¤ºä¾‹
---
galaxy_info:
  # ğŸ“‹ åŸºæœ¬ä¿¡æ¯
  author: your_name
  description: WebæœåŠ¡å™¨éƒ¨ç½²è§’è‰²
  company: your_company
  license: MIT
  min_ansible_version: 2.9
  
  # ğŸ¯ å¹³å°æ”¯æŒ
  platforms:
    - name: EL           # RedHatç³»åˆ—
      versions:
        - 7
        - 8
    - name: Ubuntu
      versions:
        - 18.04
        - 20.04
  
  # ğŸ·ï¸ åˆ†ç±»æ ‡ç­¾
  galaxy_tags:
    - web
    - apache
    - httpd

# ğŸ”— è§’è‰²ä¾èµ–
dependencies:
  - role: common-setup
    vars:
      setup_firewall: true
  - role: ssl-certificates
    when: enable_ssl | default(false)
```

### 4.2 ä¾èµ–å…³ç³»è¯¦è§£


**ğŸ”¸ dependencieså­—æ®µè¯´æ˜**
```yaml
dependencies:
  # ç®€å•ä¾èµ–ï¼šåªæŒ‡å®šè§’è‰²å
  - common-tools
  
  # å¸¦å˜é‡çš„ä¾èµ–
  - role: database-setup
    vars:
      db_name: myapp
      db_user: appuser
  
  # æ¡ä»¶ä¾èµ–
  - role: ssl-config
    when: use_ssl == true
  
  # æ¥è‡ªGalaxyçš„ä¾èµ–
  - src: geerlingguy.apache
    version: 3.2.0
```

**ğŸ“Š ä¾èµ–æ‰§è¡Œé¡ºåº**
```
æ‰§è¡Œé¡ºåºï¼šdependencies â†’ å½“å‰è§’è‰²çš„tasks
        â†“
ä¾èµ–è§’è‰²A â†’ ä¾èµ–è§’è‰²B â†’ å½“å‰è§’è‰²ä¸»ä»»åŠ¡
```

### 4.3 galaxy_infoé…ç½®è¯¦è§£


**ğŸ¯ å¹³å°å…¼å®¹æ€§é…ç½®**
```yaml
platforms:
  - name: EL                    # Enterprise Linux (CentOS/RHEL)
    versions:
      - 7                       # CentOS 7
      - 8                       # CentOS 8
  - name: Ubuntu
    versions:
      - bionic                  # 18.04 LTS
      - focal                   # 20.04 LTS
  - name: Debian
    versions:
      - buster                  # Debian 10
      - bullseye                # Debian 11
```

---

## 5. ğŸ”Œ æ’ä»¶æ‰©å±•é…ç½®


### 5.1 å˜é‡é…ç½®å¯¹æ¯”


**ğŸ“Š vars/ vs defaults/ åŒºåˆ«å¯¹æ¯”è¡¨**

| ç‰¹æ€§ | **vars/main.yml** | **defaults/main.yml** |
|------|------------------|----------------------|
| **ä¼˜å…ˆçº§** | é«˜ï¼ˆä¸æ˜“è¦†ç›–ï¼‰ | ä½ï¼ˆå®¹æ˜“è¦†ç›–ï¼‰ |
| **ç”¨é€”** | è§’è‰²å†…éƒ¨å›ºå®šå€¼ | ç”¨æˆ·å¯è‡ªå®šä¹‰é»˜è®¤å€¼ |
| **è¦†ç›–éš¾åº¦** | å›°éš¾ | å®¹æ˜“ |
| **é€‚ç”¨åœºæ™¯** | è§’è‰²é€»è¾‘å¸¸é‡ | ç”¨æˆ·é…ç½®é€‰é¡¹ |

```yaml
# defaults/main.yml - ç”¨æˆ·å¯è¦†ç›–çš„é»˜è®¤å€¼
---
http_port: 80
max_connections: 100
enable_ssl: false
log_level: info

# vars/main.yml - è§’è‰²å†…éƒ¨å›ºå®šå€¼
---
service_name: httpd
config_path: /etc/httpd/conf/httpd.conf
log_path: /var/log/httpd
```

### 5.2 è‡ªå®šä¹‰æ’ä»¶ç›®å½•


**ğŸ”¸ library/ - è‡ªå®šä¹‰æ¨¡å—**
```python
# library/check_service.py - ç®€å•è‡ªå®šä¹‰æ¨¡å—ç¤ºä¾‹
#!/usr/bin/python
from ansible.module_utils.basic import AnsibleModule

def main():
    module = AnsibleModule(
        argument_spec=dict(
            service_name=dict(type='str', required=True)
        )
    )
    
    service_name = module.params['service_name']
    # æ£€æŸ¥æœåŠ¡çŠ¶æ€çš„é€»è¾‘
    result = {'changed': False, 'status': 'running'}
    module.exit_json(**result)

if __name__ == '__main__':
    main()
```

**ğŸ”¸ filter_plugins/ - è‡ªå®šä¹‰è¿‡æ»¤å™¨**
```python
# filter_plugins/custom_filters.py
def format_size(value):
    """å°†å­—èŠ‚è½¬æ¢ä¸ºå¯è¯»æ ¼å¼"""
    for unit in ['B', 'KB', 'MB', 'GB']:
        if value < 1024.0:
            return f"{value:.1f}{unit}"
        value /= 1024.0
    return f"{value:.1f}TB"

class FilterModule(object):
    def filters(self):
        return {
            'format_size': format_size
        }
```

```yaml
# ä½¿ç”¨è‡ªå®šä¹‰è¿‡æ»¤å™¨
- name: æ˜¾ç¤ºç£ç›˜å¤§å°
  debug:
    msg: "ç£ç›˜å¤§å°: {{ disk_size_bytes | format_size }}"
```

---

## 6. ğŸ’¡ æœ€ä½³å®è·µä¸å¸¸è§é—®é¢˜


### 6.1 è§’è‰²è®¾è®¡æœ€ä½³å®è·µ


**ğŸ¯ è§’è‰²å‘½åè§„èŒƒ**
```
å¥½çš„å‘½åï¼š
âœ… webserver          - æ¸…æ™°æ˜äº†
âœ… database-mysql     - åŠŸèƒ½+æŠ€æœ¯
âœ… monitoring-zabbix  - åˆ†ç±»æ˜ç¡®

ä¸å¥½çš„å‘½åï¼š
âŒ role1             - æ— æ„ä¹‰
âŒ my_awesome_role   - å¤ªä¸»è§‚
âŒ server_setup_v2   - ç‰ˆæœ¬å·ä¸åº”åœ¨åç§°ä¸­
```

**ğŸ“‹ ç›®å½•ç»“æ„å»ºè®®**
```yaml
# æ¨èçš„è§’è‰²ç»„ç»‡æ–¹å¼
roles/
â”œâ”€â”€ common/              # é€šç”¨åŸºç¡€è§’è‰²
â”œâ”€â”€ webserver/           # WebæœåŠ¡å™¨è§’è‰²
â”œâ”€â”€ database/            # æ•°æ®åº“è§’è‰²
â”œâ”€â”€ monitoring/          # ç›‘æ§è§’è‰²
â””â”€â”€ security/            # å®‰å…¨é…ç½®è§’è‰²
```

### 6.2 å¸¸è§é…ç½®é”™è¯¯ä¸è§£å†³


**âš ï¸ å¸¸è§é—®é¢˜1ï¼šä¾èµ–å¾ªç¯**
```yaml
# âŒ é”™è¯¯ç¤ºä¾‹ï¼šè§’è‰²Aä¾èµ–Bï¼ŒBåˆä¾èµ–A
# role-a/meta/main.yml
dependencies:
  - role-b

# role-b/meta/main.yml  
dependencies:
  - role-a              # å½¢æˆå¾ªç¯ä¾èµ–ï¼
```

**âœ… è§£å†³æ–¹æ¡ˆï¼šé‡æ–°è®¾è®¡è§’è‰²å…³ç³»**
```yaml
# åˆ›å»ºå…±åŒåŸºç¡€è§’è‰²
common-base/            # å…¬å…±åŸºç¡€åŠŸèƒ½
â”œâ”€â”€ role-a/            # ä¾èµ–common-base
â””â”€â”€ role-b/            # ä¾èµ–common-base
```

**âš ï¸ å¸¸è§é—®é¢˜2ï¼šå˜é‡ä¼˜å…ˆçº§æ··ä¹±**
```
å˜é‡ä¼˜å…ˆçº§ï¼ˆä»é«˜åˆ°ä½ï¼‰ï¼š
1. å‘½ä»¤è¡Œå˜é‡ (-e)
2. è¿æ¥å˜é‡
3. åŒ…å«å˜é‡
4. è§’è‰²vars/main.yml    â† é«˜ä¼˜å…ˆçº§
5. æ¸…å•å˜é‡
6. è§’è‰²defaults/main.yml â† ä½ä¼˜å…ˆçº§
```

### 6.3 è§’è‰²æµ‹è¯•ä¸éªŒè¯


**ğŸ§ª è§’è‰²æµ‹è¯•ç»“æ„**
```
my-role/
â”œâ”€â”€ molecule/           # æµ‹è¯•æ¡†æ¶ç›®å½•
â”‚   â””â”€â”€ default/
â”‚       â”œâ”€â”€ molecule.yml
â”‚       â”œâ”€â”€ playbook.yml
â”‚       â””â”€â”€ tests/
â””â”€â”€ tests/
    â”œâ”€â”€ inventory
    â””â”€â”€ test.yml
```

**ğŸ” ç®€å•æµ‹è¯•ç¤ºä¾‹**
```yaml
# tests/test.yml
---
- hosts: localhost
  remote_user: root
  roles:
    - my-role
  post_tasks:
    - name: éªŒè¯æœåŠ¡æ˜¯å¦è¿è¡Œ
      service:
        name: httpd
        state: started
      check_mode: yes
      register: service_status
      failed_when: service_status.changed
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ

```
ğŸ”¸ è§’è‰²æœ¬è´¨ï¼šæ¨¡å—åŒ–çš„AnsibleåŠŸèƒ½åŒ…ï¼Œæé«˜ä»£ç å¤ç”¨æ€§
ğŸ”¸ ç›®å½•ç»“æ„ï¼šæ ‡å‡†åŒ–çš„æ–‡ä»¶ç»„ç»‡ï¼Œæ¯ä¸ªç›®å½•æœ‰ç‰¹å®šç”¨é€”
ğŸ”¸ æ ¸å¿ƒæ–‡ä»¶ï¼šmeta/main.ymlï¼ˆå…ƒæ•°æ®ï¼‰+ tasks/main.ymlï¼ˆä»»åŠ¡ï¼‰
ğŸ”¸ å˜é‡å±‚æ¬¡ï¼šdefaultsï¼ˆå¯è¦†ç›–ï¼‰vs varsï¼ˆå›ºå®šå€¼ï¼‰
ğŸ”¸ ä¾èµ–å…³ç³»ï¼šé€šè¿‡meta/main.ymlç®¡ç†è§’è‰²é—´çš„ä¾èµ–
ğŸ”¸ æ¨¡æ¿ç³»ç»Ÿï¼šä½¿ç”¨Jinja2è¯­æ³•ç”ŸæˆåŠ¨æ€é…ç½®æ–‡ä»¶
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ è§’è‰²çš„æ¨¡å—åŒ–æ€ç»´**
```
ä¼ ç»Ÿæ–¹å¼ï¼šä¸€ä¸ªå¤§playbookåŒ…å«æ‰€æœ‰åŠŸèƒ½
  â†“
è§’è‰²æ–¹å¼ï¼šæŒ‰åŠŸèƒ½æ‹†åˆ†ï¼Œç‹¬ç«‹ç»´æŠ¤ï¼Œç»„åˆä½¿ç”¨
  â†“
ä¼˜åŠ¿ï¼šå¤ç”¨æ€§å¼ºã€ç»´æŠ¤ç®€å•ã€å›¢é˜Ÿåä½œå‹å¥½
```

**ğŸ”¹ é…ç½®æ–‡ä»¶çš„å±‚æ¬¡å…³ç³»**
```
é…ç½®ä¼˜å…ˆçº§ç†è§£ï¼š
å‘½ä»¤è¡Œå‚æ•° > inventoryå˜é‡ > vars/main.yml > defaults/main.yml
         â†‘                                    â†‘
      æœ€é«˜ä¼˜å…ˆçº§                           æœ€ä½ä¼˜å…ˆçº§
```

**ğŸ”¹ ä¾èµ–ç®¡ç†çš„é‡è¦æ€§**
```
ä¾èµ–è®¾è®¡åŸåˆ™ï¼š
- å•ä¸€èŒè´£ï¼šæ¯ä¸ªè§’è‰²ä¸“æ³¨ä¸€ä¸ªåŠŸèƒ½
- æœ€å°ä¾èµ–ï¼šå‡å°‘ä¸å¿…è¦çš„ä¾èµ–å…³ç³»
- é¿å…å¾ªç¯ï¼šè®¾è®¡æ—¶è€ƒè™‘ä¾èµ–æ–¹å‘
```

### 7.3 å®é™…åº”ç”¨æŒ‡å—


**ğŸ¯ è§’è‰²ä½¿ç”¨åœºæ™¯**
- **åŸºç¡€è®¾æ–½**ï¼šæœåŠ¡å™¨åŸºç¡€é…ç½®ã€å®‰å…¨åŠ å›º
- **åº”ç”¨éƒ¨ç½²**ï¼šWebæœåŠ¡å™¨ã€æ•°æ®åº“ã€ç¼“å­˜æœåŠ¡
- **è¿ç»´è‡ªåŠ¨åŒ–**ï¼šç›‘æ§ã€å¤‡ä»½ã€æ—¥å¿—ç®¡ç†
- **ç¯å¢ƒç®¡ç†**ï¼šå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒæ ‡å‡†åŒ–

**ğŸš€ é¡¹ç›®ä¸­çš„è§’è‰²è§„åˆ’**
```
é¡¹ç›®è§’è‰²è§„åˆ’ç¤ºä¾‹ï¼š
â”Œâ”€ common-base          â† æ‰€æœ‰æœåŠ¡å™¨çš„åŸºç¡€é…ç½®
â”œâ”€ security-hardening   â† å®‰å…¨åŠ å›ºï¼ˆä¾èµ–common-baseï¼‰
â”œâ”€ webserver-nginx      â† Nginxéƒ¨ç½²ï¼ˆä¾èµ–common-baseï¼‰
â”œâ”€ database-mysql       â† MySQLéƒ¨ç½²ï¼ˆä¾èµ–common-baseï¼‰
â””â”€ monitoring-zabbix    â† ç›‘æ§éƒ¨ç½²ï¼ˆä¾èµ–common-baseï¼‰
```

**ğŸ”§ å¼€å‘æµç¨‹å»ºè®®**
1. **éœ€æ±‚åˆ†æ**ï¼šç¡®å®šè§’è‰²åŠŸèƒ½è¾¹ç•Œ
2. **è®¾è®¡ç»“æ„**ï¼šè§„åˆ’ç›®å½•å’Œæ–‡ä»¶ç»„ç»‡
3. **ç¼–å†™ä»£ç **ï¼šä»ç®€å•åˆ°å¤æ‚é€æ­¥å®Œå–„
4. **æµ‹è¯•éªŒè¯**ï¼šæœ¬åœ°æµ‹è¯•å’Œé›†æˆæµ‹è¯•
5. **æ–‡æ¡£ç»´æŠ¤**ï¼šREADMEå’Œå˜é‡è¯´æ˜

### 7.4 è®°å¿†è¦ç‚¹

```
ğŸ§  è§’è‰²é…ç½®æ–‡ä»¶è®°å¿†å£è¯€ï¼š
metaå®šä¾èµ–ï¼Œtasksæ˜¯æ ¸å¿ƒ
handlerså¤„äº‹ä»¶ï¼Œtemplatesåšæ¨¡æ¿
filesæ”¾é™æ€ï¼Œvarså­˜å˜é‡
defaultså¯æ”¹ï¼Œpluginsæ‰©å±•åŠŸèƒ½å¤š
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- Ansibleè§’è‰²æ˜¯åŠŸèƒ½æ¨¡å—åŒ–çš„æœ€ä½³å®è·µ
- æ ‡å‡†ç›®å½•ç»“æ„è®©è§’è‰²æ˜“äºç†è§£å’Œç»´æŠ¤
- åˆç†çš„ä¾èµ–è®¾è®¡æ˜¯å¤§å‹é¡¹ç›®æˆåŠŸçš„å…³é”®
- å˜é‡çš„ä¼˜å…ˆçº§ç†è§£å¯¹è§’è‰²å¼€å‘è‡³å…³é‡è¦