---
title: 13、集合collections配置
---
## 📚 目录

1. [什么是Ansible集合](#1-什么是ansible集合)
2. [集合目录结构详解](#2-集合目录结构详解)
3. [galaxy.yml元数据文件](#3-galaxyyml元数据文件)
4. [requirements.yml需求文件](#4-requirementsyml需求文件)
5. [集合路径配置](#5-集合路径配置)
6. [ansible-galaxy集合管理工具](#6-ansible-galaxy集合管理工具)
7. [版本管理与依赖关系](#7-版本管理与依赖关系)
8. [实际应用场景与最佳实践](#8-实际应用场景与最佳实践)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 📦 什么是Ansible集合


### 1.1 集合的基本概念


**集合（Collections）**是Ansible 2.9版本后引入的新概念，简单来说就是把相关的**模块、插件、角色**打包在一起的"功能包"。

```
传统方式：模块散落各处，难以管理
         ansible-playbook ← 直接调用各种模块
         
集合方式：相关功能统一打包
         ansible-playbook ← 使用集合 ← 集合包含(模块+插件+角色)
```

**🔸 集合解决了什么问题？**
- **统一管理**：相关功能不再分散，便于维护
- **版本控制**：每个集合有独立版本，升级更安全
- **社区贡献**：开发者可以独立发布和维护集合
- **命名空间**：避免模块名冲突，如 `community.general.ping`

### 1.2 集合与传统模块的区别


| 对比项目 | **传统模块** | **集合方式** |
|---------|------------|------------|
| **组织方式** | `分散在ansible核心` | `按功能分组打包` |
| **调用方式** | `ping` | `community.general.ping` |
| **版本管理** | `跟随Ansible版本` | `独立版本管理` |
| **更新频率** | `跟随Ansible发布` | `可独立快速更新` |
| **命名冲突** | `容易冲突` | `命名空间隔离` |

### 1.3 集合的命名规范


**命名格式**：`namespace.collection_name`

```
真实示例：
community.general     ← 社区通用集合
ansible.posix         ← Ansible官方POSIX集合  
amazon.aws           ← Amazon AWS集合
kubernetes.core      ← Kubernetes核心集合

调用示例：
- name: 使用community.general集合的systemd模块
  community.general.systemd:
    name: nginx
    state: started
```

---

## 2. 📁 集合目录结构详解


### 2.1 标准集合目录结构


```
my_collection/                    ← 集合根目录
├── galaxy.yml                   ← 集合元数据文件（必需）
├── README.md                    ← 说明文档
├── plugins/                     ← 插件目录
│   ├── modules/                 ← 模块存放处
│   ├── inventory/               ← 动态清单插件
│   ├── lookup/                  ← 查找插件
│   └── filter/                  ← 过滤插件
├── roles/                       ← 角色目录
│   ├── role1/                   ← 具体角色
│   └── role2/
├── playbooks/                   ← 示例playbook
└── tests/                       ← 测试文件
```

### 2.2 collections/目录说明


**系统默认位置**：
```bash
# 系统级集合目录
/usr/share/ansible/collections/

# 用户级集合目录  
~/.ansible/collections/

# 当前项目集合目录
./collections/
```

**目录查找优先级**：
```
1. 当前目录的collections/      ← 最高优先级
2. 环境变量COLLECTIONS_PATHS
3. ansible.cfg配置文件
4. ~/.ansible/collections/     ← 用户目录
5. /usr/share/ansible/collections/ ← 系统目录
```

### 2.3 实际项目中的集合组织


```
项目结构示例：
my_ansible_project/
├── ansible.cfg                  ← Ansible配置
├── inventory/                   ← 清单文件
├── playbooks/                   ← 主要playbook
├── collections/                 ← 项目专用集合
│   └── requirements.yml         ← 集合依赖声明
└── group_vars/                  ← 变量文件
```

---

## 3. 📋 galaxy.yml元数据文件


### 3.1 galaxy.yml的作用


**galaxy.yml**是集合的"身份证"，包含了集合的所有重要信息，类似于Python的`setup.py`或Node.js的`package.json`。

**🔸 为什么需要galaxy.yml？**
- 告诉Ansible这个目录是一个集合
- 定义集合的基本信息（名称、版本、作者等）
- 声明集合的依赖关系
- 设置集合的分发信息

### 3.2 galaxy.yml完整结构解析


```yaml
## 基本信息（必需）

namespace: mycompany              # 命名空间（必需）
name: mytools                     # 集合名称（必需）
version: 1.2.3                    # 版本号（必需）

## 描述信息

description: 我的公司内部工具集合
readme: README.md
authors:
  - "张三 <zhangsan@company.com>"
  - "李四 <lisi@company.com>"

## 许可证和标签

license: 
  - GPL-3.0-or-later
license_file: LICENSE
tags:
  - tools
  - company
  - automation

## 依赖关系（重要）

dependencies:
  "ansible.posix": ">=1.0.0"     # 依赖ansible.posix集合
  "community.general": ">=4.0.0" # 依赖community.general集合

## 仓库信息

repository: https://github.com/mycompany/ansible-mytools
documentation: https://docs.mycompany.com/ansible-mytools
homepage: https://www.mycompany.com
issues: https://github.com/mycompany/ansible-mytools/issues

## 构建忽略

build_ignore:
  - .gitignore
  - .DS_Store
  - tests/
```

### 3.3 关键字段详解


**namespace和name**：
```yaml
namespace: mycompany    # 相当于"品牌名"
name: mytools          # 相当于"产品名"

# 最终调用：mycompany.mytools.模块名
```

**version版本管理**：
```yaml
# 遵循语义化版本规范
version: 1.2.3
#        ^ ^ ^
#        | | 修订版本（bug修复）
#        | 次版本号（新功能）
#        主版本号（破坏性更改）
```

**dependencies依赖管理**：
```yaml
dependencies:
  "community.general": ">=4.0.0,<6.0.0"  # 版本范围
  "ansible.posix": "~=1.3.0"             # 兼容版本
  "kubernetes.core": "*"                  # 任意版本
```

---

## 4. 📝 requirements.yml需求文件


### 4.1 requirements.yml的用途


**requirements.yml**是项目级别的"购物清单"，告诉Ansible这个项目需要哪些集合，类似于Python的`requirements.txt`。

**🔸 什么时候使用？**
- 新人加入项目，快速安装所需集合
- 持续集成环境，自动安装依赖
- 多环境部署，保持集合版本一致

### 4.2 requirements.yml基本格式


```yaml
---
# 集合依赖列表
collections:
  # 方式1：简单指定名称（安装最新版本）
  - name: community.general
  
  # 方式2：指定版本要求
  - name: ansible.posix
    version: ">=1.3.0"
  
  # 方式3：从特定源安装
  - name: mycompany.internal
    source: https://galaxy.mycompany.com/
  
  # 方式4：从Git仓库安装
  - name: mycompany.devtools
    type: git
    source: https://github.com/mycompany/ansible-devtools.git
    version: main
  
  # 方式5：从本地路径安装
  - name: mycompany.custom
    type: dir
    source: ./local_collections/mycompany/custom/
```

### 4.3 版本要求语法详解


| **版本语法** | **含义** | **示例** |
|-------------|---------|----------|
| `*` | `任意版本` | `version: "*"` |
| `>=1.0.0` | `大于等于指定版本` | `version: ">=1.0.0"` |
| `<2.0.0` | `小于指定版本` | `version: "<2.0.0"` |
| `>=1.0.0,<2.0.0` | `版本范围` | `version: ">=1.0.0,<2.0.0"` |
| `~=1.3.0` | `兼容版本` | `相当于 >=1.3.0,<1.4.0` |
| `==1.2.3` | `精确版本` | `version: "==1.2.3"` |

### 4.4 实际项目requirements.yml示例


```yaml
---
# Web服务器部署项目的集合需求
collections:
  # 基础功能集合
  - name: ansible.posix
    version: ">=1.0.0"
  
  - name: community.general  
    version: ">=4.0.0"
  
  # 云平台集合
  - name: amazon.aws
    version: ">=3.0.0"
  
  # Web服务器相关
  - name: community.crypto
    version: ">=2.0.0"
    
  # 公司内部集合
  - name: mycompany.monitoring
    source: https://internal-galaxy.company.com/
    version: ">=1.5.0"
```

---

## 5. 🛠️ 集合路径配置


### 5.1 collections_paths配置详解


**collections_paths**告诉Ansible去哪里寻找集合，支持多个路径，按顺序查找。

**ansible.cfg配置示例**：
```ini
[defaults]
# 集合搜索路径（按优先级排序）
collections_paths = ./collections:~/.ansible/collections:/usr/share/ansible/collections

# 其他相关配置
collections_on_ansible_version_mismatch = warning
```

### 5.2 路径配置的三种方式


**方式1：配置文件**（推荐）
```ini
# ansible.cfg
[defaults]  
collections_paths = ./collections:../shared_collections:~/.ansible/collections
```

**方式2：环境变量**
```bash
# 临时设置
export COLLECTIONS_PATHS="./collections:~/.ansible/collections"

# 永久设置（添加到.bashrc）
echo 'export COLLECTIONS_PATHS="./collections:~/.ansible/collections"' >> ~/.bashrc
```

**方式3：命令行参数**
```bash
ansible-playbook -p ./collections:~/.ansible/collections playbook.yml
```

### 5.3 路径优先级与查找机制


```
Ansible查找集合的顺序：

1. 命令行指定的路径
   ↓
2. 环境变量COLLECTIONS_PATHS  
   ↓
3. ansible.cfg中的collections_paths
   ↓
4. 当前目录的./collections/
   ↓
5. 用户目录~/.ansible/collections/
   ↓
6. 系统目录/usr/share/ansible/collections/
```

**🔸 实际查找过程**：
```
查找community.general.ping模块时：

第一步：在./collections/ansible_collections/community/general/plugins/modules/
第二步：在~/.ansible/collections/ansible_collections/community/general/plugins/modules/
第三步：在/usr/share/ansible/collections/ansible_collections/community/general/plugins/modules/
```

### 5.4 collections_on_ansible_version_mismatch详解


当集合要求的Ansible版本与当前版本不匹配时的处理方式：

```ini
[defaults]
# 版本不匹配时的处理方式
collections_on_ansible_version_mismatch = warning

# 可选值：
# ignore  - 忽略版本不匹配（可能有风险）
# warning - 显示警告但继续执行（默认推荐）  
# error   - 抛出错误并停止执行（严格模式）
```

**实际效果演示**：
```bash
# warning模式输出
[WARNING]: Collection community.general does not support Ansible version 2.9.0

# error模式输出  
[ERROR]: Collection community.general requires ansible>=4.0.0
```

---

## 6. ⚙️ ansible-galaxy集合管理工具


### 6.1 ansible-galaxy工具概述


**ansible-galaxy**是Ansible官方提供的集合管理工具，相当于Python的pip或Node.js的npm，专门用来**安装、管理、发布**Ansible集合。

**🔸 主要功能**：
- **安装集合**：从各种源安装集合
- **列出集合**：查看已安装的集合
- **创建集合**：生成集合模板
- **发布集合**：上传集合到Galaxy

### 6.2 install_collections - 集合安装命令详解


**基本安装语法**：
```bash
# 语法：ansible-galaxy collection install [选项] 集合名称

# 最简单的安装
ansible-galaxy collection install community.general

# 安装指定版本
ansible-galaxy collection install community.general:4.3.0

# 安装到指定目录
ansible-galaxy collection install -p ./collections community.general

# 批量安装（从requirements.yml）
ansible-galaxy collection install -r requirements.yml
```

**常用安装选项**：
```bash
# 强制重新安装（覆盖已存在的）
ansible-galaxy collection install --force community.general

# 忽略依赖关系
ansible-galaxy collection install --ignore-deps community.general

# 从特定源安装
ansible-galaxy collection install -s https://galaxy.mycompany.com/ mycompany.tools

# 升级到最新版本
ansible-galaxy collection install --upgrade community.general
```

### 6.3 collection_list - 集合列表管理


**查看已安装集合**：
```bash
# 列出所有已安装集合
ansible-galaxy collection list

# 查看特定集合信息
ansible-galaxy collection list community.general

# 查看指定路径的集合
ansible-galaxy collection list -p ./collections
```

**输出示例**：
```
Collection                Version
------------------------- -------
ansible.netcommon         2.4.0  
ansible.posix             1.3.0  
community.crypto          2.8.1  
community.general         4.3.0  
```

### 6.4 集合依赖管理


**自动安装依赖**：
```bash
# 安装集合时自动安装依赖（默认行为）
ansible-galaxy collection install kubernetes.core

# 这会自动安装kubernetes.core依赖的其他集合
# 如：ansible.posix, community.general等
```

**依赖冲突处理**：
```bash
# 当出现依赖冲突时
[WARNING]: Failed to resolve dependency community.general>=4.0.0

# 解决方案1：手动安装指定版本
ansible-galaxy collection install community.general:4.3.0

# 解决方案2：忽略依赖检查（不推荐）
ansible-galaxy collection install --ignore-deps problematic.collection
```

---

## 7. 🏷️ 版本管理与依赖关系


### 7.1 namespace命名空间管理


**命名空间的作用**：
- **避免冲突**：不同组织可以有同名集合
- **归属标识**：明确集合的来源和维护者
- **权限管理**：控制谁可以在命名空间下发布集合

**常见命名空间**：
```
官方命名空间：
ansible.*          # Ansible官方维护
community.*        # 社区维护

厂商命名空间：
amazon.*           # Amazon AWS相关
microsoft.*        # Microsoft Azure相关  
google.*           # Google Cloud相关

公司命名空间：
mycompany.*        # 公司内部集合
```

### 7.2 collection_name集合命名规范


**好的集合命名**：
```yaml
# 功能明确
community.general      # 通用工具集合
community.crypto       # 加密相关集合
kubernetes.core        # Kubernetes核心功能

# 避免的命名
mycompany.stuff        # 太泛泛，不知道包含什么
tools.utils            # 命名空间不规范
awesome_collection     # 使用下划线不规范
```

### 7.3 version版本要求策略


**语义化版本控制**：
```
版本号格式：主版本.次版本.修订版本
            MAJOR.MINOR.PATCH
            
主版本：不兼容的API更改
次版本：向后兼容的功能新增
修订版本：向后兼容的问题修正
```

**实际版本管理策略**：
```yaml
# 保守策略（推荐生产环境）
dependencies:
  "community.general": ">=4.3.0,<4.4.0"  # 锁定次版本

# 积极策略（适合开发环境）
dependencies:
  "community.general": ">=4.0.0,<5.0.0"  # 允许次版本更新

# 固定策略（关键系统）
dependencies:
  "community.general": "==4.3.1"          # 完全固定版本
```

### 7.4 source集合源管理


**集合安装源类型**：

| **源类型** | **source值** | **适用场景** |
|-----------|-------------|-------------|
| **Galaxy Hub** | `默认或galaxy.ansible.com` | `公开集合` |
| **私有Galaxy** | `https://galaxy.company.com/` | `企业内部` |
| **Git仓库** | `git+https://github.com/...` | `开发版本` |
| **本地目录** | `file:///path/to/collection` | `本地开发` |
| **HTTP/HTTPS** | `https://example.com/collection.tar.gz` | `特殊分发` |

**实际配置示例**：
```yaml
collections:
  # 公开Galaxy源（默认）
  - name: community.general
  
  # 企业私有Galaxy
  - name: mycompany.internal
    source: https://ansible-galaxy.mycompany.com/
    
  # Git仓库源  
  - name: experimental.tools
    type: git
    source: https://github.com/myorg/experimental-tools.git
    version: develop
```

### 7.5 type集合类型说明


**集合类型定义**：
- **galaxy**：从Galaxy服务器安装（默认）
- **git**：从Git仓库安装
- **dir**：从本地目录安装
- **file**：从本地文件安装

```yaml
# 不同类型示例
collections:
  # Galaxy类型（默认，可省略type）
  - name: community.general
    type: galaxy
    
  # Git类型
  - name: myorg.devtools  
    type: git
    source: https://github.com/myorg/devtools.git
    version: main
    
  # 目录类型
  - name: local.custom
    type: dir
    source: ./my_collections/local/custom/
    
  # 文件类型
  - name: packaged.tools
    type: file  
    source: /tmp/packaged-tools-1.0.0.tar.gz
```

### 7.6 dependencies依赖关系最佳实践


**依赖声明原则**：
```yaml
# 原则1：明确最低版本要求
dependencies:
  "ansible.posix": ">=1.3.0"  # 明确需要的最低版本

# 原则2：避免过于严格的上限
  "community.general": ">=4.0.0,<6.0.0"  # 给予一定的升级空间

# 原则3：核心依赖要保守
  "ansible.builtin": ">=2.10.0,<3.0.0"   # 核心功能要稳定
```

**依赖管理工具**：
```bash
# 检查依赖冲突
ansible-galaxy collection list --format json | jq '.collections'

# 自动解析并安装依赖
ansible-galaxy collection install -r requirements.yml --force-with-deps

# 生成依赖锁定文件
ansible-galaxy collection list --format json > collections-lock.json
```

---

## 8. 🚀 实际应用场景与最佳实践


### 8.1 企业内部集合管理


**场景**：公司有多个项目需要使用相同的自定义模块和角色

**解决方案**：
```
项目结构：
company-ansible-collections/
├── galaxy.yml
├── plugins/modules/
│   ├── company_user.py       # 公司用户管理模块
│   └── company_deploy.py     # 公司部署模块
├── roles/
│   ├── base_setup/           # 基础环境角色
│   └── monitoring/           # 监控角色
└── requirements.yml
```

**galaxy.yml配置**：
```yaml
namespace: mycompany
name: common
version: 1.0.0
description: 公司通用Ansible集合

dependencies:
  "ansible.posix": ">=1.0.0"
  "community.general": ">=4.0.0"
```

**使用方式**：
```yaml
# 在项目的requirements.yml中
collections:
  - name: mycompany.common
    source: https://ansible-galaxy.company.com/
    version: ">=1.0.0"
```

### 8.2 多环境集合版本管理


**挑战**：开发、测试、生产环境需要不同版本的集合

**解决方案**：
```
# 开发环境 requirements-dev.yml
collections:
  - name: community.general
    version: ">=4.0.0"          # 使用较新版本

# 生产环境 requirements-prod.yml  
collections:
  - name: community.general
    version: "==4.3.1"          # 固定版本，确保稳定
```

**部署脚本**：
```bash
#!/bin/bash
# deploy.sh
ENVIRONMENT=${1:-dev}

case $ENVIRONMENT in
  "prod")
    ansible-galaxy collection install -r requirements-prod.yml --force
    ;;
  "dev"|*)
    ansible-galaxy collection install -r requirements-dev.yml --force
    ;;
esac
```

### 8.3 离线环境集合部署


**场景**：生产环境无法连接互联网，需要离线安装集合

**解决方案步骤**：

**步骤1：在线环境准备集合包**
```bash
# 下载集合及依赖
ansible-galaxy collection download -r requirements.yml -p ./offline_collections/

# 打包所有集合
tar -czf ansible-collections-offline.tar.gz offline_collections/
```

**步骤2：离线环境安装**
```bash
# 解压集合包
tar -xzf ansible-collections-offline.tar.gz

# 批量安装本地集合
for collection in offline_collections/*.tar.gz; do
  ansible-galaxy collection install "$collection" -p ./collections/
done
```

### 8.4 CI/CD集成最佳实践


**GitLab CI示例**：
```yaml
# .gitlab-ci.yml
stages:
  - prepare
  - deploy

install_collections:
  stage: prepare
  script:
    - ansible-galaxy collection install -r requirements.yml
  cache:
    paths:
      - ~/.ansible/collections/
  artifacts:
    paths:
      - ~/.ansible/collections/
    expire_in: 1 hour

deploy:
  stage: deploy
  dependencies:
    - install_collections
  script:
    - ansible-playbook -i inventory deploy.yml
```

### 8.5 集合开发与测试


**集合开发目录结构**：
```
my_new_collection/
├── galaxy.yml
├── plugins/modules/
│   └── my_module.py
├── roles/
├── tests/
│   └── integration/
├── .github/workflows/
└── README.md
```

**测试集合的方法**：
```bash
# 构建集合
ansible-galaxy collection build

# 安装本地构建的集合进行测试
ansible-galaxy collection install ./my_company-my_collection-1.0.0.tar.gz --force

# 运行测试
ansible-test integration --python 3.8
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的核心概念


```
🔸 集合本质：相关模块、插件、角色的统一包装
🔸 命名规范：namespace.collection_name格式
🔸 配置文件：galaxy.yml定义集合，requirements.yml声明依赖
🔸 路径管理：collections_paths控制集合查找位置
🔸 版本控制：遵循语义化版本规范，合理设置依赖版本要求
🔸 管理工具：ansible-galaxy是集合管理的核心工具
```

### 9.2 关键理解要点


**🔹 为什么要使用集合**
```
传统问题：
- 模块分散难管理
- 版本依赖混乱  
- 命名容易冲突
- 更新不够灵活

集合优势：
- 功能统一打包管理
- 独立版本控制
- 命名空间避免冲突
- 可独立快速更新
```

**🔹 集合路径的查找逻辑**
```
理解要点：
- 按优先级顺序查找：当前目录 > 配置路径 > 用户目录 > 系统目录
- 找到即停止，不会继续查找其他位置
- 可通过collections_paths自定义查找路径
```

**🔹 版本管理最佳实践**
```
开发环境：版本要求宽松，便于使用新特性
测试环境：版本适度锁定，保证测试有效性
生产环境：版本严格固定，确保系统稳定
```

### 9.3 实际应用指导


**选择集合安装位置**：
```
项目级：./collections/           # 项目独有集合
用户级：~/.ansible/collections/  # 个人常用集合  
系统级：/usr/share/ansible/      # 系统共享集合
```

**requirements.yml编写原则**：
```
✅ 明确版本要求，避免使用"*"
✅ 重要集合锁定版本，避免意外升级
✅ 添加注释说明集合用途
✅ 定期审查和更新依赖版本
```

**企业使用建议**：
```
建议搭建私有Galaxy服务器：
- 统一管理企业内部集合
- 控制集合版本发布
- 提供离线安装支持
- 增强安全性和可控性
```

### 9.4 常见问题与解决方案


| **问题** | **原因** | **解决方案** |
|---------|---------|------------|
| `集合找不到` | `路径配置错误` | `检查collections_paths配置` |
| `版本冲突` | `依赖版本要求不兼容` | `调整version范围或手动安装` |
| `安装失败` | `网络问题或源不可达` | `更换source或使用离线安装` |
| `模块调用失败` | `集合未正确引用` | `使用完整FQCN格式调用` |

### 9.5 学习路径建议


**初学者路径**：
```
1. 理解集合基本概念和命名规范
2. 学会使用ansible-galaxy安装常用集合
3. 掌握requirements.yml编写和使用
4. 了解集合路径配置和查找机制
```

**进阶路径**：
```
1. 学习集合开发和构建
2. 掌握企业级集合管理策略
3. 实践CI/CD集成和离线部署
4. 探索私有Galaxy服务器搭建
```

**核心记忆口诀**：
- 集合打包功能强，命名空间防冲突
- galaxy文件是身份，requirements声明依赖
- ansible-galaxy管理工具，安装列表都靠它  
- 路径优先有顺序，版本管理要合理