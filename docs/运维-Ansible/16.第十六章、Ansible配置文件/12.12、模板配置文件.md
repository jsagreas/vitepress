---
title: 12ã€æ¨¡æ¿é…ç½®æ–‡ä»¶
---
## ğŸ“š ç›®å½•

1. [æ¨¡æ¿ç³»ç»ŸåŸºç¡€æ¦‚å¿µ](#1-æ¨¡æ¿ç³»ç»ŸåŸºç¡€æ¦‚å¿µ)
2. [æ¨¡æ¿ç›®å½•ç»“æ„ä¸æ–‡ä»¶å‘½å](#2-æ¨¡æ¿ç›®å½•ç»“æ„ä¸æ–‡ä»¶å‘½å)
3. [templateæ¨¡å—è¯¦è§£](#3-templateæ¨¡å—è¯¦è§£)
4. [Jinja2æ¨¡æ¿è¯­æ³•é…ç½®](#4-Jinja2æ¨¡æ¿è¯­æ³•é…ç½®)
5. [æ¨¡æ¿æ¸²æŸ“è¡Œä¸ºé…ç½®](#5-æ¨¡æ¿æ¸²æŸ“è¡Œä¸ºé…ç½®)
6. [é«˜çº§æ¨¡æ¿é…ç½®é€‰é¡¹](#6-é«˜çº§æ¨¡æ¿é…ç½®é€‰é¡¹)
7. [å®é™…åº”ç”¨åœºæ™¯ä¸æœ€ä½³å®è·µ](#7-å®é™…åº”ç”¨åœºæ™¯ä¸æœ€ä½³å®è·µ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ æ¨¡æ¿ç³»ç»ŸåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Ansibleæ¨¡æ¿ï¼Ÿ


**ç®€å•ç†è§£**ï¼šæ¨¡æ¿å°±åƒæ˜¯ä¸€ä¸ª"å¡«ç©ºé¢˜"ï¼Œä½ æå‰å‡†å¤‡å¥½ä¸€ä¸ªé…ç½®æ–‡ä»¶çš„æ¡†æ¶ï¼Œé‡Œé¢ç•™å‡ºä¸€äº›ç©ºç™½ä½ç½®ï¼Œç„¶åAnsibleä¼šè‡ªåŠ¨æŠŠå¯¹åº”çš„å€¼å¡«è¿›å»ã€‚

```
æ¯”å¦‚ä½ è¦é…ç½®nginxï¼š
æ¨¡æ¿æ–‡ä»¶ï¼šserver_name {{ domain_name }};
å˜é‡å€¼ï¼šdomain_name = "example.com"
æœ€ç»ˆç»“æœï¼šserver_name example.com;
```

**æ ¸å¿ƒä½œç”¨**ï¼š
- **åŠ¨æ€ç”Ÿæˆé…ç½®æ–‡ä»¶**ï¼šæ ¹æ®ä¸åŒç¯å¢ƒç”Ÿæˆä¸åŒçš„é…ç½®
- **å‡å°‘é‡å¤å·¥ä½œ**ï¼šä¸€ä¸ªæ¨¡æ¿å¯ä»¥ç”¨äºå¤šå°æœåŠ¡å™¨
- **ä¿æŒé…ç½®ä¸€è‡´æ€§**ï¼šç¡®ä¿æ‰€æœ‰æœåŠ¡å™¨ä½¿ç”¨ç»Ÿä¸€çš„é…ç½®æ ¼å¼

### 1.2 æ¨¡æ¿ç³»ç»Ÿçš„å·¥ä½œæµç¨‹


```
å¼€å‘é˜¶æ®µ                 éƒ¨ç½²é˜¶æ®µ                 ç›®æ ‡æœåŠ¡å™¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¼–å†™æ¨¡æ¿    â”‚   â†’    â”‚ Ansibleè¯»å–  â”‚   â†’    â”‚  ç”Ÿæˆæœ€ç»ˆ    â”‚
â”‚ (.j2æ–‡ä»¶)   â”‚         â”‚ æ¨¡æ¿+å˜é‡   â”‚         â”‚  é…ç½®æ–‡ä»¶    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   templates/              inventory               /etc/nginx/
   nginx.conf.j2           group_vars/            nginx.conf
```

**è¯¦ç»†è¿‡ç¨‹**ï¼š
1. **å‡†å¤‡é˜¶æ®µ**ï¼šåœ¨`templates/`ç›®å½•ä¸‹åˆ›å»º`.j2`æ¨¡æ¿æ–‡ä»¶
2. **å®šä¹‰å˜é‡**ï¼šåœ¨inventoryã€group_varsæˆ–playbookä¸­å®šä¹‰å˜é‡
3. **æ‰§è¡Œé˜¶æ®µ**ï¼šAnsibleè¯»å–æ¨¡æ¿ï¼Œç”¨å˜é‡å€¼æ›¿æ¢å ä½ç¬¦
4. **éƒ¨ç½²é˜¶æ®µ**ï¼šå°†æ¸²æŸ“åçš„æ–‡ä»¶ä¼ è¾“åˆ°ç›®æ ‡æœåŠ¡å™¨

---

## 2. ğŸ“ æ¨¡æ¿ç›®å½•ç»“æ„ä¸æ–‡ä»¶å‘½å


### 2.1 templates/ç›®å½•çš„ä½œç”¨


**ç›®å½•è§„èŒƒ**ï¼š
```
project/
â”œâ”€â”€ playbooks/
â”œâ”€â”€ inventory/
â”œâ”€â”€ templates/          â† ä¸“é—¨å­˜æ”¾æ¨¡æ¿æ–‡ä»¶çš„ç›®å½•
â”‚   â”œâ”€â”€ nginx.conf.j2   â† Nginxé…ç½®æ¨¡æ¿
â”‚   â”œâ”€â”€ app.properties.j2
â”‚   â””â”€â”€ database.yml.j2
â””â”€â”€ group_vars/
```

> **ğŸ’¡ å°è´´å£«**ï¼š`templates/`ç›®å½•å¿…é¡»å’Œä½ çš„playbookåœ¨åŒä¸€å±‚çº§ï¼ŒAnsibleä¼šè‡ªåŠ¨åœ¨è¿™ä¸ªç›®å½•ä¸­æŸ¥æ‰¾æ¨¡æ¿æ–‡ä»¶ã€‚

### 2.2 .j2æ‰©å±•åçš„å«ä¹‰


**ä¸ºä»€ä¹ˆç”¨.j2ï¼Ÿ**
- **Jinja2æ ‡è¯†**ï¼š`.j2`è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªJinja2æ¨¡æ¿æ–‡ä»¶
- **åŒºåˆ†æ™®é€šæ–‡ä»¶**ï¼šè®©ä½ ä¸€çœ¼å°±çŸ¥é“è¿™æ˜¯æ¨¡æ¿ï¼Œä¸æ˜¯æœ€ç»ˆé…ç½®æ–‡ä»¶
- **ç¼–è¾‘å™¨æ”¯æŒ**ï¼šå¾ˆå¤šä»£ç ç¼–è¾‘å™¨ä¼šæ ¹æ®`.j2`æ‰©å±•åæä¾›è¯­æ³•é«˜äº®

**å‘½åå»ºè®®**ï¼š
```
åŸå§‹é…ç½®æ–‡ä»¶å + .j2 æ‰©å±•å
â”œâ”€â”€ nginx.conf      â†’ nginx.conf.j2
â”œâ”€â”€ app.properties  â†’ app.properties.j2  
â”œâ”€â”€ hosts           â†’ hosts.j2
â””â”€â”€ my.cnf          â†’ my.cnf.j2
```

### 2.3 æ¨¡æ¿æ–‡ä»¶çš„åŸºæœ¬ç»“æ„


**ç®€å•ç¤ºä¾‹**ï¼š
```nginx
# nginx.conf.j2 æ¨¡æ¿æ–‡ä»¶
server {
    listen {{ nginx_port | default(80) }};
    server_name {{ server_name }};
    root {{ web_root }}/{{ app_name }};
    
    {% if enable_ssl %}
    ssl_certificate {{ ssl_cert_path }};
    ssl_certificate_key {{ ssl_key_path }};
    {% endif %}
}
```

**æ¨¡æ¿è¯­æ³•è¯´æ˜**ï¼š
- `{{ å˜é‡å }}` - è¾“å‡ºå˜é‡çš„å€¼
- `{% if æ¡ä»¶ %}` - æ¡ä»¶åˆ¤æ–­
- `| default(80)` - å¦‚æœå˜é‡ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤å€¼80

---

## 3. ğŸ”§ templateæ¨¡å—è¯¦è§£


### 3.1 templateæ¨¡å—çš„åŸºæœ¬ç”¨æ³•


**æ ¸å¿ƒåŠŸèƒ½**ï¼š`template`æ¨¡å—è´Ÿè´£è¯»å–æ¨¡æ¿æ–‡ä»¶ï¼Œç”¨å˜é‡æ›¿æ¢å ä½ç¬¦ï¼Œç„¶åå°†æœ€ç»ˆæ–‡ä»¶å¤åˆ¶åˆ°ç›®æ ‡æœåŠ¡å™¨ã€‚

**åŸºæœ¬è¯­æ³•**ï¼š
```yaml
- name: éƒ¨ç½²Nginxé…ç½®æ–‡ä»¶
  template:
    src: nginx.conf.j2          # æ¨¡æ¿æ–‡ä»¶è·¯å¾„(ç›¸å¯¹äºtemplates/)
    dest: /etc/nginx/nginx.conf # ç›®æ ‡æ–‡ä»¶è·¯å¾„
    owner: root                 # æ–‡ä»¶æ‰€æœ‰è€…
    group: root                 # æ–‡ä»¶ç»„
    mode: '0644'               # æ–‡ä»¶æƒé™
```

### 3.2 templateæ¨¡å—çš„å¸¸ç”¨å‚æ•°


| å‚æ•° | ä½œç”¨ | ç¤ºä¾‹å€¼ | è¯´æ˜ |
|------|------|--------|------|
| **src** | æ¨¡æ¿æ–‡ä»¶è·¯å¾„ | `nginx.conf.j2` | ç›¸å¯¹äºtemplates/ç›®å½•çš„è·¯å¾„ |
| **dest** | ç›®æ ‡æ–‡ä»¶è·¯å¾„ | `/etc/nginx/nginx.conf` | ç›®æ ‡æœåŠ¡å™¨ä¸Šçš„å®Œæ•´è·¯å¾„ |
| **backup** | å¤‡ä»½åŸæ–‡ä»¶ | `yes` | ä¿®æ”¹å‰å¤‡ä»½åŸæœ‰æ–‡ä»¶ |
| **owner** | æ–‡ä»¶æ‰€æœ‰è€… | `nginx` | è®¾ç½®æ–‡ä»¶çš„æ‹¥æœ‰è€… |
| **group** | æ–‡ä»¶ç»„ | `nginx` | è®¾ç½®æ–‡ä»¶çš„ç»„ |
| **mode** | æ–‡ä»¶æƒé™ | `'0644'` | è®¾ç½®æ–‡ä»¶æƒé™ |

**å®é™…åº”ç”¨ç¤ºä¾‹**ï¼š
```yaml
- name: ç”Ÿæˆåº”ç”¨é…ç½®æ–‡ä»¶
  template:
    src: app.properties.j2
    dest: /opt/myapp/config/app.properties
    owner: appuser
    group: appuser  
    mode: '0600'
    backup: yes
  notify: restart application
```

### 3.3 templateä¸copyæ¨¡å—çš„åŒºåˆ«


**å¯¹æ¯”ç†è§£**ï¼š

```
copyæ¨¡å—ï¼šç›´æ¥å¤åˆ¶æ–‡ä»¶
åŸæ–‡ä»¶ï¼šserver_name example.com;
ç»“æœï¼š  server_name example.com;  (å®Œå…¨ä¸€æ ·)

templateæ¨¡å—ï¼šå¤„ç†æ¨¡æ¿åå¤åˆ¶
æ¨¡æ¿ï¼š  server_name {{ domain }};
å˜é‡ï¼š  domain: mysite.com
ç»“æœï¼š  server_name mysite.com;   (å˜é‡è¢«æ›¿æ¢)
```

---

## 4. âš™ï¸ Jinja2æ¨¡æ¿è¯­æ³•é…ç½®


### 4.1 è‡ªå®šä¹‰å˜é‡åˆ†éš”ç¬¦


**ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰ï¼Ÿ**
æœ‰æ—¶å€™ä½ çš„é…ç½®æ–‡ä»¶æœ¬èº«å°±åŒ…å«`{{ }}`ç¬¦å·ï¼Œè¿™æ—¶å°±ä¼šå’ŒJinja2çš„è¯­æ³•å†²çªã€‚

**é…ç½®æ–¹å¼**ï¼š
```ini
# ansible.cfg é…ç½®æ–‡ä»¶
[defaults]
variable_start_string = <<
variable_end_string = >>
```

**ä½¿ç”¨æ•ˆæœ**ï¼š
```nginx
# æ¨¡æ¿æ–‡ä»¶ä¸­ä½¿ç”¨æ–°çš„åˆ†éš”ç¬¦
server_name << domain_name >>;
location / {
    # åŸæœ‰çš„ {{ }} ä¸ä¼šè¢«å¤„ç†
    add_header X-Custom "{{user_id}}";
}
```

### 4.2 å—è¯­å¥åˆ†éš”ç¬¦é…ç½®


**æ§åˆ¶ç»“æ„è¯­æ³•è‡ªå®šä¹‰**ï¼š
```ini
[defaults]
block_start_string = <%
block_end_string = %>
```

**åº”ç”¨ç¤ºä¾‹**ï¼š
```nginx
<% if enable_ssl %>
ssl_certificate /path/to/cert.pem;
ssl_certificate_key /path/to/key.pem;
<% endif %>
```

### 4.3 æ³¨é‡Šè¯­æ³•é…ç½®


**è‡ªå®šä¹‰æ³¨é‡Šç¬¦å·**ï¼š
```ini
[defaults]  
comment_start_string = <#
comment_end_string = #>
```

**æ¨¡æ¿ä¸­çš„æ³¨é‡Š**ï¼š
```nginx
<# è¿™æ˜¯æ¨¡æ¿æ³¨é‡Šï¼Œä¸ä¼šå‡ºç°åœ¨æœ€ç»ˆæ–‡ä»¶ä¸­ #>
server {
    listen 80;
}
```

### 4.4 é…ç½®å‚æ•°æ€»è§ˆè¡¨


| é…ç½®é¡¹ | é»˜è®¤å€¼ | ä½œç”¨ | ä½¿ç”¨åœºæ™¯ |
|--------|--------|------|----------|
| `variable_start_string` | `{{` | å˜é‡å¼€å§‹æ ‡è®° | ç›®æ ‡æ–‡ä»¶åŒ…å«`{{`ç¬¦å·æ—¶ |
| `variable_end_string` | `}}` | å˜é‡ç»“æŸæ ‡è®° | ç›®æ ‡æ–‡ä»¶åŒ…å«`}}`ç¬¦å·æ—¶ |
| `block_start_string` | `{%` | æ§åˆ¶å—å¼€å§‹æ ‡è®° | ç›®æ ‡æ–‡ä»¶åŒ…å«`{%`ç¬¦å·æ—¶ |
| `block_end_string` | `%}` | æ§åˆ¶å—ç»“æŸæ ‡è®° | ç›®æ ‡æ–‡ä»¶åŒ…å«`%}`ç¬¦å·æ—¶ |
| `comment_start_string` | `{#` | æ³¨é‡Šå¼€å§‹æ ‡è®° | éœ€è¦ç‰¹æ®Šæ³¨é‡Šè¯­æ³•æ—¶ |
| `comment_end_string` | `#}` | æ³¨é‡Šç»“æŸæ ‡è®° | éœ€è¦ç‰¹æ®Šæ³¨é‡Šè¯­æ³•æ—¶ |

---

## 5. ğŸ¨ æ¨¡æ¿æ¸²æŸ“è¡Œä¸ºé…ç½®


### 5.1 trim_blocks - ä¿®å‰ªå—é…ç½®


**ä»€ä¹ˆæ˜¯å—ä¿®å‰ªï¼Ÿ**
å½“ä½ åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨æ§åˆ¶ç»“æ„ï¼ˆå¦‚ifã€forï¼‰æ—¶ï¼Œå¯èƒ½ä¼šäº§ç”Ÿå¤šä½™çš„ç©ºç™½è¡Œã€‚

**é—®é¢˜æ¼”ç¤º**ï¼š
```nginx
# ä¸å¯ç”¨trim_blocksæ—¶
server {
{% if enable_ssl %}
    listen 443 ssl;
{% endif %}
    listen 80;
}

# æ¸²æŸ“ç»“æœä¼šæœ‰ç©ºè¡Œ
server {

    listen 443 ssl;

    listen 80;
}
```

**å¯ç”¨é…ç½®**ï¼š
```ini
[defaults]
trim_blocks = True
```

**æ•ˆæœå¯¹æ¯”**ï¼š
```nginx
# å¯ç”¨åçš„æ¸²æŸ“ç»“æœ
server {
    listen 443 ssl;
    listen 80;
}
```

### 5.2 lstrip_blocks - å·¦å‰¥ç¦»å—é…ç½®


**ä½œç”¨è¯´æ˜**ï¼šç§»é™¤æ§åˆ¶å—å‰é¢çš„ç©ºç™½å­—ç¬¦ï¼Œè®©è¾“å‡ºæ›´æ•´æ´ã€‚

**é…ç½®å¯ç”¨**ï¼š
```ini
[defaults]
lstrip_blocks = True
```

**å®é™…æ•ˆæœ**ï¼š
```nginx
# æ¨¡æ¿æ–‡ä»¶
    {% if ssl_enabled %}
    ssl_protocols TLSv1.2 TLSv1.3;
    {% endif %}

# ä¸å¯ç”¨lstrip_blocks
    
    ssl_protocols TLSv1.2 TLSv1.3;
    

# å¯ç”¨å
ssl_protocols TLSv1.2 TLSv1.3;
```

### 5.3 keep_trailing_newline - ä¿æŒå°¾éƒ¨æ¢è¡Œ


**ç”¨é€”**ï¼šæŸäº›ç³»ç»Ÿè¦æ±‚é…ç½®æ–‡ä»¶å¿…é¡»ä»¥æ¢è¡Œç¬¦ç»“å°¾ã€‚

**é…ç½®æ–¹å¼**ï¼š
```ini
[defaults]
keep_trailing_newline = True
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- **Shellè„šæœ¬**ï¼šå¾ˆå¤šShellè§£é‡Šå™¨è¦æ±‚è„šæœ¬æ–‡ä»¶ä»¥æ¢è¡Œç»“å°¾
- **é…ç½®æ–‡ä»¶**ï¼šæŸäº›åº”ç”¨ç¨‹åºçš„é…ç½®è§£æå™¨æœ‰æ­¤è¦æ±‚
- **æ–‡æœ¬å¤„ç†**ï¼šç¬¦åˆPOSIXæ ‡å‡†çš„æ–‡æœ¬æ–‡ä»¶æ ¼å¼

---

## 6. ğŸš€ é«˜çº§æ¨¡æ¿é…ç½®é€‰é¡¹


### 6.1 jinja2_extensions - Jinja2æ‰©å±•


**ä»€ä¹ˆæ˜¯Jinja2æ‰©å±•ï¼Ÿ**
æ‰©å±•å¯ä»¥ä¸ºæ¨¡æ¿å¼•æ“æ·»åŠ é¢å¤–çš„åŠŸèƒ½ï¼Œæ¯”å¦‚æ›´å¤šçš„è¿‡æ»¤å™¨ã€å‡½æ•°æˆ–è¯­æ³•ã€‚

**å¸¸ç”¨æ‰©å±•é…ç½®**ï¼š
```ini
[defaults]
jinja2_extensions = jinja2.ext.do,jinja2.ext.i18n,jinja2.ext.loopcontrols
```

**æ‰©å±•åŠŸèƒ½è¯´æ˜**ï¼š

| æ‰©å±•å | åŠŸèƒ½ | ä½¿ç”¨ç¤ºä¾‹ |
|--------|------|----------|
| `jinja2.ext.do` | æ‰§è¡Œè¡¨è¾¾å¼ä¸è¾“å‡º | `{% do list.append(item) %}` |
| `jinja2.ext.i18n` | å›½é™…åŒ–æ”¯æŒ | `{{ _('Hello World') }}` |
| `jinja2.ext.loopcontrols` | å¾ªç¯æ§åˆ¶ | `{% break %}`, `{% continue %}` |

**å®é™…åº”ç”¨ç¤ºä¾‹**ï¼š
```yaml
# ä½¿ç”¨doæ‰©å±•æ“ä½œåˆ—è¡¨
{% set users = [] %}
{% for user in all_users %}
  {% if user.active %}
    {% do users.append(user.name) %}
  {% endif %}
{% endfor %}

# ç”Ÿæˆç”¨æˆ·åˆ—è¡¨
{% for username in users %}
User: {{ username }}
{% endfor %}
```

### 6.2 jinja2_native - åŸç”Ÿæ¨¡å¼


**åŸç”Ÿæ¨¡å¼çš„ä½œç”¨**ï¼š
æ­£å¸¸æƒ…å†µä¸‹ï¼ŒJinja2ä¼šæŠŠæ‰€æœ‰è¾“å‡ºéƒ½è½¬æ¢ä¸ºå­—ç¬¦ä¸²ã€‚å¯ç”¨åŸç”Ÿæ¨¡å¼åï¼Œå¯ä»¥ä¿æŒæ•°æ®çš„åŸå§‹ç±»å‹ã€‚

**é…ç½®å¯ç”¨**ï¼š
```ini
[defaults]
jinja2_native = True
```

**åº”ç”¨åœºæ™¯**ï¼š
```yaml
# æ¨¡æ¿æ–‡ä»¶
database_port: {{ db_port }}
enable_ssl: {{ ssl_enabled }}
max_connections: {{ max_conn }}

# åŸç”Ÿæ¨¡å¼å…³é—­æ—¶(é»˜è®¤)
database_port: "3306"      # å­—ç¬¦ä¸²
enable_ssl: "True"         # å­—ç¬¦ä¸²  
max_connections: "100"     # å­—ç¬¦ä¸²

# åŸç”Ÿæ¨¡å¼å¼€å¯æ—¶
database_port: 3306        # æ•°å­—
enable_ssl: true          # å¸ƒå°”å€¼
max_connections: 100      # æ•°å­—
```

> **âš ï¸ æ³¨æ„**ï¼šåŸç”Ÿæ¨¡å¼ä¸»è¦ç”¨äºç”ŸæˆYAMLæˆ–JSONæ ¼å¼çš„é…ç½®æ–‡ä»¶æ—¶ï¼Œæ™®é€šæ–‡æœ¬é…ç½®æ–‡ä»¶é€šå¸¸ä¸éœ€è¦å¯ç”¨ã€‚

---

## 7. ğŸ“‹ å®é™…åº”ç”¨åœºæ™¯ä¸æœ€ä½³å®è·µ


### 7.1 WebæœåŠ¡å™¨é…ç½®åœºæ™¯


**Nginxé…ç½®æ¨¡æ¿ç¤ºä¾‹**ï¼š

```nginx
# templates/nginx.conf.j2
upstream {{ app_name }}_backend {
{% for server in backend_servers %}
    server {{ server.ip }}:{{ server.port }}{% if server.backup | default(false) %} backup{% endif %};
{% endfor %}
}

server {
    listen {{ nginx_port | default(80) }};
    server_name {{ server_name }};
    
    {% if enable_ssl %}
    listen 443 ssl http2;
    ssl_certificate {{ ssl_cert_path }};
    ssl_certificate_key {{ ssl_key_path }};
    {% endif %}
    
    location / {
        proxy_pass http://{{ app_name }}_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

**å¯¹åº”çš„å˜é‡å®šä¹‰**ï¼š
```yaml
# group_vars/webservers.yml
app_name: myapp
nginx_port: 80
server_name: example.com
enable_ssl: true
ssl_cert_path: /etc/ssl/certs/example.com.pem
ssl_key_path: /etc/ssl/private/example.com.key

backend_servers:
  - ip: 192.168.1.10
    port: 8080
  - ip: 192.168.1.11  
    port: 8080
    backup: true
```

### 7.2 åº”ç”¨é…ç½®æ–‡ä»¶åœºæ™¯


**Spring Booté…ç½®æ¨¡æ¿**ï¼š
```properties
# templates/application.properties.j2
# æœåŠ¡å™¨é…ç½®
server.port={{ app_port | default(8080) }}
server.servlet.context-path={{ context_path | default('/') }}

# æ•°æ®åº“é…ç½®  
spring.datasource.url=jdbc:mysql://{{ db_host }}:{{ db_port }}/{{ db_name }}
spring.datasource.username={{ db_user }}
spring.datasource.password={{ db_password }}

# Redisé…ç½®
{% if redis_enabled | default(false) %}
spring.redis.host={{ redis_host }}
spring.redis.port={{ redis_port | default(6379) }}
{% if redis_password is defined %}
spring.redis.password={{ redis_password }}
{% endif %}
{% endif %}

# æ—¥å¿—é…ç½®
logging.level.{{ app_package }}={{ log_level | default('INFO') }}
logging.file.name={{ log_path }}/{{ app_name }}.log
```

### 7.3 ç³»ç»Ÿé…ç½®æ¨¡æ¿å®è·µ


**å¤šç¯å¢ƒéƒ¨ç½²é…ç½®**ï¼š
```yaml
- name: æ ¹æ®ç¯å¢ƒéƒ¨ç½²ä¸åŒé…ç½®
  template:
    src: app.properties.j2
    dest: "/opt/{{ app_name }}/config/application-{{ environment }}.properties"
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: '0640'
    backup: yes
  vars:
    app_port: "{{ environments[environment].port }}"
    db_host: "{{ environments[environment].database.host }}"
    db_name: "{{ environments[environment].database.name }}"
  notify:
    - restart application
```

### 7.4 æ¨¡æ¿é…ç½®æœ€ä½³å®è·µ


**ğŸ”¥ é‡è¦å®è·µåŸåˆ™**ï¼š

1. **å˜é‡å‘½åè§„èŒƒ**ï¼š
   ```yaml
   # å¥½çš„å‘½å
   nginx_worker_processes: 4
   mysql_max_connections: 150
   
   # é¿å…çš„å‘½å  
   wp: 4
   max_conn: 150
   ```

2. **é»˜è®¤å€¼ä½¿ç”¨**ï¼š
   ```jinja2
   # æ€»æ˜¯ä¸ºé‡è¦é…ç½®æä¾›é»˜è®¤å€¼
   worker_processes {{ nginx_workers | default('auto') }};
   client_max_body_size {{ max_upload_size | default('10M') }};
   ```

3. **æ¡ä»¶åˆ¤æ–­ä¼˜åŒ–**ï¼š
   ```jinja2
   # ä½¿ç”¨æ˜ç¡®çš„å¸ƒå°”åˆ¤æ–­
   {% if ssl_enabled | default(false) %}
   # è€Œä¸æ˜¯
   {% if ssl_enabled %}
   ```

4. **å¾ªç¯å¤„ç†æŠ€å·§**ï¼š
   ```jinja2
   # ä½¿ç”¨å¾ªç¯å˜é‡
   {% for item in items %}
   item_{{ loop.index }}: {{ item.value }}
   {% endfor %}
   ```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æ¨¡æ¿ç³»ç»Ÿï¼šç”¨å˜é‡åŠ¨æ€ç”Ÿæˆé…ç½®æ–‡ä»¶çš„æœºåˆ¶
ğŸ”¸ .j2æ‰©å±•åï¼šæ ‡è¯†Jinja2æ¨¡æ¿æ–‡ä»¶çš„å‘½åè§„èŒƒ  
ğŸ”¸ templateæ¨¡å—ï¼šè´Ÿè´£æ¨¡æ¿æ¸²æŸ“å’Œæ–‡ä»¶éƒ¨ç½²çš„æ ¸å¿ƒæ¨¡å—
ğŸ”¸ å˜é‡æ›¿æ¢ï¼šä½¿ç”¨ {{ }} è¯­æ³•åœ¨æ¨¡æ¿ä¸­æ’å…¥å˜é‡å€¼
ğŸ”¸ æ¡ä»¶æ§åˆ¶ï¼šä½¿ç”¨ {% if %} å®ç°é…ç½®çš„æ¡ä»¶åŒ…å«
ğŸ”¸ å¾ªç¯ç”Ÿæˆï¼šä½¿ç”¨ {% for %} æ‰¹é‡ç”Ÿæˆé‡å¤é…ç½®é¡¹
```

### 8.2 å…³é”®é…ç½®é€‰é¡¹ç†è§£


**ğŸ”¹ è¯­æ³•åˆ†éš”ç¬¦é…ç½®çš„ä»·å€¼**ï¼š
```
è§£å†³å†²çªï¼šå½“ç›®æ ‡é…ç½®æ–‡ä»¶æœ¬èº«åŒ…å«{{ }}æ—¶
æé«˜çµæ´»æ€§ï¼šé€‚åº”ä¸åŒçš„é…ç½®æ–‡ä»¶æ ¼å¼è¦æ±‚  
ä¿æŒå…¼å®¹ï¼šä¸ç°æœ‰é…ç½®æ–‡ä»¶æ ¼å¼ä¿æŒä¸€è‡´
```

**ğŸ”¹ æ¸²æŸ“è¡Œä¸ºé…ç½®çš„ä½œç”¨**ï¼š
```
trim_blocksï¼šæ¶ˆé™¤å¤šä½™ç©ºç™½è¡Œï¼Œè®©è¾“å‡ºæ›´æ•´æ´
lstrip_blocksï¼šç§»é™¤è¡Œé¦–ç©ºç™½ï¼Œä¼˜åŒ–æ ¼å¼
keep_trailing_newlineï¼šç¡®ä¿æ–‡ä»¶æ ¼å¼ç¬¦åˆæ ‡å‡†
jinja2_nativeï¼šä¿æŒæ•°æ®ç±»å‹ï¼Œé€‚ç”¨äºç»“æ„åŒ–é…ç½®
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


**âœ… ä»€ä¹ˆæ—¶å€™ä½¿ç”¨æ¨¡æ¿**ï¼š
- é…ç½®æ–‡ä»¶éœ€è¦æ ¹æ®ç¯å¢ƒå˜åŒ–
- å¤šå°æœåŠ¡å™¨éœ€è¦ç›¸ä¼¼ä½†ä¸å®Œå…¨ç›¸åŒçš„é…ç½®
- é…ç½®é¡¹å¾ˆå¤šï¼Œæ‰‹åŠ¨ç»´æŠ¤å®¹æ˜“å‡ºé”™
- éœ€è¦æ ¹æ®æ¡ä»¶åŒ…å«æˆ–æ’é™¤æŸäº›é…ç½®é¡¹

**âŒ ä»€ä¹ˆæ—¶å€™ä¸ç”¨æ¨¡æ¿**ï¼š
- é…ç½®æ–‡ä»¶å®Œå…¨é™æ€ï¼Œä»ä¸æ”¹å˜
- åªæœ‰ä¸€å°æœåŠ¡å™¨ï¼Œé…ç½®ç®€å•
- é…ç½®æ–‡ä»¶æ ¼å¼è¿‡äºå¤æ‚ï¼Œæ¨¡æ¿éš¾ä»¥ç»´æŠ¤

**ğŸ¯ æ¨¡æ¿ä½¿ç”¨æŠ€å·§**ï¼š
```
å˜é‡åˆ†å±‚ï¼šå…¨å±€å˜é‡ â†’ ç»„å˜é‡ â†’ ä¸»æœºå˜é‡
é»˜è®¤å€¼ï¼šä¸ºæ‰€æœ‰å˜é‡æä¾›åˆç†çš„é»˜è®¤å€¼
æµ‹è¯•éªŒè¯ï¼šä½¿ç”¨--checkæ¨¡å¼é¢„è§ˆæ¨¡æ¿æ¸²æŸ“ç»“æœ
ç‰ˆæœ¬æ§åˆ¶ï¼šæ¨¡æ¿æ–‡ä»¶çº³å…¥Gitç®¡ç†
æ–‡æ¡£è¯´æ˜ï¼šä¸ºå¤æ‚æ¨¡æ¿æ·»åŠ æ³¨é‡Šè¯´æ˜
```

### 8.4 å¸¸è§é—®é¢˜è§£å†³


**é—®é¢˜1ï¼šæ¨¡æ¿æ‰¾ä¸åˆ°**
```yaml
# ç¡®ä¿æ¨¡æ¿è·¯å¾„æ­£ç¡®
- template:
    src: nginx.conf.j2  # ç›¸å¯¹äºtemplates/ç›®å½•
    dest: /etc/nginx/nginx.conf
```

**é—®é¢˜2ï¼šå˜é‡æœªå®šä¹‰**
```jinja2
# ä½¿ç”¨é»˜è®¤å€¼é¿å…é”™è¯¯
{{ database_host | default('localhost') }}
```

**é—®é¢˜3ï¼šæ ¼å¼æ··ä¹±**
```ini
# å¯ç”¨æ ¼å¼ä¼˜åŒ–é…ç½®
trim_blocks = True
lstrip_blocks = True  
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- æ¨¡æ¿å°±æ˜¯å¡«ç©ºé¢˜ï¼Œå˜é‡å¡«ç©ºå¾ˆå®¹æ˜“
- j2æ‰©å±•è¦è®°æ¸…ï¼Œtemplateç›®å½•æ˜¯æ ¹åŸº
- æ¡ä»¶å¾ªç¯åŠ å˜é‡ï¼ŒåŠ¨æ€é…ç½®å…¨é å®ƒ
- åˆ†éš”ç¬¦å·å¯è‡ªå®šï¼Œé¿å…å†²çªæœ‰å¦™è®¡