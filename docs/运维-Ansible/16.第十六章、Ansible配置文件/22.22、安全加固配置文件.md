---
title: 22、安全加固配置文件
---
## 📚 目录

1. [Ansible安全配置基础概念](#1-ansible安全配置基础概念)
2. [防火墙配置管理](#2-防火墙配置管理)
3. [SELinux系统安全配置](#3-selinux系统安全配置)
4. [SSH安全加固配置](#4-ssh安全加固配置)
5. [用户权限管理配置](#5-用户权限管理配置)
6. [Fail2ban入侵防护配置](#6-fail2ban入侵防护配置)
7. [证书与密钥管理](#7-证书与密钥管理)
8. [系统审计与监控配置](#8-系统审计与监控配置)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🛡️ Ansible安全配置基础概念


### 1.1 什么是Ansible安全加固


**🔸 简单理解**
想象你刚搬进新房子，需要安装门锁、监控、防盗窗等安全设施。Ansible安全加固就像是用**自动化工具**给你的服务器"装修安全设施"。

```
传统手工方式：                  Ansible自动化方式：
登录服务器A → 配置防火墙         编写配置文件 → 一键部署到所有服务器
登录服务器B → 配置防火墙         ↓
登录服务器C → 配置防火墙         节省时间，避免出错，标准化配置
...重复N次，容易出错
```

**🔹 核心作用**
- **统一管理**：一套配置管理多台服务器的安全策略
- **标准化**：确保所有服务器都有相同的安全水平
- **自动化**：减少人工操作，避免配置错误
- **可追溯**：所有安全配置都有记录，便于审计

### 1.2 安全配置的核心组件


**🔧 主要安全组件**

| 组件名称 | **作用说明** | **比喻** |
|---------|-------------|---------|
| 🔥 **防火墙** | `控制网络流量进出` | 房子的门卫，决定谁能进出 |
| 🔐 **SELinux** | `系统级访问控制` | 房间内的保险箱，限制程序权限 |
| 🚪 **SSH加固** | `远程登录安全` | 加强版门锁，防止暴力破解 |
| 👤 **用户管理** | `账户权限控制` | 管理谁有钥匙，钥匙能开哪些门 |
| 🛡️ **Fail2ban** | `入侵检测防护` | 智能监控系统，自动拉黑可疑人员 |

### 1.3 配置文件组织结构


```
ansible-security/
├── playbooks/              # 主要执行文件
│   ├── security-main.yml   # 主配置文件
│   └── hardening.yml       # 加固配置
├── roles/                  # 功能模块
│   ├── firewall/           # 防火墙配置
│   ├── ssh-hardening/      # SSH加固
│   └── user-management/    # 用户管理
├── group_vars/             # 变量配置
│   ├── all.yml             # 全局变量
│   └── security.yml        # 安全专用变量
└── inventory/              # 服务器清单
    └── hosts               # 目标服务器列表
```

---

## 2. 🔥 防火墙配置管理


### 2.1 防火墙基础概念


**💡 通俗解释**
防火墙就像小区的门卫，决定什么人（网络流量）可以进入，什么人要被拒绝。

**🔹 防火墙的工作原理**
```
网络请求 → 防火墙检查 → 允许/拒绝

例如：
外部访问SSH(22端口) → 检查规则 → 允许特定IP访问
外部访问随机端口 → 检查规则 → 拒绝访问
```

### 2.2 UFW防火墙配置


**🔧 基础UFW配置**

```yaml
# roles/firewall/tasks/main.yml
---
- name: "安装UFW防火墙"
  apt:
    name: ufw
    state: present
  become: yes

- name: "设置默认策略 - 拒绝所有入站"
  ufw:
    direction: incoming
    policy: deny
  become: yes

- name: "允许SSH访问"
  ufw:
    rule: allow
    port: "{{ ssh_port | default('22') }}"
  become: yes

- name: "允许HTTP和HTTPS"
  ufw:
    rule: allow
    port: "{{ item }}"
  loop:
    - '80'
    - '443'
  when: allow_web_traffic
  become: yes

- name: "启用防火墙"
  ufw:
    state: enabled
  become: yes
```

**📝 配置变量文件**

```yaml
# group_vars/security.yml
---
# 防火墙配置
firewall_enabled: true
allow_web_traffic: true
ssh_port: 2222

# 允许的IP地址列表
allowed_ips:
  - "192.168.1.0/24"    # 本地网络
  - "10.0.0.0/8"        # 内网地址

# 服务端口配置
service_ports:
  ssh: "{{ ssh_port }}"
  http: 80
  https: 443
  mysql: 3306
```

### 2.3 高级防火墙规则


**🎯 特定IP访问控制**

```yaml
- name: "只允许特定IP访问敏感服务"
  ufw:
    rule: allow
    port: "{{ item.port }}"
    src: "{{ item.ip }}"
  loop:
    - { port: "3306", ip: "192.168.1.100" }  # 数据库只允许应用服务器访问
    - { port: "6379", ip: "192.168.1.101" }  # Redis只允许应用服务器访问
  become: yes
```

**⚠️ 重要提醒**
> 💡 **新手提示**：配置防火墙时一定要先允许SSH端口，否则会把自己锁在门外！

---

## 3. 🔐 SELinux系统安全配置


### 3.1 SELinux是什么


**🔸 简单理解**
SELinux就像给每个程序都配了一个"身份证"和"通行证"。即使程序被黑客控制，也只能在限定范围内活动，无法随意破坏系统。

```
没有SELinux的情况：
黑客控制Apache → 可以读取任意文件 → 系统被完全攻破

有SELinux的情况：
黑客控制Apache → 只能访问网站文件 → 无法访问系统其他部分
```

### 3.2 SELinux基础配置


**🔧 SELinux状态管理**

```yaml
# roles/selinux/tasks/main.yml
---
- name: "检查当前SELinux状态"
  command: getenforce
  register: selinux_status
  changed_when: false

- name: "设置SELinux为强制模式"
  selinux:
    policy: targeted
    state: enforcing
  become: yes
  notify: reboot_required

- name: "安装SELinux管理工具"
  yum:
    name:
      - policycoreutils-python-utils
      - setools-console
    state: present
  become: yes
```

### 3.3 常用SELinux配置


**📋 Web服务SELinux配置**

```yaml
- name: "允许Apache连接网络"
  seboolean:
    name: httpd_can_network_connect
    state: yes
    persistent: yes
  become: yes
  when: "'httpd' in ansible_facts.packages"

- name: "设置网站目录SELinux上下文"
  sefcontext:
    target: '/var/www/html(/.*)?'
    setype: httpd_exec_t
  become: yes

- name: "应用SELinux上下文"
  command: restorecon -R /var/www/html
  become: yes
```

**🎓 新手指南**
> 📝 **学习提示**：SELinux有三种模式
> - **Enforcing**（强制）：严格执行安全策略
> - **Permissive**（宽松）：记录违规但不阻止
> - **Disabled**（禁用）：完全关闭SELinux

---

## 4. 🚪 SSH安全加固配置


### 4.1 为什么要加固SSH


**💡 现实场景**
SSH就像你家的大门，如果不加固，黑客会：
- 暴力破解密码（就像小偷试各种钥匙）
- 使用默认端口22（就像小偷知道你家门牌号）
- 尝试root用户登录（就像直接找房主要钥匙）

### 4.2 SSH基础加固配置


**🔧 SSH服务配置**

```yaml
# roles/ssh-hardening/tasks/main.yml
---
- name: "备份原始SSH配置文件"
  copy:
    src: /etc/ssh/sshd_config
    dest: /etc/ssh/sshd_config.backup
    remote_src: yes
  become: yes

- name: "配置SSH安全参数"
  lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    backup: yes
  loop:
    - { regexp: '^#?Port', line: 'Port {{ ssh_port }}' }
    - { regexp: '^#?PermitRootLogin', line: 'PermitRootLogin no' }
    - { regexp: '^#?PasswordAuthentication', line: 'PasswordAuthentication no' }
    - { regexp: '^#?MaxAuthTries', line: 'MaxAuthTries 3' }
    - { regexp: '^#?ClientAliveInterval', line: 'ClientAliveInterval 300' }
  become: yes
  notify: restart_ssh
```

### 4.3 SSH密钥认证配置


**🔑 密钥管理任务**

```yaml
- name: "确保.ssh目录存在"
  file:
    path: "/home/{{ ansible_user }}/.ssh"
    state: directory
    mode: '0700'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: "部署授权密钥"
  authorized_key:
    user: "{{ ansible_user }}"
    key: "{{ item }}"
    state: present
  loop: "{{ ssh_public_keys }}"
```

**📁 变量配置**

```yaml
# group_vars/security.yml
ssh_port: 2222
ssh_public_keys:
  - "ssh-rsa AAAAB3NzaC1yc2EAAAA... admin@company.com"
  - "ssh-rsa AAAAB3NzaC1yc2EAAAA... backup@company.com"

# SSH安全参数
ssh_max_auth_tries: 3
ssh_client_alive_interval: 300
ssh_max_sessions: 2
```

---

## 5. 👤 用户权限管理配置


### 5.1 用户管理基础概念


**🔸 权限管理原则**
```
最小权限原则：每个用户只给必需的权限
职责分离：不同的工作分给不同的用户
定期审查：定期检查用户权限是否合理
```

### 5.2 用户创建与管理


**👥 用户管理任务**

```yaml
# roles/user-management/tasks/main.yml
---
- name: "创建管理员组"
  group:
    name: "{{ item }}"
    state: present
  loop:
    - wheel
    - sudoers
  become: yes

- name: "创建系统管理用户"
  user:
    name: "{{ item.name }}"
    groups: "{{ item.groups | default('') }}"
    shell: "{{ item.shell | default('/bin/bash') }}"
    create_home: yes
    password: "{{ item.password | password_hash('sha512') }}"
  loop: "{{ system_users }}"
  become: yes

- name: "配置sudo权限"
  lineinfile:
    path: /etc/sudoers.d/{{ item.name }}
    line: "{{ item.name }} ALL=(ALL) {{ item.sudo_type | default('ALL') }}"
    create: yes
    mode: '0440'
  loop: "{{ system_users }}"
  when: item.sudo | default(false)
  become: yes
```

### 5.3 用户变量配置


```yaml
# group_vars/users.yml
---
system_users:
  - name: "webadmin"
    groups: "wheel"
    sudo: true
    sudo_type: "NOPASSWD:ALL"
    password: "SecureP@ssw0rd123"
    
  - name: "backup"
    groups: ""
    sudo: true
    sudo_type: "NOPASSWD:/usr/bin/rsync, /usr/bin/tar"
    password: "BackupP@ss456"

# 需要删除的用户
users_to_remove:
  - "guest"
  - "demo"
```

---

## 6. 🛡️ Fail2ban入侵防护配置


### 6.1 Fail2ban工作原理


**💡 通俗解释**
Fail2ban就像一个聪明的保安，它会：
- 监控日志文件，发现可疑活动
- 记录谁在尝试暴力破解
- 自动禁止可疑IP地址访问

```
工作流程：
1. 监控SSH日志 → 发现连续失败登录
2. 识别攻击IP → 192.168.1.100尝试了10次失败登录
3. 自动封禁IP → 将该IP加入防火墙禁止列表
4. 定时解封 → 10分钟后自动解除封禁
```

### 6.2 Fail2ban基础配置


**🔧 安装和配置Fail2ban**

```yaml
# roles/fail2ban/tasks/main.yml
---
- name: "安装Fail2ban"
  package:
    name: fail2ban
    state: present
  become: yes

- name: "创建Fail2ban自定义配置"
  template:
    src: jail.local.j2
    dest: /etc/fail2ban/jail.local
    backup: yes
  become: yes
  notify: restart_fail2ban

- name: "启动并启用Fail2ban服务"
  systemd:
    name: fail2ban
    state: started
    enabled: yes
  become: yes
```

### 6.3 Fail2ban配置模板


**📝 jail.local配置模板**

```jinja2
# templates/jail.local.j2
[DEFAULT]
# 忽略的IP地址
ignoreip = 127.0.0.1/8 ::1 {{ fail2ban_ignore_ips | join(' ') }}

# 封禁时间（秒）
bantime = {{ fail2ban_ban_time | default(600) }}

# 查找时间窗口（秒）
findtime = {{ fail2ban_find_time | default(600) }}

# 最大尝试次数
maxretry = {{ fail2ban_max_retry | default(5) }}

[sshd]
enabled = true
port = {{ ssh_port }}
filter = sshd
logpath = /var/log/auth.log
maxretry = 3

[nginx-http-auth]
enabled = {{ fail2ban_nginx_enabled | default(false) }}
port = http,https
logpath = /var/log/nginx/error.log
```

**⚙️ 变量配置**

```yaml
# group_vars/security.yml
fail2ban_enabled: true
fail2ban_ban_time: 1800        # 30分钟封禁
fail2ban_find_time: 600        # 10分钟内
fail2ban_max_retry: 5          # 最多5次尝试
fail2ban_ignore_ips:
  - "192.168.1.0/24"           # 内网IP不封禁
  - "10.0.0.0/8"               # 办公网IP不封禁
```

---

## 7. 🔒 证书与密钥管理


### 7.1 SSL证书的重要性


**🔸 为什么需要SSL证书**
SSL证书就像给网站办理了"身份证"，用户访问时可以：
- 确认网站身份（不是钓鱼网站）
- 加密传输数据（防止窃听）
- 建立信任关系（浏览器显示小锁图标）

### 7.2 Let's Encrypt免费证书配置


**🔧 自动申请和续期证书**

```yaml
# roles/ssl-certs/tasks/main.yml
---
- name: "安装Certbot工具"
  package:
    name: 
      - certbot
      - python3-certbot-nginx
    state: present
  become: yes

- name: "申请SSL证书"
  command: >
    certbot --nginx
    --non-interactive
    --agree-tos
    --email {{ ssl_admin_email }}
    --domains {{ item }}
  loop: "{{ ssl_domains }}"
  become: yes
  register: certbot_result
  failed_when: 
    - certbot_result.rc != 0
    - "'Certificate not yet due for renewal' not in certbot_result.stdout"

- name: "设置证书自动续期"
  cron:
    name: "Certbot证书续期"
    minute: "0"
    hour: "12"
    job: "/usr/bin/certbot renew --quiet"
  become: yes
```

### 7.3 证书配置变量


```yaml
# group_vars/ssl.yml
---
ssl_enabled: true
ssl_admin_email: "admin@company.com"
ssl_domains:
  - "www.example.com"
  - "api.example.com"

# 证书存储路径
ssl_cert_path: "/etc/letsencrypt/live"
ssl_dhparam_path: "/etc/ssl/certs/dhparam.pem"
ssl_dhparam_size: 2048
```

---

## 8. 📊 系统审计与监控配置


### 8.1 系统审计的重要性


**💡 审计就像安装监控摄像头**
- 记录谁做了什么操作
- 发现异常行为
- 提供安全事件的证据
- 满足合规性要求

### 8.2 auditd审计系统配置


**🔧 配置系统审计**

```yaml
# roles/audit/tasks/main.yml
---
- name: "安装auditd审计系统"
  package:
    name: 
      - auditd
      - audispd-plugins
    state: present
  become: yes

- name: "配置审计规则"
  template:
    src: audit.rules.j2
    dest: /etc/audit/rules.d/custom.rules
    backup: yes
  become: yes
  notify: restart_auditd

- name: "启动并启用auditd服务"
  systemd:
    name: auditd
    state: started
    enabled: yes
  become: yes
```

### 8.3 审计规则配置


**📝 审计规则模板**

```bash
# templates/audit.rules.j2
# 监控重要文件的修改
-w /etc/passwd -p wa -k user_modification
-w /etc/group -p wa -k group_modification
-w /etc/shadow -p wa -k password_modification
-w /etc/sudoers -p wa -k sudo_modification

# 监控系统调用
-a always,exit -F arch=b64 -S adjtimex -S settimeofday -k time_change
-a always,exit -F arch=b32 -S adjtimex -S settimeofday -S stime -k time_change

# 监控网络配置变化
-a always,exit -F arch=b64 -S sethostname -S setdomainname -k system_locale

# 监控登录事件
-w /var/log/lastlog -p wa -k logins
-w /var/run/faillock -p wa -k logins
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的核心概念


```
🔸 防火墙：网络流量的门卫，控制谁能进出
🔸 SELinux：程序权限的保险箱，限制程序能做什么
🔸 SSH加固：远程登录的加强版门锁
🔸 用户管理：分配和控制系统访问权限
🔸 Fail2ban：智能保安，自动识别和阻止攻击
🔸 SSL证书：网站的身份证，保证通信安全
🔸 系统审计：监控摄像头，记录所有重要操作
```

### 9.2 安全配置最佳实践


**🎯 安全配置黄金法则**

| 原则 | **具体做法** | **新手提醒** |
|------|-------------|-------------|
| 🔐 **最小权限** | `只给必需的权限，不多给一分` | 宁可用时再给，也不要预先给太多 |
| 🛡️ **多层防护** | `防火墙+SELinux+Fail2ban组合使用` | 一道防线失效，其他防线继续保护 |
| 📝 **定期审查** | `每月检查用户权限和访问日志` | 及时发现和清理不必要的权限 |
| 🔄 **自动更新** | `启用安全补丁自动更新` | 让系统自己保持最新安全状态 |
| 📊 **监控告警** | `配置重要事件的自动通知` | 第一时间发现安全问题 |

### 9.3 常见配置模板


**🚀 快速启动配置**

```yaml
# 主要安全配置文件示例
---
- hosts: all
  become: yes
  vars:
    # 基础安全配置
    ssh_port: 2222
    fail2ban_enabled: true
    firewall_enabled: true
    selinux_enforcing: true
    
    # 用户配置
    admin_users:
      - name: "sysadmin"
        sudo: true
        
  roles:
    - firewall
    - ssh-hardening
    - user-management
    - fail2ban
    - ssl-certs
    - audit
```

### 9.4 实施步骤建议


**📋 新手实施指南**

> 🎯 **第一步：基础防护**
> 1. 配置防火墙允许必要端口
> 2. 修改SSH默认端口
> 3. 禁用root远程登录

> 🛡️ **第二步：加强防护** 
> 1. 启用SELinux强制模式
> 2. 部署Fail2ban防暴力破解
> 3. 创建专用管理员账户

> 📊 **第三步：监控审计**
> 1. 配置系统审计规则
> 2. 启用日志监控
> 3. 设置告警通知

> 🔒 **第四步：证书加密**
> 1. 申请SSL证书
> 2. 配置HTTPS强制跳转
> 3. 设置证书自动续期

**核心记忆口诀**：
> 🧠 防火墙是门卫，SELinux是保险箱  
> SSH加固防破解，用户权限要最小  
> Fail2ban当保安，证书确保通信安  
> 审计监控不可少，安全配置要趁早