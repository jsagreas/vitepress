---
title: 14、测试配置文件
---
## 📚 目录

1. [测试配置概述](#1-测试配置概述)
2. [Molecule测试框架配置](#2-Molecule测试框架配置)
3. [语法检查配置](#3-语法检查配置)
4. [测试目录结构](#4-测试目录结构)
5. [测试剧本配置](#5-测试剧本配置)
6. [核心要点总结](#6-核心要点总结)

---

## 1. 🧪 测试配置概述


### 1.1 为什么需要测试配置


**简单理解**：就像写程序需要测试一样，Ansible剧本也需要测试来确保正常工作

```
没有测试的问题：
😰 部署到生产环境才发现错误
😰 不知道剧本在不同系统上是否正常
😰 修改剧本后不确定是否破坏了原有功能

有了测试的好处：
✅ 提前发现问题，避免生产事故
✅ 确保剧本在多个平台上都能工作
✅ 放心修改代码，测试保证功能正常
```

### 1.2 Ansible测试体系架构


**整体测试流程**：
```
开发阶段          测试阶段          部署阶段
   |                |                |
写剧本 → 语法检查 → 功能测试 → 集成测试 → 生产部署
   |                |                |
编写.yml        molecule测试      实际环境验证
```

### 1.3 测试配置的核心组件


**🔸 主要测试工具**
- **Molecule**：专门的Ansible测试框架
- **yamllint**：YAML语法检查工具  
- **ansible-lint**：Ansible最佳实践检查
- **pytest**：Python测试框架（可选）

---

## 2. 🔬 Molecule测试框架配置


### 2.1 什么是Molecule


**通俗解释**：Molecule是专门为Ansible设计的测试工具，就像是给你的剧本安排一个"模拟考试"

> 💡 **核心概念**：Molecule帮你创建临时的测试环境，运行你的剧本，然后验证结果是否符合预期

### 2.2 molecule.yml 主配置文件


**配置文件结构**：
```yaml
# molecule.yml - Molecule主配置文件
---
dependency:          # 依赖管理 - 测试前需要安装什么
  name: galaxy       # 使用ansible-galaxy安装依赖

driver:              # 驱动配置 - 用什么创建测试环境
  name: docker       # 使用Docker容器作为测试环境

platforms:           # 平台配置 - 在哪些系统上测试
  - name: instance   # 测试实例名称
    image: ubuntu:20.04  # 使用的系统镜像
    pre_build_image: true

provisioner:         # 供应器配置 - 如何运行Ansible
  name: ansible      # 使用Ansible作为供应器
  inventory:
    host_vars:       # 主机变量
      instance:
        ansible_user: root

verifier:           # 验证器配置 - 如何验证测试结果
  name: ansible     # 使用Ansible验证

scenario:           # 场景配置 - 测试场景设置
  test_sequence:    # 测试步骤顺序
    - dependency
    - create
    - prepare
    - converge
    - verify
    - cleanup
    - destroy
```

### 2.3 关键配置项详解


#### 🚗 Driver驱动配置


**常用驱动类型**：

| 驱动类型 | **适用场景** | **优点** | **缺点** |
|---------|------------|---------|--------|
| `docker` | `日常开发测试` | `快速、轻量` | `不支持systemd` |
| `vagrant` | `完整系统测试` | `真实环境` | `启动较慢` |
| `podman` | `容器化测试` | `无需root权限` | `新技术，兼容性待验证` |

**Docker驱动配置示例**：
```yaml
driver:
  name: docker
  options:
    managed: false    # 是否由Molecule管理容器生命周期
    ansible_connection_options:
      ansible_connection: docker
```

#### 🏗️ Platforms平台配置


**多平台测试配置**：
```yaml
platforms:
  # Ubuntu测试环境
  - name: ubuntu-instance
    image: ubuntu:20.04
    pre_build_image: true
    groups:
      - ubuntu_group
    
  # CentOS测试环境  
  - name: centos-instance
    image: centos:8
    pre_build_image: true
    groups:
      - centos_group
    
  # 自定义容器配置
  - name: custom-instance
    image: ubuntu:20.04
    dockerfile: ../Dockerfile  # 使用自定义Dockerfile
    capabilities:
      - SYS_ADMIN             # 容器权限配置
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:ro
```

### 2.4 测试场景配置


**测试序列说明**：
```yaml
scenario:
  name: default           # 场景名称
  test_sequence:         # 自定义测试步骤
    - lint               # 1. 语法检查
    - dependency        # 2. 安装依赖
    - cleanup           # 3. 清理环境
    - destroy           # 4. 销毁旧实例
    - create            # 5. 创建测试实例
    - prepare           # 6. 准备测试环境
    - converge          # 7. 运行主要剧本
    - idempotence       # 8. 幂等性测试
    - side_effect       # 9. 副作用测试
    - verify            # 10. 验证结果
    - cleanup           # 11. 清理资源
    - destroy           # 12. 销毁测试实例
```

**各步骤含义**：
- **🔍 lint**：检查语法和最佳实践
- **📦 dependency**：安装role依赖
- **🏗️ create**：创建测试虚拟机/容器
- **⚙️ prepare**：配置测试环境
- **🎯 converge**：执行你要测试的剧本
- **✅ verify**：验证剧本执行结果
- **🧹 cleanup/destroy**：清理测试环境

---

## 3. ✅ 语法检查配置


### 3.1 yamllint配置文件


**作用说明**：yamllint专门检查YAML文件的语法规范，确保格式正确

**.yamllint配置示例**：
```yaml
# .yamllint - YAML语法检查配置
---
extends: default          # 继承默认规则

rules:
  # 行长度限制
  line-length:
    max: 120              # 每行最多120字符
    allow-non-breakable-words: true
    
  # 缩进规则  
  indentation:
    spaces: 2             # 使用2个空格缩进
    indent-sequences: true
    
  # 注释规则
  comments:
    min-spaces-from-content: 2  # 注释与内容间至少2个空格
    
  # 空行规则
  empty-lines:
    max: 2                # 最多连续2个空行
    max-start: 0          # 文件开头不允许空行
    max-end: 1            # 文件结尾最多1个空行
    
  # 尾随空格
  trailing-spaces: enable # 检查行尾空格
  
  # 文档分隔符
  document-start: disable # 不强制要求 ---
```

**常见检查项目**：
- ✅ **缩进一致性**：确保使用统一的缩进
- ✅ **行长度控制**：避免行太长影响阅读
- ✅ **空格规范**：冒号后空格、注释空格等
- ✅ **特殊字符**：避免不可见字符

### 3.2 ansible-lint配置文件


**作用说明**：检查Ansible剧本是否遵循最佳实践

**.ansible-lint配置示例**：
```yaml
# .ansible-lint - Ansible最佳实践检查
---
# 跳过的规则列表
skip_list:
  - yaml[line-length]     # 跳过行长度检查（由yamllint负责）
  - name[casing]          # 跳过任务名称大小写检查
  
# 排除的文件和目录
exclude_paths:
  - .cache/               # 缓存目录
  - .github/              # GitHub配置
  - molecule/             # Molecule测试文件
  - .ansible-lint-ignore  # 忽略文件

# 解析器配置
parseable: true           # 输出可解析格式

# 严格模式
strict: false            # 非严格模式，warning不会导致失败

# 使用的规则集
profile: production      # 生产环境规则集
```

**常见检查规则**：

| 规则类型 | **检查内容** | **示例问题** |
|---------|------------|-------------|
| **语法规则** | `YAML格式、Ansible语法` | `缩进错误、关键字拼写` |
| **最佳实践** | `任务命名、变量使用` | `任务缺少name、硬编码值` |
| **安全规则** | `权限、密码管理` | `明文密码、过高权限` |
| **性能规则** | `循环优化、条件判断` | `不必要的循环、复杂条件` |

---

## 4. 📁 测试目录结构


### 4.1 标准测试目录布局


**目录结构说明**：
```
project/
├── molecule/                    # Molecule测试目录
│   ├── default/                # 默认测试场景
│   │   ├── molecule.yml        # 场景配置
│   │   ├── converge.yml        # 主要测试剧本
│   │   ├── verify.yml          # 验证剧本
│   │   ├── prepare.yml         # 准备剧本
│   │   └── cleanup.yml         # 清理剧本
│   └── alternative/            # 替代测试场景
│       └── molecule.yml
├── tests/                      # 传统测试目录
│   ├── inventory              # 测试清单文件
│   └── test.yml               # 测试剧本
├── test_plugins/              # 测试插件目录
│   └── custom_test.py         # 自定义测试插件
├── .yamllint                  # YAML语法检查配置
├── .ansible-lint             # Ansible语法检查配置
└── ansible.cfg               # Ansible配置文件
```

### 4.2 tests/ 传统测试目录


**用途说明**：存放传统的手动测试文件

**inventory测试清单**：
```ini
# tests/inventory - 测试主机清单
[test_servers]
localhost ansible_connection=local

[test_servers:vars]
ansible_user=root
ansible_become=yes
```

**test.yml测试剧本**：
```yaml
# tests/test.yml - 手动测试剧本
---
- hosts: test_servers
  gather_facts: yes
  
  tasks:
    - name: 🧪 测试基本连接
      ping:
      
    - name: 📋 显示系统信息
      debug:
        msg: "系统：{{ ansible_distribution }} {{ ansible_distribution_version }}"
```

### 4.3 test_plugins/ 测试插件目录


**作用说明**：存放自定义的测试插件，扩展测试能力

**自定义测试插件示例**：
```python
# test_plugins/custom_test.py
class TestModule(object):
    """自定义测试模块"""
    
    def tests(self):
        return {
            'is_service_running': self.is_service_running,
        }
    
    def is_service_running(self, service_name):
        """检查服务是否运行"""
        # 实现服务检查逻辑
        pass
```

---

## 5. 🎭 测试剧本配置


### 5.1 converge.yml 收敛剧本


**作用说明**：这是主要的测试剧本，运行你想要测试的角色或任务

```yaml
# molecule/default/converge.yml - 主要测试剧本
---
- name: 🎯 收敛测试
  hosts: all
  gather_facts: yes
  become: yes
  
  # 测试变量
  vars:
    test_package: nginx
    test_service: nginx
    
  # 执行要测试的角色
  roles:
    - role: nginx_role
      
  # 或者直接写测试任务  
  tasks:
    - name: 📦 安装测试包
      package:
        name: "{{ test_package }}"
        state: present
        
    - name: 🚀 启动服务
      service:
        name: "{{ test_service }}"
        state: started
        enabled: yes
```

### 5.2 verify.yml 验证剧本


**作用说明**：验证converge.yml执行后的结果是否符合预期

```yaml
# molecule/default/verify.yml - 结果验证剧本
---
- name: ✅ 验证测试结果
  hosts: all
  gather_facts: yes
  
  tasks:
    - name: 🔍 检查包是否已安装
      package_facts:
      
    - name: ✅ 验证nginx已安装
      assert:
        that:
          - "'nginx' in ansible_facts.packages"
        fail_msg: "❌ nginx包未正确安装"
        success_msg: "✅ nginx包安装成功"
        
    - name: 🔍 检查服务状态
      service_facts:
      
    - name: ✅ 验证nginx服务运行
      assert:
        that:
          - "ansible_facts.services['nginx.service'].state == 'running'"
        fail_msg: "❌ nginx服务未运行"
        success_msg: "✅ nginx服务正常运行"
        
    - name: 🌐 测试HTTP响应
      uri:
        url: http://localhost:80
        method: GET
        status_code: 200
      register: http_result
      
    - name: ✅ 验证网站可访问
      assert:
        that:
          - "http_result.status == 200"
        fail_msg: "❌ 网站无法访问"
        success_msg: "✅ 网站访问正常"
```

### 5.3 prepare.yml 准备剧本


**作用说明**：在主要测试前准备测试环境

```yaml
# molecule/default/prepare.yml - 环境准备剧本
---
- name: 🛠️ 准备测试环境
  hosts: all
  gather_facts: yes
  become: yes
  
  tasks:
    - name: 🔄 更新包缓存
      package:
        update_cache: yes
      when: ansible_os_family == "Debian"
      
    - name: 📦 安装必要的工具
      package:
        name:
          - curl
          - wget
          - net-tools
        state: present
        
    - name: 🔧 配置系统设置
      sysctl:
        name: net.ipv4.ip_forward
        value: '1'
        state: present
      ignore_errors: yes  # 容器环境可能无法修改
```

### 5.4 cleanup.yml 清理剧本


**作用说明**：测试完成后清理环境

```yaml
# molecule/default/cleanup.yml - 环境清理剧本  
---
- name: 🧹 清理测试环境
  hosts: all
  gather_facts: no
  become: yes
  
  tasks:
    - name: 🛑 停止测试服务
      service:
        name: nginx
        state: stopped
      ignore_errors: yes
      
    - name: 🗑️ 卸载测试包
      package:
        name: nginx
        state: absent
      ignore_errors: yes
      
    - name: 🧽 清理临时文件
      file:
        path: /tmp/test_*
        state: absent
      ignore_errors: yes
```

### 5.5 dependency依赖管理


**galaxy依赖配置**：
```yaml
# molecule.yml中的依赖配置
dependency:
  name: galaxy
  options:
    requirements-file: requirements.yml
    role-file: requirements.yml
```

**requirements.yml依赖文件**：
```yaml
# requirements.yml - 角色依赖
---
roles:
  - name: geerlingguy.nginx
    version: "2.8.0"
    
collections:
  - name: community.general
    version: ">=3.0.0"
```

---

## 6. 📋 核心要点总结


### 6.1 必须掌握的核心概念


```
🔸 Molecule测试框架：专门为Ansible设计的自动化测试工具
🔸 语法检查工具：yamllint检查YAML语法，ansible-lint检查最佳实践
🔸 测试目录结构：molecule/、tests/、test_plugins/各有不同用途
🔸 测试剧本类型：converge主测试、verify验证、prepare准备、cleanup清理
🔸 配置文件作用：molecule.yml控制整个测试流程和环境
```

### 6.2 关键理解要点


**🔹 测试的价值**
```
为什么要写测试：
• 🛡️ 预防生产故障：提前发现问题
• 🔄 支持重构：放心修改代码
• 📚 活文档：测试就是最好的使用说明
• 🎯 质量保证：确保剧本在不同环境都能工作
```

**🔹 Molecule的核心流程**
```
测试生命周期：
创建环境 → 准备环境 → 执行剧本 → 验证结果 → 清理环境

每个阶段都有对应的剧本：
create → prepare → converge → verify → cleanup
```

**🔹 配置文件的层次关系**
```
molecule.yml：总控制台，定义测试策略
├── driver：定义测试环境类型
├── platforms：定义测试目标系统  
├── provisioner：定义如何运行Ansible
└── verifier：定义如何验证结果
```

### 6.3 实际应用指导


**⭐ 测试配置最佳实践**
- **🎯 简单开始**：先用Docker driver，快速上手
- **📊 多平台测试**：至少测试Ubuntu和CentOS
- **✅ 完整验证**：不只检查安装，还要验证功能
- **🧹 环境清理**：测试后彻底清理，避免影响下次测试

**🔧 常用配置模板**
```yaml
# 基础molecule.yml模板
---
dependency:
  name: galaxy
driver:
  name: docker  
platforms:
  - name: instance
    image: ubuntu:20.04
    pre_build_image: true
provisioner:
  name: ansible
verifier:
  name: ansible
```

**📝 配置文件检查清单**
- ✅ `.yamllint`：YAML格式检查配置
- ✅ `.ansible-lint`：Ansible最佳实践检查
- ✅ `molecule.yml`：测试环境和流程配置
- ✅ 测试剧本：converge、verify、prepare、cleanup齐全

### 6.4 故障排除指南


**🐛 常见问题解决**
```
容器权限问题：
→ 添加capabilities: [SYS_ADMIN]

服务启动失败：  
→ 使用init系统容器镜像

网络连接问题：
→ 检查防火墙和端口配置

依赖安装失败：
→ 检查requirements.yml格式
```

**🔍 调试技巧**
- **详细输出**：`molecule test -v` 查看详细日志
- **保留环境**：`molecule converge` 创建环境不销毁
- **单步调试**：分步执行 create、prepare、converge
- **进入容器**：`molecule login` 直接登录测试容器

**核心记忆**：
- Molecule让Ansible测试变简单，配置文件控制全流程
- 语法检查保代码质量，测试剧本验证功能
- Docker容器做测试快又轻，多平台验证保兼容
- 准备清理要做好，测试环境不冲突