---
title: 11、插件配置文件
---
## 📚 目录

1. [插件系统基础概念](#1-插件系统基础概念)
2. [动作与回调插件配置](#2-动作与回调插件配置)
3. [连接与传输插件配置](#3-连接与传输插件配置)
4. [数据处理插件配置](#4-数据处理插件配置)
5. [清单与变量插件配置](#5-清单与变量插件配置)
6. [执行策略插件配置](#6-执行策略插件配置)
7. [网络设备专用插件配置](#7-网络设备专用插件配置)
8. [权限与缓存插件配置](#8-权限与缓存插件配置)
9. [测试与验证插件配置](#9-测试与验证插件配置)
10. [插件配置最佳实践](#10-插件配置最佳实践)
11. [核心要点总结](#11-核心要点总结)

---

## 1. 🧩 插件系统基础概念


### 1.1 什么是Ansible插件系统


**🔸 通俗理解**
想象一下Ansible是一台"万能工作机"，而插件就是给这台机器装上的各种"专业工具头"：
- 🔧 **动作插件** = 执行具体任务的工具头（如安装软件、复制文件）
- 🔌 **连接插件** = 连接不同设备的接口（如SSH、WinRM）
- 📊 **回调插件** = 监控和报告工作状态的仪表盘

### 1.2 插件系统的工作原理


```
Ansible核心引擎
      ↓
  插件加载器
      ↓
┌─────────────────────────────────────┐
│  各类插件按需加载和执行              │
├─────────────────────────────────────┤
│ 动作插件 → 执行具体任务              │
│ 连接插件 → 建立设备连接              │
│ 回调插件 → 处理执行结果              │
│ 过滤插件 → 处理数据转换              │
│ 查找插件 → 获取外部数据              │
└─────────────────────────────────────┘
```

> 💡 **核心理解**: 插件让Ansible具备了"模块化扩展"能力，就像给手机安装不同的APP来实现不同功能

### 1.3 插件配置的重要性


**为什么需要配置插件路径？**
- 🎯 **功能扩展**: 使用自定义或第三方插件增强功能
- 📁 **组织管理**: 将插件按类型分类存放便于维护
- 🔄 **版本控制**: 不同项目可以使用不同版本的插件
- 🚀 **性能优化**: 只加载需要的插件，提升执行效率

---

## 2. 🎭 动作与回调插件配置


### 2.1 动作插件 (action_plugins)


**🔸 什么是动作插件**
动作插件是Ansible执行任务时调用的"实际执行者"，每当你在playbook中写一个任务，背后就有对应的动作插件在工作。

```ini
# ansible.cfg 配置示例
[defaults]
action_plugins = ./plugins/action:/usr/share/ansible/plugins/action
```

**🎯 实际应用场景**
```yaml
# playbook示例 - 动作插件在背后工作
- name: 复制文件到远程主机
  copy:  # 这里会调用copy动作插件
    src: /tmp/myfile.txt
    dest: /opt/myfile.txt

- name: 安装软件包
  yum:   # 这里会调用yum动作插件
    name: nginx
    state: present
```

| **场景** | **默认插件** | **自定义插件用途** |
|---------|-------------|------------------|
| 🔄 **文件操作** | `copy`, `template` | `高级文件处理、加密复制` |
| 📦 **包管理** | `yum`, `apt` | `企业内部包管理器支持` |
| 🌐 **网络配置** | `uri`, `get_url` | `特定API调用、数据获取` |

### 2.2 回调插件 (callback_plugins)


**🔸 什么是回调插件**
回调插件就像是Ansible的"实时播报员"，负责告诉你任务执行的情况，是成功还是失败，花了多长时间等等。

```ini
[defaults]
callback_plugins = ./plugins/callback:/usr/share/ansible/plugins/callback
# 启用特定回调插件
stdout_callback = yaml  # 使用yaml格式输出结果
```

**💡 常用回调插件配置**
```ini
# 更美观的输出格式
stdout_callback = community.general.yaml
# 或者使用JSON格式
stdout_callback = json

# 启用计时器
callbacks_enabled = timer, profile_tasks
```

**📊 回调插件效果对比**
```
# 默认输出（比较简陋）
TASK [安装nginx] ********************************
ok: [webserver1]

# YAML回调插件输出（更清晰）
TASK [安装nginx] ********************************
ok: [webserver1] => 
  changed: false
  msg: ""
  rc: 0
```

---

## 3. 🔌 连接与传输插件配置


### 3.1 连接插件 (connection_plugins)


**🔸 通俗理解连接插件**
连接插件就像是Ansible与目标机器之间的"桥梁"，不同类型的设备需要不同的"桥梁"来连接：
- 🐧 **Linux服务器** → SSH连接插件
- 🪟 **Windows服务器** → WinRM连接插件  
- 🌐 **网络设备** → 专用网络连接插件

```ini
[defaults]
connection_plugins = ./plugins/connection:/usr/share/ansible/plugins/connection
```

**🎯 常见连接插件应用**

| **目标设备类型** | **连接插件** | **配置示例** | **使用场景** |
|----------------|-------------|-------------|------------|
| 🐧 **Linux服务器** | `ssh` | `ansible_connection: ssh` | `标准Linux管理` |
| 🪟 **Windows服务器** | `winrm` | `ansible_connection: winrm` | `Windows服务器管理` |
| 🐳 **Docker容器** | `docker` | `ansible_connection: docker` | `容器化应用部署` |
| ☁️ **云端实例** | `aws_ssm` | `ansible_connection: aws_ssm` | `AWS EC2实例管理` |

```yaml
# inventory文件中指定连接插件
[windows_servers]
win-server-01 ansible_connection=winrm ansible_winrm_server_cert_validation=ignore

[linux_servers]  
web-server-01 ansible_connection=ssh ansible_user=admin

[docker_containers]
app-container ansible_connection=docker
```

---

## 4. 🔄 数据处理插件配置


### 4.1 过滤器插件 (filter_plugins)


**🔸 什么是过滤器插件**
过滤器插件就像是"数据加工厂"，把原始数据按照你的需求进行各种转换和处理。

```ini
[defaults]
filter_plugins = ./plugins/filter:/usr/share/ansible/plugins/filter
```

**💻 过滤器使用示例**
```yaml
---
- name: 数据处理示例
  hosts: localhost
  vars:
    server_list: ['web1', 'web2', 'db1']
    user_data: "  ADMIN_USER  "
  
  tasks:
    - name: 字符串处理
      debug:
        msg: "清理后的用户名: {{ user_data | trim | lower }}"
        # 结果: admin_user
    
    - name: 列表过滤
      debug:
        msg: "Web服务器: {{ server_list | select('match', 'web.*') | list }}"
        # 结果: ['web1', 'web2']
```

**🎯 常用过滤器分类**

```
📝 文本处理过滤器:
├── trim          # 去除空格
├── upper/lower   # 大小写转换  
├── replace       # 字符串替换
└── regex_search  # 正则匹配

📊 数据结构处理:
├── map           # 数据映射
├── select        # 条件筛选
├── group_by      # 分组操作
└── unique        # 去重处理

🔢 数学运算:
├── int           # 转换为整数
├── float         # 转换为浮点数
├── abs           # 绝对值
└── round         # 四舍五入
```

### 4.2 查找插件 (lookup_plugins)


**🔸 什么是查找插件**
查找插件就像是Ansible的"信息收集员"，能从各种外部数据源获取信息并在playbook中使用。

```ini
[defaults]
lookup_plugins = ./plugins/lookup:/usr/share/ansible/plugins/lookup
```

**🔍 查找插件实战应用**
```yaml
---
- name: 查找插件使用示例
  hosts: localhost
  tasks:
    # 从文件读取数据
    - name: 读取配置文件内容
      debug:
        msg: "配置内容: {{ lookup('file', '/etc/hostname') }}"
    
    # 从环境变量获取值
    - name: 获取环境变量
      debug:
        msg: "当前用户: {{ lookup('env', 'USER') }}"
    
    # 从密码管理器获取密码
    - name: 获取数据库密码
      debug:
        msg: "密码已获取"
      vars:
        db_password: "{{ lookup('passwordstore', 'database/mysql_root') }}"
```

**📋 常用查找插件类型**

| **数据源** | **查找插件** | **用途说明** | **使用场景** |
|-----------|-------------|-------------|------------|
| 📁 **本地文件** | `file` | `读取文件内容` | `配置文件、证书读取` |
| 🌐 **环境变量** | `env` | `获取环境变量值` | `系统配置、敏感信息` |
| 🔐 **密码存储** | `passwordstore` | `从密码管理器获取` | `数据库密码、API密钥` |
| 🗄️ **数据库查询** | `mysql`, `postgresql` | `数据库数据查询` | `动态配置、用户列表` |

---

## 5. 📋 清单与变量插件配置


### 5.1 清单插件 (inventory_plugins)


**🔸 什么是清单插件**
清单插件就像是Ansible的"通讯录管理器"，帮助Ansible从不同来源自动发现和管理要操作的服务器列表。

```ini
[defaults]
inventory_plugins = ./plugins/inventory:/usr/share/ansible/plugins/inventory

# 启用特定清单插件
[inventory]
enable_plugins = host_list, script, auto, yaml, ini, toml
```

**🌐 动态清单实战示例**
```yaml
# aws_inventory.yml - AWS动态清单配置
plugin: amazon.aws.aws_ec2
regions:
  - us-east-1
  - us-west-2
keyed_groups:
  - key: tags
    prefix: tag
  - key: instance_type
    prefix: instance_type
compose:
  ansible_host: public_ip_address
```

```bash
# 使用动态清单
ansible-inventory -i aws_inventory.yml --list
```

**☁️ 云平台清单插件对比**

| **云平台** | **清单插件** | **配置复杂度** | **适用场景** |
|-----------|-------------|---------------|------------|
| 🌩️ **AWS** | `amazon.aws.aws_ec2` | `⭐⭐⭐` | `EC2实例自动发现` |
| ☁️ **Azure** | `azure.azcollection.azure_rm` | `⭐⭐⭐⭐` | `Azure虚拟机管理` |
| 🌈 **GCP** | `google.cloud.gcp_compute` | `⭐⭐⭐` | `GCE实例批量操作` |
| 🐳 **Docker** | `community.docker.docker_containers` | `⭐⭐` | `容器集群管理` |

### 5.2 变量插件 (vars_plugins)


**🔸 什么是变量插件**
变量插件就像是Ansible的"配置助手"，能够从各种外部源动态加载变量，让你的配置更灵活。

```ini
[defaults]
vars_plugins = ./plugins/vars:/usr/share/ansible/plugins/vars

# 启用变量插件
vars_plugins_enabled = host_group_vars, community.general.cobbler
```

**🎯 变量插件应用场景**
```yaml
# 项目结构示例
project/
├── group_vars/
│   ├── webservers.yml      # Web服务器组变量
│   └── databases.yml       # 数据库组变量
├── host_vars/
│   ├── web01.yml          # 单个主机变量
│   └── db01.yml           
└── external_vars/         # 外部变量源
    └── vault_vars.yml     # 加密变量文件
```

```yaml
# webservers.yml - 组变量示例
---
nginx_version: "1.20"
ssl_enabled: true
backup_schedule: "0 2 * * *"

# 使用外部变量源
external_config: "{{ lookup('file', 'external_vars/vault_vars.yml') | from_yaml }}"
```

---

## 6. 🎯 执行策略插件配置


### 6.1 策略插件 (strategy_plugins)


**🔸 什么是策略插件**
策略插件就像是Ansible的"任务调度器"，决定了任务在多台服务器上的执行顺序和方式。

```ini
[defaults]
strategy_plugins = ./plugins/strategy:/usr/share/ansible/plugins/strategy
```

**⚡ 执行策略对比**

```yaml
---
- name: 不同执行策略示例
  hosts: all
  strategy: linear    # 默认策略：按顺序逐个执行
  # strategy: free    # 自由策略：各主机独立执行
  # strategy: debug   # 调试策略：支持断点调试
  
  tasks:
    - name: 安装软件包
      yum:
        name: nginx
        state: present
    
    - name: 启动服务
      systemd:
        name: nginx
        state: started
```

**📊 策略插件性能对比**

| **执行策略** | **执行方式** | **适用场景** | **优缺点** |
|-------------|-------------|-------------|-----------|
| 🔄 **linear** | `串行执行，等待所有主机完成当前任务再执行下一个` | `依赖性强的任务` | `✅稳定可靠 ❌速度较慢` |
| 🚀 **free** | `并行执行，各主机独立推进` | `无依赖的批量操作` | `✅速度快 ❌可能出现不一致` |
| 🐛 **debug** | `支持断点调试的执行方式` | `开发调试阶段` | `✅便于调试 ❌仅用于开发` |

---

## 7. 🌐 网络设备专用插件配置


### 7.1 终端插件 (terminal_plugins)


**🔸 什么是终端插件**
终端插件专门用于连接网络设备，就像是给Ansible装上了"网络设备语言翻译器"。

```ini
[defaults]
terminal_plugins = ./plugins/terminal:/usr/share/ansible/plugins/terminal
```

### 7.2 网络协议插件配置


**🔸 NETCONF插件 (netconf_plugins)**
```ini
[defaults]
netconf_plugins = ./plugins/netconf:/usr/share/ansible/plugins/netconf
```

**🔸 CLI配置插件 (cliconf_plugins)**
```ini
[defaults]
cliconf_plugins = ./plugins/cliconf:/usr/share/ansible/plugins/cliconf
```

**🔸 HTTP API插件 (httpapi_plugins)**
```ini
[defaults]
httpapi_plugins = ./plugins/httpapi:/usr/share/ansible/plugins/httpapi
```

**🌐 网络设备管理示例**
```yaml
---
- name: 网络设备配置管理
  hosts: cisco_switches
  connection: network_cli
  gather_facts: false
  
  tasks:
    - name: 配置VLAN
      cisco.ios.ios_vlans:
        config:
          - vlan_id: 100
            name: PRODUCTION
            state: active
    
    - name: 配置接口
      cisco.ios.ios_interfaces:
        config:
          - name: GigabitEthernet0/1
            description: "Server Connection"
            enabled: true
```

**📡 网络插件应用矩阵**

```
设备类型          终端插件      CLI插件       API插件       使用场景
┌─────────────────────────────────────────────────────────────┐
│ Cisco IOS    →   ios      →  ios       →  无        →  路由器交换机  │
│ Juniper      →   junos    →  junos     →  junos     →  企业网络设备  │
│ Arista EOS   →   eos      →  eos       →  eos       →  数据中心设备  │
│ Huawei VRP   →   ce        →  ce        →  无        →  运营商设备   │
└─────────────────────────────────────────────────────────────┘
```

---

## 8. 🔐 权限与缓存插件配置


### 8.1 权限提升插件 (become_plugins)


**🔸 什么是权限提升插件**
权限提升插件就像是Ansible的"安全卫士"，帮助普通用户临时获得管理员权限来执行系统任务。

```ini
[defaults]
become_plugins = ./plugins/become:/usr/share/ansible/plugins/become
```

**🎯 权限提升实战配置**
```yaml
---
- name: 权限提升示例
  hosts: linux_servers
  become: true          # 启用权限提升
  become_method: sudo   # 使用sudo方式
  become_user: root     # 提升到root用户
  
  tasks:
    - name: 安装系统软件包
      yum:
        name: htop
        state: present
    
    - name: 修改系统配置文件
      lineinfile:
        path: /etc/sysctl.conf
        line: 'net.ipv4.ip_forward = 1'
```

**🔒 权限提升方法对比**

| **提升方法** | **适用系统** | **配置要求** | **安全级别** | **使用场景** |
|-------------|-------------|-------------|-------------|-------------|
| 🔑 **sudo** | `Linux/Unix` | `sudoers配置` | `⭐⭐⭐⭐` | `标准Linux管理` |
| 👑 **su** | `Linux/Unix` | `root密码` | `⭐⭐⭐` | `传统Unix系统` |
| 🪟 **runas** | `Windows` | `用户凭据` | `⭐⭐⭐⭐` | `Windows服务器` |
| 🐳 **doas** | `OpenBSD` | `doas.conf配置` | `⭐⭐⭐⭐⭐` | `高安全要求系统` |

### 8.2 缓存插件 (cache_plugins)


**🔸 什么是缓存插件**
缓存插件就像是Ansible的"记忆系统"，能够保存之前收集的信息，避免重复工作提升效率。

```ini
[defaults]
cache_plugins = ./plugins/cache:/usr/share/ansible/plugins/cache

# 启用facts缓存
gathering = smart
fact_caching = jsonfile
fact_caching_connection = /tmp/ansible_fact_cache
fact_caching_timeout = 86400  # 24小时
```

**⚡ 缓存效果对比**
```bash
# 第一次执行（无缓存）- 耗时较长
$ time ansible all -m setup
real    0m15.234s

# 第二次执行（有缓存）- 耗时很短  
$ time ansible all -m setup
real    0m2.156s
```

---

## 9. 🧪 测试与验证插件配置


### 9.1 测试插件 (test_plugins)


**🔸 什么是测试插件**
测试插件就像是Ansible的"质量检查员"，帮助你在playbook中进行各种条件判断和数据验证。

```ini
[defaults]
test_plugins = ./plugins/test:/usr/share/ansible/plugins/test
```

**🎯 测试插件实战应用**
```yaml
---
- name: 测试插件使用示例
  hosts: localhost
  vars:
    server_port: 8080
    service_status: "running"
    ip_address: "192.168.1.100"
  
  tasks:
    - name: 检查端口号是否有效
      debug:
        msg: "端口号有效"
      when: server_port is number and server_port > 1024
    
    - name: 验证服务状态
      debug:
        msg: "服务正在运行"
      when: service_status is match("running|active")
    
    - name: 验证IP地址格式
      debug:
        msg: "IP地址格式正确"
      when: ip_address is regex('^(\d{1,3}\.){3}\d{1,3}$')
```

**🔍 常用测试插件分类**

```
📊 数据类型测试:
├── defined      # 变量是否已定义
├── undefined    # 变量是否未定义
├── number       # 是否为数字
└── string       # 是否为字符串

🔍 内容匹配测试:
├── match        # 正则表达式匹配
├── search       # 包含搜索
├── regex        # 复杂正则验证
└── version      # 版本号比较

📋 集合操作测试:
├── subset       # 子集判断
├── superset     # 超集判断
├── contains     # 包含关系
└── intersects   # 交集判断
```

---

## 10. 🎨 插件配置最佳实践


### 10.1 插件目录组织结构


**📁 推荐的目录结构**
```
ansible-project/
├── ansible.cfg                 # 主配置文件
├── plugins/                   # 自定义插件目录
│   ├── action/               # 动作插件
│   ├── callback/             # 回调插件
│   ├── connection/           # 连接插件
│   ├── filter/               # 过滤器插件
│   ├── lookup/               # 查找插件
│   ├── inventory/            # 清单插件
│   ├── vars/                 # 变量插件
│   └── test/                 # 测试插件
├── playbooks/                # playbook文件
└── inventories/              # 清单文件
```

### 10.2 性能优化配置


```ini
[defaults]
# 基础插件路径配置
action_plugins = ./plugins/action:/usr/share/ansible/plugins/action
callback_plugins = ./plugins/callback
filter_plugins = ./plugins/filter
lookup_plugins = ./plugins/lookup

# 性能优化配置
gathering = smart              # 智能facts收集
fact_caching = jsonfile       # 启用facts缓存
fact_caching_timeout = 3600   # 缓存1小时

# 输出优化
stdout_callback = yaml        # 美观输出格式
callbacks_enabled = timer     # 启用计时器

# 连接优化
pipelining = True            # 启用管道传输
host_key_checking = False    # 跳过SSH主机密钥检查（开发环境）
```

### 10.3 安全配置建议


> 🔒 **安全提醒**: 生产环境配置要点

```ini
[defaults]
# 安全相关配置
host_key_checking = True         # 生产环境务必启用
remote_user = ansible-user       # 使用专门的ansible用户
become_ask_pass = True           # 每次询问提权密码

# 敏感数据处理
vault_password_file = ~/.vault_pass  # Vault密码文件路径
vault_encrypt_identity = production  # 指定加密标识

# 日志配置
log_path = /var/log/ansible.log  # 启用日志记录
```

---

## 11. 📋 核心要点总结


### 11.1 必须掌握的插件配置


```
🔸 基础插件路径：掌握action、callback、connection三大核心插件配置
🔸 数据处理插件：熟练使用filter和lookup插件处理复杂数据
🔸 清单管理插件：理解inventory和vars插件的动态配置能力  
🔸 执行策略插件：根据场景选择合适的strategy执行方式
🔸 安全权限插件：正确配置become插件保障系统安全
```

### 11.2 关键理解要点


**🔹 插件系统的模块化思维**
```
理解要点：
- 每类插件解决特定领域问题，职责单一明确
- 插件之间相互配合，形成完整的自动化解决方案  
- 自定义插件可以扩展Ansible原生功能
```

**🔹 配置路径的层次结构**  
```
配置优先级：
1. 项目本地插件目录 (./plugins/*)
2. 用户家目录插件 (~/.ansible/plugins/*)  
3. 系统全局插件 (/usr/share/ansible/plugins/*)
```

**🔹 性能与安全的平衡**
```
开发环境：注重效率和调试便利性
├── 启用缓存减少重复操作
├── 使用调试友好的回调插件
└── 简化权限验证流程

生产环境：注重安全性和稳定性  
├── 严格的权限提升配置
├── 完整的日志记录
└── 保守的连接和缓存策略
```

### 11.3 实际应用价值


**🎯 场景化应用指南**
- **🏢 企业环境**: 重点配置清单插件和权限插件，实现规模化管理
- **☁️ 云原生环境**: 重点配置连接插件和查找插件，支持动态基础设施
- **🌐 网络运维**: 重点配置网络专用插件，实现设备统一管理
- **🔧 开发测试**: 重点配置回调插件和测试插件，提升开发效率

**💡 学习建议**
- **由浅入深**: 先掌握基础插件，再学习专业插件
- **实践导向**: 在实际项目中逐步应用不同类型插件
- **文档参考**: 经常查阅官方插件文档了解最新功能
- **社区资源**: 关注社区插件，学习最佳实践

**核心记忆**：
- Ansible插件系统是模块化扩展的核心机制
- 不同插件类型解决不同领域的自动化问题  
- 合理配置插件路径是发挥插件威力的基础
- 安全配置和性能优化需要根据环境平衡考虑