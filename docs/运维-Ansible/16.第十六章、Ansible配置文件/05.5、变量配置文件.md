---
title: 5、变量配置文件
---
## 📚 目录

1. [变量配置文件概述](#1-变量配置文件概述)
2. [全局变量配置](#2-全局变量配置)
3. [组变量配置](#3-组变量配置)
4. [主机变量配置](#4-主机变量配置)
5. [剧本变量文件](#5-剧本变量文件)
6. [加密变量配置](#6-加密变量配置)
7. [运行时变量](#7-运行时变量)
8. [系统内置变量](#8-系统内置变量)
9. [变量优先级规则](#9-变量优先级规则)
10. [动态变量操作](#10-动态变量操作)
11. [核心要点总结](#11-核心要点总结)

---

## 1. 🌟 变量配置文件概述


### 1.1 什么是Ansible变量

**🔸 变量的本质**
变量就像是代码中的"占位符"，可以存储数据并在需要时调用。想象一下你在写信时用"XXX"代替收信人姓名，后面统一替换成真实姓名，Ansible变量就是这个道理。

```
简单理解变量：
普通做法：每台服务器都写死配置
变量做法：用变量代替，灵活替换

比如：
- 服务器IP：192.168.1.10 → {{ server_ip }}
- 软件版本：nginx-1.20 → {{ nginx_version }}
- 用户名：admin → {{ admin_user }}
```

### 1.2 为什么需要变量配置文件

**🎯 解决的问题**

```
问题场景举例：

场景1：部署100台服务器
❌ 没有变量：需要修改100个配置文件
✅ 使用变量：只需修改1个变量文件

场景2：测试环境vs生产环境
❌ 没有变量：需要维护两套完全不同的配置
✅ 使用变量：同一套模板，不同变量文件

场景3：敏感信息管理
❌ 没有加密：密码明文写在配置中
✅ 使用vault：密码加密存储，安全可靠
```

### 1.3 变量配置文件的分类


```
Ansible变量文件家族：

📁 inventory/
  📁 group_vars/          ← 组变量目录
    📄 all.yml           ← 全局变量（所有主机都能用）
    📄 webservers.yml    ← web服务器组专用变量
    📄 databases.yml     ← 数据库服务器组专用变量
  📁 host_vars/          ← 主机变量目录
    📄 web01.yml         ← web01服务器专用变量
    📄 db01.yml          ← db01服务器专用变量
    
📁 playbooks/
  📄 vars.yml            ← 剧本变量文件
  📄 vault.yml           ← 加密变量文件
```

---

## 2. 🌍 全局变量配置


### 2.1 group_vars/all.yml - 全局变量文件


**🔸 什么是全局变量**
全局变量就像是"通用设置"，所有服务器都能使用这些变量。就像公司的通用规定，每个部门都要遵守。

**📄 文件位置与作用**
```
文件路径：inventory/group_vars/all.yml
作用范围：所有主机（无论属于哪个组）
使用场景：通用配置、公共参数、环境标识
```

**💡 实际配置示例**
```yaml
# inventory/group_vars/all.yml

# 🌟 环境配置
environment: production
region: cn-north
datacenter: beijing

# 🔧 通用软件版本
common_packages:
  - vim
  - git
  - curl
  - wget

# 👤 通用用户配置
admin_user: ansible
admin_group: wheel

# 🌐 网络配置
dns_servers:
  - 8.8.8.8
  - 114.114.114.114

# ⏰ 时区设置
timezone: Asia/Shanghai

# 📁 通用目录配置
base_dirs:
  app_home: /opt/app
  log_dir: /var/log/app
  backup_dir: /backup

# 🔐 基础安全配置
security_settings:
  ssh_port: 22
  allow_root_login: no
  password_auth: no
```

### 2.2 全局变量的使用方法


**🎯 在剧本中使用全局变量**
```yaml
# deploy.yml
- name: 创建应用目录
  file:
    path: "{{ base_dirs.app_home }}"
    state: directory
    owner: "{{ admin_user }}"
    group: "{{ admin_group }}"

- name: 安装通用软件包
  yum:
    name: "{{ common_packages }}"
    state: present
```

**🔍 变量使用的关键点**
- 使用 `{{ 变量名 }}` 的格式调用变量
- 字典类型变量用 `{{ 字典名.键名 }}` 访问
- 列表类型变量可以直接在循环中使用

---

## 3. 👥 组变量配置


### 3.1 group_vars/组名.yml - 组专用变量


**🔸 什么是组变量**
组变量就像是"部门专用设置"，只有特定组（部门）的服务器才能使用。比如web服务器有web相关的配置，数据库服务器有数据库相关的配置。

**📊 组变量配置对比**

| 变量类型 | **作用范围** | **使用场景** | **配置文件** |
|----------|-------------|-------------|-------------|
| 全局变量 | 所有主机 | 通用配置、环境设置 | `group_vars/all.yml` |
| 组变量 | 特定组主机 | 角色专用配置 | `group_vars/组名.yml` |
| 主机变量 | 单个主机 | 个性化配置 | `host_vars/主机名.yml` |

### 3.2 Web服务器组变量示例


**📄 group_vars/webservers.yml**
```yaml
# Web服务器组专用配置

# 🌐 Nginx配置
nginx_config:
  version: "1.20.2"
  worker_processes: auto
  worker_connections: 1024
  keepalive_timeout: 65
  
  # 虚拟主机配置
  sites:
    - name: "example.com"
      port: 80
      root: "/var/www/example"
    - name: "api.example.com"  
      port: 8080
      root: "/var/www/api"

# 📁 Web专用目录
web_dirs:
  document_root: /var/www
  log_dir: /var/log/nginx
  config_dir: /etc/nginx

# 🔐 Web安全配置
web_security:
  firewall_ports:
    - 80
    - 443
    - 8080
  ssl_enabled: true
  ssl_protocols:
    - TLSv1.2
    - TLSv1.3

# 📦 Web相关软件包
web_packages:
  - nginx
  - php-fpm
  - redis
  - memcached
```

### 3.3 数据库服务器组变量示例


**📄 group_vars/databases.yml**
```yaml
# 数据库服务器组专用配置

# 🗃️ MySQL配置
mysql_config:
  version: "8.0"
  port: 3306
  max_connections: 200
  innodb_buffer_pool_size: "1G"
  
  # 数据库列表
  databases:
    - name: app_prod
      encoding: utf8mb4
    - name: app_test
      encoding: utf8mb4

# 📁 数据库专用目录
db_dirs:
  data_dir: /var/lib/mysql
  log_dir: /var/log/mysql
  backup_dir: /backup/mysql
  config_dir: /etc/mysql

# 🔒 数据库安全配置
db_security:
  firewall_ports:
    - 3306
  bind_address: "0.0.0.0"
  max_user_connections: 50

# 📦 数据库相关软件
db_packages:
  - mysql-server
  - mysql-client
  - python3-pymysql
```

### 3.4 组变量的继承与覆盖


**🔄 变量继承关系图**
```
变量继承优先级：

全局变量 (group_vars/all.yml)
    ↓
组变量 (group_vars/webservers.yml)  
    ↓
主机变量 (host_vars/web01.yml)
    ↓
剧本变量 (vars.yml)

高优先级会覆盖低优先级的同名变量
```

---

## 4. 🖥️ 主机变量配置


### 4.1 host_vars/主机名.yml - 主机专用变量


**🔸 什么是主机变量**
主机变量就像是"个人专属设置"，只对单个服务器生效。比如某台服务器需要特殊的内存设置，或者有特定的IP配置。

**🎯 主机变量使用场景**
```
典型使用场景：

✅ 服务器硬件差异：某台服务器内存更大，需要特殊配置
✅ 网络配置差异：不同服务器有不同的IP地址
✅ 角色差异：主从数据库配置不同
✅ 特殊需求：某台服务器需要安装额外软件
```

### 4.2 具体主机变量示例


**📄 host_vars/web01.yml**
```yaml
# web01服务器专用配置

# 🌐 网络配置
network_config:
  ip_address: 192.168.1.10
  netmask: 255.255.255.0
  gateway: 192.168.1.1
  hostname: web01.example.com

# 💾 硬件相关配置
hardware_config:
  cpu_cores: 4
  memory_gb: 8
  disk_space: 500
  
# ⚙️ 个性化配置
custom_config:
  # 这台服务器作为主Web服务器，需要更高的连接数
  nginx_worker_connections: 2048
  
  # 需要安装额外的监控工具
  extra_packages:
    - htop
    - iotop
    - netstat-nat
    
  # 特殊的日志轮转配置
  log_rotation:
    size: 100M
    rotate_count: 30
```

**📄 host_vars/db01.yml**
```yaml
# db01服务器（主数据库）专用配置

# 🌐 网络配置
network_config:
  ip_address: 192.168.1.20
  netmask: 255.255.255.0
  gateway: 192.168.1.1
  hostname: db01.example.com

# 🗃️ 数据库角色配置
database_role: master

# ⚙️ 主数据库专用配置
mysql_master_config:
  server_id: 1
  log_bin: mysql-bin
  binlog_format: ROW
  
  # 主数据库性能配置
  innodb_buffer_pool_size: "4G"
  innodb_log_file_size: "512M"
  max_connections: 500

# 🔐 复制用户配置
replication_config:
  replication_user: replicator
  allowed_hosts:
    - 192.168.1.21  # db02从库IP
    - 192.168.1.22  # db03从库IP
```

### 4.3 主机变量的优先级特点


**🔝 变量优先级实际应用**
```yaml
# 假设有以下变量定义：

# group_vars/all.yml
nginx_worker_processes: 2

# group_vars/webservers.yml  
nginx_worker_processes: 4

# host_vars/web01.yml
nginx_worker_processes: 8

# 最终web01服务器使用的值是：8
# 因为主机变量优先级最高
```

---

## 5. 📋 剧本变量文件


### 5.1 vars.yml - 剧本专用变量文件


**🔸 什么是剧本变量文件**
剧本变量文件就像是"项目配置文件"，专门为某个部署任务（剧本）服务。比如部署一个新应用时，这个应用相关的所有配置都放在剧本变量文件里。

**📁 剧本变量文件的组织方式**
```
项目结构示例：

📁 deploy-webapp/
  📄 site.yml              ← 主剧本文件
  📄 vars.yml              ← 剧本变量文件
  📁 roles/                ← 角色目录
  📁 templates/            ← 模板文件
  📁 files/               ← 静态文件
```

### 5.2 Web应用部署变量示例


**📄 vars.yml**
```yaml
# Web应用部署专用变量

# 🚀 应用基本信息
app_info:
  name: "mywebapp"
  version: "2.1.0"
  description: "企业级Web应用系统"
  
# 📦 部署配置
deployment:
  source_url: "https://github.com/company/mywebapp.git"
  branch: "release-2.1.0" 
  deploy_path: "/opt/webapp"
  
  # 部署前备份
  backup_enabled: true
  backup_path: "/backup/webapp"
  
# 🌐 应用运行配置
app_config:
  port: 8080
  workers: 4
  max_request_size: "10M"
  session_timeout: 1800
  
  # 数据库连接
  database:
    host: "{{ hostvars['db01']['network_config']['ip_address'] }}"
    port: 3306
    name: app_prod
    pool_size: 20
    
# 🔧 依赖服务配置
services:
  redis:
    host: 192.168.1.30
    port: 6379
    db: 0
    
  elasticsearch:
    hosts:
      - 192.168.1.40:9200
      - 192.168.1.41:9200
    index_prefix: "webapp"

# 📊 监控配置
monitoring:
  enabled: true
  metrics_port: 9090
  health_check_url: "/health"
  alert_email: "admin@example.com"
```

### 5.3 剧本中引用变量文件


**🎯 在主剧本中引用变量文件**
```yaml
# site.yml - 主剧本文件
---
- hosts: webservers
  vars_files:
    - vars.yml          # 引入剧本变量文件
    - vault.yml         # 引入加密变量文件（如果有）
  
  tasks:
    - name: 创建应用目录
      file:
        path: "{{ deployment.deploy_path }}"
        state: directory
        owner: "{{ admin_user }}"
        mode: '0755'
        
    - name: 克隆应用代码
      git:
        repo: "{{ deployment.source_url }}"
        dest: "{{ deployment.deploy_path }}"
        version: "{{ deployment.branch }}"
        
    - name: 配置应用端口
      template:
        src: app_config.j2
        dest: "{{ deployment.deploy_path }}/config/app.conf"
      notify: restart webapp
```

---

## 6. 🔐 加密变量配置


### 6.1 vault.yml - 加密变量文件


**🔸 什么是Ansible Vault**
Ansible Vault就像是一个"保险箱"，专门用来存放敏感信息，比如密码、密钥、证书等。这些信息会被加密，即使别人拿到文件也看不到真实内容。

**⚠️ 为什么需要加密变量**
```
安全风险对比：

❌ 不加密的问题：
- 密码明文存储在Git仓库中
- 任何能访问代码的人都能看到密码
- 容易发生密码泄露事故

✅ 使用加密的好处：
- 密码经过加密，看到的是乱码
- 只有知道解密密码的人才能使用
- 代码仓库更加安全
```

### 6.2 创建和管理加密文件


**🔧 Vault文件的基本操作**
```bash
# 创建新的加密文件
ansible-vault create vault.yml

# 编辑加密文件  
ansible-vault edit vault.yml

# 查看加密文件内容（不修改）
ansible-vault view vault.yml

# 更改加密密码
ansible-vault rekey vault.yml

# 解密文件（变成普通文件）
ansible-vault decrypt vault.yml

# 加密现有文件
ansible-vault encrypt existing_file.yml
```

### 6.3 加密变量文件内容示例


**📄 vault.yml（加密前的内容）**
```yaml
# 敏感信息变量（这些会被加密存储）

# 🔑 数据库认证信息
database_credentials:
  root_password: "SuperSecret123!"
  app_user: "webapp_user"
  app_password: "WebApp@2023"
  replication_password: "Repl1c@tion2023"

# 🌐 API认证密钥
api_credentials:
  jwt_secret: "my-super-secret-jwt-key-2023"
  encryption_key: "32-char-encryption-key-here!"
  third_party_api_key: "sk-1234567890abcdef"

# 📧 邮件服务配置
email_config:
  smtp_user: "noreply@company.com"
  smtp_password: "SmtpPass2023!"
  
# ☁️ 云服务凭据
cloud_credentials:
  aws_access_key: "AKIAI44QH8DHBEXAMPLE"
  aws_secret_key: "je7MtGbClwBF/2Zp9Utk/h3yCo8nvbEXAMPLEKEY"
  
# 🔐 SSL证书密码
ssl_config:
  private_key_password: "SslKey2023!"
  certificate_password: "CertPass2023!"
```

### 6.4 使用加密变量


**🎯 在剧本中使用加密变量**
```yaml
# deploy.yml
---
- hosts: databases
  vars_files:
    - vars.yml          # 普通变量文件
    - vault.yml         # 加密变量文件
  
  tasks:
    - name: 创建MySQL数据库
      mysql_db:
        name: "{{ app_config.database.name }}"
        state: present
        login_user: root
        login_password: "{{ database_credentials.root_password }}"
        
    - name: 创建应用数据库用户
      mysql_user:
        name: "{{ database_credentials.app_user }}"
        password: "{{ database_credentials.app_password }}"
        host: "%"
        priv: "{{ app_config.database.name }}.*:ALL"
        state: present
```

**🔑 运行使用加密文件的剧本**
```bash
# 运行时需要提供Vault密码
ansible-playbook deploy.yml --ask-vault-pass

# 或者使用密码文件
ansible-playbook deploy.yml --vault-password-file vault_pass.txt

# 或者使用环境变量
export ANSIBLE_VAULT_PASSWORD_FILE=vault_pass.txt
ansible-playbook deploy.yml
```

---

## 7. ⚡ 运行时变量


### 7.1 extra_vars - 额外变量


**🔸 什么是额外变量**
额外变量就像是"临时参数"，在运行剧本时临时传入，不需要写在配置文件里。比如临时指定一个版本号、临时修改某个配置。

**🎯 extra_vars的使用场景**
```
适用场景：

✅ 临时覆盖配置：测试时临时改个参数
✅ 环境切换：同一个剧本在不同环境使用
✅ 版本控制：部署时指定软件版本
✅ 调试模式：临时开启调试信息
```

### 7.2 extra_vars使用方法


**💻 命令行传递方式**
```bash
# 方式1：直接在命令行传递单个变量
ansible-playbook deploy.yml -e "app_version=2.1.0"

# 方式2：传递多个变量
ansible-playbook deploy.yml -e "app_version=2.1.0 environment=staging"

# 方式3：传递复杂数据结构
ansible-playbook deploy.yml -e '{"database":{"host":"192.168.1.25","port":3306}}'

# 方式4：从文件读取额外变量
ansible-playbook deploy.yml -e "@extra_vars.yml"
```

**📄 额外变量文件示例**
```yaml
# extra_vars.yml
environment: staging
app_version: "2.1.0-beta"
debug_mode: true

database_override:
  host: 192.168.1.100
  port: 3307
  
deployment_options:
  skip_backup: true
  fast_deploy: true
```

### 7.3 运行时变量的优先级


**🔝 变量优先级完整链条**
```
变量优先级（从低到高）：

1. group_vars/all.yml           ← 全局变量（最低）
2. group_vars/组名.yml          ← 组变量
3. host_vars/主机名.yml         ← 主机变量  
4. vars.yml（剧本变量文件）      ← 剧本变量
5. vars（剧本内定义）           ← 剧本内变量
6. extra_vars                   ← 额外变量（最高）

高优先级变量会覆盖低优先级的同名变量
```

**💡 实际应用示例**
```yaml
# 假设各层级都定义了app_version变量：

# group_vars/all.yml
app_version: "1.0.0"

# vars.yml  
app_version: "2.0.0"

# 命令行执行
ansible-playbook deploy.yml -e "app_version=3.0.0"

# 最终使用的版本是：3.0.0（extra_vars优先级最高）
```

---

## 8. 🔍 系统内置变量


### 8.1 ansible_facts - 系统事实变量


**🔸 什么是事实变量**
事实变量就像是"身份证信息"，Ansible自动收集每台服务器的详细信息，比如操作系统、IP地址、硬件配置等，这些信息都存储在事实变量中。

**📊 事实变量的分类**
```
系统事实变量分类：

🖥️  硬件信息：CPU、内存、磁盘
🌐  网络信息：IP地址、网卡、路由
💿  系统信息：操作系统、内核版本
📁  文件系统：挂载点、磁盘使用情况
🔧  服务信息：运行的服务、端口占用
```

### 8.2 常用事实变量示例


**💻 硬件相关事实变量**
```yaml
# 在剧本中使用事实变量
- name: 显示系统信息
  debug:
    msg: |
      服务器: {{ ansible_hostname }}
      操作系统: {{ ansible_distribution }} {{ ansible_distribution_version }}
      CPU核心数: {{ ansible_processor_cores }}
      内存大小: {{ ansible_memtotal_mb }}MB
      IP地址: {{ ansible_default_ipv4.address }}
      
# 根据硬件配置动态调整参数
- name: 根据内存大小设置Java堆内存
  template:
    src: java_opts.j2
    dest: /opt/app/java_opts
  vars:
    # 内存大于8GB时，堆内存设置为4GB
    heap_size: "{{ '4g' if ansible_memtotal_mb > 8192 else '2g' }}"
```

**🌐 网络相关事实变量**
```yaml
# 网络配置相关的事实变量
- name: 配置防火墙规则
  firewalld:
    source: "{{ item }}"
    zone: trusted
    permanent: yes
    state: enabled
  loop: "{{ ansible_all_ipv4_addresses }}"
  
- name: 显示网络接口信息
  debug:
    msg: |
      网卡名称: {{ ansible_default_ipv4.interface }}
      IP地址: {{ ansible_default_ipv4.address }}
      网关: {{ ansible_default_ipv4.gateway }}
      子网掩码: {{ ansible_default_ipv4.netmask }}
```

### 8.3 hostvars - 主机变量集合


**🔸 什么是hostvars**
hostvars就像是"通讯录"，里面包含了所有主机的变量信息。你可以通过它获取其他服务器的配置信息，实现服务器间的协调配置。

**🎯 hostvars的典型应用**
```yaml
# 配置Web服务器连接数据库服务器
- name: 配置应用数据库连接
  template:
    src: database.conf.j2
    dest: /opt/app/config/database.conf
  vars:
    # 获取数据库服务器的IP地址
    db_host: "{{ hostvars['db01']['ansible_default_ipv4']['address'] }}"
    db_port: "{{ hostvars['db01']['mysql_config']['port'] }}"

# 生成所有Web服务器的负载均衡配置
- name: 配置负载均衡
  template:
    src: nginx_upstream.j2  
    dest: /etc/nginx/conf.d/upstream.conf
  vars:
    web_servers: |
      {% for host in groups['webservers'] %}
      server {{ hostvars[host]['ansible_default_ipv4']['address'] }}:80;
      {% endfor %}
```

### 8.4 groupvars - 组变量集合


**🔸 什么是groupvars**
groupvars就像是"部门花名册"，包含了各个组的变量信息。可以用来获取整个组的配置，实现跨组的协调配置。

**💡 groupvars使用示例**
```yaml
# 为监控系统配置所有服务器组信息
- name: 生成监控配置
  template:
    src: monitoring.conf.j2
    dest: /etc/monitoring/servers.conf
  vars:
    # 获取所有组的服务器列表
    server_groups: |
      {% for group_name in groups %}
      [{{ group_name }}]
      {% for host in groups[group_name] %}
      {{ host }} {{ hostvars[host]['ansible_default_ipv4']['address'] }}
      {% endfor %}
      {% endfor %}
```

---

## 9. 📏 变量优先级规则


### 9.1 完整的变量优先级链


**🔝 从低到高的完整优先级顺序**
```
变量优先级完整排序：

1.  inventory文件中的组变量 [all]                    ← 最低优先级
2.  inventory文件中的组变量 [其他组]
3.  inventory/group_vars/all.yml
4.  inventory/group_vars/组名.yml  
5.  inventory文件中的主机变量
6.  inventory/host_vars/主机名.yml
7.  playbook中的组变量 [all]
8.  playbook中的组变量 [其他组]
9.  playbook中的主机变量
10. host_facts（主机事实变量）
11. play vars（剧本变量）
12. play vars_prompt（交互式变量）
13. play vars_files（变量文件）
14. role vars（角色变量）
15. include_vars（包含的变量）
16. set_facts（设置的事实变量）
17. register（注册变量）
18. extra_vars                                      ← 最高优先级
```

### 9.2 变量优先级实战理解


**🎯 实际场景下的优先级应用**
```yaml
# 假设在不同层级定义了nginx_port变量：

# 1. group_vars/all.yml
nginx_port: 80

# 2. group_vars/webservers.yml
nginx_port: 8080

# 3. host_vars/web01.yml  
nginx_port: 8090

# 4. playbook中的vars
- hosts: webservers
  vars:
    nginx_port: 9090
  
# 5. 命令行extra_vars
ansible-playbook site.yml -e "nginx_port=9999"

# 最终web01服务器使用的端口：9999
# 因为extra_vars优先级最高
```

### 9.3 优先级规则的实用建议


**💡 变量定义的最佳实践**
```
变量定义策略：

🔸 通用配置 → group_vars/all.yml
  例：时区、DNS、通用软件包

🔸 角色配置 → group_vars/角色名.yml  
  例：web服务器、数据库服务器的专用配置

🔸 个性化配置 → host_vars/主机名.yml
  例：特定服务器的IP、硬件配置

🔸 项目配置 → vars.yml
  例：应用版本、部署路径

🔸 敏感信息 → vault.yml
  例：密码、密钥、证书

🔸 临时配置 → extra_vars
  例：测试参数、调试开关
```

---

## 10. 🔄 动态变量操作


### 10.1 register - 注册变量


**🔸 什么是注册变量**
注册变量就像是"执行结果的记录本"，可以把命令或任务的执行结果保存起来，供后续任务使用。比如查询数据库状态、检查文件是否存在等。

**🎯 register的典型使用场景**
```
常用场景：

✅ 检查服务状态：查看服务是否运行，决定是否需要启动
✅ 文件存在性检查：检查配置文件是否存在，决定是否需要创建
✅ 命令执行结果：获取命令输出，用于后续逻辑判断
✅ 获取系统信息：查询系统状态，动态调整配置
```

**💡 register使用示例**
```yaml
# 检查服务状态
- name: 检查Nginx服务状态
  systemd:
    name: nginx
  register: nginx_status
  
- name: 显示服务状态
  debug:
    msg: "Nginx状态: {{ nginx_status.status.ActiveState }}"
    
- name: 如果服务未运行则启动
  systemd:
    name: nginx
    state: started
  when: nginx_status.status.ActiveState != "active"

# 检查文件存在性
- name: 检查配置文件是否存在
  stat:
    path: /etc/app/config.yml
  register: config_file
  
- name: 创建配置文件（如果不存在）
  template:
    src: config.yml.j2
    dest: /etc/app/config.yml
  when: not config_file.stat.exists

# 获取命令执行结果  
- name: 获取磁盘使用情况
  shell: df -h /opt | tail -1 | awk '{print $5}' | sed 's/%//'
  register: disk_usage
  
- name: 检查磁盘空间
  fail:
    msg: "磁盘空间不足，当前使用: {{ disk_usage.stdout }}%"
  when: disk_usage.stdout|int > 90
```

### 10.2 set_fact - 设置事实变量


**🔸 什么是set_fact**
set_fact就像是"动态计算器"，可以在剧本运行过程中动态计算和设置变量。这些变量会变成该主机的"事实"，可以被后续任务和其他主机使用。

**🔧 set_fact的应用示例**
```yaml
# 动态计算配置参数
- name: 根据内存大小计算Java堆内存
  set_fact:
    java_heap_size: "{{ (ansible_memtotal_mb * 0.7) | int }}m"
    java_perm_size: "{{ (ansible_memtotal_mb * 0.1) | int }}m"
    
- name: 显示计算结果
  debug:
    msg: |
      系统内存: {{ ansible_memtotal_mb }}MB
      Java堆内存: {{ java_heap_size }}
      永久代内存: {{ java_perm_size }}

# 组合复杂的配置信息      
- name: 构建数据库连接URL
  set_fact:
    database_url: "jdbc:mysql://{{ hostvars['db01']['ansible_default_ipv4']['address'] }}:{{ mysql_config.port }}/{{ app_config.database.name }}?useSSL=true&charset=utf8mb4"
    
- name: 生成应用配置
  template:
    src: application.properties.j2
    dest: /opt/app/config/application.properties
  vars:
    db_connection: "{{ database_url }}"

# 条件性设置变量
- name: 根据环境设置调试模式
  set_fact:
    debug_enabled: "{{ true if environment == 'development' else false }}"
    log_level: "{{ 'DEBUG' if environment == 'development' else 'INFO' }}"
    
# 构建复杂的数据结构
- name: 构建服务器集群信息
  set_fact:
    cluster_info:
      web_servers: |
        {% set servers = [] %}
        {% for host in groups['webservers'] %}
        {% set _ = servers.append({
          'name': host,
          'ip': hostvars[host]['ansible_default_ipv4']['address'],
          'port': hostvars[host].get('nginx_port', 80)
        }) %}
        {% endfor %}
        {{ servers }}
      database_servers: |
        {% set servers = [] %}
        {% for host in groups['databases'] %}
        {% set _ = servers.append({
          'name': host,
          'ip': hostvars[host]['ansible_default_ipv4']['address'],
          'role': hostvars[host].get('database_role', 'slave')
        }) %}
        {% endfor %}
        {{ servers }}
```

### 10.3 magic_variables - 魔法变量


**🔸 什么是魔法变量**
魔法变量就像是"系统内置的万能工具"，Ansible自动提供的特殊变量，包含了关于清单、组、主机等的各种信息。

**🎯 常用魔法变量列表**

| 变量名 | **含义** | **示例用法** |
|--------|----------|-------------|
| `inventory_hostname` | 当前主机在清单中的名称 | `{{ inventory_hostname }}` |
| `ansible_hostname` | 主机的实际主机名 | `{{ ansible_hostname }}` |
| `groups` | 所有组的信息 | `{{ groups['webservers'] }}` |
| `group_names` | 当前主机所属的组列表 | `{{ group_names }}` |
| `hostvars` | 所有主机的变量 | `{{ hostvars['web01']['ansible_ip'] }}` |
| `ansible_play_hosts` | 当前剧本涉及的主机列表 | `{{ ansible_play_hosts }}` |
| `ansible_version` | Ansible版本信息 | `{{ ansible_version.full }}` |

**💡 魔法变量使用示例**
```yaml
# 显示主机基本信息
- name: 显示主机信息
  debug:
    msg: |
      清单中的主机名: {{ inventory_hostname }}
      实际主机名: {{ ansible_hostname }}
      所属组: {{ group_names | join(', ') }}
      IP地址: {{ ansible_default_ipv4.address }}
      
# 生成集群配置文件
- name: 生成集群节点配置
  template:
    src: cluster.conf.j2
    dest: /etc/app/cluster.conf
  vars:
    cluster_nodes: |
      {% for host in groups['webservers'] %}
      {{ host }}={{ hostvars[host]['ansible_default_ipv4']['address'] }}:8080
      {% endfor %}
      
# 条件执行（仅在特定组的主机上执行）
- name: 配置负载均衡器
  template:
    src: haproxy.cfg.j2
    dest: /etc/haproxy/haproxy.cfg
  when: "'loadbalancers' in group_names"
```

---

## 11. 📋 核心要点总结


### 11.1 必须掌握的核心概念


**🔸 变量配置文件体系**
```
Ansible变量文件的"五大金刚"：

1. group_vars/all.yml     ← 全局通用变量
2. group_vars/组名.yml    ← 组专用变量  
3. host_vars/主机名.yml   ← 主机专用变量
4. vars.yml              ← 剧本项目变量
5. vault.yml             ← 加密敏感变量
```

**🔸 变量优先级记忆法**
```
优先级记忆口诀："命令行最大，主机胜过组，组胜过全局"

extra_vars (命令行)     ← 最高优先级
    ↓
host_vars (主机变量)    ← 个性化配置
    ↓  
group_vars (组变量)     ← 角色专用配置
    ↓
group_vars/all (全局)   ← 通用基础配置
```

### 11.2 关键理解要点


**🔹 什么时候用什么变量文件**
```
变量文件选择指南：

🌍 所有服务器都需要的配置 → group_vars/all.yml
   例：时区、DNS、基础软件包

👥 特定角色服务器的配置 → group_vars/角色名.yml
   例：Web服务器配置、数据库配置

🖥️ 单个服务器的特殊配置 → host_vars/主机名.yml  
   例：IP地址、硬件相关配置

📋 项目部署的专用配置 → vars.yml
   例：应用版本、部署路径

🔐 密码密钥等敏感信息 → vault.yml
   例：数据库密码、API密钥
```

**🔹 变量安全使用原则**
```
安全使用三原则：

1. 敏感信息必须加密：密码、密钥 → vault.yml
2. 普通配置分层管理：全局 → 组 → 主机
3. 临时调试用命令行：-e 参数传递临时变量
```

### 11.3 实际应用最佳实践


**🎯 变量文件组织最佳实践**
```yaml
# 📁 推荐的目录结构
inventory/
  📄 hosts                    # 主机清单
  📁 group_vars/
    📄 all.yml               # 全局变量：时区、DNS、基础包
    📄 webservers.yml        # Web服务器：Nginx、PHP配置  
    📄 databases.yml         # 数据库服务器：MySQL配置
  📁 host_vars/
    📄 web01.yml             # web01专用：IP、硬件配置
    📄 db01.yml              # db01专用：主从角色配置
    
playbooks/
  📄 site.yml                # 主剧本文件
  📄 vars.yml                # 项目变量：应用配置
  📄 vault.yml               # 敏感变量：密码、密钥
```

**🔧 变量命名规范建议**
```yaml
# ✅ 好的变量命名（清晰明确）
nginx_version: "1.20.2"
database_root_password: "{{ vault_db_root_password }}"
app_deployment_path: "/opt/webapp"

# ❌ 不好的变量命名（含糊不清）
ver: "1.20.2"
pwd: "secret123"
path: "/opt/webapp"

# 🎯 推荐的命名规则：
# 1. 使用下划线分隔单词
# 2. 名称要能表达具体含义
# 3. 敏感变量加vault_前缀
# 4. 相关变量使用统一前缀
```

### 11.4 常见问题和解决方案


**⚠️ 变量问题诊断检查清单**
```
变量问题排查步骤：

☐ 检查变量名是否正确（区分大小写）
☐ 检查文件路径是否正确
☐ 检查YAML语法是否正确（缩进、冒号）  
☐ 检查变量优先级是否被覆盖
☐ 检查vault文件是否需要解密
☐ 检查inventory中的主机名是否匹配
☐ 使用ansible all -m setup查看事实变量
☐ 使用debug模块打印变量值进行调试
```

**💡 实用调试技巧**
```yaml
# 调试变量值
- name: 调试变量信息
  debug:
    msg: |
      当前主机: {{ inventory_hostname }}
      变量值: {{ 变量名 }}
      变量类型: {{ 变量名 | type_debug }}
      
# 查看所有变量
- name: 显示所有主机变量
  debug:
    var: hostvars[inventory_hostname]
    
# 条件调试
- name: 仅在调试模式显示
  debug:
    var: sensitive_variable
  when: debug_mode | default(false)
```

**核心记忆要点**：
- 变量文件分五类：全局、组、主机、剧本、加密
- 优先级记住：命令行 > 主机 > 组 > 全局
- 敏感信息必须用vault加密存储
- 变量命名要清晰，便于维护和理解
- 遇到问题先检查语法，再查看优先级