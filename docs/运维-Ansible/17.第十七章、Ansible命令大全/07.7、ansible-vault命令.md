---
title: 7、ansible-vault命令
---
## 📚 目录

1. [ansible-vault核心概念](#1-ansible-vault核心概念)
2. [文件加密解密操作](#2-文件加密解密操作)
3. [字符串加密与管理](#3-字符串加密与管理)
4. [密码管理策略](#4-密码管理策略)
5. [多重vault密码管理](#5-多重vault密码管理)
6. [实际应用场景](#6-实际应用场景)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 🔐 ansible-vault核心概念


### 1.1 什么是ansible-vault


**🎯 核心定义**
```
ansible-vault：Ansible内置的加密工具
作用：保护敏感数据，如密码、密钥、配置信息
原理：使用AES256加密算法，基于用户提供的密码
目标：确保敏感信息在代码仓库中的安全性
```

**💡 为什么需要vault**

日常运维中，我们经常遇到这样的问题：

```
问题场景：
× 数据库密码直接写在playbook里
× API密钥明文存储在变量文件中  
× 服务器登录凭证暴露在版本控制中

安全风险：
• 代码泄露 = 密码泄露
• 团队成员都能看到敏感信息
• 版本历史中留下敏感数据痕迹
```

**✅ vault解决方案**
- **加密存储**：敏感数据以密文形式保存
- **透明使用**：Ansible运行时自动解密
- **版本安全**：加密文件可以安全提交到git
- **权限控制**：只有知道vault密码的人才能解密

### 1.2 vault工作原理


**🔧 加密流程图**
```
原始敏感数据    vault密码    加密算法
     ↓             ↓           ↓
   db_password  + mysecret  →  AES256  →  加密文件
   "admin123"                              $ANSIBLE_VAULT;1.1;AES256
                                          66386439643...
```

**📊 使用流程对比**

| **传统方式** | **使用vault后** |
|------------|-----------------|
| `db_pass: admin123` | `db_pass: !vault 66386439...` |
| 明文存储，高风险 | 密文存储，安全可控 |
| 代码即密码泄露 | 需要vault密码才能解密 |

---

## 2. 📁 文件加密解密操作


### 2.1 创建加密文件 - create


**🎯 基本用法**
```bash
ansible-vault create secrets.yml
```

**操作演示：**
```
① 执行命令后，系统提示输入vault密码
② 密码确认后，打开默认编辑器
③ 编辑敏感信息内容
④ 保存退出，文件自动加密存储
```

**💻 实际操作示例**
```bash
# 创建数据库配置文件
ansible-vault create database_config.yml

# 系统提示：New Vault password: 
# 输入：mysecretpass
# Confirm New Vault password: 
# 再次输入：mysecretpass

# 编辑器中输入：
database:
  host: db.example.com
  username: admin
  password: super_secret_123
  port: 5432
```

**📋 文件内容展示**

保存后的 `database_config.yml` 内容：
```
$ANSIBLE_VAULT;1.1;AES256
66386439653834336464616266613661653563663566663037366139306566373...
33623337396662363931626464393964323837373834393832386232623066393...
```

> 💡 **新手提示**：加密后的文件看起来像乱码，这是正常的！这就是AES256加密的效果。

### 2.2 编辑加密文件 - edit


**🎯 基本用法**
```bash
ansible-vault edit secrets.yml
```

**使用场景：**
- ✅ 修改已加密文件的内容
- ✅ 添加新的敏感配置项
- ✅ 更新过期的密码信息

**操作流程：**
```
①️ 输入vault密码验证身份
②️ 临时解密文件内容到编辑器
③️ 修改完成后保存退出
④️ 自动重新加密保存
```

### 2.3 加密现有文件 - encrypt


**🎯 基本用法**
```bash
ansible-vault encrypt existing_config.yml
```

**应用场景：**

假设你已经有一个明文配置文件：

*config.yml (加密前)*
```yaml
api_keys:
  github: ghp_xxxxxxxxxxxx
  aws: AKIAXXXXXXXXXXXXXXXX
  
database:
  password: my_db_password
```

执行加密命令：
```bash
ansible-vault encrypt config.yml
# New Vault password: [输入密码]
# Confirm New Vault password: [确认密码]  
# Encryption successful
```

**批量加密多个文件：**
```bash
ansible-vault encrypt file1.yml file2.yml file3.yml
```

### 2.4 解密文件 - decrypt  


**🎯 基本用法**
```bash
ansible-vault decrypt secrets.yml
```

**⚠️ 使用注意**

```
解密操作会将文件变为明文！
使用场景：
✅ 临时查看文件内容
✅ 迁移到其他加密方案
❌ 不建议长期保持解密状态
```

**安全建议：**
- 查看完毕后立即重新加密
- 避免在共享环境中解密文件
- 确保解密文件不会被意外提交

### 2.5 查看加密文件 - view


**🎯 基本用法**
```bash
ansible-vault view secrets.yml
```

**💡 最佳实践**

`view` 是最安全的查看方式：
- ✅ 临时解密显示，不修改原文件
- ✅ 只读模式，避免误操作
- ✅ 查看后自动"重新加密"状态

**对比说明：**

| 命令 | 安全性 | 用途 |
|-----|-------|------|
| `decrypt` | ⚠️ 文件变明文 | 需要长期编辑 |
| `view` | ✅ 临时查看 | 快速查看内容 |
| `edit` | ✅ 安全编辑 | 修改内容 |

---

## 3. 🔤 字符串加密与管理


### 3.1 加密单个字符串 - encrypt_string


**🎯 核心概念**

有时候我们不需要加密整个文件，只需要加密文件中的某些敏感字段。`encrypt_string` 就是专门做这件事的。

**基本用法：**
```bash
ansible-vault encrypt_string 'my_secret_password' --name 'db_password'
```

**实际操作演示：**
```bash
# 加密数据库密码
ansible-vault encrypt_string 'admin123' --name 'database_password'

输出结果：
database_password: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      66386439653834336464616266613661653563663...
      33623337396662363931626464393964323837373...
```

### 3.2 字符串加密的实际应用


**📋 在playbook中使用**

*vars/secrets.yml*
```yaml
# 混合使用明文和密文
server_config:
  hostname: web01.example.com  # 明文，非敏感信息
  database_url: !vault |      # 密文，敏感信息
        $ANSIBLE_VAULT;1.1;AES256
        66386439653834336464616266613661...
  
  api_token: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        33623337396662363931626464393964...
```

**💡 优势对比**

| 方式 | 优势 | 劣势 |
|-----|------|------|
| **整文件加密** | 管理简单 | 无法部分共享 |
| **字符串加密** | 灵活精确 | 文件结构复杂 |

### 3.3 交互式字符串加密


**无参数方式：**
```bash
ansible-vault encrypt_string
```

系统会提示：
```
Reading plaintext input from stdin...
输入要加密的内容：my_database_password
按 Ctrl+D 结束输入

!vault |
      $ANSIBLE_VAULT;1.1;AES256
      66386439653834336464616...
```

**📝 实用技巧**

①️ **管道输入**
```bash
echo "secret_value" | ansible-vault encrypt_string --stdin-name 'my_var'
```

②️ **从文件读取**
```bash
cat secret.txt | ansible-vault encrypt_string --stdin-name 'file_content'
```

---

## 4. 🔑 密码管理策略


### 4.1 密码输入方式


**方式对比一览表：**

| 方式 | 命令示例 | 安全性 | 便利性 | 适用场景 |
|-----|---------|-------|-------|---------|
| **交互输入** | `--ask-vault-pass` | 🟢 高 | 🟡 中等 | 手动操作 |
| **密码文件** | `--vault-password-file` | 🟡 中等 | 🟢 高 | 自动化脚本 |
| **环境变量** | `ANSIBLE_VAULT_PASSWORD` | 🟡 中等 | 🟢 高 | CI/CD流水线 |

### 4.2 交互式密码输入


**🎯 使用方式**
```bash
ansible-vault view secrets.yml --ask-vault-pass
```

**操作流程：**
```
执行命令 → 提示输入密码 → 验证通过 → 显示内容

Vault password: [输入密码，不显示]
[解密内容显示]
```

**适用场景：**
- ✅ 开发环境手动操作
- ✅ 一次性查看文件
- ❌ 自动化脚本中不适用

### 4.3 密码文件管理


**🔧 创建密码文件**
```bash
# 创建密码文件
echo "my_vault_password" > ~/.vault_pass

# 设置权限（重要！）
chmod 600 ~/.vault_pass
```

**使用密码文件：**
```bash
ansible-vault edit secrets.yml --vault-password-file ~/.vault_pass
```

**🛡️ 安全注意事项**

| ⚠️ 安全风险 | ✅ 防护措施 |
|------------|------------|
| 密码文件权限过宽 | `chmod 600` 仅所有者可读 |
| 意外提交到git | 加入 `.gitignore` |
| 多人共享密码 | 使用不同的vault-id |

**.gitignore 示例：**
```
# 忽略vault密码文件
.vault_pass
*.vault_pass
vault_passwords/
```

### 4.4 环境变量方式


**设置环境变量：**
```bash
export ANSIBLE_VAULT_PASSWORD=my_secret_password
```

**自动生效：**
```bash
# 无需额外参数，自动使用环境变量中的密码
ansible-vault view secrets.yml
```

**🐳 Docker容器中使用：**
```bash
docker run -e ANSIBLE_VAULT_PASSWORD=mysecret \
    ansible/ansible:latest \
    ansible-vault view /playbooks/secrets.yml
```

### 4.5 更改vault密码 - rekey


**🎯 基本用法**
```bash
ansible-vault rekey secrets.yml
```

**操作流程：**
```
Old Vault password: [输入旧密码]
New Vault password: [输入新密码]  
Confirm New Vault password: [确认新密码]
Rekey successful
```

**批量更改密码：**
```bash
ansible-vault rekey file1.yml file2.yml file3.yml
```

---

## 5. 🏷️ 多重vault密码管理


### 5.1 vault-id概念详解


**🎯 核心理念**

在大型项目中，不同环境、不同团队可能需要不同的vault密码：

```
项目结构示例：
├── vars/
│   ├── prod_secrets.yml      # 生产环境密码(生产团队)
│   ├── dev_secrets.yml       # 开发环境密码(开发团队) 
│   └── shared_config.yml     # 共享配置(所有人)
```

**传统问题：**
- 所有加密文件使用同一密码
- 权限控制粒度粗糙
- 密码泄露影响范围大

**vault-id解决方案：**
```
不同文件使用不同的vault-id标识
每个vault-id对应独立的密码
实现精细化的权限控制
```

### 5.2 创建带vault-id的加密文件


**🔧 基本语法**
```bash
ansible-vault create --vault-id label@source filename
```

**实际示例：**
```bash
# 创建生产环境配置（使用prod标识）
ansible-vault create --vault-id prod@prompt prod_secrets.yml

# 创建开发环境配置（使用dev标识）  
ansible-vault create --vault-id dev@prompt dev_secrets.yml

# 使用密码文件
ansible-vault create --vault-id prod@prod.vault prod_db.yml
```

**📁 密码文件组织**
```
project/
├── vault_passwords/
│   ├── prod.vault          # 生产环境密码
│   ├── dev.vault           # 开发环境密码
│   └── shared.vault        # 共享密码
├── vars/
│   ├── prod_secrets.yml    # @prod加密
│   ├── dev_secrets.yml     # @dev加密
│   └── shared.yml          # @shared加密
```

### 5.3 多密码文件的使用


**查看不同vault-id的文件：**
```bash
# 查看生产环境配置
ansible-vault view --vault-id prod@prod.vault prod_secrets.yml

# 查看开发环境配置  
ansible-vault view --vault-id dev@dev.vault dev_secrets.yml
```

**🔄 同时使用多个vault-id**
```bash
# playbook运行时指定多个密码源
ansible-playbook deploy.yml \
  --vault-id prod@prod.vault \
  --vault-id dev@dev.vault \
  --vault-id shared@shared.vault
```

### 5.4 vault-id实际应用场景


**🏢 企业环境示例**

```
场景：电商公司的多环境部署

开发环境 (dev@...)：
- 开发团队可访问
- 测试数据库密码
- 第三方测试API密钥

预发环境 (staging@...)：
- QA团队 + 开发负责人
- 仿生产数据库
- 生产API的测试版本

生产环境 (prod@...)：
- 运维团队 + 架构师
- 生产数据库密码
- 正式API密钥和证书
```

**权限矩阵：**

| 角色 | dev | staging | prod |
|-----|-----|---------|------|
| 开发工程师 | ✅ | ❌ | ❌ |
| QA工程师 | ✅ | ✅ | ❌ |
| 运维工程师 | ✅ | ✅ | ✅ |
| 架构师 | ✅ | ✅ | ✅ |

---

## 6. 🚀 实际应用场景


### 6.1 Web应用部署场景


**📋 项目结构**
```
web_deploy/
├── playbooks/
│   └── deploy_webapp.yml
├── vars/
│   ├── common.yml              # 公开配置
│   ├── database_secrets.yml    # 数据库密码
│   └── api_keys.yml           # API密钥
└── vault_passwords/
    ├── db.vault               # 数据库密码文件
    └── api.vault              # API密码文件
```

**database_secrets.yml 内容：**
```yaml
# 使用字符串加密
mysql_config:
  host: db.internal.com
  port: 3306
  username: webapp_user
  password: !vault |
    $ANSIBLE_VAULT;1.1;AES256
    66386439653834336464616266613661...
  
redis_config:  
  host: cache.internal.com
  port: 6379
  password: !vault |
    $ANSIBLE_VAULT;1.1;AES256
    33623337396662363931626464393964...
```

**运行playbook：**
```bash
ansible-playbook playbooks/deploy_webapp.yml \
  --vault-id db@vault_passwords/db.vault \
  --vault-id api@vault_passwords/api.vault
```

### 6.2 多环境CI/CD集成


**🔧 Jenkins Pipeline示例**

```groovy
pipeline {
    agent any
    
    environment {
        // 从Jenkins凭据获取vault密码
        VAULT_PASS_DEV = credentials('ansible-vault-dev')
        VAULT_PASS_PROD = credentials('ansible-vault-prod')
    }
    
    stages {
        stage('Deploy to Dev') {
            steps {
                sh '''
                    echo $VAULT_PASS_DEV > .vault_dev
                    chmod 600 .vault_dev
                    ansible-playbook deploy.yml \
                        -i inventories/dev \
                        --vault-password-file .vault_dev
                '''
            }
        }
        
        stage('Deploy to Prod') {
            when { branch 'main' }
            steps {
                sh '''
                    echo $VAULT_PASS_PROD > .vault_prod  
                    chmod 600 .vault_prod
                    ansible-playbook deploy.yml \
                        -i inventories/prod \
                        --vault-password-file .vault_prod
                '''
            }
        }
    }
    
    post {
        always {
            // 清理密码文件
            sh 'rm -f .vault_*'
        }
    }
}
```

### 6.3 容器化环境中的使用


**🐳 Docker Compose示例**

*docker-compose.yml*
```yaml
version: '3.8'
services:
  ansible-runner:
    image: ansible/ansible-runner:latest
    environment:
      - ANSIBLE_VAULT_PASSWORD_FILE=/run/secrets/vault_password
    secrets:
      - vault_password
    volumes:
      - ./playbooks:/runner/playbooks
      - ./vars:/runner/vars
    command: >
      ansible-playbook /runner/playbooks/deploy.yml
      --vault-password-file=/run/secrets/vault_password

secrets:
  vault_password:
    file: ./vault_password.txt
```

### 6.4 团队协作最佳实践


**📊 权限分级策略**

```
Level 1 - 基础配置：
• 开放给所有开发者
• 非敏感的应用配置
• 使用共享的vault密码

Level 2 - 环境相关：  
• 按环境分配权限
• 测试环境密码给开发+QA
• 预发环境密码限制范围

Level 3 - 生产核心：
• 仅核心运维团队
• 数据库管理员
• 安全管理员
```

**🔄 密码轮换策略**
```
定期轮换计划：
✅ 每季度更换生产环境密码
✅ 每月更换预发环境密码  
✅ 人员变动时及时更换
✅ 使用密码管理工具生成强密码
```

---

## 7. 📋 核心要点总结


### 7.1 必须掌握的基本操作


```
🔸 文件操作：create、edit、encrypt、decrypt、view
🔸 字符串操作：encrypt_string 用于部分字段加密
🔸 密码管理：--ask-vault-pass、--vault-password-file
🔸 密码更换：rekey 命令更改vault密码
🔸 多重管理：vault-id 实现不同密码管理不同文件
```

### 7.2 关键理解要点


**🔹 安全vs便利的平衡**
```
高安全性选择：
• 交互式密码输入 (--ask-vault-pass)
• 经常更换vault密码
• 细化的vault-id权限控制

高便利性选择：
• 密码文件或环境变量
• 自动化脚本集成
• 统一的vault密码管理

最佳实践：根据环境选择合适的方案
```

**🔹 不同加密方式的选择**
```
整文件加密 适用于：
✅ 文件内容都是敏感信息
✅ 简化密码管理
✅ 小团队协作

字符串加密 适用于：
✅ 文件中只有部分敏感字段  
✅ 需要部分内容共享
✅ 复杂的权限需求
```

**🔹 多环境管理策略**
```
单一密码：
• 管理简单，适合小项目
• 权限控制粗糙
• 安全风险相对集中

多重vault-id：
• 权限控制精细
• 管理复杂度增加
• 安全风险分散化
```

### 7.3 实际应用价值


**💼 业务场景应用**
- **Web应用部署**：保护数据库密码、API密钥
- **云基础设施**：加密云服务商的访问凭证
- **容器化部署**：在Docker/K8s中安全传递敏感配置
- **CI/CD流水线**：在自动化流程中安全使用密码

**🔧 运维实践**
- **密码轮换**：定期更新关键系统密码
- **权限管理**：不同环境使用不同vault-id
- **安全审计**：加密文件的版本控制安全
- **团队协作**：多人协作时的密码共享策略

### 7.4 常见问题与解决


**❓ 常见问题速查**

| 问题 | 原因 | 解决方案 |
|-----|------|---------|
| 💥 解密失败 | 密码错误 | 确认使用正确的vault密码 |
| 🔒 权限拒绝 | 密码文件权限 | `chmod 600 密码文件` |
| 📁 找不到密码文件 | 路径错误 | 检查文件路径和相对路径 |
| 🔄 批量操作失败 | 文件使用不同密码 | 使用对应的vault-id |

**⚠️ 安全提醒**
```
DO ✅：
• 定期更换vault密码
• 密码文件设置严格权限
• 将密码文件加入.gitignore
• 使用强密码

DON'T ❌：
• 在命令行中明文传递密码
• 将密码文件提交到版本控制
• 在多人环境中使用单一密码
• 长期保持文件解密状态
```

**核心记忆口诀**：
- vault工具保密码，AES256加密强
- create edit encrypt用，view查看最安全
- 密码管理三方式，交互文件环境量
- 多重vault-id好，权限控制更精良