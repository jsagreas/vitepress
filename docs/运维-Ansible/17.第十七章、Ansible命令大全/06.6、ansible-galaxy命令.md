---
title: 6、ansible-galaxy命令
---
## 📚 目录

1. [ansible-galaxy基础概念](#1-ansible-galaxy基础概念)
2. [角色管理核心命令](#2-角色管理核心命令)
3. [Collection集合管理](#3-Collection集合管理)
4. [requirements.yml文件管理](#4-requirements-yml文件管理)
5. [Galaxy平台交互命令](#5-Galaxy平台交互命令)
6. [实际应用场景与最佳实践](#6-实际应用场景与最佳实践)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 🌟 ansible-galaxy基础概念


### 1.1 什么是ansible-galaxy


**🔸 核心定义**
```
ansible-galaxy：Ansible官方提供的角色和集合管理工具
作用：帮你下载、安装、管理别人写好的Ansible代码
比喻：就像手机上的应用商店，但装的是自动化脚本
```

**💡 为什么需要galaxy**
想象你要配置一个Web服务器，需要安装Nginx、配置SSL、设置防火墙等。如果每次都自己写，会很麻烦。Galaxy就是让你直接用别人已经写好、测试过的配置。

```
不用Galaxy的情况：
你需要自己写 → 安装Nginx的playbook
你需要自己写 → 配置SSL的playbook  
你需要自己写 → 设置防火墙的playbook
时间成本：可能需要几天

用Galaxy的情况：
ansible-galaxy install nginx角色 → 5分钟搞定
ansible-galaxy install ssl角色 → 5分钟搞定
ansible-galaxy install firewall角色 → 5分钟搞定
时间成本：15分钟
```

### 1.2 角色(Role) vs 集合(Collection)


**🔹 角色(Role)**：一套完整的自动化方案
```
什么是角色：
├── 一个nginx角色包含：
│   ├── 安装nginx的任务
│   ├── 配置nginx的模板
│   ├── 启动nginx的处理器
│   └── 默认的变量设置
│
比喻：角色就像一个完整的"菜谱"，告诉你怎么做一道菜
```

**🔹 集合(Collection)**：多个相关工具的打包
```
什么是集合：
├── 一个cloud集合可能包含：
│   ├── AWS相关的模块
│   ├── Azure相关的模块  
│   ├── 云服务相关的角色
│   └── 云监控相关的插件
│
比喻：集合就像一个"工具箱"，里面有各种相关工具
```

### 1.3 Galaxy的两种来源


**📦 官方Galaxy Hub**
- 地址：`galaxy.ansible.com`
- 特点：免费、公开、社区维护
- 就像GitHub一样，任何人都可以上传分享

**🏢 私有Galaxy服务器**
- 企业内部搭建
- 存放公司专用的角色和集合
- 更安全、更可控

---

## 2. 🎯 角色管理核心命令


### 2.1 创建新角色 - ansible-galaxy init


**🔸 基本用法**
```bash
# 创建一个名为webserver的角色
ansible-galaxy init webserver
```

**💡 执行结果说明**
这个命令会创建一个标准的角色目录结构：
```
webserver/
├── README.md          ← 角色说明文档
├── defaults/
│   └── main.yml      ← 默认变量
├── files/            ← 静态文件存放
├── handlers/
│   └── main.yml      ← 处理器定义
├── meta/
│   └── main.yml      ← 角色元信息
├── tasks/
│   └── main.yml      ← 主要任务
├── templates/        ← 模板文件
├── tests/            ← 测试文件
└── vars/
    └── main.yml      ← 角色变量
```

> 💡 **通俗理解**：就像搭房子时先搭好框架，每个房间都有固定用途

**🔧 高级选项**
```bash
# 在指定目录创建角色
ansible-galaxy init --init-path=/path/to/roles webserver

# 创建时指定角色类型
ansible-galaxy init --type=role webserver
```

### 2.2 安装角色 - ansible-galaxy install


**🔸 从Galaxy Hub安装**
```bash
# 安装nginx角色
ansible-galaxy install nginxinc.nginx

# 指定版本安装
ansible-galaxy install nginxinc.nginx,1.0.0
```

**💡 理解安装过程**
1. 命令执行后，ansible会连接到galaxy.ansible.com
2. 下载nginxinc.nginx角色的代码包
3. 解压到本地角色目录（通常是`~/.ansible/roles/`）
4. 现在你就可以在playbook中使用这个角色了

**🔸 从Git仓库安装**
```bash
# 从GitHub安装
ansible-galaxy install git+https://github.com/username/role-name.git

# 指定分支
ansible-galaxy install git+https://github.com/username/role-name.git,main
```

**🔸 从本地文件安装**
```bash
# 从本地tar包安装
ansible-galaxy install /path/to/role.tar.gz
```

**🔧 常用安装选项**
```bash
# 强制重新安装（覆盖已存在的）
ansible-galaxy install --force nginxinc.nginx

# 安装到指定目录
ansible-galaxy install --roles-path=/custom/path nginxinc.nginx

# 忽略错误继续安装
ansible-galaxy install --ignore-errors role1 role2 role3
```

### 2.3 列出已安装角色 - ansible-galaxy list


**🔸 基本查看**
```bash
# 查看所有已安装角色
ansible-galaxy list
```

**示例输出**：
```
# /home/user/.ansible/roles
- nginxinc.nginx, 1.0.0
- geerlingguy.apache, 3.2.0
- community.mysql, 2.1.0
```

**🔸 查看特定路径的角色**
```bash
# 查看指定目录的角色
ansible-galaxy list --roles-path=/custom/roles
```

> 💡 **实用技巧**：定期运行这个命令，了解你安装了哪些角色，避免重复安装

### 2.4 搜索角色 - ansible-galaxy search


**🔸 关键字搜索**
```bash
# 搜索nginx相关角色
ansible-galaxy search nginx

# 搜索多个关键字
ansible-galaxy search web server
```

**🔸 按作者搜索**
```bash
# 搜索特定作者的角色
ansible-galaxy search --author=geerlingguy
```

**🔸 按平台搜索**
```bash
# 搜索Ubuntu平台的角色
ansible-galaxy search --platforms=Ubuntu
```

> 💡 **选择技巧**：
> - 优先选择下载量高、评分好的角色
> - 查看角色的最后更新时间，选择维护活跃的
> - 读一下README，确保功能符合需求

### 2.5 查看角色详情 - ansible-galaxy info


**🔸 查看角色信息**
```bash
# 查看nginx角色的详细信息
ansible-galaxy info nginxinc.nginx
```

**示例输出解读**：
```
Role: nginxinc.nginx
	description: 安装和配置nginx web服务器
	active: True                    ← 角色是否活跃维护
	commit: 2a1b3c4d               ← 最新提交ID  
	download_count: 50000          ← 下载次数
	forks_count: 150               ← fork次数
	github_branch: main            ← GitHub分支
	github_repo: ansible-role-nginx ← 仓库名
	github_user: nginxinc          ← GitHub用户
	license: Apache                ← 开源协议
	min_ansible_version: 2.9       ← 最低Ansible版本要求
	platforms:                     ← 支持的平台
		- name: EL                 ← Enterprise Linux (CentOS/RHEL)
		  versions: ['7', '8']
		- name: Ubuntu
		  versions: ['18.04', '20.04']
```

### 2.6 删除角色 - ansible-galaxy remove


**🔸 删除指定角色**
```bash
# 删除nginx角色
ansible-galaxy remove nginxinc.nginx
```

**🔸 批量删除**
```bash
# 删除多个角色
ansible-galaxy remove nginxinc.nginx geerlingguy.apache
```

> ⚠️ **注意**：删除角色前确认没有playbook在使用它，否则会导致执行失败

---

## 3. 📦 Collection集合管理


### 3.1 什么是Collection


**💡 Collection的理解**
Collection是Ansible 2.9后引入的新概念，把相关的模块、角色、插件打包在一起。

```
传统方式的问题：
├── AWS的模块分散在各处
├── 云服务的角色各自独立  
├── 相关插件难以统一管理
└── 版本依赖关系复杂

Collection的解决方案：
├── amazon.aws集合包含：
│   ├── ec2模块
│   ├── s3模块
│   ├── rds模块
│   ├── aws相关角色
│   └── aws相关插件
└── 统一版本，统一安装
```

### 3.2 安装Collection - ansible-galaxy collection install


**🔸 从Galaxy安装**
```bash
# 安装AWS集合
ansible-galaxy collection install amazon.aws

# 指定版本安装
ansible-galaxy collection install amazon.aws:1.5.0
```

**🔸 从requirements文件安装**
```bash
# 从requirements.yml安装
ansible-galaxy collection install -r requirements.yml
```

**🔸 安装选项**
```bash
# 强制重新安装
ansible-galaxy collection install --force amazon.aws

# 安装到指定路径
ansible-galaxy collection install --collections-path=/custom/collections amazon.aws

# 升级到最新版本  
ansible-galaxy collection install --upgrade amazon.aws
```

### 3.3 列出Collection - ansible-galaxy collection list


**🔸 查看已安装集合**
```bash
# 查看所有集合
ansible-galaxy collection list
```

**示例输出**：
```
Collection        Version
----------------- -------
amazon.aws        1.5.0  
community.general 3.3.0  
ansible.posix     1.3.0
```

**🔸 查看特定集合**
```bash
# 查看指定集合的版本
ansible-galaxy collection list amazon.aws
```

### 3.4 验证Collection - ansible-galaxy collection verify


**🔸 验证集合完整性**
```bash
# 验证amazon.aws集合
ansible-galaxy collection verify amazon.aws
```

这个命令会检查：
- 集合文件是否完整
- 是否被篡改
- 版本是否匹配

> 💡 **使用场景**：在生产环境部署前，验证集合的完整性和安全性

---

## 4. 📋 requirements.yml文件管理


### 4.1 requirements.yml文件结构


**🔸 基本结构**
```yaml
# requirements.yml
---
# 角色依赖
roles:
  - name: nginxinc.nginx
    version: "1.0.0"
  - name: geerlingguy.apache
    version: ">=3.0.0"
  - src: https://github.com/username/custom-role.git
    version: main
    name: custom-role

# 集合依赖  
collections:
  - name: amazon.aws
    version: ">=1.5.0"
  - name: community.general
    version: "3.3.0"
  - name: ansible.posix
```

### 4.2 从requirements安装


**🔸 安装角色**
```bash
# 安装requirements.yml中的所有角色
ansible-galaxy install -r requirements.yml
```

**🔸 安装集合**
```bash  
# 安装requirements.yml中的所有集合
ansible-galaxy collection install -r requirements.yml
```

**🔸 同时安装角色和集合**
```bash
# 先安装角色
ansible-galaxy install -r requirements.yml

# 再安装集合
ansible-galaxy collection install -r requirements.yml
```

### 4.3 requirements文件最佳实践


**📝 版本固定策略**
```yaml
# ✅ 推荐：生产环境固定版本
roles:
  - name: nginxinc.nginx
    version: "1.0.0"          # 精确版本

# ⚠️ 谨慎：开发环境可以用范围
roles:
  - name: nginxinc.nginx  
    version: ">=1.0.0,<2.0.0" # 版本范围
```

**🗂️ 分环境管理**
```bash
# 不同环境用不同requirements文件
requirements-dev.yml     # 开发环境
requirements-prod.yml    # 生产环境  
requirements-test.yml    # 测试环境
```

---

## 5. 🔗 Galaxy平台交互命令


### 5.1 登录Galaxy - ansible-galaxy login


**🔸 登录到Galaxy Hub**
```bash
# 使用GitHub账号登录
ansible-galaxy login --github-token=YOUR_GITHUB_TOKEN
```

**💡 获取token步骤**：
1. 登录GitHub
2. 进入Settings → Developer settings → Personal access tokens
3. 生成新token，权限选择repo相关
4. 复制token用于登录

### 5.2 导入角色 - ansible-galaxy import


**🔸 从GitHub导入角色**
```bash
# 导入GitHub上的角色到Galaxy
ansible-galaxy import username repository-name
```

**执行过程**：
1. Galaxy连接到你的GitHub仓库
2. 检查角色格式是否符合标准
3. 运行测试（如果有的话）
4. 导入成功后，其他人就能安装你的角色

### 5.3 删除Galaxy上的角色 - ansible-galaxy delete


**🔸 删除已发布的角色**
```bash
# 删除Galaxy上的角色
ansible-galaxy delete username role-name
```

> ⚠️ **注意**：这个操作不可逆，删除前要谨慎考虑

### 5.4 设置角色信息 - ansible-galaxy setup


**🔸 设置角色的Galaxy信息**
```bash  
# 设置角色在Galaxy上的信息
ansible-galaxy setup username role-name
```

---

## 6. 🚀 实际应用场景与最佳实践


### 6.1 项目初始化场景


**📋 场景描述**
你要搭建一个完整的Web应用环境，需要nginx、mysql、redis等服务。

**🔧 实施步骤**
```bash
# 1. 创建项目目录
mkdir web-project && cd web-project

# 2. 创建requirements.yml
cat > requirements.yml << EOF
---
roles:
  - nginxinc.nginx
  - geerlingguy.mysql  
  - geerlingguy.redis
collections:
  - community.general
EOF

# 3. 一键安装所有依赖
ansible-galaxy install -r requirements.yml
ansible-galaxy collection install -r requirements.yml

# 4. 创建主playbook
cat > site.yml << EOF
---
- hosts: webservers
  roles:
    - nginxinc.nginx
    - geerlingguy.mysql
    - geerlingguy.redis
EOF
```

### 6.2 角色开发场景


**📋 场景描述**
你要开发一个自定义的应用部署角色。

**🔧 开发流程**
```bash
# 1. 初始化角色结构
ansible-galaxy init myapp

# 2. 编写角色内容
cd myapp
# 编辑tasks/main.yml, templates/, etc.

# 3. 本地测试
ansible-playbook -i localhost, test-playbook.yml

# 4. 推送到GitHub
git init && git add . && git commit -m "Initial role"
git remote add origin https://github.com/username/ansible-role-myapp
git push -u origin main

# 5. 导入到Galaxy
ansible-galaxy login --github-token=YOUR_TOKEN
ansible-galaxy import username ansible-role-myapp
```

### 6.3 企业环境部署场景


**🏢 私有Galaxy设置**
```bash
# 1. 配置ansible.cfg使用私有Galaxy
cat >> ansible.cfg << EOF
[galaxy]
server_list = private_galaxy, public_galaxy

[galaxy_server.private_galaxy]
url = https://galaxy.company.com/
username = your_username
password = your_password

[galaxy_server.public_galaxy] 
url = https://galaxy.ansible.com/
EOF

# 2. 从私有Galaxy安装
ansible-galaxy install --server private_galaxy company.internal_role
```

### 6.4 版本管理最佳实践


**📊 版本策略对比表**

| 环境类型 | 版本策略 | 示例 | 优缺点 |
|---------|----------|------|--------|
| **开发环境** | `latest`或范围版本 | `>=1.0.0` | 🟢 获取新特性 🔴 可能不稳定 |
| **测试环境** | 固定版本 | `1.2.0` | 🟢 稳定可重复 🟡 需定期更新 |
| **生产环境** | 严格固定版本 | `1.2.0` | 🟢 最高稳定性 🔴 错过安全更新 |

### 6.5 依赖冲突解决


**⚠️ 常见问题**：不同角色依赖同一个角色的不同版本

**解决方案**：
```yaml
# requirements.yml中明确指定版本
roles:
  - name: common.base
    version: "2.1.0"  # 明确版本，避免冲突
  - name: web.frontend
    version: "1.0.0"
  - name: web.backend  
    version: "1.0.0"
```

**🔍 检查依赖**：
```bash
# 查看角色的meta信息，了解其依赖
cat ~/.ansible/roles/role-name/meta/main.yml
```

---

## 7. 📋 核心要点总结


### 7.1 必须掌握的基本命令


```bash
# 🔸 角色管理核心命令
ansible-galaxy init role-name              # 创建新角色
ansible-galaxy install role-name           # 安装角色
ansible-galaxy list                        # 列出已安装角色
ansible-galaxy search keyword              # 搜索角色
ansible-galaxy info role-name              # 查看角色详情
ansible-galaxy remove role-name            # 删除角色

# 🔸 集合管理核心命令  
ansible-galaxy collection install name     # 安装集合
ansible-galaxy collection list             # 列出集合
ansible-galaxy collection verify name      # 验证集合

# 🔸 文件管理命令
ansible-galaxy install -r requirements.yml # 从文件安装依赖
```

### 7.2 关键理解要点


**🔹 角色 vs 集合的选择**
```
使用角色的场景：
• 需要完整的服务配置方案
• 单一功能的自动化需求
• 传统的Ansible项目

使用集合的场景：
• 需要一套相关的工具和模块
• 复杂的云平台集成
• 现代化的Ansible项目
```

**🔹 版本管理策略**
```
开发阶段：使用latest版本快速迭代
测试阶段：固定版本确保一致性
生产环境：严格锁定版本保证稳定
```

**🔹 依赖管理思维**
```
单一项目：直接用install命令
多项目共享：用requirements.yml文件
企业级应用：搭建私有Galaxy服务
```

### 7.3 实际应用价值


**🎯 效率提升**
- **时间节省**：使用现有角色比自己写快10倍以上
- **质量保证**：社区验证过的角色更可靠
- **标准化**：统一的角色结构便于团队协作

**🔧 最佳实践要点**
- **选择角色**：优先选择活跃维护、下载量高的角色
- **版本控制**：生产环境务必固定版本
- **依赖管理**：用requirements.yml管理所有依赖
- **安全考虑**：定期更新角色获取安全补丁

**📊 常用操作流程**
```
新项目启动流程：
1. 创建requirements.yml → 定义依赖
2. 批量安装依赖 → ansible-galaxy install -r requirements.yml  
3. 编写主playbook → 引用安装的角色
4. 测试验证 → 确保功能正常
5. 部署上线 → 在目标环境执行
```

**核心记忆**：
- **Galaxy是Ansible的应用商店**：别重复造轮子，用现成的
- **角色解决单一问题，集合解决一类问题**：按需选择
- **requirements.yml是项目依赖清单**：必备的项目文件  
- **版本管理是成功的关键**：开发灵活，生产固定