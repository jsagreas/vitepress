---
title: 5、变量和参数命令
---
## 📚 目录

1. [变量传递命令](#1-变量传递命令)
2. [详细输出控制](#2-详细输出控制)
3. [认证和权限管理](#3-认证和权限管理)
4. [用户和提权控制](#4-用户和提权控制)
5. [实战应用场景](#5-实战应用场景)
6. [核心要点总结](#6-核心要点总结)

---

## 1. 🔧 变量传递命令


### 1.1 -e 传递额外变量


**🔸 基本概念**
`-e`（或`--extra-vars`）是Ansible中最常用的变量传递方式，可以在命令行直接给playbook传递变量值。

**💡 为什么需要传递变量？**
想象你写了一个部署网站的playbook，但是不同环境（开发、测试、生产）需要不同的配置。如果每次都要修改playbook文件，那就太麻烦了。通过`-e`，你可以在执行时灵活指定变量值。

**🎯 基本用法**
```bash
# 传递单个变量
ansible-playbook site.yml -e "app_name=myapp"

# 传递多个变量
ansible-playbook site.yml -e "app_name=myapp env=production port=8080"

# 传递复杂数据类型
ansible-playbook site.yml -e '{"users":["tom","jerry"],"debug":true}'
```

**🔍 实际应用示例**
```bash
# 部署不同版本的应用
ansible-playbook deploy.yml -e "version=2.1.0 env=staging"

# 动态指定数据库连接
ansible-playbook db-setup.yml -e "db_host=192.168.1.100 db_port=3306"
```

### 1.2 --extra-vars 传递变量文件


**🔸 什么是变量文件？**
当变量很多或很复杂时，在命令行输入就不方便了。这时可以把所有变量写在一个文件里，然后通过`--extra-vars`引用这个文件。

**📄 支持的文件格式**

**JSON格式示例（vars.json）：**
```json
{
  "app_name": "mywebapp",
  "environment": "production",
  "database": {
    "host": "db.example.com",
    "port": 3306,
    "name": "webapp_db"
  },
  "features": ["ssl", "cache", "monitor"]
}
```

**YAML格式示例（vars.yml）：**
```yaml
app_name: mywebapp
environment: production
database:
  host: db.example.com
  port: 3306
  name: webapp_db
features:
  - ssl
  - cache
  - monitor
```

**🚀 使用变量文件**
```bash
# 使用JSON变量文件
ansible-playbook site.yml --extra-vars @vars.json

# 使用YAML变量文件
ansible-playbook site.yml --extra-vars @vars.yml

# 混合使用：文件变量 + 命令行变量
ansible-playbook site.yml --extra-vars @vars.yml -e "debug=true"
```

---

## 2. 📊 详细输出控制


### 2.1 输出详细级别对比


| 级别 | 参数 | **输出内容** | **使用场景** |
|------|------|-------------|-------------|
| **默认** | 无 | `基本执行结果` | `日常使用，看结果` |
| **详细** | `-v` | `任务详情 + 返回值` | `调试任务执行` |
| **更详细** | `-vv` | `连接信息 + 模块参数` | `排查连接问题` |
| **调试** | `-vvv` | `执行过程 + 内部状态` | `深度调试` |
| **连接调试** | `-vvvv` | `所有网络通信详情` | `网络故障诊断` |

### 2.2 -v 详细输出模式


**🔸 作用说明**
`-v`会显示任务的详细执行信息，包括每个任务的返回值和状态变化。

**对比效果：**

**默认输出（无-v）：**
```
PLAY [web servers] *************************

TASK [install nginx] ***********************
ok: [web1]
ok: [web2]

PLAY RECAP *********************************
web1 : ok=1  changed=0  unreachable=0  failed=0
```

**详细输出（-v）：**
```
PLAY [web servers] *************************

TASK [install nginx] ***********************
ok: [web1] => {
    "changed": false,
    "msg": "nginx is already installed"
}
ok: [web2] => {
    "changed": false,
    "msg": "nginx is already installed"  
}
```

### 2.3 -vv 更详细输出


**🔸 额外显示内容**
- 连接建立过程
- 模块执行参数
- SSH连接详情

**📋 应用场景**
```bash
# 检查连接问题
ansible-playbook site.yml -vv

# 查看模块实际参数
ansible all -m copy -a "src=file.txt dest=/tmp/" -vv
```

### 2.4 -vvv 调试级别输出


**🔸 深度调试信息**
- 任务执行的内部逻辑
- 变量解析过程
- 条件判断详情
- 循环执行状态

### 2.5 -vvvv 连接调试输出


**🔸 网络通信详情**
- SSH连接的每个步骤
- 文件传输过程
- 网络延迟信息
- 认证握手过程

**⚠️ 使用建议**
```
日常执行：无需-v参数
任务失败：使用-v查看返回值
连接问题：使用-vv查看连接信息
复杂调试：使用-vvv
网络故障：使用-vvvv
```

---

## 3. 🔐 认证和权限管理


### 3.1 --ask-pass 询问SSH密码


**🔸 什么时候需要？**
当你的目标服务器没有配置SSH密钥认证，需要使用密码登录时。

**💡 工作原理**
```
正常流程：Ansible → SSH密钥 → 目标服务器
使用--ask-pass：Ansible → 提示输入密码 → 密码认证 → 目标服务器
```

**🎯 使用方法**
```bash
# 执行时会提示输入SSH密码
ansible-playbook site.yml --ask-pass

# 配合其他参数使用
ansible all -m ping --ask-pass -u admin
```

**执行效果：**
```
SSH password: [在这里输入密码，不显示]
PLAY [all] *****************************
...
```

### 3.2 --ask-become-pass 询问sudo密码


**🔸 提权场景说明**
很多系统管理任务需要root权限，比如安装软件、修改系统配置。Ansible可以用普通用户登录，然后通过sudo提升权限。

**💡 两种认证组合**
```
场景1：密钥登录 + sudo密码
ansible-playbook site.yml --ask-become-pass

场景2：密码登录 + sudo密码  
ansible-playbook site.yml --ask-pass --ask-become-pass

场景3：密码登录 + 无密码sudo
ansible-playbook site.yml --ask-pass -b
```

**🎯 实际应用**
```bash
# 需要sudo权限安装软件
ansible-playbook install-packages.yml --ask-become-pass -b

# 用户tom登录，然后sudo执行
ansible-playbook system-config.yml -u tom --ask-become-pass -b
```

---

## 4. 👤 用户和提权控制


### 4.1 -u 指定远程用户


**🔸 基本概念**
指定连接到远程服务器时使用的用户名。如果不指定，默认使用当前本地用户名。

**📊 用户指定策略**

| 场景 | **命令示例** | **说明** |
|------|-------------|----------|
| **默认用户** | `ansible-playbook site.yml` | `使用当前用户名` |
| **指定用户** | `ansible-playbook site.yml -u admin` | `使用admin用户登录` |
| **root用户** | `ansible-playbook site.yml -u root` | `直接用root登录` |
| **服务账号** | `ansible-playbook site.yml -u deploy` | `使用专门的部署账号` |

### 4.2 -b 使用become提权


**🔸 什么是become？**
become是Ansible的提权机制，类似于sudo。它允许你以普通用户登录，然后临时获得更高权限执行任务。

**💡 为什么需要提权？**
```
系统管理任务通常需要root权限：
✓ 安装软件包：yum install、apt install
✓ 修改系统配置：/etc/目录下的文件
✓ 启动系统服务：systemctl start
✓ 创建系统用户：useradd
✓ 修改网络配置：防火墙规则
```

**🎯 使用示例**
```bash
# 普通用户登录，提权执行
ansible-playbook system-setup.yml -u deploy -b

# 结合sudo密码使用
ansible-playbook install.yml -u admin -b --ask-become-pass
```

### 4.3 --become-user 指定提权用户


**🔸 灵活的权限控制**
默认become会提权到root，但有时你可能需要切换到其他特定用户。

**实用场景：**
```
场景1：切换到应用用户
# admin登录 → 切换到www-data用户 → 部署网站
ansible-playbook deploy-web.yml -u admin -b --become-user www-data

场景2：切换到数据库用户  
# 普通用户登录 → 切换到mysql用户 → 执行数据库操作
ansible-playbook db-backup.yml -u operator -b --become-user mysql

场景3：服务账号管理
# 运维登录 → 切换到应用账号 → 重启应用
ansible-playbook restart-app.yml -u ops -b --become-user appuser
```

### 4.4 --become-method 指定提权方法


**🔸 多种提权方式**

| 方法 | **说明** | **适用系统** | **特点** |
|------|---------|-------------|----------|
| **sudo** | `标准sudo命令` | `Linux/Unix` | `最常用，需要密码` |
| **su** | `切换用户命令` | `Linux/Unix` | `需要目标用户密码` |
| **pbrun** | `PowerBroker` | `企业环境` | `商业权限管理` |
| **pfexec** | `Solaris权限` | `Solaris` | `基于角色的访问` |
| **runas** | `Windows提权` | `Windows` | `Windows环境专用` |

**🎯 实际使用**
```bash
# 使用su方式提权
ansible-playbook site.yml --become-method su --ask-become-pass

# Windows环境使用runas
ansible-playbook windows-setup.yml --become-method runas -u administrator
```

---

## 5. 🚀 实战应用场景


### 5.1 完整的生产部署命令


**🎯 场景：部署生产环境应用**
```bash
# 复杂的生产部署命令
ansible-playbook deploy-production.yml \
  -u deploy \
  -b \
  --ask-become-pass \
  -e "app_version=2.3.1" \
  -e "environment=production" \
  --extra-vars @production-vars.yml \
  -v
```

**命令解析：**
```
-u deploy                    # 使用deploy用户登录
-b                          # 需要时提权到root
--ask-become-pass           # 询问sudo密码
-e "app_version=2.3.1"      # 指定部署版本
-e "environment=production"  # 设置环境标识
--extra-vars @production-vars.yml  # 加载生产环境变量文件
-v                          # 显示详细执行过程
```

### 5.2 开发环境快速测试


**🎯 场景：开发者本地测试**
```bash
# 简单的开发测试
ansible-playbook test.yml -e "debug=true" -vv
```

### 5.3 批量系统维护


**🎯 场景：系统管理员批量更新**
```bash
# 批量系统更新
ansible-playbook system-update.yml \
  -u admin \
  --ask-pass \
  --ask-become-pass \
  -b \
  -vvv
```

### 5.4 应用配置管理


**🎯 场景：不同环境配置部署**

**开发环境：**
```bash
ansible-playbook app-config.yml --extra-vars @dev-vars.yml -e "env=dev"
```

**测试环境：**
```bash
ansible-playbook app-config.yml --extra-vars @test-vars.yml -e "env=test"
```

**生产环境：**
```bash
ansible-playbook app-config.yml --extra-vars @prod-vars.yml -e "env=prod" -v
```

---

## 6. 📋 核心要点总结


### 6.1 必须掌握的核心概念


**🔸 变量传递核心**
- `-e`：命令行直接传递变量，适合简单动态值
- `--extra-vars @file`：文件传递变量，适合复杂配置
- **优先级**：命令行变量 > 文件变量 > playbook变量

**🔸 输出控制核心**
- 无参数：看结果够用
- `-v`：调试任务执行
- `-vv`：排查连接问题  
- `-vvv`+：深度故障诊断

**🔸 认证权限核心**
- `--ask-pass`：密码登录SSH
- `--ask-become-pass`：sudo提权密码
- `-u`：指定登录用户
- `-b`：启用提权机制

### 6.2 实用组合技巧


**🔹 常用命令组合模式**
```bash
# 模式1：开发测试（简单快速）
ansible-playbook test.yml -e "debug=true"

# 模式2：生产部署（安全完整）
ansible-playbook prod.yml -u deploy -b --ask-become-pass --extra-vars @prod-vars.yml -v

# 模式3：故障调试（详细输出）
ansible-playbook debug.yml -vvv

# 模式4：批量管理（权限认证）
ansible-playbook system.yml --ask-pass --ask-become-pass -b
```

### 6.3 最佳实践建议


**🎯 变量管理策略**
- **敏感信息**：使用ansible-vault加密
- **环境区分**：不同环境使用不同变量文件
- **版本控制**：变量文件纳入git管理
- **命名规范**：变量名要见名知义

**🎯 执行策略选择**
- **日常操作**：默认输出级别
- **新playbook**：使用-v验证执行过程
- **生产部署**：使用-v记录执行日志
- **故障排查**：根据问题选择合适的-v级别

**🎯 安全认证建议**
- **优先使用**：SSH密钥认证
- **密码认证**：仅在必要时使用
- **权限最小化**：使用专门的服务账号
- **日志审计**：记录所有提权操作

### 6.4 记忆要点


**🧠 核心记忆**
- **变量传递**：`-e`简单值，`@file`复杂配置
- **输出控制**：越多`v`越详细，`-vvvv`是极限
- **用户权限**：`-u`指定用户，`-b`提升权限
- **密码询问**：`--ask-pass`登录，`--ask-become-pass`提权

**⚡ 快速决策**
```
需要传参数？ → 用-e
配置很复杂？ → 用--extra-vars @文件
执行有问题？ → 加-v看详情
需要权限？   → 加-b提权
要输密码？   → 加--ask-*-pass
```