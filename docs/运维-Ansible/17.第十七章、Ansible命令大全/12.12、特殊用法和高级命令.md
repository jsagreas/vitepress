---
title: 12ã€ç‰¹æ®Šç”¨æ³•å’Œé«˜çº§å‘½ä»¤
---
## ğŸ“š ç›®å½•

1. [ansible-pullæ‹‰å–æ¨¡å¼](#1-ansible-pullæ‹‰å–æ¨¡å¼)
2. [æ¡ä»¶æ‰§è¡Œæ§åˆ¶](#2-æ¡ä»¶æ‰§è¡Œæ§åˆ¶)
3. [å§”æ‰˜å’Œæœ¬åœ°æ‰§è¡Œ](#3-å§”æ‰˜å’Œæœ¬åœ°æ‰§è¡Œ)
4. [metaä»»åŠ¡æ§åˆ¶](#4-metaä»»åŠ¡æ§åˆ¶)
5. [åŠ¨æ€åŠ è½½æœºåˆ¶](#5-åŠ¨æ€åŠ è½½æœºåˆ¶)
6. [è§’è‰²ä¾èµ–ç®¡ç†](#6-è§’è‰²ä¾èµ–ç®¡ç†)
7. [è‡ªå®šä¹‰æ¨¡å—å’Œæ’ä»¶](#7-è‡ªå®šä¹‰æ¨¡å—å’Œæ’ä»¶)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”„ ansible-pullæ‹‰å–æ¨¡å¼


### 1.1 ä»€ä¹ˆæ˜¯ansible-pull


**ğŸ’­ ä¼ ç»Ÿæ¨¡å¼ vs æ‹‰å–æ¨¡å¼**
```
ä¼ ç»Ÿæ¨é€æ¨¡å¼ï¼ˆansibleï¼‰ï¼š
æ§åˆ¶æœº â”€â”€æ¨é€â”€â”€> ç›®æ ‡æœº1
       â”€â”€æ¨é€â”€â”€> ç›®æ ‡æœº2
       â”€â”€æ¨é€â”€â”€> ç›®æ ‡æœº3

æ‹‰å–æ¨¡å¼ï¼ˆansible-pullï¼‰ï¼š
ç›®æ ‡æœº1 â”€â”€æ‹‰å–â”€â”€> Gitä»“åº“
ç›®æ ‡æœº2 â”€â”€æ‹‰å–â”€â”€> Gitä»“åº“  
ç›®æ ‡æœº3 â”€â”€æ‹‰å–â”€â”€> Gitä»“åº“
```

> **ğŸ’¡ å…³é”®ç†è§£**ï¼šansible-pullæ˜¯è®©ç›®æ ‡æœºå™¨ä¸»åŠ¨ä»Gitä»“åº“æ‹‰å–é…ç½®å¹¶æ‰§è¡Œï¼Œè€Œä¸æ˜¯ä»æ§åˆ¶æœºæ¨é€

**ğŸ¯ ä¸ºä»€ä¹ˆè¦ç”¨æ‹‰å–æ¨¡å¼ï¼Ÿ**
- **å¤§è§„æ¨¡éƒ¨ç½²**ï¼šä¸å—æ§åˆ¶æœºæ€§èƒ½é™åˆ¶ï¼Œå¯ä»¥åŒæ—¶ç®¡ç†æˆåƒä¸Šä¸‡å°æœºå™¨
- **ç½‘ç»œéš”ç¦»**ï¼šç›®æ ‡æœºå™¨åªéœ€è¦è®¿é—®Gitä»“åº“ï¼Œä¸éœ€è¦å¼€æ”¾SSHç»™æ§åˆ¶æœº
- **è‡ªåŠ¨åŒ–è¿ç»´**ï¼šé…åˆå®šæ—¶ä»»åŠ¡å®ç°å®Œå…¨è‡ªåŠ¨åŒ–çš„é…ç½®ç®¡ç†

### 1.2 ansible-pullåŸºæœ¬ç”¨æ³•


**ğŸ”§ åŸºæœ¬è¯­æ³•ç»“æ„**
```bash
ansible-pull [é€‰é¡¹] -U <gitä»“åº“åœ°å€> [playbookæ–‡ä»¶]
```

**ğŸ“‹ æ ¸å¿ƒå‚æ•°è¯´æ˜**
```bash
# åŸºæœ¬æ‹‰å–æ‰§è¡Œ
ansible-pull -U https://github.com/username/ansible-configs.git

# æŒ‡å®šæ‰§è¡Œçš„playbookæ–‡ä»¶
ansible-pull -U https://github.com/username/configs.git site.yml

# æŒ‡å®šåˆ†æ”¯
ansible-pull -U https://github.com/username/configs.git -C master

# è®¾ç½®æ‰§è¡Œé—´éš”ï¼ˆç§’ï¼‰
ansible-pull -U https://github.com/username/configs.git -s 300
```

### 1.3 å®é™…åº”ç”¨åœºæ™¯


**ğŸ¢ ä¼ä¸šçº§è‡ªåŠ¨åŒ–éƒ¨ç½²**
```bash
#!/bin/bash
# éƒ¨ç½²è„šæœ¬ï¼šdeploy.sh

# æ¯30åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡é…ç½®åŒæ­¥
ansible-pull \
  -U https://git.company.com/ops/server-configs.git \
  -C production \
  --accept-host-key \
  -i inventory/prod \
  site.yml
```

**ğŸ“‹ é…ç½®æ£€æŸ¥æ¸…å•**
- [ ] Gitä»“åº“æƒé™é…ç½®æ­£ç¡®
- [ ] SSHå¯†é’¥æˆ–è®¤è¯è®¾ç½®å®Œæˆ
- [ ] playbookè·¯å¾„å’Œæ–‡ä»¶åæ­£ç¡®
- [ ] ç›®æ ‡æœºå™¨æœ‰ansibleå’Œgitå‘½ä»¤

> **âš ï¸ é‡è¦æé†’**ï¼šä½¿ç”¨ansible-pullæ—¶ï¼Œç¡®ä¿Gitä»“åº“çš„å®‰å…¨æ€§ï¼Œå› ä¸ºæ‰€æœ‰ç›®æ ‡æœºå™¨éƒ½éœ€è¦è®¿é—®æƒé™

---

## 2. ğŸ¯ æ¡ä»¶æ‰§è¡Œæ§åˆ¶


### 2.1 --whenæ¡ä»¶åˆ¤æ–­è¯¦è§£


**ğŸ’­ ä»€ä¹ˆæ˜¯æ¡ä»¶æ‰§è¡Œï¼Ÿ**
å°±åƒç¼–ç¨‹ä¸­çš„ifè¯­å¥ï¼Œåªæœ‰æ»¡è¶³ç‰¹å®šæ¡ä»¶æ—¶æ‰æ‰§è¡ŒæŸä¸ªä»»åŠ¡ã€‚è¿™è®©æˆ‘ä»¬å¯ä»¥æ ¹æ®ä¸åŒæƒ…å†µæ‰§è¡Œä¸åŒçš„æ“ä½œã€‚

**ğŸ”§ åŸºæœ¬whenè¯­æ³•**
```yaml
# playbookç¤ºä¾‹ï¼šæ ¹æ®æ“ä½œç³»ç»Ÿå®‰è£…ä¸åŒè½¯ä»¶åŒ…
- name: å®‰è£…Apacheï¼ˆUbuntuç³»ç»Ÿï¼‰
  apt:
    name: apache2
    state: present
  when: ansible_os_family == "Debian"

- name: å®‰è£…Apacheï¼ˆCentOSç³»ç»Ÿï¼‰
  yum:
    name: httpd
    state: present
  when: ansible_os_family == "RedHat"
```

### 2.2 å¸¸ç”¨æ¡ä»¶è¡¨è¾¾å¼


**ğŸ“Š ç³»ç»Ÿåˆ¤æ–­æ¡ä»¶**
```yaml
# æ“ä½œç³»ç»Ÿç‰ˆæœ¬åˆ¤æ–­
when: ansible_distribution_version >= "18.04"

# å†…å­˜å¤§å°åˆ¤æ–­
when: ansible_memtotal_mb > 4096

# æ–‡ä»¶å­˜åœ¨åˆ¤æ–­
when: ansible_stat.stat.exists

# æœåŠ¡çŠ¶æ€åˆ¤æ–­
when: service_result.changed
```

**ğŸ”— é€»è¾‘è¿ç®—ç¬¦ç»„åˆ**
```yaml
# ANDé€»è¾‘ï¼ˆåŒæ—¶æ»¡è¶³ï¼‰
when: 
  - ansible_os_family == "RedHat"
  - ansible_distribution_major_version == "7"

# ORé€»è¾‘ï¼ˆæ»¡è¶³å…¶ä¸€ï¼‰
when: ansible_os_family == "RedHat" or ansible_os_family == "Debian"

# NOTé€»è¾‘ï¼ˆä¸æ»¡è¶³ï¼‰
when: not ansible_selinux.status == "disabled"
```

### 2.3 --only-ifçš„å†å²ç”¨æ³•


> **ğŸ“š å†å²çŸ¥è¯†**ï¼š--only-ifæ˜¯æ—©æœŸAnsibleç‰ˆæœ¬ä½¿ç”¨çš„æ¡ä»¶æ‰§è¡Œå‚æ•°ï¼Œç°åœ¨å·²è¢«whenå…³é”®å­—æ›¿ä»£ï¼Œä½†äº†è§£å®ƒæœ‰åŠ©äºç†è§£è€ç‰ˆæœ¬ä»£ç 

---

## 3. ğŸ›ï¸ å§”æ‰˜å’Œæœ¬åœ°æ‰§è¡Œ


### 3.1 --delegate-toå§”æ‰˜æ‰§è¡Œ


**ğŸ’­ ä»€ä¹ˆæ˜¯å§”æ‰˜æ‰§è¡Œï¼Ÿ**
å°±åƒä½ å§”æ‰˜åˆ«äººä»£åŠäº‹æƒ…ä¸€æ ·ï¼Œè®©ä¸€ä¸ªä»»åŠ¡åœ¨æŒ‡å®šçš„å…¶ä»–æœºå™¨ä¸Šæ‰§è¡Œï¼Œè€Œä¸æ˜¯åœ¨åŸæœ¬çš„ç›®æ ‡æœºå™¨ä¸Šã€‚

**ğŸ¯ å…¸å‹åº”ç”¨åœºæ™¯**
```yaml
# åœ¨è´Ÿè½½å‡è¡¡å™¨ä¸Šæ“ä½œï¼Œè€Œä¸æ˜¯åœ¨WebæœåŠ¡å™¨ä¸Š
- name: ä»è´Ÿè½½å‡è¡¡å™¨ç§»é™¤WebæœåŠ¡å™¨
  haproxy:
    state: disabled
    host: "{{ inventory_hostname }}"
  delegate_to: loadbalancer.example.com

# åœ¨æ•°æ®åº“æœåŠ¡å™¨åˆ›å»ºç”¨æˆ·ï¼Œä¸ºWebåº”ç”¨å‡†å¤‡
- name: åˆ›å»ºæ•°æ®åº“ç”¨æˆ·
  mysql_user:
    name: webapp
    password: "{{ db_password }}"
  delegate_to: "{{ groups['database'][0] }}"
```

**ğŸ“‹ å§”æ‰˜æ‰§è¡Œçš„å®é™…ä»·å€¼**
- **è´Ÿè½½å‡è¡¡ç®¡ç†**ï¼šåœ¨æ›´æ–°æœåŠ¡å™¨å‰å…ˆä»è´Ÿè½½å‡è¡¡å™¨ç§»é™¤
- **æ•°æ®åº“æ“ä½œ**ï¼šåœ¨æ•°æ®åº“æœåŠ¡å™¨ä¸Šåˆ›å»ºç”¨æˆ·å’Œæ•°æ®åº“
- **ç›‘æ§ç³»ç»Ÿ**ï¼šåœ¨ç›‘æ§æœåŠ¡å™¨ä¸Šé…ç½®å‘Šè­¦è§„åˆ™

### 3.2 --local-actionæœ¬åœ°åŠ¨ä½œ


**ğŸ’¡ æ ¸å¿ƒæ¦‚å¿µ**ï¼šè®©ä»»åŠ¡åœ¨Ansibleæ§åˆ¶æœºä¸Šæ‰§è¡Œï¼Œè€Œä¸æ˜¯è¿œç¨‹ç›®æ ‡æœºå™¨

```yaml
# åœ¨æ§åˆ¶æœºç”Ÿæˆé…ç½®æ–‡ä»¶
- name: ç”Ÿæˆé…ç½®æ–‡ä»¶
  local_action:
    module: template
    src: config.j2
    dest: "/tmp/{{ inventory_hostname }}_config"

# ç­‰ä»·çš„æ–°è¯­æ³•
- name: ç”Ÿæˆé…ç½®æ–‡ä»¶
  template:
    src: config.j2
    dest: "/tmp/{{ inventory_hostname }}_config"
  delegate_to: localhost
```

### 3.3 --connection=localæœ¬åœ°è¿æ¥


**ğŸ”§ æœ¬åœ°è¿æ¥æ¨¡å¼**
```bash
# ç›´æ¥åœ¨æœ¬æœºæ‰§è¡Œï¼Œä¸é€šè¿‡SSH
ansible localhost -m setup --connection=local

# playbookä¸­æŒ‡å®šæœ¬åœ°è¿æ¥
ansible-playbook site.yml --connection=local
```

**ğŸ“Š è¿æ¥ç±»å‹å¯¹æ¯”**
| è¿æ¥ç±»å‹ | **ä½¿ç”¨åœºæ™¯** | **æ‰§è¡Œä½ç½®** | **ç½‘ç»œéœ€æ±‚** |
|---------|-------------|-------------|-------------|
| `ssh` | è¿œç¨‹ç®¡ç† | ç›®æ ‡æœºå™¨ | éœ€è¦SSHè¿æ¥ |
| `local` | æœ¬æœºæ“ä½œ | æ§åˆ¶æœº | æ— éœ€ç½‘ç»œ |
| `docker` | å®¹å™¨ç®¡ç† | å®¹å™¨å†…éƒ¨ | Docker API |

### 3.4 --run-onceåªè¿è¡Œä¸€æ¬¡


**ğŸ’­ åº”ç”¨åœºæ™¯**ï¼šå½“ä½ æœ‰å¤šå°æœåŠ¡å™¨ï¼Œä½†æŸä¸ªæ“ä½œåªéœ€è¦æ‰§è¡Œä¸€æ¬¡æ—¶ä½¿ç”¨

```yaml
# æ•°æ®åº“åˆå§‹åŒ–åªéœ€è¦æ‰§è¡Œä¸€æ¬¡
- name: åˆå§‹åŒ–æ•°æ®åº“
  mysql_db:
    name: webapp
    state: present
  run_once: true

# ä¸‹è½½æ–‡ä»¶åˆ°å…±äº«å­˜å‚¨ï¼Œåªéœ€è¦ä¸€å°æœºå™¨ä¸‹è½½
- name: ä¸‹è½½å®‰è£…åŒ…
  get_url:
    url: "{{ software_url }}"
    dest: "/shared/storage/installer.tar.gz"
  run_once: true
```

---

## 4. ğŸ® metaä»»åŠ¡æ§åˆ¶


### 4.1 ä»€ä¹ˆæ˜¯metaä»»åŠ¡


**ğŸ’­ ç†è§£metaä»»åŠ¡**
metaå°±åƒæ˜¯ç»™Ansibleå‘å‡ºçš„"æ§åˆ¶æŒ‡ä»¤"ï¼Œå‘Šè¯‰å®ƒå¦‚ä½•æ‰§è¡Œä»»åŠ¡ï¼Œè€Œä¸æ˜¯æ‰§è¡Œå…·ä½“çš„ç³»ç»Ÿæ“ä½œã€‚

**ğŸ¯ æ ¸å¿ƒmetaæ¨¡å—**
```yaml
# åˆ·æ–°inventoryç¼“å­˜
- meta: refresh_inventory

# æ”¶é›†ç³»ç»Ÿä¿¡æ¯
- meta: setup

# æ¸…é™¤å·²æ”¶é›†çš„facts
- meta: clear_facts

# æ¸…é™¤ä¸»æœºé”™è¯¯çŠ¶æ€
- meta: clear_host_errors

# ç»“æŸå½“å‰ä¸»æœºçš„æ‰§è¡Œ
- meta: end_host

# ç»“æŸæ•´ä¸ªplaybookæ‰§è¡Œ
- meta: end_play
```

### 4.2 å®é™…åº”ç”¨ç¤ºä¾‹


**ğŸ”„ åŠ¨æ€inventoryåˆ·æ–°**
```yaml
# åˆ›å»ºæ–°çš„äº‘ä¸»æœºåï¼Œåˆ·æ–°inventory
- name: åˆ›å»ºEC2å®ä¾‹
  ec2:
    image: ami-12345
    instance_type: t2.micro
    wait: yes

- name: åˆ·æ–°inventoryä»¥åŒ…å«æ–°åˆ›å»ºçš„å®ä¾‹
  meta: refresh_inventory

- name: é…ç½®æ–°åˆ›å»ºçš„å®ä¾‹
  setup:
  delegate_to: "{{ groups['tag_newly_created'][0] }}"
```

**âš ï¸ é”™è¯¯å¤„ç†å’Œæ¢å¤**
```yaml
- name: å°è¯•æ‰§è¡Œå¯èƒ½å¤±è´¥çš„æ“ä½œ
  command: risky_command
  ignore_errors: yes

- name: æ¸…é™¤ä¸»æœºé”™è¯¯çŠ¶æ€ç»§ç»­æ‰§è¡Œ
  meta: clear_host_errors

- name: æ‰§è¡Œåç»­ä»»åŠ¡
  debug:
    msg: "ç»§ç»­æ‰§è¡Œåç»­æ“ä½œ"
```

---

## 5. ğŸ“¦ åŠ¨æ€åŠ è½½æœºåˆ¶


### 5.1 include vs importçš„åŒºåˆ«


**ğŸ’­ æ ¸å¿ƒåŒºåˆ«ç†è§£**
```
includeï¼ˆåŠ¨æ€åŠ è½½ï¼‰ï¼š
è¿è¡Œæ—¶å†³å®š â†’ å¯ä»¥ä½¿ç”¨å˜é‡ â†’ å¾ªç¯ä¸­å¯å˜

importï¼ˆé™æ€åŠ è½½ï¼‰ï¼š
è§£ææ—¶å†³å®š â†’ é¢„å…ˆç¡®å®šå†…å®¹ â†’ æ€§èƒ½æ›´å¥½
```

### 5.2 include_tasksåŠ¨æ€ä»»åŠ¡åŠ è½½


**ğŸ”§ åŸºæœ¬è¯­æ³•å’Œåº”ç”¨**
```yaml
# æ ¹æ®æ“ä½œç³»ç»ŸåŠ¨æ€åŠ è½½ä¸åŒçš„ä»»åŠ¡æ–‡ä»¶
- name: åŠ è½½ç³»ç»Ÿç‰¹å®šçš„å®‰è£…ä»»åŠ¡
  include_tasks: "install_{{ ansible_os_family | lower }}.yml"

# å¾ªç¯åŠ è½½ä»»åŠ¡
- name: ä¸ºæ¯ä¸ªåº”ç”¨åŠ è½½é…ç½®ä»»åŠ¡
  include_tasks: configure_app.yml
  vars:
    app_name: "{{ item }}"
  loop:
    - nginx
    - mysql
    - redis
```

**ğŸ“ æ–‡ä»¶ç»„ç»‡ç»“æ„ç¤ºä¾‹**
```
playbooks/
â”œâ”€â”€ main.yml
â”œâ”€â”€ tasks/
â”‚   â”œâ”€â”€ install_debian.yml
â”‚   â”œâ”€â”€ install_redhat.yml
â”‚   â””â”€â”€ configure_app.yml
â””â”€â”€ vars/
    â””â”€â”€ app_configs.yml
```

### 5.3 include_varsåŠ¨æ€å˜é‡åŠ è½½


```yaml
# æ ¹æ®ç¯å¢ƒåŠ è½½ä¸åŒçš„å˜é‡æ–‡ä»¶
- name: åŠ è½½ç¯å¢ƒç‰¹å®šå˜é‡
  include_vars: "{{ env }}_vars.yml"

# æ¡ä»¶æ€§åŠ è½½å˜é‡
- name: åŠ è½½æ•°æ®åº“é…ç½®
  include_vars: database.yml
  when: "'database' in group_names"
```

### 5.4 import_playbooké™æ€playbookå¯¼å…¥


```yaml
# main.yml - ä¸»playbookæ–‡ä»¶
---
- import_playbook: basic_setup.yml
- import_playbook: security_hardening.yml
- import_playbook: application_deploy.yml
```

> **ğŸ” é€‰æ‹©å»ºè®®**ï¼šéœ€è¦åŠ¨æ€æ€§å’Œçµæ´»æ€§æ—¶ç”¨includeï¼Œè¿½æ±‚æ€§èƒ½å’Œç®€å•æ€§æ—¶ç”¨import

---

## 6. ğŸ—ï¸ è§’è‰²ä¾èµ–ç®¡ç†


### 6.1 è§’è‰²ä¾èµ–çš„åŸºæœ¬æ¦‚å¿µ


**ğŸ’­ ä»€ä¹ˆæ˜¯è§’è‰²ä¾èµ–ï¼Ÿ**
å°±åƒè½¯ä»¶åŒ…ç®¡ç†ä¸­çš„ä¾èµ–å…³ç³»ï¼Œä¸€ä¸ªè§’è‰²éœ€è¦å…¶ä»–è§’è‰²å…ˆæ‰§è¡Œæ‰èƒ½æ­£å¸¸å·¥ä½œã€‚

**ğŸ“ è§’è‰²ç›®å½•ç»“æ„**
```
roles/
â”œâ”€â”€ webserver/
â”‚   â”œâ”€â”€ meta/
â”‚   â”‚   â””â”€â”€ main.yml          # ä¾èµ–å…³ç³»å®šä¹‰
â”‚   â”œâ”€â”€ tasks/
â”‚   â”‚   â””â”€â”€ main.yml
â”‚   â””â”€â”€ vars/
â”‚       â””â”€â”€ main.yml
â””â”€â”€ database/
    â”œâ”€â”€ meta/
    â”‚   â””â”€â”€ main.yml
    â””â”€â”€ tasks/
        â””â”€â”€ main.yml
```

### 6.2 ä¾èµ–å…³ç³»å®šä¹‰


**ğŸ”— åœ¨meta/main.ymlä¸­å®šä¹‰ä¾èµ–**
```yaml
# roles/webserver/meta/main.yml
dependencies:
  - role: common
    become: yes
  - role: database
    vars:
      db_name: webapp
      db_user: webapp_user
  - role: firewall
    vars:
      allowed_ports: [80, 443]
    when: enable_firewall | default(true)
```

### 6.3 ä¾èµ–æ‰§è¡Œé¡ºåº


**ğŸ“Š æ‰§è¡Œæµç¨‹å›¾**
```
æ’­æ”¾æ‰§è¡Œé¡ºåºï¼š
1. ä¾èµ–è§’è‰²ï¼šcommon
2. ä¾èµ–è§’è‰²ï¼šdatabase  
3. ä¾èµ–è§’è‰²ï¼šfirewall
4. ä¸»è¦è§’è‰²ï¼šwebserver
```

**âš ï¸ é‡è¦ç‰¹æ€§**
- ç›¸åŒä¾èµ–åªæ‰§è¡Œä¸€æ¬¡
- ä¾èµ–è§’è‰²å…ˆäºä¸»è§’è‰²æ‰§è¡Œ
- æ”¯æŒæ¡ä»¶ä¾èµ–å’Œå˜é‡ä¼ é€’

---

## 7. ğŸ”§ è‡ªå®šä¹‰æ¨¡å—å’Œæ’ä»¶


### 7.1 è‡ªå®šä¹‰æ¨¡å—è·¯å¾„é…ç½®


**ğŸ“ æ¨¡å—æœç´¢è·¯å¾„**
```bash
# æŸ¥çœ‹å½“å‰æ¨¡å—è·¯å¾„
ansible-config dump | grep DEFAULT_MODULE_PATH

# ä¸´æ—¶æŒ‡å®šæ¨¡å—è·¯å¾„
export ANSIBLE_LIBRARY=/path/to/custom/modules

# ansible.cfgä¸­é…ç½®
[defaults]
library = /path/to/custom/modules:/another/path
```

**ğŸ“ é¡¹ç›®ç»“æ„ç¤ºä¾‹**
```
project/
â”œâ”€â”€ ansible.cfg
â”œâ”€â”€ playbooks/
â”œâ”€â”€ library/              # è‡ªå®šä¹‰æ¨¡å—ç›®å½•
â”‚   â””â”€â”€ my_custom_module.py
â””â”€â”€ plugins/
    â”œâ”€â”€ action/           # actionæ’ä»¶
    â”œâ”€â”€ callback/         # callbackæ’ä»¶
    â””â”€â”€ filter/           # filteræ’ä»¶
```

### 7.2 ç®€å•è‡ªå®šä¹‰æ¨¡å—ç¤ºä¾‹


**ğŸ åŸºç¡€æ¨¡å—æ¡†æ¶**
```python
#!/usr/bin/python
# library/hello_world.py

from ansible.module_utils.basic import AnsibleModule

def main():
    module = AnsibleModule(
        argument_spec=dict(
            name=dict(type='str', required=True),
            greeting=dict(type='str', default='Hello')
        )
    )
    
    name = module.params['name']
    greeting = module.params['greeting']
    
    result = dict(
        changed=False,
        message=f"{greeting}, {name}!"
    )
    
    module.exit_json(**result)

if __name__ == '__main__':
    main()
```

**ğŸ“‹ ä½¿ç”¨è‡ªå®šä¹‰æ¨¡å—**
```yaml
- name: æµ‹è¯•è‡ªå®šä¹‰æ¨¡å—
  hello_world:
    name: "Ansibleç”¨æˆ·"
    greeting: "ä½ å¥½"
```

### 7.3 æ’ä»¶å¼€å‘åŸºç¡€


**ğŸ”Œ è¿‡æ»¤å™¨æ’ä»¶ç¤ºä¾‹**
```python
# plugins/filter/custom_filters.py

def reverse_string(value):
    """åè½¬å­—ç¬¦ä¸²"""
    return value[::-1]

def format_size(bytes):
    """æ ¼å¼åŒ–å­—èŠ‚å¤§å°"""
    for unit in ['B', 'KB', 'MB', 'GB']:
        if bytes < 1024:
            return f"{bytes:.1f}{unit}"
        bytes /= 1024
    return f"{bytes:.1f}TB"

class FilterModule(object):
    def filters(self):
        return {
            'reverse': reverse_string,
            'format_size': format_size
        }
```

**ğŸ“ åœ¨playbookä¸­ä½¿ç”¨**
```yaml
- name: ä½¿ç”¨è‡ªå®šä¹‰è¿‡æ»¤å™¨
  debug:
    msg: "{{ 'hello' | reverse }}"  # è¾“å‡ºï¼šolleh

- name: æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
  debug:
    msg: "{{ 1048576 | format_size }}"  # è¾“å‡ºï¼š1.0MB
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ ansible-pullï¼šå¤§è§„æ¨¡éƒ¨ç½²çš„æ‹‰å–æ¨¡å¼ï¼Œç›®æ ‡æœºä¸»åŠ¨è·å–é…ç½®
ğŸ”¸ æ¡ä»¶æ‰§è¡Œï¼šwhenå…³é”®å­—å®ç°æ™ºèƒ½åŒ–çš„æ¡ä»¶åˆ¤æ–­
ğŸ”¸ å§”æ‰˜æ‰§è¡Œï¼šdelegate_toè®©ä»»åŠ¡åœ¨æŒ‡å®šæœºå™¨ä¸Šæ‰§è¡Œ
ğŸ”¸ metaä»»åŠ¡ï¼šæ§åˆ¶Ansibleæ‰§è¡Œæµç¨‹çš„ç‰¹æ®Šä»»åŠ¡
ğŸ”¸ åŠ¨æ€åŠ è½½ï¼šincludeå’Œimportçš„åŒºåˆ«å’Œåº”ç”¨åœºæ™¯
ğŸ”¸ è§’è‰²ä¾èµ–ï¼šç®¡ç†å¤æ‚è§’è‰²é—´çš„ä¾èµ–å…³ç³»
ğŸ”¸ è‡ªå®šä¹‰æ‰©å±•ï¼šæ¨¡å—å’Œæ’ä»¶çš„å¼€å‘å’Œä½¿ç”¨
```

### 8.2 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¸šåŠ¡åœºæ™¯åº”ç”¨**
- **å¤§è§„æ¨¡è¿ç»´**ï¼šansible-pullæ¨¡å¼ç®¡ç†æ•°åƒå°æœåŠ¡å™¨
- **æ™ºèƒ½éƒ¨ç½²**ï¼šæ¡ä»¶æ‰§è¡Œæ ¹æ®ç¯å¢ƒè‡ªåŠ¨é€‰æ‹©æ“ä½œ
- **å¤æ‚ç¼–æ’**ï¼šå§”æ‰˜æ‰§è¡Œåè°ƒå¤šä¸ªç³»ç»Ÿçš„æ“ä½œ
- **çµæ´»é…ç½®**ï¼šåŠ¨æ€åŠ è½½é€‚åº”ä¸åŒçš„éƒ¨ç½²éœ€æ±‚

**ğŸ”§ è¿ç»´å®è·µè¦ç‚¹**
- **æ€§èƒ½ä¼˜åŒ–**ï¼šåˆç†ä½¿ç”¨includeå’Œimportæå‡æ‰§è¡Œæ•ˆç‡
- **é”™è¯¯å¤„ç†**ï¼šmetaä»»åŠ¡å¸®åŠ©ä»é”™è¯¯çŠ¶æ€ä¸­æ¢å¤
- **ä»£ç å¤ç”¨**ï¼šè§’è‰²ä¾èµ–å®ç°é…ç½®çš„æ¨¡å—åŒ–ç®¡ç†
- **åŠŸèƒ½æ‰©å±•**ï¼šè‡ªå®šä¹‰æ¨¡å—è§£å†³ç‰¹æ®Šä¸šåŠ¡éœ€æ±‚

### 8.3 å­¦ä¹ å»ºè®®å’Œæ³¨æ„äº‹é¡¹


**ğŸ“š å­¦ä¹ è·¯å¾„å»ºè®®**
```
åŸºç¡€æŒæ¡ â†’ æ¡ä»¶æ‰§è¡Œå’Œå§”æ‰˜ â†’ metaä»»åŠ¡æ§åˆ¶
         â†“
é«˜çº§åº”ç”¨ â† è‡ªå®šä¹‰å¼€å‘ â† åŠ¨æ€åŠ è½½å’Œè§’è‰²ä¾èµ–
```

**âš ï¸ å¸¸è§é™·é˜±é¿å…**
- ansible-pulléœ€è¦ç¡®ä¿Gitä»“åº“å®‰å…¨æ€§
- å§”æ‰˜æ‰§è¡Œæ—¶æ³¨æ„ç›®æ ‡æœºå™¨çš„å¯è®¿é—®æ€§
- includeå’Œimportçš„é€‰æ‹©è¦è€ƒè™‘æ€§èƒ½å’Œçµæ´»æ€§å¹³è¡¡
- è‡ªå®šä¹‰æ¨¡å—å¼€å‘è¦éµå¾ªAnsibleçš„è§„èŒƒ

**ğŸ¯ è¿›é˜¶å­¦ä¹ æ–¹å‘**
- æ·±å…¥å­¦ä¹ Ansibleæ¶æ„å’Œæ’ä»¶ç³»ç»Ÿ
- æŒæ¡å¤æ‚çš„Jinja2æ¨¡æ¿å’Œè¿‡æ»¤å™¨
- å­¦ä¹ Ansible Tower/AWXçš„ä¼ä¸šçº§ç®¡ç†
- äº†è§£Ansible Collectionsçš„ç°ä»£åŒ–ç®¡ç†æ–¹å¼

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- é«˜çº§åŠŸèƒ½è®©Ansibleæ›´å¼ºå¤§æ›´çµæ´»
- æ¡ä»¶æ‰§è¡Œå’Œå§”æ‰˜æ˜¯æ™ºèƒ½è¿ç»´çš„åŸºç¡€
- åŠ¨æ€åŠ è½½å’Œè§’è‰²ä¾èµ–å®ç°é…ç½®ç®¡ç†çš„å·¥ç¨‹åŒ–
- è‡ªå®šä¹‰æ‰©å±•æ»¡è¶³ç‰¹æ®Šä¸šåŠ¡éœ€æ±‚ï¼Œä½†è¦è°¨æ…ä½¿ç”¨