---
title: 2ã€æ’ä»¶å¼€å‘è¯¦è§£
---
## ğŸ“š ç›®å½•

1. [Ansibleæ’ä»¶ä½“ç³»æ¦‚è¿°](#1-Ansibleæ’ä»¶ä½“ç³»æ¦‚è¿°)
2. [æ’ä»¶ç±»å‹è¯¦è§£](#2-æ’ä»¶ç±»å‹è¯¦è§£)
3. [Actionæ’ä»¶å¼€å‘](#3-Actionæ’ä»¶å¼€å‘)
4. [Callbackæ’ä»¶å¼€å‘](#4-Callbackæ’ä»¶å¼€å‘)
5. [Connectionæ’ä»¶å¼€å‘](#5-Connectionæ’ä»¶å¼€å‘)
6. [Filteræ’ä»¶å¼€å‘](#6-Filteræ’ä»¶å¼€å‘)
7. [Lookupæ’ä»¶å¼€å‘](#7-Lookupæ’ä»¶å¼€å‘)
8. [æ’ä»¶å¼€å‘æµç¨‹](#8-æ’ä»¶å¼€å‘æµç¨‹)
9. [æ’ä»¶å®‰è£…éƒ¨ç½²](#9-æ’ä»¶å®‰è£…éƒ¨ç½²)
10. [æ’ä»¶æµ‹è¯•ç­–ç•¥](#10-æ’ä»¶æµ‹è¯•ç­–ç•¥)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”Œ Ansibleæ’ä»¶ä½“ç³»æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯Ansibleæ’ä»¶


**ğŸ”¸ æ’ä»¶æœ¬è´¨**
```
æ’ä»¶å°±æ˜¯æ‰©å±•AnsibleåŠŸèƒ½çš„Pythonæ¨¡å—
ä½œç”¨ï¼šä¸ºAnsibleæ·»åŠ æ–°çš„èƒ½åŠ›å’Œç‰¹æ€§
ä½ç½®ï¼šæ’ä»¶æ˜¯Ansibleæ¶æ„ä¸­çš„"å¯æ’æ‹”ç»„ä»¶"
```

**ğŸ’¡ é€šä¿—ç†è§£**
> æŠŠAnsibleæƒ³è±¡æˆä¸€ä¸ªæ™ºèƒ½æ‰‹æœºï¼Œæ’ä»¶å°±æ˜¯å„ç§APPåº”ç”¨
> - åŸç”ŸåŠŸèƒ½ï¼šæ‰“ç”µè¯ã€å‘çŸ­ä¿¡ï¼ˆåŸºç¡€æ¨¡å—ï¼‰
> - æ‰©å±•åŠŸèƒ½ï¼šå¾®ä¿¡ã€æ”¯ä»˜å®ï¼ˆè‡ªå®šä¹‰æ’ä»¶ï¼‰
> - æ’ä»¶è®©Ansibleå˜å¾—æ›´å¼ºå¤§ã€æ›´çµæ´»

### 1.2 æ’ä»¶ä¸æ¨¡å—çš„åŒºåˆ«


**ğŸ†š æ ¸å¿ƒåŒºåˆ«å¯¹æ¯”**

| ç»´åº¦ | **æ¨¡å—(Module)** | **æ’ä»¶(Plugin)** |
|------|------------------|------------------|
| ğŸ¯ **ä½œç”¨** | æ‰§è¡Œå…·ä½“ä»»åŠ¡ | æ‰©å±•æ ¸å¿ƒåŠŸèƒ½ |
| ğŸ“ **ä½ç½®** | åœ¨è¢«ç®¡èŠ‚ç‚¹è¿è¡Œ | åœ¨æ§åˆ¶èŠ‚ç‚¹è¿è¡Œ |
| ğŸ”„ **è°ƒç”¨** | playbookä¸­ç›´æ¥è°ƒç”¨ | æ¡†æ¶å†…éƒ¨è°ƒç”¨ |
| ğŸ“ **ç¤ºä¾‹** | `copy`ã€`service` | `callback`ã€`filter` |

**ğŸ§  è®°å¿†æŠ€å·§**
```
æ¨¡å— = å¹²æ´»çš„å·¥äººï¼ˆæ‰§è¡Œä»»åŠ¡ï¼‰
æ’ä»¶ = ç®¡ç†å·¥å…·ï¼ˆå¢å¼ºèƒ½åŠ›ï¼‰
```

### 1.3 æ’ä»¶çš„å·¥ä½œåŸç†


**ğŸ”„ æ’ä»¶å·¥ä½œæµç¨‹**
```
Ansibleå¯åŠ¨
     â†“
 åŠ è½½æ’ä»¶ç›®å½•
     â†“
 æ³¨å†Œæ’ä»¶ç±»å‹
     â†“  
 æ‰§è¡Œè¿‡ç¨‹ä¸­è°ƒç”¨æ’ä»¶
     â†“
 æ’ä»¶å¤„ç†å¹¶è¿”å›ç»“æœ
```

---

## 2. ğŸ·ï¸ æ’ä»¶ç±»å‹è¯¦è§£


### 2.1 æ’ä»¶åˆ†ç±»æ€»è§ˆ


**ğŸ“Š ä¸»è¦æ’ä»¶ç±»å‹**

| æ’ä»¶ç±»å‹ | **åŠŸèƒ½è¯´æ˜** | **ä½¿ç”¨åœºæ™¯** | **é‡è¦ç¨‹åº¦** |
|---------|-------------|-------------|-------------|
| ğŸ¬ **Action** | æ§åˆ¶ä»»åŠ¡æ‰§è¡Œé€»è¾‘ | å¤æ‚ä»»åŠ¡å¤„ç† | â­â­â­ |
| ğŸ“ **Callback** | å¤„ç†æ‰§è¡Œç»“æœ | æ—¥å¿—ã€é€šçŸ¥ã€æŠ¥å‘Š | â­â­â­ |
| ğŸ”— **Connection** | è¿æ¥ç›®æ ‡ä¸»æœº | ç‰¹æ®Šè¿æ¥æ–¹å¼ | â­â­ |
| ğŸ”§ **Filter** | æ•°æ®è¿‡æ»¤å¤„ç† | æ¨¡æ¿æ•°æ®å¤„ç† | â­â­â­ |
| ğŸ” **Lookup** | å¤–éƒ¨æ•°æ®æŸ¥è¯¢ | è·å–é…ç½®æ•°æ® | â­â­ |
| ğŸ“¦ **Vars** | å˜é‡è·å– | åŠ¨æ€å˜é‡åŠ è½½ | â­ |

### 2.2 æ’ä»¶é€‰æ‹©æŒ‡å—


**ğŸ¯ é€‰æ‹©åŸåˆ™**

```
ğŸ”¸ éœ€è¦ä¿®æ”¹ä»»åŠ¡æ‰§è¡Œé€»è¾‘ â†’ Actionæ’ä»¶
ğŸ”¸ éœ€è¦å¤„ç†æ‰§è¡Œç»“æœ     â†’ Callbackæ’ä»¶  
ğŸ”¸ éœ€è¦æ•°æ®è½¬æ¢å¤„ç†     â†’ Filteræ’ä»¶
ğŸ”¸ éœ€è¦è·å–å¤–éƒ¨æ•°æ®     â†’ Lookupæ’ä»¶
ğŸ”¸ éœ€è¦ç‰¹æ®Šè¿æ¥æ–¹å¼     â†’ Connectionæ’ä»¶
```

---

## 3. ğŸ¬ Actionæ’ä»¶å¼€å‘


### 3.1 Actionæ’ä»¶æ¦‚å¿µ


**ğŸ”¸ Actionæ’ä»¶ä½œç”¨**
```
å®šä½ï¼šæ§åˆ¶ä»»åŠ¡åœ¨æ§åˆ¶èŠ‚ç‚¹çš„æ‰§è¡Œé€»è¾‘
æ—¶æœºï¼šåœ¨æ¨¡å—æ‰§è¡Œå‰/åè¿›è¡Œé¢„å¤„ç†/åå¤„ç†
ç”¨é€”ï¼šå¤æ‚çš„é€»è¾‘æ§åˆ¶ã€å‚æ•°å¤„ç†ã€æ¡ä»¶åˆ¤æ–­
```

**ğŸ’¼ å…¸å‹åº”ç”¨åœºæ™¯**
- æ–‡ä»¶ä¸Šä¼ å‰çš„é¢„å¤„ç†
- å¤æ‚çš„æ¡ä»¶åˆ¤æ–­é€»è¾‘
- ä¸å¤šä¸ªæ¨¡å—çš„åè°ƒæ‰§è¡Œ

### 3.2 Actionæ’ä»¶å¼€å‘å®æˆ˜


**ğŸ“ åŸºç¡€ç»“æ„**
```python
from ansible.plugins.action import ActionBase
from ansible.errors import AnsibleError

class ActionModule(ActionBase):
    def run(self, tmp=None, task_vars=None):
        # è°ƒç”¨çˆ¶ç±»åˆå§‹åŒ–
        super(ActionModule, self).run(tmp, task_vars)
        
        # è·å–ä»»åŠ¡å‚æ•°
        args = self._task.args
        source = args.get('src', None)
        
        # ä¸šåŠ¡é€»è¾‘å¤„ç†
        if not source:
            return {'failed': True, 'msg': 'å¿…é¡»æä¾›srcå‚æ•°'}
            
        # æ‰§è¡Œç»“æœ
        return {
            'changed': False,
            'msg': 'å¤„ç†å®Œæˆ',
            'result': processed_data
        }
```

**ğŸ”§ å®é™…ç¤ºä¾‹ï¼šæ–‡ä»¶é¢„å¤„ç†æ’ä»¶**
```python
class ActionModule(ActionBase):
    def run(self, tmp=None, task_vars=None):
        result = super(ActionModule, self).run(tmp, task_vars)
        
        # è·å–æºæ–‡ä»¶è·¯å¾„
        src_file = self._task.args.get('src')
        dest_file = self._task.args.get('dest', '/tmp/processed')
        
        # åœ¨æ§åˆ¶èŠ‚ç‚¹å¤„ç†æ–‡ä»¶
        try:
            with open(src_file, 'r') as f:
                content = f.read()
                # æ·»åŠ æ—¶é—´æˆ³
                processed = f"# å¤„ç†æ—¶é—´: {datetime.now()}\n{content}"
                
            # å†™å…¥ä¸´æ—¶æ–‡ä»¶
            with open('/tmp/temp_processed', 'w') as f:
                f.write(processed)
                
            # è°ƒç”¨copyæ¨¡å—ä¼ è¾“æ–‡ä»¶
            copy_result = self._execute_module(
                module_name='copy',
                module_args={
                    'src': '/tmp/temp_processed',
                    'dest': dest_file
                },
                task_vars=task_vars
            )
            
            return copy_result
            
        except Exception as e:
            return {'failed': True, 'msg': str(e)}
```

---

## 4. ğŸ“ Callbackæ’ä»¶å¼€å‘


### 4.1 Callbackæ’ä»¶æ¦‚å¿µ


**ğŸ”¸ Callbackæ’ä»¶ä½œç”¨**
```
å®šä½ï¼šå¤„ç†Ansibleæ‰§è¡Œè¿‡ç¨‹ä¸­çš„å„ç§äº‹ä»¶
æ—¶æœºï¼šä»»åŠ¡å¼€å§‹ã€ç»“æŸã€å¤±è´¥ç­‰å…³é”®èŠ‚ç‚¹
ç”¨é€”ï¼šæ—¥å¿—è®°å½•ã€é€šçŸ¥å‘é€ã€æŠ¥å‘Šç”Ÿæˆ
```

**ğŸ“± å®é™…åº”ç”¨åœºæ™¯**
- å‘é€é’‰é’‰/å¾®ä¿¡é€šçŸ¥
- ç”ŸæˆHTMLæ‰§è¡ŒæŠ¥å‘Š
- è®°å½•è¯¦ç»†çš„å®¡è®¡æ—¥å¿—

### 4.2 Callbackæ’ä»¶å¼€å‘å®æˆ˜


**ğŸ“ åŸºç¡€ç»“æ„**
```python
from ansible.plugins.callback import CallbackBase
import json

class CallbackModule(CallbackBase):
    CALLBACK_VERSION = 2.0
    CALLBACK_TYPE = 'notification'
    CALLBACK_NAME = 'custom_notify'
    
    def v2_playbook_on_start(self, playbook):
        """Playbookå¼€å§‹æ‰§è¡Œ"""
        pass
        
    def v2_runner_on_ok(self, result):
        """ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ"""
        pass
        
    def v2_runner_on_failed(self, result, ignore_errors=False):
        """ä»»åŠ¡æ‰§è¡Œå¤±è´¥"""  
        pass
```

**ğŸ”§ å®é™…ç¤ºä¾‹ï¼šé’‰é’‰é€šçŸ¥æ’ä»¶**
```python
import requests
import json

class CallbackModule(CallbackBase):
    CALLBACK_VERSION = 2.0
    CALLBACK_TYPE = 'notification'
    CALLBACK_NAME = 'dingtalk_notify'
    
    def __init__(self):
        super(CallbackModule, self).__init__()
        self.webhook_url = "https://oapi.dingtalk.com/robot/send?access_token=YOUR_TOKEN"
        self.failed_tasks = []
    
    def v2_runner_on_failed(self, result, ignore_errors=False):
        """ä»»åŠ¡å¤±è´¥æ—¶è®°å½•"""
        task_name = result._task.get_name()
        host = result._host.get_name()
        error_msg = result._result.get('msg', 'æœªçŸ¥é”™è¯¯')
        
        self.failed_tasks.append({
            'host': host,
            'task': task_name,
            'error': error_msg
        })
    
    def v2_playbook_on_stats(self, stats):
        """Playbookæ‰§è¡Œå®Œæˆï¼Œå‘é€æ±‡æ€»é€šçŸ¥"""
        if self.failed_tasks:
            message = f"âš ï¸ Ansibleæ‰§è¡Œå‘ç°{len(self.failed_tasks)}ä¸ªå¤±è´¥ä»»åŠ¡:\n"
            for task in self.failed_tasks:
                message += f"â€¢ {task['host']}: {task['task']} - {task['error']}\n"
        else:
            message = "âœ… Ansibleæ‰§è¡ŒæˆåŠŸï¼Œæ‰€æœ‰ä»»åŠ¡æ­£å¸¸å®Œæˆ"
            
        # å‘é€é’‰é’‰é€šçŸ¥
        self._send_dingtalk(message)
    
    def _send_dingtalk(self, message):
        """å‘é€é’‰é’‰æ¶ˆæ¯"""
        payload = {
            "msgtype": "text",
            "text": {"content": message}
        }
        requests.post(self.webhook_url, data=json.dumps(payload))
```

---

## 5. ğŸ”— Connectionæ’ä»¶å¼€å‘


### 5.1 Connectionæ’ä»¶æ¦‚å¿µ


**ğŸ”¸ Connectionæ’ä»¶ä½œç”¨**
```
å®šä½ï¼šå®šä¹‰Ansibleå¦‚ä½•è¿æ¥åˆ°ç›®æ ‡ä¸»æœº
ä½œç”¨ï¼šæ”¯æŒç‰¹æ®Šçš„è¿æ¥åè®®æˆ–æ–¹å¼
å†…ç½®ï¼šssh, winrm, local, dockerç­‰
```

**ğŸŒ åº”ç”¨åœºæ™¯**
- é€šè¿‡è·³æ¿æœºè¿æ¥
- å®¹å™¨å†…æ‰§è¡Œå‘½ä»¤
- äº‘å¹³å°APIè°ƒç”¨

### 5.2 Connectionæ’ä»¶å¼€å‘è¦ç‚¹


**ğŸ“ æ ¸å¿ƒæ–¹æ³•**
```python
from ansible.plugins.connection import ConnectionBase

class Connection(ConnectionBase):
    transport = 'custom'  # è¿æ¥ç±»å‹åç§°
    
    def _connect(self):
        """å»ºç«‹è¿æ¥"""
        pass
        
    def exec_command(self, cmd, in_data=None, sudoable=True):
        """æ‰§è¡Œå‘½ä»¤"""
        pass
        
    def put_file(self, in_path, out_path):
        """ä¸Šä¼ æ–‡ä»¶"""
        pass
        
    def fetch_file(self, in_path, out_path):
        """ä¸‹è½½æ–‡ä»¶"""
        pass
        
    def close(self):
        """å…³é—­è¿æ¥"""
        pass
```

---

## 6. ğŸ”§ Filteræ’ä»¶å¼€å‘


### 6.1 Filteræ’ä»¶æ¦‚å¿µ


**ğŸ”¸ Filteræ’ä»¶ä½œç”¨**
```
å®šä½ï¼šåœ¨Jinja2æ¨¡æ¿ä¸­è¿›è¡Œæ•°æ®è¿‡æ»¤å’Œè½¬æ¢
è¯­æ³•ï¼š{{ variable | filter_name }}
ç”¨é€”ï¼šæ ¼å¼åŒ–è¾“å‡ºã€æ•°æ®è®¡ç®—ã€å­—ç¬¦ä¸²å¤„ç†
```

**ğŸ“Š å†…ç½®filterç¤ºä¾‹**
```yaml
# æ—¥æœŸæ ¼å¼åŒ–
"{{ ansible_date_time.date | strftime('%Yå¹´%mæœˆ%dæ—¥') }}"

# åˆ—è¡¨å¤„ç†  
"{{ users | map(attribute='name') | list }}"

# å­—ç¬¦ä¸²å¤„ç†
"{{ server_name | upper | replace('-', '_') }}"
```

### 6.2 Filteræ’ä»¶å¼€å‘å®æˆ˜


**ğŸ“ åŸºç¡€ç»“æ„**
```python
def custom_filter(value, arg1=None, arg2=None):
    """è‡ªå®šä¹‰è¿‡æ»¤å™¨å‡½æ•°"""
    # å¤„ç†é€»è¾‘
    return processed_value

class FilterModule(object):
    def filters(self):
        return {
            'custom_filter': custom_filter,
            'another_filter': another_filter_func
        }
```

**ğŸ”§ å®é™…ç¤ºä¾‹ï¼šå®ç”¨Filteræ’ä»¶**
```python
import re
from datetime import datetime

def format_bytes(bytes_value):
    """å­—èŠ‚æ•°æ ¼å¼åŒ–"""
    bytes_value = int(bytes_value)
    for unit in ['B', 'KB', 'MB', 'GB', 'TB']:
        if bytes_value < 1024:
            return f"{bytes_value:.1f}{unit}"
        bytes_value /= 1024
    return f"{bytes_value:.1f}PB"

def mask_sensitive(value, mask_char='*', show_chars=2):
    """æ•æ„Ÿä¿¡æ¯è„±æ•"""
    if len(value) <= show_chars * 2:
        return mask_char * len(value)
    return value[:show_chars] + mask_char * (len(value) - show_chars * 2) + value[-show_chars:]

def parse_version(version_string):
    """ç‰ˆæœ¬å·è§£æ"""
    match = re.match(r'(\d+)\.(\d+)\.(\d+)', version_string)
    if match:
        return {
            'major': int(match.group(1)),
            'minor': int(match.group(2)), 
            'patch': int(match.group(3))
        }
    return None

class FilterModule(object):
    def filters(self):
        return {
            'format_bytes': format_bytes,
            'mask_sensitive': mask_sensitive,
            'parse_version': parse_version
        }
```

**ğŸ¯ ä½¿ç”¨ç¤ºä¾‹**
```yaml
- debug:
    msg: |
      ç£ç›˜ç©ºé—´: {{ ansible_mounts[0].size_total | format_bytes }}
      æ•°æ®åº“å¯†ç : {{ db_password | mask_sensitive }}
      è½¯ä»¶ç‰ˆæœ¬: {{ app_version | parse_version }}
```

---

## 7. ğŸ” Lookupæ’ä»¶å¼€å‘


### 7.1 Lookupæ’ä»¶æ¦‚å¿µ


**ğŸ”¸ Lookupæ’ä»¶ä½œç”¨**
```
å®šä½ï¼šä»å¤–éƒ¨æ•°æ®æºæŸ¥è¯¢æ•°æ®
è¯­æ³•ï¼š{{ lookup('plugin_name', 'query_string') }}
æ—¶æœºï¼šåœ¨æ§åˆ¶èŠ‚ç‚¹æ‰§è¡Œï¼Œè·å–æ•°æ®ç”¨äºåç»­ä»»åŠ¡
```

**ğŸ“‚ å†…ç½®lookupç¤ºä¾‹**
```yaml
# è¯»å–æ–‡ä»¶å†…å®¹
- debug: msg="{{ lookup('file', '/etc/hostname') }}"

# ç¯å¢ƒå˜é‡
- debug: msg="{{ lookup('env', 'HOME') }}"  

# éšæœºå¯†ç 
- debug: msg="{{ lookup('password', '/tmp/password length=12') }}"
```

### 7.2 Lookupæ’ä»¶å¼€å‘å®æˆ˜


**ğŸ“ åŸºç¡€ç»“æ„**
```python
from ansible.plugins.lookup import LookupBase

class LookupModule(LookupBase):
    def run(self, terms, variables=None, **kwargs):
        results = []
        for term in terms:
            # æŸ¥è¯¢é€»è¾‘
            result = self._query_data(term)
            results.append(result)
        return results
```

**ğŸ”§ å®é™…ç¤ºä¾‹ï¼šé…ç½®ä¸­å¿ƒæŸ¥è¯¢æ’ä»¶**
```python
import requests
from ansible.plugins.lookup import LookupBase
from ansible.errors import AnsibleError

class LookupModule(LookupBase):
    def run(self, terms, variables=None, **kwargs):
        # è·å–é…ç½®ä¸­å¿ƒåœ°å€
        config_center = kwargs.get('config_center', 'http://localhost:8080')
        namespace = kwargs.get('namespace', 'default')
        
        results = []
        for term in terms:
            try:
                # æ„é€ æŸ¥è¯¢URL
                url = f"{config_center}/api/config/{namespace}/{term}"
                
                # å‘é€æŸ¥è¯¢è¯·æ±‚
                response = requests.get(url, timeout=10)
                response.raise_for_status()
                
                # è§£æç»“æœ
                config_data = response.json()
                results.append(config_data.get('value', ''))
                
            except Exception as e:
                raise AnsibleError(f"é…ç½®æŸ¥è¯¢å¤±è´¥: {str(e)}")
                
        return results
```

**ğŸ¯ ä½¿ç”¨ç¤ºä¾‹**
```yaml
- name: è·å–æ•°æ®åº“é…ç½®
  set_fact:
    db_host: "{{ lookup('config_center', 'database.host', config_center='http://config.example.com', namespace='prod') }}"
    db_port: "{{ lookup('config_center', 'database.port', config_center='http://config.example.com', namespace='prod') }}"
```

---

## 8. âš™ï¸ æ’ä»¶å¼€å‘æµç¨‹


### 8.1 å¼€å‘ç¯å¢ƒå‡†å¤‡


**ğŸ”§ ç¯å¢ƒè¦æ±‚**
```
Pythonç‰ˆæœ¬ï¼š3.6+
Ansibleç‰ˆæœ¬ï¼šå»ºè®®2.9+
å¼€å‘å·¥å…·ï¼šIDE + Git
æµ‹è¯•ç¯å¢ƒï¼šè™šæ‹Ÿæœºæˆ–å®¹å™¨
```

### 8.2 å¼€å‘æ­¥éª¤è¯¦è§£


**ğŸ“‹ æ ‡å‡†å¼€å‘æµç¨‹**

```
ğŸ“ Step 1: éœ€æ±‚åˆ†æ
â†“ æ˜ç¡®æ’ä»¶ç±»å‹å’ŒåŠŸèƒ½éœ€æ±‚

ğŸ“ Step 2: è®¾è®¡æ¥å£  
â†“ å®šä¹‰è¾“å…¥å‚æ•°å’Œè¾“å‡ºæ ¼å¼

ğŸ“ Step 3: ç¼–å†™ä»£ç 
â†“ å®ç°æ ¸å¿ƒé€»è¾‘å’Œé”™è¯¯å¤„ç†

ğŸ“ Step 4: ç¼–å†™æµ‹è¯•
â†“ å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

ğŸ“ Step 5: æ–‡æ¡£ç¼–å†™
â†“ ä½¿ç”¨è¯´æ˜å’Œç¤ºä¾‹

ğŸ“ Step 6: æ‰“åŒ…éƒ¨ç½²
â†“ å®‰è£…é…ç½®å’ŒéªŒæ”¶æµ‹è¯•
```

### 8.3 å¼€å‘æœ€ä½³å®è·µ


**âœ… ä»£ç è´¨é‡æ ‡å‡†**
```python
# 1. å¼‚å¸¸å¤„ç†
try:
    result = risky_operation()
except SpecificException as e:
    return {'failed': True, 'msg': f'æ“ä½œå¤±è´¥: {str(e)}'}

# 2. å‚æ•°éªŒè¯
required_params = ['src', 'dest']
for param in required_params:
    if param not in self._task.args:
        return {'failed': True, 'msg': f'ç¼ºå°‘å¿…éœ€å‚æ•°: {param}'}

# 3. æ—¥å¿—è®°å½•
self._display.vvv(f'Processing file: {src_file}')
```

**ğŸ¯ æ€§èƒ½ä¼˜åŒ–æç¤º**
- é¿å…ä¸å¿…è¦çš„ç½‘ç»œè¯·æ±‚
- åˆç†ä½¿ç”¨ç¼“å­˜æœºåˆ¶
- å¼‚å¸¸æƒ…å†µå¿«é€Ÿå¤±è´¥
- èµ„æºä½¿ç”¨å®Œæ¯•ååŠæ—¶é‡Šæ”¾

---

## 9. ğŸ“¦ æ’ä»¶å®‰è£…éƒ¨ç½²


### 9.1 æ’ä»¶ç›®å½•ç»“æ„


**ğŸ“ æ ‡å‡†ç›®å½•å¸ƒå±€**
```
ansible-project/
â”œâ”€â”€ plugins/
â”‚   â”œâ”€â”€ action/
â”‚   â”‚   â””â”€â”€ custom_action.py
â”‚   â”œâ”€â”€ callback/  
â”‚   â”‚   â””â”€â”€ dingtalk_notify.py
â”‚   â”œâ”€â”€ filter/
â”‚   â”‚   â””â”€â”€ custom_filters.py
â”‚   â””â”€â”€ lookup/
â”‚       â””â”€â”€ config_center.py
â”œâ”€â”€ ansible.cfg
â””â”€â”€ playbooks/
```

### 9.2 é…ç½®æ–‡ä»¶è®¾ç½®


**âš™ï¸ ansible.cfgé…ç½®**
```ini
[defaults]
# æ’ä»¶æœç´¢è·¯å¾„
action_plugins = plugins/action
callback_plugins = plugins/callback  
filter_plugins = plugins/filter
lookup_plugins = plugins/lookup

# å¯ç”¨callbackæ’ä»¶
callbacks_enabled = dingtalk_notify
```

### 9.3 å®‰è£…æ–¹å¼å¯¹æ¯”


**ğŸ“Š ä¸åŒå®‰è£…æ–¹å¼**

| æ–¹å¼ | **é€‚ç”¨åœºæ™¯** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** |
|------|-------------|----------|----------|
| ğŸ¯ **é¡¹ç›®ç›®å½•** | å•é¡¹ç›®ä½¿ç”¨ | ç®€å•ç›´æ¥ | ä¸å¯å¤ç”¨ |
| ğŸŒ **å…¨å±€å®‰è£…** | å¤šé¡¹ç›®å…±äº« | ç»Ÿä¸€ç®¡ç† | æƒé™è¦æ±‚é«˜ |
| ğŸ“¦ **Collection** | ç”Ÿäº§ç¯å¢ƒ | ç‰ˆæœ¬ç®¡ç†å¥½ | é…ç½®å¤æ‚ |

---

## 10. ğŸ§ª æ’ä»¶æµ‹è¯•ç­–ç•¥


### 10.1 æµ‹è¯•ç±»å‹åˆ†æ


**ğŸ”¬ æµ‹è¯•å±‚çº§**
```
ğŸ”¸ å•å…ƒæµ‹è¯•ï¼šæµ‹è¯•å•ä¸ªå‡½æ•°é€»è¾‘
ğŸ”¸ é›†æˆæµ‹è¯•ï¼šæµ‹è¯•æ’ä»¶ä¸Ansibleé›†æˆ
ğŸ”¸ åŠŸèƒ½æµ‹è¯•ï¼šæµ‹è¯•å®Œæ•´ä¸šåŠ¡åœºæ™¯
ğŸ”¸ æ€§èƒ½æµ‹è¯•ï¼šæµ‹è¯•æ‰§è¡Œæ•ˆç‡å’Œèµ„æºå ç”¨
```

### 10.2 æµ‹è¯•æ–¹æ³•å®è·µ


**ğŸ“ å•å…ƒæµ‹è¯•ç¤ºä¾‹**
```python
import unittest
from unittest.mock import patch, MagicMock
from plugins.filter.custom_filters import format_bytes

class TestCustomFilters(unittest.TestCase):
    def test_format_bytes(self):
        """æµ‹è¯•å­—èŠ‚æ ¼å¼åŒ–"""
        self.assertEqual(format_bytes(1024), "1.0KB")
        self.assertEqual(format_bytes(1048576), "1.0MB")
        self.assertEqual(format_bytes(500), "500.0B")

    def test_format_bytes_invalid_input(self):
        """æµ‹è¯•å¼‚å¸¸è¾“å…¥"""
        with self.assertRaises(ValueError):
            format_bytes("invalid")

if __name__ == '__main__':
    unittest.main()
```

**ğŸ¯ é›†æˆæµ‹è¯•ç¤ºä¾‹**
```yaml
# test_playbook.yml
- name: æµ‹è¯•è‡ªå®šä¹‰æ’ä»¶
  hosts: localhost
  gather_facts: no
  tasks:
    - name: æµ‹è¯•filteræ’ä»¶
      debug:
        msg: "{{ 1024000 | format_bytes }}"
      
    - name: æµ‹è¯•lookupæ’ä»¶  
      debug:
        msg: "{{ lookup('config_center', 'test.key') }}"
```

### 10.3 è°ƒè¯•æŠ€å·§


**ğŸ› å¸¸ç”¨è°ƒè¯•æ–¹æ³•**
```python
# 1. è°ƒè¯•è¾“å‡º
self._display.vvv(f"Debug: variable = {variable}")

# 2. æ–­ç‚¹è°ƒè¯•
import pdb; pdb.set_trace()

# 3. å¼‚å¸¸æ•è·
try:
    risky_code()
except Exception as e:
    self._display.error(f"Error details: {str(e)}")
    import traceback
    traceback.print_exc()
```

**âš ï¸ å¸¸è§é—®é¢˜æ’æŸ¥**
```
â“ æ’ä»¶ä¸ç”Ÿæ•ˆ
âœ… æ£€æŸ¥è·¯å¾„é…ç½®æ˜¯å¦æ­£ç¡®

â“ å¯¼å…¥é”™è¯¯
âœ… ç¡®è®¤Pythonè·¯å¾„å’Œä¾èµ–åŒ…

â“ å‚æ•°ä¼ é€’é—®é¢˜  
âœ… éªŒè¯å‚æ•°åç§°å’Œæ•°æ®ç±»å‹

â“ æ€§èƒ½é—®é¢˜
âœ… æ·»åŠ æ€§èƒ½ç›‘æ§å’Œæ—¥å¿—
```

---

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 å¿…é¡»æŒæ¡çš„åŸºç¡€æ¦‚å¿µ


```
ğŸ”¸ æ’ä»¶vsæ¨¡å—ï¼šæ’ä»¶æ‰©å±•åŠŸèƒ½ï¼Œæ¨¡å—æ‰§è¡Œä»»åŠ¡
ğŸ”¸ æ’ä»¶åˆ†ç±»ï¼šActionã€Callbackã€Filterã€Lookupç­‰
ğŸ”¸ å¼€å‘æµç¨‹ï¼šéœ€æ±‚â†’è®¾è®¡â†’ç¼–ç â†’æµ‹è¯•â†’éƒ¨ç½²
ğŸ”¸ éƒ¨ç½²æ–¹å¼ï¼šé¡¹ç›®ç›®å½•ã€å…¨å±€å®‰è£…ã€Collection
ğŸ”¸ æµ‹è¯•ç­–ç•¥ï¼šå•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€è°ƒè¯•æŠ€å·§
```

### 11.2 å…³é”®å¼€å‘è¦ç‚¹


**ğŸ”¹ æ’ä»¶é€‰æ‹©æŒ‡å¯¼**
```
éœ€æ±‚åˆ†æï¼š
â€¢ ä¿®æ”¹æ‰§è¡Œé€»è¾‘ â†’ Actionæ’ä»¶
â€¢ å¤„ç†æ‰§è¡Œç»“æœ â†’ Callbackæ’ä»¶  
â€¢ æ•°æ®è¿‡æ»¤è½¬æ¢ â†’ Filteræ’ä»¶
â€¢ å¤–éƒ¨æ•°æ®æŸ¥è¯¢ â†’ Lookupæ’ä»¶
â€¢ ç‰¹æ®Šè¿æ¥æ–¹å¼ â†’ Connectionæ’ä»¶
```

**ğŸ”¹ å¼€å‘è´¨é‡ä¿è¯**
```
ä»£ç è§„èŒƒï¼š
â€¢ å®Œå–„çš„å¼‚å¸¸å¤„ç†
â€¢ è¯¦ç»†çš„å‚æ•°éªŒè¯  
â€¢ æ¸…æ™°çš„æ—¥å¿—è¾“å‡º
â€¢ åˆç†çš„æ€§èƒ½ä¼˜åŒ–
```

**ğŸ”¹ æµ‹è¯•éªŒè¯è¦ç‚¹**
```
æµ‹è¯•è¦†ç›–ï¼š
â€¢ æ­£å¸¸åŠŸèƒ½éªŒè¯
â€¢ å¼‚å¸¸æƒ…å†µå¤„ç†
â€¢ è¾¹ç•Œæ¡ä»¶æµ‹è¯•
â€¢ æ€§èƒ½å‹åŠ›æµ‹è¯•
```

### 11.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ’¼ é¡¹ç›®åº”ç”¨ç­–ç•¥**
- **å°å›¢é˜Ÿ**ï¼šä½¿ç”¨é¡¹ç›®ç›®å½•æ–¹å¼ï¼Œç®€å•ç›´æ¥
- **ä¸­å¤§å‹å›¢é˜Ÿ**ï¼šå¼€å‘Collectionï¼Œç»Ÿä¸€ç®¡ç†
- **ä¼ä¸šçº§**ï¼šå»ºç«‹æ’ä»¶åº“ï¼Œåˆ¶å®šå¼€å‘è§„èŒƒ

**ğŸ› ï¸ å¼€å‘æ•ˆç‡æå‡**
- å»ºç«‹æ’ä»¶æ¨¡æ¿ï¼Œå¿«é€Ÿèµ·æ­¥
- é›†æˆCI/CDï¼Œè‡ªåŠ¨åŒ–æµ‹è¯•
- å»ºç«‹æ–‡æ¡£åº“ï¼ŒçŸ¥è¯†æ²‰æ·€
- å®šæœŸcode reviewï¼Œè´¨é‡ä¿è¯

**ğŸ¯ å¸¸è§åº”ç”¨åœºæ™¯**
- **ç›‘æ§å‘Šè­¦**ï¼šCallbackæ’ä»¶å‘é€é€šçŸ¥
- **æ•°æ®å¤„ç†**ï¼šFilteræ’ä»¶æ ¼å¼åŒ–è¾“å‡º
- **é…ç½®ç®¡ç†**ï¼šLookupæ’ä»¶æŸ¥è¯¢é…ç½®ä¸­å¿ƒ
- **å¤æ‚é€»è¾‘**ï¼šActionæ’ä»¶å¤„ç†ä¸šåŠ¡æµç¨‹

**ğŸ§  æ ¸å¿ƒè®°å¿†å£è¯€**
```
æ’ä»¶æ‰©å±•æ·»åŠŸèƒ½ï¼Œäº”å¤§ç±»å‹è®°å¿ƒé—´
Actionæ§åˆ¶æ‰§è¡Œæµï¼ŒCallbackå¤„ç†ç»“æœæ˜¾  
Filterè¿‡æ»¤è½¬æ•°æ®ï¼ŒLookupæŸ¥è¯¢å¤–éƒ¨æº
å¼€å‘æµ‹è¯•ä¸èƒ½å°‘ï¼Œéƒ¨ç½²é…ç½®è¦è§„èŒƒ
```