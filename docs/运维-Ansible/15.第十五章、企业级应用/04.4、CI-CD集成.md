---
title: 4ã€CI-CDé›†æˆ
---
## ğŸ“š ç›®å½•

1. [CI/CDä¸Ansibleæ¦‚è¿°](#1-cicdä¸ansibleæ¦‚è¿°)
2. [Jenkinsé›†æˆå®æˆ˜](#2-jenkinsé›†æˆå®æˆ˜)
3. [GitLab CIæµæ°´çº¿](#3-gitlab-ciæµæ°´çº¿)
4. [GitHub Actionsé›†æˆ](#4-github-actionsé›†æˆ)
5. [ä»£ç ä»“åº“ç®¡ç†ç­–ç•¥](#5-ä»£ç ä»“åº“ç®¡ç†ç­–ç•¥)
6. [ç¯å¢ƒç®¡ç†ä¸å‘å¸ƒæµç¨‹](#6-ç¯å¢ƒç®¡ç†ä¸å‘å¸ƒæµç¨‹)
7. [ç›‘æ§å‘Šè­¦ä¸å›æ»šæœºåˆ¶](#7-ç›‘æ§å‘Šè­¦ä¸å›æ»šæœºåˆ¶)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸš€ CI/CDä¸Ansibleæ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯CI/CDé›†æˆ


**ç®€å•ç†è§£**ï¼šCI/CDå°±åƒå·¥å‚çš„æµæ°´çº¿ï¼Œä»£ç ä¸€æäº¤å°±è‡ªåŠ¨æµ‹è¯•ã€æ‰“åŒ…ã€éƒ¨ç½²ã€‚Ansibleåœ¨è¿™é‡Œæ‰®æ¼”"è‡ªåŠ¨åŒ–éƒ¨ç½²å·¥äºº"çš„è§’è‰²ã€‚

```
ä¼ ç»Ÿéƒ¨ç½²æ–¹å¼ï¼š
å¼€å‘å†™ä»£ç  â†’ æ‰‹åŠ¨æµ‹è¯• â†’ æ‰‹åŠ¨æ‰“åŒ… â†’ æ‰‹åŠ¨ä¸Šä¼ æœåŠ¡å™¨ â†’ æ‰‹åŠ¨éƒ¨ç½²

CI/CD + Ansibleæ–¹å¼ï¼š
å¼€å‘æäº¤ä»£ç  â†’ è‡ªåŠ¨æµ‹è¯• â†’ è‡ªåŠ¨æ‰“åŒ… â†’ Ansibleè‡ªåŠ¨éƒ¨ç½² â†’ è‡ªåŠ¨é€šçŸ¥
```

**ğŸ”¥ æ ¸å¿ƒä»·å€¼**ï¼š
- **æé«˜æ•ˆç‡**ï¼šä»æ‰‹åŠ¨å‡ å°æ—¶åˆ°è‡ªåŠ¨å‡ åˆ†é’Ÿ
- **å‡å°‘é”™è¯¯**ï¼šé¿å…äººå·¥æ“ä½œå¤±è¯¯
- **ç»Ÿä¸€æµç¨‹**ï¼šæ‰€æœ‰ç¯å¢ƒéƒ¨ç½²æ ‡å‡†åŒ–
- **å¿«é€Ÿå›æ»š**ï¼šå‡ºé—®é¢˜ç«‹å³æ¢å¤

### 1.2 Ansibleåœ¨CI/CDä¸­çš„è§’è‰²å®šä½


**ğŸ¯ Ansibleçš„ä¸‰å¤§ä½œç”¨**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CIé˜¶æ®µ        â”‚    â”‚   CDé˜¶æ®µ        â”‚    â”‚   è¿ç»´é˜¶æ®µ      â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ â€¢ ä»£ç æ£€æŸ¥      â”‚â”€â”€â”€â–ºâ”‚ â€¢ æœåŠ¡å™¨å‡†å¤‡    â”‚â”€â”€â”€â–ºâ”‚ â€¢ å¥åº·æ£€æŸ¥      â”‚
â”‚ â€¢ å•å…ƒæµ‹è¯•      â”‚    â”‚ â€¢ åº”ç”¨éƒ¨ç½²      â”‚    â”‚ â€¢ æ—¥å¿—æ”¶é›†      â”‚
â”‚ â€¢ æ„å»ºæ‰“åŒ…      â”‚    â”‚ â€¢ é…ç½®ç®¡ç†      â”‚    â”‚ â€¢ æ€§èƒ½ç›‘æ§      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†‘
                        Ansibleä¸»è¦å‘æŒ¥ä½œç”¨
```

### 1.3 é›†æˆæ¶æ„å…¨æ™¯å›¾


```
å¼€å‘è€… â†’ Gitä»“åº“ â†’ CI/CDå¹³å° â†’ Ansible â†’ ç›®æ ‡æœåŠ¡å™¨ç¾¤

å…·ä½“æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”   push   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  trigger  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  execute  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¼€å‘ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ Gitä»“åº“ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ CI/CDç³»ç»Ÿâ”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ Ansible â”‚
â””â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚                      â”‚
                                              â–¼                      â–¼
                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                        â”‚ æ„å»ºæµ‹è¯• â”‚           â”‚ ç›®æ ‡æœåŠ¡å™¨â”‚
                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸ”§ Jenkinsé›†æˆå®æˆ˜


### 2.1 JenkinsåŸºç¡€ç¯å¢ƒå‡†å¤‡


**ğŸ“‹ ç¯å¢ƒæ¸…å•**ï¼š
- JenkinsæœåŠ¡å™¨ï¼š`192.168.1.100`
- Ansibleæ§åˆ¶èŠ‚ç‚¹ï¼šå¯ä¸JenkinsåŒæœºæˆ–ç‹¬ç«‹
- ç›®æ ‡æœåŠ¡å™¨ç¾¤ï¼š`192.168.1.101-103`

**ğŸ”‘ å…³é”®é…ç½®æ­¥éª¤**ï¼š

**Step 1ï¸âƒ£ - å®‰è£…å¿…è¦æ’ä»¶**
```bash
# åœ¨Jenkinsç®¡ç†ç•Œé¢å®‰è£…ä»¥ä¸‹æ’ä»¶
- Ansible Plugin
- Git Plugin  
- Pipeline Plugin
- Build Timestamp Plugin
```

**Step 2ï¸âƒ£ - é…ç½®Ansibleè·¯å¾„**
```
Jenkinsç®¡ç† â†’ å…¨å±€å·¥å…·é…ç½® â†’ Ansible
åç§°: ansible
è·¯å¾„: /usr/bin/ansible-playbook
```

**Step 3ï¸âƒ£ - SSHå¯†é’¥é…ç½®**
```bash
# ç”ŸæˆJenkinsä¸“ç”¨å¯†é’¥
ssh-keygen -t rsa -f ~/.ssh/jenkins_rsa

# å°†å…¬é’¥åˆ†å‘åˆ°ç›®æ ‡æœåŠ¡å™¨
ssh-copy-id -i ~/.ssh/jenkins_rsa.pub user@192.168.1.101
```

### 2.2 Pipelineè„šæœ¬å®æˆ˜


**ğŸ’¡ å®Œæ•´çš„Jenkinsfileç¤ºä¾‹**ï¼š

```groovy
pipeline {
    agent any
    
    environment {
        ANSIBLE_HOST_KEY_CHECKING = 'False'
        DEPLOY_ENV = "${params.ENVIRONMENT}"
    }
    
    parameters {
        choice(
            name: 'ENVIRONMENT',
            choices: ['dev', 'test', 'prod'],
            description: 'é€‰æ‹©éƒ¨ç½²ç¯å¢ƒ'
        )
        booleanParam(
            name: 'SKIP_TESTS',
            defaultValue: false,
            description: 'æ˜¯å¦è·³è¿‡æµ‹è¯•'
        )
    }
    
    stages {
        stage('ğŸ“¥ ä»£ç æ£€å‡º') {
            steps {
                checkout scm
                echo "æ£€å‡ºä»£ç åˆ°: ${WORKSPACE}"
            }
        }
        
        stage('ğŸ” ä»£ç è´¨é‡æ£€æŸ¥') {
            when { not { params.SKIP_TESTS } }
            steps {
                sh '''
                    echo "æ‰§è¡Œä»£ç æ‰«æ..."
                    # å®é™…é¡¹ç›®ä¸­å¯èƒ½æ˜¯: sonar-scanner
                '''
            }
        }
        
        stage('ğŸ“¦ æ„å»ºåº”ç”¨') {
            steps {
                sh '''
                    echo "æ„å»ºåº”ç”¨åŒ…..."
                    # ç¤ºä¾‹ï¼šæ‰“åŒ…Javaåº”ç”¨
                    # mvn clean package -DskipTests
                    mkdir -p dist
                    echo "build-${BUILD_NUMBER}" > dist/version.txt
                '''
                archiveArtifacts artifacts: 'dist/**', fingerprint: true
            }
        }
        
        stage('ğŸš€ Ansibleéƒ¨ç½²') {
            steps {
                script {
                    def inventoryFile = "inventory/${DEPLOY_ENV}/hosts"
                    def playbookFile = "playbooks/deploy.yml"
                    
                    ansiblePlaybook(
                        playbook: playbookFile,
                        inventory: inventoryFile,
                        extras: "-e build_number=${BUILD_NUMBER} -e deploy_env=${DEPLOY_ENV}",
                        credentialsId: 'ansible-ssh-key'
                    )
                }
            }
        }
        
        stage('âœ… éƒ¨ç½²éªŒè¯') {
            steps {
                ansiblePlaybook(
                    playbook: 'playbooks/verify.yml',
                    inventory: "inventory/${DEPLOY_ENV}/hosts",
                    extras: "-e deploy_env=${DEPLOY_ENV}"
                )
            }
        }
    }
    
    post {
        success {
            echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼ç¯å¢ƒ: ${DEPLOY_ENV}"
            // å‘é€æˆåŠŸé€šçŸ¥
        }
        failure {
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
            // å‘é€å¤±è´¥é€šçŸ¥ï¼Œå¯èƒ½è§¦å‘å›æ»š
        }
    }
}
```

### 2.3 å¤šç¯å¢ƒç®¡ç†ç­–ç•¥


**ğŸ—ï¸ ç›®å½•ç»“æ„è®¾è®¡**ï¼š

```
jenkins-ansible-project/
â”œâ”€â”€ Jenkinsfile                    # Pipelineè„šæœ¬
â”œâ”€â”€ inventory/                     # ç¯å¢ƒæ¸…å•
â”‚   â”œâ”€â”€ dev/
â”‚   â”‚   â”œâ”€â”€ hosts                 # å¼€å‘ç¯å¢ƒä¸»æœº
â”‚   â”‚   â””â”€â”€ group_vars/
â”‚   â”œâ”€â”€ test/
â”‚   â”‚   â”œâ”€â”€ hosts                 # æµ‹è¯•ç¯å¢ƒä¸»æœº
â”‚   â”‚   â””â”€â”€ group_vars/
â”‚   â””â”€â”€ prod/
â”‚       â”œâ”€â”€ hosts                 # ç”Ÿäº§ç¯å¢ƒä¸»æœº
â”‚       â””â”€â”€ group_vars/
â”œâ”€â”€ playbooks/
â”‚   â”œâ”€â”€ deploy.yml                # éƒ¨ç½²ä¸»é€»è¾‘
â”‚   â”œâ”€â”€ verify.yml                # éƒ¨ç½²éªŒè¯
â”‚   â””â”€â”€ rollback.yml              # å›æ»šé€»è¾‘
â””â”€â”€ roles/
    â”œâ”€â”€ app-deploy/               # åº”ç”¨éƒ¨ç½²è§’è‰²
    â””â”€â”€ health-check/             # å¥åº·æ£€æŸ¥è§’è‰²
```

**ğŸ“Š ç¯å¢ƒå·®å¼‚åŒ–é…ç½®**ï¼š

| ç¯å¢ƒ | **éƒ¨ç½²ç­–ç•¥** | **éªŒè¯çº§åˆ«** | **å®¡æ‰¹è¦æ±‚** | **å›æ»šç­–ç•¥** |
|------|------------|------------|------------|------------|
| `ğŸŸ¢ Dev` | `ç›´æ¥éƒ¨ç½²` | `åŸºç¡€æ£€æŸ¥` | `æ— éœ€å®¡æ‰¹` | `å¿«é€Ÿå›æ»š` |
| `ğŸŸ¡ Test` | `è“ç»¿éƒ¨ç½²` | `å®Œæ•´æµ‹è¯•` | `æŠ€æœ¯å®¡æ‰¹` | `è‡ªåŠ¨å›æ»š` |
| `ğŸ”´ Prod` | `æ»šåŠ¨æ›´æ–°` | `å…¨é¢ç›‘æ§` | `ä¸šåŠ¡å®¡æ‰¹` | `æ‰‹åŠ¨ç¡®è®¤` |

---

## 3. ğŸ¦Š GitLab CIæµæ°´çº¿


### 3.1 GitLab CIåŸºç¡€æ¦‚å¿µ


**ğŸ¯ æ ¸å¿ƒæ¦‚å¿µè§£é‡Š**ï¼š

**Runnerï¼ˆæ‰§è¡Œå™¨ï¼‰**ï¼šå°±åƒæ˜¯ä¸“é—¨å¹²æ´»çš„"å·¥äºº"ï¼Œå¯ä»¥æ˜¯Dockerå®¹å™¨ã€è™šæ‹Ÿæœºæˆ–ç‰©ç†æœºã€‚

**Pipelineï¼ˆæµæ°´çº¿ï¼‰**ï¼šå°±åƒå·¥å‚çš„è£…é…çº¿ï¼Œä»£ç ä»æäº¤åˆ°éƒ¨ç½²çš„æ•´ä¸ªæµç¨‹ã€‚

**Jobï¼ˆä½œä¸šï¼‰**ï¼šæµæ°´çº¿ä¸­çš„å…·ä½“ä»»åŠ¡ï¼Œæ¯”å¦‚"æµ‹è¯•ä»£ç "ã€"æ‰“åŒ…åº”ç”¨"ã€"éƒ¨ç½²æœåŠ¡"ã€‚

**Stageï¼ˆé˜¶æ®µï¼‰**ï¼šæŠŠç›¸å…³çš„Jobå½’ä¸ºä¸€ç»„ï¼Œæ¯”å¦‚"æ„å»ºé˜¶æ®µ"ã€"æµ‹è¯•é˜¶æ®µ"ã€"éƒ¨ç½²é˜¶æ®µ"ã€‚

### 3.2 .gitlab-ci.ymlé…ç½®è¯¦è§£


**ğŸ’¡ å®Œæ•´é…ç½®ç¤ºä¾‹**ï¼š

```yaml
# GitLab CIé…ç½®æ–‡ä»¶
variables:
  ANSIBLE_HOST_KEY_CHECKING: "false"
  DOCKER_DRIVER: overlay2

# å®šä¹‰æµæ°´çº¿é˜¶æ®µ
stages:
  - build
  - test
  - deploy-dev
  - deploy-test  
  - deploy-prod

# ğŸ—ï¸ æ„å»ºé˜¶æ®µ
build-job:
  stage: build
  image: maven:3.8-openjdk-11
  script:
    - echo "ğŸ”¨ å¼€å§‹æ„å»ºåº”ç”¨..."
    - mvn clean compile
    - mvn package -DskipTests
  artifacts:
    paths:
      - target/*.jar
    expire_in: 1 hour
  only:
    - main
    - develop

# ğŸ§ª æµ‹è¯•é˜¶æ®µ  
test-job:
  stage: test
  image: maven:3.8-openjdk-11
  script:
    - echo "ğŸ” æ‰§è¡Œå•å…ƒæµ‹è¯•..."
    - mvn test
  coverage: '/Code coverage: \d+\.\d+%/'
  artifacts:
    reports:
      junit: target/surefire-reports/TEST-*.xml

# ğŸš€ å¼€å‘ç¯å¢ƒéƒ¨ç½²
deploy-dev:
  stage: deploy-dev
  image: registry.gitlab.com/gitlab-org/cloud-deploy/aws-base:latest
  before_script:
    - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh && chmod 700 ~/.ssh
    - ssh-keyscan -H $DEV_SERVER >> ~/.ssh/known_hosts
  script:
    - echo "ğŸŒ± éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ..."
    - |
      ansible-playbook \
        -i inventory/dev/hosts \
        -e "build_version=$CI_PIPELINE_ID" \
        -e "git_commit=$CI_COMMIT_SHA" \
        playbooks/deploy.yml
  environment:
    name: development
    url: https://dev.example.com
  only:
    - develop

# ğŸ§ª æµ‹è¯•ç¯å¢ƒéƒ¨ç½²ï¼ˆéœ€è¦æ‰‹åŠ¨è§¦å‘ï¼‰
deploy-test:
  stage: deploy-test
  image: registry.gitlab.com/gitlab-org/cloud-deploy/aws-base:latest
  script:
    - echo "ğŸ”¬ éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ..."
    - |
      ansible-playbook \
        -i inventory/test/hosts \
        -e "build_version=$CI_PIPELINE_ID" \
        -e "deploy_strategy=blue_green" \
        playbooks/deploy.yml
  environment:
    name: testing
    url: https://test.example.com
  when: manual  # æ‰‹åŠ¨è§¦å‘
  only:
    - main

# ğŸ­ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ï¼ˆéœ€è¦å®¡æ‰¹ï¼‰
deploy-prod:
  stage: deploy-prod
  image: registry.gitlab.com/gitlab-org/cloud-deploy/aws-base:latest
  script:
    - echo "ğŸ­ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."
    - |
      ansible-playbook \
        -i inventory/prod/hosts \
        -e "build_version=$CI_PIPELINE_ID" \
        -e "deploy_strategy=rolling_update" \
        -e "health_check_timeout=300" \
        playbooks/deploy.yml
  environment:
    name: production
    url: https://prod.example.com
  when: manual
  allow_failure: false
  only:
    - main
  # ç”Ÿäº§éƒ¨ç½²å‰çš„é¢å¤–æ£€æŸ¥
  before_script:
    - echo "ğŸ”’ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰æ£€æŸ¥..."
    - ansible all -i inventory/prod/hosts -m ping
```

### 3.3 ç¯å¢ƒéš”ç¦»ä¸å®‰å…¨


**ğŸ” å¯†é’¥ç®¡ç†ç­–ç•¥**ï¼š

```
GitLabé¡¹ç›®è®¾ç½® â†’ CI/CD â†’ Variables

ç”Ÿäº§ç¯å¢ƒå¯†é’¥ï¼ˆä»…ä¸»åˆ†æ”¯å¯ç”¨ï¼‰ï¼š
â”œâ”€â”€ PROD_SSH_KEY          # ç”Ÿäº§æœåŠ¡å™¨SSHç§é’¥
â”œâ”€â”€ PROD_DB_PASSWORD      # ç”Ÿäº§æ•°æ®åº“å¯†ç 
â”œâ”€â”€ PROD_API_TOKEN        # ç”Ÿäº§APIè®¿é—®ä»¤ç‰Œ
â””â”€â”€ PROD_DEPLOY_KEY       # ç”Ÿäº§éƒ¨ç½²ä¸“ç”¨å¯†é’¥

æµ‹è¯•ç¯å¢ƒå¯†é’¥ï¼ˆä¿æŠ¤åˆ†æ”¯å¯ç”¨ï¼‰ï¼š
â”œâ”€â”€ TEST_SSH_KEY          # æµ‹è¯•æœåŠ¡å™¨SSHç§é’¥
â”œâ”€â”€ TEST_DB_PASSWORD      # æµ‹è¯•æ•°æ®åº“å¯†ç 
â””â”€â”€ TEST_API_TOKEN        # æµ‹è¯•APIè®¿é—®ä»¤ç‰Œ
```

**âš¡ æå‡æ€§èƒ½çš„æŠ€å·§**ï¼š

```yaml
# ç¼“å­˜ä¼˜åŒ–
cache:
  paths:
    - .m2/repository/        # Mavenä¾èµ–ç¼“å­˜
    - node_modules/          # npmä¾èµ–ç¼“å­˜
    - venv/                  # Pythonè™šæ‹Ÿç¯å¢ƒç¼“å­˜

# å¹¶è¡Œæ‰§è¡Œ
test-unit:
  stage: test
  parallel: 4              # å¹¶è¡Œæ‰§è¡Œ4ä¸ªå®ä¾‹
  script:
    - mvn test -Dtest.groups=unit

# æ¡ä»¶æ‰§è¡Œ
deploy-hotfix:
  script:
    - ansible-playbook hotfix.yml
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^hotfix\/.*/'  # åªåœ¨çƒ­ä¿®å¤åˆ†æ”¯æ‰§è¡Œ
```

---

## 4. ğŸ™ GitHub Actionsé›†æˆ


### 4.1 GitHub Actionså·¥ä½œåŸç†


**ğŸ­ æ ¸å¿ƒæ¦‚å¿µç±»æ¯”**ï¼š

**Workflowï¼ˆå·¥ä½œæµï¼‰**ï¼šå°±åƒä¸€ä¸ªå®Œæ•´çš„"å‰§æœ¬"ï¼Œå®šä¹‰äº†ä»å¼€å§‹åˆ°ç»“æŸçš„æ‰€æœ‰è¡¨æ¼”æ­¥éª¤ã€‚

**Jobï¼ˆä½œä¸šï¼‰**ï¼šå‰§æœ¬ä¸­çš„"ä¸€åœºæˆ"ï¼Œå¯ä»¥å¹¶è¡Œæ¼”å‡ºå¤šåœºæˆã€‚

**Stepï¼ˆæ­¥éª¤ï¼‰**ï¼šä¸€åœºæˆä¸­çš„å…·ä½“"å°è¯å’ŒåŠ¨ä½œ"ã€‚

**Actionï¼ˆåŠ¨ä½œï¼‰**ï¼šå¯é‡ç”¨çš„"ç»å…¸æ¡¥æ®µ"ï¼Œåˆ«äººå†™å¥½çš„ä»£ç ç‰‡æ®µã€‚

### 4.2 å®Œæ•´å·¥ä½œæµé…ç½®


**ğŸ“ .github/workflows/deploy.yml**ï¼š

```yaml
name: ğŸš€ CI/CD with Ansible

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  ANSIBLE_HOST_KEY_CHECKING: False
  PYTHON_VERSION: 3.9

jobs:
  # ğŸ—ï¸ æ„å»ºå’Œæµ‹è¯•Job
  build-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [14.x, 16.x]
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      
    - name: ğŸ“¦ è®¾ç½®Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: ğŸ“š å®‰è£…ä¾èµ–
      run: |
        npm ci
        echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
        
    - name: ğŸ§ª è¿è¡Œæµ‹è¯•
      run: |
        npm run test:coverage
        echo "âœ… æµ‹è¯•æ‰§è¡Œå®Œæˆ"
        
    - name: ğŸ“Š ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        
    - name: ğŸ—ï¸ æ„å»ºåº”ç”¨
      run: |
        npm run build
        echo "âœ… æ„å»ºå®Œæˆï¼Œè¾“å‡ºåˆ° dist/"
        
    - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: build-files-${{ github.run_number }}
        path: dist/

  # ğŸŒ± éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ
  deploy-dev:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    environment: development
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      
    - name: ğŸ“¦ ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v3
      with:
        name: build-files-${{ github.run_number }}
        path: dist/
        
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“š å®‰è£…Ansible
      run: |
        python -m pip install --upgrade pip
        pip install ansible
        echo "âœ… Ansibleå®‰è£…å®Œæˆ"
        
    - name: ğŸ”‘ é…ç½®SSHå¯†é’¥
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.DEV_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.DEV_SERVER_IP }} >> ~/.ssh/known_hosts
        
    - name: ğŸš€ æ‰§è¡ŒAnsibleéƒ¨ç½²
      env:
        ANSIBLE_PRIVATE_KEY_FILE: ~/.ssh/id_rsa
      run: |
        echo "ğŸŒ± å¼€å§‹éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ..."
        ansible-playbook \
          -i inventory/dev/hosts \
          -e "app_version=${{ github.run_number }}" \
          -e "git_commit=${{ github.sha }}" \
          -e "deploy_env=development" \
          playbooks/deploy.yml
          
    - name: âœ… éªŒè¯éƒ¨ç½²ç»“æœ
      run: |
        echo "ğŸ” éªŒè¯å¼€å‘ç¯å¢ƒéƒ¨ç½²..."
        ansible-playbook \
          -i inventory/dev/hosts \
          playbooks/verify.yml

  # ğŸ­ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼ˆéœ€è¦å®¡æ‰¹ï¼‰
  deploy-production:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: 
      name: production
      url: https://prod.example.com
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v3
      
    - name: ğŸ” ç”Ÿäº§ç¯å¢ƒé¢„æ£€æŸ¥
      run: |
        echo "ğŸ”’ æ‰§è¡Œç”Ÿäº§ç¯å¢ƒé¢„æ£€æŸ¥..."
        # æ£€æŸ¥ç”Ÿäº§æœåŠ¡å™¨çŠ¶æ€
        # æ£€æŸ¥æ•°æ®åº“è¿æ¥
        # æ£€æŸ¥ä¾èµ–æœåŠ¡
        
    - name: ğŸ“¦ ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v3
      with:
        name: build-files-${{ github.run_number }}
        path: dist/
        
    - name: ğŸ è®¾ç½®Pythonå’ŒAnsible
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - run: |
        pip install ansible
        echo "âœ… Ansibleå‡†å¤‡å®Œæˆ"
        
    - name: ğŸ”‘ é…ç½®ç”Ÿäº§ç¯å¢ƒSSHå¯†é’¥
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.PROD_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.PROD_SERVER_IP }} >> ~/.ssh/known_hosts
        
    - name: ğŸ­ ç”Ÿäº§ç¯å¢ƒæ»šåŠ¨éƒ¨ç½²
      env:
        ANSIBLE_PRIVATE_KEY_FILE: ~/.ssh/id_rsa
      run: |
        echo "ğŸ­ å¼€å§‹æ»šåŠ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."
        ansible-playbook \
          -i inventory/prod/hosts \
          -e "app_version=${{ github.run_number }}" \
          -e "deploy_strategy=rolling" \
          -e "health_check_retries=5" \
          -e "rollback_enabled=true" \
          playbooks/deploy.yml
          
    - name: ğŸ“Š éƒ¨ç½²åç›‘æ§
      run: |
        echo "ğŸ“Š ç›‘æ§ç”Ÿäº§ç¯å¢ƒçŠ¶æ€..."
        sleep 60  # ç­‰å¾…æœåŠ¡ç¨³å®š
        ansible-playbook \
          -i inventory/prod/hosts \
          playbooks/post-deploy-check.yml
```

### 4.3 é«˜çº§åŠŸèƒ½é…ç½®


**ğŸ¯ æ¡ä»¶éƒ¨ç½²ä¸ç¯å¢ƒä¿æŠ¤**ï¼š

```yaml
# ç¯å¢ƒä¿æŠ¤è§„åˆ™ç¤ºä¾‹
environment:
  name: production
  url: https://prod.example.com
  # GitHubéœ€è¦åœ¨ä»“åº“è®¾ç½®ä¸­é…ç½®ä¿æŠ¤è§„åˆ™ï¼š
  # âœ… éœ€è¦å®¡æ‰¹è€…ç¡®è®¤
  # âœ… ç­‰å¾…è®¡æ—¶å™¨ï¼ˆæ¯”å¦‚5åˆ†é’Ÿï¼‰
  # âœ… é™åˆ¶éƒ¨ç½²åˆ†æ”¯ï¼ˆä»…mainåˆ†æ”¯ï¼‰
```

**âš¡ çŸ©é˜µç­–ç•¥å¹¶è¡Œéƒ¨ç½²**ï¼š

```yaml
deploy-multi-env:
  strategy:
    matrix:
      environment: [dev, test]
      include:
        - environment: dev
          server_ip: ${{ secrets.DEV_SERVER_IP }}
          ssh_key: ${{ secrets.DEV_SSH_KEY }}
        - environment: test
          server_ip: ${{ secrets.TEST_SERVER_IP }}
          ssh_key: ${{ secrets.TEST_SSH_KEY }}
  
  steps:
    - name: éƒ¨ç½²åˆ° ${{ matrix.environment }}
      run: |
        ansible-playbook \
          -i inventory/${{ matrix.environment }}/hosts \
          playbooks/deploy.yml
```

---

## 5. ğŸ“ ä»£ç ä»“åº“ç®¡ç†ç­–ç•¥


### 5.1 åˆ†æ”¯ç®¡ç†æ¨¡å‹


**ğŸŒ³ Git Flowåˆ†æ”¯ç­–ç•¥**ï¼š

```
ç”Ÿäº§åˆ†æ”¯ (main)     â—â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â—
                          â•±       â•±       â•±
å‘å¸ƒåˆ†æ”¯ (release)          â—â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â—
                          â•± â•²     â•± â•²
å¼€å‘åˆ†æ”¯ (develop)   â—â”€â”€â”€â”€â”€â—â”€â”€â”€â—â”€â—â”€â”€â”€â—â”€â—â”€â”€â”€â”€â”€â—
                      â•±     â•² â•±   â•² â•±     â•²
åŠŸèƒ½åˆ†æ”¯ (feature)   â—       â—     â—       â—
                    
çƒ­ä¿®å¤åˆ†æ”¯ (hotfix)                  â—â”€â”€â”€â”€â”€â—
                                    â•±       â•²
                              main â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â—
```

**ğŸ“‹ åˆ†æ”¯èŒè´£è¯´æ˜**ï¼š

| åˆ†æ”¯ç±»å‹ | **ç”¨é€”è¯´æ˜** | **åˆå¹¶ç›®æ ‡** | **è§¦å‘éƒ¨ç½²** | **ç”Ÿå‘½å‘¨æœŸ** |
|----------|------------|------------|------------|------------|
| `ğŸŸ¢ main` | `ç”Ÿäº§ç‰ˆæœ¬ï¼Œéšæ—¶å¯å‘å¸ƒ` | `æ— ï¼ˆå—ä¿æŠ¤ï¼‰` | `ç”Ÿäº§ç¯å¢ƒ` | `æ°¸ä¹…å­˜åœ¨` |
| `ğŸ”µ develop` | `å¼€å‘ä¸»çº¿ï¼ŒåŠŸèƒ½é›†æˆ` | `release/main` | `å¼€å‘ç¯å¢ƒ` | `æ°¸ä¹…å­˜åœ¨` |
| `ğŸŸ¡ feature/*` | `æ–°åŠŸèƒ½å¼€å‘` | `develop` | `æ— æˆ–ä¸ªäººç¯å¢ƒ` | `åŠŸèƒ½å®Œæˆååˆ é™¤` |
| `ğŸŸ  release/*` | `å‘å¸ƒå‡†å¤‡ï¼Œç‰ˆæœ¬æµ‹è¯•` | `main+develop` | `æµ‹è¯•ç¯å¢ƒ` | `å‘å¸ƒååˆ é™¤` |
| `ğŸ”´ hotfix/*` | `ç´§æ€¥ä¿®å¤` | `main+develop` | `ç”Ÿäº§ç¯å¢ƒ` | `ä¿®å¤ååˆ é™¤` |

### 5.2 Ansibleé¡¹ç›®ç»“æ„è§„èŒƒ


**ğŸ—ï¸ æ¨èçš„ç›®å½•ç»„ç»‡**ï¼š

```
ansible-infrastructure/
â”œâ”€â”€ .github/workflows/              # GitHub Actionså·¥ä½œæµ
â”‚   â”œâ”€â”€ ci.yml                     # æŒç»­é›†æˆæµæ°´çº¿
â”‚   â””â”€â”€ deploy.yml                 # éƒ¨ç½²æµæ°´çº¿
â”œâ”€â”€ .gitlab-ci.yml                 # GitLab CIé…ç½®
â”œâ”€â”€ Jenkinsfile                    # Jenkins Pipeline
â”œâ”€â”€ ansible.cfg                    # Ansibleé…ç½®æ–‡ä»¶
â”œâ”€â”€ requirements.yml               # Ansibleä¾èµ–ï¼ˆè§’è‰²ã€é›†åˆï¼‰
â”œâ”€â”€ inventory/                     # ç¯å¢ƒæ¸…å•
â”‚   â”œâ”€â”€ group_vars/               # ç»„å˜é‡
â”‚   â”‚   â”œâ”€â”€ all.yml              # å…¨å±€å˜é‡
â”‚   â”‚   â”œâ”€â”€ web.yml              # WebæœåŠ¡å™¨ç»„å˜é‡
â”‚   â”‚   â””â”€â”€ db.yml               # æ•°æ®åº“æœåŠ¡å™¨ç»„å˜é‡
â”‚   â”œâ”€â”€ host_vars/               # ä¸»æœºå˜é‡
â”‚   â”œâ”€â”€ dev/
â”‚   â”‚   â”œâ”€â”€ hosts.yml            # å¼€å‘ç¯å¢ƒæ¸…å•
â”‚   â”‚   â””â”€â”€ group_vars/
â”‚   â”œâ”€â”€ test/
â”‚   â”‚   â”œâ”€â”€ hosts.yml            # æµ‹è¯•ç¯å¢ƒæ¸…å•
â”‚   â”‚   â””â”€â”€ group_vars/
â”‚   â””â”€â”€ prod/
â”‚       â”œâ”€â”€ hosts.yml            # ç”Ÿäº§ç¯å¢ƒæ¸…å•
â”‚       â””â”€â”€ group_vars/
â”œâ”€â”€ playbooks/                    # å‰§æœ¬æ–‡ä»¶
â”‚   â”œâ”€â”€ site.yml                 # ä¸»å‰§æœ¬
â”‚   â”œâ”€â”€ deploy.yml               # éƒ¨ç½²å‰§æœ¬
â”‚   â”œâ”€â”€ rollback.yml             # å›æ»šå‰§æœ¬
â”‚   â””â”€â”€ maintenance.yml          # ç»´æŠ¤å‰§æœ¬
â”œâ”€â”€ roles/                       # è‡ªå®šä¹‰è§’è‰²
â”‚   â”œâ”€â”€ common/                  # é€šç”¨é…ç½®è§’è‰²
â”‚   â”œâ”€â”€ web-server/              # WebæœåŠ¡å™¨è§’è‰²
â”‚   â”œâ”€â”€ database/                # æ•°æ®åº“è§’è‰²
â”‚   â””â”€â”€ monitoring/              # ç›‘æ§è§’è‰²
â”œâ”€â”€ files/                       # é™æ€æ–‡ä»¶
â”œâ”€â”€ templates/                   # Jinja2æ¨¡æ¿æ–‡ä»¶
â””â”€â”€ scripts/                     # è¾…åŠ©è„šæœ¬
    â”œâ”€â”€ deploy.sh                # æœ¬åœ°éƒ¨ç½²è„šæœ¬
    â””â”€â”€ health-check.sh          # å¥åº·æ£€æŸ¥è„šæœ¬
```

### 5.3 é…ç½®ç®¡ç†æœ€ä½³å®è·µ


**ğŸ” æ•æ„Ÿä¿¡æ¯ç®¡ç†**ï¼š

```yaml
# ansible.cfg
[defaults]
host_key_checking = False
inventory = inventory
roles_path = roles
vault_password_file = .vault_pass  # Vaultå¯†ç æ–‡ä»¶

[privilege_escalation]
become = True
become_method = sudo
become_user = root
```

**ğŸ’¡ ç¯å¢ƒå˜é‡åˆ†ç¦»ç¤ºä¾‹**ï¼š

```yaml
# inventory/group_vars/all.yml - å…¨å±€é…ç½®
app_name: myapp
app_user: webapp
deploy_dir: /opt/{{ app_name }}

# inventory/dev/group_vars/all.yml - å¼€å‘ç¯å¢ƒ
database_host: dev-db.internal
database_name: myapp_dev
debug_mode: true
log_level: DEBUG

# inventory/prod/group_vars/all.yml - ç”Ÿäº§ç¯å¢ƒ  
database_host: prod-db.internal
database_name: myapp_prod
debug_mode: false
log_level: INFO
# æ•æ„Ÿä¿¡æ¯ä½¿ç”¨VaultåŠ å¯†
database_password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          66386439653236336464626566653863...
```

---

## 6. ğŸ—ï¸ ç¯å¢ƒç®¡ç†ä¸å‘å¸ƒæµç¨‹


### 6.1 å¤šç¯å¢ƒéƒ¨ç½²ç­–ç•¥


**ğŸ¯ ä¸åŒç¯å¢ƒçš„éƒ¨ç½²ç­–ç•¥**ï¼š

```
å¼€å‘ç¯å¢ƒ (Development):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¿«é€Ÿéƒ¨ç½²    â”‚ â†’ ç›´æ¥è¦†ç›–ï¼Œé‡å¯æœåŠ¡
â”‚ å®æ—¶è°ƒè¯•    â”‚ â†’ å¼€å¯è¯¦ç»†æ—¥å¿—ï¼Œé”™è¯¯å±•ç¤º
â”‚ åŠŸèƒ½éªŒè¯    â”‚ â†’ åŸºæœ¬å†’çƒŸæµ‹è¯•å³å¯
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æµ‹è¯•ç¯å¢ƒ (Testing):  
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è“ç»¿éƒ¨ç½²    â”‚ â†’ ä¸¤å¥—ç¯å¢ƒåˆ‡æ¢ï¼Œé›¶åœæœº
â”‚ å®Œæ•´æµ‹è¯•    â”‚ â†’ è‡ªåŠ¨åŒ–æµ‹è¯•å¥—ä»¶æ‰§è¡Œ
â”‚ æ€§èƒ½éªŒè¯    â”‚ â†’ è´Ÿè½½æµ‹è¯•å’Œæ€§èƒ½ç›‘æ§
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”Ÿäº§ç¯å¢ƒ (Production):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ»šåŠ¨æ›´æ–°    â”‚ â†’ é€å°æ›´æ–°ï¼Œä¿æŒæœåŠ¡å¯ç”¨
â”‚ é‡‘ä¸é›€å‘å¸ƒ  â”‚ â†’ å°æ¯”ä¾‹æµé‡å…ˆè¡ŒéªŒè¯
â”‚ å…¨é¢ç›‘æ§    â”‚ â†’ å®æ—¶ç›‘æ§å„é¡¹æŒ‡æ ‡
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 è“ç»¿éƒ¨ç½²å®ç°


**ğŸ’™ğŸ’š è“ç»¿éƒ¨ç½²Ansibleå®æˆ˜**ï¼š

```yaml
# playbooks/blue-green-deploy.yml
---
- name: ğŸ”„ è“ç»¿éƒ¨ç½²æµç¨‹
  hosts: web
  vars:
    current_color: "{{ hostvars['localhost']['current_color'] | default('blue') }}"
    new_color: "{{ 'green' if current_color == 'blue' else 'blue' }}"
    
  tasks:
    - name: ğŸ” æ£€æŸ¥å½“å‰è¿è¡Œç‰ˆæœ¬
      uri:
        url: "http://{{ ansible_host }}:{{ app_port }}/health"
      register: health_check
      ignore_errors: yes
      
    - name: ğŸ“¦ éƒ¨ç½²æ–°ç‰ˆæœ¬åˆ°{{ new_color }}ç¯å¢ƒ
      include_role:
        name: app-deploy
      vars:
        deploy_color: "{{ new_color }}"
        app_port: "{{ '8081' if new_color == 'green' else '8080' }}"
        
    - name: â° ç­‰å¾…æ–°ç‰ˆæœ¬å¯åŠ¨
      wait_for:
        host: "{{ ansible_host }}"
        port: "{{ '8081' if new_color == 'green' else '8080' }}"
        timeout: 120
        
    - name: ğŸ§ª æ–°ç‰ˆæœ¬å¥åº·æ£€æŸ¥
      uri:
        url: "http://{{ ansible_host }}:{{ '8081' if new_color == 'green' else '8080' }}/health"
        method: GET
      register: new_version_health
      retries: 5
      delay: 10
      
    - name: ğŸ”„ åˆ‡æ¢è´Ÿè½½å‡è¡¡å™¨æµé‡
      include_role:
        name: load-balancer
      vars:
        active_color: "{{ new_color }}"
        
    - name: â¸ï¸ åœæ­¢æ—§ç‰ˆæœ¬æœåŠ¡
      systemd:
        name: "{{ app_name }}-{{ current_color }}"
        state: stopped
      when: new_version_health is succeeded
```

### 6.3 æ»šåŠ¨æ›´æ–°ç­–ç•¥


**ğŸŒŠ æ»šåŠ¨æ›´æ–°é…ç½®**ï¼š

```yaml
# playbooks/rolling-update.yml
---
- name: ğŸŒŠ æ»šåŠ¨æ›´æ–°éƒ¨ç½²
  hosts: web
  serial: "{{ rolling_update_batch | default(1) }}"  # æ¯æ¬¡æ›´æ–°1å°
  max_fail_percentage: 25  # æœ€å¤šå…è®¸25%å¤±è´¥
  
  vars:
    health_check_url: "http://{{ ansible_host }}:{{ app_port }}/health"
    drain_timeout: 30  # æµé‡æ’ç©ºæ—¶é—´
    
  tasks:
    - name: ğŸ“Š éƒ¨ç½²å‰çŠ¶æ€æ£€æŸ¥
      uri:
        url: "{{ health_check_url }}"
      register: pre_deploy_health
      
    - name: ğŸš« ä»è´Ÿè½½å‡è¡¡å™¨ç§»é™¤èŠ‚ç‚¹
      uri:
        url: "{{ lb_api_url }}/nodes/{{ ansible_host }}/disable"
        method: POST
        headers:
          Authorization: "Bearer {{ lb_api_token }}"
          
    - name: â° ç­‰å¾…è¿æ¥æ’ç©º
      wait_for:
        timeout: "{{ drain_timeout }}"
      delegate_to: localhost
      
    - name: ğŸ“¦ éƒ¨ç½²æ–°ç‰ˆæœ¬
      include_role:
        name: app-deploy
      vars:
        app_version: "{{ target_version }}"
        
    - name: ğŸ”„ é‡å¯åº”ç”¨æœåŠ¡
      systemd:
        name: "{{ app_service_name }}"
        state: restarted
        enabled: yes
        
    - name: â° ç­‰å¾…æœåŠ¡å¯åŠ¨
      wait_for:
        host: "{{ ansible_host }}"
        port: "{{ app_port }}"
        timeout: 120
        
    - name: ğŸ§ª å¥åº·æ£€æŸ¥éªŒè¯
      uri:
        url: "{{ health_check_url }}"
        status_code: 200
      register: post_deploy_health
      retries: 10
      delay: 6
      
    - name: âœ… é‡æ–°åŠ å…¥è´Ÿè½½å‡è¡¡å™¨
      uri:
        url: "{{ lb_api_url }}/nodes/{{ ansible_host }}/enable"
        method: POST
        headers:
          Authorization: "Bearer {{ lb_api_token }}"
      when: post_deploy_health is succeeded
      
    - name: âŒ éƒ¨ç½²å¤±è´¥å¤„ç†
      fail:
        msg: "èŠ‚ç‚¹ {{ ansible_host }} éƒ¨ç½²å¤±è´¥ï¼Œåœæ­¢æ»šåŠ¨æ›´æ–°"
      when: post_deploy_health is failed
```

### 6.4 å®¡æ‰¹æµç¨‹é›†æˆ


**ğŸ”’ å¤šçº§å®¡æ‰¹æœºåˆ¶**ï¼š

| ç¯å¢ƒ | **å®¡æ‰¹çº§åˆ«** | **å®¡æ‰¹äººå‘˜** | **ç­‰å¾…æ—¶é—´** | **å®¡æ‰¹æ–¹å¼** |
|------|------------|------------|------------|------------|
| `ğŸŸ¢ Dev` | `æ— å®¡æ‰¹` | `è‡ªåŠ¨é€šè¿‡` | `0åˆ†é’Ÿ` | `ä»£ç æäº¤è‡ªåŠ¨éƒ¨ç½²` |
| `ğŸŸ¡ Test` | `æŠ€æœ¯å®¡æ‰¹` | `é¡¹ç›®æŠ€æœ¯è´Ÿè´£äºº` | `æœ€å¤š1å°æ—¶` | `GitHub/GitLabå®¡æ‰¹` |
| `ğŸ”´ Prod` | `ä¸šåŠ¡å®¡æ‰¹` | `äº§å“ç»ç†+æŠ€æœ¯ç»ç†` | `æœ€å¤š24å°æ—¶` | `é‚®ä»¶+å¹³å°åŒé‡ç¡®è®¤` |

**ğŸ“ å®¡æ‰¹æµç¨‹é…ç½®ç¤ºä¾‹**ï¼š

```yaml
# GitHub Actionsç¯å¢ƒä¿æŠ¤è§„åˆ™
environment:
  name: production
  protection_rules:
    - type: required_reviewers
      reviewers: 
        - tech-lead
        - product-manager
    - type: wait_timer  
      minutes: 5
    - type: deployment_branch_policy
      branches: [main]
```

---

## 7. ğŸ“Š ç›‘æ§å‘Šè­¦ä¸å›æ»šæœºåˆ¶


### 7.1 éƒ¨ç½²è¿‡ç¨‹ç›‘æ§


**ğŸ“ˆ å…³é”®ç›‘æ§æŒ‡æ ‡**ï¼š

```
éƒ¨ç½²è¿‡ç¨‹æŒ‡æ ‡:
â”œâ”€â”€ ğŸ“Š åŸºç¡€æŒ‡æ ‡
â”‚   â”œâ”€â”€ éƒ¨ç½²è€—æ—¶ï¼šé€šå¸¸ < 10åˆ†é’Ÿ
â”‚   â”œâ”€â”€ æˆåŠŸç‡ï¼šç›®æ ‡ > 95%
â”‚   â””â”€â”€ å›æ»šç‡ï¼šç›®æ ‡ < 5%
â”œâ”€â”€ ğŸ”§ æœåŠ¡æŒ‡æ ‡  
â”‚   â”œâ”€â”€ æœåŠ¡å¯åŠ¨æ—¶é—´ï¼š< 2åˆ†é’Ÿ
â”‚   â”œâ”€â”€ å¥åº·æ£€æŸ¥å“åº”ï¼š< 5ç§’
â”‚   â””â”€â”€ æœåŠ¡å¯ç”¨æ€§ï¼š> 99.9%
â””â”€â”€ ğŸ’» ç³»ç»ŸæŒ‡æ ‡
    â”œâ”€â”€ CPUä½¿ç”¨ç‡ï¼š< 80%
    â”œâ”€â”€ å†…å­˜ä½¿ç”¨ç‡ï¼š< 85%
    â””â”€â”€ ç£ç›˜ç©ºé—´ï¼š> 20%å‰©ä½™
```

**ğŸ”” å‘Šè­¦é…ç½®å®ç°**ï¼š

```yaml
# roles/monitoring/tasks/main.yml
- name: ğŸ“Š é…ç½®éƒ¨ç½²ç›‘æ§è„šæœ¬
  template:
    src: deploy-monitor.sh.j2
    dest: /opt/scripts/deploy-monitor.sh
    mode: '0755'

- name: ğŸ“± é…ç½®é’‰é’‰/ä¼å¾®å‘Šè­¦
  template:
    src: alert-webhook.py.j2
    dest: /opt/scripts/alert-webhook.py
    mode: '0755'
  vars:
    webhook_url: "{{ alert_webhook_url }}"
    
# templates/deploy-monitor.sh.j2
#!/bin/bash
APP_URL="{{ app_health_check_url }}"
ALERT_WEBHOOK="{{ alert_webhook_url }}"

# å¥åº·æ£€æŸ¥å‡½æ•°
check_health() {
    response=$(curl -s -o /dev/null -w "%{http_code}" "$APP_URL" --max-time 10)
    if [ "$response" = "200" ]; then
        echo "âœ… æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡"
        return 0
    else
        echo "âŒ æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥: HTTP $response"
        return 1
    fi
}

# å‘é€å‘Šè­¦
send_alert() {
    local status="$1"
    local message="$2"
    
    curl -H "Content-Type: application/json" \
         -d "{\"msgtype\":\"text\",\"text\":{\"content\":\"[$status] $message\"}}" \
         "$ALERT_WEBHOOK"
}

# æ‰§è¡Œç›‘æ§
if check_health; then
    send_alert "SUCCESS" "ğŸ‰ åº”ç”¨éƒ¨ç½²æˆåŠŸï¼ç‰ˆæœ¬: {{ app_version }}"
else
    send_alert "FAILED" "âŒ åº”ç”¨éƒ¨ç½²å¤±è´¥ï¼è¯·ç«‹å³æ£€æŸ¥æœåŠ¡çŠ¶æ€"
    exit 1
fi
```

### 7.2 è‡ªåŠ¨å›æ»šæœºåˆ¶


**âª æ™ºèƒ½å›æ»šç­–ç•¥**ï¼š

```yaml
# playbooks/smart-rollback.yml
---
- name: ğŸ”„ æ™ºèƒ½å›æ»šç³»ç»Ÿ
  hosts: web
  vars:
    rollback_threshold: 3        # è¿ç»­å¤±è´¥3æ¬¡è§¦å‘å›æ»š
    health_check_interval: 30    # å¥åº·æ£€æŸ¥é—´éš”30ç§’
    rollback_timeout: 300        # å›æ»šè¶…æ—¶5åˆ†é’Ÿ
    
  tasks:
    - name: ğŸ“Š è·å–å½“å‰éƒ¨ç½²ç‰ˆæœ¬
      slurp:
        src: /opt/{{ app_name }}/current_version
      register: current_version_file
      
    - name: ğŸ“Š è·å–ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬
      slurp:
        src: /opt/{{ app_name }}/previous_version  
      register: previous_version_file
      
    - name: ğŸ” æŒç»­å¥åº·æ£€æŸ¥
      uri:
        url: "http://{{ ansible_host }}:{{ app_port }}/health"
        status_code: 200
        timeout: 10
      register: health_result
      retries: "{{ rollback_threshold }}"
      delay: "{{ health_check_interval }}"
      ignore_errors: yes
      
    - name: ğŸš¨ è§¦å‘è‡ªåŠ¨å›æ»šæ¡ä»¶åˆ¤æ–­
      set_fact:
        should_rollback: true
      when: 
        - health_result is failed
        - previous_version_file.content is defined
        
    - name: âª æ‰§è¡Œè‡ªåŠ¨å›æ»š
      block:
        - name: ğŸ“¢ å‘é€å›æ»šå¼€å§‹é€šçŸ¥
          uri:
            url: "{{ alert_webhook_url }}"
            method: POST
            body_format: json
            body:
              msgtype: "text"
              text:
                content: "ğŸš¨ æ£€æµ‹åˆ°æœåŠ¡å¼‚å¸¸ï¼Œå¼€å§‹è‡ªåŠ¨å›æ»šåˆ°ç‰ˆæœ¬: {{ previous_version_file.content | b64decode | trim }}"
                
        - name: ğŸ”„ åœæ­¢å½“å‰æ•…éšœç‰ˆæœ¬
          systemd:
            name: "{{ app_service_name }}"
            state: stopped
            
        - name: âª æ¢å¤åˆ°ä¸Šä¸€ç‰ˆæœ¬
          include_role:
            name: app-deploy
          vars:
            app_version: "{{ previous_version_file.content | b64decode | trim }}"
            rollback_mode: true
            
        - name: ğŸ”„ é‡å¯æœåŠ¡
          systemd:
            name: "{{ app_service_name }}"
            state: restarted
            
        - name: â° ç­‰å¾…å›æ»šç‰ˆæœ¬å¯åŠ¨
          wait_for:
            host: "{{ ansible_host }}"
            port: "{{ app_port }}"
            timeout: "{{ rollback_timeout }}"
            
        - name: ğŸ§ª éªŒè¯å›æ»šç‰ˆæœ¬å¥åº·çŠ¶æ€
          uri:
            url: "http://{{ ansible_host }}:{{ app_port }}/health"
            status_code: 200
          retries: 5
          delay: 10
          
        - name: ğŸ“¢ å›æ»šæˆåŠŸé€šçŸ¥
          uri:
            url: "{{ alert_webhook_url }}"
            method: POST
            body_format: json
            body:
              msgtype: "text" 
              text:
                content: "âœ… è‡ªåŠ¨å›æ»šæˆåŠŸï¼æœåŠ¡å·²æ¢å¤åˆ°ç¨³å®šç‰ˆæœ¬: {{ previous_version_file.content | b64decode | trim }}"
                
      when: should_rollback | default(false)
      
    - name: âŒ å›æ»šå¤±è´¥åº”æ€¥å¤„ç†
      block:
        - name: ğŸš¨ å‘é€ç´§æ€¥å‘Šè­¦
          uri:
            url: "{{ alert_webhook_url }}"
            method: POST
            body_format: json
            body:
              msgtype: "text"
              text:
                content: "ğŸš¨ğŸš¨ è‡ªåŠ¨å›æ»šå¤±è´¥ï¼è¯·ç«‹å³äººå·¥ä»‹å…¥å¤„ç†ï¼æœåŠ¡å™¨: {{ ansible_host }}"
                
        - name: ğŸ“ è§¦å‘ç”µè¯å‘Šè­¦ï¼ˆå¯é€‰ï¼‰
          uri:
            url: "{{ emergency_call_api }}"
            method: POST
            body_format: json
            body:
              phone: "{{ ops_emergency_phone }}"
              message: "ç”Ÿäº§æœåŠ¡å¼‚å¸¸ä¸”è‡ªåŠ¨å›æ»šå¤±è´¥ï¼Œè¯·ç«‹å³å¤„ç†"
              
      rescue:
        - debug: msg="å›æ»šå¤±è´¥ï¼Œéœ€è¦äººå·¥ä»‹å…¥"
```

### 7.3 ç›‘æ§æ•°æ®æ”¶é›†


**ğŸ“Š å…³é”®æŒ‡æ ‡æ”¶é›†**ï¼š

```yaml
# roles/metrics-collector/tasks/main.yml
- name: ğŸ“ˆ éƒ¨ç½²Prometheusç›‘æ§
  template:
    src: prometheus.yml.j2
    dest: /etc/prometheus/prometheus.yml
  notify: restart prometheus

# templates/prometheus.yml.j2  
global:
  scrape_interval: 15s

rule_files:
  - "alert_rules.yml"

scrape_configs:
  # åº”ç”¨ç›‘æ§
  - job_name: '{{ app_name }}'
    static_configs:
      - targets: 
{% for host in groups['web'] %}
        - '{{ host }}:{{ app_metrics_port | default(9090) }}'
{% endfor %}
    metrics_path: '/metrics'
    scrape_interval: 30s
    
  # ç³»ç»Ÿç›‘æ§  
  - job_name: 'node-exporter'
    static_configs:
      - targets:
{% for host in groups['all'] %}
        - '{{ host }}:9100'
{% endfor %}

# å‘Šè­¦è§„åˆ™é…ç½®
alerting:
  alertmanagers:
    - static_configs:
        - targets: ['{{ alertmanager_host }}:9093']
```

**ğŸ”” å‘Šè­¦è§„åˆ™å®šä¹‰**ï¼š

```yaml
# templates/alert_rules.yml.j2
groups:
- name: deployment_alerts
  rules:
  # éƒ¨ç½²å¤±è´¥å‘Šè­¦
  - alert: DeploymentFailed
    expr: increase(deployment_failures_total[5m]) > 0
    for: 0m
    labels:
      severity: critical
    annotations:
      summary: "éƒ¨ç½²å¤±è´¥å‘Šè­¦"
      description: "åº”ç”¨ {{ app_name }} éƒ¨ç½²å¤±è´¥ï¼Œè¯·ç«‹å³æ£€æŸ¥"
      
  # æœåŠ¡ä¸å¯ç”¨å‘Šè­¦  
  - alert: ServiceDown
    expr: up{job="{{ app_name }}"} == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "æœåŠ¡ä¸å¯ç”¨"
      description: "æœåŠ¡ {{ app_name }} åœ¨ {{ ansible_host }} ä¸Šä¸å¯ç”¨è¶…è¿‡1åˆ†é’Ÿ"
      
  # å“åº”æ—¶é—´è¿‡é•¿å‘Šè­¦
  - alert: HighResponseTime
    expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "å“åº”æ—¶é—´è¿‡é•¿"
      description: "95%è¯·æ±‚å“åº”æ—¶é—´è¶…è¿‡2ç§’ï¼ŒæŒç»­5åˆ†é’Ÿ"
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ CI/CDé›†æˆæœ¬è´¨ï¼šè‡ªåŠ¨åŒ–ä»£ç ä»æäº¤åˆ°éƒ¨ç½²çš„å…¨è¿‡ç¨‹
ğŸ”¸ Ansibleè§’è‰²ï¼šåœ¨CDé˜¶æ®µè´Ÿè´£æœåŠ¡å™¨é…ç½®å’Œåº”ç”¨éƒ¨ç½²
ğŸ”¸ å¤šå¹³å°æ”¯æŒï¼šJenkinsã€GitLab CIã€GitHub Actionså„æœ‰ä¼˜åŠ¿
ğŸ”¸ ç¯å¢ƒéš”ç¦»ï¼šå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒçš„å·®å¼‚åŒ–ç®¡ç†
ğŸ”¸ éƒ¨ç½²ç­–ç•¥ï¼šè“ç»¿éƒ¨ç½²ã€æ»šåŠ¨æ›´æ–°ã€é‡‘ä¸é›€å‘å¸ƒ
ğŸ”¸ ç›‘æ§å›æ»šï¼šè‡ªåŠ¨ç›‘æ§éƒ¨ç½²çŠ¶æ€ï¼Œå¼‚å¸¸æ—¶å¿«é€Ÿå›æ»š
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ é€‰æ‹©åˆé€‚çš„CI/CDå¹³å°**
```
Jenkinsï¼š
âœ… åŠŸèƒ½æœ€å¼ºå¤§ï¼Œæ’ä»¶ä¸°å¯Œ
âœ… è‡ªå»ºç³»ç»Ÿï¼Œå®Œå…¨æ§åˆ¶
âŒ ç»´æŠ¤æˆæœ¬é«˜ï¼Œå­¦ä¹ æ›²çº¿é™¡

GitLab CIï¼š
âœ… ä¸Gitå®Œç¾é›†æˆï¼Œé…ç½®ç®€å•
âœ… å†…ç½®Dockeræ”¯æŒ
âŒ ä¾èµ–GitLabå¹³å°

GitHub Actionsï¼š
âœ… ä¸GitHubæ·±åº¦é›†æˆï¼Œå…è´¹é¢åº¦
âœ… å¼ºå¤§çš„Actionç”Ÿæ€
âŒ ä»…é™GitHubä»“åº“
```

**ğŸ”¹ ç¯å¢ƒç®¡ç†ç­–ç•¥é€‰æ‹©**
```
å°å›¢é˜Ÿæ¨èï¼š
å¼€å‘ç¯å¢ƒï¼šç›´æ¥éƒ¨ç½²ï¼Œå¿«é€Ÿè¿­ä»£
ç”Ÿäº§ç¯å¢ƒï¼šæ‰‹åŠ¨å®¡æ‰¹ï¼Œè“ç»¿éƒ¨ç½²

å¤§å›¢é˜Ÿæ¨èï¼š  
å¼€å‘ç¯å¢ƒï¼šè‡ªåŠ¨éƒ¨ç½²
æµ‹è¯•ç¯å¢ƒï¼šè“ç»¿éƒ¨ç½²ï¼Œè‡ªåŠ¨åŒ–æµ‹è¯•
é¢„ç”Ÿäº§ï¼šæ»šåŠ¨æ›´æ–°ï¼Œæ€§èƒ½æµ‹è¯•
ç”Ÿäº§ç¯å¢ƒï¼šå¤šçº§å®¡æ‰¹ï¼Œé‡‘ä¸é›€å‘å¸ƒ
```

**ğŸ”¹ ç›‘æ§å‘Šè­¦çš„é‡è¦æ€§**
```
éƒ¨ç½²ä¸æ˜¯ç»ˆç‚¹ï¼Œç›‘æ§æ‰æ˜¯èµ·ç‚¹ï¼š
âœ… å®æ—¶ç›‘æ§æœåŠ¡å¥åº·çŠ¶æ€
âœ… å¿«é€Ÿå‘ç°å’Œå®šä½é—®é¢˜
âœ… è‡ªåŠ¨å›æ»šå‡å°‘æ•…éšœå½±å“
âœ… æŒç»­æ”¹è¿›éƒ¨ç½²æµç¨‹
```

### 8.3 å®æˆ˜åº”ç”¨å»ºè®®


**ğŸ¯ ä»ç®€å•å¼€å§‹é€æ­¥å®Œå–„**
```
ç¬¬1é˜¶æ®µï¼šåŸºç¡€è‡ªåŠ¨åŒ–
- å•ç¯å¢ƒè‡ªåŠ¨éƒ¨ç½²
- åŸºæœ¬å¥åº·æ£€æŸ¥
- ç®€å•é€šçŸ¥æœºåˆ¶

ç¬¬2é˜¶æ®µï¼šå¤šç¯å¢ƒç®¡ç†
- å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒéš”ç¦»
- åˆ†æ”¯ç­–ç•¥å’Œå®¡æ‰¹æµç¨‹
- è“ç»¿éƒ¨ç½²å®ç°

ç¬¬3é˜¶æ®µï¼šä¼ä¸šçº§å®Œå–„
- ç›‘æ§å‘Šè­¦ä½“ç³»
- è‡ªåŠ¨å›æ»šæœºåˆ¶  
- æ€§èƒ½æŒ‡æ ‡æ”¶é›†
- åˆè§„å®¡è®¡åŠŸèƒ½
```

**ğŸ›¡ï¸ å®‰å…¨æœ€ä½³å®è·µ**
```
å¯†é’¥ç®¡ç†ï¼š
- ä½¿ç”¨CI/CDå¹³å°çš„å¯†é’¥ç®¡ç†åŠŸèƒ½
- ä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒå¯†é’¥
- å®šæœŸè½®æ¢å¯†é’¥

æƒé™æ§åˆ¶ï¼š
- æœ€å°æƒé™åŸåˆ™
- åˆ†ç¯å¢ƒæˆæƒ
- æ“ä½œå®¡è®¡æ—¥å¿—

ç½‘ç»œå®‰å…¨ï¼š
- VPNæˆ–ä¸“çº¿è¿æ¥
- é˜²ç«å¢™è§„åˆ™é™åˆ¶
- SSHå¯†é’¥è®¤è¯
```

### 8.4 æ•…éšœå¤„ç†ç»éªŒ


**ğŸš¨ å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ**
```
éƒ¨ç½²å¡æ­»ï¼š
åŸå› ï¼šç½‘ç»œè¶…æ—¶ã€ä¾èµ–æœåŠ¡ä¸å¯ç”¨
è§£å†³ï¼šå¢åŠ è¶…æ—¶è®¾ç½®ï¼Œæ·»åŠ é‡è¯•æœºåˆ¶

æƒé™é—®é¢˜ï¼š
åŸå› ï¼šSSHå¯†é’¥è¿‡æœŸã€sudoæƒé™ä¸è¶³
è§£å†³ï¼šæ£€æŸ¥å¯†é’¥é…ç½®ï¼ŒéªŒè¯ç”¨æˆ·æƒé™

æœåŠ¡å¯åŠ¨å¤±è´¥ï¼š
åŸå› ï¼šç«¯å£å ç”¨ã€é…ç½®é”™è¯¯ã€ä¾èµ–ç¼ºå¤±
è§£å†³ï¼šè¯¦ç»†æ—¥å¿—è®°å½•ï¼Œåˆ†æ­¥éª¤éªŒè¯

å›æ»šå¤±è´¥ï¼š
åŸå› ï¼šç‰ˆæœ¬æ–‡ä»¶æŸåã€æ•°æ®åº“ä¸å…¼å®¹
è§£å†³ï¼šç‰ˆæœ¬å¤‡ä»½ç­–ç•¥ï¼Œæ•°æ®åº“è¿ç§»è„šæœ¬
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- CI/CDé›†æˆè®©éƒ¨ç½²ä»æ‰‹å·¥å˜è‡ªåŠ¨ï¼Œä»å®¹æ˜“å‡ºé”™å˜å¯é ç¨³å®š
- é€‰æ‹©é€‚åˆçš„å¹³å°å’Œç­–ç•¥ï¼Œä»ç®€å•å¼€å§‹é€æ­¥å®Œå–„
- ç¯å¢ƒéš”ç¦»å’Œå®¡æ‰¹æµç¨‹æ˜¯ç”Ÿäº§å®‰å…¨çš„é‡è¦ä¿éšœ
- ç›‘æ§å‘Šè­¦å’Œè‡ªåŠ¨å›æ»šæ˜¯é«˜å¯ç”¨æœåŠ¡çš„å¿…è¦æ¡ä»¶
- å®‰å…¨å’Œæƒé™ç®¡ç†åœ¨ä¼ä¸šç¯å¢ƒä¸­ä¸å¯å¿½è§†