---
title: 3ã€ç›‘æ§è°ƒè¯•ä½“ç³»
---
## ğŸ“š ç›®å½•

1. [Ansibleè°ƒè¯•åŸºç¡€](#1-ansibleè°ƒè¯•åŸºç¡€)
2. [verboseè¯¦ç»†è¾“å‡º](#2-verboseè¯¦ç»†è¾“å‡º)
3. [debugè°ƒè¯•æ¨¡å—](#3-debugè°ƒè¯•æ¨¡å—)
4. [registerå˜é‡æ³¨å†Œ](#4-registerå˜é‡æ³¨å†Œ)
5. [æ—¥å¿—æ–‡ä»¶åˆ†æ](#5-æ—¥å¿—æ–‡ä»¶åˆ†æ)
6. [é”™è¯¯ä¿¡æ¯è§£è¯»](#6-é”™è¯¯ä¿¡æ¯è§£è¯»)
7. [æ€§èƒ½åˆ†æä¸ç“¶é¢ˆè¯†åˆ«](#7-æ€§èƒ½åˆ†æä¸ç“¶é¢ˆè¯†åˆ«)
8. [æ•…éšœæ’æŸ¥æŠ€å·§](#8-æ•…éšœæ’æŸ¥æŠ€å·§)
9. [ç›‘æ§å·¥å…·é›†æˆ](#9-ç›‘æ§å·¥å…·é›†æˆ)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”§ Ansibleè°ƒè¯•åŸºç¡€


### 1.1 ä»€ä¹ˆæ˜¯Ansibleè°ƒè¯•


**æ ¸å¿ƒæ¦‚å¿µ**ï¼šAnsibleè°ƒè¯•å°±åƒç»™ä½ çš„è‡ªåŠ¨åŒ–è„šæœ¬è£…ä¸Š"é€è§†é•œ"ï¼Œè®©ä½ èƒ½çœ‹åˆ°æ¯ä¸€æ­¥æ‰§è¡Œçš„ç»†èŠ‚å’Œç»“æœã€‚

```
ç®€å•ç†è§£ï¼š
æ™®é€šæ‰§è¡Œ = é»‘ç›’æ“ä½œï¼ˆåªçœ‹ç»“æœï¼‰
è°ƒè¯•æ¨¡å¼ = é€æ˜æ“ä½œï¼ˆçœ‹åˆ°è¿‡ç¨‹ï¼‰

å°±åƒåšèœï¼š
- æ™®é€šæ¨¡å¼ï¼šåªçŸ¥é“èœåšå¥½äº†æˆ–åšåäº†
- è°ƒè¯•æ¨¡å¼ï¼šçŸ¥é“æ¯ä¸ªæ­¥éª¤çš„çŠ¶æ€ï¼Œå“ªé‡Œæ”¾äº†å¤šå°‘ç›
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦è°ƒè¯•


**å®é™…é—®é¢˜åœºæ™¯**ï¼š
```
ğŸ”¸ ä»»åŠ¡å¤±è´¥äº†ï¼Œä½†ä¸çŸ¥é“å…·ä½“å“ªé‡Œå‡ºé”™
ğŸ”¸ å˜é‡å€¼ä¸å¯¹ï¼Œä½†ä¸æ¸…æ¥šæ˜¯åœ¨å“ªä¸ªç¯èŠ‚è¢«æ”¹å˜çš„
ğŸ”¸ æŸäº›ä¸»æœºæ‰§è¡ŒæˆåŠŸï¼ŒæŸäº›å¤±è´¥ï¼Œéœ€è¦æ‰¾å‡ºå·®å¼‚
ğŸ”¸ è„šæœ¬è¿è¡Œå¾ˆæ…¢ï¼Œæƒ³çŸ¥é“ç“¶é¢ˆåœ¨å“ªé‡Œ
ğŸ”¸ æƒ³éªŒè¯æ¡ä»¶åˆ¤æ–­æ˜¯å¦æŒ‰é¢„æœŸå·¥ä½œ
```

### 1.3 è°ƒè¯•çš„åŸºæœ¬æ€è·¯


```
è°ƒè¯•æµç¨‹ï¼š
é—®é¢˜å‘ç° â†’ ä¿¡æ¯æ”¶é›† â†’ é—®é¢˜å®šä½ â†’ è§£å†³éªŒè¯

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‘ç°é—®é¢˜    â”‚â”€â”€â–¶â”‚  æ”¶é›†ä¿¡æ¯    â”‚â”€â”€â–¶â”‚  åˆ†æå®šä½    â”‚
â”‚ ä»»åŠ¡å¤±è´¥     â”‚    â”‚ æŸ¥çœ‹æ—¥å¿—     â”‚    â”‚ æ‰¾å‡ºåŸå›      â”‚
â”‚ ç»“æœå¼‚å¸¸     â”‚    â”‚ è¯¦ç»†è¾“å‡º     â”‚    â”‚ ç¡®å®šæ–¹æ¡ˆ     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  æŒç»­ç›‘æ§    â”‚â—€â”€â”€â”‚  éªŒè¯è§£å†³    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ æ€§èƒ½ä¼˜åŒ–     â”‚    â”‚ æµ‹è¯•ä¿®å¤     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸ” verboseè¯¦ç»†è¾“å‡º


### 2.1 verboseè¾“å‡ºçº§åˆ«


**ä»€ä¹ˆæ˜¯verbose**ï¼šverboseå°±åƒè°ƒèŠ‚æ˜¾ç¤ºå™¨çš„"äº®åº¦"ï¼Œçº§åˆ«è¶Šé«˜ï¼Œçœ‹åˆ°çš„ç»†èŠ‚è¶Šå¤šã€‚

```bash
# ä¸åŒçš„verboseçº§åˆ«
ansible-playbook playbook.yml                # é»˜è®¤è¾“å‡º
ansible-playbook playbook.yml -v            # ä¸€çº§è¯¦ç»†
ansible-playbook playbook.yml -vv           # äºŒçº§è¯¦ç»†  
ansible-playbook playbook.yml -vvv          # ä¸‰çº§è¯¦ç»†
ansible-playbook playbook.yml -vvvv         # å››çº§è¯¦ç»†ï¼ˆæœ€é«˜ï¼‰
```

### 2.2 å„çº§åˆ«è¯¦ç»†å¯¹æ¯”


| çº§åˆ« | **æ˜¾ç¤ºå†…å®¹** | **é€‚ç”¨åœºæ™¯** | **ä¿¡æ¯é‡** |
|------|------------|-------------|-----------|
| `é»˜è®¤` | `åŸºæœ¬ä»»åŠ¡çŠ¶æ€` | `æ—¥å¸¸ä½¿ç”¨` | `â­` |
| `-v` | `ä»»åŠ¡è¯¦ç»†ä¿¡æ¯` | `ä¸€èˆ¬è°ƒè¯•` | `â­â­` |
| `-vv` | `ä»»åŠ¡+è¿æ¥ä¿¡æ¯` | `ç½‘ç»œé—®é¢˜è°ƒè¯•` | `â­â­â­` |
| `-vvv` | `æ›´å¤šæ‰§è¡Œç»†èŠ‚` | `æ·±åº¦è°ƒè¯•` | `â­â­â­â­` |
| `-vvvv` | `æ‰€æœ‰è°ƒè¯•ä¿¡æ¯` | `ä¸“å®¶çº§è°ƒè¯•` | `â­â­â­â­â­` |

### 2.3 å®é™…è¾“å‡ºå¯¹æ¯”


**æ™®é€šè¾“å‡ºç¤ºä¾‹**ï¼š
```
PLAY [webservers] ****************************************************

TASK [Install nginx] *************************************************
ok: [web1]
ok: [web2]

TASK [Start nginx] ***************************************************
changed: [web1]
changed: [web2]
```

**-vvçº§åˆ«è¾“å‡ºç¤ºä¾‹**ï¼š
```
ansible-playbook 2.9.6
  config file = /etc/ansible/ansible.cfg
  configured module search path = ['/home/user/.ansible/plugins/modules']
  
PLAY [webservers] ****************************************************

TASK [Install nginx] *************************************************
task path: /path/to/playbook.yml:10
<web1> ESTABLISH SSH CONNECTION FOR USER: ansible
<web1> SSH: EXEC ssh -C -o ControlMaster=auto web1 '/bin/sh -c ...'
<web1> (0, b'nginx is already installed\n', b'')
ok: [web1] => {"changed": false, "msg": "nginx already installed"}
```

### 2.4 å®ç”¨çš„verboseä½¿ç”¨æŠ€å·§


```bash
# ğŸ”§ è°ƒè¯•ç‰¹å®šä»»åŠ¡
ansible-playbook playbook.yml -vv --start-at-task="Install nginx"

# ğŸ”§ åªçœ‹å¤±è´¥çš„è¯¦ç»†ä¿¡æ¯
ansible-playbook playbook.yml -v | grep -A 10 "FAILED"

# ğŸ”§ å°†è¯¦ç»†è¾“å‡ºä¿å­˜åˆ°æ–‡ä»¶
ansible-playbook playbook.yml -vvv > debug.log 2>&1
```

---

## 3. ğŸ› debugè°ƒè¯•æ¨¡å—


### 3.1 debugæ¨¡å—åŸºç¡€ç”¨æ³•


**debugæ¨¡å—ä½œç”¨**ï¼šdebugæ¨¡å—å°±åƒåœ¨ä»£ç é‡ŒåŠ "æ‰“å°è¯­å¥"ï¼Œè®©ä½ çœ‹åˆ°å˜é‡çš„å€¼å’Œæ‰§è¡ŒçŠ¶æ€ã€‚

```yaml
---
- hosts: localhost
  vars:
    username: "admin"
    server_port: 8080
  tasks:
    # ğŸ”¸ æ‰“å°ç®€å•æ¶ˆæ¯
    - name: æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯
      debug:
        msg: "å¼€å§‹é…ç½®æœåŠ¡å™¨"
    
    # ğŸ”¸ æ˜¾ç¤ºå˜é‡å€¼
    - name: æ˜¾ç¤ºç”¨æˆ·å
      debug:
        var: username
    
    # ğŸ”¸ æ˜¾ç¤ºå¤šä¸ªå˜é‡
    - name: æ˜¾ç¤ºé…ç½®ä¿¡æ¯
      debug:
        msg: "ç”¨æˆ·: {{ username }}, ç«¯å£: {{ server_port }}"
```

### 3.2 debugæ¨¡å—é«˜çº§ç”¨æ³•


```yaml
---
- hosts: webservers
  tasks:
    # ğŸ”¸ æ¡ä»¶è°ƒè¯•
    - name: æ£€æŸ¥ç³»ç»Ÿä¿¡æ¯
      debug:
        msg: "è¿™æ˜¯CentOSç³»ç»Ÿ"
      when: ansible_distribution == "CentOS"
    
    # ğŸ”¸ æ˜¾ç¤ºå¤æ‚æ•°æ®ç»“æ„
    - name: æ˜¾ç¤ºä¸»æœºæ‰€æœ‰å˜é‡
      debug:
        var: hostvars[inventory_hostname]
      
    # ğŸ”¸ æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
    - name: æ˜¾ç¤ºå†…å­˜ä¿¡æ¯
      debug:
        msg: "æ€»å†…å­˜: {{ ansible_memtotal_mb }}MB"
    
    # ğŸ”¸ æ ¼å¼åŒ–è¾“å‡º
    - name: æ˜¾ç¤ºæ ¼å¼åŒ–ä¿¡æ¯
      debug:
        msg: |
          æœåŠ¡å™¨çŠ¶æ€æŠ¥å‘Š:
          - ä¸»æœºå: {{ inventory_hostname }}
          - IPåœ°å€: {{ ansible_default_ipv4.address }}
          - ç³»ç»Ÿ: {{ ansible_distribution }} {{ ansible_distribution_version }}
```

### 3.3 å®æˆ˜è°ƒè¯•ç¤ºä¾‹


```yaml
---
- hosts: webservers
  vars:
    packages:
      - nginx
      - mysql
      - php
  tasks:
    # ğŸ”¸ å¾ªç¯è°ƒè¯•
    - name: æ˜¾ç¤ºè¦å®‰è£…çš„åŒ…
      debug:
        msg: "å‡†å¤‡å®‰è£…: {{ item }}"
      loop: "{{ packages }}"
    
    # ğŸ”¸ æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    - name: æ£€æŸ¥é…ç½®æ–‡ä»¶
      stat:
        path: /etc/nginx/nginx.conf
      register: nginx_config
    
    - name: æ˜¾ç¤ºæ–‡ä»¶æ£€æŸ¥ç»“æœ
      debug:
        msg: "é…ç½®æ–‡ä»¶{% if nginx_config.stat.exists %}å­˜åœ¨{% else %}ä¸å­˜åœ¨{% endif %}"
```

---

## 4. ğŸ“ registerå˜é‡æ³¨å†Œ


### 4.1 ä»€ä¹ˆæ˜¯register


**registeræ¦‚å¿µ**ï¼šregisterå°±åƒç»™ä»»åŠ¡çš„æ‰§è¡Œç»“æœèµ·ä¸ª"å¤–å·"ï¼Œä»¥åå¯ä»¥ç”¨è¿™ä¸ªå¤–å·æ¥å¼•ç”¨ç»“æœã€‚

```
ç®€å•ç†è§£ï¼š
ä»»åŠ¡æ‰§è¡Œ â†’ äº§ç”Ÿç»“æœ â†’ registerä¿å­˜ç»“æœ â†’ å…¶ä»–ä»»åŠ¡ä½¿ç”¨ç»“æœ

å°±åƒï¼š
åšé¥­(ä»»åŠ¡) â†’ åšå‡ºèœå“(ç»“æœ) â†’ è£…ç›˜è´´æ ‡ç­¾(register) â†’ åˆ«äººçœ‹æ ‡ç­¾çŸ¥é“æ˜¯ä»€ä¹ˆèœ
```

### 4.2 registeråŸºæœ¬ç”¨æ³•


```yaml
---
- hosts: webservers
  tasks:
    # ğŸ”¸ æ³¨å†Œå‘½ä»¤æ‰§è¡Œç»“æœ
    - name: æ£€æŸ¥ç£ç›˜ä½¿ç”¨æƒ…å†µ
      command: df -h
      register: disk_usage
    
    # ğŸ”¸ ä½¿ç”¨æ³¨å†Œçš„ç»“æœ
    - name: æ˜¾ç¤ºç£ç›˜ä½¿ç”¨æƒ…å†µ
      debug:
        var: disk_usage.stdout_lines
    
    # ğŸ”¸ åŸºäºç»“æœåšåˆ¤æ–­
    - name: ç£ç›˜ç©ºé—´å……è¶³
      debug:
        msg: "ç£ç›˜ç©ºé—´æ­£å¸¸"
      when: "'100%' not in disk_usage.stdout"
```

### 4.3 registerç»“æœç»“æ„


**registerå˜é‡åŒ…å«çš„ä¿¡æ¯**ï¼š
```
registerç»“æœç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  cmd               â”‚ â† æ‰§è¡Œçš„å‘½ä»¤
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  
â”‚  stdout            â”‚ â† æ ‡å‡†è¾“å‡ºå†…å®¹
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  stderr            â”‚ â† é”™è¯¯è¾“å‡ºå†…å®¹  
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  rc                â”‚ â† è¿”å›ä»£ç (0=æˆåŠŸ)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  changed           â”‚ â† æ˜¯å¦æœ‰å˜æ›´
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  stdout_lines      â”‚ â† è¾“å‡ºæŒ‰è¡Œåˆ†å‰²çš„åˆ—è¡¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.4 registerå®é™…åº”ç”¨åœºæ™¯


```yaml
---
- hosts: webservers
  tasks:
    # ğŸ”¸ åœºæ™¯1ï¼šæ£€æŸ¥æœåŠ¡çŠ¶æ€
    - name: æ£€æŸ¥nginxçŠ¶æ€
      command: systemctl is-active nginx
      register: nginx_status
      ignore_errors: yes
    
    - name: æ ¹æ®çŠ¶æ€å†³å®šæ“ä½œ
      service:
        name: nginx
        state: started
      when: nginx_status.stdout != "active"
    
    # ğŸ”¸ åœºæ™¯2ï¼šè·å–ç³»ç»Ÿä¿¡æ¯
    - name: è·å–å½“å‰ç”¨æˆ·
      command: whoami
      register: current_user
    
    - name: æ˜¾ç¤ºå½“å‰ç”¨æˆ·
      debug:
        msg: "å½“å‰æ‰§è¡Œç”¨æˆ·: {{ current_user.stdout }}"
    
    # ğŸ”¸ åœºæ™¯3ï¼šæ–‡ä»¶æ“ä½œç»“æœ
    - name: åˆ›å»ºé…ç½®ç›®å½•
      file:
        path: /etc/myapp
        state: directory
      register: dir_result
    
    - name: æ˜¾ç¤ºç›®å½•åˆ›å»ºç»“æœ
      debug:
        msg: "ç›®å½•{% if dir_result.changed %}å·²åˆ›å»º{% else %}å·²å­˜åœ¨{% endif %}"
```

---

## 5. ğŸ“‹ æ—¥å¿—æ–‡ä»¶åˆ†æ


### 5.1 Ansibleæ—¥å¿—é…ç½®


**æ—¥å¿—æ–‡ä»¶ä½ç½®**ï¼šAnsibleçš„æ—¥å¿—å°±åƒè¡Œè½¦è®°å½•ä»ªï¼Œè®°å½•äº†æ‰€æœ‰æ“ä½œçš„è¯¦ç»†è¿‡ç¨‹ã€‚

```ini
# ansible.cfg é…ç½®æ–‡ä»¶
[defaults]
log_path = /var/log/ansible.log
host_key_checking = False
stdout_callback = debug
```

### 5.2 æ—¥å¿—å†…å®¹åˆ†æ


**æ—¥å¿—æ–‡ä»¶ç»“æ„**ï¼š
```
æ—¥å¿—è®°å½•æ ¼å¼ï¼š
æ—¶é—´æˆ³ | ä¸»æœºå | ä»»åŠ¡åç§° | æ‰§è¡Œç»“æœ | è¯¦ç»†ä¿¡æ¯

2024-12-19 10:30:15,123 p=12345 u=ansible |  ok: [web1] => {
    "changed": false,
    "msg": "nginx is already installed"
}
```

### 5.3 æ—¥å¿—åˆ†æå®ç”¨å‘½ä»¤


```bash
# ğŸ” æŸ¥çœ‹æœ€è¿‘çš„æ—¥å¿—
tail -f /var/log/ansible.log

# ğŸ” æŸ¥çœ‹ç‰¹å®šä¸»æœºçš„æ—¥å¿—
grep "web1" /var/log/ansible.log

# ğŸ” æŸ¥çœ‹å¤±è´¥çš„ä»»åŠ¡
grep "FAILED" /var/log/ansible.log

# ğŸ” æŸ¥çœ‹æœ€è¿‘100è¡Œæ—¥å¿—
tail -n 100 /var/log/ansible.log

# ğŸ” æŒ‰æ—¶é—´è¿‡æ»¤æ—¥å¿—
grep "2024-12-19" /var/log/ansible.log

# ğŸ” ç»Ÿè®¡æ‰§è¡Œç»“æœ
grep -c "ok:\|changed:\|failed:" /var/log/ansible.log
```

### 5.4 è‡ªå®šä¹‰æ—¥å¿—è®°å½•


```yaml
---
- hosts: webservers
  tasks:
    - name: å¼€å§‹éƒ¨ç½²
      debug:
        msg: "=== å¼€å§‹éƒ¨ç½²åº”ç”¨ ==="
    
    - name: è®°å½•éƒ¨ç½²æ—¶é—´
      debug:
        msg: "éƒ¨ç½²æ—¶é—´: {{ ansible_date_time.iso8601 }}"
    
    # åœ¨å…³é”®æ­¥éª¤æ·»åŠ æ—¥å¿—è®°å½•
    - name: å®‰è£…è½¯ä»¶åŒ…
      yum:
        name: nginx
        state: present
      register: install_result
    
    - name: è®°å½•å®‰è£…ç»“æœ
      debug:
        msg: "è½¯ä»¶åŒ…å®‰è£…{% if install_result.changed %}æˆåŠŸ{% else %}è·³è¿‡ï¼ˆå·²å®‰è£…ï¼‰{% endif %}"
```

---

## 6. âš ï¸ é”™è¯¯ä¿¡æ¯è§£è¯»


### 6.1 å¸¸è§é”™è¯¯ç±»å‹


**SSHè¿æ¥é”™è¯¯**ï¼š
```bash
# é”™è¯¯ä¿¡æ¯
UNREACHABLE! => {
    "changed": false,
    "msg": "Failed to connect to the host via ssh",
    "unreachable": true
}

# è§£å†³æ€è·¯
1. æ£€æŸ¥ä¸»æœºæ˜¯å¦å¯è¾¾: ping target_host
2. æ£€æŸ¥SSHæœåŠ¡: ssh target_host
3. æ£€æŸ¥å¯†é’¥è®¤è¯: ssh-copy-id target_host
```

**æƒé™é”™è¯¯**ï¼š
```bash
# é”™è¯¯ä¿¡æ¯  
FAILED! => {
    "msg": "Missing sudo password"
}

# è§£å†³æ–¹æ¡ˆ
ansible-playbook playbook.yml --ask-become-pass
# æˆ–åœ¨inventoryä¸­é…ç½®
[webservers]
web1 ansible_become_pass=your_password
```

### 6.2 æ¨¡å—æ‰§è¡Œé”™è¯¯


```yaml
# ğŸ”¸ æ–‡ä»¶æ“ä½œé”™è¯¯
- name: åˆ›å»ºæ–‡ä»¶
  file:
    path: /root/test.txt
    state: touch
  # å¯èƒ½é”™è¯¯ï¼šæƒé™ä¸è¶³

# ğŸ”¸ æœåŠ¡æ“ä½œé”™è¯¯  
- name: å¯åŠ¨æœåŠ¡
  service:
    name: nginx
    state: started
  # å¯èƒ½é”™è¯¯ï¼šæœåŠ¡ä¸å­˜åœ¨ã€æƒé™ä¸è¶³
```

### 6.3 è¯­æ³•é”™è¯¯è§£è¯»


```yaml
# âŒ YAMLè¯­æ³•é”™è¯¯
- name: å®‰è£…è½¯ä»¶åŒ…
  yum:
    name: nginx
   state: present  # ç¼©è¿›é”™è¯¯

# âœ… æ­£ç¡®å†™æ³•
- name: å®‰è£…è½¯ä»¶åŒ…
  yum:
    name: nginx
    state: present
```

### 6.4 é”™è¯¯å¤„ç†ç­–ç•¥


```yaml
---
- hosts: webservers
  tasks:
    # ğŸ”¸ å¿½ç•¥ç‰¹å®šé”™è¯¯
    - name: æ£€æŸ¥æœåŠ¡çŠ¶æ€
      command: systemctl status nginx
      register: service_status
      ignore_errors: yes
    
    # ğŸ”¸ é”™è¯¯æ—¶ç»§ç»­æ‰§è¡Œ
    - name: å°è¯•å¯åŠ¨æœåŠ¡
      service:
        name: nginx
        state: started
      ignore_errors: yes
    
    # ğŸ”¸ åŸºäºé”™è¯¯ç»“æœåšåˆ¤æ–­
    - name: å¤„ç†å¯åŠ¨å¤±è´¥
      debug:
        msg: "æœåŠ¡å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®"
      when: service_status is failed
```

---

## 7. âš¡ æ€§èƒ½åˆ†æä¸ç“¶é¢ˆè¯†åˆ«


### 7.1 æ‰§è¡Œæ—¶é—´åˆ†æ


**ä»€ä¹ˆå½±å“Ansibleæ€§èƒ½**ï¼š
```
æ€§èƒ½å½±å“å› ç´ ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç½‘ç»œå»¶è¿Ÿ    â”‚    â”‚  ä¸»æœºæ•°é‡    â”‚    â”‚  ä»»åŠ¡å¤æ‚åº¦  â”‚
â”‚ SSHè¿æ¥æ—¶é—´  â”‚    â”‚ å¹¶å‘æ‰§è¡Œæ•°   â”‚    â”‚ æ¨¡å—æ‰§è¡Œæ—¶é—´ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                   â”‚                   â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
                     â–¼                         â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
            â”‚   æ€»æ‰§è¡Œæ—¶é—´     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚ ç”¨æˆ·æ„Ÿå—çš„é€Ÿåº¦   â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 æ€§èƒ½åˆ†æå·¥å…·


```bash
# ğŸ”§ å¯ç”¨æ€§èƒ½åˆ†æ
export ANSIBLE_CALLBACK_WHITELIST="profile_tasks"
ansible-playbook playbook.yml

# ğŸ”§ æ˜¾ç¤ºä»»åŠ¡æ‰§è¡Œæ—¶é—´
ansible-playbook playbook.yml -v | grep "TASK\|=>.*changed"

# ğŸ”§ å¹¶å‘æ§åˆ¶
ansible-playbook playbook.yml -f 10  # æœ€å¤š10ä¸ªå¹¶å‘
```

### 7.3 æ€§èƒ½ä¼˜åŒ–æŠ€å·§


```yaml
---
- hosts: webservers
  # ğŸ”¸ ä¼˜åŒ–1ï¼šå‡å°‘factæ”¶é›†
  gather_facts: no
  
  # ğŸ”¸ ä¼˜åŒ–2ï¼šä½¿ç”¨æ›´å¿«çš„è¿æ¥æ–¹å¼
  vars:
    ansible_ssh_pipelining: true
  
  tasks:
    # ğŸ”¸ ä¼˜åŒ–3ï¼šæ‰¹é‡æ“ä½œæ›¿ä»£å¾ªç¯
    - name: å®‰è£…å¤šä¸ªè½¯ä»¶åŒ…ï¼ˆä¼˜åŒ–å‰ï¼‰
      yum:
        name: "{{ item }}"
        state: present
      loop:
        - nginx
        - mysql
        - php
    
    # ğŸ”¸ ä¼˜åŒ–åï¼šä¸€æ¬¡æ€§å®‰è£…
    - name: å®‰è£…å¤šä¸ªè½¯ä»¶åŒ…ï¼ˆä¼˜åŒ–åï¼‰
      yum:
        name:
          - nginx  
          - mysql
          - php
        state: present
```

### 7.4 ç“¶é¢ˆè¯†åˆ«æ–¹æ³•


```yaml
# ğŸ” æ·»åŠ æ—¶é—´æˆ³æ ‡è®°
- name: è®°å½•å¼€å§‹æ—¶é—´
  debug:
    msg: "å¼€å§‹æ—¶é—´: {{ ansible_date_time.epoch }}"
  register: start_time

# æ‰§è¡Œè€—æ—¶ä»»åŠ¡
- name: æ‰§è¡Œæ•°æ®åº“å¤‡ä»½
  shell: mysqldump --all-databases > backup.sql

- name: è®°å½•ç»“æŸæ—¶é—´
  debug:
    msg: "ç»“æŸæ—¶é—´: {{ ansible_date_time.epoch }}"
  register: end_time

- name: è®¡ç®—æ‰§è¡Œæ—¶é—´
  debug:
    msg: "æ‰§è¡Œè€—æ—¶: {{ (end_time.msg.split(': ')[1]|int - start_time.msg.split(': ')[1]|int) }}ç§’"
```

---

## 8. ğŸ”§ æ•…éšœæ’æŸ¥æŠ€å·§


### 8.1 ç³»ç»Ÿæ€§æ’æŸ¥æ–¹æ³•


```
æ•…éšœæ’æŸ¥æµç¨‹ï¼š
é—®é¢˜ç°è±¡ â†’ ä¿¡æ¯æ”¶é›† â†’ å‡è®¾éªŒè¯ â†’ é—®é¢˜è§£å†³

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1.é—®é¢˜ç°è±¡  â”‚  ä»»åŠ¡å¤±è´¥ã€ç»“æœå¼‚å¸¸ã€æ‰§è¡Œç¼“æ…¢
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2.ä¿¡æ¯æ”¶é›†  â”‚  æŸ¥çœ‹æ—¥å¿—ã€è¯¦ç»†è¾“å‡ºã€ç³»ç»ŸçŠ¶æ€
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
       â–¼  
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3.å‡è®¾éªŒè¯  â”‚  é€æ­¥æµ‹è¯•ã€ç¼©å°èŒƒå›´ã€å®šä½åŸå› 
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4.é—®é¢˜è§£å†³  â”‚  ä¿®å¤é…ç½®ã€æ›´æ–°ä»£ç ã€éªŒè¯ç»“æœ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 å¸¸ç”¨æ’æŸ¥å‘½ä»¤


```bash
# ğŸ” æµ‹è¯•ä¸»æœºè¿é€šæ€§
ansible webservers -m ping

# ğŸ” æ£€æŸ¥ä¸»æœºåŸºæœ¬ä¿¡æ¯
ansible webservers -m setup -a "filter=ansible_os_family"

# ğŸ” æ‰§è¡Œç®€å•å‘½ä»¤æµ‹è¯•
ansible webservers -m command -a "uptime"

# ğŸ” æ£€æŸ¥ç‰¹å®šä»»åŠ¡
ansible-playbook playbook.yml --list-tasks
ansible-playbook playbook.yml --check  # å¹²è¿è¡Œ

# ğŸ” ä»æŒ‡å®šä»»åŠ¡å¼€å§‹æ‰§è¡Œ
ansible-playbook playbook.yml --start-at-task="Install nginx"
```

### 8.3 åˆ†æ­¥è°ƒè¯•æŠ€å·§


```yaml
---
- hosts: webservers
  tasks:
    # ğŸ”¸ æ­¥éª¤1ï¼šéªŒè¯å‰ç½®æ¡ä»¶
    - name: æ£€æŸ¥ç³»ç»Ÿç‰ˆæœ¬
      debug:
        var: ansible_distribution_version
    
    # ğŸ”¸ æ­¥éª¤2ï¼šæµ‹è¯•ç½‘ç»œè¿æ¥
    - name: æµ‹è¯•ç½‘ç»œè¿æ¥
      wait_for:
        host: "{{ inventory_hostname }}"
        port: 22
        timeout: 10
      delegate_to: localhost
    
    # ğŸ”¸ æ­¥éª¤3ï¼šæ£€æŸ¥å¿…éœ€æœåŠ¡
    - name: æ£€æŸ¥SSHæœåŠ¡
      service_facts:
      
    - name: æ˜¾ç¤ºSSHæœåŠ¡çŠ¶æ€
      debug:
        msg: "SSHæœåŠ¡çŠ¶æ€: {{ services['sshd.service'].state }}"
      when: "'sshd.service' in services"
```

### 8.4 é—®é¢˜éš”ç¦»æŠ€æœ¯


```yaml
# ğŸ”§ åˆ›å»ºæœ€å°æµ‹è¯•ç”¨ä¾‹
---
- hosts: webservers[0]  # åªåœ¨ç¬¬ä¸€å°ä¸»æœºæµ‹è¯•
  tasks:
    - name: æœ€å°æµ‹è¯•
      debug:
        msg: "è¿æ¥æ­£å¸¸"

# ğŸ”§ é€æ­¥æ·»åŠ å¤æ‚åº¦
- hosts: webservers
  tasks:
    # å…ˆæµ‹è¯•ç®€å•å‘½ä»¤
    - name: æµ‹è¯•åŸºæœ¬å‘½ä»¤
      command: echo "test"
      
    # å†æµ‹è¯•æ–‡ä»¶æ“ä½œ
    - name: æµ‹è¯•æ–‡ä»¶æ“ä½œ
      file:
        path: /tmp/test
        state: touch
```

---

## 9. ğŸ“Š ç›‘æ§å·¥å…·é›†æˆ


### 9.1 Ansibleä¸ç›‘æ§ç³»ç»Ÿæ•´åˆ


**ç›‘æ§é›†æˆæ¶æ„**ï¼š
```
Ansibleæ‰§è¡Œ â†’ æ”¶é›†æŒ‡æ ‡ â†’ å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ â†’ ç”ŸæˆæŠ¥å‘Š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Playbook   â”‚â”€â”€â”€â–¶â”‚  æ‰§è¡Œç»“æœ    â”‚â”€â”€â”€â–¶â”‚  ç›‘æ§ç³»ç»Ÿ    â”‚
â”‚  æ‰§è¡Œä»»åŠ¡    â”‚    â”‚ æ—¶é—´/çŠ¶æ€   â”‚    â”‚ Prometheus  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ Grafana     â”‚
                                      â”‚ ELK Stack   â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             â”‚
                                             â–¼
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚  æŠ¥å‘Š/å‘Šè­¦   â”‚
                                    â”‚ ä»ªè¡¨ç›˜æ˜¾ç¤º   â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.2 é›†æˆPrometheusç›‘æ§


```yaml
---
- hosts: webservers
  tasks:
    # ğŸ”¸ è®°å½•ä»»åŠ¡å¼€å§‹æ—¶é—´
    - name: è®°å½•éƒ¨ç½²å¼€å§‹
      uri:
        url: "http://pushgateway:9091/metrics/job/ansible_deploy/instance/{{ inventory_hostname }}"
        method: POST
        body: "ansible_deploy_start_time {{ ansible_date_time.epoch }}"
      delegate_to: localhost
    
    # æ‰§è¡Œå®é™…ä»»åŠ¡
    - name: éƒ¨ç½²åº”ç”¨
      copy:
        src: app.jar
        dest: /opt/app/
      register: deploy_result
    
    # ğŸ”¸ è®°å½•ä»»åŠ¡ç»“æœ
    - name: è®°å½•éƒ¨ç½²ç»“æœ
      uri:
        url: "http://pushgateway:9091/metrics/job/ansible_deploy/instance/{{ inventory_hostname }}"
        method: POST
        body: |
          ansible_deploy_status {% if deploy_result.changed %}1{% else %}0{% endif %}
          ansible_deploy_end_time {{ ansible_date_time.epoch }}
      delegate_to: localhost
```

### 9.3 æ—¥å¿—é›†æˆELK Stack


```yaml
# ğŸ”§ é…ç½®ç»“æ„åŒ–æ—¥å¿—è¾“å‡º
- name: å‘é€æ—¥å¿—åˆ°Elasticsearch
  uri:
    url: "http://elasticsearch:9200/ansible-logs/_doc/"
    method: POST
    headers:
      Content-Type: "application/json"
    body_format: json
    body:
      timestamp: "{{ ansible_date_time.iso8601 }}"
      host: "{{ inventory_hostname }}"
      task: "{{ ansible_task_name }}"
      status: "{% if ansible_failed %}failed{% else %}success{% endif %}"
      message: "{{ ansible_task_result | to_json }}"
```

### 9.4 å‘Šè­¦é›†æˆ


```yaml
# ğŸš¨ å¤±è´¥æ—¶å‘é€å‘Šè­¦
- name: å‘é€å‘Šè­¦é€šçŸ¥
  mail:
    to: "admin@company.com"
    subject: "Ansibleä»»åŠ¡å¤±è´¥å‘Šè­¦"
    body: |
      ä¸»æœº: {{ inventory_hostname }}
      ä»»åŠ¡: {{ failed_task_name }}
      æ—¶é—´: {{ ansible_date_time.iso8601 }}
      é”™è¯¯: {{ ansible_task_result.msg }}
  when: ansible_failed
  delegate_to: localhost
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„è°ƒè¯•æŠ€èƒ½


```
ğŸ”¸ åŸºç¡€è°ƒè¯•ï¼šæŒæ¡verboseè¾“å‡ºçº§åˆ«çš„ä½¿ç”¨
ğŸ”¸ ä¿¡æ¯æ”¶é›†ï¼šä¼šç”¨debugæ¨¡å—æ˜¾ç¤ºå˜é‡å’ŒçŠ¶æ€  
ğŸ”¸ ç»“æœä¿å­˜ï¼šç†Ÿç»ƒä½¿ç”¨registeræ³¨å†Œä»»åŠ¡ç»“æœ
ğŸ”¸ æ—¥å¿—åˆ†æï¼šèƒ½å¤Ÿåˆ†æå’Œè¿‡æ»¤Ansibleæ—¥å¿—æ–‡ä»¶
ğŸ”¸ é”™è¯¯å¤„ç†ï¼šç†è§£å¸¸è§é”™è¯¯ä¿¡æ¯å¹¶çŸ¥é“è§£å†³æ–¹æ³•
ğŸ”¸ æ€§èƒ½ä¼˜åŒ–ï¼šè¯†åˆ«æ€§èƒ½ç“¶é¢ˆå¹¶åº”ç”¨ä¼˜åŒ–æŠ€å·§
ğŸ”¸ æ•…éšœæ’æŸ¥ï¼šç³»ç»Ÿæ€§çš„é—®é¢˜å®šä½å’Œè§£å†³æµç¨‹
```

### 10.2 è°ƒè¯•æœ€ä½³å®è·µ


**ğŸ”¹ è°ƒè¯•åŸåˆ™**ï¼š
```
æ¸è¿›å¼è°ƒè¯•ï¼š
ä»ç®€å•åˆ°å¤æ‚ â†’ ä»å±€éƒ¨åˆ°æ•´ä½“ â†’ ä»å•æœºåˆ°é›†ç¾¤

ä¿¡æ¯é©±åŠ¨ï¼š
å¤šæ”¶é›†ä¿¡æ¯ â†’ å°‘åšå‡è®¾ â†’ ç”¨äº‹å®è¯´è¯

å·¥å…·é…åˆï¼š
verboseè¾“å‡º + debugæ¨¡å— + registerå˜é‡ + æ—¥å¿—åˆ†æ
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–è¦ç‚¹**ï¼š
```
å‡å°‘ä¸å¿…è¦æ“ä½œï¼š
- å…³é—­factæ”¶é›†ï¼ˆgather_facts: noï¼‰
- æ‰¹é‡æ“ä½œæ›¿ä»£å¾ªç¯
- åˆç†è®¾ç½®å¹¶å‘æ•°

æé«˜è¿æ¥æ•ˆç‡ï¼š
- å¯ç”¨SSH pipelining
- ä½¿ç”¨è¿æ¥å¤ç”¨
- ä¼˜åŒ–ç½‘ç»œé…ç½®
```

### 10.3 å®é™…åº”ç”¨ä»·å€¼


- **å¼€å‘é˜¶æ®µ**ï¼šå¿«é€Ÿå®šä½è„šæœ¬é—®é¢˜ï¼Œæé«˜å¼€å‘æ•ˆç‡
- **æµ‹è¯•é˜¶æ®µ**ï¼šéªŒè¯æ‰§è¡Œç»“æœï¼Œç¡®ä¿é€»è¾‘æ­£ç¡®
- **ç”Ÿäº§éƒ¨ç½²**ï¼šç›‘æ§æ‰§è¡ŒçŠ¶æ€ï¼ŒåŠæ—¶å‘ç°å¼‚å¸¸
- **è¿ç»´ç›‘æ§**ï¼šé›†æˆç›‘æ§ç³»ç»Ÿï¼Œå»ºç«‹è¿ç»´å¯è§†åŒ–
- **æ•…éšœå¤„ç†**ï¼šå¿«é€Ÿå®šä½é—®é¢˜ï¼Œç¼©çŸ­æ•…éšœæ¢å¤æ—¶é—´

### 10.4 è¿›é˜¶å­¦ä¹ æ–¹å‘


**ğŸ”§ æ·±å…¥ç›‘æ§**ï¼š
- å­¦ä¹ Prometheus + Grafanaç›‘æ§é›†æˆ
- æŒæ¡ELK Stackæ—¥å¿—åˆ†æ
- ç ”ç©¶APMåº”ç”¨æ€§èƒ½ç›‘æ§

**ğŸ”§ è‡ªåŠ¨åŒ–è¿ç»´**ï¼š
- ChatOpsé›†æˆï¼ˆSlackã€é’‰é’‰ï¼‰
- CI/CDæµæ°´çº¿é›†æˆ
- è‡ªåŠ¨åŒ–æµ‹è¯•å’Œå›æ»š

**æ ¸å¿ƒè®°å¿†**ï¼š
- è°ƒè¯•å¦‚é€è§†é•œï¼Œverboseçœ‹ç»†èŠ‚ï¼Œdebugæ˜¾å˜é‡
- registerå­˜ç»“æœï¼Œæ—¥å¿—è®°è¿‡ç¨‹ï¼Œé”™è¯¯è¦åˆ†æ
- æ€§èƒ½æ‰¾ç“¶é¢ˆï¼Œæ•…éšœç³»ç»ŸæŸ¥ï¼Œç›‘æ§åŠ©è¿ç»´
- å·¥å…·è¦é…åˆï¼Œå®è·µå‡ºçœŸçŸ¥ï¼Œé—®é¢˜ä¸å¯æ€•