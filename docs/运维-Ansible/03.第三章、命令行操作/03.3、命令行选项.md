---
title: 3、命令行选项
---
## 📚 目录

1. [版本与帮助信息](#1-版本与帮助信息)
2. [详细输出与调试](#2-详细输出与调试)
3. [检查模式与差异显示](#3-检查模式与差异显示)
4. [主机管理与语法检查](#4-主机管理与语法检查)
5. [加密与安全选项](#5-加密与安全选项)
6. [输出格式控制](#6-输出格式控制)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 📋 版本与帮助信息


### 1.1 版本信息查看


**🔸 --version：获取版本详情**
```bash
ansible --version
```

**输出内容解读**：
```
ansible [core 2.14.1]
  config file = /etc/ansible/ansible.cfg    ← 配置文件位置
  configured module = /usr/share/ansible    ← 模块路径
  ansible python module location = /usr/lib/python3/dist-packages/ansible
  python version = 3.10.6                  ← Python版本
```

这个命令相当于给Ansible做"体检"，告诉你：
- **当前版本**：确保版本兼容性
- **配置文件位置**：知道配置从哪里加载
- **模块路径**：了解Ansible组件位置
- **Python版本**：确保运行环境正常

### 1.2 帮助信息获取


**🔸 --help：查看帮助文档**
```bash
ansible --help           # 基础帮助
ansible-playbook --help  # playbook帮助
```

帮助信息就像说明书，包含：
- **可用选项**：所有命令行参数
- **使用格式**：正确的命令语法
- **实用示例**：常见使用场景

**💡 实用技巧**
```bash
# 快速查找特定选项
ansible --help | grep -i verbose  # 查找详细输出相关选项
ansible --help | grep -i check    # 查找检查相关选项
```

---

## 2. 🔍 详细输出与调试


### 2.1 详细输出级别


**🔸 -v：基础详细模式**
```bash
ansible all -m ping -v
```

输出效果对比：
```
# 普通模式（简洁）
server1 | SUCCESS => {
    "ping": "pong"
}

# -v模式（详细）
Using /etc/ansible/ansible.cfg as config file
server1 | SUCCESS => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python3"
    },
    "changed": false,
    "ping": "pong"
}
```

**🔸 调试级别递增**
| 级别 | 选项 | **显示内容** | **适用场景** |
|-----|------|-------------|-------------|
| `基础` | `-v` | `模块输出和配置信息` | `日常使用` |
| `详细` | `-vv` | `任务执行过程` | `故障排查` |
| `调试` | `-vvv` | `连接和认证详情` | `深度调试` |
| `超详` | `-vvvv` | `插件和内部处理` | `开发调试` |

### 2.2 实际调试场景


**连接问题排查**：
```bash
# 当SSH连接失败时
ansible server1 -m ping -vvv
```

输出会显示：
```
SSH连接建立过程 → 认证方式 → 错误详情 → 解决建议
```

**模块执行跟踪**：
```bash
# 查看模块具体执行了什么
ansible all -m copy -a "src=/tmp/test.txt dest=/tmp/" -vv
```

**💡 调试使用建议**：
- **日常操作**：不加-v，保持输出简洁
- **出现错误**：使用-v看基本信息
- **复杂问题**：使用-vv或-vvv深入分析

---

## 3. 🛡️ 检查模式与差异显示


### 3.1 检查模式（预演模式）


**🔸 --check：只检查不执行**

检查模式就像"彩排"，让你提前知道会发生什么变化：

```bash
# 检查文件复制操作
ansible all -m copy -a "src=/tmp/config.txt dest=/etc/config.txt" --check
```

**安全特点**：
```
✅ 不会实际修改系统
✅ 显示将要进行的操作
✅ 发现潜在问题
✅ 验证playbook逻辑
```

### 3.2 差异显示


**🔸 --diff：显示变更内容**

差异显示让你看到**具体变化**：

```bash
# 修改配置文件并显示差异
ansible server1 -m replace -a "path=/etc/hosts regexp='^127.0.0.1' replace='127.0.0.1'" --diff
```

**输出示例**：
```diff
--- before: /etc/hosts
+++ after: /etc/hosts
$$ -1,3 +1,3 $$
-127.0.0.1   localhost
+127.0.0.1   localhost myserver
 ::1         localhost
```

### 3.3 组合使用技巧


**最佳实践组合**：
```bash
# 完美的预检查组合
ansible-playbook site.yml --check --diff -v
```

这个组合提供：
- **--check**：不执行实际操作
- **--diff**：显示具体变更
- **-v**：详细输出过程

**实际工作流程**：
```
第1步：--check --diff    ← 预览变更
第2步：确认无误后执行    ← 正式运行
第3步：--diff验证结果    ← 确认变更
```

---

## 4. 🎯 主机管理与语法检查


### 4.1 主机列表显示


**🔸 --list-hosts：显示目标主机**

在执行任务前，先确认目标主机：

```bash
# 列出所有主机
ansible all --list-hosts

# 列出特定组的主机
ansible webservers --list-hosts

# 列出playbook涉及的主机
ansible-playbook site.yml --list-hosts
```

**输出示例**：
```
playbook: site.yml
  play #1 (webservers): webservers    TAGS: []
    pattern: ['webservers']
    hosts (3):
      web1.example.com
      web2.example.com  
      web3.example.com
```

**使用场景**：
- **批量操作前确认**：避免误操作
- **inventory验证**：确保主机分组正确
- **权限检查**：确认有权限访问的主机

### 4.2 语法检查


**🔸 --syntax-check：验证语法**

语法检查就像代码编译检查，发现格式错误：

```bash
# 检查playbook语法
ansible-playbook site.yml --syntax-check
```

**正确语法输出**：
```
playbook: site.yml
```

**错误语法输出示例**：
```
ERROR! Syntax Error while loading YAML.
  mapping values are not allowed in this context
  
The error appears to be in 'site.yml': line 12, column 22
```

**💡 语法检查覆盖范围**：
- **YAML格式**：缩进、语法结构
- **Ansible语法**：模块名称、参数格式
- **引用关系**：变量、模板文件存在性

---

## 5. 🔐 加密与安全选项


### 5.1 Vault密码处理


**🔸 --ask-vault-pass：交互式密码**

Ansible Vault用于加密敏感信息，如密码、密钥等：

```bash
# 运行包含加密文件的playbook
ansible-playbook site.yml --ask-vault-pass
```

**交互过程**：
```
Vault password: [用户输入密码]
```

### 5.2 加密文件管理


**创建加密文件**：
```bash
# 创建加密的变量文件
ansible-vault create secrets.yml
```

**编辑加密文件**：
```bash
# 编辑已加密的文件
ansible-vault edit secrets.yml
```

**解密查看**：
```bash
# 临时查看加密内容
ansible-vault view secrets.yml
```

### 5.3 密码文件选项


**避免交互式输入**：
```bash
# 使用密码文件
ansible-playbook site.yml --vault-password-file ~/.ansible_vault_pass

# 使用环境变量
export ANSIBLE_VAULT_PASSWORD_FILE=~/.ansible_vault_pass
ansible-playbook site.yml
```

**安全最佳实践**：
```
✅ 密码文件权限设为600
✅ 不要把密码文件提交到版本控制
✅ 定期轮换vault密码
✅ 使用不同密码文件分离敏感程度
```

---

## 6. 📊 输出格式控制


### 6.1 输出格式选项


**默认输出格式对比**：

```bash
# 标准输出（默认）
ansible all -m setup -a "filter=ansible_os_family"
```

```json
server1 | SUCCESS => {
    "ansible_facts": {
        "ansible_os_family": "Debian"
    }
}
```

**一行输出格式**：
```bash
ansible all -m ping --one-line
```
```
server1 | SUCCESS => {"ping": "pong"}
```

### 6.2 JSON输出处理


**结合jq工具美化**：
```bash
# 获取系统信息并格式化
ansible server1 -m setup | jq '.ansible_facts.ansible_distribution'
```

### 6.3 输出重定向与日志


**保存执行结果**：
```bash
# 保存详细执行日志
ansible-playbook site.yml -v > deployment.log 2>&1

# 只保存错误输出
ansible-playbook site.yml 2> errors.log
```

**日志分析技巧**：
```bash
# 筛选错误信息
grep "FAILED\|ERROR" deployment.log

# 统计执行结果
grep -c "SUCCESS\|FAILED\|CHANGED" deployment.log
```

---

## 7. 📋 核心要点总结


### 7.1 必须掌握的核心选项


```
🔸 版本检查：--version（了解环境）
🔸 详细输出：-v/-vv/-vvv（调试利器）
🔸 预检查：--check --diff（安全第一）
🔸 主机确认：--list-hosts（避免误操作）
🔸 语法检查：--syntax-check（预防错误）
🔸 加密处理：--ask-vault-pass（保护敏感信息）
```

### 7.2 实用命令组合


**🔹 日常运维组合**
```bash
# 安全执行流程
ansible-playbook site.yml --check --diff --list-hosts -v
# 预览 → 确认 → 执行
```

**🔹 故障排查组合**
```bash
# 问题诊断流程
ansible server1 -m ping -vvv
# 详细调试 → 定位问题 → 解决问题
```

**🔹 批量操作组合**
```bash
# 批量更新流程
ansible webservers --list-hosts  # 确认主机
ansible webservers -m ping       # 测试连通性
ansible webservers -m yum -a "name=httpd state=latest" --check --diff
# 最后执行实际操作
```

### 7.3 使用建议与最佳实践


**📌 选项使用原则**：
- **测试优先**：重要操作先用--check
- **逐步调试**：从-v开始，逐步增加详细级别
- **安全意识**：敏感操作使用vault加密
- **确认目标**：批量操作前用--list-hosts确认

**📌 常见使用场景**：
| 场景 | **推荐组合** | **说明** |
|------|-------------|---------|
| `日常检查` | `--check --diff` | `预览变更，安全可靠` |
| `故障排查` | `-vv 或 -vvv` | `详细信息，快速定位` |
| `生产部署` | `--list-hosts --syntax-check` | `确认目标，验证语法` |
| `敏感操作` | `--ask-vault-pass --check` | `加密保护，预览执行` |

**💡 记忆口诀**：
```
版本帮助先了解，详细输出助调试
检查差异保安全，主机语法要验证
加密选项护隐私，输出格式随需选
```

**核心理念**：命令行选项是Ansible操作的"安全阀"和"放大镜"，合理使用能让运维工作更加安全、高效、可控。