---
title: 5、创建自定义角色
---
## 📚 目录


1. [角色系统概述](#1-角色系统概述)
2. [角色初始化与结构](#2-角色初始化与结构)
3. [角色开发流程](#3-角色开发流程)
4. [功能设计与实现](#4-功能设计与实现)
5. [任务与模板开发](#5-任务与模板开发)
6. [变量设计与管理](#6-变量设计与管理)
7. [测试与文档](#7-测试与文档)
8. [版本管理与发布](#8-版本管理与发布)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🎯 角色系统概述



### 1.1 什么是Ansible角色



**🔸 角色的本质**
```
角色（Role）就像一个功能包，把相关的任务、变量、文件等打包在一起
比如：nginx角色包含了安装、配置、启动nginx的所有操作
```

**💡 为什么要用角色**
- **复用性**：一次编写，多处使用
- **模块化**：功能独立，易于维护  
- **标准化**：统一的目录结构和命名规范
- **协作性**：团队间可以共享和交换

### 1.2 角色vs普通playbook



**传统playbook方式：**
```
所有任务写在一个文件里，文件越来越大
不同项目重复写相似的任务
难以维护和共享
```

**角色方式：**
```
按功能分解成独立的角色
每个角色有标准的目录结构
可以像积木一样组合使用
```

---

## 2. 📁 角色初始化与结构



### 2.1 使用ansible-galaxy初始化角色



**🔧 创建新角色**
```bash
# 创建一个名为webserver的角色

ansible-galaxy init webserver

# 指定创建位置

ansible-galaxy init roles/webserver

# 创建后的目录结构

webserver/
├── README.md          # 角色说明文档
├── defaults/          # 默认变量
│   └── main.yml
├── files/            # 静态文件
├── handlers/         # 处理器
│   └── main.yml
├── meta/            # 元数据
│   └── main.yml
├── tasks/           # 主要任务
│   └── main.yml
├── templates/       # Jinja2模板
├── tests/          # 测试用例
│   ├── inventory
│   └── test.yml
└── vars/           # 变量文件
    └── main.yml
```

**💡 目录结构说明**

| 目录/文件 | **作用** | **什么时候用** |
|----------|----------|---------------|
| `tasks/` | **主要任务代码** | 存放角色要执行的所有任务 |
| `defaults/` | **默认变量值** | 可被覆盖的默认配置 |
| `vars/` | **角色变量** | 角色内部使用的变量 |
| `files/` | **静态文件** | 需要复制到目标机器的文件 |
| `templates/` | **模板文件** | 需要变量替换的配置文件 |
| `handlers/` | **事件处理器** | 配置变更后的重启等操作 |
| `meta/` | **角色元信息** | 依赖关系、作者信息等 |

### 2.2 角色目录详解



**🗂️ 各目录的具体用途**

```
┌─ webserver/
│
├─ tasks/main.yml          ← 🎯 核心任务文件
│   ├─ 安装软件包
│   ├─ 复制配置文件  
│   └─ 启动服务
│
├─ defaults/main.yml       ← ⚙️ 默认配置
│   ├─ 端口号: 80
│   ├─ 工作进程数: auto
│   └─ 日志级别: info
│
├─ templates/             ← 📝 配置模板
│   ├─ nginx.conf.j2     
│   └─ vhost.conf.j2
│
├─ files/                ← 📄 静态文件
│   ├─ ssl证书
│   └─ 自定义页面
│
└─ handlers/main.yml     ← 🔄 重启服务
    └─ restart nginx
```

---

## 3. 🔄 角色开发流程



### 3.1 开发流程概览



**📋 标准开发步骤**
```
1️⃣ 需求分析 → 确定角色要实现什么功能
2️⃣ 功能设计 → 分解成具体的任务步骤  
3️⃣ 创建结构 → 用ansible-galaxy init初始化
4️⃣ 编写任务 → 在tasks/main.yml中实现功能
5️⃣ 设计变量 → 在defaults/和vars/中定义变量
6️⃣ 创建模板 → 在templates/中创建配置文件
7️⃣ 编写测试 → 创建测试用例验证功能
8️⃣ 完善文档 → 编写README和使用说明
9️⃣ 版本管理 → 使用git管理代码版本
```

### 3.2 开发最佳实践



**🎯 设计原则**
- **单一职责**：一个角色只做一件事
- **幂等性**：多次运行结果一致
- **可配置性**：通过变量控制行为
- **向后兼容**：新版本不破坏旧用法

**⭐⭐ 重点提醒**
> 开发角色时要考虑不同操作系统的兼容性
> 使用when条件判断来处理系统差异

---

## 4. 🎨 功能设计与实现



### 4.1 需求分析示例



**🎯 以nginx角色为例**
```
功能需求：
✅ 安装nginx服务
✅ 配置nginx主配置文件  
✅ 创建虚拟主机配置
✅ 启动nginx服务
✅ 开机自启动
✅ 防火墙端口开放
```

**🔥 核心任务分解**
```
Task 1: 安装nginx包
Task 2: 创建nginx用户（如果不存在）
Task 3: 复制主配置文件
Task 4: 创建网站目录
Task 5: 复制网站文件
Task 6: 配置虚拟主机
Task 7: 启动nginx服务
Task 8: 配置防火墙
```

### 4.2 跨平台兼容设计



**🖥️ 系统差异处理**

| 操作系统 | **包管理器** | **服务名称** | **配置路径** |
|----------|-------------|-------------|--------------|
| `CentOS/RHEL` | `yum/dnf` | `nginx` | `/etc/nginx/` |
| `Ubuntu/Debian` | `apt` | `nginx` | `/etc/nginx/` |
| `SUSE` | `zypper` | `nginx` | `/etc/nginx/` |

**💡 兼容性处理方法**
```yaml
# 使用when条件判断系统类型

- name: 安装nginx (CentOS/RHEL)
  yum:
    name: nginx
    state: present
  when: ansible_os_family == "RedHat"

- name: 安装nginx (Ubuntu/Debian)  
  apt:
    name: nginx
    state: present
  when: ansible_os_family == "Debian"
```

---

## 5. ⚡ 任务与模板开发



### 5.1 任务文件编写



**📝 tasks/main.yml 结构设计**
```yaml
---
# nginx角色主任务文件


- name: 包含系统特定的变量
  include_vars: "{{ ansible_os_family }}.yml"

- name: 安装nginx包
  package:
    name: "{{ nginx_package_name }}"
    state: present
  notify: restart nginx

- name: 确保nginx配置目录存在
  file:
    path: "{{ nginx_config_dir }}/conf.d"
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: 复制nginx主配置文件
  template:
    src: nginx.conf.j2
    dest: "{{ nginx_config_dir }}/nginx.conf"
    backup: yes
  notify: restart nginx

- name: 创建网站根目录
  file:
    path: "{{ nginx_document_root }}"
    state: directory
    owner: "{{ nginx_user }}"
    group: "{{ nginx_group }}"
    mode: '0755'

- name: 启动并启用nginx服务
  service:
    name: nginx
    state: started
    enabled: yes
```

**🔧 任务编写要点**
- **幂等性**：使用合适的state参数
- **通知机制**：配置变更后通知重启服务
- **备份机制**：重要文件修改前自动备份
- **权限控制**：合理设置文件和目录权限

### 5.2 模板文件开发



**📋 templates/nginx.conf.j2 示例**
```jinja2
# nginx主配置文件模板

user {{ nginx_user }};
worker_processes {{ nginx_worker_processes }};
error_log {{ nginx_error_log }};
pid {{ nginx_pid_file }};

events {
    worker_connections {{ nginx_worker_connections }};
    use epoll;
}

http {
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log {{ nginx_access_log }} main;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout {{ nginx_keepalive_timeout }};
    types_hash_max_size 2048;

    include {{ nginx_config_dir }}/mime.types;
    default_type application/octet-stream;

#    # 包含虚拟主机配置
    include {{ nginx_config_dir }}/conf.d/*.conf;
}
```

**💡 模板开发技巧**
- 使用变量替换固定值
- 保持模板的通用性
- 添加适当的注释说明

---

## 6. 🔧 变量设计与管理



### 6.1 变量分层设计



**📊 变量优先级**
```
高优先级 ↑
├─ 命令行变量 (-e)
├─ playbook变量
├─ inventory变量
├─ 角色vars/变量
└─ 角色defaults/变量
低优先级 ↓
```

**⚙️ defaults/main.yml 默认变量**
```yaml
---
# nginx角色默认配置


# 基础配置

nginx_user: nginx
nginx_group: nginx
nginx_worker_processes: auto
nginx_worker_connections: 1024
nginx_keepalive_timeout: 65

# 路径配置

nginx_config_dir: /etc/nginx
nginx_document_root: /usr/share/nginx/html
nginx_log_dir: /var/log/nginx

# 日志配置

nginx_error_log: "{{ nginx_log_dir }}/error.log"
nginx_access_log: "{{ nginx_log_dir }}/access.log"

# 服务配置

nginx_service_name: nginx
nginx_package_name: nginx

# 虚拟主机配置

nginx_vhosts: []
nginx_remove_default_vhost: false
```

### 6.2 系统特定变量



**🖥️ vars/RedHat.yml (CentOS/RHEL)**
```yaml
---
nginx_user: nginx
nginx_group: nginx
nginx_pid_file: /var/run/nginx.pid
nginx_config_dir: /etc/nginx
nginx_document_root: /usr/share/nginx/html
```

**🖥️ vars/Debian.yml (Ubuntu/Debian)**
```yaml
---
nginx_user: www-data
nginx_group: www-data
nginx_pid_file: /var/run/nginx.pid
nginx_config_dir: /etc/nginx
nginx_document_root: /var/www/html
```

**🎯 变量设计原则**
- **默认可用**：提供合理的默认值
- **易于覆盖**：用户可以简单修改
- **系统适配**：考虑不同系统的差异
- **文档清晰**：变量用途要说明清楚

---

## 7. 🧪 测试与文档



### 7.1 角色测试



**📝 tests/test.yml 测试用例**
```yaml
---
- hosts: localhost
  remote_user: root
  roles:
    - webserver
  vars:
    nginx_worker_processes: 2
    nginx_vhosts:
      - server_name: example.com
        document_root: /var/www/example
```

**🔍 测试执行**
```bash
# 运行角色测试

ansible-playbook -i tests/inventory tests/test.yml

# 使用molecule进行高级测试（可选）

pip install molecule
molecule init role webserver --driver-name docker
molecule test
```

### 7.2 文档编写



**📖 README.md 文档结构**
```markdown
# Webserver Role


# 功能描述


这个角色用于安装和配置nginx web服务器

# 系统要求


- CentOS 7+
- Ubuntu 18.04+
- 需要sudo权限

# 角色变量


| 变量名 | 默认值 | 说明 |
|--------|--------|------|
| nginx_worker_processes | auto | 工作进程数 |
| nginx_worker_connections | 1024 | 每个进程的连接数 |

# 使用示例


```yaml
- hosts: webservers
  roles:
    - role: webserver
      nginx_worker_processes: 4
```

# 许可证


MIT
```

**💡 文档要点**
- **功能说明**：角色的作用和用途
- **系统要求**：支持的操作系统版本
- **变量文档**：所有可配置的变量
- **使用示例**：具体的使用方法
- **许可证信息**：开源许可证

---

## 8. 📦 版本管理与发布



### 8.1 Git版本管理



**🔀 版本管理流程**
```bash
# 初始化git仓库

git init
git add .
git commit -m "初始版本：创建webserver角色"

# 创建版本标签

git tag v1.0.0
git push origin v1.0.0

# 分支管理

git checkout -b feature/ssl-support
# 开发新功能...

git merge feature/ssl-support
```

**📋 版本号规范**
```
v1.0.0  ← 主版本.次版本.修订版本

主版本：不兼容的API修改
次版本：向下兼容的功能性新增
修订版本：向下兼容的问题修正
```

### 8.2 角色发布



**🌟 发布到Ansible Galaxy**
```bash
# 创建galaxy.yml文件

galaxy_info:
  author: your-name
  description: Nginx web server role
  company: your-company
  license: MIT
  min_ansible_version: 2.9
  platforms:
    - name: EL
      versions:
        - 7
        - 8
    - name: Ubuntu
      versions:
        - bionic
        - focal

# 上传到Galaxy

ansible-galaxy import github_user repository_name
```

**🔗 私有仓库管理**
```bash
# 安装私有角色

ansible-galaxy install git+https://github.com/company/webserver-role.git

# 通过requirements.yml管理

echo "- src: git+https://github.com/company/webserver-role.git
  name: webserver" > requirements.yml

ansible-galaxy install -r requirements.yml
```

---

## 9. 📋 核心要点总结



### 9.1 必须掌握的核心概念



```
🔸 角色结构：标准的目录组织方式
🔸 角色初始化：使用ansible-galaxy init创建
🔸 任务编写：在tasks/main.yml中实现核心功能
🔸 变量设计：defaults/和vars/的区别和用途  
🔸 模板开发：使用Jinja2模板处理配置文件
🔸 跨平台兼容：处理不同操作系统的差异
🔸 测试验证：编写测试用例验证角色功能
🔸 文档完善：编写清晰的README和变量说明
```

### 9.2 角色开发最佳实践



**🎯 设计原则**
- **🟢 基础级**：掌握标准目录结构和基本语法
- **🟡 进阶级**：理解变量优先级和模板语法  
- **🔴 高级级**：具备跨平台兼容和性能优化能力

**💪 实践建议**
- **动手练习**：从简单角色开始，逐步增加复杂度
- **代码复用**：学会使用include和import组织代码
- **社区学习**：研究Galaxy上优秀角色的代码

**🧠 记忆技巧**
```
角色开发八步走：
1. Galaxy初始化  2. 需求分析清
3. 任务来实现  4. 变量要设计  
5. 模板配置化  6. 测试要跟上
7. 文档写清楚  8. 版本管理好
```

### 9.3 常见问题与解决



**❗ 常见误区**
- **误区1**：把所有任务都写在main.yml里
- **误区2**：不考虑跨平台兼容性
- **误区3**：变量命名不规范，容易冲突

**✨ 推荐做法**
- 使用include_tasks拆分复杂任务
- 用when条件处理系统差异
- 给变量添加角色前缀避免冲突

**🚨 重要提醒**
> 角色开发要考虑团队协作，代码要清晰易懂
> 每个角色都应该有完整的测试用例
> 文档是角色的重要组成部分，不可忽视

**🔑 核心记忆**
- Ansible角色是功能模块化的最佳实践
- 标准的目录结构让代码更好维护
- 变量分层设计提供灵活的配置能力
- 跨平台兼容是生产环境的基本要求
- 测试和文档是角色质量的重要保证