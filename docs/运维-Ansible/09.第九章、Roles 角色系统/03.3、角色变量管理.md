---
title: 3ã€è§’è‰²å˜é‡ç®¡ç†
---
## ğŸ“š ç›®å½•


1. [è§’è‰²å˜é‡ç³»ç»Ÿæ¦‚è¿°](#1-è§’è‰²å˜é‡ç³»ç»Ÿæ¦‚è¿°)
2. [defaultsé»˜è®¤å˜é‡](#2-defaultsé»˜è®¤å˜é‡)
3. [varsè§’è‰²å˜é‡](#3-varsè§’è‰²å˜é‡)
4. [å˜é‡ä¼˜å…ˆçº§æœºåˆ¶](#4-å˜é‡ä¼˜å…ˆçº§æœºåˆ¶)
5. [å˜é‡æ–‡ä»¶ç»„ç»‡](#5-å˜é‡æ–‡ä»¶ç»„ç»‡)
6. [å˜é‡å‘½åç©ºé—´](#6-å˜é‡å‘½åç©ºé—´)
7. [å˜é‡æ–‡æ¡£åŒ–](#7-å˜é‡æ–‡æ¡£åŒ–)
8. [å˜é‡éªŒè¯](#8-å˜é‡éªŒè¯)
9. [æ•æ„Ÿå˜é‡å¤„ç†](#9-æ•æ„Ÿå˜é‡å¤„ç†)
10. [å˜é‡é‡å†™æœºåˆ¶](#10-å˜é‡é‡å†™æœºåˆ¶)
11. [è§’è‰²é—´å˜é‡ä¼ é€’](#11-è§’è‰²é—´å˜é‡ä¼ é€’)
12. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#12-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

# ğŸ¯ **å­¦ä¹ è·¯å¾„å¯¼èˆª**


**å‰ç½®çŸ¥è¯†**ï¼šéœ€è¦æŒæ¡AnsibleåŸºç¡€è¯­æ³•ã€Playbookç¼–å†™ â†’ **å½“å‰å†…å®¹**ï¼šè§’è‰²å˜é‡ç®¡ç† â†’ **åç»­å­¦ä¹ **ï¼šå»ºè®®å­¦ä¹ Ansible Galaxyå’Œé«˜çº§æ¨¡æ¿

â±ï¸ **é¢„è®¡å­¦ä¹ æ—¶é—´**ï¼šæœ¬ç« é¢„è®¡90åˆ†é’Ÿ | å®è·µç»ƒä¹ 60åˆ†é’Ÿ

---

## 1. ğŸ—‚ï¸ è§’è‰²å˜é‡ç³»ç»Ÿæ¦‚è¿°



### 1.1 ä»€ä¹ˆæ˜¯è§’è‰²å˜é‡



**ğŸ”¸ æ ¸å¿ƒå®šä¹‰**
Ansibleè§’è‰²å˜é‡æ˜¯è§’è‰²å†…éƒ¨ä½¿ç”¨çš„é…ç½®å‚æ•°ï¼Œè®©è§’è‰²å…·æœ‰çµæ´»æ€§å’Œå¯é‡ç”¨æ€§ã€‚å°±åƒå‡½æ•°çš„å‚æ•°ä¸€æ ·ï¼Œé€šè¿‡å˜é‡æ¥æ§åˆ¶è§’è‰²çš„è¡Œä¸ºã€‚

**ğŸ’¡ ç”Ÿæ´»åŒ–ç±»æ¯”**
æƒ³è±¡è§’è‰²æ˜¯ä¸€ä¸ª"æ™ºèƒ½å®¶ç”µ"ï¼š
- **å˜é‡**å°±åƒé¥æ§å™¨çš„æŒ‰é’®ï¼Œç”¨æ¥è°ƒèŠ‚ä¸åŒè®¾ç½®
- **é»˜è®¤å€¼**æ˜¯å‡ºå‚è®¾ç½®ï¼Œå¼€ç®±å³ç”¨
- **è‡ªå®šä¹‰å€¼**æ˜¯ç”¨æˆ·ä¸ªæ€§åŒ–é…ç½®

### 1.2 å˜é‡åœ¨è§’è‰²ä¸­çš„ä½ç½®



**ğŸ“ è§’è‰²ç›®å½•ç»“æ„**
```
my_role/
â”œâ”€â”€ defaults/           # é»˜è®¤å˜é‡ï¼ˆä¼˜å…ˆçº§æœ€ä½ï¼‰
â”‚   â””â”€â”€ main.yml
â”œâ”€â”€ vars/              # è§’è‰²å˜é‡ï¼ˆä¼˜å…ˆçº§è¾ƒé«˜ï¼‰
â”‚   â””â”€â”€ main.yml
â”œâ”€â”€ tasks/             # ä»»åŠ¡æ–‡ä»¶
â”œâ”€â”€ templates/         # æ¨¡æ¿æ–‡ä»¶
â”œâ”€â”€ files/             # é™æ€æ–‡ä»¶
â”œâ”€â”€ handlers/          # å¤„ç†å™¨
â”œâ”€â”€ meta/              # è§’è‰²å…ƒæ•°æ®
â””â”€â”€ README.md          # è¯´æ˜æ–‡æ¡£
```

### 1.3 å˜é‡ç±»å‹å¯¹æ¯”



| **å˜é‡ç±»å‹** | **ä½ç½®** | **ç”¨é€”** | **ä¼˜å…ˆçº§** | **å¯é‡å†™** |
|-------------|---------|---------|-----------|-----------|
| **defaults** | `defaults/main.yml` | é»˜è®¤é…ç½® | æœ€ä½ â­ | âœ… å®¹æ˜“ |
| **vars** | `vars/main.yml` | è§’è‰²å†…éƒ¨å˜é‡ | è¾ƒé«˜ â­â­â­ | âš ï¸ å›°éš¾ |
| **ä»»åŠ¡å˜é‡** | ä»»åŠ¡ä¸­å®šä¹‰ | ä¸´æ—¶ä½¿ç”¨ | æœ€é«˜ â­â­â­â­ | âŒ ä¸å¯ |

---

## 2. ğŸ¨ defaultsé»˜è®¤å˜é‡



### 2.1 defaultså˜é‡çš„ç‰¹ç‚¹



**ğŸ”¸ æ ¸å¿ƒç‰¹æ€§**
- **æœ€ä½ä¼˜å…ˆçº§**ï¼šå®¹æ˜“è¢«å…¶ä»–å˜é‡è¦†ç›–
- **æä¾›é»˜è®¤å€¼**ï¼šè§’è‰²å¼€ç®±å³ç”¨çš„åŸºç¡€é…ç½®
- **ç”¨æˆ·å‹å¥½**ï¼šæœ€å®¹æ˜“è¢«å¤–éƒ¨è‡ªå®šä¹‰

**ğŸ’¡ ä½¿ç”¨åœºæ™¯**
```
âœ… é€‚åˆç”¨ä½œdefaultsï¼š
â€¢ æœåŠ¡ç«¯å£å·ã€è¶…æ—¶æ—¶é—´
â€¢ è½¯ä»¶åŒ…ç‰ˆæœ¬ã€å®‰è£…è·¯å¾„
â€¢ åŠŸèƒ½å¼€å…³ï¼ˆå¯ç”¨/ç¦ç”¨ï¼‰

âŒ ä¸é€‚åˆç”¨ä½œdefaultsï¼š
â€¢ æ•æ„Ÿä¿¡æ¯ï¼ˆå¯†ç ã€å¯†é’¥ï¼‰
â€¢ ç³»ç»Ÿç›¸å…³è·¯å¾„
â€¢ å¿…é¡»ç”±ç”¨æˆ·æŒ‡å®šçš„å‚æ•°
```

### 2.2 defaultså˜é‡å®šä¹‰



**ğŸ“ åŸºæœ¬å®šä¹‰æ–¹å¼**
```yaml
# roles/webserver/defaults/main.yml

---
# WebæœåŠ¡å™¨é…ç½®

webserver_port: 80
webserver_ssl_port: 443
webserver_worker_processes: auto

# è½¯ä»¶åŒ…é…ç½®

nginx_version: "1.20.*"
nginx_user: www-data
nginx_group: www-data

# åŠŸèƒ½å¼€å…³

nginx_ssl_enabled: true
nginx_gzip_enabled: true
nginx_cache_enabled: false

# è·¯å¾„é…ç½®

nginx_conf_dir: /etc/nginx
nginx_log_dir: /var/log/nginx
nginx_web_root: /var/www/html
```

### 2.3 defaultsæœ€ä½³å®è·µ



**ğŸ¯ å‘½åçº¦å®š**
```yaml
# æ¨èï¼šä½¿ç”¨è§’è‰²åå‰ç¼€

mysql_port: 3306
mysql_root_password: ""
mysql_databases: []

# é¿å…ï¼šé€šç”¨åç§°å®¹æ˜“å†²çª

port: 3306        # âŒ å¤ªé€šç”¨
password: ""      # âŒ å¯èƒ½å†²çª
databases: []     # âŒ ä¸å¤Ÿæ˜ç¡®
```

**ğŸ“Š æ•°æ®ç±»å‹ä½¿ç”¨**
```yaml
# å­—ç¬¦ä¸²ç±»å‹

app_name: "my-application"
app_version: "1.2.3"

# æ•°å­—ç±»å‹  

app_port: 8080
app_timeout: 30

# å¸ƒå°”ç±»å‹

app_ssl_enabled: true
app_debug_mode: false

# åˆ—è¡¨ç±»å‹

app_allowed_ips:
  - "192.168.1.0/24"
  - "10.0.0.0/8"

# å­—å…¸ç±»å‹

app_database:
  host: localhost
  port: 5432
  name: myapp_db
  user: myapp_user
```

---

## 3. âš™ï¸ varsè§’è‰²å˜é‡



### 3.1 varså˜é‡ç‰¹ç‚¹



**ğŸ”¸ å…³é”®ç‰¹æ€§**
- **é«˜ä¼˜å…ˆçº§**ï¼šä¸å®¹æ˜“è¢«è¦†ç›–
- **è§’è‰²å†…éƒ¨é€»è¾‘**ï¼šæ§åˆ¶è§’è‰²å†…éƒ¨è¡Œä¸º
- **è®¡ç®—å˜é‡**ï¼šåŸºäºå…¶ä»–å˜é‡è®¡ç®—å¾—å‡º

### 3.2 varsä½¿ç”¨åœºæ™¯



**ğŸ› ï¸ å†…éƒ¨è®¡ç®—å˜é‡**
```yaml
# roles/webapp/vars/main.yml

---
# åŸºäºæ“ä½œç³»ç»Ÿçš„å˜é‡è®¡ç®—

nginx_service_name: "{{ 'nginx' if ansible_os_family == 'RedHat' else 'nginx' }}"
nginx_config_file: "{{ nginx_conf_dir }}/nginx.conf"

# åŸºäºæ¡ä»¶çš„è·¯å¾„è®¡ç®—

app_log_file: "{{ nginx_log_dir }}/{{ app_name }}.log"
app_pid_file: "/var/run/{{ app_name }}.pid"

# å¤åˆé…ç½®

nginx_upstream_servers: |
  {% for server in app_backend_servers %}
  server {{ server.ip }}:{{ server.port }} weight={{ server.weight | default(1) }};
  {% endfor %}
```

### 3.3 varsä¸defaultsé…åˆä½¿ç”¨



**ğŸ”„ ååŒå·¥ä½œæ¨¡å¼**
```yaml
# defaults/main.yml - ç”¨æˆ·å¯é…ç½®é¡¹

app_name: myapp
app_port: 8080
app_backend_servers:
  - { ip: "192.168.1.10", port: 8080 }
  - { ip: "192.168.1.11", port: 8080 }

# vars/main.yml - å†…éƒ¨é€»è¾‘å˜é‡

app_config_dir: "/etc/{{ app_name }}"
app_service_file: "/etc/systemd/system/{{ app_name }}.service"
nginx_upstream_name: "{{ app_name }}_backend"
```

---

## 4. ğŸ”¢ å˜é‡ä¼˜å…ˆçº§æœºåˆ¶



### 4.1 Ansibleå˜é‡ä¼˜å…ˆçº§é¡ºåº



**ğŸ“Š ä¼˜å…ˆçº§æ’åºï¼ˆä»é«˜åˆ°ä½ï¼‰**
```
ğŸ“‹ å˜é‡ä¼˜å…ˆçº§åˆ—è¡¨ï¼š

1ï¸âƒ£ å‘½ä»¤è¡Œ -e å‚æ•°         (æœ€é«˜ä¼˜å…ˆçº§)
2ï¸âƒ£ ä»»åŠ¡ä¸­çš„ vars
3ï¸âƒ£ include_vars åŠ è½½çš„å˜é‡
4ï¸âƒ£ set_facts è®¾ç½®çš„å˜é‡
5ï¸âƒ£ æ³¨å†Œå˜é‡ (register)
6ï¸âƒ£ vars_files ä¸­çš„å˜é‡
7ï¸âƒ£ vars_prompt ä¸­çš„å˜é‡
8ï¸âƒ£ Playbook ä¸­çš„ vars
9ï¸âƒ£ host_vars æ–‡ä»¶
ğŸ”Ÿ group_vars æ–‡ä»¶
1ï¸âƒ£1ï¸âƒ£ è§’è‰² vars/main.yml
1ï¸âƒ£2ï¸âƒ£ inventory ä¸­çš„å˜é‡
1ï¸âƒ£3ï¸âƒ£ è§’è‰² defaults/main.yml    (æœ€ä½ä¼˜å…ˆçº§)
```

### 4.2 ä¼˜å…ˆçº§å®é™…åº”ç”¨



**ğŸ¯ è¦†ç›–ç­–ç•¥ç¤ºä¾‹**
```yaml
# è§’è‰² defaults/main.yml

mysql_port: 3306

# group_vars/webservers.yml  

mysql_port: 3307          # è¦†ç›–defaults

# host_vars/web01.yml

mysql_port: 3308          # è¦†ç›–group_vars

# å‘½ä»¤è¡Œæ‰§è¡Œ

ansible-playbook -e "mysql_port=3309" site.yml  # æœ€ç»ˆç”Ÿæ•ˆ
```

### 4.3 å˜é‡è¦†ç›–éªŒè¯



**ğŸ” è°ƒè¯•å˜é‡å€¼**
```yaml
# åœ¨ä»»åŠ¡ä¸­æŸ¥çœ‹å˜é‡æœ€ç»ˆå€¼

- name: æ˜¾ç¤ºå½“å‰ç”Ÿæ•ˆçš„å˜é‡å€¼
  debug:
    msg: |
      å½“å‰MySQLç«¯å£: {{ mysql_port }}
      å˜é‡æ¥æº: {{ mysql_port | default('æœªå®šä¹‰') }}
```

---

## 5. ğŸ“ å˜é‡æ–‡ä»¶ç»„ç»‡



### 5.1 æŒ‰ç¯å¢ƒç»„ç»‡å˜é‡



**ğŸ—ï¸ ç¯å¢ƒåˆ†ç¦»ç»“æ„**
```
roles/webapp/
â”œâ”€â”€ defaults/
â”‚   â”œâ”€â”€ main.yml          # é€šç”¨é»˜è®¤å€¼
â”‚   â”œâ”€â”€ development.yml   # å¼€å‘ç¯å¢ƒé»˜è®¤å€¼
â”‚   â”œâ”€â”€ staging.yml       # æµ‹è¯•ç¯å¢ƒé»˜è®¤å€¼  
â”‚   â””â”€â”€ production.yml    # ç”Ÿäº§ç¯å¢ƒé»˜è®¤å€¼
â”œâ”€â”€ vars/
â”‚   â”œâ”€â”€ main.yml          # é€šç”¨å˜é‡
â”‚   â”œâ”€â”€ RedHat.yml        # RedHatç³»ç»Ÿå˜é‡
â”‚   â””â”€â”€ Debian.yml        # Debianç³»ç»Ÿå˜é‡
```

**ğŸ”§ åŠ¨æ€åŠ è½½å˜é‡æ–‡ä»¶**
```yaml
# tasks/main.yml

- name: åŠ è½½æ“ä½œç³»ç»Ÿç›¸å…³å˜é‡
  include_vars: "{{ ansible_os_family }}.yml"
  
- name: åŠ è½½ç¯å¢ƒç›¸å…³å˜é‡  
  include_vars: "{{ app_environment | default('production') }}.yml"
  when: app_environment is defined
```

### 5.2 æŒ‰åŠŸèƒ½æ¨¡å—ç»„ç»‡



**ğŸ§© æ¨¡å—åŒ–å˜é‡ç»“æ„**
```yaml
# defaults/main.yml - ä¸»é…ç½®æ–‡ä»¶

---
# å¯¼å…¥å„åŠŸèƒ½æ¨¡å—å˜é‡

database: "{{ webapp_database }}"
cache: "{{ webapp_cache }}"
logging: "{{ webapp_logging }}"

# defaults/database.yml

---
webapp_database:
  host: localhost
  port: 3306
  name: webapp_db
  user: webapp_user
  max_connections: 100

# defaults/cache.yml  

---
webapp_cache:
  type: redis
  host: localhost
  port: 6379
  ttl: 3600
```

### 5.3 å˜é‡æ–‡ä»¶åŠ è½½ç­–ç•¥



**âš¡ æ™ºèƒ½åŠ è½½æœºåˆ¶**
```yaml
- name: æŒ‰ä¼˜å…ˆçº§åŠ è½½é…ç½®æ–‡ä»¶
  include_vars: "{{ item }}"
  with_first_found:
    - files:
        - "{{ ansible_hostname }}.yml"      # ä¸»æœºç‰¹å®š
        - "{{ app_environment }}.yml"       # ç¯å¢ƒç‰¹å®š
        - "{{ ansible_os_family }}.yml"     # ç³»ç»Ÿç‰¹å®š
        - "main.yml"                        # é»˜è®¤é…ç½®
      paths:
        - "{{ role_path }}/vars"
        - "{{ role_path }}/defaults"
```

---

## 6. ğŸ·ï¸ å˜é‡å‘½åç©ºé—´



### 6.1 å‘½åç©ºé—´è®¾è®¡åŸåˆ™



**ğŸ¯ å‘½åè§„èŒƒ**
```yaml
# âœ… æ¨èï¼šä½¿ç”¨è§’è‰²åä½œä¸ºå‰ç¼€

nginx_worker_processes: auto
nginx_client_max_body_size: 10m
nginx_ssl_certificate_path: /etc/ssl/certs

# âœ… æ¨èï¼šä½¿ç”¨åŠŸèƒ½åˆ†ç»„

mysql_server_port: 3306
mysql_server_bind_address: 0.0.0.0
mysql_client_default_charset: utf8mb4

# âŒ é¿å…ï¼šé€šç”¨åç§°

port: 80              # å¯èƒ½ä¸å…¶ä»–è§’è‰²å†²çª
timeout: 30           # å«ä¹‰ä¸æ˜ç¡®
config_file: ""       # å¤ªå®½æ³›
```

### 6.2 åµŒå¥—å‘½åç©ºé—´



**ğŸ—‚ï¸ ç»“æ„åŒ–å˜é‡ç»„ç»‡**
```yaml
# æ¨èï¼šä½¿ç”¨å­—å…¸ç»“æ„ç»„ç»‡ç›¸å…³å˜é‡

webapp:
  name: myapp
  version: "1.2.3"
  port: 8080
  ssl:
    enabled: true
    cert_path: /etc/ssl/certs/app.crt
    key_path: /etc/ssl/private/app.key
  database:
    host: localhost
    port: 3306
    name: myapp_db
    user: myapp_user
  cache:
    type: redis
    host: localhost
    port: 6379
```

**ğŸ“ ä½¿ç”¨åµŒå¥—å˜é‡**
```yaml
# åœ¨ä»»åŠ¡ä¸­å¼•ç”¨åµŒå¥—å˜é‡

- name: é…ç½®åº”ç”¨ç«¯å£
  lineinfile:
    path: /etc/myapp/config.conf
    line: "port={{ webapp.port }}"

- name: æ£€æŸ¥SSLæ˜¯å¦å¯ç”¨
  debug:
    msg: "SSLçŠ¶æ€: {{ 'enabled' if webapp.ssl.enabled else 'disabled' }}"
```

### 6.3 å‘½åç©ºé—´å†²çªå¤„ç†



**âš ï¸ å†²çªé¢„é˜²ç­–ç•¥**
```yaml
# ä½¿ç”¨æ›´å…·ä½“çš„å‰ç¼€

apache_webserver_port: 80        # è€Œä¸æ˜¯ webserver_port
nginx_webserver_port: 80         # é¿å…ä¸apacheå†²çª

# ä½¿ç”¨è§’è‰²ç‰¹å®šçš„å‘½åç©ºé—´

mongodb_cluster:
  replica_set_name: rs0
  
mysql_cluster:
  master_host: db01.example.com
```

---

## 7. ğŸ“– å˜é‡æ–‡æ¡£åŒ–



### 7.1 å˜é‡æ–‡æ¡£ç¼–å†™



**ğŸ“‹ README.mdå˜é‡è¯´æ˜**
```markdown
# WebServer Role


# å˜é‡è¯´æ˜



## å¿…éœ€å˜é‡


| å˜é‡å | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|
| `webserver_domain` | string | ç½‘ç«™åŸŸå | `example.com` |
| `webserver_ssl_cert` | string | SSLè¯ä¹¦è·¯å¾„ | `/etc/ssl/certs/site.crt` |

## å¯é€‰å˜é‡  


| å˜é‡å | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `webserver_port` | integer | `80` | HTTPç›‘å¬ç«¯å£ |
| `webserver_worker_processes` | string | `auto` | Workerè¿›ç¨‹æ•° |
| `webserver_ssl_enabled` | boolean | `true` | æ˜¯å¦å¯ç”¨SSL |

## é«˜çº§é…ç½®


```yaml
# SSLé…ç½®ç¤ºä¾‹

webserver_ssl:
  protocols: ["TLSv1.2", "TLSv1.3"]
  ciphers: "ECDHE-RSA-AES256-GCM-SHA384"
  prefer_server_ciphers: true
```
```

### 7.2 å†…è”æ–‡æ¡£æ³¨é‡Š



**ğŸ’¬ ä»£ç æ³¨é‡Šæœ€ä½³å®è·µ**
```yaml
# defaults/main.yml

---
# ==============================================

# WebæœåŠ¡å™¨åŸºç¡€é…ç½®

# ==============================================


# æœåŠ¡ç›‘å¬ç«¯å£ (1-65535)

# æ³¨æ„ï¼šå°äº1024çš„ç«¯å£éœ€è¦rootæƒé™

webserver_port: 80

# Workerè¿›ç¨‹æ•°é…ç½®

# å¯é€‰å€¼: æ•°å­— | 'auto' 

# å»ºè®®: è®¾ç½®ä¸ºCPUæ ¸å¿ƒæ•°

webserver_worker_processes: auto

# SSL/TLSé…ç½®

# å¯ç”¨SSLéœ€è¦åŒæ—¶é…ç½®è¯ä¹¦è·¯å¾„

webserver_ssl_enabled: true

# è¯ä¹¦æ–‡ä»¶è·¯å¾„ (å½“ssl_enabled=trueæ—¶å¿…éœ€)

# ç¡®ä¿Ansibleè¿è¡Œç”¨æˆ·æœ‰è¯»å–æƒé™

webserver_ssl_cert: ""     # å¿…éœ€: SSLè¯ä¹¦æ–‡ä»¶è·¯å¾„
webserver_ssl_key: ""      # å¿…éœ€: SSLç§é’¥æ–‡ä»¶è·¯å¾„

# å®¢æˆ·ç«¯è¿æ¥é…ç½®

webserver_keepalive_timeout: 65        # è¿æ¥ä¿æŒæ—¶é—´(ç§’)
webserver_client_max_body_size: 10m    # æœ€å¤§è¯·æ±‚ä½“å¤§å°
```

### 7.3 å˜é‡éªŒè¯æ–‡æ¡£



**ğŸ” éªŒè¯è§„åˆ™è¯´æ˜**
```yaml
# meta/main.yml

---
galaxy_info:
  description: WebæœåŠ¡å™¨é…ç½®è§’è‰²
  
# å˜é‡éªŒè¯è§„åˆ™æ–‡æ¡£  

argument_specs:
  main:
    short_description: é…ç½®WebæœåŠ¡å™¨
    options:
      webserver_port:
        description: HTTPç›‘å¬ç«¯å£
        type: int
        required: false
        default: 80
        
      webserver_domain:
        description: æœåŠ¡å™¨åŸŸå
        type: str
        required: true
        
      webserver_ssl_enabled:
        description: æ˜¯å¦å¯ç”¨SSL
        type: bool
        required: false
        default: true
```

---

## 8. âœ… å˜é‡éªŒè¯



### 8.1 åŸºç¡€å˜é‡éªŒè¯



**ğŸ” ä½¿ç”¨assertæ¨¡å—éªŒè¯**
```yaml
# tasks/validate.yml

---
- name: éªŒè¯å¿…éœ€å˜é‡å·²å®šä¹‰
  assert:
    that:
      - webserver_domain is defined
      - webserver_domain | length > 0
    fail_msg: "webserver_domain å¿…é¡»å®šä¹‰ä¸”ä¸èƒ½ä¸ºç©º"
    success_msg: "åŸŸåé…ç½®éªŒè¯é€šè¿‡"

- name: éªŒè¯ç«¯å£èŒƒå›´
  assert:
    that:
      - webserver_port is number
      - webserver_port >= 1
      - webserver_port <= 65535
    fail_msg: "ç«¯å£å·å¿…é¡»æ˜¯1-65535ä¹‹é—´çš„æ•°å­—"
    
- name: éªŒè¯SSLé…ç½®å®Œæ•´æ€§
  assert:
    that:
      - webserver_ssl_cert is defined
      - webserver_ssl_key is defined  
      - webserver_ssl_cert | length > 0
      - webserver_ssl_key | length > 0
    fail_msg: "å¯ç”¨SSLæ—¶å¿…é¡»æŒ‡å®šè¯ä¹¦å’Œç§é’¥è·¯å¾„"
  when: webserver_ssl_enabled | bool
```

### 8.2 é«˜çº§å˜é‡éªŒè¯



**ğŸ›¡ï¸ å¤åˆæ¡ä»¶éªŒè¯**
```yaml
- name: éªŒè¯æ•°æ®åº“é…ç½®
  assert:
    that:
      - webapp.database.host is defined
      - webapp.database.port is number
      - webapp.database.port >= 1024
      - webapp.database.name is match('^[a-zA-Z0-9_]+$')
    fail_msg: |
      æ•°æ®åº“é…ç½®éªŒè¯å¤±è´¥ï¼š
      - host: å¿…é¡»å®šä¹‰æ•°æ®åº“ä¸»æœº
      - port: ç«¯å£å¿…é¡»æ˜¯>=1024çš„æ•°å­—  
      - name: æ•°æ®åº“ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿
    quiet: false

- name: éªŒè¯SSLè¯ä¹¦æ–‡ä»¶å­˜åœ¨æ€§
  stat:
    path: "{{ webserver_ssl_cert }}"
  register: cert_file_stat
  when: webserver_ssl_enabled | bool

- name: ç¡®è®¤è¯ä¹¦æ–‡ä»¶å¯è®¿é—®
  assert:
    that:
      - cert_file_stat.stat.exists
      - cert_file_stat.stat.readable
    fail_msg: "SSLè¯ä¹¦æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ— æ³•è¯»å–: {{ webserver_ssl_cert }}"
  when: webserver_ssl_enabled | bool
```

### 8.3 è‡ªå®šä¹‰éªŒè¯å‡½æ•°



**âš™ï¸ éªŒè¯ä»»åŠ¡æ¨¡å—åŒ–**
```yaml
# tasks/validation/main.yml

---
- name: æ‰§è¡Œæ‰€æœ‰éªŒè¯æ£€æŸ¥
  include_tasks: "{{ item }}"
  loop:
    - required_vars.yml
    - network_config.yml  
    - ssl_config.yml
    - database_config.yml

# tasks/validation/required_vars.yml  

---
- name: æ£€æŸ¥å¿…éœ€å˜é‡
  fail:
    msg: "å¿…éœ€å˜é‡ {{ item }} æœªå®šä¹‰"
  when: vars[item] is not defined
  loop:
    - webserver_domain
    - webserver_admin_email
```

---

## 9. ğŸ” æ•æ„Ÿå˜é‡å¤„ç†



### 9.1 å¯†ç å’Œå¯†é’¥ç®¡ç†



**ğŸ”‘ Ansible Vaultä½¿ç”¨**
```bash
# åˆ›å»ºåŠ å¯†å˜é‡æ–‡ä»¶

ansible-vault create roles/webapp/vars/secrets.yml

# ç¼–è¾‘åŠ å¯†æ–‡ä»¶

ansible-vault edit roles/webapp/vars/secrets.yml

# æŸ¥çœ‹åŠ å¯†æ–‡ä»¶

ansible-vault view roles/webapp/vars/secrets.yml
```

**ğŸ“ æ•æ„Ÿå˜é‡å®šä¹‰**
```yaml
# vars/secrets.yml (åŠ å¯†æ–‡ä»¶)

$ANSIBLE_VAULT;1.1;AES256
66386439653737336464663464633464336464633734643031363...

# è§£å¯†åå†…å®¹:

---
webapp_db_password: "super_secret_password"
webapp_api_key: "abc123def456ghi789"
webapp_jwt_secret: "my_jwt_signing_key"
```

### 9.2 æ•æ„Ÿå˜é‡ä½¿ç”¨



**ğŸ›¡ï¸ å®‰å…¨ä½¿ç”¨æ–¹å¼**
```yaml
# åœ¨ä»»åŠ¡ä¸­ä½¿ç”¨æ•æ„Ÿå˜é‡

- name: é…ç½®æ•°æ®åº“è¿æ¥
  template:
    src: database.conf.j2
    dest: /etc/myapp/database.conf
    mode: '0600'     # é™åˆ¶æ–‡ä»¶æƒé™
  no_log: true       # ä¸è®°å½•æ•æ„Ÿä¿¡æ¯åˆ°æ—¥å¿—
  
# æ¨¡æ¿æ–‡ä»¶ä¸­ä½¿ç”¨

# templates/database.conf.j2

database:
  host: "{{ webapp.database.host }}"
  port: "{{ webapp.database.port }}"
  username: "{{ webapp.database.user }}"
  password: "{{ webapp_db_password }}"
```

### 9.3 æ•æ„Ÿå˜é‡æœ€ä½³å®è·µ



**ğŸ¯ å®‰å…¨ç®¡ç†ç­–ç•¥**
```yaml
# âœ… æ¨èåšæ³•

- name: å¤„ç†æ•æ„Ÿæ•°æ®
  mysql_user:
    name: "{{ webapp.database.user }}"
    password: "{{ webapp_db_password }}"
    priv: "{{ webapp.database.name }}.*:ALL"
  no_log: true                    # éšè—æ•æ„Ÿè¾“å‡º
  
# ä½¿ç”¨lookupæ’ä»¶è¯»å–å¤–éƒ¨å¯†é’¥

- name: ä»å¤–éƒ¨æ–‡ä»¶è¯»å–APIå¯†é’¥
  set_fact:
    api_key: "{{ lookup('file', '/etc/secrets/api.key') }}"
  no_log: true

# âŒ é¿å…çš„åšæ³•  

- name: ä¸è¦åœ¨debugä¸­æ˜¾ç¤ºå¯†ç 
  debug:
    var: webapp_db_password       # âŒ å¯†ç ä¼šæ˜¾ç¤ºåœ¨è¾“å‡ºä¸­
```

---

## 10. ğŸ”„ å˜é‡é‡å†™æœºåˆ¶



### 10.1 ä¼˜é›…çš„å˜é‡é‡å†™



**ğŸ¨ å¤šå±‚æ¬¡é…ç½®ç­–ç•¥**
```yaml
# defaults/main.yml - æä¾›åˆç†é»˜è®¤å€¼

nginx_config:
  worker_processes: auto
  worker_connections: 1024
  keepalive_timeout: 65
  client_max_body_size: 1m
  
# å…è®¸éƒ¨åˆ†é‡å†™è€Œä¸å½±å“å…¶ä»–é…ç½®

- name: åˆå¹¶ç”¨æˆ·é…ç½®
  set_fact:
    nginx_config: "{{ nginx_config | combine(nginx_custom_config | default({}), recursive=True) }}"
```

### 10.2 æ¡ä»¶å˜é‡é‡å†™



**ğŸ”€ åŸºäºæ¡ä»¶çš„åŠ¨æ€é…ç½®**
```yaml
# æ ¹æ®ç¯å¢ƒåŠ¨æ€è°ƒæ•´é…ç½®

- name: è®¾ç½®ç¯å¢ƒç‰¹å®šé…ç½®
  set_fact:
    webapp_config: "{{ webapp_config | combine(env_overrides) }}"
  vars:
    env_overrides:
      debug: "{{ true if app_environment == 'development' else false }}"
      log_level: "{{ 'debug' if app_environment == 'development' else 'info' }}"
      cache_ttl: "{{ 60 if app_environment == 'development' else 3600 }}"
      
# åŸºäºç³»ç»Ÿæ¶æ„çš„é…ç½®è°ƒæ•´  

- name: è°ƒæ•´ç³»ç»Ÿç‰¹å®šå‚æ•°
  set_fact:
    nginx_worker_processes: "{{ ansible_processor_vcpus if ansible_processor_vcpus <= 8 else 8 }}"
```

### 10.3 å˜é‡åˆå¹¶ç­–ç•¥



**ğŸ”— æ™ºèƒ½å˜é‡åˆå¹¶**
```yaml
# æ·±åº¦åˆå¹¶å­—å…¸å˜é‡

- name: åˆå¹¶å¤æ‚é…ç½®
  set_fact:
    final_config: "{{ base_config | combine(user_config, recursive=True) }}"
  vars:
    base_config:
      database:
        pool_size: 10
        timeout: 30
      cache:
        ttl: 3600
        max_memory: 128m
    user_config:
      database:
        pool_size: 20    # åªè¦†ç›–è¿™ä¸€é¡¹
#      # cacheé…ç½®ä¿æŒé»˜è®¤å€¼
```

---

## 11. ğŸ¤ è§’è‰²é—´å˜é‡ä¼ é€’



### 11.1 è§’è‰²ä¾èµ–å˜é‡ä¼ é€’



**ğŸ”— é€šè¿‡meta/main.ymlä¼ é€’**
```yaml
# roles/webapp/meta/main.yml

---
dependencies:
  - role: common
    vars:
      common_packages: 
        - git
        - curl
  - role: nginx  
    vars:
      nginx_sites:
        - name: "{{ webapp.name }}"
          port: "{{ webapp.port }}"
          ssl_enabled: "{{ webapp.ssl.enabled }}"
```

### 11.2 é€šè¿‡set_factä¼ é€’å˜é‡



**ğŸ¯ è¿è¡Œæ—¶å˜é‡ä¼ é€’**
```yaml
# åœ¨è§’è‰²Aä¸­è®¾ç½®å˜é‡ç»™è§’è‰²Bä½¿ç”¨

- name: ä¸ºä¸‹æ¸¸è§’è‰²å‡†å¤‡é…ç½®
  set_fact:
    shared_database_config:
      host: "{{ webapp.database.host }}"
      port: "{{ webapp.database.port }}"
      name: "{{ webapp.database.name }}"
  
# åœ¨è§’è‰²Bä¸­ä½¿ç”¨å…±äº«å˜é‡  

- name: ä½¿ç”¨ä¸Šæ¸¸è§’è‰²æä¾›çš„é…ç½®
  debug:
    msg: "æ•°æ®åº“è¿æ¥: {{ shared_database_config.host }}:{{ shared_database_config.port }}"
```

### 11.3 å…¨å±€å˜é‡å…±äº«



**ğŸŒ é€šè¿‡group_varså’Œhost_varså…±äº«**
```yaml
# group_vars/webservers.yml

---
# æ‰€æœ‰webæœåŠ¡å™¨å…±äº«çš„é…ç½®

shared_config:
  timezone: "Asia/Shanghai"
  ntp_servers:
    - "0.pool.ntp.org"
    - "1.pool.ntp.org"
  monitoring:
    enabled: true
    agent_port: 9100

# åœ¨ä»»ä½•è§’è‰²ä¸­éƒ½å¯ä»¥ä½¿ç”¨

- name: åº”ç”¨å…±äº«æ—¶åŒºé…ç½®
  timezone:
    name: "{{ shared_config.timezone }}"
```

---

## 12. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“



### 12.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ



```
ğŸ”¸ defaults vs varsï¼šdefaultsä¼˜å…ˆçº§ä½ï¼Œvarsä¼˜å…ˆçº§é«˜
ğŸ”¸ å˜é‡ä¼˜å…ˆçº§ï¼šå‘½ä»¤è¡Œ > vars > group_vars > defaults  
ğŸ”¸ å‘½åç©ºé—´ï¼šä½¿ç”¨è§’è‰²åå‰ç¼€é¿å…å˜é‡å†²çª
ğŸ”¸ æ•æ„Ÿå˜é‡ï¼šä½¿ç”¨Ansible VaultåŠ å¯†å­˜å‚¨
ğŸ”¸ å˜é‡éªŒè¯ï¼šä½¿ç”¨assertç¡®ä¿é…ç½®æ­£ç¡®æ€§
ğŸ”¸ æ–‡æ¡£åŒ–ï¼šæ¸…æ™°è®°å½•å˜é‡ç”¨é€”å’Œç¤ºä¾‹
```

### 12.2 å…³é”®ç†è§£è¦ç‚¹



**ğŸ”¹ defaultså’Œvarsçš„é€‰æ‹©åŸåˆ™**
```
ä½¿ç”¨defaultså½“ï¼š
â€¢ æä¾›åˆç†çš„é»˜è®¤å€¼
â€¢ å¸Œæœ›ç”¨æˆ·å®¹æ˜“è‡ªå®šä¹‰
â€¢ é…ç½®é¡¹æ˜¯å¯é€‰çš„

ä½¿ç”¨varså½“ï¼š
â€¢ è§’è‰²å†…éƒ¨è®¡ç®—å˜é‡  
â€¢ ä¸å¸Œæœ›è¢«è½»æ˜“è¦†ç›–
â€¢ åŸºäºç³»ç»Ÿä¿¡æ¯åŠ¨æ€ç”Ÿæˆ
```

**ğŸ”¹ å˜é‡ç»„ç»‡çš„è®¾è®¡æ€è·¯**
```
æŒ‰ç¯å¢ƒåˆ†ç¦»ï¼šå¼€å‘/æµ‹è¯•/ç”Ÿäº§ä½¿ç”¨ä¸åŒé…ç½®
æŒ‰åŠŸèƒ½æ¨¡å—ï¼šæ•°æ®åº“/ç¼“å­˜/æ—¥å¿—åˆ†åˆ«é…ç½®  
æŒ‰ç³»ç»Ÿå·®å¼‚ï¼šä¸åŒæ“ä½œç³»ç»Ÿä½¿ç”¨ä¸åŒå˜é‡
```

### 12.3 å®é™…åº”ç”¨ä»·å€¼



**ğŸ¯ åº”ç”¨åœºæ™¯ç¤ºä¾‹**
- **å¤šç¯å¢ƒéƒ¨ç½²**ï¼šåŒä¸€è§’è‰²é€‚é…ä¸åŒç¯å¢ƒ
- **å¤§è§„æ¨¡ç®¡ç†**ï¼šç»Ÿä¸€é…ç½®ä¸Šç™¾å°æœåŠ¡å™¨
- **å®‰å…¨åˆè§„**ï¼šæ•æ„Ÿä¿¡æ¯åŠ å¯†å­˜å‚¨
- **å›¢é˜Ÿåä½œ**ï¼šæ¸…æ™°çš„å˜é‡æ–‡æ¡£å’ŒéªŒè¯

### 12.4 å­¦ä¹ æ£€æŸ¥æ¸…å•



- [ ] ç†è§£defaultså’Œvarsçš„åŒºåˆ«å’Œç”¨é€”
- [ ] æŒæ¡å˜é‡ä¼˜å…ˆçº§å’Œè¦†ç›–æœºåˆ¶  
- [ ] èƒ½å¤Ÿè®¾è®¡åˆç†çš„å˜é‡å‘½åç©ºé—´
- [ ] ä¼šç¼–å†™å˜é‡éªŒè¯å’Œæ–‡æ¡£
- [ ] æŒæ¡æ•æ„Ÿå˜é‡çš„å®‰å…¨å¤„ç†
- [ ] äº†è§£è§’è‰²é—´å˜é‡ä¼ é€’æ–¹æ³•

**ğŸ”‘ æ ¸å¿ƒè®°å¿†è¦ç‚¹**
> defaultsç»™é»˜è®¤ï¼Œvarsè—å†…éƒ¨
> ä¼˜å…ˆçº§è¦è®°ä½ï¼Œå‘½åç©ºé—´é˜²å†²çª
> æ•æ„Ÿä¿¡æ¯è¦åŠ å¯†ï¼ŒéªŒè¯æ–‡æ¡£ä¸èƒ½å°‘

**ğŸ’¡ è¿›é˜¶å­¦ä¹ å»ºè®®**
- æ·±å…¥å­¦ä¹ Jinja2æ¨¡æ¿è¯­æ³•
- ç ”ç©¶Ansible Vaulté«˜çº§ç”¨æ³•  
- äº†è§£åŠ¨æ€inventoryçš„å˜é‡ç®¡ç†
- å­¦ä¹ è§’è‰²æµ‹è¯•å’ŒæŒç»­é›†æˆ