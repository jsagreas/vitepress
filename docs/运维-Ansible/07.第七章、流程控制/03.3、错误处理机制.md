---
title: 3ã€é”™è¯¯å¤„ç†æœºåˆ¶
---
## ğŸ“š ç›®å½•

1. [é”™è¯¯å¤„ç†åŸºç¡€æ¦‚å¿µ](#1-é”™è¯¯å¤„ç†åŸºç¡€æ¦‚å¿µ)
2. [blockä»»åŠ¡å—ç»“æ„åŒ–å¤„ç†](#2-blockä»»åŠ¡å—ç»“æ„åŒ–å¤„ç†)
3. [é”™è¯¯å¿½ç•¥ä¸æ¡ä»¶æ§åˆ¶](#3-é”™è¯¯å¿½ç•¥ä¸æ¡ä»¶æ§åˆ¶)
4. [è‡ªå®šä¹‰é”™è¯¯æ¡ä»¶è®¾ç½®](#4-è‡ªå®šä¹‰é”™è¯¯æ¡ä»¶è®¾ç½®)
5. [å…¨å±€é”™è¯¯å¤„ç†ç­–ç•¥](#5-å…¨å±€é”™è¯¯å¤„ç†ç­–ç•¥)
6. [å®è·µæ¡ˆä¾‹ä¸æ•…éšœæ’æŸ¥](#6-å®è·µæ¡ˆä¾‹ä¸æ•…éšœæ’æŸ¥)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ é”™è¯¯å¤„ç†åŸºç¡€æ¦‚å¿µ


### 1.1 ä¸ºä»€ä¹ˆéœ€è¦é”™è¯¯å¤„ç†


**ç°å®åœºæ™¯ç†è§£**ï¼š
æƒ³è±¡ä½ åœ¨æ‰¹é‡éƒ¨ç½²100å°æœåŠ¡å™¨ï¼Œå¦‚æœç¬¬10å°æœåŠ¡å™¨å‡ºç°é—®é¢˜ï¼Œä½ å¸Œæœ›ï¼š
- ğŸ”¸ **æ™ºèƒ½å¤„ç†**ï¼šè‡ªåŠ¨å°è¯•ä¿®å¤æˆ–è®°å½•é”™è¯¯ç»§ç»­æ‰§è¡Œ
- ğŸ”¸ **é¿å…ä¸­æ–­**ï¼šä¸è¦å› ä¸ºä¸€å°æœºå™¨å½±å“æ•´ä¸ªéƒ¨ç½²æµç¨‹
- ğŸ”¸ **æ¸…æ™°åé¦ˆ**ï¼šçŸ¥é“å“ªé‡Œå‡ºé”™äº†ï¼Œä¸ºä»€ä¹ˆå‡ºé”™

```
ä¼ ç»Ÿè„šæœ¬é—®é¢˜ï¼š
#!/bin/bash
systemctl start nginx    # å¦‚æœå¤±è´¥ï¼Œæ•´ä¸ªè„šæœ¬åœæ­¢
systemctl start mysql    # æ°¸è¿œä¸ä¼šæ‰§è¡Œ
systemctl start redis    # æ°¸è¿œä¸ä¼šæ‰§è¡Œ

Ansibleè§£å†³æ–¹æ¡ˆï¼š
- å¯ä»¥é€‰æ‹©æ€§å¤„ç†é”™è¯¯
- æä¾›å¤šç§é”™è¯¯å¤„ç†ç­–ç•¥  
- æ”¯æŒé”™è¯¯æ¢å¤æœºåˆ¶
```

### 1.2 Ansibleé”™è¯¯å¤„ç†çš„æ ¸å¿ƒæ€æƒ³


**ğŸ”¸ é”™è¯¯ä¸ç­‰äºå¤±è´¥**
```
é”™è¯¯å‘ç”Ÿæ—¶çš„é€‰æ‹©ï¼š
1. ç«‹å³åœæ­¢ â† ä¼ ç»Ÿåšæ³•
2. å¿½ç•¥ç»§ç»­ â† ignore_errors
3. å°è¯•ä¿®å¤ â† rescueæœºåˆ¶  
4. è®°å½•å¤„ç† â† è‡ªå®šä¹‰é€»è¾‘
```

**ğŸ”¸ åˆ†å±‚é”™è¯¯å¤„ç†**
```
ä»»åŠ¡çº§åˆ«ï¼šå•ä¸ªä»»åŠ¡çš„é”™è¯¯å¤„ç†
å—çº§åˆ«ï¼šä¸€ç»„ä»»åŠ¡çš„ç»Ÿä¸€å¤„ç†  
å‰§æœ¬çº§åˆ«ï¼šæ•´ä¸ªplaybookçš„å…¨å±€ç­–ç•¥
ä¸»æœºçº§åˆ«ï¼šæŸå°æœºå™¨å¤±è´¥ä¸å½±å“å…¶ä»–æœºå™¨
```

---

## 2. ğŸ—ï¸ blockä»»åŠ¡å—ç»“æ„åŒ–å¤„ç†


### 2.1 blockåŸºæœ¬ç»“æ„


**ğŸ’¡ æ ¸å¿ƒç†è§£**ï¼š`block`å°±åƒç¼–ç¨‹ä¸­çš„`try-catch-finally`è¯­å¥

```
ç”Ÿæ´»ç±»æ¯”ï¼š
try {
    åšé¥­(ä¹°èœã€æ´—èœã€ç‚’èœ)     â† blockéƒ¨åˆ†
} catch (å‡ºé”™äº†) {
    ç‚¹å¤–å–                     â† rescueéƒ¨åˆ†  
} finally {
    æ”¶æ‹¾å¨æˆ¿                   â† alwayséƒ¨åˆ†
}
```

**ğŸ”§ åŸºæœ¬è¯­æ³•ç»“æ„**

```yaml
- name: å®Œæ•´çš„é”™è¯¯å¤„ç†ç¤ºä¾‹
  block:
    # æ­£å¸¸æ‰§è¡Œçš„ä»»åŠ¡ç»„
    - name: å°è¯•å¯åŠ¨æœåŠ¡
      service:
        name: nginx
        state: started
        
    - name: æ£€æŸ¥æœåŠ¡çŠ¶æ€
      uri:
        url: http://localhost:80
        
  rescue:
    # å‡ºé”™æ—¶æ‰§è¡Œçš„ä»»åŠ¡ç»„
    - name: è®°å½•é”™è¯¯ä¿¡æ¯
      debug:
        msg: "æœåŠ¡å¯åŠ¨å¤±è´¥ï¼Œå°è¯•ä¿®å¤"
        
    - name: é‡æ–°å®‰è£…nginx
      package:
        name: nginx
        state: present
        
  always:
    # æ— è®ºæˆåŠŸå¤±è´¥éƒ½æ‰§è¡Œ
    - name: æ£€æŸ¥æœ€ç»ˆçŠ¶æ€
      debug:
        msg: "ä»»åŠ¡æ‰§è¡Œå®Œæˆ"
```

### 2.2 blockçš„æ‰§è¡Œé€»è¾‘


**ğŸ“Š æ‰§è¡Œæµç¨‹å›¾**
```
å¼€å§‹æ‰§è¡Œblock
       â†“
   æ‰§è¡Œblockä¸­çš„ä»»åŠ¡
       â†“
    ä»»åŠ¡æˆåŠŸï¼Ÿ
   â†™        â†˜
 æ˜¯          å¦
 â†“           â†“
è·³è¿‡rescue  æ‰§è¡Œrescueä»»åŠ¡
 â†“           â†“
 â†˜         â†™
   æ‰§è¡Œalwaysä»»åŠ¡
       â†“
   æµç¨‹ç»“æŸ
```

**ğŸ¯ å®é™…åº”ç”¨ç¤ºä¾‹**

```yaml
- name: éƒ¨ç½²Webåº”ç”¨çš„å®Œæ•´æµç¨‹
  block:
    - name: åˆ›å»ºåº”ç”¨ç›®å½•
      file:
        path: /var/www/myapp
        state: directory
        
    - name: ä¸‹è½½åº”ç”¨æ–‡ä»¶
      get_url:
        url: "{{ app_download_url }}"
        dest: /var/www/myapp/
        
    - name: å¯åŠ¨åº”ç”¨æœåŠ¡
      service:
        name: myapp
        state: started
        
  rescue:
    # å¦‚æœéƒ¨ç½²å¤±è´¥ï¼Œå›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
    - name: è¾“å‡ºé”™è¯¯ä¿¡æ¯
      debug:
        msg: "éƒ¨ç½²å¤±è´¥ï¼Œå¼€å§‹å›æ»š"
        
    - name: æ¢å¤å¤‡ä»½ç‰ˆæœ¬
      command: cp -r /var/www/myapp.backup/* /var/www/myapp/
      
    - name: é‡å¯æœåŠ¡
      service:
        name: myapp
        state: restarted
        
  always:
    - name: å‘é€é€šçŸ¥
      mail:
        subject: "åº”ç”¨éƒ¨ç½²ç»“æœé€šçŸ¥"
        body: "éƒ¨ç½²ä»»åŠ¡å·²å®Œæˆï¼Œè¯·æ£€æŸ¥æœåŠ¡çŠ¶æ€"
```

### 2.3 åµŒå¥—blockå¤„ç†


**ğŸ”¸ å¤æ‚åœºæ™¯çš„åˆ†å±‚å¤„ç†**

```yaml
- name: å¤šå±‚é”™è¯¯å¤„ç†ç¤ºä¾‹
  block:
    - name: ä¸»è¦éƒ¨ç½²æµç¨‹
      block:
        - name: æ•°æ®åº“æ“ä½œ
          mysql_db:
            name: myapp
            state: present
            
      rescue:
        - name: æ•°æ®åº“å¤±è´¥å¤„ç†
          debug:
            msg: "æ•°æ®åº“æ“ä½œå¤±è´¥"
            
    - name: WebæœåŠ¡éƒ¨ç½²
      service:
        name: nginx
        state: started
        
  rescue:
    - name: æ•´ä½“å¤±è´¥å¤„ç†
      debug:
        msg: "æ•´ä¸ªéƒ¨ç½²æµç¨‹å¤±è´¥"
        
  always:
    - name: æ¸…ç†å·¥ä½œ
      debug:
        msg: "æ‰§è¡Œæ¸…ç†å·¥ä½œ"
```

---

## 3. âš™ï¸ é”™è¯¯å¿½ç•¥ä¸æ¡ä»¶æ§åˆ¶


### 3.1 ignore_errorså¿½ç•¥é”™è¯¯


**ğŸ’­ ç”Ÿæ´»ç±»æ¯”ç†è§£**ï¼š
å°±åƒåšèœæ—¶ç›æ”¾å¤šäº†ï¼Œä½ å¯ä»¥é€‰æ‹©ï¼š
- ğŸ”¸ **ä¸¥æ ¼æ¨¡å¼**ï¼šå€’æ‰é‡åšï¼ˆé»˜è®¤Ansibleè¡Œä¸ºï¼‰
- ğŸ”¸ **å®½å®¹æ¨¡å¼**ï¼šç»§ç»­åšï¼Œåé¢æƒ³åŠæ³•è¡¥æ•‘ï¼ˆignore_errorsï¼‰

**ğŸ”§ åŸºæœ¬ç”¨æ³•**

```yaml
- name: å°è¯•åœæ­¢æœåŠ¡ï¼ˆå¯èƒ½ä¸å­˜åœ¨ï¼‰
  service:
    name: old_service
    state: stopped
  ignore_errors: true  # æœåŠ¡ä¸å­˜åœ¨ä¹Ÿç»§ç»­æ‰§è¡Œ

- name: ç»§ç»­åç»­ä»»åŠ¡
  debug:
    msg: "æ— è®ºä¸Šé¢æˆåŠŸå¤±è´¥ï¼Œè¿™é‡Œéƒ½ä¼šæ‰§è¡Œ"
```

**ğŸ“Š ignore_errorsä½¿ç”¨åœºæ™¯å¯¹æ¯”**

| ä½¿ç”¨åœºæ™¯ | **æ˜¯å¦ä½¿ç”¨ignore_errors** | **åŸå› è¯´æ˜** |
|---------|-------------------------|-------------|
| `æ¸…ç†ä¸´æ—¶æ–‡ä»¶` | âœ… **å»ºè®®ä½¿ç”¨** | `æ–‡ä»¶å¯èƒ½ä¸å­˜åœ¨ï¼Œä¸å½±å“ä¸»æµç¨‹` |
| `åœæ­¢æ—§æœåŠ¡` | âœ… **å»ºè®®ä½¿ç”¨** | `æœåŠ¡å¯èƒ½æœªå®‰è£…ï¼Œå±æ­£å¸¸æƒ…å†µ` |
| `åˆ›å»ºæ•°æ®åº“` | âŒ **ä¸å»ºè®®** | `æ•°æ®åº“åˆ›å»ºå¤±è´¥é€šå¸¸éœ€è¦å¤„ç†` |
| `é‡è¦é…ç½®æ–‡ä»¶` | âŒ **ä¸å»ºè®®** | `é…ç½®é”™è¯¯ä¼šå½±å“ç³»ç»Ÿæ­£å¸¸è¿è¡Œ` |

### 3.2 failed_whenè‡ªå®šä¹‰å¤±è´¥æ¡ä»¶


**ğŸ¯ æ ¸å¿ƒç†è§£**ï¼šæœ‰æ—¶å‘½ä»¤æ‰§è¡ŒæˆåŠŸï¼Œä½†ç»“æœä¸ç¬¦åˆæˆ‘ä»¬æœŸæœ›

**å®é™…åœºæ™¯ç¤ºä¾‹**

```yaml
- name: æ£€æŸ¥ç£ç›˜ç©ºé—´
  shell: df -h / | tail -1 | awk '{print $5}' | sed 's/%//'
  register: disk_usage
  failed_when: disk_usage.stdout|int > 90
  # ç£ç›˜ä½¿ç”¨è¶…è¿‡90%å°±è®¤ä¸ºå¤±è´¥

- name: æ£€æŸ¥æœåŠ¡å“åº”
  uri:
    url: "http://{{ inventory_hostname }}:8080/health"
  register: health_check
  failed_when: 
    - health_check.status != 200
    - "'healthy' not in health_check.content"
  # çŠ¶æ€ç ä¸æ˜¯200æˆ–å“åº”å†…å®¹ä¸åŒ…å«healthyå°±å¤±è´¥
```

**ğŸ” æ·±å…¥ç†è§£failed_when**

```yaml
- name: å¤æ‚çš„å¤±è´¥æ¡ä»¶åˆ¤æ–­
  shell: |
    ps aux | grep nginx | grep -v grep | wc -l
  register: nginx_processes
  failed_when:
    - nginx_processes.stdout|int == 0  # æ²¡æœ‰nginxè¿›ç¨‹
    - nginx_processes.stdout|int > 10  # nginxè¿›ç¨‹è¿‡å¤š
  # è¿›ç¨‹æ•°ä¸º0æˆ–è¶…è¿‡10éƒ½è®¤ä¸ºå¼‚å¸¸
```

### 3.3 changed_whenå˜æ›´çŠ¶æ€æ§åˆ¶


**ğŸ’¡ ç†è§£å˜æ›´çŠ¶æ€çš„é‡è¦æ€§**ï¼š
Ansibleä¼šæ ¹æ®ä»»åŠ¡æ˜¯å¦"å˜æ›´"æ¥å†³å®šæ˜¯å¦è§¦å‘handlers

**ğŸ”§ å®é™…åº”ç”¨ç¤ºä¾‹**

```yaml
- name: æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•
  shell: nginx -t
  register: syntax_check
  changed_when: false  # æ£€æŸ¥è¯­æ³•ä¸ç®—å˜æ›´
  failed_when: syntax_check.rc != 0

- name: é‡å¯æœåŠ¡ï¼ˆä»…å½“é…ç½®æ”¹å˜æ—¶ï¼‰
  service:
    name: nginx
    state: restarted
  notify: restart nginx
  # åªæœ‰çœŸæ­£çš„é…ç½®å˜æ›´æ‰ä¼šè§¦å‘é‡å¯
```

**ğŸ“‹ changed_whenä½¿ç”¨æŒ‡å—**

```yaml
- name: æ¡ä»¶åŒ–å˜æ›´çŠ¶æ€
  shell: echo "å½“å‰æ—¶é—´: $(date)"
  register: time_output
  changed_when: 
    - time_output.stdout is defined
    - "'error' not in time_output.stdout"
  # åªæœ‰è¾“å‡ºæ­£å¸¸ä¸”ä¸åŒ…å«erroræ‰ç®—å˜æ›´
```

---

## 4. ğŸ›ï¸ è‡ªå®šä¹‰é”™è¯¯æ¡ä»¶è®¾ç½®


### 4.1 åŸºäºè¿”å›ç çš„é”™è¯¯åˆ¤æ–­


**ğŸ”¸ ç†è§£å‘½ä»¤è¿”å›ç **ï¼š
- **è¿”å›ç 0**ï¼šå‘½ä»¤æ‰§è¡ŒæˆåŠŸ
- **è¿”å›ç é0**ï¼šå‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼ˆ1-255ä¸åŒé”™è¯¯ç±»å‹ï¼‰

```yaml
- name: è‡ªå®šä¹‰è¿”å›ç å¤„ç†
  shell: |
    # æ¨¡æ‹Ÿå¯èƒ½è¿”å›ä¸åŒé”™è¯¯ç çš„è„šæœ¬
    if [ ! -f /etc/config.conf ]; then
      exit 1  # é…ç½®æ–‡ä»¶ä¸å­˜åœ¨
    elif [ ! -r /etc/config.conf ]; then
      exit 2  # é…ç½®æ–‡ä»¶ä¸å¯è¯»
    else
      exit 0  # æ­£å¸¸
    fi
  register: config_check
  failed_when: config_check.rc not in [0, 1]  # åªæœ‰è¿”å›ç 2æ‰ç®—å¤±è´¥
```

### 4.2 åŸºäºè¾“å‡ºå†…å®¹çš„é”™è¯¯åˆ¤æ–­


**ğŸ¯ å®é™…åº”ç”¨åœºæ™¯**

```yaml
- name: æ£€æŸ¥æ•°æ®åº“è¿æ¥
  shell: mysql -u root -p{{ mysql_password }} -e "SELECT 1;"
  register: mysql_test
  failed_when:
    - mysql_test.rc != 0
    - "'Access denied' in mysql_test.stderr"
    - "'Connection refused' in mysql_test.stderr"
  # å¤šç§å¤±è´¥æ¡ä»¶ç»„åˆåˆ¤æ–­

- name: æ£€æŸ¥WebæœåŠ¡å“åº”å†…å®¹
  uri:
    url: "http://localhost/api/status"
  register: api_response
  failed_when: >
    api_response.status != 200 or
    'success' not in api_response.content or
    api_response.json.status != 'healthy'
  # å¤æ‚çš„å“åº”å†…å®¹åˆ¤æ–­
```

### 4.3 ç»„åˆæ¡ä»¶çš„é«˜çº§ç”¨æ³•


**ğŸ”§ é€»è¾‘è¿ç®—ç¬¦ä½¿ç”¨**

```yaml
- name: å¤åˆæ¡ä»¶é”™è¯¯åˆ¤æ–­
  shell: systemctl status {{ service_name }}
  register: service_status
  failed_when:
    - service_status.rc != 0  # å‘½ä»¤å¤±è´¥
    - |
      'Active: active' not in service_status.stdout or
      'Main PID:' not in service_status.stdout
    # ä½¿ç”¨å¤šè¡Œæ¡ä»¶å’Œé€»è¾‘è¿ç®—
```

---

## 5. ğŸŒ å…¨å±€é”™è¯¯å¤„ç†ç­–ç•¥


### 5.1 any_errors_fatalè‡´å‘½é”™è¯¯å¤„ç†


**ğŸ’­ åº”ç”¨åœºæ™¯ç†è§£**ï¼š
é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸€å°æœºå™¨å¤±è´¥ä¸å½±å“å…¶ä»–æœºå™¨ç»§ç»­æ‰§è¡Œã€‚ä½†æŸäº›åœºæ™¯ä¸‹éœ€è¦"ä¸€ä¸ªå¤±è´¥ï¼Œå…¨éƒ¨åœæ­¢"

```yaml
---
- name: å…³é”®ç³»ç»Ÿéƒ¨ç½²ï¼ˆä»»ä½•é”™è¯¯éƒ½è¦åœæ­¢ï¼‰
  hosts: production_servers
  any_errors_fatal: true  # ä»»ä½•ä¸»æœºå¤±è´¥ï¼Œç«‹å³åœæ­¢æ‰€æœ‰ä¸»æœº
  
  tasks:
    - name: æ£€æŸ¥æ•°æ®åº“è¿æ¥
      mysql_db:
        name: critical_db
        state: present
        
    - name: éƒ¨ç½²å…³é”®åº”ç”¨
      copy:
        src: critical_app.jar
        dest: /opt/app/
```

### 5.2 max_fail_percentageå¤±è´¥æ¯”ä¾‹æ§åˆ¶


**ğŸ¯ çµæ´»çš„å¤±è´¥ç­–ç•¥**

```yaml
---
- name: æ‰¹é‡æœåŠ¡å™¨æ›´æ–°ï¼ˆå…è®¸å°‘é‡å¤±è´¥ï¼‰
  hosts: web_servers
  max_fail_percentage: 20  # å…è®¸20%çš„æœåŠ¡å™¨å¤±è´¥
  
  tasks:
    - name: æ›´æ–°è½¯ä»¶åŒ…
      package:
        name: nginx
        state: latest
        
    - name: é‡å¯æœåŠ¡
      service:
        name: nginx
        state: restarted
```

**ğŸ“Š å¤±è´¥æ¯”ä¾‹ç­–ç•¥å¯¹æ¯”**

| åœºæ™¯ç±»å‹ | **max_fail_percentage** | **any_errors_fatal** | **ä½¿ç”¨åŸå› ** |
|---------|------------------------|---------------------|-------------|
| `å…³é”®ç³»ç»Ÿéƒ¨ç½²` | `0%` | `true` | `ä»»ä½•é”™è¯¯éƒ½ä¸èƒ½å®¹å¿` |
| `æ‰¹é‡è½¯ä»¶æ›´æ–°` | `10-20%` | `false` | `ä¸ªåˆ«æœºå™¨å¤±è´¥å¯æ¥å—` |
| `é…ç½®æ–‡ä»¶åˆ†å‘` | `5%` | `false` | `å°‘é‡å¤±è´¥ä¸å½±å“æ•´ä½“` |
| `æ•°æ®åº“è¿ç§»` | `0%` | `true` | `æ•°æ®ä¸€è‡´æ€§è¦æ±‚é«˜` |

### 5.3 serialæ‰¹é‡æ‰§è¡Œæ§åˆ¶


**ğŸ”¸ æ§åˆ¶æ‰§è¡ŒèŠ‚å¥ï¼Œé™ä½é£é™©**

```yaml
---
- name: æ»šåŠ¨æ›´æ–°ç­–ç•¥
  hosts: production_servers
  serial: 2  # æ¯æ¬¡åªå¤„ç†2å°æœåŠ¡å™¨
  max_fail_percentage: 0  # ä¸å…è®¸å¤±è´¥
  
  tasks:
    - name: åœæ­¢æœåŠ¡
      service:
        name: myapp
        state: stopped
        
    - name: æ›´æ–°åº”ç”¨
      copy:
        src: new_version.jar
        dest: /opt/app/myapp.jar
        backup: yes
        
    - name: å¯åŠ¨æœåŠ¡
      service:
        name: myapp
        state: started
        
    - name: å¥åº·æ£€æŸ¥
      uri:
        url: "http://{{ inventory_hostname }}:8080/health"
      retries: 5
      delay: 10
```

---

## 6. ğŸ› ï¸ å®è·µæ¡ˆä¾‹ä¸æ•…éšœæ’æŸ¥


### 6.1 WebæœåŠ¡éƒ¨ç½²çš„å®Œæ•´é”™è¯¯å¤„ç†


**ğŸš€ å®æˆ˜æ¡ˆä¾‹ï¼šç”Ÿäº§ç¯å¢ƒWebåº”ç”¨éƒ¨ç½²**

```yaml
---
- name: ç”Ÿäº§ç¯å¢ƒWebåº”ç”¨éƒ¨ç½²
  hosts: web_servers
  serial: 1  # ä¸€å°ä¸€å°éƒ¨ç½²ï¼Œé™ä½é£é™©
  
  vars:
    app_name: mywebapp
    backup_dir: /backup/{{ app_name }}
    health_check_url: "http://localhost:8080/health"
    
  tasks:
    - name: éƒ¨ç½²å‰å‡†å¤‡å’Œæ£€æŸ¥
      block:
        - name: æ£€æŸ¥ç£ç›˜ç©ºé—´
          shell: df -h /var/www | tail -1 | awk '{print $5}' | sed 's/%//'
          register: disk_usage
          failed_when: disk_usage.stdout|int > 85
          
        - name: åˆ›å»ºå¤‡ä»½ç›®å½•
          file:
            path: "{{ backup_dir }}"
            state: directory
            
        - name: å¤‡ä»½å½“å‰ç‰ˆæœ¬
          archive:
            path: /var/www/{{ app_name }}
            dest: "{{ backup_dir }}/backup_{{ ansible_date_time.epoch }}.tar.gz"
          ignore_errors: true  # é¦–æ¬¡éƒ¨ç½²å¯èƒ½æ²¡æœ‰æ—§ç‰ˆæœ¬
          
      rescue:
        - name: é¢„æ£€æŸ¥å¤±è´¥å¤„ç†
          debug:
            msg: "éƒ¨ç½²å‰æ£€æŸ¥å¤±è´¥ï¼Œåœæ­¢éƒ¨ç½²"
          failed: yes  # å¼ºåˆ¶å¤±è´¥ï¼Œåœæ­¢åç»­ä»»åŠ¡
          
    - name: åº”ç”¨éƒ¨ç½²ä¸»æµç¨‹
      block:
        - name: åœæ­¢åº”ç”¨æœåŠ¡
          service:
            name: "{{ app_name }}"
            state: stopped
          ignore_errors: true  # æœåŠ¡å¯èƒ½ä¸å­˜åœ¨
          
        - name: ä¸‹è½½æ–°ç‰ˆæœ¬åº”ç”¨
          get_url:
            url: "{{ app_download_url }}"
            dest: "/tmp/{{ app_name }}.tar.gz"
            
        - name: è§£å‹åº”ç”¨æ–‡ä»¶
          unarchive:
            src: "/tmp/{{ app_name }}.tar.gz"
            dest: /var/www/
            remote_src: yes
            
        - name: æ›´æ–°é…ç½®æ–‡ä»¶
          template:
            src: app.conf.j2
            dest: "/var/www/{{ app_name }}/config/app.conf"
            
        - name: å¯åŠ¨åº”ç”¨æœåŠ¡
          service:
            name: "{{ app_name }}"
            state: started
            
        - name: ç­‰å¾…æœåŠ¡å¯åŠ¨
          wait_for:
            port: 8080
            host: localhost
            timeout: 60
            
        - name: å¥åº·æ£€æŸ¥
          uri:
            url: "{{ health_check_url }}"
            method: GET
            status_code: 200
          retries: 5
          delay: 10
          
      rescue:
        - name: éƒ¨ç½²å¤±è´¥å›æ»šå¤„ç†
          debug:
            msg: "åº”ç”¨éƒ¨ç½²å¤±è´¥ï¼Œå¼€å§‹å›æ»š"
            
        - name: åœæ­¢å¤±è´¥çš„æœåŠ¡
          service:
            name: "{{ app_name }}"
            state: stopped
          ignore_errors: true
          
        - name: æ¢å¤å¤‡ä»½ç‰ˆæœ¬
          shell: |
            cd {{ backup_dir }}
            latest_backup=$(ls -t backup_*.tar.gz | head -1)
            if [ -n "$latest_backup" ]; then
              tar -xzf "$latest_backup" -C /var/www/
              echo "å·²æ¢å¤å¤‡ä»½: $latest_backup"
            else
              echo "æ²¡æœ‰æ‰¾åˆ°å¤‡ä»½æ–‡ä»¶"
            fi
          register: restore_result
          
        - name: é‡æ–°å¯åŠ¨æœåŠ¡
          service:
            name: "{{ app_name }}"
            state: started
          when: "'å·²æ¢å¤å¤‡ä»½' in restore_result.stdout"
          
        - name: å‘é€å¤±è´¥é€šçŸ¥
          mail:
            to: ops@company.com
            subject: "åº”ç”¨éƒ¨ç½²å¤±è´¥ - {{ inventory_hostname }}"
            body: |
              æœåŠ¡å™¨: {{ inventory_hostname }}
              åº”ç”¨: {{ app_name }}
              å¤±è´¥æ—¶é—´: {{ ansible_date_time.iso8601 }}
              é”™è¯¯ä¿¡æ¯: éƒ¨ç½²è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œå·²è‡ªåŠ¨å›æ»š
              
      always:
        - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          file:
            path: "/tmp/{{ app_name }}.tar.gz"
            state: absent
            
        - name: è®°å½•éƒ¨ç½²ç»“æœ
          lineinfile:
            path: /var/log/ansible_deploy.log
            line: "{{ ansible_date_time.iso8601 }} - {{ inventory_hostname }} - {{ app_name }} - {{ 'SUCCESS' if ansible_failed_result is not defined else 'FAILED' }}"
            create: yes
```

### 6.2 æ•°æ®åº“æ“ä½œçš„é”™è¯¯å¤„ç†


**ğŸ”§ æ•°æ®åº“è¿ç§»åœºæ™¯**

```yaml
- name: æ•°æ®åº“è¿ç§»é”™è¯¯å¤„ç†
  block:
    - name: å¤‡ä»½æ•°æ®åº“
      mysql_db:
        name: "{{ db_name }}"
        state: dump
        target: "/backup/{{ db_name }}_{{ ansible_date_time.epoch }}.sql"
        
    - name: æ‰§è¡Œæ•°æ®åº“è¿ç§»
      mysql_db:
        name: "{{ db_name }}"
        state: import
        target: "{{ migration_script }}"
        
    - name: éªŒè¯è¿ç§»ç»“æœ
      mysql_query:
        login_db: "{{ db_name }}"
        query: "SELECT COUNT(*) as count FROM new_table"
      register: migration_check
      failed_when: migration_check.query_result[0].count|int == 0
      
  rescue:
    - name: è¿ç§»å¤±è´¥å¤„ç†
      debug:
        msg: "æ•°æ®åº“è¿ç§»å¤±è´¥ï¼Œå¼€å§‹æ¢å¤"
        
    - name: æ¢å¤æ•°æ®åº“å¤‡ä»½
      mysql_db:
        name: "{{ db_name }}"
        state: import
        target: "/backup/{{ db_name }}_{{ ansible_date_time.epoch }}.sql"
        
    - name: è®¾ç½®å¤±è´¥æ ‡å¿—
      set_fact:
        migration_failed: true
        
  always:
    - name: é€šçŸ¥è¿ç§»ç»“æœ
      debug:
        msg: |
          æ•°æ®åº“è¿ç§»å®Œæˆ
          æ•°æ®åº“: {{ db_name }}
          çŠ¶æ€: {{ 'FAILED' if migration_failed|default(false) else 'SUCCESS' }}
```

### 6.3 å¸¸è§æ•…éšœæ’æŸ¥æŠ€å·§


**ğŸ“‹ é”™è¯¯æ’æŸ¥æ£€æŸ¥æ¸…å•**

| æ£€æŸ¥é¡¹ç›® | **æ£€æŸ¥å‘½ä»¤** | **å¯èƒ½åŸå› ** | **è§£å†³æ–¹æ¡ˆ** |
|---------|-------------|-------------|-------------|
| `ä»»åŠ¡è¯­æ³•é”™è¯¯` | `ansible-playbook --syntax-check` | `YAMLè¯­æ³•é”™è¯¯` | `æ£€æŸ¥ç¼©è¿›å’Œè¯­æ³•` |
| `è¿æ¥é—®é¢˜` | `ansible all -m ping` | `SSHè¿æ¥å¤±è´¥` | `æ£€æŸ¥å¯†é’¥å’Œç½‘ç»œ` |
| `æƒé™é—®é¢˜` | `ansible all -m shell -a "whoami"` | `ç”¨æˆ·æƒé™ä¸è¶³` | `ä½¿ç”¨becomeæˆ–æ£€æŸ¥sudo` |
| `æ¨¡å—é”™è¯¯` | `ansible-doc module_name` | `æ¨¡å—å‚æ•°é”™è¯¯` | `æŸ¥é˜…æ¨¡å—æ–‡æ¡£` |

**ğŸ” è°ƒè¯•æŠ€å·§**

```yaml
- name: è°ƒè¯•ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€
  debug:
    var: item
  loop:
    - "{{ ansible_hostname }}"
    - "{{ ansible_os_family }}"
    - "{{ ansible_distribution_version }}"
  when: debug_mode|default(false)

- name: è¯¦ç»†é”™è¯¯ä¿¡æ¯æ”¶é›†
  shell: |
    echo "=== ç³»ç»Ÿä¿¡æ¯ ==="
    uname -a
    echo "=== ç£ç›˜ä½¿ç”¨ ==="
    df -h
    echo "=== å†…å­˜ä½¿ç”¨ ==="
    free -h
    echo "=== è¿›ç¨‹çŠ¶æ€ ==="
    ps aux | head -10
  register: system_info
  when: collect_debug_info|default(false)
  
- name: è¾“å‡ºè°ƒè¯•ä¿¡æ¯
  debug:
    var: system_info.stdout_lines
  when: collect_debug_info|default(false)
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ é”™è¯¯å¤„ç†ä¸‰è¦ç´ ï¼šblock-rescue-always
ğŸ”¸ é”™è¯¯å¿½ç•¥ç­–ç•¥ï¼šignore_errorsé€‚åº¦ä½¿ç”¨
ğŸ”¸ è‡ªå®šä¹‰å¤±è´¥æ¡ä»¶ï¼šfailed_whenå’Œchanged_when
ğŸ”¸ å…¨å±€é”™è¯¯æ§åˆ¶ï¼šany_errors_fatalå’Œmax_fail_percentage
ğŸ”¸ æ•…éšœæ¢å¤æœºåˆ¶ï¼šå¤‡ä»½-éƒ¨ç½²-éªŒè¯-å›æ»š
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ é”™è¯¯å¤„ç†çš„å±‚æ¬¡æ€ç»´**
```
ä»»åŠ¡çº§åˆ« â†’ ä¸ªåˆ«ä»»åŠ¡çš„å®¹é”™
å—çº§åˆ« â†’ ä¸€ç»„ä»»åŠ¡çš„æ•´ä½“å¤„ç†
å‰§æœ¬çº§åˆ« â†’ æ•´ä¸ªæµç¨‹çš„å…¨å±€ç­–ç•¥
ä¸»æœºçº§åˆ« â†’ å¤šæœºå™¨ç¯å¢ƒçš„åè°ƒ
```

**ğŸ”¹ é”™è¯¯å¤„ç†çš„å¹³è¡¡è‰ºæœ¯**
```
ä¸¥æ ¼ vs å®½æ¾ï¼š
â€¢ å…³é”®ç³»ç»Ÿï¼šä¸¥æ ¼å¤„ç†ï¼Œé›¶å®¹å¿
â€¢ æ‰¹é‡æ“ä½œï¼šé€‚åº¦å®½æ¾ï¼Œå…è®¸ä¸ªåˆ«å¤±è´¥

å¿«é€Ÿ vs ç¨³å®šï¼š  
â€¢ å¼€å‘ç¯å¢ƒï¼šå¿«é€Ÿè¿­ä»£ï¼Œç®€åŒ–å¤„ç†
â€¢ ç”Ÿäº§ç¯å¢ƒï¼šç¨³å®šä¼˜å…ˆï¼Œå®Œæ•´æµç¨‹
```

**ğŸ”¹ é¢„é˜²èƒœäºæ²»ç–—**
```
äº‹å‰æ£€æŸ¥ï¼šç£ç›˜ç©ºé—´ã€æƒé™ã€ä¾èµ–
è¿‡ç¨‹ç›‘æ§ï¼šè¿›åº¦åé¦ˆã€çŠ¶æ€æ£€æŸ¥
äº‹åéªŒè¯ï¼šåŠŸèƒ½æµ‹è¯•ã€æ€§èƒ½æ£€æŸ¥
```

### 7.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ**
- **æ¸è¿›å¼éƒ¨ç½²**ï¼šä½¿ç”¨serialæ§åˆ¶éƒ¨ç½²èŠ‚å¥
- **å®Œæ•´çš„å¤‡ä»½æ¢å¤**ï¼šéƒ¨ç½²å‰å¤‡ä»½ï¼Œå¤±è´¥æ—¶è‡ªåŠ¨å›æ»š
- **å¤šå±‚å¥åº·æ£€æŸ¥**ï¼šæœåŠ¡å¯åŠ¨ã€ç«¯å£ç›‘å¬ã€åŠŸèƒ½éªŒè¯
- **è¯¦ç»†çš„é”™è¯¯æ—¥å¿—**ï¼šä¾¿äºé—®é¢˜è¿½è¸ªå’Œåˆ†æ

**ğŸ”§ å¼€å‘è¿ç»´æ•ˆç‡**
- **å‡å°‘äººå·¥å¹²é¢„**ï¼šè‡ªåŠ¨åŒ–é”™è¯¯å¤„ç†å’Œæ¢å¤
- **æé«˜éƒ¨ç½²æˆåŠŸç‡**ï¼šé¢„æ£€æŸ¥å’Œå®¹é”™æœºåˆ¶
- **å¿«é€Ÿæ•…éšœå®šä½**ï¼šç»“æ„åŒ–é”™è¯¯ä¿¡æ¯å’Œè°ƒè¯•å·¥å…·
- **æ ‡å‡†åŒ–æµç¨‹**ï¼šå¯å¤ç”¨çš„é”™è¯¯å¤„ç†æ¨¡æ¿

**æ ¸å¿ƒè®°å¿†**ï¼š
- é”™è¯¯å¤„ç†æ˜¯Ansibleé«˜çº§åº”ç”¨çš„æ ¸å¿ƒæŠ€èƒ½
- block-rescue-alwaysæä¾›ç»“æ„åŒ–é”™è¯¯å¤„ç†
- åˆç†ä½¿ç”¨ignore_errorså’Œè‡ªå®šä¹‰å¤±è´¥æ¡ä»¶
- ç”Ÿäº§ç¯å¢ƒå¿…é¡»è€ƒè™‘å®Œæ•´çš„å®¹é”™å’Œæ¢å¤æœºåˆ¶
- é¢„é˜²æ€§æ£€æŸ¥æ¯”äº‹åå¤„ç†æ›´é‡è¦