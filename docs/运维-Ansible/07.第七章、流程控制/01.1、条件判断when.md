---
title: 1ã€æ¡ä»¶åˆ¤æ–­when
---
## ğŸ“š ç›®å½•

1. [whenæ¡ä»¶åˆ¤æ–­åŸºç¡€](#1-whenæ¡ä»¶åˆ¤æ–­åŸºç¡€)
2. [åŸºæœ¬æ•°æ®ç±»å‹åˆ¤æ–­](#2-åŸºæœ¬æ•°æ®ç±»å‹åˆ¤æ–­)
3. [å­—ç¬¦ä¸²æ¯”è¾ƒä¸åŒ¹é…](#3-å­—ç¬¦ä¸²æ¯”è¾ƒä¸åŒ¹é…)
4. [æ•°å€¼æ¯”è¾ƒæ“ä½œ](#4-æ•°å€¼æ¯”è¾ƒæ“ä½œ)
5. [åˆ—è¡¨ä¸å­—å…¸åˆ¤æ–­](#5-åˆ—è¡¨ä¸å­—å…¸åˆ¤æ–­)
6. [æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…](#6-æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…)
7. [é€»è¾‘æ“ä½œç¬¦ç»„åˆ](#7-é€»è¾‘æ“ä½œç¬¦ç»„åˆ)
8. [å¤æ‚æ¡ä»¶æ„å»º](#8-å¤æ‚æ¡ä»¶æ„å»º)
9. [å®é™…åº”ç”¨åœºæ™¯](#9-å®é™…åº”ç”¨åœºæ™¯)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ whenæ¡ä»¶åˆ¤æ–­åŸºç¡€


### 1.1 ä»€ä¹ˆæ˜¯whenå…³é”®å­—


**ğŸ”¸ æ ¸å¿ƒå®šä¹‰**
`when`æ˜¯Ansibleä¸­çš„æ¡ä»¶æ§åˆ¶å…³é”®å­—ï¼Œç”¨äºå†³å®šæŸä¸ªä»»åŠ¡æ˜¯å¦æ‰§è¡Œã€‚å°±åƒç”Ÿæ´»ä¸­çš„"å¦‚æœ...é‚£ä¹ˆ..."é€»è¾‘ä¸€æ ·ç®€å•ç›´è§‚ã€‚

**ğŸ’¡ ç”Ÿæ´»ç±»æ¯”**
> å°±åƒæ—©ä¸Šå‡ºé—¨å‰çœ‹å¤©æ°”ï¼šå¦‚æœä¸‹é›¨å°±å¸¦ä¼ï¼Œå¦‚æœæ™´å¤©å°±ä¸ç”¨å¸¦ã€‚Ansibleçš„whenå°±æ˜¯è¿™æ ·çš„åˆ¤æ–­é€»è¾‘ã€‚

### 1.2 åŸºæœ¬è¯­æ³•ç»“æ„


```yaml
- name: ä»»åŠ¡åç§°
  æ¨¡å—å:
    å‚æ•°1: å€¼1
    å‚æ•°2: å€¼2
  when: æ¡ä»¶è¡¨è¾¾å¼
```

**ğŸš€ å¿«é€Ÿä¸Šæ‰‹ç¤ºä¾‹**
```yaml
- name: åªåœ¨CentOSç³»ç»Ÿä¸Šå®‰è£…httpd
  yum:
    name: httpd
    state: present
  when: ansible_os_family == "RedHat"
```

### 1.3 whençš„æ‰§è¡Œæœºåˆ¶


**ğŸ“Š æ‰§è¡Œæµç¨‹**
```
ä»»åŠ¡å¼€å§‹ â†’ è¯„ä¼°whenæ¡ä»¶ â†’ Trueæ‰§è¡Œ/Falseè·³è¿‡ â†’ ä¸‹ä¸€ä¸ªä»»åŠ¡
    â†“
æ¡ä»¶ä¸ºTrue: changed/ok/failed
æ¡ä»¶ä¸ºFalse: skipping
```

**âš ï¸ æ³¨æ„äº‹é¡¹**
- whenæ¡ä»¶åœ¨**æ¯ä¸ªç›®æ ‡ä¸»æœº**ä¸Šç‹¬ç«‹è¯„ä¼°
- æ¡ä»¶ä¸º`False`æ—¶ä»»åŠ¡æ˜¾ç¤ºä¸º**skipping**çŠ¶æ€
- æ¡ä»¶è¡¨è¾¾å¼æ”¯æŒ**Jinja2æ¨¡æ¿è¯­æ³•**

---

## 2. ğŸ“‹ åŸºæœ¬æ•°æ®ç±»å‹åˆ¤æ–­


### 2.1 å¸ƒå°”å€¼åˆ¤æ–­


**ğŸ”¸ å¸ƒå°”å€¼çš„æœ¬è´¨**
å¸ƒå°”å€¼å°±æ˜¯"çœŸ"æˆ–"å‡"çš„åˆ¤æ–­ï¼Œåœ¨Ansibleä¸­ç»å¸¸ç”¨æ¥æ§åˆ¶ä»»åŠ¡çš„æ‰§è¡Œã€‚

**åŸºæœ¬ç”¨æ³•å¯¹æ¯”**
```yaml
# ç›´æ¥ä½¿ç”¨å˜é‡ï¼ˆæ¨èï¼‰
- name: å½“éœ€è¦é‡å¯æ—¶æ‰§è¡Œ
  service:
    name: nginx
    state: restarted
  when: need_restart

# æ˜¾å¼å¸ƒå°”å€¼æ¯”è¾ƒ
- name: æ˜ç¡®æ£€æŸ¥trueå€¼
  debug:
    msg: "æœåŠ¡å·²å¯ç”¨"
  when: service_enabled == true

- name: æ£€æŸ¥falseå€¼
  debug:
    msg: "æœåŠ¡å·²ç¦ç”¨"
  when: service_enabled == false
```

**ğŸ’¡ å…³é”®æ´å¯Ÿ**
> åœ¨Ansibleä¸­ï¼Œå˜é‡æœ¬èº«å°±å¯ä»¥ä½œä¸ºå¸ƒå°”æ¡ä»¶ã€‚`when: my_var`ç­‰åŒäº`when: my_var == true`

### 2.2 å˜é‡å­˜åœ¨æ€§åˆ¤æ–­


**æ£€æŸ¥å˜é‡æ˜¯å¦å®šä¹‰**
```yaml
# å˜é‡å·²å®šä¹‰æ—¶æ‰§è¡Œ
- name: ä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰é…ç½®
  template:
    src: custom.conf.j2
    dest: /etc/app/custom.conf
  when: custom_config is defined

# å˜é‡æœªå®šä¹‰æ—¶æ‰§è¡Œ
- name: ä½¿ç”¨é»˜è®¤é…ç½®
  copy:
    src: default.conf
    dest: /etc/app/default.conf
  when: custom_config is not defined
```

**ğŸ“ˆ è¿›é˜¶è·¯å¾„**
```
åŸºç¡€åˆ¤æ–­ â†’ ç»„åˆæ¡ä»¶ â†’ å¤æ‚é€»è¾‘
    â†“        â†“        â†“
  ç®€å•     ä¸­ç­‰      é«˜çº§
```

---

## 3. ğŸ”¤ å­—ç¬¦ä¸²æ¯”è¾ƒä¸åŒ¹é…


### 3.1 åŸºæœ¬å­—ç¬¦ä¸²æ¯”è¾ƒ


**ç›¸ç­‰æ€§æ¯”è¾ƒ**
```yaml
# ç²¾ç¡®åŒ¹é…
- name: åœ¨Ubuntuç³»ç»Ÿä¸Šå®‰è£…è½¯ä»¶
  apt:
    name: nginx
    state: present
  when: ansible_distribution == "Ubuntu"

# ä¸ç­‰äºæ¯”è¾ƒ
- name: éç”Ÿäº§ç¯å¢ƒçš„è°ƒè¯•ä»»åŠ¡
  debug:
    msg: "è¿™æ˜¯æµ‹è¯•ç¯å¢ƒ"
  when: environment != "production"
```

**ğŸ¯ è®°å¿†å£è¯€**
> åŒç­‰å·åˆ¤ç›¸ç­‰ï¼Œæ„Ÿå¹ç­‰å·åˆ¤ä¸ç­‰

### 3.2 å­—ç¬¦ä¸²åŒ…å«åˆ¤æ–­


**inæ“ä½œç¬¦ä½¿ç”¨**
```yaml
# æ£€æŸ¥å­—ç¬¦ä¸²åŒ…å«
- name: åœ¨Red Hatç³»åˆ—ç³»ç»Ÿä¸Šæ“ä½œ
  yum:
    name: vim
    state: present
  when: "'RedHat' in ansible_os_family or 'CentOS' in ansible_distribution"

# æ£€æŸ¥ç‰ˆæœ¬å­—ç¬¦ä¸²
- name: Python3ç¯å¢ƒæ£€æŸ¥
  debug:
    msg: "Python 3ç¯å¢ƒ"
  when: "'python3' in ansible_python_interpreter"
```

### 3.3 å­—ç¬¦ä¸²æ¨¡å¼åŒ¹é…


**startswithå’Œendswithæ–¹æ³•**
```yaml
# æ–‡ä»¶åæ£€æŸ¥
- name: å¤„ç†é…ç½®æ–‡ä»¶
  lineinfile:
    path: "/etc/{{ item }}"
    line: "# Auto-generated config"
  loop: "{{ config_files }}"
  when: item.startswith('app') and item.endswith('.conf')

# ç‰ˆæœ¬å·æ£€æŸ¥
- name: æ—§ç‰ˆæœ¬ç³»ç»Ÿå¤„ç†
  shell: echo "æ—§ç‰ˆæœ¬å¤„ç†é€»è¾‘"
  when: ansible_distribution_version.startswith('18')
```

**ğŸ“ å­¦ä¹ æ£€æŸ¥ç‚¹**
- [ ] ç†è§£å­—ç¬¦ä¸²ç›¸ç­‰æ¯”è¾ƒ
- [ ] æŒæ¡åŒ…å«å…³ç³»åˆ¤æ–­
- [ ] å­¦ä¼šæ¨¡å¼åŒ¹é…æ–¹æ³•

---

## 4. ğŸ”¢ æ•°å€¼æ¯”è¾ƒæ“ä½œ


### 4.1 åŸºæœ¬æ•°å€¼æ¯”è¾ƒ


**æ¯”è¾ƒæ“ä½œç¬¦å®Œæ•´åˆ—è¡¨**

| æ“ä½œç¬¦ | å«ä¹‰ | ç¤ºä¾‹ | è¯´æ˜ |
|--------|------|------|------|
| `==` | ç­‰äº | `cpu_count == 4` | ç²¾ç¡®ç›¸ç­‰ |
| `!=` | ä¸ç­‰äº | `memory_gb != 8` | ä¸ç›¸ç­‰ |
| `>` | å¤§äº | `disk_usage > 80` | ä¸¥æ ¼å¤§äº |
| `>=` | å¤§äºç­‰äº | `uptime >= 7` | å¤§äºæˆ–ç­‰äº |
| `<` | å°äº | `load_avg < 1.0` | ä¸¥æ ¼å°äº |
| `<=` | å°äºç­‰äº | `temperature <= 70` | å°äºæˆ–ç­‰äº |

**å®é™…åº”ç”¨ç¤ºä¾‹**
```yaml
# å†…å­˜æ£€æŸ¥
- name: é«˜å†…å­˜æœåŠ¡å™¨ç‰¹æ®Šé…ç½®
  sysctl:
    name: vm.swappiness
    value: '10'
  when: ansible_memtotal_mb >= 16384  # 16GBä»¥ä¸Š

# ç£ç›˜ç©ºé—´ç›‘æ§
- name: ç£ç›˜ç©ºé—´è­¦å‘Š
  debug:
    msg: "ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œä½¿ç”¨ç‡: {{ disk_usage }}%"
  when: disk_usage|int > 85

# CPUæ ¸å¿ƒæ•°åˆ¤æ–­
- name: å¤šæ ¸æœåŠ¡å™¨ä¼˜åŒ–
  replace:
    path: /etc/nginx/nginx.conf
    regexp: 'worker_processes.*'
    replace: 'worker_processes {{ ansible_processor_vcpus }};'
  when: ansible_processor_vcpus > 2
```

### 4.2 æ•°å€¼èŒƒå›´åˆ¤æ–­


**åŒºé—´åˆ¤æ–­æŠ€å·§**
```yaml
# æ€§èƒ½ç­‰çº§åˆ¤æ–­
- name: ä¸­ç­‰æ€§èƒ½æœåŠ¡å™¨é…ç½®
  template:
    src: medium-performance.conf.j2
    dest: /etc/app/config.conf
  when: ansible_memtotal_mb >= 4096 and ansible_memtotal_mb < 16384

# ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥
- name: å…¼å®¹çš„Pythonç‰ˆæœ¬
  pip:
    name: "{{ python_packages }}"
    state: present
  when: 
    - python_version|float >= 3.6
    - python_version|float < 4.0
```

**ğŸ” æ·±å…¥æ€è€ƒ**
> ä¸ºä»€ä¹ˆè¦ç”¨`|int`å’Œ`|float`è¿‡æ»¤å™¨ï¼Ÿå› ä¸ºAnsibleä¸­çš„å˜é‡å¯èƒ½æ˜¯å­—ç¬¦ä¸²æ ¼å¼ï¼Œéœ€è¦è½¬æ¢ä¸ºæ•°å€¼æ‰èƒ½è¿›è¡Œæ•°å­¦æ¯”è¾ƒã€‚

---

## 5. ğŸ“¦ åˆ—è¡¨ä¸å­—å…¸åˆ¤æ–­


### 5.1 åˆ—è¡¨æ“ä½œåˆ¤æ–­


**åˆ—è¡¨åŒ…å«æ£€æŸ¥**
```yaml
# æ£€æŸ¥æœåŠ¡æ˜¯å¦åœ¨å…è®¸åˆ—è¡¨ä¸­
- name: å¯åŠ¨å…è®¸çš„æœåŠ¡
  systemd:
    name: "{{ item }}"
    state: started
  loop: "{{ requested_services }}"
  when: item in allowed_services

# æ£€æŸ¥ç«¯å£æ˜¯å¦å¼€æ”¾
- name: é…ç½®é˜²ç«å¢™è§„åˆ™
  firewalld:
    port: "{{ app_port }}/tcp"
    permanent: yes
    state: enabled
  when: app_port|string in open_ports

# å¤šä¸ªæ¡ä»¶çš„åˆ—è¡¨æ£€æŸ¥
- name: æ•°æ®åº“æœåŠ¡å™¨é…ç½®
  template:
    src: database.conf.j2
    dest: /etc/db/config.conf
  when: 
    - "'database' in server_roles"
    - "inventory_hostname in database_servers"
```

### 5.2 å­—å…¸é”®å€¼åˆ¤æ–­


**å­—å…¸ç»“æ„æ“ä½œ**
```yaml
# æ£€æŸ¥å­—å…¸é”®æ˜¯å¦å­˜åœ¨
- name: åº”ç”¨ç‰¹å®šé…ç½®
  copy:
    content: "{{ app_configs[app_name] }}"
    dest: "/etc/{{ app_name }}/config.yaml"
  when: app_name in app_configs

# å­—å…¸å€¼çš„åˆ¤æ–­
- name: SSLè¯ä¹¦é…ç½®
  copy:
    src: "{{ ssl_certs[domain_name].cert_file }}"
    dest: "/etc/ssl/certs/{{ domain_name }}.crt"
  when: 
    - domain_name in ssl_certs
    - ssl_certs[domain_name].enabled == true
```

**ğŸ“Š å¯¹æ¯”çŸ©é˜µ**

| æ•°æ®ç±»å‹ | åŒ…å«æ£€æŸ¥ | é”®å­˜åœ¨æ£€æŸ¥ | å€¼æ¯”è¾ƒ |
|----------|----------|------------|--------|
| **åˆ—è¡¨** | `item in list` | N/A | `list[0] == value` |
| **å­—å…¸** | `value in dict.values()` | `key in dict` | `dict[key] == value` |
| **å­—ç¬¦ä¸²** | `'sub' in string` | N/A | `string == value` |

---

## 6. ğŸ” æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…


### 6.1 åŸºæœ¬æ­£åˆ™åŒ¹é…


**ğŸ”¸ æ­£åˆ™è¡¨è¾¾å¼çš„ä½œç”¨**
æ­£åˆ™è¡¨è¾¾å¼å°±åƒä¸€ä¸ªæ™ºèƒ½çš„æ–‡æœ¬æœç´¢å·¥å…·ï¼Œå¯ä»¥è¯†åˆ«å¤æ‚çš„å­—ç¬¦ä¸²æ¨¡å¼ã€‚åœ¨Ansibleä¸­ç”¨äºçµæ´»çš„æ¡ä»¶åˆ¤æ–­ã€‚

**matchæ“ä½œç¬¦ä½¿ç”¨**
```yaml
# IPåœ°å€æ ¼å¼éªŒè¯
- name: éªŒè¯IPåœ°å€æ ¼å¼
  debug:
    msg: "æœ‰æ•ˆçš„IPåœ°å€"
  when: server_ip is match("^([0-9]{1,3}\.){3}[0-9]{1,3}$")

# ä¸»æœºåæ¨¡å¼åŒ¹é…
- name: WebæœåŠ¡å™¨ä¸“ç”¨é…ç½®
  template:
    src: web-server.conf.j2
    dest: /etc/config.conf
  when: inventory_hostname is match("^web[0-9]+")
```

### 6.2 searchå’Œregexæµ‹è¯•


**search vs matchçš„åŒºåˆ«**
```yaml
# search: åœ¨å­—ç¬¦ä¸²ä¸­æœç´¢æ¨¡å¼
- name: æ—¥å¿—æ–‡ä»¶åŒ…å«é”™è¯¯
  debug:
    msg: "å‘ç°é”™è¯¯æ—¥å¿—"
  when: log_content is search("ERROR|CRITICAL")

# match: ä»å­—ç¬¦ä¸²å¼€å¤´åŒ¹é…
- name: ç³»ç»Ÿç‰ˆæœ¬æ£€æŸ¥
  debug:
    msg: "Ubuntu 20.04ç³»ç»Ÿ"
  when: ansible_distribution_release is match("focal")

# regexæµ‹è¯•ï¼ˆæ›´çµæ´»ï¼‰
- name: é‚®ç®±æ ¼å¼éªŒè¯
  mail:
    to: "{{ user_email }}"
    subject: "ç³»ç»Ÿé€šçŸ¥"
  when: user_email is regex("^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$")
```

**ğŸ’¡ å…³é”®æ´å¯Ÿ**
> `match`ä»å¼€å¤´åŒ¹é…ï¼Œ`search`åœ¨ä»»æ„ä½ç½®æœç´¢ã€‚é€‰æ‹©åˆé€‚çš„æ–¹æ³•å¾ˆé‡è¦ï¼

### 6.3 å¸¸ç”¨æ­£åˆ™æ¨¡å¼


**å®ç”¨æ­£åˆ™è¡¨è¾¾å¼åº“**
```yaml
# ç‰ˆæœ¬å·åŒ¹é…
- name: ç‰¹å®šç‰ˆæœ¬è½¯ä»¶å¤„ç†
  package:
    name: "{{ software_name }}"
    state: present
  when: software_version is match("^[2-9]\.[0-9]+\.[0-9]+")

# MACåœ°å€éªŒè¯
- name: ç½‘ç»œæ¥å£é…ç½®
  template:
    src: network.j2
    dest: /etc/network/interfaces
  when: interface_mac is regex("^([0-9A-Fa-f]{2}[:-]){5}[0-9A-Fa-f]{2}$")

# æ–‡ä»¶æ‰©å±•åæ£€æŸ¥
- name: å¤„ç†é…ç½®æ–‡ä»¶
  lineinfile:
    path: "{{ config_file }}"
    line: "# Modified by Ansible"
  when: config_file is search("\.(conf|cfg|ini|yaml|yml)$")
```

**ğŸ¯ ä¸€åˆ†é’ŸæŒæ¡**
æ­£åˆ™è¡¨è¾¾å¼çš„3ä¸ªæ ¸å¿ƒç”¨é€”ï¼š
1. **æ ¼å¼éªŒè¯**ï¼šç¡®ä¿æ•°æ®ç¬¦åˆé¢„æœŸæ ¼å¼
2. **æ¨¡å¼åŒ¹é…**ï¼šæ ¹æ®å‘½åè§„åˆ™åˆ†ç±»å¤„ç†
3. **å†…å®¹æœç´¢**ï¼šåœ¨æ–‡æœ¬ä¸­æŸ¥æ‰¾ç‰¹å®šæ¨¡å¼

---

## 7. ğŸ”— é€»è¾‘æ“ä½œç¬¦ç»„åˆ


### 7.1 åŸºæœ¬é€»è¾‘æ“ä½œç¬¦


**ANDé€»è¾‘ï¼ˆä¸”ï¼‰**
```yaml
# å¤šä¸ªæ¡ä»¶åŒæ—¶æ»¡è¶³
- name: ç”Ÿäº§ç¯å¢ƒçš„WebæœåŠ¡å™¨
  systemd:
    name: nginx
    state: started
    enabled: yes
  when: 
    - environment == "production"
    - "'web' in server_roles"
    - ansible_memtotal_mb >= 4096

# å•è¡ŒANDå†™æ³•
- name: é«˜æ€§èƒ½æ•°æ®åº“é…ç½®
  sysctl:
    name: vm.dirty_ratio
    value: '5'
  when: server_type == "database" and ansible_processor_vcpus >= 8
```

**ORé€»è¾‘ï¼ˆæˆ–ï¼‰**
```yaml
# å¤šä¸ªæ¡ä»¶ä»»ä¸€æ»¡è¶³
- name: RedHatç³»åˆ—ç³»ç»ŸåŒ…ç®¡ç†
  yum:
    name: git
    state: present
  when: ansible_os_family == "RedHat" or ansible_distribution == "CentOS"

# å¤æ‚ORç»„åˆ
- name: å¼€å‘æˆ–æµ‹è¯•ç¯å¢ƒçš„è°ƒè¯•å·¥å…·
  package:
    name: "{{ debug_tools }}"
    state: present
  when: >
    environment == "development" or
    environment == "testing" or
    debug_mode == true
```

**NOTé€»è¾‘ï¼ˆéï¼‰**
```yaml
# æ’é™¤ç‰¹å®šæ¡ä»¶
- name: éWindowsç³»ç»Ÿä»»åŠ¡
  shell: echo "Unix-like system detected"
  when: not (ansible_os_family == "Windows")

# å¤æ‚NOTç»„åˆ
- name: éå…³é”®ä¸šåŠ¡æ—¶é—´æ‰§è¡Œ
  cron:
    name: "ç³»ç»Ÿæ¸…ç†"
    hour: "2"
    minute: "0"
    job: "/usr/local/bin/cleanup.sh"
  when: not (business_hours == true and critical_system == true)
```

### 7.2 é€»è¾‘ä¼˜å…ˆçº§å’Œåˆ†ç»„


**æ‹¬å·åˆ†ç»„æ§åˆ¶ä¼˜å…ˆçº§**
```yaml
# æ¸…æ™°çš„é€»è¾‘åˆ†ç»„
- name: ç‰¹å®šç¯å¢ƒå’Œè§’è‰²çš„é…ç½®
  template:
    src: special-config.j2
    dest: /etc/app/config.conf
  when: >
    (environment == "production" or environment == "staging") and
    (server_role == "web" or server_role == "api") and
    enable_special_features == true

# å¤æ‚ä¸šåŠ¡é€»è¾‘
- name: æ•°æ®åº“å¤‡ä»½ç­–ç•¥
  cron:
    name: "æ•°æ®åº“å¤‡ä»½"
    hour: "{{ backup_hour | default('1') }}"
    job: "/usr/local/bin/db-backup.sh"
  when: >
    (
      (server_role == "database" and backup_enabled == true) or
      (server_role == "master" and is_primary == true)
    ) and
    not (maintenance_mode == true or readonly_mode == true)
```

**ğŸš¨ æ³¨æ„äº‹é¡¹**
- ä½¿ç”¨`>`è¿›è¡Œå¤šè¡Œæ¡ä»¶æ—¶ï¼Œæ³¨æ„ç¼©è¿›
- å¤æ‚æ¡ä»¶å»ºè®®ç”¨æ‹¬å·æ˜ç¡®ä¼˜å…ˆçº§
- é¿å…è¿‡åº¦åµŒå¥—ï¼Œå½±å“å¯è¯»æ€§

---

## 8. ğŸ”§ å¤æ‚æ¡ä»¶æ„å»º


### 8.1 å˜é‡è®¡ç®—ç»“æœåˆ¤æ–­


**æ•°å­¦è¿ç®—ç»“æœæ¡ä»¶**
```yaml
# è®¡ç®—ç™¾åˆ†æ¯”
- name: å†…å­˜ä½¿ç”¨ç‡è­¦å‘Š
  debug:
    msg: "å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: {{ (memory_used / memory_total * 100) | round(1) }}%"
  when: (memory_used / memory_total * 100) > 80

# æ—¶é—´è®¡ç®—
- name: é•¿æ—¶é—´è¿è¡Œçš„æœåŠ¡é‡å¯
  systemd:
    name: "{{ service_name }}"
    state: restarted
  when: 
    - service_uptime_days is defined
    - service_uptime_days | int > 30
```

### 8.2 factså’Œå˜é‡ç»„åˆåˆ¤æ–­


**ç³»ç»Ÿä¿¡æ¯ç»¼åˆåˆ¤æ–­**
```yaml
# ç³»ç»Ÿèµ„æºç»¼åˆè¯„ä¼°
- name: é«˜è´Ÿè½½ç³»ç»Ÿä¼˜åŒ–
  sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
  loop:
    - { name: 'net.core.somaxconn', value: '65535' }
    - { name: 'net.ipv4.tcp_max_syn_backlog', value: '65535' }
  when: >
    ansible_processor_vcpus >= 4 and
    ansible_memtotal_mb >= 8192 and
    ansible_system_vendor != "VMware, Inc." and
    current_load_average | float > 2.0

# ç½‘ç»œæ¥å£çŠ¶æ€åˆ¤æ–­
- name: é…ç½®é«˜é€Ÿç½‘ç»œæ¥å£
  template:
    src: high-speed-interface.j2
    dest: /etc/network/interfaces.d/{{ ansible_default_ipv4.interface }}
  when: >
    ansible_default_ipv4.interface is defined and
    ansible_default_ipv4.speed is defined and
    ansible_default_ipv4.speed | int >= 1000 and
    network_optimization == true
```

### 8.3 registerç»“æœåˆ¤æ–­


**ä»»åŠ¡æ‰§è¡Œç»“æœæ¡ä»¶**
```yaml
# åŸºäºå‰ä¸€ä»»åŠ¡ç»“æœçš„åˆ¤æ–­
- name: æ£€æŸ¥æœåŠ¡çŠ¶æ€
  systemd:
    name: nginx
    state: started
  register: nginx_result
  ignore_errors: yes

- name: æœåŠ¡å¯åŠ¨å¤±è´¥æ—¶çš„æ¢å¤æ“ä½œ
  shell: |
    systemctl reset-failed nginx
    systemctl start nginx
  when: 
    - nginx_result is failed
    - nginx_result.msg is search("failed")

# å‘½ä»¤æ‰§è¡Œç»“æœåˆ¤æ–­
- name: æ£€æŸ¥ç£ç›˜ç©ºé—´
  shell: df -h /var | tail -1 | awk '{print $5}' | sed 's/%//'
  register: disk_usage
  changed_when: false

- name: ç£ç›˜ç©ºé—´æ¸…ç†
  shell: /usr/local/bin/cleanup-logs.sh
  when: 
    - disk_usage.stdout is defined
    - disk_usage.stdout | int > 85
```

**ğŸ“ˆ è¿›é˜¶è·¯å¾„**
```
ç®€å•æ¡ä»¶ â†’ ç»„åˆæ¡ä»¶ â†’ è®¡ç®—æ¡ä»¶ â†’ ç»“æœæ¡ä»¶
    â†“         â†“         â†“         â†“
  åŸºç¡€      è¿›é˜¶      é«˜çº§      ä¸“å®¶
```

---

## 9. ğŸš€ å®é™…åº”ç”¨åœºæ™¯


### 9.1 ç¯å¢ƒåŒºåˆ†éƒ¨ç½²


**å¤šç¯å¢ƒç®¡ç†ç­–ç•¥**
```yaml
# å¼€å‘ç¯å¢ƒé…ç½®
- name: å¼€å‘ç¯å¢ƒè°ƒè¯•é…ç½®
  template:
    src: debug.conf.j2
    dest: /etc/app/debug.conf
  when: 
    - environment == "development"
    - enable_debug_mode | default(false) | bool

# ç”Ÿäº§ç¯å¢ƒå®‰å…¨åŠ å›º
- name: ç”Ÿäº§ç¯å¢ƒå®‰å…¨é…ç½®
  sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
  loop:
    - { name: 'net.ipv4.conf.all.send_redirects', value: '0' }
    - { name: 'net.ipv4.conf.all.accept_redirects', value: '0' }
  when: >
    environment == "production" and
    security_hardening == true

# æµ‹è¯•ç¯å¢ƒç‰¹æ®Šå·¥å…·
- name: æµ‹è¯•ç¯å¢ƒç›‘æ§å·¥å…·
  package:
    name: "{{ test_monitoring_tools }}"
    state: present
  when: >
    environment in ["testing", "staging"] and
    install_monitoring == true
```

### 9.2 ç³»ç»Ÿå·®å¼‚åŒ–å¤„ç†


**è·¨å¹³å°å…¼å®¹æ€§**
```yaml
# ä¸åŒæ“ä½œç³»ç»Ÿçš„åŒ…ç®¡ç†
- name: RedHatç³»åˆ—å®‰è£…è½¯ä»¶
  yum:
    name: "{{ packages }}"
    state: present
  when: ansible_os_family == "RedHat"

- name: Debianç³»åˆ—å®‰è£…è½¯ä»¶
  apt:
    name: "{{ packages }}"
    state: present
    update_cache: yes
  when: ansible_os_family == "Debian"

# ç‰ˆæœ¬ç‰¹å®šå¤„ç†
- name: Ubuntu 18.04ç‰¹æ®Šé…ç½®
  lineinfile:
    path: /etc/systemd/resolved.conf
    line: "DNS=8.8.8.8"
    state: present
  when: >
    ansible_distribution == "Ubuntu" and
    ansible_distribution_version is version('18.04', '>=') and
    ansible_distribution_version is version('20.04', '<')

# æ¶æ„ç›¸å…³é…ç½®
- name: ARMæ¶æ„ä¼˜åŒ–
  sysctl:
    name: vm.dirty_background_ratio
    value: '5'
  when: ansible_architecture in ["aarch64", "armv7l"]
```

### 9.3 ä¸šåŠ¡é€»è¾‘æ§åˆ¶


**æœåŠ¡ä¾èµ–ç®¡ç†**
```yaml
# æ•°æ®åº“æœåŠ¡å™¨é…ç½®
- name: å®‰è£…æ•°æ®åº“æœåŠ¡
  package:
    name: "{{ database_package }}"
    state: present
  when: >
    'database' in server_roles and
    database_package is defined

# æ•°æ®åº“åˆå§‹åŒ–ï¼ˆä»…é¦–æ¬¡ï¼‰
- name: åˆå§‹åŒ–æ•°æ®åº“
  shell: "{{ database_init_command }}"
  when: >
    'database' in server_roles and
    database_initialized is not defined and
    database_master == inventory_hostname

# WebæœåŠ¡å™¨é…ç½®ï¼ˆä¾èµ–æ•°æ®åº“ï¼‰
- name: é…ç½®WebæœåŠ¡å™¨æ•°æ®åº“è¿æ¥
  template:
    src: database-config.j2
    dest: /etc/webapp/db-config.ini
  when: >
    'web' in server_roles and
    'database' in groups and
    groups['database'] | length > 0
  notify: restart webapp
```

### 9.4 ç»´æŠ¤æ—¶é—´çª—å£æ§åˆ¶


**å®šæ—¶ç»´æŠ¤ä»»åŠ¡**
```yaml
# å·¥ä½œæ—¶é—´åˆ¤æ–­å˜é‡è®¾ç½®
- name: è®¾ç½®ä¸šåŠ¡æ—¶é—´æ ‡å¿—
  set_fact:
    is_business_hours: >-
      {{
        (ansible_date_time.hour | int >= 9 and ansible_date_time.hour | int < 17) and
        (ansible_date_time.weekday | int < 5)
      }}

# éå·¥ä½œæ—¶é—´æ‰§è¡Œç»´æŠ¤
- name: ç³»ç»Ÿæ›´æ–°ï¼ˆéå·¥ä½œæ—¶é—´ï¼‰
  package:
    name: "*"
    state: latest
  when: >
    not is_business_hours | bool and
    allow_system_updates | default(false) | bool and
    environment != "production"

# ç´§æ€¥ä¿®å¤ï¼ˆå¿½ç•¥æ—¶é—´é™åˆ¶ï¼‰
- name: ç´§æ€¥å®‰å…¨è¡¥ä¸
  package:
    name: "{{ security_packages }}"
    state: latest
  when: >
    emergency_patch | default(false) | bool or
    (not is_business_hours | bool and security_update_required | default(false) | bool)
```

**ğŸ¯ å¿…é¡»ç†è§£**
å®é™…åº”ç”¨ä¸­ï¼Œæ¡ä»¶åˆ¤æ–­é€šå¸¸ç»“åˆï¼š
1. **ç¯å¢ƒå˜é‡**ï¼šåŒºåˆ†å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§
2. **ä¸»æœºåˆ†ç»„**ï¼šä¸åŒè§’è‰²çš„æœåŠ¡å™¨
3. **ç³»ç»Ÿä¿¡æ¯**ï¼šé€‚é…ä¸åŒæ“ä½œç³»ç»Ÿ
4. **ä¸šåŠ¡é€»è¾‘**ï¼šæ»¡è¶³ç‰¹å®šä¸šåŠ¡éœ€æ±‚

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„åŸºç¡€æ¦‚å¿µ


```
ğŸ”¸ whenå…³é”®å­—ï¼šAnsibleæ¡ä»¶æ§åˆ¶çš„æ ¸å¿ƒï¼Œå†³å®šä»»åŠ¡æ˜¯å¦æ‰§è¡Œ
ğŸ”¸ æ¡ä»¶ç±»å‹ï¼šå¸ƒå°”å€¼ã€å­—ç¬¦ä¸²ã€æ•°å€¼ã€åˆ—è¡¨ã€å­—å…¸ã€æ­£åˆ™è¡¨è¾¾å¼
ğŸ”¸ é€»è¾‘æ“ä½œï¼šandã€orã€notä¸‰ç§åŸºæœ¬é€»è¾‘ç»„åˆ
ğŸ”¸ å˜é‡åˆ¤æ–­ï¼šdefinedã€undefinedæ£€æŸ¥å˜é‡å­˜åœ¨æ€§
ğŸ”¸ æ¯”è¾ƒæ“ä½œï¼š==ã€!=ã€>ã€<ã€>=ã€<= æ•°å€¼æ¯”è¾ƒè¿ç®—
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ whenæ¡ä»¶çš„æœ¬è´¨**
```
æ ¸å¿ƒåŸç†ï¼š
â€¢ whenåè·ŸJinja2è¡¨è¾¾å¼ï¼Œç»“æœä¸ºTrue/False
â€¢ Trueæ—¶æ‰§è¡Œä»»åŠ¡ï¼ŒFalseæ—¶è·³è¿‡(skipping)
â€¢ æ¯ä¸ªä¸»æœºç‹¬ç«‹è¯„ä¼°æ¡ä»¶
â€¢ æ”¯æŒå˜é‡ã€å‡½æ•°ã€è¿‡æ»¤å™¨çš„ç»„åˆä½¿ç”¨
```

**ğŸ”¹ æ•°æ®ç±»å‹åˆ¤æ–­æŠ€å·§**
```
å­—ç¬¦ä¸²åˆ¤æ–­ï¼š
â€¢ ç›¸ç­‰æ¯”è¾ƒï¼švariable == "value"
â€¢ åŒ…å«æ£€æŸ¥ï¼š'substring' in variable
â€¢ æ¨¡å¼åŒ¹é…ï¼švariable is match("pattern")

æ•°å€¼åˆ¤æ–­ï¼š
â€¢ è®°å¾—ç±»å‹è½¬æ¢ï¼švariable|int > 100
â€¢ èŒƒå›´åˆ¤æ–­ï¼švalue >= min and value < max
â€¢ ç©ºå€¼å¤„ç†ï¼švariable | default(0) | int

åˆ—è¡¨å­—å…¸ï¼š
â€¢ åˆ—è¡¨åŒ…å«ï¼šitem in list_variable
â€¢ å­—å…¸é”®æ£€æŸ¥ï¼škey in dict_variable
â€¢ åµŒå¥—è®¿é—®ï¼šdict_var[key].sub_key is defined
```

**ğŸ”¹ å¤æ‚æ¡ä»¶æ„å»ºåŸåˆ™**
```
å¯è¯»æ€§ä¼˜å…ˆï¼š
â€¢ å¤æ‚æ¡ä»¶ç”¨å¤šè¡Œä¹¦å†™
â€¢ åˆç†ä½¿ç”¨æ‹¬å·æ§åˆ¶ä¼˜å…ˆçº§
â€¢ é€‚å½“æ·»åŠ æ³¨é‡Šè¯´æ˜ä¸šåŠ¡é€»è¾‘

æ€§èƒ½è€ƒè™‘ï¼š
â€¢ ç®€å•æ¡ä»¶æ”¾åœ¨å‰é¢ï¼ˆçŸ­è·¯åŸåˆ™ï¼‰
â€¢ é¿å…é‡å¤è®¡ç®—ç›¸åŒè¡¨è¾¾å¼
â€¢ registerç»“æœç¼“å­˜å¤ç”¨
```

### 10.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ”¹ ç¯å¢ƒé€‚é…ç­–ç•¥**
```
ç³»ç»Ÿå·®å¼‚åŒ–ï¼š
âœ… åŸºäºansible_os_familyåŒºåˆ†æ“ä½œç³»ç»Ÿ
âœ… ä½¿ç”¨ansible_distribution_versionå¤„ç†ç‰ˆæœ¬å·®å¼‚
âœ… æ ¹æ®ansible_architectureå¤„ç†æ¶æ„å·®å¼‚

ç¯å¢ƒåŒºåˆ†ï¼š
âœ… environmentå˜é‡åŒºåˆ†å¼€å‘/æµ‹è¯•/ç”Ÿäº§
âœ… ç»“åˆinventoryåˆ†ç»„å®ç°æ‰¹é‡æ§åˆ¶
âœ… ä½¿ç”¨group_varså®šä¹‰ç¯å¢ƒç‰¹å®šå˜é‡
```

**ğŸ”¹ æœ€ä½³å®è·µå»ºè®®**
```
æ¡ä»¶ç¼–å†™ï¼š
â€¢ ä¼˜å…ˆä½¿ç”¨åˆ—è¡¨æ ¼å¼çš„å¤šæ¡ä»¶ï¼ˆæ¸…æ™°æ˜“è¯»ï¼‰
â€¢ å¤æ‚é€»è¾‘æå–ä¸ºå•ç‹¬å˜é‡
â€¢ é¿å…åœ¨whenä¸­ç›´æ¥å†™å¤æ‚è®¡ç®—

é”™è¯¯å¤„ç†ï¼š
â€¢ ä½¿ç”¨default()è¿‡æ»¤å™¨æä¾›é»˜è®¤å€¼
â€¢ æ£€æŸ¥å˜é‡å®šä¹‰çŠ¶æ€é¿å…æœªå®šä¹‰é”™è¯¯
â€¢ ç»“åˆignore_errorså’Œfailed_whenç²¾ç¡®æ§åˆ¶
```

### 10.4 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ


**âŒ å¸¸è§è¯¯åŒº**
```
å­—ç¬¦ä¸²æ¯”è¾ƒé”™è¯¯ï¼š
é”™è¯¯ï¼šwhen: variable == 123  # å­—ç¬¦ä¸²å’Œæ•°å­—æ¯”è¾ƒ
æ­£ç¡®ï¼šwhen: variable|int == 123

å˜é‡æœªå®šä¹‰é”™è¯¯ï¼š  
é”™è¯¯ï¼šwhen: undefined_var == "value"  # å¯èƒ½æŠ¥é”™
æ­£ç¡®ï¼šwhen: undefined_var|default("") == "value"

é€»è¾‘ä¼˜å…ˆçº§æ··ä¹±ï¼š
é”™è¯¯ï¼šwhen: a == 1 or b == 2 and c == 3  # ä¸æ¸…æ™°
æ­£ç¡®ï¼šwhen: a == 1 or (b == 2 and c == 3)  # æ˜ç¡®ä¼˜å…ˆçº§
```

**âœ… è§£å†³æ–¹æ¡ˆ**
```
è°ƒè¯•æŠ€å·§ï¼š
â€¢ ä½¿ç”¨debugæ¨¡å—è¾“å‡ºå˜é‡å€¼
â€¢ åˆ©ç”¨ansible-playbook -væŸ¥çœ‹è·³è¿‡åŸå› 
â€¢ ä¸´æ—¶ç®€åŒ–æ¡ä»¶é€æ­¥æ’æŸ¥é—®é¢˜

æ€§èƒ½ä¼˜åŒ–ï¼š
â€¢ å°†å¸¸ç”¨åˆ¤æ–­æ¡ä»¶è®¾ä¸ºfactå˜é‡
â€¢ å¤æ‚è®¡ç®—ç»“æœregisterä¿å­˜å¤ç”¨
â€¢ åˆç†ä½¿ç”¨tagså®ç°æ¡ä»¶æ‰§è¡Œ
```

### 10.5 å­¦ä¹ è¿›é˜¶è·¯å¾„


**ğŸš€ å¿«é€Ÿä¸Šæ‰‹**ï¼ˆ1-2å‘¨ï¼‰
```
1ï¸âƒ£ æŒæ¡åŸºæœ¬æ•°æ®ç±»å‹åˆ¤æ–­ï¼ˆå¸ƒå°”ã€å­—ç¬¦ä¸²ã€æ•°å€¼ï¼‰
2ï¸âƒ£ å­¦ä¼šç®€å•çš„and/oré€»è¾‘ç»„åˆ
3ï¸âƒ£ ç†Ÿç»ƒä½¿ç”¨ç³»ç»Ÿfactsè¿›è¡Œç¯å¢ƒåˆ¤æ–­
```

**ğŸ’ª å®è·µæŒ‘æˆ˜**ï¼ˆ2-4å‘¨ï¼‰
```
4ï¸âƒ£ æ„å»ºå¤æ‚çš„å¤šæ¡ä»¶åˆ¤æ–­é€»è¾‘
5ï¸âƒ£ ç»“åˆregisterå®ç°ä¾èµ–ä»»åŠ¡æ§åˆ¶
6ï¸âƒ£ ç¼–å†™è·¨å¹³å°å…¼å®¹çš„playbook
```

**ğŸ¯ è®°å¿†è¦ç‚¹**
- whenæ¡ä»¶å°±æ˜¯ifåˆ¤æ–­ï¼ŒTrueæ‰§è¡ŒFalseè·³è¿‡
- å­—ç¬¦ä¸²æ•°å€¼è¦åŒºåˆ†ï¼Œç±»å‹è½¬æ¢å¾ˆé‡è¦
- å¤æ‚é€»è¾‘å¤šåˆ†è¡Œï¼Œæ‹¬å·ä¼˜å…ˆçº§è¦æ¸…æ¥š
- å˜é‡å­˜åœ¨è¦æ£€æŸ¥ï¼Œdefaulté»˜è®¤å€¼é˜²é”™

**æ ¸å¿ƒä»·å€¼**ï¼šæŒæ¡whenæ¡ä»¶åˆ¤æ–­ï¼Œå°±æŒæ¡äº†Ansibleè‡ªåŠ¨åŒ–çš„æ§åˆ¶é€»è¾‘ï¼Œèƒ½å¤Ÿå®ç°å¤æ‚åœºæ™¯ä¸‹çš„ç²¾ç¡®ä»»åŠ¡æ‰§è¡Œï¼Œè¿™æ˜¯ä»åŸºç¡€ä½¿ç”¨è¿ˆå‘é«˜çº§åº”ç”¨çš„å…³é”®æŠ€èƒ½ã€‚