---
title: 2ã€å¾ªç¯ç»“æ„loop
---
## ğŸ“š ç›®å½•

1. [å¾ªç¯ç»“æ„åŸºç¡€æ¦‚å¿µ](#1-å¾ªç¯ç»“æ„åŸºç¡€æ¦‚å¿µ)
2. [loopåŸºç¡€è¯­æ³•ä¸åº”ç”¨](#2-loopåŸºç¡€è¯­æ³•ä¸åº”ç”¨)
3. [ä¸åŒç±»å‹çš„å¾ªç¯æ“ä½œ](#3-ä¸åŒç±»å‹çš„å¾ªç¯æ“ä½œ)
4. [å¾ªç¯æ§åˆ¶ä¸ä¼˜åŒ–](#4-å¾ªç¯æ§åˆ¶ä¸ä¼˜åŒ–)
5. [é«˜çº§å¾ªç¯æŠ€å·§](#5-é«˜çº§å¾ªç¯æŠ€å·§)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”„ å¾ªç¯ç»“æ„åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Ansibleå¾ªç¯


> ğŸ“– **æ ¸å¿ƒæ¦‚å¿µ**  
> Ansibleå¾ªç¯å°±åƒç”Ÿæ´»ä¸­çš„"é‡å¤åšæŸä»¶äº‹"ï¼Œæ¯”å¦‚ç»™ç­ä¸Šæ¯ä¸ªå­¦ç”Ÿå‘ä½œä¸šæœ¬ï¼Œä½ ä¸éœ€è¦å†™30éå‘ä½œä¸šçš„æ­¥éª¤ï¼Œåªéœ€è¦å†™ä¸€æ¬¡ï¼Œç„¶åå‘Šè¯‰Ansibleå¯¹æ¯ä¸ªå­¦ç”Ÿéƒ½æ‰§è¡Œè¿™ä¸ªåŠ¨ä½œã€‚

**å¾ªç¯çš„æœ¬è´¨ä½œç”¨**ï¼š
- **å‡å°‘é‡å¤ä»£ç **ï¼šä¸€ä¸ªä»»åŠ¡å¤„ç†å¤šä¸ªç›®æ ‡
- **æ‰¹é‡æ“ä½œ**ï¼šåŒæ—¶ç®¡ç†å¤šä¸ªæ–‡ä»¶ã€ç”¨æˆ·ã€æœåŠ¡
- **åŠ¨æ€å¤„ç†**ï¼šæ ¹æ®å˜é‡åˆ—è¡¨çµæ´»æ‰§è¡Œ

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦å¾ªç¯


```
âŒ æ²¡æœ‰å¾ªç¯çš„å†™æ³•ï¼ˆç¹çï¼‰ï¼š
- name: åˆ›å»ºç”¨æˆ·alice
  user: name=alice
- name: åˆ›å»ºç”¨æˆ·bob  
  user: name=bob
- name: åˆ›å»ºç”¨æˆ·charlie
  user: name=charlie

âœ… ä½¿ç”¨å¾ªç¯çš„å†™æ³•ï¼ˆä¼˜é›…ï¼‰ï¼š
- name: æ‰¹é‡åˆ›å»ºç”¨æˆ·
  user: name={{ item }}
  loop:
    - alice
    - bob  
    - charlie
```

### 1.3 Ansibleå¾ªç¯çš„æ¼”è¿›å†å²


**å‘å±•è½¨è¿¹**ï¼š
```
æ—©æœŸç‰ˆæœ¬ â†’ with_itemsï¼ˆä¼ ç»Ÿæ–¹å¼ï¼‰
å½“å‰ç‰ˆæœ¬ â†’ loopï¼ˆæ¨èæ–¹å¼ï¼‰
æœªæ¥æ–¹å‘ â†’ loop + æ›´å¤šæ§åˆ¶é€‰é¡¹
```

> ğŸ’¡ **å­¦ä¹ å»ºè®®**  
> è™½ç„¶`with_items`ä»ç„¶å¯ç”¨ï¼Œä½†æ–°é¡¹ç›®å»ºè®®ä½¿ç”¨`loop`ï¼Œè¯­æ³•æ›´æ¸…æ™°ï¼ŒåŠŸèƒ½æ›´å¼ºå¤§ã€‚

---

## 2. ğŸ¯ loopåŸºç¡€è¯­æ³•ä¸åº”ç”¨


### 2.1 æœ€ç®€å•çš„åˆ—è¡¨å¾ªç¯


**åŸºç¡€è¯­æ³•ç»“æ„**ï¼š
```yaml
- name: ä»»åŠ¡æè¿°
  æ¨¡å—å:
    å‚æ•°: "{{ item }}"
  loop:
    - å€¼1
    - å€¼2
    - å€¼3
```

**å®é™…åº”ç”¨ç¤ºä¾‹**ï¼š
```yaml
- name: å®‰è£…å¤šä¸ªè½¯ä»¶åŒ…
  package:
    name: "{{ item }}"
    state: present
  loop:
    - vim
    - git
    - curl
    - wget
```

> ğŸ§  **ç†è§£è¦ç‚¹**  
> `{{ item }}`æ˜¯å¾ªç¯å˜é‡ï¼Œæ¯æ¬¡å¾ªç¯éƒ½ä¼šè‡ªåŠ¨æ›¿æ¢ä¸ºå½“å‰çš„åˆ—è¡¨å€¼ã€‚å°±åƒå˜é­”æœ¯çš„å¸½å­ï¼Œæ¯æ¬¡æå‡ºä¸åŒçš„å…”å­ã€‚

### 2.2 å˜é‡å¼•ç”¨å¾ªç¯


**ä½¿ç”¨é¢„å®šä¹‰å˜é‡**ï¼š
```yaml
vars:
  packages:
    - nginx
    - mysql-server
    - php-fpm

tasks:
  - name: æ‰¹é‡å®‰è£…WebæœåŠ¡å™¨ç»„ä»¶
    package:
      name: "{{ item }}"
      state: present
    loop: "{{ packages }}"
```

**åŠ¨æ€å˜é‡å¾ªç¯**ï¼š
```yaml
- name: ä¸ºä¸åŒç¯å¢ƒåˆ›å»ºç›®å½•
  file:
    path: "/opt/{{ item }}"
    state: directory
    mode: '0755'
  loop: "{{ environments | default(['dev', 'test', 'prod']) }}"
```

### 2.3 å¾ªç¯å˜é‡çš„æ·±å…¥ç†è§£


**å¾ªç¯å˜é‡çš„ä½œç”¨åŸŸ**ï¼š
```
å•ä¸ªä»»åŠ¡å†… â”€â”€ itemå˜é‡æœ‰æ•ˆ
ä»»åŠ¡ç»“æŸå â”€â”€ itemå˜é‡å¤±æ•ˆ
ä¸‹ä¸ªä»»åŠ¡ä¸­ â”€â”€ å¯ä»¥é‡æ–°ä½¿ç”¨item
```

**å¾ªç¯å˜é‡çš„æ•°æ®æµ**ï¼š
```
åˆ—è¡¨æ•°æ® â¡ï¸ å¾ªç¯æœºåˆ¶ â¡ï¸ itemå˜é‡ â¡ï¸ æ¨¡å—æ‰§è¡Œ
```

---

## 3. ğŸ”¢ ä¸åŒç±»å‹çš„å¾ªç¯æ“ä½œ


### 3.1 æ•°å€¼èŒƒå›´å¾ªç¯


**è¿ç»­æ•°å­—å¾ªç¯**ï¼š
```yaml
- name: åˆ›å»ºç¼–å·ç›®å½•
  file:
    path: "/tmp/dir{{ item }}"
    state: directory
  loop: "{{ range(1, 6) | list }}"
  # ç­‰æ•ˆäº: loop: [1, 2, 3, 4, 5]
```

**å¸¦æ­¥é•¿çš„æ•°å­—å¾ªç¯**ï¼š
```yaml
- name: åˆ›å»ºå¶æ•°ç¼–å·çš„ç”¨æˆ·
  user:
    name: "user{{ item }}"
    state: present
  loop: "{{ range(2, 11, 2) | list }}"
  # ç­‰æ•ˆäº: [2, 4, 6, 8, 10]
```

> ğŸ’¡ **è®°å¿†æŠ€å·§**  
> `range(å¼€å§‹, ç»“æŸ, æ­¥é•¿)`å°±åƒæ¥¼æ¢¯ï¼Œä»å“ªå±‚å¼€å§‹ï¼Œåˆ°å“ªå±‚ç»“æŸï¼Œæ¯æ¬¡è·¨å‡ å±‚å°é˜¶ã€‚

### 3.2 å­—å…¸å¾ªç¯


**ç®€å•é”®å€¼å¯¹å¾ªç¯**ï¼š
```yaml
- name: è®¾ç½®å¤šä¸ªç¯å¢ƒå˜é‡
  lineinfile:
    path: /etc/environment
    line: "{{ item.key }}={{ item.value }}"
  loop:
    - key: "JAVA_HOME"
      value: "/usr/lib/jvm/java-8"
    - key: "MYSQL_HOST" 
      value: "192.168.1.100"
    - key: "REDIS_PORT"
      value: "6379"
```

**å¤æ‚å­—å…¸ç»“æ„å¾ªç¯**ï¼š
```yaml
vars:
  databases:
    - name: webapp_db
      user: webapp_user
      password: secure123
      encoding: utf8
    - name: blog_db  
      user: blog_user
      password: secret456
      encoding: utf8mb4

tasks:
  - name: åˆ›å»ºæ•°æ®åº“
    mysql_db:
      name: "{{ item.name }}"
      encoding: "{{ item.encoding }}"
      state: present
    loop: "{{ databases }}"
  
  - name: åˆ›å»ºæ•°æ®åº“ç”¨æˆ·
    mysql_user:
      name: "{{ item.user }}"
      password: "{{ item.password }}"
      priv: "{{ item.name }}.*:ALL"
    loop: "{{ databases }}"
```

### 3.3 æ–‡ä»¶å’Œç›®å½•å¾ªç¯


**éå†æ–‡ä»¶åˆ—è¡¨**ï¼š
```yaml
- name: æŸ¥æ‰¾æ—¥å¿—æ–‡ä»¶
  find:
    paths: /var/log
    patterns: "*.log"
  register: log_files

- name: å¤‡ä»½æ‰€æœ‰æ—¥å¿—æ–‡ä»¶
  copy:
    src: "{{ item.path }}"
    dest: "/backup/{{ item.path | basename }}"
    remote_src: true
  loop: "{{ log_files.files }}"
```

**ç›®å½•ç»“æ„åˆ›å»º**ï¼š
```yaml
- name: åˆ›å»ºé¡¹ç›®ç›®å½•ç»“æ„
  file:
    path: "/opt/myapp/{{ item }}"
    state: directory
    owner: appuser
    group: appuser
    mode: '0755'
  loop:
    - bin
    - config
    - logs
    - data
    - tmp
```

### 3.4 with_itemsä¼ ç»Ÿæ–¹å¼


> âš ï¸ **æ³¨æ„**ï¼šè™½ç„¶`with_items`ä»ç„¶å¯ç”¨ï¼Œä½†å»ºè®®ä½¿ç”¨`loop`

**with_itemsåŸºæœ¬ç”¨æ³•**ï¼š
```yaml
# ä¼ ç»Ÿæ–¹å¼ï¼ˆä¸æ¨èï¼‰
- name: å®‰è£…è½¯ä»¶åŒ…
  package:
    name: "{{ item }}"
  with_items:
    - vim
    - git
    - curl

# ç°ä»£æ–¹å¼ï¼ˆæ¨èï¼‰  
- name: å®‰è£…è½¯ä»¶åŒ…
  package:
    name: "{{ item }}"
  loop:
    - vim
    - git  
    - curl
```

**è¿ç§»å¯¹æ¯”**ï¼š

| ä¼ ç»Ÿè¯­æ³• | ç°ä»£è¯­æ³• | è¯´æ˜ |
|---------|---------|------|
| `with_items` | `loop` | åŸºæœ¬åˆ—è¡¨å¾ªç¯ |
| `with_dict` | `loop: "{{ dict\|dict2items }}"` | å­—å…¸å¾ªç¯ |
| `with_sequence` | `loop: "{{ range()\|list }}"` | æ•°å€¼åºåˆ— |
| `with_fileglob` | `loop: "{{ query('fileglob', pattern) }}"` | æ–‡ä»¶åŒ¹é… |

---

## 4. âš™ï¸ å¾ªç¯æ§åˆ¶ä¸ä¼˜åŒ–


### 4.1 loop_controlè¯¦è§£


**åŸºæœ¬æ§åˆ¶å‚æ•°**ï¼š
```yaml
- name: åˆ›å»ºç”¨æˆ·æ—¶æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
  user:
    name: "{{ item }}"
    state: present
  loop:
    - alice
    - bob
    - charlie
  loop_control:
    index_var: user_index      # ç´¢å¼•å˜é‡
    loop_var: current_user     # è‡ªå®šä¹‰å¾ªç¯å˜é‡å
    label: "åˆ›å»ºç”¨æˆ·{{ item }}" # æ˜¾ç¤ºæ ‡ç­¾
    pause: 2                   # æ¯æ¬¡å¾ªç¯é—´æš‚åœ2ç§’
```

**æ§åˆ¶å‚æ•°è¯´æ˜**ï¼š

| å‚æ•° | ä½œç”¨ | ç¤ºä¾‹ç”¨é€” |
|-----|-----|----------|
| `index_var` | æä¾›ç´¢å¼•ç¼–å· | åˆ›å»ºç¼–å·æ–‡ä»¶ã€æ•°ç»„æ“ä½œ |
| `loop_var` | è‡ªå®šä¹‰å˜é‡å | é¿å…åµŒå¥—å¾ªç¯å†²çª |
| `label` | è‡ªå®šä¹‰æ˜¾ç¤ºä¿¡æ¯ | ç¾åŒ–è¾“å‡ºï¼Œä¾¿äºè°ƒè¯• |
| `pause` | å¾ªç¯é—´æš‚åœ | é¿å…ç³»ç»Ÿè´Ÿè½½è¿‡é«˜ |

### 4.2 åµŒå¥—å¾ªç¯å¤„ç†


**é¿å…å˜é‡å†²çªçš„åµŒå¥—å¾ªç¯**ï¼š
```yaml
- name: ä¸ºæ¯ä¸ªç”¨æˆ·åœ¨æ¯ä¸ªé¡¹ç›®ä¸­åˆ›å»ºç›®å½•
  file:
    path: "/projects/{{ outer_item }}/users/{{ inner_item }}"
    state: directory
  loop: "{{ users }}"
  loop_control:
    loop_var: inner_item
  vars:
    users: ["alice", "bob", "charlie"]
  with_items: "{{ projects }}"
  loop_control:
    loop_var: outer_item
  vars:
    projects: ["web", "mobile", "api"]
```

> ğŸ’¡ **æœ€ä½³å®è·µ**  
> åµŒå¥—å¾ªç¯æ—¶å¿…é¡»ä½¿ç”¨ä¸åŒçš„`loop_var`åç§°ï¼Œé¿å…å†…å¤–å¾ªç¯å˜é‡å†²çªã€‚

### 4.3 æ¡ä»¶å¾ªç¯


**ç»“åˆwhenä½¿ç”¨**ï¼š
```yaml
- name: åªåœ¨ç‰¹å®šæœåŠ¡å™¨ä¸Šå®‰è£…è½¯ä»¶
  package:
    name: "{{ item }}"
    state: present
  loop:
    - nginx
    - mysql-server
    - redis
  when: 
    - inventory_hostname in groups['webservers']
    - item != 'mysql-server' or 'database' in group_names
```

**åŠ¨æ€æ¡ä»¶åˆ¤æ–­**ï¼š
```yaml
vars:
  services:
    - name: nginx
      required: true
      environments: [prod, test]
    - name: redis  
      required: false
      environments: [prod]
    - name: memcached
      required: true
      environments: [test, dev]

tasks:
  - name: æ ¹æ®ç¯å¢ƒå®‰è£…æœåŠ¡
    service:
      name: "{{ item.name }}"
      state: started
      enabled: yes
    loop: "{{ services }}"
    when: 
      - item.required or force_install | default(false)
      - current_env in item.environments
```

---

## 5. ğŸš€ é«˜çº§å¾ªç¯æŠ€å·§


### 5.1 å¾ªç¯ç»“æœæ³¨å†Œä¸å¤„ç†


**æ³¨å†Œå¾ªç¯ç»“æœ**ï¼š
```yaml
- name: æ£€æŸ¥å¤šä¸ªæœåŠ¡çŠ¶æ€
  systemd:
    name: "{{ item }}"
  register: service_status
  loop:
    - nginx
    - mysql
    - redis
  failed_when: false

- name: æ˜¾ç¤ºæœåŠ¡çŠ¶æ€æ±‡æ€»
  debug:
    msg: |
      æœåŠ¡: {{ item.item }}
      çŠ¶æ€: {{ 'running' if item.changed else 'stopped' }}
      ç»“æœ: {{ item.rc | default(0) }}
  loop: "{{ service_status.results }}"
  loop_control:
    label: "{{ item.item }}"
```

**ç»“æœæ•°æ®ç»“æ„**ï¼š
```
service_status:
  results:
    - item: "nginx"      # åŸå§‹å¾ªç¯é¡¹
      changed: true      # æ˜¯å¦å‘ç”Ÿå˜æ›´  
      rc: 0             # è¿”å›ç 
      stdout: "..."     # æ ‡å‡†è¾“å‡º
    - item: "mysql"
      changed: false
      rc: 0
```

### 5.2 å¾ªç¯æ€§èƒ½ä¼˜åŒ–


**æ‰¹é‡æ“ä½œä¼˜åŒ–**ï¼š
```yaml
# âŒ ä½æ•ˆæ–¹å¼ï¼šé€ä¸ªå®‰è£…
- name: å®‰è£…è½¯ä»¶åŒ…
  package:
    name: "{{ item }}"
    state: present
  loop:
    - vim
    - git
    - curl
    - wget

# âœ… é«˜æ•ˆæ–¹å¼ï¼šæ‰¹é‡å®‰è£…
- name: æ‰¹é‡å®‰è£…è½¯ä»¶åŒ…
  package:
    name:
      - vim
      - git  
      - curl
      - wget
    state: present
```

**å¼‚æ­¥æ‰§è¡Œä¼˜åŒ–**ï¼š
```yaml
- name: å¼‚æ­¥æ‰§è¡Œè€—æ—¶ä»»åŠ¡
  command: "/scripts/long_task.sh {{ item }}"
  async: 300          # æœ€å¤§æ‰§è¡Œæ—¶é—´5åˆ†é’Ÿ
  poll: 0             # ä¸ç­‰å¾…å®Œæˆ
  register: async_jobs
  loop: "{{ large_dataset }}"

- name: ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
  async_status:
    jid: "{{ item.ansible_job_id }}"
  register: job_result
  until: job_result.finished
  retries: 30
  delay: 10
  loop: "{{ async_jobs.results }}"
```

### 5.3 å¤æ‚æ•°æ®ç»“æ„å¾ªç¯


**å¤šç»´æ•°ç»„å¤„ç†**ï¼š
```yaml
vars:
  server_configs:
    webservers:
      - host: web1.example.com
        port: 80
        ssl: false
      - host: web2.example.com  
        port: 443
        ssl: true
    databases:
      - host: db1.example.com
        port: 3306
        type: mysql
      - host: db2.example.com
        port: 5432  
        type: postgresql

tasks:
  - name: é…ç½®æ‰€æœ‰æœåŠ¡å™¨
    template:
      src: "{{ item.1.type | default('generic') }}.conf.j2"
      dest: "/etc/{{ item.0 }}/{{ item.1.host }}.conf"
    loop: "{{ server_configs | dict2items | subelements('value') }}"
    loop_control:
      label: "{{ item.0 }}: {{ item.1.host }}"
```

**JSON/YAMLæ•°æ®å¤„ç†**ï¼š
```yaml
- name: è¯»å–é…ç½®æ–‡ä»¶å¹¶å¾ªç¯å¤„ç†
  include_vars: "{{ item }}"
  loop:
    - configs/database.yml
    - configs/redis.yml
    - configs/elasticsearch.yml
  register: config_data

- name: åº”ç”¨æ‰€æœ‰é…ç½®
  template:
    src: "app.conf.j2"
    dest: "/etc/app/{{ item.key }}.conf"
  loop: "{{ config_data.results | map(attribute='ansible_facts') | list }}"
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å¾ªç¯æœ¬è´¨ï¼šå‡å°‘é‡å¤ä»£ç ï¼Œæ‰¹é‡å¤„ç†å¤šä¸ªç›®æ ‡
ğŸ”¸ åŸºç¡€è¯­æ³•ï¼šloop + {{ item }}ï¼Œç®€å•ç›´è§‚
ğŸ”¸ æ•°æ®ç±»å‹ï¼šåˆ—è¡¨ã€å­—å…¸ã€æ•°å€¼èŒƒå›´ã€æ–‡ä»¶åˆ—è¡¨
ğŸ”¸ æ§åˆ¶æœºåˆ¶ï¼šloop_controlæä¾›ä¸°å¯Œçš„æ§åˆ¶é€‰é¡¹
ğŸ”¸ æ€§èƒ½ä¼˜åŒ–ï¼šåˆç†é€‰æ‹©å¾ªç¯æ–¹å¼ï¼Œé¿å…ä¸å¿…è¦çš„é‡å¤
```

### 6.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ loop vs with_itemsçš„é€‰æ‹©**
```
æ¨èä½¿ç”¨ï¼šloopï¼ˆç°ä»£è¯­æ³•ï¼‰
- è¯­æ³•ç»Ÿä¸€ï¼ŒåŠŸèƒ½å¼ºå¤§
- æ›´å¥½çš„å¯è¯»æ€§å’Œç»´æŠ¤æ€§
- æ›´ä¸°å¯Œçš„æ§åˆ¶é€‰é¡¹

å…¼å®¹ä¿ç•™ï¼šwith_itemsï¼ˆä¼ ç»Ÿè¯­æ³•ï¼‰
- æ—§ä»£ç ä¸­ä»ç„¶å¯è§
- åŸºæœ¬åŠŸèƒ½ç›¸åŒ
- é€æ¸è¢«loopå–ä»£
```

**ğŸ”¹ å¾ªç¯å˜é‡çš„ä½œç”¨æœºåˆ¶**
```
å¾ªç¯æ‰§è¡Œæµç¨‹ï¼š
1. è¯»å–åˆ—è¡¨æ•°æ®
2. é€ä¸ªèµ‹å€¼ç»™itemå˜é‡  
3. æ‰§è¡Œä»»åŠ¡æ¨¡å—
4. é‡å¤ç›´åˆ°åˆ—è¡¨ç»“æŸ

å˜é‡ä½œç”¨åŸŸï¼š
- ä»…åœ¨å½“å‰ä»»åŠ¡å†…æœ‰æ•ˆ
- æ¯æ¬¡å¾ªç¯è‡ªåŠ¨æ›´æ–°å€¼
- å¯é€šè¿‡loop_controlè‡ªå®šä¹‰
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–çš„æ€è€ƒæ–¹å¼**
```
ä¼˜åŒ–åŸåˆ™ï¼š
- èƒ½æ‰¹é‡å°±ä¸é€ä¸ª
- èƒ½å¹¶è¡Œå°±ä¸ä¸²è¡Œ  
- èƒ½ç¼“å­˜å°±ä¸é‡å¤
- èƒ½å¼‚æ­¥å°±ä¸åŒæ­¥

å®é™…åº”ç”¨ï¼š
- è½¯ä»¶åŒ…ç®¡ç†ï¼šä½¿ç”¨åˆ—è¡¨è€Œéå¾ªç¯
- è€—æ—¶ä»»åŠ¡ï¼šè€ƒè™‘asyncå¼‚æ­¥æ‰§è¡Œ
- å¤§æ•°æ®é‡ï¼šåˆ†æ‰¹å¤„ç†ï¼Œæ§åˆ¶å¹¶å‘
```

### 6.3 å®é™…åº”ç”¨åœºæ™¯


**ğŸ¯ æ—¥å¸¸è¿ç»´åœºæ™¯**
- **æ‰¹é‡ç”¨æˆ·ç®¡ç†**ï¼šåˆ›å»ºã€åˆ é™¤ã€æƒé™è®¾ç½®
- **è½¯ä»¶åŒ…ç®¡ç†**ï¼šå®‰è£…ã€æ›´æ–°ã€é…ç½®å¤šä¸ªè½¯ä»¶
- **æ–‡ä»¶æ“ä½œ**ï¼šå¤‡ä»½ã€åŒæ­¥ã€æƒé™ä¿®æ”¹
- **æœåŠ¡ç®¡ç†**ï¼šå¯åŠ¨ã€åœæ­¢ã€é‡å¯å¤šä¸ªæœåŠ¡

**ğŸ¯ é…ç½®ç®¡ç†åœºæ™¯**  
- **ç¯å¢ƒé…ç½®**ï¼šå¤šç¯å¢ƒé…ç½®æ–‡ä»¶ç”Ÿæˆ
- **æ•°æ®åº“ç®¡ç†**ï¼šå¤šæ•°æ®åº“åˆ›å»ºå’Œç”¨æˆ·æˆæƒ
- **ç›‘æ§éƒ¨ç½²**ï¼šæ‰¹é‡éƒ¨ç½²ç›‘æ§agent
- **è¯ä¹¦ç®¡ç†**ï¼šSSLè¯ä¹¦æ‰¹é‡æ›´æ–°

### 6.4 æœ€ä½³å®è·µå»ºè®®


**ğŸ“‹ ç¼–å†™è§„èŒƒ**
```
âœ… ä½¿ç”¨æè¿°æ€§çš„ä»»åŠ¡åç§°
âœ… åˆç†ä½¿ç”¨loop_controlæ ‡ç­¾
âœ… å¤æ‚å¾ªç¯æ·»åŠ æ³¨é‡Šè¯´æ˜
âœ… éªŒè¯æ•°æ®æ ¼å¼å’Œç±»å‹
âœ… å¤„ç†å¯èƒ½çš„å¼‚å¸¸æƒ…å†µ
```

**ğŸ”§ è°ƒè¯•æŠ€å·§**
```
1. ä½¿ç”¨debugæ¨¡å—è¾“å‡ºå¾ªç¯å˜é‡å€¼
2. åˆ©ç”¨loop_controlçš„labelç¾åŒ–è¾“å‡º
3. å…ˆå°èŒƒå›´æµ‹è¯•å†æ‰¹é‡æ‰§è¡Œ
4. æŸ¥çœ‹ansibleè¯¦ç»†è¾“å‡º(-vvv)
5. æ³¨å†Œç»“æœå˜é‡ä¾¿äºæ’æŸ¥é—®é¢˜
```

**âš¡ æ€§èƒ½è€ƒè™‘**
```
1. è¯„ä¼°ä»»åŠ¡æ˜¯å¦çœŸæ­£éœ€è¦å¾ªç¯
2. è€ƒè™‘ä½¿ç”¨æ¨¡å—çš„æ‰¹é‡åŠŸèƒ½
3. å¤§æ•°æ®é‡æ—¶åˆ†æ‰¹å¤„ç†
4. è€—æ—¶ä»»åŠ¡ä½¿ç”¨å¼‚æ­¥æ‰§è¡Œ
5. é¿å…ä¸å¿…è¦çš„åµŒå¥—å¾ªç¯
```

### 6.5 å­¦ä¹ è¿›é˜¶è·¯å¾„


```
ğŸŸ¢ **å…¥é—¨é˜¶æ®µ**ï¼šæŒæ¡åŸºæœ¬loopè¯­æ³•ï¼Œç†è§£itemå˜é‡
ğŸŸ¡ **è¿›é˜¶é˜¶æ®µ**ï¼šå­¦ä¼šå­—å…¸å¾ªç¯ã€æ¡ä»¶å¾ªç¯ã€loop_control
ğŸ”´ **é«˜çº§é˜¶æ®µ**ï¼šæŒæ¡åµŒå¥—å¾ªç¯ã€å¼‚æ­¥å¤„ç†ã€æ€§èƒ½ä¼˜åŒ–
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- å¾ªç¯å‡é‡å¤ï¼Œæ‰¹é‡æ•ˆç‡é«˜
- loopé…itemï¼Œæ•°æ®è‡ªåŠ¨è·‘  
- å­—å…¸ç”¨é”®å€¼ï¼Œåˆ—è¡¨ç”¨ç´¢å¼•
- æ§åˆ¶é å‚æ•°ï¼Œä¼˜åŒ–çœ‹åœºæ™¯

**ğŸ”— æ‰©å±•å­¦ä¹ **ï¼š
- æ¡ä»¶åˆ¤æ–­(when)ä¸å¾ªç¯ç»“åˆ
- å˜é‡æ³¨å†Œ(register)åœ¨å¾ªç¯ä¸­çš„åº”ç”¨  
- Jinja2æ¨¡æ¿åœ¨å¾ªç¯ä¸­çš„é«˜çº§ç”¨æ³•
- å¼‚æ­¥æ‰§è¡Œå’Œå¹¶å‘æ§åˆ¶è¿›é˜¶æŠ€å·§