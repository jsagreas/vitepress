---
title: 3ã€facts-ç³»ç»Ÿä¿¡æ¯
---
## ğŸ“š ç›®å½•

1. [Factsç³»ç»ŸåŸºç¡€æ¦‚å¿µ](#1-Factsç³»ç»ŸåŸºç¡€æ¦‚å¿µ)
2. [setupæ¨¡å—è¯¦è§£](#2-setupæ¨¡å—è¯¦è§£)
3. [ç³»ç»Ÿä¿¡æ¯ç±»åˆ«è¯¦è§£](#3-ç³»ç»Ÿä¿¡æ¯ç±»åˆ«è¯¦è§£)
4. [Factså˜é‡ä½¿ç”¨æ–¹æ³•](#4-Factså˜é‡ä½¿ç”¨æ–¹æ³•)
5. [è‡ªå®šä¹‰Factsæœºåˆ¶](#5-è‡ªå®šä¹‰Factsæœºåˆ¶)
6. [Factsç¼“å­˜ä¸æ€§èƒ½ä¼˜åŒ–](#6-Factsç¼“å­˜ä¸æ€§èƒ½ä¼˜åŒ–)
7. [å®æˆ˜åº”ç”¨åœºæ™¯](#7-å®æˆ˜åº”ç”¨åœºæ™¯)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ Factsç³»ç»ŸåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Ansible Facts


**Factsçš„æœ¬è´¨**ï¼šFactså°±æ˜¯Ansibleè‡ªåŠ¨æ”¶é›†çš„ç›®æ ‡ä¸»æœºä¿¡æ¯ï¼Œå¯ä»¥ç†è§£ä¸º"ä¸»æœºæ¡£æ¡ˆå¡"

```
ç®€å•ç±»æ¯”ï¼š
å°±åƒåŒ»ç”Ÿç»™ç—…äººçœ‹ç—…å‰è¦å…ˆäº†è§£ç—…äººçš„åŸºæœ¬æƒ…å†µä¸€æ ·
- å¹´é¾„ã€æ€§åˆ«ã€èº«é«˜ä½“é‡ï¼ˆåŸºç¡€ä¿¡æ¯ï¼‰
- è¡€å‹ã€å¿ƒç‡ã€ä½“æ¸©ï¼ˆçŠ¶æ€ä¿¡æ¯ï¼‰  
- æ—¢å¾€ç—…å²ã€è¿‡æ•å²ï¼ˆå†å²ä¿¡æ¯ï¼‰

Ansibleä¹Ÿéœ€è¦å…ˆäº†è§£ç›®æ ‡ä¸»æœºçš„æƒ…å†µï¼š
- æ“ä½œç³»ç»Ÿã€CPUã€å†…å­˜ï¼ˆç¡¬ä»¶ä¿¡æ¯ï¼‰
- IPåœ°å€ã€ç½‘å¡ã€ç£ç›˜ï¼ˆé…ç½®ä¿¡æ¯ï¼‰
- å·²å®‰è£…è½¯ä»¶ã€æœåŠ¡çŠ¶æ€ï¼ˆè½¯ä»¶ä¿¡æ¯ï¼‰
```

**Factsçš„æ ¸å¿ƒä½œç”¨**ï¼š
- **ğŸ“Š ä¿¡æ¯æ”¶é›†**ï¼šè‡ªåŠ¨è·å–ä¸»æœºçš„è¯¦ç»†ä¿¡æ¯
- **ğŸ¯ æ¡ä»¶åˆ¤æ–­**ï¼šæ ¹æ®ä¸åŒç³»ç»Ÿæ‰§è¡Œä¸åŒæ“ä½œ
- **ğŸ“ æ¨¡æ¿æ¸²æŸ“**ï¼šåœ¨é…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨ä¸»æœºä¿¡æ¯
- **ğŸ”„ åŠ¨æ€é…ç½®**ï¼šæ ¹æ®ä¸»æœºç‰¹æ€§åŠ¨æ€è°ƒæ•´é…ç½®

### 1.2 Factsçš„å·¥ä½œæµç¨‹


**è‡ªåŠ¨æ”¶é›†æµç¨‹**ï¼š
```
Ansibleæ‰§è¡Œæµç¨‹ï¼š
æ­¥éª¤1ï¸âƒ£ è¿æ¥ç›®æ ‡ä¸»æœº
æ­¥éª¤2ï¸âƒ£ è‡ªåŠ¨æ‰§è¡Œsetupæ¨¡å—æ”¶é›†Facts
æ­¥éª¤3ï¸âƒ£ å°†Factsä¿¡æ¯å­˜å‚¨ä¸ºansible_factså˜é‡
æ­¥éª¤4ï¸âƒ£ åœ¨åç»­ä»»åŠ¡ä¸­å¯ä»¥ä½¿ç”¨è¿™äº›å˜é‡
æ­¥éª¤5ï¸âƒ£ ä»»åŠ¡æ‰§è¡Œå®ŒæˆåFactsä¿¡æ¯å¤±æ•ˆ
```

**Factsæ”¶é›†ç¤ºæ„å›¾**ï¼š
```
Ansibleæ§åˆ¶ç«¯                     ç›®æ ‡ä¸»æœº
     â”‚                              â”‚
     â”œâ”€[1]å»ºç«‹SSHè¿æ¥â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”‚
     â”‚                              â”‚
     â”œâ”€[2]æ‰§è¡Œsetupæ¨¡å—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’   â”‚æ”¶é›†ç³»ç»Ÿä¿¡æ¯
     â”‚                              â”‚- ç¡¬ä»¶ä¿¡æ¯
     â”‚                              â”‚- ç³»ç»Ÿä¿¡æ¯  
     â”‚                              â”‚- ç½‘ç»œä¿¡æ¯
     â”‚                              â”‚- è½¯ä»¶ä¿¡æ¯
     â”‚                              â”‚
     â”œâ”€[3]è¿”å›Factsæ•°æ®â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                              â”‚
     â”œâ”€[4]å­˜å‚¨ä¸ºansible_factså˜é‡    â”‚
     â”‚                              â”‚
     â””â”€[5]æ‰§è¡Œåç»­ä»»åŠ¡ï¼ˆå¯ä½¿ç”¨Factsï¼‰â”€â†’â”‚
```

### 1.3 Factsä¸å…¶ä»–å˜é‡çš„åŒºåˆ«


**å˜é‡ç±»å‹å¯¹æ¯”**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å˜é‡ç±»å‹   â”‚    æ•°æ®æ¥æº   â”‚   ç”Ÿå‘½å‘¨æœŸ   â”‚   ä½¿ç”¨åœºæ™¯   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Factså˜é‡   â”‚ ç›®æ ‡ä¸»æœºè‡ªåŠ¨  â”‚ å•æ¬¡æ‰§è¡ŒæœŸé—´ â”‚ ç³»ç»Ÿä¿¡æ¯ç›¸å…³ â”‚
â”‚            â”‚ æ”¶é›†çš„ç³»ç»Ÿä¿¡æ¯â”‚              â”‚ æ¡ä»¶åˆ¤æ–­     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä¸»æœºå˜é‡    â”‚ æ¸…å•æ–‡ä»¶æˆ–   â”‚ æŒç»­å­˜åœ¨     â”‚ ä¸»æœºç‰¹å®šé…ç½® â”‚
â”‚            â”‚ host_varsç›®å½•â”‚              â”‚             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç»„å˜é‡      â”‚ æ¸…å•æ–‡ä»¶æˆ–   â”‚ æŒç»­å­˜åœ¨     â”‚ ç»„é€šç”¨é…ç½®   â”‚
â”‚            â”‚ group_varsç›®å½•â”‚              â”‚             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä»»åŠ¡å˜é‡    â”‚ playbookä¸­   â”‚ ä»»åŠ¡æ‰§è¡ŒæœŸé—´ â”‚ ä»»åŠ¡ä¸´æ—¶æ•°æ® â”‚
â”‚            â”‚ æ‰‹åŠ¨å®šä¹‰     â”‚              â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸ”§ setupæ¨¡å—è¯¦è§£


### 2.1 setupæ¨¡å—åŸºç¡€ä½¿ç”¨


**åŸºæœ¬è¯­æ³•**ï¼š
```bash
# æ”¶é›†æ‰€æœ‰Factsä¿¡æ¯
ansible ä¸»æœºå -m setup

# å®é™…ç¤ºä¾‹
ansible web1 -m setup
ansible all -m setup
```

> ğŸ’¡ **é‡è¦è¯´æ˜**ï¼šsetupæ¨¡å—æ˜¯Ansibleçš„å†…ç½®æ¨¡å—ï¼Œä¸“é—¨ç”¨æ¥æ”¶é›†ç›®æ ‡ä¸»æœºçš„ç³»ç»Ÿä¿¡æ¯ï¼Œå®ƒåœ¨æ¯ä¸ªplaybookæ‰§è¡Œå‰éƒ½ä¼šè‡ªåŠ¨è¿è¡Œ

### 2.2 setupæ¨¡å—å¸¸ç”¨å‚æ•°


**å‚æ•°è¯¦è§£**ï¼š

| å‚æ•°å | ä½œç”¨è¯´æ˜ | ä½¿ç”¨ç¤ºä¾‹ | å¤‡æ³¨ |
|--------|----------|----------|------|
| `filter` | **è¿‡æ»¤æŒ‡å®šä¿¡æ¯** | `filter=ansible_eth*` | æ”¯æŒé€šé…ç¬¦ |
| `gather_subset` | **é€‰æ‹©æ”¶é›†ç±»åˆ«** | `gather_subset=network,hardware` | æé«˜æ•ˆç‡ |
| `fact_path` | **è‡ªå®šä¹‰factsè·¯å¾„** | `fact_path=/etc/ansible/facts.d` | è¯»å–è‡ªå®šä¹‰facts |

**è¿‡æ»¤å™¨ä½¿ç”¨ç¤ºä¾‹**ï¼š
```bash
# åªæŸ¥çœ‹ç½‘ç»œæ¥å£ä¿¡æ¯
ansible web1 -m setup -a "filter=ansible_eth*"

# åªæŸ¥çœ‹å†…å­˜ä¿¡æ¯
ansible web1 -m setup -a "filter=ansible_memory*"

# åªæŸ¥çœ‹æ“ä½œç³»ç»Ÿä¿¡æ¯
ansible web1 -m setup -a "filter=ansible_os*"
```

**å­é›†æ”¶é›†ç¤ºä¾‹**ï¼š
```bash
# åªæ”¶é›†ç½‘ç»œå’Œç¡¬ä»¶ä¿¡æ¯ï¼ˆåŠ å¿«æ”¶é›†é€Ÿåº¦ï¼‰
ansible web1 -m setup -a "gather_subset=network,hardware"

# ä¸æ”¶é›†ç½‘ç»œä¿¡æ¯ï¼ˆç”¨!è¡¨ç¤ºæ’é™¤ï¼‰
ansible web1 -m setup -a "gather_subset=!network"

# æ”¶é›†æœ€å°ä¿¡æ¯é›†
ansible web1 -m setup -a "gather_subset=min"
```

### 2.3 å…³é—­è‡ªåŠ¨Factsæ”¶é›†


**ä¸ºä»€ä¹ˆè¦å…³é—­è‡ªåŠ¨æ”¶é›†**ï¼š
- **ğŸš€ æå‡é€Ÿåº¦**ï¼šè·³è¿‡Factsæ”¶é›†ï¼ŒåŠ å¿«playbookæ‰§è¡Œ
- **ğŸ’¾ èŠ‚çœèµ„æº**ï¼šå‡å°‘ç½‘ç»œä¼ è¾“å’Œå†…å­˜å ç”¨
- **ğŸ¯ é’ˆå¯¹æ€§**ï¼šæŸäº›ä»»åŠ¡ä¸éœ€è¦ç³»ç»Ÿä¿¡æ¯

**å…³é—­æ–¹æ³•**ï¼š
```yaml
# æ–¹æ³•1ï¼šåœ¨playçº§åˆ«å…³é—­
- hosts: webservers
  gather_facts: no  # å…³é—­è‡ªåŠ¨æ”¶é›†
  tasks:
    - name: ç®€å•ä»»åŠ¡ï¼Œä¸éœ€è¦ç³»ç»Ÿä¿¡æ¯
      debug:
        msg: "Hello World"
```

```yaml
# æ–¹æ³•2ï¼šæ‰‹åŠ¨æ”¶é›†ç‰¹å®šä¿¡æ¯
- hosts: webservers
  gather_facts: no
  tasks:
    - name: æ‰‹åŠ¨æ”¶é›†ç½‘ç»œä¿¡æ¯
      setup:
        gather_subset: network
      
    - name: ä½¿ç”¨æ”¶é›†çš„ç½‘ç»œä¿¡æ¯
      debug:
        msg: "IPåœ°å€æ˜¯: {{ ansible_default_ipv4.address }}"
```

---

## 3. ğŸ“Š ç³»ç»Ÿä¿¡æ¯ç±»åˆ«è¯¦è§£


### 3.1 åŸºç¡€ç³»ç»Ÿä¿¡æ¯


**æ“ä½œç³»ç»Ÿç›¸å…³Facts**ï¼š

| Factså˜é‡å | å«ä¹‰è¯´æ˜ | ç¤ºä¾‹å€¼ |
|-------------|----------|--------|
| `ansible_distribution` | **æ“ä½œç³»ç»Ÿå‘è¡Œç‰ˆ** | `"CentOS"`, `"Ubuntu"` |
| `ansible_distribution_version` | **ç³»ç»Ÿç‰ˆæœ¬å·** | `"7.9"`, `"20.04"` |
| `ansible_kernel` | **å†…æ ¸ç‰ˆæœ¬** | `"3.10.0-1160.el7.x86_64"` |
| `ansible_architecture` | **ç³»ç»Ÿæ¶æ„** | `"x86_64"`, `"aarch64"` |
| `ansible_os_family` | **æ“ä½œç³»ç»Ÿå®¶æ—** | `"RedHat"`, `"Debian"` |

**å®é™…ä½¿ç”¨ç¤ºä¾‹**ï¼š
```yaml
- name: æ ¹æ®ä¸åŒç³»ç»Ÿå®‰è£…è½¯ä»¶åŒ…
  package:
    name: "{{ 'httpd' if ansible_os_family == 'RedHat' else 'apache2' }}"
    state: present
```

### 3.2 ç¡¬ä»¶ä¿¡æ¯


**CPUå’Œå†…å­˜ä¿¡æ¯**ï¼š

```
CPUç›¸å…³Factsï¼š
â”œâ”€ ansible_processor_count: ç‰©ç†CPUæ•°é‡
â”œâ”€ ansible_processor_cores: æ¯ä¸ªCPUçš„æ ¸å¿ƒæ•°  
â”œâ”€ ansible_processor_vcpus: è™šæ‹ŸCPUæ€»æ•°
â””â”€ ansible_processor[]: CPUå‹å·ä¿¡æ¯æ•°ç»„

å†…å­˜ç›¸å…³Factsï¼š
â”œâ”€ ansible_memtotal_mb: æ€»å†…å­˜(MB)
â”œâ”€ ansible_memfree_mb: ç©ºé—²å†…å­˜(MB)
â”œâ”€ ansible_swaptotal_mb: äº¤æ¢åˆ†åŒºæ€»å¤§å°(MB)
â””â”€ ansible_swapfree_mb: äº¤æ¢åˆ†åŒºç©ºé—²å¤§å°(MB)
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```yaml
- name: æ£€æŸ¥æœåŠ¡å™¨é…ç½®æ˜¯å¦æ»¡è¶³è¦æ±‚
  debug:
    msg: |
      æœåŠ¡å™¨é…ç½®ä¿¡æ¯ï¼š
      - CPUæ ¸å¿ƒæ•°: {{ ansible_processor_vcpus }}
      - å†…å­˜å¤§å°: {{ ansible_memtotal_mb }}MB
      - ç³»ç»Ÿæ¶æ„: {{ ansible_architecture }}
  when: 
    - ansible_processor_vcpus >= 4
    - ansible_memtotal_mb >= 8192
```

### 3.3 ç½‘ç»œæ¥å£ä¿¡æ¯


**ç½‘ç»œFactsç»“æ„**ï¼š
```
ç½‘ç»œä¿¡æ¯å±‚æ¬¡ç»“æ„ï¼š
ansible_interfaces: æ‰€æœ‰ç½‘ç»œæ¥å£åˆ—è¡¨
â”œâ”€ lo (å›ç¯æ¥å£)
â”œâ”€ eth0 (ç¬¬ä¸€å—ç½‘å¡)
â””â”€ eth1 (ç¬¬äºŒå—ç½‘å¡)

æ¯ä¸ªæ¥å£çš„è¯¦ç»†ä¿¡æ¯ï¼š
ansible_eth0:
â”œâ”€ ipv4: IPåœ°å€ç›¸å…³ä¿¡æ¯
â”‚  â”œâ”€ address: IPåœ°å€
â”‚  â”œâ”€ netmask: å­ç½‘æ©ç 
â”‚  â””â”€ network: ç½‘ç»œåœ°å€
â”œâ”€ macaddress: MACåœ°å€
â”œâ”€ mtu: æœ€å¤§ä¼ è¾“å•å…ƒ
â””â”€ type: æ¥å£ç±»å‹
```

**ç½‘ç»œä¿¡æ¯ä½¿ç”¨ç¤ºä¾‹**ï¼š
```yaml
- name: æ˜¾ç¤ºæœåŠ¡å™¨ç½‘ç»œé…ç½®
  debug:
    msg: |
      ç½‘ç»œæ¥å£ä¿¡æ¯ï¼š
      {% for interface in ansible_interfaces %}
      - {{ interface }}: {{ ansible_facts[interface].get('ipv4', {}).get('address', 'No IP') }}
      {% endfor %}
      
      é»˜è®¤ç½‘å…³: {{ ansible_default_ipv4.gateway }}
      DNSæœåŠ¡å™¨: {{ ansible_dns.nameservers }}
```

### 3.4 æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯


**ç£ç›˜å’Œæ–‡ä»¶ç³»ç»ŸFacts**ï¼š

```yaml
# æŸ¥çœ‹æŒ‚è½½ç‚¹ä¿¡æ¯
- debug:
    msg: |
      æ–‡ä»¶ç³»ç»ŸæŒ‚è½½æƒ…å†µï¼š
      {% for mount in ansible_mounts %}
      - æŒ‚è½½ç‚¹: {{ mount.mount }}
        è®¾å¤‡: {{ mount.device }}  
        æ–‡ä»¶ç³»ç»Ÿ: {{ mount.fstype }}
        æ€»å¤§å°: {{ (mount.size_total / 1024 / 1024 / 1024) | round(2) }}GB
        å¯ç”¨ç©ºé—´: {{ (mount.size_available / 1024 / 1024 / 1024) | round(2) }}GB
      {% endfor %}
```

**å­˜å‚¨ç©ºé—´æ£€æŸ¥ç¤ºä¾‹**ï¼š
```yaml
- name: æ£€æŸ¥ç£ç›˜ç©ºé—´æ˜¯å¦å……è¶³
  fail:
    msg: "æ ¹åˆ†åŒºç©ºé—´ä¸è¶³ï¼Œå‰©ä½™: {{ item.size_available // 1024 // 1024 // 1024 }}GB"
  when: 
    - item.mount == "/"
    - item.size_available < 10 * 1024 * 1024 * 1024  # å°äº10GB
  loop: "{{ ansible_mounts }}"
```

---

## 4. ğŸ¯ Factså˜é‡ä½¿ç”¨æ–¹æ³•


### 4.1 åœ¨Playbookä¸­ä½¿ç”¨Facts


**åŸºæœ¬ä½¿ç”¨è¯­æ³•**ï¼š
```yaml
# ç›´æ¥ä½¿ç”¨Factså˜é‡
- name: æ ¹æ®ç³»ç»Ÿç±»å‹æ‰§è¡Œä¸åŒæ“ä½œ
  debug:
    msg: "å½“å‰ç³»ç»Ÿæ˜¯: {{ ansible_distribution }} {{ ansible_distribution_version }}"

# åœ¨whenæ¡ä»¶ä¸­ä½¿ç”¨
- name: åªåœ¨CentOSç³»ç»Ÿæ‰§è¡Œ
  yum:
    name: httpd
    state: present
  when: ansible_distribution == "CentOS"
```

### 4.2 æ¡ä»¶åˆ¤æ–­åº”ç”¨


**å¤šæ¡ä»¶ç»„åˆåˆ¤æ–­**ï¼š
```yaml
- name: å®‰è£…é€‚åˆçš„è½¯ä»¶åŒ…ç®¡ç†å™¨
  package:
    name: "{{ package_name }}"
    state: present
  vars:
    package_name: >-
      {%- if ansible_os_family == "RedHat" -%}
        httpd
      {%- elif ansible_os_family == "Debian" -%}
        apache2
      {%- elif ansible_os_family == "Suse" -%}
        apache2
      {%- else -%}
        httpd
      {%- endif -%}
```

**ç³»ç»Ÿç‰ˆæœ¬åˆ¤æ–­**ï¼š
```yaml
- name: æ ¹æ®Ubuntuç‰ˆæœ¬é€‰æ‹©Pythonç‰ˆæœ¬
  package:
    name: "{{ python_package }}"
    state: present
  vars:
    python_package: >-
      {%- if ansible_distribution == "Ubuntu" -%}
        {%- if ansible_distribution_version is version("20.04", ">=") -%}
          python3.9
        {%- else -%}
          python3.6
        {%- endif -%}
      {%- else -%}
        python3
      {%- endif -%}
  when: ansible_distribution == "Ubuntu"
```

### 4.3 åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨Facts


**Nginxé…ç½®æ–‡ä»¶æ¨¡æ¿ç¤ºä¾‹**ï¼š
```nginx
# templates/nginx.conf.j2
user nginx;
worker_processes {{ ansible_processor_vcpus }};  # æ ¹æ®CPUæ ¸å¿ƒæ•°è®¾ç½®
error_log /var/log/nginx/error.log;
pid /run/nginx.pid;

events {
    worker_connections {{ 1024 * ansible_processor_vcpus }};  # æ ¹æ®CPUè°ƒæ•´è¿æ¥æ•°
}

http {
    # æ ¹æ®å†…å­˜å¤§å°è°ƒæ•´ç¼“å­˜é…ç½®
    {% if ansible_memtotal_mb > 4096 %}
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=cache:100m;
    {% else %}
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=cache:50m;  
    {% endif %}
    
    server {
        listen 80;
        server_name {{ ansible_default_ipv4.address }};  # ä½¿ç”¨ä¸»æœºIP
        
        location / {
            root /var/www/html;
            index index.html;
        }
    }
}
```

---

## 5. ğŸ› ï¸ è‡ªå®šä¹‰Factsæœºåˆ¶


### 5.1 ä»€ä¹ˆæ˜¯è‡ªå®šä¹‰Facts


**è‡ªå®šä¹‰Factsçš„ç”¨é€”**ï¼š
- **ğŸ“‹ åº”ç”¨ä¿¡æ¯**ï¼šè®°å½•åº”ç”¨ç‰ˆæœ¬ã€é…ç½®è·¯å¾„ç­‰
- **ğŸ”§ ä¸šåŠ¡é€»è¾‘**ï¼šå­˜å‚¨ä¸šåŠ¡ç›¸å…³çš„æ ‡è¯†å’Œå‚æ•°  
- **ğŸ“Š ç›‘æ§æ•°æ®**ï¼šæ”¶é›†è‡ªå®šä¹‰çš„ç›‘æ§æŒ‡æ ‡
- **ğŸ¯ ç¯å¢ƒæ ‡è¯†**ï¼šæ ‡è®°ç¯å¢ƒç±»å‹ï¼ˆå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ï¼‰

### 5.2 åˆ›å»ºè‡ªå®šä¹‰Facts


**æ–¹æ³•1ï¼šJSONæ ¼å¼çš„é™æ€Facts**
```bash
# åœ¨ç›®æ ‡ä¸»æœºåˆ›å»ºfactsç›®å½•
mkdir -p /etc/ansible/facts.d

# åˆ›å»ºè‡ªå®šä¹‰factsæ–‡ä»¶ï¼ˆå¿…é¡»ä»¥.factç»“å°¾ï¼‰
cat > /etc/ansible/facts.d/app_info.fact << 'EOF'
{
    "app_name": "web_server",
    "app_version": "2.1.0",
    "environment": "production",
    "deploy_date": "2024-01-15",
    "config_path": "/opt/webapp/config"
}
EOF
```

**æ–¹æ³•2ï¼šå¯æ‰§è¡Œè„šæœ¬çš„åŠ¨æ€Facts**
```bash
# åˆ›å»ºå¯æ‰§è¡Œçš„factsè„šæœ¬
cat > /etc/ansible/facts.d/system_status.fact << 'EOF'
#!/bin/bash
# å¿…é¡»è¾“å‡ºJSONæ ¼å¼

echo "{"
echo "  \"disk_usage\": $(df / | tail -1 | awk '{print $5}' | sed 's/%//'),"
echo "  \"load_average\": \"$(uptime | awk -F'load average:' '{print $2}' | sed 's/^ *//')\","  
echo "  \"running_services\": $(systemctl list-units --type=service --state=running | grep -c '\.service')"
echo "}"
EOF

# ç»™è„šæœ¬æ‰§è¡Œæƒé™
chmod +x /etc/ansible/facts.d/system_status.fact
```

### 5.3 ä½¿ç”¨è‡ªå®šä¹‰Facts


**åœ¨Playbookä¸­ä½¿ç”¨**ï¼š
```yaml
- name: ä½¿ç”¨è‡ªå®šä¹‰Facts
  debug:
    msg: |
      åº”ç”¨ä¿¡æ¯ï¼š
      - åº”ç”¨åç§°: {{ ansible_local.app_info.app_name }}
      - åº”ç”¨ç‰ˆæœ¬: {{ ansible_local.app_info.app_version }}
      - ç¯å¢ƒç±»å‹: {{ ansible_local.app_info.environment }}
      
      ç³»ç»ŸçŠ¶æ€ï¼š
      - ç£ç›˜ä½¿ç”¨ç‡: {{ ansible_local.system_status.disk_usage }}%
      - è¿è¡ŒæœåŠ¡æ•°: {{ ansible_local.system_status.running_services }}
```

> ğŸ“Œ **é‡è¦æé†’**ï¼šè‡ªå®šä¹‰Factsé€šè¿‡`ansible_local`è®¿é—®ï¼Œæ ¼å¼ä¸º`ansible_local.æ–‡ä»¶å.é”®å`

### 5.4 é€šè¿‡Ansibleéƒ¨ç½²è‡ªå®šä¹‰Facts


**è‡ªåŠ¨åŒ–éƒ¨ç½²è‡ªå®šä¹‰Facts**ï¼š
```yaml
- name: åˆ›å»ºfactsç›®å½•
  file:
    path: /etc/ansible/facts.d
    state: directory
    mode: '0755'

- name: éƒ¨ç½²åº”ç”¨ä¿¡æ¯facts
  copy:
    content: |
      {
        "app_name": "{{ app_name | default('unknown') }}",
        "app_version": "{{ app_version | default('1.0.0') }}",
        "environment": "{{ env_type | default('development') }}",
        "deploy_date": "{{ ansible_date_time.date }}"
      }
    dest: /etc/ansible/facts.d/app_info.fact
    mode: '0644'
  notify: refresh_facts

- name: åˆ·æ–°Factsä¿¡æ¯
  setup:
  tags: always
```

---

## 6. âš¡ Factsç¼“å­˜ä¸æ€§èƒ½ä¼˜åŒ–


### 6.1 Factsç¼“å­˜æœºåˆ¶


**ä¸ºä»€ä¹ˆéœ€è¦ç¼“å­˜**ï¼š
- **â° å‡å°‘æ”¶é›†æ—¶é—´**ï¼šé¿å…é‡å¤æ”¶é›†ç›¸åŒä¿¡æ¯
- **ğŸŒ é™ä½ç½‘ç»œå¼€é”€**ï¼šå‡å°‘SSHè¿æ¥å’Œæ•°æ®ä¼ è¾“
- **ğŸ’¾ èŠ‚çœç³»ç»Ÿèµ„æº**ï¼šå‡å°‘ç›®æ ‡ä¸»æœºçš„èµ„æºæ¶ˆè€—

**ç¼“å­˜é…ç½®æ–¹æ³•**ï¼š
```ini
# ansible.cfgé…ç½®æ–‡ä»¶
[defaults]
# å¯ç”¨factsç¼“å­˜
gathering = smart
# ç¼“å­˜è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
fact_caching_timeout = 3600
# ç¼“å­˜æ–¹å¼ï¼ˆmemory/redis/jsonfileï¼‰
fact_caching = jsonfile
# ç¼“å­˜ç›®å½•
fact_caching_connection = /tmp/ansible_facts_cache
```

### 6.2 ç¼“å­˜ç­–ç•¥é€‰æ‹©


**ç¼“å­˜æ–¹å¼å¯¹æ¯”**ï¼š

| ç¼“å­˜ç±»å‹ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|---------|------|------|----------|
| `memory` | **é€Ÿåº¦æœ€å¿«** | é‡å¯åä¸¢å¤± | å•æ¬¡æ‰§è¡Œï¼Œä¸´æ—¶ç¼“å­˜ |
| `jsonfile` | **æŒä¹…åŒ–å­˜å‚¨** | ç£ç›˜IOå¼€é”€ | å¤šæ¬¡æ‰§è¡Œï¼Œæœ¬åœ°å¼€å‘ |
| `redis` | **é›†ä¸­ç®¡ç†** | éœ€è¦RedisæœåŠ¡ | å¤šç”¨æˆ·ç¯å¢ƒï¼Œç”Ÿäº§ç¯å¢ƒ |

### 6.3 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


**ä¼˜åŒ–æ”¶é›†èŒƒå›´**ï¼š
```yaml
# åªæ”¶é›†å¿…è¦ä¿¡æ¯ï¼Œæå‡é€Ÿåº¦
- hosts: webservers
  gather_facts: yes
  gather_subset:
    - "!all"          # æ’é™¤æ‰€æœ‰
    - "min"           # åªæ”¶é›†æœ€åŸºç¡€ä¿¡æ¯
    - "network"       # æ·»åŠ ç½‘ç»œä¿¡æ¯
    - "virtual"       # æ·»åŠ è™šæ‹ŸåŒ–ä¿¡æ¯
```

**åˆ†æ‰¹æ”¶é›†ç­–ç•¥**ï¼š
```yaml
- name: ç¬¬ä¸€é˜¶æ®µï¼šä¸æ”¶é›†factså¿«é€Ÿæ‰§è¡Œ
  hosts: all
  gather_facts: no
  tasks:
    - name: æ£€æŸ¥ä¸»æœºè¿é€šæ€§
      ping:

- name: ç¬¬äºŒé˜¶æ®µï¼šéœ€è¦æ—¶æ‰æ”¶é›†facts
  hosts: webservers  
  gather_facts: yes
  gather_subset: min
  tasks:
    - name: æ ¹æ®ç³»ç»Ÿä¿¡æ¯æ‰§è¡Œé…ç½®
      template:
        src: app.conf.j2
        dest: /etc/app/app.conf
```

---

## 7. ğŸ¯ å®æˆ˜åº”ç”¨åœºæ™¯


### 7.1 ç¯å¢ƒæ£€æŸ¥è„šæœ¬


**ç³»ç»Ÿç¯å¢ƒæ£€æŸ¥Playbook**ï¼š
```yaml
- name: æœåŠ¡å™¨ç¯å¢ƒæ£€æŸ¥
  hosts: all
  tasks:
    - name: æ”¶é›†ç³»ç»Ÿä¿¡æ¯
      setup:
        gather_subset: all
    
    - name: ç”Ÿæˆç¯å¢ƒæ£€æŸ¥æŠ¥å‘Š  
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â• æœåŠ¡å™¨ç¯å¢ƒæ£€æŸ¥æŠ¥å‘Š â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘ ä¸»æœºå: {{ ansible_hostname }}
          â•‘ ç³»ç»Ÿ: {{ ansible_distribution }} {{ ansible_distribution_version }}
          â•‘ å†…æ ¸: {{ ansible_kernel }}
          â•‘ æ¶æ„: {{ ansible_architecture }}  
          â•‘ CPUæ ¸å¿ƒ: {{ ansible_processor_vcpus }}
          â•‘ å†…å­˜: {{ ansible_memtotal_mb }}MB
          â•‘ ç£ç›˜: {% for mount in ansible_mounts %}{{ mount.mount }}({{ (mount.size_total/1024/1024/1024)|round(2) }}GB) {% endfor %}
          â•‘ ä¸»IP: {{ ansible_default_ipv4.address }}
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    - name: æ£€æŸ¥ç³»ç»Ÿè¦æ±‚
      assert:
        that:
          - ansible_memtotal_mb >= 2048
          - ansible_processor_vcpus >= 2
          - ansible_architecture == "x86_64"
        fail_msg: "ç³»ç»Ÿé…ç½®ä¸æ»¡è¶³æœ€ä½è¦æ±‚"
        success_msg: "ç³»ç»Ÿé…ç½®æ£€æŸ¥é€šè¿‡"
```

### 7.2 åŠ¨æ€é…ç½®ç”Ÿæˆ


**æ ¹æ®ä¸»æœºé…ç½®ç”ŸæˆæœåŠ¡é…ç½®**ï¼š
```yaml
- name: åŠ¨æ€ç”Ÿæˆæ•°æ®åº“é…ç½®
  hosts: dbservers
  tasks:
    - name: æ ¹æ®å†…å­˜å¤§å°è°ƒæ•´MySQLé…ç½®
      template:
        src: my.cnf.j2
        dest: /etc/mysql/my.cnf
      vars:
        # æ ¹æ®å†…å­˜åŠ¨æ€è®¡ç®—ç¼“å†²åŒºå¤§å°
        innodb_buffer_pool_size: "{{ (ansible_memtotal_mb * 0.7) | int }}M"
        max_connections: "{{ ansible_processor_vcpus * 50 }}"
      notify: restart mysql
```

**æ¨¡æ¿æ–‡ä»¶å†…å®¹**ï¼š
```ini
# templates/my.cnf.j2
[mysqld]
# æ ¹æ®ç³»ç»Ÿå†…å­˜åŠ¨æ€é…ç½®
innodb_buffer_pool_size = {{ innodb_buffer_pool_size }}

# æ ¹æ®CPUæ ¸å¿ƒæ•°é…ç½®è¿æ¥æ•°
max_connections = {{ max_connections }}

# æ ¹æ®ç³»ç»Ÿç±»å‹è®¾ç½®æ•°æ®ç›®å½•
{% if ansible_os_family == "RedHat" %}
datadir = /var/lib/mysql
{% elif ansible_os_family == "Debian" %}  
datadir = /var/lib/mysql
{% endif %}

# æ ¹æ®ç½‘ç»œæ¥å£ç»‘å®šåœ°å€
bind-address = {{ ansible_default_ipv4.address }}
```

### 7.3 é›†ç¾¤èŠ‚ç‚¹å‘ç°


**è‡ªåŠ¨å‘ç°é›†ç¾¤èŠ‚ç‚¹**ï¼š
```yaml
- name: é…ç½®é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯
  hosts: cluster_nodes
  tasks:
    - name: æ”¶é›†æ‰€æœ‰èŠ‚ç‚¹ä¿¡æ¯
      setup:
      delegate_to: "{{ item }}"
      delegate_facts: yes
      loop: "{{ groups['cluster_nodes'] }}"
    
    - name: ç”Ÿæˆé›†ç¾¤é…ç½®æ–‡ä»¶
      template:
        src: cluster.conf.j2  
        dest: /etc/cluster/cluster.conf
      vars:
        cluster_members: |
          {% for host in groups['cluster_nodes'] %}
          {{ hostvars[host]['ansible_hostname'] }}:{{ hostvars[host]['ansible_default_ipv4']['address'] }}:9300
          {% endfor %}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Factsæœ¬è´¨ï¼šAnsibleè‡ªåŠ¨æ”¶é›†çš„ç›®æ ‡ä¸»æœºç³»ç»Ÿä¿¡æ¯
ğŸ”¸ setupæ¨¡å—ï¼šä¸“é—¨æ”¶é›†Factsçš„å†…ç½®æ¨¡å—ï¼Œæ¯æ¬¡æ‰§è¡Œå‰è‡ªåŠ¨è¿è¡Œ
ğŸ”¸ å˜é‡è®¿é—®ï¼šé€šè¿‡ansible_*å˜é‡åè®¿é—®ï¼Œè‡ªå®šä¹‰Factsé€šè¿‡ansible_localè®¿é—®
ğŸ”¸ ä¿¡æ¯åˆ†ç±»ï¼šç³»ç»Ÿä¿¡æ¯ã€ç¡¬ä»¶ä¿¡æ¯ã€ç½‘ç»œä¿¡æ¯ã€æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯å››å¤§ç±»
ğŸ”¸ åº”ç”¨åœºæ™¯ï¼šæ¡ä»¶åˆ¤æ–­ã€æ¨¡æ¿æ¸²æŸ“ã€åŠ¨æ€é…ç½®ã€ç¯å¢ƒæ£€æŸ¥
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ Factsçš„ç”Ÿå‘½å‘¨æœŸ**
```
ç†è§£è¦ç‚¹ï¼š
- Factsåœ¨æ¯æ¬¡playbookæ‰§è¡Œæ—¶æ”¶é›†
- ä»…åœ¨å½“å‰æ‰§è¡Œå‘¨æœŸå†…æœ‰æ•ˆ
- å¯ä»¥é€šè¿‡ç¼“å­˜æœºåˆ¶æå‡æ€§èƒ½
- gather_facts: no å¯ä»¥è·³è¿‡æ”¶é›†
```

**ğŸ”¹ å¸¸ç”¨Factså˜é‡è®°å¿†**
```
ç³»ç»Ÿç±»å‹ï¼šansible_os_family, ansible_distribution  
ç¡¬ä»¶é…ç½®ï¼šansible_processor_vcpus, ansible_memtotal_mb
ç½‘ç»œä¿¡æ¯ï¼šansible_default_ipv4.address, ansible_interfaces
æ–‡ä»¶ç³»ç»Ÿï¼šansible_mounts (æ•°ç»„ç±»å‹)
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**
```
æ”¶é›†ä¼˜åŒ–ï¼š
- ä½¿ç”¨gather_subseté™åˆ¶æ”¶é›†èŒƒå›´
- å¯ç”¨factsç¼“å­˜å‡å°‘é‡å¤æ”¶é›†
- ä¸éœ€è¦æ—¶å…³é—­è‡ªåŠ¨æ”¶é›†

ä½¿ç”¨æŠ€å·§ï¼š
- åœ¨æ¡ä»¶åˆ¤æ–­ä¸­ä½¿ç”¨Factså®ç°è·¨å¹³å°å…¼å®¹
- åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨Factså®ç°åŠ¨æ€é…ç½®
- ç»“åˆdelegate_factså®ç°é›†ç¾¤é…ç½®
```

### 8.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ“Š è‡ªåŠ¨åŒ–è¿ç»´åœºæ™¯**ï¼š
- **ç¯å¢ƒæ ‡å‡†åŒ–**ï¼šæ ¹æ®Factsä¿¡æ¯ç»Ÿä¸€é…ç½®æ ‡å‡†
- **æ€§èƒ½è°ƒä¼˜**ï¼šæ ¹æ®ç¡¬ä»¶é…ç½®è‡ªåŠ¨è°ƒæ•´æœåŠ¡å‚æ•°
- **æ•…éšœæ’æŸ¥**ï¼šæ”¶é›†ç³»ç»Ÿä¿¡æ¯è¾…åŠ©é—®é¢˜è¯Šæ–­
- **èµ„æºç®¡ç†**ï¼šåŸºäºFactsä¿¡æ¯è¿›è¡Œèµ„æºåˆ†é…å’Œç›‘æ§

**ğŸ¯ æœ€ä½³å®è·µå»ºè®®**ï¼š
- ç†Ÿç»ƒæŒæ¡å¸¸ç”¨Factså˜é‡çš„å«ä¹‰å’Œç”¨æ³•
- å­¦ä¼šåœ¨playbookä¸­ä½¿ç”¨Factsè¿›è¡Œæ¡ä»¶åˆ¤æ–­
- æŒæ¡è‡ªå®šä¹‰Factsçš„åˆ›å»ºå’Œä½¿ç”¨æ–¹æ³•
- äº†è§£æ€§èƒ½ä¼˜åŒ–å’Œç¼“å­˜é…ç½®æ–¹æ³•

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- Factsæ”¶é›†ç³»ç»Ÿä¿¡ï¼Œsetupæ¨¡å—æ˜¯å…³é”®
- æ¡ä»¶åˆ¤æ–­æ¨¡æ¿ç”¨ï¼ŒåŠ¨æ€é…ç½®å¾ˆæ–¹ä¾¿
- è‡ªå®šä¹‰Factsæ‰©åŠŸèƒ½ï¼Œlocalå‰ç¼€è¦è®°ç‰¢
- ç¼“å­˜ä¼˜åŒ–ææ€§èƒ½ï¼ŒæŒ‰éœ€æ”¶é›†æ˜¯ç‹é“