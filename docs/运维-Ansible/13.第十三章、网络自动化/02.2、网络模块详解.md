---
title: 2、网络模块详解
---
## 📚 目录

1. [网络自动化基础概念](#1-网络自动化基础概念)
2. [Cisco IOS模块详解](#2-cisco-ios模块详解)
3. [Nexus NX-OS模块应用](#3-nexus-nx-os模块应用)
4. [Arista EOS模块操作](#4-arista-eos模块操作)
5. [Juniper模块管理](#5-juniper模块管理)
6. [网络配置管理实战](#6-网络配置管理实战)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 🌐 网络自动化基础概念


### 1.1 什么是网络自动化


**🔸 基本概念**
网络自动化就是用程序代替人工来管理网络设备，就像用遥控器控制电视一样，我们用Ansible来远程控制路由器、交换机等网络设备。

**💡 为什么需要网络自动化**
```
传统手工方式的问题：
• 一台台登录设备配置 → 效率低下
• 人工操作容易出错 → 配置错误风险高  
• 配置不一致 → 网络故障难排查
• 变更记录缺失 → 无法追溯问题

自动化带来的好处：
• 批量操作 → 几百台设备同时配置
• 标准化配置 → 减少人为错误
• 版本控制 → 配置变更可追溯
• 快速部署 → 新业务快速上线
```

### 1.2 Ansible网络模块分类


**📋 主要厂商模块分类**

| 厂商类型 | **模块前缀** | **典型设备** | **主要用途** |
|---------|------------|-------------|-----------|
| 🔸 **Cisco IOS** | `ios_*` | `路由器、交换机` | `企业网络核心设备` |
| 🔺 **Cisco Nexus** | `nxos_*` | `数据中心交换机` | `大型数据中心网络` |
| ⭐ **Arista EOS** | `eos_*` | `云网络设备` | `软件定义网络` |
| 🔧 **Juniper** | `junos_*` | `企业级路由器` | `运营商网络设备` |

### 1.3 网络模块工作原理


**🔄 连接与执行流程**
```
Ansible控制节点
       |
   [SSH/NETCONF连接]
       |
   网络设备(路由器/交换机)
       |
   [执行配置命令]
       |
   [返回执行结果]
       |
   Ansible收集结果并报告
```

**⚠️ 重要理解**
- **无Agent**：网络设备不需要安装任何软件
- **基于SSH**：通过SSH协议连接设备
- **命令转换**：Ansible模块将任务转换为设备命令
- **幂等性**：多次执行相同任务结果一致

---

## 2. 🔧 Cisco IOS模块详解


### 2.1 ios_command模块 - 命令执行专家


**🎯 模块用途**
`ios_command`模块专门用来在Cisco IOS设备上执行**查看命令**，就像你在设备上输入`show`命令一样，但可以批量执行并收集结果。

**💡 基本语法结构**
```yaml
- name: 执行IOS查看命令
  ios_command:
    commands:
      - show version        # 查看版本信息
      - show ip route      # 查看路由表  
      - show interface     # 查看接口状态
```

**⚡ 实际应用示例**

```yaml
---
- name: 收集网络设备信息
  hosts: cisco_routers
  gather_facts: no
  
  tasks:
    - name: 检查设备基本信息
      ios_command:
        commands:
          - show version
          - show ip interface brief  
          - show running-config | include hostname
      register: device_info
    
    - name: 显示收集到的信息
      debug:
        msg: "设备 {{ inventory_hostname }} 的版本信息: {{ device_info.stdout[0] }}"
```

**🔍 高级用法 - 条件等待**
```yaml
- name: 等待接口UP状态
  ios_command:
    commands:
      - show interface GigabitEthernet0/1
    wait_for:
      - result[0] contains "line protocol is up"
    interval: 10      # 每10秒检查一次
    retries: 5        # 最多重试5次
```

### 2.2 ios_config模块 - 配置管理核心


**🎯 模块作用**
`ios_config`是配置IOS设备的核心模块，可以添加、修改、删除设备配置，相当于你在设备上进入配置模式进行配置。

**📝 基础配置语法**
```yaml
- name: 配置主机名和接口
  ios_config:
    lines:
      - hostname Router-01                    # 设置主机名
      - interface GigabitEthernet0/1         # 进入接口配置
      - ip address 192.168.1.1 255.255.255.0  # 配置IP地址
      - no shutdown                          # 启用接口
```

**🔧 分段配置管理**
```yaml
- name: 配置OSPF路由协议
  ios_config:
    lines:
      - network 192.168.1.0 0.0.0.255 area 0
      - network 10.0.0.0 0.255.255.255 area 1  
    parents: router ospf 100    # 指定父级配置段
```

**⚠️ 安全配置实践**
```yaml
- name: 安全配置备份和变更
  ios_config:
    lines:
      - username admin privilege 15 secret MyPassword123
      - line vty 0 4
      - login local
    backup: yes              # 配置前自动备份
    backup_options:
      filename: "{{ inventory_hostname }}_backup.cfg"
      dir_path: ./backups/
```

### 2.3 配置验证与回滚


**✅ 配置验证机制**
```yaml
- name: 带验证的接口配置
  ios_config:
    lines:
      - description "Connect to Server Farm"  
      - switchport mode access
      - switchport access vlan 100
    parents: interface GigabitEthernet1/0/24
    match: exact           # 精确匹配现有配置
    replace: line          # 逐行替换差异配置
```

**🔄 配置对比与更新**
```yaml
- name: 智能配置更新
  ios_config:
    src: router_template.j2    # 使用配置模板
    diff_against: intended     # 对比预期配置
    intended_config: "{{ lookup('file', 'intended_config.txt') }}"
```

---

## 3. 🏢 Nexus NX-OS模块应用


### 3.1 nxos_config模块特点


**🔸 与IOS的区别**
NX-OS系统主要用于**数据中心环境**，相比传统IOS有更强的虚拟化和高密度端口支持能力。

**💪 核心配置能力**
```yaml
- name: 配置Nexus交换机VLAN
  nxos_config:
    lines:
      - name Production-Web
      - state active
    parents: vlan 100
```

**🌐 VPC配置示例**
```yaml
- name: 配置虚拟端口通道
  nxos_config:
    lines:
      - peer-keepalive destination 10.1.1.2
      - peer-gateway
      - auto-recovery
    parents: vpc domain 1
```

### 3.2 高密度端口管理


**⚡ 批量端口配置**
```yaml
- name: 批量配置接入端口
  nxos_config:
    lines:
      - switchport mode access
      - switchport access vlan {{ item.vlan }}
      - spanning-tree port type edge
    parents: interface Ethernet1/{{ item.port }}
  loop:
    - { port: 1, vlan: 10 }
    - { port: 2, vlan: 20 }  
    - { port: 3, vlan: 30 }
```

**🔧 Fabric Extender配置**
```yaml
- name: 配置FEX扩展模块
  nxos_config:
    lines:
      - type fex
      - description "Server Access FEX"
    parents: interface Ethernet101/1/1-48
```

---

## 4. ☁️ Arista EOS模块操作


### 4.1 eos_facts模块 - 设备信息收集


**📊 EOS设备信息收集**
`eos_facts`模块专门用于收集Arista设备的详细信息，包括硬件、软件、网络配置等各种状态数据。

```yaml
- name: 收集EOS设备详细信息
  eos_facts:
    gather_subset:
      - all              # 收集所有信息
      - "!config"        # 排除配置信息(感叹号表示排除)
  register: eos_facts

- name: 显示设备信息摘要
  debug:
    msg: |
      设备型号: {{ eos_facts.ansible_facts.ansible_net_model }}
      软件版本: {{ eos_facts.ansible_facts.ansible_net_version }}  
      序列号: {{ eos_facts.ansible_facts.ansible_net_serialnum }}
```

### 4.2 eos_config高级特性


**🎨 模板化配置管理**
```yaml
- name: 使用模板配置BGP
  eos_config:
    src: bgp_template.j2
    backup: yes
  vars:
    bgp_asn: 65001
    router_id: 1.1.1.1
    neighbors:
      - ip: 10.0.0.2
        remote_as: 65002
```

**🔄 配置会话管理**
```yaml
- name: 使用配置会话安全变更
  eos_config:
    lines:
      - router bgp {{ bgp_asn }}
      - neighbor {{ neighbor_ip }} remote-as {{ remote_asn }}
    session: ansible_session    # 使用命名会话
    commit: no                  # 先不提交，等待验证
```

---

## 5. 🌲 Juniper模块管理


### 5.1 junos_config模块特点


**🔸 Junos独特之处**
Juniper设备使用XML格式的配置和NETCONF协议，这与其他厂商的CLI方式有明显区别。

**📋 基本配置语法**
```yaml
- name: 配置Juniper接口
  junos_config:
    lines:
      - set interfaces ge-0/0/1 unit 0 family inet address 192.168.1.1/24
      - set interfaces ge-0/0/1 unit 0 description "LAN Connection"
    comment: "Ansible automated configuration"
```

### 5.2 XML格式配置管理


**🔧 结构化配置方式**
```yaml
- name: 使用结构化配置
  junos_config:
    config: |
      <configuration>
        <interfaces>
          <interface>
            <name>ge-0/0/1</name>
            <unit>
              <name>0</name>
              <family>
                <inet>
                  <address>
                    <name>192.168.1.1/24</name>
                  </address>
                </inet>
              </family>
            </unit>
          </interface>
        </interfaces>
      </configuration>
    format: xml
```

---

## 6. 🛠️ 网络配置管理实战


### 6.1 接口配置统一管理


**⚡ 多厂商接口配置**
```yaml
---
- name: 统一接口配置管理
  hosts: network_devices
  gather_facts: no
  
  tasks:
    # Cisco设备接口配置
    - name: 配置Cisco设备接口
      ios_config:
        lines:
          - description {{ interface.description }}
          - ip address {{ interface.ip }} {{ interface.mask }}
          - no shutdown
        parents: interface {{ interface.name }}
      when: ansible_network_os == "ios"
      loop: "{{ interfaces }}"
      loop_control:
        loop_var: interface
    
    # Nexus设备接口配置  
    - name: 配置Nexus设备接口
      nxos_config:
        lines:
          - description {{ interface.description }}
          - ip address {{ interface.ip }}/{{ interface.prefix }}
          - no shutdown
        parents: interface {{ interface.name }}
      when: ansible_network_os == "nxos"
      loop: "{{ interfaces }}"
      loop_control:
        loop_var: interface
```

### 6.2 VLAN管理自动化


**🌐 VLAN配置标准化**
```yaml
- name: 标准化VLAN配置
  hosts: switches
  
  vars:
    standard_vlans:
      - { id: 10, name: "Management", subnet: "192.168.10.0/24" }
      - { id: 20, name: "Production", subnet: "192.168.20.0/24" }
      - { id: 30, name: "Development", subnet: "192.168.30.0/24" }
  
  tasks:
    - name: 创建标准VLAN
      ios_config:
        lines:
          - name {{ item.name }}
        parents: vlan {{ item.id }}
      loop: "{{ standard_vlans }}"
      
    - name: 配置VLAN接口网关
      ios_config:
        lines:
          - ip address {{ item.subnet | ipaddr('1') }} {{ item.subnet | ipaddr('netmask') }}
          - no shutdown
        parents: interface vlan{{ item.id }}
      loop: "{{ standard_vlans }}"
```

### 6.3 路由配置自动化


**🛣️ OSPF路由配置**
```yaml
- name: 自动化OSPF路由配置
  hosts: routers
  
  tasks:
    - name: 启用OSPF进程
      ios_config:
        lines:
          - router-id {{ router_id }}
          - passive-interface default
          - no passive-interface {{ item }}
        parents: router ospf {{ ospf_process }}
      loop: "{{ ospf_interfaces }}"
    
    - name: 配置OSPF网络
      ios_config:
        lines:
          - network {{ item.network }} {{ item.wildcard }} area {{ item.area }}
        parents: router ospf {{ ospf_process }}
      loop: "{{ ospf_networks }}"
```

### 6.4 配置备份与恢复


**💾 自动化备份策略**
```yaml
- name: 网络设备配置备份
  hosts: all_network_devices
  
  tasks:
    - name: 创建备份目录
      file:
        path: "./backups/{{ inventory_hostname }}"
        state: directory
      delegate_to: localhost
    
    - name: 备份IOS设备配置
      ios_command:
        commands: show running-config
      register: ios_config
      when: ansible_network_os == "ios"
    
    - name: 保存配置到本地文件
      copy:
        content: "{{ ios_config.stdout[0] }}"
        dest: "./backups/{{ inventory_hostname }}/running-config-{{ ansible_date_time.date }}.txt"
      delegate_to: localhost
      when: ios_config is defined
```

### 6.5 网络健康检查


**🏥 自动化网络诊断**
```yaml
- name: 网络设备健康检查
  hosts: network_devices
  
  tasks:
    - name: 检查设备运行状态
      ios_command:
        commands:
          - show version
          - show processes cpu
          - show memory summary
          - show interface summary
      register: health_check
    
    - name: 分析CPU使用率
      debug:
        msg: "警告：设备{{ inventory_hostname }}CPU使用率过高！"
      when: health_check.stdout[1] | regex_search('CPU utilization.*?(\d+)%') | int > 80
    
    - name: 检查关键接口状态
      ios_command:
        commands: show interface {{ item }} | include "line protocol"
      loop: "{{ critical_interfaces }}"
      register: interface_status
      failed_when: "'line protocol is down' in interface_status.stdout[0]"
```

---

## 7. 📋 核心要点总结


### 7.1 必须掌握的基本概念


```
🔸 网络自动化本质：用程序代替手工管理网络设备
🔸 模块分类：按厂商分类(ios_*/nxos_*/eos_*/junos_*)
🔸 基本操作：命令执行(command模块)和配置管理(config模块) 
🔸 工作原理：通过SSH连接，转换任务为设备命令
🔸 核心优势：批量操作、标准化配置、版本控制
```

### 7.2 关键模块对比理解


**📊 主要模块功能对比**

| 模块类型 | **主要用途** | **典型场景** | **注意要点** |
|---------|------------|-------------|-------------|
| `*_command` | `执行查看命令` | `信息收集、状态检查` | `只读操作，安全性高` |
| `*_config` | `配置管理` | `设备配置变更` | `需要备份，影响业务` |
| `*_facts` | `设备信息收集` | `资产管理、监控` | `结构化数据输出` |

### 7.3 实际应用指导原则


**✅ 最佳实践**
```
配置安全：
• 重要变更前必须备份配置
• 使用check模式预检查变更影响  
• 配置分阶段、小批量执行

标准化管理：
• 使用模板统一配置格式
• 建立配置标准和命名规范
• 实现配置版本控制

错误处理：
• 设置合理的超时时间
• 使用条件判断避免重复操作
• 建立配置回滚机制
```

**⚠️ 常见陷阱**
```
连接问题：
• 确保SSH连接正常且权限足够
• 注意设备的并发连接限制
• 处理设备重启后的连接恢复

配置冲突：
• 避免同时修改相同配置段
• 理解设备配置的依赖关系  
• 注意配置的生效顺序

性能影响：
• 避免在业务高峰期执行变更
• 控制并发执行的设备数量
• 监控设备CPU和内存使用情况
```

### 7.4 学习路径建议


**📍 基础阶段**
1. **掌握SSH连接**：能够通过Ansible连接网络设备
2. **熟练使用command模块**：收集设备信息和状态
3. **理解config模块基础**：执行简单的配置变更

**🎯 进阶阶段**  
1. **模板化配置**：使用Jinja2模板标准化配置
2. **条件判断**：根据设备类型执行不同操作
3. **错误处理**：建立完善的异常处理机制

**🚀 高级阶段**
1. **多厂商统一管理**：抽象化网络操作
2. **自动化流程设计**：端到端的网络变更流程
3. **监控与告警集成**：配置变更的自动化监控

**💡 记忆要点**
- **command模块**：只看不改，安全收集信息
- **config模块**：能改配置，需要小心备份
- **facts模块**：结构化收集，便于程序处理
- **备份优先**：重要配置变更前必须备份
- **分步执行**：大批量变更要分阶段进行

通过这些网络模块，你可以实现从简单的设备信息收集到复杂的网络配置管理，让网络运维工作变得更加高效和可靠。记住：**自动化不是为了炫技，而是为了让网络管理更加标准化、可追溯、少出错**。