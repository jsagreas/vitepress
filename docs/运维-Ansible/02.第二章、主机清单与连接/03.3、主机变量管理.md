---
title: 3ã€ä¸»æœºå˜é‡ç®¡ç†
---
## ğŸ“š ç›®å½•

1. [å˜é‡ç®¡ç†åŸºç¡€æ¦‚å¿µ](#1-å˜é‡ç®¡ç†åŸºç¡€æ¦‚å¿µ)
2. [host_varsç›®å½•è¯¦è§£](#2-host_varsç›®å½•è¯¦è§£)
3. [group_varsç›®å½•è¯¦è§£](#3-group_varsç›®å½•è¯¦è§£)
4. [å˜é‡ç»§æ‰¿ä¸ä¼˜å…ˆçº§](#4-å˜é‡ç»§æ‰¿ä¸ä¼˜å…ˆçº§)
5. [å˜é‡æ–‡ä»¶ç»„ç»‡æœ€ä½³å®è·µ](#5-å˜é‡æ–‡ä»¶ç»„ç»‡æœ€ä½³å®è·µ)
6. [æ•æ„Ÿå˜é‡å®‰å…¨å¤„ç†](#6-æ•æ„Ÿå˜é‡å®‰å…¨å¤„ç†)
7. [å®é™…åº”ç”¨åœºæ™¯](#7-å®é™…åº”ç”¨åœºæ™¯)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ å˜é‡ç®¡ç†åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Ansibleå˜é‡


**ç®€å•ç†è§£**ï¼šå˜é‡å°±æ˜¯ç»™æœåŠ¡å™¨è®¾ç½®"æ ‡ç­¾"å’Œ"å±æ€§"çš„æ–¹å¼

æƒ³è±¡ä¸€ä¸‹ç®¡ç†å…¬å¸çš„ç”µè„‘ï¼š
```
åŠå…¬å®¤ç”µè„‘Aï¼š
- éƒ¨é—¨ï¼šè´¢åŠ¡éƒ¨
- æ“ä½œç³»ç»Ÿï¼šWindows 10
- å†…å­˜ï¼š8GB
- éœ€è¦å®‰è£…ï¼šOfficeã€è´¢åŠ¡è½¯ä»¶

åŠå…¬å®¤ç”µè„‘Bï¼š
- éƒ¨é—¨ï¼šå¼€å‘éƒ¨  
- æ“ä½œç³»ç»Ÿï¼šUbuntu
- å†…å­˜ï¼š16GB
- éœ€è¦å®‰è£…ï¼šDockerã€å¼€å‘å·¥å…·
```

åœ¨Ansibleä¸­ï¼Œè¿™äº›ä¿¡æ¯å°±æ˜¯å˜é‡ï¼Œå¸®åŠ©æˆ‘ä»¬ï¼š
- ğŸ·ï¸ **åŒºåˆ†ä¸åŒä¸»æœº**ï¼šæ¯å°æœåŠ¡å™¨æœ‰è‡ªå·±çš„ç‰¹ç‚¹
- ğŸ“‹ **ç»Ÿä¸€ç®¡ç†é…ç½®**ï¼šç›¸åŒç±»å‹æœåŠ¡å™¨ç”¨ç›¸åŒé…ç½®
- ğŸ”§ **çµæ´»éƒ¨ç½²åº”ç”¨**ï¼šæ ¹æ®æœåŠ¡å™¨ç‰¹ç‚¹é€‰æ‹©å®‰è£…å†…å®¹

### 1.2 å˜é‡çš„ä¸¤å¤§ç±»å‹


**ä¸»æœºå˜é‡ï¼ˆHost Variablesï¼‰**ï¼š
```
å«ä¹‰ï¼šå•ä¸ªæœåŠ¡å™¨ä¸“æœ‰çš„è®¾ç½®
æ¯”å¦‚ï¼šè¿™å°æœåŠ¡å™¨çš„IPåœ°å€ã€ä¸»æœºåã€ç‰¹æ®Šé…ç½®
```

**ç»„å˜é‡ï¼ˆGroup Variablesï¼‰**ï¼š
```
å«ä¹‰ï¼šä¸€ç»„æœåŠ¡å™¨å…±åŒçš„è®¾ç½®
æ¯”å¦‚ï¼šWebæœåŠ¡å™¨ç»„éƒ½éœ€è¦å®‰è£…Nginx
```

### 1.3 ä¸ºä»€ä¹ˆéœ€è¦å˜é‡ç®¡ç†


**é—®é¢˜åœºæ™¯**ï¼š
```
æ²¡æœ‰å˜é‡ç®¡ç†ï¼š
æ¯å°æœåŠ¡å™¨å†™ä¸€ä¸ªå•ç‹¬çš„é…ç½®æ–‡ä»¶
100å°æœåŠ¡å™¨ = 100ä¸ªé…ç½®æ–‡ä»¶
ä¿®æ”¹ä¸€ä¸ªé…ç½®éœ€è¦æ”¹100æ¬¡

æœ‰äº†å˜é‡ç®¡ç†ï¼š
WebæœåŠ¡å™¨ç»„ï¼šå…±åŒå˜é‡å†™ä¸€æ¬¡
ç‰¹æ®ŠæœåŠ¡å™¨ï¼šä¸ªåˆ«å˜é‡å•ç‹¬è®¾ç½®
ä¿®æ”¹é…ç½®åªéœ€è¦æ”¹ä¸€ä¸ªåœ°æ–¹
```

---

## 2. ğŸ“ host_varsç›®å½•è¯¦è§£


### 2.1 host_varsç›®å½•çš„ä½œç”¨


**æ ¸å¿ƒæ¦‚å¿µ**ï¼š`host_vars`æ˜¯ä¸“é—¨å­˜æ”¾**å•ä¸ªä¸»æœºå˜é‡**çš„ç›®å½•

```
é¡¹ç›®ç»“æ„ç¤ºä¾‹ï¼š
ansible-project/
â”œâ”€â”€ inventory/
â”‚   â””â”€â”€ hosts
â”œâ”€â”€ host_vars/           â† ä¸»æœºå˜é‡ç›®å½•
â”‚   â”œâ”€â”€ web01.yml       â† web01æœåŠ¡å™¨çš„ä¸“æœ‰å˜é‡
â”‚   â”œâ”€â”€ web02.yml       â† web02æœåŠ¡å™¨çš„ä¸“æœ‰å˜é‡
â”‚   â””â”€â”€ db01.yml        â† db01æœåŠ¡å™¨çš„ä¸“æœ‰å˜é‡
â””â”€â”€ playbooks/
```

### 2.2 host_varsæ–‡ä»¶å‘½åè§„åˆ™


**å‘½åæ–¹å¼**ï¼šå¿…é¡»ä¸inventoryä¸­çš„ä¸»æœºå**å®Œå…¨ä¸€è‡´**

```yaml
# inventoryæ–‡ä»¶å†…å®¹
[webservers]
web01.example.com
web02.example.com

[databases] 
db01.example.com
```

å¯¹åº”çš„host_varsæ–‡ä»¶ï¼š
```
host_vars/
â”œâ”€â”€ web01.example.com.yml    â† ä¸»æœºåå®Œå…¨åŒ¹é…
â”œâ”€â”€ web02.example.com.yml    â† ä¸»æœºåå®Œå…¨åŒ¹é…  
â””â”€â”€ db01.example.com.yml     â† ä¸»æœºåå®Œå…¨åŒ¹é…
```

### 2.3 host_varsæ–‡ä»¶å†…å®¹ç¤ºä¾‹


**web01.example.com.yml** - WebæœåŠ¡å™¨1çš„ä¸“æœ‰é…ç½®ï¼š
```yaml
# WebæœåŠ¡å™¨1çš„ä¸“æœ‰å˜é‡
server_role: "primary_web"
nginx_worker_processes: 4
ssl_certificate_path: "/etc/ssl/web01-cert.pem"
backup_schedule: "0 2 * * *"

# è¿™å°æœåŠ¡å™¨ç‰¹æœ‰çš„åº”ç”¨é…ç½®
custom_apps:
  - name: "monitoring_agent"
    version: "2.1.0"
  - name: "log_collector"
    version: "1.5.2"

# ç½‘ç»œé…ç½®
network_config:
  internal_ip: "192.168.1.10"
  external_ip: "203.0.113.10"
  bandwidth_limit: "1000Mbps"
```

**db01.example.com.yml** - æ•°æ®åº“æœåŠ¡å™¨çš„ä¸“æœ‰é…ç½®ï¼š
```yaml
# æ•°æ®åº“æœåŠ¡å™¨ä¸“æœ‰å˜é‡
server_role: "master_database"
mysql_max_connections: 1000
mysql_buffer_pool_size: "8G"

# å­˜å‚¨é…ç½®
storage_config:
  data_dir: "/var/lib/mysql"
  backup_dir: "/backup/mysql"
  log_dir: "/var/log/mysql"

# å¤‡ä»½ç­–ç•¥
backup_strategy:
  frequency: "daily"
  retention_days: 30
  compression: true
```

### 2.4 host_varsç›®å½•ç»„ç»‡æ–¹å¼


**æ–¹å¼ä¸€ï¼šå•æ–‡ä»¶æ¨¡å¼**ï¼ˆæ¨èå°é¡¹ç›®ï¼‰
```
host_vars/
â”œâ”€â”€ web01.yml
â”œâ”€â”€ web02.yml
â””â”€â”€ db01.yml
```

**æ–¹å¼äºŒï¼šç›®å½•æ¨¡å¼**ï¼ˆæ¨èå¤§é¡¹ç›®ï¼‰
```
host_vars/
â”œâ”€â”€ web01/
â”‚   â”œâ”€â”€ main.yml        â† ä¸»è¦é…ç½®
â”‚   â”œâ”€â”€ network.yml     â† ç½‘ç»œé…ç½®
â”‚   â””â”€â”€ apps.yml        â† åº”ç”¨é…ç½®
â”œâ”€â”€ web02/
â”‚   â”œâ”€â”€ main.yml
â”‚   â””â”€â”€ network.yml
â””â”€â”€ db01/
    â”œâ”€â”€ main.yml
    â”œâ”€â”€ database.yml    â† æ•°æ®åº“ä¸“ç”¨é…ç½®
    â””â”€â”€ backup.yml      â† å¤‡ä»½é…ç½®
```

> ğŸ’¡ **ä½¿ç”¨æŠ€å·§**ï¼šAnsibleä¼šè‡ªåŠ¨è¯»å–ç›®å½•ä¸‹çš„æ‰€æœ‰`.yml`æ–‡ä»¶å¹¶åˆå¹¶å˜é‡

---

## 3. ğŸ“‚ group_varsç›®å½•è¯¦è§£


### 3.1 group_varsç›®å½•çš„ä½œç”¨


**æ ¸å¿ƒæ¦‚å¿µ**ï¼š`group_vars`å­˜æ”¾**ä¸»æœºç»„å…±åŒå˜é‡**çš„ç›®å½•

```
ç†è§£æ–¹å¼ï¼š
host_vars  = ä¸ªäººä¸“å±è®¾ç½®ï¼ˆèº«ä»½è¯å·ã€ä¸ªäººçˆ±å¥½ï¼‰
group_vars = å›¢é˜Ÿå…±åŒè®¾ç½®ï¼ˆå…¬å¸åˆ¶åº¦ã€éƒ¨é—¨è§„èŒƒï¼‰
```

é¡¹ç›®ç»“æ„ï¼š
```
ansible-project/
â”œâ”€â”€ inventory/
â”‚   â””â”€â”€ hosts
â”œâ”€â”€ group_vars/          â† ç»„å˜é‡ç›®å½•
â”‚   â”œâ”€â”€ webservers.yml   â† webserversç»„çš„å…±åŒå˜é‡
â”‚   â”œâ”€â”€ databases.yml    â† databasesç»„çš„å…±åŒå˜é‡
â”‚   â”œâ”€â”€ all.yml         â† æ‰€æœ‰ä¸»æœºçš„å…±åŒå˜é‡
â”‚   â””â”€â”€ prod.yml        â† prodç¯å¢ƒçš„å…±åŒå˜é‡
â””â”€â”€ host_vars/
```

### 3.2 group_varsæ–‡ä»¶å‘½åè§„åˆ™


**å‘½åæ–¹å¼**ï¼šä¸inventoryä¸­çš„**ç»„åå®Œå…¨ä¸€è‡´**

inventoryç¤ºä¾‹ï¼š
```ini
# ä¸»æœºåˆ†ç»„
[webservers]
web01.example.com
web02.example.com

[databases]
db01.example.com
db02.example.com

[loadbalancers]
lb01.example.com

# ç¯å¢ƒåˆ†ç»„
[prod:children]
webservers
databases
loadbalancers

[staging:children]
webservers
```

å¯¹åº”çš„group_varsï¼š
```
group_vars/
â”œâ”€â”€ webservers.yml      â† webserversç»„å˜é‡
â”œâ”€â”€ databases.yml       â† databasesç»„å˜é‡  
â”œâ”€â”€ loadbalancers.yml   â† loadbalancersç»„å˜é‡
â”œâ”€â”€ prod.yml           â† prodç¯å¢ƒå˜é‡
â”œâ”€â”€ staging.yml        â† stagingç¯å¢ƒå˜é‡
â””â”€â”€ all.yml            â† æ‰€æœ‰ä¸»æœºå…±åŒå˜é‡
```

### 3.3 group_varsæ–‡ä»¶å†…å®¹ç¤ºä¾‹


**webservers.yml** - WebæœåŠ¡å™¨ç»„å…±åŒé…ç½®ï¼š
```yaml
# WebæœåŠ¡å™¨ç»„çš„å…±åŒå˜é‡
web_server_type: "nginx"
web_server_version: "1.20"
document_root: "/var/www/html"

# å…±åŒçš„å®‰è£…åŒ…
common_packages:
  - nginx
  - php-fpm
  - mysql-client
  - git
  - curl

# å…±åŒçš„æœåŠ¡é…ç½®
nginx_config:
  worker_connections: 1024
  keepalive_timeout: 65
  gzip_compression: true

# å…±åŒçš„å®‰å…¨è®¾ç½®
security_config:
  firewall_enabled: true
  ssh_port: 22
  fail2ban_enabled: true
```

**databases.yml** - æ•°æ®åº“ç»„å…±åŒé…ç½®ï¼š
```yaml
# æ•°æ®åº“æœåŠ¡å™¨ç»„å…±åŒå˜é‡
database_type: "mysql"
database_version: "8.0"

# æ•°æ®åº“é€šç”¨é…ç½®
mysql_config:
  character_set: "utf8mb4"
  collation: "utf8mb4_unicode_ci"
  innodb_file_per_table: true
  
# å…±åŒçš„å¤‡ä»½é…ç½®
backup_config:
  backup_user: "backup"
  backup_time: "01:00"
  compress_backups: true
```

**all.yml** - æ‰€æœ‰æœåŠ¡å™¨å…±åŒé…ç½®ï¼š
```yaml
# æ‰€æœ‰æœåŠ¡å™¨çš„å…±åŒå˜é‡
timezone: "Asia/Shanghai"
locale: "zh_CN.UTF-8"

# åŸºç¡€è½¯ä»¶åŒ…
base_packages:
  - vim
  - htop
  - wget
  - unzip
  - ntpdate

# ç³»ç»Ÿç”¨æˆ·
system_users:
  - name: "admin"
    groups: ["wheel", "sudo"]
    shell: "/bin/bash"

# ç›‘æ§é…ç½®
monitoring:
  enabled: true
  agent: "node_exporter"
  port: 9100
```

### 3.4 ç‰¹æ®Šç»„å˜é‡ï¼šall


**allç»„çš„ç‰¹æ®Šå«ä¹‰**ï¼š
```yaml
# all.yml å¯¹æ‰€æœ‰ä¸»æœºç”Ÿæ•ˆ
# ç›¸å½“äº"å…¨å…¬å¸é€šçŸ¥"ï¼Œæ¯ä¸ªäººéƒ½è¦éµå®ˆ

# é€‚åˆæ”¾ç½®çš„å†…å®¹ï¼š
- å…¬å¸åŸŸå
- ç»Ÿä¸€æ—¶åŒºè®¾ç½®  
- åŸºç¡€å®‰å…¨é…ç½®
- é€šç”¨è½¯ä»¶åŒ…
- ç®¡ç†å‘˜è´¦æˆ·
```

---

## 4. âš–ï¸ å˜é‡ç»§æ‰¿ä¸ä¼˜å…ˆçº§


### 4.1 å˜é‡ä¼˜å…ˆçº§è§„åˆ™


**ä¼˜å…ˆçº§ä»é«˜åˆ°ä½**ï¼ˆæ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ï¼‰ï¼š

| ä¼˜å…ˆçº§ | å˜é‡æ¥æº | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|--------|----------|------|----------|
| **22** | `å‘½ä»¤è¡Œ -e` | å‘½ä»¤è¡Œç›´æ¥ä¼ å…¥ | ä¸´æ—¶è¦†ç›–å˜é‡ |
| **21** | `roleå‚æ•°` | è§’è‰²è°ƒç”¨æ—¶ä¼ å…¥ | è§’è‰²å®šåˆ¶åŒ– |
| **20** | `includeå‚æ•°` | includeæ—¶ä¼ å…¥ | åŠ¨æ€å‚æ•° |
| **19** | `set_facts` | è¿è¡Œæ—¶åŠ¨æ€è®¾ç½® | è®¡ç®—å¾—å‡ºçš„å€¼ |
| **18** | `registeredå˜é‡` | ä»»åŠ¡æ‰§è¡Œç»“æœ | æ¡ä»¶åˆ¤æ–­ä¾æ® |
| **17** | `host_vars` | ä¸»æœºä¸“æœ‰å˜é‡ | ğŸ”¥ **å•æœºå®šåˆ¶** |
| **16** | `group_vars` | ç»„å˜é‡ | ğŸ”¥ **æ‰¹é‡ç®¡ç†** |
| **15** | `play vars` | playbookä¸­å®šä¹‰ | å‰§æœ¬å†…å˜é‡ |
| **14** | `inventoryå˜é‡` | æ¸…å•ä¸­å®šä¹‰ | åŸºç¡€ä¸»æœºä¿¡æ¯ |

> ğŸ“ **è®°å¿†æ–¹æ³•**ï¼šè¶Šé è¿‘æ‰§è¡Œæ—¶åˆ»çš„å˜é‡ä¼˜å…ˆçº§è¶Šé«˜

### 4.2 å˜é‡ç»§æ‰¿å…³ç³»å›¾


```
å˜é‡ç»§æ‰¿å±‚æ¬¡ç»“æ„ï¼š

              allç»„å˜é‡ (æ‰€æœ‰ä¸»æœºç»§æ‰¿)
                  â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    webserversç»„        databasesç»„
         â”‚                  â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
   web01    web02     db01     db02
    â”‚        â”‚         â”‚        â”‚
host_vars  host_vars host_vars host_vars
(æœ€ç»ˆç”Ÿæ•ˆ) (æœ€ç»ˆç”Ÿæ•ˆ) (æœ€ç»ˆç”Ÿæ•ˆ) (æœ€ç»ˆç”Ÿæ•ˆ)

ç»§æ‰¿è§„åˆ™ï¼š
â€¢ å­çº§å˜é‡ä¼šè¦†ç›–çˆ¶çº§åŒåå˜é‡
â€¢ ä¸»æœºå˜é‡ä¼˜å…ˆçº§æœ€é«˜
â€¢ ç»„å˜é‡å½±å“ç»„å†…æ‰€æœ‰ä¸»æœº
```

### 4.3 å˜é‡è¦†ç›–å®ä¾‹


**åœºæ™¯è®¾ç½®**ï¼š
```yaml
# group_vars/all.yml
app_port: 80
app_user: "www"
app_debug: false

# group_vars/webservers.yml  
app_port: 8080        # è¦†ç›–allä¸­çš„80
app_ssl: true         # æ–°å¢å˜é‡

# host_vars/web01.yml
app_port: 9090        # è¦†ç›–webserversä¸­çš„8080
app_debug: true       # è¦†ç›–allä¸­çš„false
```

**æœ€ç»ˆç»“æœ** - web01ä¸»æœºçš„å˜é‡ï¼š
```yaml
app_port: 9090        # æ¥è‡ªhost_vars (ä¼˜å…ˆçº§æœ€é«˜)
app_user: "www"       # æ¥è‡ªall (æœªè¢«è¦†ç›–)
app_debug: true       # æ¥è‡ªhost_vars (è¦†ç›–all)
app_ssl: true         # æ¥è‡ªwebservers (ç»§æ‰¿)
```

### 4.4 å˜é‡åˆå¹¶è§„åˆ™


**ç®€å•å˜é‡**ï¼šç›´æ¥è¦†ç›–
```yaml
# group_vars/all.yml
database_port: 3306

# host_vars/db01.yml  
database_port: 3307   # ç›´æ¥è¦†ç›–ï¼Œæœ€ç»ˆå€¼ä¸º3307
```

**å¤æ‚å˜é‡**ï¼šéƒ¨åˆ†åˆå¹¶
```yaml
# group_vars/webservers.yml
nginx_config:
  worker_processes: 2
  worker_connections: 1024
  
# host_vars/web01.yml
nginx_config:
  worker_processes: 4     # è¦†ç›–
  keepalive_timeout: 65   # æ–°å¢

# æœ€ç»ˆåˆå¹¶ç»“æœï¼š
nginx_config:
  worker_processes: 4     # æ¥è‡ªhost_vars
  worker_connections: 1024 # æ¥è‡ªgroup_vars
  keepalive_timeout: 65   # æ¥è‡ªhost_vars
```

---

## 5. ğŸ“‹ å˜é‡æ–‡ä»¶ç»„ç»‡æœ€ä½³å®è·µ


### 5.1 ç›®å½•ç»“æ„æ¨è


**å°å‹é¡¹ç›®**ï¼ˆ< 10å°æœåŠ¡å™¨ï¼‰ï¼š
```
ansible-project/
â”œâ”€â”€ inventory.yml
â”œâ”€â”€ group_vars/
â”‚   â”œâ”€â”€ all.yml
â”‚   â”œâ”€â”€ webservers.yml
â”‚   â””â”€â”€ databases.yml
â”œâ”€â”€ host_vars/
â”‚   â”œâ”€â”€ web01.yml
â”‚   â””â”€â”€ db01.yml
â””â”€â”€ playbooks/
```

**ä¸­å‹é¡¹ç›®**ï¼ˆ10-50å°æœåŠ¡å™¨ï¼‰ï¼š
```
ansible-project/
â”œâ”€â”€ inventories/
â”‚   â”œâ”€â”€ production/
â”‚   â”‚   â”œâ”€â”€ hosts
â”‚   â”‚   â”œâ”€â”€ group_vars/
â”‚   â”‚   â””â”€â”€ host_vars/
â”‚   â””â”€â”€ staging/
â”‚       â”œâ”€â”€ hosts
â”‚       â”œâ”€â”€ group_vars/
â”‚       â””â”€â”€ host_vars/
â””â”€â”€ playbooks/
```

**å¤§å‹é¡¹ç›®**ï¼ˆ> 50å°æœåŠ¡å™¨ï¼‰ï¼š
```
ansible-project/
â”œâ”€â”€ inventories/
â”‚   â””â”€â”€ production/
â”‚       â”œâ”€â”€ hosts
â”‚       â”œâ”€â”€ group_vars/
â”‚       â”‚   â”œâ”€â”€ all/
â”‚       â”‚   â”‚   â”œâ”€â”€ main.yml
â”‚       â”‚   â”‚   â”œâ”€â”€ packages.yml
â”‚       â”‚   â”‚   â””â”€â”€ security.yml
â”‚       â”‚   â”œâ”€â”€ webservers/
â”‚       â”‚   â”‚   â”œâ”€â”€ main.yml
â”‚       â”‚   â”‚   â”œâ”€â”€ nginx.yml
â”‚       â”‚   â”‚   â””â”€â”€ php.yml
â”‚       â”‚   â””â”€â”€ databases/
â”‚       â”‚       â”œâ”€â”€ main.yml
â”‚       â”‚       â”œâ”€â”€ mysql.yml
â”‚       â”‚       â””â”€â”€ backup.yml
â”‚       â””â”€â”€ host_vars/
â”‚           â”œâ”€â”€ web01/
â”‚           â”‚   â”œâ”€â”€ main.yml
â”‚           â”‚   â””â”€â”€ custom.yml
â”‚           â””â”€â”€ db01/
â”‚               â”œâ”€â”€ main.yml
â”‚               â””â”€â”€ database.yml
```

### 5.2 å˜é‡å‘½åè§„èŒƒ


**å‘½ååŸåˆ™**ï¼š
```yaml
# âœ… å¥½çš„å‘½å
web_server_port: 80
database_max_connections: 100
app_environment: "production"
nginx_worker_processes: 4

# âŒ ä¸å¥½çš„å‘½å  
port: 80              # å¤ªæ³›æ³›ï¼Œä¸çŸ¥é“æ˜¯ä»€ä¹ˆç«¯å£
max: 100             # å®Œå…¨ä¸çŸ¥é“æ˜¯ä»€ä¹ˆçš„æœ€å¤§å€¼
env: "prod"          # ç¼©å†™ä¸æ¸…æ™°
workers: 4           # ä»€ä¹ˆçš„å·¥ä½œè¿›ç¨‹æ•°ï¼Ÿ
```

**å‘½åè§„åˆ™**ï¼š
- ğŸ”¤ **å…¨å°å†™**ï¼šä½¿ç”¨ä¸‹åˆ’çº¿åˆ†éš”
- ğŸ“ **æè¿°æ¸…æ™°**ï¼šè§åçŸ¥æ„
- ğŸ·ï¸ **æ·»åŠ å‰ç¼€**ï¼šæŒ‰åŠŸèƒ½æ¨¡å—åˆ†ç»„
- ğŸš« **é¿å…ç¼©å†™**ï¼šé™¤éæ˜¯é€šç”¨ç¼©å†™

**æŒ‰æ¨¡å—åˆ†ç»„ç¤ºä¾‹**ï¼š
```yaml
# æ•°æ®åº“ç›¸å…³å˜é‡
db_type: "mysql"
db_version: "8.0"
db_port: 3306
db_root_password: "{{ vault_db_root_password }}"

# WebæœåŠ¡å™¨ç›¸å…³å˜é‡  
web_server: "nginx"
web_port: 80
web_ssl_port: 443
web_document_root: "/var/www/html"

# åº”ç”¨ç›¸å…³å˜é‡
app_name: "myapp"
app_version: "2.1.0"
app_environment: "production"
app_debug: false
```

### 5.3 å˜é‡æ–‡ä»¶æ‹†åˆ†ç­–ç•¥


**æŒ‰åŠŸèƒ½æ¨¡å—æ‹†åˆ†**ï¼š
```yaml
# group_vars/webservers/main.yml - ä¸»è¦é…ç½®
web_server_type: "nginx"
document_root: "/var/www/html"

# group_vars/webservers/packages.yml - è½¯ä»¶åŒ…
web_packages:
  - nginx
  - php-fpm
  - mysql-client

# group_vars/webservers/security.yml - å®‰å…¨é…ç½®
firewall_rules:
  - port: 80
    protocol: tcp
  - port: 443  
    protocol: tcp
```

**æŒ‰ç¯å¢ƒæ‹†åˆ†**ï¼š
```yaml
# group_vars/all/main.yml - é€šç”¨é…ç½®
app_name: "myapp"
app_user: "appuser"

# group_vars/all/production.yml - ç”Ÿäº§ç¯å¢ƒ
app_debug: false
app_log_level: "warning"

# group_vars/all/staging.yml - æµ‹è¯•ç¯å¢ƒ  
app_debug: true
app_log_level: "debug"
```

---

## 6. ğŸ”’ æ•æ„Ÿå˜é‡å®‰å…¨å¤„ç†


### 6.1 ä»€ä¹ˆæ˜¯æ•æ„Ÿå˜é‡


**æ•æ„Ÿå˜é‡**åŒ…æ‹¬ï¼š
- ğŸ”‘ **å¯†ç **ï¼šæ•°æ®åº“å¯†ç ã€åº”ç”¨å¯†ç 
- ğŸ« **ä»¤ç‰Œ**ï¼šAPIå¯†é’¥ã€è®¿é—®ä»¤ç‰Œ
- ğŸ“œ **è¯ä¹¦**ï¼šSSLè¯ä¹¦ã€ç§é’¥æ–‡ä»¶
- ğŸ” **é…ç½®**ï¼šåŒ…å«æ•æ„Ÿä¿¡æ¯çš„é…ç½®

### 6.2 Ansible VaultåŸºç¡€


**Vaultæ˜¯ä»€ä¹ˆ**ï¼šAnsibleå†…ç½®çš„**åŠ å¯†å·¥å…·**ï¼Œä¸“é—¨ç”¨æ¥ä¿æŠ¤æ•æ„Ÿæ•°æ®

**åŸºæœ¬æ“ä½œ**ï¼š
```bash
# åˆ›å»ºåŠ å¯†æ–‡ä»¶
ansible-vault create secret.yml

# ç¼–è¾‘åŠ å¯†æ–‡ä»¶  
ansible-vault edit secret.yml

# æŸ¥çœ‹åŠ å¯†æ–‡ä»¶
ansible-vault view secret.yml

# åŠ å¯†ç°æœ‰æ–‡ä»¶
ansible-vault encrypt existing-file.yml

# è§£å¯†æ–‡ä»¶
ansible-vault decrypt secret.yml
```

### 6.3 æ•æ„Ÿå˜é‡ç»„ç»‡æ–¹å¼


**æ–¹å¼ä¸€ï¼šå•ç‹¬çš„vaultæ–‡ä»¶**
```
group_vars/
â”œâ”€â”€ all/
â”‚   â”œâ”€â”€ main.yml           â† æ™®é€šå˜é‡
â”‚   â””â”€â”€ vault.yml          â† åŠ å¯†çš„æ•æ„Ÿå˜é‡
â””â”€â”€ webservers/
    â”œâ”€â”€ main.yml           â† æ™®é€šå˜é‡  
    â””â”€â”€ vault.yml          â† åŠ å¯†çš„æ•æ„Ÿå˜é‡
```

**æ™®é€šå˜é‡æ–‡ä»¶** - `group_vars/all/main.yml`ï¼š
```yaml
# æ™®é€šå˜é‡ï¼Œå¯ä»¥å…¬å¼€
database_host: "db.example.com"
database_name: "myapp"
database_user: "appuser"
database_port: 3306

# å¼•ç”¨åŠ å¯†å˜é‡
database_password: "{{ vault_database_password }}"
api_key: "{{ vault_api_key }}"
```

**åŠ å¯†å˜é‡æ–‡ä»¶** - `group_vars/all/vault.yml`ï¼ˆåŠ å¯†åï¼‰ï¼š
```yaml
# è¿™ä¸ªæ–‡ä»¶ä¼šè¢«Ansible VaultåŠ å¯†
vault_database_password: "super_secret_password_123"
vault_api_key: "sk-1234567890abcdef"
vault_ssl_private_key: |
  -----BEGIN PRIVATE KEY-----
  MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQC...
  -----END PRIVATE KEY-----
```

### 6.4 ä½¿ç”¨vaultå˜é‡çš„å®è·µ


**åœ¨playbookä¸­ä½¿ç”¨**ï¼š
```yaml
- name: é…ç½®æ•°æ®åº“è¿æ¥
  template:
    src: database.conf.j2
    dest: /etc/myapp/database.conf
  vars:
    db_host: "{{ database_host }}"
    db_name: "{{ database_name }}"  
    db_user: "{{ database_user }}"
    db_pass: "{{ database_password }}"  # è¿™é‡Œå¼•ç”¨çš„æ˜¯æ™®é€šå˜é‡
```

**è¿è¡Œplaybookæ—¶**ï¼š
```bash
# å•ä¸ªvaultå¯†ç 
ansible-playbook -i inventory site.yml --ask-vault-pass

# å¯†ç æ–‡ä»¶
echo "my_vault_password" > .vault_pass
ansible-playbook -i inventory site.yml --vault-password-file .vault_pass

# ç¯å¢ƒå˜é‡
export ANSIBLE_VAULT_PASSWORD_FILE=.vault_pass  
ansible-playbook -i inventory site.yml
```

### 6.5 æ•æ„Ÿå˜é‡æœ€ä½³å®è·µ


**å®‰å…¨åŸåˆ™**ï¼š
```yaml
# âœ… å¥½çš„åšæ³•
vault_mysql_root_password: "complex_password_123!@#"
mysql_root_password: "{{ vault_mysql_root_password }}"

# âŒ ä¸å¥½çš„åšæ³•
mysql_root_password: "123456"  # æ˜æ–‡å¯†ç 
```

**æ–‡ä»¶æƒé™è®¾ç½®**ï¼š
```bash
# è®¾ç½®vaultæ–‡ä»¶æƒé™
chmod 600 group_vars/all/vault.yml
chmod 600 .vault_pass

# Gitå¿½ç•¥æ•æ„Ÿæ–‡ä»¶
echo ".vault_pass" >> .gitignore
echo "*.pem" >> .gitignore
```

**å˜é‡å‘½åçº¦å®š**ï¼š
- åŠ å¯†å˜é‡ä»¥ `vault_` å¼€å¤´
- æ™®é€šå˜é‡å¼•ç”¨vaultå˜é‡
- ä¿æŒå˜é‡åå¯¹åº”å…³ç³»æ¸…æ™°

---

## 7. ğŸš€ å®é™…åº”ç”¨åœºæ™¯


### 7.1 Webåº”ç”¨éƒ¨ç½²åœºæ™¯


**é¡¹ç›®èƒŒæ™¯**ï¼šéƒ¨ç½²ä¸€ä¸ªWebåº”ç”¨åˆ°å¤šå°æœåŠ¡å™¨

**inventoryé…ç½®**ï¼š
```ini
[webservers]
web01.example.com
web02.example.com

[databases]  
db01.example.com

[loadbalancers]
lb01.example.com
```

**å˜é‡é…ç½®ç»“æ„**ï¼š
```
group_vars/
â”œâ”€â”€ all.yml              â† æ‰€æœ‰æœåŠ¡å™¨é€šç”¨é…ç½®
â”œâ”€â”€ webservers.yml       â† WebæœåŠ¡å™¨ç»„é…ç½®
â”œâ”€â”€ databases.yml        â† æ•°æ®åº“ç»„é…ç½®
â””â”€â”€ loadbalancers.yml    â† è´Ÿè½½å‡è¡¡å™¨ç»„é…ç½®

host_vars/
â”œâ”€â”€ web01.yml           â† web01ç‰¹æ®Šé…ç½®
â”œâ”€â”€ web02.yml           â† web02ç‰¹æ®Šé…ç½®
â””â”€â”€ db01.yml            â† db01ç‰¹æ®Šé…ç½®
```

**å…·ä½“å˜é‡è®¾ç½®**ï¼š

`group_vars/all.yml`ï¼š
```yaml
# é€šç”¨ç³»ç»Ÿé…ç½®
timezone: "Asia/Shanghai"
ntp_server: "pool.ntp.org"

# åº”ç”¨åŸºç¡€ä¿¡æ¯
app_name: "mywebapp"
app_version: "2.1.0"
app_user: "webuser"
app_group: "webgroup"

# åŸºç¡€è½¯ä»¶åŒ…
base_packages:
  - git
  - curl
  - vim
  - htop
```

`group_vars/webservers.yml`ï¼š
```yaml
# WebæœåŠ¡å™¨é…ç½®
web_server: "nginx"
web_port: 80
web_ssl_port: 443
document_root: "/var/www/{{ app_name }}"

# PHPé…ç½®
php_version: "8.1"
php_memory_limit: "256M"
php_max_execution_time: 300

# WebæœåŠ¡å™¨è½¯ä»¶åŒ…
web_packages:
  - nginx
  - "php{{ php_version }}-fpm"
  - "php{{ php_version }}-mysql"
  - "php{{ php_version }}-curl"
```

`host_vars/web01.yml`ï¼š
```yaml
# web01ä½œä¸ºä¸»WebæœåŠ¡å™¨
server_role: "primary"
nginx_worker_processes: 4

# SSLè¯ä¹¦ï¼ˆä¸»æœåŠ¡å™¨æ‰¿æ‹…HTTPSï¼‰
ssl_certificate_path: "/etc/ssl/certs/web01.crt"
ssl_private_key_path: "/etc/ssl/private/web01.key"

# ç‰¹æ®Šé…ç½®
custom_nginx_configs:
  - ssl_session_cache
  - ssl_stapling
```

### 7.2 å¤šç¯å¢ƒç®¡ç†åœºæ™¯


**åœºæ™¯**ï¼šåŒä¸€åº”ç”¨éƒ¨ç½²åˆ°å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒ

**inventoryç»“æ„**ï¼š
```
inventories/
â”œâ”€â”€ production/
â”‚   â”œâ”€â”€ hosts
â”‚   â”œâ”€â”€ group_vars/
â”‚   â””â”€â”€ host_vars/
â”œâ”€â”€ staging/  
â”‚   â”œâ”€â”€ hosts
â”‚   â”œâ”€â”€ group_vars/
â”‚   â””â”€â”€ host_vars/
â””â”€â”€ development/
    â”œâ”€â”€ hosts
    â”œâ”€â”€ group_vars/
    â””â”€â”€ host_vars/
```

**ç”Ÿäº§ç¯å¢ƒå˜é‡** - `production/group_vars/all.yml`ï¼š
```yaml
environment: "production"
app_debug: false
app_log_level: "error"
database_host: "prod-db.example.com"
redis_host: "prod-redis.example.com"

# ç”Ÿäº§ç¯å¢ƒæ€§èƒ½é…ç½®
php_memory_limit: "512M"
nginx_worker_processes: 8
mysql_max_connections: 1000
```

**æµ‹è¯•ç¯å¢ƒå˜é‡** - `staging/group_vars/all.yml`ï¼š
```yaml
environment: "staging"  
app_debug: true
app_log_level: "debug"
database_host: "test-db.example.com"
redis_host: "test-redis.example.com"

# æµ‹è¯•ç¯å¢ƒè½»é‡é…ç½®
php_memory_limit: "256M" 
nginx_worker_processes: 2
mysql_max_connections: 100
```

**éƒ¨ç½²å‘½ä»¤**ï¼š
```bash
# éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
ansible-playbook -i inventories/production site.yml

# éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ  
ansible-playbook -i inventories/staging site.yml
```

### 7.3 å˜é‡æ¨¡æ¿åŒ–åº”ç”¨


**é…ç½®æ¨¡æ¿** - `templates/nginx.conf.j2`ï¼š
```nginx
server {
    listen {{ web_port }};
    {% if ssl_enabled %}
    listen {{ web_ssl_port }} ssl;
    ssl_certificate {{ ssl_certificate_path }};
    ssl_certificate_key {{ ssl_private_key_path }};
    {% endif %}
    
    server_name {{ server_name }};
    root {{ document_root }};
    
    # æ ¹æ®æœåŠ¡å™¨è§’è‰²è®¾ç½®ä¸åŒé…ç½®
    {% if server_role == "primary" %}
    # ä¸»æœåŠ¡å™¨ç‰¹æ®Šé…ç½®
    location /admin {
        allow 192.168.1.0/24;
        deny all;
    }
    {% endif %}
    
    # PHPå¤„ç†
    location ~ \.php$ {
        fastcgi_pass 127.0.0.1:9000;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param APP_ENV {{ environment }};
        include fastcgi_params;
    }
}
```

é€šè¿‡å˜é‡ï¼ŒåŒä¸€ä¸ªæ¨¡æ¿å¯ä»¥ç”Ÿæˆä¸åŒæœåŠ¡å™¨çš„ä¸ªæ€§åŒ–é…ç½®æ–‡ä»¶ã€‚

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ”¸ host_varsï¼šå•ä¸ªä¸»æœºä¸“æœ‰å˜é‡ï¼Œä¼˜å…ˆçº§æœ€é«˜
ğŸ”¸ group_varsï¼šä¸»æœºç»„å…±åŒå˜é‡ï¼Œæ‰¹é‡ç®¡ç†åˆ©å™¨
ğŸ”¸ å˜é‡ç»§æ‰¿ï¼šå­çº§è¦†ç›–çˆ¶çº§ï¼Œè¿‘è€…ä¼˜å…ˆåŸåˆ™
ğŸ”¸ æ–‡ä»¶ç»„ç»‡ï¼šæŒ‰åŠŸèƒ½æ¨¡å—æ‹†åˆ†ï¼Œä¿æŒç»“æ„æ¸…æ™°
ğŸ”¸ æ•æ„Ÿæ•°æ®ï¼šä½¿ç”¨VaultåŠ å¯†ï¼Œä¿æŠ¤é‡è¦ä¿¡æ¯
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å˜é‡ä¼˜å…ˆçº§è®°å¿†æ³•**
```
è·ç¦»æ‰§è¡Œè¶Šè¿‘ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼š
å‘½ä»¤è¡Œå‚æ•° > ä¸»æœºå˜é‡ > ç»„å˜é‡ > å…¨å±€å˜é‡

è®°ä½ï¼šä¸ªäººè®¾ç½® > éƒ¨é—¨è®¾ç½® > å…¬å¸è®¾ç½®
```

**ğŸ”¹ ç›®å½•ç»“æ„é€‰æ‹©**
```
å°é¡¹ç›®ï¼šå•æ–‡ä»¶æ¨¡å¼ï¼Œç®€å•ç›´æ¥
å¤§é¡¹ç›®ï¼šç›®å½•æ¨¡å¼ï¼Œåˆ†ç±»ç®¡ç†
å¤šç¯å¢ƒï¼šç‹¬ç«‹inventoryï¼Œéš”ç¦»é…ç½®
```

**ğŸ”¹ å˜é‡å‘½ååŸåˆ™**
```
è§åçŸ¥æ„ï¼šdatabase_port æ¯” port å¥½
ç»Ÿä¸€å‰ç¼€ï¼šdb_userã€db_passã€db_host
é¿å…å†²çªï¼šä½¿ç”¨æ¨¡å—å‰ç¼€åŒºåˆ†åŠŸèƒ½
```

### 8.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ è§£å†³çš„æ ¸å¿ƒé—®é¢˜**
- **é…ç½®ç®¡ç†**ï¼šç»Ÿä¸€ç®¡ç†å¤§é‡æœåŠ¡å™¨é…ç½®
- **ç¯å¢ƒéš”ç¦»**ï¼šä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒå˜é‡å€¼  
- **æ‰¹é‡æ“ä½œ**ï¼šç»„å˜é‡å®ç°æ‰¹é‡é…ç½®ä¿®æ”¹
- **ä¸ªæ€§åŒ–å®šåˆ¶**ï¼šä¸»æœºå˜é‡æ»¡è¶³ç‰¹æ®Šéœ€æ±‚
- **å®‰å…¨ä¿æŠ¤**ï¼švaultåŠ å¯†ä¿æŠ¤æ•æ„Ÿä¿¡æ¯

**ğŸ”§ æœ€ä½³å®è·µæ€»ç»“**
- **ç»“æ„æ¸…æ™°**ï¼šåˆç†çš„ç›®å½•ç»„ç»‡å’Œæ–‡ä»¶å‘½å
- **èŒè´£åˆ†æ˜**ï¼šall < ç»„ < ä¸»æœºçš„å˜é‡å±‚æ¬¡
- **å®‰å…¨ç¬¬ä¸€**ï¼šæ•æ„Ÿå˜é‡å¿…é¡»åŠ å¯†å­˜å‚¨
- **æ–‡æ¡£å®Œæ•´**ï¼šå˜é‡å«ä¹‰å’Œç”¨é€”è¦å†™æ¸…æ¥š
- **ç‰ˆæœ¬æ§åˆ¶**ï¼šå˜é‡æ–‡ä»¶çº³å…¥Gitç®¡ç†ï¼ˆé™¤æ•æ„Ÿæ–‡ä»¶ï¼‰

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- ä¸»æœºå˜é‡ç®¡å•æœºï¼Œç»„å˜é‡ç®¡ä¸€ç‰‡
- ä¼˜å…ˆçº§çœ‹è¿œè¿‘ï¼Œè¶Šè¿‘è¶Šä¼˜å…ˆ
- æ•æ„Ÿæ•°æ®è¦åŠ å¯†ï¼Œå®‰å…¨ç¬¬ä¸€ä¸èƒ½å¿˜
- ç»“æ„æ¸…æ™°æ˜“ç»´æŠ¤ï¼Œè§åçŸ¥æ„æœ€é‡è¦