---
title: 2ã€inventory-åŠ¨æ€æ¸…å•
---
## ğŸ“š ç›®å½•å¯¼èˆª

1. [åŠ¨æ€æ¸…å•åŸºç¡€æ¦‚å¿µ](#1-åŠ¨æ€æ¸…å•åŸºç¡€æ¦‚å¿µ)
2. [å·¥ä½œåŸç†ä¸æœºåˆ¶](#2-å·¥ä½œåŸç†ä¸æœºåˆ¶)
3. [äº‘å¹³å°æ’ä»¶åº”ç”¨](#3-äº‘å¹³å°æ’ä»¶åº”ç”¨)
4. [è„šæœ¬æ¸…å•å¼€å‘](#4-è„šæœ¬æ¸…å•å¼€å‘)
5. [ä¼ä¸šçº§åº”ç”¨å®è·µ](#5-ä¼ä¸šçº§åº”ç”¨å®è·µ)
6. [æ··åˆæ¨¡å¼æœ€ä½³å®è·µ](#6-æ··åˆæ¨¡å¼æœ€ä½³å®è·µ)

---

## 1. ğŸ¯ åŠ¨æ€æ¸…å•åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯åŠ¨æ€æ¸…å•


â±ï¸ **é¢„è®¡å­¦ä¹ æ—¶é—´**: 10åˆ†é’Ÿ  
ğŸ“– **å‰ç½®çŸ¥è¯†**: AnsibleåŸºç¡€ã€é™æ€inventory  
ğŸ¯ **å­¦ä¹ ç›®æ ‡**: ç†è§£åŠ¨æ€æ¸…å•çš„æœ¬è´¨å’Œä½¿ç”¨åœºæ™¯

**ğŸ”¸ æ ¸å¿ƒå®šä¹‰**

åŠ¨æ€æ¸…å•ï¼ˆDynamic Inventoryï¼‰å°±æ˜¯è®©Ansibleèƒ½å¤Ÿ**è‡ªåŠ¨è·å–**å’Œ**å®æ—¶æ›´æ–°**ä¸»æœºä¿¡æ¯ï¼Œè€Œä¸éœ€è¦æ‰‹åŠ¨ç»´æŠ¤ä¸€ä¸ªå›ºå®šçš„ä¸»æœºåˆ—è¡¨æ–‡ä»¶ã€‚

ğŸŒ° **ç”Ÿæ´»ç±»æ¯”**: æƒ³è±¡ä½ è¦ç»™å…¨ç­åŒå­¦å‘é€šçŸ¥ï¼Œé™æ€æ¸…å•å°±åƒæ˜¯ä¸€ä»½å›ºå®šçš„èŠ±åå†Œï¼Œè€ŒåŠ¨æ€æ¸…å•å°±åƒæ˜¯å®æ—¶æŸ¥è¯¢å­¦æ ¡ç³»ç»Ÿè·å–å½“å‰åœ¨æ ¡å­¦ç”Ÿåå•ã€‚

**ğŸ”¸ ä¸ºä»€ä¹ˆéœ€è¦åŠ¨æ€æ¸…å•**

```
ä¼ ç»Ÿé™æ€æ¸…å•çš„ç—›ç‚¹:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ‰‹åŠ¨ç»´æŠ¤å›°éš¾    â”‚    â”‚   ä¿¡æ¯å®¹æ˜“è¿‡æœŸ   â”‚    â”‚   æ‰©å±•æ€§å·®      â”‚
â”‚                â”‚    â”‚                â”‚    â”‚                â”‚
â”‚ æœåŠ¡å™¨å¢å‡éœ€è¦   â”‚    â”‚ IPåœ°å€å˜åŒ–æ— æ³•   â”‚    â”‚ äº‘ç¯å¢ƒåŠ¨æ€ä¼¸ç¼©   â”‚
â”‚ æ‰‹åŠ¨ä¿®æ”¹æ–‡ä»¶     â”‚    â”‚ åŠæ—¶åŒæ­¥æ›´æ–°     â”‚    â”‚ éš¾ä»¥é€‚åº”        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”¸ åŠ¨æ€æ¸…å•çš„ä¼˜åŠ¿**

- âœ… **è‡ªåŠ¨å‘ç°**: æ— éœ€æ‰‹åŠ¨æ·»åŠ æ–°æœåŠ¡å™¨
- âœ… **å®æ—¶æ›´æ–°**: ä¿¡æ¯å§‹ç»ˆä¿æŒæœ€æ–°çŠ¶æ€  
- âœ… **äº‘åŸç”Ÿ**: å®Œç¾é€‚é…å„ç§äº‘å¹³å°
- âœ… **å‡å°‘é”™è¯¯**: é¿å…æ‰‹åŠ¨ç»´æŠ¤å¸¦æ¥çš„ç–æ¼

### 1.2 åŠ¨æ€æ¸…å•çš„æœ¬è´¨


**ğŸ”¸ æœ¬è´¨ç†è§£**

åŠ¨æ€æ¸…å•å…¶å®å°±æ˜¯ä¸€ä¸ª**èƒ½å¤Ÿè¿”å›JSONæ ¼å¼ä¸»æœºä¿¡æ¯çš„ç¨‹åº**ï¼Œè¿™ä¸ªç¨‹åºå¯ä»¥æ˜¯ï¼š
- ğŸ Pythonè„šæœ¬
- ğŸ”Œ å®˜æ–¹æ’ä»¶
- ğŸŒ APIæ¥å£è°ƒç”¨
- ğŸ“‹ æ•°æ®åº“æŸ¥è¯¢

**ğŸ”¸ å·¥ä½œæ—¶æœº**

```
Ansibleæ‰§è¡Œæµç¨‹ä¸­çš„ä½ç½®:
ansible-playbookæ‰§è¡Œ â†’ è¯»å–æ¸…å•ä¿¡æ¯ â†’ è¿æ¥ç›®æ ‡ä¸»æœº â†’ æ‰§è¡Œä»»åŠ¡

åŠ¨æ€æ¸…å•åœ¨ç¬¬äºŒæ­¥å‘æŒ¥ä½œç”¨ï¼Œå®æ—¶è·å–æœ€æ–°çš„ä¸»æœºä¿¡æ¯
```

---

## 2. âš™ï¸ å·¥ä½œåŸç†ä¸æœºåˆ¶


### 2.1 JSONæ ¼å¼è¾“å‡ºæ ‡å‡†


**ğŸ”¸ æ ‡å‡†è¾“å‡ºæ ¼å¼**

åŠ¨æ€æ¸…å•è„šæœ¬å¿…é¡»èƒ½å¤Ÿè¾“å‡ºæ ‡å‡†çš„JSONæ ¼å¼æ•°æ®ï¼ŒåŒ…å«ä¸¤ç§ä¿¡æ¯ï¼š

1. **`--list`å‚æ•°**: è¿”å›æ‰€æœ‰ä¸»æœºå’Œç»„ä¿¡æ¯
2. **`--host`å‚æ•°**: è¿”å›ç‰¹å®šä¸»æœºçš„è¯¦ç»†å˜é‡

```json
{
  "webservers": {
    "hosts": ["web1.example.com", "web2.example.com"],
    "vars": {
      "http_port": 80,
      "nginx_version": "1.18"
    }
  },
  "databases": {
    "hosts": ["db1.example.com", "db2.example.com"],
    "vars": {
      "mysql_port": 3306
    }
  },
  "_meta": {
    "hostvars": {
      "web1.example.com": {
        "ansible_host": "192.168.1.10",
        "role": "frontend"
      },
      "web2.example.com": {
        "ansible_host": "192.168.1.11", 
        "role": "frontend"
      }
    }
  }
}
```

**ğŸ”¸ å…³é”®å­—æ®µè¯´æ˜**

- **`hosts`**: ç»„å†…ä¸»æœºåˆ—è¡¨
- **`vars`**: ç»„çº§åˆ«å˜é‡
- **`_meta.hostvars`**: ä¸»æœºçº§åˆ«å˜é‡ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
- **`children`**: å­ç»„å®šä¹‰ï¼ˆå¯é€‰ï¼‰

### 2.2 è„šæœ¬è°ƒç”¨æœºåˆ¶


**ğŸ”¸ Ansibleå¦‚ä½•è°ƒç”¨åŠ¨æ€æ¸…å•**

```bash
# Ansibleå†…éƒ¨çš„è°ƒç”¨æµç¨‹

inventory_script.py --list     # è·å–æ‰€æœ‰ä¸»æœºä¿¡æ¯
inventory_script.py --host web1.example.com  # è·å–ç‰¹å®šä¸»æœºå˜é‡
```

**ğŸ”¸ è„šæœ¬æ‰§è¡Œè¦æ±‚**

- ğŸ è„šæœ¬å¿…é¡»æœ‰æ‰§è¡Œæƒé™
- ğŸ“ å¿…é¡»æ”¯æŒ`--list`å’Œ`--host`å‚æ•°
- ğŸ”„ è¾“å‡ºå¿…é¡»æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼
- âš¡ æ‰§è¡Œæ—¶é—´ä¸å®œè¿‡é•¿ï¼ˆå½±å“æ€§èƒ½ï¼‰

### 2.3 ç¼“å­˜æœºåˆ¶ä¼˜åŒ–


**ğŸ”¸ ä¸ºä»€ä¹ˆéœ€è¦ç¼“å­˜**

```
æ²¡æœ‰ç¼“å­˜çš„é—®é¢˜:
æ¯æ¬¡ansibleå‘½ä»¤ â†’ é‡æ–°è°ƒç”¨è„šæœ¬ â†’ é‡æ–°æŸ¥è¯¢æ•°æ®æº â†’ æ€§èƒ½ä½ä¸‹

å¯ç”¨ç¼“å­˜å:
ç¬¬ä¸€æ¬¡è°ƒç”¨ â†’ ç¼“å­˜ç»“æœ â†’ åç»­ä½¿ç”¨ç¼“å­˜ â†’ æ€§èƒ½æå‡
```

**ğŸ”¸ ç¼“å­˜é…ç½®**

```ini
# ansible.cfg ä¸­çš„ç¼“å­˜é…ç½®

[inventory]
cache = True
cache_plugin = memory
cache_timeout = 3600
cache_connection = /tmp/ansible_inventory_cache
```

---

## 3. ğŸŒ äº‘å¹³å°æ’ä»¶åº”ç”¨


### 3.1 AWS EC2 åŠ¨æ€æ¸…å•


**ğŸ”¸ æ’ä»¶å®‰è£…ä¸é…ç½®**

AWS EC2æ’ä»¶æ˜¯Ansibleå®˜æ–¹æä¾›çš„æˆç†Ÿè§£å†³æ–¹æ¡ˆï¼Œèƒ½å¤Ÿè‡ªåŠ¨å‘ç°EC2å®ä¾‹å¹¶ç”Ÿæˆæ¸…å•ã€‚

```bash
# å®‰è£…AWSç›¸å…³ä¾èµ–

pip install boto3 botocore
```

**ğŸ”¸ é…ç½®æ–‡ä»¶ç¤ºä¾‹**

åˆ›å»º `aws_ec2.yml` é…ç½®æ–‡ä»¶ï¼š

```yaml
# aws_ec2.yml - AWSåŠ¨æ€æ¸…å•é…ç½®

plugin: aws_ec2

regions:
  - us-east-1
  - us-west-2

# æŒ‰æ ‡ç­¾åˆ†ç»„

keyed_groups:
  - key: tags.Environment
    prefix: env
    separator: '_'
  - key: tags.Application  
    prefix: app
    separator: '_'

# ä¸»æœºåè§„åˆ™

hostnames:
  - tag:Name
  - dns-name
  - private-ip-address

# å®ä¾‹çŠ¶æ€è¿‡æ»¤

filters:
  instance-state-name: running
```

**ğŸ”¸ ä½¿ç”¨æ–¹å¼**

```bash
# ä½¿ç”¨AWSåŠ¨æ€æ¸…å•

ansible-inventory -i aws_ec2.yml --list
ansible-playbook -i aws_ec2.yml site.yml
```

### 3.2 é˜¿é‡Œäº‘ECSåŠ¨æ€æ¸…å•


**ğŸ”¸ é˜¿é‡Œäº‘æ’ä»¶é…ç½®**

```yaml
# alicloud_ecs.yml - é˜¿é‡Œäº‘åŠ¨æ€æ¸…å•é…ç½®  

plugin: alicloud_ecs

regions:
  - cn-beijing
  - cn-shanghai

# è®¤è¯é…ç½®

access_key_id: "{{ lookup('env', 'ALIBABA_CLOUD_ACCESS_KEY_ID') }}"
access_key_secret: "{{ lookup('env', 'ALIBABA_CLOUD_ACCESS_KEY_SECRET') }}"

# æŒ‰æ ‡ç­¾åˆ†ç»„

keyed_groups:
  - key: tags.env
    prefix: environment
  - key: tags.project
    prefix: project

# è¿‡æ»¤æ¡ä»¶

filters:
  - status: Running
```

### 3.3 Google Cloud Platform


**ğŸ”¸ GCPæ’ä»¶åŸºæœ¬é…ç½®**

```yaml
# gcp_compute.yml - GCPåŠ¨æ€æ¸…å•é…ç½®

plugin: gcp_compute

projects:
  - my-gcp-project-1
  - my-gcp-project-2

regions:
  - us-central1
  - asia-east1

# æœåŠ¡è´¦æˆ·è®¤è¯

service_account_file: /path/to/service-account.json

# æŒ‰æ ‡ç­¾å’ŒåŒºåŸŸåˆ†ç»„

keyed_groups:
  - key: labels.environment
    prefix: env
  - key: zone
    prefix: zone
```

---

## 4. ğŸ è„šæœ¬æ¸…å•å¼€å‘


### 4.1 ç®€å•åŠ¨æ€æ¸…å•è„šæœ¬


**ğŸ”¸ åŸºç¡€è„šæœ¬ç»“æ„**

åˆ›å»ºä¸€ä¸ªä»æ•°æ®åº“è¯»å–ä¸»æœºä¿¡æ¯çš„åŠ¨æ€æ¸…å•è„šæœ¬ï¼š

```python
#!/usr/bin/env python3

# -*- coding: utf-8 -*-


import json
import argparse
import sqlite3

class DatabaseInventory:
    def __init__(self):
        self.inventory = {}
        self.db_path = '/var/lib/ansible/hosts.db'
    
    def load_inventory(self):
        """ä»æ•°æ®åº“åŠ è½½ä¸»æœºä¿¡æ¯"""
        try:
            conn = sqlite3.connect(self.db_path)
            cursor = conn.cursor()
            
#            # æŸ¥è¯¢ä¸»æœºä¿¡æ¯
            cursor.execute("""
                SELECT hostname, ip, group_name, environment, role 
                FROM hosts WHERE status = 'active'
            """)
            
            hosts = cursor.fetchall()
            groups = {}
            hostvars = {}
            
#            # ç»„ç»‡æ•°æ®ç»“æ„
            for host in hosts:
                hostname, ip, group_name, env, role = host
                
#                # åˆ›å»ºç»„
                if group_name not in groups:
                    groups[group_name] = {'hosts': [], 'vars': {}}
                groups[group_name]['hosts'].append(hostname)
                
#                # ä¸»æœºå˜é‡
                hostvars[hostname] = {
                    'ansible_host': ip,
                    'environment': env,
                    'role': role
                }
            
#            # æ„å»ºæœ€ç»ˆæ¸…å•
            self.inventory = groups
            self.inventory['_meta'] = {'hostvars': hostvars}
            
            conn.close()
            
        except Exception as e:
#            # å‘ç”Ÿé”™è¯¯æ—¶è¿”å›ç©ºæ¸…å•
            self.inventory = {'_meta': {'hostvars': {}}}
    
    def get_inventory(self):
        """è¿”å›å®Œæ•´æ¸…å•"""
        self.load_inventory()
        return self.inventory
    
    def get_host_vars(self, hostname):
        """è¿”å›ç‰¹å®šä¸»æœºå˜é‡"""
        self.load_inventory()
        return self.inventory.get('_meta', {}).get('hostvars', {}).get(hostname, {})

def main():
#    # å‚æ•°è§£æ
    parser = argparse.ArgumentParser(description='Database Inventory Script')
    parser.add_argument('--list', action='store_true', help='List all hosts')
    parser.add_argument('--host', help='Get variables for specific host')
    args = parser.parse_args()
    
    inventory = DatabaseInventory()
    
    if args.list:
#        # è¿”å›æ‰€æœ‰ä¸»æœºæ¸…å•
        print(json.dumps(inventory.get_inventory(), indent=2))
    elif args.host:
#        # è¿”å›ç‰¹å®šä¸»æœºå˜é‡
        print(json.dumps(inventory.get_host_vars(args.host), indent=2))
    else:
#        # é»˜è®¤è¿”å›ç©ºç»“æœ
        print(json.dumps({}))

if __name__ == '__main__':
    main()
```

**ğŸ”¸ è„šæœ¬ä½¿ç”¨æ–¹æ³•**

```bash
# è®¾ç½®æ‰§è¡Œæƒé™

chmod +x database_inventory.py

# æµ‹è¯•è„šæœ¬åŠŸèƒ½

./database_inventory.py --list
./database_inventory.py --host web1.example.com

# åœ¨Ansibleä¸­ä½¿ç”¨

ansible-playbook -i database_inventory.py site.yml
```

### 4.2 APIé›†æˆåŠ¨æ€æ¸…å•


**ğŸ”¸ ä»REST APIè·å–ä¸»æœºä¿¡æ¯**

```python
#!/usr/bin/env python3


import json
import requests
import argparse
from urllib.parse import urljoin

class APIInventory:
    def __init__(self):
        self.api_base = 'http://cmdb.company.com/api/v1/'
        self.api_token = 'your-api-token-here'
        self.headers = {
            'Authorization': f'Bearer {self.api_token}',
            'Content-Type': 'application/json'
        }
    
    def fetch_hosts(self):
        """ä»APIè·å–ä¸»æœºæ•°æ®"""
        try:
#            # è°ƒç”¨CMDB API
            response = requests.get(
                urljoin(self.api_base, 'hosts'),
                headers=self.headers,
                timeout=10
            )
            response.raise_for_status()
            return response.json()
            
        except requests.RequestException as e:
            print(f"APIè°ƒç”¨å¤±è´¥: {e}", file=sys.stderr)
            return []
    
    def build_inventory(self):
        """æ„å»ºAnsibleæ¸…å•æ ¼å¼"""
        hosts_data = self.fetch_hosts()
        inventory = {'_meta': {'hostvars': {}}}
        
        for host in hosts_data:
            hostname = host['hostname']
            group_name = host.get('group', 'ungrouped')
            
#            # åˆ›å»ºç»„
            if group_name not in inventory:
                inventory[group_name] = {'hosts': []}
            
            inventory[group_name]['hosts'].append(hostname)
            
#            # ä¸»æœºå˜é‡
            inventory['_meta']['hostvars'][hostname] = {
                'ansible_host': host['ip_address'],
                'ansible_user': host.get('ssh_user', 'root'),
                'environment': host.get('environment', 'unknown'),
                'datacenter': host.get('datacenter', 'unknown')
            }
        
        return inventory
```

---

## 5. ğŸ¢ ä¼ä¸šçº§åº”ç”¨å®è·µ


### 5.1 CMDBé›†æˆæ–¹æ¡ˆ


**ğŸ”¸ ä¼ä¸šCMDBé›†æˆæ¶æ„**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Ansible       â”‚â”€â”€â”€â–¶â”‚  åŠ¨æ€æ¸…å•è„šæœ¬    â”‚â”€â”€â”€â–¶â”‚    ä¼ä¸šCMDB     â”‚
â”‚   Controller    â”‚    â”‚                â”‚    â”‚                â”‚
â”‚                â”‚    â”‚  - è®¤è¯å¤„ç†      â”‚    â”‚ - ä¸»æœºä¿¡æ¯      â”‚
â”‚ - æ‰§è¡Œplaybook  â”‚    â”‚  - æ•°æ®è½¬æ¢      â”‚    â”‚ - é…ç½®å±æ€§      â”‚
â”‚ - ä»»åŠ¡è°ƒåº¦      â”‚    â”‚  - ç¼“å­˜ä¼˜åŒ–      â”‚    â”‚ - å…³ç³»æ˜ å°„      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”¸ CMDBæ•°æ®æ˜ å°„ç­–ç•¥**

ä¼ä¸šCMDBé€šå¸¸åŒ…å«ä¸°å¯Œçš„èµ„äº§ä¿¡æ¯ï¼Œéœ€è¦åˆç†æ˜ å°„åˆ°Ansibleå˜é‡ï¼š

| CMDBå­—æ®µ | **Ansibleå˜é‡** | **ç”¨é€”è¯´æ˜** |
|---------|----------------|-------------|
| `server_ip` | `ansible_host` | `SSHè¿æ¥åœ°å€` |
| `environment` | `env` | `ç¯å¢ƒæ ‡è¯†ï¼ˆprod/test/devï¼‰` |
| `business_unit` | `bu` | `ä¸šåŠ¡å•å…ƒåˆ†ç»„` |
| `os_type` | `ansible_os_family` | `æ“ä½œç³»ç»Ÿç±»å‹` |
| `service_port` | `app_port` | `åº”ç”¨ç«¯å£é…ç½®` |

### 5.2 å¤šæ•°æ®æºèåˆ


**ğŸ”¸ æ··åˆæ•°æ®æºå¤„ç†**

å®é™…ä¼ä¸šç¯å¢ƒä¸­ï¼Œä¸»æœºä¿¡æ¯å¯èƒ½æ¥è‡ªå¤šä¸ªæ•°æ®æºï¼š

```python
class HybridInventory:
    def __init__(self):
        self.sources = {
            'cmdb': CMDBSource(),
            'aws': AWSSource(), 
            'vmware': VMwareSource(),
            'manual': ManualSource()
        }
    
    def merge_inventories(self):
        """åˆå¹¶å¤šä¸ªæ•°æ®æº"""
        merged = {'_meta': {'hostvars': {}}}
        
        for source_name, source in self.sources.items():
            source_inventory = source.get_inventory()
            
#            # åˆå¹¶ç»„ä¿¡æ¯
            for group, group_data in source_inventory.items():
                if group == '_meta':
                    continue
                    
                if group not in merged:
                    merged[group] = {'hosts': [], 'vars': {}}
                
#                # å»é‡æ·»åŠ ä¸»æœº
                for host in group_data.get('hosts', []):
                    if host not in merged[group]['hosts']:
                        merged[group]['hosts'].append(host)
                
#                # åˆå¹¶ç»„å˜é‡
                merged[group]['vars'].update(group_data.get('vars', {}))
            
#            # åˆå¹¶ä¸»æœºå˜é‡  
            source_hostvars = source_inventory.get('_meta', {}).get('hostvars', {})
            merged['_meta']['hostvars'].update(source_hostvars)
        
        return merged
```

### 5.3 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥


**ğŸ”¸ ç¼“å­˜æœºåˆ¶è®¾è®¡**

```python
import pickle
import os
import time

class CachedInventory:
    def __init__(self, cache_timeout=300):
        self.cache_timeout = cache_timeout  # 5åˆ†é’Ÿç¼“å­˜
        self.cache_file = '/tmp/ansible_inventory_cache.pkl'
    
    def is_cache_valid(self):
        """æ£€æŸ¥ç¼“å­˜æ˜¯å¦æœ‰æ•ˆ"""
        if not os.path.exists(self.cache_file):
            return False
        
        file_age = time.time() - os.path.getmtime(self.cache_file)
        return file_age < self.cache_timeout
    
    def load_cache(self):
        """åŠ è½½ç¼“å­˜æ•°æ®"""
        try:
            with open(self.cache_file, 'rb') as f:
                return pickle.load(f)
        except:
            return None
    
    def save_cache(self, data):
        """ä¿å­˜ç¼“å­˜æ•°æ®"""
        try:
            with open(self.cache_file, 'wb') as f:
                pickle.dump(data, f)
        except:
            pass  # ç¼“å­˜å¤±è´¥ä¸å½±å“ä¸»åŠŸèƒ½
```

---

## 6. ğŸ”„ æ··åˆæ¨¡å¼æœ€ä½³å®è·µ


### 6.1 é™æ€ä¸åŠ¨æ€ç»“åˆ


**ğŸ”¸ æ··åˆæ¸…å•æ¶æ„**

åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¾€å¾€éœ€è¦å°†é™æ€æ¸…å•å’ŒåŠ¨æ€æ¸…å•ç»“åˆä½¿ç”¨ï¼š

```
é¡¹ç›®æ¸…å•ç›®å½•ç»“æ„:
inventory/
â”œâ”€â”€ static_hosts.yml          # é™æ€ä¸»æœºï¼ˆå¦‚è·³æ¿æœºã€ç‰¹æ®Šè®¾å¤‡ï¼‰
â”œâ”€â”€ aws_ec2.yml              # AWSåŠ¨æ€æ¸…å•
â”œâ”€â”€ cmdb_inventory.py        # CMDBåŠ¨æ€æ¸…å•
â””â”€â”€ group_vars/              # ç»„å˜é‡ç›®å½•
    â”œâ”€â”€ all.yml
    â”œâ”€â”€ production.yml
    â””â”€â”€ development.yml
```

**ğŸ”¸ ä½¿ç”¨æ–¹å¼**

```bash
# æŒ‡å®šæ¸…å•ç›®å½•ï¼ŒAnsibleä¼šè‡ªåŠ¨åˆå¹¶æ‰€æœ‰æ¸…å•æº

ansible-playbook -i inventory/ site.yml

# æŸ¥çœ‹åˆå¹¶åçš„æ¸…å•ç»“æœ

ansible-inventory -i inventory/ --list
```

### 6.2 ä¼˜å…ˆçº§ä¸è¦†ç›–è§„åˆ™


**ğŸ”¸ å˜é‡ä¼˜å…ˆçº§ç†è§£**

å½“å¤šä¸ªæ¸…å•æºå®šä¹‰ç›¸åŒå˜é‡æ—¶ï¼ŒAnsibleçš„ä¼˜å…ˆçº§è§„åˆ™ï¼š

```
ä¼˜å…ˆçº§ä»é«˜åˆ°ä½:
1. å‘½ä»¤è¡Œ -e å‚æ•°
2. playbookä¸­çš„vars
3. host_vars/ ç›®å½•
4. åŠ¨æ€æ¸…å•çš„ä¸»æœºå˜é‡
5. group_vars/ ç›®å½•  
6. é™æ€æ¸…å•çš„ä¸»æœºå˜é‡
7. åŠ¨æ€æ¸…å•çš„ç»„å˜é‡
8. é™æ€æ¸…å•çš„ç»„å˜é‡
```

**ğŸ”¸ å®ç”¨å»ºè®®**

- ğŸ¯ **æ ¸å¿ƒé…ç½®**æ”¾åœ¨é™æ€æ¸…å•ä¸­ï¼ˆå¦‚SSHç”¨æˆ·ã€ç«¯å£ï¼‰
- ğŸ“Š **åŠ¨æ€å±æ€§**é€šè¿‡åŠ¨æ€æ¸…å•è·å–ï¼ˆå¦‚IPåœ°å€ã€æ ‡ç­¾ï¼‰
- ğŸ”§ **ç¯å¢ƒç‰¹å®š**é…ç½®ä½¿ç”¨group_varsç®¡ç†

### 6.3 æ•…éšœå®¹é”™æœºåˆ¶


**ğŸ”¸ å®¹é”™è®¾è®¡åŸåˆ™**

```python
class FaultTolerantInventory:
    def __init__(self):
        self.fallback_inventory = {
            'all': {'hosts': []},
            '_meta': {'hostvars': {}}
        }
    
    def get_inventory_with_fallback(self):
        """å¸¦å®¹é”™çš„æ¸…å•è·å–"""
        try:
#            # å°è¯•ä»ä¸»æ•°æ®æºè·å–
            return self.get_primary_inventory()
        except Exception as e:
            print(f"è­¦å‘Š: ä¸»æ•°æ®æºå¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ: {e}", file=sys.stderr)
            
            try:
#                # å°è¯•ä»ç¼“å­˜è·å–
                cached = self.load_cache()
                if cached:
                    return cached
            except:
                pass
            
#            # æœ€åä½¿ç”¨ç©ºæ¸…å•é¿å…å®Œå…¨å¤±è´¥
            return self.fallback_inventory
```

---

## ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ”¸ åŠ¨æ€æ¸…å•æœ¬è´¨**: è‡ªåŠ¨è·å–å’Œæ›´æ–°ä¸»æœºä¿¡æ¯çš„æœºåˆ¶ï¼Œè§£å†³é™æ€æ¸…å•ç»´æŠ¤å›°éš¾çš„é—®é¢˜

**ğŸ”¸ å·¥ä½œåŸç†**: é€šè¿‡è„šæœ¬æˆ–æ’ä»¶å®æ—¶æŸ¥è¯¢æ•°æ®æºï¼Œè¾“å‡ºJSONæ ¼å¼çš„ä¸»æœºæ¸…å•ä¿¡æ¯

**ğŸ”¸ åº”ç”¨åœºæ™¯**: äº‘ç¯å¢ƒã€å®¹å™¨åŒ–ç¯å¢ƒã€å¤§è§„æ¨¡åŠ¨æ€åŸºç¡€è®¾æ–½ç®¡ç†

**ğŸ”¸ æ ¸å¿ƒæŠ€æœ¯**: JSONæ ¼å¼è¾“å‡ºã€APIé›†æˆã€ç¼“å­˜ä¼˜åŒ–ã€å¤šæ•°æ®æºèåˆ

### å®é™…åº”ç”¨ä»·å€¼


- **ğŸš€ è‡ªåŠ¨åŒ–ç¨‹åº¦**: å¤§å¹…å‡å°‘æ‰‹åŠ¨ç»´æŠ¤å·¥ä½œï¼Œæé«˜è¿ç»´æ•ˆç‡
- **âš¡ å“åº”é€Ÿåº¦**: å¿«é€Ÿé€‚åº”åŸºç¡€è®¾æ–½å˜åŒ–ï¼Œæ”¯æŒå¼¹æ€§æ‰©ç¼©å®¹
- **ğŸ¯ å‡†ç¡®æ€§**: é¿å…æ‰‹åŠ¨ç»´æŠ¤å¯¼è‡´çš„ä¿¡æ¯ä¸ä¸€è‡´é—®é¢˜
- **ğŸ”§ æ‰©å±•æ€§**: å¯ä»¥é›†æˆå„ç§æ•°æ®æºå’Œäº‘å¹³å°

### å­¦ä¹ è·¯å¾„å»ºè®®


```
ğŸ—ºï¸ æ¨èå­¦ä¹ è·¯å¾„:
åŸºç¡€æ¦‚å¿µ â†’ å®˜æ–¹æ’ä»¶ä½¿ç”¨ â†’ è‡ªå®šä¹‰è„šæœ¬å¼€å‘ â†’ ä¼ä¸šçº§é›†æˆ â†’ æ€§èƒ½ä¼˜åŒ–
   â†“           â†“              â†“              â†“           â†“
 ç†è®ºç†è§£    å¿«é€Ÿä¸Šæ‰‹       æ·±åº¦å®šåˆ¶        ç”Ÿäº§å®è·µ    é«˜çº§åº”ç”¨
```

**ğŸ§  è®°å¿†å£è¯€**: "åŠ¨æ€æ¸…å•è‡ªåŠ¨åŒ–ï¼ŒJSONè¾“å‡ºæ ‡å‡†åŒ–ï¼Œå¤šæºèåˆä¼ä¸šåŒ–ï¼Œç¼“å­˜ä¼˜åŒ–æ€§èƒ½åŒ–"

**ğŸ’ª å®æˆ˜æŒ‘æˆ˜**
å°è¯•åˆ›å»ºä¸€ä¸ªç®€å•çš„åŠ¨æ€æ¸…å•è„šæœ¬ï¼Œè¦æ±‚ï¼š
- æ”¯æŒ`--list`å’Œ`--host`å‚æ•°
- ä»æ–‡æœ¬æ–‡ä»¶è¯»å–ä¸»æœºä¿¡æ¯
- æŒ‰ç¯å¢ƒæ ‡ç­¾åˆ†ç»„
- è¾“å‡ºç¬¦åˆJSONæ ‡å‡†æ ¼å¼

**ğŸ”— æ‰©å±•é˜…è¯»**
- ç›¸å…³æ¦‚å¿µ: [é™æ€æ¸…å•åŸºç¡€](#) | [Ansibleæ’ä»¶å¼€å‘](#)
- å®æˆ˜æ¡ˆä¾‹: [äº‘å¹³å°è‡ªåŠ¨åŒ–](#) | [CMDBé›†æˆé¡¹ç›®](#)