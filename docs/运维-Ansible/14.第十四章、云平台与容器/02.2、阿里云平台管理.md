---
title: 2、阿里云平台管理
---
## 📚 目录

1. [云平台自动化概述](#1-云平台自动化概述)
2. [阿里云ECS服务器管理](#2-阿里云ECS服务器管理)  
3. [腾讯云CVM主机操作](#3-腾讯云CVM主机操作)
4. [VPC专有网络配置](#4-VPC专有网络配置)
5. [安全组规则管理](#5-安全组规则管理)
6. [负载均衡SLB配置](#6-负载均衡SLB配置)
7. [RDS云数据库管理](#7-RDS云数据库管理)
8. [OSS对象存储操作](#8-OSS对象存储操作)
9. [RAM访问控制配置](#9-RAM访问控制配置)
10. [资源编排自动化](#10-资源编排自动化)
11. [监控告警配置](#11-监控告警配置)
12. [核心要点总结](#12-核心要点总结)

---

## 1. ☁️ 云平台自动化概述


### 1.1 什么是云平台管理


**简单理解**: 云平台管理就是用代码来控制云服务器，而不是手动点击网页操作

```
传统方式：                  Ansible方式：
登录控制台 → 点击创建        编写配置文件 → 自动执行
手动配置参数                批量操作资源
容易出错                    标准化流程
```

**核心优势**：
- 🚀 **批量操作**: 一次创建100台服务器
- 📝 **标准化**: 确保每次配置都一样
- ⚡ **快速恢复**: 故障时快速重建环境
- 💰 **成本控制**: 自动启停节省费用

### 1.2 支持的云平台


**主流云平台**：
- **阿里云**: ECS、VPC、SLB、RDS等
- **腾讯云**: CVM、VPC、CLB、CDB等  
- **华为云**: ECS、VPC、ELB、RDS等
- **AWS**: EC2、VPC、ELB、RDS等

### 1.3 认证配置原理


云平台认证就像门卡一样，Ansible需要"门卡"才能操作云资源：

```
┌─────────────┐    认证密钥    ┌─────────────┐
│   Ansible   │ ──────────→  │   阿里云    │
│   控制端    │              │   API接口   │
└─────────────┘              └─────────────┘

认证方式：
1. AccessKey + SecretKey (推荐)
2. 临时凭证 (更安全)
3. 实例角色 (云上推荐)
```

---

## 2. 🖥️ 阿里云ECS服务器管理


### 2.1 ECS实例基本概念


**ECS是什么**: Elastic Compute Service，就是云服务器，相当于租用的虚拟电脑

**核心要素**：
- **实例规格**: CPU、内存配置 (如2核4G)
- **镜像**: 操作系统模板 (如CentOS 7.9)
- **磁盘**: 系统盘+数据盘
- **网络**: VPC、子网、公网IP

### 2.2 安装阿里云模块


> 💡 **提示**: 使用前需要安装专门的阿里云模块

```bash
# 安装阿里云SDK
pip install alibabacloud_ecs20140526
pip install ansible-alibabacloud
```

**配置认证信息**：
```yaml
# group_vars/all.yml
alicloud_access_key: "LTAI4G..."
alicloud_secret_key: "XxXxXx..."
alicloud_region: "cn-beijing"
```

### 2.3 创建ECS实例


**实际操作场景**: 需要快速部署测试环境

```yaml
- name: 创建阿里云ECS实例
  hosts: localhost
  vars:
    # 实例基本信息
    instance_name: "web-server-{{ ansible_date_time.epoch }}"
    instance_type: "ecs.t5-lc1m1.small"  # 1核1G突发性能
    image_id: "centos_7_9_x64_20G_alibase"
    
  tasks:
    - name: 创建ECS实例
      ali_instance:
        access_key: "{{ alicloud_access_key }}"
        secret_key: "{{ alicloud_secret_key }}"
        region: "{{ alicloud_region }}"
        
        # 实例配置
        instance_name: "{{ instance_name }}"
        instance_type: "{{ instance_type }}"
        image_id: "{{ image_id }}"
        
        # 网络配置
        vswitch_id: "vsw-bp1xxx"
        security_group_id: "sg-bp1xxx"
        
        # 磁盘配置
        system_disk_category: "cloud_efficiency"
        system_disk_size: 40
        
        # 其他配置
        internet_charge_type: "PayByTraffic"
        max_bandwidth_out: 5
        password: "MyPassword123!"
        
        state: present
        count: 2  # 创建2台
      register: ecs_result
    
    - name: 显示创建结果
      debug:
        msg: "实例ID: {{ item.id }}, 公网IP: {{ item.public_ip }}"
      loop: "{{ ecs_result.instances }}"
```

### 2.4 管理ECS实例状态


**常见操作**: 启动、停止、重启服务器

```yaml
- name: 管理ECS实例状态
  ali_instance:
    access_key: "{{ alicloud_access_key }}"
    secret_key: "{{ alicloud_secret_key }}"
    region: "{{ alicloud_region }}"
    
    instance_ids:
      - "i-bp1xxxxx"
      - "i-bp1yyyyy"
    
    state: "{{ operation }}"  # running/stopped/restarted
```

**批量操作示例**:
```yaml
# 批量停机节省费用
- name: 晚上自动停机
  cron:
    name: "停止测试环境"
    minute: "0"
    hour: "22"
    job: "ansible-playbook stop-test-env.yml"

# 早上自动开机
- name: 早上自动开机  
  cron:
    name: "启动测试环境"
    minute: "0" 
    hour: "8"
    job: "ansible-playbook start-test-env.yml"
```

---

## 3. 🏢 腾讯云CVM主机操作


### 3.1 CVM与ECS的区别


**本质相同**: 都是云服务器，只是厂商不同

| 对比项 | **阿里云ECS** | **腾讯云CVM** | **说明** |
|--------|--------------|---------------|----------|
| 产品名 | `Elastic Compute Service` | `Cloud Virtual Machine` | `名称不同，功能相同` |
| 实例规格 | `ecs.t5-lc1m1.small` | `S3.SMALL1` | `规格命名规则不同` |
| 镜像ID | `centos_7_9_x64_20G` | `img-9qabwvbn` | `镜像标识格式不同` |
| 地域代码 | `cn-beijing` | `ap-beijing` | `地域命名约定不同` |

### 3.2 腾讯云认证配置


```yaml
# 腾讯云认证信息
tencent_secret_id: "AKIDxxxxx"
tencent_secret_key: "xxxxxxx" 
tencent_region: "ap-beijing"
```

### 3.3 创建CVM实例


```yaml
- name: 创建腾讯云CVM实例
  tencentcloud_instance:
    secret_id: "{{ tencent_secret_id }}"
    secret_key: "{{ tencent_secret_key }}"
    region: "{{ tencent_region }}"
    
    # 实例配置
    instance_name: "web-server"
    instance_type: "S3.SMALL1"  # 1核1G
    image_id: "img-9qabwvbn"    # CentOS 7.6
    
    # 网络配置
    vpc_id: "vpc-xxxxxx"
    subnet_id: "subnet-xxxxxx"
    
    # 计费配置
    instance_charge_type: "POSTPAID_BY_HOUR"  # 按小时计费
    
    state: present
```

---

## 4. 🌐 VPC专有网络配置


### 4.1 VPC网络概念


**简单理解**: VPC就像你的专属网络空间，相当于在云上建了个"局域网"

```
传统网络:                    VPC专有网络:
┌─────────────────┐         ┌─ VPC (10.0.0.0/8) ──────┐
│   物理机房      │         │ ┌─子网1──┐ ┌─子网2──┐    │
│ ┌─┐ ┌─┐ ┌─┐    │         │ │Web服务│ │数据库│    │
│ │A│ │B│ │C│    │   →     │ │10.0.1.x│ │10.0.2.x│  │
│ └─┘ └─┘ └─┘    │         │ └───────┘ └───────┘    │
│   共享网络      │         │      隔离安全           │
└─────────────────┘         └─────────────────────────┘
```

**核心优势**:
- 🔒 **网络隔离**: 不同VPC完全隔离
- 🎯 **精细控制**: 可以控制每个子网
- 🚪 **灵活路由**: 自定义网络规则
- 🔗 **混合云**: 可以连接本地机房

### 4.2 创建VPC网络


**实际需求**: 为新项目创建独立网络环境

```yaml
- name: 创建VPC专有网络
  ali_vpc:
    access_key: "{{ alicloud_access_key }}"
    secret_key: "{{ alicloud_secret_key }}"
    region: "{{ alicloud_region }}"
    
    # VPC基本信息
    vpc_name: "project-vpc"
    cidr_block: "10.0.0.0/8"  # 网络地址范围
    description: "项目专用网络"
    
    state: present
  register: vpc_result

- name: 创建子网
  ali_vswitch:
    access_key: "{{ alicloud_access_key }}"
    secret_key: "{{ alicloud_secret_key }}"
    region: "{{ alicloud_region }}"
    
    # 子网信息
    vpc_id: "{{ vpc_result.vpc.id }}"
    cidr_block: "10.0.1.0/24"  # 子网地址范围
    vswitch_name: "web-subnet"
    zone_id: "cn-beijing-a"
    
    state: present
```

### 4.3 网络规划最佳实践


**地址规划建议**:

```
生产环境网络规划:
┌─ VPC: 10.0.0.0/8 ────────────────────┐
│                                      │
│ ┌─ Web层: 10.0.1.0/24 ─────────┐     │
│ │ 可用IP: 10.0.1.1~10.0.1.254 │     │
│ └─────────────────────────────┘     │
│                                      │
│ ┌─ 应用层: 10.0.2.0/24 ────────┐     │  
│ │ 可用IP: 10.0.2.1~10.0.2.254 │     │
│ └─────────────────────────────┘     │
│                                      │
│ ┌─ 数据层: 10.0.3.0/24 ────────┐     │
│ │ 可用IP: 10.0.3.1~10.0.3.254 │     │
│ └─────────────────────────────┘     │
└──────────────────────────────────────┘
```

> ⚠️ **注意**: 不同子网间默认互通，需要安全组来控制访问

---

## 5. 🔒 安全组规则管理


### 5.1 安全组概念


**简单理解**: 安全组就像防火墙，控制什么流量可以进出服务器

```
没有安全组:                 有安全组保护:
外网 ─────→ 服务器         外网 ──→ [安全组] ──→ 服务器
任何人都能访问                   只允许指定访问
```

**工作原理**:
- **入站规则**: 控制外部访问服务器
- **出站规则**: 控制服务器访问外部
- **默认拒绝**: 没有规则就拒绝访问

### 5.2 创建安全组


```yaml
- name: 创建Web服务器安全组
  ali_security_group:
    access_key: "{{ alicloud_access_key }}"
    secret_key: "{{ alicloud_secret_key }}"
    region: "{{ alicloud_region }}"
    
    # 安全组信息
    group_name: "web-security-group"
    description: "Web服务器安全组"
    vpc_id: "{{ vpc_id }}"
    
    # 安全规则
    rules:
      # SSH访问
      - proto: tcp
        port_range: "22/22"
        cidr_ip: "0.0.0.0/0"
        rule_desc: "SSH远程登录"
      
      # HTTP访问  
      - proto: tcp
        port_range: "80/80"
        cidr_ip: "0.0.0.0/0"
        rule_desc: "HTTP网站访问"
        
      # HTTPS访问
      - proto: tcp
        port_range: "443/443" 
        cidr_ip: "0.0.0.0/0"
        rule_desc: "HTTPS安全访问"
        
      # 数据库访问(仅内网)
      - proto: tcp
        port_range: "3306/3306"
        cidr_ip: "10.0.0.0/8"
        rule_desc: "MySQL数据库"
    
    state: present
```

### 5.3 安全组最佳实践


**安全原则**: 最小权限，只开放必需的端口

```yaml
# 不同角色的安全组配置
web_server_rules:
  - { port: "22", source: "管理员IP", desc: "SSH管理" }
  - { port: "80", source: "0.0.0.0/0", desc: "HTTP访问" }
  - { port: "443", source: "0.0.0.0/0", desc: "HTTPS访问" }

app_server_rules:
  - { port: "22", source: "管理员IP", desc: "SSH管理" }  
  - { port: "8080", source: "10.0.1.0/24", desc: "应用服务" }

db_server_rules:
  - { port: "22", source: "管理员IP", desc: "SSH管理" }
  - { port: "3306", source: "10.0.2.0/24", desc: "数据库访问" }
```

> 🚀 **进阶**: 生产环境建议使用跳板机，不直接开放SSH到公网

---

## 6. ⚖️ 负载均衡SLB配置


### 6.1 负载均衡概念


**简单理解**: 负载均衡就像餐厅的服务员分配客人，把访问请求分配给不同的服务器

```
没有负载均衡:                有负载均衡:
用户 ──→ 服务器A             用户 ──→ [负载均衡] ──→ 服务器A
        (压力大)                         │        服务器B  
                                        └─────→ 服务器C
                                        (压力分散)
```

**核心作用**:
- 📈 **分散负载**: 多台服务器分担访问压力
- 🔄 **故障转移**: 某台故障时自动切换
- ⚡ **提高性能**: 整体响应更快
- 📊 **弹性扩展**: 可以随时增加服务器

### 6.2 创建SLB实例


**实际场景**: 网站访问量增大，需要负载均衡

```yaml
- name: 创建SLB负载均衡
  ali_slb_lb:
    access_key: "{{ alicloud_access_key }}"
    secret_key: "{{ alicloud_secret_key }}"
    region: "{{ alicloud_region }}"
    
    # SLB基本信息
    load_balancer_name: "web-slb"
    load_balancer_spec: "slb.s2.small"  # 规格
    address_type: "internet"            # 公网类型
    
    # 网络配置
    vpc_id: "{{ vpc_id }}"
    vswitch_id: "{{ vswitch_id }}"
    
    # 计费方式
    internet_charge_type: "paybytraffic"
    bandwidth: 10  # 10Mbps
    
    state: present
  register: slb_result
```

### 6.3 配置监听器和后端服务器


```yaml
# 添加HTTP监听器
- name: 配置HTTP监听器
  ali_slb_listener:
    access_key: "{{ alicloud_access_key }}"
    secret_key: "{{ alicloud_secret_key }}"
    region: "{{ alicloud_region }}"
    
    load_balancer_id: "{{ slb_result.load_balancer.id }}"
    
    # 监听配置
    listener_port: 80
    backend_server_port: 80
    protocol: "http"
    
    # 健康检查
    health_check: "on"
    health_check_uri: "/health"
    health_check_timeout: 5
    
    state: present

# 添加后端服务器
- name: 添加后端服务器
  ali_slb_backend_server:
    access_key: "{{ alicloud_access_key }}"
    secret_key: "{{ alicloud_secret_key }}"
    region: "{{ alicloud_region }}"
    
    load_balancer_id: "{{ slb_result.load_balancer.id }}"
    
    # 后端服务器列表
    backend_servers:
      - server_id: "i-bp1xxxxx"
        weight: 100
      - server_id: "i-bp1yyyyy" 
        weight: 100
    
    state: present
```

### 6.4 会话保持配置


**什么是会话保持**: 确保同一用户的请求总是转发到同一台服务器

```yaml
- name: 配置会话保持
  ali_slb_listener:
    # ... 其他配置
    
    # 会话保持
    persistence_timeout: 1800  # 30分钟
    cookie: "JSESSIONID"       # 基于Cookie
    
    # 或者基于源IP
    # scheduler: "wlc"          # 加权最少连接
    # persistence_timeout: 1800
```

---

## 7. 🗄️ RDS云数据库管理


### 7.1 RDS数据库概念


**简单理解**: RDS就是托管的数据库服务，不用自己搭建和维护数据库

```
自建数据库:                   RDS云数据库:
安装MySQL ──→ 配置参数       选择规格 ──→ 直接使用
设置备份 ──→ 监控维护        自动备份 ──→ 自动监控
故障恢复 ──→ 人工处理        故障转移 ──→ 自动恢复
```

**核心优势**:
- 🔧 **免维护**: 不用管补丁、升级
- 💾 **自动备份**: 数据安全有保障  
- 📈 **弹性扩展**: 随时调整配置
- 🔒 **高可用**: 主从自动切换

### 7.2 创建RDS实例


**实际需求**: 为应用创建MySQL数据库

```yaml
- name: 创建RDS数据库实例
  ali_rds_instance:
    access_key: "{{ alicloud_access_key }}"
    secret_key: "{{ alicloud_secret_key }}"
    region: "{{ alicloud_region }}"
    
    # 实例基本信息
    db_instance_id: "rm-bp1xxxxx"
    db_instance_description: "应用数据库"
    
    # 数据库配置
    engine: "MySQL"
    engine_version: "8.0"
    db_instance_class: "mysql.n2.medium.1"  # 2核4G
    db_instance_storage: 100                 # 100GB
    
    # 网络配置
    vpc_id: "{{ vpc_id }}"
    vswitch_id: "{{ vswitch_id }}"
    
    # 安全配置
    master_username: "admin"
    master_user_password: "MyPassword123!"
    
    # 备份配置  
    backup_retention_period: 7  # 保留7天
    preferred_backup_time: "03:00Z-04:00Z"
    
    state: present
  register: rds_result
```

### 7.3 数据库账号管理


```yaml
- name: 创建数据库账号
  ali_rds_account:
    access_key: "{{ alicloud_access_key }}"
    secret_key: "{{ alicloud_secret_key }}"
    region: "{{ alicloud_region }}"
    
    db_instance_id: "{{ rds_result.db_instance.id }}"
    
    # 账号信息
    account_name: "app_user"
    account_password: "AppPassword123!"
    account_type: "Normal"  # 普通账号
    account_description: "应用专用账号"
    
    # 权限配置
    db_names: ["app_database"]
    privilege: "ReadWrite"
    
    state: present
```

### 7.4 白名单配置


**安全配置**: 只允许指定IP访问数据库

```yaml
- name: 配置数据库白名单
  ali_rds_security_ip:
    access_key: "{{ alicloud_access_key }}"
    secret_key: "{{ alicloud_secret_key }}"
    region: "{{ alicloud_region }}"
    
    db_instance_id: "{{ rds_result.db_instance.id }}"
    
    # 白名单配置
    security_ips: "10.0.2.0/24,10.0.3.0/24"  # 应用服务器网段
    whitelist_name: "app_servers"
    
    state: present
```

---

## 8. 📦 OSS对象存储操作


### 8.1 OSS存储概念


**简单理解**: OSS就像云端硬盘，可以存放任何文件，通过网址直接访问

```
传统文件存储:                OSS对象存储:
本地硬盘 ──→ 文件路径       云端存储 ──→ HTTP网址
/var/www/img/photo.jpg    https://bucket.oss.com/photo.jpg
```

**典型应用**:
- 📸 **图片存储**: 网站图片、用户头像
- 📄 **文档存储**: PDF、Word文档
- 🎥 **视频存储**: 视频文件、直播录制
- 📱 **APP资源**: 安装包、更新文件

### 8.2 创建OSS存储桶


```yaml
- name: 创建OSS存储桶
  ali_oss_bucket:
    access_key: "{{ alicloud_access_key }}"
    secret_key: "{{ alicloud_secret_key }}"
    region: "{{ alicloud_region }}"
    
    # 存储桶信息
    bucket_name: "my-app-storage"
    acl: "private"  # 私有访问
    
    # 存储配置
    storage_class: "Standard"  # 标准存储
    
    state: present
  register: oss_result
```

### 8.3 上传和管理文件


**批量上传文件**:
```yaml
- name: 上传静态资源
  ali_oss_object:
    access_key: "{{ alicloud_access_key }}"
    secret_key: "{{ alicloud_secret_key }}"
    region: "{{ alicloud_region }}"
    
    bucket: "{{ oss_result.bucket.name }}"
    key: "{{ item.key }}"
    src: "{{ item.src }}"
    mode: put
    
  loop:
    - { key: "static/css/style.css", src: "/local/css/style.css" }
    - { key: "static/js/app.js", src: "/local/js/app.js" }
    - { key: "images/logo.png", src: "/local/images/logo.png" }
```

### 8.4 设置访问权限


```yaml
- name: 设置公共读权限
  ali_oss_bucket:
    access_key: "{{ alicloud_access_key }}"
    secret_key: "{{ alicloud_secret_key }}"
    region: "{{ alicloud_region }}"
    
    bucket_name: "{{ oss_result.bucket.name }}"
    acl: "public-read"  # 公共读取
    
    state: present

# 配置跨域访问(CORS)
- name: 配置CORS规则
  ali_oss_cors:
    access_key: "{{ alicloud_access_key }}"
    secret_key: "{{ alicloud_secret_key }}"
    region: "{{ alicloud_region }}"
    
    bucket: "{{ oss_result.bucket.name }}"
    cors_rules:
      - allowed_origins: ["*"]
        allowed_methods: ["GET", "POST"]
        allowed_headers: ["*"]
        max_age_seconds: 3600
```

---

## 9. 🔐 RAM访问控制配置


### 9.1 RAM权限管理概念


**简单理解**: RAM就像公司的门禁卡系统，不同的人有不同的权限

```
传统权限:                   RAM权限管理:
老板 ──→ 所有权限          ┌─ 管理员 ──→ 全部权限
员工 ──→ 部分权限          ├─ 开发者 ──→ ECS权限  
实习生 ──→ 只读权限        ├─ 运维 ──→ 监控权限
                          └─ 财务 ──→ 账单权限
```

**核心概念**:
- **用户**: 操作云资源的人员账号
- **角色**: 一组权限的集合
- **策略**: 具体的权限规则
- **组**: 用户的分组管理

### 9.2 创建RAM用户


```yaml
- name: 创建RAM用户
  ali_ram_user:
    access_key: "{{ alicloud_access_key }}"
    secret_key: "{{ alicloud_secret_key }}"
    
    # 用户信息
    user_name: "developer-zhang"
    display_name: "开发者张三"
    mobile_phone: "13800138000"
    email: "zhang@company.com"
    comments: "后端开发工程师"
    
    state: present
  register: ram_user

- name: 创建用户访问密钥
  ali_ram_access_key:
    access_key: "{{ alicloud_access_key }}"
    secret_key: "{{ alicloud_secret_key }}"
    
    user_name: "{{ ram_user.user.user_name }}"
    status: "Active"
    
    state: present
```

### 9.3 创建权限策略


**自定义权限策略**:
```yaml
- name: 创建ECS只读权限策略
  ali_ram_policy:
    access_key: "{{ alicloud_access_key }}"
    secret_key: "{{ alicloud_secret_key }}"
    
    # 策略信息
    policy_name: "ECSReadOnlyAccess"
    description: "ECS服务器只读权限"
    
    # 权限文档
    policy_document: |
      {
        "Version": "1",
        "Statement": [
          {
            "Effect": "Allow",
            "Action": [
              "ecs:Describe*",
              "ecs:List*"
            ],
            "Resource": "*"
          }
        ]
      }
    
    state: present
```

### 9.4 权限绑定


```yaml
- name: 为用户绑定权限策略
  ali_ram_user_policy:
    access_key: "{{ alicloud_access_key }}"
    secret_key: "{{ alicloud_secret_key }}"
    
    user_name: "developer-zhang"
    policy_name: "ECSReadOnlyAccess"
    policy_type: "Custom"  # 自定义策略
    
    state: present

# 也可以绑定系统策略
- name: 绑定系统OSS访问策略
  ali_ram_user_policy:
    access_key: "{{ alicloud_access_key }}"
    secret_key: "{{ alicloud_secret_key }}"
    
    user_name: "developer-zhang" 
    policy_name: "AliyunOSSFullAccess"
    policy_type: "System"  # 系统策略
    
    state: present
```

---

## 10. 🏗️ 资源编排自动化


### 10.1 资源编排概念


**简单理解**: 资源编排就像建房子的图纸，一次性创建整套环境

```
手动创建:                     资源编排:
创建VPC ──→ 创建子网         编写模板 ──→ 一键部署
创建安全组 ──→ 创建ECS        ┌─ VPC
创建RDS ──→ 配置SLB         ├─ ECS  
(步骤多，易出错)              ├─ RDS
                            └─ SLB
                            (标准化，可复用)
```

### 10.2 完整环境部署


**实际场景**: 一键部署完整的Web应用环境

```yaml
- name: 部署完整Web应用环境
  hosts: localhost
  vars:
    project_name: "my-web-app"
    environment: "production"
    
  tasks:
    # 1. 创建VPC网络
    - name: 创建项目VPC
      ali_vpc:
        access_key: "{{ alicloud_access_key }}"
        secret_key: "{{ alicloud_secret_key }}"
        region: "{{ alicloud_region }}"
        
        vpc_name: "{{ project_name }}-vpc"
        cidr_block: "10.0.0.0/8"
        
        state: present
      register: vpc_result
    
    # 2. 创建子网
    - name: 创建Web服务器子网
      ali_vswitch:
        access_key: "{{ alicloud_access_key }}"
        secret_key: "{{ alicloud_secret_key }}"
        region: "{{ alicloud_region }}"
        
        vpc_id: "{{ vpc_result.vpc.id }}"
        cidr_block: "10.0.1.0/24"
        vswitch_name: "{{ project_name }}-web-subnet"
        zone_id: "cn-beijing-a"
        
        state: present
      register: web_subnet
    
    - name: 创建数据库子网
      ali_vswitch:
        access_key: "{{ alicloud_access_key }}"
        secret_key: "{{ alicloud_secret_key }}"
        region: "{{ alicloud_region }}"
        
        vpc_id: "{{ vpc_result.vpc.id }}"
        cidr_block: "10.0.2.0/24"  
        vswitch_name: "{{ project_name }}-db-subnet"
        zone_id: "cn-beijing-b"
        
        state: present
      register: db_subnet
    
    # 3. 创建安全组
    - name: 创建Web安全组
      ali_security_group:
        access_key: "{{ alicloud_access_key }}"
        secret_key: "{{ alicloud_secret_key }}"
        region: "{{ alicloud_region }}"
        
        group_name: "{{ project_name }}-web-sg"
        description: "Web服务器安全组"
        vpc_id: "{{ vpc_result.vpc.id }}"
        
        rules:
          - proto: tcp
            port_range: "80/80"
            cidr_ip: "0.0.0.0/0"
          - proto: tcp
            port_range: "443/443"
            cidr_ip: "0.0.0.0/0"
            
        state: present
      register: web_sg
    
    # 4. 创建ECS实例
    - name: 创建Web服务器
      ali_instance:
        access_key: "{{ alicloud_access_key }}"
        secret_key: "{{ alicloud_secret_key }}"
        region: "{{ alicloud_region }}"
        
        instance_name: "{{ project_name }}-web-{{ item }}"
        instance_type: "ecs.c6.large"  # 2核4G
        image_id: "centos_7_9_x64_20G_alibase"
        
        vswitch_id: "{{ web_subnet.vswitch.id }}"
        security_group_id: "{{ web_sg.group_id }}"
        
        system_disk_category: "cloud_essd"
        system_disk_size: 40
        
        state: present
      loop: [1, 2]  # 创建2台
      register: web_servers
    
    # 5. 创建RDS数据库
    - name: 创建应用数据库
      ali_rds_instance:
        access_key: "{{ alicloud_access_key }}"
        secret_key: "{{ alicloud_secret_key }}"
        region: "{{ alicloud_region }}"
        
        db_instance_description: "{{ project_name }}数据库"
        engine: "MySQL"
        engine_version: "8.0"
        db_instance_class: "mysql.n2.medium.1"
        
        vpc_id: "{{ vpc_result.vpc.id }}"
        vswitch_id: "{{ db_subnet.vswitch.id }}"
        
        master_username: "admin"
        master_user_password: "MyPassword123!"
        
        state: present
      register: rds_instance
    
    # 6. 创建负载均衡
    - name: 创建SLB负载均衡
      ali_slb_lb:
        access_key: "{{ alicloud_access_key }}"
        secret_key: "{{ alicloud_secret_key }}"
        region: "{{ alicloud_region }}"
        
        load_balancer_name: "{{ project_name }}-slb"
        load_balancer_spec: "slb.s2.small"
        address_type: "internet"
        
        vpc_id: "{{ vpc_result.vpc.id }}"
        vswitch_id: "{{ web_subnet.vswitch.id }}"
        
        state: present
      register: slb_result
    
    # 7. 配置SLB监听器
    - name: 配置HTTP监听器
      ali_slb_listener:
        access_key: "{{ alicloud_access_key }}"
        secret_key: "{{ alicloud_secret_key }}"
        region: "{{ alicloud_region }}"
        
        load_balancer_id: "{{ slb_result.load_balancer.id }}"
        listener_port: 80
        backend_server_port: 80
        protocol: "http"
        
        health_check: "on"
        health_check_uri: "/health"
        
        state: present
```

### 10.3 环境清理


```yaml
- name: 清理测试环境
  hosts: localhost
  tasks:
    - name: 删除所有ECS实例
      ali_instance:
        access_key: "{{ alicloud_access_key }}"
        secret_key: "{{ alicloud_secret_key }}"
        region: "{{ alicloud_region }}"
        
        instance_ids: "{{ test_instance_ids }}"
        force: true
        state: absent
    
    - name: 删除RDS实例
      ali_rds_instance:
        access_key: "{{ alicloud_access_key }}"
        secret_key: "{{ alicloud_secret_key }}"
        region: "{{ alicloud_region }}"
        
        db_instance_id: "{{ test_rds_id }}"
        skip_final_snapshot: true
        state: absent
```

---

## 11. 📊 监控告警配置


### 11.1 云监控概念


**简单理解**: 云监控就像体检报告，实时检查服务器的"健康状况"

```
传统监控:                    云监控:
手动检查 ──→ 发现问题       自动监控 ──→ 提前预警
人工处理 ──→ 解决故障       自动恢复 ──→ 减少损失

监控指标:
CPU使用率 ──→ 是否过高
内存使用率 ──→ 是否不足  
磁盘空间 ──→ 是否快满
网络流量 ──→ 是否异常
```

### 11.2 创建监控规则


**实际需求**: 服务器CPU过高时自动告警

```yaml
- name: 创建CPU监控告警
  ali_cms_alarm:
    access_key: "{{ alicloud_access_key }}"
    secret_key: "{{ alicloud_secret_key }}"
    region: "{{ alicloud_region }}"
    
    # 告警规则信息
    rule_name: "CPU使用率过高告警"
    metric_name: "CPUUtilization"  # CPU使用率
    namespace: "acs_ecs_dashboard"  # ECS监控命名空间
    
    # 监控目标
    dimensions: "instanceId:i-bp1xxxxx"
    
    # 告警条件
    comparison_operator: "GreaterThanThreshold"  # 大于阈值
    threshold: "80"      # 80%
    evaluation_count: 3  # 连续3次
    period: 300         # 5分钟检查一次
    
    # 告警通知
    contact_groups: ["运维组"]
    
    state: present

- name: 创建内存监控告警  
  ali_cms_alarm:
    access_key: "{{ alicloud_access_key }}"
    secret_key: "{{ alicloud_secret_key }}"
    region: "{{ alicloud_region }}"
    
    rule_name: "内存使用率过高告警"
    metric_name: "MemoryUtilization" 
    namespace: "acs_ecs_dashboard"
    
    dimensions: "instanceId:i-bp1xxxxx"
    
    comparison_operator: "GreaterThanThreshold"
    threshold: "85"
    evaluation_count: 2
    period: 300
    
    contact_groups: ["运维组"]
    
    state: present
```

### 11.3 配置通知方式


```yaml
- name: 创建告警联系组
  ali_cms_contact_group:
    access_key: "{{ alicloud_access_key }}"
    secret_key: "{{ alicloud_secret_key }}"
    
    # 联系组信息
    contact_group_name: "运维组"
    describe: "运维人员告警组"
    
    # 联系人列表
    contacts:
      - contact_name: "张三"
        mail: "zhangsan@company.com"
        sms: "13800138001" 
      - contact_name: "李四"
        mail: "lisi@company.com"
        sms: "13800138002"
    
    state: present

# 配置钉钉机器人告警
- name: 配置钉钉告警
  ali_cms_alarm:
    # ... 其他配置
    
    # 钉钉机器人Webhook
    webhook: "https://oapi.dingtalk.com/robot/send?access_token=xxx"
    
    state: present
```

### 11.4 自定义监控指标


**业务监控**: 监控应用特定指标

```yaml
- name: 创建自定义应用监控
  uri:
    url: "https://metrics.cn-beijing.aliyuncs.com/"
    method: POST
    headers:
      Authorization: "{{ aliyun_auth_header }}"
      Content-Type: "application/json"
    body_format: json
    body:
      Action: "PutCustomMetric"
      
      # 自定义指标
      MetricData:
        - MetricName: "ActiveUsers"     # 在线用户数
          Value: "{{ active_users }}"
          Timestamp: "{{ ansible_date_time.epoch }}"
          Unit: "Count"
          
        - MetricName: "ResponseTime"    # 响应时间
          Value: "{{ response_time }}"
          Timestamp: "{{ ansible_date_time.epoch }}"
          Unit: "Milliseconds"
```

---

## 12. 📋 核心要点总结


### 12.1 必须掌握的核心概念


```
🔸 云平台管理：用代码控制云资源，实现自动化运维
🔸 ECS服务器：云上虚拟机，支持批量创建和管理
🔸 VPC网络：专有云网络，提供网络隔离和安全控制
🔸 安全组：云上防火墙，控制网络访问权限  
🔸 负载均衡：分散访问压力，提高系统可用性
🔸 RDS数据库：托管数据库服务，免运维管理
🔸 OSS存储：对象存储服务，适合文件和媒体存储
🔸 RAM权限：访问控制管理，实现精细化权限控制
🔸 资源编排：一键部署完整环境，标准化基础设施
🔸 监控告警：实时监控系统状态，及时发现问题
```

### 12.2 关键理解要点


**🔹 云平台自动化的价值**
```
传统运维痛点 → Ansible解决方案：
• 手动操作易出错 → 代码化标准流程
• 环境不一致 → 模板化部署
• 扩容慢 → 自动化批量操作
• 成本难控制 → 定时启停节省费用
```

**🔹 网络安全最佳实践**
```
安全层次设计：
VPC网络隔离 ──→ 不同环境独立
安全组控制 ──→ 最小权限原则
RAM权限管理 ──→ 人员权限分离
监控告警 ──→ 及时发现异常
```

**🔹 成本优化策略**
```
成本控制方法：
• 按需创建资源，用完即删
• 测试环境定时启停
• 选择合适的实例规格  
• 设置预算告警阈值
```

### 12.3 实际应用价值


**📊 典型应用场景**:
- **开发测试**: 快速创建标准化测试环境
- **生产部署**: 一键部署完整应用架构
- **弹性扩容**: 根据流量自动调整资源
- **灾备恢复**: 快速在异地重建环境
- **成本管理**: 自动化启停节省费用

**🎯 运维效率提升**:

| 对比维度 | **传统方式** | **Ansible自动化** | **提升效果** |
|---------|-------------|------------------|-------------|
| 创建环境 | `2-3天手动配置` | `30分钟自动部署` | `效率提升80倍` |
| 环境一致性 | `难以保证` | `模板化保障` | `减少90%配置错误` |
| 批量操作 | `逐台手动操作` | `批量并发执行` | `时间节省95%` |
| 故障恢复 | `半天重建` | `1小时自动恢复` | `恢复时间缩短75%` |

**⚡ 学习路径建议**:
1. **基础实践**: 先掌握单个资源操作
2. **组合应用**: 学会多资源协同配置  
3. **模板化**: 封装可复用的部署模板
4. **监控运维**: 完善监控告警体系
5. **持续优化**: 基于实际使用优化流程

> 💡 **核心记忆**: 云平台管理的本质是Infrastructure as Code(IaC)，用代码描述基础设施，实现可重复、可审计、可版本管理的运维自动化