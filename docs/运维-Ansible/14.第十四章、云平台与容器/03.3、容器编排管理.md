---
title: 3ã€å®¹å™¨ç¼–æ’ç®¡ç†
---
## ğŸ“š ç›®å½•

1. [Dockerå®¹å™¨ç®¡ç†åŸºç¡€](#1-Dockerå®¹å™¨ç®¡ç†åŸºç¡€)
2. [docker_containeræ¨¡å—è¯¦è§£](#2-docker_containeræ¨¡å—è¯¦è§£)
3. [docker_imageé•œåƒç®¡ç†](#3-docker_imageé•œåƒç®¡ç†)
4. [docker_networkç½‘ç»œç®¡ç†](#4-docker_networkç½‘ç»œç®¡ç†)
5. [docker_volumeå­˜å‚¨ç®¡ç†](#5-docker_volumeå­˜å‚¨ç®¡ç†)
6. [Docker Composeé›†æˆ](#6-Docker-Composeé›†æˆ)
7. [å®¹å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†](#7-å®¹å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†)
8. [é•œåƒæ„å»ºè‡ªåŠ¨åŒ–](#8-é•œåƒæ„å»ºè‡ªåŠ¨åŒ–)
9. [ç›‘æ§å’Œæ—¥å¿—ç®¡ç†](#9-ç›‘æ§å’Œæ—¥å¿—ç®¡ç†)
10. [å®‰å…¨é…ç½®æœ€ä½³å®è·µ](#10-å®‰å…¨é…ç½®æœ€ä½³å®è·µ)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ³ Dockerå®¹å™¨ç®¡ç†åŸºç¡€


### 1.1 ä»€ä¹ˆæ˜¯å®¹å™¨ç¼–æ’


**å®¹å™¨ç¼–æ’**å°±æ˜¯**è‡ªåŠ¨åŒ–ç®¡ç†å®¹å™¨çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸ**ã€‚ç®€å•ç†è§£å°±æ˜¯ï¼š
- ğŸš€ **è‡ªåŠ¨éƒ¨ç½²**ï¼šå‘Šè¯‰ç³»ç»Ÿè¦è¿è¡Œä»€ä¹ˆå®¹å™¨
- ğŸ“Š **çŠ¶æ€ç®¡ç†**ï¼šç¡®ä¿å®¹å™¨æŒ‰é¢„æœŸè¿è¡Œ
- ğŸ”„ **ç”Ÿå‘½å‘¨æœŸ**ï¼šåˆ›å»ºã€å¯åŠ¨ã€åœæ­¢ã€åˆ é™¤å®¹å™¨
- ğŸ“ˆ **è§„æ¨¡åŒ–**ï¼šåŒæ—¶ç®¡ç†æˆç™¾ä¸Šåƒä¸ªå®¹å™¨

**ä¸ºä»€ä¹ˆéœ€è¦Ansibleç®¡ç†Dockerï¼Ÿ**
```
ä¼ ç»Ÿæ–¹å¼ï¼š
æ‰‹å·¥æ‰§è¡Œ â†’ docker run nginx â†’ è®°ä½å‘½ä»¤ â†’ é‡å¤æ“ä½œ

Ansibleæ–¹å¼ï¼š
å†™ä¸€æ¬¡é…ç½® â†’ è‡ªåŠ¨åŒ–æ‰§è¡Œ â†’ æ ‡å‡†åŒ–ç®¡ç† â†’ å¯é‡å¤éƒ¨ç½²
```

### 1.2 Ansible Dockeræ¨¡å—æ¶æ„


**æ ¸å¿ƒæ¨¡å—ä½“ç³»**
```
Ansible Dockerç”Ÿæ€
â”œâ”€â”€ docker_container     â† å®¹å™¨ç®¡ç†ï¼ˆæœ€å¸¸ç”¨ï¼‰
â”œâ”€â”€ docker_image         â† é•œåƒç®¡ç†
â”œâ”€â”€ docker_network       â† ç½‘ç»œç®¡ç†
â”œâ”€â”€ docker_volume        â† å­˜å‚¨ç®¡ç†
â”œâ”€â”€ docker_compose       â† Composeæ–‡ä»¶ç®¡ç†
â””â”€â”€ docker_swarm         â† é›†ç¾¤ç®¡ç†
```

**æ¨¡å—é—´å…³ç³»ç†è§£**
- **docker_image** â†’ å…ˆå‡†å¤‡é•œåƒ
- **docker_network** â†’ åˆ›å»ºç½‘ç»œ
- **docker_volume** â†’ å‡†å¤‡å­˜å‚¨
- **docker_container** â†’ å¯åŠ¨å®¹å™¨ï¼ˆä½¿ç”¨ä¸Šé¢çš„èµ„æºï¼‰

### 1.3 ç¯å¢ƒå‡†å¤‡è¦æ±‚


**å¿…å¤‡æ¡ä»¶æ£€æŸ¥**
```yaml
# æ£€æŸ¥Dockeræ˜¯å¦å®‰è£…
- name: éªŒè¯Dockerç¯å¢ƒ
  shell: docker --version
  register: docker_version
  
- name: å®‰è£…Docker Pythonåº“
  pip:
    name: 
      - docker
      - docker-compose
```

> **ğŸ’¡ é‡è¦æç¤º**ï¼šAnsibleç®¡ç†Dockeréœ€è¦åœ¨ç›®æ ‡æœºå™¨ä¸Šå®‰è£…Pythonçš„dockeråº“ï¼Œè¿™æ˜¯æ¨¡å—å·¥ä½œçš„åŸºç¡€

---

## 2. ğŸ“¦ docker_containeræ¨¡å—è¯¦è§£


### 2.1 docker_containeræ¨¡å—æ ¸å¿ƒä½œç”¨


**è¿™ä¸ªæ¨¡å—æ˜¯åšä»€ä¹ˆçš„ï¼Ÿ**
`docker_container`æ¨¡å—å°±æ˜¯**Ansibleæ“ä½œDockerå®¹å™¨çš„ç‘å£«å†›åˆ€**ï¼Œå®ƒèƒ½ï¼š
- âœ… **åˆ›å»ºå®¹å™¨**ï¼šç›¸å½“äº`docker run`å‘½ä»¤
- ğŸ”„ **ç®¡ç†çŠ¶æ€**ï¼šå¯åŠ¨ã€åœæ­¢ã€é‡å¯å®¹å™¨
- âš™ï¸ **é…ç½®å®¹å™¨**ï¼šç«¯å£æ˜ å°„ã€ç¯å¢ƒå˜é‡ã€æŒ‚è½½ç­‰
- ğŸ—‘ï¸ **æ¸…ç†èµ„æº**ï¼šåˆ é™¤ä¸éœ€è¦çš„å®¹å™¨

### 2.2 åŸºç¡€å®¹å™¨åˆ›å»º


**æœ€ç®€å•çš„å®¹å™¨å¯åŠ¨**
```yaml
- name: å¯åŠ¨nginxå®¹å™¨
  docker_container:
    name: my-nginx           # å®¹å™¨åç§°
    image: nginx:latest      # ä½¿ç”¨çš„é•œåƒ
    state: started          # å®¹å™¨çŠ¶æ€ï¼šstarted/stopped/absent
```

**è¿™æ®µä»£ç çš„å«ä¹‰ï¼š**
- `name`: ç»™å®¹å™¨èµ·ä¸ªåå­—ï¼Œå°±åƒç»™å® ç‰©èµ·åä¸€æ ·
- `image`: å‘Šè¯‰Dockerç”¨å“ªä¸ªé•œåƒæ¥åˆ›å»ºå®¹å™¨
- `state: started`: ç¡®ä¿å®¹å™¨æ˜¯è¿è¡ŒçŠ¶æ€

### 2.3 ç«¯å£æ˜ å°„é…ç½®


**ä»€ä¹ˆæ˜¯ç«¯å£æ˜ å°„ï¼Ÿ**
ç«¯å£æ˜ å°„å°±æ˜¯**æŠŠå®¹å™¨å†…éƒ¨çš„ç«¯å£æš´éœ²åˆ°ä¸»æœºä¸Š**ï¼Œè®©å¤–ç•Œèƒ½è®¿é—®å®¹å™¨æœåŠ¡ã€‚

```yaml
- name: é…ç½®nginxç«¯å£æ˜ å°„
  docker_container:
    name: web-server
    image: nginx:latest
    ports:
      - "80:80"              # ä¸»æœºç«¯å£:å®¹å™¨ç«¯å£
      - "443:443"
    state: started
```

**ç«¯å£æ˜ å°„çš„ç†è§£ï¼š**
```
å¤–éƒ¨è®¿é—®æµç¨‹ï¼š
æµè§ˆå™¨è¯·æ±‚ â†’ ä¸»æœº80ç«¯å£ â†’ æ˜ å°„åˆ° â†’ å®¹å™¨80ç«¯å£ â†’ NginxæœåŠ¡

å°±åƒç»™æˆ¿é—´å¼€çª—æˆ·ï¼Œå¤–é¢çš„äººå¯ä»¥é€šè¿‡çª—æˆ·çœ‹åˆ°é‡Œé¢
```

### 2.4 ç¯å¢ƒå˜é‡å’ŒæŒ‚è½½


**ä¸ºä»€ä¹ˆéœ€è¦ç¯å¢ƒå˜é‡ï¼Ÿ**
ç¯å¢ƒå˜é‡å°±æ˜¯**ç»™å®¹å™¨ä¼ é€’é…ç½®ä¿¡æ¯**çš„æ–¹å¼ï¼Œæ¯”å¦‚æ•°æ®åº“å¯†ç ã€APIå¯†é’¥ç­‰ã€‚

```yaml
- name: å¯åŠ¨MySQLæ•°æ®åº“
  docker_container:
    name: mysql-db
    image: mysql:8.0
    env:
      MYSQL_ROOT_PASSWORD: "{{ db_password }}"
      MYSQL_DATABASE: "myapp"
    volumes:
      - "/opt/mysql-data:/var/lib/mysql"    # ä¸»æœºè·¯å¾„:å®¹å™¨è·¯å¾„
    ports:
      - "3306:3306"
    state: started
```

**é…ç½®å«ä¹‰è§£é‡Šï¼š**
- `env`: è®¾ç½®å®¹å™¨å†…çš„ç¯å¢ƒå˜é‡ï¼ŒMySQLéœ€è¦è¿™äº›æ¥åˆå§‹åŒ–
- `volumes`: æ•°æ®æŒä¹…åŒ–ï¼ŒæŠŠå®¹å™¨å†…çš„æ•°æ®å­˜åˆ°ä¸»æœºä¸Š
- **ä¸ºä»€ä¹ˆè¦æŒ‚è½½ï¼Ÿ** å¦‚æœä¸æŒ‚è½½ï¼Œå®¹å™¨åˆ é™¤åæ•°æ®å°±ä¸¢å¤±äº†

### 2.5 å®¹å™¨èµ„æºé™åˆ¶


**æ§åˆ¶å®¹å™¨èµ„æºä½¿ç”¨**
```yaml
- name: åˆ›å»ºå—é™åˆ¶çš„å®¹å™¨
  docker_container:
    name: limited-app
    image: myapp:latest
    memory: "512m"           # é™åˆ¶å†…å­˜ä½¿ç”¨
    cpus: "1.0"             # é™åˆ¶CPUä½¿ç”¨
    restart_policy: always   # é‡å¯ç­–ç•¥
    state: started
```

**èµ„æºé™åˆ¶çš„é‡è¦æ€§ï¼š**
- é˜²æ­¢å•ä¸ªå®¹å™¨è€—å°½ç³»ç»Ÿèµ„æº
- ä¿è¯å¤šä¸ªå®¹å™¨å…¬å¹³ä½¿ç”¨èµ„æº
- æé«˜ç³»ç»Ÿæ•´ä½“ç¨³å®šæ€§

---

## 3. ğŸ–¼ï¸ docker_imageé•œåƒç®¡ç†


### 3.1 é•œåƒç®¡ç†çš„ä½œç”¨


**ä»€ä¹ˆæ˜¯Dockeré•œåƒï¼Ÿ**
Dockeré•œåƒå°±åƒæ˜¯**åº”ç”¨ç¨‹åºçš„å®‰è£…åŒ…**ï¼ŒåŒ…å«äº†ï¼š
- ğŸ“¦ åº”ç”¨ç¨‹åºä»£ç 
- ğŸ”§ è¿è¡Œç¯å¢ƒï¼ˆæ“ä½œç³»ç»Ÿã€åº“æ–‡ä»¶ï¼‰
- âš™ï¸ é…ç½®æ–‡ä»¶
- ğŸ“‹ å¯åŠ¨æŒ‡ä»¤

### 3.2 æ‹‰å–å’Œç®¡ç†é•œåƒ


**ä»ä»“åº“æ‹‰å–é•œåƒ**
```yaml
- name: æ‹‰å–nginxé•œåƒ
  docker_image:
    name: nginx:latest
    source: pull
    
- name: æ‹‰å–å¤šä¸ªç‰ˆæœ¬é•œåƒ
  docker_image:
    name: "{{ item }}"
    source: pull
  loop:
    - "nginx:1.20"
    - "nginx:1.21"
    - "redis:6.2"
```

### 3.3 æ„å»ºè‡ªå®šä¹‰é•œåƒ


**ä½¿ç”¨Dockerfileæ„å»ºé•œåƒ**
```yaml
- name: æ„å»ºåº”ç”¨é•œåƒ
  docker_image:
    name: myapp:v1.0
    build:
      path: /path/to/dockerfile/    # Dockerfileæ‰€åœ¨ç›®å½•
      args:
        NODE_VERSION: "16"          # æ„å»ºå‚æ•°
    source: build
```

**æ„å»ºè¿‡ç¨‹ç†è§£ï¼š**
```
æ„å»ºæµç¨‹ï¼š
Dockerfile â†’ Dockeræ„å»º â†’ ç”Ÿæˆé•œåƒ â†’ ç”¨äºåˆ›å»ºå®¹å™¨

å°±åƒæŒ‰ç…§èœè°±åšèœï¼š
èœè°±(Dockerfile) â†’ æŒ‰æ­¥éª¤åˆ¶ä½œ â†’ å®Œæˆèœå“(é•œåƒ) â†’ å¯ä»¥äº«ç”¨(è¿è¡Œå®¹å™¨)
```

### 3.4 é•œåƒæ¸…ç†


**æ¸…ç†æ— ç”¨é•œåƒ**
```yaml
- name: æ¸…ç†æ‚¬ç©ºé•œåƒ
  docker_prune:
    images: yes
    images_filters:
      dangling: true
      
- name: åˆ é™¤ç‰¹å®šé•œåƒ
  docker_image:
    name: old-app:v0.9
    state: absent
```

---

## 4. ğŸŒ docker_networkç½‘ç»œç®¡ç†


### 4.1 Dockerç½‘ç»œæ¦‚å¿µ


**ä»€ä¹ˆæ˜¯Dockerç½‘ç»œï¼Ÿ**
Dockerç½‘ç»œå°±æ˜¯**å®¹å™¨ä¹‹é—´é€šä¿¡çš„æ¡¥æ¢**ï¼Œå°±åƒï¼š
- ğŸ  **bridgeç½‘ç»œ**ï¼šé»˜è®¤ç½‘ç»œï¼Œå®¹å™¨é—´å¯ä»¥é€šä¿¡
- ğŸŒ **hostç½‘ç»œ**ï¼šç›´æ¥ä½¿ç”¨ä¸»æœºç½‘ç»œ
- ğŸ”’ **noneç½‘ç»œ**ï¼šæ— ç½‘ç»œè¿æ¥
- ğŸ—ï¸ **è‡ªå®šä¹‰ç½‘ç»œ**ï¼šä¸ºç‰¹å®šåº”ç”¨åˆ›å»ºä¸“ç”¨ç½‘ç»œ

### 4.2 åˆ›å»ºè‡ªå®šä¹‰ç½‘ç»œ


**ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰ç½‘ç»œï¼Ÿ**
è‡ªå®šä¹‰ç½‘ç»œæä¾›**æ›´å¥½çš„éš”ç¦»æ€§å’Œå¯æ§æ€§**ï¼š

```yaml
- name: åˆ›å»ºåº”ç”¨ä¸“ç”¨ç½‘ç»œ
  docker_network:
    name: app-network
    driver: bridge
    ipam_config:
      - subnet: "172.20.0.0/16"
        gateway: "172.20.0.1"
```

### 4.3 å®¹å™¨ç½‘ç»œè¿æ¥


**å°†å®¹å™¨è¿æ¥åˆ°ç½‘ç»œ**
```yaml
- name: å¯åŠ¨æ•°æ®åº“å®¹å™¨
  docker_container:
    name: mysql-db
    image: mysql:8.0
    networks:
      - name: app-network
        ipv4_address: "172.20.0.10"    # æŒ‡å®šIPåœ°å€
        
- name: å¯åŠ¨åº”ç”¨å®¹å™¨
  docker_container:
    name: web-app
    image: myapp:latest
    networks:
      - name: app-network
        ipv4_address: "172.20.0.11"
```

**ç½‘ç»œè¿æ¥çš„å¥½å¤„ï¼š**
```
ç½‘ç»œéš”ç¦»ç¤ºä¾‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   app-network   â”‚    â”‚  other-network  â”‚
â”‚                 â”‚    â”‚                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”  â”‚    â”‚   â”Œâ”€â”€â”€â”€â”        â”‚
â”‚  â”‚Web â”‚ â”‚ DB â”‚  â”‚    â”‚   â”‚Testâ”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜  â”‚    â”‚   â””â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¸åŒç½‘ç»œçš„å®¹å™¨é»˜è®¤æ— æ³•äº’ç›¸è®¿é—®ï¼Œæä¾›å®‰å…¨éš”ç¦»
```

---

## 5. ğŸ’¾ docker_volumeå­˜å‚¨ç®¡ç†


### 5.1 æ•°æ®æŒä¹…åŒ–çš„é‡è¦æ€§


**ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®å·ï¼Ÿ**
å®¹å™¨æ˜¯**ä¸´æ—¶çš„**ï¼Œåˆ é™¤å®¹å™¨åæ•°æ®å°±æ¶ˆå¤±äº†ã€‚æ•°æ®å·è§£å†³è¿™ä¸ªé—®é¢˜ï¼š
- ğŸ”’ **æ•°æ®æŒä¹…åŒ–**ï¼šæ•°æ®å­˜å‚¨åœ¨ä¸»æœºä¸Šï¼Œä¸ä¼šä¸¢å¤±
- ğŸ“¤ **æ•°æ®å…±äº«**ï¼šå¤šä¸ªå®¹å™¨å¯ä»¥å…±äº«åŒä¸€ä¸ªæ•°æ®å·
- ğŸš€ **æ€§èƒ½ä¼˜åŒ–**ï¼šç›´æ¥è®¿é—®ä¸»æœºå­˜å‚¨ï¼Œæ€§èƒ½æ›´å¥½

### 5.2 åˆ›å»ºå’Œç®¡ç†æ•°æ®å·


**åˆ›å»ºå‘½åæ•°æ®å·**
```yaml
- name: åˆ›å»ºMySQLæ•°æ®å·
  docker_volume:
    name: mysql-data
    
- name: åˆ›å»ºåº”ç”¨æ—¥å¿—å·
  docker_volume:
    name: app-logs
    driver_options:
      type: none
      o: bind
      device: /opt/logs
```

### 5.3 ä½¿ç”¨æ•°æ®å·


**åœ¨å®¹å™¨ä¸­ä½¿ç”¨æ•°æ®å·**
```yaml
- name: ä½¿ç”¨æ•°æ®å·å¯åŠ¨å®¹å™¨
  docker_container:
    name: mysql-server
    image: mysql:8.0
    volumes:
      - "mysql-data:/var/lib/mysql"     # å‘½åå·
      - "/host/path:/container/path"    # ç»‘å®šæŒ‚è½½
      - "app-logs:/var/log/app"         # åº”ç”¨æ—¥å¿—
    env:
      MYSQL_ROOT_PASSWORD: "password"
```

**æ•°æ®å·ç±»å‹å¯¹æ¯”**

| ç±»å‹ | **ç‰¹ç‚¹** | **ä½¿ç”¨åœºæ™¯** | **ç¤ºä¾‹** |
|------|---------|-------------|---------|
| ğŸ·ï¸ **å‘½åå·** | `Dockerç®¡ç†ï¼ŒæŒä¹…åŒ–å¥½` | `æ•°æ®åº“æ•°æ®å­˜å‚¨` | `mysql-data:/var/lib/mysql` |
| ğŸ“ **ç»‘å®šæŒ‚è½½** | `ç›´æ¥æ˜ å°„ä¸»æœºç›®å½•` | `é…ç½®æ–‡ä»¶ï¼Œå¼€å‘è°ƒè¯•` | `/opt/config:/etc/app` |
| ğŸ’¾ **ä¸´æ—¶å·** | `å®¹å™¨åˆ é™¤æ—¶è‡ªåŠ¨æ¸…ç†` | `ä¸´æ—¶æ–‡ä»¶å¤„ç†` | `tmpfs:/tmp` |

---

## 6. ğŸ™ Docker Composeé›†æˆ


### 6.1 ä»€ä¹ˆæ˜¯Docker Compose


**Docker Composeçš„ä½œç”¨**
Docker Composeæ˜¯**å¤šå®¹å™¨åº”ç”¨çš„ç¼–æ’å·¥å…·**ï¼Œå°±åƒï¼š
- ğŸ“‹ **èœè°±**ï¼šå®šä¹‰åº”ç”¨çš„å®Œæ•´é…ç½®
- ğŸ± **å¥—é¤**ï¼šä¸€æ¬¡æ€§å¯åŠ¨å¤šä¸ªç›¸å…³æœåŠ¡
- ğŸ”§ **ç®¡ç†å·¥å…·**ï¼šç»Ÿä¸€ç®¡ç†å¤æ‚åº”ç”¨

### 6.2 ä½¿ç”¨Ansibleç®¡ç†Compose


**éƒ¨ç½²Composeæ–‡ä»¶**
```yaml
- name: åˆ›å»ºåº”ç”¨ç›®å½•
  file:
    path: /opt/myapp
    state: directory
    
- name: éƒ¨ç½²docker-compose.yml
  template:
    src: docker-compose.yml.j2
    dest: /opt/myapp/docker-compose.yml
    
- name: å¯åŠ¨Composeåº”ç”¨
  docker_compose:
    project_src: /opt/myapp
    state: present
```

### 6.3 Composeæ–‡ä»¶æ¨¡æ¿


**docker-compose.yml.j2æ¨¡æ¿ç¤ºä¾‹**
```yaml
version: '3.8'
services:
  web:
    image: nginx:latest
    ports:
      - "{{ web_port }}:80"
    depends_on:
      - app
      
  app:
    image: myapp:{{ app_version }}
    environment:
      - DB_HOST=database
      - DB_PASSWORD={{ db_password }}
    depends_on:
      - database
      
  database:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD={{ db_password }}
    volumes:
      - mysql_data:/var/lib/mysql

volumes:
  mysql_data:
```

**Composeçš„ä¼˜åŠ¿ï¼š**
- ğŸ¯ **å£°æ˜å¼**ï¼šæè¿°ä½ æƒ³è¦çš„æœ€ç»ˆçŠ¶æ€
- ğŸ”„ **ä¾èµ–ç®¡ç†**ï¼šè‡ªåŠ¨å¤„ç†æœåŠ¡å¯åŠ¨é¡ºåº
- ğŸŒ **ç½‘ç»œè‡ªåŠ¨åŒ–**ï¼šè‡ªåŠ¨åˆ›å»ºæœåŠ¡é—´ç½‘ç»œ

---

## 7. ğŸ”„ å®¹å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†


### 7.1 å®¹å™¨çŠ¶æ€ç®¡ç†


**å®¹å™¨ç”Ÿå‘½å‘¨æœŸç†è§£**
```
å®¹å™¨çŠ¶æ€æµè½¬ï¼š
åˆ›å»º â†’ å¯åŠ¨ â†’ è¿è¡Œ â†’ åœæ­¢ â†’ åˆ é™¤
 â†“      â†“      â†“      â†“      â†“
created started running stopped removed
```

**å®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†**
```yaml
- name: å®¹å™¨ç”Ÿå‘½å‘¨æœŸæ¼”ç¤º
  block:
    - name: åˆ›å»ºå®¹å™¨ï¼ˆä¸å¯åŠ¨ï¼‰
      docker_container:
        name: demo-app
        image: nginx:latest
        state: present
        
    - name: å¯åŠ¨å®¹å™¨
      docker_container:
        name: demo-app
        state: started
        
    - name: é‡å¯å®¹å™¨
      docker_container:
        name: demo-app
        state: started
        restart: yes
        
    - name: åœæ­¢å®¹å™¨
      docker_container:
        name: demo-app
        state: stopped
        
    - name: åˆ é™¤å®¹å™¨
      docker_container:
        name: demo-app
        state: absent
```

### 7.2 å®¹å™¨å¥åº·æ£€æŸ¥


**é…ç½®å®¹å™¨å¥åº·æ£€æŸ¥**
```yaml
- name: å¸¦å¥åº·æ£€æŸ¥çš„å®¹å™¨
  docker_container:
    name: web-app
    image: myapp:latest
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
```

**å¥åº·æ£€æŸ¥çš„ä½œç”¨ï¼š**
- ğŸ” **è‡ªåŠ¨æ£€æµ‹**ï¼šå®šæœŸæ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸
- ğŸ”„ **è‡ªåŠ¨æ¢å¤**ï¼šé…åˆé‡å¯ç­–ç•¥è‡ªåŠ¨é‡å¯å¼‚å¸¸å®¹å™¨
- ğŸ“Š **çŠ¶æ€æŠ¥å‘Š**ï¼šæä¾›æœåŠ¡å¥åº·çŠ¶æ€ä¿¡æ¯

### 7.3 é‡å¯ç­–ç•¥é…ç½®


**ä¸åŒé‡å¯ç­–ç•¥å¯¹æ¯”**

| ç­–ç•¥ | **å«ä¹‰** | **ä½¿ç”¨åœºæ™¯** |
|------|---------|-------------|
| `no` | `ä»ä¸é‡å¯` | `ä¸€æ¬¡æ€§ä»»åŠ¡` |
| `always` | `æ€»æ˜¯é‡å¯` | `ç³»ç»ŸæœåŠ¡` |
| `unless-stopped` | `é™¤éæ‰‹åŠ¨åœæ­¢` | `åº”ç”¨æœåŠ¡` |
| `on-failure` | `å¤±è´¥æ—¶é‡å¯` | `å¯èƒ½å‡ºé”™çš„ä»»åŠ¡` |

```yaml
- name: é…ç½®é‡å¯ç­–ç•¥
  docker_container:
    name: critical-service
    image: myapp:latest
    restart_policy: unless-stopped
    restart_retries: 3
```

---

## 8. ğŸ—ï¸ é•œåƒæ„å»ºè‡ªåŠ¨åŒ–


### 8.1 è‡ªåŠ¨åŒ–æ„å»ºæµç¨‹


**æ„å»ºè¿‡ç¨‹è‡ªåŠ¨åŒ–**
```yaml
- name: å‡†å¤‡æ„å»ºç¯å¢ƒ
  file:
    path: "{{ item }}"
    state: directory
  loop:
    - /opt/build
    - /opt/build/src
    
- name: å¤åˆ¶åº”ç”¨ä»£ç 
  copy:
    src: "{{ local_src_path }}"
    dest: /opt/build/src/
    
- name: ç”ŸæˆDockerfile
  template:
    src: Dockerfile.j2
    dest: /opt/build/Dockerfile
    
- name: æ„å»ºåº”ç”¨é•œåƒ
  docker_image:
    name: "myapp:{{ app_version }}"
    build:
      path: /opt/build
      pull: yes
      nocache: "{{ force_rebuild | default(false) }}"
    source: build
```

### 8.2 å¤šé˜¶æ®µæ„å»º


**Dockerfileæ¨¡æ¿ç¤ºä¾‹**
```dockerfile
# æ„å»ºé˜¶æ®µ
FROM node:16-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

# è¿è¡Œé˜¶æ®µ
FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

**å¤šé˜¶æ®µæ„å»ºçš„å¥½å¤„ï¼š**
- ğŸ¯ **ä½“ç§¯ä¼˜åŒ–**ï¼šæœ€ç»ˆé•œåƒåªåŒ…å«è¿è¡Œæ—¶éœ€è¦çš„æ–‡ä»¶
- ğŸ”’ **å®‰å…¨æ€§**ï¼šä¸åŒ…å«æºç å’Œæ„å»ºå·¥å…·
- âš¡ **æ€§èƒ½æå‡**ï¼šæ›´å°çš„é•œåƒä¸‹è½½å’Œå¯åŠ¨æ›´å¿«

---

## 9. ğŸ“Š ç›‘æ§å’Œæ—¥å¿—ç®¡ç†


### 9.1 å®¹å™¨æ—¥å¿—æ”¶é›†


**é…ç½®æ—¥å¿—é©±åŠ¨**
```yaml
- name: é…ç½®æ—¥å¿—æ”¶é›†
  docker_container:
    name: web-app
    image: myapp:latest
    log_driver: json-file
    log_options:
      max-size: "10m"
      max-file: "3"
```

**æŸ¥çœ‹å®¹å™¨æ—¥å¿—**
```yaml
- name: è·å–å®¹å™¨æ—¥å¿—
  shell: docker logs --tail 100 {{ container_name }}
  register: container_logs
  
- name: æ˜¾ç¤ºæ—¥å¿—å†…å®¹
  debug:
    msg: "{{ container_logs.stdout_lines }}"
```

### 9.2 å®¹å™¨çŠ¶æ€ç›‘æ§


**æ”¶é›†å®¹å™¨çŠ¶æ€ä¿¡æ¯**
```yaml
- name: è·å–å®¹å™¨çŠ¶æ€
  docker_container_info:
    name: "{{ item }}"
  register: container_info
  loop:
    - web-app
    - database
    - redis
    
- name: æ£€æŸ¥å®¹å™¨å¥åº·çŠ¶æ€
  debug:
    msg: "å®¹å™¨ {{ item.container.Name }} çŠ¶æ€: {{ item.container.State.Status }}"
  loop: "{{ container_info.results }}"
  when: item.exists
```

### 9.3 èµ„æºä½¿ç”¨ç›‘æ§


**å®¹å™¨èµ„æºç»Ÿè®¡**
```yaml
- name: è·å–å®¹å™¨èµ„æºä½¿ç”¨æƒ…å†µ
  shell: docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}"
  register: container_stats
  
- name: æ˜¾ç¤ºèµ„æºä½¿ç”¨
  debug:
    msg: "{{ container_stats.stdout_lines }}"
```

---

## 10. ğŸ”’ å®‰å…¨é…ç½®æœ€ä½³å®è·µ


### 10.1 å®¹å™¨å®‰å…¨åŸºç¡€


**å®‰å…¨é…ç½®åŸåˆ™**
- ğŸš« **æœ€å°æƒé™**ï¼šåªç»™å®¹å™¨å¿…è¦çš„æƒé™
- ğŸ‘¤ **érootç”¨æˆ·**ï¼šé¿å…ä»¥rootèº«ä»½è¿è¡Œ
- ğŸŒ **ç½‘ç»œéš”ç¦»**ï¼šä½¿ç”¨è‡ªå®šä¹‰ç½‘ç»œéš”ç¦»æœåŠ¡
- ğŸ“ **åªè¯»æ–‡ä»¶ç³»ç»Ÿ**ï¼šé‡è¦ç›®å½•è®¾ç½®ä¸ºåªè¯»

### 10.2 å®‰å…¨é…ç½®å®è·µ


**å®‰å…¨çš„å®¹å™¨å¯åŠ¨é…ç½®**
```yaml
- name: å®‰å…¨çš„åº”ç”¨å®¹å™¨
  docker_container:
    name: secure-app
    image: myapp:latest
    user: "1000:1000"              # érootç”¨æˆ·
    read_only: yes                 # åªè¯»æ ¹æ–‡ä»¶ç³»ç»Ÿ
    tmpfs:
      - /tmp
      - /var/run
    security_opts:
      - no-new-privileges:true     # ç¦æ­¢è·å–æ–°æƒé™
    cap_drop:
      - ALL                        # åˆ é™¤æ‰€æœ‰æƒé™
    cap_add:
      - NET_BIND_SERVICE           # åªæ·»åŠ å¿…éœ€æƒé™
```

### 10.3 é•œåƒå®‰å…¨æ‰«æ


**é›†æˆå®‰å…¨æ‰«æ**
```yaml
- name: æ‰«æé•œåƒæ¼æ´
  shell: |
    docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
    aquasec/trivy image {{ image_name }}:{{ image_tag }}
  register: scan_result
  
- name: æ£€æŸ¥æ‰«æç»“æœ
  fail:
    msg: "é•œåƒå­˜åœ¨é«˜å±æ¼æ´ï¼Œè¯·æ£€æŸ¥"
  when: "'HIGH' in scan_result.stdout or 'CRITICAL' in scan_result.stdout"
```

### 10.4 å¯†é’¥ç®¡ç†


**å®‰å…¨çš„å¯†é’¥ä¼ é€’**
```yaml
- name: ä½¿ç”¨Docker secrets
  docker_secret:
    name: app_password
    data: "{{ app_password | b64encode }}"
    
- name: åœ¨å®¹å™¨ä¸­ä½¿ç”¨secret
  docker_container:
    name: secure-app
    image: myapp:latest
    secrets:
      - app_password
```

---

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å®¹å™¨ç¼–æ’ï¼šè‡ªåŠ¨åŒ–ç®¡ç†å®¹å™¨å…¨ç”Ÿå‘½å‘¨æœŸçš„æŠ€æœ¯
ğŸ”¸ docker_containerï¼šAnsibleç®¡ç†Dockerå®¹å™¨çš„æ ¸å¿ƒæ¨¡å—
ğŸ”¸ é•œåƒç®¡ç†ï¼šåŒ…æ‹¬æ‹‰å–ã€æ„å»ºã€æ¸…ç†é•œåƒçš„å®Œæ•´æµç¨‹
ğŸ”¸ ç½‘ç»œéš”ç¦»ï¼šé€šè¿‡è‡ªå®šä¹‰ç½‘ç»œå®ç°æœåŠ¡é—´çš„å®‰å…¨é€šä¿¡
ğŸ”¸ æ•°æ®æŒä¹…åŒ–ï¼šä½¿ç”¨æ•°æ®å·ä¿è¯é‡è¦æ•°æ®ä¸ä¸¢å¤±
ğŸ”¸ Composeé›†æˆï¼šé€šè¿‡Ansibleç®¡ç†å¤æ‚çš„å¤šå®¹å™¨åº”ç”¨
```

### 11.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å®¹å™¨ vs è™šæ‹Ÿæœº**
```
å®¹å™¨çš„ä¼˜åŠ¿ï¼š
- å¯åŠ¨é€Ÿåº¦ï¼šç§’çº§ vs åˆ†é’Ÿçº§
- èµ„æºå ç”¨ï¼šå…±äº«å†…æ ¸ vs ç‹¬ç«‹ç³»ç»Ÿ
- éƒ¨ç½²å¯†åº¦ï¼šåŒç¡¬ä»¶å¯è¿è¡Œæ›´å¤šå®ä¾‹
- é•œåƒå¤§å°ï¼šMBçº§ vs GBçº§
```

**ğŸ”¹ æ•°æ®æŒä¹…åŒ–ç­–ç•¥**
```
é€‰æ‹©åŸåˆ™ï¼š
- é…ç½®æ–‡ä»¶ â†’ ç»‘å®šæŒ‚è½½ï¼ˆ/host/path:/container/pathï¼‰
- åº”ç”¨æ•°æ® â†’ å‘½åå·ï¼ˆvolume_name:/data/pathï¼‰
- ä¸´æ—¶æ–‡ä»¶ â†’ tmpfsï¼ˆå†…å­˜æ–‡ä»¶ç³»ç»Ÿï¼‰
- æ—¥å¿—æ–‡ä»¶ â†’ æ ¹æ®é‡è¦æ€§é€‰æ‹©
```

**ğŸ”¹ ç½‘ç»œè®¾è®¡æ€è·¯**
```
ç½‘ç»œè§„åˆ’ï¼š
- å‰ç«¯ç½‘ç»œï¼šWebæœåŠ¡å™¨è®¿é—®
- åç«¯ç½‘ç»œï¼šåº”ç”¨å’Œæ•°æ®åº“é€šä¿¡
- ç®¡ç†ç½‘ç»œï¼šç›‘æ§å’Œç®¡ç†æœåŠ¡
- å„ç½‘ç»œé—´é€‚å½“éš”ç¦»ï¼Œæé«˜å®‰å…¨æ€§
```

### 11.3 å®é™…åº”ç”¨åœºæ™¯


**ğŸ“Š å…¸å‹éƒ¨ç½²æ¶æ„**
```
å®Œæ•´åº”ç”¨æ ˆï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Nginx     â”‚    â”‚   åº”ç”¨æœåŠ¡   â”‚    â”‚   æ•°æ®åº“     â”‚
â”‚  (åå‘ä»£ç†)  â”‚â”â”â”â–¶â”‚   (ä¸šåŠ¡é€»è¾‘) â”‚â”â”â”â–¶â”‚  (æ•°æ®å­˜å‚¨)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†‘                   â†‘                   â†‘
   å‰ç«¯ç½‘ç»œ           åº”ç”¨ç½‘ç»œ           æ•°æ®ç½‘ç»œ
```

**ğŸš€ éƒ¨ç½²æµç¨‹æ ‡å‡†åŒ–**
```
è‡ªåŠ¨åŒ–éƒ¨ç½²æ­¥éª¤ï¼š
1. ç¯å¢ƒæ£€æŸ¥ â†’ ç¡®è®¤Dockerç¯å¢ƒ
2. é•œåƒå‡†å¤‡ â†’ æ‹‰å–æˆ–æ„å»ºé•œåƒ
3. ç½‘ç»œåˆ›å»º â†’ å»ºç«‹æœåŠ¡é€šä¿¡ç½‘ç»œ
4. å­˜å‚¨å‡†å¤‡ â†’ åˆ›å»ºæ•°æ®å·
5. å®¹å™¨å¯åŠ¨ â†’ æŒ‰ä¾èµ–é¡ºåºå¯åŠ¨æœåŠ¡
6. å¥åº·æ£€æŸ¥ â†’ éªŒè¯æœåŠ¡çŠ¶æ€
7. ç›‘æ§é…ç½® â†’ è®¾ç½®æ—¥å¿—å’Œç›‘æ§
```

### 11.4 æœ€ä½³å®è·µå»ºè®®


**ğŸ”§ å¼€å‘ç¯å¢ƒå®è·µ**
- ä½¿ç”¨ç»‘å®šæŒ‚è½½å®ç°ä»£ç çƒ­æ›´æ–°
- é…ç½®å¼€å‘ä¸“ç”¨çš„ç¯å¢ƒå˜é‡
- å¯ç”¨è¯¦ç»†æ—¥å¿—è¾“å‡ºä¾¿äºè°ƒè¯•

**ğŸ­ ç”Ÿäº§ç¯å¢ƒå®è·µ**
- ä½¿ç”¨å‘½åå·ä¿è¯æ•°æ®å®‰å…¨
- é…ç½®èµ„æºé™åˆ¶é˜²æ­¢èµ„æºè€—å°½
- å¯ç”¨å¥åº·æ£€æŸ¥å’Œè‡ªåŠ¨é‡å¯
- å®šæœŸæ¸…ç†æ— ç”¨é•œåƒå’Œå®¹å™¨

**ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®**
- ä¼˜åŒ–é•œåƒå¤§å°ï¼ˆå¤šé˜¶æ®µæ„å»ºï¼‰
- åˆç†é…ç½®èµ„æºé™åˆ¶
- ä½¿ç”¨åˆé€‚çš„é‡å¯ç­–ç•¥
- é…ç½®æ—¥å¿—è½®è½¬é¿å…ç£ç›˜æ»¡

**ğŸ”’ å®‰å…¨åŠ å›ºæªæ–½**
- ä½¿ç”¨érootç”¨æˆ·è¿è¡Œå®¹å™¨
- å¯ç”¨åªè¯»æ ¹æ–‡ä»¶ç³»ç»Ÿ
- å®šæœŸæ‰«æé•œåƒå®‰å…¨æ¼æ´
- å®æ–½ç½‘ç»œåˆ†æ®µéš”ç¦»

### 11.5 å¸¸è§é—®é¢˜è§£å†³


**â“ å®¹å™¨æ— æ³•å¯åŠ¨**
```
æ’æŸ¥æ­¥éª¤ï¼š
1. æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨
2. ç¡®è®¤ç«¯å£æ˜¯å¦è¢«å ç”¨
3. éªŒè¯ç¯å¢ƒå˜é‡é…ç½®
4. æŸ¥çœ‹å®¹å™¨æ—¥å¿—ä¿¡æ¯
```

**â“ æ•°æ®ä¸¢å¤±é—®é¢˜**
```
é¢„é˜²æªæ–½ï¼š
1. é‡è¦æ•°æ®å¿…é¡»ä½¿ç”¨æ•°æ®å·
2. å®šæœŸå¤‡ä»½æ•°æ®å·å†…å®¹
3. æµ‹è¯•æ•°æ®æ¢å¤æµç¨‹
4. æ–‡æ¡£åŒ–æ•°æ®å­˜å‚¨ä½ç½®
```

**â“ ç½‘ç»œè¿æ¥é—®é¢˜**
```
è§£å†³æ€è·¯ï¼š
1. æ£€æŸ¥ç½‘ç»œé…ç½®æ˜¯å¦æ­£ç¡®
2. ç¡®è®¤å®¹å™¨åœ¨åŒä¸€ç½‘ç»œä¸­
3. éªŒè¯é˜²ç«å¢™è§„åˆ™
4. æµ‹è¯•ç½‘ç»œè¿é€šæ€§
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- å®¹å™¨ç¼–æ’è®©éƒ¨ç½²å˜å¾—ç®€å•å¯é‡å¤
- Ansible + Docker = å¼ºå¤§çš„è‡ªåŠ¨åŒ–ç»„åˆ
- å®‰å…¨å’Œç›‘æ§ä»ä¸€å¼€å§‹å°±è¦è€ƒè™‘
- å®è·µä¸­ä¸æ–­ä¼˜åŒ–å’Œæ”¹è¿›é…ç½®