---
title: 6ã€ç”¨æˆ·æƒé™æ¨¡å—
---
## ğŸ“š ç›®å½•

1. [ç”¨æˆ·æƒé™ç®¡ç†æ¦‚è¿°](#1-ç”¨æˆ·æƒé™ç®¡ç†æ¦‚è¿°)
2. [useræ¨¡å—-ç”¨æˆ·ç®¡ç†](#2-useræ¨¡å—-ç”¨æˆ·ç®¡ç†)
3. [groupæ¨¡å—-ç»„ç®¡ç†](#3-groupæ¨¡å—-ç»„ç®¡ç†)
4. [authorized_keyæ¨¡å—-SSHå¯†é’¥ç®¡ç†](#4-authorized_keyæ¨¡å—-SSHå¯†é’¥ç®¡ç†)
5. [aclæ¨¡å—-è®¿é—®æ§åˆ¶åˆ—è¡¨](#5-aclæ¨¡å—-è®¿é—®æ§åˆ¶åˆ—è¡¨)
6. [sudoæƒé™é…ç½®](#6-sudoæƒé™é…ç½®)
7. [å®æˆ˜æ¡ˆä¾‹æ•´åˆ](#7-å®æˆ˜æ¡ˆä¾‹æ•´åˆ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” ç”¨æˆ·æƒé™ç®¡ç†æ¦‚è¿°


### 1.1 ä¸ºä»€ä¹ˆéœ€è¦ç”¨æˆ·æƒé™ç®¡ç†


åœ¨Linuxç³»ç»Ÿä¸­ï¼Œ**ç”¨æˆ·æƒé™ç®¡ç†**æ˜¯ç³»ç»Ÿå®‰å…¨çš„åŸºç¡€ã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯æ§åˆ¶"è°èƒ½åšä»€ä¹ˆ"ã€‚

```
ç°å®åœºæ™¯æ¯”å–»ï¼š
å…¬å¸åŠå…¬æ¥¼ = Linuxç³»ç»Ÿ
å‘˜å·¥ = ç”¨æˆ·è´¦å·
éƒ¨é—¨ = ç”¨æˆ·ç»„
é—¨ç¦å¡ = æƒé™
ä¸åŒæ¥¼å±‚çš„è®¿é—®æƒé™ = æ–‡ä»¶/ç›®å½•æƒé™
```

### 1.2 Ansibleç”¨æˆ·æƒé™ç®¡ç†æ ¸å¿ƒæ¨¡å—


| æ¨¡å—å | **ä¸»è¦ä½œç”¨** | **å…¸å‹ä½¿ç”¨åœºæ™¯** |
|--------|-------------|-----------------|
| `user` | ç®¡ç†ç³»ç»Ÿç”¨æˆ·è´¦å· | åˆ›å»ºåº”ç”¨è´¦å·ã€è®¾ç½®å¯†ç ã€é…ç½®Shell |
| `group` | ç®¡ç†ç”¨æˆ·ç»„ | åˆ›å»ºé¡¹ç›®ç»„ã€éƒ¨é—¨ç»„ç»‡æ¶æ„ |
| `authorized_key` | ç®¡ç†SSHå…¬é’¥ | æ— å¯†ç ç™»å½•ã€å¯†é’¥åˆ†å‘ |
| `acl` | ç²¾ç»†åŒ–æƒé™æ§åˆ¶ | ç‰¹æ®Šæƒé™éœ€æ±‚ã€æ–‡ä»¶å…±äº« |

### 1.3 æƒé™ç®¡ç†çš„åŸºæœ¬æ€è·¯


```
ç”¨æˆ·æƒé™ç®¡ç†æµç¨‹ï¼š
ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºç”¨æˆ·ç»„ (group) â†’ å®šä¹‰æƒé™èŒƒå›´
ç¬¬äºŒæ­¥ï¼šåˆ›å»ºç”¨æˆ· (user) â†’ åˆ†é…åˆ°åˆé€‚çš„ç»„
ç¬¬ä¸‰æ­¥ï¼šé…ç½®SSHå¯†é’¥ (authorized_key) â†’ å®‰å…¨ç™»å½•
ç¬¬å››æ­¥ï¼šè®¾ç½®ç‰¹æ®Šæƒé™ (acl) â†’ ç²¾ç»†åŒ–æ§åˆ¶
ç¬¬äº”æ­¥ï¼šé…ç½®sudoæƒé™ â†’ ç®¡ç†å‘˜æƒé™åˆ†é…
```

---

## 2. ğŸ‘¤ useræ¨¡å—-ç”¨æˆ·ç®¡ç†


### 2.1 useræ¨¡å—çš„æ ¸å¿ƒä½œç”¨


`user`æ¨¡å—å°±åƒæ˜¯"äººäº‹éƒ¨é—¨"ï¼Œä¸“é—¨è´Ÿè´£ç®¡ç†ç³»ç»Ÿä¸­çš„ç”¨æˆ·è´¦å·ã€‚å®ƒå¯ä»¥åˆ›å»ºã€åˆ é™¤ã€ä¿®æ”¹ç”¨æˆ·ï¼Œè®¾ç½®å¯†ç ã€é…ç½®ç”¨æˆ·å±æ€§ç­‰ã€‚

> ğŸ’¡ **é€šä¿—ç†è§£**  
> æŠŠuseræ¨¡å—æƒ³è±¡æˆå…¬å¸HRï¼Œè´Ÿè´£å‘˜å·¥å…¥èŒã€ç¦»èŒã€è°ƒå²—ç­‰æ‰€æœ‰äººå‘˜ç®¡ç†å·¥ä½œ

### 2.2 ç”¨æˆ·åˆ›å»ºä¸åŸºæœ¬é…ç½®


**æœ€ç®€å•çš„ç”¨æˆ·åˆ›å»ºï¼š**
```yaml
- name: åˆ›å»ºæ™®é€šç”¨æˆ·
  user:
    name: appuser
    state: present
```

**å®Œæ•´çš„ç”¨æˆ·åˆ›å»ºé…ç½®ï¼š**
```yaml
- name: åˆ›å»ºå®Œæ•´é…ç½®çš„ç”¨æˆ·
  user:
    name: webadmin           # ç”¨æˆ·å
    uid: 1001               # æŒ‡å®šç”¨æˆ·ID
    group: webgroup         # ä¸»ç”¨æˆ·ç»„
    groups: sudo,docker     # é™„åŠ ç”¨æˆ·ç»„
    shell: /bin/bash        # ç™»å½•Shell
    home: /home/webadmin    # å®¶ç›®å½•
    create_home: yes        # åˆ›å»ºå®¶ç›®å½•
    comment: "Webç®¡ç†å‘˜"     # ç”¨æˆ·æè¿°
    state: present          # ç¡®ä¿ç”¨æˆ·å­˜åœ¨
```

### 2.3 å¯†ç ç­–ç•¥è®¾ç½®


> âš ï¸ **é‡è¦æé†’**  
> åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå»ºè®®ä½¿ç”¨SSHå¯†é’¥è€Œä¸æ˜¯å¯†ç ç™»å½•

**è®¾ç½®ç”¨æˆ·å¯†ç ï¼š**
```yaml
- name: è®¾ç½®ç”¨æˆ·å¯†ç 
  user:
    name: appuser
    password: "{{ 'mypassword123' | password_hash('sha512') }}"
    update_password: on_create  # ä»…åœ¨åˆ›å»ºæ—¶è®¾ç½®å¯†ç 
```

**å¯†ç è¿‡æœŸç­–ç•¥ï¼š**
```yaml
- name: é…ç½®å¯†ç è¿‡æœŸç­–ç•¥
  user:
    name: appuser
    password_expire_max: 90    # å¯†ç 90å¤©è¿‡æœŸ
    password_expire_min: 7     # å¯†ç æœ€å°‘7å¤©æ‰èƒ½ä¿®æ”¹
```

### 2.4 ç”¨æˆ·åˆ é™¤ä¸çŠ¶æ€ç®¡ç†


**å®‰å…¨åˆ é™¤ç”¨æˆ·ï¼š**
```yaml
- name: åˆ é™¤ç”¨æˆ·(ä¿ç•™å®¶ç›®å½•)
  user:
    name: olduser
    state: absent
    remove: no              # ä¸åˆ é™¤å®¶ç›®å½•

- name: å½»åº•åˆ é™¤ç”¨æˆ·
  user:
    name: olduser
    state: absent
    remove: yes             # åˆ é™¤å®¶ç›®å½•å’Œé‚®ä»¶
    force: yes              # å¼ºåˆ¶åˆ é™¤(å³ä½¿ç”¨æˆ·æ­£åœ¨ä½¿ç”¨)
```

### 2.5 æ‰¹é‡ç”¨æˆ·ç®¡ç†


**ä½¿ç”¨å¾ªç¯åˆ›å»ºå¤šä¸ªç”¨æˆ·ï¼š**
```yaml
- name: æ‰¹é‡åˆ›å»ºå¼€å‘å›¢é˜Ÿç”¨æˆ·
  user:
    name: "{{ item.name }}"
    group: "{{ item.group }}"
    comment: "{{ item.comment }}"
    state: present
  loop:
    - { name: "dev01", group: "developers", comment: "å‰ç«¯å¼€å‘" }
    - { name: "dev02", group: "developers", comment: "åç«¯å¼€å‘" }
    - { name: "dev03", group: "developers", comment: "æµ‹è¯•å·¥ç¨‹å¸ˆ" }
```

---

## 3. ğŸ‘¥ groupæ¨¡å—-ç»„ç®¡ç†


### 3.1 groupæ¨¡å—çš„æ ¸å¿ƒä½œç”¨


`group`æ¨¡å—è´Ÿè´£ç®¡ç†ç”¨æˆ·ç»„ï¼Œå°±åƒå…¬å¸çš„"éƒ¨é—¨ç®¡ç†"ã€‚é€šè¿‡ç”¨æˆ·ç»„ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¹é‡ç®¡ç†å…·æœ‰ç›¸åŒæƒé™çš„ç”¨æˆ·ã€‚

> ğŸ’¡ **é€šä¿—ç†è§£**  
> ç”¨æˆ·ç»„å°±åƒéƒ¨é—¨ï¼ŒåŒä¸€ä¸ªéƒ¨é—¨çš„äººé€šå¸¸æœ‰ç›¸ä¼¼çš„æƒé™ã€‚æ¯”å¦‚"å¼€å‘ç»„"éƒ½èƒ½è®¿é—®ä»£ç åº“ï¼Œ"è¿ç»´ç»„"éƒ½èƒ½ç®¡ç†æœåŠ¡å™¨

### 3.2 åŸºæœ¬ç»„ç®¡ç†æ“ä½œ


**åˆ›å»ºç”¨æˆ·ç»„ï¼š**
```yaml
- name: åˆ›å»ºå¼€å‘ç»„
  group:
    name: developers
    gid: 2001              # æŒ‡å®šç»„ID
    state: present

- name: åˆ›å»ºç³»ç»Ÿç»„
  group:
    name: nginx
    system: yes            # åˆ›å»ºç³»ç»Ÿç»„(GID < 1000)
    state: present
```

**åˆ é™¤ç”¨æˆ·ç»„ï¼š**
```yaml
- name: åˆ é™¤ç”¨æˆ·ç»„
  group:
    name: oldgroup
    state: absent
```

### 3.3 ç»„ç»‡æ¶æ„è®¾è®¡ç¤ºä¾‹


```
å…¬å¸ç»„ç»‡æ¶æ„æ˜ å°„åˆ°Linuxç»„ï¼š

                å…¬å¸ (system)
                    |
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        |          |          |
    å¼€å‘éƒ¨      è¿ç»´éƒ¨      è´¢åŠ¡éƒ¨
   (dev)      (ops)      (finance)
        |          |          |
    â”Œâ”€â”€â”€â”¼â”€â”€â”€â”  â”Œâ”€â”€â”€â”¼â”€â”€â”€â”     |
   å‰ç«¯  åç«¯  ç³»ç»Ÿ  å®‰å…¨    ä¼šè®¡
  (web) (api)(sys)(sec)  (account)
```

**å®ç°ç»„ç»‡æ¶æ„ï¼š**
```yaml
- name: åˆ›å»ºå…¬å¸ç»„ç»‡æ¶æ„
  group:
    name: "{{ item }}"
    state: present
  loop:
    - company
    - developers
    - operations
    - finance
    - frontend
    - backend
    - sysadmin
    - security
```

---

## 4. ğŸ”‘ authorized_keyæ¨¡å—-SSHå¯†é’¥ç®¡ç†


### 4.1 ä¸ºä»€ä¹ˆè¦ä½¿ç”¨SSHå¯†é’¥


SSHå¯†é’¥è®¤è¯æ¯”å¯†ç è®¤è¯æ›´å®‰å…¨ã€æ›´æ–¹ä¾¿ï¼š

| è®¤è¯æ–¹å¼ | **å®‰å…¨æ€§** | **ä¾¿åˆ©æ€§** | **é€‚ç”¨åœºæ™¯** |
|---------|-----------|-----------|-------------|
| å¯†ç è®¤è¯ | ä½ï¼ˆå¯è¢«æš´åŠ›ç ´è§£ï¼‰ | éœ€è¦è®°å¿†å¯†ç  | ä¸´æ—¶è®¿é—® |
| å¯†é’¥è®¤è¯ | é«˜ï¼ˆå‡ ä¹æ— æ³•ç ´è§£ï¼‰ | è‡ªåŠ¨è®¤è¯ | æ—¥å¸¸è¿ç»´ã€è‡ªåŠ¨åŒ– |

### 4.2 SSHå¯†é’¥çš„å·¥ä½œåŸç†


```
SSHå¯†é’¥è®¤è¯æµç¨‹ï¼š
å®¢æˆ·ç«¯                                    æœåŠ¡å™¨
   |                                       |
   |--[1]å‘èµ·è¿æ¥è¯·æ±‚-------------------->|
   |                                       |
   |<-[2]å‘é€éšæœºæŒ‘æˆ˜æ•°æ®------------------|
   |                                       |
   |--[3]ç”¨ç§é’¥ç­¾åæŒ‘æˆ˜æ•°æ®--------------->|
   |                                       |
   |<-[4]éªŒè¯ç­¾åæˆåŠŸ,å…è®¸ç™»å½•-------------|
```

### 4.3 å¯†é’¥åˆ†å‘ä¸ç®¡ç†


**æ·»åŠ SSHå…¬é’¥ï¼š**
```yaml
- name: ä¸ºç”¨æˆ·æ·»åŠ SSHå…¬é’¥
  authorized_key:
    user: webadmin
    state: present
    key: "{{ lookup('file', '/path/to/public_key.pub') }}"
    comment: "webadminçš„å·¥ä½œå¯†é’¥"
```

**ä»å­—ç¬¦ä¸²æ·»åŠ å¯†é’¥ï¼š**
```yaml
- name: ç›´æ¥æŒ‡å®šå…¬é’¥å†…å®¹
  authorized_key:
    user: appuser
    state: present
    key: "ssh-rsa AAAAB3NzaC1yc2EAAAA... user@hostname"
```

**æ‰¹é‡åˆ†å‘å¯†é’¥ï¼š**
```yaml
- name: æ‰¹é‡åˆ†å‘ç®¡ç†å‘˜å¯†é’¥
  authorized_key:
    user: "{{ item }}"
    state: present
    key: "{{ admin_public_key }}"
  loop:
    - webadmin
    - dbadmin  
    - appuser
```

### 4.4 å¯†é’¥é€‰é¡¹é…ç½®


**é™åˆ¶å¯†é’¥ä½¿ç”¨ï¼š**
```yaml
- name: æ·»åŠ å—é™åˆ¶çš„å¯†é’¥
  authorized_key:
    user: backup
    state: present
    key: "{{ backup_public_key }}"
    key_options: 'from="192.168.1.100",command="/usr/local/bin/backup.sh",no-pty'
```

å¸¸ç”¨å¯†é’¥é€‰é¡¹è¯´æ˜ï¼š
- `from="IPåœ°å€"`: é™åˆ¶æ¥æºIP
- `command="å‘½ä»¤"`: å¼ºåˆ¶æ‰§è¡Œç‰¹å®šå‘½ä»¤
- `no-pty`: ç¦æ­¢åˆ†é…ç»ˆç«¯
- `no-agent-forwarding`: ç¦æ­¢ä»£ç†è½¬å‘

### 4.5 å¯†é’¥è½®æ¢ä¸å®‰å…¨ç®¡ç†


**ç§»é™¤æ—§å¯†é’¥ï¼š**
```yaml
- name: ç§»é™¤è¿‡æœŸå¯†é’¥
  authorized_key:
    user: appuser
    state: absent
    key: "{{ old_public_key }}"
```

**ç‹¬å æ¨¡å¼ç®¡ç†ï¼š**
```yaml
- name: ç‹¬å ç®¡ç†ç”¨æˆ·å¯†é’¥
  authorized_key:
    user: appuser
    state: present
    exclusive: yes           # åˆ é™¤å…¶ä»–æ‰€æœ‰å¯†é’¥
    key: "{{ current_keys | join('\n') }}"
```

---

## 5. ğŸ¯ aclæ¨¡å—-è®¿é—®æ§åˆ¶åˆ—è¡¨


### 5.1 ä»€ä¹ˆæ˜¯ACLè®¿é—®æ§åˆ¶


ä¼ ç»Ÿçš„Linuxæƒé™åªæœ‰"æ‰€æœ‰è€…ã€ç»„ã€å…¶ä»–äºº"ä¸‰ç§èº«ä»½ï¼ŒACL(Access Control List)å¯ä»¥ä¸ºä»»æ„ç”¨æˆ·æˆ–ç»„è®¾ç½®æƒé™ã€‚

> ğŸ’¡ **é€šä¿—æ¯”å–»**  
> ä¼ ç»Ÿæƒé™åƒæ˜¯"åŒ…å¢é—¨ç¦"ï¼Œåªèƒ½è®¾ç½®VIPã€ä¼šå‘˜ã€æ™®é€šå®¢æˆ·ä¸‰ä¸ªçº§åˆ«  
> ACLæƒé™åƒæ˜¯"ä¸ªæ€§åŒ–é—¨ç¦"ï¼Œå¯ä»¥ä¸ºæ¯ä¸ªäººå•ç‹¬è®¾ç½®ä¸åŒçš„è®¿é—®æƒé™

### 5.2 ACLåŸºæœ¬æ¦‚å¿µ


```
ä¼ ç»Ÿæƒé™ vs ACLæƒé™å¯¹æ¯”ï¼š

ä¼ ç»Ÿæƒé™ï¼š
æ–‡ä»¶æ‰€æœ‰è€…: rwx (è¯»å†™æ‰§è¡Œ)
æ–‡ä»¶ç»„:    r-x (è¯»å’Œæ‰§è¡Œ)  
å…¶ä»–äºº:    r-- (åªè¯»)

ACLæƒé™ï¼š
æ–‡ä»¶æ‰€æœ‰è€…: rwx
æ–‡ä»¶ç»„:    r-x
ç”¨æˆ·alice: rw- (ç‰¹æ®ŠæŒ‡å®š)
ç”¨æˆ·bob:   r-- (ç‰¹æ®ŠæŒ‡å®š)
ç»„admin:   rwx (ç‰¹æ®ŠæŒ‡å®š)
å…¶ä»–äºº:    --- (æ— æƒé™)
```

### 5.3 ACLæƒé™è®¾ç½®


**ä¸ºç‰¹å®šç”¨æˆ·è®¾ç½®ACLï¼š**
```yaml
- name: ç»™aliceç”¨æˆ·è®¾ç½®æ–‡ä»¶è¯»å†™æƒé™
  acl:
    path: /var/log/app.log
    entity: alice
    etype: user
    permissions: rw
    state: present
```

**ä¸ºç‰¹å®šç»„è®¾ç½®ACLï¼š**
```yaml
- name: ç»™adminç»„è®¾ç½®ç›®å½•å…¨éƒ¨æƒé™
  acl:
    path: /var/www/html
    entity: admin
    etype: group
    permissions: rwx
    recursive: yes          # é€’å½’åº”ç”¨åˆ°å­ç›®å½•
    state: present
```

### 5.4 é»˜è®¤ACLè®¾ç½®


**è®¾ç½®ç›®å½•é»˜è®¤ACLï¼š**
```yaml
- name: è®¾ç½®ç›®å½•é»˜è®¤ACL
  acl:
    path: /shared/project
    entity: developers
    etype: group
    permissions: rwx
    default: yes           # æ–°å»ºæ–‡ä»¶ç»§æ‰¿æ­¤æƒé™
    state: present
```

### 5.5 ACLæƒé™æŸ¥çœ‹ä¸åˆ é™¤


**åˆ é™¤ç‰¹å®šACLï¼š**
```yaml
- name: åˆ é™¤ç”¨æˆ·çš„ACLæƒé™
  acl:
    path: /var/log/app.log
    entity: alice
    etype: user
    state: absent
```

**æ¸…ç©ºæ‰€æœ‰ACLï¼š**
```yaml
- name: æ¸…ç©ºæ–‡ä»¶æ‰€æœ‰ACL
  acl:
    path: /tmp/testfile
    state: absent
```

---

## 6. âš¡ sudoæƒé™é…ç½®


### 6.1 sudoæƒé™çš„ä½œç”¨


`sudo`è®©æ™®é€šç”¨æˆ·å¯ä»¥ä¸´æ—¶è·å¾—ç®¡ç†å‘˜æƒé™æ‰§è¡Œç‰¹å®šå‘½ä»¤ï¼Œè¿™æ¯”ç›´æ¥ä½¿ç”¨rootè´¦å·æ›´å®‰å…¨ã€‚

> ğŸ” **å®‰å…¨åŸåˆ™**  
> æ—¥å¸¸ä½¿ç”¨æ™®é€šè´¦å·ï¼Œéœ€è¦ç®¡ç†å‘˜æƒé™æ—¶ç”¨sudoï¼Œé¿å…é•¿æ—¶é—´ä½¿ç”¨rootè´¦å·

### 6.2 é€šè¿‡lineinfileæ¨¡å—é…ç½®sudo


**æ·»åŠ ç”¨æˆ·åˆ°sudoç»„ï¼š**
```yaml
- name: å°†ç”¨æˆ·æ·»åŠ åˆ°sudoç»„
  user:
    name: webadmin
    groups: sudo
    append: yes            # è¿½åŠ åˆ°ç»„ï¼Œä¸è¦†ç›–ç°æœ‰ç»„
```

**è‡ªå®šä¹‰sudoè§„åˆ™ï¼š**
```yaml
- name: é…ç½®ç”¨æˆ·ç‰¹å®šsudoæƒé™
  lineinfile:
    path: /etc/sudoers.d/webadmin
    line: "webadmin ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart nginx"
    create: yes
    validate: 'visudo -cf %s'  # éªŒè¯è¯­æ³•æ­£ç¡®æ€§
```

### 6.3 sudoæƒé™é…ç½®ç¤ºä¾‹


**è¿ç»´å›¢é˜Ÿæƒé™é…ç½®ï¼š**
```yaml
- name: é…ç½®è¿ç»´å›¢é˜Ÿsudoæƒé™
  blockinfile:
    path: /etc/sudoers.d/operations
    create: yes
    block: |
      # è¿ç»´ç»„å¯ä»¥ç®¡ç†ç³»ç»ŸæœåŠ¡
      %operations ALL=(ALL) NOPASSWD: /usr/bin/systemctl
      
      # ç³»ç»Ÿç®¡ç†å‘˜å¯ä»¥æ‰§è¡Œæ‰€æœ‰å‘½ä»¤
      %sysadmin ALL=(ALL) NOPASSWD: ALL
      
      # åº”ç”¨ç®¡ç†å‘˜åªèƒ½ç®¡ç†åº”ç”¨ç›¸å…³æœåŠ¡
      %appuser ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart nginx, /usr/bin/systemctl restart mysql
    validate: 'visudo -cf %s'
```

---

## 7. ğŸš€ å®æˆ˜æ¡ˆä¾‹æ•´åˆ


### 7.1 WebæœåŠ¡å™¨ç”¨æˆ·æƒé™é…ç½®


è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„WebæœåŠ¡å™¨ç”¨æˆ·æƒé™é…ç½®æ¡ˆä¾‹ï¼š

```yaml
---
- name: WebæœåŠ¡å™¨ç”¨æˆ·æƒé™å®Œæ•´é…ç½®
  hosts: webservers
  become: yes
  vars:
    web_admin_key: "ssh-rsa AAAAB3NzaC1yc2EAAAA... webadmin@company.com"
    
  tasks:
    # ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºç”¨æˆ·ç»„
    - name: åˆ›å»ºWebç›¸å…³ç”¨æˆ·ç»„
      group:
        name: "{{ item }}"
        state: present
      loop:
        - webadmin
        - webuser
        - nginx

    # ç¬¬äºŒæ­¥ï¼šåˆ›å»ºç”¨æˆ·
    - name: åˆ›å»ºWebç®¡ç†å‘˜
      user:
        name: webadmin
        group: webadmin
        groups: sudo
        shell: /bin/bash
        home: /home/webadmin
        create_home: yes
        comment: "WebæœåŠ¡å™¨ç®¡ç†å‘˜"
        
    - name: åˆ›å»ºWebåº”ç”¨ç”¨æˆ·
      user:
        name: webuser
        group: webuser
        groups: nginx
        shell: /bin/bash
        home: /var/www
        create_home: yes
        system: yes
        comment: "Webåº”ç”¨è¿è¡Œç”¨æˆ·"

    # ç¬¬ä¸‰æ­¥ï¼šé…ç½®SSHå¯†é’¥
    - name: é…ç½®ç®¡ç†å‘˜SSHå¯†é’¥
      authorized_key:
        user: webadmin
        key: "{{ web_admin_key }}"
        state: present

    # ç¬¬å››æ­¥ï¼šè®¾ç½®ç›®å½•ACLæƒé™
    - name: è®¾ç½®Webç›®å½•ACLæƒé™
      acl:
        path: /var/www/html
        entity: "{{ item.user }}"
        etype: "{{ item.type }}"
        permissions: "{{ item.perms }}"
        recursive: yes
        state: present
      loop:
        - { user: "webadmin", type: "user", perms: "rwx" }
        - { user: "webuser", type: "user", perms: "rx" }
        - { user: "nginx", type: "group", perms: "rx" }

    # ç¬¬äº”æ­¥ï¼šé…ç½®sudoæƒé™
    - name: é…ç½®Webç®¡ç†å‘˜sudoæƒé™
      lineinfile:
        path: /etc/sudoers.d/webadmin
        line: "webadmin ALL=(ALL) NOPASSWD: /usr/bin/systemctl * nginx, /usr/bin/systemctl * php*"
        create: yes
        validate: 'visudo -cf %s'
```

### 7.2 å¼€å‘ç¯å¢ƒç”¨æˆ·é…ç½®


**å¼€å‘å›¢é˜Ÿæ‰¹é‡é…ç½®ï¼š**
```yaml
- name: é…ç½®å¼€å‘å›¢é˜Ÿç¯å¢ƒ
  hosts: dev_servers
  become: yes
  vars:
    developers:
      - { name: "alice", key_file: "alice_key.pub", role: "frontend" }
      - { name: "bob", key_file: "bob_key.pub", role: "backend" }
      - { name: "carol", key_file: "carol_key.pub", role: "fullstack" }
  
  tasks:
    - name: åˆ›å»ºå¼€å‘ç»„
      group:
        name: developers
        gid: 3000
        
    - name: åˆ›å»ºå¼€å‘äººå‘˜è´¦å·
      user:
        name: "{{ item.name }}"
        group: developers
        groups: docker
        comment: "{{ item.role }}å¼€å‘å·¥ç¨‹å¸ˆ"
        shell: /bin/bash
      loop: "{{ developers }}"
      
    - name: åˆ†å‘SSHå¯†é’¥
      authorized_key:
        user: "{{ item.name }}"
        key: "{{ lookup('file', 'keys/' + item.key_file) }}"
        state: present
      loop: "{{ developers }}"
```

### 7.3 å®‰å…¨åŠ å›ºé…ç½®


**ç”¨æˆ·å®‰å…¨ç­–ç•¥ï¼š**
```yaml
- name: ç”¨æˆ·å®‰å…¨åŠ å›ºé…ç½®
  hosts: all
  become: yes
  tasks:
    # ç¦ç”¨rootè¿œç¨‹ç™»å½•
    - name: ç¦ç”¨rootç”¨æˆ·SSHç™»å½•
      user:
        name: root
        password_lock: yes
        
    # è®¾ç½®å¯†ç è¿‡æœŸç­–ç•¥
    - name: é…ç½®å¯†ç å®‰å…¨ç­–ç•¥
      user:
        name: "{{ item }}"
        password_expire_max: 90
        password_expire_min: 7
        password_expire_warn: 14
      loop: "{{ regular_users }}"
      
    # æ¸…ç†æ— ç”¨è´¦å·
    - name: åˆ é™¤ç³»ç»Ÿé»˜è®¤æ— ç”¨è´¦å·
      user:
        name: "{{ item }}"
        state: absent
      loop:
        - games
        - news
        - uucp
      ignore_errors: yes
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ useræ¨¡å—ï¼šç”¨æˆ·ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œåˆ›å»ºã€é…ç½®ã€åˆ é™¤ç”¨æˆ·è´¦å·
ğŸ”¸ groupæ¨¡å—ï¼šç”¨æˆ·ç»„ç®¡ç†ï¼Œå®ç°æƒé™çš„æ‰¹é‡åˆ†é…
ğŸ”¸ authorized_keyæ¨¡å—ï¼šSSHå¯†é’¥ç®¡ç†ï¼Œå®ç°å®‰å…¨çš„æ— å¯†ç è®¤è¯
ğŸ”¸ aclæ¨¡å—ï¼šç²¾ç»†åŒ–æƒé™æ§åˆ¶ï¼Œçªç ´ä¼ ç»Ÿæƒé™é™åˆ¶
ğŸ”¸ sudoæƒé™ï¼šå®‰å…¨çš„æƒé™æå‡æœºåˆ¶
```

### 8.2 å®é™…åº”ç”¨æœ€ä½³å®è·µ


**ğŸ”¹ ç”¨æˆ·ç®¡ç†ç­–ç•¥**
```
ç”¨æˆ·åˆ›å»ºåŸåˆ™ï¼š
â€¢ æŒ‰èŒèƒ½åˆ›å»ºç”¨æˆ·ç»„ï¼Œç”¨æˆ·å½’å±åˆé€‚çš„ç»„
â€¢ ç”Ÿäº§ç¯å¢ƒç¦ç”¨å¯†ç ç™»å½•ï¼Œç»Ÿä¸€ä½¿ç”¨SSHå¯†é’¥
â€¢ è®¾ç½®åˆç†çš„å¯†ç è¿‡æœŸç­–ç•¥
â€¢ åŠæ—¶æ¸…ç†ç¦»èŒäººå‘˜è´¦å·
```

**ğŸ”¹ æƒé™åˆ†é…åŸåˆ™**
```
æœ€å°æƒé™åŸåˆ™ï¼š
â€¢ ç”¨æˆ·åªè·å¾—å®Œæˆå·¥ä½œæ‰€éœ€çš„æœ€å°æƒé™
â€¢ ä½¿ç”¨sudoè€Œä¸æ˜¯ç›´æ¥rootæƒé™
â€¢ å®šæœŸå®¡æŸ¥å’Œæ¸…ç†ä¸å¿…è¦çš„æƒé™
â€¢ é‡è¦æ“ä½œä½¿ç”¨ACLç²¾ç»†åŒ–æ§åˆ¶
```

**ğŸ”¹ å¯†é’¥ç®¡ç†å®‰å…¨**
```
SSHå¯†é’¥ç®¡ç†ï¼š
â€¢ å®šæœŸè½®æ¢å¯†é’¥ï¼Œåˆ é™¤è¿‡æœŸå¯†é’¥
â€¢ ä½¿ç”¨å¯†é’¥é€‰é¡¹é™åˆ¶ä½¿ç”¨åœºæ™¯
â€¢ ä¸ºä¸åŒç”¨é€”ä½¿ç”¨ä¸åŒçš„å¯†é’¥å¯¹
â€¢ é›†ä¸­ç®¡ç†å’Œåˆ†å‘å¯†é’¥
```

### 8.3 å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ


| é—®é¢˜ | **åŸå› ** | **è§£å†³æ–¹æ¡ˆ** |
|------|---------|-------------|
| ç”¨æˆ·åˆ›å»ºå¤±è´¥ | ç”¨æˆ·åé‡å¤æˆ–UIDå†²çª | æ£€æŸ¥ç°æœ‰ç”¨æˆ·ï¼ŒæŒ‡å®šä¸åŒçš„UID |
| SSHå¯†é’¥è®¤è¯å¤±è´¥ | å…¬é’¥æ ¼å¼é”™è¯¯æˆ–æƒé™é—®é¢˜ | éªŒè¯å…¬é’¥æ ¼å¼ï¼Œæ£€æŸ¥~/.sshç›®å½•æƒé™ |
| ACLè®¾ç½®ä¸ç”Ÿæ•ˆ | æ–‡ä»¶ç³»ç»Ÿä¸æ”¯æŒACL | é‡æ–°æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿå¹¶å¯ç”¨ACL |
| sudoæƒé™ä¸ç”Ÿæ•ˆ | sudoersæ–‡ä»¶è¯­æ³•é”™è¯¯ | ä½¿ç”¨visudoéªŒè¯è¯­æ³• |

### 8.4 è‡ªåŠ¨åŒ–è¿ç»´ä»·å€¼


- **æ ‡å‡†åŒ–ç®¡ç†**ï¼šç»Ÿä¸€çš„ç”¨æˆ·åˆ›å»ºå’Œæƒé™é…ç½®æµç¨‹
- **å®‰å…¨æ€§æå‡**ï¼šè‡ªåŠ¨åŒ–çš„å¯†é’¥åˆ†å‘å’Œæƒé™æ§åˆ¶
- **æ•ˆç‡æå‡**ï¼šæ‰¹é‡æ“ä½œï¼Œé¿å…é‡å¤æ‰‹å·¥é…ç½®
- **å®¡è®¡è¿½è¸ª**ï¼šæ‰€æœ‰æ“ä½œéƒ½æœ‰è®°å½•ï¼Œä¾¿äºå®‰å…¨å®¡è®¡
- **ä¸€è‡´æ€§ä¿è¯**ï¼šç¡®ä¿æ‰€æœ‰æœåŠ¡å™¨çš„ç”¨æˆ·æƒé™é…ç½®ä¸€è‡´

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
ç”¨æˆ·ç»„ç»‡è¦è§„åˆ’ï¼Œæƒé™åˆ†é…è¦åˆç†
å¯†é’¥è®¤è¯æ›¿å¯†ç ï¼ŒACLç²¾æ§æ›´å®‰å…¨
sudoææƒè¦å®¡æ…ï¼Œå®šæœŸæ¸…ç†ä¿å®‰å…¨
è‡ªåŠ¨é…ç½®æ ‡å‡†åŒ–ï¼Œè¿ç»´æ•ˆç‡å¤§æå‡
```