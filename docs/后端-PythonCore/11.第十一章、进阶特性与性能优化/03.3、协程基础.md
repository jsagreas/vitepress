---
title: 3ã€åç¨‹åŸºç¡€
---
## ğŸ“š ç›®å½•

1. [åç¨‹æ¦‚å¿µä¸åŸºç¡€ç†è§£](#1-åç¨‹æ¦‚å¿µä¸åŸºç¡€ç†è§£)
2. [ç”Ÿæˆå™¨å®ç°åç¨‹](#2-ç”Ÿæˆå™¨å®ç°åç¨‹)
3. [åç¨‹çŠ¶æ€ç®¡ç†ä¸ç”Ÿå‘½å‘¨æœŸ](#3-åç¨‹çŠ¶æ€ç®¡ç†ä¸ç”Ÿå‘½å‘¨æœŸ)
4. [åç¨‹é€šä¿¡æœºåˆ¶](#4-åç¨‹é€šä¿¡æœºåˆ¶)
5. [å¼‚æ­¥ç”Ÿæˆå™¨è¯¦è§£](#5-å¼‚æ­¥ç”Ÿæˆå™¨è¯¦è§£)
6. [åç¨‹è°ƒåº¦å™¨åŸç†](#6-åç¨‹è°ƒåº¦å™¨åŸç†)
7. [åç¨‹ä¸å¹¶å‘ç¼–ç¨‹](#7-åç¨‹ä¸å¹¶å‘ç¼–ç¨‹)
8. [åç¨‹æœ€ä½³å®è·µæŒ‡å—](#8-åç¨‹æœ€ä½³å®è·µæŒ‡å—)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒŸ åç¨‹æ¦‚å¿µä¸åŸºç¡€ç†è§£


### 1.1 ä»€ä¹ˆæ˜¯åç¨‹


**ğŸ”¸ åç¨‹çš„é€šä¿—ç†è§£**

æƒ³è±¡ä½ åœ¨åšé¥­ï¼Œéœ€è¦åŒæ—¶å¤„ç†å¤šä¸ªä»»åŠ¡ï¼š
```
æ™®é€šå‡½æ•°ï¼šä¸€æ­¥æ­¥åšå®Œä¸€é“èœï¼Œå†åšä¸‹ä¸€é“
åç¨‹ï¼šç‚’èœæ—¶ï¼Œè¶ç€ç­‰é”…çƒ­çš„é—´éš™å»æ´—èœï¼Œæ´—èœé—´éš™åˆå»åˆ‡è‚‰
```

åç¨‹å°±æ˜¯è¿™æ ·ä¸€ç§**å¯ä»¥æš‚åœå’Œæ¢å¤æ‰§è¡Œ**çš„å‡½æ•°ï¼Œå®ƒèƒ½åœ¨åˆé€‚çš„æ—¶æœºä¸»åŠ¨è®©å‡ºæ§åˆ¶æƒï¼Œè®©å…¶ä»–åç¨‹è¿è¡Œï¼Œä»è€Œå®ç°**åä½œå¼å¤šä»»åŠ¡**ã€‚

**ğŸ’¡ åç¨‹çš„æ ¸å¿ƒç‰¹ç‚¹**
- **å¯æš‚åœ**ï¼šå‡½æ•°æ‰§è¡Œåˆ°æŸä¸ªç‚¹æ—¶å¯ä»¥æš‚åœ
- **å¯æ¢å¤**ï¼šæš‚åœåå¯ä»¥ä»æš‚åœç‚¹ç»§ç»­æ‰§è¡Œ
- **ä¿æŒçŠ¶æ€**ï¼šæš‚åœæ—¶ä¿ç•™å±€éƒ¨å˜é‡å’Œæ‰§è¡ŒçŠ¶æ€
- **åä½œå¼**ï¼šä¸»åŠ¨è®©å‡ºæ§åˆ¶æƒï¼Œè€Œéè¢«å¼ºåˆ¶åˆ‡æ¢

### 1.2 åç¨‹ä¸å…¶ä»–æ¦‚å¿µçš„åŒºåˆ«


```
æ‰§è¡Œæ–¹å¼å¯¹æ¯”ï¼š

æ™®é€šå‡½æ•°ï¼š
def cook_rice():
    print("æ´—ç±³")
    print("åŠ æ°´") 
    print("ç…®é¥­")
    return "ç±³é¥­"

çº¿ç¨‹ï¼š
import threading
thread1 = threading.Thread(target=cook_rice)
thread2 = threading.Thread(target=cook_soup)
# ç³»ç»Ÿæ§åˆ¶åˆ‡æ¢ï¼Œå¯èƒ½éšæ—¶è¢«æ‰“æ–­

åç¨‹ï¼š
async def cook_rice():
    print("æ´—ç±³")
    await asyncio.sleep(1)  # ä¸»åŠ¨è®©å‡ºæ§åˆ¶æƒ
    print("åŠ æ°´")
    await asyncio.sleep(5)  # ç…®é¥­æ—¶è®©å…¶ä»–åç¨‹è¿è¡Œ
    print("ç…®é¥­å®Œæˆ")
    return "ç±³é¥­"
```

| ç‰¹æ€§å¯¹æ¯” | **æ™®é€šå‡½æ•°** | **çº¿ç¨‹** | **åç¨‹** |
|---------|------------|---------|---------|
| **æ‰§è¡Œæ–¹å¼** | `é¡ºåºæ‰§è¡Œï¼Œä¸å¯ä¸­æ–­` | `æŠ¢å å¼å¤šä»»åŠ¡` | `åä½œå¼å¤šä»»åŠ¡` |
| **åˆ‡æ¢æ§åˆ¶** | `æ— åˆ‡æ¢` | `ç³»ç»Ÿæ§åˆ¶` | `ç¨‹åºå‘˜æ§åˆ¶` |
| **å†…å­˜å¼€é”€** | `æœ€å°` | `è¾ƒå¤§(æ ˆç©ºé—´)` | `å¾ˆå°` |
| **åˆ›å»ºæˆæœ¬** | `æä½` | `é«˜` | `ä½` |
| **å¹¶å‘æ•°é‡** | `1` | `å—é™(å‡ åƒä¸ª)` | `å¾ˆé«˜(å‡ ä¸‡ä¸ª)` |

### 1.3 Pythonä¸­çš„åç¨‹å‘å±•å†ç¨‹


**ğŸ“ˆ åç¨‹åœ¨Pythonä¸­çš„æ¼”è¿›**

```
Python 2.5 (2006å¹´)ï¼š
- å¼•å…¥yieldè¡¨è¾¾å¼
- ç”Ÿæˆå™¨å¯ä»¥æ¥æ”¶æ•°æ®
- åç¨‹é›å½¢å‡ºç°

Python 3.3 (2012å¹´)ï¼š
- yield fromè¯­æ³•
- ç®€åŒ–åç¨‹å§”æ‰˜

Python 3.4 (2014å¹´)ï¼š
- asyncioåº“åŠ å…¥æ ‡å‡†åº“
- @asyncio.coroutineè£…é¥°å™¨

Python 3.5+ (2015å¹´)ï¼š
- async/awaitè¯­æ³•
- åŸç”Ÿåç¨‹æ”¯æŒ
- å¼‚æ­¥ç”Ÿæˆå™¨å’Œå¼‚æ­¥è¿­ä»£å™¨
```

---

## 2. ğŸ”§ ç”Ÿæˆå™¨å®ç°åç¨‹


### 2.1 ä»ç”Ÿæˆå™¨åˆ°åç¨‹çš„è½¬å˜


**ğŸ”¸ æ™®é€šç”Ÿæˆå™¨å›é¡¾**

```python
def simple_generator():
    print("å¼€å§‹æ‰§è¡Œ")
    yield 1
    print("ä¸­é—´æ‰§è¡Œ")
    yield 2
    print("ç»“æŸæ‰§è¡Œ")
    return "å®Œæˆ"

# ä½¿ç”¨æ–¹å¼
gen = simple_generator()
print(next(gen))  # è¾“å‡ºï¼šå¼€å§‹æ‰§è¡Œ \n 1
print(next(gen))  # è¾“å‡ºï¼šä¸­é—´æ‰§è¡Œ \n 2
```

**ğŸ”¸ ç”Ÿæˆå™¨çš„åŒå‘é€šä¿¡èƒ½åŠ›**

ç”Ÿæˆå™¨ä¸ä»…èƒ½äº§å‡ºæ•°æ®ï¼ˆyieldï¼‰ï¼Œè¿˜èƒ½æ¥æ”¶æ•°æ®ï¼š

```python
def echo_generator():
    print("åç¨‹å¯åŠ¨ï¼Œç­‰å¾…æ•°æ®...")
    try:
        while True:
            received = yield  # æ¥æ”¶å¤–éƒ¨å‘é€çš„æ•°æ®
            print(f"æ”¶åˆ°æ•°æ®: {received}")
    except GeneratorExit:
        print("åç¨‹ç»“æŸ")

# ä½¿ç”¨ç¤ºä¾‹
coro = echo_generator()
next(coro)  # å¯åŠ¨åç¨‹ï¼Œæ‰§è¡Œåˆ°ç¬¬ä¸€ä¸ªyield
coro.send("Hello")      # å‘é€æ•°æ®ç»™åç¨‹
coro.send("World")      # å†å‘é€æ•°æ®
coro.close()            # å…³é—­åç¨‹
```

### 2.2 ç”Ÿæˆå™¨åç¨‹çš„åŸºæœ¬æ¨¡å¼


**ğŸ’¬ æ•°æ®å¤„ç†åç¨‹ç¤ºä¾‹**

```python
def data_processor():
    """æ•°æ®å¤„ç†åç¨‹ - æ¥æ”¶æ•°æ®å¹¶å¤„ç†"""
    total = 0
    count = 0
    
    print("æ•°æ®å¤„ç†å™¨å¯åŠ¨...")
    try:
        while True:
            # æ¥æ”¶æ•°æ®
            value = yield
            if value is None:
                break
                
            # å¤„ç†æ•°æ®
            total += value
            count += 1
            avg = total / count
            print(f"æ”¶åˆ°: {value}, ç´¯è®¡: {total}, å¹³å‡: {avg:.2f}")
            
    except GeneratorExit:
        print(f"å¤„ç†å®Œæˆ: æ€»è®¡{count}ä¸ªæ•°æ®ï¼Œå¹³å‡å€¼{avg:.2f}")

# å®é™…ä½¿ç”¨
processor = data_processor()
next(processor)  # å¯åŠ¨åç¨‹

# å‘é€æ•°æ®è¿›è¡Œå¤„ç†
for num in [10, 20, 30, 40, 50]:
    processor.send(num)

processor.close()
```

### 2.3 åç¨‹è£…é¥°å™¨çš„ä½¿ç”¨


**ğŸ¯ ç®€åŒ–åç¨‹å¯åŠ¨**

æ‰‹åŠ¨è°ƒç”¨ `next()` å¯åŠ¨åç¨‹å¾ˆéº»çƒ¦ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨è£…é¥°å™¨è‡ªåŠ¨åŒ–ï¼š

```python
def coroutine_starter(func):
    """åç¨‹å¯åŠ¨è£…é¥°å™¨"""
    def wrapper(*args, **kwargs):
        coro = func(*args, **kwargs)
        next(coro)  # è‡ªåŠ¨å¯åŠ¨åç¨‹
        return coro
    return wrapper

@coroutine_starter
def auto_echo():
    print("åç¨‹è‡ªåŠ¨å¯åŠ¨!")
    while True:
        msg = yield
        print(f"å›å£°: {msg}")

# ç›´æ¥ä½¿ç”¨ï¼Œæ— éœ€æ‰‹åŠ¨å¯åŠ¨
echo = auto_echo()
echo.send("è‡ªåŠ¨å¯åŠ¨æµ‹è¯•")  # ç›´æ¥å‘é€æ•°æ®
```

### 2.4 åç¨‹çš„å§”æ‰˜ - yield from


**ğŸ”— åç¨‹é“¾å¼è°ƒç”¨**

`yield from` å¯ä»¥è®©ä¸€ä¸ªåç¨‹å§”æ‰˜ç»™å¦ä¸€ä¸ªåç¨‹ï¼š

```python
@coroutine_starter
def sub_coroutine():
    """å­åç¨‹"""
    print("å­åç¨‹å¼€å§‹å·¥ä½œ")
    for i in range(3):
        value = yield
        print(f"å­åç¨‹å¤„ç†: {value}")
    print("å­åç¨‹å·¥ä½œå®Œæˆ")
    return "å­åç¨‹ç»“æœ"

@coroutine_starter  
def main_coroutine():
    """ä¸»åç¨‹"""
    print("ä¸»åç¨‹å¯åŠ¨")
    
    # å§”æ‰˜ç»™å­åç¨‹å¤„ç†
    result = yield from sub_coroutine()
    print(f"å­åç¨‹è¿”å›: {result}")
    
    # ä¸»åç¨‹ç»§ç»­å·¥ä½œ
    while True:
        value = yield
        print(f"ä¸»åç¨‹å¤„ç†: {value}")

# ä½¿ç”¨ç¤ºä¾‹
main = main_coroutine()

# å‰3ä¸ªæ•°æ®ä¼šè¢«å­åç¨‹å¤„ç†
main.send("æ•°æ®1")
main.send("æ•°æ®2") 
main.send("æ•°æ®3")

# åç»­æ•°æ®ç”±ä¸»åç¨‹å¤„ç†
main.send("æ•°æ®4")
```

---

## 3. ğŸ”„ åç¨‹çŠ¶æ€ç®¡ç†ä¸ç”Ÿå‘½å‘¨æœŸ


### 3.1 åç¨‹çš„å››ç§çŠ¶æ€


**ğŸ“Š åç¨‹çŠ¶æ€è¯¦è§£**

```python
import inspect

def demo_coroutine():
    print("åç¨‹å¯åŠ¨")
    x = yield "ç¬¬ä¸€æ¬¡æš‚åœ"
    print(f"æ”¶åˆ°: {x}")
    y = yield "ç¬¬äºŒæ¬¡æš‚åœ"  
    print(f"æ”¶åˆ°: {y}")
    return "åç¨‹ç»“æŸ"

# åˆ›å»ºåç¨‹å¯¹è±¡
coro = demo_coroutine()
print(f"åˆ›å»ºåçŠ¶æ€: {inspect.getgeneratorstate(coro)}")
# è¾“å‡º: GEN_CREATED (å·²åˆ›å»ºï¼Œæœªå¯åŠ¨)

# å¯åŠ¨åç¨‹
result1 = next(coro)
print(f"å¯åŠ¨åçŠ¶æ€: {inspect.getgeneratorstate(coro)}")
print(f"è¿”å›å€¼: {result1}")
# è¾“å‡º: GEN_SUSPENDED (å·²æš‚åœ)

# å‘é€æ•°æ®
result2 = coro.send("Hello")
print(f"å‘é€åçŠ¶æ€: {inspect.getgeneratorstate(coro)}")
print(f"è¿”å›å€¼: {result2}")

# å†æ¬¡å‘é€ï¼Œåç¨‹ç»“æŸ
try:
    coro.send("World")
except StopIteration as e:
    print(f"åç¨‹ç»“æŸï¼Œè¿”å›å€¼: {e.value}")
    print(f"æœ€ç»ˆçŠ¶æ€: {inspect.getgeneratorstate(coro)}")
    # è¾“å‡º: GEN_CLOSED (å·²å…³é—­)
```

**ğŸ¯ çŠ¶æ€è½¬æ¢å›¾**
```
åˆ›å»ºåç¨‹å¯¹è±¡
      â†“
GEN_CREATED (å·²åˆ›å»º)
      â†“ next()æˆ–send()
GEN_SUSPENDED (æš‚åœä¸­) â†â†’ send()/next()
      â†“ æ­£å¸¸ç»“æŸæˆ–å¼‚å¸¸
GEN_CLOSED (å·²å…³é—­)

ç‰¹æ®Šæƒ…å†µï¼š
GEN_RUNNING (è¿è¡Œä¸­) - åç¨‹æ­£åœ¨æ‰§è¡Œæ—¶çš„çŸ­æš‚çŠ¶æ€
```

### 3.2 åç¨‹å¼‚å¸¸å¤„ç†


**âš ï¸ åœ¨åç¨‹ä¸­å¤„ç†å¼‚å¸¸**

```python
@coroutine_starter
def robust_processor():
    """å¥å£®çš„æ•°æ®å¤„ç†åç¨‹"""
    print("å¤„ç†å™¨å¯åŠ¨ï¼Œå‡†å¤‡æ¥æ”¶æ•°æ®...")
    
    try:
        while True:
            try:
                data = yield
                
                # æ¨¡æ‹Ÿæ•°æ®å¤„ç†
                if data == "error":
                    raise ValueError("å¤„ç†é”™è¯¯")
                    
                result = data * 2
                print(f"å¤„ç†ç»“æœ: {data} -> {result}")
                
            except ValueError as e:
                print(f"æ•°æ®å¤„ç†é”™è¯¯: {e}")
                # ç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªæ•°æ®
                continue
                
    except GeneratorExit:
        print("åç¨‹æ­£å¸¸å…³é—­")
    except Exception as e:
        print(f"åç¨‹å¼‚å¸¸é€€å‡º: {e}")

# æµ‹è¯•å¼‚å¸¸å¤„ç†
processor = robust_processor()

processor.send(5)        # æ­£å¸¸å¤„ç†
processor.send("error")  # è§¦å‘å¼‚å¸¸ä½†ç»§ç»­è¿è¡Œ
processor.send(10)       # ç»§ç»­æ­£å¸¸å¤„ç†
processor.close()        # æ­£å¸¸å…³é—­
```

### 3.3 åç¨‹çš„æ¸…ç†æœºåˆ¶


**ğŸ§¹ åç¨‹èµ„æºæ¸…ç†**

```python
class ResourceManager:
    """èµ„æºç®¡ç†ç¤ºä¾‹"""
    def __init__(self, name):
        self.name = name
        self.is_open = False
    
    def open(self):
        print(f"æ‰“å¼€èµ„æº: {self.name}")
        self.is_open = True
    
    def close(self):
        if self.is_open:
            print(f"å…³é—­èµ„æº: {self.name}")
            self.is_open = False

@coroutine_starter
def resource_coroutine():
    """å¸¦èµ„æºç®¡ç†çš„åç¨‹"""
    resource = ResourceManager("æ•°æ®åº“è¿æ¥")
    
    try:
        resource.open()
        print("åç¨‹å¼€å§‹å·¥ä½œ...")
        
        while True:
            data = yield
            print(f"ä½¿ç”¨èµ„æºå¤„ç†: {data}")
            
    finally:
        # æ— è®ºå¦‚ä½•éƒ½ä¼šæ‰§è¡Œæ¸…ç†
        resource.close()
        print("åç¨‹æ¸…ç†å®Œæˆ")

# æµ‹è¯•èµ„æºæ¸…ç†
worker = resource_coroutine()
worker.send("ä»»åŠ¡1")
worker.send("ä»»åŠ¡2")
worker.close()  # ä¼šè§¦å‘finallyå—
```

---

## 4. ğŸ’¬ åç¨‹é€šä¿¡æœºåˆ¶


### 4.1 åŸºæœ¬çš„æ•°æ®ä¼ é€’


**ğŸ”¸ åŒå‘æ•°æ®æµ**

åç¨‹çš„å¼ºå¤§ä¹‹å¤„åœ¨äºå¯ä»¥åŒå‘ä¼ é€’æ•°æ®ï¼š

```python
def bidirectional_processor():
    """åŒå‘æ•°æ®å¤„ç†å™¨"""
    print("åŒå‘å¤„ç†å™¨å¯åŠ¨")
    
    while True:
        # æ¥æ”¶è¾“å…¥æ•°æ®
        input_data = yield
        
        # å¤„ç†æ•°æ®
        if isinstance(input_data, str):
            result = input_data.upper()
            feedback = f"å­—ç¬¦ä¸²å¤„ç†: {result}"
        elif isinstance(input_data, (int, float)):
            result = input_data ** 2
            feedback = f"æ•°å­—å¤„ç†: {input_data}Â² = {result}"
        else:
            feedback = f"æœªçŸ¥ç±»å‹: {type(input_data)}"
        
        # è¿”å›å¤„ç†ç»“æœ
        print(feedback)

# ä½¿ç”¨ç¤ºä¾‹
processor = bidirectional_processor()
next(processor)  # å¯åŠ¨

processor.send("hello")  # å­—ç¬¦ä¸²å¤„ç†
processor.send(5)        # æ•°å­—å¤„ç†
processor.send([1,2,3])  # æœªçŸ¥ç±»å‹
```

### 4.2 åç¨‹é—´çš„æ•°æ®ç®¡é“


**ğŸ”— æ„å»ºåç¨‹ç®¡é“**

```python
@coroutine_starter
def data_filter(target, condition):
    """æ•°æ®è¿‡æ»¤å™¨"""
    while True:
        data = yield
        if condition(data):
            target.send(data)

@coroutine_starter  
def data_transformer(target, transform_func):
    """æ•°æ®è½¬æ¢å™¨"""
    while True:
        data = yield
        transformed = transform_func(data)
        target.send(transformed)

@coroutine_starter
def data_sink():
    """æ•°æ®æ¥æ”¶å™¨"""
    while True:
        data = yield
        print(f"æœ€ç»ˆç»“æœ: {data}")

# æ„å»ºå¤„ç†ç®¡é“
sink = data_sink()
transformer = data_transformer(sink, lambda x: x * 10)
filter_even = data_filter(transformer, lambda x: x % 2 == 0)

# æµ‹è¯•ç®¡é“
print("=== æµ‹è¯•æ•°æ®ç®¡é“ ===")
for num in range(1, 6):
    print(f"è¾“å…¥: {num}")
    filter_even.send(num)
    print()
```

**ç®¡é“å·¥ä½œæµç¨‹å›¾**ï¼š
```
è¾“å…¥æ•°æ® â†’ è¿‡æ»¤å™¨(å¶æ•°) â†’ è½¬æ¢å™¨(*10) â†’ è¾“å‡º
   1    â†’     ä¸¢å¼ƒ     â†’      -      â†’   -
   2    â†’     é€šè¿‡     â†’     20      â†’  20
   3    â†’     ä¸¢å¼ƒ     â†’      -      â†’   -  
   4    â†’     é€šè¿‡     â†’     40      â†’  40
```

### 4.3 åç¨‹å¹¿æ’­æœºåˆ¶


**ğŸ“» ä¸€å¯¹å¤šæ•°æ®åˆ†å‘**

```python
@coroutine_starter
def broadcaster(targets):
    """å¹¿æ’­å™¨ - å°†æ•°æ®å‘é€ç»™å¤šä¸ªç›®æ ‡"""
    while True:
        data = yield
        print(f"å¹¿æ’­æ•°æ®: {data}")
        for target in targets:
            try:
                target.send(data)
            except StopIteration:
                # ç§»é™¤å·²å…³é—­çš„åç¨‹
                targets.remove(target)

@coroutine_starter
def logger(name):
    """æ—¥å¿—è®°å½•å™¨"""
    while True:
        data = yield
        print(f"[{name}] è®°å½•: {data}")

@coroutine_starter
def calculator(operation):
    """è®¡ç®—å™¨"""
    total = 0
    while True:
        data = yield
        if operation == "sum":
            total += data
            print(f"ç´¯åŠ å™¨: +{data} = {total}")
        elif operation == "product":
            total = total * data if total != 0 else data
            print(f"ç´¯ä¹˜å™¨: Ã—{data} = {total}")

# åˆ›å»ºå¤šä¸ªæ¥æ”¶å™¨
log1 = logger("ç³»ç»Ÿæ—¥å¿—")
log2 = logger("é”™è¯¯æ—¥å¿—") 
calc1 = calculator("sum")
calc2 = calculator("product")

# åˆ›å»ºå¹¿æ’­å™¨
broadcast = broadcaster([log1, log2, calc1, calc2])

# å¹¿æ’­æ•°æ®
for value in [5, 3, 8, 2]:
    broadcast.send(value)
```

---

## 5. ğŸŒŠ å¼‚æ­¥ç”Ÿæˆå™¨è¯¦è§£


### 5.1 ç†è§£å¼‚æ­¥ç”Ÿæˆå™¨


**ğŸ”¸ å¼‚æ­¥ç”Ÿæˆå™¨çš„æ¦‚å¿µ**

å¼‚æ­¥ç”Ÿæˆå™¨ç»“åˆäº†**ç”Ÿæˆå™¨çš„æƒ°æ€§æ±‚å€¼**å’Œ**åç¨‹çš„å¼‚æ­¥æ‰§è¡Œ**ç‰¹æ€§ï¼š

```python
import asyncio
import random

async def async_data_source():
    """å¼‚æ­¥æ•°æ®æº - æ¨¡æ‹Ÿä»ç½‘ç»œè·å–æ•°æ®"""
    for i in range(5):
        # æ¨¡æ‹Ÿå¼‚æ­¥IOæ“ä½œ
        await asyncio.sleep(0.5)
        
        # æ¨¡æ‹Ÿè·å–æ•°æ®
        data = random.randint(1, 100)
        print(f"ç”Ÿæˆæ•°æ®: {data}")
        
        yield data  # å¼‚æ­¥äº§å‡ºæ•°æ®

# ä½¿ç”¨å¼‚æ­¥ç”Ÿæˆå™¨
async def main():
    print("=== å¼‚æ­¥ç”Ÿæˆå™¨æ¼”ç¤º ===")
    
    async for data in async_data_source():
        print(f"å¤„ç†æ•°æ®: {data}")
        # å¯ä»¥åœ¨è¿™é‡Œè¿›è¡Œå¼‚æ­¥å¤„ç†
        await asyncio.sleep(0.2)

# è¿è¡Œç¤ºä¾‹
asyncio.run(main())
```

### 5.2 å¼‚æ­¥ç”Ÿæˆå™¨çš„å®é™…åº”ç”¨


**ğŸ“¡ æ¨¡æ‹Ÿå®æ—¶æ•°æ®æµ**

```python
import asyncio
import json
from datetime import datetime

async def stock_price_stream(symbol):
    """è‚¡ç¥¨ä»·æ ¼æµ - æ¨¡æ‹Ÿå®æ—¶è‚¡ä»·æ•°æ®"""
    base_price = 100.0
    
    while True:
        # æ¨¡æ‹Ÿä»·æ ¼æ³¢åŠ¨
        change = random.uniform(-2, 2)
        base_price += change
        base_price = max(0.01, base_price)  # ä»·æ ¼ä¸èƒ½ä¸ºè´Ÿ
        
        # ç”Ÿæˆè‚¡ä»·æ•°æ®
        price_data = {
            'symbol': symbol,
            'price': round(base_price, 2),
            'timestamp': datetime.now().isoformat(),
            'change': round(change, 2)
        }
        
        yield price_data
        
        # ç­‰å¾…ä¸€æ®µæ—¶é—´å†ç”Ÿæˆä¸‹ä¸€ä¸ªæ•°æ®ç‚¹
        await asyncio.sleep(1)

async def process_stock_data():
    """å¤„ç†è‚¡ä»·æ•°æ®"""
    print("å¼€å§‹ç›‘æ§è‚¡ä»·...")
    
    count = 0
    async for price_info in stock_price_stream("AAPL"):
        print(f"ğŸ“ˆ {price_info['symbol']}: ${price_info['price']} "
              f"({price_info['change']:+.2f})")
        
        # æ¨¡æ‹Ÿæ•°æ®å¤„ç†
        if price_info['price'] > 102:
            print("âš ï¸  ä»·æ ¼åé«˜ï¼Œå»ºè®®å–å‡º")
        elif price_info['price'] < 98:
            print("ğŸ’° ä»·æ ¼åä½ï¼Œå»ºè®®ä¹°å…¥")
        
        count += 1
        if count >= 10:  # åªå¤„ç†10ä¸ªæ•°æ®ç‚¹
            break
    
    print("ç›‘æ§ç»“æŸ")

# è¿è¡Œè‚¡ä»·ç›‘æ§
asyncio.run(process_stock_data())
```

### 5.3 å¼‚æ­¥ç”Ÿæˆå™¨çš„ç»„åˆä½¿ç”¨


**ğŸ”„ å¼‚æ­¥æ•°æ®å¤„ç†ç®¡é“**

```python
async def data_fetcher():
    """æ•°æ®è·å–å™¨"""
    for i in range(1, 11):
        await asyncio.sleep(0.3)  # æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
        yield f"åŸå§‹æ•°æ®-{i}"

async def data_processor(source):
    """æ•°æ®å¤„ç†å™¨"""
    async for data in source:
        # æ¨¡æ‹Ÿæ•°æ®å¤„ç†æ—¶é—´
        await asyncio.sleep(0.1)
        processed = data.replace("åŸå§‹", "å¤„ç†è¿‡çš„")
        yield processed

async def data_filter(source, keyword):
    """æ•°æ®è¿‡æ»¤å™¨"""
    async for data in source:
        if keyword in data:
            yield data

async def async_pipeline_demo():
    """å¼‚æ­¥ç®¡é“æ¼”ç¤º"""
    print("=== å¼‚æ­¥æ•°æ®å¤„ç†ç®¡é“ ===")
    
    # æ„å»ºå¼‚æ­¥å¤„ç†ç®¡é“
    fetcher = data_fetcher()
    processor = data_processor(fetcher)
    filtered = data_filter(processor, "5")  # åªä¿ç•™åŒ…å«"5"çš„æ•°æ®
    
    # å¤„ç†æ•°æ®
    async for result in filtered:
        print(f"âœ… æœ€ç»ˆç»“æœ: {result}")

# è¿è¡Œç®¡é“æ¼”ç¤º
asyncio.run(async_pipeline_demo())
```

---

## 6. âš™ï¸ åç¨‹è°ƒåº¦å™¨åŸç†


### 6.1 ç®€å•çš„äº‹ä»¶å¾ªç¯


**ğŸ”¸ ç†è§£äº‹ä»¶å¾ªç¯çš„å·¥ä½œåŸç†**

äº‹ä»¶å¾ªç¯æ˜¯åç¨‹çš„"å¤§ç®¡å®¶"ï¼Œè´Ÿè´£è°ƒåº¦å’Œæ‰§è¡Œåç¨‹ï¼š

```python
import time
from collections import deque

class SimpleEventLoop:
    """ç®€åŒ–ç‰ˆäº‹ä»¶å¾ªç¯"""
    
    def __init__(self):
        self.ready_queue = deque()  # å‡†å¤‡è¿è¡Œçš„åç¨‹é˜Ÿåˆ—
        self.sleeping = []          # ä¼‘çœ ä¸­çš„åç¨‹åˆ—è¡¨
        
    def call_soon(self, coro):
        """å°†åç¨‹åŠ å…¥å‡†å¤‡é˜Ÿåˆ—"""
        self.ready_queue.append(coro)
    
    def call_later(self, delay, coro):
        """å»¶è¿Ÿæ‰§è¡Œåç¨‹"""
        wake_time = time.time() + delay
        self.sleeping.append((wake_time, coro))
        self.sleeping.sort()  # æŒ‰å”¤é†’æ—¶é—´æ’åº
    
    def run_until_complete(self, main_coro):
        """è¿è¡Œä¸»åç¨‹ç›´åˆ°å®Œæˆ"""
        self.call_soon(main_coro)
        
        while self.ready_queue or self.sleeping:
            # æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦å”¤é†’çš„åç¨‹
            current_time = time.time()
            while self.sleeping and self.sleeping[0][0] <= current_time:
                _, coro = self.sleeping.pop(0)
                self.call_soon(coro)
            
            # è¿è¡Œå‡†å¤‡å¥½çš„åç¨‹
            if self.ready_queue:
                coro = self.ready_queue.popleft()
                try:
                    # æ‰§è¡Œåç¨‹ä¸€æ­¥
                    result = next(coro)
                    
                    # å¦‚æœåç¨‹è¿”å›äº†å»¶è¿Ÿæ—¶é—´ï¼Œå®‰æ’ç¨åæ‰§è¡Œ
                    if isinstance(result, (int, float)):
                        self.call_later(result, coro)
                    else:
                        self.call_soon(coro)
                        
                except StopIteration:
                    # åç¨‹æ‰§è¡Œå®Œæˆ
                    print("åç¨‹æ‰§è¡Œå®Œæˆ")
            
            # çŸ­æš‚ä¼‘çœ ï¼Œé¿å…CPUå ç”¨è¿‡é«˜
            time.sleep(0.01)

# æµ‹è¯•ç®€å•äº‹ä»¶å¾ªç¯
def demo_coroutine():
    """æ¼”ç¤ºåç¨‹"""
    print("åç¨‹å¼€å§‹æ‰§è¡Œ")
    yield 1  # ä¼‘çœ 1ç§’
    print("ä¼‘çœ 1ç§’åç»§ç»­")
    yield 0.5  # ä¼‘çœ 0.5ç§’
    print("å†ä¼‘çœ 0.5ç§’åç»§ç»­")
    yield 0  # ç«‹å³æ‰§è¡Œ
    print("åç¨‹æ‰§è¡Œç»“æŸ")

# è¿è¡Œæ¼”ç¤º
print("=== ç®€å•äº‹ä»¶å¾ªç¯æ¼”ç¤º ===")
loop = SimpleEventLoop()
coro = demo_coroutine()
loop.run_until_complete(coro)
```

### 6.2 åç¨‹è°ƒåº¦ç­–ç•¥


**ğŸ¯ ä¸åŒçš„è°ƒåº¦ç­–ç•¥**

```python
import asyncio
from asyncio import Event, Queue

async def cpu_bound_task(name, duration):
    """CPUå¯†é›†å‹ä»»åŠ¡æ¨¡æ‹Ÿ"""
    print(f"ğŸ“Š {name} å¼€å§‹è®¡ç®—...")
    
    start_time = asyncio.get_event_loop().time()
    end_time = start_time + duration
    
    while asyncio.get_event_loop().time() < end_time:
        # å®šæœŸè®©å‡ºæ§åˆ¶æƒ
        if (asyncio.get_event_loop().time() - start_time) % 0.1 < 0.01:
            await asyncio.sleep(0)  # è®©å…¶ä»–åç¨‹è¿è¡Œ
    
    print(f"âœ… {name} è®¡ç®—å®Œæˆ (è€—æ—¶{duration}ç§’)")

async def io_bound_task(name, delay):
    """IOå¯†é›†å‹ä»»åŠ¡æ¨¡æ‹Ÿ"""
    print(f"ğŸŒ {name} å¼€å§‹IOæ“ä½œ...")
    await asyncio.sleep(delay)  # æ¨¡æ‹ŸIOç­‰å¾…
    print(f"âœ… {name} IOå®Œæˆ (ç­‰å¾…{delay}ç§’)")

async def scheduling_demo():
    """è°ƒåº¦ç­–ç•¥æ¼”ç¤º"""
    print("=== åç¨‹è°ƒåº¦ç­–ç•¥æ¼”ç¤º ===")
    
    tasks = [
        cpu_bound_task("CPUä»»åŠ¡1", 2),
        io_bound_task("IOä»»åŠ¡1", 1),
        cpu_bound_task("CPUä»»åŠ¡2", 1.5),
        io_bound_task("IOä»»åŠ¡2", 0.5),
    ]
    
    # å¹¶å‘æ‰§è¡Œæ‰€æœ‰ä»»åŠ¡
    await asyncio.gather(*tasks)

# è¿è¡Œè°ƒåº¦æ¼”ç¤º
asyncio.run(scheduling_demo())
```

### 6.3 è‡ªå®šä¹‰ä»»åŠ¡è°ƒåº¦å™¨


**ğŸ”§ æ„å»ºä¸“ç”¨è°ƒåº¦å™¨**

```python
import asyncio
import heapq
from typing import Callable, Any

class PriorityScheduler:
    """ä¼˜å…ˆçº§ä»»åŠ¡è°ƒåº¦å™¨"""
    
    def __init__(self):
        self.task_queue = []  # ä¼˜å…ˆçº§é˜Ÿåˆ—
        self.task_id = 0      # ä»»åŠ¡IDè®¡æ•°å™¨
    
    def schedule_task(self, priority: int, coro_func: Callable, *args, **kwargs):
        """å®‰æ’ä¼˜å…ˆçº§ä»»åŠ¡"""
        self.task_id += 1
        task_item = (priority, self.task_id, coro_func, args, kwargs)
        heapq.heappush(self.task_queue, task_item)
    
    async def run_all_tasks(self):
        """è¿è¡Œæ‰€æœ‰ä»»åŠ¡"""
        tasks = []
        
        while self.task_queue:
            priority, task_id, coro_func, args, kwargs = heapq.heappop(self.task_queue)
            print(f"ğŸ¯ å¯åŠ¨ä»»åŠ¡ {task_id} (ä¼˜å…ˆçº§: {priority})")
            
            # åˆ›å»ºåç¨‹ä»»åŠ¡
            task = asyncio.create_task(coro_func(*args, **kwargs))
            tasks.append(task)
        
        # ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
        await asyncio.gather(*tasks)

async def high_priority_task(name):
    """é«˜ä¼˜å…ˆçº§ä»»åŠ¡"""
    print(f"ğŸ”¥ é«˜ä¼˜å…ˆçº§ä»»åŠ¡ {name} å¼€å§‹")
    await asyncio.sleep(1)
    print(f"âœ… é«˜ä¼˜å…ˆçº§ä»»åŠ¡ {name} å®Œæˆ")

async def normal_task(name):
    """æ™®é€šä»»åŠ¡"""
    print(f"ğŸ“ æ™®é€šä»»åŠ¡ {name} å¼€å§‹")
    await asyncio.sleep(2)
    print(f"âœ… æ™®é€šä»»åŠ¡ {name} å®Œæˆ")

async def low_priority_task(name):
    """ä½ä¼˜å…ˆçº§ä»»åŠ¡"""
    print(f"â³ ä½ä¼˜å…ˆçº§ä»»åŠ¡ {name} å¼€å§‹")
    await asyncio.sleep(0.5)
    print(f"âœ… ä½ä¼˜å…ˆçº§ä»»åŠ¡ {name} å®Œæˆ")

async def priority_scheduling_demo():
    """ä¼˜å…ˆçº§è°ƒåº¦æ¼”ç¤º"""
    print("=== ä¼˜å…ˆçº§ä»»åŠ¡è°ƒåº¦æ¼”ç¤º ===")
    
    scheduler = PriorityScheduler()
    
    # å®‰æ’ä¸åŒä¼˜å…ˆçº§çš„ä»»åŠ¡
    scheduler.schedule_task(3, low_priority_task, "ä»»åŠ¡A")
    scheduler.schedule_task(1, high_priority_task, "ä»»åŠ¡B")  
    scheduler.schedule_task(2, normal_task, "ä»»åŠ¡C")
    scheduler.schedule_task(1, high_priority_task, "ä»»åŠ¡D")
    scheduler.schedule_task(3, low_priority_task, "ä»»åŠ¡E")
    
    # è¿è¡Œæ‰€æœ‰ä»»åŠ¡
    await scheduler.run_all_tasks()

# è¿è¡Œä¼˜å…ˆçº§è°ƒåº¦æ¼”ç¤º
asyncio.run(priority_scheduling_demo())
```

---

## 7. ğŸš€ åç¨‹ä¸å¹¶å‘ç¼–ç¨‹


### 7.1 åç¨‹å¹¶å‘æ¨¡å¼


**ğŸ”¸ å¹¶å‘vså¹¶è¡Œçš„ç†è§£**

```
å¹¶å‘ (Concurrency)ï¼š
- ä¸€ä¸ªå¨å¸ˆåŒæ—¶å¤„ç†å¤šé“èœ
- åœ¨ç‚’èœç­‰å¾…çš„æ—¶å€™å»æ´—èœ
- åç¨‹å±äºå¹¶å‘ç¼–ç¨‹

å¹¶è¡Œ (Parallelism)ï¼š  
- å¤šä¸ªå¨å¸ˆåŒæ—¶å„è‡ªåšèœ
- æ¯ä¸ªå¨å¸ˆç‹¬ç«‹å·¥ä½œ
- å¤šè¿›ç¨‹/å¤šçº¿ç¨‹å±äºå¹¶è¡Œç¼–ç¨‹
```

**ğŸ¯ åç¨‹å¹¶å‘çš„ä¼˜åŠ¿åœºæ™¯**

```python
import asyncio
import aiohttp
import time

async def fetch_url(session, url):
    """å¼‚æ­¥è·å–URLå†…å®¹"""
    try:
        async with session.get(url) as response:
            content = await response.text()
            return f"âœ… {url}: {len(content)} å­—ç¬¦"
    except Exception as e:
        return f"âŒ {url}: {str(e)}"

async def concurrent_requests():
    """å¹¶å‘HTTPè¯·æ±‚æ¼”ç¤º"""
    urls = [
        "https://httpbin.org/delay/1",
        "https://httpbin.org/delay/2", 
        "https://httpbin.org/delay/1",
        "https://httpbin.org/json",
        "https://httpbin.org/uuid"
    ]
    
    print("=== åç¨‹å¹¶å‘HTTPè¯·æ±‚ ===")
    start_time = time.time()
    
    async with aiohttp.ClientSession() as session:
        # å¹¶å‘æ‰§è¡Œæ‰€æœ‰è¯·æ±‚
        results = await asyncio.gather(
            *[fetch_url(session, url) for url in urls]
        )
    
    end_time = time.time()
    
    for result in results:
        print(result)
    
    print(f"â±ï¸ æ€»è€—æ—¶: {end_time - start_time:.2f} ç§’")

# å¯¹æ¯”ï¼šé¡ºåºæ‰§è¡Œçš„ç‰ˆæœ¬
async def sequential_requests():
    """é¡ºåºHTTPè¯·æ±‚æ¼”ç¤º"""
    urls = [
        "https://httpbin.org/delay/1",
        "https://httpbin.org/delay/2",
        "https://httpbin.org/delay/1"
    ]
    
    print("=== é¡ºåºHTTPè¯·æ±‚ ===")
    start_time = time.time()
    
    async with aiohttp.ClientSession() as session:
        results = []
        for url in urls:
            result = await fetch_url(session, url)
            results.append(result)
    
    end_time = time.time()
    
    for result in results:
        print(result)
    
    print(f"â±ï¸ æ€»è€—æ—¶: {end_time - start_time:.2f} ç§’")

# æ³¨æ„ï¼šè¿™ä¸ªç¤ºä¾‹éœ€è¦å®‰è£… aiohttp: pip install aiohttp
# è¿è¡Œæ—¶å–æ¶ˆæ³¨é‡Šä¸‹é¢çš„è¡Œ
# asyncio.run(concurrent_requests())
# asyncio.run(sequential_requests())
```

### 7.2 åç¨‹åŒæ­¥åŸè¯­


**ğŸ”’ åç¨‹é—´çš„åŒæ­¥æ§åˆ¶**

```python
import asyncio
import random

# ä½¿ç”¨é”ä¿æŠ¤å…±äº«èµ„æº
shared_resource = {"counter": 0}
resource_lock = asyncio.Lock()

async def worker_with_lock(worker_id, work_count):
    """å¸¦é”çš„å·¥ä½œåç¨‹"""
    for i in range(work_count):
        # è·å–é”
        async with resource_lock:
            # ä¸´ç•ŒåŒºï¼šä¿®æ”¹å…±äº«èµ„æº
            old_value = shared_resource["counter"]
            await asyncio.sleep(0.01)  # æ¨¡æ‹Ÿå¤„ç†æ—¶é—´
            shared_resource["counter"] = old_value + 1
            
            print(f"Worker-{worker_id}: {old_value} -> {shared_resource['counter']}")

async def lock_demo():
    """é”æ¼”ç¤º"""
    print("=== åç¨‹é”æ¼”ç¤º ===")
    shared_resource["counter"] = 0
    
    # åˆ›å»ºå¤šä¸ªå·¥ä½œåç¨‹
    workers = [
        worker_with_lock(i, 3) for i in range(3)
    ]
    
    await asyncio.gather(*workers)
    print(f"æœ€ç»ˆè®¡æ•°: {shared_resource['counter']}")

# ä½¿ç”¨äº‹ä»¶è¿›è¡Œåç¨‹é€šä¿¡
async def event_demo():
    """äº‹ä»¶æ¼”ç¤º"""
    print("\n=== åç¨‹äº‹ä»¶æ¼”ç¤º ===")
    
    # åˆ›å»ºäº‹ä»¶
    start_event = asyncio.Event()
    finish_event = asyncio.Event()
    
    async def waiter(name):
        """ç­‰å¾…è€…"""
        print(f"{name} ç­‰å¾…å¼€å§‹ä¿¡å·...")
        await start_event.wait()
        print(f"{name} æ”¶åˆ°ä¿¡å·ï¼Œå¼€å§‹å·¥ä½œ!")
        
        # æ¨¡æ‹Ÿå·¥ä½œ
        await asyncio.sleep(random.uniform(1, 3))
        print(f"{name} å·¥ä½œå®Œæˆ")
        
        # è®¾ç½®å®Œæˆäº‹ä»¶
        finish_event.set()
    
    async def coordinator():
        """åè°ƒè€…"""
        print("åè°ƒè€…å‡†å¤‡ä¸­...")
        await asyncio.sleep(1)
        
        print("ğŸš€ å‘é€å¼€å§‹ä¿¡å·!")
        start_event.set()
        
        print("ç­‰å¾…å·¥ä½œå®Œæˆ...")
        await finish_event.wait()
        print("âœ… æ‰€æœ‰å·¥ä½œå·²å®Œæˆ!")
    
    # å¹¶å‘è¿è¡Œ
    await asyncio.gather(
        waiter("å·¥äººA"),
        waiter("å·¥äººB"), 
        coordinator()
    )

# è¿è¡ŒåŒæ­¥åŸè¯­æ¼”ç¤º
asyncio.run(lock_demo())
asyncio.run(event_demo())
```

### 7.3 åç¨‹æ± å’Œä»»åŠ¡ç®¡ç†


**ğŸŠâ€â™‚ï¸ åç¨‹æ± ç®¡ç†**

```python
import asyncio
from asyncio import Semaphore

class CoroutinePool:
    """åç¨‹æ± ç®¡ç†å™¨"""
    
    def __init__(self, max_workers=5):
        self.semaphore = Semaphore(max_workers)
        self.active_tasks = set()
    
    async def submit(self, coro_func, *args, **kwargs):
        """æäº¤åç¨‹ä»»åŠ¡"""
        async with self.semaphore:  # é™åˆ¶å¹¶å‘æ•°
            task = asyncio.create_task(coro_func(*args, **kwargs))
            self.active_tasks.add(task)
            
            try:
                result = await task
                return result
            finally:
                self.active_tasks.discard(task)
    
    async def map(self, coro_func, iterable):
        """æ‰¹é‡å¤„ç†"""
        tasks = [
            self.submit(coro_func, item) 
            for item in iterable
        ]
        return await asyncio.gather(*tasks)
    
    async def shutdown(self):
        """å…³é—­åç¨‹æ± """
        # ç­‰å¾…æ‰€æœ‰æ´»è·ƒä»»åŠ¡å®Œæˆ
        if self.active_tasks:
            await asyncio.gather(*self.active_tasks, return_exceptions=True)

async def worker_task(task_id, processing_time):
    """å·¥ä½œä»»åŠ¡"""
    print(f"ğŸ“‹ ä»»åŠ¡ {task_id} å¼€å§‹å¤„ç†...")
    await asyncio.sleep(processing_time)
    result = f"ä»»åŠ¡ {task_id} å®Œæˆ (è€—æ—¶ {processing_time}s)"
    print(f"âœ… {result}")
    return result

async def pool_demo():
    """åç¨‹æ± æ¼”ç¤º"""
    print("=== åç¨‹æ± æ¼”ç¤º ===")
    
    # åˆ›å»ºåç¨‹æ± ï¼Œæœ€å¤§å¹¶å‘æ•°ä¸º3
    pool = CoroutinePool(max_workers=3)
    
    # å‡†å¤‡ä»»åŠ¡æ•°æ®
    task_data = [
        (1, 2), (2, 1), (3, 3), (4, 1), 
        (5, 2), (6, 1), (7, 2), (8, 1)
    ]
    
    print(f"ğŸš€ å¼€å§‹å¤„ç† {len(task_data)} ä¸ªä»»åŠ¡ (æœ€å¤§å¹¶å‘: 3)")
    start_time = asyncio.get_event_loop().time()
    
    # æ‰¹é‡å¤„ç†ä»»åŠ¡
    results = await pool.map(
        lambda data: worker_task(data[0], data[1]),
        task_data
    )
    
    end_time = asyncio.get_event_loop().time()
    
    print(f"\nğŸ“Š å¤„ç†ç»“æœ:")
    for result in results:
        print(f"  {result}")
    
    print(f"â±ï¸ æ€»è€—æ—¶: {end_time - start_time:.2f} ç§’")
    
    # å…³é—­åç¨‹æ± 
    await pool.shutdown()

# è¿è¡Œåç¨‹æ± æ¼”ç¤º
asyncio.run(pool_demo())
```

---

## 8. ğŸ’ åç¨‹æœ€ä½³å®è·µæŒ‡å—


### 8.1 åç¨‹è®¾è®¡åŸåˆ™


**ğŸ¯ è®¾è®¡é«˜è´¨é‡åç¨‹çš„åŸåˆ™**

1. **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªåç¨‹åªåšä¸€ä»¶äº‹
2. **å¼‚å¸¸å®‰å…¨**ï¼šå¦¥å–„å¤„ç†å¼‚å¸¸æƒ…å†µ  
3. **èµ„æºæ¸…ç†**ï¼šç¡®ä¿èµ„æºå¾—åˆ°é‡Šæ”¾
4. **é¿å…é˜»å¡**ï¼šä¸åœ¨åç¨‹ä¸­ä½¿ç”¨é˜»å¡æ“ä½œ

```python
import asyncio
import aiofiles
import logging
from contextlib import asynccontextmanager

# é…ç½®æ—¥å¿—
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

class FileProcessor:
    """æ–‡ä»¶å¤„ç†å™¨ - å±•ç¤ºæœ€ä½³å®è·µ"""
    
    def __init__(self, max_concurrent=3):
        self.semaphore = asyncio.Semaphore(max_concurrent)
        self.processed_count = 0
        
    @asynccontextmanager
    async def managed_file(self, filename, mode='r'):
        """å¼‚æ­¥æ–‡ä»¶ç®¡ç†å™¨"""
        file_handle = None
        try:
            logger.info(f"ğŸ“‚ æ‰“å¼€æ–‡ä»¶: {filename}")
            file_handle = await aiofiles.open(filename, mode)
            yield file_handle
        except FileNotFoundError:
            logger.error(f"âŒ æ–‡ä»¶ä¸å­˜åœ¨: {filename}")
            raise
        except Exception as e:
            logger.error(f"âŒ æ–‡ä»¶æ“ä½œé”™è¯¯: {e}")
            raise
        finally:
            if file_handle:
                await file_handle.close()
                logger.info(f"ğŸ”’ å…³é—­æ–‡ä»¶: {filename}")
    
    async def process_single_file(self, filename):
        """å¤„ç†å•ä¸ªæ–‡ä»¶"""
        async with self.semaphore:  # é™åˆ¶å¹¶å‘
            try:
                async with self.managed_file(filename) as file:
                    content = await file.read()
                    
                    # æ¨¡æ‹Ÿå¤„ç†æ—¶é—´
                    await asyncio.sleep(1)
                    
                    # å¤„ç†æ–‡ä»¶å†…å®¹
                    line_count = len(content.splitlines())
                    char_count = len(content)
                    
                    self.processed_count += 1
                    
                    result = {
                        'filename': filename,
                        'lines': line_count,
                        'characters': char_count,
                        'status': 'success'
                    }
                    
                    logger.info(f"âœ… å¤„ç†å®Œæˆ: {filename}")
                    return result
                    
            except Exception as e:
                logger.error(f"âŒ å¤„ç†å¤±è´¥ {filename}: {e}")
                return {
                    'filename': filename,
                    'status': 'error', 
                    'error': str(e)
                }
    
    async def process_files(self, filenames):
        """æ‰¹é‡å¤„ç†æ–‡ä»¶"""
        logger.info(f"ğŸš€ å¼€å§‹å¤„ç† {len(filenames)} ä¸ªæ–‡ä»¶")
        
        tasks = [
            self.process_single_file(filename) 
            for filename in filenames
        ]
        
        # ä½¿ç”¨ gather å¹¶å¤„ç†å¼‚å¸¸
        results = await asyncio.gather(*tasks, return_exceptions=True)
        
        # å¤„ç†ç»“æœ
        successful = sum(1 for r in results if isinstance(r, dict) and r.get('status') == 'success')
        failed = len(results) - successful
        
        logger.info(f"ğŸ“Š å¤„ç†å®Œæˆ: {successful} æˆåŠŸ, {failed} å¤±è´¥")
        return results

# æ³¨æ„ï¼šè¿™ä¸ªç¤ºä¾‹éœ€è¦å®‰è£… aiofiles: pip install aiofiles
# ä½¿ç”¨ç¤ºä¾‹ï¼ˆéœ€è¦åˆ›å»ºæµ‹è¯•æ–‡ä»¶ï¼‰
async def best_practices_demo():
    """æœ€ä½³å®è·µæ¼”ç¤º"""
    processor = FileProcessor(max_concurrent=2)
    
    # åˆ›å»ºæµ‹è¯•æ–‡ä»¶
    test_files = ["test1.txt", "test2.txt", "nonexistent.txt"]
    
    # åˆ›å»ºå®é™…çš„æµ‹è¯•æ–‡ä»¶
    for filename in test_files[:2]:  # åªåˆ›å»ºå‰ä¸¤ä¸ª
        async with aiofiles.open(filename, 'w') as f:
            await f.write(f"è¿™æ˜¯æµ‹è¯•æ–‡ä»¶ {filename}\nç¬¬äºŒè¡Œå†…å®¹\nç¬¬ä¸‰è¡Œå†…å®¹")
    
    try:
        results = await processor.process_files(test_files)
        
        for result in results:
            if isinstance(result, dict):
                print(f"ğŸ“„ {result}")
            else:
                print(f"âŒ å¼‚å¸¸: {result}")
                
    finally:
        # æ¸…ç†æµ‹è¯•æ–‡ä»¶
        import os
        for filename in test_files[:2]:
            try:
                os.remove(filename)
            except FileNotFoundError:
                pass

# è¿è¡Œæœ€ä½³å®è·µæ¼”ç¤º
# asyncio.run(best_practices_demo())
```

### 8.2 æ€§èƒ½ä¼˜åŒ–æŠ€å·§


**âš¡ åç¨‹æ€§èƒ½ä¼˜åŒ–**

```python
import asyncio
import time
from functools import wraps

def measure_time(func):
    """å¼‚æ­¥å‡½æ•°æ‰§è¡Œæ—¶é—´è£…é¥°å™¨"""
    @wraps(func)
    async def wrapper(*args, **kwargs):
        start = time.time()
        result = await func(*args, **kwargs)
        end = time.time()
        print(f"â±ï¸ {func.__name__} æ‰§è¡Œæ—¶é—´: {end - start:.2f}s")
        return result
    return wrapper

class PerformanceOptimizer:
    """æ€§èƒ½ä¼˜åŒ–æ¼”ç¤º"""
    
    @staticmethod
    async def cpu_intensive_task_bad():
        """âŒ é”™è¯¯çš„CPUå¯†é›†å‹ä»»åŠ¡"""
        # è¿™ä¼šé˜»å¡äº‹ä»¶å¾ªç¯
        total = 0
        for i in range(10000000):
            total += i
        return total
    
    @staticmethod 
    async def cpu_intensive_task_good():
        """âœ… æ­£ç¡®çš„CPUå¯†é›†å‹ä»»åŠ¡"""
        total = 0
        for i in range(10000000):
            total += i
            # å®šæœŸè®©å‡ºæ§åˆ¶æƒ
            if i % 100000 == 0:
                await asyncio.sleep(0)
        return total
    
    @staticmethod
    async def batch_processing_bad(items):
        """âŒ ä½æ•ˆçš„æ‰¹å¤„ç†"""
        results = []
        for item in items:
            # é€ä¸ªå¤„ç†ï¼Œæ²¡æœ‰å¹¶å‘
            await asyncio.sleep(0.1)  # æ¨¡æ‹ŸIOæ“ä½œ
            results.append(item * 2)
        return results
    
    @staticmethod
    async def batch_processing_good(items, batch_size=5):
        """âœ… é«˜æ•ˆçš„æ‰¹å¤„ç†"""
        async def process_item(item):
            await asyncio.sleep(0.1)
            return item * 2
        
        results = []
        
        # åˆ†æ‰¹å¹¶å‘å¤„ç†
        for i in range(0, len(items), batch_size):
            batch = items[i:i + batch_size]
            batch_results = await asyncio.gather(
                *[process_item(item) for item in batch]
            )
            results.extend(batch_results)
        
        return results

@measure_time
async def performance_comparison():
    """æ€§èƒ½å¯¹æ¯”æ¼”ç¤º"""
    print("=== åç¨‹æ€§èƒ½ä¼˜åŒ–å¯¹æ¯” ===")
    
    optimizer = PerformanceOptimizer()
    test_data = list(range(20))
    
    print("\n1. æ‰¹å¤„ç†æ€§èƒ½å¯¹æ¯”:")
    
    print("ä½æ•ˆç‰ˆæœ¬ (é¡ºåºå¤„ç†):")
    result1 = await optimizer.batch_processing_bad(test_data)
    
    print("é«˜æ•ˆç‰ˆæœ¬ (æ‰¹é‡å¹¶å‘):")
    result2 = await optimizer.batch_processing_good(test_data)
    
    print(f"ç»“æœä¸€è‡´: {result1 == result2}")

# è¿è¡Œæ€§èƒ½å¯¹æ¯”
asyncio.run(performance_comparison())
```

### 8.3 é”™è¯¯å¤„ç†å’Œè°ƒè¯•


**ğŸ› åç¨‹è°ƒè¯•æŠ€å·§**

```python
import asyncio
import functools
import traceback
from typing import Any, Callable

def debug_coroutine(func: Callable) -> Callable:
    """åç¨‹è°ƒè¯•è£…é¥°å™¨"""
    @functools.wraps(func)
    async def wrapper(*args, **kwargs):
        coro_name = f"{func.__module__}.{func.__name__}"
        print(f"ğŸ” å¼€å§‹æ‰§è¡Œåç¨‹: {coro_name}")
        
        try:
            result = await func(*args, **kwargs)
            print(f"âœ… åç¨‹å®Œæˆ: {coro_name}")
            return result
        except Exception as e:
            print(f"âŒ åç¨‹å¼‚å¸¸: {coro_name}")
            print(f"   é”™è¯¯ç±»å‹: {type(e).__name__}")
            print(f"   é”™è¯¯ä¿¡æ¯: {str(e)}")
            traceback.print_exc()
            raise
    
    return wrapper

class SafeCoroutineRunner:
    """å®‰å…¨çš„åç¨‹è¿è¡Œå™¨"""
    
    @staticmethod
    async def run_with_timeout(coro, timeout_seconds=5):
        """å¸¦è¶…æ—¶çš„åç¨‹æ‰§è¡Œ"""
        try:
            result = await asyncio.wait_for(coro, timeout=timeout_seconds)
            return {'status': 'success', 'result': result}
        except asyncio.TimeoutError:
            return {'status': 'timeout', 'error': f'åç¨‹è¶…æ—¶ ({timeout_seconds}s)'}
        except Exception as e:
            return {'status': 'error', 'error': str(e)}
    
    @staticmethod
    async def run_with_retry(coro_func, max_retries=3, delay=1):
        """å¸¦é‡è¯•çš„åç¨‹æ‰§è¡Œ"""
        for attempt in range(max_retries + 1):
            try:
                result = await coro_func()
                return result
            except Exception as e:
                if attempt == max_retries:
                    print(f"âŒ é‡è¯• {max_retries} æ¬¡åä»ç„¶å¤±è´¥: {e}")
                    raise
                else:
                    print(f"âš ï¸ ç¬¬ {attempt + 1} æ¬¡å°è¯•å¤±è´¥ï¼Œ{delay}ç§’åé‡è¯•: {e}")
                    await asyncio.sleep(delay)

@debug_coroutine
async def unreliable_task(task_id, fail_rate=0.3):
    """ä¸å¯é çš„ä»»åŠ¡ï¼ˆç”¨äºæµ‹è¯•é”™è¯¯å¤„ç†ï¼‰"""
    import random
    
    print(f"ğŸ² ä»»åŠ¡ {task_id} å¼€å§‹æ‰§è¡Œ...")
    await asyncio.sleep(random.uniform(0.5, 2))
    
    if random.random() < fail_rate:
        raise Exception(f"ä»»åŠ¡ {task_id} éšæœºå¤±è´¥")
    
    return f"ä»»åŠ¡ {task_id} æˆåŠŸå®Œæˆ"

async def error_handling_demo():
    """é”™è¯¯å¤„ç†æ¼”ç¤º"""
    print("=== åç¨‹é”™è¯¯å¤„ç†æ¼”ç¤º ===")
    
    runner = SafeCoroutineRunner()
    
    # æµ‹è¯•è¶…æ—¶å¤„ç†
    print("\n1. è¶…æ—¶å¤„ç†æµ‹è¯•:")
    
    async def slow_task():
        await asyncio.sleep(3)  # æ•…æ„æ…¢çš„ä»»åŠ¡
        return "æ…¢ä»»åŠ¡å®Œæˆ"
    
    result = await runner.run_with_timeout(slow_task(), timeout_seconds=2)
    print(f"è¶…æ—¶æµ‹è¯•ç»“æœ: {result}")
    
    # æµ‹è¯•é‡è¯•æœºåˆ¶
    print("\n2. é‡è¯•æœºåˆ¶æµ‹è¯•:")
    
    async def flaky_task():
        return await unreliable_task("é‡è¯•æµ‹è¯•", fail_rate=0.7)
    
    try:
        result = await runner.run_with_retry(flaky_task, max_retries=3, delay=0.5)
        print(f"é‡è¯•æˆåŠŸ: {result}")
    except Exception as e:
        print(f"é‡è¯•æœ€ç»ˆå¤±è´¥: {e}")

# è¿è¡Œé”™è¯¯å¤„ç†æ¼”ç¤º
asyncio.run(error_handling_demo())
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ”¸ åç¨‹æœ¬è´¨ï¼šå¯æš‚åœå’Œæ¢å¤çš„å‡½æ•°ï¼Œå®ç°åä½œå¼å¤šä»»åŠ¡
ğŸ”¸ ç”Ÿæˆå™¨åç¨‹ï¼šä½¿ç”¨yieldå®ç°çš„åç¨‹ï¼Œæ”¯æŒåŒå‘æ•°æ®ä¼ é€’
ğŸ”¸ å¼‚æ­¥è¯­æ³•ï¼šasync/awaitæ˜¯ç°ä»£Pythonåç¨‹çš„æ ‡å‡†è¯­æ³•
ğŸ”¸ äº‹ä»¶å¾ªç¯ï¼šåç¨‹çš„è°ƒåº¦å™¨ï¼Œè´Ÿè´£åç¨‹çš„æ‰§è¡Œå’Œåˆ‡æ¢
ğŸ”¸ å¹¶å‘ç‰¹æ€§ï¼šåç¨‹é€‚åˆIOå¯†é›†å‹ä»»åŠ¡ï¼Œä¸é€‚åˆCPUå¯†é›†å‹
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ åç¨‹çš„å·¥ä½œåŸç†**
```
åç¨‹æš‚åœæœºåˆ¶ï¼š
- yield/awaitæ˜¯æš‚åœç‚¹
- æš‚åœæ—¶ä¿å­˜å‡½æ•°çŠ¶æ€
- æ¢å¤æ—¶ä»æš‚åœç‚¹ç»§ç»­

åç¨‹è°ƒåº¦ç­–ç•¥ï¼š
- åä½œå¼è°ƒåº¦ï¼Œéœ€è¦ä¸»åŠ¨è®©å‡ºæ§åˆ¶æƒ
- äº‹ä»¶å¾ªç¯è´Ÿè´£åç¨‹é—´çš„åˆ‡æ¢
- IOæ“ä½œæ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°å…¶ä»–åç¨‹
```

**ğŸ”¹ åç¨‹çš„é€‚ç”¨åœºæ™¯**
```
é€‚åˆçš„åœºæ™¯ï¼š
âœ… ç½‘ç»œè¯·æ±‚å’Œæ–‡ä»¶IO
âœ… æ•°æ®åº“æŸ¥è¯¢
âœ… å¾®æœåŠ¡é—´é€šä¿¡
âœ… å®æ—¶æ•°æ®æµå¤„ç†

ä¸é€‚åˆçš„åœºæ™¯ï¼š
âŒ CPUå¯†é›†å‹è®¡ç®—
âŒ éœ€è¦çœŸæ­£å¹¶è¡Œå¤„ç†çš„ä»»åŠ¡
âŒ ä¼ ç»Ÿçš„é˜»å¡å¼åŒæ­¥ä»£ç 
```

**ğŸ”¹ åç¨‹vsçº¿ç¨‹çš„é€‰æ‹©**
```
é€‰æ‹©åç¨‹çš„ç†ç”±ï¼š
- æ›´é«˜çš„å¹¶å‘æ•°ï¼ˆä¸Šä¸‡ä¸ªåç¨‹ï¼‰
- æ›´ä½çš„å†…å­˜å¼€é”€
- é¿å…çº¿ç¨‹å®‰å…¨é—®é¢˜
- æ›´å¥½çš„å¯æ§æ€§

é€‰æ‹©çº¿ç¨‹çš„ç†ç”±ï¼š
- CPUå¯†é›†å‹ä»»åŠ¡
- éœ€è¦åˆ©ç”¨å¤šæ ¸å¤„ç†å™¨
- ä¸é˜»å¡å¼ç¬¬ä¸‰æ–¹åº“é›†æˆ
```

### 9.3 å®è·µåº”ç”¨æŒ‡å—


**ğŸ’¡ åç¨‹ç¼–ç¨‹æœ€ä½³å®è·µ**
```
è®¾è®¡åŸåˆ™ï¼š
1. å•ä¸€èŒè´£ - æ¯ä¸ªåç¨‹ä¸“æ³¨ä¸€ä¸ªä»»åŠ¡
2. å¼‚å¸¸å®‰å…¨ - å¦¥å–„å¤„ç†æ‰€æœ‰å¼‚å¸¸æƒ…å†µ
3. èµ„æºæ¸…ç† - ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨
4. é¿å…é˜»å¡ - ä¸åœ¨åç¨‹ä¸­ä½¿ç”¨é˜»å¡æ“ä½œ

æ€§èƒ½ä¼˜åŒ–ï¼š
1. æ§åˆ¶å¹¶å‘æ•° - ä½¿ç”¨Semaphoreé™åˆ¶
2. æ‰¹é‡å¤„ç† - åˆ†æ‰¹å¹¶å‘è€Œéå…¨é‡å¹¶å‘
3. å®šæœŸè®©æƒ - CPUå¯†é›†å‹ä»»åŠ¡ä¸­æ’å…¥await asyncio.sleep(0)
4. åˆç†è¶…æ—¶ - ä¸ºé•¿æ—¶é—´è¿è¡Œçš„åç¨‹è®¾ç½®è¶…æ—¶
```

**ğŸ”§ å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ**
```
é—®é¢˜ï¼šåç¨‹æ— æ³•å¯åŠ¨
è§£å†³ï¼šæ£€æŸ¥æ˜¯å¦åœ¨asyncå‡½æ•°ä¸­ä½¿ç”¨await

é—®é¢˜ï¼šæ€§èƒ½ä¸å¦‚é¢„æœŸ
è§£å†³ï¼šæ£€æŸ¥æ˜¯å¦æœ‰é˜»å¡æ“ä½œï¼Œä½¿ç”¨asyncioç‰ˆæœ¬çš„åº“

é—®é¢˜ï¼šå†…å­˜æ³„æ¼
è§£å†³ï¼šç¡®ä¿åç¨‹æ­£å¸¸ç»“æŸï¼Œæ¸…ç†èµ„æº

é—®é¢˜ï¼šè°ƒè¯•å›°éš¾
è§£å†³ï¼šä½¿ç”¨åç¨‹è°ƒè¯•è£…é¥°å™¨ï¼Œå¯ç”¨asyncioè°ƒè¯•æ¨¡å¼
```

### 9.4 å­¦ä¹ è·¯å¾„å»ºè®®


**ğŸ“š å¾ªåºæ¸è¿›çš„å­¦ä¹ æ­¥éª¤**
```
ç¬¬ä¸€é˜¶æ®µ - åŸºç¡€ç†è§£ï¼š
â–¡ ç†è§£ç”Ÿæˆå™¨å’Œyieldå…³é”®å­—
â–¡ æŒæ¡åç¨‹çš„åŸºæœ¬æ¦‚å¿µå’Œè¯­æ³•
â–¡ å­¦ä¼šä½¿ç”¨async/await

ç¬¬äºŒé˜¶æ®µ - å®è·µåº”ç”¨ï¼š
â–¡ ç¼–å†™ç®€å•çš„å¼‚æ­¥ç¨‹åº
â–¡ å­¦ä¹ asyncioåº“çš„åŸºæœ¬ç”¨æ³•
â–¡ ç†è§£äº‹ä»¶å¾ªç¯çš„å·¥ä½œåŸç†

ç¬¬ä¸‰é˜¶æ®µ - è¿›é˜¶æŠ€èƒ½ï¼š
â–¡ æŒæ¡åç¨‹é—´é€šä¿¡å’ŒåŒæ­¥
â–¡ å­¦ä¹ å¼‚æ­¥ç”Ÿæˆå™¨å’Œè¿­ä»£å™¨
â–¡ äº†è§£åç¨‹çš„æ€§èƒ½ä¼˜åŒ–æŠ€å·§

ç¬¬å››é˜¶æ®µ - ä¸“ä¸šåº”ç”¨ï¼š
â–¡ æ„å»ºå¤æ‚çš„å¼‚æ­¥åº”ç”¨
â–¡ é›†æˆå¼‚æ­¥æ•°æ®åº“å’Œç½‘ç»œåº“
â–¡ æŒæ¡åç¨‹çš„è°ƒè¯•å’Œæµ‹è¯•æŠ€å·§
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- åç¨‹æ˜¯å¯æš‚åœæ¢å¤çš„å‡½æ•°ï¼Œé€‚åˆIOå¯†é›†å‹ä»»åŠ¡
- async/awaitæ˜¯ç°ä»£åç¨‹çš„æ ‡å‡†è¯­æ³•
- äº‹ä»¶å¾ªç¯æ˜¯åç¨‹è¿è¡Œçš„åŸºç¡€è®¾æ–½
- åç¨‹éœ€è¦ä¸»åŠ¨è®©å‡ºæ§åˆ¶æƒæ‰èƒ½å®ç°å¹¶å‘
- æ­£ç¡®çš„å¼‚å¸¸å¤„ç†å’Œèµ„æºç®¡ç†æ˜¯åç¨‹ç¼–ç¨‹çš„å…³é”®