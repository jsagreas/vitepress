---
title: 10ã€å†…å­˜ç®¡ç†ä¼˜åŒ–
---
## ğŸ“š ç›®å½•

1. [Pythonå†…å­˜æ¨¡å‹åŸºç¡€ç†è§£](#1-pythonå†…å­˜æ¨¡å‹åŸºç¡€ç†è§£)
2. [å†…å­˜åˆ†é…æœºåˆ¶è¯¦è§£](#2-å†…å­˜åˆ†é…æœºåˆ¶è¯¦è§£)
3. [åƒåœ¾æ”¶é›†ä¼˜åŒ–ç­–ç•¥](#3-åƒåœ¾æ”¶é›†ä¼˜åŒ–ç­–ç•¥)
4. [å†…å­˜æ³„æ¼æ£€æµ‹ä¸é¢„é˜²](#4-å†…å­˜æ³„æ¼æ£€æµ‹ä¸é¢„é˜²)
5. [__slots__å†…å­˜ä¼˜åŒ–è¯¦è§£](#5-__slots__å†…å­˜ä¼˜åŒ–è¯¦è§£)
6. [å¼±å¼•ç”¨weakrefæ¨¡å—åº”ç”¨](#6-å¼±å¼•ç”¨weakrefæ¨¡å—åº”ç”¨)
7. [å†…å­˜æ˜ å°„æ–‡ä»¶å¤„ç†](#7-å†…å­˜æ˜ å°„æ–‡ä»¶å¤„ç†)
8. [å¤§æ•°æ®å¤„ç†ä¼˜åŒ–ç­–ç•¥](#8-å¤§æ•°æ®å¤„ç†ä¼˜åŒ–ç­–ç•¥)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ§  Pythonå†…å­˜æ¨¡å‹åŸºç¡€ç†è§£


### 1.1 ä»€ä¹ˆæ˜¯Pythonå†…å­˜æ¨¡å‹


**ğŸ”¸ ç®€å•ç†è§£**
æƒ³è±¡å†…å­˜å°±åƒä¸€ä¸ªå·¨å¤§çš„å‚¨ç‰©æŸœï¼ŒPythonç¨‹åºè¿è¡Œæ—¶éœ€è¦åœ¨è¿™ä¸ªå‚¨ç‰©æŸœé‡Œå­˜æ”¾å„ç§æ•°æ®ã€‚Pythonçš„å†…å­˜æ¨¡å‹å°±æ˜¯ç®¡ç†è¿™ä¸ªå‚¨ç‰©æŸœçš„è§„åˆ™å’Œæ–¹æ³•ã€‚

```
ç”Ÿæ´»ç±»æ¯”ï¼š
å†…å­˜ = å›¾ä¹¦é¦†çš„ä¹¦æ¶
å¯¹è±¡ = ä¹¦ç±
å˜é‡ = å›¾ä¹¦æ ‡ç­¾
å¼•ç”¨ = æ‰¾ä¹¦çš„ç´¢å¼•å¡
```

**ğŸ’¡ æ ¸å¿ƒæ¦‚å¿µ**
```
Pythonå†…å­˜ç®¡ç†çš„ä¸‰ä¸ªå…³é”®è§’è‰²ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å¯¹è±¡åŒº     â”‚    â”‚   å¼•ç”¨åŒº     â”‚    â”‚  åƒåœ¾å›æ”¶åŒº  â”‚
â”‚ å­˜å‚¨å®é™…æ•°æ®  â”‚    â”‚ å­˜å‚¨å˜é‡å   â”‚    â”‚ æ¸…ç†åºŸå¼ƒæ•°æ®  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†‘                  â†‘                  â†‘
    çœŸæ­£çš„æ•°æ®         å˜é‡æŒ‡å‘æ•°æ®        è‡ªåŠ¨æ¸…ç†æœºåˆ¶
```

### 1.2 Pythonå†…å­˜çš„ç‰¹æ®Šæ€§


**ğŸ”¹ ä¸€åˆ‡çš†å¯¹è±¡çš„å†…å­˜å½±å“**
```python
# åœ¨Pythonä¸­ï¼Œè¿æ•°å­—éƒ½æ˜¯å¯¹è±¡
a = 5  # åˆ›å»ºäº†ä¸€ä¸ªæ•´æ•°å¯¹è±¡ï¼ŒaæŒ‡å‘å®ƒ
b = 5  # Pythonèªæ˜åœ°è®©bä¹ŸæŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡
print(id(a) == id(b))  # Trueï¼Œå®ƒä»¬æŒ‡å‘åŒä¸€ä¸ªå†…å­˜åœ°å€
```

**ğŸ“Š å†…å­˜ä½¿ç”¨å¯¹æ¯”**
| è¯­è¨€ç±»å‹ | **æ•°æ®å­˜å‚¨æ–¹å¼** | **å†…å­˜å¼€é”€** | **è®¿é—®é€Ÿåº¦** |
|---------|----------------|-------------|-------------|
| ğŸ”¸ **Cè¯­è¨€** | `ç›´æ¥å­˜å‚¨å€¼` | `æå°` | `æå¿«` |
| ğŸ”¸ **Python** | `å¯¹è±¡+å¼•ç”¨` | `è¾ƒå¤§` | `è¾ƒæ…¢ä½†çµæ´»` |

> **ğŸ’¡ ç†è§£è¦ç‚¹**ï¼šPythonç”¨ç©ºé—´æ¢å–äº†çµæ´»æ€§ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å­¦ä¼šä¼˜åŒ–å†…å­˜ä½¿ç”¨

### 1.3 å†…å­˜æ¨¡å‹çš„å®é™…å½±å“


**ğŸ¯ ä¸ºä»€ä¹ˆè¦å…³å¿ƒå†…å­˜æ¨¡å‹**
```
å®é™…åœºæ™¯ä¸¾ä¾‹ï¼š
å¤„ç†100ä¸‡æ¡ç”¨æˆ·æ•°æ®æ—¶
- ä¸ä¼˜åŒ–ï¼šå¯èƒ½å ç”¨2GBå†…å­˜
- ä¼˜åŒ–åï¼šå¯èƒ½åªéœ€è¦500MBå†…å­˜
- ç»“æœï¼šç¨‹åºè¿è¡Œæ›´å¿«ï¼Œä¸å®¹æ˜“å´©æºƒ
```

---

## 2. âš™ï¸ å†…å­˜åˆ†é…æœºåˆ¶è¯¦è§£


### 2.1 Pythonçš„å†…å­˜åˆ†é…ç­–ç•¥


**ğŸ”¸ åˆ†å±‚å†…å­˜ç®¡ç†**
```
Pythonå†…å­˜åˆ†é…çš„ä¸‰å±‚ç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â† ç¬¬3å±‚ï¼šPythonå¯¹è±¡å±‚
â”‚  åˆ—è¡¨ã€å­—å…¸ã€å­—ç¬¦ä¸²ç­‰Pythonå¯¹è±¡      â”‚   (æˆ‘ä»¬ç›´æ¥æ“ä½œçš„å±‚é¢)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â† ç¬¬2å±‚ï¼šPythonå†…å­˜æ± 
â”‚  PyMallocå†…å­˜ç®¡ç†å™¨                 â”‚   (Pythonè‡ªåŠ¨ç®¡ç†)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â† ç¬¬1å±‚ï¼šç³»ç»Ÿå†…å­˜
â”‚  æ“ä½œç³»ç»Ÿå†…å­˜ç®¡ç†                   â”‚   (ç³»ç»Ÿåº•å±‚ç®¡ç†)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ’¡ é€šä¿—è§£é‡Š**
- **ç¬¬1å±‚**ï¼šåƒåŸå¸‚çš„åœŸåœ°èµ„æºï¼Œç”±æ”¿åºœï¼ˆæ“ä½œç³»ç»Ÿï¼‰ç»Ÿä¸€ç®¡ç†
- **ç¬¬2å±‚**ï¼šåƒå°åŒºç‰©ä¸šï¼ŒPythonåœ¨åœŸåœ°ä¸Šå»ºç«‹è‡ªå·±çš„ç®¡ç†è§„åˆ™
- **ç¬¬3å±‚**ï¼šåƒæˆ‘ä»¬çš„æˆ¿é—´ï¼Œç›´æ¥ä½¿ç”¨å’Œå¸ƒç½®çš„ç©ºé—´

### 2.2 å°å¯¹è±¡å†…å­˜æ± æœºåˆ¶


**ğŸ”¹ ä»€ä¹ˆæ˜¯å°å¯¹è±¡æ± **
```python
# Pythonå¯¹å°äº512å­—èŠ‚çš„å¯¹è±¡ä½¿ç”¨ç‰¹æ®Šçš„å†…å­˜æ± 
small_list = [1, 2, 3]        # ä½¿ç”¨å†…å­˜æ± 
big_list = list(range(1000))  # å¯èƒ½ä¸ä½¿ç”¨å†…å­˜æ± 

# å†…å­˜æ± çš„å¥½å¤„ï¼šåˆ†é…å’Œé‡Šæ”¾é€Ÿåº¦æ›´å¿«
```

**ğŸ“ˆ å†…å­˜æ± å·¥ä½œåŸç†**
```
å†…å­˜æ± å°±åƒé¤å…çš„é¤å…·ç®¡ç†ï¼š
ç”¨é¤é«˜å³°æœŸï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å·²ä½¿ç”¨   â”‚  â”‚ å·²ä½¿ç”¨   â”‚  â”‚ ç©ºé—²     â”‚
â”‚ é¤å…·     â”‚  â”‚ é¤å…·     â”‚  â”‚ é¤å…·     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“           â†“           â†‘
  æ­£åœ¨ç”¨é¤    æ­£åœ¨ç”¨é¤    ç­‰å¾…ä½¿ç”¨

å®¢äººèµ°åé¤å…·ä¸æ‰”æ‰ï¼Œæ´—å‡€åç»™ä¸‹ä¸€ä½å®¢äººç”¨
è¿™æ ·æ¯”æ¯æ¬¡éƒ½ä¹°æ–°é¤å…·æ•ˆç‡é«˜å¾—å¤š
```

### 2.3 å¼•ç”¨è®¡æ•°æœºåˆ¶


**ğŸ”¸ ä»€ä¹ˆæ˜¯å¼•ç”¨è®¡æ•°**
```python
# æ¯ä¸ªå¯¹è±¡éƒ½æœ‰ä¸€ä¸ª"å¼•ç”¨è®¡æ•°å™¨"
import sys

data = "Hello World"
print(f"å¼•ç”¨æ¬¡æ•°: {sys.getrefcount(data)}")  # å¼•ç”¨æ¬¡æ•°: 2

another_ref = data  # å¢åŠ ä¸€ä¸ªå¼•ç”¨
print(f"å¼•ç”¨æ¬¡æ•°: {sys.getrefcount(data)}")  # å¼•ç”¨æ¬¡æ•°: 3

del another_ref     # åˆ é™¤ä¸€ä¸ªå¼•ç”¨
print(f"å¼•ç”¨æ¬¡æ•°: {sys.getrefcount(data)}")  # å¼•ç”¨æ¬¡æ•°: 2
```

**ğŸ”„ å¼•ç”¨è®¡æ•°çš„ç”Ÿæ´»ç±»æ¯”**
```
å¼•ç”¨è®¡æ•° = å›¾ä¹¦é¦†çš„å€Ÿé˜…ç™»è®°
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä¸€æœ¬ä¹¦     â”‚ â† è¿™æ˜¯å¯¹è±¡
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å€Ÿé˜…è®°å½•ï¼š   â”‚ â† è¿™æ˜¯å¼•ç”¨è®¡æ•°
â”‚ å¼ ä¸‰ âœ“      â”‚
â”‚ æå›› âœ“      â”‚   
â”‚ ç‹äº” âœ“      â”‚   æ€»å…±3ä¸ªäººå€Ÿé˜…
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å½“æ‰€æœ‰äººéƒ½è¿˜ä¹¦äº†ï¼ˆå¼•ç”¨è®¡æ•°=0ï¼‰ï¼Œå›¾ä¹¦é¦†å°±å¯ä»¥ä¸‹æ¶è¿™æœ¬ä¹¦
```

---

## 3. ğŸ—‘ï¸ åƒåœ¾æ”¶é›†ä¼˜åŒ–ç­–ç•¥


### 3.1 Pythonåƒåœ¾æ”¶é›†æœºåˆ¶åŸç†


**ğŸ”¸ ä¸ºä»€ä¹ˆéœ€è¦åƒåœ¾æ”¶é›†**
```python
# å¾ªç¯å¼•ç”¨é—®é¢˜ï¼šå¼•ç”¨è®¡æ•°æ— æ³•è§£å†³
class Node:
    def __init__(self, value):
        self.value = value
        self.next = None

# åˆ›å»ºå¾ªç¯å¼•ç”¨
node1 = Node("A")
node2 = Node("B")
node1.next = node2  # node1æŒ‡å‘node2
node2.next = node1  # node2æŒ‡å‘node1

# å³ä½¿åˆ é™¤å˜é‡ï¼Œå¯¹è±¡ä»ç„¶ç›¸äº’å¼•ç”¨ï¼Œå¼•ç”¨è®¡æ•°ä¸ä¸º0
del node1, node2    # ä½†å†…å­˜ä¸­çš„å¯¹è±¡è¿˜åœ¨äº’ç›¸æŒ‡å‘
```

**ğŸ’¡ åƒåœ¾æ”¶é›†å™¨çš„ä½œç”¨**
```
åƒåœ¾æ”¶é›†å™¨ = åŸå¸‚æ¸…æ´å·¥
å®šæœŸæ£€æŸ¥æ•´ä¸ª"åŸå¸‚"ï¼ˆå†…å­˜ï¼‰ï¼Œæ‰¾å‡ºï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æœ‰ç”¨çš„å¯¹è±¡   â”‚  â”‚ å¾ªç¯å¼•ç”¨åƒåœ¾  â”‚  â”‚ å­¤ç«‹çš„åƒåœ¾   â”‚
â”‚ (ç»§ç»­ä¿ç•™)   â”‚  â”‚ (éœ€è¦æ¸…ç†)   â”‚  â”‚ (éœ€è¦æ¸…ç†)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“               â†“               â†“
     ä¿æŒåŸæ ·        æ‰“ç ´å¾ªç¯         ç›´æ¥åˆ é™¤
```

### 3.2 åƒåœ¾æ”¶é›†çš„ä¸‰ä»£æœºåˆ¶


**ğŸ“Š åˆ†ä»£åƒåœ¾æ”¶é›†ç­–ç•¥**
```
Pythoné‡‡ç”¨"å¹´é¾„åˆ†å±‚"çš„æ¸…ç†ç­–ç•¥ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ–°ç”Ÿä»£     â”‚  â”‚   ä¸­ç”Ÿä»£     â”‚  â”‚   è€ç”Ÿä»£     â”‚
â”‚  (0ä»£å¯¹è±¡)   â”‚  â”‚  (1ä»£å¯¹è±¡)   â”‚  â”‚  (2ä»£å¯¹è±¡)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åˆšåˆ›å»ºçš„å¯¹è±¡  â”‚  â”‚ å­˜æ´»ä¸€æ®µæ—¶é—´  â”‚  â”‚ é•¿æœŸå­˜æ´»å¯¹è±¡  â”‚
â”‚ æ¸…ç†é¢‘ç‡é«˜   â”‚  â”‚ æ¸…ç†é¢‘ç‡ä¸­ç­‰  â”‚  â”‚ æ¸…ç†é¢‘ç‡ä½   â”‚
â”‚ é˜ˆå€¼: 700   â”‚  â”‚ é˜ˆå€¼: 10     â”‚  â”‚ é˜ˆå€¼: 10     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”§ åƒåœ¾æ”¶é›†ä¼˜åŒ–å®è·µ**
```python
import gc

# æ‰‹åŠ¨è§¦å‘åƒåœ¾æ”¶é›†
collected = gc.collect()
print(f"æ¸…ç†äº† {collected} ä¸ªå¯¹è±¡")

# æŸ¥çœ‹åƒåœ¾æ”¶é›†ç»Ÿè®¡ä¿¡æ¯
print("å„ä»£å¯¹è±¡æ•°é‡:", gc.get_count())
print("åƒåœ¾æ”¶é›†é˜ˆå€¼:", gc.get_threshold())

# åœ¨å†…å­˜å¯†é›†å‹æ“ä½œåæ‰‹åŠ¨æ¸…ç†
def process_large_data():
    # å¤„ç†å¤§é‡æ•°æ®
    large_data = [i for i in range(1000000)]
    # å¤„ç†å®Œæˆå
    del large_data
    gc.collect()  # æ‰‹åŠ¨æ¸…ç†ï¼Œç¡®ä¿å†…å­˜é‡Šæ”¾
```

### 3.3 ä¼˜åŒ–åƒåœ¾æ”¶é›†æ€§èƒ½


**âš¡ å®ç”¨ä¼˜åŒ–æŠ€å·§**
```python
# æŠ€å·§1ï¼šå‡å°‘ä¸å¿…è¦çš„å¯¹è±¡åˆ›å»º
# ä¸å¥½çš„åšæ³•
def bad_string_concat(items):
    result = ""
    for item in items:
        result += str(item)  # æ¯æ¬¡éƒ½åˆ›å»ºæ–°å­—ç¬¦ä¸²å¯¹è±¡
    return result

# å¥½çš„åšæ³•
def good_string_concat(items):
    return "".join(str(item) for item in items)  # ä¸€æ¬¡æ€§åˆ›å»º

# æŠ€å·§2ï¼šåŠæ—¶æ¸…ç†å¤§å¯¹è±¡
def process_data_file(filename):
    with open(filename) as f:
        data = f.read()  # å¯èƒ½å¾ˆå¤§çš„å¯¹è±¡
        
    # å¤„ç†æ•°æ®
    result = process(data)
    
    # ä¸»åŠ¨åˆ é™¤å¤§å¯¹è±¡ï¼Œä¸ç­‰åƒåœ¾æ”¶é›†
    del data
    
    return result
```

---

## 4. ğŸ” å†…å­˜æ³„æ¼æ£€æµ‹ä¸é¢„é˜²


### 4.1 ä»€ä¹ˆæ˜¯å†…å­˜æ³„æ¼


**ğŸ”¸ å†…å­˜æ³„æ¼çš„é€šä¿—ç†è§£**
```
å†…å­˜æ³„æ¼ = å®¶é‡Œçš„æ‚ç‰©è¶Šå †è¶Šå¤š
æ­£å¸¸æƒ…å†µï¼š
ç”¨å®Œçš„ä¸œè¥¿ â†’ åŠæ—¶ä¸¢å¼ƒ â†’ ç©ºé—´é‡Šæ”¾ â†’ å¯ä»¥æ”¾æ–°ä¸œè¥¿

å†…å­˜æ³„æ¼ï¼š
ç”¨å®Œçš„ä¸œè¥¿ â†’ å¿˜è®°ä¸¢å¼ƒ â†’ ç©ºé—´å ç”¨ â†’ å¯ç”¨ç©ºé—´è¶Šæ¥è¶Šå°‘
```

**ğŸ’¡ Pythonä¸­å¸¸è§çš„å†…å­˜æ³„æ¼åœºæ™¯**
```python
# åœºæ™¯1ï¼šå…¨å±€å˜é‡ç´¯ç§¯
global_cache = []  # å…¨å±€åˆ—è¡¨

def add_to_cache(data):
    global_cache.append(data)  # æ•°æ®ä¸€ç›´ç´¯ç§¯ï¼Œä»ä¸æ¸…ç†

# åœºæ™¯2ï¼šå¾ªç¯å¼•ç”¨
class Parent:
    def __init__(self):
        self.children = []
    
    def add_child(self, child):
        self.children.append(child)
        child.parent = self  # å¾ªç¯å¼•ç”¨ï¼šparent â†” child

# åœºæ™¯3ï¼šé—­åŒ…æ•è·å¤§å¯¹è±¡
def create_function():
    big_data = list(range(1000000))  # å¤§å¯¹è±¡
    
    def inner_func():
        print("Hello")  # å³ä½¿ä¸ç”¨big_dataï¼Œä¹Ÿä¼šä¿æŒå¼•ç”¨
    
    return inner_func  # big_dataè¢«é—­åŒ…æ•è·ï¼Œæ— æ³•é‡Šæ”¾
```

### 4.2 å†…å­˜æ³„æ¼æ£€æµ‹å·¥å…·


**ğŸ”§ ä½¿ç”¨tracemallocæ£€æµ‹å†…å­˜ä½¿ç”¨**
```python
import tracemalloc

# å¼€å§‹å†…å­˜è¿½è¸ª
tracemalloc.start()

# æ¨¡æ‹Ÿä¸€äº›æ“ä½œ
data = []
for i in range(100000):
    data.append(i)

# è·å–å†…å­˜ä½¿ç”¨å¿«ç…§
snapshot = tracemalloc.take_snapshot()
top_stats = snapshot.statistics('lineno')

print("å†…å­˜ä½¿ç”¨æœ€å¤šçš„å‰3è¡Œä»£ç :")
for stat in top_stats[:3]:
    print(f"æ–‡ä»¶: {stat.traceback.format()}")
    print(f"å†…å­˜: {stat.size / 1024 / 1024:.1f} MB")
    print(f"å¯¹è±¡æ•°: {stat.count}")
    print("-" * 40)
```

**ğŸ“Š å†…å­˜ä½¿ç”¨ç›‘æ§**
```python
import psutil
import os

def monitor_memory():
    """ç›‘æ§å½“å‰è¿›ç¨‹çš„å†…å­˜ä½¿ç”¨"""
    process = psutil.Process(os.getpid())
    memory_info = process.memory_info()
    
    print(f"RSSå†…å­˜ (å®é™…å ç”¨): {memory_info.rss / 1024 / 1024:.1f} MB")
    print(f"VMSå†…å­˜ (è™šæ‹Ÿå†…å­˜): {memory_info.vms / 1024 / 1024:.1f} MB")
    print(f"å†…å­˜ä½¿ç”¨ç™¾åˆ†æ¯”: {process.memory_percent():.1f}%")

# åœ¨ç¨‹åºå…³é”®ç‚¹è°ƒç”¨ç›‘æ§
monitor_memory()
```

### 4.3 å†…å­˜æ³„æ¼é¢„é˜²ç­–ç•¥


**âœ… æœ€ä½³å®è·µæ¸…å•**
```python
# ç­–ç•¥1ï¼šä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨
class ResourceManager:
    def __init__(self):
        self.resources = []
    
    def __enter__(self):
        return self
    
    def __exit__(self, exc_type, exc_val, exc_tb):
        # è‡ªåŠ¨æ¸…ç†èµ„æº
        for resource in self.resources:
            del resource
        self.resources.clear()

# ç­–ç•¥2ï¼šå®šæœŸæ¸…ç†ç¼“å­˜
from collections import OrderedDict

class LimitedCache:
    def __init__(self, max_size=1000):
        self.cache = OrderedDict()
        self.max_size = max_size
    
    def set(self, key, value):
        if len(self.cache) >= self.max_size:
            # åˆ é™¤æœ€è€çš„é¡¹ç›®
            self.cache.popitem(last=False)
        self.cache[key] = value

# ç­–ç•¥3ï¼šä½¿ç”¨å¼±å¼•ç”¨æ‰“ç ´å¾ªç¯
import weakref

class Parent:
    def __init__(self):
        self._children = []  # ä½¿ç”¨å¼ºå¼•ç”¨å­˜å‚¨children
    
    def add_child(self, child):
        self._children.append(child)
        child.parent = weakref.ref(self)  # ä½¿ç”¨å¼±å¼•ç”¨é¿å…å¾ªç¯
```

---

## 5. ğŸ¯ __slots__å†…å­˜ä¼˜åŒ–è¯¦è§£


### 5.1 ä»€ä¹ˆæ˜¯__slots__


**ğŸ”¸ __slots__çš„é€šä¿—ç†è§£**
```
æ™®é€šPythonå¯¹è±¡ = å¸¦æŠ½å±‰çš„ä¹¦æ¡Œ
- æŠ½å±‰æ•°é‡ä¸é™åˆ¶ï¼Œå¯ä»¥éšæ—¶åŠ æ–°æŠ½å±‰
- ä½†æ¯ä¸ªæŠ½å±‰éƒ½éœ€è¦æ ‡ç­¾å’Œç®¡ç†ç©ºé—´
- é€‚åˆéœ€è¦çµæ´»æ€§çš„åœºæ™¯

__slots__å¯¹è±¡ = å›ºå®šæ ¼ä½çš„å·¥å…·ç®±
- é¢„å…ˆå®šä¹‰å¥½æœ‰å‡ ä¸ªæ ¼å­ï¼Œæ”¾ä»€ä¹ˆä¸œè¥¿
- æ²¡æœ‰é¢å¤–çš„ç®¡ç†å¼€é”€
- èŠ‚çœç©ºé—´ä½†å¤±å»çµæ´»æ€§
```

**ğŸ’¡ __slots__çš„å·¥ä½œåŸç†**
```python
# æ™®é€šç±»ï¼šä½¿ç”¨__dict__å­˜å‚¨å±æ€§
class NormalPerson:
    def __init__(self, name, age):
        self.name = name
        self.age = age

# ä½¿ç”¨__slots__çš„ç±»ï¼šå›ºå®šå±æ€§
class SlottedPerson:
    __slots__ = ['name', 'age']  # åªå…è®¸è¿™ä¸¤ä¸ªå±æ€§
    
    def __init__(self, name, age):
        self.name = name
        self.age = age

# å†…å­˜ä½¿ç”¨å¯¹æ¯”
normal = NormalPerson("å¼ ä¸‰", 25)
slotted = SlottedPerson("æå››", 30)

print(f"æ™®é€šå¯¹è±¡å¤§å°: {normal.__sizeof__() + normal.__dict__.__sizeof__()} bytes")
print(f"__slots__å¯¹è±¡å¤§å°: {slotted.__sizeof__()} bytes")
```

### 5.2 __slots__çš„ä½¿ç”¨åœºæ™¯


**ğŸ“Š æ€§èƒ½å¯¹æ¯”æµ‹è¯•**
```python
import sys
from typing import List

class Point:
    def __init__(self, x: float, y: float):
        self.x = x
        self.y = y

class SlottedPoint:
    __slots__ = ['x', 'y']
    
    def __init__(self, x: float, y: float):
        self.x = x
        self.y = y

# åˆ›å»ºå¤§é‡å¯¹è±¡æµ‹è¯•
def test_memory_usage():
    # åˆ›å»º100ä¸‡ä¸ªæ™®é€šå¯¹è±¡
    normal_points = [Point(i, i) for i in range(1000000)]
    
    # åˆ›å»º100ä¸‡ä¸ª__slots__å¯¹è±¡
    slotted_points = [SlottedPoint(i, i) for i in range(1000000)]
    
    print(f"æ™®é€šå¯¹è±¡æ€»å†…å­˜: {sum(sys.getsizeof(p) + sys.getsizeof(p.__dict__) for p in normal_points[:1000]) / 1000:.1f} bytes per object")
    print(f"__slots__å¯¹è±¡æ€»å†…å­˜: {sum(sys.getsizeof(p) for p in slotted_points[:1000]) / 1000:.1f} bytes per object")

# å®é™…å†…å­˜èŠ‚çœé€šå¸¸åœ¨30-50%
```

**ğŸ¯ é€‚ç”¨åœºæ™¯åˆ¤æ–­**
```
ä½¿ç”¨__slots__çš„åœºæ™¯ï¼š
âœ… éœ€è¦åˆ›å»ºå¤§é‡ç›¸åŒç±»å‹çš„å¯¹è±¡
âœ… å¯¹è±¡å±æ€§å›ºå®šï¼Œä¸éœ€è¦åŠ¨æ€æ·»åŠ 
âœ… å¯¹å†…å­˜ä½¿ç”¨æœ‰ä¸¥æ ¼è¦æ±‚
âœ… å¯¹è±¡ä¸»è¦ç”¨äºæ•°æ®å­˜å‚¨

ä¸é€‚ç”¨__slots__çš„åœºæ™¯ï¼š
âŒ éœ€è¦åŠ¨æ€æ·»åŠ å±æ€§
âŒ éœ€è¦ç»§æ‰¿å¤æ‚çš„ç±»å±‚æ¬¡
âŒ å¯¹è±¡æ•°é‡è¾ƒå°‘ï¼ˆä¼˜åŒ–æ•ˆæœä¸æ˜æ˜¾ï¼‰
âŒ éœ€è¦ä½¿ç”¨æŸäº›ç‰¹æ®ŠåŠŸèƒ½ï¼ˆå¦‚__dict__ï¼‰
```

### 5.3 __slots__çš„é«˜çº§ç”¨æ³•


**ğŸ”§ å®ç”¨çš„__slots__æ¨¡å¼**
```python
# æ¨¡å¼1ï¼šæ•°æ®ç±»ä¼˜åŒ–
class Vector3D:
    __slots__ = ['x', 'y', 'z']
    
    def __init__(self, x=0, y=0, z=0):
        self.x = x
        self.y = y
        self.z = z
    
    def magnitude(self):
        return (self.x**2 + self.y**2 + self.z**2)**0.5
    
    def __repr__(self):
        return f"Vector3D({self.x}, {self.y}, {self.z})"

# æ¨¡å¼2ï¼šé…ç½®ç±»ä¼˜åŒ–
class DatabaseConfig:
    __slots__ = ['host', 'port', 'username', 'password', 'database']
    
    def __init__(self, **kwargs):
        # åªå…è®¸é¢„å®šä¹‰çš„é…ç½®é¡¹
        for slot in self.__slots__:
            setattr(self, slot, kwargs.get(slot))

# æ¨¡å¼3ï¼šèŠ‚ç‚¹ç±»ä¼˜åŒ–ï¼ˆæ ‘ã€å›¾ç­‰æ•°æ®ç»“æ„ï¼‰
class TreeNode:
    __slots__ = ['value', 'left', 'right', 'parent']
    
    def __init__(self, value):
        self.value = value
        self.left = None
        self.right = None
        self.parent = None
```

**âš ï¸ __slots__ä½¿ç”¨æ³¨æ„äº‹é¡¹**
```python
# æ³¨æ„äº‹é¡¹1ï¼šä¸èƒ½åŠ¨æ€æ·»åŠ å±æ€§
class SlottedClass:
    __slots__ = ['x', 'y']

obj = SlottedClass()
obj.x = 1  # æ­£å¸¸
# obj.z = 3  # é”™è¯¯ï¼AttributeError: 'SlottedClass' object has no attribute 'z'

# æ³¨æ„äº‹é¡¹2ï¼šç»§æ‰¿æ—¶çš„è€ƒè™‘
class Base:
    __slots__ = ['a']

class Child(Base):
    __slots__ = ['b']  # å­ç±»å¯ä»¥å®šä¹‰é¢å¤–çš„slots

# æ³¨æ„äº‹é¡¹3ï¼šå¤šé‡ç»§æ‰¿çš„é™åˆ¶
# å¤šé‡ç»§æ‰¿æ—¶åªèƒ½æœ‰ä¸€ä¸ªçˆ¶ç±»å®šä¹‰__slots__
```

---

## 6. ğŸ”— å¼±å¼•ç”¨weakrefæ¨¡å—åº”ç”¨


### 6.1 ä»€ä¹ˆæ˜¯å¼±å¼•ç”¨


**ğŸ”¸ å¼±å¼•ç”¨çš„ç”Ÿæ´»ç±»æ¯”**
```
å¼ºå¼•ç”¨ = æˆ¿å­çš„æ­£å¼ç§Ÿå®¢
- æœ‰ç§Ÿçº¦ä¿æŠ¤ï¼Œæˆ¿ä¸œä¸èƒ½éšæ„æ”¶å›æˆ¿å­
- åªè¦ç§Ÿå®¢ä¸é€€ç§Ÿï¼Œæˆ¿å­å°±ä¸€ç›´è¢«å ç”¨

å¼±å¼•ç”¨ = æˆ¿å­çš„ä¸´æ—¶è®¿å®¢
- æ²¡æœ‰ç§Ÿçº¦ä¿æŠ¤ï¼Œæˆ¿ä¸œå¯ä»¥éšæ—¶æ”¶å›æˆ¿å­
- è®¿å®¢å¯ä»¥çŸ¥é“æˆ¿å­æ˜¯å¦è¿˜åœ¨ï¼Œä½†ä¸èƒ½é˜»æ­¢æˆ¿å­è¢«æ”¶å›
```

**ğŸ’¡ å¼±å¼•ç”¨çš„æŠ€æœ¯å«ä¹‰**
```python
import weakref

# åˆ›å»ºå¯¹è±¡
data = [1, 2, 3, 4, 5]

# åˆ›å»ºå¼ºå¼•ç”¨ï¼ˆæ™®é€šå¼•ç”¨ï¼‰
strong_ref = data        # é˜»æ­¢å¯¹è±¡è¢«åƒåœ¾æ”¶é›†

# åˆ›å»ºå¼±å¼•ç”¨
weak_ref = weakref.ref(data)  # ä¸é˜»æ­¢å¯¹è±¡è¢«åƒåœ¾æ”¶é›†

print(f"é€šè¿‡å¼ºå¼•ç”¨è®¿é—®: {strong_ref}")
print(f"é€šè¿‡å¼±å¼•ç”¨è®¿é—®: {weak_ref()}")  # æ³¨æ„ï¼šéœ€è¦è°ƒç”¨æ‰èƒ½è·å–å¯¹è±¡

# åˆ é™¤å¼ºå¼•ç”¨
del data, strong_ref

# å¼±å¼•ç”¨æŒ‡å‘çš„å¯¹è±¡å¯èƒ½å·²ç»è¢«å›æ”¶
if weak_ref() is None:
    print("å¯¹è±¡å·²è¢«åƒåœ¾æ”¶é›†")
else:
    print(f"å¯¹è±¡ä»ç„¶å­˜åœ¨: {weak_ref()}")
```

### 6.2 å¼±å¼•ç”¨çš„åº”ç”¨åœºæ™¯


**ğŸ”§ è§£å†³å¾ªç¯å¼•ç”¨é—®é¢˜**
```python
import weakref

class Parent:
    def __init__(self, name):
        self.name = name
        self.children = []
    
    def add_child(self, child):
        self.children.append(child)
        # ä½¿ç”¨å¼±å¼•ç”¨é¿å…å¾ªç¯ï¼šparent â† child
        child._parent = weakref.ref(self)
    
    def __repr__(self):
        return f"Parent({self.name})"

class Child:
    def __init__(self, name):
        self.name = name
        self._parent = None
    
    @property
    def parent(self):
        # å®‰å…¨åœ°è·å–çˆ¶å¯¹è±¡
        if self._parent is not None:
            return self._parent()  # è°ƒç”¨å¼±å¼•ç”¨
        return None
    
    def __repr__(self):
        parent_name = self.parent.name if self.parent else "None"
        return f"Child({self.name}, parent={parent_name})"

# ä½¿ç”¨ç¤ºä¾‹
parent = Parent("çˆ¸çˆ¸")
child = Child("å„¿å­")
parent.add_child(child)

print(f"å­å¯¹è±¡çš„çˆ¶äº²: {child.parent}")

# åˆ é™¤çˆ¶å¯¹è±¡
del parent
print(f"çˆ¶å¯¹è±¡åˆ é™¤å: {child.parent}")  # None
```

**ğŸ¯ è§‚å¯Ÿè€…æ¨¡å¼ä¸­çš„åº”ç”¨**
```python
import weakref
from typing import List, Callable

class Observable:
    def __init__(self):
        # ä½¿ç”¨å¼±å¼•ç”¨å­˜å‚¨è§‚å¯Ÿè€…ï¼Œé¿å…å†…å­˜æ³„æ¼
        self._observers = weakref.WeakSet()
    
    def add_observer(self, observer):
        self._observers.add(observer)
    
    def remove_observer(self, observer):
        self._observers.discard(observer)
    
    def notify(self, message):
        # é€šçŸ¥æ‰€æœ‰è¿˜å­˜æ´»çš„è§‚å¯Ÿè€…
        for observer in self._observers:
            observer.update(message)

class Observer:
    def __init__(self, name):
        self.name = name
    
    def update(self, message):
        print(f"{self.name} æ”¶åˆ°æ¶ˆæ¯: {message}")

# ä½¿ç”¨ç¤ºä¾‹
observable = Observable()

# åˆ›å»ºè§‚å¯Ÿè€…
observer1 = Observer("è§‚å¯Ÿè€…1")
observer2 = Observer("è§‚å¯Ÿè€…2")

observable.add_observer(observer1)
observable.add_observer(observer2)

observable.notify("ç¬¬ä¸€æ¡æ¶ˆæ¯")  # ä¸¤ä¸ªè§‚å¯Ÿè€…éƒ½æ”¶åˆ°

# åˆ é™¤ä¸€ä¸ªè§‚å¯Ÿè€…
del observer1

observable.notify("ç¬¬äºŒæ¡æ¶ˆæ¯")  # åªæœ‰observer2æ”¶åˆ°
```

### 6.3 å¼±å¼•ç”¨çš„é«˜çº§ç”¨æ³•


**ğŸ”§ ç¼“å­˜ä¼˜åŒ–**
```python
import weakref
import gc

class SmartCache:
    def __init__(self):
        # ä½¿ç”¨å¼±å¼•ç”¨å­—å…¸ï¼Œå¯¹è±¡è¢«åˆ é™¤æ—¶è‡ªåŠ¨æ¸…ç†ç¼“å­˜
        self._cache = weakref.WeakValueDictionary()
    
    def get_or_create(self, key, factory):
        # å°è¯•ä»ç¼“å­˜è·å–
        obj = self._cache.get(key)
        if obj is not None:
            print(f"ä»ç¼“å­˜è·å–: {key}")
            return obj
        
        # åˆ›å»ºæ–°å¯¹è±¡
        print(f"åˆ›å»ºæ–°å¯¹è±¡: {key}")
        obj = factory()
        self._cache[key] = obj
        return obj

class ExpensiveObject:
    def __init__(self, data):
        self.data = data
        print(f"åˆ›å»ºæ˜‚è´µå¯¹è±¡: {data}")

# ä½¿ç”¨ç¤ºä¾‹
cache = SmartCache()

# åˆ›å»ºå¯¹è±¡
obj1 = cache.get_or_create("key1", lambda: ExpensiveObject("æ•°æ®1"))
obj2 = cache.get_or_create("key1", lambda: ExpensiveObject("æ•°æ®1"))  # ä»ç¼“å­˜è·å–

print(f"å¯¹è±¡ç›¸åŒ: {obj1 is obj2}")

# åˆ é™¤å¯¹è±¡å¼•ç”¨
del obj1, obj2

# è§¦å‘åƒåœ¾æ”¶é›†
gc.collect()

# å†æ¬¡è·å–ï¼Œéœ€è¦é‡æ–°åˆ›å»º
obj3 = cache.get_or_create("key1", lambda: ExpensiveObject("æ•°æ®1"))
```

**ğŸ“š å›è°ƒå‡½æ•°ç®¡ç†**
```python
import weakref
from functools import partial

class EventManager:
    def __init__(self):
        self._callbacks = weakref.WeakKeyDictionary()
    
    def register(self, obj, callback):
        """æ³¨å†Œå¯¹è±¡çš„å›è°ƒå‡½æ•°"""
        if obj not in self._callbacks:
            self._callbacks[obj] = []
        self._callbacks[obj].append(callback)
    
    def trigger(self, event_data):
        """è§¦å‘æ‰€æœ‰æ´»è·ƒå¯¹è±¡çš„å›è°ƒ"""
        for obj, callbacks in self._callbacks.items():
            for callback in callbacks:
                try:
                    callback(event_data)
                except Exception as e:
                    print(f"å›è°ƒæ‰§è¡Œå¤±è´¥: {e}")

class Handler:
    def __init__(self, name):
        self.name = name
    
    def handle_event(self, data):
        print(f"{self.name} å¤„ç†äº‹ä»¶: {data}")

# ä½¿ç”¨ç¤ºä¾‹
event_manager = EventManager()

handler1 = Handler("å¤„ç†å™¨1")
handler2 = Handler("å¤„ç†å™¨2")

# æ³¨å†Œå›è°ƒ
event_manager.register(handler1, handler1.handle_event)
event_manager.register(handler2, handler2.handle_event)

event_manager.trigger("æµ‹è¯•äº‹ä»¶")  # ä¸¤ä¸ªå¤„ç†å™¨éƒ½å“åº”

# åˆ é™¤ä¸€ä¸ªå¤„ç†å™¨
del handler1

event_manager.trigger("ç¬¬äºŒä¸ªäº‹ä»¶")  # åªæœ‰handler2å“åº”
```

---

## 7. ğŸ“ å†…å­˜æ˜ å°„æ–‡ä»¶å¤„ç†


### 7.1 ä»€ä¹ˆæ˜¯å†…å­˜æ˜ å°„æ–‡ä»¶


**ğŸ”¸ å†…å­˜æ˜ å°„çš„é€šä¿—ç†è§£**
```
ä¼ ç»Ÿæ–‡ä»¶è¯»å– = å›¾ä¹¦é¦†å€Ÿä¹¦
1. å»å›¾ä¹¦é¦†ï¼ˆæ‰“å¼€æ–‡ä»¶ï¼‰
2. æ‰¾åˆ°ä¹¦ï¼ˆå®šä½æ•°æ®ï¼‰
3. æŠŠæ•´æœ¬ä¹¦æ¬å›å®¶ï¼ˆè¯»å…¥å†…å­˜ï¼‰
4. åœ¨å®¶é‡Œé˜…è¯»ï¼ˆå¤„ç†æ•°æ®ï¼‰

å†…å­˜æ˜ å°„ = åœ¨å›¾ä¹¦é¦†é˜…è§ˆå®¤é˜…è¯»
1. å»å›¾ä¹¦é¦†ï¼ˆæ˜ å°„æ–‡ä»¶ï¼‰
2. ä¹¦å°±åœ¨æ¡Œä¸Šï¼ˆç›´æ¥è®¿é—®æ–‡ä»¶å†…å®¹ï¼‰
3. éšæ—¶ç¿»é˜…ä»»æ„é¡µé¢ï¼ˆéšæœºè®¿é—®ï¼‰
4. çœ‹å®Œå°±èµ°ï¼ˆè‡ªåŠ¨ç®¡ç†ï¼‰
```

**ğŸ’¡ å†…å­˜æ˜ å°„çš„ä¼˜åŠ¿**
```python
import mmap
import os

# ä¼ ç»Ÿæ–¹å¼ï¼šä¸€æ¬¡æ€§è¯»å–æ•´ä¸ªæ–‡ä»¶
def traditional_read(filename):
    with open(filename, 'rb') as f:
        data = f.read()  # æ•´ä¸ªæ–‡ä»¶åŠ è½½åˆ°å†…å­˜
        return len(data)

# å†…å­˜æ˜ å°„æ–¹å¼ï¼šæŒ‰éœ€è®¿é—®æ–‡ä»¶å†…å®¹
def mmap_read(filename):
    with open(filename, 'rb') as f:
        with mmap.mmap(f.fileno(), 0, access=mmap.ACCESS_READ) as mm:
            return len(mm)  # æ–‡ä»¶å†…å®¹æ˜ å°„åˆ°è™šæ‹Ÿå†…å­˜ï¼Œä¸å®é™…å ç”¨ç‰©ç†å†…å­˜

# å¯¹äºå¤§æ–‡ä»¶ï¼Œå†…å­˜æ˜ å°„æ˜æ˜¾æ›´é«˜æ•ˆ
```

### 7.2 åŸºç¡€å†…å­˜æ˜ å°„æ“ä½œ


**ğŸ”§ è¯»å–å¤§æ–‡ä»¶**
```python
import mmap

def process_large_file(filename):
    """é«˜æ•ˆå¤„ç†å¤§æ–‡ä»¶çš„ç¤ºä¾‹"""
    with open(filename, 'rb') as f:
        # åˆ›å»ºå†…å­˜æ˜ å°„
        with mmap.mmap(f.fileno(), 0, access=mmap.ACCESS_READ) as mm:
            # æ–‡ä»¶å¤§å°
            file_size = len(mm)
            print(f"æ–‡ä»¶å¤§å°: {file_size / 1024 / 1024:.1f} MB")
            
            # éšæœºè®¿é—®ä»»æ„ä½ç½®
            middle_pos = file_size // 2
            print(f"æ–‡ä»¶ä¸­é—´çš„å­—èŠ‚: {mm[middle_pos]}")
            
            # æœç´¢ç‰¹å®šå†…å®¹
            search_text = b"python"
            pos = mm.find(search_text)
            if pos != -1:
                print(f"æ‰¾åˆ° '{search_text.decode()}' åœ¨ä½ç½®: {pos}")
            
            # æŒ‰å—å¤„ç†å¤§æ–‡ä»¶
            chunk_size = 1024 * 1024  # 1MBå—
            for i in range(0, file_size, chunk_size):
                chunk = mm[i:i + chunk_size]
                # å¤„ç†è¿™ä¸ªå—çš„æ•°æ®
                process_chunk(chunk)

def process_chunk(chunk):
    """å¤„ç†æ–‡ä»¶å—"""
    # ä¾‹å¦‚ï¼šç»Ÿè®¡å­—èŠ‚å€¼åˆ†å¸ƒ
    byte_count = {}
    for byte in chunk:
        byte_count[byte] = byte_count.get(byte, 0) + 1
    return byte_count
```

**ğŸ“ ä¿®æ”¹å¤§æ–‡ä»¶**
```python
def modify_large_file(filename):
    """å®‰å…¨åœ°ä¿®æ”¹å¤§æ–‡ä»¶"""
    with open(filename, 'r+b') as f:  # æ³¨æ„ï¼šr+bæ¨¡å¼å…è®¸è¯»å†™
        with mmap.mmap(f.fileno(), 0) as mm:
            # æŸ¥æ‰¾è¦æ›¿æ¢çš„å†…å®¹
            old_text = b"old_value"
            new_text = b"new_value"
            
            pos = mm.find(old_text)
            while pos != -1:
                # æ›¿æ¢å†…å®¹ï¼ˆæ³¨æ„ï¼šæ–°å†…å®¹é•¿åº¦å¿…é¡»ç›¸åŒï¼‰
                if len(old_text) == len(new_text):
                    mm[pos:pos + len(old_text)] = new_text
                    print(f"åœ¨ä½ç½® {pos} æ›¿æ¢æˆåŠŸ")
                else:
                    print("æ–°æ—§æ–‡æœ¬é•¿åº¦ä¸åŒï¼Œæ— æ³•ç›´æ¥æ›¿æ¢")
                
                # ç»§ç»­æŸ¥æ‰¾ä¸‹ä¸€ä¸ª
                pos = mm.find(old_text, pos + 1)
            
            # å¼ºåˆ¶å†™å…¥ç£ç›˜
            mm.flush()
```

### 7.3 é«˜çº§å†…å­˜æ˜ å°„æŠ€æœ¯


**ğŸš€ å¤šè¿›ç¨‹å…±äº«å†…å­˜**
```python
import mmap
import os
import struct
from multiprocessing import Process

def create_shared_memory(size):
    """åˆ›å»ºå…±äº«å†…å­˜åŒºåŸŸ"""
    # åˆ›å»ºä¸´æ—¶æ–‡ä»¶ä½œä¸ºå…±äº«å†…å­˜
    temp_file = "/tmp/shared_memory"
    with open(temp_file, 'wb') as f:
        f.write(b'\x00' * size)  # å†™å…¥æŒ‡å®šå¤§å°çš„ç©ºæ•°æ®
    
    return temp_file

def worker_process(shared_file, worker_id):
    """å·¥ä½œè¿›ç¨‹ï¼šå†™å…¥æ•°æ®åˆ°å…±äº«å†…å­˜"""
    with open(shared_file, 'r+b') as f:
        with mmap.mmap(f.fileno(), 0) as mm:
            # æ¯ä¸ªè¿›ç¨‹å†™å…¥ä¸åŒçš„åŒºåŸŸ
            start_pos = worker_id * 1024
            data = f"Worker {worker_id} data".encode()
            mm[start_pos:start_pos + len(data)] = data
            mm.flush()
            print(f"è¿›ç¨‹ {worker_id} å†™å…¥å®Œæˆ")

def main_process():
    """ä¸»è¿›ç¨‹ï¼šåˆ›å»ºå…±äº«å†…å­˜å¹¶å¯åŠ¨å·¥ä½œè¿›ç¨‹"""
    shared_file = create_shared_memory(8192)  # 8KBå…±äº«å†…å­˜
    
    # å¯åŠ¨å¤šä¸ªå·¥ä½œè¿›ç¨‹
    processes = []
    for i in range(4):
        p = Process(target=worker_process, args=(shared_file, i))
        p.start()
        processes.append(p)
    
    # ç­‰å¾…æ‰€æœ‰è¿›ç¨‹å®Œæˆ
    for p in processes:
        p.join()
    
    # è¯»å–å…±äº«å†…å­˜å†…å®¹
    with open(shared_file, 'rb') as f:
        with mmap.mmap(f.fileno(), 0, access=mmap.ACCESS_READ) as mm:
            for i in range(4):
                start_pos = i * 1024
                data = mm[start_pos:start_pos + 100].rstrip(b'\x00')
                if data:
                    print(f"è¿›ç¨‹ {i} çš„æ•°æ®: {data.decode()}")
    
    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    os.unlink(shared_file)
```

**ğŸ“Š å¤§æ•°æ®åˆ†æåº”ç”¨**
```python
import mmap
import struct
import time

class BinaryDataProcessor:
    """å¤„ç†å¤§å‹äºŒè¿›åˆ¶æ•°æ®æ–‡ä»¶"""
    
    def __init__(self, filename):
        self.filename = filename
        self.f = open(filename, 'rb')
        self.mm = mmap.mmap(self.f.fileno(), 0, access=mmap.ACCESS_READ)
    
    def __enter__(self):
        return self
    
    def __exit__(self, exc_type, exc_val, exc_tb):
        self.mm.close()
        self.f.close()
    
    def count_integers(self):
        """ç»Ÿè®¡æ–‡ä»¶ä¸­32ä½æ•´æ•°çš„ä¸ªæ•°"""
        return len(self.mm) // 4
    
    def get_integer_at(self, index):
        """è·å–æŒ‡å®šç´¢å¼•çš„32ä½æ•´æ•°"""
        pos = index * 4
        if pos + 4 <= len(self.mm):
            return struct.unpack('i', self.mm[pos:pos + 4])[0]
        raise IndexError("ç´¢å¼•è¶…å‡ºèŒƒå›´")
    
    def find_max_min(self):
        """æ‰¾å‡ºæ–‡ä»¶ä¸­çš„æœ€å¤§å€¼å’Œæœ€å°å€¼"""
        if len(self.mm) < 4:
            return None, None
        
        max_val = min_val = self.get_integer_at(0)
        count = self.count_integers()
        
        # æŒ‰å—å¤„ç†ï¼Œé¿å…ä¸€æ¬¡å¤„ç†è¿‡å¤šæ•°æ®
        chunk_size = 1024 * 1024  # å¤„ç†1MBçš„æ•°æ®å—
        for i in range(0, count, chunk_size // 4):
            end = min(i + chunk_size // 4, count)
            for j in range(i, end):
                val = self.get_integer_at(j)
                max_val = max(max_val, val)
                min_val = min(min_val, val)
        
        return max_val, min_val

# ä½¿ç”¨ç¤ºä¾‹
def demo_binary_processing():
    # åˆ›å»ºæµ‹è¯•æ•°æ®æ–‡ä»¶
    test_file = "test_data.bin"
    with open(test_file, 'wb') as f:
        # å†™å…¥100ä¸‡ä¸ªéšæœºæ•´æ•°
        import random
        for _ in range(1000000):
            f.write(struct.pack('i', random.randint(-1000000, 1000000)))
    
    # ä½¿ç”¨å†…å­˜æ˜ å°„å¤„ç†
    start_time = time.time()
    with BinaryDataProcessor(test_file) as processor:
        count = processor.count_integers()
        max_val, min_val = processor.find_max_min()
        
        print(f"å¤„ç†äº† {count} ä¸ªæ•´æ•°")
        print(f"æœ€å¤§å€¼: {max_val}, æœ€å°å€¼: {min_val}")
        print(f"å¤„ç†è€—æ—¶: {time.time() - start_time:.2f} ç§’")
    
    # æ¸…ç†æµ‹è¯•æ–‡ä»¶
    os.unlink(test_file)
```

---

## 8. ğŸ“ˆ å¤§æ•°æ®å¤„ç†ä¼˜åŒ–ç­–ç•¥


### 8.1 å†…å­˜é«˜æ•ˆçš„æ•°æ®ç»“æ„é€‰æ‹©


**ğŸ”¸ é€‰æ‹©åˆé€‚çš„æ•°æ®ç»“æ„**
```python
import array
import sys
from collections import deque

# å¯¹æ¯”ä¸åŒæ•°æ®ç»“æ„çš„å†…å­˜ä½¿ç”¨
def compare_data_structures():
    # å­˜å‚¨100ä¸‡ä¸ªæ•´æ•°
    size = 1000000
    
    # 1. æ™®é€šåˆ—è¡¨
    python_list = list(range(size))
    
    # 2. arrayæ¨¡å—ï¼ˆç±»å‹åŒ–æ•°ç»„ï¼‰
    int_array = array.array('i', range(size))  # 'i'è¡¨ç¤ºintç±»å‹
    
    # 3. å­—èŠ‚æ•°ç»„
    byte_array = bytearray(size)
    
    print("å†…å­˜ä½¿ç”¨å¯¹æ¯”:")
    print(f"Pythonåˆ—è¡¨: {sys.getsizeof(python_list) / 1024 / 1024:.1f} MB")
    print(f"Arrayæ•°ç»„: {sys.getsizeof(int_array) / 1024 / 1024:.1f} MB")
    print(f"å­—èŠ‚æ•°ç»„: {sys.getsizeof(byte_array) / 1024 / 1024:.1f} MB")

# é€‰æ‹©æŒ‡å—
data_structure_guide = {
    "å¤§é‡æ•´æ•°": "ä½¿ç”¨array.array('i')",
    "å¤§é‡æµ®ç‚¹æ•°": "ä½¿ç”¨array.array('f')",
    "å¤§é‡å­—èŠ‚æ•°æ®": "ä½¿ç”¨bytearrayæˆ–bytes",
    "é˜Ÿåˆ—æ“ä½œ": "ä½¿ç”¨collections.deque",
    "å¤§é‡å¸ƒå°”å€¼": "ä½¿ç”¨bitarrayåº“",
    "ç¨€ç–æ•°æ®": "ä½¿ç”¨å­—å…¸æˆ–ä¸“é—¨çš„ç¨€ç–çŸ©é˜µåº“"
}
```

**ğŸ“Š å†…å­˜å‹å¥½çš„æ•°æ®å¤„ç†**
```python
from itertools import islice
import csv

class MemoryEfficientProcessor:
    """å†…å­˜é«˜æ•ˆçš„æ•°æ®å¤„ç†å™¨"""
    
    @staticmethod
    def process_large_csv(filename, chunk_size=10000):
        """åˆ†æ‰¹å¤„ç†å¤§å‹CSVæ–‡ä»¶"""
        with open(filename, 'r') as f:
            reader = csv.reader(f)
            header = next(reader)  # è¯»å–è¡¨å¤´
            
            while True:
                # è¯»å–ä¸€æ‰¹æ•°æ®
                chunk = list(islice(reader, chunk_size))
                if not chunk:
                    break
                
                # å¤„ç†è¿™æ‰¹æ•°æ®
                yield from MemoryEfficientProcessor.process_chunk(chunk)
    
    @staticmethod
    def process_chunk(chunk):
        """å¤„ç†æ•°æ®å—"""
        for row in chunk:
            # åªä¿ç•™éœ€è¦çš„å­—æ®µï¼Œç«‹å³å¤„ç†
            processed_data = {
                'id': int(row[0]) if row[0].isdigit() else 0,
                'value': float(row[1]) if row[1].replace('.', '').isdigit() else 0.0
            }
            yield processed_data
    
    @staticmethod
    def streaming_filter(data_iter, condition):
        """æµå¼è¿‡æ»¤ï¼Œä¸å ç”¨é¢å¤–å†…å­˜"""
        for item in data_iter:
            if condition(item):
                yield item
    
    @staticmethod
    def streaming_map(data_iter, transform):
        """æµå¼è½¬æ¢ï¼Œä¸å ç”¨é¢å¤–å†…å­˜"""
        for item in data_iter:
            yield transform(item)

# ä½¿ç”¨ç¤ºä¾‹
def demo_memory_efficient():
    # æ¨¡æ‹Ÿå¤§æ•°æ®å¤„ç†
    processor = MemoryEfficientProcessor()
    
    # å‡è®¾æœ‰ä¸€ä¸ªå¾ˆå¤§çš„CSVæ–‡ä»¶
    for data in processor.process_large_csv("large_data.csv"):
        # æµå¼è¿‡æ»¤ï¼šåªä¿ç•™å€¼å¤§äº100çš„è®°å½•
        filtered = processor.streaming_filter(
            [data], 
            lambda x: x['value'] > 100
        )
        
        # æµå¼è½¬æ¢ï¼šè®¡ç®—æŸç§æŒ‡æ ‡
        transformed = processor.streaming_map(
            filtered,
            lambda x: {'id': x['id'], 'score': x['value'] * 1.5}
        )
        
        # å¤„ç†ç»“æœï¼ˆè¿™é‡Œåªæ˜¯æ‰“å°ï¼Œå®é™…å¯èƒ½æ˜¯å†™å…¥æ•°æ®åº“ç­‰ï¼‰
        for result in transformed:
            # print(result)  # å®é™…å¤„ç†é€»è¾‘
            pass
```

### 8.2 ç”Ÿæˆå™¨ä¸è¿­ä»£å™¨ä¼˜åŒ–


**âš¡ ç”Ÿæˆå™¨çš„å†…å­˜ä¼˜åŠ¿**
```python
import sys

# ä¼ ç»Ÿæ–¹å¼ï¼šä¸€æ¬¡æ€§ç”Ÿæˆæ‰€æœ‰æ•°æ®
def traditional_range(n):
    return [i * i for i in range(n)]

# ç”Ÿæˆå™¨æ–¹å¼ï¼šæŒ‰éœ€ç”Ÿæˆæ•°æ®
def generator_range(n):
    for i in range(n):
        yield i * i

# å†…å­˜ä½¿ç”¨å¯¹æ¯”
def compare_memory():
    n = 1000000
    
    # ä¼ ç»Ÿæ–¹å¼
    traditional_data = traditional_range(n)
    print(f"åˆ—è¡¨å†…å­˜ä½¿ç”¨: {sys.getsizeof(traditional_data) / 1024 / 1024:.1f} MB")
    
    # ç”Ÿæˆå™¨æ–¹å¼
    generator_data = generator_range(n)
    print(f"ç”Ÿæˆå™¨å†…å­˜ä½¿ç”¨: {sys.getsizeof(generator_data)} bytes")

# ç”Ÿæˆå™¨çš„å®é™…åº”ç”¨
class DataPipeline:
    """æ•°æ®å¤„ç†ç®¡é“"""
    
    @staticmethod
    def read_file_lines(filename):
        """é€è¡Œè¯»å–æ–‡ä»¶"""
        with open(filename, 'r') as f:
            for line in f:
                yield line.strip()
    
    @staticmethod
    def filter_non_empty(lines):
        """è¿‡æ»¤ç©ºè¡Œ"""
        for line in lines:
            if line:
                yield line
    
    @staticmethod
    def parse_numbers(lines):
        """è§£ææ•°å­—"""
        for line in lines:
            try:
                yield float(line)
            except ValueError:
                continue
    
    @staticmethod
    def calculate_stats(numbers):
        """è®¡ç®—ç»Ÿè®¡ä¿¡æ¯"""
        count = 0
        total = 0
        min_val = float('inf')
        max_val = float('-inf')
        
        for num in numbers:
            count += 1
            total += num
            min_val = min(min_val, num)
            max_val = max(max_val, num)
            
            # æ¯å¤„ç†1000ä¸ªæ•°å­—è¾“å‡ºä¸€æ¬¡è¿›åº¦
            if count % 1000 == 0:
                print(f"å·²å¤„ç† {count} ä¸ªæ•°å­—...")
        
        if count > 0:
            return {
                'count': count,
                'average': total / count,
                'min': min_val,
                'max': max_val
            }
        return None

# ä½¿ç”¨ç®¡é“å¤„ç†å¤§æ–‡ä»¶
def process_large_number_file(filename):
    pipeline = DataPipeline()
    
    # æ„å»ºå¤„ç†ç®¡é“
    lines = pipeline.read_file_lines(filename)
    non_empty_lines = pipeline.filter_non_empty(lines)
    numbers = pipeline.parse_numbers(non_empty_lines)
    
    # è®¡ç®—ç»Ÿè®¡ä¿¡æ¯ï¼ˆå†…å­˜ä½¿ç”¨é‡å§‹ç»ˆå¾ˆå°ï¼‰
    stats = pipeline.calculate_stats(numbers)
    return stats
```

### 8.3 å¹¶è¡Œå¤„ç†ä¸å†…å­˜ç®¡ç†


**ğŸ”„ å¤šè¿›ç¨‹å†…å­˜ä¼˜åŒ–**
```python
import multiprocessing as mp
import os
from functools import partial

class ParallelProcessor:
    """å¹¶è¡Œå¤„ç†å™¨ï¼Œä¼˜åŒ–å†…å­˜ä½¿ç”¨"""
    
    @staticmethod
    def worker_init():
        """å·¥ä½œè¿›ç¨‹åˆå§‹åŒ–"""
        # è®¾ç½®å·¥ä½œè¿›ç¨‹çš„å†…å­˜é™åˆ¶ç­‰
        print(f"å·¥ä½œè¿›ç¨‹ {os.getpid()} å¯åŠ¨")
    
    @staticmethod
    def process_chunk(chunk_data, transform_func):
        """å¤„ç†æ•°æ®å—"""
        try:
            # å¤„ç†æ•°æ®
            results = []
            for item in chunk_data:
                result = transform_func(item)
                results.append(result)
            
            return results
        except Exception as e:
            print(f"å¤„ç†å‡ºé”™: {e}")
            return []
    
    @staticmethod
    def parallel_process(data, transform_func, num_processes=None):
        """å¹¶è¡Œå¤„ç†å¤§æ•°æ®é›†"""
        if num_processes is None:
            num_processes = mp.cpu_count()
        
        # å°†æ•°æ®åˆ†æˆå—
        chunk_size = max(1, len(data) // num_processes)
        chunks = [data[i:i + chunk_size] for i in range(0, len(data), chunk_size)]
        
        # åˆ›å»ºè¿›ç¨‹æ± 
        with mp.Pool(processes=num_processes, initializer=ParallelProcessor.worker_init) as pool:
            # ä½¿ç”¨partialåˆ›å»ºå¸¦å‚æ•°çš„å‡½æ•°
            worker_func = partial(ParallelProcessor.process_chunk, transform_func=transform_func)
            
            # å¹¶è¡Œå¤„ç†æ‰€æœ‰å—
            results = pool.map(worker_func, chunks)
            
            # åˆå¹¶ç»“æœ
            final_results = []
            for chunk_result in results:
                final_results.extend(chunk_result)
            
            return final_results

# å®ç”¨ç¤ºä¾‹
def heavy_computation(x):
    """æ¨¡æ‹Ÿé‡è®¡ç®—ä»»åŠ¡"""
    import time
    time.sleep(0.001)  # æ¨¡æ‹Ÿè®¡ç®—æ—¶é—´
    return x * x + 2 * x + 1

def demo_parallel_processing():
    # åˆ›å»ºå¤§æ•°æ®é›†
    data = list(range(10000))
    
    print("å¼€å§‹å¹¶è¡Œå¤„ç†...")
    
    # å¹¶è¡Œå¤„ç†
    processor = ParallelProcessor()
    results = processor.parallel_process(data, heavy_computation)
    
    print(f"å¤„ç†å®Œæˆï¼Œç»“æœæ•°é‡: {len(results)}")
    print(f"å‰10ä¸ªç»“æœ: {results[:10]}")
```

**ğŸ”§ å†…å­˜ç›‘æ§ä¸è‡ªåŠ¨æ¸…ç†**
```python
import psutil
import gc
import threading
import time

class MemoryMonitor:
    """å†…å­˜ç›‘æ§å’Œè‡ªåŠ¨æ¸…ç†"""
    
    def __init__(self, threshold_mb=1000, check_interval=5):
        self.threshold_bytes = threshold_mb * 1024 * 1024
        self.check_interval = check_interval
        self.monitoring = False
        self.monitor_thread = None
    
    def start_monitoring(self):
        """å¼€å§‹å†…å­˜ç›‘æ§"""
        if self.monitoring:
            return
        
        self.monitoring = True
        self.monitor_thread = threading.Thread(target=self._monitor_loop)
        self.monitor_thread.daemon = True
        self.monitor_thread.start()
        print("å†…å­˜ç›‘æ§å·²å¯åŠ¨")
    
    def stop_monitoring(self):
        """åœæ­¢å†…å­˜ç›‘æ§"""
        self.monitoring = False
        if self.monitor_thread:
            self.monitor_thread.join()
        print("å†…å­˜ç›‘æ§å·²åœæ­¢")
    
    def _monitor_loop(self):
        """ç›‘æ§å¾ªç¯"""
        while self.monitoring:
            current_memory = self.get_memory_usage()
            
            if current_memory > self.threshold_bytes:
                print(f"å†…å­˜ä½¿ç”¨è¶…è¿‡é˜ˆå€¼: {current_memory / 1024 / 1024:.1f} MB")
                self._cleanup_memory()
            
            time.sleep(self.check_interval)
    
    def get_memory_usage(self):
        """è·å–å½“å‰è¿›ç¨‹å†…å­˜ä½¿ç”¨é‡"""
        process = psutil.Process()
        return process.memory_info().rss
    
    def _cleanup_memory(self):
        """æ‰§è¡Œå†…å­˜æ¸…ç†"""
        print("æ‰§è¡Œå†…å­˜æ¸…ç†...")
        
        # å¼ºåˆ¶åƒåœ¾æ”¶é›†
        collected = gc.collect()
        print(f"åƒåœ¾æ”¶é›†æ¸…ç†äº† {collected} ä¸ªå¯¹è±¡")
        
        # æ£€æŸ¥æ¸…ç†æ•ˆæœ
        new_memory = self.get_memory_usage()
        print(f"æ¸…ç†åå†…å­˜ä½¿ç”¨: {new_memory / 1024 / 1024:.1f} MB")

# ä½¿ç”¨ç¤ºä¾‹
def demo_memory_monitoring():
    # å¯åŠ¨å†…å­˜ç›‘æ§
    monitor = MemoryMonitor(threshold_mb=100, check_interval=2)
    monitor.start_monitoring()
    
    try:
        # æ¨¡æ‹Ÿå†…å­˜å¯†é›†å‹æ“ä½œ
        data_list = []
        for i in range(10):
            # åˆ›å»ºå¤§é‡æ•°æ®
            chunk = [j for j in range(100000)]
            data_list.append(chunk)
            
            print(f"åˆ›å»ºæ•°æ®å— {i+1}, å½“å‰å†…å­˜: {monitor.get_memory_usage() / 1024 / 1024:.1f} MB")
            time.sleep(1)
        
        # æ¸…ç†æ•°æ®
        data_list.clear()
        
    finally:
        monitor.stop_monitoring()
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Pythonå†…å­˜æ¨¡å‹ï¼šä¸€åˆ‡çš†å¯¹è±¡ï¼Œå¼•ç”¨è®¡æ•°+åƒåœ¾æ”¶é›†
ğŸ”¸ å†…å­˜åˆ†é…æœºåˆ¶ï¼šåˆ†å±‚ç®¡ç†ï¼Œå°å¯¹è±¡æ± ä¼˜åŒ–
ğŸ”¸ åƒåœ¾æ”¶é›†åŸç†ï¼šåˆ†ä»£æ”¶é›†ï¼Œè§£å†³å¾ªç¯å¼•ç”¨é—®é¢˜
ğŸ”¸ å†…å­˜æ³„æ¼é¢„é˜²ï¼šæ­£ç¡®ç®¡ç†å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ
ğŸ”¸ __slots__ä¼˜åŒ–ï¼šå›ºå®šå±æ€§ï¼ŒèŠ‚çœå†…å­˜ç©ºé—´
ğŸ”¸ å¼±å¼•ç”¨åº”ç”¨ï¼šé¿å…å¾ªç¯å¼•ç”¨ï¼Œå®ç°æ™ºèƒ½ç¼“å­˜
ğŸ”¸ å†…å­˜æ˜ å°„æŠ€æœ¯ï¼šé«˜æ•ˆå¤„ç†å¤§æ–‡ä»¶
ğŸ”¸ å¤§æ•°æ®ä¼˜åŒ–ï¼šç”Ÿæˆå™¨ã€å¹¶è¡Œå¤„ç†ã€å†…å­˜ç›‘æ§
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å†…å­˜ä¼˜åŒ–çš„æƒè¡¡è€ƒè™‘**
```
æ€§èƒ½ vs å†…å­˜ï¼š
â€¢ __slots__ï¼šèŠ‚çœå†…å­˜ä½†å¤±å»çµæ´»æ€§
â€¢ ç”Ÿæˆå™¨ï¼šèŠ‚çœå†…å­˜ä½†åªèƒ½éå†ä¸€æ¬¡
â€¢ å†…å­˜æ˜ å°„ï¼šé«˜æ•ˆè®¿é—®ä½†éœ€è¦æ–‡ä»¶æ”¯æŒ

å¤æ‚åº¦ vs æ”¶ç›Šï¼š
â€¢ ç®€å•åœºæ™¯ï¼šåŸºç¡€ä¼˜åŒ–å°±å¤Ÿç”¨
â€¢ å¤æ‚åœºæ™¯ï¼šéœ€è¦ç»¼åˆå¤šç§æŠ€æœ¯
â€¢ è¿‡åº¦ä¼˜åŒ–ï¼šå¯èƒ½é€‚å¾—å…¶å
```

**ğŸ”¹ ä¼˜åŒ–ç­–ç•¥çš„é€‰æ‹©åŸåˆ™**
```
æ•°æ®é‡åˆ¤æ–­ï¼š
å°æ•°æ®ï¼ˆ<1MBï¼‰ï¼šåŸºç¡€ä¼˜åŒ–å³å¯
ä¸­ç­‰æ•°æ®ï¼ˆ1MB-1GBï¼‰ï¼šè€ƒè™‘ç”Ÿæˆå™¨ã€__slots__
å¤§æ•°æ®ï¼ˆ>1GBï¼‰ï¼šå¿…é¡»ä½¿ç”¨å†…å­˜æ˜ å°„ã€å¹¶è¡Œå¤„ç†

åº”ç”¨åœºæ™¯è€ƒè™‘ï¼š
æ•°æ®å­˜å‚¨ï¼šä¼˜å…ˆè€ƒè™‘__slots__
æ–‡ä»¶å¤„ç†ï¼šä¼˜å…ˆè€ƒè™‘å†…å­˜æ˜ å°„
æµå¼å¤„ç†ï¼šä¼˜å…ˆè€ƒè™‘ç”Ÿæˆå™¨
å¤æ‚å…³ç³»ï¼šè€ƒè™‘å¼±å¼•ç”¨
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ ä¼˜åŒ–æ£€æŸ¥æ¸…å•**
```
å†…å­˜ä½¿ç”¨æ£€æŸ¥ï¼š
âœ… æ˜¯å¦æœ‰å¤§å¯¹è±¡é•¿æœŸå ç”¨å†…å­˜ï¼Ÿ
âœ… æ˜¯å¦å­˜åœ¨å¾ªç¯å¼•ç”¨é—®é¢˜ï¼Ÿ
âœ… æ˜¯å¦å¯ä»¥ä½¿ç”¨ç”Ÿæˆå™¨æ›¿ä»£åˆ—è¡¨ï¼Ÿ
âœ… æ˜¯å¦éœ€è¦__slots__ä¼˜åŒ–ï¼Ÿ

æ€§èƒ½ç›‘æ§ï¼š
âœ… å®šæœŸæ£€æŸ¥å†…å­˜ä½¿ç”¨æƒ…å†µ
âœ… ç›‘æ§åƒåœ¾æ”¶é›†é¢‘ç‡
âœ… è¯†åˆ«å†…å­˜æ³„æ¼é£é™©ç‚¹
âœ… æµ‹è¯•æé™æ•°æ®é‡ä¸‹çš„è¡¨ç°
```

**ğŸ’¡ æœ€ä½³å®è·µæ€»ç»“**
```
è®¾è®¡é˜¶æ®µï¼š
â€¢ é¢„ä¼°æ•°æ®è§„æ¨¡ï¼Œé€‰æ‹©åˆé€‚çš„æ•°æ®ç»“æ„
â€¢ è€ƒè™‘å¯¹è±¡ç”Ÿå‘½å‘¨æœŸï¼Œè®¾è®¡æ¸…ç†ç­–ç•¥
â€¢ è¯„ä¼°æ˜¯å¦éœ€è¦å¹¶è¡Œå¤„ç†

å¼€å‘é˜¶æ®µï¼š
â€¢ ä½¿ç”¨é€‚å½“çš„å†…å­˜ä¼˜åŒ–æŠ€æœ¯
â€¢ ç¼–å†™å†…å­˜ä½¿ç”¨æµ‹è¯•ç”¨ä¾‹
â€¢ å®ç°å†…å­˜ç›‘æ§æœºåˆ¶

éƒ¨ç½²é˜¶æ®µï¼š
â€¢ ç›‘æ§ç”Ÿäº§ç¯å¢ƒå†…å­˜ä½¿ç”¨
â€¢ è®¾ç½®åˆç†çš„å†…å­˜é˜ˆå€¼
â€¢ å‡†å¤‡å†…å­˜é—®é¢˜åº”æ€¥æ–¹æ¡ˆ
```

### 9.4 å¸¸è§é—®é¢˜è§£å†³


**ğŸ”§ å†…å­˜é—®é¢˜è¯Šæ–­**
```python
# å¿«é€Ÿè¯Šæ–­å·¥å…·
import tracemalloc
import gc

def diagnose_memory():
    """å†…å­˜é—®é¢˜å¿«é€Ÿè¯Šæ–­"""
    # 1. æ£€æŸ¥åƒåœ¾æ”¶é›†çŠ¶æ€
    print("åƒåœ¾æ”¶é›†ç»Ÿè®¡:", gc.get_count())
    print("åƒåœ¾æ”¶é›†é˜ˆå€¼:", gc.get_threshold())
    
    # 2. å¼ºåˆ¶åƒåœ¾æ”¶é›†
    collected = gc.collect()
    print(f"æ¸…ç†äº† {collected} ä¸ªå¯¹è±¡")
    
    # 3. æ£€æŸ¥å†…å­˜è¿½è¸ª
    if tracemalloc.is_tracing():
        snapshot = tracemalloc.take_snapshot()
        top_stats = snapshot.statistics('lineno')
        print("å†…å­˜ä½¿ç”¨æœ€å¤šçš„3è¡Œä»£ç :")
        for stat in top_stats[:3]:
            print(f"  {stat}")

# åœ¨ç¨‹åºä¸­å®šæœŸè°ƒç”¨è¯Šæ–­å‡½æ•°
```

**âš ï¸ é¿å…å¸¸è§é™·é˜±**
```
å¸¸è§å†…å­˜é™·é˜±ï¼š
âŒ å…¨å±€å˜é‡æ— é™å¢é•¿
âŒ é—­åŒ…æ•è·å¤§å¯¹è±¡
âŒ å¾ªç¯å¼•ç”¨æœªå¤„ç†
âŒ æ–‡ä»¶å¥æŸ„æœªå…³é—­
âŒ çº¿ç¨‹å¯¹è±¡æœªæ­£ç¡®æ¸…ç†

é¢„é˜²æªæ–½ï¼š
âœ… ä½¿ç”¨withè¯­å¥ç®¡ç†èµ„æº
âœ… åŠæ—¶æ¸…ç†ä¸éœ€è¦çš„å¼•ç”¨
âœ… ä½¿ç”¨å¼±å¼•ç”¨é¿å…å¾ªç¯
âœ… å®šæœŸè¿›è¡Œå†…å­˜æ£€æŸ¥
âœ… ç¼–å†™å†…å­˜ä½¿ç”¨æµ‹è¯•
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- å¯¹è±¡å¼•ç”¨è¦æ¸…æ™°ï¼Œå¾ªç¯å¼•ç”¨ç”¨å¼±å¼•ç”¨
- å¤§æ•°æ®å¤„ç†ç”¨ç”Ÿæˆå™¨ï¼Œæ–‡ä»¶å¤„ç†ç”¨æ˜ å°„
- å›ºå®šå±æ€§ç”¨__slots__ï¼Œå†…å­˜ç›‘æ§ä¸å¯å°‘
- ä¼˜åŒ–é€‚åº¦è«è¿‡åº¦ï¼Œæ€§èƒ½å†…å­˜è¦å¹³è¡¡