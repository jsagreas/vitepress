---
title: 4、doctest文档测试
---
## 📚 目录

1. [doctest模块基础概念](#1-doctest模块基础概念)
2. [文档字符串测试详解](#2-文档字符串测试详解)
3. [doctest语法规则与技巧](#3-doctest语法规则与技巧)
4. [测试输出验证机制](#4-测试输出验证机制)
5. [doctest执行方式大全](#5-doctest执行方式大全)
6. [文档测试组织策略](#6-文档测试组织策略)
7. [doctest限制与注意事项](#7-doctest限制与注意事项)
8. [文档测试最佳实践](#8-文档测试最佳实践)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🎯 doctest模块基础概念


### 1.1 什么是doctest


**🔸 简单理解**：doctest就像在说明书里写例子，然后让Python自动检查这些例子是否正确

```python
def add(a, b):
    """
    把两个数字加起来
    
    >>> add(2, 3)
    5
    >>> add(-1, 1)
    0
    """
    return a + b
```

**核心概念**：
- 📝 **文档测试**：把测试用例写在函数的说明文档里
- 🔍 **自动验证**：Python会自动运行这些例子并检查结果
- 📖 **一举两得**：既是文档说明，又是测试用例

### 1.2 为什么需要doctest


**🌰 生活类比**：就像买电器时看说明书上的使用示例，doctest让你的代码也有"使用示例"

**实际好处**：
```
✅ 文档永远是最新的  - 代码改了，测试会自动提醒你更新文档
✅ 学习成本很低      - 不需要专门学测试框架
✅ 使用示例清晰      - 别人看代码时知道怎么用
✅ 发现问题及时      - 代码出错时马上知道
```

**🔸 适用场景**：
- 🔰 **新手学习**：理解函数如何使用
- 📚 **文档说明**：展示函数的典型用法
- 🧪 **简单测试**：验证基本功能是否正常

---

## 2. 📝 文档字符串测试详解


### 2.1 基础文档测试格式


**🔸 标准格式**：在三引号文档字符串中写测试

```python
def multiply(x, y):
    """
    计算两个数的乘积
    
    >>> multiply(3, 4)
    12
    >>> multiply(0, 100)
    0
    >>> multiply(-2, 5)
    -10
    """
    return x * y
```

**格式要点**：
- `>>>` 表示Python交互式命令行
- 下一行直接写期望的输出结果
- 不要有多余的空格或缩进

### 2.2 多种数据类型测试


**🔸 字符串测试**：
```python
def greet(name):
    """
    生成问候语
    
    >>> greet("小明")
    '你好，小明！'
    >>> greet("")
    '你好，！'
    """
    return f"你好，{name}！"
```

**🔸 列表测试**：
```python
def get_even_numbers(numbers):
    """
    获取列表中的偶数
    
    >>> get_even_numbers([1, 2, 3, 4, 5, 6])
    [2, 4, 6]
    >>> get_even_numbers([1, 3, 5])
    []
    >>> get_even_numbers([])
    []
    """
    return [n for n in numbers if n % 2 == 0]
```

**🔸 字典测试**：
```python
def count_words(text):
    """
    统计单词出现次数
    
    >>> count_words("hello world hello")
    {'hello': 2, 'world': 1}
    >>> count_words("")
    {}
    """
    if not text:
        return {}
    words = text.split()
    return {word: words.count(word) for word in set(words)}
```

### 2.3 异常处理测试


**🔸 测试异常情况**：
```python
def divide(a, b):
    """
    计算除法
    
    >>> divide(10, 2)
    5.0
    >>> divide(10, 0)
    Traceback (most recent call last):
        ...
    ZeroDivisionError: division by zero
    """
    return a / b
```

**异常测试要点**：
- 用 `Traceback (most recent call last):` 开头
- 用 `...` 省略中间的堆栈信息
- 最后一行写具体的异常类型和消息

---

## 3. 🔧 doctest语法规则与技巧


### 3.1 基本语法规则


**🔸 命令行提示符规则**：

| 提示符 | **含义** | **使用场景** |
|--------|---------|-------------|
| `>>>` | `主提示符` | `新的语句开始` |
| `...` | `续行提示符` | `语句继续或代码块内部` |

```python
def create_list():
    """
    创建一个列表
    
    >>> numbers = [1, 2, 3]
    >>> for i in numbers:
    ...     print(i * 2)
    2
    4
    6
    """
    pass
```

### 3.2 输出格式处理


**🔸 处理空白字符**：
```python
def format_text():
    """
    格式化文本输出
    
    >>> print("hello\\nworld")
    hello
    world
    >>> print("前面有空格:   后面也有   ")
    前面有空格:   后面也有   
    """
    pass
```

**🔸 处理浮点数精度**：
```python
def calculate_average(numbers):
    """
    计算平均值
    
    >>> calculate_average([1, 2, 3])
    2.0
    >>> round(calculate_average([1, 2, 4]), 2)
    2.33
    """
    return sum(numbers) / len(numbers)
```

### 3.3 特殊标记和选项


**🔸 忽略输出的部分内容**：
```python
def get_current_time():
    """
    获取当前时间
    
    >>> import datetime
    >>> now = datetime.datetime.now()
    >>> print(f"当前时间: {now}")  # doctest: +SKIP
    当前时间: ...
    """
    pass
```

**常用选项标记**：
- `# doctest: +SKIP` - 跳过这个测试
- `# doctest: +ELLIPSIS` - 允许使用...省略部分输出
- `# doctest: +NORMALIZE_WHITESPACE` - 忽略空白字符差异

---

## 4. ✅ 测试输出验证机制


### 4.1 精确匹配原则


**🔸 doctest的严格性**：
```python
def demo_strict_matching():
    """
    演示精确匹配
    
    这样是正确的：
    >>> print("Hello")
    Hello
    
    这样会失败（多了空格）：
    >>> print("Hello")
    Hello 
    
    这样也会失败（大小写不同）：
    >>> print("Hello")
    hello
    """
    pass
```

### 4.2 输出验证流程


**🔸 验证步骤图解**：
```
代码执行 ──▶ 获取实际输出 ──▶ 与期望输出比较 ──▶ 报告结果
    │              │                │              │
    ▼              ▼                ▼              ▼
运行>>> 后的代码   捕获print等输出   逐字符对比      通过/失败
```

**🔸 比较机制**：
```python
def explain_comparison():
    """
    说明比较机制
    
    >>> result = [1, 2, 3]
    >>> result
    [1, 2, 3]
    
    >>> print(result)
    [1, 2, 3]
    
    >>> len(result)
    3
    """
    pass
```

### 4.3 处理复杂输出


**🔸 多行输出处理**：
```python
def multi_line_output():
    """
    处理多行输出
    
    >>> data = {"name": "张三", "age": 25}
    >>> for key, value in data.items():
    ...     print(f"{key}: {value}")
    name: 张三
    age: 25
    """
    pass
```

**🔸 使用省略号**：
```python
def ellipsis_example():
    """
    使用省略号处理变化的输出
    
    >>> import os
    >>> os.getcwd()  # doctest: +ELLIPSIS
    '/.../...'
    """
    pass
```

---

## 5. 🚀 doctest执行方式大全


### 5.1 直接运行模块


**🔸 在文件末尾添加**：
```python
# math_utils.py

def square(x):
    """
    计算平方
    >>> square(4)
    16
    >>> square(-3)
    9
    """
    return x * x

if __name__ == "__main__":
    import doctest
    doctest.testmod()
```

**运行方式**：
```bash
python math_utils.py
```

### 5.2 命令行运行


**🔸 使用-m doctest参数**：
```bash
# 运行指定文件的所有doctest

python -m doctest math_utils.py

# 显示详细信息

python -m doctest -v math_utils.py

# 测试文本文件中的doctest

python -m doctest example.txt
```

### 5.3 交互式测试


**🔸 在Python解释器中**：
```python
>>> import doctest
>>> import math_utils
>>> doctest.testmod(math_utils)
TestResults(failed=0, attempted=2)

>>> doctest.testmod(math_utils, verbose=True)
Trying:
    square(4)
Expecting:
    16
ok
Trying:
    square(-3)
Expecting:
    9
ok
```

### 5.4 程序化执行


**🔸 在程序中调用**：
```python
import doctest

def run_tests():
    """运行所有doctest"""
#    # 测试当前模块
    result = doctest.testmod()
    print(f"测试完成：失败 {result.failed} 个，总共 {result.attempted} 个")
    
#    # 测试指定文件
    doctest.testfile("example.txt", verbose=True)

if __name__ == "__main__":
    run_tests()
```

---

## 6. 📂 文档测试组织策略


### 6.1 函数级别组织


**🔸 每个函数的测试策略**：
```python
def calculate_tax(income, rate):
    """
    计算税额
    
    基本功能测试：
    >>> calculate_tax(1000, 0.1)
    100.0
    
    边界值测试：
    >>> calculate_tax(0, 0.1)
    0.0
    >>> calculate_tax(1000, 0)
    0.0
    
    异常情况测试：
    >>> calculate_tax(-100, 0.1)
    Traceback (most recent call last):
        ...
    ValueError: 收入不能为负数
    """
    if income < 0:
        raise ValueError("收入不能为负数")
    return income * rate
```

### 6.2 模块级别组织


**🔸 模块文档测试**：
```python
"""
数学工具模块

这个模块提供基本的数学计算功能

基本使用示例：
>>> from math_utils import square, cube
>>> square(3)
9
>>> cube(2)
8

组合使用：
>>> numbers = [1, 2, 3, 4]
>>> [square(n) for n in numbers]
[1, 4, 9, 16]
"""

def square(x):
    """计算平方"""
    return x * x

def cube(x):
    """计算立方"""
    return x * x * x
```

### 6.3 外部文件组织


**🔸 创建专门的测试文件**：

`example_tests.txt`:
```
数学工具测试文件
================

导入模块：
>>> import math_utils

测试平方函数：
>>> math_utils.square(5)
25

测试立方函数：
>>> math_utils.cube(3)
27

测试错误情况：
>>> math_utils.square("hello")
Traceback (most recent call last):
    ...
TypeError: unsupported operand type(s) for *: 'str' and 'str'
```

**运行外部文件测试**：
```python
import doctest
doctest.testfile("example_tests.txt")
```

---

## 7. ⚠️ doctest限制与注意事项


### 7.1 主要限制


**🔸 doctest不适合的场景**：

| 限制类型 | **具体表现** | **解决方案** |
|---------|-------------|------------|
| 🔴 **复杂测试** | `不适合复杂的测试逻辑` | `使用unittest或pytest` |
| 🔴 **大量数据** | `文档会变得很长很乱` | `外部测试文件` |
| 🔴 **随机输出** | `每次结果不同无法预测` | `使用mock或固定种子` |
| 🔴 **性能测试** | `无法测试执行时间` | `专门的性能测试工具` |

### 7.2 常见问题及解决


**🔸 空白字符问题**：
```python
def problematic_whitespace():
    """
    空白字符问题演示
    
    容易出错的写法：
    >>> print("hello world")
    hello world   # 后面有看不见的空格会导致测试失败
    
    正确的写法：
    >>> print("hello world")
    hello world
    
    使用选项忽略空白：
    >>> print("hello   world")  # doctest: +NORMALIZE_WHITESPACE
    hello world
    """
    pass
```

**🔸 平台相关问题**：
```python
def platform_issues():
    """
    平台相关问题
    
    路径分隔符问题：
    >>> import os
    >>> os.path.join("folder", "file.txt")  # doctest: +ELLIPSIS
    'folder.../file.txt'
    
    浮点数精度问题：
    >>> 1/3  # doctest: +ELLIPSIS
    0.333...
    """
    pass
```

### 7.3 调试技巧


**🔸 显示详细输出**：
```python
# 运行时显示所有测试过程

python -m doctest -v mymodule.py
```

**🔸 失败时的处理**：
```python
import doctest

def debug_failed_tests():
    """调试失败的测试"""
    try:
        doctest.testmod(verbose=True)
    except doctest.DocTestFailure as e:
        print(f"测试失败：{e}")
        print(f"期望输出：{e.expected}")
        print(f"实际输出：{e.got}")
```

---

## 8. 🎯 文档测试最佳实践


### 8.1 编写高质量测试


**🔸 测试覆盖原则**：

⏱️ **预计学习时间**: 20分钟  
🎯 **学习目标**: 掌握doctest最佳实践，写出高质量的文档测试

```python
def bank_account_withdraw(balance, amount):
    """
    银行账户取款
    
    🔸 正常情况测试：
    >>> bank_account_withdraw(1000, 200)
    800
    
    🔸 边界值测试：
    >>> bank_account_withdraw(100, 100)
    0
    
    🔸 异常情况测试：
    >>> bank_account_withdraw(100, 200)
    Traceback (most recent call last):
        ...
    ValueError: 余额不足
    
    🔸 输入验证测试：
    >>> bank_account_withdraw(-100, 50)
    Traceback (most recent call last):
        ...
    ValueError: 余额不能为负数
    """
    if balance < 0:
        raise ValueError("余额不能为负数")
    if amount > balance:
        raise ValueError("余额不足")
    return balance - amount
```

### 8.2 文档与测试平衡


**🔸 好的文档测试示例**：
```python
def format_phone(phone):
    """
    格式化电话号码
    
    将11位手机号码格式化为 xxx-xxxx-xxxx 格式
    
    参数:
        phone (str): 11位手机号码字符串
        
    返回:
        str: 格式化后的电话号码
        
    示例:
    >>> format_phone("13812345678")
    '138-1234-5678'
    >>> format_phone("18900001111")
    '189-0000-1111'
    
    错误输入处理:
    >>> format_phone("123")
    Traceback (most recent call last):
        ...
    ValueError: 电话号码必须是11位数字
    """
    if len(phone) != 11 or not phone.isdigit():
        raise ValueError("电话号码必须是11位数字")
    return f"{phone[:3]}-{phone[3:7]}-{phone[7:]}"
```

### 8.3 团队协作规范


**🔸 代码审查清单**：

```markdown
📋 **doctest质量检查**
- [ ] 每个公共函数都有文档测试
- [ ] 测试覆盖了正常情况、边界情况、异常情况  
- [ ] 测试示例简洁明了，不冗余
- [ ] 文档说明清楚函数的用途和用法
- [ ] 没有平台相关的硬编码内容
```

**🔸 维护建议**：
```python
def maintenance_example():
    """
    维护性良好的文档测试示例
    
    ✅ 好的做法：
    >>> result = calculate_discount(100, 0.1)
    >>> result
    90.0
    
    ❌ 避免的做法：
    >>> calculate_discount(123.456789, 0.123456789)  # 太复杂的数字
    >>> some_complex_calculation()  # 依赖外部状态
    """
    pass
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的核心概念


```
🔸 doctest本质：把测试写在文档字符串里的轻量级测试方法
🔸 基本语法：>>> 表示输入，下一行是期望输出
🔸 执行方式：python -m doctest 或 doctest.testmod()
🔸 适用场景：简单函数测试、使用示例、文档验证
🔸 主要限制：不适合复杂测试、大量数据、随机输出
```

### 9.2 关键理解要点


**🔹 doctest的双重作用**
```
📚 文档功能：
- 展示函数如何使用
- 提供具体的使用示例
- 帮助理解函数行为

🧪 测试功能：
- 验证代码是否正确工作
- 发现代码修改后的问题
- 确保文档与代码同步
```

**🔹 何时使用doctest**
```
✅ 适合使用：
- 简单的函数测试
- 提供使用示例
- 验证基本功能
- 教学和学习

❌ 不适合使用：
- 复杂的业务逻辑测试
- 需要大量测试数据
- 性能测试
- 集成测试
```

### 9.3 实际应用价值


**🎯 对新手的价值**：
- **学习工具**：通过示例理解函数用法
- **调试助手**：快速验证函数是否工作正常
- **文档习惯**：养成写文档的好习惯
- **测试入门**：了解测试的基本概念

**🔧 在实际项目中的应用**：
```python
# 实用的doctest模板

def utility_function(param1, param2):
    """
    函数简短描述
    
    详细说明函数的作用和用法...
    
    Args:
        param1: 参数1的说明
        param2: 参数2的说明
    
    Returns:
        返回值的说明
        
    Examples:
        >>> utility_function("test", 123)
        'expected_result'
        >>> utility_function("", 0)
        'edge_case_result'
    
    Raises:
        ValueError: 参数错误时抛出
    """
#    # 函数实现
    pass
```

### 9.4 学习路径建议


**🗺️ 推荐学习顺序**：
```
基础语法 → 简单示例 → 异常测试 → 执行方式 → 组织策略 → 最佳实践
   ↓          ↓          ↓          ↓          ↓          ↓
了解概念   动手练习   处理错误   灵活运行   项目应用   专业开发
```

**💪 实战练习建议**：
1. **入门练习**：为简单的数学函数添加doctest
2. **进阶练习**：测试字符串处理函数，包含异常情况
3. **综合练习**：为一个小项目的所有函数添加文档测试
4. **团队练习**：制定团队的doctest编写规范

---

**🧠 记忆口诀**：
- doctest文档测试两不误，三个引号把例子写
- 大于小于箭头作提示，下行直接写结果
- 简单测试它最棒，复杂逻辑另寻路
- 代码文档同步好，维护起来不发愁

**🎯 核心记忆**：
- doctest = 文档 + 测试，一石二鸟的好工具
- >>> 输入，下一行输出，格式严格要记牢
- 适合简单不适合复杂，定位清楚很重要
- 新手学习好帮手，进阶还需其他招