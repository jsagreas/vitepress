---
title: 3ã€çº¿ç¨‹é€šä¿¡ä¸åè°ƒ
---
## ğŸ“š ç›®å½•

1. [çº¿ç¨‹é€šä¿¡åŸºç¡€æ¦‚å¿µ](#1-çº¿ç¨‹é€šä¿¡åŸºç¡€æ¦‚å¿µ)
2. [Queueé˜Ÿåˆ—é€šä¿¡](#2-Queueé˜Ÿåˆ—é€šä¿¡)
3. [Eventäº‹ä»¶å¯¹è±¡](#3-Eventäº‹ä»¶å¯¹è±¡)
4. [Barrierå±éšœåŒæ­¥](#4-Barrierå±éšœåŒæ­¥)
5. [çº¿ç¨‹å±€éƒ¨å­˜å‚¨](#5-çº¿ç¨‹å±€éƒ¨å­˜å‚¨)
6. [çº¿ç¨‹æ± ThreadPoolExecutor](#6-çº¿ç¨‹æ± ThreadPoolExecutor)
7. [çº¿ç¨‹å¼‚å¸¸å¤„ç†](#7-çº¿ç¨‹å¼‚å¸¸å¤„ç†)
8. [çº¿ç¨‹è°ƒè¯•æŠ€å·§](#8-çº¿ç¨‹è°ƒè¯•æŠ€å·§)
9. [çº¿ç¨‹æœ€ä½³å®è·µ](#9-çº¿ç¨‹æœ€ä½³å®è·µ)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¤ çº¿ç¨‹é€šä¿¡åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯çº¿ç¨‹é€šä¿¡


**ç®€å•ç†è§£**ï¼šçº¿ç¨‹é€šä¿¡å°±åƒä¸åŒçš„å·¥äººä¹‹é—´è¦äº’ç›¸ä¼ é€’ä¿¡æ¯å’Œåè°ƒå·¥ä½œ

```
ç°å®ç”Ÿæ´»ä¸­çš„ä¾‹å­ï¼š
å¨æˆ¿åšèœ â†’ æœåŠ¡å‘˜ä¸Šèœ â†’ æ”¶é“¶å‘˜ç»“è´¦

æ¯ä¸ªæ­¥éª¤éƒ½éœ€è¦ç­‰å‰ä¸€æ­¥å®Œæˆï¼Œè¿˜è¦ä¼ é€’ä¿¡æ¯ï¼š
- "èœåšå¥½äº†ï¼" (å¨å¸ˆâ†’æœåŠ¡å‘˜)
- "å®¢äººä»˜æ¬¾äº†ï¼" (æ”¶é“¶å‘˜â†’å¨å¸ˆ)
```

**æ ¸å¿ƒé—®é¢˜**ï¼š
- **æ•°æ®å…±äº«**ï¼šå¤šä¸ªçº¿ç¨‹æ€ä¹ˆå®‰å…¨åœ°å…±äº«æ•°æ®ï¼Ÿ
- **é¡ºåºåè°ƒ**ï¼šæ€ä¹ˆè®©çº¿ç¨‹æŒ‰ç…§æ­£ç¡®çš„é¡ºåºæ‰§è¡Œï¼Ÿ
- **çŠ¶æ€é€šçŸ¥**ï¼šä¸€ä¸ªçº¿ç¨‹æ€ä¹ˆå‘Šè¯‰å¦ä¸€ä¸ªçº¿ç¨‹"æˆ‘å®Œæˆäº†"ï¼Ÿ

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦çº¿ç¨‹é€šä¿¡


**æ²¡æœ‰é€šä¿¡çš„é—®é¢˜**ï¼š
```
æƒ³è±¡ä¸€ä¸ªé¤å…ï¼Œå¨å¸ˆå’ŒæœåŠ¡å‘˜å„å¹²å„çš„ï¼š
âŒ å¨å¸ˆåšå®Œèœä¸å‘Šè¯‰æœåŠ¡å‘˜ â†’ èœå‡‰äº†
âŒ æœåŠ¡å‘˜ä¸çŸ¥é“å“ªæ¡Œçš„èœ â†’ ä¸Šé”™èœ
âŒ ä¸¤ä¸ªæœåŠ¡å‘˜åŒæ—¶æ‹¿åŒä¸€ç›˜èœ â†’ å†²çª
```

**æœ‰äº†é€šä¿¡çš„å¥½å¤„**ï¼š
```
âœ… ä¿¡æ¯ä¼ é€’ï¼šçº¿ç¨‹ä¹‹é—´å¯ä»¥ä¼ é€’æ•°æ®
âœ… çŠ¶æ€åŒæ­¥ï¼šçº¿ç¨‹å¯ä»¥ç­‰å¾…å…¶ä»–çº¿ç¨‹å®Œæˆ
âœ… èµ„æºåè°ƒï¼šé¿å…å¤šä¸ªçº¿ç¨‹æŠ¢åŒä¸€ä¸ªèµ„æº
âœ… é”™è¯¯å¤„ç†ï¼šä¸€ä¸ªçº¿ç¨‹å‡ºé”™å¯ä»¥é€šçŸ¥å…¶ä»–çº¿ç¨‹
```

---

## 2. ğŸ“® Queueé˜Ÿåˆ—é€šä¿¡


### 2.1 Queueæ˜¯ä»€ä¹ˆ


**ç®€å•ç†è§£**ï¼šQueueå°±åƒä¸€ä¸ªä¼ é€å¸¦ï¼Œä¸€è¾¹æ”¾ä¸œè¥¿ï¼Œå¦ä¸€è¾¹æ‹¿ä¸œè¥¿

```
ç”Ÿæ´»ä¸­çš„é˜Ÿåˆ—ï¼š
è¶…å¸‚æ’é˜Ÿ â†’ å…ˆæ¥å…ˆæœåŠ¡
é‚®ä»¶æŠ•é€’ â†’ å…ˆæŠ•é€’çš„å…ˆå¤„ç†
å·¥å‚æµæ°´çº¿ â†’ ä¸Šä¸€é“å·¥åºå®Œæˆï¼Œä¸‹ä¸€é“å·¥åºå¼€å§‹å¤„ç†
```

**Queueçš„ç‰¹ç‚¹**ï¼š
- **å…ˆè¿›å…ˆå‡º**ï¼šæœ€å…ˆæ”¾è¿›å»çš„æœ€å…ˆæ‹¿å‡ºæ¥
- **çº¿ç¨‹å®‰å…¨**ï¼šå¤šä¸ªçº¿ç¨‹åŒæ—¶æ“ä½œä¸ä¼šå‡ºé—®é¢˜
- **é˜»å¡æ“ä½œ**ï¼šé˜Ÿåˆ—ç©ºäº†ä¼šç­‰å¾…ï¼Œæ»¡äº†ä¹Ÿä¼šç­‰å¾…

### 2.2 åŸºæœ¬ç”¨æ³•


```python
import queue
import threading
import time

# åˆ›å»ºä¸€ä¸ªé˜Ÿåˆ—ï¼ˆæœ€å¤šå­˜æ”¾3ä¸ªç‰©å“ï¼‰
q = queue.Queue(maxsize=3)

def producer(name):
    """ç”Ÿäº§è€…ï¼šå¾€é˜Ÿåˆ—é‡Œæ”¾ä¸œè¥¿"""
    for i in range(5):
        item = f"{name}-å•†å“{i}"
        q.put(item)  # æ”¾å…¥é˜Ÿåˆ—
        print(f"ğŸ“¦ {name} ç”Ÿäº§äº†: {item}")
        time.sleep(1)

def consumer(name):
    """æ¶ˆè´¹è€…ï¼šä»é˜Ÿåˆ—é‡Œæ‹¿ä¸œè¥¿"""
    while True:
        try:
            item = q.get(timeout=3)  # ä»é˜Ÿåˆ—å–å‡ºï¼Œæœ€å¤šç­‰3ç§’
            print(f"ğŸ›’ {name} æ¶ˆè´¹äº†: {item}")
            q.task_done()  # å‘Šè¯‰é˜Ÿåˆ—"æˆ‘å¤„ç†å®Œäº†"
            time.sleep(0.5)
        except queue.Empty:
            print(f"{name} ç­‰å¤ªä¹…äº†ï¼Œä¸ç­‰äº†")
            break

# å¯åŠ¨çº¿ç¨‹
producer_thread = threading.Thread(target=producer, args=("å·¥å‚A",))
consumer_thread = threading.Thread(target=consumer, args=("é¡¾å®¢B",))

producer_thread.start()
consumer_thread.start()

producer_thread.join()
consumer_thread.join()
```

### 2.3 Queueçš„ä¸åŒç±»å‹


| Queueç±»å‹ | **ç‰¹ç‚¹** | **ä½¿ç”¨åœºæ™¯** | **æ’åºæ–¹å¼** |
|----------|---------|-------------|-------------|
| `Queue` | **å…ˆè¿›å…ˆå‡º** | `æ™®é€šä»»åŠ¡å¤„ç†` | `æŒ‰æ”¾å…¥é¡ºåº` |
| `LifoQueue` | **åè¿›å…ˆå‡ºï¼ˆæ ˆï¼‰** | `æ’¤é”€æ“ä½œã€æ·±åº¦ä¼˜å…ˆ` | `æœ€åæ”¾å…¥çš„å…ˆå‡ºæ¥` |
| `PriorityQueue` | **æŒ‰ä¼˜å…ˆçº§æ’åº** | `ä»»åŠ¡æœ‰é‡è¦ç¨‹åº¦` | `æŒ‰ä¼˜å…ˆçº§æ•°å­—æ’åº` |

**ä¼˜å…ˆçº§é˜Ÿåˆ—ç¤ºä¾‹**ï¼š
```python
import queue

# åˆ›å»ºä¼˜å…ˆçº§é˜Ÿåˆ—
pq = queue.PriorityQueue()

# æ”¾å…¥ä»»åŠ¡ï¼ˆæ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼‰
pq.put((1, "ç´§æ€¥ä»»åŠ¡"))     # æœ€é«˜ä¼˜å…ˆçº§
pq.put((3, "æ™®é€šä»»åŠ¡"))     # æœ€ä½ä¼˜å…ˆçº§  
pq.put((2, "é‡è¦ä»»åŠ¡"))     # ä¸­ç­‰ä¼˜å…ˆçº§

# æŒ‰ä¼˜å…ˆçº§å–å‡º
while not pq.empty():
    priority, task = pq.get()
    print(f"å¤„ç†: {task} (ä¼˜å…ˆçº§: {priority})")

# è¾“å‡ºï¼š
# å¤„ç†: ç´§æ€¥ä»»åŠ¡ (ä¼˜å…ˆçº§: 1)
# å¤„ç†: é‡è¦ä»»åŠ¡ (ä¼˜å…ˆçº§: 2)  
# å¤„ç†: æ™®é€šä»»åŠ¡ (ä¼˜å…ˆçº§: 3)
```

### 2.4 Queueçš„å®é™…åº”ç”¨


**åœºæ™¯ï¼šç½‘ç«™æ•°æ®çˆ¬å–**
```python
import queue
import threading
import requests
import time

# ä»»åŠ¡é˜Ÿåˆ—
url_queue = queue.Queue()
result_queue = queue.Queue()

def crawler(worker_id):
    """çˆ¬è™«å·¥ä½œè€…"""
    while True:
        try:
            url = url_queue.get(timeout=2)
            print(f"ğŸ•·ï¸ å·¥ä½œè€…{worker_id} å¼€å§‹çˆ¬å–: {url}")
            
            # æ¨¡æ‹Ÿçˆ¬å–ç½‘é¡µ
            time.sleep(1)  # æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚æ—¶é—´
            result = f"{url} çš„å†…å®¹"
            
            result_queue.put(result)
            url_queue.task_done()
            
        except queue.Empty:
            print(f"å·¥ä½œè€…{worker_id} æ²¡æœ‰æ›´å¤šä»»åŠ¡äº†")
            break

# æ·»åŠ è¦çˆ¬å–çš„ç½‘å€
urls = [
    "https://example.com/page1",
    "https://example.com/page2", 
    "https://example.com/page3"
]

for url in urls:
    url_queue.put(url)

# å¯åŠ¨3ä¸ªçˆ¬è™«çº¿ç¨‹
for i in range(3):
    t = threading.Thread(target=crawler, args=(i,))
    t.start()

# ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
url_queue.join()
print("æ‰€æœ‰ç½‘é¡µçˆ¬å–å®Œæˆï¼")
```

---

## 3. ğŸš¦ Eventäº‹ä»¶å¯¹è±¡


### 3.1 Eventæ˜¯ä»€ä¹ˆ


**ç®€å•ç†è§£**ï¼šEventå°±åƒä¸€ä¸ªçº¢ç»¿ç¯ï¼Œæ§åˆ¶çº¿ç¨‹çš„ç­‰å¾…å’Œç»§ç»­

```
ç”Ÿæ´»ä¸­çš„äº‹ä»¶ï¼š
ğŸ”´ çº¢ç¯äº®èµ· â†’ æ‰€æœ‰è½¦è¾†ç­‰å¾…
ğŸŸ¢ ç»¿ç¯äº®èµ· â†’ æ‰€æœ‰è½¦è¾†å¯ä»¥é€šè¡Œ
ğŸ“¢ è€å¸ˆè¯´"å¼€å§‹ç­”é¢˜" â†’ æ‰€æœ‰å­¦ç”Ÿå¼€å§‹å†™å·å­
```

**Eventçš„çŠ¶æ€**ï¼š
- **è®¾ç½®çŠ¶æ€**ï¼ˆsetï¼‰ï¼šç»¿ç¯ï¼Œå…è®¸é€šè¡Œ
- **æ¸…é™¤çŠ¶æ€**ï¼ˆclearï¼‰ï¼šçº¢ç¯ï¼Œéœ€è¦ç­‰å¾…
- **ç­‰å¾…çŠ¶æ€**ï¼ˆwaitï¼‰ï¼šç­‰ç»¿ç¯äº®èµ·

### 3.2 åŸºæœ¬ç”¨æ³•


```python
import threading
import time

# åˆ›å»ºä¸€ä¸ªäº‹ä»¶å¯¹è±¡
event = threading.Event()

def waiter(name):
    """ç­‰å¾…è€…ï¼šç­‰å¾…äº‹ä»¶å‘ç”Ÿ"""
    print(f"ğŸš¶ {name} åœ¨ç­‰å¾…ä¿¡å·...")
    event.wait()  # ç­‰å¾…äº‹ä»¶è¢«è®¾ç½®
    print(f"ğŸƒ {name} æ”¶åˆ°ä¿¡å·ï¼Œå¼€å§‹è¡ŒåŠ¨ï¼")

def setter():
    """è®¾ç½®è€…ï¼šè§¦å‘äº‹ä»¶"""
    print("â° å‡†å¤‡ä¸­ï¼Œè¯·ç¨ç­‰...")
    time.sleep(3)  # æ¨¡æ‹Ÿå‡†å¤‡æ—¶é—´
    
    print("ğŸ“¢ å‘å‡ºå¼€å§‹ä¿¡å·ï¼")
    event.set()  # è®¾ç½®äº‹ä»¶ï¼Œæ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹ä¼šè¢«å”¤é†’

# åˆ›å»ºå¤šä¸ªç­‰å¾…çº¿ç¨‹
for i in range(3):
    t = threading.Thread(target=waiter, args=(f"é€‰æ‰‹{i}",))
    t.start()

# åˆ›å»ºä¿¡å·å‘é€çº¿ç¨‹
signal_thread = threading.Thread(target=setter)
signal_thread.start()

signal_thread.join()
```

### 3.3 Eventçš„å®é™…åº”ç”¨


**åœºæ™¯ï¼šä¸‹è½½å™¨ç­‰å¾…ç½‘ç»œè¿æ¥**
```python
import threading
import time

# ç½‘ç»œè¿æ¥äº‹ä»¶
network_ready = threading.Event()

def check_network():
    """æ£€æŸ¥ç½‘ç»œè¿æ¥"""
    print("ğŸ” æ­£åœ¨æ£€æŸ¥ç½‘ç»œè¿æ¥...")
    time.sleep(2)  # æ¨¡æ‹Ÿç½‘ç»œæ£€æŸ¥
    
    # æ¨¡æ‹Ÿç½‘ç»œè¿æ¥æˆåŠŸ
    print("âœ… ç½‘ç»œè¿æ¥æ­£å¸¸")
    network_ready.set()  # é€šçŸ¥ç½‘ç»œå·²å°±ç»ª

def downloader(file_name):
    """ä¸‹è½½å™¨ï¼šç­‰å¾…ç½‘ç»œå°±ç»ªåä¸‹è½½"""
    print(f"ğŸ“ {file_name} ç­‰å¾…ç½‘ç»œè¿æ¥...")
    
    network_ready.wait()  # ç­‰å¾…ç½‘ç»œå°±ç»ª
    
    print(f"ğŸ“¥ å¼€å§‹ä¸‹è½½ {file_name}")
    time.sleep(1)  # æ¨¡æ‹Ÿä¸‹è½½
    print(f"âœ… {file_name} ä¸‹è½½å®Œæˆ")

# å¯åŠ¨ç½‘ç»œæ£€æŸ¥
network_thread = threading.Thread(target=check_network)
network_thread.start()

# å¯åŠ¨å¤šä¸ªä¸‹è½½ä»»åŠ¡
downloads = ["æ–‡ä»¶1.zip", "æ–‡ä»¶2.pdf", "æ–‡ä»¶3.mp4"]
for file_name in downloads:
    t = threading.Thread(target=downloader, args=(file_name,))
    t.start()

network_thread.join()
```

### 3.4 Eventçš„é«˜çº§ç”¨æ³•


**è¶…æ—¶ç­‰å¾…**ï¼š
```python
import threading
import time

event = threading.Event()

def waiter_with_timeout():
    """å¸¦è¶…æ—¶çš„ç­‰å¾…"""
    print("â³ ç­‰å¾…ä¿¡å·ï¼Œæœ€å¤šç­‰5ç§’...")
    
    if event.wait(timeout=5):  # æœ€å¤šç­‰5ç§’
        print("âœ… æ”¶åˆ°ä¿¡å·ï¼")
    else:
        print("â° ç­‰å¾…è¶…æ—¶ï¼Œä¸ç­‰äº†")

# å¯åŠ¨ç­‰å¾…çº¿ç¨‹
t = threading.Thread(target=waiter_with_timeout)
t.start()

# æ¨¡æ‹Ÿè¶…æ—¶æƒ…å†µï¼ˆä¸å‘é€ä¿¡å·ï¼‰
time.sleep(6)
```

---

## 4. ğŸš§ Barrierå±éšœåŒæ­¥


### 4.1 Barrieræ˜¯ä»€ä¹ˆ


**ç®€å•ç†è§£**ï¼šBarrierå°±åƒä¸€ä¸ªå…³å¡ï¼Œå¿…é¡»ç­‰æ‰€æœ‰äººéƒ½åˆ°é½äº†æ‰èƒ½ä¸€èµ·é€šè¿‡

```
ç”Ÿæ´»ä¸­çš„å±éšœï¼š
ğŸšŒ æ—…æ¸¸å›¢ï¼šç­‰æ‰€æœ‰äººä¸Šè½¦æ‰èƒ½å‘è½¦
ğŸƒ æ¥åŠ›èµ›ï¼šç­‰é˜Ÿå‹è·‘åˆ°æ‰èƒ½ä¼ æ£’
ğŸ¬ åˆå”±å›¢ï¼šç­‰æ‰€æœ‰äººå‡†å¤‡å¥½æ‰èƒ½å¼€å§‹å”±
```

**Barrierçš„ç‰¹ç‚¹**ï¼š
- **é›†åˆç‚¹**ï¼šçº¿ç¨‹åœ¨è¿™é‡Œé›†åˆç­‰å¾…
- **ç»Ÿä¸€æ”¾è¡Œ**ï¼šæ‰€æœ‰çº¿ç¨‹éƒ½åˆ°äº†æ‰ä¸€èµ·ç»§ç»­
- **å¯é‡ç”¨**ï¼šå¯ä»¥è®¾ç½®å¤šä¸ªå…³å¡ç‚¹

### 4.2 åŸºæœ¬ç”¨æ³•


```python
import threading
import time
import random

# åˆ›å»ºä¸€ä¸ªå±éšœï¼Œç­‰å¾…3ä¸ªçº¿ç¨‹
barrier = threading.Barrier(3)

def worker(worker_id):
    """å·¥ä½œè€…"""
    # ç¬¬ä¸€é˜¶æ®µï¼šå‡†å¤‡å·¥ä½œ
    prep_time = random.randint(1, 3)
    print(f"ğŸ”§ å·¥ä½œè€…{worker_id} æ­£åœ¨å‡†å¤‡... (éœ€è¦{prep_time}ç§’)")
    time.sleep(prep_time)
    
    print(f"âœ… å·¥ä½œè€…{worker_id} å‡†å¤‡å®Œæˆï¼Œç­‰å¾…å…¶ä»–äºº...")
    
    try:
        barrier.wait()  # ç­‰å¾…æ‰€æœ‰äººéƒ½å‡†å¤‡å¥½
        print(f"ğŸš€ å·¥ä½œè€…{worker_id} å¼€å§‹æ‰§è¡Œä¸»è¦ä»»åŠ¡ï¼")
        
        # ç¬¬äºŒé˜¶æ®µï¼šä¸»è¦å·¥ä½œ
        work_time = random.randint(1, 2)
        time.sleep(work_time)
        print(f"ğŸ’¼ å·¥ä½œè€…{worker_id} ä¸»è¦ä»»åŠ¡å®Œæˆ")
        
        barrier.wait()  # å†æ¬¡ç­‰å¾…æ‰€æœ‰äººå®Œæˆ
        print(f"ğŸ‰ å·¥ä½œè€…{worker_id} è¿›å…¥æœ€ç»ˆé˜¶æ®µï¼")
        
    except threading.BrokenBarrierError:
        print(f"âŒ å·¥ä½œè€…{worker_id}: å±éšœè¢«ç ´åäº†")

# å¯åŠ¨3ä¸ªå·¥ä½œçº¿ç¨‹
for i in range(3):
    t = threading.Thread(target=worker, args=(i,))
    t.start()
```

### 4.3 Barrierçš„å®é™…åº”ç”¨


**åœºæ™¯ï¼šå¹¶è¡Œè®¡ç®—ä»»åŠ¡**
```python
import threading
import time

# åˆ›å»ºå±éšœç­‰å¾…4ä¸ªè®¡ç®—çº¿ç¨‹
calculation_barrier = threading.Barrier(4)
results = {}  # å­˜å‚¨è®¡ç®—ç»“æœ

def parallel_calculator(task_id, numbers):
    """å¹¶è¡Œè®¡ç®—å™¨"""
    print(f"ğŸ§® ä»»åŠ¡{task_id} å¼€å§‹è®¡ç®—...")
    
    # æ¨¡æ‹Ÿå¤æ‚è®¡ç®—
    result = sum(x * x for x in numbers)
    time.sleep(2)  # æ¨¡æ‹Ÿè®¡ç®—æ—¶é—´
    
    results[task_id] = result
    print(f"âœ… ä»»åŠ¡{task_id} è®¡ç®—å®Œæˆï¼Œç»“æœ: {result}")
    
    # ç­‰å¾…æ‰€æœ‰è®¡ç®—å®Œæˆ
    calculation_barrier.wait()
    
    # æ‰€æœ‰ä»»åŠ¡å®Œæˆåï¼Œæ±‡æ€»ç»“æœ
    if task_id == 0:  # è®©ç¬¬ä¸€ä¸ªçº¿ç¨‹è´Ÿè´£æ±‡æ€»
        total = sum(results.values())
        print(f"ğŸ“Š æ‰€æœ‰è®¡ç®—å®Œæˆï¼æ€»å’Œ: {total}")

# åˆ†é…è®¡ç®—ä»»åŠ¡
tasks = [
    [1, 2, 3, 4],
    [5, 6, 7, 8], 
    [9, 10, 11, 12],
    [13, 14, 15, 16]
]

for i, numbers in enumerate(tasks):
    t = threading.Thread(target=parallel_calculator, args=(i, numbers))
    t.start()
```

---

## 5. ğŸ—„ï¸ çº¿ç¨‹å±€éƒ¨å­˜å‚¨


### 5.1 ä»€ä¹ˆæ˜¯çº¿ç¨‹å±€éƒ¨å­˜å‚¨


**ç®€å•ç†è§£**ï¼šæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„å°æŸœå­ï¼Œäº’ç›¸çœ‹ä¸åˆ°å¯¹æ–¹çš„ä¸œè¥¿

```
ç°å®ä¾‹å­ï¼š
ğŸ  æ¯ä¸ªæˆ¿é—´éƒ½æœ‰è‡ªå·±çš„è¡£æŸœ
ğŸ‘¥ æ¯ä¸ªå‘˜å·¥éƒ½æœ‰è‡ªå·±çš„å·¥ä½œå°
ğŸ’ æ¯ä¸ªå­¦ç”Ÿéƒ½æœ‰è‡ªå·±çš„ä¹¦åŒ…

ç‰¹ç‚¹ï¼š
- åŒåä½†å†…å®¹ä¸åŒ
- äº’ç›¸ä¸å¹²æ‰°
- å„è‡ªç®¡ç†å„è‡ªçš„
```

### 5.2 åŸºæœ¬ç”¨æ³•


```python
import threading
import time

# åˆ›å»ºçº¿ç¨‹å±€éƒ¨å­˜å‚¨
local_data = threading.local()

def process_data(worker_id):
    """æ¯ä¸ªçº¿ç¨‹å¤„ç†è‡ªå·±çš„æ•°æ®"""
    # æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ local_data.value
    local_data.value = f"çº¿ç¨‹{worker_id}çš„æ•°æ®"
    local_data.counter = 0
    
    for i in range(3):
        local_data.counter += 1
        print(f"ğŸ”¢ {worker_id}: è®¡æ•°å™¨={local_data.counter}, æ•°æ®={local_data.value}")
        time.sleep(0.5)
    
    print(f"âœ… {worker_id} æœ€ç»ˆç»“æœ: {local_data.counter}")

# å¯åŠ¨å¤šä¸ªçº¿ç¨‹
for i in range(3):
    t = threading.Thread(target=process_data, args=(f"å·¥ä½œè€…{i}",))
    t.start()
```

### 5.3 çº¿ç¨‹å±€éƒ¨å­˜å‚¨çš„åº”ç”¨åœºæ™¯


**åœºæ™¯1ï¼šæ•°æ®åº“è¿æ¥ç®¡ç†**
```python
import threading
import time

# æ¨¡æ‹Ÿæ•°æ®åº“è¿æ¥æ± 
class DatabaseConnection:
    def __init__(self, conn_id):
        self.conn_id = conn_id
        self.is_connected = True
    
    def query(self, sql):
        return f"è¿æ¥{self.conn_id}æ‰§è¡Œ: {sql}"
    
    def close(self):
        self.is_connected = False

# çº¿ç¨‹å±€éƒ¨å­˜å‚¨æ•°æ®åº“è¿æ¥
local_db = threading.local()

def get_db_connection():
    """è·å–å½“å‰çº¿ç¨‹çš„æ•°æ®åº“è¿æ¥"""
    if not hasattr(local_db, 'connection'):
        # æ¯ä¸ªçº¿ç¨‹ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶åˆ›å»ºè¿æ¥
        conn_id = threading.current_thread().name
        local_db.connection = DatabaseConnection(conn_id)
        print(f"ğŸ”— ä¸º {conn_id} åˆ›å»ºæ–°çš„æ•°æ®åº“è¿æ¥")
    
    return local_db.connection

def database_worker(worker_name):
    """æ•°æ®åº“å·¥ä½œè€…"""
    # è·å–å½“å‰çº¿ç¨‹çš„æ•°æ®åº“è¿æ¥
    db = get_db_connection()
    
    # æ‰§è¡ŒæŸ¥è¯¢
    for i in range(3):
        result = db.query(f"SELECT * FROM table_{i}")
        print(f"ğŸ“Š {worker_name}: {result}")
        time.sleep(0.5)

# å¯åŠ¨å¤šä¸ªæ•°æ®åº“å·¥ä½œçº¿ç¨‹
for i in range(3):
    t = threading.Thread(
        target=database_worker, 
        args=(f"DBå·¥ä½œè€…{i}",),
        name=f"DBThread-{i}"
    )
    t.start()
```

**åœºæ™¯2ï¼šç”¨æˆ·ä¼šè¯ç®¡ç†**
```python
import threading

# çº¿ç¨‹å±€éƒ¨å­˜å‚¨ç”¨æˆ·ä¿¡æ¯
local_user = threading.local()

def set_user_context(user_id, username):
    """è®¾ç½®å½“å‰çº¿ç¨‹çš„ç”¨æˆ·ä¸Šä¸‹æ–‡"""
    local_user.user_id = user_id
    local_user.username = username
    local_user.permissions = ["read", "write"] if user_id == 1 else ["read"]

def get_current_user():
    """è·å–å½“å‰çº¿ç¨‹çš„ç”¨æˆ·ä¿¡æ¯"""
    if hasattr(local_user, 'user_id'):
        return {
            'user_id': local_user.user_id,
            'username': local_user.username,
            'permissions': local_user.permissions
        }
    return None

def handle_request(user_id, username, action):
    """å¤„ç†ç”¨æˆ·è¯·æ±‚"""
    # è®¾ç½®ç”¨æˆ·ä¸Šä¸‹æ–‡
    set_user_context(user_id, username)
    
    # å¤„ç†ä¸šåŠ¡é€»è¾‘
    user = get_current_user()
    print(f"ğŸ‘¤ ç”¨æˆ· {user['username']} è¯·æ±‚ {action}")
    
    if "write" in user['permissions']:
        print(f"âœ… å…è®¸ {action} æ“ä½œ")
    else:
        print(f"âŒ æƒé™ä¸è¶³ï¼Œæ‹’ç» {action} æ“ä½œ")

# æ¨¡æ‹Ÿå¤šä¸ªç”¨æˆ·åŒæ—¶è¯·æ±‚
users = [
    (1, "ç®¡ç†å‘˜", "åˆ é™¤æ–‡ä»¶"),
    (2, "æ™®é€šç”¨æˆ·", "å†™å…¥æ•°æ®"),
    (3, "è®¿å®¢", "è¯»å–æ•°æ®")
]

for user_id, username, action in users:
    t = threading.Thread(target=handle_request, args=(user_id, username, action))
    t.start()
```

---

## 6. ğŸŠ çº¿ç¨‹æ± ThreadPoolExecutor


### 6.1 ä»€ä¹ˆæ˜¯çº¿ç¨‹æ± 


**ç®€å•ç†è§£**ï¼šçº¿ç¨‹æ± å°±åƒä¸€ä¸ªå·¥äººå›¢é˜Ÿï¼Œæœ‰å›ºå®šæ•°é‡çš„å·¥äººæ¥å¤„ç†ä»»åŠ¡

```
ç°å®ä¸­çš„ä¾‹å­ï¼š
ğŸ­ å·¥å‚æµæ°´çº¿ï¼šå›ºå®šæ•°é‡çš„å·¥äººï¼Œä»»åŠ¡æ¥äº†å°±åˆ†é…
ğŸ” å¿«é¤åº—ï¼šå‡ ä¸ªå‘˜å·¥è½®æµåšæ±‰å ¡
ğŸš– å‡ºç§Ÿè½¦å…¬å¸ï¼šå›ºå®šæ•°é‡çš„è½¦ï¼Œä¹˜å®¢æ¥äº†å°±æ´¾è½¦

å¥½å¤„ï¼š
âœ… é¿å…é¢‘ç¹æ‹›è˜/è§£é›‡å·¥äººï¼ˆåˆ›å»º/é”€æ¯çº¿ç¨‹ï¼‰
âœ… æ§åˆ¶å·¥äººæ•°é‡ï¼ˆæ§åˆ¶èµ„æºä½¿ç”¨ï¼‰
âœ… ç»Ÿä¸€ç®¡ç†ä»»åŠ¡åˆ†é…
```

### 6.2 åŸºæœ¬ç”¨æ³•


```python
from concurrent.futures import ThreadPoolExecutor
import time

def task_worker(task_id):
    """ä»»åŠ¡å¤„ç†å‡½æ•°"""
    print(f"ğŸ”§ å¼€å§‹å¤„ç†ä»»åŠ¡ {task_id}")
    time.sleep(2)  # æ¨¡æ‹Ÿå·¥ä½œæ—¶é—´
    result = f"ä»»åŠ¡{task_id}çš„ç»“æœ"
    print(f"âœ… ä»»åŠ¡ {task_id} å®Œæˆ")
    return result

# åˆ›å»ºçº¿ç¨‹æ± ï¼ˆæœ€å¤š3ä¸ªå·¥ä½œçº¿ç¨‹ï¼‰
with ThreadPoolExecutor(max_workers=3) as executor:
    # æäº¤ä»»åŠ¡
    futures = []
    for i in range(6):
        future = executor.submit(task_worker, i)
        futures.append(future)
    
    # è·å–ç»“æœ
    for future in futures:
        result = future.result()  # ç­‰å¾…ä»»åŠ¡å®Œæˆå¹¶è·å–ç»“æœ
        print(f"ğŸ“„ æ”¶åˆ°ç»“æœ: {result}")

print("ğŸ‰ æ‰€æœ‰ä»»åŠ¡å®Œæˆ")
```

### 6.3 çº¿ç¨‹æ± çš„é«˜çº§ç”¨æ³•


**æ–¹æ³•1ï¼šmapæ–¹å¼æ‰¹é‡å¤„ç†**
```python
from concurrent.futures import ThreadPoolExecutor
import time

def download_file(url):
    """æ¨¡æ‹Ÿä¸‹è½½æ–‡ä»¶"""
    filename = url.split('/')[-1]
    print(f"ğŸ“¥ å¼€å§‹ä¸‹è½½: {filename}")
    time.sleep(1)  # æ¨¡æ‹Ÿä¸‹è½½æ—¶é—´
    print(f"âœ… ä¸‹è½½å®Œæˆ: {filename}")
    return f"{filename} (å¤§å°: 1MB)"

# è¦ä¸‹è½½çš„æ–‡ä»¶åˆ—è¡¨
urls = [
    "https://example.com/file1.zip",
    "https://example.com/file2.pdf", 
    "https://example.com/file3.mp4",
    "https://example.com/file4.txt"
]

# ä½¿ç”¨mapæ–¹å¼
with ThreadPoolExecutor(max_workers=2) as executor:
    results = list(executor.map(download_file, urls))

print("ğŸ“‹ ä¸‹è½½ç»“æœ:")
for result in results:
    print(f"  - {result}")
```

**æ–¹æ³•2ï¼šas_completedè·å–æœ€å¿«å®Œæˆçš„ä»»åŠ¡**
```python
from concurrent.futures import ThreadPoolExecutor, as_completed
import time
import random

def search_engine(engine_name):
    """æ¨¡æ‹Ÿæœç´¢å¼•æ“æŸ¥è¯¢"""
    search_time = random.uniform(0.5, 3.0)  # éšæœºæœç´¢æ—¶é—´
    print(f"ğŸ” {engine_name} å¼€å§‹æœç´¢...")
    time.sleep(search_time)
    
    results_count = random.randint(10, 100)
    print(f"âœ… {engine_name} æœç´¢å®Œæˆ!")
    return f"{engine_name}: æ‰¾åˆ°{results_count}ä¸ªç»“æœ"

# å¤šä¸ªæœç´¢å¼•æ“
engines = ["Google", "Bing", "ç™¾åº¦", "æœç‹—"]

with ThreadPoolExecutor(max_workers=4) as executor:
    # æäº¤æ‰€æœ‰æœç´¢ä»»åŠ¡
    future_to_engine = {
        executor.submit(search_engine, engine): engine 
        for engine in engines
    }
    
    # è·å–æœ€å…ˆå®Œæˆçš„ç»“æœ
    print("â° æŒ‰å®Œæˆé¡ºåºæ˜¾ç¤ºç»“æœ:")
    for future in as_completed(future_to_engine):
        engine = future_to_engine[future]
        result = future.result()
        print(f"ğŸ† {result}")
```

### 6.4 çº¿ç¨‹æ± çš„å®é™…åº”ç”¨


**åœºæ™¯ï¼šç½‘é¡µçˆ¬è™«**
```python
from concurrent.futures import ThreadPoolExecutor
import requests
import time

def crawl_page(url):
    """çˆ¬å–ç½‘é¡µ"""
    try:
        print(f"ğŸ•·ï¸ å¼€å§‹çˆ¬å–: {url}")
        # è¿™é‡Œç”¨sleepæ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚
        time.sleep(1)
        
        # æ¨¡æ‹Ÿè·å–é¡µé¢æ ‡é¢˜
        title = f"{url.split('/')[-1]} çš„æ ‡é¢˜"
        print(f"ğŸ“„ çˆ¬å–æˆåŠŸ: {title}")
        return {"url": url, "title": title, "status": "success"}
        
    except Exception as e:
        print(f"âŒ çˆ¬å–å¤±è´¥ {url}: {e}")
        return {"url": url, "error": str(e), "status": "failed"}

# è¦çˆ¬å–çš„ç½‘å€åˆ—è¡¨
urls = [
    "https://example.com/page1",
    "https://example.com/page2",
    "https://example.com/page3",
    "https://example.com/page4",
    "https://example.com/page5"
]

# ä½¿ç”¨çº¿ç¨‹æ± çˆ¬å–
print("ğŸš€ å¼€å§‹å¹¶å‘çˆ¬å–...")
start_time = time.time()

with ThreadPoolExecutor(max_workers=3) as executor:
    results = list(executor.map(crawl_page, urls))

end_time = time.time()

# ç»Ÿè®¡ç»“æœ
success_count = sum(1 for r in results if r["status"] == "success")
failed_count = len(results) - success_count

print(f"\nğŸ“Š çˆ¬å–å®Œæˆ:")
print(f"   âœ… æˆåŠŸ: {success_count} ä¸ª")
print(f"   âŒ å¤±è´¥: {failed_count} ä¸ª")
print(f"   â±ï¸ æ€»è€—æ—¶: {end_time - start_time:.2f} ç§’")
```

---

## 7. ğŸš¨ çº¿ç¨‹å¼‚å¸¸å¤„ç†


### 7.1 ä¸ºä»€ä¹ˆéœ€è¦å¼‚å¸¸å¤„ç†


**é—®é¢˜åœºæ™¯**ï¼š
```
ğŸš— æƒ³è±¡ä¸€ä¸ªå‡ºç§Ÿè½¦é˜Ÿï¼š
âŒ ä¸€è¾†è½¦æŠ›é”šäº†ï¼Œä½†è°ƒåº¦ä¸­å¿ƒä¸çŸ¥é“
âŒ ä¹˜å®¢ä¸€ç›´ç­‰è½¦ï¼Œä½†è½¦æ°¸è¿œä¸ä¼šæ¥
âŒ å…¶ä»–è½¦ç»§ç»­å·¥ä½œï¼Œä½†è¿™ä¸ªä»»åŠ¡æ°¸è¿œå®Œä¸æˆ
```

**çº¿ç¨‹å¼‚å¸¸çš„ç‰¹ç‚¹**ï¼š
- **é™é»˜å¤±è´¥**ï¼šçº¿ç¨‹å†…çš„å¼‚å¸¸ä¸ä¼šå½±å“ä¸»ç¨‹åº
- **éš¾ä»¥å‘ç°**ï¼šä¸»çº¿ç¨‹å¯èƒ½ä¸çŸ¥é“å­çº¿ç¨‹å‡ºé”™äº†
- **èµ„æºæµªè´¹**ï¼šå‡ºé”™çš„çº¿ç¨‹å¯èƒ½å ç”¨èµ„æº

### 7.2 åŸºæœ¬å¼‚å¸¸å¤„ç†


```python
import threading
import time

def risky_task(task_id):
    """å¯èƒ½å‡ºé”™çš„ä»»åŠ¡"""
    try:
        print(f"ğŸ”§ ä»»åŠ¡{task_id} å¼€å§‹æ‰§è¡Œ...")
        
        if task_id == 2:
            # æ¨¡æ‹Ÿå¼‚å¸¸
            raise ValueError(f"ä»»åŠ¡{task_id} é‡åˆ°äº†é—®é¢˜!")
        
        time.sleep(1)
        print(f"âœ… ä»»åŠ¡{task_id} æˆåŠŸå®Œæˆ")
        
    except Exception as e:
        print(f"âŒ ä»»åŠ¡{task_id} æ‰§è¡Œå¤±è´¥: {e}")
        # å¯ä»¥è®°å½•æ—¥å¿—ã€å‘é€è­¦æŠ¥ç­‰

# å¯åŠ¨å¤šä¸ªä»»åŠ¡
threads = []
for i in range(4):
    t = threading.Thread(target=risky_task, args=(i,))
    threads.append(t)
    t.start()

# ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ
for t in threads:
    t.join()

print("ğŸ¯ æ‰€æœ‰ä»»åŠ¡å¤„ç†å®Œæˆ")
```

### 7.3 ä½¿ç”¨çº¿ç¨‹æ± å¤„ç†å¼‚å¸¸


```python
from concurrent.futures import ThreadPoolExecutor, as_completed
import time

def unreliable_worker(worker_id):
    """ä¸å¯é çš„å·¥ä½œè€…"""
    print(f"ğŸ”§ å·¥ä½œè€…{worker_id} å¼€å§‹å·¥ä½œ...")
    
    # æ¨¡æ‹Ÿä¸åŒç±»å‹çš„é”™è¯¯
    if worker_id == 1:
        raise ConnectionError("ç½‘ç»œè¿æ¥å¤±è´¥")
    elif worker_id == 2:
        raise ValueError("æ•°æ®æ ¼å¼é”™è¯¯")
    elif worker_id == 3:
        time.sleep(2)
        return f"å·¥ä½œè€…{worker_id} æˆåŠŸå®Œæˆ"
    else:
        time.sleep(1)
        return f"å·¥ä½œè€…{worker_id} æ­£å¸¸å®Œæˆ"

# ä½¿ç”¨çº¿ç¨‹æ± å¹¶å¤„ç†å¼‚å¸¸
with ThreadPoolExecutor(max_workers=3) as executor:
    # æäº¤ä»»åŠ¡
    future_to_worker = {
        executor.submit(unreliable_worker, i): i 
        for i in range(5)
    }
    
    # å¤„ç†ç»“æœå’Œå¼‚å¸¸
    for future in as_completed(future_to_worker):
        worker_id = future_to_worker[future]
        
        try:
            result = future.result()
            print(f"âœ… {result}")
            
        except ConnectionError as e:
            print(f"ğŸŒ å·¥ä½œè€…{worker_id} ç½‘ç»œé”™è¯¯: {e}")
            # å¯ä»¥é‡è¯•ç½‘ç»œè¿æ¥
            
        except ValueError as e:
            print(f"ğŸ“Š å·¥ä½œè€…{worker_id} æ•°æ®é”™è¯¯: {e}")
            # å¯ä»¥ä¿®å¤æ•°æ®åé‡è¯•
            
        except Exception as e:
            print(f"âŒ å·¥ä½œè€…{worker_id} æœªçŸ¥é”™è¯¯: {e}")
```

### 7.4 å¼‚å¸¸å¤„ç†æœ€ä½³å®è·µ


**å®é™…åº”ç”¨ï¼šå¥å£®çš„æ–‡ä»¶å¤„ç†ç³»ç»Ÿ**
```python
import threading
import queue
import time
import logging

# è®¾ç½®æ—¥å¿—
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(message)s')

class FileProcessor:
    def __init__(self, max_workers=3):
        self.task_queue = queue.Queue()
        self.result_queue = queue.Queue()
        self.error_queue = queue.Queue()
        self.max_workers = max_workers
        self.workers = []
        self.running = True
    
    def worker(self, worker_id):
        """å·¥ä½œçº¿ç¨‹"""
        while self.running:
            try:
                # è·å–ä»»åŠ¡ï¼Œè¶…æ—¶é€€å‡º
                task = self.task_queue.get(timeout=1)
                
                # å¤„ç†ä»»åŠ¡
                result = self.process_file(task, worker_id)
                self.result_queue.put(result)
                
                self.task_queue.task_done()
                
            except queue.Empty:
                continue  # é˜Ÿåˆ—ä¸ºç©ºï¼Œç»§ç»­ç­‰å¾…
                
            except Exception as e:
                # å¤„ç†æ‰€æœ‰å¼‚å¸¸
                error_info = {
                    'worker_id': worker_id,
                    'task': task if 'task' in locals() else 'unknown',
                    'error': str(e),
                    'timestamp': time.time()
                }
                self.error_queue.put(error_info)
                logging.error(f"å·¥ä½œè€…{worker_id} å‡ºé”™: {e}")
    
    def process_file(self, filename, worker_id):
        """å¤„ç†æ–‡ä»¶ï¼ˆå¯èƒ½å‡ºé”™çš„åœ°æ–¹ï¼‰"""
        print(f"ğŸ“ å·¥ä½œè€…{worker_id} å¤„ç†æ–‡ä»¶: {filename}")
        
        # æ¨¡æ‹Ÿä¸åŒçš„é”™è¯¯æƒ…å†µ
        if "error" in filename:
            raise ValueError(f"æ–‡ä»¶ {filename} æ ¼å¼é”™è¯¯")
        elif "missing" in filename:
            raise FileNotFoundError(f"æ–‡ä»¶ {filename} ä¸å­˜åœ¨")
        
        # æ¨¡æ‹Ÿå¤„ç†æ—¶é—´
        time.sleep(1)
        return f"{filename} å¤„ç†å®Œæˆ (by å·¥ä½œè€…{worker_id})"
    
    def start(self):
        """å¯åŠ¨å·¥ä½œçº¿ç¨‹"""
        for i in range(self.max_workers):
            t = threading.Thread(target=self.worker, args=(i,))
            t.daemon = True  # å®ˆæŠ¤çº¿ç¨‹ï¼Œä¸»ç¨‹åºé€€å‡ºæ—¶è‡ªåŠ¨ç»“æŸ
            self.workers.append(t)
            t.start()
        
        logging.info(f"å¯åŠ¨äº† {self.max_workers} ä¸ªå·¥ä½œçº¿ç¨‹")
    
    def add_task(self, filename):
        """æ·»åŠ ä»»åŠ¡"""
        self.task_queue.put(filename)
    
    def get_results(self):
        """è·å–å¤„ç†ç»“æœ"""
        results = []
        try:
            while True:
                result = self.result_queue.get_nowait()
                results.append(result)
        except queue.Empty:
            pass
        return results
    
    def get_errors(self):
        """è·å–é”™è¯¯ä¿¡æ¯"""
        errors = []
        try:
            while True:
                error = self.error_queue.get_nowait()
                errors.append(error)
        except queue.Empty:
            pass
        return errors
    
    def stop(self):
        """åœæ­¢å¤„ç†"""
        self.running = False
        for t in self.workers:
            t.join(timeout=2)

# ä½¿ç”¨ç¤ºä¾‹
processor = FileProcessor(max_workers=3)
processor.start()

# æ·»åŠ ä»»åŠ¡ï¼ˆåŒ…æ‹¬ä¼šå‡ºé”™çš„ä»»åŠ¡ï¼‰
files = [
    "document1.txt",
    "error_file.txt",    # ä¼šè§¦å‘ValueError
    "document2.pdf", 
    "missing_file.doc",  # ä¼šè§¦å‘FileNotFoundError
    "document3.xlsx"
]

for filename in files:
    processor.add_task(filename)

# ç­‰å¾…å¤„ç†å®Œæˆ
processor.task_queue.join()

# è·å–ç»“æœå’Œé”™è¯¯
results = processor.get_results()
errors = processor.get_errors()

print("\nğŸ“Š å¤„ç†ç»“æœ:")
for result in results:
    print(f"  âœ… {result}")

print("\nâŒ é”™è¯¯æŠ¥å‘Š:")
for error in errors:
    print(f"  ğŸš¨ å·¥ä½œè€…{error['worker_id']}: {error['error']}")

processor.stop()
```

---

## 8. ğŸ” çº¿ç¨‹è°ƒè¯•æŠ€å·§


### 8.1 çº¿ç¨‹çŠ¶æ€ç›‘æ§


```python
import threading
import time

def monitor_threads():
    """ç›‘æ§æ‰€æœ‰çº¿ç¨‹çŠ¶æ€"""
    while True:
        print("\nğŸ” å½“å‰çº¿ç¨‹çŠ¶æ€:")
        for thread in threading.enumerate():
            status = "ğŸŸ¢ è¿è¡Œä¸­" if thread.is_alive() else "ğŸ”´ å·²åœæ­¢"
            thread_type = "ğŸ§µ å®ˆæŠ¤çº¿ç¨‹" if thread.daemon else "ğŸ§µ æ™®é€šçº¿ç¨‹"
            print(f"  {thread.name}: {status} {thread_type}")
        
        time.sleep(3)

def worker_task(name, duration):
    """å·¥ä½œä»»åŠ¡"""
    print(f"ğŸ”§ {name} å¼€å§‹å·¥ä½œ...")
    time.sleep(duration)
    print(f"âœ… {name} å·¥ä½œå®Œæˆ")

# å¯åŠ¨ç›‘æ§çº¿ç¨‹ï¼ˆå®ˆæŠ¤çº¿ç¨‹ï¼‰
monitor = threading.Thread(target=monitor_threads, daemon=True)
monitor.start()

# å¯åŠ¨å·¥ä½œçº¿ç¨‹
threads = []
for i in range(3):
    t = threading.Thread(
        target=worker_task, 
        args=(f"å·¥ä½œè€…{i}", i + 2),
        name=f"Worker-{i}"
    )
    threads.append(t)
    t.start()

# ç­‰å¾…å·¥ä½œçº¿ç¨‹å®Œæˆ
for t in threads:
    t.join()

print("ğŸ¯ æ‰€æœ‰å·¥ä½œå®Œæˆ")
```

### 8.2 æ­»é”æ£€æµ‹


```python
import threading
import time

# ä¸¤ä¸ªé”ï¼Œå®¹æ˜“é€ æˆæ­»é”
lock1 = threading.Lock()
lock2 = threading.Lock()

def task_a():
    """ä»»åŠ¡Aï¼šå…ˆè·å–lock1å†è·å–lock2"""
    print("ğŸ”´ ä»»åŠ¡A: å°è¯•è·å–é”1...")
    with lock1:
        print("ğŸ”´ ä»»åŠ¡A: è·å¾—é”1ï¼Œç­‰å¾…1ç§’...")
        time.sleep(1)
        
        print("ğŸ”´ ä»»åŠ¡A: å°è¯•è·å–é”2...")
        with lock2:
            print("ğŸ”´ ä»»åŠ¡A: è·å¾—é”2ï¼Œæ‰§è¡Œä»»åŠ¡")

def task_b():
    """ä»»åŠ¡Bï¼šå…ˆè·å–lock2å†è·å–lock1ï¼ˆä¼šé€ æˆæ­»é”ï¼‰"""
    print("ğŸ”µ ä»»åŠ¡B: å°è¯•è·å–é”2...")
    with lock2:
        print("ğŸ”µ ä»»åŠ¡B: è·å¾—é”2ï¼Œç­‰å¾…1ç§’...")
        time.sleep(1)
        
        print("ğŸ”µ ä»»åŠ¡B: å°è¯•è·å–é”1...")
        with lock1:
            print("ğŸ”µ ä»»åŠ¡B: è·å¾—é”1ï¼Œæ‰§è¡Œä»»åŠ¡")

def deadlock_detector():
    """æ­»é”æ£€æµ‹å™¨"""
    start_time = time.time()
    while time.time() - start_time < 10:  # ç›‘æ§10ç§’
        time.sleep(2)
        
        # æ£€æŸ¥æ˜¯å¦æœ‰çº¿ç¨‹å¡ä½
        active_threads = [t for t in threading.enumerate() if t != threading.current_thread()]
        if len(active_threads) > 0:
            print("âš ï¸  æ£€æµ‹åˆ°çº¿ç¨‹å¯èƒ½å‘ç”Ÿæ­»é”ï¼Œæ­£åœ¨ç›‘æ§...")
            for thread in active_threads:
                print(f"   ğŸ“ {thread.name}: {'è¿è¡Œä¸­' if thread.is_alive() else 'å·²åœæ­¢'}")

# å¯åŠ¨æ­»é”æ£€æµ‹
detector = threading.Thread(target=deadlock_detector, daemon=True)
detector.start()

# å¯åŠ¨å¯èƒ½æ­»é”çš„ä»»åŠ¡
print("ğŸš€ å¯åŠ¨å¯èƒ½å‘ç”Ÿæ­»é”çš„ä»»åŠ¡...")
t1 = threading.Thread(target=task_a, name="TaskA")
t2 = threading.Thread(target=task_b, name="TaskB")

t1.start()
t2.start()

# è®¾ç½®è¶…æ—¶æ—¶é—´
t1.join(timeout=5)
t2.join(timeout=5)

if t1.is_alive() or t2.is_alive():
    print("ğŸ’€ æ£€æµ‹åˆ°æ­»é”ï¼çº¿ç¨‹æ²¡æœ‰åœ¨é¢„æœŸæ—¶é—´å†…å®Œæˆ")
else:
    print("âœ… ä»»åŠ¡æ­£å¸¸å®Œæˆï¼Œæ²¡æœ‰æ­»é”")
```

### 8.3 æ€§èƒ½åˆ†æ


```python
import threading
import time
import functools

def performance_monitor(func):
    """æ€§èƒ½ç›‘æ§è£…é¥°å™¨"""
    @functools.wraps(func)
    def wrapper(*args, **kwargs):
        thread_name = threading.current_thread().name
        start_time = time.time()
        
        print(f"â±ï¸ {thread_name} å¼€å§‹æ‰§è¡Œ {func.__name__}")
        
        try:
            result = func(*args, **kwargs)
            end_time = time.time()
            duration = end_time - start_time
            print(f"âœ… {thread_name} å®Œæˆ {func.__name__}ï¼Œè€—æ—¶: {duration:.2f}ç§’")
            return result
            
        except Exception as e:
            end_time = time.time()
            duration = end_time - start_time
            print(f"âŒ {thread_name} æ‰§è¡Œ {func.__name__} å¤±è´¥ï¼Œè€—æ—¶: {duration:.2f}ç§’ï¼Œé”™è¯¯: {e}")
            raise
    
    return wrapper

@performance_monitor
def slow_calculation(n):
    """è€—æ—¶è®¡ç®—"""
    result = sum(i * i for i in range(n))
    time.sleep(1)  # æ¨¡æ‹Ÿå¤æ‚è®¡ç®—
    return result

@performance_monitor  
def fast_task():
    """å¿«é€Ÿä»»åŠ¡"""
    time.sleep(0.1)
    return "å¿«é€Ÿå®Œæˆ"

# æµ‹è¯•æ€§èƒ½ç›‘æ§
threads = []

# å¯åŠ¨ä¸åŒç±»å‹çš„ä»»åŠ¡
for i in range(3):
    t1 = threading.Thread(
        target=slow_calculation, 
        args=(1000000,),
        name=f"SlowWorker-{i}"
    )
    
    t2 = threading.Thread(
        target=fast_task,
        name=f"FastWorker-{i}"
    )
    
    threads.extend([t1, t2])
    t1.start()
    t2.start()

# ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
for t in threads:
    t.join()

print("ğŸ“Š æ€§èƒ½åˆ†æå®Œæˆ")
```

---

## 9. ğŸ¯ çº¿ç¨‹æœ€ä½³å®è·µ


### 9.1 çº¿ç¨‹å®‰å…¨çš„å•ä¾‹æ¨¡å¼


```python
import threading

class DatabaseManager:
    """çº¿ç¨‹å®‰å…¨çš„æ•°æ®åº“ç®¡ç†å™¨ï¼ˆå•ä¾‹æ¨¡å¼ï¼‰"""
    
    _instance = None
    _lock = threading.Lock()
    
    def __new__(cls):
        # åŒé‡æ£€æŸ¥é”å®š
        if cls._instance is None:
            with cls._lock:
                if cls._instance is None:
                    cls._instance = super().__new__(cls)
                    cls._instance._initialized = False
        return cls._instance
    
    def __init__(self):
        if self._initialized:
            return
        
        self._initialized = True
        self.connections = {}
        self.connection_lock = threading.Lock()
        print("ğŸ—„ï¸ æ•°æ®åº“ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ")
    
    def get_connection(self, thread_id):
        """ä¸ºæ¯ä¸ªçº¿ç¨‹è·å–ç‹¬ç«‹çš„è¿æ¥"""
        with self.connection_lock:
            if thread_id not in self.connections:
                self.connections[thread_id] = f"è¿æ¥-{thread_id}"
                print(f"ğŸ”— ä¸ºçº¿ç¨‹ {thread_id} åˆ›å»ºæ–°è¿æ¥")
            
            return self.connections[thread_id]

def database_worker(worker_id):
    """æ•°æ®åº“å·¥ä½œè€…"""
    db_manager = DatabaseManager()  # æ‰€æœ‰çº¿ç¨‹è·å–åŒä¸€ä¸ªå®ä¾‹
    connection = db_manager.get_connection(worker_id)
    
    print(f"ğŸ’¾ å·¥ä½œè€… {worker_id} ä½¿ç”¨è¿æ¥: {connection}")
    time.sleep(1)

# æµ‹è¯•çº¿ç¨‹å®‰å…¨çš„å•ä¾‹
threads = []
for i in range(5):
    t = threading.Thread(target=database_worker, args=(i,))
    threads.append(t)
    t.start()

for t in threads:
    t.join()
```

### 9.2 ä¼˜é›…çš„çº¿ç¨‹æ± ç®¡ç†


```python
import threading
import queue
import time
import signal
import sys

class GracefulThreadPool:
    """ä¼˜é›…çš„çº¿ç¨‹æ± å®ç°"""
    
    def __init__(self, max_workers=3):
        self.max_workers = max_workers
        self.task_queue = queue.Queue()
        self.workers = []
        self.shutdown = False
        
        # æ³¨å†Œä¿¡å·å¤„ç†ï¼ˆCtrl+Cä¼˜é›…é€€å‡ºï¼‰
        signal.signal(signal.SIGINT, self._signal_handler)
    
    def _signal_handler(self, signum, frame):
        """å¤„ç†ä¸­æ–­ä¿¡å·"""
        print("\nğŸ›‘ æ”¶åˆ°ä¸­æ–­ä¿¡å·ï¼Œæ­£åœ¨ä¼˜é›…å…³é—­...")
        self.shutdown_gracefully()
        sys.exit(0)
    
    def worker(self, worker_id):
        """å·¥ä½œçº¿ç¨‹"""
        print(f"ğŸ”§ å·¥ä½œè€…{worker_id} å¯åŠ¨")
        
        while not self.shutdown:
            try:
                # è·å–ä»»åŠ¡ï¼Œè¶…æ—¶æ£€æŸ¥
                task, args = self.task_queue.get(timeout=1)
                
                if task is None:  # æ¯’ä¸¸ï¼Œåœæ­¢ä¿¡å·
                    break
                
                print(f"âš¡ å·¥ä½œè€…{worker_id} å¼€å§‹å¤„ç†ä»»åŠ¡")
                result = task(*args)
                print(f"âœ… å·¥ä½œè€…{worker_id} å®Œæˆä»»åŠ¡: {result}")
                
                self.task_queue.task_done()
                
            except queue.Empty:
                continue  # è¶…æ—¶ç»§ç»­æ£€æŸ¥shutdownçŠ¶æ€
            
            except Exception as e:
                print(f"âŒ å·¥ä½œè€…{worker_id} å¤„ç†ä»»åŠ¡æ—¶å‡ºé”™: {e}")
                self.task_queue.task_done()
        
        print(f"ğŸ å·¥ä½œè€…{worker_id} é€€å‡º")
    
    def start(self):
        """å¯åŠ¨çº¿ç¨‹æ± """
        for i in range(self.max_workers):
            t = threading.Thread(target=self.worker, args=(i,))
            t.daemon = False  # éå®ˆæŠ¤çº¿ç¨‹ï¼Œç¡®ä¿ä¼˜é›…é€€å‡º
            self.workers.append(t)
            t.start()
        
        print(f"ğŸš€ çº¿ç¨‹æ± å¯åŠ¨ï¼Œ{self.max_workers} ä¸ªå·¥ä½œè€…å°±ç»ª")
    
    def submit(self, func, *args):
        """æäº¤ä»»åŠ¡"""
        if not self.shutdown:
            self.task_queue.put((func, args))
    
    def shutdown_gracefully(self, timeout=5):
        """ä¼˜é›…å…³é—­"""
        print("ğŸ“‹ ç­‰å¾…å½“å‰ä»»åŠ¡å®Œæˆ...")
        
        # è®¾ç½®å…³é—­æ ‡å¿—
        self.shutdown = True
        
        # ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡å®Œæˆ
        self.task_queue.join()
        
        # å‘é€åœæ­¢ä¿¡å·ç»™æ‰€æœ‰å·¥ä½œçº¿ç¨‹
        for _ in self.workers:
            self.task_queue.put((None, None))
        
        # ç­‰å¾…æ‰€æœ‰çº¿ç¨‹é€€å‡º
        for t in self.workers:
            t.join(timeout=timeout)
            if t.is_alive():
                print(f"âš ï¸ çº¿ç¨‹ {t.name} æ²¡æœ‰åœ¨ {timeout} ç§’å†…é€€å‡º")
        
        print("ğŸ¯ çº¿ç¨‹æ± å·²ä¼˜é›…å…³é—­")

# ç¤ºä¾‹ä»»åŠ¡
def sample_task(task_id, duration):
    """ç¤ºä¾‹ä»»åŠ¡"""
    time.sleep(duration)
    return f"ä»»åŠ¡{task_id}å®Œæˆ"

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    pool = GracefulThreadPool(max_workers=3)
    pool.start()
    
    # æäº¤ä¸€äº›ä»»åŠ¡
    for i in range(8):
        pool.submit(sample_task, i, 1)
    
    # æ¨¡æ‹Ÿè¿è¡Œä¸€æ®µæ—¶é—´åå…³é—­
    try:
        time.sleep(10)
    except KeyboardInterrupt:
        pass
    
    pool.shutdown_gracefully()
```

### 9.3 çº¿ç¨‹é€šä¿¡æœ€ä½³å®è·µæ€»ç»“


**è®¾è®¡åŸåˆ™**ï¼š
```
ğŸ¯ å•ä¸€èŒè´£ï¼šæ¯ä¸ªçº¿ç¨‹è´Ÿè´£ä¸€ç±»ä»»åŠ¡
ğŸ”’ æœ€å°é”å®šï¼šé”çš„èŒƒå›´è¶Šå°è¶Šå¥½
ğŸ“¦ æ— çŠ¶æ€è®¾è®¡ï¼šçº¿ç¨‹é—´é€šè¿‡æ¶ˆæ¯ä¼ é€’ï¼Œä¸å…±äº«å¯å˜çŠ¶æ€
ğŸš« é¿å…æ­»é”ï¼šç»Ÿä¸€é”å®šé¡ºåºï¼Œä½¿ç”¨è¶…æ—¶
âš¡ å¼‚æ­¥ä¼˜å…ˆï¼šèƒ½å¼‚æ­¥å°±ä¸è¦åŒæ­¥é˜»å¡
```

**é€šä¿¡æ–¹å¼é€‰æ‹©æŒ‡å—**ï¼š

| åœºæ™¯ | **æ¨èæ–¹å¼** | **åŸå› ** |
|------|-------------|---------|
| `ç”Ÿäº§è€…-æ¶ˆè´¹è€…` | **Queue** | `å†…ç½®é˜»å¡å’Œçº¿ç¨‹å®‰å…¨` |
| `ç­‰å¾…ä¿¡å·` | **Event** | `ç®€å•çš„çŠ¶æ€é€šçŸ¥` |
| `é›†åˆç­‰å¾…` | **Barrier** | `å¤šçº¿ç¨‹åŒæ­¥ç‚¹` |
| `çº¿ç¨‹ç‹¬ç«‹æ•°æ®` | **ThreadLocal** | `é¿å…æ•°æ®ç«äº‰` |
| `ä»»åŠ¡åˆ†å‘` | **ThreadPoolExecutor** | `ç»Ÿä¸€ç®¡ç†å’Œå¼‚å¸¸å¤„ç†` |

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Queueé˜Ÿåˆ—ï¼šçº¿ç¨‹é—´ä¼ é€’æ•°æ®çš„"ä¼ é€å¸¦"
ğŸ”¸ Eventäº‹ä»¶ï¼šçº¿ç¨‹é—´çš„"çº¢ç»¿ç¯"ä¿¡å·æ§åˆ¶
ğŸ”¸ Barrierå±éšœï¼šå¤šçº¿ç¨‹çš„"é›†åˆç‚¹"åŒæ­¥
ğŸ”¸ ThreadLocalï¼šæ¯ä¸ªçº¿ç¨‹çš„"ç§äººå‚¨ç‰©æŸœ"
ğŸ”¸ ThreadPoolExecutorï¼šç»Ÿä¸€ç®¡ç†çš„"å·¥äººå›¢é˜Ÿ"
ğŸ”¸ å¼‚å¸¸å¤„ç†ï¼šè®©çº¿ç¨‹é”™è¯¯"æœ‰è¿¹å¯å¾ª"
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆéœ€è¦çº¿ç¨‹é€šä¿¡**
```
ç°å®ç±»æ¯”ï¼š
- æ²¡æœ‰é€šä¿¡çš„å¤šçº¿ç¨‹ = å„å¹²å„çš„å·¥äººï¼Œæ•ˆç‡ä½ä¸‹
- æœ‰é€šä¿¡çš„å¤šçº¿ç¨‹ = åè°ƒé…åˆçš„å›¢é˜Ÿï¼Œé«˜æ•ˆåä½œ

æŠ€æœ¯åŸå› ï¼š
- æ•°æ®å…±äº«éœ€è¦å®‰å…¨æœºåˆ¶
- ä»»åŠ¡åè°ƒéœ€è¦åŒæ­¥ç‚¹
- é”™è¯¯å¤„ç†éœ€è¦é€šçŸ¥æœºåˆ¶
```

**ğŸ”¹ é€‰æ‹©åˆé€‚çš„é€šä¿¡æ–¹å¼**
```
æ•°æ®ä¼ é€’ â†’ Queueï¼ˆç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼ï¼‰
çŠ¶æ€é€šçŸ¥ â†’ Eventï¼ˆç­‰å¾…æŸä¸ªæ¡ä»¶æˆç«‹ï¼‰
é›†ä½“è¡ŒåŠ¨ â†’ Barrierï¼ˆæ‰€æœ‰äººéƒ½å‡†å¤‡å¥½å†è¡ŒåŠ¨ï¼‰
ç§æœ‰æ•°æ® â†’ ThreadLocalï¼ˆæ¯ä¸ªçº¿ç¨‹ç‹¬ç«‹å­˜å‚¨ï¼‰
ä»»åŠ¡ç®¡ç† â†’ ThreadPoolï¼ˆç»Ÿä¸€åˆ†é…å’Œç®¡ç†ï¼‰
```

**ğŸ”¹ çº¿ç¨‹å®‰å…¨çš„æœ¬è´¨**
```
é—®é¢˜æ ¹æºï¼šå¤šä¸ªçº¿ç¨‹åŒæ—¶ä¿®æ”¹åŒä¸€æ•°æ®
è§£å†³æ€è·¯ï¼š
- ä¸å…±äº«ï¼šæ¯ä¸ªçº¿ç¨‹ç”¨è‡ªå·±çš„æ•°æ®ï¼ˆThreadLocalï¼‰
- åè°ƒè®¿é—®ï¼šç”¨é”ã€é˜Ÿåˆ—ç­‰æœºåˆ¶æ§åˆ¶è®¿é—®é¡ºåº
- æ¶ˆæ¯ä¼ é€’ï¼šé€šè¿‡Queueç­‰æ–¹å¼ä¼ é€’æ•°æ®å‰¯æœ¬
```

### 10.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ å¸¸è§åº”ç”¨åœºæ™¯**
- **ç½‘ç»œçˆ¬è™«**ï¼šQueueåˆ†å‘URLï¼ŒThreadPoolæ‰§è¡Œçˆ¬å–
- **æ–‡ä»¶å¤„ç†**ï¼šç”Ÿäº§è€…è¯»å–æ–‡ä»¶åˆ—è¡¨ï¼Œæ¶ˆè´¹è€…å¤„ç†æ–‡ä»¶
- **WebæœåŠ¡å™¨**ï¼šThreadPoolå¤„ç†è¯·æ±‚ï¼ŒEventæ§åˆ¶æœåŠ¡å¯åœ
- **æ•°æ®å¤„ç†**ï¼šBarrieråŒæ­¥å¤šé˜¶æ®µè®¡ç®—ï¼ŒThreadLocalå­˜å‚¨ä¸­é—´ç»“æœ

**ğŸ”§ ç¼–ç¨‹å®è·µæŠ€å·§**
- **è®¾è®¡å…ˆè¡Œ**ï¼šå…ˆæƒ³æ¸…æ¥šçº¿ç¨‹é—´çš„åä½œå…³ç³»
- **å¼‚å¸¸ä¼˜å…ˆ**ï¼šæ¯ä¸ªçº¿ç¨‹éƒ½è¦è€ƒè™‘å¼‚å¸¸å¤„ç†
- **ç›‘æ§è°ƒè¯•**ï¼šæ·»åŠ æ—¥å¿—å’ŒçŠ¶æ€ç›‘æ§
- **ä¼˜é›…é€€å‡º**ï¼šç¨‹åºç»“æŸæ—¶è®©çº¿ç¨‹æ­£å¸¸é€€å‡º

### 10.4 å­¦ä¹ è·¯å¾„å»ºè®®


```
ğŸ“š å­¦ä¹ é¡ºåºï¼š
1ï¸âƒ£ ç†è§£åŸºæœ¬æ¦‚å¿µ â†’ çŸ¥é“æ¯ç§æœºåˆ¶çš„ä½œç”¨
2ï¸âƒ£ åŠ¨æ‰‹ç»ƒä¹ ç¤ºä¾‹ â†’ çœ‹æ‡‚ä»£ç è¿è¡Œè¿‡ç¨‹  
3ï¸âƒ£ å®é™…é¡¹ç›®åº”ç”¨ â†’ è§£å†³çœŸå®é—®é¢˜
4ï¸âƒ£ æ€§èƒ½ä¼˜åŒ–è°ƒè¯• â†’ æå‡ä»£ç è´¨é‡

ğŸ¯ æŒæ¡æ ‡å‡†ï¼š
âœ… èƒ½è§£é‡Šæ¯ç§é€šä¿¡æ–¹å¼çš„é€‚ç”¨åœºæ™¯
âœ… èƒ½å†™å‡ºçº¿ç¨‹å®‰å…¨çš„ä»£ç 
âœ… èƒ½å¤„ç†çº¿ç¨‹å¼‚å¸¸å’Œè°ƒè¯•é—®é¢˜
âœ… èƒ½è®¾è®¡åˆç†çš„å¤šçº¿ç¨‹æ¶æ„
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- Queueä¼ æ•°æ®ï¼ŒEventå‘ä¿¡å·
- Barrieré½æ­¥èµ°ï¼ŒThreadLocalå„è‡ªå¥½
- ThreadPoolæ¥ç®¡ç†ï¼Œå¼‚å¸¸å¤„ç†ä¸èƒ½å°‘
- é€šä¿¡åè°ƒæ˜¯å…³é”®ï¼Œçº¿ç¨‹å®‰å…¨æœ€é‡è¦