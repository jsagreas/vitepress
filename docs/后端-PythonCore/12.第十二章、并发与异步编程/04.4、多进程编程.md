---
title: 4ã€å¤šè¿›ç¨‹ç¼–ç¨‹
---
## ğŸ“š ç›®å½•

1. [ä»€ä¹ˆæ˜¯å¤šè¿›ç¨‹ç¼–ç¨‹](#1-ä»€ä¹ˆæ˜¯å¤šè¿›ç¨‹ç¼–ç¨‹)
2. [multiprocessingæ¨¡å—è¯¦è§£](#2-multiprocessingæ¨¡å—è¯¦è§£)
3. [Processç±»ä½¿ç”¨](#3-Processç±»ä½¿ç”¨)
4. [è¿›ç¨‹åˆ›å»ºä¸ç®¡ç†](#4-è¿›ç¨‹åˆ›å»ºä¸ç®¡ç†)
5. [è¿›ç¨‹é—´é€šä¿¡IPC](#5-è¿›ç¨‹é—´é€šä¿¡IPC)
6. [Pipeç®¡é“é€šä¿¡](#6-Pipeç®¡é“é€šä¿¡)
7. [Queueè¿›ç¨‹é˜Ÿåˆ—](#7-Queueè¿›ç¨‹é˜Ÿåˆ—)
8. [Managerå…±äº«çŠ¶æ€](#8-Managerå…±äº«çŠ¶æ€)
9. [è¿›ç¨‹æ± ProcessPoolExecutor](#9-è¿›ç¨‹æ± ProcessPoolExecutor)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”„ ä»€ä¹ˆæ˜¯å¤šè¿›ç¨‹ç¼–ç¨‹


### 1.1 è¿›ç¨‹çš„åŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ è¿›ç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ**
```
ç®€å•ç†è§£ï¼šè¿›ç¨‹å°±åƒä¸€ä¸ªç‹¬ç«‹çš„å·¥å‚è½¦é—´
- æ¯ä¸ªè½¦é—´æœ‰è‡ªå·±çš„è®¾å¤‡ï¼ˆå†…å­˜ç©ºé—´ï¼‰
- æ¯ä¸ªè½¦é—´çš„å·¥äººï¼ˆçº¿ç¨‹ï¼‰ç›¸äº’ç‹¬ç«‹
- è½¦é—´ä¹‹é—´éœ€è¦ç‰¹æ®Šæ–¹å¼æ‰èƒ½æ²Ÿé€š

æŠ€æœ¯å®šä¹‰ï¼šè¿›ç¨‹æ˜¯ç¨‹åºåœ¨è®¡ç®—æœºä¸­çš„ä¸€æ¬¡æ‰§è¡Œå®ä¾‹
ç‰¹ç‚¹ï¼šæ‹¥æœ‰ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ï¼Œç›¸äº’éš”ç¦»
```

**ğŸ’¡ ç”Ÿæ´»ç±»æ¯”**
```
å•è¿›ç¨‹ç¨‹åºï¼šä¸€ä¸ªäººåšæ‰€æœ‰äº‹æƒ…
å¤šçº¿ç¨‹ç¨‹åºï¼šä¸€ä¸ªåŠå…¬å®¤é‡Œå¤šä¸ªäººåä½œ
å¤šè¿›ç¨‹ç¨‹åºï¼šå¤šä¸ªç‹¬ç«‹åŠå…¬å®¤ï¼Œæ¯ä¸ªåŠå…¬å®¤æœ‰è‡ªå·±çš„å›¢é˜Ÿ

ä¼˜åŠ¿ï¼šå³ä½¿ä¸€ä¸ªåŠå…¬å®¤å‡ºé—®é¢˜ï¼Œå…¶ä»–åŠå…¬å®¤ä¸å—å½±å“
åŠ£åŠ¿ï¼šåŠå…¬å®¤ä¹‹é—´æ²Ÿé€šæ¯”è¾ƒéº»çƒ¦
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦å¤šè¿›ç¨‹


**ğŸ¯ è§£å†³çš„æ ¸å¿ƒé—®é¢˜**
```
1. CPUå¯†é›†å‹ä»»åŠ¡ï¼šå……åˆ†åˆ©ç”¨å¤šæ ¸CPU
2. ç¨‹åºç¨³å®šæ€§ï¼šä¸€ä¸ªè¿›ç¨‹å´©æºƒä¸å½±å“å…¶ä»–è¿›ç¨‹
3. ç»•è¿‡GILé™åˆ¶ï¼šPythonçš„å…¨å±€è§£é‡Šå™¨é”é™åˆ¶å¤šçº¿ç¨‹æ•ˆæœ
4. å†…å­˜éš”ç¦»ï¼šé¿å…ä¸åŒä»»åŠ¡ä¹‹é—´çš„æ•°æ®æ±¡æŸ“
```

**ğŸ“Š é€‚ç”¨åœºæ™¯å¯¹æ¯”**
| åœºæ™¯ç±»å‹ | **å¤šè¿›ç¨‹** | **å¤šçº¿ç¨‹** | **å¼‚æ­¥** |
|---------|-----------|-----------|---------|
| ğŸ§® **CPUå¯†é›†å‹** | `âœ… æœ€ä½³é€‰æ‹©` | `âŒ å—GILé™åˆ¶` | `âŒ ä¸é€‚åˆ` |
| ğŸŒ **IOå¯†é›†å‹** | `âš–ï¸ å¯ä»¥ä½†æµªè´¹` | `âœ… åˆé€‚` | `âœ… æœ€ä½³` |
| ğŸ’¾ **å†…å­˜è¦æ±‚** | `âŒ æ¶ˆè€—å¤§` | `âœ… æ¶ˆè€—å°` | `âœ… æ¶ˆè€—å°` |
| ğŸ”’ **æ•°æ®å®‰å…¨** | `âœ… å¤©ç„¶éš”ç¦»` | `âš ï¸ éœ€è¦é”` | `âœ… å•çº¿ç¨‹` |

---

## 2. ğŸ› ï¸ multiprocessingæ¨¡å—è¯¦è§£


### 2.1 æ¨¡å—æ¶æ„æ¦‚è§ˆ


**ğŸ—ï¸ æ ¸å¿ƒç»„ä»¶å…³ç³»å›¾**
```
multiprocessing æ¨¡å—
â”œâ”€â”€ Process ç±» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ åˆ›å»ºå’Œç®¡ç†è¿›ç¨‹
â”œâ”€â”€ é€šä¿¡æœºåˆ¶
â”‚   â”œâ”€â”€ Queue â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ è¿›ç¨‹é—´æ¶ˆæ¯é˜Ÿåˆ—
â”‚   â”œâ”€â”€ Pipe â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ åŒå‘ç®¡é“é€šä¿¡
â”‚   â””â”€â”€ Manager â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å…±äº«æ•°æ®ç®¡ç†å™¨
â”œâ”€â”€ åŒæ­¥åŸè¯­
â”‚   â”œâ”€â”€ Lock â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ è¿›ç¨‹é”
â”‚   â”œâ”€â”€ Event â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ äº‹ä»¶é€šçŸ¥
â”‚   â””â”€â”€ Semaphore â”€â”€â”€â”€â”€â”€â”€ ä¿¡å·é‡
â””â”€â”€ è¿›ç¨‹æ± 
    â””â”€â”€ Pool/ProcessPoolExecutor â”€â”€ è¿›ç¨‹æ± ç®¡ç†
```

### 2.2 æ¨¡å—å¯¼å…¥å’ŒåŸºæœ¬ä½¿ç”¨


```python
import multiprocessing as mp
from multiprocessing import Process, Queue, Pipe, Manager
from concurrent.futures import ProcessPoolExecutor

# æŸ¥çœ‹CPUæ ¸å¿ƒæ•°
print(f"CPUæ ¸å¿ƒæ•°: {mp.cpu_count()}")
```

**âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹**
```
Windowsç³»ç»Ÿç‰¹åˆ«è¦æ±‚ï¼š
å¿…é¡»åœ¨ if __name__ == '__main__': ä¸­å¯åŠ¨è¿›ç¨‹
åŸå› ï¼šWindowsåˆ›å»ºè¿›ç¨‹æ—¶ä¼šé‡æ–°å¯¼å…¥æ¨¡å—
```

---

## 3. ğŸš€ Processç±»ä½¿ç”¨


### 3.1 Processç±»åŸºç¡€


**ğŸ”¸ Processç±»æ˜¯ä»€ä¹ˆï¼Ÿ**
```
Processç±»å°±åƒä¸€ä¸ª"è¿›ç¨‹å·¥å‚"
ä½œç”¨ï¼šå¸®ä½ åˆ›å»ºä¸€ä¸ªæ–°çš„ç‹¬ç«‹è¿›ç¨‹
ç±»æ¯”ï¼šå°±åƒå¼€è®¾ä¸€ä¸ªæ–°çš„åˆ†å…¬å¸ï¼Œæœ‰è‡ªå·±çš„å‘˜å·¥å’ŒåŠå…¬åœºæ‰€
```

**ğŸ“‹ Processç±»çš„æ ¸å¿ƒå‚æ•°**
```python
Process(
    target=å‡½æ•°å,      # æ–°è¿›ç¨‹è¦æ‰§è¡Œçš„å‡½æ•°
    args=å‚æ•°å…ƒç»„,      # ä¼ ç»™å‡½æ•°çš„å‚æ•°
    kwargs=å…³é”®å­—å‚æ•°,   # ä¼ ç»™å‡½æ•°çš„å…³é”®å­—å‚æ•°
    name=è¿›ç¨‹åç§°       # ç»™è¿›ç¨‹èµ·ä¸ªåå­—ï¼Œæ–¹ä¾¿ç®¡ç†
)
```

### 3.2 åˆ›å»ºç¬¬ä¸€ä¸ªè¿›ç¨‹


**ğŸ”° åŸºç¡€ç¤ºä¾‹**
```python
import multiprocessing
import time

def worker_job(name, work_time):
    """å·¥äººçš„å·¥ä½œå‡½æ•°"""
    print(f"å·¥äºº {name} å¼€å§‹å·¥ä½œ")
    time.sleep(work_time)  # æ¨¡æ‹Ÿå·¥ä½œæ—¶é—´
    print(f"å·¥äºº {name} å®Œæˆå·¥ä½œ")

if __name__ == '__main__':
    # åˆ›å»ºä¸€ä¸ªæ–°è¿›ç¨‹
    worker = multiprocessing.Process(
        target=worker_job,      # æŒ‡å®šå·¥ä½œå‡½æ•°
        args=('å°ç‹', 2),       # ä¼ é€’å‚æ•°ï¼šå§“åå’Œå·¥ä½œæ—¶é—´
        name='Worker-1'         # ç»™è¿›ç¨‹å‘½å
    )
    
    print("ä¸»è¿›ç¨‹ï¼šå‡†å¤‡å®‰æ’å·¥ä½œ")
    worker.start()              # å¯åŠ¨è¿›ç¨‹
    worker.join()               # ç­‰å¾…è¿›ç¨‹å®Œæˆ
    print("ä¸»è¿›ç¨‹ï¼šæ‰€æœ‰å·¥ä½œå®Œæˆ")
```

**ğŸ” æ‰§è¡Œæµç¨‹è§£æ**
```
ä¸»è¿›ç¨‹æµç¨‹ï¼š
åˆ›å»ºProcesså¯¹è±¡ â†’ start()å¯åŠ¨ â†’ join()ç­‰å¾… â†’ è¿›ç¨‹ç»“æŸ

å­è¿›ç¨‹æµç¨‹ï¼š
æ¥æ”¶ä»»åŠ¡ â†’ æ‰§è¡Œworker_jobå‡½æ•° â†’ è¿”å›ç»“æœ â†’ è¿›ç¨‹ç»ˆæ­¢

æ—¶é—´çº¿ï¼š
[ä¸»è¿›ç¨‹] åˆ›å»ºè¿›ç¨‹å¯¹è±¡
[ä¸»è¿›ç¨‹] è°ƒç”¨start()
[å­è¿›ç¨‹] å¼€å§‹æ‰§è¡Œworker_job
[ä¸»è¿›ç¨‹] è°ƒç”¨join()ï¼Œè¿›å…¥ç­‰å¾…çŠ¶æ€
[å­è¿›ç¨‹] å®Œæˆå·¥ä½œï¼Œè¿›ç¨‹ç»“æŸ
[ä¸»è¿›ç¨‹] join()è¿”å›ï¼Œç»§ç»­æ‰§è¡Œ
```

### 3.3 Processç±»çš„é‡è¦æ–¹æ³•


**ğŸ“š å¸¸ç”¨æ–¹æ³•è¯¦è§£**

| æ–¹æ³• | **ä½œç”¨** | **ä½¿ç”¨æ—¶æœº** | **æ³¨æ„äº‹é¡¹** |
|------|---------|-------------|-------------|
| `start()` | `å¯åŠ¨è¿›ç¨‹` | `åˆ›å»ºProcesså¯¹è±¡å` | `åªèƒ½è°ƒç”¨ä¸€æ¬¡` |
| `join()` | `ç­‰å¾…è¿›ç¨‹ç»“æŸ` | `éœ€è¦åŒæ­¥æ—¶` | `ä¼šé˜»å¡ä¸»è¿›ç¨‹` |
| `is_alive()` | `æ£€æŸ¥è¿›ç¨‹æ˜¯å¦è¿è¡Œ` | `éœ€è¦ç›‘æ§çŠ¶æ€æ—¶` | `è¿”å›True/False` |
| `terminate()` | `å¼ºåˆ¶ç»ˆæ­¢è¿›ç¨‹` | `ç´§æ€¥åœæ­¢æ—¶` | `å¯èƒ½ä¸¢å¤±æ•°æ®` |

**ğŸ’¡ æ–¹æ³•ä½¿ç”¨ç¤ºä¾‹**
```python
import multiprocessing
import time

def long_task():
    """ä¸€ä¸ªè€—æ—¶ä»»åŠ¡"""
    for i in range(10):
        print(f"ä»»åŠ¡è¿›è¡Œä¸­... {i+1}/10")
        time.sleep(1)

if __name__ == '__main__':
    # åˆ›å»ºè¿›ç¨‹
    process = multiprocessing.Process(target=long_task)
    
    # å¯åŠ¨è¿›ç¨‹
    print("å¯åŠ¨ä»»åŠ¡...")
    process.start()
    
    # æ£€æŸ¥è¿›ç¨‹çŠ¶æ€
    time.sleep(3)
    if process.is_alive():
        print("è¿›ç¨‹ä»åœ¨è¿è¡Œ")
    
    # ç­‰å¾…5ç§’åå¼ºåˆ¶ç»ˆæ­¢
    time.sleep(2)
    process.terminate()  # å¼ºåˆ¶ç»ˆæ­¢
    process.join()       # æ¸…ç†è¿›ç¨‹èµ„æº
    print("ä»»åŠ¡å·²ç»ˆæ­¢")
```

---

## 4. âš™ï¸ è¿›ç¨‹åˆ›å»ºä¸ç®¡ç†


### 4.1 å¤šç§åˆ›å»ºè¿›ç¨‹çš„æ–¹å¼


**ğŸ¯ æ–¹å¼ä¸€ï¼šç›´æ¥ä½¿ç”¨Processç±»**
```python
def calculate_square(numbers, result_queue):
    """è®¡ç®—æ•°å­—çš„å¹³æ–¹"""
    results = [x * x for x in numbers]
    result_queue.put(results)

if __name__ == '__main__':
    queue = multiprocessing.Queue()
    
    # åˆ›å»ºå¤šä¸ªè¿›ç¨‹å¤„ç†ä¸åŒæ•°æ®
    processes = []
    data_chunks = [[1, 2, 3], [4, 5, 6], [7, 8, 9]]
    
    for i, chunk in enumerate(data_chunks):
        p = multiprocessing.Process(
            target=calculate_square,
            args=(chunk, queue),
            name=f'Calculator-{i+1}'
        )
        processes.append(p)
        p.start()
    
    # ç­‰å¾…æ‰€æœ‰è¿›ç¨‹å®Œæˆ
    for p in processes:
        p.join()
    
    # æ”¶é›†ç»“æœ
    results = []
    while not queue.empty():
        results.append(queue.get())
    
    print("è®¡ç®—ç»“æœ:", results)
```

**ğŸ¯ æ–¹å¼äºŒï¼šç»§æ‰¿Processç±»**
```python
class CalculatorProcess(multiprocessing.Process):
    """è‡ªå®šä¹‰è®¡ç®—å™¨è¿›ç¨‹ç±»"""
    
    def __init__(self, numbers, name):
        super().__init__()
        self.numbers = numbers
        self.name = name
        self.result = None
    
    def run(self):
        """é‡å†™runæ–¹æ³•ï¼Œå®šä¹‰è¿›ç¨‹è¦æ‰§è¡Œçš„ä»»åŠ¡"""
        print(f"{self.name} å¼€å§‹è®¡ç®—...")
        self.result = sum(x * x for x in self.numbers)
        print(f"{self.name} è®¡ç®—å®Œæˆï¼Œç»“æœ: {self.result}")

if __name__ == '__main__':
    # åˆ›å»ºè‡ªå®šä¹‰è¿›ç¨‹å®ä¾‹
    calc1 = CalculatorProcess([1, 2, 3, 4], "è®¡ç®—å™¨1")
    calc2 = CalculatorProcess([5, 6, 7, 8], "è®¡ç®—å™¨2")
    
    # å¯åŠ¨è¿›ç¨‹
    calc1.start()
    calc2.start()
    
    # ç­‰å¾…å®Œæˆ
    calc1.join()
    calc2.join()
    
    print("æ‰€æœ‰è®¡ç®—å®Œæˆ")
```

### 4.2 è¿›ç¨‹ç®¡ç†æœ€ä½³å®è·µ


**ğŸ“Š è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸç®¡ç†**
```
è¿›ç¨‹çŠ¶æ€è½¬æ¢å›¾ï¼š
          start()
åˆ›å»º â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ è¿è¡Œä¸­ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ å®Œæˆ
 â”‚                 â”‚               â†‘
 â”‚                 â”‚ terminate()   â”‚
 â”‚                 â†“               â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ ç»ˆæ­¢çŠ¶æ€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†‘
                join() æ¸…ç†èµ„æº
```

**ğŸ’¡ ç®¡ç†æŠ€å·§**
```python
import multiprocessing
import time
import signal

class ProcessManager:
    """è¿›ç¨‹ç®¡ç†å™¨"""
    
    def __init__(self):
        self.processes = []
    
    def add_task(self, target, args=(), name=None):
        """æ·»åŠ æ–°ä»»åŠ¡"""
        process = multiprocessing.Process(
            target=target, 
            args=args, 
            name=name
        )
        self.processes.append(process)
        return process
    
    def start_all(self):
        """å¯åŠ¨æ‰€æœ‰è¿›ç¨‹"""
        for p in self.processes:
            p.start()
            print(f"å¯åŠ¨è¿›ç¨‹: {p.name}")
    
    def wait_all(self, timeout=None):
        """ç­‰å¾…æ‰€æœ‰è¿›ç¨‹å®Œæˆ"""
        for p in self.processes:
            p.join(timeout)
            if p.is_alive():
                print(f"è¿›ç¨‹ {p.name} è¶…æ—¶ï¼Œå¼ºåˆ¶ç»ˆæ­¢")
                p.terminate()
                p.join()
    
    def status_report(self):
        """è¿›ç¨‹çŠ¶æ€æŠ¥å‘Š"""
        alive_count = sum(1 for p in self.processes if p.is_alive())
        print(f"è¿›ç¨‹çŠ¶æ€: {alive_count}/{len(self.processes)} æ­£åœ¨è¿è¡Œ")

# ä½¿ç”¨ç¤ºä¾‹
def worker_task(task_id, duration):
    print(f"ä»»åŠ¡ {task_id} å¼€å§‹æ‰§è¡Œ")
    time.sleep(duration)
    print(f"ä»»åŠ¡ {task_id} æ‰§è¡Œå®Œæˆ")

if __name__ == '__main__':
    manager = ProcessManager()
    
    # æ·»åŠ å¤šä¸ªä»»åŠ¡
    manager.add_task(worker_task, (1, 2), "ä»»åŠ¡1")
    manager.add_task(worker_task, (2, 3), "ä»»åŠ¡2")
    manager.add_task(worker_task, (3, 1), "ä»»åŠ¡3")
    
    # æ‰¹é‡ç®¡ç†
    manager.start_all()
    manager.status_report()
    manager.wait_all(timeout=5)  # æœ€å¤šç­‰å¾…5ç§’
    print("æ‰€æœ‰ä»»åŠ¡å¤„ç†å®Œæˆ")
```

---

## 5. ğŸ“¡ è¿›ç¨‹é—´é€šä¿¡IPC


### 5.1 ä¸ºä»€ä¹ˆéœ€è¦è¿›ç¨‹é—´é€šä¿¡


**ğŸ”¸ IPCçš„å¿…è¦æ€§**
```
é—®é¢˜ï¼šä¸åŒè¿›ç¨‹æœ‰ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ï¼Œæ— æ³•ç›´æ¥å…±äº«æ•°æ®
ç±»æ¯”ï¼šä¸åŒåŸå¸‚çš„åˆ†å…¬å¸éœ€è¦é€šè¿‡é‚®ä»¶ã€ç”µè¯ç­‰æ–¹å¼æ²Ÿé€š
è§£å†³ï¼šä½¿ç”¨ç‰¹æ®Šçš„é€šä¿¡æœºåˆ¶åœ¨è¿›ç¨‹é—´ä¼ é€’æ•°æ®

IPC = Inter-Process Communicationï¼ˆè¿›ç¨‹é—´é€šä¿¡ï¼‰
```

**ğŸ¯ å¸¸è§IPCæ–¹å¼å¯¹æ¯”**
| æ–¹å¼ | **ç‰¹ç‚¹** | **é€‚ç”¨åœºæ™¯** | **æ•°æ®é‡** |
|------|---------|-------------|-----------|
| ğŸš‡ **Queue** | `å…ˆè¿›å…ˆå‡ºï¼Œçº¿ç¨‹å®‰å…¨` | `ä»»åŠ¡åˆ†å‘ï¼Œç»“æœæ”¶é›†` | `ä¸­ç­‰` |
| ğŸ”— **Pipe** | `åŒå‘ç®¡é“ï¼Œé€Ÿåº¦å¿«` | `ä¸¤ä¸ªè¿›ç¨‹ç›´æ¥é€šä¿¡` | `å°åˆ°ä¸­ç­‰` |
| ğŸ—ƒï¸ **Manager** | `å…±äº«å¤æ‚æ•°æ®ç»“æ„` | `å¤šè¿›ç¨‹å…±äº«çŠ¶æ€` | `ä»»æ„` |
| ğŸ’¾ **å…±äº«å†…å­˜** | `é€Ÿåº¦æœ€å¿«` | `å¤§é‡æ•°æ®å…±äº«` | `å¤§` |

### 5.2 IPCåŸºæœ¬åŸç†


**ğŸ”§ é€šä¿¡æœºåˆ¶ç¤ºæ„å›¾**
```
è¿›ç¨‹A                    é€šä¿¡åª’ä»‹                    è¿›ç¨‹B
â”Œâ”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”
â”‚æ•°æ®Aâ”‚ â”€â”€â”€â”€ put() â”€â”€â”€â”€â†’ â”‚Queueâ”‚ â”€â”€â”€â”€ get() â”€â”€â”€â”€â†’ â”‚æ¥æ”¶â”‚
â””â”€â”€â”€â”€â”€â”˜                  â”‚ ä¸­è½¬â”‚                   â””â”€â”€â”€â”€â”€â”˜
                         â”‚ ç«™  â”‚
â”Œâ”€â”€â”€â”€â”€â”                  â”‚     â”‚                   â”Œâ”€â”€â”€â”€â”€â”
â”‚ç»“æœâ”‚ â†â”€â”€â”€ get() â”€â”€â”€â”€â”€â”€ â”‚     â”‚ â†â”€â”€â”€ put() â”€â”€â”€â”€â”€â”€ â”‚æ•°æ®Bâ”‚
â””â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”˜
```

**âš ï¸ IPCæ³¨æ„äº‹é¡¹**
```
æ•°æ®åºåˆ—åŒ–ï¼š
- è¿›ç¨‹é—´ä¼ é€’çš„æ•°æ®ä¼šè¢«åºåˆ—åŒ–ï¼ˆpickleï¼‰
- åªèƒ½ä¼ é€’å¯åºåˆ—åŒ–çš„å¯¹è±¡
- å‡½æ•°ã€ç±»å®ä¾‹ç­‰éœ€è¦ç‰¹æ®Šå¤„ç†

æ€§èƒ½è€ƒè™‘ï¼š
- æ•°æ®å¤åˆ¶æœ‰å¼€é”€ï¼Œé¿å…ä¼ é€’å¤§å¯¹è±¡
- é¢‘ç¹é€šä¿¡ä¼šå½±å“æ€§èƒ½
- é€‰æ‹©åˆé€‚çš„IPCæ–¹å¼å¾ˆé‡è¦
```

---

## 6. ğŸ”— Pipeç®¡é“é€šä¿¡


### 6.1 Pipeçš„åŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯Pipeï¼Ÿ**
```
Pipeï¼ˆç®¡é“ï¼‰å°±åƒä¸¤ä¸ªæˆ¿é—´ä¹‹é—´çš„å¯¹è®²æœº
ç‰¹ç‚¹ï¼š
- åŒå‘é€šä¿¡ï¼šä¸¤ç«¯éƒ½å¯ä»¥å‘é€å’Œæ¥æ”¶
- ç‚¹å¯¹ç‚¹ï¼šåªè¿æ¥ä¸¤ä¸ªè¿›ç¨‹
- é€Ÿåº¦å¿«ï¼šç›´æ¥å†…å­˜é€šä¿¡ï¼Œå¼€é”€å°
```

### 6.2 Pipeçš„åŸºæœ¬ä½¿ç”¨


**ğŸ”° ç®€å•ç¤ºä¾‹**
```python
import multiprocessing

def sender_process(conn, messages):
    """å‘é€è€…è¿›ç¨‹"""
    for msg in messages:
        print(f"å‘é€: {msg}")
        conn.send(msg)
    conn.send("END")  # å‘é€ç»“æŸä¿¡å·
    conn.close()

def receiver_process(conn):
    """æ¥æ”¶è€…è¿›ç¨‹"""
    while True:
        msg = conn.recv()
        if msg == "END":
            break
        print(f"æ¥æ”¶: {msg}")
    conn.close()

if __name__ == '__main__':
    # åˆ›å»ºç®¡é“
    parent_conn, child_conn = multiprocessing.Pipe()
    
    # åˆ›å»ºè¿›ç¨‹
    sender = multiprocessing.Process(
        target=sender_process, 
        args=(parent_conn, ["Hello", "World", "Python"])
    )
    receiver = multiprocessing.Process(
        target=receiver_process, 
        args=(child_conn,)
    )
    
    # å¯åŠ¨è¿›ç¨‹
    sender.start()
    receiver.start()
    
    # ç­‰å¾…å®Œæˆ
    sender.join()
    receiver.join()
    
    print("é€šä¿¡å®Œæˆ")
```

### 6.3 Pipeçš„é«˜çº§ç”¨æ³•


**ğŸ“Š åŒå‘é€šä¿¡ç¤ºä¾‹**
```python
def calculator_process(conn):
    """è®¡ç®—å™¨è¿›ç¨‹"""
    print("è®¡ç®—å™¨è¿›ç¨‹å¯åŠ¨ï¼Œç­‰å¾…è®¡ç®—ä»»åŠ¡...")
    
    while True:
        # æ¥æ”¶ä»»åŠ¡
        task = conn.recv()
        if task == "QUIT":
            break
        
        # è§£æä»»åŠ¡
        operation, a, b = task
        
        # è®¡ç®—ç»“æœ
        if operation == "add":
            result = a + b
        elif operation == "multiply":
            result = a * b
        else:
            result = "æœªçŸ¥æ“ä½œ"
        
        # å‘é€ç»“æœ
        conn.send(f"{a} {operation} {b} = {result}")
    
    conn.close()
    print("è®¡ç®—å™¨è¿›ç¨‹ç»“æŸ")

if __name__ == '__main__':
    # åˆ›å»ºåŒå‘ç®¡é“
    main_conn, calc_conn = multiprocessing.Pipe()
    
    # å¯åŠ¨è®¡ç®—å™¨è¿›ç¨‹
    calculator = multiprocessing.Process(
        target=calculator_process, 
        args=(calc_conn,)
    )
    calculator.start()
    
    # ä¸»è¿›ç¨‹å‘é€ä»»åŠ¡å¹¶æ¥æ”¶ç»“æœ
    tasks = [
        ("add", 10, 20),
        ("multiply", 5, 6),
        ("add", 100, 200)
    ]
    
    for task in tasks:
        main_conn.send(task)        # å‘é€ä»»åŠ¡
        result = main_conn.recv()   # æ¥æ”¶ç»“æœ
        print(f"è®¡ç®—ç»“æœ: {result}")
    
    # å‘é€é€€å‡ºä¿¡å·
    main_conn.send("QUIT")
    calculator.join()
    main_conn.close()
```

**âš ï¸ Pipeä½¿ç”¨æ³¨æ„äº‹é¡¹**
```
çº¿ç¨‹å®‰å…¨æ€§ï¼š
- Pipeä¸¤ç«¯ä¸èƒ½åœ¨åŒä¸€è¿›ç¨‹çš„å¤šä¸ªçº¿ç¨‹ä¸­åŒæ—¶ä½¿ç”¨
- æ¯ç«¯åªèƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­æ“ä½œ

é˜»å¡ç‰¹æ€§ï¼š
- recv()ä¼šé˜»å¡ç­‰å¾…æ•°æ®
- send()åœ¨ç¼“å†²åŒºæ»¡æ—¶ä¹Ÿä¼šé˜»å¡

é”™è¯¯å¤„ç†ï¼š
- å¯¹ç«¯å…³é—­æ—¶recv()ä¼šæŠ›å‡ºEOFError
- è¦åŠæ—¶close()é‡Šæ”¾èµ„æº
```

---

## 7. ğŸ“‹ Queueè¿›ç¨‹é˜Ÿåˆ—


### 7.1 Queueçš„åŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯Queueï¼Ÿ**
```
Queueï¼ˆé˜Ÿåˆ—ï¼‰å°±åƒé“¶è¡Œçš„æ’é˜Ÿç³»ç»Ÿ
ç‰¹ç‚¹ï¼š
- å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰ï¼šå…ˆæ’é˜Ÿçš„å…ˆæœåŠ¡
- å¤šå¯¹å¤šï¼šå¤šä¸ªè¿›ç¨‹å¯ä»¥åŒæ—¶æ”¾å…¥å’Œå–å‡º
- çº¿ç¨‹å®‰å…¨ï¼šå†…ç½®é”æœºåˆ¶ï¼Œæ— éœ€æ‹…å¿ƒæ•°æ®å†²çª
```

**ğŸ“Š Queue vs æ™®é€šåˆ—è¡¨**
```
æ™®é€šåˆ—è¡¨çš„é—®é¢˜ï¼š
è¿›ç¨‹A: list.append(data)  â†â†’  è¿›ç¨‹B: data = list.pop()
                  â†‘ å†²çªï¼ä¸¤ä¸ªè¿›ç¨‹åŒæ—¶æ“ä½œ

Queueçš„è§£å†³æ–¹æ¡ˆï¼š
è¿›ç¨‹A: queue.put(data)    â†â†’  è¿›ç¨‹B: data = queue.get()
                  â†‘ å®‰å…¨ï¼å†…ç½®é”ä¿æŠ¤
```

### 7.2 QueueåŸºæœ¬æ“ä½œ


**ğŸ”° åŸºç¡€ä½¿ç”¨ç¤ºä¾‹**
```python
import multiprocessing
import time
import random

def producer(queue, producer_id, item_count):
    """ç”Ÿäº§è€…ï¼šå‘é˜Ÿåˆ—ä¸­æ”¾å…¥æ•°æ®"""
    for i in range(item_count):
        # æ¨¡æ‹Ÿç”Ÿäº§æ—¶é—´
        time.sleep(random.uniform(0.1, 0.5))
        
        item = f"äº§å“-{producer_id}-{i+1}"
        queue.put(item)
        print(f"ç”Ÿäº§è€…{producer_id} ç”Ÿäº§: {item}")
    
    # ç”Ÿäº§å®Œæˆä¿¡å·
    queue.put(f"DONE-{producer_id}")

def consumer(queue, consumer_id):
    """æ¶ˆè´¹è€…ï¼šä»é˜Ÿåˆ—ä¸­å–å‡ºæ•°æ®"""
    consumed_count = 0
    done_producers = 0
    
    while True:
        item = queue.get()  # é˜»å¡ç­‰å¾…æ•°æ®
        
        if item.startswith("DONE"):
            done_producers += 1
            print(f"æ¶ˆè´¹è€…{consumer_id} æ”¶åˆ°ç”Ÿäº§è€…å®Œæˆä¿¡å·: {item}")
            if done_producers >= 2:  # å‡è®¾æœ‰2ä¸ªç”Ÿäº§è€…
                break
        else:
            consumed_count += 1
            print(f"æ¶ˆè´¹è€…{consumer_id} æ¶ˆè´¹: {item}")
            time.sleep(random.uniform(0.1, 0.3))  # æ¨¡æ‹Ÿæ¶ˆè´¹æ—¶é—´
    
    print(f"æ¶ˆè´¹è€…{consumer_id} æ€»å…±æ¶ˆè´¹äº† {consumed_count} ä¸ªäº§å“")

if __name__ == '__main__':
    # åˆ›å»ºé˜Ÿåˆ—
    queue = multiprocessing.Queue(maxsize=10)  # æœ€å¤§å®¹é‡10
    
    # åˆ›å»ºç”Ÿäº§è€…è¿›ç¨‹
    producers = []
    for i in range(2):
        p = multiprocessing.Process(
            target=producer, 
            args=(queue, i+1, 5)  # æ¯ä¸ªç”Ÿäº§è€…ç”Ÿäº§5ä¸ªäº§å“
        )
        producers.append(p)
        p.start()
    
    # åˆ›å»ºæ¶ˆè´¹è€…è¿›ç¨‹
    consumers = []
    for i in range(2):
        c = multiprocessing.Process(
            target=consumer, 
            args=(queue, i+1)
        )
        consumers.append(c)
        c.start()
    
    # ç­‰å¾…æ‰€æœ‰è¿›ç¨‹å®Œæˆ
    for p in producers:
        p.join()
    for c in consumers:
        c.join()
    
    print("ç”Ÿäº§æ¶ˆè´¹å®Œæˆ")
```

### 7.3 Queueçš„é‡è¦æ–¹æ³•


**ğŸ“š æ–¹æ³•è¯¦è§£è¡¨**
| æ–¹æ³• | **ä½œç”¨** | **é˜»å¡æ€§** | **ä½¿ç”¨åœºæ™¯** |
|------|---------|-----------|-------------|
| `put(item)` | `æ”¾å…¥æ•°æ®` | `é˜Ÿåˆ—æ»¡æ—¶é˜»å¡` | `ç”Ÿäº§è€…æ”¾å…¥æ•°æ®` |
| `get()` | `å–å‡ºæ•°æ®` | `é˜Ÿåˆ—ç©ºæ—¶é˜»å¡` | `æ¶ˆè´¹è€…å–å‡ºæ•°æ®` |
| `put_nowait(item)` | `éé˜»å¡æ”¾å…¥` | `é˜Ÿåˆ—æ»¡æ—¶æŠ›å¼‚å¸¸` | `ä¸æƒ³ç­‰å¾…çš„æƒ…å†µ` |
| `get_nowait()` | `éé˜»å¡å–å‡º` | `é˜Ÿåˆ—ç©ºæ—¶æŠ›å¼‚å¸¸` | `æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®` |
| `empty()` | `æ£€æŸ¥æ˜¯å¦ä¸ºç©º` | `å¦` | `çŠ¶æ€æ£€æŸ¥` |
| `full()` | `æ£€æŸ¥æ˜¯å¦å·²æ»¡` | `å¦` | `çŠ¶æ€æ£€æŸ¥` |
| `qsize()` | `è·å–é˜Ÿåˆ—å¤§å°` | `å¦` | `ç›‘æ§é˜Ÿåˆ—çŠ¶æ€` |

**ğŸ’¡ é”™è¯¯å¤„ç†ç¤ºä¾‹**
```python
import multiprocessing
from queue import Empty, Full

def safe_queue_operations():
    """å®‰å…¨çš„é˜Ÿåˆ—æ“ä½œç¤ºä¾‹"""
    queue = multiprocessing.Queue(maxsize=2)
    
    # å®‰å…¨çš„putæ“ä½œ
    try:
        queue.put_nowait("æ•°æ®1")
        queue.put_nowait("æ•°æ®2")
        queue.put_nowait("æ•°æ®3")  # è¿™é‡Œä¼šæŠ›å‡ºFullå¼‚å¸¸
    except Full:
        print("é˜Ÿåˆ—å·²æ»¡ï¼Œæ— æ³•æ”¾å…¥æ›´å¤šæ•°æ®")
    
    # å®‰å…¨çš„getæ“ä½œ
    while True:
        try:
            item = queue.get_nowait()
            print(f"å–å‡ºæ•°æ®: {item}")
        except Empty:
            print("é˜Ÿåˆ—ä¸ºç©ºï¼Œæ²¡æœ‰æ›´å¤šæ•°æ®")
            break
    
    print(f"é˜Ÿåˆ—å¤§å°: {queue.qsize()}")

if __name__ == '__main__':
    safe_queue_operations()
```

---

## 8. ğŸ—ƒï¸ Managerå…±äº«çŠ¶æ€


### 8.1 Managerçš„åŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯Managerï¼Ÿ**
```
Managerå°±åƒä¸€ä¸ª"å…±äº«æ•°æ®ç®¡å®¶"
ä½œç”¨ï¼šè®©å¤šä¸ªè¿›ç¨‹å¯ä»¥å…±äº«å¤æ‚çš„æ•°æ®ç»“æ„
ç±»æ¯”ï¼šå°±åƒä¸€ä¸ªå…¬å…±ä»“åº“ï¼Œæ‰€æœ‰éƒ¨é—¨éƒ½å¯ä»¥å­˜å–ç‰©å“

æ”¯æŒçš„æ•°æ®ç±»å‹ï¼š
- listï¼šå…±äº«åˆ—è¡¨
- dictï¼šå…±äº«å­—å…¸  
- Queueï¼šå…±äº«é˜Ÿåˆ—
- Eventï¼šå…±äº«äº‹ä»¶
- Lockï¼šå…±äº«é”
```

### 8.2 ManageråŸºæœ¬ä½¿ç”¨


**ğŸ”° å…±äº«å­—å…¸ç¤ºä¾‹**
```python
import multiprocessing
import time

def update_shared_data(shared_dict, worker_id):
    """æ›´æ–°å…±äº«æ•°æ®çš„å·¥ä½œè¿›ç¨‹"""
    for i in range(5):
        # æ¨¡æ‹Ÿå·¥ä½œ
        time.sleep(0.5)
        
        # æ›´æ–°å…±äº«å­—å…¸
        key = f"worker_{worker_id}_task_{i+1}"
        shared_dict[key] = f"å®Œæˆæ—¶é—´: {time.time():.2f}"
        
        print(f"å·¥ä½œè€…{worker_id} å®Œæˆä»»åŠ¡ {i+1}")

def monitor_progress(shared_dict, total_workers):
    """ç›‘æ§è¿›åº¦çš„è¿›ç¨‹"""
    while True:
        time.sleep(1)
        current_tasks = len(shared_dict)
        total_tasks = total_workers * 5
        
        print(f"è¿›åº¦ç›‘æ§: {current_tasks}/{total_tasks} ä»»åŠ¡å®Œæˆ")
        
        if current_tasks >= total_tasks:
            print("æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼")
            break

if __name__ == '__main__':
    # åˆ›å»ºManager
    with multiprocessing.Manager() as manager:
        # åˆ›å»ºå…±äº«å­—å…¸
        shared_dict = manager.dict()
        
        # åˆ›å»ºå·¥ä½œè¿›ç¨‹
        workers = []
        num_workers = 3
        
        for i in range(num_workers):
            worker = multiprocessing.Process(
                target=update_shared_data,
                args=(shared_dict, i+1)
            )
            workers.append(worker)
            worker.start()
        
        # åˆ›å»ºç›‘æ§è¿›ç¨‹
        monitor = multiprocessing.Process(
            target=monitor_progress,
            args=(shared_dict, num_workers)
        )
        monitor.start()
        
        # ç­‰å¾…æ‰€æœ‰å·¥ä½œè¿›ç¨‹å®Œæˆ
        for worker in workers:
            worker.join()
        
        # ç­‰å¾…ç›‘æ§è¿›ç¨‹å®Œæˆ
        monitor.join()
        
        # æŸ¥çœ‹æœ€ç»ˆç»“æœ
        print("\næœ€ç»ˆç»“æœ:")
        for key, value in shared_dict.items():
            print(f"{key}: {value}")
```

### 8.3 Managerçš„é«˜çº§åº”ç”¨


**ğŸ“Š å¤šè¿›ç¨‹ä»»åŠ¡çŠ¶æ€ç®¡ç†**
```python
import multiprocessing
import time
import random

class TaskManager:
    """ä»»åŠ¡ç®¡ç†å™¨"""
    
    def __init__(self, manager):
        self.tasks = manager.list()        # ä»»åŠ¡åˆ—è¡¨
        self.results = manager.dict()      # ç»“æœå­—å…¸
        self.status = manager.dict()       # çŠ¶æ€å­—å…¸
        self.lock = manager.Lock()         # å…±äº«é”
        
        # åˆå§‹åŒ–çŠ¶æ€
        self.status['completed'] = 0
        self.status['failed'] = 0
        self.status['total'] = 0

def task_worker(task_manager, worker_id):
    """ä»»åŠ¡æ‰§è¡Œå™¨"""
    while True:
        # çº¿ç¨‹å®‰å…¨åœ°è·å–ä»»åŠ¡
        with task_manager.lock:
            if not task_manager.tasks:
                break
            task = task_manager.tasks.pop(0)
        
        print(f"å·¥ä½œè€…{worker_id} å¼€å§‹æ‰§è¡Œä»»åŠ¡: {task}")
        
        # æ¨¡æ‹Ÿä»»åŠ¡æ‰§è¡Œ
        try:
            execution_time = random.uniform(1, 3)
            time.sleep(execution_time)
            
            # éšæœºæ¨¡æ‹ŸæˆåŠŸ/å¤±è´¥
            if random.random() < 0.8:  # 80% æˆåŠŸç‡
                result = f"ä»»åŠ¡{task}æ‰§è¡ŒæˆåŠŸï¼Œè€—æ—¶{execution_time:.2f}ç§’"
                with task_manager.lock:
                    task_manager.results[task] = result
                    task_manager.status['completed'] += 1
                print(f"å·¥ä½œè€…{worker_id} å®Œæˆä»»åŠ¡: {task}")
            else:
                raise Exception("æ¨¡æ‹Ÿä»»åŠ¡å¤±è´¥")
                
        except Exception as e:
            with task_manager.lock:
                task_manager.results[task] = f"ä»»åŠ¡å¤±è´¥: {str(e)}"
                task_manager.status['failed'] += 1
            print(f"å·¥ä½œè€…{worker_id} ä»»åŠ¡å¤±è´¥: {task}")

if __name__ == '__main__':
    with multiprocessing.Manager() as manager:
        # åˆ›å»ºä»»åŠ¡ç®¡ç†å™¨
        task_manager = TaskManager(manager)
        
        # æ·»åŠ ä»»åŠ¡
        tasks = [f"Task-{i+1}" for i in range(10)]
        task_manager.tasks.extend(tasks)
        task_manager.status['total'] = len(tasks)
        
        # åˆ›å»ºå¤šä¸ªå·¥ä½œè¿›ç¨‹
        workers = []
        num_workers = 3
        
        for i in range(num_workers):
            worker = multiprocessing.Process(
                target=task_worker,
                args=(task_manager, i+1)
            )
            workers.append(worker)
            worker.start()
        
        # ç­‰å¾…æ‰€æœ‰å·¥ä½œè¿›ç¨‹å®Œæˆ
        for worker in workers:
            worker.join()
        
        # æ˜¾ç¤ºæœ€ç»ˆç»Ÿè®¡
        print("\n=== ä»»åŠ¡æ‰§è¡Œç»Ÿè®¡ ===")
        print(f"æ€»ä»»åŠ¡æ•°: {task_manager.status['total']}")
        print(f"æˆåŠŸå®Œæˆ: {task_manager.status['completed']}")
        print(f"æ‰§è¡Œå¤±è´¥: {task_manager.status['failed']}")
        
        print("\n=== è¯¦ç»†ç»“æœ ===")
        for task, result in task_manager.results.items():
            print(f"{task}: {result}")
```

**âš ï¸ Manageræ€§èƒ½æ³¨æ„äº‹é¡¹**
```
æ€§èƒ½å¼€é”€ï¼š
- Manageråˆ›å»ºçš„å¯¹è±¡é€šè¿‡ç½‘ç»œåè®®é€šä¿¡
- æ¯æ¬¡è®¿é—®éƒ½æœ‰åºåˆ—åŒ–/ååºåˆ—åŒ–å¼€é”€
- æ¯”æœ¬åœ°å¯¹è±¡æ…¢å¾ˆå¤š

ä½¿ç”¨å»ºè®®ï¼š
- é€‚åˆå…±äº«çŠ¶æ€ç®¡ç†ï¼Œä¸é€‚åˆé¢‘ç¹æ•°æ®äº¤æ¢
- å°½é‡æ‰¹é‡æ“ä½œï¼Œå‡å°‘è®¿é—®æ¬¡æ•°
- è€ƒè™‘ä½¿ç”¨é”å‡å°‘ç«äº‰
```

---

## 9. ğŸŠâ€â™‚ï¸ è¿›ç¨‹æ± ProcessPoolExecutor


### 9.1 è¿›ç¨‹æ± çš„æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯è¿›ç¨‹æ± ï¼Ÿ**
```
è¿›ç¨‹æ± å°±åƒä¸€ä¸ª"å·¥äººå›¢é˜Ÿç®¡ç†ç³»ç»Ÿ"
ä¼˜åŠ¿ï¼š
- é¿å…é¢‘ç¹åˆ›å»ºé”€æ¯è¿›ç¨‹çš„å¼€é”€
- è‡ªåŠ¨ç®¡ç†è¿›ç¨‹æ•°é‡
- æä¾›ç®€å•æ˜“ç”¨çš„ä»»åŠ¡æäº¤æ¥å£
- è‡ªåŠ¨æ”¶é›†ä»»åŠ¡ç»“æœ

ç±»æ¯”ï¼š
ä¼ ç»Ÿæ–¹å¼ï¼šæ¯ä¸ªä»»åŠ¡éƒ½ä¸´æ—¶æ‹›è˜ä¸€ä¸ªå·¥äºº
è¿›ç¨‹æ± æ–¹å¼ï¼šç»´æŠ¤ä¸€ä¸ªå›ºå®šçš„å·¥äººå›¢é˜Ÿï¼Œä»»åŠ¡æ¥äº†å°±åˆ†é…
```

### 9.2 ProcessPoolExecutoråŸºæœ¬ä½¿ç”¨


**ğŸ”° åŸºç¡€ç¤ºä¾‹**
```python
from concurrent.futures import ProcessPoolExecutor
import time

def calculate_square(number):
    """è®¡ç®—å¹³æ–¹æ•°"""
    print(f"è®¡ç®— {number} çš„å¹³æ–¹")
    time.sleep(1)  # æ¨¡æ‹Ÿè®¡ç®—æ—¶é—´
    result = number * number
    print(f"{number}Â² = {result}")
    return result

if __name__ == '__main__':
    numbers = [1, 2, 3, 4, 5, 6, 7, 8]
    
    # ä½¿ç”¨è¿›ç¨‹æ± 
    with ProcessPoolExecutor(max_workers=4) as executor:
        print("æäº¤ä»»åŠ¡åˆ°è¿›ç¨‹æ± ...")
        
        # æ–¹å¼1ï¼šmapæ–¹æ³•ï¼ˆæ‰¹é‡å¤„ç†ï¼‰
        start_time = time.time()
        results = list(executor.map(calculate_square, numbers))
        end_time = time.time()
        
        print(f"æ‰€æœ‰ç»“æœ: {results}")
        print(f"æ€»è€—æ—¶: {end_time - start_time:.2f}ç§’")
```

**ğŸ” æ‰§è¡Œè¿‡ç¨‹åˆ†æ**
```
æ—¶é—´çº¿åˆ†æï¼š
æ— è¿›ç¨‹æ± ï¼ˆä¸²è¡Œï¼‰ï¼š8ä¸ªä»»åŠ¡ Ã— 1ç§’ = 8ç§’
æœ‰è¿›ç¨‹æ± ï¼ˆ4è¿›ç¨‹ï¼‰ï¼š8ä¸ªä»»åŠ¡ Ã· 4è¿›ç¨‹ Ã— 1ç§’ = 2ç§’

æ‰§è¡Œæµç¨‹ï¼š
1. åˆ›å»º4ä¸ªå·¥ä½œè¿›ç¨‹
2. ä»»åŠ¡1-4åˆ†é…ç»™4ä¸ªè¿›ç¨‹
3. è¿›ç¨‹å®Œæˆåï¼Œä»»åŠ¡5-8ç»§ç»­åˆ†é…
4. æ‰€æœ‰ä»»åŠ¡å®Œæˆåï¼Œæ”¶é›†ç»“æœ
```

### 9.3 è¿›ç¨‹æ± çš„é«˜çº§ç”¨æ³•


**ğŸ“Š submitæ–¹æ³•ä¸Futureå¯¹è±¡**
```python
from concurrent.futures import ProcessPoolExecutor, as_completed
import time
import random

def download_task(url, file_size):
    """æ¨¡æ‹Ÿæ–‡ä»¶ä¸‹è½½ä»»åŠ¡"""
    print(f"å¼€å§‹ä¸‹è½½: {url}")
    
    # æ¨¡æ‹Ÿä¸‹è½½æ—¶é—´ï¼ˆæ–‡ä»¶è¶Šå¤§è¶Šæ…¢ï¼‰
    download_time = file_size / 10.0 + random.uniform(0.5, 1.5)
    time.sleep(download_time)
    
    result = {
        'url': url,
        'size': file_size,
        'time': download_time,
        'status': 'success'
    }
    
    print(f"ä¸‹è½½å®Œæˆ: {url} ({file_size}MB)")
    return result

if __name__ == '__main__':
    # æ¨¡æ‹Ÿä¸‹è½½ä»»åŠ¡åˆ—è¡¨
    download_list = [
        ("file1.zip", 50),
        ("file2.mp4", 200),
        ("file3.pdf", 10),
        ("file4.iso", 500),
        ("file5.txt", 1)
    ]
    
    # ä½¿ç”¨submitæ–¹æ³•æäº¤ä»»åŠ¡
    with ProcessPoolExecutor(max_workers=3) as executor:
        # æäº¤æ‰€æœ‰ä»»åŠ¡ï¼Œè·å¾—Futureå¯¹è±¡
        future_to_task = {
            executor.submit(download_task, url, size): (url, size)
            for url, size in download_list
        }
        
        print("æ‰€æœ‰ä»»åŠ¡å·²æäº¤ï¼Œç­‰å¾…å®Œæˆ...")
        
        # æŒ‰å®Œæˆé¡ºåºå¤„ç†ç»“æœ
        completed_count = 0
        for future in as_completed(future_to_task):
            completed_count += 1
            url, size = future_to_task[future]
            
            try:
                result = future.result()  # è·å–ä»»åŠ¡ç»“æœ
                print(f"[{completed_count}/5] {url} ä¸‹è½½æˆåŠŸ")
                print(f"  æ–‡ä»¶å¤§å°: {result['size']}MB")
                print(f"  ä¸‹è½½æ—¶é—´: {result['time']:.2f}ç§’")
            except Exception as e:
                print(f"[{completed_count}/5] {url} ä¸‹è½½å¤±è´¥: {e}")
            
            print("-" * 40)
        
        print("æ‰€æœ‰ä¸‹è½½ä»»åŠ¡å®Œæˆï¼")
```

**ğŸ“ˆ ä»»åŠ¡è¿›åº¦ç›‘æ§**
```python
from concurrent.futures import ProcessPoolExecutor
import time
import random

def heavy_computation(task_id, workload):
    """é‡è®¡ç®—ä»»åŠ¡"""
    print(f"ä»»åŠ¡{task_id} å¼€å§‹å¤„ç†...")
    
    total_steps = workload
    for step in range(total_steps):
        # æ¨¡æ‹Ÿè®¡ç®—æ­¥éª¤
        time.sleep(random.uniform(0.1, 0.3))
        
        # æ¯10æ­¥æŠ¥å‘Šä¸€æ¬¡è¿›åº¦
        if (step + 1) % 10 == 0 or (step + 1) == total_steps:
            progress = (step + 1) / total_steps * 100
            print(f"ä»»åŠ¡{task_id} è¿›åº¦: {progress:.1f}%")
    
    result = f"ä»»åŠ¡{task_id}å®Œæˆï¼Œå¤„ç†äº†{workload}ä¸ªæ­¥éª¤"
    return result

if __name__ == '__main__':
    # åˆ›å»ºä¸åŒå·¥ä½œé‡çš„ä»»åŠ¡
    tasks = [
        (1, 30), (2, 50), (3, 20), (4, 40), (5, 25)
    ]
    
    print("å¼€å§‹æ‰¹é‡è®¡ç®—ä»»åŠ¡...")
    start_time = time.time()
    
    with ProcessPoolExecutor(max_workers=3) as executor:
        # æäº¤æ‰€æœ‰ä»»åŠ¡
        futures = [
            executor.submit(heavy_computation, task_id, workload)
            for task_id, workload in tasks
        ]
        
        # ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆå¹¶æ”¶é›†ç»“æœ
        results = []
        for i, future in enumerate(futures):
            result = future.result()  # é˜»å¡ç­‰å¾…è¯¥ä»»åŠ¡å®Œæˆ
            results.append(result)
            print(f"æ”¶åˆ°ç»“æœ {i+1}/{len(futures)}: {result}")
    
    end_time = time.time()
    print(f"\næ‰€æœ‰ä»»åŠ¡å®Œæˆï¼Œæ€»è€—æ—¶: {end_time - start_time:.2f}ç§’")
```

### 9.4 è¿›ç¨‹æ± æœ€ä½³å®è·µ


**âš–ï¸ è¿›ç¨‹æ± å¤§å°é€‰æ‹©**
```python
import multiprocessing
import os

# æ ¹æ®ä»»åŠ¡ç±»å‹é€‰æ‹©è¿›ç¨‹æ•°
def choose_pool_size(task_type="cpu_bound"):
    """é€‰æ‹©åˆé€‚çš„è¿›ç¨‹æ± å¤§å°"""
    cpu_count = multiprocessing.cpu_count()
    
    if task_type == "cpu_bound":
        # CPUå¯†é›†å‹ï¼šè¿›ç¨‹æ•° = CPUæ ¸å¿ƒæ•°
        return cpu_count
    elif task_type == "io_bound":
        # IOå¯†é›†å‹ï¼šå¯ä»¥è¶…è¿‡CPUæ ¸å¿ƒæ•°
        return cpu_count * 2
    elif task_type == "mixed":
        # æ··åˆå‹ï¼šç¨å¾®è¶…è¿‡CPUæ ¸å¿ƒæ•°
        return cpu_count + 2
    else:
        return cpu_count

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == '__main__':
    print(f"CPUæ ¸å¿ƒæ•°: {multiprocessing.cpu_count()}")
    print(f"CPUå¯†é›†å‹ä»»åŠ¡å»ºè®®è¿›ç¨‹æ•°: {choose_pool_size('cpu_bound')}")
    print(f"IOå¯†é›†å‹ä»»åŠ¡å»ºè®®è¿›ç¨‹æ•°: {choose_pool_size('io_bound')}")
    print(f"æ··åˆå‹ä»»åŠ¡å»ºè®®è¿›ç¨‹æ•°: {choose_pool_size('mixed')}")
```

**ğŸ’¡ é”™è¯¯å¤„ç†å’Œèµ„æºç®¡ç†**
```python
from concurrent.futures import ProcessPoolExecutor, TimeoutError
import time
import random

def unreliable_task(task_id):
    """ä¸ç¨³å®šçš„ä»»åŠ¡ï¼ˆå¯èƒ½æˆåŠŸã€å¤±è´¥æˆ–è¶…æ—¶ï¼‰"""
    # éšæœºå†³å®šä»»åŠ¡è¡Œä¸º
    behavior = random.choice(['success', 'error', 'timeout'])
    
    if behavior == 'success':
        time.sleep(random.uniform(1, 2))
        return f"ä»»åŠ¡{task_id}æˆåŠŸå®Œæˆ"
    elif behavior == 'error':
        time.sleep(0.5)
        raise Exception(f"ä»»åŠ¡{task_id}æ‰§è¡Œå‡ºé”™")
    else:  # timeout
        time.sleep(10)  # æ¨¡æ‹Ÿé•¿æ—¶é—´ä»»åŠ¡
        return f"ä»»åŠ¡{task_id}æœ€ç»ˆå®Œæˆ"

if __name__ == '__main__':
    tasks = list(range(1, 6))
    
    with ProcessPoolExecutor(max_workers=3) as executor:
        # æäº¤ä»»åŠ¡
        futures = [executor.submit(unreliable_task, task_id) for task_id in tasks]
        
        # å¤„ç†ç»“æœï¼Œè®¾ç½®è¶…æ—¶
        for i, future in enumerate(futures):
            try:
                # è®¾ç½®3ç§’è¶…æ—¶
                result = future.result(timeout=3)
                print(f"âœ… ä»»åŠ¡{i+1}: {result}")
            
            except TimeoutError:
                print(f"â° ä»»åŠ¡{i+1}: æ‰§è¡Œè¶…æ—¶")
                future.cancel()  # å°è¯•å–æ¶ˆä»»åŠ¡
            
            except Exception as e:
                print(f"âŒ ä»»åŠ¡{i+1}: æ‰§è¡Œå¤±è´¥ - {e}")
        
        print("æ‰¹å¤„ç†å®Œæˆ")
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å¤šè¿›ç¨‹ç¼–ç¨‹ï¼šåˆ©ç”¨å¤šæ ¸CPUå¤„ç†CPUå¯†é›†å‹ä»»åŠ¡çš„æœ€ä½³é€‰æ‹©
ğŸ”¸ Processç±»ï¼šåˆ›å»ºå’Œç®¡ç†è¿›ç¨‹çš„åŸºç¡€å·¥å…·
ğŸ”¸ IPCé€šä¿¡ï¼šè¿›ç¨‹é—´æ•°æ®äº¤æ¢çš„å¿…å¤‡æŠ€èƒ½
ğŸ”¸ Queueé˜Ÿåˆ—ï¼šå¤šè¿›ç¨‹å®‰å…¨çš„æ•°æ®ä¼ é€’æ–¹å¼
ğŸ”¸ Pipeç®¡é“ï¼šé«˜æ•ˆçš„ç‚¹å¯¹ç‚¹è¿›ç¨‹é€šä¿¡
ğŸ”¸ Managerï¼šå¤æ‚æ•°æ®ç»“æ„çš„è¿›ç¨‹é—´å…±äº«
ğŸ”¸ è¿›ç¨‹æ± ï¼šæ‰¹é‡ä»»åŠ¡å¤„ç†çš„é«˜æ•ˆæ–¹æ¡ˆ
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä½•æ—¶ä½¿ç”¨å¤šè¿›ç¨‹**
```
é€‚ç”¨åœºæ™¯ï¼š
âœ… CPUå¯†é›†å‹ä»»åŠ¡ï¼ˆæ•°å­¦è®¡ç®—ã€å›¾åƒå¤„ç†ã€æ•°æ®åˆ†æï¼‰
âœ… éœ€è¦çœŸæ­£å¹¶è¡Œæ‰§è¡Œçš„ä»»åŠ¡
âœ… å¯¹ç¨‹åºç¨³å®šæ€§è¦æ±‚é«˜çš„åœºæ™¯
âœ… éœ€è¦ç»•è¿‡Python GILé™åˆ¶çš„æƒ…å†µ

ä¸é€‚ç”¨åœºæ™¯ï¼š
âŒ IOå¯†é›†å‹ä»»åŠ¡ï¼ˆæ–‡ä»¶è¯»å†™ã€ç½‘ç»œè¯·æ±‚ï¼‰
âŒ å†…å­˜èµ„æºç´§å¼ çš„ç¯å¢ƒ
âŒ ä»»åŠ¡ä¹‹é—´éœ€è¦é¢‘ç¹æ•°æ®äº¤æ¢
âŒ ç®€å•çš„é¡ºåºæ‰§è¡Œä»»åŠ¡
```

**ğŸ”¹ IPCæ–¹å¼é€‰æ‹©**
```
é€‰æ‹©åŸåˆ™ï¼š
Queueï¼šå¤šå¯¹å¤šé€šä¿¡ï¼Œä»»åŠ¡åˆ†å‘æ”¶é›†
Pipeï¼šä¸€å¯¹ä¸€é€šä¿¡ï¼Œé€Ÿåº¦è¦æ±‚é«˜
Managerï¼šéœ€è¦å…±äº«å¤æ‚æ•°æ®ç»“æ„
å…±äº«å†…å­˜ï¼šå¤§é‡æ•°æ®ï¼Œæ€§èƒ½è¦æ±‚æé«˜

æ€§èƒ½å¯¹æ¯”ï¼š
å…±äº«å†…å­˜ > Pipe > Queue > Manager
å¤æ‚åº¦ï¼š
Manager > Queue > Pipe > å…±äº«å†…å­˜
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–è¦ç‚¹**
```
è¿›ç¨‹æ•°é‡ï¼š
CPUå¯†é›†å‹ = CPUæ ¸å¿ƒæ•°
IOå¯†é›†å‹ = CPUæ ¸å¿ƒæ•° Ã— 2
æ··åˆå‹ = CPUæ ¸å¿ƒæ•° + 2

æ•°æ®ä¼ é€’ï¼š
- é¿å…ä¼ é€’å¤§å¯¹è±¡
- å°½é‡ä¼ é€’åŸºæœ¬æ•°æ®ç±»å‹
- è€ƒè™‘æ•°æ®å‹ç¼©å’Œæ‰¹é‡ä¼ é€’

èµ„æºç®¡ç†ï¼š
- åŠæ—¶å…³é—­ä¸ç”¨çš„è¿æ¥
- ä½¿ç”¨withè¯­å¥ç®¡ç†è¿›ç¨‹æ± 
- è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
```

### 10.3 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ


**â“ å¸¸è§é—®é¢˜FAQ**

**Q: ä¸ºä»€ä¹ˆæˆ‘çš„å¤šè¿›ç¨‹ç¨‹åºæ¯”å•è¿›ç¨‹è¿˜æ…¢ï¼Ÿ**
**A:** å¯èƒ½åŸå› ï¼š
- ä»»åŠ¡ä¸æ˜¯CPUå¯†é›†å‹ï¼Œè¿›ç¨‹åˆ›å»ºå¼€é”€å¤§äºæ”¶ç›Š
- è¿›ç¨‹é—´é€šä¿¡æ•°æ®é‡è¿‡å¤§
- è¿›ç¨‹æ•°é‡è®¾ç½®ä¸åˆç†

**Q: å¦‚ä½•åœ¨Windowsä¸Šé¿å…importé”™è¯¯ï¼Ÿ**
**A:** å¿…é¡»ä½¿ç”¨ `if __name__ == '__main__':` ä¿æŠ¤ä¸»ç¨‹åºä»£ç 

**Q: è¿›ç¨‹é—´å¦‚ä½•å…±äº«å¤§é‡æ•°æ®ï¼Ÿ**
**A:** æ¨èæ–¹æ¡ˆï¼š
- ä½¿ç”¨å…±äº«å†…å­˜ï¼ˆ`multiprocessing.shared_memory`ï¼‰
- å°†æ•°æ®ä¿å­˜åˆ°æ–‡ä»¶ï¼Œä¼ é€’æ–‡ä»¶è·¯å¾„
- ä½¿ç”¨æ•°æ®åº“ä½œä¸ºä¸­è½¬

**Q: å¦‚ä½•ä¼˜é›…åœ°ç»ˆæ­¢æ‰€æœ‰å­è¿›ç¨‹ï¼Ÿ**
**A:** æœ€ä½³å®è·µï¼š
```python
# å‘é€ç»ˆæ­¢ä¿¡å·
for process in processes:
    process.terminate()

# ç­‰å¾…è¿›ç¨‹ç»“æŸ
for process in processes:
    process.join(timeout=5)
    if process.is_alive():
        process.kill()  # å¼ºåˆ¶æ€æ­»
```

### 10.4 å­¦ä¹ è·¯å¾„å»ºè®®


**ğŸ“š å»ºè®®å­¦ä¹ é¡ºåº**

**ç¬¬1é˜¶æ®µï¼šåŸºç¡€ç†è§£**
- [ ] ç†è§£è¿›ç¨‹ä¸çº¿ç¨‹çš„åŒºåˆ«
- [ ] æŒæ¡Processç±»çš„åŸºæœ¬ä½¿ç”¨
- [ ] äº†è§£è¿›ç¨‹é—´é€šä¿¡çš„å¿…è¦æ€§

**ç¬¬2é˜¶æ®µï¼šé€šä¿¡æœºåˆ¶**
- [ ] ç†Ÿç»ƒä½¿ç”¨Queueè¿›è¡Œä»»åŠ¡åˆ†å‘
- [ ] æŒæ¡Pipeçš„åŒå‘é€šä¿¡
- [ ] ç†è§£Managerçš„åº”ç”¨åœºæ™¯

**ç¬¬3é˜¶æ®µï¼šå®æˆ˜åº”ç”¨**
- [ ] ä½¿ç”¨è¿›ç¨‹æ± å¤„ç†æ‰¹é‡ä»»åŠ¡
- [ ] è®¾è®¡åˆç†çš„é”™è¯¯å¤„ç†æœºåˆ¶
- [ ] æ€§èƒ½è°ƒä¼˜å’Œç›‘æ§

**ç¬¬4é˜¶æ®µï¼šé«˜çº§ä¸»é¢˜**
- [ ] å…±äº«å†…å­˜çš„ä½¿ç”¨
- [ ] è¿›ç¨‹åŒæ­¥åŸè¯­
- [ ] åˆ†å¸ƒå¼è®¡ç®—æ¡†æ¶

### 10.5 å®é™…åº”ç”¨ä»·å€¼


**ğŸ’¼ çœŸå®åº”ç”¨åœºæ™¯**
- **æ•°æ®åˆ†æ**ï¼šå¹¶è¡Œå¤„ç†å¤§æ•°æ®é›†åˆ†æ
- **å›¾åƒå¤„ç†**ï¼šæ‰¹é‡å›¾ç‰‡è½¬æ¢å’Œæ»¤é•œå¤„ç†  
- **ç§‘å­¦è®¡ç®—**ï¼šæ•°å€¼æ¨¡æ‹Ÿå’Œæœºå™¨å­¦ä¹ è®­ç»ƒ
- **çˆ¬è™«ç³»ç»Ÿ**ï¼šå¤šè¿›ç¨‹çˆ¬å–ä¸åŒç½‘ç«™
- **æ–‡ä»¶å¤„ç†**ï¼šæ‰¹é‡æ–‡ä»¶è½¬æ¢å’Œå‹ç¼©

**ğŸ¯ æœ€ä½³å®è·µæ€»ç»“**
```
è®¾è®¡åŸåˆ™ï¼š
1. ä»»åŠ¡åˆ†è§£è¦åˆç†ï¼Œé¿å…è¿›ç¨‹é—´é¢‘ç¹é€šä¿¡
2. é”™è¯¯å¤„ç†è¦å®Œå–„ï¼Œé¿å…åƒµå°¸è¿›ç¨‹
3. èµ„æºç®¡ç†è¦åŠæ—¶ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
4. ç›‘æ§æœºåˆ¶è¦åˆ°ä½ï¼Œä¾¿äºè°ƒè¯•å’Œä¼˜åŒ–

æ€§èƒ½è¦ç‚¹ï¼š
1. æ ¹æ®ä»»åŠ¡ç‰¹æ€§é€‰æ‹©åˆé€‚çš„å¹¶å‘æ–¹å¼
2. åˆç†è®¾ç½®è¿›ç¨‹æ•°é‡å’Œè¶…æ—¶æ—¶é—´
3. ä¼˜åŒ–æ•°æ®ä¼ é€’å’Œå…±äº«æœºåˆ¶
4. å»ºç«‹å®Œå–„çš„æ—¥å¿—å’Œç›‘æ§ä½“ç³»
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- å¤šè¿›ç¨‹è§£å†³CPUå¯†é›†å‹ï¼Œç»•è¿‡GILçœŸå¹¶è¡Œ
- Queueç®¡é“å…±äº«æ•°æ®ï¼Œé€‰æ‹©åˆé€‚æœ€å…³é”®  
- è¿›ç¨‹æ± ç®¡ç†æ›´ç®€å•ï¼Œæ‰¹é‡ä»»åŠ¡æ•ˆç‡é«˜
- é”™è¯¯å¤„ç†è¦å®Œå–„ï¼Œèµ„æºç®¡ç†ä¸èƒ½å¿˜