---
title: 1ã€æ€§èƒ½ä¸å®‰å…¨
---
## ğŸ“š ç›®å½•

1. [N+1æŸ¥è¯¢é—®é¢˜ä¸DataLoader](#1-n1æŸ¥è¯¢é—®é¢˜ä¸dataloader)
2. [æ‰¹é‡åŠ è½½æ¦‚å¿µä¸ç¼“å­˜æœºåˆ¶](#2-æ‰¹é‡åŠ è½½æ¦‚å¿µä¸ç¼“å­˜æœºåˆ¶)
3. [æŸ¥è¯¢æ·±åº¦ä¸å¤æ‚åº¦é™åˆ¶](#3-æŸ¥è¯¢æ·±åº¦ä¸å¤æ‚åº¦é™åˆ¶)
4. [æŸ¥è¯¢ç™½åå•ç­–ç•¥](#4-æŸ¥è¯¢ç™½åå•ç­–ç•¥)
5. [è®¤è¯ä¸æˆæƒæœºåˆ¶](#5-è®¤è¯ä¸æˆæƒæœºåˆ¶)
6. [CORSé…ç½®è¯¦è§£](#6-corsé…ç½®è¯¦è§£)
7. [è¾“å…¥éªŒè¯ä¸å®‰å…¨é˜²æŠ¤](#7-è¾“å…¥éªŒè¯ä¸å®‰å…¨é˜²æŠ¤)
8. [é˜²æ­¢æ¶æ„æŸ¥è¯¢](#8-é˜²æ­¢æ¶æ„æŸ¥è¯¢)
9. [ç¼“å­˜ç­–ç•¥ä¼˜åŒ–](#9-ç¼“å­˜ç­–ç•¥ä¼˜åŒ–)
10. [è¶…æ—¶æ§åˆ¶æœºåˆ¶](#10-è¶…æ—¶æ§åˆ¶æœºåˆ¶)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ N+1æŸ¥è¯¢é—®é¢˜ä¸DataLoader


### 1.1 ä»€ä¹ˆæ˜¯N+1æŸ¥è¯¢é—®é¢˜


> ğŸ’¡ **ç®€å•ç†è§£**ï¼šN+1é—®é¢˜å°±æ˜¯"æŸ¥è¯¢å¤ªå¤šæ¬¡æ•°æ®åº“"çš„é—®é¢˜ï¼Œæœ¬æ¥1æ¬¡å°±èƒ½æå®šçš„ï¼Œç»“æœæ‰§è¡Œäº†N+1æ¬¡æŸ¥è¯¢

**é—®é¢˜åœºæ™¯ä¸¾ä¾‹**ï¼š
å‡è®¾ä½ è¦æŸ¥è¯¢10ä¸ªç”¨æˆ·çš„ä¿¡æ¯ï¼Œæ¯ä¸ªç”¨æˆ·è¿˜è¦æ˜¾ç¤ºä»–ä»¬çš„æ–‡ç« ï¼š

```
æ²¡æœ‰ä¼˜åŒ–çš„æƒ…å†µï¼š
1ï¸âƒ£ å…ˆæŸ¥è¯¢10ä¸ªç”¨æˆ· (1æ¬¡æŸ¥è¯¢)
2ï¸âƒ£ ä¸ºæ¯ä¸ªç”¨æˆ·æŸ¥è¯¢æ–‡ç«  (10æ¬¡æŸ¥è¯¢)
æ€»è®¡ï¼š11æ¬¡æ•°æ®åº“æŸ¥è¯¢ (1 + 10 = N+1)

ç†æƒ³æƒ…å†µï¼š
âœ… åªéœ€è¦2æ¬¡æŸ¥è¯¢å°±å¤Ÿäº†
```

### 1.2 N+1é—®é¢˜çš„å…·ä½“è¡¨ç°


**GraphQLæŸ¥è¯¢ç¤ºä¾‹**ï¼š
```graphql
# ç”¨æˆ·æƒ³è¦æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨å’Œæ¯ä¸ªç”¨æˆ·çš„æ–‡ç« 
query {
  users {
    id
    name
    posts {
      title
      content
    }
  }
}
```

**æ²¡ä¼˜åŒ–æ—¶çš„æ•°æ®åº“æ‰§è¡Œ**ï¼š
```
ç¬¬1æ¬¡æŸ¥è¯¢: SELECT * FROM users           (è·å–æ‰€æœ‰ç”¨æˆ·)
ç¬¬2æ¬¡æŸ¥è¯¢: SELECT * FROM posts WHERE user_id = 1  (ç”¨æˆ·1çš„æ–‡ç« )  
ç¬¬3æ¬¡æŸ¥è¯¢: SELECT * FROM posts WHERE user_id = 2  (ç”¨æˆ·2çš„æ–‡ç« )
ç¬¬4æ¬¡æŸ¥è¯¢: SELECT * FROM posts WHERE user_id = 3  (ç”¨æˆ·3çš„æ–‡ç« )
...
ç¬¬N+1æ¬¡æŸ¥è¯¢: SELECT * FROM posts WHERE user_id = N
```

> âš ï¸ **é—®é¢˜ä¸¥é‡æ€§**ï¼šå¦‚æœæœ‰1000ä¸ªç”¨æˆ·ï¼Œå°±è¦æ‰§è¡Œ1001æ¬¡æŸ¥è¯¢ï¼æ•°æ®åº“ä¼šè¢«æ‰“å®

### 1.3 DataLoaderæ˜¯ä»€ä¹ˆ


**DataLoaderçš„æ ¸å¿ƒæ€æƒ³**ï¼š
- ğŸ¯ **æ‰¹é‡å¤„ç†**ï¼šæŠŠå¤šä¸ªå•ç‹¬çš„æŸ¥è¯¢åˆå¹¶æˆä¸€æ¬¡æ‰¹é‡æŸ¥è¯¢
- â° **å»¶è¿Ÿæ‰§è¡Œ**ï¼šä¸æ˜¯ç«‹å³æŸ¥è¯¢ï¼Œè€Œæ˜¯ç­‰ä¸€ç­‰ï¼Œæ”¶é›†æ›´å¤šè¯·æ±‚å†ä¸€èµ·å¤„ç†
- ğŸ§  **ç¼“å­˜ç»“æœ**ï¼šåŒæ ·çš„æ•°æ®åœ¨ä¸€æ¬¡è¯·æ±‚ä¸­åªæŸ¥ä¸€æ¬¡

```
DataLoaderçš„å·¥ä½œæµç¨‹ï¼š
1. æ”¶é›†è¯·æ±‚   â†’ [user1çš„æ–‡ç« , user2çš„æ–‡ç« , user3çš„æ–‡ç« ]
2. æ‰¹é‡æŸ¥è¯¢   â†’ SELECT * FROM posts WHERE user_id IN (1,2,3)  
3. åˆ†å‘ç»“æœ   â†’ æŠŠç»“æœæŒ‰ç”¨æˆ·IDåˆ†é…ç»™å¯¹åº”çš„è¯·æ±‚
```

### 1.4 DataLoaderå®ç°ç¤ºä¾‹


**åˆ›å»ºDataLoader**ï¼š
```javascript
const DataLoader = require('dataloader');

// åˆ›å»ºä¸€ä¸ªæ‰¹é‡åŠ è½½ç”¨æˆ·æ–‡ç« çš„DataLoader
const postLoader = new DataLoader(async (userIds) => {
  // æ‰¹é‡æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·çš„æ–‡ç« 
  const posts = await Post.findAll({
    where: { user_id: userIds }
  });
  
  // æŒ‰ç”¨æˆ·IDåˆ†ç»„æ•´ç†ç»“æœ
  const postsByUserId = {};
  userIds.forEach(id => postsByUserId[id] = []);
  
  posts.forEach(post => {
    postsByUserId[post.user_id].push(post);
  });
  
  // è¿”å›ä¸è¾“å…¥é¡ºåºå¯¹åº”çš„ç»“æœ
  return userIds.map(id => postsByUserId[id]);
});
```

**åœ¨Resolverä¸­ä½¿ç”¨**ï¼š
```javascript
const resolvers = {
  User: {
    posts: async (user) => {
      // ä¸å†ç›´æ¥æŸ¥è¯¢æ•°æ®åº“ï¼Œè€Œæ˜¯é€šè¿‡DataLoader
      return postLoader.load(user.id);
    }
  }
};
```

**æ•ˆæœå¯¹æ¯”**ï¼š
```
ä½¿ç”¨DataLoaderå‰:  1 + Næ¬¡æŸ¥è¯¢ (Nä¸ªç”¨æˆ·å°±N+1æ¬¡)
ä½¿ç”¨DataLoaderå:  2æ¬¡æŸ¥è¯¢   (1æ¬¡æŸ¥ç”¨æˆ· + 1æ¬¡æ‰¹é‡æŸ¥æ–‡ç« )
æ€§èƒ½æå‡:         50å€ä»¥ä¸Š (å½“N=100æ—¶)
```

---

## 2. ğŸ“¦ æ‰¹é‡åŠ è½½æ¦‚å¿µä¸ç¼“å­˜æœºåˆ¶


### 2.1 æ‰¹é‡åŠ è½½çš„æ ¸å¿ƒæ€æƒ³


> ğŸ’¡ **é€šä¿—è§£é‡Š**ï¼šæ‰¹é‡åŠ è½½å°±åƒ"æ‹¼å›¢è´­ç‰©"ï¼ŒæŠŠå¤šä¸ªäººçš„éœ€æ±‚é›†ä¸­èµ·æ¥ï¼Œä¸€æ¬¡æ€§å¤„ç†ï¼Œæ—¢çœæ—¶åˆçœåŠ›

**æ‰¹é‡åŠ è½½çš„å·¥ä½œåŸç†**ï¼š
```
ä¼ ç»Ÿæ–¹å¼ (ä¸€ä¸ªä¸ªå¤„ç†):
è¯·æ±‚1: ç»™æˆ‘ç”¨æˆ·1çš„ä¿¡æ¯ â†’ æŸ¥æ•°æ®åº“
è¯·æ±‚2: ç»™æˆ‘ç”¨æˆ·2çš„ä¿¡æ¯ â†’ æŸ¥æ•°æ®åº“  
è¯·æ±‚3: ç»™æˆ‘ç”¨æˆ·3çš„ä¿¡æ¯ â†’ æŸ¥æ•°æ®åº“

æ‰¹é‡åŠ è½½æ–¹å¼:
æ”¶é›†è¯·æ±‚: [ç”¨æˆ·1, ç”¨æˆ·2, ç”¨æˆ·3]
æ‰¹é‡æŸ¥è¯¢: SELECT * FROM users WHERE id IN (1,2,3)
åˆ†å‘ç»“æœ: æŠŠç»“æœæŒ‰IDåˆ†ç»™å„ä¸ªè¯·æ±‚
```

### 2.2 DataLoaderçš„ç¼“å­˜æœºåˆ¶


**ç¼“å­˜çš„ä½œç”¨**ï¼š
- ğŸ¯ **é¿å…é‡å¤æŸ¥è¯¢**ï¼šåŒä¸€æ¬¡è¯·æ±‚ä¸­ç›¸åŒçš„æ•°æ®åªæŸ¥ä¸€æ¬¡
- âš¡ **æå‡å“åº”é€Ÿåº¦**ï¼šä»å†…å­˜ä¸­è·å–æ¯”æŸ¥æ•°æ®åº“å¿«å¾—å¤š
- ğŸ’° **èŠ‚çœèµ„æº**ï¼šå‡å°‘æ•°æ®åº“å‹åŠ›

**ç¼“å­˜ç”Ÿå‘½å‘¨æœŸ**ï¼š
```
è¯·æ±‚å¼€å§‹ â†’ åˆ›å»ºDataLoaderå®ä¾‹
   â†“
ç¬¬ä¸€æ¬¡åŠ è½½æ•°æ® â†’ æŸ¥æ•°æ®åº“ + å­˜å…¥ç¼“å­˜
   â†“  
å†æ¬¡åŠ è½½ç›¸åŒæ•°æ® â†’ ç›´æ¥ä»ç¼“å­˜è¿”å›
   â†“
è¯·æ±‚ç»“æŸ â†’ é”€æ¯DataLoaderå®ä¾‹ (ç¼“å­˜æ¸…ç©º)
```

**ç¼“å­˜ç¤ºä¾‹**ï¼š
```javascript
// åŒä¸€ä¸ªGraphQLè¯·æ±‚ä¸­
const loader = new DataLoader(batchLoadFn);

// ç¬¬ä¸€æ¬¡è°ƒç”¨ - ä¼šæŸ¥è¯¢æ•°æ®åº“
const user1 = await loader.load(1);

// ç¬¬äºŒæ¬¡è°ƒç”¨ç›¸åŒID - ç›´æ¥ä»ç¼“å­˜è¿”å›
const user1Again = await loader.load(1); // ä¸ä¼šå†æŸ¥æ•°æ®åº“

console.log(user1 === user1Again); // trueï¼Œæ˜¯åŒä¸€ä¸ªå¯¹è±¡
```

### 2.3 ç¼“å­˜é…ç½®é€‰é¡¹


**DataLoaderé…ç½®å‚æ•°**ï¼š
```javascript
const loader = new DataLoader(batchLoadFn, {
  // æ˜¯å¦å¯ç”¨ç¼“å­˜ï¼Œé»˜è®¤ä¸ºtrue
  cache: true,
  
  // æ‰¹å¤„ç†å»¶è¿Ÿæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ï¼Œé»˜è®¤ä¸ºä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯
  batchScheduleFn: callback => process.nextTick(callback),
  
  // æœ€å¤§æ‰¹å¤„ç†å¤§å°ï¼Œé»˜è®¤æ— é™åˆ¶
  maxBatchSize: 1000
});
```

**æ‰‹åŠ¨ç¼“å­˜æ“ä½œ**ï¼š
```javascript
// æ‰‹åŠ¨æ·»åŠ åˆ°ç¼“å­˜
loader.prime(key, value);

// æ¸…é™¤ç‰¹å®šç¼“å­˜
loader.clear(key);

// æ¸…é™¤æ‰€æœ‰ç¼“å­˜  
loader.clearAll();
```

---

## 3. ğŸ” æŸ¥è¯¢æ·±åº¦ä¸å¤æ‚åº¦é™åˆ¶


### 3.1 ä¸ºä»€ä¹ˆéœ€è¦æ·±åº¦é™åˆ¶


> âš ï¸ **é—®é¢˜åœºæ™¯**ï¼šæ¶æ„ç”¨æˆ·å¯èƒ½å‘é€è¶…æ·±å±‚çš„æŸ¥è¯¢ï¼Œè®©æœåŠ¡å™¨å´©æºƒ

**å±é™©çš„æ·±å±‚æŸ¥è¯¢**ï¼š
```graphql
# æ¶æ„çš„æ·±å±‚åµŒå¥—æŸ¥è¯¢
query {
  user {
    friends {
      friends {
        friends {
          friends {
            friends {
              # ... å¯ä»¥åµŒå¥—å‡ ç™¾å±‚
            }
          }
        }
      }
    }
  }
}
```

**æ·±åº¦æ”»å‡»çš„å±å®³**ï¼š
```
æŸ¥è¯¢æ·±åº¦: 10å±‚   â†’ å¯èƒ½è¿”å›: 10^5 = 100,000æ¡è®°å½•
æŸ¥è¯¢æ·±åº¦: 15å±‚   â†’ å¯èƒ½è¿”å›: 10^15æ¡è®°å½• (æœåŠ¡å™¨ç›´æ¥å´©æºƒ)
```

### 3.2 æŸ¥è¯¢æ·±åº¦é™åˆ¶å®ç°


**å®‰è£…æ·±åº¦é™åˆ¶åŒ…**ï¼š
```bash
npm install graphql-depth-limit
```

**è®¾ç½®æ·±åº¦é™åˆ¶**ï¼š
```javascript
const depthLimit = require('graphql-depth-limit');

const server = new ApolloServer({
  typeDefs,
  resolvers,
  validationRules: [
    depthLimit(10) // é™åˆ¶æŸ¥è¯¢æ·±åº¦ä¸è¶…è¿‡10å±‚
  ]
});
```

**æ·±åº¦è®¡ç®—ç¤ºä¾‹**ï¼š
```graphql
# è¿™ä¸ªæŸ¥è¯¢çš„æ·±åº¦æ˜¯ 3
query {        # æ·±åº¦: 0
  user {       # æ·±åº¦: 1  
    posts {    # æ·±åº¦: 2
      title    # æ·±åº¦: 3
    }
  }
}
```

### 3.3 æŸ¥è¯¢å¤æ‚åº¦é™åˆ¶


**ä»€ä¹ˆæ˜¯æŸ¥è¯¢å¤æ‚åº¦**ï¼š
- ğŸ¯ **ä¸åªçœ‹æ·±åº¦**ï¼šè¿˜è¦è€ƒè™‘æŸ¥è¯¢è¿”å›çš„æ•°æ®é‡
- ğŸ“Š **è¯„åˆ†æœºåˆ¶**ï¼šç»™æ¯ä¸ªå­—æ®µè®¾ç½®å¤æ‚åº¦åˆ†æ•°
- âš–ï¸ **æ€»åˆ†æ§åˆ¶**ï¼šé™åˆ¶å•æ¬¡æŸ¥è¯¢çš„æ€»å¤æ‚åº¦åˆ†æ•°

**å¤æ‚åº¦è®¡ç®—ç¤ºä¾‹**ï¼š
```javascript
const costAnalysis = require('graphql-cost-analysis');

const server = new ApolloServer({
  typeDefs,
  resolvers,
  plugins: [
    costAnalysis({
      maximumCost: 1000, // æœ€å¤§å¤æ‚åº¦åˆ†æ•°
      scalarCost: 1,     // æ ‡é‡å­—æ®µåˆ†æ•°
      objectCost: 2,     // å¯¹è±¡å­—æ®µåˆ†æ•°
      listCost: 10,      // åˆ—è¡¨å­—æ®µåˆ†æ•°
      introspectionCost: 1000 // å†…çœæŸ¥è¯¢åˆ†æ•°
    })
  ]
});
```

**å¤æ‚åº¦è¯„ä¼°**ï¼š
```graphql
# å¤æ‚åº¦è®¡ç®—ç¤ºä¾‹
query {
  users(limit: 100) {    # 100 * 2 = 200åˆ† (åˆ—è¡¨å¯¹è±¡)
    id                   # 100 * 1 = 100åˆ† (æ ‡é‡)
    name                 # 100 * 1 = 100åˆ† (æ ‡é‡)
    posts(limit: 10) {   # 100 * 10 * 2 = 2000åˆ† (åµŒå¥—åˆ—è¡¨)
      title              # 100 * 10 * 1 = 1000åˆ†
    }
  }
}
# æ€»å¤æ‚åº¦: 3400åˆ† (è¶…è¿‡1000åˆ†é™åˆ¶ï¼Œä¼šè¢«æ‹’ç»)
```

---

## 4. âœ… æŸ¥è¯¢ç™½åå•ç­–ç•¥


### 4.1 ä»€ä¹ˆæ˜¯æŸ¥è¯¢ç™½åå•


> ğŸ’¡ **ç®€å•ç†è§£**ï¼šç™½åå•å°±æ˜¯"å…è®¸åå•"ï¼Œåªæœ‰åå•ä¸Šçš„æŸ¥è¯¢æ‰èƒ½æ‰§è¡Œï¼Œå…¶ä»–çš„éƒ½æ‹’ç»

**ç™½åå•çš„å¥½å¤„**ï¼š
- ğŸ”’ **å®‰å…¨æ€§æœ€é«˜**ï¼šå®Œå…¨é˜»æ­¢æ¶æ„æŸ¥è¯¢
- âš¡ **æ€§èƒ½å¯é¢„æµ‹**ï¼šæ‰€æœ‰æŸ¥è¯¢éƒ½æ˜¯å·²çŸ¥çš„ï¼Œæ€§èƒ½å¯æ§
- ğŸ› ï¸ **ä¾¿äºä¼˜åŒ–**ï¼šå¯ä»¥é’ˆå¯¹ç‰¹å®šæŸ¥è¯¢åšä¸“é—¨ä¼˜åŒ–

### 4.2 æŸ¥è¯¢ç™½åå•å®ç°


**å­˜å‚¨é¢„å®šä¹‰æŸ¥è¯¢**ï¼š
```javascript
// é¢„å®šä¹‰çš„å®‰å…¨æŸ¥è¯¢
const allowedQueries = {
  'getUserProfile': `
    query getUserProfile($id: ID!) {
      user(id: $id) {
        id
        name
        email
        posts {
          title
          createdAt
        }
      }
    }
  `,
  'getPostList': `
    query getPostList($limit: Int) {
      posts(limit: $limit) {
        id
        title
        author {
          name
        }
      }
    }
  `
};
```

**ç™½åå•éªŒè¯ä¸­é—´ä»¶**ï¼š
```javascript
const validateQuery = (req, res, next) => {
  const queryName = req.body.operationName;
  const queryString = req.body.query;
  
  // æ£€æŸ¥æŸ¥è¯¢æ˜¯å¦åœ¨ç™½åå•ä¸­
  if (!allowedQueries[queryName]) {
    return res.status(400).json({
      error: 'æŸ¥è¯¢ä¸åœ¨å…è®¸åˆ—è¡¨ä¸­'
    });
  }
  
  // éªŒè¯æŸ¥è¯¢å†…å®¹æ˜¯å¦åŒ¹é…
  if (allowedQueries[queryName] !== queryString) {
    return res.status(400).json({
      error: 'æŸ¥è¯¢å†…å®¹ä¸åŒ¹é…'
    });
  }
  
  next();
};
```

**å®¢æˆ·ç«¯æŸ¥è¯¢ä½¿ç”¨**ï¼š
```javascript
// å®¢æˆ·ç«¯åªèƒ½ä½¿ç”¨é¢„å®šä¹‰çš„æŸ¥è¯¢
const GET_USER_PROFILE = `
  query getUserProfile($id: ID!) {
    user(id: $id) {
      id
      name
      email
      posts {
        title
        createdAt
      }
    }
  }
`;

// å‘é€è¯·æ±‚
fetch('/graphql', {
  method: 'POST',
  body: JSON.stringify({
    query: GET_USER_PROFILE,
    operationName: 'getUserProfile',
    variables: { id: '123' }
  })
});
```

### 4.3 ç™½åå•ç­–ç•¥çš„æƒè¡¡


**ä¼˜åŠ¿**ï¼š
- âœ… **å®‰å…¨æ€§æé«˜**ï¼šå®Œå…¨é˜²æ­¢æœªçŸ¥æŸ¥è¯¢
- âœ… **æ€§èƒ½å¯æ§**ï¼šæ‰€æœ‰æŸ¥è¯¢éƒ½ç»è¿‡æµ‹è¯•
- âœ… **ä¾¿äºç›‘æ§**ï¼šå®¹æ˜“ç»Ÿè®¡æŸ¥è¯¢ä½¿ç”¨æƒ…å†µ

**åŠ£åŠ¿**ï¼š
- âŒ **çµæ´»æ€§é™ä½**ï¼šå®¢æˆ·ç«¯ä¸èƒ½è‡ªç”±ç»„åˆæŸ¥è¯¢
- âŒ **ç»´æŠ¤æˆæœ¬é«˜**ï¼šéœ€è¦ç®¡ç†å¤§é‡é¢„å®šä¹‰æŸ¥è¯¢
- âŒ **å¼€å‘æ•ˆç‡ä½**ï¼šæ¯ä¸ªæ–°æŸ¥è¯¢éƒ½è¦å…ˆæ·»åŠ åˆ°ç™½åå•

**é€‚ç”¨åœºæ™¯**ï¼š
```
âœ… ç”Ÿäº§ç¯å¢ƒçš„å…¬å¼€API
âœ… å¯¹å®‰å…¨è¦æ±‚æé«˜çš„ç³»ç»Ÿ
âœ… æ€§èƒ½è¦æ±‚ä¸¥æ ¼çš„åœºæ™¯

âŒ å¼€å‘å’Œæµ‹è¯•ç¯å¢ƒ  
âŒ å†…éƒ¨ä½¿ç”¨çš„API
âŒ éœ€è¦å¿«é€Ÿè¿­ä»£çš„é¡¹ç›®
```

---

## 5. ğŸ” è®¤è¯ä¸æˆæƒæœºåˆ¶


### 5.1 è®¤è¯å’Œæˆæƒçš„åŒºåˆ«


> ğŸ’¡ **é€šä¿—è§£é‡Š**ï¼š
> - **è®¤è¯**ï¼šç¡®è®¤"ä½ æ˜¯è°"ï¼ˆèº«ä»½éªŒè¯ï¼‰
> - **æˆæƒ**ï¼šç¡®è®¤"ä½ èƒ½åšä»€ä¹ˆ"ï¼ˆæƒé™éªŒè¯ï¼‰

```
ç”Ÿæ´»ä¸­çš„ä¾‹å­ï¼š
è®¤è¯ â†’ åˆ·èº«ä»½è¯è¿›å…¥å°åŒº (è¯æ˜ä½ çš„èº«ä»½)
æˆæƒ â†’ åªèƒ½è¿›å…¥ä½ æœ‰é’¥åŒ™çš„æˆ¿é—´ (æƒé™æ§åˆ¶)
```

### 5.2 GraphQLä¸­çš„è®¤è¯å®ç°


**JWT Tokenè®¤è¯**ï¼š
```javascript
const jwt = require('jsonwebtoken');

// è®¤è¯ä¸­é—´ä»¶
const authenticate = (req, res, next) => {
  const token = req.headers.authorization?.replace('Bearer ', '');
  
  if (!token) {
    req.user = null; // æœªç™»å½•ç”¨æˆ·
    return next();
  }
  
  try {
    // éªŒè¯å¹¶è§£ætoken
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    req.user = decoded; // è®¾ç½®å½“å‰ç”¨æˆ·ä¿¡æ¯
    next();
  } catch (error) {
    return res.status(401).json({ error: 'æ— æ•ˆçš„è®¤è¯ä»¤ç‰Œ' });
  }
};
```

**åœ¨GraphQL Contextä¸­ä¼ é€’ç”¨æˆ·ä¿¡æ¯**ï¼š
```javascript
const server = new ApolloServer({
  typeDefs,
  resolvers,
  context: ({ req }) => ({
    user: req.user, // ä¼ é€’ç”¨æˆ·ä¿¡æ¯åˆ°resolvers
    db: database
  })
});
```

### 5.3 å­—æ®µçº§åˆ«çš„æˆæƒ


**åœ¨Resolverä¸­è¿›è¡Œæƒé™æ£€æŸ¥**ï¼š
```javascript
const resolvers = {
  Query: {
    // åªæœ‰ç™»å½•ç”¨æˆ·æ‰èƒ½æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨
    users: (parent, args, context) => {
      if (!context.user) {
        throw new Error('è¯·å…ˆç™»å½•');
      }
      
      return User.findAll();
    },
    
    // åªæœ‰ç®¡ç†å‘˜æ‰èƒ½æŸ¥çœ‹æ‰€æœ‰æ–‡ç« 
    allPosts: (parent, args, context) => {
      if (!context.user || context.user.role !== 'admin') {
        throw new Error('éœ€è¦ç®¡ç†å‘˜æƒé™');
      }
      
      return Post.findAll();
    }
  },
  
  User: {
    // ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„é‚®ç®±
    email: (user, args, context) => {
      if (!context.user || context.user.id !== user.id) {
        return null; // éšè—æ•æ„Ÿä¿¡æ¯
      }
      
      return user.email;
    }
  }
};
```

### 5.4 åŸºäºè§„åˆ™çš„æˆæƒç³»ç»Ÿ


**åˆ›å»ºæƒé™è§„åˆ™**ï¼š
```javascript
const { rule, shield, and, or } = require('graphql-shield');

// å®šä¹‰æƒé™è§„åˆ™
const isAuthenticated = rule({ cache: 'contextual' })(
  async (parent, args, context) => {
    return context.user !== null;
  }
);

const isAdmin = rule({ cache: 'contextual' })(
  async (parent, args, context) => {
    return context.user && context.user.role === 'admin';
  }
);

const isOwner = rule({ cache: 'strict' })(
  async (parent, args, context) => {
    return context.user && context.user.id === parent.authorId;
  }
);

// ç»„åˆæƒé™è§„åˆ™
const permissions = shield({
  Query: {
    users: isAuthenticated,        // éœ€è¦ç™»å½•
    adminPanel: isAdmin,           // éœ€è¦ç®¡ç†å‘˜æƒé™
  },
  Mutation: {
    createPost: isAuthenticated,   // åˆ›å»ºæ–‡ç« éœ€è¦ç™»å½•
    deletePost: or(isOwner, isAdmin), // åˆ é™¤æ–‡ç« éœ€è¦æ˜¯ä½œè€…æˆ–ç®¡ç†å‘˜
  },
  User: {
    email: isOwner,                // é‚®ç®±åªæœ‰æœ¬äººå¯è§
  }
});
```

---

## 6. ğŸŒ CORSé…ç½®è¯¦è§£


### 6.1 ä»€ä¹ˆæ˜¯CORS


> ğŸ’¡ **ç®€å•ç†è§£**ï¼šCORSæ˜¯æµè§ˆå™¨çš„å®‰å…¨æœºåˆ¶ï¼Œé˜²æ­¢æ¶æ„ç½‘ç«™å·å–å…¶ä»–ç½‘ç«™çš„æ•°æ®

**CORSå…¨ç§°**ï¼šCross-Origin Resource Sharingï¼ˆè·¨åŸŸèµ„æºå…±äº«ï¼‰

**ä¸ºä»€ä¹ˆéœ€è¦CORS**ï¼š
```
åŒæºç­–ç•¥é™åˆ¶ï¼š
http://localhost:3000  â† å‰ç«¯åº”ç”¨
http://localhost:4000  â† GraphQLæœåŠ¡

æµè§ˆå™¨é»˜è®¤ç¦æ­¢è·¨åŸŸè¯·æ±‚ï¼Œéœ€è¦CORSé…ç½®å…è®¸
```

### 6.2 GraphQLçš„CORSé…ç½®


**Express + Apollo Serverçš„CORSè®¾ç½®**ï¼š
```javascript
const express = require('express');
const cors = require('cors');
const { ApolloServer } = require('apollo-server-express');

const app = express();

// åŸºç¡€CORSé…ç½®
app.use(cors({
  origin: [
    'http://localhost:3000',     // å¼€å‘ç¯å¢ƒå‰ç«¯
    'https://myapp.com',         // ç”Ÿäº§ç¯å¢ƒå‰ç«¯
  ],
  credentials: true,             // å…è®¸æºå¸¦è®¤è¯ä¿¡æ¯
  methods: ['GET', 'POST'],      // å…è®¸çš„HTTPæ–¹æ³•
  allowedHeaders: [              // å…è®¸çš„è¯·æ±‚å¤´
    'Content-Type',
    'Authorization'
  ]
}));

const server = new ApolloServer({
  typeDefs,
  resolvers,
  context: ({ req }) => ({ user: req.user })
});

await server.start();
server.applyMiddleware({ 
  app, 
  cors: false  // ç¦ç”¨Apolloçš„CORSï¼Œä½¿ç”¨Expressçš„CORS
});
```

### 6.3 é¢„æ£€è¯·æ±‚å¤„ç†


**ä»€ä¹ˆæ˜¯é¢„æ£€è¯·æ±‚**ï¼š
æµè§ˆå™¨åœ¨å‘é€å¤æ‚è·¨åŸŸè¯·æ±‚å‰ï¼Œä¼šå…ˆå‘é€ä¸€ä¸ªOPTIONSè¯·æ±‚æ¥æ£€æŸ¥æƒé™

```
å®¢æˆ·ç«¯å‘é€GraphQLè¯·æ±‚çš„æµç¨‹ï¼š

1. æµè§ˆå™¨å‘é€ OPTIONS é¢„æ£€è¯·æ±‚
   â†“
2. æœåŠ¡å™¨è¿”å›CORS headersç¡®è®¤å…è®¸
   â†“  
3. æµè§ˆå™¨å‘é€çœŸæ­£çš„ POST è¯·æ±‚
   â†“
4. æœåŠ¡å™¨å¤„ç†GraphQLæŸ¥è¯¢å¹¶è¿”å›ç»“æœ
```

**å¤„ç†é¢„æ£€è¯·æ±‚**ï¼š
```javascript
app.options('*', cors()); // ä¸ºæ‰€æœ‰è·¯å¾„å¯ç”¨é¢„æ£€è¯·æ±‚å¤„ç†

// æˆ–è€…æ‰‹åŠ¨å¤„ç†
app.use((req, res, next) => {
  if (req.method === 'OPTIONS') {
    res.header('Access-Control-Allow-Origin', req.headers.origin);
    res.header('Access-Control-Allow-Credentials', 'true');
    res.header('Access-Control-Allow-Methods', 'GET, POST, OPTIONS');
    res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization');
    return res.sendStatus(200);
  }
  next();
});
```

### 6.4 ç”Ÿäº§ç¯å¢ƒCORSæœ€ä½³å®è·µ


**å®‰å…¨çš„CORSé…ç½®**ï¼š
```javascript
const allowedOrigins = process.env.NODE_ENV === 'production' 
  ? ['https://myapp.com', 'https://www.myapp.com']  // ç”Ÿäº§ç¯å¢ƒåªå…è®¸ç‰¹å®šåŸŸå
  : ['http://localhost:3000', 'http://localhost:3001']; // å¼€å‘ç¯å¢ƒå…è®¸æœ¬åœ°ç«¯å£

app.use(cors({
  origin: function (origin, callback) {
    // å…è®¸æ²¡æœ‰originçš„è¯·æ±‚ï¼ˆå¦‚ç§»åŠ¨åº”ç”¨ã€Postmanç­‰ï¼‰
    if (!origin) return callback(null, true);
    
    if (allowedOrigins.includes(origin)) {
      callback(null, true);
    } else {
      callback(new Error('ä¸å…è®¸çš„è·¨åŸŸè¯·æ±‚'));
    }
  },
  credentials: true,
  maxAge: 86400 // é¢„æ£€è¯·æ±‚ç¼“å­˜æ—¶é—´ï¼ˆç§’ï¼‰
}));
```

---

## 7. ğŸ›¡ï¸ è¾“å…¥éªŒè¯ä¸å®‰å…¨é˜²æŠ¤


### 7.1 ä¸ºä»€ä¹ˆéœ€è¦è¾“å…¥éªŒè¯


> âš ï¸ **å®‰å…¨é£é™©**ï¼šç”¨æˆ·å¯èƒ½å‘é€æ¶æ„æ•°æ®ï¼Œå¯¼è‡´æ•°æ®æ³„éœ²ã€æœåŠ¡å™¨å´©æºƒæˆ–æ•°æ®æŸå

**å¸¸è§çš„è¾“å…¥æ”»å‡»**ï¼š
- ğŸ”¸ **SQLæ³¨å…¥**ï¼šæ¶æ„çš„æ•°æ®åº“æŸ¥è¯¢ä»£ç 
- ğŸ”¸ **XSSæ”»å‡»**ï¼šæ¶æ„çš„JavaScriptä»£ç 
- ğŸ”¸ **æ•°æ®ç±»å‹é”™è¯¯**ï¼šå‘é€é”™è¯¯ç±»å‹çš„æ•°æ®
- ğŸ”¸ **è¶…å¤§æ•°æ®**ï¼šå‘é€è¶…å¤§æ–‡ä»¶æˆ–å­—ç¬¦ä¸²

### 7.2 GraphQL Schemaå±‚é¢çš„éªŒè¯


**ç±»å‹ç³»ç»Ÿè‡ªåŠ¨éªŒè¯**ï¼š
```graphql
# Schemaå®šä¹‰å·²ç»æä¾›äº†åŸºç¡€éªŒè¯
type User {
  id: ID!           # å¿…é¡»æ˜¯IDç±»å‹ï¼Œä¸èƒ½ä¸ºç©º
  age: Int          # å¿…é¡»æ˜¯æ•´æ•°
  email: String!    # å¿…é¡»æ˜¯å­—ç¬¦ä¸²ï¼Œä¸èƒ½ä¸ºç©º
  isActive: Boolean # å¿…é¡»æ˜¯å¸ƒå°”å€¼
}

input CreateUserInput {
  name: String!     # å¿…å¡«å­—æ®µ
  age: Int         
  email: String!
}
```

**è‡ªå®šä¹‰æ ‡é‡ç±»å‹éªŒè¯**ï¼š
```javascript
const { GraphQLScalarType, GraphQLError } = require('graphql');
const { Kind } = require('graphql/language');

// é‚®ç®±æ ¼å¼éªŒè¯
const EmailType = new GraphQLScalarType({
  name: 'Email',
  description: 'é‚®ç®±åœ°å€æ ¼å¼',
  
  serialize(value) {
    // è¾“å‡ºæ—¶çš„éªŒè¯
    if (!isValidEmail(value)) {
      throw new GraphQLError('æ— æ•ˆçš„é‚®ç®±æ ¼å¼');
    }
    return value;
  },
  
  parseValue(value) {
    // å˜é‡è¾“å…¥æ—¶çš„éªŒè¯
    if (!isValidEmail(value)) {
      throw new GraphQLError('æ— æ•ˆçš„é‚®ç®±æ ¼å¼');
    }
    return value;
  },
  
  parseLiteral(ast) {
    // æŸ¥è¯¢å­—é¢é‡æ—¶çš„éªŒè¯
    if (ast.kind !== Kind.STRING || !isValidEmail(ast.value)) {
      throw new GraphQLError('æ— æ•ˆçš„é‚®ç®±æ ¼å¼');
    }
    return ast.value;
  }
});

function isValidEmail(email) {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(email);
}
```

### 7.3 ä¸šåŠ¡é€»è¾‘å±‚é¢çš„éªŒè¯


**åœ¨Resolverä¸­è¿›è¡Œæ·±åº¦éªŒè¯**ï¼š
```javascript
const resolvers = {
  Mutation: {
    createUser: async (parent, { input }, context) => {
      // 1. åŸºç¡€å­—æ®µéªŒè¯
      if (!input.name || input.name.trim().length < 2) {
        throw new Error('ç”¨æˆ·åè‡³å°‘éœ€è¦2ä¸ªå­—ç¬¦');
      }
      
      if (!input.email || !isValidEmail(input.email)) {
        throw new Error('è¯·æä¾›æœ‰æ•ˆçš„é‚®ç®±åœ°å€');
      }
      
      if (input.age !== undefined && (input.age < 0 || input.age > 120)) {
        throw new Error('å¹´é¾„å¿…é¡»åœ¨0-120ä¹‹é—´');
      }
      
      // 2. ä¸šåŠ¡é€»è¾‘éªŒè¯
      const existingUser = await User.findOne({ 
        where: { email: input.email } 
      });
      
      if (existingUser) {
        throw new Error('è¯¥é‚®ç®±å·²è¢«æ³¨å†Œ');
      }
      
      // 3. æ•°æ®æ¸…ç†
      const cleanInput = {
        name: input.name.trim(),
        email: input.email.toLowerCase(),
        age: input.age
      };
      
      return User.create(cleanInput);
    }
  }
};
```

### 7.4 ä½¿ç”¨éªŒè¯åº“ç®€åŒ–å·¥ä½œ


**JoiéªŒè¯åº“ç¤ºä¾‹**ï¼š
```javascript
const Joi = require('joi');

// å®šä¹‰éªŒè¯è§„åˆ™
const createUserSchema = Joi.object({
  name: Joi.string().min(2).max(50).required(),
  email: Joi.string().email().required(),
  age: Joi.number().integer().min(0).max(120),
  password: Joi.string().min(8).pattern(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/)
});

const resolvers = {
  Mutation: {
    createUser: async (parent, { input }) => {
      // ä½¿ç”¨JoiéªŒè¯è¾“å…¥
      const { error, value } = createUserSchema.validate(input);
      
      if (error) {
        throw new Error(`è¾“å…¥éªŒè¯å¤±è´¥: ${error.details[0].message}`);
      }
      
      // ä½¿ç”¨éªŒè¯åçš„æ•°æ®
      return User.create(value);
    }
  }
};
```

---

## 8. ğŸš¨ é˜²æ­¢æ¶æ„æŸ¥è¯¢


### 8.1 å¸¸è§çš„æ¶æ„æŸ¥è¯¢ç±»å‹


**æ·±åº¦çˆ†ç‚¸æŸ¥è¯¢**ï¼š
```graphql
# æ¶æ„çš„æ·±å±‚åµŒå¥—
query {
  user {
    friends {
      friends {
        friends {
          # ... æ— é™åµŒå¥—
        }
      }
    }
  }
}
```

**å¤æ‚åº¦çˆ†ç‚¸æŸ¥è¯¢**ï¼š
```graphql
# è¯·æ±‚å¤§é‡æ•°æ®
query {
  users(limit: 999999) {
    posts(limit: 999999) {
      comments(limit: 999999) {
        content
      }
    }
  }
}
```

**èµ„æºè€—å°½æŸ¥è¯¢**ï¼š
```graphql
# å¤šä¸ªè€—æ—¶æ“ä½œå¹¶å‘æ‰§è¡Œ
query {
  heavyOperation1: calculatePi(digits: 1000000)
  heavyOperation2: generateReport(years: 100) 
  heavyOperation3: searchDatabase(pattern: ".*")
}
```

### 8.2 æŸ¥è¯¢å¤æ‚åº¦åˆ†æ


**å®‰è£…æŸ¥è¯¢å¤æ‚åº¦åˆ†æå™¨**ï¼š
```bash
npm install graphql-query-complexity
```

**é…ç½®å¤æ‚åº¦é™åˆ¶**ï¼š
```javascript
const { createComplexityLimitRule } = require('graphql-query-complexity');

const server = new ApolloServer({
  typeDefs,
  resolvers,
  validationRules: [
    createComplexityLimitRule(1000, {
      scalarCost: 1,      // æ ‡é‡å­—æ®µæˆæœ¬
      objectCost: 2,      // å¯¹è±¡å­—æ®µæˆæœ¬  
      listFactor: 10,     // åˆ—è¡¨å€æ•°
      introspectionCost: 1000 // å†…çœæŸ¥è¯¢æˆæœ¬
    })
  ]
});
```

**è‡ªå®šä¹‰å­—æ®µå¤æ‚åº¦**ï¼š
```graphql
type Query {
  users(limit: Int = 10): [User] 
  # å¤æ‚åº¦ = limit * 2 (æ¯ä¸ªç”¨æˆ·å¯¹è±¡æˆæœ¬ä¸º2)
  
  searchUsers(query: String!): [User]
  # æœç´¢æ“ä½œæˆæœ¬æ›´é«˜ï¼Œè®¾ç½®ä¸ºå›ºå®š50
}
```

```javascript
const typeDefs = `
  type Query {
    users(limit: Int = 10): [User]
    searchUsers(query: String!): [User] 
  }
`;

// åœ¨resolverä¸­è®¾ç½®å¤æ‚åº¦
const resolvers = {
  Query: {
    users: {
      resolve: (parent, args) => User.findAll({ limit: args.limit }),
      complexity: ({ args }) => args.limit * 2  // åŠ¨æ€è®¡ç®—å¤æ‚åº¦
    },
    searchUsers: {
      resolve: (parent, args) => searchUsers(args.query),
      complexity: 50  // å›ºå®šå¤æ‚åº¦
    }
  }
};
```

### 8.3 æŸ¥è¯¢é€Ÿç‡é™åˆ¶


**åŸºäºIPçš„é™æµ**ï¼š
```javascript
const rateLimit = require('express-rate-limit');

// åŸºç¡€é™æµä¸­é—´ä»¶
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15åˆ†é’Ÿæ—¶é—´çª—å£
  max: 100,                 // æœ€å¤š100ä¸ªè¯·æ±‚
  message: 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•',
  standardHeaders: true,    // è¿”å›é™æµä¿¡æ¯åˆ°headers
  legacyHeaders: false,
});

app.use('/graphql', limiter);
```

**åŸºäºç”¨æˆ·çš„é™æµ**ï¼š
```javascript
const userLimiter = rateLimit({
  windowMs: 60 * 1000,  // 1åˆ†é’Ÿ
  max: (req) => {
    // æ ¹æ®ç”¨æˆ·ç­‰çº§è®¾ç½®ä¸åŒé™åˆ¶
    if (req.user?.isPremium) return 200;  // VIPç”¨æˆ·200æ¬¡
    if (req.user) return 60;              // æ™®é€šç”¨æˆ·60æ¬¡  
    return 20;                            // æœªç™»å½•ç”¨æˆ·20æ¬¡
  },
  keyGenerator: (req) => req.user?.id || req.ip
});
```

### 8.4 æŸ¥è¯¢é»‘åå•æœºåˆ¶


**æ£€æµ‹æ¶æ„æŸ¥è¯¢æ¨¡å¼**ï¼š
```javascript
const dangerousPatterns = [
  /mutation.*delete.*\*/i,      // å±é™©çš„åˆ é™¤æ“ä½œ
  /query.*{.*{.*{.*{.*{/,       // æ·±åº¦åµŒå¥—è¿‡æ·±
  /limit:\s*\d{6,}/,           // limitå€¼è¿‡å¤§
  /__schema|__type/            // å†…çœæŸ¥è¯¢ï¼ˆç”Ÿäº§ç¯å¢ƒå¯ç¦ç”¨ï¼‰
];

const validateQuery = (req, res, next) => {
  const query = req.body.query;
  
  for (const pattern of dangerousPatterns) {
    if (pattern.test(query)) {
      return res.status(400).json({
        error: 'æŸ¥è¯¢åŒ…å«ä¸å®‰å…¨çš„æ¨¡å¼',
        pattern: pattern.toString()
      });
    }
  }
  
  next();
};

app.use('/graphql', validateQuery);
```

---

## 9. âš¡ ç¼“å­˜ç­–ç•¥ä¼˜åŒ–


### 9.1 ç¼“å­˜çš„å±‚æ¬¡ç»“æ„


> ğŸ’¡ **ç¼“å­˜å±‚æ¬¡**ï¼šåƒä¿„ç½—æ–¯å¥—å¨ƒä¸€æ ·ï¼Œä¸€å±‚å¥—ä¸€å±‚ï¼Œè¶Šé è¿‘ç”¨æˆ·è¶Šå¿«

```
ç¼“å­˜å±‚æ¬¡å›¾ (ä»å¿«åˆ°æ…¢):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æµè§ˆå™¨ç¼“å­˜     â”‚ â† æœ€å¿«ï¼Œåœ¨ç”¨æˆ·è®¾å¤‡ä¸Š
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     CDNç¼“å­˜     â”‚ â† åœ°ç†ä½ç½®å°±è¿‘ç¼“å­˜
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   åº”ç”¨æœåŠ¡å™¨ç¼“å­˜ â”‚ â† Redis/Memcached
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æ•°æ®åº“æŸ¥è¯¢ç¼“å­˜ â”‚ â† æ•°æ®åº“å†…ç½®ç¼“å­˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.2 HTTPç¼“å­˜æ§åˆ¶


**è®¾ç½®GraphQLå“åº”ç¼“å­˜å¤´**ï¼š
```javascript
const server = new ApolloServer({
  typeDefs,
  resolvers,
  plugins: [
    {
      requestDidStart() {
        return {
          willSendResponse(requestContext) {
            const { response, request } = requestContext;
            
            // æ ¹æ®æŸ¥è¯¢ç±»å‹è®¾ç½®ç¼“å­˜ç­–ç•¥
            if (isPublicQuery(request.query)) {
              // å…¬å¼€æ•°æ®å¯ä»¥ç¼“å­˜è¾ƒé•¿æ—¶é—´
              response.http.setHeader('Cache-Control', 'public, max-age=300'); // 5åˆ†é’Ÿ
            } else if (isPrivateQuery(request.query)) {
              // ç§äººæ•°æ®çŸ­æ—¶é—´ç¼“å­˜
              response.http.setHeader('Cache-Control', 'private, max-age=60'); // 1åˆ†é’Ÿ
            } else {
              // æ•æ„Ÿæ•°æ®ä¸ç¼“å­˜
              response.http.setHeader('Cache-Control', 'no-cache');
            }
          }
        };
      }
    }
  ]
});

function isPublicQuery(query) {
  // åˆ¤æ–­æ˜¯å¦ä¸ºå…¬å¼€æ•°æ®æŸ¥è¯¢
  return /query.*posts.*public/i.test(query);
}
```

### 9.3 åº”ç”¨å±‚ç¼“å­˜å®ç°


**Redisç¼“å­˜æŸ¥è¯¢ç»“æœ**ï¼š
```javascript
const redis = require('redis');
const client = redis.createClient();

const resolvers = {
  Query: {
    popularPosts: async () => {
      const cacheKey = 'popular_posts';
      
      // 1. å…ˆæ£€æŸ¥ç¼“å­˜
      const cached = await client.get(cacheKey);
      if (cached) {
        console.log('ä»ç¼“å­˜è¿”å›æ•°æ®');
        return JSON.parse(cached);
      }
      
      // 2. ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“
      console.log('ä»æ•°æ®åº“æŸ¥è¯¢æ•°æ®');
      const posts = await Post.findAll({
        where: { isPublic: true },
        order: [['views', 'DESC']],
        limit: 10
      });
      
      // 3. å­˜å…¥ç¼“å­˜ï¼Œè®¾ç½®5åˆ†é’Ÿè¿‡æœŸ
      await client.setEx(cacheKey, 300, JSON.stringify(posts));
      
      return posts;
    }
  }
};
```

**æ™ºèƒ½ç¼“å­˜é”®ç”Ÿæˆ**ï¼š
```javascript
const crypto = require('crypto');

function generateCacheKey(query, variables, user) {
  const data = {
    query: query.replace(/\s+/g, ' ').trim(), // æ ‡å‡†åŒ–æŸ¥è¯¢å­—ç¬¦ä¸²
    variables,
    userId: user?.id || 'anonymous'           // ç”¨æˆ·ç›¸å…³çš„æ•°æ®éœ€è¦åŒºåˆ†ç”¨æˆ·
  };
  
  // ç”Ÿæˆå”¯ä¸€çš„ç¼“å­˜é”®
  return crypto
    .createHash('md5')
    .update(JSON.stringify(data))
    .digest('hex');
}

// ä½¿ç”¨ç¤ºä¾‹
const cacheKey = generateCacheKey(
  req.body.query,
  req.body.variables,
  req.user
);
```

### 9.4 ç¼“å­˜å¤±æ•ˆç­–ç•¥


**åŸºäºæ—¶é—´çš„å¤±æ•ˆ**ï¼š
```javascript
// TTL (Time To Live) ç­–ç•¥
const cacheStrategies = {
  staticData: 3600,      // é™æ€æ•°æ® 1å°æ—¶
  userData: 300,         // ç”¨æˆ·æ•°æ® 5åˆ†é’Ÿ  
  realtimeData: 30,      // å®æ—¶æ•°æ® 30ç§’
  sensitiveData: 0       // æ•æ„Ÿæ•°æ® ä¸ç¼“å­˜
};

async function cacheWithTTL(key, data, type = 'userData') {
  const ttl = cacheStrategies[type];
  if (ttl > 0) {
    await client.setEx(key, ttl, JSON.stringify(data));
  }
}
```

**åŸºäºäº‹ä»¶çš„å¤±æ•ˆ**ï¼š
```javascript
const EventEmitter = require('events');
const cacheInvalidator = new EventEmitter();

// æ•°æ®æ›´æ–°æ—¶å‘é€å¤±æ•ˆäº‹ä»¶
const resolvers = {
  Mutation: {
    createPost: async (parent, { input }) => {
      const newPost = await Post.create(input);
      
      // å‘é€ç¼“å­˜å¤±æ•ˆäº‹ä»¶
      cacheInvalidator.emit('post.created', {
        authorId: newPost.authorId,
        tags: newPost.tags
      });
      
      return newPost;
    }
  }
};

// ç›‘å¬å¤±æ•ˆäº‹ä»¶ï¼Œæ¸…ç†ç›¸å…³ç¼“å­˜
cacheInvalidator.on('post.created', async (data) => {
  // æ¸…ç†ç›¸å…³çš„ç¼“å­˜é”®
  await client.del('popular_posts');
  await client.del(`user_posts:${data.authorId}`);
  
  // æ¸…ç†æ ‡ç­¾ç›¸å…³ç¼“å­˜
  for (const tag of data.tags) {
    await client.del(`posts_by_tag:${tag}`);
  }
});
```

---

## 10. â° è¶…æ—¶æ§åˆ¶æœºåˆ¶


### 10.1 ä¸ºä»€ä¹ˆéœ€è¦è¶…æ—¶æ§åˆ¶


> âš ï¸ **é—®é¢˜åœºæ™¯**ï¼šæŸä¸ªæŸ¥è¯¢æ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼Œå ç”¨æœåŠ¡å™¨èµ„æºï¼Œå½±å“å…¶ä»–ç”¨æˆ·çš„è¯·æ±‚

**è¶…æ—¶æ§åˆ¶çš„å¥½å¤„**ï¼š
- ğŸ• **é˜²æ­¢èµ„æºè€—å°½**ï¼šé¿å…é•¿æ—¶é—´å ç”¨æ•°æ®åº“è¿æ¥
- âš¡ **æå‡ç”¨æˆ·ä½“éªŒ**ï¼šå¿«é€Ÿè¿”å›é”™è¯¯ï¼Œè€Œä¸æ˜¯è®©ç”¨æˆ·æ— é™ç­‰å¾…
- ğŸ›¡ï¸ **ç³»ç»Ÿä¿æŠ¤**ï¼šé˜²æ­¢æ¶æ„æŸ¥è¯¢æ‹–å®æ•´ä¸ªç³»ç»Ÿ

### 10.2 GraphQLæœåŠ¡å™¨çº§è¶…æ—¶


**Apollo Serverè¶…æ—¶è®¾ç½®**ï¼š
```javascript
const server = new ApolloServer({
  typeDefs,
  resolvers,
  plugins: [
    {
      requestDidStart() {
        return {
          willSendResponse(requestContext) {
            // è¯·æ±‚å¼€å§‹æ—¶é—´
            const startTime = Date.now();
            
            return {
              willSendResponse() {
                const duration = Date.now() - startTime;
                
                // è®°å½•æ…¢æŸ¥è¯¢
                if (duration > 5000) { // è¶…è¿‡5ç§’
                  console.warn(`æ…¢æŸ¥è¯¢æ£€æµ‹: ${duration}ms`, {
                    query: requestContext.request.query,
                    variables: requestContext.request.variables
                  });
                }
              }
            };
          }
        };
      }
    }
  ]
});

// è®¾ç½®ExpressæœåŠ¡å™¨è¶…æ—¶
app.use(timeout('30s')); // 30ç§’è¶…æ—¶

app.use((req, res, next) => {
  if (!req.timedout) next();
});
```

### 10.3 æ•°æ®åº“æŸ¥è¯¢è¶…æ—¶


**è®¾ç½®æ•°æ®åº“è¿æ¥è¶…æ—¶**ï¼š
```javascript
const { Sequelize } = require('sequelize');

const sequelize = new Sequelize(database, username, password, {
  host: 'localhost',
  dialect: 'postgres',
  pool: {
    max: 5,
    min: 0,
    acquire: 30000,    // è·å–è¿æ¥çš„æœ€é•¿æ—¶é—´ (30ç§’)
    idle: 10000        // è¿æ¥ç©ºé—²æ—¶é—´ (10ç§’)
  },
  dialectOptions: {
    statement_timeout: 20000,  // SQLè¯­å¥æ‰§è¡Œè¶…æ—¶ (20ç§’)
    query_timeout: 20000       // æŸ¥è¯¢è¶…æ—¶ (20ç§’)
  }
});
```

**åœ¨Resolverä¸­è®¾ç½®è¶…æ—¶**ï¼š
```javascript
const resolvers = {
  Query: {
    complexReport: async (parent, args) => {
      // ä½¿ç”¨Promise.raceå®ç°è¶…æ—¶æ§åˆ¶
      const reportPromise = generateComplexReport(args);
      const timeoutPromise = new Promise((_, reject) => {
        setTimeout(() => {
          reject(new Error('æŸ¥è¯¢è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•'));
        }, 15000); // 15ç§’è¶…æ—¶
      });
      
      try {
        return await Promise.race([reportPromise, timeoutPromise]);
      } catch (error) {
        console.error('å¤æ‚æŠ¥å‘ŠæŸ¥è¯¢å¤±è´¥:', error);
        throw error;
      }
    }
  }
};
```

### 10.4 åˆ†é˜¶æ®µè¶…æ—¶æ§åˆ¶


**ä¸åŒæ“ä½œçš„è¶…æ—¶ç­–ç•¥**ï¼š
```javascript
const timeoutConfig = {
  simpleQuery: 5000,    // ç®€å•æŸ¥è¯¢ 5ç§’
  complexQuery: 30000,  // å¤æ‚æŸ¥è¯¢ 30ç§’
  reportGeneration: 60000, // æŠ¥å‘Šç”Ÿæˆ 60ç§’
  fileUpload: 120000,   // æ–‡ä»¶ä¸Šä¼  120ç§’
};

async function withTimeout(promise, operation = 'simpleQuery') {
  const timeout = timeoutConfig[operation];
  
  const timeoutPromise = new Promise((_, reject) => {
    setTimeout(() => {
      reject(new Error(`${operation} æ“ä½œè¶…æ—¶ (${timeout}ms)`));
    }, timeout);
  });
  
  return Promise.race([promise, timeoutPromise]);
}

// ä½¿ç”¨ç¤ºä¾‹
const resolvers = {
  Query: {
    users: async () => {
      return withTimeout(
        User.findAll(), 
        'simpleQuery'
      );
    },
    
    generateReport: async (parent, args) => {
      return withTimeout(
        Report.generate(args),
        'reportGeneration'
      );
    }
  }
};
```

### 10.5 å®¢æˆ·ç«¯è¶…æ—¶é…ç½®


**Apollo Clientè¶…æ—¶è®¾ç½®**ï¼š
```javascript
import { createHttpLink } from '@apollo/client';
import { setContext } from '@apollo/client/link/context';

const httpLink = createHttpLink({
  uri: 'http://localhost:4000/graphql',
  fetchOptions: {
    timeout: 10000  // 10ç§’è¶…æ—¶
  }
});

// æˆ–è€…ä½¿ç”¨è‡ªå®šä¹‰fetch
const customFetch = (uri, options) => {
  return Promise.race([
    fetch(uri, options),
    new Promise((_, reject) => 
      setTimeout(() => reject(new Error('è¯·æ±‚è¶…æ—¶')), 15000)
    )
  ]);
};

const httpLink = createHttpLink({
  uri: 'http://localhost:4000/graphql',
  fetch: customFetch
});
```

---

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 æ€§èƒ½ä¼˜åŒ–æ ¸å¿ƒè¦ç‚¹


> ğŸ¯ **æ ¸å¿ƒè®°å¿†**ï¼šæ€§èƒ½ä¼˜åŒ–å°±æ˜¯"å‡å°‘æŸ¥è¯¢æ¬¡æ•°ï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡"

**å¿…é¡»æŒæ¡çš„æ¦‚å¿µ**ï¼š
- âœ… **N+1é—®é¢˜**ï¼šä¸€æ¬¡æŸ¥è¯¢å˜æˆN+1æ¬¡æŸ¥è¯¢çš„æ€§èƒ½é™·é˜±
- âœ… **DataLoader**ï¼šæ‰¹é‡åŠ è½½+ç¼“å­˜æœºåˆ¶è§£å†³N+1é—®é¢˜  
- âœ… **æŸ¥è¯¢å¤æ‚åº¦**ï¼šé€šè¿‡è¯„åˆ†æœºåˆ¶æ§åˆ¶æŸ¥è¯¢èµ„æºæ¶ˆè€—
- âœ… **ç¼“å­˜ç­–ç•¥**ï¼šå¤šå±‚ç¼“å­˜æå‡å“åº”é€Ÿåº¦

**æ€§èƒ½ä¼˜åŒ–çš„æ€è·¯**ï¼š
```
å‘ç°é—®é¢˜ â†’ åˆ†æåŸå›  â†’ é€‰æ‹©æ–¹æ¡ˆ â†’ å®æ–½ä¼˜åŒ– â†’ ç›‘æ§æ•ˆæœ

å¸¸è§é—®é¢˜:
- æŸ¥è¯¢å¤ªæ…¢    â†’ DataLoaderæ‰¹é‡åŠ è½½
- èµ„æºå ç”¨é«˜  â†’ å¤æ‚åº¦é™åˆ¶ + è¶…æ—¶æ§åˆ¶  
- å“åº”æ…¢     â†’ å¤šå±‚ç¼“å­˜ç­–ç•¥
- å¹¶å‘é‡å¤§    â†’ è¿æ¥æ±  + é™æµæœºåˆ¶
```

### 11.2 å®‰å…¨é˜²æŠ¤æ ¸å¿ƒè¦ç‚¹


> ğŸ›¡ï¸ **æ ¸å¿ƒè®°å¿†**ï¼šå®‰å…¨å°±æ˜¯"éªŒè¯è¾“å…¥ï¼Œæ§åˆ¶æƒé™ï¼Œé™åˆ¶èµ„æº"

**å¿…é¡»æŒæ¡çš„å®‰å…¨æœºåˆ¶**ï¼š
- âœ… **è®¤è¯æˆæƒ**ï¼šç¡®è®¤ç”¨æˆ·èº«ä»½å’Œæƒé™
- âœ… **è¾“å…¥éªŒè¯**ï¼šé˜²æ­¢æ¶æ„æ•°æ®æ³¨å…¥
- âœ… **æŸ¥è¯¢é™åˆ¶**ï¼šé˜²æ­¢èµ„æºè€—å°½æ”»å‡»
- âœ… **CORSé…ç½®**ï¼šæ§åˆ¶è·¨åŸŸè®¿é—®

**å®‰å…¨é˜²æŠ¤çš„å±‚æ¬¡**ï¼š
```
ç½‘ç»œå±‚å®‰å…¨:  CORS + HTTPS + é˜²ç«å¢™
åº”ç”¨å±‚å®‰å…¨:  è®¤è¯ + æˆæƒ + è¾“å…¥éªŒè¯
æŸ¥è¯¢å±‚å®‰å…¨:  æ·±åº¦é™åˆ¶ + å¤æ‚åº¦æ§åˆ¶ + ç™½åå•
æ•°æ®å±‚å®‰å…¨:  SQLé˜²æ³¨å…¥ + æ•æ„Ÿæ•°æ®è„±æ•
```

### 11.3 å®è·µåº”ç”¨æŒ‡å¯¼


**å¼€å‘ç¯å¢ƒ vs ç”Ÿäº§ç¯å¢ƒ**ï¼š
```
å¼€å‘ç¯å¢ƒé…ç½®:
âœ… å®½æ¾çš„CORSè®¾ç½®    
âœ… è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
âœ… GraphiQLè°ƒè¯•ç•Œé¢
âœ… è¾ƒé«˜çš„æŸ¥è¯¢é™åˆ¶

ç”Ÿäº§ç¯å¢ƒé…ç½®:
âœ… ä¸¥æ ¼çš„CORSç™½åå•
âœ… ç®€åŒ–çš„é”™è¯¯ä¿¡æ¯  
âœ… ç¦ç”¨å†…çœæŸ¥è¯¢
âœ… ä¸¥æ ¼çš„å®‰å…¨é™åˆ¶
```

**ç›‘æ§æŒ‡æ ‡**ï¼š
- ğŸ“Š **æ€§èƒ½æŒ‡æ ‡**ï¼šå“åº”æ—¶é—´ã€æŸ¥è¯¢å¤æ‚åº¦ã€ç¼“å­˜å‘½ä¸­ç‡
- ğŸ”’ **å®‰å…¨æŒ‡æ ‡**ï¼šå¤±è´¥è®¤è¯æ¬¡æ•°ã€æ¶æ„æŸ¥è¯¢æ‹¦æˆªã€é™æµè§¦å‘
- ğŸ’» **èµ„æºæŒ‡æ ‡**ï¼šCPUä½¿ç”¨ç‡ã€å†…å­˜å ç”¨ã€æ•°æ®åº“è¿æ¥æ•°

**æ•…éšœæ’æŸ¥æ€è·¯**ï¼š
```
æ€§èƒ½é—®é¢˜æ’æŸ¥:
1. æ£€æŸ¥æ…¢æŸ¥è¯¢æ—¥å¿—
2. åˆ†æN+1æŸ¥è¯¢é—®é¢˜  
3. æ£€æŸ¥ç¼“å­˜å‘½ä¸­ç‡
4. ä¼˜åŒ–æ•°æ®åº“ç´¢å¼•

å®‰å…¨é—®é¢˜æ’æŸ¥:
1. æ£€æŸ¥è®¤è¯å¤±è´¥æ—¥å¿—
2. åˆ†æå¼‚å¸¸æŸ¥è¯¢æ¨¡å¼
3. æ£€æŸ¥æƒé™é…ç½®
4. éªŒè¯è¾“å…¥è¿‡æ»¤è§„åˆ™
```

### 11.4 æœ€ä½³å®è·µæ€»ç»“


**ä»£ç è´¨é‡**ï¼š
- ğŸ¯ **ç®€æ´æ˜äº†**ï¼šä»£ç é€»è¾‘æ¸…æ™°ï¼Œæ³¨é‡Šå®Œæ•´
- ğŸ”§ **æ¨¡å—åŒ–è®¾è®¡**ï¼šåŠŸèƒ½è§£è€¦ï¼Œä¾¿äºç»´æŠ¤
- ğŸ“ **é”™è¯¯å¤„ç†**ï¼šå®Œå–„çš„å¼‚å¸¸æ•è·å’Œé”™è¯¯æç¤º
- ğŸ§ª **æµ‹è¯•è¦†ç›–**ï¼šå•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

**éƒ¨ç½²è¿ç»´**ï¼š
- ğŸ“Š **ç›‘æ§å‘Šè­¦**ï¼šå®æ—¶ç›‘æ§ç³»ç»ŸçŠ¶æ€
- ğŸ”„ **è‡ªåŠ¨åŒ–éƒ¨ç½²**ï¼šCI/CDæµç¨‹
- ğŸ’¾ **æ•°æ®å¤‡ä»½**ï¼šå®šæœŸå¤‡ä»½é‡è¦æ•°æ®
- ğŸ“ˆ **æ€§èƒ½è°ƒä¼˜**ï¼šæŒç»­ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½

> ğŸ’¡ **æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
> - æ€§èƒ½ä¼˜åŒ–é ç¼“å­˜ï¼ŒN+1é—®é¢˜ç”¨DataLoader
> - å®‰å…¨é˜²æŠ¤è¦å…¨é¢ï¼Œè®¤è¯æˆæƒåŠ éªŒè¯  
> - æŸ¥è¯¢é™åˆ¶é˜²æ”»å‡»ï¼Œè¶…æ—¶æ§åˆ¶ä¿ç¨³å®š
> - ç›‘æ§æ—¥å¿—ä¸å¯å°‘ï¼Œé—®é¢˜æ’æŸ¥æœ‰æ–¹å‘