---
title: 6、微信小程序适配
---
## 📚 目录


1. [小程序环境特殊性](#1-小程序环境特殊性)
2. [Axios在小程序中的问题](#2-axios在小程序中的问题)
3. [网络请求域名配置](#3-网络请求域名配置)
4. [Axios适配器配置](#4-axios适配器配置)
5. [小程序特有处理方案](#5-小程序特有处理方案)
6. [常见问题与解决方案](#6-常见问题与解决方案)
7. [替代方案选择](#7-替代方案选择)
8. [核心要点总结](#8-核心要点总结)

---

# 1. 📱 小程序环境特殊性



## 1.1 小程序是什么环境



**💡 通俗理解**：
小程序就像是一个"特殊的浏览器"，它有自己的规则和限制。

```
普通网页环境：           小程序环境：
浏览器 → 可以访问任何网站   小程序 → 只能访问指定的服务器
       → 有完整的DOM        → 没有完整的DOM  
       → 支持所有JS API     → 只支持部分API
```

**🔸 关键区别**：
- **网络限制**：只能访问你事先配置好的域名
- **API限制**：不支持浏览器的很多功能
- **运行环境**：不是真正的浏览器，是微信自己的运行环境

## 1.2 为什么会有这些限制



**🛡️ 安全考虑**：
```
想象一下：
如果小程序可以随便访问任何网站，就像给陌生人你家的钥匙一样危险
所以微信说："你只能访问我允许的地址"
```

**📋 具体限制表现**：
- 必须使用 `https://` 协议
- 域名必须提前在小程序后台配置
- 不能使用浏览器的 `XMLHttpRequest`
- 只能使用小程序提供的 `wx.request()`

---

# 2. ⚠️ Axios在小程序中的问题



## 2.1 什么是Axios



**💡 简单理解**：
Axios就像是一个"网络请求助手"，帮你向服务器要数据。

```
你想要数据：                Axios帮你：
"我要用户信息"       →      发请求 → 服务器
"我要商品列表"       →      拿数据 ← 服务器
"我要提交订单"       →      处理响应 → 你的代码
```

## 2.2 为什么Axios在小程序中有问题



**🚫 核心问题**：Axios是为浏览器设计的，小程序不是浏览器！

```
Axios期望的环境：                实际小程序环境：
├─ XMLHttpRequest ✓            ├─ XMLHttpRequest ✗ (没有)
├─ window对象 ✓               ├─ window对象 ✗ (没有)  
├─ document对象 ✓             ├─ document对象 ✗ (没有)
└─ 浏览器API ✓                └─ 只有wx.request() ✓
```

**🔸 具体表现**：
```javascript
// 这在小程序中会报错
import axios from 'axios'
axios.get('/api/users') // ❌ 报错：找不到XMLHttpRequest
```

## 2.3 错误示例



```javascript
// ❌ 直接使用会出现的错误
ReferenceError: XMLHttpRequest is not defined
ReferenceError: window is not defined
```

---

# 3. 🌐 网络请求域名配置



## 3.1 什么是域名配置



**💡 通俗比喻**：
就像是给门卫一个"允许进入的人员名单"，只有名单上的人才能进来。

```
小程序后台配置：           实际效果：
✅ https://api.example.com  → 可以访问
✅ https://cdn.example.com  → 可以访问  
❌ https://other.com        → 被拒绝访问
```

## 3.2 如何配置域名



**📋 配置步骤**：

1. **登录小程序管理后台**
   ```
   https://mp.weixin.qq.com → 登录你的小程序账号
   ```

2. **找到服务器域名配置**
   ```
   开发 → 开发管理 → 开发设置 → 服务器域名
   ```

3. **添加你的API域名**
   ```
   request合法域名：https://your-api.com
   ```

## 3.3 配置要求



**🔸 必须满足的条件**：
- ✅ 必须是 `https://` 开头
- ✅ 必须是你拥有的域名
- ✅ 域名必须备案（在中国）
- ❌ 不能是IP地址
- ❌ 不能带端口号

**📝 配置示例**：
```
✅ 正确：https://api.myapp.com
✅ 正确：https://backend.mycompany.com
❌ 错误：http://api.myapp.com    (不是https)
❌ 错误：https://192.168.1.1     (IP地址)
❌ 错误：https://api.com:8080    (带端口)
```

---

# 4. 🔧 Axios适配器配置



## 4.1 什么是适配器



**💡 通俗理解**：
适配器就像是"翻译官"，把Axios的话翻译成小程序能听懂的话。

```
原理图示：
Axios请求 → 适配器翻译 → wx.request() → 服务器
         ←           ←              ←
Axios响应 ← 适配器翻译 ← 小程序响应   ← 服务器响应
```

## 4.2 实现小程序适配器



**🔧 核心代码**：
```javascript
// miniprogram-adapter.js
function createAdapter() {
  return function(config) {
    return new Promise((resolve, reject) => {
      // 把Axios配置转换成wx.request配置
      wx.request({
        url: config.url,
        method: config.method.toUpperCase(),
        data: config.data,
        header: config.headers,
        success: (res) => {
          // 把小程序响应转换成Axios格式
          resolve({
            data: res.data,
            status: res.statusCode,
            statusText: 'OK',
            headers: res.header,
            config: config
          })
        },
        fail: (error) => {
          reject(error)
        }
      })
    })
  }
}
```

## 4.3 使用适配器



```javascript
import axios from 'axios'

// 设置适配器
axios.defaults.adapter = createAdapter()

// 现在可以正常使用了
axios.get('/api/users').then(res => {
  console.log(res.data) // ✅ 正常工作
})
```

---

# 5. 🎯 小程序特有处理方案



## 5.1 请求拦截器配置



**💡 用途**：在发送请求前自动添加通用信息

```javascript
// 添加token和通用头部
axios.interceptors.request.use(config => {
  // 从小程序存储获取token
  const token = wx.getStorageSync('token')
  if (token) {
    config.headers.Authorization = `Bearer ${token}`
  }
  
  // 添加小程序特有信息
  config.headers['Content-Type'] = 'application/json'
  return config
})
```

## 5.2 响应拦截器配置



**💡 用途**：统一处理服务器响应和错误

```javascript
// 统一处理响应
axios.interceptors.response.use(
  response => {
    // 成功响应处理
    return response.data
  },
  error => {
    // 错误处理
    if (error.status === 401) {
      // token过期，跳转登录
      wx.navigateTo({ url: '/pages/login/login' })
    } else {
      // 显示错误提示
      wx.showToast({
        title: '网络错误',
        icon: 'none'
      })
    }
    return Promise.reject(error)
  }
)
```

## 5.3 封装API服务



**💡 目的**：把所有API请求统一管理

```javascript
// api/index.js
class ApiService {
  // 获取用户信息
  getUserInfo() {
    return axios.get('/api/user/info')
  }
  
  // 获取商品列表
  getProductList(page = 1) {
    return axios.get('/api/products', {
      params: { page }
    })
  }
  
  // 提交订单
  createOrder(orderData) {
    return axios.post('/api/orders', orderData)
  }
}

export default new ApiService()
```

**使用示例**：
```javascript
import api from '@/api/index.js'

// 在页面中使用
Page({
  async onLoad() {
    try {
      const userInfo = await api.getUserInfo()
      this.setData({ userInfo })
    } catch (error) {
      console.log('获取用户信息失败')
    }
  }
})
```

---

# 6. 🐛 常见问题与解决方案



## 6.1 域名配置问题



**❌ 问题**：请求被拒绝，提示域名不在配置列表中

```
错误信息：
url not in domain list
```

**✅ 解决方案**：
1. 检查小程序后台域名配置
2. 确保使用的是配置的域名
3. 注意开发环境和生产环境的域名

```javascript
// 根据环境切换API地址
const baseURL = process.env.NODE_ENV === 'development' 
  ? 'https://dev-api.myapp.com'    // 开发环境
  : 'https://api.myapp.com'        // 生产环境

axios.defaults.baseURL = baseURL
```

## 6.2 HTTPS证书问题



**❌ 问题**：SSL证书验证失败

**✅ 解决方案**：
```javascript
// 开发阶段可以跳过证书验证（仅限开发）
wx.request({
  url: 'https://your-api.com',
  method: 'GET',
  // 开发时跳过证书验证
  enableHttp2: true,
  enableQuic: true
})
```

## 6.3 请求超时问题



**❌ 问题**：小程序网络请求容易超时

**✅ 解决方案**：
```javascript
// 设置合理的超时时间
axios.defaults.timeout = 10000 // 10秒

// 或者在适配器中设置
wx.request({
  url: config.url,
  timeout: 10000, // 小程序原生超时设置
  // ... 其他配置
})
```

## 6.4 数据格式问题



**❌ 问题**：请求数据格式不正确

**✅ 解决方案**：
```javascript
// POST请求数据处理
axios.post('/api/users', {
  name: '张三',
  age: 25
}, {
  headers: {
    'Content-Type': 'application/json'
  },
  // 确保数据序列化
  transformRequest: [function(data) {
    return JSON.stringify(data)
  }]
})
```

---

# 7. 🔄 替代方案选择



## 7.1 直接使用wx.request



**💡 优点**：原生支持，无兼容问题

```javascript
// 封装wx.request
function request(options) {
  return new Promise((resolve, reject) => {
    wx.request({
      ...options,
      success: resolve,
      fail: reject
    })
  })
}

// 使用
const getUserInfo = () => {
  return request({
    url: 'https://api.myapp.com/user/info',
    method: 'GET'
  })
}
```

## 7.2 使用小程序专用的HTTP库



**🔸 推荐库：flyio**

```javascript
// 安装：npm install flyio
import fly from 'flyio/dist/npm/wx'

// 配置
fly.config.baseURL = 'https://api.myapp.com'

// 使用（语法类似Axios）
fly.get('/user/info').then(res => {
  console.log(res.data)
})
```

## 7.3 方案对比



| 方案 | **优点** | **缺点** | **适用场景** |
|------|---------|---------|-------------|
| **Axios + 适配器** | `语法熟悉，功能完整` | `需要额外配置` | `从web项目迁移` |
| **wx.request** | `原生支持，稳定` | `语法相对复杂` | `纯小程序项目` |
| **flyio** | `专为小程序设计` | `额外依赖` | `追求最佳体验` |

## 7.4 选择建议



**🎯 推荐选择**：

```
新项目：推荐使用 flyio 或封装的 wx.request
├─ 简单项目 → 封装 wx.request
├─ 复杂项目 → flyio
└─ 团队熟悉Axios → Axios + 适配器

现有项目迁移：
├─ 已使用Axios → 添加适配器
└─ 重新设计API层 → 选择最适合的方案
```

---

# 8. 📋 核心要点总结



## 8.1 必须理解的关键概念



```
🔸 小程序环境限制：不是浏览器，有特殊的网络规则
🔸 域名白名单：必须提前配置允许访问的域名
🔸 HTTPS要求：所有网络请求必须使用HTTPS
🔸 适配器作用：让Axios能在小程序环境中工作
🔸 替代方案：根据项目需求选择合适的HTTP库
```

## 8.2 实践要点



**🔹 开发流程**：
```
1. 配置服务器域名（小程序后台）
2. 选择HTTP请求方案
3. 封装API服务层
4. 添加错误处理
5. 测试验证功能
```

**🔹 最佳实践**：
- ✅ 统一管理API接口
- ✅ 添加请求和响应拦截器
- ✅ 合理设置超时时间
- ✅ 做好错误处理和用户提示
- ✅ 区分开发和生产环境

## 8.3 避免的坑



**⚠️ 常见误区**：
- ❌ 忘记配置域名白名单
- ❌ 使用HTTP而不是HTTPS
- ❌ 没有做错误处理
- ❌ 超时时间设置不合理
- ❌ 开发和生产环境配置相同

## 8.4 记忆要点



**💡 核心记忆**：
- 小程序 = 特殊环境 + 特殊规则
- Axios = 需要适配器才能工作
- 域名 = 必须提前配置白名单
- HTTPS = 必须使用，不能用HTTP
- 封装 = API统一管理，便于维护

**🎯 实用技巧**：
```javascript
// 一个完整的小程序HTTP配置示例
const http = {
  baseURL: 'https://api.myapp.com',
  timeout: 10000,
  headers: {
    'Content-Type': 'application/json'
  }
}
```
