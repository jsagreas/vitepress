---
title: 2、跨域处理与 CORS
---
## 📚 目录

1. [什么是跨域问题](#1-什么是跨域问题)
2. [CORS 跨域解决方案](#2-cors-跨域解决方案)
3. [Express 中的跨域处理](#3-express-中的跨域处理)
4. [跨域请求类型详解](#4-跨域请求类型详解)
5. [生产环境跨域配置](#5-生产环境跨域配置)
6. [核心要点总结](#6-核心要点总结)

---

## 1. 🚫 什么是跨域问题


### 1.1 跨域问题的本质


**🔸 什么是同源策略**
```
同源策略 = 浏览器的安全防护机制
目的：防止恶意网站偷取其他网站的数据

同源的判断标准：
协议 + 域名 + 端口 完全相同 = 同源
```

**💡 生活中的类比**
> 想象你住在一个小区，同源策略就像小区的门禁系统。只有同一个小区的住户才能互相串门，外来人员需要特殊许可才能进入。

### 1.2 跨域场景示例


```
前端页面：http://localhost:3000     （开发服务器）
后端API：  http://localhost:8000     （后端服务器）

结果：❌ 跨域！（端口不同）

常见跨域场景：
✅ 同源：https://api.example.com/users
❌ 跨域：http://api.example.com/users    （协议不同）
❌ 跨域：https://other.com/users         （域名不同）  
❌ 跨域：https://api.example.com:8080/users （端口不同）
```

### 1.3 前后端分离架构中的跨域


```
传统架构：
前端页面 + 后端服务 = 同一个域名
├── index.html       （前端）
├── /api/users       （后端API）
└── 运行在同一服务器 → 不存在跨域

现代前后端分离：
前端项目：Vue/React 开发服务器
后端项目：Node.js API 服务器
├── 前端：localhost:3000
├── 后端：localhost:8000  
└── 不同端口 → 必然跨域！
```

### 1.4 浏览器的报错信息


```javascript
// 典型的跨域错误信息
Access to fetch at 'http://localhost:8000/api/users' 
from origin 'http://localhost:3000' has been blocked by CORS policy: 
No 'Access-Control-Allow-Origin' header is present on the requested resource.
```

**🎯 关键理解**：
- 跨域限制只存在于 **浏览器环境**
- **服务器之间** 调用不存在跨域问题
- **移动端APP** 原生请求也没有跨域限制

---

## 2. 🔓 CORS 跨域解决方案


### 2.1 CORS 的工作原理


**🔸 CORS 是什么**
```
CORS = Cross-Origin Resource Sharing（跨域资源共享）
本质：服务器告诉浏览器"允许这个跨域请求"
方式：通过特殊的 HTTP 响应头来实现
```

**📋 CORS 工作流程**
```
浏览器发起跨域请求：
客户端                           服务器
   |                               |
   |--[1] 发送请求----------------->|
   |   Origin: http://localhost:3000|
   |                               |
   |<--[2] 返回响应头---------------|
   |   Access-Control-Allow-Origin: *|
   |                               |
   |--[3] 浏览器检查头部----------- |
   |   ✅ 允许访问数据              |
```

### 2.2 核心响应头详解


**🎯 Access-Control-Allow-Origin**
```javascript
// 允许所有域名访问（开发阶段）
res.setHeader('Access-Control-Allow-Origin', '*');

// 允许特定域名访问（生产环境推荐）
res.setHeader('Access-Control-Allow-Origin', 'https://myapp.com');

// 允许多个域名（需要动态设置）
const allowedOrigins = ['http://localhost:3000', 'https://myapp.com'];
const origin = req.headers.origin;
if (allowedOrigins.includes(origin)) {
    res.setHeader('Access-Control-Allow-Origin', origin);
}
```

**🔧 Access-Control-Allow-Methods**
```javascript
// 允许的 HTTP 方法
res.setHeader('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE');
```

**📝 Access-Control-Allow-Headers**
```javascript
// 允许的请求头
res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization');
```

**🍪 Access-Control-Allow-Credentials**
```javascript
// 允许携带 Cookie 和认证信息
res.setHeader('Access-Control-Allow-Credentials', true);

// ⚠️ 注意：携带凭据时，Origin 不能设为 *
res.setHeader('Access-Control-Allow-Origin', 'http://localhost:3000');
```

### 2.3 手动设置 CORS 示例


```javascript
// 基础的 CORS 中间件
function corsMiddleware(req, res, next) {
    // 设置允许的来源
    res.setHeader('Access-Control-Allow-Origin', '*');
    
    // 设置允许的方法
    res.setHeader('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
    
    // 设置允许的请求头
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization');
    
    // 处理预检请求
    if (req.method === 'OPTIONS') {
        res.status(200).end();
        return;
    }
    
    next();
}

// 使用中间件
app.use(corsMiddleware);
```

---

## 3. ⚡ Express 中的跨域处理


### 3.1 使用 cors 中间件


**📦 安装 cors 包**
```bash
npm install cors
```

**🔸 基础使用**
```javascript
const express = require('express');
const cors = require('cors');

const app = express();

// 方式1：允许所有跨域请求（开发阶段）
app.use(cors());

// 等价于手动设置：
// app.use(cors({
//     origin: '*',
//     methods: ['GET', 'POST', 'PUT', 'DELETE'],
//     allowedHeaders: ['Content-Type', 'Authorization']
// }));

app.get('/api/users', (req, res) => {
    res.json({ message: '用户数据', users: [] });
});
```

### 3.2 cors 中间件详细配置


```javascript
// 详细的 CORS 配置
const corsOptions = {
    // 🎯 指定允许的来源
    origin: ['http://localhost:3000', 'https://myapp.com'],
    
    // 🔧 允许的 HTTP 方法
    methods: ['GET', 'POST', 'PUT', 'DELETE'],
    
    // 📝 允许的请求头
    allowedHeaders: ['Content-Type', 'Authorization', 'X-Requested-With'],
    
    // 🍪 是否允许发送 Cookie
    credentials: true,
    
    // ⏱️ 预检请求的缓存时间（秒）
    maxAge: 86400 // 24小时
};

app.use(cors(corsOptions));
```

### 3.3 动态 CORS 配置


```javascript
// 根据环境动态配置
const corsOptions = {
    origin: function (origin, callback) {
        // 开发环境：允许所有来源
        if (process.env.NODE_ENV === 'development') {
            callback(null, true);
            return;
        }
        
        // 生产环境：检查白名单
        const allowedOrigins = [
            'https://myapp.com',
            'https://www.myapp.com'
        ];
        
        if (!origin || allowedOrigins.includes(origin)) {
            callback(null, true);
        } else {
            callback(new Error('不允许的跨域请求'));
        }
    },
    credentials: true
};

app.use(cors(corsOptions));
```

### 3.4 为特定路由设置跨域


```javascript
// 只为特定路由启用跨域
app.get('/api/public', cors(), (req, res) => {
    res.json({ message: '公开API，允许跨域' });
});

// 为API路由组启用跨域
app.use('/api', cors({
    origin: ['http://localhost:3000']
}));

app.get('/api/users', (req, res) => {
    res.json({ users: [] });
});
```

---

## 4. 🔍 跨域请求类型详解


### 4.1 简单请求 vs 复杂请求


**🌟 简单请求**
```
满足以下条件的请求 = 简单请求：

✅ 请求方法：GET、POST、HEAD
✅ 请求头只包含：
   - Accept
   - Accept-Language  
   - Content-Language
   - Content-Type（仅限：text/plain、multipart/form-data、application/x-www-form-urlencoded）

特点：浏览器直接发送，不需要预检
```

**🔥 复杂请求（需要预检）**
```
不满足简单请求条件的 = 复杂请求：

❌ 请求方法：PUT、DELETE、PATCH
❌ 请求头包含：Content-Type: application/json
❌ 自定义请求头：Authorization、X-Token

特点：浏览器先发送 OPTIONS 预检请求
```

### 4.2 预检请求详解


**📋 预检请求流程**
```
客户端                                  服务器
   |                                      |
   |--[1] OPTIONS 预检请求--------------->|
   |   Origin: http://localhost:3000      |
   |   Access-Control-Request-Method: POST|
   |   Access-Control-Request-Headers: ...|
   |                                      |
   |<--[2] 预检响应----------------------|
   |   Access-Control-Allow-Origin: *     |
   |   Access-Control-Allow-Methods: ...  |
   |   Access-Control-Allow-Headers: ...  |
   |                                      |
   |--[3] 实际请求----------------------->|
   |   POST /api/users                    |
   |   Content-Type: application/json     |
```

**💻 预检请求示例**
```javascript
// 前端发送复杂请求
fetch('http://localhost:8000/api/users', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',  // 复杂请求
        'Authorization': 'Bearer token123'   // 自定义头部
    },
    body: JSON.stringify({ name: '张三' })
});

// 后端处理预检请求
app.use(cors({
    origin: 'http://localhost:3000',
    methods: ['GET', 'POST', 'PUT', 'DELETE'],
    allowedHeaders: ['Content-Type', 'Authorization'],
    credentials: true,
    maxAge: 3600  // 预检结果缓存1小时
}));
```

### 4.3 预检请求的优化策略


```javascript
// 🚀 优化策略1：增加缓存时间
const corsOptions = {
    maxAge: 86400,  // 24小时缓存，减少预检请求频率
    // ... 其他配置
};

// 🚀 优化策略2：合理设计API
// ❌ 避免不必要的复杂请求
app.post('/api/users', express.text(), (req, res) => {
    // Content-Type: text/plain 是简单请求
});

// ✅ 接受简单请求格式
app.post('/api/users', express.urlencoded(), (req, res) => {
    // Content-Type: application/x-www-form-urlencoded 是简单请求
});
```

---

## 5. 🏭 生产环境跨域配置


### 5.1 环境配置管理


```javascript
// config/cors.js
const corsConfig = {
    development: {
        origin: true,  // 允许所有来源
        credentials: true
    },
    
    production: {
        origin: [
            'https://myapp.com',
            'https://www.myapp.com',
            'https://admin.myapp.com'
        ],
        credentials: true,
        maxAge: 86400
    }
};

module.exports = corsConfig[process.env.NODE_ENV || 'development'];
```

### 5.2 CORS 安全最佳实践


**🔒 安全配置清单**
```javascript
const corsOptions = {
    // ✅ 明确指定允许的域名，避免使用 *
    origin: process.env.ALLOWED_ORIGINS?.split(',') || 'http://localhost:3000',
    
    // ✅ 只允许必要的 HTTP 方法
    methods: ['GET', 'POST', 'PUT', 'DELETE'],
    
    // ✅ 限制允许的请求头
    allowedHeaders: [
        'Content-Type', 
        'Authorization',
        'X-Requested-With'
    ],
    
    // ⚠️ 谨慎使用 credentials: true
    credentials: true,
    
    // ✅ 设置合理的缓存时间
    maxAge: 3600,
    
    // ✅ 不暴露敏感的响应头
    exposedHeaders: ['X-Total-Count']
};
```

### 5.3 跨域 Cookie 处理


```javascript
// 前端设置（携带 Cookie）
fetch('http://localhost:8000/api/login', {
    method: 'POST',
    credentials: 'include',  // 🔑 关键：携带 Cookie
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({ username, password })
});

// 后端配置（接收 Cookie）
app.use(cors({
    origin: 'http://localhost:3000',  // ⚠️ 不能是 *
    credentials: true  // 🔑 关键：允许凭据
}));

// 设置 Cookie
app.post('/api/login', (req, res) => {
    // 验证用户...
    
    res.cookie('token', 'jwt_token_here', {
        httpOnly: true,    // 防止 XSS
        secure: false,     // 生产环境设为 true
        sameSite: 'lax'    // CSRF 防护
    });
    
    res.json({ message: '登录成功' });
});
```

### 5.4 反向代理解决跨域


```javascript
// 开发环境：使用代理解决跨域
// vite.config.js 或 webpack.config.js
module.exports = {
    devServer: {
        proxy: {
            '/api': {
                target: 'http://localhost:8000',
                changeOrigin: true,
                pathRewrite: {
                    '^/api': '/api'  // 可选：重写路径
                }
            }
        }
    }
};

// 🎯 代理的好处：
// 前端请求：http://localhost:3000/api/users
// 实际转发：http://localhost:8000/api/users
// 对浏览器来说是同源请求，无跨域问题
```

---

## 6. 📋 核心要点总结


### 6.1 必须掌握的核心概念


```
🔸 跨域本质：浏览器同源策略的安全限制
🔸 CORS原理：服务器通过响应头告诉浏览器允许跨域
🔸 请求类型：简单请求直接发送，复杂请求需要预检
🔸 开发策略：开发环境放宽限制，生产环境严格控制
🔸 安全原则：明确指定域名，避免使用通配符 *
```

### 6.2 关键理解要点


**🔹 跨域只是浏览器限制**
```
浏览器 → 服务器：❌ 受跨域限制
服务器 → 服务器：✅ 不受跨域限制  
移动端APP → 服务器：✅ 不受跨域限制
```

**🔹 CORS vs 代理的选择**
```
CORS方案：
✅ 适合：API服务，需要多个前端访问
❌ 限制：需要后端配合，安全性要求高

代理方案：
✅ 适合：开发环境，快速解决跨域
❌ 限制：只解决开发问题，生产环境仍需处理
```

**🔹 预检请求的必要性**
```
目的：保护服务器，避免直接发送危险请求
机制：先询问服务器是否允许，再发送实际请求
优化：通过缓存减少预检请求频率
```

### 6.3 实际应用指导


**🎯 开发环境配置**
```javascript
// 快速开发配置
app.use(cors({
    origin: true,        // 允许所有来源
    credentials: true    // 支持 Cookie
}));
```

**🏭 生产环境配置**
```javascript
// 安全生产配置
app.use(cors({
    origin: process.env.ALLOWED_ORIGINS.split(','),
    credentials: true,
    methods: ['GET', 'POST', 'PUT', 'DELETE'],
    allowedHeaders: ['Content-Type', 'Authorization']
}));
```

**🔧 常见问题解决**
```
问题1：携带 Cookie 失败
解决：确保 credentials: true 且 origin 不为 *

问题2：自定义请求头被拒绝  
解决：在 allowedHeaders 中添加对应头部

问题3：PUT/DELETE 请求失败
解决：确保 methods 中包含对应方法
```

### 6.4 记忆要点


**💡 CORS 配置口诀**
```
跨域问题源于浏览器，
CORS响应头来帮忙。
开发放松生产严，
安全第一别贪方便。
简单请求直接过，
复杂请求先预检。
Cookie携带需谨慎，
域名明确不用星。
```

**🔑 关键配置项记忆**
- `origin`：**谁能访问**（域名白名单）
- `methods`：**怎么访问**（HTTP方法）  
- `allowedHeaders`：**带什么头**（请求头白名单）
- `credentials`：**要不要Cookie**（是否携带凭据）
- `maxAge`：**缓存多久**（预检结果缓存时间）