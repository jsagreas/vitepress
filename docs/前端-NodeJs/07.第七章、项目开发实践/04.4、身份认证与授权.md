---
title: 4ã€èº«ä»½è®¤è¯ä¸æˆæƒ
---
## ğŸ“š ç›®å½•

1. [è®¤è¯ä¸æˆæƒåŸºç¡€æ¦‚å¿µ](#1-è®¤è¯ä¸æˆæƒåŸºç¡€æ¦‚å¿µ)
2. [Sessionä¼šè¯è®¤è¯](#2-Sessionä¼šè¯è®¤è¯)
3. [JWT Tokenè®¤è¯](#3-JWT-Tokenè®¤è¯)
4. [å¯†ç å®‰å…¨å¤„ç†](#4-å¯†ç å®‰å…¨å¤„ç†)
5. [æƒé™æ§åˆ¶ç³»ç»Ÿ](#5-æƒé™æ§åˆ¶ç³»ç»Ÿ)
6. [OAuth2.0æˆæƒ](#6-OAuth2.0æˆæƒ)
7. [å®è·µåº”ç”¨æŒ‡å—](#7-å®è·µåº”ç”¨æŒ‡å—)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” è®¤è¯ä¸æˆæƒåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯è®¤è¯ä¸æˆæƒ


**ğŸ¤” ç”Ÿæ´»ä¸­çš„ä¾‹å­**
```
è®¤è¯ï¼ˆAuthenticationï¼‰ï¼šè¯æ˜ä½ æ˜¯è°
- å°±åƒè¿›å…¥å°åŒºæ—¶ï¼Œé—¨å«çœ‹ä½ çš„èº«ä»½è¯
- ç¡®è®¤"ä½ ç¡®å®æ˜¯å¼ ä¸‰"

æˆæƒï¼ˆAuthorizationï¼‰ï¼šå†³å®šä½ èƒ½åšä»€ä¹ˆ  
- å°±åƒèº«ä»½è¯ç¡®è®¤åï¼Œé—¨å«æŸ¥çœ‹ä½ èƒ½è¿›å“ªæ ‹æ¥¼
- ç¡®è®¤"å¼ ä¸‰å¯ä»¥è¿›å…¥Aæ ‹ï¼Œä½†ä¸èƒ½è¿›å…¥Bæ ‹"
```

**ğŸ’¡ æŠ€æœ¯å«ä¹‰**
- **è®¤è¯**ï¼šéªŒè¯ç”¨æˆ·èº«ä»½ï¼Œç¡®è®¤ç”¨æˆ·æ˜¯åˆæ³•çš„
- **æˆæƒ**ï¼šç¡®å®šç”¨æˆ·èƒ½è®¿é—®å“ªäº›èµ„æºï¼Œèƒ½è¿›è¡Œå“ªäº›æ“ä½œ

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦è®¤è¯æˆæƒ


**ğŸ¯ æ ¸å¿ƒé—®é¢˜**
```
ç½‘ç«™å®‰å…¨çš„ä¸‰å¤§é—®é¢˜ï¼š
1. è°åœ¨è®¿é—®ï¼Ÿ â†’ è®¤è¯è§£å†³
2. èƒ½è®¿é—®ä»€ä¹ˆï¼Ÿ â†’ æˆæƒè§£å†³  
3. åšäº†ä»€ä¹ˆæ“ä½œï¼Ÿ â†’ å®¡è®¡è®°å½•è§£å†³

å®é™…åœºæ™¯ï¼š
- ç”¨æˆ·ç™»å½•åæ‰èƒ½å‘å¸–
- ç®¡ç†å‘˜æ‰èƒ½åˆ é™¤æ–‡ç« 
- VIPç”¨æˆ·æ‰èƒ½ä¸‹è½½é«˜æ¸…è§†é¢‘
```

### 1.3 å¸¸è§è®¤è¯æ–¹å¼å¯¹æ¯”


| è®¤è¯æ–¹å¼ | **å·¥ä½œåŸç†** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** | **é€‚ç”¨åœºæ™¯** |
|---------|------------|---------|---------|-------------|
| ğŸª **Session+Cookie** | `æœåŠ¡å™¨å­˜å‚¨ä¼šè¯ï¼Œå®¢æˆ·ç«¯å­˜Cookie` | `ç®€å•æ˜“ç”¨ï¼Œå®‰å…¨æ€§å¥½` | `å ç”¨æœåŠ¡å™¨å†…å­˜ï¼Œä¸é€‚åˆåˆ†å¸ƒå¼` | `ä¼ ç»ŸWebåº”ç”¨` |
| ğŸ« **JWT Token** | `è‡ªåŒ…å«ä»¤ç‰Œï¼Œæ— éœ€æœåŠ¡å™¨å­˜å‚¨` | `æ— çŠ¶æ€ï¼Œé€‚åˆåˆ†å¸ƒå¼` | `ä»¤ç‰Œè¾ƒå¤§ï¼Œéš¾ä»¥æ’¤é”€` | `APIæœåŠ¡ï¼Œç§»åŠ¨åº”ç”¨` |
| ğŸ”‘ **API Key** | `å›ºå®šå¯†é’¥æ ‡è¯†åº”ç”¨` | `ç®€å•ç›´æ¥` | `å®‰å…¨æ€§è¾ƒä½` | `æœåŠ¡é—´è°ƒç”¨` |
| ğŸŒ **OAuth2.0** | `ç¬¬ä¸‰æ–¹æˆæƒæ ‡å‡†` | `æ ‡å‡†åŒ–ï¼Œå®‰å…¨` | `å¤æ‚ï¼Œéœ€è¦ç¬¬ä¸‰æ–¹æ”¯æŒ` | `ç¬¬ä¸‰æ–¹ç™»å½•` |

---

## 2. ğŸª Sessionä¼šè¯è®¤è¯


### 2.1 Sessionè®¤è¯åŸç†


**ğŸ”„ å·¥ä½œæµç¨‹å›¾ç¤º**
```
ç”¨æˆ·ç™»å½•æµç¨‹ï¼š
å®¢æˆ·ç«¯                    æœåŠ¡å™¨
   |                        |
   |--[1]æäº¤ç”¨æˆ·åå¯†ç ------>|
   |                        |--[2]éªŒè¯ç”¨æˆ·ä¿¡æ¯
   |                        |--[3]åˆ›å»ºSession
   |                        |--[4]ç”ŸæˆSessionID  
   |<-[5]è¿”å›Cookie(SessionID)|
   |                        |
   |--[6]æºå¸¦Cookieè®¿é—®----->|
   |                        |--[7]æ ¹æ®SessionIDæŸ¥æ‰¾Session
   |<-[8]è¿”å›ç”¨æˆ·æ•°æ®--------|

æ ¸å¿ƒæ€æƒ³ï¼šæœåŠ¡å™¨è®°ä½ä½ ï¼Œå®¢æˆ·ç«¯å¸¦ç€"é—¨ç‰Œå·"
```

### 2.2 Sessionå®ç°ç¤ºä¾‹


**ğŸ“ åŸºç¡€Sessionå®ç°**
```javascript
const express = require('express');
const session = require('express-session');
const app = express();

// é…ç½®Sessionä¸­é—´ä»¶
app.use(session({
  secret: 'your-secret-key',           // ç­¾åå¯†é’¥
  resave: false,                       // ä¸å¼ºåˆ¶ä¿å­˜
  saveUninitialized: false,            // ä¸ä¿å­˜æœªåˆå§‹åŒ–session
  cookie: { 
    maxAge: 24 * 60 * 60 * 1000,      // 24å°æ—¶è¿‡æœŸ
    secure: false,                      // HTTPä¸‹è®¾ä¸ºfalse
    httpOnly: true                      // é˜²æ­¢XSSæ”»å‡»
  }
}));

// ç™»å½•æ¥å£
app.post('/login', (req, res) => {
  const { username, password } = req.body;
  
  // éªŒè¯ç”¨æˆ·åå¯†ç ï¼ˆå®é™…åº”è¯¥æŸ¥æ•°æ®åº“ï¼‰
  if (username === 'admin' && password === '123456') {
    // ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°Session
    req.session.user = {
      id: 1,
      username: 'admin',
      role: 'admin'
    };
    res.json({ success: true, message: 'ç™»å½•æˆåŠŸ' });
  } else {
    res.json({ success: false, message: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯' });
  }
});

// éœ€è¦è®¤è¯çš„æ¥å£
app.get('/profile', (req, res) => {
  if (req.session.user) {
    res.json({ user: req.session.user });
  } else {
    res.status(401).json({ message: 'è¯·å…ˆç™»å½•' });
  }
});

// é€€å‡ºç™»å½•
app.post('/logout', (req, res) => {
  req.session.destroy();  // é”€æ¯Session
  res.json({ message: 'é€€å‡ºæˆåŠŸ' });
});
```

### 2.3 Cookieå®‰å…¨é…ç½®


**ğŸ›¡ï¸ å®‰å…¨è®¾ç½®è¯´æ˜**
```javascript
app.use(session({
  secret: process.env.SESSION_SECRET,  // ä»ç¯å¢ƒå˜é‡è¯»å–
  
  cookie: {
    maxAge: 24 * 60 * 60 * 1000,     // è¿‡æœŸæ—¶é—´ï¼š24å°æ—¶
    secure: true,                     // ä»…HTTPSä¼ è¾“
    httpOnly: true,                   // ç¦æ­¢JSè®¿é—®ï¼Œé˜²XSS
    sameSite: 'strict'                // é˜²CSRFæ”»å‡»
  },
  
  store: new MongoStore({             // ä½¿ç”¨æ•°æ®åº“å­˜å‚¨
    url: 'mongodb://localhost/session'
  })
}));

å®‰å…¨è¦ç‚¹ï¼š
âœ… secretå¯†é’¥è¦è¶³å¤Ÿå¤æ‚ä¸”ä¿å¯†
âœ… httpOnlyé˜²æ­¢JSè„šæœ¬çªƒå–Cookie
âœ… secureç¡®ä¿HTTPSç¯å¢ƒä¸‹ä¼ è¾“
âœ… sameSiteé˜²æ­¢è·¨ç«™è¯·æ±‚ä¼ªé€ 
```

---

## 3. ğŸ« JWT Tokenè®¤è¯


### 3.1 JWTæ˜¯ä»€ä¹ˆ


**ğŸ¯ JWTåŸºæœ¬æ¦‚å¿µ**
```
JWT = JSON Web Token
ä½œç”¨ï¼šä¸€ç§å®‰å…¨çš„ä¿¡æ¯ä¼ è¾“æ–¹å¼
ç‰¹ç‚¹ï¼šè‡ªåŒ…å«ã€æ— çŠ¶æ€ã€å¯éªŒè¯

ç”Ÿæ´»æ¯”å–»ï¼š
Sessionåƒ"ä¼šå‘˜å¡" â†’ éœ€è¦åº—é“ºæŸ¥ä¼šå‘˜ä¿¡æ¯
JWTåƒ"èº«ä»½è¯"   â†’ è‡ªå·±å°±åŒ…å«æ‰€æœ‰ä¿¡æ¯
```

### 3.2 JWTç»“æ„è§£æ


**ğŸ“‹ JWTä¸‰éƒ¨åˆ†ç»“æ„**
```
JWTæ ¼å¼ï¼šHeader.Payload.Signature
ç¤ºä¾‹ï¼šeyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjoxLCJleHAiOjE2MzQ1Njc4OTB9.signature

ç»“æ„åˆ†è§£ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Header    â”‚.â”‚   Payload    â”‚.â”‚  Signature  â”‚
â”‚   å¤´éƒ¨ä¿¡æ¯   â”‚ â”‚   è½½è·æ•°æ®    â”‚ â”‚   ç­¾åéªŒè¯   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Headerï¼ˆå¤´éƒ¨ï¼‰ï¼š
{
  "typ": "JWT",         // ç±»å‹
  "alg": "HS256"        // ç­¾åç®—æ³•
}

Payloadï¼ˆè½½è·ï¼‰ï¼š
{
  "user_id": 1,         // ç”¨æˆ·ID
  "username": "admin",  // ç”¨æˆ·å
  "exp": 1634567890     // è¿‡æœŸæ—¶é—´
}

Signatureï¼ˆç­¾åï¼‰ï¼š
HMACSHA256(
  base64UrlEncode(header) + "." + base64UrlEncode(payload),
  secret
)
```

### 3.3 JWTå®ç°ç¤ºä¾‹


**âš¡ JWTè®¤è¯å®ç°**
```javascript
const jwt = require('jsonwebtoken');
const SECRET_KEY = 'your-secret-key';

// ç”ŸæˆToken
function generateToken(user) {
  const payload = {
    user_id: user.id,
    username: user.username,
    role: user.role
  };
  
  return jwt.sign(payload, SECRET_KEY, {
    expiresIn: '24h'        // 24å°æ—¶åè¿‡æœŸ
  });
}

// éªŒè¯Tokenä¸­é—´ä»¶
function authenticateToken(req, res, next) {
  const authHeader = req.headers['authorization'];
  const token = authHeader && authHeader.split(' ')[1]; // Bearer TOKEN
  
  if (!token) {
    return res.status(401).json({ message: 'ç¼ºå°‘è®¿é—®ä»¤ç‰Œ' });
  }
  
  jwt.verify(token, SECRET_KEY, (err, user) => {
    if (err) {
      return res.status(403).json({ message: 'ä»¤ç‰Œæ— æ•ˆæˆ–å·²è¿‡æœŸ' });
    }
    req.user = user;        // å°†ç”¨æˆ·ä¿¡æ¯é™„åŠ åˆ°è¯·æ±‚å¯¹è±¡
    next();
  });
}

// ç™»å½•æ¥å£
app.post('/login', (req, res) => {
  const { username, password } = req.body;
  
  if (username === 'admin' && password === '123456') {
    const user = { id: 1, username: 'admin', role: 'admin' };
    const token = generateToken(user);
    
    res.json({
      success: true,
      token: token,
      user: user
    });
  } else {
    res.status(401).json({ message: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯' });
  }
});

// å—ä¿æŠ¤çš„è·¯ç”±
app.get('/profile', authenticateToken, (req, res) => {
  res.json({ user: req.user });
});
```

### 3.4 åˆ·æ–°Tokenæœºåˆ¶


**ğŸ”„ Tokenåˆ·æ–°ç­–ç•¥**
```javascript
// åŒTokenç­–ç•¥ï¼šAccess Token + Refresh Token
function generateTokens(user) {
  const accessToken = jwt.sign(
    { user_id: user.id, username: user.username },
    SECRET_KEY,
    { expiresIn: '15m' }      // è®¿é—®ä»¤ç‰Œ15åˆ†é’Ÿ
  );
  
  const refreshToken = jwt.sign(
    { user_id: user.id, type: 'refresh' },
    REFRESH_SECRET,
    { expiresIn: '7d' }       // åˆ·æ–°ä»¤ç‰Œ7å¤©
  );
  
  return { accessToken, refreshToken };
}

// åˆ·æ–°Tokenæ¥å£
app.post('/refresh', (req, res) => {
  const { refreshToken } = req.body;
  
  try {
    const decoded = jwt.verify(refreshToken, REFRESH_SECRET);
    
    if (decoded.type !== 'refresh') {
      throw new Error('Invalid token type');
    }
    
    // ç”Ÿæˆæ–°çš„è®¿é—®ä»¤ç‰Œ
    const user = getUserById(decoded.user_id);
    const newAccessToken = generateToken(user);
    
    res.json({ accessToken: newAccessToken });
  } catch (err) {
    res.status(401).json({ message: 'åˆ·æ–°ä»¤ç‰Œæ— æ•ˆ' });
  }
});

ä½¿ç”¨ç­–ç•¥ï¼š
âœ… Access TokençŸ­æœŸæœ‰æ•ˆï¼ˆ15åˆ†é’Ÿï¼‰
âœ… Refresh Tokené•¿æœŸæœ‰æ•ˆï¼ˆ7å¤©ï¼‰  
âœ… Access Tokenè¿‡æœŸæ—¶ç”¨Refresh Tokenæ¢å–æ–°çš„
âœ… æé«˜å®‰å…¨æ€§åŒæ—¶ä¿è¯ç”¨æˆ·ä½“éªŒ
```

---

## 4. ğŸ”’ å¯†ç å®‰å…¨å¤„ç†


### 4.1 ä¸ºä»€ä¹ˆä¸èƒ½æ˜æ–‡å­˜å‚¨å¯†ç 


**âš ï¸ å®‰å…¨é£é™©**
```
æ˜æ–‡å¯†ç çš„å±é™©ï¼š
1. æ•°æ®åº“æ³„éœ² â†’ æ‰€æœ‰å¯†ç è¢«ç›—
2. å†…éƒ¨äººå‘˜ â†’ å¯ä»¥æŸ¥çœ‹ç”¨æˆ·å¯†ç 
3. æ—¥å¿—è®°å½• â†’ å¯èƒ½æ„å¤–è®°å½•å¯†ç 
4. ç”¨æˆ·ä¹ æƒ¯ â†’ å¾ˆå¤šç½‘ç«™ç”¨ç›¸åŒå¯†ç 

è§£å†³æ–¹æ¡ˆï¼šåŠ å¯†å­˜å‚¨å¯†ç 
```

### 4.2 bcryptå¯†ç åŠ å¯†


**ğŸ›¡ï¸ bcryptåŠ å¯†åŸç†**
```javascript
const bcrypt = require('bcrypt');

// å¯†ç åŠ å¯†
async function hashPassword(plainPassword) {
  const saltRounds = 10;  // åŠ å¯†å¼ºåº¦ï¼Œæ•°å­—è¶Šå¤§è¶Šå®‰å…¨ä½†è¶Šæ…¢
  const hashedPassword = await bcrypt.hash(plainPassword, saltRounds);
  return hashedPassword;
}

// å¯†ç éªŒè¯
async function verifyPassword(plainPassword, hashedPassword) {
  const isMatch = await bcrypt.compare(plainPassword, hashedPassword);
  return isMatch;
}

// ç”¨æˆ·æ³¨å†Œç¤ºä¾‹
app.post('/register', async (req, res) => {
  try {
    const { username, password } = req.body;
    
    // åŠ å¯†å¯†ç 
    const hashedPassword = await hashPassword(password);
    
    // ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆç¤ºä¾‹ï¼‰
    const user = {
      username: username,
      password: hashedPassword  // å­˜å‚¨åŠ å¯†åçš„å¯†ç 
    };
    
    // saveUser(user);  // å®é™…ä¿å­˜åˆ°æ•°æ®åº“
    res.json({ success: true, message: 'æ³¨å†ŒæˆåŠŸ' });
  } catch (error) {
    res.status(500).json({ message: 'æ³¨å†Œå¤±è´¥' });
  }
});

// ç”¨æˆ·ç™»å½•ç¤ºä¾‹
app.post('/login', async (req, res) => {
  try {
    const { username, password } = req.body;
    
    // ä»æ•°æ®åº“è·å–ç”¨æˆ·ï¼ˆç¤ºä¾‹ï¼‰
    const user = getUserByUsername(username);
    if (!user) {
      return res.status(401).json({ message: 'ç”¨æˆ·ä¸å­˜åœ¨' });
    }
    
    // éªŒè¯å¯†ç 
    const isValidPassword = await verifyPassword(password, user.password);
    if (isValidPassword) {
      const token = generateToken(user);
      res.json({ success: true, token: token });
    } else {
      res.status(401).json({ message: 'å¯†ç é”™è¯¯' });
    }
  } catch (error) {
    res.status(500).json({ message: 'ç™»å½•å¤±è´¥' });
  }
});
```

**ğŸ’¡ bcryptä¼˜åŠ¿**
```
ä¸ºä»€ä¹ˆé€‰æ‹©bcryptï¼š
âœ… è‡ªåŠ¨åŠ ç›ï¼šæ¯æ¬¡åŠ å¯†ç»“æœéƒ½ä¸åŒ
âœ… å¯è°ƒå¼ºåº¦ï¼šå¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´åŠ å¯†æ—¶é—´
âœ… é˜²å½©è™¹è¡¨ï¼šç›¸åŒå¯†ç åŠ å¯†åç»“æœä¸åŒ
âœ… ç»è¿‡æ—¶é—´éªŒè¯ï¼šè¢«å¹¿æ³›ä½¿ç”¨çš„æˆç†Ÿæ–¹æ¡ˆ
```

---

## 5. ğŸ‘¥ æƒé™æ§åˆ¶ç³»ç»Ÿ


### 5.1 RBACæƒé™æ¨¡å‹


**ğŸ—ï¸ RBACåŸºæœ¬æ¦‚å¿µ**
```
RBAC = Role-Based Access Controlï¼ˆåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼‰

æ ¸å¿ƒæ€æƒ³ï¼š
ç”¨æˆ· â†’ è§’è‰² â†’ æƒé™ â†’ èµ„æº

ç”Ÿæ´»ä¾‹å­ï¼š
å¼ ä¸‰(ç”¨æˆ·) â†’ ç»ç†(è§’è‰²) â†’ å®¡æ‰¹æƒé™(æƒé™) â†’ æŠ¥é”€å•(èµ„æº)

ç³»ç»Ÿè®¾è®¡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User   â”‚â”€â”€â”€â†’â”‚  Role   â”‚â”€â”€â”€â†’â”‚Permissionâ”‚â”€â”€â”€â†’â”‚Resource â”‚
â”‚  ç”¨æˆ·   â”‚    â”‚  è§’è‰²   â”‚    â”‚   æƒé™   â”‚    â”‚  èµ„æº   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 æƒé™æ§åˆ¶å®ç°


**ğŸ” æƒé™éªŒè¯ä¸­é—´ä»¶**
```javascript
// æƒé™é…ç½®
const permissions = {
  'admin': ['user:read', 'user:write', 'user:delete', 'post:*'],
  'editor': ['post:read', 'post:write', 'user:read'],
  'user': ['post:read', 'profile:read', 'profile:write']
};

// æ£€æŸ¥æƒé™ä¸­é—´ä»¶
function checkPermission(requiredPermission) {
  return (req, res, next) => {
    const user = req.user;  // ä»JWTæˆ–Sessionè·å–
    
    if (!user) {
      return res.status(401).json({ message: 'è¯·å…ˆç™»å½•' });
    }
    
    const userPermissions = permissions[user.role] || [];
    
    // æ£€æŸ¥å…·ä½“æƒé™æˆ–é€šé…ç¬¦æƒé™
    const hasPermission = userPermissions.includes(requiredPermission) ||
                         userPermissions.some(p => p.endsWith(':*') && 
                                            requiredPermission.startsWith(p.slice(0, -1)));
    
    if (hasPermission) {
      next();
    } else {
      res.status(403).json({ message: 'æƒé™ä¸è¶³' });
    }
  };
}

// ä½¿ç”¨æƒé™æ§åˆ¶
app.get('/users', authenticateToken, checkPermission('user:read'), (req, res) => {
  res.json({ users: ['user1', 'user2'] });
});

app.delete('/users/:id', authenticateToken, checkPermission('user:delete'), (req, res) => {
  res.json({ message: 'ç”¨æˆ·åˆ é™¤æˆåŠŸ' });
});

app.get('/posts', authenticateToken, checkPermission('post:read'), (req, res) => {
  res.json({ posts: ['post1', 'post2'] });
});
```

### 5.3 åŠ¨æ€æƒé™æ§åˆ¶


**âš¡ çµæ´»æƒé™ç³»ç»Ÿ**
```javascript
// æ›´çµæ´»çš„æƒé™æ£€æŸ¥
function hasPermission(user, action, resource, resourceId = null) {
  const userRole = user.role;
  const userPermissions = permissions[userRole] || [];
  
  // 1. æ£€æŸ¥é€šç”¨æƒé™
  if (userPermissions.includes(`${resource}:${action}`)) {
    return true;
  }
  
  // 2. æ£€æŸ¥é€šé…ç¬¦æƒé™
  if (userPermissions.includes(`${resource}:*`)) {
    return true;
  }
  
  // 3. æ£€æŸ¥èµ„æºæ‰€æœ‰è€…æƒé™
  if (resourceId && user.id === resourceId && action === 'write') {
    return true;  // ç”¨æˆ·å¯ä»¥ç¼–è¾‘è‡ªå·±çš„å†…å®¹
  }
  
  return false;
}

// èµ„æºçº§åˆ«æƒé™æ§åˆ¶
app.put('/posts/:id', authenticateToken, async (req, res) => {
  const postId = req.params.id;
  const user = req.user;
  
  // è·å–æ–‡ç« ä¿¡æ¯
  const post = await getPostById(postId);
  
  // æ£€æŸ¥æƒé™ï¼šç®¡ç†å‘˜ æˆ– æ–‡ç« ä½œè€…
  if (hasPermission(user, 'write', 'post') || post.authorId === user.id) {
    // æ‰§è¡Œæ›´æ–°æ“ä½œ
    res.json({ message: 'æ›´æ–°æˆåŠŸ' });
  } else {
    res.status(403).json({ message: 'åªèƒ½ç¼–è¾‘è‡ªå·±çš„æ–‡ç« ' });
  }
});
```

---

## 6. ğŸŒ OAuth2.0æˆæƒ


### 6.1 OAuth2.0åŸºæœ¬æ¦‚å¿µ


**ğŸ¤ OAuth2.0å·¥ä½œåŸç†**
```
OAuth2.0æ˜¯ä»€ä¹ˆï¼š
- ä¸€ç§æˆæƒæ ‡å‡†åè®®
- å…è®¸ç¬¬ä¸‰æ–¹åº”ç”¨è®¿é—®ç”¨æˆ·èµ„æº
- æ— éœ€æš´éœ²ç”¨æˆ·å¯†ç 

ç”Ÿæ´»ä¾‹å­ï¼š
ä½ æƒ³ç”¨ç¾å›¢ç‚¹å¤–å–ï¼Œä½†ä¸æƒ³æ³¨å†Œæ–°è´¦å·
â†’ é€‰æ‹©"å¾®ä¿¡ç™»å½•"
â†’ å¾®ä¿¡é—®ä½ ï¼šæ˜¯å¦æˆæƒç¾å›¢è·å–ä½ çš„åŸºæœ¬ä¿¡æ¯ï¼Ÿ
â†’ ä½ åŒæ„åï¼Œç¾å›¢å°±èƒ½è·å–ä½ çš„å¾®ä¿¡å¤´åƒã€æ˜µç§°ç­‰
â†’ ä½†ç¾å›¢æ°¸è¿œä¸çŸ¥é“ä½ çš„å¾®ä¿¡å¯†ç 

å››ä¸ªè§’è‰²ï¼š
ğŸ™ Resource Ownerï¼ˆèµ„æºæ‰€æœ‰è€…ï¼‰ï¼šç”¨æˆ·
ğŸ¢ Resource Serverï¼ˆèµ„æºæœåŠ¡å™¨ï¼‰ï¼šå¾®ä¿¡æœåŠ¡å™¨
ğŸ” Authorization Serverï¼ˆæˆæƒæœåŠ¡å™¨ï¼‰ï¼šå¾®ä¿¡æˆæƒæœåŠ¡å™¨  
ğŸ“± Clientï¼ˆå®¢æˆ·ç«¯ï¼‰ï¼šç¾å›¢App
```

### 6.2 æˆæƒç æµç¨‹


**ğŸ”„ OAuth2.0æˆæƒæµç¨‹**
```
æˆæƒç æ¨¡å¼æµç¨‹ï¼ˆæœ€å¸¸ç”¨ï¼‰ï¼š

ç”¨æˆ·               å®¢æˆ·ç«¯(ç¾å›¢)          æˆæƒæœåŠ¡å™¨(å¾®ä¿¡)
 |                     |                      |
 |--[1]ç‚¹å‡»å¾®ä¿¡ç™»å½•---->|                      |
 |                     |--[2]é‡å®šå‘åˆ°å¾®ä¿¡----->|
 |                     |                      |
 |<----[3]æ˜¾ç¤ºæˆæƒé¡µé¢------------------|
 |                     |                      |
 |--[4]ç”¨æˆ·åŒæ„æˆæƒ------------------->|
 |                     |                      |
 |                     |<--[5]è¿”å›æˆæƒç ------|
 |                     |                      |
 |                     |--[6]ç”¨æˆæƒç æ¢Token-->|
 |                     |<--[7]è¿”å›Access Token|
 |                     |                      |
 |                     |--[8]ç”¨Tokenè·å–ç”¨æˆ·ä¿¡æ¯
 |<--[9]ç™»å½•æˆåŠŸ-------|                      |

å…³é”®å‚æ•°ï¼š
- client_idï¼šåº”ç”¨æ ‡è¯†
- redirect_uriï¼šå›è°ƒåœ°å€  
- response_typeï¼šå“åº”ç±»å‹ï¼ˆcodeï¼‰
- scopeï¼šæƒé™èŒƒå›´
- stateï¼šé˜²CSRFæ”»å‡»çš„éšæœºå€¼
```

### 6.3 ç®€å•OAuthå®ç°


**ğŸ“ æ¨¡æ‹ŸOAuthæµç¨‹**
```javascript
const express = require('express');
const axios = require('axios');

// å¾®ä¿¡ç™»å½•é…ç½®
const WECHAT_CONFIG = {
  appId: 'your_wechat_app_id',
  appSecret: 'your_wechat_app_secret',
  redirectUri: 'http://localhost:3000/auth/wechat/callback'
};

// 1. å‘èµ·æˆæƒè¯·æ±‚
app.get('/auth/wechat', (req, res) => {
  const state = Math.random().toString(36).substr(2); // éšæœºçŠ¶æ€å€¼
  req.session.oauthState = state; // ä¿å­˜çŠ¶æ€å€¼
  
  const authUrl = `https://open.weixin.qq.com/connect/qrconnect?` +
    `appid=${WECHAT_CONFIG.appId}&` +
    `redirect_uri=${encodeURIComponent(WECHAT_CONFIG.redirectUri)}&` +
    `response_type=code&` +
    `scope=snsapi_login&` +
    `state=${state}`;
  
  res.redirect(authUrl);
});

// 2. å¤„ç†æˆæƒå›è°ƒ
app.get('/auth/wechat/callback', async (req, res) => {
  const { code, state } = req.query;
  
  // éªŒè¯stateé˜²æ­¢CSRFæ”»å‡»
  if (state !== req.session.oauthState) {
    return res.status(400).json({ error: 'çŠ¶æ€éªŒè¯å¤±è´¥' });
  }
  
  try {
    // 3. ç”¨æˆæƒç æ¢å–access_token
    const tokenResponse = await axios.get('https://api.weixin.qq.com/sns/oauth2/access_token', {
      params: {
        appid: WECHAT_CONFIG.appId,
        secret: WECHAT_CONFIG.appSecret,
        code: code,
        grant_type: 'authorization_code'
      }
    });
    
    const { access_token, openid } = tokenResponse.data;
    
    // 4. ç”¨access_tokenè·å–ç”¨æˆ·ä¿¡æ¯
    const userResponse = await axios.get('https://api.weixin.qq.com/sns/userinfo', {
      params: {
        access_token: access_token,
        openid: openid
      }
    });
    
    const userInfo = userResponse.data;
    
    // 5. åˆ›å»ºæˆ–æ›´æ–°æœ¬åœ°ç”¨æˆ·
    let user = await findUserByOpenId(openid);
    if (!user) {
      user = await createUser({
        openid: openid,
        nickname: userInfo.nickname,
        avatar: userInfo.headimgurl
      });
    }
    
    // 6. ç”Ÿæˆæœ¬åœ°JWT token
    const token = generateToken(user);
    
    res.json({
      success: true,
      token: token,
      user: user
    });
    
  } catch (error) {
    res.status(500).json({ error: 'æˆæƒå¤±è´¥' });
  }
});
```

---

## 7. ğŸš€ å®è·µåº”ç”¨æŒ‡å—


### 7.1 é€‰æ‹©åˆé€‚çš„è®¤è¯æ–¹æ¡ˆ


**ğŸ¤” æ–¹æ¡ˆé€‰æ‹©æŒ‡å—**
```
ä¼ ç»ŸWebåº”ç”¨ï¼š
âœ… ä½¿ç”¨Session + Cookie
âœ… æœåŠ¡å™¨æ¸²æŸ“é¡µé¢
âœ… ç”¨æˆ·çŠ¶æ€å­˜å‚¨åœ¨æœåŠ¡å™¨

å•é¡µåº”ç”¨(SPA)ï¼š
âœ… ä½¿ç”¨JWT Token
âœ… å‰åç«¯åˆ†ç¦»
âœ… Tokenå­˜å‚¨åœ¨localStorage/sessionStorage

ç§»åŠ¨Appï¼š
âœ… ä½¿ç”¨JWT Token
âœ… æ”¯æŒç¦»çº¿éªŒè¯
âœ… å®ç°Tokenè‡ªåŠ¨åˆ·æ–°

å¾®æœåŠ¡æ¶æ„ï¼š
âœ… ä½¿ç”¨JWT Token
âœ… æ— çŠ¶æ€ï¼Œæ˜“æ‰©å±•
âœ… æœåŠ¡é—´ç»Ÿä¸€è®¤è¯

ç¬¬ä¸‰æ–¹é›†æˆï¼š
âœ… ä½¿ç”¨OAuth2.0
âœ… æ ‡å‡†åŒ–æµç¨‹
âœ… ç”¨æˆ·ä½“éªŒå¥½
```

### 7.2 å®‰å…¨æœ€ä½³å®è·µ


**ğŸ›¡ï¸ å®‰å…¨é˜²æŠ¤è¦ç‚¹**
```javascript
// 1. å¼ºå¯†ç ç­–ç•¥
function validatePassword(password) {
  const minLength = 8;
  const hasUpper = /[A-Z]/.test(password);
  const hasLower = /[a-z]/.test(password);
  const hasNumber = /\d/.test(password);
  const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(password);
  
  return password.length >= minLength && hasUpper && hasLower && hasNumber && hasSpecial;
}

// 2. ç™»å½•é¢‘ç‡é™åˆ¶
const loginAttempts = new Map();

function rateLimitLogin(req, res, next) {
  const ip = req.ip;
  const attempts = loginAttempts.get(ip) || { count: 0, lastAttempt: Date.now() };
  
  if (attempts.count >= 5 && Date.now() - attempts.lastAttempt < 15 * 60 * 1000) {
    return res.status(429).json({ message: 'ç™»å½•å°è¯•è¿‡äºé¢‘ç¹ï¼Œè¯·15åˆ†é’Ÿåå†è¯•' });
  }
  
  next();
}

// 3. HTTPSå¼ºåˆ¶
function requireHTTPS(req, res, next) {
  if (process.env.NODE_ENV === 'production' && req.header('x-forwarded-proto') !== 'https') {
    return res.redirect(`https://${req.header('host')}${req.url}`);
  }
  next();
}

// 4. æ•æ„Ÿæ“ä½œäºŒæ¬¡éªŒè¯
app.delete('/account', authenticateToken, async (req, res) => {
  const { password } = req.body;
  const user = await getUserById(req.user.user_id);
  
  // åˆ é™¤è´¦æˆ·å‰è¦æ±‚è¾“å…¥å¯†ç ç¡®è®¤
  const isValidPassword = await verifyPassword(password, user.password);
  if (!isValidPassword) {
    return res.status(401).json({ message: 'å¯†ç éªŒè¯å¤±è´¥' });
  }
  
  // æ‰§è¡Œåˆ é™¤æ“ä½œ
  await deleteUser(user.id);
  res.json({ message: 'è´¦æˆ·åˆ é™¤æˆåŠŸ' });
});
```

### 7.3 å¸¸è§å®‰å…¨æ¼æ´é˜²æŠ¤


**âš ï¸ å®‰å…¨å¨èƒä¸é˜²æŠ¤**
```javascript
// 1. XSSæ”»å‡»é˜²æŠ¤
const helmet = require('helmet');
app.use(helmet()); // è®¾ç½®å®‰å…¨ç›¸å…³çš„HTTPå¤´

// 2. CSRFæ”»å‡»é˜²æŠ¤  
const csrf = require('csurf');
app.use(csrf({ cookie: true }));

// 3. SQLæ³¨å…¥é˜²æŠ¤ï¼ˆä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ï¼‰
// âŒ é”™è¯¯æ–¹å¼
const query = `SELECT * FROM users WHERE username = '${username}'`;

// âœ… æ­£ç¡®æ–¹å¼
const query = 'SELECT * FROM users WHERE username = ?';
db.query(query, [username]);

// 4. ä¼šè¯å›ºå®šæ”»å‡»é˜²æŠ¤
app.post('/login', (req, res) => {
  // ç™»å½•æˆåŠŸåé‡æ–°ç”Ÿæˆsession ID
  req.session.regenerate((err) => {
    if (err) {
      return res.status(500).json({ error: 'ç™»å½•å¤±è´¥' });
    }
    
    req.session.user = user;
    res.json({ success: true });
  });
});

// 5. æ•æ„Ÿä¿¡æ¯è¿‡æ»¤
function sanitizeUser(user) {
  const { password, ...safeUser } = user;
  return safeUser; // æ°¸è¿œä¸è¦è¿”å›å¯†ç å­—æ®µ
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ è®¤è¯vsæˆæƒï¼šè®¤è¯ç¡®è®¤èº«ä»½ï¼Œæˆæƒå†³å®šæƒé™
ğŸ”¸ Sessionæœºåˆ¶ï¼šæœåŠ¡å™¨å­˜å‚¨çŠ¶æ€ï¼Œå®¢æˆ·ç«¯å­˜å‚¨ä¼šè¯ID
ğŸ”¸ JWTåŸç†ï¼šè‡ªåŒ…å«ä»¤ç‰Œï¼Œæ— éœ€æœåŠ¡å™¨å­˜å‚¨çŠ¶æ€
ğŸ”¸ å¯†ç åŠ å¯†ï¼šä½¿ç”¨bcryptç­‰å®‰å…¨ç®—æ³•ï¼Œæ°¸ä¸æ˜æ–‡å­˜å‚¨
ğŸ”¸ æƒé™æ§åˆ¶ï¼šRBACæ¨¡å‹ï¼Œç”¨æˆ·-è§’è‰²-æƒé™-èµ„æº
ğŸ”¸ OAuth2.0ï¼šç¬¬ä¸‰æ–¹æˆæƒæ ‡å‡†ï¼Œå®ç°å•ç‚¹ç™»å½•
```

### 8.2 å…³é”®å®è·µè¦ç‚¹


**ğŸ”¹ è®¤è¯æ–¹æ¡ˆé€‰æ‹©**
```
è€ƒè™‘å› ç´ ï¼š
- åº”ç”¨ç±»å‹ï¼šWebåº”ç”¨vsç§»åŠ¨åº”ç”¨vså¾®æœåŠ¡
- ç”¨æˆ·ä½“éªŒï¼šç™»å½•é¢‘ç‡vså®‰å…¨è¦æ±‚
- æŠ€æœ¯æ¶æ„ï¼šå•ä½“åº”ç”¨vsåˆ†å¸ƒå¼ç³»ç»Ÿ
- æ‰©å±•éœ€æ±‚ï¼šæ˜¯å¦éœ€è¦ç¬¬ä¸‰æ–¹ç™»å½•

é€‰æ‹©å»ºè®®ï¼š
ä¼ ç»ŸWeb â†’ Session + Cookie
ç°ä»£SPA â†’ JWT Token  
ç§»åŠ¨åº”ç”¨ â†’ JWT + è‡ªåŠ¨åˆ·æ–°
ä¼ä¸šåº”ç”¨ â†’ OAuth2.0 + SSO
```

**ğŸ”¹ å®‰å…¨é˜²æŠ¤ç­–ç•¥**
```
å¯†ç å®‰å…¨ï¼š
âœ… å¼ºå¯†ç ç­–ç•¥
âœ… bcryptåŠ å¯†å­˜å‚¨
âœ… é˜²æš´åŠ›ç ´è§£ï¼ˆç™»å½•é™åˆ¶ï¼‰

ä¼šè¯å®‰å…¨ï¼š
âœ… HTTPSä¼ è¾“
âœ… å®‰å…¨çš„Cookieè®¾ç½®
âœ… ä¼šè¯è¶…æ—¶æ§åˆ¶

Tokenå®‰å…¨ï¼š
âœ… çŸ­æœŸæœ‰æ•ˆæœŸ
âœ… åˆ·æ–°Tokenæœºåˆ¶
âœ… å®‰å…¨çš„å­˜å‚¨æ–¹å¼
```

### 8.3 å®é™…åº”ç”¨å»ºè®®


**ğŸ¯ å¼€å‘å®è·µ**
- **æ¸è¿›å¼å®ç°**ï¼šå…ˆå®ç°åŸºç¡€è®¤è¯ï¼Œå†æ·»åŠ é«˜çº§åŠŸèƒ½
- **å®‰å…¨ä¼˜å…ˆ**ï¼šå®å¯ç”¨æˆ·ä½“éªŒç¨å·®ï¼Œä¹Ÿè¦ä¿è¯å®‰å…¨æ€§
- **æ—¥å¿—è®°å½•**ï¼šè®°å½•æ‰€æœ‰è®¤è¯æˆæƒç›¸å…³æ“ä½œ
- **é”™è¯¯å¤„ç†**ï¼šç»Ÿä¸€çš„é”™è¯¯å“åº”æ ¼å¼ï¼Œä¸æ³„éœ²æ•æ„Ÿä¿¡æ¯
- **æµ‹è¯•è¦†ç›–**ï¼šè®¤è¯æˆæƒé€»è¾‘å¿…é¡»æœ‰å®Œæ•´çš„æµ‹è¯•ç”¨ä¾‹

**ğŸ”§ è¿ç»´ç›‘æ§**
- **å¼‚å¸¸ç™»å½•ç›‘æ§**ï¼šå¼‚åœ°ç™»å½•ã€é¢‘ç¹å¤±è´¥ç­‰
- **Tokenä½¿ç”¨ç›‘æ§**ï¼šè¿‡æœŸç‡ã€åˆ·æ–°é¢‘ç‡ç­‰
- **æƒé™ä½¿ç”¨ç»Ÿè®¡**ï¼šå“ªäº›æƒé™è¢«é¢‘ç¹ä½¿ç”¨
- **å®‰å…¨äº‹ä»¶å‘Šè­¦**ï¼šå¯ç–‘çš„è®¿é—®è¡Œä¸º

**æ ¸å¿ƒè®°å¿†**ï¼š
- è®¤è¯è¯æ˜èº«ä»½ï¼Œæˆæƒæ§åˆ¶æƒé™ï¼Œä¸¤è€…ç¼ºä¸€ä¸å¯
- Sessioné€‚åˆä¼ ç»ŸWebï¼ŒJWTé€‚åˆç°ä»£åº”ç”¨
- å¯†ç æ°¸è¿œä¸æ˜æ–‡ï¼Œbcryptæ˜¯å¥½é€‰æ‹©
- æƒé™æ§åˆ¶è¦ç»†ç²’åº¦ï¼ŒRBACæ˜¯å¥½æ¨¡å‹
- å®‰å…¨æ— å°äº‹ï¼Œé˜²æŠ¤è¦å…¨é¢