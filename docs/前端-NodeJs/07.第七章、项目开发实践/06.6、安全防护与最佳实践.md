---
title: 6ã€å®‰å…¨é˜²æŠ¤ä¸æœ€ä½³å®è·µ
---
## ğŸ“š ç›®å½•

1. [Webå®‰å…¨å¨èƒæ¦‚è¿°](#1-Webå®‰å…¨å¨èƒæ¦‚è¿°)
2. [XSSæ”»å‡»é˜²æŠ¤](#2-XSSæ”»å‡»é˜²æŠ¤)
3. [CSRFæ”»å‡»é˜²æŠ¤](#3-CSRFæ”»å‡»é˜²æŠ¤)
4. [SQLæ³¨å…¥é˜²æŠ¤](#4-SQLæ³¨å…¥é˜²æŠ¤)
5. [Helmetå®‰å…¨ä¸­é—´ä»¶](#5-Helmetå®‰å…¨ä¸­é—´ä»¶)
6. [HTTPSä¸å®‰å…¨ä¼ è¾“](#6-HTTPSä¸å®‰å…¨ä¼ è¾“)
7. [è¾“å…¥éªŒè¯ä¸æ•°æ®æ¸…æ´—](#7-è¾“å…¥éªŒè¯ä¸æ•°æ®æ¸…æ´—)
8. [æƒé™æ§åˆ¶ä¸è®¿é—®ç®¡ç†](#8-æƒé™æ§åˆ¶ä¸è®¿é—®ç®¡ç†)
9. [å®‰å…¨é…ç½®æœ€ä½³å®è·µ](#9-å®‰å…¨é…ç½®æœ€ä½³å®è·µ)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”’ Webå®‰å…¨å¨èƒæ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯Webå®‰å…¨


> ğŸ’¡ **æ ¸å¿ƒæ¦‚å¿µ**ï¼šWebå®‰å…¨å°±æ˜¯ä¿æŠ¤ç½‘ç«™å’Œç”¨æˆ·å…å—æ¶æ„æ”»å‡»
> 
> ç®€å•æ¥è¯´ï¼Œå°±åƒç»™ä½ çš„æˆ¿å­è£…é˜²ç›—é—¨ã€çª—æˆ·è£…é˜²æŠ¤æ ä¸€æ ·ï¼ŒWebå®‰å…¨æ˜¯ç»™ç½‘ç«™è£…"é˜²æŠ¤æªæ–½"

**å¸¸è§çš„ç½‘ç»œæ”»å‡»ç±»å‹**ï¼š

```
ğŸ¯ ä¸»è¦å¨èƒç±»å‹ï¼š

XSSæ”»å‡»     â†’ åœ¨ç½‘é¡µä¸­æ’å…¥æ¶æ„ä»£ç 
CSRFæ”»å‡»    â†’ å†’å……ç”¨æˆ·æ‰§è¡Œæ¶æ„æ“ä½œ
SQLæ³¨å…¥     â†’ é€šè¿‡è¾“å…¥æ¡†æ”»å‡»æ•°æ®åº“
ç‚¹å‡»åŠ«æŒ     â†’ è¯±éª—ç”¨æˆ·ç‚¹å‡»éšè—é“¾æ¥
æ•°æ®æ³„éœ²     â†’ æ•æ„Ÿä¿¡æ¯è¢«éæ³•è·å–
```

### 1.2 ä¸ºä»€ä¹ˆNode.jsåº”ç”¨éœ€è¦å®‰å…¨é˜²æŠ¤


**é£é™©åœºæ™¯ç¤ºä¾‹**ï¼š
- ğŸ”¥ **ç”¨æˆ·ç™»å½•è¢«ç›—**ï¼šé»‘å®¢è·å–ç”¨æˆ·è´¦å·å¯†ç 
- ğŸ’° **èµ„é‡‘è¢«è½¬èµ°**ï¼šæ¶æ„ç¨‹åºè‡ªåŠ¨è½¬è´¦
- ğŸ“± **ä¿¡æ¯è¢«çªƒå–**ï¼šä¸ªäººéšç§æ•°æ®æ³„éœ²
- ğŸŒ **ç½‘ç«™è¢«ç¯¡æ”¹**ï¼šé¦–é¡µè¢«æ¤å…¥å¹¿å‘Šæˆ–ç—…æ¯’

### 1.3 å®‰å…¨é˜²æŠ¤çš„åŸºæœ¬åŸåˆ™


```
ğŸ›¡ï¸ é˜²æŠ¤ä¸‰åŸåˆ™ï¼š

é˜²æ‚£äºæœªç„¶  â†’ æå‰è®¾ç½®é˜²æŠ¤æªæ–½
å±‚å±‚è®¾é˜²   â†’ å¤šé‡å®‰å…¨æœºåˆ¶ä¿æŠ¤
æŒç»­ç›‘æ§   â†’ åŠæ—¶å‘ç°å’Œå¤„ç†å¨èƒ
```

---

## 2. âš¡ XSSæ”»å‡»é˜²æŠ¤


### 2.1 ä»€ä¹ˆæ˜¯XSSæ”»å‡»


> ğŸ’¡ **é€šä¿—è§£é‡Š**ï¼šXSSå°±åƒæœ‰äººåœ¨ä½ çš„ç½‘é¡µé‡Œå·å·æ”¾äº†ä¸€æ®µæ¶æ„ä»£ç 
> 
> å½“ç”¨æˆ·è®¿é—®è¿™ä¸ªé¡µé¢æ—¶ï¼Œæ¶æ„ä»£ç å°±ä¼šè‡ªåŠ¨æ‰§è¡Œï¼Œå¯èƒ½ä¼šçªƒå–ç”¨æˆ·ä¿¡æ¯

**XSSæ”»å‡»ç¤ºä¾‹**ï¼š
```javascript
// å±é™©çš„ç”¨æˆ·è¾“å…¥
const userInput = '<script>alert("ä½ è¢«æ”»å‡»äº†ï¼")</script>';

// å¦‚æœç›´æ¥æ˜¾ç¤ºåœ¨ç½‘é¡µä¸Šï¼Œå°±ä¼šæ‰§è¡Œæ¶æ„ä»£ç 
document.innerHTML = userInput; // âŒ å±é™©ï¼
```

### 2.2 XSSæ”»å‡»çš„ç±»å‹


**ğŸ”¸ å­˜å‚¨å‹XSS**ï¼š
```
æ”»å‡»æµç¨‹ï¼š
ç”¨æˆ·A â†’ åœ¨è¯„è®ºæ¡†è¾“å…¥æ¶æ„ä»£ç  â†’ å­˜å‚¨åˆ°æ•°æ®åº“
ç”¨æˆ·B â†’ è®¿é—®é¡µé¢çœ‹è¯„è®º â†’ æ¶æ„ä»£ç æ‰§è¡Œ â†’ ç”¨æˆ·Bè¢«æ”»å‡»

å®é™…ä¾‹å­ï¼šè®ºå›è¯„è®ºã€ç”¨æˆ·èµ„æ–™ç­‰
```

**ğŸ”¸ åå°„å‹XSS**ï¼š
```
æ”»å‡»æµç¨‹ï¼š
é»‘å®¢ â†’ åˆ¶ä½œåŒ…å«æ¶æ„ä»£ç çš„é“¾æ¥ â†’ å‘é€ç»™ç”¨æˆ·
ç”¨æˆ· â†’ ç‚¹å‡»é“¾æ¥ â†’ ç½‘ç«™æ˜¾ç¤ºæ¶æ„ä»£ç  â†’ ç”¨æˆ·è¢«æ”»å‡»

å®é™…ä¾‹å­ï¼šæœç´¢ç»“æœé¡µé¢ã€é”™è¯¯æç¤ºé¡µé¢
```

### 2.3 XSSé˜²æŠ¤æ–¹æ³•


**âœ… æ–¹æ³•1ï¼šè¾“å‡ºç¼–ç **
```javascript
// å®‰å…¨çš„æ•°æ®æ˜¾ç¤ºæ–¹å¼
function escapeHtml(text) {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  
  return text.replace(/[&<>"']/g, function(m) { 
    return map[m]; 
  });
}

// ä½¿ç”¨ç¤ºä¾‹
const userInput = '<script>alert("æ”»å‡»")</script>';
const safeOutput = escapeHtml(userInput);
// ç»“æœï¼š&lt;script&gt;alert("æ”»å‡»")&lt;/script&gt;
```

**âœ… æ–¹æ³•2ï¼šä½¿ç”¨æ¨¡æ¿å¼•æ“çš„è‡ªåŠ¨è½¬ä¹‰**
```javascript
// EJSæ¨¡æ¿ - è‡ªåŠ¨è½¬ä¹‰
app.set('view engine', 'ejs');

// åœ¨æ¨¡æ¿ä¸­
<%= userInput %> <!-- è‡ªåŠ¨è½¬ä¹‰ï¼Œå®‰å…¨ -->
<%- userInput %> <!-- ä¸è½¬ä¹‰ï¼Œå±é™© -->
```

**âœ… æ–¹æ³•3ï¼šå†…å®¹å®‰å…¨ç­–ç•¥(CSP)**
```javascript
// è®¾ç½®CSPå¤´éƒ¨
app.use((req, res, next) => {
  res.setHeader(
    'Content-Security-Policy',
    "default-src 'self'; script-src 'self' 'unsafe-inline'"
  );
  next();
});
```

---

## 3. ğŸ”„ CSRFæ”»å‡»é˜²æŠ¤


### 3.1 ä»€ä¹ˆæ˜¯CSRFæ”»å‡»


> ğŸ’¡ **é€šä¿—è§£é‡Š**ï¼šCSRFå°±åƒæœ‰äººå†’å……ä½ çš„èº«ä»½å»é“¶è¡Œè½¬è´¦
> 
> å½“ä½ ç™»å½•ç½‘ç«™åï¼Œæ¶æ„ç½‘ç«™åˆ©ç”¨ä½ çš„ç™»å½•çŠ¶æ€ï¼Œå·å·æ‰§è¡Œä¸€äº›æ“ä½œ

**CSRFæ”»å‡»æµç¨‹**ï¼š
```
çœŸå®åœºæ™¯æ¨¡æ‹Ÿï¼š

1. ç”¨æˆ·ç™»å½•é“¶è¡Œç½‘ç«™ â†’ è·å¾—ç™»å½•å‡­è¯(Cookie)
2. åœ¨åŒä¸€æµè§ˆå™¨æ‰“å¼€æ¶æ„ç½‘ç«™
3. æ¶æ„ç½‘ç«™åŒ…å«éšè—çš„è½¬è´¦è¡¨å•
4. è¡¨å•è‡ªåŠ¨æäº¤åˆ°é“¶è¡Œç½‘ç«™
5. é“¶è¡Œç½‘ç«™è®¤ä¸ºæ˜¯ç”¨æˆ·æœ¬äººæ“ä½œ â†’ æ‰§è¡Œè½¬è´¦
```

### 3.2 CSRFé˜²æŠ¤æ–¹æ³•


**âœ… æ–¹æ³•1ï¼šCSRF TokenéªŒè¯**
```javascript
const csrf = require('csurf');

// å¯ç”¨CSRFä¿æŠ¤
const csrfProtection = csrf({ cookie: true });
app.use(csrfProtection);

// åœ¨è¡¨å•ä¸­åŒ…å«CSRF token
app.get('/form', (req, res) => {
  res.render('form', { 
    csrfToken: req.csrfToken() 
  });
});

// è¡¨å•æ¨¡æ¿
// <input type="hidden" name="_csrf" value="<%= csrfToken %>">
```

**âœ… æ–¹æ³•2ï¼šåŒæºæ£€æŸ¥**
```javascript
// æ£€æŸ¥è¯·æ±‚æ¥æº
app.use((req, res, next) => {
  const origin = req.headers.origin;
  const host = req.headers.host;
  
  if (origin && !origin.includes(host)) {
    return res.status(403).send('ç¦æ­¢è·¨åŸŸè¯·æ±‚');
  }
  
  next();
});
```

**âœ… æ–¹æ³•3ï¼šåŒé‡CookieéªŒè¯**
```javascript
// è®¾ç½®CSRF cookie
app.use((req, res, next) => {
  if (!req.cookies.csrf) {
    const token = generateRandomToken();
    res.cookie('csrf', token);
    req.csrf = token;
  }
  next();
});

// éªŒè¯è¯·æ±‚
app.post('/api/*', (req, res, next) => {
  const cookieToken = req.cookies.csrf;
  const headerToken = req.headers['x-csrf-token'];
  
  if (cookieToken !== headerToken) {
    return res.status(403).send('CSRFéªŒè¯å¤±è´¥');
  }
  
  next();
});
```

---

## 4. ğŸ—„ï¸ SQLæ³¨å…¥é˜²æŠ¤


### 4.1 ä»€ä¹ˆæ˜¯SQLæ³¨å…¥


> ğŸ’¡ **é€šä¿—è§£é‡Š**ï¼šSQLæ³¨å…¥å°±åƒæœ‰äººåœ¨ä½ çš„æ•°æ®åº“æŸ¥è¯¢ä¸­å·å·åŠ äº†æ¶æ„å‘½ä»¤
> 
> åŸæœ¬åªæ˜¯æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œç»“æœå˜æˆäº†åˆ é™¤æ•´ä¸ªæ•°æ®åº“

**SQLæ³¨å…¥ç¤ºä¾‹**ï¼š
```javascript
// âŒ å±é™©çš„æ•°æ®åº“æŸ¥è¯¢
const username = req.body.username; // ç”¨æˆ·è¾“å…¥ï¼šadmin'; DROP TABLE users; --
const query = `SELECT * FROM users WHERE username = '${username}'`;

// æœ€ç»ˆæ‰§è¡Œçš„SQLï¼š
// SELECT * FROM users WHERE username = 'admin'; DROP TABLE users; --'
// ç»“æœï¼šç”¨æˆ·è¡¨è¢«åˆ é™¤ï¼
```

### 4.2 SQLæ³¨å…¥é˜²æŠ¤æ–¹æ³•


**âœ… æ–¹æ³•1ï¼šå‚æ•°åŒ–æŸ¥è¯¢**
```javascript
// ä½¿ç”¨MySQLå‚æ•°åŒ–æŸ¥è¯¢
const mysql = require('mysql2');

// å®‰å…¨çš„æŸ¥è¯¢æ–¹å¼
const query = 'SELECT * FROM users WHERE username = ? AND password = ?';
const values = [req.body.username, req.body.password];

db.execute(query, values, (err, results) => {
  // å¤„ç†ç»“æœ
});
```

**âœ… æ–¹æ³•2ï¼šORMæ¡†æ¶ä¿æŠ¤**
```javascript
// ä½¿ç”¨Sequelize ORM
const User = require('./models/User');

// è‡ªåŠ¨é˜²SQLæ³¨å…¥
const user = await User.findOne({
  where: {
    username: req.body.username,
    password: req.body.password
  }
});
```

**âœ… æ–¹æ³•3ï¼šè¾“å…¥éªŒè¯å’Œè¿‡æ»¤**
```javascript
// è¾“å…¥éªŒè¯
function validateInput(input) {
  // ç§»é™¤å±é™©å­—ç¬¦
  const dangerous = /['";\-\-\/\*]/g;
  return input.replace(dangerous, '');
}

// ç™½åå•éªŒè¯
function isValidUsername(username) {
  const pattern = /^[a-zA-Z0-9_]{3,20}$/;
  return pattern.test(username);
}
```

---

## 5. ğŸ›¡ï¸ Helmetå®‰å…¨ä¸­é—´ä»¶


### 5.1 ä»€ä¹ˆæ˜¯Helmet


> ğŸ’¡ **é€šä¿—è§£é‡Š**ï¼šHelmetå°±åƒç»™ç½‘ç«™æˆ´äº†ä¸€ä¸ª"å®‰å…¨å¤´ç›”"
> 
> å®ƒä¼šè‡ªåŠ¨è®¾ç½®å¾ˆå¤šå®‰å…¨ç›¸å…³çš„HTTPå¤´éƒ¨ï¼Œä¿æŠ¤ç½‘ç«™å…å—å¸¸è§æ”»å‡»

### 5.2 HelmetåŸºæœ¬ä½¿ç”¨


```javascript
const helmet = require('helmet');

// ä½¿ç”¨é»˜è®¤å®‰å…¨è®¾ç½®
app.use(helmet());

// ç­‰åŒäºè®¾ç½®å¤šä¸ªå®‰å…¨å¤´éƒ¨ï¼š
// X-Content-Type-Options: nosniff
// X-Frame-Options: DENY  
// X-XSS-Protection: 1; mode=block
// ç­‰ç­‰...
```

### 5.3 Helmetä¸»è¦åŠŸèƒ½


**ğŸ”¸ é˜²æ­¢ç‚¹å‡»åŠ«æŒ**
```javascript
// X-Frame-Optionså¤´éƒ¨
app.use(helmet.frameguard({ 
  action: 'deny' // ç¦æ­¢è¢«åµŒå…¥iframe
}));

// æˆ–è€…åªå…è®¸åŒæºåµŒå…¥
app.use(helmet.frameguard({ 
  action: 'sameorigin' 
}));
```

**ğŸ”¸ é˜²æ­¢MIMEç±»å‹å—…æ¢**
```javascript
// X-Content-Type-Optionså¤´éƒ¨
app.use(helmet.noSniff());
// æµè§ˆå™¨å°†ä¸¥æ ¼æŒ‰ç…§Content-Typeæ‰§è¡Œ
```

**ğŸ”¸ XSSä¿æŠ¤**
```javascript
// X-XSS-Protectionå¤´éƒ¨
app.use(helmet.xssFilter());
// å¯ç”¨æµè§ˆå™¨å†…ç½®XSSè¿‡æ»¤å™¨
```

**ğŸ”¸ å†…å®¹å®‰å…¨ç­–ç•¥**
```javascript
app.use(helmet.contentSecurityPolicy({
  directives: {
    defaultSrc: ["'self'"],                    // é»˜è®¤åªå…è®¸åŒæº
    styleSrc: ["'self'", "'unsafe-inline'"],  // æ ·å¼æ¥æº
    scriptSrc: ["'self'"],                    // è„šæœ¬æ¥æº
    imgSrc: ["'self'", "data:", "https:"]     // å›¾ç‰‡æ¥æº
  }
}));
```

### 5.4 Helmetè‡ªå®šä¹‰é…ç½®


```javascript
app.use(helmet({
  // å¯ç”¨æ‰€æœ‰é»˜è®¤ä¿æŠ¤
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      styleSrc: ["'self'", "https://fonts.googleapis.com"],
      fontSrc: ["'self'", "https://fonts.gstatic.com"],
      scriptSrc: ["'self'"],
      imgSrc: ["'self'", "data:", "https:"]
    }
  },
  
  // éšè—X-Powered-Byå¤´éƒ¨
  hidePoweredBy: true,
  
  // å¼ºåˆ¶HTTPS
  hsts: {
    maxAge: 31536000,      // 1å¹´
    includeSubDomains: true
  }
}));
```

---

## 6. ğŸ” HTTPSä¸å®‰å…¨ä¼ è¾“


### 6.1 ä¸ºä»€ä¹ˆéœ€è¦HTTPS


> ğŸ’¡ **é€šä¿—è§£é‡Š**ï¼šHTTPå°±åƒæ˜ä¿¡ç‰‡ï¼Œå†…å®¹è°éƒ½èƒ½çœ‹åˆ°
> 
> HTTPSå°±åƒå¯†å°çš„ä¿¡å°ï¼Œåªæœ‰æ”¶ä»¶äººèƒ½çœ‹åˆ°å†…å®¹

**HTTP vs HTTPSå¯¹æ¯”**ï¼š

| ç‰¹æ€§ | HTTP | HTTPS |
|------|------|-------|
| **ä¼ è¾“æ–¹å¼** | æ˜æ–‡ä¼ è¾“ | åŠ å¯†ä¼ è¾“ |
| **å®‰å…¨æ€§** | âŒ å®¹æ˜“è¢«çªƒå¬ | âœ… æ•°æ®åŠ å¯†ä¿æŠ¤ |
| **ç«¯å£** | 80 | 443 |
| **è¯ä¹¦** | ä¸éœ€è¦ | éœ€è¦SSLè¯ä¹¦ |
| **æµè§ˆå™¨æ˜¾ç¤º** | ğŸ”“ ä¸å®‰å…¨è­¦å‘Š | ğŸ”’ å®‰å…¨é”å›¾æ ‡ |

### 6.2 å¼ºåˆ¶HTTPSè·³è½¬


```javascript
// ä¸­é—´ä»¶ï¼šå¼ºåˆ¶è·³è½¬åˆ°HTTPS
function forceHTTPS(req, res, next) {
  if (!req.secure && process.env.NODE_ENV === 'production') {
    return res.redirect(301, `https://${req.headers.host}${req.url}`);
  }
  next();
}

app.use(forceHTTPS);
```

### 6.3 å®‰å…¨Cookieè®¾ç½®


```javascript
// è®¾ç½®å®‰å…¨çš„Sessioné…ç½®
app.use(session({
  secret: process.env.SESSION_SECRET,
  resave: false,
  saveUninitialized: false,
  cookie: {
    secure: true,      // åªåœ¨HTTPSä¸‹ä¼ è¾“
    httpOnly: true,    // ç¦æ­¢JavaScriptè®¿é—®
    maxAge: 1800000,   // 30åˆ†é’Ÿè¿‡æœŸ
    sameSite: 'strict' // é˜²CSRFæ”»å‡»
  }
}));

// è®¾ç½®å®‰å…¨çš„æ™®é€šCookie
res.cookie('userToken', token, {
  secure: true,      // HTTPS only
  httpOnly: true,    // é˜²XSS
  sameSite: 'strict' // é˜²CSRF
});
```

---

## 7. ğŸ” è¾“å…¥éªŒè¯ä¸æ•°æ®æ¸…æ´—


### 7.1 ä¸ºä»€ä¹ˆéœ€è¦è¾“å…¥éªŒè¯


> ğŸ’¡ **é€šä¿—è§£é‡Š**ï¼šè¾“å…¥éªŒè¯å°±åƒé—¨å«æ£€æŸ¥èº«ä»½è¯
> 
> ç¡®ä¿è¿›å…¥ç³»ç»Ÿçš„æ•°æ®éƒ½æ˜¯"åˆæ³•"çš„ï¼Œè¿‡æ»¤æ‰æœ‰å®³å†…å®¹

### 7.2 åŸºæœ¬è¾“å…¥éªŒè¯


```javascript
const { body, validationResult } = require('express-validator');

// ç”¨æˆ·æ³¨å†ŒéªŒè¯è§„åˆ™
const validateRegister = [
  body('username')
    .isLength({ min: 3, max: 20 })
    .withMessage('ç”¨æˆ·åé•¿åº¦3-20å­—ç¬¦')
    .matches(/^[a-zA-Z0-9_]+$/)
    .withMessage('ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿'),
    
  body('email')
    .isEmail()
    .withMessage('è¯·è¾“å…¥æœ‰æ•ˆé‚®ç®±åœ°å€')
    .normalizeEmail(), // è‡ªåŠ¨æ ‡å‡†åŒ–é‚®ç®±æ ¼å¼
    
  body('password')
    .isLength({ min: 6 })
    .withMessage('å¯†ç è‡³å°‘6ä½')
    .matches(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/)
    .withMessage('å¯†ç å¿…é¡»åŒ…å«å¤§å°å†™å­—æ¯å’Œæ•°å­—')
];

// ä½¿ç”¨éªŒè¯ä¸­é—´ä»¶
app.post('/register', validateRegister, (req, res) => {
  const errors = validationResult(req);
  
  if (!errors.isEmpty()) {
    return res.status(400).json({
      success: false,
      message: 'è¾“å…¥æ•°æ®æœ‰è¯¯',
      errors: errors.array()
    });
  }
  
  // æ•°æ®éªŒè¯é€šè¿‡ï¼Œç»§ç»­å¤„ç†
});
```

### 7.3 æ•°æ®æ¸…æ´—å’Œè¿‡æ»¤


```javascript
const DOMPurify = require('isomorphic-dompurify');

// HTMLå†…å®¹æ¸…æ´—
function sanitizeHTML(html) {
  return DOMPurify.sanitize(html, {
    ALLOWED_TAGS: ['p', 'b', 'i', 'strong', 'em'],
    ALLOWED_ATTR: []
  });
}

// é€šç”¨æ•°æ®æ¸…æ´—
function sanitizeInput(input) {
  if (typeof input !== 'string') return input;
  
  return input
    .trim()                           // å»é™¤é¦–å°¾ç©ºæ ¼
    .replace(/\s+/g, ' ')            // åˆå¹¶å¤šä¸ªç©ºæ ¼
    .replace(/[<>'"&]/g, '');        // ç§»é™¤å±é™©å­—ç¬¦
}

// ä¸­é—´ä»¶ï¼šè‡ªåŠ¨æ¸…æ´—è¯·æ±‚æ•°æ®
app.use((req, res, next) => {
  if (req.body) {
    for (let key in req.body) {
      if (typeof req.body[key] === 'string') {
        req.body[key] = sanitizeInput(req.body[key]);
      }
    }
  }
  next();
});
```

### 7.4 æ–‡ä»¶ä¸Šä¼ å®‰å…¨


```javascript
const multer = require('multer');
const path = require('path');

// å®‰å…¨çš„æ–‡ä»¶ä¸Šä¼ é…ç½®
const upload = multer({
  dest: 'uploads/',
  limits: {
    fileSize: 5 * 1024 * 1024, // é™åˆ¶5MB
    files: 1                    // ä¸€æ¬¡åªèƒ½ä¸Šä¼ 1ä¸ªæ–‡ä»¶
  },
  fileFilter: (req, file, cb) => {
    // åªå…è®¸å›¾ç‰‡æ–‡ä»¶
    const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];
    
    if (allowedTypes.includes(file.mimetype)) {
      cb(null, true);
    } else {
      cb(new Error('åªå…è®¸ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶'), false);
    }
  }
});

// æ–‡ä»¶åå®‰å…¨å¤„ç†
function generateSafeFilename(originalname) {
  const ext = path.extname(originalname);
  const name = Date.now() + '-' + Math.round(Math.random() * 1E9);
  return name + ext;
}
```

---

## 8. ğŸ‘¤ æƒé™æ§åˆ¶ä¸è®¿é—®ç®¡ç†


### 8.1 èº«ä»½è®¤è¯(Authentication)


> ğŸ’¡ **é€šä¿—è§£é‡Š**ï¼šèº«ä»½è®¤è¯å°±æ˜¯ç¡®è®¤"ä½ æ˜¯è°"
> 
> å°±åƒè¿›å…¥å…¬å¸éœ€è¦åˆ·å·¥ç‰Œï¼Œè¯æ˜ä½ çš„èº«ä»½

```javascript
const jwt = require('jsonwebtoken');
const bcrypt = require('bcrypt');

// ç”¨æˆ·ç™»å½•
app.post('/login', async (req, res) => {
  const { username, password } = req.body;
  
  // æŸ¥æ‰¾ç”¨æˆ·
  const user = await User.findOne({ username });
  if (!user) {
    return res.status(401).json({ message: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯' });
  }
  
  // éªŒè¯å¯†ç 
  const isValidPassword = await bcrypt.compare(password, user.password);
  if (!isValidPassword) {
    return res.status(401).json({ message: 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯' });
  }
  
  // ç”ŸæˆJWTä»¤ç‰Œ
  const token = jwt.sign(
    { userId: user.id, username: user.username },
    process.env.JWT_SECRET,
    { expiresIn: '24h' }
  );
  
  res.json({ token, user: { id: user.id, username: user.username } });
});
```

### 8.2 æƒé™éªŒè¯(Authorization)


> ğŸ’¡ **é€šä¿—è§£é‡Š**ï¼šæƒé™éªŒè¯å°±æ˜¯ç¡®è®¤"ä½ èƒ½åšä»€ä¹ˆ"
> 
> å°±åƒä¸åŒçº§åˆ«çš„å‘˜å·¥èƒ½è®¿é—®ä¸åŒçš„åŠå…¬åŒºåŸŸ

```javascript
// JWTéªŒè¯ä¸­é—´ä»¶
function authenticateToken(req, res, next) {
  const authHeader = req.headers['authorization'];
  const token = authHeader && authHeader.split(' ')[1]; // Bearer TOKEN
  
  if (!token) {
    return res.status(401).json({ message: 'éœ€è¦è®¿é—®ä»¤ç‰Œ' });
  }
  
  jwt.verify(token, process.env.JWT_SECRET, (err, user) => {
    if (err) {
      return res.status(403).json({ message: 'ä»¤ç‰Œæ— æ•ˆ' });
    }
    
    req.user = user;
    next();
  });
}

// è§’è‰²æƒé™ä¸­é—´ä»¶
function requireRole(role) {
  return (req, res, next) => {
    if (req.user.role !== role) {
      return res.status(403).json({ message: 'æƒé™ä¸è¶³' });
    }
    next();
  };
}

// ä½¿ç”¨ç¤ºä¾‹
app.get('/admin/users', 
  authenticateToken,           // å…ˆéªŒè¯èº«ä»½
  requireRole('admin'),        // å†éªŒè¯æƒé™
  (req, res) => {
    // åªæœ‰ç®¡ç†å‘˜èƒ½è®¿é—®
  }
);
```

### 8.3 è®¿é—®é¢‘ç‡é™åˆ¶


```javascript
const rateLimit = require('express-rate-limit');

// åŸºæœ¬é™æµé…ç½®
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15åˆ†é’Ÿ
  max: 100,                 // æœ€å¤š100æ¬¡è¯·æ±‚
  message: 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•',
  standardHeaders: true,    // è¿”å›é™æµä¿¡æ¯
  legacyHeaders: false
});

app.use('/api/', limiter);

// ç™»å½•æ¥å£ç‰¹æ®Šé™æµ
const loginLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: 5,                   // 15åˆ†é’Ÿå†…æœ€å¤šå°è¯•5æ¬¡
  skipSuccessfulRequests: true
});

app.post('/login', loginLimiter, (req, res) => {
  // ç™»å½•é€»è¾‘
});
```

---

## 9. âš™ï¸ å®‰å…¨é…ç½®æœ€ä½³å®è·µ


### 9.1 ç¯å¢ƒå˜é‡ç®¡ç†


```javascript
// .envæ–‡ä»¶ï¼ˆä¸è¦æäº¤åˆ°ä»£ç ä»“åº“ï¼‰
NODE_ENV=production
JWT_SECRET=your-super-secret-key-here
DB_PASSWORD=your-database-password
API_KEY=your-api-key

// åœ¨ä»£ç ä¸­ä½¿ç”¨
require('dotenv').config();

const config = {
  jwtSecret: process.env.JWT_SECRET || 'fallback-secret',
  dbPassword: process.env.DB_PASSWORD,
  port: process.env.PORT || 3000
};

// å¯åŠ¨æ—¶æ£€æŸ¥å¿…éœ€çš„ç¯å¢ƒå˜é‡
function checkRequiredEnvVars() {
  const required = ['JWT_SECRET', 'DB_PASSWORD'];
  
  for (const envVar of required) {
    if (!process.env[envVar]) {
      console.error(`ç¼ºå°‘å¿…éœ€çš„ç¯å¢ƒå˜é‡: ${envVar}`);
      process.exit(1);
    }
  }
}

checkRequiredEnvVars();
```

### 9.2 é”™è¯¯å¤„ç†å®‰å…¨


```javascript
// å®‰å…¨çš„é”™è¯¯å¤„ç†
app.use((err, req, res, next) => {
  // è®°å½•è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼ˆä»…åœ¨æœåŠ¡å™¨ç«¯ï¼‰
  console.error('æœåŠ¡å™¨é”™è¯¯:', err);
  
  // æ ¹æ®ç¯å¢ƒè¿”å›ä¸åŒçš„é”™è¯¯ä¿¡æ¯
  if (process.env.NODE_ENV === 'production') {
    // ç”Ÿäº§ç¯å¢ƒï¼šè¿”å›é€šç”¨é”™è¯¯ä¿¡æ¯
    res.status(500).json({
      success: false,
      message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯'
    });
  } else {
    // å¼€å‘ç¯å¢ƒï¼šè¿”å›è¯¦ç»†é”™è¯¯ä¿¡æ¯
    res.status(500).json({
      success: false,
      message: err.message,
      stack: err.stack
    });
  }
});
```

### 9.3 æ—¥å¿—è®°å½•


```javascript
const winston = require('winston');

// åˆ›å»ºæ—¥å¿—è®°å½•å™¨
const logger = winston.createLogger({
  level: 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.json()
  ),
  transports: [
    new winston.transports.File({ filename: 'logs/error.log', level: 'error' }),
    new winston.transports.File({ filename: 'logs/combined.log' })
  ]
});

// å®‰å…¨äº‹ä»¶è®°å½•ä¸­é—´ä»¶
function securityLogger(req, res, next) {
  // è®°å½•æ•æ„Ÿæ“ä½œ
  if (req.method !== 'GET') {
    logger.info('å®‰å…¨æ“ä½œ', {
      ip: req.ip,
      method: req.method,
      url: req.url,
      userAgent: req.headers['user-agent'],
      user: req.user ? req.user.username : 'anonymous'
    });
  }
  
  next();
}

app.use(securityLogger);
```

### 9.4 å®šæœŸå®‰å…¨æ£€æŸ¥


```bash
# æ£€æŸ¥ä¾èµ–åŒ…æ¼æ´
npm audit

# ä¿®å¤å¯ä¿®å¤çš„æ¼æ´
npm audit fix

# æ›´æ–°è¿‡æ—¶çš„åŒ…
npm outdated
npm update
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„å®‰å…¨æ¦‚å¿µ


```
ğŸ”¸ XSSé˜²æŠ¤ï¼šè¾“å‡ºç¼–ç ï¼Œé˜²æ­¢æ¶æ„è„šæœ¬æ‰§è¡Œ
ğŸ”¸ CSRFé˜²æŠ¤ï¼šTokenéªŒè¯ï¼Œé˜²æ­¢è·¨ç«™è¯·æ±‚ä¼ªé€ 
ğŸ”¸ SQLæ³¨å…¥é˜²æŠ¤ï¼šå‚æ•°åŒ–æŸ¥è¯¢ï¼ŒéªŒè¯è¾“å…¥æ•°æ®
ğŸ”¸ HTTPSä¼ è¾“ï¼šåŠ å¯†é€šä¿¡ï¼Œä¿æŠ¤æ•°æ®ä¼ è¾“å®‰å…¨
ğŸ”¸ è¾“å…¥éªŒè¯ï¼šè¿‡æ»¤æ¸…æ´—ï¼Œç¡®ä¿æ•°æ®åˆæ³•æ€§
ğŸ”¸ æƒé™æ§åˆ¶ï¼šèº«ä»½è®¤è¯å’Œæˆæƒç®¡ç†
```

### 10.2 å®‰å…¨é˜²æŠ¤æ£€æŸ¥æ¸…å•


**âœ… åŸºç¡€å®‰å…¨æªæ–½**
- [ ] ä½¿ç”¨Helmetè®¾ç½®å®‰å…¨å¤´éƒ¨
- [ ] å¯ç”¨HTTPSå’Œå®‰å…¨Cookie
- [ ] å®ç°è¾“å…¥éªŒè¯å’Œæ•°æ®æ¸…æ´—
- [ ] è®¾ç½®è®¿é—®é¢‘ç‡é™åˆ¶
- [ ] éšè—æ•æ„ŸæŠ€æœ¯ä¿¡æ¯

**âœ… é«˜çº§å®‰å…¨æªæ–½**
- [ ] å®ç°JWTèº«ä»½è®¤è¯
- [ ] è®¾ç½®CSRFä¿æŠ¤
- [ ] é…ç½®å†…å®¹å®‰å…¨ç­–ç•¥
- [ ] å»ºç«‹å®‰å…¨æ—¥å¿—è®°å½•
- [ ] å®šæœŸå®‰å…¨å®¡è®¡

### 10.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¸ºä»€ä¹ˆé‡è¦**ï¼š
- **ä¿æŠ¤ç”¨æˆ·**ï¼šé˜²æ­¢ä¸ªäººä¿¡æ¯æ³„éœ²å’Œè´¢äº§æŸå¤±
- **ä¿æŠ¤ä¸šåŠ¡**ï¼šé¿å…æ•°æ®è¢«æ¶æ„ç¯¡æ”¹æˆ–åˆ é™¤
- **æ³•å¾‹åˆè§„**ï¼šæ»¡è¶³æ•°æ®ä¿æŠ¤æ³•è§„è¦æ±‚
- **ç”¨æˆ·ä¿¡ä»»**ï¼šæå‡ç”¨æˆ·å¯¹ç½‘ç«™çš„ä¿¡ä»»åº¦

**ğŸ”§ å®æ–½å»ºè®®**ï¼š
1. **åˆ†å±‚é˜²æŠ¤**ï¼šä¸è¦ä¾èµ–å•ä¸€å®‰å…¨æªæ–½
2. **æŒç»­æ›´æ–°**ï¼šå®šæœŸæ›´æ–°ä¾èµ–åŒ…å’Œå®‰å…¨é…ç½®
3. **ç›‘æ§å‘Šè­¦**ï¼šå»ºç«‹å®‰å…¨äº‹ä»¶ç›‘æ§æœºåˆ¶
4. **å›¢é˜ŸåŸ¹è®­**ï¼šæå‡å›¢é˜Ÿå®‰å…¨æ„è¯†

**æ ¸å¿ƒè®°å¿†**ï¼š
- å®‰å…¨é˜²æŠ¤è¦ä»è®¾è®¡é˜¶æ®µå¼€å§‹è€ƒè™‘
- è¾“å…¥éªŒè¯å’Œè¾“å‡ºç¼–ç æ˜¯åŸºç¡€é˜²æŠ¤
- ä½¿ç”¨æˆç†Ÿçš„å®‰å…¨ä¸­é—´ä»¶å’Œæœ€ä½³å®è·µ
- å®šæœŸå®¡è®¡å’Œæ›´æ–°æ˜¯å®‰å…¨ç»´æŠ¤çš„å…³é”®