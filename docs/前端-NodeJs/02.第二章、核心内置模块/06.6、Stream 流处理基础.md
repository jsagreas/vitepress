---
title: 6ã€Stream æµå¤„ç†åŸºç¡€
---
## ğŸ“š ç›®å½•

1. [ä»€ä¹ˆæ˜¯ Stream æµ](#1-ä»€ä¹ˆæ˜¯-stream-æµ)
2. [å››ç§æµç±»å‹è¯¦è§£](#2-å››ç§æµç±»å‹è¯¦è§£)
3. [å¯è¯»æµ Readable](#3-å¯è¯»æµ-readable)
4. [å¯å†™æµ Writable](#4-å¯å†™æµ-writable)
5. [ç®¡é“æ“ä½œ pipe()](#5-ç®¡é“æ“ä½œ-pipe)
6. [æµäº‹ä»¶å¤„ç†](#6-æµäº‹ä»¶å¤„ç†)
7. [æ–‡ä»¶æµå®é™…åº”ç”¨](#7-æ–‡ä»¶æµå®é™…åº”ç”¨)
8. [Transform è½¬æ¢æµ](#8-transform-è½¬æ¢æµ)
9. [èƒŒå‹å¤„ç†åŸºç¡€](#9-èƒŒå‹å¤„ç†åŸºç¡€)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒŠ ä»€ä¹ˆæ˜¯ Stream æµ


### 1.1 é€šä¿—ç†è§£ Stream

**ğŸ’¡ ç”Ÿæ´»ä¸­çš„æµ**ï¼š
- ğŸš° **æ°´ç®¡æµæ°´**ï¼šæ°´é¾™å¤´â†’æ°´ç®¡â†’æ°´æ§½ï¼Œæ°´æ˜¯ä¸€æ®µä¸€æ®µæµè¿‡å»çš„
- ğŸ“º **è§†é¢‘æ’­æ”¾**ï¼šä¸ç”¨ä¸‹è½½å®Œæ•´è§†é¢‘ï¼Œè¾¹ä¸‹è½½è¾¹æ’­æ”¾
- ğŸµ **éŸ³ä¹æµåª’ä½“**ï¼šä¸ç”¨ç­‰æ•´é¦–æ­Œä¸‹è½½å®Œï¼Œå¯ä»¥è¾¹ä¸‹è¾¹å¬

**ğŸ’» Node.js ä¸­çš„ Stream**ï¼š
```
ä¼ ç»Ÿæ–¹å¼å¤„ç†æ–‡ä»¶ï¼š
è¯»å–æ•´ä¸ªæ–‡ä»¶ â†’ æ”¾å…¥å†…å­˜ â†’ å¤„ç† â†’ è¾“å‡º
é—®é¢˜ï¼šå¤§æ–‡ä»¶ä¼šå æ»¡å†…å­˜ï¼

Stream æµå¼å¤„ç†ï¼š
è¯»ä¸€å°å— â†’ å¤„ç†ä¸€å°å— â†’ è¾“å‡ºä¸€å°å— â†’ ç»§ç»­...
ä¼˜åŠ¿ï¼šå†…å­˜å ç”¨å°ï¼Œå¤„ç†é€Ÿåº¦å¿«ï¼
```

### 1.2 Stream çš„æ ¸å¿ƒä¼˜åŠ¿


| ä¼˜åŠ¿ | ä¼ ç»Ÿæ–¹å¼ | Stream æ–¹å¼ | å®é™…æ•ˆæœ |
|------|----------|-------------|----------|
| **ğŸ§  å†…å­˜ä½¿ç”¨** | å…¨éƒ¨åŠ è½½åˆ°å†…å­˜ | åˆ†å—å¤„ç† | èŠ‚çœ90%+å†…å­˜ |
| **âš¡ å¤„ç†é€Ÿåº¦** | ç­‰å¾…å…¨éƒ¨è¯»å–å®Œ | è¾¹è¯»è¾¹å¤„ç† | æå‡80%+é€Ÿåº¦ |
| **ğŸ“ æ–‡ä»¶å¤§å°** | å—å†…å­˜é™åˆ¶ | æ— å¤§å°é™åˆ¶ | å¯å¤„ç†GBçº§æ–‡ä»¶ |
| **ğŸ‘¥ ç”¨æˆ·ä½“éªŒ** | ç­‰å¾…å®Œæˆ | å®æ—¶å“åº” | æ›´å¥½çš„ä½“éªŒ |

### 1.3 Stream çš„å·¥ä½œåŸç†


```
æ•°æ®æµè½¬è¿‡ç¨‹ï¼š

æ•°æ®æº âœ [chunk1] âœ [chunk2] âœ [chunk3] âœ ç›®æ ‡
       â†“         â†“         â†“
     å¤„ç†1     å¤„ç†2     å¤„ç†3

æ¯ä¸ª chunkï¼ˆæ•°æ®å—ï¼‰ç‹¬ç«‹å¤„ç†ï¼Œä¸éœ€è¦ç­‰å¾…å…¨éƒ¨æ•°æ®
```

---

## 2. ğŸ”„ å››ç§æµç±»å‹è¯¦è§£


### 2.1 å››ç§æµç±»å‹æ¦‚è§ˆ


```
ğŸ“– Readableï¼ˆå¯è¯»æµï¼‰     ğŸ“ Writableï¼ˆå¯å†™æµï¼‰
   â¬‡ï¸ åªèƒ½è¯»å–æ•°æ®           â¬†ï¸ åªèƒ½å†™å…¥æ•°æ®
   ä¾‹ï¼šæ–‡ä»¶è¯»å–             ä¾‹ï¼šæ–‡ä»¶å†™å…¥

ğŸ”„ Duplexï¼ˆåŒå·¥æµï¼‰       ğŸ”§ Transformï¼ˆè½¬æ¢æµï¼‰
   â¬‡ï¸â¬†ï¸ æ—¢èƒ½è¯»åˆèƒ½å†™         â¬‡ï¸ğŸ”§â¬†ï¸ è¯»å–â†’è½¬æ¢â†’å†™å…¥
   ä¾‹ï¼šTCPè¿æ¥              ä¾‹ï¼šæ•°æ®å‹ç¼©
```

### 2.2 æµç±»å‹è¯¦ç»†è¯´æ˜


**ğŸ“– Readable å¯è¯»æµ**ï¼š
- **ä½œç”¨**ï¼šä»æ•°æ®æºè¯»å–æ•°æ®
- **ç‰¹ç‚¹**ï¼šåªèƒ½è¯»ï¼Œä¸èƒ½å†™
- **ä¾‹å­**ï¼šè¯»å–æ–‡ä»¶ã€HTTPè¯·æ±‚å“åº”

**ğŸ“ Writable å¯å†™æµ**ï¼š
- **ä½œç”¨**ï¼šå‘ç›®æ ‡å†™å…¥æ•°æ®
- **ç‰¹ç‚¹**ï¼šåªèƒ½å†™ï¼Œä¸èƒ½è¯»
- **ä¾‹å­**ï¼šå†™å…¥æ–‡ä»¶ã€HTTPè¯·æ±‚

**ğŸ”„ Duplex åŒå·¥æµ**ï¼š
- **ä½œç”¨**ï¼šæ—¢å¯ä»¥è¯»ä¹Ÿå¯ä»¥å†™
- **ç‰¹ç‚¹**ï¼šè¯»å†™ç›¸äº’ç‹¬ç«‹
- **ä¾‹å­**ï¼šTCPè¿æ¥ã€WebSocket

**ğŸ”§ Transform è½¬æ¢æµ**ï¼š
- **ä½œç”¨**ï¼šè¯»å–æ•°æ®â†’å¤„ç†â†’è¾“å‡º
- **ç‰¹ç‚¹**ï¼šDuplexçš„ç‰¹æ®Šå½¢å¼
- **ä¾‹å­**ï¼šæ•°æ®å‹ç¼©ã€JSONè§£æ

---

## 3. ğŸ“– å¯è¯»æµ Readable


### 3.1 åˆ›å»ºå¯è¯»æµ


```javascript
const fs = require('fs');

// åˆ›å»ºæ–‡ä»¶å¯è¯»æµ
const readStream = fs.createReadStream('input.txt');

// è®¾ç½®ç¼–ç ï¼ˆå¯é€‰ï¼‰
readStream.setEncoding('utf8');
```

### 3.2 å¯è¯»æµçš„åŸºæœ¬ä½¿ç”¨


```javascript
const fs = require('fs');

// åˆ›å»ºå¯è¯»æµ
const readStream = fs.createReadStream('example.txt');

// ç›‘å¬æ•°æ®äº‹ä»¶
readStream.on('data', (chunk) => {
  console.log('æ”¶åˆ°æ•°æ®å—:', chunk);
});

// ç›‘å¬ç»“æŸäº‹ä»¶
readStream.on('end', () => {
  console.log('æ–‡ä»¶è¯»å–å®Œæˆ');
});

// ç›‘å¬é”™è¯¯äº‹ä»¶
readStream.on('error', (err) => {
  console.log('è¯»å–é”™è¯¯:', err);
});
```

### 3.3 å¯è¯»æµçš„é‡è¦é€‰é¡¹


```javascript
// åˆ›å»ºå¯è¯»æµæ—¶çš„å¸¸ç”¨é€‰é¡¹
const readStream = fs.createReadStream('file.txt', {
  encoding: 'utf8',     // ğŸ“„ è®¾ç½®ç¼–ç 
  start: 100,           // ğŸ¯ ä»ç¬¬100å­—èŠ‚å¼€å§‹
  end: 500,             // ğŸ åˆ°ç¬¬500å­—èŠ‚ç»“æŸ
  highWaterMark: 1024   // ğŸ§  ç¼“å†²åŒºå¤§å°(å­—èŠ‚)
});
```

---

## 4. ğŸ“ å¯å†™æµ Writable


### 4.1 åˆ›å»ºå¯å†™æµ


```javascript
const fs = require('fs');

// åˆ›å»ºæ–‡ä»¶å¯å†™æµ
const writeStream = fs.createWriteStream('output.txt');
```

### 4.2 å¯å†™æµçš„åŸºæœ¬ä½¿ç”¨


```javascript
const fs = require('fs');

// åˆ›å»ºå¯å†™æµ
const writeStream = fs.createWriteStream('output.txt');

// å†™å…¥æ•°æ®
writeStream.write('ç¬¬ä¸€è¡Œæ•°æ®\n');
writeStream.write('ç¬¬äºŒè¡Œæ•°æ®\n');

// ç»“æŸå†™å…¥
writeStream.end('æœ€åä¸€è¡Œæ•°æ®\n');

// ç›‘å¬å®Œæˆäº‹ä»¶
writeStream.on('finish', () => {
  console.log('æ–‡ä»¶å†™å…¥å®Œæˆ');
});

// ç›‘å¬é”™è¯¯äº‹ä»¶
writeStream.on('error', (err) => {
  console.log('å†™å…¥é”™è¯¯:', err);
});
```

### 4.3 å®ç”¨çš„å†™å…¥ç¤ºä¾‹


```javascript
// ğŸ’¡ å®é™…åº”ç”¨ï¼šç”Ÿæˆæ—¥å¿—æ–‡ä»¶
const fs = require('fs');

const logStream = fs.createWriteStream('app.log', { flags: 'a' }); // è¿½åŠ æ¨¡å¼

function writeLog(message) {
  const timestamp = new Date().toISOString();
  logStream.write(`[${timestamp}] ${message}\n`);
}

writeLog('åº”ç”¨å¯åŠ¨');
writeLog('ç”¨æˆ·ç™»å½•');
writeLog('å¤„ç†è¯·æ±‚');
```

---

## 5. ğŸ”— ç®¡é“æ“ä½œ pipe()


### 5.1 ä»€ä¹ˆæ˜¯ç®¡é“ pipe()


**ğŸ’¡ ç®¡é“çš„æ¦‚å¿µ**ï¼š
```
å°±åƒç°å®ä¸­çš„æ°´ç®¡ï¼š

æ°´æº âœ ç®¡é“1 âœ ç®¡é“2 âœ ç®¡é“3 âœ æ°´æ§½

Node.js ä¸­ï¼š
å¯è¯»æµ âœ pipe() âœ å¯å†™æµ
```

**ğŸ¯ pipe() çš„ä½œç”¨**ï¼š
- **è‡ªåŠ¨è¿æ¥**ï¼šå°†å¯è¯»æµè¿æ¥åˆ°å¯å†™æµ
- **è‡ªåŠ¨æ§åˆ¶**ï¼šè‡ªåŠ¨å¤„ç†æ•°æ®æµé€Ÿ
- **é”™è¯¯å¤„ç†**ï¼šè‡ªåŠ¨å¤„ç†èƒŒå‹é—®é¢˜

### 5.2 åŸºç¡€ pipe() ä½¿ç”¨


```javascript
const fs = require('fs');

// åˆ›å»ºè¯»å†™æµ
const readStream = fs.createReadStream('input.txt');
const writeStream = fs.createWriteStream('output.txt');

// ä½¿ç”¨ç®¡é“è¿æ¥
readStream.pipe(writeStream);

console.log('å¼€å§‹å¤åˆ¶æ–‡ä»¶...');

// ç›‘å¬å®Œæˆ
writeStream.on('finish', () => {
  console.log('æ–‡ä»¶å¤åˆ¶å®Œæˆï¼');
});
```

### 5.3 é“¾å¼ç®¡é“æ“ä½œ


```javascript
const fs = require('fs');
const zlib = require('zlib');

// ğŸ’ª å¼ºå¤§çš„é“¾å¼æ“ä½œï¼šè¯»å– â†’ å‹ç¼© â†’ å†™å…¥
fs.createReadStream('input.txt')
  .pipe(zlib.createGzip())           // å‹ç¼©
  .pipe(fs.createWriteStream('output.txt.gz')); // å†™å…¥å‹ç¼©æ–‡ä»¶

console.log('æ–‡ä»¶å‹ç¼©ä¸­...');
```

### 5.4 pipe() vs æ‰‹åŠ¨å¤„ç†


```javascript
// âŒ æ‰‹åŠ¨å¤„ç†ï¼ˆå¤æ‚ï¼‰
const readStream = fs.createReadStream('input.txt');
const writeStream = fs.createWriteStream('output.txt');

readStream.on('data', (chunk) => {
  writeStream.write(chunk);
});

readStream.on('end', () => {
  writeStream.end();
});

// âœ… ä½¿ç”¨ pipe()ï¼ˆç®€å•ï¼‰
readStream.pipe(writeStream);
```

---

## 6. ğŸ­ æµäº‹ä»¶å¤„ç†


### 6.1 å¯è¯»æµçš„é‡è¦äº‹ä»¶


```javascript
const readStream = fs.createReadStream('file.txt');

// ğŸ“Š data - æ¥æ”¶åˆ°æ•°æ®å—
readStream.on('data', (chunk) => {
  console.log(`æ¥æ”¶æ•°æ®: ${chunk.length} å­—èŠ‚`);
});

// ğŸ end - æ•°æ®è¯»å–å®Œæˆ
readStream.on('end', () => {
  console.log('âœ… è¯»å–å®Œæˆ');
});

// âš ï¸ error - å‘ç”Ÿé”™è¯¯
readStream.on('error', (err) => {
  console.log('âŒ è¯»å–é”™è¯¯:', err.message);
});

// ğŸ”“ open - æ–‡ä»¶æ‰“å¼€
readStream.on('open', () => {
  console.log('ğŸ“‚ æ–‡ä»¶å·²æ‰“å¼€');
});

// ğŸ”’ close - æ–‡ä»¶å…³é—­
readStream.on('close', () => {
  console.log('ğŸ“ æ–‡ä»¶å·²å…³é—­');
});
```

### 6.2 å¯å†™æµçš„é‡è¦äº‹ä»¶


```javascript
const writeStream = fs.createWriteStream('output.txt');

// ğŸ finish - å†™å…¥å®Œæˆ
writeStream.on('finish', () => {
  console.log('âœ… å†™å…¥å®Œæˆ');
});

// ğŸ’§ drain - ç¼“å†²åŒºå¯ä»¥ç»§ç»­å†™å…¥
writeStream.on('drain', () => {
  console.log('ğŸ”„ å¯ä»¥ç»§ç»­å†™å…¥');
});

// âš ï¸ error - å†™å…¥é”™è¯¯
writeStream.on('error', (err) => {
  console.log('âŒ å†™å…¥é”™è¯¯:', err.message);
});
```

### 6.3 å®é™…åº”ç”¨ç¤ºä¾‹


```javascript
// ğŸ’¡ å®ç”¨ç¤ºä¾‹ï¼šå®‰å…¨çš„æ–‡ä»¶å¤åˆ¶
function copyFile(source, destination) {
  const readStream = fs.createReadStream(source);
  const writeStream = fs.createWriteStream(destination);
  
  let copiedBytes = 0;
  
  readStream.on('data', (chunk) => {
    copiedBytes += chunk.length;
    console.log(`å·²å¤åˆ¶: ${copiedBytes} å­—èŠ‚`);
  });
  
  readStream.on('error', (err) => {
    console.log('è¯»å–å¤±è´¥:', err.message);
    writeStream.destroy(); // æ¸…ç†å†™å…¥æµ
  });
  
  writeStream.on('error', (err) => {
    console.log('å†™å…¥å¤±è´¥:', err.message);
    readStream.destroy(); // æ¸…ç†è¯»å–æµ
  });
  
  writeStream.on('finish', () => {
    console.log(`âœ… å¤åˆ¶å®Œæˆï¼Œå…± ${copiedBytes} å­—èŠ‚`);
  });
  
  // å¼€å§‹å¤åˆ¶
  readStream.pipe(writeStream);
}

// ä½¿ç”¨
copyFile('large-file.txt', 'backup.txt');
```

---

## 7. ğŸ“ æ–‡ä»¶æµå®é™…åº”ç”¨


### 7.1 å¤§æ–‡ä»¶å¤„ç†ä¼˜åŠ¿å¯¹æ¯”


```javascript
// âŒ ä¼ ç»Ÿæ–¹å¼ - å¤„ç†å¤§æ–‡ä»¶ï¼ˆå±é™©ï¼‰
const fs = require('fs');

// è¿™æ ·å¤„ç†å¤§æ–‡ä»¶ä¼šå æ»¡å†…å­˜ï¼
fs.readFile('huge-file.txt', (err, data) => {
  if (err) throw err;
  // å¦‚æœæ–‡ä»¶æ˜¯ 2GBï¼Œå°±éœ€è¦ 2GB å†…å­˜ï¼
  console.log('æ–‡ä»¶å¤§å°:', data.length);
});

// âœ… Stream æ–¹å¼ - å¤„ç†å¤§æ–‡ä»¶ï¼ˆå®‰å…¨ï¼‰
const readStream = fs.createReadStream('huge-file.txt');

let totalSize = 0;
readStream.on('data', (chunk) => {
  totalSize += chunk.length;
  console.log(`å¤„ç†è¿›åº¦: ${totalSize} å­—èŠ‚`);
  // åªå ç”¨å¾ˆå°‘å†…å­˜ï¼Œå¯ä»¥å¤„ç†ä»»æ„å¤§å°çš„æ–‡ä»¶ï¼
});

readStream.on('end', () => {
  console.log(`âœ… å¤„ç†å®Œæˆï¼Œæ€»å¤§å°: ${totalSize} å­—èŠ‚`);
});
```

### 7.2 å®ç”¨çš„æ–‡ä»¶å¤„ç†ç¤ºä¾‹


```javascript
// ğŸ’¡ ç¤ºä¾‹1ï¼šç»Ÿè®¡æ–‡ä»¶è¡Œæ•°
function countLines(filename) {
  const readStream = fs.createReadStream(filename, { encoding: 'utf8' });
  let lineCount = 0;
  let remaining = '';
  
  readStream.on('data', (chunk) => {
    remaining += chunk;
    const lines = remaining.split('\n');
    remaining = lines.pop(); // ä¿ç•™æœ€åä¸å®Œæ•´çš„è¡Œ
    lineCount += lines.length;
  });
  
  readStream.on('end', () => {
    if (remaining.length > 0) lineCount++; // æœ€åä¸€è¡Œ
    console.log(`æ–‡ä»¶å…±æœ‰ ${lineCount} è¡Œ`);
  });
}

// ğŸ’¡ ç¤ºä¾‹2ï¼šæ–‡ä»¶åˆ†å‰²
function splitFile(inputFile, chunkSize) {
  const readStream = fs.createReadStream(inputFile);
  let fileIndex = 0;
  let currentSize = 0;
  let writeStream = fs.createWriteStream(`${inputFile}.part${fileIndex}`);
  
  readStream.on('data', (chunk) => {
    if (currentSize + chunk.length > chunkSize) {
      // å½“å‰æ–‡ä»¶å—å·²æ»¡ï¼Œåˆ›å»ºæ–°æ–‡ä»¶
      writeStream.end();
      fileIndex++;
      currentSize = 0;
      writeStream = fs.createWriteStream(`${inputFile}.part${fileIndex}`);
    }
    
    writeStream.write(chunk);
    currentSize += chunk.length;
  });
  
  readStream.on('end', () => {
    writeStream.end();
    console.log(`æ–‡ä»¶åˆ†å‰²å®Œæˆï¼Œå…± ${fileIndex + 1} ä¸ªæ–‡ä»¶`);
  });
}
```

### 7.3 æ€§èƒ½å¯¹æ¯”å®ä¾‹


```javascript
// ğŸ”¬ æ€§èƒ½æµ‹è¯•ï¼šStream vs ä¼ ç»Ÿæ–¹å¼
const fs = require('fs');

// åˆ›å»ºä¸€ä¸ªæµ‹è¯•æ–‡ä»¶ï¼ˆ50MBï¼‰
function createTestFile() {
  const writeStream = fs.createWriteStream('test-50mb.txt');
  const data = 'A'.repeat(1024); // 1KB æ•°æ®
  
  for (let i = 0; i < 50 * 1024; i++) { // 50MB
    writeStream.write(data);
  }
  writeStream.end();
}

// ğŸ“Š æ–¹å¼1ï¼šä¼ ç»Ÿæ–¹å¼æµ‹è¯•
function testTraditional() {
  console.time('ä¼ ç»Ÿæ–¹å¼');
  fs.readFile('test-50mb.txt', (err, data) => {
    console.timeEnd('ä¼ ç»Ÿæ–¹å¼');
    console.log('å†…å­˜ä½¿ç”¨:', process.memoryUsage().heapUsed / 1024 / 1024, 'MB');
  });
}

// ğŸ“Š æ–¹å¼2ï¼šStream æµ‹è¯•
function testStream() {
  console.time('Streamæ–¹å¼');
  const readStream = fs.createReadStream('test-50mb.txt');
  let totalSize = 0;
  
  readStream.on('data', (chunk) => {
    totalSize += chunk.length;
  });
  
  readStream.on('end', () => {
    console.timeEnd('Streamæ–¹å¼');
    console.log('å†…å­˜ä½¿ç”¨:', process.memoryUsage().heapUsed / 1024 / 1024, 'MB');
  });
}
```

---

## 8. ğŸ”§ Transform è½¬æ¢æµ


### 8.1 ä»€ä¹ˆæ˜¯ Transform æµ


**ğŸ’¡ Transform çš„æ¦‚å¿µ**ï¼š
```
è¾“å…¥æ•°æ® âœ [è½¬æ¢å¤„ç†] âœ è¾“å‡ºæ•°æ®

ä¾‹å¦‚ï¼š
è‹±æ–‡æ–‡æœ¬ âœ [è½¬å¤§å†™] âœ å¤§å†™æ–‡æœ¬
JSONå­—ç¬¦ä¸² âœ [è§£æ] âœ JavaScriptå¯¹è±¡
åŸå§‹æ•°æ® âœ [å‹ç¼©] âœ å‹ç¼©æ•°æ®
```

### 8.2 åˆ›å»ºè‡ªå®šä¹‰ Transform æµ


```javascript
const { Transform } = require('stream');

// åˆ›å»ºä¸€ä¸ªå°†æ–‡æœ¬è½¬æ¢ä¸ºå¤§å†™çš„æµ
class UppercaseTransform extends Transform {
  _transform(chunk, encoding, callback) {
    // è½¬æ¢é€»è¾‘ï¼šå°†æ•°æ®è½¬ä¸ºå¤§å†™
    const upperChunk = chunk.toString().toUpperCase();
    
    // å°†è½¬æ¢åçš„æ•°æ®ä¼ é€’ç»™ä¸‹ä¸€ä¸ªæµ
    this.push(upperChunk);
    
    // å‘Šè¯‰ Node.js è¿™ä¸ªå—å¤„ç†å®Œæˆ
    callback();
  }
}

// ä½¿ç”¨è‡ªå®šä¹‰è½¬æ¢æµ
const fs = require('fs');

fs.createReadStream('input.txt')
  .pipe(new UppercaseTransform())
  .pipe(fs.createWriteStream('output-upper.txt'));

console.log('æ­£åœ¨è½¬æ¢æ–‡ä»¶ä¸ºå¤§å†™...');
```

### 8.3 å®ç”¨çš„ Transform ç¤ºä¾‹


```javascript
// ğŸ’¡ ç¤ºä¾‹1ï¼šCSV æ•°æ®å¤„ç†
class CSVLineTransform extends Transform {
  constructor() {
    super({ objectMode: true }); // å¤„ç†å¯¹è±¡è€Œä¸æ˜¯å­—ç¬¦ä¸²
  }
  
  _transform(chunk, encoding, callback) {
    const lines = chunk.toString().split('\n');
    
    lines.forEach(line => {
      if (line.trim()) {
        const data = line.split(',');
        this.push({
          name: data[0],
          age: parseInt(data[1]),
          city: data[2]
        });
      }
    });
    
    callback();
  }
}

// ğŸ’¡ ç¤ºä¾‹2ï¼šJSON æ ¼å¼åŒ–
class JSONFormatter extends Transform {
  _transform(chunk, encoding, callback) {
    try {
      const data = JSON.parse(chunk.toString());
      const formatted = JSON.stringify(data, null, 2); // ç¾åŒ–æ ¼å¼
      this.push(formatted);
    } catch (err) {
      this.emit('error', err);
    }
    callback();
  }
}
```

### 8.4 ä½¿ç”¨å†…ç½®çš„ Transform æµ


```javascript
const zlib = require('zlib');
const fs = require('fs');

// ğŸ—œï¸ æ–‡ä»¶å‹ç¼©
fs.createReadStream('input.txt')
  .pipe(zlib.createGzip())
  .pipe(fs.createWriteStream('output.txt.gz'));

// ğŸ“‚ æ–‡ä»¶è§£å‹
fs.createReadStream('compressed.txt.gz')
  .pipe(zlib.createGunzip())
  .pipe(fs.createWriteStream('decompressed.txt'));

// ğŸ”— å¤šä¸ªè½¬æ¢ç»„åˆ
fs.createReadStream('data.json')
  .pipe(new JSONFormatter())      // JSON ç¾åŒ–
  .pipe(zlib.createGzip())        // å‹ç¼©
  .pipe(fs.createWriteStream('formatted-data.json.gz'));
```

---

## 9. ğŸŒŠ èƒŒå‹å¤„ç†åŸºç¡€


### 9.1 ä»€ä¹ˆæ˜¯èƒŒå‹ï¼ˆBackpressureï¼‰


**ğŸ’¡ èƒŒå‹çš„æ¦‚å¿µ**ï¼š
```
æƒ³è±¡ä¸€ä¸ªæ°´ç®¡ç³»ç»Ÿï¼š

å¿«é€Ÿæ°´æº âœ ç»†ç®¡å­ âœ æ…¢é€Ÿå‡ºå£
   ğŸ’§ğŸ’§ğŸ’§     ğŸ”’      ğŸ’§

é—®é¢˜ï¼šæ°´æºå¤ªå¿«ï¼Œç®¡å­ä¼šçˆ†ï¼
è§£å†³ï¼šæ§åˆ¶æ°´æºæµé€Ÿï¼Œé¿å…æº¢å‡º

åœ¨ Node.js ä¸­ï¼š
å¿«é€Ÿè¯»å– âœ æ…¢é€Ÿå¤„ç† âœ æ…¢é€Ÿå†™å…¥
å¦‚æœä¸æ§åˆ¶ï¼Œå†…å­˜ä¼šçˆ†æ»¡ï¼
```

### 9.2 èƒŒå‹çš„å®é™…é—®é¢˜


```javascript
// âš ï¸ æ²¡æœ‰èƒŒå‹æ§åˆ¶çš„é—®é¢˜ç¤ºä¾‹
const fs = require('fs');

const readStream = fs.createReadStream('huge-file.txt');
const writeStream = fs.createWriteStream('output.txt');

readStream.on('data', (chunk) => {
  // å¦‚æœå†™å…¥å¤ªæ…¢ï¼Œæ•°æ®ä¼šå †ç§¯åœ¨å†…å­˜ä¸­ï¼
  const success = writeStream.write(chunk);
  
  if (!success) {
    console.log('âš ï¸ å†™å…¥ç¼“å†²åŒºæ»¡äº†ï¼Œä½†æˆ‘ä»¬è¿˜åœ¨ç»§ç»­è¯»å–...');
    // è¿™æ ·ä¼šå¯¼è‡´å†…å­˜ä¸æ–­å¢é•¿ï¼
  }
});
```

### 9.3 æ­£ç¡®çš„èƒŒå‹å¤„ç†


```javascript
// âœ… æ­£ç¡®å¤„ç†èƒŒå‹
const fs = require('fs');

function copyFileWithBackpressure(source, destination) {
  const readStream = fs.createReadStream(source);
  const writeStream = fs.createWriteStream(destination);
  
  readStream.on('data', (chunk) => {
    const success = writeStream.write(chunk);
    
    if (!success) {
      // å†™å…¥ç¼“å†²åŒºæ»¡äº†ï¼Œæš‚åœè¯»å–
      console.log('â¸ï¸ æš‚åœè¯»å–ï¼Œç­‰å¾…å†™å…¥ç¼“å†²åŒºæ¸…ç©º...');
      readStream.pause();
      
      // ç­‰å¾… drain äº‹ä»¶ï¼Œè¡¨ç¤ºå¯ä»¥ç»§ç»­å†™å…¥
      writeStream.once('drain', () => {
        console.log('â–¶ï¸ ç»§ç»­è¯»å–...');
        readStream.resume();
      });
    }
  });
  
  readStream.on('end', () => {
    writeStream.end();
  });
}

// ğŸ’¡ ä½¿ç”¨ pipe() è‡ªåŠ¨å¤„ç†èƒŒå‹ï¼ˆæ¨èï¼‰
// pipe() æ–¹æ³•å†…éƒ¨å·²ç»å¤„ç†äº†èƒŒå‹é—®é¢˜
readStream.pipe(writeStream);
```

### 9.4 èƒŒå‹å¤„ç†çš„æœ€ä½³å®è·µ


```javascript
// ğŸ¯ æœ€ä½³å®è·µï¼šä½¿ç”¨ pipeline()
const { pipeline } = require('stream');
const fs = require('fs');
const zlib = require('zlib');

// pipeline() æä¾›æ›´å¥½çš„é”™è¯¯å¤„ç†å’Œæ¸…ç†
pipeline(
  fs.createReadStream('input.txt'),
  zlib.createGzip(),
  fs.createWriteStream('output.txt.gz'),
  (err) => {
    if (err) {
      console.log('âŒ å¤„ç†å¤±è´¥:', err.message);
    } else {
      console.log('âœ… å¤„ç†æˆåŠŸå®Œæˆ');
    }
  }
);
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Stream æœ¬è´¨ï¼šåˆ†å—å¤„ç†æ•°æ®ï¼ŒèŠ‚çœå†…å­˜ï¼Œæå‡æ€§èƒ½
ğŸ”¸ å››ç§ç±»å‹ï¼šReadable(è¯»)ã€Writable(å†™)ã€Duplex(è¯»å†™)ã€Transform(è½¬æ¢)
ğŸ”¸ æ ¸å¿ƒæ–¹æ³•ï¼špipe()è¿æ¥æµï¼Œè‡ªåŠ¨å¤„ç†æ•°æ®ä¼ è¾“
ğŸ”¸ é‡è¦äº‹ä»¶ï¼šdata(æ•°æ®)ã€end(ç»“æŸ)ã€error(é”™è¯¯)ã€drain(å¯å†™)
ğŸ”¸ å®é™…åº”ç”¨ï¼šæ–‡ä»¶æ“ä½œã€æ•°æ®è½¬æ¢ã€ç½‘ç»œé€šä¿¡
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆä½¿ç”¨ Stream**
```
å†…å­˜ä¼˜åŠ¿ï¼š
- ä¼ ç»Ÿæ–¹å¼ï¼šè¯»å– 1GB æ–‡ä»¶éœ€è¦ 1GB å†…å­˜
- Stream æ–¹å¼ï¼šåªéœ€è¦ 64KB å†…å­˜å¤„ç†ä»»æ„å¤§å°æ–‡ä»¶

æ€§èƒ½ä¼˜åŠ¿ï¼š
- ä¼ ç»Ÿæ–¹å¼ï¼šè¯»å®Œâ†’å¤„ç†â†’å†™å…¥ï¼ˆä¸²è¡Œï¼‰
- Stream æ–¹å¼ï¼šè¾¹è¯»è¾¹å¤„ç†è¾¹å†™å…¥ï¼ˆå¹¶è¡Œï¼‰
```

**ğŸ”¹ pipe() çš„å¼ºå¤§ä¹‹å¤„**
```
è‡ªåŠ¨åŠŸèƒ½ï¼š
âœ… è‡ªåŠ¨è¿æ¥è¯»å†™æµ
âœ… è‡ªåŠ¨å¤„ç†èƒŒå‹
âœ… è‡ªåŠ¨å¤„ç†é”™è¯¯
âœ… è‡ªåŠ¨æ¸…ç†èµ„æº

æ‰‹åŠ¨vsè‡ªåŠ¨ï¼š
âŒ æ‰‹åŠ¨ï¼šéœ€è¦ç›‘å¬å¤šä¸ªäº‹ä»¶ï¼Œå¤„ç†å„ç§æƒ…å†µ
âœ… pipe()ï¼šä¸€è¡Œä»£ç æå®šæ‰€æœ‰é—®é¢˜
```

**ğŸ”¹ ä»€ä¹ˆæ—¶å€™ä½¿ç”¨ Stream**
```
é€‚ç”¨åœºæ™¯ï¼š
âœ… å¤„ç†å¤§æ–‡ä»¶ï¼ˆ>1MBï¼‰
âœ… å®æ—¶æ•°æ®å¤„ç†
âœ… ç½‘ç»œæ•°æ®ä¼ è¾“
âœ… æ•°æ®æ ¼å¼è½¬æ¢

ä¸é€‚ç”¨åœºæ™¯ï¼š
âŒ å°æ•°æ®ï¼ˆ<1KBï¼‰
âŒ éœ€è¦éšæœºè®¿é—®æ•°æ®
âŒ ç®€å•çš„ä¸€æ¬¡æ€§æ“ä½œ
```

### 10.3 å®é™…å¼€å‘å»ºè®®


**ğŸ› ï¸ æœ€ä½³å®è·µ**
```javascript
// âœ… æ¨èï¼šä½¿ç”¨ pipeline() å¤„ç†å¤šä¸ªæµ
const { pipeline } = require('stream');

pipeline(
  source,
  transform1,
  transform2,
  destination,
  (err) => {
    // ç»Ÿä¸€é”™è¯¯å¤„ç†
  }
);

// âœ… æ¨èï¼šæ€»æ˜¯å¤„ç†é”™è¯¯äº‹ä»¶
stream.on('error', (err) => {
  console.error('Stream é”™è¯¯:', err);
});

// âœ… æ¨èï¼šè®¾ç½®åˆé€‚çš„ç¼“å†²åŒºå¤§å°
const stream = fs.createReadStream('file.txt', {
  highWaterMark: 1024 * 16 // 16KB ç¼“å†²åŒº
});
```

**ğŸ¯ æ€§èƒ½ä¼˜åŒ–æŠ€å·§**
```javascript
// 1. åˆç†è®¾ç½®ç¼“å†²åŒºå¤§å°
const options = {
  highWaterMark: 1024 * 64 // 64KBï¼Œæ ¹æ®å®é™…æƒ…å†µè°ƒæ•´
};

// 2. ä½¿ç”¨å¯¹è±¡æ¨¡å¼å¤„ç†ç»“æ„åŒ–æ•°æ®
const transform = new Transform({
  objectMode: true // å¤„ç†å¯¹è±¡è€Œéå­—ç¬¦ä¸²
});

// 3. åŠæ—¶é”€æ¯ä¸éœ€è¦çš„æµ
stream.destroy();
```

### 10.4 å¸¸è§é—®é¢˜ä¸è§£å†³


| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| **å†…å­˜ä¸æ–­å¢é•¿** | æ²¡æœ‰å¤„ç†èƒŒå‹ | ä½¿ç”¨ `pipe()` æˆ–æ­£ç¡®å¤„ç† `drain` äº‹ä»¶ |
| **æ•°æ®ä¸¢å¤±** | æ²¡æœ‰ç›‘å¬ `error` äº‹ä»¶ | æ€»æ˜¯æ·»åŠ é”™è¯¯å¤„ç† |
| **æ–‡ä»¶æŸå** | æµæ²¡æœ‰æ­£ç¡®å…³é—­ | ä½¿ç”¨ `pipeline()` ç¡®ä¿æ¸…ç† |
| **æ€§èƒ½å·®** | ç¼“å†²åŒºè®¾ç½®ä¸å½“ | è°ƒæ•´ `highWaterMark` å¤§å° |

### 10.5 è¿›é˜¶å­¦ä¹ æ–¹å‘


```
ğŸ”¸ æ·±å…¥å­¦ä¹ ï¼š
  - Readable._read() å†…éƒ¨å®ç°
  - Writable._write() è‡ªå®šä¹‰é€»è¾‘
  - Transform._transform() æ•°æ®è½¬æ¢
  - æµçš„å†…éƒ¨ç¼“å†²æœºåˆ¶

ğŸ”¸ å®æˆ˜é¡¹ç›®ï¼š
  - æ–‡ä»¶ä¸Šä¼ ä¸‹è½½ç³»ç»Ÿ
  - æ—¥å¿—å¤„ç†ç³»ç»Ÿ
  - æ•°æ®è½¬æ¢å·¥å…·
  - å®æ—¶æ•°æ®åˆ†æ

ğŸ”¸ ç›¸å…³æŠ€æœ¯ï¼š
  - HTTP æµ
  - WebSocket æµ
  - æ•°æ®åº“è¿æ¥æµ
  - ç¬¬ä¸‰æ–¹æµåº“ï¼ˆå¦‚ highland.jsï¼‰
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- Stream è®©å¤§æ•°æ®å¤„ç†å˜ç®€å•
- pipe() æ˜¯æµæ“ä½œçš„æœ€ä½³æœ‹å‹
- å§‹ç»ˆå¤„ç†é”™è¯¯ï¼Œé¿å…ç¨‹åºå´©æºƒ
- åˆç†é…ç½®ç¼“å†²åŒºï¼Œä¼˜åŒ–æ€§èƒ½è¡¨ç°