---
title: 16ã€upstreamè´Ÿè½½å‡è¡¡
---
## ğŸ“š ç›®å½•

1. [ä»€ä¹ˆæ˜¯upstreamè´Ÿè½½å‡è¡¡](#1-ä»€ä¹ˆæ˜¯upstreamè´Ÿè½½å‡è¡¡)
2. [upstreamåŸºç¡€é…ç½®è¯­æ³•](#2-upstreamåŸºç¡€é…ç½®è¯­æ³•)
3. [æœåŠ¡å™¨é…ç½®å‚æ•°è¯¦è§£](#3-æœåŠ¡å™¨é…ç½®å‚æ•°è¯¦è§£)
4. [è´Ÿè½½å‡è¡¡ç®—æ³•é€‰æ‹©](#4-è´Ÿè½½å‡è¡¡ç®—æ³•é€‰æ‹©)
5. [å¥åº·æ£€æŸ¥ä¸æ•…éšœå¤„ç†](#5-å¥åº·æ£€æŸ¥ä¸æ•…éšœå¤„ç†)
6. [å®é™…åº”ç”¨åœºæ™¯é…ç½®](#6-å®é™…åº”ç”¨åœºæ™¯é…ç½®)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ ä»€ä¹ˆæ˜¯upstreamè´Ÿè½½å‡è¡¡


### 1.1 è´Ÿè½½å‡è¡¡çš„ç”Ÿæ´»åŒ–ç†è§£


**ğŸª æƒ³è±¡ä¸€ä¸ªè¶…å¸‚çš„æ”¶é“¶å°åœºæ™¯**
```
æ™®é€šæƒ…å†µï¼šåªæœ‰1ä¸ªæ”¶é“¶å‘˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é¡¾å®¢æ’é˜Ÿ â”‚ â†’ [æ”¶é“¶å‘˜] â†’ ç»“è´¦å®Œæˆ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     å‹åŠ›å¤§ï¼Œæ•ˆç‡ä½

è´Ÿè½½å‡è¡¡ï¼šå¤šä¸ªæ”¶é“¶å‘˜åˆ†æ‹…å·¥ä½œ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    [æ”¶é“¶å‘˜1] â†’ ç»“è´¦å®Œæˆ
â”‚ é¡¾å®¢æ’é˜Ÿ â”‚ â†’  [æ”¶é“¶å‘˜2] â†’ ç»“è´¦å®Œæˆ  
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    [æ”¶é“¶å‘˜3] â†’ ç»“è´¦å®Œæˆ
                å‹åŠ›åˆ†æ•£ï¼Œæ•ˆç‡é«˜
```

### 1.2 upstreamåœ¨Nginxä¸­çš„ä½œç”¨


**ğŸ’¡ æ ¸å¿ƒæ¦‚å¿µ**
- **upstream**ï¼šå®šä¹‰ä¸€ç»„åç«¯æœåŠ¡å™¨
- **è´Ÿè½½å‡è¡¡**ï¼šå°†ç”¨æˆ·è¯·æ±‚åˆ†å‘åˆ°å¤šå°æœåŠ¡å™¨
- **é«˜å¯ç”¨**ï¼šä¸€å°æœåŠ¡å™¨å®•æœºï¼Œå…¶ä»–ç»§ç»­å·¥ä½œ
- **æ€§èƒ½æå‡**ï¼šå¤šå°æœåŠ¡å™¨å¹¶è¡Œå¤„ç†è¯·æ±‚

**ğŸ”„ å·¥ä½œæµç¨‹å›¾ç¤º**
```
ç”¨æˆ·è¯·æ±‚ â†’ Nginx(è´Ÿè½½å‡è¡¡å™¨) â†’ åç«¯æœåŠ¡å™¨ç»„
   |              |                  |
   |              |              â”Œâ”€â”€â”€â”€â”€â”€â”€â”
   |              â””â”€ åˆ†å‘è¯·æ±‚ â”€â”€â†’ â”‚æœåŠ¡å™¨1â”‚
   |                             â”œâ”€â”€â”€â”€â”€â”€â”€â”¤
   â””â”€ è¿”å›å“åº” â†â”€ æ”¶é›†å“åº” â†â”€â”€â”€â”€â”€â”€ â”‚æœåŠ¡å™¨2â”‚
                                â”œâ”€â”€â”€â”€â”€â”€â”€â”¤
                                â”‚æœåŠ¡å™¨3â”‚
                                â””â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 ä¸ºä»€ä¹ˆéœ€è¦upstream


**âŒ å•å°æœåŠ¡å™¨çš„é—®é¢˜**
- ğŸ”´ **æ€§èƒ½ç“¶é¢ˆ**ï¼šä¸€å°æœåŠ¡å™¨å¤„ç†èƒ½åŠ›æœ‰é™
- ğŸ”´ **å•ç‚¹æ•…éšœ**ï¼šæœåŠ¡å™¨å®•æœºå¯¼è‡´æ•´ä¸ªç½‘ç«™ä¸å¯ç”¨
- ğŸ”´ **æ‰©å±•å›°éš¾**ï¼šç”¨æˆ·å¢é•¿æ—¶æ— æ³•å¿«é€Ÿå¢åŠ å¤„ç†èƒ½åŠ›

**âœ… upstreamè§£å†³æ–¹æ¡ˆ**
- ğŸŸ¢ **æ€§èƒ½æå‡**ï¼šå¤šå°æœåŠ¡å™¨å¹¶è¡Œå¤„ç†ï¼Œæé«˜ååé‡
- ğŸŸ¢ **é«˜å¯ç”¨æ€§**ï¼šä¸€å°å®•æœºï¼Œå…¶ä»–ç»§ç»­æœåŠ¡
- ğŸŸ¢ **æ°´å¹³æ‰©å±•**ï¼šéœ€è¦æ—¶å¯ä»¥è½»æ¾æ·»åŠ æ–°æœåŠ¡å™¨

---

## 2. ğŸ“ upstreamåŸºç¡€é…ç½®è¯­æ³•


### 2.1 æœ€ç®€å•çš„upstreamé…ç½®


```nginx
# å®šä¹‰åç«¯æœåŠ¡å™¨ç»„
upstream backend {
    server 192.168.1.10:8080;
    server 192.168.1.11:8080;
    server 192.168.1.12:8080;
}

# åœ¨locationä¸­ä½¿ç”¨
server {
    listen 80;
    server_name example.com;
    
    location / {
        proxy_pass http://backend;
    }
}
```

**ğŸ”¸ é…ç½®è§£è¯»**
- `upstream backend`ï¼šå®šä¹‰åä¸º"backend"çš„æœåŠ¡å™¨ç»„
- `server IP:ç«¯å£`ï¼šæŒ‡å®šåç«¯æœåŠ¡å™¨åœ°å€
- `proxy_pass http://backend`ï¼šå°†è¯·æ±‚è½¬å‘ç»™æœåŠ¡å™¨ç»„

### 2.2 upstreamé…ç½®çš„ä½ç½®


**ğŸ“ é…ç½®æ–‡ä»¶ç»“æ„**
```nginx
# nginx.conf ä¸»é…ç½®æ–‡ä»¶
http {
    # upstreamå¿…é¡»å®šä¹‰åœ¨httpå—å†…
    upstream web_servers {
        server 192.168.1.10:8080;
        server 192.168.1.11:8080;
    }
    
    # serverå—å¯ä»¥å¼•ç”¨upstream
    server {
        listen 80;
        location / {
            proxy_pass http://web_servers;
        }
    }
}
```

**âš ï¸ ä½ç½®è¦æ±‚**
- upstream **å¿…é¡»**åœ¨ `http{}` å—å†…å®šä¹‰
- upstream **ä¸èƒ½**åœ¨ `server{}` æˆ– `location{}` å†…å®šä¹‰
- å®šä¹‰åå¯ä»¥åœ¨ä»»ä½• `location` ä¸­ä½¿ç”¨

### 2.3 å‘½åè§„èŒƒä¸å¼•ç”¨


**ğŸ“Œ å‘½åå»ºè®®**
```nginx
# å¥½çš„å‘½åæ–¹å¼
upstream api_servers { }      # APIæœåŠ¡å™¨ç»„
upstream web_servers { }      # WebæœåŠ¡å™¨ç»„  
upstream db_servers { }       # æ•°æ®åº“æœåŠ¡å™¨ç»„

# é¿å…çš„å‘½å
upstream group1 { }           # å«ä¹‰ä¸æ˜
upstream test { }             # è¿‡äºç®€å•
```

**ğŸ”— å¼•ç”¨æ–¹å¼**
```nginx
location /api/ {
    proxy_pass http://api_servers;  # å¼•ç”¨APIæœåŠ¡å™¨ç»„
}

location /static/ {
    proxy_pass http://web_servers;  # å¼•ç”¨WebæœåŠ¡å™¨ç»„
}
```

---

## 3. âš™ï¸ æœåŠ¡å™¨é…ç½®å‚æ•°è¯¦è§£


### 3.1 weightæƒé‡é…ç½®


**ğŸ’° æƒé‡å°±åƒ"å·¥èµ„åˆ†é…"**
```
å…¬å¸æœ‰3ä¸ªå‘˜å·¥åšåŒæ ·å·¥ä½œï¼š
- è€å‘˜å·¥Aï¼šèƒ½åŠ›å¼ºï¼Œåˆ†é…40%çš„å·¥ä½œ (weight=4)
- ä¸­ç­‰å‘˜å·¥Bï¼šä¸€èˆ¬èƒ½åŠ›ï¼Œåˆ†é…30%çš„å·¥ä½œ (weight=3)  
- æ–°å‘˜å·¥Cï¼šèƒ½åŠ›å¼±ï¼Œåˆ†é…30%çš„å·¥ä½œ (weight=3)
```

**âš–ï¸ æƒé‡é…ç½®ç¤ºä¾‹**
```nginx
upstream backend {
    server 192.168.1.10:8080 weight=5;  # é«˜æ€§èƒ½æœåŠ¡å™¨ï¼Œå¤šåˆ†é…
    server 192.168.1.11:8080 weight=3;  # ä¸­ç­‰æ€§èƒ½
    server 192.168.1.12:8080 weight=2;  # æ€§èƒ½è¾ƒä½ï¼Œå°‘åˆ†é…
}
```

**ğŸ“Š æƒé‡åˆ†é…è®¡ç®—**
```
æ€»æƒé‡ = 5 + 3 + 2 = 10
æœåŠ¡å™¨1: 5/10 = 50% çš„è¯·æ±‚
æœåŠ¡å™¨2: 3/10 = 30% çš„è¯·æ±‚  
æœåŠ¡å™¨3: 2/10 = 20% çš„è¯·æ±‚
```

### 3.2 max_failsæœ€å¤§å¤±è´¥æ¬¡æ•°


**ğŸš¨ å¤±è´¥æ£€æµ‹æœºåˆ¶**
```nginx
upstream backend {
    server 192.168.1.10:8080 max_fails=3;
    server 192.168.1.11:8080 max_fails=2;
}
```

**ğŸ’¡ å·¥ä½œåŸç†**
```
è¯·æ±‚è¿‡ç¨‹ï¼š
ç¬¬1æ¬¡å¤±è´¥ â†’ è®°å½•1æ¬¡å¤±è´¥ â†’ ç»§ç»­ä½¿ç”¨
ç¬¬2æ¬¡å¤±è´¥ â†’ è®°å½•2æ¬¡å¤±è´¥ â†’ ç»§ç»­ä½¿ç”¨  
ç¬¬3æ¬¡å¤±è´¥ â†’ è¾¾åˆ°max_fails â†’ æš‚æ—¶ç§»é™¤æœåŠ¡å™¨
```

**ğŸ”¢ å‚æ•°è®¾ç½®å»ºè®®**
- **é»˜è®¤å€¼**ï¼š`max_fails=1`
- **ç”Ÿäº§ç¯å¢ƒ**ï¼šå»ºè®®è®¾ç½®ä¸º `2-5`
- **æµ‹è¯•ç¯å¢ƒ**ï¼šå¯ä»¥è®¾ç½®ä¸º `1`

### 3.3 fail_timeoutå¤±è´¥è¶…æ—¶æ—¶é—´


**â° è¶…æ—¶æ¢å¤æœºåˆ¶**
```nginx
upstream backend {
    server 192.168.1.10:8080 max_fails=3 fail_timeout=30s;
}
```

**ğŸ”„ æ¢å¤æµç¨‹**
```
æœåŠ¡å™¨è¢«æ ‡è®°ä¸ºå¤±è´¥ â†’ ç­‰å¾…30ç§’ â†’ é‡æ–°å°è¯• â†’ æˆåŠŸåˆ™æ¢å¤
```

**âš ï¸ æ³¨æ„äº‹é¡¹**
- **fail_timeout** æ—¢æ˜¯å¤±è´¥ç»Ÿè®¡çš„æ—¶é—´çª—å£ï¼Œä¹Ÿæ˜¯è¢«è¸¢å‡ºåçš„æ¢å¤ç­‰å¾…æ—¶é—´
- é»˜è®¤å€¼æ˜¯ `10s`
- ç”Ÿäº§ç¯å¢ƒå»ºè®®è®¾ç½®ä¸º `30s-60s`

### 3.4 backupå¤‡ç”¨æœåŠ¡å™¨


**ğŸš‘ å¤‡ç”¨æœåŠ¡å™¨å°±åƒ"å¤‡ç”¨è½®èƒ"**
```nginx
upstream backend {
    server 192.168.1.10:8080;           # ä¸»æœåŠ¡å™¨
    server 192.168.1.11:8080;           # ä¸»æœåŠ¡å™¨
    server 192.168.1.12:8080 backup;    # å¤‡ç”¨æœåŠ¡å™¨
}
```

**ğŸ¯ å¤‡ç”¨æœåŠ¡å™¨ç‰¹ç‚¹**
- **æ­£å¸¸æƒ…å†µ**ï¼šä¸æ¥æ”¶è¯·æ±‚ï¼Œå¤„äºå¾…å‘½çŠ¶æ€
- **æ•…éšœæ—¶**ï¼šä¸»æœåŠ¡å™¨éƒ½ä¸å¯ç”¨æ—¶æ‰å¯ç”¨
- **æ¢å¤å**ï¼šä¸»æœåŠ¡å™¨æ¢å¤åï¼Œå¤‡ç”¨æœåŠ¡å™¨åœæ­¢æœåŠ¡

### 3.5 downä¸‹çº¿æ ‡è®°


**ğŸ”§ ç»´æŠ¤æ¨¡å¼**
```nginx
upstream backend {
    server 192.168.1.10:8080;
    server 192.168.1.11:8080 down;      # æ ‡è®°ä¸ºä¸‹çº¿
    server 192.168.1.12:8080;
}
```

**ğŸ’¡ ä½¿ç”¨åœºæ™¯**
- **æœåŠ¡å™¨ç»´æŠ¤**ï¼šä¸´æ—¶ä¸‹çº¿æŸå°æœåŠ¡å™¨
- **ç‰ˆæœ¬å‡çº§**ï¼šé€å°å‡çº§ä¸å½±å“æœåŠ¡
- **é…ç½®è°ƒè¯•**ï¼šå¿«é€Ÿç¦ç”¨æœ‰é—®é¢˜çš„æœåŠ¡å™¨

### 3.6 ç»¼åˆé…ç½®ç¤ºä¾‹


```nginx
upstream web_cluster {
    # ä¸»åŠ›æœåŠ¡å™¨ - é«˜é…ç½®ï¼Œé«˜æƒé‡
    server 192.168.1.10:8080 weight=5 max_fails=3 fail_timeout=30s;
    
    # è¾…åŠ©æœåŠ¡å™¨ - ä¸­é…ç½®ï¼Œä¸­æƒé‡  
    server 192.168.1.11:8080 weight=3 max_fails=3 fail_timeout=30s;
    
    # è€æ—§æœåŠ¡å™¨ - ä½é…ç½®ï¼Œä½æƒé‡
    server 192.168.1.12:8080 weight=1 max_fails=2 fail_timeout=60s;
    
    # å¤‡ç”¨æœåŠ¡å™¨ - ç´§æ€¥æƒ…å†µå¯ç”¨
    server 192.168.1.13:8080 backup;
    
    # ç»´æŠ¤ä¸­æœåŠ¡å™¨ - æš‚æ—¶ä¸‹çº¿
    server 192.168.1.14:8080 down;
}
```

---

## 4. ğŸ² è´Ÿè½½å‡è¡¡ç®—æ³•é€‰æ‹©


### 4.1 è½®è¯¢ç®—æ³•ï¼ˆé»˜è®¤ï¼‰


**ğŸ  è½®è¯¢å°±åƒ"æ’é˜Ÿè½®æµ"**
```
è¯·æ±‚åˆ†å‘é¡ºåºï¼š
è¯·æ±‚1 â†’ æœåŠ¡å™¨A
è¯·æ±‚2 â†’ æœåŠ¡å™¨B  
è¯·æ±‚3 â†’ æœåŠ¡å™¨C
è¯·æ±‚4 â†’ æœåŠ¡å™¨A (é‡æ–°å¼€å§‹)
```

**âš™ï¸ é…ç½®æ–¹å¼**
```nginx
upstream backend {
    # ä¸éœ€è¦é¢å¤–é…ç½®ï¼Œé»˜è®¤å°±æ˜¯è½®è¯¢
    server 192.168.1.10:8080;
    server 192.168.1.11:8080;
    server 192.168.1.12:8080;
}
```

**âœ… é€‚ç”¨åœºæ™¯**
- æœåŠ¡å™¨æ€§èƒ½ç›¸è¿‘
- è¯·æ±‚å¤„ç†æ—¶é—´ç›¸ä¼¼
- ç®€å•çš„Webåº”ç”¨

### 4.2 åŠ æƒè½®è¯¢ç®—æ³•


**ğŸ“Š æŒ‰æƒé‡åˆ†é…**
```nginx
upstream backend {
    server 192.168.1.10:8080 weight=3;  # 3æ¬¡
    server 192.168.1.11:8080 weight=2;  # 2æ¬¡  
    server 192.168.1.12:8080 weight=1;  # 1æ¬¡
}
```

**ğŸ”„ åˆ†é…æ¨¡å¼**
```
6ä¸ªè¿ç»­è¯·æ±‚çš„åˆ†é…ï¼š
è¯·æ±‚1 â†’ æœåŠ¡å™¨A (weight=3)
è¯·æ±‚2 â†’ æœåŠ¡å™¨A 
è¯·æ±‚3 â†’ æœåŠ¡å™¨A
è¯·æ±‚4 â†’ æœåŠ¡å™¨B (weight=2)
è¯·æ±‚5 â†’ æœåŠ¡å™¨B
è¯·æ±‚6 â†’ æœåŠ¡å™¨C (weight=1)
```

### 4.3 æœ€å°‘è¿æ¥ç®—æ³•


**ğŸ“ˆ æ™ºèƒ½åˆ†é…ç»™ç©ºé—²æœåŠ¡å™¨**
```nginx
upstream backend {
    least_conn;  # å¯ç”¨æœ€å°‘è¿æ¥ç®—æ³•
    server 192.168.1.10:8080;
    server 192.168.1.11:8080;
    server 192.168.1.12:8080;
}
```

**ğŸ§  å·¥ä½œåŸç†**
```
å½“å‰è¿æ¥çŠ¶æ€ï¼š
æœåŠ¡å™¨A: 5ä¸ªæ´»è·ƒè¿æ¥
æœåŠ¡å™¨B: 3ä¸ªæ´»è·ƒè¿æ¥  â† æ–°è¯·æ±‚åˆ†é…ç»™B
æœåŠ¡å™¨C: 7ä¸ªæ´»è·ƒè¿æ¥
```

**âœ… é€‚ç”¨åœºæ™¯**
- è¯·æ±‚å¤„ç†æ—¶é—´å·®å¼‚è¾ƒå¤§
- é•¿è¿æ¥åº”ç”¨
- éœ€è¦å‡åŒ€åˆ†é…è´Ÿè½½

### 4.4 IPå“ˆå¸Œç®—æ³•


**ğŸ” åŒä¸€ç”¨æˆ·å›ºå®šæœåŠ¡å™¨**
```nginx
upstream backend {
    ip_hash;  # å¯ç”¨IPå“ˆå¸Œ
    server 192.168.1.10:8080;
    server 192.168.1.11:8080;
    server 192.168.1.12:8080;
}
```

**ğŸ¯ å›ºå®šæ˜ å°„å…³ç³»**
```
ç”¨æˆ·IPå“ˆå¸Œè®¡ç®—ï¼š
192.168.1.100 â†’ hashå€¼123 â†’ æœåŠ¡å™¨A
192.168.1.101 â†’ hashå€¼456 â†’ æœåŠ¡å™¨B
192.168.1.102 â†’ hashå€¼789 â†’ æœåŠ¡å™¨C

åŒä¸€IPçš„æ‰€æœ‰è¯·æ±‚éƒ½å»åŒä¸€å°æœåŠ¡å™¨
```

**âœ… é€‚ç”¨åœºæ™¯**
- éœ€è¦ä¼šè¯ä¿æŒçš„åº”ç”¨
- è´­ç‰©è½¦ã€ç™»å½•çŠ¶æ€
- æœ¬åœ°ç¼“å­˜ä¾èµ–

### 4.5 ç®—æ³•é€‰æ‹©å¯¹æ¯”è¡¨


| ç®—æ³•ç±»å‹ | **é€‚ç”¨åœºæ™¯** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** |
|---------|-------------|---------|---------|
| ğŸ”„ **è½®è¯¢** | `æœåŠ¡å™¨æ€§èƒ½ç›¸è¿‘` | `ç®€å•ã€å‡åŒ€åˆ†é…` | `ä¸è€ƒè™‘æœåŠ¡å™¨è´Ÿè½½` |
| âš–ï¸ **åŠ æƒè½®è¯¢** | `æœåŠ¡å™¨æ€§èƒ½ä¸åŒ` | `æŒ‰æ€§èƒ½åˆ†é…è´Ÿè½½` | `ä»ä¸è€ƒè™‘å®æ—¶è´Ÿè½½` |
| ğŸ“Š **æœ€å°‘è¿æ¥** | `è¯·æ±‚å¤„ç†æ—¶é—´å·®å¼‚å¤§` | `æ™ºèƒ½è´Ÿè½½å‡è¡¡` | `è®¡ç®—å¼€é”€ç¨å¤§` |
| ğŸ” **IPå“ˆå¸Œ** | `éœ€è¦ä¼šè¯ä¿æŒ` | `ç”¨æˆ·ä½“éªŒä¸€è‡´` | `è´Ÿè½½å¯èƒ½ä¸å‡` |

---

## 5. ğŸ¥ å¥åº·æ£€æŸ¥ä¸æ•…éšœå¤„ç†


### 5.1 è¢«åŠ¨å¥åº·æ£€æŸ¥


**ğŸ‘¨â€âš•ï¸ è¢«åŠ¨æ£€æŸ¥å°±åƒ"ç”Ÿç—…äº†æ‰çœ‹ç—…"**
```nginx
upstream backend {
    server 192.168.1.10:8080 max_fails=3 fail_timeout=30s;
    server 192.168.1.11:8080 max_fails=2 fail_timeout=60s;
}
```

**ğŸ” æ£€æŸ¥æµç¨‹**
```
æ­£å¸¸è¯·æ±‚ â†’ æœåŠ¡å™¨å“åº”æ­£å¸¸ â†’ ç»§ç»­ä½¿ç”¨
æ­£å¸¸è¯·æ±‚ â†’ æœåŠ¡å™¨æ— å“åº”/é”™è¯¯ â†’ è®°å½•å¤±è´¥æ¬¡æ•°
å¤±è´¥æ¬¡æ•°è¾¾åˆ°max_fails â†’ æ ‡è®°æœåŠ¡å™¨ä¸å¯ç”¨
ç­‰å¾…fail_timeoutæ—¶é—´ â†’ é‡æ–°å°è¯•ä½¿ç”¨
```

### 5.2 æ•…éšœåˆ¤æ–­æ¡ä»¶


**âŒ è¢«è®¤ä¸ºæ˜¯å¤±è´¥çš„æƒ…å†µ**
- **è¿æ¥è¶…æ—¶**ï¼šæ— æ³•å»ºç«‹TCPè¿æ¥
- **å“åº”è¶…æ—¶**ï¼šè¿æ¥å»ºç«‹ä½†æ— å“åº”
- **HTTPé”™è¯¯**ï¼šè¿”å›5xxçŠ¶æ€ç 
- **è¿æ¥é‡ç½®**ï¼šæœåŠ¡å™¨ä¸»åŠ¨æ–­å¼€è¿æ¥

**âœ… è¢«è®¤ä¸ºæ˜¯æˆåŠŸçš„æƒ…å†µ**
- **æ­£å¸¸å“åº”**ï¼šè¿”å›2xxæˆ–3xxçŠ¶æ€ç 
- **åŠæ—¶å“åº”**ï¼šåœ¨è¶…æ—¶æ—¶é—´å†…è¿”å›
- **ç¨³å®šè¿æ¥**ï¼šè¿æ¥ä¿æŒæ­£å¸¸

### 5.3 æ•…éšœæ¢å¤æœºåˆ¶


**ğŸ”„ è‡ªåŠ¨æ¢å¤æµç¨‹**
```
æ­¥éª¤1: æœåŠ¡å™¨è¢«æ ‡è®°ä¸ºå¤±è´¥
   â†“
æ­¥éª¤2: åœæ­¢å‘è¯¥æœåŠ¡å™¨å‘é€è¯·æ±‚
   â†“  
æ­¥éª¤3: ç­‰å¾… fail_timeout æ—¶é—´
   â†“
æ­¥éª¤4: å‘é€ä¸€ä¸ªæµ‹è¯•è¯·æ±‚
   â†“
æ­¥éª¤5: å¦‚æœæˆåŠŸï¼Œæ¢å¤æ­£å¸¸ä½¿ç”¨
       å¦‚æœå¤±è´¥ï¼Œç»§ç»­ç­‰å¾…
```

### 5.4 é«˜çº§æ•…éšœå¤„ç†é…ç½®


```nginx
upstream robust_backend {
    # ä¸»åŠ›æœåŠ¡å™¨ç»„
    server 192.168.1.10:8080 weight=3 max_fails=2 fail_timeout=30s;
    server 192.168.1.11:8080 weight=3 max_fails=2 fail_timeout=30s;
    
    # å¤‡ç”¨æœåŠ¡å™¨ - ä¸»æœåŠ¡å™¨éƒ½æ•…éšœæ—¶å¯ç”¨
    server 192.168.1.20:8080 backup;
    server 192.168.1.21:8080 backup;
    
    # ä¿æŒè¿æ¥æ± ï¼Œæé«˜æ€§èƒ½
    keepalive 32;
}

server {
    listen 80;
    
    location / {
        proxy_pass http://robust_backend;
        
        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 3s;    # è¿æ¥è¶…æ—¶
        proxy_send_timeout 30s;      # å‘é€è¶…æ—¶
        proxy_read_timeout 30s;      # è¯»å–è¶…æ—¶
        
        # é‡è¯•è®¾ç½®
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503;
    }
}
```

---

## 6. ğŸ› ï¸ å®é™…åº”ç”¨åœºæ™¯é…ç½®


### 6.1 ç”µå•†ç½‘ç«™é…ç½®


```nginx
# ç”µå•†ç³»ç»Ÿçš„å¤šå±‚è´Ÿè½½å‡è¡¡
upstream api_servers {
    # APIæœåŠ¡å™¨ - å¤„ç†ä¸šåŠ¡é€»è¾‘
    server 192.168.1.10:8080 weight=5 max_fails=3 fail_timeout=30s;
    server 192.168.1.11:8080 weight=5 max_fails=3 fail_timeout=30s;
    server 192.168.1.12:8080 weight=3 max_fails=3 fail_timeout=30s;
    
    # å¤‡ç”¨APIæœåŠ¡å™¨
    server 192.168.1.20:8080 backup;
    
    keepalive 50;
}

upstream static_servers {
    # é™æ€èµ„æºæœåŠ¡å™¨
    server 192.168.2.10:80 weight=1;
    server 192.168.2.11:80 weight=1;
    
    keepalive 100;
}

server {
    listen 80;
    server_name shop.example.com;
    
    # APIè¯·æ±‚è´Ÿè½½å‡è¡¡
    location /api/ {
        proxy_pass http://api_servers;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    
    # é™æ€èµ„æºè´Ÿè½½å‡è¡¡  
    location /static/ {
        proxy_pass http://static_servers;
        expires 1d;
    }
}
```

### 6.2 ç›´æ’­å¹³å°é…ç½®


```nginx
# ç›´æ’­å¹³å°çš„åœ°åŸŸåŒ–è´Ÿè½½å‡è¡¡
upstream live_servers_beijing {
    # åŒ—äº¬æœºæˆ¿ - ååŒ—ç”¨æˆ·
    server bj1.live.example.com:1935 weight=5;
    server bj2.live.example.com:1935 weight=5;
    server bj3.live.example.com:1935 backup;
}

upstream live_servers_shanghai {
    # ä¸Šæµ·æœºæˆ¿ - åä¸œç”¨æˆ·  
    server sh1.live.example.com:1935 weight=5;
    server sh2.live.example.com:1935 weight=5;
    server sh3.live.example.com:1935 backup;
}

# æ ¹æ®ç”¨æˆ·åœ°ç†ä½ç½®åˆ†å‘
map $geoip_region $backend_pool {
    default live_servers_shanghai;
    "Beijing" live_servers_beijing;
    "Tianjin" live_servers_beijing;
    "Hebei" live_servers_beijing;
}

server {
    listen 80;
    server_name live.example.com;
    
    location / {
        proxy_pass http://$backend_pool;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

### 6.3 å¾®æœåŠ¡æ¶æ„é…ç½®


```nginx
# å¾®æœåŠ¡ç½‘å…³è´Ÿè½½å‡è¡¡
upstream user_service {
    least_conn;  # ä½¿ç”¨æœ€å°‘è¿æ¥ç®—æ³•
    server user1.internal:8080 max_fails=3 fail_timeout=30s;
    server user2.internal:8080 max_fails=3 fail_timeout=30s;
    keepalive 20;
}

upstream order_service {
    ip_hash;  # è®¢å•æœåŠ¡éœ€è¦ä¼šè¯ä¿æŒ
    server order1.internal:8080 max_fails=2 fail_timeout=60s;
    server order2.internal:8080 max_fails=2 fail_timeout=60s;
    keepalive 20;
}

upstream payment_service {
    # æ”¯ä»˜æœåŠ¡ - é«˜å¯ç”¨é…ç½®
    server pay1.internal:8080 weight=3 max_fails=1 fail_timeout=10s;
    server pay2.internal:8080 weight=3 max_fails=1 fail_timeout=10s;
    server pay3.internal:8080 backup;
    keepalive 30;
}

server {
    listen 80;
    server_name api.example.com;
    
    # ç”¨æˆ·æœåŠ¡
    location /user/ {
        proxy_pass http://user_service/;
    }
    
    # è®¢å•æœåŠ¡
    location /order/ {
        proxy_pass http://order_service/;
    }
    
    # æ”¯ä»˜æœåŠ¡  
    location /payment/ {
        proxy_pass http://payment_service/;
        # æ”¯ä»˜æ¥å£ç‰¹æ®Šè¶…æ—¶è®¾ç½®
        proxy_connect_timeout 5s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„åŸºç¡€æ¦‚å¿µ


```
ğŸ”¸ upstreamä½œç”¨ï¼šå®šä¹‰åç«¯æœåŠ¡å™¨ç»„ï¼Œå®ç°è´Ÿè½½å‡è¡¡
ğŸ”¸ åŸºæœ¬è¯­æ³•ï¼šåœ¨httpå—å†…å®šä¹‰ï¼Œlocationä¸­å¼•ç”¨
ğŸ”¸ æ ¸å¿ƒå‚æ•°ï¼šweightæƒé‡ã€max_failså¤±è´¥æ¬¡æ•°ã€fail_timeoutè¶…æ—¶æ—¶é—´
ğŸ”¸ æœåŠ¡å™¨çŠ¶æ€ï¼šbackupå¤‡ç”¨ã€downä¸‹çº¿
ğŸ”¸ ç®—æ³•é€‰æ‹©ï¼šè½®è¯¢ã€åŠ æƒè½®è¯¢ã€æœ€å°‘è¿æ¥ã€IPå“ˆå¸Œ
```

### 7.2 å…³é”®é…ç½®ç†è§£è¦ç‚¹


**ğŸ”¹ æƒé‡åˆ†é…åŸç†**
```
æƒé‡å†³å®šè¯·æ±‚åˆ†é…æ¯”ä¾‹ï¼š
- weight=5 çš„æœåŠ¡å™¨å¤„ç† 5/(5+3+2)=50% çš„è¯·æ±‚
- æ ¹æ®æœåŠ¡å™¨æ€§èƒ½åˆç†è®¾ç½®æƒé‡
- é«˜æ€§èƒ½æœåŠ¡å™¨è®¾ç½®é«˜æƒé‡
```

**ğŸ”¹ æ•…éšœæ£€æµ‹æœºåˆ¶**
```
max_fails + fail_timeout ç»„åˆä½¿ç”¨ï¼š
- max_fails=3: è¿ç»­3æ¬¡å¤±è´¥åè¸¢å‡º
- fail_timeout=30s: 30ç§’åé‡æ–°å°è¯•
- è‡ªåŠ¨æ•…éšœæ¢å¤ï¼Œæ— éœ€äººå·¥å¹²é¢„
```

**ğŸ”¹ ç®—æ³•é€‰æ‹©æ ‡å‡†**
```
é€‰æ‹©ä¾æ®ï¼š
- æœåŠ¡å™¨æ€§èƒ½ç›¸è¿‘ â†’ è½®è¯¢
- æœåŠ¡å™¨æ€§èƒ½ä¸åŒ â†’ åŠ æƒè½®è¯¢  
- è¯·æ±‚å¤„ç†æ—¶é—´å·®å¼‚å¤§ â†’ æœ€å°‘è¿æ¥
- éœ€è¦ä¼šè¯ä¿æŒ â†’ IPå“ˆå¸Œ
```

### 7.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ’¡ ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ**
- âœ… **åˆç†è®¾ç½®æƒé‡**ï¼šæ ¹æ®æœåŠ¡å™¨å®é™…æ€§èƒ½é…ç½®
- âœ… **é…ç½®å¤‡ç”¨æœåŠ¡å™¨**ï¼šç¡®ä¿é«˜å¯ç”¨æ€§
- âœ… **é€‚å½“çš„è¶…æ—¶è®¾ç½®**ï¼šé¿å…é•¿æ—¶é—´ç­‰å¾…æ•…éšœæœåŠ¡å™¨
- âœ… **å¯ç”¨keepalive**ï¼šæé«˜è¿æ¥å¤ç”¨æ•ˆç‡

**âš ï¸ å¸¸è§é…ç½®è¯¯åŒº**
- âŒ **weightè®¾ç½®è¿‡å¤§å·®å¼‚**ï¼šå¯èƒ½å¯¼è‡´è´Ÿè½½ä¸å‡
- âŒ **max_failsè®¾ç½®è¿‡å°**ï¼šå¯èƒ½é¢‘ç¹è¸¢å‡ºæ­£å¸¸æœåŠ¡å™¨
- âŒ **fail_timeoutè¿‡çŸ­**ï¼šæ•…éšœæœåŠ¡å™¨é¢‘ç¹é‡è¯•
- âŒ **ä¸é…ç½®backup**ï¼šæ‰€æœ‰æœåŠ¡å™¨æ•…éšœæ—¶æ— å¤‡é€‰æ–¹æ¡ˆ

### 7.4 æ•…éšœæ’æŸ¥æ–¹æ³•


**ğŸ” å¸¸è§é—®é¢˜è¯Šæ–­**
```
é—®é¢˜1: æŸå°æœåŠ¡å™¨æ”¶ä¸åˆ°è¯·æ±‚
â†’ æ£€æŸ¥weightè®¾ç½®æ˜¯å¦ä¸º0
â†’ æ£€æŸ¥æ˜¯å¦æ ‡è®°ä¸ºdown
â†’ æ£€æŸ¥æ˜¯å¦è¾¾åˆ°max_failsè¢«è¸¢å‡º

é—®é¢˜2: è´Ÿè½½ä¸å‡è¡¡
â†’ æ£€æŸ¥å„æœåŠ¡å™¨weighté…ç½®
â†’ æ£€æŸ¥è´Ÿè½½å‡è¡¡ç®—æ³•æ˜¯å¦åˆé€‚
â†’ ç›‘æ§å„æœåŠ¡å™¨å®é™…è¿æ¥æ•°

é—®é¢˜3: ç”¨æˆ·ä¼šè¯ä¸¢å¤±  
â†’ æ£€æŸ¥æ˜¯å¦éœ€è¦ä½¿ç”¨ip_hash
â†’ è€ƒè™‘ä½¿ç”¨å…±äº«ä¼šè¯å­˜å‚¨
â†’ æ£€æŸ¥å¤‡ç”¨æœåŠ¡å™¨é…ç½®
```

**ğŸ“Š ç›‘æ§å»ºè®®**
- ğŸ“ˆ **ç›‘æ§å„æœåŠ¡å™¨è¯·æ±‚åˆ†å¸ƒ**ï¼šç¡®ä¿è´Ÿè½½å‡è¡¡æ•ˆæœ
- ğŸ“ˆ **ç›‘æ§æœåŠ¡å™¨å“åº”æ—¶é—´**ï¼šåŠæ—¶å‘ç°æ€§èƒ½é—®é¢˜
- ğŸ“ˆ **ç›‘æ§æ•…éšœç‡**ï¼šä¼˜åŒ–max_failså’Œfail_timeoutå‚æ•°
- ğŸ“ˆ **ç›‘æ§è¿æ¥æ•°**ï¼šåˆç†è®¾ç½®keepaliveè¿æ¥æ± 

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- upstreamå®šä¹‰æœåŠ¡å™¨ç»„ï¼Œè´Ÿè½½å‡è¡¡ææ€§èƒ½
- weightæƒé‡æŒ‰æ€§èƒ½ï¼Œfailsè¶…æ—¶é˜²æ•…éšœ  
- ç®—æ³•é€‰æ‹©çœ‹éœ€æ±‚ï¼Œå¤‡ç”¨æœåŠ¡å™¨ä¿é«˜å¯ç”¨
- ç›‘æ§è°ƒä¼˜ä¸å¯å°‘ï¼Œç”Ÿäº§ç¯å¢ƒç¨³å¦‚å±±