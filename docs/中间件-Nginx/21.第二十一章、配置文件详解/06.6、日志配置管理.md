---
title: 6、日志配置管理
---
## 📚 目录

1. [Nginx日志系统概述](#1-Nginx日志系统概述)
2. [访问日志配置详解](#2-访问日志配置详解)
3. [日志格式定义深入](#3-日志格式定义深入)
4. [错误日志设置管理](#4-错误日志设置管理)
5. [日志性能优化配置](#5-日志性能优化配置)
6. [条件日志记录策略](#6-条件日志记录策略)
7. [日志文件管理实践](#7-日志文件管理实践)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🌐 Nginx日志系统概述


### 1.1 日志系统的作用


**什么是Nginx日志？**
简单来说，日志就像是Nginx的"记事本"，它会详细记录：
- 谁访问了你的网站
- 访问了什么页面
- 什么时候访问的
- 访问是否成功
- 如果有错误，错误是什么

```
比如你开了一家店铺：
访问日志 = 客户进店记录本
错误日志 = 店铺问题记录本

访问日志记录：张三 10:30 买了苹果 成功
错误日志记录：11:45 冰箱坏了 温度过高
```

### 1.2 Nginx日志的两大类型


**🔸 访问日志（Access Log）**
记录每一个访问请求的详细信息

**🔸 错误日志（Error Log）**  
记录Nginx运行过程中的错误和异常情况

```
日志类型对比：

访问日志                     错误日志
├─ 记录正常访问             ├─ 记录异常情况
├─ 文件通常很大             ├─ 文件相对较小
├─ 用于分析用户行为         ├─ 用于故障排查
└─ 可以关闭不记录           └─ 建议始终开启
```

### 1.3 日志系统的重要价值


**💡 实际应用价值**
- **用户行为分析**：了解网站访问模式
- **性能监控**：发现响应慢的页面
- **安全防护**：识别恶意攻击行为
- **故障排查**：快速定位问题根源
- **业务决策**：基于数据做网站优化

---

## 2. 📊 访问日志配置详解


### 2.1 access_log基本语法


**核心配置指令**
```nginx
access_log path [format [buffer=size] [gzip[=level]] [flush=time] [if=condition]];
```

**通俗理解**：
- `path`：日志文件存放的位置
- `format`：日志内容的格式（用什么样式记录）
- `buffer`：缓冲区大小（先攒一批再写入磁盘）
- `gzip`：是否压缩日志文件
- `flush`：多长时间强制写入一次
- `if`：什么条件下才记录日志

### 2.2 基础配置示例


**最简单的配置**
```nginx
server {
    listen 80;
    server_name example.com;
    
    # 最基本的访问日志配置
    access_log /var/log/nginx/access.log;
    
    location / {
        root /var/www/html;
    }
}
```

**详细配置示例**
```nginx
http {
    # 在http块中定义，影响所有虚拟主机
    access_log /var/log/nginx/access.log combined;
    
    server {
        listen 80;
        server_name example.com;
        
        # 在server块中定义，只影响当前虚拟主机
        access_log /var/log/nginx/example.log combined;
        
        location /api/ {
            # 在location块中定义，只影响特定路径
            access_log /var/log/nginx/api.log combined;
            proxy_pass http://backend;
        }
    }
}
```

### 2.3 访问日志的配置层级


```
配置层级优先级（从高到低）：

location块配置
    ↓ 覆盖
server块配置  
    ↓ 覆盖
http块配置
    ↓ 覆盖
全局默认配置

实际应用：
可以为不同的路径设置不同的日志文件
比如API接口单独记录，静态文件单独记录
```

### 2.4 关闭访问日志


**什么时候需要关闭日志**
- 静态文件访问（图片、CSS、JS）
- 健康检查请求
- 内部系统调用

```nginx
server {
    listen 80;
    server_name example.com;
    
    # 静态资源不记录日志，减少磁盘IO
    location ~* \.(jpg|jpeg|png|gif|css|js)$ {
        access_log off;
        expires 7d;
    }
    
    # 健康检查不记录日志
    location /health {
        access_log off;
        return 200 "OK";
    }
    
    # 其他请求正常记录
    location / {
        access_log /var/log/nginx/access.log;
        root /var/www/html;
    }
}
```

---

## 3. 📝 日志格式定义深入


### 3.1 log_format指令详解


**基本语法**
```nginx
log_format name [escape=default|json|none] string ...;
```

**通俗解释**：
- `name`：给这个日志格式起个名字
- `escape`：特殊字符如何处理
- `string`：具体的日志格式内容

### 3.2 预定义日志格式


**Nginx内置格式**

| 格式名称 | **说明** | **适用场景** |
|---------|---------|-------------|
| `combined` | **详细格式，包含用户代理和引用页** | `生产环境推荐` |
| `common` | **基础格式，包含基本访问信息** | `简单应用场景` |
| `main` | **自定义格式，通常和combined类似** | `根据需要调整` |

**combined格式详解**
```nginx
log_format combined '$remote_addr - $remote_user [$time_local] '
                   '"$request" $status $body_bytes_sent '
                   '"$http_referer" "$http_user_agent"';
```

**实际日志示例**
```
192.168.1.100 - - [21/Sep/2025:14:30:15 +0800] "GET /index.html HTTP/1.1" 200 1024 "https://google.com" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
```

### 3.3 常用日志变量详解


**🔸 客户端信息变量**

| 变量名 | **含义** | **示例值** |
|-------|---------|-----------|
| `$remote_addr` | **客户端IP地址** | `192.168.1.100` |
| `$remote_user` | **认证用户名** | `john` 或 `-` |
| `$http_user_agent` | **浏览器信息** | `Mozilla/5.0 ...` |
| `$http_referer` | **来源页面** | `https://google.com` |

**🔸 请求信息变量**

| 变量名 | **含义** | **示例值** |
|-------|---------|-----------|
| `$request` | **完整请求行** | `GET /page.html HTTP/1.1` |
| `$request_method` | **请求方法** | `GET`, `POST`, `PUT` |
| `$request_uri` | **请求URI** | `/page.html?id=123` |
| `$args` | **查询参数** | `id=123&name=test` |

**🔸 响应信息变量**

| 变量名 | **含义** | **示例值** |
|-------|---------|-----------|
| `$status` | **HTTP状态码** | `200`, `404`, `500` |
| `$body_bytes_sent` | **发送字节数** | `1024` |
| `$request_time` | **请求处理时间** | `0.123` |
| `$upstream_response_time` | **后端响应时间** | `0.089` |

### 3.4 自定义日志格式示例


**性能监控格式**
```nginx
log_format performance '$time_local $remote_addr "$request" '
                      '$status $request_time $upstream_response_time '
                      '$body_bytes_sent "$http_user_agent"';

server {
    access_log /var/log/nginx/performance.log performance;
}
```

**API接口格式**
```nginx
log_format api_log '$time_local [$request_method] $request_uri '
                   'Status:$status Time:${request_time}s '
                   'Size:${body_bytes_sent}bytes IP:$remote_addr';

server {
    location /api/ {
        access_log /var/log/nginx/api.log api_log;
    }
}
```

**JSON格式日志**
```nginx
log_format json_log escape=json '{'
    '"timestamp": "$time_local", '
    '"client_ip": "$remote_addr", '
    '"method": "$request_method", '
    '"uri": "$request_uri", '
    '"status": $status, '
    '"response_time": $request_time, '
    '"user_agent": "$http_user_agent"'
'}';
```

### 3.5 日志格式选择指导


**🎯 格式选择建议**

```
小型网站：
└─ 使用 combined 格式
   └─ 信息全面，便于分析

大型网站：
├─ API接口：使用 JSON 格式
│  └─ 便于程序解析
├─ 静态资源：使用 简化格式
│  └─ 减少日志大小
└─ 主要页面：使用 performance 格式
   └─ 重点关注性能
```

---

## 4. ⚠️ 错误日志设置管理


### 4.1 error_log基本配置


**基本语法**
```nginx
error_log file [level];
```

**通俗解释**：
- `file`：错误日志文件位置
- `level`：记录什么级别的错误

### 4.2 错误日志级别详解


**错误级别从严重到轻微**

| 级别 | **说明** | **包含内容** | **使用场景** |
|-----|---------|-------------|-------------|
| `emerg` | **紧急情况** | `系统无法使用` | `系统崩溃` |
| `alert` | **立即处理** | `需要立即修复` | `严重错误` |
| `crit` | **临界错误** | `关键功能失效` | `关键服务异常` |
| `error` | **一般错误** | `常见错误情况` | `**生产环境推荐**` |
| `warn` | **警告信息** | `潜在问题` | `开发调试` |
| `notice` | **注意信息** | `正常但重要` | `详细监控` |
| `info` | **信息记录** | `一般信息` | `开发测试` |
| `debug` | **调试信息** | `详细调试` | `故障排查` |

**实际理解**：
```
就像医院的病情级别：
emerg = 生命危险，立即抢救
error = 需要治疗的疾病  ← 生产环境常用
warn  = 需要注意的症状
info  = 健康检查信息
debug = 详细体检报告
```

### 4.3 错误日志配置示例


**基础配置**
```nginx
# 全局错误日志配置
error_log /var/log/nginx/error.log error;

http {
    # HTTP块错误日志
    error_log /var/log/nginx/http_error.log warn;
    
    server {
        # 服务器块错误日志
        error_log /var/log/nginx/server_error.log error;
        
        location /debug/ {
            # 特定路径开启调试
            error_log /var/log/nginx/debug.log debug;
        }
    }
}
```

**分级日志配置**
```nginx
# 不同环境的配置建议

# 生产环境
error_log /var/log/nginx/error.log error;

# 测试环境  
error_log /var/log/nginx/error.log warn;

# 开发环境
error_log /var/log/nginx/error.log info;

# 调试模式
error_log /var/log/nginx/error.log debug;
```

### 4.4 错误日志实际示例


**典型错误日志内容**
```
2025/09/21 14:30:15 [error] 1234#0: *567 open() "/var/www/html/notfound.html" failed (2: No such file or directory), client: 192.168.1.100, server: example.com, request: "GET /notfound.html HTTP/1.1", host: "example.com"

2025/09/21 14:31:20 [warn] 1234#0: *568 upstream server temporarily disabled while connecting to upstream, client: 192.168.1.101, server: api.example.com, request: "POST /api/users HTTP/1.1", upstream: "http://127.0.0.1:8080/api/users", host: "api.example.com"
```

**日志内容解读**：
- **时间戳**：错误发生的时间
- **级别**：`[error]` 或 `[warn]` 等
- **进程ID**：`1234#0`
- **连接ID**：`*567`
- **错误描述**：具体的错误信息
- **客户端信息**：IP、请求内容等

---

## 5. ⚡ 日志性能优化配置


### 5.1 日志缓冲配置


**为什么需要缓冲？**
想象一下写日记：
- **不用缓冲**：每句话都立即写到纸上（频繁磁盘操作）
- **使用缓冲**：先在脑中积累几句，再一起写下来（减少磁盘操作）

**buffer参数详解**
```nginx
access_log /var/log/nginx/access.log combined buffer=64k;
```

**缓冲大小建议**

| 网站规模 | **缓冲大小** | **说明** |
|---------|-------------|---------|
| 小型网站 | `32k-64k` | **日常使用足够** |
| 中型网站 | `64k-128k` | **平衡性能和内存** |
| 大型网站 | `128k-256k` | **高并发优化** |

### 5.2 日志刷新配置


**flush参数的作用**
```nginx
access_log /var/log/nginx/access.log combined buffer=64k flush=5s;
```

**通俗理解**：
- 缓冲区像个水桶，`buffer=64k` 是桶的大小
- `flush=5s` 是说：每5秒钟，不管桶满没满，都倒一次水
- 这样确保日志不会积压太久

**刷新时间建议**

| 应用场景 | **刷新时间** | **原因** |
|---------|-------------|---------|
| 实时监控 | `1s-3s` | **快速发现问题** |
| 一般网站 | `5s-10s` | **性能和实时性平衡** |
| 日志分析 | `30s-60s` | **注重性能优化** |

### 5.3 日志压缩配置


**gzip压缩日志**
```nginx
access_log /var/log/nginx/access.log combined buffer=64k gzip=6;
```

**压缩级别选择**

| 级别 | **压缩比** | **CPU消耗** | **适用场景** |
|-----|-----------|-------------|-------------|
| `1-3` | **低** | **低** | **CPU敏感环境** |
| `4-6` | **中等** | **中等** | ****推荐使用**** |
| `7-9` | **高** | **高** | **存储空间紧张** |

### 5.4 性能优化综合配置


**高性能日志配置示例**
```nginx
http {
    # 定义高效的日志格式
    log_format optimized '$time_local $status $request_time '
                        '$remote_addr "$request" $body_bytes_sent';
    
    # 主访问日志：使用缓冲和压缩
    access_log /var/log/nginx/access.log optimized 
               buffer=128k flush=10s gzip=4;
    
    server {
        listen 80;
        server_name example.com;
        
        # 静态文件不记录日志
        location ~* \.(jpg|png|css|js)$ {
            access_log off;
            expires 30d;
        }
        
        # API接口详细日志
        location /api/ {
            access_log /var/log/nginx/api.log combined 
                       buffer=64k flush=5s;
            proxy_pass http://backend;
        }
        
        # 其他请求简化日志
        location / {
            access_log /var/log/nginx/main.log optimized 
                       buffer=128k flush=10s gzip=4;
            root /var/www/html;
        }
    }
}
```

---

## 6. 🎯 条件日志记录策略


### 6.1 if条件日志记录


**基本语法**
```nginx
access_log /var/log/nginx/access.log combined if=$condition;
```

**什么是条件日志？**
就像设置筛选器，只有满足特定条件的请求才会被记录到日志中。

### 6.2 常用条件变量


**状态码条件**
```nginx
# 只记录错误状态
map $status $loggable {
    ~^[23]  0;  # 2xx和3xx状态码不记录
    default 1;  # 其他状态码记录
}

access_log /var/log/nginx/error_only.log combined if=$loggable;
```

**请求类型条件**
```nginx
# 不记录静态文件请求
map $request_uri $not_static {
    ~*\.(gif|jpg|png|css|js|ico)$ 0;
    default 1;
}

access_log /var/log/nginx/dynamic.log combined if=$not_static;
```

### 6.3 实用条件日志示例


**排除健康检查**
```nginx
# 不记录健康检查请求
map $request_uri $health_check {
    ~^/health$ 0;
    ~^/status$ 0;
    ~^/ping$   0;
    default    1;
}

access_log /var/log/nginx/access.log combined if=$health_check;
```

**只记录慢请求**
```nginx
# 只记录响应时间超过1秒的请求
map $request_time $slow_request {
    ~^0\.      0;  # 小于1秒不记录
    default    1;  # 1秒以上记录
}

access_log /var/log/nginx/slow.log combined if=$slow_request;
```

**分离API和页面日志**
```nginx
# API请求单独记录
map $request_uri $is_api {
    ~^/api/  1;
    default  0;
}

# API日志
access_log /var/log/nginx/api.log combined if=$is_api;

# 非API日志  
access_log /var/log/nginx/web.log combined if=!$is_api;
```

### 6.4 复杂条件组合


**多条件判断**
```nginx
# 定义多个条件变量
map $status $is_error {
    ~^[45] 1;
    default 0;
}

map $request_time $is_slow {
    ~^[1-9] 1;
    default 0;
}

# 组合条件：错误或慢请求
map "$is_error:$is_slow" $need_attention {
    "1:0" 1;  # 错误但不慢
    "0:1" 1;  # 慢但无错误
    "1:1" 1;  # 又错误又慢
    default 0;
}

access_log /var/log/nginx/attention.log combined if=$need_attention;
```

---

## 7. 📁 日志文件管理实践


### 7.1 日志文件路径规划


**目录结构建议**
```
/var/log/nginx/
├── access/                    # 访问日志目录
│   ├── main.log              # 主站访问日志
│   ├── api.log               # API访问日志
│   └── static.log            # 静态资源日志
├── error/                     # 错误日志目录
│   ├── error.log             # 错误日志
│   ├── debug.log             # 调试日志
│   └── upstream.log          # 后端错误日志
└── archive/                   # 归档日志目录
    ├── 2025-09-20/           # 按日期归档
    └── 2025-09-21/
```

**路径变量使用**
```nginx
# 使用变量动态生成日志路径
log_format daily '$time_local $remote_addr "$request" $status';

server {
    # 按日期分割日志文件
    access_log /var/log/nginx/access-$year-$month-$day.log daily;
    
    # 按虚拟主机分割
    access_log /var/log/nginx/$server_name.log combined;
}
```

### 7.2 日志轮转配置


**什么是日志轮转？**
就像换新的记事本：
- 旧本子写满了，收起来存档
- 拿出新本子继续写
- 定期清理太旧的本子

**logrotate配置示例**
```bash
# /etc/logrotate.d/nginx
/var/log/nginx/*.log {
    daily                    # 每天轮转
    missingok               # 文件不存在不报错
    rotate 52               # 保留52个文件（一年）
    compress                # 压缩旧文件
    delaycompress          # 延迟压缩
    notifempty             # 空文件不轮转
    create 644 nginx nginx  # 创建新文件的权限
    postrotate             # 轮转后执行的命令
        if [ -f /var/run/nginx.pid ]; then
            kill -USR1 `cat /var/run/nginx.pid`
        fi
    endscript
}
```

### 7.3 日志监控与分析


**实时监控命令**
```bash
# 实时查看访问日志
tail -f /var/log/nginx/access.log

# 监控错误日志
tail -f /var/log/nginx/error.log | grep ERROR

# 统计状态码分布
awk '{print $9}' /var/log/nginx/access.log | sort | uniq -c | sort -nr

# 查看访问量最大的IP
awk '{print $1}' /var/log/nginx/access.log | sort | uniq -c | sort -nr | head -10
```

**日志分析工具推荐**

| 工具 | **类型** | **特点** | **适用场景** |
|-----|---------|---------|-------------|
| `GoAccess` | **实时分析** | `轻量级，实时显示` | **快速分析** |
| `AWStats` | **定期分析** | `详细报表` | **定期报告** |
| `ELK Stack` | **企业级** | `强大搜索分析` | **大型网站** |

### 7.4 日志安全与备份


**日志文件权限设置**
```bash
# 设置合适的文件权限
chmod 644 /var/log/nginx/*.log
chown nginx:nginx /var/log/nginx/*.log

# 防止日志文件被篡改
chattr +a /var/log/nginx/security.log  # 只允许追加
```

**备份策略建议**
```bash
# 每日备份重要日志
#!/bin/bash
DATE=$(date +%Y%m%d)
tar -czf /backup/nginx-logs-$DATE.tar.gz /var/log/nginx/
find /backup/ -name "nginx-logs-*.tar.gz" -mtime +30 -delete
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的基本概念


```
🔸 日志类型：访问日志记录请求，错误日志记录异常
🔸 配置层级：location > server > http，下级覆盖上级
🔸 日志格式：使用变量定义，combined格式最常用
🔸 性能优化：buffer缓冲、flush刷新、gzip压缩
🔸 条件记录：使用if参数，只记录需要的日志
🔸 文件管理：合理规划路径，定期轮转备份
```

### 8.2 关键理解要点


**🔹 日志配置的平衡艺术**
```
详细程度 vs 性能影响：
- 记录越详细，性能开销越大
- 生产环境要在有用性和性能间平衡

存储空间 vs 保留时间：
- 日志文件增长很快
- 需要合理的轮转和清理策略

实时性 vs 效率：
- 实时写入影响性能
- 缓冲可以提升性能但延迟写入
```

**🔹 错误日志级别的选择**
```
生产环境建议：
- 使用 error 级别
- 不要使用 debug 级别（日志太多）
- warn 级别适合监控潜在问题

调试阶段：
- 临时开启 debug 级别
- 调试完成后及时关闭
- 避免长期开启影响性能
```

### 8.3 实际应用指导


**🎯 新手配置建议**
```
第一步：基础配置
├─ 使用 combined 格式
├─ error 级别错误日志
└─ 静态文件关闭日志

第二步：性能优化
├─ 添加 buffer 参数
├─ 设置合理的 flush 时间
└─ 考虑使用 gzip 压缩

第三步：精细化管理
├─ 不同路径使用不同日志文件
├─ 条件日志过滤无用记录
└─ 建立日志轮转机制
```

**🔧 常见问题解决**
```
日志文件太大：
✅ 开启日志轮转
✅ 使用条件日志记录
✅ 静态文件关闭日志

磁盘IO过高：
✅ 增大buffer缓冲区
✅ 延长flush时间
✅ 考虑SSD存储

日志分析困难：
✅ 使用标准化格式
✅ 结构化日志（JSON）
✅ 使用专业分析工具
```

### 8.4 生产环境最佳实践


**⭐ 推荐配置模板**
```nginx
http {
    # 标准访问日志格式
    log_format main '$remote_addr - $remote_user [$time_local] '
                   '"$request" $status $body_bytes_sent '
                   '"$http_referer" "$http_user_agent" $request_time';
    
    # 错误日志
    error_log /var/log/nginx/error.log error;
    
    # 主访问日志（优化配置）
    access_log /var/log/nginx/access.log main 
               buffer=128k flush=10s gzip=4;
    
    server {
        # 静态资源不记录日志
        location ~* \.(css|js|jpg|png|gif|ico|woff|woff2)$ {
            access_log off;
            expires 30d;
        }
        
        # 健康检查不记录日志
        location = /health {
            access_log off;
            return 200 "OK";
        }
        
        # 其他请求正常记录
        location / {
            # 配置正常...
        }
    }
}
```

**核心记忆**：
- 日志是Nginx的记事本，记录访问和错误
- 访问日志看用户行为，错误日志查问题
- 合理配置格式和级别，平衡详细度和性能
- 使用缓冲和压缩优化性能，条件记录过滤噪音
- 建立轮转机制，定期清理，保持系统健康