---
title: 8、server虚拟主机配置
---
## 📚 目录

1. [server配置块的本质理解](#1-server配置块的本质理解)
2. [listen端口监听详解](#2-listen端口监听详解)
3. [server_name域名绑定机制](#3-server_name域名绑定机制)
4. [网站根目录与首页配置](#4-网站根目录与首页配置)
5. [server_name匹配优先级规则](#5-server_name匹配优先级规则)
6. [default_server默认服务器配置](#6-default_server默认服务器配置)
7. [多域名配置实战](#7-多域名配置实战)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🏠 server配置块的本质理解


### 1.1 什么是server配置块


**通俗理解**：把 server 配置块想象成一个"虚拟房子"

```
现实生活类比：
一个大楼（Nginx服务器）里面可以有很多房间（server块）
每个房间有自己的门牌号（端口）和房间名（域名）
不同的访客（用户请求）根据门牌号和房间名找到对应的房间

Nginx中：
一个Nginx服务器可以承载多个网站
每个网站就是一个server配置块
用户通过域名和端口访问不同的网站
```

**server配置块的作用**：
- 🎯 **网站隔离**：每个 server 块代表一个独立的网站
- 🎯 **请求分发**：根据域名和端口将请求分配到对应网站
- 🎯 **配置独立**：每个网站可以有自己的配置规则

### 1.2 server配置块的基本结构


```nginx
# 这是一个完整的server配置块示例
server {
    # 监听端口
    listen 80;
    
    # 绑定域名
    server_name www.example.com;
    
    # 网站根目录
    root /var/www/example;
    
    # 默认首页
    index index.html index.htm;
    
    # 其他配置...
}
```

**结构说明**：
- `server { }` 包围起来的就是一个完整的虚拟主机
- 大括号内的每一行都是具体的配置指令
- 每个配置指令都以分号 `;` 结尾

---

## 2. 🔌 listen端口监听详解


### 2.1 listen指令的含义


**通俗解释**：listen 就像是给你的网站安装一个"门铃"

```
生活比喻：
你家的门铃响了，你知道有客人来访
门铃的按钮就相当于端口号
客人按80号按钮，就是要访问网站
客人按443号按钮，就是要访问HTTPS网站

技术含义：
listen 80    # 监听80端口，处理HTTP请求
listen 443   # 监听443端口，处理HTTPS请求
```

### 2.2 listen的基本用法


**基础监听配置**：

```nginx
# 最简单的端口监听
server {
    listen 80;                    # 监听80端口
    server_name example.com;
}

# 指定IP地址和端口
server {
    listen 192.168.1.100:80;     # 只监听特定IP的80端口
    server_name example.com;
}

# 监听所有IP的特定端口
server {
    listen 0.0.0.0:8080;         # 监听所有IP的8080端口
    server_name example.com;
}
```

### 2.3 常用端口说明


| 端口号 | **用途** | **说明** |
|--------|----------|----------|
| `80` | **HTTP网站** | `浏览器默认端口，可以省略不写` |
| `443` | **HTTPS网站** | `加密网站的标准端口` |
| `8080` | **测试网站** | `开发测试时常用的端口` |
| `3000` | **开发环境** | `前端开发服务器常用端口` |

**端口选择原则**：
- ✅ **80端口**：正式网站首选，用户访问时不需要加端口号
- ✅ **443端口**：HTTPS网站必须，确保数据传输安全
- ✅ **自定义端口**：测试环境或避免端口冲突时使用

---

## 3. 🏷️ server_name域名绑定机制


### 3.1 server_name的作用原理


**形象比喻**：server_name 就像是你家的门牌号

```
现实类比：
邮递员送信时看门牌号找到你家
www.example.com 就是网站的"门牌号"
当用户输入这个域名时，Nginx就知道要访问哪个网站

技术原理：
用户在浏览器输入域名 → DNS解析获得服务器IP → 
请求发送到服务器 → Nginx根据server_name匹配对应的server块
```

### 3.2 server_name的配置方式


**精确匹配**：
```nginx
server {
    listen 80;
    server_name www.example.com;    # 只匹配 www.example.com
}
```

**通配符匹配**：
```nginx
server {
    listen 80;
    server_name *.example.com;      # 匹配所有 example.com 的子域名
    # 可以匹配：www.example.com, blog.example.com, api.example.com
}

server {
    listen 80;
    server_name example.*;          # 匹配 example 开头的所有域名
    # 可以匹配：example.com, example.net, example.org
}
```

**多域名绑定**：
```nginx
server {
    listen 80;
    server_name example.com www.example.com blog.example.com;
    # 这三个域名都会访问同一个网站
}
```

### 3.3 域名配置实际应用


**企业网站常见配置**：
```nginx
# 主网站配置
server {
    listen 80;
    server_name example.com www.example.com;
    root /var/www/main;
    index index.html;
}

# 博客子站配置
server {
    listen 80;
    server_name blog.example.com;
    root /var/www/blog;
    index index.html;
}

# API接口服务
server {
    listen 80;
    server_name api.example.com;
    root /var/www/api;
    index index.html;
}
```

---

## 4. 📁 网站根目录与首页配置


### 4.1 root指令详解


**通俗理解**：root 就是告诉 Nginx "你的网站文件放在哪个文件夹里"

```
生活比喻：
你告诉朋友你的照片放在 /家里/相册/旅游照片/ 这个位置
root 就是告诉 Nginx 网站文件放在 /var/www/example/ 这个位置

技术含义：
root /var/www/example;
当用户访问 www.example.com/about.html 时
Nginx 会去 /var/www/example/about.html 这个文件路径查找文件
```

### 4.2 root配置示例


```nginx
server {
    listen 80;
    server_name www.example.com;
    root /var/www/example;           # 网站根目录
    
    # 用户访问路径与实际文件路径的对应关系：
    # 访问 www.example.com/         → /var/www/example/index.html
    # 访问 www.example.com/about/   → /var/www/example/about/index.html
    # 访问 www.example.com/css/style.css → /var/www/example/css/style.css
}
```

### 4.3 index指令详解


**index的作用**：当用户访问目录时，自动寻找指定的首页文件

```nginx
server {
    listen 80;
    server_name www.example.com;
    root /var/www/example;
    index index.html index.htm index.php;    # 按顺序查找首页文件
}
```

**查找顺序说明**：
```
用户访问：www.example.com/
Nginx查找顺序：
1. 先找 /var/www/example/index.html
2. 如果没有，再找 /var/www/example/index.htm  
3. 如果还没有，最后找 /var/www/example/index.php
4. 都没有的话，显示目录列表或404错误
```

### 4.4 常见的目录结构


```
典型网站目录结构：
/var/www/example/
├── index.html          # 首页文件
├── about.html          # 关于页面
├── css/
│   └── style.css       # 样式文件
├── js/
│   └── main.js         # JavaScript文件
├── images/
│   ├── logo.png        # 图片文件
│   └── banner.jpg
└── contact/
    └── index.html      # 联系页面
```

---

## 5. 🎯 server_name匹配优先级规则


### 5.1 匹配优先级排序


**Nginx 匹配域名的优先级**（从高到低）：

```
1. 精确匹配      www.example.com
2. 左侧通配符    *.example.com  
3. 右侧通配符    www.example.*
4. 正则表达式    ~^www\.(.+)\.com$
5. default_server 默认服务器
```

### 5.2 优先级实例演示


**配置示例**：
```nginx
# 配置1：精确匹配（优先级最高）
server {
    listen 80;
    server_name www.example.com;
    root /var/www/exact;
    return 200 "精确匹配";
}

# 配置2：左侧通配符匹配
server {
    listen 80;
    server_name *.example.com;
    root /var/www/wildcard;
    return 200 "通配符匹配";
}

# 配置3：默认服务器
server {
    listen 80 default_server;
    server_name _;
    root /var/www/default;
    return 200 "默认服务器";
}
```

**访问结果**：
```
访问 www.example.com      → 返回"精确匹配"（优先级1）
访问 blog.example.com     → 返回"通配符匹配"（优先级2）
访问 other-site.com       → 返回"默认服务器"（优先级5）
```

### 5.3 匹配规则最佳实践


> 💡 **配置建议**  
> 为了避免混淆，建议按以下原则配置：
> - 主要域名使用精确匹配
> - 子域名统一使用通配符匹配  
> - 设置一个默认服务器处理未匹配的请求

**推荐配置模式**：
```nginx
# 主站 - 精确匹配
server {
    listen 80;
    server_name example.com www.example.com;
    root /var/www/main;
}

# 子站 - 通配符匹配
server {
    listen 80;
    server_name *.example.com;
    root /var/www/subdomains;
}

# 默认 - 处理其他所有请求
server {
    listen 80 default_server;
    server_name _;
    return 444;  # 直接关闭连接
}
```

---

## 6. 🛡️ default_server默认服务器配置


### 6.1 default_server的作用


**形象比喻**：default_server 就像是一个"兜底的门卫"

```
现实比喻：
当有人来找一个不存在的住户时
门卫会统一处理这些"找不到目标"的访客

技术含义：
当用户访问的域名在所有server_name中都找不到匹配时
Nginx会使用标记为default_server的server块来处理请求
```

### 6.2 default_server基本配置


```nginx
server {
    listen 80 default_server;        # 在listen后面加上default_server
    listen [::]:80 default_server;   # IPv6的默认服务器
    server_name _;                   # 下划线表示匹配任何域名
    
    # 常见的默认处理方式
    return 444;                      # 直接关闭连接
    # 或者
    return 301 https://www.example.com$request_uri;  # 重定向到主站
}
```

### 6.3 default_server的应用场景


**安全防护**：
```nginx
# 拒绝恶意域名访问
server {
    listen 80 default_server;
    server_name _;
    return 444;                      # 不返回任何内容，直接断开连接
}
```

**域名重定向**：
```nginx
# 将所有未知域名重定向到主站
server {
    listen 80 default_server;
    server_name _;
    return 301 https://www.example.com$request_uri;
}
```

**显示维护页面**：
```nginx
# 显示统一的维护页面
server {
    listen 80 default_server;
    server_name _;
    root /var/www/maintenance;
    index maintenance.html;
}
```

### 6.4 default_server注意事项


> ⚠️ **重要提醒**  
> 每个 listen 端口只能有一个 default_server
> 如果不指定，Nginx会自动将第一个server块作为默认服务器

**错误示例**：
```nginx
# ❌ 错误：同一端口有多个default_server
server {
    listen 80 default_server;
    server_name site1.com;
}

server {
    listen 80 default_server;    # 这会导致配置错误
    server_name site2.com;
}
```

**正确示例**：
```nginx
# ✅ 正确：每个端口只有一个default_server
server {
    listen 80 default_server;
    server_name _;
}

server {
    listen 80;
    server_name site1.com;
}

server {
    listen 80;
    server_name site2.com;
}
```

---

## 7. 🌐 多域名配置实战


### 7.1 企业级多站点架构


**典型企业需求**：
```
主网站：    www.company.com
企业邮箱：  mail.company.com  
客户支持：  support.company.com
API接口：   api.company.com
测试环境：  test.company.com
```

### 7.2 完整的多域名配置


```nginx
# 主网站配置
server {
    listen 80;
    listen 443 ssl;
    server_name company.com www.company.com;
    root /var/www/main;
    index index.html index.php;
    
    # SSL证书配置（如果启用HTTPS）
    ssl_certificate /etc/ssl/certs/company.crt;
    ssl_certificate_key /etc/ssl/private/company.key;
}

# 邮箱系统
server {
    listen 80;
    server_name mail.company.com;
    
    # 重定向到邮箱系统
    return 301 https://mail.company.com$request_uri;
}

# 客户支持系统
server {
    listen 80;
    server_name support.company.com;
    root /var/www/support;
    index index.html;
    
    # 支持系统的特殊配置
    location /api/ {
        proxy_pass http://support-backend;
    }
}

# API接口服务
server {
    listen 80;
    server_name api.company.com;
    
    # 所有请求转发给后端API服务器
    location / {
        proxy_pass http://api-backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}

# 测试环境（仅内网访问）
server {
    listen 80;
    server_name test.company.com;
    root /var/www/test;
    
    # 限制访问IP
    allow 192.168.1.0/24;
    deny all;
}

# 默认服务器（安全处理）
server {
    listen 80 default_server;
    server_name _;
    return 444;  # 拒绝未知域名访问
}
```

### 7.3 开发环境的多项目配置


**本地开发常见需求**：
```nginx
# 项目A
server {
    listen 80;
    server_name project-a.local;
    root /home/developer/project-a/public;
    index index.html index.php;
}

# 项目B  
server {
    listen 80;
    server_name project-b.local;
    root /home/developer/project-b/dist;
    index index.html;
}

# Vue.js开发服务器代理
server {
    listen 80;
    server_name vue-app.local;
    
    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
    }
}
```

### 7.4 域名配置的管理技巧


**文件组织结构**：
```
/etc/nginx/
├── nginx.conf              # 主配置文件
├── sites-available/        # 可用站点配置
│   ├── main-site.conf
│   ├── api-site.conf
│   └── support-site.conf
└── sites-enabled/          # 启用站点配置（软链接）
    ├── main-site.conf -> ../sites-available/main-site.conf
    └── api-site.conf -> ../sites-available/api-site.conf
```

**管理命令**：
```bash
# 启用站点
sudo ln -s /etc/nginx/sites-available/new-site.conf /etc/nginx/sites-enabled/

# 禁用站点  
sudo rm /etc/nginx/sites-enabled/old-site.conf

# 测试配置
sudo nginx -t

# 重新加载配置
sudo nginx -s reload
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心概念


```
🔸 server配置块：每个块代表一个独立的虚拟主机网站
🔸 listen指令：指定监听的端口，决定网站的访问入口
🔸 server_name：绑定域名，决定哪些域名访问这个网站
🔸 root指令：设置网站文件的根目录位置
🔸 index指令：设置默认首页文件名
🔸 匹配优先级：精确匹配 > 通配符匹配 > 默认服务器
🔸 default_server：处理所有未匹配域名的默认服务器
```

### 8.2 关键理解要点


**🔹 虚拟主机的本质**
```
理解要点：
- 一台服务器托管多个网站
- 每个网站有独立的配置和文件目录
- 通过域名和端口区分不同网站
- 实现资源的有效利用和管理
```

**🔹 域名匹配的逻辑**
```
匹配流程：
1. 用户输入域名访问网站
2. DNS解析域名获得服务器IP
3. 请求发送到Nginx服务器
4. Nginx根据server_name匹配对应的server块
5. 使用匹配到的配置处理用户请求
```

**🔹 配置的优先级原则**
```
设计原则：
- 精确匹配优先级最高，避免误匹配
- 通配符提供灵活性，管理子域名
- 默认服务器兜底，处理异常情况
- 合理的优先级确保请求正确分发
```

### 8.3 实际应用指导


**配置最佳实践**：
- ✅ **主域名使用精确匹配**：确保主站访问稳定
- ✅ **子域名使用通配符**：便于扩展和管理
- ✅ **设置默认服务器**：提高安全性
- ✅ **合理组织配置文件**：便于维护和管理

**常见错误避免**：
- ❌ **忘记设置root目录**：导致404错误
- ❌ **端口冲突**：多个程序使用同一端口
- ❌ **域名拼写错误**：导致网站无法访问
- ❌ **权限问题**：Nginx无法读取网站文件

**新手学习路径**：
1. 🎯 **先理解概念**：明白虚拟主机的作用
2. 🎯 **练习基本配置**：配置一个简单的网站
3. 🎯 **掌握域名绑定**：理解server_name的用法
4. 🎯 **学习多站点配置**：管理多个网站
5. 🎯 **优化安全配置**：设置默认服务器

**实用配置模板**：
```nginx
# 基础网站配置模板
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;
    root /var/www/your-site;
    index index.html index.htm;
    
    # 错误页面
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;
    
    # 日志文件
    access_log /var/log/nginx/your-site.access.log;
    error_log /var/log/nginx/your-site.error.log;
}
```

**核心记忆口诀**：
- server块定义虚拟主机，一块一站很清晰
- listen设置监听端口，80和443要记住  
- server_name绑定域名，精确匹配优先级
- root指向网站目录，index设置首页名