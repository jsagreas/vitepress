---
title: 2、nginx.conf配置参数详解
---
## 📚 目录

1. [Nginx配置文件概述](#1-nginx配置文件概述)
2. [全局配置参数](#2-全局配置参数)
3. [事件驱动配置](#3-事件驱动配置)
4. [HTTP核心配置](#4-http核心配置)
5. [服务器虚拟主机配置](#5-服务器虚拟主机配置)
6. [反向代理与负载均衡](#6-反向代理与负载均衡)
7. [SSL安全配置](#7-ssl安全配置)
8. [访问控制与限制](#8-访问控制与限制)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🔧 Nginx配置文件概述


### 1.1 配置文件是什么

想象一下，Nginx就像一个多才多艺的服务员，而配置文件就是给这个服务员的**详细工作手册**。这个手册告诉服务员：
- 🏠 应该在哪个地址工作（监听端口）
- 👥 能同时服务多少客户（连接数）
- 📂 客户要的文件放在哪里（网站目录）
- 🔄 遇到问题怎么处理（错误页面）

### 1.2 配置文件结构

Nginx配置文件采用**分层嵌套**的结构，就像俄罗斯套娃一样：

```
nginx.conf文件结构：
┌─────────────────────┐
│    全局配置         │ ← 影响整个Nginx服务
├─────────────────────┤
│    events { }       │ ← 控制连接处理方式
├─────────────────────┤
│    http {           │ ← HTTP相关设置
│      server {       │   ← 虚拟主机配置
│        location { } │     ← 路径匹配规则
│      }              │
│    }                │
└─────────────────────┘
```

### 1.3 配置文件位置

通常配置文件位于：
- **CentOS/RHEL**: `/etc/nginx/nginx.conf`
- **Ubuntu/Debian**: `/etc/nginx/nginx.conf`
- **编译安装**: `/usr/local/nginx/conf/nginx.conf`

---

## 2. ⚙️ 全局配置参数


### 2.1 用户与进程管理


#### 👤 运行用户设置 (user)

**作用**: 指定Nginx工作进程以什么身份运行

```nginx
user nginx nginx;
```

**通俗解释**: 就像给服务员发工牌，告诉系统"这个服务员叫nginx，属于nginx组"。这样做是为了**安全**，不让Nginx用root权限运行，避免被黑客利用。

**常见配置**:
- `user nginx;` - 使用nginx用户，自动匹配同名组
- `user www-data;` - Ubuntu系统常用
- `user nobody;` - 最小权限用户

#### 🔢 工作进程数量 (worker_processes)

**作用**: 决定Nginx开启几个工作进程来处理请求

```nginx
worker_processes auto;        # 自动检测CPU核心数
worker_processes 4;           # 手动指定4个进程
```

**通俗解释**: 就像餐厅决定雇佣几个服务员。CPU有几个核心，通常就开几个进程，这样能**充分利用**服务器性能。

**选择建议**:
- 🟢 **推荐**: `auto` - 让Nginx自己决定
- 🟡 **手动**: CPU核心数 = 进程数
- 🔴 **避免**: 进程数远超CPU核心数

#### ⚡ CPU绑定 (worker_cpu_affinity)

**作用**: 将每个工作进程绑定到特定的CPU核心

```nginx
worker_cpu_affinity 0001 0010 0100 1000;  # 4核CPU绑定
```

**通俗解释**: 就像给每个服务员分配固定的工作区域，避免他们相互干扰，提高工作效率。

**CPU绑定示例**:
```
2核CPU: worker_cpu_affinity 01 10;
4核CPU: worker_cpu_affinity 0001 0010 0100 1000;
8核CPU: worker_cpu_affinity 00000001 00000010 00000100...
```

#### 📁 文件描述符限制 (worker_rlimit_nofile)

**作用**: 设置单个工作进程能打开的最大文件数

```nginx
worker_rlimit_nofile 65535;
```

**通俗解释**: 就像规定每个服务员最多能同时拿几个盘子。文件描述符就是系统的"盘子"，用完了就无法处理新请求。

### 2.2 进程管理参数


#### 📊 进程优先级 (worker_priority)

**作用**: 设置工作进程的系统优先级

```nginx
worker_priority -5;  # 范围: -20(最高) 到 20(最低)
```

**通俗解释**: 告诉操作系统"Nginx很重要，请优先处理它的任务"，就像VIP客户优先服务。

#### ⏰ 优雅关闭超时 (worker_shutdown_timeout)

**作用**: 工作进程关闭时的最大等待时间

```nginx
worker_shutdown_timeout 10s;
```

**通俗解释**: 就像告诉服务员"收工时给你10秒钟处理完手头的客户，然后必须下班"。

#### 📝 进程ID文件 (pid)

**作用**: 指定存储主进程ID的文件位置

```nginx
pid /var/run/nginx.pid;
```

**通俗解释**: 就像给餐厅经理一个名牌，系统通过这个文件知道谁是Nginx的"大管家"。

### 2.3 日志与调试


#### 📋 错误日志 (error_log)

**作用**: 设置错误日志的位置和详细程度

```nginx
error_log /var/log/nginx/error.log warn;
```

**日志级别对比**:
| 级别 | 用途 | 信息量 | 适用场景 |
|------|------|--------|----------|
| `debug` | 调试信息 | 极详细 | 🔧 开发调试 |
| `info` | 一般信息 | 详细 | 📊 信息记录 |
| `notice` | 重要通知 | 中等 | 📢 重要事件 |
| `warn` | 警告信息 | 适中 | ⚠️ **生产推荐** |
| `error` | 错误信息 | 简洁 | 🚫 仅记录错误 |
| `crit` | 严重错误 | 最少 | 💥 关键问题 |

#### 🔄 守护进程模式 (daemon)

**作用**: 控制Nginx是否在后台运行

```nginx
daemon on;   # 默认值，后台运行
daemon off;  # 前台运行，用于容器环境
```

**通俗解释**: `on`就像让服务员在后台默默工作，`off`就像让服务员在你眼前工作，方便观察。

---

## 3. 🚀 事件驱动配置


### 3.1 events块作用

`events`块专门控制Nginx如何处理网络连接，就像设置餐厅的**接待规则**。

```nginx
events {
    worker_connections 1024;
    use epoll;
    multi_accept on;
}
```

### 3.2 连接数配置


#### 🔗 单进程最大连接数 (worker_connections)

**作用**: 每个工作进程最多能同时处理多少个连接

```nginx
worker_connections 1024;  # 常见值: 1024, 2048, 4096
```

**计算总连接数**:
```
最大并发连接数 = worker_processes × worker_connections
例如: 4个进程 × 1024连接 = 4096个并发连接
```

**通俗解释**: 就像规定每个服务员最多能同时照顾几桌客人。

### 3.3 事件驱动模型


#### ⚡ 事件模型选择 (use)

**作用**: 选择底层的网络事件处理机制

```nginx
use epoll;     # Linux推荐
use kqueue;    # FreeBSD/macOS
use select;    # 兼容性最好但性能差
```

**性能对比**:
```
性能排序: epoll > kqueue > select
并发能力: epoll(万级) > select(千级)
```

**通俗解释**: 就像选择接待客人的方式：
- `epoll`: 智能的"呼叫器"系统，客人需要服务时主动通知
- `select`: 服务员要不停巡视每桌客人，效率低

#### 📬 批量接受连接 (multi_accept)

**作用**: 是否一次性接受多个新连接

```nginx
multi_accept on;   # 推荐开启
multi_accept off;  # 默认值
```

**通俗解释**: `on`就像服务员一次迎接多位客人，`off`就像一次只迎接一位客人。显然批量处理更高效。

#### 🔒 接受连接互斥锁 (accept_mutex)

**作用**: 控制多个进程争抢新连接的方式

```nginx
accept_mutex off;  # 新版本推荐关闭
accept_mutex on;   # 旧版本默认开启
```

**通俗解释**: 就像决定多个服务员是"排队接客"还是"自由竞争接客"。现在网络性能好了，自由竞争反而更快。

---

## 4. 🌐 HTTP核心配置


### 4.1 HTTP块概述

`http`块是Nginx的核心配置区域，控制所有HTTP相关的功能，就像餐厅的**服务标准手册**。

### 4.2 文件传输优化


#### 📁 高效文件传输 (sendfile)

**作用**: 启用操作系统级别的文件传输优化

```nginx
sendfile on;
```

**工作原理对比**:
```
传统方式: 磁盘 → 内核缓冲区 → 用户缓冲区 → 网络
sendfile: 磁盘 → 内核缓冲区 → 网络 (跳过用户空间)
```

**通俗解释**: 就像快递员直接从仓库发货给客户，不用经过中转站，速度更快。

#### 📦 TCP数据包优化 (tcp_nopush & tcp_nodelay)

**作用**: 优化网络数据包的发送策略

```nginx
tcp_nopush on;     # 批量发送数据包
tcp_nodelay on;    # 立即发送小数据包
```

**使用场景**:
- `tcp_nopush`: 适合传输大文件，减少数据包数量
- `tcp_nodelay`: 适合实时通信，减少延迟

**通俗解释**: 
- `tcp_nopush`: 像快递员装满一车再发货
- `tcp_nodelay`: 像外卖员来一单就送一单

### 4.3 连接管理


#### ⏰ 长连接超时 (keepalive_timeout)

**作用**: 客户端连接保持多长时间不关闭

```nginx
keepalive_timeout 65s;  # 65秒后自动关闭连接
```

**通俗解释**: 就像客人吃完饭后，桌子保留多久不收拾。时间太短频繁建连接影响性能，太长占用资源。

#### 📊 单连接请求数限制 (keepalive_requests)

**作用**: 单个长连接最多处理多少个请求

```nginx
keepalive_requests 100;
```

**通俗解释**: 就像规定一桌客人最多点100道菜，然后必须换桌。防止单个连接占用过久。

### 4.4 缓冲区配置


#### 📋 客户端请求缓冲区设置

**作用**: 控制接收客户端数据的缓冲区大小

```nginx
client_max_body_size 10m;              # 最大请求体10MB
client_body_buffer_size 128k;          # 请求体缓冲区128KB
client_header_buffer_size 1k;          # 请求头缓冲区1KB
large_client_header_buffers 4 4k;      # 大请求头缓冲区：4个4KB
```

**参数解释**:
| 参数 | 作用 | 建议值 | 影响 |
|------|------|--------|------|
| `client_max_body_size` | 上传文件大小限制 | `10m` | 🔺 太小无法上传大文件 |
| `client_body_buffer_size` | 请求体缓冲区 | `128k` | 🔺 太小频繁写磁盘 |
| `client_header_buffer_size` | 普通请求头缓冲 | `1k` | 🔺 太小无法处理请求 |
| `large_client_header_buffers` | 大请求头缓冲 | `4 4k` | 🔺 太小无法处理复杂请求 |

### 4.5 超时配置


#### ⏱️ 各类超时时间设置

**作用**: 防止慢客户端占用服务器资源

```nginx
client_header_timeout 60s;    # 读取请求头超时
client_body_timeout 60s;      # 读取请求体超时  
send_timeout 60s;             # 发送响应超时
```

**超时时间建议**:
```
快速网络环境: 30-60秒
慢速网络环境: 60-120秒
文件上传场景: 根据文件大小调整
```

**通俗解释**: 就像给客人点菜、上菜、结账设置时间限制，防止客人拖拖拉拉影响其他客人。

### 4.6 安全配置


#### 🔒 隐藏服务器信息 (server_tokens)

**作用**: 控制是否显示Nginx版本信息

```nginx
server_tokens off;  # 隐藏版本信息，推荐
server_tokens on;   # 显示完整版本信息
server_tokens build; # 显示版本和构建信息
```

**安全对比**:
```
开启时: Server: nginx/1.20.2
关闭时: Server: nginx
```

**通俗解释**: 就像店员是否告诉客人"我们用的是xx牌收银机"，不说避免暴露系统细节给坏人。

---

## 5. 🖥️ 服务器虚拟主机配置


### 5.1 server块作用

`server`块定义虚拟主机，就像在一栋楼里开设多个**不同风格的餐厅**。

### 5.2 基础服务器配置


#### 🔌 端口监听 (listen)

**作用**: 指定服务器监听的端口和协议

```nginx
listen 80;                    # 监听80端口
listen 443 ssl;              # 监听443端口，启用SSL
listen 80 default_server;    # 默认服务器
listen [::]:80 ipv6only=on;  # IPv6监听
```

**端口用途说明**:
| 端口 | 协议 | 用途 | 说明 |
|------|------|------|------|
| `80` | HTTP | 普通网站 | 🌐 最常用的Web端口 |
| `443` | HTTPS | 加密网站 | 🔒 安全连接必需 |
| `8080` | HTTP | 备用端口 | 🔧 开发测试常用 |
| `8443` | HTTPS | 备用SSL端口 | 🔧 管理界面常用 |

#### 🏷️ 域名绑定 (server_name)

**作用**: 指定这个虚拟主机对应的域名

```nginx
server_name example.com;                    # 单个域名
server_name example.com www.example.com;    # 多个域名
server_name *.example.com;                  # 通配符域名
server_name ~^(\w+)\.example\.com$;         # 正则表达式域名
```

**域名匹配优先级**:
```
1. 精确匹配: server_name example.com;
2. 通配符前缀: server_name *.example.com;
3. 通配符后缀: server_name example.*;
4. 正则表达式: server_name ~^(.+)\.example\.com$;
5. 默认服务器: listen 80 default_server;
```

### 5.3 文件路径配置


#### 📂 网站根目录 (root)

**作用**: 设置网站文件存放的根目录

```nginx
root /var/www/html;
```

#### 🔗 目录别名 (alias)

**作用**: 为特定URL路径设置别名目录

```nginx
location /images/ {
    alias /data/images/;  # /images/photo.jpg 实际访问 /data/images/photo.jpg
}
```

**root vs alias 区别**:
```
root示例:
location /images/ { root /data; }
访问 /images/photo.jpg → 文件路径 /data/images/photo.jpg

alias示例:  
location /images/ { alias /data/photos/; }
访问 /images/photo.jpg → 文件路径 /data/photos/photo.jpg
```

#### 📄 默认首页 (index)

**作用**: 设置目录的默认首页文件

```nginx
index index.html index.htm index.php;
```

**查找顺序**: 按从左到右的顺序查找文件，找到第一个存在的文件就使用它。

### 5.4 URL处理


#### 🔍 文件查找策略 (try_files)

**作用**: 按顺序尝试查找文件，找不到就执行后备方案

```nginx
try_files $uri $uri/ /index.html;
```

**工作流程示例**:
```
访问 /about
1. 先找 /var/www/html/about 文件
2. 再找 /var/www/html/about/ 目录  
3. 最后返回 /var/www/html/index.html
```

**常见用法**:
```nginx
# 单页应用(SPA)
try_files $uri $uri/ /index.html;

# WordPress
try_files $uri $uri/ /index.php?$query_string;

# 静态站点
try_files $uri $uri/ =404;
```

#### 📋 目录浏览 (autoindex)

**作用**: 当没有首页文件时，显示目录文件列表

```nginx
autoindex on;                      # 开启目录浏览
autoindex_exact_size off;          # 显示友好的文件大小
autoindex_localtime on;            # 显示本地时间
```

**效果对比**:
```
autoindex_exact_size on:  1048576 bytes
autoindex_exact_size off: 1.0M

autoindex_localtime on:   2025-09-21 14:30:00
autoindex_localtime off:  21-Sep-2025 06:30
```

---

## 6. 🔄 反向代理与负载均衡


### 6.1 反向代理概念

反向代理就像餐厅的**传菜员**，客人点菜后，传菜员去厨房取菜再端给客人。客人不需要知道哪个厨师做的菜。

```
客户端请求流程:
浏览器 → Nginx(传菜员) → 后端服务器(厨师) → 数据库
        ↓                              ↓
    缓存、压缩、安全检查          业务逻辑处理
```

### 6.2 基础代理配置


#### 🎯 代理地址 (proxy_pass)

**作用**: 指定要代理到的后端服务器地址

```nginx
location /api/ {
    proxy_pass http://127.0.0.1:8080;    # 代理到本机8080端口
}

location /app/ {
    proxy_pass http://backend-server;     # 代理到上游服务器组
}
```

**URL处理规则**:
```
有斜杠: proxy_pass http://server/;
访问 /api/user → 代理到 http://server/user

无斜杠: proxy_pass http://server;  
访问 /api/user → 代理到 http://server/api/user
```

#### 📋 代理请求头设置 (proxy_set_header)

**作用**: 向后端服务器传递客户端信息

```nginx
proxy_set_header Host $host;                    # 原始主机名
proxy_set_header X-Real-IP $remote_addr;       # 客户端真实IP
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  # IP转发链
proxy_set_header X-Forwarded-Proto $scheme;    # 原始协议(http/https)
```

**为什么需要设置这些头**:
```
问题: 后端服务器只能看到Nginx的IP，看不到真实客户端
解决: 通过HTTP头告诉后端服务器客户端的真实信息
应用: 用户日志、地域限制、安全检查等
```

### 6.3 代理超时配置


#### ⏰ 代理超时设置

**作用**: 控制代理过程中各个阶段的超时时间

```nginx
proxy_connect_timeout 60s;    # 连接后端超时
proxy_send_timeout 60s;       # 发送请求超时  
proxy_read_timeout 60s;       # 读取响应超时
```

**超时场景说明**:
| 超时类型 | 触发时机 | 建议值 | 影响 |
|----------|----------|--------|------|
| `connect` | 连接后端服务器 | `30-60s` | 🔺 太短无法连接慢服务器 |
| `send` | 发送请求数据 | `60-120s` | 🔺 太短无法传输大文件 |
| `read` | 等待后端响应 | `60-300s` | 🔺 太短无法处理复杂请求 |

### 6.4 代理缓冲配置


#### 📦 代理缓冲区设置

**作用**: 优化代理过程中的数据传输效率

```nginx
proxy_buffering on;                # 开启代理缓冲
proxy_buffer_size 4k;             # 响应头缓冲区大小
proxy_buffers 8 4k;               # 响应体缓冲区：8个4KB
proxy_busy_buffers_size 8k;       # 忙碌缓冲区大小
```

**缓冲机制说明**:
```
开启缓冲的好处:
- Nginx先接收完整响应，再发送给客户端
- 减少后端服务器连接时间
- 提高并发处理能力

关闭缓冲的场景:
- 实时流媒体传输
- 服务器推送事件(SSE)
- 需要立即响应的API
```

### 6.5 负载均衡配置


#### ⚖️ 上游服务器组 (upstream)

**作用**: 定义一组后端服务器，实现负载均衡

```nginx
upstream backend {
    server 192.168.1.10:8080 weight=3;        # 权重为3
    server 192.168.1.11:8080 weight=1;        # 权重为1  
    server 192.168.1.12:8080 backup;          # 备用服务器
    server 192.168.1.13:8080 down;            # 临时下线
}

server {
    location / {
        proxy_pass http://backend;
    }
}
```

**服务器参数说明**:
| 参数 | 作用 | 示例 | 说明 |
|------|------|------|------|
| `weight` | 权重分配 | `weight=3` | 🔺 权重越高分配请求越多 |
| `max_fails` | 最大失败次数 | `max_fails=3` | 🔺 失败3次后暂时不使用 |
| `fail_timeout` | 失败超时时间 | `fail_timeout=30s` | 🔺 30秒后重新尝试使用 |
| `backup` | 备用服务器 | `backup` | 🔺 只有其他服务器都不可用时才使用 |
| `down` | 服务器下线 | `down` | 🔺 暂时不参与负载均衡 |

#### 🎲 负载均衡算法

**默认算法**: 加权轮询 (weighted round-robin)

```nginx
upstream backend {
    # 默认加权轮询
    server server1.com weight=3;
    server server2.com weight=1;
}

upstream backend_ip_hash {
    ip_hash;  # IP哈希，同一IP总是访问同一台服务器
    server server1.com;
    server server2.com;
}

upstream backend_least_conn {
    least_conn;  # 最少连接数优先
    server server1.com;
    server server2.com;
}
```

**算法选择指导**:
```
加权轮询: 适用于服务器性能不同的场景
IP哈希: 适用于需要会话保持的应用
最少连接: 适用于请求处理时间差异较大的场景
```

---

## 7. 🔐 SSL安全配置


### 7.1 SSL/TLS概念

SSL就像给网站穿上一件**防弹衣**，保护数据在传输过程中不被窃听或篡改。

```
HTTP传输: 明文传输，就像寄明信片
HTTPS传输: 加密传输，就像寄密封信件
```

### 7.2 SSL基础配置


#### 🔒 SSL证书配置

**作用**: 配置SSL证书和私钥文件

```nginx
server {
    listen 443 ssl;
    server_name example.com;
    
    ssl_certificate /path/to/certificate.crt;      # 证书文件
    ssl_certificate_key /path/to/private.key;      # 私钥文件
}
```

**证书类型说明**:
| 证书类型 | 验证级别 | 适用场景 | 价格 |
|----------|----------|----------|------|
| **DV证书** | 域名验证 | 个人网站、博客 | 💰 免费-便宜 |
| **OV证书** | 组织验证 | 企业网站 | 💰💰 中等 |
| **EV证书** | 扩展验证 | 银行、电商 | 💰💰💰 昂贵 |

#### 🔧 SSL协议版本配置

**作用**: 指定支持的SSL/TLS协议版本

```nginx
ssl_protocols TLSv1.2 TLSv1.3;  # 只支持安全版本
```

**协议安全性对比**:
```
TLSv1.3: 最新最安全，性能最好 ✅
TLSv1.2: 安全可靠，广泛支持 ✅  
TLSv1.1: 已过时，不推荐 ❌
TLSv1.0: 不安全，禁用 ❌
SSLv3:   严重漏洞，禁用 ❌
SSLv2:   严重漏洞，禁用 ❌
```

#### 🔐 加密套件配置

**作用**: 指定支持的加密算法组合

```nginx
ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
ssl_prefer_server_ciphers on;  # 优先使用服务器的加密套件顺序
```

**推荐的现代加密套件**:
```nginx
ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
```

### 7.3 SSL性能优化


#### ⚡ SSL会话缓存

**作用**: 缓存SSL握手信息，提高HTTPS连接速度

```nginx
ssl_session_cache shared:SSL:10m;    # 共享缓存10MB
ssl_session_timeout 10m;             # 会话超时10分钟
```

**会话缓存效果**:
```
首次访问: 完整SSL握手，耗时较长
再次访问: 复用会话，大幅提速
缓存命中率: 通常可达80-90%
```

#### 📋 OCSP装订

**作用**: 优化证书状态检查，提高SSL连接速度

```nginx
ssl_stapling on;
ssl_stapling_verify on;
resolver 8.8.8.8 8.8.4.4 valid=300s;
resolver_timeout 5s;
```

**OCSP装订原理**:
```
传统方式: 浏览器 → 证书颁发机构 → 检查证书状态
OCSP装订: 服务器预先获取证书状态，直接告诉浏览器
```

### 7.4 安全增强配置


#### 🛡️ 安全响应头

**作用**: 通过HTTP响应头增强网站安全性

```nginx
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
add_header X-Frame-Options "DENY" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
```

**安全头说明**:
| 响应头 | 作用 | 保护对象 |
|--------|------|----------|
| `HSTS` | 强制HTTPS访问 | 🔒 防止协议降级攻击 |
| `X-Frame-Options` | 防止页面嵌入 | 🖼️ 防止点击劫持 |
| `X-Content-Type-Options` | 阻止MIME嗅探 | 📄 防止内容类型混淆 |
| `X-XSS-Protection` | 启用XSS过滤 | 💉 防止跨站脚本攻击 |

---

## 8. 🚦 访问控制与限制


### 8.1 IP访问控制

就像设置餐厅的**黑白名单**，决定哪些客人可以进入，哪些不能进入。

#### 🚫 IP黑白名单 (allow/deny)

**作用**: 基于IP地址控制访问权限

```nginx
location /admin/ {
    allow 192.168.1.0/24;    # 允许局域网访问
    allow 10.0.0.1;          # 允许特定IP
    deny all;                # 拒绝其他所有IP
}
```

**规则匹配顺序**: Nginx按从上到下的顺序匹配，遇到第一个匹配的规则就停止。

**常见IP格式**:
```
单个IP: allow 192.168.1.100;
IP段: allow 192.168.1.0/24;     # 192.168.1.1-192.168.1.254
大段: allow 10.0.0.0/8;         # 10.0.0.1-10.255.255.254
所有: allow all; 或 deny all;
```

### 8.2 用户认证


#### 🔑 HTTP基本认证 (auth_basic)

**作用**: 要求用户输入用户名和密码才能访问

```nginx
location /private/ {
    auth_basic "Restricted Area";              # 认证提示信息
    auth_basic_user_file /etc/nginx/htpasswd; # 用户密码文件
}
```

**创建密码文件**:
```bash
# 安装htpasswd工具
yum install httpd-tools  # CentOS
apt install apache2-utils  # Ubuntu

# 创建用户密码
htpasswd -c /etc/nginx/htpasswd admin    # 创建第一个用户
htpasswd /etc/nginx/htpasswd user1       # 添加其他用户
```

#### 🔐 访问控制逻辑 (satisfy)

**作用**: 控制多重访问控制的逻辑关系

```nginx
location /secure/ {
    satisfy any;              # 满足任一条件即可 (或逻辑)
    # satisfy all;           # 必须满足所有条件 (与逻辑)
    
    allow 192.168.1.0/24;    # IP白名单
    auth_basic "Login Required";
    auth_basic_user_file /etc/nginx/htpasswd;
}
```

**逻辑说明**:
```
satisfy any: IP在白名单 OR 通过用户认证 → 允许访问
satisfy all: IP在白名单 AND 通过用户认证 → 允许访问
```

### 8.3 请求频率限制


#### 🚦 请求限速 (limit_req)

**作用**: 限制客户端的请求频率，防止DDoS攻击

```nginx
# 在http块中定义限制区域
limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;

# 在location中应用限制
location /api/ {
    limit_req zone=api burst=20 nodelay;
}
```

**参数详解**:
| 参数 | 作用 | 示例 | 说明 |
|------|------|------|------|
| `zone` | 限制区域名称 | `zone=api:10m` | 🔺 10MB内存存储状态 |
| `rate` | 请求速率 | `rate=10r/s` | 🔺 每秒最多10个请求 |
| `burst` | 突发请求数 | `burst=20` | 🔺 允许20个突发请求 |
| `nodelay` | 立即处理模式 | `nodelay` | 🔺 不延迟处理突发请求 |

**限速效果演示**:
```
正常情况: 每秒处理10个请求
突发流量: 瞬间可处理30个请求(10+20)
超出限制: 返回503错误
```

#### 🔗 连接数限制 (limit_conn)

**作用**: 限制同一IP的并发连接数

```nginx
# 定义连接限制区域
limit_conn_zone $binary_remote_addr zone=conn:10m;

# 应用连接限制
location /download/ {
    limit_conn conn 2;  # 每个IP最多2个并发连接
}
```

**使用场景**:
```
文件下载: 防止单用户占用过多带宽
API接口: 防止恶意客户端建立过多连接
流媒体: 控制并发播放数量
```

### 8.4 重定向与重写


#### 🔄 URL重定向 (return)

**作用**: 将请求重定向到其他地址

```nginx
# 永久重定向 (301)
location /old-path/ {
    return 301 /new-path/;
}

# 临时重定向 (302)  
location /temp/ {
    return 302 http://example.com/new-location;
}

# 返回状态码
location /forbidden/ {
    return 403;
}
```

**重定向状态码说明**:
| 状态码 | 类型 | SEO影响 | 使用场景 |
|--------|------|---------|----------|
| `301` | 永久重定向 | 🟢 转移权重 | 网站改版、URL规范化 |
| `302` | 临时重定向 | 🟡 不转移权重 | 临时维护、A/B测试 |
| `404` | 页面不存在 | 🔴 负面影响 | 删除的页面 |
| `403` | 禁止访问 | 🔴 负面影响 | 权限不足 |

#### ✏️ URL重写 (rewrite)

**作用**: 修改请求的URI，支持正则表达式

```nginx
# 基本重写
rewrite ^/old-(.*)$ /new-$1 permanent;

# 去除文件扩展名
rewrite ^/(.*)\.html$ /$1 permanent;

# 添加www前缀
if ($host !~* ^www\.) {
    rewrite ^(.*)$ http://www.$host$1 permanent;
}
```

**重写标志说明**:
```
last: 停止处理当前规则，重新开始匹配
break: 停止处理所有重写规则
redirect: 返回302临时重定向
permanent: 返回301永久重定向
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的核心概念


```
🔸 配置文件结构：全局 → events → http → server → location
🔸 进程模型：主进程管理 + 多个工作进程处理请求
🔸 事件驱动：epoll高效处理大量并发连接
🔸 虚拟主机：一台服务器托管多个网站
🔸 反向代理：Nginx作为中介转发请求到后端
🔸 负载均衡：多台后端服务器分担负载
🔸 SSL配置：HTTPS加密传输保护数据安全
🔸 访问控制：IP限制、用户认证、频率限制
```

### 9.2 关键参数记忆要点


**🔹 性能相关参数**
```
worker_processes auto;           # 工作进程数 = CPU核心数
worker_connections 1024;         # 每进程最大连接数
sendfile on;                     # 高效文件传输
keepalive_timeout 65;            # 长连接超时时间
```

**🔹 安全相关参数**
```
server_tokens off;               # 隐藏版本信息
ssl_protocols TLSv1.2 TLSv1.3;  # 只用安全协议
limit_req_zone 限制请求频率      # 防DDoS攻击
allow/deny 控制IP访问            # 访问控制
```

**🔹 代理相关参数**
```
proxy_pass 后端地址;             # 反向代理目标
proxy_set_header 传递客户端信息  # 保持原始请求信息
upstream 定义服务器组;           # 负载均衡
```

### 9.3 实际应用价值


**🎯 企业级Web服务架构**
- **前端静态资源**：Nginx直接提供
- **API接口**：反向代理到后端应用服务器
- **数据库查询**：后端服务器处理业务逻辑
- **文件上传**：Nginx处理大文件上传优化

**🛡️ 安全防护体系**
- **SSL/TLS加密**：保护数据传输安全
- **访问控制**：IP白名单、用户认证
- **频率限制**：防止恶意攻击
- **安全响应头**：增强浏览器安全策略

**⚡ 性能优化策略**
- **负载均衡**：分散服务器压力
- **静态文件缓存**：减少服务器负载
- **gzip压缩**：减少网络传输量
- **HTTP/2支持**：提升网页加载速度

### 9.4 配置最佳实践


**🔧 配置文件组织**
```
主配置文件: /etc/nginx/nginx.conf
虚拟主机: /etc/nginx/sites-available/
SSL证书: /etc/ssl/certs/
日志文件: /var/log/nginx/
```

**📊 监控要点**
```
访问日志: 分析用户行为和流量模式
错误日志: 快速定位和解决问题
性能指标: 响应时间、并发连接数
资源使用: CPU、内存、磁盘IO
```

**🚀 维护建议**
```
定期备份: 配置文件和SSL证书
版本更新: 及时修复安全漏洞
日志轮转: 防止日志文件过大
性能调优: 根据实际负载调整参数
```

**核心记忆口诀**：
- Nginx配置有层次，全局事件HTTP嵌套
- 虚拟主机分域名，代理负载保性能
- SSL安全是必须，访问控制防攻击
- 参数调优看场景，监控日志助运维