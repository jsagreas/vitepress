---
title: 14、安全相关配置
---
## 📚 目录

1. [安全头部配置](#1-安全头部配置)
2. [点击劫持防护配置](#2-点击劫持防护配置)
3. [MIME嗅探防护配置](#3-MIME嗅探防护配置)
4. [HSTS强制HTTPS配置](#4-HSTS强制HTTPS配置)
5. [内容安全策略配置](#5-内容安全策略配置)
6. [IP访问控制配置](#6-IP访问控制配置)
7. [请求频率限制配置](#7-请求频率限制配置)
8. [连接数限制配置](#8-连接数限制配置)
9. [安全配置最佳实践](#9-安全配置最佳实践)
10. [核心要点总结](#10-核心要点总结)

---

## 1. 🛡️ 安全头部配置


### 1.1 add_header指令基础


**🔸 什么是安全头部**
```
简单理解：就像给你的网站加上各种"安全标签"
作用：告诉浏览器如何安全地处理你的网页内容
位置：HTTP响应头中，用户看不到但浏览器会读取

生活类比：
网站 = 你的房子
安全头部 = 门口贴的各种告示牌
"禁止推销员进入" = X-Frame-Options
"请出示身份证" = Content-Security-Policy
```

**💡 add_header指令语法**
```nginx
# 基本语法
add_header 头部名称 头部值 [always];

# always参数：确保在所有HTTP状态码下都添加头部
add_header X-Frame-Options DENY always;
```

### 1.2 常用安全头部概览


**📊 安全头部全家桶**
```
┌─────────────────────────────────────────┐
│             HTTP安全头部                │
├─────────────────────────────────────────┤
│ X-Frame-Options      │ 防止点击劫持     │
├─────────────────────────────────────────┤
│ X-Content-Type-Options │ 防止MIME嗅探   │
├─────────────────────────────────────────┤
│ Strict-Transport-Security │ 强制HTTPS  │
├─────────────────────────────────────────┤
│ Content-Security-Policy │ 内容安全策略  │
├─────────────────────────────────────────┤
│ X-XSS-Protection     │ XSS攻击防护     │
└─────────────────────────────────────────┘
```

---

## 2. 🚫 点击劫持防护配置


### 2.1 X-Frame-Options详解


**🔸 什么是点击劫持**
```
攻击原理：
恶意网站 → 用iframe偷偷嵌入你的网站 → 诱导用户点击
用户以为：在点击恶意网站的按钮
实际情况：点击的是你网站的重要操作按钮

现实例子：
用户看到："点击领取红包"
实际点击：银行转账确认按钮
结果：钱被转走了！
```

**⚡ 配置示例**
```nginx
server {
    listen 80;
    server_name example.com;
    
    # 完全禁止被iframe嵌入
    add_header X-Frame-Options DENY always;
    
    # 只允许同源嵌入
    # add_header X-Frame-Options SAMEORIGIN always;
    
    # 允许指定域名嵌入
    # add_header X-Frame-Options "ALLOW-FROM https://trusted.com" always;
}
```

### 2.2 三种防护级别


| 配置值 | **防护效果** | **适用场景** | **注意事项** |
|--------|-------------|-------------|-------------|
| `DENY` | `完全禁止任何网站嵌入` | `银行、支付等敏感网站` | `无法在iframe中展示` |
| `SAMEORIGIN` | `只允许同域名嵌入` | `一般企业网站` | `子域名也被禁止` |
| `ALLOW-FROM` | `指定白名单域名` | `需要合作伙伴嵌入` | `浏览器支持有限` |

**🎯 选择建议**
```
高安全要求：选择 DENY
一般网站：选择 SAMEORIGIN  
需要嵌入：选择 ALLOW-FROM 或使用 CSP
```

---

## 3. 🔍 MIME嗅探防护配置


### 3.1 X-Content-Type-Options详解


**🔸 什么是MIME嗅探攻击**
```
正常情况：
服务器说："这是个图片文件"
浏览器："好的，我按图片处理"

攻击情况：
黑客上传：伪装成图片的恶意脚本
服务器说："这是个图片文件"  
浏览器嗅探："咦，内容像脚本，我执行一下"
结果：恶意代码被执行！

生活类比：
你收到一个写着"礼品盒"的包裹
但你打开发现里面是炸弹
MIME嗅探防护 = 只看标签，不猜内容
```

**⚡ 配置示例**
```nginx
server {
    listen 80;
    server_name example.com;
    
    # 禁止浏览器MIME嗅探
    add_header X-Content-Type-Options nosniff always;
    
    # 配合正确的MIME类型设置
    location ~* \.(jpg|jpeg|png|gif)$ {
        add_header Content-Type image/jpeg;
        add_header X-Content-Type-Options nosniff always;
    }
    
    location ~* \.(js|css)$ {
        add_header X-Content-Type-Options nosniff always;
    }
}
```

**💡 防护原理**
```
设置后的效果：
浏览器："服务器说这是图片，我就按图片处理"
浏览器："即使内容看起来像脚本，我也不执行"
结果：恶意代码无法执行
```

---

## 4. 🔒 HSTS强制HTTPS配置


### 4.1 Strict-Transport-Security详解


**🔸 什么是HSTS**
```
HSTS = HTTP Strict Transport Security
作用：强制浏览器只使用HTTPS访问网站

没有HSTS的问题：
用户输入：example.com
浏览器：先试HTTP，再跳转HTTPS
危险：中间人可以劫持HTTP请求

有HSTS的情况：
浏览器记住："这个网站必须用HTTPS"
下次直接：https://example.com
安全：跳过HTTP阶段
```

**⚡ 基础配置**
```nginx
server {
    listen 443 ssl http2;
    server_name example.com;
    
    # 基础HSTS配置（1年）
    add_header Strict-Transport-Security "max-age=31536000" always;
    
    # 包含子域名的HSTS配置
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    
    # 最严格配置（包含预加载）
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
}
```

### 4.2 HSTS参数详解


**📊 参数说明**
```
max-age=31536000
├─ 含义：浏览器记住31536000秒（1年）
├─ 单位：秒
└─ 建议：至少1年，最多2年

includeSubDomains
├─ 含义：所有子域名也强制HTTPS
├─ 例如：api.example.com, www.example.com
└─ 注意：确保所有子域名都支持HTTPS

preload  
├─ 含义：申请加入浏览器预加载列表
├─ 效果：首次访问也强制HTTPS
└─ 要求：max-age至少1年，必须includeSubDomains
```

**⚠️ 重要提醒**
```
HSTS一旦设置，很难撤销！
设置前确保：
✅ 所有页面都支持HTTPS
✅ 所有子域名都配置好SSL
✅ 没有HTTP的重要功能
```

---

## 5. 🛡️ 内容安全策略配置


### 5.1 Content-Security-Policy基础


**🔸 什么是CSP**
```
CSP = Content Security Policy = 内容安全策略
作用：告诉浏览器哪些资源可以加载，哪些不能

生活类比：
网页 = 你的家
CSP = 门卫规则手册
"只允许亲朋好友进入" = 只允许信任域名的脚本
"禁止陌生人带包裹" = 禁止外部脚本注入
```

**💡 CSP工作原理**
```
没有CSP：
恶意脚本注入 → 浏览器执行 → 网站被攻击

有CSP：
恶意脚本注入 → CSP检查 → 不在白名单 → 拒绝执行
```

### 5.2 常用CSP指令


**⚡ 基础配置示例**
```nginx
server {
    listen 443 ssl;
    server_name example.com;
    
    # 基础CSP配置
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:;" always;
    
    # 更严格的配置
    add_header Content-Security-Policy "
        default-src 'self';
        script-src 'self' https://trusted-cdn.com;
        style-src 'self' https://fonts.googleapis.com;
        img-src 'self' data: https:;
        font-src 'self' https://fonts.gstatic.com;
        connect-src 'self' https://api.example.com;
        frame-ancestors 'none';
    " always;
}
```

**📋 CSP指令说明**

| 指令 | **作用** | **示例** | **说明** |
|------|---------|---------|---------|
| `default-src` | `默认策略` | `'self'` | `其他指令的默认值` |
| `script-src` | `脚本来源` | `'self' https://cdn.com` | `控制JavaScript加载` |
| `style-src` | `样式来源` | `'self' 'unsafe-inline'` | `控制CSS加载` |
| `img-src` | `图片来源` | `'self' data: https:` | `控制图片加载` |
| `font-src` | `字体来源` | `https://fonts.com` | `控制字体文件` |

**🔑 关键字说明**
```
'self'          = 同源策略，只允许本域名
'unsafe-inline' = 允许内联代码（不推荐）
'unsafe-eval'   = 允许eval()执行（危险）
data:           = 允许data:协议
https:          = 允许所有HTTPS来源
'none'          = 禁止所有来源
```

---

## 6. 🚧 IP访问控制配置


### 6.1 allow/deny指令详解


**🔸 IP访问控制原理**
```
工作方式：
请求到达 → 检查IP → 对比规则 → 允许/拒绝

生活类比：
网站 = 小区
IP地址 = 身份证号
allow = 白名单（允许进入的人）
deny = 黑名单（禁止进入的人）
```

**⚡ 基础配置**
```nginx
# 全局IP控制
server {
    listen 80;
    server_name example.com;
    
    # 只允许指定IP访问
    allow 192.168.1.100;
    allow 192.168.1.0/24;    # 允许整个网段
    allow 203.0.113.0/24;
    deny all;                # 拒绝其他所有IP
}

# 特定路径IP控制
server {
    listen 80;
    server_name example.com;
    
    # 管理后台只允许内网访问
    location /admin/ {
        allow 192.168.0.0/16;   # 内网段
        allow 10.0.0.0/8;       # 另一个内网段
        deny all;
    }
    
    # API接口限制特定IP
    location /api/ {
        allow 203.0.113.10;     # 合作方IP
        allow 203.0.113.11;
        deny all;
    }
}
```

### 6.2 IP控制规则详解


**📊 IP地址格式说明**
```
单个IP地址：
192.168.1.100           # 精确匹配一个IP

网段表示法：
192.168.1.0/24          # 192.168.1.1-192.168.1.254
10.0.0.0/8              # 10.0.0.1-10.255.255.254
172.16.0.0/12           # 172.16.0.1-172.31.255.254

特殊表示：
all                     # 所有IP地址
```

**🎯 规则执行顺序**
```
重要原则：从上到下依次匹配，遇到匹配规则就停止

示例分析：
allow 192.168.1.100;    # 第1条：允许这个IP
deny 192.168.1.0/24;    # 第2条：拒绝这个网段  
allow all;              # 第3条：允许所有其他IP

结果：
192.168.1.100    → 允许（匹配第1条）
192.168.1.50     → 拒绝（匹配第2条）
203.0.113.10     → 允许（匹配第3条）
```

---

## 7. ⏱️ 请求频率限制配置


### 7.1 limit_req模块详解


**🔸 什么是请求频率限制**
```
作用：防止单个IP短时间内发送太多请求
原理：类似"限速器"，控制访问频率

生活类比：
网站 = 银行ATM机
用户 = 取钱的人  
limit_req = "每人每分钟最多取3次钱"
超出限制 = 提示"操作太频繁，请稍后再试"
```

**💡 工作机制**
```
令牌桶算法：
1. 系统以固定速率生成"令牌"
2. 每个请求消耗一个"令牌"  
3. 没有令牌就等待或拒绝
4. 桶满时不再生成新令牌

例子：
速率：每秒生成2个令牌
桶容量：最多存10个令牌
突发：可以瞬间处理10个请求
持续：每秒只能处理2个请求
```

### 7.2 limit_req配置实例


**⚡ 基础配置**
```nginx
# 在http块中定义限制规则
http {
    # 定义限制区域
    limit_req_zone $binary_remote_addr zone=one:10m rate=1r/s;
    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/m;
    
    server {
        listen 80;
        server_name example.com;
        
        # 全站限制：每秒1个请求，允许5个突发
        limit_req zone=one burst=5 nodelay;
        
        # API接口更严格限制
        location /api/ {
            limit_req zone=api burst=2 nodelay;
        }
        
        # 登录页面特殊限制
        location /login {
            limit_req zone=one burst=1 nodelay;
        }
    }
}
```

**📋 参数详解**
```
limit_req_zone配置解释：
$binary_remote_addr  → 按客户端IP限制
zone=one:10m        → 名为"one"的区域，内存10MB
rate=1r/s           → 每秒允许1个请求

limit_req使用解释：
zone=one            → 使用名为"one"的规则
burst=5             → 允许突发5个请求
nodelay             → 超出后立即返回错误（不排队等待）
```

### 7.3 不同场景的限流策略


**🎯 策略建议**

| 场景 | **限制策略** | **配置示例** | **说明** |
|------|-------------|-------------|---------|
| **一般页面** | `1-2req/s` | `rate=1r/s burst=3` | `正常浏览不受影响` |
| **API接口** | `10-20req/m` | `rate=10r/m burst=2` | `防止接口滥用` |
| **登录注册** | `5req/m` | `rate=5r/m burst=1` | `防止暴力破解` |
| **文件上传** | `1req/m` | `rate=1r/m burst=0` | `防止资源滥用` |

---

## 8. 🔗 连接数限制配置


### 8.1 limit_conn模块详解


**🔸 什么是连接数限制**
```
作用：限制同一IP同时建立的连接数
区别：
- limit_req = 限制请求频率（时间维度）
- limit_conn = 限制并发连接（数量维度）

生活类比：
餐厅 = 你的网站
顾客 = 用户连接
limit_conn = "每个顾客最多占用2个座位"
防止：一个人占用太多资源影响其他顾客
```

**💡 连接vs请求的区别**
```
HTTP/1.1情况：
1个连接 = 可以发送多个请求（keep-alive）
限制10个连接 = 客户端最多同时保持10个TCP连接

HTTP/2情况：
1个连接 = 可以并行处理多个请求
限制1个连接 = 但仍可以高效处理多个请求

实际效果：
防止单个IP占用过多服务器连接资源
```

### 8.2 limit_conn配置实例


**⚡ 基础配置**
```nginx
http {
    # 定义连接限制区域
    limit_conn_zone $binary_remote_addr zone=addr:10m;
    limit_conn_zone $server_name zone=perserver:10m;
    
    server {
        listen 80;
        server_name example.com;
        
        # 每个IP最多10个并发连接
        limit_conn addr 10;
        
        # 整个服务器最多1000个连接
        limit_conn perserver 1000;
        
        # 下载区域更严格限制
        location /download/ {
            limit_conn addr 2;      # 每IP只能2个下载连接
            limit_rate 100k;        # 限制下载速度100KB/s
        }
        
        # 静态文件允许更多连接
        location ~* \.(jpg|png|css|js)$ {
            limit_conn addr 20;
        }
    }
}
```

**📊 配置说明**
```
limit_conn_zone配置：
$binary_remote_addr → 按IP地址统计连接
zone=addr:10m      → 区域名"addr"，内存10MB
                     10MB大约可以记录16万个IP状态

limit_conn使用：
limit_conn addr 10  → 每个IP最多10个连接
超出连接数时       → 返回503错误
```

---

## 9. 🎯 安全配置最佳实践


### 9.1 综合安全配置模板


**⚡ 生产环境推荐配置**
```nginx
http {
    # 限流配置
    limit_req_zone $binary_remote_addr zone=login:10m rate=5r/m;
    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=general:10m rate=2r/s;
    
    # 连接数限制
    limit_conn_zone $binary_remote_addr zone=addr:10m;
    
    server {
        listen 443 ssl http2;
        server_name example.com;
        
        # 基础安全头部
        add_header X-Frame-Options DENY always;
        add_header X-Content-Type-Options nosniff always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        
        # HSTS配置
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        
        # CSP配置
        add_header Content-Security-Policy "
            default-src 'self';
            script-src 'self' https://cdn.jsdelivr.net;
            style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
            img-src 'self' data: https:;
            font-src 'self' https://fonts.gstatic.com;
            connect-src 'self';
            frame-ancestors 'none';
        " always;
        
        # 全站限流
        limit_req zone=general burst=10 nodelay;
        limit_conn addr 20;
        
        # 管理后台保护
        location /admin/ {
            allow 192.168.1.0/24;
            deny all;
            
            limit_req zone=login burst=2 nodelay;
            
            # 额外安全头部
            add_header Cache-Control "no-store, no-cache, must-revalidate" always;
        }
        
        # API接口保护
        location /api/ {
            limit_req zone=api burst=5 nodelay;
            
            # API专用CSP
            add_header Content-Security-Policy "default-src 'none';" always;
        }
        
        # 登录接口特殊保护
        location = /login {
            limit_req zone=login burst=1 nodelay;
            
            # 登录尝试记录
            access_log /var/log/nginx/login_attempts.log combined;
        }
    }
}
```

### 9.2 安全配置检查清单


**✅ 配置完成检查**
```
🔸 安全头部检查：
□ X-Frame-Options已设置
□ X-Content-Type-Options已设置  
□ Strict-Transport-Security已配置
□ Content-Security-Policy已定义

🔸 访问控制检查：
□ 管理后台IP限制已设置
□ 敏感接口访问控制已配置
□ 默认拒绝策略已应用

🔸 频率限制检查：
□ 全站请求频率已限制
□ 登录接口特殊限制已设置
□ API接口限流已配置
□ 连接数限制已设置

🔸 日志监控检查：
□ 安全相关日志已配置
□ 攻击尝试记录已启用
□ 日志轮转已设置
```

### 9.3 常见安全配置错误


**❌ 避免这些错误**
```
错误1：HSTS配置过早
问题：还没完全配置好HTTPS就开启HSTS
后果：用户无法访问网站
解决：确保所有页面都支持HTTPS后再开启

错误2：CSP配置过严
问题：禁用了必需的资源加载
后果：网站功能异常，样式丢失
解决：逐步收紧策略，充分测试

错误3：IP限制过严
问题：限制了正常用户的IP段
后果：合法用户无法访问
解决：仔细规划IP白名单，提供紧急访问方式

错误4：限流设置不当
问题：限制过严影响正常使用
后果：用户体验差，误杀正常请求
解决：根据实际访问量合理设置
```

---

## 10. 📋 核心要点总结


### 10.1 必须掌握的安全配置


**🔸 核心安全头部**
```
X-Frame-Options        → 防点击劫持，推荐DENY或SAMEORIGIN
X-Content-Type-Options → 防MIME嗅探，设置nosniff
Strict-Transport-Security → 强制HTTPS，设置1年以上
Content-Security-Policy → 内容安全策略，根据需求定制
```

**🔸 访问控制配置**
```
allow/deny → IP白名单黑名单，先allow后deny all
规则顺序 → 从上到下匹配，遇到匹配就停止
网段表示 → 使用CIDR格式，如192.168.1.0/24
```

**🔸 频率限制配置**
```
limit_req_zone → 定义限制区域和规则
limit_req → 应用限制规则
limit_conn_zone → 定义连接数限制区域
limit_conn → 应用连接数限制
```

### 10.2 安全配置记忆要点


**🎯 配置优先级**
```
1级（必须）：基础安全头部 + IP访问控制
2级（重要）：HSTS + 基础限流
3级（推荐）：CSP + 详细限流策略
4级（高级）：自定义安全策略
```

**🔑 关键理解**
```
安全配置 = 防护墙 + 限速器 + 身份验证
防护墙 → 安全头部阻止各种攻击
限速器 → 频率和连接限制防止滥用  
身份验证 → IP控制确保合法访问
```

**💡 实施建议**
```
渐进式部署：
1. 先测试环境验证配置
2. 生产环境逐步开启
3. 监控日志调整参数
4. 建立应急访问方案

监控重点：
- 403/503错误率变化
- 正常用户是否受影响
- 攻击阻挡效果如何
- 服务器性能影响
```

**核心记忆口诀**：
- 头部安全防攻击，IP控制挡恶意
- 频率限制防滥用，连接控制保资源
- 策略配置要渐进，监控调优是关键