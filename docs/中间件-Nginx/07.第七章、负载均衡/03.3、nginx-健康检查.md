---
title: 3ã€nginx-å¥åº·æ£€æŸ¥
---
## ğŸ“š ç›®å½•

1. [å¥åº·æ£€æŸ¥åŸºæœ¬æ¦‚å¿µ](#1-å¥åº·æ£€æŸ¥åŸºæœ¬æ¦‚å¿µ)
2. [è¢«åŠ¨å¥åº·æ£€æŸ¥](#2-è¢«åŠ¨å¥åº·æ£€æŸ¥)
3. [ä¸»åŠ¨å¥åº·æ£€æŸ¥](#3-ä¸»åŠ¨å¥åº·æ£€æŸ¥)
4. [å¥åº·æ£€æŸ¥é…ç½®è¯¦è§£](#4-å¥åº·æ£€æŸ¥é…ç½®è¯¦è§£)
5. [æ•…éšœèŠ‚ç‚¹å¤„ç†æœºåˆ¶](#5-æ•…éšœèŠ‚ç‚¹å¤„ç†æœºåˆ¶)
6. [è‡ªåŠ¨æ¢å¤æœºåˆ¶](#6-è‡ªåŠ¨æ¢å¤æœºåˆ¶)
7. [ç›‘æ§å‘Šè­¦é›†æˆ](#7-ç›‘æ§å‘Šè­¦é›†æˆ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¥ å¥åº·æ£€æŸ¥åŸºæœ¬æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯å¥åº·æ£€æŸ¥


**é€šä¿—ç†è§£**ï¼šå°±åƒåŒ»ç”Ÿå®šæœŸç»™ç—…äººä½“æ£€ä¸€æ ·ï¼ŒNginxä¹Ÿéœ€è¦å®šæœŸ"ä½“æ£€"åç«¯æœåŠ¡å™¨

```
ç°å®ç”Ÿæ´»ç±»æ¯”ï¼š
åŒ»é™¢ä½“æ£€ â†’ å‘ç°é—®é¢˜ â†’ åŠæ—¶æ²»ç–— â†’ é¿å…æ¶åŒ–
Nginxå¥åº·æ£€æŸ¥ â†’ å‘ç°æ•…éšœæœåŠ¡å™¨ â†’ åœæ­¢è½¬å‘è¯·æ±‚ â†’ é¿å…ç”¨æˆ·è®¿é—®å¤±è´¥

ç›®çš„ï¼šç¡®ä¿ç”¨æˆ·è¯·æ±‚åªå‘é€ç»™"å¥åº·"çš„æœåŠ¡å™¨
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦å¥åº·æ£€æŸ¥


**æ ¸å¿ƒé—®é¢˜**ï¼šåœ¨è´Ÿè½½å‡è¡¡ç¯å¢ƒä¸­ï¼Œåç«¯æœåŠ¡å™¨å¯èƒ½éšæ—¶å‡ºç°æ•…éšœ

```
å¸¸è§æ•…éšœåœºæ™¯ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    è¯·æ±‚è½¬å‘    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Nginx     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ æœåŠ¡å™¨A âœ…  â”‚ â† æ­£å¸¸
â”‚ è´Ÿè½½å‡è¡¡å™¨   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ æœåŠ¡å™¨B âŒ  â”‚ â† å®•æœºäº†ï¼
â”‚            â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ æœåŠ¡å™¨C âœ…  â”‚ â† æ­£å¸¸
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ²¡æœ‰å¥åº·æ£€æŸ¥çš„åæœï¼š
â€¢ 1/3çš„ç”¨æˆ·è®¿é—®å¤±è´¥
â€¢ ç”¨æˆ·ä½“éªŒå·®
â€¢ ç³»ç»Ÿå¯ç”¨æ€§ä¸‹é™
```

**å¥åº·æ£€æŸ¥çš„ä»·å€¼**ï¼š
- **è‡ªåŠ¨å‘ç°**ï¼šåŠæ—¶å‘ç°æ•…éšœæœåŠ¡å™¨
- **è‡ªåŠ¨éš”ç¦»**ï¼šåœæ­¢å‘æ•…éšœæœåŠ¡å™¨å‘é€è¯·æ±‚
- **è‡ªåŠ¨æ¢å¤**ï¼šæœåŠ¡å™¨æ¢å¤åè‡ªåŠ¨é‡æ–°åŠ å…¥
- **æå‡å¯ç”¨æ€§**ï¼šç¡®ä¿ç³»ç»Ÿæ•´ä½“ç¨³å®šè¿è¡Œ

### 1.3 å¥åº·æ£€æŸ¥çš„åŸºæœ¬åŸç†


**å·¥ä½œæœºåˆ¶**ï¼š
```
æ£€æŸ¥æµç¨‹ï¼š
1. Nginxå®šæœŸå‘åç«¯æœåŠ¡å™¨å‘é€æ£€æµ‹è¯·æ±‚
2. æ ¹æ®æœåŠ¡å™¨å“åº”åˆ¤æ–­å¥åº·çŠ¶æ€
3. å¥åº·çš„æœåŠ¡å™¨ç»§ç»­æ¥æ”¶ç”¨æˆ·è¯·æ±‚
4. ä¸å¥åº·çš„æœåŠ¡å™¨è¢«æš‚æ—¶ç§»é™¤
5. å®šæœŸé‡æ–°æ£€æŸ¥è¢«ç§»é™¤çš„æœåŠ¡å™¨
```

---

## 2. ğŸ” è¢«åŠ¨å¥åº·æ£€æŸ¥


### 2.1 è¢«åŠ¨æ£€æŸ¥åŸç†


**ä»€ä¹ˆæ˜¯è¢«åŠ¨æ£€æŸ¥**ï¼šä¸ä¸»åŠ¨å‘é€æ£€æµ‹è¯·æ±‚ï¼Œè€Œæ˜¯æ ¹æ®ç”¨æˆ·è®¿é—®çš„ç»“æœæ¥åˆ¤æ–­æœåŠ¡å™¨çŠ¶æ€

```
è¢«åŠ¨æ£€æŸ¥å·¥ä½œæ–¹å¼ï¼š
ç”¨æˆ·è¯·æ±‚ â†’ Nginx â†’ åç«¯æœåŠ¡å™¨

å¦‚æœåç«¯æœåŠ¡å™¨ï¼š
âœ… æ­£å¸¸å“åº” â†’ æ ‡è®°ä¸ºå¥åº·
âŒ è¿æ¥å¤±è´¥/è¶…æ—¶/é”™è¯¯å“åº” â†’ æ ‡è®°ä¸ºä¸å¥åº·

å°±åƒï¼šåªæœ‰å½“ç—…äººæ¥çœ‹ç—…æ—¶ï¼ŒåŒ»ç”Ÿæ‰èƒ½å‘ç°é—®é¢˜
```

### 2.2 è¢«åŠ¨æ£€æŸ¥é…ç½®


**åŸºæœ¬é…ç½®è¯­æ³•**ï¼š
```nginx
upstream backend {
    server 192.168.1.10:8080 max_fails=3 fail_timeout=30s;
    server 192.168.1.11:8080 max_fails=3 fail_timeout=30s;
    server 192.168.1.12:8080 max_fails=3 fail_timeout=30s;
}
```

**å‚æ•°è¯¦è§£**ï¼š

| å‚æ•° | å«ä¹‰ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `max_fails` | æœ€å¤§å¤±è´¥æ¬¡æ•° | 1 | è¿ç»­å¤±è´¥å¤šå°‘æ¬¡åæ ‡è®°ä¸ºä¸å¯ç”¨ |
| `fail_timeout` | å¤±è´¥è¶…æ—¶æ—¶é—´ | 10s | è¢«æ ‡è®°ä¸å¯ç”¨åï¼Œå¤šä¹…é‡æ–°å°è¯• |

### 2.3 å¤±è´¥åˆ¤æ–­æ¡ä»¶


**ä»€ä¹ˆæƒ…å†µç®—"å¤±è´¥"**ï¼š
```
è¿æ¥å¤±è´¥ï¼š
â€¢ æ— æ³•å»ºç«‹TCPè¿æ¥
â€¢ è¿æ¥è¶…æ—¶
â€¢ è¿æ¥è¢«æ‹’ç»

å“åº”å¤±è´¥ï¼š
â€¢ HTTP 4xx/5xxé”™è¯¯çŠ¶æ€ç 
â€¢ å“åº”è¶…æ—¶
â€¢ è¿æ¥ä¸­æ–­
```

**é…ç½®ç¤ºä¾‹**ï¼š
```nginx
upstream api_servers {
    # è¿ç»­å¤±è´¥2æ¬¡ï¼Œæš‚åœ60ç§’
    server api1.example.com max_fails=2 fail_timeout=60s;
    server api2.example.com max_fails=2 fail_timeout=60s;
    
    # å¤‡ç”¨æœåŠ¡å™¨ï¼Œåªæœ‰ä¸»æœåŠ¡å™¨éƒ½ä¸å¯ç”¨æ—¶æ‰ä½¿ç”¨
    server backup.example.com backup;
}

server {
    listen 80;
    
    location /api/ {
        proxy_pass http://api_servers;
        
        # è¿æ¥è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 5s;
        proxy_send_timeout 10s;
        proxy_read_timeout 10s;
    }
}
```

### 2.4 è¢«åŠ¨æ£€æŸ¥çš„ä¼˜ç¼ºç‚¹


**ä¼˜ç‚¹**ï¼š
- **é›¶é¢å¤–å¼€é”€**ï¼šä¸äº§ç”Ÿé¢å¤–çš„æ£€æµ‹è¯·æ±‚
- **é…ç½®ç®€å•**ï¼šåªéœ€è®¾ç½®å‡ ä¸ªå‚æ•°
- **å®æ—¶æ€§å¥½**ï¼šåŸºäºçœŸå®ç”¨æˆ·è¯·æ±‚åˆ¤æ–­

**ç¼ºç‚¹**ï¼š
- **æ£€æµ‹æ»å**ï¼šéœ€è¦ç”¨æˆ·è¯·æ±‚æ‰èƒ½å‘ç°é—®é¢˜
- **ç”¨æˆ·å—å½±å“**ï¼šæ•…éšœæœŸé—´ä»æœ‰ç”¨æˆ·è®¿é—®å¤±è´¥
- **åˆ¤æ–­ä¸å¤Ÿå‡†ç¡®**ï¼šå¯èƒ½è¯¯åˆ¤ä¸´æ—¶æ€§é—®é¢˜

---

## 3. ğŸ¯ ä¸»åŠ¨å¥åº·æ£€æŸ¥


### 3.1 ä¸»åŠ¨æ£€æŸ¥åŸç†


**ä»€ä¹ˆæ˜¯ä¸»åŠ¨æ£€æŸ¥**ï¼šNginxä¸»åŠ¨å‘åç«¯æœåŠ¡å™¨å‘é€æ£€æµ‹è¯·æ±‚ï¼Œä¸ä¾èµ–ç”¨æˆ·è®¿é—®

```
ä¸»åŠ¨æ£€æŸ¥å·¥ä½œæ–¹å¼ï¼š
å®šæ—¶å™¨è§¦å‘ â†’ Nginxå‘é€æ£€æµ‹è¯·æ±‚ â†’ åç«¯æœåŠ¡å™¨ â†’ è¿”å›å“åº” â†’ åˆ¤æ–­å¥åº·çŠ¶æ€

å°±åƒï¼šåŒ»ç”Ÿå®šæœŸä¸»åŠ¨ç»™ç—…äººä½“æ£€ï¼Œè€Œä¸ç­‰ç—…äººç”Ÿç—…æ‰å‘ç°é—®é¢˜
```

### 3.2 Nginx Plusçš„ä¸»åŠ¨æ£€æŸ¥


> **æ³¨æ„**ï¼šä¸»åŠ¨å¥åº·æ£€æŸ¥æ˜¯Nginx Plusï¼ˆå•†ä¸šç‰ˆï¼‰çš„åŠŸèƒ½ï¼Œå¼€æºç‰ˆæœ¬ä¸æ”¯æŒ

**é…ç½®ç¤ºä¾‹**ï¼š
```nginx
upstream backend {
    zone backend 64k;
    server backend1.example.com;
    server backend2.example.com;
}

server {
    listen 80;
    
    location / {
        proxy_pass http://backend;
        
        # å¯ç”¨ä¸»åŠ¨å¥åº·æ£€æŸ¥
        health_check;
    }
}
```

**é«˜çº§é…ç½®**ï¼š
```nginx
location / {
    proxy_pass http://backend;
    
    # è¯¦ç»†çš„å¥åº·æ£€æŸ¥é…ç½®
    health_check 
        interval=5s          # æ£€æŸ¥é—´éš”5ç§’
        fails=3             # è¿ç»­å¤±è´¥3æ¬¡æ ‡è®°ä¸ºä¸å¥åº·
        passes=2            # è¿ç»­æˆåŠŸ2æ¬¡æ ‡è®°ä¸ºå¥åº·
        uri=/health         # æ£€æŸ¥çš„URIè·¯å¾„
        match=server_ok;    # ä½¿ç”¨è‡ªå®šä¹‰åŒ¹é…æ¡ä»¶
}

# è‡ªå®šä¹‰åŒ¹é…æ¡ä»¶
match server_ok {
    status 200;                    # HTTPçŠ¶æ€ç å¿…é¡»æ˜¯200
    header Content-Type ~ "text/html";  # å“åº”å¤´åŒ¹é…
    body ~ "Server is OK";         # å“åº”å†…å®¹åŒ¹é…
}
```

### 3.3 å¼€æºç‰ˆæœ¬çš„æ›¿ä»£æ–¹æ¡ˆ


**ä½¿ç”¨ç¬¬ä¸‰æ–¹æ¨¡å—**ï¼š

**1. nginx_upstream_check_module**
```nginx
upstream backend {
    server 192.168.1.10:8080;
    server 192.168.1.11:8080;
    
    # å¥åº·æ£€æŸ¥é…ç½®
    check interval=3000 rise=2 fall=3 timeout=1000;
    check_http_send "GET /health HTTP/1.0\r\n\r\n";
    check_http_expect_alive http_2xx http_3xx;
}
```

**2. ä½¿ç”¨å¤–éƒ¨è„šæœ¬**ï¼š
```bash
#!/bin/bash
# health_check.sh

SERVERS=("192.168.1.10:8080" "192.168.1.11:8080")
NGINX_CONF="/etc/nginx/conf.d/upstream.conf"

for server in "${SERVERS[@]}"; do
    if curl -f -s "http://$server/health" > /dev/null; then
        echo "Server $server is healthy"
        # å°†æœåŠ¡å™¨æ·»åŠ åˆ°é…ç½®ä¸­
    else
        echo "Server $server is unhealthy"
        # ä»é…ç½®ä¸­ç§»é™¤æœåŠ¡å™¨
    fi
done

# é‡æ–°åŠ è½½Nginxé…ç½®
nginx -s reload
```

---

## 4. âš™ï¸ å¥åº·æ£€æŸ¥é…ç½®è¯¦è§£


### 4.1 æ£€æŸ¥é—´éš”è®¾ç½®


**åŸåˆ™**ï¼šå¹³è¡¡æ£€æµ‹åŠæ—¶æ€§å’Œç³»ç»Ÿè´Ÿè½½

```
æ£€æŸ¥é—´éš”é€‰æ‹©ï¼š
é«˜å¯ç”¨ç³»ç»Ÿï¼š1-5ç§’
æ™®é€šç³»ç»Ÿï¼š5-30ç§’
ä½é¢‘æœåŠ¡ï¼š30-300ç§’

è€ƒè™‘å› ç´ ï¼š
â€¢ æœåŠ¡çš„é‡è¦æ€§
â€¢ åç«¯æœåŠ¡å™¨çš„è´Ÿè½½æ‰¿å—èƒ½åŠ›
â€¢ ç½‘ç»œå»¶è¿Ÿ
â€¢ æ•…éšœæ¢å¤æ—¶é—´è¦æ±‚
```

### 4.2 å¤±è´¥é˜ˆå€¼é…ç½®


**è¢«åŠ¨æ£€æŸ¥ç¤ºä¾‹**ï¼š
```nginx
upstream web_servers {
    # è½»é‡çº§æœåŠ¡ï¼šå®¹å¿åº¦ä½
    server web1.local max_fails=1 fail_timeout=10s;
    
    # é‡è¦æœåŠ¡ï¼šå®¹å¿åº¦é«˜
    server api1.local max_fails=5 fail_timeout=30s;
    
    # æ•°æ®åº“ï¼šå®¹å¿åº¦æœ€é«˜
    server db1.local max_fails=10 fail_timeout=60s;
}
```

### 4.3 æ£€æŸ¥è·¯å¾„è®¾è®¡


**ä¸“ç”¨å¥åº·æ£€æŸ¥ç«¯ç‚¹**ï¼š
```nginx
# åº”ç”¨æœåŠ¡å™¨æä¾›ä¸“é—¨çš„å¥åº·æ£€æŸ¥æ¥å£
location /health {
    proxy_pass http://backend/health;
    
    # ä¸è®°å½•å¥åº·æ£€æŸ¥æ—¥å¿—
    access_log off;
}
```

**å¥åº·æ£€æŸ¥æ¥å£è®¾è®¡**ï¼š
```javascript
// Node.jsç¤ºä¾‹
app.get('/health', (req, res) => {
    // æ£€æŸ¥æ•°æ®åº“è¿æ¥
    if (database.isConnected()) {
        res.status(200).json({
            status: 'healthy',
            timestamp: new Date(),
            uptime: process.uptime()
        });
    } else {
        res.status(503).json({
            status: 'unhealthy',
            error: 'Database connection failed'
        });
    }
});
```

### 4.4 è¶…æ—¶è®¾ç½®


**åˆç†çš„è¶…æ—¶é…ç½®**ï¼š
```nginx
location / {
    proxy_pass http://backend;
    
    # è¿æ¥è¶…æ—¶ï¼šå¿«é€Ÿå‘ç°ç½‘ç»œé—®é¢˜
    proxy_connect_timeout 3s;
    
    # å‘é€è¶…æ—¶ï¼šé¿å…æ…¢è¯·æ±‚å½±å“åˆ¤æ–­
    proxy_send_timeout 5s;
    
    # è¯»å–è¶…æ—¶ï¼šå¹³è¡¡å“åº”æ—¶é—´å’Œå®¹é”™
    proxy_read_timeout 10s;
}
```

---

## 5. ğŸ”§ æ•…éšœèŠ‚ç‚¹å¤„ç†æœºåˆ¶


### 5.1 æ•…éšœæ£€æµ‹æµç¨‹


```
æ•…éšœæ£€æµ‹è¿‡ç¨‹ï¼š
è¯·æ±‚å‘é€ â†’ ç­‰å¾…å“åº” â†’ åˆ¤æ–­ç»“æœ
    â†“            â†“         â†“
  æˆåŠŸå‘é€     æ­£å¸¸å“åº”    æ ‡è®°å¥åº·
    â†“            â†“         â†“
  å‘é€å¤±è´¥     å¼‚å¸¸å“åº”    å¤±è´¥è®¡æ•°+1
    â†“            â†“         â†“
 è¿æ¥è¶…æ—¶      å“åº”è¶…æ—¶    è¾¾åˆ°é˜ˆå€¼ï¼Ÿ
                             â†“
                        æ ‡è®°ä¸ºä¸å¯ç”¨
```

### 5.2 èŠ‚ç‚¹çŠ¶æ€ç®¡ç†


**èŠ‚ç‚¹çŠ¶æ€ç±»å‹**ï¼š

| çŠ¶æ€ | æè¿° | å¤„ç†æ–¹å¼ |
|------|------|----------|
| **å¥åº·** | æ­£å¸¸å“åº” | æ­£å¸¸æ¥æ”¶è¯·æ±‚ |
| **ä¸å¥åº·** | è¾¾åˆ°å¤±è´¥é˜ˆå€¼ | æš‚åœå‘é€è¯·æ±‚ |
| **æ¢å¤ä¸­** | æ­£åœ¨é‡æ–°æ£€æµ‹ | é€æ­¥æ¢å¤æµé‡ |
| **ç»´æŠ¤ä¸­** | æ‰‹åŠ¨ä¸‹çº¿ | å®Œå…¨åœæ­¢è¯·æ±‚ |

### 5.3 è´Ÿè½½é‡æ–°åˆ†é…


**æ•…éšœæ—¶çš„æµé‡åˆ†é…**ï¼š
```nginx
upstream app_servers {
    server app1.local weight=3;  # æ­£å¸¸
    server app2.local weight=3;  # æ­£å¸¸  
    server app3.local weight=0;  # æ•…éšœï¼Œæƒé‡ä¸º0
}

# æµé‡åˆ†é…ï¼š
# app1: 50% (3/6)
# app2: 50% (3/6)  
# app3: 0%  (è¢«è·³è¿‡)
```

### 5.4 æ•…éšœéš”ç¦»ç­–ç•¥


**å®Œå…¨éš”ç¦»**ï¼š
```nginx
upstream backend {
    server backend1.local;
    server backend2.local down;  # æ‰‹åŠ¨ä¸‹çº¿
    server backend3.local;
}
```

**é€æ­¥éš”ç¦»**ï¼š
```nginx
upstream backend {
    # ç¬¬ä¸€æ­¥ï¼šé™ä½æƒé‡
    server problem_server weight=1;
    server normal_server weight=10;
    
    # ç¬¬äºŒæ­¥ï¼šå®Œå…¨ç§»é™¤ï¼ˆå¦‚æœé—®é¢˜æŒç»­ï¼‰
    # server problem_server down;
}
```

---

## 6. ğŸ”„ è‡ªåŠ¨æ¢å¤æœºåˆ¶


### 6.1 æ¢å¤æ£€æµ‹åŸç†


**æ¢å¤è¿‡ç¨‹**ï¼š
```
æ•…éšœæœåŠ¡å™¨æ¢å¤æµç¨‹ï¼š
1. æœåŠ¡å™¨ä¿®å¤å®Œæˆ
2. Nginxå®šæœŸé‡æ–°å°è¯•è¿æ¥
3. è¿æ¥æˆåŠŸ â†’ é‡ç½®å¤±è´¥è®¡æ•°
4. é‡æ–°åŠ å…¥è´Ÿè½½å‡è¡¡æ± 
5. é€æ­¥æ¢å¤æ­£å¸¸æµé‡
```

### 6.2 æ¢å¤æ—¶é—´æ§åˆ¶


**fail_timeoutå‚æ•°çš„åŒé‡ä½œç”¨**ï¼š
```nginx
server backend1.local max_fails=3 fail_timeout=30s;

å«ä¹‰ï¼š
1. è¿ç»­å¤±è´¥3æ¬¡åï¼Œæ ‡è®°ä¸ºä¸å¯ç”¨
2. 30ç§’åï¼Œé‡æ–°å°è¯•è¿æ¥ä¸€æ¬¡
3. å¦‚æœæˆåŠŸï¼Œé‡ç½®å¤±è´¥è®¡æ•°å¹¶æ¢å¤æœåŠ¡
4. å¦‚æœå¤±è´¥ï¼Œå†ç­‰30ç§’åé‡è¯•
```

### 6.3 æ¸è¿›å¼æ¢å¤


**é¿å…é›ªå´©æ•ˆåº”**ï¼š
```nginx
upstream backend {
    # ä¸»æœåŠ¡å™¨æ± 
    server main1.local weight=10;
    server main2.local weight=10;
    
    # æ¢å¤ä¸­çš„æœåŠ¡å™¨ï¼šç»™äºˆè¾ƒä½æƒé‡
    server recovering.local weight=1 max_fails=1 fail_timeout=10s;
}
```

### 6.4 æ¢å¤éªŒè¯


**å¤šæ¬¡éªŒè¯ç¡®ä¿ç¨³å®š**ï¼š
```bash
# æ¢å¤éªŒè¯è„šæœ¬
#!/bin/bash
SERVER="http://192.168.1.10:8080"
SUCCESS_COUNT=0
REQUIRED_SUCCESS=3

for i in {1..5}; do
    if curl -f -s "$SERVER/health" > /dev/null; then
        SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
        echo "Health check $i: SUCCESS"
    else
        echo "Health check $i: FAILED"
        SUCCESS_COUNT=0  # é‡ç½®è®¡æ•°
    fi
    sleep 2
done

if [ $SUCCESS_COUNT -ge $REQUIRED_SUCCESS ]; then
    echo "Server is stable, can be fully restored"
else
    echo "Server is still unstable"
fi
```

---

## 7. ğŸ“Š ç›‘æ§å‘Šè­¦é›†æˆ


### 7.1 ç›‘æ§æŒ‡æ ‡


**å…³é”®ç›‘æ§æŒ‡æ ‡**ï¼š

| æŒ‡æ ‡ç±»å‹ | å…·ä½“æŒ‡æ ‡ | è¯´æ˜ |
|----------|----------|------|
| **å¯ç”¨æ€§** | å¥åº·èŠ‚ç‚¹æ•°/æ€»èŠ‚ç‚¹æ•° | æ•´ä½“å¥åº·åº¦ |
| **å“åº”æ€§** | å¹³å‡å“åº”æ—¶é—´ | æ€§èƒ½çŠ¶å†µ |
| **ç¨³å®šæ€§** | æ•…éšœæ¬¡æ•°/æ¢å¤æ¬¡æ•° | ç¨³å®šç¨‹åº¦ |
| **è´Ÿè½½** | å„èŠ‚ç‚¹è¯·æ±‚åˆ†å¸ƒ | è´Ÿè½½å‡è¡¡æ•ˆæœ |

### 7.2 æ—¥å¿—è®°å½•


**å¥åº·æ£€æŸ¥æ—¥å¿—é…ç½®**ï¼š
```nginx
# è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼
log_format health_check '$remote_addr - $remote_user [$time_local] '
                       '"$request" $status $body_bytes_sent '
                       '$upstream_addr $upstream_status $upstream_response_time';

server {
    location /health {
        proxy_pass http://backend;
        access_log /var/log/nginx/health_check.log health_check;
    }
}
```

### 7.3 çŠ¶æ€ç›‘æ§é¡µé¢


**NginxçŠ¶æ€é¡µé…ç½®**ï¼š
```nginx
# å¯ç”¨çŠ¶æ€æ¨¡å—ï¼ˆéœ€è¦ç¼–è¯‘æ—¶åŒ…å«ï¼‰
location /nginx_status {
    stub_status on;
    access_log off;
    
    # é™åˆ¶è®¿é—®
    allow 127.0.0.1;
    allow 192.168.1.0/24;
    deny all;
}

# upstreamçŠ¶æ€ï¼ˆéœ€è¦ç¬¬ä¸‰æ–¹æ¨¡å—ï¼‰
location /status {
    check_status;
    access_log off;
}
```

### 7.4 å‘Šè­¦é›†æˆ


**ä¸ç›‘æ§ç³»ç»Ÿé›†æˆ**ï¼š
```bash
#!/bin/bash
# å¥åº·æ£€æŸ¥å‘Šè­¦è„šæœ¬

UNHEALTHY_THRESHOLD=50  # ä¸å¥åº·èŠ‚ç‚¹è¶…è¿‡50%æ—¶å‘Šè­¦

# è·å–å¥åº·çŠ¶æ€
TOTAL_SERVERS=$(nginx_check_status | grep -c "server")
HEALTHY_SERVERS=$(nginx_check_status | grep -c "up")
UNHEALTHY_PERCENT=$(( (TOTAL_SERVERS - HEALTHY_SERVERS) * 100 / TOTAL_SERVERS ))

if [ $UNHEALTHY_PERCENT -gt $UNHEALTHY_THRESHOLD ]; then
    # å‘é€å‘Šè­¦
    curl -X POST "http://alertmanager:9093/api/v1/alerts" \
         -H "Content-Type: application/json" \
         -d '[{
             "labels": {
                 "alertname": "NginxHighUnhealthyNodes",
                 "severity": "critical",
                 "service": "nginx"
             },
             "annotations": {
                 "summary": "Nginx has too many unhealthy backend nodes",
                 "description": "'"$UNHEALTHY_PERCENT"'% of backend nodes are unhealthy"
             }
         }]'
fi
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å¥åº·æ£€æŸ¥æœ¬è´¨ï¼šè‡ªåŠ¨å‘ç°å’Œå¤„ç†æ•…éšœæœåŠ¡å™¨çš„æœºåˆ¶
ğŸ”¸ è¢«åŠ¨æ£€æŸ¥ï¼šåŸºäºç”¨æˆ·è¯·æ±‚ç»“æœåˆ¤æ–­ï¼Œç®€å•ä½†æœ‰æ»åæ€§
ğŸ”¸ ä¸»åŠ¨æ£€æŸ¥ï¼šä¸»åŠ¨å‘é€æ£€æµ‹è¯·æ±‚ï¼ŒåŠæ—¶ä½†éœ€è¦é¢å¤–èµ„æº
ğŸ”¸ æ•…éšœå¤„ç†ï¼šè‡ªåŠ¨éš”ç¦»æ•…éšœèŠ‚ç‚¹ï¼Œä¿æŠ¤æ•´ä½“ç³»ç»Ÿç¨³å®šæ€§
ğŸ”¸ è‡ªåŠ¨æ¢å¤ï¼šæ•…éšœä¿®å¤åè‡ªåŠ¨é‡æ–°åŠ å…¥æœåŠ¡ï¼Œæ— éœ€äººå·¥å¹²é¢„
```

### 8.2 é…ç½®è¦ç‚¹


**è¢«åŠ¨å¥åº·æ£€æŸ¥é…ç½®**ï¼š
```nginx
upstream backend {
    server server1 max_fails=3 fail_timeout=30s;
    server server2 max_fails=3 fail_timeout=30s;
    server server3 backup;  # å¤‡ç”¨æœåŠ¡å™¨
}
```

**å…³é”®å‚æ•°ç†è§£**ï¼š
- **max_fails**ï¼šå®¹é”™æ¬¡æ•°ï¼Œæ ¹æ®æœåŠ¡ç¨³å®šæ€§è°ƒæ•´
- **fail_timeout**ï¼šæ¢å¤é—´éš”ï¼Œå¹³è¡¡åŠæ—¶æ€§å’Œç³»ç»Ÿè´Ÿè½½
- **backup**ï¼šå¤‡ç”¨èŠ‚ç‚¹ï¼Œä¸»èŠ‚ç‚¹å…¨éƒ¨æ•…éšœæ—¶å¯ç”¨

### 8.3 æœ€ä½³å®è·µ


**è®¾è®¡åŸåˆ™**ï¼š
- **ä¸“ç”¨æ£€æŸ¥ç«¯ç‚¹**ï¼šè®¾è®¡è½»é‡çº§çš„ `/health` æ¥å£
- **åˆç†çš„é˜ˆå€¼**ï¼šæ ¹æ®æœåŠ¡ç‰¹æ€§è®¾ç½®å¤±è´¥æ¬¡æ•°å’Œè¶…æ—¶æ—¶é—´
- **ç›‘æ§é›†æˆ**ï¼šç»“åˆæ—¥å¿—å’Œç›‘æ§ç³»ç»Ÿï¼ŒåŠæ—¶å‘ç°é—®é¢˜
- **æ¸è¿›æ¢å¤**ï¼šé¿å…æ•…éšœæœåŠ¡å™¨æ¢å¤æ—¶é€ æˆå†²å‡»

**å¸¸ç”¨é…ç½®æ¨¡æ¿**ï¼š
```nginx
upstream production_app {
    # WebæœåŠ¡å™¨ï¼šå¿«é€Ÿå“åº”è¦æ±‚
    server web1.local max_fails=2 fail_timeout=10s;
    server web2.local max_fails=2 fail_timeout=10s;
    
    # APIæœåŠ¡å™¨ï¼šç¨³å®šæ€§è¦æ±‚
    server api1.local max_fails=3 fail_timeout=30s;
    server api2.local max_fails=3 fail_timeout=30s;
    
    # å¤‡ç”¨æœåŠ¡å™¨
    server backup.local backup;
}
```

### 8.4 æ•…éšœæ’æŸ¥æ€è·¯


**å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ**ï¼š

| é—®é¢˜ç°è±¡ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ¡ˆ |
|----------|----------|----------|
| æœåŠ¡å™¨é¢‘ç¹ä¸Šä¸‹çº¿ | é˜ˆå€¼è®¾ç½®è¿‡æ•æ„Ÿ | å¢åŠ max_failså€¼ |
| æ•…éšœå‘ç°å¤ªæ…¢ | æ£€æŸ¥é—´éš”å¤ªé•¿ | å‡å°‘fail_timeout |
| ç³»ç»Ÿè´Ÿè½½è¿‡é«˜ | æ£€æŸ¥è¿‡äºé¢‘ç¹ | å¢åŠ æ£€æŸ¥é—´éš” |
| è¯¯åˆ¤å¥åº·æœåŠ¡å™¨ | æ£€æŸ¥ç«¯ç‚¹æœ‰é—®é¢˜ | ä¼˜åŒ–å¥åº·æ£€æŸ¥æ¥å£ |

**æ ¸å¿ƒè®°å¿†**ï¼š
- å¥åº·æ£€æŸ¥æ˜¯è´Ÿè½½å‡è¡¡çš„"ä¿é™©ä¸"
- è¢«åŠ¨æ£€æŸ¥ç®€å•å®ç”¨ï¼Œä¸»åŠ¨æ£€æŸ¥æ›´åŠ åŠæ—¶
- åˆç†è®¾ç½®å‚æ•°æ˜¯å…³é”®ï¼Œè¿‡æ•è¿‡é’éƒ½ä¸å¥½
- ç›‘æ§å‘Šè­¦ä¸å¯å°‘ï¼ŒåŠæ—¶å‘ç°æ—©å¤„ç†