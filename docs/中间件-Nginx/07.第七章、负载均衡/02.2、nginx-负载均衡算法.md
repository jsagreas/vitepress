---
title: 2ã€nginx-è´Ÿè½½å‡è¡¡ç®—æ³•
---
## ğŸ“š ç›®å½•

1. [è´Ÿè½½å‡è¡¡åŸºç¡€æ¦‚å¿µ](#1-è´Ÿè½½å‡è¡¡åŸºç¡€æ¦‚å¿µ)
2. [è½®è¯¢ç®—æ³•è¯¦è§£](#2-è½®è¯¢ç®—æ³•è¯¦è§£)
3. [åŠ æƒè½®è¯¢æ·±å…¥ç†è§£](#3-åŠ æƒè½®è¯¢æ·±å…¥ç†è§£)
4. [IPå“ˆå¸Œç®—æ³•åŸç†](#4-IPå“ˆå¸Œç®—æ³•åŸç†)
5. [æœ€å°‘è¿æ¥ç®—æ³•](#5-æœ€å°‘è¿æ¥ç®—æ³•)
6. [ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•](#6-ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•)
7. [ä¼šè¯ä¿æŒæœºåˆ¶](#7-ä¼šè¯ä¿æŒæœºåˆ¶)
8. [ç®—æ³•é€‰æ‹©æŒ‡å—](#8-ç®—æ³•é€‰æ‹©æŒ‡å—)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”„ è´Ÿè½½å‡è¡¡åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯è´Ÿè½½å‡è¡¡

ğŸ¯ **é€šä¿—ç†è§£**ï¼šè´Ÿè½½å‡è¡¡å°±åƒé“¶è¡Œçš„å«å·ç³»ç»Ÿ

```
é“¶è¡ŒæœåŠ¡çª—å£çš„æ¯”å–»ï¼š
æ²¡æœ‰å«å·ç³»ç»Ÿï¼š
- æ‰€æœ‰å®¢æˆ·æŒ¤åœ¨ä¸€ä¸ªçª—å£ â†’ æ’é˜Ÿå¾ˆé•¿ï¼Œæ•ˆç‡ä½ä¸‹
- å…¶ä»–çª—å£ç©ºé—² â†’ èµ„æºæµªè´¹

æœ‰äº†å«å·ç³»ç»Ÿï¼š
- è‡ªåŠ¨åˆ†é…å®¢æˆ·åˆ°ä¸åŒçª—å£ â†’ åˆ†æ•£å‹åŠ›
- æ ¹æ®ä¸šåŠ¡ç±»å‹åˆ†é… â†’ ä¸“ä¸šé«˜æ•ˆ
- çª—å£æ•…éšœæ—¶è‡ªåŠ¨è½¬ç§» â†’ ä¿è¯æœåŠ¡è¿ç»­æ€§

Nginxè´Ÿè½½å‡è¡¡çš„ä½œç”¨ï¼š
- åˆ†æ•£ç”¨æˆ·è¯·æ±‚åˆ°å¤šå°æœåŠ¡å™¨
- æé«˜ç³»ç»Ÿæ•´ä½“å¤„ç†èƒ½åŠ›
- é¿å…å•ç‚¹æ•…éšœï¼Œæå‡å¯ç”¨æ€§
```

### 1.2 è´Ÿè½½å‡è¡¡çš„æ ¸å¿ƒä»·å€¼

**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦è´Ÿè½½å‡è¡¡**

```
å•æœåŠ¡å™¨çš„é—®é¢˜ï¼š
ğŸ”¸ æ€§èƒ½ç“¶é¢ˆï¼šä¸€å°æœåŠ¡å™¨å¤„ç†èƒ½åŠ›æœ‰é™
ğŸ”¸ å•ç‚¹æ•…éšœï¼šæœåŠ¡å™¨æŒ‚äº†æ•´ä¸ªç³»ç»Ÿå°±ä¸å¯ç”¨
ğŸ”¸ èµ„æºæµªè´¹ï¼šæ— æ³•å……åˆ†åˆ©ç”¨å¤šå°æœåŠ¡å™¨

è´Ÿè½½å‡è¡¡è§£å†³çš„é—®é¢˜ï¼š
âœ… æ°´å¹³æ‰©å±•ï¼šå¢åŠ æœåŠ¡å™¨æå‡æ•´ä½“æ€§èƒ½
âœ… é«˜å¯ç”¨æ€§ï¼šæŸå°æœåŠ¡å™¨æ•…éšœä¸å½±å“æ•´ä½“æœåŠ¡
âœ… èµ„æºä¼˜åŒ–ï¼šåˆç†åˆ†é…è¯·æ±‚ï¼Œæé«˜èµ„æºåˆ©ç”¨ç‡
âœ… çµæ´»ä¼¸ç¼©ï¼šæ ¹æ®è´Ÿè½½åŠ¨æ€è°ƒæ•´æœåŠ¡å™¨æ•°é‡
```

### 1.3 Nginxè´Ÿè½½å‡è¡¡çš„å·¥ä½œåŸç†

**âš™ï¸ åŸºæœ¬å·¥ä½œæµç¨‹**

```
è¯·æ±‚å¤„ç†æµç¨‹ï¼š
å®¢æˆ·ç«¯è¯·æ±‚ â†’ Nginxä»£ç†æœåŠ¡å™¨ â†’ é€‰æ‹©ç®—æ³• â†’ åç«¯æœåŠ¡å™¨ â†’ å¤„ç†ç»“æœ â†’ è¿”å›å®¢æˆ·ç«¯
     â†“              â†“              â†“            â†“           â†“
   ç”¨æˆ·è®¿é—®     è´Ÿè½½å‡è¡¡å™¨      ç®—æ³•å†³ç­–     å®é™…å¤„ç†     å“åº”è¿”å›

Nginxçš„è§’è‰²ï¼š
- åå‘ä»£ç†ï¼šä»£ç†åç«¯æœåŠ¡å™¨æ¥æ”¶è¯·æ±‚
- è°ƒåº¦å™¨ï¼šæ ¹æ®ç®—æ³•é€‰æ‹©åˆé€‚çš„åç«¯æœåŠ¡å™¨
- ç›‘æ§å™¨ï¼šæ£€æŸ¥åç«¯æœåŠ¡å™¨å¥åº·çŠ¶æ€
- ç¼“å­˜å™¨ï¼šå¯ä»¥ç¼“å­˜å“åº”æé«˜æ€§èƒ½
```

### 1.4 upstreamåŸºç¡€é…ç½®

**ğŸ”§ æœ€ç®€å•çš„è´Ÿè½½å‡è¡¡é…ç½®**

```nginx
# å®šä¹‰åç«¯æœåŠ¡å™¨ç»„
upstream backend_servers {
    server 192.168.1.10:8080;
    server 192.168.1.11:8080;
    server 192.168.1.12:8080;
}

# é…ç½®è´Ÿè½½å‡è¡¡
server {
    listen 80;
    server_name example.com;
    
    location / {
        proxy_pass http://backend_servers;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

**ğŸ“‹ é…ç½®è§£é‡Š**
- `upstream` - å®šä¹‰åç«¯æœåŠ¡å™¨ç»„çš„å…³é”®å­—
- `backend_servers` - è‡ªå®šä¹‰çš„æœåŠ¡å™¨ç»„åç§°
- `server` - æŒ‡å®šåç«¯æœåŠ¡å™¨çš„IPå’Œç«¯å£
- `proxy_pass` - å°†è¯·æ±‚è½¬å‘åˆ°æŒ‡å®šçš„æœåŠ¡å™¨ç»„

---

## 2. ğŸ”„ è½®è¯¢ç®—æ³•è¯¦è§£


### 2.1 è½®è¯¢ç®—æ³•çš„å·¥ä½œåŸç†

**ğŸ¯ æœ€ç®€å•å…¬å¹³çš„åˆ†é…æ–¹å¼**

```
è½®è¯¢ç®—æ³•å°±åƒåˆ†å‘æ‰‘å…‹ç‰Œï¼š
å‘ç‰Œé¡ºåºï¼šA â†’ B â†’ C â†’ A â†’ B â†’ C â†’ ...
æ¯äººéƒ½èƒ½å¾—åˆ°ç›¸ç­‰æ•°é‡çš„ç‰Œ

Nginxè½®è¯¢å·¥ä½œè¿‡ç¨‹ï¼š
ç¬¬1ä¸ªè¯·æ±‚ â†’ æœåŠ¡å™¨A
ç¬¬2ä¸ªè¯·æ±‚ â†’ æœåŠ¡å™¨B  
ç¬¬3ä¸ªè¯·æ±‚ â†’ æœåŠ¡å™¨C
ç¬¬4ä¸ªè¯·æ±‚ â†’ æœåŠ¡å™¨A (é‡æ–°å¼€å§‹å¾ªç¯)
ç¬¬5ä¸ªè¯·æ±‚ â†’ æœåŠ¡å™¨B
...ä»¥æ­¤ç±»æ¨

ç‰¹ç‚¹ï¼š
âœ… å®Œå…¨å…¬å¹³ï¼šæ¯å°æœåŠ¡å™¨å¤„ç†ç›¸åŒæ•°é‡çš„è¯·æ±‚
âœ… ç®€å•å¯é ï¼šç®—æ³•é€»è¾‘ç®€å•ï¼Œä¸å®¹æ˜“å‡ºé”™
âœ… æ— çŠ¶æ€ï¼šä¸éœ€è¦è®°å½•é¢å¤–ä¿¡æ¯
```

### 2.2 è½®è¯¢ç®—æ³•é…ç½®å®è·µ

**ğŸ› ï¸ å®é™…é…ç½®ç¤ºä¾‹**

```nginx
upstream web_servers {
    # é»˜è®¤å°±æ˜¯è½®è¯¢ç®—æ³•ï¼Œæ— éœ€é¢å¤–é…ç½®
    server 10.0.0.10:80;
    server 10.0.0.11:80;
    server 10.0.0.12:80;
}

server {
    listen 80;
    server_name www.example.com;
    
    location / {
        proxy_pass http://web_servers;
        
        # è®¾ç½®ä»£ç†å¤´ä¿¡æ¯
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # è¿æ¥è¶…æ—¶é…ç½®
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
}
```

### 2.3 è½®è¯¢ç®—æ³•çš„é€‚ç”¨åœºæ™¯

**ğŸª ä»€ä¹ˆæ—¶å€™ä½¿ç”¨è½®è¯¢ç®—æ³•**

```
âœ… é€‚åˆçš„åœºæ™¯ï¼š
- åç«¯æœåŠ¡å™¨æ€§èƒ½åŸºæœ¬ç›¸åŒ
- è¯·æ±‚å¤„ç†æ—¶é—´ç›¸å¯¹å›ºå®š
- æ²¡æœ‰ç‰¹æ®Šçš„ä¼šè¯ä¿æŒéœ€æ±‚
- ç³»ç»Ÿåˆšå¼€å§‹éƒ¨ç½²ï¼Œç®€å•å¯é 

âŒ ä¸é€‚åˆçš„åœºæ™¯ï¼š
- æœåŠ¡å™¨æ€§èƒ½å·®å¼‚å¾ˆå¤§
- è¯·æ±‚å¤„ç†å¤æ‚åº¦å·®å¼‚å¤§
- éœ€è¦ä¼šè¯ä¿æŒçš„åº”ç”¨
- å¯¹å“åº”æ—¶é—´è¦æ±‚æé«˜

å®é™…åº”ç”¨ä¾‹å­ï¼š
ğŸ”¸ é™æ€æ–‡ä»¶æœåŠ¡å™¨é›†ç¾¤
ğŸ”¸ APIæ¥å£æœåŠ¡ï¼ˆæ— çŠ¶æ€ï¼‰
ğŸ”¸ å¾®æœåŠ¡æ¶æ„ä¸­çš„æ— çŠ¶æ€æœåŠ¡
```

### 2.4 è½®è¯¢ç®—æ³•çš„ä¼˜ç¼ºç‚¹åˆ†æ

**âš–ï¸ å…¨é¢çš„ä¼˜ç¼ºç‚¹è¯„ä¼°**

| æ–¹é¢ | **ä¼˜åŠ¿** | **åŠ£åŠ¿** |
|------|---------|---------|
| ğŸ”¸ **å…¬å¹³æ€§** | `ç»å¯¹å…¬å¹³åˆ†é…` | `ä¸è€ƒè™‘æœåŠ¡å™¨æ€§èƒ½å·®å¼‚` |
| ğŸ”¸ **å¤æ‚åº¦** | `ç®—æ³•ç®€å•æ˜“æ‡‚` | `æ— æ³•åº”å¯¹å¤æ‚åœºæ™¯` |
| ğŸ”¸ **æ€§èƒ½** | `å‡ ä¹æ— è®¡ç®—å¼€é”€` | `å¯èƒ½å¯¼è‡´æ€§èƒ½ä¸å‡è¡¡` |
| ğŸ”¸ **å¯ç»´æŠ¤æ€§** | `é…ç½®ç®€å•` | `ç¼ºä¹çµæ´»æ€§` |

**ğŸ’¡ æ€§èƒ½å½±å“ç¤ºä¾‹**
```
å‡è®¾æœ‰3å°æœåŠ¡å™¨å¤„ç†èƒ½åŠ›ä¸åŒï¼š
æœåŠ¡å™¨Aï¼šæ¯ç§’å¤„ç†100ä¸ªè¯·æ±‚
æœåŠ¡å™¨Bï¼šæ¯ç§’å¤„ç†50ä¸ªè¯·æ±‚
æœåŠ¡å™¨Cï¼šæ¯ç§’å¤„ç†200ä¸ªè¯·æ±‚

è½®è¯¢ç®—æ³•ç»“æœï¼š
- æ¯å°æœåŠ¡å™¨éƒ½åˆ†åˆ°ç›¸åŒæ•°é‡çš„è¯·æ±‚
- ä½†æœåŠ¡å™¨Bæˆä¸ºç“¶é¢ˆï¼Œæ•´ä½“æ€§èƒ½å—é™
- æœåŠ¡å™¨Cçš„é«˜æ€§èƒ½æ²¡æœ‰å¾—åˆ°å……åˆ†åˆ©ç”¨

è§£å†³æ–¹æ¡ˆï¼š
- ä½¿ç”¨åŠ æƒè½®è¯¢æ ¹æ®æ€§èƒ½åˆ†é…æƒé‡
- æˆ–è€…è€ƒè™‘ä½¿ç”¨æœ€å°‘è¿æ¥ç®—æ³•
```

---

## 3. âš–ï¸ åŠ æƒè½®è¯¢æ·±å…¥ç†è§£


### 3.1 åŠ æƒè½®è¯¢çš„æ ¸å¿ƒæ€æƒ³

**ğŸ¯ æŒ‰èƒ½åŠ›åˆ†é…å·¥ä½œçš„æ™ºèƒ½æ–¹å¼**

```
åŠ æƒè½®è¯¢å°±åƒå·¥å‚çš„ä»»åŠ¡åˆ†é…ï¼š
æ™®é€šå·¥äººï¼šåˆ†é…2ä¸ªä»»åŠ¡
ç†Ÿç»ƒå·¥äººï¼šåˆ†é…3ä¸ªä»»åŠ¡  
æŠ€æœ¯ä¸“å®¶ï¼šåˆ†é…5ä¸ªä»»åŠ¡

æ ¹æ®èƒ½åŠ›åˆ†é…ï¼Œæ—¢å…¬å¹³åˆé«˜æ•ˆ

NginxåŠ æƒè½®è¯¢ï¼š
æœåŠ¡å™¨Aï¼ˆæƒé‡1ï¼‰ï¼šå¤„ç†1/6çš„è¯·æ±‚
æœåŠ¡å™¨Bï¼ˆæƒé‡2ï¼‰ï¼šå¤„ç†2/6çš„è¯·æ±‚
æœåŠ¡å™¨Cï¼ˆæƒé‡3ï¼‰ï¼šå¤„ç†3/6çš„è¯·æ±‚

åˆ†é…é¡ºåºç¤ºä¾‹ï¼ˆæƒé‡A:1, B:2, C:3ï¼‰ï¼š
è¯·æ±‚1 â†’ C (æƒé‡æœ€é«˜ä¼˜å…ˆ)
è¯·æ±‚2 â†’ C 
è¯·æ±‚3 â†’ B
è¯·æ±‚4 â†’ C
è¯·æ±‚5 â†’ B
è¯·æ±‚6 â†’ A
è¯·æ±‚7 â†’ C (æ–°ä¸€è½®å¼€å§‹)
```

### 3.2 åŠ æƒè½®è¯¢é…ç½®è¯¦è§£

**ğŸ”§ æƒé‡é…ç½®çš„å®é™…åº”ç”¨**

```nginx
upstream app_servers {
    # weightå‚æ•°æŒ‡å®šæƒé‡ï¼Œé»˜è®¤ä¸º1
    server 192.168.1.10:8080 weight=1;  # å¤„ç†èƒ½åŠ›ä¸€èˆ¬
    server 192.168.1.11:8080 weight=2;  # å¤„ç†èƒ½åŠ›ä¸­ç­‰
    server 192.168.1.12:8080 weight=3;  # å¤„ç†èƒ½åŠ›æœ€å¼º
    
    # è¿˜å¯ä»¥é…ç½®å…¶ä»–å‚æ•°
    server 192.168.1.13:8080 weight=2 max_fails=3 fail_timeout=30s;
}

server {
    listen 80;
    server_name api.example.com;
    
    location /api/ {
        proxy_pass http://app_servers;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

**ğŸ“Š æƒé‡è®¡ç®—è¯´æ˜**
```
æƒé‡åˆ†é…è®¡ç®—ï¼š
æ€»æƒé‡ = 1 + 2 + 3 = 6

å„æœåŠ¡å™¨åˆ†é…æ¯”ä¾‹ï¼š
æœåŠ¡å™¨Aï¼š1/6 â‰ˆ 16.67%
æœåŠ¡å™¨Bï¼š2/6 â‰ˆ 33.33%  
æœåŠ¡å™¨Cï¼š3/6 = 50%

å¦‚æœæ¯åˆ†é’Ÿæœ‰600ä¸ªè¯·æ±‚ï¼š
æœåŠ¡å™¨Aï¼šå¤„ç†çº¦100ä¸ªè¯·æ±‚
æœåŠ¡å™¨Bï¼šå¤„ç†çº¦200ä¸ªè¯·æ±‚
æœåŠ¡å™¨Cï¼šå¤„ç†çº¦300ä¸ªè¯·æ±‚
```

### 3.3 æƒé‡è®¾ç½®çš„å®ç”¨ç­–ç•¥

**ğŸ’¡ å¦‚ä½•ç§‘å­¦è®¾ç½®æƒé‡å€¼**

```
ğŸ”¸ åŸºäºç¡¬ä»¶é…ç½®è®¾ç½®æƒé‡ï¼š

CPUæ ¸å¿ƒæ•°å‚è€ƒï¼š
2æ ¸å¿ƒæœåŠ¡å™¨ â†’ weight=1
4æ ¸å¿ƒæœåŠ¡å™¨ â†’ weight=2  
8æ ¸å¿ƒæœåŠ¡å™¨ â†’ weight=4

å†…å­˜å®¹é‡å‚è€ƒï¼š
4GBå†…å­˜ â†’ weight=1
8GBå†…å­˜ â†’ weight=2
16GBå†…å­˜ â†’ weight=4

ğŸ”¸ åŸºäºæ€§èƒ½æµ‹è¯•è®¾ç½®æƒé‡ï¼š

å‹åŠ›æµ‹è¯•ç»“æœï¼š
æœåŠ¡å™¨Aï¼šQPS=500 â†’ weight=1
æœåŠ¡å™¨Bï¼šQPS=1000 â†’ weight=2
æœåŠ¡å™¨Cï¼šQPS=1500 â†’ weight=3

ğŸ”¸ åŸºäºç½‘ç»œå¸¦å®½è®¾ç½®æƒé‡ï¼š

100Mbpså¸¦å®½ â†’ weight=1
1Gbpså¸¦å®½ â†’ weight=10
10Gbpså¸¦å®½ â†’ weight=100
```

### 3.4 åŠ¨æ€æƒé‡è°ƒæ•´ç­–ç•¥

**ğŸ”„ è¿è¡Œæ—¶æƒé‡ä¼˜åŒ–**

```nginx
# åœ¨ä¸åœæœçš„æƒ…å†µä¸‹è°ƒæ•´æƒé‡
# ä½¿ç”¨nginx -s reloadé‡æ–°åŠ è½½é…ç½®

upstream dynamic_servers {
    # æ–°æœåŠ¡å™¨åŠ å…¥æ—¶è®¾ç½®è¾ƒä½æƒé‡è§‚å¯Ÿ
    server 192.168.1.10:8080 weight=3;
    server 192.168.1.11:8080 weight=3;
    server 192.168.1.12:8080 weight=1;  # æ–°æœåŠ¡å™¨ï¼Œå…ˆè§‚å¯Ÿ
    
    # æœåŠ¡å™¨å‡ºç°é—®é¢˜æ—¶ä¸´æ—¶é™ä½æƒé‡
    server 192.168.1.13:8080 weight=1 max_fails=2 fail_timeout=60s;
}
```

**âš ï¸ æƒé‡è°ƒæ•´æ³¨æ„äº‹é¡¹**
```
æƒé‡è°ƒæ•´çš„æœ€ä½³å®è·µï¼š

1. æ¸è¿›å¼è°ƒæ•´ï¼š
   - ä¸è¦ä¸€æ¬¡æ€§å¤§å¹…è°ƒæ•´æƒé‡
   - é€æ­¥å¢å‡ï¼Œè§‚å¯Ÿç³»ç»Ÿè¡¨ç°

2. ç›‘æ§é©±åŠ¨ï¼š
   - åŸºäºç›‘æ§æ•°æ®è°ƒæ•´æƒé‡
   - å…³æ³¨CPUã€å†…å­˜ã€å“åº”æ—¶é—´ç­‰æŒ‡æ ‡

3. ä¸šåŠ¡è€ƒè™‘ï¼š
   - é¿å…åœ¨ä¸šåŠ¡é«˜å³°æœŸè°ƒæ•´
   - ä¿ç•™å›æ»šæ–¹æ¡ˆ

4. æ–‡æ¡£è®°å½•ï¼š
   - è®°å½•æ¯æ¬¡è°ƒæ•´çš„åŸå› å’Œç»“æœ
   - å»ºç«‹æƒé‡è°ƒæ•´çš„å†³ç­–æµç¨‹
```

---

## 4. ğŸ” IPå“ˆå¸Œç®—æ³•åŸç†


### 4.1 IPå“ˆå¸Œç®—æ³•çš„å·¥ä½œæœºåˆ¶

**ğŸ¯ ä¼šè¯ç»‘å®šçš„æ™ºèƒ½è§£å†³æ–¹æ¡ˆ**

```
IPå“ˆå¸Œå°±åƒå›ºå®šçš„åœè½¦ä½ï¼š
æ¯ä¸ªè½¦ç‰Œå·(IPåœ°å€) â†’ å¯¹åº”å›ºå®šçš„åœè½¦ä½(æœåŠ¡å™¨)
è½¦ä¸»æ¯æ¬¡æ¥éƒ½åœåœ¨åŒä¸€ä¸ªä½ç½®ï¼Œæ–¹ä¾¿æ‰¾è½¦

Nginx IPå“ˆå¸Œå·¥ä½œåŸç†ï¼š
1. è·å–å®¢æˆ·ç«¯IPåœ°å€
2. å¯¹IPåœ°å€è¿›è¡Œå“ˆå¸Œè®¡ç®—
3. æ ¹æ®å“ˆå¸Œå€¼é€‰æ‹©å¯¹åº”çš„æœåŠ¡å™¨
4. ç›¸åŒIPçš„è¯·æ±‚æ€»æ˜¯åˆ°è¾¾åŒä¸€å°æœåŠ¡å™¨

å“ˆå¸Œè®¡ç®—ç¤ºä¾‹ï¼š
å®¢æˆ·ç«¯IP: 192.168.1.100
å“ˆå¸Œå€¼: hash(192.168.1.100) = 12345
æœåŠ¡å™¨é€‰æ‹©: 12345 % 3 = 0 â†’ é€‰æ‹©ç¬¬1å°æœåŠ¡å™¨

ä¼˜åŠ¿ï¼š
âœ… ä¼šè¯ä¿æŒï¼šç”¨æˆ·çŠ¶æ€ä¿å­˜åœ¨ç‰¹å®šæœåŠ¡å™¨ä¸Š
âœ… ç¼“å­˜æ•ˆç‡ï¼šç›¸åŒç”¨æˆ·çš„ç¼“å­˜å‘½ä¸­ç‡é«˜
âœ… æ•°æ®ä¸€è‡´æ€§ï¼šé¿å…æ•°æ®åœ¨æœåŠ¡å™¨é—´ä¸ä¸€è‡´
```

### 4.2 IPå“ˆå¸Œé…ç½®å®è·µ

**ğŸ”§ ip_hashæŒ‡ä»¤çš„ä½¿ç”¨**

```nginx
upstream session_servers {
    ip_hash;  # å¯ç”¨IPå“ˆå¸Œç®—æ³•
    
    server 192.168.1.10:8080;
    server 192.168.1.11:8080;
    server 192.168.1.12:8080;
    
    # æ³¨æ„ï¼šä½¿ç”¨ip_hashæ—¶ä¸èƒ½è®¾ç½®weightæƒé‡
    # weightå‚æ•°ä¼šè¢«å¿½ç•¥
}

server {
    listen 80;
    server_name shop.example.com;
    
    location / {
        proxy_pass http://session_servers;
        
        # ç¡®ä¿ä¼ é€’çœŸå®IPåœ°å€
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # ä¼šè¯ç›¸å…³çš„ä»£ç†è®¾ç½®
        proxy_set_header Host $host;
        proxy_set_header Connection "";
    }
}
```

### 4.3 IPå“ˆå¸Œçš„é€‚ç”¨åœºæ™¯

**ğŸ›’ ä»€ä¹ˆæ—¶å€™ä½¿ç”¨IPå“ˆå¸Œ**

```
âœ… æœ€é€‚åˆçš„åœºæ™¯ï¼š

1. è´­ç‰©è½¦åº”ç”¨ï¼š
   - ç”¨æˆ·æ·»åŠ å•†å“åˆ°è´­ç‰©è½¦
   - è´­ç‰©è½¦æ•°æ®å­˜å‚¨åœ¨æœåŠ¡å™¨å†…å­˜ä¸­
   - éœ€è¦ä¿è¯ç”¨æˆ·è¯·æ±‚åˆ°åŒä¸€å°æœåŠ¡å™¨

2. åœ¨çº¿æ¸¸æˆï¼š
   - ç©å®¶çŠ¶æ€ä¿å­˜åœ¨ç‰¹å®šæœåŠ¡å™¨
   - é¿å…é¢‘ç¹çš„æ•°æ®åŒæ­¥
   - ä¿è¯æ¸¸æˆä½“éªŒçš„è¿ç»­æ€§

3. æ–‡ä»¶ä¸Šä¼ ï¼š
   - å¤§æ–‡ä»¶åˆ†ç‰‡ä¸Šä¼ 
   - å„ç‰‡æ®µéœ€è¦ä¸Šä¼ åˆ°åŒä¸€å°æœåŠ¡å™¨
   - æœ€ååˆå¹¶æ–‡ä»¶

âŒ ä¸é€‚åˆçš„åœºæ™¯ï¼š

1. é™æ€èµ„æºæœåŠ¡ï¼š
   - æ²¡æœ‰ä¼šè¯çŠ¶æ€éœ€è¦ä¿æŒ
   - è¿½æ±‚æœ€ä¼˜çš„è´Ÿè½½åˆ†é…

2. æ— çŠ¶æ€APIæœåŠ¡ï¼š
   - æ¯ä¸ªè¯·æ±‚éƒ½æ˜¯ç‹¬ç«‹çš„
   - ä¸éœ€è¦ä¿æŒä¼šè¯

3. CDNåŠ é€Ÿåœºæ™¯ï¼š
   - éœ€è¦åœ°ç†ä½ç½®å°±è¿‘åˆ†é…
   - IPå“ˆå¸Œå¯èƒ½å¯¼è‡´è·ç¦»è¿‡è¿œ
```

### 4.4 IPå“ˆå¸Œçš„æ½œåœ¨é—®é¢˜

**âš ï¸ éœ€è¦æ³¨æ„çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ**

```
ğŸ”¸ è´Ÿè½½ä¸å‡è¡¡é—®é¢˜ï¼š

é—®é¢˜åŸå› ï¼š
- æŸäº›IPæ®µçš„ç”¨æˆ·ç‰¹åˆ«å¤š
- å“ˆå¸Œåˆ†å¸ƒå¯èƒ½ä¸å¤Ÿå‡åŒ€
- å¯¼è‡´æŸå°æœåŠ¡å™¨è´Ÿè½½è¿‡é«˜

è§£å†³æ–¹æ¡ˆï¼š
- å¢åŠ æœåŠ¡å™¨æ•°é‡æ”¹å–„åˆ†å¸ƒ
- ç»“åˆä¸€è‡´æ€§å“ˆå¸Œç®—æ³•
- ç›‘æ§å„æœåŠ¡å™¨è´Ÿè½½æƒ…å†µ

ğŸ”¸ ä»£ç†ç¯å¢ƒé—®é¢˜ï¼š

é—®é¢˜ï¼šç”¨æˆ·é€šè¿‡ä»£ç†è®¿é—®ï¼Œçœ‹åˆ°çš„éƒ½æ˜¯ä»£ç†IP
ç»“æœï¼šå¤§é‡ç”¨æˆ·è¢«åˆ†é…åˆ°åŒä¸€å°æœåŠ¡å™¨

è§£å†³æ–¹æ¡ˆï¼š
# ä½¿ç”¨çœŸå®IPè¿›è¡Œå“ˆå¸Œ
map $http_x_forwarded_for $real_ip {
    ~^(\d+\.\d+\.\d+\.\d+) $1;
    default $remote_addr;
}

upstream proxy_aware_servers {
    hash $real_ip consistent;
    server 192.168.1.10:8080;
    server 192.168.1.11:8080;
    server 192.168.1.12:8080;
}

ğŸ”¸ æœåŠ¡å™¨åŠ¨æ€è°ƒæ•´é—®é¢˜ï¼š

é—®é¢˜ï¼šå¢åŠ æˆ–å‡å°‘æœåŠ¡å™¨ä¼šå¯¼è‡´å¤§é‡ä¼šè¯é‡æ–°åˆ†é…
å½±å“ï¼šç”¨æˆ·å¯èƒ½ä¸¢å¤±ç™»å½•çŠ¶æ€æˆ–è´­ç‰©è½¦å†…å®¹

è§£å†³æ–¹æ¡ˆï¼š
- ä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•
- åœ¨ä¸šåŠ¡ä½å³°æœŸè¿›è¡ŒæœåŠ¡å™¨è°ƒæ•´
- å®ç°ä¼šè¯æ•°æ®çš„å¤–éƒ¨å­˜å‚¨ï¼ˆRedisç­‰ï¼‰
```

---

## 5. ğŸ“Š æœ€å°‘è¿æ¥ç®—æ³•


### 5.1 æœ€å°‘è¿æ¥ç®—æ³•çš„æ ¸å¿ƒç†å¿µ

**ğŸ¯ æ™ºèƒ½é€‰æ‹©æœ€ç©ºé—²çš„æœåŠ¡å™¨**

```
æœ€å°‘è¿æ¥å°±åƒé€‰æ‹©æ’é˜Ÿæœ€çŸ­çš„æ”¶é“¶å°ï¼š
æ”¶é“¶å°Aï¼š3ä¸ªäººæ’é˜Ÿ
æ”¶é“¶å°Bï¼š1ä¸ªäººæ’é˜Ÿ  â† é€‰æ‹©è¿™ä¸ª
æ”¶é“¶å°Cï¼š5ä¸ªäººæ’é˜Ÿ

æ–°é¡¾å®¢ä¼šè‡ªåŠ¨é€‰æ‹©æ’é˜Ÿäººæ•°æœ€å°‘çš„æ”¶é“¶å°

Nginxæœ€å°‘è¿æ¥å·¥ä½œåŸç†ï¼š
1. å®æ—¶ç»Ÿè®¡æ¯å°æœåŠ¡å™¨çš„æ´»è·ƒè¿æ¥æ•°
2. æ–°è¯·æ±‚åˆ°æ¥æ—¶é€‰æ‹©è¿æ¥æ•°æœ€å°‘çš„æœåŠ¡å™¨
3. åŠ¨æ€å¹³è¡¡å„æœåŠ¡å™¨çš„è´Ÿè½½

è¿æ¥æ•°ç»Ÿè®¡ç¤ºä¾‹ï¼š
æœåŠ¡å™¨Aï¼šå½“å‰è¿æ¥æ•° 15
æœåŠ¡å™¨Bï¼šå½“å‰è¿æ¥æ•° 8   â† é€‰æ‹©è¿™å°
æœåŠ¡å™¨Cï¼šå½“å‰è¿æ¥æ•° 12

ä¼˜åŠ¿ï¼š
âœ… åŠ¨æ€è´Ÿè½½å‡è¡¡ï¼šå®æ—¶å“åº”æœåŠ¡å™¨è´Ÿè½½å˜åŒ–
âœ… æ€§èƒ½ä¼˜åŒ–ï¼šé¿å…æŸå°æœåŠ¡å™¨è¿‡è½½
âœ… è‡ªé€‚åº”ï¼šé€‚åº”ä¸åŒè¯·æ±‚çš„å¤„ç†æ—¶é—´å·®å¼‚
```

### 5.2 æœ€å°‘è¿æ¥é…ç½®å®ç°

**ğŸ”§ least_connæŒ‡ä»¤çš„ä½¿ç”¨**

```nginx
upstream api_servers {
    least_conn;  # å¯ç”¨æœ€å°‘è¿æ¥ç®—æ³•
    
    server 192.168.1.10:8080 max_conns=100;  # é™åˆ¶æœ€å¤§è¿æ¥æ•°
    server 192.168.1.11:8080 max_conns=150;
    server 192.168.1.12:8080 max_conns=200;
    
    # å¯ä»¥ä¸å…¶ä»–å‚æ•°ç»“åˆä½¿ç”¨
    server 192.168.1.13:8080 weight=2 max_conns=120;
}

server {
    listen 80;
    server_name api.example.com;
    
    location /api/ {
        proxy_pass http://api_servers;
        
        # ä¿æŒè¿æ¥ä»¥ä¾¿å‡†ç¡®ç»Ÿè®¡è¿æ¥æ•°
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        
        # è®¾ç½®é€‚å½“çš„è¶…æ—¶æ—¶é—´
        proxy_connect_timeout 10s;
        proxy_send_timeout 10s;
        proxy_read_timeout 60s;
    }
}
```

### 5.3 åŠ æƒæœ€å°‘è¿æ¥

**âš–ï¸ ç»“åˆæƒé‡çš„æ™ºèƒ½åˆ†é…**

```nginx
upstream weighted_least_conn {
    least_conn;
    
    # æƒé‡ä¼šå½±å“è¿æ¥æ•°çš„è®¡ç®—
    server 192.168.1.10:8080 weight=1;   # ä½æ€§èƒ½æœåŠ¡å™¨
    server 192.168.1.11:8080 weight=2;   # ä¸­æ€§èƒ½æœåŠ¡å™¨  
    server 192.168.1.12:8080 weight=3;   # é«˜æ€§èƒ½æœåŠ¡å™¨
}
```

**ğŸ’¡ åŠ æƒè¿æ¥æ•°è®¡ç®—**
```
åŠ æƒè¿æ¥æ•°è®¡ç®—å…¬å¼ï¼š
åŠ æƒè¿æ¥æ•° = å®é™…è¿æ¥æ•° / æƒé‡

ç¤ºä¾‹æƒ…å†µï¼š
æœåŠ¡å™¨Aï¼šå®é™…è¿æ¥10ï¼Œæƒé‡1 â†’ åŠ æƒè¿æ¥æ•° = 10/1 = 10
æœåŠ¡å™¨Bï¼šå®é™…è¿æ¥16ï¼Œæƒé‡2 â†’ åŠ æƒè¿æ¥æ•° = 16/2 = 8   â† é€‰æ‹©è¿™å°
æœåŠ¡å™¨Cï¼šå®é™…è¿æ¥27ï¼Œæƒé‡3 â†’ åŠ æƒè¿æ¥æ•° = 27/3 = 9

ç»“æœï¼šé€‰æ‹©åŠ æƒè¿æ¥æ•°æœ€å°çš„æœåŠ¡å™¨B
```

### 5.4 æœ€å°‘è¿æ¥ç®—æ³•çš„ä¼˜åŒ–åœºæ™¯

**ğŸš€ ä»€ä¹ˆæ—¶å€™æœ€æœ‰æ•ˆ**

```
âœ… æœ€é€‚åˆçš„åœºæ™¯ï¼š

1. é•¿è¿æ¥æœåŠ¡ï¼š
   - WebSocketè¿æ¥
   - æ•°æ®åº“è¿æ¥æ± 
   - æ–‡ä»¶ä¼ è¾“æœåŠ¡

2. å¤„ç†æ—¶é—´å·®å¼‚å¤§çš„è¯·æ±‚ï¼š
   - å›¾ç‰‡å¤„ç†æœåŠ¡
   - æ•°æ®åˆ†æAPI  
   - æŠ¥è¡¨ç”ŸæˆæœåŠ¡

3. èµ„æºæ¶ˆè€—ä¸å‡åŒ€çš„åº”ç”¨ï¼š
   - è§†é¢‘è½¬ç æœåŠ¡
   - æœºå™¨å­¦ä¹ æ¨ç†æœåŠ¡
   - å¤æ‚æŸ¥è¯¢å¤„ç†

å®é™…æ•ˆæœå¯¹æ¯”ï¼š
è½®è¯¢ç®—æ³•ï¼š
- æœåŠ¡å™¨Aï¼šå¤„ç†3ä¸ªå¤æ‚è¯·æ±‚ï¼Œè´Ÿè½½100%
- æœåŠ¡å™¨Bï¼šå¤„ç†3ä¸ªç®€å•è¯·æ±‚ï¼Œè´Ÿè½½30%
- æœåŠ¡å™¨Cï¼šå¤„ç†3ä¸ªä¸­ç­‰è¯·æ±‚ï¼Œè´Ÿè½½60%

æœ€å°‘è¿æ¥ç®—æ³•ï¼š
- æœåŠ¡å™¨Aï¼šå¤„ç†1ä¸ªå¤æ‚è¯·æ±‚ï¼Œè´Ÿè½½35%
- æœåŠ¡å™¨Bï¼šå¤„ç†5ä¸ªç®€å•è¯·æ±‚ï¼Œè´Ÿè½½25%
- æœåŠ¡å™¨Cï¼šå¤„ç†3ä¸ªä¸­ç­‰è¯·æ±‚ï¼Œè´Ÿè½½60%

ç»“æœï¼šè´Ÿè½½æ›´åŠ å‡è¡¡ï¼Œæ•´ä½“æ€§èƒ½æå‡
```

### 5.5 ç›‘æ§è¿æ¥æ•°çŠ¶æ€

**ğŸ“ˆ è¿æ¥æ•°ç›‘æ§çš„é‡è¦æ€§**

```nginx
# å¯ç”¨çŠ¶æ€ç›‘æ§æ¨¡å—
location /nginx_status {
    stub_status on;
    access_log off;
    allow 127.0.0.1;
    deny all;
}

# é«˜çº§ç›‘æ§é…ç½®
location /upstream_status {
    # éœ€è¦nginx-plusæˆ–ç¬¬ä¸‰æ–¹æ¨¡å—
    upstream_status;
    access_log off;
    allow 192.168.1.0/24;
    deny all;
}
```

**ğŸ“Š è¿æ¥æ•°ç›‘æ§æŒ‡æ ‡**
```
å…³é”®ç›‘æ§æŒ‡æ ‡ï¼š

1. å®æ—¶è¿æ¥æ•°ï¼š
   - å„æœåŠ¡å™¨å½“å‰æ´»è·ƒè¿æ¥
   - è¿æ¥æ•°åˆ†å¸ƒæ˜¯å¦å‡åŒ€
   - è¿æ¥æ•°å˜åŒ–è¶‹åŠ¿

2. è¿æ¥æ•ˆç‡ï¼š
   - å¹³å‡è¿æ¥æŒç»­æ—¶é—´
   - è¿æ¥å»ºç«‹/æ–­å¼€é¢‘ç‡
   - è¿æ¥å¤ç”¨ç‡

3. æ€§èƒ½æŒ‡æ ‡ï¼š
   - å“åº”æ—¶é—´ä¸è¿æ¥æ•°çš„å…³ç³»
   - é”™è¯¯ç‡ä¸è¿æ¥æ•°çš„å…³ç³»
   - ååé‡å˜åŒ–

ç›‘æ§å‘Šè­¦è®¾ç½®ï¼š
- å•æœåŠ¡å™¨è¿æ¥æ•°è¶…è¿‡é˜ˆå€¼
- è¿æ¥æ•°åˆ†å¸ƒä¸¥é‡ä¸å‡
- è¿æ¥å»ºç«‹å¤±è´¥ç‡è¿‡é«˜
```

---

## 6. ğŸ”„ ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•


### 6.1 ä¸€è‡´æ€§å“ˆå¸Œçš„è®¾è®¡æ€æƒ³

**ğŸ¯ è§£å†³ä¼ ç»Ÿå“ˆå¸Œçš„æ‰©å®¹é—®é¢˜**

```
ä¼ ç»Ÿå“ˆå¸Œçš„é—®é¢˜ï¼š
å‡è®¾æœ‰3å°æœåŠ¡å™¨ï¼Œç”¨æˆ·IPå“ˆå¸Œåæ¨¡3åˆ†é…
ç”¨æˆ·Aï¼šhash(IP_A) % 3 = 1 â†’ æœåŠ¡å™¨1
ç”¨æˆ·Bï¼šhash(IP_B) % 3 = 2 â†’ æœåŠ¡å™¨2
ç”¨æˆ·Cï¼šhash(IP_C) % 3 = 0 â†’ æœåŠ¡å™¨0

å½“å¢åŠ åˆ°4å°æœåŠ¡å™¨æ—¶ï¼š
ç”¨æˆ·Aï¼šhash(IP_A) % 4 = 2 â†’ æœåŠ¡å™¨2 (å˜äº†!)
ç”¨æˆ·Bï¼šhash(IP_B) % 4 = 1 â†’ æœåŠ¡å™¨1 (å˜äº†!)
ç”¨æˆ·Cï¼šhash(IP_C) % 4 = 0 â†’ æœåŠ¡å™¨0 (æ²¡å˜)

ç»“æœï¼š2/3çš„ç”¨æˆ·ä¼šè¯ä¸¢å¤±

ä¸€è‡´æ€§å“ˆå¸Œè§£å†³æ–¹æ¡ˆï¼š
æŠŠæœåŠ¡å™¨å’Œç”¨æˆ·éƒ½æ˜ å°„åˆ°ä¸€ä¸ªç¯ä¸Š
å¢å‡æœåŠ¡å™¨æ—¶åªå½±å“é‚»è¿‘çš„ç”¨æˆ·
å¤§éƒ¨åˆ†ç”¨æˆ·çš„æ˜ å°„å…³ç³»ä¿æŒä¸å˜

ä¸€è‡´æ€§å“ˆå¸Œç¯ç¤ºæ„ï¼š
     0Â°
     |
270Â° --- 90Â°  (æœåŠ¡å™¨Aåœ¨45Â°ï¼ŒæœåŠ¡å™¨Båœ¨135Â°ï¼ŒæœåŠ¡å™¨Cåœ¨225Â°)
     |
   180Â°

ç”¨æˆ·åˆ†é…è§„åˆ™ï¼š
é¡ºæ—¶é’ˆæ‰¾åˆ°ç¬¬ä¸€å°æœåŠ¡å™¨
```

### 6.2 Nginxä¸€è‡´æ€§å“ˆå¸Œé…ç½®

**ğŸ”§ consistentå‚æ•°çš„ä½¿ç”¨**

```nginx
upstream consistent_servers {
    # ä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œï¼ŒåŸºäºå®¢æˆ·ç«¯IP
    hash $remote_addr consistent;
    
    server 192.168.1.10:8080;
    server 192.168.1.11:8080;  
    server 192.168.1.12:8080;
}

# åŸºäºURLçš„ä¸€è‡´æ€§å“ˆå¸Œ
upstream url_consistent_servers {
    hash $request_uri consistent;
    
    server 192.168.1.10:8080;
    server 192.168.1.11:8080;
    server 192.168.1.12:8080;
}

# åŸºäºè‡ªå®šä¹‰å˜é‡çš„ä¸€è‡´æ€§å“ˆå¸Œ
upstream custom_consistent_servers {
    hash $arg_user_id consistent;  # åŸºäºURLå‚æ•°user_id
    
    server 192.168.1.10:8080;
    server 192.168.1.11:8080;
    server 192.168.1.12:8080;
}

server {
    listen 80;
    server_name cdn.example.com;
    
    # ç”¨æˆ·ä¼šè¯æœåŠ¡
    location /user/ {
        proxy_pass http://consistent_servers;
    }
    
    # é™æ€èµ„æºç¼“å­˜
    location /static/ {
        proxy_pass http://url_consistent_servers;
        proxy_cache_key $request_uri;
    }
    
    # ç”¨æˆ·ä¸ªæ€§åŒ–æœåŠ¡
    location /personal/ {
        proxy_pass http://custom_consistent_servers;
    }
}
```

### 6.3 ä¸€è‡´æ€§å“ˆå¸Œçš„åº”ç”¨åœºæ™¯

**ğŸª æœ€ä½³åº”ç”¨åœºåˆ**

```
âœ… æœ€é€‚åˆçš„åœºæ™¯ï¼š

1. åˆ†å¸ƒå¼ç¼“å­˜ï¼š
   - ç¼“å­˜æ•°æ®åˆ†å¸ƒåœ¨å¤šå°æœåŠ¡å™¨
   - å¢å‡æœåŠ¡å™¨æ—¶æœ€å°åŒ–ç¼“å­˜å¤±æ•ˆ
   - æé«˜ç¼“å­˜å‘½ä¸­ç‡

2. æœ‰çŠ¶æ€æœåŠ¡æ‰©å®¹ï¼š
   - ç”¨æˆ·ä¼šè¯éœ€è¦ä¿æŒ
   - æœåŠ¡å™¨éœ€è¦åŠ¨æ€æ‰©å®¹
   - æœ€å°åŒ–ä¼šè¯è¿ç§»æˆæœ¬

3. åˆ†ç‰‡å­˜å‚¨ç³»ç»Ÿï¼š
   - æ•°æ®æŒ‰æŸç§è§„åˆ™åˆ†ç‰‡
   - æ”¯æŒåŠ¨æ€æ·»åŠ å­˜å‚¨èŠ‚ç‚¹
   - ä¿æŒæ•°æ®åˆ†å¸ƒç›¸å¯¹ç¨³å®š

å®é™…åº”ç”¨ä¾‹å­ï¼š

CDNèŠ‚ç‚¹é€‰æ‹©ï¼š
- åŸºäºURLå“ˆå¸Œé€‰æ‹©ç¼“å­˜èŠ‚ç‚¹
- å¢åŠ èŠ‚ç‚¹æ—¶å¤§éƒ¨åˆ†ç¼“å­˜ä»ç„¶æœ‰æ•ˆ
- æé«˜æ•´ä½“ç¼“å­˜æ•ˆç‡

åˆ†å¸ƒå¼æ•°æ®åº“ï¼š
- åŸºäºä¸»é”®å“ˆå¸Œé€‰æ‹©åˆ†ç‰‡
- æ‰©å®¹æ—¶åªéœ€è¦è¿ç§»éƒ¨åˆ†æ•°æ®
- ä¿æŒç³»ç»Ÿå¯ç”¨æ€§
```

### 6.4 ä¸€è‡´æ€§å“ˆå¸Œçš„æ€§èƒ½ä¼˜åŒ–

**âš¡ æå‡å“ˆå¸Œåˆ†å¸ƒå‡åŒ€æ€§**

```nginx
# å¢åŠ è™šæ‹ŸèŠ‚ç‚¹æé«˜åˆ†å¸ƒå‡åŒ€æ€§
upstream optimized_consistent {
    # Nginxä¼šè‡ªåŠ¨åˆ›å»ºè™šæ‹ŸèŠ‚ç‚¹
    hash $remote_addr consistent;
    
    # å¯ä»¥é€šè¿‡æƒé‡å½±å“è™šæ‹ŸèŠ‚ç‚¹æ•°é‡
    server 192.168.1.10:8080 weight=3;  # æ›´å¤šè™šæ‹ŸèŠ‚ç‚¹
    server 192.168.1.11:8080 weight=2;
    server 192.168.1.12:8080 weight=1;
}

# åŸºäºå¤šä¸ªå˜é‡çš„å¤åˆå“ˆå¸Œ
map $remote_addr$http_user_agent $client_fingerprint {
    default $remote_addr$http_user_agent;
}

upstream fingerprint_servers {
    hash $client_fingerprint consistent;
    
    server 192.168.1.10:8080;
    server 192.168.1.11:8080;
    server 192.168.1.12:8080;
}
```

**ğŸ“Š æ€§èƒ½ç›‘æ§æŒ‡æ ‡**
```
ä¸€è‡´æ€§å“ˆå¸Œæ•ˆæœè¯„ä¼°ï¼š

1. åˆ†å¸ƒå‡åŒ€æ€§ï¼š
   - å„æœåŠ¡å™¨è´Ÿè½½æ¯”ä¾‹
   - è¯·æ±‚åˆ†å¸ƒçš„æ ‡å‡†å·®
   - ç†æƒ³æƒ…å†µä¸‹åº”è¯¥æ¥è¿‘å¹³å‡åˆ†é…

2. ç¨³å®šæ€§ï¼š
   - å¢å‡æœåŠ¡å™¨æ—¶çš„å½±å“èŒƒå›´
   - ä¼šè¯ä¿æŒçš„æˆåŠŸç‡
   - ç¼“å­˜å‘½ä¸­ç‡çš„å˜åŒ–

3. æ€§èƒ½æŒ‡æ ‡ï¼š
   - å“ˆå¸Œè®¡ç®—å¼€é”€
   - è¯·æ±‚å“åº”æ—¶é—´
   - ç³»ç»Ÿæ•´ä½“ååé‡

ä¼˜åŒ–å»ºè®®ï¼š
- ç›‘æ§å„æœåŠ¡å™¨çš„è´Ÿè½½åˆ†å¸ƒ
- æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´æƒé‡
- å®šæœŸè¯„ä¼°å“ˆå¸Œé”®çš„é€‰æ‹©æ˜¯å¦åˆç†
```

---

## 7. ğŸ”— ä¼šè¯ä¿æŒæœºåˆ¶


### 7.1 ä¼šè¯ä¿æŒçš„é‡è¦æ€§

**ğŸ¯ ä¸ºä»€ä¹ˆéœ€è¦ä¼šè¯ä¿æŒ**

```
ä¼šè¯ä¿æŒå°±åƒé“¶è¡ŒæŸœå°çš„ä¸“å±æœåŠ¡ï¼š
å®¢æˆ·AåŠç†è´·æ¬¾ä¸šåŠ¡ â†’ æŸœå°1 (èµ„æ–™åœ¨æŸœå°1)
å®¢æˆ·Aå†æ¬¡æ¥åŠç† â†’ è¿˜æ˜¯æŸœå°1 (é¿å…é‡å¤æäº¤èµ„æ–™)

Webåº”ç”¨ä¸­çš„ä¼šè¯ä¿æŒï¼š
ç”¨æˆ·ç™»å½• â†’ æœåŠ¡å™¨A (ç™»å½•çŠ¶æ€ä¿å­˜åœ¨A)
ç”¨æˆ·è´­ç‰© â†’ æœåŠ¡å™¨A (è´­ç‰©è½¦æ•°æ®åœ¨A)  
ç”¨æˆ·ç»“è´¦ â†’ æœåŠ¡å™¨A (ä¿æŒå®Œæ•´çš„è´­ç‰©æµç¨‹)

æ²¡æœ‰ä¼šè¯ä¿æŒçš„é—®é¢˜ï¼š
1. ç”¨æˆ·ç™»å½•çŠ¶æ€ä¸¢å¤±
2. è´­ç‰©è½¦å†…å®¹æ¶ˆå¤±
3. è¡¨å•æ•°æ®éœ€è¦é‡æ–°å¡«å†™
4. ç”¨æˆ·ä½“éªŒæå·®

æœ‰äº†ä¼šè¯ä¿æŒçš„å¥½å¤„ï¼š
âœ… ç”¨æˆ·çŠ¶æ€è¿ç»­æ€§
âœ… æ•°æ®ä¸€è‡´æ€§ä¿è¯
âœ… å‡å°‘é‡å¤æ“ä½œ
âœ… æå‡ç”¨æˆ·ä½“éªŒ
```

### 7.2 åŸºäºCookieçš„ä¼šè¯ä¿æŒ

**ğŸª ä½¿ç”¨Cookieå®ç°æœåŠ¡å™¨ç»‘å®š**

```nginx
# ä½¿ç”¨nginx stickyæ¨¡å—å®ç°Cookieä¼šè¯ä¿æŒ
upstream sticky_servers {
    sticky cookie srv_id expires=1h domain=.example.com path=/;
    
    server 192.168.1.10:8080;
    server 192.168.1.11:8080;
    server 192.168.1.12:8080;
}

# æ‰‹åŠ¨å®ç°åŸºäºCookieçš„ä¼šè¯ä¿æŒ
map $cookie_server_id $backend_pool {
    ~server1 backend_1;
    ~server2 backend_2;  
    ~server3 backend_3;
    default backend_1;
}

upstream backend_1 {
    server 192.168.1.10:8080;
}

upstream backend_2 {
    server 192.168.1.11:8080;
}

upstream backend_3 {
    server 192.168.1.12:8080;
}

server {
    listen 80;
    server_name app.example.com;
    
    location / {
        # å¦‚æœæ²¡æœ‰Cookieï¼Œè®¾ç½®é»˜è®¤æœåŠ¡å™¨å¹¶æ·»åŠ Cookie
        if ($cookie_server_id = "") {
            add_header Set-Cookie "server_id=server1; Path=/; Domain=.example.com";
            proxy_pass http://backend_1;
            break;
        }
        
        # æ ¹æ®Cookieé€‰æ‹©åç«¯æœåŠ¡å™¨
        proxy_pass http://$backend_pool;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 7.3 å¤–éƒ¨ä¼šè¯å­˜å‚¨æ–¹æ¡ˆ

**ğŸ—„ï¸ ä½¿ç”¨Redisç­‰å¤–éƒ¨å­˜å‚¨**

```nginx
# é…ç½®Redisä½œä¸ºä¼šè¯å­˜å‚¨
upstream app_cluster {
    server 192.168.1.10:8080;
    server 192.168.1.11:8080;
    server 192.168.1.12:8080;
}

server {
    listen 80;
    server_name webapp.example.com;
    
    location / {
        # æ‰€æœ‰æœåŠ¡å™¨å…±äº«Redisä¼šè¯å­˜å‚¨
        # ä¸éœ€è¦ä¼šè¯ä¿æŒï¼Œå¯ä»¥ä½¿ç”¨ä»»æ„è´Ÿè½½å‡è¡¡ç®—æ³•
        proxy_pass http://app_cluster;
        
        # ä¼ é€’ä¼šè¯ç›¸å…³å¤´ä¿¡æ¯
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # è®¾ç½®è¾ƒé•¿çš„è¿æ¥è¶…æ—¶ï¼ˆå¯¹äºå¤æ‚æ“ä½œï¼‰
        proxy_read_timeout 300s;
    }
}
```

**ğŸ’¡ åº”ç”¨ç¨‹åºé…ç½®ç¤ºä¾‹**
```python
# Python Flaskåº”ç”¨é…ç½®Redisä¼šè¯
from flask import Flask, session
import redis

app = Flask(__name__)
app.config['SESSION_TYPE'] = 'redis'
app.config['SESSION_REDIS'] = redis.from_url('redis://192.168.1.100:6379')
app.config['SESSION_PERMANENT'] = False
app.config['SESSION_USE_SIGNER'] = True
app.config['SESSION_KEY_PREFIX'] = 'webapp:'

# Java Spring Bootåº”ç”¨é…ç½®
# application.yml
spring:
  session:
    store-type: redis
  redis:
    host: 192.168.1.100
    port: 6379
    password: your_password
    database: 0
```

### 7.4 ä¼šè¯ä¿æŒçš„æœ€ä½³å®è·µ

**ğŸ† ç”Ÿäº§ç¯å¢ƒçš„ä¼šè¯ä¿æŒç­–ç•¥**

```
ğŸ”¸ ç­–ç•¥é€‰æ‹©æŒ‡å—ï¼š

1. IPå“ˆå¸Œæ–¹å¼ï¼š
   âœ… é…ç½®ç®€å•ï¼Œæ— éœ€åº”ç”¨æ”¹åŠ¨
   âŒ è´Ÿè½½å¯èƒ½ä¸å‡è¡¡
   ğŸ¯ é€‚åˆï¼šä¼ ç»Ÿåº”ç”¨å¿«é€Ÿè¿ç§»

2. Cookieä¼šè¯ä¿æŒï¼š
   âœ… è´Ÿè½½ç›¸å¯¹å‡è¡¡
   âŒ ä¾èµ–å®¢æˆ·ç«¯Cookieæ”¯æŒ
   ğŸ¯ é€‚åˆï¼šWebåº”ç”¨ï¼Œç”¨æˆ·äº¤äº’å¤š

3. å¤–éƒ¨ä¼šè¯å­˜å‚¨ï¼š
   âœ… å®Œå…¨æ— çŠ¶æ€ï¼Œæœ€ä½³è´Ÿè½½å‡è¡¡
   âŒ å¢åŠ å¤æ‚åº¦å’Œå¤–éƒ¨ä¾èµ–
   ğŸ¯ é€‚åˆï¼šå¾®æœåŠ¡æ¶æ„ï¼Œäº‘åŸç”Ÿåº”ç”¨

æ··åˆç­–ç•¥ç¤ºä¾‹ï¼š
# å…³é”®ä¸šåŠ¡ä½¿ç”¨ä¼šè¯ä¿æŒ
location /admin/ {
    hash $remote_addr consistent;
    proxy_pass http://admin_servers;
}

# APIæœåŠ¡ä½¿ç”¨å¤–éƒ¨å­˜å‚¨
location /api/ {
    least_conn;  # æœ€ä¼˜è´Ÿè½½å‡è¡¡
    proxy_pass http://api_servers;
}

# é™æ€èµ„æºä¸éœ€è¦ä¼šè¯
location /static/ {
    # è½®è¯¢å³å¯
    proxy_pass http://static_servers;
}
```

### 7.5 ä¼šè¯æ•…éšœè½¬ç§»æœºåˆ¶

**ğŸ›¡ï¸ æœåŠ¡å™¨æ•…éšœæ—¶çš„ä¼šè¯å¤„ç†**

```nginx
upstream session_failover {
    # é…ç½®å¥åº·æ£€æŸ¥å’Œæ•…éšœè½¬ç§»
    hash $remote_addr consistent;
    
    server 192.168.1.10:8080 max_fails=3 fail_timeout=30s backup;
    server 192.168.1.11:8080 max_fails=3 fail_timeout=30s;
    server 192.168.1.12:8080 max_fails=3 fail_timeout=30s;
    
    # backupæœåŠ¡å™¨åªåœ¨ä¸»æœåŠ¡å™¨éƒ½æ•…éšœæ—¶ä½¿ç”¨
}

# ä¼šè¯å¤åˆ¶é…ç½®
server {
    listen 80;
    server_name session.example.com;
    
    location / {
        proxy_pass http://session_failover;
        
        # æ•…éšœæ—¶çš„å¤„ç†
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503;
        proxy_next_upstream_tries 2;
        proxy_next_upstream_timeout 10s;
        
        # ä¼šè¯ç›¸å…³å¤´ä¿¡æ¯
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

**âš ï¸ æ•…éšœè½¬ç§»æ³¨æ„äº‹é¡¹**
```
ä¼šè¯æ•…éšœè½¬ç§»ç­–ç•¥ï¼š

1. ä¼˜é›…é™çº§ï¼š
   - ä¸»æœåŠ¡å™¨æ•…éšœæ—¶è‡ªåŠ¨è½¬ç§»
   - ç”¨æˆ·å¯èƒ½éœ€è¦é‡æ–°ç™»å½•
   - æä¾›å‹å¥½çš„é”™è¯¯æç¤º

2. ä¼šè¯å¤‡ä»½ï¼š
   - å…³é”®ä¼šè¯æ•°æ®å®æ—¶å¤‡ä»½
   - æ•…éšœæ—¶ä»å¤‡ä»½æ¢å¤ä¼šè¯
   - å¢åŠ ç³»ç»Ÿå¤æ‚åº¦ä½†ç”¨æˆ·ä½“éªŒæ›´å¥½

3. æ— çŠ¶æ€è®¾è®¡ï¼š
   - æ¨èçš„é•¿è¿œè§£å†³æ–¹æ¡ˆ
   - ä½¿ç”¨JWTæˆ–å¤–éƒ¨å­˜å‚¨
   - æœåŠ¡å™¨æ•…éšœå¯¹ç”¨æˆ·é€æ˜

ç›‘æ§æŒ‡æ ‡ï¼š
- ä¼šè¯ä¿æŒæˆåŠŸç‡
- æ•…éšœè½¬ç§»å“åº”æ—¶é—´
- ç”¨æˆ·é‡æ–°ç™»å½•ç‡
- ç³»ç»Ÿæ•´ä½“å¯ç”¨æ€§
```

---

## 8. ğŸ¯ ç®—æ³•é€‰æ‹©æŒ‡å—


### 8.1 ä¸šåŠ¡åœºæ™¯ä¸ç®—æ³•åŒ¹é…

**ğŸª ä¸åŒä¸šåŠ¡é€‰æ‹©ä¸åŒç®—æ³•**

```
ğŸ”¸ ç”µå•†ç½‘ç«™åœºæ™¯åˆ†æï¼š

å•†å“æµè§ˆé¡µé¢ï¼š
éœ€æ±‚ï¼šé«˜å¹¶å‘ï¼Œæ— çŠ¶æ€
æ¨èï¼šè½®è¯¢ æˆ– åŠ æƒè½®è¯¢
åŸå› ï¼šè¯·æ±‚ç›¸å¯¹ç®€å•ï¼Œè¿½æ±‚æœ€å¤§ååé‡

è´­ç‰©è½¦åŠŸèƒ½ï¼š
éœ€æ±‚ï¼šä¼šè¯ä¿æŒï¼Œç”¨æˆ·ä½“éªŒ
æ¨èï¼šIPå“ˆå¸Œ æˆ– ä¸€è‡´æ€§å“ˆå¸Œ
åŸå› ï¼šè´­ç‰©è½¦æ•°æ®éœ€è¦ä¿æŒåœ¨åŒä¸€æœåŠ¡å™¨

æ”¯ä»˜æµç¨‹ï¼š
éœ€æ±‚ï¼šé«˜å¯é æ€§ï¼Œæ•°æ®ä¸€è‡´æ€§
æ¨èï¼šæœ€å°‘è¿æ¥ + å¤–éƒ¨ä¼šè¯å­˜å‚¨
åŸå› ï¼šæ”¯ä»˜å¤„ç†å¤æ‚ï¼Œéœ€è¦æœ€ä¼˜æ€§èƒ½å’Œæ•°æ®å®‰å…¨

ğŸ”¸ å†…å®¹åˆ†å‘(CDN)åœºæ™¯ï¼š

é™æ€èµ„æºç¼“å­˜ï¼š
éœ€æ±‚ï¼šç¼“å­˜å‘½ä¸­ç‡ï¼Œæ‰©å±•æ€§
æ¨èï¼šä¸€è‡´æ€§å“ˆå¸Œ(åŸºäºURL)
åŸå› ï¼šç›¸åŒURLè®¿é—®åŒä¸€ç¼“å­˜èŠ‚ç‚¹

åŠ¨æ€å†…å®¹APIï¼š
éœ€æ±‚ï¼šå“åº”é€Ÿåº¦ï¼Œè´Ÿè½½å‡è¡¡
æ¨èï¼šæœ€å°‘è¿æ¥
åŸå› ï¼šAPIå¤„ç†æ—¶é—´å·®å¼‚å¤§ï¼Œéœ€è¦åŠ¨æ€å‡è¡¡

ğŸ”¸ ä¼ä¸šå†…éƒ¨ç³»ç»Ÿï¼š

æ–‡ä»¶æœåŠ¡å™¨ï¼š
éœ€æ±‚ï¼šå¤§æ–‡ä»¶ä¼ è¾“ï¼Œé•¿è¿æ¥
æ¨èï¼šæœ€å°‘è¿æ¥ + æƒé‡
åŸå› ï¼šæ–‡ä»¶å¤§å°å·®å¼‚å¤§ï¼Œéœ€è¦è€ƒè™‘æœåŠ¡å™¨æ€§èƒ½

æ•°æ®åº“ä»£ç†ï¼š
éœ€æ±‚ï¼šè¿æ¥æ± ç®¡ç†ï¼Œæ€§èƒ½ä¼˜åŒ–
æ¨èï¼šåŠ æƒè½®è¯¢ + è¿æ¥é™åˆ¶
åŸå› ï¼šæ•°æ®åº“è¿æ¥å®è´µï¼Œéœ€è¦ç²¾ç¡®æ§åˆ¶
```

### 8.2 æ€§èƒ½æµ‹è¯•é©±åŠ¨çš„ç®—æ³•é€‰æ‹©

**ğŸ“Š åŸºäºæ•°æ®åšå†³ç­–**

```bash
# æ€§èƒ½æµ‹è¯•è„šæœ¬ç¤ºä¾‹
#!/bin/bash

# æµ‹è¯•ä¸åŒç®—æ³•çš„æ€§èƒ½è¡¨ç°
test_algorithm() {
    local algorithm=$1
    local config_file="/tmp/nginx_${algorithm}.conf"
    
    # ç”Ÿæˆæµ‹è¯•é…ç½®
    generate_config $algorithm > $config_file
    
    # é‡æ–°åŠ è½½nginxé…ç½®
    nginx -s reload -c $config_file
    
    # æ‰§è¡Œå‹åŠ›æµ‹è¯•
    ab -n 10000 -c 100 http://localhost/ > /tmp/result_${algorithm}.txt
    
    # è§£æç»“æœ
    local rps=$(grep "Requests per second" /tmp/result_${algorithm}.txt | awk '{print $4}')
    local response_time=$(grep "Time per request" /tmp/result_${algorithm}.txt | head -1 | awk '{print $4}')
    
    echo "$algorithm: RPS=$rps, ResponseTime=${response_time}ms"
}

# æµ‹è¯•æ‰€æœ‰ç®—æ³•
for algo in "round_robin" "weighted" "ip_hash" "least_conn"; do
    test_algorithm $algo
    sleep 10  # ç­‰å¾…ç³»ç»Ÿç¨³å®š
done
```

**ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡å¯¹æ¯”è¡¨**

| ç®—æ³•ç±»å‹ | **ååé‡(RPS)** | **å“åº”æ—¶é—´(ms)** | **CPUä½¿ç”¨ç‡** | **å†…å­˜å ç”¨** |
|---------|----------------|----------------|-------------|-------------|
| ğŸ”¸ **è½®è¯¢** | `1200` | `83` | `ä½` | `ä½` |
| ğŸ”¸ **åŠ æƒè½®è¯¢** | `1350` | `74` | `ä½` | `ä½` |
| ğŸ”¸ **IPå“ˆå¸Œ** | `1180` | `85` | `ä¸­` | `ä¸­` |
| ğŸ”¸ **æœ€å°‘è¿æ¥** | `1400` | `71` | `ä¸­` | `ä¸­` |
| ğŸ”¸ **ä¸€è‡´æ€§å“ˆå¸Œ** | `1100` | `91` | `é«˜` | `ä¸­` |

### 8.3 åŠ¨æ€ç®—æ³•åˆ‡æ¢ç­–ç•¥

**ğŸ”„ æ ¹æ®è´Ÿè½½æƒ…å†µåŠ¨æ€è°ƒæ•´**

```nginx
# ä½¿ç”¨mapæŒ‡ä»¤å®ç°åŠ¨æ€ç®—æ³•é€‰æ‹©
map $time_iso8601 $current_hour {
    ~T([0-9]{2}): $1;
}

# æ ¹æ®æ—¶é—´æ®µé€‰æ‹©ä¸åŒçš„ä¸Šæ¸¸
map $current_hour $backend_choice {
    ~^(09|10|11|14|15|16)$ "peak_servers";     # é«˜å³°æœŸ
    ~^(12|13)$ "lunch_servers";                # åˆé¤æ—¶é—´
    default "normal_servers";                   # æ­£å¸¸æ—¶æ®µ
}

# é«˜å³°æœŸé…ç½®ï¼šä½¿ç”¨æœ€å°‘è¿æ¥ç®—æ³•
upstream peak_servers {
    least_conn;
    server 192.168.1.10:8080 weight=3;
    server 192.168.1.11:8080 weight=3;
    server 192.168.1.12:8080 weight=3;
    server 192.168.1.13:8080 weight=2;  # ä¸´æ—¶æ‰©å®¹æœåŠ¡å™¨
}

# åˆé¤æ—¶é—´ï¼šä½¿ç”¨è½®è¯¢ç®—æ³•
upstream lunch_servers {
    server 192.168.1.10:8080;
    server 192.168.1.11:8080;
    # å‡å°‘æœåŠ¡å™¨æ•°é‡èŠ‚çœèµ„æº
}

# æ­£å¸¸æ—¶æ®µï¼šä½¿ç”¨åŠ æƒè½®è¯¢
upstream normal_servers {
    server 192.168.1.10:8080 weight=2;
    server 192.168.1.11:8080 weight=2;
    server 192.168.1.12:8080 weight=1;
}

server {
    listen 80;
    server_name dynamic.example.com;
    
    location / {
        proxy_pass http://$backend_choice;
        proxy_set_header Host $host;
    }
}
```

### 8.4 ç®—æ³•ç»„åˆä½¿ç”¨ç­–ç•¥

**ğŸ¨ æ··åˆç®—æ³•å‘æŒ¥æœ€å¤§æ•ˆæœ**

```nginx
# æ ¹æ®ä¸åŒURLè·¯å¾„ä½¿ç”¨ä¸åŒç®—æ³•
server {
    listen 80;
    server_name multi.example.com;
    
    # é™æ€èµ„æºï¼šä¸€è‡´æ€§å“ˆå¸Œï¼Œæé«˜ç¼“å­˜æ•ˆç‡
    location ~* \.(jpg|jpeg|png|gif|css|js)$ {
        proxy_pass http://static_consistent_servers;
        proxy_cache_key $request_uri;
        expires 1d;
    }
    
    # APIæ¥å£ï¼šæœ€å°‘è¿æ¥ï¼Œä¼˜åŒ–æ€§èƒ½
    location /api/ {
        proxy_pass http://api_least_conn_servers;
        proxy_set_header X-API-Request "true";
    }
    
    # ç”¨æˆ·ç›¸å…³ï¼šIPå“ˆå¸Œï¼Œä¿æŒä¼šè¯
    location /user/ {
        proxy_pass http://user_ip_hash_servers;
        proxy_set_header X-User-Session "maintain";
    }
    
    # ç®¡ç†åå°ï¼šåŠ æƒè½®è¯¢ï¼Œä¸“ç”¨æœåŠ¡å™¨
    location /admin/ {
        proxy_pass http://admin_weighted_servers;
        # é¢å¤–çš„å®‰å…¨å¤´
        proxy_set_header X-Admin-Access "true";
    }
    
    # é»˜è®¤é¡µé¢ï¼šç®€å•è½®è¯¢
    location / {
        proxy_pass http://default_round_robin_servers;
    }
}

# å¯¹åº”çš„upstreamé…ç½®
upstream static_consistent_servers {
    hash $request_uri consistent;
    server 192.168.1.20:8080;
    server 192.168.1.21:8080;
}

upstream api_least_conn_servers {
    least_conn;
    server 192.168.1.30:8080 max_conns=50;
    server 192.168.1.31:8080 max_conns=50;
}

upstream user_ip_hash_servers {
    ip_hash;
    server 192.168.1.40:8080;
    server 192.168.1.41:8080;
}

upstream admin_weighted_servers {
    server 192.168.1.50:8080 weight=3;  # é«˜æ€§èƒ½æœåŠ¡å™¨
    server 192.168.1.51:8080 weight=1;  # å¤‡ç”¨æœåŠ¡å™¨
}

upstream default_round_robin_servers {
    server 192.168.1.10:8080;
    server 192.168.1.11:8080;
    server 192.168.1.12:8080;
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ è½®è¯¢ç®—æ³•ï¼šæœ€ç®€å•å…¬å¹³çš„åˆ†é…æ–¹å¼ï¼Œé€‚åˆåŒè´¨åŒ–æœåŠ¡å™¨
ğŸ”¸ åŠ æƒè½®è¯¢ï¼šæ ¹æ®æœåŠ¡å™¨æ€§èƒ½åˆ†é…æƒé‡ï¼Œæ™ºèƒ½è´Ÿè½½åˆ†é…
ğŸ”¸ IPå“ˆå¸Œï¼šåŸºäºå®¢æˆ·ç«¯IPä¿æŒä¼šè¯ï¼Œè§£å†³çŠ¶æ€ä¿æŒé—®é¢˜
ğŸ”¸ æœ€å°‘è¿æ¥ï¼šåŠ¨æ€é€‰æ‹©æœ€ç©ºé—²æœåŠ¡å™¨ï¼Œé€‚åº”ä¸åŒå¤„ç†æ—¶é—´
ğŸ”¸ ä¸€è‡´æ€§å“ˆå¸Œï¼šè§£å†³æ‰©å®¹æ—¶çš„ä¼šè¯è¿ç§»é—®é¢˜ï¼Œåˆ†å¸ƒå¼å‹å¥½
ğŸ”¸ ä¼šè¯ä¿æŒï¼šç¡®ä¿ç”¨æˆ·çŠ¶æ€è¿ç»­æ€§ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ç®—æ³•é€‰æ‹©çš„æ ¸å¿ƒåŸåˆ™**
```
ä¸šåŠ¡ä¼˜å…ˆï¼š
- æ ¹æ®å®é™…ä¸šåŠ¡éœ€æ±‚é€‰æ‹©ç®—æ³•
- ä¸åŒæ¨¡å—å¯ä»¥ä½¿ç”¨ä¸åŒç®—æ³•
- æ€§èƒ½æµ‹è¯•éªŒè¯é€‰æ‹©çš„æ­£ç¡®æ€§

æ¸è¿›ä¼˜åŒ–ï¼š
- ä»ç®€å•ç®—æ³•å¼€å§‹ï¼ˆè½®è¯¢ï¼‰
- æ ¹æ®é—®é¢˜é€æ­¥ä¼˜åŒ–ï¼ˆåŠ æƒã€å“ˆå¸Œï¼‰
- é¿å…è¿‡åº¦è®¾è®¡

ç›‘æ§é©±åŠ¨ï¼š
- åŸºäºç›‘æ§æ•°æ®è°ƒæ•´ç­–ç•¥
- å…³æ³¨å…³é”®æ€§èƒ½æŒ‡æ ‡
- å®šæœŸè¯„ä¼°å’Œä¼˜åŒ–
```

**ğŸ”¹ ä¼šè¯ä¿æŒçš„ç­–ç•¥å±‚æ¬¡**
```
æŠ€æœ¯å±‚é¢ï¼š
- IPå“ˆå¸Œï¼šç®€å•æœ‰æ•ˆï¼Œä½†æœ‰å±€é™æ€§
- Cookieç»‘å®šï¼šçµæ´»ä½†ä¾èµ–å®¢æˆ·ç«¯
- å¤–éƒ¨å­˜å‚¨ï¼šæœ€ä½³ä½†å¢åŠ å¤æ‚åº¦

æ¶æ„å±‚é¢ï¼š
- å•ä½“åº”ç”¨ï¼šä¼˜å…ˆè€ƒè™‘IPå“ˆå¸Œ
- å¾®æœåŠ¡ï¼šæ¨èå¤–éƒ¨ä¼šè¯å­˜å‚¨
- æ··åˆæ¶æ„ï¼šæŒ‰æ¨¡å—åˆ†åˆ«å¤„ç†

è¿ç»´å±‚é¢ï¼š
- ç›‘æ§ä¼šè¯ä¿æŒæˆåŠŸç‡
- å‡†å¤‡æ•…éšœè½¬ç§»æ–¹æ¡ˆ
- å®šæœŸæµ‹è¯•æ¢å¤æµç¨‹
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–çš„å…³é”®å› ç´ **
```
ç®—æ³•æ•ˆç‡ï¼š
- è½®è¯¢ï¼šè®¡ç®—å¼€é”€æœ€å°
- å“ˆå¸Œï¼šé€‚ä¸­çš„è®¡ç®—å¼€é”€
- æœ€å°‘è¿æ¥ï¼šéœ€è¦çŠ¶æ€ç»´æŠ¤

è´Ÿè½½å‡è¡¡æ€§ï¼š
- è½®è¯¢ï¼šç†è®ºæœ€å‡è¡¡
- åŠ æƒï¼šè€ƒè™‘æœåŠ¡å™¨å·®å¼‚
- æœ€å°‘è¿æ¥ï¼šåŠ¨æ€è‡ªé€‚åº”

æ‰©å±•æ€§ï¼š
- ä¸€è‡´æ€§å“ˆå¸Œï¼šæ‰©å®¹å‹å¥½
- ä¼ ç»Ÿç®—æ³•ï¼šæ‰©å®¹å½±å“å¤§
- å¤–éƒ¨çŠ¶æ€ï¼šæ— çŠ¶æ€æœ€ä½³
```

### 9.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ç”Ÿäº§ç¯å¢ƒåº”ç”¨åœºæ™¯**
- **ç”µå•†å¹³å°**ï¼šè´­ç‰©è½¦ç”¨IPå“ˆå¸Œï¼Œå•†å“å±•ç¤ºç”¨åŠ æƒè½®è¯¢
- **è§†é¢‘ç½‘ç«™**ï¼šè§†é¢‘æœåŠ¡ç”¨ä¸€è‡´æ€§å“ˆå¸Œï¼Œç”¨æˆ·ä¸­å¿ƒç”¨æœ€å°‘è¿æ¥
- **æ¸¸æˆå¹³å°**ï¼šæ¸¸æˆæœåŠ¡å™¨ç”¨IPå“ˆå¸Œï¼Œå……å€¼æ¥å£ç”¨æœ€å°‘è¿æ¥
- **ä¼ä¸šåº”ç”¨**ï¼šOAç³»ç»Ÿç”¨ä¼šè¯ä¿æŒï¼ŒæŠ¥è¡¨ç³»ç»Ÿç”¨æœ€å°‘è¿æ¥

**ğŸ”§ è¿ç»´å®è·µå»ºè®®**
- **åˆ†å±‚è®¾è®¡**ï¼šä¸åŒå±‚æ¬¡ä½¿ç”¨ä¸åŒçš„è´Ÿè½½å‡è¡¡ç­–ç•¥
- **æ¸è¿›ä¼˜åŒ–**ï¼šä»ç®€å•å¼€å§‹ï¼Œæ ¹æ®é—®é¢˜é€æ­¥ä¼˜åŒ–
- **ç›‘æ§å®Œå–„**ï¼šå»ºç«‹å®Œæ•´çš„æ€§èƒ½ç›‘æ§å’Œå‘Šè­¦ä½“ç³»
- **æµ‹è¯•éªŒè¯**ï¼šå®šæœŸè¿›è¡Œæ€§èƒ½æµ‹è¯•å’Œæ•…éšœæ¼”ç»ƒ

**ğŸ“ˆ æŠ€æœ¯å‘å±•è¶‹åŠ¿**
- **æ™ºèƒ½åŒ–**ï¼šåŸºäºæœºå™¨å­¦ä¹ çš„åŠ¨æ€è´Ÿè½½å‡è¡¡
- **äº‘åŸç”Ÿ**ï¼šKubernetesç­‰å¹³å°çš„è´Ÿè½½å‡è¡¡é›†æˆ
- **è¾¹ç¼˜è®¡ç®—**ï¼šCDNè¾¹ç¼˜èŠ‚ç‚¹çš„æ™ºèƒ½è°ƒåº¦
- **å¾®æœåŠ¡**ï¼šæœåŠ¡ç½‘æ ¼ä¸­çš„é«˜çº§è´Ÿè½½å‡è¡¡ç­–ç•¥

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- è½®è¯¢å…¬å¹³æœ€ç®€å•ï¼ŒåŠ æƒæ™ºèƒ½åˆ†é«˜ä½
- å“ˆå¸Œä¿æŒè§£ä¼šè¯ï¼Œè¿æ¥åŠ¨æ€æœ€ä¼˜åŒ–
- ä¸€è‡´æ‰©å®¹ä¸è¿ç§»ï¼Œä¼šè¯ä¿æŒç”¨æˆ·å–œ
- åœºæ™¯åŒ¹é…é€‰ç®—æ³•ï¼Œç›‘æ§ä¼˜åŒ–æ˜¯å…³é”®