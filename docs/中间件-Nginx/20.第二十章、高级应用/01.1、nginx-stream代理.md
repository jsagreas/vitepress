---
title: 1ã€nginx-streamä»£ç†
---
## ğŸ“š ç›®å½•

1. [Streamä»£ç†åŸºæœ¬æ¦‚å¿µ](#1-Streamä»£ç†åŸºæœ¬æ¦‚å¿µ)
2. [å››å±‚ä»£ç†vsä¸ƒå±‚ä»£ç†](#2-å››å±‚ä»£ç†vsä¸ƒå±‚ä»£ç†)
3. [Streamæ¨¡å—é…ç½®](#3-Streamæ¨¡å—é…ç½®)
4. [TCPä»£ç†å®æˆ˜](#4-TCPä»£ç†å®æˆ˜)
5. [UDPä»£ç†å®æˆ˜](#5-UDPä»£ç†å®æˆ˜)
6. [è´Ÿè½½å‡è¡¡é…ç½®](#6-è´Ÿè½½å‡è¡¡é…ç½®)
7. [å¥åº·æ£€æŸ¥æœºåˆ¶](#7-å¥åº·æ£€æŸ¥æœºåˆ¶)
8. [å®é™…åº”ç”¨åœºæ™¯](#8-å®é™…åº”ç”¨åœºæ™¯)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ Streamä»£ç†åŸºæœ¬æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Streamä»£ç†


**ğŸ”¸ ç®€å•ç†è§£**
```
Streamä»£ç†å°±æ˜¯åœ¨ä¼ è¾“å±‚ï¼ˆTCP/UDPå±‚ï¼‰è¿›è¡Œçš„ä»£ç†
ä¸å…³å¿ƒæ•°æ®å†…å®¹æ˜¯ä»€ä¹ˆï¼Œåªè´Ÿè´£æŠŠæ•°æ®åŒ…ä»ä¸€ç«¯è½¬å‘åˆ°å¦ä¸€ç«¯

é€šä¿—æ¯”å–»ï¼š
HTTPä»£ç† = é‚®å±€å·¥ä½œäººå‘˜ä¼šæ‰“å¼€ä¿¡ä»¶æ£€æŸ¥å†…å®¹
Streamä»£ç† = å¿«é€’å‘˜åªè´Ÿè´£æŒ‰åœ°å€é€åŒ…è£¹ï¼Œä¸ç®¡é‡Œé¢è£…ä»€ä¹ˆ
```

**ğŸ’¡ æ ¸å¿ƒç‰¹ç‚¹**
- **å››å±‚ä»£ç†**ï¼šå·¥ä½œåœ¨OSIä¸ƒå±‚æ¨¡å‹çš„ç¬¬4å±‚ï¼ˆä¼ è¾“å±‚ï¼‰
- **åè®®æ— å…³**ï¼šæ”¯æŒä»»ä½•åŸºäºTCP/UDPçš„åè®®
- **é«˜æ€§èƒ½**ï¼šä¸éœ€è¦è§£æåº”ç”¨å±‚åè®®ï¼Œå¤„ç†é€Ÿåº¦å¿«
- **é€æ˜è½¬å‘**ï¼šå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ„ŸçŸ¥ä¸åˆ°ä»£ç†çš„å­˜åœ¨

### 1.2 Streamä»£ç†çš„å·¥ä½œåŸç†


```
å®¢æˆ·ç«¯è¯·æ±‚æµç¨‹ï¼š

å®¢æˆ·ç«¯ â”€â”€â”€â”€TCPè¿æ¥â”€â”€â”€â–º Nginx Stream â”€â”€â”€â”€TCPè¿æ¥â”€â”€â”€â–º åç«¯æœåŠ¡å™¨
   â”‚                      ä»£ç†                        â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ•°æ®é€æ˜è½¬å‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   
åŸç†è¯´æ˜ï¼š
1. å®¢æˆ·ç«¯è¿æ¥åˆ°Nginxçš„æŒ‡å®šç«¯å£
2. Nginxæ ¹æ®é…ç½®é€‰æ‹©åç«¯æœåŠ¡å™¨
3. å»ºç«‹åˆ°åç«¯æœåŠ¡å™¨çš„è¿æ¥
4. åŒå‘é€æ˜è½¬å‘æ‰€æœ‰æ•°æ®åŒ…
5. ä¿æŒè¿æ¥ç›´åˆ°ä»»æ„ä¸€æ–¹æ–­å¼€
```

### 1.3 ä¸ºä»€ä¹ˆéœ€è¦Streamä»£ç†


**ğŸ¯ è§£å†³çš„é—®é¢˜**
- **æ•°æ®åº“ä»£ç†**ï¼šMySQLã€PostgreSQLé›†ç¾¤ä»£ç†
- **ç¼“å­˜ä»£ç†**ï¼šRedisã€Memcachedé›†ç¾¤è´Ÿè½½å‡è¡¡
- **æ¶ˆæ¯é˜Ÿåˆ—**ï¼šRabbitMQã€Kafkaè¿æ¥ä»£ç†
- **æ¸¸æˆæœåŠ¡å™¨**ï¼šå®æ—¶æ¸¸æˆè¿æ¥ä»£ç†
- **VPN/SSH**ï¼šå®‰å…¨è¿æ¥ä»£ç†

---

## 2. ğŸ”„ å››å±‚ä»£ç†vsä¸ƒå±‚ä»£ç†


### 2.1 å·¥ä½œå±‚æ¬¡å¯¹æ¯”


```
OSIä¸ƒå±‚æ¨¡å‹å¯¹æ¯”ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åº”ç”¨å±‚(7)     â”‚                 â”‚   HTTPä»£ç†      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   ä¸ƒå±‚ä»£ç†       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   è¡¨ç¤ºå±‚(6)     â”‚   (HTTPä»£ç†)    â”‚   è§£æHTTP      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ä¼šè¯å±‚(5)     â”‚                 â”‚   å†…å®¹æ„ŸçŸ¥      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ä¼ è¾“å±‚(4)     â”‚   å››å±‚ä»£ç†       â”‚   Streamä»£ç†    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   (Streamä»£ç†)  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ç½‘ç»œå±‚(3)     â”‚                 â”‚   é€æ˜è½¬å‘      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   æ•°æ®é“¾è·¯å±‚(2) â”‚                 â”‚   åè®®æ— å…³      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ç‰©ç†å±‚(1)     â”‚                 â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 åŠŸèƒ½ç‰¹æ€§å¯¹æ¯”


| å¯¹æ¯”é¡¹ç›® | **å››å±‚ä»£ç†ï¼ˆStreamï¼‰** | **ä¸ƒå±‚ä»£ç†ï¼ˆHTTPï¼‰** |
|---------|----------------------|-------------------|
| ğŸ” **å·¥ä½œå±‚æ¬¡** | `ä¼ è¾“å±‚ï¼ˆTCP/UDPï¼‰` | `åº”ç”¨å±‚ï¼ˆHTTPï¼‰` |
| âš¡ **æ€§èƒ½** | `æé«˜ï¼Œæ— åè®®è§£æ` | `è¾ƒé«˜ï¼Œéœ€è§£æHTTP` |
| ğŸ¯ **æ”¯æŒåè®®** | `æ‰€æœ‰TCP/UDPåè®®` | `ä»…HTTP/HTTPSåè®®` |
| ğŸ”§ **é…ç½®å¤æ‚åº¦** | `ç®€å•ï¼Œåªéœ€ç«¯å£æ˜ å°„` | `å¤æ‚ï¼Œæ”¯æŒè·¯å¾„ã€å¤´éƒ¨è·¯ç”±` |
| ğŸ“Š **è´Ÿè½½å‡è¡¡** | `åŸºæœ¬ç®—æ³•ï¼ˆè½®è¯¢ã€æƒé‡ï¼‰` | `é«˜çº§ç®—æ³•ï¼ˆåŸºäºå†…å®¹ï¼‰` |
| ğŸ›¡ï¸ **å®‰å…¨ç‰¹æ€§** | `åŸºç¡€è®¿é—®æ§åˆ¶` | `ä¸°å¯Œï¼ˆWAFã€é™æµã€è®¤è¯ï¼‰` |
| ğŸ” **æ—¥å¿—ä¿¡æ¯** | `è¿æ¥çº§åˆ«ä¿¡æ¯` | `è¯·æ±‚çº§åˆ«è¯¦ç»†ä¿¡æ¯` |

### 2.3 ä½¿ç”¨åœºæ™¯é€‰æ‹©


**ğŸ¯ é€‰æ‹©å››å±‚ä»£ç†çš„åœºæ™¯**
```
âœ… æ•°æ®åº“è¿æ¥ä»£ç†ï¼ˆMySQLã€PostgreSQLï¼‰
âœ… ç¼“å­˜æœåŠ¡ä»£ç†ï¼ˆRedisã€Memcachedï¼‰  
âœ… æ¶ˆæ¯é˜Ÿåˆ—ä»£ç†ï¼ˆRabbitMQã€Kafkaï¼‰
âœ… æ¸¸æˆæœåŠ¡å™¨è¿æ¥
âœ… VPN/SSHè¿æ¥ä»£ç†
âœ… éœ€è¦æé«˜æ€§èƒ½çš„åœºæ™¯
âœ… éHTTPåè®®çš„åº”ç”¨
```

**ğŸ¯ é€‰æ‹©ä¸ƒå±‚ä»£ç†çš„åœºæ™¯**
```
âœ… Webåº”ç”¨ä»£ç†
âœ… APIç½‘å…³
âœ… åŸºäºURLè·¯å¾„çš„è·¯ç”±
âœ… éœ€è¦å†…å®¹æ£€æŸ¥å’Œä¿®æ”¹
âœ… å¤æ‚çš„è´Ÿè½½å‡è¡¡ç­–ç•¥
âœ… Webå®‰å…¨é˜²æŠ¤ï¼ˆWAFï¼‰
```

---

## 3. âš™ï¸ Streamæ¨¡å—é…ç½®


### 3.1 å¯ç”¨Streamæ¨¡å—


**ğŸ”§ æ£€æŸ¥æ¨¡å—æ˜¯å¦å·²å®‰è£…**
```bash
# æ£€æŸ¥nginxæ˜¯å¦åŒ…å«streamæ¨¡å—
nginx -V 2>&1 | grep -o with-stream

# å¦‚æœæ²¡æœ‰è¾“å‡ºï¼Œè¯´æ˜éœ€è¦é‡æ–°ç¼–è¯‘nginx
# æˆ–è€…å®‰è£…åŒ…å«streamæ¨¡å—çš„nginxç‰ˆæœ¬
```

**ğŸ“¦ å®‰è£…åŒ…å«Streamæ¨¡å—çš„Nginx**
```bash
# Ubuntu/Debian
sudo apt-get install nginx-full

# CentOS/RHEL
sudo yum install nginx-mod-stream

# æˆ–ç¼–è¯‘å®‰è£…æ—¶æ·»åŠ 
./configure --with-stream --with-stream_ssl_module
```

### 3.2 åŸºæœ¬é…ç½®ç»“æ„


**ğŸ“‹ é…ç½®æ–‡ä»¶ç»“æ„**
```nginx
# nginx.conf ä¸»é…ç½®æ–‡ä»¶
user nginx;
worker_processes auto;

# é”™è¯¯æ—¥å¿—
error_log /var/log/nginx/error.log;

events {
    worker_connections 1024;
}

# HTTPå—é…ç½®
http {
    # HTTPç›¸å…³é…ç½®...
}

# Streamå—é…ç½®ï¼ˆæ–°å¢ï¼‰
stream {
    # Streamä»£ç†é…ç½®
    upstream backend_mysql {
        server 192.168.1.10:3306;
        server 192.168.1.11:3306;
    }
    
    server {
        listen 3306;
        proxy_pass backend_mysql;
    }
}
```

> ğŸ’¡ **é…ç½®è¦ç‚¹**ï¼šStreamå—ä¸HTTPå—æ˜¯åŒçº§çš„ï¼Œéƒ½åœ¨mainå—å†…

### 3.3 åŸºç¡€é…ç½®æŒ‡ä»¤


**ğŸ”¸ æ ¸å¿ƒæŒ‡ä»¤è¯´æ˜**
```nginx
stream {
    # å®šä¹‰åç«¯æœåŠ¡å™¨ç»„
    upstream backend_name {
        server ip:port [å‚æ•°];
    }
    
    # å®šä¹‰ä»£ç†æœåŠ¡
    server {
        listen port;              # ç›‘å¬ç«¯å£
        proxy_pass backend_name;  # ä»£ç†ç›®æ ‡
        proxy_timeout 1s;         # è¿æ¥è¶…æ—¶
        proxy_connect_timeout 1s; # è¿æ¥å»ºç«‹è¶…æ—¶
    }
}
```

---

## 4. ğŸ—„ï¸ TCPä»£ç†å®æˆ˜


### 4.1 MySQLæ•°æ®åº“ä»£ç†


**ğŸ¯ åº”ç”¨åœºæ™¯**ï¼šä¸ºMySQLä¸»ä»é›†ç¾¤æä¾›ç»Ÿä¸€è®¿é—®å…¥å£

```nginx
stream {
    # å®šä¹‰MySQLåç«¯æœåŠ¡å™¨ç»„
    upstream mysql_cluster {
        server 192.168.1.10:3306 weight=3;  # ä¸»åº“ï¼Œæƒé‡é«˜
        server 192.168.1.11:3306 weight=1;  # ä»åº“1
        server 192.168.1.12:3306 weight=1;  # ä»åº“2
        server 192.168.1.13:3306 backup;    # å¤‡ç”¨åº“
    }
    
    # MySQLä»£ç†æœåŠ¡
    server {
        listen 3306;                    # ç›‘å¬3306ç«¯å£
        proxy_pass mysql_cluster;       # è½¬å‘åˆ°åç«¯é›†ç¾¤
        proxy_timeout 300s;             # ä»£ç†è¶…æ—¶5åˆ†é’Ÿ
        proxy_connect_timeout 10s;      # è¿æ¥è¶…æ—¶10ç§’
        
        # é”™è¯¯æ—¥å¿—
        error_log /var/log/nginx/mysql_proxy.log;
    }
}
```

**ğŸ“Š é…ç½®è¯´æ˜**
- **æƒé‡åˆ†é…**ï¼šä¸»åº“æƒé‡3ï¼Œä»åº“æƒé‡1ï¼Œè¯»å†™åˆ†ç¦»æ•ˆæœ
- **å¤‡ç”¨æœåŠ¡å™¨**ï¼šå½“ä¸»è¦æœåŠ¡å™¨éƒ½ä¸å¯ç”¨æ—¶å¯ç”¨
- **è¶…æ—¶è®¾ç½®**ï¼šè€ƒè™‘æ•°æ®åº“æŸ¥è¯¢å¯èƒ½è¾ƒé•¿ï¼Œè®¾ç½®è¾ƒå¤§è¶…æ—¶å€¼

### 4.2 Redisç¼“å­˜ä»£ç†


**ğŸ¯ åº”ç”¨åœºæ™¯**ï¼šRedisé›†ç¾¤è´Ÿè½½å‡è¡¡å’Œæ•…éšœè½¬ç§»

```nginx
stream {
    # Redisè¯»å†™åˆ†ç¦»é…ç½®
    upstream redis_master {
        server 192.168.1.20:6379;  # Redisä¸»èŠ‚ç‚¹
    }
    
    upstream redis_slaves {
        server 192.168.1.21:6379;  # Redisä»èŠ‚ç‚¹1
        server 192.168.1.22:6379;  # Redisä»èŠ‚ç‚¹2
        least_conn;                 # æœ€å°‘è¿æ¥ç®—æ³•
    }
    
    # Redisä¸»èŠ‚ç‚¹ä»£ç†ï¼ˆå†™æ“ä½œï¼‰
    server {
        listen 6380;
        proxy_pass redis_master;
        proxy_timeout 60s;
        proxy_connect_timeout 5s;
    }
    
    # Redisä»èŠ‚ç‚¹ä»£ç†ï¼ˆè¯»æ“ä½œï¼‰
    server {
        listen 6381;
        proxy_pass redis_slaves;
        proxy_timeout 60s;
        proxy_connect_timeout 5s;
    }
}
```

**ğŸ”§ åº”ç”¨ç«¯é…ç½®**
```python
# Pythonåº”ç”¨ç«¯ä½¿ç”¨ç¤ºä¾‹
import redis

# å†™æ“ä½œè¿æ¥ä¸»èŠ‚ç‚¹ä»£ç†
redis_write = redis.Redis(host='nginx_server', port=6380)

# è¯»æ“ä½œè¿æ¥ä»èŠ‚ç‚¹ä»£ç†  
redis_read = redis.Redis(host='nginx_server', port=6381)

# å†™å…¥æ•°æ®
redis_write.set('key', 'value')

# è¯»å–æ•°æ®
value = redis_read.get('key')
```

### 4.3 SSHè¿æ¥ä»£ç†


**ğŸ¯ åº”ç”¨åœºæ™¯**ï¼šä¸ºå†…ç½‘SSHæœåŠ¡å™¨æä¾›ç»Ÿä¸€è®¿é—®å…¥å£

```nginx
stream {
    # SSHæœåŠ¡å™¨ç»„
    upstream ssh_servers {
        server 10.0.1.10:22;  # å†…ç½‘æœåŠ¡å™¨1
        server 10.0.1.11:22;  # å†…ç½‘æœåŠ¡å™¨2
        server 10.0.1.12:22;  # å†…ç½‘æœåŠ¡å™¨3
        ip_hash;               # åŸºäºIPå“ˆå¸Œï¼Œä¿è¯ä¼šè¯æŒä¹…æ€§
    }
    
    # SSHä»£ç†æœåŠ¡
    server {
        listen 2222;
        proxy_pass ssh_servers;
        proxy_timeout 24h;           # SSHä¼šè¯å¯èƒ½å¾ˆé•¿
        proxy_connect_timeout 30s;
        
        # ä¿æŒè¿æ¥æ´»è·ƒ
        proxy_socket_keepalive on;
    }
}
```

**ğŸ”— å®¢æˆ·ç«¯ä½¿ç”¨**
```bash
# é€šè¿‡ä»£ç†è¿æ¥SSH
ssh -p 2222 user@nginx_server

# ç­‰æ•ˆäºè¿æ¥åˆ°åç«¯æŸå°æœåŠ¡å™¨
# ssh user@10.0.1.10
```

---

## 5. ğŸ“¡ UDPä»£ç†å®æˆ˜


### 5.1 DNSæœåŠ¡ä»£ç†


**ğŸ¯ åº”ç”¨åœºæ™¯**ï¼šä¸ºå†…ç½‘DNSæœåŠ¡å™¨æä¾›è´Ÿè½½å‡è¡¡

```nginx
stream {
    # DNSæœåŠ¡å™¨ç»„
    upstream dns_servers {
        server 8.8.8.8:53;      # Google DNS
        server 8.8.4.4:53;      # Google DNSå¤‡ç”¨
        server 114.114.114.114:53; # 114 DNS
    }
    
    # DNSä»£ç†æœåŠ¡
    server {
        listen 53 udp;           # UDPåè®®
        proxy_pass dns_servers;
        proxy_timeout 1s;        # DNSæŸ¥è¯¢è¶…æ—¶çŸ­
        proxy_responses 1;       # æœŸæœ›çš„å“åº”æ•°é‡
        
        # UDPç¼“å†²åŒºè®¾ç½®
        proxy_bind $remote_addr transparent;
    }
}
```

### 5.2 æ¸¸æˆæœåŠ¡å™¨ä»£ç†


**ğŸ¯ åº”ç”¨åœºæ™¯**ï¼šå¤šä¸ªæ¸¸æˆæœåŠ¡å™¨çš„è´Ÿè½½å‡è¡¡

```nginx
stream {
    # æ¸¸æˆæœåŠ¡å™¨ç»„
    upstream game_servers {
        server 192.168.1.30:7777;
        server 192.168.1.31:7777;
        server 192.168.1.32:7777;
        hash $remote_addr consistent; # ä¸€è‡´æ€§å“ˆå¸Œ
    }
    
    # æ¸¸æˆUDPä»£ç†
    server {
        listen 7777 udp;
        proxy_pass game_servers;
        proxy_timeout 10s;
        proxy_responses 1;
        
        # ä¼šè¯ä¿æŒï¼ˆé‡è¦ï¼‰
        proxy_session_drop off;
    }
}
```

---

## 6. âš–ï¸ è´Ÿè½½å‡è¡¡é…ç½®


### 6.1 è´Ÿè½½å‡è¡¡ç®—æ³•


**ğŸ”„ æ”¯æŒçš„ç®—æ³•ç±»å‹**

| ç®—æ³•åç§° | **é…ç½®æ–¹å¼** | **é€‚ç”¨åœºæ™¯** | **ç‰¹ç‚¹** |
|---------|------------|-------------|----------|
| ğŸ¯ **è½®è¯¢** | `é»˜è®¤é…ç½®` | `æœåŠ¡å™¨æ€§èƒ½ç›¸åŒ` | `è¯·æ±‚ä¾æ¬¡åˆ†å‘` |
| âš–ï¸ **åŠ æƒè½®è¯¢** | `weight=æ•°å­—` | `æœåŠ¡å™¨æ€§èƒ½ä¸åŒ` | `æŒ‰æƒé‡æ¯”ä¾‹åˆ†å‘` |
| ğŸ”— **IPå“ˆå¸Œ** | `ip_hash;` | `éœ€è¦ä¼šè¯ä¿æŒ` | `åŒIPæ€»æ˜¯è®¿é—®åŒä¸€å°` |
| ğŸ“Š **æœ€å°‘è¿æ¥** | `least_conn;` | `é•¿è¿æ¥åº”ç”¨` | `è¿æ¥æ•°æœ€å°‘çš„ä¼˜å…ˆ` |
| ğŸ² **éšæœº** | `random;` | `ç®€å•è´Ÿè½½åˆ†æ•£` | `éšæœºé€‰æ‹©æœåŠ¡å™¨` |
| ğŸ”„ **ä¸€è‡´æ€§å“ˆå¸Œ** | `hash $å˜é‡ consistent;` | `ç¼“å­˜åœºæ™¯` | `å‡å°‘é‡æ–°åˆ†å¸ƒå½±å“` |

### 6.2 å®é™…é…ç½®ç¤ºä¾‹


**âš–ï¸ åŠ æƒè½®è¯¢é…ç½®**
```nginx
stream {
    upstream weighted_backend {
        server 192.168.1.10:3306 weight=5;  # æ€§èƒ½å¥½çš„æœåŠ¡å™¨
        server 192.168.1.11:3306 weight=3;  # æ€§èƒ½ä¸€èˆ¬
        server 192.168.1.12:3306 weight=1;  # æ€§èƒ½è¾ƒå·®
        
        # æƒé‡æ¯”ä¾‹ = 5:3:1
        # å³æ¯9ä¸ªè¯·æ±‚ä¸­ï¼Œç¬¬ä¸€å°å¤„ç†5ä¸ªï¼Œç¬¬äºŒå°3ä¸ªï¼Œç¬¬ä¸‰å°1ä¸ª
    }
    
    server {
        listen 3306;
        proxy_pass weighted_backend;
    }
}
```

**ğŸ”— ä¼šè¯ä¿æŒé…ç½®**
```nginx
stream {
    upstream session_backend {
        # åŸºäºå®¢æˆ·ç«¯IPçš„å“ˆå¸Œ
        hash $remote_addr consistent;
        
        server 192.168.1.10:6379;
        server 192.168.1.11:6379;
        server 192.168.1.12:6379;
    }
    
    server {
        listen 6379;
        proxy_pass session_backend;
    }
}
```

### 6.3 æœåŠ¡å™¨çŠ¶æ€ç®¡ç†


**ğŸ”§ æœåŠ¡å™¨å‚æ•°é…ç½®**
```nginx
upstream backend_with_params {
    server 192.168.1.10:3306 weight=3 max_fails=2 fail_timeout=30s;
    server 192.168.1.11:3306 weight=2 max_fails=3 fail_timeout=60s;
    server 192.168.1.12:3306 backup;  # å¤‡ç”¨æœåŠ¡å™¨
    server 192.168.1.13:3306 down;    # ä¸´æ—¶ä¸‹çº¿
}
```

**ğŸ“‹ å‚æ•°è¯´æ˜**
- `weight=N`ï¼šæƒé‡å€¼ï¼Œé»˜è®¤1
- `max_fails=N`ï¼šå¤±è´¥Næ¬¡åæ ‡è®°ä¸å¯ç”¨
- `fail_timeout=time`ï¼šæ ‡è®°ä¸å¯ç”¨çš„æ—¶é—´
- `backup`ï¼šå¤‡ç”¨æœåŠ¡å™¨ï¼Œä¸»æœåŠ¡å™¨éƒ½å¤±è´¥æ—¶å¯ç”¨
- `down`ï¼šä¸´æ—¶æ ‡è®°æœåŠ¡å™¨ä¸å¯ç”¨

---

## 7. ğŸ¥ å¥åº·æ£€æŸ¥æœºåˆ¶


### 7.1 è¢«åŠ¨å¥åº·æ£€æŸ¥


**ğŸ” å·¥ä½œåŸç†**
```
è¢«åŠ¨æ£€æŸ¥ = åœ¨æ­£å¸¸è¯·æ±‚ä¸­å‘ç°æ•…éšœ

å®¢æˆ·ç«¯è¯·æ±‚ â”€â”€â”€â–º Nginx â”€â”€â”€â–º åç«¯æœåŠ¡å™¨
                â”‚           â”‚
                â”‚           âœ— è¿æ¥å¤±è´¥
                â”‚
                â–¼
        æ ‡è®°æœåŠ¡å™¨ä¸å¯ç”¨ï¼ˆfail_timeoutæ—¶é—´å†…ï¼‰
```

**âš™ï¸ é…ç½®ç¤ºä¾‹**
```nginx
upstream passive_check {
    server 192.168.1.10:3306 max_fails=3 fail_timeout=30s;
    server 192.168.1.11:3306 max_fails=2 fail_timeout=60s;
    
    # è§£é‡Šï¼š
    # ç¬¬ä¸€å°ï¼š3æ¬¡å¤±è´¥åï¼Œ30ç§’å†…ä¸å†å°è¯•
    # ç¬¬äºŒå°ï¼š2æ¬¡å¤±è´¥åï¼Œ60ç§’å†…ä¸å†å°è¯•
}
```

### 7.2 ä¸»åŠ¨å¥åº·æ£€æŸ¥


> âš ï¸ **æ³¨æ„**ï¼šä¸»åŠ¨å¥åº·æ£€æŸ¥éœ€è¦Nginx Pluså•†ä¸šç‰ˆæœ¬æˆ–ç¬¬ä¸‰æ–¹æ¨¡å—

**ğŸ¯ åŸç†è¯´æ˜**
```
ä¸»åŠ¨æ£€æŸ¥ = å®šæœŸä¸»åŠ¨æ¢æµ‹åç«¯æœåŠ¡å™¨çŠ¶æ€

           å®šæ—¶æ¢æµ‹
Nginx â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º åç«¯æœåŠ¡å™¨
  â”‚                      â”‚
  â”‚ â—„â”€â”€â”€ å“åº”æ­£å¸¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                      â”‚
  â–¼                      â”‚
æ ‡è®°æœåŠ¡å™¨å¯ç”¨            â”‚
                         âœ— æ— å“åº”
                         â”‚
                         â–¼
                   æ ‡è®°æœåŠ¡å™¨ä¸å¯ç”¨
```

### 7.3 ç›‘æ§å’Œæ—¥å¿—


**ğŸ“Š å¥åº·çŠ¶æ€ç›‘æ§**
```bash
# æŸ¥çœ‹NginxçŠ¶æ€ï¼ˆéœ€è¦é…ç½®çŠ¶æ€é¡µé¢ï¼‰
curl http://localhost/nginx_status

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
tail -f /var/log/nginx/error.log | grep upstream

# æŸ¥çœ‹è®¿é—®æ—¥å¿—
tail -f /var/log/nginx/access.log
```

**ğŸ“ æ—¥å¿—é…ç½®ä¼˜åŒ–**
```nginx
stream {
    # é”™è¯¯æ—¥å¿—çº§åˆ«
    error_log /var/log/nginx/stream_error.log info;
    
    upstream monitored_backend {
        server 192.168.1.10:3306 max_fails=1 fail_timeout=10s;
        server 192.168.1.11:3306 max_fails=1 fail_timeout=10s;
    }
    
    server {
        listen 3306;
        proxy_pass monitored_backend;
        
        # è®°å½•è¯¦ç»†çš„ä»£ç†ä¿¡æ¯
        error_log /var/log/nginx/mysql_proxy.log debug;
    }
}
```

---

## 8. ğŸš€ å®é™…åº”ç”¨åœºæ™¯


### 8.1 å¾®æœåŠ¡æ¶æ„ä¸­çš„åº”ç”¨


**ğŸ—ï¸ å¾®æœåŠ¡æ•°æ®åº“ä»£ç†**
```
å‰ç«¯åº”ç”¨æ¶æ„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·æœåŠ¡   â”‚    â”‚  è®¢å•æœåŠ¡   â”‚    â”‚  å•†å“æœåŠ¡   â”‚
â”‚  App        â”‚    â”‚  App        â”‚    â”‚  App        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                  â”‚                  â”‚
       â–¼                  â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Nginx Streamâ”‚    â”‚ Nginx Streamâ”‚    â”‚ Nginx Streamâ”‚
â”‚ MySQL Proxy â”‚    â”‚ MySQL Proxy â”‚    â”‚ Redis Proxy â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                  â”‚                  â”‚
       â–¼                  â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   MySQL     â”‚    â”‚   MySQL     â”‚    â”‚   Redis     â”‚
â”‚   é›†ç¾¤      â”‚    â”‚   é›†ç¾¤      â”‚    â”‚   é›†ç¾¤      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 é«˜å¯ç”¨æ•°æ®åº“é›†ç¾¤


**ğŸ¥ ä¸»ä»å¤åˆ¶ + è¯»å†™åˆ†ç¦»**
```nginx
stream {
    # ä¸»åº“ï¼ˆå†™æ“ä½œï¼‰
    upstream mysql_master {
        server 192.168.1.10:3306;
        server 192.168.1.11:3306 backup;  # ä¸»åº“å¤‡ä»½
    }
    
    # ä»åº“ï¼ˆè¯»æ“ä½œï¼‰
    upstream mysql_slaves {
        server 192.168.1.20:3306 weight=2;
        server 192.168.1.21:3306 weight=2;
        server 192.168.1.22:3306 weight=1;
        least_conn;  # æœ€å°‘è¿æ¥ï¼Œé€‚åˆè¯»æ“ä½œ
    }
    
    # å†™æ“ä½œä»£ç†
    server {
        listen 3307;  # å†™ç«¯å£
        proxy_pass mysql_master;
    }
    
    # è¯»æ“ä½œä»£ç†
    server {
        listen 3308;  # è¯»ç«¯å£
        proxy_pass mysql_slaves;
    }
}
```

### 8.3 Redisé›†ç¾¤æ–¹æ¡ˆ


**ğŸ”´ Redis Sentinel + Streamä»£ç†**
```nginx
stream {
    # Redisä¸»èŠ‚ç‚¹ä»£ç†
    upstream redis_master {
        server 192.168.1.30:6379;
    }
    
    # Redisä»èŠ‚ç‚¹ä»£ç†
    upstream redis_slaves {
        server 192.168.1.31:6379;
        server 192.168.1.32:6379;
        server 192.168.1.33:6379;
    }
    
    # Sentinelä»£ç†ï¼ˆç›‘æ§å’Œæ•…éšœè½¬ç§»ï¼‰
    upstream redis_sentinel {
        server 192.168.1.30:26379;
        server 192.168.1.31:26379;
        server 192.168.1.32:26379;
    }
    
    # å†™æ“ä½œ
    server {
        listen 6380;
        proxy_pass redis_master;
    }
    
    # è¯»æ“ä½œ
    server {
        listen 6381;
        proxy_pass redis_slaves;
    }
    
    # Sentinelè®¿é—®
    server {
        listen 26380;
        proxy_pass redis_sentinel;
    }
}
```

### 8.4 æ€§èƒ½ä¼˜åŒ–é…ç½®


**âš¡ é«˜æ€§èƒ½é…ç½®ç¤ºä¾‹**
```nginx
# nginx.conf å…¨å±€ä¼˜åŒ–
worker_processes auto;
worker_cpu_affinity auto;
worker_rlimit_nofile 65535;

events {
    worker_connections 10240;
    use epoll;
    multi_accept on;
}

stream {
    # è¿æ¥æ± ä¼˜åŒ–
    upstream high_performance_backend {
        server 192.168.1.10:3306 max_conns=100;
        server 192.168.1.11:3306 max_conns=100;
        
        # ä¿æŒè¿æ¥
        keepalive 32;
        keepalive_requests 100;
        keepalive_timeout 60s;
    }
    
    server {
        listen 3306 so_keepalive=on;
        proxy_pass high_performance_backend;
        
        # ç¼“å†²åŒºä¼˜åŒ–
        proxy_buffer_size 16k;
        proxy_timeout 600s;
        proxy_connect_timeout 10s;
        
        # TCPä¼˜åŒ–
        proxy_socket_keepalive on;
    }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ”¸ Streamä»£ç†æœ¬è´¨ï¼šå››å±‚ï¼ˆä¼ è¾“å±‚ï¼‰é€æ˜ä»£ç†ï¼Œåè®®æ— å…³
ğŸ”¸ æ ¸å¿ƒä¼˜åŠ¿ï¼šé«˜æ€§èƒ½ã€é€šç”¨æ€§å¼ºã€é…ç½®ç®€å•
ğŸ”¸ ä¸»è¦åº”ç”¨ï¼šæ•°æ®åº“ä»£ç†ã€ç¼“å­˜ä»£ç†ã€æ¸¸æˆæœåŠ¡å™¨ä»£ç†
ğŸ”¸ è´Ÿè½½å‡è¡¡ï¼šæ”¯æŒè½®è¯¢ã€æƒé‡ã€å“ˆå¸Œç­‰å¤šç§ç®—æ³•
ğŸ”¸ å¥åº·æ£€æŸ¥ï¼šè¢«åŠ¨æ£€æŸ¥æœºåˆ¶ï¼Œæ ‡è®°æ•…éšœæœåŠ¡å™¨
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ å››å±‚vsä¸ƒå±‚ä»£ç†çš„é€‰æ‹©**
```
é€‰æ‹©å››å±‚ä»£ç†çš„åœºæ™¯ï¼š
âœ… éHTTPåè®®ï¼ˆMySQLã€Redisã€SSHç­‰ï¼‰
âœ… éœ€è¦æé«˜æ€§èƒ½
âœ… ç®€å•çš„è´Ÿè½½å‡è¡¡éœ€æ±‚
âœ… é€æ˜ä»£ç†éœ€æ±‚

é€‰æ‹©ä¸ƒå±‚ä»£ç†çš„åœºæ™¯ï¼š
âœ… HTTP/HTTPSåº”ç”¨
âœ… éœ€è¦å†…å®¹è·¯ç”±ï¼ˆåŸºäºURLã€å¤´éƒ¨ï¼‰
âœ… éœ€è¦åº”ç”¨å±‚å®‰å…¨é˜²æŠ¤
âœ… å¤æ‚çš„è´Ÿè½½å‡è¡¡ç­–ç•¥
```

**ğŸ”¹ é…ç½®çš„æ ¸å¿ƒè¦ç‚¹**
```
åŸºæœ¬ç»“æ„ï¼š
- Streamå—ä¸HTTPå—åŒçº§
- ä½¿ç”¨upstreamå®šä¹‰åç«¯æœåŠ¡å™¨ç»„
- ä½¿ç”¨serverå—å®šä¹‰ä»£ç†æœåŠ¡

å…³é”®å‚æ•°ï¼š
- proxy_passï¼šæŒ‡å®šä»£ç†ç›®æ ‡
- proxy_timeoutï¼šä»£ç†è¶…æ—¶æ—¶é—´
- weightï¼šæœåŠ¡å™¨æƒé‡
- max_failsï¼šæœ€å¤§å¤±è´¥æ¬¡æ•°
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ’¡ æœ€ä½³å®è·µ**
- **ç›‘å¬ç«¯å£**ï¼šé¿å…ä¸ç°æœ‰æœåŠ¡å†²çªï¼Œé€‰æ‹©åˆé€‚ç«¯å£
- **è¶…æ—¶è®¾ç½®**ï¼šæ ¹æ®åç«¯æœåŠ¡ç‰¹ç‚¹è®¾ç½®åˆç†è¶…æ—¶
- **æƒé‡åˆ†é…**ï¼šæ ¹æ®æœåŠ¡å™¨æ€§èƒ½åˆç†åˆ†é…æƒé‡
- **å¥åº·æ£€æŸ¥**ï¼šé…ç½®é€‚å½“çš„å¤±è´¥é˜ˆå€¼å’Œæ¢å¤æ—¶é—´
- **æ—¥å¿—è®°å½•**ï¼šå¯ç”¨è¯¦ç»†æ—¥å¿—ä¾¿äºé—®é¢˜æ’æŸ¥

**ğŸš¨ å¸¸è§é—®é¢˜é¿å…**
- **ç«¯å£å†²çª**ï¼šç¡®ä¿ç›‘å¬ç«¯å£æœªè¢«å ç”¨
- **æƒé™é—®é¢˜**ï¼šNginxè¿›ç¨‹éœ€è¦ç»‘å®šç«¯å£çš„æƒé™
- **é˜²ç«å¢™**ï¼šç¡®ä¿ç›¸å…³ç«¯å£é˜²ç«å¢™è§„åˆ™æ­£ç¡®
- **å†…æ ¸å‚æ•°**ï¼šé«˜å¹¶å‘æ—¶å¯èƒ½éœ€è¦è°ƒæ•´ç³»ç»Ÿå‚æ•°

**ğŸ”§ æ•…éšœæ’æŸ¥æ­¥éª¤**
1. **æ£€æŸ¥é…ç½®è¯­æ³•**ï¼š`nginx -t`
2. **æŸ¥çœ‹é”™è¯¯æ—¥å¿—**ï¼š`tail -f /var/log/nginx/error.log`
3. **æµ‹è¯•è¿æ¥**ï¼š`telnet nginx_ip proxy_port`
4. **æ£€æŸ¥åç«¯æœåŠ¡**ï¼šç¡®è®¤åç«¯æœåŠ¡å™¨æ­£å¸¸è¿è¡Œ
5. **ç½‘ç»œæ£€æŸ¥**ï¼šç¡®è®¤ç½‘ç»œè¿é€šæ€§

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- Streamä»£ç†å·¥ä½œåœ¨ä¼ è¾“å±‚ï¼Œé€æ˜è½¬å‘æ•°æ®åŒ…
- é€‚ç”¨äºæ‰€æœ‰TCP/UDPåè®®ï¼Œä¸é™äºHTTP
- é…ç½®ç®€å•ä½†åŠŸèƒ½å¼ºå¤§ï¼Œæ˜¯å¾®æœåŠ¡æ¶æ„çš„é‡è¦ç»„ä»¶
- åˆç†é…ç½®è´Ÿè½½å‡è¡¡å’Œå¥åº·æ£€æŸ¥æ˜¯ç¨³å®šè¿è¡Œçš„å…³é”®