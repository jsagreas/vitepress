---
title: 2ã€nginx-websocketä»£ç†
---
## ğŸ“š ç›®å½•

1. [WebSocketåè®®åŸºç¡€ç†è§£](#1-WebSocketåè®®åŸºç¡€ç†è§£)
2. [Nginxä»£ç†WebSocketçš„åŸç†](#2-Nginxä»£ç†WebSocketçš„åŸç†)
3. [åŸºç¡€é…ç½®å®ç°](#3-åŸºç¡€é…ç½®å®ç°)
4. [è´Ÿè½½å‡è¡¡ä¸ä¼šè¯ä¿æŒ](#4-è´Ÿè½½å‡è¡¡ä¸ä¼šè¯ä¿æŒ)
5. [æ•…éšœå¤„ç†ä¸ç›‘æ§](#5-æ•…éšœå¤„ç†ä¸ç›‘æ§)
6. [å®é™…åº”ç”¨åœºæ™¯](#6-å®é™…åº”ç”¨åœºæ™¯)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ WebSocketåè®®åŸºç¡€ç†è§£


### 1.1 ä»€ä¹ˆæ˜¯WebSocket


**ç®€å•ç†è§£**ï¼šWebSocketå°±åƒæ˜¯æµè§ˆå™¨å’ŒæœåŠ¡å™¨ä¹‹é—´å»ºç«‹çš„ä¸€æ¡"ä¸“ç”¨ç”µè¯çº¿"

```
ä¼ ç»ŸHTTPè¯·æ±‚ï¼ˆåƒå‘çŸ­ä¿¡ï¼‰ï¼š
æµè§ˆå™¨ â†’ æœåŠ¡å™¨ï¼šä½ å¥½ï¼Œç»™æˆ‘é¦–é¡µå†…å®¹
æœåŠ¡å™¨ â†’ æµè§ˆå™¨ï¼šå¥½çš„ï¼Œè¿™æ˜¯é¦–é¡µ
[è¿æ¥æ–­å¼€ï¼Œæƒ³å†è¦æ•°æ®å¾—é‡æ–°å‘è¯·æ±‚]

WebSocketè¿æ¥ï¼ˆåƒæ‰“ç”µè¯ï¼‰ï¼š
æµè§ˆå™¨ â†” æœåŠ¡å™¨ï¼šå»ºç«‹è¿æ¥åå¯ä»¥éšæ—¶åŒå‘èŠå¤©
[è¿æ¥ä¿æŒï¼ŒåŒæ–¹éƒ½èƒ½ä¸»åŠ¨å‘æ¶ˆæ¯]
```

### 1.2 WebSocketçš„å·¥ä½œç‰¹ç‚¹


**ğŸ”¸ æ ¸å¿ƒç‰¹å¾**
- **æŒä¹…è¿æ¥**ï¼šä¸€æ¬¡æ¡æ‰‹ï¼Œé•¿æœŸé€šä¿¡
- **åŒå‘é€šä¿¡**ï¼šæœåŠ¡å™¨å¯ä»¥ä¸»åŠ¨æ¨é€æ¶ˆæ¯ç»™å®¢æˆ·ç«¯
- **å®æ—¶æ€§**ï¼šæ¶ˆæ¯ä¼ è¾“å»¶è¿Ÿæä½
- **è½»é‡åè®®**ï¼šæ•°æ®åŒ…å¤´éƒ¨è¾ƒå°ï¼Œä¼ è¾“æ•ˆç‡é«˜

**ğŸ’¡ åè®®å‡çº§è¿‡ç¨‹**
```
ç¬¬ä¸€æ­¥ï¼šå®¢æˆ·ç«¯å‘èµ·å‡çº§è¯·æ±‚
GET /chat HTTP/1.1
Host: example.com
Connection: Upgrade          â† å‘Šè¯‰æœåŠ¡å™¨è¦å‡çº§åè®®
Upgrade: websocket          â† å‡çº§åˆ°WebSocket
Sec-WebSocket-Key: x3JHkwIl... â† å®‰å…¨éªŒè¯å¯†é’¥

ç¬¬äºŒæ­¥ï¼šæœåŠ¡å™¨åŒæ„å‡çº§
HTTP/1.1 101 Switching Protocols  â† 101çŠ¶æ€ç è¡¨ç¤ºåè®®åˆ‡æ¢
Connection: Upgrade
Upgrade: websocket
Sec-WebSocket-Accept: HSmks... â† éªŒè¯å“åº”

ç¬¬ä¸‰æ­¥ï¼šåè®®å‡çº§å®Œæˆï¼Œå¼€å§‹WebSocketé€šä¿¡
```

### 1.3 å¸¸è§åº”ç”¨åœºæ™¯


**ğŸ¯ å®é™…åº”ç”¨**
- **åœ¨çº¿èŠå¤©**ï¼šå¾®ä¿¡ç½‘é¡µç‰ˆã€QQç©ºé—´æ¶ˆæ¯é€šçŸ¥
- **å®æ—¶æ¸¸æˆ**ï¼šç½‘é¡µæ¸¸æˆçš„å®æ—¶å¯¹æˆ˜
- **è‚¡ç¥¨è¡Œæƒ…**ï¼šè‚¡ä»·å®æ—¶æ›´æ–°æ˜¾ç¤º
- **åä½œç¼–è¾‘**ï¼šå¤šäººåŒæ—¶ç¼–è¾‘æ–‡æ¡£ï¼ˆå¦‚è…¾è®¯æ–‡æ¡£ï¼‰
- **è§†é¢‘å¼¹å¹•**ï¼šç›´æ’­é—´å®æ—¶å¼¹å¹•æ˜¾ç¤º

---

## 2. âš™ï¸ Nginxä»£ç†WebSocketçš„åŸç†


### 2.1 ä¸ºä»€ä¹ˆéœ€è¦ä»£ç†


**ğŸ¤” é—®é¢˜èƒŒæ™¯**
æƒ³è±¡ä¸€ä¸ªåœºæ™¯ï¼šä½ å¼€å‘äº†ä¸€ä¸ªèŠå¤©ç½‘ç«™ï¼Œç”¨æˆ·é€šè¿‡æµè§ˆå™¨è¿æ¥WebSocketæœåŠ¡

```
æ²¡æœ‰ä»£ç†çš„é—®é¢˜ï¼š
ç”¨æˆ·æµè§ˆå™¨ â†’ ç›´æ¥è¿æ¥ â†’ WebSocketæœåŠ¡å™¨:8080
- ç”¨æˆ·éœ€è¦è®°ä½ç«¯å£å·
- æ— æ³•è¿›è¡Œè´Ÿè½½å‡è¡¡
- éš¾ä»¥è¿›è¡Œè®¿é—®æ§åˆ¶
- SSLè¯ä¹¦é…ç½®å¤æ‚

ä½¿ç”¨Nginxä»£ç†åï¼š
ç”¨æˆ·æµè§ˆå™¨ â†’ Nginx:80/443 â†’ WebSocketæœåŠ¡å™¨:8080
- ç”¨æˆ·åªéœ€è¦è®¿é—®åŸŸå
- å¯ä»¥è´Ÿè½½å‡è¡¡åˆ°å¤šä¸ªæœåŠ¡å™¨
- ç»Ÿä¸€SSLé…ç½®
- å¯ä»¥è¿›è¡Œè®¿é—®æ§åˆ¶
```

### 2.2 Nginxå¤„ç†WebSocketçš„æœºåˆ¶


**ğŸ”§ å·¥ä½œåŸç†**
```
Nginxçš„è§’è‰²åƒ"æ¥çº¿å‘˜"ï¼š

1. æ¥æ”¶å‡çº§è¯·æ±‚
   å®¢æˆ·ç«¯ â†’ Nginxï¼šæˆ‘è¦å‡çº§åˆ°WebSocket
   Nginxï¼šæ£€æŸ¥è¯·æ±‚æ˜¯å¦åˆæ³•

2. è½¬å‘å‡çº§è¯·æ±‚  
   Nginx â†’ åç«¯æœåŠ¡å™¨ï¼šæœ‰äººè¦å‡çº§WebSocket
   åç«¯æœåŠ¡å™¨ â†’ Nginxï¼šåŒæ„å‡çº§

3. å»ºç«‹é€æ˜é€šé“
   Nginxï¼šå‡çº§æˆåŠŸï¼Œæˆ‘ç°åœ¨å˜æˆ"ä¼ è¯ç­’"
   å®¢æˆ·ç«¯ â†” Nginx â†” åç«¯æœåŠ¡å™¨ï¼ˆæ•°æ®é€æ˜ä¼ è¾“ï¼‰
```

### 2.3 å…³é”®é…ç½®è¦ç‚¹


**ğŸ’¡ æ ¸å¿ƒé…ç½®ç†è§£**
```nginx
# è¿™ä¸‰ä¸ªé…ç½®æ˜¯WebSocketä»£ç†çš„"ä¸‰ä»¶å¥—"
proxy_http_version 1.1;                    # ä½¿ç”¨HTTP/1.1ç‰ˆæœ¬
proxy_set_header Upgrade $http_upgrade;    # è½¬å‘å‡çº§è¯·æ±‚å¤´
proxy_set_header Connection "upgrade";     # è®¾ç½®è¿æ¥ä¸ºå‡çº§æ¨¡å¼
```

**è¯¦ç»†è§£é‡Š**ï¼š
- `proxy_http_version 1.1`ï¼šWebSocketéœ€è¦HTTP/1.1åè®®æ”¯æŒ
- `Upgrade $http_upgrade`ï¼šæŠŠå®¢æˆ·ç«¯çš„å‡çº§è¯·æ±‚åŸæ ·ä¼ é€’ç»™åç«¯
- `Connection "upgrade"`ï¼šå‘Šè¯‰åç«¯è¿™æ˜¯ä¸€ä¸ªåè®®å‡çº§è¯·æ±‚

---

## 3. ğŸ”§ åŸºç¡€é…ç½®å®ç°


### 3.1 æœ€ç®€å•çš„WebSocketä»£ç†


```nginx
server {
    listen 80;
    server_name chat.example.com;
    
    location / {
        # WebSocketä»£ç†çš„åŸºæœ¬é…ç½®
        proxy_pass http://127.0.0.1:8080;
        
        # WebSocketå¿…éœ€çš„ä¸‰ä¸ªé…ç½®
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # ä¼ é€’å®¢æˆ·ç«¯çœŸå®ä¿¡æ¯
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 3.2 å¸¦è¶…æ—¶æ§åˆ¶çš„é…ç½®


```nginx
server {
    listen 80;
    server_name chat.example.com;
    
    location /ws {
        proxy_pass http://websocket_backend;
        
        # WebSocketåŸºç¡€é…ç½®
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # è¶…æ—¶é…ç½®ï¼ˆé‡è¦ï¼ï¼‰
        proxy_connect_timeout 60s;        # è¿æ¥è¶…æ—¶
        proxy_send_timeout 60s;           # å‘é€è¶…æ—¶  
        proxy_read_timeout 600s;          # è¯»å–è¶…æ—¶ï¼ˆWebSocketéœ€è¦æ›´é•¿æ—¶é—´ï¼‰
        
        # ä¼ é€’å®¢æˆ·ç«¯ä¿¡æ¯
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}

upstream websocket_backend {
    server 127.0.0.1:8080;
}
```

### 3.3 HTTPSç¯å¢ƒä¸‹çš„WebSocketé…ç½®


```nginx
server {
    listen 443 ssl;
    server_name chat.example.com;
    
    # SSLé…ç½®
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    location /ws {
        proxy_pass http://websocket_backend;
        
        # WebSocketé…ç½®
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # HTTPSç¯å¢ƒç‰¹æ®Šé…ç½®
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;  # å‘Šè¯‰åç«¯è¿™æ˜¯HTTPSè¯·æ±‚
        
        # è¶…æ—¶é…ç½®
        proxy_read_timeout 600s;
    }
}
```

---

## 4. âš–ï¸ è´Ÿè½½å‡è¡¡ä¸ä¼šè¯ä¿æŒ


### 4.1 WebSocketè´Ÿè½½å‡è¡¡çš„æŒ‘æˆ˜


**ğŸ¤” é—®é¢˜åˆ†æ**
```
æ™®é€šHTTPè¯·æ±‚ï¼š
è¯·æ±‚1 â†’ æœåŠ¡å™¨Aï¼ˆå¤„ç†å®Œå°±ç»“æŸï¼‰
è¯·æ±‚2 â†’ æœåŠ¡å™¨Bï¼ˆå¤„ç†å®Œå°±ç»“æŸï¼‰
è¯·æ±‚3 â†’ æœåŠ¡å™¨Cï¼ˆå¤„ç†å®Œå°±ç»“æŸï¼‰
æ¯ä¸ªè¯·æ±‚ç‹¬ç«‹ï¼Œå¯ä»¥éšæ„åˆ†é…

WebSocketè¿æ¥ï¼š
ç”¨æˆ·å¼ ä¸‰ â†’ æœåŠ¡å™¨Aï¼ˆå»ºç«‹è¿æ¥åéœ€è¦ä¸€ç›´ä¿æŒï¼‰
ç”¨æˆ·æå›› â†’ æœåŠ¡å™¨Bï¼ˆå»ºç«‹è¿æ¥åéœ€è¦ä¸€ç›´ä¿æŒï¼‰
å¦‚æœå¼ ä¸‰çš„æ¶ˆæ¯è¢«åˆ†é…åˆ°æœåŠ¡å™¨Bï¼Œå°±æ‰¾ä¸åˆ°è¿æ¥äº†ï¼
```

### 4.2 IPå“ˆå¸Œè´Ÿè½½å‡è¡¡ï¼ˆæ¨èæ–¹æ¡ˆï¼‰


```nginx
upstream websocket_backend {
    # ä½¿ç”¨IPå“ˆå¸Œï¼Œç¡®ä¿åŒä¸€IPæ€»æ˜¯è¿æ¥åˆ°åŒä¸€å°æœåŠ¡å™¨
    ip_hash;
    
    server 192.168.1.10:8080;
    server 192.168.1.11:8080;
    server 192.168.1.12:8080;
}

server {
    listen 80;
    server_name chat.example.com;
    
    location /ws {
        proxy_pass http://websocket_backend;
        
        # WebSocketåŸºç¡€é…ç½®
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # è¿æ¥ä¿æŒé…ç½®
        proxy_read_timeout 3600s;  # 1å°æ—¶è¶…æ—¶
        proxy_send_timeout 3600s;
    }
}
```

### 4.3 åŸºäºCookieçš„ä¼šè¯ä¿æŒ


```nginx
upstream websocket_backend {
    # åŸºäºcookieè¿›è¡Œè´Ÿè½½å‡è¡¡
    hash $cookie_server_id consistent;
    
    server 192.168.1.10:8080;
    server 192.168.1.11:8080;
    server 192.168.1.12:8080;
}

server {
    listen 80;
    server_name chat.example.com;
    
    # æ™®é€šHTTPè¯·æ±‚ï¼Œè®¾ç½®æœåŠ¡å™¨æ ‡è¯†cookie
    location / {
        proxy_pass http://websocket_backend;
        
        # æ·»åŠ æœåŠ¡å™¨æ ‡è¯†
        add_header Set-Cookie "server_id=$upstream_addr; Path=/; HttpOnly";
    }
    
    # WebSocketè¿æ¥ï¼Œä½¿ç”¨cookieè¿›è¡Œè·¯ç”±
    location /ws {
        proxy_pass http://websocket_backend;
        
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

### 4.4 è´Ÿè½½å‡è¡¡ç®—æ³•å¯¹æ¯”


| ç®—æ³•ç±»å‹ | **å·¥ä½œåŸç†** | **WebSocketé€‚ç”¨æ€§** | **ä¼˜ç¼ºç‚¹** |
|---------|-------------|-------------------|-----------|
| ğŸ”„ **è½®è¯¢** | `ä¾æ¬¡åˆ†é…åˆ°ä¸åŒæœåŠ¡å™¨` | `âŒ ä¸é€‚ç”¨` | `ä¼šå¯¼è‡´è¿æ¥ä¸¢å¤±` |
| ğŸ¯ **IPå“ˆå¸Œ** | `æ ¹æ®å®¢æˆ·ç«¯IPåˆ†é…` | `âœ… æ¨è` | `ç®€å•å¯é ï¼Œä½†IPå˜åŒ–æ—¶æœ‰é—®é¢˜` |
| ğŸª **Cookieå“ˆå¸Œ** | `æ ¹æ®Cookieåˆ†é…` | `âœ… é€‚ç”¨` | `çµæ´»ï¼Œä½†éœ€è¦é¢å¤–é…ç½®` |
| âš¡ **æœ€å°‘è¿æ¥** | `åˆ†é…åˆ°è¿æ¥æ•°æœ€å°‘çš„æœåŠ¡å™¨` | `âŒ ä¸é€‚ç”¨` | `ä¼šç ´åè¿æ¥æŒä¹…æ€§` |

---

## 5. ğŸ› ï¸ æ•…éšœå¤„ç†ä¸ç›‘æ§


### 5.1 å¸¸è§é—®é¢˜è¯Šæ–­


**ğŸ” è¿æ¥å¤±è´¥é—®é¢˜**
```nginx
# é—®é¢˜1ï¼šå¿˜è®°è®¾ç½®HTTPç‰ˆæœ¬
proxy_http_version 1.1;  # å¿…é¡»æœ‰è¿™ä¸€è¡Œï¼

# é—®é¢˜2ï¼šæ²¡æœ‰æ­£ç¡®è½¬å‘Upgradeå¤´
proxy_set_header Upgrade $http_upgrade;      # å¿…é¡»æœ‰ï¼
proxy_set_header Connection "upgrade";       # å¿…é¡»æœ‰ï¼

# é—®é¢˜3ï¼šè¶…æ—¶æ—¶é—´å¤ªçŸ­
proxy_read_timeout 600s;  # WebSocketè¿æ¥éœ€è¦æ›´é•¿è¶…æ—¶æ—¶é—´
```

**âš ï¸ æ•…éšœæ’æŸ¥æ­¥éª¤**
```
ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥Nginxé”™è¯¯æ—¥å¿—
tail -f /var/log/nginx/error.log

ç¬¬äºŒæ­¥ï¼šæ£€æŸ¥è®¿é—®æ—¥å¿—ä¸­çš„çŠ¶æ€ç 
tail -f /var/log/nginx/access.log | grep "101"  # 101è¡¨ç¤ºåè®®å‡çº§æˆåŠŸ

ç¬¬ä¸‰æ­¥ï¼šä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·
Network â†’ WSæ ‡ç­¾ â†’ æŸ¥çœ‹WebSocketè¿æ¥çŠ¶æ€

ç¬¬å››æ­¥ï¼šæµ‹è¯•åç«¯æœåŠ¡å™¨
ç›´æ¥è¿æ¥åç«¯WebSocketæœåŠ¡ï¼Œæ’é™¤Nginxé—®é¢˜
```

### 5.2 å¥åº·æ£€æŸ¥é…ç½®


```nginx
upstream websocket_backend {
    server 192.168.1.10:8080 max_fails=3 fail_timeout=30s;
    server 192.168.1.11:8080 max_fails=3 fail_timeout=30s;
    server 192.168.1.12:8080 backup;  # å¤‡ç”¨æœåŠ¡å™¨
}

server {
    listen 80;
    server_name chat.example.com;
    
    # å¥åº·æ£€æŸ¥é¡µé¢
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
    
    location /ws {
        proxy_pass http://websocket_backend;
        
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # è¿æ¥å¤±è´¥æ—¶çš„å¤„ç†
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503;
    }
}
```

### 5.3 ç›‘æ§é…ç½®


```nginx
# åœ¨httpå—ä¸­æ·»åŠ æ—¥å¿—æ ¼å¼
http {
    log_format websocket '$remote_addr - $remote_user [$time_local] '
                        '"$request" $status $body_bytes_sent '
                        '"$http_referer" "$http_user_agent" '
                        'rt=$request_time ut="$upstream_response_time" '
                        'upgrade="$http_upgrade" connection="$http_connection"';
    
    server {
        listen 80;
        server_name chat.example.com;
        
        location /ws {
            # ä½¿ç”¨ä¸“é—¨çš„æ—¥å¿—æ ¼å¼è®°å½•WebSocketè¿æ¥
            access_log /var/log/nginx/websocket.log websocket;
            
            proxy_pass http://websocket_backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }
}
```

---

## 6. ğŸš€ å®é™…åº”ç”¨åœºæ™¯


### 6.1 åœ¨çº¿èŠå¤©å®¤é…ç½®


```nginx
# èŠå¤©å®¤å®Œæ•´é…ç½®ç¤ºä¾‹
upstream chat_servers {
    ip_hash;  # ç¡®ä¿ç”¨æˆ·è¿æ¥åˆ°åŒä¸€å°æœåŠ¡å™¨
    server 192.168.1.10:3000;
    server 192.168.1.11:3000;
    server 192.168.1.12:3000;
}

server {
    listen 443 ssl http2;
    server_name chat.example.com;
    
    # SSLé…ç½®
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    # é™æ€æ–‡ä»¶ï¼ˆèŠå¤©å®¤é¡µé¢ï¼‰
    location / {
        root /var/www/chat;
        index index.html;
    }
    
    # WebSocketè¿æ¥
    location /socket.io/ {
        proxy_pass http://chat_servers;
        
        # WebSocketé…ç½®
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # ä¼ é€’çœŸå®å®¢æˆ·ç«¯ä¿¡æ¯
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        
        # é•¿è¿æ¥é…ç½®
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }
    
    # APIæ¥å£ï¼ˆæ™®é€šHTTPï¼‰
    location /api/ {
        proxy_pass http://chat_servers;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

### 6.2 è‚¡ç¥¨è¡Œæƒ…æ¨é€é…ç½®


```nginx
upstream stock_servers {
    # è‚¡ç¥¨æ•°æ®æœåŠ¡å™¨
    least_conn;  # ä½¿ç”¨æœ€å°‘è¿æ¥ç®—æ³•
    server 192.168.1.20:8080;
    server 192.168.1.21:8080;
    server 192.168.1.22:8080;
}

map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

server {
    listen 80;
    server_name stock.example.com;
    
    # è‚¡ç¥¨é¡µé¢
    location / {
        root /var/www/stock;
        index index.html;
    }
    
    # å®æ—¶è¡Œæƒ…WebSocket
    location /realtime {
        proxy_pass http://stock_servers;
        
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        
        # çŸ­è¶…æ—¶ï¼Œå¿«é€Ÿæ£€æµ‹æ–­çº¿
        proxy_read_timeout 60s;
        proxy_send_timeout 60s;
        
        # é˜²æ­¢ç¼“å­˜
        proxy_buffering off;
    }
}
```

### 6.3 å¤šäººåä½œç¼–è¾‘é…ç½®


```nginx
upstream collaboration_servers {
    # åŸºäºç”¨æˆ·IDè¿›è¡Œä¼šè¯ä¿æŒ
    hash $arg_userId consistent;
    server 192.168.1.30:4000;
    server 192.168.1.31:4000;
}

server {
    listen 443 ssl;
    server_name docs.example.com;
    
    # SSLé…ç½®
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    # æ–‡æ¡£ç¼–è¾‘é¡µé¢
    location / {
        root /var/www/docs;
        index index.html;
    }
    
    # åä½œç¼–è¾‘WebSocket
    location /collaborate {
        # åªå…è®¸è®¤è¯ç”¨æˆ·è¿æ¥
        auth_request /auth;
        
        proxy_pass http://collaboration_servers;
        
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # ä¼ é€’ç”¨æˆ·è®¤è¯ä¿¡æ¯
        proxy_set_header X-User-ID $arg_userId;
        proxy_set_header X-Document-ID $arg_docId;
        
        # é•¿è¿æ¥é…ç½®
        proxy_read_timeout 1800s;  # 30åˆ†é’Ÿ
    }
    
    # è®¤è¯æ£€æŸ¥
    location = /auth {
        internal;
        proxy_pass http://auth_server/verify;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URI $request_uri;
    }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ”¸ WebSocketæœ¬è´¨ï¼šæµè§ˆå™¨ä¸æœåŠ¡å™¨çš„æŒä¹…åŒå‘é€šä¿¡é€šé“
ğŸ”¸ åè®®å‡çº§ï¼šä»HTTPåè®®å‡çº§åˆ°WebSocketåè®®çš„è¿‡ç¨‹
ğŸ”¸ ä»£ç†åŸç†ï¼šNginxä½œä¸º"ä¼ è¯ç­’"è½¬å‘WebSocketæ•°æ®
ğŸ”¸ ä¼šè¯ä¿æŒï¼šç¡®ä¿åŒä¸€ç”¨æˆ·çš„è¿æ¥å§‹ç»ˆè·¯ç”±åˆ°åŒä¸€æœåŠ¡å™¨
ğŸ”¸ é…ç½®è¦ç‚¹ï¼šHTTP/1.1 + Upgradeå¤´ + Connectionå¤´ æ˜¯ä¸‰è¦ç´ 
```

### 7.2 å…³é”®é…ç½®ç†è§£


**ğŸ”¹ WebSocketä»£ç†ä¸‰è¦ç´ **
```nginx
proxy_http_version 1.1;                    # åè®®ç‰ˆæœ¬
proxy_set_header Upgrade $http_upgrade;    # å‡çº§è¯·æ±‚
proxy_set_header Connection "upgrade";     # è¿æ¥æ¨¡å¼
```

**ğŸ”¹ è¶…æ—¶é…ç½®çš„é‡è¦æ€§**
```
ç†è§£è¦ç‚¹ï¼š
- WebSocketæ˜¯é•¿è¿æ¥ï¼Œéœ€è¦è¾ƒé•¿çš„è¶…æ—¶æ—¶é—´
- proxy_read_timeoutå»ºè®®è®¾ç½®ä¸º600sæˆ–æ›´é•¿
- è¿‡çŸ­çš„è¶…æ—¶ä¼šå¯¼è‡´è¿æ¥æ„å¤–æ–­å¼€
```

**ğŸ”¹ è´Ÿè½½å‡è¡¡ç­–ç•¥é€‰æ‹©**
```
ip_hashï¼šæœ€ç®€å•å¯é çš„æ–¹æ¡ˆ
hash $cookie_xxxï¼šæ›´çµæ´»çš„ä¼šè¯ä¿æŒ
è½®è¯¢/æœ€å°‘è¿æ¥ï¼šä¸é€‚ç”¨äºWebSocket
```

### 7.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ’¡ é…ç½®æœ€ä½³å®è·µ**
- æ€»æ˜¯ä½¿ç”¨`ip_hash`æˆ–åŸºäºsessionçš„è´Ÿè½½å‡è¡¡
- è®¾ç½®åˆé€‚çš„è¶…æ—¶æ—¶é—´ï¼ˆå»ºè®®600s+ï¼‰
- é…ç½®å¥åº·æ£€æŸ¥å’Œæ•…éšœè½¬ç§»
- ä½¿ç”¨SSLæ—¶è¦æ­£ç¡®ä¼ é€’åè®®ä¿¡æ¯

**âš ï¸ å¸¸è§é—®é¢˜é¿å…**
- å¿˜è®°è®¾ç½®`proxy_http_version 1.1`
- è¶…æ—¶æ—¶é—´è®¾ç½®è¿‡çŸ­å¯¼è‡´è¿æ¥æ–­å¼€
- ä½¿ç”¨ä¸å½“çš„è´Ÿè½½å‡è¡¡ç®—æ³•
- æ²¡æœ‰è€ƒè™‘ä¼šè¯ä¿æŒé—®é¢˜

**ğŸš€ ç›‘æ§å’Œç»´æŠ¤**
- ç›‘æ§WebSocketè¿æ¥æ•°å’ŒçŠ¶æ€
- è®°å½•ä¸“é—¨çš„WebSocketè®¿é—®æ—¥å¿—
- è®¾ç½®åˆç†çš„å¥åº·æ£€æŸ¥æœºåˆ¶
- å‡†å¤‡æ•…éšœåˆ‡æ¢é¢„æ¡ˆ

**æ ¸å¿ƒè®°å¿†**ï¼š
- WebSocket = æŒä¹…è¿æ¥ + åŒå‘é€šä¿¡
- Nginxä»£ç† = åè®®å‡çº§ + æ•°æ®è½¬å‘  
- è´Ÿè½½å‡è¡¡ = ä¼šè¯ä¿æŒ + æ•…éšœè½¬ç§»
- é…ç½®è¦ç‚¹ = ä¸‰è¦ç´  + è¶…æ—¶ + ç›‘æ§