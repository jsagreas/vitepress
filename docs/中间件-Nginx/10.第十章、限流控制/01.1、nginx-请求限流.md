---
title: 1ã€nginx-è¯·æ±‚é™æµ
---
## ğŸ“š ç›®å½•

1. [ä»€ä¹ˆæ˜¯è¯·æ±‚é™æµ](#1-ä»€ä¹ˆæ˜¯è¯·æ±‚é™æµ)
2. [limit_reqæ¨¡å—åŸºç¡€](#2-limit_reqæ¨¡å—åŸºç¡€)
3. [æ¼æ¡¶ç®—æ³•åŸç†](#3-æ¼æ¡¶ç®—æ³•åŸç†)
4. [é™æµé…ç½®è¯¦è§£](#4-é™æµé…ç½®è¯¦è§£)
5. [çªå‘è¯·æ±‚å¤„ç†](#5-çªå‘è¯·æ±‚å¤„ç†)
6. [é™æµçŠ¶æ€ç ä¸é”™è¯¯å¤„ç†](#6-é™æµçŠ¶æ€ç ä¸é”™è¯¯å¤„ç†)
7. [å®é™…åº”ç”¨åœºæ™¯](#7-å®é™…åº”ç”¨åœºæ™¯)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸš¦ ä»€ä¹ˆæ˜¯è¯·æ±‚é™æµ


### 1.1 é™æµçš„é€šä¿—ç†è§£


**ç”Ÿæ´»ä¸­çš„é™æµ**å°±åƒé«˜é€Ÿå…¬è·¯æ”¶è´¹ç«™ä¸€æ ·ï¼š

```
ç°å®åœºæ™¯å¯¹æ¯”ï¼š
é«˜é€Ÿæ”¶è´¹ç«™ â†’ æ§åˆ¶è½¦è¾†é€šè¿‡é€Ÿåº¦ï¼Œé¿å…æ‹¥å µ
é“¶è¡ŒATMæœº â†’ é™åˆ¶æ¯äººæ¯å¤©å–æ¬¾æ¬¡æ•°å’Œé‡‘é¢
ç”µå½±é™¢æ£€ç¥¨ â†’ æ§åˆ¶è§‚ä¼—è¿›åœºé€Ÿåº¦ï¼Œç»´æŒç§©åº

ç½‘ç«™é™æµ â†’ æ§åˆ¶ç”¨æˆ·è®¿é—®é¢‘ç‡ï¼Œä¿æŠ¤æœåŠ¡å™¨
```

**é™æµçš„æœ¬è´¨ç›®çš„**ï¼š
- **ä¿æŠ¤æœåŠ¡å™¨**ï¼šé˜²æ­¢ç¬é—´å¤§é‡è¯·æ±‚å‹å®ç³»ç»Ÿ
- **ä¿è¯æœåŠ¡è´¨é‡**ï¼šè®©æ­£å¸¸ç”¨æˆ·éƒ½èƒ½ç¨³å®šè®¿é—®
- **é˜²æ­¢æ¶æ„æ”»å‡»**ï¼šé˜»æ­¢DDoSæ”»å‡»å’Œçˆ¬è™«æ»¥ç”¨
- **èµ„æºå…¬å¹³åˆ†é…**ï¼šé¿å…ä¸ªåˆ«ç”¨æˆ·å ç”¨è¿‡å¤šèµ„æº

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦é™æµ


**æ²¡æœ‰é™æµçš„å±é™©**ï¼š

```
å±é™©åœºæ™¯ç¤ºä¾‹ï¼š
ç½‘ç«™çªç„¶è¢«çƒ­ç‚¹æ–°é—»æåŠ â†’ ç¬é—´æ¶Œå…¥10ä¸‡ç”¨æˆ·
æœåŠ¡å™¨é…ç½®ï¼šåªèƒ½åŒæ—¶å¤„ç†1000ä¸ªè¯·æ±‚
ç»“æœï¼šæœåŠ¡å™¨å´©æºƒï¼Œæ‰€æœ‰ç”¨æˆ·éƒ½æ— æ³•è®¿é—®

æ¶æ„æ”»å‡»åœºæ™¯ï¼š
æ”»å‡»è€…ç”¨è„šæœ¬æ¯ç§’å‘é€1000æ¬¡è¯·æ±‚
æ­£å¸¸ç”¨æˆ·ï¼šæ¯åˆ†é’Ÿè®¿é—®å‡ æ¬¡
ç»“æœï¼šæ­£å¸¸ç”¨æˆ·è¢«æŒ¤å‡ºï¼Œç½‘ç«™å˜æ…¢ç”šè‡³æ— æ³•è®¿é—®
```

> ğŸ’¡ **æ ¸å¿ƒç†è§£**  
> é™æµå°±åƒç»™ç½‘ç«™è£…äº†ä¸€ä¸ª"æ™ºèƒ½é—¨å«"ï¼Œæ§åˆ¶è®¿å®¢è¿›å…¥çš„é€Ÿåº¦ï¼Œæ—¢ä¿æŠ¤æˆ¿å­ä¸è¢«æŒ¤å¡Œï¼Œåˆç¡®ä¿æ¯ä¸ªå®¢äººéƒ½èƒ½å¾—åˆ°å¥½çš„æœåŠ¡ã€‚

### 1.3 é™æµä¸å…¶ä»–æ§åˆ¶æ–¹å¼çš„åŒºåˆ«


| æ§åˆ¶æ–¹å¼ | **ä½œç”¨å¯¹è±¡** | **æ§åˆ¶ç›®æ ‡** | **ç”Ÿæ´»æ¯”å–»** |
|---------|-------------|-------------|-------------|
| **é™æµ** | `è¯·æ±‚é¢‘ç‡` | æ§åˆ¶è®¿é—®é€Ÿåº¦ | é«˜é€Ÿæ”¶è´¹ç«™é™é€Ÿ |
| **é™è¿** | `è¿æ¥æ•°é‡` | æ§åˆ¶åŒæ—¶è¿æ¥ | é¤å…é™åˆ¶åº§ä½æ•° |
| **è®¿é—®æ§åˆ¶** | `ç”¨æˆ·èº«ä»½` | æ§åˆ¶è®¿é—®æƒé™ | ä¼šå‘˜å¡å‡†å…¥åˆ¶ |
| **è´Ÿè½½å‡è¡¡** | `æœåŠ¡å™¨é€‰æ‹©` | åˆ†æ•£è®¿é—®å‹åŠ› | å¤šä¸ªæ”¶é“¶å°åˆ†æµ |

---

## 2. ğŸ› ï¸ limit_reqæ¨¡å—åŸºç¡€


### 2.1 limit_reqæ¨¡å—ç®€ä»‹


**limit_reqæ¨¡å—**æ˜¯Nginxå†…ç½®çš„è¯·æ±‚é™æµæ¨¡å—ï¼ŒåŸºäº**æ¼æ¡¶ç®—æ³•**å®ç°ã€‚

**æ¨¡å—ä½œç”¨**ï¼š
- é™åˆ¶å•ä¸ªIPçš„è¯·æ±‚é¢‘ç‡
- æ”¯æŒçªå‘è¯·æ±‚ç¼“å­˜
- å¯è‡ªå®šä¹‰é™æµè§„åˆ™å’Œå“åº”

### 2.2 åŸºç¡€é…ç½®è¯­æ³•


**ç¬¬ä¸€æ­¥ï¼šå®šä¹‰é™æµåŒºåŸŸ**
```nginx
http {
    # å®šä¹‰ä¸€ä¸ªé™æµåŒºåŸŸ
    limit_req_zone $binary_remote_addr zone=mylimit:10m rate=1r/s;
    #                â†‘                    â†‘           â†‘
    #            æŒ‰IPé™åˆ¶            åŒºåŸŸåç§°     æ¯ç§’1ä¸ªè¯·æ±‚
}
```

**é…ç½®å‚æ•°è¯¦è§£**ï¼š
- `$binary_remote_addr`ï¼š**é™æµçš„ä¾æ®**ï¼ˆé€šå¸¸æ˜¯å®¢æˆ·ç«¯IPï¼‰
- `zone=mylimit:10m`ï¼š**å†…å­˜åŒºåŸŸåç§°**å’Œ**å¤§å°**ï¼ˆ10MBå¯å­˜å‚¨çº¦16ä¸‡ä¸ªIPçŠ¶æ€ï¼‰
- `rate=1r/s`ï¼š**é™æµé€Ÿç‡**ï¼ˆæ¯ç§’å…è®¸1ä¸ªè¯·æ±‚ï¼‰

**ç¬¬äºŒæ­¥ï¼šåº”ç”¨é™æµè§„åˆ™**
```nginx
server {
    location /api/ {
        limit_req zone=mylimit;
        # åº”ç”¨åä¸ºmylimitçš„é™æµè§„åˆ™
    }
}
```

### 2.3 é€Ÿç‡å•ä½è¯´æ˜


```
æ”¯æŒçš„é€Ÿç‡å•ä½ï¼š
1r/s   = æ¯ç§’1ä¸ªè¯·æ±‚
10r/s  = æ¯ç§’10ä¸ªè¯·æ±‚  
1r/m   = æ¯åˆ†é’Ÿ1ä¸ªè¯·æ±‚
30r/m  = æ¯åˆ†é’Ÿ30ä¸ªè¯·æ±‚

å¸¸ç”¨é…ç½®å»ºè®®ï¼š
æ™®é€šç½‘ç«™ï¼š1-5r/s
APIæ¥å£ï¼š10-50r/s
é™æ€èµ„æºï¼š100-500r/s
```

> âš ï¸ **æ–°æ‰‹æ³¨æ„**  
> é€Ÿç‡è®¾ç½®è¦æ ¹æ®å®é™…ä¸šåŠ¡éœ€æ±‚ï¼Œå¤ªä¸¥æ ¼ä¼šå½±å“æ­£å¸¸ç”¨æˆ·ä½“éªŒï¼Œå¤ªå®½æ¾èµ·ä¸åˆ°ä¿æŠ¤ä½œç”¨ã€‚

---

## 3. ğŸª£ æ¼æ¡¶ç®—æ³•åŸç†


### 3.1 æ¼æ¡¶ç®—æ³•çš„å½¢è±¡ç†è§£


**æƒ³è±¡ä¸€ä¸ªæœ‰æ´çš„æ°´æ¡¶**ï¼š

```
æ¼æ¡¶ç®—æ³•å›¾ç¤ºï¼š

è¯·æ±‚æµå…¥ â†’  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
(ä¸è§„å¾‹)    â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â”‚ â† æ¡¶é‡Œç§¯ç´¯çš„è¯·æ±‚
           â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â”‚
           â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â”‚
           â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â”‚
           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ æ’å®šé€Ÿç‡æ¼å‡º
                  â†“
              å¤„ç†è¯·æ±‚ (è§„å¾‹çš„)

æ ¸å¿ƒç‰¹ç‚¹ï¼š
â€¢ æ¡¶å®¹é‡æœ‰é™ï¼šè¶…å‡ºå®¹é‡çš„è¯·æ±‚ä¼šè¢«ä¸¢å¼ƒ
â€¢ æ¼å‡ºé€Ÿç‡æ’å®šï¼šæ— è®ºè¿›å…¥å¤šå°‘ï¼Œå‡ºå»é€Ÿç‡ä¸å˜
â€¢ å¹³æ»‘æµé‡ï¼šå°†çªå‘æµé‡å˜æˆå¹³æ»‘æµé‡
```

### 3.2 ç®—æ³•å·¥ä½œæœºåˆ¶


**æ¼æ¡¶ç®—æ³•çš„ä¸‰ä¸ªå…³é”®å‚æ•°**ï¼š

1. **æ¡¶å®¹é‡ï¼ˆburstï¼‰**ï¼šèƒ½ç¼“å­˜å¤šå°‘ä¸ªè¯·æ±‚
2. **æ¼å‡ºé€Ÿç‡ï¼ˆrateï¼‰**ï¼šæ¯ç§’å¤„ç†å¤šå°‘ä¸ªè¯·æ±‚  
3. **æµå…¥æ§åˆ¶**ï¼šè¶…å‡ºå®¹é‡çš„è¯·æ±‚å¦‚ä½•å¤„ç†

**å¤„ç†æµç¨‹**ï¼š
```
æ­¥éª¤1ï¼šæ–°è¯·æ±‚åˆ°è¾¾
  â†“
æ­¥éª¤2ï¼šæ£€æŸ¥æ¡¶æ˜¯å¦å·²æ»¡
  â†“
æ­¥éª¤3aï¼šæ¡¶æœªæ»¡ â†’ è¯·æ±‚è¿›å…¥æ¡¶ï¼Œç­‰å¾…å¤„ç†
æ­¥éª¤3bï¼šæ¡¶å·²æ»¡ â†’ æ ¹æ®ç­–ç•¥å†³å®šï¼ˆæ‹’ç»/å»¶è¿Ÿï¼‰
  â†“
æ­¥éª¤4ï¼šæŒ‰æ’å®šé€Ÿç‡ä»æ¡¶ä¸­å–å‡ºè¯·æ±‚å¤„ç†
```

### 3.3 å®é™…è¿è¡Œç¤ºä¾‹


**å‡è®¾é…ç½®**ï¼š`rate=2r/s`ï¼Œ`burst=5`

```
æ—¶é—´è½´ç¤ºä¾‹ï¼ˆæ¯0.5ç§’ä¸€ä¸ªæ—¶é—´ç‚¹ï¼‰ï¼š

æ—¶åˆ»0ç§’ï¼šæ”¶åˆ°10ä¸ªè¯·æ±‚
 æ¡¶çŠ¶æ€ï¼š[â– â– â– â– â– ] (5ä¸ªè¿›æ¡¶ï¼Œ5ä¸ªè¢«æ‹’ç»)
 å¤„ç†ï¼š0ä¸ª

æ—¶åˆ»0.5ç§’ï¼šå¤„ç†1ä¸ªè¯·æ±‚
 æ¡¶çŠ¶æ€ï¼š[â– â– â– â– _] (4ä¸ªåœ¨æ¡¶ä¸­)
 å¤„ç†ï¼š1ä¸ª

æ—¶åˆ»1ç§’ï¼šæ”¶åˆ°3ä¸ªè¯·æ±‚ï¼Œå¤„ç†1ä¸ª
 æ¡¶çŠ¶æ€ï¼š[â– â– â– â– â– ] (æ¡¶æ»¡ï¼Œ1ä¸ªæ–°è¯·æ±‚è¢«æ‹’ç»)
 å¤„ç†ï¼š1ä¸ª

æ—¶åˆ»1.5ç§’ï¼šå¤„ç†1ä¸ªè¯·æ±‚
 æ¡¶çŠ¶æ€ï¼š[â– â– â– â– _] (4ä¸ªåœ¨æ¡¶ä¸­)
 å¤„ç†ï¼š1ä¸ª
```

> ğŸ“Œ **æ ¸å¿ƒç†è§£**  
> æ¼æ¡¶ç®—æ³•å°±åƒç»™ç½‘ç«™å®‰è£…äº†ä¸€ä¸ª"ç¼“å†²å™¨"ï¼Œæ— è®ºå¤–ç•Œè¯·æ±‚å¤šä¹ˆæ±¹æ¶Œï¼Œéƒ½ä¼šè¢«å¹³æ»‘åœ°å¤„ç†ï¼Œä¿æŠ¤æœåŠ¡å™¨ä¸è¢«å†²å®ã€‚

---

## 4. âš™ï¸ é™æµé…ç½®è¯¦è§£


### 4.1 å®Œæ•´é…ç½®ç¤ºä¾‹


```nginx
http {
    # å®šä¹‰å¤šä¸ªé™æµåŒºåŸŸ
    limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=api:10m rate=20r/s;
    limit_req_zone $binary_remote_addr zone=login:1m rate=1r/s;
    
    server {
        listen 80;
        server_name example.com;
        
        # æ™®é€šé¡µé¢é™æµ
        location / {
            limit_req zone=general burst=20 nodelay;
            proxy_pass http://backend;
        }
        
        # APIæ¥å£é™æµ
        location /api/ {
            limit_req zone=api burst=10;
            proxy_pass http://api_backend;
        }
        
        # ç™»å½•æ¥å£ä¸¥æ ¼é™æµ
        location /login {
            limit_req zone=login burst=3;
            proxy_pass http://auth_backend;
        }
    }
}
```

### 4.2 å…³é”®å‚æ•°è¯¦è§£


**zoneå‚æ•°**ï¼šæŒ‡å®šä½¿ç”¨å“ªä¸ªé™æµåŒºåŸŸ
```nginx
limit_req zone=mylimit;
# ä½¿ç”¨åä¸ºmylimitçš„é™æµåŒºåŸŸ
```

**burstå‚æ•°**ï¼šè®¾ç½®çªå‘è¯·æ±‚ç¼“å­˜æ•°é‡
```nginx
limit_req zone=mylimit burst=5;
# å…è®¸ç¼“å­˜5ä¸ªçªå‘è¯·æ±‚
```

**nodelayå‚æ•°**ï¼šç«‹å³å¤„ç†çªå‘è¯·æ±‚
```nginx
limit_req zone=mylimit burst=5 nodelay;
# çªå‘è¯·æ±‚ä¸æ’é˜Ÿï¼Œç«‹å³å¤„ç†æˆ–æ‹’ç»
```

### 4.3 nodelayå‚æ•°çš„é‡è¦åŒºåˆ«


**ä¸ä½¿ç”¨nodelayï¼ˆé»˜è®¤è¡Œä¸ºï¼‰**ï¼š
```
è¯·æ±‚æ—¶åºï¼š1ç§’å†…æ”¶åˆ°6ä¸ªè¯·æ±‚ï¼Œrate=1r/sï¼Œburst=5

å¤„ç†æ–¹å¼ï¼š
è¯·æ±‚1ï¼šç«‹å³å¤„ç† âœ“
è¯·æ±‚2ï¼šå»¶è¿Ÿ1ç§’å¤„ç† â°
è¯·æ±‚3ï¼šå»¶è¿Ÿ2ç§’å¤„ç† â°  
è¯·æ±‚4ï¼šå»¶è¿Ÿ3ç§’å¤„ç† â°
è¯·æ±‚5ï¼šå»¶è¿Ÿ4ç§’å¤„ç† â°
è¯·æ±‚6ï¼šå»¶è¿Ÿ5ç§’å¤„ç† â°

ç‰¹ç‚¹ï¼šæ‰€æœ‰è¯·æ±‚éƒ½ä¼šè¢«å¤„ç†ï¼Œä½†æœ‰å»¶è¿Ÿ
```

**ä½¿ç”¨nodelay**ï¼š
```
ç›¸åŒåœºæ™¯ä¸‹ï¼š

å¤„ç†æ–¹å¼ï¼š
è¯·æ±‚1ï¼šç«‹å³å¤„ç† âœ“
è¯·æ±‚2ï¼šç«‹å³å¤„ç† âœ“
è¯·æ±‚3ï¼šç«‹å³å¤„ç† âœ“
è¯·æ±‚4ï¼šç«‹å³å¤„ç† âœ“
è¯·æ±‚5ï¼šç«‹å³å¤„ç† âœ“
è¯·æ±‚6ï¼šç«‹å³æ‹’ç» âŒ

ç‰¹ç‚¹ï¼šåœ¨é™åˆ¶èŒƒå›´å†…ç«‹å³å“åº”ï¼Œè¶…å‡ºç«‹å³æ‹’ç»
```

> ğŸ’¡ **é€‰æ‹©å»ºè®®**  
> - **ä¸ç”¨nodelay**ï¼šé€‚åˆå¯ä»¥ç­‰å¾…çš„åœºæ™¯ï¼Œå¦‚æ–‡ä»¶ä¸‹è½½
> - **ç”¨nodelay**ï¼šé€‚åˆå®æ—¶æ€§è¦æ±‚é«˜çš„åœºæ™¯ï¼Œå¦‚APIæ¥å£

### 4.4 è‡ªå®šä¹‰é™æµä¾æ®


**é™¤äº†IPï¼Œè¿˜å¯ä»¥åŸºäºå…¶ä»–æ¡ä»¶é™æµ**ï¼š

```nginx
# åŸºäºç”¨æˆ·IDé™æµ
limit_req_zone $arg_user_id zone=user_limit:10m rate=10r/s;

# åŸºäºUser-Agenté™æµ
limit_req_zone $http_user_agent zone=ua_limit:10m rate=100r/s;

# åŸºäºç»„åˆæ¡ä»¶é™æµ
map $remote_addr$http_user_agent $limit_key {
    ~bot "crawler";
    default $remote_addr;
}
limit_req_zone $limit_key zone=smart_limit:10m rate=5r/s;
```

---

## 5. ğŸš€ çªå‘è¯·æ±‚å¤„ç†


### 5.1 çªå‘è¯·æ±‚çš„ç°å®åœºæ™¯


**å…¸å‹çªå‘åœºæ™¯**ï¼š
- **ç§’æ€æ´»åŠ¨**ï¼š0ç‚¹å‡†æ—¶å¼€å§‹ï¼Œç¬é—´å¤§é‡ç”¨æˆ·æ¶Œå…¥
- **çƒ­ç‚¹æ–°é—»**ï¼šçªå‘äº‹ä»¶å¯¼è‡´ç½‘ç«™è®¿é—®é‡æ¿€å¢
- **ä¿ƒé”€æ´»åŠ¨**ï¼šé™æ—¶ä¼˜æƒ å¸¦æ¥çš„æµé‡é«˜å³°
- **APIè°ƒç”¨**ï¼šæ‰¹é‡å¤„ç†ä»»åŠ¡çš„é›†ä¸­è¯·æ±‚

### 5.2 burstå‚æ•°é…ç½®ç­–ç•¥


**burstå¤§å°çš„é€‰æ‹©ä¾æ®**ï¼š

```
ä¸šåŠ¡ç±»å‹å»ºè®®ï¼š

é™æ€ç½‘ç«™ï¼šburst=50-100
 åŸå› ï¼šç”¨æˆ·æµè§ˆæ—¶å¯èƒ½å¿«é€Ÿç‚¹å‡»å¤šä¸ªé¡µé¢

APIæ¥å£ï¼šburst=10-20  
 åŸå› ï¼šå®¢æˆ·ç«¯å¯èƒ½æ‰¹é‡è°ƒç”¨ï¼Œä½†ä¸å®œè¿‡å¤§

ç™»å½•æ¥å£ï¼šburst=2-5
 åŸå› ï¼šå®‰å…¨æ•æ„Ÿï¼Œé˜²æ­¢æš´åŠ›ç ´è§£

æ–‡ä»¶ä¸Šä¼ ï¼šburst=1-3
 åŸå› ï¼šä¸Šä¼ å ç”¨èµ„æºå¤šï¼Œé™åˆ¶æ›´ä¸¥æ ¼
```

### 5.3 å¤„ç†çªå‘è¯·æ±‚çš„æœ€ä½³å®è·µ


**é…ç½®ç¤ºä¾‹ï¼šç”µå•†ç½‘ç«™ç§’æ€æ´»åŠ¨**

```nginx
http {
    # æ™®é€šå•†å“é¡µé¢
    limit_req_zone $binary_remote_addr zone=normal:10m rate=10r/s;
    
    # ç§’æ€é¡µé¢
    limit_req_zone $binary_remote_addr zone=seckill:10m rate=20r/s;
    
    server {
        # æ™®é€šé¡µé¢ï¼šå…è®¸é€‚ä¸­çªå‘
        location /products/ {
            limit_req zone=normal burst=30 nodelay;
        }
        
        # ç§’æ€é¡µé¢ï¼šå…è®¸è¾ƒå¤§çªå‘ï¼Œå¿«é€Ÿå“åº”
        location /seckill/ {
            limit_req zone=seckill burst=50 nodelay;
        }
        
        # ä¸‹å•æ¥å£ï¼šä¸¥æ ¼é™åˆ¶ï¼Œé˜²æ­¢é‡å¤ä¸‹å•
        location /order {
            limit_req zone=normal burst=3;
        }
    }
}
```

### 5.4 å¤šçº§é™æµç­–ç•¥


**å¤æ‚åœºæ™¯çš„å¤šé‡ä¿æŠ¤**ï¼š

```nginx
location /api/ {
    # ç¬¬ä¸€çº§ï¼šåŸºç¡€é¢‘ç‡é™åˆ¶
    limit_req zone=api_basic burst=10 nodelay;
    
    # ç¬¬äºŒçº§ï¼šé«˜é¢‘ç”¨æˆ·é¢å¤–é™åˆ¶
    limit_req zone=api_premium burst=50 nodelay;
    
    proxy_pass http://backend;
}
```

> âš ï¸ **é‡è¦æé†’**  
> å¤šä¸ªlimit_reqè§„åˆ™åŒæ—¶ç”Ÿæ•ˆæ—¶ï¼Œåªè¦è¿åä»»ä½•ä¸€ä¸ªè§„åˆ™ï¼Œè¯·æ±‚å°±ä¼šè¢«é™åˆ¶ã€‚

---

## 6. ğŸ“Š é™æµçŠ¶æ€ç ä¸é”™è¯¯å¤„ç†


### 6.1 é»˜è®¤é™æµå“åº”


**è¢«é™æµæ—¶çš„é»˜è®¤è¡Œä¸º**ï¼š

```
HTTPçŠ¶æ€ç ï¼š503 Service Temporarily Unavailable
å“åº”å¤´ï¼šæ— ç‰¹æ®Šæ ‡è¯†
å“åº”ä½“ï¼šç®€å•çš„é”™è¯¯é¡µé¢
```

### 6.2 è‡ªå®šä¹‰é™æµå“åº”


**æ–¹æ³•ä¸€ï¼šè‡ªå®šä¹‰é”™è¯¯é¡µé¢**

```nginx
http {
    limit_req_zone $binary_remote_addr zone=mylimit:10m rate=5r/s;
    
    server {
        # è‡ªå®šä¹‰503é”™è¯¯é¡µé¢
        error_page 503 /rate_limit.html;
        
        location = /rate_limit.html {
            root /var/www/error;
            internal;
        }
        
        location /api/ {
            limit_req zone=mylimit burst=10 nodelay;
            proxy_pass http://backend;
        }
    }
}
```

**æ–¹æ³•äºŒï¼šè¿”å›JSONæ ¼å¼é”™è¯¯**

```nginx
location /api/ {
    limit_req zone=mylimit burst=10 nodelay;
    
    # é™æµæ—¶è¿”å›JSONé”™è¯¯ä¿¡æ¯
    error_page 503 = @rate_limit;
    proxy_pass http://backend;
}

location @rate_limit {
    add_header Content-Type application/json always;
    return 200 '{"error":"Rate limit exceeded","code":503,"message":"Too many requests"}';
}
```

### 6.3 é™æµæ—¥å¿—è®°å½•


**å¯ç”¨è¯¦ç»†æ—¥å¿—**ï¼š

```nginx
http {
    limit_req_zone $binary_remote_addr zone=mylimit:10m rate=5r/s;
    
    # è®¾ç½®æ—¥å¿—çº§åˆ«
    limit_req_log_level warn;
    
    server {
        location /api/ {
            limit_req zone=mylimit burst=10 nodelay;
            
            # è®°å½•é™æµäº‹ä»¶
            access_log /var/log/nginx/rate_limit.log combined;
            proxy_pass http://backend;
        }
    }
}
```

**æ—¥å¿—ç¤ºä¾‹**ï¼š
```
2024-09-21 15:30:15 [warn] limiting requests, excess: 5.000 by zone "mylimit"
192.168.1.100 - - [21/Sep/2024:15:30:15 +0800] "GET /api/data HTTP/1.1" 503 0
```

### 6.4 å®¢æˆ·ç«¯å‹å¥½çš„é”™è¯¯ä¿¡æ¯


**æ·»åŠ é™æµæç¤ºå¤´**ï¼š

```nginx
location /api/ {
    limit_req zone=mylimit burst=10 nodelay;
    
    # æ·»åŠ é€Ÿç‡é™åˆ¶ä¿¡æ¯å¤´
    add_header X-RateLimit-Limit "5" always;
    add_header X-RateLimit-Remaining "0" always;
    add_header X-RateLimit-Reset "60" always;
    
    proxy_pass http://backend;
}
```

**é”™è¯¯å“åº”ç¤ºä¾‹**ï¼š
```http
HTTP/1.1 503 Service Temporarily Unavailable
X-RateLimit-Limit: 5
X-RateLimit-Remaining: 0  
X-RateLimit-Reset: 60
Content-Type: application/json

{
  "error": "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•",
  "retry_after": 60
}
```

---

## 7. ğŸ¯ å®é™…åº”ç”¨åœºæ™¯


### 7.1 Webç½‘ç«™åŸºç¡€é˜²æŠ¤


**åœºæ™¯**ï¼šä¿æŠ¤ç½‘ç«™å…å—æ¶æ„çˆ¬è™«å’ŒDDoSæ”»å‡»

```nginx
http {
    # åŸºç¡€é™æµï¼šæ™®é€šç”¨æˆ·æ¯ç§’æœ€å¤š10ä¸ªè¯·æ±‚
    limit_req_zone $binary_remote_addr zone=website:20m rate=10r/s;
    
    server {
        server_name www.example.com;
        
        location / {
            # å…è®¸çŸ­æ—¶é—´çªå‘ï¼Œä½†æ€»ä½“æ§åˆ¶åœ¨åˆç†èŒƒå›´
            limit_req zone=website burst=20 nodelay;
            
            # è®¾ç½®å‹å¥½çš„é”™è¯¯é¡µé¢
            error_page 503 /limit.html;
            
            proxy_pass http://web_servers;
        }
        
        # é™æ€èµ„æºç›¸å¯¹å®½æ¾
        location ~* \.(jpg|png|css|js)$ {
            limit_req zone=website burst=50 nodelay;
            expires 1d;
        }
    }
}
```

### 7.2 APIæ¥å£ä¿æŠ¤


**åœºæ™¯**ï¼šä¿æŠ¤APIæœåŠ¡ï¼Œé˜²æ­¢æ»¥ç”¨å’Œæ¶æ„è°ƒç”¨

```nginx
http {
    # APIé™æµï¼šæ ¹æ®ä¸åŒæ¥å£è®¾ç½®ä¸åŒé™åˆ¶
    limit_req_zone $binary_remote_addr zone=api_read:10m rate=100r/s;
    limit_req_zone $binary_remote_addr zone=api_write:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=api_auth:5m rate=5r/s;
    
    server {
        server_name api.example.com;
        
        # æŸ¥è¯¢ç±»APIï¼šç›¸å¯¹å®½æ¾
        location ~ ^/api/v1/(get|list|search) {
            limit_req zone=api_read burst=50;
            proxy_pass http://api_servers;
        }
        
        # å†™å…¥ç±»APIï¼šä¸¥æ ¼é™åˆ¶
        location ~ ^/api/v1/(create|update|delete) {
            limit_req zone=api_write burst=5 nodelay;
            proxy_pass http://api_servers;
        }
        
        # è®¤è¯æ¥å£ï¼šæœ€ä¸¥æ ¼é™åˆ¶
        location ~ ^/api/v1/(login|register|reset) {
            limit_req zone=api_auth burst=2 nodelay;
            proxy_pass http://auth_servers;
        }
    }
}
```

### 7.3 ç™»å½•å®‰å…¨é˜²æŠ¤


**åœºæ™¯**ï¼šé˜²æ­¢æš´åŠ›ç ´è§£ç™»å½•å¯†ç 

```nginx
http {
    # ç™»å½•é™æµï¼šæ¯ä¸ªIPæ¯åˆ†é’Ÿæœ€å¤š5æ¬¡å°è¯•
    limit_req_zone $binary_remote_addr zone=login:10m rate=5r/m;
    
    server {
        # ç™»å½•é¡µé¢
        location /login {
            limit_req zone=login burst=2 nodelay;
            
            # é™æµæ—¶è¿”å›æ˜ç¡®æç¤º
            error_page 503 = @login_limit;
            proxy_pass http://app_servers;
        }
        
        # ç™»å½•é™æµæç¤ºé¡µé¢
        location @login_limit {
            add_header Content-Type "text/html; charset=utf-8";
            return 200 '
            <html><head><title>ç™»å½•é¢‘ç¹</title></head>
            <body>
                <h2>ç™»å½•å°è¯•è¿‡äºé¢‘ç¹</h2>
                <p>ä¸ºäº†è´¦æˆ·å®‰å…¨ï¼Œè¯·ç¨ç­‰ç‰‡åˆ»å†è¯•</p>
                <p>å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»å®¢æœ</p>
            </body></html>';
        }
    }
}
```

### 7.4 åŠ¨æ€é™æµç­–ç•¥


**åœºæ™¯**ï¼šæ ¹æ®ç”¨æˆ·ç±»å‹å®æ–½ä¸åŒé™æµç­–ç•¥

```nginx
http {
    # ä½¿ç”¨mapæ ¹æ®ç”¨æˆ·ç±»å‹è®¾ç½®ä¸åŒçš„é™æµkey
    map $http_user_type $rate_limit_key {
        "premium"    "";              # ä¼šå‘˜ç”¨æˆ·ä¸é™æµ
        "regular"    $binary_remote_addr;  # æ™®é€šç”¨æˆ·æŒ‰IPé™æµ
        default      $binary_remote_addr;  # é»˜è®¤æŒ‰IPé™æµ
    }
    
    limit_req_zone $rate_limit_key zone=dynamic:10m rate=20r/s;
    
    server {
        location /api/ {
            # åªæœ‰éç©ºkeyæ‰ä¼šè¢«é™æµ
            limit_req zone=dynamic burst=10 nodelay;
            proxy_pass http://backend;
        }
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ è¯·æ±‚é™æµæœ¬è´¨ï¼šæ§åˆ¶å•ä½æ—¶é—´å†…çš„è¯·æ±‚æ•°é‡ï¼Œä¿æŠ¤æœåŠ¡å™¨
ğŸ”¸ æ¼æ¡¶ç®—æ³•ï¼šåŒ€é€Ÿå¤„ç†è¯·æ±‚çš„æ ¸å¿ƒæœºåˆ¶ï¼Œçªå‘å˜å¹³æ»‘
ğŸ”¸ limit_reqæ¨¡å—ï¼šNginxå†…ç½®é™æµå·¥å…·ï¼Œé…ç½®ç®€å•æ•ˆæœå¥½
ğŸ”¸ burstå‚æ•°ï¼šçªå‘è¯·æ±‚ç¼“å­˜ï¼Œå¹³è¡¡ç”¨æˆ·ä½“éªŒå’Œç³»ç»Ÿä¿æŠ¤
ğŸ”¸ nodelayå‚æ•°ï¼šæ§åˆ¶çªå‘è¯·æ±‚çš„å¤„ç†æ–¹å¼ï¼Œç«‹å³å“åº”vsæ’é˜Ÿç­‰å¾…
```

### 8.2 é…ç½®è¦ç‚¹é€ŸæŸ¥


**åŸºç¡€é…ç½®æ¨¡æ¿**ï¼š
```nginx
# ç¬¬ä¸€æ­¥ï¼šå®šä¹‰é™æµåŒºåŸŸ
limit_req_zone $binary_remote_addr zone=åç§°:å¤§å° rate=é€Ÿç‡;

# ç¬¬äºŒæ­¥ï¼šåº”ç”¨é™æµè§„åˆ™  
limit_req zone=åç§° burst=çªå‘æ•° nodelay;
```

**å‚æ•°é€‰æ‹©æŒ‡å—**ï¼š
```
rateè®¾ç½®ï¼š
â€¢ é™æ€ç½‘ç«™ï¼š10-50r/s
â€¢ APIæ¥å£ï¼š20-100r/s  
â€¢ ç™»å½•æ¥å£ï¼š1-5r/s

burstè®¾ç½®ï¼š
â€¢ ä¸€èˆ¬ä¸ºrateçš„2-5å€
â€¢ å®‰å…¨æ•æ„Ÿæ¥å£è®¾ç½®è¾ƒå°å€¼
â€¢ ç”¨æˆ·ä½“éªŒè¦æ±‚é«˜çš„è®¾ç½®è¾ƒå¤§å€¼
```

### 8.3 æœ€ä½³å®è·µå»ºè®®


**ğŸ”¹ åˆ†å±‚é™æµç­–ç•¥**
```
å®æ–½å»ºè®®ï¼š
â€¢ å…¨å±€åŸºç¡€é™æµï¼šé˜²æ­¢æ•´ä½“è¿‡è½½
â€¢ æ¥å£åˆ†ç±»é™æµï¼šæ ¹æ®é‡è¦æ€§è®¾ç½®ä¸åŒé™åˆ¶
â€¢ ç”¨æˆ·åˆ†çº§é™æµï¼šVIPç”¨æˆ·äº«å—æ›´é«˜é™é¢
â€¢ æ—¶é—´æ®µè°ƒæ•´ï¼šé«˜å³°æœŸå’Œä½å³°æœŸä¸åŒç­–ç•¥
```

**ğŸ”¹ ç›‘æ§å’Œè°ƒä¼˜**
```
è¿ç»´è¦ç‚¹ï¼š
â€¢ å¯ç”¨è¯¦ç»†æ—¥å¿—è®°å½•é™æµäº‹ä»¶
â€¢ ç›‘æ§503é”™è¯¯ç‡ï¼Œé¿å…è¯¯æ€æ­£å¸¸ç”¨æˆ·
â€¢ æ ¹æ®ä¸šåŠ¡å¢é•¿è°ƒæ•´é™æµå‚æ•°
â€¢ å‡†å¤‡é™çº§é¢„æ¡ˆï¼Œé™æµå¤±æ•ˆæ—¶çš„åº”å¯¹
```

**ğŸ”¹ ç”¨æˆ·ä½“éªŒå¹³è¡¡**
```
å‹å¥½é™æµï¼š
â€¢ æä¾›æ¸…æ™°çš„é”™è¯¯æç¤ºä¿¡æ¯
â€¢ å‘ŠçŸ¥ç”¨æˆ·ä½•æ—¶å¯ä»¥é‡è¯•
â€¢ åŒºåˆ†æ¶æ„è¯·æ±‚å’Œæ­£å¸¸çªå‘
â€¢ è€ƒè™‘ä¸šåŠ¡åœºæ™¯çš„ç‰¹æ®Šéœ€æ±‚
```

### 8.4 å¸¸è§é—®é¢˜è§£ç­”


**â“ é™æµå¤ªä¸¥æ ¼ï¼Œæ­£å¸¸ç”¨æˆ·å—å½±å“æ€ä¹ˆåŠï¼Ÿ**
```
è§£å†³æ–¹æ¡ˆï¼š
1. é€‚å½“å¢åŠ burstå€¼ï¼Œå…è®¸æ›´å¤šçªå‘è¯·æ±‚
2. ä½¿ç”¨nodelayå‚æ•°ï¼Œæé«˜å“åº”é€Ÿåº¦
3. ç›‘æ§æ—¥å¿—ï¼Œæ ¹æ®å®é™…æƒ…å†µè°ƒæ•´rate
4. è€ƒè™‘åŸºäºç”¨æˆ·èº«ä»½çš„å·®å¼‚åŒ–é™æµ
```

**â“ å¦‚ä½•é˜²æ­¢ç»•è¿‡IPé™æµï¼Ÿ**
```
åŠ å¼ºæªæ–½ï¼š
1. ç»“åˆUser-Agentã€Cookieç­‰å¤šç»´åº¦é™æµ
2. ä½¿ç”¨åº”ç”¨å±‚é™æµè¡¥å……ï¼ˆå¦‚Redisè®¡æ•°å™¨ï¼‰
3. é…ç½®é˜²ç«å¢™è§„åˆ™ï¼Œä»ç½‘ç»œå±‚é˜»æ–­
4. å¯ç”¨è®¿é—®æ—¥å¿—åˆ†æï¼Œè¯†åˆ«å¼‚å¸¸è¡Œä¸º
```

**â“ é›†ç¾¤ç¯å¢ƒä¸‹é™æµå¦‚ä½•åŒæ­¥ï¼Ÿ**
```
è§£å†³æ€è·¯ï¼š
1. æ¯ä¸ªèŠ‚ç‚¹ç‹¬ç«‹é™æµï¼ˆç®€å•ä½†ä¸å¤Ÿç²¾ç¡®ï¼‰
2. ä½¿ç”¨å…±äº«å­˜å‚¨ï¼ˆRedisï¼‰å®ç°å…¨å±€é™æµ
3. åœ¨è´Ÿè½½å‡è¡¡å±‚å®ç°é™æµï¼ˆå¦‚F5ã€HAProxyï¼‰
4. ä½¿ç”¨ä¸“ä¸šé™æµæœåŠ¡ï¼ˆå¦‚é˜¿é‡Œäº‘ã€è…¾è®¯äº‘ï¼‰
```

> ğŸ“Œ **æ ¸å¿ƒè®°å¿†**  
> é™æµæ˜¯ç½‘ç«™é˜²æŠ¤çš„ç¬¬ä¸€é“é˜²çº¿ï¼Œåˆç†é…ç½®èƒ½åœ¨ä¿æŠ¤æœåŠ¡å™¨çš„åŒæ—¶ä¿è¯ç”¨æˆ·ä½“éªŒã€‚è®°ä½"å…ˆä¿æŠ¤ï¼Œå†ä¼˜åŒ–"çš„åŸåˆ™ï¼Œé€æ­¥è°ƒæ•´åˆ°æœ€ä½³çŠ¶æ€ã€‚

---

**å­¦ä¹ å»ºè®®**ï¼š
1. **å…ˆç†è§£åŸç†**ï¼šæ¼æ¡¶ç®—æ³•æ˜¯åŸºç¡€ï¼Œç†è§£äº†åŸç†é…ç½®å°±ä¸éš¾
2. **ä»ç®€å•å¼€å§‹**ï¼šå…ˆé…ç½®åŸºç¡€é™æµï¼Œå†æ ¹æ®éœ€è¦æ·»åŠ å¤æ‚è§„åˆ™  
3. **æŒç»­ç›‘æ§**ï¼šé™æµæ•ˆæœéœ€è¦é€šè¿‡æ—¥å¿—å’Œç›‘æ§æ¥éªŒè¯è°ƒæ•´
4. **ä¸šåŠ¡ç»“åˆ**ï¼šé™æµç­–ç•¥è¦ç»“åˆå…·ä½“ä¸šåŠ¡åœºæ™¯ï¼Œæ²¡æœ‰ä¸‡èƒ½é…ç½®