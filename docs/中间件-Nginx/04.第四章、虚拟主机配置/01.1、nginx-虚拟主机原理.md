---
title: 1、nginx-虚拟主机原理
---
## 📚 目录

1. [虚拟主机概念与作用](#1-虚拟主机概念与作用)
2. [虚拟主机的工作原理](#2-虚拟主机的工作原理)
3. [基于域名的虚拟主机](#3-基于域名的虚拟主机)
4. [基于IP的虚拟主机](#4-基于IP的虚拟主机)
5. [基于端口的虚拟主机](#5-基于端口的虚拟主机)
6. [默认服务器配置策略](#6-默认服务器配置策略)
7. [多站点部署实战](#7-多站点部署实战)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🏠 虚拟主机概念与作用


### 1.1 什么是虚拟主机


**通俗理解**：虚拟主机就像是一栋大楼里的不同房间，每个房间有自己的门牌号，但都共用同一个地址。

```
现实中的理解：
一栋大楼（一台服务器）
├── 201室（网站A）- www.sitea.com
├── 202室（网站B）- www.siteb.com
└── 203室（网站C）- www.sitec.com

都是同一个服务器，但能跑多个不同的网站
```

**🔸 核心定义**
```
虚拟主机（Virtual Host）：
在一台物理服务器上运行多个网站的技术
每个网站有独立的域名、内容和配置
用户访问不同域名时，看到不同的网站内容
```

### 1.2 为什么需要虚拟主机


**💰 成本考虑**
- **传统方式**：一个网站一台服务器，成本高昂
- **虚拟主机**：一台服务器跑多个网站，大幅降低成本

**🎯 实际应用场景**
```
个人开发者：
- 博客网站：blog.myname.com
- 作品展示：portfolio.myname.com  
- 测试环境：test.myname.com

企业应用：
- 官方网站：www.company.com
- 帮助文档：help.company.com
- API服务：api.company.com
```

### 1.3 虚拟主机的优势


| 优势 | **说明** | **举例** |
|------|---------|---------|
| 💰 **成本效益** | `一台服务器运行多个网站` | `原本需要3台服务器，现在只需1台` |
| 🔧 **易于管理** | `统一的服务器管理和维护` | `只需要维护一个Nginx配置` |
| ⚡ **资源利用** | `充分利用服务器性能` | `小网站共享服务器资源` |
| 🎯 **灵活部署** | `可以随时添加或删除网站` | `新项目上线只需新增配置` |

---

## 2. ⚙️ 虚拟主机的工作原理


### 2.1 HTTP请求识别机制


**🔍 Nginx如何知道你要访问哪个网站？**

当用户在浏览器输入网址时，实际发生了这样的过程：

```
用户访问流程：
1. 用户输入：www.sitea.com
2. 浏览器发送HTTP请求到服务器
3. 请求头包含：Host: www.sitea.com
4. Nginx读取Host头信息
5. 匹配对应的虚拟主机配置
6. 返回对应网站的内容
```

**📋 HTTP请求头示例**
```
GET / HTTP/1.1
Host: www.sitea.com          ← 关键信息！Nginx靠这个识别网站
User-Agent: Mozilla/5.0...
Accept: text/html...
```

### 2.2 Nginx匹配逻辑


**🎯 Nginx的处理步骤**
```
步骤1：接收HTTP请求
步骤2：提取Host头信息
步骤3：遍历所有server块配置
步骤4：匹配server_name指令
步骤5：选择匹配的虚拟主机
步骤6：返回对应内容
```

> 💡 **核心理解**：Nginx主要通过HTTP请求头中的`Host`字段来区分不同的网站。这就是为什么不同域名可以指向同一个IP地址，但能显示不同内容的原因。

### 2.3 三种主要区分方式


**🔸 区分维度对比**

| 区分方式 | **识别依据** | **适用场景** | **配置复杂度** |
|---------|-------------|-------------|---------------|
| **基于域名** | `Host头中的域名` | `最常用，多网站部署` | `简单` |
| **基于IP** | `服务器的不同IP地址` | `需要独立IP的场景` | `中等` |
| **基于端口** | `不同的端口号` | `测试环境，内部系统` | `简单` |

---

## 3. 🌐 基于域名的虚拟主机


### 3.1 基本原理说明


**🔸 最常用的方式**
基于域名的虚拟主机是最常见的配置方式，通过不同的域名来区分不同的网站。

**🎯 工作机制**
```
用户访问 www.sitea.com：
├── DNS解析到服务器IP：192.168.1.100
├── HTTP请求头：Host: www.sitea.com
├── Nginx匹配：server_name www.sitea.com
└── 返回网站A的内容

用户访问 www.siteb.com：
├── DNS解析到服务器IP：192.168.1.100（同一个IP）
├── HTTP请求头：Host: www.siteb.com  
├── Nginx匹配：server_name www.siteb.com
└── 返回网站B的内容
```

### 3.2 配置示例详解


**📝 基础配置**
```nginx
# 网站A的配置
server {
    listen 80;                    # 监听80端口
    server_name www.sitea.com;    # 域名匹配
    root /var/www/sitea;          # 网站文件目录
    index index.html;             # 默认首页
    
    location / {
        try_files $uri $uri/ =404;
    }
}

# 网站B的配置  
server {
    listen 80;
    server_name www.siteb.com;    # 不同的域名
    root /var/www/siteb;          # 不同的文件目录
    index index.html;
    
    location / {
        try_files $uri $uri/ =404;
    }
}
```

**🔧 高级配置技巧**
```nginx
# 支持多个域名指向同一个网站
server {
    listen 80;
    server_name example.com www.example.com;  # 多个域名
    root /var/www/example;
    
    # 可选：重定向到主域名
    if ($host != 'www.example.com') {
        return 301 https://www.example.com$request_uri;
    }
}

# 支持子域名通配符
server {
    listen 80;
    server_name *.example.com;    # 匹配所有子域名
    root /var/www/subdomains;
    
    # 根据子域名设置不同目录
    location / {
        root /var/www/subdomains/$host;
        try_files $uri $uri/ =404;
    }
}
```

### 3.3 域名匹配规则


**🎯 优先级顺序**
```
1. 精确匹配：server_name example.com;
2. 通配符前缀：server_name *.example.com;
3. 通配符后缀：server_name mail.*;
4. 正则表达式：server_name ~^(.+)\.example\.com$;
5. 默认服务器：default_server
```

**💡 实际应用示例**
```nginx
# 优先级演示配置
server {
    listen 80;
    server_name mail.example.com;     # 精确匹配，优先级最高
    root /var/www/mail;
}

server {
    listen 80;
    server_name *.example.com;        # 通配符匹配，优先级较低
    root /var/www/wildcard;
}
```

---

## 4. 🌍 基于IP的虚拟主机


### 4.1 工作原理


**🔸 基本概念**
基于IP的虚拟主机是通过服务器的不同IP地址来区分不同的网站。

**🎯 适用场景**
```
SSL证书需求：
- 每个网站需要独立的SSL证书
- 某些老版本浏览器不支持SNI

安全隔离：
- 不同级别的应用需要网络隔离
- 对外和对内的服务分离

特殊协议：
- 非HTTP协议的服务
- 需要独立IP的第三方集成
```

### 4.2 配置方法


**📋 前提条件：服务器配置多个IP**
```bash
# 查看当前IP配置
ip addr show

# 临时添加IP地址（示例）
sudo ip addr add 192.168.1.101/24 dev eth0
sudo ip addr add 192.168.1.102/24 dev eth0
```

**📝 Nginx配置示例**
```nginx
# IP地址：192.168.1.101 对应网站A
server {
    listen 192.168.1.101:80;     # 指定IP地址
    server_name _;                # 不限制域名
    root /var/www/sitea;
    index index.html;
}

# IP地址：192.168.1.102 对应网站B
server {
    listen 192.168.1.102:80;     # 不同的IP地址
    server_name _;
    root /var/www/siteb;
    index index.html;
}

# 主IP地址的默认配置
server {
    listen 192.168.1.100:80;
    server_name _;
    root /var/www/default;
    index index.html;
}
```

### 4.3 优缺点分析


**✅ 优势**
- **独立性强**：每个网站有独立的IP地址
- **SSL兼容**：支持老版本浏览器的SSL
- **安全隔离**：网络层面的隔离

**❌ 劣势**  
- **成本较高**：需要多个公网IP地址
- **IPv4稀缺**：公网IPv4地址资源有限
- **管理复杂**：需要管理多个IP地址

---

## 5. 🚪 基于端口的虚拟主机


### 5.1 基本原理


**🔸 概念说明**
基于端口的虚拟主机通过不同的端口号来区分不同的网站或服务。

**🎯 常见应用**
```
开发测试环境：
- 主站：example.com:80
- 测试站：example.com:8080
- 开发站：example.com:8081

管理后台：
- 用户网站：example.com:80
- 管理后台：example.com:8888

不同服务：
- 网站：example.com:80
- API：example.com:3000
- 文档：example.com:4000
```

### 5.2 配置示例


**📝 基础配置**
```nginx
# 主网站 - 80端口
server {
    listen 80;
    server_name example.com;
    root /var/www/main;
    index index.html;
}

# 测试环境 - 8080端口
server {
    listen 8080;
    server_name example.com;          # 同一个域名
    root /var/www/test;               # 不同的目录
    index index.html;
    
    # 可选：添加测试环境标识
    add_header X-Environment "Test";
}

# 管理后台 - 8888端口
server {
    listen 8888;
    server_name example.com;
    root /var/www/admin;
    index index.html;
    
    # 管理后台通常需要认证
    auth_basic "Admin Area";
    auth_basic_user_file /etc/nginx/.htpasswd;
}
```

**🔧 进阶配置技巧**
```nginx
# 自动重定向到HTTPS
server {
    listen 80;
    server_name example.com;
    return 301 https://$server_name$request_uri;
}

# HTTPS主站 - 443端口
server {
    listen 443 ssl;
    server_name example.com;
    root /var/www/main;
    
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
}

# API服务 - 3000端口
server {
    listen 3000;
    server_name example.com;
    
    location / {
        proxy_pass http://localhost:8000;  # 代理到后端应用
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 5.3 使用注意事项


> ⚠️ **安全提醒**：非标准端口（非80/443）通常需要在防火墙中开放对应端口。

**🔒 防火墙配置示例**
```bash
# Ubuntu/Debian 使用 ufw
sudo ufw allow 8080
sudo ufw allow 8888

# CentOS/RHEL 使用 firewall-cmd  
sudo firewall-cmd --permanent --add-port=8080/tcp
sudo firewall-cmd --permanent --add-port=8888/tcp
sudo firewall-cmd --reload
```

---

## 6. 🎯 默认服务器配置策略


### 6.1 什么是默认服务器


**🔸 核心概念**
当用户的请求无法匹配任何已配置的虚拟主机时，Nginx会使用默认服务器来处理这个请求。

**💡 生活化理解**
```
就像公司前台的作用：
- 有预约的客人 → 直接引导到对应部门（匹配的虚拟主机）
- 没有预约的客人 → 前台接待处理（默认服务器）
```

### 6.2 默认服务器的选择规则


**🎯 Nginx的默认选择逻辑**
```
1. 显式指定：listen 80 default_server;
2. 配置文件顺序：第一个server块
3. 监听端口：同端口的第一个配置
```

**📝 显式配置默认服务器**
```nginx
# 明确指定默认服务器
server {
    listen 80 default_server;        # 关键标识
    listen [::]:80 default_server;   # IPv6支持  
    server_name _;                   # 下划线表示匹配任何域名
    root /var/www/default;
    index index.html;
    
    # 可以返回特定的错误页面
    location / {
        return 444;  # 444表示关闭连接，不返回响应
    }
}
```

### 6.3 安全配置策略


**🔒 防止恶意域名解析**
```nginx
# 安全的默认服务器配置
server {
    listen 80 default_server;
    server_name _;
    
    # 方式1：返回404错误
    return 404;
    
    # 方式2：重定向到主站
    # return 301 https://www.yoursite.com$request_uri;
    
    # 方式3：显示警告页面
    # root /var/www/blocked;
    # index blocked.html;
}
```

**💪 防护恶意请求示例**
```nginx
server {
    listen 80 default_server;
    server_name _;
    
    # 记录恶意请求
    access_log /var/log/nginx/malicious.log;
    
    location / {
        # 返回简单的拒绝信息
        return 444;
    }
    
    # 对特定路径返回403
    location ~* \.(php|asp|jsp)$ {
        return 403;
    }
}
```

---

## 7. 🚀 多站点部署实战


### 7.1 完整部署案例


**🎯 实战场景**
假设我们要在一台服务器上部署以下网站：
- 公司官网：www.company.com
- 博客系统：blog.company.com  
- API服务：api.company.com
- 管理后台：admin.company.com

### 7.2 目录结构规划


**📁 推荐的目录结构**
```
/var/www/
├── company.com/           # 主站目录
│   ├── public/           # 网站文件
│   └── logs/            # 日志文件
├── blog.company.com/     # 博客目录
│   ├── public/
│   └── logs/
├── api.company.com/      # API目录
│   ├── public/
│   └── logs/
└── admin.company.com/    # 管理后台
    ├── public/
    └── logs/
```

**🔧 创建目录结构**
```bash
# 创建网站目录
sudo mkdir -p /var/www/{company.com,blog.company.com,api.company.com,admin.company.com}/{public,logs}

# 设置权限
sudo chown -R www-data:www-data /var/www/
sudo chmod -R 755 /var/www/
```

### 7.3 完整Nginx配置


**📝 主配置文件结构**
```nginx
# /etc/nginx/nginx.conf 主配置
http {
    # 基础配置
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # 日志格式
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                   '$status $body_bytes_sent "$http_referer" '
                   '"$http_user_agent" "$http_x_forwarded_for"';
    
    # 包含虚拟主机配置
    include /etc/nginx/sites-enabled/*;
}
```

**🌐 主站配置文件**
```nginx
# /etc/nginx/sites-available/company.com
server {
    listen 80;
    server_name company.com www.company.com;
    root /var/www/company.com/public;
    index index.html index.php;
    
    # 访问日志
    access_log /var/www/company.com/logs/access.log main;
    error_log /var/www/company.com/logs/error.log;
    
    location / {
        try_files $uri $uri/ =404;
    }
    
    # 如果使用PHP
    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    }
}
```

**📝 博客配置文件**
```nginx
# /etc/nginx/sites-available/blog.company.com
server {
    listen 80;
    server_name blog.company.com;
    root /var/www/blog.company.com/public;
    index index.html index.php;
    
    access_log /var/www/blog.company.com/logs/access.log main;
    error_log /var/www/blog.company.com/logs/error.log;
    
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }
    
    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    }
}
```

**🔌 API服务配置**
```nginx
# /etc/nginx/sites-available/api.company.com
server {
    listen 80;
    server_name api.company.com;
    
    access_log /var/www/api.company.com/logs/access.log main;
    error_log /var/www/api.company.com/logs/error.log;
    
    # API通常是代理到后端应用
    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # CORS设置（如果需要）
    location /api/ {
        add_header 'Access-Control-Allow-Origin' '*';
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS';
        add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization';
        
        if ($request_method = 'OPTIONS') {
            return 204;
        }
        
        proxy_pass http://localhost:3000;
    }
}
```

### 7.4 启用网站配置


**🔗 启用配置的步骤**
```bash
# 创建软链接启用网站
sudo ln -s /etc/nginx/sites-available/company.com /etc/nginx/sites-enabled/
sudo ln -s /etc/nginx/sites-available/blog.company.com /etc/nginx/sites-enabled/
sudo ln -s /etc/nginx/sites-available/api.company.com /etc/nginx/sites-enabled/

# 测试配置语法
sudo nginx -t

# 重新加载配置
sudo systemctl reload nginx
```

### 7.5 DNS配置说明


**🌐 域名解析配置**
```
# 需要在DNS服务商处添加A记录
company.com          A    192.168.1.100
www.company.com      A    192.168.1.100
blog.company.com     A    192.168.1.100  
api.company.com      A    192.168.1.100
admin.company.com    A    192.168.1.100
```

> 💡 **重要提醒**：所有子域名都指向同一个服务器IP，Nginx通过Host头来区分访问的是哪个网站。

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的核心概念


```
🔸 虚拟主机本质：一台服务器运行多个网站的技术
🔸 识别机制：主要通过HTTP请求头中的Host字段区分
🔸 三种类型：基于域名（最常用）、基于IP、基于端口
🔸 默认服务器：处理无法匹配的请求，重要的安全配置
🔸 实际价值：大幅降低运维成本，提高资源利用率
```

### 8.2 关键理解要点


**🔹 虚拟主机的核心优势**
```
成本效益：
- 一台服务器 = 多个网站
- 大幅降低硬件和运维成本
- 特别适合中小型网站

管理便利：
- 统一的服务器管理
- 集中的日志和监控
- 简化的备份和维护
```

**🔹 选择哪种虚拟主机类型？**
```
基于域名：首选方案
✅ 最常用，配置简单
✅ 支持无限域名数量
✅ 成本最低

基于IP：特殊需求
✅ SSL证书独立性
✅ 安全隔离要求
❌ 需要多个IP地址

基于端口：内部使用
✅ 测试和开发环境
✅ 管理后台分离
❌ 用户体验不够友好
```

**🔹 安全配置的重要性**
```
默认服务器配置：
- 防止恶意域名解析到你的服务器
- 避免显示不相关的网站内容
- 记录和阻止可疑请求
```

### 8.3 实际应用指导


**🎯 最佳实践建议**
```
1. 目录规划：
   - 每个网站独立目录
   - 日志文件分离存储
   - 权限设置合理

2. 配置管理：
   - 使用sites-available和sites-enabled结构
   - 配置文件按域名命名
   - 定期备份配置文件

3. 安全考虑：
   - 配置默认服务器
   - 设置合适的错误页面
   - 监控访问日志

4. 性能优化：
   - 根据网站类型调整配置
   - 合理设置缓存策略
   - 监控服务器资源使用
```

**🔧 故障排查技巧**
```
常见问题诊断：
1. 检查DNS解析：nslookup domain.com
2. 测试配置语法：nginx -t
3. 查看错误日志：tail -f /var/log/nginx/error.log
4. 验证Host头：curl -H "Host: domain.com" http://server-ip
```

### 8.4 扩展学习方向


**📚 进阶主题**
- **SSL/TLS配置**：为虚拟主机配置HTTPS
- **负载均衡**：多台服务器的虚拟主机部署
- **缓存策略**：不同网站的缓存配置
- **监控报警**：虚拟主机的监控和报警设置

**核心记忆要点**：
- 虚拟主机让一台服务器变身多网站神器
- Host请求头是Nginx识别网站的关键信息
- 基于域名的虚拟主机是最实用的选择
- 默认服务器配置是重要的安全防线
- 合理的目录规划和配置管理是成功的基础