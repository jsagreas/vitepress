---
title: 2ã€nginx-å¾®æœåŠ¡ç½‘å…³
---
## ğŸ“š ç›®å½•

1. [å¾®æœåŠ¡ç½‘å…³åŸºç¡€æ¦‚å¿µ](#1-å¾®æœåŠ¡ç½‘å…³åŸºç¡€æ¦‚å¿µ)
2. [APIç½‘å…³é…ç½®å®æˆ˜](#2-APIç½‘å…³é…ç½®å®æˆ˜)
3. [æœåŠ¡è·¯ç”±è®¾è®¡](#3-æœåŠ¡è·¯ç”±è®¾è®¡)
4. [è´Ÿè½½å‡è¡¡ç­–ç•¥](#4-è´Ÿè½½å‡è¡¡ç­–ç•¥)
5. [ç†”æ–­é™çº§æœºåˆ¶](#5-ç†”æ–­é™çº§æœºåˆ¶)
6. [é™æµç­–ç•¥å®ç°](#6-é™æµç­–ç•¥å®ç°)
7. [ç›‘æ§æ—¥å¿—é…ç½®](#7-ç›‘æ§æ—¥å¿—é…ç½®)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ å¾®æœåŠ¡ç½‘å…³åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯å¾®æœåŠ¡ç½‘å…³


**ç®€å•ç†è§£**ï¼šæŠŠå¾®æœåŠ¡ç½‘å…³æƒ³è±¡æˆä¸€ä¸ª**æ™ºèƒ½é—¨å«**
```
ä¼ ç»Ÿå•ä½“åº”ç”¨ï¼š
å®¢æˆ·ç«¯ â†’ ç›´æ¥è®¿é—®åº”ç”¨

å¾®æœåŠ¡æ¶æ„ï¼š
å®¢æˆ·ç«¯ â†’ ç½‘å…³(é—¨å«) â†’ å„ç§å¾®æœåŠ¡
                     â†“
              ç”¨æˆ·æœåŠ¡ã€è®¢å•æœåŠ¡ã€æ”¯ä»˜æœåŠ¡...
```

**ç½‘å…³çš„ä½œç”¨å°±åƒé—¨å«ä¸€æ ·**ï¼š
- ğŸšª **ç»Ÿä¸€å…¥å£**ï¼šæ‰€æœ‰è¯·æ±‚éƒ½ä»è¿™é‡Œè¿›å…¥
- ğŸ” **èº«ä»½éªŒè¯**ï¼šæ£€æŸ¥è°èƒ½è¿›æ¥
- ğŸ§­ **è·¯ç”±åˆ†å‘**ï¼šæŒ‡å¼•å»å“ªä¸ªæœåŠ¡
- ğŸ›¡ï¸ **å®‰å…¨é˜²æŠ¤**ï¼šé˜»æŒ¡æ¶æ„è®¿é—®
- ğŸ“Š **ç›‘æ§è®°å½•**ï¼šè®°å½•è°æ¥è¿‡ã€åšäº†ä»€ä¹ˆ

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦ç½‘å…³


**æ²¡æœ‰ç½‘å…³çš„é—®é¢˜**ï¼š
```
å®¢æˆ·ç«¯éœ€è¦çŸ¥é“æ¯ä¸ªæœåŠ¡çš„åœ°å€ï¼š
- ç”¨æˆ·æœåŠ¡ï¼šhttp://user-service:8080
- è®¢å•æœåŠ¡ï¼šhttp://order-service:8081  
- æ”¯ä»˜æœåŠ¡ï¼šhttp://pay-service:8082

é—®é¢˜ï¼š
âœ— å®¢æˆ·ç«¯è¦ç®¡ç†å¾ˆå¤šæœåŠ¡åœ°å€
âœ— æ¯ä¸ªæœåŠ¡éƒ½è¦å¤„ç†è·¨åŸŸã€è®¤è¯ç­‰é€šç”¨é—®é¢˜
âœ— éš¾ä»¥ç»Ÿä¸€ç›‘æ§å’Œç®¡ç†
âœ— æœåŠ¡åœ°å€å˜æ›´å½±å“å®¢æˆ·ç«¯
```

**æœ‰äº†ç½‘å…³çš„å¥½å¤„**ï¼š
```
å®¢æˆ·ç«¯åªéœ€è¦çŸ¥é“ç½‘å…³åœ°å€ï¼š
- ç½‘å…³ï¼šhttp://api-gateway.com

ä¼˜åŠ¿ï¼š
âœ… å•ä¸€å…¥å£ï¼Œç®€åŒ–å®¢æˆ·ç«¯
âœ… ç»Ÿä¸€å¤„ç†è®¤è¯ã€è·¨åŸŸç­‰
âœ… é›†ä¸­ç›‘æ§å’Œç®¡ç†
âœ… æœåŠ¡åœ°å€å˜æ›´å¯¹å®¢æˆ·ç«¯é€æ˜
```

### 1.3 Nginxä½œä¸ºç½‘å…³çš„ä¼˜åŠ¿


**ä¸ºä»€ä¹ˆé€‰æ‹©Nginx**ï¼š

| ç‰¹æ€§ | Nginxä¼˜åŠ¿ | è¯´æ˜ |
|------|-----------|------|
| **é«˜æ€§èƒ½** | å•æœºå¤„ç†æ•°ä¸‡å¹¶å‘ | äº‹ä»¶é©±åŠ¨æ¶æ„ï¼Œèµ„æºæ¶ˆè€—ä½ |
| **æˆç†Ÿç¨³å®š** | ç”Ÿäº§ç¯å¢ƒéªŒè¯åå¤šå¹´ | å¤§é‡äº’è”ç½‘å…¬å¸åœ¨ä½¿ç”¨ |
| **é…ç½®çµæ´»** | å¼ºå¤§çš„é…ç½®è¯­æ³• | æ”¯æŒå¤æ‚çš„è·¯ç”±å’Œè½¬å‘è§„åˆ™ |
| **æ‰©å±•æ€§å¼º** | ä¸°å¯Œçš„æ¨¡å—ç”Ÿæ€ | é™æµã€è®¤è¯ã€æ—¥å¿—ç­‰æ¨¡å—é½å…¨ |
| **å­¦ä¹ æˆæœ¬ä½** | é…ç½®è¯­æ³•ç®€å• | ç›¸æ¯”å…¶ä»–ç½‘å…³æ›´å®¹æ˜“ä¸Šæ‰‹ |

---

## 2. ğŸ”§ APIç½‘å…³é…ç½®å®æˆ˜


### 2.1 åŸºç¡€ç½‘å…³æ¶æ„


**å®é™…åœºæ™¯**ï¼šå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªç”µå•†ç³»ç»Ÿ
```
ä¸šåŠ¡æ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å®¢æˆ·ç«¯     â”‚    â”‚           Nginxç½‘å…³              â”‚
â”‚  (Web/App)  â”‚â”€â”€â”€â–¶â”‚  ç«¯å£: 80/443                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  åŸŸå: api.shop.com             â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚             â–¼                   â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ç”¨æˆ·æœåŠ¡  â”‚  â”‚è®¢å•æœåŠ¡  â”‚  â”‚æ”¯ä»˜æœåŠ¡  â”‚
              â”‚:8080    â”‚  â”‚:8081    â”‚  â”‚:8082    â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒé…ç½®æ–‡ä»¶ç»“æ„


```nginx
# /etc/nginx/nginx.conf
# å…¨å±€é…ç½®
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;

events {
    worker_connections 1024;
    use epoll;
}

http {
    # åŸºç¡€è®¾ç½®
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    
    # æ—¥å¿—æ ¼å¼ï¼ˆç¨åè¯¦ç»†è®²è§£ï¼‰
    log_format gateway_log '$remote_addr - $remote_user [$time_local] '
                          '"$request" $status $body_bytes_sent '
                          '"$http_referer" "$http_user_agent" '
                          'upstream_addr="$upstream_addr" '
                          'upstream_response_time="$upstream_response_time"';
    
    # å¼•å…¥ç½‘å…³é…ç½®
    include /etc/nginx/conf.d/gateway.conf;
}
```

### 2.3 æœåŠ¡å‘ç°é…ç½®


**å®šä¹‰åç«¯æœåŠ¡é›†ç¾¤**ï¼š
```nginx
# /etc/nginx/conf.d/gateway.conf

# ç”¨æˆ·æœåŠ¡é›†ç¾¤
upstream user_service {
    # å¥åº·æ£€æŸ¥ï¼ˆéœ€è¦nginx-plusæˆ–ç¬¬ä¸‰æ–¹æ¨¡å—ï¼‰
    least_conn;  # æœ€å°‘è¿æ¥æ•°ç®—æ³•
    server 192.168.1.10:8080 weight=3 max_fails=2 fail_timeout=30s;
    server 192.168.1.11:8080 weight=2 max_fails=2 fail_timeout=30s;
    server 192.168.1.12:8080 weight=1 backup;  # å¤‡ç”¨æœåŠ¡å™¨
}

# è®¢å•æœåŠ¡é›†ç¾¤
upstream order_service {
    ip_hash;  # åŸºäºIPçš„ä¼šè¯ä¿æŒ
    server 192.168.1.20:8081 max_fails=3 fail_timeout=30s;
    server 192.168.1.21:8081 max_fails=3 fail_timeout=30s;
}

# æ”¯ä»˜æœåŠ¡é›†ç¾¤
upstream payment_service {
    server 192.168.1.30:8082 max_fails=2 fail_timeout=60s;
    server 192.168.1.31:8082 max_fails=2 fail_timeout=60s;
}
```

**é…ç½®è¯´æ˜**ï¼š
- `least_conn`ï¼šé€‰æ‹©è¿æ¥æ•°æœ€å°‘çš„æœåŠ¡å™¨
- `ip_hash`ï¼šåŒä¸€IPçš„è¯·æ±‚æ€»æ˜¯è½¬å‘åˆ°åŒä¸€å°æœåŠ¡å™¨
- `weight`ï¼šæƒé‡ï¼Œæ•°å­—è¶Šå¤§åˆ†é…çš„è¯·æ±‚è¶Šå¤š
- `max_fails`ï¼šæœ€å¤§å¤±è´¥æ¬¡æ•°
- `fail_timeout`ï¼šå¤±è´¥åå¤šé•¿æ—¶é—´ä¸å†å°è¯•
- `backup`ï¼šå¤‡ç”¨æœåŠ¡å™¨ï¼Œåªæœ‰ä¸»æœåŠ¡å™¨éƒ½ä¸å¯ç”¨æ—¶æ‰ä½¿ç”¨

---

## 3. ğŸ§­ æœåŠ¡è·¯ç”±è®¾è®¡


### 3.1 åŸºäºè·¯å¾„çš„è·¯ç”±


**æ ¸å¿ƒæ€æƒ³**ï¼šæ ¹æ®URLè·¯å¾„å†³å®šè½¬å‘åˆ°å“ªä¸ªæœåŠ¡

```nginx
server {
    listen 80;
    server_name api.shop.com;
    
    # é€šç”¨é…ç½®
    access_log /var/log/nginx/gateway.log gateway_log;
    
    # ç”¨æˆ·ç›¸å…³API
    location /api/users/ {
        # ç§»é™¤è·¯å¾„å‰ç¼€ï¼ˆå¯é€‰ï¼‰
        rewrite ^/api/users/(.*)$ /$1 break;
        proxy_pass http://user_service;
        
        # ä¼ é€’åŸå§‹è¯·æ±‚ä¿¡æ¯
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 5s;
        proxy_send_timeout 10s;
        proxy_read_timeout 10s;
    }
    
    # è®¢å•ç›¸å…³API
    location /api/orders/ {
        proxy_pass http://order_service/;
        include /etc/nginx/proxy_params;  # å…¬å…±ä»£ç†å‚æ•°
    }
    
    # æ”¯ä»˜ç›¸å…³API
    location /api/payments/ {
        proxy_pass http://payment_service/;
        include /etc/nginx/proxy_params;
    }
}
```

### 3.2 åŸºäºè¯·æ±‚å¤´çš„è·¯ç”±


**åº”ç”¨åœºæ™¯**ï¼šAPIç‰ˆæœ¬æ§åˆ¶ã€A/Bæµ‹è¯•

```nginx
# APIç‰ˆæœ¬è·¯ç”±
location /api/ {
    # é»˜è®¤è·¯ç”±åˆ°v1
    set $target_service "user_service";
    
    # æ ¹æ®Acceptå¤´å†³å®šç‰ˆæœ¬
    if ($http_accept ~* "application/vnd\.api\.v2") {
        set $target_service "user_service_v2";
    }
    
    proxy_pass http://$target_service;
    include /etc/nginx/proxy_params;
}

# A/Bæµ‹è¯•è·¯ç”±
location /api/feature/ {
    # æ ¹æ®ç”¨æˆ·æ ‡è¯†è¿›è¡Œç°åº¦
    if ($http_x_user_id ~* "[02468]$") {
        proxy_pass http://feature_service_beta;
        break;
    }
    
    proxy_pass http://feature_service_stable;
    include /etc/nginx/proxy_params;
}
```

### 3.3 æ™ºèƒ½è·¯ç”±é…ç½®


**é«˜çº§è·¯ç”±è§„åˆ™**ï¼š
```nginx
# ç§»åŠ¨ç«¯ä¸“ç”¨è·¯ç”±
location /mobile/ {
    if ($http_user_agent ~* "(Mobile|Android|iPhone)") {
        proxy_pass http://mobile_service/;
        break;
    }
    
    # éç§»åŠ¨ç«¯é‡å®šå‘åˆ°ä¸»ç«™
    return 302 https://www.shop.com$request_uri;
}

# åœ°ç†ä½ç½®è·¯ç”±ï¼ˆéœ€è¦GeoIPæ¨¡å—ï¼‰
location /api/geo/ {
    # æ ¹æ®åœ°ç†ä½ç½®é€‰æ‹©æœåŠ¡
    if ($geoip_country_code = "CN") {
        proxy_pass http://china_service/;
    }
    if ($geoip_country_code = "US") {
        proxy_pass http://us_service/;
    }
    
    # é»˜è®¤æœåŠ¡
    proxy_pass http://global_service/;
}
```

---

## 4. âš–ï¸ è´Ÿè½½å‡è¡¡ç­–ç•¥


### 4.1 å¸¸ç”¨è´Ÿè½½å‡è¡¡ç®—æ³•


**è½®è¯¢(Round Robin) - é»˜è®¤ç®—æ³•**ï¼š
```nginx
upstream backend {
    server 192.168.1.10:8080;
    server 192.168.1.11:8080;
    server 192.168.1.12:8080;
}
# è¯·æ±‚ä¾æ¬¡åˆ†é…ï¼š10â†’11â†’12â†’10â†’11â†’12...
```

**åŠ æƒè½®è¯¢(Weighted Round Robin)**ï¼š
```nginx
upstream backend {
    server 192.168.1.10:8080 weight=3;  # åˆ†é…3ä¸ªè¯·æ±‚
    server 192.168.1.11:8080 weight=2;  # åˆ†é…2ä¸ªè¯·æ±‚  
    server 192.168.1.12:8080 weight=1;  # åˆ†é…1ä¸ªè¯·æ±‚
}
# åˆ†é…æ¯”ä¾‹ 3:2:1
```

**æœ€å°‘è¿æ¥(Least Connections)**ï¼š
```nginx
upstream backend {
    least_conn;  # é€‰æ‹©å½“å‰è¿æ¥æ•°æœ€å°‘çš„æœåŠ¡å™¨
    server 192.168.1.10:8080;
    server 192.168.1.11:8080;
    server 192.168.1.12:8080;
}
```

**IPå“ˆå¸Œ(IP Hash)**ï¼š
```nginx
upstream backend {
    ip_hash;  # åŒä¸€IPæ€»æ˜¯è®¿é—®åŒä¸€å°æœåŠ¡å™¨
    server 192.168.1.10:8080;
    server 192.168.1.11:8080;
    server 192.168.1.12:8080;
}
```

### 4.2 å¥åº·æ£€æŸ¥é…ç½®


**è¢«åŠ¨å¥åº·æ£€æŸ¥**ï¼ˆåŸºäºå“åº”çŠ¶æ€ï¼‰ï¼š
```nginx
upstream backend {
    server 192.168.1.10:8080 max_fails=3 fail_timeout=30s;
    server 192.168.1.11:8080 max_fails=3 fail_timeout=30s;
    
    # å¤‡ç”¨æœåŠ¡å™¨
    server 192.168.1.100:8080 backup;
}
```

**ä¸»åŠ¨å¥åº·æ£€æŸ¥**ï¼ˆéœ€è¦ç¬¬ä¸‰æ–¹æ¨¡å—ï¼‰ï¼š
```nginx
upstream backend {
    server 192.168.1.10:8080;
    server 192.168.1.11:8080;
    
    # éœ€è¦nginx_upstream_check_module
    check interval=3000 rise=2 fall=5 timeout=1000 type=http;
    check_http_send "GET /health HTTP/1.0\r\n\r\n";
    check_http_expect_alive http_2xx http_3xx;
}
```

### 4.3 ä¼šè¯ä¿æŒç­–ç•¥


**åŸºäºCookieçš„ä¼šè¯ä¿æŒ**ï¼š
```nginx
upstream backend {
    # ä½¿ç”¨ç¬¬ä¸‰æ–¹stickyæ¨¡å—
    sticky cookie srv_id expires=1h path=/;
    server 192.168.1.10:8080;
    server 192.168.1.11:8080;
}
```

**åŸºäºè¯·æ±‚å¤´çš„ä¼šè¯ä¿æŒ**ï¼š
```nginx
location /api/ {
    # æ ¹æ®ç”¨æˆ·IDå“ˆå¸Œ
    set $backend_pool backend;
    if ($http_x_user_id) {
        set_by_lua_block $backend_pool {
            local user_id = ngx.var.http_x_user_id
            local hash = ngx.crc32_long(user_id)
            local server_index = hash % 3 + 1
            return "backend_" .. server_index
        }
    }
    
    proxy_pass http://$backend_pool;
}
```

---

## 5. ğŸ”„ ç†”æ–­é™çº§æœºåˆ¶


### 5.1 ç†”æ–­å™¨åŸºæœ¬æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯ç†”æ–­å™¨**ï¼š
```
æ­£å¸¸æƒ…å†µï¼š
å®¢æˆ·ç«¯ â†’ ç½‘å…³ â†’ æœåŠ¡ â†’ æ­£å¸¸å“åº”

æœåŠ¡å¼‚å¸¸æ—¶ï¼š
å®¢æˆ·ç«¯ â†’ ç½‘å…³ â†’ æœåŠ¡ â†’ è¶…æ—¶/é”™è¯¯
              â†“
           ç†”æ–­å™¨å¼€å¯
              â†“
å®¢æˆ·ç«¯ â†’ ç½‘å…³ â†’ ç›´æ¥è¿”å›é™çº§å“åº”
```

**ç†”æ–­å™¨çŠ¶æ€**ï¼š
- ğŸŸ¢ **é—­åˆçŠ¶æ€**ï¼šæ­£å¸¸è½¬å‘è¯·æ±‚
- ğŸŸ¡ **åŠå¼€çŠ¶æ€**ï¼šå…è®¸å°‘é‡è¯·æ±‚æµ‹è¯•æœåŠ¡æ˜¯å¦æ¢å¤
- ğŸ”´ **æ‰“å¼€çŠ¶æ€**ï¼šç›´æ¥è¿”å›é™çº§å“åº”ï¼Œä¸è½¬å‘è¯·æ±‚

### 5.2 åŸºäºå“åº”æ—¶é—´çš„ç†”æ–­


```nginx
# å®šä¹‰é”™è¯¯é¡µé¢
error_page 502 503 504 @fallback;

upstream backend {
    server 192.168.1.10:8080 max_fails=3 fail_timeout=30s;
    server 192.168.1.11:8080 max_fails=3 fail_timeout=30s;
}

location /api/users/ {
    proxy_pass http://backend;
    
    # è¶…æ—¶è®¾ç½®
    proxy_connect_timeout 2s;
    proxy_send_timeout 5s;
    proxy_read_timeout 5s;
    
    # é”™è¯¯å¤„ç†
    proxy_next_upstream error timeout http_502 http_503 http_504;
    proxy_next_upstream_tries 2;
    proxy_next_upstream_timeout 10s;
}

# é™çº§å¤„ç†
location @fallback {
    default_type application/json;
    return 200 '{"code": 503, "message": "æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•"}';
}
```

### 5.3 åŸºäºé”™è¯¯ç‡çš„ç†”æ–­


**ä½¿ç”¨Luaè„šæœ¬å®ç°æ™ºèƒ½ç†”æ–­**ï¼š
```nginx
location /api/orders/ {
    access_by_lua_block {
        local redis = require "resty.redis"
        local red = redis:new()
        red:connect("127.0.0.1", 6379)
        
        local service_key = "circuit_breaker:order_service"
        local current_time = ngx.time()
        local window_size = 60  -- æ—¶é—´çª—å£60ç§’
        
        -- æ£€æŸ¥ç†”æ–­çŠ¶æ€
        local circuit_state = red:get(service_key .. ":state")
        if circuit_state == "OPEN" then
            local open_time = red:get(service_key .. ":open_time")
            if current_time - open_time < 30 then  -- ç†”æ–­30ç§’
                ngx.status = 503
                ngx.say('{"code": 503, "message": "æœåŠ¡ç†”æ–­ä¸­"}')
                ngx.exit(503)
            else
                -- è¿›å…¥åŠå¼€çŠ¶æ€
                red:set(service_key .. ":state", "HALF_OPEN")
            end
        end
    }
    
    proxy_pass http://order_service;
    
    # è®°å½•å“åº”çŠ¶æ€
    log_by_lua_block {
        local redis = require "resty.redis"
        local red = redis:new()
        red:connect("127.0.0.1", 6379)
        
        local service_key = "circuit_breaker:order_service"
        local status = ngx.status
        
        -- ç»Ÿè®¡æˆåŠŸ/å¤±è´¥æ¬¡æ•°
        if status >= 500 then
            red:incr(service_key .. ":errors")
        else
            red:incr(service_key .. ":success")
        end
        
        -- æ£€æŸ¥æ˜¯å¦éœ€è¦å¼€å¯ç†”æ–­
        local errors = red:get(service_key .. ":errors") or 0
        local total = (red:get(service_key .. ":success") or 0) + errors
        
        if total >= 10 and errors / total > 0.5 then
            red:set(service_key .. ":state", "OPEN")
            red:set(service_key .. ":open_time", ngx.time())
        end
    }
}
```

### 5.4 é™çº§ç­–ç•¥è®¾è®¡


**å¤šçº§é™çº§æ–¹æ¡ˆ**ï¼š
```nginx
# ä¸€çº§é™çº§ï¼šè¿”å›ç¼“å­˜æ•°æ®
location @level1_fallback {
    default_type application/json;
    # å¯ä»¥ä»Redisæˆ–æ–‡ä»¶è¯»å–ç¼“å­˜æ•°æ®
    return 200 '{"code": 200, "data": "cached_data", "from_cache": true}';
}

# äºŒçº§é™çº§ï¼šè¿”å›é»˜è®¤æ•°æ®
location @level2_fallback {
    default_type application/json;
    return 200 '{"code": 200, "data": [], "message": "ä½¿ç”¨é»˜è®¤æ•°æ®"}';
}

# ä¸‰çº§é™çº§ï¼šè¿”å›é”™è¯¯ä¿¡æ¯
location @level3_fallback {
    default_type application/json;
    return 503 '{"code": 503, "message": "æœåŠ¡æš‚æ—¶ä¸å¯ç”¨"}';
}
```

---

## 6. ğŸš¦ é™æµç­–ç•¥å®ç°


### 6.1 é™æµåŸºæœ¬æ¦‚å¿µ


**ä¸ºä»€ä¹ˆéœ€è¦é™æµ**ï¼š
```
æ­£å¸¸æµé‡ï¼š
æ¯ç§’100ä¸ªè¯·æ±‚ â†’ æœåŠ¡æ­£å¸¸å¤„ç†

çªå‘æµé‡ï¼š
æ¯ç§’10000ä¸ªè¯·æ±‚ â†’ æœåŠ¡å‹å®ï¼Œæ•´ä½“ä¸å¯ç”¨

é™æµä¿æŠ¤ï¼š
æ¯ç§’æœ€å¤š1000ä¸ªè¯·æ±‚ â†’ è¶…å‡ºéƒ¨åˆ†è¢«é™åˆ¶ï¼ŒæœåŠ¡ç¨³å®šè¿è¡Œ
```

### 6.2 è¯·æ±‚é¢‘ç‡é™åˆ¶


**åŸºäºIPçš„é™æµ**ï¼š
```nginx
http {
    # å®šä¹‰é™æµåŒºåŸŸ
    limit_req_zone $binary_remote_addr zone=per_ip:10m rate=10r/s;
    limit_req_zone $server_name zone=per_server:10m rate=100r/s;
    
    server {
        location /api/ {
            # åº”ç”¨é™æµè§„åˆ™
            limit_req zone=per_ip burst=20 nodelay;
            limit_req zone=per_server burst=50 nodelay;
            
            proxy_pass http://backend;
        }
    }
}
```

**é…ç½®å‚æ•°è§£é‡Š**ï¼š
- `rate=10r/s`ï¼šæ¯ç§’å…è®¸10ä¸ªè¯·æ±‚
- `burst=20`ï¼šå…è®¸çªå‘20ä¸ªè¯·æ±‚æ’é˜Ÿ
- `nodelay`ï¼šä¸å»¶è¿Ÿå¤„ç†çªå‘è¯·æ±‚ï¼Œè¶…å‡ºç›´æ¥æ‹’ç»

### 6.3 è¿æ¥æ•°é™åˆ¶


```nginx
http {
    # é™åˆ¶å¹¶å‘è¿æ¥æ•°
    limit_conn_zone $binary_remote_addr zone=conn_per_ip:10m;
    limit_conn_zone $server_name zone=conn_per_server:10m;
    
    server {
        location /api/ {
            # æ¯ä¸ªIPæœ€å¤š10ä¸ªå¹¶å‘è¿æ¥
            limit_conn conn_per_ip 10;
            # æ•´ä¸ªæœåŠ¡å™¨æœ€å¤š1000ä¸ªå¹¶å‘è¿æ¥
            limit_conn conn_per_server 1000;
            
            proxy_pass http://backend;
        }
    }
}
```

### 6.4 æ™ºèƒ½é™æµç­–ç•¥


**åŸºäºç”¨æˆ·çº§åˆ«çš„é™æµ**ï¼š
```nginx
# æ ¹æ®ç”¨æˆ·ç±»å‹è®¾ç½®ä¸åŒé™æµè§„åˆ™
map $http_x_user_type $limit_key {
    "vip"     $binary_remote_addr;        # VIPç”¨æˆ·
    "premium" $binary_remote_addr;        # é«˜çº§ç”¨æˆ·  
    default   $binary_remote_addr;        # æ™®é€šç”¨æˆ·
}

# ä¸åŒç”¨æˆ·ç±»å‹çš„é™æµåŒºåŸŸ
limit_req_zone $limit_key zone=vip_zone:10m rate=100r/s;
limit_req_zone $limit_key zone=premium_zone:10m rate=50r/s;
limit_req_zone $limit_key zone=normal_zone:10m rate=10r/s;

server {
    location /api/ {
        # æ ¹æ®ç”¨æˆ·ç±»å‹åº”ç”¨ä¸åŒé™æµ
        if ($http_x_user_type = "vip") {
            limit_req zone=vip_zone burst=50 nodelay;
        }
        if ($http_x_user_type = "premium") {
            limit_req zone=premium_zone burst=30 nodelay;
        }
        if ($http_x_user_type = "") {
            limit_req zone=normal_zone burst=10 nodelay;
        }
        
        proxy_pass http://backend;
    }
}
```

### 6.5 é™æµå“åº”å®šåˆ¶


```nginx
# è‡ªå®šä¹‰é™æµé”™è¯¯é¡µé¢
error_page 429 @rate_limit_error;

location @rate_limit_error {
    default_type application/json;
    add_header X-Rate-Limit-Exceeded true;
    return 429 '{
        "code": 429,
        "message": "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•",
        "retry_after": 60
    }';
}

# è®¾ç½®é™æµæ—¥å¿—
location /api/ {
    limit_req zone=per_ip burst=10 nodelay;
    limit_req_log_level warn;
    limit_req_status 429;
    
    proxy_pass http://backend;
}
```

---

## 7. ğŸ“Š ç›‘æ§æ—¥å¿—é…ç½®


### 7.1 è¯¦ç»†æ—¥å¿—æ ¼å¼è®¾è®¡


```nginx
# ç½‘å…³ä¸“ç”¨æ—¥å¿—æ ¼å¼
log_format gateway_access '$remote_addr - $remote_user [$time_local] '
                         '"$request" $status $body_bytes_sent '
                         '"$http_referer" "$http_user_agent" '
                         'rt=$request_time '
                         'uct="$upstream_connect_time" '
                         'uht="$upstream_header_time" '
                         'urt="$upstream_response_time" '
                         'upstream="$upstream_addr" '
                         'host="$host" '
                         'xff="$http_x_forwarded_for"';

# é”™è¯¯è¿½è¸ªæ—¥å¿—æ ¼å¼
log_format gateway_error '$time_local $remote_addr "$request" '
                        '$status $upstream_addr $upstream_status '
                        '$upstream_response_time $request_time';
```

### 7.2 ç»“æ„åŒ–æ—¥å¿—è¾“å‡º


**JSONæ ¼å¼æ—¥å¿—**ï¼š
```nginx
log_format json_gateway escape=json
    '{'
    '"timestamp":"$time_iso8601",'
    '"remote_addr":"$remote_addr",'
    '"request_method":"$request_method",'
    '"request_uri":"$request_uri",'
    '"status":$status,'
    '"body_bytes_sent":$body_bytes_sent,'
    '"request_time":$request_time,'
    '"upstream_addr":"$upstream_addr",'
    '"upstream_status":"$upstream_status",'
    '"upstream_response_time":"$upstream_response_time",'
    '"user_agent":"$http_user_agent",'
    '"referer":"$http_referer"'
    '}';

server {
    access_log /var/log/nginx/gateway.json json_gateway;
    error_log /var/log/nginx/gateway_error.log warn;
}
```

### 7.3 å…³é”®æŒ‡æ ‡ç›‘æ§


**æ€§èƒ½ç›‘æ§é…ç½®**ï¼š
```nginx
server {
    location /api/ {
        # è®°å½•è¯¦ç»†çš„å“åº”æ—¶é—´
        add_header X-Response-Time $request_time;
        add_header X-Upstream-Addr $upstream_addr;
        add_header X-Upstream-Response-Time $upstream_response_time;
        
        proxy_pass http://backend;
    }
    
    # å¥åº·æ£€æŸ¥ç«¯ç‚¹
    location /nginx-health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
    
    # NginxçŠ¶æ€ç›‘æ§
    location /nginx-status {
        stub_status on;
        access_log off;
        allow 127.0.0.1;
        deny all;
    }
}
```

### 7.4 æ—¥å¿—è½®è½¬å’Œç®¡ç†


**æ—¥å¿—è½®è½¬é…ç½®**ï¼š
```bash
# /etc/logrotate.d/nginx-gateway
/var/log/nginx/gateway*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    sharedscripts
    postrotate
        /bin/kill -USR1 `cat /var/run/nginx.pid 2>/dev/null` 2>/dev/null || true
    endscript
}
```

### 7.5 å®æ—¶ç›‘æ§é›†æˆ


**ä¸ç›‘æ§ç³»ç»Ÿé›†æˆ**ï¼š
```nginx
# å¯¼å‡ºPrometheusæŒ‡æ ‡ï¼ˆéœ€è¦nginx-prometheus-exporterï¼‰
location /metrics {
    access_log off;
    allow 10.0.0.0/8;
    deny all;
    
    # è¿”å›NginxæŒ‡æ ‡
    stub_status on;
}

# è‡ªå®šä¹‰ä¸šåŠ¡æŒ‡æ ‡
location /api/ {
    # è®°å½•ä¸šåŠ¡æŒ‡æ ‡åˆ°æ—¥å¿—
    log_by_lua_block {
        local method = ngx.var.request_method
        local status = ngx.status
        local service = ngx.var.upstream_addr
        
        -- å‘é€æŒ‡æ ‡åˆ°ç›‘æ§ç³»ç»Ÿ
        -- (è¿™é‡Œå¯ä»¥é›†æˆStatsDã€Prometheusç­‰)
        ngx.log(ngx.INFO, string.format(
            "METRIC: method=%s status=%d service=%s time=%s",
            method, status, service, ngx.var.request_time
        ))
    }
    
    proxy_pass http://backend;
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 ç½‘å…³æ ¸å¿ƒåŠŸèƒ½å›é¡¾


```
ğŸŒ ç»Ÿä¸€å…¥å£ï¼šæ‰€æœ‰è¯·æ±‚çš„å”¯ä¸€å…¥å£ç‚¹
ğŸ§­ è·¯ç”±åˆ†å‘ï¼šæ ¹æ®è§„åˆ™å°†è¯·æ±‚è½¬å‘åˆ°å¯¹åº”æœåŠ¡
âš–ï¸ è´Ÿè½½å‡è¡¡ï¼šåœ¨å¤šä¸ªæœåŠ¡å®ä¾‹é—´åˆ†é…è¯·æ±‚
ğŸ›¡ï¸ å®‰å…¨é˜²æŠ¤ï¼šè®¤è¯ã€æˆæƒã€é™æµã€é˜²æ”»å‡»
ğŸ”„ ç†”æ–­é™çº§ï¼šæœåŠ¡å¼‚å¸¸æ—¶çš„ä¿æŠ¤æœºåˆ¶
ğŸ“Š ç›‘æ§æ—¥å¿—ï¼šå…¨é¢çš„è¯·æ±‚è·Ÿè¸ªå’Œæ€§èƒ½ç›‘æ§
```

### 8.2 å…³é”®é…ç½®è¦ç‚¹


**ğŸ”¹ upstreamé…ç½®æœ€ä½³å®è·µ**ï¼š
```
é€‰æ‹©åˆé€‚çš„è´Ÿè½½å‡è¡¡ç®—æ³•ï¼š
- æ— çŠ¶æ€æœåŠ¡ï¼šè½®è¯¢æˆ–æœ€å°‘è¿æ¥
- æœ‰çŠ¶æ€æœåŠ¡ï¼šIPå“ˆå¸Œæˆ–stickyä¼šè¯
- æ€§èƒ½å·®å¼‚å¤§ï¼šåŠ æƒè½®è¯¢

å¥åº·æ£€æŸ¥å¿…é¡»é…ç½®ï¼š
- è®¾ç½®åˆç†çš„max_failså’Œfail_timeout
- é…ç½®backupæœåŠ¡å™¨ä½œä¸ºåå¤‡
- è€ƒè™‘ä½¿ç”¨ä¸»åŠ¨å¥åº·æ£€æŸ¥
```

**ğŸ”¹ proxyé…ç½®è¦ç‚¹**ï¼š
```
è¶…æ—¶è®¾ç½®è¦åˆç†ï¼š
- connect_timeout: 2-5ç§’
- send_timeout: 5-30ç§’  
- read_timeout: 10-60ç§’

è¯·æ±‚å¤´ä¼ é€’è¦å®Œæ•´ï¼š
- Host, X-Real-IP, X-Forwarded-Forå¿…é¡»è®¾ç½®
- è‡ªå®šä¹‰ä¸šåŠ¡å¤´è¦æ­£ç¡®ä¼ é€’
```

**ğŸ”¹ é™æµç­–ç•¥è®¾è®¡**ï¼š
```
å¤šç»´åº¦é™æµï¼š
- IPçº§åˆ«ï¼šé˜²æ­¢å•ç‚¹æ”»å‡»
- ç”¨æˆ·çº§åˆ«ï¼šå·®å¼‚åŒ–æœåŠ¡è´¨é‡
- æ¥å£çº§åˆ«ï¼šä¿æŠ¤æ ¸å¿ƒä¸šåŠ¡

é™æµå‚æ•°è¦åˆç†ï¼š
- rateä¸å®œè¿‡å°ï¼Œå½±å“æ­£å¸¸ç”¨æˆ·
- burstè¦è€ƒè™‘çªå‘æµé‡
- é”™è¯¯å“åº”è¦ç”¨æˆ·å‹å¥½
```

### 8.3 ç”Ÿäº§ç¯å¢ƒå»ºè®®


**ğŸš€ æ€§èƒ½ä¼˜åŒ–å»ºè®®**ï¼š
- âœ… ä½¿ç”¨`worker_processes auto`è‡ªåŠ¨æ£€æµ‹CPUæ ¸æ•°
- âœ… é€‚å½“å¢å¤§`worker_connections`æé«˜å¹¶å‘
- âœ… å¯ç”¨`sendfile`å’Œ`tcp_nopush`ä¼˜åŒ–æ–‡ä»¶ä¼ è¾“
- âœ… é…ç½®åˆç†çš„ç¼“å†²åŒºå¤§å°
- âœ… ä½¿ç”¨HTTP/2æé«˜ä¼ è¾“æ•ˆç‡

**ğŸ”’ å®‰å…¨åŠ å›ºå»ºè®®**ï¼š
- âœ… éšè—Nginxç‰ˆæœ¬ä¿¡æ¯
- âœ… é…ç½®åˆç†çš„rate limiting
- âœ… å®æ–½IPç™½åå•/é»‘åå•
- âœ… å¯ç”¨HTTPSå’Œå®‰å…¨å¤´
- âœ… å®šæœŸæ›´æ–°Nginxç‰ˆæœ¬

**ğŸ“Š ç›‘æ§å‘Šè­¦å»ºè®®**ï¼š
- âœ… ç›‘æ§å“åº”æ—¶é—´å’Œé”™è¯¯ç‡
- âœ… è®¾ç½®æœåŠ¡å¯ç”¨æ€§å‘Šè­¦
- âœ… è·Ÿè¸ªå¼‚å¸¸æµé‡æ¨¡å¼
- âœ… å»ºç«‹å®¹é‡è§„åˆ’åŸºçº¿
- âœ… é…ç½®æ—¥å¿—èšåˆå’Œåˆ†æ

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- Nginxç½‘å…³æ˜¯å¾®æœåŠ¡æ¶æ„çš„é‡è¦åŸºç¡€è®¾æ–½
- åˆç†çš„è·¯ç”±å’Œè´Ÿè½½å‡è¡¡ç­–ç•¥æ˜¯æ ¸å¿ƒ
- ç†”æ–­é™çº§å’Œé™æµæ˜¯ä¿éšœç³»ç»Ÿç¨³å®šçš„å…³é”®
- å®Œå–„çš„ç›‘æ§æ—¥å¿—æ˜¯è¿ç»´çš„é‡è¦ä¾æ®
- é…ç½®è¦åœ¨æ€§èƒ½ã€å®‰å…¨ã€å¯ç»´æŠ¤æ€§ä¹‹é—´æ‰¾åˆ°å¹³è¡¡