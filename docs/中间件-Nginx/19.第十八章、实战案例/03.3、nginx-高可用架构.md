---
title: 3ã€nginx-é«˜å¯ç”¨æ¶æ„
---
## ğŸ“š ç›®å½•

1. [é«˜å¯ç”¨æ¶æ„åŸºç¡€æ¦‚å¿µ](#1-é«˜å¯ç”¨æ¶æ„åŸºç¡€æ¦‚å¿µ)
2. [ä¸»å¤‡åˆ‡æ¢æœºåˆ¶](#2-ä¸»å¤‡åˆ‡æ¢æœºåˆ¶)
3. [è´Ÿè½½å‡è¡¡é«˜å¯ç”¨æ–¹æ¡ˆ](#3-è´Ÿè½½å‡è¡¡é«˜å¯ç”¨æ–¹æ¡ˆ)
4. [ä¼šè¯ä¿æŒç­–ç•¥](#4-ä¼šè¯ä¿æŒç­–ç•¥)
5. [æ•…éšœè½¬ç§»ä¸è‡ªåŠ¨æ¢å¤](#5-æ•…éšœè½¬ç§»ä¸è‡ªåŠ¨æ¢å¤)
6. [æœåŠ¡å‘ç°ä¸å¥åº·æ£€æŸ¥](#6-æœåŠ¡å‘ç°ä¸å¥åº·æ£€æŸ¥)
7. [å®¹ç¾å¤‡ä»½ç­–ç•¥](#7-å®¹ç¾å¤‡ä»½ç­–ç•¥)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ é«˜å¯ç”¨æ¶æ„åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯é«˜å¯ç”¨


**ç®€å•ç†è§£**ï¼šé«˜å¯ç”¨å°±åƒç»™ä½ çš„ç½‘ç«™è¯·äº†å¤šä¸ªä¿å®‰ï¼Œä¸€ä¸ªä¿å®‰ç”Ÿç—…äº†ï¼Œå…¶ä»–ä¿å®‰ç«‹åˆ»é¡¶ä¸Šï¼Œç”¨æˆ·æ„Ÿè§‰ä¸åˆ°ä»»ä½•å¼‚å¸¸ã€‚

> ğŸ’¡ **é«˜å¯ç”¨å®šä¹‰**ï¼šç³»ç»Ÿåœ¨é¢å¯¹ç¡¬ä»¶æ•…éšœã€è½¯ä»¶é”™è¯¯ã€ç½‘ç»œä¸­æ–­ç­‰é—®é¢˜æ—¶ï¼Œä»èƒ½ç»§ç»­æä¾›æœåŠ¡çš„èƒ½åŠ›

**ç”Ÿæ´»ä¸­çš„ç±»æ¯”**ï¼š
```
é“¶è¡ŒATMæœº â†’ ä¸€å°åäº†ï¼Œå…¶ä»–ATMç»§ç»­å·¥ä½œ
ç”µæ¢¯ç³»ç»Ÿ â†’ ä¸€éƒ¨ç”µæ¢¯ç»´ä¿®ï¼Œå…¶ä»–ç”µæ¢¯æ­£å¸¸è¿è¡Œ
ç½‘ç«™æœåŠ¡ â†’ ä¸€å°æœåŠ¡å™¨å®•æœºï¼Œå…¶ä»–æœåŠ¡å™¨æ¥ç®¡æµé‡
```

### 1.2 é«˜å¯ç”¨çš„æ ¸å¿ƒæŒ‡æ ‡


**å¯ç”¨æ€§ç­‰çº§**ï¼š
- â­ **90%** (8.76å¤©/å¹´æ•…éšœ) â†’ åŸºç¡€å¯ç”¨
- â­â­ **99%** (3.65å¤©/å¹´æ•…éšœ) â†’ æ ‡å‡†å¯ç”¨  
- â­â­â­ **99.9%** (8.76å°æ—¶/å¹´æ•…éšœ) â†’ é«˜å¯ç”¨
- â­â­â­â­ **99.99%** (52.56åˆ†é’Ÿ/å¹´æ•…éšœ) â†’ æé«˜å¯ç”¨

> âš ï¸ **æ–°æ‰‹ç†è§£**ï¼š99.9%çœ‹èµ·æ¥å¾ˆé«˜ï¼Œä½†æ„å‘³ç€ä¸€å¹´å¯ä»¥å®•æœº8.76å°æ—¶ï¼Œå¯¹ç”µå•†ç½‘ç«™æ¥è¯´æŸå¤±å·¨å¤§

### 1.3 é«˜å¯ç”¨æ¶æ„çš„åŸºæœ¬æ€è·¯


**å•ç‚¹æ•…éšœé—®é¢˜**ï¼š
```
ä¼ ç»Ÿæ¶æ„é—®é¢˜ï¼š
ç”¨æˆ· â†’ [å•å°Nginx] â†’ åç«¯æœåŠ¡
           â†‘
      å¦‚æœè¿™é‡ŒæŒ‚äº†ï¼Œæ•´ä¸ªç½‘ç«™å°±ä¸èƒ½è®¿é—®äº†
```

**é«˜å¯ç”¨è§£å†³æ–¹æ¡ˆ**ï¼š
```
é«˜å¯ç”¨æ¶æ„ï¼š
ç”¨æˆ· â†’ [ä¸»Nginx] â† è™šæ‹ŸIPè‡ªåŠ¨åˆ‡æ¢
       [å¤‡Nginx] 
           â†“
       åç«¯æœåŠ¡é›†ç¾¤

æ ¸å¿ƒæ€æƒ³ï¼šæ¶ˆé™¤å•ç‚¹æ•…éšœï¼Œä»»ä½•ä¸€ä¸ªç»„ä»¶æŒ‚äº†éƒ½æœ‰å¤‡ç”¨
```

---

## 2. ğŸ”„ ä¸»å¤‡åˆ‡æ¢æœºåˆ¶


### 2.1 ä»€ä¹ˆæ˜¯ä¸»å¤‡åˆ‡æ¢


**é€šä¿—è§£é‡Š**ï¼šå°±åƒå­¦æ ¡é‡Œçš„ç­é•¿å’Œå‰¯ç­é•¿ï¼Œç­é•¿ä¸åœ¨çš„æ—¶å€™å‰¯ç­é•¿è‡ªåŠ¨æ¥ç®¡ç­çº§äº‹åŠ¡ã€‚

```
ä¸»å¤‡æ¨¡å¼æ¶æ„å›¾ï¼š

                  è™šæ‹ŸIP: 192.168.1.100
                         â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                     â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”  å¿ƒè·³æ£€æµ‹  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚ä¸»Nginxâ”‚ â†â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚å¤‡Nginxâ”‚          â”‚
â”‚Active â”‚            â”‚Standbyâ”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
    â”‚                                     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
                   åç«¯æœåŠ¡å™¨é›†ç¾¤
```

### 2.2 Keepalivedå®ç°ä¸»å¤‡åˆ‡æ¢


**Keepalivedç®€ä»‹**ï¼š
- **ä½œç”¨**ï¼šä¸“é—¨ç”¨æ¥å®ç°æœåŠ¡é«˜å¯ç”¨çš„å·¥å…·
- **åŸç†**ï¼šé€šè¿‡VRRPåè®®å®ç°è™šæ‹ŸIPçš„è‡ªåŠ¨åˆ‡æ¢
- **ä¼˜åŠ¿**ï¼šé…ç½®ç®€å•ï¼Œåˆ‡æ¢é€Ÿåº¦å¿«ï¼ˆç§’çº§ï¼‰

> ğŸ’¡ **VRRPåè®®**ï¼šVirtual Router Redundancy Protocolï¼Œè™šæ‹Ÿè·¯ç”±å†—ä½™åè®®ï¼Œè¯´ç™½äº†å°±æ˜¯è®©å¤šå°æœºå™¨å…±äº«ä¸€ä¸ªè™šæ‹ŸIP

**ä¸»æœåŠ¡å™¨Keepalivedé…ç½®**ï¼š
```bash
# /etc/keepalived/keepalived.conf
vrrp_script nginx_check {
    script "/etc/keepalived/check_nginx.sh"
    interval 2          # æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡
    weight -20          # å¤±è´¥æ—¶æƒé‡é™ä½20
    fall 3              # è¿ç»­3æ¬¡å¤±è´¥æ‰åˆ¤å®šæ•…éšœ
}

vrrp_instance VI_1 {
    state MASTER        # ä¸»æœåŠ¡å™¨çŠ¶æ€
    interface eth0      # ç½‘å¡æ¥å£
    virtual_router_id 101
    priority 110        # ä¼˜å…ˆçº§ï¼ˆä¸»æœåŠ¡å™¨è®¾ç½®æ›´é«˜ï¼‰
    advert_int 1        # å¿ƒè·³é—´éš”1ç§’
    
    authentication {
        auth_type PASS
        auth_pass 123456
    }
    
    virtual_ipaddress {
        192.168.1.100   # è™šæ‹ŸIPåœ°å€
    }
    
    track_script {
        nginx_check     # å…³è”Nginxæ£€æŸ¥è„šæœ¬
    }
}
```

**Nginxå¥åº·æ£€æŸ¥è„šæœ¬**ï¼š
```bash
#!/bin/bash
# /etc/keepalived/check_nginx.sh

# æ£€æŸ¥Nginxè¿›ç¨‹æ˜¯å¦å­˜åœ¨
if ! pgrep nginx > /dev/null; then
    echo "Nginxè¿›ç¨‹ä¸å­˜åœ¨ï¼Œå°è¯•å¯åŠ¨..."
    systemctl start nginx
    sleep 2
    
    # å†æ¬¡æ£€æŸ¥ï¼Œå¦‚æœè¿˜æ˜¯ä¸å­˜åœ¨åˆ™åˆ‡æ¢
    if ! pgrep nginx > /dev/null; then
        echo "Nginxå¯åŠ¨å¤±è´¥ï¼Œè§¦å‘ä¸»å¤‡åˆ‡æ¢"
        exit 1
    fi
fi

# æ£€æŸ¥Nginxæ˜¯å¦èƒ½æ­£å¸¸å“åº”
curl -f http://localhost > /dev/null 2>&1
if [ $? -ne 0 ]; then
    echo "Nginxæ— æ³•æ­£å¸¸å“åº”"
    exit 1
fi

echo "Nginxè¿è¡Œæ­£å¸¸"
exit 0
```

### 2.3 ä¸»å¤‡åˆ‡æ¢æµç¨‹


**æ­£å¸¸å·¥ä½œæµç¨‹**ï¼š
```
æ­¥éª¤1ï¼šä¸»æœåŠ¡å™¨æ­£å¸¸å·¥ä½œï¼Œè™šæ‹ŸIPç»‘å®šåœ¨ä¸»æœåŠ¡å™¨
æ­¥éª¤2ï¼šä¸»å¤‡æœåŠ¡å™¨äº’ç›¸å‘é€å¿ƒè·³åŒ…ï¼ˆæ¯ç§’ä¸€æ¬¡ï¼‰
æ­¥éª¤3ï¼šå¤‡æœåŠ¡å™¨æ¥æ”¶åˆ°å¿ƒè·³ï¼Œä¿æŒå¾…æœºçŠ¶æ€
æ­¥éª¤4ï¼šç”¨æˆ·è¯·æ±‚é€šè¿‡è™šæ‹ŸIPè®¿é—®ä¸»æœåŠ¡å™¨
```

**æ•…éšœåˆ‡æ¢æµç¨‹**ï¼š
```
æ­¥éª¤1ï¼šä¸»æœåŠ¡å™¨NginxæœåŠ¡å¼‚å¸¸
æ­¥éª¤2ï¼šå¥åº·æ£€æŸ¥è„šæœ¬æ£€æµ‹åˆ°æ•…éšœ
æ­¥éª¤3ï¼šä¸»æœåŠ¡å™¨åœæ­¢å‘é€å¿ƒè·³åŒ…
æ­¥éª¤4ï¼šå¤‡æœåŠ¡å™¨3ç§’å†…æœªæ”¶åˆ°å¿ƒè·³
æ­¥éª¤5ï¼šå¤‡æœåŠ¡å™¨è‡ªåŠ¨æ¥ç®¡è™šæ‹ŸIP
æ­¥éª¤6ï¼šç”¨æˆ·è¯·æ±‚è‡ªåŠ¨è½¬åˆ°å¤‡æœåŠ¡å™¨
```

> âš ï¸ **åˆ‡æ¢æ—¶é—´**ï¼šé€šå¸¸åœ¨3-5ç§’å†…å®Œæˆï¼Œç”¨æˆ·å¯èƒ½çŸ­æš‚æ„Ÿå—åˆ°å»¶è¿Ÿ

---

## 3. âš–ï¸ è´Ÿè½½å‡è¡¡é«˜å¯ç”¨æ–¹æ¡ˆ


### 3.1 è´Ÿè½½å‡è¡¡å™¨çš„é«˜å¯ç”¨æŒ‘æˆ˜


**é—®é¢˜æè¿°**ï¼šè´Ÿè½½å‡è¡¡å™¨æœ¬èº«ä¹Ÿå¯èƒ½å‡ºæ•…éšœï¼Œéœ€è¦ç»™"åˆ†é…å·¥ä½œçš„äºº"ä¹Ÿå®‰æ’å¤‡ç”¨ã€‚

```
å•ç‚¹è´Ÿè½½å‡è¡¡é—®é¢˜ï¼š
ç”¨æˆ· â†’ [è´Ÿè½½å‡è¡¡å™¨] â†’ æœåŠ¡å™¨1
            â†‘         â†’ æœåŠ¡å™¨2  
       å¦‚æœè¿™é‡ŒæŒ‚äº†     â†’ æœåŠ¡å™¨3
       æ‰€æœ‰æœåŠ¡å™¨éƒ½æ— æ³•è®¿é—®
```

### 3.2 åŒæœºçƒ­å¤‡è´Ÿè½½å‡è¡¡


**æ¶æ„è®¾è®¡**ï¼š
```
é«˜å¯ç”¨è´Ÿè½½å‡è¡¡æ¶æ„ï¼š

              â”Œâ”€â”€â”€ è™šæ‹ŸIP â”€â”€â”€â”
              â”‚              â”‚
         â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
         â”‚ä¸»è´Ÿè½½å‡è¡¡â”‚    â”‚å¤‡è´Ÿè½½å‡è¡¡â”‚
         â”‚ Nginx-1 â”‚    â”‚ Nginx-2 â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚              â”‚
              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚          â”‚          â”‚
     â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â” â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â” â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”
     â”‚WebæœåŠ¡1â”‚ â”‚WebæœåŠ¡2â”‚ â”‚WebæœåŠ¡3â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸»è´Ÿè½½å‡è¡¡å™¨é…ç½®**ï¼š
```nginx
# ä¸»Nginxè´Ÿè½½å‡è¡¡é…ç½®
upstream backend_servers {
    server 192.168.1.10:80 max_fails=3 fail_timeout=30s;
    server 192.168.1.11:80 max_fails=3 fail_timeout=30s;
    server 192.168.1.12:80 max_fails=3 fail_timeout=30s;
}

server {
    listen 80;
    server_name www.example.com;
    
    location / {
        proxy_pass http://backend_servers;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        
        # å¥åº·æ£€æŸ¥é…ç½®
        proxy_connect_timeout 3s;
        proxy_send_timeout 10s;
        proxy_read_timeout 10s;
    }
}
```

### 3.3 å¤šçº§è´Ÿè½½å‡è¡¡æ¶æ„


**ä¼ä¸šçº§æ–¹æ¡ˆ**ï¼š
```
å¤šçº§é«˜å¯ç”¨æ¶æ„ï¼š

å¤–ç½‘ç”¨æˆ·
    â†“
DNSè´Ÿè½½å‡è¡¡ (å…¨å±€)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åœ°åŸŸ1        åœ°åŸŸ2    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”     â”‚
â”‚ â”‚ä¸»å¤‡LBâ”‚    â”‚ä¸»å¤‡LBâ”‚     â”‚
â”‚ â””â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“              â†“
æœºæˆ¿1æœåŠ¡å™¨      æœºæˆ¿2æœåŠ¡å™¨
```

**é…ç½®è¦ç‚¹**ï¼š
- âœ… **DNSè½®è¯¢**ï¼šä¸åŒåœ°åŸŸç”¨æˆ·è®¿é—®å°±è¿‘æœºæˆ¿
- âœ… **ä¸»å¤‡åˆ‡æ¢**ï¼šæ¯ä¸ªæœºæˆ¿å†…éƒ¨åšä¸»å¤‡
- âœ… **è·¨æœºæˆ¿å¤‡ä»½**ï¼šä¸€ä¸ªæœºæˆ¿å…¨éƒ¨æ•…éšœæ—¶åˆ‡æ¢åˆ°å¦ä¸€ä¸ªæœºæˆ¿

---

## 4. ğŸ”’ ä¼šè¯ä¿æŒç­–ç•¥


### 4.1 ä¼šè¯ä¿æŒçš„å¿…è¦æ€§


**é—®é¢˜åœºæ™¯**ï¼šç”¨æˆ·ç™»å½•ç”µå•†ç½‘ç«™ï¼ŒåŠ äº†å•†å“åˆ°è´­ç‰©è½¦ï¼Œç»“æœåˆ·æ–°é¡µé¢è´­ç‰©è½¦å˜ç©ºäº†ã€‚

> ğŸ’¡ **ä¼šè¯ä¿æŒ**ï¼šç¡®ä¿åŒä¸€ç”¨æˆ·çš„è¯·æ±‚æ€»æ˜¯åˆ†é…åˆ°åŒä¸€å°æœåŠ¡å™¨ï¼Œé¿å…ç™»å½•çŠ¶æ€ä¸¢å¤±

### 4.2 IP Hashä¼šè¯ä¿æŒ


**å·¥ä½œåŸç†**ï¼šæ ¹æ®ç”¨æˆ·IPåœ°å€è®¡ç®—å“ˆå¸Œå€¼ï¼Œç›¸åŒIPæ€»æ˜¯åˆ†é…åˆ°åŒä¸€å°æœåŠ¡å™¨ã€‚

```nginx
upstream backend_servers {
    ip_hash;  # å¯ç”¨IPå“ˆå¸Œç®—æ³•
    server 192.168.1.10:80;
    server 192.168.1.11:80;
    server 192.168.1.12:80;
}
```

**ä¼˜ç¼ºç‚¹åˆ†æ**ï¼š
- âœ… **ä¼˜ç‚¹**ï¼šé…ç½®ç®€å•ï¼Œæ— éœ€é¢å¤–å­˜å‚¨
- âŒ **ç¼ºç‚¹**ï¼šNATç¯å¢ƒä¸‹å¤šç”¨æˆ·å¯èƒ½è¢«åˆ†é…åˆ°åŒä¸€æœåŠ¡å™¨

### 4.3 åŸºäºCookieçš„ä¼šè¯ä¿æŒ


**å®ç°æ–¹æ¡ˆ**ï¼š
```nginx
upstream backend_servers {
    hash $cookie_serverid consistent;
    server 192.168.1.10:80;
    server 192.168.1.11:80;
    server 192.168.1.12:80;
}

server {
    listen 80;
    location / {
        # å¦‚æœæ²¡æœ‰cookieï¼Œéšæœºé€‰æ‹©æœåŠ¡å™¨å¹¶è®¾ç½®cookie
        if ($cookie_serverid = "") {
            add_header Set-Cookie "serverid=$upstream_addr; Path=/";
        }
        
        proxy_pass http://backend_servers;
    }
}
```

### 4.4 å…±äº«Sessionå­˜å‚¨


**æœ€ä½³å®è·µ**ï¼šä½¿ç”¨Redisé›†ä¸­å­˜å‚¨Sessionæ•°æ®

```
ä¼šè¯å…±äº«æ¶æ„ï¼š

ç”¨æˆ·è¯·æ±‚ â†’ ä»»æ„Nginx â†’ ä»»æ„WebæœåŠ¡å™¨ â†’ Redis Sessionå­˜å‚¨
                                     â†‘
                             æ‰€æœ‰æœåŠ¡å™¨å…±äº«Session
```

**å¥½å¤„**ï¼š
- âœ… ä»»æ„æœåŠ¡å™¨æ•…éšœéƒ½ä¸å½±å“ç”¨æˆ·ä¼šè¯
- âœ… å¯ä»¥è‡ªç”±å®ç°è´Ÿè½½å‡è¡¡ç®—æ³•
- âœ… æœåŠ¡å™¨é‡å¯ä¸ä¸¢å¤±Session

---

## 5. ğŸ”§ æ•…éšœè½¬ç§»ä¸è‡ªåŠ¨æ¢å¤


### 5.1 æ•…éšœæ£€æµ‹æœºåˆ¶


**å¤šå±‚æ¬¡å¥åº·æ£€æŸ¥**ï¼š
```nginx
upstream backend_servers {
    server 192.168.1.10:80 
           max_fails=3          # æœ€å¤§å¤±è´¥æ¬¡æ•°
           fail_timeout=30s     # æ•…éšœè¶…æ—¶æ—¶é—´
           backup;              # å¤‡ç”¨æœåŠ¡å™¨æ ‡è®°
    
    server 192.168.1.11:80 max_fails=2 fail_timeout=10s;
    server 192.168.1.12:80 max_fails=2 fail_timeout=10s;
}
```

**å‚æ•°å«ä¹‰**ï¼š
- **max_fails**ï¼šè¿ç»­å¤±è´¥å¤šå°‘æ¬¡åæ ‡è®°ä¸ºä¸å¯ç”¨
- **fail_timeout**ï¼šæ ‡è®°ä¸ºä¸å¯ç”¨åå¤šé•¿æ—¶é—´å†æ¬¡å°è¯•
- **backup**ï¼šåªæœ‰ä¸»æœåŠ¡å™¨éƒ½ä¸å¯ç”¨æ—¶æ‰ä½¿ç”¨

### 5.2 æ¸è¿›å¼æ•…éšœæ¢å¤


**æ™ºèƒ½æ¢å¤ç­–ç•¥**ï¼š
```nginx
# è‡ªå®šä¹‰å¥åº·æ£€æŸ¥è„šæœ¬
location /health_check {
    access_log off;
    return 200 "healthy\n";
    add_header Content-Type text/plain;
}

# å¤–éƒ¨ç›‘æ§è„šæœ¬æ£€æŸ¥
upstream backend_servers {
    server 192.168.1.10:80 slow_start=30s;  # æ¢å¤å30ç§’å†…é€æ¸å¢åŠ æµé‡
    server 192.168.1.11:80;
    server 192.168.1.12:80;
}
```

### 5.3 æ•…éšœè½¬ç§»æœ€ä½³å®è·µ


**åˆ†çº§æ•…éšœå¤„ç†**ï¼š
```
ä¸€çº§æ•…éšœï¼šå•å°æœåŠ¡å™¨å®•æœº
å¤„ç†ï¼šè‡ªåŠ¨ä»è´Ÿè½½å‡è¡¡æ± ä¸­ç§»é™¤

äºŒçº§æ•…éšœï¼šä¸»è´Ÿè½½å‡è¡¡å™¨å®•æœº  
å¤„ç†ï¼šKeepalivedè‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡æœº

ä¸‰çº§æ•…éšœï¼šæ•´ä¸ªæœºæˆ¿ç½‘ç»œä¸­æ–­
å¤„ç†ï¼šDNSåˆ‡æ¢åˆ°å¤‡ç”¨æœºæˆ¿

å››çº§æ•…éšœï¼šåº”ç”¨ç¨‹åºå…¨é¢æ•…éšœ
å¤„ç†ï¼šè¿”å›é™æ€ç»´æŠ¤é¡µé¢
```

---

## 6. ğŸ” æœåŠ¡å‘ç°ä¸å¥åº·æ£€æŸ¥


### 6.1 åŠ¨æ€æœåŠ¡å‘ç°


**ä¼ ç»Ÿé—®é¢˜**ï¼šæœåŠ¡å™¨IPå˜åŒ–éœ€è¦æ‰‹åŠ¨ä¿®æ”¹Nginxé…ç½®å¹¶é‡å¯ã€‚

**åŠ¨æ€å‘ç°æ–¹æ¡ˆ**ï¼š
```lua
-- ä½¿ç”¨Luaè„šæœ¬å®ç°åŠ¨æ€upstream
-- nginx.confä¸­å¼€å¯luaæ¨¡å—
init_by_lua_block {
    local consul = require "resty.consul"
    local cjson = require "cjson"
    
    -- ä»Consulè·å–æœåŠ¡åˆ—è¡¨
    function refresh_upstream()
        local c = consul:new({
            host = "127.0.0.1",
            port = 8500
        })
        
        local services = c:get_service("web-service")
        -- åŠ¨æ€æ›´æ–°upstreamé…ç½®
    end
}
```

### 6.2 ä¸»åŠ¨å¥åº·æ£€æŸ¥


**nginx-pluså¥åº·æ£€æŸ¥**ï¼š
```nginx
upstream backend {
    zone backend 64k;
    server 192.168.1.10:80;
    server 192.168.1.11:80;
    server 192.168.1.12:80;
}

server {
    listen 80;
    
    # å¥åº·æ£€æŸ¥ç«¯ç‚¹
    location /api/health {
        health_check interval=5s 
                    fails=3 
                    passes=2 
                    uri=/health
                    match=server_ok;
        proxy_pass http://backend;
    }
}

# å®šä¹‰å¥åº·æ£€æŸ¥åŒ¹é…æ¡ä»¶
match server_ok {
    status 200;
    header Content-Type = text/plain;
    body ~ "OK";
}
```

### 6.3 è¢«åŠ¨å¥åº·æ£€æŸ¥ä¼˜åŒ–


**æ™ºèƒ½æ•…éšœæ£€æµ‹**ï¼š
```nginx
upstream backend {
    server 192.168.1.10:80 
           max_fails=3 
           fail_timeout=30s;
    
    # åŸºäºå“åº”æ—¶é—´çš„å¥åº·åˆ¤æ–­
    server 192.168.1.11:80 
           max_fails=2 
           fail_timeout=10s
           max_conns=100;    # é™åˆ¶æœ€å¤§è¿æ¥æ•°
}

# ç›‘æ§å…³é”®æŒ‡æ ‡
log_format upstream_time '$remote_addr - $remote_user [$time_local] '
                        '"$request" $status $bytes_sent '
                        '"$http_referer" "$http_user_agent" '
                        'rt=$request_time uct="$upstream_connect_time" '
                        'uht="$upstream_header_time" urt="$upstream_response_time"';
```

---

## 7. ğŸ  å®¹ç¾å¤‡ä»½ç­–ç•¥


### 7.1 æ•°æ®ä¸­å¿ƒçº§å®¹ç¾


**å¼‚åœ°å¤šæ´»æ¶æ„**ï¼š
```
ä¸»æ•°æ®ä¸­å¿ƒ (åŒ—äº¬)          å¤‡æ•°æ®ä¸­å¿ƒ (ä¸Šæµ·)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä¸»Nginxé›†ç¾¤   â”‚ â†â”€â”€â”€â†’ â”‚   å¤‡Nginxé›†ç¾¤   â”‚
â”‚                 â”‚ åŒæ­¥   â”‚                 â”‚  
â”‚  ä¸»æ•°æ®åº“é›†ç¾¤   â”‚ â†â”€â”€â”€â†’ â”‚  å¤‡æ•°æ®åº“é›†ç¾¤   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†‘                          â†‘
        â””â”€â”€â”€ DNSæ™ºèƒ½è°ƒåº¦ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 é…ç½®æ–‡ä»¶å¤‡ä»½


**è‡ªåŠ¨å¤‡ä»½è„šæœ¬**ï¼š
```bash
#!/bin/bash
# nginx_backup.sh

BACKUP_DIR="/backup/nginx"
DATE=$(date +%Y%m%d_%H%M%S)

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR/$DATE

# å¤‡ä»½é…ç½®æ–‡ä»¶
cp -r /etc/nginx/ $BACKUP_DIR/$DATE/
cp /etc/keepalived/keepalived.conf $BACKUP_DIR/$DATE/

# å¤‡ä»½SSLè¯ä¹¦
cp -r /etc/ssl/certs/ $BACKUP_DIR/$DATE/

# ä¿ç•™æœ€è¿‘30å¤©çš„å¤‡ä»½
find $BACKUP_DIR -type d -mtime +30 -exec rm -rf {} \;

echo "å¤‡ä»½å®Œæˆ: $BACKUP_DIR/$DATE"
```

### 7.3 å¿«é€Ÿæ¢å¤æœºåˆ¶


**ä¸€é”®æ¢å¤è„šæœ¬**ï¼š
```bash
#!/bin/bash
# nginx_restore.sh

if [ -z "$1" ]; then
    echo "ç”¨æ³•: $0 <å¤‡ä»½æ—¥æœŸ>"
    echo "å¯ç”¨å¤‡ä»½: $(ls /backup/nginx/)"
    exit 1
fi

BACKUP_DATE=$1
BACKUP_PATH="/backup/nginx/$BACKUP_DATE"

# åœæ­¢æœåŠ¡
systemctl stop nginx
systemctl stop keepalived

# æ¢å¤é…ç½®
cp -r $BACKUP_PATH/nginx/* /etc/nginx/
cp $BACKUP_PATH/keepalived.conf /etc/keepalived/

# æ£€æŸ¥é…ç½®è¯­æ³•
nginx -t
if [ $? -eq 0 ]; then
    # å¯åŠ¨æœåŠ¡
    systemctl start nginx
    systemctl start keepalived
    echo "æ¢å¤æˆåŠŸ"
else
    echo "é…ç½®æ–‡ä»¶æœ‰è¯¯ï¼Œè¯·æ£€æŸ¥"
fi
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 é«˜å¯ç”¨æ¶æ„æ ¸å¿ƒåŸåˆ™


```
ğŸ”¸ æ¶ˆé™¤å•ç‚¹ï¼šä»»ä½•ç»„ä»¶éƒ½ä¸èƒ½æˆä¸ºæ•´ä¸ªç³»ç»Ÿçš„å•ç‚¹æ•…éšœ
ğŸ”¸ è‡ªåŠ¨åˆ‡æ¢ï¼šæ•…éšœå‘ç”Ÿæ—¶èƒ½å¤Ÿè‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨ç³»ç»Ÿ
ğŸ”¸ å¿«é€Ÿæ¢å¤ï¼šæ•…éšœæ¢å¤åèƒ½å¤Ÿå¿«é€Ÿé‡æ–°åŠ å…¥æœåŠ¡
ğŸ”¸ ç›‘æ§é¢„è­¦ï¼šèƒ½å¤ŸåŠæ—¶å‘ç°å’Œé¢„è­¦æ½œåœ¨é—®é¢˜
ğŸ”¸ æ•°æ®ä¸€è‡´ï¼šç¡®ä¿åˆ‡æ¢è¿‡ç¨‹ä¸­æ•°æ®ä¸ä¸¢å¤±ä¸é”™ä¹±
```

### 8.2 å®æ–½æ­¥éª¤å»ºè®®


**ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€é«˜å¯ç”¨**
- âœ… éƒ¨ç½²Nginxä¸»å¤‡æ¶æ„
- âœ… é…ç½®Keepalivedå®ç°è‡ªåŠ¨åˆ‡æ¢
- âœ… è®¾ç½®åŸºç¡€çš„å¥åº·æ£€æŸ¥

**ç¬¬äºŒé˜¶æ®µï¼šè´Ÿè½½å‡è¡¡é«˜å¯ç”¨**
- âœ… å®ç°åç«¯æœåŠ¡å™¨çš„è´Ÿè½½å‡è¡¡
- âœ… é…ç½®ä¼šè¯ä¿æŒç­–ç•¥
- âœ… ä¼˜åŒ–æ•…éšœæ£€æµ‹å’Œæ¢å¤æœºåˆ¶

**ç¬¬ä¸‰é˜¶æ®µï¼šä¼ä¸šçº§å®¹ç¾**
- âœ… éƒ¨ç½²è·¨æœºæˆ¿çš„å®¹ç¾æ¶æ„
- âœ… å®ç°æ•°æ®åŒæ­¥å’Œå¤‡ä»½
- âœ… å»ºç«‹å®Œæ•´çš„ç›‘æ§å’ŒæŠ¥è­¦ä½“ç³»

### 8.3 å¸¸è§é—®é¢˜ä¸è§£å†³


| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| **è„‘è£‚é—®é¢˜** | ç½‘ç»œåˆ†åŒºå¯¼è‡´åŒä¸» | é…ç½®ä»²è£æœºåˆ¶ |
| **åˆ‡æ¢è¿‡æ…¢** | æ£€æµ‹å‘¨æœŸå¤ªé•¿ | è°ƒæ•´å¿ƒè·³é—´éš” |
| **ä¼šè¯ä¸¢å¤±** | æœåŠ¡å™¨æ•…éšœ | ä½¿ç”¨å…±äº«Sessionå­˜å‚¨ |
| **è´Ÿè½½ä¸å‡** | ç®—æ³•é€‰æ‹©ä¸å½“ | æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ç®—æ³• |

### 8.4 ç›‘æ§æŒ‡æ ‡


**å…³é”®ç›‘æ§é¡¹**ï¼š
- ğŸ”´ **å¯ç”¨æ€§**ï¼šæœåŠ¡å“åº”æ—¶é—´ã€æˆåŠŸç‡
- ğŸŸ¡ **æ€§èƒ½**ï¼šå¹¶å‘è¿æ¥æ•°ã€CPU/å†…å­˜ä½¿ç”¨ç‡  
- ğŸŸ¢ **å®¹é‡**ï¼šå¸¦å®½ä½¿ç”¨ã€ç£ç›˜ç©ºé—´
- ğŸ”µ **å®‰å…¨**ï¼šå¼‚å¸¸è®¿é—®ã€SSLè¯ä¹¦æœ‰æ•ˆæœŸ

> ğŸ’¡ **æ–°æ‰‹å»ºè®®**ï¼šå…ˆä»ç®€å•çš„ä¸»å¤‡æ¶æ„å¼€å§‹ï¼Œé€æ­¥æ¼”è¿›åˆ°å¤æ‚çš„å¤šçº§é«˜å¯ç”¨æ¶æ„

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- é«˜å¯ç”¨è®¾è®¡æ— å•ç‚¹ï¼Œä¸»å¤‡åˆ‡æ¢è¦è‡ªåŠ¨
- å¥åº·æ£€æŸ¥æ˜¯å…³é”®ï¼Œæ•…éšœæ¢å¤è¦è¿…é€Ÿ  
- ä¼šè¯ä¿æŒç”¨æˆ·çˆ½ï¼Œå®¹ç¾å¤‡ä»½ä¿å®‰å…¨