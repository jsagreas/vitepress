---
title: 1、nginx-访问日志
---
## 📚 目录

1. [什么是访问日志](#1-什么是访问日志)
2. [access_log指令详解](#2-access_log指令详解)
3. [日志格式定义与自定义](#3-日志格式定义与自定义)
4. [条件日志记录](#4-条件日志记录)
5. [日志缓冲区优化](#5-日志缓冲区优化)
6. [日志文件轮转](#6-日志文件轮转)
7. [实际应用场景](#7-实际应用场景)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 📝 什么是访问日志


### 1.1 访问日志的本质


**简单理解**：就像门卫记录每个进出人员一样，Nginx访问日志记录每个访问网站的请求

```
现实生活类比：
门卫记录本：
- 谁来了？(客户端IP)
- 什么时候来的？(时间)
- 来干什么？(请求的页面)
- 用了多长时间？(响应时间)
- 结果如何？(状态码)

Nginx访问日志：
192.168.1.100 - [21/Sep/2025:15:30:00] "GET /index.html HTTP/1.1" 200 1024
```

> 💡 **核心作用**  
> 访问日志是网站运营的"黑匣子"，记录所有用户访问行为，帮助我们了解网站使用情况

### 1.2 访问日志包含的信息


**基本信息构成**：
- **谁访问了**：客户端IP地址
- **什么时候**：访问时间
- **访问什么**：请求的URL和方法
- **结果如何**：响应状态码和大小
- **用什么访问**：浏览器信息(User-Agent)

**典型日志记录示例**：
```
192.168.1.100 - - [21/Sep/2025:15:30:00 +0800] "GET /index.html HTTP/1.1" 200 1024 "http://www.example.com/" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
```

| 字段 | **含义** | **作用** |
|------|----------|----------|
| `192.168.1.100` | 客户端IP | 识别访问者来源 |
| `[21/Sep/2025:15:30:00 +0800]` | 访问时间 | 分析访问模式 |
| `"GET /index.html HTTP/1.1"` | 请求信息 | 了解访问内容 |
| `200` | 状态码 | 判断请求是否成功 |
| `1024` | 响应大小 | 统计流量使用 |

---

## 2. ⚙️ access_log指令详解


### 2.1 基础语法理解


**指令格式**：
```
access_log path [format [buffer=size] [gzip[=level]] [flush=time]];
```

**通俗解释**：告诉Nginx把日志写到哪里，用什么格式，怎么优化性能

### 2.2 基本配置示例


**最简单的配置**：
```nginx
# 使用默认格式记录到指定文件
access_log /var/log/nginx/access.log;
```

**完整配置示例**：
```nginx
server {
    listen 80;
    server_name www.example.com;
    
    # 基本访问日志
    access_log /var/log/nginx/example.access.log;
    
    # 错误日志
    error_log /var/log/nginx/example.error.log;
    
    location / {
        root /var/www/html;
        index index.html;
    }
}
```

### 2.3 不同位置的配置作用域


**配置位置对比**：

```
配置层级图：
┌─────────────────────────────────┐
│  http 块 (全局默认)              │
│  ┌───────────────────────────┐   │
│  │  server 块 (虚拟主机级)    │   │
│  │  ┌─────────────────────┐   │   │
│  │  │  location 块 (路径级) │   │   │
│  │  └─────────────────────┘   │   │
│  └───────────────────────────┘   │
└─────────────────────────────────┘
```

**实际配置示例**：
```nginx
# 全局默认日志格式
http {
    access_log /var/log/nginx/global.log;
    
    server {
        server_name api.example.com;
        # API服务器专用日志
        access_log /var/log/nginx/api.log;
        
        location /upload {
            # 上传接口的详细日志
            access_log /var/log/nginx/upload.log detailed;
        }
    }
}
```

### 2.4 关闭访问日志


**关闭方法**：
```nginx
# 完全关闭访问日志
access_log off;

# 只记录错误，不记录正常访问
access_log off;
error_log /var/log/nginx/error.log;
```

> ⚠️ **注意事项**  
> 关闭日志可以提高性能，但会失去访问统计和问题诊断的重要信息

---

## 3. 🎨 日志格式定义与自定义


### 3.1 默认日志格式解析


**Nginx内置的默认格式**：
```nginx
log_format combined '$remote_addr - $remote_user [$time_local] '
                   '"$request" $status $body_bytes_sent '
                   '"$http_referer" "$http_user_agent"';
```

**字段含义详解**：

| 变量 | **含义** | **示例值** | **用途** |
|------|----------|------------|----------|
| `$remote_addr` | 客户端IP地址 | `192.168.1.100` | 识别访问来源 |
| `$remote_user` | 认证用户名 | `john` 或 `-` | HTTP基础认证 |
| `$time_local` | 本地时间 | `[21/Sep/2025:15:30:00 +0800]` | 时间分析 |
| `$request` | 完整请求行 | `"GET /index.html HTTP/1.1"` | 了解请求详情 |
| `$status` | 响应状态码 | `200`, `404`, `500` | 判断请求结果 |
| `$body_bytes_sent` | 响应体大小 | `1024` | 流量统计 |
| `$http_referer` | 来源页面 | `"http://www.google.com"` | 分析流量来源 |
| `$http_user_agent` | 浏览器信息 | `"Mozilla/5.0..."` | 分析客户端类型 |

### 3.2 自定义日志格式


**创建简化格式**：
```nginx
# 定义简单格式
log_format simple '$remote_addr [$time_local] "$request" $status';

server {
    # 使用自定义格式
    access_log /var/log/nginx/simple.log simple;
}
```

**创建详细格式**：
```nginx
# 定义详细格式，包含响应时间
log_format detailed '$remote_addr - $remote_user [$time_local] '
                   '"$request" $status $body_bytes_sent '
                   '"$http_referer" "$http_user_agent" '
                   '$request_time $upstream_response_time';

server {
    access_log /var/log/nginx/detailed.log detailed;
}
```

### 3.3 JSON格式日志


**为什么需要JSON格式**：方便程序解析和日志分析工具处理

```nginx
# JSON格式日志定义
log_format json_format escape=json '{'
    '"time": "$time_local",'
    '"remote_addr": "$remote_addr",'
    '"request": "$request",'
    '"status": $status,'
    '"body_bytes_sent": $body_bytes_sent,'
    '"http_referer": "$http_referer",'
    '"http_user_agent": "$http_user_agent",'
    '"request_time": $request_time'
'}';

server {
    access_log /var/log/nginx/access.json json_format;
}
```

**JSON日志输出示例**：
```json
{
    "time": "21/Sep/2025:15:30:00 +0800",
    "remote_addr": "192.168.1.100",
    "request": "GET /index.html HTTP/1.1",
    "status": 200,
    "body_bytes_sent": 1024,
    "http_referer": "-",
    "http_user_agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
    "request_time": 0.001
}
```

### 3.4 常用变量参考


**时间相关变量**：
```
$time_local        # 本地时间格式
$time_iso8601      # ISO8601格式时间
$msec              # 毫秒级时间戳
```

**请求相关变量**：
```
$request_method    # 请求方法 (GET, POST, etc.)
$request_uri       # 完整的原始请求URI
$uri               # 当前请求的URI
$args              # 请求参数
```

**响应相关变量**：
```
$status            # 响应状态码
$body_bytes_sent   # 发送给客户端的字节数
$bytes_sent        # 发送给客户端的总字节数
$request_time      # 请求处理时间
```

---

## 4. 🎯 条件日志记录


### 4.1 什么是条件日志


**通俗理解**：不是所有请求都需要记录，可以设置条件来过滤

```
生活例子：
门卫不需要记录每个路过的人，
只记录真正进入办公楼的人

Nginx条件日志：
不记录所有请求，
只记录满足条件的请求
```

### 4.2 基于状态码的条件记录


**只记录错误请求**：
```nginx
# 定义一个变量，只有错误状态码时才记录
map $status $loggable {
    ~^[23]  0;  # 2xx和3xx状态码不记录
    default 1;  # 其他状态码记录
}

server {
    access_log /var/log/nginx/errors.log combined if=$loggable;
}
```

**只记录成功请求**：
```nginx
map $status $log_success {
    ~^[45]  0;  # 4xx和5xx不记录
    default 1;  # 其他记录
}

server {
    access_log /var/log/nginx/success.log combined if=$log_success;
}
```

### 4.3 基于请求路径的条件记录


**排除静态资源**：
```nginx
# 定义不记录静态资源的变量
map $request_uri $log_static {
    ~*\.(css|js|png|jpg|gif|ico)$ 0;  # 静态资源不记录
    default 1;                        # 其他请求记录
}

server {
    access_log /var/log/nginx/dynamic.log combined if=$log_static;
}
```

**只记录API请求**：
```nginx
map $request_uri $log_api {
    ~^/api/ 1;    # 以/api/开头的记录
    default 0;    # 其他不记录
}

server {
    access_log /var/log/nginx/api.log combined if=$log_api;
}
```

### 4.4 基于客户端的条件记录


**排除内部监控**：
```nginx
# 定义地理位置或内部IP的过滤
geo $internal_ip {
    default 0;
    192.168.0.0/16 1;    # 内网IP
    10.0.0.0/8 1;        # 内网IP
}

# 取反，只记录外部访问
map $internal_ip $log_external {
    1 0;        # 内网不记录
    0 1;        # 外网记录
}

server {
    access_log /var/log/nginx/external.log combined if=$log_external;
}
```

---

## 5. ⚡ 日志缓冲区优化


### 5.1 为什么需要缓冲区


**性能问题理解**：
```
没有缓冲区的情况：
每个请求 → 立即写硬盘 → 等待写入完成
100个请求 = 100次硬盘写入 = 很慢

有缓冲区的情况：
多个请求 → 先放在内存 → 一次性写硬盘
100个请求 = 1次硬盘写入 = 很快
```

### 5.2 缓冲区配置语法


**基本缓冲区配置**：
```nginx
access_log /var/log/nginx/access.log combined buffer=32k;
```

**参数说明**：
- `buffer=32k`：设置32KB的内存缓冲区
- 当缓冲区满了或者达到刷新时间时，一次性写入硬盘

### 5.3 缓冲区 + 定时刷新


**组合配置**：
```nginx
access_log /var/log/nginx/access.log combined buffer=32k flush=5s;
```

**配置含义**：
- 使用32KB缓冲区
- 每5秒强制刷新一次
- 即使缓冲区没满，也会定期写入硬盘

### 5.4 压缩日志


**启用压缩**：
```nginx
access_log /var/log/nginx/access.log.gz combined gzip buffer=32k flush=5s;
```

**压缩级别**：
```nginx
# 设置压缩级别 (1-9, 1最快，9压缩率最高)
access_log /var/log/nginx/access.log.gz combined gzip=6 buffer=32k;
```

### 5.5 性能优化配置示例


**高流量网站优化**：
```nginx
http {
    # 定义高效的日志格式
    log_format optimized '$remote_addr [$time_local] "$request" $status $body_bytes_sent';
    
    server {
        server_name high-traffic.com;
        
        # 大缓冲区 + 压缩 + 定时刷新
        access_log /var/log/nginx/high-traffic.log.gz optimized 
                   gzip=1 buffer=64k flush=10s;
    }
}
```

---

## 6. 🔄 日志文件轮转


### 6.1 为什么需要日志轮转


**问题场景**：
```
日志文件增长示例：
第1天：access.log (10MB)
第7天：access.log (70MB)
第30天：access.log (300MB)
第365天：access.log (3.6GB) ← 太大了！

轮转后：
access.log (今天的日志)
access.log.1 (昨天的日志)
access.log.2 (前天的日志)
...
```

> 💡 **轮转的好处**  
> - 防止单个日志文件过大
> - 便于按时间查找问题
> - 可以定期删除旧日志节省空间

### 6.2 使用logrotate进行轮转


**创建轮转配置文件**：
```bash
# 创建 /etc/logrotate.d/nginx 文件
sudo vim /etc/logrotate.d/nginx
```

**配置内容**：
```
/var/log/nginx/*.log {
    daily           # 每天轮转
    missingok       # 如果日志文件不存在，不报错
    rotate 52       # 保留52个文件(52周)
    compress        # 压缩旧日志文件
    delaycompress   # 延迟压缩(第二次轮转时才压缩)
    notifempty      # 空文件不轮转
    create 0644 nginx nginx  # 创建新文件的权限和所有者
    sharedscripts   # 多个日志文件共享脚本
    postrotate      # 轮转后执行的命令
        /bin/kill -USR1 `cat /var/run/nginx.pid 2> /dev/null` 2> /dev/null || true
    endscript
}
```

### 6.3 轮转配置详解


**轮转频率选项**：
```
daily     # 每天轮转
weekly    # 每周轮转  
monthly   # 每月轮转
yearly    # 每年轮转
size 100M # 文件达到100M时轮转
```

**文件处理选项**：
```
rotate 30     # 保留30个备份文件
compress      # 压缩旧文件
nocompress    # 不压缩
copytruncate  # 复制后清空原文件(适用于某些程序)
create        # 创建新的空文件
```

### 6.4 手动测试轮转


**测试配置**：
```bash
# 测试logrotate配置是否正确
sudo logrotate -d /etc/logrotate.d/nginx

# 强制执行一次轮转
sudo logrotate -f /etc/logrotate.d/nginx
```

**查看轮转结果**：
```bash
ls -la /var/log/nginx/
# 应该看到类似这样的文件：
# access.log
# access.log.1
# access.log.2.gz
# access.log.3.gz
```

### 6.5 Nginx信号重载


**为什么需要信号重载**：
```
轮转过程：
1. logrotate重命名 access.log → access.log.1
2. 创建新的空 access.log 文件
3. 但Nginx还在写旧的文件句柄！
4. 发送USR1信号告诉Nginx重新打开日志文件
```

**手动重载日志**：
```bash
# 发送USR1信号重新打开日志文件
sudo nginx -s reopen

# 或者使用kill命令
sudo kill -USR1 `cat /var/run/nginx.pid`
```

---

## 7. 🚀 实际应用场景


### 7.1 网站流量分析


**分析访问统计**：
```bash
# 查看访问最多的IP
awk '{print $1}' /var/log/nginx/access.log | sort | uniq -c | sort -nr | head -10

# 查看最受欢迎的页面
awk '{print $7}' /var/log/nginx/access.log | sort | uniq -c | sort -nr | head -10

# 查看状态码分布
awk '{print $9}' /var/log/nginx/access.log | sort | uniq -c | sort -nr
```

### 7.2 性能监控配置


**性能监控日志格式**：
```nginx
log_format performance '$remote_addr [$time_local] "$request" '
                      '$status $body_bytes_sent '
                      '$request_time $upstream_response_time '
                      '"$http_user_agent"';

server {
    access_log /var/log/nginx/performance.log performance;
}
```

**分析慢请求**：
```bash
# 查找处理时间超过1秒的请求
awk '$NF > 1.0 {print}' /var/log/nginx/performance.log

# 按响应时间排序
sort -k8 -nr /var/log/nginx/performance.log | head -10
```

### 7.3 安全监控


**安全日志格式**：
```nginx
log_format security '$remote_addr [$time_local] "$request" '
                   '$status "$http_referer" "$http_user_agent" '
                   '$request_length $bytes_sent $request_time';

# 只记录可疑请求
map $status $log_suspicious {
    ~^4  1;  # 4xx错误
    ~^5  1;  # 5xx错误
    default 0;
}

server {
    access_log /var/log/nginx/security.log security if=$log_suspicious;
}
```

### 7.4 多站点日志管理


**按站点分离日志**：
```nginx
http {
    log_format main '$remote_addr [$time_local] "$request" $status $body_bytes_sent';
    
    server {
        server_name www.site1.com;
        access_log /var/log/nginx/site1.access.log main;
        error_log /var/log/nginx/site1.error.log;
    }
    
    server {
        server_name www.site2.com;
        access_log /var/log/nginx/site2.access.log main;
        error_log /var/log/nginx/site2.error.log;
    }
}
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的基本概念


> 🎯 **核心要点**  
> - **访问日志作用**：记录所有HTTP请求，是网站运营的重要数据源
> - **access_log指令**：控制日志记录的位置、格式和方式
> - **日志格式定义**：使用log_format自定义记录哪些信息
> - **条件记录**：使用if条件控制哪些请求需要记录
> - **性能优化**：通过缓冲区和压缩提高日志写入性能
> - **日志轮转**：防止日志文件过大，便于管理和分析

### 8.2 关键配置模板


**基础配置模板**：
```nginx
http {
    # 定义标准日志格式
    log_format main '$remote_addr [$time_local] "$request" '
                   '$status $body_bytes_sent "$http_referer" '
                   '"$http_user_agent" $request_time';
    
    server {
        # 标准访问日志
        access_log /var/log/nginx/access.log main buffer=32k flush=5s;
        
        # 错误日志
        error_log /var/log/nginx/error.log warn;
    }
}
```

**高性能配置模板**：
```nginx
# 高流量站点优化
access_log /var/log/nginx/access.log.gz main gzip=1 buffer=64k flush=10s;
```

### 8.3 常见问题和解决方案


| 问题 | **原因** | **解决方案** |
|------|----------|-------------|
| 日志文件过大 | 没有配置轮转 | 配置logrotate定期轮转 |
| 日志写入慢 | 没有使用缓冲区 | 添加buffer参数 |
| 磁盘空间不足 | 旧日志没有清理 | 在轮转配置中限制保留数量 |
| 日志格式混乱 | 格式定义不当 | 使用标准的log_format定义 |

### 8.4 最佳实践建议


**日志管理原则**：

> 💡 **记住这些要点**  
> - **分类记录**：不同类型的请求使用不同的日志文件
> - **性能优化**：高流量站点必须使用缓冲区和压缩
> - **定期轮转**：避免单个文件过大影响分析效率
> - **监控分析**：定期分析日志发现问题和优化点
> - **安全审计**：保留足够长时间的日志用于安全分析

**配置检查清单**：
- ✅ 是否配置了适当的日志格式？
- ✅ 是否启用了缓冲区优化？
- ✅ 是否配置了日志轮转？
- ✅ 是否有足够的磁盘空间？
- ✅ 是否设置了合适的条件过滤？

**核心记忆口诀**：
- 访问日志记行为，格式自定义很重要
- 缓冲压缩提性能，轮转管理防过大
- 条件过滤选重点，分析监控保安全