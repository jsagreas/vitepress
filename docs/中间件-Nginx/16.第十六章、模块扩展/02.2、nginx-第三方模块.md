---
title: 2ã€nginx-ç¬¬ä¸‰æ–¹æ¨¡å—
---
## ðŸ“š ç›®å½•

1. [ç¬¬ä¸‰æ–¹æ¨¡å—æ¦‚è¿°](#1-ç¬¬ä¸‰æ–¹æ¨¡å—æ¦‚è¿°)
2. [Luaæ¨¡å—è¯¦è§£](#2-Luaæ¨¡å—è¯¦è§£)
3. [Uploadä¸Šä¼ æ¨¡å—](#3-Uploadä¸Šä¼ æ¨¡å—)
4. [Imageå›¾åƒå¤„ç†æ¨¡å—](#4-Imageå›¾åƒå¤„ç†æ¨¡å—)
5. [GeoIPåœ°ç†ä½ç½®æ¨¡å—](#5-GeoIPåœ°ç†ä½ç½®æ¨¡å—)
6. [æ¨¡å—ç¼–è¯‘å®‰è£…å®žæˆ˜](#6-æ¨¡å—ç¼–è¯‘å®‰è£…å®žæˆ˜)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ðŸ”§ ç¬¬ä¸‰æ–¹æ¨¡å—æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯ç¬¬ä¸‰æ–¹æ¨¡å—


> **ðŸ’¡ ç®€å•ç†è§£**ï¼šå°±åƒç»™æ‰‹æœºå®‰è£…APPä¸€æ ·ï¼ŒNginxçš„ç¬¬ä¸‰æ–¹æ¨¡å—å°±æ˜¯ç»™Nginxå®‰è£…"æ’ä»¶"ï¼Œè®©å®ƒå…·å¤‡æ›´å¤šåŠŸèƒ½ã€‚

**ðŸ”¸ æ ¸å¿ƒæ¦‚å¿µ**
```
Nginxæœ¬èº«ï¼šä¸€ä¸ªåŸºç¡€çš„WebæœåŠ¡å™¨
ç¬¬ä¸‰æ–¹æ¨¡å—ï¼šç¤¾åŒºå¼€å‘çš„åŠŸèƒ½æ‰©å±•åŒ…
ä½œç”¨ï¼šè®©Nginxèƒ½åšæ›´å¤šäº‹æƒ…ï¼Œæ¯”å¦‚å¤„ç†å›¾ç‰‡ã€æ‰§è¡Œè„šæœ¬ã€è¯†åˆ«åœ°ç†ä½ç½®ç­‰
```

**ðŸ“Š å¸¸è§ç¬¬ä¸‰æ–¹æ¨¡å—åˆ†ç±»**

| æ¨¡å—ç±»åž‹ | **ä¸»è¦åŠŸèƒ½** | **å…¸åž‹ä»£è¡¨** | **ä½¿ç”¨åœºæ™¯** |
|---------|------------|-------------|-------------|
| ðŸŽ¨ **å›¾åƒå¤„ç†** | `è£å‰ªã€ç¼©æ”¾ã€æ ¼å¼è½¬æ¢` | `ngx_http_image_filter` | `å›¾ç‰‡ç½‘ç«™ã€CDN` |
| ðŸ“œ **è„šæœ¬æ‰§è¡Œ** | `åœ¨Nginxä¸­è¿è¡Œä»£ç ` | `OpenResty(Lua)` | `åŠ¨æ€é€»è¾‘å¤„ç†` |
| ðŸ“ **æ–‡ä»¶å¤„ç†** | `ä¸Šä¼ ã€ä¸‹è½½ä¼˜åŒ–` | `nginx-upload-module` | `æ–‡ä»¶ä¸Šä¼ æœåŠ¡` |
| ðŸŒ **åœ°ç†å®šä½** | `æ ¹æ®IPåˆ¤æ–­åœ°ç†ä½ç½®` | `ngx_http_geoip_module` | `åŒºåŸŸåŒ–æœåŠ¡` |
| ðŸ”’ **å®‰å…¨å¢žå¼º** | `é˜²æŠ¤ã€é™æµã€è¿‡æ»¤` | `ModSecurity` | `Webåº”ç”¨é˜²ç«å¢™` |

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦ç¬¬ä¸‰æ–¹æ¨¡å—


**ðŸŽ¯ è§£å†³çš„å®žé™…é—®é¢˜**

```
åŽŸç”ŸNginxçš„å±€é™ï¼š
âŒ ä¸èƒ½ç›´æŽ¥å¤„ç†å›¾ç‰‡ï¼ˆè£å‰ªã€ç¼©æ”¾ï¼‰
âŒ ä¸èƒ½æ‰§è¡Œå¤æ‚çš„ä¸šåŠ¡é€»è¾‘
âŒ ä¸èƒ½è¯†åˆ«ç”¨æˆ·çš„åœ°ç†ä½ç½®
âŒ æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½è¾ƒå¼±

ç¬¬ä¸‰æ–¹æ¨¡å—çš„ä»·å€¼ï¼š
âœ… æ‰©å±•åŠŸèƒ½ï¼šè®©Nginxå˜æˆ"ä¸‡èƒ½æœåŠ¡å™¨"
âœ… æå‡æ€§èƒ½ï¼šé¿å…è¯·æ±‚è½¬å‘åˆ°åŽç«¯
âœ… é™ä½Žå¤æ‚åº¦ï¼šä¸€ä¸ªæœåŠ¡å™¨è§£å†³å¤šä¸ªé—®é¢˜
âœ… èŠ‚çº¦æˆæœ¬ï¼šå‡å°‘æœåŠ¡å™¨æ•°é‡
```

**ðŸ—ï¸ æž¶æž„ä¼˜åŠ¿å¯¹æ¯”**

```
ä¼ ç»Ÿæž¶æž„ï¼š
ç”¨æˆ·è¯·æ±‚ â†’ Nginx â†’ åŽç«¯åº”ç”¨ â†’ å›¾ç‰‡å¤„ç†æœåŠ¡ â†’ åœ°ç†ä½ç½®æœåŠ¡
         â†“
    å¤æ‚ã€æ…¢ã€èµ„æºæ¶ˆè€—å¤§

æ‰©å±•æ¨¡å—æž¶æž„ï¼š
ç”¨æˆ·è¯·æ±‚ â†’ Nginx(é›†æˆå„ç§æ¨¡å—) â†’ ç›´æŽ¥å¤„ç†å®Œæˆ
         â†“
    ç®€å•ã€å¿«ã€èµ„æºèŠ‚çº¦
```

---

## 2. ðŸŽ­ Luaæ¨¡å—è¯¦è§£


### 2.1 OpenRestyä¸ŽLuaæ¨¡å—


> **ðŸ’¡ ç”Ÿæ´»åŒ–ç†è§£**ï¼šå¦‚æžœè¯´Nginxæ˜¯ä¸€ä¸ªå¾ˆæ£’çš„æœåŠ¡å‘˜ï¼Œé‚£ä¹ˆLuaæ¨¡å—å°±æ˜¯è®©è¿™ä¸ªæœåŠ¡å‘˜å­¦ä¼šäº†ç¼–ç¨‹ï¼Œèƒ½å¤„ç†å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ã€‚

**ðŸ”¸ OpenRestyæ˜¯ä»€ä¹ˆ**
```
å®šä¹‰ï¼šåŸºäºŽNginxå’ŒLuaçš„Webåº”ç”¨æœåŠ¡å™¨
æœ¬è´¨ï¼šNginx + Luaæ¨¡å— + å¸¸ç”¨åº“çš„æ•´åˆåŒ…
ä¼˜åŠ¿ï¼šè®©Nginxå…·å¤‡ç¼–ç¨‹èƒ½åŠ›ï¼Œå¯ä»¥å†™ä»£ç å¤„ç†è¯·æ±‚
```

**ðŸ“ˆ æ€§èƒ½ä¼˜åŠ¿**
```
ä¼ ç»Ÿæ–¹å¼ï¼š
Nginx â†’ è½¬å‘è¯·æ±‚ â†’ PHP/Javaåº”ç”¨ â†’ æ•°æ®åº“
æ—¶é—´ï¼šç½‘ç»œå»¶è¿Ÿ + åº”ç”¨å¤„ç†æ—¶é—´

Luaæ¨¡å—æ–¹å¼ï¼š
Nginxå†…éƒ¨ç›´æŽ¥æ‰§è¡ŒLuaä»£ç  â†’ æ•°æ®åº“
æ—¶é—´ï¼šä»…Luaæ‰§è¡Œæ—¶é—´ï¼ˆæžå¿«ï¼‰

æ€§èƒ½æå‡ï¼šé€šå¸¸å¿«5-10å€ï¼
```

### 2.2 Luaæ¨¡å—çš„å®žé™…åº”ç”¨


**ðŸŽ¯ å…¸åž‹ä½¿ç”¨åœºæ™¯**

**åœºæ™¯1ï¼šåŠ¨æ€ç”Ÿæˆå†…å®¹**
```lua
-- åœ¨Nginxé…ç½®ä¸­åµŒå…¥Luaä»£ç 
location /api/time {
    content_by_lua '
        -- èŽ·å–å½“å‰æ—¶é—´
        local time = os.date("%Y-%m-%d %H:%M:%S")
        -- è¿”å›žJSONæ ¼å¼
        ngx.header["Content-Type"] = "application/json"
        ngx.say(\'{"time": "\' .. time .. \'"}\')
    ';
}
```

**åœºæ™¯2ï¼šè¯·æ±‚éªŒè¯å’Œè¿‡æ»¤**
```lua
location /protected/ {
    access_by_lua '
        -- æ£€æŸ¥è¯·æ±‚å¤´ä¸­çš„token
        local token = ngx.var.http_authorization
        if not token or token ~= "Bearer valid_token" then
            ngx.status = 401
            ngx.say("Unauthorized")
            ngx.exit(401)
        end
    ';
    
    # éªŒè¯é€šè¿‡åŽçš„æ­£å¸¸å¤„ç†
    proxy_pass http://backend;
}
```

**ðŸ” Luaåœ¨ä¸åŒé˜¶æ®µçš„ä½œç”¨**

```
Nginxè¯·æ±‚å¤„ç†æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   1. æŽ¥æ”¶è¯·æ±‚    â”‚ â† init_by_luaï¼šåˆå§‹åŒ–
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   2. é‡å†™URI    â”‚ â† rewrite_by_luaï¼šURLé‡å†™
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   3. è®¿é—®æŽ§åˆ¶    â”‚ â† access_by_luaï¼šæƒé™éªŒè¯
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   4. å†…å®¹ç”Ÿæˆ    â”‚ â† content_by_luaï¼šç”Ÿæˆå“åº”
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   5. è®°å½•æ—¥å¿—    â”‚ â† log_by_luaï¼šæ—¥å¿—å¤„ç†
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 Luaæ¨¡å—çš„ä¼˜åŠ¿ä¸Žé™åˆ¶


**âœ… ä¼˜åŠ¿**
- **è¶…é«˜æ€§èƒ½**ï¼šåœ¨Nginxè¿›ç¨‹å†…ç›´æŽ¥æ‰§è¡Œï¼Œæ— ç½‘ç»œå¼€é”€
- **ç®€å•æ˜“å­¦**ï¼šLuaè¯­æ³•ç®€æ´ï¼Œç±»ä¼¼Python
- **åŠŸèƒ½å¼ºå¤§**ï¼šå¯ä»¥è®¿é—®Redisã€MySQLã€HTTPç­‰
- **çƒ­æ›´æ–°**ï¼šä¿®æ”¹ä»£ç æ— éœ€é‡å¯Nginx

**âš ï¸ æ³¨æ„äº‹é¡¹**
- **é˜»å¡žé£Žé™©**ï¼šå¤æ‚è®¡ç®—å¯èƒ½å½±å“Nginxæ€§èƒ½
- **å†…å­˜ç®¡ç†**ï¼šéœ€è¦æ³¨æ„å†…å­˜æ³„æ¼
- **è°ƒè¯•å›°éš¾**ï¼šé”™è¯¯æŽ’æŸ¥ç›¸å¯¹å¤æ‚

---

## 3. ðŸ“ Uploadä¸Šä¼ æ¨¡å—


### 3.1 Uploadæ¨¡å—è§£å†³çš„é—®é¢˜


> **ðŸ’¡ ç±»æ¯”ç†è§£**ï¼šæ™®é€šçš„æ–‡ä»¶ä¸Šä¼ å°±åƒç”¨å°æŽ¨è½¦è¿è´§ï¼Œè€ŒUploadæ¨¡å—å°±åƒç”¨ä¼ é€å¸¦ï¼Œæ•ˆçŽ‡æ›´é«˜ï¼Œè¿˜èƒ½è¾¹è¿è¾“è¾¹å¤„ç†ã€‚

**ðŸŽ¯ ä¼ ç»Ÿä¸Šä¼ çš„é—®é¢˜**
```
æ™®é€šä¸Šä¼ æµç¨‹ï¼š
ç”¨æˆ·é€‰æ‹©æ–‡ä»¶ â†’ æµè§ˆå™¨è¯»å–æ•´ä¸ªæ–‡ä»¶åˆ°å†…å­˜ â†’ å‘é€ç»™Nginx 
â†’ Nginxè½¬å‘ç»™åŽç«¯åº”ç”¨ â†’ åº”ç”¨å¤„ç†å¹¶ä¿å­˜

é—®é¢˜ï¼š
âŒ å¤§æ–‡ä»¶å ç”¨å¤§é‡å†…å­˜
âŒ ä¸Šä¼ è¿‡ç¨‹ä¸­æ— æ³•åšå…¶ä»–å¤„ç†
âŒ å¤±è´¥åŽéœ€è¦é‡æ–°ä¸Šä¼ æ•´ä¸ªæ–‡ä»¶
âŒ æ— æ³•å®žæ—¶æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
```

**ðŸš€ Uploadæ¨¡å—çš„ä¼˜åŠ¿**
```
ä¼˜åŒ–åŽçš„æµç¨‹ï¼š
ç”¨æˆ·é€‰æ‹©æ–‡ä»¶ â†’ åˆ†å—ä¸Šä¼  â†’ Nginxç›´æŽ¥å¤„ç†å¹¶ä¿å­˜
â†’ å®žæ—¶åé¦ˆè¿›åº¦ â†’ å®ŒæˆåŽé€šçŸ¥åŽç«¯åº”ç”¨

ä¼˜åŠ¿ï¼š
âœ… æµå¼å¤„ç†ï¼šè¾¹ä¸Šä¼ è¾¹ä¿å­˜ï¼Œå†…å­˜å ç”¨å°
âœ… æ–­ç‚¹ç»­ä¼ ï¼šæ”¯æŒæš‚åœå’Œç»§ç»­ä¸Šä¼ 
âœ… è¿›åº¦ç›‘æŽ§ï¼šå®žæ—¶æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
âœ… å¹¶å‘ä¸Šä¼ ï¼šæ”¯æŒå¤šæ–‡ä»¶åŒæ—¶ä¸Šä¼ 
```

### 3.2 Uploadæ¨¡å—é…ç½®å®žä¾‹


**ðŸ“ åŸºç¡€é…ç½®ç¤ºä¾‹**
```nginx
# æ–‡ä»¶ä¸Šä¼ å¤„ç†
location /upload {
    # é™åˆ¶ä¸Šä¼ æ–‡ä»¶å¤§å°
    client_max_body_size 100m;
    
    # ä½¿ç”¨uploadæ¨¡å—å¤„ç†
    upload_pass /upload_handler;
    
    # è®¾ç½®ä¸´æ—¶æ–‡ä»¶å­˜å‚¨è·¯å¾„
    upload_store /tmp/nginx_uploads;
    
    # è®¾ç½®æ–‡ä»¶æƒé™
    upload_store_access user:rw group:rw all:r;
    
    # ä¼ é€’æ–‡ä»¶ä¿¡æ¯ç»™åŽç«¯
    upload_set_form_field $upload_field_name.name "$upload_file_name";
    upload_set_form_field $upload_field_name.path "$upload_tmp_path";
    upload_set_form_field $upload_field_name.size "$upload_file_size";
}

# ä¸Šä¼ å®ŒæˆåŽçš„å¤„ç†
location /upload_handler {
    proxy_pass http://backend_app;
    proxy_set_header X-Real-IP $remote_addr;
}
```

**ðŸŽ¯ å®žé™…åº”ç”¨åœºæ™¯**

| åº”ç”¨åœºæ™¯ | **é…ç½®è¦ç‚¹** | **æ³¨æ„äº‹é¡¹** |
|---------|------------|-------------|
| ðŸ“¸ **å›¾ç‰‡ä¸Šä¼ ** | `é™åˆ¶æ ¼å¼ã€å¤§å°` | `å®‰å…¨æ‰«æã€æ ¼å¼éªŒè¯` |
| ðŸ“¹ **è§†é¢‘ä¸Šä¼ ** | `å¤§æ–‡ä»¶æ”¯æŒã€è¶…æ—¶è®¾ç½®` | `ç¼–ç è½¬æ¢ã€å­˜å‚¨ä¼˜åŒ–` |
| ðŸ“„ **æ–‡æ¡£ä¸Šä¼ ** | `ç—…æ¯’æ‰«æã€æ ¼å¼æ£€æŸ¥` | `ç‰ˆæœ¬æŽ§åˆ¶ã€å¤‡ä»½ç­–ç•¥` |

---

## 4. ðŸŽ¨ Imageå›¾åƒå¤„ç†æ¨¡å—


### 4.1 å›¾åƒå¤„ç†æ¨¡å—çš„ä½œç”¨


> **ðŸ’¡ å½¢è±¡æ¯”å–»**ï¼šå°±åƒç»™Nginxå®‰è£…äº†ä¸€ä¸ªä¸“ä¸šçš„"ç…§ç‰‡ç¼–è¾‘è½¯ä»¶"ï¼Œå¯ä»¥å®žæ—¶è£å‰ªã€ç¼©æ”¾ã€è½¬æ¢å›¾ç‰‡æ ¼å¼ã€‚

**ðŸ”¸ è§£å†³çš„å®žé™…éœ€æ±‚**
```
ç”µå•†ç½‘ç«™çš„å›°æ‰°ï¼š
- å•†å“å›¾ç‰‡éœ€è¦å¤šç§å°ºå¯¸ï¼ˆç¼©ç•¥å›¾ã€è¯¦æƒ…å›¾ã€æ”¾å¤§å›¾ï¼‰
- ä¸åŒè®¾å¤‡éœ€è¦ä¸åŒåˆ†è¾¨çŽ‡
- å­˜å‚¨å’Œä¼ è¾“æˆæœ¬é«˜

ä¼ ç»Ÿè§£å†³æ–¹æ¡ˆï¼š
âŒ é¢„å…ˆç”Ÿæˆæ‰€æœ‰å°ºå¯¸ â†’ å­˜å‚¨ç©ºé—´ç¿»å€
âŒ åŽç«¯å®žæ—¶å¤„ç† â†’ å“åº”æ…¢ï¼ŒæœåŠ¡å™¨åŽ‹åŠ›å¤§
âŒ ç¬¬ä¸‰æ–¹æœåŠ¡ â†’ æˆæœ¬é«˜ï¼Œä¾èµ–å¤–éƒ¨

Imageæ¨¡å—è§£å†³æ–¹æ¡ˆï¼š
âœ… å®žæ—¶æŒ‰éœ€ç”Ÿæˆ â†’ èŠ‚çº¦å­˜å‚¨ç©ºé—´
âœ… Nginxå±‚é¢å¤„ç† â†’ å“åº”å¿«ï¼Œå‡è½»åŽç«¯åŽ‹åŠ›
âœ… è‡ªä¸»å¯æŽ§ â†’ æ— é¢å¤–æˆæœ¬
```

### 4.2 å›¾åƒå¤„ç†å®žé™…åº”ç”¨


**ðŸ“ å¸¸ç”¨å›¾åƒå¤„ç†é…ç½®**
```nginx
# å›¾ç‰‡åŠ¨æ€å¤„ç†
location ~* ^/images/(.+)\.(jpg|jpeg|png|gif)$ {
    set $image_root /var/www/images;
    set $image_uri $1;
    set $image_ext $2;
    
    # å°è¯•ç›´æŽ¥è¿”å›žåŽŸå›¾
    try_files $uri @image_resize;
}

# å›¾ç‰‡ç¼©æ”¾å¤„ç†
location @image_resize {
    # èŽ·å–ç¼©æ”¾å‚æ•°
    set $width $arg_w;
    set $height $arg_h;
    set $quality $arg_q;
    
    # é»˜è®¤å€¼
    if ($width = '') { set $width 800; }
    if ($height = '') { set $height 600; }
    if ($quality = '') { set $quality 85; }
    
    # å›¾ç‰‡å¤„ç†
    image_filter resize $width $height;
    image_filter_jpeg_quality $quality;
    image_filter_buffer 10M;
    
    # ç¼“å­˜å¤„ç†åŽçš„å›¾ç‰‡
    expires 7d;
    add_header Cache-Control "public, immutable";
}
```

**ðŸŽ¯ URLä½¿ç”¨ç¤ºä¾‹**
```
åŽŸå›¾è®¿é—®ï¼š
https://example.com/images/product.jpg

ç¼©æ”¾è®¿é—®ï¼š
https://example.com/images/product.jpg?w=300&h=200&q=90
â†“
è‡ªåŠ¨ç”Ÿæˆ300x200åƒç´ ï¼Œè´¨é‡90%çš„å›¾ç‰‡
```

**ðŸ“Š æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**

| ä¼˜åŒ–æ–¹å¼ | **å®žçŽ°æ–¹æ³•** | **æ•ˆæžœ** |
|---------|------------|---------|
| ðŸ”„ **ç¼“å­˜ç­–ç•¥** | `è®¾ç½®expiresã€etag` | `å‡å°‘é‡å¤å¤„ç†` |
| ðŸŽ¯ **æ™ºèƒ½åŽ‹ç¼©** | `æ ¹æ®è®¾å¤‡ç±»åž‹è°ƒæ•´è´¨é‡` | `èŠ‚çº¦å¸¦å®½50%+` |
| âš¡ **å¼‚æ­¥å¤„ç†** | `åŽå°é¢„ç”Ÿæˆçƒ­é—¨å°ºå¯¸` | `é¦–æ¬¡è®¿é—®æ›´å¿«` |

---

## 5. ðŸŒ GeoIPåœ°ç†ä½ç½®æ¨¡å—


### 5.1 GeoIPæ¨¡å—çš„å®žé™…ä»·å€¼


> **ðŸ’¡ ç”Ÿæ´»åŒ–åœºæ™¯**ï¼šå°±åƒå•†åº—çš„æ™ºèƒ½é—¨è¿Žï¼Œèƒ½è¯†åˆ«é¡¾å®¢æ¥è‡ªå“ªé‡Œï¼Œç„¶åŽæä¾›ç›¸åº”çš„æœåŠ¡ï¼ˆè¯­è¨€ã€è´§å¸ã€å•†å“æŽ¨èï¼‰ã€‚

**ðŸŽ¯ å®žé™…åº”ç”¨åœºæ™¯**

**åœºæ™¯1ï¼šCDNæ™ºèƒ½è°ƒåº¦**
```
ç”¨æˆ·è®¿é—®è¿‡ç¨‹ï¼š
ç”¨æˆ·ï¼ˆåŒ—äº¬ï¼‰è®¿é—®ç½‘ç«™ 
â†’ GeoIPè¯†åˆ«ï¼šæ¥è‡ªä¸­å›½åŒ—äº¬
â†’ è‡ªåŠ¨é€‰æ‹©ï¼šåŒ—äº¬CDNèŠ‚ç‚¹
â†’ ç»“æžœï¼šè®¿é—®é€Ÿåº¦æå‡70%
```

**åœºæ™¯2ï¼šåŒºåŸŸåŒ–å†…å®¹æœåŠ¡**
```
ç”µå•†ç½‘ç«™åº”ç”¨ï¼š
ç¾Žå›½ç”¨æˆ· â†’ æ˜¾ç¤ºç¾Žå…ƒä»·æ ¼ï¼Œè‹±æ–‡ç•Œé¢
ä¸­å›½ç”¨æˆ· â†’ æ˜¾ç¤ºäººæ°‘å¸ä»·æ ¼ï¼Œä¸­æ–‡ç•Œé¢
æ¬§æ´²ç”¨æˆ· â†’ æ˜¾ç¤ºæ¬§å…ƒä»·æ ¼ï¼Œç¬¦åˆGDPRçš„éšç§æ¡æ¬¾
```

**åœºæ™¯3ï¼šå®‰å…¨é˜²æŠ¤**
```
é£Žé™©æŽ§åˆ¶ï¼š
è¯†åˆ«åˆ°é«˜é£Žé™©åœ°åŒºIP â†’ å¢žåŠ éªŒè¯ç 
æ£€æµ‹åˆ°å¼‚å¸¸ç™»å½•ä½ç½® â†’ å‘é€å®‰å…¨é€šçŸ¥
å‘çŽ°æ¶æ„IPé›†ä¸­åŒºåŸŸ â†’ è‡ªåŠ¨å°ç¦
```

### 5.2 GeoIPé…ç½®ä¸Žä½¿ç”¨


**ðŸ“ åŸºç¡€é…ç½®ç¤ºä¾‹**
```nginx
# åŠ è½½GeoIPæ•°æ®åº“
geoip_country /usr/share/GeoIP/GeoIP.dat;
geoip_city /usr/share/GeoIP/GeoLiteCity.dat;

server {
    listen 80;
    server_name example.com;
    
    # æ ¹æ®å›½å®¶é‡å®šå‘
    location / {
        if ($geoip_country_code = "CN") {
            return 301 https://cn.example.com$request_uri;
        }
        
        if ($geoip_country_code = "US") {
            return 301 https://us.example.com$request_uri;
        }
        
        # é»˜è®¤è·³è½¬
        return 301 https://global.example.com$request_uri;
    }
    
    # æ˜¾ç¤ºåœ°ç†ä¿¡æ¯
    location /location {
        add_header Content-Type "application/json";
        return 200 '{
            "country": "$geoip_country_name",
            "country_code": "$geoip_country_code", 
            "city": "$geoip_city",
            "region": "$geoip_region"
        }';
    }
}
```

**ðŸ” å¯ç”¨çš„åœ°ç†ä¿¡æ¯å˜é‡**

| å˜é‡å | **å«ä¹‰** | **ç¤ºä¾‹å€¼** |
|--------|----------|-----------|
| `$geoip_country_name` | **å›½å®¶åç§°** | `China, United States` |
| `$geoip_country_code` | **å›½å®¶ä»£ç ** | `CN, US, JP` |
| `$geoip_city` | **åŸŽå¸‚åç§°** | `Beijing, New York` |
| `$geoip_region` | **çœ/å·žåç§°** | `Beijing, California` |
| `$geoip_latitude` | **çº¬åº¦** | `39.9042` |
| `$geoip_longitude` | **ç»åº¦** | `116.4074` |

### 5.3 GeoIPæ•°æ®åº“ç®¡ç†


**ðŸ“Š æ•°æ®åº“ç±»åž‹é€‰æ‹©**

```
å…è´¹ç‰ˆ GeoLite2ï¼š
âœ… å…è´¹ä½¿ç”¨
âœ… å®šæœŸæ›´æ–°
âŒ ç²¾åº¦ç›¸å¯¹è¾ƒä½Žï¼ˆåŸŽå¸‚çº§åˆ«å‡†ç¡®çŽ‡~80%ï¼‰

å•†ä¸šç‰ˆ GeoIP2ï¼š
âœ… é«˜ç²¾åº¦ï¼ˆåŸŽå¸‚çº§åˆ«å‡†ç¡®çŽ‡~95%+ï¼‰
âœ… æ›´å¤šæ•°æ®ç»´åº¦
âœ… æŠ€æœ¯æ”¯æŒ
âŒ éœ€è¦ä»˜è´¹

é€‰æ‹©å»ºè®®ï¼š
ðŸ”¸ ä¸ªäººé¡¹ç›®ã€åˆåˆ›å…¬å¸ â†’ GeoLite2
ðŸ”¸ ä¼ä¸šçº§åº”ç”¨ã€ç²¾åº¦è¦æ±‚é«˜ â†’ GeoIP2å•†ä¸šç‰ˆ
```

---

## 6. ðŸ› ï¸ æ¨¡å—ç¼–è¯‘å®‰è£…å®žæˆ˜


### 6.1 æ¨¡å—å®‰è£…æ–¹æ³•å¯¹æ¯”


**ðŸ”¸ ä¸‰ç§å®‰è£…æ–¹å¼**

| å®‰è£…æ–¹å¼ | **éš¾åº¦** | **çµæ´»æ€§** | **é€‚ç”¨åœºæ™¯** |
|---------|---------|-----------|-------------|
| ðŸ“¦ **åŒ…ç®¡ç†å™¨å®‰è£…** | `â­ ç®€å•` | `â­â­ ä¸€èˆ¬` | `å¿«é€Ÿéƒ¨ç½²ï¼Œæ ‡å‡†åŠŸèƒ½` |
| ðŸ”§ **æºç ç¼–è¯‘å®‰è£…** | `â­â­â­ å¤æ‚` | `â­â­â­ æœ€é«˜` | `å®šåˆ¶éœ€æ±‚ï¼Œæ€§èƒ½ä¼˜åŒ–` |
| ðŸ³ **Dockeré•œåƒ** | `â­â­ ä¸­ç­‰` | `â­â­ è¾ƒå¥½` | `å®¹å™¨åŒ–éƒ¨ç½²` |

### 6.2 æºç ç¼–è¯‘å®‰è£…è¯¦ç»†æ­¥éª¤


> **ðŸ’¡ ç†è§£è¦ç‚¹**ï¼šæºç ç¼–è¯‘å°±åƒè£…ä¿®æˆ¿å­ï¼Œä½ å¯ä»¥é€‰æ‹©éœ€è¦çš„åŠŸèƒ½ï¼Œä¸è¦ä¸éœ€è¦çš„ï¼Œæœ€ç»ˆå¾—åˆ°æœ€é€‚åˆçš„ç‰ˆæœ¬ã€‚

**Step 1** ðŸš€ **å‡†å¤‡ç¼–è¯‘çŽ¯å¢ƒ**
```bash
# CentOS/RHELç³»ç»Ÿ
sudo yum groupinstall "Development Tools"
sudo yum install pcre-devel zlib-devel openssl-devel

# Ubuntu/Debianç³»ç»Ÿ  
sudo apt update
sudo apt install build-essential libpcre3-dev zlib1g-dev libssl-dev
```

**Step 2** â¬‡ï¸ **ä¸‹è½½æºç å’Œæ¨¡å—**
```bash
# ä¸‹è½½Nginxæºç 
wget http://nginx.org/download/nginx-1.24.0.tar.gz
tar -xzf nginx-1.24.0.tar.gz

# ä¸‹è½½ç¬¬ä¸‰æ–¹æ¨¡å—ï¼ˆä»¥uploadæ¨¡å—ä¸ºä¾‹ï¼‰
git clone https://github.com/fdintino/nginx-upload-module.git
```

**Step 3** âš™ï¸ **é…ç½®ç¼–è¯‘é€‰é¡¹**
```bash
cd nginx-1.24.0

# é…ç½®ç¼–è¯‘å‚æ•°
./configure \
    --prefix=/usr/local/nginx \
    --with-http_ssl_module \
    --with-http_v2_module \
    --with-http_geoip_module \
    --with-http_image_filter_module \
    --add-module=../nginx-upload-module \
    --with-file-aio \
    --with-http_secure_link_module
```

**ðŸ” ç¼–è¯‘å‚æ•°è¯´æ˜Ž**

```
æ ¸å¿ƒå‚æ•°è§£é‡Šï¼š
--prefixï¼šå®‰è£…è·¯å¾„
--with-http_ssl_moduleï¼šHTTPSæ”¯æŒ
--with-http_v2_moduleï¼šHTTP/2æ”¯æŒ  
--with-http_geoip_moduleï¼šåœ°ç†ä½ç½®åŠŸèƒ½
--add-moduleï¼šæ·»åŠ ç¬¬ä¸‰æ–¹æ¨¡å—
--with-file-aioï¼šå¼‚æ­¥æ–‡ä»¶IOï¼ˆæå‡æ€§èƒ½ï¼‰
```

**Step 4** ðŸ”¨ **ç¼–è¯‘å’Œå®‰è£…**
```bash
# ç¼–è¯‘ï¼ˆä½¿ç”¨å¤šæ ¸å¿ƒåŠ é€Ÿï¼‰
make -j$(nproc)

# å®‰è£…
sudo make install

# åˆ›å»ºsystemdæœåŠ¡æ–‡ä»¶
sudo tee /etc/systemd/system/nginx.service > /dev/null <<EOF
[Unit]
Description=The nginx HTTP and reverse proxy server
After=network.target remote-fs.target nss-lookup.target

[Service]
Type=forking
PIDFile=/usr/local/nginx/logs/nginx.pid
ExecStartPre=/usr/local/nginx/sbin/nginx -t
ExecStart=/usr/local/nginx/sbin/nginx
ExecReload=/bin/kill -s HUP \$MAINPID
ExecStop=/bin/kill -s QUIT \$MAINPID
PrivateTmp=true

[Install]
WantedBy=multi-user.target
EOF

# å¯ç”¨å¹¶å¯åŠ¨æœåŠ¡
sudo systemctl enable nginx
sudo systemctl start nginx
```

### 6.3 æ¨¡å—éªŒè¯ä¸Žæµ‹è¯•


**âœ… éªŒè¯æ¨¡å—æ˜¯å¦æ­£ç¡®å®‰è£…**
```bash
# æŸ¥çœ‹ç¼–è¯‘åŒ…å«çš„æ¨¡å—
/usr/local/nginx/sbin/nginx -V

# æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•
/usr/local/nginx/sbin/nginx -t

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
tail -f /usr/local/nginx/logs/error.log
```

**ðŸ§ª ç®€å•åŠŸèƒ½æµ‹è¯•**
```bash
# æµ‹è¯•GeoIPæ¨¡å—
curl -H "X-Forwarded-For: 8.8.8.8" http://localhost/location

# æµ‹è¯•å›¾ç‰‡å¤„ç†æ¨¡å—
wget http://localhost/images/test.jpg?w=100&h=100

# æµ‹è¯•ä¸Šä¼ åŠŸèƒ½
curl -F "file=@test.txt" http://localhost/upload
```

---

## 7. ðŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŽŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ðŸ”¸ ç¬¬ä¸‰æ–¹æ¨¡å—ï¼šæ‰©å±•NginxåŠŸèƒ½çš„æ’ä»¶ï¼Œè®©Nginxå˜æˆå¤šåŠŸèƒ½æœåŠ¡å™¨
ðŸ”¸ Luaæ¨¡å—ï¼šè®©Nginxå…·å¤‡ç¼–ç¨‹èƒ½åŠ›ï¼Œå¯ä»¥å†™ä»£ç å¤„ç†å¤æ‚é€»è¾‘
ðŸ”¸ Uploadæ¨¡å—ï¼šä¼˜åŒ–æ–‡ä»¶ä¸Šä¼ ï¼Œæ”¯æŒå¤§æ–‡ä»¶ã€æ–­ç‚¹ç»­ä¼ ã€è¿›åº¦ç›‘æŽ§
ðŸ”¸ Imageæ¨¡å—ï¼šå®žæ—¶å›¾ç‰‡å¤„ç†ï¼ŒåŠ¨æ€ç¼©æ”¾è£å‰ªï¼ŒèŠ‚çº¦å­˜å‚¨ç©ºé—´
ðŸ”¸ GeoIPæ¨¡å—ï¼šè¯†åˆ«ç”¨æˆ·åœ°ç†ä½ç½®ï¼Œå®žçŽ°åŒºåŸŸåŒ–æœåŠ¡å’Œæ™ºèƒ½è°ƒåº¦
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ðŸ”¹ æ¨¡å—é€‰æ‹©åŽŸåˆ™**
```
æ€§èƒ½ä¼˜å…ˆï¼š
- é«˜å¹¶å‘åœºæ™¯ â†’ é€‰æ‹©Cè¯­è¨€ç¼–å†™çš„æ¨¡å—
- ç®€å•é€»è¾‘ â†’ åŽŸç”Ÿæ¨¡å—å°±å¤Ÿç”¨
- å¤æ‚é€»è¾‘ â†’ Luaæ¨¡å—æ›´çµæ´»

åŠŸèƒ½éœ€æ±‚ï¼š
- å›¾ç‰‡ç½‘ç«™ â†’ å¿…é¡»æœ‰Imageæ¨¡å—
- æ–‡ä»¶åˆ†äº« â†’ å¿…é¡»æœ‰Uploadæ¨¡å—  
- å›½é™…åŒ–æœåŠ¡ â†’ å¿…é¡»æœ‰GeoIPæ¨¡å—
- åŠ¨æ€å†…å®¹ â†’ å¿…é¡»æœ‰Luaæ¨¡å—
```

**ðŸ”¹ å®‰è£…æ–¹å¼é€‰æ‹©**
```
åŒ…ç®¡ç†å™¨å®‰è£…ï¼š
âœ… é€‚åˆï¼šå¿«é€Ÿéƒ¨ç½²ã€æ ‡å‡†åŠŸèƒ½å¤Ÿç”¨
âŒ ä¸é€‚åˆï¼šéœ€è¦ç‰¹æ®Šæ¨¡å—ã€æ€§èƒ½è¦æ±‚æžé«˜

æºç ç¼–è¯‘ï¼š
âœ… é€‚åˆï¼šå®šåˆ¶åŒ–éœ€æ±‚ã€æ€§èƒ½ä¼˜åŒ–ã€ç‰¹æ®Šæ¨¡å—
âŒ ä¸é€‚åˆï¼šå¿«é€Ÿéƒ¨ç½²ã€è¿ç»´ç»éªŒä¸è¶³
```

**ðŸ”¹ å®žé™…åº”ç”¨å»ºè®®**
```
å°åž‹é¡¹ç›®ï¼š
- ä½¿ç”¨åŒ…ç®¡ç†å™¨å®‰è£…
- é€‰æ‹©1-2ä¸ªæ ¸å¿ƒæ¨¡å—
- é‡ç‚¹å…³æ³¨ç¨³å®šæ€§

ä¸­åž‹é¡¹ç›®ï¼š
- æºç ç¼–è¯‘å®‰è£…
- æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©æ¨¡å—
- åšå¥½æ€§èƒ½ç›‘æŽ§

å¤§åž‹é¡¹ç›®ï¼š
- å®šåˆ¶åŒ–ç¼–è¯‘
- å¤šæ¨¡å—ç»„åˆä½¿ç”¨
- å»ºç«‹å®Œå–„çš„è¿ç»´ä½“ç³»
```

### 7.3 å®žé™…åº”ç”¨ä»·å€¼


**ðŸ’¼ ä¸šåŠ¡åœºæ™¯æ˜ å°„**
- **ç”µå•†å¹³å°**ï¼šImage + Upload + GeoIPï¼ˆå›¾ç‰‡å¤„ç†+æ–‡ä»¶ä¸Šä¼ +åŒºåŸŸåŒ–ï¼‰
- **å†…å®¹åˆ†å‘**ï¼šLua + GeoIPï¼ˆåŠ¨æ€é€»è¾‘+æ™ºèƒ½è°ƒåº¦ï¼‰
- **æ–‡ä»¶æœåŠ¡**ï¼šUpload + Imageï¼ˆä¸Šä¼ ä¼˜åŒ–+å›¾ç‰‡å¤„ç†ï¼‰
- **å›½é™…åŒ–åº”ç”¨**ï¼šGeoIP + Luaï¼ˆåœ°ç†è¯†åˆ«+åŠ¨æ€å†…å®¹ï¼‰

**ðŸ”§ è¿ç»´å®žè·µ**
- **æ¨¡å—ç®¡ç†**ï¼šå®šæœŸæ›´æ–°æ¨¡å—ï¼Œå…³æ³¨å®‰å…¨è¡¥ä¸
- **æ€§èƒ½ç›‘æŽ§**ï¼šç›‘æŽ§æ¨¡å—çš„èµ„æºä½¿ç”¨æƒ…å†µ
- **æ•…éšœå¤„ç†**ï¼šäº†è§£å„æ¨¡å—çš„å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ
- **å®¹é‡è§„åˆ’**ï¼šæ ¹æ®æ¨¡å—ç‰¹æ€§è§„åˆ’æœåŠ¡å™¨èµ„æº

**ðŸŽ¯ å­¦ä¹ è·¯å¾„å»ºè®®**
1. **åŸºç¡€é˜¶æ®µ**ï¼šç†è§£æ¨¡å—æ¦‚å¿µï¼ŒæŽŒæ¡åŒ…ç®¡ç†å™¨å®‰è£…
2. **è¿›é˜¶é˜¶æ®µ**ï¼šå­¦ä¼šæºç ç¼–è¯‘ï¼Œé…ç½®å¸¸ç”¨æ¨¡å—
3. **é«˜çº§é˜¶æ®µ**ï¼šæ¨¡å—ç»„åˆä½¿ç”¨ï¼Œæ€§èƒ½è°ƒä¼˜ä¼˜åŒ–
4. **ä¸“å®¶é˜¶æ®µ**ï¼šè‡ªå®šä¹‰æ¨¡å—å¼€å‘ï¼Œè§£å†³å¤æ‚ä¸šåŠ¡éœ€æ±‚

**æ ¸å¿ƒè®°å¿†**ï¼š
- ç¬¬ä¸‰æ–¹æ¨¡å—è®©Nginxå˜æˆä¸‡èƒ½æœåŠ¡å™¨
- Luaæ¨¡å—ç»™Nginxè£…ä¸Šäº†"å¤§è„‘"
- Uploadæ¨¡å—è®©æ–‡ä»¶ä¼ è¾“æ›´é«˜æ•ˆ
- Imageæ¨¡å—è®©å›¾ç‰‡å¤„ç†æ›´æ™ºèƒ½
- GeoIPæ¨¡å—è®©æœåŠ¡æ›´è´´è¿‘ç”¨æˆ·
- æºç ç¼–è¯‘è™½å¤æ‚ä½†åŠŸèƒ½æœ€å¼ºå¤§