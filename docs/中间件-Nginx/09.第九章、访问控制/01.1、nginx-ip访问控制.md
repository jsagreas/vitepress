---
title: 1、nginx-ip访问控制
---
## 📚 目录

1. [访问控制概述](#1-访问控制概述)
2. [基本IP控制指令](#2-基本IP控制指令)
3. [IP白名单配置](#3-IP白名单配置)
4. [IP黑名单配置](#4-IP黑名单配置)
5. [网段控制详解](#5-网段控制详解)
6. [动态IP控制策略](#6-动态IP控制策略)
7. [实际应用场景](#7-实际应用场景)
8. [核心要点总结](#8-核心要点总结)

---

## 1. 🛡️ 访问控制概述


### 1.1 什么是访问控制


**简单理解**：访问控制就像是给你的网站装了一道"门禁系统"

```
现实中的门禁：                 Nginx访问控制：
┌─────────────────┐           ┌─────────────────┐
│   公司大门      │           │   Web服务器     │
│                 │           │                 │
│ ✅ 员工刷卡进入 │    VS     │ ✅ 允许的IP访问 │
│ ❌ 外人被拦截   │           │ ❌ 禁止的IP拒绝 │
└─────────────────┘           └─────────────────┘

核心作用：控制哪些人（IP地址）可以访问你的网站
```

**为什么需要访问控制**：
- **安全防护**：阻止恶意IP的攻击和爬虫
- **资源保护**：保护重要的管理页面和API接口
- **合规要求**：某些业务只能特定地区或机构访问
- **性能优化**：减少无效请求，节省服务器资源

### 1.2 Nginx访问控制的工作原理


**处理流程**：
```
客户端请求 → Nginx接收 → 检查IP地址 → 匹配规则 → 允许/拒绝

详细过程：
客户端(192.168.1.100)
          ↓
    发送HTTP请求
          ↓
    Nginx服务器接收
          ↓
    提取客户端IP地址
          ↓
    按顺序检查allow/deny规则
          ↓
    ┌─ 匹配到allow规则 → 允许访问 → 正常响应
    └─ 匹配到deny规则  → 拒绝访问 → 返回403错误
```

**核心特点**：
- **顺序检查**：按照配置文件中的顺序逐条检查规则
- **首次匹配**：找到第一个匹配的规则就执行，不再继续检查
- **默认行为**：如果没有匹配的规则，默认允许访问

---

## 2. 🔧 基本IP控制指令


### 2.1 allow指令详解


**基本语法**：
```nginx
allow 地址;
```

**allow指令含义**：明确允许某个IP或IP段访问

> 💡 **通俗理解**：allow就是"白名单"，写在这里的IP地址都是"好人"，可以自由进出

**常用格式**：
```nginx
# 1. 允许单个IP
allow 192.168.1.100;

# 2. 允许所有IP（相当于取消限制）
allow all;

# 3. 允许网段（后面会详细讲解）
allow 192.168.1.0/24;
```

### 2.2 deny指令详解


**基本语法**：
```nginx
deny 地址;
```

**deny指令含义**：明确拒绝某个IP或IP段访问

> 💡 **通俗理解**：deny就是"黑名单"，写在这里的IP地址都是"坏人"，一律不准进入

**常用格式**：
```nginx
# 1. 拒绝单个IP
deny 192.168.1.50;

# 2. 拒绝所有IP（相当于关闭服务）
deny all;

# 3. 拒绝网段
deny 10.0.0.0/8;
```

### 2.3 规则执行顺序


**重要概念**：Nginx按照配置文件中的顺序检查规则，找到第一个匹配的就执行

```nginx
# 示例：规则执行顺序
location /admin {
    allow 192.168.1.100;    # 规则1：允许这个IP
    deny  192.168.1.0/24;   # 规则2：拒绝这个网段
    allow all;              # 规则3：允许所有其他IP
}

# 执行逻辑：
# 如果IP是 192.168.1.100 → 匹配规则1 → 允许访问
# 如果IP是 192.168.1.200 → 不匹配规则1，匹配规则2 → 拒绝访问  
# 如果IP是 10.0.0.1     → 不匹配规则1和2，匹配规则3 → 允许访问
```

> ⚠️ **重要提醒**：规则的顺序非常重要！先写的规则优先级更高

---

## 3. ✅ IP白名单配置


### 3.1 什么是IP白名单


**白名单概念**：只允许名单上的IP访问，其他一律拒绝

```
白名单模式：
┌─────────────────────────────────┐
│          所有访问请求            │
│                                │
│  ✅ 白名单IP → 允许访问         │
│  ❌ 其他IP   → 全部拒绝         │
└─────────────────────────────────┘

适用场景：高安全要求的管理后台、内部系统
```

### 3.2 单个IP白名单


**配置示例**：
```nginx
# 只允许管理员IP访问后台
location /admin {
    allow 192.168.1.10;    # 管理员办公室IP
    allow 192.168.1.20;    # 管理员家里IP
    deny all;              # 拒绝所有其他IP
    
    # 其他配置...
    try_files $uri $uri/ /admin/index.html;
}
```

**配置解释**：
- `allow 192.168.1.10;` - 允许这个特定IP访问
- `allow 192.168.1.20;` - 允许另一个特定IP访问  
- `deny all;` - **关键**：拒绝所有其他IP

> 📌 **记住**：白名单的关键是最后要加 `deny all;`，否则其他IP仍然可以访问

### 3.3 多个IP白名单的优雅写法


**方法一：直接列举**
```nginx
location /api {
    allow 192.168.1.10;
    allow 192.168.1.11;
    allow 192.168.1.12;
    allow 10.0.0.100;
    deny all;
}
```

**方法二：使用变量判断**
```nginx
# 在http块中定义地图
map $remote_addr $allowed_ip {
    default              0;
    192.168.1.10        1;
    192.168.1.11        1;
    192.168.1.12        1;
    10.0.0.100          1;
}

# 在location中使用
location /api {
    if ($allowed_ip = 0) {
        return 403;
    }
    # 其他配置...
}
```

---

## 4. ❌ IP黑名单配置


### 4.1 什么是IP黑名单


**黑名单概念**：拒绝名单上的IP访问，其他都可以正常访问

```
黑名单模式：
┌─────────────────────────────────┐
│          所有访问请求            │
│                                │
│  ❌ 黑名单IP → 拒绝访问         │
│  ✅ 其他IP   → 正常访问         │
└─────────────────────────────────┘

适用场景：阻止已知的恶意IP、爬虫IP
```

### 4.2 单个IP黑名单


**配置示例**：
```nginx
# 拒绝恶意IP访问
location / {
    deny 192.168.1.99;     # 发现的恶意IP
    deny 10.0.0.50;        # 另一个恶意IP
    allow all;             # 允许所有其他IP
    
    # 其他配置...
    try_files $uri $uri/ /index.html;
}
```

**配置解释**：
- `deny 192.168.1.99;` - 拒绝这个恶意IP
- `deny 10.0.0.50;` - 拒绝另一个恶意IP
- `allow all;` - **关键**：允许所有其他IP正常访问

### 4.3 批量封禁恶意IP


**实际场景**：发现了一批恶意爬虫IP需要封禁

```nginx
# 在server块中配置
server {
    listen 80;
    server_name example.com;
    
    # 封禁已知恶意IP
    deny 203.0.113.10;     # 恶意爬虫1
    deny 203.0.113.20;     # 恶意爬虫2
    deny 198.51.100.5;     # 攻击IP
    deny 198.51.100.15;    # 攻击IP
    
    location / {
        root /var/www/html;
        index index.html;
    }
}
```

---

## 5. 🌐 网段控制详解


### 5.1 什么是网段控制


**网段概念**：一次性控制一个IP地址范围，而不是一个一个IP地址去设置

> 💡 **生活类比**：就像说"禁止整个小区的人进入"，而不是一户一户地说"禁止张家、禁止李家..."

### 5.2 CIDR表示法详解


**CIDR格式**：`IP地址/子网掩码位数`

**常见网段范围**：
```
网段表示法        实际包含的IP范围              包含IP数量
192.168.1.0/24   192.168.1.0 - 192.168.1.255     256个
192.168.0.0/16   192.168.0.0 - 192.168.255.255   65536个
10.0.0.0/8       10.0.0.0 - 10.255.255.255       16777216个
```

**简单记忆方法**：
- `/24` - 一个C类网段（常见的局域网）
- `/16` - 一个B类网段（大型局域网）
- `/8` - 一个A类网段（超大网络）

### 5.3 网段控制实际应用


**场景1：只允许公司内网访问**
```nginx
location /internal {
    allow 192.168.1.0/24;    # 允许公司内网
    allow 10.0.0.0/8;        # 允许VPN网段
    deny all;                # 拒绝外网访问
}
```

**场景2：封禁某个地区的IP段**
```nginx
# 封禁某些已知的恶意IP段
location / {
    deny 185.220.0.0/16;     # 某个恶意IP段
    deny 179.43.0.0/16;      # 另一个恶意IP段
    allow all;               # 允许其他正常访问
}
```

**场景3：分层访问控制**
```nginx
# 不同路径不同权限
location /public {
    # 公共区域，允许所有人访问
    allow all;
}

location /member {
    # 会员区域，只允许特定网段
    allow 192.168.1.0/24;   # 公司网段
    allow 172.16.0.0/12;    # 合作伙伴网段
    deny all;
}

location /admin {
    # 管理区域，只允许管理员IP
    allow 192.168.1.10;     # 管理员IP
    deny all;
}
```

---

## 6. 🔄 动态IP控制策略


### 6.1 什么是动态IP控制


**动态控制含义**：根据实际情况自动调整访问控制策略，而不是写死在配置文件里

**为什么需要动态控制**：
- **管理员IP变化**：在家办公时IP地址不固定
- **攻击应对**：发现新的攻击IP需要快速封禁
- **业务需求**：根据业务情况临时开放或限制访问

### 6.2 基于geo模块的地理位置控制


**geo模块配置**：
```nginx
# 在http块中配置
geo $remote_addr $geo_country {
    default        unknown;
    127.0.0.0/8    local;
    192.168.0.0/16 internal;
    
    # 根据实际需要配置IP段对应的地区
    203.0.113.0/24 china;
    198.51.100.0/24 usa;
}

# 在location中使用
location /api {
    if ($geo_country = unknown) {
        return 403 "Access denied for unknown region";
    }
    
    # 只允许特定地区访问
    if ($geo_country !~ ^(china|internal)$) {
        return 403 "Access denied for your region";
    }
}
```

### 6.3 结合外部文件的动态控制


**方案思路**：将允许/拒绝的IP列表放在外部文件中，便于动态更新

```nginx
# 主配置文件
location /admin {
    include /etc/nginx/conf.d/admin_whitelist.conf;
    deny all;
}

# /etc/nginx/conf.d/admin_whitelist.conf 文件内容：
allow 192.168.1.10;    # 管理员1
allow 192.168.1.20;    # 管理员2
allow 203.0.113.50;    # 临时授权IP
```

**更新流程**：
```bash
# 1. 修改白名单文件
echo "allow 203.0.113.60;" >> /etc/nginx/conf.d/admin_whitelist.conf

# 2. 重新加载配置（不中断服务）
nginx -s reload
```

### 6.4 基于请求频率的动态限制


**限流控制配置**：
```nginx
# 定义限制区域
limit_req_zone $binary_remote_addr zone=login:10m rate=5r/m;

location /login {
    # 每个IP每分钟最多5次登录尝试
    limit_req zone=login burst=2 nodelay;
    
    # 如果超过限制，返回429状态码
    limit_req_status 429;
    
    # 正常处理登录
    proxy_pass http://backend;
}
```

---

## 7. 🎯 实际应用场景


### 7.1 网站后台管理保护


**需求**：网站后台只允许管理员访问，防止被恶意扫描和攻击

```nginx
# WordPress管理后台保护
location /wp-admin {
    allow 192.168.1.10;    # 管理员办公室
    allow 192.168.1.20;    # 管理员家里
    allow 203.0.113.100;   # 管理员手机热点
    deny all;
    
    # 正常的WordPress后台处理
    try_files $uri $uri/ /wp-admin/index.php?$args;
}

# WordPress登录页面保护
location /wp-login.php {
    allow 192.168.1.0/24;  # 内网可以登录
    deny all;
    
    fastcgi_pass php-fpm;
    include fastcgi_params;
}
```

### 7.2 API接口访问控制


**需求**：API接口只允许合作伙伴和内部系统调用

```nginx
# API访问控制
location /api {
    # 允许内部系统
    allow 192.168.1.0/24;
    
    # 允许合作伙伴A
    allow 203.0.113.0/24;
    
    # 允许合作伙伴B  
    allow 198.51.100.50;
    allow 198.51.100.51;
    
    # 拒绝其他所有访问
    deny all;
    
    # 转发到后端API服务
    proxy_pass http://api_backend;
    proxy_set_header X-Real-IP $remote_addr;
}
```

### 7.3 防止恶意爬虫和攻击


**需求**：封禁已知的恶意IP和爬虫，保护网站资源

```nginx
# 在server块开头集中配置黑名单
server {
    listen 80;
    server_name example.com;
    
    # 封禁恶意爬虫IP段
    deny 185.220.0.0/16;      # 某个恶意爬虫网段
    deny 179.43.0.0/16;       # 另一个恶意网段
    
    # 封禁单个攻击IP
    deny 203.0.113.99;        # 发现的攻击IP
    deny 198.51.100.88;       # 另一个攻击IP
    
    location / {
        root /var/www/html;
        index index.html;
    }
    
    # 特别保护敏感路径
    location ~ /\.(git|svn|env) {
        deny all;
        return 404;
    }
}
```

### 7.4 地区访问限制


**需求**：某些内容只对特定地区开放，或者屏蔽某些地区的访问

```nginx
# 使用geo模块进行地区控制
geo $remote_addr $blocked_country {
    default 0;
    # 假设这些是需要屏蔽的地区IP段
    185.0.0.0/8    1;
    179.0.0.0/8    1;
}

server {
    listen 80;
    server_name example.com;
    
    # 屏蔽特定地区
    if ($blocked_country) {
        return 403 "Access denied from your region";
    }
    
    location / {
        root /var/www/html;
        index index.html;
    }
}
```

---

## 8. 📋 核心要点总结


### 8.1 必须掌握的基本概念


```
🔸 访问控制：通过IP地址控制谁能访问网站的安全机制
🔸 allow指令：白名单，明确允许某些IP访问
🔸 deny指令：黑名单，明确拒绝某些IP访问  
🔸 规则顺序：按配置文件顺序检查，首次匹配就执行
🔸 网段控制：使用CIDR格式一次性控制IP地址范围
🔸 动态控制：结合外部文件和模块实现灵活的访问控制
```

### 8.2 关键理解要点


**🔹 白名单 vs 黑名单的选择**
```
白名单模式（推荐用于高安全场景）：
✅ 优点：安全性高，只允许信任的IP
❌ 缺点：管理复杂，新用户无法访问

黑名单模式（推荐用于一般场景）：
✅ 优点：管理简单，不影响正常用户
❌ 缺点：需要持续发现和封禁恶意IP

选择原则：
• 管理后台、API接口 → 使用白名单
• 普通网站、博客 → 使用黑名单
```

**🔹 规则配置的最佳实践**
```
配置顺序原则：
1. 特殊IP规则（单个IP的allow/deny）
2. 网段规则（IP段的allow/deny）  
3. 兜底规则（allow all 或 deny all）

常见错误：
❌ 忘记写 deny all（白名单失效）
❌ 规则顺序错误（被前面的规则覆盖）
❌ 网段表示法错误（/24, /16等）
```

**🔹 网段CIDR记忆技巧**
```
快速记忆：
/24 = 256个IP    (192.168.1.0/24)   ← 最常用
/16 = 65536个IP  (192.168.0.0/16)   ← 大网段  
/8  = 1677万个IP (10.0.0.0/8)       ← 超大网段

实用技巧：
• 公司内网通常用 /24
• 封禁恶意网段用 /16 或 /24
• 地区封禁可能用 /8
```

### 8.3 实际应用价值


**🎯 安全防护场景**
- **管理后台保护**：只允许管理员IP访问
- **API接口保护**：只允许合作伙伴调用
- **攻击防护**：快速封禁恶意IP和爬虫
- **地区限制**：根据业务需求限制地区访问

**🔧 运维管理实践**
- **配置文件分离**：将IP列表放在独立文件中
- **定期检查更新**：及时发现和封禁新的恶意IP
- **监控访问日志**：分析访问模式发现异常
- **备用访问方案**：为管理员准备多个可用IP

**核心记忆口诀**：
- IP控制两指令，allow白名单，deny黑名单
- 顺序检查很重要，首次匹配就执行
- 白名单末尾deny all，黑名单末尾allow all
- 网段控制用CIDR，/24最常用记心里

> 💡 **新手建议**：先从简单的单IP控制开始练习，熟悉后再使用网段控制和动态策略。记住每次修改配置后都要用 `nginx -t` 检查语法，用 `nginx -s reload` 重新加载配置。