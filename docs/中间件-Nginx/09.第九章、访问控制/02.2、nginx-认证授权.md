---
title: 2、nginx-认证授权
---
## 📚 目录


1. [认证授权基础概念](#1-认证授权基础概念)
2. [HTTP Basic认证](#2-HTTP-Basic认证)
3. [用户密码文件管理](#3-用户密码文件管理)
4. [认证域设置与配置](#4-认证域设置与配置)
5. [高级认证方案](#5-高级认证方案)
6. [权限控制策略](#6-权限控制策略)
7. [实战应用场景](#7-实战应用场景)
8. [核心要点总结](#8-核心要点总结)

---

# 1. 🔐 认证授权基础概念



## 1.1 什么是认证授权



**通俗理解：认证授权就像小区门禁**
```
现实生活中的门禁系统：
🏠 小区大门 → 刷卡进入（认证：你是谁）
🏢 电梯按钮 → 只能到你住的楼层（授权：你能做什么）

网站访问控制：
🌐 网站入口 → 输入用户名密码（认证）
📁 特定页面 → 检查用户权限（授权）
```

**核心概念解释：**
- **认证（Authentication）**：验证"你是谁"
- **授权（Authorization）**：决定"你能做什么"
- **访问控制**：结合认证和授权，控制资源访问

## 1.2 为什么需要访问控制



**实际应用场景：**

①② **管理后台保护**
```
问题：管理后台不能让所有人都能访问
解决：设置用户名密码，只有管理员能进入
效果：保护敏感数据和管理功能
```

③④ **内部文档系统**
```
问题：公司内部文档不能对外公开
解决：员工登录后才能查看相关文档
效果：信息安全，防止泄露
```

⑤⑥ **API接口保护**
```
问题：API不能被恶意调用
解决：需要提供有效token才能访问
效果：防止滥用，保证服务稳定
```

## 1.3 Nginx认证授权的优势



**为什么选择Nginx做访问控制？**

┌─────────────────────────────────────┐
│ 🌟 Nginx访问控制优势                │
├─────────────────────────────────────┤
│ ⚡ 性能高效：在请求到达后端前就过滤   │
│ 🔧 配置简单：几行配置就能实现         │
│ 🛡️ 安全可靠：久经考验的成熟方案       │
│ 💡 灵活多样：支持多种认证方式         │
│ 📊 易于管理：统一在反向代理层控制     │
└─────────────────────────────────────┘

---

# 2. 🔑 HTTP Basic认证



## 2.1 Basic认证原理



**什么是HTTP Basic认证？**

HTTP Basic认证是最简单的网页认证方式，就像在网页上弹出一个登录对话框。

```
用户访问过程：
1. 用户访问受保护页面
2. 浏览器弹出登录框 📱
3. 用户输入用户名和密码
4. 浏览器发送认证信息给服务器
5. 服务器验证通过后显示页面
```

**认证流程图示：**
```
浏览器                    Nginx服务器
   |                          |
   |--[1]请求受保护资源------->|
   |                          |
   |<--[2]返回401未授权-------|
   |    (要求认证)             |
   |                          |
   |--[3]发送用户名密码------>|
   |   (Base64编码)           |
   |                          |
   |<--[4]验证成功返回内容----|
   |                          |
```

## 2.2 Basic认证配置语法



**核心指令解释：**

**`auth_basic` 指令**
```nginx
# 开启认证并设置提示信息

auth_basic "请输入用户名和密码";

# 关闭认证

auth_basic off;
```
- **作用**：启用HTTP Basic认证
- **参数**：认证提示文字（会显示在登录框上）
- **位置**：可在 `location` 、`server` 、`http` 块中使用

**`auth_basic_user_file` 指令**
```nginx
# 指定用户密码文件位置

auth_basic_user_file /etc/nginx/passwd;
```
- **作用**：指定存储用户名和密码的文件
- **参数**：文件的绝对路径
- **格式**：用户名:加密密码，每行一个用户

## 2.3 基础配置示例



**简单的管理后台保护：**

```nginx
server {
    listen 80;
    server_name admin.example.com;
    
#    # 管理后台需要认证
    location /admin {
        auth_basic "管理员登录";
        auth_basic_user_file /etc/nginx/admin.passwd;
        
#        # 后端管理系统
        proxy_pass http://backend_admin;
    }
    
#    # 普通页面不需要认证
    location / {
        proxy_pass http://backend_web;
    }
}
```

**部分目录认证：**

```nginx
server {
    listen 80;
    server_name docs.company.com;
    
#    # 公开文档区域
    location /public {
        root /var/www/docs;
    }
    
#    # 内部文档需要认证
    location /internal {
        auth_basic "内部文档访问";
        auth_basic_user_file /etc/nginx/internal.passwd;
        root /var/www/docs;
    }
    
#    # 机密文档需要特殊认证
    location /confidential {
        auth_basic "机密文档区域";
        auth_basic_user_file /etc/nginx/confidential.passwd;
        root /var/www/docs;
    }
}
```

---

# 3. 📝 用户密码文件管理



## 3.1 密码文件格式



**标准格式说明：**

用户密码文件采用`用户名:加密密码`的格式，每行一个用户：

```
# /etc/nginx/passwd 文件内容示例

admin:$apr1$abc123$xyz789...     # 管理员账户
user1:$apr1$def456$uvw123...     # 普通用户1  
user2:$apr1$ghi789$rst456...     # 普通用户2
```

**格式要点：**
- ✅ **分隔符**：用冒号 `:` 分隔用户名和密码
- ✅ **加密方式**：密码必须加密存储，不能明文
- ✅ **一行一用户**：每行只能有一个用户记录
- ✅ **无空行**：文件中不要有空行或多余字符

## 3.2 创建密码文件



**使用htpasswd工具：**

htpasswd是专门用来创建HTTP认证密码文件的工具，非常简单好用。

```bash
# 安装htpasswd工具

# Ubuntu/Debian系统

sudo apt-get install apache2-utils

# CentOS/RHEL系统  

sudo yum install httpd-tools
```

**创建新的密码文件：**

```bash
# 创建新文件并添加第一个用户

sudo htpasswd -c /etc/nginx/passwd admin
# 系统会提示输入密码，输入两次确认


# 添加更多用户（不用-c参数）

sudo htpasswd /etc/nginx/passwd user1
sudo htpasswd /etc/nginx/passwd user2
```

**参数说明：**
- **`-c`**：创建新文件（只在第一次使用）
- **`-B`**：使用bcrypt加密（推荐，更安全）
- **`-d`**：删除指定用户

## 3.3 密码文件安全管理



**文件权限设置：**

```bash
# 设置正确的文件权限

sudo chown root:nginx /etc/nginx/passwd
sudo chmod 640 /etc/nginx/passwd

# 权限解释：

# 640 = rw-r-----

# 所有者(root)：读写权限

# 群组(nginx)：只读权限  

# 其他用户：无权限

```

> 💡 **安全提示**：密码文件权限很重要！设置不当可能被其他用户读取。

**密码文件管理最佳实践：**

①② **定期更新密码**
```bash
# 更新用户密码

sudo htpasswd /etc/nginx/passwd admin
```

③④ **备份密码文件**
```bash
# 备份到安全位置

sudo cp /etc/nginx/passwd /backup/nginx-passwd-$(date +%Y%m%d)
```

⑤⑥ **监控访问日志**
```bash
# 查看认证失败的尝试

sudo grep "401" /var/log/nginx/access.log
```

---

# 4. 🏷️ 认证域设置与配置



## 4.1 认证域概念



**什么是认证域？**

认证域（Realm）就像给不同的房间贴上不同的标签，告诉用户这是什么地方，需要什么级别的权限。

```
公司办公楼的例子：
🏢 一楼大厅 → 无需认证
🔐 财务部门 → "财务系统登录"  
🔐 技术部门 → "开发环境访问"
🔐 总经理室 → "高级管理区域"
```

**认证域的作用：**
- **用户体验**：清楚告诉用户这是什么系统
- **权限区分**：不同区域可以有不同的用户群体
- **浏览器缓存**：相同域的认证信息会被浏览器记住

## 4.2 多认证域配置



**不同目录使用不同认证域：**

```nginx
server {
    listen 80;
    server_name portal.company.com;
    
#    # 管理系统认证域
    location /admin {
        auth_basic "管理系统 - 请使用管理员账号登录";
        auth_basic_user_file /etc/nginx/admin.passwd;
        proxy_pass http://admin_backend;
    }
    
#    # 开发环境认证域
    location /dev {
        auth_basic "开发环境 - 请使用开发者账号登录";
        auth_basic_user_file /etc/nginx/dev.passwd;
        proxy_pass http://dev_backend;
    }
    
#    # 测试环境认证域
    location /test {
        auth_basic "测试环境 - 请使用测试账号登录";
        auth_basic_user_file /etc/nginx/test.passwd;
        proxy_pass http://test_backend;
    }
}
```

## 4.3 条件认证配置



**基于IP地址的条件认证：**

有时我们希望内网用户不需要认证，外网用户需要认证。

```nginx
# 定义内网IP段

geo $internal_user {
    default 0;
    192.168.1.0/24 1;    # 公司内网
    10.0.0.0/8 1;        # 内部网络
    127.0.0.1 1;         # 本地访问
}

server {
    listen 80;
    server_name internal.company.com;
    
    location /dashboard {
#        # 外网用户需要认证，内网用户直接访问
        if ($internal_user = 0) {
            auth_basic "外网访问需要认证";
            auth_basic_user_file /etc/nginx/external.passwd;
        }
        
        proxy_pass http://dashboard_backend;
    }
}
```

**基于时间的认证控制：**

```nginx
# 根据时间决定是否需要认证

map $time_iso8601 $office_hours {
    default 0;
    ~T(09|1[0-7]):[0-5][0-9]:[0-5][0-9] 1;  # 9:00-17:59 工作时间
}

server {
    listen 80;
    server_name workspace.company.com;
    
    location /tools {
#        # 非工作时间需要额外认证
        if ($office_hours = 0) {
            auth_basic "非工作时间访问需要特殊授权";
            auth_basic_user_file /etc/nginx/after_hours.passwd;
        }
        
        proxy_pass http://tools_backend;
    }
}
```

---

# 5. 🚀 高级认证方案



## 5.1 第三方认证集成



**什么是第三方认证？**

第三方认证就是借用其他系统的用户账号，比如用微信登录购物网站，用Google账号登录其他应用。

**常见第三方认证方式：**

┌─────────────────────────────────────┐
│ 🔗 主流第三方认证方案               │
├─────────────────────────────────────┤
│ 🌐 OAuth 2.0：Google、GitHub等     │
│ 🏢 LDAP：企业活动目录              │
│ 🎫 SAML：企业单点登录              │
│ 🔑 OpenID Connect：标准化认证      │
└─────────────────────────────────────┘

**使用auth_request模块进行外部认证：**

```nginx
# 外部认证服务配置

upstream auth_server {
    server 127.0.0.1:8080;
}

server {
    listen 80;
    server_name app.example.com;
    
#    # 内部认证接口
    location = /auth {
        internal;  # 只能内部调用
        proxy_pass http://auth_server/verify;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URI $request_uri;
        proxy_set_header X-Original-Remote-Addr $remote_addr;
    }
    
#    # 需要认证的应用
    location /app {
        auth_request /auth;  # 先调用认证接口
        
#        # 认证成功后的处理
        proxy_pass http://app_backend;
        
#        # 传递用户信息到后端
        auth_request_set $user $upstream_http_x_user;
        proxy_set_header X-User $user;
    }
    
#    # 登录页面
    location /login {
        proxy_pass http://auth_server/login;
    }
}
```

## 5.2 JWT认证实现



**JWT认证原理：**

JWT（JSON Web Token）就像一张特殊的身份证，包含了用户信息和有效期，服务器可以直接验证而不需要查数据库。

```
JWT结构示例：
┌──────────────┬──────────────┬──────────────┐
│    Header    │   Payload    │  Signature   │
│   (头部)     │   (载荷)     │   (签名)     │
├──────────────┼──────────────┼──────────────┤
│ 算法和类型   │ 用户信息     │ 防篡改签名   │
│ {"alg":"HS"} │ {"user":"xx"}│ 加密字符串   │
└──────────────┴──────────────┴──────────────┘
```

**使用lua脚本验证JWT：**

```nginx
# 需要安装lua模块

server {
    listen 80;
    server_name api.example.com;
    
    location /api {
#        # Lua脚本验证JWT
        access_by_lua_block {
            local jwt = require "resty.jwt"
            local jwt_token = ngx.var.http_authorization
            
            if not jwt_token then
                ngx.status = 401
                ngx.say("缺少认证令牌")
                ngx.exit(401)
            end
            
#            # 去掉Bearer前缀
            jwt_token = string.gsub(jwt_token, "Bearer ", "")
            
#            # 验证JWT
            local jwt_obj = jwt:verify("your-secret-key", jwt_token)
            if not jwt_obj.verified then
                ngx.status = 401
                ngx.say("认证令牌无效")
                ngx.exit(401)
            end
            
#            # 设置用户信息供后端使用
            ngx.var.user_id = jwt_obj.payload.user_id
        }
        
        proxy_pass http://api_backend;
        proxy_set_header X-User-ID $user_id;
    }
}
```

## 5.3 多重认证策略



**组合多种认证方式：**

```nginx
server {
    listen 80;
    server_name secure.example.com;
    
#    # 高度敏感区域：需要多重认证
    location /critical {
#        # 第一重：Basic认证
        auth_basic "第一重认证 - 基础验证";
        auth_basic_user_file /etc/nginx/basic.passwd;
        
#        # 第二重：IP白名单
        allow 192.168.1.100;  # 管理员IP
        allow 192.168.1.101;  # 备用管理IP
        deny all;
        
#        # 第三重：外部JWT验证
        auth_request /jwt_verify;
        
        proxy_pass http://critical_backend;
    }
    
#    # JWT验证接口
    location = /jwt_verify {
        internal;
        proxy_pass http://jwt_auth_server/verify;
    }
}
```

---

# 6. 🛡️ 权限控制策略



## 6.1 基于角色的访问控制



**什么是角色控制？**

角色控制就像公司的职位权限，不同职位的人能访问不同的资源。

```
公司权限分级示例：
👨‍💼 总经理：能访问所有系统
👩‍💻 部门经理：能访问本部门系统  
👨‍🔧 普通员工：只能访问基础功能
👤 实习生：只能访问培训材料
```

**基于用户组的权限配置：**

```nginx
# 定义不同用户组的密码文件

# /etc/nginx/admin.passwd - 管理员组

# /etc/nginx/manager.passwd - 经理组  

# /etc/nginx/employee.passwd - 员工组


server {
    listen 80;
    server_name erp.company.com;
    
#    # 管理员专区：所有权限
    location /admin {
        auth_basic "管理员登录";
        auth_basic_user_file /etc/nginx/admin.passwd;
        proxy_pass http://admin_system;
    }
    
#    # 经理专区：部门管理权限
    location /manager {
        auth_basic "部门经理登录";
        auth_basic_user_file /etc/nginx/manager.passwd;
        proxy_pass http://manager_system;
    }
    
#    # 员工专区：基础功能
    location /employee {
        auth_basic "员工登录";
        auth_basic_user_file /etc/nginx/employee.passwd;
        proxy_pass http://employee_system;
    }
    
#    # 公共区域：无需认证
    location /public {
        proxy_pass http://public_system;
    }
}
```

## 6.2 细粒度权限控制



**HTTP方法权限控制：**

```nginx
server {
    listen 80;
    server_name api.company.com;
    
#    # API接口权限控制
    location /api/data {
#        # 读取权限：所有认证用户
        if ($request_method = GET) {
            auth_basic "数据读取权限";
            auth_basic_user_file /etc/nginx/read_users.passwd;
        }
        
#        # 写入权限：高级用户
        if ($request_method ~ ^(POST|PUT|DELETE)$) {
            auth_basic "数据写入权限";
            auth_basic_user_file /etc/nginx/write_users.passwd;
        }
        
        proxy_pass http://api_backend;
    }
}
```

**时间段权限控制：**

```nginx
# 工作时间检查

map $time_iso8601 $business_hours {
    default 0;
    ~T(0[9]|1[0-7]):[0-5][0-9]:[0-5][0-9] 1;  # 9:00-17:59
}

server {
    listen 80;
    server_name tools.company.com;
    
    location /sensitive-tools {
#        # 非工作时间限制访问
        if ($business_hours = 0) {
            auth_basic "非工作时间需要高级权限";
            auth_basic_user_file /etc/nginx/after_hours.passwd;
        }
        
#        # 工作时间的基础认证
        if ($business_hours = 1) {
            auth_basic "工具系统访问";
            auth_basic_user_file /etc/nginx/regular_users.passwd;
        }
        
        proxy_pass http://tools_backend;
    }
}
```

## 6.3 动态权限控制



**基于外部系统的动态权限：**

```nginx
server {
    listen 80;
    server_name dynamic.company.com;
    
#    # 动态权限检查
    location /protected {
#        # 调用权限检查服务
        auth_request /check_permission;
        
#        # 传递权限检查结果
        auth_request_set $permission_level $upstream_http_x_permission;
        proxy_set_header X-Permission-Level $permission_level;
        
        proxy_pass http://protected_backend;
    }
    
#    # 权限检查接口
    location = /check_permission {
        internal;
        proxy_pass http://permission_service/check;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        
#        # 传递用户信息
        proxy_set_header X-Original-URI $request_uri;
        proxy_set_header X-User-IP $remote_addr;
        proxy_set_header X-User-Agent $http_user_agent;
    }
}
```

---

# 7. 💼 实战应用场景



## 7.1 企业内部系统保护



**场景描述：**
某公司有多个内部系统，需要根据员工级别控制访问权限。

**解决方案：**

```nginx
# 企业内部门户配置

server {
    listen 80;
    server_name portal.company.internal;
    
#    # 首页：所有员工可访问
    location / {
        auth_basic "员工门户登录";
        auth_basic_user_file /etc/nginx/all_employees.passwd;
        proxy_pass http://portal_home;
    }
    
#    # 人事系统：HR和管理层
    location /hr {
        auth_basic "人事系统 - HR专用";
        auth_basic_user_file /etc/nginx/hr_staff.passwd;
        proxy_pass http://hr_system;
    }
    
#    # 财务系统：财务部和高管
    location /finance {
        auth_basic "财务系统 - 财务部门";
        auth_basic_user_file /etc/nginx/finance_staff.passwd;
        proxy_pass http://finance_system;
    }
    
#    # 总经理办公室：仅高级管理层
    location /executive {
        auth_basic "高管办公系统";
        auth_basic_user_file /etc/nginx/executives.passwd;
        
#        # 额外IP限制
        allow 192.168.1.200;  # 总经理办公室
        allow 192.168.1.201;  # 副总办公室
        deny all;
        
        proxy_pass http://executive_system;
    }
}
```

## 7.2 开发环境访问控制



**场景描述：**
开发团队需要访问测试环境和开发环境，但要防止外部访问。

**配置示例：**

```nginx
# 开发环境访问控制

upstream dev_app {
    server 192.168.10.100:8080;
    server 192.168.10.101:8080;
}

upstream test_app {
    server 192.168.10.200:8080;
    server 192.168.10.201:8080;
}

server {
    listen 80;
    server_name dev.company.com;
    
#    # 开发环境：开发人员访问
    location /dev {
#        # VPN网段访问控制
        allow 10.0.0.0/8;        # 公司VPN
        allow 192.168.1.0/24;    # 办公网络
        deny all;
        
        auth_basic "开发环境访问";
        auth_basic_user_file /etc/nginx/developers.passwd;
        
        proxy_pass http://dev_app;
        proxy_set_header X-Environment "development";
    }
    
#    # 测试环境：测试人员和开发人员
    location /test {
        allow 10.0.0.0/8;
        allow 192.168.1.0/24;
        deny all;
        
        auth_basic "测试环境访问";
        auth_basic_user_file /etc/nginx/testers.passwd;
        
        proxy_pass http://test_app;
        proxy_set_header X-Environment "testing";
    }
    
#    # 监控页面：运维人员
    location /monitor {
        auth_basic "系统监控";
        auth_basic_user_file /etc/nginx/ops_team.passwd;
        
        proxy_pass http://monitoring_system;
    }
}
```

## 7.3 API接口认证保护



**场景描述：**
提供对外API服务，需要API密钥认证和频率限制。

**实现方案：**

```nginx
# API认证和限流配置

http {
#    # 限流配置
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
    limit_req_zone $http_x_api_key zone=api_key_limit:10m rate=100r/s;
    
#    # API密钥验证
    map $http_x_api_key $api_key_valid {
        default 0;
        "sk_live_123456789" 1;
        "sk_live_987654321" 1;
        "sk_test_111222333" 1;
    }
}

server {
    listen 80;
    server_name api.service.com;
    
#    # 公开API：需要API密钥
    location /api/v1/public {
#        # 检查API密钥
        if ($api_key_valid = 0) {
            return 401 '{"error":"无效的API密钥"}';
        }
        
#        # API限流
        limit_req zone=api_key_limit burst=20 nodelay;
        
        proxy_pass http://api_backend;
        proxy_set_header X-API-Key $http_x_api_key;
    }
    
#    # 私有API：需要额外认证
    location /api/v1/private {
#        # API密钥检查
        if ($api_key_valid = 0) {
            return 401 '{"error":"无效的API密钥"}';
        }
        
#        # 额外的Basic认证
        auth_basic "私有API访问";
        auth_basic_user_file /etc/nginx/api_premium.passwd;
        
#        # 更严格的限流
        limit_req zone=api_key_limit burst=10 nodelay;
        
        proxy_pass http://private_api_backend;
        proxy_set_header X-API-Key $http_x_api_key;
    }
    
#    # 管理API：仅内部使用
    location /api/v1/admin {
#        # 仅允许内网访问
        allow 192.168.1.0/24;
        deny all;
        
        auth_basic "管理API";
        auth_basic_user_file /etc/nginx/api_admin.passwd;
        
        proxy_pass http://admin_api_backend;
    }
}
```

---

# 8. 📋 核心要点总结



## 8.1 必须掌握的基本概念



```
🔸 认证授权：认证验证身份，授权控制权限
🔸 HTTP Basic认证：最简单的网页认证方式
🔸 密码文件：存储用户凭据，必须加密保存
🔸 认证域：不同区域的认证提示和用户群体
🔸 权限控制：基于角色、时间、IP等条件的访问控制
```

## 8.2 关键配置要点



**🔹 基础认证配置**
```nginx
# 核心配置模板

location /protected {
    auth_basic "认证提示信息";
    auth_basic_user_file /path/to/passwd;
#    # 其他配置...
}
```

**🔹 安全最佳实践**
```
文件权限：密码文件设置为640权限
密码安全：使用htpasswd工具加密存储
定期更新：定期更换密码和审核用户
日志监控：监控认证失败和异常访问
```

**🔹 高级功能应用**
```
条件认证：基于IP、时间等条件的动态认证
多重认证：组合多种认证方式提高安全性
外部集成：与LDAP、OAuth等第三方系统集成
API保护：使用JWT、API密钥等现代认证方式
```

## 8.3 实际应用价值



**💼 企业应用场景**
- **内部系统保护**：员工门户、管理后台、开发环境
- **API服务安全**：对外接口的认证和授权控制  
- **文档系统**：按权限等级控制文档访问
- **监控运维**：运维工具和监控系统的访问控制

**🔧 技术优势**
- **性能高效**：在Nginx层面过滤，减轻后端压力
- **配置灵活**：支持多种认证方式和复杂规则
- **易于管理**：统一的访问控制入口
- **安全可靠**：成熟稳定的认证机制

## 8.4 学习要点提醒



> 💡 **新手重点**：先掌握Basic认证，理解认证和授权的区别

> ⚠️ **安全注意**：密码文件权限、HTTPS传输、定期审核

> 🚀 **进阶方向**：学习JWT、OAuth2.0等现代认证标准

**核心记忆口诀**：
- 认证验身份，授权定权限
- Basic认证简单用，密码文件要加密  
- 多重保护更安全，条件控制更灵活
- 企业应用广又深，安全第一是根本