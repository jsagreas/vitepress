---
title: 3、nginx-安全防护
---
## 📚 目录

1. [安全防护基本概念](#1-安全防护基本概念)
2. [防盗链配置详解](#2-防盗链配置详解)
3. [防注入攻击配置](#3-防注入攻击配置)
4. [版本信息隐藏](#4-版本信息隐藏)
5. [安全响应头设置](#5-安全响应头设置)
6. [请求限制与防护](#6-请求限制与防护)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 🛡️ 安全防护基本概念


### 1.1 什么是Web安全防护


**简单理解**：就像给你的房子装防盗门、监控摄像头一样，Web安全防护就是给网站装各种"安全设备"，防止坏人进来搞破坏。

```
现实生活类比：
房子安全 ≈ 网站安全
├── 防盗门 ≈ 访问控制
├── 监控   ≈ 日志记录
├── 保安   ≈ 防火墙
└── 警报   ≈ 入侵检测
```

**🔸 为什么需要安全防护**
- **保护数据**：防止用户信息泄露
- **维护服务**：避免网站被攻击瘫痪
- **防止损失**：减少经济和声誉损失
- **合规要求**：满足安全法规标准

### 1.2 常见的Web攻击类型


**📊 攻击方式对照表**

| 攻击类型 | **简单理解** | **危害** | **Nginx防护** |
|---------|------------|---------|--------------|
| 🔗 **盗链** | `别人偷用你的图片流量` | `带宽浪费，服务器压力` | `refer检查` |
| 💉 **SQL注入** | `通过输入框攻击数据库` | `数据泄露，系统破坏` | `请求过滤` |
| 🎭 **XSS攻击** | `在网页中插入恶意代码` | `用户信息被盗` | `安全头设置` |
| 🌊 **DDoS** | `大量请求让服务器瘫痪` | `网站无法访问` | `请求限制` |

### 1.3 Nginx安全防护优势


**🎯 为什么选择Nginx做安全防护**
```
性能优势：
• 高并发处理能力
• 低内存占用
• 快速响应恶意请求

配置优势：
• 规则简单易懂
• 模块化配置
• 实时生效无需重启

成本优势：
• 开源免费
• 部署简单
• 维护成本低
```

---

## 2. 🔗 防盗链配置详解


### 2.1 什么是盗链


**通俗解释**：盗链就像有人直接用你家的电线给他家供电一样。别的网站直接引用你网站的图片、视频等资源，但流量和带宽费用却是你在承担。

```
盗链示例：
你的网站：www.yoursite.com/images/photo.jpg
盗链网站：<img src="http://www.yoursite.com/images/photo.jpg">

结果：
✅ 盗链网站显示了图片
❌ 你的服务器承担流量费用
❌ 你的带宽被无偿占用
```

### 2.2 基础防盗链配置


**🔸 根据来源网站判断**

```nginx
# 基础防盗链配置
location ~* \.(jpg|jpeg|png|gif|bmp|svg|webp)$ {
    # 检查请求来源
    valid_referers none blocked server_names
                   www.yoursite.com
                   yoursite.com
                   *.yoursite.com;
    
    # 如果来源不合法，返回禁止访问
    if ($invalid_referer) {
        return 403;
    }
    
    # 设置缓存时间
    expires 7d;
    add_header Cache-Control "public, immutable";
}
```

**📝 配置说明**：
- `valid_referers`：定义合法的来源
- `none`：允许直接访问（地址栏输入）
- `blocked`：允许不发送referer的请求
- `server_names`：允许本服务器名称
- `*.yoursite.com`：允许子域名

### 2.3 高级防盗链策略


**🎯 返回替代图片而不是403错误**

```nginx
location ~* \.(jpg|jpeg|png|gif)$ {
    valid_referers none blocked server_names
                   www.yoursite.com
                   yoursite.com;
    
    if ($invalid_referer) {
        # 返回防盗链提示图片，而不是错误页面
        rewrite ^.*$ /images/no-hotlink.png last;
    }
    
    expires 30d;
}

# 防盗链提示图片不做referer检查
location = /images/no-hotlink.png {
    expires 1d;
}
```

**💡 为什么用替代图片更好**
- **用户体验**：不会看到错误页面
- **友好提示**：可以显示版权信息
- **减少投诉**：避免因403错误被举报

### 2.4 白名单防盗链


**🔸 允许特定网站使用资源**

```nginx
# 设置白名单变量
map $http_referer $allow_referer {
    default                    0;
    ~*yoursite\.com           1;
    ~*partner\.com            1;
    ~*trusted-site\.com       1;
    ~*google\.com             1;
    ~*baidu\.com              1;
}

location ~* \.(jpg|jpeg|png|gif|css|js)$ {
    # 检查是否在白名单中
    if ($allow_referer = 0) {
        return 403;
    }
    
    expires 30d;
}
```

### 2.5 防盗链监控与统计


**📊 记录盗链尝试**

```nginx
# 创建专门的日志格式
log_format hotlink '$remote_addr - $remote_user [$time_local] '
                   '"$request" $status $body_bytes_sent '
                   '"$http_referer" "$http_user_agent"';

location ~* \.(jpg|jpeg|png|gif)$ {
    valid_referers none blocked server_names yoursite.com;
    
    if ($invalid_referer) {
        # 记录盗链尝试
        access_log /var/log/nginx/hotlink.log hotlink;
        return 403;
    }
}
```

---

## 3. 💉 防注入攻击配置


### 3.1 什么是SQL注入和XSS


**🔸 SQL注入简单理解**
```
正常查询：SELECT * FROM users WHERE name = '张三'
恶意注入：SELECT * FROM users WHERE name = ''; DROP TABLE users; --'

就像：
正常对话："请帮我查张三的信息"
恶意注入："请帮我查张三的信息；顺便把用户表删了；后面不用管"
```

**🔸 XSS攻击简单理解**
```
正常输入：用户名填写"小明"
恶意输入：用户名填写"<script>alert('被攻击了')</script>"

结果：网页会执行这段恶意代码
```

### 3.2 基础请求过滤


**🛡️ 过滤危险参数**

```nginx
# 检测SQL注入关键词
location / {
    # 检查URL参数和POST数据
    if ($args ~* "union.*select|insert.*into|delete.*from|drop.*table") {
        return 444;  # 直接断开连接
    }
    
    # 检查常见SQL注入模式
    if ($request_body ~* "union.*select|insert.*into|delete.*from") {
        return 444;
    }
    
    # 检查XSS攻击模式
    if ($args ~* "script.*>|<.*script|javascript:|onclick=|onload=") {
        return 444;
    }
    
    proxy_pass http://backend;
}
```

### 3.3 高级安全过滤规则


**📋 创建安全规则集**

```nginx
# 创建专门的安全配置文件：/etc/nginx/security.conf

# SQL注入防护
map $args $is_sql_injection {
    default                           0;
    ~*union.*select                   1;
    ~*insert.*into                    1;
    ~*delete.*from                    1;
    ~*drop.*table                     1;
    ~*update.*set                     1;
    ~*concat.*\(                      1;
    ~*substr.*\(                      1;
    ~*'.*or.*'1'.*=.*'1              1;
}

# XSS攻击防护
map $args $is_xss_attack {
    default                           0;
    ~*<script                         1;
    ~*javascript:                     1;
    ~*vbscript:                       1;
    ~*onclick=                        1;
    ~*onload=                         1;
    ~*onerror=                        1;
    ~*eval\(                          1;
}

# 在主配置中引用
location / {
    # 引入安全配置
    include /etc/nginx/security.conf;
    
    # 检查SQL注入
    if ($is_sql_injection = 1) {
        access_log /var/log/nginx/attack.log attack_log;
        return 444;
    }
    
    # 检查XSS攻击
    if ($is_xss_attack = 1) {
        access_log /var/log/nginx/attack.log attack_log;
        return 444;
    }
    
    proxy_pass http://backend;
}
```

### 3.4 用户代理过滤


**🤖 拦截恶意爬虫和工具**

```nginx
# 创建User-Agent黑名单
map $http_user_agent $blocked_agent {
    default                     0;
    ~*sqlmap                    1;
    ~*nikto                     1;
    ~*nessus                    1;
    ~*masscan                   1;
    ~*nmap                      1;
    ~*gobuster                  1;
    ~*python-requests           1;
    ""                          1;  # 空User-Agent
}

location / {
    if ($blocked_agent = 1) {
        return 444;
    }
    
    proxy_pass http://backend;
}
```

---

## 4. 🎭 版本信息隐藏


### 4.1 为什么要隐藏版本信息


**🔸 安全风险**
```
暴露版本的风险：
攻击者看到：Server: nginx/1.18.0
攻击者知道：这个版本有哪些已知漏洞
攻击者行动：针对性地发起攻击

就像：
❌ 在门上贴"家里有现金，门锁是XX牌普通锁"
✅ 什么都不贴，让坏人不知道情况
```

### 4.2 隐藏Nginx版本号


**🔧 基础版本隐藏**

```nginx
# 在 http 块中添加
http {
    # 隐藏Nginx版本号
    server_tokens off;
    
    # 自定义Server头（可选）
    # 完全不显示Server信息
    more_clear_headers 'Server';
    
    # 或者显示自定义信息
    # more_set_headers 'Server: WebServer';
}
```

**📊 效果对比**
```
隐藏前：
HTTP/1.1 200 OK
Server: nginx/1.18.0
Content-Type: text/html

隐藏后：
HTTP/1.1 200 OK
Server: nginx
Content-Type: text/html
```

### 4.3 隐藏后端应用信息


**🎯 隐藏PHP、Python等后端标识**

```nginx
location ~ \.php$ {
    # 隐藏PHP版本信息
    fastcgi_hide_header X-Powered-By;
    
    # 隐藏其他可能暴露信息的头
    proxy_hide_header X-Powered-By;
    proxy_hide_header X-AspNet-Version;
    proxy_hide_header X-AspNetMvc-Version;
    
    fastcgi_pass php-fpm;
}
```

### 4.4 错误页面安全处理


**📄 自定义错误页面**

```nginx
# 统一错误页面，避免暴露系统信息
error_page 400 401 402 403 404 /40x.html;
error_page 500 501 502 503 504 /50x.html;

location = /40x.html {
    root /usr/share/nginx/html;
    internal;  # 只能内部访问
}

location = /50x.html {
    root /usr/share/nginx/html;
    internal;
}

# 在错误页面中不要暴露具体错误信息
location / {
    # 不显示详细错误信息
    proxy_intercept_errors on;
    proxy_pass http://backend;
}
```

---

## 5. 🔒 安全响应头设置


### 5.1 什么是安全响应头


**简单理解**：安全响应头就像给网页戴上各种"防护装备"，告诉浏览器应该如何安全地处理这个网页。

```
生活类比：
安全头 = 使用说明书
├── "请戴安全帽" ≈ Content-Security-Policy
├── "禁止外人进入" ≈ X-Frame-Options  
├── "检查证件" ≈ Strict-Transport-Security
└── "小心地滑" ≈ X-Content-Type-Options
```

### 5.2 核心安全头配置


**🛡️ 基础安全头设置**

```nginx
location / {
    # 防止页面被嵌入iframe（防点击劫持）
    add_header X-Frame-Options "SAMEORIGIN" always;
    
    # 防止MIME类型嗅探
    add_header X-Content-Type-Options "nosniff" always;
    
    # 启用XSS保护
    add_header X-XSS-Protection "1; mode=block" always;
    
    # 控制referer信息发送
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # 强制HTTPS（如果使用HTTPS）
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    
    proxy_pass http://backend;
}
```

**📝 各个头的作用解释**：

| 安全头 | **作用** | **简单理解** |
|--------|---------|-------------|
| `X-Frame-Options` | `防止被嵌入其他网站` | `不允许别人把你的网页装进他们的框里` |
| `X-Content-Type-Options` | `防止文件类型被修改` | `图片就是图片，不能当脚本运行` |
| `X-XSS-Protection` | `启用浏览器XSS防护` | `浏览器帮忙检查恶意代码` |
| `Referrer-Policy` | `控制来源信息泄露` | `控制告诉别人你从哪来的信息` |

### 5.3 高级安全策略配置


**🎯 内容安全策略（CSP）**

```nginx
location / {
    # 基础CSP策略
    add_header Content-Security-Policy "
        default-src 'self';
        script-src 'self' 'unsafe-inline' cdn.example.com;
        style-src 'self' 'unsafe-inline' fonts.googleapis.com;
        img-src 'self' data: *.yourdomain.com;
        font-src 'self' fonts.gstatic.com;
        connect-src 'self' api.yourdomain.com;
        frame-ancestors 'none';
    " always;
    
    proxy_pass http://backend;
}
```

**💡 CSP规则解释**：
- `default-src 'self'`：默认只允许同域资源
- `script-src`：控制JavaScript来源
- `style-src`：控制CSS样式来源
- `img-src`：控制图片来源
- `frame-ancestors 'none'`：禁止被其他网站嵌入

### 5.4 HTTPS安全增强


**🔐 HTTPS专用安全配置**

```nginx
server {
    listen 443 ssl http2;
    server_name yourdomain.com;
    
    # SSL证书配置
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    # 增强HTTPS安全
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    
    # 禁用不安全的SSL版本
    ssl_protocols TLSv1.2 TLSv1.3;
    
    # 安全的加密套件
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    
    location / {
        # HTTPS专用安全头
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        proxy_pass http://backend;
    }
}
```

---

## 6. 📏 请求限制与防护


### 6.1 为什么需要请求限制


**🌊 DDoS攻击的危害**
```
正常情况：
每秒10个用户访问 → 服务器轻松处理

DDoS攻击：
每秒10000个恶意请求 → 服务器瘫痪
├── 正常用户无法访问
├── 服务器资源耗尽
└── 可能导致系统崩溃
```

### 6.2 基础限流配置


**⏱️ 请求频率限制**

```nginx
# 在http块中定义限流区域
http {
    # 定义限流规则：每个IP每秒最多10个请求
    limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;
    
    # 定义严格限流：每个IP每秒最多2个请求
    limit_req_zone $binary_remote_addr zone=strict:10m rate=2r/s;
}

server {
    # 一般页面限流
    location / {
        limit_req zone=general burst=20 nodelay;
        proxy_pass http://backend;
    }
    
    # 登录页面严格限流
    location /login {
        limit_req zone=strict burst=5 nodelay;
        proxy_pass http://backend;
    }
}
```

**📝 参数说明**：
- `rate=10r/s`：每秒允许10个请求
- `burst=20`：突发请求缓冲区大小
- `nodelay`：超出限制立即返回错误

### 6.3 连接数限制


**🔌 并发连接控制**

```nginx
http {
    # 限制每个IP的并发连接数
    limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:10m;
    
    # 限制每个server的总连接数
    limit_conn_zone $server_name zone=conn_limit_per_server:10m;
}

server {
    # 每个IP最多10个并发连接
    limit_conn conn_limit_per_ip 10;
    
    # 服务器总连接数限制
    limit_conn conn_limit_per_server 1000;
    
    location / {
        proxy_pass http://backend;
    }
}
```

### 6.4 请求大小限制


**📦 防止大文件攻击**

```nginx
server {
    # 限制请求体大小为10MB
    client_max_body_size 10M;
    
    # 限制请求头大小
    client_header_buffer_size 1k;
    large_client_header_buffers 4 8k;
    
    location /upload {
        # 上传接口允许更大的文件
        client_max_body_size 100M;
        proxy_pass http://backend;
    }
    
    location /api {
        # API接口限制较小的请求体
        client_max_body_size 1M;
        proxy_pass http://backend;
    }
}
```

### 6.5 智能限流策略


**🧠 基于请求特征的智能限流**

```nginx
# 根据不同条件设置不同的限流key
map $request_uri $limit_key {
    default                    $binary_remote_addr;
    ~*/api/                    $binary_remote_addr$request_uri;
    ~*/search                  $binary_remote_addr$args;
}

# 定义限流区域
limit_req_zone $limit_key zone=smart_limit:10m rate=5r/s;

location / {
    # 使用智能限流
    limit_req zone=smart_limit burst=10 nodelay;
    
    # 限流时返回友好提示
    error_page 429 = @rate_limit;
    
    proxy_pass http://backend;
}

# 限流提示页面
location @rate_limit {
    return 429 '{"error":"请求过于频繁，请稍后再试","code":429}';
    add_header Content-Type application/json;
}
```

### 6.6 地理位置访问控制


**🌍 基于地区的访问限制**

```nginx
# 需要安装GeoIP模块
http {
    # 根据国家代码设置访问控制
    map $geoip_country_code $allowed_country {
        default no;
        CN yes;     # 允许中国
        US yes;     # 允许美国
        JP yes;     # 允许日本
    }
}

server {
    location / {
        # 检查地理位置
        if ($allowed_country = no) {
            return 403 "Access denied from your location";
        }
        
        proxy_pass http://backend;
    }
}
```

---

## 7. 📋 核心要点总结


### 7.1 必须掌握的安全配置


```
🔸 基础防护：防盗链、版本隐藏、请求限制
🔸 攻击防护：SQL注入过滤、XSS防护、恶意爬虫拦截
🔸 安全加固：安全响应头、HTTPS强化、错误页面定制
🔸 监控记录：攻击日志、访问统计、异常告警
```

### 7.2 安全配置最佳实践


**🎯 配置原则**
```
分层防护：
• Nginx前端过滤 + 应用层验证 + 数据库权限控制

适度原则：
• 不要过度限制影响正常用户体验
• 根据业务特点调整安全策略

监控预警：
• 记录所有安全事件
• 设置异常访问告警
• 定期分析攻击趋势
```

**⚡ 快速安全检查清单**

✅ **基础安全检查**
- [ ] 已隐藏Nginx版本号
- [ ] 已配置防盗链保护
- [ ] 已设置请求大小限制
- [ ] 已启用基础限流保护

✅ **高级安全检查** 
- [ ] 已配置安全响应头
- [ ] 已设置SQL注入过滤
- [ ] 已配置XSS攻击防护
- [ ] 已启用访问日志记录

✅ **HTTPS安全检查**
- [ ] 已强制HTTPS访问
- [ ] 已配置安全SSL协议
- [ ] 已设置HSTS安全头
- [ ] 已隐藏服务器详细信息

### 7.3 实际应用价值


**💼 业务场景应用**
- **电商网站**：防止恶意爬取商品信息，保护用户数据
- **API服务**：限制调用频率，防止接口被滥用
- **内容网站**：防止图片盗链，节省带宽成本
- **企业应用**：提升整体安全等级，满足合规要求

**🔧 运维实践价值**
- **成本节约**：减少因攻击导致的损失
- **性能保障**：防止恶意请求影响正常服务
- **合规达标**：满足安全审计要求
- **声誉保护**：避免安全事件影响品牌形象

**💡 学习记忆技巧**
```
安全防护记忆口诀：
"防盗链，限请求，隐版本，加安全头"
├── 防盗链：valid_referers + 白名单
├── 限请求：limit_req + limit_conn  
├── 隐版本：server_tokens off
└── 安全头：X-Frame-Options等

核心思想：
"预防为主，监控为辅，分层防护，适度配置"
```