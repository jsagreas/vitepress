---
title: 2、定时任务
---
## 📚 目录

1. [定时任务基本概念](#1-定时任务基本概念)
2. [crontab基础操作](#2-crontab基础操作)
3. [cron时间格式详解](#3-cron时间格式详解)
4. [用户cron与系统cron](#4-用户cron与系统cron)
5. [cron环境变量](#5-cron环境变量)
6. [at一次性任务](#6-at一次性任务)
7. [anacron系统级定时任务](#7-anacron系统级定时任务)
8. [定时任务最佳实践](#8-定时任务最佳实践)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🕒 定时任务基本概念


### 1.1 什么是定时任务


**定时任务**就是让系统在指定的时间自动执行某些命令或脚本，就像给系统设定闹钟一样。

```
现实生活中的定时器：        Linux中的定时任务：
每天早上7点闹钟响    →     每天7点备份数据库
每周一发周报         →     每周一清理日志文件
每月1号交房租        →     每月1号生成报表
```

### 1.2 定时任务的作用


**🎯 主要用途**：
- **定期备份**：数据库备份、文件备份
- **系统维护**：清理临时文件、轮转日志
- **监控检查**：检查系统状态、磁盘空间
- **定期报告**：生成统计报表、发送邮件

### 1.3 Linux定时任务的类型


```
┌─────────────────────┐
│      定时任务类型    │
├─────────────────────┤
│  cron (重复执行)    │ ← 每天、每周、每月重复
├─────────────────────┤
│  at (一次性执行)    │ ← 只在指定时间执行一次
├─────────────────────┤
│  anacron (补偿执行) │ ← 系统关机时错过的任务
└─────────────────────┘
```

---

## 2. ⚙️ crontab基础操作


### 2.1 crontab是什么


**crontab**是"cron table"的缩写，就是定时任务的配置表。每个用户都有自己的crontab文件，用来存放个人的定时任务。

### 2.2 crontab基本命令


| 命令 | **作用** | **使用场景** |
|------|---------|-------------|
| `crontab -e` | **编辑**当前用户的定时任务 | `添加新任务或修改现有任务` |
| `crontab -l` | **查看**当前用户的定时任务 | `检查已设置的任务` |
| `crontab -r` | **删除**当前用户的所有定时任务 | `⚠️ 清空所有任务(谨慎使用)` |
| `crontab -u user -e` | **编辑**指定用户的定时任务 | `管理员管理其他用户任务` |

### 2.3 第一个定时任务示例


让我们创建一个简单的定时任务：每分钟在文件中记录当前时间

```bash
# 编辑定时任务
crontab -e

# 在编辑器中添加以下内容：
* * * * * echo "当前时间: $(date)" >> /tmp/time.log

# 保存退出后查看任务
crontab -l
```

> 💡 **新手提示**  
> 第一次运行`crontab -e`时，系统会让你选择编辑器(vi、nano等)。推荐新手选择nano，更容易操作。

---

## 3. 📅 cron时间格式详解


### 3.1 基本格式结构


cron时间格式由5个字段组成，用空格分隔：

```
┌─────────── 分钟 (0-59)
│ ┌───────── 小时 (0-23)
│ │ ┌─────── 日 (1-31)
│ │ │ ┌───── 月 (1-12)
│ │ │ │ ┌─── 星期几 (0-7, 0和7都表示周日)
│ │ │ │ │
* * * * * 要执行的命令
```

### 3.2 时间字段详解


| 字段 | **取值范围** | **含义** | **示例** |
|------|-------------|---------|---------|
| **分钟** | `0-59` | 第几分钟执行 | `30表示30分时执行` |
| **小时** | `0-23` | 第几小时执行 | `14表示下午2点执行` |
| **日** | `1-31` | 每月第几天执行 | `15表示每月15号执行` |
| **月** | `1-12` | 第几个月执行 | `6表示6月份执行` |
| **星期** | `0-7` | 星期几执行 | `1表示周一执行` |

### 3.3 特殊符号说明


**🔸 基本通配符**

| 符号 | **含义** | **示例** | **解释** |
|------|---------|---------|---------|
| `*` | 任意值 | `* * * * *` | `每分钟执行` |
| `,` | 列举多个值 | `0 8,12,18 * * *` | `每天8点、12点、18点执行` |
| `-` | 范围 | `0 9-17 * * *` | `每天9点到17点的整点执行` |
| `/` | 间隔 | `*/5 * * * *` | `每5分钟执行一次` |

**🔸 实用示例**

```bash
# 每天早上8点30分执行
30 8 * * *

# 每周一到周五的上午9点执行
0 9 * * 1-5

# 每隔2小时执行一次
0 */2 * * *

# 每月1号和15号的凌晨2点执行
0 2 1,15 * *

# 每年6月15日上午10点执行
0 10 15 6 *
```

### 3.4 特殊时间表达式


**🎯 快捷表达式**

| 表达式 | **等价写法** | **含义** |
|--------|-------------|---------|
| `@reboot` | - | `系统启动时执行` |
| `@yearly` | `0 0 1 1 *` | `每年1月1日执行` |
| `@monthly` | `0 0 1 * *` | `每月1号执行` |
| `@weekly` | `0 0 * * 0` | `每周日执行` |
| `@daily` | `0 0 * * *` | `每天午夜执行` |
| `@hourly` | `0 * * * *` | `每小时执行` |

```bash
# 系统启动时启动某个服务
@reboot /path/to/start_service.sh

# 每天午夜备份数据
@daily /home/user/backup.sh
```

---

## 4. 👥 用户cron与系统cron


### 4.1 用户级cron


**用户cron**是每个普通用户设置的个人定时任务。

**📂 存储位置**：`/var/spool/cron/crontabs/用户名`

```bash
# 普通用户设置自己的定时任务
crontab -e

# 示例：每天备份自己的文档
0 2 * * * tar -czf /backup/documents_$(date +\%Y\%m\%d).tar.gz /home/user/Documents
```

### 4.2 系统级cron


**系统cron**是管理员设置的系统级定时任务，影响整个系统。

**📂 主要配置文件**：
- `/etc/crontab` - 系统主配置文件
- `/etc/cron.d/` - 独立的系统任务文件
- `/etc/cron.daily/` - 每天执行的脚本
- `/etc/cron.weekly/` - 每周执行的脚本
- `/etc/cron.monthly/` - 每月执行的脚本

### 4.3 系统cron文件结构


系统级cron比用户cron多了一个**用户字段**：

```bash
# 查看系统主配置文件
cat /etc/crontab

# 内容示例：
# 分 时 日 月 周 用户 命令
17 *    * * *   root    cd / && run-parts --report /etc/cron.hourly
25 6    * * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.daily )
47 6    * * 7   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.weekly )
52 6    1 * *   root    test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.monthly )
```

### 4.4 /etc/cron.d/ 目录


这个目录存放独立的系统级cron文件，适合软件包安装时添加定时任务：

```bash
# 创建系统级定时任务文件
sudo vim /etc/cron.d/system-backup

# 文件内容：
# 每天凌晨3点以root用户执行系统备份
0 3 * * * root /usr/local/bin/system-backup.sh
```

---

## 5. 🌍 cron环境变量


### 5.1 为什么需要了解cron环境


cron执行时的环境和你登录shell时的环境**完全不同**，这是新手最容易遇到的问题。

```
登录shell环境：          cron执行环境：
PATH=/usr/local/bin...  PATH=/usr/bin:/bin
HOME=/home/user         HOME=/home/user
SHELL=/bin/bash         SHELL=/bin/sh
所有环境变量完整         只有基本环境变量
```

### 5.2 常见的cron环境问题


**❌ 常见错误**：
- 脚本在命令行能运行，cron执行失败
- 找不到命令（command not found）
- 相对路径无法找到文件

```bash
# 这个在命令行正常，但cron可能失败
0 8 * * * python3 backup.py

# 原因：cron不知道python3在哪里，不知道backup.py在哪里
```

### 5.3 设置cron环境变量


**🔧 解决方案1：在crontab中设置环境变量**

```bash
crontab -e

# 在任务前面设置环境变量
PATH=/usr/local/bin:/usr/bin:/bin
HOME=/home/user
SHELL=/bin/bash

# 然后设置任务
0 8 * * * cd /home/user/scripts && python3 backup.py >> /var/log/backup.log 2>&1
```

**🔧 解决方案2：使用绝对路径**

```bash
# 使用命令和文件的完整路径
0 8 * * * /usr/bin/python3 /home/user/scripts/backup.py >> /var/log/backup.log 2>&1
```

**🔧 解决方案3：脚本中设置环境**

```bash
#!/bin/bash
# backup.sh

# 设置环境
export PATH=/usr/local/bin:/usr/bin:/bin
export HOME=/home/user

# 切换到脚本目录
cd "$(dirname "$0")"

# 执行实际工作
python3 backup.py
```

### 5.4 cron环境变量最佳实践


- [x] **使用绝对路径**：命令和文件都用完整路径
- [x] **设置PATH变量**：确保能找到所需命令
- [x] **重定向输出**：记录执行日志和错误信息
- [x] **测试脚本**：先在命令行用`/bin/sh`测试脚本

---

## 6. ⏰ at一次性任务


### 6.1 at命令简介


**at命令**用于安排一次性任务，不像cron会重复执行。就像设定一个单次闹钟。

### 6.2 at基本用法


```bash
# 基本语法
at [时间] [日期]

# 常用时间格式
at 14:30                    # 今天下午2点30分
at 2:30 PM                  # 今天下午2点30分
at now + 5 minutes          # 5分钟后
at now + 2 hours            # 2小时后
at tomorrow                 # 明天同一时间
at 10:00 AM tomorrow        # 明天上午10点
at 15:30 2024-12-25         # 指定日期和时间
```

### 6.3 at任务管理


```bash
# 查看待执行的at任务
atq

# 删除指定的at任务（任务号从atq获得）
atrm 任务号

# 查看具体任务内容
at -c 任务号
```

### 6.4 at实用示例


**示例1：临时关机**

```bash
# 30分钟后自动关机
echo "shutdown -h now" | at now + 30 minutes
```

**示例2：定时发送邮件提醒**

```bash
# 明天上午9点发送邮件提醒
at 9:00 AM tomorrow << EOF
echo "别忘了今天的重要会议！" | mail -s "会议提醒" user@example.com
EOF
```

**示例3：临时备份**

```bash
# 2小时后执行备份
at now + 2 hours << EOF
cd /home/user
tar -czf backup_$(date +%Y%m%d_%H%M).tar.gz Documents
EOF
```

---

## 7. 🔄 anacron系统级定时任务


### 7.1 anacron的作用


**anacron**是"anachronistic cron"的缩写，专门处理系统**不是24小时运行**的情况。

```
问题场景：
笔记本电脑设置了每天凌晨2点备份
但经常晚上关机，错过了备份时间

anacron解决方案：
系统开机后检查，如果昨天的备份没执行
会自动补充执行错过的任务
```

### 7.2 anacron配置文件


**📂 主配置文件**：`/etc/anacrontab`

```bash
# 查看anacron配置
cat /etc/anacrontab

# 典型内容：
SHELL=/bin/sh
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

# 格式：周期(天) 延迟(分钟) 任务名称 命令
1       5       cron.daily      run-parts /etc/cron.daily
7       10      cron.weekly     run-parts /etc/cron.weekly  
30      15      cron.monthly    run-parts /etc/cron.monthly
```

### 7.3 anacron字段说明


| 字段 | **含义** | **示例说明** |
|------|---------|-------------|
| **周期** | 多少天执行一次 | `1表示每天，7表示每周` |
| **延迟** | 系统启动后延迟多少分钟执行 | `5表示开机5分钟后执行` |
| **任务名称** | 任务标识符 | `用于跟踪任务执行状态` |
| **命令** | 要执行的命令 | `实际执行的脚本或命令` |

### 7.4 anacron实用场景


**🎯 适用场景**：
- 笔记本电脑和个人工作站
- 经常关机的开发环境
- 虚拟机环境
- 任何非24小时运行的系统

**❌ 不适用场景**：
- 24小时运行的服务器
- 需要精确时间执行的任务
- 实时性要求高的任务

---

## 8. 🎯 定时任务最佳实践


### 8.1 脚本编写最佳实践


**✅ 脚本结构规范**

```bash
#!/bin/bash
# 数据库备份脚本示例

# 设置错误时立即退出
set -e

# 设置变量
BACKUP_DIR="/backup/database"
DATE=$(date +%Y%m%d_%H%M%S)
LOG_FILE="/var/log/db_backup.log"

# 创建备份目录
mkdir -p "$BACKUP_DIR"

# 记录开始时间
echo "$(date): 开始数据库备份" >> "$LOG_FILE"

# 执行备份
mysqldump -u backup_user -p'password' mydb > "$BACKUP_DIR/mydb_$DATE.sql"

# 记录完成时间
echo "$(date): 数据库备份完成 - $BACKUP_DIR/mydb_$DATE.sql" >> "$LOG_FILE"
```

### 8.2 错误处理和日志记录


**📝 日志记录技巧**

```bash
# crontab中重定向日志
0 2 * * * /path/to/backup.sh >> /var/log/backup.log 2>&1

# 脚本内部日志函数
log_message() {
    echo "$(date '+%Y-%m-%d %H:%M:%S'): $1" >> "$LOG_FILE"
}

# 使用示例
log_message "备份开始"
log_message "备份完成"
log_message "错误：磁盘空间不足"
```

### 8.3 任务监控和告警


**🔔 简单的邮件告警**

```bash
#!/bin/bash
# 带告警的备份脚本

BACKUP_DIR="/backup"
ALERT_EMAIL="admin@example.com"

if ! mysqldump -u backup_user -p'password' mydb > "$BACKUP_DIR/backup.sql"; then
    echo "数据库备份失败！时间：$(date)" | mail -s "备份失败告警" "$ALERT_EMAIL"
    exit 1
fi

echo "数据库备份成功！时间：$(date)" | mail -s "备份成功" "$ALERT_EMAIL"
```

### 8.4 定时任务安全建议


- [x] **权限控制**：使用最小必要权限
- [x] **路径安全**：避免使用相对路径
- [x] **密码安全**：不在脚本中硬编码密码
- [x] **日志轮转**：定期清理日志文件

```bash
# 使用环境变量存储敏感信息
export DB_PASSWORD="your_password"

# 脚本中使用
mysqldump -u backup_user -p"$DB_PASSWORD" mydb > backup.sql
```

### 8.5 常用的定时任务模板


**🔧 系统维护任务**

```bash
# 每天凌晨清理临时文件
0 2 * * * find /tmp -type f -mtime +7 -delete

# 每周日备份重要目录
0 3 * * 0 tar -czf /backup/home_$(date +\%Y\%m\%d).tar.gz /home

# 每月1号清理老旧日志
0 4 1 * * find /var/log -name "*.log" -mtime +30 -delete
```

**📊 监控检查任务**

```bash
# 每5分钟检查磁盘空间
*/5 * * * * df -h | awk '$5 > "80%" {print $0}' | mail -s "磁盘空间告警" admin@example.com

# 每小时检查服务状态
0 * * * * systemctl is-active apache2 || systemctl restart apache2
```

### 8.6 调试定时任务


**🔍 调试技巧**

1. **先在命令行测试**：
```bash
# 使用sh直接执行，模拟cron环境
/bin/sh /path/to/your/script.sh
```

2. **增加详细日志**：
```bash
# 在crontab中添加详细重定向
* * * * * /path/to/script.sh >> /var/log/cron_debug.log 2>&1
```

3. **检查cron服务状态**：
```bash
# 检查cron服务是否运行
systemctl status cron

# 查看cron系统日志
grep CRON /var/log/syslog
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的核心概念


```
🔸 crontab：用户定时任务配置工具，每个用户都有独立的任务表
🔸 cron格式：分时日月周五个字段，决定任务执行时间
🔸 系统cron：/etc/crontab和/etc/cron.d/目录下的系统级任务
🔸 环境变量：cron执行环境与登录shell不同，需要特别注意
🔸 at命令：一次性任务调度，适合临时性任务
🔸 anacron：补偿执行机制，适合非24小时运行的系统
```

### 9.2 关键理解要点


**🔹 时间格式记忆方法**
```
记忆口诀：分时日月周
* * * * * 从左到右：越来越大的时间单位
分钟 < 小时 < 日期 < 月份 < 星期
```

**🔹 用户cron vs 系统cron**
```
用户cron：
- crontab -e 编辑
- 只影响当前用户
- 5个字段：时间 + 命令

系统cron：
- 编辑 /etc/crontab 或 /etc/cron.d/
- 影响整个系统
- 6个字段：时间 + 用户 + 命令
```

**🔹 环境变量问题**
```
问题根源：cron执行环境简化
解决思路：
1. 使用绝对路径
2. 在crontab中设置环境变量
3. 脚本中重新设置环境
```

### 9.3 实际应用指导


**🎯 任务分类选择**
- **重复性任务** → 使用 cron
- **一次性任务** → 使用 at
- **关机补偿任务** → 使用 anacron

**🔧 最佳实践要点**
- 使用绝对路径避免找不到命令
- 重定向输出记录执行日志
- 设置错误处理和告警机制
- 定期检查和清理日志文件

**⚠️ 常见陷阱避免**
- 不要忽视环境变量问题
- 不要使用`crontab -r`轻易删除所有任务
- 不要在脚本中硬编码敏感信息
- 不要忘记测试脚本的可执行权限

### 9.4 学习进阶路径


- [x] **基础掌握**：crontab基本操作和时间格式
- [x] **环境理解**：解决cron执行环境问题
- [x] **脚本编写**：编写健壮的定时任务脚本
- [ ] **监控告警**：实现任务执行状态监控
- [ ] **高级应用**：集群环境下的定时任务管理

> 💡 **学习建议**  
> 定时任务是系统管理的重要技能，建议从简单的文件备份任务开始练习，逐步掌握复杂的系统维护任务。记住：**先测试，再部署，多记录日志**！

**核心记忆口诀**：
- 定时任务三兄弟：cron重复，at一次，anacron补偿
- 时间格式分时日月周，环境变量要记住
- 绝对路径加日志，错误处理不能少