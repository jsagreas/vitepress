---
title: 4ã€æœ€ä½³å®è·µ
---
## ğŸ“š ç›®å½•

1. [Shellè„šæœ¬æœ€ä½³å®è·µæ¦‚è¿°](#1-Shellè„šæœ¬æœ€ä½³å®è·µæ¦‚è¿°)
2. [ä»£ç é£æ ¼è§„èŒƒ](#2-ä»£ç é£æ ¼è§„èŒƒ)
3. [é”™è¯¯å¤„ç†æ ‡å‡†](#3-é”™è¯¯å¤„ç†æ ‡å‡†)
4. [æ–‡æ¡£å’Œæ³¨é‡Šè§„èŒƒ](#4-æ–‡æ¡£å’Œæ³¨é‡Šè§„èŒƒ)
5. [Shellè„šæœ¬é‡æ„æŠ€å·§](#5-Shellè„šæœ¬é‡æ„æŠ€å·§)
6. [ä»£ç å¤ç”¨å’Œåº“ç®¡ç†](#6-ä»£ç å¤ç”¨å’Œåº“ç®¡ç†)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ“‹ Shellè„šæœ¬æœ€ä½³å®è·µæ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯Shellè„šæœ¬æœ€ä½³å®è·µ


**ğŸ¯ æ ¸å¿ƒå®šä¹‰**
```
Shellè„šæœ¬æœ€ä½³å®è·µï¼šç»è¿‡å®æˆ˜éªŒè¯çš„ç¼–ç¨‹è§„èŒƒå’ŒæŠ€å·§é›†åˆ
ç›®æ ‡ï¼šæé«˜è„šæœ¬è´¨é‡ã€å¯ç»´æŠ¤æ€§ã€å¯è¯»æ€§å’Œå¥å£®æ€§
æœ¬è´¨ï¼šå°†é›¶æ•£çš„ç¼–ç¨‹ç»éªŒç³»ç»ŸåŒ–ã€æ ‡å‡†åŒ–
```

ğŸ’¡ **é€šä¿—ç†è§£**ï¼šå°±åƒåšèœæœ‰æ ‡å‡†é£Ÿè°±ä¸€æ ·ï¼Œå†™Shellè„šæœ¬ä¹Ÿæœ‰ä¸€å¥—"æ ‡å‡†åšæ³•"ï¼Œéµå¾ªè¿™äº›åšæ³•èƒ½è®©ä½ çš„è„šæœ¬æ›´ä¸“ä¸šã€æ›´å¯é ã€‚

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦æœ€ä½³å®è·µ


**ğŸ” å®é™…ç—›ç‚¹åˆ†æ**
```
æ²¡æœ‰è§„èŒƒçš„è„šæœ¬é—®é¢˜ï¼š
â€¢ åŠå¹´åè‡ªå·±éƒ½çœ‹ä¸æ‡‚
â€¢ å‡ºé”™æ—¶éš¾ä»¥å®šä½é—®é¢˜
â€¢ å¤šäººåä½œæ—¶é£æ ¼ä¸ç»Ÿä¸€
â€¢ è„šæœ¬åœ¨ä¸åŒç¯å¢ƒä¸‹è¡¨ç°ä¸ä¸€è‡´
â€¢ ç»´æŠ¤æˆæœ¬è¶Šæ¥è¶Šé«˜
```

**âœ… æœ€ä½³å®è·µçš„ä»·å€¼**
- **å¯è¯»æ€§æå‡**ï¼šä»£ç è‡ªæ³¨é‡Šï¼Œä¸€ç›®äº†ç„¶
- **ç»´æŠ¤æ€§å¢å¼º**ï¼šç»“æ„æ¸…æ™°ï¼Œæ˜“äºä¿®æ”¹
- **å¥å£®æ€§ä¿éšœ**ï¼šé”™è¯¯å¤„ç†å®Œå–„ï¼Œè¿è¡Œç¨³å®š
- **åä½œæ•ˆç‡**ï¼šç»Ÿä¸€è§„èŒƒï¼Œå›¢é˜Ÿåä½œé¡ºç•…

### 1.3 æœ€ä½³å®è·µçš„æ ¸å¿ƒåŸåˆ™


ğŸ“ **å…­å¤§æ ¸å¿ƒåŸåˆ™**ï¼š

**ğŸ¯ æ¸…æ™°æ€§åŸåˆ™**
```
è®©ä»£ç è¡¨è¾¾æ„å›¾ï¼Œè€Œä¸æ˜¯è®©è¯»è€…çŒœæµ‹
å˜é‡åè¦æœ‰æ„ä¹‰ï¼šuser_count è€Œä¸æ˜¯ uc
å‡½æ•°åè¦æ˜ç¡®ï¼švalidate_email() è€Œä¸æ˜¯ check()
```

**ğŸ›¡ï¸ å¥å£®æ€§åŸåˆ™**  
```
å‡è®¾ä»»ä½•å¯èƒ½å‡ºé”™çš„åœ°æ–¹éƒ½ä¼šå‡ºé”™
æ£€æŸ¥å‘½ä»¤æ‰§è¡Œç»“æœ
éªŒè¯ç”¨æˆ·è¾“å…¥
å¤„ç†å¼‚å¸¸æƒ…å†µ
```

**ğŸ”§ ä¸€è‡´æ€§åŸåˆ™**
```
æ•´ä¸ªé¡¹ç›®ä¿æŒç»Ÿä¸€çš„ä»£ç é£æ ¼
å‘½åè§„èŒƒç»Ÿä¸€
ç¼©è¿›æ ¼å¼ç»Ÿä¸€
é”™è¯¯å¤„ç†æ–¹å¼ç»Ÿä¸€
```

**ğŸ“– å¯ç»´æŠ¤æ€§åŸåˆ™**
```
ä»£ç ç»“æ„æ¸…æ™°ï¼Œæ¨¡å—åŒ–è®¾è®¡
å……åˆ†çš„æ³¨é‡Šå’Œæ–‡æ¡£
é¿å…è¿‡åº¦å¤æ‚çš„é€»è¾‘
ä¿æŒå‡½æ•°èŒè´£å•ä¸€
```

**âš¡ æ•ˆç‡æ€§åŸåˆ™**
```
é€‰æ‹©åˆé€‚çš„å·¥å…·å’Œæ–¹æ³•
é¿å…ä¸å¿…è¦çš„ç³»ç»Ÿè°ƒç”¨
åˆç†ä½¿ç”¨ç¼“å­˜æœºåˆ¶
ä¼˜åŒ–å¾ªç¯å’Œæ¡ä»¶åˆ¤æ–­
```

**ğŸ”„ å¯é‡ç”¨æ€§åŸåˆ™**
```
æå–é€šç”¨åŠŸèƒ½ä¸ºå‡½æ•°æˆ–åº“
å‚æ•°åŒ–é…ç½®
é¿å…ç¡¬ç¼–ç 
è®¾è®¡çµæ´»çš„æ¥å£
```

---

## 2. ğŸ¨ ä»£ç é£æ ¼è§„èŒƒ


### 2.1 è„šæœ¬ç»“æ„æ ‡å‡†


**ğŸ“‹ æ ‡å‡†è„šæœ¬æ¨¡æ¿**

```bash
#!/bin/bash
# 
# è„šæœ¬åç§°ï¼šuser_manager.sh
# åŠŸèƒ½æè¿°ï¼šç”¨æˆ·ç®¡ç†å·¥å…·ï¼Œæ”¯æŒæ·»åŠ ã€åˆ é™¤ã€æŸ¥è¯¢ç”¨æˆ·
# ä½œè€…ï¼šå¼ ä¸‰
# åˆ›å»ºæ—¥æœŸï¼š2024-01-15
# ç‰ˆæœ¬ï¼š1.0
# æœ€åä¿®æ”¹ï¼š2024-01-20
#

# ==================== å…¨å±€é…ç½® ====================
readonly SCRIPT_NAME=$(basename "$0")
readonly SCRIPT_DIR=$(cd "$(dirname "$0")" && pwd)
readonly LOG_FILE="/var/log/${SCRIPT_NAME%.sh}.log"

# ==================== å…¨å±€å˜é‡ ====================
declare -g DEBUG_MODE=false
declare -g VERBOSE_MODE=false

# ==================== å·¥å…·å‡½æ•° ====================
# åœ¨è¿™é‡Œå®šä¹‰é€šç”¨å·¥å…·å‡½æ•°

# ==================== ä¸šåŠ¡å‡½æ•° ====================
# åœ¨è¿™é‡Œå®šä¹‰å…·ä½“ä¸šåŠ¡é€»è¾‘å‡½æ•°

# ==================== ä¸»ç¨‹åº ====================
main() {
    # ä¸»ç¨‹åºé€»è¾‘
}

# è„šæœ¬å…¥å£
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
```

ğŸ”¸ **ç»“æ„è¯´æ˜**ï¼š
- **è„šæœ¬å¤´**ï¼šåŒ…å«åŸºæœ¬ä¿¡æ¯å’Œä½¿ç”¨è¯´æ˜
- **é…ç½®åŒº**ï¼šå®šä¹‰å¸¸é‡å’Œå…¨å±€å˜é‡
- **å‡½æ•°åŒº**ï¼šæŒ‰åŠŸèƒ½åˆ†ç±»ç»„ç»‡å‡½æ•°
- **ä¸»ç¨‹åº**ï¼šå…¥å£é€»è¾‘
- **æ‰§è¡Œæ£€æŸ¥**ï¼šé˜²æ­¢è¢«è¯¯import

### 2.2 å‘½åè§„èŒƒ


**ğŸ“ å˜é‡å‘½åè§„èŒƒ**

| **ç±»å‹** | **è§„èŒƒ** | **ç¤ºä¾‹** | **è¯´æ˜** |
|----------|----------|----------|----------|
| ğŸ”¸ **å±€éƒ¨å˜é‡** | `å°å†™+ä¸‹åˆ’çº¿` | `user_name`, `file_count` | å‡½æ•°å†…éƒ¨ä½¿ç”¨ |
| ğŸ”¸ **å…¨å±€å˜é‡** | `å¤§å†™+ä¸‹åˆ’çº¿` | `USER_HOME`, `MAX_RETRY` | è„šæœ¬çº§åˆ«ä½¿ç”¨ |
| ğŸ”¸ **å¸¸é‡** | `readonly å¤§å†™` | `readonly PI=3.14` | ä¸å¯ä¿®æ”¹çš„å€¼ |
| ğŸ”¸ **ç¯å¢ƒå˜é‡** | `å¤§å†™+ä¸‹åˆ’çº¿` | `PATH`, `HOME` | ç³»ç»Ÿçº§åˆ« |

**ğŸ”§ å‡½æ•°å‘½åè§„èŒƒ**
```bash
# âœ… å¥½çš„å‡½æ•°å‘½å
validate_email_format()     # åŠ¨è¯+åè¯ï¼ŒåŠŸèƒ½æ˜ç¡®
get_user_info()            # è·å–ç±»å‡½æ•°
check_file_exists()        # æ£€æŸ¥ç±»å‡½æ•°
print_error_message()      # è¾“å‡ºç±»å‡½æ•°

# âŒ ä¸å¥½çš„å‡½æ•°å‘½å
do_it()                    # åŠŸèƒ½ä¸æ˜ç¡®
func1()                    # æ²¡æœ‰æ„ä¹‰
check()                    # è¿‡äºç®€å•
```

### 2.3 æ ¼å¼å’Œç¼©è¿›è§„èŒƒ


**ğŸ“ ç¼©è¿›å’Œç©ºæ ¼è§„èŒƒ**
```bash
# âœ… æ ‡å‡†æ ¼å¼
if [[ "$1" == "start" ]]; then
    echo "æ­£åœ¨å¯åŠ¨æœåŠ¡..."
    start_service
elif [[ "$1" == "stop" ]]; then
    echo "æ­£åœ¨åœæ­¢æœåŠ¡..."
    stop_service
else
    echo "ç”¨æ³•: $0 {start|stop}"
    exit 1
fi

# å‡½æ•°å®šä¹‰æ ¼å¼
function_name() {
    local param1="$1"
    local param2="$2"
    
    # å‡½æ•°ä½“ä½¿ç”¨4ä¸ªç©ºæ ¼ç¼©è¿›
    if [[ -n "$param1" ]]; then
        echo "å¤„ç†å‚æ•°: $param1"
    fi
}
```

**ğŸ” ä»£ç å¸ƒå±€è§„èŒƒ**
```bash
# è¿ç®—ç¬¦å‘¨å›´è¦æœ‰ç©ºæ ¼
if [[ $count -gt 10 ]]; then    # âœ… æ­£ç¡®
if [[ $count>10 ]]; then        # âŒ é”™è¯¯

# å‡½æ•°è°ƒç”¨çš„å‚æ•°åˆ†éš”
process_file "$input_file" "$output_file" "$options"

# é•¿å‘½ä»¤çš„æ¢è¡Œ
docker run \
    --name mycontainer \
    --volume /host/path:/container/path \
    --port 8080:80 \
    nginx:latest
```

### 2.4 æ³¨é‡Šé£æ ¼è§„èŒƒ


**ğŸ’¬ æ³¨é‡Šåˆ†ç±»å’Œæ ¼å¼**
```bash
# ==================== åŒºå—æ³¨é‡Š ====================
# ç”¨äºåˆ†å‰²ä»£ç çš„ä¸åŒåŠŸèƒ½åŒºå—

#
# å¤šè¡ŒåŠŸèƒ½æ³¨é‡Š
# è§£é‡Šå¤æ‚é€»è¾‘æˆ–ç®—æ³•
# è¯´æ˜å‡½æ•°çš„ç”¨é€”å’Œå‚æ•°
#
process_data() {
    local input_file="$1"    # è¾“å…¥æ–‡ä»¶è·¯å¾„
    local output_dir="$2"    # è¾“å‡ºç›®å½•
    
    # TODO: æ·»åŠ æ–‡ä»¶æ ¼å¼éªŒè¯
    # FIXME: å¤„ç†ç‰¹æ®Šå­—ç¬¦çš„è½¬ä¹‰é—®é¢˜
    
    echo "å¤„ç†æ–‡ä»¶: $input_file"
}
```

---

## 3. ğŸ›¡ï¸ é”™è¯¯å¤„ç†æ ‡å‡†


### 3.1 é”™è¯¯å¤„ç†çš„é‡è¦æ€§


ğŸ’¡ **ä¸ºä»€ä¹ˆé”™è¯¯å¤„ç†å¦‚æ­¤é‡è¦ï¼Ÿ**

æƒ³è±¡ä¸€ä¸‹ï¼šä½ å†™äº†ä¸€ä¸ªæ•°æ®åº“å¤‡ä»½è„šæœ¬ï¼Œè¿è¡Œäº†å‡ ä¸ªæœˆéƒ½æ²¡é—®é¢˜ã€‚æŸå¤©ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œå¤‡ä»½å¤±è´¥äº†ï¼Œä½†è„šæœ¬æ²¡æœ‰ä»»ä½•æç¤ºå°±ç»“æŸäº†ã€‚ç»“æœæ•°æ®åº“çœŸçš„å‡ºé—®é¢˜æ—¶ï¼Œä½ æ‰å‘ç°å¤‡ä»½æ—©å°±åœæ­¢äº†ï¼

è¿™å°±æ˜¯æ²¡æœ‰é”™è¯¯å¤„ç†çš„ä¸¥é‡åæœã€‚

### 3.2 åŸºç¡€é”™è¯¯å¤„ç†æœºåˆ¶


**ğŸš¨ set æŒ‡ä»¤çš„ä½¿ç”¨**
```bash
#!/bin/bash

# é”™è¯¯å¤„ç†çš„ä¸‰å¤§æ³•å®
set -euo pipefail

# è§£é‡Šï¼š
# -e: ä»»ä½•å‘½ä»¤è¿”å›éé›¶çŠ¶æ€å°±ç«‹å³é€€å‡º
# -u: ä½¿ç”¨æœªå®šä¹‰å˜é‡æ—¶æŠ¥é”™é€€å‡º
# -o pipefail: ç®¡é“ä¸­ä»»ä½•å‘½ä»¤å¤±è´¥éƒ½ä¼šå¯¼è‡´æ•´ä¸ªç®¡é“å¤±è´¥
```

ğŸ”¸ **å®é™…æ•ˆæœå¯¹æ¯”**ï¼š
```bash
# æ²¡æœ‰set -eçš„æƒ…å†µ
rm /nonexistent/file        # å‘½ä»¤å¤±è´¥ä½†è„šæœ¬ç»§ç»­
echo "å¤‡ä»½å®Œæˆ"             # é”™è¯¯ä¿¡æ¯ï¼šå¤‡ä»½å®é™…å¤±è´¥äº†

# æœ‰set -eçš„æƒ…å†µ  
set -e
rm /nonexistent/file        # å‘½ä»¤å¤±è´¥ï¼Œè„šæœ¬ç«‹å³é€€å‡º
echo "å¤‡ä»½å®Œæˆ"             # è¿™è¡Œä¸ä¼šæ‰§è¡Œ
```

### 3.3 ç»“æ„åŒ–é”™è¯¯å¤„ç†


**ğŸ¯ é”™è¯¯å¤„ç†å‡½æ•°æ¨¡æ¿**
```bash
# é”™è¯¯å¤„ç†å·¥å…·å‡½æ•°
error_exit() {
    local message="$1"
    local exit_code="${2:-1}"
    
    echo "âŒ é”™è¯¯: $message" >&2
    echo "ğŸ“ ä½ç½®: ${BASH_SOURCE[2]}:${BASH_LINENO[1]}" >&2
    echo "â° æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" >&2
    
    exit "$exit_code"
}

# è­¦å‘Šå‡½æ•°
warning() {
    local message="$1"
    echo "âš ï¸  è­¦å‘Š: $message" >&2
}

# ä¿¡æ¯è¾“å‡ºå‡½æ•°
info() {
    local message="$1"
    echo "â„¹ï¸  ä¿¡æ¯: $message"
}
```

**ğŸ”§ å®é™…ä½¿ç”¨ç¤ºä¾‹**
```bash
# æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
check_file_exists() {
    local file_path="$1"
    
    if [[ ! -f "$file_path" ]]; then
        error_exit "æ–‡ä»¶ä¸å­˜åœ¨: $file_path"
    fi
    
    if [[ ! -r "$file_path" ]]; then
        error_exit "æ–‡ä»¶ä¸å¯è¯»: $file_path"
    fi
    
    info "æ–‡ä»¶æ£€æŸ¥é€šè¿‡: $file_path"
}

# å®‰å…¨çš„å‘½ä»¤æ‰§è¡Œ
safe_execute() {
    local command="$1"
    local description="$2"
    
    info "æ­£åœ¨æ‰§è¡Œ: $description"
    
    if ! eval "$command"; then
        error_exit "å‘½ä»¤æ‰§è¡Œå¤±è´¥: $description"
    fi
    
    info "æ‰§è¡ŒæˆåŠŸ: $description"
}
```

### 3.4 ä¿¡å·å¤„ç†å’Œæ¸…ç†æœºåˆ¶


**ğŸ§¹ èµ„æºæ¸…ç†æ¨¡å¼**
```bash
# ä¸´æ—¶æ–‡ä»¶æ¸…ç†
readonly TEMP_DIR=$(mktemp -d)
readonly LOCK_FILE="/var/run/${SCRIPT_NAME%.sh}.lock"

# æ¸…ç†å‡½æ•°
cleanup() {
    local exit_code=$?
    
    info "æ­£åœ¨æ¸…ç†èµ„æº..."
    
    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    [[ -d "$TEMP_DIR" ]] && rm -rf "$TEMP_DIR"
    
    # ç§»é™¤é”æ–‡ä»¶
    [[ -f "$LOCK_FILE" ]] && rm -f "$LOCK_FILE"
    
    # ç»“æŸåå°è¿›ç¨‹
    [[ -n "${BG_PID:-}" ]] && kill "$BG_PID" 2>/dev/null
    
    info "èµ„æºæ¸…ç†å®Œæˆ"
    exit $exit_code
}

# æ³¨å†Œæ¸…ç†å‡½æ•°
trap cleanup EXIT INT TERM
```

### 3.5 æ—¥å¿—è®°å½•æœ€ä½³å®è·µ


**ğŸ“ æ—¥å¿—è®°å½•æ ‡å‡†**
```bash
# æ—¥å¿—çº§åˆ«å®šä¹‰
readonly LOG_LEVELS=(DEBUG INFO WARN ERROR FATAL)

# æ—¥å¿—è®°å½•å‡½æ•°
log_message() {
    local level="$1"
    local message="$2"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    # è¾“å‡ºåˆ°æ—¥å¿—æ–‡ä»¶å’Œæ§åˆ¶å°
    echo "[$timestamp] [$level] $message" | tee -a "$LOG_FILE"
}

# ä¾¿æ·çš„æ—¥å¿—å‡½æ•°
log_debug() { [[ "$DEBUG_MODE" == true ]] && log_message "DEBUG" "$1"; }
log_info()  { log_message "INFO" "$1"; }
log_warn()  { log_message "WARN" "$1"; }
log_error() { log_message "ERROR" "$1"; }
log_fatal() { log_message "FATAL" "$1"; error_exit "$1"; }
```

---

## 4. ğŸ“– æ–‡æ¡£å’Œæ³¨é‡Šè§„èŒƒ


### 4.1 è„šæœ¬æ–‡æ¡£åŒ–çš„ä»·å€¼


ğŸ’¡ **æ–‡æ¡£åŒ–çš„é‡è¦æ€§**

å¥½çš„æ–‡æ¡£å°±åƒç»™è„šæœ¬é…äº†ä¸ª"è¯´æ˜ä¹¦"ã€‚6ä¸ªæœˆåå½“ä½ å†æ¬¡æ‰“å¼€è¿™ä¸ªè„šæœ¬æ—¶ï¼Œä½ ä¼šæ„Ÿè°¢å½“åˆå†™æ–‡æ¡£çš„è‡ªå·±ï¼

### 4.2 è„šæœ¬å¤´éƒ¨æ–‡æ¡£æ¨¡æ¿


**ğŸ“‹ æ ‡å‡†æ–‡æ¡£å¤´**
```bash
#!/bin/bash
#
# è„šæœ¬åç§°: database_backup.sh
# åŠŸèƒ½æè¿°: 
#   è‡ªåŠ¨åŒ–æ•°æ®åº“å¤‡ä»½å·¥å…·ï¼Œæ”¯æŒMySQLå’ŒPostgreSQL
#   æä¾›å¢é‡å¤‡ä»½ã€å‹ç¼©ã€è¿œç¨‹å­˜å‚¨ç­‰åŠŸèƒ½
#
# ä½¿ç”¨æ–¹æ³•:
#   ./database_backup.sh [é€‰é¡¹] <æ•°æ®åº“ç±»å‹>
#
# é€‰é¡¹è¯´æ˜:
#   -d, --database    æŒ‡å®šæ•°æ®åº“åç§°
#   -u, --user       æ•°æ®åº“ç”¨æˆ·å
#   -p, --password   æ•°æ®åº“å¯†ç 
#   -o, --output     å¤‡ä»½æ–‡ä»¶è¾“å‡ºç›®å½•
#   -c, --compress   å¯ç”¨å‹ç¼©(å¯é€‰)
#   -r, --remote     è¿œç¨‹å­˜å‚¨åœ°å€(å¯é€‰)
#   -h, --help       æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
#
# ä½¿ç”¨ç¤ºä¾‹:
#   ./database_backup.sh -d mydb -u root -p secret -o /backup
#   ./database_backup.sh --database=mydb --compress --remote=user@server:/backup
#
# ä¾èµ–è¦æ±‚:
#   - bash 4.0+
#   - mysqldump æˆ– pg_dump
#   - gzip (å¦‚æœä½¿ç”¨å‹ç¼©)
#   - rsync (å¦‚æœä½¿ç”¨è¿œç¨‹å­˜å‚¨)
#
# ç¯å¢ƒå˜é‡:
#   DB_PASSWORD     æ•°æ®åº“å¯†ç (å¯é€‰ï¼Œæ›¿ä»£-på‚æ•°)
#   BACKUP_DIR      é»˜è®¤å¤‡ä»½ç›®å½•(å¯é€‰ï¼Œæ›¿ä»£-oå‚æ•°)
#
# ä½œè€…ä¿¡æ¯:
#   ä½œè€…: æå›› <lisi@company.com>
#   åˆ›å»º: 2024-01-15
#   ç‰ˆæœ¬: 2.1.0
#   æ›´æ–°: 2024-03-10
#
# ç‰ˆæœ¬å†å²:
#   2.1.0 - æ·»åŠ PostgreSQLæ”¯æŒ
#   2.0.0 - é‡æ„ä¸ºæ¨¡å—åŒ–æ¶æ„
#   1.5.0 - å¢åŠ è¿œç¨‹å­˜å‚¨åŠŸèƒ½
#   1.0.0 - åˆå§‹ç‰ˆæœ¬
#
```

### 4.3 å‡½æ•°æ–‡æ¡£è§„èŒƒ


**ğŸ”§ å‡½æ•°æ–‡æ¡£æ¨¡æ¿**
```bash
#
# å‡½æ•°åç§°: validate_database_connection
#
# åŠŸèƒ½æè¿°: 
#   éªŒè¯æ•°æ®åº“è¿æ¥æ˜¯å¦æ­£å¸¸ï¼Œæ”¯æŒè¿æ¥è¶…æ—¶æ£€æµ‹
#
# å‚æ•°è¯´æ˜:
#   $1 - æ•°æ®åº“ç±»å‹ (mysql|postgresql)
#   $2 - æ•°æ®åº“ä¸»æœºåœ°å€
#   $3 - æ•°æ®åº“ç«¯å£å·
#   $4 - ç”¨æˆ·å
#   $5 - å¯†ç 
#
# è¿”å›å€¼:
#   0 - è¿æ¥æˆåŠŸ
#   1 - è¿æ¥å¤±è´¥
#   2 - å‚æ•°é”™è¯¯
#
# ä½¿ç”¨ç¤ºä¾‹:
#   if validate_database_connection "mysql" "localhost" "3306" "root" "password"; then
#       echo "æ•°æ®åº“è¿æ¥æ­£å¸¸"
#   fi
#
# æ³¨æ„äº‹é¡¹:
#   - å¯†ç å‚æ•°å¯èƒ½åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼Œéœ€è¦é€‚å½“è½¬ä¹‰
#   - è¿æ¥è¶…æ—¶è®¾ç½®ä¸º30ç§’
#   - å‡½æ•°ä¼šåœ¨æ—¥å¿—ä¸­è®°å½•è¿æ¥å°è¯•ï¼Œä½†ä¸ä¼šè®°å½•å¯†ç 
#
validate_database_connection() {
    local db_type="$1"
    local host="$2" 
    local port="$3"
    local username="$4"
    local password="$5"
    
    # å‚æ•°éªŒè¯
    if [[ $# -ne 5 ]]; then
        log_error "å‚æ•°é”™è¯¯: éœ€è¦5ä¸ªå‚æ•°ï¼Œå®é™…æä¾›äº†$#ä¸ª"
        return 2
    fi
    
    # å…·ä½“å®ç°...
}
```

### 4.4 è¡Œå†…æ³¨é‡Šè§„èŒƒ


**ğŸ’¬ æ³¨é‡Šçš„è‰ºæœ¯**
```bash
# âœ… å¥½çš„æ³¨é‡Šï¼šè§£é‡Šä¸ºä»€ä¹ˆè¿™æ ·åš
# ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶é¿å…åŸæ–‡ä»¶åœ¨å¤„ç†è¿‡ç¨‹ä¸­è¢«ä¿®æ”¹
temp_file=$(mktemp)

# è®¾ç½®è¾ƒé•¿çš„è¶…æ—¶æ—¶é—´ï¼Œå› ä¸ºå¤§æ–‡ä»¶ä¸Šä¼ å¯èƒ½éœ€è¦æ›´å¤šæ—¶é—´
timeout_seconds=300

# æ£€æŸ¥ç£ç›˜ç©ºé—´æ˜¯å¦è¶³å¤Ÿï¼ˆè‡³å°‘éœ€è¦æ–‡ä»¶å¤§å°çš„2å€ç©ºé—´ç”¨äºå¤„ç†ï¼‰
required_space=$((file_size * 2))

# âŒ ä¸å¥½çš„æ³¨é‡Šï¼šåªæ˜¯é‡å¤ä»£ç åšäº†ä»€ä¹ˆ
# åˆ›å»ºä¸´æ—¶æ–‡ä»¶
temp_file=$(mktemp)

# è®¾ç½®è¶…æ—¶ä¸º300ç§’
timeout_seconds=300

# è®¡ç®—æ‰€éœ€ç©ºé—´
required_space=$((file_size * 2))
```

**ğŸ¯ æ³¨é‡Šçš„æœ€ä½³å®è·µ**ï¼š

ğŸ“ **æ³¨é‡ŠåŸåˆ™**ï¼š
- **è§£é‡Šæ„å›¾**ï¼Œä¸æ˜¯é‡å¤ä»£ç 
- **è¯´æ˜å¤æ‚é€»è¾‘**çš„æ€è·¯
- **æ ‡è®°ä¸´æ—¶è§£å†³æ–¹æ¡ˆ**ï¼ˆTODOã€FIXMEï¼‰
- **è®°å½•é‡è¦çš„é…ç½®å†³ç­–**

```bash
# TODO: è€ƒè™‘ä½¿ç”¨é…ç½®æ–‡ä»¶æ›¿ä»£ç¡¬ç¼–ç çš„å‚æ•°
MAX_CONNECTIONS=100

# FIXME: ä¸´æ—¶è§£å†³æ–¹æ¡ˆï¼Œéœ€è¦ä¼˜åŒ–æ€§èƒ½
# å½“å‰å®ç°åœ¨å¤§æ•°æ®é‡æ—¶å¯èƒ½è¾ƒæ…¢
while read -r line; do
    process_line "$line"
done < "$input_file"

# HACK: ç”±äºç³»ç»Ÿbugï¼Œéœ€è¦ç­‰å¾…æ–‡ä»¶ç³»ç»ŸåŒæ­¥
# å‚è€ƒ: https://bugs.example.com/issue/12345
sleep 1
```

---

## 5. ğŸ”§ Shellè„šæœ¬é‡æ„æŠ€å·§


### 5.1 ä»€ä¹ˆæ˜¯è„šæœ¬é‡æ„


ğŸ’¡ **é‡æ„çš„æœ¬è´¨**

é‡æ„å°±åƒ"è£…ä¿®æˆ¿å­"ä¸€æ ·ï¼Œæˆ¿å­çš„åŠŸèƒ½ä¸å˜ï¼Œä½†å†…éƒ¨ç»“æ„æ›´åˆç†ã€æ›´ç¾è§‚ã€æ›´å®ç”¨ã€‚è„šæœ¬é‡æ„å°±æ˜¯æ”¹å–„ä»£ç å†…éƒ¨ç»“æ„ï¼Œè€Œä¸æ”¹å˜å¤–éƒ¨è¡Œä¸ºã€‚

### 5.2 è¯†åˆ«éœ€è¦é‡æ„çš„ä¿¡å·


**ğŸš¨ é‡æ„ä¿¡å·æ£€æµ‹æ¸…å•**
```
ä»£ç å¼‚å‘³æ£€æµ‹ï¼š
â–¡ å‡½æ•°è¶…è¿‡50è¡Œ
â–¡ ç›¸åŒä»£ç å‡ºç°3æ¬¡ä»¥ä¸Š
â–¡ å˜é‡åè®©äººå›°æƒ‘
â–¡ åµŒå¥—å±‚çº§è¶…è¿‡4å±‚
â–¡ ä¸€ä¸ªå‡½æ•°åšå¤šä»¶äº‹æƒ…
â–¡ ç¡¬ç¼–ç éšå¤„å¯è§
â–¡ é”™è¯¯å¤„ç†ä¸ä¸€è‡´
â–¡ æ²¡æœ‰æ³¨é‡Šæˆ–æ³¨é‡Šè¿‡æ—¶
```

**ğŸ” å®é™…ç¤ºä¾‹ï¼šé‡æ„å‰çš„é—®é¢˜ä»£ç **
```bash
# âŒ é—®é¢˜ä»£ç ï¼šåŠŸèƒ½æ··ä¹±ï¼Œé‡å¤ä»£ç å¤š
backup_files() {
    if [ "$1" = "mysql" ]; then
        if [ ! -d "/backup/mysql" ]; then
            mkdir -p /backup/mysql
        fi
        mysqldump -u root -p$2 mydb > /backup/mysql/backup_$(date +%Y%m%d).sql
        if [ $? -eq 0 ]; then
            echo "MySQL backup success"
            gzip /backup/mysql/backup_$(date +%Y%m%d).sql
        else
            echo "MySQL backup failed"
        fi
    elif [ "$1" = "postgres" ]; then
        if [ ! -d "/backup/postgres" ]; then
            mkdir -p /backup/postgres  
        fi
        pg_dump -U postgres mydb > /backup/postgres/backup_$(date +%Y%m%d).sql
        if [ $? -eq 0 ]; then
            echo "PostgreSQL backup success"
            gzip /backup/postgres/backup_$(date +%Y%m%d).sql
        else
            echo "PostgreSQL backup failed"
        fi
    fi
}
```

### 5.3 é‡æ„æŠ€å·§å’Œæ–¹æ³•


**ğŸ¯ é‡æ„æŠ€å·§ä¸€ï¼šæå–å…¬å…±å‡½æ•°**
```bash
# âœ… é‡æ„åï¼šæå–å…¬å…±é€»è¾‘
create_backup_directory() {
    local backup_type="$1"
    local backup_dir="/backup/$backup_type"
    
    if [[ ! -d "$backup_dir" ]]; then
        mkdir -p "$backup_dir" || error_exit "æ— æ³•åˆ›å»ºå¤‡ä»½ç›®å½•: $backup_dir"
        info "åˆ›å»ºå¤‡ä»½ç›®å½•: $backup_dir"
    fi
    
    echo "$backup_dir"
}

compress_backup_file() {
    local backup_file="$1"
    
    if [[ -f "$backup_file" ]]; then
        gzip "$backup_file" || warning "å‹ç¼©æ–‡ä»¶å¤±è´¥: $backup_file"
        info "å¤‡ä»½æ–‡ä»¶å·²å‹ç¼©: $backup_file.gz"
    fi
}

generate_backup_filename() {
    local backup_dir="$1"
    local prefix="$2"
    local timestamp=$(date '+%Y%m%d_%H%M%S')
    
    echo "$backup_dir/${prefix}_${timestamp}.sql"
}
```

**ğŸ¯ é‡æ„æŠ€å·§äºŒï¼šä¸“é—¨åŒ–å‡½æ•°**
```bash
# æ•°æ®åº“ç‰¹å®šçš„å¤‡ä»½å‡½æ•°
backup_mysql_database() {
    local database="$1"
    local username="$2" 
    local password="$3"
    local backup_dir="$4"
    local backup_file="$5"
    
    info "å¼€å§‹MySQLæ•°æ®åº“å¤‡ä»½: $database"
    
    if mysqldump -u "$username" -p"$password" "$database" > "$backup_file"; then
        info "MySQLå¤‡ä»½æˆåŠŸ: $backup_file"
        return 0
    else
        error_exit "MySQLå¤‡ä»½å¤±è´¥: $database"
    fi
}

backup_postgresql_database() {
    local database="$1"
    local username="$2"
    local backup_file="$3"
    
    info "å¼€å§‹PostgreSQLæ•°æ®åº“å¤‡ä»½: $database"
    
    # ä½¿ç”¨ç¯å¢ƒå˜é‡ä¼ é€’å¯†ç ï¼Œæ›´å®‰å…¨
    if PGPASSWORD="$POSTGRES_PASSWORD" pg_dump -U "$username" "$database" > "$backup_file"; then
        info "PostgreSQLå¤‡ä»½æˆåŠŸ: $backup_file"
        return 0
    else
        error_exit "PostgreSQLå¤‡ä»½å¤±è´¥: $database"
    fi
}
```

**ğŸ¯ é‡æ„æŠ€å·§ä¸‰ï¼šç»Ÿä¸€æ¥å£è®¾è®¡**
```bash
# ç»Ÿä¸€çš„å¤‡ä»½æ¥å£
backup_database() {
    local db_type="$1"
    local database="$2"
    local username="$3"
    local password="$4"
    
    # è¾“å…¥éªŒè¯
    validate_backup_parameters "$db_type" "$database" "$username"
    
    # åˆ›å»ºå¤‡ä»½ç›®å½•
    local backup_dir
    backup_dir=$(create_backup_directory "$db_type")
    
    # ç”Ÿæˆå¤‡ä»½æ–‡ä»¶å
    local backup_file
    backup_file=$(generate_backup_filename "$backup_dir" "$database")
    
    # æ ¹æ®æ•°æ®åº“ç±»å‹æ‰§è¡Œå¤‡ä»½
    case "$db_type" in
        mysql)
            backup_mysql_database "$database" "$username" "$password" "$backup_dir" "$backup_file"
            ;;
        postgresql)
            backup_postgresql_database "$database" "$username" "$backup_file"
            ;;
        *)
            error_exit "ä¸æ”¯æŒçš„æ•°æ®åº“ç±»å‹: $db_type"
            ;;
    esac
    
    # å‹ç¼©å¤‡ä»½æ–‡ä»¶
    compress_backup_file "$backup_file"
    
    info "æ•°æ®åº“å¤‡ä»½å®Œæˆ: $db_type/$database"
}
```

### 5.4 é…ç½®å¤–éƒ¨åŒ–é‡æ„


**ğŸ“‹ é…ç½®æ–‡ä»¶åŒ–é‡æ„**
```bash
# config/backup.conf
# æ•°æ®åº“å¤‡ä»½é…ç½®æ–‡ä»¶

# åŸºç¡€é…ç½®
BACKUP_ROOT_DIR="/data/backup"
BACKUP_RETENTION_DAYS=30
COMPRESS_BACKUPS=true
ENABLE_REMOTE_SYNC=false

# MySQLé…ç½®
MYSQL_HOST="localhost"
MYSQL_PORT=3306
MYSQL_USER="backup_user"
MYSQL_DATABASES="app_db,log_db,user_db"

# PostgreSQLé…ç½®  
POSTGRES_HOST="localhost"
POSTGRES_PORT=5432
POSTGRES_USER="backup_user"
POSTGRES_DATABASES="main_db,analytics_db"

# è¿œç¨‹åŒæ­¥é…ç½®
REMOTE_HOST="backup-server.company.com"
REMOTE_USER="backup"
REMOTE_PATH="/backups"
```

**ğŸ”§ é…ç½®åŠ è½½å‡½æ•°**
```bash
load_configuration() {
    local config_file="${1:-config/backup.conf}"
    
    if [[ ! -f "$config_file" ]]; then
        error_exit "é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $config_file"
    fi
    
    # å®‰å…¨åœ°åŠ è½½é…ç½®æ–‡ä»¶
    while IFS='=' read -r key value; do
        # è·³è¿‡æ³¨é‡Šå’Œç©ºè¡Œ
        [[ "$key" =~ ^[[:space:]]*# ]] && continue
        [[ -z "$key" ]] && continue
        
        # ç§»é™¤å‰åç©ºæ ¼
        key=$(echo "$key" | xargs)
        value=$(echo "$value" | xargs)
        
        # å¯¼å‡ºä¸ºç¯å¢ƒå˜é‡
        export "$key"="$value"
        
    done < "$config_file"
    
    info "é…ç½®æ–‡ä»¶åŠ è½½å®Œæˆ: $config_file"
}
```

### 5.5 æ¨¡å—åŒ–é‡æ„


**ğŸ—ï¸ æ¨¡å—åŒ–ç»“æ„è®¾è®¡**
```
é¡¹ç›®ç»“æ„ï¼š
backup-tool/
â”œâ”€â”€ backup.sh              # ä¸»è„šæœ¬
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ backup.conf        # é…ç½®æ–‡ä»¶
â”‚   â””â”€â”€ databases.list     # æ•°æ®åº“åˆ—è¡¨
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ common.sh          # é€šç”¨å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ database.sh        # æ•°æ®åº“æ“ä½œå‡½æ•°
â”‚   â”œâ”€â”€ storage.sh         # å­˜å‚¨ç®¡ç†å‡½æ•°
â”‚   â””â”€â”€ notification.sh    # é€šçŸ¥åŠŸèƒ½å‡½æ•°
â”œâ”€â”€ logs/                  # æ—¥å¿—ç›®å½•
â””â”€â”€ temp/                  # ä¸´æ—¶æ–‡ä»¶ç›®å½•
```

**ğŸ”— æ¨¡å—åŠ è½½æœºåˆ¶**
```bash
# lib/common.sh - é€šç”¨å·¥å…·åº“
readonly LIB_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# å®‰å…¨çš„åº“åŠ è½½å‡½æ•°
load_library() {
    local lib_name="$1"
    local lib_file="$LIB_DIR/$lib_name.sh"
    
    if [[ ! -f "$lib_file" ]]; then
        echo "é”™è¯¯: æ‰¾ä¸åˆ°åº“æ–‡ä»¶ $lib_file" >&2
        return 1
    fi
    
    if [[ ! -r "$lib_file" ]]; then
        echo "é”™è¯¯: åº“æ–‡ä»¶ä¸å¯è¯» $lib_file" >&2
        return 1
    fi
    
    source "$lib_file"
    echo "å·²åŠ è½½åº“: $lib_name"
}

# æ‰¹é‡åŠ è½½åº“
load_all_libraries() {
    local libraries=("database" "storage" "notification")
    
    for lib in "${libraries[@]}"; do
        load_library "$lib" || error_exit "åŠ è½½åº“å¤±è´¥: $lib"
    done
}
```

---

## 6. ğŸ”„ ä»£ç å¤ç”¨å’Œåº“ç®¡ç†


### 6.1 ä»£ç å¤ç”¨çš„é‡è¦æ€§


ğŸ’¡ **ä¸ºä»€ä¹ˆè¦å¤ç”¨ä»£ç ï¼Ÿ**

æƒ³è±¡ä½ æ˜¯ä¸ªå¨å¸ˆï¼Œæ¯æ¬¡åšèœéƒ½è¦ä»å¤´å¼€å§‹å‡†å¤‡è°ƒæ–™ã€åˆ‡èœã€é…èœã€‚æœ‰ç»éªŒçš„å¨å¸ˆä¼šæå‰å‡†å¤‡å¸¸ç”¨çš„è°ƒæ–™åŒ…ã€åˆ‡å¥½å¸¸ç”¨çš„é…èœã€‚ä»£ç å¤ç”¨å°±æ˜¯è¿™ä¸ªé“ç†â€”â€”æŠŠå¸¸ç”¨çš„åŠŸèƒ½åšæˆ"ä»£ç è°ƒæ–™åŒ…"ï¼Œéœ€è¦æ—¶ç›´æ¥ä½¿ç”¨ã€‚

### 6.2 é€šç”¨å‡½æ•°åº“è®¾è®¡


**ğŸ› ï¸ æ ¸å¿ƒå·¥å…·å‡½æ•°åº“**
```bash
# lib/utils.sh - é€šç”¨å·¥å…·å‡½æ•°åº“

#
# å­—ç¬¦ä¸²å¤„ç†å·¥å…·
#
string_trim() {
    local string="$1"
    echo "$string" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//'
}

string_to_upper() {
    echo "$1" | tr '[:lower:]' '[:upper:]'
}

string_to_lower() {
    echo "$1" | tr '[:upper:]' '[:lower:]'
}

string_contains() {
    local string="$1"
    local substring="$2"
    [[ "$string" =~ $substring ]]
}

#
# æ–‡ä»¶æ“ä½œå·¥å…·
#
file_get_size() {
    local file="$1"
    [[ -f "$file" ]] && stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null
}

file_get_extension() {
    local filename="$1"
    echo "${filename##*.}"
}

file_get_basename() {
    local filepath="$1"
    basename "$filepath"
}

file_backup_with_timestamp() {
    local file="$1"
    local timestamp=$(date '+%Y%m%d_%H%M%S')
    local backup_file="${file}.${timestamp}.bak"
    
    if [[ -f "$file" ]]; then
        cp "$file" "$backup_file"
        echo "$backup_file"
    fi
}

#
# ç½‘ç»œå·¥å…·
#
network_check_port() {
    local host="$1"
    local port="$2"
    local timeout="${3:-5}"
    
    timeout "$timeout" bash -c "</dev/tcp/$host/$port" 2>/dev/null
}

network_get_public_ip() {
    curl -s ifconfig.me || curl -s icanhazip.com || echo "è·å–IPå¤±è´¥"
}

#
# ç³»ç»Ÿä¿¡æ¯å·¥å…·  
#
system_get_memory_usage() {
    free | awk '/^Mem:/ { printf "%.2f", $3/$2 * 100 }'
}

system_get_disk_usage() {
    local path="${1:-/}"
    df "$path" | awk 'NR==2 { printf "%.2f", $5 }' | sed 's/%//'
}

system_get_load_average() {
    uptime | awk -F'load average:' '{ print $2 }' | awk '{ print $1 }' | sed 's/,//'
}
```

### 6.3 é…ç½®ç®¡ç†åº“


**âš™ï¸ é…ç½®ç®¡ç†å·¥å…·**
```bash
# lib/config.sh - é…ç½®ç®¡ç†åº“

# å…¨å±€é…ç½®å­˜å‚¨
declare -A CONFIG_STORE

#
# é…ç½®æ–‡ä»¶åŠ è½½å™¨
#
config_load_file() {
    local config_file="$1"
    
    if [[ ! -f "$config_file" ]]; then
        log_error "é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $config_file"
        return 1
    fi
    
    # è§£æé…ç½®æ–‡ä»¶
    while IFS='=' read -r key value; do
        # è·³è¿‡æ³¨é‡Šå’Œç©ºè¡Œ
        [[ "$key" =~ ^[[:space:]]*# ]] && continue
        [[ -z "$key" ]] && continue
        
        # æ¸…ç†é”®å€¼
        key=$(string_trim "$key")
        value=$(string_trim "$value")
        
        # å»æ‰å€¼çš„å¼•å·
        value=$(echo "$value" | sed 's/^["'\'']\|["'\'']$//g')
        
        # å­˜å‚¨é…ç½®
        CONFIG_STORE["$key"]="$value"
        
    done < "$config_file"
    
    log_info "é…ç½®æ–‡ä»¶åŠ è½½æˆåŠŸ: $config_file"
}

#
# è·å–é…ç½®å€¼
#
config_get() {
    local key="$1"
    local default_value="$2"
    
    if [[ -n "${CONFIG_STORE[$key]:-}" ]]; then
        echo "${CONFIG_STORE[$key]}"
    else
        echo "$default_value"
    fi
}

#
# è®¾ç½®é…ç½®å€¼
#
config_set() {
    local key="$1"
    local value="$2"
    
    CONFIG_STORE["$key"]="$value"
}

#
# æ£€æŸ¥å¿…éœ€çš„é…ç½®é¡¹
#
config_require() {
    local required_keys=("$@")
    local missing_keys=()
    
    for key in "${required_keys[@]}"; do
        if [[ -z "${CONFIG_STORE[$key]:-}" ]]; then
            missing_keys+=("$key")
        fi
    done
    
    if [[ ${#missing_keys[@]} -gt 0 ]]; then
        log_error "ç¼ºå°‘å¿…éœ€çš„é…ç½®é¡¹: ${missing_keys[*]}"
        return 1
    fi
}

#
# æ˜¾ç¤ºæ‰€æœ‰é…ç½®
#
config_show_all() {
    echo "=== å½“å‰é…ç½® ==="
    for key in "${!CONFIG_STORE[@]}"; do
        printf "%-20s = %s\n" "$key" "${CONFIG_STORE[$key]}"
    done | sort
}
```

### 6.4 åº“çš„ç‰ˆæœ¬ç®¡ç†å’Œä¾èµ–


**ğŸ“¦ åº“ç‰ˆæœ¬ç®¡ç†**
```bash
# lib/version.sh - åº“ç‰ˆæœ¬ç®¡ç†

# åº“ç‰ˆæœ¬ä¿¡æ¯
declare -A LIB_VERSIONS=(
    ["utils"]="1.2.0"
    ["config"]="1.0.5" 
    ["database"]="2.1.0"
    ["notification"]="1.1.2"
)

# æœ€ä½è¦æ±‚ç‰ˆæœ¬
declare -A REQUIRED_VERSIONS=(
    ["bash"]="4.0"
    ["curl"]="7.0"
    ["jq"]="1.5"
)

#
# æ£€æŸ¥åº“ç‰ˆæœ¬å…¼å®¹æ€§
#
check_library_version() {
    local lib_name="$1"
    local required_version="$2"
    local current_version="${LIB_VERSIONS[$lib_name]:-0.0.0}"
    
    if version_compare "$current_version" "$required_version"; then
        log_info "åº“ç‰ˆæœ¬æ£€æŸ¥é€šè¿‡: $lib_name ($current_version >= $required_version)"
        return 0
    else
        log_error "åº“ç‰ˆæœ¬ä¸å…¼å®¹: $lib_name (éœ€è¦ >= $required_version, å½“å‰ $current_version)"
        return 1
    fi
}

#
# ç‰ˆæœ¬æ¯”è¾ƒå‡½æ•°
#
version_compare() {
    local version1="$1"
    local version2="$2"
    
    # ä½¿ç”¨sort -Vè¿›è¡Œç‰ˆæœ¬æ¯”è¾ƒ
    local higher_version
    higher_version=$(echo -e "$version1\n$version2" | sort -V | tail -n1)
    
    [[ "$higher_version" == "$version1" ]]
}

#
# æ£€æŸ¥ç³»ç»Ÿä¾èµ–
#
check_system_dependencies() {
    local missing_deps=()
    
    # æ£€æŸ¥bashç‰ˆæœ¬
    local bash_version="${BASH_VERSION%%.*}"
    if ! version_compare "$bash_version" "${REQUIRED_VERSIONS[bash]}"; then
        missing_deps+=("bash >= ${REQUIRED_VERSIONS[bash]}")
    fi
    
    # æ£€æŸ¥å¤–éƒ¨å‘½ä»¤
    for cmd in curl jq; do
        if ! command -v "$cmd" >/dev/null 2>&1; then
            missing_deps+=("$cmd")
        fi
    done
    
    if [[ ${#missing_deps[@]} -gt 0 ]]; then
        log_error "ç¼ºå°‘ç³»ç»Ÿä¾èµ–: ${missing_deps[*]}"
        return 1
    fi
    
    log_info "ç³»ç»Ÿä¾èµ–æ£€æŸ¥é€šè¿‡"
}
```

### 6.5 åº“çš„ä½¿ç”¨ç¤ºä¾‹


**ğŸ¯ å®Œæ•´çš„åº“ä½¿ç”¨ç¤ºä¾‹**
```bash
#!/bin/bash
# example_script.sh - ä½¿ç”¨åº“çš„ç¤ºä¾‹è„šæœ¬

# è®¾ç½®åŸºç¡€è·¯å¾„
readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
readonly LIB_DIR="$SCRIPT_DIR/lib"

# åŠ è½½æ ¸å¿ƒåº“
source "$LIB_DIR/common.sh"
source "$LIB_DIR/utils.sh"
source "$LIB_DIR/config.sh"
source "$LIB_DIR/version.sh"

# ä¸»å‡½æ•°ç¤ºä¾‹
main() {
    log_info "å¼€å§‹æ‰§è¡Œç¤ºä¾‹è„šæœ¬"
    
    # æ£€æŸ¥ç³»ç»Ÿä¾èµ–
    check_system_dependencies || error_exit "ä¾èµ–æ£€æŸ¥å¤±è´¥"
    
    # åŠ è½½é…ç½®
    config_load_file "config/app.conf"
    
    # æ£€æŸ¥å¿…éœ€é…ç½®
    config_require "DATABASE_HOST" "DATABASE_USER" "BACKUP_DIR"
    
    # ä½¿ç”¨å·¥å…·å‡½æ•°
    local server_ip
    server_ip=$(network_get_public_ip)
    log_info "æœåŠ¡å™¨å…¬ç½‘IP: $server_ip"
    
    local memory_usage
    memory_usage=$(system_get_memory_usage)
    log_info "å†…å­˜ä½¿ç”¨ç‡: ${memory_usage}%"
    
    # é…ç½®ä½¿ç”¨ç¤ºä¾‹
    local db_host
    db_host=$(config_get "DATABASE_HOST" "localhost")
    log_info "æ•°æ®åº“ä¸»æœº: $db_host"
    
    # ç½‘ç»œæ£€æŸ¥
    if network_check_port "$db_host" 3306; then
        log_info "æ•°æ®åº“ç«¯å£è¿æ¥æ­£å¸¸"
    else
        log_warn "æ•°æ®åº“ç«¯å£è¿æ¥å¤±è´¥"
    fi
    
    log_info "ç¤ºä¾‹è„šæœ¬æ‰§è¡Œå®Œæˆ"
}

# è„šæœ¬å…¥å£
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æœ€ä½³å®è·µæœ¬è´¨ï¼šç»è¿‡éªŒè¯çš„ç¼–ç¨‹è§„èŒƒå’ŒæŠ€å·§é›†åˆ
ğŸ”¸ å…­å¤§åŸåˆ™ï¼šæ¸…æ™°æ€§ã€å¥å£®æ€§ã€ä¸€è‡´æ€§ã€å¯ç»´æŠ¤æ€§ã€æ•ˆç‡æ€§ã€å¯é‡ç”¨æ€§  
ğŸ”¸ ä»£ç é£æ ¼ï¼šç»Ÿä¸€çš„å‘½åã€æ ¼å¼ã€æ³¨é‡Šè§„èŒƒ
ğŸ”¸ é”™è¯¯å¤„ç†ï¼šé¢„é˜²æ€§è®¾è®¡ï¼Œå®Œå–„çš„å¼‚å¸¸å¤„ç†æœºåˆ¶
ğŸ”¸ æ–‡æ¡£åŒ–ï¼šå®Œæ•´çš„æ–‡æ¡£å’Œæ³¨é‡Šï¼Œä¾¿äºç†è§£å’Œç»´æŠ¤
ğŸ”¸ é‡æ„æ€ç»´ï¼šæŒç»­æ”¹å–„ä»£ç ç»“æ„ï¼Œæå‡ä»£ç è´¨é‡
ğŸ”¸ æ¨¡å—åŒ–ï¼šä»£ç å¤ç”¨ï¼Œåº“ç®¡ç†ï¼Œé™ä½ç»´æŠ¤æˆæœ¬
```

### 7.2 å…³é”®å®è·µè¦ç‚¹


**ğŸ”¹ è„šæœ¬ç»“æ„åŒ–è®¾è®¡**
```
æ ‡å‡†ç»“æ„ï¼š
è„šæœ¬å¤´(è¯´æ˜) â†’ é…ç½®åŒº â†’ å·¥å…·å‡½æ•° â†’ ä¸šåŠ¡å‡½æ•° â†’ ä¸»ç¨‹åº â†’ å…¥å£æ£€æŸ¥

æ¯ä¸ªéƒ¨åˆ†èŒè´£æ˜ç¡®ï¼š
- è„šæœ¬å¤´ï¼šæä¾›ä½¿ç”¨è¯´æ˜å’ŒåŸºæœ¬ä¿¡æ¯
- é…ç½®åŒºï¼šå®šä¹‰å¸¸é‡å’Œå…¨å±€å˜é‡
- å‡½æ•°åŒºï¼šæŒ‰åŠŸèƒ½åˆ†ç±»ç»„ç»‡
- ä¸»ç¨‹åºï¼šæ§åˆ¶æ•´ä½“æµç¨‹
- å…¥å£æ£€æŸ¥ï¼šé˜²æ­¢æ„å¤–å¯¼å…¥
```

**ğŸ”¹ é”™è¯¯å¤„ç†çš„å±‚æ¬¡è®¾è®¡**
```
ä¸‰çº§é”™è¯¯å¤„ç†ï¼š
Level 1: set -euo pipefail (åŸºç¡€ä¿éšœ)
Level 2: å‡½æ•°çº§é”™è¯¯æ£€æŸ¥ (é€»è¾‘ä¿éšœ)  
Level 3: èµ„æºæ¸…ç†æœºåˆ¶ (å…œåº•ä¿éšœ)

å…³é”®ç‚¹ï¼š
- æ¯ä¸ªå¯èƒ½å¤±è´¥çš„æ“ä½œéƒ½è¦æ£€æŸ¥
- æä¾›æœ‰æ„ä¹‰çš„é”™è¯¯ä¿¡æ¯
- ç¡®ä¿èµ„æºæ­£ç¡®é‡Šæ”¾
```

**ğŸ”¹ æ–‡æ¡£åŒ–çš„ä»·å€¼**
```
æ–‡æ¡£åŒ–æŠ•èµ„å›æŠ¥ï¼š
çŸ­æœŸï¼šå¸®åŠ©ç†è§£ä»£ç é€»è¾‘
ä¸­æœŸï¼šé™ä½ç»´æŠ¤æˆæœ¬
é•¿æœŸï¼šçŸ¥è¯†ä¼ æ‰¿ï¼Œå›¢é˜Ÿåä½œ

æ–‡æ¡£åŸåˆ™ï¼š
- è¯´æ˜æ„å›¾è€Œä¸æ˜¯é‡å¤ä»£ç 
- ä¿æŒæ–‡æ¡£ä¸ä»£ç åŒæ­¥
- æä¾›ä½¿ç”¨ç¤ºä¾‹
- æ ‡è®°é‡è¦å†³ç­–å’Œé™åˆ¶
```

### 7.3 å®é™…åº”ç”¨å»ºè®®


**ğŸ’¡ å®è·µå»ºè®®**

ğŸ¯ **æ¸è¿›å¼æ”¹å–„**ï¼š
- ä»æ–°è„šæœ¬å¼€å§‹åº”ç”¨æœ€ä½³å®è·µ
- å¯¹ç°æœ‰è„šæœ¬è¿›è¡Œæ¸è¿›å¼é‡æ„
- å»ºç«‹å›¢é˜Ÿä»£ç è§„èŒƒ
- å®šæœŸè¿›è¡Œä»£ç è¯„å®¡

ğŸ“Š **è´¨é‡åº¦é‡æŒ‡æ ‡**ï¼š
- **å¯è¯»æ€§**ï¼šæ–°äººèƒ½å¦å¿«é€Ÿç†è§£
- **å¥å£®æ€§**ï¼šå¼‚å¸¸æƒ…å†µä¸‹çš„è¡¨ç°
- **å¯ç»´æŠ¤æ€§**ï¼šä¿®æ”¹çš„éš¾æ˜“ç¨‹åº¦
- **å¯é‡ç”¨æ€§**ï¼šåŠŸèƒ½å¤ç”¨çš„ç¨‹åº¦

ğŸ”§ **å·¥å…·è¾…åŠ©**ï¼š
- ä½¿ç”¨shellcheckè¿›è¡Œé™æ€æ£€æŸ¥
- å»ºç«‹ä»£ç æ¨¡æ¿å’Œç”Ÿæˆå™¨
- ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶è·Ÿè¸ªå˜æ›´
- å»ºç«‹è‡ªåŠ¨åŒ–æµ‹è¯•

### 7.4 å­¦ä¹ æ£€æŸ¥æ¸…å•


```
âœ… **åŸºç¡€æŒæ¡æ£€æŸ¥**ï¼š
â–¡ èƒ½ç¼–å†™æ ‡å‡†çš„è„šæœ¬å¤´éƒ¨æ–‡æ¡£
â–¡ æŒæ¡ç»Ÿä¸€çš„å‘½åå’Œæ ¼å¼è§„èŒƒ
â–¡ èƒ½å®ç°å®Œå–„çš„é”™è¯¯å¤„ç†
â–¡ ä¼šå†™æœ‰æ„ä¹‰çš„æ³¨é‡Šå’Œæ–‡æ¡£

âœ… **è¿›é˜¶åº”ç”¨æ£€æŸ¥**ï¼š
â–¡ èƒ½è¯†åˆ«éœ€è¦é‡æ„çš„ä»£ç 
â–¡ æŒæ¡å¸¸è§çš„é‡æ„æŠ€å·§
â–¡ èƒ½è®¾è®¡æ¨¡å—åŒ–çš„è„šæœ¬ç»“æ„
â–¡ ä¼šåˆ›å»ºå’Œç®¡ç†å‡½æ•°åº“

âœ… **é«˜çº§å®è·µæ£€æŸ¥**ï¼š
â–¡ èƒ½åˆ¶å®šå›¢é˜Ÿç¼–ç è§„èŒƒ
â–¡ æŒæ¡ç‰ˆæœ¬ç®¡ç†å’Œä¾èµ–å¤„ç†
â–¡ èƒ½è¿›è¡Œä»£ç è´¨é‡è¯„ä¼°
â–¡ ä¼šæŒç»­æ”¹å–„ç°æœ‰ä»£ç 
```

### 7.5 è®°å¿†è¦ç‚¹


ğŸ§  **æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
"è§„èŒƒå…ˆè¡Œè´¨é‡é«˜ï¼Œé”™è¯¯å¤„ç†ä¸èƒ½å°‘
æ–‡æ¡£æ³¨é‡Šè¦è·Ÿä¸Šï¼Œé‡æ„ä¼˜åŒ–æ˜¯æ³•å®
æ¨¡å—å¤ç”¨ææ•ˆç‡ï¼ŒæŒç»­æ”¹è¿›æœ€é‡è¦"
```

ğŸ”‘ **å…³é”®æ¦‚å¿µé€Ÿè®°**ï¼š
- **æœ€ä½³å®è·µ** = è§„èŒƒ + æŠ€å·§ + ç»éªŒ
- **ä»£ç é£æ ¼** = å‘½å + æ ¼å¼ + æ³¨é‡Š
- **é”™è¯¯å¤„ç†** = é¢„é˜² + æ£€æŸ¥ + æ¸…ç†
- **æ–‡æ¡£åŒ–** = è¯´æ˜ + ç¤ºä¾‹ + ç»´æŠ¤
- **é‡æ„** = æ”¹å–„ç»“æ„ + ä¿æŒåŠŸèƒ½
- **å¤ç”¨** = æå–å…¬å…± + åº“ç®¡ç†

**æ ¸å¿ƒä»·å€¼**ï¼šéµå¾ªæœ€ä½³å®è·µä¸æ˜¯ä¸ºäº†ç‚«æŠ€ï¼Œè€Œæ˜¯ä¸ºäº†å†™å‡ºæ›´å¯é ã€æ›´æ˜“ç»´æŠ¤ã€æ›´ä¸“ä¸šçš„Shellè„šæœ¬ï¼Œè®©ä»£ç æˆä¸ºå›¢é˜Ÿçš„èµ„äº§è€Œä¸æ˜¯è´Ÿæ‹…ã€‚