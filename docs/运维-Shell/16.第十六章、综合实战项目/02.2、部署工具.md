---
title: 2ã€éƒ¨ç½²å·¥å…·
---
## ğŸ“š ç›®å½•

1. [éƒ¨ç½²å·¥å…·æ¦‚è¿°](#1-éƒ¨ç½²å·¥å…·æ¦‚è¿°)
2. [åº”ç”¨éƒ¨ç½²è„šæœ¬è®¾è®¡](#2-åº”ç”¨éƒ¨ç½²è„šæœ¬è®¾è®¡)
3. [ç¯å¢ƒé…ç½®è‡ªåŠ¨åŒ–](#3-ç¯å¢ƒé…ç½®è‡ªåŠ¨åŒ–)
4. [æ‰¹é‡æœåŠ¡å™¨æ“ä½œ](#4-æ‰¹é‡æœåŠ¡å™¨æ“ä½œ)
5. [é…ç½®æ–‡ä»¶ç®¡ç†](#5-é…ç½®æ–‡ä»¶ç®¡ç†)
6. [ç‰ˆæœ¬æ§åˆ¶é›†æˆ](#6-ç‰ˆæœ¬æ§åˆ¶é›†æˆ)
7. [å›æ»šæœºåˆ¶å®ç°](#7-å›æ»šæœºåˆ¶å®ç°)
8. [éƒ¨ç½²æ—¥å¿—ä¸ç›‘æ§](#8-éƒ¨ç½²æ—¥å¿—ä¸ç›‘æ§)
9. [è“ç»¿éƒ¨ç½²å®æˆ˜](#9-è“ç»¿éƒ¨ç½²å®æˆ˜)
10. [å®¹å™¨åŒ–éƒ¨ç½²è„šæœ¬](#10-å®¹å™¨åŒ–éƒ¨ç½²è„šæœ¬)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸš€ éƒ¨ç½²å·¥å…·æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯è‡ªåŠ¨åŒ–éƒ¨ç½²


**ç®€å•ç†è§£**ï¼šæŠŠæ‰‹å·¥éƒ¨ç½²å˜æˆè„šæœ¬è‡ªåŠ¨æ‰§è¡Œï¼Œå°±åƒå·¥å‚æµæ°´çº¿ä¸€æ ·ï¼Œæ ‡å‡†åŒ–ã€å¯é‡å¤ã€ä¸å‡ºé”™ã€‚

```
æ‰‹å·¥éƒ¨ç½²è¿‡ç¨‹ï¼š               è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼š
1. ç™»å½•æœåŠ¡å™¨     â†’         ä¸€é”®æ‰§è¡Œè„šæœ¬
2. ä¸‹è½½ä»£ç       â†’         è‡ªåŠ¨å®Œæˆæ‰€æœ‰æ­¥éª¤
3. ç¼–è¯‘æ„å»º      â†’         å‡å°‘äººä¸ºé”™è¯¯
4. åœæ­¢æœåŠ¡      â†’         æé«˜éƒ¨ç½²æ•ˆç‡
5. æ›¿æ¢æ–‡ä»¶      â†’         ä¾¿äºç‰ˆæœ¬ç®¡ç†
6. å¯åŠ¨æœåŠ¡
7. éªŒè¯ç»“æœ
```

### 1.2 éƒ¨ç½²å·¥å…·çš„æ ¸å¿ƒä»·å€¼


**è§£å†³çš„é—®é¢˜**ï¼š
- **äººå·¥é”™è¯¯**ï¼šæ¶ˆé™¤æ‰‹å·¥æ“ä½œçš„å¤±è¯¯
- **æ•ˆç‡ä½ä¸‹**ï¼šæå‡éƒ¨ç½²é€Ÿåº¦å’Œé¢‘ç‡
- **ç¯å¢ƒä¸ä¸€è‡´**ï¼šä¿è¯å„ç¯å¢ƒéƒ¨ç½²æ ‡å‡†åŒ–
- **å›æ»šå›°éš¾**ï¼šå¿«é€Ÿæ¢å¤åˆ°ä¸Šä¸€ç‰ˆæœ¬

**å¸¦æ¥çš„å¥½å¤„**ï¼š
- ğŸ”„ **ä¸€è‡´æ€§**ï¼šæ¯æ¬¡éƒ¨ç½²éƒ½å®Œå…¨ç›¸åŒ
- âš¡ **é«˜æ•ˆæ€§**ï¼šå‡ åˆ†é’Ÿå®ŒæˆåŸæœ¬éœ€è¦å°æ—¶çš„å·¥ä½œ
- ğŸ”’ **å¯é æ€§**ï¼šå‡å°‘99%çš„äººä¸ºå¤±è¯¯
- ğŸ“Š **å¯è¿½æº¯**ï¼šå®Œæ•´çš„éƒ¨ç½²å†å²è®°å½•

### 1.3 éƒ¨ç½²å·¥å…·çš„ç»„æˆæ¶æ„


```
éƒ¨ç½²å·¥å…·æ¶æ„å›¾ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä»£ç ä»“åº“       â”‚    â”‚   é…ç½®ç®¡ç†       â”‚
â”‚   (Git/SVN)     â”‚    â”‚   (Config)      â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                      â”‚
      v                      v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         éƒ¨ç½²è„šæœ¬å¼•æ“             â”‚
â”‚    (Shell/Python/Ansible)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç›®æ ‡æœåŠ¡å™¨1    â”‚   ç›®æ ‡æœåŠ¡å™¨2      â”‚
â”‚   (Web Server)  â”‚   (App Server)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ğŸ“¦ åº”ç”¨éƒ¨ç½²è„šæœ¬è®¾è®¡


### 2.1 åŸºç¡€éƒ¨ç½²è„šæœ¬ç»“æ„


**æ ¸å¿ƒæ€è·¯**ï¼šæŠŠéƒ¨ç½²è¿‡ç¨‹åˆ†è§£ä¸ºå¯æ§çš„æ­¥éª¤ï¼Œæ¯æ­¥éƒ½æœ‰æ£€æŸ¥å’Œé”™è¯¯å¤„ç†ã€‚

```bash
#!/bin/bash
# åº”ç”¨éƒ¨ç½²ä¸»è„šæœ¬

# é…ç½®ä¿¡æ¯
APP_NAME="myapp"
APP_VERSION="1.0.0"
DEPLOY_DIR="/opt/apps/${APP_NAME}"
BACKUP_DIR="/opt/backup"
LOG_FILE="/var/log/deploy.log"

# æ—¥å¿—å‡½æ•°
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a $LOG_FILE
}

# é”™è¯¯å¤„ç†
handle_error() {
    log "é”™è¯¯: $1"
    exit 1
}

# ä¸»è¦éƒ¨ç½²å‡½æ•°
deploy_app() {
    log "å¼€å§‹éƒ¨ç½² ${APP_NAME} v${APP_VERSION}"
    
    # æ­¥éª¤1: ç¯å¢ƒæ£€æŸ¥
    check_environment || handle_error "ç¯å¢ƒæ£€æŸ¥å¤±è´¥"
    
    # æ­¥éª¤2: å¤‡ä»½å½“å‰ç‰ˆæœ¬
    backup_current || handle_error "å¤‡ä»½å¤±è´¥"
    
    # æ­¥éª¤3: ä¸‹è½½æ–°ç‰ˆæœ¬
    download_app || handle_error "ä¸‹è½½å¤±è´¥"
    
    # æ­¥éª¤4: éƒ¨ç½²æ–°ç‰ˆæœ¬
    install_app || handle_error "å®‰è£…å¤±è´¥"
    
    # æ­¥éª¤5: å¯åŠ¨æœåŠ¡
    start_services || handle_error "å¯åŠ¨å¤±è´¥"
    
    # æ­¥éª¤6: éªŒè¯éƒ¨ç½²
    verify_deployment || handle_error "éªŒè¯å¤±è´¥"
    
    log "éƒ¨ç½²æˆåŠŸå®Œæˆ"
}

# æ‰§è¡Œéƒ¨ç½²
deploy_app
```

### 2.2 ç¯å¢ƒæ£€æŸ¥å‡½æ•°


**ç›®çš„**ï¼šç¡®ä¿éƒ¨ç½²ç¯å¢ƒæ»¡è¶³è¦æ±‚ï¼Œé¿å…éƒ¨ç½²åˆ°ä¸€åŠæ‰å‘ç°é—®é¢˜ã€‚

```bash
check_environment() {
    log "æ­£åœ¨æ£€æŸ¥éƒ¨ç½²ç¯å¢ƒ..."
    
    # æ£€æŸ¥ç£ç›˜ç©ºé—´ (è‡³å°‘éœ€è¦1GB)
    available_space=$(df -m $DEPLOY_DIR | tail -1 | awk '{print $4}')
    if [ $available_space -lt 1024 ]; then
        log "ç£ç›˜ç©ºé—´ä¸è¶³: ${available_space}MB < 1024MB"
        return 1
    fi
    
    # æ£€æŸ¥å¿…è¦çš„å‘½ä»¤
    for cmd in wget unzip systemctl; do
        if ! command -v $cmd &> /dev/null; then
            log "ç¼ºå°‘å¿…è¦å‘½ä»¤: $cmd"
            return 1
        fi
    done
    
    # æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
    if netstat -tlnp | grep -q ":8080 "; then
        log "ç«¯å£8080å·²è¢«å ç”¨"
        return 1
    fi
    
    log "ç¯å¢ƒæ£€æŸ¥é€šè¿‡"
    return 0
}
```

### 2.3 æ™ºèƒ½éƒ¨ç½²ç­–ç•¥


**æ¸è¿›å¼éƒ¨ç½²**ï¼šå…ˆåœä¸€å°æœåŠ¡å™¨ï¼Œéƒ¨ç½²æˆåŠŸåå†éƒ¨ç½²å…¶ä»–æœåŠ¡å™¨ã€‚

```bash
# å¤šæœåŠ¡å™¨æ¸è¿›éƒ¨ç½²
SERVERS=("192.168.1.10" "192.168.1.11" "192.168.1.12")

progressive_deploy() {
    local success_count=0
    
    for server in "${SERVERS[@]}"; do
        log "å¼€å§‹éƒ¨ç½²åˆ°æœåŠ¡å™¨: $server"
        
        if deploy_to_server $server; then
            success_count=$((success_count + 1))
            log "æœåŠ¡å™¨ $server éƒ¨ç½²æˆåŠŸ"
            
            # ç­‰å¾…æœåŠ¡ç¨³å®š
            sleep 30
            
            # å¥åº·æ£€æŸ¥
            if ! health_check $server; then
                log "æœåŠ¡å™¨ $server å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œåœæ­¢éƒ¨ç½²"
                return 1
            fi
        else
            log "æœåŠ¡å™¨ $server éƒ¨ç½²å¤±è´¥ï¼Œåœæ­¢éƒ¨ç½²"
            return 1
        fi
    done
    
    log "æ‰€æœ‰æœåŠ¡å™¨éƒ¨ç½²æˆåŠŸ ($success_count/${#SERVERS[@]})"
}
```

---

## 3. âš™ï¸ ç¯å¢ƒé…ç½®è‡ªåŠ¨åŒ–


### 3.1 ç³»ç»Ÿç¯å¢ƒåˆå§‹åŒ–


**ä»€ä¹ˆæ˜¯ç¯å¢ƒé…ç½®**ï¼šå°±æ˜¯æŠŠä¸€å°æ–°æœåŠ¡å™¨é…ç½®æˆèƒ½è¿è¡Œä½ åº”ç”¨çš„çŠ¶æ€ï¼ŒåŒ…æ‹¬å®‰è£…è½¯ä»¶ã€è®¾ç½®å‚æ•°ç­‰ã€‚

```bash
#!/bin/bash
# ç³»ç»Ÿç¯å¢ƒè‡ªåŠ¨é…ç½®è„šæœ¬

setup_system_environment() {
    log "å¼€å§‹é…ç½®ç³»ç»Ÿç¯å¢ƒ"
    
    # æ›´æ–°ç³»ç»Ÿ
    log "æ›´æ–°ç³»ç»ŸåŒ…..."
    yum update -y || apt-get update -y
    
    # å®‰è£…åŸºç¡€è½¯ä»¶
    install_basic_packages
    
    # é…ç½®é˜²ç«å¢™
    configure_firewall
    
    # ä¼˜åŒ–ç³»ç»Ÿå‚æ•°
    optimize_system_params
    
    # åˆ›å»ºåº”ç”¨ç”¨æˆ·
    create_app_user
    
    log "ç³»ç»Ÿç¯å¢ƒé…ç½®å®Œæˆ"
}

install_basic_packages() {
    local packages=(
        "wget" "curl" "unzip" "git"
        "java-1.8.0-openjdk" "nginx" "mysql"
    )
    
    for package in "${packages[@]}"; do
        log "å®‰è£…è½¯ä»¶åŒ…: $package"
        if command -v yum &> /dev/null; then
            yum install -y $package
        elif command -v apt-get &> /dev/null; then
            apt-get install -y $package
        fi
    done
}
```

### 3.2 åº”ç”¨ç¯å¢ƒé…ç½®


**é…ç½®ç®¡ç†æ€è·¯**ï¼šæŠŠæ‰€æœ‰é…ç½®éƒ½å†™åœ¨è„šæœ¬é‡Œï¼Œéƒ¨ç½²æ—¶è‡ªåŠ¨ç”Ÿæˆé…ç½®æ–‡ä»¶ã€‚

```bash
# ç”Ÿæˆåº”ç”¨é…ç½®æ–‡ä»¶
generate_app_config() {
    local env=$1  # dev/test/prod
    local config_file="$DEPLOY_DIR/config/application.properties"
    
    log "ç”Ÿæˆç¯å¢ƒé…ç½®: $env"
    
    # åˆ›å»ºé…ç½®ç›®å½•
    mkdir -p $(dirname $config_file)
    
    # æ ¹æ®ç¯å¢ƒç”Ÿæˆä¸åŒé…ç½®
    case $env in
        "dev")
            cat > $config_file << EOF
# å¼€å‘ç¯å¢ƒé…ç½®
server.port=8080
database.host=dev-db.company.com
database.user=dev_user
database.password=dev_pass
log.level=DEBUG
cache.enabled=false
EOF
            ;;
        "prod")
            cat > $config_file << EOF
# ç”Ÿäº§ç¯å¢ƒé…ç½®
server.port=8080
database.host=prod-db.company.com
database.user=prod_user
database.password=${DB_PASSWORD}  # ä»ç¯å¢ƒå˜é‡è·å–
log.level=INFO
cache.enabled=true
cache.redis.host=redis.company.com
EOF
            ;;
    esac
    
    log "é…ç½®æ–‡ä»¶ç”Ÿæˆå®Œæˆ: $config_file"
}
```

### 3.3 ç¯å¢ƒå˜é‡ç®¡ç†


**å®‰å…¨é…ç½®ç®¡ç†**ï¼šæ•æ„Ÿä¿¡æ¯ä¸å†™åœ¨è„šæœ¬é‡Œï¼Œé€šè¿‡ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶ä¼ é€’ã€‚

```bash
# ç¯å¢ƒå˜é‡é…ç½®æ–‡ä»¶: /etc/environment/app.env
load_environment() {
    local env_file="/etc/environment/app.env"
    
    if [ -f $env_file ]; then
        log "åŠ è½½ç¯å¢ƒå˜é‡: $env_file"
        source $env_file
    else
        log "ç¯å¢ƒå˜é‡æ–‡ä»¶ä¸å­˜åœ¨: $env_file"
        # è®¾ç½®é»˜è®¤å€¼
        export DB_PASSWORD="default_password"
        export API_KEY="default_key"
    fi
    
    # éªŒè¯å¿…è¦çš„ç¯å¢ƒå˜é‡
    required_vars=("DB_PASSWORD" "API_KEY")
    for var in "${required_vars[@]}"; do
        if [ -z "${!var}" ]; then
            handle_error "ç¼ºå°‘å¿…è¦çš„ç¯å¢ƒå˜é‡: $var"
        fi
    done
}
```

---

## 4. ğŸ–¥ï¸ æ‰¹é‡æœåŠ¡å™¨æ“ä½œ


### 4.1 SSHæ‰¹é‡æ‰§è¡Œ


**æ ¸å¿ƒæ€æƒ³**ï¼šä¸€æ¡å‘½ä»¤åŒæ—¶åœ¨å¤šå°æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼Œæé«˜è¿ç»´æ•ˆç‡ã€‚

```bash
#!/bin/bash
# æ‰¹é‡æœåŠ¡å™¨æ“ä½œè„šæœ¬

# æœåŠ¡å™¨åˆ—è¡¨
SERVER_LIST="/etc/servers.txt"  # æ¯è¡Œä¸€ä¸ªIPåœ°å€
SSH_USER="deploy"
SSH_KEY="/home/deploy/.ssh/id_rsa"

# åœ¨æ‰€æœ‰æœåŠ¡å™¨ä¸Šæ‰§è¡Œå‘½ä»¤
execute_on_all_servers() {
    local command="$1"
    local success_count=0
    local total_count=0
    
    log "å¼€å§‹åœ¨æ‰€æœ‰æœåŠ¡å™¨ä¸Šæ‰§è¡Œå‘½ä»¤: $command"
    
    while read -r server; do
        # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Šè¡Œ
        [[ -z "$server" || "$server" == \#* ]] && continue
        
        total_count=$((total_count + 1))
        
        log "åœ¨æœåŠ¡å™¨ $server ä¸Šæ‰§è¡Œå‘½ä»¤"
        
        if ssh -i $SSH_KEY -o ConnectTimeout=10 \
               -o StrictHostKeyChecking=no \
               $SSH_USER@$server "$command"; then
            log "æœåŠ¡å™¨ $server æ‰§è¡ŒæˆåŠŸ"
            success_count=$((success_count + 1))
        else
            log "æœåŠ¡å™¨ $server æ‰§è¡Œå¤±è´¥"
        fi
        
    done < $SERVER_LIST
    
    log "æ‰¹é‡æ‰§è¡Œå®Œæˆ: $success_count/$total_count æˆåŠŸ"
}

# æ‰¹é‡æ–‡ä»¶ä¼ è¾“
distribute_file() {
    local local_file="$1"
    local remote_path="$2"
    
    log "åˆ†å‘æ–‡ä»¶ $local_file åˆ°æ‰€æœ‰æœåŠ¡å™¨çš„ $remote_path"
    
    while read -r server; do
        [[ -z "$server" || "$server" == \#* ]] && continue
        
        log "ä¼ è¾“æ–‡ä»¶åˆ°æœåŠ¡å™¨: $server"
        
        if scp -i $SSH_KEY -o ConnectTimeout=10 \
               $local_file $SSH_USER@$server:$remote_path; then
            log "æ–‡ä»¶ä¼ è¾“æˆåŠŸ: $server"
        else
            log "æ–‡ä»¶ä¼ è¾“å¤±è´¥: $server"
        fi
    done < $SERVER_LIST
}
```

### 4.2 å¹¶è¡Œæ‰§è¡Œä¼˜åŒ–


**æå‡æ•ˆç‡**ï¼šå¤šä¸ªæœåŠ¡å™¨åŒæ—¶æ“ä½œï¼Œè€Œä¸æ˜¯ä¸€ä¸ªä¸€ä¸ªæ¥ã€‚

```bash
# å¹¶è¡Œæ‰§è¡Œæ‰¹é‡æ“ä½œ
parallel_execute() {
    local command="$1"
    local max_jobs=5  # æœ€å¤§å¹¶è¡Œæ•°
    
    log "å¼€å§‹å¹¶è¡Œæ‰§è¡Œ: $command (æœ€å¤§å¹¶è¡Œæ•°: $max_jobs)"
    
    while read -r server; do
        [[ -z "$server" || "$server" == \#* ]] && continue
        
        # æ§åˆ¶å¹¶è¡Œæ•°é‡
        while [ $(jobs -r | wc -l) -ge $max_jobs ]; do
            sleep 1
        done
        
        # åå°æ‰§è¡Œ
        {
            log "[$server] å¼€å§‹æ‰§è¡Œ"
            if ssh -i $SSH_KEY -o ConnectTimeout=10 \
                   -o StrictHostKeyChecking=no \
                   $SSH_USER@$server "$command" 2>&1 | \
                   while read line; do
                       echo "[$server] $line"
                   done; then
                log "[$server] æ‰§è¡ŒæˆåŠŸ"
            else
                log "[$server] æ‰§è¡Œå¤±è´¥"
            fi
        } &
        
    done < $SERVER_LIST
    
    # ç­‰å¾…æ‰€æœ‰åå°ä»»åŠ¡å®Œæˆ
    wait
    log "æ‰€æœ‰å¹¶è¡Œä»»åŠ¡æ‰§è¡Œå®Œæˆ"
}
```

### 4.3 æœåŠ¡å™¨çŠ¶æ€æ£€æŸ¥


**å¥åº·æ£€æŸ¥**ï¼šæ‰¹é‡æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€ï¼ŒåŠæ—¶å‘ç°é—®é¢˜ã€‚

```bash
# æ‰¹é‡å¥åº·æ£€æŸ¥
batch_health_check() {
    log "å¼€å§‹æ‰¹é‡å¥åº·æ£€æŸ¥"
    
    # æ£€æŸ¥é¡¹ç›®é…ç½®
    declare -A checks=(
        ["cpu"]="top -bn1 | grep 'Cpu(s)' | awk '{print \$2}'"
        ["memory"]="free -m | grep 'Mem:' | awk '{print \$3/\$2*100}'"
        ["disk"]="df -h | grep '/$' | awk '{print \$5}'"
        ["service"]="systemctl is-active myapp"
    )
    
    # ç”Ÿæˆæ£€æŸ¥æŠ¥å‘Š
    report_file="/tmp/health_report_$(date +%Y%m%d_%H%M%S).txt"
    echo "æœåŠ¡å™¨å¥åº·æ£€æŸ¥æŠ¥å‘Š - $(date)" > $report_file
    echo "=================================" >> $report_file
    
    while read -r server; do
        [[ -z "$server" || "$server" == \#* ]] && continue
        
        echo "" >> $report_file
        echo "æœåŠ¡å™¨: $server" >> $report_file
        echo "-----------------" >> $report_file
        
        for check_name in "${!checks[@]}"; do
            result=$(ssh -i $SSH_KEY -o ConnectTimeout=10 \
                     $SSH_USER@$server "${checks[$check_name]}" 2>/dev/null)
            
            if [ $? -eq 0 ]; then
                echo "$check_name: $result" >> $report_file
            else
                echo "$check_name: æ£€æŸ¥å¤±è´¥" >> $report_file
            fi
        done
        
    done < $SERVER_LIST
    
    log "å¥åº·æ£€æŸ¥å®Œæˆï¼ŒæŠ¥å‘Šä¿å­˜è‡³: $report_file"
}
```

---

## 5. ğŸ“‹ é…ç½®æ–‡ä»¶ç®¡ç†


### 5.1 é…ç½®æ¨¡æ¿ç³»ç»Ÿ


**æ¨¡æ¿æ€è·¯**ï¼šç”¨æ¨¡æ¿æ–‡ä»¶å®šä¹‰é…ç½®ç»“æ„ï¼Œéƒ¨ç½²æ—¶å¡«å…¥å…·ä½“å€¼ï¼Œé¿å…ç¡¬ç¼–ç ã€‚

```bash
#!/bin/bash
# é…ç½®æ–‡ä»¶æ¨¡æ¿ç®¡ç†ç³»ç»Ÿ

TEMPLATE_DIR="/opt/deploy/templates"
CONFIG_DIR="/opt/deploy/configs"

# ä»æ¨¡æ¿ç”Ÿæˆé…ç½®æ–‡ä»¶
generate_config_from_template() {
    local template_name="$1"
    local environment="$2"
    local output_file="$3"
    
    local template_file="$TEMPLATE_DIR/${template_name}.template"
    local vars_file="$CONFIG_DIR/${environment}.vars"
    
    log "ä»æ¨¡æ¿ç”Ÿæˆé…ç½®: $template_name -> $output_file"
    
    # æ£€æŸ¥æ¨¡æ¿æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    if [ ! -f "$template_file" ]; then
        handle_error "æ¨¡æ¿æ–‡ä»¶ä¸å­˜åœ¨: $template_file"
    fi
    
    # åŠ è½½ç¯å¢ƒå˜é‡
    if [ -f "$vars_file" ]; then
        source "$vars_file"
    fi
    
    # æ›¿æ¢æ¨¡æ¿å˜é‡
    envsubst < "$template_file" > "$output_file"
    
    log "é…ç½®æ–‡ä»¶ç”Ÿæˆå®Œæˆ: $output_file"
}
```

**æ¨¡æ¿æ–‡ä»¶ç¤ºä¾‹**ï¼š
```bash
# nginxé…ç½®æ¨¡æ¿: /opt/deploy/templates/nginx.template
server {
    listen ${NGINX_PORT:-80};
    server_name ${SERVER_NAME};
    
    location / {
        proxy_pass http://${APP_HOST}:${APP_PORT};
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_connect_timeout ${PROXY_TIMEOUT:-30}s;
    }
    
    access_log /var/log/nginx/${SERVER_NAME}.access.log;
    error_log /var/log/nginx/${SERVER_NAME}.error.log;
}
```

### 5.2 å¤šç¯å¢ƒé…ç½®ç®¡ç†


**ç¯å¢ƒéš”ç¦»**ï¼šä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒçš„é…ç½®å€¼ï¼Œä½†é…ç½®ç»“æ„ç›¸åŒã€‚

```bash
# ç¯å¢ƒå˜é‡é…ç½®: /opt/deploy/configs/prod.vars
export NGINX_PORT=80
export SERVER_NAME="api.company.com"
export APP_HOST="127.0.0.1"
export APP_PORT=8080
export PROXY_TIMEOUT=60
export DB_HOST="prod-db.company.com"
export DB_USER="prod_user"
export DB_PASSWORD="prod_secure_password"

# æµ‹è¯•ç¯å¢ƒé…ç½®: /opt/deploy/configs/test.vars
export NGINX_PORT=8080
export SERVER_NAME="test-api.company.com"
export APP_HOST="127.0.0.1"
export APP_PORT=8081
export PROXY_TIMEOUT=30
export DB_HOST="test-db.company.com"
export DB_USER="test_user"
export DB_PASSWORD="test_password"
```

### 5.3 é…ç½®éªŒè¯æœºåˆ¶


**ç¡®ä¿æ­£ç¡®æ€§**ï¼šç”Ÿæˆé…ç½®åè¦éªŒè¯æ ¼å¼å’Œå†…å®¹æ˜¯å¦æ­£ç¡®ã€‚

```bash
# é…ç½®æ–‡ä»¶éªŒè¯
validate_config() {
    local config_file="$1"
    local config_type="$2"
    
    log "éªŒè¯é…ç½®æ–‡ä»¶: $config_file"
    
    case $config_type in
        "nginx")
            if nginx -t -c "$config_file" 2>/dev/null; then
                log "Nginxé…ç½®æ–‡ä»¶éªŒè¯é€šè¿‡"
                return 0
            else
                log "Nginxé…ç½®æ–‡ä»¶éªŒè¯å¤±è´¥"
                return 1
            fi
            ;;
        "properties")
            # æ£€æŸ¥propertiesæ–‡ä»¶æ ¼å¼
            if ! grep -q "^[^=]*=[^=]*$" "$config_file"; then
                log "Propertiesæ–‡ä»¶æ ¼å¼é”™è¯¯"
                return 1
            fi
            
            # æ£€æŸ¥å¿…è¦çš„é…ç½®é¡¹
            required_keys=("database.host" "server.port")
            for key in "${required_keys[@]}"; do
                if ! grep -q "^$key=" "$config_file"; then
                    log "ç¼ºå°‘å¿…è¦é…ç½®é¡¹: $key"
                    return 1
                fi
            done
            
            log "Propertiesé…ç½®æ–‡ä»¶éªŒè¯é€šè¿‡"
            return 0
            ;;
    esac
}
```

---

## 6. ğŸ”„ ç‰ˆæœ¬æ§åˆ¶é›†æˆ


### 6.1 Gité›†æˆè‡ªåŠ¨åŒ–


**è‡ªåŠ¨æ‹‰å–ä»£ç **ï¼šéƒ¨ç½²è„šæœ¬ç›´æ¥ä»Gitä»“åº“è·å–æœ€æ–°ä»£ç ï¼Œç¡®ä¿ç‰ˆæœ¬ä¸€è‡´ã€‚

```bash
#!/bin/bash
# Gitç‰ˆæœ¬æ§åˆ¶é›†æˆ

GIT_REPO="https://github.com/company/myapp.git"
GIT_BRANCH="master"
WORKSPACE="/opt/deploy/workspace"
DEPLOY_KEY="/home/deploy/.ssh/deploy_key"

# ä»Gitä»“åº“è·å–ä»£ç 
fetch_code_from_git() {
    local version="$1"  # å¯ä»¥æ˜¯åˆ†æ”¯åã€æ ‡ç­¾æˆ–commit hash
    
    log "ä»Gitä»“åº“è·å–ä»£ç : $version"
    
    # åˆ›å»ºå·¥ä½œç›®å½•
    mkdir -p $WORKSPACE
    cd $WORKSPACE
    
    # å¦‚æœç›®å½•å·²å­˜åœ¨ï¼Œåˆ™æ›´æ–°ï¼›å¦åˆ™å…‹éš†
    if [ -d ".git" ]; then
        log "æ›´æ–°ç°æœ‰ä»“åº“"
        git fetch --all
        git reset --hard origin/$version
    else
        log "å…‹éš†æ–°ä»“åº“"
        git clone -b $version $GIT_REPO .
    fi
    
    # è·å–å½“å‰ç‰ˆæœ¬ä¿¡æ¯
    local current_commit=$(git rev-parse HEAD)
    local commit_message=$(git log -1 --pretty=format:"%s")
    local commit_author=$(git log -1 --pretty=format:"%an")
    local commit_date=$(git log -1 --pretty=format:"%ad")
    
    log "å½“å‰ç‰ˆæœ¬ä¿¡æ¯:"
    log "  Commit: $current_commit"
    log "  Message: $commit_message"
    log "  Author: $commit_author"
    log "  Date: $commit_date"
    
    # ä¿å­˜ç‰ˆæœ¬ä¿¡æ¯åˆ°æ–‡ä»¶
    cat > "$DEPLOY_DIR/version.txt" << EOF
Version: $version
Commit: $current_commit
Message: $commit_message
Author: $commit_author
Date: $commit_date
Deploy Time: $(date)
EOF

    return 0
}
```

### 6.2 æ„å»ºæµç¨‹è‡ªåŠ¨åŒ–


**ä»£ç æ„å»º**ï¼šè·å–ä»£ç åè‡ªåŠ¨ç¼–è¯‘æ‰“åŒ…ï¼Œç”Ÿæˆå¯éƒ¨ç½²çš„æ–‡ä»¶ã€‚

```bash
# è‡ªåŠ¨æ„å»ºæµç¨‹
build_application() {
    local build_env="$1"
    
    log "å¼€å§‹æ„å»ºåº”ç”¨ (ç¯å¢ƒ: $build_env)"
    
    cd $WORKSPACE
    
    # æ£€æŸ¥æ„å»ºå·¥å…·
    if [ -f "pom.xml" ]; then
        # Mavené¡¹ç›®
        build_with_maven $build_env
    elif [ -f "package.json" ]; then
        # Node.jsé¡¹ç›®
        build_with_npm $build_env
    elif [ -f "requirements.txt" ]; then
        # Pythoné¡¹ç›®
        build_with_python $build_env
    else
        log "æœªè¯†åˆ«çš„é¡¹ç›®ç±»å‹"
        return 1
    fi
}

# Mavenæ„å»º
build_with_maven() {
    local profile="$1"
    
    log "ä½¿ç”¨Mavenæ„å»ºé¡¹ç›® (Profile: $profile)"
    
    # æ¸…ç†å¹¶ç¼–è¯‘
    if mvn clean compile -P$profile -Dmaven.test.skip=true; then
        log "ç¼–è¯‘æˆåŠŸ"
    else
        handle_error "ç¼–è¯‘å¤±è´¥"
    fi
    
    # æ‰“åŒ…
    if mvn package -P$profile -Dmaven.test.skip=true; then
        log "æ‰“åŒ…æˆåŠŸ"
        # å¤åˆ¶æ„å»ºäº§ç‰©
        cp target/*.jar $DEPLOY_DIR/
    else
        handle_error "æ‰“åŒ…å¤±è´¥"
    fi
}

# Node.jsæ„å»º
build_with_npm() {
    local env="$1"
    
    log "ä½¿ç”¨npmæ„å»ºé¡¹ç›® (ç¯å¢ƒ: $env)"
    
    # å®‰è£…ä¾èµ–
    npm install --production
    
    # æ„å»º
    NODE_ENV=$env npm run build
    
    # å¤åˆ¶æ„å»ºäº§ç‰©
    cp -r dist/* $DEPLOY_DIR/
}
```

### 6.3 ç‰ˆæœ¬æ ‡ç­¾ç®¡ç†


**ç‰ˆæœ¬è¿½è¸ª**ï¼šæ¯æ¬¡éƒ¨ç½²éƒ½æ‰“ä¸Šæ ‡ç­¾ï¼Œä¾¿äºè¿½è¸ªå’Œå›æ»šã€‚

```bash
# ç‰ˆæœ¬æ ‡ç­¾ç®¡ç†
manage_version_tags() {
    local action="$1"  # create, list, delete
    local tag_name="$2"
    
    case $action in
        "create")
            create_version_tag "$tag_name"
            ;;
        "list")
            list_version_tags
            ;;
        "delete")
            delete_version_tag "$tag_name"
            ;;
    esac
}

create_version_tag() {
    local tag="$1"
    
    log "åˆ›å»ºç‰ˆæœ¬æ ‡ç­¾: $tag"
    
    cd $WORKSPACE
    
    # åˆ›å»ºå¸¦æ³¨é‡Šçš„æ ‡ç­¾
    git tag -a "$tag" -m "Release $tag - $(date)"
    
    # æ¨é€æ ‡ç­¾åˆ°è¿œç¨‹ä»“åº“
    git push origin "$tag"
    
    log "ç‰ˆæœ¬æ ‡ç­¾åˆ›å»ºå®Œæˆ: $tag"
}

list_version_tags() {
    log "ç‰ˆæœ¬æ ‡ç­¾åˆ—è¡¨:"
    cd $WORKSPACE
    git tag -l --sort=-version:refname | head -10
}
```

---

## 7. ğŸ”™ å›æ»šæœºåˆ¶å®ç°


### 7.1 å¤‡ä»½ç­–ç•¥


**å›æ»šåŸç†**ï¼šæ¯æ¬¡éƒ¨ç½²å‰å…ˆå¤‡ä»½å½“å‰ç‰ˆæœ¬ï¼Œå‡ºé—®é¢˜æ—¶å¿«é€Ÿæ¢å¤ã€‚

```bash
#!/bin/bash
# å›æ»šæœºåˆ¶å®ç°

BACKUP_DIR="/opt/backup"
MAX_BACKUPS=5  # ä¿ç•™æœ€è¿‘5ä¸ªå¤‡ä»½

# åˆ›å»ºå¤‡ä»½
create_backup() {
    local backup_name="backup_$(date +%Y%m%d_%H%M%S)"
    local backup_path="$BACKUP_DIR/$backup_name"
    
    log "åˆ›å»ºå¤‡ä»½: $backup_name"
    
    mkdir -p "$backup_path"
    
    # å¤‡ä»½åº”ç”¨æ–‡ä»¶
    if [ -d "$DEPLOY_DIR" ]; then
        cp -r "$DEPLOY_DIR" "$backup_path/app"
    fi
    
    # å¤‡ä»½é…ç½®æ–‡ä»¶
    backup_configs "$backup_path/configs"
    
    # å¤‡ä»½æ•°æ®åº“
    backup_database "$backup_path/database"
    
    # åˆ›å»ºå¤‡ä»½ä¿¡æ¯æ–‡ä»¶
    cat > "$backup_path/backup_info.txt" << EOF
Backup Name: $backup_name
Backup Time: $(date)
App Version: $(cat $DEPLOY_DIR/version.txt 2>/dev/null || echo "Unknown")
Server: $(hostname)
EOF

    log "å¤‡ä»½åˆ›å»ºå®Œæˆ: $backup_path"
    
    # æ¸…ç†æ—§å¤‡ä»½
    cleanup_old_backups
    
    echo "$backup_name"  # è¿”å›å¤‡ä»½åç§°
}

# å¤‡ä»½é…ç½®æ–‡ä»¶
backup_configs() {
    local backup_config_dir="$1"
    mkdir -p "$backup_config_dir"
    
    # å¤‡ä»½é‡è¦é…ç½®æ–‡ä»¶
    local config_files=(
        "/etc/nginx/nginx.conf"
        "/opt/apps/myapp/config/application.properties"
        "/etc/systemd/system/myapp.service"
    )
    
    for config_file in "${config_files[@]}"; do
        if [ -f "$config_file" ]; then
            cp "$config_file" "$backup_config_dir/"
        fi
    done
}
```

### 7.2 å¿«é€Ÿå›æ»šåŠŸèƒ½


**ä¸€é”®å›æ»š**ï¼šå‡ºç°é—®é¢˜æ—¶ï¼Œä¸€æ¡å‘½ä»¤æ¢å¤åˆ°ä¸Šä¸ªç‰ˆæœ¬ã€‚

```bash
# æ‰§è¡Œå›æ»š
rollback_to_version() {
    local backup_name="$1"
    local backup_path="$BACKUP_DIR/$backup_name"
    
    log "å¼€å§‹å›æ»šåˆ°ç‰ˆæœ¬: $backup_name"
    
    # æ£€æŸ¥å¤‡ä»½æ˜¯å¦å­˜åœ¨
    if [ ! -d "$backup_path" ]; then
        handle_error "å¤‡ä»½ä¸å­˜åœ¨: $backup_name"
    fi
    
    # åœæ­¢å½“å‰æœåŠ¡
    log "åœæ­¢åº”ç”¨æœåŠ¡"
    systemctl stop myapp
    
    # å¤‡ä»½å½“å‰ç‰ˆæœ¬ï¼ˆä»¥é˜²å›æ»šå¤±è´¥éœ€è¦æ¢å¤ï¼‰
    local current_backup=$(create_backup)
    log "å·²å¤‡ä»½å½“å‰ç‰ˆæœ¬: $current_backup"
    
    # æ¢å¤åº”ç”¨æ–‡ä»¶
    if [ -d "$backup_path/app" ]; then
        log "æ¢å¤åº”ç”¨æ–‡ä»¶"
        rm -rf "$DEPLOY_DIR"
        cp -r "$backup_path/app" "$DEPLOY_DIR"
    fi
    
    # æ¢å¤é…ç½®æ–‡ä»¶
    restore_configs "$backup_path/configs"
    
    # æ¢å¤æ•°æ®åº“ï¼ˆå¯é€‰ï¼Œé€šå¸¸ä¸å»ºè®®è‡ªåŠ¨æ¢å¤æ•°æ®åº“ï¼‰
    # restore_database "$backup_path/database"
    
    # å¯åŠ¨æœåŠ¡
    log "å¯åŠ¨åº”ç”¨æœåŠ¡"
    systemctl start myapp
    
    # éªŒè¯å›æ»šç»“æœ
    sleep 10
    if health_check_local; then
        log "å›æ»šæˆåŠŸå®Œæˆ"
        
        # è®°å½•å›æ»šæ“ä½œ
        echo "$(date): å›æ»šåˆ° $backup_name" >> /var/log/rollback.log
    else
        log "å›æ»šåæœåŠ¡å¼‚å¸¸ï¼Œå°è¯•æ¢å¤"
        rollback_to_version "$current_backup"
    fi
}

# åˆ—å‡ºå¯ç”¨çš„å¤‡ä»½ç‰ˆæœ¬
list_available_backups() {
    log "å¯ç”¨çš„å¤‡ä»½ç‰ˆæœ¬:"
    ls -la "$BACKUP_DIR" | grep "backup_" | awk '{print $9, $6, $7, $8}'
}

# æ¸…ç†æ—§å¤‡ä»½
cleanup_old_backups() {
    local backup_count=$(ls -1 "$BACKUP_DIR" | grep "backup_" | wc -l)
    
    if [ $backup_count -gt $MAX_BACKUPS ]; then
        local excess=$((backup_count - MAX_BACKUPS))
        log "æ¸…ç† $excess ä¸ªæ—§å¤‡ä»½"
        
        ls -1t "$BACKUP_DIR" | grep "backup_" | tail -n $excess | while read backup; do
            log "åˆ é™¤å¤‡ä»½: $backup"
            rm -rf "$BACKUP_DIR/$backup"
        done
    fi
}
```

### 7.3 ç°åº¦å›æ»šç­–ç•¥


**æ¸è¿›å¼å›æ»š**ï¼šå…ˆå›æ»šä¸€å°æœåŠ¡å™¨éªŒè¯ï¼Œç¡®è®¤æ— é—®é¢˜å†å›æ»šå…¶ä»–æœåŠ¡å™¨ã€‚

```bash
# ç°åº¦å›æ»š
gradual_rollback() {
    local backup_name="$1"
    local servers=("${SERVERS[@]}")
    
    log "å¼€å§‹ç°åº¦å›æ»šåˆ°ç‰ˆæœ¬: $backup_name"
    
    # ç¬¬ä¸€é˜¶æ®µï¼šå›æ»šç¬¬ä¸€å°æœåŠ¡å™¨
    local first_server="${servers[0]}"
    log "ç¬¬ä¸€é˜¶æ®µï¼šå›æ»šæœåŠ¡å™¨ $first_server"
    
    if rollback_server "$first_server" "$backup_name"; then
        log "ç¬¬ä¸€å°æœåŠ¡å™¨å›æ»šæˆåŠŸ"
        
        # ç­‰å¾…å¹¶éªŒè¯
        sleep 60
        if health_check "$first_server"; then
            log "ç¬¬ä¸€å°æœåŠ¡å™¨éªŒè¯é€šè¿‡ï¼Œç»§ç»­å›æ»šå…¶ä»–æœåŠ¡å™¨"
            
            # ç¬¬äºŒé˜¶æ®µï¼šå›æ»šå…¶ä»–æœåŠ¡å™¨
            for server in "${servers[@]:1}"; do
                log "å›æ»šæœåŠ¡å™¨: $server"
                rollback_server "$server" "$backup_name" &
            done
            wait
            
            log "æ‰€æœ‰æœåŠ¡å™¨å›æ»šå®Œæˆ"
        else
            log "ç¬¬ä¸€å°æœåŠ¡å™¨éªŒè¯å¤±è´¥ï¼Œåœæ­¢å›æ»š"
            return 1
        fi
    else
        log "ç¬¬ä¸€å°æœåŠ¡å™¨å›æ»šå¤±è´¥"
        return 1
    fi
}
```

---

## 8. ğŸ“Š éƒ¨ç½²æ—¥å¿—ä¸ç›‘æ§


### 8.1 è¯¦ç»†æ—¥å¿—è®°å½•


**æ—¥å¿—çš„ä»·å€¼**ï¼šè®°å½•æ¯ä¸ªæ“ä½œæ­¥éª¤ï¼Œå‡ºé—®é¢˜æ—¶èƒ½å¿«é€Ÿå®šä½åŸå› ã€‚

```bash
#!/bin/bash
# éƒ¨ç½²æ—¥å¿—ç³»ç»Ÿ

LOG_DIR="/var/log/deploy"
LOG_FILE="$LOG_DIR/deploy_$(date +%Y%m%d).log"
ERROR_LOG="$LOG_DIR/error.log"

# åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ
init_logging() {
    mkdir -p "$LOG_DIR"
    
    # å¦‚æœæ˜¯æ–°çš„ä¸€å¤©ï¼Œè½®è½¬æ—¥å¿—
    if [ ! -f "$LOG_FILE" ]; then
        # å‹ç¼©æ˜¨å¤©çš„æ—¥å¿—
        find "$LOG_DIR" -name "deploy_*.log" -mtime +0 -exec gzip {} \;
    fi
}

# å¢å¼ºçš„æ—¥å¿—å‡½æ•°
log() {
    local level="$1"
    local message="$2"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    local caller="${BASH_SOURCE[2]##*/}:${BASH_LINENO[1]}"
    
    # æ ¼å¼åŒ–æ—¥å¿—æ¶ˆæ¯
    local log_entry="[$timestamp] [$level] [$caller] $message"
    
    # è¾“å‡ºåˆ°æ§åˆ¶å°ï¼ˆå¸¦é¢œè‰²ï¼‰
    case $level in
        "INFO")
            echo -e "\033[32m$log_entry\033[0m"
            ;;
        "WARN")
            echo -e "\033[33m$log_entry\033[0m"
            ;;
        "ERROR")
            echo -e "\033[31m$log_entry\033[0m"
            echo "$log_entry" >> "$ERROR_LOG"
            ;;
        *)
            echo "$log_entry"
            ;;
    esac
    
    # å†™å…¥æ—¥å¿—æ–‡ä»¶
    echo "$log_entry" >> "$LOG_FILE"
}

# ä½¿ç”¨ç¤ºä¾‹
info() { log "INFO" "$1"; }
warn() { log "WARN" "$1"; }
error() { log "ERROR" "$1"; }
```

### 8.2 éƒ¨ç½²æŒ‡æ ‡æ”¶é›†


**ç›‘æ§å…³é”®æŒ‡æ ‡**ï¼šéƒ¨ç½²æ—¶é—´ã€æˆåŠŸç‡ã€èµ„æºä½¿ç”¨ç­‰ï¼Œå¸®åŠ©ä¼˜åŒ–éƒ¨ç½²è¿‡ç¨‹ã€‚

```bash
# éƒ¨ç½²æŒ‡æ ‡æ”¶é›†
collect_deployment_metrics() {
    local start_time="$1"
    local end_time="$2"
    local status="$3"  # SUCCESS/FAILED
    local version="$4"
    
    local duration=$((end_time - start_time))
    local metrics_file="$LOG_DIR/metrics.csv"
    
    # å¦‚æœæŒ‡æ ‡æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºå¹¶å†™å…¥è¡¨å¤´
    if [ ! -f "$metrics_file" ]; then
        echo "timestamp,version,status,duration_seconds,server_count,deployment_size_mb" > "$metrics_file"
    fi
    
    # è®¡ç®—éƒ¨ç½²åŒ…å¤§å°
    local deployment_size=$(du -sm "$DEPLOY_DIR" | awk '{print $1}')
    
    # å†™å…¥æŒ‡æ ‡æ•°æ®
    echo "$(date -d @$end_time '+%Y-%m-%d %H:%M:%S'),$version,$status,$duration,${#SERVERS[@]},$deployment_size" >> "$metrics_file"
    
    info "éƒ¨ç½²æŒ‡æ ‡å·²è®°å½•: ç”¨æ—¶${duration}ç§’, çŠ¶æ€$status"
}

# ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Š
generate_deployment_report() {
    local report_file="$LOG_DIR/report_$(date +%Y%m%d).html"
    
    info "ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Š: $report_file"
    
    cat > "$report_file" << EOF
<!DOCTYPE html>
<html>
<head>
    <title>éƒ¨ç½²æŠ¥å‘Š - $(date +%Y-%m-%d)</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .success { color: green; }
        .failed { color: red; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>éƒ¨ç½²æŠ¥å‘Š</h1>
    <h2>ä»Šæ—¥éƒ¨ç½²ç»Ÿè®¡</h2>
    <table>
        <tr><th>æ—¶é—´</th><th>ç‰ˆæœ¬</th><th>çŠ¶æ€</th><th>ç”¨æ—¶(ç§’)</th><th>æœåŠ¡å™¨æ•°é‡</th></tr>
EOF

    # è¯»å–ä»Šå¤©çš„éƒ¨ç½²è®°å½•
    if [ -f "$LOG_DIR/metrics.csv" ]; then
        tail -n +2 "$LOG_DIR/metrics.csv" | grep "$(date +%Y-%m-%d)" | while read line; do
            IFS=',' read -r timestamp version status duration servers size <<< "$line"
            
            local status_class="success"
            [ "$status" = "FAILED" ] && status_class="failed"
            
            echo "<tr><td>$timestamp</td><td>$version</td><td class=\"$status_class\">$status</td><td>$duration</td><td>$servers</td></tr>" >> "$report_file"
        done
    fi
    
    echo "</table></body></html>" >> "$report_file"
    
    info "æŠ¥å‘Šç”Ÿæˆå®Œæˆ: $report_file"
}
```

### 8.3 å‘Šè­¦é€šçŸ¥ç³»ç»Ÿ


**åŠæ—¶é€šçŸ¥**ï¼šéƒ¨ç½²æˆåŠŸæˆ–å¤±è´¥æ—¶ï¼Œé€šè¿‡é‚®ä»¶ã€é’‰é’‰ç­‰æ–¹å¼é€šçŸ¥ç›¸å…³äººå‘˜ã€‚

```bash
# å‘Šè­¦é€šçŸ¥ç³»ç»Ÿ
send_notification() {
    local status="$1"      # SUCCESS/FAILED
    local message="$2"
    local details="$3"
    
    info "å‘é€é€šçŸ¥: $status - $message"
    
    # é’‰é’‰é€šçŸ¥
    send_dingtalk_notification "$status" "$message" "$details"
    
    # é‚®ä»¶é€šçŸ¥
    send_email_notification "$status" "$message" "$details"
    
    # çŸ­ä¿¡é€šçŸ¥ï¼ˆä»…å¤±è´¥æ—¶ï¼‰
    if [ "$status" = "FAILED" ]; then
        send_sms_notification "$message"
    fi
}

# é’‰é’‰æœºå™¨äººé€šçŸ¥
send_dingtalk_notification() {
    local status="$1"
    local message="$2"
    local details="$3"
    
    local webhook_url="https://oapi.dingtalk.com/robot/send?access_token=YOUR_TOKEN"
    local color="#00FF00"  # ç»¿è‰²
    
    [ "$status" = "FAILED" ] && color="#FF0000"  # çº¢è‰²
    
    local json_data=$(cat << EOF
{
    "msgtype": "markdown",
    "markdown": {
        "title": "éƒ¨ç½²é€šçŸ¥",
        "text": "## éƒ¨ç½²é€šçŸ¥\n\n**çŠ¶æ€**: <font color=\"$color\">$status</font>\n\n**æ¶ˆæ¯**: $message\n\n**è¯¦æƒ…**: $details\n\n**æ—¶é—´**: $(date)\n\n**æœåŠ¡å™¨**: $(hostname)"
    }
}
EOF
    )
    
    curl -H "Content-Type: application/json" \
         -X POST \
         -d "$json_data" \
         "$webhook_url" > /dev/null 2>&1
}

# é‚®ä»¶é€šçŸ¥
send_email_notification() {
    local status="$1"
    local message="$2"
    local details="$3"
    
    local recipients="dev-team@company.com"
    local subject="éƒ¨ç½²é€šçŸ¥ - $status - $(date)"
    
    local email_body="éƒ¨ç½²çŠ¶æ€: $status
æ¶ˆæ¯: $message
è¯¦æƒ…: $details
æ—¶é—´: $(date)
æœåŠ¡å™¨: $(hostname)

æœ€è¿‘çš„æ—¥å¿—:
$(tail -20 "$LOG_FILE")"
    
    echo "$email_body" | mail -s "$subject" "$recipients"
}
```

---

## 9. ğŸ”„ è“ç»¿éƒ¨ç½²å®æˆ˜


### 9.1 è“ç»¿éƒ¨ç½²åŸç†


**ä»€ä¹ˆæ˜¯è“ç»¿éƒ¨ç½²**ï¼šå‡†å¤‡ä¸¤å¥—å®Œå…¨ç›¸åŒçš„ç¯å¢ƒï¼ˆè“ç¯å¢ƒå’Œç»¿ç¯å¢ƒï¼‰ï¼Œä¸€å¥—è¿è¡Œå½“å‰ç‰ˆæœ¬ï¼Œä¸€å¥—éƒ¨ç½²æ–°ç‰ˆæœ¬ï¼Œç„¶ååˆ‡æ¢æµé‡ã€‚

```
è“ç»¿éƒ¨ç½²æµç¨‹å›¾ï¼š

åˆå§‹çŠ¶æ€ï¼š
ç”¨æˆ·æµé‡ â†’ è´Ÿè½½å‡è¡¡å™¨ â†’ è“ç¯å¢ƒ(v1.0)
                      ç»¿ç¯å¢ƒ(ç©ºé—²)

éƒ¨ç½²é˜¶æ®µï¼š
ç”¨æˆ·æµé‡ â†’ è´Ÿè½½å‡è¡¡å™¨ â†’ è“ç¯å¢ƒ(v1.0)
                      ç»¿ç¯å¢ƒ(éƒ¨ç½²v2.0)

åˆ‡æ¢é˜¶æ®µï¼š
ç”¨æˆ·æµé‡ â†’ è´Ÿè½½å‡è¡¡å™¨ â†’ è“ç¯å¢ƒ(ç©ºé—²)
                      ç»¿ç¯å¢ƒ(v2.0) â†

å›æ»šæ—¶ï¼š
ç”¨æˆ·æµé‡ â†’ è´Ÿè½½å‡è¡¡å™¨ â†’ è“ç¯å¢ƒ(v1.0) â†
                      ç»¿ç¯å¢ƒ(v2.0)
```

### 9.2 è“ç»¿éƒ¨ç½²è„šæœ¬å®ç°


```bash
#!/bin/bash
# è“ç»¿éƒ¨ç½²å®ç°è„šæœ¬

BLUE_PORT=8080
GREEN_PORT=8081
NGINX_CONFIG="/etc/nginx/conf.d/app.conf"

# è·å–å½“å‰æ´»è·ƒç¯å¢ƒ
get_active_environment() {
    if nginx -T 2>/dev/null | grep -q "proxy_pass.*:$BLUE_PORT"; then
        echo "blue"
    elif nginx -T 2>/dev/null | grep -q "proxy_pass.*:$GREEN_PORT"; then
        echo "green"
    else
        echo "unknown"
    fi
}

# è·å–å¾…éƒ¨ç½²ç¯å¢ƒ
get_standby_environment() {
    local active=$(get_active_environment)
    
    case $active in
        "blue")
            echo "green"
            ;;
        "green")
            echo "blue"
            ;;
        *)
            echo "blue"  # é»˜è®¤ä½¿ç”¨è“ç¯å¢ƒ
            ;;
    esac
}

# éƒ¨ç½²åˆ°æŒ‡å®šç¯å¢ƒ
deploy_to_environment() {
    local env="$1"      # blue æˆ– green
    local version="$2"
    
    info "å¼€å§‹éƒ¨ç½²åˆ°${env}ç¯å¢ƒ: $version"
    
    local port
    local service_name
    
    if [ "$env" = "blue" ]; then
        port=$BLUE_PORT
        service_name="myapp-blue"
    else
        port=$GREEN_PORT
        service_name="myapp-green"
    fi
    
    # åœæ­¢ç›®æ ‡ç¯å¢ƒæœåŠ¡
    info "åœæ­¢${env}ç¯å¢ƒæœåŠ¡"
    systemctl stop "$service_name" || true
    
    # éƒ¨ç½²æ–°ç‰ˆæœ¬
    deploy_version_to_port "$version" "$port"
    
    # å¯åŠ¨æœåŠ¡
    info "å¯åŠ¨${env}ç¯å¢ƒæœåŠ¡"
    systemctl start "$service_name"
    
    # ç­‰å¾…æœåŠ¡å¯åŠ¨
    sleep 20
    
    # å¥åº·æ£€æŸ¥
    if health_check_port "$port"; then
        info "${env}ç¯å¢ƒéƒ¨ç½²æˆåŠŸ"
        return 0
    else
        error "${env}ç¯å¢ƒå¥åº·æ£€æŸ¥å¤±è´¥"
        return 1
    fi
}

# åˆ‡æ¢æµé‡åˆ°æŒ‡å®šç¯å¢ƒ
switch_traffic() {
    local target_env="$1"
    
    info "åˆ‡æ¢æµé‡åˆ°${target_env}ç¯å¢ƒ"
    
    local target_port
    if [ "$target_env" = "blue" ]; then
        target_port=$BLUE_PORT
    else
        target_port=$GREEN_PORT
    fi
    
    # å¤‡ä»½å½“å‰nginxé…ç½®
    cp "$NGINX_CONFIG" "$NGINX_CONFIG.backup"
    
    # ç”Ÿæˆæ–°çš„nginxé…ç½®
    cat > "$NGINX_CONFIG" << EOF
upstream app_servers {
    server 127.0.0.1:$target_port;
}

server {
    listen 80;
    server_name myapp.company.com;
    
    location / {
        proxy_pass http://app_servers;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
    
    # å¥åº·æ£€æŸ¥ç«¯ç‚¹
    location /health {
        proxy_pass http://app_servers/health;
    }
}
EOF

    # æµ‹è¯•nginxé…ç½®
    if nginx -t; then
        # é‡æ–°åŠ è½½nginx
        nginx -s reload
        info "æµé‡åˆ‡æ¢æˆåŠŸï¼Œå½“å‰æ´»è·ƒç¯å¢ƒ: $target_env"
        
        # éªŒè¯åˆ‡æ¢ç»“æœ
        sleep 5
        if health_check_external; then
            info "æµé‡åˆ‡æ¢éªŒè¯é€šè¿‡"
            return 0
        else
            error "æµé‡åˆ‡æ¢éªŒè¯å¤±è´¥ï¼Œæ­£åœ¨å›æ»š"
            cp "$NGINX_CONFIG.backup" "$NGINX_CONFIG"
            nginx -s reload
            return 1
        fi
    else
        error "nginxé…ç½®é”™è¯¯ï¼Œæ— æ³•åˆ‡æ¢æµé‡"
        return 1
    fi
}
```

### 9.3 è“ç»¿éƒ¨ç½²ä¸»æµç¨‹


```bash
# è“ç»¿éƒ¨ç½²ä¸»å‡½æ•°
blue_green_deploy() {
    local version="$1"
    
    info "å¼€å§‹è“ç»¿éƒ¨ç½²: $version"
    
    # è·å–å½“å‰ç¯å¢ƒçŠ¶æ€
    local active_env=$(get_active_environment)
    local standby_env=$(get_standby_environment)
    
    info "å½“å‰æ´»è·ƒç¯å¢ƒ: $active_env"
    info "å¾…éƒ¨ç½²ç¯å¢ƒ: $standby_env"
    
    # è®°å½•éƒ¨ç½²å¼€å§‹æ—¶é—´
    local start_time=$(date +%s)
    
    # ç¬¬ä¸€æ­¥ï¼šéƒ¨ç½²åˆ°å¾…æœºç¯å¢ƒ
    if deploy_to_environment "$standby_env" "$version"; then
        info "å¾…æœºç¯å¢ƒéƒ¨ç½²æˆåŠŸ"
    else
        error "å¾…æœºç¯å¢ƒéƒ¨ç½²å¤±è´¥ï¼Œåœæ­¢éƒ¨ç½²"
        collect_deployment_metrics "$start_time" "$(date +%s)" "FAILED" "$version"
        return 1
    fi
    
    # ç¬¬äºŒæ­¥ï¼šåˆ‡æ¢æµé‡
    if switch_traffic "$standby_env"; then
        info "æµé‡åˆ‡æ¢æˆåŠŸ"
        
        # ç¬¬ä¸‰æ­¥ï¼šéªŒè¯æ–°ç¯å¢ƒ
        sleep 30
        if verify_deployment; then
            info "è“ç»¿éƒ¨ç½²æˆåŠŸå®Œæˆ"
            
            # åœæ­¢åŸæ¥çš„æ´»è·ƒç¯å¢ƒï¼ˆå¯é€‰ï¼‰
            # stop_environment "$active_env"
            
            collect_deployment_metrics "$start_time" "$(date +%s)" "SUCCESS" "$version"
            send_notification "SUCCESS" "è“ç»¿éƒ¨ç½²æˆåŠŸ" "ç‰ˆæœ¬: $version, æ–°æ´»è·ƒç¯å¢ƒ: $standby_env"
        else
            error "æ–°ç¯å¢ƒéªŒè¯å¤±è´¥ï¼Œæ­£åœ¨å›æ»š"
            rollback_blue_green "$active_env"
        fi
    else
        error "æµé‡åˆ‡æ¢å¤±è´¥"
        collect_deployment_metrics "$start_time" "$(date +%s)" "FAILED" "$version"
        return 1
    fi
}

# è“ç»¿éƒ¨ç½²å›æ»š
rollback_blue_green() {
    local target_env="$1"
    
    warn "æ‰§è¡Œè“ç»¿éƒ¨ç½²å›æ»šåˆ°: $target_env"
    
    if switch_traffic "$target_env"; then
        info "è“ç»¿å›æ»šæˆåŠŸ"
        send_notification "SUCCESS" "è“ç»¿éƒ¨ç½²å›æ»šæˆåŠŸ" "å·²å›æ»šåˆ°ç¯å¢ƒ: $target_env"
    else
        error "è“ç»¿å›æ»šå¤±è´¥"
        send_notification "FAILED" "è“ç»¿éƒ¨ç½²å›æ»šå¤±è´¥" "éœ€è¦äººå·¥ä»‹å…¥"
    fi
}
```

---

## 10. ğŸ³ å®¹å™¨åŒ–éƒ¨ç½²è„šæœ¬


### 10.1 Dockeréƒ¨ç½²åŸºç¡€


**å®¹å™¨åŒ–çš„å¥½å¤„**ï¼šç¯å¢ƒä¸€è‡´ã€éƒ¨ç½²ç®€å•ã€èµ„æºéš”ç¦»ã€æ‰©å®¹æ–¹ä¾¿ã€‚

```bash
#!/bin/bash
# Dockerå®¹å™¨åŒ–éƒ¨ç½²è„šæœ¬

DOCKER_IMAGE="myapp"
DOCKER_TAG="latest"
CONTAINER_NAME="myapp-container"
DOCKER_PORT=8080
HOST_PORT=80

# Dockeré•œåƒæ„å»º
build_docker_image() {
    local version="$1"
    local image_tag="${DOCKER_IMAGE}:${version}"
    
    info "æ„å»ºDockeré•œåƒ: $image_tag"
    
    cd $WORKSPACE
    
    # æ£€æŸ¥Dockerfileæ˜¯å¦å­˜åœ¨
    if [ ! -f "Dockerfile" ]; then
        create_dockerfile
    fi
    
    # æ„å»ºé•œåƒ
    if docker build -t "$image_tag" .; then
        info "é•œåƒæ„å»ºæˆåŠŸ: $image_tag"
        
        # æ‰“æ ‡ç­¾
        docker tag "$image_tag" "${DOCKER_IMAGE}:latest"
        
        return 0
    else
        error "é•œåƒæ„å»ºå¤±è´¥"
        return 1
    fi
}

# ç”ŸæˆDockerfileï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
create_dockerfile() {
    info "ç”ŸæˆDockerfile"
    
    cat > Dockerfile << 'EOF'
# ä½¿ç”¨å®˜æ–¹Javaè¿è¡Œç¯å¢ƒä½œä¸ºåŸºç¡€é•œåƒ
FROM openjdk:8-jre-slim

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶jaræ–‡ä»¶åˆ°å®¹å™¨ä¸­
COPY target/*.jar app.jar

# æš´éœ²ç«¯å£
EXPOSE 8080

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV JAVA_OPTS="-Xmx512m -Xms256m"

# å¯åŠ¨å‘½ä»¤
CMD ["sh", "-c", "java $JAVA_OPTS -jar app.jar"]
EOF
}

# å®¹å™¨éƒ¨ç½²
deploy_container() {
    local version="$1"
    local image_tag="${DOCKER_IMAGE}:${version}"
    
    info "éƒ¨ç½²å®¹å™¨: $image_tag"
    
    # åœæ­¢æ—§å®¹å™¨
    if docker ps -q --filter "name=$CONTAINER_NAME" | grep -q .; then
        info "åœæ­¢æ—§å®¹å™¨"
        docker stop "$CONTAINER_NAME"
        docker rm "$CONTAINER_NAME"
    fi
    
    # å¯åŠ¨æ–°å®¹å™¨
    if docker run -d \
        --name "$CONTAINER_NAME" \
        --restart unless-stopped \
        -p "$HOST_PORT:$DOCKER_PORT" \
        -e "SPRING_PROFILES_ACTIVE=prod" \
        -v "/opt/logs:/app/logs" \
        "$image_tag"; then
        
        info "å®¹å™¨å¯åŠ¨æˆåŠŸ"
        
        # ç­‰å¾…å®¹å™¨å¯åŠ¨
        sleep 20
        
        # å¥åº·æ£€æŸ¥
        if health_check_container "$CONTAINER_NAME"; then
            info "å®¹å™¨éƒ¨ç½²æˆåŠŸ"
            return 0
        else
            error "å®¹å™¨å¥åº·æ£€æŸ¥å¤±è´¥"
            return 1
        fi
    else
        error "å®¹å™¨å¯åŠ¨å¤±è´¥"
        return 1
    fi
}
```

### 10.2 Docker Composeå¤šæœåŠ¡éƒ¨ç½²


**å¤šæœåŠ¡ç¼–æ’**ï¼šåº”ç”¨é€šå¸¸ä¸æ˜¯å•ç‹¬è¿è¡Œï¼Œéœ€è¦æ•°æ®åº“ã€ç¼“å­˜ç­‰æœåŠ¡ï¼ŒDocker Composeå¯ä»¥ç»Ÿä¸€ç®¡ç†ã€‚

```bash
# Docker Composeéƒ¨ç½²
deploy_with_compose() {
    local version="$1"
    
    info "ä½¿ç”¨Docker Composeéƒ¨ç½²å¤šæœåŠ¡ç¯å¢ƒ: $version"
    
    # ç”Ÿæˆdocker-compose.yml
    generate_compose_file "$version"
    
    # æ‹‰å–é•œåƒ
    info "æ‹‰å–Dockeré•œåƒ"
    docker-compose pull
    
    # æ„å»ºè‡ªå®šä¹‰é•œåƒ
    info "æ„å»ºåº”ç”¨é•œåƒ"
    docker-compose build
    
    # å¯åŠ¨æœåŠ¡
    info "å¯åŠ¨æœåŠ¡æ ˆ"
    if docker-compose up -d; then
        info "æœåŠ¡æ ˆå¯åŠ¨æˆåŠŸ"
        
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        sleep 30
        
        # æ£€æŸ¥æ‰€æœ‰æœåŠ¡çŠ¶æ€
        if check_compose_health; then
            info "Docker Composeéƒ¨ç½²æˆåŠŸ"
            return 0
        else
            error "æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥"
            return 1
        fi
    else
        error "æœåŠ¡æ ˆå¯åŠ¨å¤±è´¥"
        return 1
    fi
}

# ç”Ÿæˆdocker-compose.ymlæ–‡ä»¶
generate_compose_file() {
    local version="$1"
    
    info "ç”Ÿæˆdocker-compose.ymlæ–‡ä»¶"
    
    cat > docker-compose.yml << EOF
version: '3.8'

services:
  app:
    image: ${DOCKER_IMAGE}:${version}
    container_name: myapp-main
    restart: unless-stopped
    ports:
      - "80:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - DATABASE_URL=jdbc:mysql://db:3306/myapp
      - REDIS_URL=redis://redis:6379
    volumes:
      - ./logs:/app/logs
      - ./config:/app/config
    depends_on:
      - db
      - redis
    networks:
      - app-network

  db:
    image: mysql:8.0
    container_name: myapp-db
    restart: unless-stopped
    environment:
      - MYSQL_ROOT_PASSWORD=rootpassword
      - MYSQL_DATABASE=myapp
      - MYSQL_USER=appuser
      - MYSQL_PASSWORD=apppassword
    volumes:
      - mysql-data:/var/lib/mysql
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - app-network

  redis:
    image: redis:6-alpine
    container_name: myapp-redis
    restart: unless-stopped
    volumes:
      - redis-data:/data
    networks:
      - app-network

  nginx:
    image: nginx:alpine
    container_name: myapp-nginx
    restart: unless-stopped
    ports:
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - app
    networks:
      - app-network

volumes:
  mysql-data:
  redis-data:

networks:
  app-network:
    driver: bridge
EOF
}

# æ£€æŸ¥ComposeæœåŠ¡å¥åº·çŠ¶æ€
check_compose_health() {
    local services=("app" "db" "redis" "nginx")
    
    info "æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€"
    
    for service in "${services[@]}"; do
        if docker-compose ps "$service" | grep -q "Up"; then
            info "æœåŠ¡ $service è¿è¡Œæ­£å¸¸"
        else
            error "æœåŠ¡ $service è¿è¡Œå¼‚å¸¸"
            return 1
        fi
    done
    
    # æ£€æŸ¥åº”ç”¨æ˜¯å¦å“åº”
    if curl -f http://localhost/health > /dev/null 2>&1; then
        info "åº”ç”¨å¥åº·æ£€æŸ¥é€šè¿‡"
        return 0
    else
        error "åº”ç”¨å¥åº·æ£€æŸ¥å¤±è´¥"
        return 1
    fi
}
```

### 10.3 å®¹å™¨åŒ–å›æ»šæœºåˆ¶


```bash
# å®¹å™¨ç‰ˆæœ¬å›æ»š
rollback_container() {
    local target_version="$1"
    
    info "å›æ»šå®¹å™¨åˆ°ç‰ˆæœ¬: $target_version"
    
    # è·å–å½“å‰è¿è¡Œçš„å®¹å™¨ä¿¡æ¯
    local current_image=$(docker inspect "$CONTAINER_NAME" --format='{{.Config.Image}}' 2>/dev/null)
    
    if [ -n "$current_image" ]; then
        info "å½“å‰é•œåƒ: $current_image"
        
        # å¤‡ä»½å½“å‰å®¹å™¨ï¼ˆåˆ›å»ºé•œåƒå¿«ç…§ï¼‰
        local backup_tag="backup-$(date +%Y%m%d_%H%M%S)"
        docker commit "$CONTAINER_NAME" "${DOCKER_IMAGE}:${backup_tag}"
        info "å·²åˆ›å»ºå¤‡ä»½é•œåƒ: ${DOCKER_IMAGE}:${backup_tag}"
    fi
    
    # åœæ­¢å½“å‰å®¹å™¨
    docker stop "$CONTAINER_NAME" 2>/dev/null || true
    docker rm "$CONTAINER_NAME" 2>/dev/null || true
    
    # éƒ¨ç½²ç›®æ ‡ç‰ˆæœ¬
    if deploy_container "$target_version"; then
        info "å®¹å™¨å›æ»šæˆåŠŸ"
        send_notification "SUCCESS" "å®¹å™¨å›æ»šæˆåŠŸ" "å·²å›æ»šåˆ°ç‰ˆæœ¬: $target_version"
    else
        error "å®¹å™¨å›æ»šå¤±è´¥"
        send_notification "FAILED" "å®¹å™¨å›æ»šå¤±è´¥" "ç‰ˆæœ¬: $target_version"
    fi
}

# Docker Composeå›æ»š
rollback_compose() {
    local target_version="$1"
    
    info "Docker Composeå›æ»šåˆ°ç‰ˆæœ¬: $target_version"
    
    # æ›´æ–°composeæ–‡ä»¶
    generate_compose_file "$target_version"
    
    # æ‰§è¡Œæ»šåŠ¨æ›´æ–°
    if docker-compose up -d; then
        info "Docker Composeå›æ»šæˆåŠŸ"
    else
        error "Docker Composeå›æ»šå¤±è´¥"
    fi
}
```

---

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ”¸ è‡ªåŠ¨åŒ–éƒ¨ç½²æœ¬è´¨**ï¼š
- æ ‡å‡†åŒ–æ“ä½œæµç¨‹ï¼Œæ¶ˆé™¤äººå·¥å¹²é¢„
- æé«˜éƒ¨ç½²æ•ˆç‡å’Œè´¨é‡
- å®ç°å¿«é€Ÿäº¤ä»˜å’Œå¿«é€Ÿå›æ»š

**ğŸ”¸ éƒ¨ç½²è„šæœ¬è®¾è®¡åŸåˆ™**ï¼š
- æ¨¡å—åŒ–ï¼šæ¯ä¸ªåŠŸèƒ½ç‹¬ç«‹ï¼Œä¾¿äºç»´æŠ¤
- å¯é‡å¤ï¼šåŒæ ·çš„è„šæœ¬åœ¨ä»»ä½•ç¯å¢ƒéƒ½èƒ½å·¥ä½œ
- å®¹é”™æ€§ï¼šæ¯æ­¥éƒ½æœ‰é”™è¯¯å¤„ç†å’Œå›æ»šæœºåˆ¶

**ğŸ”¸ å…³é”®æŠ€æœ¯è¦ç´ **ï¼š
- ç¯å¢ƒæ£€æŸ¥ä¸é…ç½®è‡ªåŠ¨åŒ–
- ç‰ˆæœ¬æ§åˆ¶é›†æˆä¸æ„å»ºæµç¨‹
- æ—¥å¿—è®°å½•ä¸ç›‘æ§å‘Šè­¦
- è“ç»¿éƒ¨ç½²ä¸å®¹å™¨åŒ–æŠ€æœ¯

### 11.2 å®è·µç»éªŒæ€»ç»“


**ğŸ”¹ éƒ¨ç½²ç­–ç•¥é€‰æ‹©**ï¼š
```
æ¸è¿›å¼éƒ¨ç½²ï¼šé£é™©æœ€å°ï¼Œä½†é€Ÿåº¦è¾ƒæ…¢
è“ç»¿éƒ¨ç½²ï¼šå¿«é€Ÿåˆ‡æ¢ï¼Œéœ€è¦åŒå€èµ„æº
å®¹å™¨åŒ–éƒ¨ç½²ï¼šç¯å¢ƒä¸€è‡´ï¼Œæ˜“äºæ‰©å±•
```

**ğŸ”¹ é”™è¯¯å¤„ç†æœ€ä½³å®è·µ**ï¼š
- æ¯ä¸ªå…³é”®æ­¥éª¤éƒ½è¦æœ‰æ£€æŸ¥ç‚¹
- å¤±è´¥æ—¶è‡ªåŠ¨å›æ»šï¼Œä¸å½±å“çº¿ä¸ŠæœåŠ¡
- è¯¦ç»†è®°å½•é”™è¯¯ä¿¡æ¯ï¼Œä¾¿äºæ’æŸ¥

**ğŸ”¹ ç›‘æ§å‘Šè­¦è¦ç‚¹**ï¼š
- éƒ¨ç½²è¿‡ç¨‹å®æ—¶ç›‘æ§
- æˆåŠŸå¤±è´¥åŠæ—¶é€šçŸ¥
- æ€§èƒ½æŒ‡æ ‡æŒç»­æ”¶é›†

### 11.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ’¼ ä¼ä¸šåº”ç”¨åœºæ™¯**ï¼š
- **äº’è”ç½‘å…¬å¸**ï¼šæ”¯æŒé¢‘ç¹å‘ç‰ˆï¼Œæå‡äº¤ä»˜æ•ˆç‡
- **ä¼ ç»Ÿä¼ä¸š**ï¼šå‡å°‘éƒ¨ç½²é£é™©ï¼Œæé«˜ç³»ç»Ÿç¨³å®šæ€§
- **å°å›¢é˜Ÿ**ï¼šé™ä½è¿ç»´æˆæœ¬ï¼Œä¸“æ³¨ä¸šåŠ¡å¼€å‘

**ğŸš€ æŠ€èƒ½å‘å±•è·¯å¾„**ï¼š
1. **åŸºç¡€é˜¶æ®µ**ï¼šæŒæ¡Shellè„šæœ¬å’ŒåŸºæœ¬éƒ¨ç½²æµç¨‹
2. **è¿›é˜¶é˜¶æ®µ**ï¼šå­¦ä¹ å®¹å™¨æŠ€æœ¯å’ŒCI/CDé›†æˆ
3. **é«˜çº§é˜¶æ®µ**ï¼šè®¾è®¡ä¼ä¸šçº§éƒ¨ç½²å¹³å°

### 11.4 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ


**ğŸ”§ éƒ¨ç½²å¤±è´¥é—®é¢˜æ’æŸ¥**ï¼š
- æ£€æŸ¥ç¯å¢ƒä¾èµ–å’Œæƒé™
- æŸ¥çœ‹è¯¦ç»†æ—¥å¿—å®šä½é”™è¯¯ç‚¹
- éªŒè¯é…ç½®æ–‡ä»¶å’Œç¯å¢ƒå˜é‡
- ç¡®è®¤ç½‘ç»œè¿æ¥å’Œç«¯å£çŠ¶æ€

**âš ï¸ å®‰å…¨æ³¨æ„äº‹é¡¹**ï¼š
- SSHå¯†é’¥æƒé™è®¾ç½®ä¸º600
- æ•æ„Ÿä¿¡æ¯ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–å¯†é’¥ç®¡ç†
- å®šæœŸè½®æ¢éƒ¨ç½²å¯†é’¥
- å®¡è®¡éƒ¨ç½²æ“ä½œæ—¥å¿—

**ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®**ï¼š
- å¹¶è¡Œæ‰§è¡Œæå‡æ•ˆç‡
- å¢é‡éƒ¨ç½²å‡å°‘ä¼ è¾“é‡
- æœ¬åœ°ç¼“å­˜å‡å°‘ä¸‹è½½æ—¶é—´
- é¢„çƒ­æœºåˆ¶æå‡é¦–æ¬¡è®¿é—®é€Ÿåº¦

### 11.5 è¿›é˜¶å­¦ä¹ æ–¹å‘


**ğŸ”„ CI/CDé›†æˆ**ï¼š
- Jenkinsã€GitLab CIé›†æˆ
- ä»£ç è´¨é‡æ£€æŸ¥è‡ªåŠ¨åŒ–
- è‡ªåŠ¨åŒ–æµ‹è¯•é›†æˆ
- å‘å¸ƒæµæ°´çº¿è®¾è®¡

**â˜ï¸ äº‘åŸç”Ÿéƒ¨ç½²**ï¼š
- Kuberneteså®¹å™¨ç¼–æ’
- Helm ChartåŒ…ç®¡ç†
- IstioæœåŠ¡ç½‘æ ¼
- äº‘å¹³å°éƒ¨ç½²å·¥å…·

**ğŸ“Š å¯è§‚æµ‹æ€§**ï¼š
- Prometheusç›‘æ§æŒ‡æ ‡
- ELKæ—¥å¿—åˆ†ææ ˆ
- Grafanaå¯è§†åŒ–é¢æ¿
- åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª

**ğŸ›¡ï¸ å®‰å…¨åŠ å›º**ï¼š
- å®¹å™¨é•œåƒå®‰å…¨æ‰«æ
- ç½‘ç»œç­–ç•¥é…ç½®
- å¯†é’¥ç®¡ç†æœ€ä½³å®è·µ
- è®¿é—®æ§åˆ¶å’Œå®¡è®¡

### 11.6 å®ç”¨å·¥å…·æ¨è


| **å·¥å…·ç±»å‹** | **æ¨èå·¥å…·** | **é€‚ç”¨åœºæ™¯** | **å­¦ä¹ éš¾åº¦** |
|------------|------------|------------|------------|
| **Shellå¢å¼º** | `bash-completion` `shellcheck` | æå‡è„šæœ¬è´¨é‡ | â­â­ |
| **è¿œç¨‹ç®¡ç†** | `ansible` `fabric` | æ‰¹é‡æœåŠ¡å™¨ç®¡ç† | â­â­â­ |
| **å®¹å™¨å·¥å…·** | `docker` `docker-compose` | å®¹å™¨åŒ–éƒ¨ç½² | â­â­â­ |
| **ç›‘æ§å·¥å…·** | `supervisor` `systemd` | æœåŠ¡ç›‘æ§ | â­â­ |
| **æ—¥å¿—åˆ†æ** | `logrotate` `rsyslog` | æ—¥å¿—ç®¡ç† | â­â­ |

**ğŸ¯ æ ¸å¿ƒè®°å¿†**ï¼š
- è‡ªåŠ¨åŒ–éƒ¨ç½²æ˜¯ç°ä»£è½¯ä»¶äº¤ä»˜çš„åŸºç¡€èƒ½åŠ›
- è„šæœ¬åŒ–ã€æ ‡å‡†åŒ–ã€ç›‘æ§åŒ–æ˜¯ä¸‰å¤§æ ¸å¿ƒè¦ç´   
- ä»ç®€å•è„šæœ¬åˆ°å¤æ‚å¹³å°ï¼Œå¾ªåºæ¸è¿›å­¦ä¹ 
- å®è·µæ˜¯æŒæ¡éƒ¨ç½²æŠ€æœ¯çš„æœ€å¥½æ–¹å¼

**ğŸ“ å­¦ä¹ å»ºè®®**ï¼š
1. **åŠ¨æ‰‹å®è·µ**ï¼šæ­å»ºæµ‹è¯•ç¯å¢ƒï¼Œç¼–å†™éƒ¨ç½²è„šæœ¬
2. **é˜…è¯»æºç **ï¼šå­¦ä¹ ä¼˜ç§€å¼€æºé¡¹ç›®çš„éƒ¨ç½²æ–¹æ¡ˆ
3. **å…³æ³¨è¶‹åŠ¿**ï¼šäº†è§£äº‘åŸç”Ÿå’ŒDevOpsæœ€æ–°å‘å±•
4. **ç»éªŒåˆ†äº«**ï¼šå‚ä¸æŠ€æœ¯ç¤¾åŒºï¼Œåˆ†äº«å®è·µç»éªŒ

> ğŸ’¡ **æ¸©é¦¨æç¤º**ï¼šéƒ¨ç½²å·¥å…·çš„æ ¸å¿ƒä¸åœ¨äºæŠ€æœ¯å¤æ‚åº¦ï¼Œè€Œåœ¨äºè§£å†³å®é™…é—®é¢˜ã€‚ä»ç®€å•çš„è„šæœ¬å¼€å§‹ï¼Œé€æ­¥å®Œå–„åŠŸèƒ½ï¼Œæœ€ç»ˆå½¢æˆé€‚åˆå›¢é˜Ÿçš„éƒ¨ç½²ä½“ç³»ã€‚è®°ä½ï¼šæœ€å¥½çš„éƒ¨ç½²å·¥å…·æ˜¯èƒ½ç¨³å®šå·¥ä½œã€æ˜“äºç»´æŠ¤çš„å·¥å…·ï¼