---
title: 3ã€æ¥å£å®‰å…¨ç­–ç•¥
---
## ğŸ“š ç›®å½•

1. [æ¥å£å®‰å…¨ç­–ç•¥æ¦‚è¿°](#1-æ¥å£å®‰å…¨ç­–ç•¥æ¦‚è¿°)
2. [ç­¾åéªŒè¯é˜²ç¯¡æ”¹](#2-ç­¾åéªŒè¯é˜²ç¯¡æ”¹)
3. [é¢‘ç‡æ§åˆ¶é˜²æ»¥ç”¨](#3-é¢‘ç‡æ§åˆ¶é˜²æ»¥ç”¨)
4. [è®¿é—®æ§åˆ¶ç­–ç•¥](#4-è®¿é—®æ§åˆ¶ç­–ç•¥)
5. [å®‰å…¨é…ç½®ä¼˜åŒ–](#5-å®‰å…¨é…ç½®ä¼˜åŒ–)
6. [æ¥å£å¹‚ç­‰æ€§ä¿éšœ](#6-æ¥å£å¹‚ç­‰æ€§ä¿éšœ)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ›¡ï¸ æ¥å£å®‰å…¨ç­–ç•¥æ¦‚è¿°


### 1.1 ä¸ºä»€ä¹ˆéœ€è¦æ¥å£å®‰å…¨é˜²æŠ¤


æƒ³è±¡ä¸€ä¸‹ï¼Œä½ å®¶çš„é—¨å¦‚æœæ²¡æœ‰é”ï¼Œä»»ä½•äººéƒ½å¯ä»¥éšä¾¿è¿›å‡ºï¼Œè¿™å°±æ˜¯æ²¡æœ‰å®‰å…¨é˜²æŠ¤çš„æ¥å£ã€‚

**ğŸ¯ æ¥å£é¢ä¸´çš„ä¸»è¦å¨èƒ**ï¼š

```
æ¥å£å®‰å…¨å¨èƒå…¨æ™¯å›¾ï¼š

æ¶æ„ç”¨æˆ· â”€â”€â”€â”€â”
            â”‚
åƒåœ¾è¯·æ±‚ â”€â”€â”€â”€â”¼â”€â”€â”€â†’ [ä½ çš„APIæ¥å£] â”€â”€â”€â†’ æœåŠ¡å™¨å´©æºƒ
            â”‚                      â†“
å‚æ•°ç¯¡æ”¹ â”€â”€â”€â”€â”˜                   æ•°æ®æ³„éœ²
                                 â†“
                              ä¸šåŠ¡æŸå¤±
```

> **ğŸ’¡ ç®€å•ç†è§£**ï¼šæ¥å£å®‰å…¨å°±åƒç»™ä½ çš„APIè£…ä¸Šå„ç§"å®‰å…¨é”"ï¼Œè®©åäººè¿›ä¸æ¥ï¼Œå¥½äººç”¨å¾—çˆ½ã€‚

**ğŸ”¸ å¸¸è§çš„æ¥å£æ”»å‡»æ–¹å¼**ï¼š

| **æ”»å‡»ç±»å‹** | **ç”Ÿæ´»æ¯”å–»** | **æŠ€æœ¯è¡¨ç°** | **å±å®³åæœ** |
|-------------|-------------|-------------|-------------|
| **å‚æ•°ç¯¡æ”¹** | `ä¼ªé€ èº«ä»½è¯` | `ä¿®æ”¹è¯·æ±‚å‚æ•°è·å–ä»–äººæ•°æ®` | `æ•°æ®æ³„éœ²ã€è¶Šæƒè®¿é—®` |
| **æ¥å£åˆ·é‡** | `é»„ç‰›æŠ¢ç¥¨` | `çŸ­æ—¶é—´å¤§é‡è¯·æ±‚åŒä¸€æ¥å£` | `æœåŠ¡å™¨å‹å®ã€æ­£å¸¸ç”¨æˆ·æ— æ³•ä½¿ç”¨` |
| **æ¶æ„è°ƒç”¨** | `éªšæ‰°ç”µè¯` | `é¢‘ç¹è°ƒç”¨æ¶ˆè€—èµ„æºçš„æ¥å£` | `æœåŠ¡å™¨èµ„æºè€—å°½` |
| **ä¿¡æ¯æ¢æµ‹** | `è¸©ç‚¹ä¾¦æŸ¥` | `é€šè¿‡é”™è¯¯ä¿¡æ¯äº†è§£ç³»ç»Ÿå†…éƒ¨` | `æš´éœ²ç³»ç»Ÿæ¶æ„å’Œæ¼æ´` |

### 1.2 å®‰å…¨é˜²æŠ¤çš„æ ¸å¿ƒåŸåˆ™


**ğŸ° ä¸‰å±‚é˜²æŠ¤ä½“ç³»**ï¼š

```
APIå®‰å…¨é˜²æŠ¤ä¸‰å±‚æ¶æ„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ç¬¬ä¸€å±‚ï¼šé—¨å«æ£€æŸ¥                      â”‚
â”‚  IPç™½åå• â”‚ è¯·æ±‚é¢‘ç‡æ£€æŸ¥ â”‚ è¯·æ±‚å¤§å°æ£€æŸ¥ â”‚ åŸºç¡€éªŒè¯     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  ç¬¬äºŒå±‚ï¼šèº«ä»½æ ¸å®                      â”‚
â”‚  ç­¾åéªŒè¯ â”‚ ä»¤ç‰Œæ£€æŸ¥ â”‚ æƒé™éªŒè¯ â”‚ å‚æ•°å®Œæ•´æ€§æ£€æŸ¥       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  ç¬¬ä¸‰å±‚ï¼šè¡Œä¸ºç›‘æ§                      â”‚
â”‚  æ“ä½œæ—¥å¿— â”‚ å¼‚å¸¸ç›‘æ§ â”‚ å¹‚ç­‰æ€§æ£€æŸ¥ â”‚ ç»“æœè¿‡æ»¤         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. âœï¸ ç­¾åéªŒè¯é˜²ç¯¡æ”¹


### 2.1 ä»€ä¹ˆæ˜¯æ¥å£ç­¾å


**ğŸ” ç­¾åå°±åƒ"é˜²ä¼ªæ ‡ç­¾"**

æƒ³è±¡ä½ ç½‘è´­æ—¶ï¼ŒåŒ…è£¹ä¸Šçš„å°æ¡å¦‚æœè¢«æ’•å¼€ï¼Œä½ å°±çŸ¥é“æœ‰äººåŠ¨è¿‡ä½ çš„åŒ…è£¹ã€‚æ¥å£ç­¾åå°±æ˜¯è¿™ä¸ª"é˜²ä¼ªå°æ¡"ã€‚

```
ç­¾åéªŒè¯åŸç†å›¾ï¼š

å®¢æˆ·ç«¯å‘é€è¯·æ±‚ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åŸå§‹å‚æ•°: name=å¼ ä¸‰&age=25&action=query          â”‚
â”‚         â†“                                       â”‚
â”‚ åŠ å¯†ç®—æ³•: MD5/SHA256                             â”‚
â”‚         â†“                                       â”‚
â”‚ ç”Ÿæˆç­¾å: sign=a1b2c3d4e5f6...                   â”‚
â”‚         â†“                                       â”‚
â”‚ å®Œæ•´è¯·æ±‚: name=å¼ ä¸‰&age=25&action=query&sign=... â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“ ç½‘ç»œä¼ è¾“
æœåŠ¡ç«¯æ¥æ”¶éªŒè¯ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æå–å‚æ•°: name=å¼ ä¸‰&age=25&action=query       â”‚
â”‚ 2. ç”¨åŒæ ·ç®—æ³•é‡æ–°è®¡ç®—ç­¾å                         â”‚
â”‚ 3. å¯¹æ¯”ç­¾åæ˜¯å¦ä¸€è‡´                              â”‚
â”‚ 4. ä¸€è‡´â†’å¤„ç†è¯·æ±‚ï¼Œä¸ä¸€è‡´â†’æ‹’ç»è¯·æ±‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ç­¾åéªŒè¯å®ç°


**ğŸ”§ åŸºç¡€ç­¾åå®ç°**ï¼š

```java
// å®¢æˆ·ç«¯ç”Ÿæˆç­¾å
public class SignatureUtil {
    private static final String SECRET_KEY = "your-secret-key";
    
    // ç”Ÿæˆç­¾åçš„æ ¸å¿ƒæ–¹æ³•
    public static String generateSign(Map<String, String> params) {
        // 1. å‚æ•°æ’åºï¼ˆä¿è¯é¡ºåºä¸€è‡´ï¼‰
        TreeMap<String, String> sortedParams = new TreeMap<>(params);
        
        // 2. æ‹¼æ¥å‚æ•°å­—ç¬¦ä¸²
        StringBuilder sb = new StringBuilder();
        for (Map.Entry<String, String> entry : sortedParams.entrySet()) {
            sb.append(entry.getKey()).append("=").append(entry.getValue()).append("&");
        }
        
        // 3. åŠ ä¸Šå¯†é’¥
        String paramString = sb.toString() + "key=" + SECRET_KEY;
        
        // 4. MD5åŠ å¯†
        return MD5.encode(paramString).toUpperCase();
    }
}

// ä½¿ç”¨ç¤ºä¾‹
Map<String, String> params = new HashMap<>();
params.put("username", "zhangsan");
params.put("age", "25");
params.put("timestamp", "1634567890");

String signature = SignatureUtil.generateSign(params);
// æœ€ç»ˆè¯·æ±‚ï¼š/api/user?username=zhangsan&age=25&timestamp=1634567890&sign=ABC123...
```

**ğŸ› ï¸ æœåŠ¡ç«¯éªŒè¯**ï¼š

```java
// æœåŠ¡ç«¯ç­¾åéªŒè¯
@RestController
public class UserController {
    
    @PostMapping("/api/user")
    public Result getUser(@RequestParam Map<String, String> params) {
        // 1. æå–å®¢æˆ·ç«¯ä¼ æ¥çš„ç­¾å
        String clientSign = params.remove("sign");
        
        // 2. ç”¨å‰©ä½™å‚æ•°é‡æ–°è®¡ç®—ç­¾å
        String serverSign = SignatureUtil.generateSign(params);
        
        // 3. å¯¹æ¯”ç­¾å
        if (!serverSign.equals(clientSign)) {
            return Result.error("ç­¾åéªŒè¯å¤±è´¥");
        }
        
        // 4. æ£€æŸ¥æ—¶é—´æˆ³ï¼ˆé˜²é‡æ”¾æ”»å‡»ï¼‰
        long timestamp = Long.parseLong(params.get("timestamp"));
        if (System.currentTimeMillis() - timestamp > 300000) { // 5åˆ†é’Ÿè¿‡æœŸ
            return Result.error("è¯·æ±‚å·²è¿‡æœŸ");
        }
        
        // 5. å¤„ç†æ­£å¸¸ä¸šåŠ¡
        return Result.success("éªŒè¯é€šè¿‡");
    }
}
```

> **ğŸ’¡ å…³é”®è¦ç‚¹**ï¼š
> - **å‚æ•°æ’åº**ï¼šä¿è¯å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯è®¡ç®—ç­¾åæ—¶é¡ºåºä¸€è‡´
> - **æ—¶é—´æˆ³**ï¼šé˜²æ­¢åˆ«äººé‡å¤ä½¿ç”¨ä½ çš„è¯·æ±‚ï¼ˆé‡æ”¾æ”»å‡»ï¼‰
> - **å¯†é’¥ä¿æŠ¤**ï¼šSecret Keyç»å¯¹ä¸èƒ½æ³„éœ²ï¼Œå°±åƒé“¶è¡Œå¡å¯†ç 

### 2.3 ç­¾åå®‰å…¨å¢å¼º


**â° æ—¶é—´æˆ³é˜²é‡æ”¾**ï¼š

```java
// å¢å¼ºç‰ˆç­¾åéªŒè¯
public class EnhancedSignature {
    
    // ç”Ÿæˆå¸¦æ—¶é—´æˆ³å’Œéšæœºæ•°çš„ç­¾å
    public static String generateSecureSign(Map<String, String> params) {
        // æ·»åŠ æ—¶é—´æˆ³
        params.put("timestamp", String.valueOf(System.currentTimeMillis()));
        
        // æ·»åŠ éšæœºæ•°ï¼ˆé˜²æ­¢åŒä¸€æ—¶é—´ç›¸åŒå‚æ•°çš„é‡å¤è¯·æ±‚ï¼‰
        params.put("nonce", UUID.randomUUID().toString().replace("-", ""));
        
        return SignatureUtil.generateSign(params);
    }
}
```

---

## 3. ğŸš¦ é¢‘ç‡æ§åˆ¶é˜²æ»¥ç”¨


### 3.1 ä»€ä¹ˆæ˜¯æ¥å£é™æµ


**ğŸš° é™æµå°±åƒæ°´é¾™å¤´æ§åˆ¶æ°´æµ**

æƒ³è±¡ä¸€ä¸ªæ°´ç®¡ï¼Œå¦‚æœæ°´æµå¤ªå¤§ä¼šæŠŠç®¡å­å†²ç ´ã€‚æ¥å£é™æµå°±æ˜¯ç»™APIè£…ä¸ª"æ°´é¾™å¤´"ï¼Œæ§åˆ¶è¯·æ±‚çš„æµé‡ã€‚

```
é™æµåŸç†ç¤ºæ„å›¾ï¼š

æ­£å¸¸æƒ…å†µï¼š
ç”¨æˆ·è¯·æ±‚ â”€â”€â†’ [é™æµå™¨: âœ“ é€šè¿‡] â”€â”€â†’ APIæœåŠ¡å™¨ â”€â”€â†’ æ­£å¸¸å“åº”

è¶…å‡ºé™åˆ¶ï¼š
ç”¨æˆ·è¯·æ±‚ â”€â”€â†’ [é™æµå™¨: âœ— æ‹¦æˆª] â”€â”€X  APIæœåŠ¡å™¨
          â†“
      è¿”å›ï¼šè¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•
```

### 3.2 å¸¸è§é™æµç­–ç•¥


**ğŸ¯ å››ç§é™æµç®—æ³•å¯¹æ¯”**ï¼š

| **ç®—æ³•åç§°** | **ç”Ÿæ´»æ¯”å–»** | **é€‚ç”¨åœºæ™¯** | **ä¼˜ç¼ºç‚¹** |
|-------------|-------------|-------------|-----------|
| **å›ºå®šçª—å£** | `æ¯å°æ—¶é™é€Ÿ100å…¬é‡Œ` | `ç®€å•è®¡æ•°é™åˆ¶` | `ç®€å•ä½†å¯èƒ½çªåˆº` |
| **æ»‘åŠ¨çª—å£** | `æœ€è¿‘1å°æ—¶å†…ä¸è¶…100å…¬é‡Œ` | `å¹³æ»‘é™æµ` | `å†…å­˜å ç”¨è¾ƒå¤§` |
| **ä»¤ç‰Œæ¡¶** | `é“¶è¡Œå–å·æœºåˆ¶` | `å…è®¸çªå‘æµé‡` | `å®ç°å¤æ‚` |
| **æ¼æ¡¶** | `æ¼æ–—å€’æ°´` | `æµé‡æ•´å½¢` | `ä¸å…è®¸çªå‘` |

**ğŸ’¡ å›ºå®šçª—å£é™æµï¼ˆæœ€ç®€å•ï¼‰**ï¼š

```java
// åŸºäºRedisçš„ç®€å•é™æµ
@Component
public class RateLimiter {
    
    @Autowired
    private RedisTemplate<String, String> redis;
    
    /**
     * æ£€æŸ¥æ˜¯å¦è¶…å‡ºé™æµ
     * @param key é™æµçš„é”®ï¼ˆæ¯”å¦‚ç”¨æˆ·IDã€IPåœ°å€ï¼‰
     * @param limit é™åˆ¶æ¬¡æ•°
     * @param window æ—¶é—´çª—å£ï¼ˆç§’ï¼‰
     */
    public boolean isAllowed(String key, int limit, int window) {
        String redisKey = "rate_limit:" + key;
        
        // è·å–å½“å‰è®¡æ•°
        String count = redis.opsForValue().get(redisKey);
        
        if (count == null) {
            // ç¬¬ä¸€æ¬¡è¯·æ±‚ï¼Œè®¾ç½®è®¡æ•°ä¸º1ï¼Œè¿‡æœŸæ—¶é—´ä¸ºwindowç§’
            redis.opsForValue().set(redisKey, "1", window, TimeUnit.SECONDS);
            return true;
        } else {
            int currentCount = Integer.parseInt(count);
            if (currentCount < limit) {
                // æœªè¾¾åˆ°é™åˆ¶ï¼Œè®¡æ•°+1
                redis.opsForValue().increment(redisKey);
                return true;
            } else {
                // è¶…å‡ºé™åˆ¶
                return false;
            }
        }
    }
}

// åœ¨Controllerä¸­ä½¿ç”¨
@RestController
public class ApiController {
    
    @Autowired
    private RateLimiter rateLimiter;
    
    @GetMapping("/api/data")
    public Result getData(HttpServletRequest request) {
        String clientIP = getClientIP(request);
        
        // æ¯ä¸ªIPæ¯åˆ†é’Ÿæœ€å¤š10æ¬¡è¯·æ±‚
        if (!rateLimiter.isAllowed(clientIP, 10, 60)) {
            return Result.error("è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•");
        }
        
        // æ­£å¸¸å¤„ç†ä¸šåŠ¡
        return Result.success("æ•°æ®è·å–æˆåŠŸ");
    }
}
```

### 3.3 å¤šå±‚é™æµç­–ç•¥


**ğŸ¢ åˆ†å±‚é™æµè®¾è®¡**ï¼š

```java
// å¤šç»´åº¦é™æµ
@Component
public class MultiDimensionRateLimit {
    
    // å…¨å±€é™æµï¼šä¿æŠ¤æ•´ä¸ªç³»ç»Ÿ
    public boolean checkGlobalLimit(String api) {
        return rateLimiter.isAllowed("global:" + api, 1000, 60); // æ¯åˆ†é’Ÿ1000æ¬¡
    }
    
    // ç”¨æˆ·é™æµï¼šé˜²æ­¢å•ä¸ªç”¨æˆ·æ»¥ç”¨
    public boolean checkUserLimit(String userId, String api) {
        return rateLimiter.isAllowed("user:" + userId + ":" + api, 100, 60); // æ¯åˆ†é’Ÿ100æ¬¡
    }
    
    // IPé™æµï¼šé˜²æ­¢æ¶æ„IPæ”»å‡»
    public boolean checkIPLimit(String ip, String api) {
        return rateLimiter.isAllowed("ip:" + ip + ":" + api, 200, 60); // æ¯åˆ†é’Ÿ200æ¬¡
    }
    
    // æ¥å£é™æµï¼šä¿æŠ¤é‡è¦æ¥å£
    public boolean checkAPILimit(String api) {
        return rateLimiter.isAllowed("api:" + api, 500, 60); // æ¯åˆ†é’Ÿ500æ¬¡
    }
}
```

---

## 4. ğŸ”’ è®¿é—®æ§åˆ¶ç­–ç•¥


### 4.1 IPç™½åå•ä¸é»‘åå•


**ğŸšª IPæ§åˆ¶å°±åƒé—¨å«ç®¡ç†**

- **ç™½åå•**ï¼šåªå…è®¸åå•ä¸Šçš„äººè¿›å…¥ï¼ˆVIPé€šé“ï¼‰
- **é»‘åå•**ï¼šç¦æ­¢åå•ä¸Šçš„äººè¿›å…¥ï¼ˆé»‘æˆ·æ‹¦æˆªï¼‰

```java
// IPè®¿é—®æ§åˆ¶
@Component
public class IPAccessControl {
    
    // ç™½åå•ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
    private Set<String> whitelist = new HashSet<>(Arrays.asList(
        "192.168.1.100",    // åŠå…¬ç½‘IP
        "10.0.0.50",        // æœåŠ¡å™¨IP
        "123.456.789.0"     // åˆä½œä¼™ä¼´IP
    ));
    
    // é»‘åå•
    private Set<String> blacklist = new HashSet<>();
    
    public boolean isAccessAllowed(String clientIP) {
        // 1. å…ˆæ£€æŸ¥ç™½åå•ï¼ˆç™½åå•ç›´æ¥é€šè¿‡ï¼‰
        if (whitelist.contains(clientIP)) {
            return true;
        }
        
        // 2. å†æ£€æŸ¥é»‘åå•ï¼ˆé»‘åå•ç›´æ¥æ‹’ç»ï¼‰
        if (blacklist.contains(clientIP)) {
            return false;
        }
        
        // 3. ä¸åœ¨ä»»ä½•åå•ä¸­çš„IPï¼Œæ‰§è¡Œå…¶ä»–æ£€æŸ¥
        return checkOtherRules(clientIP);
    }
    
    // åŠ¨æ€æ·»åŠ åˆ°é»‘åå•ï¼ˆæ¯”å¦‚æ£€æµ‹åˆ°æ¶æ„è¡Œä¸ºï¼‰
    public void addToBlacklist(String ip, String reason) {
        blacklist.add(ip);
        log.warn("IP {} è¢«åŠ å…¥é»‘åå•ï¼ŒåŸå› ï¼š{}", ip, reason);
    }
}
```

### 4.2 è¯·æ±‚å¤§å°é™åˆ¶


**ğŸ“¦ æ§åˆ¶è¯·æ±‚å¤§å°é˜²æ­¢æ”»å‡»**

```java
// è¯·æ±‚å¤§å°æ£€æŸ¥
@Component
public class RequestSizeChecker {
    
    private static final long MAX_REQUEST_SIZE = 10 * 1024 * 1024; // 10MB
    
    public boolean checkRequestSize(HttpServletRequest request) {
        long contentLength = request.getContentLengthLong();
        
        if (contentLength > MAX_REQUEST_SIZE) {
            log.warn("è¯·æ±‚å¤§å°è¶…é™ï¼š{}bytesï¼Œæœ€å¤§å…è®¸ï¼š{}bytes", 
                contentLength, MAX_REQUEST_SIZE);
            return false;
        }
        
        return true;
    }
}

// åœ¨æ‹¦æˆªå™¨ä¸­ä½¿ç”¨
@Component
public class SecurityInterceptor implements HandlerInterceptor {
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler) throws Exception {
        
        // æ£€æŸ¥è¯·æ±‚å¤§å°
        if (!requestSizeChecker.checkRequestSize(request)) {
            response.setStatus(413); // Request Entity Too Large
            response.getWriter().write("è¯·æ±‚å†…å®¹è¿‡å¤§");
            return false;
        }
        
        return true;
    }
}
```

---

## 5. âš™ï¸ å®‰å…¨é…ç½®ä¼˜åŒ–


### 5.1 è¶…æ—¶è®¾ç½®é˜²èµ„æºå ç”¨


**â±ï¸ è¶…æ—¶è®¾ç½®å°±åƒ"è‡ªåŠ¨æ–­ç”µå™¨"**

æƒ³è±¡ä½ å®¶çš„ç”µå™¨æœ‰è‡ªåŠ¨æ–­ç”µä¿æŠ¤ï¼Œé¿å…é•¿æ—¶é—´å·¥ä½œæŸåã€‚æ¥å£è¶…æ—¶è®¾ç½®ä¹Ÿæ˜¯è¿™ä¸ªé“ç†ã€‚

```java
// æ¥å£è¶…æ—¶é…ç½®
@RestController
public class TimeoutController {
    
    @GetMapping("/api/slow-operation")
    public Result slowOperation() {
        // è®¾ç½®æ–¹æ³•çº§åˆ«è¶…æ—¶
        return executeWithTimeout(() -> {
            // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
            Thread.sleep(5000);
            return "æ“ä½œå®Œæˆ";
        }, 3000); // 3ç§’è¶…æ—¶
    }
    
    private Result executeWithTimeout(Callable<String> task, long timeoutMs) {
        ExecutorService executor = Executors.newSingleThreadExecutor();
        Future<String> future = executor.submit(task);
        
        try {
            String result = future.get(timeoutMs, TimeUnit.MILLISECONDS);
            return Result.success(result);
        } catch (TimeoutException e) {
            future.cancel(true); // å–æ¶ˆä»»åŠ¡
            return Result.error("æ“ä½œè¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•");
        } catch (Exception e) {
            return Result.error("æ“ä½œå¤±è´¥");
        } finally {
            executor.shutdown();
        }
    }
}
```

### 5.2 é”™è¯¯ä¿¡æ¯å®‰å…¨å¤„ç†


**ğŸ¤ é”™è¯¯ä¿¡æ¯è¦"è—ä¸€æ‰‹"**

> **å±é™©ç¤ºä¾‹**ï¼šâŒ 
> ```json
> {
>   "error": "SQLé”™è¯¯ï¼šTable 'users' doesn't exist in database 'company_db'"
> }
> ```

> **å®‰å…¨ç¤ºä¾‹**ï¼šâœ…
> ```json
> {
>   "error": "ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•",
>   "code": "SYS_ERROR_001"
> }
> ```

```java
// å®‰å…¨çš„é”™è¯¯å¤„ç†
@ControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(Exception.class)
    public Result handleException(Exception e, HttpServletRequest request) {
        String requestId = UUID.randomUUID().toString();
        
        // è¯¦ç»†é”™è¯¯è®°å½•åˆ°æ—¥å¿—ï¼ˆå¼€å‘äººå‘˜çœ‹ï¼‰
        log.error("è¯·æ±‚å¼‚å¸¸ [{}] URI:{} Error:", 
            requestId, request.getRequestURI(), e);
        
        // è¿”å›ç»™ç”¨æˆ·çš„å®‰å…¨ä¿¡æ¯ï¼ˆç”¨æˆ·çœ‹ï¼‰
        if (e instanceof BusinessException) {
            // ä¸šåŠ¡å¼‚å¸¸å¯ä»¥æ˜¾ç¤ºå…·ä½“ä¿¡æ¯
            return Result.error(e.getMessage());
        } else {
            // ç³»ç»Ÿå¼‚å¸¸åªæ˜¾ç¤ºé€šç”¨ä¿¡æ¯
            return Result.error("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•")
                        .setTraceId(requestId); // æä¾›è¿½è¸ªIDä¾¿äºæ’æŸ¥
        }
    }
}
```

---

## 6. ğŸ”„ æ¥å£å¹‚ç­‰æ€§ä¿éšœ


### 6.1 ä»€ä¹ˆæ˜¯æ¥å£å¹‚ç­‰æ€§


**ğŸ¯ å¹‚ç­‰æ€§çš„é€šä¿—è§£é‡Š**

å¹‚ç­‰æ€§å°±åƒæŒ‰ç”µæ¢¯æŒ‰é’®ï¼Œæ— è®ºä½ æŒ‰1æ¬¡è¿˜æ˜¯æŒ‰10æ¬¡ï¼Œç”µæ¢¯éƒ½åªä¼šæ¥1æ¬¡ã€‚

```
å¹‚ç­‰æ€§ç¤ºä¾‹å¯¹æ¯”ï¼š

âŒ éå¹‚ç­‰æ“ä½œï¼š
æ¯æ¬¡è°ƒç”¨ /api/account/deposit?amount=100
è´¦æˆ·ä½™é¢ï¼š1000 â†’ 1100 â†’ 1200 â†’ 1300 (æ¯æ¬¡éƒ½å¢åŠ )

âœ… å¹‚ç­‰æ“ä½œï¼š
æ¯æ¬¡è°ƒç”¨ /api/account/set-balance?amount=1100&token=abc123
è´¦æˆ·ä½™é¢ï¼š1000 â†’ 1100 â†’ 1100 â†’ 1100 (é‡å¤è°ƒç”¨ç»“æœç›¸åŒ)
```

### 6.2 å¹‚ç­‰ä»¤ç‰Œå®ç°


**ğŸ« å¹‚ç­‰ä»¤ç‰Œå°±åƒ"ç”µå½±ç¥¨"**

ä¸€å¼ ç”µå½±ç¥¨åªèƒ½çœ‹ä¸€æ¬¡ç”µå½±ï¼Œç”¨è¿‡å°±åºŸäº†ã€‚

```java
// å¹‚ç­‰ä»¤ç‰Œç®¡ç†
@Service
public class IdempotentTokenService {
    
    @Autowired
    private RedisTemplate<String, String> redis;
    
    // ç”Ÿæˆå¹‚ç­‰ä»¤ç‰Œ
    public String generateToken(String userId) {
        String token = UUID.randomUUID().toString();
        String key = "idempotent:" + userId + ":" + token;
        
        // ä»¤ç‰Œ5åˆ†é’Ÿæœ‰æ•ˆæœŸ
        redis.opsForValue().set(key, "1", 300, TimeUnit.SECONDS);
        
        return token;
    }
    
    // æ¶ˆè´¹å¹‚ç­‰ä»¤ç‰Œï¼ˆä¸€æ¬¡æ€§ä½¿ç”¨ï¼‰
    public boolean consumeToken(String userId, String token) {
        String key = "idempotent:" + userId + ":" + token;
        
        // å°è¯•åˆ é™¤ä»¤ç‰Œï¼ˆåˆ é™¤æˆåŠŸè¯´æ˜ä»¤ç‰Œå­˜åœ¨ä¸”æœªä½¿ç”¨ï¼‰
        Boolean deleted = redis.delete(key);
        return Boolean.TRUE.equals(deleted);
    }
}

// å¹‚ç­‰æ¥å£å®ç°
@RestController
public class PaymentController {
    
    @PostMapping("/api/payment")
    public Result makePayment(@RequestParam String userId,
                             @RequestParam String token,
                             @RequestParam BigDecimal amount) {
        
        // 1. éªŒè¯å¹¶æ¶ˆè´¹å¹‚ç­‰ä»¤ç‰Œ
        if (!idempotentTokenService.consumeToken(userId, token)) {
            return Result.error("è¯·æ±‚å·²å¤„ç†æˆ–ä»¤ç‰Œæ— æ•ˆ");
        }
        
        try {
            // 2. æ‰§è¡Œæ”¯ä»˜ä¸šåŠ¡
            String orderId = paymentService.processPayment(userId, amount);
            return Result.success("æ”¯ä»˜æˆåŠŸ", orderId);
            
        } catch (Exception e) {
            // 3. ä¸šåŠ¡å¤±è´¥æ—¶ï¼Œå¯ä»¥è€ƒè™‘é‡æ–°ç”Ÿæˆä»¤ç‰Œ
            log.error("æ”¯ä»˜å¤±è´¥ï¼Œç”¨æˆ·ï¼š{}ï¼Œé‡‘é¢ï¼š{}", userId, amount, e);
            return Result.error("æ”¯ä»˜å¤±è´¥ï¼Œè¯·é‡è¯•");
        }
    }
    
    // è·å–æ–°çš„å¹‚ç­‰ä»¤ç‰Œ
    @GetMapping("/api/payment/token")
    public Result getPaymentToken(@RequestParam String userId) {
        String token = idempotentTokenService.generateToken(userId);
        return Result.success(token);
    }
}
```

### 6.3 ä¹è§‚é”å®ç°å¹‚ç­‰


**ğŸ”’ ä¹è§‚é”å°±åƒ"ç‰ˆæœ¬å·æ ‡è®°"**

```java
// åŸºäºç‰ˆæœ¬å·çš„ä¹è§‚é”
@Entity
public class Account {
    private Long id;
    private BigDecimal balance;
    private Integer version; // ç‰ˆæœ¬å·
    
    // getter/setter...
}

@Service
public class AccountService {
    
    // ä¹è§‚é”æ›´æ–°è´¦æˆ·ä½™é¢
    public boolean updateBalance(Long accountId, BigDecimal newBalance, Integer expectedVersion) {
        // SQL: UPDATE account SET balance = ?, version = version + 1 
        //      WHERE id = ? AND version = ?
        
        int updatedRows = accountMapper.updateBalanceWithVersion(
            accountId, newBalance, expectedVersion);
        
        return updatedRows > 0; // æ›´æ–°æˆåŠŸè¯´æ˜ç‰ˆæœ¬å·åŒ¹é…
    }
    
    // å®‰å…¨çš„ä½™é¢æ›´æ–°æ“ä½œ
    public Result safeUpdateBalance(Long accountId, BigDecimal amount) {
        for (int retry = 0; retry < 3; retry++) { // æœ€å¤šé‡è¯•3æ¬¡
            // 1. æŸ¥è¯¢å½“å‰è´¦æˆ·ä¿¡æ¯
            Account account = accountMapper.selectById(accountId);
            
            // 2. è®¡ç®—æ–°ä½™é¢
            BigDecimal newBalance = account.getBalance().add(amount);
            
            // 3. ä¹è§‚é”æ›´æ–°
            if (updateBalance(accountId, newBalance, account.getVersion())) {
                return Result.success("æ›´æ–°æˆåŠŸ");
            }
            
            // 4. æ›´æ–°å¤±è´¥ï¼Œè¯´æ˜æœ‰å¹¶å‘ä¿®æ”¹ï¼Œç¨ç­‰é‡è¯•
            try {
                Thread.sleep(50); // ç­‰å¾…50ms
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
                break;
            }
        }
        
        return Result.error("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
    }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å®‰å…¨é˜²æŠ¤æ ¸å¿ƒåŸåˆ™


```
ğŸ”¸ ç­¾åéªŒè¯ï¼šæ¥å£å‚æ•°ä¸èƒ½è¢«ç¯¡æ”¹ï¼ˆé˜²ä¼ªæ ‡ç­¾ï¼‰
ğŸ”¸ é¢‘ç‡é™åˆ¶ï¼šé˜²æ­¢æ¥å£è¢«åˆ·çˆ†ï¼ˆæ°´é¾™å¤´æ§åˆ¶ï¼‰
ğŸ”¸ è®¿é—®æ§åˆ¶ï¼šåªè®©è¯¥è¿›æ¥çš„äººè¿›æ¥ï¼ˆé—¨å«ç®¡ç†ï¼‰
ğŸ”¸ è¶…æ—¶è®¾ç½®ï¼šé¿å…é•¿æ—¶é—´å ç”¨èµ„æºï¼ˆè‡ªåŠ¨æ–­ç”µå™¨ï¼‰
ğŸ”¸ é”™è¯¯å®‰å…¨ï¼šä¸æš´éœ²ç³»ç»Ÿå†…éƒ¨ä¿¡æ¯ï¼ˆè—ä¸€æ‰‹ï¼‰
ğŸ”¸ å¹‚ç­‰ä¿éšœï¼šé‡å¤æ“ä½œä¸ä¼šäº§ç”Ÿå‰¯ä½œç”¨ï¼ˆç”µå½±ç¥¨æœºåˆ¶ï¼‰
```

### 7.2 å®æ–½ä¼˜å…ˆçº§å»ºè®®


**ğŸš€ å®‰å…¨æªæ–½å®æ–½é¡ºåº**ï¼š

| **ä¼˜å…ˆçº§** | **å®‰å…¨æªæ–½** | **å®æ–½éš¾åº¦** | **é˜²æŠ¤æ•ˆæœ** | **å¿…è¦æ€§** |
|-----------|-------------|-------------|-------------|-----------|
| **ğŸ”´ é«˜** | `åŸºç¡€é™æµ` | `ç®€å•` | `é«˜` | `å¿…é¡»` |
| **ğŸ”´ é«˜** | `å‚æ•°ç­¾å` | `ä¸­ç­‰` | `é«˜` | `å¿…é¡»` |
| **ğŸŸ¡ ä¸­** | `IPé»‘åå•` | `ç®€å•` | `ä¸­` | `æ¨è` |
| **ğŸŸ¡ ä¸­** | `è¯·æ±‚å¤§å°é™åˆ¶` | `ç®€å•` | `ä¸­` | `æ¨è` |
| **ğŸŸ¢ ä½** | `å¹‚ç­‰ä»¤ç‰Œ` | `å¤æ‚` | `é«˜` | `å¯é€‰` |

### 7.3 å®æˆ˜åº”ç”¨å»ºè®®


**ğŸ’¡ é’ˆå¯¹ä¸åŒåœºæ™¯çš„å®‰å…¨ç­–ç•¥**ï¼š

```
ğŸ“± ç§»åŠ¨APPæ¥å£ï¼š
âœ“ å¿…é¡»ï¼šç­¾åéªŒè¯ + ç”¨æˆ·é™æµ
âœ“ æ¨èï¼šè®¾å¤‡IDç»‘å®š + ç‰ˆæœ¬æ§åˆ¶

ğŸŒ Web APIæ¥å£ï¼š
âœ“ å¿…é¡»ï¼šIPé™æµ + åŸºç¡€éªŒè¯
âœ“ æ¨èï¼šCORSé…ç½® + CSPç­–ç•¥

ğŸ’° æ”¯ä»˜ç›¸å…³æ¥å£ï¼š
âœ“ å¿…é¡»ï¼šå¹‚ç­‰æ€§ + å¤šé‡ç­¾åéªŒè¯
âœ“ æ¨èï¼šå®æ—¶é£æ§ + å¼‚å¸¸ç›‘æ§

ğŸ“Š æ•°æ®æŸ¥è¯¢æ¥å£ï¼š
âœ“ å¿…é¡»ï¼šæŸ¥è¯¢é™æµ + ç»“æœç¼“å­˜
âœ“ æ¨èï¼šæ•°æ®è„±æ• + æƒé™åˆ†çº§
```

### 7.4 å¸¸è§é—®é¢˜è§£å†³


**â“ æ–°æ‰‹å¸¸è§ç–‘é—®**ï¼š

> **Q: ç­¾åéªŒè¯ä¼šä¸ä¼šå½±å“æ€§èƒ½ï¼Ÿ**
> A: å½±å“å¾ˆå°ï¼ŒMD5/SHA256è®¡ç®—å¾ˆå¿«ï¼Œå®‰å…¨æ”¶ç›Šè¿œå¤§äºæ€§èƒ½æˆæœ¬

> **Q: é™æµå¤ªä¸¥æ ¼ç”¨æˆ·ä½“éªŒä¸å¥½æ€ä¹ˆåŠï¼Ÿ**
> A: å¯ä»¥åˆ†å±‚é™æµï¼ŒVIPç”¨æˆ·æ›´é«˜çš„é™åˆ¶ï¼Œæ™®é€šç”¨æˆ·åŸºç¡€é™åˆ¶

> **Q: å¹‚ç­‰æ€§æ˜¯å¦æ‰€æœ‰æ¥å£éƒ½éœ€è¦ï¼Ÿ**
> A: ä¸æ˜¯ï¼Œä¸»è¦æ˜¯ä¿®æ”¹æ•°æ®çš„æ¥å£éœ€è¦ï¼ŒæŸ¥è¯¢æ¥å£å¤©ç„¶å¹‚ç­‰

> **Q: å¦‚ä½•å¹³è¡¡å®‰å…¨æ€§å’Œæ˜“ç”¨æ€§ï¼Ÿ**
> A: å¯¹å¤–æ¥å£ä¸¥æ ¼éªŒè¯ï¼Œå†…éƒ¨æ¥å£é€‚åº¦æ”¾æ¾ï¼Œåˆ†ç¯å¢ƒé…ç½®

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
```
æ¥å£å®‰å…¨é˜²æŠ¤è¦åšå¥½ï¼Œç­¾åé™æµç¼ºä¸€ä¸å¯
å‚æ•°ç¯¡æ”¹ç”¨ç­¾åé˜²ï¼Œæ¶æ„åˆ·é‡é é™æµæŒ¡
IPé»‘ç™½åå•é—¨å«ç®¡ï¼Œè¶…æ—¶è®¾ç½®é˜²å ç”¨
é”™è¯¯ä¿¡æ¯è¦ä¿å¯†ï¼Œå¹‚ç­‰ä»¤ç‰Œé˜²é‡å¤
å®‰å…¨é…ç½®åˆ†å±‚åšï¼Œç”¨æˆ·ä½“éªŒä¸¤å…¼é¡¾
```