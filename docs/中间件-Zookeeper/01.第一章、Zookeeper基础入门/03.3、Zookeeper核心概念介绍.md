---
title: 3ã€Zookeeperæ ¸å¿ƒæ¦‚å¿µä»‹ç»
---
## ğŸ“š ç›®å½•

1. [ZooKeeperæ¦‚è¿°](#1-zookeeperæ¦‚è¿°)
2. [æ ‘å½¢æ•°æ®ç»“æ„è¯¦è§£](#2-æ ‘å½¢æ•°æ®ç»“æ„è¯¦è§£)
3. [ZNodeèŠ‚ç‚¹æ¦‚å¿µ](#3-znodeèŠ‚ç‚¹æ¦‚å¿µ)
4. [ä¼šè¯Sessionæœºåˆ¶](#4-ä¼šè¯sessionæœºåˆ¶)
5. [ç›‘å¬æœºåˆ¶Watch](#5-ç›‘å¬æœºåˆ¶watch)
6. [é€‰ä¸¾ç®—æ³•åŸç†](#6-é€‰ä¸¾ç®—æ³•åŸç†)
7. [é›†ç¾¤è§’è‰²ç®¡ç†](#7-é›†ç¾¤è§’è‰²ç®¡ç†)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ˜ ZooKeeperæ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯ZooKeeper


**ğŸ”¸ æ ¸å¿ƒå®šä¹‰**
```
ZooKeeperï¼šåˆ†å¸ƒå¼åè°ƒæœåŠ¡æ¡†æ¶
è®¾è®¡ç›®æ ‡ï¼šä¸ºåˆ†å¸ƒå¼åº”ç”¨æä¾›ä¸€è‡´æ€§æœåŠ¡
æ ¸å¿ƒç‰¹æ€§ï¼šé«˜å¯ç”¨ã€å¼ºä¸€è‡´æ€§ã€é¡ºåºè®¿é—®
åº”ç”¨åœºæ™¯ï¼šé…ç½®ç®¡ç†ã€æœåŠ¡å‘ç°ã€åˆ†å¸ƒå¼é”ã€é›†ç¾¤ç®¡ç†
```

**ğŸ’¡ åŠ¨ç‰©å›­ç®¡ç†å‘˜çš„æ¯”å–»**
```
ä¼ ç»ŸåŠ¨ç‰©å›­ï¼š                    åˆ†å¸ƒå¼ç³»ç»Ÿï¼š
    ç®¡ç†å‘˜                         ZooKeeper
     â†“                               â†“
  åè°ƒåŠ¨ç‰©                       åè°ƒåˆ†å¸ƒå¼æœåŠ¡
  - å–‚é£Ÿæ—¶é—´                     - é…ç½®ç®¡ç†  
  - æ´»åŠ¨å®‰æ’                     - æœåŠ¡æ³¨å†Œ
  - å¥åº·æ£€æŸ¥                     - çŠ¶æ€ç›‘æ§
  - åŒºåŸŸç®¡ç†                     - èµ„æºåˆ†é…
```

### 1.2 ZooKeeperåœ¨åˆ†å¸ƒå¼æ¶æ„ä¸­çš„ä½œç”¨


**ğŸ—ï¸ æ¶æ„ä½ç½®**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           åº”ç”¨å±‚æœåŠ¡                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    æœåŠ¡A    æœåŠ¡B    æœåŠ¡C           â”‚
â”‚      â†“       â†“       â†“             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         ZooKeeperé›†ç¾¤               â”‚  â† åè°ƒä¸­å¿ƒ
â”‚    Leader  Follower  Observer      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           ç½‘ç»œå±‚                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ¯ æ ¸å¿ƒèŒè´£**
```
ğŸ”¸ é…ç½®ä¸­å¿ƒï¼šé›†ä¸­ç®¡ç†é…ç½®ä¿¡æ¯
ğŸ”¸ æ³¨å†Œä¸­å¿ƒï¼šæœåŠ¡æ³¨å†Œä¸å‘ç°
ğŸ”¸ åè°ƒæœåŠ¡ï¼šåˆ†å¸ƒå¼é”ã€é€‰ä¸»
ğŸ”¸ é€šçŸ¥æœºåˆ¶ï¼šçŠ¶æ€å˜æ›´é€šçŸ¥
ğŸ”¸ å‘½åæœåŠ¡ï¼šç»Ÿä¸€å‘½åç©ºé—´
```

---

## 2. ğŸŒ³ æ ‘å½¢æ•°æ®ç»“æ„è¯¦è§£


### 2.1 ZooKeeperæ•°æ®æ¨¡å‹


**ğŸ”¸ ç±»æ–‡ä»¶ç³»ç»Ÿç»“æ„**
```
ZooKeeperæ•°æ®ç»“æ„ï¼š
                   /                    â† æ ¹èŠ‚ç‚¹
                 â”Œâ”€â”´â”€â”
               app1  services           â† åº”ç”¨èŠ‚ç‚¹
               â”Œâ”€â”´â”    â”Œâ”€â”€â”´â”€â”€â”
            config users web database  â† ä¸šåŠ¡èŠ‚ç‚¹  
              â”‚     â”‚    â”‚      â”‚
            db.url  list  nginx  mysql  â† å…·ä½“é…ç½®
```

**ğŸ’¡ ä¸ä¼ ç»Ÿæ–‡ä»¶ç³»ç»Ÿçš„å¯¹æ¯”**
```
ä¼ ç»Ÿæ–‡ä»¶ç³»ç»Ÿï¼š              ZooKeeperï¼š
/home/user/file.txt       /app1/config/db.url
  â†‘      â†‘      â†‘             â†‘      â†‘      â†‘
 ç›®å½•   ç›®å½•   æ–‡ä»¶          ZNode  ZNode  ZNode

ç›¸åŒç‚¹ï¼š
âœ“ å±‚æ¬¡åŒ–ç»“æ„
âœ“ è·¯å¾„è®¿é—®æ–¹å¼  
âœ“ çˆ¶å­å…³ç³»

ä¸åŒç‚¹ï¼š
âœ— æ–‡ä»¶ vs ZNodeï¼ˆæ¯ä¸ªèŠ‚ç‚¹éƒ½å¯å­˜å‚¨æ•°æ®ï¼‰
âœ— æ°¸ä¹…å­˜å‚¨ vs ä¼šè¯ç›¸å…³
âœ— å¤§æ–‡ä»¶ vs å°æ•°æ®ï¼ˆâ‰¤1MBï¼‰
```

### 2.2 è·¯å¾„è¡¨ç¤ºè§„èŒƒ


**ğŸ“ è·¯å¾„å‘½åè§„åˆ™**
```java
// æ ‡å‡†è·¯å¾„æ ¼å¼
/path/to/znode

// è·¯å¾„è§„åˆ™ï¼š
âœ… å¿…é¡»ä»¥ / å¼€å¤´
âœ… è·¯å¾„åˆ†éš”ç¬¦ä¸º /
âœ… èŠ‚ç‚¹åç§°ä¸èƒ½åŒ…å« \u0000-\u001F å’Œ \u007F-\u009F
âœ… èŠ‚ç‚¹åç§°ä¸èƒ½åŒ…å« . å’Œ ..
âœ… èŠ‚ç‚¹åç§°åŒºåˆ†å¤§å°å†™

// ç¤ºä¾‹è·¯å¾„
/applications/web-server/config    âœ… æ­£ç¡®
/apps//double-slash               âŒ é”™è¯¯ï¼ˆåŒæ–œæ ï¼‰
/apps/app.config                  âŒ é¿å…ä½¿ç”¨ç‚¹
```

### 2.3 èŠ‚ç‚¹å±‚æ¬¡å…³ç³»


**ğŸ”— çˆ¶å­å…³ç³»ç‰¹æ€§**
```
èŠ‚ç‚¹å…³ç³»å›¾ï¼š
    /dubbo                    â† çˆ¶èŠ‚ç‚¹
    â”œâ”€â”€ /providers           â† å­èŠ‚ç‚¹
    â”‚   â”œâ”€â”€ server1:20880    â† å­™èŠ‚ç‚¹
    â”‚   â””â”€â”€ server2:20880
    â””â”€â”€ /consumers           â† å­èŠ‚ç‚¹
        â”œâ”€â”€ client1
        â””â”€â”€ client2

ç‰¹æ€§è¯´æ˜ï¼š
â€¢ çˆ¶èŠ‚ç‚¹åˆ é™¤ â†’ æ‰€æœ‰å­èŠ‚ç‚¹çº§è”åˆ é™¤
â€¢ å­èŠ‚ç‚¹åˆ›å»º â†’ çˆ¶èŠ‚ç‚¹å¿…é¡»å­˜åœ¨
â€¢ è·¯å¾„å”¯ä¸€æ€§ â†’ åŒçº§èŠ‚ç‚¹åç§°ä¸é‡å¤
â€¢ æ·±åº¦é™åˆ¶ â†’ ç†è®ºæ— é™ï¼Œå®é™…å»ºè®®æ§åˆ¶åœ¨åˆç†èŒƒå›´
```

---

## 3. ğŸ—‚ï¸ ZNodeèŠ‚ç‚¹æ¦‚å¿µ


### 3.1 ZNodeåŸºæœ¬ç‰¹æ€§


**ğŸ”¸ ZNodeæ ¸å¿ƒå±æ€§**
```java
// ZNodeæ•°æ®ç»“æ„
public class Stat {
    private long czxid;          // åˆ›å»ºäº‹åŠ¡ID
    private long mzxid;          // æœ€åä¿®æ”¹äº‹åŠ¡ID
    private long ctime;          // åˆ›å»ºæ—¶é—´æˆ³
    private long mtime;          // æœ€åä¿®æ”¹æ—¶é—´æˆ³
    private int version;         // æ•°æ®ç‰ˆæœ¬å·
    private int cversion;        // å­èŠ‚ç‚¹ç‰ˆæœ¬å·
    private int aversion;        // ACLç‰ˆæœ¬å·
    private long ephemeralOwner; // ä¸´æ—¶èŠ‚ç‚¹æ‰€æœ‰è€…ä¼šè¯ID
    private int dataLength;      // æ•°æ®é•¿åº¦
    private int numChildren;     // å­èŠ‚ç‚¹æ•°é‡
}
```

**ğŸ’¾ æ•°æ®å­˜å‚¨ç‰¹ç‚¹**
```
å­˜å‚¨é™åˆ¶ï¼š
â€¢ æœ€å¤§æ•°æ®å¤§å°ï¼š1MB
â€¢ æ¨èæ•°æ®å¤§å°ï¼š< 1KB
â€¢ æ•°æ®ç±»å‹ï¼šbyte[]

ä½¿ç”¨å»ºè®®ï¼š
âœ… é…ç½®ä¿¡æ¯ï¼šconnection.timeout=5000
âœ… çŠ¶æ€æ ‡è¯†ï¼š{"status": "active"}
âœ… å…ƒæ•°æ®ï¼š{"version": "2.1.0", "updateTime": "2025-01-01"}
âŒ å¤§æ–‡ä»¶å­˜å‚¨ï¼šå›¾ç‰‡ã€è§†é¢‘ç­‰
âŒ æ—¥å¿—å­˜å‚¨ï¼šåº”ç”¨æ—¥å¿—æ•°æ®
```

### 3.2 ZNodeèŠ‚ç‚¹ç±»å‹


#### ğŸ”„ æŒä¹…èŠ‚ç‚¹ï¼ˆPersistentï¼‰


**ç‰¹æ€§è¯´æ˜**
```
ç”Ÿå‘½å‘¨æœŸï¼šåˆ›å»ºåä¸€ç›´å­˜åœ¨ï¼Œç›´åˆ°ä¸»åŠ¨åˆ é™¤
ä½¿ç”¨åœºæ™¯ï¼šé…ç½®ä¿¡æ¯ã€æœåŠ¡æ³¨å†Œä¿¡æ¯
èŠ‚ç‚¹æ ‡è¯†ï¼šæ— ç‰¹æ®Šæ ‡è¯†

åˆ›å»ºç¤ºä¾‹ï¼š
zkCli.sh -server localhost:2181
[zk: localhost:2181(CONNECTED) 0] create /config "database.url=jdbc:mysql://..."
Created /config
```

**ğŸ”¢ æŒä¹…é¡ºåºèŠ‚ç‚¹ï¼ˆPersistent Sequentialï¼‰**
```
ç‰¹æ€§ï¼šæŒä¹…èŠ‚ç‚¹ + è‡ªåŠ¨ç¼–å·
å‘½åè§„åˆ™ï¼šæŒ‡å®šåç§° + 10ä½æ•°å­—åºå·
ä½¿ç”¨åœºæ™¯ï¼šåˆ†å¸ƒå¼é”çš„å…¬å¹³æ€§å®ç°

åˆ›å»ºç¤ºä¾‹ï¼š
[zk: localhost:2181(CONNECTED) 1] create -s /locks/lock- ""
Created /locks/lock-0000000001
[zk: localhost:2181(CONNECTED) 2] create -s /locks/lock- ""  
Created /locks/lock-0000000002

åºå·ç‰¹ç‚¹ï¼š
â€¢ å•è°ƒé€’å¢
â€¢ å…¨å±€å”¯ä¸€
â€¢ 10ä½æ•°å­—ï¼Œå‰ç¼€è¡¥0
```

#### â° ä¸´æ—¶èŠ‚ç‚¹ï¼ˆEphemeralï¼‰


**ç”Ÿå‘½å‘¨æœŸç®¡ç†**
```
åˆ›å»ºæ¡ä»¶ï¼šå®¢æˆ·ç«¯ä¼šè¯å»ºç«‹å
é”€æ¯æ¡ä»¶ï¼š
  â”œâ”€â”€ å®¢æˆ·ç«¯ä¸»åŠ¨åˆ é™¤
  â”œâ”€â”€ å®¢æˆ·ç«¯ä¼šè¯è¶…æ—¶
  â””â”€â”€ å®¢æˆ·ç«¯å¼‚å¸¸æ–­å¼€

å®é™…åº”ç”¨ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æœåŠ¡å®ä¾‹æ³¨å†Œ       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æœåŠ¡å¯åŠ¨ â†’ åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹ â”‚
â”‚ æœåŠ¡åœæ­¢ â†’ èŠ‚ç‚¹è‡ªåŠ¨æ¶ˆå¤± â”‚
â”‚ ç½‘ç»œå¼‚å¸¸ â†’ èŠ‚ç‚¹è¶…æ—¶åˆ é™¤ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”¢ ä¸´æ—¶é¡ºåºèŠ‚ç‚¹ï¼ˆEphemeral Sequentialï¼‰**
```java
// åˆ†å¸ƒå¼é”å®ç°ç¤ºä¾‹
public class DistributedLock {
    
    public void lock() throws Exception {
        // åˆ›å»ºä¸´æ—¶é¡ºåºèŠ‚ç‚¹
        String lockPath = zk.create(
            LOCK_ROOT + "/lock-", 
            new byte[0], 
            ZooDefs.Ids.OPEN_ACL_UNSAFE,
            CreateMode.EPHEMERAL_SEQUENTIAL
        );
        
        // è·å–æ‰€æœ‰é”èŠ‚ç‚¹å¹¶æ’åº
        List<String> children = zk.getChildren(LOCK_ROOT, false);
        Collections.sort(children);
        
        // åˆ¤æ–­æ˜¯å¦è·å¾—é”
        if (lockPath.endsWith(children.get(0))) {
            // è·å¾—é”
            return;
        } else {
            // ç›‘å¬å‰ä¸€ä¸ªèŠ‚ç‚¹
            watchPreviousNode(children, lockPath);
        }
    }
}
```

### 3.3 èŠ‚ç‚¹ç±»å‹é€‰æ‹©æŒ‡å—


**ğŸ¯ é€‰æ‹©å†³ç­–æ ‘**
```
éœ€è¦èŠ‚ç‚¹æŒä¹…å­˜åœ¨ï¼Ÿ
    â”œâ”€â”€ Yes â†’ æŒä¹…èŠ‚ç‚¹ç±»å‹
    â”‚   â””â”€â”€ éœ€è¦æ’åºï¼Ÿ
    â”‚       â”œâ”€â”€ Yes â†’ æŒä¹…é¡ºåºèŠ‚ç‚¹
    â”‚       â””â”€â”€ No  â†’ æŒä¹…èŠ‚ç‚¹
    â””â”€â”€ No  â†’ ä¸´æ—¶èŠ‚ç‚¹ç±»å‹
        â””â”€â”€ éœ€è¦æ’åºï¼Ÿ
            â”œâ”€â”€ Yes â†’ ä¸´æ—¶é¡ºåºèŠ‚ç‚¹
            â””â”€â”€ No  â†’ ä¸´æ—¶èŠ‚ç‚¹

åº”ç”¨åœºæ™¯æ˜ å°„ï¼š
ğŸ“Š é…ç½®ç®¡ç†    â†’ æŒä¹…èŠ‚ç‚¹
ğŸ·ï¸  æœåŠ¡æ³¨å†Œ    â†’ ä¸´æ—¶èŠ‚ç‚¹  
ğŸ”’ åˆ†å¸ƒå¼é”    â†’ ä¸´æ—¶é¡ºåºèŠ‚ç‚¹
ğŸ“ å·¥ä½œé˜Ÿåˆ—    â†’ æŒä¹…é¡ºåºèŠ‚ç‚¹
```

---

## 4. ğŸ”— ä¼šè¯Sessionæœºåˆ¶


### 4.1 ä¼šè¯åŸºæœ¬æ¦‚å¿µ


**ğŸ”¸ ä¼šè¯å®šä¹‰ä¸ç‰¹æ€§**
```
ä¼šè¯ï¼ˆSessionï¼‰ï¼šå®¢æˆ·ç«¯ä¸ZooKeeperæœåŠ¡å™¨ä¹‹é—´çš„è¿æ¥
ç”Ÿå‘½å‘¨æœŸï¼šä»è¿æ¥å»ºç«‹åˆ°è¿æ¥æ–­å¼€
å”¯ä¸€æ ‡è¯†ï¼šSessionIDï¼ˆ64ä½longå‹ï¼‰
ä¼šè¯çŠ¶æ€ï¼šCONNECTING â†’ CONNECTED â†’ CLOSED
```

**ğŸ“Š ä¼šè¯çŠ¶æ€è½¬æ¢å›¾**
```
å®¢æˆ·ç«¯çŠ¶æ€è½¬æ¢ï¼š

    [å¯åŠ¨]
      â†“
  CONNECTING â”€â”€è¿æ¥æˆåŠŸâ”€â”€â†’ CONNECTED
      â†“                      â†“
   è¿æ¥å¤±è´¥                ä¼šè¯è¶…æ—¶
      â†“                      â†“
    CLOSED â†â”€â”€ä¸»åŠ¨æ–­å¼€â”€â”€â”€â”€ CONNECTED
                            â†“
                        é‡è¿æˆåŠŸ
                            â†“
                        CONNECTED
```

### 4.2 ä¼šè¯è¶…æ—¶æœºåˆ¶


**â° è¶…æ—¶å‚æ•°é…ç½®**
```java
// å®¢æˆ·ç«¯è¿æ¥é…ç½®
ZooKeeper zk = new ZooKeeper(
    "localhost:2181",           // è¿æ¥å­—ç¬¦ä¸²
    30000,                      // ä¼šè¯è¶…æ—¶æ—¶é—´(ms)
    new Watcher() {             // ç›‘å¬å™¨
        public void process(WatchedEvent event) {
            // å¤„ç†äº‹ä»¶
        }
    }
);

è¶…æ—¶æ—¶é—´è®¾ç½®ï¼š
â€¢ æœ€å°å€¼ï¼š2 * tickTime (é»˜è®¤4ç§’)
â€¢ æœ€å¤§å€¼ï¼š20 * tickTime (é»˜è®¤40ç§’)  
â€¢ æ¨èå€¼ï¼š15-30ç§’
â€¢ å½±å“å› ç´ ï¼šç½‘ç»œå»¶è¿Ÿã€ä¸šåŠ¡å¤æ‚åº¦
```

**ğŸ”„ å¿ƒè·³ä¿æ´»æœºåˆ¶**
```
å¿ƒè·³æœºåˆ¶æµç¨‹ï¼š

å®¢æˆ·ç«¯                           æœåŠ¡å™¨
   â”‚                               â”‚
   â”‚â”€â”€â”€â”€â”€â”€ å‘é€å¿ƒè·³ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
   â”‚                               â”‚ æ›´æ–°ä¼šè¯è¶…æ—¶æ—¶é—´
   â”‚â†â”€â”€â”€â”€â”€â”€ å¿ƒè·³å“åº” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                               â”‚
   â”‚  (é—´éš” 1/3 * sessionTimeout)   â”‚
   â”‚                               â”‚
   â”‚â”€â”€â”€â”€â”€â”€ å‘é€å¿ƒè·³ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
   â”‚                               â”‚

è¶…æ—¶æ£€æµ‹ï¼š
IF (å½“å‰æ—¶é—´ - æœ€åå¿ƒè·³æ—¶é—´) > sessionTimeout:
    æ ‡è®°ä¼šè¯è¿‡æœŸï¼Œæ¸…ç†ä¸´æ—¶èŠ‚ç‚¹
```

### 4.3 ä¼šè¯ç®¡ç†æœ€ä½³å®è·µ


**âš™ï¸ è¿æ¥æ± ç®¡ç†**
```java
// ä¼šè¯è¿æ¥ç®¡ç†å™¨
public class ZkSessionManager {
    private final AtomicReference<ZooKeeper> zkRef = new AtomicReference<>();
    private final CountDownLatch connectedLatch = new CountDownLatch(1);
    
    public ZooKeeper getConnection() throws Exception {
        ZooKeeper zk = zkRef.get();
        if (zk == null || !zk.getState().equals(ZooKeeper.States.CONNECTED)) {
            synchronized (this) {
                zk = zkRef.get();
                if (zk == null || !zk.getState().equals(ZooKeeper.States.CONNECTED)) {
                    if (zk != null) {
                        zk.close();
                    }
                    zk = createConnection();
                    zkRef.set(zk);
                }
            }
        }
        return zk;
    }
    
    private ZooKeeper createConnection() throws Exception {
        ZooKeeper zk = new ZooKeeper(connectString, sessionTimeout, 
            new ConnectionWatcher());
        connectedLatch.await(10, TimeUnit.SECONDS);
        return zk;
    }
}
```

**ğŸ”§ ä¼šè¯å¼‚å¸¸å¤„ç†**
```java
// ä¼šè¯çŠ¶æ€ç›‘å¬å¤„ç†
public class SessionWatcher implements Watcher {
    
    @Override
    public void process(WatchedEvent event) {
        if (event.getType() == Event.EventType.None) {
            switch (event.getState()) {
                case SyncConnected:
                    logger.info("ä¼šè¯è¿æ¥æˆåŠŸ");
                    break;
                case Disconnected:
                    logger.warn("ä¼šè¯è¿æ¥æ–­å¼€ï¼Œå°è¯•é‡è¿...");
                    reconnect();
                    break;
                case Expired:
                    logger.error("ä¼šè¯å·²è¿‡æœŸï¼Œéœ€è¦é‡æ–°åˆ›å»º");
                    recreateSession();
                    break;
                case AuthFailed:
                    logger.error("èº«ä»½éªŒè¯å¤±è´¥");
                    break;
            }
        }
    }
}
```

---

## 5. ğŸ‘ï¸ ç›‘å¬æœºåˆ¶Watch


### 5.1 Watchæœºåˆ¶æ¦‚è¿°


**ğŸ”¸ Watchå·¥ä½œåŸç†**
```
ç›‘å¬æœºåˆ¶ï¼ˆWatchï¼‰ï¼šå®¢æˆ·ç«¯å¯¹ZNodeæ³¨å†Œç›‘å¬ï¼Œå½“èŠ‚ç‚¹å‘ç”Ÿå˜åŒ–æ—¶æ”¶åˆ°é€šçŸ¥

å·¥ä½œæµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â‘ æ³¨å†ŒWatch     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å®¢æˆ·ç«¯     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”‚ ZooKeeper   â”‚
â”‚            â”‚                  â”‚   æœåŠ¡å™¨     â”‚
â”‚            â”‚ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â‘£é€šçŸ¥äº‹ä»¶        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†‘                              â”‚
       â”‚            â‘¢è§¦å‘äº‹ä»¶           â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â‘¡æ•°æ®å˜æ›´
```

**âš¡ Watchç‰¹æ€§**
```
ä¸€æ¬¡æ€§è§¦å‘ï¼š
â€¢ Watchè§¦å‘åè‡ªåŠ¨ç§»é™¤
â€¢ éœ€è¦é‡æ–°æ³¨å†Œæ‰èƒ½ç»§ç»­ç›‘å¬

å¼‚æ­¥é€šçŸ¥ï¼š
â€¢ äº‹ä»¶é€šçŸ¥æ˜¯å¼‚æ­¥çš„
â€¢ ä¸ä¿è¯é€šçŸ¥çš„å®æ—¶æ€§

äº‹ä»¶ç±»å‹ï¼š
â€¢ NodeCreatedï¼šèŠ‚ç‚¹åˆ›å»º
â€¢ NodeDeletedï¼šèŠ‚ç‚¹åˆ é™¤  
â€¢ NodeDataChangedï¼šèŠ‚ç‚¹æ•°æ®å˜æ›´
â€¢ NodeChildrenChangedï¼šå­èŠ‚ç‚¹å˜æ›´
```

### 5.2 Watchäº‹ä»¶ç±»å‹è¯¦è§£


**ğŸ“‹ äº‹ä»¶åˆ†ç±»è¡¨**

| äº‹ä»¶ç±»å‹ | è§¦å‘æ¡ä»¶ | ç›‘å¬æ–¹å¼ | åº”ç”¨åœºæ™¯ |
|---------|---------|---------|----------|
| `NodeCreated` | èŠ‚ç‚¹è¢«åˆ›å»º | `exists()` | ç­‰å¾…ç‰¹å®šèŠ‚ç‚¹åˆ›å»º |
| `NodeDeleted` | èŠ‚ç‚¹è¢«åˆ é™¤ | `exists()`, `getData()` | ç›‘æ§èŠ‚ç‚¹ç”Ÿå‘½å‘¨æœŸ |
| `NodeDataChanged` | èŠ‚ç‚¹æ•°æ®ä¿®æ”¹ | `getData()` | é…ç½®å˜æ›´ç›‘å¬ |
| `NodeChildrenChanged` | å­èŠ‚ç‚¹å˜æ›´ | `getChildren()` | æœåŠ¡åˆ—è¡¨ç›‘å¬ |

**ğŸ” ç›‘å¬æ³¨å†Œæ–¹å¼**
```java
// 1. ç›‘å¬èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨
Stat stat = zk.exists("/config", new Watcher() {
    public void process(WatchedEvent event) {
        if (event.getType() == Event.EventType.NodeCreated) {
            System.out.println("èŠ‚ç‚¹è¢«åˆ›å»º");
        }
    }
});

// 2. ç›‘å¬èŠ‚ç‚¹æ•°æ®å˜åŒ–
byte[] data = zk.getData("/config", new Watcher() {
    public void process(WatchedEvent event) {
        if (event.getType() == Event.EventType.NodeDataChanged) {
            System.out.println("èŠ‚ç‚¹æ•°æ®å‘ç”Ÿå˜åŒ–");
            // é‡æ–°æ³¨å†Œç›‘å¬
            try {
                zk.getData("/config", this, null);
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }
}, null);

// 3. ç›‘å¬å­èŠ‚ç‚¹å˜åŒ–
List<String> children = zk.getChildren("/services", new Watcher() {
    public void process(WatchedEvent event) {
        if (event.getType() == Event.EventType.NodeChildrenChanged) {
            System.out.println("å­èŠ‚ç‚¹å‘ç”Ÿå˜åŒ–");
            // é‡æ–°è·å–å­èŠ‚ç‚¹åˆ—è¡¨
            refreshServiceList();
        }
    }
});
```

### 5.3 Watchå®ç°æ¨¡å¼


**ğŸ”„ é…ç½®ä¸­å¿ƒç›‘å¬æ¨¡å¼**
```java
public class ConfigWatcher {
    private ZooKeeper zk;
    private String configPath;
    private ConfigChangeListener listener;
    
    public void startWatch() throws Exception {
        watchConfigNode();
    }
    
    private void watchConfigNode() throws Exception {
        try {
            // è·å–é…ç½®æ•°æ®å¹¶æ³¨å†Œç›‘å¬
            Stat stat = zk.exists(configPath, new Watcher() {
                @Override
                public void process(WatchedEvent event) {
                    try {
                        if (event.getType() == Event.EventType.NodeDataChanged) {
                            // é…ç½®å˜æ›´ï¼Œé‡æ–°è¯»å–
                            byte[] data = zk.getData(configPath, this, null);
                            listener.onConfigChanged(new String(data));
                        } else if (event.getType() == Event.EventType.NodeDeleted) {
                            // é…ç½®èŠ‚ç‚¹è¢«åˆ é™¤
                            listener.onConfigDeleted();
                        }
                        // é‡æ–°æ³¨å†Œç›‘å¬
                        watchConfigNode();
                    } catch (Exception e) {
                        logger.error("å¤„ç†é…ç½®å˜æ›´äº‹ä»¶å¤±è´¥", e);
                    }
                }
            });
            
            if (stat != null) {
                byte[] data = zk.getData(configPath, false, null);
                listener.onConfigChanged(new String(data));
            }
        } catch (KeeperException.NoNodeException e) {
            // èŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œç›‘å¬èŠ‚ç‚¹åˆ›å»ºäº‹ä»¶
            zk.exists(configPath, this::watchConfigNode);
        }
    }
}
```

**ğŸ¢ æœåŠ¡å‘ç°ç›‘å¬æ¨¡å¼**
```java
public class ServiceDiscovery {
    private ZooKeeper zk;
    private String servicePath;
    private List<String> currentServices = new ArrayList<>();
    
    public void startDiscovery() throws Exception {
        watchServiceNodes();
    }
    
    private void watchServiceNodes() throws Exception {
        List<String> services = zk.getChildren(servicePath, new Watcher() {
            @Override
            public void process(WatchedEvent event) {
                if (event.getType() == Event.EventType.NodeChildrenChanged) {
                    try {
                        // å­èŠ‚ç‚¹å˜æ›´ï¼Œæ›´æ–°æœåŠ¡åˆ—è¡¨
                        List<String> newServices = zk.getChildren(servicePath, this);
                        updateServiceList(newServices);
                    } catch (Exception e) {
                        logger.error("æ›´æ–°æœåŠ¡åˆ—è¡¨å¤±è´¥", e);
                    }
                }
            }
        });
        
        updateServiceList(services);
    }
    
    private void updateServiceList(List<String> newServices) {
        // å¯¹æ¯”å˜åŒ–
        Set<String> added = new HashSet<>(newServices);
        added.removeAll(currentServices);
        
        Set<String> removed = new HashSet<>(currentServices);
        removed.removeAll(newServices);
        
        // é€šçŸ¥å˜æ›´
        for (String service : added) {
            onServiceAdded(service);
        }
        for (String service : removed) {
            onServiceRemoved(service);
        }
        
        currentServices = new ArrayList<>(newServices);
    }
}
```

---

## 6. âš–ï¸ é€‰ä¸¾ç®—æ³•åŸç†


### 6.1 ZABåè®®æ¦‚è¿°


**ğŸ”¸ ZABåè®®å®šä¹‰**
```
ZAB (ZooKeeper Atomic Broadcast)ï¼šZooKeeperåŸå­å¹¿æ’­åè®®
è®¾è®¡ç›®æ ‡ï¼š
â€¢ ä¿è¯äº‹åŠ¡çš„åŸå­æ€§å’Œé¡ºåºæ€§
â€¢ å®ç°é›†ç¾¤ä¸­Leaderé€‰ä¸¾
â€¢ ç¡®ä¿æ•°æ®ä¸€è‡´æ€§

åè®®æ¨¡å¼ï¼š
â”œâ”€â”€ æ¢å¤æ¨¡å¼ (Recovery Mode)
â”‚   â”œâ”€â”€ Leaderé€‰ä¸¾
â”‚   â””â”€â”€ æ•°æ®åŒæ­¥
â””â”€â”€ å¹¿æ’­æ¨¡å¼ (Broadcast Mode)
    â”œâ”€â”€ äº‹åŠ¡æè®®
    â””â”€â”€ äº‹åŠ¡æäº¤
```

### 6.2 Leaderé€‰ä¸¾è¿‡ç¨‹


**ğŸ—³ï¸ é€‰ä¸¾è§¦å‘æ¡ä»¶**
```
é€‰ä¸¾å¯åŠ¨åœºæ™¯ï¼š
1ï¸âƒ£ é›†ç¾¤å¯åŠ¨æ—¶ - åˆæ¬¡é€‰ä¸¾
2ï¸âƒ£ Leaderå´©æºƒ - é‡æ–°é€‰ä¸¾  
3ï¸âƒ£ Leaderå¤±å»åŠæ•°ä»¥ä¸ŠFollower - é‡æ–°é€‰ä¸¾

é€‰ä¸¾å‚ä¸è€…ï¼š
âœ… FollowerèŠ‚ç‚¹ - å‚ä¸æŠ•ç¥¨
âœ… ObserverèŠ‚ç‚¹ - ä¸å‚ä¸æŠ•ç¥¨ï¼ˆä»…åŒæ­¥æ•°æ®ï¼‰
âŒ LeaderèŠ‚ç‚¹ - é€‰ä¸¾äº§ç”Ÿåä¸å†å‚ä¸
```

**ğŸ”¢ é€‰ä¸¾ç®—æ³•æµç¨‹**
```
é€‰ä¸¾æµç¨‹å›¾ï¼š

é˜¶æ®µ1: èŠ‚ç‚¹çŠ¶æ€åˆå§‹åŒ–
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ‰€æœ‰èŠ‚ç‚¹è¿›å…¥ LOOKING çŠ¶æ€            â”‚
â”‚ åˆå§‹æŠ•ç¥¨ï¼šæŠ•ç¥¨ç»™è‡ªå·±                 â”‚
â”‚ Vote = (myId, myZxid, myEpoch)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
é˜¶æ®µ2: æŠ•ç¥¨äº¤æ¢
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ èŠ‚ç‚¹é—´äº¤æ¢æŠ•ç¥¨ä¿¡æ¯                   â”‚
â”‚ æ¯”è¾ƒè§„åˆ™ï¼š                          â”‚
â”‚ 1. Epochå¤§çš„ä¼˜å…ˆ                    â”‚  
â”‚ 2. Zxidå¤§çš„ä¼˜å…ˆ                     â”‚
â”‚ 3. ServerIdå¤§çš„ä¼˜å…ˆ                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
é˜¶æ®µ3: æŠ•ç¥¨ç»Ÿè®¡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç»Ÿè®¡æ¯ä¸ªå€™é€‰è€…çš„ç¥¨æ•°                 â”‚
â”‚ åˆ¤æ–­æ˜¯å¦è¿‡åŠæ•° (> n/2)              â”‚
â”‚ ç¡®å®šLeader                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ“Š é€‰ä¸¾ç®—æ³•å®ä¾‹**
```
é›†ç¾¤é…ç½®ï¼š5ä¸ªèŠ‚ç‚¹ (Server1-5)
èŠ‚ç‚¹çŠ¶æ€ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ èŠ‚ç‚¹ID â”‚ çŠ¶æ€   â”‚ Epoch â”‚ Zxid     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1      â”‚ LOOKINGâ”‚ 1     â”‚ 0x100001 â”‚
â”‚ 2      â”‚ LOOKINGâ”‚ 1     â”‚ 0x100002 â”‚
â”‚ 3      â”‚ LOOKINGâ”‚ 1     â”‚ 0x100003 â”‚ â† æœ€æ–°æ•°æ®
â”‚ 4      â”‚ LOOKINGâ”‚ 1     â”‚ 0x100001 â”‚
â”‚ 5      â”‚ LOOKINGâ”‚ 1     â”‚ 0x100001 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æŠ•ç¥¨è¿‡ç¨‹ï¼š
è½®æ¬¡1ï¼šå„èŠ‚ç‚¹æŠ•ç¥¨ç»™è‡ªå·±
  Server1 â†’ (1, 0x100001, 1)
  Server2 â†’ (2, 0x100002, 1)  
  Server3 â†’ (3, 0x100003, 1)
  Server4 â†’ (4, 0x100001, 1)
  Server5 â†’ (5, 0x100001, 1)

è½®æ¬¡2ï¼šæ”¶åˆ°æŠ•ç¥¨åé‡æ–°å†³ç­–
  æ¯”è¾ƒè§„åˆ™ï¼šServer3çš„Zxidæœ€å¤§
  æ‰€æœ‰èŠ‚ç‚¹æ”¹æŠ•Server3ï¼š
  æœ€ç»ˆç»“æœï¼šServer3 è·å¾—5ç¥¨ï¼Œæˆä¸ºLeader âœ…
```

### 6.3 é€‰ä¸¾ä¼˜åŒ–æœºåˆ¶


**ğŸš€ Fast Leader Election (FLE)**
```java
// å¿«é€Ÿé€‰ä¸¾ç®—æ³•ä¼ªä»£ç 
public Vote lookForLeader() {
    HashMap<Long, Vote> recvset = new HashMap<>();
    HashMap<Long, Vote> outofelection = new HashMap<>();
    
    synchronized(this) {
        logicalclock.incrementAndGet();
        updateProposal(getInitId(), getInitLastLoggedZxid(), getPeerEpoch());
    }
    
    // å‘é€åˆå§‹æŠ•ç¥¨
    sendNotifications();
    
    while ((self.getPeerState() == ServerState.LOOKING) && (!stop)) {
        Notification n = recvqueue.poll(notTimeout, TimeUnit.MILLISECONDS);
        
        if (n == null) {
            // è¶…æ—¶å¤„ç†
            if (manager.haveDelivered()) {
                sendNotifications();
            } else {
                manager.connectAll();
            }
        } else {
            // å¤„ç†æŠ•ç¥¨æ¶ˆæ¯
            switch (n.state) {
                case LOOKING:
                    if (n.electionEpoch > logicalclock.get()) {
                        // æ›´é«˜çš„é€‰ä¸¾è½®æ¬¡
                        logicalclock.set(n.electionEpoch);
                        recvset.clear();
                        if (totalOrderPredicate(n.leader, n.zxid, n.peerEpoch,
                                getInitId(), getInitLastLoggedZxid(), getPeerEpoch())) {
                            updateProposal(n.leader, n.zxid, n.peerEpoch);
                        } else {
                            updateProposal(getInitId(), getInitLastLoggedZxid(), getPeerEpoch());
                        }
                        sendNotifications();
                    }
                    break;
                case FOLLOWING:
                case LEADING:
                    // å·²æœ‰Leaderï¼ŒéªŒè¯å¹¶è·Ÿéš
                    if (n.electionEpoch == logicalclock.get()) {
                        recvset.put(n.sid, new Vote(n.leader, n.zxid, n.electionEpoch, n.peerEpoch));
                        if (termPredicate(recvset, new Vote(n.leader, n.zxid, n.electionEpoch, n.peerEpoch))) {
                            self.setPeerState((n.leader == self.getId()) ? ServerState.LEADING: ServerState.FOLLOWING);
                            return new Vote(n.leader, n.zxid, n.electionEpoch, n.peerEpoch);
                        }
                    }
                    break;
            }
        }
    }
    return null;
}
```

---

## 7. ğŸ­ é›†ç¾¤è§’è‰²ç®¡ç†


### 7.1 é›†ç¾¤è§’è‰²å®šä¹‰


**ğŸ‘¥ è§’è‰²åˆ†ç±»ä¸èŒè´£**

| è§’è‰² | èŒè´£ | æ•°é‡é™åˆ¶ | å‚ä¸é€‰ä¸¾ | å‚ä¸å†™æ“ä½œ |
|------|------|----------|----------|-----------|
| **Leader** | äº‹åŠ¡å¤„ç†ã€æ•°æ®åŒæ­¥ | 1ä¸ª | å¦ | âœ… æ˜¯ |
| **Follower** | å“åº”å®¢æˆ·ç«¯è¯»è¯·æ±‚ | æ— é™åˆ¶ | âœ… æ˜¯ | è½¬å‘ç»™Leader |
| **Observer** | æ‰©å±•è¯»èƒ½åŠ› | æ— é™åˆ¶ | âŒ å¦ | è½¬å‘ç»™Leader |

**ğŸ”„ è§’è‰²è½¬æ¢å…³ç³»**
```
è§’è‰²çŠ¶æ€è½¬æ¢å›¾ï¼š

    [åˆå§‹çŠ¶æ€]
        â†“
    LOOKING â”€â”€â”€â”€é€‰ä¸¾æˆåŠŸâ”€â”€â”€â†’ LEADING (Leader)
        â†‘                      â†“
        â”‚                  Leaderå´©æºƒ
        â”‚                      â†“  
        â””â”€â”€â”€é‡æ–°é€‰ä¸¾â”€â”€â”€â”€â”€â”€ FOLLOWING (Follower)
                              â†“
                        é…ç½®ä¸ºObserver
                              â†“
                         OBSERVING (Observer)
```

### 7.2 Leaderè§’è‰²è¯¦è§£


**ğŸ‘‘ Leaderæ ¸å¿ƒèŒè´£**
```
äº‹åŠ¡å¤„ç†æµç¨‹ï¼š

å®¢æˆ·ç«¯å†™è¯·æ±‚ â†’ Leaderæ¥æ”¶ â†’ ç”Ÿæˆäº‹åŠ¡ID â†’ å‘èµ·æè®®
                                      â†“
æäº¤æˆåŠŸ â† è¿‡åŠæ•°ç¡®è®¤ â† ç­‰å¾…Followerå“åº” â† å¹¿æ’­Proposal
    â†“
é€šçŸ¥æ‰€æœ‰èŠ‚ç‚¹ â†’ æ•°æ®åŒæ­¥å®Œæˆ
```

**âš¡ Leaderé€‰ä¸¾åçš„åˆå§‹åŒ–**
```java
// Leaderå¯åŠ¨åçš„åˆå§‹åŒ–è¿‡ç¨‹
public class Leader {
    
    public void lead() throws IOException, InterruptedException {
        self.end_fle = Time.currentElapsedTime();
        long electionTimeTaken = self.end_fle - self.start_fle;
        LOG.info("é€‰ä¸¾è€—æ—¶: " + electionTimeTaken + "ms");
        
        self.start_fle = 0;
        self.end_fle = 0;

        zk.registerJMX(new LeaderBean(this, zk), self.jmxLocalPeerBean);

        try {
            self.setZabState(QuorumPeer.ZabState.DISCOVERY);
            
            // 1. å‘ç°é˜¶æ®µï¼šæ”¶é›†Followerä¿¡æ¯
            followers = new HashSet<LearnerHandler>();
            long epoch = getEpochToPropose(self.getId(), self.getAcceptedEpoch());
            
            // 2. åŒæ­¥é˜¶æ®µï¼šæ•°æ®åŒæ­¥
            zk.setZxid(ZxidUtils.makeZxid(epoch, 0));
            synchronized(this) {
                lastProposed = zk.getZxid();
            }
            
            newLeaderProposal.packet = new QuorumPacket(NEWLEADER, zk.getZxid(), null, null);
            
            // ç­‰å¾…è¿‡åŠæ•°Followerç¡®è®¤
            if ((newLeaderProposal.hasAllQuorumMembers())) {
                commit(zk.getZxid());
                inform.queuePacket(new QuorumPacket(INFORM, zk.getZxid(), null, null));
            }
            
            // 3. å¹¿æ’­é˜¶æ®µï¼šå¼€å§‹å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚
            startForwarding();
            
        } finally {
            zk.unregisterJMX(this);
        }
    }
}
```

### 7.3 Followerè§’è‰²è¯¦è§£


**ğŸ¤ Followerä¸»è¦åŠŸèƒ½**
```java
public class Follower {
    
    public void followLeader() throws InterruptedException {
        self.end_fle = Time.currentElapsedTime();
        long electionTimeTaken = self.end_fle - self.start_fle;
        self.start_fle = 0;
        self.end_fle = 0;
        
        try {
            QuorumServer leaderServer = findLeader();            
            
            try {
                // è¿æ¥Leader
                connectToLeader(leaderServer.addr, leaderServer.hostname);
                
                // æ³¨å†Œåˆ°Leader
                long newEpochZxid = registerWithLeader(Leader.FOLLOWERINFO);
                
                if (self.isReconfigStateChange())
                   throw new Exception("learned about role change");
                
                // æ•°æ®åŒæ­¥
                syncWithLeader(newEpochZxid);
                
                QuorumPacket qp = new QuorumPacket();
                while (this.isRunning()) {
                    // å¤„ç†Leaderå‘æ¥çš„æ¶ˆæ¯
                    readPacket(qp);
                    processPacket(qp);
                }
            } catch (Exception e) {
                LOG.warn("Exception when following the leader", e);
                try {
                    sock.close();
                } catch (IOException e1) {
                    e1.printStackTrace();
                }
                // clear pending revalidations
                pendingRevalidations.clear();
            }
        } finally {
            zk.unregisterJMX((Learner)this);
        }
    }
    
    // å¤„ç†ä¸åŒç±»å‹çš„æ•°æ®åŒ…
    protected void processPacket(QuorumPacket qp) throws Exception{
        switch (qp.getType()) {
        case Leader.PING:            
            ping(qp);            
            break;
        case Leader.PROPOSAL:            
            TxnHeader hdr = new TxnHeader();
            Record txn = SerializeUtils.deserializeTxn(qp.getData(), hdr);
            if (hdr.getZxid() != lastQueued + 1) {
                LOG.warn("Got zxid 0x" + Long.toHexString(hdr.getZxid()) + " expected 0x" + Long.toHexString(lastQueued + 1));
            }
            lastQueued = hdr.getZxid();
            
            if (hdr.getType() == OpCode.reconfig){
               SetDataTxn setDataTxn = (SetDataTxn) txn;       
               QuorumVerifier qv = self.configFromString(new String(setDataTxn.getData()));
               self.setLastSeenQuorumVerifier(qv, true);                               
            }
            
            fzk.logRequest(hdr, txn);
            break;
        case Leader.COMMIT:
            fzk.commit(qp.getZxid());
            break;
            
        // ... å…¶ä»–æ¶ˆæ¯å¤„ç†
        }
    }
}
```

### 7.4 Observerè§’è‰²è¯¦è§£


**ğŸ‘€ Observerè®¾è®¡ç›®æ ‡**
```
Observerä½œç”¨ï¼š
ğŸ¯ æ‰©å±•è¯»èƒ½åŠ›ï¼šåˆ†æ‹…Followerè¯»è¯·æ±‚å‹åŠ›
ğŸ¯ ä¸å‚ä¸é€‰ä¸¾ï¼šä¸å½±å“é€‰ä¸¾æ€§èƒ½å’Œä¸€è‡´æ€§
ğŸ¯ å¼‚æ­¥åŒæ­¥ï¼šå‡å°‘å†™æ“ä½œå»¶è¿Ÿ
ğŸ¯ åœ°åŸŸéƒ¨ç½²ï¼šè·¨åœ°åŸŸéƒ¨ç½²æ—¶å‡å°‘ç½‘ç»œå»¶è¿Ÿ
```

**âš™ï¸ Observeré…ç½®ç¤ºä¾‹**
```properties
# zoo.cfgé…ç½®æ–‡ä»¶
tickTime=2000
initLimit=10
syncLimit=5
dataDir=/var/lib/zookeeper
clientPort=2181

# æœåŠ¡å™¨åˆ—è¡¨é…ç½®
server.1=zoo1:2888:3888
server.2=zoo2:2888:3888  
server.3=zoo3:2888:3888
server.4=zoo4:2888:3888:observer    # ObserverèŠ‚ç‚¹
server.5=zoo5:2888:3888:observer    # ObserverèŠ‚ç‚¹

# ObserverèŠ‚ç‚¹ä¸Šé¢å¤–é…ç½®
peerType=observer
```

**ğŸ”„ Observerå·¥ä½œæµç¨‹**
```
Observeræ•°æ®åŒæ­¥ï¼š

Leader                     Observer
  â”‚                          â”‚
  â”‚â”€â”€â”€â”€â”€â”€ INFORM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚  å¼‚æ­¥é€šçŸ¥
  â”‚                          â”‚  åº”ç”¨äº‹åŠ¡
  â”‚                          â”‚
  â”‚                          â”‚
å®¢æˆ·ç«¯è¯»è¯·æ±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚  ç›´æ¥å“åº”
                             â”‚  (ä¸è½¬å‘åˆ°Leader)
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ”¸ ZooKeeperæœ¬è´¨ï¼šåˆ†å¸ƒå¼åè°ƒæœåŠ¡ï¼Œæä¾›ä¸€è‡´æ€§ä¿è¯
ğŸ”¸ æ•°æ®æ¨¡å‹ï¼šç±»æ–‡ä»¶ç³»ç»Ÿçš„æ ‘å½¢ç»“æ„ï¼Œæ¯ä¸ªèŠ‚ç‚¹å¯å­˜å‚¨æ•°æ®  
ğŸ”¸ èŠ‚ç‚¹ç±»å‹ï¼šæŒä¹…/ä¸´æ—¶ Ã— æ™®é€š/é¡ºåº = 4ç§ç»„åˆ
ğŸ”¸ ä¼šè¯æœºåˆ¶ï¼šå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨çš„é•¿è¿æ¥ï¼Œæ”¯æŒå¿ƒè·³ä¿æ´»
ğŸ”¸ ç›‘å¬æœºåˆ¶ï¼šä¸€æ¬¡æ€§äº‹ä»¶é€šçŸ¥ï¼Œæ”¯æŒèŠ‚ç‚¹å’Œæ•°æ®å˜æ›´ç›‘å¬
ğŸ”¸ é€‰ä¸¾ç®—æ³•ï¼šZABåè®®ä¿è¯Leaderé€‰ä¸¾å’Œæ•°æ®ä¸€è‡´æ€§
ğŸ”¸ é›†ç¾¤è§’è‰²ï¼šLeaderè´Ÿè´£å†™ï¼ŒFollowerå‚ä¸é€‰ä¸¾ï¼ŒObserveræ‰©å±•è¯»
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆZooKeeperèƒ½ä¿è¯ä¸€è‡´æ€§**
```
ä¸€è‡´æ€§ä¿éšœæœºåˆ¶ï¼š
â€¢ Leaderç»Ÿä¸€å¤„ç†å†™æ“ä½œ â†’ é¿å…å¹¶å‘å†²çª
â€¢ è¿‡åŠæ•°ç¡®è®¤æœºåˆ¶ â†’ ä¿è¯æ•°æ®å¯é æ€§  
â€¢ ZABåè®® â†’ ä¿è¯äº‹åŠ¡é¡ºåºæ€§
â€¢ ä¼šè¯æœºåˆ¶ â†’ ä¿è¯å®¢æˆ·ç«¯çŠ¶æ€ä¸€è‡´æ€§
```

**ğŸ”¹ ZNodeè®¾è®¡çš„ç²¾å¦™ä¹‹å¤„**
```
è®¾è®¡ç‰¹ç‚¹ï¼š
â€¢ å°æ•°æ®å­˜å‚¨ â†’ é¿å…æˆä¸ºå­˜å‚¨ç³»ç»Ÿ
â€¢ è·¯å¾„å”¯ä¸€æ€§ â†’ å¤©ç„¶çš„å‘½åç©ºé—´
â€¢ ä¸´æ—¶èŠ‚ç‚¹ â†’ è‡ªåŠ¨æ¸…ç†æœºåˆ¶
â€¢ é¡ºåºèŠ‚ç‚¹ â†’ åˆ†å¸ƒå¼é”çš„åŸºç¡€
â€¢ ç‰ˆæœ¬æœºåˆ¶ â†’ ä¹è§‚é”å®ç°
```

**ğŸ”¹ Watchæœºåˆ¶çš„æƒè¡¡è®¾è®¡**
```
è®¾è®¡æƒè¡¡ï¼š
â€¢ ä¸€æ¬¡æ€§è§¦å‘ vs æŒç»­ç›‘å¬ â†’ é¿å…äº‹ä»¶é£æš´
â€¢ å¼‚æ­¥é€šçŸ¥ vs åŒæ­¥é€šçŸ¥ â†’ æé«˜æ€§èƒ½
â€¢ ç®€å•äº‹ä»¶ vs è¯¦ç»†ä¿¡æ¯ â†’ å‡å°‘ç½‘ç»œå¼€é”€
```

### 8.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ å…¸å‹åº”ç”¨åœºæ™¯**
- **é…ç½®ä¸­å¿ƒ**ï¼šç»Ÿä¸€é…ç½®ç®¡ç†ï¼ŒåŠ¨æ€é…ç½®æ›´æ–°
- **æœåŠ¡æ³¨å†Œå‘ç°**ï¼šå¾®æœåŠ¡æ¶æ„ä¸­çš„æœåŠ¡æ²»ç†
- **åˆ†å¸ƒå¼é”**ï¼šåŸºäºä¸´æ—¶é¡ºåºèŠ‚ç‚¹å®ç°
- **é›†ç¾¤ç®¡ç†**ï¼šèŠ‚ç‚¹çŠ¶æ€ç›‘æ§ï¼Œæ•…éšœè‡ªåŠ¨åˆ‡æ¢
- **åˆ†å¸ƒå¼é˜Ÿåˆ—**ï¼šåŸºäºé¡ºåºèŠ‚ç‚¹å®ç°FIFOé˜Ÿåˆ—

**âš ï¸ ä½¿ç”¨æ³¨æ„äº‹é¡¹**
```
æ€§èƒ½è€ƒè™‘ï¼š
âœ… é€‚åˆè¯»å¤šå†™å°‘åœºæ™¯  
âœ… æ•°æ®é‡æ§åˆ¶åœ¨KBçº§åˆ«
âŒ ä¸é€‚åˆé¢‘ç¹å†™æ“ä½œ
âŒ ä¸é€‚åˆå¤§æ•°æ®å­˜å‚¨

å¯é æ€§è€ƒè™‘ï¼š  
âœ… éƒ¨ç½²å¥‡æ•°ä¸ªèŠ‚ç‚¹ï¼ˆ3ã€5ã€7ï¼‰
âœ… åˆç†è®¾ç½®ä¼šè¯è¶…æ—¶æ—¶é—´
âœ… ç›‘æ§é›†ç¾¤å¥åº·çŠ¶æ€
âŒ é¿å…ç½‘ç»œåˆ†åŒºé—®é¢˜
```

**ğŸ’¡ å­¦ä¹ è·¯å¾„å»ºè®®**
```
åŸºç¡€é˜¶æ®µï¼š
1ï¸âƒ£ ç†è§£ZNodeæ¦‚å¿µå’Œæ“ä½œ
2ï¸âƒ£ æŒæ¡ä¼šè¯å’ŒWatchæœºåˆ¶
3ï¸âƒ£ ç†Ÿæ‚‰åŸºæœ¬çš„å®¢æˆ·ç«¯API

è¿›é˜¶é˜¶æ®µï¼š  
4ï¸âƒ£ æ·±å…¥ç†è§£ZABåè®®
5ï¸âƒ£ å­¦ä¹ é›†ç¾¤éƒ¨ç½²å’Œè¿ç»´
6ï¸âƒ£ æŒæ¡å¸¸è§åº”ç”¨æ¨¡å¼

å®æˆ˜é˜¶æ®µï¼š
7ï¸âƒ£ å®ç°åˆ†å¸ƒå¼é”
8ï¸âƒ£ æ„å»ºé…ç½®ä¸­å¿ƒ
9ï¸âƒ£ é›†æˆåˆ°å®é™…é¡¹ç›®ä¸­
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- *"æ ‘å½¢å­˜å‚¨å°æ•°æ®ï¼Œä¸´æ—¶æŒä¹…ä¸¤å¤§ç±»"*
- *"ä¼šè¯å¿ƒè·³ä¿è¿æ¥ï¼ŒWatchç›‘å¬ä¸€æ¬¡æ€§"*  
- *"Leaderå¤„ç†å†™è¯·æ±‚ï¼Œè¿‡åŠç¡®è®¤ä¿ä¸€è‡´"*
- *"é…ç½®æ³¨å†Œé”é˜Ÿåˆ—ï¼Œåè°ƒæœåŠ¡ç¬¬ä¸€é€‰"*