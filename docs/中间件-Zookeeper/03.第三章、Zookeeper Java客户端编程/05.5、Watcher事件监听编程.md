---
title: 5ã€Watcheräº‹ä»¶ç›‘å¬ç¼–ç¨‹
---
## ğŸ“š ç›®å½•

1. [Watcheræ¥å£å®ç°](#1-Watcheræ¥å£å®ç°)
2. [äº‹ä»¶å¤„ç†é€»è¾‘](#2-äº‹ä»¶å¤„ç†é€»è¾‘)
3. [é‡å¤æ³¨å†Œæœºåˆ¶](#3-é‡å¤æ³¨å†Œæœºåˆ¶)
4. [äº‹ä»¶ç±»å‹åˆ¤æ–­](#4-äº‹ä»¶ç±»å‹åˆ¤æ–­)
5. [å¼‚å¸¸å¤„ç†ç­–ç•¥](#5-å¼‚å¸¸å¤„ç†ç­–ç•¥)
6. [æœ€ä½³å®è·µæŒ‡å—](#6-æœ€ä½³å®è·µæŒ‡å—)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” Watcheræ¥å£å®ç°


### 1.1 Watcheræœºåˆ¶æ ¸å¿ƒç†è§£

ğŸ¯ **ç®€å•ç†è§£**ï¼šWatcherå°±åƒ"é—¨é“ƒ"ï¼Œå½“ZNodeå‘ç”Ÿå˜åŒ–æ—¶ä¼š"å“é“ƒ"é€šçŸ¥ä½ 

```
ç”Ÿæ´»ä¸­çš„ç±»æ¯”ï¼š
é—¨é“ƒç³»ç»Ÿ â†’ Watcheræœºåˆ¶
æŒ‰é—¨é“ƒ â†’ ZNodeå˜åŒ–äº‹ä»¶
å¬åˆ°é“ƒå£° â†’ æ¥æ”¶åˆ°é€šçŸ¥
å¼€é—¨æŸ¥çœ‹ â†’ å¤„ç†äº‹ä»¶é€»è¾‘

ç‰¹ç‚¹ï¼š
- ä¸€æ¬¡æ€§è§¦å‘ï¼ˆæŒ‰ä¸€æ¬¡å“ä¸€æ¬¡ï¼‰
- éœ€è¦é‡æ–°æ³¨å†Œï¼ˆæƒ³ç»§ç»­ç›‘å¬éœ€è¦é‡æ–°æŒ‰é“ƒè®¾ç½®ï¼‰
- å¼‚æ­¥é€šçŸ¥ï¼ˆä¸ä¼šé˜»å¡å…¶ä»–æ“ä½œï¼‰
```

### 1.2 åŸºæœ¬Watcheræ¥å£å®ç°

**ğŸ”§ ç®€å•çš„Watcherå®ç°**

```java
import org.apache.zookeeper.*;
import org.apache.zookeeper.data.Stat;

// åŸºç¡€Watcherå®ç°ç±»
public class SimpleWatcher implements Watcher {
    
    @Override
    public void process(WatchedEvent event) {
        System.out.println("æ”¶åˆ°äº‹ä»¶é€šçŸ¥:");
        System.out.println("äº‹ä»¶ç±»å‹: " + event.getType());
        System.out.println("è¿æ¥çŠ¶æ€: " + event.getState());
        System.out.println("èŠ‚ç‚¹è·¯å¾„: " + event.getPath());
    }
}

// ä½¿ç”¨ç¤ºä¾‹
public class WatcherDemo {
    private ZooKeeper zk;
    
    public void connectZK() throws Exception {
        zk = new ZooKeeper("localhost:2181", 3000, new SimpleWatcher());
        Thread.sleep(2000); // ç­‰å¾…è¿æ¥å»ºç«‹
    }
    
    // ç›‘å¬èŠ‚ç‚¹æ•°æ®å˜åŒ–
    public void watchNodeData() throws Exception {
        String path = "/test";
        
        // æ³¨å†Œç›‘å¬å¹¶è·å–æ•°æ®
        byte[] data = zk.getData(path, true, null);
        System.out.println("å½“å‰æ•°æ®: " + new String(data));
    }
}
```

### 1.3 ä¸“ç”¨Watcherç±»è®¾è®¡

**ğŸ“‹ é’ˆå¯¹ä¸åŒåœºæ™¯çš„Watcherè®¾è®¡**

```java
// æ•°æ®å˜åŒ–ç›‘å¬å™¨
public class DataWatcher implements Watcher {
    private ZooKeeper zk;
    private String watchPath;
    
    public DataWatcher(ZooKeeper zk, String path) {
        this.zk = zk;
        this.watchPath = path;
    }
    
    @Override
    public void process(WatchedEvent event) {
        if (event.getType() == Event.EventType.NodeDataChanged) {
            try {
                // è·å–æ–°æ•°æ®å¹¶é‡æ–°æ³¨å†Œç›‘å¬
                byte[] newData = zk.getData(watchPath, this, null);
                System.out.println("æ•°æ®å·²æ›´æ–°: " + new String(newData));
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }
}

// å­èŠ‚ç‚¹å˜åŒ–ç›‘å¬å™¨
public class ChildrenWatcher implements Watcher {
    private ZooKeeper zk;
    private String watchPath;
    
    public ChildrenWatcher(ZooKeeper zk, String path) {
        this.zk = zk;
        this.watchPath = path;
    }
    
    @Override
    public void process(WatchedEvent event) {
        if (event.getType() == Event.EventType.NodeChildrenChanged) {
            try {
                // è·å–æœ€æ–°å­èŠ‚ç‚¹åˆ—è¡¨å¹¶é‡æ–°ç›‘å¬
                List<String> children = zk.getChildren(watchPath, this);
                System.out.println("å­èŠ‚ç‚¹å˜åŒ–: " + children);
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }
}
```

---

## 2. âš¡ äº‹ä»¶å¤„ç†é€»è¾‘


### 2.1 äº‹ä»¶å¤„ç†çš„æ ¸å¿ƒæµç¨‹

**ğŸ”„ æ ‡å‡†çš„äº‹ä»¶å¤„ç†æ¨¡å¼**

```
äº‹ä»¶å¤„ç†æµç¨‹ï¼š
æ¥æ”¶äº‹ä»¶ â†’ åˆ¤æ–­äº‹ä»¶ç±»å‹ â†’ æ‰§è¡Œå¯¹åº”é€»è¾‘ â†’ é‡æ–°æ³¨å†Œç›‘å¬

å…³é”®æ­¥éª¤ï¼š
1. äº‹ä»¶ç±»å‹åˆ¤æ–­ï¼ˆNodeDataChanged/NodeChildrenChangedç­‰ï¼‰
2. è·¯å¾„åŒ¹é…éªŒè¯ï¼ˆç¡®ä¿æ˜¯å…³å¿ƒçš„èŠ‚ç‚¹ï¼‰
3. ä¸šåŠ¡é€»è¾‘å¤„ç†ï¼ˆæ ¹æ®å˜åŒ–æ‰§è¡Œç›¸åº”æ“ä½œï¼‰
4. å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼ˆç½‘ç»œå¼‚å¸¸ã€èŠ‚ç‚¹ä¸å­˜åœ¨ç­‰ï¼‰
5. é‡æ–°æ³¨å†Œç›‘å¬ï¼ˆä¿æŒæŒç»­ç›‘å¬ï¼‰
```

### 2.2 äº‹ä»¶å¤„ç†å™¨æ¨¡å¼å®ç°

**ğŸ—ï¸ ä½¿ç”¨ç­–ç•¥æ¨¡å¼å¤„ç†ä¸åŒäº‹ä»¶**

```java
// äº‹ä»¶å¤„ç†å™¨æ¥å£
interface EventHandler {
    void handle(WatchedEvent event, ZooKeeper zk);
}

// æ•°æ®å˜åŒ–å¤„ç†å™¨
class DataChangedHandler implements EventHandler {
    @Override
    public void handle(WatchedEvent event, ZooKeeper zk) {
        try {
            byte[] data = zk.getData(event.getPath(), true, null);
            System.out.println("å¤„ç†æ•°æ®å˜åŒ–: " + new String(data));
            // é‡æ–°æ³¨å†Œç›‘å¬
        } catch (Exception e) {
            System.err.println("å¤„ç†æ•°æ®å˜åŒ–å¤±è´¥: " + e.getMessage());
        }
    }
}

// èŠ‚ç‚¹åˆ›å»ºå¤„ç†å™¨
class NodeCreatedHandler implements EventHandler {
    @Override
    public void handle(WatchedEvent event, ZooKeeper zk) {
        System.out.println("èŠ‚ç‚¹å·²åˆ›å»º: " + event.getPath());
        // å¯ä»¥å¼€å§‹ç›‘å¬è¯¥èŠ‚ç‚¹çš„æ•°æ®å˜åŒ–
        try {
            zk.getData(event.getPath(), true, null);
        } catch (Exception e) {
            System.err.println("ç›‘å¬æ–°åˆ›å»ºèŠ‚ç‚¹å¤±è´¥: " + e.getMessage());
        }
    }
}

// ç»¼åˆäº‹ä»¶å¤„ç†å™¨
public class EventProcessor implements Watcher {
    private ZooKeeper zk;
    private Map<Event.EventType, EventHandler> handlers;
    
    public EventProcessor(ZooKeeper zk) {
        this.zk = zk;
        this.handlers = new HashMap<>();
        
        // æ³¨å†Œä¸åŒç±»å‹äº‹ä»¶çš„å¤„ç†å™¨
        handlers.put(Event.EventType.NodeDataChanged, new DataChangedHandler());
        handlers.put(Event.EventType.NodeCreated, new NodeCreatedHandler());
    }
    
    @Override
    public void process(WatchedEvent event) {
        EventHandler handler = handlers.get(event.getType());
        if (handler != null) {
            handler.handle(event, zk);
        } else {
            System.out.println("æœªå¤„ç†çš„äº‹ä»¶ç±»å‹: " + event.getType());
        }
    }
}
```

### 2.3 å¼‚æ­¥äº‹ä»¶å¤„ç†

**ğŸš€ æé«˜äº‹ä»¶å¤„ç†æ•ˆç‡**

```java
public class AsyncEventProcessor implements Watcher {
    private ExecutorService executor;
    private ZooKeeper zk;
    
    public AsyncEventProcessor(ZooKeeper zk) {
        this.zk = zk;
        // åˆ›å»ºçº¿ç¨‹æ± å¤„ç†äº‹ä»¶
        this.executor = Executors.newFixedThreadPool(5);
    }
    
    @Override
    public void process(WatchedEvent event) {
        // å¼‚æ­¥å¤„ç†äº‹ä»¶ï¼Œä¸é˜»å¡Watcherçº¿ç¨‹
        executor.submit(() -> {
            try {
                handleEvent(event);
            } catch (Exception e) {
                System.err.println("å¼‚æ­¥å¤„ç†äº‹ä»¶å¤±è´¥: " + e.getMessage());
            }
        });
    }
    
    private void handleEvent(WatchedEvent event) throws Exception {
        switch (event.getType()) {
            case NodeDataChanged:
                byte[] data = zk.getData(event.getPath(), this, null);
                processDataChange(event.getPath(), data);
                break;
                
            case NodeChildrenChanged:
                List<String> children = zk.getChildren(event.getPath(), this);
                processChildrenChange(event.getPath(), children);
                break;
        }
    }
    
    private void processDataChange(String path, byte[] data) {
        // å…·ä½“çš„æ•°æ®å˜åŒ–å¤„ç†é€»è¾‘
        System.out.println("å¼‚æ­¥å¤„ç†æ•°æ®å˜åŒ–: " + path);
    }
    
    private void processChildrenChange(String path, List<String> children) {
        // å…·ä½“çš„å­èŠ‚ç‚¹å˜åŒ–å¤„ç†é€»è¾‘
        System.out.println("å¼‚æ­¥å¤„ç†å­èŠ‚ç‚¹å˜åŒ–: " + path);
    }
}
```

---

## 3. ğŸ” é‡å¤æ³¨å†Œæœºåˆ¶


### 3.1 ä¸ºä»€ä¹ˆéœ€è¦é‡å¤æ³¨å†Œ

**âš ï¸ Watcherçš„ä¸€æ¬¡æ€§ç‰¹å¾**

```
Watcherä¸€æ¬¡æ€§ç‰¹å¾ï¼š
- è§¦å‘ä¸€æ¬¡åè‡ªåŠ¨å¤±æ•ˆ
- éœ€è¦æ‰‹åŠ¨é‡æ–°æ³¨å†Œ
- è¿™æ˜¯ZooKeeperçš„è®¾è®¡åŸåˆ™

ä¸é‡æ–°æ³¨å†Œçš„åæœï¼š
- åªèƒ½æ”¶åˆ°ç¬¬ä¸€æ¬¡å˜åŒ–é€šçŸ¥
- åç»­å˜åŒ–å°†æ— æ³•æ„ŸçŸ¥
- ç›‘å¬åŠŸèƒ½å¤±æ•ˆ
```

### 3.2 è‡ªåŠ¨é‡æ³¨å†Œå®ç°

**ğŸ”„ å®ç°æŒç»­ç›‘å¬çš„è‡ªåŠ¨æ³¨å†Œ**

```java
public class AutoReRegisterWatcher implements Watcher {
    private ZooKeeper zk;
    private String monitorPath;
    private volatile boolean isActive = true;
    
    public AutoReRegisterWatcher(ZooKeeper zk, String path) {
        this.zk = zk;
        this.monitorPath = path;
    }
    
    @Override
    public void process(WatchedEvent event) {
        if (!isActive) return;
        
        System.out.println("æ”¶åˆ°äº‹ä»¶: " + event.getType() + " è·¯å¾„: " + event.getPath());
        
        // å¤„ç†äº‹ä»¶å¹¶è‡ªåŠ¨é‡æ–°æ³¨å†Œ
        try {
            switch (event.getType()) {
                case NodeDataChanged:
                    // è·å–æ•°æ®åŒæ—¶é‡æ–°æ³¨å†Œ
                    byte[] data = zk.getData(monitorPath, this, null);
                    handleDataChange(data);
                    break;
                    
                case NodeChildrenChanged:
                    // è·å–å­èŠ‚ç‚¹åŒæ—¶é‡æ–°æ³¨å†Œ
                    List<String> children = zk.getChildren(monitorPath, this);
                    handleChildrenChange(children);
                    break;
                    
                case NodeDeleted:
                    handleNodeDeleted();
                    // èŠ‚ç‚¹è¢«åˆ é™¤åï¼Œå¯ä»¥ç›‘å¬çˆ¶èŠ‚ç‚¹ç­‰å¾…é‡æ–°åˆ›å»º
                    startWatchingForRecreation();
                    break;
            }
        } catch (Exception e) {
            System.err.println("é‡æ–°æ³¨å†Œå¤±è´¥: " + e.getMessage());
        }
    }
    
    // å¼€å§‹ç›‘å¬èŠ‚ç‚¹é‡æ–°åˆ›å»º
    private void startWatchingForRecreation() throws Exception {
        String parentPath = monitorPath.substring(0, monitorPath.lastIndexOf("/"));
        zk.getChildren(parentPath, this);
    }
    
    // åœæ­¢ç›‘å¬
    public void stopWatching() {
        isActive = false;
    }
    
    private void handleDataChange(byte[] data) {
        System.out.println("æ•°æ®å˜åŒ–: " + new String(data));
    }
    
    private void handleChildrenChange(List<String> children) {
        System.out.println("å­èŠ‚ç‚¹å˜åŒ–: " + children);
    }
    
    private void handleNodeDeleted() {
        System.out.println("èŠ‚ç‚¹è¢«åˆ é™¤: " + monitorPath);
    }
}
```

### 3.3 æ™ºèƒ½é‡æ³¨å†Œç­–ç•¥

**ğŸ§  æ ¹æ®æƒ…å†µæ™ºèƒ½å†³å®šæ˜¯å¦é‡æ³¨å†Œ**

```java
public class SmartWatcher implements Watcher {
    private ZooKeeper zk;
    private String path;
    private int retryCount = 0;
    private final int maxRetry = 3;
    
    @Override
    public void process(WatchedEvent event) {
        try {
            if (shouldReRegister(event)) {
                reRegisterWatcher();
                retryCount = 0; // é‡ç½®é‡è¯•è®¡æ•°
            }
        } catch (Exception e) {
            handleReRegisterFailure(e);
        }
    }
    
    private boolean shouldReRegister(WatchedEvent event) {
        // è¿æ¥æ–­å¼€æ—¶ä¸é‡æ³¨å†Œ
        if (event.getState() != Event.KeeperState.SyncConnected) {
            return false;
        }
        
        // èŠ‚ç‚¹åˆ é™¤åå¯èƒ½ä¸éœ€è¦ç«‹å³é‡æ³¨å†Œ
        if (event.getType() == Event.EventType.NodeDeleted) {
            return false;
        }
        
        return true;
    }
    
    private void reRegisterWatcher() throws Exception {
        // æ ¹æ®ç›‘å¬ç±»å‹é‡æ–°æ³¨å†Œ
        if (path.endsWith("_data")) {
            zk.getData(path, this, null);
        } else if (path.endsWith("_children")) {
            zk.getChildren(path, this);
        }
    }
    
    private void handleReRegisterFailure(Exception e) {
        if (retryCount < maxRetry) {
            retryCount++;
            System.out.println("é‡æ³¨å†Œå¤±è´¥ï¼Œé‡è¯•ç¬¬" + retryCount + "æ¬¡");
            
            // å»¶è¿Ÿé‡è¯•
            try {
                Thread.sleep(1000 * retryCount);
                reRegisterWatcher();
            } catch (Exception retryException) {
                System.err.println("é‡è¯•å¤±è´¥: " + retryException.getMessage());
            }
        } else {
            System.err.println("é‡æ³¨å†Œè¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œåœæ­¢ç›‘å¬");
        }
    }
}
```

---

## 4. ğŸ¯ äº‹ä»¶ç±»å‹åˆ¤æ–­


### 4.1 ZooKeeperäº‹ä»¶ç±»å‹è¯¦è§£

**ğŸ“Š äº‹ä»¶ç±»å‹åˆ†ç±»å’Œå«ä¹‰**

| äº‹ä»¶ç±»å‹ | **è§¦å‘æ¡ä»¶** | **å¸¸è§ç”¨é€”** | **æ³¨æ„äº‹é¡¹** |
|---------|-------------|-------------|-------------|
| ğŸ”¸ **NodeCreated** | `èŠ‚ç‚¹è¢«åˆ›å»º` | `ç›‘å¬èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨` | `åªåœ¨exists()æ—¶è§¦å‘` |
| ğŸ”¸ **NodeDeleted** | `èŠ‚ç‚¹è¢«åˆ é™¤` | `ç›‘å¬èŠ‚ç‚¹ç”Ÿå‘½å‘¨æœŸ` | `éœ€è¦å¤„ç†åç»­ç›‘å¬` |
| ğŸ”¸ **NodeDataChanged** | `èŠ‚ç‚¹æ•°æ®ä¿®æ”¹` | `é…ç½®å˜æ›´ç›‘å¬` | `æœ€å¸¸ç”¨çš„äº‹ä»¶ç±»å‹` |
| ğŸ”¸ **NodeChildrenChanged** | `å­èŠ‚ç‚¹å¢åˆ ` | `é›†ç¾¤æˆå‘˜å˜åŒ–` | `ä¸å…³å¿ƒå­èŠ‚ç‚¹æ•°æ®` |
| ğŸ”¸ **None** | `è¿æ¥çŠ¶æ€å˜åŒ–` | `è¿æ¥æ–­å¼€/é‡è¿` | `ä¸æ˜¯èŠ‚ç‚¹äº‹ä»¶` |

### 4.2 äº‹ä»¶ç±»å‹åˆ¤æ–­å®ç°

**ğŸ” ç²¾ç¡®çš„äº‹ä»¶ç±»å‹å¤„ç†**

```java
public class EventTypeHandler implements Watcher {
    private ZooKeeper zk;
    
    @Override
    public void process(WatchedEvent event) {
        // é¦–å…ˆæ£€æŸ¥è¿æ¥çŠ¶æ€
        if (event.getState() != Event.KeeperState.SyncConnected) {
            handleConnectionEvent(event);
            return;
        }
        
        // å¤„ç†èŠ‚ç‚¹äº‹ä»¶
        switch (event.getType()) {
            case NodeCreated:
                handleNodeCreated(event.getPath());
                break;
                
            case NodeDeleted:
                handleNodeDeleted(event.getPath());
                break;
                
            case NodeDataChanged:
                handleDataChanged(event.getPath());
                break;
                
            case NodeChildrenChanged:
                handleChildrenChanged(event.getPath());
                break;
                
            case None:
                // è¿æ¥äº‹ä»¶ï¼Œé€šå¸¸åœ¨è¿æ¥å»ºç«‹æ—¶è§¦å‘
                System.out.println("è¿æ¥äº‹ä»¶è§¦å‘");
                break;
                
            default:
                System.out.println("æœªçŸ¥äº‹ä»¶ç±»å‹: " + event.getType());
        }
    }
    
    private void handleNodeCreated(String path) {
        System.out.println("èŠ‚ç‚¹åˆ›å»º: " + path);
        try {
            // å¼€å§‹ç›‘å¬æ–°åˆ›å»ºèŠ‚ç‚¹çš„æ•°æ®å˜åŒ–
            zk.getData(path, this, null);
        } catch (Exception e) {
            System.err.println("ç›‘å¬æ–°èŠ‚ç‚¹å¤±è´¥: " + e.getMessage());
        }
    }
    
    private void handleNodeDeleted(String path) {
        System.out.println("èŠ‚ç‚¹åˆ é™¤: " + path);
        // å¯ä»¥ç›‘å¬çˆ¶èŠ‚ç‚¹ï¼Œç­‰å¾…èŠ‚ç‚¹é‡æ–°åˆ›å»º
    }
    
    private void handleDataChanged(String path) {
        try {
            byte[] data = zk.getData(path, this, null);
            System.out.println("æ•°æ®å˜åŒ– " + path + ": " + new String(data));
        } catch (Exception e) {
            System.err.println("è·å–å˜æ›´æ•°æ®å¤±è´¥: " + e.getMessage());
        }
    }
    
    private void handleChildrenChanged(String path) {
        try {
            List<String> children = zk.getChildren(path, this);
            System.out.println("å­èŠ‚ç‚¹å˜åŒ– " + path + ": " + children);
        } catch (Exception e) {
            System.err.println("è·å–å­èŠ‚ç‚¹å¤±è´¥: " + e.getMessage());
        }
    }
    
    private void handleConnectionEvent(WatchedEvent event) {
        System.out.println("è¿æ¥çŠ¶æ€å˜åŒ–: " + event.getState());
        
        switch (event.getState()) {
            case Disconnected:
                System.out.println("ä¸ZooKeeperæ–­å¼€è¿æ¥");
                break;
            case Expired:
                System.out.println("ä¼šè¯è¿‡æœŸï¼Œéœ€è¦é‡æ–°è¿æ¥");
                break;
            case ConnectedReadOnly:
                System.out.println("åªè¯»è¿æ¥æ¨¡å¼");
                break;
        }
    }
}
```

### 4.3 å¤åˆäº‹ä»¶å¤„ç†

**ğŸ”— å¤„ç†è¿ç»­å‘ç”Ÿçš„å¤šä¸ªäº‹ä»¶**

```java
public class CompositeEventHandler implements Watcher {
    private Map<String, Long> lastEventTime = new ConcurrentHashMap<>();
    private final long eventCooldown = 100; // 100mså†·å´æ—¶é—´
    
    @Override
    public void process(WatchedEvent event) {
        String eventKey = event.getPath() + "_" + event.getType();
        long currentTime = System.currentTimeMillis();
        
        // é˜²æ­¢é‡å¤äº‹ä»¶é¢‘ç¹è§¦å‘
        Long lastTime = lastEventTime.get(eventKey);
        if (lastTime != null && (currentTime - lastTime) < eventCooldown) {
            System.out.println("è·³è¿‡é‡å¤äº‹ä»¶: " + eventKey);
            return;
        }
        
        lastEventTime.put(eventKey, currentTime);
        
        // å¤„ç†ç»„åˆäº‹ä»¶åœºæ™¯
        if (event.getType() == Event.EventType.NodeCreated) {
            // èŠ‚ç‚¹åˆ›å»ºåç«‹å³ç›‘å¬å…¶æ•°æ®å˜åŒ–
            try {
                zk.getData(event.getPath(), this, null);
                zk.getChildren(event.getPath(), this); // åŒæ—¶ç›‘å¬å­èŠ‚ç‚¹
            } catch (Exception e) {
                System.err.println("è®¾ç½®ç»„åˆç›‘å¬å¤±è´¥: " + e.getMessage());
            }
        }
    }
}
```

---

## 5. ğŸ›¡ï¸ å¼‚å¸¸å¤„ç†ç­–ç•¥


### 5.1 å¸¸è§å¼‚å¸¸ç±»å‹å’Œå¤„ç†

**âš ï¸ Watcherç¼–ç¨‹ä¸­çš„å…¸å‹å¼‚å¸¸**

```java
public class RobustWatcher implements Watcher {
    private ZooKeeper zk;
    private String watchPath;
    private volatile boolean isRunning = true;
    
    @Override
    public void process(WatchedEvent event) {
        if (!isRunning) return;
        
        try {
            processEventSafely(event);
        } catch (KeeperException.NoNodeException e) {
            handleNodeNotExists(event.getPath(), e);
        } catch (KeeperException.SessionExpiredException e) {
            handleSessionExpired(e);
        } catch (KeeperException.ConnectionLossException e) {
            handleConnectionLoss(e);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            handleInterruption(e);
        } catch (Exception e) {
            handleUnknownException(event, e);
        }
    }
    
    private void processEventSafely(WatchedEvent event) throws Exception {
        switch (event.getType()) {
            case NodeDataChanged:
                byte[] data = zk.getData(event.getPath(), this, null);
                System.out.println("å®‰å…¨å¤„ç†æ•°æ®å˜åŒ–: " + new String(data));
                break;
                
            case NodeChildrenChanged:
                List<String> children = zk.getChildren(event.getPath(), this);
                System.out.println("å®‰å…¨å¤„ç†å­èŠ‚ç‚¹å˜åŒ–: " + children);
                break;
        }
    }
    
    private void handleNodeNotExists(String path, KeeperException.NoNodeException e) {
        System.out.println("èŠ‚ç‚¹ä¸å­˜åœ¨: " + path + ", å°è¯•ç›‘å¬çˆ¶èŠ‚ç‚¹");
        try {
            // ç›‘å¬çˆ¶èŠ‚ç‚¹ï¼Œç­‰å¾…ç›®æ ‡èŠ‚ç‚¹é‡æ–°åˆ›å»º
            String parentPath = path.substring(0, path.lastIndexOf("/"));
            if (!parentPath.isEmpty()) {
                zk.getChildren(parentPath, this);
            }
        } catch (Exception ex) {
            System.err.println("ç›‘å¬çˆ¶èŠ‚ç‚¹å¤±è´¥: " + ex.getMessage());
        }
    }
    
    private void handleSessionExpired(KeeperException.SessionExpiredException e) {
        System.out.println("ä¼šè¯è¿‡æœŸï¼Œéœ€è¦é‡æ–°å»ºç«‹è¿æ¥");
        isRunning = false;
        // é€šçŸ¥ä¸Šå±‚åº”ç”¨é‡æ–°è¿æ¥
        notifySessionExpired();
    }
    
    private void handleConnectionLoss(KeeperException.ConnectionLossException e) {
        System.out.println("è¿æ¥ä¸¢å¤±ï¼Œç­‰å¾…è‡ªåŠ¨é‡è¿...");
        // ZooKeeperå®¢æˆ·ç«¯ä¼šè‡ªåŠ¨é‡è¿ï¼Œæ— éœ€ç‰¹æ®Šå¤„ç†
    }
    
    private void handleInterruption(InterruptedException e) {
        System.out.println("æ“ä½œè¢«ä¸­æ–­");
        isRunning = false;
    }
    
    private void handleUnknownException(WatchedEvent event, Exception e) {
        System.err.println("å¤„ç†äº‹ä»¶æ—¶å‘ç”ŸæœªçŸ¥å¼‚å¸¸: " + event.getType());
        System.err.println("å¼‚å¸¸ä¿¡æ¯: " + e.getMessage());
        
        // è®°å½•å¼‚å¸¸ä½†ç»§ç»­è¿è¡Œ
        logException(event, e);
    }
    
    private void notifySessionExpired() {
        // å®ç°ä¼šè¯è¿‡æœŸé€šçŸ¥æœºåˆ¶
        System.out.println("é€šçŸ¥åº”ç”¨å±‚ï¼šZooKeeperä¼šè¯å·²è¿‡æœŸ");
    }
    
    private void logException(WatchedEvent event, Exception e) {
        // å®ç°å¼‚å¸¸æ—¥å¿—è®°å½•
        System.err.println("äº‹ä»¶å¤„ç†å¼‚å¸¸æ—¥å¿—å·²è®°å½•");
    }
}
```

### 5.2 é‡è¯•æœºåˆ¶å®ç°

**ğŸ” æ™ºèƒ½é‡è¯•ç­–ç•¥**

```java
public class RetryableWatcher implements Watcher {
    private ZooKeeper zk;
    private final int maxRetries = 3;
    private final long retryDelay = 1000; // 1ç§’
    
    @Override
    public void process(WatchedEvent event) {
        executeWithRetry(() -> processEvent(event), maxRetries);
    }
    
    private void executeWithRetry(Runnable operation, int maxAttempts) {
        int attempts = 0;
        Exception lastException = null;
        
        while (attempts < maxAttempts) {
            try {
                operation.run();
                return; // æˆåŠŸæ‰§è¡Œï¼Œé€€å‡ºé‡è¯•å¾ªç¯
            } catch (Exception e) {
                lastException = e;
                attempts++;
                
                if (attempts < maxAttempts) {
                    System.out.println("æ“ä½œå¤±è´¥ï¼Œé‡è¯•ç¬¬" + attempts + "æ¬¡");
                    try {
                        Thread.sleep(retryDelay * attempts); // æŒ‡æ•°é€€é¿
                    } catch (InterruptedException ie) {
                        Thread.currentThread().interrupt();
                        break;
                    }
                }
            }
        }
        
        // æ‰€æœ‰é‡è¯•éƒ½å¤±è´¥
        System.err.println("é‡è¯•" + maxAttempts + "æ¬¡åä»ç„¶å¤±è´¥: " + 
                          lastException.getMessage());
    }
    
    private void processEvent(WatchedEvent event) throws Exception {
        // å…·ä½“çš„äº‹ä»¶å¤„ç†é€»è¾‘
        if (event.getType() == Event.EventType.NodeDataChanged) {
            byte[] data = zk.getData(event.getPath(), this, null);
            handleDataChange(data);
        }
    }
    
    private void handleDataChange(byte[] data) {
        System.out.println("é‡è¯•æˆåŠŸï¼Œæ•°æ®: " + new String(data));
    }
}
```

---

## 6. ğŸ–ï¸ æœ€ä½³å®è·µæŒ‡å—


### 6.1 Watcherè®¾è®¡åŸåˆ™

**ğŸ“‹ ç”Ÿäº§ç¯å¢ƒçš„æœ€ä½³å®è·µ**

```
è®¾è®¡åŸåˆ™æ¸…å•ï¼š

âœ… è½»é‡çº§å¤„ç†
- åœ¨process()æ–¹æ³•ä¸­æ‰§è¡Œè½»é‡çº§æ“ä½œ
- é‡çš„ä¸šåŠ¡é€»è¾‘æ”¾åˆ°å¼‚æ­¥çº¿ç¨‹å¤„ç†
- é¿å…é˜»å¡Watcherçº¿ç¨‹

âœ… å¼‚å¸¸å®‰å…¨
- æ•è·æ‰€æœ‰å¯èƒ½çš„å¼‚å¸¸
- å¼‚å¸¸ä¸èƒ½å½±å“å…¶ä»–Watcher
- æä¾›é™çº§å¤„ç†æ–¹æ¡ˆ

âœ… èµ„æºç®¡ç†
- åŠæ—¶å…³é—­ä¸å†éœ€è¦çš„Watcher
- é¿å…å†…å­˜æ³„æ¼
- åˆç†æ§åˆ¶çº¿ç¨‹æ± å¤§å°

âœ… å¹‚ç­‰æ€§è®¾è®¡
- é‡å¤äº‹ä»¶çš„å¤„ç†è¦å¹‚ç­‰
- çŠ¶æ€å˜æ›´è¦åŸå­æ€§
- é¿å…å¹¶å‘é—®é¢˜
```

### 6.2 ç”Ÿäº§çº§Watcherå®ç°

**ğŸ­ ä¼ä¸šçº§Watcheræ¨¡æ¿**

```java
public class ProductionWatcher implements Watcher {
    private static final Logger logger = LoggerFactory.getLogger(ProductionWatcher.class);
    
    private final ZooKeeper zk;
    private final String nodePath;
    private final ExecutorService executor;
    private final AtomicBoolean isActive;
    private final RetryPolicy retryPolicy;
    
    public ProductionWatcher(ZooKeeper zk, String nodePath) {
        this.zk = zk;
        this.nodePath = nodePath;
        this.executor = Executors.newSingleThreadExecutor(r -> {
            Thread t = new Thread(r, "Watcher-" + nodePath);
            t.setDaemon(true);
            return t;
        });
        this.isActive = new AtomicBoolean(true);
        this.retryPolicy = new ExponentialBackoffRetry(1000, 3);
    }
    
    @Override
    public void process(WatchedEvent event) {
        if (!isActive.get()) {
            return;
        }
        
        // å¼‚æ­¥å¤„ç†äº‹ä»¶
        executor.submit(() -> {
            try {
                handleEventWithRetry(event);
            } catch (Exception e) {
                logger.error("å¤„ç†äº‹ä»¶å¤±è´¥: {}", event, e);
            }
        });
    }
    
    private void handleEventWithRetry(WatchedEvent event) {
        retryPolicy.execute(() -> {
            switch (event.getType()) {
                case NodeDataChanged:
                    handleDataChanged(event.getPath());
                    break;
                case NodeChildrenChanged:
                    handleChildrenChanged(event.getPath());
                    break;
                case NodeDeleted:
                    handleNodeDeleted(event.getPath());
                    break;
                default:
                    logger.debug("å¿½ç•¥äº‹ä»¶ç±»å‹: {}", event.getType());
            }
        });
    }
    
    private void handleDataChanged(String path) throws Exception {
        byte[] data = zk.getData(path, this, null);
        logger.info("èŠ‚ç‚¹æ•°æ®å˜åŒ–: {} -> {}", path, new String(data));
        
        // ä¸šåŠ¡é€»è¾‘å¤„ç†
        processBusinessLogic(data);
    }
    
    private void handleChildrenChanged(String path) throws Exception {
        List<String> children = zk.getChildren(path, this);
        logger.info("å­èŠ‚ç‚¹å˜åŒ–: {} -> {}", path, children);
    }
    
    private void handleNodeDeleted(String path) {
        logger.warn("èŠ‚ç‚¹è¢«åˆ é™¤: {}", path);
        // å¯ä»¥é€‰æ‹©ç›‘å¬çˆ¶èŠ‚ç‚¹ç­‰å¾…é‡å»º
    }
    
    private void processBusinessLogic(byte[] data) {
        // å…·ä½“çš„ä¸šåŠ¡å¤„ç†é€»è¾‘
        logger.debug("å¤„ç†ä¸šåŠ¡é€»è¾‘: {}", new String(data));
    }
    
    // ä¼˜é›…å…³é—­
    public void close() {
        isActive.set(false);
        executor.shutdown();
        try {
            if (!executor.awaitTermination(5, TimeUnit.SECONDS)) {
                executor.shutdownNow();
            }
        } catch (InterruptedException e) {
            executor.shutdownNow();
            Thread.currentThread().interrupt();
        }
    }
    
    // é‡è¯•ç­–ç•¥æ¥å£
    interface RetryPolicy {
        void execute(Runnable operation) throws Exception;
    }
    
    // æŒ‡æ•°é€€é¿é‡è¯•å®ç°
    static class ExponentialBackoffRetry implements RetryPolicy {
        private final long baseDelay;
        private final int maxRetries;
        
        public ExponentialBackoffRetry(long baseDelay, int maxRetries) {
            this.baseDelay = baseDelay;
            this.maxRetries = maxRetries;
        }
        
        @Override
        public void execute(Runnable operation) throws Exception {
            for (int i = 0; i <= maxRetries; i++) {
                try {
                    operation.run();
                    return;
                } catch (Exception e) {
                    if (i == maxRetries) {
                        throw e;
                    }
                    Thread.sleep(baseDelay * (1 << i)); // æŒ‡æ•°é€€é¿
                }
            }
        }
    }
}
```

### 6.3 ç›‘æ§å’Œè°ƒè¯•

**ğŸ“Š Watcherè¿è¡ŒçŠ¶æ€ç›‘æ§**

```java
public class WatcherMonitor {
    private final Map<String, WatcherStats> watcherStats = new ConcurrentHashMap<>();
    
    public void recordEvent(String watcherPath, Event.EventType eventType) {
        WatcherStats stats = watcherStats.computeIfAbsent(watcherPath, 
            k -> new WatcherStats());
        stats.recordEvent(eventType);
    }
    
    public void recordException(String watcherPath, Exception e) {
        WatcherStats stats = watcherStats.get(watcherPath);
        if (stats != null) {
            stats.recordException(e);
        }
    }
    
    // è·å–ç›‘æ§æŠ¥å‘Š
    public String getMonitorReport() {
        StringBuilder report = new StringBuilder();
        report.append("Watcherç›‘æ§æŠ¥å‘Š:\n");
        
        watcherStats.forEach((path, stats) -> {
            report.append(String.format("è·¯å¾„: %s, äº‹ä»¶æ•°: %d, å¼‚å¸¸æ•°: %d\n",
                path, stats.getEventCount(), stats.getExceptionCount()));
        });
        
        return report.toString();
    }
    
    static class WatcherStats {
        private final AtomicLong eventCount = new AtomicLong(0);
        private final AtomicLong exceptionCount = new AtomicLong(0);
        private final Map<Event.EventType, AtomicLong> eventTypeCount = new ConcurrentHashMap<>();
        
        public void recordEvent(Event.EventType eventType) {
            eventCount.incrementAndGet();
            eventTypeCount.computeIfAbsent(eventType, k -> new AtomicLong(0))
                          .incrementAndGet();
        }
        
        public void recordException(Exception e) {
            exceptionCount.incrementAndGet();
        }
        
        public long getEventCount() { return eventCount.get(); }
        public long getExceptionCount() { return exceptionCount.get(); }
    }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Watcheræœºåˆ¶ï¼šä¸€æ¬¡æ€§äº‹ä»¶é€šçŸ¥æœºåˆ¶ï¼Œç±»ä¼¼"é—¨é“ƒ"ç³»ç»Ÿ
ğŸ”¸ æ¥å£å®ç°ï¼šå®ç°Watcheræ¥å£ï¼Œé‡å†™process()æ–¹æ³•å¤„ç†äº‹ä»¶
ğŸ”¸ äº‹ä»¶å¤„ç†ï¼šæ ¹æ®äº‹ä»¶ç±»å‹æ‰§è¡Œç›¸åº”çš„ä¸šåŠ¡é€»è¾‘
ğŸ”¸ é‡å¤æ³¨å†Œï¼šWatcherè§¦å‘åè‡ªåŠ¨å¤±æ•ˆï¼Œéœ€æ‰‹åŠ¨é‡æ–°æ³¨å†Œ
ğŸ”¸ äº‹ä»¶ç±»å‹ï¼šNodeCreatedã€NodeDeletedã€NodeDataChangedã€NodeChildrenChanged
ğŸ”¸ å¼‚å¸¸å¤„ç†ï¼šç½‘ç»œå¼‚å¸¸ã€èŠ‚ç‚¹ä¸å­˜åœ¨ã€ä¼šè¯è¿‡æœŸç­‰å¼‚å¸¸åœºæ™¯
ğŸ”¸ æœ€ä½³å®è·µï¼šå¼‚æ­¥å¤„ç†ã€å¼‚å¸¸å®‰å…¨ã€èµ„æºç®¡ç†ã€å¹‚ç­‰è®¾è®¡
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ Watcherçš„å·¥ä½œç‰¹ç‚¹**
```
ä¸€æ¬¡æ€§è§¦å‘ï¼š
- æ¯ä¸ªWatcheråªèƒ½è§¦å‘ä¸€æ¬¡
- è§¦å‘åè‡ªåŠ¨ä»ZooKeeperç§»é™¤
- éœ€è¦åœ¨äº‹ä»¶å¤„ç†ä¸­é‡æ–°æ³¨å†Œ

å¼‚æ­¥é€šçŸ¥ï¼š
- äº‹ä»¶å¤„ç†ä¸ä¼šé˜»å¡ZooKeeperæ“ä½œ
- é€‚åˆç”¨å¼‚æ­¥çº¿ç¨‹å¤„ç†é‡ä¸šåŠ¡é€»è¾‘
- é¿å…åœ¨process()æ–¹æ³•ä¸­æ‰§è¡Œè€—æ—¶æ“ä½œ

è·¯å¾„ç»‘å®šï¼š
- Watcherä¸ç‰¹å®šèŠ‚ç‚¹è·¯å¾„ç»‘å®š
- åªæ¥æ”¶è¯¥è·¯å¾„ç›¸å…³çš„äº‹ä»¶
- æ”¯æŒç›‘å¬æ•°æ®å˜åŒ–å’Œå­èŠ‚ç‚¹å˜åŒ–
```

**ğŸ”¹ äº‹ä»¶å¤„ç†çš„æ ¸å¿ƒæ¨¡å¼**
```
äº‹ä»¶åˆ†å‘æ¨¡å¼ï¼š
- æ ¹æ®äº‹ä»¶ç±»å‹åˆ†å‘åˆ°ä¸åŒå¤„ç†å™¨
- ä½¿ç”¨ç­–ç•¥æ¨¡å¼å¤„ç†ä¸åŒç±»å‹äº‹ä»¶
- ä¾¿äºæ‰©å±•å’Œç»´æŠ¤

é‡æ–°æ³¨å†Œæ¨¡å¼ï¼š
- åœ¨äº‹ä»¶å¤„ç†å®Œæˆåç«‹å³é‡æ–°æ³¨å†Œ
- ç¡®ä¿ç›‘å¬çš„è¿ç»­æ€§
- å¤„ç†èŠ‚ç‚¹åˆ é™¤ç­‰ç‰¹æ®Šåœºæ™¯

å¼‚å¸¸æ¢å¤æ¨¡å¼ï¼š
- æ•è·å¹¶å¤„ç†å„ç§å¼‚å¸¸æƒ…å†µ
- å®ç°é‡è¯•æœºåˆ¶å’Œé™çº§æ–¹æ¡ˆ
- ä¿è¯ç›‘å¬æœåŠ¡çš„ç¨³å®šè¿è¡Œ
```

**ğŸ”¹ ç”Ÿäº§ç¯å¢ƒçš„å…³é”®è€ƒè™‘**
```
æ€§èƒ½ä¼˜åŒ–ï¼š
- ä½¿ç”¨çº¿ç¨‹æ± å¼‚æ­¥å¤„ç†äº‹ä»¶
- é¿å…åœ¨Watcherçº¿ç¨‹ä¸­æ‰§è¡Œé‡æ“ä½œ
- åˆç†è®¾ç½®é‡è¯•ç­–ç•¥å’Œè¶…æ—¶æ—¶é—´

ç¨³å®šæ€§ä¿è¯ï¼š
- å®Œå–„çš„å¼‚å¸¸å¤„ç†æœºåˆ¶
- èµ„æºæ³„æ¼é˜²æŠ¤
- ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶

ä¸šåŠ¡è§£è€¦ï¼š
- Watcheråªè´Ÿè´£äº‹ä»¶é€šçŸ¥
- ä¸šåŠ¡é€»è¾‘ä¸ç›‘å¬æœºåˆ¶åˆ†ç¦»
- æ”¯æŒåŠ¨æ€é…ç½®å’Œçƒ­æ›´æ–°
```

### 7.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ å…¸å‹åº”ç”¨åœºæ™¯**
- **é…ç½®ä¸­å¿ƒ**ï¼šç›‘å¬é…ç½®å˜åŒ–ï¼Œå®æ—¶æ›´æ–°åº”ç”¨é…ç½®
- **æœåŠ¡å‘ç°**ï¼šç›‘å¬æœåŠ¡èŠ‚ç‚¹å˜åŒ–ï¼ŒåŠ¨æ€æ›´æ–°æœåŠ¡åˆ—è¡¨
- **åˆ†å¸ƒå¼é”**ï¼šç›‘å¬é”èŠ‚ç‚¹çŠ¶æ€ï¼Œå®ç°ç­‰å¾…é˜Ÿåˆ—
- **é›†ç¾¤ç®¡ç†**ï¼šç›‘å¬é›†ç¾¤æˆå‘˜å˜åŒ–ï¼Œå®ç°æ•…éšœè½¬ç§»

**ğŸ”§ å¼€å‘å®è·µå»ºè®®**
- **åˆ†å±‚è®¾è®¡**ï¼šåŒºåˆ†ç›‘å¬å±‚ã€äº‹ä»¶å¤„ç†å±‚ã€ä¸šåŠ¡é€»è¾‘å±‚
- **å¼‚æ­¥å¤„ç†**ï¼šä½¿ç”¨çº¿ç¨‹æ± é¿å…é˜»å¡Watcherçº¿ç¨‹
- **å¼‚å¸¸å®‰å…¨**ï¼šå®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œé™çº§æœºåˆ¶
- **ç›‘æ§å®Œå–„**ï¼šå»ºç«‹Watcherè¿è¡ŒçŠ¶æ€çš„ç›‘æ§ä½“ç³»

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- Watcheré—¨é“ƒä¸€æ¬¡å“ï¼Œäº‹ä»¶å¤„ç†è¦é‡æ–°è£…
- å¼‚æ­¥å¤„ç†ä¿æ€§èƒ½ï¼Œå¼‚å¸¸å®‰å…¨ä¸èƒ½å¿˜
- ç±»å‹åˆ¤æ–­è·¯å¾„æ¸…ï¼Œé‡è¯•æœºåˆ¶è¦æ™ºèƒ½
- ç›‘æ§æ—¥å¿—å…¨è¦†ç›–ï¼Œç”Ÿäº§ç¯å¢ƒç¨³å¦‚å±±