---
title: 9ã€æœåŠ¡æ³¨å†Œå‘ç°å®ç°
---
## ğŸ“š ç›®å½•

1. [æœåŠ¡æ³¨å†Œå‘ç°åŸºæœ¬æ¦‚å¿µ](#1-æœåŠ¡æ³¨å†Œå‘ç°åŸºæœ¬æ¦‚å¿µ)
2. [Zookeeperå®ç°æœåŠ¡æ³¨å†Œ](#2-zookeeperå®ç°æœåŠ¡æ³¨å†Œ)
3. [æœåŠ¡å‘ç°æœºåˆ¶è¯¦è§£](#3-æœåŠ¡å‘ç°æœºåˆ¶è¯¦è§£)
4. [å¥åº·æ£€æŸ¥å®ç°](#4-å¥åº·æ£€æŸ¥å®ç°)
5. [è´Ÿè½½å‡è¡¡ç­–ç•¥](#5-è´Ÿè½½å‡è¡¡ç­–ç•¥)
6. [å®Œæ•´å®æˆ˜ç¤ºä¾‹](#6-å®Œæ•´å®æˆ˜ç¤ºä¾‹)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ æœåŠ¡æ³¨å†Œå‘ç°åŸºæœ¬æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯æœåŠ¡æ³¨å†Œå‘ç°


**é€šä¿—ç†è§£**ï¼šå°±åƒç”µè¯é»„é¡µä¸€æ ·ï¼ŒæœåŠ¡æ³¨å†Œå‘ç°å¸®åŠ©å¾®æœåŠ¡ä¹‹é—´äº’ç›¸æ‰¾åˆ°å¯¹æ–¹ã€‚

```
ç”Ÿæ´»ç±»æ¯”ï¼š
æ‰¾é¤å…åƒé¥­ â†’ æŸ¥çœ‹å¤§ä¼—ç‚¹è¯„ â†’ æ‰¾åˆ°é™„è¿‘çš„é¤å… â†’ é€‰æ‹©ä¸€å®¶å»åƒ

å¾®æœåŠ¡åœºæ™¯ï¼š
æœåŠ¡Aéœ€è¦è°ƒç”¨æœåŠ¡B â†’ æŸ¥è¯¢æ³¨å†Œä¸­å¿ƒ â†’ æ‰¾åˆ°æœåŠ¡Bçš„å®ä¾‹ â†’ é€‰æ‹©ä¸€ä¸ªå®ä¾‹è°ƒç”¨
```

**æ ¸å¿ƒä½œç”¨**ï¼š
- ğŸ”¸ **æœåŠ¡æ³¨å†Œ**ï¼šæœåŠ¡å¯åŠ¨æ—¶å‘Šè¯‰æ³¨å†Œä¸­å¿ƒ"æˆ‘åœ¨è¿™é‡Œ"
- ğŸ”¸ **æœåŠ¡å‘ç°**ï¼šå…¶ä»–æœåŠ¡å¯ä»¥æ‰¾åˆ°å¹¶è°ƒç”¨è¿™ä¸ªæœåŠ¡
- ğŸ”¸ **å¥åº·ç®¡ç†**ï¼šè‡ªåŠ¨å‰”é™¤ä¸å¥åº·çš„æœåŠ¡å®ä¾‹
- ğŸ”¸ **è´Ÿè½½å‡è¡¡**ï¼šåœ¨å¤šä¸ªå®ä¾‹ä¸­é€‰æ‹©æœ€åˆé€‚çš„ä¸€ä¸ª

### 1.2 ä¼ ç»Ÿæ–¹å¼ vs æœåŠ¡æ³¨å†Œå‘ç°


```
ä¼ ç»Ÿç¡¬ç¼–ç æ–¹å¼ï¼š
æœåŠ¡Aä»£ç  â†’ ç›´æ¥å†™æ­»æœåŠ¡Bçš„IP:Port â†’ è°ƒç”¨æœåŠ¡B
é—®é¢˜ï¼šIPå˜äº†ä»£ç å°±è¦æ”¹ï¼ŒæœåŠ¡BæŒ‚äº†æ— æ³•è‡ªåŠ¨åˆ‡æ¢

æœåŠ¡æ³¨å†Œå‘ç°æ–¹å¼ï¼š
æœåŠ¡A â†’ è¯¢é—®æ³¨å†Œä¸­å¿ƒ â†’ è·å–æœåŠ¡Bçš„å¯ç”¨å®ä¾‹åˆ—è¡¨ â†’ é€‰æ‹©ä¸€ä¸ªè°ƒç”¨
ä¼˜åŠ¿ï¼šåŠ¨æ€å‘ç°ï¼Œè‡ªåŠ¨æ•…éšœè½¬ç§»ï¼Œæ”¯æŒæ°´å¹³æ‰©å±•
```

### 1.3 Zookeeperåœ¨æœåŠ¡å‘ç°ä¸­çš„ä¼˜åŠ¿


**ä¸ºä»€ä¹ˆé€‰æ‹©Zookeeper**ï¼š
```
ä¸€è‡´æ€§ä¿è¯ï¼š
â€¢ å¼ºä¸€è‡´æ€§ï¼Œæ•°æ®ä¸ä¼šå‡ºç°åˆ†æ­§
â€¢ é€‚åˆå¯¹æ•°æ®å‡†ç¡®æ€§è¦æ±‚é«˜çš„åœºæ™¯

ç›‘å¬æœºåˆ¶ï¼š
â€¢ æœåŠ¡çŠ¶æ€å˜åŒ–æ—¶ç«‹å³é€šçŸ¥
â€¢ å®æ—¶æ€§å¥½ï¼Œå“åº”å¿«

æ ‘å½¢ç»“æ„ï¼š
â€¢ å¤©ç„¶æ”¯æŒæœåŠ¡åˆ†ç»„å’Œåˆ†ç±»
â€¢ ä¾¿äºç®¡ç†å¤æ‚çš„æœåŠ¡å…³ç³»
```

---

## 2. ğŸ“ Zookeeperå®ç°æœåŠ¡æ³¨å†Œ


### 2.1 æœåŠ¡æ³¨å†Œçš„åŸºæœ¬æ€è·¯


**æ ¸å¿ƒæ€æƒ³**ï¼šæ¯ä¸ªæœåŠ¡å®ä¾‹åœ¨Zookeeperä¸­åˆ›å»ºä¸€ä¸ªä¸´æ—¶é¡ºåºèŠ‚ç‚¹

```
ZookeeperèŠ‚ç‚¹ç»“æ„ï¼š
/services
    /user-service
        /instance-0000000001  (IP:PORT + å…ƒæ•°æ®)
        /instance-0000000002  (IP:PORT + å…ƒæ•°æ®)
        /instance-0000000003  (IP:PORT + å…ƒæ•°æ®)
    /order-service  
        /instance-0000000001  (IP:PORT + å…ƒæ•°æ®)

ä¸ºä»€ä¹ˆç”¨ä¸´æ—¶èŠ‚ç‚¹ï¼Ÿ
â€¢ æœåŠ¡æŒ‚äº†ï¼ŒèŠ‚ç‚¹è‡ªåŠ¨åˆ é™¤
â€¢ å…¶ä»–æœåŠ¡ç«‹å³çŸ¥é“è¿™ä¸ªå®ä¾‹ä¸å¯ç”¨äº†
```

### 2.2 æœåŠ¡æ³¨å†Œæ ¸å¿ƒå®ç°


```java
public class ServiceRegistry {
    private ZooKeeper zk;
    private String servicePath;
    private String instancePath;
    
    public ServiceRegistry(String zkConnectString, String serviceName) {
        this.zk = new ZooKeeper(zkConnectString, 3000, null);
        this.servicePath = "/services/" + serviceName;
    }
    
    /**
     * æ³¨å†ŒæœåŠ¡å®ä¾‹
     */
    public void register(String host, int port, Map<String, String> metadata) {
        try {
            // 1. ç¡®ä¿æœåŠ¡æ ¹è·¯å¾„å­˜åœ¨
            ensurePathExists(servicePath);
            
            // 2. åˆ›å»ºæœåŠ¡å®ä¾‹ä¿¡æ¯
            ServiceInstance instance = new ServiceInstance(host, port, metadata);
            String instanceData = JSON.toJSONString(instance);
            
            // 3. åˆ›å»ºä¸´æ—¶é¡ºåºèŠ‚ç‚¹
            String actualPath = zk.create(
                servicePath + "/instance-",
                instanceData.getBytes(),
                ZooDefs.Ids.OPEN_ACL_UNSAFE,
                CreateMode.EPHEMERAL_SEQUENTIAL  // ä¸´æ—¶é¡ºåºèŠ‚ç‚¹
            );
            
            this.instancePath = actualPath;
            System.out.println("æœåŠ¡æ³¨å†ŒæˆåŠŸ: " + actualPath);
            
        } catch (Exception e) {
            throw new RuntimeException("æœåŠ¡æ³¨å†Œå¤±è´¥", e);
        }
    }
    
    /**
     * ç¡®ä¿è·¯å¾„å­˜åœ¨
     */
    private void ensurePathExists(String path) throws Exception {
        if (zk.exists(path, false) == null) {
            // é€’å½’åˆ›å»ºçˆ¶è·¯å¾„
            String parentPath = path.substring(0, path.lastIndexOf("/"));
            if (!parentPath.isEmpty()) {
                ensurePathExists(parentPath);
            }
            
            zk.create(path, new byte[0], 
                     ZooDefs.Ids.OPEN_ACL_UNSAFE, 
                     CreateMode.PERSISTENT);
        }
    }
}

/**
 * æœåŠ¡å®ä¾‹ä¿¡æ¯
 */
class ServiceInstance {
    private String host;
    private int port;
    private Map<String, String> metadata;
    private long registerTime;
    
    public ServiceInstance(String host, int port, Map<String, String> metadata) {
        this.host = host;
        this.port = port;
        this.metadata = metadata;
        this.registerTime = System.currentTimeMillis();
    }
    
    // getters and setters...
}
```

### 2.3 æœåŠ¡æ³¨å†Œä½¿ç”¨ç¤ºä¾‹


```java
public class UserService {
    public static void main(String[] args) {
        // 1. åˆ›å»ºæœåŠ¡æ³¨å†Œå™¨
        ServiceRegistry registry = new ServiceRegistry(
            "localhost:2181", 
            "user-service"
        );
        
        // 2. å‡†å¤‡æœåŠ¡å…ƒæ•°æ®
        Map<String, String> metadata = new HashMap<>();
        metadata.put("version", "1.0.0");
        metadata.put("weight", "100");
        metadata.put("tags", "prod,core");
        
        // 3. æ³¨å†ŒæœåŠ¡
        registry.register("192.168.1.100", 8080, metadata);
        
        // 4. å¯åŠ¨å®é™…çš„ä¸šåŠ¡æœåŠ¡
        startBusinessService();
        
        // 5. ç¨‹åºç»“æŸæ—¶ä¼šè‡ªåŠ¨æ³¨é”€ï¼ˆä¸´æ—¶èŠ‚ç‚¹ç‰¹æ€§ï¼‰
    }
    
    private static void startBusinessService() {
        // å¯åŠ¨Spring Bootã€Tomcatç­‰ä¸šåŠ¡æœåŠ¡
        System.out.println("ç”¨æˆ·æœåŠ¡å¯åŠ¨æˆåŠŸï¼Œç›‘å¬ç«¯å£8080");
        // ä¿æŒç¨‹åºè¿è¡Œ
        try { Thread.sleep(Long.MAX_VALUE); } catch (Exception e) {}
    }
}
```

---

## 3. ğŸ” æœåŠ¡å‘ç°æœºåˆ¶è¯¦è§£


### 3.1 æœåŠ¡å‘ç°çš„åŸºæœ¬æµç¨‹


```
æœåŠ¡å‘ç°æµç¨‹ï¼š
å®¢æˆ·ç«¯ â†’ æŸ¥è¯¢Zookeeper â†’ è·å–æœåŠ¡å®ä¾‹åˆ—è¡¨ â†’ é€‰æ‹©å®ä¾‹ â†’ å‘èµ·è°ƒç”¨

è¯¦ç»†æ­¥éª¤ï¼š
1. æŸ¥è¯¢ /services/user-service ä¸‹çš„æ‰€æœ‰å­èŠ‚ç‚¹
2. è¯»å–æ¯ä¸ªå­èŠ‚ç‚¹çš„æ•°æ®ï¼ˆæœåŠ¡å®ä¾‹ä¿¡æ¯ï¼‰
3. è¿‡æ»¤å¥åº·çš„å®ä¾‹
4. æ ¹æ®è´Ÿè½½å‡è¡¡ç­–ç•¥é€‰æ‹©ä¸€ä¸ªå®ä¾‹
5. å‘èµ·HTTPè°ƒç”¨
```

### 3.2 æœåŠ¡å‘ç°æ ¸å¿ƒå®ç°


```java
public class ServiceDiscovery {
    private ZooKeeper zk;
    private LoadBalancer loadBalancer;
    
    public ServiceDiscovery(String zkConnectString) {
        this.zk = new ZooKeeper(zkConnectString, 3000, null);
        this.loadBalancer = new RandomLoadBalancer(); // é»˜è®¤éšæœºè´Ÿè½½å‡è¡¡
    }
    
    /**
     * å‘ç°æœåŠ¡å®ä¾‹
     */
    public ServiceInstance discover(String serviceName) {
        try {
            String servicePath = "/services/" + serviceName;
            
            // 1. è·å–æ‰€æœ‰æœåŠ¡å®ä¾‹èŠ‚ç‚¹
            List<String> instances = zk.getChildren(servicePath, false);
            if (instances.isEmpty()) {
                throw new RuntimeException("æ²¡æœ‰å¯ç”¨çš„æœåŠ¡å®ä¾‹: " + serviceName);
            }
            
            // 2. è¯»å–å®ä¾‹è¯¦ç»†ä¿¡æ¯
            List<ServiceInstance> availableInstances = new ArrayList<>();
            for (String instanceNode : instances) {
                String instancePath = servicePath + "/" + instanceNode;
                byte[] data = zk.getData(instancePath, false, null);
                
                ServiceInstance instance = JSON.parseObject(
                    new String(data), ServiceInstance.class
                );
                
                // 3. å¥åº·æ£€æŸ¥ï¼ˆç®€å•ç¤ºä¾‹ï¼‰
                if (isInstanceHealthy(instance)) {
                    availableInstances.add(instance);
                }
            }
            
            if (availableInstances.isEmpty()) {
                throw new RuntimeException("æ²¡æœ‰å¥åº·çš„æœåŠ¡å®ä¾‹: " + serviceName);
            }
            
            // 4. è´Ÿè½½å‡è¡¡é€‰æ‹©å®ä¾‹
            return loadBalancer.choose(availableInstances);
            
        } catch (Exception e) {
            throw new RuntimeException("æœåŠ¡å‘ç°å¤±è´¥: " + serviceName, e);
        }
    }
    
    /**
     * ç®€å•çš„å¥åº·æ£€æŸ¥
     */
    private boolean isInstanceHealthy(ServiceInstance instance) {
        // è¿™é‡Œå¯ä»¥å®ç°å¤æ‚çš„å¥åº·æ£€æŸ¥é€»è¾‘
        // æ¯”å¦‚ï¼špingæ£€æŸ¥ã€HTTPå¥åº·æ£€æŸ¥ç­‰
        return true; // ç®€åŒ–ç¤ºä¾‹
    }
}
```

### 3.3 æœåŠ¡å‘ç°ä½¿ç”¨ç¤ºä¾‹


```java
public class OrderService {
    private ServiceDiscovery discovery;
    
    public OrderService() {
        this.discovery = new ServiceDiscovery("localhost:2181");
    }
    
    /**
     * è°ƒç”¨ç”¨æˆ·æœåŠ¡è·å–ç”¨æˆ·ä¿¡æ¯
     */
    public User getUserInfo(Long userId) {
        try {
            // 1. å‘ç°ç”¨æˆ·æœåŠ¡å®ä¾‹
            ServiceInstance userService = discovery.discover("user-service");
            
            // 2. æ„å»ºè°ƒç”¨URL
            String url = "http://" + userService.getHost() + ":" 
                        + userService.getPort() + "/users/" + userId;
            
            // 3. å‘èµ·HTTPè°ƒç”¨ï¼ˆä½¿ç”¨OkHttpã€RestTemplateç­‰ï¼‰
            String response = httpGet(url);
            
            // 4. è§£æè¿”å›ç»“æœ
            return JSON.parseObject(response, User.class);
            
        } catch (Exception e) {
            throw new RuntimeException("è°ƒç”¨ç”¨æˆ·æœåŠ¡å¤±è´¥", e);
        }
    }
    
    private String httpGet(String url) {
        // å®é™…çš„HTTPè°ƒç”¨å®ç°
        return "{}"; // ç®€åŒ–ç¤ºä¾‹
    }
}
```

---

## 4. ğŸ’“ å¥åº·æ£€æŸ¥å®ç°


### 4.1 å¥åº·æ£€æŸ¥çš„é‡è¦æ€§


**ä¸ºä»€ä¹ˆéœ€è¦å¥åº·æ£€æŸ¥**ï¼š
```
é—®é¢˜åœºæ™¯ï¼š
æœåŠ¡å®ä¾‹å·²ç»æ³¨å†Œï¼Œä½†æ˜¯ï¼š
â€¢ æœåŠ¡è¿›ç¨‹æ­»é”ï¼Œæ— æ³•å¤„ç†è¯·æ±‚
â€¢ æ•°æ®åº“è¿æ¥å¼‚å¸¸ï¼ŒæœåŠ¡ä¸å¯ç”¨
â€¢ å†…å­˜æº¢å‡ºï¼Œå“åº”è¶…æ—¶

è§£å†³æ–¹æ¡ˆï¼š
å®šæœŸæ£€æŸ¥æœåŠ¡å®ä¾‹çš„å¥åº·çŠ¶æ€
è‡ªåŠ¨å‰”é™¤ä¸å¥åº·çš„å®ä¾‹
```

### 4.2 å¥åº·æ£€æŸ¥å®ç°æ–¹å¼


**æ–¹å¼ä¸€ï¼šä¸»åŠ¨å¥åº·æ£€æŸ¥**
```java
public class HealthChecker {
    private ScheduledExecutorService scheduler;
    private ServiceDiscovery discovery;
    
    public HealthChecker(ServiceDiscovery discovery) {
        this.discovery = discovery;
        this.scheduler = Executors.newScheduledThreadPool(5);
    }
    
    /**
     * å¯åŠ¨å¥åº·æ£€æŸ¥
     */
    public void startHealthCheck() {
        scheduler.scheduleWithFixedDelay(() -> {
            try {
                checkAllServices();
            } catch (Exception e) {
                System.err.println("å¥åº·æ£€æŸ¥å¼‚å¸¸: " + e.getMessage());
            }
        }, 10, 30, TimeUnit.SECONDS); // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
    }
    
    private void checkAllServices() {
        List<String> services = getRegisteredServices();
        
        for (String serviceName : services) {
            checkServiceHealth(serviceName);
        }
    }
    
    private void checkServiceHealth(String serviceName) {
        List<ServiceInstance> instances = discovery.getAllInstances(serviceName);
        
        for (ServiceInstance instance : instances) {
            boolean isHealthy = performHealthCheck(instance);
            
            if (!isHealthy) {
                // æ ‡è®°ä¸ºä¸å¥åº·æˆ–ç§»é™¤å®ä¾‹
                markInstanceUnhealthy(instance);
                System.out.println("å®ä¾‹ä¸å¥åº·: " + instance.getHost() + ":" + instance.getPort());
            }
        }
    }
    
    /**
     * æ‰§è¡Œå…·ä½“çš„å¥åº·æ£€æŸ¥
     */
    private boolean performHealthCheck(ServiceInstance instance) {
        try {
            // HTTPå¥åº·æ£€æŸ¥
            String healthUrl = "http://" + instance.getHost() + ":" 
                             + instance.getPort() + "/health";
            
            // è®¾ç½®è¾ƒçŸ­çš„è¶…æ—¶æ—¶é—´
            String response = httpGetWithTimeout(healthUrl, 5000);
            
            // æ£€æŸ¥å“åº”å†…å®¹
            return response.contains("\"status\":\"UP\"");
            
        } catch (Exception e) {
            return false; // ä»»ä½•å¼‚å¸¸éƒ½è®¤ä¸ºä¸å¥åº·
        }
    }
}
```

**æ–¹å¼äºŒï¼šå¿ƒè·³ç»­çº¦æœºåˆ¶**
```java
public class HeartbeatService {
    private ScheduledExecutorService heartbeatExecutor;
    private ZooKeeper zk;
    private String instancePath;
    
    /**
     * å¯åŠ¨å¿ƒè·³ç»­çº¦
     */
    public void startHeartbeat() {
        heartbeatExecutor = Executors.newSingleThreadScheduledExecutor();
        
        heartbeatExecutor.scheduleWithFixedDelay(() -> {
            try {
                updateInstanceHeartbeat();
            } catch (Exception e) {
                System.err.println("å¿ƒè·³æ›´æ–°å¤±è´¥: " + e.getMessage());
            }
        }, 5, 10, TimeUnit.SECONDS); // æ¯10ç§’å‘é€ä¸€æ¬¡å¿ƒè·³
    }
    
    private void updateInstanceHeartbeat() throws Exception {
        // æ›´æ–°èŠ‚ç‚¹æ•°æ®ï¼ŒåŒ…å«æœ€æ–°çš„å¿ƒè·³æ—¶é—´
        ServiceInstance instance = getCurrentInstance();
        instance.setLastHeartbeat(System.currentTimeMillis());
        
        String data = JSON.toJSONString(instance);
        zk.setData(instancePath, data.getBytes(), -1);
    }
}
```

### 4.3 å¥åº·æ£€æŸ¥é…ç½®ç¤ºä¾‹


```java
/**
 * å¥åº·æ£€æŸ¥é…ç½®
 */
public class HealthCheckConfig {
    private int checkInterval = 30;        // æ£€æŸ¥é—´éš”ï¼ˆç§’ï¼‰
    private int timeout = 5;              // è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
    private int failureThreshold = 3;     // å¤±è´¥é˜ˆå€¼
    private String healthCheckUrl = "/health";
    
    // getters and setters...
}

/**
 * å¢å¼ºçš„å¥åº·æ£€æŸ¥å™¨
 */
public class EnhancedHealthChecker {
    private Map<String, Integer> failureCount = new ConcurrentHashMap<>();
    private HealthCheckConfig config;
    
    private boolean performHealthCheck(ServiceInstance instance) {
        String instanceKey = instance.getHost() + ":" + instance.getPort();
        
        try {
            boolean isHealthy = doActualHealthCheck(instance);
            
            if (isHealthy) {
                // é‡ç½®å¤±è´¥è®¡æ•°
                failureCount.put(instanceKey, 0);
                return true;
            } else {
                // å¢åŠ å¤±è´¥è®¡æ•°
                int count = failureCount.getOrDefault(instanceKey, 0) + 1;
                failureCount.put(instanceKey, count);
                
                // è¶…è¿‡é˜ˆå€¼æ‰è®¤ä¸ºä¸å¥åº·
                return count < config.getFailureThreshold();
            }
            
        } catch (Exception e) {
            int count = failureCount.getOrDefault(instanceKey, 0) + 1;
            failureCount.put(instanceKey, count);
            return count < config.getFailureThreshold();
        }
    }
}
```

---

## 5. âš–ï¸ è´Ÿè½½å‡è¡¡ç­–ç•¥


### 5.1 è´Ÿè½½å‡è¡¡çš„ä½œç”¨


**ä¸ºä»€ä¹ˆéœ€è¦è´Ÿè½½å‡è¡¡**ï¼š
```
åœºæ™¯ï¼šç”¨æˆ·æœåŠ¡æœ‰3ä¸ªå®ä¾‹
å®ä¾‹Aï¼š192.168.1.100:8080  
å®ä¾‹Bï¼š192.168.1.101:8080
å®ä¾‹Cï¼š192.168.1.102:8080

é—®é¢˜ï¼šè°ƒç”¨å“ªä¸€ä¸ªï¼Ÿ
â€¢ éšæœºé€‰æ‹©ï¼Ÿå¯èƒ½æŸä¸ªå®ä¾‹å‹åŠ›å¤§
â€¢ è½®è¯¢é€‰æ‹©ï¼Ÿå¯èƒ½æŸä¸ªå®ä¾‹æ€§èƒ½å·®
â€¢ æ™ºèƒ½é€‰æ‹©ï¼Ÿæ ¹æ®å®é™…æƒ…å†µåŠ¨æ€å†³ç­–
```

### 5.2 è´Ÿè½½å‡è¡¡ç­–ç•¥å®ç°


**ç­–ç•¥1ï¼šéšæœºè´Ÿè½½å‡è¡¡**
```java
public class RandomLoadBalancer implements LoadBalancer {
    private Random random = new Random();
    
    @Override
    public ServiceInstance choose(List<ServiceInstance> instances) {
        if (instances.isEmpty()) {
            return null;
        }
        
        int index = random.nextInt(instances.size());
        return instances.get(index);
    }
}
```

**ç­–ç•¥2ï¼šè½®è¯¢è´Ÿè½½å‡è¡¡**  
```java
public class RoundRobinLoadBalancer implements LoadBalancer {
    private AtomicInteger counter = new AtomicInteger(0);
    
    @Override
    public ServiceInstance choose(List<ServiceInstance> instances) {
        if (instances.isEmpty()) {
            return null;
        }
        
        int index = counter.getAndIncrement() % instances.size();
        return instances.get(index);
    }
}
```

**ç­–ç•¥3ï¼šåŠ æƒè´Ÿè½½å‡è¡¡**
```java
public class WeightedLoadBalancer implements LoadBalancer {
    
    @Override
    public ServiceInstance choose(List<ServiceInstance> instances) {
        if (instances.isEmpty()) {
            return null;
        }
        
        // 1. è®¡ç®—æ€»æƒé‡
        int totalWeight = instances.stream()
            .mapToInt(instance -> getWeight(instance))
            .sum();
            
        if (totalWeight <= 0) {
            // å¦‚æœæ²¡æœ‰æƒé‡ä¿¡æ¯ï¼Œä½¿ç”¨éšæœºç­–ç•¥
            return instances.get(new Random().nextInt(instances.size()));
        }
        
        // 2. éšæœºé€‰æ‹©ä¸€ä¸ªæƒé‡ç‚¹
        int randomWeight = new Random().nextInt(totalWeight);
        
        // 3. æ‰¾åˆ°å¯¹åº”çš„å®ä¾‹
        int currentWeight = 0;
        for (ServiceInstance instance : instances) {
            currentWeight += getWeight(instance);
            if (randomWeight < currentWeight) {
                return instance;
            }
        }
        
        return instances.get(0); // å…œåº•è¿”å›
    }
    
    private int getWeight(ServiceInstance instance) {
        String weight = instance.getMetadata().get("weight");
        return weight != null ? Integer.parseInt(weight) : 1;
    }
}
```

**ç­–ç•¥4ï¼šæœ€å°‘è¿æ¥è´Ÿè½½å‡è¡¡**
```java
public class LeastConnectionLoadBalancer implements LoadBalancer {
    private Map<String, Integer> connectionCount = new ConcurrentHashMap<>();
    
    @Override
    public ServiceInstance choose(List<ServiceInstance> instances) {
        if (instances.isEmpty()) {
            return null;
        }
        
        ServiceInstance chosen = null;
        int minConnections = Integer.MAX_VALUE;
        
        for (ServiceInstance instance : instances) {
            String key = instance.getHost() + ":" + instance.getPort();
            int connections = connectionCount.getOrDefault(key, 0);
            
            if (connections < minConnections) {
                minConnections = connections;
                chosen = instance;
            }
        }
        
        // å¢åŠ è¿æ¥æ•°
        if (chosen != null) {
            String key = chosen.getHost() + ":" + chosen.getPort();
            connectionCount.put(key, minConnections + 1);
        }
        
        return chosen;
    }
    
    /**
     * é‡Šæ”¾è¿æ¥ï¼ˆåœ¨è¯·æ±‚å®Œæˆåè°ƒç”¨ï¼‰
     */
    public void releaseConnection(ServiceInstance instance) {
        String key = instance.getHost() + ":" + instance.getPort();
        connectionCount.computeIfPresent(key, (k, v) -> Math.max(0, v - 1));
    }
}
```

### 5.3 è´Ÿè½½å‡è¡¡ç­–ç•¥é€‰æ‹©æŒ‡å¯¼


| ç­–ç•¥ç±»å‹ | **é€‚ç”¨åœºæ™¯** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** |
|---------|------------|---------|---------|
| ğŸ² **éšæœº** | `å®ä¾‹æ€§èƒ½ç›¸è¿‘ï¼Œç®€å•åœºæ™¯` | `å®ç°ç®€å•ï¼Œåˆ†å¸ƒå‡åŒ€` | `ä¸è€ƒè™‘å®ä¾‹è´Ÿè½½` |
| ğŸ”„ **è½®è¯¢** | `å®ä¾‹æ€§èƒ½ç›¸è¿‘ï¼Œéœ€è¦å¹³å‡åˆ†é…` | `ç»å¯¹å¹³å‡ï¼Œå…¬å¹³æ€§å¥½` | `ä¸è€ƒè™‘å®é™…è´Ÿè½½` |
| âš–ï¸ **åŠ æƒ** | `å®ä¾‹æ€§èƒ½ä¸åŒ` | `æ ¹æ®æ€§èƒ½åˆ†é…ï¼Œçµæ´»` | `éœ€è¦é…ç½®æƒé‡` |
| ğŸ“Š **æœ€å°‘è¿æ¥** | `è¯·æ±‚å¤„ç†æ—¶é—´å·®å¼‚å¤§` | `è€ƒè™‘å®é™…è´Ÿè½½` | `å®ç°å¤æ‚ï¼Œæœ‰çŠ¶æ€` |

---

## 6. ğŸš€ å®Œæ•´å®æˆ˜ç¤ºä¾‹


### 6.1 ç»¼åˆæœåŠ¡æ³¨å†Œå‘ç°æ¡†æ¶


```java
/**
 * æœåŠ¡æ³¨å†Œå‘ç°ç®¡ç†å™¨
 */
public class ServiceManager {
    private ZooKeeper zk;
    private ServiceRegistry registry;
    private ServiceDiscovery discovery;
    private HealthChecker healthChecker;
    private String currentServiceName;
    
    public ServiceManager(String zkConnectString, String serviceName) {
        try {
            this.zk = new ZooKeeper(zkConnectString, 3000, new DefaultWatcher());
            this.currentServiceName = serviceName;
            this.registry = new ServiceRegistry(zk, serviceName);
            this.discovery = new ServiceDiscovery(zk);
            this.healthChecker = new HealthChecker(discovery);
            
            // å¯åŠ¨å¥åº·æ£€æŸ¥
            healthChecker.startHealthCheck();
            
        } catch (Exception e) {
            throw new RuntimeException("ServiceManageråˆå§‹åŒ–å¤±è´¥", e);
        }
    }
    
    /**
     * æ³¨å†Œå½“å‰æœåŠ¡
     */
    public void registerSelf(String host, int port, Map<String, String> metadata) {
        registry.register(host, port, metadata);
        
        // æ·»åŠ JVMå…³é—­é’©å­ï¼Œç¡®ä¿ä¼˜é›…ä¸‹çº¿
        Runtime.getRuntime().addShutdownHook(new Thread(() -> {
            try {
                System.out.println("æ­£åœ¨æ³¨é”€æœåŠ¡...");
                registry.unregister();
                zk.close();
            } catch (Exception e) {
                System.err.println("æœåŠ¡æ³¨é”€å¤±è´¥: " + e.getMessage());
            }
        }));
    }
    
    /**
     * å‘ç°å¹¶è°ƒç”¨å…¶ä»–æœåŠ¡
     */
    public <T> T invokeService(String serviceName, String path, Class<T> responseType) {
        ServiceInstance instance = discovery.discover(serviceName);
        
        String url = "http://" + instance.getHost() + ":" 
                   + instance.getPort() + path;
        
        // è¿™é‡Œå¯ä»¥é›†æˆHTTPå®¢æˆ·ç«¯
        return performHttpCall(url, responseType);
    }
    
    private <T> T performHttpCall(String url, Class<T> responseType) {
        // å®é™…HTTPè°ƒç”¨å®ç°
        // å¯ä»¥ä½¿ç”¨OkHttpã€RestTemplateç­‰
        return null; // ç®€åŒ–ç¤ºä¾‹
    }
    
    /**
     * ç›‘å¬æœåŠ¡å˜åŒ–
     */
    public void watchService(String serviceName, ServiceChangeListener listener) {
        discovery.watchService(serviceName, listener);
    }
    
    private class DefaultWatcher implements Watcher {
        @Override
        public void process(WatchedEvent event) {
            System.out.println("ZKäº‹ä»¶: " + event.getType() + " - " + event.getPath());
        }
    }
}
```

### 6.2 å®é™…ä½¿ç”¨ç¤ºä¾‹


**ç”¨æˆ·æœåŠ¡å¯åŠ¨**ï¼š
```java
@SpringBootApplication
public class UserServiceApplication {
    
    public static void main(String[] args) {
        // 1. å¯åŠ¨Spring Bootåº”ç”¨
        SpringApplication.run(UserServiceApplication.class, args);
        
        // 2. åˆå§‹åŒ–æœåŠ¡ç®¡ç†å™¨
        ServiceManager serviceManager = new ServiceManager(
            "localhost:2181", 
            "user-service"
        );
        
        // 3. å‡†å¤‡æœåŠ¡å…ƒæ•°æ®
        Map<String, String> metadata = new HashMap<>();
        metadata.put("version", "1.2.0");
        metadata.put("weight", "100");
        metadata.put("region", "beijing");
        metadata.put("tags", "core,prod");
        
        // 4. æ³¨å†ŒæœåŠ¡
        String hostIP = getLocalHostIP();
        serviceManager.registerSelf(hostIP, 8080, metadata);
        
        System.out.println("ç”¨æˆ·æœåŠ¡å¯åŠ¨å®Œæˆï¼Œå·²æ³¨å†Œåˆ°Zookeeper");
    }
    
    private static String getLocalHostIP() {
        try {
            return InetAddress.getLocalHost().getHostAddress();
        } catch (Exception e) {
            return "localhost";
        }
    }
}
```

**è®¢å•æœåŠ¡è°ƒç”¨ç”¨æˆ·æœåŠ¡**ï¼š
```java
@RestController
public class OrderController {
    
    @Autowired
    private ServiceManager serviceManager;
    
    @GetMapping("/orders/{orderId}")
    public OrderDTO getOrder(@PathVariable Long orderId) {
        // 1. æŸ¥è¯¢è®¢å•åŸºæœ¬ä¿¡æ¯
        Order order = orderService.getById(orderId);
        
        // 2. è°ƒç”¨ç”¨æˆ·æœåŠ¡è·å–ç”¨æˆ·ä¿¡æ¯
        UserDTO user = serviceManager.invokeService(
            "user-service", 
            "/users/" + order.getUserId(), 
            UserDTO.class
        );
        
        // 3. ç»„è£…è¿”å›æ•°æ®
        OrderDTO result = new OrderDTO();
        result.setOrder(order);
        result.setUser(user);
        
        return result;
    }
}
```

### 6.3 ç›‘æ§å’Œç®¡ç†ç•Œé¢


```java
/**
 * æœåŠ¡ç›‘æ§æ¥å£
 */
@RestController
@RequestMapping("/admin/services")
public class ServiceMonitorController {
    
    @Autowired
    private ServiceDiscovery discovery;
    
    /**
     * æŸ¥çœ‹æ‰€æœ‰æœåŠ¡
     */
    @GetMapping("/list")
    public Map<String, Object> listAllServices() {
        Map<String, Object> result = new HashMap<>();
        
        List<String> services = discovery.getAllServiceNames();
        Map<String, List<ServiceInstance>> serviceInstances = new HashMap<>();
        
        for (String serviceName : services) {
            List<ServiceInstance> instances = discovery.getAllInstances(serviceName);
            serviceInstances.put(serviceName, instances);
        }
        
        result.put("services", services);
        result.put("instances", serviceInstances);
        result.put("timestamp", System.currentTimeMillis());
        
        return result;
    }
    
    /**
     * æŸ¥çœ‹ç‰¹å®šæœåŠ¡çš„å®ä¾‹
     */
    @GetMapping("/{serviceName}/instances")
    public List<ServiceInstance> getServiceInstances(@PathVariable String serviceName) {
        return discovery.getAllInstances(serviceName);
    }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ æœåŠ¡æ³¨å†Œï¼šä½¿ç”¨ä¸´æ—¶é¡ºåºèŠ‚ç‚¹ï¼Œè‡ªåŠ¨æ•…éšœæ£€æµ‹
ğŸ”¸ æœåŠ¡å‘ç°ï¼šæŸ¥è¯¢å­èŠ‚ç‚¹ï¼Œè·å–å®ä¾‹ä¿¡æ¯ï¼Œè´Ÿè½½å‡è¡¡é€‰æ‹©
ğŸ”¸ å¥åº·æ£€æŸ¥ï¼šä¸»åŠ¨æ£€æŸ¥ + å¿ƒè·³ç»­çº¦ï¼Œç¡®ä¿æœåŠ¡å¯ç”¨æ€§
ğŸ”¸ è´Ÿè½½å‡è¡¡ï¼šå¤šç§ç­–ç•¥ï¼Œæ ¹æ®åœºæ™¯é€‰æ‹©åˆé€‚çš„ç®—æ³•
ğŸ”¸ ç›‘å¬æœºåˆ¶ï¼šå®æ—¶æ„ŸçŸ¥æœåŠ¡å˜åŒ–ï¼ŒåŠ¨æ€æ›´æ–°å®ä¾‹åˆ—è¡¨
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸´æ—¶èŠ‚ç‚¹çš„å¦™ç”¨**ï¼š
```
ä¸ºä»€ä¹ˆç”¨ä¸´æ—¶èŠ‚ç‚¹ï¼Ÿ
â€¢ æœåŠ¡æŒ‚äº†ï¼ŒèŠ‚ç‚¹è‡ªåŠ¨åˆ é™¤
â€¢ ç½‘ç»œæ–­äº†ï¼Œä¼šè¯è¶…æ—¶åèŠ‚ç‚¹æ¶ˆå¤±  
â€¢ å…¶ä»–æœåŠ¡ç«‹å³æ„ŸçŸ¥åˆ°å˜åŒ–
â€¢ æ— éœ€æ‰‹åŠ¨æ¸…ç†åƒµå°¸èŠ‚ç‚¹

è¿™æ˜¯Zookeeperæœ€æ ¸å¿ƒçš„ç‰¹æ€§ï¼
```

**ğŸ”¹ è´Ÿè½½å‡è¡¡çš„é€‰æ‹©åŸåˆ™**ï¼š
```
å®ä¾‹æ€§èƒ½ç›¸è¿‘ â†’ éšæœºæˆ–è½®è¯¢
å®ä¾‹æ€§èƒ½ä¸åŒ â†’ åŠ æƒè½®è¯¢
é•¿è¿æ¥åœºæ™¯ â†’ æœ€å°‘è¿æ¥
è¦æ±‚ç»å¯¹å…¬å¹³ â†’ è½®è¯¢
è¦æ±‚ç®€å•é«˜æ•ˆ â†’ éšæœº
```

**ğŸ”¹ å¥åº·æ£€æŸ¥çš„å¹³è¡¡**ï¼š
```
æ£€æŸ¥å¤ªé¢‘ç¹ â†’ å¢åŠ ç³»ç»Ÿè´Ÿè½½
æ£€æŸ¥å¤ªç¨€å°‘ â†’ æ•…éšœå‘ç°å»¶è¿Ÿ
åˆç†é…ç½®ï¼š30ç§’æ£€æŸ¥é—´éš”ï¼Œ3æ¬¡å¤±è´¥é˜ˆå€¼
```

### 7.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ å¾®æœåŠ¡æ¶æ„å¿…å¤‡**ï¼š
- **åŠ¨æ€æœåŠ¡å‘ç°**ï¼šæ— éœ€ç¡¬ç¼–ç æœåŠ¡åœ°å€
- **è‡ªåŠ¨æ•…éšœè½¬ç§»**ï¼šæœåŠ¡æŒ‚äº†è‡ªåŠ¨åˆ‡æ¢
- **æ°´å¹³æ‰©å±•æ”¯æŒ**ï¼šæ–°å®ä¾‹è‡ªåŠ¨åŠ å…¥è´Ÿè½½å‡è¡¡
- **é…ç½®ç»Ÿä¸€ç®¡ç†**ï¼šæœåŠ¡å…ƒæ•°æ®é›†ä¸­å­˜å‚¨

**ğŸ› ï¸ ç”Ÿäº§ç¯å¢ƒè€ƒè™‘**ï¼š
- **é«˜å¯ç”¨éƒ¨ç½²**ï¼šZookeeperé›†ç¾¤éƒ¨ç½²
- **ç›‘æ§å‘Šè­¦**ï¼šæœåŠ¡æ³¨å†Œ/å‘ç°å¼‚å¸¸ç›‘æ§
- **ä¼˜é›…ä¸‹çº¿**ï¼šJVMå…³é—­é’©å­ç¡®ä¿æ­£å¸¸æ³¨é”€
- **ç°åº¦å‘å¸ƒ**ï¼šé€šè¿‡æƒé‡æ§åˆ¶æµé‡åˆ†é…

### 7.4 å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ


**âŒ å¸¸è§é—®é¢˜**ï¼š
```
é—®é¢˜1ï¼šæœåŠ¡å¯åŠ¨æ…¢ï¼Œæ³¨å†Œå»¶è¿Ÿ
è§£å†³ï¼šå¼‚æ­¥æ³¨å†Œï¼Œå¯åŠ¨å®Œæˆåå†æ³¨å†Œ

é—®é¢˜2ï¼šç½‘ç»œæŠ–åŠ¨å¯¼è‡´æœåŠ¡é¢‘ç¹ä¸Šä¸‹çº¿  
è§£å†³ï¼šå¢åŠ é‡è¯•æœºåˆ¶ï¼Œå»¶é•¿ä¼šè¯è¶…æ—¶æ—¶é—´

é—®é¢˜3ï¼šè´Ÿè½½ä¸å‡è¡¡
è§£å†³ï¼šæ£€æŸ¥æƒé‡é…ç½®ï¼Œé€‰æ‹©åˆé€‚çš„è´Ÿè½½å‡è¡¡ç­–ç•¥

é—®é¢˜4ï¼šå¥åº·æ£€æŸ¥å½±å“æ€§èƒ½
è§£å†³ï¼šå¼‚æ­¥æ£€æŸ¥ï¼Œåˆç†è®¾ç½®æ£€æŸ¥é—´éš”
```

**âœ… æœ€ä½³å®è·µ**ï¼š
- æœåŠ¡å¯åŠ¨åå»¶è¿Ÿå‡ ç§’å†æ³¨å†Œï¼Œç¡®ä¿æœåŠ¡å®Œå…¨å°±ç»ª
- å®ç°å¤šå±‚å¥åº·æ£€æŸ¥ï¼šè¿›ç¨‹å­˜æ´» + HTTPå¥åº·æ¥å£
- åˆç†è®¾ç½®Zookeeperä¼šè¯è¶…æ—¶æ—¶é—´ï¼ˆæ¨è30-60ç§’ï¼‰
- å®ç°ä¼˜é›…å…³é—­ï¼Œç¡®ä¿æœåŠ¡ä¸‹çº¿æ—¶æ­£ç¡®æ³¨é”€

**æ ¸å¿ƒè®°å¿†**ï¼š
- ä¸´æ—¶èŠ‚ç‚¹åšæ³¨å†Œï¼Œä¼šè¯æ–­äº†è‡ªåŠ¨åˆ 
- ç›‘å¬å­èŠ‚ç‚¹å˜åŒ–ï¼Œå®æ—¶å‘ç°æœåŠ¡çŠ¶æ€  
- è´Ÿè½½å‡è¡¡é€‰å®ä¾‹ï¼Œå¥åº·æ£€æŸ¥ä¿è´¨é‡
- å…ƒæ•°æ®å­˜èŠ‚ç‚¹é‡Œï¼Œæƒé‡æ ‡ç­¾éƒ½èƒ½åŠ 