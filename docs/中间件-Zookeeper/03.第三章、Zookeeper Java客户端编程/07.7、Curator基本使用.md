---
title: 7ã€CuratoråŸºæœ¬ä½¿ç”¨
---
## ğŸ“š ç›®å½•

1. [Curatoræ¡†æ¶æ¦‚è¿°](#1-Curatoræ¡†æ¶æ¦‚è¿°)
2. [CuratorFrameworkå®¢æˆ·ç«¯](#2-CuratorFrameworkå®¢æˆ·ç«¯)
3. [è¿æ¥æ„å»ºå™¨è¯¦è§£](#3-è¿æ¥æ„å»ºå™¨è¯¦è§£)
4. [å®¢æˆ·ç«¯å¯åŠ¨ä¸ç”Ÿå‘½å‘¨æœŸ](#4-å®¢æˆ·ç«¯å¯åŠ¨ä¸ç”Ÿå‘½å‘¨æœŸ)
5. [åŸºæœ¬æ“ä½œAPI](#5-åŸºæœ¬æ“ä½œAPI)
6. [è·¯å¾„ç¼“å­˜æœºåˆ¶](#6-è·¯å¾„ç¼“å­˜æœºåˆ¶)
7. [ä¼˜é›…å…³é—­å¤„ç†](#7-ä¼˜é›…å…³é—­å¤„ç†)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ Curatoræ¡†æ¶æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯Apache Curator


**ç®€å•ç†è§£**ï¼šå¦‚æœæŠŠåŸç”ŸZooKeeperå®¢æˆ·ç«¯æ¯”ä½œæ‰‹åŠ¨æŒ¡æ±½è½¦ï¼Œé‚£ä¹ˆCuratorå°±æ˜¯è‡ªåŠ¨æŒ¡è±ªåç‰ˆï¼

```
åŸç”ŸZooKeeperå®¢æˆ·ç«¯çš„ç—›ç‚¹ï¼š
ğŸ˜¤ è¿æ¥ç®¡ç†å¤æ‚ï¼šéœ€è¦æ‰‹åŠ¨å¤„ç†è¿æ¥æ–­å¼€é‡è¿
ğŸ˜¤ ä¼šè¯è¶…æ—¶å¤„ç†ï¼šéœ€è¦è‡ªå·±ç›‘å¬ä¼šè¯çŠ¶æ€
ğŸ˜¤ APIè®¾è®¡åº•å±‚ï¼šç›´æ¥æ“ä½œå­—èŠ‚æ•°ç»„ï¼Œä¸å¤Ÿå‹å¥½
ğŸ˜¤ é‡è¯•æœºåˆ¶ç¼ºå¤±ï¼šç½‘ç»œå¼‚å¸¸æ—¶éœ€è¦æ‰‹åŠ¨é‡è¯•
ğŸ˜¤ åˆ†å¸ƒå¼åè°ƒå›°éš¾ï¼šåˆ†å¸ƒå¼é”ã€é€‰ä¸¾ç­‰éœ€è¦è‡ªå·±å®ç°

Curatorçš„è§£å†³æ–¹æ¡ˆï¼š
âœ… è‡ªåŠ¨è¿æ¥ç®¡ç†ï¼šæ–­çº¿è‡ªåŠ¨é‡è¿ï¼Œé€æ˜å¤„ç†
âœ… æ™ºèƒ½é‡è¯•ç­–ç•¥ï¼šå¤šç§é‡è¯•ç­–ç•¥å¯é€‰
âœ… é«˜çº§APIå°è£…ï¼šæä¾›æ›´å‹å¥½çš„æ“ä½œæ¥å£
âœ… åˆ†å¸ƒå¼å·¥å…·ï¼šå†…ç½®åˆ†å¸ƒå¼é”ã€é€‰ä¸¾ã€å±éšœç­‰
âœ… è·¯å¾„ç¼“å­˜ï¼šè‡ªåŠ¨ç»´æŠ¤èŠ‚ç‚¹æ•°æ®å’Œå­èŠ‚ç‚¹åˆ—è¡¨
```

### 1.2 Curatoræ¶æ„è®¾è®¡


**ğŸ—ï¸ åˆ†å±‚æ¶æ„å›¾**ï¼š
```
åº”ç”¨ç¨‹åºä»£ç 
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Curator Recipes (åˆ†å¸ƒå¼å·¥å…·)   â”‚ â† åˆ†å¸ƒå¼é”ã€é€‰ä¸¾ç­‰é«˜çº§åŠŸèƒ½
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    Curator Framework (æ ¸å¿ƒæ¡†æ¶)  â”‚ â† ä¸»è¦APIï¼Œè¿æ¥ç®¡ç†
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    Curator Client (å®¢æˆ·ç«¯å°è£…)   â”‚ â† é‡è¯•ç­–ç•¥ï¼Œè¿æ¥çŠ¶æ€ç®¡ç†
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    ZooKeeper Client (åŸç”Ÿå®¢æˆ·ç«¯) â”‚ â† åº•å±‚ZKåŸç”ŸAPI
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
ZooKeeperæœåŠ¡å™¨é›†ç¾¤
```

**ğŸ’¡ æ ¸å¿ƒè®¾è®¡ç†å¿µ**ï¼š
```
æµç•…APIè®¾è®¡ï¼š
â€¢ é“¾å¼è°ƒç”¨é£æ ¼ï¼Œä»£ç æ›´ç®€æ´
â€¢ å»ºé€ è€…æ¨¡å¼ï¼Œé…ç½®æ›´æ¸…æ™°
â€¢ å¼‚æ­¥å’ŒåŒæ­¥APIå¹¶å­˜

å®¹é”™æ€§è®¾è®¡ï¼š
â€¢ è‡ªåŠ¨é‡è¯•æœºåˆ¶
â€¢ è¿æ¥çŠ¶æ€è‡ªåŠ¨æ¢å¤
â€¢ å¼‚å¸¸æƒ…å†µä¼˜é›…å¤„ç†

æ‰©å±•æ€§è®¾è®¡ï¼š
â€¢ æ’ä»¶åŒ–é‡è¯•ç­–ç•¥
â€¢ å¯æ‰©å±•çš„Recipeæ¨¡å¼
â€¢ çµæ´»çš„äº‹ä»¶ç›‘å¬æœºåˆ¶
```

### 1.3 Mavenä¾èµ–é…ç½®


**ğŸ“¦ é¡¹ç›®ä¾èµ–è®¾ç½®**ï¼š
```xml
<!-- Curatorä¸»è¦ä¾èµ– -->
<dependency>
    <groupId>org.apache.curator</groupId>
    <artifactId>curator-framework</artifactId>
    <version>5.4.0</version>
</dependency>

<!-- Curatoré«˜çº§åŠŸèƒ½ï¼ˆåˆ†å¸ƒå¼å·¥å…·ï¼‰ -->
<dependency>
    <groupId>org.apache.curator</groupId>
    <artifactId>curator-recipes</artifactId>
    <version>5.4.0</version>
</dependency>

<!-- æµ‹è¯•æ”¯æŒ -->
<dependency>
    <groupId>org.apache.curator</groupId>
    <artifactId>curator-test</artifactId>
    <version>5.4.0</version>
    <scope>test</scope>
</dependency>
```

---

## 2. ğŸ”§ CuratorFrameworkå®¢æˆ·ç«¯


### 2.1 CuratorFrameworkæ ¸å¿ƒæ¦‚å¿µ


**ä»€ä¹ˆæ˜¯CuratorFrameworkï¼Ÿ**
CuratorFrameworkæ˜¯Curatorçš„æ ¸å¿ƒæ¥å£ï¼Œå°±åƒæ˜¯ä¸€ä¸ª"è¶…çº§é¥æ§å™¨"ï¼Œé€šè¿‡å®ƒå¯ä»¥æ§åˆ¶ZooKeeperçš„æ‰€æœ‰åŠŸèƒ½ã€‚

```java
// CuratorFrameworkæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®šä¹‰äº†æ‰€æœ‰ZKæ“ä½œ
public interface CuratorFramework extends Closeable {
    // èŠ‚ç‚¹æ“ä½œ
    CreateBuilder create();
    DeleteBuilder delete();
    ExistsBuilder checkExists();
    GetDataBuilder getData();
    SetDataBuilder setData();
    GetChildrenBuilder getChildren();
    
    // è¿æ¥ç®¡ç†
    void start();
    void close();
    CuratorFrameworkState getState();
    
    // ç›‘å¬å™¨
    CuratorListener getCuratorListenable();
    ConnectionStateListenable getConnectionStateListenable();
}
```

### 2.2 å®¢æˆ·ç«¯çŠ¶æ€ç®¡ç†


**ğŸ”„ å®¢æˆ·ç«¯ç”Ÿå‘½å‘¨æœŸ**ï¼š
```
å®¢æˆ·ç«¯çŠ¶æ€è½¬æ¢å›¾ï¼š
[LATENT] â”€â”€start()â”€â”€> [STARTED] â”€â”€close()â”€â”€> [STOPPED]
   â†‘                     â†“
   â””â”€â”€â”€â”€â”€â”€â”€â”€ restart â”€â”€â”€â”€â”˜

çŠ¶æ€è¯´æ˜ï¼š
â€¢ LATENTï¼šåˆšåˆ›å»ºï¼Œè¿˜æœªå¯åŠ¨
â€¢ STARTEDï¼šå·²å¯åŠ¨ï¼Œå¯ä»¥æ‰§è¡ŒZKæ“ä½œ  
â€¢ STOPPEDï¼šå·²å…³é—­ï¼Œä¸èƒ½å†ä½¿ç”¨
```

**ğŸ“Š è¿æ¥çŠ¶æ€ç›‘å¬**ï¼š
```java
public class ConnectionStateExample {
    public static void main(String[] args) throws Exception {
        CuratorFramework client = CuratorFrameworkFactory.newClient(
            "localhost:2181", 
            new ExponentialBackoffRetry(1000, 3)
        );
        
        // æ·»åŠ è¿æ¥çŠ¶æ€ç›‘å¬å™¨
        client.getConnectionStateListenable().addListener(
            (client1, newState) -> {
                switch (newState) {
                    case CONNECTED:
                        System.out.println("è¿æ¥æˆåŠŸ");
                        break;
                    case SUSPENDED:
                        System.out.println("è¿æ¥æŒ‚èµ·");
                        break;
                    case RECONNECTED:
                        System.out.println("é‡æ–°è¿æ¥æˆåŠŸ");
                        break;
                    case LOST:
                        System.out.println("è¿æ¥ä¸¢å¤±");
                        break;
                }
            }
        );
        
        client.start();
        client.blockUntilConnected(); // ç­‰å¾…è¿æ¥æˆåŠŸ
    }
}
```

---

## 3. ğŸ› ï¸ è¿æ¥æ„å»ºå™¨è¯¦è§£


### 3.1 CuratorFrameworkFactoryå·¥å‚ç±»


**æ„å»ºå™¨æ¨¡å¼çš„ä¼˜åŠ¿**ï¼š
å°±åƒæ­ç§¯æœ¨ä¸€æ ·ï¼Œä½ å¯ä»¥é€‰æ‹©éœ€è¦çš„"ç§¯æœ¨å—"ï¼Œç»„è£…æˆé€‚åˆä½ çš„å®¢æˆ·ç«¯é…ç½®ã€‚

```java
// æ–¹å¼ä¸€ï¼šç®€å•æ„å»ºï¼ˆé€‚åˆå¼€å‘æµ‹è¯•ï¼‰
CuratorFramework client = CuratorFrameworkFactory.newClient(
    "localhost:2181",                    // ZKæœåŠ¡å™¨åœ°å€
    new ExponentialBackoffRetry(1000, 3) // é‡è¯•ç­–ç•¥
);

// æ–¹å¼äºŒï¼šè¯¦ç»†é…ç½®æ„å»ºï¼ˆé€‚åˆç”Ÿäº§ç¯å¢ƒï¼‰
CuratorFramework client = CuratorFrameworkFactory.builder()
    .connectString("zk1:2181,zk2:2181,zk3:2181") // é›†ç¾¤åœ°å€
    .sessionTimeoutMs(30000)                      // ä¼šè¯è¶…æ—¶30ç§’
    .connectionTimeoutMs(15000)                   // è¿æ¥è¶…æ—¶15ç§’
    .retryPolicy(new ExponentialBackoffRetry(1000, 3)) // é‡è¯•ç­–ç•¥
    .namespace("myapp")                           // å‘½åç©ºé—´
    .build();
```

### 3.2 é‡è¦é…ç½®å‚æ•°è¯¦è§£


**âš™ï¸ æ ¸å¿ƒé…ç½®å‚æ•°**ï¼š

| å‚æ•° | **é»˜è®¤å€¼** | **è¯´æ˜** | **å»ºè®®é…ç½®** |
|------|-----------|----------|-------------|
| `connectString` | `å¿…å¡«` | `ZKæœåŠ¡å™¨åœ°å€` | `zk1:2181,zk2:2181,zk3:2181` |
| `sessionTimeoutMs` | `60000` | `ä¼šè¯è¶…æ—¶æ—¶é—´(æ¯«ç§’)` | `30000-60000` |
| `connectionTimeoutMs` | `15000` | `è¿æ¥è¶…æ—¶æ—¶é—´(æ¯«ç§’)` | `10000-30000` |
| `namespace` | `null` | `å‘½åç©ºé—´å‰ç¼€` | `åº”ç”¨åå¦‚"myapp"` |
| `retryPolicy` | `å¿…å¡«` | `é‡è¯•ç­–ç•¥` | `ExponentialBackoffRetry` |

**ğŸ”„ é‡è¯•ç­–ç•¥é€‰æ‹©**ï¼š
```java
// 1. æŒ‡æ•°é€€é¿é‡è¯•ï¼ˆæ¨èï¼‰
// é‡è¯•é—´éš”ï¼š1s, 2s, 4s, 8s...
RetryPolicy retryPolicy = new ExponentialBackoffRetry(1000, 3);

// 2. å›ºå®šé—´éš”é‡è¯•
// æ¯æ¬¡é‡è¯•é—´éš”å›ºå®š1ç§’
RetryPolicy retryPolicy = new RetryNTimes(3, 1000);

// 3. ç›´åˆ°æˆåŠŸé‡è¯•ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
// ä¼šä¸€ç›´é‡è¯•ç›´åˆ°æˆåŠŸï¼Œå¯èƒ½å¯¼è‡´æ— é™é‡è¯•
RetryPolicy retryPolicy = new RetryUntilElapsed(30000, 1000);

// 4. æœ‰ç•ŒæŒ‡æ•°é€€é¿é‡è¯•ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰
// åœ¨æŒ‡æ•°é€€é¿åŸºç¡€ä¸Šè®¾ç½®æœ€å¤§é‡è¯•é—´éš”
RetryPolicy retryPolicy = new BoundedExponentialBackoffRetry(1000, 10000, 5);
```

### 3.3 å‘½åç©ºé—´æœºåˆ¶


**ä»€ä¹ˆæ˜¯å‘½åç©ºé—´ï¼Ÿ**
å‘½åç©ºé—´å°±åƒç»™ä½ çš„åº”ç”¨åˆ†é…ä¸€ä¸ª"ä¸“å±æ–‡ä»¶å¤¹"ï¼Œæ‰€æœ‰æ“ä½œéƒ½åœ¨è¿™ä¸ªæ–‡ä»¶å¤¹ä¸‹è¿›è¡Œï¼Œé¿å…å’Œå…¶ä»–åº”ç”¨å†²çªã€‚

```java
// è®¾ç½®å‘½åç©ºé—´ä¸º"myapp"
CuratorFramework client = CuratorFrameworkFactory.builder()
    .connectString("localhost:2181")
    .namespace("myapp")  // è®¾ç½®å‘½åç©ºé—´
    .retryPolicy(new ExponentialBackoffRetry(1000, 3))
    .build();

client.start();

// åˆ›å»ºèŠ‚ç‚¹"/config"ï¼Œå®é™…åˆ›å»ºçš„æ˜¯"/myapp/config"
client.create()
    .creatingParentsIfNeeded()
    .forPath("/config", "app config".getBytes());

// è¯»å–èŠ‚ç‚¹"/config"ï¼Œå®é™…è¯»å–çš„æ˜¯"/myapp/config"  
byte[] data = client.getData().forPath("/config");
```

**ğŸ’¡ å‘½åç©ºé—´çš„å¥½å¤„**ï¼š
```
å¤šç§Ÿæˆ·éš”ç¦»ï¼š
åº”ç”¨Aï¼š/appA/config, /appA/data
åº”ç”¨Bï¼š/appB/config, /appB/data
é¿å…è·¯å¾„å†²çª

ç®€åŒ–ä»£ç ï¼š
â€¢ åº”ç”¨å†…éƒ¨åªéœ€å…³å¿ƒç›¸å¯¹è·¯å¾„
â€¢ ä¸éœ€è¦åœ¨æ¯ä¸ªè·¯å¾„å‰åŠ åº”ç”¨å‰ç¼€
â€¢ ä»£ç æ›´ç®€æ´ï¼Œç»´æŠ¤æ›´å®¹æ˜“
```

---

## 4. âš¡ å®¢æˆ·ç«¯å¯åŠ¨ä¸ç”Ÿå‘½å‘¨æœŸ


### 4.1 å®¢æˆ·ç«¯å¯åŠ¨è¿‡ç¨‹


**ğŸš€ å¯åŠ¨æµç¨‹è¯¦è§£**ï¼š
```java
public class ClientLifecycleExample {
    private static final String CONNECT_STRING = "localhost:2181";
    
    public static void main(String[] args) throws Exception {
        // 1. åˆ›å»ºå®¢æˆ·ç«¯ï¼ˆæ­¤æ—¶çŠ¶æ€ä¸ºLATENTï¼‰
        CuratorFramework client = CuratorFrameworkFactory.builder()
            .connectString(CONNECT_STRING)
            .sessionTimeoutMs(30000)
            .retryPolicy(new ExponentialBackoffRetry(1000, 3))
            .build();
            
        System.out.println("å®¢æˆ·ç«¯çŠ¶æ€: " + client.getState()); // LATENT
        
        // 2. å¯åŠ¨å®¢æˆ·ç«¯ï¼ˆçŠ¶æ€å˜ä¸ºSTARTEDï¼‰
        client.start();
        System.out.println("å®¢æˆ·ç«¯çŠ¶æ€: " + client.getState()); // STARTED
        
        // 3. ç­‰å¾…è¿æ¥å»ºç«‹ï¼ˆå¯é€‰ä½†æ¨èï¼‰
        boolean connected = client.blockUntilConnected(10, TimeUnit.SECONDS);
        if (connected) {
            System.out.println("è¿æ¥ZooKeeperæˆåŠŸ");
        } else {
            System.out.println("è¿æ¥ZooKeeperè¶…æ—¶");
            return;
        }
        
        // 4. æ‰§è¡Œä¸šåŠ¡æ“ä½œ
        performOperations(client);
        
        // 5. å…³é—­å®¢æˆ·ç«¯
        client.close();
        System.out.println("å®¢æˆ·ç«¯çŠ¶æ€: " + client.getState()); // STOPPED
    }
    
    private static void performOperations(CuratorFramework client) 
            throws Exception {
        // åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹éªŒè¯è¿æ¥
        String path = "/test-" + System.currentTimeMillis();
        client.create()
            .creatingParentsIfNeeded()
            .forPath(path, "Hello Curator".getBytes());
            
        System.out.println("åˆ›å»ºèŠ‚ç‚¹æˆåŠŸ: " + path);
        
        // åˆ é™¤æµ‹è¯•èŠ‚ç‚¹
        client.delete().forPath(path);
        System.out.println("åˆ é™¤èŠ‚ç‚¹æˆåŠŸ: " + path);
    }
}
```

### 4.2 è¿æ¥ç­‰å¾…ç­–ç•¥


**â° ä¸åŒçš„ç­‰å¾…ç­–ç•¥**ï¼š
```java
// ç­–ç•¥1ï¼šç«‹å³è¿”å›ï¼Œä¸ç­‰å¾…è¿æ¥ï¼ˆä¸æ¨èï¼‰
client.start();
// å¯èƒ½è¿˜æœªè¿æ¥å°±å¼€å§‹æ“ä½œï¼Œå®¹æ˜“å‡ºé”™

// ç­–ç•¥2ï¼šæ— é™ç­‰å¾…è¿æ¥æˆåŠŸ
client.start();
client.blockUntilConnected(); // ä¼šä¸€ç›´ç­‰å¾…ï¼Œå¯èƒ½é˜»å¡

// ç­–ç•¥3ï¼šé™æ—¶ç­‰å¾…è¿æ¥ï¼ˆæ¨èï¼‰
client.start();
boolean connected = client.blockUntilConnected(30, TimeUnit.SECONDS);
if (!connected) {
    throw new RuntimeException("è¿æ¥ZooKeeperå¤±è´¥");
}

// ç­–ç•¥4ï¼šä½¿ç”¨è¿æ¥çŠ¶æ€ç›‘å¬å™¨ï¼ˆé«˜çº§ç”¨æ³•ï¼‰
CountDownLatch connectedLatch = new CountDownLatch(1);
client.getConnectionStateListenable().addListener((c, newState) -> {
    if (newState == ConnectionState.CONNECTED) {
        connectedLatch.countDown();
    }
});
client.start();
connectedLatch.await(30, TimeUnit.SECONDS);
```

---

## 5. ğŸ“‹ åŸºæœ¬æ“ä½œAPI


### 5.1 èŠ‚ç‚¹åˆ›å»ºæ“ä½œ


**ğŸ”¨ åˆ›å»ºèŠ‚ç‚¹çš„å„ç§æ–¹å¼**ï¼š
```java
public class NodeCreationExample {
    public static void demonstrate(CuratorFramework client) throws Exception {
        
        // 1. åˆ›å»ºæŒä¹…èŠ‚ç‚¹
        client.create()
            .forPath("/persistent-node", "persistent data".getBytes());
            
        // 2. åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹
        client.create()
            .withMode(CreateMode.EPHEMERAL)
            .forPath("/ephemeral-node", "ephemeral data".getBytes());
            
        // 3. åˆ›å»ºæŒä¹…é¡ºåºèŠ‚ç‚¹
        String actualPath = client.create()
            .withMode(CreateMode.PERSISTENT_SEQUENTIAL)
            .forPath("/sequential-node-", "sequential data".getBytes());
        System.out.println("å®é™…åˆ›å»ºè·¯å¾„: " + actualPath); // å¦‚: /sequential-node-0000000001
        
        // 4. åˆ›å»ºå¤šçº§è·¯å¾„ï¼ˆè‡ªåŠ¨åˆ›å»ºçˆ¶èŠ‚ç‚¹ï¼‰
        client.create()
            .creatingParentsIfNeeded()  // å…³é”®ï¼šè‡ªåŠ¨åˆ›å»ºçˆ¶èŠ‚ç‚¹
            .forPath("/app/config/database", "db config".getBytes());
            
        // 5. å¸¦ACLæƒé™çš„èŠ‚ç‚¹åˆ›å»º
        List<ACL> acls = ZooDefs.Ids.OPEN_ACL_UNSAFE;
        client.create()
            .withMode(CreateMode.PERSISTENT)
            .withACL(acls)
            .forPath("/secure-node", "secure data".getBytes());
            
        // 6. å¼‚æ­¥åˆ›å»ºèŠ‚ç‚¹
        client.create()
            .inBackground((client1, event) -> {
                if (event.getResultCode() == KeeperException.Code.OK.intValue()) {
                    System.out.println("å¼‚æ­¥åˆ›å»ºæˆåŠŸ: " + event.getPath());
                }
            })
            .forPath("/async-node", "async data".getBytes());
    }
}
```

### 5.2 èŠ‚ç‚¹è¯»å–æ“ä½œ


**ğŸ“– è¯»å–èŠ‚ç‚¹æ•°æ®å’Œå…ƒä¿¡æ¯**ï¼š
```java
public class NodeReadingExample {
    public static void demonstrate(CuratorFramework client) throws Exception {
        String path = "/test-node";
        
        // å…ˆåˆ›å»ºä¸€ä¸ªæµ‹è¯•èŠ‚ç‚¹
        client.create()
            .creatingParentsIfNeeded()
            .forPath(path, "original data".getBytes());
            
        // 1. åŸºæœ¬è¯»å–æ•°æ®
        byte[] data = client.getData().forPath(path);
        System.out.println("èŠ‚ç‚¹æ•°æ®: " + new String(data));
        
        // 2. è¯»å–æ•°æ®å¹¶è·å–ç»Ÿè®¡ä¿¡æ¯
        Stat stat = new Stat();
        byte[] dataWithStat = client.getData()
            .storingStatIn(stat)  // å°†ç»Ÿè®¡ä¿¡æ¯å­˜å‚¨åœ¨statå¯¹è±¡ä¸­
            .forPath(path);
            
        System.out.println("èŠ‚ç‚¹æ•°æ®: " + new String(dataWithStat));
        System.out.println("åˆ›å»ºæ—¶é—´: " + stat.getCtime());
        System.out.println("ä¿®æ”¹æ—¶é—´: " + stat.getMtime());
        System.out.println("ç‰ˆæœ¬å·: " + stat.getVersion());
        System.out.println("æ•°æ®é•¿åº¦: " + stat.getDataLength());
        
        // 3. æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨
        Stat existStat = client.checkExists().forPath(path);
        if (existStat != null) {
            System.out.println("èŠ‚ç‚¹å­˜åœ¨ï¼Œç‰ˆæœ¬: " + existStat.getVersion());
        }
        
        // 4. æ£€æŸ¥ä¸å­˜åœ¨çš„èŠ‚ç‚¹
        Stat nonExistStat = client.checkExists().forPath("/non-exist");
        System.out.println("ä¸å­˜åœ¨çš„èŠ‚ç‚¹: " + (nonExistStat == null ? "null" : "å­˜åœ¨"));
        
        // 5. å¼‚æ­¥è¯»å–æ•°æ®
        client.getData()
            .inBackground((client1, event) -> {
                if (event.getResultCode() == KeeperException.Code.OK.intValue()) {
                    System.out.println("å¼‚æ­¥è¯»å–æˆåŠŸ: " + new String(event.getData()));
                }
            })
            .forPath(path);
    }
}
```

### 5.3 èŠ‚ç‚¹æ›´æ–°å’Œåˆ é™¤


**âœï¸ æ›´æ–°å’Œåˆ é™¤æ“ä½œ**ï¼š
```java
public class NodeUpdateDeleteExample {
    public static void demonstrate(CuratorFramework client) throws Exception {
        String path = "/update-test";
        
        // åˆ›å»ºæµ‹è¯•èŠ‚ç‚¹
        client.create()
            .forPath(path, "initial data".getBytes());
            
        // 1. åŸºæœ¬æ›´æ–°æ•°æ®
        client.setData()
            .forPath(path, "updated data".getBytes());
            
        // 2. åŸºäºç‰ˆæœ¬çš„æ¡ä»¶æ›´æ–°ï¼ˆä¹è§‚é”ï¼‰
        Stat stat = client.checkExists().forPath(path);
        client.setData()
            .withVersion(stat.getVersion())  // æŒ‡å®šç‰ˆæœ¬å·
            .forPath(path, "version updated data".getBytes());
            
        // 3. å¼‚æ­¥æ›´æ–°
        client.setData()
            .inBackground((client1, event) -> {
                if (event.getResultCode() == KeeperException.Code.OK.intValue()) {
                    System.out.println("å¼‚æ­¥æ›´æ–°æˆåŠŸ");
                }
            })
            .forPath(path, "async updated data".getBytes());
            
        Thread.sleep(1000); // ç­‰å¾…å¼‚æ­¥æ“ä½œå®Œæˆ
        
        // 4. åŸºæœ¬åˆ é™¤èŠ‚ç‚¹
        client.delete().forPath(path);
        
        // é‡æ–°åˆ›å»ºç”¨äºå…¶ä»–åˆ é™¤ç¤ºä¾‹
        client.create()
            .creatingParentsIfNeeded()
            .forPath("/delete-test/child", "child data".getBytes());
            
        // 5. é€’å½’åˆ é™¤ï¼ˆåˆ é™¤èŠ‚ç‚¹åŠå…¶æ‰€æœ‰å­èŠ‚ç‚¹ï¼‰
        client.delete()
            .deletingChildrenIfNeeded()  // åˆ é™¤å­èŠ‚ç‚¹
            .forPath("/delete-test");
            
        // 6. åŸºäºç‰ˆæœ¬çš„æ¡ä»¶åˆ é™¤
        client.create().forPath("/version-delete-test", "data".getBytes());
        Stat deleteStat = client.checkExists().forPath("/version-delete-test");
        client.delete()
            .withVersion(deleteStat.getVersion())
            .forPath("/version-delete-test");
            
        // 7. ä¿è¯åˆ é™¤ï¼ˆå³ä½¿èŠ‚ç‚¹ä¸å­˜åœ¨ä¹Ÿä¸æŠ¥é”™ï¼‰
        client.delete()
            .guaranteed()  // ä¿è¯åˆ é™¤
            .forPath("/may-not-exist");
    }
}
```

### 5.4 è·å–å­èŠ‚ç‚¹åˆ—è¡¨


**ğŸ“‚ å­èŠ‚ç‚¹æ“ä½œ**ï¼š
```java
public class ChildrenOperationExample {
    public static void demonstrate(CuratorFramework client) throws Exception {
        // åˆ›å»ºæµ‹è¯•ç»“æ„
        client.create().creatingParentsIfNeeded()
            .forPath("/parent/child1", "child1 data".getBytes());
        client.create().forPath("/parent/child2", "child2 data".getBytes());
        client.create().forPath("/parent/child3", "child3 data".getBytes());
        
        // 1. è·å–å­èŠ‚ç‚¹åˆ—è¡¨
        List<String> children = client.getChildren().forPath("/parent");
        System.out.println("å­èŠ‚ç‚¹åˆ—è¡¨: " + children);
        
        // 2. è·å–å­èŠ‚ç‚¹å¹¶è·å–çˆ¶èŠ‚ç‚¹ç»Ÿè®¡ä¿¡æ¯
        Stat parentStat = new Stat();
        List<String> childrenWithStat = client.getChildren()
            .storingStatIn(parentStat)
            .forPath("/parent");
            
        System.out.println("å­èŠ‚ç‚¹æ•°é‡: " + childrenWithStat.size());
        System.out.println("çˆ¶èŠ‚ç‚¹å­èŠ‚ç‚¹æ•°é‡: " + parentStat.getNumChildren());
        
        // 3. å¼‚æ­¥è·å–å­èŠ‚ç‚¹
        client.getChildren()
            .inBackground((client1, event) -> {
                if (event.getResultCode() == KeeperException.Code.OK.intValue()) {
                    System.out.println("å¼‚æ­¥è·å–å­èŠ‚ç‚¹: " + event.getChildren());
                }
            })
            .forPath("/parent");
            
        Thread.sleep(1000); // ç­‰å¾…å¼‚æ­¥æ“ä½œå®Œæˆ
        
        // æ¸…ç†æµ‹è¯•æ•°æ®
        client.delete().deletingChildrenIfNeeded().forPath("/parent");
    }
}
```

---

## 6. ğŸ—‚ï¸ è·¯å¾„ç¼“å­˜æœºåˆ¶


### 6.1 ä»€ä¹ˆæ˜¯è·¯å¾„ç¼“å­˜


**è·¯å¾„ç¼“å­˜çš„ä½œç”¨**ï¼š
æƒ³è±¡ä½ ç»å¸¸éœ€è¦æŸ¥çœ‹æŸä¸ªæ–‡ä»¶å¤¹é‡Œæœ‰å“ªäº›æ–‡ä»¶ï¼Œä¸å…¶æ¯æ¬¡éƒ½å»ç¿»æ‰¾ï¼Œä¸å¦‚åœ¨æ¡Œå­ä¸Šæ”¾ä¸€ä¸ªæ¸…å•ï¼Œæ–‡ä»¶å¤¹æœ‰å˜åŒ–æ—¶è‡ªåŠ¨æ›´æ–°æ¸…å•ã€‚è¿™å°±æ˜¯è·¯å¾„ç¼“å­˜çš„ä½œç”¨ã€‚

```java
// PathChildrenCacheï¼šç›‘æ§å­èŠ‚ç‚¹å˜åŒ–
// NodeCacheï¼šç›‘æ§å•ä¸ªèŠ‚ç‚¹æ•°æ®å˜åŒ–  
// TreeCacheï¼šç›‘æ§æ•´ä¸ªå­æ ‘å˜åŒ–ï¼ˆæ¨èï¼‰
```

### 6.2 PathChildrenCacheå­èŠ‚ç‚¹ç¼“å­˜


**ğŸ‘¶ ç›‘æ§å­èŠ‚ç‚¹å˜åŒ–**ï¼š
```java
public class PathChildrenCacheExample {
    public static void demonstrate(CuratorFramework client) throws Exception {
        String parentPath = "/cache-test";
        
        // ç¡®ä¿çˆ¶èŠ‚ç‚¹å­˜åœ¨
        if (client.checkExists().forPath(parentPath) == null) {
            client.create().creatingParentsIfNeeded().forPath(parentPath);
        }
        
        // åˆ›å»ºPathChildrenCache
        PathChildrenCache cache = new PathChildrenCache(
            client, 
            parentPath, 
            true  // cacheData: æ˜¯å¦ç¼“å­˜èŠ‚ç‚¹æ•°æ®
        );
        
        // æ·»åŠ ç›‘å¬å™¨
        cache.getListenable().addListener(new PathChildrenCacheListener() {
            @Override
            public void childEvent(CuratorFramework client, PathChildrenCacheEvent event) 
                    throws Exception {
                ChildData childData = event.getData();
                
                switch (event.getType()) {
                    case CHILD_ADDED:
                        System.out.println("å­èŠ‚ç‚¹æ·»åŠ : " + childData.getPath());
                        System.out.println("æ•°æ®: " + new String(childData.getData()));
                        break;
                        
                    case CHILD_UPDATED:
                        System.out.println("å­èŠ‚ç‚¹æ›´æ–°: " + childData.getPath());
                        System.out.println("æ–°æ•°æ®: " + new String(childData.getData()));
                        break;
                        
                    case CHILD_REMOVED:
                        System.out.println("å­èŠ‚ç‚¹åˆ é™¤: " + childData.getPath());
                        break;
                        
                    case CONNECTION_SUSPENDED:
                        System.out.println("è¿æ¥æŒ‚èµ·");
                        break;
                        
                    case CONNECTION_RECONNECTED:
                        System.out.println("é‡æ–°è¿æ¥");
                        break;
                        
                    case CONNECTION_LOST:
                        System.out.println("è¿æ¥ä¸¢å¤±");
                        break;
                        
                    case INITIALIZED:
                        System.out.println("ç¼“å­˜åˆå§‹åŒ–å®Œæˆ");
                        break;
                }
            }
        });
        
        // å¯åŠ¨ç¼“å­˜ï¼ˆé‡è¦ï¼šå¿…é¡»åœ¨ä½¿ç”¨å‰å¯åŠ¨ï¼‰
        cache.start(PathChildrenCache.StartMode.BUILD_INITIAL_CACHE);
        
        // æ¨¡æ‹Ÿå­èŠ‚ç‚¹å˜åŒ–
        System.out.println("åˆ›å»ºå­èŠ‚ç‚¹...");
        client.create().forPath(parentPath + "/child1", "data1".getBytes());
        Thread.sleep(1000);
        
        System.out.println("æ›´æ–°å­èŠ‚ç‚¹...");
        client.setData().forPath(parentPath + "/child1", "updated data1".getBytes());
        Thread.sleep(1000);
        
        System.out.println("åˆ é™¤å­èŠ‚ç‚¹...");
        client.delete().forPath(parentPath + "/child1");
        Thread.sleep(1000);
        
        // å…³é—­ç¼“å­˜
        cache.close();
    }
}
```

### 6.3 NodeCacheå•èŠ‚ç‚¹ç¼“å­˜


**ğŸ¯ ç›‘æ§å•ä¸ªèŠ‚ç‚¹**ï¼š
```java
public class NodeCacheExample {
    public static void demonstrate(CuratorFramework client) throws Exception {
        String nodePath = "/node-cache-test";
        
        // åˆ›å»ºæµ‹è¯•èŠ‚ç‚¹
        if (client.checkExists().forPath(nodePath) == null) {
            client.create()
                .creatingParentsIfNeeded()
                .forPath(nodePath, "initial data".getBytes());
        }
        
        // åˆ›å»ºNodeCache
        NodeCache nodeCache = new NodeCache(client, nodePath);
        
        // æ·»åŠ ç›‘å¬å™¨
        nodeCache.getListenable().addListener(new NodeCacheListener() {
            @Override
            public void nodeChanged() throws Exception {
                ChildData currentData = nodeCache.getCurrentData();
                
                if (currentData == null) {
                    System.out.println("èŠ‚ç‚¹è¢«åˆ é™¤");
                } else {
                    System.out.println("èŠ‚ç‚¹æ•°æ®å˜åŒ–: " + currentData.getPath());
                    System.out.println("æ–°æ•°æ®: " + new String(currentData.getData()));
                    System.out.println("ç‰ˆæœ¬: " + currentData.getStat().getVersion());
                }
            }
        });
        
        // å¯åŠ¨ç¼“å­˜
        nodeCache.start(true); // trueè¡¨ç¤ºå¯åŠ¨æ—¶æ„å»ºåˆå§‹ç¼“å­˜
        
        // æ¨¡æ‹ŸèŠ‚ç‚¹å˜åŒ–
        System.out.println("æ›´æ–°èŠ‚ç‚¹æ•°æ®...");
        client.setData().forPath(nodePath, "updated data".getBytes());
        Thread.sleep(1000);
        
        System.out.println("å†æ¬¡æ›´æ–°èŠ‚ç‚¹æ•°æ®...");
        client.setData().forPath(nodePath, "final data".getBytes());
        Thread.sleep(1000);
        
        // è·å–å½“å‰ç¼“å­˜çš„æ•°æ®
        ChildData cachedData = nodeCache.getCurrentData();
        if (cachedData != null) {
            System.out.println("ç¼“å­˜ä¸­çš„æ•°æ®: " + new String(cachedData.getData()));
        }
        
        // å…³é—­ç¼“å­˜
        nodeCache.close();
        
        // æ¸…ç†æµ‹è¯•èŠ‚ç‚¹
        client.delete().forPath(nodePath);
    }
}
```

### 6.4 TreeCacheæ ‘å½¢ç¼“å­˜


**ğŸŒ³ ç›‘æ§æ•´ä¸ªå­æ ‘**ï¼š
```java
public class TreeCacheExample {
    public static void demonstrate(CuratorFramework client) throws Exception {
        String rootPath = "/tree-cache-test";
        
        // ç¡®ä¿æ ¹èŠ‚ç‚¹å­˜åœ¨
        if (client.checkExists().forPath(rootPath) == null) {
            client.create().creatingParentsIfNeeded().forPath(rootPath);
        }
        
        // åˆ›å»ºTreeCache
        TreeCache treeCache = TreeCache.newBuilder(client, rootPath)
            .setCacheData(true)  // ç¼“å­˜æ•°æ®
            .setMaxDepth(3)      // æœ€å¤§æ·±åº¦
            .build();
        
        // æ·»åŠ ç›‘å¬å™¨
        treeCache.getListenable().addListener(new TreeCacheListener() {
            @Override
            public void childEvent(CuratorFramework client, TreeCacheEvent event) 
                    throws Exception {
                ChildData data = event.getData();
                
                switch (event.getType()) {
                    case NODE_ADDED:
                        System.out.println("èŠ‚ç‚¹æ·»åŠ : " + data.getPath());
                        if (data.getData() != null) {
                            System.out.println("æ•°æ®: " + new String(data.getData()));
                        }
                        break;
                        
                    case NODE_UPDATED:
                        System.out.println("èŠ‚ç‚¹æ›´æ–°: " + data.getPath());
                        System.out.println("æ–°æ•°æ®: " + new String(data.getData()));
                        break;
                        
                    case NODE_REMOVED:
                        System.out.println("èŠ‚ç‚¹åˆ é™¤: " + data.getPath());
                        break;
                        
                    case CONNECTION_SUSPENDED:
                        System.out.println("è¿æ¥æŒ‚èµ·");
                        break;
                        
                    case CONNECTION_RECONNECTED:
                        System.out.println("é‡æ–°è¿æ¥");
                        break;
                        
                    case CONNECTION_LOST:
                        System.out.println("è¿æ¥ä¸¢å¤±");
                        break;
                        
                    case INITIALIZED:
                        System.out.println("TreeCacheåˆå§‹åŒ–å®Œæˆ");
                        break;
                }
            }
        });
        
        // å¯åŠ¨TreeCache
        treeCache.start();
        
        // æ¨¡æ‹Ÿå„ç§èŠ‚ç‚¹æ“ä½œ
        System.out.println("åˆ›å»ºå­èŠ‚ç‚¹...");
        client.create().forPath(rootPath + "/level1", "level1 data".getBytes());
        Thread.sleep(1000);
        
        System.out.println("åˆ›å»ºå­™èŠ‚ç‚¹...");
        client.create().forPath(rootPath + "/level1/level2", "level2 data".getBytes());
        Thread.sleep(1000);
        
        System.out.println("æ›´æ–°å­èŠ‚ç‚¹...");
        client.setData().forPath(rootPath + "/level1", "updated level1 data".getBytes());
        Thread.sleep(1000);
        
        // æŸ¥çœ‹ç¼“å­˜ä¸­çš„æ•°æ®
        Map<String, ChildData> currentChildren = treeCache.getCurrentChildren(rootPath);
        System.out.println("å½“å‰å­èŠ‚ç‚¹æ•°é‡: " + currentChildren.size());
        
        ChildData level1Data = treeCache.getCurrentData(rootPath + "/level1");
        if (level1Data != null) {
            System.out.println("level1èŠ‚ç‚¹æ•°æ®: " + new String(level1Data.getData()));
        }
        
        // å…³é—­ç¼“å­˜
        treeCache.close();
        
        // æ¸…ç†æµ‹è¯•æ•°æ®
        client.delete().deletingChildrenIfNeeded().forPath(rootPath);
    }
}
```

---

## 7. ğŸ”„ ä¼˜é›…å…³é—­å¤„ç†


### 7.1 ä¸ºä»€ä¹ˆéœ€è¦ä¼˜é›…å…³é—­


**ä¼˜é›…å…³é—­çš„é‡è¦æ€§**ï¼š
å°±åƒç¦»å¼€æˆ¿é—´è¦å…³ç¯ä¸€æ ·ï¼Œç¨‹åºç»“æŸæ—¶ä¹Ÿè¦"å…³ç¯" - é‡Šæ”¾èµ„æºã€å…³é—­è¿æ¥ã€æ¸…ç†ç¼“å­˜ã€‚

```
ä¸ä¼˜é›…å…³é—­çš„é—®é¢˜ï¼š
ğŸ˜° è¿æ¥æ³„æ¼ï¼šZKè¿æ¥æ²¡æœ‰æ­£ç¡®å…³é—­
ğŸ˜° çº¿ç¨‹æ³„æ¼ï¼šåå°çº¿ç¨‹ç»§ç»­è¿è¡Œ
ğŸ˜° èµ„æºå ç”¨ï¼šå†…å­˜å’Œæ–‡ä»¶å¥æŸ„æœªé‡Šæ”¾
ğŸ˜° æ•°æ®ä¸ä¸€è‡´ï¼šæ­£åœ¨è¿›è¡Œçš„æ“ä½œè¢«ä¸­æ–­

ä¼˜é›…å…³é—­çš„å¥½å¤„ï¼š
âœ… é‡Šæ”¾æ‰€æœ‰èµ„æº
âœ… ä¿å­˜é‡è¦çŠ¶æ€
âœ… é¿å…æ•°æ®æŸå
âœ… æä¾›è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒ
```

### 7.2 åŸºæœ¬å…³é—­æµç¨‹


**ğŸ“ æ ‡å‡†å…³é—­æµç¨‹**ï¼š
```java
public class GracefulShutdownExample {
    private CuratorFramework client;
    private PathChildrenCache pathCache;
    private NodeCache nodeCache;
    private TreeCache treeCache;
    
    public void initialize() throws Exception {
        // åˆå§‹åŒ–å®¢æˆ·ç«¯
        client = CuratorFrameworkFactory.builder()
            .connectString("localhost:2181")
            .sessionTimeoutMs(30000)
            .retryPolicy(new ExponentialBackoffRetry(1000, 3))
            .build();
            
        client.start();
        client.blockUntilConnected(10, TimeUnit.SECONDS);
        
        // åˆå§‹åŒ–å„ç§ç¼“å­˜
        pathCache = new PathChildrenCache(client, "/test", true);
        pathCache.start();
        
        nodeCache = new NodeCache(client, "/node-test");
        nodeCache.start();
        
        treeCache = TreeCache.newBuilder(client, "/tree-test").build();
        treeCache.start();
    }
    
    public void shutdown() throws Exception {
        System.out.println("å¼€å§‹ä¼˜é›…å…³é—­...");
        
        // 1. å…³é—­ç¼“å­˜ï¼ˆæŒ‰åˆ›å»ºé¡ºåºçš„é€†åºå…³é—­ï¼‰
        if (treeCache != null) {
            System.out.println("å…³é—­TreeCache...");
            treeCache.close();
        }
        
        if (nodeCache != null) {
            System.out.println("å…³é—­NodeCache...");
            nodeCache.close();
        }
        
        if (pathCache != null) {
            System.out.println("å…³é—­PathChildrenCache...");
            pathCache.close();
        }
        
        // 2. å…³é—­å®¢æˆ·ç«¯è¿æ¥
        if (client != null) {
            System.out.println("å…³é—­CuratorFramework...");
            client.close();
        }
        
        System.out.println("ä¼˜é›…å…³é—­å®Œæˆ");
    }
    
    public static void main(String[] args) throws Exception {
        GracefulShutdownExample example = new GracefulShutdownExample();
        
        // æ³¨å†ŒJVMå…³é—­é’©å­
        Runtime.getRuntime().addShutdownHook(new Thread(() -> {
            try {
                example.shutdown();
            } catch (Exception e) {
                System.err.println("å…³é—­è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: " + e.getMessage());
            }
        }));
        
        // åˆå§‹åŒ–å¹¶è¿è¡Œåº”ç”¨
        example.initialize();
        
        // æ¨¡æ‹Ÿåº”ç”¨è¿è¡Œ
        System.out.println("åº”ç”¨æ­£åœ¨è¿è¡Œï¼ŒæŒ‰Ctrl+Cé€€å‡º...");
        Thread.sleep(Long.MAX_VALUE);
    }
}
```

### 7.3 ä½¿ç”¨try-with-resourcesæ¨¡å¼


**ğŸ›¡ï¸ è‡ªåŠ¨èµ„æºç®¡ç†**ï¼š
```java
public class AutoCloseableExample {
    
    // è‡ªå®šä¹‰å¯è‡ªåŠ¨å…³é—­çš„Curatorå®¢æˆ·ç«¯åŒ…è£…ç±»
    public static class AutoCloseableCuratorFramework implements AutoCloseable {
        private final CuratorFramework client;
        
        public AutoCloseableCuratorFramework(String connectString) {
            this.client = CuratorFrameworkFactory.builder()
                .connectString(connectString)
                .retryPolicy(new ExponentialBackoffRetry(1000, 3))
                .build();
        }
        
        public CuratorFramework getClient() {
            return client;
        }
        
        public void start() throws Exception {
            client.start();
            client.blockUntilConnected(30, TimeUnit.SECONDS);
        }
        
        @Override
        public void close() throws Exception {
            System.out.println("è‡ªåŠ¨å…³é—­CuratorFramework");
            client.close();
        }
    }
    
    public static void main(String[] args) {
        // ä½¿ç”¨try-with-resourcesç¡®ä¿èµ„æºè‡ªåŠ¨å…³é—­
        try (AutoCloseableCuratorFramework wrapper = 
                 new AutoCloseableCuratorFramework("localhost:2181")) {
            
            wrapper.start();
            CuratorFramework client = wrapper.getClient();
            
            // ä½¿ç”¨å®¢æˆ·ç«¯è¿›è¡Œæ“ä½œ
            client.create()
                .creatingParentsIfNeeded()
                .forPath("/auto-close-test", "test data".getBytes());
                
            byte[] data = client.getData().forPath("/auto-close-test");
            System.out.println("è¯»å–æ•°æ®: " + new String(data));
            
            client.delete().forPath("/auto-close-test");
            
        } catch (Exception e) {
            System.err.println("æ“ä½œå¤±è´¥: " + e.getMessage());
        }
        // è¿™é‡Œä¼šè‡ªåŠ¨è°ƒç”¨close()æ–¹æ³•
    }
}
```

### 7.4 Springæ¡†æ¶é›†æˆçš„ä¼˜é›…å…³é—­


**ğŸŒ¸ Springç¯å¢ƒä¸‹çš„æœ€ä½³å®è·µ**ï¼š
```java
@Component
public class CuratorService implements DisposableBean {
    private CuratorFramework client;
    private List<Closeable> resources = new ArrayList<>();
    
    @PostConstruct
    public void init() throws Exception {
        // åˆå§‹åŒ–Curatorå®¢æˆ·ç«¯
        client = CuratorFrameworkFactory.builder()
            .connectString("${zookeeper.connect-string}")
            .sessionTimeoutMs(30000)
            .retryPolicy(new ExponentialBackoffRetry(1000, 3))
            .build();
            
        client.start();
        client.blockUntilConnected(30, TimeUnit.SECONDS);
        
        // åˆå§‹åŒ–ç¼“å­˜
        PathChildrenCache pathCache = new PathChildrenCache(client, "/app", true);
        pathCache.start();
        resources.add(pathCache);
        
        NodeCache nodeCache = new NodeCache(client, "/app/config");
        nodeCache.start();
        resources.add(nodeCache);
    }
    
    public CuratorFramework getClient() {
        return client;
    }
    
    @PreDestroy
    @Override
    public void destroy() throws Exception {
        System.out.println("Springå®¹å™¨å…³é—­ï¼Œå¼€å§‹æ¸…ç†Curatorèµ„æº...");
        
        // å…³é—­æ‰€æœ‰ç¼“å­˜èµ„æº
        for (Closeable resource : resources) {
            try {
                resource.close();
            } catch (Exception e) {
                System.err.println("å…³é—­èµ„æºå¤±è´¥: " + e.getMessage());
            }
        }
        resources.clear();
        
        // å…³é—­å®¢æˆ·ç«¯
        if (client != null) {
            client.close();
        }
        
        System.out.println("Curatorèµ„æºæ¸…ç†å®Œæˆ");
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ”¸ CuratorFrameworkï¼šCuratorçš„æ ¸å¿ƒæ¥å£ï¼Œæä¾›æ‰€æœ‰ZKæ“ä½œ
ğŸ”¸ è¿æ¥æ„å»ºå™¨ï¼šé€šè¿‡å»ºé€ è€…æ¨¡å¼é…ç½®å®¢æˆ·ç«¯å‚æ•°
ğŸ”¸ å®¢æˆ·ç«¯å¯åŠ¨ï¼šstart()åéœ€è¦ç­‰å¾…è¿æ¥å»ºç«‹æ‰èƒ½æ“ä½œ
ğŸ”¸ åŸºæœ¬æ“ä½œAPIï¼šcreateã€getDataã€setDataã€deleteã€getChildren
ğŸ”¸ è·¯å¾„ç¼“å­˜ï¼šPathChildrenCacheã€NodeCacheã€TreeCacheä¸‰ç§ç¼“å­˜
ğŸ”¸ ä¼˜é›…å…³é—­ï¼šæŒ‰é¡ºåºå…³é—­ç¼“å­˜å’Œå®¢æˆ·ç«¯ï¼Œé‡Šæ”¾æ‰€æœ‰èµ„æº
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ Curatorç›¸æ¯”åŸç”Ÿå®¢æˆ·ç«¯çš„ä¼˜åŠ¿**ï¼š
```
è‡ªåŠ¨åŒ–ç®¡ç†ï¼š
â€¢ è¿æ¥æ–­å¼€è‡ªåŠ¨é‡è¿
â€¢ ä¼šè¯è¶…æ—¶è‡ªåŠ¨å¤„ç†
â€¢ æ™ºèƒ½é‡è¯•ç­–ç•¥

APIå‹å¥½æ€§ï¼š
â€¢ é“¾å¼è°ƒç”¨é£æ ¼
â€¢ å¼‚æ­¥æ“ä½œæ”¯æŒ
â€¢ ä¸°å¯Œçš„é…ç½®é€‰é¡¹

é«˜çº§åŠŸèƒ½ï¼š
â€¢ è·¯å¾„ç¼“å­˜æœºåˆ¶
â€¢ åˆ†å¸ƒå¼åè°ƒå·¥å…·
â€¢ äº‹ä»¶ç›‘å¬æœºåˆ¶
```

**ğŸ”¹ ä½•æ—¶ä½¿ç”¨è·¯å¾„ç¼“å­˜**ï¼š
```
é€‚ç”¨åœºæ™¯ï¼š
âœ… éœ€è¦ç›‘æ§èŠ‚ç‚¹å˜åŒ–çš„åº”ç”¨
âœ… é¢‘ç¹è¯»å–èŠ‚ç‚¹æ•°æ®çš„åœºæ™¯
âœ… éœ€è¦æœ¬åœ°ç¼“å­˜æé«˜æ€§èƒ½
âœ… å®ç°é…ç½®ä¸­å¿ƒç­‰åŠŸèƒ½

ä¸é€‚ç”¨åœºæ™¯ï¼š
âŒ ç®€å•çš„ä¸€æ¬¡æ€§æ“ä½œ
âŒ èŠ‚ç‚¹å˜åŒ–å¾ˆå°‘çš„åœºæ™¯
âŒ å†…å­˜ä½¿ç”¨æ•æ„Ÿçš„ç¯å¢ƒ
âŒ å¯¹å®æ—¶æ€§è¦æ±‚æé«˜çš„åœºæ™¯
```

**ğŸ”¹ é‡è¯•ç­–ç•¥çš„é€‰æ‹©**ï¼š
```
ExponentialBackoffRetryï¼š
â€¢ æŒ‡æ•°é€€é¿ï¼Œé€‚åˆå¤§å¤šæ•°åœºæ™¯
â€¢ é¿å…é‡è¯•é£æš´

RetryNTimesï¼š
â€¢ å›ºå®šé‡è¯•æ¬¡æ•°ï¼Œç®€å•ç›´æ¥
â€¢ é€‚åˆå¯¹å»¶è¿Ÿæ•æ„Ÿçš„åœºæ™¯

BoundedExponentialBackoffRetryï¼š
â€¢ æœ‰ç•ŒæŒ‡æ•°é€€é¿ï¼Œç”Ÿäº§ç¯å¢ƒæ¨è
â€¢ å¹³è¡¡é‡è¯•æ•ˆæœå’Œèµ„æºæ¶ˆè€—
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ’¼ å¼€å‘ç¯å¢ƒé…ç½®**ï¼š
```java
// å¼€å‘ç¯å¢ƒï¼šç®€å•é…ç½®ï¼Œæ–¹ä¾¿è°ƒè¯•
CuratorFramework client = CuratorFrameworkFactory.newClient(
    "localhost:2181",
    new RetryNTimes(3, 1000)
);
```

**ğŸ­ ç”Ÿäº§ç¯å¢ƒé…ç½®**ï¼š
```java
// ç”Ÿäº§ç¯å¢ƒï¼šå®Œæ•´é…ç½®ï¼Œå¯é æ€§ä¼˜å…ˆ
CuratorFramework client = CuratorFrameworkFactory.builder()
    .connectString("zk1:2181,zk2:2181,zk3:2181")
    .sessionTimeoutMs(30000)
    .connectionTimeoutMs(15000)
    .retryPolicy(new BoundedExponentialBackoffRetry(1000, 30000, 5))
    .namespace("myapp")
    .build();
```

**ğŸ› ï¸ æœ€ä½³å®è·µå»ºè®®**ï¼š
```
è¿æ¥ç®¡ç†ï¼š
â€¢ åº”ç”¨å¯åŠ¨æ—¶åˆ›å»ºå®¢æˆ·ç«¯å¹¶å¯åŠ¨
â€¢ ä½¿ç”¨å•ä¾‹æ¨¡å¼å…±äº«å®¢æˆ·ç«¯å®ä¾‹
â€¢ åº”ç”¨å…³é—­æ—¶ä¼˜é›…å…³é—­å®¢æˆ·ç«¯

é”™è¯¯å¤„ç†ï¼š
â€¢ æ•è·KeeperExceptionå¹¶æ ¹æ®é”™è¯¯ç å¤„ç†
â€¢ ä½¿ç”¨åˆé€‚çš„é‡è¯•ç­–ç•¥
â€¢ ç›‘å¬è¿æ¥çŠ¶æ€å˜åŒ–

æ€§èƒ½ä¼˜åŒ–ï¼š
â€¢ åˆç†ä½¿ç”¨è·¯å¾„ç¼“å­˜
â€¢ é¿å…é¢‘ç¹åˆ›å»ºå’Œé”€æ¯å®¢æˆ·ç«¯
â€¢ ä½¿ç”¨å¼‚æ­¥APIæé«˜å¹¶å‘æ€§èƒ½
```

### 8.4 å¸¸è§é—®é¢˜è§£ç­”


**â“ ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å‘½åç©ºé—´ï¼Ÿ**
```
ç­”ï¼šå‘½åç©ºé—´æä¾›å¤šç§Ÿæˆ·éš”ç¦»ï¼š
â€¢ é¿å…ä¸åŒåº”ç”¨ä¹‹é—´çš„è·¯å¾„å†²çª
â€¢ ç®€åŒ–åº”ç”¨å†…éƒ¨çš„è·¯å¾„ç®¡ç†
â€¢ æä¾›é€»è¾‘ä¸Šçš„åº”ç”¨è¾¹ç•Œ
â€¢ ä¾¿äºæƒé™æ§åˆ¶å’Œç®¡ç†
```

**â“ å¦‚ä½•é€‰æ‹©åˆé€‚çš„ç¼“å­˜ç±»å‹ï¼Ÿ**
```
ç­”ï¼šæ ¹æ®ç›‘æ§éœ€æ±‚é€‰æ‹©ï¼š
â€¢ NodeCacheï¼šç›‘æ§å•ä¸ªèŠ‚ç‚¹çš„æ•°æ®å˜åŒ–
â€¢ PathChildrenCacheï¼šç›‘æ§æŸä¸ªèŠ‚ç‚¹çš„å­èŠ‚ç‚¹å˜åŒ–
â€¢ TreeCacheï¼šç›‘æ§æ•´ä¸ªå­æ ‘çš„å˜åŒ–ï¼ˆåŠŸèƒ½æœ€å…¨é¢ï¼‰
```

**â“ å®¢æˆ·ç«¯ä»€ä¹ˆæ—¶å€™ä¼šè‡ªåŠ¨é‡è¿ï¼Ÿ**
```
ç­”ï¼šä»¥ä¸‹æƒ…å†µä¼šè§¦å‘è‡ªåŠ¨é‡è¿ï¼š
â€¢ ç½‘ç»œä¸´æ—¶ä¸­æ–­
â€¢ ZooKeeperæœåŠ¡å™¨é‡å¯
â€¢ ä¼šè¯è¶…æ—¶ä½†è¿æ¥å¯æ¢å¤
â€¢ è´Ÿè½½å‡è¡¡å¯¼è‡´çš„è¿æ¥åˆ‡æ¢
```

**ğŸ§  è®°å¿†è¦ç‚¹**ï¼š
- Curatoræ˜¯ZooKeeperçš„é«˜çº§å®¢æˆ·ç«¯ï¼Œç®€åŒ–äº†å¼€å‘å¤æ‚åº¦
- å®¢æˆ·ç«¯éœ€è¦start()å¯åŠ¨ï¼Œå»ºè®®ç­‰å¾…è¿æ¥å»ºç«‹
- è·¯å¾„ç¼“å­˜èƒ½å®æ—¶ç›‘æ§èŠ‚ç‚¹å˜åŒ–ï¼Œæä¾›æœ¬åœ°ç¼“å­˜
- ä¼˜é›…å…³é—­å¾ˆé‡è¦ï¼Œé¿å…èµ„æºæ³„æ¼
- ç”Ÿäº§ç¯å¢ƒè¦é…ç½®é‡è¯•ç­–ç•¥å’Œè¿æ¥å‚æ•°

**æ ¸å¿ƒç†å¿µ**ï¼šCuratorè®©ZooKeeperç¼–ç¨‹ä»"æ‰‹åŠ¨æŒ¡"å˜æˆäº†"è‡ªåŠ¨æŒ¡"ï¼Œä½†ä»éœ€è¦ç†è§£åº•å±‚åŸç†æ‰èƒ½ç”¨å¥½å®ƒï¼