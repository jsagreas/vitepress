---
title: 6ã€Curatoræ¡†æ¶ä»‹ç»
---
## ğŸ“š ç›®å½•

1. [Curatoræ¡†æ¶æ¦‚è¿°](#1-curatoræ¡†æ¶æ¦‚è¿°)
2. [æ ¸å¿ƒæ¶æ„ä¸ç»„ä»¶](#2-æ ¸å¿ƒæ¶æ„ä¸ç»„ä»¶)
3. [è¿æ¥ç®¡ç†ä¸é‡è¯•ç­–ç•¥](#3-è¿æ¥ç®¡ç†ä¸é‡è¯•ç­–ç•¥)
4. [åˆ†å¸ƒå¼é”å®ç°](#4-åˆ†å¸ƒå¼é”å®ç°)
5. [å¸¸ç”¨é…æ–¹æ¨¡å¼](#5-å¸¸ç”¨é…æ–¹æ¨¡å¼)
6. [å®è·µåº”ç”¨ç¤ºä¾‹](#6-å®è·µåº”ç”¨ç¤ºä¾‹)
7. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#7-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ Curatoræ¡†æ¶æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯Curator


**ç®€å•ç†è§£**ï¼šCuratorå°±æ˜¯Apacheå¼€å‘çš„ä¸€ä¸ª**Zookeeperé«˜çº§å®¢æˆ·ç«¯å·¥å…·åŒ…**ï¼Œå®ƒæŠŠZookeeperçš„å¤æ‚æ“ä½œå˜å¾—ç®€å•æ˜“ç”¨ã€‚

```
åŸç”ŸZookeeperå®¢æˆ·ç«¯çš„é—®é¢˜ï¼š
âŒ è¿æ¥ç®¡ç†å¤æ‚ï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†æ–­çº¿é‡è¿
âŒ æ²¡æœ‰é‡è¯•æœºåˆ¶ï¼Œç½‘ç»œæŠ–åŠ¨å°±å¤±è´¥
âŒ APIè®¾è®¡ååº•å±‚ï¼Œä½¿ç”¨èµ·æ¥å¾ˆç¹ç
âŒ å¸¸è§åŠŸèƒ½éœ€è¦è‡ªå·±å®ç°ï¼Œæ¯”å¦‚åˆ†å¸ƒå¼é”

Curatorçš„è§£å†³æ–¹æ¡ˆï¼š
âœ… è‡ªåŠ¨ç®¡ç†è¿æ¥ï¼Œæ–­çº¿è‡ªåŠ¨é‡è¿
âœ… å†…ç½®å¤šç§é‡è¯•ç­–ç•¥ï¼Œç½‘ç»œé—®é¢˜è‡ªåŠ¨å¤„ç†
âœ… é«˜çº§APIï¼Œæ“ä½œç®€å•ç›´è§‚
âœ… æä¾›ä¸°å¯Œçš„åˆ†å¸ƒå¼åº”ç”¨é…æ–¹æ¨¡å¼
```

### 1.2 Curatorçš„æ ¸å¿ƒä»·å€¼


**ğŸ”¸ è¿æ¥ç®¡ç†è‡ªåŠ¨åŒ–**
```java
// åŸç”Ÿå®¢æˆ·ç«¯ï¼šéœ€è¦æ‰‹åŠ¨å¤„ç†è¿æ¥çŠ¶æ€
ZooKeeper zk = new ZooKeeper("localhost:2181", 3000, new Watcher() {
    public void process(WatchedEvent event) {
        // æ‰‹åŠ¨å¤„ç†è¿æ¥çŠ¶æ€å˜åŒ–
        if (event.getState() == Event.KeeperState.Disconnected) {
            // éœ€è¦è‡ªå·±å†™é‡è¿é€»è¾‘
        }
    }
});

// Curatorï¼šè¿æ¥ç®¡ç†å®Œå…¨è‡ªåŠ¨åŒ–
CuratorFramework client = CuratorFrameworkFactory.builder()
    .connectString("localhost:2181")
    .retryPolicy(new ExponentialBackoffRetry(1000, 3))
    .build();
client.start();  // å¯åŠ¨åè‡ªåŠ¨ç®¡ç†è¿æ¥
```

**ğŸ”¸ æ“ä½œç®€å•åŒ–**
```java
// åŸç”Ÿå®¢æˆ·ç«¯ï¼šåˆ›å»ºèŠ‚ç‚¹å¾ˆå¤æ‚
zk.create("/myapp", "data".getBytes(), 
          ZooDefs.Ids.OPEN_ACL_UNSAFE, 
          CreateMode.PERSISTENT);

// Curatorï¼šä¸€è¡Œä»£ç æå®š
client.create()
      .creatingParentsIfNeeded()  // è‡ªåŠ¨åˆ›å»ºçˆ¶èŠ‚ç‚¹
      .forPath("/myapp", "data".getBytes());
```

### 1.3 é€‚ç”¨åœºæ™¯åˆ†æ


```
ğŸ¯ ä»€ä¹ˆæ—¶å€™ç”¨Curatorï¼š
âœ… ç”Ÿäº§ç¯å¢ƒçš„Zookeeperåº”ç”¨å¼€å‘
âœ… éœ€è¦åˆ†å¸ƒå¼åè°ƒåŠŸèƒ½ï¼ˆé”ã€é˜Ÿåˆ—ã€é€‰ä¸¾ç­‰ï¼‰
âœ… å¯¹ç¨³å®šæ€§å’Œå¯é æ€§è¦æ±‚é«˜çš„ç³»ç»Ÿ
âœ… å¸Œæœ›å¿«é€Ÿå¼€å‘ï¼Œä¸æƒ³å¤„ç†åº•å±‚ç»†èŠ‚

ğŸš« ä»€ä¹ˆæ—¶å€™ä¸ç”¨Curatorï¼š
âŒ ç®€å•çš„å­¦ä¹ å’Œå®éªŒé¡¹ç›®
âŒ å¯¹æ€§èƒ½æœ‰æè‡´è¦æ±‚çš„åœºæ™¯
âŒ éœ€è¦å®šåˆ¶åŒ–çš„è¿æ¥ç®¡ç†é€»è¾‘
```

---

## 2. ğŸ—ï¸ æ ¸å¿ƒæ¶æ„ä¸ç»„ä»¶


### 2.1 Curatoræ•´ä½“æ¶æ„


```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                åº”ç”¨ç¨‹åºä»£ç                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Curator Recipes  â”‚  é…æ–¹æ¨¡å¼ï¼ˆåˆ†å¸ƒå¼é”ã€é˜Ÿåˆ—ç­‰ï¼‰     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Curator Framework â”‚  é«˜çº§APIå°è£…                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Curator Client    â”‚  è¿æ¥ç®¡ç†ã€é‡è¯•ç­–ç•¥             â”‚  
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Zookeeper Client  â”‚  åŸç”Ÿå®¢æˆ·ç«¯                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ¶æ„è¯´æ˜ï¼š
- Curator Clientï¼šè´Ÿè´£è¿æ¥ç®¡ç†å’Œé‡è¯•
- Curator Frameworkï¼šæä¾›é«˜çº§API
- Curator Recipesï¼šæä¾›åˆ†å¸ƒå¼åº”ç”¨é…æ–¹
```

### 2.2 ä¸»è¦ç»„ä»¶è¯¦è§£


**ğŸ”§ CuratorFramework - æ ¸å¿ƒæ¡†æ¶**
```java
// è¿™æ˜¯Curatorçš„æ ¸å¿ƒæ¥å£ï¼Œæ‰€æœ‰æ“ä½œéƒ½é€šè¿‡å®ƒè¿›è¡Œ
public interface CuratorFramework {
    // åˆ›å»ºæ“ä½œ
    CreateBuilder create();
    
    // åˆ é™¤æ“ä½œ  
    DeleteBuilder delete();
    
    // æ£€æŸ¥å­˜åœ¨
    ExistsBuilder checkExists();
    
    // è·å–æ•°æ®
    GetDataBuilder getData();
    
    // è®¾ç½®æ•°æ®
    SetDataBuilder setData();
    
    // è·å–å­èŠ‚ç‚¹
    GetChildrenBuilder getChildren();
}

// ä½¿ç”¨ç¤ºä¾‹
CuratorFramework client = CuratorFrameworkFactory.builder()
    .connectString("localhost:2181")
    .sessionTimeoutMs(30000)
    .connectionTimeoutMs(15000)
    .retryPolicy(new ExponentialBackoffRetry(1000, 3))
    .build();
```

**ğŸ”„ RetryPolicy - é‡è¯•ç­–ç•¥**
```java
// æŒ‡æ•°é€€é¿é‡è¯•ï¼šæ¯æ¬¡é‡è¯•é—´éš”æ—¶é—´é€’å¢
RetryPolicy retryPolicy = new ExponentialBackoffRetry(
    1000,  // åŸºç¡€ç¡çœ æ—¶é—´1ç§’
    3      // æœ€å¤§é‡è¯•3æ¬¡
);

// å›ºå®šé—´éš”é‡è¯•
RetryPolicy retryPolicy = new RetryNTimes(
    3,     // é‡è¯•3æ¬¡
    1000   // æ¯æ¬¡é—´éš”1ç§’
);

// æ— é™é‡è¯•ï¼ˆç›´åˆ°æˆåŠŸï¼‰
RetryPolicy retryPolicy = new RetryForever(1000);
```

### 2.3 æ ¸å¿ƒä¾èµ–å…³ç³»


```xml
<!-- Mavenä¾èµ–é…ç½® -->
<dependencies>
    <!-- Curatoræ ¸å¿ƒæ¡†æ¶ -->
    <dependency>
        <groupId>org.apache.curator</groupId>
        <artifactId>curator-framework</artifactId>
        <version>4.3.0</version>
    </dependency>
    
    <!-- Curatoré…æ–¹æ¨¡å¼ -->  
    <dependency>
        <groupId>org.apache.curator</groupId>
        <artifactId>curator-recipes</artifactId>
        <version>4.3.0</version>
    </dependency>
</dependencies>
```

---

## 3. ğŸ”— è¿æ¥ç®¡ç†ä¸é‡è¯•ç­–ç•¥


### 3.1 è¿æ¥ç®¡ç†æœºåˆ¶


**è¿æ¥ç”Ÿå‘½å‘¨æœŸè‡ªåŠ¨åŒ–**
```java
public class CuratorConnectionExample {
    private CuratorFramework client;
    
    public void initClient() {
        client = CuratorFrameworkFactory.builder()
            .connectString("zk1:2181,zk2:2181,zk3:2181")
            .sessionTimeoutMs(30000)    // ä¼šè¯è¶…æ—¶30ç§’
            .connectionTimeoutMs(15000) // è¿æ¥è¶…æ—¶15ç§’
            .retryPolicy(new ExponentialBackoffRetry(1000, 3))
            .build();
        
        // å¯åŠ¨å®¢æˆ·ç«¯ï¼ˆå¼‚æ­¥æ“ä½œï¼‰
        client.start();
        
        try {
            // ç­‰å¾…è¿æ¥å»ºç«‹ï¼ˆæœ€å¤šç­‰å¾…10ç§’ï¼‰
            boolean connected = client.blockUntilConnected(10, TimeUnit.SECONDS);
            if (connected) {
                System.out.println("æˆåŠŸè¿æ¥åˆ°Zookeeper");
            }
        } catch (InterruptedException e) {
            System.out.println("è¿æ¥è¢«ä¸­æ–­");
        }
    }
}
```

**è¿æ¥çŠ¶æ€ç›‘å¬**
```java
// ç›‘å¬è¿æ¥çŠ¶æ€å˜åŒ–
client.getConnectionStateListenable().addListener(new ConnectionStateListener() {
    @Override
    public void stateChanged(CuratorFramework client, ConnectionState newState) {
        switch (newState) {
            case CONNECTED:
                System.out.println("å·²è¿æ¥åˆ°Zookeeper");
                break;
            case SUSPENDED:
                System.out.println("è¿æ¥æš‚åœï¼Œæ­£åœ¨é‡è¿...");
                break;
            case RECONNECTED:
                System.out.println("é‡æ–°è¿æ¥æˆåŠŸ");
                break;
            case LOST:
                System.out.println("è¿æ¥ä¸¢å¤±");
                break;
        }
    }
});
```

### 3.2 é‡è¯•ç­–ç•¥è¯¦è§£


**ğŸ”„ æŒ‡æ•°é€€é¿é‡è¯•ï¼ˆæ¨èï¼‰**
```java
// ç¬¬1æ¬¡é‡è¯•ï¼šç­‰å¾…1ç§’
// ç¬¬2æ¬¡é‡è¯•ï¼šç­‰å¾…2ç§’  
// ç¬¬3æ¬¡é‡è¯•ï¼šç­‰å¾…4ç§’
RetryPolicy policy = new ExponentialBackoffRetry(
    1000,     // åŸºç¡€é—´éš”æ—¶é—´
    3,        // æœ€å¤§é‡è¯•æ¬¡æ•°
    30000     // æœ€å¤§é—´éš”æ—¶é—´ï¼ˆå¯é€‰ï¼‰
);

// é€‚ç”¨åœºæ™¯ï¼šç½‘ç»œä¸ç¨³å®šçš„ç”Ÿäº§ç¯å¢ƒ
```

**ğŸ”¢ å›ºå®šæ¬¡æ•°é‡è¯•**
```java
// æ¯æ¬¡éƒ½ç­‰å¾…1ç§’ï¼Œæ€»å…±é‡è¯•3æ¬¡
RetryPolicy policy = new RetryNTimes(3, 1000);

// é€‚ç”¨åœºæ™¯ï¼šå¯¹å“åº”æ—¶é—´è¦æ±‚ä¸¥æ ¼çš„åœºæ™¯
```

**â° æœ‰é™æ—¶é—´å†…é‡è¯•**
```java
// åœ¨30ç§’å†…ä¸æ–­é‡è¯•ï¼Œé—´éš”1ç§’
RetryPolicy policy = new RetryUntilElapsed(30000, 1000);

// é€‚ç”¨åœºæ™¯ï¼šæœ‰æ˜ç¡®æ—¶é—´çª—å£çš„æ“ä½œ
```

### 3.3 è¿æ¥ç®¡ç†æœ€ä½³å®è·µ


```java
public class CuratorBestPractices {
    
    public CuratorFramework createOptimalClient() {
        return CuratorFrameworkFactory.builder()
            // è¿æ¥ä¸²ï¼šä½¿ç”¨å¤šä¸ªZookeeperèŠ‚ç‚¹
            .connectString("zk1:2181,zk2:2181,zk3:2181")
            
            // ä¼šè¯è¶…æ—¶ï¼šå¹³è¡¡æ£€æµ‹é€Ÿåº¦å’Œç¨³å®šæ€§
            .sessionTimeoutMs(30000)     // 30ç§’è¾ƒä¸ºåˆé€‚
            
            // è¿æ¥è¶…æ—¶ï¼šç½‘ç»œç¯å¢ƒå†³å®š
            .connectionTimeoutMs(15000)  // 15ç§’è¶³å¤Ÿ
            
            // é‡è¯•ç­–ç•¥ï¼šæŒ‡æ•°é€€é¿ï¼Œæœ€å¤šé‡è¯•3æ¬¡
            .retryPolicy(new ExponentialBackoffRetry(1000, 3))
            
            // å‘½åç©ºé—´ï¼šé¿å…ä¸åŒåº”ç”¨å†²çª
            .namespace("myapp")
            
            .build();
    }
}
```

---

## 4. ğŸ”’ åˆ†å¸ƒå¼é”å®ç°


### 4.1 åˆ†å¸ƒå¼é”åŸºæœ¬æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼é”**ï¼šåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªè¿›ç¨‹èƒ½è®¿é—®å…±äº«èµ„æºçš„æœºåˆ¶ã€‚

```
ä¼ ç»Ÿé” vs åˆ†å¸ƒå¼é”ï¼š

ä¼ ç»Ÿé”ï¼ˆå•æœºç¯å¢ƒï¼‰ï¼š
åº”ç”¨A â”€â”€â”
        â”œâ”€â”€ å…±äº«å†…å­˜ â”€â”€ synchronized/Lock
åº”ç”¨B â”€â”€â”˜

åˆ†å¸ƒå¼é”ï¼ˆåˆ†å¸ƒå¼ç¯å¢ƒï¼‰ï¼š
æœåŠ¡å™¨1 â”€â”
æœåŠ¡å™¨2 â”€â”¼â”€â”€ Zookeeperé›†ç¾¤ â”€â”€ å…¨å±€åè°ƒ
æœåŠ¡å™¨3 â”€â”˜
```

### 4.2 InterProcessMutex - å¯é‡å…¥é”


**ğŸ”¸ åŸºæœ¬ç”¨æ³•**
```java
public class DistributedLockExample {
    private CuratorFramework client;
    private InterProcessMutex lock;
    
    public void initLock() {
        // åˆ›å»ºåˆ†å¸ƒå¼é”ï¼Œé”è·¯å¾„ä¸º /locks/mylock
        lock = new InterProcessMutex(client, "/locks/mylock");
    }
    
    public void doWorkWithLock() {
        try {
            // å°è¯•è·å–é”ï¼Œæœ€å¤šç­‰å¾…10ç§’
            if (lock.acquire(10, TimeUnit.SECONDS)) {
                try {
                    // æ‰§è¡Œéœ€è¦åŒæ­¥çš„ä¸šåŠ¡é€»è¾‘
                    System.out.println("è·å¾—é”ï¼Œå¼€å§‹æ‰§è¡Œä¸šåŠ¡...");
                    Thread.sleep(5000);  // æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç†
                    System.out.println("ä¸šåŠ¡æ‰§è¡Œå®Œæˆ");
                } finally {
                    // å¿…é¡»åœ¨finallyä¸­é‡Šæ”¾é”
                    lock.release();
                    System.out.println("é”å·²é‡Šæ”¾");
                }
            } else {
                System.out.println("è·å–é”è¶…æ—¶ï¼Œæ”¾å¼ƒæ‰§è¡Œ");
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

**ğŸ”„ é”çš„å¯é‡å…¥ç‰¹æ€§**
```java
// åŒä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¤šæ¬¡è·å–åŒä¸€æŠŠé”
public void reentrantExample() {
    try {
        lock.acquire();  // ç¬¬ä¸€æ¬¡è·å–é”
        try {
            methodA();   // è°ƒç”¨å…¶ä»–æ–¹æ³•
        } finally {
            lock.release();  // é‡Šæ”¾é”
        }
    } catch (Exception e) {
        e.printStackTrace();
    }
}

public void methodA() {
    try {
        lock.acquire();  // åŒä¸€çº¿ç¨‹å†æ¬¡è·å–é”ï¼ˆå¯é‡å…¥ï¼‰
        try {
            // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
            System.out.println("åœ¨methodAä¸­æ‰§è¡Œä¸šåŠ¡");
        } finally {
            lock.release();  // é‡Šæ”¾é”
        }
    } catch (Exception e) {
        e.printStackTrace();
    }
}
```

### 4.3 InterProcessReadWriteLock - è¯»å†™é”


**è¯»å†™é”çš„ä»·å€¼**ï¼šè¯»æ“ä½œå¯ä»¥å¹¶å‘ï¼Œå†™æ“ä½œäº’æ–¥ï¼Œæé«˜å¹¶å‘æ€§èƒ½ã€‚

```java
public class ReadWriteLockExample {
    private InterProcessReadWriteLock rwLock;
    private InterProcessMutex readLock;
    private InterProcessMutex writeLock;
    
    public void initReadWriteLock() {
        rwLock = new InterProcessReadWriteLock(client, "/locks/rwlock");
        readLock = rwLock.readLock();    // è¯»é”
        writeLock = rwLock.writeLock();  // å†™é”
    }
    
    // è¯»æ“ä½œï¼šå¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è¯»
    public void readData() {
        try {
            readLock.acquire();
            try {
                System.out.println("æ­£åœ¨è¯»å–æ•°æ®...");
                // å¤šä¸ªè¯»æ“ä½œå¯ä»¥å¹¶å‘æ‰§è¡Œ
                Thread.sleep(2000);
            } finally {
                readLock.release();
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    // å†™æ“ä½œï¼šç‹¬å æ‰§è¡Œ
    public void writeData() {
        try {
            writeLock.acquire();
            try {
                System.out.println("æ­£åœ¨å†™å…¥æ•°æ®...");
                // å†™æ“ä½œæ—¶å…¶ä»–è¯»å†™éƒ½è¢«é˜»å¡
                Thread.sleep(3000);
            } finally {
                writeLock.release();
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

### 4.4 é”çš„å®ç°åŸç†


```
Zookeeperåˆ†å¸ƒå¼é”å®ç°åŸç†ï¼š

1. åˆ›å»ºä¸´æ—¶é¡ºåºèŠ‚ç‚¹ï¼š
   /locks/mylock/
   â”œâ”€â”€ 0000000001  (ç¬¬1ä¸ªå®¢æˆ·ç«¯)
   â”œâ”€â”€ 0000000002  (ç¬¬2ä¸ªå®¢æˆ·ç«¯)  
   â””â”€â”€ 0000000003  (ç¬¬3ä¸ªå®¢æˆ·ç«¯)

2. åˆ¤æ–­æ˜¯å¦è·å¾—é”ï¼š
   - åºå·æœ€å°çš„èŠ‚ç‚¹è·å¾—é”
   - å…¶ä»–èŠ‚ç‚¹ç›‘å¬å‰ä¸€ä¸ªèŠ‚ç‚¹

3. é”é‡Šæ”¾æ—¶ï¼š
   - åˆ é™¤è‡ªå·±çš„èŠ‚ç‚¹
   - ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ”¶åˆ°é€šçŸ¥ï¼Œæ£€æŸ¥æ˜¯å¦è½®åˆ°è‡ªå·±

4. å¼‚å¸¸å¤„ç†ï¼š
   - ä¸´æ—¶èŠ‚ç‚¹ç‰¹æ€§ï¼šå®¢æˆ·ç«¯æ–­å¼€è‡ªåŠ¨åˆ é™¤
   - é¿å…æ­»é”é—®é¢˜
```

---

## 5. ğŸ“‹ å¸¸ç”¨é…æ–¹æ¨¡å¼


### 5.1 Leaderé€‰ä¸¾


**åº”ç”¨åœºæ™¯**ï¼šé›†ç¾¤ä¸­éœ€è¦é€‰å‡ºä¸€ä¸ªä¸»èŠ‚ç‚¹è¿›è¡Œåè°ƒå·¥ä½œã€‚

```java
public class LeaderElectionExample {
    private LeaderSelector leaderSelector;
    private String leaderPath = "/election/leader";
    
    public void startLeaderElection() {
        leaderSelector = new LeaderSelector(client, leaderPath, 
            new LeaderSelectorListenerAdapter() {
                @Override
                public void takeLeadership(CuratorFramework client) throws Exception {
                    // æˆä¸ºLeaderåçš„å¤„ç†é€»è¾‘
                    System.out.println("æˆ‘æ˜¯Leaderï¼Œå¼€å§‹å·¥ä½œ...");
                    
                    try {
                        // æ¨¡æ‹ŸLeaderå·¥ä½œ
                        while (true) {
                            doLeaderWork();
                            Thread.sleep(5000);
                        }
                    } catch (InterruptedException e) {
                        System.out.println("Leaderå·¥ä½œè¢«ä¸­æ–­");
                    }
                }
            });
        
        // è‡ªåŠ¨é‡æ–°æ’é˜Ÿå‚ä¸é€‰ä¸¾
        leaderSelector.autoRequeue();
        leaderSelector.start();
    }
    
    private void doLeaderWork() {
        System.out.println("æ‰§è¡ŒLeaderä»»åŠ¡...");
    }
    
    public void stop() {
        leaderSelector.close();
    }
}
```

### 5.2 åˆ†å¸ƒå¼é˜Ÿåˆ—


**ğŸ”¸ FIFOé˜Ÿåˆ— - å…ˆè¿›å…ˆå‡º**
```java
public class DistributedQueueExample {
    private DistributedQueue<String> queue;
    
    public void initQueue() {
        // åˆ›å»ºåˆ†å¸ƒå¼é˜Ÿåˆ—
        queue = QueueBuilder.builder(client, new QueueConsumer<String>() {
            @Override
            public void consumeMessage(String message) throws Exception {
                // å¤„ç†é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯
                System.out.println("å¤„ç†æ¶ˆæ¯: " + message);
            }
            
            @Override
            public void stateChanged(CuratorFramework client, ConnectionState newState) {
                // å¤„ç†è¿æ¥çŠ¶æ€å˜åŒ–
            }
        }, new QueueSerializer<String>() {
            @Override
            public byte[] serialize(String item) {
                return item.getBytes();
            }
            
            @Override
            public String deserialize(byte[] bytes) {
                return new String(bytes);
            }
        }, "/queues/myqueue").buildQueue();
        
        queue.start();
    }
    
    // å‘é˜Ÿåˆ—æ·»åŠ æ¶ˆæ¯
    public void sendMessage(String message) throws Exception {
        queue.put(message);
        System.out.println("å‘é€æ¶ˆæ¯: " + message);
    }
}
```

**ğŸ”¸ ä¼˜å…ˆçº§é˜Ÿåˆ—**
```java
// å¸¦ä¼˜å…ˆçº§çš„åˆ†å¸ƒå¼é˜Ÿåˆ—
DistributedPriorityQueue<String> priorityQueue = 
    QueueBuilder.builder(client, consumer, serializer, "/priority-queue")
                .buildPriorityQueue(0);  // é»˜è®¤ä¼˜å…ˆçº§ä¸º0

// å‘é€ä¸åŒä¼˜å…ˆçº§çš„æ¶ˆæ¯
priorityQueue.put("ä½ä¼˜å…ˆçº§æ¶ˆæ¯", 1);
priorityQueue.put("é«˜ä¼˜å…ˆçº§æ¶ˆæ¯", 10);  // æ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜
priorityQueue.put("æ™®é€šæ¶ˆæ¯", 5);
```

### 5.3 åˆ†å¸ƒå¼å±éšœ


**Barrier - åŒæ­¥å±éšœ**ï¼šç­‰å¾…æ‰€æœ‰å‚ä¸è€…éƒ½åˆ°è¾¾æŸä¸ªç‚¹åï¼Œä¸€èµ·ç»§ç»­æ‰§è¡Œã€‚

```java
public class DistributedBarrierExample {
    private DistributedBarrier barrier;
    private int participantCount = 3;  // å‚ä¸è€…æ•°é‡
    
    public void initBarrier() {
        barrier = new DistributedBarrier(client, "/barriers/sync-point");
    }
    
    public void waitAtBarrier() {
        try {
            System.out.println("åˆ°è¾¾åŒæ­¥ç‚¹ï¼Œç­‰å¾…å…¶ä»–å‚ä¸è€…...");
            
            // è®¾ç½®å±éšœ
            barrier.setBarrier();
            
            // ç­‰å¾…æ‰€æœ‰å‚ä¸è€…åˆ°è¾¾
            barrier.waitOnBarrier();
            
            System.out.println("æ‰€æœ‰å‚ä¸è€…å·²åˆ°è¾¾ï¼Œç»§ç»­æ‰§è¡Œ...");
            
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    public void removeBarrier() throws Exception {
        // ç§»é™¤å±éšœï¼Œè®©æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹ç»§ç»­æ‰§è¡Œ
        barrier.removeBarrier();
    }
}
```

---

## 6. ğŸ’¼ å®è·µåº”ç”¨ç¤ºä¾‹


### 6.1 é…ç½®ä¸­å¿ƒå®ç°


```java
/**
 * åŸºäºCuratorçš„ç®€å•é…ç½®ä¸­å¿ƒ
 */
public class ConfigCenter {
    private CuratorFramework client;
    private String configPath = "/configs";
    private Map<String, String> localCache = new ConcurrentHashMap<>();
    
    public ConfigCenter(CuratorFramework client) {
        this.client = client;
        initConfigWatch();
    }
    
    // è·å–é…ç½®å€¼
    public String getConfig(String key) {
        return localCache.get(key);
    }
    
    // è®¾ç½®é…ç½®å€¼
    public void setConfig(String key, String value) throws Exception {
        String path = configPath + "/" + key;
        
        if (client.checkExists().forPath(path) != null) {
            client.setData().forPath(path, value.getBytes());
        } else {
            client.create()
                  .creatingParentsIfNeeded()
                  .forPath(path, value.getBytes());
        }
        
        // æ›´æ–°æœ¬åœ°ç¼“å­˜
        localCache.put(key, value);
    }
    
    // ç›‘å¬é…ç½®å˜åŒ–
    private void initConfigWatch() {
        try {
            // ç¡®ä¿é…ç½®æ ¹ç›®å½•å­˜åœ¨
            if (client.checkExists().forPath(configPath) == null) {
                client.create()
                      .creatingParentsIfNeeded()
                      .forPath(configPath);
            }
            
            // ç›‘å¬å­èŠ‚ç‚¹å˜åŒ–
            PathChildrenCache cache = new PathChildrenCache(
                client, configPath, true);
            
            cache.getListenable().addListener(new PathChildrenCacheListener() {
                @Override
                public void childEvent(CuratorFramework client, 
                                     PathChildrenCacheEvent event) throws Exception {
                    ChildData childData = event.getData();
                    if (childData != null) {
                        String key = childData.getPath().substring(configPath.length() + 1);
                        String value = new String(childData.getData());
                        
                        switch (event.getType()) {
                            case CHILD_ADDED:
                            case CHILD_UPDATED:
                                localCache.put(key, value);
                                System.out.println("é…ç½®æ›´æ–°: " + key + " = " + value);
                                break;
                            case CHILD_REMOVED:
                                localCache.remove(key);
                                System.out.println("é…ç½®åˆ é™¤: " + key);
                                break;
                        }
                    }
                }
            });
            
            cache.start(PathChildrenCache.StartMode.BUILD_INITIAL_CACHE);
            
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

### 6.2 æœåŠ¡å‘ç°å®ç°


```java
/**
 * åŸºäºCuratorçš„æœåŠ¡å‘ç°
 */
public class ServiceDiscovery {
    private CuratorFramework client;
    private String servicePath = "/services";
    private Map<String, List<String>> serviceInstances = new ConcurrentHashMap<>();
    
    // æ³¨å†ŒæœåŠ¡å®ä¾‹
    public void registerService(String serviceName, String instanceAddress) throws Exception {
        String path = servicePath + "/" + serviceName + "/" + instanceAddress;
        
        // åˆ›å»ºä¸´æ—¶é¡ºåºèŠ‚ç‚¹
        client.create()
              .creatingParentsIfNeeded()
              .withMode(CreateMode.EPHEMERAL_SEQUENTIAL)
              .forPath(path);
        
        System.out.println("æœåŠ¡å®ä¾‹æ³¨å†ŒæˆåŠŸ: " + serviceName + " -> " + instanceAddress);
    }
    
    // å‘ç°æœåŠ¡å®ä¾‹
    public List<String> discoverService(String serviceName) throws Exception {
        String path = servicePath + "/" + serviceName;
        
        if (client.checkExists().forPath(path) != null) {
            List<String> children = client.getChildren().forPath(path);
            return children.stream()
                          .map(child -> child.substring(0, child.lastIndexOf('-')))
                          .collect(Collectors.toList());
        }
        
        return new ArrayList<>();
    }
    
    // ç›‘å¬æœåŠ¡å˜åŒ–
    public void watchService(String serviceName, ServiceChangeListener listener) {
        String path = servicePath + "/" + serviceName;
        
        PathChildrenCache cache = new PathChildrenCache(client, path, true);
        cache.getListenable().addListener(new PathChildrenCacheListener() {
            @Override
            public void childEvent(CuratorFramework client, 
                                 PathChildrenCacheEvent event) throws Exception {
                // é€šçŸ¥æœåŠ¡å˜åŒ–
                List<String> instances = discoverService(serviceName);
                listener.onServiceChange(serviceName, instances);
            }
        });
        
        try {
            cache.start();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    public interface ServiceChangeListener {
        void onServiceChange(String serviceName, List<String> instances);
    }
}
```

---

## 7. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 7.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Curatoræœ¬è´¨ï¼šZookeeperçš„é«˜çº§å®¢æˆ·ç«¯å°è£…ï¼Œç®€åŒ–åˆ†å¸ƒå¼åº”ç”¨å¼€å‘
ğŸ”¸ æ ¸å¿ƒç»„ä»¶ï¼šCuratorFramework(æ¡†æ¶) + RetryPolicy(é‡è¯•) + Recipes(é…æ–¹)
ğŸ”¸ è¿æ¥ç®¡ç†ï¼šè‡ªåŠ¨é‡è¿ã€çŠ¶æ€ç›‘å¬ã€è¶…æ—¶æ§åˆ¶
ğŸ”¸ åˆ†å¸ƒå¼é”ï¼šäº’æ–¥é”ã€è¯»å†™é”ã€å¯é‡å…¥ç‰¹æ€§
ğŸ”¸ é…æ–¹æ¨¡å¼ï¼šLeaderé€‰ä¸¾ã€åˆ†å¸ƒå¼é˜Ÿåˆ—ã€åŒæ­¥å±éšœ
```

### 7.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¸ºä»€ä¹ˆé€‰æ‹©Curator**
```
åŸç”Ÿå®¢æˆ·ç«¯çš„ç—›ç‚¹ï¼š
- è¿æ¥ç®¡ç†å¤æ‚ï¼Œéœ€è¦å¤„ç†å„ç§å¼‚å¸¸æƒ…å†µ
- æ²¡æœ‰é‡è¯•æœºåˆ¶ï¼Œç½‘ç»œæŠ–åŠ¨å°±å¤±è´¥
- å¸¸ç”¨åŠŸèƒ½éœ€è¦é‡å¤å®ç°

Curatorçš„ä»·å€¼ï¼š
- è¿æ¥ç®¡ç†è‡ªåŠ¨åŒ–ï¼Œå¼€å‘è€…ä¸“æ³¨ä¸šåŠ¡é€»è¾‘
- å†…ç½®é‡è¯•ç­–ç•¥ï¼Œæé«˜ç³»ç»Ÿç¨³å®šæ€§
- ä¸°å¯Œçš„é…æ–¹æ¨¡å¼ï¼Œå¼€ç®±å³ç”¨
```

**ğŸ”¹ é‡è¯•ç­–ç•¥çš„é€‰æ‹©åŸåˆ™**
```
æŒ‡æ•°é€€é¿é‡è¯•ï¼š
- é€‚åˆç½‘ç»œä¸ç¨³å®šçš„ç¯å¢ƒ
- é¿å…é¢‘ç¹é‡è¯•ç»™ç³»ç»Ÿé€ æˆå‹åŠ›
- ç”Ÿäº§ç¯å¢ƒæ¨èä½¿ç”¨

å›ºå®šæ¬¡æ•°é‡è¯•ï¼š
- é€‚åˆå¯¹å“åº”æ—¶é—´æ•æ„Ÿçš„åœºæ™¯
- é‡è¯•è¡Œä¸ºå¯é¢„æœŸ
- ç®€å•åœºæ™¯ä¸‹çš„ä¸é”™é€‰æ‹©
```

**ğŸ”¹ åˆ†å¸ƒå¼é”çš„æ­£ç¡®ä½¿ç”¨**
```
ä½¿ç”¨æ¨¡å¼ï¼š
try {
    if (lock.acquire(timeout)) {
        try {
            // ä¸šåŠ¡é€»è¾‘
        } finally {
            lock.release();  // å¿…é¡»åœ¨finallyä¸­é‡Šæ”¾
        }
    }
} catch (Exception e) {
    // å¼‚å¸¸å¤„ç†
}

æ³¨æ„äº‹é¡¹ï¼š
- è·å–é”è¦è®¾ç½®è¶…æ—¶æ—¶é—´
- å¿…é¡»åœ¨finallyå—ä¸­é‡Šæ”¾é”
- å¤„ç†è·å–é”å¤±è´¥çš„æƒ…å†µ
```

### 7.3 å®é™…åº”ç”¨å»ºè®®


**ğŸ¯ ç”Ÿäº§ç¯å¢ƒé…ç½®**
```java
// æ¨èçš„ç”Ÿäº§ç¯å¢ƒé…ç½®
CuratorFramework client = CuratorFrameworkFactory.builder()
    .connectString("zk1:2181,zk2:2181,zk3:2181")  // å¤šèŠ‚ç‚¹
    .sessionTimeoutMs(30000)                       // 30ç§’ä¼šè¯è¶…æ—¶
    .connectionTimeoutMs(15000)                    // 15ç§’è¿æ¥è¶…æ—¶
    .retryPolicy(new ExponentialBackoffRetry(1000, 3))  // æŒ‡æ•°é€€é¿é‡è¯•
    .namespace("myapp")                            // å‘½åç©ºé—´éš”ç¦»
    .build();
```

**ğŸ“Š å¸¸è§åº”ç”¨åœºæ™¯**
- **é…ç½®ä¸­å¿ƒ**ï¼šç»Ÿä¸€ç®¡ç†åº”ç”¨é…ç½®ï¼Œæ”¯æŒåŠ¨æ€æ›´æ–°
- **æœåŠ¡å‘ç°**ï¼šè‡ªåŠ¨å‘ç°å’Œæ³¨å†ŒæœåŠ¡å®ä¾‹
- **åˆ†å¸ƒå¼é”**ï¼šä¿è¯åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„æ•°æ®ä¸€è‡´æ€§
- **Leaderé€‰ä¸¾**ï¼šé›†ç¾¤ä¸­é€‰å‡ºä¸»èŠ‚ç‚¹è¿›è¡Œåè°ƒ
- **ä»»åŠ¡åˆ†å‘**ï¼šä½¿ç”¨åˆ†å¸ƒå¼é˜Ÿåˆ—è¿›è¡Œä»»åŠ¡è°ƒåº¦

**âš ï¸ ä½¿ç”¨æ³¨æ„äº‹é¡¹**
```
æ€§èƒ½è€ƒè™‘ï¼š
- Curatoræ¯”åŸç”Ÿå®¢æˆ·ç«¯æœ‰ä¸€å®šæ€§èƒ½å¼€é”€
- å¤§é‡å¹¶å‘æ“ä½œæ—¶è¦æ³¨æ„è¿æ¥æ± é…ç½®
- åˆç†è®¾ç½®é‡è¯•å‚æ•°ï¼Œé¿å…è¿‡åº¦é‡è¯•

å¼‚å¸¸å¤„ç†ï¼š
- è¦å¤„ç†è¿æ¥æ–­å¼€çš„æƒ…å†µ
- åˆ†å¸ƒå¼é”è·å–å¤±è´¥çš„é™çº§å¤„ç†
- ç›‘å¬å™¨ä¸­çš„å¼‚å¸¸ä¸èƒ½å½±å“ä¸»æµç¨‹
```

### 7.4 å­¦ä¹ å»ºè®®


```
å­¦ä¹ è·¯å¾„ï¼š
1ï¸âƒ£ æŒæ¡åŸºæœ¬çš„è¿æ¥ç®¡ç†å’ŒCRUDæ“ä½œ
2ï¸âƒ£ ç†è§£é‡è¯•ç­–ç•¥çš„å·¥ä½œæœºåˆ¶
3ï¸âƒ£ ç†Ÿç»ƒä½¿ç”¨åˆ†å¸ƒå¼é”è§£å†³å¹¶å‘é—®é¢˜
4ï¸âƒ£ å­¦ä¹ é…æ–¹æ¨¡å¼è§£å†³åˆ†å¸ƒå¼åè°ƒé—®é¢˜
5ï¸âƒ£ ç»“åˆå®é™…é¡¹ç›®è¿›è¡Œç»¼åˆåº”ç”¨

å®è·µå»ºè®®ï¼š
- å…ˆåœ¨å•æœºç¯å¢ƒæ­å»ºZookeeperé›†ç¾¤ç»ƒä¹ 
- ç”¨åˆ†å¸ƒå¼é”å®ç°ä¸€ä¸ªç®€å•çš„è®¡æ•°å™¨
- å°è¯•å®ç°é…ç½®ä¸­å¿ƒå’ŒæœåŠ¡å‘ç°
- å¯¹æ¯”Curatorå’ŒåŸç”Ÿå®¢æˆ·ç«¯çš„å·®å¼‚
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- Curatorå°è£…åŸç”Ÿå¤æ‚ï¼Œè¿æ¥é‡è¯•éƒ½å¸®ä½ æ
- åˆ†å¸ƒå¼é”é…æ–¹æ¨¡å¼ï¼Œå¼€ç®±å³ç”¨å¾ˆé«˜æ•ˆ  
- ç”Ÿäº§ç¯å¢ƒå¿…å¤‡å·¥å…·ï¼Œç¨³å®šå¯é æœ‰ä¿éšœ
- æŒæ¡æ ¸å¿ƒå‡ ä¸ªç»„ä»¶ï¼Œåˆ†å¸ƒå¼åè°ƒä¸ç”¨æ„