---
title: 8ã€åˆ†å¸ƒå¼é”å®ç°
---
## ğŸ“š ç›®å½•

1. [åˆ†å¸ƒå¼é”åŸºç¡€æ¦‚å¿µ](#1-åˆ†å¸ƒå¼é”åŸºç¡€æ¦‚å¿µ)
2. [InterProcessMutexäº’æ–¥é”](#2-InterProcessMutexäº’æ–¥é”)
3. [å¯é‡å…¥é”æœºåˆ¶](#3-å¯é‡å…¥é”æœºåˆ¶)
4. [åˆ†å¸ƒå¼è¯»å†™é”](#4-åˆ†å¸ƒå¼è¯»å†™é”)
5. [ä¿¡å·é‡æ§åˆ¶](#5-ä¿¡å·é‡æ§åˆ¶)
6. [æ …æ åŒæ­¥æœºåˆ¶](#6-æ …æ åŒæ­¥æœºåˆ¶)
7. [åˆ†å¸ƒå¼é”å®ç°åŸç†](#7-åˆ†å¸ƒå¼é”å®ç°åŸç†)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” åˆ†å¸ƒå¼é”åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼é”


**ğŸ¯ é€šä¿—ç†è§£**ï¼š
åˆ†å¸ƒå¼é”å°±åƒæ˜¯å¤šä¸ªäººè¦æŠ¢å¤ºä¸€æŠŠé’¥åŒ™ï¼Œåªæœ‰æ‹¿åˆ°é’¥åŒ™çš„äººæ‰èƒ½è¿›å…¥æˆ¿é—´å¹²æ´»ï¼Œå¹²å®Œæ´»åå¿…é¡»æŠŠé’¥åŒ™è¿˜å›å»ï¼Œè®©å…¶ä»–äººæœ‰æœºä¼šæ‹¿åˆ°ã€‚

```
å•æœºç¯å¢ƒçš„é”ï¼š
çº¿ç¨‹A ---> æŠ¢å¤ºå†…å­˜ä¸­çš„é” <--- çº¿ç¨‹B
         (åœ¨åŒä¸€å°æœºå™¨ä¸Š)

åˆ†å¸ƒå¼ç¯å¢ƒçš„é”ï¼š
æœåŠ¡å™¨A ---> æŠ¢å¤ºZookeeperä¸­çš„é” <--- æœåŠ¡å™¨B
          (è·¨ç½‘ç»œçš„ä¸åŒæœºå™¨)
```

**ğŸ“ æ ¸å¿ƒä½œç”¨**ï¼š
- **äº’æ–¥æ€§**ï¼šåŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹èƒ½è·å–é”
- **é˜²æ­¢é‡å¤**ï¼šé¿å…åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„é‡å¤æ“ä½œ
- **æ•°æ®ä¸€è‡´æ€§**ï¼šä¿è¯å…±äº«èµ„æºçš„å®‰å…¨è®¿é—®

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”


**ğŸ’¼ å®é™…åœºæ™¯ä¸¾ä¾‹**ï¼š

**åœºæ™¯1ï¼šè®¢å•ç”Ÿæˆ**
```
ç”¨æˆ·ä¸‹å• â†’ å¤šä¸ªæœåŠ¡å™¨åŒæ—¶å¤„ç†
é—®é¢˜ï¼šå¯èƒ½ç”Ÿæˆé‡å¤è®¢å•
è§£å†³ï¼šç”¨åˆ†å¸ƒå¼é”ä¿è¯åªæœ‰ä¸€å°æœåŠ¡å™¨å¤„ç†
```

**åœºæ™¯2ï¼šåº“å­˜æ‰£å‡**
```
å•†å“åªå‰©1ä»¶ â†’ å¤šä¸ªç”¨æˆ·åŒæ—¶è´­ä¹°
é—®é¢˜ï¼šå¯èƒ½å‡ºç°è¶…å–æƒ…å†µ
è§£å†³ï¼šç”¨åˆ†å¸ƒå¼é”ä¸²è¡Œå¤„ç†åº“å­˜æ“ä½œ
```

**åœºæ™¯3ï¼šå®šæ—¶ä»»åŠ¡**
```
æ¯å¤©å‡Œæ™¨æ‰§è¡Œæ•°æ®ç»Ÿè®¡ â†’ å¤šä¸ªæœåŠ¡å™¨éƒ½éƒ¨ç½²äº†ä»»åŠ¡
é—®é¢˜ï¼šä»»åŠ¡é‡å¤æ‰§è¡Œï¼Œæµªè´¹èµ„æº
è§£å†³ï¼šç”¨åˆ†å¸ƒå¼é”ä¿è¯åªæœ‰ä¸€å°æœåŠ¡å™¨æ‰§è¡Œ
```

### 1.3 åˆ†å¸ƒå¼é”çš„å®ç°æ–¹å¼å¯¹æ¯”


| å®ç°æ–¹å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|---------|------|------|----------|
| **Database** | å®ç°ç®€å• | æ€§èƒ½è¾ƒå·®ï¼Œå•ç‚¹æ•…éšœ | å°è§„æ¨¡ç³»ç»Ÿ |
| **Redis** | æ€§èƒ½å¥½ï¼Œæ”¯æŒè¿‡æœŸ | å¯èƒ½ä¸¢å¤±é”ï¼Œå¤æ‚åœºæ™¯å¤„ç†éš¾ | é«˜æ€§èƒ½è¦æ±‚ |
| **Zookeeper** | å¯é æ€§é«˜ï¼Œæ”¯æŒå¤æ‚åœºæ™¯ | æ€§èƒ½ç›¸å¯¹è¾ƒä½ | å¼ºä¸€è‡´æ€§è¦æ±‚ |

**ğŸ¯ Zookeeperçš„ä¼˜åŠ¿**ï¼š
- **å¼ºä¸€è‡´æ€§**ï¼šåŸºäºZABåè®®ï¼Œæ•°æ®ä¸€è‡´æ€§æœ‰ä¿éšœ
- **ä¸´æ—¶èŠ‚ç‚¹**ï¼šå®¢æˆ·ç«¯æ–­å¼€è‡ªåŠ¨é‡Šæ”¾é”ï¼Œé¿å…æ­»é”
- **äº‹ä»¶é€šçŸ¥**ï¼šæ”¯æŒé”ç­‰å¾…å’Œé€šçŸ¥æœºåˆ¶
- **æœ‰åºèŠ‚ç‚¹**ï¼šå¤©ç„¶æ”¯æŒå…¬å¹³é”çš„å®ç°

---

## 2. ğŸ”’ InterProcessMutexäº’æ–¥é”


### 2.1 InterProcessMutexåŸºæœ¬æ¦‚å¿µ


**ğŸ“– ä»€ä¹ˆæ˜¯InterProcessMutex**ï¼š
InterProcessMutexæ˜¯Curatoræ¡†æ¶æä¾›çš„åˆ†å¸ƒå¼äº’æ–¥é”ï¼Œ`InterProcess`æ„æ€æ˜¯"è¿›ç¨‹é—´"ï¼Œ`Mutex`æ„æ€æ˜¯"äº’æ–¥"ã€‚ç®€å•è¯´å°±æ˜¯è®©ä¸åŒæœåŠ¡å™¨ä¸Šçš„ç¨‹åºèƒ½å¤Ÿç›¸äº’æ’æ–¥åœ°ä½¿ç”¨åŒä¸€ä¸ªèµ„æºã€‚

**ğŸ”‘ æ ¸å¿ƒç‰¹ç‚¹**ï¼š
- **äº’æ–¥æ€§**ï¼šåŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯èƒ½æŒæœ‰é”
- **å¯é‡å…¥**ï¼šåŒä¸€ä¸ªå®¢æˆ·ç«¯å¯ä»¥å¤šæ¬¡è·å–åŒä¸€æŠŠé”
- **è‡ªåŠ¨é‡Šæ”¾**ï¼šå®¢æˆ·ç«¯æ–­å¼€è¿æ¥åè‡ªåŠ¨é‡Šæ”¾é”
- **å…¬å¹³æ€§**ï¼šæŒ‰ç…§è¯·æ±‚é¡ºåºåˆ†é…é”

### 2.2 åŸºæœ¬ä½¿ç”¨ç¤ºä¾‹


```java
// 1. åˆ›å»ºåˆ†å¸ƒå¼é”
public class DistributedLockExample {
    private CuratorFramework client;
    private InterProcessMutex lock;
    
    public void initLock() {
        // åˆ›å»ºZookeeperå®¢æˆ·ç«¯
        client = CuratorFrameworkFactory.newClient(
            "localhost:2181", 
            new ExponentialBackoffRetry(1000, 3)
        );
        client.start();
        
        // åˆ›å»ºåˆ†å¸ƒå¼é”ï¼Œè·¯å¾„æ˜¯é”çš„æ ‡è¯†
        lock = new InterProcessMutex(client, "/myapp/locks/order");
    }
    
    // 2. ä½¿ç”¨åˆ†å¸ƒå¼é”
    public void processOrder() {
        try {
            // è·å–é”ï¼Œæœ€å¤šç­‰å¾…10ç§’
            if (lock.acquire(10, TimeUnit.SECONDS)) {
                System.out.println("è·å–é”æˆåŠŸï¼Œå¼€å§‹å¤„ç†è®¢å•...");
                
                // è¿™é‡Œæ”¾ä½ çš„ä¸šåŠ¡é€»è¾‘
                Thread.sleep(5000); // æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç†
                
                System.out.println("è®¢å•å¤„ç†å®Œæˆ");
            } else {
                System.out.println("è·å–é”è¶…æ—¶ï¼Œæ”¾å¼ƒå¤„ç†");
            }
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            try {
                // ä¸€å®šè¦é‡Šæ”¾é”ï¼
                lock.release();
                System.out.println("é”å·²é‡Šæ”¾");
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }
}
```

**ğŸ’¡ ä»£ç è§£é‡Š**ï¼š
- `/myapp/locks/order`ï¼šé”çš„è·¯å¾„ï¼Œç›¸å½“äºé”çš„åå­—
- `acquire(10, TimeUnit.SECONDS)`ï¼šå°è¯•è·å–é”ï¼Œæœ€å¤šç­‰10ç§’
- `release()`ï¼šé‡Šæ”¾é”ï¼Œå¿…é¡»åœ¨finallyå—ä¸­æ‰§è¡Œ

### 2.3 å®é™…åº”ç”¨åœºæ™¯


**ğŸ¯ é˜²æ­¢è®¢å•é‡å¤ç”Ÿæˆ**ï¼š

```java
@Service
public class OrderService {
    private InterProcessMutex orderLock;
    
    public String createOrder(String userId, String productId) {
        // ç”¨ç”¨æˆ·IDå’Œå•†å“IDç»„æˆé”çš„è·¯å¾„ï¼Œç¡®ä¿åŒä¸€ç”¨æˆ·åŒä¸€å•†å“ä¸ä¼šé‡å¤ä¸‹å•
        String lockPath = "/locks/order/" + userId + "_" + productId;
        InterProcessMutex lock = new InterProcessMutex(client, lockPath);
        
        try {
            if (lock.acquire(5, TimeUnit.SECONDS)) {
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è®¢å•
                if (existsOrder(userId, productId)) {
                    return "è®¢å•å·²å­˜åœ¨ï¼Œæ— éœ€é‡å¤åˆ›å»º";
                }
                
                // åˆ›å»ºæ–°è®¢å•
                String orderId = generateOrderId();
                saveOrder(orderId, userId, productId);
                return "è®¢å•åˆ›å»ºæˆåŠŸï¼š" + orderId;
            } else {
                return "ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•";
            }
        } catch (Exception e) {
            return "åˆ›å»ºè®¢å•å¤±è´¥ï¼š" + e.getMessage();
        } finally {
            try {
                lock.release();
            } catch (Exception e) {
                // è®°å½•æ—¥å¿—
            }
        }
    }
}
```

### 2.4 ä½¿ç”¨æ³¨æ„äº‹é¡¹


**âš ï¸ é‡è¦æé†’**ï¼š

```
âœ… æ­£ç¡®åšæ³•ï¼š
1. æ€»æ˜¯åœ¨finallyå—ä¸­é‡Šæ”¾é”
2. è®¾ç½®åˆç†çš„ç­‰å¾…è¶…æ—¶æ—¶é—´
3. å¤„ç†è·å–é”å¤±è´¥çš„æƒ…å†µ
4. é”çš„ç²’åº¦è¦åˆé€‚

âŒ å¸¸è§é”™è¯¯ï¼š
1. å¿˜è®°é‡Šæ”¾é”å¯¼è‡´æ­»é”
2. è®¾ç½®è¶…æ—¶æ—¶é—´è¿‡é•¿é˜»å¡å…¶ä»–çº¿ç¨‹
3. é”çš„ç²’åº¦è¿‡ç²—å½±å“æ€§èƒ½
4. æ²¡æœ‰å¤„ç†å¼‚å¸¸æƒ…å†µ
```

---

## 3. ğŸ”„ å¯é‡å…¥é”æœºåˆ¶


### 3.1 ä»€ä¹ˆæ˜¯å¯é‡å…¥é”


**ğŸ¤” é€šä¿—è§£é‡Š**ï¼š
å¯é‡å…¥é”å°±åƒæ˜¯ä½ å®¶çš„é—¨é”ï¼Œä½ ç”¨é’¥åŒ™å¼€é—¨è¿›å…¥åï¼Œå¦‚æœä½ æƒ³ä»é‡Œé¢å†å¼€åŒä¸€é“é—¨ï¼ˆæ¯”å¦‚å‡ºå»æ‹¿ä¸ªä¸œè¥¿å†è¿›æ¥ï¼‰ï¼Œä½ ä¸éœ€è¦é‡æ–°æ‰¾é’¥åŒ™ï¼Œå› ä¸ºä½ å·²ç»åœ¨æˆ¿å­é‡Œäº†ã€‚

**ğŸ“Š å¯é‡å…¥é” vs ä¸å¯é‡å…¥é”**ï¼š

```
ä¸å¯é‡å…¥é”çš„é—®é¢˜ï¼š
æ–¹æ³•Aè·å–é” â†’ è°ƒç”¨æ–¹æ³•B â†’ æ–¹æ³•Bä¹Ÿè¦è·å–åŒä¸€æŠŠé” â†’ æ­»é”ï¼

å¯é‡å…¥é”çš„è§£å†³ï¼š
æ–¹æ³•Aè·å–é” â†’ è°ƒç”¨æ–¹æ³•B â†’ æ–¹æ³•Bå‘ç°æ˜¯åŒä¸€çº¿ç¨‹ â†’ ç›´æ¥é€šè¿‡
```

### 3.2 InterProcessMutexçš„å¯é‡å…¥æ€§


**ğŸ”‘ é‡å…¥æœºåˆ¶åŸç†**ï¼š
InterProcessMutexä¼šè®°å½•æŒæœ‰é”çš„çº¿ç¨‹ä¿¡æ¯ï¼Œå½“åŒä¸€ä¸ªçº¿ç¨‹å†æ¬¡è¯·æ±‚åŒä¸€æŠŠé”æ—¶ï¼Œä¼šå¢åŠ é‡å…¥è®¡æ•°å™¨ï¼Œè€Œä¸æ˜¯é˜»å¡ç­‰å¾…ã€‚

```java
public class ReentrantLockExample {
    private InterProcessMutex lock;
    
    public void method1() throws Exception {
        if (lock.acquire(10, TimeUnit.SECONDS)) {
            try {
                System.out.println("æ–¹æ³•1è·å–é”æˆåŠŸ");
                
                // è°ƒç”¨æ–¹æ³•2ï¼Œæ–¹æ³•2ä¹Ÿéœ€è¦åŒä¸€æŠŠé”
                method2();
                
            } finally {
                lock.release();
                System.out.println("æ–¹æ³•1é‡Šæ”¾é”");
            }
        }
    }
    
    public void method2() throws Exception {
        if (lock.acquire(10, TimeUnit.SECONDS)) {
            try {
                System.out.println("æ–¹æ³•2è·å–é”æˆåŠŸï¼ˆå¯é‡å…¥ï¼‰");
                // ä¸šåŠ¡é€»è¾‘
                Thread.sleep(1000);
            } finally {
                lock.release();
                System.out.println("æ–¹æ³•2é‡Šæ”¾é”");
            }
        }
    }
}
```

**ğŸ“‹ æ‰§è¡Œç»“æœ**ï¼š
```
æ–¹æ³•1è·å–é”æˆåŠŸ
æ–¹æ³•2è·å–é”æˆåŠŸï¼ˆå¯é‡å…¥ï¼‰
æ–¹æ³•2é‡Šæ”¾é”
æ–¹æ³•1é‡Šæ”¾é”
```

### 3.3 é‡å…¥è®¡æ•°å™¨åŸç†


**ğŸ”¢ å†…éƒ¨è®¡æ•°æœºåˆ¶**ï¼š

```
ç¬¬ä¸€æ¬¡è·å–é”ï¼šé‡å…¥è®¡æ•° = 1
ç¬¬äºŒæ¬¡è·å–é”ï¼šé‡å…¥è®¡æ•° = 2  (å¯é‡å…¥)
ç¬¬ä¸‰æ¬¡è·å–é”ï¼šé‡å…¥è®¡æ•° = 3  (å¯é‡å…¥)

ç¬¬ä¸€æ¬¡é‡Šæ”¾é”ï¼šé‡å…¥è®¡æ•° = 2  (é”ä»è¢«æŒæœ‰)
ç¬¬äºŒæ¬¡é‡Šæ”¾é”ï¼šé‡å…¥è®¡æ•° = 1  (é”ä»è¢«æŒæœ‰)
ç¬¬ä¸‰æ¬¡é‡Šæ”¾é”ï¼šé‡å…¥è®¡æ•° = 0  (é”å®Œå…¨é‡Šæ”¾)
```

**ğŸ’¡ é‡è¦æé†’**ï¼š
acquire()å’Œrelease()è°ƒç”¨å¿…é¡»æˆå¯¹å‡ºç°ï¼Œè·å–äº†å‡ æ¬¡é”å°±å¿…é¡»é‡Šæ”¾å‡ æ¬¡é”ã€‚

---

## 4. ğŸ“– åˆ†å¸ƒå¼è¯»å†™é”


### 4.1 è¯»å†™é”åŸºæœ¬æ¦‚å¿µ


**ğŸ“š ä»€ä¹ˆæ˜¯è¯»å†™é”**ï¼š
è¯»å†™é”å°±åƒå›¾ä¹¦é¦†çš„é˜…è¯»è§„åˆ™ï¼šå¤šä¸ªäººå¯ä»¥åŒæ—¶çœ‹åŒä¸€æœ¬ä¹¦ï¼ˆè¯»æ“ä½œï¼‰ï¼Œä½†æ˜¯åªèƒ½æœ‰ä¸€ä¸ªäººåœ¨ä¹¦ä¸Šå†™ç¬”è®°ï¼ˆå†™æ“ä½œï¼‰ï¼Œè€Œä¸”å†™ç¬”è®°çš„æ—¶å€™å…¶ä»–äººéƒ½ä¸èƒ½çœ‹è¿™æœ¬ä¹¦ã€‚

**ğŸ“Š è¯»å†™é”çš„è§„åˆ™**ï¼š
```
è¯»é”ä¸è¯»é”ï¼šâœ… å¯ä»¥å…±å­˜ (å¤šäººåŒæ—¶è¯»)
è¯»é”ä¸å†™é”ï¼šâŒ ä¸èƒ½å…±å­˜ (è¯»æ—¶ä¸èƒ½å†™)
å†™é”ä¸è¯»é”ï¼šâŒ ä¸èƒ½å…±å­˜ (å†™æ—¶ä¸èƒ½è¯»)  
å†™é”ä¸å†™é”ï¼šâŒ ä¸èƒ½å…±å­˜ (å†™æ—¶ä¸èƒ½å†™)
```

### 4.2 InterProcessReadWriteLockä½¿ç”¨


```java
public class ReadWriteLockExample {
    private CuratorFramework client;
    private InterProcessReadWriteLock rwLock;
    private InterProcessMutex readLock;
    private InterProcessMutex writeLock;
    
    public void initReadWriteLock() {
        // åˆ›å»ºè¯»å†™é”
        rwLock = new InterProcessReadWriteLock(client, "/locks/data");
        readLock = rwLock.readLock();   // è¯»é”
        writeLock = rwLock.writeLock(); // å†™é”
    }
    
    // è¯»æ•°æ®æ“ä½œ
    public String readData() {
        try {
            if (readLock.acquire(10, TimeUnit.SECONDS)) {
                System.out.println("è·å–è¯»é”æˆåŠŸï¼Œå¼€å§‹è¯»å–æ•°æ®...");
                
                // æ¨¡æ‹Ÿè¯»å–æ•°æ®
                String data = loadDataFromDatabase();
                Thread.sleep(2000); // æ¨¡æ‹Ÿè¯»å–è€—æ—¶
                
                System.out.println("æ•°æ®è¯»å–å®Œæˆ: " + data);
                return data;
            }
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            try {
                readLock.release();
                System.out.println("è¯»é”é‡Šæ”¾");
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
        return null;
    }
    
    // å†™æ•°æ®æ“ä½œ
    public void writeData(String newData) {
        try {
            if (writeLock.acquire(10, TimeUnit.SECONDS)) {
                System.out.println("è·å–å†™é”æˆåŠŸï¼Œå¼€å§‹å†™å…¥æ•°æ®...");
                
                // æ¨¡æ‹Ÿå†™å…¥æ•°æ®
                saveDataToDatabase(newData);
                Thread.sleep(3000); // æ¨¡æ‹Ÿå†™å…¥è€—æ—¶
                
                System.out.println("æ•°æ®å†™å…¥å®Œæˆ: " + newData);
            }
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            try {
                writeLock.release();
                System.out.println("å†™é”é‡Šæ”¾");
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }
}
```

### 4.3 è¯»å†™é”çš„åº”ç”¨åœºæ™¯


**ğŸ¯ é…ç½®æ–‡ä»¶ç®¡ç†**ï¼š

```java
@Service
public class ConfigService {
    private InterProcessReadWriteLock configLock;
    private Map<String, String> configCache = new HashMap<>();
    
    // è¯»å–é…ç½®ï¼ˆå¤šä¸ªæœåŠ¡å™¨å¯ä»¥åŒæ—¶è¯»ï¼‰
    public String getConfig(String key) {
        InterProcessMutex readLock = configLock.readLock();
        try {
            if (readLock.acquire(5, TimeUnit.SECONDS)) {
                // ä»ç¼“å­˜æˆ–æ•°æ®åº“è¯»å–é…ç½®
                return configCache.get(key);
            }
        } catch (Exception e) {
            // å¤„ç†å¼‚å¸¸
        } finally {
            try {
                readLock.release();
            } catch (Exception e) {}
        }
        return null;
    }
    
    // æ›´æ–°é…ç½®ï¼ˆåŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªæœåŠ¡å™¨æ›´æ–°ï¼‰
    public void updateConfig(String key, String value) {
        InterProcessMutex writeLock = configLock.writeLock();
        try {
            if (writeLock.acquire(10, TimeUnit.SECONDS)) {
                // æ›´æ–°æ•°æ®åº“
                updateConfigInDatabase(key, value);
                // æ›´æ–°ç¼“å­˜
                configCache.put(key, value);
                // é€šçŸ¥å…¶ä»–æœåŠ¡å™¨åˆ·æ–°ç¼“å­˜
                notifyConfigChange(key, value);
            }
        } catch (Exception e) {
            // å¤„ç†å¼‚å¸¸
        } finally {
            try {
                writeLock.release();
            } catch (Exception e) {}
        }
    }
}
```

**ğŸ“ˆ æ€§èƒ½ä¼˜åŠ¿**ï¼š
- **è¯»å¤šå†™å°‘åœºæ™¯**ï¼šå¤šä¸ªè¯»æ“ä½œå¯ä»¥å¹¶å‘æ‰§è¡Œï¼Œæé«˜ç³»ç»Ÿååé‡
- **æ•°æ®ä¸€è‡´æ€§**ï¼šå†™æ“ä½œæ—¶ç¡®ä¿æ•°æ®çš„å®Œæ•´æ€§
- **é¿å…è¯»è„æ•°æ®**ï¼šè¯»å†™äº’æ–¥ä¿è¯æ•°æ®ä¸€è‡´æ€§

---

## 5. ğŸš¦ ä¿¡å·é‡æ§åˆ¶


### 5.1 ä¿¡å·é‡åŸºæœ¬æ¦‚å¿µ


**ğŸ« é€šä¿—ç†è§£**ï¼š
ä¿¡å·é‡å°±åƒæ˜¯ç”µå½±é™¢çš„ç¥¨ï¼Œæ€»å…±æœ‰100å¼ ç¥¨ï¼ˆä¿¡å·é‡å€¼ä¸º100ï¼‰ï¼Œæ¯ä¸ªäººè¿›åœºéœ€è¦ä¸€å¼ ç¥¨ï¼Œçœ‹å®Œç”µå½±é€€åœºæ—¶è¦æŠŠç¥¨é€€å›å»ã€‚å½“ç¥¨ç”¨å®Œæ—¶ï¼Œåæ¥çš„äººå°±è¦ç­‰åˆ«äººçœ‹å®Œç”µå½±é€€ç¥¨æ‰èƒ½è¿›åœºã€‚

**ğŸ”¢ ä¿¡å·é‡ vs äº’æ–¥é”**ï¼š
```
äº’æ–¥é”ï¼šåªæœ‰1æŠŠé’¥åŒ™ï¼ŒåŒæ—¶åªèƒ½1ä¸ªäººä½¿ç”¨
ä¿¡å·é‡ï¼šæœ‰NæŠŠé’¥åŒ™ï¼ŒåŒæ—¶å¯ä»¥Nä¸ªäººä½¿ç”¨
```

### 5.2 InterProcessSemaphoreV2ä½¿ç”¨


```java
public class SemaphoreExample {
    private CuratorFramework client;
    private InterProcessSemaphoreV2 semaphore;
    
    public void initSemaphore() {
        // åˆ›å»ºä¿¡å·é‡ï¼Œæœ€å¤šå…è®¸3ä¸ªå®¢æˆ·ç«¯åŒæ—¶è®¿é—®
        semaphore = new InterProcessSemaphoreV2(client, "/semaphores/database", 3);
    }
    
    public void accessDatabase() {
        Lease lease = null;
        try {
            // è·å–ä¿¡å·é‡è®¸å¯ï¼Œæœ€å¤šç­‰å¾…10ç§’
            lease = semaphore.acquire(10, TimeUnit.SECONDS);
            
            if (lease != null) {
                System.out.println("è·å–ä¿¡å·é‡æˆåŠŸï¼Œå¼€å§‹è®¿é—®æ•°æ®åº“...");
                
                // æ¨¡æ‹Ÿæ•°æ®åº“è®¿é—®
                Thread.sleep(5000);
                
                System.out.println("æ•°æ®åº“è®¿é—®å®Œæˆ");
            } else {
                System.out.println("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•");
            }
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            if (lease != null) {
                try {
                    // é‡Šæ”¾ä¿¡å·é‡è®¸å¯
                    semaphore.returnLease(lease);
                    System.out.println("ä¿¡å·é‡è®¸å¯å·²å½’è¿˜");
                } catch (Exception e) {
                    e.printStackTrace();
                }
            }
        }
    }
}
```

### 5.3 ä¿¡å·é‡çš„å®é™…åº”ç”¨


**ğŸ¯ æ•°æ®åº“è¿æ¥æ± æ§åˆ¶**ï¼š

```java
@Service
public class DatabaseService {
    private InterProcessSemaphoreV2 dbSemaphore;
    private static final int MAX_CONNECTIONS = 10;
    
    public void initService() {
        // é™åˆ¶æ•´ä¸ªé›†ç¾¤æœ€å¤š10ä¸ªæ•°æ®åº“è¿æ¥
        dbSemaphore = new InterProcessSemaphoreV2(
            client, 
            "/semaphores/db-connections", 
            MAX_CONNECTIONS
        );
    }
    
    public void executeQuery(String sql) {
        Lease lease = null;
        Connection conn = null;
        
        try {
            // è·å–æ•°æ®åº“è¿æ¥è®¸å¯
            lease = dbSemaphore.acquire(5, TimeUnit.SECONDS);
            
            if (lease != null) {
                // è·å–å®é™…çš„æ•°æ®åº“è¿æ¥
                conn = getConnection();
                
                // æ‰§è¡ŒSQLæŸ¥è¯¢
                ResultSet rs = conn.createStatement().executeQuery(sql);
                
                // å¤„ç†ç»“æœ
                processResult(rs);
                
            } else {
                throw new RuntimeException("æ•°æ®åº“ç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
            }
            
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            // é‡Šæ”¾æ•°æ®åº“è¿æ¥
            if (conn != null) {
                try {
                    conn.close();
                } catch (SQLException e) {}
            }
            
            // é‡Šæ”¾ä¿¡å·é‡è®¸å¯
            if (lease != null) {
                try {
                    dbSemaphore.returnLease(lease);
                } catch (Exception e) {}
            }
        }
    }
}
```

**ğŸ“Š é™æµåº”ç”¨åœºæ™¯**ï¼š

| åº”ç”¨åœºæ™¯ | ä¿¡å·é‡å€¼ | è¯´æ˜ |
|---------|---------|------|
| **APIé™æµ** | 1000/åˆ†é’Ÿ | é˜²æ­¢æ¥å£è¢«æ¶æ„è°ƒç”¨ |
| **æ–‡ä»¶ä¸‹è½½** | 50ä¸ªè¿æ¥ | é™åˆ¶åŒæ—¶ä¸‹è½½æ–‡ä»¶çš„æ•°é‡ |
| **æ‰¹é‡å¤„ç†** | 5ä¸ªä»»åŠ¡ | æ§åˆ¶åŒæ—¶æ‰§è¡Œçš„æ‰¹é‡ä»»åŠ¡æ•° |
| **æ•°æ®åº“è¿æ¥** | 100ä¸ªè¿æ¥ | é˜²æ­¢è¿æ¥æ± è€—å°½ |

### 5.4 ä¿¡å·é‡ä½¿ç”¨æ³¨æ„äº‹é¡¹


**âš ï¸ é‡è¦æé†’**ï¼š
```
âœ… æ­£ç¡®åšæ³•ï¼š
1. è·å–åˆ°leaseåä¸€å®šè¦é‡Šæ”¾
2. è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
3. ä¿¡å·é‡å€¼è¦æ ¹æ®ç³»ç»Ÿè´Ÿè½½èƒ½åŠ›è®¾ç½®
4. å¤„ç†è·å–å¤±è´¥çš„æƒ…å†µ

âŒ å¸¸è§é”™è¯¯ï¼š
1. å¿˜è®°é‡Šæ”¾leaseå¯¼è‡´èµ„æºæ³„éœ²
2. ä¿¡å·é‡å€¼è®¾ç½®è¿‡å¤§å¯¼è‡´ç³»ç»Ÿè¿‡è½½
3. è¶…æ—¶æ—¶é—´è¿‡é•¿å½±å“ç”¨æˆ·ä½“éªŒ
4. æ²¡æœ‰å¤„ç†å¼‚å¸¸æƒ…å†µ
```

---

## 6. ğŸš§ æ …æ åŒæ­¥æœºåˆ¶


### 6.1 æ …æ åŒæ­¥åŸºæœ¬æ¦‚å¿µ


**ğŸƒâ€â™‚ï¸ é€šä¿—ç†è§£**ï¼š
æ …æ åŒæ­¥å°±åƒæ˜¯é©¬æ‹‰æ¾æ¯”èµ›çš„èµ·è·‘çº¿ï¼Œæ‰€æœ‰è¿åŠ¨å‘˜éƒ½è¦åœ¨èµ·è·‘çº¿å‰ç­‰å¾…ï¼Œç›´åˆ°å‘ä»¤æªå“èµ·ï¼Œå¤§å®¶æ‰èƒ½åŒæ—¶èµ·è·‘ã€‚åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¤šä¸ªæœåŠ¡éœ€è¦ç­‰å¾…å½¼æ­¤éƒ½å‡†å¤‡å¥½ï¼Œç„¶ååŒæ—¶å¼€å§‹æ‰§è¡ŒæŸä¸ªä»»åŠ¡ã€‚

**ğŸ“Š æ …æ çš„ä¸¤ç§ç±»å‹**ï¼š

```
DistributedBarrierï¼ˆåˆ†å¸ƒå¼æ …æ ï¼‰ï¼š
æ‰€æœ‰å‚ä¸è€…ç­‰å¾… â†’ æ¡ä»¶æ»¡è¶³ â†’ æ‰€æœ‰å‚ä¸è€…åŒæ—¶é€šè¿‡

DistributedDoubleBarrierï¼ˆåˆ†å¸ƒå¼åŒæ …æ ï¼‰ï¼š
æ‰€æœ‰å‚ä¸è€…èšé›† â†’ åŒæ—¶å¼€å§‹æ‰§è¡Œ â†’ éƒ½å®ŒæˆååŒæ—¶ç»“æŸ
```

### 6.2 DistributedBarrierä½¿ç”¨


**ğŸš§ åŸºæœ¬æ …æ ç¤ºä¾‹**ï¼š

```java
public class BarrierExample {
    private CuratorFramework client;
    private DistributedBarrier barrier;
    
    public void initBarrier() {
        // åˆ›å»ºåˆ†å¸ƒå¼æ …æ 
        barrier = new DistributedBarrier(client, "/barriers/deployment");
        
        try {
            // è®¾ç½®æ …æ ï¼ˆå…³é—­çŠ¶æ€ï¼‰
            barrier.setBarrier();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    // å·¥ä½œçº¿ç¨‹ç­‰å¾…æ …æ å¼€å¯
    public void workerTask(String workerId) {
        try {
            System.out.println(workerId + " å‡†å¤‡å°±ç»ªï¼Œç­‰å¾…ç»Ÿä¸€å¼€å§‹...");
            
            // ç­‰å¾…æ …æ å¼€å¯
            barrier.waitOnBarrier();
            
            System.out.println(workerId + " å¼€å§‹æ‰§è¡Œä»»åŠ¡ï¼");
            
            // æ‰§è¡Œå…·ä½“ä»»åŠ¡
            doWork(workerId);
            
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    // æ§åˆ¶å™¨å¼€å¯æ …æ 
    public void releaseBarrier() {
        try {
            System.out.println("æ‰€æœ‰æœåŠ¡å‡†å¤‡å®Œæ¯•ï¼Œå¼€å¯æ …æ ï¼");
            
            // ç§»é™¤æ …æ ï¼Œæ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹ä¼šåŒæ—¶é€šè¿‡
            barrier.removeBarrier();
            
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

### 6.3 DistributedDoubleBarrierä½¿ç”¨


**ğŸ”„ åŒæ …æ ç¤ºä¾‹**ï¼š

```java
public class DoubleBarrierExample {
    private CuratorFramework client;
    private DistributedDoubleBarrier doubleBarrier;
    
    public void initDoubleBarrier(int memberCount) {
        // åˆ›å»ºåŒæ …æ ï¼Œéœ€è¦3ä¸ªæˆå‘˜å‚ä¸
        doubleBarrier = new DistributedDoubleBarrier(
            client, 
            "/barriers/batch-job", 
            memberCount
        );
    }
    
    public void executeBatchJob(String jobId) {
        try {
            System.out.println(jobId + " ç­‰å¾…å…¶ä»–ä»»åŠ¡å‡†å¤‡...");
            
            // è¿›å…¥æ …æ ï¼Œç­‰å¾…å…¶ä»–æˆå‘˜
            doubleBarrier.enter();
            
            System.out.println(jobId + " æ‰€æœ‰ä»»åŠ¡å¼€å§‹æ‰§è¡Œï¼");
            
            // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
            processBatchData(jobId);
            
            System.out.println(jobId + " ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œç­‰å¾…å…¶ä»–ä»»åŠ¡...");
            
            // ç¦»å¼€æ …æ ï¼Œç­‰å¾…å…¶ä»–æˆå‘˜å®Œæˆ
            doubleBarrier.leave();
            
            System.out.println(jobId + " æ‰€æœ‰ä»»åŠ¡éƒ½å®Œæˆäº†ï¼");
            
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    private void processBatchData(String jobId) {
        try {
            // æ¨¡æ‹Ÿæ‰¹é‡æ•°æ®å¤„ç†
            Thread.sleep((long) (Math.random() * 5000) + 2000);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }
}
```

### 6.4 æ …æ çš„å®é™…åº”ç”¨åœºæ™¯


**ğŸ¯ åˆ†å¸ƒå¼æ‰¹é‡å¤„ç†**ï¼š

```java
@Service
public class BatchProcessService {
    private DistributedDoubleBarrier batchBarrier;
    
    // æ¯å¤©å‡Œæ™¨çš„æ•°æ®å¤„ç†ä»»åŠ¡
    @Scheduled(cron = "0 0 0 * * ?")
    public void dailyDataProcess() {
        String nodeId = getNodeId();
        
        try {
            // ç­‰å¾…æ‰€æœ‰èŠ‚ç‚¹å‡†å¤‡å¥½
            batchBarrier.enter();
            
            System.out.println("æ‰€æœ‰èŠ‚ç‚¹å¼€å§‹å¤„ç†æ•°æ®...");
            
            // å„è‡ªå¤„ç†è‡ªå·±çš„æ•°æ®åˆ†ç‰‡
            processDataShard(nodeId);
            
            // ç­‰å¾…æ‰€æœ‰èŠ‚ç‚¹å¤„ç†å®Œæˆ
            batchBarrier.leave();
            
            System.out.println("æ‰€æœ‰æ•°æ®å¤„ç†å®Œæˆï¼Œå¼€å§‹æ±‡æ€»...");
            
            // æ±‡æ€»å¤„ç†ç»“æœ
            if (isMasterNode()) {
                aggregateResults();
            }
            
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

**ğŸ“Š æ …æ åº”ç”¨åœºæ™¯æ€»ç»“**ï¼š

| åœºæ™¯ç±»å‹ | ä½¿ç”¨æ …æ  | åº”ç”¨è¯´æ˜ |
|---------|---------|----------|
| **ç³»ç»Ÿéƒ¨ç½²** | DistributedBarrier | ç­‰å¾…æ‰€æœ‰æœåŠ¡éƒ¨ç½²å®Œæˆå†å¼€æ”¾æµé‡ |
| **æ•°æ®è¿ç§»** | DistributedDoubleBarrier | å¤šä¸ªèŠ‚ç‚¹åŒæ—¶å¼€å§‹å’Œç»“æŸè¿ç§» |
| **æ‰¹é‡è®¡ç®—** | DistributedDoubleBarrier | MapReduceä»»åŠ¡çš„åŒæ­¥ |
| **æµ‹è¯•åŒæ­¥** | DistributedBarrier | æ€§èƒ½æµ‹è¯•ä¸­çš„å¹¶å‘æ§åˆ¶ |

---

## 7. âš™ï¸ åˆ†å¸ƒå¼é”å®ç°åŸç†


### 7.1 Zookeeperåˆ†å¸ƒå¼é”åŸç†


**ğŸ”‘ æ ¸å¿ƒå®ç°æ€è·¯**ï¼š

```
Zookeeperåˆ†å¸ƒå¼é”çš„æœ¬è´¨ï¼š
åˆ©ç”¨Zookeeperçš„èŠ‚ç‚¹ç‰¹æ€§ + äº‹ä»¶ç›‘å¬æœºåˆ¶
```

**ğŸ“Š èŠ‚ç‚¹ç±»å‹çš„å¦™ç”¨**ï¼š

```
ä¸´æ—¶é¡ºåºèŠ‚ç‚¹çš„ç‰¹ç‚¹ï¼š
1. ä¸´æ—¶æ€§ï¼šå®¢æˆ·ç«¯æ–­å¼€è¿æ¥èŠ‚ç‚¹è‡ªåŠ¨åˆ é™¤
2. é¡ºåºæ€§ï¼šèŠ‚ç‚¹åä¼šè‡ªåŠ¨åŠ ä¸Šé€’å¢åºå·  
3. å”¯ä¸€æ€§ï¼šç›¸åŒè·¯å¾„ä¸‹ä¸ä¼šæœ‰é‡å¤èŠ‚ç‚¹

åˆ©ç”¨è¿™äº›ç‰¹ç‚¹å®ç°åˆ†å¸ƒå¼é”ï¼š
/locks/mylock_0000000001  â† ç¬¬ä¸€ä¸ªå®¢æˆ·ç«¯
/locks/mylock_0000000002  â† ç¬¬äºŒä¸ªå®¢æˆ·ç«¯  
/locks/mylock_0000000003  â† ç¬¬ä¸‰ä¸ªå®¢æˆ·ç«¯

è§„åˆ™ï¼šåºå·æœ€å°çš„èŠ‚ç‚¹è·å¾—é”
```

### 7.2 é”è·å–çš„è¯¦ç»†æµç¨‹


**ğŸ”„ è·å–é”çš„æ­¥éª¤**ï¼š

```
Step 1: åˆ›å»ºä¸´æ—¶é¡ºåºèŠ‚ç‚¹
å®¢æˆ·ç«¯A â†’ åˆ›å»º /locks/mylock_0000000001
å®¢æˆ·ç«¯B â†’ åˆ›å»º /locks/mylock_0000000002
å®¢æˆ·ç«¯C â†’ åˆ›å»º /locks/mylock_0000000003

Step 2: æ£€æŸ¥æ˜¯å¦è·å¾—é”
å®¢æˆ·ç«¯A â†’ æ£€æŸ¥è‡ªå·±æ˜¯å¦æ˜¯æœ€å°åºå· â†’ æ˜¯ â†’ è·å¾—é”
å®¢æˆ·ç«¯B â†’ æ£€æŸ¥è‡ªå·±æ˜¯å¦æ˜¯æœ€å°åºå· â†’ å¦ â†’ ç­‰å¾…
å®¢æˆ·ç«¯C â†’ æ£€æŸ¥è‡ªå·±æ˜¯å¦æ˜¯æœ€å°åºå· â†’ å¦ â†’ ç­‰å¾…

Step 3: ç›‘å¬å‰ä¸€ä¸ªèŠ‚ç‚¹
å®¢æˆ·ç«¯B â†’ ç›‘å¬ /locks/mylock_0000000001
å®¢æˆ·ç«¯C â†’ ç›‘å¬ /locks/mylock_0000000002

Step 4: é”é‡Šæ”¾é€šçŸ¥
å®¢æˆ·ç«¯Aé‡Šæ”¾é” â†’ åˆ é™¤èŠ‚ç‚¹ â†’ å®¢æˆ·ç«¯Bæ”¶åˆ°é€šçŸ¥ â†’ è·å¾—é”
```

**ğŸ’¡ ä¸ºä»€ä¹ˆåªç›‘å¬å‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Ÿ**
```
å¦‚æœæ‰€æœ‰å®¢æˆ·ç«¯éƒ½ç›‘å¬æœ€å°èŠ‚ç‚¹ï¼š
é”é‡Šæ”¾æ—¶ â†’ æ‰€æœ‰å®¢æˆ·ç«¯éƒ½æ”¶åˆ°é€šçŸ¥ â†’ ç¾Šç¾¤æ•ˆåº”

åªç›‘å¬å‰ä¸€ä¸ªèŠ‚ç‚¹ï¼š
é”é‡Šæ”¾æ—¶ â†’ åªæœ‰ä¸‹ä¸€ä¸ªå®¢æˆ·ç«¯æ”¶åˆ°é€šçŸ¥ â†’ é¿å…ç¾Šç¾¤æ•ˆåº”
```

### 7.3 InterProcessMutexæºç åŸç†


**ğŸ” æ ¸å¿ƒå®ç°é€»è¾‘**ï¼š

```java
// ç®€åŒ–ç‰ˆçš„é”è·å–é€»è¾‘
public class SimplifiedLock {
    
    public boolean acquire() throws Exception {
        // 1. åˆ›å»ºä¸´æ—¶é¡ºåºèŠ‚ç‚¹
        String ourPath = client.create()
            .creatingParentsIfNeeded()
            .withMode(CreateMode.EPHEMERAL_SEQUENTIAL)
            .forPath(basePath + "/lock-");
        
        while (true) {
            // 2. è·å–æ‰€æœ‰å­èŠ‚ç‚¹å¹¶æ’åº
            List<String> children = client.getChildren().forPath(basePath);
            Collections.sort(children);
            
            // 3. æ£€æŸ¥è‡ªå·±æ˜¯å¦æ˜¯æœ€å°çš„
            int ourIndex = children.indexOf(ourPath.substring(basePath.length() + 1));
            
            if (ourIndex == 0) {
                // æˆ‘ä»¬æ˜¯æœ€å°çš„ï¼Œè·å¾—é”
                return true;
            }
            
            // 4. ç›‘å¬å‰ä¸€ä¸ªèŠ‚ç‚¹
            String pathToWatch = basePath + "/" + children.get(ourIndex - 1);
            
            final CountDownLatch latch = new CountDownLatch(1);
            
            Watcher watcher = new Watcher() {
                public void process(WatchedEvent event) {
                    latch.countDown(); // èŠ‚ç‚¹è¢«åˆ é™¤ï¼Œå”¤é†’ç­‰å¾…
                }
            };
            
            // è®¾ç½®ç›‘å¬
            if (client.checkExists().usingWatcher(watcher).forPath(pathToWatch) == null) {
                // èŠ‚ç‚¹å·²ç»ä¸å­˜åœ¨äº†ï¼Œç»§ç»­å¾ªç¯æ£€æŸ¥
                continue;
            }
            
            // 5. ç­‰å¾…è¢«å”¤é†’
            latch.await();
        }
    }
    
    public void release() throws Exception {
        // åˆ é™¤è‡ªå·±çš„èŠ‚ç‚¹ï¼Œé‡Šæ”¾é”
        client.delete().forPath(ourPath);
    }
}
```

### 7.4 å¯é‡å…¥é”çš„å®ç°åŸç†


**ğŸ”¢ é‡å…¥è®¡æ•°å®ç°**ï¼š

```java
// å¯é‡å…¥é”çš„æ ¸å¿ƒæ•°æ®ç»“æ„
public class ReentrantLockData {
    private final Thread lockThread;     // æŒæœ‰é”çš„çº¿ç¨‹
    private final String lockPath;       // é”èŠ‚ç‚¹è·¯å¾„
    private int lockCount;               // é‡å…¥æ¬¡æ•°
    
    public ReentrantLockData(Thread lockThread, String lockPath) {
        this.lockThread = lockThread;
        this.lockPath = lockPath;
        this.lockCount = 1;
    }
    
    // å¢åŠ é‡å…¥æ¬¡æ•°
    public void incrementLockCount() {
        lockCount++;
    }
    
    // å‡å°‘é‡å…¥æ¬¡æ•°
    public void decrementLockCount() {
        lockCount--;
    }
    
    // æ˜¯å¦å¯ä»¥å®Œå…¨é‡Šæ”¾é”
    public boolean canRelease() {
        return lockCount <= 0;
    }
}
```

**ğŸ”„ é‡å…¥æœºåˆ¶æµç¨‹**ï¼š

```
åŒä¸€çº¿ç¨‹å¤šæ¬¡è·å–é”ï¼š
ç¬¬ä¸€æ¬¡acquire() â†’ åˆ›å»ºèŠ‚ç‚¹ï¼ŒlockCount = 1
ç¬¬äºŒæ¬¡acquire() â†’ æ£€æŸ¥çº¿ç¨‹ç›¸åŒï¼ŒlockCount = 2
ç¬¬ä¸‰æ¬¡acquire() â†’ æ£€æŸ¥çº¿ç¨‹ç›¸åŒï¼ŒlockCount = 3

åŒä¸€çº¿ç¨‹å¤šæ¬¡é‡Šæ”¾é”ï¼š
ç¬¬ä¸€æ¬¡release() â†’ lockCount = 2ï¼Œä¸åˆ é™¤èŠ‚ç‚¹
ç¬¬äºŒæ¬¡release() â†’ lockCount = 1ï¼Œä¸åˆ é™¤èŠ‚ç‚¹  
ç¬¬ä¸‰æ¬¡release() â†’ lockCount = 0ï¼Œåˆ é™¤èŠ‚ç‚¹ï¼ŒçœŸæ­£é‡Šæ”¾é”
```

### 7.5 åˆ†å¸ƒå¼é”çš„ä¼˜åŒ–ç­–ç•¥


**âš¡ æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š

| ä¼˜åŒ–ç­–ç•¥ | å®ç°æ–¹æ³• | ä¼˜åŒ–æ•ˆæœ |
|---------|---------|----------|
| **è¿æ¥å¤ç”¨** | ä½¿ç”¨è¿æ¥æ±  | å‡å°‘è¿æ¥å»ºç«‹å¼€é”€ |
| **æ‰¹é‡æ“ä½œ** | äº‹åŠ¡æ‰¹é‡å¤„ç† | å‡å°‘ç½‘ç»œå¾€è¿”æ¬¡æ•° |
| **æœ¬åœ°ç¼“å­˜** | ç¼“å­˜èŠ‚ç‚¹ä¿¡æ¯ | å‡å°‘ZKæŸ¥è¯¢æ¬¡æ•° |
| **å¼‚æ­¥å¤„ç†** | å¼‚æ­¥è·å–é” | æé«˜å¹¶å‘èƒ½åŠ› |

**ğŸ”’ å®‰å…¨æ€§ä¿éšœ**ï¼š
```
1. ä¸´æ—¶èŠ‚ç‚¹ï¼šå®¢æˆ·ç«¯æ–­å¼€è‡ªåŠ¨é‡Šæ”¾é”
2. ä¼šè¯è¶…æ—¶ï¼šé˜²æ­¢æ­»é”
3. é¡ºåºèŠ‚ç‚¹ï¼šä¿è¯é”çš„å…¬å¹³æ€§
4. äº‹ä»¶é€šçŸ¥ï¼šåŠæ—¶å“åº”é”é‡Šæ”¾
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ åˆ†å¸ƒå¼é”æœ¬è´¨ï¼šè·¨ç½‘ç»œçš„èµ„æºäº’æ–¥è®¿é—®æ§åˆ¶
ğŸ”¸ InterProcessMutexï¼šCuratoræä¾›çš„äº’æ–¥é”å®ç°
ğŸ”¸ å¯é‡å…¥ç‰¹æ€§ï¼šåŒä¸€çº¿ç¨‹å¯å¤šæ¬¡è·å–åŒä¸€æŠŠé”  
ğŸ”¸ è¯»å†™é”æœºåˆ¶ï¼šè¯»è¯»å…±äº«ï¼Œè¯»å†™äº’æ–¥ï¼Œå†™å†™äº’æ–¥
ğŸ”¸ ä¿¡å·é‡æ§åˆ¶ï¼šé™åˆ¶åŒæ—¶è®¿é—®èµ„æºçš„æ•°é‡
ğŸ”¸ æ …æ åŒæ­¥ï¼šå¤šä¸ªèŠ‚ç‚¹åŒæ—¶å¼€å§‹æˆ–ç»“æŸä»»åŠ¡
```

### 8.2 å…³é”®å®ç°åŸç†


**ğŸ”¹ Zookeeperé”å®ç°æ ¸å¿ƒ**ï¼š
```
ä¸´æ—¶é¡ºåºèŠ‚ç‚¹ + äº‹ä»¶ç›‘å¬ = åˆ†å¸ƒå¼é”
æœ€å°åºå·è·å¾—é” + ç›‘å¬å‰ç½®èŠ‚ç‚¹ = å…¬å¹³é”
é‡å…¥è®¡æ•°å™¨ + çº¿ç¨‹æ£€æŸ¥ = å¯é‡å…¥é”
```

**ğŸ”¹ å„ç±»é”çš„é€‚ç”¨åœºæ™¯**ï¼š
```
äº’æ–¥é” InterProcessMutexï¼š
â†’ é˜²é‡å¤æ“ä½œã€èµ„æºç‹¬å è®¿é—®

è¯»å†™é” InterProcessReadWriteLockï¼š  
â†’ è¯»å¤šå†™å°‘åœºæ™¯ã€é…ç½®ç®¡ç†

ä¿¡å·é‡ InterProcessSemaphoreV2ï¼š
â†’ é™æµæ§åˆ¶ã€èµ„æºæ± ç®¡ç†

æ …æ  DistributedBarrier/DoubleBarrierï¼š
â†’ æ‰¹é‡å¤„ç†ã€ç³»ç»Ÿéƒ¨ç½²åŒæ­¥
```

### 8.3 ä½¿ç”¨æœ€ä½³å®è·µ


**âœ… æ­£ç¡®ä½¿ç”¨æ¨¡å¼**ï¼š
```
1. æ€»æ˜¯åœ¨try-finallyä¸­é‡Šæ”¾é”
2. è®¾ç½®åˆç†çš„è·å–è¶…æ—¶æ—¶é—´
3. é€‰æ‹©åˆé€‚çš„é”ç²’åº¦
4. å¤„ç†è·å–é”å¤±è´¥çš„æƒ…å†µ
5. é¿å…é•¿æ—¶é—´æŒæœ‰é”
```

**âš ï¸ å¸¸è§é—®é¢˜é¿å…**ï¼š
```
âŒ å¿˜è®°é‡Šæ”¾é” â†’ å¯¼è‡´æ­»é”
âŒ é”ç²’åº¦è¿‡ç²— â†’ å½±å“å¹¶å‘æ€§èƒ½  
âŒ è¶…æ—¶è®¾ç½®è¿‡é•¿ â†’ å½±å“ç”¨æˆ·ä½“éªŒ
âŒ æ²¡æœ‰å¼‚å¸¸å¤„ç† â†’ ç³»ç»Ÿä¸ç¨³å®š
âŒ é‡å…¥æ¬¡æ•°ä¸åŒ¹é… â†’ é”æ³„éœ²
```

### 8.4 æ€§èƒ½ä¸å¯é æ€§


**ğŸ“Š æ€§èƒ½ç‰¹ç‚¹**ï¼š
- **ä¸€è‡´æ€§å¼º**ï¼šåŸºäºZABåè®®ä¿è¯æ•°æ®ä¸€è‡´æ€§
- **å¯é æ€§é«˜**ï¼šä¸´æ—¶èŠ‚ç‚¹è‡ªåŠ¨æ¸…ç†ï¼Œé¿å…æ­»é”
- **å…¬å¹³æ€§å¥½**ï¼šé¡ºåºèŠ‚ç‚¹ä¿è¯FIFOé¡ºåº
- **æ‰©å±•æ€§å¼º**ï¼šæ”¯æŒé›†ç¾¤éƒ¨ç½²ï¼Œé«˜å¯ç”¨

**ğŸ¯ é€‰å‹å»ºè®®**ï¼š
```
é«˜ä¸€è‡´æ€§è¦æ±‚ â†’ é€‰æ‹©Zookeeperåˆ†å¸ƒå¼é”
é«˜æ€§èƒ½è¦æ±‚ â†’ è€ƒè™‘Redisåˆ†å¸ƒå¼é”  
ç®€å•åœºæ™¯ â†’ æ•°æ®åº“åˆ†å¸ƒå¼é”
å¤æ‚åŒæ­¥éœ€æ±‚ â†’ Zookeeperæ …æ æœºåˆ¶
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- åˆ†å¸ƒå¼é”è§£å†³è·¨æœåŠ¡å™¨çš„èµ„æºç«äº‰é—®é¢˜
- InterProcessMutexæ˜¯æœ€å¸¸ç”¨çš„åˆ†å¸ƒå¼äº’æ–¥é”
- å¯é‡å…¥é”å…è®¸åŒä¸€çº¿ç¨‹å¤šæ¬¡è·å–åŒä¸€æŠŠé”
- è¯»å†™é”é€‚åˆè¯»å¤šå†™å°‘çš„åœºæ™¯ä¼˜åŒ–æ€§èƒ½
- ä¿¡å·é‡ç”¨äºé™åˆ¶åŒæ—¶è®¿é—®èµ„æºçš„æ•°é‡
- æ …æ æœºåˆ¶å®ç°å¤šèŠ‚ç‚¹çš„åŒæ­¥åè°ƒ
- åº•å±‚åŸç†åŸºäºä¸´æ—¶é¡ºåºèŠ‚ç‚¹å’Œäº‹ä»¶ç›‘å¬
- ä½¿ç”¨æ—¶ä¸€å®šè¦æ³¨æ„è·å–å’Œé‡Šæ”¾çš„é…å¯¹