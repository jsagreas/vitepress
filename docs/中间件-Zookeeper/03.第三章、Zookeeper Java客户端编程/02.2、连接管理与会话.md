---
title: 2ã€è¿æ¥ç®¡ç†ä¸ä¼šè¯
---
## ğŸ“š ç›®å½•

1. [è¿æ¥ç®¡ç†åŸºç¡€æ¦‚å¿µ](#1-è¿æ¥ç®¡ç†åŸºç¡€æ¦‚å¿µ)
2. [è¿æ¥å»ºç«‹è¿‡ç¨‹](#2-è¿æ¥å»ºç«‹è¿‡ç¨‹)
3. [ä¼šè¯æœºåˆ¶è¯¦è§£](#3-ä¼šè¯æœºåˆ¶è¯¦è§£)
4. [å¿ƒè·³æœºåˆ¶ä¸ä¼šè¯ä¿æŒ](#4-å¿ƒè·³æœºåˆ¶ä¸ä¼šè¯ä¿æŒ)
5. [ä¼šè¯è¶…æ—¶å¤„ç†](#5-ä¼šè¯è¶…æ—¶å¤„ç†)
6. [è¿æ¥é‡è¯•ç­–ç•¥](#6-è¿æ¥é‡è¯•ç­–ç•¥)
7. [çŠ¶æ€ç›‘å¬æœºåˆ¶](#7-çŠ¶æ€ç›‘å¬æœºåˆ¶)
8. [å®é™…åº”ç”¨ä¸æœ€ä½³å®è·µ](#8-å®é™…åº”ç”¨ä¸æœ€ä½³å®è·µ)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”— è¿æ¥ç®¡ç†åŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯è¿æ¥ç®¡ç†


**é€šä¿—è§£é‡Š**ï¼šè¿æ¥ç®¡ç†å°±åƒä½ å’Œæœ‹å‹æ‰“ç”µè¯ä¸€æ ·ï¼Œéœ€è¦å…ˆæ‹¨å·å»ºç«‹è¿æ¥ï¼Œé€šè¯è¿‡ç¨‹ä¸­ä¿æŒçº¿è·¯ç•…é€šï¼Œé€šè¯ç»“æŸåæŒ‚æ–­ç”µè¯ã€‚Zookeeperå®¢æˆ·ç«¯ä¹Ÿæ˜¯è¿™æ ·ï¼Œéœ€è¦å’ŒæœåŠ¡å™¨å»ºç«‹è¿æ¥ã€ä¿æŒè¿æ¥ã€å¤„ç†æ–­å¼€ç­‰æƒ…å†µã€‚

```
ç°å®ç”Ÿæ´»ç±»æ¯”ï¼š                    Zookeeperè¿æ¥ï¼š
æ‰“ç”µè¯ç»™æœ‹å‹                     å®¢æˆ·ç«¯è¿æ¥æœåŠ¡å™¨
 â†“                                â†“
æ‹¨å·å»ºç«‹è¿æ¥                     å‘é€è¿æ¥è¯·æ±‚
 â†“                                â†“
ä¿æŒé€šè¯çŠ¶æ€                     ä¼šè¯ä¿æŒ
 â†“                                â†“
å¤„ç†ä¿¡å·ä¸å¥½                     å¤„ç†ç½‘ç»œå¼‚å¸¸
 â†“                                â†“
é€šè¯ç»“æŸæŒ‚æœº                     æ–­å¼€è¿æ¥é‡Šæ”¾èµ„æº
```

### 1.2 è¿æ¥ç®¡ç†çš„æ ¸å¿ƒä½œç”¨


**ä¸ºä»€ä¹ˆéœ€è¦è¿æ¥ç®¡ç†ï¼Ÿ**
- **ğŸ” èº«ä»½è®¤è¯**ï¼šç¡®è®¤å®¢æˆ·ç«¯æœ‰æƒé™è®¿é—®Zookeeper
- **ğŸ“¡ é€šä¿¡é€šé“**ï¼šå»ºç«‹å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨é—´çš„æ•°æ®ä¼ è¾“é€šé“
- **ğŸ’“ å¥åº·æ£€æŸ¥**ï¼šé€šè¿‡å¿ƒè·³ç¡®ä¿è¿æ¥æ­£å¸¸å·¥ä½œ
- **ğŸ”„ æ•…éšœæ¢å¤**ï¼šç½‘ç»œé—®é¢˜æ—¶è‡ªåŠ¨é‡è¿
- **ğŸ“Š çŠ¶æ€åŒæ­¥**ï¼šä¿æŒå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çŠ¶æ€ä¸€è‡´

### 1.3 è¿æ¥çš„ç”Ÿå‘½å‘¨æœŸ


```
è¿æ¥çŠ¶æ€è½¬æ¢å›¾ï¼š

NOT_CONNECTED  â†’  CONNECTING  â†’  CONNECTED  â†’  CLOSED
      â†‘              â†“              â†“           â†‘
      â””â”€â”€â”€â”€â”€â”€â”€â”€ DISCONNECTED â†â”€â”€â”€â”€â”€â”˜           â”‚
                     â†“                        â”‚
                RECONNECTING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

çŠ¶æ€è¯´æ˜ï¼š
â€¢ NOT_CONNECTEDï¼šåˆå§‹çŠ¶æ€ï¼Œè¿˜æœªå¼€å§‹è¿æ¥
â€¢ CONNECTINGï¼šæ­£åœ¨å°è¯•å»ºç«‹è¿æ¥
â€¢ CONNECTEDï¼šè¿æ¥æˆåŠŸï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨
â€¢ DISCONNECTEDï¼šè¿æ¥æ–­å¼€ï¼Œä½†ä¼šå°è¯•é‡è¿
â€¢ RECONNECTINGï¼šæ­£åœ¨é‡æ–°è¿æ¥ä¸­
â€¢ CLOSEDï¼šè¿æ¥å½»åº•å…³é—­ï¼Œä¸å†é‡è¿
```

---

## 2. ğŸš€ è¿æ¥å»ºç«‹è¿‡ç¨‹


### 2.1 è¿æ¥å»ºç«‹çš„åŸºæœ¬æµç¨‹


**å»ºç«‹è¿æ¥å°±åƒæ­å»ºä¸€åº§æ¡¥æ¢**ï¼Œéœ€è¦ç»è¿‡å‡ ä¸ªå…³é”®æ­¥éª¤ï¼š

```
å®¢æˆ·ç«¯è¿æ¥å»ºç«‹æµç¨‹ï¼š

ç¬¬1æ­¥ï¼šè§£ææœåŠ¡å™¨åœ°å€
"localhost:2181,server2:2181" â†’ [localhost:2181, server2:2181]

ç¬¬2æ­¥ï¼šé€‰æ‹©æœåŠ¡å™¨è¿æ¥
æŒ‰é¡ºåºæˆ–éšæœºé€‰æ‹©ä¸€å°æœåŠ¡å™¨è¿›è¡Œè¿æ¥

ç¬¬3æ­¥ï¼šå»ºç«‹TCPè¿æ¥
å®¢æˆ·ç«¯ â†â”€â”€â”€â”€ TCPæ¡æ‰‹ â”€â”€â”€â”€â†’ ZookeeperæœåŠ¡å™¨

ç¬¬4æ­¥ï¼šå‘é€è¿æ¥è¯·æ±‚
å®¢æˆ·ç«¯å‘é€ConnectRequeståŒ…å«ï¼š
- åè®®ç‰ˆæœ¬å·
- ä¼šè¯è¶…æ—¶æ—¶é—´
- ä¼šè¯IDï¼ˆå¦‚æœæ˜¯é‡è¿ï¼‰
- å¯†ç ï¼ˆå¦‚æœæ˜¯é‡è¿ï¼‰

ç¬¬5æ­¥ï¼šæœåŠ¡å™¨å“åº”
æœåŠ¡å™¨è¿”å›ConnectResponseåŒ…å«ï¼š
- åˆ†é…çš„ä¼šè¯ID
- åå•†çš„è¶…æ—¶æ—¶é—´
- å¯†ç ç”¨äºé‡è¿
```

### 2.2 ä»£ç å®ç°è¿æ¥å»ºç«‹


```java
public class ZookeeperConnectionDemo {
    private ZooKeeper zk;
    private final CountDownLatch connectedSignal = new CountDownLatch(1);
    
    // è¿æ¥å»ºç«‹çš„æ ¸å¿ƒä»£ç 
    public void connect(String hosts) throws Exception {
        // åˆ›å»ºZooKeeperå®ä¾‹ï¼Œè¿™é‡Œå°±å¼€å§‹å»ºç«‹è¿æ¥äº†
        zk = new ZooKeeper(hosts, 3000, new Watcher() {
            @Override
            public void process(WatchedEvent event) {
                // è¿æ¥æˆåŠŸåä¼šæ”¶åˆ°Connectedäº‹ä»¶
                if (event.getState() == KeeperState.SyncConnected) {
                    System.out.println("âœ… è¿æ¥å»ºç«‹æˆåŠŸï¼");
                    connectedSignal.countDown(); // é€šçŸ¥ç­‰å¾…çº¿ç¨‹
                }
            }
        });
        
        // ç­‰å¾…è¿æ¥å»ºç«‹å®Œæˆï¼ˆæœ€å¤šç­‰å¾…10ç§’ï¼‰
        if (!connectedSignal.await(10, TimeUnit.SECONDS)) {
            throw new Exception("âŒ è¿æ¥è¶…æ—¶ï¼Œå»ºç«‹å¤±è´¥");
        }
    }
    
    public static void main(String[] args) {
        ZookeeperConnectionDemo demo = new ZookeeperConnectionDemo();
        try {
            demo.connect("localhost:2181");
            System.out.println("ğŸ‰ å¯ä»¥å¼€å§‹ä½¿ç”¨Zookeeperäº†ï¼");
        } catch (Exception e) {
            System.out.println("ğŸ’¥ è¿æ¥å¤±è´¥ï¼š" + e.getMessage());
        }
    }
}
```

### 2.3 è¿æ¥å‚æ•°è¯¦è§£


| å‚æ•°åç§° | **ä½œç”¨è¯´æ˜** | **æ¨èå€¼** | **æ³¨æ„äº‹é¡¹** |
|---------|-------------|-----------|-------------|
| **è¿æ¥å­—ç¬¦ä¸²** | `æŒ‡å®šæœåŠ¡å™¨åœ°å€` | `"host1:2181,host2:2181"` | `å¤šä¸ªåœ°å€ç”¨é€—å·åˆ†éš”ï¼Œæé«˜å¯ç”¨æ€§` |
| **ä¼šè¯è¶…æ—¶** | `ä¼šè¯å¤±æ•ˆæ—¶é—´` | `3000-30000æ¯«ç§’` | `å¤ªçŸ­å®¹æ˜“è¶…æ—¶ï¼Œå¤ªé•¿å½±å“æ•…éšœæ£€æµ‹` |
| **Watcher** | `äº‹ä»¶ç›‘å¬å™¨` | `å¿…é¡»æä¾›` | `ç”¨äºæ¥æ”¶è¿æ¥çŠ¶æ€å˜åŒ–é€šçŸ¥` |

**ğŸ’¡ å°è´´å£«**ï¼šè¿æ¥å­—ç¬¦ä¸²ä¸­çš„å¤šä¸ªåœ°å€æ˜¯ä¸ºäº†é«˜å¯ç”¨ï¼Œå¦‚æœç¬¬ä¸€ä¸ªæœåŠ¡å™¨è¿ä¸ä¸Šï¼Œä¼šè‡ªåŠ¨å°è¯•ç¬¬äºŒä¸ªã€‚

---

## 3. ğŸ« ä¼šè¯æœºåˆ¶è¯¦è§£


### 3.1 ä»€ä¹ˆæ˜¯ä¼šè¯


**é€šä¿—ç†è§£**ï¼šä¼šè¯å°±åƒä½ åœ¨é“¶è¡ŒåŠä¸šåŠ¡æ—¶æ‹¿åˆ°çš„æ’é˜Ÿå·ç ï¼Œè¿™ä¸ªå·ç ä»£è¡¨äº†ä½ è¿™æ¬¡è®¿é—®çš„èº«ä»½ã€‚åœ¨Zookeeperä¸­ï¼Œä¼šè¯IDå°±æ˜¯å®¢æˆ·ç«¯çš„èº«ä»½è¯ï¼ŒæœåŠ¡å™¨é€šè¿‡å®ƒè¯†åˆ«ä¸åŒçš„å®¢æˆ·ç«¯ã€‚

```
ä¼šè¯çš„æœ¬è´¨ï¼š

ç°å®åœºæ™¯ï¼šé“¶è¡Œæ’é˜Ÿç³»ç»Ÿ            Zookeeperä¼šè¯ç³»ç»Ÿ
  å–å·æœº                           è¿æ¥å»ºç«‹
    â†“                                â†“
æ’é˜Ÿå·ï¼šA001                     ä¼šè¯IDï¼š0x1000001
    â†“                                â†“
ç­‰å¾…å«å·                         ä¿æŒè¿æ¥
    â†“                                â†“
åŠç†ä¸šåŠ¡                         æ‰§è¡Œæ“ä½œ
    â†“                                â†“
ä¸šåŠ¡å®Œæˆ                         ä¼šè¯ç»“æŸ
```

### 3.2 ä¼šè¯çš„é‡è¦å±æ€§


```java
// ä¼šè¯ä¿¡æ¯å±•ç¤º
public void showSessionInfo(ZooKeeper zk) {
    System.out.println("ğŸ“‹ å½“å‰ä¼šè¯ä¿¡æ¯ï¼š");
    System.out.println("ğŸ†” ä¼šè¯IDï¼š" + Long.toHexString(zk.getSessionId()));
    System.out.println("ğŸ”‘ ä¼šè¯å¯†ç ï¼š" + Arrays.toString(zk.getSessionPasswd()));
    System.out.println("â±ï¸ ä¼šè¯è¶…æ—¶ï¼š" + zk.getSessionTimeout() + "ms");
    System.out.println("ğŸ”— è¿æ¥çŠ¶æ€ï¼š" + zk.getState());
}
```

**ä¼šè¯å±æ€§è¯´æ˜**ï¼š
- **ğŸ†” ä¼šè¯ID**ï¼šå”¯ä¸€æ ‡è¯†ä¸€ä¸ªä¼šè¯ï¼Œç”±æœåŠ¡å™¨ç”Ÿæˆ
- **ğŸ”‘ ä¼šè¯å¯†ç **ï¼šç”¨äºé‡è¿æ—¶éªŒè¯èº«ä»½
- **â±ï¸ è¶…æ—¶æ—¶é—´**ï¼šä¼šè¯çš„æœ‰æ•ˆæœŸï¼Œè¶…è¿‡å°±å¤±æ•ˆ
- **ğŸ”— çŠ¶æ€**ï¼šå½“å‰ä¼šè¯çš„è¿æ¥çŠ¶æ€

### 3.3 ä¼šè¯çš„ç”Ÿå‘½å‘¨æœŸ


```
ä¼šè¯ç”Ÿå‘½å‘¨æœŸæ—¶é—´è½´ï¼š

åˆ›å»ºé˜¶æ®µ     |    æ´»è·ƒé˜¶æ®µ    |    ç»“æŸé˜¶æ®µ
    â†“              â†“             â†“
[è¿æ¥å»ºç«‹] â†’ [æ­£å¸¸ä½¿ç”¨] â†’ [ä¸»åŠ¨å…³é—­/è¶…æ—¶]
    â†“              â†“             â†“
è·å¾—ä¼šè¯ID    å‘é€å¿ƒè·³åŒ…     é‡Šæ”¾èµ„æº
åˆ†é…èµ„æº     æ‰§è¡Œæ“ä½œ       æ¸…ç†ä¸´æ—¶èŠ‚ç‚¹
```

---

## 4. ğŸ’“ å¿ƒè·³æœºåˆ¶ä¸ä¼šè¯ä¿æŒ


### 4.1 å¿ƒè·³æœºåˆ¶çš„ä½œç”¨


**å¿ƒè·³å°±åƒäººçš„è„‰æ**ï¼Œè¯æ˜å®¢æˆ·ç«¯è¿˜"æ´»ç€"ã€‚å¦‚æœæœåŠ¡å™¨é•¿æ—¶é—´æ”¶ä¸åˆ°å®¢æˆ·ç«¯çš„å¿ƒè·³ï¼Œå°±è®¤ä¸ºå®¢æˆ·ç«¯å·²ç»"æ­»äº†"ï¼Œä¼šæ¸…ç†ç›¸å…³èµ„æºã€‚

```
å¿ƒè·³æœºåˆ¶å·¥ä½œåŸç†ï¼š

å®¢æˆ·ç«¯                        ZookeeperæœåŠ¡å™¨
  |                              |
  |â”€â”€â”€â”€ pingåŒ… (å¿ƒè·³) â”€â”€â”€â”€â”€â”€â”€â”€â†’   |
  |                              | âœ… æ”¶åˆ°å¿ƒè·³ï¼Œæ›´æ–°æœ€åæ´»è·ƒæ—¶é—´
  |                              |
  |â†â”€â”€â”€ pongåŒ… (å“åº”) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  |
  | âœ… æ”¶åˆ°å“åº”ï¼Œè¿æ¥æ­£å¸¸           |
  |                              |
  |     ... 30ç§’å ...           |
  |                              |
  |â”€â”€â”€â”€ pingåŒ… (å¿ƒè·³) â”€â”€â”€â”€â”€â”€â”€â”€â†’   |
  |                              |
```

### 4.2 å¿ƒè·³æ—¶é—´è®¡ç®—


```java
public class HeartbeatCalculator {
    
    // å¿ƒè·³æ—¶é—´è®¡ç®—å…¬å¼
    public static void calculateHeartbeat(int sessionTimeout) {
        // å¿ƒè·³é—´éš” = ä¼šè¯è¶…æ—¶æ—¶é—´ / 3
        int heartbeatInterval = sessionTimeout / 3;
        
        System.out.println("ğŸ“Š å¿ƒè·³å‚æ•°è®¡ç®—ï¼š");
        System.out.println("â±ï¸ ä¼šè¯è¶…æ—¶æ—¶é—´ï¼š" + sessionTimeout + "ms");
        System.out.println("ğŸ’“ å¿ƒè·³é—´éš”ï¼š" + heartbeatInterval + "ms");
        System.out.println("ğŸ”¢ è¶…æ—¶æ£€æµ‹æ¬¡æ•°ï¼šå¤§çº¦3æ¬¡å¿ƒè·³å¤±è´¥åè¶…æ—¶");
        
        // ç¤ºä¾‹ï¼šä¼šè¯è¶…æ—¶30ç§’ï¼Œå¿ƒè·³é—´éš”10ç§’
        // å¦‚æœè¿ç»­3æ¬¡å¿ƒè·³å¤±è´¥ï¼ˆ30ç§’ï¼‰ï¼Œä¼šè¯å°±è¶…æ—¶
    }
    
    public static void main(String[] args) {
        calculateHeartbeat(30000); // 30ç§’ä¼šè¯è¶…æ—¶
    }
}
```

### 4.3 å¿ƒè·³å¤±è´¥å¤„ç†


**âš ï¸ æ³¨æ„**ï¼šå¿ƒè·³å¤±è´¥é€šå¸¸æ„å‘³ç€ç½‘ç»œé—®é¢˜ï¼Œå®¢æˆ·ç«¯ä¼šè‡ªåŠ¨å¤„ç†ï¼š

```
å¿ƒè·³å¤±è´¥å¤„ç†æµç¨‹ï¼š

ç¬¬1æ¬¡å¿ƒè·³å¤±è´¥ â†’ è®°å½•å¤±è´¥ï¼Œç»§ç»­å°è¯•
ç¬¬2æ¬¡å¿ƒè·³å¤±è´¥ â†’ å¯èƒ½æ˜¯ç½‘ç»œæŠ–åŠ¨ï¼Œç»§ç»­å°è¯•  
ç¬¬3æ¬¡å¿ƒè·³å¤±è´¥ â†’ åˆ¤å®šè¿æ¥æ–­å¼€ï¼Œè§¦å‘é‡è¿
      â†“
è¿æ¥çŠ¶æ€å˜ä¸ºï¼šDISCONNECTED
      â†“
å¼€å§‹é‡è¿æµç¨‹ï¼šå°è¯•è¿æ¥å…¶ä»–æœåŠ¡å™¨
```

---

## 5. â° ä¼šè¯è¶…æ—¶å¤„ç†


### 5.1 ä»€ä¹ˆæ—¶å€™ä¼šè¯è¶…æ—¶


**ä¼šè¯è¶…æ—¶çš„è§¦å‘æ¡ä»¶**ï¼š
- **ğŸ’” å¿ƒè·³ä¸­æ–­**ï¼šå®¢æˆ·ç«¯åœæ­¢å‘é€å¿ƒè·³åŒ…
- **ğŸŒ ç½‘ç»œæ•…éšœ**ï¼šç½‘ç»œä¸­æ–­å¯¼è‡´é€šä¿¡å¤±è´¥
- **ğŸ’» å®¢æˆ·ç«¯å´©æºƒ**ï¼šåº”ç”¨ç¨‹åºå¼‚å¸¸é€€å‡º
- **â±ï¸ æ—¶é—´åˆ°æœŸ**ï¼šè¶…è¿‡è®¾å®šçš„è¶…æ—¶æ—¶é—´

```
ä¼šè¯è¶…æ—¶åˆ¤æ–­é€»è¾‘ï¼š

æœåŠ¡å™¨ç«¯æ£€æŸ¥æµç¨‹ï¼š
    â†“
æ£€æŸ¥ä¸Šæ¬¡å¿ƒè·³æ—¶é—´
    â†“
è®¡ç®—æ—¶é—´é—´éš”ï¼šå½“å‰æ—¶é—´ - ä¸Šæ¬¡å¿ƒè·³æ—¶é—´
    â†“
åˆ¤æ–­ï¼šæ—¶é—´é—´éš” > ä¼šè¯è¶…æ—¶æ—¶é—´ï¼Ÿ
    â†“
Yes â†’ ä¼šè¯è¶…æ—¶ï¼Œæ¸…ç†èµ„æº
No â†’ ä¼šè¯æ­£å¸¸ï¼Œç»§ç»­ç­‰å¾…
```

### 5.2 è¶…æ—¶åçš„æ¸…ç†å·¥ä½œ


```java
// æ¨¡æ‹Ÿä¼šè¯è¶…æ—¶åçš„æ¸…ç†å·¥ä½œ
public class SessionTimeoutHandler {
    
    public void handleSessionTimeout(long sessionId) {
        System.out.println("âš ï¸ ä¼šè¯è¶…æ—¶å¤„ç†å¼€å§‹ï¼Œä¼šè¯IDï¼š" + Long.toHexString(sessionId));
        
        // 1. æ¸…ç†ä¸´æ—¶èŠ‚ç‚¹
        cleanupEphemeralNodes(sessionId);
        
        // 2. é‡Šæ”¾watcher
        cleanupWatchers(sessionId);
        
        // 3. æ¸…ç†ä¼šè¯æ•°æ®
        cleanupSessionData(sessionId);
        
        System.out.println("âœ… ä¼šè¯è¶…æ—¶å¤„ç†å®Œæˆ");
    }
    
    private void cleanupEphemeralNodes(long sessionId) {
        System.out.println("ğŸ—‘ï¸ åˆ é™¤ä¸´æ—¶èŠ‚ç‚¹...");
        // åˆ é™¤è¯¥ä¼šè¯åˆ›å»ºçš„æ‰€æœ‰ä¸´æ—¶èŠ‚ç‚¹
        // è¿™äº›èŠ‚ç‚¹ä¼šè‡ªåŠ¨ä»Zookeeperä¸­åˆ é™¤
    }
    
    private void cleanupWatchers(long sessionId) {
        System.out.println("ğŸ‘ï¸ æ¸…ç†ç›‘å¬å™¨...");
        // ç§»é™¤è¯¥ä¼šè¯æ³¨å†Œçš„æ‰€æœ‰watcher
    }
    
    private void cleanupSessionData(long sessionId) {
        System.out.println("ğŸ“¦ æ¸…ç†ä¼šè¯æ•°æ®...");
        // é‡Šæ”¾ä¼šè¯ç›¸å…³çš„å†…å­˜å’Œèµ„æº
    }
}
```

### 5.3 å®¢æˆ·ç«¯è¶…æ—¶æ„ŸçŸ¥


```java
public class SessionTimeoutDemo {
    
    public void demonstrateTimeout() throws Exception {
        ZooKeeper zk = new ZooKeeper("localhost:2181", 3000, event -> {
            if (event.getState() == KeeperState.Expired) {
                System.out.println("ğŸ’¥ ä¼šè¯å·²è¶…æ—¶ï¼éœ€è¦é‡æ–°è¿æ¥");
                // ä¼šè¯è¶…æ—¶åï¼Œéœ€è¦åˆ›å»ºæ–°çš„ZooKeeperå®ä¾‹
                reconnect();
            }
        });
        
        // åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹æµ‹è¯•
        String path = zk.create("/temp", "data".getBytes(), 
                              ZooDefs.Ids.OPEN_ACL_UNSAFE, 
                              CreateMode.EPHEMERAL);
        System.out.println("âœ… åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹ï¼š" + path);
        
        // æ¨¡æ‹Ÿé•¿æ—¶é—´æ“ä½œï¼Œå¯èƒ½å¯¼è‡´è¶…æ—¶
        Thread.sleep(10000); // ç¡çœ 10ç§’
    }
    
    private void reconnect() {
        System.out.println("ğŸ”„ å¼€å§‹é‡æ–°è¿æ¥...");
        // åˆ›å»ºæ–°çš„ZooKeeperå®ä¾‹
        // æ³¨æ„ï¼šä¸´æ—¶èŠ‚ç‚¹å·²ç»è¢«æœåŠ¡å™¨åˆ é™¤äº†
    }
}
```

**ğŸš¨ é‡è¦**ï¼šä¼šè¯è¶…æ—¶åï¼Œå®¢æˆ·ç«¯å¿…é¡»åˆ›å»ºæ–°çš„ZooKeeperå®ä¾‹ï¼Œä¸èƒ½å¤ç”¨æ—§çš„è¿æ¥ã€‚

---

## 6. ğŸ”„ è¿æ¥é‡è¯•ç­–ç•¥


### 6.1 ä¸ºä»€ä¹ˆéœ€è¦é‡è¯•


**ç½‘ç»œä¸–ç•Œå……æ»¡ä¸ç¡®å®šæ€§**ï¼š
- **ğŸ“¡ ç½‘ç»œæŠ–åŠ¨**ï¼šçŸ­æš‚çš„ç½‘ç»œä¸ç¨³å®š
- **ğŸ”§ æœåŠ¡å™¨ç»´æŠ¤**ï¼šæŸå°æœåŠ¡å™¨ä¸´æ—¶ä¸‹çº¿
- **âš¡ è´Ÿè½½é«˜å³°**ï¼šæœåŠ¡å™¨ç¹å¿™æš‚æ—¶æ— å“åº”
- **ğŸŒ DNSè§£æé—®é¢˜**ï¼šåŸŸåè§£æä¸´æ—¶å¤±è´¥

é‡è¯•æœºåˆ¶å°±åƒåšæŒæ•²é—¨ï¼Œå¦‚æœä¸€æ¬¡æ²¡äººå¼€é—¨ï¼Œè¿‡ä¸€ä¼šå„¿å†æ•²ï¼Œç›´åˆ°æœ‰äººå¼€é—¨æˆ–ç¡®å®šæ²¡äººåœ¨å®¶ã€‚

### 6.2 é‡è¯•ç­–ç•¥ç±»å‹


```java
// ä¸åŒçš„é‡è¯•ç­–ç•¥å®ç°
public class RetryStrategies {
    
    // 1ï¸âƒ£ å›ºå®šé—´éš”é‡è¯•
    public static class FixedIntervalRetry {
        private final int retryTimes;
        private final long sleepTime;
        
        public FixedIntervalRetry(int retryTimes, long sleepTime) {
            this.retryTimes = retryTimes; // é‡è¯•æ¬¡æ•°
            this.sleepTime = sleepTime;   // æ¯æ¬¡é—´éš”æ—¶é—´
        }
        
        public void retry() throws InterruptedException {
            for (int i = 0; i < retryTimes; i++) {
                System.out.println("ğŸ”„ ç¬¬" + (i + 1) + "æ¬¡é‡è¯•...");
                Thread.sleep(sleepTime); // å›ºå®šç­‰å¾…æ—¶é—´
                
                if (tryConnect()) {
                    System.out.println("âœ… é‡è¯•æˆåŠŸï¼");
                    return;
                }
            }
            System.out.println("âŒ é‡è¯•å¤±è´¥ï¼Œå·²è¾¾æœ€å¤§æ¬¡æ•°");
        }
    }
    
    // 2ï¸âƒ£ æŒ‡æ•°é€€é¿é‡è¯•ï¼ˆæ¨èï¼‰
    public static class ExponentialBackoffRetry {
        private final int maxRetries;
        private final long baseSleepTime;
        
        public ExponentialBackoffRetry(int maxRetries, long baseSleepTime) {
            this.maxRetries = maxRetries;
            this.baseSleepTime = baseSleepTime;
        }
        
        public void retry() throws InterruptedException {
            for (int i = 0; i < maxRetries; i++) {
                // ç­‰å¾…æ—¶é—´æŒ‡æ•°å¢é•¿ï¼š1ç§’ã€2ç§’ã€4ç§’ã€8ç§’...
                long sleepTime = baseSleepTime * (1L << i);
                
                System.out.println("ğŸ”„ ç¬¬" + (i + 1) + "æ¬¡é‡è¯•ï¼Œç­‰å¾…" + sleepTime + "ms");
                Thread.sleep(sleepTime);
                
                if (tryConnect()) {
                    System.out.println("âœ… é‡è¯•æˆåŠŸï¼");
                    return;
                }
            }
            System.out.println("âŒ é‡è¯•å¤±è´¥ï¼Œå·²è¾¾æœ€å¤§æ¬¡æ•°");
        }
    }
    
    // æ¨¡æ‹Ÿè¿æ¥å°è¯•
    private static boolean tryConnect() {
        // æ¨¡æ‹Ÿ70%çš„æˆåŠŸç‡
        return Math.random() > 0.3;
    }
}
```

### 6.3 Curatoræ¡†æ¶çš„é‡è¯•ç­–ç•¥


```java
// ä½¿ç”¨Curatoræ¡†æ¶çš„é‡è¯•ç­–ç•¥ï¼ˆæ¨èï¼‰
public class CuratorRetryDemo {
    
    public void demonstrateCuratorRetry() throws Exception {
        // æŒ‡æ•°é€€é¿é‡è¯•ï¼šæœ€å¤šé‡è¯•3æ¬¡ï¼ŒåŸºç¡€é—´éš”1ç§’ï¼Œæœ€å¤§é—´éš”10ç§’
        RetryPolicy retryPolicy = new ExponentialBackoffRetry(1000, 3, 10000);
        
        CuratorFramework client = CuratorFrameworkFactory.builder()
                .connectString("localhost:2181")
                .sessionTimeoutMs(30000)
                .retryPolicy(retryPolicy)  // è®¾ç½®é‡è¯•ç­–ç•¥
                .build();
        
        client.start();
        
        // Curatorä¼šè‡ªåŠ¨å¤„ç†è¿æ¥é‡è¯•
        System.out.println("ğŸ‰ Curatorå®¢æˆ·ç«¯å¯åŠ¨æˆåŠŸï¼");
    }
}
```

**ğŸ’¡ æœ€ä½³å®è·µ**ï¼šä½¿ç”¨æŒ‡æ•°é€€é¿é‡è¯•ç­–ç•¥ï¼Œé¿å…åœ¨æœåŠ¡å™¨å‹åŠ›å¤§æ—¶åŠ å‰§é—®é¢˜ã€‚

---

## 7. ğŸ‘ï¸ çŠ¶æ€ç›‘å¬æœºåˆ¶


### 7.1 è¿æ¥çŠ¶æ€ç›‘å¬çš„é‡è¦æ€§


**ä¸ºä»€ä¹ˆè¦ç›‘å¬çŠ¶æ€ï¼Ÿ**
æƒ³è±¡ä½ åœ¨ä½¿ç”¨æ‰‹æœºï¼ŒçŠ¶æ€æ ä¼šæ˜¾ç¤ºä¿¡å·å¼ºåº¦ã€ç”µæ± ç”µé‡ç­‰ä¿¡æ¯ã€‚åŒæ ·ï¼ŒZookeeperå®¢æˆ·ç«¯ä¹Ÿéœ€è¦çŸ¥é“è¿æ¥çŠ¶æ€ï¼Œä»¥ä¾¿åšå‡ºç›¸åº”çš„å¤„ç†ã€‚

```
çŠ¶æ€ç›‘å¬çš„ä»·å€¼ï¼š

ğŸ“± æ‰‹æœºçŠ¶æ€æ                ğŸ”— ZookeeperçŠ¶æ€ç›‘å¬
    â†“                            â†“
ä¿¡å·å¼ºåº¦æ˜¾ç¤º                 è¿æ¥çŠ¶æ€æ˜¾ç¤º
ç”µæ± ç”µé‡æ˜¾ç¤º                 ä¼šè¯çŠ¶æ€æ˜¾ç¤º
ç½‘ç»œç±»å‹æ˜¾ç¤º                 æœåŠ¡å™¨çŠ¶æ€æ˜¾ç¤º
    â†“                            â†“
ç”¨æˆ·æ®æ­¤å†³å®šè¡ŒåŠ¨              åº”ç”¨æ®æ­¤å†³å®šç­–ç•¥
```

### 7.2 è¿æ¥çŠ¶æ€ç±»å‹


```java
public class ConnectionStates {
    
    public void explainConnectionStates() {
        System.out.println("ğŸ”— Zookeeperè¿æ¥çŠ¶æ€è¯´æ˜ï¼š");
        System.out.println();
        
        System.out.println("ğŸ“ NOT_CONNECTED");
        System.out.println("   å«ä¹‰ï¼šè¿˜æ²¡å¼€å§‹è¿æ¥");
        System.out.println("   æ“ä½œï¼šä¸èƒ½æ‰§è¡Œä»»ä½•Zookeeperæ“ä½œ");
        System.out.println();
        
        System.out.println("ğŸ”„ CONNECTING");
        System.out.println("   å«ä¹‰ï¼šæ­£åœ¨å°è¯•å»ºç«‹è¿æ¥");
        System.out.println("   æ“ä½œï¼šç­‰å¾…è¿æ¥å®Œæˆ");
        System.out.println();
        
        System.out.println("âœ… CONNECTED");
        System.out.println("   å«ä¹‰ï¼šè¿æ¥æˆåŠŸï¼Œä¼šè¯æ­£å¸¸");
        System.out.println("   æ“ä½œï¼šå¯ä»¥æ­£å¸¸ä½¿ç”¨æ‰€æœ‰åŠŸèƒ½");
        System.out.println();
        
        System.out.println("âš ï¸ DISCONNECTED");
        System.out.println("   å«ä¹‰ï¼šè¿æ¥æ–­å¼€ï¼Œä½†ä¼šè¯è¿˜åœ¨");
        System.out.println("   æ“ä½œï¼šç­‰å¾…é‡è¿ï¼Œä¸èƒ½æ‰§è¡Œæ“ä½œ");
        System.out.println();
        
        System.out.println("ğŸ”„ RECONNECTING");
        System.out.println("   å«ä¹‰ï¼šæ­£åœ¨é‡æ–°è¿æ¥");
        System.out.println("   æ“ä½œï¼šç­‰å¾…é‡è¿å®Œæˆ");
        System.out.println();
        
        System.out.println("ğŸ’¥ EXPIRED");
        System.out.println("   å«ä¹‰ï¼šä¼šè¯å·²è¿‡æœŸ");
        System.out.println("   æ“ä½œï¼šå¿…é¡»åˆ›å»ºæ–°çš„ZooKeeperå®ä¾‹");
        System.out.println();
        
        System.out.println("ğŸšª CLOSED");
        System.out.println("   å«ä¹‰ï¼šè¿æ¥å·²å…³é—­");
        System.out.println("   æ“ä½œï¼šä¸èƒ½å†ä½¿ç”¨ï¼Œéœ€è¦é‡æ–°åˆ›å»º");
    }
}
```

### 7.3 å®ç°çŠ¶æ€ç›‘å¬å™¨


```java
public class ConnectionStateListener implements Watcher {
    private final CountDownLatch connectedLatch = new CountDownLatch(1);
    private volatile boolean connected = false;
    
    @Override
    public void process(WatchedEvent event) {
        System.out.println("ğŸ“¢ æ”¶åˆ°çŠ¶æ€å˜åŒ–äº‹ä»¶ï¼š" + event.getState());
        
        switch (event.getState()) {
            case SyncConnected:
                handleConnected();
                break;
                
            case Disconnected:
                handleDisconnected();
                break;
                
            case Expired:
                handleExpired();
                break;
                
            case ConnectedReadOnly:
                handleReadOnlyConnected();
                break;
                
            default:
                System.out.println("ğŸ¤” æœªçŸ¥çŠ¶æ€ï¼š" + event.getState());
        }
    }
    
    private void handleConnected() {
        System.out.println("âœ… è¿æ¥å»ºç«‹æˆåŠŸï¼");
        connected = true;
        connectedLatch.countDown(); // é€šçŸ¥ç­‰å¾…çš„çº¿ç¨‹
        
        // å¯ä»¥åœ¨è¿™é‡Œæ‰§è¡Œè¿æ¥æˆåŠŸåçš„åˆå§‹åŒ–æ“ä½œ
        initializeAfterConnection();
    }
    
    private void handleDisconnected() {
        System.out.println("âš ï¸ è¿æ¥æ–­å¼€ï¼æ­£åœ¨é‡è¿...");
        connected = false;
        
        // å¯ä»¥åœ¨è¿™é‡Œæš‚åœä¸€äº›æ“ä½œï¼Œç­‰å¾…é‡è¿
        pauseOperations();
    }
    
    private void handleExpired() {
        System.out.println("ğŸ’¥ ä¼šè¯è¿‡æœŸï¼éœ€è¦é‡æ–°åˆ›å»ºè¿æ¥");
        connected = false;
        
        // ä¼šè¯è¿‡æœŸéœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œé€šå¸¸éœ€è¦é‡æ–°åˆ›å»ºZooKeeperå®ä¾‹
        handleSessionExpiration();
    }
    
    private void handleReadOnlyConnected() {
        System.out.println("ğŸ“– è¿æ¥åˆ°åªè¯»æœåŠ¡å™¨");
        connected = true;
        
        // åªè¯»æ¨¡å¼ä¸‹åªèƒ½è¯»å–æ•°æ®ï¼Œä¸èƒ½ä¿®æ”¹
        switchToReadOnlyMode();
    }
    
    // ç­‰å¾…è¿æ¥å»ºç«‹
    public boolean waitForConnection(long timeout, TimeUnit unit) 
            throws InterruptedException {
        return connectedLatch.await(timeout, unit);
    }
    
    public boolean isConnected() {
        return connected;
    }
    
    // è¾…åŠ©æ–¹æ³•
    private void initializeAfterConnection() {
        System.out.println("ğŸ”§ æ‰§è¡Œè¿æ¥ååˆå§‹åŒ–...");
    }
    
    private void pauseOperations() {
        System.out.println("â¸ï¸ æš‚åœæ“ä½œç­‰å¾…é‡è¿...");
    }
    
    private void handleSessionExpiration() {
        System.out.println("ğŸ”„ å¤„ç†ä¼šè¯è¿‡æœŸï¼Œå‡†å¤‡é‡å»ºè¿æ¥...");
    }
    
    private void switchToReadOnlyMode() {
        System.out.println("ğŸ“– åˆ‡æ¢åˆ°åªè¯»æ¨¡å¼...");
    }
}
```

### 7.4 ä½¿ç”¨çŠ¶æ€ç›‘å¬å™¨


```java
public class StateListenerDemo {
    
    public void demonstrateStateListener() throws Exception {
        ConnectionStateListener listener = new ConnectionStateListener();
        
        // åˆ›å»ºZooKeeperå®ä¾‹ï¼Œä¼ å…¥çŠ¶æ€ç›‘å¬å™¨
        ZooKeeper zk = new ZooKeeper("localhost:2181", 30000, listener);
        
        // ç­‰å¾…è¿æ¥å»ºç«‹ï¼ˆæœ€å¤šç­‰å¾…10ç§’ï¼‰
        if (listener.waitForConnection(10, TimeUnit.SECONDS)) {
            System.out.println("ğŸ‰ è¿æ¥å»ºç«‹æˆåŠŸï¼Œå¯ä»¥å¼€å§‹æ“ä½œäº†ï¼");
            
            // æ‰§è¡Œä¸€äº›æ“ä½œ
            performOperations(zk, listener);
            
        } else {
            System.out.println("âŒ è¿æ¥è¶…æ—¶å¤±è´¥");
        }
        
        // å…³é—­è¿æ¥
        zk.close();
    }
    
    private void performOperations(ZooKeeper zk, ConnectionStateListener listener) 
            throws Exception {
        
        // åœ¨æ‰§è¡Œæ“ä½œå‰æ£€æŸ¥è¿æ¥çŠ¶æ€
        if (!listener.isConnected()) {
            System.out.println("âš ï¸ è¿æ¥æœªå°±ç»ªï¼Œæ“ä½œè¢«è·³è¿‡");
            return;
        }
        
        try {
            // åˆ›å»ºèŠ‚ç‚¹
            String path = zk.create("/test", "hello".getBytes(), 
                                  ZooDefs.Ids.OPEN_ACL_UNSAFE, 
                                  CreateMode.EPHEMERAL);
            System.out.println("âœ… åˆ›å»ºèŠ‚ç‚¹æˆåŠŸï¼š" + path);
            
            // è¯»å–èŠ‚ç‚¹æ•°æ®
            byte[] data = zk.getData("/test", false, null);
            System.out.println("ğŸ“– è¯»å–æ•°æ®ï¼š" + new String(data));
            
        } catch (KeeperException e) {
            if (e.code() == KeeperException.Code.CONNECTIONLOSS) {
                System.out.println("ğŸ“¡ ç½‘ç»œè¿æ¥ä¸¢å¤±ï¼Œæ“ä½œå¤±è´¥");
            } else {
                System.out.println("âŒ æ“ä½œå¤±è´¥ï¼š" + e.getMessage());
            }
        }
    }
    
    public static void main(String[] args) throws Exception {
        StateListenerDemo demo = new StateListenerDemo();
        demo.demonstrateStateListener();
    }
}
```

---

## 8. ğŸ› ï¸ å®é™…åº”ç”¨ä¸æœ€ä½³å®è·µ


### 8.1 ç”Ÿäº§ç¯å¢ƒè¿æ¥é…ç½®


```java
public class ProductionZookeeperConfig {
    
    // ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®
    public static ZooKeeper createProductionClient() throws Exception {
        
        // 1ï¸âƒ£ è¿æ¥å­—ç¬¦ä¸²ï¼šé…ç½®å¤šä¸ªæœåŠ¡å™¨ä¿è¯é«˜å¯ç”¨
        String connectString = "zk1.example.com:2181,zk2.example.com:2181,zk3.example.com:2181";
        
        // 2ï¸âƒ£ ä¼šè¯è¶…æ—¶ï¼š30ç§’ï¼ˆå¹³è¡¡æ•…éšœæ£€æµ‹é€Ÿåº¦å’Œç½‘ç»œæ³¢åŠ¨å®¹å¿åº¦ï¼‰
        int sessionTimeout = 30000;
        
        // 3ï¸âƒ£ åˆ›å»ºä¸“ä¸šçš„çŠ¶æ€ç›‘å¬å™¨
        ProductionStateWatcher watcher = new ProductionStateWatcher();
        
        ZooKeeper zk = new ZooKeeper(connectString, sessionTimeout, watcher);
        
        // 4ï¸âƒ£ ç­‰å¾…è¿æ¥å»ºç«‹ï¼Œè®¾ç½®åˆç†è¶…æ—¶æ—¶é—´
        if (!watcher.waitForConnection(30, TimeUnit.SECONDS)) {
            throw new Exception("Zookeeperè¿æ¥å»ºç«‹è¶…æ—¶");
        }
        
        System.out.println("âœ… ç”Ÿäº§ç¯å¢ƒZookeeperå®¢æˆ·ç«¯åˆ›å»ºæˆåŠŸ");
        return zk;
    }
    
    // ç”Ÿäº§ç¯å¢ƒçŠ¶æ€ç›‘å¬å™¨
    static class ProductionStateWatcher implements Watcher {
        private final CountDownLatch connectedLatch = new CountDownLatch(1);
        private volatile ZooKeeper.States currentState;
        
        @Override
        public void process(WatchedEvent event) {
            currentState = event.getState();
            
            switch (event.getState()) {
                case SyncConnected:
                    System.out.println("ğŸ“— [ç”Ÿäº§] è¿æ¥æ­£å¸¸");
                    connectedLatch.countDown();
                    break;
                    
                case Disconnected:
                    System.out.println("ğŸ“™ [ç”Ÿäº§] è¿æ¥æ–­å¼€ï¼Œç­‰å¾…é‡è¿");
                    // è®°å½•æ—¥å¿—ï¼Œå¯èƒ½å‘é€å‘Šè­¦
                    logConnectionIssue("DISCONNECTED");
                    break;
                    
                case Expired:
                    System.out.println("ğŸ“• [ç”Ÿäº§] ä¼šè¯è¿‡æœŸï¼Œéœ€è¦é‡å»ºè¿æ¥");
                    // å‘é€ä¸¥é‡å‘Šè­¦
                    alertSessionExpired();
                    break;
                    
                default:
                    System.out.println("ğŸ“˜ [ç”Ÿäº§] çŠ¶æ€å˜åŒ–ï¼š" + event.getState());
            }
        }
        
        public boolean waitForConnection(long timeout, TimeUnit unit) 
                throws InterruptedException {
            return connectedLatch.await(timeout, unit);
        }
        
        private void logConnectionIssue(String issue) {
            // è®°å½•åˆ°æ—¥å¿—ç³»ç»Ÿ
            System.out.println("ğŸ” è®°å½•è¿æ¥é—®é¢˜ï¼š" + issue + " at " + new Date());
        }
        
        private void alertSessionExpired() {
            // å‘é€å‘Šè­¦åˆ°ç›‘æ§ç³»ç»Ÿ
            System.out.println("ğŸš¨ å‘é€ä¼šè¯è¿‡æœŸå‘Šè­¦");
        }
    }
}
```

### 8.2 è¿æ¥æ± ç®¡ç†


```java
public class ZookeeperConnectionPool {
    private final String connectString;
    private final int sessionTimeout;
    private final Queue<ZooKeeper> availableConnections = new ConcurrentLinkedQueue<>();
    private final Set<ZooKeeper> allConnections = new ConcurrentHashMap<ZooKeeper, Boolean>().keySet();
    private final int maxConnections;
    
    public ZookeeperConnectionPool(String connectString, int sessionTimeout, int maxConnections) {
        this.connectString = connectString;
        this.sessionTimeout = sessionTimeout;
        this.maxConnections = maxConnections;
        
        // åˆå§‹åŒ–è¿æ¥æ± 
        initializePool();
    }
    
    private void initializePool() {
        System.out.println("ğŸŠ åˆå§‹åŒ–Zookeeperè¿æ¥æ± ...");
        
        // é¢„åˆ›å»ºä¸€äº›è¿æ¥
        for (int i = 0; i < Math.min(3, maxConnections); i++) {
            try {
                ZooKeeper zk = createConnection();
                availableConnections.offer(zk);
                allConnections.add(zk);
                System.out.println("âœ… é¢„åˆ›å»ºè¿æ¥ " + (i + 1) + " æˆåŠŸ");
            } catch (Exception e) {
                System.out.println("âŒ é¢„åˆ›å»ºè¿æ¥å¤±è´¥ï¼š" + e.getMessage());
            }
        }
    }
    
    // è·å–è¿æ¥
    public ZooKeeper borrowConnection() throws Exception {
        ZooKeeper zk = availableConnections.poll();
        
        if (zk == null && allConnections.size() < maxConnections) {
            // è¿æ¥æ± æœªæ»¡ï¼Œåˆ›å»ºæ–°è¿æ¥
            zk = createConnection();
            allConnections.add(zk);
        }
        
        if (zk != null && zk.getState() == ZooKeeper.States.CONNECTED) {
            return zk;
        }
        
        throw new Exception("æ— æ³•è·å–æœ‰æ•ˆçš„Zookeeperè¿æ¥");
    }
    
    // å½’è¿˜è¿æ¥
    public void returnConnection(ZooKeeper zk) {
        if (zk != null && zk.getState() == ZooKeeper.States.CONNECTED) {
            availableConnections.offer(zk);
        } else {
            // è¿æ¥å·²å¤±æ•ˆï¼Œä»è¿æ¥æ± ç§»é™¤
            allConnections.remove(zk);
            try {
                if (zk != null) zk.close();
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        }
    }
    
    private ZooKeeper createConnection() throws Exception {
        CountDownLatch latch = new CountDownLatch(1);
        
        ZooKeeper zk = new ZooKeeper(connectString, sessionTimeout, event -> {
            if (event.getState() == Watcher.Event.KeeperState.SyncConnected) {
                latch.countDown();
            }
        });
        
        if (!latch.await(10, TimeUnit.SECONDS)) {
            zk.close();
            throw new Exception("è¿æ¥åˆ›å»ºè¶…æ—¶");
        }
        
        return zk;
    }
    
    // å…³é—­è¿æ¥æ± 
    public void closePool() {
        System.out.println("ğŸ”’ å…³é—­Zookeeperè¿æ¥æ± ...");
        
        for (ZooKeeper zk : allConnections) {
            try {
                zk.close();
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        }
        
        allConnections.clear();
        availableConnections.clear();
    }
}
```

### 8.3 é”™è¯¯å¤„ç†æœ€ä½³å®è·µ


```java
public class ZookeeperErrorHandling {
    
    // é€šç”¨æ“ä½œé‡è¯•åŒ…è£…å™¨
    public static <T> T executeWithRetry(ZookeeperOperation<T> operation, 
                                        int maxRetries) throws Exception {
        
        Exception lastException = null;
        
        for (int i = 0; i < maxRetries; i++) {
            try {
                return operation.execute();
                
            } catch (KeeperException.ConnectionLossException e) {
                System.out.println("ğŸ“¡ è¿æ¥ä¸¢å¤±ï¼Œé‡è¯• " + (i + 1) + "/" + maxRetries);
                lastException = e;
                Thread.sleep(1000 * (i + 1)); // é€’å¢å»¶è¿Ÿ
                
            } catch (KeeperException.SessionExpiredException e) {
                System.out.println("ğŸ’¥ ä¼šè¯è¿‡æœŸï¼Œæ— æ³•é‡è¯•");
                throw e; // ä¼šè¯è¿‡æœŸä¸èƒ½é‡è¯•
                
            } catch (KeeperException e) {
                if (e.code() == KeeperException.Code.NODEEXISTS) {
                    System.out.println("ğŸ“ èŠ‚ç‚¹å·²å­˜åœ¨ï¼Œè¿™å¯èƒ½æ˜¯æ­£å¸¸æƒ…å†µ");
                    throw e; // ä¸šåŠ¡é€»è¾‘é”™è¯¯ï¼Œä¸é‡è¯•
                }
                
                System.out.println("âŒ å…¶ä»–Zookeeperé”™è¯¯ï¼š" + e.getMessage());
                lastException = e;
                Thread.sleep(1000);
            }
        }
        
        throw new Exception("æ“ä½œå¤±è´¥ï¼Œå·²é‡è¯•" + maxRetries + "æ¬¡", lastException);
    }
    
    // æ“ä½œæ¥å£å®šä¹‰
    @FunctionalInterface
    interface ZookeeperOperation<T> {
        T execute() throws KeeperException, InterruptedException;
    }
    
    // ä½¿ç”¨ç¤ºä¾‹
    public void demonstrateErrorHandling(ZooKeeper zk) throws Exception {
        
        // åˆ›å»ºèŠ‚ç‚¹çš„å¯é æ“ä½œ
        String result = executeWithRetry(() -> {
            return zk.create("/reliable-node", "data".getBytes(),
                           ZooDefs.Ids.OPEN_ACL_UNSAFE, 
                           CreateMode.PERSISTENT);
        }, 3);
        
        System.out.println("âœ… å¯é åˆ›å»ºèŠ‚ç‚¹æˆåŠŸï¼š" + result);
        
        // è¯»å–æ•°æ®çš„å¯é æ“ä½œ
        byte[] data = executeWithRetry(() -> {
            return zk.getData("/reliable-node", false, null);
        }, 3);
        
        System.out.println("ğŸ“– å¯é è¯»å–æ•°æ®ï¼š" + new String(data));
    }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ è¿æ¥ç®¡ç†ï¼šå»ºç«‹è¿æ¥â†’ä¿æŒè¿æ¥â†’å¤„ç†å¼‚å¸¸â†’å…³é—­è¿æ¥çš„å®Œæ•´æµç¨‹
ğŸ”¸ ä¼šè¯æœºåˆ¶ï¼šä¼šè¯IDæ˜¯å®¢æˆ·ç«¯èº«ä»½è¯ï¼Œç”¨äºæœåŠ¡å™¨è¯†åˆ«å’Œèµ„æºç®¡ç†
ğŸ”¸ å¿ƒè·³æœºåˆ¶ï¼šå®¢æˆ·ç«¯å®šæœŸå‘é€å¿ƒè·³è¯æ˜å­˜æ´»ï¼Œé—´éš”ä¸ºä¼šè¯è¶…æ—¶æ—¶é—´çš„1/3
ğŸ”¸ ä¼šè¯è¶…æ—¶ï¼šè¶…æ—¶åæœåŠ¡å™¨æ¸…ç†èµ„æºï¼Œå®¢æˆ·ç«¯å¿…é¡»é‡æ–°åˆ›å»ºZooKeeperå®ä¾‹
ğŸ”¸ è¿æ¥é‡è¯•ï¼šç½‘ç»œå¼‚å¸¸æ—¶è‡ªåŠ¨é‡è¯•è¿æ¥ï¼Œæ¨èæŒ‡æ•°é€€é¿ç­–ç•¥
ğŸ”¸ çŠ¶æ€ç›‘å¬ï¼šé€šè¿‡Watcherç›‘å¬è¿æ¥çŠ¶æ€å˜åŒ–ï¼ŒåŠæ—¶å¤„ç†å„ç§æƒ…å†µ
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ è¿æ¥vsä¼šè¯çš„åŒºåˆ«**
```
è¿æ¥ï¼ˆConnectionï¼‰ï¼š
- ç‰©ç†æ¦‚å¿µï¼šTCPè¿æ¥é€šé“
- å¯èƒ½æ–­å¼€é‡è¿ï¼šç½‘ç»œæŠ–åŠ¨æ—¶è¿æ¥æ–­å¼€ä½†ä¼šè¯ä¿æŒ
- çŠ¶æ€å¤šæ ·ï¼šCONNECTINGã€CONNECTEDã€DISCONNECTEDç­‰

ä¼šè¯ï¼ˆSessionï¼‰ï¼š
- é€»è¾‘æ¦‚å¿µï¼šå®¢æˆ·ç«¯åœ¨æœåŠ¡å™¨ç«¯çš„èº«ä»½å’ŒçŠ¶æ€
- æœ‰è¶…æ—¶æœºåˆ¶ï¼šè¶…æ—¶åå½»åº•å¤±æ•ˆï¼Œéœ€è¦é‡æ–°åˆ›å»º
- èµ„æºç®¡ç†ï¼šæ§åˆ¶ä¸´æ—¶èŠ‚ç‚¹ã€watcherç­‰èµ„æºçš„ç”Ÿå‘½å‘¨æœŸ
```

**ğŸ”¹ å¿ƒè·³æœºåˆ¶çš„å·¥ä½œåŸç†**
```
ä¸ºä»€ä¹ˆéœ€è¦å¿ƒè·³ï¼š
- ç½‘ç»œå¯èƒ½æ–­å¼€ä½†TCPè¿æ¥æ²¡æœ‰ç«‹å³æ„ŸçŸ¥
- å®¢æˆ·ç«¯å¯èƒ½å´©æºƒä½†æœåŠ¡å™¨ä¸çŸ¥é“
- éœ€è¦å®šæœŸç¡®è®¤å®¢æˆ·ç«¯è¿˜æ´»ç€

å¿ƒè·³å·¥ä½œæ–¹å¼ï¼š
- è‡ªåŠ¨å‘é€ï¼šå®¢æˆ·ç«¯è‡ªåŠ¨å®šæœŸå‘é€pingåŒ…
- æœåŠ¡å™¨å“åº”ï¼šæœåŠ¡å™¨æ”¶åˆ°åå›å¤pongåŒ…
- è¶…æ—¶æ£€æµ‹ï¼šå¦‚æœå¤šæ¬¡å¿ƒè·³å¤±è´¥ï¼Œåˆ¤å®šä¼šè¯è¶…æ—¶
```

**ğŸ”¹ é‡è¯•ç­–ç•¥çš„é€‰æ‹©**
```
å›ºå®šé—´éš”é‡è¯•ï¼š
- é€‚ç”¨åœºæ™¯ï¼šçŸ­æš‚ç½‘ç»œæŠ–åŠ¨
- é£é™©ï¼šå¯èƒ½åŠ å‰§æœåŠ¡å™¨å‹åŠ›

æŒ‡æ•°é€€é¿é‡è¯•ï¼š
- é€‚ç”¨åœºæ™¯ï¼šæœåŠ¡å™¨è´Ÿè½½é«˜æˆ–é•¿æ—¶é—´æ•…éšœ
- ä¼˜åŠ¿ï¼šç»™æœåŠ¡å™¨æ¢å¤æ—¶é—´ï¼Œé¿å…é›ªå´©æ•ˆåº”
- æ¨èï¼šç”Ÿäº§ç¯å¢ƒä¼˜å…ˆé€‰æ‹©
```

### 9.3 ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ


**âš ï¸ é‡è¦é…ç½®**
- **è¿æ¥å­—ç¬¦ä¸²**ï¼šé…ç½®å¤šä¸ªZookeeperæœåŠ¡å™¨åœ°å€
- **ä¼šè¯è¶…æ—¶**ï¼šæ¨è30000msï¼Œå¹³è¡¡æ•…éšœæ£€æµ‹é€Ÿåº¦å’Œå®¹é”™æ€§
- **çŠ¶æ€ç›‘å¬**ï¼šå¿…é¡»å®ç°å®Œæ•´çš„çŠ¶æ€ç›‘å¬å’Œå¤„ç†é€»è¾‘

**ğŸš¨ é¿å…å¸¸è§é”™è¯¯**
- **ä¸è¦å¿½ç•¥ä¼šè¯è¿‡æœŸ**ï¼šä¼šè¯è¿‡æœŸåå¿…é¡»é‡æ–°åˆ›å»ºZooKeeperå®ä¾‹
- **ä¸è¦é˜»å¡Watcher**ï¼šäº‹ä»¶å¤„ç†è¦å¿«é€Ÿå®Œæˆï¼Œé¿å…å½±å“å…¶ä»–äº‹ä»¶
- **ä¸è¦åœ¨Watcherä¸­æ‰§è¡ŒZookeeperæ“ä½œ**ï¼šå¯èƒ½å¯¼è‡´æ­»é”

**ğŸ’¡ æ€§èƒ½ä¼˜åŒ–å»ºè®®**
- **è¿æ¥æ± **ï¼šé«˜å¹¶å‘åœºæ™¯ä½¿ç”¨è¿æ¥æ± ç®¡ç†è¿æ¥
- **æœ¬åœ°ç¼“å­˜**ï¼šç¼“å­˜ä¸ç»å¸¸å˜åŒ–çš„æ•°æ®å‡å°‘ç½‘ç»œè°ƒç”¨
- **æ‰¹é‡æ“ä½œ**ï¼šä½¿ç”¨multiæ“ä½œå‡å°‘ç½‘ç»œå¾€è¿”æ¬¡æ•°

### 9.4 è°ƒè¯•ä¸ç›‘æ§


**ğŸ” è°ƒè¯•æŠ€å·§**
```java
// æ‰“å°è¿æ¥è¯¦ç»†ä¿¡æ¯
System.out.println("ğŸ” è°ƒè¯•ä¿¡æ¯ï¼š");
System.out.println("ä¼šè¯IDï¼š" + Long.toHexString(zk.getSessionId()));
System.out.println("ä¼šè¯è¶…æ—¶ï¼š" + zk.getSessionTimeout());
System.out.println("è¿æ¥çŠ¶æ€ï¼š" + zk.getState());
```

**ğŸ“Š ç›‘æ§æŒ‡æ ‡**
- **è¿æ¥çŠ¶æ€**ï¼šç›‘æ§è¿æ¥å»ºç«‹æˆåŠŸç‡å’Œè€—æ—¶
- **ä¼šè¯è¶…æ—¶**ï¼šç»Ÿè®¡ä¼šè¯è¶…æ—¶é¢‘ç‡å’ŒåŸå› 
- **é‡è¯•æ¬¡æ•°**ï¼šç›‘æ§é‡è¯•é¢‘ç‡ï¼Œè¯†åˆ«ç½‘ç»œé—®é¢˜
- **å“åº”æ—¶é—´**ï¼šç›‘æ§å„ç§æ“ä½œçš„å“åº”æ—¶é—´

**æ ¸å¿ƒè®°å¿†**ï¼š
- è¿æ¥ç®¡ç†æ˜¯å®¢æˆ·ç«¯ä½¿ç”¨çš„åŸºç¡€ï¼Œå¿…é¡»å¤„ç†å¥½å„ç§å¼‚å¸¸æƒ…å†µ
- ä¼šè¯æ˜¯å®¢æˆ·ç«¯èº«ä»½çš„ä½“ç°ï¼Œè¶…æ—¶åå¿…é¡»é‡æ–°åˆ›å»ºè¿æ¥
- å¿ƒè·³æ˜¯ä¼šè¯ä¿æ´»çš„æœºåˆ¶ï¼Œè‡ªåŠ¨å·¥ä½œä½†éœ€è¦ç†è§£å…¶åŸç†
- çŠ¶æ€ç›‘å¬æ˜¯æ„ŸçŸ¥è¿æ¥å˜åŒ–çš„çœ¼ç›ï¼Œå¿…é¡»å®ç°å®Œæ•´çš„å¤„ç†é€»è¾‘