---
title: 7ã€Watchç›‘å¬å®ç°åŸç†
---
## ğŸ“š ç›®å½•

1. [Watchæœºåˆ¶æ¦‚è¿°](#1-Watchæœºåˆ¶æ¦‚è¿°)
2. [Watchå·¥ä½œåŸç†](#2-Watchå·¥ä½œåŸç†)
3. [å®¢æˆ·ç«¯æ³¨å†Œæœºåˆ¶](#3-å®¢æˆ·ç«¯æ³¨å†Œæœºåˆ¶)
4. [æœåŠ¡ç«¯é€šçŸ¥æœºåˆ¶](#4-æœåŠ¡ç«¯é€šçŸ¥æœºåˆ¶)
5. [ä¸€æ¬¡æ€§è§¦å‘ç‰¹æ€§](#5-ä¸€æ¬¡æ€§è§¦å‘ç‰¹æ€§)
6. [äº‹ä»¶é˜Ÿåˆ—å¤„ç†](#6-äº‹ä»¶é˜Ÿåˆ—å¤„ç†)
7. [ç½‘ç»œé€šä¿¡æœºåˆ¶](#7-ç½‘ç»œé€šä¿¡æœºåˆ¶)
8. [å¼‚æ­¥å¤„ç†æœºåˆ¶](#8-å¼‚æ­¥å¤„ç†æœºåˆ¶)
9. [å®é™…åº”ç”¨ä¸æœ€ä½³å®è·µ](#9-å®é™…åº”ç”¨ä¸æœ€ä½³å®è·µ)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ¯ Watchæœºåˆ¶æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯Watchæœºåˆ¶


**Watchæœºåˆ¶**å°±åƒæ˜¯ç»™ZookeeperèŠ‚ç‚¹å®‰è£…äº†ä¸€ä¸ª"ç›‘æ§æ‘„åƒå¤´"ï¼Œå½“èŠ‚ç‚¹å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¼šè‡ªåŠ¨é€šçŸ¥å…³å¿ƒè¿™ä¸ªèŠ‚ç‚¹çš„å®¢æˆ·ç«¯ã€‚

```
ç®€å•ç†è§£ï¼š
å°±åƒä½ è®¢é˜…äº†æŸä¸ªå•†å“çš„é™ä»·æé†’ï¼Œå½“å•†å“çœŸçš„é™ä»·æ—¶ï¼Œ
ç³»ç»Ÿä¼šè‡ªåŠ¨å‘æ¶ˆæ¯é€šçŸ¥ä½ ï¼Œè€Œä¸éœ€è¦ä½ ä¸€ç›´åˆ·æ–°é¡µé¢æŸ¥çœ‹ã€‚

åœ¨Zookeeperä¸­ï¼š
- ä½ å…³å¿ƒæŸä¸ªèŠ‚ç‚¹ â†’ æ³¨å†ŒWatch
- èŠ‚ç‚¹å‘ç”Ÿå˜åŒ– â†’ è‡ªåŠ¨æ”¶åˆ°é€šçŸ¥
- æ”¶åˆ°é€šçŸ¥åå¤„ç† â†’ å¯ä»¥é‡æ–°æ³¨å†ŒWatch
```

### 1.2 Watchæœºåˆ¶è§£å†³çš„é—®é¢˜


**ä¼ ç»Ÿè½®è¯¢æ–¹å¼çš„é—®é¢˜ï¼š**
```
å®¢æˆ·ç«¯æ¯éš”ä¸€æ®µæ—¶é—´ä¸»åŠ¨æŸ¥è¯¢ï¼š
æ—¶é—´: 10:00  æŸ¥è¯¢ç»“æœ: æ•°æ®A
æ—¶é—´: 10:01  æŸ¥è¯¢ç»“æœ: æ•°æ®A  â† æµªè´¹èµ„æº
æ—¶é—´: 10:02  æŸ¥è¯¢ç»“æœ: æ•°æ®A  â† æµªè´¹èµ„æº  
æ—¶é—´: 10:03  æŸ¥è¯¢ç»“æœ: æ•°æ®B  â† å˜åŒ–äº†ï¼Œä½†å¯èƒ½æ™šäº†2åˆ†é’Ÿæ‰çŸ¥é“

é—®é¢˜ï¼š
ğŸ”¸ æµªè´¹ç½‘ç»œå¸¦å®½å’ŒCPUèµ„æº
ğŸ”¸ å®æ—¶æ€§å·®ï¼Œå¯èƒ½å»¶è¿Ÿå¾ˆä¹…æ‰å‘ç°å˜åŒ–
ğŸ”¸ è½®è¯¢é¢‘ç‡éš¾ä»¥æ§åˆ¶ï¼ˆé¢‘ç¹æµªè´¹èµ„æºï¼Œä¸é¢‘ç¹å®æ—¶æ€§å·®ï¼‰
```

**Watchæœºåˆ¶çš„ä¼˜åŠ¿ï¼š**
```
ä¸»åŠ¨é€šçŸ¥æ–¹å¼ï¼š
- èŠ‚ç‚¹å˜åŒ– â†’ ç«‹å³é€šçŸ¥ â†’ å®æ—¶æ€§å¥½
- ä¸å˜åŒ–æ—¶ â†’ ä¸é€šçŸ¥ â†’ èŠ‚çœèµ„æº
- ç²¾å‡†æ¨é€ â†’ åªé€šçŸ¥çœŸæ­£å…³å¿ƒçš„å®¢æˆ·ç«¯

ä¼˜åŠ¿ï¼š
âœ… å®æ—¶æ€§å¼ºï¼šå˜åŒ–ç«‹å³é€šçŸ¥
âœ… èµ„æºèŠ‚çœï¼šé¿å…æ— æ•ˆè½®è¯¢
âœ… ç²¾å‡†æ¨é€ï¼šåªé€šçŸ¥ç›¸å…³å®¢æˆ·ç«¯
```

### 1.3 Watchæœºåˆ¶çš„æ ¸å¿ƒç‰¹ç‚¹


```
ğŸ”¸ ä¸€æ¬¡æ€§è§¦å‘ï¼ˆOne-time Triggerï¼‰
â€¢ ä¸€ä¸ªWatchåªèƒ½è§¦å‘ä¸€æ¬¡
â€¢ è§¦å‘åè‡ªåŠ¨å¤±æ•ˆ
â€¢ éœ€è¦é‡å¤ç›‘å¬å¿…é¡»é‡æ–°æ³¨å†Œ

ğŸ”¸ æœ‰åºä¿è¯ï¼ˆOrderedï¼‰
â€¢ äº‹ä»¶é€šçŸ¥æŒ‰é¡ºåºå‘é€
â€¢ ä¿è¯å®¢æˆ·ç«¯çœ‹åˆ°çš„å˜åŒ–é¡ºåºæ­£ç¡®

ğŸ”¸ è½»é‡çº§ï¼ˆLightweightï¼‰
â€¢ åªé€šçŸ¥å˜åŒ–ç±»å‹ï¼Œä¸ä¼ é€’å˜åŒ–åçš„æ•°æ®
â€¢ å‡å°‘ç½‘ç»œä¼ è¾“å¼€é”€

ğŸ”¸ å¼‚æ­¥é€šçŸ¥ï¼ˆAsynchronousï¼‰
â€¢ ä¸é˜»å¡æ­£å¸¸çš„è¯»å†™æ“ä½œ
â€¢ é€šè¿‡å•ç‹¬çš„çº¿ç¨‹å¤„ç†äº‹ä»¶é€šçŸ¥
```

---

## 2. âš™ï¸ Watchå·¥ä½œåŸç†


### 2.1 æ•´ä½“å·¥ä½œæµç¨‹


```
Watchæœºåˆ¶å·¥ä½œæµç¨‹ï¼š

å®¢æˆ·ç«¯                          æœåŠ¡ç«¯
   |                              |
   |--[1]æ³¨å†ŒWatchè¯·æ±‚------------>|
   |   getData("/path", watch)    |
   |                              |--[2]ä¿å­˜Watchä¿¡æ¯åˆ°å†…å­˜
   |<-[3]è¿”å›æ•°æ®å’Œæ³¨å†Œç¡®è®¤--------|    (è·¯å¾„ â†’ å®¢æˆ·ç«¯æ˜ å°„)
   |                              |
   |                              |--[4]èŠ‚ç‚¹æ•°æ®å‘ç”Ÿå˜åŒ–
   |                              |    (å…¶ä»–å®¢æˆ·ç«¯ä¿®æ”¹)
   |                              |
   |                              |--[5]æŸ¥æ‰¾è¯¥è·¯å¾„çš„Watchåˆ—è¡¨
   |                              |
   |<-[6]å‘é€äº‹ä»¶é€šçŸ¥-------------|
   |   WatchedEvent               |
   |                              |--[7]æ¸…é™¤å·²è§¦å‘çš„Watch
   |--[8]å¤„ç†äº‹ä»¶--------------->|    (ä¸€æ¬¡æ€§è§¦å‘)
   |   (å¯é€‰æ‹©é‡æ–°æ³¨å†ŒWatch)      |
```

### 2.2 æ ¸å¿ƒç»„ä»¶äº¤äº’


```
Zookeeper Watchç³»ç»Ÿæ¶æ„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å®¢æˆ·ç«¯åº”ç”¨     â”‚    â”‚  å®¢æˆ·ç«¯Watch    â”‚    â”‚   æœåŠ¡ç«¯        â”‚
â”‚                â”‚    â”‚    ç®¡ç†å™¨       â”‚    â”‚                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ä¸šåŠ¡é€»è¾‘å¤„ç†  â”‚ â”‚    â”‚ â”‚äº‹ä»¶ç›‘å¬å™¨    â”‚ â”‚    â”‚ â”‚ Watchå­˜å‚¨   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚å›è°ƒå‡½æ•°æ³¨å†Œ  â”‚ â”‚    â”‚ â”‚ç½‘ç»œé€šä¿¡æ¨¡å—  â”‚ â”‚    â”‚ â”‚äº‹ä»¶è§¦å‘å™¨    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         |                       |                       |
         |â†â”€â”€â”€â”€â”€â”€äº‹ä»¶å›è°ƒâ”€â”€â”€â”€â”€â”€â”€â”€â”€|â†â”€â”€â”€â”€â”€â”€ç½‘ç»œé€šçŸ¥â”€â”€â”€â”€â”€â”€â”€â”€â”€|
```

### 2.3 æ•°æ®ç»“æ„è®¾è®¡


**æœåŠ¡ç«¯Watchå­˜å‚¨ç»“æ„ï¼š**
```java
// æœåŠ¡ç«¯ç»´æŠ¤çš„Watchæ˜ å°„å…³ç³»
public class WatchManager {
    // è·¯å¾„ â†’ å…³æ³¨è¯¥è·¯å¾„çš„å®¢æˆ·ç«¯ä¼šè¯åˆ—è¡¨
    private Map<String, Set<Watcher>> watchTable;
    
    // å®¢æˆ·ç«¯ä¼šè¯ â†’ è¯¥ä¼šè¯å…³æ³¨çš„è·¯å¾„åˆ—è¡¨  
    private Map<Long, Set<String>> watch2Paths;
    
    // ç¤ºä¾‹æ•°æ®ç»“æ„ï¼š
    // watchTable = {
    //   "/config/app" â†’ {session1, session3, session5}
    //   "/config/db"  â†’ {session2, session4}
    // }
    // 
    // watch2Paths = {
    //   session1 â†’ {"/config/app", "/status"}
    //   session2 â†’ {"/config/db"}
    // }
}
```

---

## 3. ğŸ“ å®¢æˆ·ç«¯æ³¨å†Œæœºåˆ¶


### 3.1 æ³¨å†ŒWatchçš„æ–¹å¼


Zookeeperæä¾›äº†å¤šç§æ³¨å†ŒWatchçš„APIæ–¹æ³•ï¼š

**ä¸»è¦æ³¨å†Œæ–¹æ³•ï¼š**
```java
// æ–¹å¼1ï¼šgetDataæ—¶æ³¨å†ŒWatch
byte[] data = zk.getData("/path", new Watcher() {
    public void process(WatchedEvent event) {
        System.out.println("èŠ‚ç‚¹æ•°æ®å˜åŒ–: " + event);
    }
}, null);

// æ–¹å¼2ï¼šexistsæ—¶æ³¨å†ŒWatch  
Stat stat = zk.exists("/path", new Watcher() {
    public void process(WatchedEvent event) {
        System.out.println("èŠ‚ç‚¹çŠ¶æ€å˜åŒ–: " + event);
    }
});

// æ–¹å¼3ï¼šgetChildrenæ—¶æ³¨å†ŒWatch
List<String> children = zk.getChildren("/path", new Watcher() {
    public void process(WatchedEvent event) {
        System.out.println("å­èŠ‚ç‚¹å˜åŒ–: " + event);
    }
});

// æ–¹å¼4ï¼šä½¿ç”¨é»˜è®¤Watcherï¼ˆåˆ›å»ºZooKeeperæ—¶æŒ‡å®šï¼‰
byte[] data = zk.getData("/path", true, null);  // trueè¡¨ç¤ºä½¿ç”¨é»˜è®¤watcher
```

### 3.2 å®¢æˆ·ç«¯Watchç®¡ç†å™¨


**å®¢æˆ·ç«¯å¦‚ä½•ç®¡ç†Watchï¼š**
```java
// å®¢æˆ·ç«¯Watchç®¡ç†å™¨çš„æ ¸å¿ƒåŠŸèƒ½
public class ClientWatchManager {
    // å­˜å‚¨ä¸åŒç±»å‹çš„Watch
    private Set<Watcher> dataWatches;     // æ•°æ®å˜åŒ–Watch
    private Set<Watcher> existWatches;    // èŠ‚ç‚¹å­˜åœ¨æ€§Watch  
    private Set<Watcher> childWatches;    // å­èŠ‚ç‚¹å˜åŒ–Watch
    
    // æ ¹æ®äº‹ä»¶ç±»å‹åˆ†å‘åˆ°å¯¹åº”çš„Watcher
    public void materialize(WatchedEvent event) {
        switch (event.getType()) {
            case NodeDataChanged:
                // é€šçŸ¥æ‰€æœ‰æ•°æ®å˜åŒ–çš„Watcher
                notifyWatchers(dataWatches, event);
                break;
            case NodeChildrenChanged:
                // é€šçŸ¥æ‰€æœ‰å­èŠ‚ç‚¹å˜åŒ–çš„Watcher  
                notifyWatchers(childWatches, event);
                break;
            // ... å…¶ä»–äº‹ä»¶ç±»å‹
        }
    }
}
```

### 3.3 æ³¨å†Œè¿‡ç¨‹è¯¦è§£


```
å®¢æˆ·ç«¯æ³¨å†ŒWatchçš„è¯¦ç»†æ­¥éª¤ï¼š

æ­¥éª¤1: åº”ç”¨è°ƒç”¨API
åº”ç”¨ä»£ç : zk.getData("/config", watcher, null)

æ­¥éª¤2: å®¢æˆ·ç«¯é¢„å¤„ç†
- å°†Watcherå­˜å‚¨åˆ°æœ¬åœ°ç®¡ç†å™¨
- ç”Ÿæˆå”¯ä¸€çš„è¯·æ±‚ID
- æ„é€ GetDataè¯·æ±‚åŒ…

æ­¥éª¤3: ç½‘ç»œä¼ è¾“
- å°†è¯·æ±‚åºåˆ—åŒ–
- é€šè¿‡TCPè¿æ¥å‘é€åˆ°æœåŠ¡ç«¯
- è¯·æ±‚ä¸­åŒ…å«pathå’Œwatchæ ‡å¿—

æ­¥éª¤4: æœåŠ¡ç«¯å“åº”
- æœåŠ¡ç«¯è¿”å›æ•°æ®å’Œæ“ä½œç»“æœ
- å®¢æˆ·ç«¯æ”¶åˆ°å“åº”ï¼Œç¡®è®¤Watchæ³¨å†ŒæˆåŠŸ

ç®€åŒ–ç†è§£ï¼š
å°±åƒä½ åœ¨å•†åº—ç•™ä¸‹ç”µè¯å·ç ï¼Œè¯´"è¿™ä¸ªå•†å“é™ä»·äº†é€šçŸ¥æˆ‘"
- ä½ çš„ç”µè¯å·ç  â†’ Watcherå›è°ƒå‡½æ•°
- å•†å“ â†’ ZookeeperèŠ‚ç‚¹è·¯å¾„  
- åº—å‘˜è®°å½•ä½ çš„éœ€æ±‚ â†’ æœåŠ¡ç«¯ä¿å­˜Watchä¿¡æ¯
```

---

## 4. ğŸ”” æœåŠ¡ç«¯é€šçŸ¥æœºåˆ¶


### 4.1 æœåŠ¡ç«¯Watchå­˜å‚¨


**æœåŠ¡ç«¯å¦‚ä½•ç»„ç»‡Watchä¿¡æ¯ï¼š**
```java
// æœåŠ¡ç«¯çš„Watchå­˜å‚¨æ ¸å¿ƒæ•°æ®ç»“æ„
public class WatchManager {
    // è¿™ä¸ªè¡¨è®°å½•ï¼šæ¯ä¸ªè·¯å¾„æœ‰å“ªäº›å®¢æˆ·ç«¯åœ¨ç›‘å¬
    private final HashMap<String, HashSet<Watcher>> watchTable = 
        new HashMap<String, HashSet<Watcher>>();
    
    // è¿™ä¸ªè¡¨è®°å½•ï¼šæ¯ä¸ªå®¢æˆ·ç«¯ç›‘å¬äº†å“ªäº›è·¯å¾„  
    private final HashMap<Watcher, HashSet<String>> watch2Paths =
        new HashMap<Watcher, HashSet<String>>();
    
    // æ·»åŠ Watchçš„æ–¹æ³•
    public void addWatch(String path, Watcher watcher) {
        // åœ¨è·¯å¾„è¡¨ä¸­æ·»åŠ ç›‘å¬è€…
        HashSet<Watcher> watchers = watchTable.get(path);
        if (watchers == null) {
            watchers = new HashSet<Watcher>();
            watchTable.put(path, watchers);
        }
        watchers.add(watcher);
        
        // åœ¨ç›‘å¬è€…è¡¨ä¸­æ·»åŠ è·¯å¾„
        HashSet<String> paths = watch2Paths.get(watcher);
        if (paths == null) {
            paths = new HashSet<String>();
            watch2Paths.put(watcher, paths);
        }
        paths.add(path);
    }
}
```

### 4.2 äº‹ä»¶è§¦å‘æµç¨‹


```
æœåŠ¡ç«¯äº‹ä»¶è§¦å‘çš„å®Œæ•´æµç¨‹ï¼š

æ•°æ®å˜åŒ–è§¦å‘ç‚¹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. å®¢æˆ·ç«¯Aä¿®æ”¹èŠ‚ç‚¹ setData("/config", newData)          â”‚
â”‚    â†“                                                   â”‚
â”‚ 2. æœåŠ¡ç«¯å¤„ç†å†™è¯·æ±‚ï¼Œæ›´æ–°èŠ‚ç‚¹æ•°æ®                        â”‚
â”‚    â†“                                                   â”‚
â”‚ 3. æ•°æ®æ›´æ–°æˆåŠŸåï¼Œè§¦å‘WatchæŸ¥æ‰¾                        â”‚
â”‚    â†“                                                   â”‚
â”‚ 4. æŸ¥æ‰¾watchTableï¼š"/config" â†’ {clientB, clientC}    â”‚
â”‚    â†“                                                   â”‚
â”‚ 5. ä¸ºæ¯ä¸ªç›¸å…³å®¢æˆ·ç«¯åˆ›å»ºWatchedEventäº‹ä»¶                  â”‚
â”‚    â†“                                                   â”‚
â”‚ 6. å°†äº‹ä»¶æ”¾å…¥å„å®¢æˆ·ç«¯çš„å‘é€é˜Ÿåˆ—                          â”‚
â”‚    â†“                                                   â”‚
â”‚ 7. å¼‚æ­¥å‘é€äº‹ä»¶åˆ°clientBå’ŒclientC                      â”‚
â”‚    â†“                                                   â”‚
â”‚ 8. æ¸…ç†å·²è§¦å‘çš„Watchï¼ˆä¸€æ¬¡æ€§è§¦å‘ç‰¹æ€§ï¼‰                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 äº‹ä»¶ç±»å‹ä¸è§¦å‘æ¡ä»¶


| **äº‹ä»¶ç±»å‹** | **è§¦å‘æ“ä½œ** | **Watchæ³¨å†Œæ–¹å¼** | **è¯´æ˜** |
|-------------|-------------|------------------|----------|
| **NodeCreated** | `create()` | `exists()` | èŠ‚ç‚¹è¢«åˆ›å»º |
| **NodeDeleted** | `delete()` | `exists()`, `getData()` | èŠ‚ç‚¹è¢«åˆ é™¤ |
| **NodeDataChanged** | `setData()` | `exists()`, `getData()` | èŠ‚ç‚¹æ•°æ®æ”¹å˜ |
| **NodeChildrenChanged** | `create(å­èŠ‚ç‚¹)`, `delete(å­èŠ‚ç‚¹)` | `getChildren()` | å­èŠ‚ç‚¹åˆ—è¡¨æ”¹å˜ |

**å®é™…è§¦å‘ç¤ºä¾‹ï¼š**
```java
// åœºæ™¯ï¼šç›‘å¬é…ç½®èŠ‚ç‚¹çš„å˜åŒ–
public class ConfigWatcher implements Watcher {
    private ZooKeeper zk;
    
    public void watchConfig() {
        try {
            // æ³¨å†Œæ•°æ®å˜åŒ–Watch
            byte[] data = zk.getData("/app/config", this, null);
            System.out.println("å½“å‰é…ç½®: " + new String(data));
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    @Override
    public void process(WatchedEvent event) {
        System.out.println("æ”¶åˆ°äº‹ä»¶: " + event.getType());
        
        if (event.getType() == Event.EventType.NodeDataChanged) {
            System.out.println("é…ç½®å‘ç”Ÿå˜åŒ–ï¼Œé‡æ–°è¯»å–...");
            // é‡æ–°æ³¨å†ŒWatchï¼ˆå› ä¸ºæ˜¯ä¸€æ¬¡æ€§çš„ï¼‰
            watchConfig();
        }
    }
}
```

---

## 5. âš¡ ä¸€æ¬¡æ€§è§¦å‘ç‰¹æ€§


### 5.1 ä¸ºä»€ä¹ˆæ˜¯ä¸€æ¬¡æ€§è§¦å‘


**è®¾è®¡åŸå› åˆ†æï¼š**

```
ä¸€æ¬¡æ€§è§¦å‘çš„è®¾è®¡è€ƒè™‘ï¼š

ğŸ”¸ é¿å…äº‹ä»¶é£æš´
å¦‚æœä¸æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œé¢‘ç¹å˜åŒ–çš„èŠ‚ç‚¹ä¼šäº§ç”Ÿå¤§é‡äº‹ä»¶ï¼š
- èŠ‚ç‚¹æ¯ç§’å˜åŒ–100æ¬¡
- æœ‰1000ä¸ªå®¢æˆ·ç«¯ç›‘å¬  
- æ¯ç§’äº§ç”Ÿ10ä¸‡ä¸ªäº‹ä»¶é€šçŸ¥
- æœåŠ¡å™¨å’Œç½‘ç»œéƒ½æ— æ³•æ‰¿å—

ğŸ”¸ ç®€åŒ–å®¢æˆ·ç«¯é€»è¾‘
- å®¢æˆ·ç«¯å¤„ç†å®Œä¸€ä¸ªäº‹ä»¶åï¼Œå¯ä»¥å†³å®šæ˜¯å¦ç»§ç»­ç›‘å¬
- é¿å…å®¢æˆ·ç«¯è¢«å¤§é‡é‡å¤äº‹ä»¶æ·¹æ²¡
- ç»™å®¢æˆ·ç«¯å……åˆ†çš„æ§åˆ¶æƒ

ğŸ”¸ ä¿è¯æœ‰åºæ€§
- ä¸€æ¬¡æ€§è§¦å‘ç¡®ä¿å®¢æˆ·ç«¯æŒ‰é¡ºåºå¤„ç†äº‹ä»¶
- é¿å…å¹¶å‘å¤„ç†å¤šä¸ªäº‹ä»¶å¯¼è‡´çš„çŠ¶æ€æ··ä¹±
```

### 5.2 ä¸€æ¬¡æ€§è§¦å‘çš„å·¥ä½œæœºåˆ¶


```java
// æœåŠ¡ç«¯è§¦å‘Watchçš„æ ¸å¿ƒä»£ç é€»è¾‘
public class WatchManager {
    
    public Set<Watcher> triggerWatch(String path, EventType type) {
        // 1. æŸ¥æ‰¾è¯¥è·¯å¾„çš„æ‰€æœ‰Watch
        Set<Watcher> watchers = watchTable.get(path);
        if (watchers == null) {
            return Collections.emptySet();
        }
        
        // 2. åˆ›å»ºäº‹ä»¶å¯¹è±¡
        WatchedEvent event = new WatchedEvent(type, KeeperState.SyncConnected, path);
        
        // 3. è§¦å‘æ‰€æœ‰ç›¸å…³çš„Watch
        for (Watcher watcher : watchers) {
            // å‘é€äº‹ä»¶é€šçŸ¥
            watcher.process(event);
        }
        
        // 4. å…³é”®ï¼šæ¸…é™¤å·²è§¦å‘çš„Watchï¼ˆä¸€æ¬¡æ€§ç‰¹æ€§ï¼‰
        watchTable.remove(path);
        
        // 5. åŒæ—¶æ¸…ç†åå‘æ˜ å°„è¡¨
        for (Watcher watcher : watchers) {
            Set<String> paths = watch2Paths.get(watcher);
            if (paths != null) {
                paths.remove(path);
            }
        }
        
        return watchers;
    }
}
```

### 5.3 é‡æ–°æ³¨å†ŒWatchçš„æ¨¡å¼


**å¸¸è§çš„Watché‡æ³¨å†Œæ¨¡å¼ï¼š**

```java
// æ¨¡å¼1: åœ¨äº‹ä»¶å¤„ç†ä¸­ç«‹å³é‡æ–°æ³¨å†Œ
public class ContinuousWatcher implements Watcher {
    private ZooKeeper zk;
    private String path;
    
    @Override
    public void process(WatchedEvent event) {
        System.out.println("æ”¶åˆ°äº‹ä»¶: " + event);
        
        // å¤„ç†äº‹ä»¶é€»è¾‘
        handleEvent(event);
        
        // ç«‹å³é‡æ–°æ³¨å†ŒWatchï¼ˆå¦‚æœéœ€è¦ç»§ç»­ç›‘å¬ï¼‰
        try {
            zk.getData(path, this, null);  // é‡æ–°æ³¨å†Œ
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}

// æ¨¡å¼2: åŸºäºæ¡ä»¶çš„é‡æ–°æ³¨å†Œ
public class ConditionalWatcher implements Watcher {
    private ZooKeeper zk;
    private boolean keepWatching = true;
    
    @Override
    public void process(WatchedEvent event) {
        handleEvent(event);
        
        // æ ¹æ®æ¡ä»¶å†³å®šæ˜¯å¦ç»§ç»­ç›‘å¬
        if (keepWatching && event.getType() != Event.EventType.NodeDeleted) {
            try {
                zk.exists(event.getPath(), this);  // é‡æ–°æ³¨å†Œ
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }
    
    public void stopWatching() {
        keepWatching = false;
    }
}
```

---

## 6. ğŸ“‹ äº‹ä»¶é˜Ÿåˆ—å¤„ç†


### 6.1 å®¢æˆ·ç«¯äº‹ä»¶é˜Ÿåˆ—


**å®¢æˆ·ç«¯å¦‚ä½•å¤„ç†äº‹ä»¶é˜Ÿåˆ—ï¼š**

```java
// å®¢æˆ·ç«¯äº‹ä»¶å¤„ç†çš„æ ¸å¿ƒç»„ä»¶
public class EventThread extends ZooKeeperThread {
    private final LinkedBlockingQueue<Object> waitingEvents = 
        new LinkedBlockingQueue<Object>();
    
    // äº‹ä»¶å¤„ç†çº¿ç¨‹çš„ä¸»å¾ªç¯
    @Override
    public void run() {
        try {
            while (true) {
                // 1. ä»é˜Ÿåˆ—ä¸­å–å‡ºäº‹ä»¶ï¼ˆé˜»å¡ç­‰å¾…ï¼‰
                Object event = waitingEvents.take();
                
                if (event instanceof WatchedEvent) {
                    // 2. å¤„ç†Watchäº‹ä»¶
                    processEvent((WatchedEvent) event);
                } else {
                    // 3. å¤„ç†å…¶ä»–ç±»å‹äº‹ä»¶ï¼ˆå¦‚è¿æ¥äº‹ä»¶ï¼‰
                    processOtherEvent(event);
                }
            }
        } catch (InterruptedException e) {
            // çº¿ç¨‹è¢«ä¸­æ–­ï¼Œé€€å‡ºå¤„ç†å¾ªç¯
        }
    }
    
    // æ·»åŠ äº‹ä»¶åˆ°é˜Ÿåˆ—
    public void queueEvent(WatchedEvent event) {
        waitingEvents.offer(event);
    }
}
```

### 6.2 äº‹ä»¶é˜Ÿåˆ—çš„ç‰¹ç‚¹


```
äº‹ä»¶é˜Ÿåˆ—çš„æ ¸å¿ƒç‰¹æ€§ï¼š

ğŸ”¸ å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰
â€¢ ä¿è¯äº‹ä»¶æŒ‰ç…§å‘ç”Ÿçš„æ—¶é—´é¡ºåºå¤„ç†
â€¢ é¿å…äº‹ä»¶å¤„ç†çš„æ—¶åºæ··ä¹±

ğŸ”¸ å¼‚æ­¥å¤„ç†
â€¢ äº‹ä»¶æ¥æ”¶å’Œäº‹ä»¶å¤„ç†åˆ†ç¦»
â€¢ ä¸é˜»å¡ç½‘ç»œé€šä¿¡çº¿ç¨‹
â€¢ æé«˜æ•´ä½“å¤„ç†æ•ˆç‡

ğŸ”¸ å•çº¿ç¨‹å¤„ç†
â€¢ åŒä¸€ä¸ªå®¢æˆ·ç«¯çš„æ‰€æœ‰äº‹ä»¶ç”±åŒä¸€ä¸ªçº¿ç¨‹å¤„ç†
â€¢ é¿å…å¹¶å‘é—®é¢˜ï¼Œç®€åŒ–å®¢æˆ·ç«¯é€»è¾‘

ğŸ”¸ å†…å­˜é˜Ÿåˆ—
â€¢ ä½¿ç”¨LinkedBlockingQueueå­˜å‚¨å¾…å¤„ç†äº‹ä»¶
â€¢ æä¾›é«˜æ•ˆçš„å…¥é˜Ÿå’Œå‡ºé˜Ÿæ“ä½œ
```

### 6.3 äº‹ä»¶å¤„ç†æµç¨‹


```
å®¢æˆ·ç«¯äº‹ä»¶å¤„ç†çš„å®Œæ•´æµç¨‹ï¼š

ç½‘ç»œå±‚                äº‹ä»¶é˜Ÿåˆ—                ä¸šåŠ¡å±‚
   |                     |                     |
   |--[1]æ”¶åˆ°äº‹ä»¶------->|                     |
   |                     |--[2]äº‹ä»¶å…¥é˜Ÿ------->|
   |                     |                     |
   |                     |<-[3]äº‹ä»¶å‡ºé˜Ÿ--------|
   |                     |                     |--[4]æŸ¥æ‰¾Watcher
   |                     |                     |
   |                     |                     |--[5]è°ƒç”¨process()
   |                     |                     |
   |                     |                     |--[6]æ‰§è¡Œä¸šåŠ¡é€»è¾‘
   |                     |                     |
   |<--[7]å¯èƒ½çš„é‡æ–°æ³¨å†Œ--|<--[8]æ–°çš„Watchè¯·æ±‚--|

å¤„ç†è¿‡ç¨‹è¯´æ˜ï¼š
1. ç½‘ç»œçº¿ç¨‹æ¥æ”¶åˆ°æœåŠ¡ç«¯å‘é€çš„äº‹ä»¶
2. å°†äº‹ä»¶æ”¾å…¥å†…å­˜é˜Ÿåˆ—ï¼Œä¸é˜»å¡ç½‘ç»œé€šä¿¡
3. äº‹ä»¶å¤„ç†çº¿ç¨‹ä»é˜Ÿåˆ—å–å‡ºäº‹ä»¶
4. æ ¹æ®äº‹ä»¶è·¯å¾„æ‰¾åˆ°å¯¹åº”çš„Watcher
5. è°ƒç”¨Watcherçš„processæ–¹æ³•
6. åœ¨processæ–¹æ³•ä¸­æ‰§è¡Œå…·ä½“çš„ä¸šåŠ¡é€»è¾‘
7-8. å¦‚æœéœ€è¦ç»§ç»­ç›‘å¬ï¼Œå‘èµ·æ–°çš„Watchæ³¨å†Œè¯·æ±‚
```

---

## 7. ğŸŒ ç½‘ç»œé€šä¿¡æœºåˆ¶


### 7.1 ç½‘ç»œé€šä¿¡åè®®


**Zookeeperä½¿ç”¨è‡ªå®šä¹‰çš„äºŒè¿›åˆ¶åè®®è¿›è¡Œé€šä¿¡ï¼š**

```java
// ç½‘ç»œæ•°æ®åŒ…çš„åŸºæœ¬ç»“æ„
public class Packet {
    RequestHeader requestHeader;    // è¯·æ±‚å¤´ä¿¡æ¯
    ReplyHeader replyHeader;       // å“åº”å¤´ä¿¡æ¯  
    Record request;                // è¯·æ±‚å†…å®¹
    Record response;               // å“åº”å†…å®¹
    ByteBuffer bb;                 // åºåˆ—åŒ–åçš„å­—èŠ‚ç¼“å†²åŒº
    
    // Watchäº‹ä»¶é€šçŸ¥çš„ç‰¹æ®Šæ•°æ®åŒ…
    public static class WatchNotification {
        int type;          // äº‹ä»¶ç±»å‹ï¼ˆåˆ›å»ºã€åˆ é™¤ã€ä¿®æ”¹ç­‰ï¼‰
        int state;         // è¿æ¥çŠ¶æ€
        String path;       // è§¦å‘äº‹ä»¶çš„èŠ‚ç‚¹è·¯å¾„
    }
}
```

### 7.2 å®¢æˆ·ç«¯ç½‘ç»œé€šä¿¡ç»„ä»¶


```
å®¢æˆ·ç«¯ç½‘ç»œé€šä¿¡æ¶æ„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  å®¢æˆ·ç«¯åº”ç”¨å±‚                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚               Zookeeperå®¢æˆ·ç«¯API                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   SendThread    â”‚ EventThread   â”‚    Watcherç®¡ç†å™¨       â”‚
â”‚   (å‘é€çº¿ç¨‹)     â”‚ (äº‹ä»¶çº¿ç¨‹)     â”‚                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              ç½‘ç»œé€šä¿¡å±‚ï¼ˆNIOï¼‰                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                TCP Socketè¿æ¥                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å„ç»„ä»¶èŒè´£ï¼š
- SendThread: è´Ÿè´£å‘é€è¯·æ±‚å’Œæ¥æ”¶å“åº”
- EventThread: è´Ÿè´£å¤„ç†äº‹ä»¶é€šçŸ¥
- Watcherç®¡ç†å™¨: ç®¡ç†æ‰€æœ‰çš„Watchæ³¨å†Œä¿¡æ¯
```

### 7.3 ç½‘ç»œé€šä¿¡çš„å…³é”®ç‰¹ç‚¹


```java
// ç½‘ç»œé€šä¿¡çš„æ ¸å¿ƒç‰¹æ€§
public class ClientCnxn {
    
    // 1. é•¿è¿æ¥æœºåˆ¶
    private Socket sock;  // ä¿æŒä¸æœåŠ¡å™¨çš„é•¿è¿æ¥
    
    // 2. å¿ƒè·³æ£€æµ‹
    private long lastHeard;  // æœ€åä¸€æ¬¡æ”¶åˆ°æœåŠ¡å™¨å“åº”çš„æ—¶é—´
    
    // 3. è¯·æ±‚é˜Ÿåˆ—
    private final LinkedList<Packet> pendingQueue = 
        new LinkedList<Packet>();  // å¾…å‘é€çš„è¯·æ±‚é˜Ÿåˆ—
    
    // 4. å“åº”é˜Ÿåˆ—  
    private final LinkedList<Packet> outgoingQueue =
        new LinkedList<Packet>();  // å¾…å¤„ç†çš„å“åº”é˜Ÿåˆ—
    
    // ä¼šè¯ä¿æŒæœºåˆ¶
    public void sendPing() {
        // å®šæœŸå‘é€å¿ƒè·³åŒ…ï¼Œä¿æŒä¼šè¯æ´»è·ƒ
        RequestHeader h = new RequestHeader();
        h.setType(OpCode.ping);
        submitRequest(h, null, null, null);
    }
}
```

---

## 8. ğŸš€ å¼‚æ­¥å¤„ç†æœºåˆ¶


### 8.1 å¼‚æ­¥å¤„ç†çš„æ ¸å¿ƒæ¶æ„


**Zookeeperå®¢æˆ·ç«¯é‡‡ç”¨å¤šçº¿ç¨‹å¼‚æ­¥å¤„ç†æ¨¡å¼ï¼š**

```
å®¢æˆ·ç«¯å¼‚æ­¥å¤„ç†æ¶æ„ï¼š

ä¸»çº¿ç¨‹                SendThread           EventThread
   |                      |                    |
   |--[1]APIè°ƒç”¨--------->|                    |
   |   getData(path,      |                    |  
   |   watcher, callback) |                    |
   |                      |--[2]æ„é€ è¯·æ±‚åŒ…---->|
   |<-[3]ç«‹å³è¿”å›---------|                    |
   |   (éé˜»å¡)           |                    |
   |                      |--[4]ç½‘ç»œå‘é€------>|æœåŠ¡ç«¯
   |                      |                    |
   |                      |<-[5]æ”¶åˆ°å“åº”-------|
   |                      |                    |
   |                      |--[6]äº‹ä»¶å…¥é˜Ÿ------>|
   |                      |                    |--[7]å¤„ç†äº‹ä»¶
   |                      |                    |
   |<-[8]å›è°ƒé€šçŸ¥---------|<-[9]äº‹ä»¶å¤„ç†å®Œæˆ---|

å¼‚æ­¥çš„å¥½å¤„ï¼š
- ä¸»çº¿ç¨‹ä¸è¢«é˜»å¡ï¼Œå¯ä»¥ç»§ç»­å¤„ç†å…¶ä»–ä¸šåŠ¡
- ç½‘ç»œIOå’Œäº‹ä»¶å¤„ç†å¹¶è¡Œè¿›è¡Œ
- æé«˜æ•´ä½“ç³»ç»Ÿçš„å“åº”èƒ½åŠ›
```

### 8.2 å¼‚æ­¥å›è°ƒæœºåˆ¶


```java
// å¼‚æ­¥å¤„ç†çš„å®ç°ç¤ºä¾‹
public class AsyncWatchExample {
    private ZooKeeper zk;
    
    // å¼‚æ­¥æ–¹å¼è·å–æ•°æ®å¹¶è®¾ç½®Watch
    public void getDataAsync(String path) {
        zk.getData(path, 
            // Watchå›è°ƒ
            new Watcher() {
                @Override
                public void process(WatchedEvent event) {
                    System.out.println("å¼‚æ­¥æ”¶åˆ°äº‹ä»¶: " + event);
                    // è¿™ä¸ªæ–¹æ³•åœ¨EventThreadä¸­æ‰§è¡Œ
                }
            }, 
            // æ•°æ®è·å–å›è°ƒ
            new AsyncCallback.DataCallback() {
                @Override
                public void processResult(int rc, String path, 
                                        Object ctx, byte[] data, Stat stat) {
                    if (rc == KeeperException.Code.OK.intValue()) {
                        System.out.println("å¼‚æ­¥è·å–æ•°æ®æˆåŠŸ: " + new String(data));
                    } else {
                        System.out.println("å¼‚æ­¥è·å–æ•°æ®å¤±è´¥: " + rc);
                    }
                    // è¿™ä¸ªæ–¹æ³•ä¹Ÿåœ¨EventThreadä¸­æ‰§è¡Œ
                }
            }, 
            null  // contextä¸Šä¸‹æ–‡å¯¹è±¡
        );
        
        // æ–¹æ³•ç«‹å³è¿”å›ï¼Œä¸é˜»å¡å½“å‰çº¿ç¨‹
        System.out.println("getDataè¯·æ±‚å·²å‘é€ï¼Œç»§ç»­æ‰§è¡Œå…¶ä»–é€»è¾‘...");
    }
}
```

### 8.3 åŒæ­¥ä¸å¼‚æ­¥çš„å¯¹æ¯”


| **ç‰¹æ€§** | **åŒæ­¥å¤„ç†** | **å¼‚æ­¥å¤„ç†** |
|---------|-------------|-------------|
| **è°ƒç”¨æ–¹å¼** | `getData(path, watcher, stat)` | `getData(path, watcher, callback, ctx)` |
| **çº¿ç¨‹é˜»å¡** | é˜»å¡è°ƒç”¨çº¿ç¨‹ç›´åˆ°å“åº”è¿”å› | ç«‹å³è¿”å›ï¼Œä¸é˜»å¡è°ƒç”¨çº¿ç¨‹ |
| **é”™è¯¯å¤„ç†** | æŠ›å‡ºå¼‚å¸¸ | åœ¨å›è°ƒå‡½æ•°ä¸­å¤„ç†é”™è¯¯ç  |
| **æ€§èƒ½å½±å“** | å¯èƒ½é™ä½å¹¶å‘æ€§èƒ½ | æé«˜å¹¶å‘å¤„ç†èƒ½åŠ› |
| **ç¼–ç¨‹å¤æ‚åº¦** | ç›¸å¯¹ç®€å• | éœ€è¦å¤„ç†å›è°ƒé€»è¾‘ |
| **é€‚ç”¨åœºæ™¯** | ç®€å•çš„é¡ºåºå¤„ç†é€»è¾‘ | é«˜å¹¶å‘ã€é«˜æ€§èƒ½éœ€æ±‚ |

---

## 9. ğŸ’¼ å®é™…åº”ç”¨ä¸æœ€ä½³å®è·µ


### 9.1 é…ç½®ä¸­å¿ƒåº”ç”¨


**ä½¿ç”¨Watchå®ç°åŠ¨æ€é…ç½®æ›´æ–°ï¼š**

```java
public class ConfigCenter {
    private ZooKeeper zk;
    private Properties config = new Properties();
    
    public class ConfigWatcher implements Watcher {
        private String configPath;
        
        public ConfigWatcher(String configPath) {
            this.configPath = configPath;
        }
        
        @Override
        public void process(WatchedEvent event) {
            if (event.getType() == Event.EventType.NodeDataChanged) {
                // é…ç½®å‘ç”Ÿå˜åŒ–ï¼Œé‡æ–°åŠ è½½
                loadConfig(configPath);
            }
        }
    }
    
    public void loadConfig(String configPath) {
        try {
            // è·å–é…ç½®æ•°æ®å¹¶æ³¨å†ŒWatch
            byte[] data = zk.getData(configPath, 
                new ConfigWatcher(configPath), null);
            
            // è§£æé…ç½®
            String configStr = new String(data, "UTF-8");
            config.load(new StringReader(configStr));
            
            // é€šçŸ¥åº”ç”¨é…ç½®å·²æ›´æ–°
            notifyConfigChanged();
            
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    public String getConfig(String key) {
        return config.getProperty(key);
    }
    
    private void notifyConfigChanged() {
        // é€šçŸ¥åº”ç”¨ç¨‹åºé…ç½®å‘ç”Ÿå˜åŒ–
        System.out.println("é…ç½®å·²æ›´æ–°ï¼Œå½“å‰é…ç½®é¡¹æ•°é‡: " + config.size());
    }
}
```

### 9.2 åˆ†å¸ƒå¼é”ç›‘å¬


**ä½¿ç”¨Watchå®ç°åˆ†å¸ƒå¼é”çš„ç­‰å¾…æœºåˆ¶ï¼š**

```java
public class DistributedLock {
    private ZooKeeper zk;
    private String lockPath;
    private String currentLockNode;
    
    public boolean tryLock() {
        try {
            // åˆ›å»ºä¸´æ—¶æœ‰åºèŠ‚ç‚¹
            currentLockNode = zk.create(lockPath + "/lock-", 
                new byte[0], ZooDefs.Ids.OPEN_ACL_UNSAFE, 
                CreateMode.EPHEMERAL_SEQUENTIAL);
            
            // è·å–æ‰€æœ‰é”èŠ‚ç‚¹
            List<String> children = zk.getChildren(lockPath, false);
            Collections.sort(children);
            
            String lockName = currentLockNode.substring(lockPath.length() + 1);
            int index = children.indexOf(lockName);
            
            if (index == 0) {
                // å½“å‰èŠ‚ç‚¹æ˜¯æœ€å°çš„ï¼Œè·å¾—é”
                return true;
            } else {
                // ç›‘å¬å‰ä¸€ä¸ªèŠ‚ç‚¹
                String prevNode = lockPath + "/" + children.get(index - 1);
                Stat stat = zk.exists(prevNode, new LockWatcher());
                
                if (stat == null) {
                    // å‰ä¸€ä¸ªèŠ‚ç‚¹å·²ç»ä¸å­˜åœ¨ï¼Œé‡æ–°å°è¯•è·å–é”
                    return tryLock();
                } else {
                    // ç­‰å¾…å‰ä¸€ä¸ªèŠ‚ç‚¹è¢«åˆ é™¤
                    return false;
                }
            }
        } catch (Exception e) {
            e.printStackTrace();
            return false;
        }
    }
    
    private class LockWatcher implements Watcher {
        @Override
        public void process(WatchedEvent event) {
            if (event.getType() == Event.EventType.NodeDeleted) {
                // å‰ä¸€ä¸ªé”èŠ‚ç‚¹è¢«åˆ é™¤ï¼Œå°è¯•è·å–é”
                synchronized (this) {
                    this.notifyAll();  // å”¤é†’ç­‰å¾…çš„çº¿ç¨‹
                }
            }
        }
    }
}
```

### 9.3 æœ€ä½³å®è·µæ€»ç»“


**Watchä½¿ç”¨çš„æœ€ä½³å®è·µï¼š**

```
âœ… æ­£ç¡®ä½¿ç”¨æ–¹å¼ï¼š

1. åŠæ—¶é‡æ–°æ³¨å†ŒWatch
   â€¢ Watchè§¦å‘åç«‹å³å¤±æ•ˆ
   â€¢ éœ€è¦æŒç»­ç›‘å¬å¿…é¡»é‡æ–°æ³¨å†Œ
   â€¢ åœ¨processæ–¹æ³•ä¸­å¤„ç†é‡æ–°æ³¨å†Œé€»è¾‘

2. å¤„ç†ç½‘ç»œå¼‚å¸¸
   â€¢ ç›‘å¬è¿æ¥çŠ¶æ€å˜åŒ–
   â€¢ è¿æ¥é‡å»ºåéœ€è¦é‡æ–°æ³¨å†Œæ‰€æœ‰Watch
   â€¢ å®ç°è‡ªåŠ¨é‡è¿å’ŒWatchæ¢å¤æœºåˆ¶

3. é¿å…Watché£æš´
   â€¢ ä¸è¦åœ¨é¢‘ç¹å˜åŒ–çš„èŠ‚ç‚¹ä¸Šè®¾ç½®å¤§é‡Watch
   â€¢ åˆç†ä½¿ç”¨äº‹ä»¶èšåˆå’Œæ‰¹å¤„ç†
   â€¢ è€ƒè™‘ä½¿ç”¨å®šæ—¶è½®è¯¢æ›¿ä»£Watch

4. æ­£ç¡®å¤„ç†äº‹ä»¶é¡ºåº
   â€¢ Watchäº‹ä»¶æ˜¯æœ‰åºçš„ï¼ŒæŒ‰é¡ºåºå¤„ç†
   â€¢ ä¸è¦åœ¨processæ–¹æ³•ä¸­æ‰§è¡Œè€—æ—¶æ“ä½œ
   â€¢ é•¿è€—æ—¶æ“ä½œåº”è¯¥å¼‚æ­¥å¤„ç†

âŒ é”™è¯¯ä½¿ç”¨æ–¹å¼ï¼š

1. å¿˜è®°é‡æ–°æ³¨å†ŒWatch
   â€¢ å¯¼è‡´åªèƒ½æ¥æ”¶ä¸€æ¬¡äº‹ä»¶é€šçŸ¥
   â€¢ åç»­å˜åŒ–æ— æ³•æ„ŸçŸ¥

2. åœ¨processæ–¹æ³•ä¸­æ‰§è¡Œè€—æ—¶æ“ä½œ
   â€¢ ä¼šé˜»å¡äº‹ä»¶å¤„ç†çº¿ç¨‹
   â€¢ å½±å“å…¶ä»–äº‹ä»¶çš„åŠæ—¶å¤„ç†

3. æ²¡æœ‰å¤„ç†è¿æ¥å¼‚å¸¸
   â€¢ è¿æ¥æ–­å¼€é‡è¿åWatchä¸¢å¤±
   â€¢ æ— æ³•æ„ŸçŸ¥åˆ°èŠ‚ç‚¹å˜åŒ–

4. è¿‡åº¦ä½¿ç”¨Watch
   â€¢ åœ¨å¤§é‡èŠ‚ç‚¹ä¸Šè®¾ç½®Watch
   â€¢ é€ æˆæœåŠ¡å™¨å’Œç½‘ç»œå‹åŠ›
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Watchæœºåˆ¶æœ¬è´¨ï¼šåŸºäºè§‚å¯Ÿè€…æ¨¡å¼çš„äº‹ä»¶é€šçŸ¥æœºåˆ¶
ğŸ”¸ ä¸€æ¬¡æ€§è§¦å‘ï¼šæ¯ä¸ªWatchåªèƒ½è§¦å‘ä¸€æ¬¡ï¼Œè§¦å‘åè‡ªåŠ¨å¤±æ•ˆ  
ğŸ”¸ å¼‚æ­¥é€šçŸ¥ï¼šäº‹ä»¶å¤„ç†ä¸é˜»å¡æ­£å¸¸çš„æ•°æ®æ“ä½œ
ğŸ”¸ æœ‰åºä¿è¯ï¼šäº‹ä»¶é€šçŸ¥æŒ‰ç…§å‘ç”Ÿé¡ºåºä¾æ¬¡å¤„ç†
ğŸ”¸ è½»é‡çº§ï¼šåªé€šçŸ¥äº‹ä»¶ç±»å‹ï¼Œä¸åŒ…å«å˜åŒ–åçš„æ•°æ®
ğŸ”¸ å®¢æˆ·ç«¯é©±åŠ¨ï¼šç”±å®¢æˆ·ç«¯ä¸»åŠ¨æ³¨å†Œï¼ŒæœåŠ¡ç«¯è¢«åŠ¨é€šçŸ¥
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ Watchçš„ç”Ÿå‘½å‘¨æœŸ**
```
æ³¨å†Œé˜¶æ®µ â†’ ç­‰å¾…é˜¶æ®µ â†’ è§¦å‘é˜¶æ®µ â†’ å¤±æ•ˆé˜¶æ®µ
   â†‘                                â†“
   â†-------- é‡æ–°æ³¨å†Œ â†---------------

ç†è§£è¦ç‚¹ï¼š
- æ³¨å†ŒåWatchè¿›å…¥ç­‰å¾…çŠ¶æ€
- èŠ‚ç‚¹å˜åŒ–æ—¶è§¦å‘äº‹ä»¶é€šçŸ¥
- è§¦å‘åWatchç«‹å³å¤±æ•ˆ
- éœ€è¦æŒç»­ç›‘å¬å¿…é¡»é‡æ–°æ³¨å†Œ
```

**ğŸ”¹ äº‹ä»¶å¤„ç†çš„å¼‚æ­¥æ€§**
```
ä¸šåŠ¡çº¿ç¨‹     ç½‘ç»œçº¿ç¨‹     äº‹ä»¶çº¿ç¨‹
    |           |           |
    |--æ³¨å†Œ----->|           |
    |<--ç«‹å³è¿”å›--|           |
    |           |<--äº‹ä»¶-----|æœåŠ¡ç«¯
    |           |--å…¥é˜Ÿ----->|
    |           |           |--å¤„ç†äº‹ä»¶
    |<----------å›è°ƒé€šçŸ¥-----|

å…³é”®ç‚¹ï¼š
- æ³¨å†ŒWatchä¸é˜»å¡ä¸šåŠ¡çº¿ç¨‹
- äº‹ä»¶é€šçŸ¥åœ¨ç‹¬ç«‹çº¿ç¨‹ä¸­å¤„ç†
- ä¿è¯äº†ç³»ç»Ÿçš„å“åº”æ€§å’Œå¹¶å‘æ€§
```

**ğŸ”¹ ä¸ºä»€ä¹ˆéœ€è¦é‡æ–°æ³¨å†Œ**
```
è®¾è®¡è€ƒè™‘ï¼š
- é¿å…äº‹ä»¶é£æš´ï¼šé˜²æ­¢é¢‘ç¹å˜åŒ–äº§ç”Ÿå¤§é‡äº‹ä»¶
- å®¢æˆ·ç«¯æ§åˆ¶ï¼šè®©å®¢æˆ·ç«¯å†³å®šæ˜¯å¦ç»§ç»­ç›‘å¬
- ç®€åŒ–æœåŠ¡ç«¯ï¼šæœåŠ¡ç«¯ä¸éœ€è¦ç®¡ç†æŒä¹…åŒ–çš„ç›‘å¬å…³ç³»
- ä¿è¯æœ‰åºï¼šç¡®ä¿å®¢æˆ·ç«¯æŒ‰é¡ºåºå¤„ç†äº‹ä»¶
```

### 10.3 å®é™…åº”ç”¨ä»·å€¼


**ä¸šåŠ¡åœºæ™¯åº”ç”¨ï¼š**
- **é…ç½®ç®¡ç†**ï¼šå®æ—¶æ„ŸçŸ¥é…ç½®å˜åŒ–ï¼ŒåŠ¨æ€æ›´æ–°åº”ç”¨é…ç½®
- **æœåŠ¡å‘ç°**ï¼šç›‘å¬æœåŠ¡èŠ‚ç‚¹å˜åŒ–ï¼ŒåŠæ—¶æ›´æ–°æœåŠ¡åˆ—è¡¨  
- **åˆ†å¸ƒå¼é”**ï¼šç›‘å¬é”èŠ‚ç‚¹å˜åŒ–ï¼Œå®ç°é”çš„ç­‰å¾…å’Œè·å–
- **é›†ç¾¤ç›‘æ§**ï¼šç›‘å¬é›†ç¾¤èŠ‚ç‚¹çŠ¶æ€ï¼ŒåŠæ—¶å‘ç°èŠ‚ç‚¹ä¸Šä¸‹çº¿
- **æ•°æ®åŒæ­¥**ï¼šç›‘å¬æ•°æ®å˜åŒ–ï¼Œè§¦å‘æ•°æ®åŒæ­¥æµç¨‹

**æŠ€æœ¯ä¼˜åŠ¿ï¼š**
- **å®æ—¶æ€§**ï¼šå˜åŒ–ç«‹å³é€šçŸ¥ï¼Œæ— éœ€è½®è¯¢
- **èµ„æºèŠ‚çœ**ï¼šé¿å…æ— æ•ˆçš„ç½‘ç»œè¯·æ±‚
- **ç¼–ç¨‹ç®€å•**ï¼šåŸºäºäº‹ä»¶é©±åŠ¨çš„ç¼–ç¨‹æ¨¡å‹
- **å¯é æ€§**ï¼šåŸºäºTCPé•¿è¿æ¥ï¼Œä¿è¯é€šçŸ¥åˆ°è¾¾

**æ ¸å¿ƒè®°å¿†è¦ç‚¹ï¼š**
- Watchæ˜¯Zookeeperçš„æ ¸å¿ƒç‰¹æ€§ï¼Œå®ç°äº†é«˜æ•ˆçš„äº‹ä»¶é€šçŸ¥æœºåˆ¶
- ä¸€æ¬¡æ€§è§¦å‘æ˜¯å…³é”®ç‰¹æ€§ï¼Œéœ€è¦é‡æ–°æ³¨å†Œæ‰èƒ½æŒç»­ç›‘å¬
- å¼‚æ­¥å¤„ç†ä¿è¯äº†ç³»ç»Ÿæ€§èƒ½ï¼Œäº‹ä»¶å¤„ç†ä¸é˜»å¡ä¸»ä¸šåŠ¡æµç¨‹  
- å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ååŒå·¥ä½œï¼Œé€šè¿‡ç½‘ç»œé€šä¿¡å®ç°åˆ†å¸ƒå¼äº‹ä»¶é€šçŸ¥
- æ­£ç¡®ä½¿ç”¨Watchèƒ½å¤Ÿæ„å»ºé«˜æ•ˆçš„åˆ†å¸ƒå¼åº”ç”¨ç³»ç»Ÿ