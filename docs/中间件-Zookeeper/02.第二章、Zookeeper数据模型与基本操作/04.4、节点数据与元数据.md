---
title: 4ã€èŠ‚ç‚¹æ•°æ®ä¸å…ƒæ•°æ®
---
## ğŸ“š ç›®å½•

1. [èŠ‚ç‚¹æ•°æ®å­˜å‚¨æ¦‚è¿°](#1-èŠ‚ç‚¹æ•°æ®å­˜å‚¨æ¦‚è¿°)
2. [èŠ‚ç‚¹æ•°æ®å†…å®¹è¯¦è§£](#2-èŠ‚ç‚¹æ•°æ®å†…å®¹è¯¦è§£)
3. [ç‰ˆæœ¬å·æœºåˆ¶è¯¦è§£](#3-ç‰ˆæœ¬å·æœºåˆ¶è¯¦è§£)
4. [æ—¶é—´æˆ³ä¿¡æ¯ç®¡ç†](#4-æ—¶é—´æˆ³ä¿¡æ¯ç®¡ç†)
5. [å­èŠ‚ç‚¹ç»Ÿè®¡ä¿¡æ¯](#5-å­èŠ‚ç‚¹ç»Ÿè®¡ä¿¡æ¯)
6. [æ•°æ®é•¿åº¦é™åˆ¶ä¸ä¼˜åŒ–](#6-æ•°æ®é•¿åº¦é™åˆ¶ä¸ä¼˜åŒ–)
7. [å®é™…æ“ä½œç¤ºä¾‹](#7-å®é™…æ“ä½œç¤ºä¾‹)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ“¦ èŠ‚ç‚¹æ•°æ®å­˜å‚¨æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯ZooKeeperèŠ‚ç‚¹æ•°æ®


**ğŸ”¸ é€šä¿—ç†è§£**
ZooKeeperçš„æ¯ä¸ªèŠ‚ç‚¹ï¼ˆznodeï¼‰å°±åƒä¸€ä¸ªå°ç›’å­ï¼Œè¿™ä¸ªç›’å­é‡Œæ—¢å¯ä»¥**å­˜æ”¾ä½ çš„æ•°æ®**ï¼Œä¹Ÿä¼š**è‡ªåŠ¨è®°å½•è¿™ä¸ªç›’å­çš„å„ç§ä¿¡æ¯**ã€‚

```
æƒ³è±¡ä¸€ä¸ªæ–‡ä»¶æŸœçš„æŠ½å±‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  èŠ‚ç‚¹ /app/config        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“„ å®é™…æ•°æ®å†…å®¹          â”‚  â† ä½ å­˜çš„é…ç½®ä¿¡æ¯
â”‚  database.host=localhost â”‚
â”‚  database.port=3306      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“Š ç³»ç»Ÿè‡ªåŠ¨è®°å½•çš„ä¿¡æ¯     â”‚  â† ZooKeeperè‡ªåŠ¨ç®¡ç†
â”‚  åˆ›å»ºæ—¶é—´: 2025-01-15    â”‚
â”‚  ä¿®æ”¹æ—¶é—´: 2025-01-20    â”‚
â”‚  ç‰ˆæœ¬å·: 5              â”‚
â”‚  æ•°æ®å¤§å°: 45 å­—èŠ‚       â”‚
â”‚  å­èŠ‚ç‚¹æ•°: 2             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 èŠ‚ç‚¹æ•°æ®çš„åŒé‡æ€§è´¨


**ğŸ“‹ æ•°æ®ç»„æˆç»“æ„**
```
ZooKeeperèŠ‚ç‚¹ = ç”¨æˆ·æ•°æ® + å…ƒæ•°æ®ä¿¡æ¯

ç”¨æˆ·æ•°æ®ï¼ˆDataï¼‰ï¼š
â€¢ ä½ ä¸»åŠ¨å­˜å‚¨çš„ä¸šåŠ¡æ•°æ®
â€¢ å¯ä»¥æ˜¯é…ç½®ä¿¡æ¯ã€çŠ¶æ€æ•°æ®ç­‰
â€¢ å¯ä»¥ä¸ºç©ºï¼ˆåªä½œä¸ºè·¯å¾„æ ‡è¯†ï¼‰

å…ƒæ•°æ®ï¼ˆMetadataï¼‰ï¼š
â€¢ ZooKeeperè‡ªåŠ¨ç»´æŠ¤çš„ç»Ÿè®¡ä¿¡æ¯
â€¢ åŒ…æ‹¬ç‰ˆæœ¬ã€æ—¶é—´ã€å¤§å°ç­‰
â€¢ ç”¨äºæ•°æ®ä¸€è‡´æ€§å’Œç®¡ç†
```

---

## 2. ğŸ’¾ èŠ‚ç‚¹æ•°æ®å†…å®¹è¯¦è§£


### 2.1 ç”¨æˆ·æ•°æ®å­˜å‚¨


**ğŸ”¸ ä»€ä¹ˆæ˜¯èŠ‚ç‚¹æ•°æ®å†…å®¹**
èŠ‚ç‚¹æ•°æ®å†…å®¹å°±æ˜¯ä½ å®é™…å­˜å‚¨åœ¨ZooKeeperèŠ‚ç‚¹ä¸­çš„**ä¸šåŠ¡ä¿¡æ¯**ã€‚

**ğŸ’¡ å¸¸è§çš„æ•°æ®å†…å®¹ç±»å‹**
```java
// 1. é…ç½®ä¿¡æ¯
String configData = """
{
    "database": {
        "host": "192.168.1.100",
        "port": 3306,
        "username": "admin"
    },
    "cache": {
        "redis_host": "127.0.0.1",
        "redis_port": 6379
    }
}
""";

// 2. æœåŠ¡æ³¨å†Œä¿¡æ¯
String serviceData = """
{
    "service_name": "user-service",
    "ip": "192.168.1.10",
    "port": 8080,
    "status": "running"
}
""";

// 3. ç®€å•çš„çŠ¶æ€æ ‡è¯†
String statusData = "ACTIVE";

// 4. ç©ºæ•°æ®ï¼ˆä»…ä½œä¸ºè·¯å¾„å­˜åœ¨ï¼‰
byte[] emptyData = new byte[0];
```

### 2.2 æ•°æ®å­˜å‚¨ç‰¹ç‚¹


**ğŸ”¹ æ•°æ®å­˜å‚¨æ–¹å¼**
```
å­˜å‚¨æ ¼å¼ï¼šå­—èŠ‚æ•°ç»„ï¼ˆbyte[]ï¼‰
ç¼–ç æ–¹å¼ï¼šé€šå¸¸ä½¿ç”¨UTF-8
æ•°æ®ç±»å‹ï¼šå¯ä»¥æ˜¯ä»»æ„äºŒè¿›åˆ¶æ•°æ®

å®é™…åº”ç”¨ç¤ºä¾‹ï¼š
/config/database     â†’ "host=localhost,port=3306"
/services/web-app    â†’ JSONæ ¼å¼çš„æœåŠ¡ä¿¡æ¯
/locks/task-1        â†’ ç©ºæ•°æ®ï¼ˆä»…ç”¨ä½œåˆ†å¸ƒå¼é”ï¼‰
/status/system       â†’ "RUNNING"
```

**âš ï¸ é‡è¦ç‰¹æ€§**
- **åŸå­æ€§æ“ä½œ**ï¼šæ•°æ®çš„è¯»å†™éƒ½æ˜¯åŸå­æ“ä½œï¼Œä¸ä¼šå‡ºç°éƒ¨åˆ†æ›´æ–°
- **ç‰ˆæœ¬æ§åˆ¶**ï¼šæ¯æ¬¡æ•°æ®å˜æ›´éƒ½ä¼šå¢åŠ ç‰ˆæœ¬å·
- **é€šçŸ¥æœºåˆ¶**ï¼šæ•°æ®å˜æ›´æ—¶å¯ä»¥é€šçŸ¥ç›‘å¬çš„å®¢æˆ·ç«¯

---

## 3. ğŸ·ï¸ ç‰ˆæœ¬å·æœºåˆ¶è¯¦è§£


### 3.1 ä»€ä¹ˆæ˜¯ç‰ˆæœ¬å·ï¼ˆVersionï¼‰


**ğŸ”¸ ç‰ˆæœ¬å·çš„æœ¬è´¨**
ç‰ˆæœ¬å·å°±åƒæ–‡æ¡£çš„**ä¿®æ”¹æ¬¡æ•°è®°å½•å™¨**ï¼Œæ¯æ¬¡ä½ ä¿®æ”¹èŠ‚ç‚¹æ•°æ®ï¼ŒZooKeeperå°±ä¼šè‡ªåŠ¨æŠŠç‰ˆæœ¬å·åŠ 1ã€‚

```
ç‰ˆæœ¬å·å˜åŒ–è¿‡ç¨‹ï¼š
åˆ›å»ºèŠ‚ç‚¹    â†’ version = 0
ç¬¬1æ¬¡ä¿®æ”¹   â†’ version = 1  
ç¬¬2æ¬¡ä¿®æ”¹   â†’ version = 2
ç¬¬3æ¬¡ä¿®æ”¹   â†’ version = 3
...
```

### 3.2 ç‰ˆæœ¬å·çš„ä½œç”¨æœºåˆ¶


**ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦ç‰ˆæœ¬å·**
```
åœºæ™¯é—®é¢˜ï¼šå¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶ä¿®æ”¹åŒä¸€ä¸ªèŠ‚ç‚¹
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  è¯»å–æ•°æ®    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚å®¢æˆ·ç«¯ A â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ /config/db   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚ version = 5  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  è¯»å–æ•°æ®    â”‚ data="old"   â”‚
â”‚å®¢æˆ·ç«¯ B â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¦‚æœæ²¡æœ‰ç‰ˆæœ¬æ§åˆ¶ï¼š
å®¢æˆ·ç«¯Aä¿®æ”¹ â†’ data="new_a"
å®¢æˆ·ç«¯Bä¿®æ”¹ â†’ data="new_b"  ï¼ˆè¦†ç›–äº†Açš„ä¿®æ”¹ï¼ï¼‰

æœ‰äº†ç‰ˆæœ¬æ§åˆ¶ï¼š
å®¢æˆ·ç«¯Aä¿®æ”¹ â†’ æ£€æŸ¥version=5ï¼Œä¿®æ”¹æˆåŠŸ â†’ version=6
å®¢æˆ·ç«¯Bä¿®æ”¹ â†’ æ£€æŸ¥version=5ï¼Œä½†ç°åœ¨å·²ç»æ˜¯6 â†’ ä¿®æ”¹å¤±è´¥ï¼
```

### 3.3 æ¡ä»¶æ›´æ–°æ“ä½œ


**ğŸ”§ åŸºäºç‰ˆæœ¬çš„å®‰å…¨æ›´æ–°**
```java
// å®‰å…¨çš„æ¡ä»¶æ›´æ–°ç¤ºä¾‹
public boolean updateConfigSafely(String path, String newData) {
    try {
        // 1. å…ˆè·å–å½“å‰æ•°æ®å’Œç‰ˆæœ¬å·
        Stat stat = zooKeeper.exists(path, false);
        if (stat == null) {
            return false; // èŠ‚ç‚¹ä¸å­˜åœ¨
        }
        
        int currentVersion = stat.getVersion();
        
        // 2. åŸºäºç‰ˆæœ¬å·è¿›è¡Œæ¡ä»¶æ›´æ–°
        zooKeeper.setData(path, newData.getBytes(), currentVersion);
        
        System.out.println("âœ… æ›´æ–°æˆåŠŸï¼æ–°ç‰ˆæœ¬å·: " + (currentVersion + 1));
        return true;
        
    } catch (KeeperException.BadVersionException e) {
        System.out.println("âŒ æ›´æ–°å¤±è´¥ï¼šæ•°æ®å·²è¢«å…¶ä»–å®¢æˆ·ç«¯ä¿®æ”¹");
        return false;
    }
}
```

### 3.4 ç‰ˆæœ¬å·çš„å®é™…åº”ç”¨


**ğŸ¯ å…¸å‹åº”ç”¨åœºæ™¯**
```
é…ç½®ç®¡ç†ï¼š
â€¢ é˜²æ­¢é…ç½®è¢«æ„å¤–è¦†ç›–
â€¢ ç¡®ä¿é…ç½®æ›´æ–°çš„åŸå­æ€§

åˆ†å¸ƒå¼é”ï¼š
â€¢ åŸºäºç‰ˆæœ¬å·å®ç°å…¬å¹³é”
â€¢ é˜²æ­¢é”è¢«é”™è¯¯é‡Šæ”¾

æœåŠ¡å‘ç°ï¼š
â€¢ æœåŠ¡ä¿¡æ¯çš„å®‰å…¨æ›´æ–°
â€¢ é¿å…æœåŠ¡çŠ¶æ€å†²çª
```

---

## 4. â° æ—¶é—´æˆ³ä¿¡æ¯ç®¡ç†


### 4.1 åˆ›å»ºæ—¶é—´ï¼ˆctimeï¼‰è¯¦è§£


**ğŸ”¸ ä»€ä¹ˆæ˜¯åˆ›å»ºæ—¶é—´**
åˆ›å»ºæ—¶é—´å°±æ˜¯**èŠ‚ç‚¹ç¬¬ä¸€æ¬¡è¢«åˆ›å»ºæ—¶çš„æ—¶é—´æˆ³**ï¼Œè¿™ä¸ªæ—¶é—´**æ°¸è¿œä¸ä¼šæ”¹å˜**ã€‚

```java
// åˆ›å»ºæ—¶é—´ç¤ºä¾‹
public void showCreateTime(String path) throws Exception {
    Stat stat = zooKeeper.exists(path, false);
    if (stat != null) {
        long ctime = stat.getCtime();
        Date createDate = new Date(ctime);
        
        System.out.println("èŠ‚ç‚¹è·¯å¾„: " + path);
        System.out.println("åˆ›å»ºæ—¶é—´: " + createDate);
        System.out.println("æ—¶é—´æˆ³: " + ctime + " æ¯«ç§’");
    }
}

// è¾“å‡ºç¤ºä¾‹ï¼š
// èŠ‚ç‚¹è·¯å¾„: /config/database
// åˆ›å»ºæ—¶é—´: Wed Jan 15 10:30:25 CST 2025
// æ—¶é—´æˆ³: 1705289425000 æ¯«ç§’
```

### 4.2 ä¿®æ”¹æ—¶é—´ï¼ˆmtimeï¼‰è¯¦è§£


**ğŸ”¸ ä»€ä¹ˆæ˜¯ä¿®æ”¹æ—¶é—´**
ä¿®æ”¹æ—¶é—´æ˜¯**èŠ‚ç‚¹æ•°æ®æœ€åä¸€æ¬¡è¢«ä¿®æ”¹çš„æ—¶é—´æˆ³**ï¼Œæ¯æ¬¡æ•°æ®å˜æ›´éƒ½ä¼šæ›´æ–°ã€‚

```java
// ä¿®æ”¹æ—¶é—´å˜åŒ–ç¤ºä¾‹
public void trackModificationTime(String path) throws Exception {
    // åˆ›å»ºèŠ‚ç‚¹
    zooKeeper.create(path, "initial".getBytes(), 
                    ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);
    
    Stat stat1 = zooKeeper.exists(path, false);
    System.out.println("åˆ›å»ºæ—¶é—´: " + new Date(stat1.getCtime()));
    System.out.println("ä¿®æ”¹æ—¶é—´: " + new Date(stat1.getMtime()));
    // æ­¤æ—¶ ctime == mtime
    
    Thread.sleep(2000); // ç­‰å¾…2ç§’
    
    // ä¿®æ”¹æ•°æ®
    zooKeeper.setData(path, "updated".getBytes(), -1);
    
    Stat stat2 = zooKeeper.exists(path, false);
    System.out.println("åˆ›å»ºæ—¶é—´: " + new Date(stat2.getCtime())); // ä¸å˜
    System.out.println("ä¿®æ”¹æ—¶é—´: " + new Date(stat2.getMtime())); // æ›´æ–°äº†
}
```

### 4.3 æ—¶é—´æˆ³çš„å®é™…ç”¨é€”


**ğŸ’¡ æ—¶é—´ä¿¡æ¯çš„åº”ç”¨åœºæ™¯**
```
æ•°æ®åŒæ­¥åˆ¤æ–­ï¼š
if (remoteModifyTime > localModifyTime) {
    // è¿œç¨‹æ•°æ®æ›´æ–°ï¼Œéœ€è¦åŒæ­¥
    syncDataFromRemote();
}

ç¼“å­˜å¤±æ•ˆç­–ç•¥ï¼š
if (System.currentTimeMillis() - stat.getMtime() > CACHE_EXPIRE_TIME) {
    // æ•°æ®å¤ªæ—§ï¼Œæ¸…ç†ç¼“å­˜
    clearCache(path);
}

ç›‘æ§å‘Šè­¦ï¼š
long noUpdateTime = System.currentTimeMillis() - stat.getMtime();
if (noUpdateTime > MAX_NO_UPDATE_TIME) {
    // æ•°æ®é•¿æ—¶é—´æœªæ›´æ–°ï¼Œå‘é€å‘Šè­¦
    sendAlert("æ•°æ®é•¿æ—¶é—´æœªæ›´æ–°: " + path);
}
```

---

## 5. ğŸ“Š å­èŠ‚ç‚¹ç»Ÿè®¡ä¿¡æ¯


### 5.1 å­èŠ‚ç‚¹æ•°é‡ç»Ÿè®¡


**ğŸ”¸ ä»€ä¹ˆæ˜¯å­èŠ‚ç‚¹æ•°é‡**
å­èŠ‚ç‚¹æ•°é‡å°±æ˜¯**å½“å‰èŠ‚ç‚¹ä¸‹ç›´æ¥åŒ…å«çš„å­èŠ‚ç‚¹ä¸ªæ•°**ï¼Œä¸åŒ…æ‹¬å­™å­èŠ‚ç‚¹ã€‚

```
èŠ‚ç‚¹å±‚æ¬¡ç»“æ„ç¤ºä¾‹ï¼š
/app
â”œâ”€â”€ config          â† /app çš„å­èŠ‚ç‚¹æ•° = 3
â”œâ”€â”€ services        â† /app/services çš„å­èŠ‚ç‚¹æ•° = 2
â”‚   â”œâ”€â”€ web-server
â”‚   â””â”€â”€ api-server
â””â”€â”€ logs
    â”œâ”€â”€ error.log   â† /app/logs çš„å­èŠ‚ç‚¹æ•° = 2
    â””â”€â”€ access.log
```

### 5.2 è·å–å­èŠ‚ç‚¹ç»Ÿè®¡ä¿¡æ¯


```java
public void showChildrenStats(String path) throws Exception {
    Stat stat = zooKeeper.exists(path, false);
    if (stat != null) {
        int childrenCount = stat.getNumChildren();
        System.out.println("ğŸ“ èŠ‚ç‚¹è·¯å¾„: " + path);
        System.out.println("ğŸ‘¶ å­èŠ‚ç‚¹æ•°é‡: " + childrenCount);
        
        // è·å–å­èŠ‚ç‚¹åˆ—è¡¨éªŒè¯
        List<String> children = zooKeeper.getChildren(path, false);
        System.out.println("ğŸ“‹ å­èŠ‚ç‚¹åˆ—è¡¨: " + children);
        
        // éªŒè¯æ•°é‡ä¸€è‡´æ€§
        assert childrenCount == children.size();
        System.out.println("âœ… ç»Ÿè®¡ä¿¡æ¯æ­£ç¡®");
    }
}

// è¾“å‡ºç¤ºä¾‹ï¼š
// ğŸ“ èŠ‚ç‚¹è·¯å¾„: /app/services  
// ğŸ‘¶ å­èŠ‚ç‚¹æ•°é‡: 2
// ğŸ“‹ å­èŠ‚ç‚¹åˆ—è¡¨: [web-server, api-server]
// âœ… ç»Ÿè®¡ä¿¡æ¯æ­£ç¡®
```

### 5.3 å­èŠ‚ç‚¹æ•°é‡çš„åº”ç”¨åœºæ™¯


**ğŸ¯ å®é™…åº”ç”¨ç¤ºä¾‹**
```java
// 1. æœåŠ¡å®ä¾‹æ•°é‡ç›‘æ§
public void monitorServiceInstances(String servicePath) throws Exception {
    Stat stat = zooKeeper.exists(servicePath, false);
    int instanceCount = stat.getNumChildren();
    
    if (instanceCount < MIN_INSTANCE_COUNT) {
        System.out.println("âš ï¸ è­¦å‘Šï¼šæœåŠ¡å®ä¾‹æ•°é‡ä¸è¶³ " + instanceCount);
        // è§¦å‘æ‰©å®¹é€»è¾‘
        scaleUp(servicePath);
    } else if (instanceCount > MAX_INSTANCE_COUNT) {
        System.out.println("ğŸ“ˆ æç¤ºï¼šæœåŠ¡å®ä¾‹æ•°é‡è¾ƒå¤š " + instanceCount);
        // è€ƒè™‘ç¼©å®¹
        considerScaleDown(servicePath);
    }
}

// 2. åˆ†å¸ƒå¼é˜Ÿåˆ—é•¿åº¦æ£€æŸ¥
public int getQueueLength(String queuePath) throws Exception {
    Stat stat = zooKeeper.exists(queuePath, false);
    return stat != null ? stat.getNumChildren() : 0;
}

// 3. é›†ç¾¤èŠ‚ç‚¹æ•°é‡ç»Ÿè®¡
public void checkClusterSize(String clusterPath) throws Exception {
    Stat stat = zooKeeper.exists(clusterPath, false);
    int nodeCount = stat.getNumChildren();
    
    System.out.println("ğŸ¢ é›†ç¾¤èŠ‚ç‚¹æ€»æ•°: " + nodeCount);
    
    if (nodeCount % 2 == 0) {
        System.out.println("âš ï¸ æ³¨æ„ï¼šå¶æ•°èŠ‚ç‚¹å¯èƒ½å½±å“é€‰ä¸¾");
    }
}
```

---

## 6. ğŸ“ æ•°æ®é•¿åº¦é™åˆ¶ä¸ä¼˜åŒ–


### 6.1 ZooKeeperæ•°æ®å¤§å°é™åˆ¶


**ğŸ”¸ é»˜è®¤é™åˆ¶è§„åˆ™**
```
å•ä¸ªèŠ‚ç‚¹æ•°æ®é™åˆ¶ï¼š
é»˜è®¤æœ€å¤§å€¼: 1MB (1,048,576 å­—èŠ‚)
æ¨èå¤§å°: < 1KB
æœ€ä½³å®è·µ: å‡ ç™¾å­—èŠ‚ä»¥å†…

ä¸ºä»€ä¹ˆæœ‰è¿™ä¸ªé™åˆ¶ï¼Ÿ
â€¢ ZooKeeperè®¾è®¡ç”¨äºå­˜å‚¨å…ƒæ•°æ®ï¼Œä¸æ˜¯æ•°æ®åº“
â€¢ æ‰€æœ‰æ•°æ®éƒ½ä¼šåŠ è½½åˆ°å†…å­˜ä¸­
â€¢ å¤§æ•°æ®ä¼šå½±å“ç½‘ç»œä¼ è¾“å’ŒåŒæ­¥æ€§èƒ½
```

### 6.2 æ•°æ®å¤§å°æ£€æŸ¥


```java
public class DataSizeManager {
    private static final int MAX_DATA_SIZE = 1024 * 1024; // 1MB
    private static final int RECOMMENDED_SIZE = 1024;     // 1KB
    
    public boolean validateDataSize(byte[] data) {
        int dataSize = data.length;
        
        System.out.println("ğŸ“Š æ•°æ®å¤§å°: " + dataSize + " å­—èŠ‚");
        
        if (dataSize > MAX_DATA_SIZE) {
            System.out.println("âŒ é”™è¯¯ï¼šæ•°æ®è¶…è¿‡æœ€å¤§é™åˆ¶ " + MAX_DATA_SIZE + " å­—èŠ‚");
            return false;
        } else if (dataSize > RECOMMENDED_SIZE) {
            System.out.println("âš ï¸ è­¦å‘Šï¼šæ•°æ®è¶…è¿‡æ¨èå¤§å° " + RECOMMENDED_SIZE + " å­—èŠ‚");
            System.out.println("ğŸ’¡ å»ºè®®ï¼šè€ƒè™‘æ•°æ®å‹ç¼©æˆ–å¤–éƒ¨å­˜å‚¨");
        } else {
            System.out.println("âœ… æ•°æ®å¤§å°åˆé€‚");
        }
        
        return true;
    }
    
    public void showDataStats(String path) throws Exception {
        Stat stat = zooKeeper.exists(path, false);
        if (stat != null) {
            int dataLength = stat.getDataLength();
            
            System.out.println("ğŸ“ èŠ‚ç‚¹: " + path);
            System.out.println("ğŸ“Š æ•°æ®é•¿åº¦: " + dataLength + " å­—èŠ‚");
            
            // è®¡ç®—æ•°æ®å¤§å°ç­‰çº§
            if (dataLength == 0) {
                System.out.println("ğŸ“ ç±»å‹: ç©ºèŠ‚ç‚¹ï¼ˆä»…è·¯å¾„æ ‡è¯†ï¼‰");
            } else if (dataLength < 100) {
                System.out.println("ğŸ“ ç±»å‹: å°æ•°æ®ï¼ˆé…ç½®æ ‡è¯†ï¼‰");
            } else if (dataLength < 1024) {
                System.out.println("ğŸ“ ç±»å‹: ä¸­ç­‰æ•°æ®ï¼ˆé…ç½®ä¿¡æ¯ï¼‰");
            } else {
                System.out.println("ğŸ“ ç±»å‹: å¤§æ•°æ®ï¼ˆéœ€è¦ä¼˜åŒ–ï¼‰");
            }
        }
    }
}
```

### 6.3 å¤§æ•°æ®å­˜å‚¨ä¼˜åŒ–ç­–ç•¥


**ğŸ’¡ æ•°æ®å­˜å‚¨ä¼˜åŒ–æ–¹æ¡ˆ**
```java
// 1. æ•°æ®å‹ç¼©ç­–ç•¥
public class DataCompressionUtil {
    public static byte[] compressData(String data) {
        // ä½¿ç”¨GZIPå‹ç¼©
        try (ByteArrayOutputStream baos = new ByteArrayOutputStream();
             GZIPOutputStream gzipOut = new GZIPOutputStream(baos)) {
            
            gzipOut.write(data.getBytes("UTF-8"));
            gzipOut.finish();
            
            byte[] compressed = baos.toByteArray();
            System.out.println("ğŸ—œï¸ å‹ç¼©å‰: " + data.length() + " å­—èŠ‚");
            System.out.println("ğŸ—œï¸ å‹ç¼©å: " + compressed.length + " å­—èŠ‚");
            System.out.println("ğŸ“ˆ å‹ç¼©ç‡: " + 
                (100 - compressed.length * 100 / data.length()) + "%");
            
            return compressed;
        }
    }
}

// 2. å¤–éƒ¨å­˜å‚¨å¼•ç”¨ç­–ç•¥
public class ExternalStorageStrategy {
    public void storeIargeData(String zkPath, String largeData) throws Exception {
        // å°†å¤§æ•°æ®å­˜å‚¨åˆ°å¤–éƒ¨ç³»ç»Ÿï¼ˆå¦‚æ–‡ä»¶ç³»ç»Ÿã€æ•°æ®åº“ï¼‰
        String fileId = saveToExternalStorage(largeData);
        
        // åœ¨ZooKeeperä¸­åªå­˜å‚¨å¼•ç”¨ä¿¡æ¯
        String reference = "external_ref:" + fileId;
        zooKeeper.setData(zkPath, reference.getBytes(), -1);
        
        System.out.println("ğŸ’¾ å¤§æ•°æ®å·²å­˜å‚¨åˆ°å¤–éƒ¨ç³»ç»Ÿ");
        System.out.println("ğŸ”— ZooKeeperå¼•ç”¨: " + reference);
    }
    
    private String saveToExternalStorage(String data) {
        // å®é™…å­˜å‚¨é€»è¾‘ï¼ˆæ–‡ä»¶ã€æ•°æ®åº“ç­‰ï¼‰
        String fileId = "file_" + System.currentTimeMillis();
        // ... å­˜å‚¨å®ç°
        return fileId;
    }
}

// 3. æ•°æ®åˆ†ç‰‡ç­–ç•¥
public class DataShardingStrategy {
    public void storeShardedData(String basePath, String largeData) throws Exception {
        int shardSize = 512; // æ¯ç‰‡512å­—èŠ‚
        int totalShards = (largeData.length() + shardSize - 1) / shardSize;
        
        // åˆ›å»ºåˆ†ç‰‡çˆ¶èŠ‚ç‚¹
        String shardParent = basePath + "/shards";
        createPath(shardParent);
        
        // å­˜å‚¨åˆ†ç‰‡æ•°æ®
        for (int i = 0; i < totalShards; i++) {
            int start = i * shardSize;
            int end = Math.min(start + shardSize, largeData.length());
            String shardData = largeData.substring(start, end);
            
            String shardPath = shardParent + "/shard-" + String.format("%03d", i);
            zooKeeper.create(shardPath, shardData.getBytes(), 
                           ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);
        }
        
        // å­˜å‚¨å…ƒæ•°æ®ä¿¡æ¯
        String metaInfo = "shards:" + totalShards;
        zooKeeper.setData(basePath, metaInfo.getBytes(), -1);
        
        System.out.println("ğŸ“¦ æ•°æ®å·²åˆ†ç‰‡å­˜å‚¨ï¼Œå…± " + totalShards + " ç‰‡");
    }
}
```

---

## 7. ğŸ’» å®é™…æ“ä½œç¤ºä¾‹


### 7.1 å®Œæ•´çš„èŠ‚ç‚¹ä¿¡æ¯æŸ¥çœ‹


```java
public class NodeInfoViewer {
    
    public void showCompleteNodeInfo(String path) throws Exception {
        System.out.println("ğŸ” =============== èŠ‚ç‚¹å®Œæ•´ä¿¡æ¯ ===============");
        System.out.println("ğŸ“ èŠ‚ç‚¹è·¯å¾„: " + path);
        
        // è·å–èŠ‚ç‚¹çŠ¶æ€ä¿¡æ¯
        Stat stat = zooKeeper.exists(path, false);
        if (stat == null) {
            System.out.println("âŒ èŠ‚ç‚¹ä¸å­˜åœ¨");
            return;
        }
        
        // è·å–èŠ‚ç‚¹æ•°æ®
        byte[] data = zooKeeper.getData(path, false, null);
        String dataStr = new String(data, "UTF-8");
        
        // æ˜¾ç¤ºç”¨æˆ·æ•°æ®
        System.out.println("\nğŸ“„ ========== ç”¨æˆ·æ•°æ® ==========");
        if (data.length == 0) {
            System.out.println("ğŸ“ æ•°æ®å†…å®¹: (ç©º)");
        } else {
            System.out.println("ğŸ“ æ•°æ®å†…å®¹: " + dataStr);
            System.out.println("ğŸ”¢ æ•°æ®ç¼–ç : UTF-8");
        }
        
        // æ˜¾ç¤ºå…ƒæ•°æ®ä¿¡æ¯
        System.out.println("\nğŸ“Š ========== å…ƒæ•°æ®ä¿¡æ¯ ==========");
        System.out.println("ğŸ·ï¸ ç‰ˆæœ¬å·: " + stat.getVersion());
        System.out.println("ğŸ“ æ•°æ®é•¿åº¦: " + stat.getDataLength() + " å­—èŠ‚");
        System.out.println("ğŸ‘¶ å­èŠ‚ç‚¹æ•°: " + stat.getNumChildren());
        
        // æ—¶é—´ä¿¡æ¯
        System.out.println("\nâ° ========== æ—¶é—´ä¿¡æ¯ ==========");
        System.out.println("ğŸ• åˆ›å»ºæ—¶é—´: " + formatTime(stat.getCtime()));
        System.out.println("ğŸ• ä¿®æ”¹æ—¶é—´: " + formatTime(stat.getMtime()));
        
        // å…¶ä»–ç»Ÿè®¡ä¿¡æ¯
        System.out.println("\nğŸ“ˆ ========== å…¶ä»–ä¿¡æ¯ ==========");
        System.out.println("ğŸ†” ä¼šè¯ID: " + Long.toHexString(stat.getEphemeralOwner()));
        System.out.println("ğŸ”„ äº‹åŠ¡ID: " + stat.getPzxid());
        System.out.println("ğŸ‘¶ å­èŠ‚ç‚¹ç‰ˆæœ¬: " + stat.getCversion());
        
        // å¦‚æœæœ‰å­èŠ‚ç‚¹ï¼Œæ˜¾ç¤ºå­èŠ‚ç‚¹åˆ—è¡¨
        if (stat.getNumChildren() > 0) {
            List<String> children = zooKeeper.getChildren(path, false);
            System.out.println("\nğŸ“‹ ========== å­èŠ‚ç‚¹åˆ—è¡¨ ==========");
            for (String child : children) {
                System.out.println("  ğŸ“ " + child);
            }
        }
        
        System.out.println("ğŸ” ==========================================");
    }
    
    private String formatTime(long timestamp) {
        if (timestamp == 0) return "N/A";
        return new SimpleDateFormat("yyyy-MM-dd HH:mm:ss").format(new Date(timestamp));
    }
}
```

### 7.2 æ•°æ®ç‰ˆæœ¬æ§åˆ¶ç¤ºä¾‹


```java
public class VersionControlDemo {
    
    public void demonstrateVersionControl(String path) throws Exception {
        System.out.println("ğŸ¯ ========= ç‰ˆæœ¬æ§åˆ¶æ¼”ç¤º =========");
        
        // 1. åˆ›å»ºèŠ‚ç‚¹
        String initialData = "version-0-data";
        zooKeeper.create(path, initialData.getBytes(), 
                        ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);
        
        Stat stat = zooKeeper.exists(path, false);
        System.out.println("âœ… åˆ›å»ºèŠ‚ç‚¹ï¼Œåˆå§‹ç‰ˆæœ¬: " + stat.getVersion());
        
        // 2. æ­£å¸¸æ›´æ–°æ“ä½œ
        for (int i = 1; i <= 3; i++) {
            String newData = "version-" + i + "-data";
            stat = zooKeeper.setData(path, newData.getBytes(), -1); // -1è¡¨ç¤ºå¿½ç•¥ç‰ˆæœ¬æ£€æŸ¥
            System.out.println("ğŸ”„ ç¬¬" + i + "æ¬¡æ›´æ–°ï¼Œæ–°ç‰ˆæœ¬: " + stat.getVersion());
            Thread.sleep(100);
        }
        
        // 3. æ¼”ç¤ºç‰ˆæœ¬å†²çª
        System.out.println("\nâš ï¸ ===== æ¼”ç¤ºç‰ˆæœ¬å†²çª =====");
        
        // è·å–å½“å‰ç‰ˆæœ¬
        stat = zooKeeper.exists(path, false);
        int currentVersion = stat.getVersion();
        System.out.println("ğŸ“‹ å½“å‰ç‰ˆæœ¬: " + currentVersion);
        
        // æ¨¡æ‹Ÿå®¢æˆ·ç«¯AåŸºäºå½“å‰ç‰ˆæœ¬æ›´æ–°
        try {
            zooKeeper.setData(path, "client-A-data".getBytes(), currentVersion);
            System.out.println("âœ… å®¢æˆ·ç«¯Aæ›´æ–°æˆåŠŸ");
        } catch (KeeperException.BadVersionException e) {
            System.out.println("âŒ å®¢æˆ·ç«¯Aæ›´æ–°å¤±è´¥ï¼šç‰ˆæœ¬å†²çª");
        }
        
        // æ¨¡æ‹Ÿå®¢æˆ·ç«¯Bä»ç„¶åŸºäºæ—§ç‰ˆæœ¬æ›´æ–°
        try {
            zooKeeper.setData(path, "client-B-data".getBytes(), currentVersion);
            System.out.println("âœ… å®¢æˆ·ç«¯Bæ›´æ–°æˆåŠŸ");
        } catch (KeeperException.BadVersionException e) {
            System.out.println("âŒ å®¢æˆ·ç«¯Bæ›´æ–°å¤±è´¥ï¼šç‰ˆæœ¬å†²çª");
        }
        
        // æ˜¾ç¤ºæœ€ç»ˆçŠ¶æ€
        byte[] finalData = zooKeeper.getData(path, false, stat);
        System.out.println("ğŸ æœ€ç»ˆæ•°æ®: " + new String(finalData));
        System.out.println("ğŸ æœ€ç»ˆç‰ˆæœ¬: " + stat.getVersion());
    }
}
```

### 7.3 ç›‘æ§èŠ‚ç‚¹å˜åŒ–


```java
public class NodeChangeMonitor implements Watcher {
    
    public void startMonitoring(String path) throws Exception {
        System.out.println("ğŸ‘€ å¼€å§‹ç›‘æ§èŠ‚ç‚¹: " + path);
        
        // è®¾ç½®æ•°æ®ç›‘å¬å™¨
        zooKeeper.getData(path, this, null);
        
        // è®¾ç½®å­èŠ‚ç‚¹ç›‘å¬å™¨
        zooKeeper.getChildren(path, this);
        
        System.out.println("âœ… ç›‘æ§å·²å¯åŠ¨ï¼Œç­‰å¾…å˜åŒ–...");
    }
    
    @Override
    public void process(WatchedEvent event) {
        String path = event.getPath();
        Event.EventType type = event.getType();
        
        System.out.println("\nğŸ”” ===== æ£€æµ‹åˆ°å˜åŒ– =====");
        System.out.println("ğŸ“ èŠ‚ç‚¹è·¯å¾„: " + path);
        System.out.println("ğŸ¯ å˜åŒ–ç±»å‹: " + type);
        System.out.println("â° å‘ç”Ÿæ—¶é—´: " + new Date());
        
        try {
            switch (type) {
                case NodeDataChanged:
                    handleDataChange(path);
                    break;
                case NodeChildrenChanged:
                    handleChildrenChange(path);
                    break;
                case NodeCreated:
                    System.out.println("âœ¨ èŠ‚ç‚¹è¢«åˆ›å»º");
                    break;
                case NodeDeleted:
                    System.out.println("ğŸ—‘ï¸ èŠ‚ç‚¹è¢«åˆ é™¤");
                    break;
            }
        } catch (Exception e) {
            System.out.println("âŒ å¤„ç†å˜åŒ–æ—¶å‡ºé”™: " + e.getMessage());
        }
        
        System.out.println("ğŸ”” ====================\n");
    }
    
    private void handleDataChange(String path) throws Exception {
        Stat stat = new Stat();
        byte[] data = zooKeeper.getData(path, this, stat); // é‡æ–°è®¾ç½®ç›‘å¬
        
        System.out.println("ğŸ“ æ–°æ•°æ®å†…å®¹: " + new String(data));
        System.out.println("ğŸ·ï¸ æ–°ç‰ˆæœ¬å·: " + stat.getVersion());
        System.out.println("ğŸ“ æ•°æ®å¤§å°: " + stat.getDataLength() + " å­—èŠ‚");
        System.out.println("â° ä¿®æ”¹æ—¶é—´: " + new Date(stat.getMtime()));
    }
    
    private void handleChildrenChange(String path) throws Exception {
        List<String> children = zooKeeper.getChildren(path, this); // é‡æ–°è®¾ç½®ç›‘å¬
        
        System.out.println("ğŸ‘¶ æ–°çš„å­èŠ‚ç‚¹æ•°é‡: " + children.size());
        System.out.println("ğŸ“‹ å­èŠ‚ç‚¹åˆ—è¡¨: " + children);
    }
}
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ èŠ‚ç‚¹æ•°æ® = ç”¨æˆ·æ•°æ® + å…ƒæ•°æ®ä¿¡æ¯
ğŸ”¸ ç‰ˆæœ¬å·ï¼šæ¯æ¬¡ä¿®æ”¹è‡ªåŠ¨é€’å¢ï¼Œç”¨äºå¹¶å‘æ§åˆ¶
ğŸ”¸ åˆ›å»ºæ—¶é—´ï¼šèŠ‚ç‚¹åˆ›å»ºæ—¶é—´æˆ³ï¼Œæ°¸ä¸æ”¹å˜
ğŸ”¸ ä¿®æ”¹æ—¶é—´ï¼šæ•°æ®æœ€åä¿®æ”¹æ—¶é—´æˆ³ï¼Œå˜æ›´æ—¶æ›´æ–°
ğŸ”¸ å­èŠ‚ç‚¹æ•°ï¼šç›´æ¥å­èŠ‚ç‚¹æ•°é‡ç»Ÿè®¡
ğŸ”¸ æ•°æ®é™åˆ¶ï¼šå•èŠ‚ç‚¹æœ€å¤§1MBï¼Œæ¨è1KBä»¥å†…
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ç‰ˆæœ¬å·æœºåˆ¶çš„é‡è¦æ€§**
```
ä½œç”¨åŸç†ï¼š
â€¢ é˜²æ­¢å¹¶å‘ä¿®æ”¹å†²çª
â€¢ å®ç°ä¹è§‚é”æœºåˆ¶
â€¢ ä¿è¯æ•°æ®ä¸€è‡´æ€§

å®é™…æ„ä¹‰ï¼š
â€¢ é…ç½®æ›´æ–°çš„å®‰å…¨æ€§
â€¢ åˆ†å¸ƒå¼åè°ƒçš„å¯é æ€§
â€¢ æ•°æ®åŒæ­¥çš„å‡†ç¡®æ€§
```

**ğŸ”¹ æ—¶é—´æˆ³çš„åŒºåˆ«å’Œç”¨é€”**
```
åˆ›å»ºæ—¶é—´ vs ä¿®æ”¹æ—¶é—´ï¼š
â€¢ ctimeï¼šç”Ÿæ—¥ï¼Œæ°¸è¿œä¸å˜
â€¢ mtimeï¼šæœ€è¿‘ä½“æ£€æ—¶é—´ï¼Œä¼šæ›´æ–°

åº”ç”¨åœºæ™¯ï¼š
â€¢ æ•°æ®åŒæ­¥åˆ¤æ–­
â€¢ ç¼“å­˜å¤±æ•ˆç­–ç•¥  
â€¢ ç›‘æ§å‘Šè­¦æœºåˆ¶
```

**ğŸ”¹ æ•°æ®å¤§å°é™åˆ¶çš„è€ƒé‡**
```
è®¾è®¡ç†å¿µï¼š
â€¢ ZooKeeperæ˜¯åè°ƒæœåŠ¡ï¼Œä¸æ˜¯å­˜å‚¨ç³»ç»Ÿ
â€¢ å…ƒæ•°æ®åº”è¯¥è½»é‡çº§
â€¢ ç½‘ç»œä¼ è¾“å’Œå†…å­˜æ•ˆç‡ä¼˜å…ˆ

ä¼˜åŒ–ç­–ç•¥ï¼š
â€¢ å‹ç¼©å¤§æ•°æ®
â€¢ å¤–éƒ¨å­˜å‚¨å¼•ç”¨
â€¢ æ•°æ®åˆ†ç‰‡å¤„ç†
```

### 8.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ ä¸šåŠ¡åœºæ™¯åº”ç”¨**
- **é…ç½®ä¸­å¿ƒ**ï¼šç‰ˆæœ¬æ§åˆ¶ç¡®ä¿é…ç½®æ›´æ–°å®‰å…¨
- **æœåŠ¡å‘ç°**ï¼šæ—¶é—´æˆ³åˆ¤æ–­æœåŠ¡ä¿¡æ¯æ–°æ—§
- **åˆ†å¸ƒå¼é”**ï¼šç‰ˆæœ¬å·å®ç°å…¬å¹³é”æœºåˆ¶
- **é›†ç¾¤ç®¡ç†**ï¼šå­èŠ‚ç‚¹æ•°ç»Ÿè®¡é›†ç¾¤è§„æ¨¡
- **ç›‘æ§å‘Šè­¦**ï¼šåŸºäºæ—¶é—´æˆ³çš„å¥åº·æ£€æŸ¥

**ğŸ”§ å¼€å‘å®è·µè¦ç‚¹**
- **æ•°æ®è®¾è®¡**ï¼šä¿æŒæ•°æ®è½»é‡ï¼Œä¼˜å…ˆè€ƒè™‘å…ƒæ•°æ®
- **å¹¶å‘æ§åˆ¶**ï¼šå–„ç”¨ç‰ˆæœ¬å·æœºåˆ¶é˜²æ­¢å†²çª
- **ç›‘æ§ç­–ç•¥**ï¼šåŸºäºæ—¶é—´æˆ³å»ºç«‹ç›‘æ§ä½“ç³»
- **æ€§èƒ½ä¼˜åŒ–**ï¼šåˆç†åˆ©ç”¨ç»Ÿè®¡ä¿¡æ¯å‡å°‘ä¸å¿…è¦æŸ¥è¯¢

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- ZooKeeperèŠ‚ç‚¹æ—¢å­˜æ•°æ®åˆè®°å½•å…ƒä¿¡æ¯
- ç‰ˆæœ¬å·æ˜¯å¹¶å‘å®‰å…¨çš„å®ˆæŠ¤ç¥
- æ—¶é—´æˆ³æ˜¯æ•°æ®æ–°é²œåº¦çš„æŒ‡ç¤ºå™¨
- æ•°æ®è¦è½»é‡ï¼Œå¤§æ•°æ®éœ€å¤–å­˜
- ç»Ÿè®¡ä¿¡æ¯å¸®åŠ©ä¼˜åŒ–å’Œç›‘æ§å†³ç­–