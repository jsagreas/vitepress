---
title: 6ã€Watchç›‘å¬æœºåˆ¶
---
## ğŸ“š ç›®å½•

1. [Watchç›‘å¬æœºåˆ¶æ¦‚è¿°](#1-Watchç›‘å¬æœºåˆ¶æ¦‚è¿°)
2. [Watchäº‹ä»¶ç±»å‹è¯¦è§£](#2-Watchäº‹ä»¶ç±»å‹è¯¦è§£)
3. [Watchç‰¹æ€§ä¸å·¥ä½œåŸç†](#3-Watchç‰¹æ€§ä¸å·¥ä½œåŸç†)
4. [Watchå®æˆ˜åº”ç”¨](#4-Watchå®æˆ˜åº”ç”¨)
5. [Watchæœ€ä½³å®è·µ](#5-Watchæœ€ä½³å®è·µ)
6. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#6-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” Watchç›‘å¬æœºåˆ¶æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯Watchæœºåˆ¶


**ğŸ¯ ç®€å•ç†è§£**ï¼šWatchå°±åƒç»™ZooKeeperèŠ‚ç‚¹å®‰è£…ä¸€ä¸ª"ç›‘æ§æ‘„åƒå¤´"

```
ç±»æ¯”ç†è§£ï¼š
ä½ åœ¨å®¶é—¨å£è£…äº†ä¸ªæ‘„åƒå¤´ â†’ Watchç›‘å¬å™¨
æœ‰äººç»è¿‡ä½ å®¶é—¨å£ â†’ ZooKeeperèŠ‚ç‚¹å‘ç”Ÿå˜åŒ–  
æ‘„åƒå¤´é©¬ä¸Šæé†’ä½  â†’ è§¦å‘Watchäº‹ä»¶é€šçŸ¥å®¢æˆ·ç«¯
```

**ğŸ’¡ æ ¸å¿ƒå®šä¹‰**
```
Watchç›‘å¬æœºåˆ¶ï¼šZooKeeperæä¾›çš„äº‹ä»¶é€šçŸ¥åŠŸèƒ½
- å®¢æˆ·ç«¯å¯ä»¥å¯¹ç‰¹å®šèŠ‚ç‚¹è®¾ç½®ç›‘å¬
- èŠ‚ç‚¹å‘ç”Ÿå˜åŒ–æ—¶ï¼ŒZooKeeperä¸»åŠ¨é€šçŸ¥å®¢æˆ·ç«¯
- å®ç°æ•°æ®å˜åŒ–çš„å®æ—¶æ„ŸçŸ¥
```

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦Watchæœºåˆ¶


**ğŸš€ è§£å†³çš„é—®é¢˜**
```
ä¼ ç»Ÿè½®è¯¢æ–¹å¼ï¼š
å®¢æˆ·ç«¯æ¯éš”ä¸€æ®µæ—¶é—´æŸ¥è¯¢ï¼š
"æ•°æ®å˜äº†å—ï¼Ÿ" â†’ "æ²¡å˜"
"æ•°æ®å˜äº†å—ï¼Ÿ" â†’ "æ²¡å˜"  
"æ•°æ®å˜äº†å—ï¼Ÿ" â†’ "å˜äº†ï¼"

é—®é¢˜ï¼š
âŒ æµªè´¹ç½‘ç»œèµ„æº
âŒ å¢åŠ æœåŠ¡å™¨è´Ÿæ‹…
âŒ æ— æ³•å®æ—¶å“åº”
```

**âœ… Watchæœºåˆ¶çš„ä¼˜åŠ¿**
```
äº‹ä»¶é©±åŠ¨æ–¹å¼ï¼š
1. è®¾ç½®ç›‘å¬ï¼š"è¯·åœ¨æ•°æ®å˜åŒ–æ—¶é€šçŸ¥æˆ‘"
2. æ­£å¸¸å·¥ä½œï¼šå®¢æˆ·ç«¯ä¸“å¿ƒåšè‡ªå·±çš„äº‹
3. å˜åŒ–é€šçŸ¥ï¼šZooKeeperä¸»åŠ¨å‘é€é€šçŸ¥
4. å³æ—¶å“åº”ï¼šå®¢æˆ·ç«¯ç«‹å³å¤„ç†å˜åŒ–

ä¼˜åŠ¿ï¼š
âœ… å®æ—¶å“åº”
âœ… èŠ‚çœèµ„æº
âœ… é«˜æ•ˆé€šä¿¡
```

### 1.3 Watchæœºåˆ¶çš„åº”ç”¨åœºæ™¯


```
ğŸ’¼ é…ç½®ç®¡ç†ï¼š
åº”ç”¨ç¨‹åºç›‘å¬é…ç½®èŠ‚ç‚¹ï¼Œé…ç½®æ›´æ–°æ—¶è‡ªåŠ¨ç”Ÿæ•ˆ

ğŸ”„ æœåŠ¡å‘ç°ï¼š
ç›‘å¬æœåŠ¡èŠ‚ç‚¹ï¼ŒæœåŠ¡ä¸Šä¸‹çº¿æ—¶åŠæ—¶æ„ŸçŸ¥

âš–ï¸ è´Ÿè½½å‡è¡¡ï¼š
ç›‘å¬æœåŠ¡å™¨åˆ—è¡¨ï¼ŒåŠ¨æ€è°ƒæ•´è´Ÿè½½åˆ†é…

ğŸ” åˆ†å¸ƒå¼é”ï¼š
ç›‘å¬é”èŠ‚ç‚¹ï¼Œé”é‡Šæ”¾æ—¶ç«‹å³è·å–

ğŸ“Š é›†ç¾¤ç®¡ç†ï¼š
ç›‘å¬æˆå‘˜èŠ‚ç‚¹ï¼Œé›†ç¾¤å˜åŒ–æ—¶è‡ªåŠ¨è°ƒæ•´
```

---

## 2. ğŸ¯ Watchäº‹ä»¶ç±»å‹è¯¦è§£


### 2.1 äº‹ä»¶ç±»å‹æ€»è§ˆ


```
ZooKeeper Watchäº‹ä»¶ä½“ç³»ï¼š

è¿æ¥çŠ¶æ€äº‹ä»¶ï¼š
- Noneï¼šå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨è¿æ¥çŠ¶æ€å‘ç”Ÿå˜åŒ–

èŠ‚ç‚¹äº‹ä»¶ï¼š
- NodeCreatedï¼šèŠ‚ç‚¹è¢«åˆ›å»º
- NodeDeletedï¼šèŠ‚ç‚¹è¢«åˆ é™¤  
- NodeDataChangedï¼šèŠ‚ç‚¹æ•°æ®å‘ç”Ÿå˜åŒ–
- NodeChildrenChangedï¼šå­èŠ‚ç‚¹åˆ—è¡¨å‘ç”Ÿå˜åŒ–
```

### 2.2 NodeCreatedäº‹ä»¶


**ğŸ”¸ è§¦å‘æ¡ä»¶**ï¼šç›‘å¬çš„èŠ‚ç‚¹è¢«åˆ›å»ºæ—¶è§¦å‘

**ğŸ“ å·¥ä½œæµç¨‹**
```
æ­¥éª¤æµç¨‹ï¼š
1. å®¢æˆ·ç«¯å¯¹ä¸å­˜åœ¨çš„èŠ‚ç‚¹ /app/config è®¾ç½®ç›‘å¬
2. å…¶ä»–å®¢æˆ·ç«¯åˆ›å»ºèŠ‚ç‚¹ /app/config
3. ZooKeeperè§¦å‘NodeCreatedäº‹ä»¶
4. é€šçŸ¥æ‰€æœ‰ç›‘å¬è¯¥èŠ‚ç‚¹çš„å®¢æˆ·ç«¯

åº”ç”¨åœºæ™¯ï¼š
- ç­‰å¾…é…ç½®æ–‡ä»¶åˆ›å»º
- ç›‘æ§æœåŠ¡å¯åŠ¨
- èµ„æºåˆå§‹åŒ–å®Œæˆé€šçŸ¥
```

**ğŸ’» ä»£ç ç¤ºä¾‹**
```java
// ç›‘å¬èŠ‚ç‚¹åˆ›å»º
public class NodeCreatedExample {
    public static void main(String[] args) throws Exception {
        ZooKeeper zk = new ZooKeeper("localhost:2181", 3000, null);
        
        // å¯¹ä¸å­˜åœ¨çš„èŠ‚ç‚¹è®¾ç½®ç›‘å¬
        Stat stat = zk.exists("/app/config", new Watcher() {
            @Override
            public void process(WatchedEvent event) {
                if (event.getType() == Event.EventType.NodeCreated) {
                    System.out.println("é…ç½®èŠ‚ç‚¹å·²åˆ›å»ºï¼");
                    // å¯ä»¥å¼€å§‹è¯»å–é…ç½®äº†
                }
            }
        });
        
        if (stat == null) {
            System.out.println("èŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œç­‰å¾…åˆ›å»º...");
        }
    }
}
```

### 2.3 NodeDeletedäº‹ä»¶


**ğŸ”¸ è§¦å‘æ¡ä»¶**ï¼šç›‘å¬çš„èŠ‚ç‚¹è¢«åˆ é™¤æ—¶è§¦å‘

**ğŸ“ å·¥ä½œæµç¨‹**
```
æ­¥éª¤æµç¨‹ï¼š
1. å®¢æˆ·ç«¯ç›‘å¬å·²å­˜åœ¨çš„èŠ‚ç‚¹ /app/server1
2. å…¶ä»–å®¢æˆ·ç«¯åˆ é™¤èŠ‚ç‚¹ /app/server1
3. ZooKeeperè§¦å‘NodeDeletedäº‹ä»¶
4. é€šçŸ¥å®¢æˆ·ç«¯èŠ‚ç‚¹å·²è¢«åˆ é™¤

åº”ç”¨åœºæ™¯ï¼š
- æœåŠ¡ä¸‹çº¿é€šçŸ¥
- èµ„æºæ¸…ç†è§¦å‘
- æ•…éšœæ£€æµ‹
```

**ğŸ’» ä»£ç ç¤ºä¾‹**
```java
// ç›‘å¬èŠ‚ç‚¹åˆ é™¤
zk.exists("/app/server1", new Watcher() {
    @Override
    public void process(WatchedEvent event) {
        if (event.getType() == Event.EventType.NodeDeleted) {
            System.out.println("æœåŠ¡å™¨server1å·²ä¸‹çº¿ï¼");
            // ä»è´Ÿè½½å‡è¡¡åˆ—è¡¨ä¸­ç§»é™¤
            removeFromLoadBalancer("server1");
        }
    }
});
```

### 2.4 NodeDataChangedäº‹ä»¶


**ğŸ”¸ è§¦å‘æ¡ä»¶**ï¼šèŠ‚ç‚¹çš„æ•°æ®å†…å®¹å‘ç”Ÿå˜åŒ–æ—¶è§¦å‘

**ğŸ“ å·¥ä½œæµç¨‹**
```
æ­¥éª¤æµç¨‹ï¼š
1. å®¢æˆ·ç«¯ç›‘å¬èŠ‚ç‚¹ /app/config
2. å…¶ä»–å®¢æˆ·ç«¯ä¿®æ”¹èŠ‚ç‚¹æ•°æ®ï¼šsetData()
3. ZooKeeperè§¦å‘NodeDataChangedäº‹ä»¶
4. å®¢æˆ·ç«¯æ”¶åˆ°é€šçŸ¥ï¼Œé‡æ–°è¯»å–æ•°æ®

é‡è¦è¯´æ˜ï¼š
âœ… æ•°æ®å†…å®¹æ”¹å˜æ‰è§¦å‘
âŒ ç‰ˆæœ¬å·å˜åŒ–ä½†å†…å®¹ç›¸åŒä¸è§¦å‘
```

**ğŸ’» ä»£ç ç¤ºä¾‹**
```java
// ç›‘å¬é…ç½®å˜åŒ–
zk.getData("/app/config", new Watcher() {
    @Override
    public void process(WatchedEvent event) {
        if (event.getType() == Event.EventType.NodeDataChanged) {
            try {
                // é‡æ–°è¯»å–æœ€æ–°é…ç½®
                byte[] newData = zk.getData("/app/config", true, null);
                String config = new String(newData);
                System.out.println("é…ç½®å·²æ›´æ–°: " + config);
                // åº”ç”¨æ–°é…ç½®
                applyNewConfig(config);
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }
}, null);
```

### 2.5 NodeChildrenChangedäº‹ä»¶


**ğŸ”¸ è§¦å‘æ¡ä»¶**ï¼šèŠ‚ç‚¹çš„å­èŠ‚ç‚¹åˆ—è¡¨å‘ç”Ÿå˜åŒ–æ—¶è§¦å‘

**ğŸ“ å·¥ä½œæµç¨‹**
```
è§¦å‘æƒ…å†µï¼š
âœ… æ·»åŠ å­èŠ‚ç‚¹
âœ… åˆ é™¤å­èŠ‚ç‚¹
âŒ å­èŠ‚ç‚¹æ•°æ®å˜åŒ–ï¼ˆä¸è§¦å‘ï¼‰
âŒ å­™å­èŠ‚ç‚¹å˜åŒ–ï¼ˆä¸è§¦å‘ï¼‰

åº”ç”¨åœºæ™¯ï¼š
- æœåŠ¡å™¨é›†ç¾¤ç›‘æ§
- ä»»åŠ¡é˜Ÿåˆ—ç›‘æ§
- é…ç½®åˆ†ç»„ç›‘æ§
```

**ğŸ’» ä»£ç ç¤ºä¾‹**
```java
// ç›‘å¬æœåŠ¡å™¨é›†ç¾¤å˜åŒ–
zk.getChildren("/servers", new Watcher() {
    @Override
    public void process(WatchedEvent event) {
        if (event.getType() == Event.EventType.NodeChildrenChanged) {
            try {
                // è·å–æœ€æ–°çš„æœåŠ¡å™¨åˆ—è¡¨
                List<String> servers = zk.getChildren("/servers", true);
                System.out.println("æœåŠ¡å™¨åˆ—è¡¨æ›´æ–°: " + servers);
                // æ›´æ–°è´Ÿè½½å‡è¡¡é…ç½®
                updateLoadBalancer(servers);
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }
});
```

### 2.6 äº‹ä»¶ç±»å‹å¯¹ç…§è¡¨


| **äº‹ä»¶ç±»å‹** | **è§¦å‘æ“ä½œ** | **ç›‘å¬æ–¹æ³•** | **åº”ç”¨åœºæ™¯** |
|------------|------------|------------|------------|
| **NodeCreated** | `create()` | `exists()` | ç­‰å¾…èµ„æºåˆ›å»º |
| **NodeDeleted** | `delete()` | `exists()`, `getData()` | æœåŠ¡ä¸‹çº¿é€šçŸ¥ |
| **NodeDataChanged** | `setData()` | `getData()` | é…ç½®åŠ¨æ€æ›´æ–° |
| **NodeChildrenChanged** | `create()`å­èŠ‚ç‚¹, `delete()`å­èŠ‚ç‚¹ | `getChildren()` | é›†ç¾¤æˆå‘˜å˜åŒ– |

---

## 3. âš™ï¸ Watchç‰¹æ€§ä¸å·¥ä½œåŸç†


### 3.1 Watchçš„æ ¸å¿ƒç‰¹æ€§


**ğŸ”¸ ç‰¹æ€§ä¸€ï¼šä¸€æ¬¡æ€§è§¦å‘**
```
é‡è¦ç‰¹æ€§ï¼šWatchæ˜¯ä¸€æ¬¡æ€§çš„ï¼

å·¥ä½œæµç¨‹ï¼š
1. è®¾ç½®Watchç›‘å¬
2. äº‹ä»¶è§¦å‘ï¼Œæ”¶åˆ°é€šçŸ¥
3. Watchè‡ªåŠ¨å¤±æ•ˆ
4. éœ€è¦é‡æ–°è®¾ç½®Watch

ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ
- é¿å…é‡å¤é€šçŸ¥
- é˜²æ­¢äº‹ä»¶å †ç§¯
- ç¡®ä¿å®¢æˆ·ç«¯å¤„ç†åŠæ—¶æ€§
```

**ğŸ’» æ­£ç¡®çš„æŒç»­ç›‘å¬å†™æ³•**
```java
public void watchForever(String path) {
    try {
        // è®¾ç½®ç›‘å¬å¹¶é‡æ–°æ³¨å†Œ
        zk.getData(path, new Watcher() {
            @Override
            public void process(WatchedEvent event) {
                if (event.getType() == Event.EventType.NodeDataChanged) {
                    System.out.println("æ•°æ®å·²å˜åŒ–");
                    // å¤„ç†å˜åŒ–
                    handleDataChange();
                    
                    // é‡è¦ï¼šé‡æ–°è®¾ç½®ç›‘å¬
                    watchForever(path);
                }
            }
        }, null);
    } catch (Exception e) {
        e.printStackTrace();
    }
}
```

**ğŸ”¸ ç‰¹æ€§äºŒï¼šå¼‚æ­¥é€šçŸ¥**
```
é€šçŸ¥æ–¹å¼ï¼š
- Watchäº‹ä»¶é€šè¿‡å¼‚æ­¥å›è°ƒé€šçŸ¥å®¢æˆ·ç«¯
- ä¸ä¼šé˜»å¡ZooKeeperæœåŠ¡å™¨
- å®¢æˆ·ç«¯åœ¨ç‹¬ç«‹çº¿ç¨‹ä¸­å¤„ç†äº‹ä»¶

å¥½å¤„ï¼š
âœ… é«˜æ€§èƒ½
âœ… éé˜»å¡
âœ… å¹¶å‘å¤„ç†
```

**ğŸ”¸ ç‰¹æ€§ä¸‰ï¼šè½»é‡çº§**
```
ä¼ è¾“å†…å®¹ï¼š
- åªä¼ è¾“äº‹ä»¶ç±»å‹å’Œè·¯å¾„
- ä¸ä¼ è¾“å˜åŒ–çš„å…·ä½“æ•°æ®
- å®¢æˆ·ç«¯éœ€è¦ä¸»åŠ¨è·å–æ–°æ•°æ®

è®¾è®¡ç†ç”±ï¼š
- å‡å°‘ç½‘ç»œä¼ è¾“
- æé«˜é€šçŸ¥æ•ˆç‡  
- é¿å…æ•°æ®ä¸ä¸€è‡´
```

### 3.2 Watchå·¥ä½œåŸç†å›¾è§£


```
ZooKeeper Watchå·¥ä½œæµç¨‹ï¼š

å®¢æˆ·ç«¯A                    ZooKeeperæœåŠ¡å™¨                å®¢æˆ·ç«¯B
   |                           |                         |
   |--[1]getData("/config",--> |                         |
   |    with Watcher)          |                         |
   |                           |--[2]æ³¨å†ŒWatchç›‘å¬------>|Watchè¡¨
   |<--[3]è¿”å›æ•°æ®-------------|                         |
   |                           |                         |
   |                           |<--[4]setData("/config")-|
   |                           |                         |
   |                           |--[5]æ£€æŸ¥Watchè¡¨-------->|Watchè¡¨
   |<--[6]å‘é€Watchäº‹ä»¶--------|                         |
   |                           |--[7]åˆ é™¤Watchè®°å½•------>|Watchè¡¨
   |                           |                         |
   |--[8]é‡æ–°getData()------->|                         |
   |   (é‡æ–°è®¾ç½®Watch)         |                         |

å…³é”®æ­¥éª¤è¯´æ˜ï¼š
[1-3] å®¢æˆ·ç«¯Aè®¾ç½®ç›‘å¬å¹¶è·å–æ•°æ®
[4] å®¢æˆ·ç«¯Bä¿®æ”¹æ•°æ®  
[5] æœåŠ¡å™¨æ£€æŸ¥è¯¥èŠ‚ç‚¹çš„ç›‘å¬åˆ—è¡¨
[6] å‘æ‰€æœ‰ç›‘å¬å®¢æˆ·ç«¯å‘é€äº‹ä»¶é€šçŸ¥
[7] åˆ é™¤å·²è§¦å‘çš„Watchè®°å½•ï¼ˆä¸€æ¬¡æ€§ç‰¹æ€§ï¼‰
[8] å®¢æˆ·ç«¯é‡æ–°è®¾ç½®ç›‘å¬ï¼ˆå¦‚æœéœ€è¦æŒç»­ç›‘å¬ï¼‰
```

### 3.3 Watchæ³¨å†Œæ–¹å¼


**ğŸ“‹ ä¸‰ç§æ³¨å†Œæ–¹å¼**

| **æ–¹æ³•** | **ç›‘å¬äº‹ä»¶** | **è¯´æ˜** |
|----------|------------|----------|
| `exists()` | NodeCreated, NodeDeleted, NodeDataChanged | ç›‘å¬èŠ‚ç‚¹å­˜åœ¨æ€§å’Œæ•°æ®å˜åŒ– |
| `getData()` | NodeDeleted, NodeDataChanged | ç›‘å¬å·²å­˜åœ¨èŠ‚ç‚¹çš„æ•°æ®å˜åŒ– |
| `getChildren()` | NodeChildrenChanged | ç›‘å¬å­èŠ‚ç‚¹åˆ—è¡¨å˜åŒ– |

**ğŸ’» æ³¨å†Œæ–¹å¼ç¤ºä¾‹**
```java
// æ–¹å¼1ï¼šé€šè¿‡exists()æ³¨å†Œ
Stat stat = zk.exists("/config", watcher);

// æ–¹å¼2ï¼šé€šè¿‡getData()æ³¨å†Œ  
byte[] data = zk.getData("/config", watcher, null);

// æ–¹å¼3ï¼šé€šè¿‡getChildren()æ³¨å†Œ
List<String> children = zk.getChildren("/servers", watcher);
```

---

## 4. ğŸ› ï¸ Watchå®æˆ˜åº”ç”¨


### 4.1 é…ç½®ä¸­å¿ƒå®ç°


**ğŸ¯ éœ€æ±‚**ï¼šå®ç°ä¸€ä¸ªç®€å•çš„é…ç½®ä¸­å¿ƒï¼Œé…ç½®å˜åŒ–æ—¶è‡ªåŠ¨é€šçŸ¥æ‰€æœ‰åº”ç”¨

**ğŸ’» å®Œæ•´å®ç°**
```java
public class ConfigCenter {
    private ZooKeeper zk;
    private String configPath = "/app/config";
    
    public ConfigCenter() throws Exception {
        zk = new ZooKeeper("localhost:2181", 3000, null);
        // ç¡®ä¿é…ç½®è·¯å¾„å­˜åœ¨
        if (zk.exists(configPath, false) == null) {
            zk.create(configPath, "".getBytes(), 
                     ZooDefs.Ids.OPEN_ACL_UNSAFE, 
                     CreateMode.PERSISTENT);
        }
    }
    
    // ç›‘å¬é…ç½®å˜åŒ–
    public void watchConfig(ConfigChangeListener listener) {
        try {
            byte[] data = zk.getData(configPath, new Watcher() {
                @Override
                public void process(WatchedEvent event) {
                    if (event.getType() == Event.EventType.NodeDataChanged) {
                        try {
                            // è·å–æœ€æ–°é…ç½®
                            byte[] newData = zk.getData(configPath, this, null);
                            String config = new String(newData);
                            
                            // é€šçŸ¥åº”ç”¨å±‚
                            listener.onConfigChanged(config);
                            
                        } catch (Exception e) {
                            e.printStackTrace();
                        }
                    }
                }
            }, null);
            
            // åˆå§‹é…ç½®é€šçŸ¥
            if (data != null) {
                listener.onConfigChanged(new String(data));
            }
            
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    // æ›´æ–°é…ç½®
    public void updateConfig(String config) throws Exception {
        zk.setData(configPath, config.getBytes(), -1);
    }
}

// é…ç½®å˜åŒ–ç›‘å¬å™¨
interface ConfigChangeListener {
    void onConfigChanged(String newConfig);
}

// ä½¿ç”¨ç¤ºä¾‹
public class Application {
    public static void main(String[] args) throws Exception {
        ConfigCenter configCenter = new ConfigCenter();
        
        // ç›‘å¬é…ç½®å˜åŒ–
        configCenter.watchConfig(newConfig -> {
            System.out.println("æ”¶åˆ°æ–°é…ç½®: " + newConfig);
            // åº”ç”¨æ–°é…ç½®
            applyConfig(newConfig);
        });
        
        // æ¨¡æ‹Ÿé…ç½®æ›´æ–°
        Thread.sleep(2000);
        configCenter.updateConfig("database.url=new-url");
    }
    
    private static void applyConfig(String config) {
        // åº”ç”¨æ–°é…ç½®çš„é€»è¾‘
        System.out.println("åº”ç”¨é…ç½®: " + config);
    }
}
```

### 4.2 æœåŠ¡å‘ç°å®ç°


**ğŸ¯ éœ€æ±‚**ï¼šç›‘æ§æœåŠ¡é›†ç¾¤ï¼ŒæœåŠ¡ä¸Šä¸‹çº¿æ—¶è‡ªåŠ¨æ›´æ–°æœåŠ¡åˆ—è¡¨

**ğŸ’» å®Œæ•´å®ç°**
```java
public class ServiceDiscovery {
    private ZooKeeper zk;
    private String servicePath = "/services";
    private List<String> currentServices = new ArrayList<>();
    
    public ServiceDiscovery() throws Exception {
        zk = new ZooKeeper("localhost:2181", 3000, null);
        // åˆ›å»ºæœåŠ¡æ ¹ç›®å½•
        if (zk.exists(servicePath, false) == null) {
            zk.create(servicePath, "".getBytes(),
                     ZooDefs.Ids.OPEN_ACL_UNSAFE,
                     CreateMode.PERSISTENT);
        }
    }
    
    // å¼€å§‹ç›‘å¬æœåŠ¡å˜åŒ–
    public void startDiscovery() {
        try {
            List<String> services = zk.getChildren(servicePath, new Watcher() {
                @Override
                public void process(WatchedEvent event) {
                    if (event.getType() == Event.EventType.NodeChildrenChanged) {
                        // é‡æ–°è·å–æœåŠ¡åˆ—è¡¨
                        updateServiceList();
                        
                        // é‡æ–°è®¾ç½®ç›‘å¬
                        startDiscovery();
                    }
                }
            });
            
            // æ›´æ–°å½“å‰æœåŠ¡åˆ—è¡¨
            updateCurrentServices(services);
            
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    private void updateServiceList() {
        try {
            List<String> newServices = zk.getChildren(servicePath, false);
            updateCurrentServices(newServices);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    private void updateCurrentServices(List<String> services) {
        // æ‰¾å‡ºæ–°å¢çš„æœåŠ¡
        for (String service : services) {
            if (!currentServices.contains(service)) {
                System.out.println("å‘ç°æ–°æœåŠ¡: " + service);
                onServiceAdded(service);
            }
        }
        
        // æ‰¾å‡ºä¸‹çº¿çš„æœåŠ¡
        for (String service : currentServices) {
            if (!services.contains(service)) {
                System.out.println("æœåŠ¡ä¸‹çº¿: " + service);
                onServiceRemoved(service);
            }
        }
        
        // æ›´æ–°å½“å‰åˆ—è¡¨
        currentServices = new ArrayList<>(services);
        System.out.println("å½“å‰åœ¨çº¿æœåŠ¡: " + currentServices);
    }
    
    private void onServiceAdded(String service) {
        // æœåŠ¡ä¸Šçº¿å¤„ç†é€»è¾‘
        // ä¾‹å¦‚ï¼šåŠ å…¥è´Ÿè½½å‡è¡¡åˆ—è¡¨
    }
    
    private void onServiceRemoved(String service) {
        // æœåŠ¡ä¸‹çº¿å¤„ç†é€»è¾‘  
        // ä¾‹å¦‚ï¼šä»è´Ÿè½½å‡è¡¡åˆ—è¡¨ç§»é™¤
    }
    
    // æ³¨å†ŒæœåŠ¡
    public void registerService(String serviceName, String serviceInfo) throws Exception {
        String fullPath = servicePath + "/" + serviceName;
        zk.create(fullPath, serviceInfo.getBytes(),
                 ZooDefs.Ids.OPEN_ACL_UNSAFE,
                 CreateMode.EPHEMERAL); // ä¸´æ—¶èŠ‚ç‚¹ï¼Œå®¢æˆ·ç«¯æ–­å¼€è‡ªåŠ¨åˆ é™¤
    }
}
```

---

## 5. ğŸ’¡ Watchæœ€ä½³å®è·µ


### 5.1 é‡è¿å¤„ç†


**âš ï¸ é—®é¢˜**ï¼šå®¢æˆ·ç«¯é‡è¿åï¼Œä¹‹å‰çš„Watchä¼šä¸¢å¤±

**âœ… è§£å†³æ–¹æ¡ˆ**ï¼šå®ç°Watché‡æ³¨å†Œæœºåˆ¶

```java
public class ReliableWatcher implements Watcher {
    private ZooKeeper zk;
    private String watchPath;
    private WatchCallback callback;
    
    public ReliableWatcher(ZooKeeper zk, String path, WatchCallback callback) {
        this.zk = zk;
        this.watchPath = path;
        this.callback = callback;
    }
    
    @Override
    public void process(WatchedEvent event) {
        // å¤„ç†è¿æ¥çŠ¶æ€äº‹ä»¶
        if (event.getState() == Event.KeeperState.SyncConnected) {
            if (event.getType() == Event.EventType.None) {
                // é‡è¿æˆåŠŸï¼Œé‡æ–°æ³¨å†ŒWatch
                reregisterWatch();
                return;
            }
        }
        
        // å¤„ç†èŠ‚ç‚¹äº‹ä»¶
        if (event.getPath() != null && event.getPath().equals(watchPath)) {
            // æ‰§è¡Œä¸šåŠ¡å›è°ƒ
            callback.onEvent(event);
            
            // é‡æ–°æ³¨å†ŒWatchï¼ˆä¸€æ¬¡æ€§ç‰¹æ€§ï¼‰
            reregisterWatch();
        }
    }
    
    private void reregisterWatch() {
        try {
            zk.exists(watchPath, this);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    
    interface WatchCallback {
        void onEvent(WatchedEvent event);
    }
}
```

### 5.2 å¼‚å¸¸å¤„ç†


**âš ï¸ å¸¸è§å¼‚å¸¸**
- `ConnectionLossException`ï¼šè¿æ¥ä¸¢å¤±
- `SessionExpiredException`ï¼šä¼šè¯è¿‡æœŸ
- `NoNodeException`ï¼šèŠ‚ç‚¹ä¸å­˜åœ¨

**âœ… å¤„ç†ç­–ç•¥**
```java
public class SafeWatcher implements Watcher {
    private static final int MAX_RETRY = 3;
    private int retryCount = 0;
    
    @Override
    public void process(WatchedEvent event) {
        try {
            handleEvent(event);
            retryCount = 0; // æˆåŠŸåé‡ç½®é‡è¯•æ¬¡æ•°
        } catch (Exception e) {
            if (retryCount < MAX_RETRY) {
                retryCount++;
                System.out.println("Watchå¤„ç†å¼‚å¸¸ï¼Œé‡è¯•ç¬¬" + retryCount + "æ¬¡");
                // å»¶è¿Ÿé‡è¯•
                retryWithDelay();
            } else {
                System.err.println("Watchå¤„ç†å¤±è´¥ï¼Œè¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°");
            }
        }
    }
    
    private void retryWithDelay() {
        new Thread(() -> {
            try {
                Thread.sleep(1000 * retryCount); // é€’å¢å»¶è¿Ÿ
                // é‡æ–°å¤„ç†
                reprocess();
            } catch (InterruptedException ie) {
                Thread.currentThread().interrupt();
            }
        }).start();
    }
}
```

### 5.3 æ€§èƒ½ä¼˜åŒ–å»ºè®®


**ğŸ“Š ä¼˜åŒ–è¦ç‚¹**

| **ä¼˜åŒ–ç‚¹** | **è¯´æ˜** | **å®ç°æ–¹å¼** |
|-----------|---------|-------------|
| **æ‰¹é‡å¤„ç†** | é¿å…é¢‘ç¹çš„å•ä¸ªWatch | ä½¿ç”¨çº¿ç¨‹æ± æ‰¹é‡å¤„ç†äº‹ä»¶ |
| **ç¼“å­˜æœºåˆ¶** | å‡å°‘é‡å¤çš„æ•°æ®è·å– | æœ¬åœ°ç¼“å­˜å¸¸ç”¨æ•°æ® |
| **è¿æ¥å¤ç”¨** | é¿å…é¢‘ç¹åˆ›å»ºè¿æ¥ | ä½¿ç”¨è¿æ¥æ± ç®¡ç†ZKè¿æ¥ |
| **å¼‚æ­¥å¤„ç†** | é¿å…é˜»å¡Watchå›è°ƒ | Watchä¸­å¯åŠ¨å¼‚æ­¥ä»»åŠ¡å¤„ç† |

**ğŸ’» æ‰¹é‡å¤„ç†ç¤ºä¾‹**
```java
public class BatchWatchProcessor {
    private ExecutorService executor = Executors.newFixedThreadPool(5);
    private BlockingQueue<WatchedEvent> eventQueue = new LinkedBlockingQueue<>();
    
    public BatchWatchProcessor() {
        // å¯åŠ¨æ‰¹å¤„ç†çº¿ç¨‹
        executor.submit(this::processBatch);
    }
    
    public void addEvent(WatchedEvent event) {
        eventQueue.offer(event);
    }
    
    private void processBatch() {
        List<WatchedEvent> batch = new ArrayList<>();
        
        while (true) {
            try {
                // æ”¶é›†ä¸€æ‰¹äº‹ä»¶ï¼ˆæœ€å¤šç­‰å¾…100msï¼‰
                WatchedEvent event = eventQueue.poll(100, TimeUnit.MILLISECONDS);
                if (event != null) {
                    batch.add(event);
                    
                    // ç»§ç»­æ”¶é›†æ›´å¤šäº‹ä»¶
                    eventQueue.drainTo(batch, 10); // æœ€å¤šå†å–10ä¸ª
                    
                    // æ‰¹é‡å¤„ç†
                    processBatchEvents(batch);
                    batch.clear();
                }
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
                break;
            }
        }
    }
    
    private void processBatchEvents(List<WatchedEvent> events) {
        // æ‰¹é‡å¤„ç†é€»è¾‘
        System.out.println("æ‰¹é‡å¤„ç† " + events.size() + " ä¸ªäº‹ä»¶");
    }
}
```

---

## 6. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 6.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ”¸ Watchæœ¬è´¨ï¼šZooKeeperçš„äº‹ä»¶é€šçŸ¥æœºåˆ¶ï¼Œå®ç°æ•°æ®å˜åŒ–çš„å®æ—¶æ„ŸçŸ¥
ğŸ”¸ å››ç§äº‹ä»¶ç±»å‹ï¼šNodeCreatedã€NodeDeletedã€NodeDataChangedã€NodeChildrenChanged
ğŸ”¸ ä¸€æ¬¡æ€§ç‰¹æ€§ï¼šWatchè§¦å‘åè‡ªåŠ¨å¤±æ•ˆï¼Œéœ€è¦é‡æ–°æ³¨å†Œæ‰èƒ½ç»§ç»­ç›‘å¬
ğŸ”¸ å¼‚æ­¥é€šçŸ¥ï¼šé€šè¿‡å›è°ƒæ–¹å¼å¼‚æ­¥é€šçŸ¥å®¢æˆ·ç«¯ï¼Œä¸é˜»å¡æœåŠ¡å™¨
ğŸ”¸ è½»é‡çº§è®¾è®¡ï¼šåªä¼ è¾“äº‹ä»¶ç±»å‹å’Œè·¯å¾„ï¼Œä¸ä¼ è¾“å˜åŒ–çš„å…·ä½“æ•°æ®
```

### 6.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ Watchçš„å·¥ä½œæœºåˆ¶**
```
è®¾ç½®é˜¶æ®µï¼šå®¢æˆ·ç«¯è°ƒç”¨exists/getData/getChildrenæ—¶è®¾ç½®Watcher
æ³¨å†Œé˜¶æ®µï¼šZooKeeperæœåŠ¡å™¨è®°å½•å®¢æˆ·ç«¯çš„ç›‘å¬å…³ç³»
è§¦å‘é˜¶æ®µï¼šèŠ‚ç‚¹å˜åŒ–æ—¶æ£€æŸ¥ç›‘å¬åˆ—è¡¨ï¼Œå‘é€äº‹ä»¶é€šçŸ¥
æ¸…ç†é˜¶æ®µï¼šå‘é€é€šçŸ¥ååˆ é™¤Watchè®°å½•ï¼ˆä¸€æ¬¡æ€§ç‰¹æ€§ï¼‰
```

**ğŸ”¹ äº‹ä»¶ç±»å‹çš„ä½¿ç”¨åœºæ™¯**
```
NodeCreated â†’ ç­‰å¾…èµ„æºåˆ›å»ºå®Œæˆ
NodeDeleted â†’ ç›‘æ§æœåŠ¡ä¸‹çº¿ã€èµ„æºæ¸…ç†
NodeDataChanged â†’ é…ç½®çƒ­æ›´æ–°ã€çŠ¶æ€åŒæ­¥
NodeChildrenChanged â†’ é›†ç¾¤ç›‘æ§ã€æœåŠ¡å‘ç°
```

**ğŸ”¹ Watchçš„è®¾è®¡å“²å­¦**
```
ä¸€æ¬¡æ€§è®¾è®¡ï¼šé¿å…äº‹ä»¶å †ç§¯ï¼Œç¡®ä¿å¤„ç†åŠæ—¶æ€§
å¼‚æ­¥é€šçŸ¥ï¼šæé«˜æ€§èƒ½ï¼Œé¿å…é˜»å¡
è½»é‡çº§é€šçŸ¥ï¼šå‡å°‘ç½‘ç»œå¼€é”€ï¼Œç”±å®¢æˆ·ç«¯ä¸»åŠ¨è·å–æ•°æ®
```

### 6.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ¯ å…¸å‹åº”ç”¨åœºæ™¯**
- **é…ç½®ä¸­å¿ƒ**ï¼šé…ç½®å˜åŒ–æ—¶è‡ªåŠ¨é€šçŸ¥æ‰€æœ‰æœåŠ¡å®ä¾‹
- **æœåŠ¡å‘ç°**ï¼šç›‘æ§æœåŠ¡èŠ‚ç‚¹ï¼Œå®ç°åŠ¨æ€æœåŠ¡è·¯ç”±
- **åˆ†å¸ƒå¼é”**ï¼šç›‘å¬é”èŠ‚ç‚¹ï¼Œå®ç°é”çš„è‡ªåŠ¨è·å–
- **é›†ç¾¤ç®¡ç†**ï¼šç›‘æ§é›†ç¾¤æˆå‘˜å˜åŒ–ï¼Œè‡ªåŠ¨è°ƒæ•´é›†ç¾¤é…ç½®
- **æ•°æ®åŒæ­¥**ï¼šç›‘å¬æ•°æ®å˜åŒ–ï¼Œå®ç°è·¨ç³»ç»Ÿæ•°æ®åŒæ­¥

**ğŸ”§ å¼€å‘æ³¨æ„äº‹é¡¹**
```
âœ… å¿…é¡»å¤„ç†é‡è¿æ—¶çš„Watché‡æ³¨å†Œ
âœ… å¼‚å¸¸æƒ…å†µä¸‹è¦æœ‰é‡è¯•æœºåˆ¶  
âœ… é¿å…åœ¨Watchå›è°ƒä¸­åšè€—æ—¶æ“ä½œ
âœ… åˆç†ä½¿ç”¨æ‰¹é‡å¤„ç†æé«˜æ€§èƒ½
âœ… æ³¨æ„å†…å­˜æ³„æ¼ï¼ŒåŠæ—¶æ¸…ç†ä¸ç”¨çš„Watch
```

**ğŸ’¡ æœ€ä½³å®è·µæ€»ç»“**
```
æ¶æ„è®¾è®¡ï¼š
- ä½¿ç”¨Watchå®ç°äº‹ä»¶é©±åŠ¨æ¶æ„
- ç»“åˆæœ¬åœ°ç¼“å­˜å‡å°‘ç½‘ç»œè°ƒç”¨
- è®¾è®¡åˆç†çš„é‡è¯•å’Œå®¹é”™æœºåˆ¶

æ€§èƒ½ä¼˜åŒ–ï¼š
- æ‰¹é‡å¤„ç†Watchäº‹ä»¶
- ä½¿ç”¨çº¿ç¨‹æ± å¤„ç†å›è°ƒ
- åˆç†è®¾ç½®Watchçš„ç²’åº¦

å¯é æ€§ä¿è¯ï¼š
- å®ç°Watchçš„è‡ªåŠ¨é‡æ³¨å†Œ
- å¤„ç†å„ç§å¼‚å¸¸æƒ…å†µ
- ç›‘æ§Watchçš„å¥åº·çŠ¶æ€
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- Watchæ˜¯ZooKeeperå®ç°å®æ—¶é€šçŸ¥çš„æ ¸å¿ƒæœºåˆ¶
- å››ç§äº‹ä»¶ç±»å‹å¯¹åº”ä¸åŒçš„ç›‘å¬éœ€æ±‚
- ä¸€æ¬¡æ€§ç‰¹æ€§éœ€è¦é‡æ–°æ³¨å†Œæ‰èƒ½æŒç»­ç›‘å¬
- åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æ˜¯å®ç°äº‹ä»¶é©±åŠ¨æ¶æ„çš„é‡è¦å·¥å…·