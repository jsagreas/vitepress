---
title: 6、集群资源管理
---
## 📚 目录

1. [集群资源管理概述](#1-集群资源管理概述)
2. [资源类型与属性定义](#2-资源类型与属性定义)
3. [资源约束配置](#3-资源约束配置)
4. [资源组管理](#4-资源组管理)
5. [资源依赖关系](#5-资源依赖关系)
6. [资源故障检测](#6-资源故障检测)
7. [资源迁移策略](#7-资源迁移策略)
8. [资源优先级设置](#8-资源优先级设置)
9. [资源监控配置](#9-资源监控配置)
10. [核心要点总结](#10-核心要点总结)

---

## 1. 🌐 集群资源管理概述


### 1.1 什么是集群资源管理


**资源管理的本质**：就像管理一个大公司的各种设备和服务一样，集群资源管理负责协调和分配集群中的各种计算资源。

```
现实类比：公司资源管理
┌─────────────────────┐    ┌─────────────────────┐
│      公司管理        │    │    集群资源管理      │
├─────────────────────┤    ├─────────────────────┤
│ 员工分配到项目组     │ → │ 服务分配到节点        │
│ 设备借用与归还       │ → │ 资源启动与停止        │
│ 部门之间协作         │ → │ 服务间依赖关系        │
│ 故障设备维修         │ → │ 故障资源恢复          │
│ 重要项目优先保障     │ → │ 关键服务优先级        │
└─────────────────────┘    └─────────────────────┘
```

### 1.2 资源管理的核心作用


**🎯 主要职责**
- **资源调度**：决定哪个服务运行在哪个节点上
- **健康监控**：时刻检查各种服务是否正常运行
- **故障恢复**：当服务出问题时自动修复或迁移
- **负载均衡**：合理分配工作负载避免单点过载
- **依赖管理**：确保相关服务按正确顺序启动

### 1.3 集群资源管理架构


```
集群资源管理架构图：

管理层面 ┌─────────────────────────────────────┐
         │        集群资源管理器(CRM)           │
         │  ┌─────────┐  ┌─────────┐  ┌─────────┐ │
         │  │资源代理 │  │约束引擎 │  │监控模块 │ │
         │  └─────────┘  └─────────┘  └─────────┘ │
         └─────────────┬───────────────────────────┘
                      │ 管理指令
执行层面 ┌─────────────┼───────────────────────────┐
         │            ▼                           │
         │  节点A    节点B    节点C    节点D        │
         │ ┌─────┐  ┌─────┐  ┌─────┐  ┌─────┐      │
         │ │资源1│  │资源2│  │资源3│  │备用 │      │
         │ │资源4│  │资源5│  │     │  │节点 │      │
         │ └─────┘  └─────┘  └─────┘  └─────┘      │
         └─────────────────────────────────────────┘
```

---

## 2. 🔧 资源类型与属性定义


### 2.1 资源类型分类


**基础资源类型**：把集群中能管理的东西分成不同类别，就像给公司的资产分类一样。

| 资源类型 | **实际含义** | **典型用途** | **管理特点** |
|---------|------------|-------------|-------------|
| 🖥️ **应用服务** | `运行的业务程序` | `Web服务、数据库` | `需要持续监控状态` |
| 💾 **存储资源** | `数据存储设备` | `共享磁盘、文件系统` | `要求独占访问` |
| 🌐 **网络资源** | `网络连接和地址` | `虚拟IP、网络接口` | `可在节点间漂移` |
| ⚙️ **系统服务** | `底层支撑服务` | `DNS、时间同步` | `通常全集群共享` |

### 2.2 资源属性详解


**🔸 基本属性**
```
资源身份信息：
├─ 资源名称(id)：在集群中的唯一标识符
├─ 资源类型(class)：指明这是什么类型的资源
├─ 提供者(provider)：定义谁来管理这个资源
└─ 描述信息(description)：人读的资源说明

运行时属性：
├─ 目标状态(target-state)：期望资源处于什么状态
├─ 当前状态(current-state)：资源实际状态
├─ 启动超时(start-timeout)：启动允许的最长时间
└─ 停止超时(stop-timeout)：停止允许的最长时间
```

**🔸 高级属性**
```
故障处理：
├─ 重启阈值(migration-threshold)：失败多少次后迁移
├─ 故障超时(failure-timeout)：故障记录保留时间
└─ 重启延迟(restart-delay)：重启前等待时间

资源亲和性：
├─ 节点偏好(node-preference)：倾向在哪个节点运行
├─ 排斥规则(anti-affinity)：不能和什么资源同节点
└─ 位置约束(location-constraint)：只能在特定位置
```

### 2.3 资源属性配置示例


**Web服务资源配置**
```bash
# 定义一个Apache Web服务资源
primitive apache-web apache \
    params configfile="/etc/httpd/conf/httpd.conf" \
    op start timeout="60s" \
    op stop timeout="60s" \
    op monitor interval="30s" timeout="20s"
```

> 💡 **通俗解释**：这就像给公司的一台Web服务器写个使用说明书，告诉管理员配置文件在哪里，启动停止最多等多久，每30秒检查一次健康状态。

---

## 3. ⚖️ 资源约束配置


### 3.1 约束的概念与作用


**约束就是规则**：告诉集群管理器什么可以做，什么不可以做，就像制定公司规章制度一样。

```
约束类型对比：

位置约束 ┌──────────────────────────────────┐
Location │ 规定资源只能在特定节点运行        │
Constraint│ 示例：数据库只能在服务器A或B上   │
         └──────────────────────────────────┘

排序约束 ┌──────────────────────────────────┐  
Order    │ 规定资源启动的先后顺序           │
Constraint│ 示例：先启动数据库，再启动Web    │
         └──────────────────────────────────┘

组合约束 ┌──────────────────────────────────┐
Colocation│ 规定资源必须在同一节点或分开     │
Constraint│ 示例：Web和数据库必须在同一台    │
         └──────────────────────────────────┘
```

### 3.2 位置约束详解


**位置约束**：告诉资源"你只能在这些地方运行"，就像指定员工只能在特定办公室工作。

**🎯 常用场景**
- **硬件要求**：数据库需要高性能存储的节点
- **许可限制**：商业软件只有特定节点有许可证
- **安全考虑**：敏感服务只能在内网节点运行
- **地理分布**：服务需要分布在不同机房

**约束权重系统**
```
权重值含义：
┌─────────┬─────────────────────────────────┐
│ 权重值   │           实际含义               │
├─────────┼─────────────────────────────────┤
│ +INFINITY│ 必须运行在此节点(强制要求)        │
│ +200     │ 非常倾向于此节点                 │
│ +100     │ 倾向于此节点                     │
│ 0        │ 中性(无偏好)                    │
│ -100     │ 不倾向于此节点                   │
│ -INFINITY│ 禁止运行在此节点                 │
└─────────┴─────────────────────────────────┘
```

### 3.3 排序约束详解


**排序约束**：规定启动和停止的顺序，就像规定开会前必须先准备会议室。

**🔄 排序关系**
```
典型的启动顺序：

第一步：基础服务
├─ 网络配置
├─ 共享存储
└─ 时间同步

第二步：数据层
├─ 数据库服务
├─ 缓存服务
└─ 消息队列

第三步：应用层
├─ 业务应用
├─ Web服务
└─ 负载均衡
```

**排序约束配置**
```bash
# 确保数据库在Web服务之前启动
order database-before-web \
    database-service:start \
    web-service:start
```

> 📝 **实际意义**：这就像规定必须先开数据库，再开网站，避免网站启动时找不到数据库而报错。

---

## 4. 📦 资源组管理


### 4.1 资源组的概念


**资源组**：把相关的资源打包在一起管理，就像把一个项目组的所有成员放在一个部门里。

```
单个资源 vs 资源组：

单个资源管理：
Web服务 ──── 独立管理
数据库 ──── 独立管理  ← 容易出现配置冲突
文件系统 ─── 独立管理

资源组管理：
┌─────────────────────┐
│     业务系统组       │
│ ┌─────────────────┐ │
│ │  文件系统       │ │ ← 作为一个整体
│ │  数据库         │ │ ← 统一管理
│ │  Web服务        │ │
│ └─────────────────┘ │
└─────────────────────┘
```

### 4.2 资源组的优势


**🌟 管理优势**
- **原子性操作**：整个组一起启动停止，不会出现半启动状态
- **简化配置**：只需要配置组级别的约束，自动应用到所有成员
- **故障隔离**：组内资源共享故障状态，便于批量处理
- **迁移便利**：整个业务系统可以一起迁移到新节点

### 4.3 资源组类型


**📋 组类型对比**

| 组类型 | **特点描述** | **启动方式** | **适用场景** |
|--------|------------|-------------|-------------|
| **普通组** | `成员按顺序启动停止` | `串行处理` | `有依赖关系的服务` |
| **克隆组** | `在多个节点同时运行` | `并行启动` | `分布式服务集群` |
| **主从组** | `一个主多个从节点` | `主节点优先` | `数据库主从复制` |

**克隆组示例**
```bash
# 创建分布式存储克隆组
clone storage-clone storage-service \
    meta clone-max="4" \
    clone-node-max="1" \
    notify="true"
```

> 🔄 **实际含义**：这个配置让存储服务在最多4个节点上运行，每个节点最多1个实例，节点间会互相通知状态变化。

---

## 5. 🔗 资源依赖关系


### 5.1 依赖关系的本质


**依赖关系**：就像做菜需要先洗菜再下锅一样，很多服务也需要按特定顺序启动。

```
业务系统依赖层次：

                  用户访问
                     ↓
        ┌─────────────────────────┐
第4层   │     负载均衡器           │
        └─────────────────────────┘
                     ↓ 依赖
        ┌─────────────────────────┐
第3层   │     Web应用服务          │
        └─────────────────────────┘
                     ↓ 依赖
        ┌─────────────────────────┐
第2层   │     数据库服务           │
        └─────────────────────────┘
                     ↓ 依赖
        ┌─────────────────────────┐
第1层   │   文件系统/网络存储       │
        └─────────────────────────┘

启动顺序：第1层 → 第2层 → 第3层 → 第4层
停止顺序：第4层 → 第3层 → 第2层 → 第1层
```

### 5.2 依赖类型详解


**🔸 强依赖(Mandatory)**
```
强依赖特征：
├─ 被依赖资源必须先启动成功
├─ 如果被依赖资源失败，依赖资源不能启动
├─ 被依赖资源停止时，依赖资源也必须停止
└─ 典型场景：Web服务依赖数据库
```

**🔸 可选依赖(Optional)**
```
可选依赖特征：
├─ 被依赖资源优先启动，但失败不影响主资源
├─ 主要用于优化启动顺序
├─ 被依赖资源停止不强制停止依赖资源
└─ 典型场景：监控服务依赖于主业务服务
```

### 5.3 复杂依赖场景


**多重依赖处理**
```
电商系统依赖关系：

          ┌─────────────┐
          │   前端页面   │
          └─────┬───────┘
                │ 依赖
    ┌───────────▼───────────┐
    │      API网关         │
    └─┬─────────────────┬───┘
      │                 │
   依赖│              依赖│
  ┌───▼────┐      ┌─────▼──┐
  │订单服务 │      │用户服务 │
  └─┬──────┘      └─┬──────┘
    │               │
 依赖│            依赖│
┌───▼──┐        ┌───▼──┐
│数据库A│        │数据库B│
└──────┘        └──────┘
```

**依赖解析算法**：集群管理器会自动计算出正确的启动顺序，确保不会出现循环依赖或死锁情况。

---

## 6. 🩺 资源故障检测


### 6.1 故障检测的重要性


**为什么需要故障检测**：就像医生定期体检发现健康问题一样，集群需要持续监控服务状态。

```
故障检测覆盖范围：

进程级检测 ┌─────────────────────────────────┐
          │ ✓ 进程是否存在                   │
          │ ✓ 进程响应是否正常               │
          │ ✓ 进程消耗资源是否异常           │
          └─────────────────────────────────┘

服务级检测 ┌─────────────────────────────────┐
          │ ✓ 服务端口是否可访问             │
          │ ✓ 服务接口是否正常响应           │
          │ ✓ 服务性能是否满足要求           │
          └─────────────────────────────────┘

业务级检测 ┌─────────────────────────────────┐
          │ ✓ 业务功能是否正常               │
          │ ✓ 数据一致性是否保持             │
          │ ✓ 用户体验是否达标               │
          └─────────────────────────────────┘
```

### 6.2 检测方法分类


**🔍 主要检测手段**

| 检测类型 | **检测内容** | **检测频率** | **误报风险** |
|---------|-------------|-------------|-------------|
| **进程检查** | `检查进程是否存在` | `10-30秒` | `低` |
| **端口检查** | `检查服务端口状态` | `30-60秒` | `中等` |
| **健康检查** | `调用健康检查接口` | `60-120秒` | `较低` |
| **功能检查** | `执行实际业务操作` | `300-600秒` | `最低` |

### 6.3 故障检测配置


**Web服务检测配置**
```bash
# HTTP服务健康检查
primitive web-service apache \
    op monitor interval="30s" timeout="20s" \
    op monitor interval="60s" timeout="30s" \
        OCF_CHECK_LEVEL="10"
```

> 🔧 **配置解读**：
> - `interval="30s"`：每30秒检查一次基础状态
> - `timeout="20s"`：检查超过20秒算超时
> - `OCF_CHECK_LEVEL="10"`：执行更深度的检查

**故障阈值设置**
```
故障判定逻辑：
┌─────────────────────────────────────┐
│ 连续检查失败次数 ≥ 故障阈值           │
│           ↓                        │
│ 触发故障处理流程                    │
│           ↓                        │
│ ┌─重启─┐ → ┌─迁移─┐ → ┌─隔离─┐      │
│ │尝试  │   │到其他│   │故障  │      │
│ │修复  │   │节点  │   │节点  │      │
│ └─────┘   └─────┘   └─────┘      │
└─────────────────────────────────────┘
```

---

## 7. 🚚 资源迁移策略


### 7.1 迁移的触发条件


**什么情况下需要迁移**：就像员工调岗一样，资源迁移通常因为当前环境不适合继续工作。

```
迁移触发场景：

主动迁移 ┌─────────────────────────────────┐
        │ • 节点维护需要                   │
        │ • 负载均衡调整                   │
        │ • 硬件升级替换                   │
        │ • 管理员手动操作                 │
        └─────────────────────────────────┘

被动迁移 ┌─────────────────────────────────┐
        │ • 节点硬件故障                   │
        │ • 服务反复启动失败               │
        │ • 网络连接中断                   │
        │ • 资源约束冲突                   │
        └─────────────────────────────────┘
```

### 7.2 迁移策略类型


**🔄 迁移方式对比**

| 迁移策略 | **执行方式** | **服务中断** | **适用场景** |
|---------|-------------|-------------|-------------|
| **冷迁移** | `先停止再启动` | `有中断` | `无状态服务` |
| **热迁移** | `在线迁移状态` | `几乎无中断` | `虚拟机应用` |
| **滚动迁移** | `逐个节点迁移` | `部分中断` | `集群化服务` |

### 7.3 迁移流程详解


**标准迁移流程**
```
迁移执行步骤：

第1步：迁移准备
├─ 选择目标节点
├─ 检查资源约束
├─ 验证目标节点能力
└─ 准备迁移环境

第2步：执行迁移  
├─ 在源节点停止资源
├─ 传输必要的状态数据
├─ 在目标节点启动资源
└─ 验证迁移成功

第3步：迁移完成
├─ 更新集群状态
├─ 清理源节点环境
├─ 重新平衡负载
└─ 记录迁移日志
```

**迁移失败处理**
```bash
# 配置迁移失败后的策略
property migration-limit="3"          # 最多迁移3次
property failure-timeout="600s"       # 故障记录保持10分钟
```

> ⚠️ **注意事项**：如果服务在多个节点都启动失败，可能是配置问题而不是节点问题，这时需要人工介入检查。

---

## 8. 🏆 资源优先级设置


### 8.1 优先级的作用机制


**优先级就是重要程度排序**：当资源冲突时，优先保证重要资源的运行，就像紧急情况下优先保障核心业务。

```
资源竞争场景示例：

节点资源不足情况：
┌─────────────────────────────────────┐
│             节点A                   │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ │
│  │数据库    │ │Web服务  │ │监控服务 │ │ ← 当前运行
│  │优先级:100│ │优先级:50│ │优先级:10│ │
│  └─────────┘ └─────────┘ └─────────┘ │
└─────────────────────────────────────┘
                    ↓
           新服务需要迁移到此节点
           (缓存服务，优先级:80)
                    ↓
              资源不足时的处理：
              停止监控服务(优先级最低)
              为缓存服务腾出空间
```

### 8.2 优先级分级系统


**🎯 优先级分级标准**

| 优先级范围 | **服务类型** | **典型场景** | **处理策略** |
|-----------|------------|-------------|-------------|
| **90-100** | `核心业务服务` | `数据库、支付系统` | `最高保障，几乎不迁移` |
| **70-89** | `重要应用服务` | `Web服务、API网关` | `高优先级保障` |
| **50-69** | `辅助服务` | `缓存、消息队列` | `中等优先级` |
| **30-49** | `监控服务` | `日志、监控、备份` | `可以适当牺牲` |
| **10-29** | `测试服务` | `开发环境、测试工具` | `最先被迁移或停止` |

### 8.3 优先级配置实践


**业务系统优先级配置**
```bash
# 设置数据库最高优先级
property priority-database="100"

# 设置Web服务高优先级  
property priority-web="80"

# 设置监控服务低优先级
property priority-monitor="20"
```

**动态优先级调整**
```
根据业务时间调整：
┌─────────────────────────────────────┐
│ 工作时间(9:00-18:00)：              │
│ ├─ 业务系统优先级: 100               │
│ ├─ 报表系统优先级: 30                │
│ └─ 备份系统优先级: 10                │
│                                     │
│ 非工作时间(18:00-9:00)：            │
│ ├─ 业务系统优先级: 60                │
│ ├─ 报表系统优先级: 80                │
│ └─ 备份系统优先级: 90                │
└─────────────────────────────────────┘
```

> 📊 **实际应用**：这种动态调整让系统在工作时间保障业务，在非工作时间优先进行数据处理和备份。

---

## 9. 📊 资源监控配置


### 9.1 监控体系架构


**监控就是集群的"体检系统"**：持续收集各种健康指标，及时发现和预警问题。

```
监控体系层次结构：

┌─────────────────────────────────────────┐
│              集群监控中心                 │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐     │
│  │告警管理 │ │数据分析 │ │报表生成 │     │
│  └─────────┘ └─────────┘ └─────────┘     │
└─────────────┬───────────────────────────┘
              │ 数据汇总
┌─────────────▼───────────────────────────┐
│              监控代理层                   │
│  节点A监控   节点B监控   节点C监控        │
│ ┌─────────┐ ┌─────────┐ ┌─────────┐     │
│ │资源状态 │ │性能指标 │ │健康检查 │     │
│ │系统负载 │ │网络连接 │ │服务状态 │     │
│ └─────────┘ └─────────┘ └─────────┘     │
└─────────────────────────────────────────┘
```

### 9.2 监控指标分类


**🔍 核心监控维度**

**资源状态监控**
```
基础状态指标：
├─ 资源启动状态(started/stopped/failed)
├─ 资源位置信息(当前运行节点)
├─ 资源运行时长(启动后持续时间)
└─ 故障次数统计(失败重启次数)

性能状态指标：  
├─ CPU使用率(进程CPU占用)
├─ 内存使用量(进程内存消耗)
├─ 磁盘I/O(读写操作频率)
└─ 网络流量(网络数据传输量)
```

**业务监控指标**
```
服务可用性：
├─ 响应时间(请求处理延迟)
├─ 吞吐量(每秒处理请求数)
├─ 错误率(失败请求占比)
└─ 并发用户数(同时在线用户)

数据完整性：
├─ 数据同步状态(主从数据一致性)
├─ 备份完成状态(备份任务执行情况)
├─ 数据库连接池(连接数和使用率)
└─ 队列长度(待处理任务数量)
```

### 9.3 监控配置实例


**Web服务监控配置**
```bash
# Apache Web服务完整监控配置
primitive web-monitor apache \
    params configfile="/etc/httpd/conf/httpd.conf" \
    statusurl="http://localhost/server-status" \
    op start timeout="60s" interval="0" \
    op stop timeout="60s" interval="0" \
    op monitor interval="30s" timeout="20s" \
        OCF_CHECK_LEVEL="0" \
    op monitor interval="120s" timeout="60s" \
        OCF_CHECK_LEVEL="10"
```

> 🔧 **配置详解**：
> - **基础监控**(30秒)：快速检查进程状态
> - **深度监控**(120秒)：检查服务响应和状态页面
> - **状态URL**：通过Apache状态页面获取详细信息

### 9.4 告警与响应机制


**告警级别定义**
```
告警严重程度分级：

🔴 紧急告警(Critical)
├─ 核心业务服务完全停止
├─ 数据丢失风险
├─ 系统安全威胁
└─ 处理时限：立即(5分钟内)

🟡 重要告警(Warning)  
├─ 服务性能严重下降
├─ 辅助服务停止
├─ 资源使用率过高
└─ 处理时限：1小时内

🟢 信息告警(Info)
├─ 服务正常重启
├─ 计划维护通知
├─ 配置变更记录
└─ 处理时限：工作时间内
```

**自动响应策略**
```bash
# 设置告警响应策略
property enable-startup-probes="true"    # 启用启动探测
property maintenance-mode="false"        # 维护模式开关
property stop-orphan-resources="true"    # 清理孤儿资源
property stop-orphan-actions="true"      # 清理孤儿操作
```

---

## 10. 📋 核心要点总结


### 10.1 必须掌握的核心概念


```
🔸 资源管理本质：协调分配集群计算资源，确保服务高可用
🔸 资源类型分类：应用服务、存储资源、网络资源、系统服务
🔸 约束配置体系：位置约束、排序约束、组合约束三大类
🔸 资源组管理：相关资源打包管理，简化配置和操作
🔸 依赖关系处理：确保服务按正确顺序启动和停止
🔸 故障检测机制：多层次健康检查，及时发现和处理问题
🔸 迁移策略选择：根据业务需求选择合适的迁移方式
🔸 优先级管理：资源竞争时的处理策略
🔸 监控告警体系：全面监控资源状态和性能指标
```

### 10.2 关键理解要点


**🔹 资源管理的核心思想**
```
集中式管理：
├─ 统一的资源调度决策
├─ 全局的约束条件检查  
├─ 协调的故障恢复流程
└─ 一致的监控告警机制

分布式执行：
├─ 各节点独立执行管理指令
├─ 本地资源状态实时上报
├─ 节点间协作完成复杂操作
└─ 网络分区时的自主决策
```

**🔹 约束与优先级的平衡**
```
配置原则：
├─ 约束确保正确性(资源不会运行在错误位置)
├─ 优先级确保重要性(关键服务优先保障)
├─ 两者结合实现最优资源分配
└─ 避免过度约束导致资源无法调度
```

**🔹 故障处理的层次化思路**
```
处理策略：
预防 → 检测 → 诊断 → 恢复 → 学习
  ↓      ↓      ↓      ↓      ↓
配置   监控   分析   迁移   优化
约束   告警   日志   重启   调整
```

### 10.3 实际应用指导


**🎯 配置最佳实践**
- **资源定义**：清晰的命名规范，详细的属性配置
- **约束设计**：平衡灵活性和稳定性，避免过度约束
- **监控配置**：合理的检查频率，分层的监控策略
- **故障处理**：明确的故障阈值，自动化的恢复流程
- **优先级管理**：业务导向的优先级设置，动态调整机制

**🔧 运维关键要点**
- **容量规划**：预估资源需求，预留足够缓冲
- **变更管理**：测试环境验证，分批次上线
- **应急响应**：完善的应急预案，快速的故障定位
- **性能调优**：持续的性能监控，主动的优化调整
- **文档维护**：完整的配置文档，及时的更新记录

**💡 故障排查思路**
```
问题定位步骤：
1️⃣ 查看集群状态：crm status
2️⃣ 检查资源约束：crm configure show
3️⃣ 分析节点状态：crm node status  
4️⃣ 查看操作历史：crm history
5️⃣ 检查日志记录：查看系统和应用日志
6️⃣ 验证网络连接：检查节点间通信
7️⃣ 测试资源操作：手动启停资源验证
```

**核心记忆口诀**：
- 资源管理重规划，类型属性要分清
- 约束配置定规则，依赖关系理顺序  
- 故障检测早发现，迁移策略要合理
- 优先级别分重点，监控告警保平安