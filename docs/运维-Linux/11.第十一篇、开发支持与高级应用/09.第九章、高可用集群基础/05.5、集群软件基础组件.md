---
title: 5、集群软件基础组件
---
## 📚 目录

1. [高可用集群概述](#1-高可用集群概述)
2. [Pacemaker集群资源管理器](#2-Pacemaker集群资源管理器)
3. [Corosync集群通信层](#3-Corosync集群通信层)
4. [集群配置管理工具](#4-集群配置管理工具)
5. [资源代理与集群信息库](#5-资源代理与集群信息库)
6. [集群通信协议与安全](#6-集群通信协议与安全)
7. [仲裁机制与脑裂防护](#7-仲裁机制与脑裂防护)
8. [集群状态监控](#8-集群状态监控)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🌐 高可用集群概述


### 1.1 什么是高可用集群


**核心含义**：高可用集群（High Availability Cluster）是将多台服务器组合在一起，让它们像一台超级计算机一样工作，当其中一台出故障时，其他机器能立即接管工作，确保服务不中断。

```
传统单机架构：
[用户] → [单台服务器] → [数据库]
  ↓
服务器故障 = 服务完全中断 ❌

高可用集群架构：
[用户] → [虚拟IP] → [主服务器] ← 心跳监控 → [备服务器]
                        ↓                    ↓
                    [共享存储] ←---------→ [数据库]
  ↓
主服务器故障 = 备服务器立即接管 ✅
```

**基本工作原理**：
- **服务冗余**：同一服务运行在多台机器上
- **故障检测**：实时监控各节点健康状态  
- **自动切换**：故障时自动将服务转移到健康节点
- **资源共享**：所有节点共享存储和网络资源

### 1.2 集群的核心价值


| 🎯 价值点 | **含义说明** | **实际效果** |
|----------|-------------|-------------|
| 📈 **高可用性** | `故障时服务不中断` | `可用性从99%提升到99.9%以上` |
| ⚡ **服务连续性** | `用户感知不到故障切换` | `业务7×24小时不间断运行` |
| 🔧 **自动化管理** | `无需人工干预故障处理` | `减少运维工作量90%以上` |
| 💰 **降低损失** | `避免因停机造成的业务损失` | `每小时停机损失可达数万元` |

### 1.3 集群基本架构组成


```
高可用集群软件栈：

┌─────────────────────────────────┐
│         应用层服务              │ ← Web服务、数据库等
├─────────────────────────────────┤  
│         资源代理层              │ ← 管理具体服务的启停
├─────────────────────────────────┤
│      Pacemaker资源管理          │ ← 决策引擎，管理资源
├─────────────────────────────────┤
│      Corosync通信层             │ ← 节点间心跳通信
├─────────────────────────────────┤
│         操作系统                │ ← Linux内核
└─────────────────────────────────┘
```

**各层作用简单理解**：
- **应用层**：实际提供服务的程序（如Apache、MySQL）
- **资源代理层**：知道如何启动、停止、检查各种服务
- **Pacemaker层**：大脑，决定哪个节点运行什么服务
- **Corosync层**：神经系统，负责节点间信息传递
- **操作系统层**：基础平台

---

## 2. 🧠 Pacemaker集群资源管理器


### 2.1 Pacemaker是什么


**通俗解释**：Pacemaker就像是集群的"大脑"和"指挥官"，它负责决定哪台服务器应该运行哪个服务，当服务器出故障时该如何处理。

**核心职责**：
```
🎯 资源管理
├─ 决定服务在哪个节点运行
├─ 监控服务运行状态
├─ 处理节点故障
└─ 执行资源迁移

🎯 策略执行  
├─ 根据约束条件分配资源
├─ 保证资源运行的优先级
├─ 处理资源间的依赖关系
└─ 执行用户定义的集群策略
```

### 2.2 Pacemaker核心概念


#### 🔸 集群资源（Resource）


**含义**：资源就是集群需要管理的"东西"，可以是服务、IP地址、存储设备等任何需要高可用保护的对象。

**常见资源类型**：
```
服务资源：
├─ Web服务器（Apache、Nginx）
├─ 数据库（MySQL、PostgreSQL）  
├─ 应用程序（自定义业务程序）
└─ 文件系统挂载点

网络资源：
├─ 虚拟IP地址（VIP）
├─ 网络接口
└─ 路由配置

存储资源：
├─ 共享磁盘
├─ 文件系统
└─ 逻辑卷
```

#### 🔸 资源约束（Constraints）


**含义**：约束就是告诉Pacemaker"什么资源应该在哪里运行"、"什么资源必须一起运行"等规则。

| 约束类型 | **作用说明** | **实际例子** |
|---------|-------------|-------------|
| 🎯 **位置约束** | `指定资源优先在哪个节点运行` | `Web服务优先在node1运行` |
| 🔗 **排列约束** | `指定资源间的运行顺序` | `先启动数据库，再启动Web服务` |
| 👥 **组合约束** | `指定资源是否必须在同一节点` | `Web服务和VIP必须在同一节点` |

### 2.3 Pacemaker工作流程


```
故障检测与处理流程：

时间线: ────────────────────────────────→

节点1: [正常运行] → [故障检测] → [标记离线] → [等待恢复]
        ↓              ↓           ↓
资源:   [运行中]   → [健康检查失败] → [开始迁移] → [在节点2运行]
        ↓              ↓              ↓
Pacemaker: [监控]  → [发现故障]    → [执行切换] → [更新配置]
```

**详细步骤说明**：
1. **持续监控**：每隔几秒检查一次资源和节点状态
2. **故障识别**：发现节点无响应或资源异常
3. **决策制定**：根据约束规则决定资源新位置
4. **执行迁移**：在目标节点启动资源，在故障节点停止资源
5. **状态更新**：更新集群配置信息库

---

## 3. 📡 Corosync集群通信层


### 3.1 Corosync的作用


**通俗解释**：如果说Pacemaker是集群的大脑，那么Corosync就是集群的神经系统，负责各个节点之间的信息传递和协调。

**核心功能**：
```
🔸 节点通信
├─ 心跳检测：定期发送"我还活着"的信号
├─ 消息传递：在节点间传递重要信息  
├─ 状态同步：保持所有节点信息一致
└─ 成员管理：跟踪哪些节点在线/离线

🔸 通信保障
├─ 可靠传输：确保重要消息不丢失
├─ 顺序保证：保证消息按正确顺序处理
├─ 组播通信：一次发送，多点接收
└─ 加密安全：防止恶意节点加入
```

### 3.2 心跳机制详解


**心跳是什么**：心跳就像人的脉搏，集群节点定期发送"我还正常工作"的信号给其他节点。

```
心跳通信示例：

时间轴: 0s    1s    2s    3s    4s    5s    6s
       │     │     │     │     │     │     │
节点1: ●──→  ●──→  ●──→  ●──→  ●──→  ✗     ✗    
       │     │     │     │     │     │     │
节点2: ←──●  ←──●  ←──●  ←──●  ←──●  ←──●  ←──●
       
● = 心跳信号正常
✗ = 心跳信号丢失
──→ = 发送方向
```

**心跳超时处理**：
- **正常情况**：每1秒发送一次心跳
- **可疑状态**：连续3次心跳丢失（3秒）
- **确认故障**：连续5次心跳丢失（5秒）
- **开始切换**：标记节点离线，启动资源迁移

### 3.3 Corosync通信方式


#### 🔸 网络通信


```
多种通信路径配置：

主通信网络:  节点1 ←─────── 以太网 ─────→ 节点2
             ↕                           ↕
备通信网络:  节点1 ←───── 备用网络 ────→ 节点2
             ↕                           ↕  
串口通信:    节点1 ←───── 串行线缆 ────→ 节点2
```

**通信路径说明**：
- **主网络**：正常业务和心跳通信
- **备网络**：主网络故障时的备用通道
- **串口**：最后的通信手段，防止网络完全中断

#### 🔸 仲裁设备


**仲裁设备作用**：当集群分裂成两部分时，帮助决定哪部分可以继续提供服务。

```
仲裁机制工作原理：

正常情况: [节点1] ←→ [节点2] ←→ [节点3]  (3票，超过半数)

网络分裂: [节点1] ✗ [节点2] ←→ [节点3]
         (1票)     (2票，超过半数继续服务)

仲裁设备: [节点1] ←→ [仲裁盘] ←→ [节点2]
         如果节点1能访问仲裁盘，节点2不能
         则节点1获得"选举权"继续服务
```

---

## 4. 🔧 集群配置管理工具


### 4.1 常用配置工具介绍


**配置工具的作用**：就像汽车的方向盘和仪表盘，让管理员能够控制和监控集群的运行状态。

| 工具名称 | **主要用途** | **使用场景** | **难易程度** |
|---------|-------------|-------------|-------------|
| 🖥️ **crm命令** | `命令行配置集群` | `日常管理和故障排查` | `⭐⭐⭐` |
| 🎛️ **pcs命令** | `Red Hat系统集群管理` | `RHEL/CentOS环境` | `⭐⭐` |
| 🌐 **Hawk Web界面** | `图形化集群管理` | `可视化配置和监控` | `⭐` |
| 📝 **crmsh脚本** | `批量配置和自动化` | `大规模部署` | `⭐⭐⭐⭐` |

### 4.2 基本配置操作


#### 🔸 查看集群状态


```bash
# 查看集群整体状态
crm status

# 查看详细节点信息  
crm node status

# 查看资源运行情况
crm resource status
```

**输出信息解读**：
```
集群状态输出示例：

Stack: corosync                    ← 使用corosync通信
Current DC: node1                  ← 当前决策节点
Version: 1.1.18                   ← Pacemaker版本
2 nodes configured                 ← 配置了2个节点
3 resources configured             ← 配置了3个资源

Online: [ node1 node2 ]           ← 在线节点列表
                                   ← 离线节点为空表示正常

webserver (IPaddr2): Started node1 ← Web服务在node1运行
database  (mysql):   Started node1 ← 数据库在node1运行  
vip       (IPaddr2): Started node1 ← 虚拟IP在node1运行
```

#### 🔸 配置资源


**创建IP资源示例**：
```bash
# 创建虚拟IP资源
crm configure primitive vip IPaddr2 \
    params ip=192.168.1.100 \
    nic=eth0 \
    op monitor interval=30s
```

**参数含义说明**：
- `primitive`：基本资源类型
- `vip`：资源名称（自定义）
- `IPaddr2`：资源代理类型
- `ip=192.168.1.100`：虚拟IP地址
- `nic=eth0`：网络接口
- `monitor interval=30s`：每30秒检查一次

---

## 5. 🔌 资源代理与集群信息库


### 5.1 资源代理（Resource Agent）详解


**什么是资源代理**：资源代理就像是各种服务的"翻译官"，它知道如何启动、停止、检查特定的服务，并将这些操作标准化给Pacemaker使用。

```
资源代理工作模式：

Pacemaker发出指令: "启动Web服务"
        ↓
资源代理接收: Apache资源代理收到指令
        ↓  
具体执行: systemctl start httpd
        ↓
状态反馈: "Web服务已成功启动"
        ↓
Pacemaker记录: 更新资源状态为"运行中"
```

### 5.2 资源代理分类


#### 🔸 标准资源代理类型


| 代理类型 | **管理对象** | **典型应用** | **特点** |
|---------|-------------|-------------|---------|
| 🌐 **IPaddr2** | `虚拟IP地址` | `Web服务访问入口` | `网络层资源` |
| 🗃️ **Filesystem** | `文件系统挂载` | `共享存储访问` | `存储层资源` |
| 🔧 **systemd** | `系统服务` | `各种Linux服务` | `通用服务管理` |
| 🏢 **apache** | `Apache Web服务器` | `Web站点服务` | `专用应用管理` |
| 💾 **mysql** | `MySQL数据库` | `数据库服务` | `数据库专用` |

#### 🔸 资源代理标准操作


**每个资源代理必须支持的基本操作**：
```
🔸 start   - 启动资源
🔸 stop    - 停止资源  
🔸 monitor - 检查资源健康状态
🔸 status  - 查询资源当前状态
🔸 meta    - 显示资源代理信息
```

**监控操作的重要性**：
- **健康检查**：定期确认服务正常运行
- **故障发现**：及时发现服务异常
- **自动恢复**：触发资源重启或迁移

### 5.3 集群信息库（CIB）


**CIB是什么**：集群信息库就像集群的"档案馆"，存储着集群的所有配置信息、资源状态、节点信息等。

```
CIB信息库结构：

┌─────────────────────────────────┐
│            CIB根节点            │
├─────────────────────────────────┤
│         集群配置信息            │ ← 全局设置、版本等
├─────────────────────────────────┤  
│         节点信息列表            │ ← 节点属性、状态
├─────────────────────────────────┤
│         资源定义清单            │ ← 资源配置、参数
├─────────────────────────────────┤
│         约束规则配置            │ ← 位置、顺序、组合约束
├─────────────────────────────────┤
│         状态信息记录            │ ← 当前运行状态
└─────────────────────────────────┘
```

**CIB的同步机制**：
- **主从同步**：配置变更在DC节点处理后同步到所有节点
- **版本控制**：每次修改都有版本号，确保一致性
- **冲突解决**：多个节点同时修改时的冲突处理机制

---

## 6. 🔐 集群通信协议与安全


### 6.1 节点通信协议


**通信协议的作用**：确保集群节点之间能够可靠、安全地交换信息。

#### 🔸 UDP组播协议


**组播通信优势**：
```
单播通信: 节点1 → 节点2, 节点1 → 节点3, 节点1 → 节点4
         需要发送3次消息

组播通信: 节点1 → [所有节点]
         只需发送1次消息，效率更高
```

**组播配置要点**：
- **组播地址**：通常使用224.0.0.0-239.255.255.255范围
- **端口配置**：默认使用5405端口
- **TTL设置**：控制数据包传播范围

#### 🔸 点对点通信


**适用场景**：
- 网络不支持组播
- 需要更严格的安全控制
- 跨子网集群部署

### 6.2 集群安全机制


#### 🔸 认证与加密


> 🔒 **安全警告**
> 
> 集群通信包含敏感信息，必须进行加密保护

**安全机制层次**：
```
安全防护层次：

应用层: HMAC消息认证 ← 防止消息篡改
       ↓
传输层: AES数据加密 ← 防止信息泄露  
       ↓
网络层: 防火墙策略 ← 限制网络访问
       ↓  
物理层: 专用网络 ← 物理隔离保护
```

#### 🔸 访问控制


**节点认证机制**：
- **共享密钥**：所有节点使用相同的密钥文件
- **证书认证**：使用数字证书进行节点身份验证
- **IP白名单**：只允许特定IP地址的节点加入

**密钥管理最佳实践**：
```bash
# 生成安全密钥
corosync-keygen

# 分发密钥到所有节点
scp /etc/corosync/authkey node2:/etc/corosync/
scp /etc/corosync/authkey node3:/etc/corosync/

# 设置正确权限
chmod 400 /etc/corosync/authkey
```

---

## 7. ⚖️ 仲裁机制与脑裂防护


### 7.1 什么是脑裂问题


**脑裂含义**：当集群网络出现故障时，原本统一的集群分裂成多个独立部分，每部分都认为自己是"正宗"的集群，导致资源在多个地方同时运行。

```
脑裂问题示意：

正常状态:
[节点1] ←─网络通信─→ [节点2]
  ↓                    ↓
[共享存储] ←─────→ [数据库]

网络故障导致脑裂:
[节点1]  ✗ 网络中断 ✗  [节点2]  
  ↓                       ↓
[启动数据库]           [也启动数据库]
  ↓                       ↓  
[同时写入存储] ← 冲突！→ [同时写入存储]
```

**脑裂的危害**：
- **数据损坏**：多个节点同时写入共享存储
- **服务冲突**：相同IP地址在多个节点出现
- **资源浪费**：重复的服务消耗系统资源

### 7.2 仲裁机制原理


**仲裁机制作用**：就像法官一样，当集群出现分歧时，决定哪一方有权继续提供服务。

#### 🔸 节点数量仲裁


```
奇数节点集群（推荐）:

3节点集群: [节点1] [节点2] [节点3]
网络分裂: [节点1] ✗ [节点2][节点3]
仲裁结果: 1票 < 2票，节点2+3继续服务

5节点集群: [节点1][节点2] ✗ [节点3][节点4][节点5]  
仲裁结果: 2票 < 3票，节点3+4+5继续服务
```

**仲裁规则**：
- **过半原则**：获得超过半数投票的部分继续服务
- **少数服务停止**：少于半数的节点自动停止服务
- **平票处理**：使用额外仲裁设备决定

#### 🔸 仲裁设备


**仲裁设备类型**：

| 设备类型 | **工作原理** | **优缺点** | **适用场景** |
|---------|-------------|-----------|-------------|
| 🗃️ **仲裁盘** | `通过共享存储投票` | `简单可靠，但需共享存储` | `有SAN环境` |
| 🌐 **仲裁服务器** | `远程节点提供仲裁` | `成本低，但需网络连接` | `跨地域集群` |
| 🔌 **仲裁设备** | `专用硬件设备` | `最可靠，但成本高` | `关键业务` |

### 7.3 脑裂防护策略


#### 🔸 STONITH机制


**STONITH含义**："Shoot The Other Node In The Head"，即"爆头其他节点"，通过强制关闭故障节点来防止脑裂。

```
STONITH工作流程：

1. 检测到节点异常
   ↓
2. 尝试正常通信无响应  
   ↓
3. 启动STONITH操作
   ↓
4. 强制关闭异常节点电源
   ↓  
5. 确认节点已离线
   ↓
6. 在其他节点启动资源
```

**STONITH设备类型**：
- **IPMI远程管理**：通过管理网络控制电源
- **智能PDU**：通过网络控制电源插座
- **虚拟化平台**：通过虚拟化管理接口控制虚拟机

#### 🔸 资源级别保护


> 💡 **专业提示**
> 
> 除了节点级STONITH，还可以在资源级别设置保护机制

**应用层保护机制**：
- **数据库锁**：确保只有一个实例能访问数据
- **文件锁**：防止多个进程同时写入文件
- **应用检查**：应用启动前检查是否有其他实例

---

## 8. 📊 集群状态监控


### 8.1 监控系统架构


**监控的重要性**：集群监控就像医院的监护设备，实时观察集群"健康状况"，及时发现和处理问题。

```
集群监控体系架构：

┌─────────────────────────────────┐
│        监控展示层               │ ← Web界面、报表、告警
├─────────────────────────────────┤
│        数据分析层               │ ← 趋势分析、预警、统计
├─────────────────────────────────┤  
│        数据收集层               │ ← 指标采集、日志收集
├─────────────────────────────────┤
│        集群节点层               │ ← 节点状态、资源状态
└─────────────────────────────────┘
```

### 8.2 关键监控指标


#### 🔸 节点层面监控


| 监控项目 | **正常范围** | **异常表现** | **处理建议** |
|---------|-------------|-------------|-------------|
| 🖥️ **CPU使用率** | `< 80%` | `持续> 90%` | `检查进程，考虑扩容` |
| 💾 **内存使用率** | `< 85%` | `> 95%` | `释放内存或增加内存` |
| 💿 **磁盘使用率** | `< 90%` | `> 95%` | `清理空间或扩容磁盘` |
| 🌐 **网络连通性** | `< 1ms延迟` | `丢包或高延迟` | `检查网络设备` |
| ⚡ **心跳状态** | `正常` | `超时或丢失` | `检查通信链路` |

#### 🔸 资源层面监控


**资源状态分类**：
```
🟢 Started   - 资源正常运行
🟡 Stopped   - 资源已停止（正常）
🔴 Failed    - 资源运行失败
🟠 Pending   - 资源正在启动/停止
🔵 Unmanaged - 资源未被管理
```

**监控检查频率**：
- **关键资源**：每30秒检查一次
- **一般资源**：每1分钟检查一次
- **网络资源**：每15秒检查一次

### 8.3 日志管理与分析


#### 🔸 重要日志文件


```bash
# 主要集群日志位置
/var/log/cluster/corosync.log     # Corosync通信日志
/var/log/pacemaker.log            # Pacemaker决策日志  
/var/log/messages                 # 系统综合日志
/var/log/ha-log                   # 集群综合日志
```

**日志级别说明**：
- **ERROR**：严重错误，需要立即处理
- **WARN**：警告信息，需要关注
- **INFO**：一般信息，记录重要操作
- **DEBUG**：调试信息，问题排查时使用

#### 🔸 常见告警信息


> ⚠️ **常见告警**
> 
> `"node1 lost quorum"` - 节点失去仲裁权
> 
> `"resource webserver failed"` - Web服务资源失败
> 
> `"STONITH device timeout"` - STONITH设备超时

**告警处理流程**：
```
收到告警 → 检查日志 → 定位问题 → 制定方案 → 执行修复 → 验证结果
```

### 8.4 性能调优监控


#### 🔸 集群性能指标


**关键性能指标**：
```
故障切换时间: 
├─ 故障检测时间: 5-30秒
├─ 决策制定时间: 1-5秒  
├─ 资源迁移时间: 10-60秒
└─ 服务恢复时间: 5-30秒

总体目标: 2分钟内完成故障切换
```

**性能优化要点**：
- **心跳间隔调优**：平衡检测速度和网络负载
- **超时参数调优**：避免误判但保证及时响应
- **资源监控频率**：关键资源更频繁检查
- **日志级别控制**：生产环境减少DEBUG日志

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的核心概念


```
🔸 集群基础：多机协作提供高可用服务，故障时自动切换
🔸 软件栈：Pacemaker管理+Corosync通信+资源代理执行  
🔸 核心组件：资源、约束、节点、CIB信息库
🔸 通信机制：心跳检测、组播通信、状态同步
🔸 防护机制：仲裁投票、STONITH强制关机、脑裂防护
🔸 监控体系：节点监控、资源监控、日志分析、性能调优
```

### 9.2 关键理解要点


**🔹 集群解决的核心问题**
```
单点故障 → 多点冗余
手工切换 → 自动故障转移  
服务中断 → 业务连续性
被动响应 → 主动监控预警
```

**🔹 组件协作关系**
```
应用服务 ← 资源代理管理 ← Pacemaker决策 ← Corosync通信
    ↓           ↓              ↓            ↓
  实际业务   标准化接口      智能调度      信息传递
```

**🔹 高可用的核心要素**
```
冗余设计：服务、网络、存储都要有备份
故障检测：快速发现异常情况
自动切换：无需人工干预的故障转移
数据一致性：避免脑裂导致的数据冲突
```

### 9.3 实际应用指导


**🎯 部署规划要点**
- **节点数量**：推荐奇数个节点（3、5、7个）
- **网络规划**：至少2条独立的心跳网络
- **存储设计**：共享存储或数据同步方案
- **STONITH设备**：必须配置可靠的电源管理

**🔧 日常运维要点**
- **定期检查**：每日检查集群状态和日志
- **配置备份**：定期备份CIB配置信息
- **故障演练**：定期进行故障切换测试
- **性能监控**：关注切换时间和资源使用率

**⚠️ 常见误区避免**
- **错误认知**：认为集群能解决所有故障（应用bug无法自动修复）
- **配置缺陷**：忽略STONITH配置（可能导致脑裂）
- **网络单点**：只配置单一心跳网络（网络故障时无法通信）
- **测试不足**：没有充分的故障切换测试（实际故障时可能失效）

### 9.4 进阶学习方向


```
基础掌握后的发展路径：

实践操作 ← 搭建测试环境，熟悉配置命令
    ↓
故障排查 ← 学习日志分析，问题定位技能  
    ↓
性能调优 ← 优化切换时间，提升集群性能
    ↓
高级特性 ← 学习高级约束，复杂资源管理
    ↓
生产应用 ← 结合业务需求，设计集群方案
```

**核心记忆口诀**：
- 集群高可用，多机共协作
- Pacemaker做大脑，Corosync传消息  
- 资源加约束，故障能自切
- 仲裁防脑裂，监控保平安