---
title: 5ã€POSIXçº¿ç¨‹ç¼–ç¨‹åŸºç¡€
---
## ğŸ“š ç›®å½•

1. [POSIXçº¿ç¨‹æ¦‚è¿°](#1-POSIXçº¿ç¨‹æ¦‚è¿°)
2. [çº¿ç¨‹åˆ›å»ºä¸ç®¡ç†](#2-çº¿ç¨‹åˆ›å»ºä¸ç®¡ç†)
3. [çº¿ç¨‹ç»ˆæ­¢ä¸å›æ”¶](#3-çº¿ç¨‹ç»ˆæ­¢ä¸å›æ”¶)
4. [çº¿ç¨‹IDä¸æ¯”è¾ƒ](#4-çº¿ç¨‹IDä¸æ¯”è¾ƒ)
5. [çº¿ç¨‹å±æ€§é…ç½®](#5-çº¿ç¨‹å±æ€§é…ç½®)
6. [çº¿ç¨‹ä¸è¿›ç¨‹å·®å¼‚](#6-çº¿ç¨‹ä¸è¿›ç¨‹å·®å¼‚)
7. [æ€§èƒ½è€ƒè™‘ä¸æœ€ä½³å®è·µ](#7-æ€§èƒ½è€ƒè™‘ä¸æœ€ä½³å®è·µ)
8. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#8-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ§µ POSIXçº¿ç¨‹æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯POSIXçº¿ç¨‹


**ğŸ“– åŸºæœ¬æ¦‚å¿µ**
```
POSIXçº¿ç¨‹(pthread)ï¼šç¬¦åˆPOSIXæ ‡å‡†çš„çº¿ç¨‹å®ç°
æœ¬è´¨ï¼šåœ¨åŒä¸€ä¸ªè¿›ç¨‹å†…å¹¶å‘æ‰§è¡Œçš„è½»é‡çº§æ‰§è¡Œå•å…ƒ
ç›®æ ‡ï¼šå®ç°ç¨‹åºå†…éƒ¨çš„å¹¶è¡Œå¤„ç†ï¼Œæé«˜æ‰§è¡Œæ•ˆç‡
```

**ğŸ” é€šä¿—ç†è§£**
> ğŸ’¡ **ç®€å•æ¯”å–»**ï¼šå¦‚æœè¿›ç¨‹æ˜¯ä¸€ä¸ªå·¥å‚ï¼Œé‚£ä¹ˆçº¿ç¨‹å°±æ˜¯å·¥å‚é‡Œçš„å·¥äººã€‚å¤šä¸ªå·¥äººå¯ä»¥åŒæ—¶åœ¨åŒä¸€ä¸ªå·¥å‚é‡Œå¹²æ´»ï¼Œå…±äº«å·¥å‚çš„è®¾å¤‡å’ŒåŸæ–™ï¼Œä½†æ¯ä¸ªå·¥äººæœ‰è‡ªå·±ç‹¬ç«‹çš„å·¥ä½œå°(æ ˆç©ºé—´)ã€‚

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦çº¿ç¨‹


**â­ æ ¸å¿ƒä¼˜åŠ¿**
```
ğŸ”¸ å¹¶å‘å¤„ç†ï¼šåŒæ—¶å¤„ç†å¤šä¸ªä»»åŠ¡
ğŸ”¸ èµ„æºå…±äº«ï¼šå…±äº«è¿›ç¨‹å†…å­˜ç©ºé—´
ğŸ”¸ åˆ›å»ºè½»é‡ï¼šæ¯”åˆ›å»ºè¿›ç¨‹å¼€é”€å°å¾—å¤š
ğŸ”¸ é€šä¿¡ç®€å•ï¼šç›´æ¥é€šè¿‡å…±äº«å†…å­˜é€šä¿¡
```

**ğŸ“Š çº¿ç¨‹ vs è¿›ç¨‹å¯¹æ¯”**
| ç‰¹æ€§ | **çº¿ç¨‹** | **è¿›ç¨‹** |
|------|---------|---------|
| ğŸ’¾ å†…å­˜ç©ºé—´ | `å…±äº«è¿›ç¨‹åœ°å€ç©ºé—´` | `ç‹¬ç«‹åœ°å€ç©ºé—´` |
| âš¡ åˆ›å»ºå¼€é”€ | `å°(å¾®ç§’çº§)` | `å¤§(æ¯«ç§’çº§)` |
| ğŸ”„ åˆ‡æ¢å¼€é”€ | `å°` | `å¤§` |
| ğŸ’¬ é€šä¿¡æ–¹å¼ | `å…±äº«å†…å­˜` | `IPCæœºåˆ¶` |
| ğŸ›¡ï¸ éš”ç¦»æ€§ | `å¼±` | `å¼º` |

---

## 2. ğŸš€ çº¿ç¨‹åˆ›å»ºä¸ç®¡ç†


### 2.1 pthread_create()å‡½æ•°è¯¦è§£


**ğŸ”§ å‡½æ•°åŸå‹**
```c
int pthread_create(pthread_t *thread,           // çº¿ç¨‹IDå­˜å‚¨åœ°å€
                   const pthread_attr_t *attr, // çº¿ç¨‹å±æ€§(å¯ä¸ºNULL)
                   void *(*start_routine)(void*), // çº¿ç¨‹æ‰§è¡Œå‡½æ•°
                   void *arg);                 // ä¼ é€’ç»™çº¿ç¨‹å‡½æ•°çš„å‚æ•°
```

**ğŸ“ å‚æ•°è¯´æ˜**
- **thread**ï¼šç”¨æ¥å­˜å‚¨æ–°åˆ›å»ºçº¿ç¨‹çš„ID
- **attr**ï¼šçº¿ç¨‹å±æ€§ï¼Œ`NULL`è¡¨ç¤ºä½¿ç”¨é»˜è®¤å±æ€§
- **start_routine**ï¼šçº¿ç¨‹è¦æ‰§è¡Œçš„å‡½æ•°
- **arg**ï¼šä¼ é€’ç»™çº¿ç¨‹å‡½æ•°çš„å‚æ•°

**âœ… è¿”å›å€¼**
- `0`ï¼šæˆåŠŸåˆ›å»ºçº¿ç¨‹
- `é0`ï¼šé”™è¯¯ç (å¦‚EAGAINã€EINVALç­‰)

### 2.2 ç®€å•çº¿ç¨‹åˆ›å»ºç¤ºä¾‹


```c
#include <pthread.h>
#include <stdio.h>
#include <unistd.h>

// çº¿ç¨‹æ‰§è¡Œå‡½æ•°
void* thread_function(void* arg) {
    int thread_num = *(int*)arg;
    printf("çº¿ç¨‹ %d æ­£åœ¨è¿è¡Œ\n", thread_num);
    sleep(2);  // æ¨¡æ‹Ÿå·¥ä½œ
    printf("çº¿ç¨‹ %d å®Œæˆå·¥ä½œ\n", thread_num);
    return NULL;
}

int main() {
    pthread_t thread1, thread2;
    int num1 = 1, num2 = 2;
    
    // åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹
    pthread_create(&thread1, NULL, thread_function, &num1);
    pthread_create(&thread2, NULL, thread_function, &num2);
    
    printf("ä¸»çº¿ç¨‹ç­‰å¾…å­çº¿ç¨‹å®Œæˆ...\n");
    
    // ç­‰å¾…çº¿ç¨‹ç»“æŸ
    pthread_join(thread1, NULL);
    pthread_join(thread2, NULL);
    
    printf("æ‰€æœ‰çº¿ç¨‹å®Œæˆ\n");
    return 0;
}
```

**ğŸ”„ æ‰§è¡Œæµç¨‹å›¾**
```
ä¸»çº¿ç¨‹                çº¿ç¨‹1              çº¿ç¨‹2
  |                    |                  |
  |--åˆ›å»ºçº¿ç¨‹1--------->|                  |
  |--åˆ›å»ºçº¿ç¨‹2----------------------->|    |
  |                    |--æ‰§è¡Œå‡½æ•°        |--æ‰§è¡Œå‡½æ•°
  |--ç­‰å¾…çº¿ç¨‹1--------->|                  |
  |--ç­‰å¾…çº¿ç¨‹2----------------------->|    |
  |<--çº¿ç¨‹1ç»“æŸ---------|                  |
  |<--çº¿ç¨‹2ç»“æŸ---------------------------|
  |--ç¨‹åºç»“æŸ
```

### 2.3 çº¿ç¨‹åˆ›å»ºæ³¨æ„äº‹é¡¹


**âš ï¸ å¸¸è§é—®é¢˜**
```
ğŸš¨ å‚æ•°ä¼ é€’é™·é˜±ï¼š
é”™è¯¯åšæ³•ï¼šç›´æ¥ä¼ é€’æ ˆå˜é‡åœ°å€
æ­£ç¡®åšæ³•ï¼šä¼ é€’ç¨³å®šçš„å†…å­˜åœ°å€

ğŸš¨ çº¿ç¨‹å‡½æ•°è¿”å›ï¼š
å¿…é¡»é€šè¿‡returnæˆ–pthread_exit()æ­£ç¡®é€€å‡º
é¿å…ç›´æ¥ä»çº¿ç¨‹å‡½æ•°ä¸­exit()
```

**ğŸ’¡ å‚æ•°ä¼ é€’çš„æ­£ç¡®æ–¹å¼**
```c
// âŒ é”™è¯¯ï¼šå¾ªç¯ä¸­ä¼ é€’æ ˆå˜é‡åœ°å€
for(int i = 0; i < 5; i++) {
    pthread_create(&threads[i], NULL, func, &i);  // å±é™©ï¼
}

// âœ… æ­£ç¡®ï¼šä¼ é€’ç¨³å®šçš„å†…å­˜åœ°å€
int *thread_args = malloc(5 * sizeof(int));
for(int i = 0; i < 5; i++) {
    thread_args[i] = i;
    pthread_create(&threads[i], NULL, func, &thread_args[i]);
}
```

---

## 3. ğŸ”š çº¿ç¨‹ç»ˆæ­¢ä¸å›æ”¶


### 3.1 pthread_exit()çº¿ç¨‹ç»ˆæ­¢


**ğŸ”§ å‡½æ•°åŸå‹**
```c
void pthread_exit(void *retval);  // retvalæ˜¯è¿”å›å€¼
```

**ğŸ¯ æ ¸å¿ƒä½œç”¨**
- **æ­£å¸¸ç»ˆæ­¢**ï¼šçº¿ç¨‹æ­£å¸¸ç»“æŸæ‰§è¡Œ
- **è¿”å›å€¼**ï¼šå¯ä»¥å‘ç­‰å¾…çš„çº¿ç¨‹ä¼ é€’è¿”å›å€¼
- **èµ„æºæ¸…ç†**ï¼šè‡ªåŠ¨æ¸…ç†çº¿ç¨‹èµ„æº

**ğŸ“ ä½¿ç”¨ç¤ºä¾‹**
```c
void* worker_thread(void* arg) {
    int work_result = 42;
    
    // æ¨¡æ‹Ÿå·¥ä½œ
    printf("çº¿ç¨‹å¼€å§‹å·¥ä½œ...\n");
    sleep(1);
    
    // æ­£å¸¸é€€å‡ºå¹¶è¿”å›ç»“æœ
    pthread_exit(&work_result);
}
```

### 3.2 pthread_join()çº¿ç¨‹å›æ”¶


**ğŸ”§ å‡½æ•°åŸå‹**
```c
int pthread_join(pthread_t thread,    // è¦ç­‰å¾…çš„çº¿ç¨‹ID
                 void **retval);      // æ¥æ”¶çº¿ç¨‹è¿”å›å€¼çš„æŒ‡é’ˆ
```

**â­ æ ¸å¿ƒåŠŸèƒ½**
- **ç­‰å¾…çº¿ç¨‹**ï¼šé˜»å¡ç­‰å¾…æŒ‡å®šçº¿ç¨‹ç»“æŸ
- **å›æ”¶èµ„æº**ï¼šå›æ”¶çº¿ç¨‹å ç”¨çš„ç³»ç»Ÿèµ„æº
- **è·å–è¿”å›å€¼**ï¼šè·å–çº¿ç¨‹çš„é€€å‡ºè¿”å›å€¼

**ğŸ”„ joinä¸detachçš„åŒºåˆ«**
```
pthread_join()ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    ç­‰å¾…     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä¸»çº¿ç¨‹    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â†’   â”‚   å­çº¿ç¨‹    â”‚
â”‚  (é˜»å¡ç­‰å¾…) â”‚ â†â”€â”€â”€â”€â”€â”€â”€â”€   â”‚  (è¿”å›ç»“æœ) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

pthread_detach()ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä¸»çº¿ç¨‹    â”‚             â”‚   å­çº¿ç¨‹    â”‚
â”‚  (ç»§ç»­æ‰§è¡Œ) â”‚             â”‚  (ç‹¬ç«‹è¿è¡Œ) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 pthread_detach()åˆ†ç¦»çº¿ç¨‹


**ğŸ”§ å‡½æ•°åŸå‹**
```c
int pthread_detach(pthread_t thread);
```

**ğŸ¯ ä½¿ç”¨åœºæ™¯**
> ğŸ’¡ **ä½•æ—¶ä½¿ç”¨detach**ï¼šå½“ä½ ä¸éœ€è¦ç­‰å¾…çº¿ç¨‹ç»“æŸï¼Œä¹Ÿä¸éœ€è¦è·å–çº¿ç¨‹è¿”å›å€¼æ—¶ï¼Œä½¿ç”¨detachè®©çº¿ç¨‹è‡ªåŠ¨æ¸…ç†èµ„æºã€‚

**ğŸ“ å¯¹æ¯”ç¤ºä¾‹**
```c
// åœºæ™¯1ï¼šéœ€è¦è·å–ç»“æœ - ä½¿ç”¨join
void* calculate_result(void* arg) {
    int *result = malloc(sizeof(int));
    *result = 42;  // è®¡ç®—ç»“æœ
    return result;
}

int main() {
    pthread_t thread;
    void *result;
    
    pthread_create(&thread, NULL, calculate_result, NULL);
    pthread_join(thread, &result);  // ç­‰å¾…å¹¶è·å–ç»“æœ
    
    printf("è®¡ç®—ç»“æœ: %d\n", *(int*)result);
    free(result);
}

// åœºæ™¯2ï¼šä¸éœ€è¦ç»“æœ - ä½¿ç”¨detach
void* background_task(void* arg) {
    // åå°ä»»åŠ¡ï¼Œæ— éœ€è¿”å›ç»“æœ
    printf("åå°ä»»åŠ¡æ‰§è¡Œä¸­...\n");
    sleep(5);
    printf("åå°ä»»åŠ¡å®Œæˆ\n");
    return NULL;
}

int main() {
    pthread_t thread;
    
    pthread_create(&thread, NULL, background_task, NULL);
    pthread_detach(thread);  // åˆ†ç¦»çº¿ç¨‹ï¼Œè‡ªåŠ¨æ¸…ç†
    
    // ä¸»çº¿ç¨‹ç»§ç»­å…¶ä»–å·¥ä½œ
    printf("ä¸»çº¿ç¨‹ç»§ç»­å·¥ä½œ...\n");
    sleep(10);  // ç­‰å¾…è¶³å¤Ÿæ—¶é—´è®©åå°ä»»åŠ¡å®Œæˆ
}
```

---

## 4. ğŸ†” çº¿ç¨‹IDä¸æ¯”è¾ƒ


### 4.1 pthread_self()è·å–çº¿ç¨‹ID


**ğŸ”§ å‡½æ•°åŸå‹**
```c
pthread_t pthread_self(void);  // è¿”å›å½“å‰çº¿ç¨‹çš„ID
```

**ğŸ¯ å®é™…åº”ç”¨**
- **æ—¥å¿—è®°å½•**ï¼šåœ¨æ—¥å¿—ä¸­æ ‡è¯†æ˜¯å“ªä¸ªçº¿ç¨‹è¾“å‡ºçš„ä¿¡æ¯
- **è°ƒè¯•åˆ†æ**ï¼šè·Ÿè¸ªçº¿ç¨‹æ‰§è¡Œæµç¨‹
- **æ¡ä»¶åˆ¤æ–­**ï¼šåˆ¤æ–­å½“å‰æ˜¯å¦æ˜¯ç‰¹å®šçº¿ç¨‹

### 4.2 pthread_equal()çº¿ç¨‹æ¯”è¾ƒ


**ğŸ”§ å‡½æ•°åŸå‹**
```c
int pthread_equal(pthread_t t1, pthread_t t2);  // æ¯”è¾ƒä¸¤ä¸ªçº¿ç¨‹IDæ˜¯å¦ç›¸åŒ
```

**âš ï¸ ä¸ºä»€ä¹ˆéœ€è¦ä¸“é—¨çš„æ¯”è¾ƒå‡½æ•°**
> ğŸ’¡ **é‡è¦æé†’**ï¼špthread_tå¯èƒ½æ˜¯ç»“æ„ä½“è€Œä¸æ˜¯ç®€å•çš„æ•´æ•°ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥ç”¨`==`æ¯”è¾ƒï¼Œå¿…é¡»ä½¿ç”¨pthread_equal()å‡½æ•°ã€‚

**ğŸ“ å®ç”¨ç¤ºä¾‹**
```c
#include <pthread.h>
#include <stdio.h>

pthread_t main_thread_id;

void* worker_thread(void* arg) {
    pthread_t current = pthread_self();
    
    printf("å·¥ä½œçº¿ç¨‹ID: %lu\n", (unsigned long)current);
    
    // åˆ¤æ–­æ˜¯å¦æ˜¯ä¸»çº¿ç¨‹
    if (pthread_equal(current, main_thread_id)) {
        printf("è¿™æ˜¯ä¸»çº¿ç¨‹\n");
    } else {
        printf("è¿™æ˜¯å­çº¿ç¨‹\n");
    }
    
    return NULL;
}

int main() {
    main_thread_id = pthread_self();  // ä¿å­˜ä¸»çº¿ç¨‹ID
    printf("ä¸»çº¿ç¨‹ID: %lu\n", (unsigned long)main_thread_id);
    
    pthread_t worker;
    pthread_create(&worker, NULL, worker_thread, NULL);
    pthread_join(worker, NULL);
    
    return 0;
}
```

---

## 5. âš™ï¸ çº¿ç¨‹å±æ€§é…ç½®


### 5.1 pthread_attr_tå±æ€§å¯¹è±¡


**ğŸ“– åŸºæœ¬æ¦‚å¿µ**
```
pthread_attr_tï¼šçº¿ç¨‹å±æ€§ç»“æ„ä½“
ä½œç”¨ï¼šæ§åˆ¶çº¿ç¨‹çš„å„ç§ç‰¹æ€§
ä½¿ç”¨æµç¨‹ï¼šåˆå§‹åŒ– â†’ è®¾ç½® â†’ åˆ›å»ºçº¿ç¨‹ â†’ é”€æ¯
```

**ğŸ”„ å±æ€§æ“ä½œæµç¨‹**
```c
pthread_attr_t attr;

// 1. åˆå§‹åŒ–å±æ€§å¯¹è±¡
pthread_attr_init(&attr);

// 2. è®¾ç½®å„ç§å±æ€§
pthread_attr_setdetachstate(&attr, PTHREAD_CREATE_DETACHED);
pthread_attr_setstacksize(&attr, 1024*1024);  // 1MBæ ˆ

// 3. åˆ›å»ºçº¿ç¨‹æ—¶ä½¿ç”¨å±æ€§
pthread_create(&thread, &attr, thread_func, NULL);

// 4. é”€æ¯å±æ€§å¯¹è±¡
pthread_attr_destroy(&attr);
```

### 5.2 æ ˆå¤§å°è®¾ç½®


**ğŸ”§ ç›¸å…³å‡½æ•°**
```c
// è®¾ç½®æ ˆå¤§å°
int pthread_attr_setstacksize(pthread_attr_t *attr, size_t stacksize);

// è·å–æ ˆå¤§å°
int pthread_attr_getstacksize(const pthread_attr_t *attr, size_t *stacksize);
```

**ğŸ“Š æ ˆå¤§å°é€‰æ‹©æŒ‡å—**
| åº”ç”¨åœºæ™¯ | **æ¨èæ ˆå¤§å°** | **è¯´æ˜** |
|---------|---------------|---------|
| ğŸ”¸ ç®€å•ä»»åŠ¡ | `64KB - 256KB` | `åŸºæœ¬çš„æ•°æ®å¤„ç†` |
| ğŸ”¸ ä¸€èˆ¬åº”ç”¨ | `512KB - 1MB` | `å¸¸è§„ä¸šåŠ¡é€»è¾‘` |
| ğŸ”¸ é€’å½’ç®—æ³• | `2MB - 8MB` | `æ·±åº¦é€’å½’è°ƒç”¨` |
| ğŸ”¸ å¤§æ•°æ®å¤„ç† | `8MB+` | `å¤§å‹æ•°ç»„æˆ–å¤æ‚è®¡ç®—` |

**ğŸ’¡ æ ˆå¤§å°è®¾ç½®ç¤ºä¾‹**
```c
void* deep_recursion_task(void* arg) {
    char large_array[500000];  // éœ€è¦è¾ƒå¤§æ ˆç©ºé—´
    // æ‰§è¡Œéœ€è¦å¤§æ ˆç©ºé—´çš„ä»»åŠ¡
    return NULL;
}

int main() {
    pthread_t thread;
    pthread_attr_t attr;
    
    pthread_attr_init(&attr);
    
    // è®¾ç½®2MBæ ˆå¤§å°
    pthread_attr_setstacksize(&attr, 2 * 1024 * 1024);
    
    pthread_create(&thread, &attr, deep_recursion_task, NULL);
    pthread_join(thread, NULL);
    
    pthread_attr_destroy(&attr);
    return 0;
}
```

### 5.3 è°ƒåº¦ç­–ç•¥é…ç½®


**ğŸ”§ è®¾ç½®åˆ†ç¦»çŠ¶æ€**
```c
// è®¾ç½®ä¸ºåˆ†ç¦»çŠ¶æ€ï¼ˆåˆ›å»ºæ—¶å°±detachï¼‰
pthread_attr_setdetachstate(&attr, PTHREAD_CREATE_DETACHED);

// è®¾ç½®ä¸ºå¯è¿æ¥çŠ¶æ€ï¼ˆé»˜è®¤ï¼Œéœ€è¦joinï¼‰
pthread_attr_setdetachstate(&attr, PTHREAD_CREATE_JOINABLE);
```

**ğŸ“ å®é™…åº”ç”¨åœºæ™¯**
```c
// åœºæ™¯ï¼šåˆ›å»ºå¤šä¸ªåå°æœåŠ¡çº¿ç¨‹
void create_service_threads() {
    pthread_attr_t attr;
    pthread_attr_init(&attr);
    
    // è®¾ç½®ä¸ºåˆ†ç¦»çŠ¶æ€ï¼Œæ— éœ€æ‰‹åŠ¨join
    pthread_attr_setdetachstate(&attr, PTHREAD_CREATE_DETACHED);
    
    // è®¾ç½®é€‚å½“çš„æ ˆå¤§å°
    pthread_attr_setstacksize(&attr, 512 * 1024);  // 512KB
    
    for (int i = 0; i < 5; i++) {
        pthread_t thread;
        pthread_create(&thread, &attr, service_worker, &i);
        // æ— éœ€pthread_joinï¼Œçº¿ç¨‹ä¼šè‡ªåŠ¨æ¸…ç†
    }
    
    pthread_attr_destroy(&attr);
}
```

---

## 6. ğŸ”„ çº¿ç¨‹ä¸è¿›ç¨‹å·®å¼‚


### 6.1 èµ„æºå…±äº«å·®å¼‚


**ğŸ“Š å…±äº«èµ„æºå¯¹æ¯”**
```
è¿›ç¨‹é—´ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è¿›ç¨‹A     â”‚    â”‚   è¿›ç¨‹B     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ç‹¬ç«‹å†…å­˜ â”‚ â”‚    â”‚ â”‚ ç‹¬ç«‹å†…å­˜ â”‚ â”‚
â”‚ â”‚ ç‹¬ç«‹æ–‡ä»¶ â”‚ â”‚    â”‚ â”‚ ç‹¬ç«‹æ–‡ä»¶ â”‚ â”‚
â”‚ â”‚ ç‹¬ç«‹å˜é‡ â”‚ â”‚    â”‚ â”‚ ç‹¬ç«‹å˜é‡ â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

çº¿ç¨‹é—´ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           åŒä¸€è¿›ç¨‹               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚ â”‚ çº¿ç¨‹A   â”‚  â”‚ çº¿ç¨‹B   â”‚       â”‚
â”‚ â”‚ ç‹¬ç«‹æ ˆ  â”‚  â”‚ ç‹¬ç«‹æ ˆ  â”‚       â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚          å…±äº«å†…å­˜               â”‚
â”‚          å…±äº«æ–‡ä»¶               â”‚
â”‚          å…±äº«å…¨å±€å˜é‡           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**âš¡ å…±äº«å†…å®¹è¯¦è§£**
| èµ„æºç±»å‹ | **è¿›ç¨‹é—´** | **çº¿ç¨‹é—´** |
|---------|-----------|-----------|
| ğŸ’¾ å †å†…å­˜ | `ç‹¬ç«‹` | `å…±äº«` |
| ğŸ“š å…¨å±€å˜é‡ | `ç‹¬ç«‹` | `å…±äº«` |
| ğŸ“ æ–‡ä»¶æè¿°ç¬¦ | `ç‹¬ç«‹(å¯ç»§æ‰¿)` | `å…±äº«` |
| ğŸ”¤ ç¯å¢ƒå˜é‡ | `ç‹¬ç«‹(å¯ç»§æ‰¿)` | `å…±äº«` |
| ğŸ“‹ æ ˆç©ºé—´ | `ç‹¬ç«‹` | `ç‹¬ç«‹` |
| ğŸ†” PID | `ä¸åŒ` | `ç›¸åŒ` |

### 6.2 é€šä¿¡æ–¹å¼å·®å¼‚


**ğŸ“ è¿›ç¨‹é—´é€šä¿¡(IPC)**
```
ğŸ”¸ ç®¡é“(pipe)ï¼šæ•°æ®æµå¼ä¼ è¾“
ğŸ”¸ æ¶ˆæ¯é˜Ÿåˆ—ï¼šç»“æ„åŒ–æ¶ˆæ¯ä¼ é€’  
ğŸ”¸ å…±äº«å†…å­˜ï¼šé«˜æ•ˆä½†éœ€è¦åŒæ­¥
ğŸ”¸ ä¿¡å·é‡ï¼šåŒæ­¥åŸè¯­
ğŸ”¸ å¥—æ¥å­—ï¼šç½‘ç»œé€šä¿¡
```

**ğŸ—£ï¸ çº¿ç¨‹é—´é€šä¿¡**
```c
// ç›´æ¥é€šè¿‡å…±äº«å˜é‡é€šä¿¡ï¼ˆéœ€è¦åŒæ­¥ï¼‰
int global_counter = 0;  // å…¨å±€å˜é‡ï¼Œæ‰€æœ‰çº¿ç¨‹å¯è§

void* increment_thread(void* arg) {
    for (int i = 0; i < 1000; i++) {
        global_counter++;  // ç›´æ¥è®¿é—®å…±äº«å˜é‡
    }
    return NULL;
}
```

### 6.3 åˆ›å»ºå¼€é”€å¯¹æ¯”


**â±ï¸ æ€§èƒ½å¯¹æ¯”å®æµ‹**
```
è¿›ç¨‹åˆ›å»º(fork)ï¼š
- æ—¶é—´å¼€é”€ï¼š1-10æ¯«ç§’
- å†…å­˜å¼€é”€ï¼šå¤åˆ¶æ•´ä¸ªåœ°å€ç©ºé—´
- ç³»ç»Ÿè°ƒç”¨ï¼šå¤æ‚çš„å†…å­˜ç®¡ç†

çº¿ç¨‹åˆ›å»º(pthread_create)ï¼š
- æ—¶é—´å¼€é”€ï¼š10-100å¾®ç§’  
- å†…å­˜å¼€é”€ï¼šåªåˆ†é…æ ˆç©ºé—´
- ç³»ç»Ÿè°ƒç”¨ï¼šè½»é‡çº§èµ„æºåˆ†é…
```

**ğŸ“ˆ å¼€é”€å¯¹æ¯”å›¾**
```
åˆ›å»ºå¼€é”€(ç›¸å¯¹å€¼):
è¿›ç¨‹ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100x
çº¿ç¨‹ â–ˆâ–ˆâ–ˆ                              3x
```

---

## 7. ğŸ¯ æ€§èƒ½è€ƒè™‘ä¸æœ€ä½³å®è·µ


### 7.1 çº¿ç¨‹åˆ›å»ºå¼€é”€åˆ†æ


**ğŸ’° å¼€é”€ç»„æˆ**
```
ğŸ”¸ ç³»ç»Ÿè°ƒç”¨å¼€é”€ï¼šå†…æ ¸æ€åˆ‡æ¢
ğŸ”¸ æ ˆç©ºé—´åˆ†é…ï¼šé»˜è®¤8MBæ ˆç©ºé—´
ğŸ”¸ çº¿ç¨‹æ§åˆ¶å—ï¼šç»´æŠ¤çº¿ç¨‹çŠ¶æ€ä¿¡æ¯
ğŸ”¸ è°ƒåº¦å™¨æ³¨å†Œï¼šåŠ å…¥ç³»ç»Ÿè°ƒåº¦é˜Ÿåˆ—
```

**ğŸ“Š æ€§èƒ½æµ‹è¯•å‚è€ƒ**
```c
// ç®€å•æ€§èƒ½æµ‹è¯•ä»£ç 
#include <sys/time.h>

double get_time() {
    struct timeval tv;
    gettimeofday(&tv, NULL);
    return tv.tv_sec + tv.tv_usec / 1000000.0;
}

void performance_test() {
    const int thread_count = 1000;
    pthread_t threads[thread_count];
    
    double start = get_time();
    
    // åˆ›å»º1000ä¸ªçº¿ç¨‹
    for (int i = 0; i < thread_count; i++) {
        pthread_create(&threads[i], NULL, simple_task, NULL);
    }
    
    // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ
    for (int i = 0; i < thread_count; i++) {
        pthread_join(threads[i], NULL);
    }
    
    double end = get_time();
    printf("åˆ›å»º%dä¸ªçº¿ç¨‹è€—æ—¶: %.3fç§’\n", thread_count, end - start);
}
```

### 7.2 çº¿ç¨‹æ± ä¼˜åŒ–ç­–ç•¥


**ğŸŠ çº¿ç¨‹æ± çš„ä¼˜åŠ¿**
> ğŸ’¡ **æ ¸å¿ƒæ€æƒ³**ï¼šé¢„å…ˆåˆ›å»ºä¸€æ‰¹çº¿ç¨‹ï¼Œé‡å¤ä½¿ç”¨å®ƒä»¬æ‰§è¡Œä»»åŠ¡ï¼Œé¿å…é¢‘ç¹åˆ›å»ºé”€æ¯çº¿ç¨‹çš„å¼€é”€ã€‚

**âš–ï¸ çº¿ç¨‹æ•°é‡é€‰æ‹©**
```
CPUå¯†é›†å‹ä»»åŠ¡ï¼šçº¿ç¨‹æ•° â‰ˆ CPUæ ¸å¿ƒæ•°
I/Oå¯†é›†å‹ä»»åŠ¡ï¼šçº¿ç¨‹æ•° â‰ˆ 2 Ã— CPUæ ¸å¿ƒæ•°
æ··åˆå‹ä»»åŠ¡ï¼šæ ¹æ®å®é™…æµ‹è¯•è°ƒä¼˜

è®¡ç®—å…¬å¼ï¼š
æœ€ä¼˜çº¿ç¨‹æ•° = CPUæ ¸å¿ƒæ•° Ã— (1 + ç­‰å¾…æ—¶é—´/è®¡ç®—æ—¶é—´)
```

### 7.3 å†…å­˜ä½¿ç”¨ä¼˜åŒ–


**ğŸ“‰ æ ˆç©ºé—´ä¼˜åŒ–**
```c
// é’ˆå¯¹ç®€å•ä»»åŠ¡å‡å°‘æ ˆå¤§å°
pthread_attr_t attr;
pthread_attr_init(&attr);

// è®¾ç½®è¾ƒå°çš„æ ˆ(256KBè€Œä¸æ˜¯é»˜è®¤8MB)
pthread_attr_setstacksize(&attr, 256 * 1024);

pthread_create(&thread, &attr, simple_task, NULL);
```

**ğŸ¯ æœ€ä½³å®è·µå»ºè®®**
```
âœ… åˆç†è®¾ç½®æ ˆå¤§å°ï¼šé¿å…æµªè´¹å†…å­˜
âœ… ä½¿ç”¨çº¿ç¨‹æ± ï¼šå‡å°‘åˆ›å»ºé”€æ¯å¼€é”€  
âœ… é¿å…è¿‡å¤šçº¿ç¨‹ï¼šé˜²æ­¢ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€
âœ… åŠæ—¶å›æ”¶èµ„æºï¼šä½¿ç”¨joinæˆ–detach
âš ï¸ æ³¨æ„å…±äº«æ•°æ®åŒæ­¥ï¼šé˜²æ­¢ç«æ€æ¡ä»¶
```

---

## 8. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 8.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ”¸ çº¿ç¨‹æœ¬è´¨ï¼šè¿›ç¨‹å†…çš„å¹¶å‘æ‰§è¡Œå•å…ƒï¼Œå…±äº«è¿›ç¨‹èµ„æº
ğŸ”¸ åˆ›å»ºå‡½æ•°ï¼špthread_create()åˆ›å»ºçº¿ç¨‹ï¼Œè®¾ç½®æ‰§è¡Œå‡½æ•°å’Œå‚æ•°
ğŸ”¸ ç»ˆæ­¢æ–¹å¼ï¼špthread_exit()æ­£å¸¸é€€å‡ºï¼Œè¿”å›å€¼å¯è¢«å…¶ä»–çº¿ç¨‹è·å–
ğŸ”¸ å›æ”¶æœºåˆ¶ï¼špthread_join()ç­‰å¾…å¹¶å›æ”¶ï¼Œpthread_detach()è‡ªåŠ¨å›æ”¶
ğŸ”¸ çº¿ç¨‹æ ‡è¯†ï¼špthread_self()è·å–IDï¼Œpthread_equal()æ¯”è¾ƒID
ğŸ”¸ å±æ€§é…ç½®ï¼špthread_attr_tè®¾ç½®æ ˆå¤§å°ã€åˆ†ç¦»çŠ¶æ€ç­‰å±æ€§
```

### 8.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ çº¿ç¨‹ vs è¿›ç¨‹çš„æœ¬è´¨åŒºåˆ«**
```
èµ„æºè§’åº¦ï¼š
- è¿›ç¨‹ï¼šç‹¬ç«‹çš„èµ„æºå®¹å™¨ï¼Œå®‰å…¨éš”ç¦»
- çº¿ç¨‹ï¼šå…±äº«èµ„æºçš„æ‰§è¡Œå•å…ƒï¼Œè½»é‡é«˜æ•ˆ

é€šä¿¡è§’åº¦ï¼š
- è¿›ç¨‹ï¼šéœ€è¦ä¸“é—¨çš„IPCæœºåˆ¶
- çº¿ç¨‹ï¼šç›´æ¥è®¿é—®å…±äº«å†…å­˜ï¼Œä½†éœ€è¦åŒæ­¥

æ€§èƒ½è§’åº¦ï¼š
- è¿›ç¨‹ï¼šåˆ›å»ºæ…¢ä½†å®‰å…¨
- çº¿ç¨‹ï¼šåˆ›å»ºå¿«ä½†éœ€è¦æ³¨æ„æ•°æ®ç«äº‰
```

**ğŸ”¹ ä½•æ—¶ä½¿ç”¨join vs detach**
```
ä½¿ç”¨pthread_join()ï¼š
âœ… éœ€è¦è·å–çº¿ç¨‹è¿”å›å€¼
âœ… éœ€è¦ç¡®ä¿çº¿ç¨‹å®Œæˆå†ç»§ç»­
âœ… éœ€è¦åŒæ­¥å¤šä¸ªçº¿ç¨‹çš„æ‰§è¡Œ

ä½¿ç”¨pthread_detach()ï¼š
âœ… åå°ä»»åŠ¡ï¼Œä¸å…³å¿ƒå®Œæˆæ—¶é—´
âœ… ä¸éœ€è¦çº¿ç¨‹è¿”å›å€¼
âœ… é¿å…å†…å­˜æ³„æ¼ï¼ˆå¿˜è®°joinçš„æƒ…å†µï¼‰
```

**ğŸ”¹ çº¿ç¨‹å±æ€§è®¾ç½®çš„å®é™…æ„ä¹‰**
```
æ ˆå¤§å°è®¾ç½®ï¼š
- å¤ªå°ï¼šå¯èƒ½æ ˆæº¢å‡º
- å¤ªå¤§ï¼šæµªè´¹å†…å­˜èµ„æº
- åˆé€‚ï¼šæ ¹æ®ä»»åŠ¡éœ€æ±‚è°ƒæ•´

åˆ†ç¦»çŠ¶æ€è®¾ç½®ï¼š
- åˆ›å»ºæ—¶è®¾ç½®ï¼šé¿å…å¿˜è®°detach
- è¿è¡Œæ—¶è®¾ç½®ï¼šçµæ´»æ§åˆ¶å›æ”¶æ–¹å¼
```

### 8.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ“ ç¼–ç¨‹æ³¨æ„äº‹é¡¹**
```
âš ï¸ å‚æ•°ä¼ é€’ï¼š
- é¿å…ä¼ é€’æ ˆå˜é‡åœ°å€
- ä½¿ç”¨mallocåˆ†é…ç¨³å®šå†…å­˜
- æˆ–è€…ä¼ é€’å…¨å±€å˜é‡åœ°å€

âš ï¸ èµ„æºç®¡ç†ï¼š
- æ¯ä¸ªpthread_createå¿…é¡»å¯¹åº”joinæˆ–detach
- åŠæ—¶é”€æ¯çº¿ç¨‹å±æ€§å¯¹è±¡
- é¿å…çº¿ç¨‹èµ„æºæ³„æ¼

âš ï¸ é”™è¯¯å¤„ç†ï¼š
- æ£€æŸ¥æ‰€æœ‰pthreadå‡½æ•°çš„è¿”å›å€¼
- åˆç†å¤„ç†çº¿ç¨‹åˆ›å»ºå¤±è´¥çš„æƒ…å†µ
```

**ğŸ¯ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**
```
ğŸ”¸ çº¿ç¨‹æ•°é‡ï¼šä¸è¦åˆ›å»ºè¿‡å¤šçº¿ç¨‹ï¼Œä¸€èˆ¬ä¸è¶…è¿‡CPUæ ¸å¿ƒæ•°çš„2-4å€
ğŸ”¸ æ ˆå¤§å°ï¼šæ ¹æ®ä»»åŠ¡ç‰¹ç‚¹åˆç†è®¾ç½®ï¼Œé¿å…é»˜è®¤çš„8MBæµªè´¹
ğŸ”¸ çº¿ç¨‹æ± ï¼šå¯¹äºé¢‘ç¹çš„çŸ­ä»»åŠ¡ï¼Œä½¿ç”¨çº¿ç¨‹æ± å‡å°‘åˆ›å»ºå¼€é”€
ğŸ”¸ äº²å’Œæ€§ï¼šå¯¹äºCPUå¯†é›†å‹ä»»åŠ¡ï¼Œè€ƒè™‘è®¾ç½®CPUäº²å’Œæ€§
```

**æ ¸å¿ƒè®°å¿†**ï¼š
- pthread_createåˆ›å»ºçº¿ç¨‹ï¼ŒæŒ‡å®šå‡½æ•°å’Œå‚æ•°
- pthread_joinç­‰å¾…å›æ”¶ï¼Œpthread_detachè‡ªåŠ¨æ¸…ç†
- çº¿ç¨‹å…±äº«è¿›ç¨‹èµ„æºï¼Œä½†æ‹¥æœ‰ç‹¬ç«‹çš„æ ˆç©ºé—´
- åˆç†è®¾ç½®çº¿ç¨‹å±æ€§ï¼Œä¼˜åŒ–å†…å­˜å’Œæ€§èƒ½è¡¨ç°