---
title: 10ã€Linux CDNèŠ‚ç‚¹æ­å»º
---
## ğŸ“š ç›®å½•

1. [CDNåŸºç¡€æ¦‚å¿µä¸æ¶æ„](#1-CDNåŸºç¡€æ¦‚å¿µä¸æ¶æ„)
2. [Nginx CDNèŠ‚ç‚¹é…ç½®](#2-Nginx-CDNèŠ‚ç‚¹é…ç½®)
3. [Apache CDNæœåŠ¡é…ç½®](#3-Apache-CDNæœåŠ¡é…ç½®)
4. [Varnishç¼“å­˜æœåŠ¡å™¨éƒ¨ç½²](#4-Varnishç¼“å­˜æœåŠ¡å™¨éƒ¨ç½²)
5. [Squidæ­£å‘ä»£ç†é…ç½®](#5-Squidæ­£å‘ä»£ç†é…ç½®)
6. [è´Ÿè½½å‡è¡¡å™¨é…ç½®](#6-è´Ÿè½½å‡è¡¡å™¨é…ç½®)
7. [æ–‡ä»¶ç³»ç»Ÿä¼˜åŒ–é…ç½®](#7-æ–‡ä»¶ç³»ç»Ÿä¼˜åŒ–é…ç½®)
8. [ç½‘ç»œå‚æ•°è°ƒä¼˜](#8-ç½‘ç»œå‚æ•°è°ƒä¼˜)
9. [ç³»ç»Ÿç›‘æ§é…ç½®](#9-ç³»ç»Ÿç›‘æ§é…ç½®)
10. [æ—¥å¿—æ”¶é›†ä¸åˆ†æ](#10-æ—¥å¿—æ”¶é›†ä¸åˆ†æ)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸŒ CDNåŸºç¡€æ¦‚å¿µä¸æ¶æ„


### 1.1 ä»€ä¹ˆæ˜¯CDN


**ğŸ”¸ CDNç®€å•ç†è§£**
CDNï¼ˆContent Delivery Networkï¼‰å°±åƒæ˜¯åœ¨å…¨å›½å„åœ°å¼€è®¾çš„è¿é”åº—ï¼Œç”¨æˆ·å¯ä»¥å°±è¿‘è·å–æœåŠ¡ï¼Œè€Œä¸ç”¨è·‘åˆ°æ€»éƒ¨å»ã€‚

```
ä¼ ç»Ÿè®¿é—®æ¨¡å¼ï¼š
ç”¨æˆ·ï¼ˆåŒ—äº¬ï¼‰ -------- 2000å…¬é‡Œ --------â†’ æœåŠ¡å™¨ï¼ˆå¹¿å·ï¼‰
å»¶è¿Ÿï¼š200msï¼Œé€Ÿåº¦æ…¢

CDNæ¨¡å¼ï¼š
ç”¨æˆ·ï¼ˆåŒ—äº¬ï¼‰ --- 50å…¬é‡Œ --â†’ CDNèŠ‚ç‚¹ï¼ˆåŒ—äº¬ï¼‰ --- å†…ç½‘ --â†’ æºæœåŠ¡å™¨ï¼ˆå¹¿å·ï¼‰
å»¶è¿Ÿï¼š20msï¼Œé€Ÿåº¦å¿«
```

**ğŸ”¸ CDNçš„å·¥ä½œåŸç†**
- **å°±è¿‘æœåŠ¡**ï¼šç”¨æˆ·è®¿é—®ç¦»è‡ªå·±æœ€è¿‘çš„CDNèŠ‚ç‚¹
- **ç¼“å­˜æœºåˆ¶**ï¼šçƒ­é—¨å†…å®¹æå‰å­˜å‚¨åœ¨å„ä¸ªèŠ‚ç‚¹
- **æ™ºèƒ½è°ƒåº¦**ï¼šDNSè‡ªåŠ¨åˆ†é…æœ€ä¼˜èŠ‚ç‚¹
- **å›æºæœºåˆ¶**ï¼šç¼“å­˜å¤±æ•ˆæ—¶ä»æºæœåŠ¡å™¨è·å–

### 1.2 CDNæ¶æ„ç»„æˆ


**ğŸ—ï¸ å…¸å‹CDNæ¶æ„å›¾**
```
                    ğŸ“ ç”¨æˆ·è¯·æ±‚
                         â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚          æ™ºèƒ½DNSè°ƒåº¦ç³»ç»Ÿ              â”‚ â† é€‰æ‹©æœ€ä½³èŠ‚ç‚¹
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ è¾¹ç¼˜èŠ‚ç‚¹  â”‚  â”‚ è¾¹ç¼˜èŠ‚ç‚¹  â”‚  â”‚ è¾¹ç¼˜èŠ‚ç‚¹  â”‚ â† å°±è¿‘æœåŠ¡
         â”‚ (åŒ—äº¬)   â”‚  â”‚ (ä¸Šæµ·)   â”‚  â”‚ (å¹¿å·)   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†‘
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚   ä¸­å¿ƒæºæœåŠ¡å™¨     â”‚ â† å†…å®¹æºå¤´
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ğŸ”¸ æ ¸å¿ƒç»„ä»¶è¯´æ˜**
- **è¾¹ç¼˜èŠ‚ç‚¹**ï¼šéƒ¨ç½²åœ¨ç”¨æˆ·é™„è¿‘ï¼Œç›´æ¥æä¾›æœåŠ¡
- **ä¸­å¿ƒèŠ‚ç‚¹**ï¼šå­˜å‚¨å®Œæ•´å†…å®¹ï¼Œè´Ÿè´£å†…å®¹åˆ†å‘
- **è°ƒåº¦ç³»ç»Ÿ**ï¼šæ™ºèƒ½é€‰æ‹©æœ€ä¼˜èŠ‚ç‚¹
- **ç›‘æ§ç³»ç»Ÿ**ï¼šå®æ—¶ç›‘æ§èŠ‚ç‚¹çŠ¶æ€

### 1.3 Linuxç¯å¢ƒä¸‹CDNéƒ¨ç½²å‡†å¤‡


**ğŸ“‹ ç³»ç»Ÿè¦æ±‚**
- **æ“ä½œç³»ç»Ÿ**ï¼šCentOS 7/8ã€Ubuntu 18.04+
- **ç¡¬ä»¶é…ç½®**ï¼š4æ ¸8Gå†…å­˜èµ·æ­¥ï¼Œå­˜å‚¨æ ¹æ®éœ€æ±‚
- **ç½‘ç»œå¸¦å®½**ï¼šåƒå…†ç½‘å¡ï¼Œå……è¶³å¸¦å®½
- **å­˜å‚¨ç©ºé—´**ï¼šSSDä¼˜å…ˆï¼Œç©ºé—´éœ€æ±‚çœ‹ç¼“å­˜ç­–ç•¥

**ğŸ”§ åŸºç¡€ç¯å¢ƒå‡†å¤‡**
```bash
# ç³»ç»Ÿæ›´æ–°
yum update -y  # CentOS
apt update && apt upgrade -y  # Ubuntu

# å…³é—­é˜²ç«å¢™å’ŒSELinuxï¼ˆæ ¹æ®éœ€è¦ï¼‰
systemctl stop firewalld
systemctl disable firewalld
setenforce 0

# å®‰è£…åŸºç¡€å·¥å…·
yum install -y wget curl vim net-tools
```

---

## 2. âš™ï¸ Nginx CDNèŠ‚ç‚¹é…ç½®


### 2.1 Nginxå®‰è£…ä¸åŸºç¡€é…ç½®


**ğŸ”¸ ä¸ºä»€ä¹ˆé€‰æ‹©Nginx**
Nginxæ˜¯æœ€æµè¡Œçš„CDNæœåŠ¡å™¨è½¯ä»¶ï¼Œå› ä¸ºå®ƒï¼š
- **é«˜å¹¶å‘**ï¼šèƒ½å¤„ç†æ•°ä¸‡å¹¶å‘è¿æ¥
- **ä½å†…å­˜**ï¼šå†…å­˜å ç”¨æå°‘
- **é«˜æ€§èƒ½**ï¼šå¤„ç†é™æ€æ–‡ä»¶é€Ÿåº¦å¿«
- **é…ç½®çµæ´»**ï¼šæ”¯æŒå„ç§ç¼“å­˜ç­–ç•¥

**ğŸ› ï¸ Nginxå®‰è£…**
```bash
# å®‰è£…Nginx
yum install -y nginx  # CentOS
apt install -y nginx  # Ubuntu

# å¯åŠ¨Nginx
systemctl start nginx
systemctl enable nginx
```

### 2.2 CDNæ ¸å¿ƒé…ç½®


**ğŸ”§ ä¸»é…ç½®æ–‡ä»¶ä¼˜åŒ–**
```nginx
# /etc/nginx/nginx.conf
user nginx;
worker_processes auto;  # è‡ªåŠ¨åŒ¹é…CPUæ ¸æ•°
error_log /var/log/nginx/error.log;

events {
    worker_connections 10240;  # æ¯ä¸ªè¿›ç¨‹æœ€å¤§è¿æ¥æ•°
    use epoll;                 # ä½¿ç”¨é«˜æ•ˆäº‹ä»¶æ¨¡å‹
    multi_accept on;           # ä¸€æ¬¡æ¥å—å¤šä¸ªè¿æ¥
}

http {
    # åŸºç¡€è®¾ç½®
    sendfile on;                    # é«˜æ•ˆæ–‡ä»¶ä¼ è¾“
    tcp_nopush on;                 # ä¼˜åŒ–æ•°æ®åŒ…ä¼ è¾“
    tcp_nodelay on;                # å‡å°‘å»¶è¿Ÿ
    keepalive_timeout 65;          # è¿æ¥ä¿æŒæ—¶é—´
    
    # ç¼“å­˜è®¾ç½®
    proxy_cache_path /var/cache/nginx/proxy_temp 
        levels=1:2 
        keys_zone=cache_zone:100m 
        max_size=10g 
        inactive=7d;
        
    include /etc/nginx/conf.d/*.conf;
}
```

**ğŸ”¸ é…ç½®è¯´æ˜**
- **worker_processes auto**ï¼šè®©Nginxè‡ªåŠ¨æ£€æµ‹CPUæ ¸æ•°
- **worker_connections 10240**ï¼šå•ä¸ªè¿›ç¨‹æœ€å¤§è¿æ¥æ•°
- **proxy_cache_path**ï¼šè®¾ç½®ç¼“å­˜ç›®å½•å’Œè§„åˆ™

### 2.3 CDNè™šæ‹Ÿä¸»æœºé…ç½®


**ğŸ“ CDNç«™ç‚¹é…ç½®ç¤ºä¾‹**
```nginx
# /etc/nginx/conf.d/cdn.conf
server {
    listen 80;
    server_name cdn.example.com;
    
    # æ—¥å¿—é…ç½®
    access_log /var/log/nginx/cdn_access.log combined;
    error_log /var/log/nginx/cdn_error.log;
    
    # é™æ€æ–‡ä»¶ç¼“å­˜
    location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
        # è®¾ç½®æºæœåŠ¡å™¨
        proxy_pass http://origin_server;
        
        # ç¼“å­˜é…ç½®
        proxy_cache cache_zone;
        proxy_cache_valid 200 304 7d;    # æˆåŠŸå“åº”ç¼“å­˜7å¤©
        proxy_cache_valid any 1h;        # å…¶ä»–å“åº”ç¼“å­˜1å°æ—¶
        
        # ç¼“å­˜å¤´è®¾ç½®
        proxy_cache_use_stale error timeout updating;
        add_header X-Cache-Status $upstream_cache_status;
        
        # è¿‡æœŸæ—¶é—´
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
    
    # åŠ¨æ€å†…å®¹ä¸ç¼“å­˜
    location / {
        proxy_pass http://origin_server;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}

# æºæœåŠ¡å™¨é…ç½®
upstream origin_server {
    server 192.168.1.100:80 weight=1 max_fails=3 fail_timeout=30s;
    server 192.168.1.101:80 weight=1 max_fails=3 fail_timeout=30s;
}
```

**ğŸ”¸ å…³é”®é…ç½®è§£é‡Š**
- **proxy_cache_valid**ï¼šè®¾ç½®ä¸åŒçŠ¶æ€ç çš„ç¼“å­˜æ—¶é—´
- **proxy_cache_use_stale**ï¼šæºæœåŠ¡å™¨å¼‚å¸¸æ—¶ä½¿ç”¨æ—§ç¼“å­˜
- **expires 30d**ï¼šå‘Šè¯‰æµè§ˆå™¨ç¼“å­˜30å¤©
- **upstream**ï¼šé…ç½®åç«¯æœåŠ¡å™¨ç¾¤

### 2.4 ç¼“å­˜ç®¡ç†ä¸æ¸…ç†


**ğŸ§¹ ç¼“å­˜æ¸…ç†è„šæœ¬**
```bash
#!/bin/bash
# /usr/local/bin/clear_cache.sh

# æ¸…ç†ç‰¹å®šURLç¼“å­˜
clear_url_cache() {
    local url=$1
    local cache_key=$(echo -n "$url" | md5sum | cut -d' ' -f1)
    local cache_path="/var/cache/nginx/proxy_temp"
    
    # æŸ¥æ‰¾å¹¶åˆ é™¤ç¼“å­˜æ–‡ä»¶
    find $cache_path -name "*$cache_key*" -delete
    echo "å·²æ¸…ç† $url çš„ç¼“å­˜"
}

# æ¸…ç†è¿‡æœŸç¼“å­˜
clear_expired_cache() {
    find /var/cache/nginx/proxy_temp -type f -mtime +7 -delete
    echo "å·²æ¸…ç†7å¤©å‰çš„è¿‡æœŸç¼“å­˜"
}

# ä½¿ç”¨ç¤ºä¾‹
clear_url_cache "http://cdn.example.com/style.css"
clear_expired_cache
```

---

## 3. ğŸŒ Apache CDNæœåŠ¡é…ç½®


### 3.1 Apache CDNé…ç½®åŸºç¡€


**ğŸ”¸ Apacheä½œä¸ºCDNçš„ç‰¹ç‚¹**
è™½ç„¶Nginxæ›´å¸¸ç”¨ï¼Œä½†Apacheåœ¨æŸäº›åœºæ™¯ä¸‹ä¹Ÿå¾ˆæœ‰ç”¨ï¼š
- **æ¨¡å—ä¸°å¯Œ**ï¼šæœ‰å¤§é‡ç°æˆæ¨¡å—
- **é…ç½®ç†Ÿæ‚‰**ï¼šå¾ˆå¤šè¿ç»´äººå‘˜ç†Ÿæ‚‰Apache
- **å…¼å®¹æ€§å¥½**ï¼šå¯¹è€ç³»ç»Ÿå…¼å®¹æ€§æ›´å¥½

**ğŸ› ï¸ Apacheå®‰è£…ä¸æ¨¡å—é…ç½®**
```bash
# å®‰è£…Apache
yum install -y httpd  # CentOS
apt install -y apache2  # Ubuntu

# å¯ç”¨å¿…éœ€æ¨¡å—
a2enmod proxy
a2enmod proxy_http
a2enmod cache
a2enmod cache_disk
a2enmod headers
a2enmod expires
```

### 3.2 Apache CDNè™šæ‹Ÿä¸»æœºé…ç½®


**ğŸ“ Apache CDNé…ç½®ç¤ºä¾‹**
```apache
# /etc/httpd/conf.d/cdn.conf æˆ– /etc/apache2/sites-available/cdn.conf

<VirtualHost *:80>
    ServerName cdn.example.com
    DocumentRoot /var/www/cdn
    
    # å¯ç”¨ç¼“å­˜
    CacheEnable disk /
    CacheRoot /var/cache/apache2/mod_cache_disk
    CacheDirLevels 2
    CacheDirLength 1
    CacheMaxFileSize 10000000
    
    # é™æ€æ–‡ä»¶ç¼“å­˜é…ç½®
    <LocationMatch "\.(css|js|png|jpg|jpeg|gif|ico)$">
        # ä»£ç†åˆ°æºæœåŠ¡å™¨
        ProxyPass http://192.168.1.100:80/
        ProxyPassReverse http://192.168.1.100:80/
        
        # è®¾ç½®ç¼“å­˜å¤´
        ExpiresActive On
        ExpiresDefault "access plus 30 days"
        Header append Cache-Control "public"
        
        # ç¼“å­˜è®¾ç½®
        CacheEnable disk
        CacheDefaultExpire 2592000  # 30å¤©
    </LocationMatch>
    
    # åŠ¨æ€å†…å®¹ä¸ç¼“å­˜
    <Location />
        ProxyPass http://192.168.1.100:80/
        ProxyPassReverse http://192.168.1.100:80/
        ProxyPreserveHost On
        
        # è®¾ç½®è¯·æ±‚å¤´
        ProxyAddHeaders On
        Header set X-Forwarded-Proto "http"
    </Location>
    
    # æ—¥å¿—é…ç½®
    ErrorLog logs/cdn_error.log
    CustomLog logs/cdn_access.log combined
</VirtualHost>
```

**ğŸ”¸ é…ç½®è¯´æ˜**
- **CacheEnable disk**ï¼šå¯ç”¨ç£ç›˜ç¼“å­˜
- **CacheRoot**ï¼šæŒ‡å®šç¼“å­˜å­˜å‚¨ç›®å½•
- **ExpiresDefault**ï¼šè®¾ç½®é»˜è®¤è¿‡æœŸæ—¶é—´
- **ProxyPreserveHost**ï¼šä¿æŒåŸå§‹Hostå¤´

---

## 4. âš¡ Varnishç¼“å­˜æœåŠ¡å™¨éƒ¨ç½²


### 4.1 ä»€ä¹ˆæ˜¯Varnish


**ğŸ”¸ Varnishç®€å•ç†è§£**
Varnishæ˜¯ä¸“é—¨çš„ç¼“å­˜æœåŠ¡å™¨ï¼Œå°±åƒä¸€ä¸ªè¶…çº§æ™ºèƒ½çš„ä»“åº“ç®¡ç†å‘˜ï¼š
- **ä¸“ä¸šç¼“å­˜**ï¼šä¸“é—¨ä¸ºç¼“å­˜è€Œç”Ÿï¼Œæ€§èƒ½æé«˜
- **å†…å­˜ç¼“å­˜**ï¼šä¸»è¦ä½¿ç”¨å†…å­˜ï¼Œé€Ÿåº¦æå¿«
- **çµæ´»è§„åˆ™**ï¼šå¯ä»¥ç”¨VCLè¯­è¨€å®šåˆ¶ç¼“å­˜è§„åˆ™

**ğŸ“Š Varnish vs Nginxç¼“å­˜å¯¹æ¯”**

| ç‰¹æ€§ | **Varnish** | **Nginx** |
|------|-------------|-----------|
| **ç¼“å­˜æ€§èƒ½** | `æé«˜ï¼Œä¸“ä¸šç¼“å­˜` | `é«˜ï¼Œé€šç”¨æœåŠ¡å™¨` |
| **å†…å­˜ä½¿ç”¨** | `ä¸»è¦ç”¨å†…å­˜` | `ä¸»è¦ç”¨ç£ç›˜` |
| **é…ç½®å¤æ‚åº¦** | `è¾ƒå¤æ‚ï¼ŒVCLè¯­è¨€` | `ç®€å•ï¼Œé…ç½®æ–‡ä»¶` |
| **åŠŸèƒ½ä¸“ä¸€æ€§** | `ä¸“é—¨ç¼“å­˜` | `å¤šåŠŸèƒ½æœåŠ¡å™¨` |

### 4.2 Varnishå®‰è£…ä¸é…ç½®


**ğŸ› ï¸ Varnishå®‰è£…**
```bash
# CentOSå®‰è£…
yum install -y epel-release
yum install -y varnish

# Ubuntuå®‰è£…
apt install -y varnish

# å¯åŠ¨æœåŠ¡
systemctl start varnish
systemctl enable varnish
```

**ğŸ”§ åŸºç¡€é…ç½®æ–‡ä»¶**
```bash
# /etc/varnish/default.vcl
vcl 4.0;

# å®šä¹‰åç«¯æœåŠ¡å™¨
backend default {
    .host = "192.168.1.100";
    .port = "80";
    .connect_timeout = 60s;
    .first_byte_timeout = 60s;
    .between_bytes_timeout = 60s;
}

# æ¥æ”¶è¯·æ±‚æ—¶çš„å¤„ç†
sub vcl_recv {
    # åªç¼“å­˜GETå’ŒHEADè¯·æ±‚
    if (req.method != "GET" && req.method != "HEAD") {
        return (pass);
    }
    
    # å¸¦Cookieçš„è¯·æ±‚ä¸ç¼“å­˜
    if (req.http.Authorization || req.http.Cookie) {
        return (pass);
    }
    
    # æ¸…ç†è¯·æ±‚å¤´
    unset req.http.Cookie;
    return (hash);
}

# ä»åç«¯è·å–å“åº”æ—¶çš„å¤„ç†
sub vcl_backend_response {
    # é™æ€æ–‡ä»¶ç¼“å­˜æ—¶é—´
    if (bereq.url ~ "\.(css|js|png|jpg|jpeg|gif|ico)$") {
        set beresp.ttl = 7d;
        set beresp.http.Cache-Control = "public, max-age=604800";
    }
    
    # HTMLæ–‡ä»¶çŸ­ç¼“å­˜
    if (beresp.http.content-type ~ "text/html") {
        set beresp.ttl = 5m;
    }
    
    return (deliver);
}

# å‘é€ç»™å®¢æˆ·ç«¯æ—¶çš„å¤„ç†
sub vcl_deliver {
    # æ·»åŠ ç¼“å­˜çŠ¶æ€å¤´
    if (obj.hits > 0) {
        set resp.http.X-Cache = "HIT";
    } else {
        set resp.http.X-Cache = "MISS";
    }
    
    # æ·»åŠ å‘½ä¸­æ¬¡æ•°
    set resp.http.X-Cache-Hits = obj.hits;
    
    return (deliver);
}
```

**ğŸ”¸ VCLé…ç½®è§£é‡Š**
- **vcl_recv**ï¼šå¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼Œå†³å®šç¼“å­˜ç­–ç•¥
- **vcl_backend_response**ï¼šå¤„ç†åç«¯å“åº”ï¼Œè®¾ç½®ç¼“å­˜æ—¶é—´
- **vcl_deliver**ï¼šå¤„ç†è¿”å›ç»™å®¢æˆ·ç«¯çš„å“åº”
- **beresp.ttl**ï¼šè®¾ç½®ç¼“å­˜ç”Ÿå­˜æ—¶é—´

### 4.3 Varnishæ€§èƒ½è°ƒä¼˜


**âš™ï¸ æœåŠ¡é…ç½®ä¼˜åŒ–**
```bash
# /etc/systemd/system/varnish.service.d/override.conf
[Service]
ExecStart=
ExecStart=/usr/sbin/varnishd \
    -a :80 \
    -T localhost:6082 \
    -f /etc/varnish/default.vcl \
    -S /etc/varnish/secret \
    -s malloc,2G \
    -p thread_pool_min=100 \
    -p thread_pool_max=5000 \
    -p thread_pool_timeout=300
```

**ğŸ”¸ å‚æ•°è¯´æ˜**
- **-s malloc,2G**ï¼šä½¿ç”¨2GBå†…å­˜ä½œä¸ºç¼“å­˜
- **thread_pool_min**ï¼šæœ€å°çº¿ç¨‹æ•°
- **thread_pool_max**ï¼šæœ€å¤§çº¿ç¨‹æ•°
- **thread_pool_timeout**ï¼šçº¿ç¨‹è¶…æ—¶æ—¶é—´

---

## 5. ğŸ”„ Squidæ­£å‘ä»£ç†é…ç½®


### 5.1 Squidä»£ç†åŸºç¡€æ¦‚å¿µ


**ğŸ”¸ æ­£å‘ä»£ç†çš„ä½œç”¨**
æ­£å‘ä»£ç†å°±åƒæ˜¯ç”¨æˆ·çš„"ä»£ç†äºº"ï¼Œæ›¿ç”¨æˆ·å»è·å–å†…å®¹ï¼š
- **è®¿é—®æ§åˆ¶**ï¼šé™åˆ¶ç”¨æˆ·è®¿é—®ç‰¹å®šç½‘ç«™
- **ç¼“å­˜åŠ é€Ÿ**ï¼šç¼“å­˜å¸¸ç”¨å†…å®¹ï¼Œæé«˜è®¿é—®é€Ÿåº¦
- **å¸¦å®½èŠ‚çœ**ï¼šå‡å°‘é‡å¤ä¸‹è½½
- **è®¿é—®è®°å½•**ï¼šè®°å½•ç”¨æˆ·è®¿é—®è¡Œä¸º

**ğŸ“‹ ä»£ç†å·¥ä½œæµç¨‹**
```
ç”¨æˆ· â†’ Squidä»£ç† â†’ äº’è”ç½‘
     â†           â†
   ç¼“å­˜çš„å†…å®¹ä»ä»£ç†ç›´æ¥è¿”å›
   æ–°å†…å®¹ä»äº’è”ç½‘è·å–å¹¶ç¼“å­˜
```

### 5.2 Squidå®‰è£…ä¸åŸºç¡€é…ç½®


**ğŸ› ï¸ Squidå®‰è£…**
```bash
# å®‰è£…Squid
yum install -y squid  # CentOS
apt install -y squid  # Ubuntu

# å¯åŠ¨æœåŠ¡
systemctl start squid
systemctl enable squid
```

**ğŸ”§ åŸºç¡€é…ç½®æ–‡ä»¶**
```bash
# /etc/squid/squid.conf

# ç›‘å¬ç«¯å£
http_port 3128

# ç¼“å­˜ç›®å½•è®¾ç½®
cache_dir ufs /var/spool/squid 10000 16 256

# å†…å­˜ç¼“å­˜è®¾ç½®
cache_mem 1024 MB
maximum_object_size_in_memory 512 KB

# è®¿é—®æ§åˆ¶åˆ—è¡¨
acl localnet src 192.168.1.0/24
acl Safe_ports port 80 443 8080
acl CONNECT method CONNECT

# è®¿é—®è§„åˆ™
http_access allow localnet
http_access allow Safe_ports
http_access deny CONNECT !Safe_ports
http_access deny all

# ç¼“å­˜è§„åˆ™
refresh_pattern ^ftp:   1440    20%     10080
refresh_pattern ^gopher:    1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .       0       20%     4320

# æ—¥å¿—è®¾ç½®
access_log /var/log/squid/access.log squid
cache_log /var/log/squid/cache.log
```

**ğŸ”¸ é…ç½®è¯´æ˜**
- **cache_dir**ï¼šè®¾ç½®ç¼“å­˜ç›®å½•å’Œå¤§å°
- **cache_mem**ï¼šè®¾ç½®å†…å­˜ç¼“å­˜å¤§å°
- **acl**ï¼šå®šä¹‰è®¿é—®æ§åˆ¶åˆ—è¡¨
- **refresh_pattern**ï¼šè®¾ç½®ç¼“å­˜åˆ·æ–°è§„åˆ™

### 5.3 Squidç¼“å­˜ä¼˜åŒ–


**âš¡ æ€§èƒ½ä¼˜åŒ–é…ç½®**
```bash
# æ·»åŠ åˆ° /etc/squid/squid.conf

# å¹¶å‘è¿æ¥æ•°ä¼˜åŒ–
workers 4
max_filedescriptors 65536

# å†…å­˜ä¼˜åŒ–
memory_pools on
memory_pools_limit 512 MB

# ç£ç›˜I/Oä¼˜åŒ–
cache_dir aufs /var/spool/squid 20000 64 256
cache_store_log none

# ç½‘ç»œä¼˜åŒ–
tcp_recv_bufsize 65536 bytes
read_ahead_gap 1 MB
```

---

## 6. âš–ï¸ è´Ÿè½½å‡è¡¡å™¨é…ç½®


### 6.1 HAProxyè´Ÿè½½å‡è¡¡é…ç½®


**ğŸ”¸ ä¸ºä»€ä¹ˆéœ€è¦è´Ÿè½½å‡è¡¡**
å½“ä¸€å°CDNèŠ‚ç‚¹ä¸å¤Ÿç”¨æ—¶ï¼Œå°±éœ€è¦å¤šå°æœåŠ¡å™¨ååŒå·¥ä½œï¼š
- **åˆ†æ•£å‹åŠ›**ï¼šå¤šå°æœåŠ¡å™¨åˆ†æ‹…è®¿é—®å‹åŠ›
- **æé«˜å¯é æ€§**ï¼šä¸€å°æ•…éšœä¸å½±å“æ•´ä½“æœåŠ¡
- **åŠ¨æ€æ‰©å±•**ï¼šå¯ä»¥éšæ—¶å¢åŠ æœåŠ¡å™¨

**ğŸ› ï¸ HAProxyå®‰è£…ä¸é…ç½®**
```bash
# å®‰è£…HAProxy
yum install -y haproxy  # CentOS
apt install -y haproxy  # Ubuntu
```

**ğŸ”§ HAProxyé…ç½®ç¤ºä¾‹**
```bash
# /etc/haproxy/haproxy.cfg

global
    daemon
    maxconn 4096
    log 127.0.0.1:514 local0
    
defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    option httplog

# å‰ç«¯é…ç½®
frontend cdn_frontend
    bind *:80
    default_backend cdn_servers
    
    # æ ¹æ®æ–‡ä»¶ç±»å‹åˆ†å‘
    acl is_static path_end .css .js .png .jpg .jpeg .gif .ico
    use_backend static_servers if is_static

# åç«¯æœåŠ¡å™¨ç»„
backend cdn_servers
    balance roundrobin
    option httpchk GET /health
    
    server cdn1 192.168.1.101:80 check
    server cdn2 192.168.1.102:80 check
    server cdn3 192.168.1.103:80 check

# é™æ€æ–‡ä»¶æœåŠ¡å™¨ç»„
backend static_servers
    balance leastconn
    option httpchk GET /ping
    
    server static1 192.168.1.201:80 check
    server static2 192.168.1.202:80 check

# ç›‘æ§é¡µé¢
listen stats
    bind *:8080
    stats enable
    stats uri /stats
    stats refresh 5s
```

**ğŸ”¸ é…ç½®è¯´æ˜**
- **balance roundrobin**ï¼šè½®è¯¢ç®—æ³•åˆ†å‘è¯·æ±‚
- **option httpchk**ï¼šå¥åº·æ£€æŸ¥é…ç½®
- **acl is_static**ï¼šå®šä¹‰é™æ€æ–‡ä»¶è§„åˆ™
- **stats**ï¼šå¯ç”¨ç›‘æ§é¡µé¢

### 6.2 LVSé…ç½®åŸºç¡€


**ğŸ”¸ LVSç®€å•ç†è§£**
LVSï¼ˆLinux Virtual Serverï¼‰æ˜¯Linuxå†…æ ¸çº§åˆ«çš„è´Ÿè½½å‡è¡¡å™¨ï¼š
- **æ€§èƒ½æé«˜**ï¼šå·¥ä½œåœ¨å†…æ ¸æ€ï¼Œæ€§èƒ½æœ€å¥½
- **é€æ˜ä»£ç†**ï¼šå¯¹å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨éƒ½é€æ˜
- **å·¥ä½œæ¨¡å¼å¤š**ï¼šNATã€DRã€TUNä¸‰ç§æ¨¡å¼

**ğŸ› ï¸ LVSåŸºç¡€é…ç½®**
```bash
# å®‰è£…ipvsadmå·¥å…·
yum install -y ipvsadm

# åˆ›å»ºè™šæ‹ŸæœåŠ¡
ipvsadm -A -t 192.168.1.100:80 -s rr

# æ·»åŠ çœŸå®æœåŠ¡å™¨
ipvsadm -a -t 192.168.1.100:80 -r 192.168.1.101:80 -m
ipvsadm -a -t 192.168.1.100:80 -r 192.168.1.102:80 -m
ipvsadm -a -t 192.168.1.100:80 -r 192.168.1.103:80 -m

# æŸ¥çœ‹é…ç½®
ipvsadm -ln
```

**ğŸ”¸ å‚æ•°è¯´æ˜**
- **-A**ï¼šæ·»åŠ è™šæ‹ŸæœåŠ¡
- **-t**ï¼šTCPæœåŠ¡
- **-s rr**ï¼šè½®è¯¢è°ƒåº¦ç®—æ³•
- **-r**ï¼šçœŸå®æœåŠ¡å™¨
- **-m**ï¼šNATæ¨¡å¼

---

## 7. ğŸ’¾ æ–‡ä»¶ç³»ç»Ÿä¼˜åŒ–é…ç½®


### 7.1 æ–‡ä»¶ç³»ç»Ÿé€‰æ‹©ä¸ä¼˜åŒ–


**ğŸ”¸ CDNå­˜å‚¨éœ€æ±‚åˆ†æ**
CDNèŠ‚ç‚¹éœ€è¦å­˜å‚¨å¤§é‡å°æ–‡ä»¶ï¼Œå¯¹æ–‡ä»¶ç³»ç»Ÿæœ‰ç‰¹æ®Šè¦æ±‚ï¼š
- **å¤§é‡å°æ–‡ä»¶**ï¼šéœ€è¦é«˜æ•ˆçš„æ–‡ä»¶ç´¢å¼•
- **è¯»å¤šå†™å°‘**ï¼šä¼˜åŒ–è¯»å–æ€§èƒ½
- **å¿«é€ŸæŸ¥æ‰¾**ï¼šéœ€è¦å¿«é€Ÿå®šä½æ–‡ä»¶

**ğŸ“Š æ–‡ä»¶ç³»ç»Ÿå¯¹æ¯”**

| æ–‡ä»¶ç³»ç»Ÿ | **é€‚ç”¨åœºæ™¯** | **ä¼˜åŠ¿** | **åŠ£åŠ¿** |
|---------|-------------|----------|----------|
| **ext4** | `é€šç”¨åœºæ™¯` | `ç¨³å®šå¯é ` | `å¤§é‡å°æ–‡ä»¶æ€§èƒ½ä¸€èˆ¬` |
| **XFS** | `å¤§æ–‡ä»¶å­˜å‚¨` | `å¤§æ–‡ä»¶æ€§èƒ½å¥½` | `å°æ–‡ä»¶æ€§èƒ½ä¸€èˆ¬` |
| **Btrfs** | `ç°ä»£éœ€æ±‚` | `åŠŸèƒ½ä¸°å¯Œï¼Œå¿«ç…§` | `ç›¸å¯¹è¾ƒæ–°ï¼Œç¨³å®šæ€§` |

### 7.2 æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ä¼˜åŒ–


**âš™ï¸ ä¼˜åŒ–æŒ‚è½½å‚æ•°**
```bash
# /etc/fstab ä¼˜åŒ–é…ç½®
/dev/sdb1 /var/cache/nginx ext4 defaults,noatime,nodiratime 0 0
```

**ğŸ”¸ æŒ‚è½½å‚æ•°è¯´æ˜**
- **noatime**ï¼šä¸æ›´æ–°æ–‡ä»¶è®¿é—®æ—¶é—´ï¼Œæé«˜æ€§èƒ½
- **nodiratime**ï¼šä¸æ›´æ–°ç›®å½•è®¿é—®æ—¶é—´
- **defaults**ï¼šä½¿ç”¨é»˜è®¤æŒ‚è½½é€‰é¡¹

**ğŸ”§ åˆ›å»ºä¼˜åŒ–çš„æ–‡ä»¶ç³»ç»Ÿ**
```bash
# åˆ›å»ºé’ˆå¯¹CDNä¼˜åŒ–çš„ext4æ–‡ä»¶ç³»ç»Ÿ
mkfs.ext4 -i 1024 -b 4096 -E stride=32,stripe-width=64 /dev/sdb1

# å‚æ•°è¯´æ˜ï¼š
# -i 1024: æ¯1KBåˆ›å»ºä¸€ä¸ªinodeï¼Œé€‚åˆå°æ–‡ä»¶
# -b 4096: å—å¤§å°4KB
# -E: æ‰©å±•é€‰é¡¹ï¼Œä¼˜åŒ–RAIDæ€§èƒ½
```

### 7.3 ç›®å½•ç»“æ„ä¼˜åŒ–


**ğŸ“ CDNç¼“å­˜ç›®å½•ç»“æ„è®¾è®¡**
```bash
# åˆ›å»ºå¤šçº§ç›®å½•ç»“æ„ï¼Œé¿å…å•ä¸ªç›®å½•æ–‡ä»¶è¿‡å¤š
mkdir -p /var/cache/nginx/{0..9}/{0..9}

# è®¾ç½®åˆé€‚çš„æƒé™
chown -R nginx:nginx /var/cache/nginx
chmod -R 755 /var/cache/nginx
```

**ğŸ”¸ ç›®å½•ç»“æ„è¯´æ˜**
```
/var/cache/nginx/
â”œâ”€â”€ 0/
â”‚   â”œâ”€â”€ 0/  â† ç¼“å­˜æ–‡ä»¶æŒ‰å“ˆå¸Œå€¼åˆ†æ•£å­˜å‚¨
â”‚   â”œâ”€â”€ 1/
â”‚   â””â”€â”€ ...
â”œâ”€â”€ 1/
â””â”€â”€ ...
```

---

## 8. ğŸŒ ç½‘ç»œå‚æ•°è°ƒä¼˜


### 8.1 TCPå‚æ•°ä¼˜åŒ–


**ğŸ”¸ ä¸ºä»€ä¹ˆè¦è°ƒä¼˜ç½‘ç»œå‚æ•°**
CDNèŠ‚ç‚¹éœ€è¦å¤„ç†å¤§é‡å¹¶å‘è¿æ¥ï¼Œé»˜è®¤çš„ç½‘ç»œå‚æ•°å¾€å¾€ä¸å¤Ÿç”¨ï¼š
- **è¿æ¥æ•°é™åˆ¶**ï¼šé»˜è®¤é…ç½®æ”¯æŒçš„è¿æ¥æ•°æœ‰é™
- **ç¼“å†²åŒºå°**ï¼šå½±å“æ•°æ®ä¼ è¾“æ•ˆç‡
- **è¶…æ—¶è®¾ç½®**ï¼šéœ€è¦æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´

**âš™ï¸ å…³é”®TCPå‚æ•°è°ƒä¼˜**
```bash
# /etc/sysctl.conf
# å¢åŠ æœ€å¤§è¿æ¥æ•°
net.core.somaxconn = 65535
net.core.netdev_max_backlog = 30000

# TCPç¼“å†²åŒºè®¾ç½®
net.core.rmem_default = 262144
net.core.rmem_max = 16777216
net.core.wmem_default = 262144
net.core.wmem_max = 16777216

# TCPçª—å£è°ƒä¼˜
net.ipv4.tcp_rmem = 4096 87380 16777216
net.ipv4.tcp_wmem = 4096 65536 16777216
net.ipv4.tcp_window_scaling = 1

# è¿æ¥é‡ç”¨
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_fin_timeout = 30

# åº”ç”¨è®¾ç½®
sysctl -p
```

**ğŸ”¸ å‚æ•°è¯´æ˜**
- **somaxconn**ï¼šç›‘å¬é˜Ÿåˆ—æœ€å¤§é•¿åº¦
- **tcp_rmem/wmem**ï¼šTCPè¯»/å†™ç¼“å†²åŒºå¤§å°
- **tcp_tw_reuse**ï¼šå…è®¸é‡ç”¨TIME_WAITçŠ¶æ€çš„è¿æ¥
- **tcp_fin_timeout**ï¼šFIN_WAIT_2çŠ¶æ€è¶…æ—¶æ—¶é—´

### 8.2 æ–‡ä»¶æè¿°ç¬¦é™åˆ¶è°ƒæ•´


**ğŸ“ å¢åŠ æ–‡ä»¶æè¿°ç¬¦é™åˆ¶**
```bash
# /etc/security/limits.conf
nginx soft nofile 100000
nginx hard nofile 100000

# æˆ–è€…é’ˆå¯¹æ‰€æœ‰ç”¨æˆ·
* soft nofile 100000
* hard nofile 100000
```

**ğŸ”§ æœåŠ¡çº§åˆ«é™åˆ¶**
```bash
# /etc/systemd/system/nginx.service.d/override.conf
[Service]
LimitNOFILE=100000
```

### 8.3 ç½‘ç»œé˜Ÿåˆ—ä¼˜åŒ–


**âš¡ ç½‘ç»œæ¥æ”¶é˜Ÿåˆ—ä¼˜åŒ–**
```bash
# æŸ¥çœ‹å½“å‰ç½‘å¡é˜Ÿåˆ—
ethtool -l eth0

# è®¾ç½®å¤šé˜Ÿåˆ—
ethtool -L eth0 combined 4

# è®¾ç½®ç½‘å¡ç¼“å†²åŒº
ethtool -G eth0 rx 2048 tx 2048
```

---

## 9. ğŸ“Š ç³»ç»Ÿç›‘æ§é…ç½®


### 9.1 åŸºç¡€ç›‘æ§æŒ‡æ ‡


**ğŸ”¸ CDNç›‘æ§çš„é‡è¦æ€§**
ç›‘æ§æ˜¯ä¿è¯CDNæœåŠ¡è´¨é‡çš„å…³é”®ï¼š
- **åŠæ—¶å‘ç°é—®é¢˜**ï¼šæœåŠ¡å™¨æ•…éšœã€ç½‘ç»œå¼‚å¸¸
- **æ€§èƒ½åˆ†æ**ï¼šç¼“å­˜å‘½ä¸­ç‡ã€å“åº”æ—¶é—´
- **å®¹é‡è§„åˆ’**ï¼šå­˜å‚¨ç©ºé—´ã€å¸¦å®½ä½¿ç”¨

**ğŸ“‹ æ ¸å¿ƒç›‘æ§æŒ‡æ ‡**
- **ç³»ç»ŸæŒ‡æ ‡**ï¼šCPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œ
- **æœåŠ¡æŒ‡æ ‡**ï¼šå¹¶å‘è¿æ¥æ•°ã€å“åº”æ—¶é—´
- **ç¼“å­˜æŒ‡æ ‡**ï¼šå‘½ä¸­ç‡ã€å­˜å‚¨ä½¿ç”¨ç‡
- **ä¸šåŠ¡æŒ‡æ ‡**ï¼šè®¿é—®é‡ã€é”™è¯¯ç‡

### 9.2 Prometheus + Grafanaç›‘æ§


**ğŸ› ï¸ Prometheuså®‰è£…é…ç½®**
```bash
# ä¸‹è½½Prometheus
wget https://github.com/prometheus/prometheus/releases/download/v2.40.0/prometheus-2.40.0.linux-amd64.tar.gz
tar xf prometheus-2.40.0.linux-amd64.tar.gz
mv prometheus-2.40.0.linux-amd64 /opt/prometheus
```

**ğŸ“ Prometheusé…ç½®**
```yaml
# /opt/prometheus/prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'nginx'
    static_configs:
      - targets: ['localhost:9113']
        
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['localhost:9100']
      
  - job_name: 'varnish'
    static_configs:
      - targets: ['localhost:9131']
```

**ğŸ”§ Nginxç›‘æ§é…ç½®**
```nginx
# æ·»åŠ åˆ°nginxé…ç½®
server {
    listen 8080;
    server_name localhost;
    
    location /nginx_status {
        stub_status on;
        access_log off;
        allow 127.0.0.1;
        deny all;
    }
}
```

### 9.3 ç›‘æ§è„šæœ¬ä¸å‘Šè­¦


**ğŸ“Š ç¼“å­˜å‘½ä¸­ç‡ç›‘æ§è„šæœ¬**
```bash
#!/bin/bash
# /usr/local/bin/monitor_cache.sh

# è·å–nginxç¼“å­˜çŠ¶æ€
nginx_stats=$(curl -s http://localhost:8080/nginx_status)
active_connections=$(echo "$nginx_stats" | grep "Active connections" | awk '{print $3}')

# è·å–ç¼“å­˜å‘½ä¸­ç‡
hit_count=$(grep "HIT" /var/log/nginx/access.log | wc -l)
total_count=$(wc -l < /var/log/nginx/access.log)
hit_rate=$(echo "scale=2; $hit_count * 100 / $total_count" | bc)

# è¾“å‡ºç›‘æ§æ•°æ®
echo "active_connections:$active_connections"
echo "cache_hit_rate:$hit_rate%"

# å‘Šè­¦æ£€æŸ¥
if (( $(echo "$hit_rate < 70" | bc -l) )); then
    echo "WARNING: Cache hit rate is low: $hit_rate%"
    # å‘é€å‘Šè­¦é‚®ä»¶æˆ–é€šçŸ¥
fi
```

---

## 10. ğŸ“‹ æ—¥å¿—æ”¶é›†ä¸åˆ†æ


### 10.1 æ—¥å¿—é…ç½®ä¸æ”¶é›†


**ğŸ”¸ CDNæ—¥å¿—çš„ä»·å€¼**
æ—¥å¿—æ˜¯CDNè¿è¥çš„é‡è¦æ•°æ®æ¥æºï¼š
- **ç”¨æˆ·è¡Œä¸ºåˆ†æ**ï¼šäº†è§£ç”¨æˆ·è®¿é—®æ¨¡å¼
- **æ€§èƒ½åˆ†æ**ï¼šå‘ç°æ€§èƒ½ç“¶é¢ˆ
- **æ•…éšœæ’æŸ¥**ï¼šå¿«é€Ÿå®šä½é—®é¢˜
- **å®‰å…¨åˆ†æ**ï¼šå‘ç°å¼‚å¸¸è®¿é—®

**ğŸ“ Nginxæ—¥å¿—æ ¼å¼ä¼˜åŒ–**
```nginx
# è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼
log_format cdn_format '$remote_addr - $remote_user [$time_local] '
                      '"$request" $status $body_bytes_sent '
                      '"$http_referer" "$http_user_agent" '
                      '$upstream_cache_status $request_time '
                      '$upstream_response_time';

# åº”ç”¨åˆ°è™šæ‹Ÿä¸»æœº
access_log /var/log/nginx/cdn_access.log cdn_format;
```

**ğŸ”¸ æ—¥å¿—å­—æ®µè¯´æ˜**
- **$upstream_cache_status**ï¼šç¼“å­˜çŠ¶æ€ï¼ˆHIT/MISS/BYPASSï¼‰
- **$request_time**ï¼šè¯·æ±‚æ€»å¤„ç†æ—¶é—´
- **$upstream_response_time**ï¼šåç«¯å“åº”æ—¶é—´

### 10.2 ELKæ—¥å¿—åˆ†æå¹³å°


**ğŸ› ï¸ Filebeatæ—¥å¿—æ”¶é›†é…ç½®**
```yaml
# /etc/filebeat/filebeat.yml
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/nginx/cdn_access.log
  fields:
    service: nginx-cdn
    
output.elasticsearch:
  hosts: ["localhost:9200"]
  
processors:
- decode_json_fields:
    fields: ["message"]
    target: ""
```

**ğŸ“Š æ—¥å¿—åˆ†æè„šæœ¬**
```bash
#!/bin/bash
# /usr/local/bin/analyze_logs.sh

LOG_FILE="/var/log/nginx/cdn_access.log"
DATE=$(date +%Y-%m-%d)

echo "=== CDNæ—¥å¿—åˆ†ææŠ¥å‘Š - $DATE ==="

# æ€»è®¿é—®é‡
total_requests=$(wc -l < $LOG_FILE)
echo "æ€»è®¿é—®é‡: $total_requests"

# ç¼“å­˜å‘½ä¸­ç‡
hit_count=$(grep "HIT" $LOG_FILE | wc -l)
hit_rate=$(echo "scale=2; $hit_count * 100 / $total_requests" | bc)
echo "ç¼“å­˜å‘½ä¸­ç‡: $hit_rate%"

# çŠ¶æ€ç ç»Ÿè®¡
echo "çŠ¶æ€ç åˆ†å¸ƒ:"
awk '{print $9}' $LOG_FILE | sort | uniq -c | sort -nr

# çƒ­é—¨æ–‡ä»¶
echo "çƒ­é—¨æ–‡ä»¶ TOP 10:"
awk '{print $7}' $LOG_FILE | sort | uniq -c | sort -nr | head -10

# æµé‡ç»Ÿè®¡
total_bytes=$(awk '{sum+=$10} END {print sum}' $LOG_FILE)
total_mb=$(echo "scale=2; $total_bytes / 1024 / 1024" | bc)
echo "æ€»æµé‡: ${total_mb} MB"
```

### 10.3 æ—¥å¿—è½®è½¬ä¸æ¸…ç†


**ğŸ”„ æ—¥å¿—è½®è½¬é…ç½®**
```bash
# /etc/logrotate.d/nginx-cdn
/var/log/nginx/cdn_*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    ifempty
    create 644 nginx nginx
    postrotate
        systemctl reload nginx
    endscript
}
```

**ğŸ§¹ æ—¥å¿—æ¸…ç†è„šæœ¬**
```bash
#!/bin/bash
# /usr/local/bin/cleanup_logs.sh

# åˆ é™¤30å¤©å‰çš„æ—¥å¿—
find /var/log/nginx/ -name "*.log.gz" -mtime +30 -delete

# åˆ é™¤å¤§äº1GBçš„å½“å‰æ—¥å¿—æ–‡ä»¶ï¼ˆå¼‚å¸¸æƒ…å†µï¼‰
find /var/log/nginx/ -name "*.log" -size +1G -exec truncate -s 0 {} \;

echo "æ—¥å¿—æ¸…ç†å®Œæˆ"
```

---

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ CDNåŸºç¡€æ¶æ„ï¼šè¾¹ç¼˜èŠ‚ç‚¹ + æºæœåŠ¡å™¨ + æ™ºèƒ½è°ƒåº¦
ğŸ”¸ ç¼“å­˜ç­–ç•¥ï¼šé™æ€æ–‡ä»¶é•¿ç¼“å­˜ï¼ŒåŠ¨æ€å†…å®¹çŸ­ç¼“å­˜æˆ–ä¸ç¼“å­˜
ğŸ”¸ è´Ÿè½½å‡è¡¡ï¼šåˆ†æ•£å‹åŠ›ï¼Œæé«˜å¯ç”¨æ€§å’Œæ€§èƒ½
ğŸ”¸ ç›‘æ§å‘Šè­¦ï¼šå®æ—¶ç›‘æ§æœåŠ¡çŠ¶æ€ï¼ŒåŠæ—¶å‘ç°é—®é¢˜
ğŸ”¸ æ—¥å¿—åˆ†æï¼šé€šè¿‡æ—¥å¿—äº†è§£ç”¨æˆ·è¡Œä¸ºå’Œç³»ç»Ÿæ€§èƒ½
```

### 11.2 å…³é”®æŠ€æœ¯é€‰å‹


**ğŸ”¹ WebæœåŠ¡å™¨é€‰æ‹©**
```
Nginxï¼š
âœ… é«˜å¹¶å‘ï¼Œä½å†…å­˜ï¼Œé…ç½®ç®€å•
âœ… ç¤¾åŒºæ´»è·ƒï¼Œæ–‡æ¡£ä¸°å¯Œ
ğŸ¯ æ¨èç”¨äºå¤§å¤šæ•°åœºæ™¯

Apacheï¼š
âœ… æ¨¡å—ä¸°å¯Œï¼ŒåŠŸèƒ½å¼ºå¤§
âœ… é…ç½®çµæ´»ï¼Œå…¼å®¹æ€§å¥½
ğŸ¯ é€‚ç”¨äºå¤æ‚ä¸šåŠ¡éœ€æ±‚

Varnishï¼š
âœ… ä¸“ä¸šç¼“å­˜ï¼Œæ€§èƒ½æé«˜
âœ… VCLè¯­è¨€çµæ´»
ğŸ¯ é€‚ç”¨äºé«˜æ€§èƒ½ç¼“å­˜éœ€æ±‚
```

**ğŸ”¹ è´Ÿè½½å‡è¡¡é€‰æ‹©**
```
HAProxyï¼š
âœ… åŠŸèƒ½ä¸°å¯Œï¼Œé…ç½®çµæ´»
âœ… å¥åº·æ£€æŸ¥å®Œå–„
ğŸ¯ é€‚ç”¨äºåº”ç”¨å±‚è´Ÿè½½å‡è¡¡

LVSï¼š
âœ… æ€§èƒ½æé«˜ï¼Œå†…æ ¸çº§åˆ«
âœ… å¯¹æœåŠ¡å™¨é€æ˜
ğŸ¯ é€‚ç”¨äºé«˜å¹¶å‘åœºæ™¯
```

### 11.3 æ€§èƒ½ä¼˜åŒ–è¦ç‚¹


**âš¡ ç³»ç»Ÿçº§ä¼˜åŒ–**
```
ç½‘ç»œå‚æ•°ï¼š
- å¢åŠ è¿æ¥æ•°é™åˆ¶
- ä¼˜åŒ–TCPç¼“å†²åŒº
- å¯ç”¨è¿æ¥å¤ç”¨

æ–‡ä»¶ç³»ç»Ÿï¼š
- é€‰æ‹©åˆé€‚çš„æ–‡ä»¶ç³»ç»Ÿ
- ä¼˜åŒ–æŒ‚è½½å‚æ•°
- åˆç†è®¾è®¡ç›®å½•ç»“æ„

ç¡¬ä»¶é…ç½®ï¼š
- SSDå­˜å‚¨æé«˜IOæ€§èƒ½
- å……è¶³å†…å­˜æé«˜ç¼“å­˜æ•ˆç‡
- å¤šæ ¸CPUå¤„ç†å¹¶å‘è¯·æ±‚
```

**ğŸ“Š ç›‘æ§æŒ‡æ ‡é‡ç‚¹**
```
æ€§èƒ½æŒ‡æ ‡ï¼š
- å“åº”æ—¶é—´ < 100ms
- ç¼“å­˜å‘½ä¸­ç‡ > 80%
- CPUä½¿ç”¨ç‡ < 70%
- å†…å­˜ä½¿ç”¨ç‡ < 80%

å¯ç”¨æ€§æŒ‡æ ‡ï¼š
- æœåŠ¡å¯ç”¨æ€§ > 99.9%
- é”™è¯¯ç‡ < 0.1%
- æ•…éšœæ¢å¤æ—¶é—´ < 5åˆ†é’Ÿ
```

### 11.4 è¿ç»´æœ€ä½³å®è·µ


**ğŸ› ï¸ éƒ¨ç½²å»ºè®®**
```
åˆ†é˜¶æ®µéƒ¨ç½²ï¼š
1. æµ‹è¯•ç¯å¢ƒéªŒè¯
2. ç°åº¦å‘å¸ƒéªŒè¯
3. å…¨é‡å‘å¸ƒ

å®¹ç¾å‡†å¤‡ï¼š
- å¤šåœ°éƒ¨ç½²
- è‡ªåŠ¨æ•…éšœåˆ‡æ¢
- å®šæœŸå¤‡ä»½æ¢å¤æ¼”ç»ƒ

å®‰å…¨åŠ å›ºï¼š
- å®šæœŸæ›´æ–°ç³»ç»Ÿ
- é…ç½®é˜²ç«å¢™è§„åˆ™
- å¯ç”¨è®¿é—®æ—¥å¿—å®¡è®¡
```

**ğŸ“ˆ æŒç»­ä¼˜åŒ–**
```
å®šæœŸè¯„ä¼°ï¼š
- æœˆåº¦æ€§èƒ½æŠ¥å‘Š
- å­£åº¦å®¹é‡è§„åˆ’
- å¹´åº¦æ¶æ„å‡çº§

æŠ€æœ¯è·Ÿè¿›ï¼š
- å…³æ³¨æ–°æŠ€æœ¯å‘å±•
- æµ‹è¯•æ€§èƒ½æ”¹è¿›
- é€æ­¥å‡çº§ä¼˜åŒ–
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- CDNæœ¬è´¨æ˜¯å°±è¿‘æœåŠ¡ï¼Œç¼“å­˜ä¸ºç‹
- æ€§èƒ½ä¼˜åŒ–éœ€è¦ç³»ç»Ÿçº§å…¨é¢è€ƒè™‘
- ç›‘æ§å’Œæ—¥å¿—æ˜¯è¿ç»´çš„çœ¼ç›å’Œå¤§è„‘
- è´Ÿè½½å‡è¡¡å’Œå®¹ç¾æ˜¯é«˜å¯ç”¨çš„åŸºç¡€
- æŒç»­ä¼˜åŒ–æ˜¯ä¿æŒç«äº‰åŠ›çš„å…³é”®