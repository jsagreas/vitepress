---
title: 7、网络安装与自动化部署
---
## 📚 目录

1. [网络安装基础概念](#1-网络安装基础概念)
2. [PXE网络启动环境搭建](#2-PXE网络启动环境搭建)  
3. [DHCP服务器配置详解](#3-DHCP服务器配置详解)
4. [TFTP文件传输协议配置](#4-TFTP文件传输协议配置)
5. [kickstart自动安装脚本](#5-kickstart自动安装脚本)
6. [preseed无人值守安装](#6-preseed无人值守安装)
7. [网络镜像源配置](#7-网络镜像源配置)
8. [批量部署策略](#8-批量部署策略)
9. [安装进度监控与日志](#9-安装进度监控与日志)
10. [核心要点总结](#10-核心要点总结)

---

## 1. 🌐 网络安装基础概念


### 1.1 什么是网络安装


**网络安装**就是通过网络来安装操作系统，不需要物理光盘或U盘。想象一下，你有100台新电脑需要安装系统，如果一台一台用光盘装，得累死人。网络安装就像是"远程装系统"，所有电脑都从网络上下载系统文件来安装。

```
传统安装方式：
每台电脑 + 光盘/U盘 → 手动安装 → 耗时巨大

网络安装方式：  
多台电脑 ← 网络 ← 安装服务器 → 批量自动安装
```

### 1.2 网络安装的核心优势


**🔸 批量部署**：一次性给几十台甚至几百台电脑装系统
**🔸 节省时间**：无需逐台插拔光盘，全自动完成
**🔸 标准化**：所有电脑装的系统配置完全一致
**🔸 远程操作**：管理员不用跑到每台电脑前操作

### 1.3 网络安装工作流程图


```
客户端电脑启动
      ↓
   PXE网络启动
      ↓
  DHCP获取IP地址
      ↓
  TFTP下载启动文件
      ↓
  HTTP下载系统镜像
      ↓
 kickstart自动安装
      ↓
    安装完成
```

---

## 2. 🔧 PXE网络启动环境搭建


### 2.1 PXE是什么


**PXE**（**P**reboot e**X**ecution **E**nvironment）翻译过来就是"预启动执行环境"。简单说，就是让电脑在没有硬盘系统的情况下，也能通过网络启动起来。

**通俗理解**：
- 普通启动：电脑 → 硬盘 → 找到系统 → 启动
- PXE启动：电脑 → 网卡 → 网络服务器 → 下载系统 → 启动

### 2.2 PXE启动必需组件


**📦 核心组件清单**
```
🔸 DHCP服务器：分配IP地址，告诉客户端去哪下载启动文件
🔸 TFTP服务器：提供启动文件下载（内核、initrd等）
🔸 HTTP/FTP服务器：提供系统安装包下载
🔸 PXE启动文件：让客户端知道如何启动
```

### 2.3 PXE环境架构图


```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   客户端电脑     │    │   DHCP服务器    │    │   TFTP服务器    │
│                │    │                │    │                │
│ 1.PXE网络启动   │───→│ 2.分配IP地址    │    │ 4.提供启动文件   │
│ 6.开始安装系统  │    │ 3.告知TFTP地址  │←───│ 5.下载内核文件   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         ↑                                            
         └──────────────── HTTP服务器 ─────────────────┘
                      （提供系统安装镜像）
```

### 2.4 启用PXE启动


**🔧 BIOS/UEFI设置步骤**
1. **开机进入BIOS**：开机时按Delete或F2键
2. **找到启动选项**：Boot Menu或Boot Options
3. **启用网络启动**：Enable PXE Boot 或 Network Boot
4. **调整启动顺序**：将Network Boot放在第一位
5. **保存退出**：Save & Exit

```
启动顺序示例：
1. Network Boot (PXE)  ← 设为第一启动项
2. Hard Drive
3. CD/DVD
4. USB
```

---

## 3. 🌐 DHCP服务器配置详解


### 3.1 DHCP在PXE中的作用


**DHCP服务器**不仅要分配IP地址，还要告诉客户端"去哪里下载启动文件"。就像是一个"向导"，指引客户端找到正确的启动路径。

**🔸 普通DHCP**：只分配IP、网关、DNS
**🔸 PXE DHCP**：额外告知TFTP服务器地址和启动文件名

### 3.2 DHCP服务安装配置


**安装DHCP服务**
```bash
# CentOS/RHEL系统
yum install dhcp -y

# Ubuntu/Debian系统  
apt install isc-dhcp-server -y
```

**核心配置文件：`/etc/dhcp/dhcpd.conf`**
```bash
# 全局配置
default-lease-time 600;        # 默认租期10分钟
max-lease-time 7200;          # 最大租期2小时

# 子网配置
subnet 192.168.1.0 netmask 255.255.255.0 {
    range 192.168.1.100 192.168.1.200;     # IP地址池
    option routers 192.168.1.1;            # 网关地址
    option domain-name-servers 8.8.8.8;    # DNS服务器
    
    # PXE启动关键配置
    next-server 192.168.1.10;              # TFTP服务器IP
    filename "pxelinux.0";                  # 启动文件名
}
```

### 3.3 配置参数详解


| 参数名称 | 作用说明 | 示例值 |
|---------|---------|--------|
| **next-server** | `TFTP服务器IP地址` | `192.168.1.10` |
| **filename** | `PXE启动文件名` | `pxelinux.0` |
| **range** | `IP地址分配范围` | `192.168.1.100-200` |
| **option routers** | `网关地址` | `192.168.1.1` |

### 3.4 启动DHCP服务


```bash
# 启动服务
systemctl start dhcpd
systemctl enable dhcpd

# 检查服务状态
systemctl status dhcpd

# 查看日志
tail -f /var/log/messages | grep dhcp
```

---

## 4. 📁 TFTP文件传输协议配置


### 4.1 TFTP协议特点


**TFTP**（**T**rivial **F**ile **T**ransfer **P**rotocol）是"简单文件传输协议"。相比FTP，它更简单，但功能也更基础。

**TFTP vs FTP对比**：
```
TFTP特点：
✅ 简单轻量，占用资源少
✅ 无需认证，适合PXE启动
✅ UDP协议，传输快速
❌ 功能简单，只能传输文件

FTP特点：
✅ 功能丰富，支持目录操作
✅ 安全认证机制
❌ 复杂重量，不适合启动环境
```

### 4.2 TFTP服务安装配置


**安装TFTP服务**
```bash
# CentOS/RHEL
yum install tftp-server xinetd -y

# Ubuntu/Debian
apt install tftpd-hpa -y
```

**配置TFTP服务：`/etc/xinetd.d/tftp`**
```bash
service tftp
{
    protocol        = udp
    port            = 69
    socket_type     = dgram
    wait            = yes
    user            = nobody
    server          = /usr/sbin/in.tftpd
    server_args     = -s /var/lib/tftpboot    # TFTP根目录
    disable         = no                      # 启用服务
}
```

### 4.3 TFTP目录结构准备


**创建TFTP根目录结构**
```bash
mkdir -p /var/lib/tftpboot
cd /var/lib/tftpboot

# 创建目录结构
mkdir -p {pxelinux.cfg,images/centos7}

# 目录结构如下：
/var/lib/tftpboot/
├── pxelinux.0              # PXE启动引导程序
├── pxelinux.cfg/           # 启动配置目录
│   └── default             # 默认启动配置
└── images/                 # 系统镜像目录
    └── centos7/
        ├── vmlinuz         # 内核文件
        └── initrd.img      # 初始化文件
```

### 4.4 获取PXE启动文件


**从syslinux包中获取**
```bash
# 安装syslinux
yum install syslinux -y

# 复制PXE启动文件
cp /usr/share/syslinux/pxelinux.0 /var/lib/tftpboot/
cp /usr/share/syslinux/menu.c32 /var/lib/tftpboot/
cp /usr/share/syslinux/vesamenu.c32 /var/lib/tftpboot/
```

---

## 5. 📜 kickstart自动安装脚本


### 5.1 kickstart是什么


**kickstart**是Red Hat系列Linux的自动化安装工具。就像是给安装程序写了一个"剧本"，告诉它该怎么安装系统，装哪些软件，怎么分区等等。

**通俗理解**：
- 手动安装：人工回答每个安装问题
- kickstart安装：提前写好答案，安装程序自动执行

### 5.2 kickstart文件结构


**kickstart文件主要包含三部分**：
```
🔸 命令部分：系统安装的基本设置
🔸 包选择部分：要安装的软件包
🔸 脚本部分：安装前后要执行的命令
```

### 5.3 基础kickstart配置示例


**创建 `/var/www/html/ks.cfg`**
```bash
#version=RHEL7
# 系统基本配置
install                                    # 安装模式
url --url="http://192.168.1.10/centos7"  # 安装源
lang en_US.UTF-8                         # 语言
keyboard us                              # 键盘布局
timezone Asia/Shanghai                   # 时区

# 网络配置
network --bootproto=dhcp --device=eth0   # 使用DHCP
network --hostname=client                # 主机名

# 磁盘分区
clearpart --all --initlabel             # 清空所有分区
autopart                                 # 自动分区

# 用户配置
rootpw --iscrypted $6$encrypted_password # root密码
user --name=admin --password=123456      # 普通用户

# 启动配置
bootloader --location=mbr                # 引导程序位置
firstboot --enable                       # 首次启动向导

# 重启
reboot                                   # 安装完成后重启

# 软件包选择
%packages
@^minimal                               # 最小化安装
@core                                   # 核心包组
vim                                     # 安装vim编辑器
wget                                    # 安装wget工具
%end

# 安装后脚本
%post
echo "System installed successfully" > /root/install.log
%end
```

### 5.4 kickstart配置详解表


| 配置项 | 作用 | 示例 |
|-------|------|------|
| **install** | `指定安装模式` | `install` |
| **url** | `指定安装源` | `url --url="http://server/centos7"` |
| **clearpart** | `磁盘分区处理` | `clearpart --all --initlabel` |
| **autopart** | `自动分区` | `autopart` |
| **rootpw** | `root密码` | `rootpw --plaintext 123456` |
| **network** | `网络配置` | `network --bootproto=dhcp` |

### 5.5 PXE启动菜单配置


**创建 `/var/lib/tftpboot/pxelinux.cfg/default`**
```bash
default vesamenu.c32
prompt 0
timeout 30

menu title PXE Boot Menu
menu background splash.jpg

label centos7
    menu label Install CentOS 7
    kernel images/centos7/vmlinuz
    append initrd=images/centos7/initrd.img ks=http://192.168.1.10/ks.cfg

label local
    menu label Boot from local drive
    localboot 0
```

---

## 6. 🐧 preseed无人值守安装


### 6.1 preseed介绍


**preseed**是Debian/Ubuntu系列的自动化安装方案，相当于Debian版的kickstart。它通过预设文件回答安装过程中的所有问题。

**kickstart vs preseed**：
```
Red Hat系列：kickstart (.cfg文件)
Debian系列：preseed (.cfg或.seed文件)
作用相同：都是自动化安装配置
```

### 6.2 preseed基础配置


**创建 `/var/www/html/preseed.cfg`**
```bash
# 地区和语言设置
d-i debian-installer/locale string en_US.UTF-8
d-i keyboard-configuration/xkb-keymap select us

# 网络配置
d-i netcfg/choose_interface select auto
d-i netcfg/get_hostname string ubuntu-client
d-i netcfg/get_domain string local

# 镜像设置
d-i mirror/country string manual
d-i mirror/http/hostname string archive.ubuntu.com
d-i mirror/http/directory string /ubuntu
d-i mirror/http/proxy string

# 用户账户设置
d-i passwd/user-fullname string Ubuntu User
d-i passwd/username string ubuntu
d-i passwd/user-password password 123456
d-i passwd/user-password-again password 123456
d-i user-setup/allow-password-weak boolean true

# 磁盘分区
d-i partman-auto/method string regular
d-i partman-auto/choose_recipe select atomic
d-i partman/confirm boolean true
d-i partman/confirm_nooverwrite boolean true

# 软件包选择
tasksel tasksel/first multiselect ubuntu-server
d-i pkgsel/include string openssh-server vim

# 引导程序
d-i grub-installer/only_debian boolean true
d-i grub-installer/bootdev string /dev/sda

# 完成安装
d-i finish-install/reboot_in_progress note
```

---

## 7. 🌐 网络镜像源配置


### 7.1 为什么需要镜像源


**镜像源**就是存放系统安装包的仓库。网络安装时，客户端需要从镜像源下载系统文件和软件包。

**本地镜像源优势**：
- **🚀 速度快**：局域网下载比互联网快
- **💰 节省带宽**：多台机器共享一个下载
- **🔒 稳定可控**：不依赖外网，安装更稳定

### 7.2 HTTP镜像源搭建


**安装Web服务器**
```bash
# CentOS/RHEL
yum install httpd -y
systemctl start httpd
systemctl enable httpd

# Ubuntu/Debian
apt install apache2 -y
systemctl start apache2
systemctl enable apache2
```

**创建镜像目录**
```bash
# Web根目录通常是 /var/www/html
mkdir -p /var/www/html/centos7
mkdir -p /var/www/html/ubuntu18

# 挂载ISO镜像
mount -o loop /path/to/CentOS-7-x86_64-DVD.iso /var/www/html/centos7
mount -o loop /path/to/ubuntu-18.04.5-server-amd64.iso /var/www/html/ubuntu18
```

### 7.3 镜像源目录结构


```
/var/www/html/
├── centos7/                    # CentOS 7镜像
│   ├── images/                 # 启动镜像
│   │   └── pxeboot/
│   │       ├── vmlinuz         # 内核文件
│   │       └── initrd.img      # 初始化文件
│   ├── Packages/               # RPM包目录
│   └── repodata/              # 仓库元数据
├── ubuntu18/                   # Ubuntu 18镜像
│   ├── casper/                 # Ubuntu启动文件
│   │   ├── vmlinuz             
│   │   └── initrd
│   └── pool/                   # DEB包目录
└── ks.cfg                      # kickstart文件
```

### 7.4 复制启动文件到TFTP


```bash
# 复制CentOS启动文件
cp /var/www/html/centos7/images/pxeboot/vmlinuz /var/lib/tftpboot/images/centos7/
cp /var/www/html/centos7/images/pxeboot/initrd.img /var/lib/tftpboot/images/centos7/

# 复制Ubuntu启动文件  
cp /var/www/html/ubuntu18/casper/vmlinuz /var/lib/tftpboot/images/ubuntu18/
cp /var/www/html/ubuntu18/casper/initrd /var/lib/tftpboot/images/ubuntu18/
```

---

## 8. 🚀 批量部署策略


### 8.1 批量部署规划


**批量部署**就是同时给多台电脑安装系统。需要考虑网络带宽、服务器性能、安装顺序等因素。

**部署策略选择**：
```
🔸 并发部署：多台同时安装，速度快但占用带宽大
🔸 分批部署：分组安装，带宽占用均匀
🔸 错峰部署：不同时间段安装，避免网络拥塞
```

### 8.2 网络带宽计算


**带宽需求估算**：
```
单台机器安装需求：约500MB-2GB
100Mbps网络环境：
- 理论速度：12.5MB/s
- 实际速度：约8-10MB/s  
- 同时安装数量：建议不超过5-8台

1000Mbps网络环境：
- 同时安装数量：可达30-50台
```

### 8.3 分组部署脚本示例


**创建分组部署脚本 `batch_deploy.sh`**
```bash
#!/bin/bash

# 定义机器分组
GROUP1="192.168.1.101 192.168.1.102 192.168.1.103"
GROUP2="192.168.1.104 192.168.1.105 192.168.1.106"
GROUP3="192.168.1.107 192.168.1.108 192.168.1.109"

# 唤醒网络启动（如果支持Wake-on-LAN）
wake_machines() {
    local group=$1
    echo "唤醒机器组: $group"
    for ip in $group; do
        # 这里可以添加WOL命令或远程启动命令
        echo "启动机器: $ip"
    done
}

# 监控安装进度
monitor_install() {
    local group=$1
    echo "监控安装进度..."
    # 可以通过ping或ssh检查安装状态
}

# 分批部署
echo "开始分批部署..."
wake_machines "$GROUP1"
sleep 600  # 等待10分钟
wake_machines "$GROUP2"  
sleep 600
wake_machines "$GROUP3"
```

### 8.4 MAC地址绑定配置


**为不同机器指定不同配置**
```bash
# 在DHCP配置中绑定MAC地址
host client1 {
    hardware ethernet 00:11:22:33:44:55;
    fixed-address 192.168.1.101;
    filename "pxelinux.0";
}

host client2 {
    hardware ethernet 00:11:22:33:44:66;
    fixed-address 192.168.1.102;  
    filename "pxelinux.0";
}
```

---

## 9. 📊 安装进度监控与日志


### 9.1 监控的重要性


**安装监控**帮助管理员了解批量安装的进度，及时发现和解决问题。就像工厂流水线需要质检员一样。

**监控内容**：
- **🔍 安装进度**：哪些机器在安装，哪些已完成
- **⚠️ 错误检测**：哪些机器安装失败
- **📈 网络状态**：带宽使用情况
- **⏱️ 时间统计**：预计完成时间

### 9.2 日志文件位置


**重要日志文件**：
```bash
# DHCP服务日志
/var/log/dhcpd.log                    # DHCP分配记录

# TFTP服务日志  
/var/log/messages                     # 系统消息（包含TFTP）
grep tftp /var/log/messages

# Web服务器日志
/var/log/httpd/access_log            # HTTP访问日志
/var/log/httpd/error_log             # HTTP错误日志

# 系统日志
/var/log/messages                    # 系统总日志
journalctl -u dhcpd                  # DHCP服务日志
journalctl -u httpd                  # HTTP服务日志
```

### 9.3 监控脚本示例


**创建监控脚本 `monitor_install.sh`**
```bash
#!/bin/bash

LOG_FILE="/var/log/pxe_monitor.log"
WEB_LOG="/var/log/httpd/access_log"

# 监控函数
monitor_dhcp() {
    echo "=== DHCP分配情况 ===" >> $LOG_FILE
    tail -n 50 /var/log/dhcpd.log | grep "DHCPACK" >> $LOG_FILE
}

monitor_tftp() {
    echo "=== TFTP下载情况 ===" >> $LOG_FILE  
    tail -n 50 /var/log/messages | grep "tftp" >> $LOG_FILE
}

monitor_http() {
    echo "=== HTTP下载情况 ===" >> $LOG_FILE
    tail -n 50 $WEB_LOG | grep -E "(vmlinuz|initrd|ks\.cfg)" >> $LOG_FILE
}

# 检查安装完成情况
check_completion() {
    echo "=== 安装完成检查 ===" >> $LOG_FILE
    for ip in 192.168.1.{101..110}; do
        if ping -c 1 $ip >/dev/null 2>&1; then
            echo "[$ip] 安装完成并已启动" >> $LOG_FILE
        else
            echo "[$ip] 安装中或未启动" >> $LOG_FILE  
        fi
    done
}

# 主监控循环
while true; do
    echo "$(date): 开始监控检查" >> $LOG_FILE
    monitor_dhcp
    monitor_tftp  
    monitor_http
    check_completion
    echo "=========================" >> $LOG_FILE
    sleep 300  # 5分钟检查一次
done
```

### 9.4 实时监控命令


**常用监控命令**：
```bash
# 实时查看DHCP日志
tail -f /var/log/dhcpd.log

# 实时查看HTTP访问
tail -f /var/log/httpd/access_log | grep -E "(vmlinuz|initrd|ks\.cfg)"

# 监控网络连接
netstat -an | grep :69        # TFTP连接
netstat -an | grep :80        # HTTP连接

# 检查服务状态
systemctl status dhcpd httpd xinetd
```

### 9.5 故障排查清单


| 问题现象 | 可能原因 | 解决方法 |
|---------|---------|---------|
| **客户端无法获取IP** | `DHCP服务未启动` | `systemctl start dhcpd` |
| **获取IP但无法启动** | `TFTP服务问题` | `检查xinetd和tftp配置` |
| **下载内核失败** | `文件路径错误` | `检查TFTP目录结构` |
| **kickstart找不到** | `HTTP服务问题` | `检查Web服务器配置` |
| **安装速度慢** | `网络带宽不足` | `减少并发安装数量` |

---

## 10. 📋 核心要点总结


### 10.1 必须掌握的核心概念


```
🔸 PXE网络启动：让电脑从网络启动而不是硬盘
🔸 DHCP配置：不仅分配IP，还要指定TFTP服务器  
🔸 TFTP协议：传输启动文件的简单文件协议
🔸 kickstart/preseed：自动化安装的配置脚本
🔸 镜像源：提供系统安装包的网络仓库
🔸 批量部署：同时给多台机器安装系统的策略
```

### 10.2 关键理解要点


**🔹 网络安装的本质**
```
核心思路：
- 客户端：通过网络获取启动文件和系统镜像
- 服务端：提供启动环境和安装资源
- 自动化：通过配置文件实现无人值守安装
```

**🔹 服务组件协作关系**
```
DHCP → 分配IP + 指向TFTP服务器
TFTP → 提供启动文件（内核、配置）  
HTTP → 提供系统镜像和kickstart文件
kickstart → 指导自动化安装过程
```

**🔹 部署规模考虑**
```
小规模（<10台）：可以并发安装
中等规模（10-50台）：分批部署
大规模（>50台）：需要多服务器或专业方案
```

### 10.3 实际应用价值


- **企业环境**：大批量服务器部署，标准化运维
- **学校机房**：统一安装教学环境
- **数据中心**：快速上线新服务器
- **测试环境**：快速重装测试系统
- **灾难恢复**：快速恢复大量受损系统

### 10.4 最佳实践建议


**🔧 服务器配置**
- 使用千兆网络，确保传输速度
- 服务器配置足够内存和存储空间
- 建议使用SSD提升文件传输性能

**📊 部署策略**
- 根据网络带宽合理控制并发数
- 预先测试配置，避免批量出错
- 建立监控机制，及时发现问题
- 准备回滚方案，应对部署失败

**🔒 安全考虑**
- DHCP服务器做好网络隔离
- kickstart文件不要包含明文密码
- 限制TFTP和HTTP服务的访问范围
- 部署完成后及时关闭不必要的服务

**核心记忆口诀**：
- PXE启动靠网卡，DHCP分配加指路
- TFTP传输启动文件，HTTP提供系统库  
- kickstart自动装，preseed是Ubuntu
- 批量部署要规划，监控日志不能少