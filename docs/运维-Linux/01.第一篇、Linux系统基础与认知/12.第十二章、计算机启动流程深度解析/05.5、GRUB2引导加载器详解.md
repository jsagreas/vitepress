---
title: 5、GRUB2引导加载器详解
---
## 📚 目录

1. [GRUB2基础概念](#1-GRUB2基础概念)
2. [GRUB2模块化架构设计](#2-GRUB2模块化架构设计)
3. [配置文件详解](#3-配置文件详解)
4. [GRUB2菜单管理](#4-GRUB2菜单管理)
5. [多系统引导配置](#5-多系统引导配置)
6. [GRUB2安全与救援](#6-GRUB2安全与救援)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 🚀 GRUB2基础概念


### 1.1 什么是GRUB2


**简单理解**：GRUB2就像计算机开机时的"选择菜单"，让你选择要启动哪个操作系统。

```
计算机开机流程：
开机 → BIOS/UEFI → GRUB2引导菜单 → 选择系统 → 启动Linux内核
```

**🔸 GRUB2的作用**
- **系统选择器**：多个操作系统时提供选择菜单
- **内核加载器**：找到并加载Linux内核文件
- **参数传递器**：向内核传递启动参数
- **故障救援器**：系统启动失败时提供救援模式

### 1.2 GRUB2 vs GRUB Legacy


| 特性对比 | **GRUB Legacy (老版本)** | **GRUB2 (新版本)** |
|---------|------------------------|-------------------|
| 配置文件 | `/boot/grub/menu.lst` | `/boot/grub/grub.cfg` |
| 配置方式 | 直接编辑配置文件 | 通过脚本自动生成 |
| 模块支持 | 功能固定 | 模块化，可扩展 |
| 文件系统 | 支持较少 | 支持更多文件系统 |
| UEFI支持 | 不支持 | 完全支持 |

**💡 为什么要升级到GRUB2？**
- **更强大**：支持更多文件系统和硬件
- **更灵活**：模块化设计，功能可扩展
- **更智能**：自动检测操作系统
- **更现代**：支持UEFI启动模式

---

## 2. 🏗️ GRUB2模块化架构设计


### 2.1 GRUB2架构组成


GRUB2采用分层模块化设计，就像搭积木一样：

```
GRUB2架构图：
┌─────────────────────────────────┐
│        GRUB2 Shell界面          │ ← 用户交互层
├─────────────────────────────────┤
│       命令和脚本系统            │ ← 命令解析层
├─────────────────────────────────┤
│       各种功能模块              │ ← 功能模块层
│  ┌─────┐ ┌─────┐ ┌─────┐      │
│  │文件系│ │网络 │ │加密 │ ...  │
│  │统模块│ │模块 │ │模块 │      │
│  └─────┘ └─────┘ └─────┘      │
├─────────────────────────────────┤
│        GRUB2 内核核心           │ ← 核心层
├─────────────────────────────────┤
│      硬件抽象层(HAL)            │ ← 硬件接口层
└─────────────────────────────────┘
```

### 2.2 核心模块分类


**🔸 基础模块（必需）**
```bash
# 文件系统支持模块
ext2, ext3, ext4    # Linux常用文件系统
fat, ntfs           # Windows文件系统
btrfs, xfs         # 高级文件系统

# 分区表支持模块  
msdos              # MBR分区表
gpt                # GPT分区表
```

**🔸 功能模块（按需加载）**
```bash
# 网络启动模块
net, tftp, http    # 网络协议支持
pxe               # PXE网络启动

# 安全模块
password, password_pbkdf2    # 密码保护
luks, cryptodisk            # 磁盘加密

# 图形模块
gfxterm, gfxmenu           # 图形界面
vga, vbe                   # 显示驱动
```

### 2.3 模块加载机制


**模块加载过程**：
```bash
# 1. 启动时自动加载核心模块
insmod part_msdos     # 加载MBR分区支持
insmod ext4           # 加载ext4文件系统支持

# 2. 按需动态加载功能模块
insmod password       # 需要密码保护时加载
insmod luks          # 访问加密分区时加载
```

**💡 模块化的好处**：
- **按需加载**：只加载需要的功能，节省内存
- **易于扩展**：新功能以模块形式添加
- **故障隔离**：单个模块出错不影响整体
- **维护简单**：模块独立更新

---

## 3. ⚙️ 配置文件详解


### 3.1 配置文件体系结构


GRUB2的配置不是直接编辑的，而是通过模板生成：

```
GRUB2配置文件体系：
/etc/default/grub           ← 主配置文件（用户编辑）
      ↓
/etc/grub.d/               ← 配置脚本目录
├── 00_header              ← 头部设置
├── 10_linux               ← Linux系统检测
├── 20_linux_xen           ← Xen虚拟化支持
├── 30_os-prober           ← 其他系统检测
└── 40_custom              ← 自定义菜单
      ↓
grub2-mkconfig命令
      ↓
/boot/grub/grub.cfg        ← 最终配置文件（自动生成）
```

### 3.2 /etc/default/grub主配置详解


这是GRUB2最重要的配置文件，控制启动行为：

```bash
# 基本配置参数
GRUB_DEFAULT=0                    # 默认启动项(0=第一个)
GRUB_TIMEOUT=5                    # 菜单显示时间(秒)
GRUB_DISTRIBUTOR="CentOS"         # 发行版名称
GRUB_CMDLINE_LINUX_DEFAULT=""     # 默认内核参数
GRUB_CMDLINE_LINUX=""             # 所有Linux都使用的参数

# 显示控制
GRUB_TERMINAL_OUTPUT="console"    # 输出终端类型
GRUB_GFXMODE=1024x768            # 图形模式分辨率
GRUB_BACKGROUND="/boot/grub/bg.png" # 背景图片

# 高级选项
GRUB_DISABLE_RECOVERY="true"      # 禁用恢复模式菜单
GRUB_DISABLE_OS_PROBER="false"    # 是否检测其他系统
```

**🔍 重要参数详解**：

**GRUB_DEFAULT** - 默认启动项
```bash
GRUB_DEFAULT=0          # 第一个菜单项
GRUB_DEFAULT=2          # 第三个菜单项  
GRUB_DEFAULT="saved"    # 记住上次选择
GRUB_DEFAULT="1>2"      # 子菜单中的项目
```

**GRUB_TIMEOUT** - 菜单等待时间
```bash
GRUB_TIMEOUT=5          # 等待5秒自动启动
GRUB_TIMEOUT=0          # 不显示菜单直接启动
GRUB_TIMEOUT=-1         # 永远等待用户选择
```

**GRUB_CMDLINE_LINUX** - 内核启动参数
```bash
# 常用内核参数示例
GRUB_CMDLINE_LINUX="quiet splash"           # 安静启动+启动画面
GRUB_CMDLINE_LINUX="rhgb quiet"            # RedHat图形启动
GRUB_CMDLINE_LINUX="systemd.unit=multi-user.target"  # 启动到命令行模式
```

### 3.3 grub.cfg配置文件结构


这是自动生成的最终配置文件，了解结构有助于故障排除：

```bash
# grub.cfg文件结构示例
## BEGIN /etc/grub.d/00_header ###

# 全局设置
set timeout=5
set default=0

## BEGIN /etc/grub.d/10_linux ###  

# Linux菜单项
menuentry 'CentOS Linux (3.10.0-1160.el7.x86_64)' {
    load_video
    insmod gzio
    insmod part_msdos
    insmod ext4
    set root='hd0,msdos1'
    linux   /vmlinuz-3.10.0-1160.el7.x86_64 root=/dev/mapper/centos-root
    initrd  /initramfs-3.10.0-1160.el7.x86_64.img
}

## BEGIN /etc/grub.d/30_os-prober ###

# 其他系统
menuentry 'Windows 10' {
    insmod part_msdos
    insmod ntfs
    set root='hd0,msdos2'
    chainloader +1
}
```

### 3.4 grub2-mkconfig配置生成


**基本使用方法**：
```bash
# 生成新的grub.cfg配置文件
grub2-mkconfig -o /boot/grub/grub.cfg

# 在某些系统中命令可能是：
grub-mkconfig -o /boot/grub/grub.cfg

# 先预览生成的配置（不写入文件）
grub2-mkconfig
```

**🔧 配置更新流程**：
```bash
# 完整的GRUB2配置更新步骤
1. 编辑主配置文件
   vim /etc/default/grub

2. 修改参数（比如修改默认启动项）
   GRUB_DEFAULT=2

3. 重新生成配置文件
   grub2-mkconfig -o /boot/grub/grub.cfg

4. 重启验证
   reboot
```

---

## 4. 📋 GRUB2菜单管理


### 4.1 菜单项的组成结构


每个GRUB2菜单项都包含以下关键信息：

```
菜单项结构：
┌─────────────────────────────────────┐
│  CentOS Linux (3.10.0-1160.el7)    │ ← 菜单标题
│  ├─ 内核文件: vmlinuz-3.10.0-1160  │ ← Linux内核
│  ├─ 内存盘: initramfs-3.10.0-1160  │ ← 初始内存文件系统  
│  ├─ 根分区: root=/dev/mapper/centos │ ← 根文件系统位置
│  └─ 内核参数: quiet splash         │ ← 启动参数
└─────────────────────────────────────┘
```

### 4.2 自定义菜单项


**方法一：修改 /etc/grub.d/40_custom**
```bash
#!/bin/sh
exec tail -n +3 $0
# 自定义菜单项开始

menuentry "我的自定义Linux" {
    set root=(hd0,1)                    # 设置根分区
    linux /vmlinuz-custom root=/dev/sda1 quiet  # 加载内核
    initrd /initrd-custom               # 加载初始RAM磁盘
}

menuentry "内存测试工具" {
    set root=(hd0,1)
    linux /memtest86+ 
}
```

**方法二：创建自定义脚本文件**
```bash
# 创建自定义脚本（以数字开头控制顺序）
vim /etc/grub.d/06_custom

#!/bin/sh
echo "menuentry 'Emergency Boot' {"
echo "    set root=(hd0,1)" 
echo "    linux /vmlinuz root=/dev/sda1 single"
echo "    initrd /initrd"
echo "}"

# 设置执行权限
chmod +x /etc/grub.d/06_custom
```

### 4.3 菜单外观定制


**🎨 主题和背景设置**：
```bash
# 在/etc/default/grub中设置
GRUB_BACKGROUND="/boot/grub/backgrounds/mybackground.png"
GRUB_THEME="/boot/grub/themes/mytheme/theme.txt"
GRUB_GFXMODE="1920x1080"              # 设置分辨率
GRUB_GFXPAYLOAD_LINUX="keep"          # 保持图形模式
```

**颜色和字体定制**：
```bash
# 在40_custom中设置颜色
menuentry "彩色菜单项" {
    set color_normal=white/blue         # 正常颜色：白字蓝底
    set color_highlight=yellow/red      # 高亮颜色：黄字红底
    # ... 其他设置
}
```

### 4.4 隐藏和显示菜单项


**隐藏恢复模式菜单**：
```bash
# 在/etc/default/grub中设置
GRUB_DISABLE_RECOVERY="true"
```

**隐藏其他操作系统检测**：
```bash  
# 不检测Windows等其他系统
GRUB_DISABLE_OS_PROBER="true"
```

**设置菜单显示条件**：
```bash
# 按住Shift键才显示菜单
GRUB_FORCE_HIDDEN_MENU="true"

# 只有多个系统时才显示菜单
GRUB_TIMEOUT_STYLE="countdown"
```

---

## 5. 🖥️ 多系统引导配置


### 5.1 双系统引导原理


多系统引导就像一个"系统选择器"，让你在开机时选择要启动的操作系统：

```
双系统引导示例：
硬盘分区布局：
/dev/sda1  ←  Windows系统分区 (NTFS)
/dev/sda2  ←  Linux根分区 (ext4)  
/dev/sda3  ←  Linux交换分区 (swap)

GRUB2菜单：
┌─────────────────────────┐
│ 1. CentOS Linux         │ ← 默认选项
│ 2. Windows 10           │ ← Windows启动项
│ 3. Advanced options     │ ← 高级选项
└─────────────────────────┘
```

### 5.2 自动检测其他系统


GRUB2通过`os-prober`工具自动检测其他操作系统：

```bash
# 手动运行系统检测
os-prober

# 输出示例：
/dev/sda1:Windows 10:Windows:chain
/dev/sda4:Ubuntu 20.04:Ubuntu:linux

# 更新GRUB配置以包含检测到的系统
grub2-mkconfig -o /boot/grub/grub.cfg
```

### 5.3 手动添加Windows启动项


如果自动检测失败，可以手动添加：

```bash
# 在/etc/grub.d/40_custom中添加
menuentry "Windows 10" {
    insmod part_msdos      # 加载MBR分区支持
    insmod ntfs            # 加载NTFS文件系统支持
    insmod chain           # 加载链式加载器
    set root='hd0,msdos1'  # 设置Windows分区(第一块硬盘第一个分区)
    chainloader +1         # 链式加载Windows启动管理器
}
```

**🔍 分区表示方法**：
```bash
# GRUB2分区命名规则
(hd0,msdos1)  =  /dev/sda1    # 第一块硬盘第一个主分区
(hd0,msdos2)  =  /dev/sda2    # 第一块硬盘第二个主分区  
(hd1,msdos1)  =  /dev/sdb1    # 第二块硬盘第一个分区
(hd0,gpt1)    =  /dev/sda1    # GPT分区表的第一个分区
```

### 5.4 多Linux发行版配置


**场景**：同时安装CentOS和Ubuntu两个Linux系统

```bash
# CentOS菜单项（自动生成）
menuentry 'CentOS Linux (3.10.0-1160.el7.x86_64)' {
    set root='hd0,msdos2'
    linux /vmlinuz-3.10.0-1160.el7.x86_64 root=/dev/sda2
    initrd /initramfs-3.10.0-1160.el7.x86_64.img
}

# Ubuntu菜单项（手动添加到40_custom）
menuentry 'Ubuntu 20.04' {
    set root='hd0,msdos3'  
    linux /boot/vmlinuz-5.4.0-74-generic root=/dev/sda3
    initrd /boot/initrd.img-5.4.0-74-generic
}
```

### 5.5 设置默认启动系统


**方法一：通过数字索引**
```bash
# 在/etc/default/grub中设置
GRUB_DEFAULT=0      # 第一个菜单项(CentOS)
GRUB_DEFAULT=1      # 第二个菜单项(Windows)
GRUB_DEFAULT=2      # 第三个菜单项(Ubuntu)
```

**方法二：通过菜单标题**
```bash
# 使用确切的菜单标题
GRUB_DEFAULT="Windows 10"
GRUB_DEFAULT="CentOS Linux (3.10.0-1160.el7.x86_64)"
```

**方法三：记住上次选择**
```bash
GRUB_DEFAULT=saved
GRUB_SAVEDEFAULT=true

# 设置初始默认项
grub2-set-default 1  # 设置第二个菜单项为默认
```

---

## 6. 🔒 GRUB2安全与救援


### 6.1 GRUB2密码保护设置


密码保护可以防止未经授权的用户修改启动参数或进入救援模式：

**设置密码的步骤**：

```bash
# 1. 生成密码哈希
grub2-mkpasswd-pbkdf2

# 输入密码后会得到类似输出：
# PBKDF2 hash of your password is grub.pbkdf2.sha512.10000.6E8...

# 2. 编辑密码配置文件
vim /etc/grub.d/00_header

# 在文件末尾添加：
cat << 'EOF'
set superusers="admin"
password_pbkdf2 admin grub.pbkdf2.sha512.10000.6E8...
EOF

# 3. 更新配置
grub2-mkconfig -o /boot/grub/grub.cfg
```

**设置不同级别的保护**：

```bash
# 在/etc/grub.d/10_linux中修改菜单项
# 需要密码才能启动的菜单项
menuentry 'Secure Boot' --class os --users admin {
    # 启动参数
}

# 任何人都能启动的菜单项  
menuentry 'Normal Boot' --class os --unrestricted {
    # 启动参数
}
```

### 6.2 GRUB2命令行救援模式


当系统无法正常启动时，可以使用GRUB2命令行进行救援：

**进入GRUB2命令行**：
- 开机时按`c`键进入GRUB2命令行
- 或在菜单界面按`e`键编辑启动参数

**🔧 常用救援命令**：

```bash
# 列出所有磁盘和分区
grub> ls
(hd0) (hd0,msdos1) (hd0,msdos2)

# 查看分区内容
grub> ls (hd0,msdos1)/
lost+found/ bin/ boot/ dev/ etc/ home/

# 设置根分区
grub> set root=(hd0,msdos2)

# 加载Linux内核
grub> linux /vmlinuz-3.10.0-1160.el7.x86_64 root=/dev/sda2

# 加载初始RAM磁盘
grub> initrd /initramfs-3.10.0-1160.el7.x86_64.img  

# 启动系统
grub> boot
```

### 6.3 常见启动故障救援


**故障1：找不到内核文件**
```bash
# 错误信息：error: file '/vmlinuz-xxx' not found

# 救援步骤：
grub> ls (hd0,msdos2)/boot/
# 找到正确的内核文件名
grub> linux /boot/vmlinuz-correct-version root=/dev/sda2
grub> initrd /boot/initramfs-correct-version.img
grub> boot
```

**故障2：根分区设置错误**
```bash
# 错误信息：Kernel panic - not syncing: VFS: Unable to mount root

# 救援步骤：
grub> ls                    # 列出所有分区
grub> ls (hd0,msdos1)/      # 逐个检查分区内容
grub> set root=(hd0,msdos2) # 设置正确的根分区
grub> linux /vmlinuz root=/dev/sda2  # 使用正确的根分区
```

**故障3：GRUB配置文件损坏**
```bash
# 从Live CD或救援模式修复：
# 挂载根分区
mount /dev/sda2 /mnt

# 挂载必要的文件系统
mount --bind /dev /mnt/dev
mount --bind /proc /mnt/proc  
mount --bind /sys /mnt/sys

# 切换到系统环境
chroot /mnt

# 重新生成GRUB配置
grub2-mkconfig -o /boot/grub/grub.cfg

# 重新安装GRUB到MBR
grub2-install /dev/sda
```

### 6.4 单用户模式启动


当需要修复系统或重置密码时，可以启动到单用户模式：

```bash
# 在GRUB菜单中：
1. 选择Linux菜单项
2. 按'e'键编辑启动参数
3. 在linux行末尾添加：
   single
   # 或者
   systemd.unit=rescue.target
   
4. 按Ctrl+X或F10启动
```

**单用户模式用途**：
- 🔧 **重置root密码**
- 🔧 **修复文件系统错误** 
- 🔧 **修改关键配置文件**
- 🔧 **诊断启动问题**

---

## 7. 📋 核心要点总结


### 7.1 必须掌握的基本概念


```
🔸 GRUB2作用：系统启动时的引导菜单，负责加载操作系统内核
🔸 模块化架构：按需加载功能模块，核心+扩展的设计理念
🔸 配置体系：用户编辑/etc/default/grub，系统自动生成grub.cfg
🔸 菜单管理：通过脚本文件控制菜单项的生成和显示
🔸 多系统支持：自动检测或手动配置多个操作系统启动
🔸 安全救援：密码保护和命令行救援功能
```

### 7.2 关键操作流程


**🔹 GRUB2配置标准流程**
```bash
1. 修改主配置文件
   vim /etc/default/grub
   
2. 编辑自定义菜单（如需要）
   vim /etc/grub.d/40_custom
   
3. 重新生成配置文件
   grub2-mkconfig -o /boot/grub/grub.cfg
   
4. 重启验证
   reboot
```

**🔹 多系统引导设置流程**
```bash
1. 确认分区布局
   fdisk -l
   
2. 检测其他系统
   os-prober
   
3. 更新GRUB配置
   grub2-mkconfig -o /boot/grub/grub.cfg
   
4. 设置默认启动项（可选）
   grub2-set-default 0
```

### 7.3 重要配置参数记忆


| 参数名称 | **作用** | **常用值** | **记忆要点** |
|---------|---------|-----------|-------------|
| `GRUB_DEFAULT` | 默认启动项 | `0`, `"saved"` | 从0开始计数 |
| `GRUB_TIMEOUT` | 菜单等待时间 | `5`, `0`, `-1` | 0=不显示，-1=永远等待 |
| `GRUB_CMDLINE_LINUX` | 内核参数 | `"quiet splash"` | 影响启动行为 |
| `GRUB_DISABLE_RECOVERY` | 禁用恢复模式 | `"true"` | 简化菜单显示 |

### 7.4 故障排除记忆要点


**🔹 救援模式核心命令**
```bash
ls                    # 查看分区
set root=(hd0,msdos1) # 设置根分区  
linux /vmlinuz        # 加载内核
initrd /initramfs     # 加载内存盘
boot                  # 启动系统
```

**🔹 常见问题解决思路**
```
找不到内核 → 检查内核文件名和路径
根分区错误 → 确认正确的分区设备名
配置损坏 → 重新生成grub.cfg
密码忘记 → 单用户模式重置
```

### 7.5 实际应用价值


- **系统管理**：理解启动流程，快速诊断启动问题
- **多系统环境**：配置Windows+Linux双系统启动
- **服务器运维**：设置安全的远程启动选项
- **故障恢复**：使用救援模式修复系统故障
- **性能优化**：通过内核参数调整系统行为

### 7.6 学习建议


**🎯 动手实践**
```bash
# 建议的练习步骤：
1. 备份现有GRUB配置
2. 修改菜单等待时间和默认项
3. 添加一个自定义菜单项  
4. 设置GRUB密码保护
5. 在虚拟机中练习救援模式
```

**📚 深入学习方向**
- UEFI启动模式下的GRUB2配置
- 网络启动(PXE)配置
- GRUB2主题定制开发
- 企业环境下的批量部署

**核心记忆口诀**：
```
GRUB2模块化，配置要生成
默认超时要设好，多系统检测要开启  
密码救援保安全，命令行下能修复
配置流程要记牢，故障排查有章法
```