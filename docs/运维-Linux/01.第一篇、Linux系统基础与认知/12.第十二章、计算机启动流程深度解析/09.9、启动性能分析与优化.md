---
title: 9、启动性能分析与优化
---
## 📚 目录

1. [启动性能分析概述](#1-启动性能分析概述)
2. [systemd-analyze启动分析工具](#2-systemd-analyze启动分析工具)
3. [blame命令服务耗时统计](#3-blame命令服务耗时统计)
4. [critical-chain关键路径分析](#4-critical-chain关键路径分析)
5. [plot图形化启动流程](#5-plot图形化启动流程)
6. [启动优化实践策略](#6-启动优化实践策略)
7. [核心要点总结](#7-核心要点总结)

---

## 1. 🚀 启动性能分析概述


### 1.1 什么是启动性能分析


**通俗理解**：就像体检一样，给你的Linux系统启动过程做个"全身检查"，看看哪里慢了、卡住了。

```
启动性能分析的作用：
┌─────────────────────────────────────┐
│  开机按钮 → BIOS → 内核 → 系统服务   │
│     ↓         ↓      ↓       ↓      │
│   检查    检查   检查    检查       │
│  哪一步  哪一步  哪一步  哪一步     │
│  最慢？  卡住？  出错？  多余？     │
└─────────────────────────────────────┘
```

### 1.2 为什么要做启动性能分析


**实际问题场景**：
- 🐌 **开机太慢**：原来10秒开机，现在要1分钟
- ⏰ **服务器重启**：生产环境重启需要快速恢复
- 🔍 **故障排查**：某些服务启动失败或超时
- ⚡ **系统优化**：让系统跑得更快更稳定

> 💡 **生活类比**  
> 就像早晨起床上班，你需要知道是洗漱慢、吃早饭慢，还是路上堵车慢，这样才能针对性地提前准备。

### 1.3 启动性能的关键指标


**重要时间节点**：
```
启动时间组成：
硬件初始化 + 内核启动 + 服务启动 = 总启动时间
     ↓           ↓         ↓
   BIOS检测    内核加载   systemd启动服务
   (固定时间)  (相对固定)  (可优化部分)
```

**主要性能指标**：
- **总启动时间**：从开机到完全可用的时间
- **内核启动时间**：内核自己的启动耗时
- **用户空间启动时间**：系统服务启动耗时
- **关键服务启动时间**：重要服务的个别耗时

---

## 2. 🔧 systemd-analyze启动分析工具


### 2.1 systemd-analyze基本概念


**简单说明**：`systemd-analyze`是Linux系统自带的启动分析"神器"，专门用来分析系统启动过程。

> 💭 **通俗理解**  
> 把它想象成一个"启动录像机"，它会记录下系统启动时每个步骤用了多长时间，然后生成一份详细的"体检报告"。

### 2.2 基本使用方法


#### 🔍 查看总体启动时间


```bash
# 查看启动总时间
systemd-analyze

# 输出示例：
# Startup finished in 2.547s (kernel) + 8.342s (userspace) = 10.889s
```

**结果解读**：
- **kernel时间**：内核启动用了2.547秒
- **userspace时间**：用户空间（系统服务）启动用了8.342秒  
- **总时间**：整个启动过程10.889秒

#### ⏱️ 详细时间分解


```bash
# 查看详细的启动阶段时间
systemd-analyze time
```

**输出解释**：
```
启动阶段详解：
├── firmware: 固件初始化时间
├── loader: 引导程序加载时间  
├── kernel: 内核启动时间
├── initrd: 初始化磁盘时间
└── userspace: 用户空间启动时间
```

### 2.3 启动时间的含义解释


**各个阶段具体做什么**：

| 阶段 | **含义** | **主要工作** | **能否优化** |
|------|---------|-------------|-------------|
| 🔧 **firmware** | `BIOS/UEFI初始化` | `硬件检测、自检` | `❌ 硬件决定` |
| 📚 **loader** | `引导加载程序` | `GRUB加载内核` | `⚡ 可微调` |
| 🐧 **kernel** | `Linux内核启动` | `驱动加载、内存初始化` | `⚡ 可微调` |
| 💾 **initrd** | `初始化内存盘` | `临时文件系统、驱动` | `✅ 可优化` |
| 🎯 **userspace** | `系统服务启动` | `各种服务启动` | `✅ 重点优化` |

> ⚠️ **重要提醒**  
> **userspace时间**是我们优化的重点，因为这部分包含了所有系统服务的启动，最有优化潜力。

---

## 3. 📊 blame命令服务耗时统计


### 3.1 blame命令基本用法


**命令作用**：`systemd-analyze blame` 会列出所有服务的启动时间，按耗时从长到短排序。

```bash
# 查看各个服务的启动时间
systemd-analyze blame
```

**典型输出示例**：
```
8.234s NetworkManager-wait-online.service
3.421s mysql.service  
2.156s apache2.service
1.987s ssh.service
1.234s rsyslog.service
 987ms dbus.service
 567ms systemd-logind.service
```

### 3.2 输出结果解读


**如何看懂这个列表**：

> 🎯 **重点关注原则**  
> 1. **看前几名**：耗时最长的服务是重点优化对象
> 2. **看异常服务**：某些服务耗时明显过长
> 3. **看不必要服务**：你可能不需要的服务

**常见耗时服务解释**：

| 服务名称 | **作用** | **为什么慢** | **优化建议** |
|---------|---------|-------------|-------------|
| 🌐 **NetworkManager-wait-online** | `等待网络连接` | `等待网络配置完成` | `调整超时时间` |
| 🗄️ **mysql.service** | `数据库服务` | `数据库初始化` | `优化数据库配置` |
| 🌍 **apache2.service** | `Web服务器` | `加载配置和模块` | `减少不必要模块` |
| 🔐 **ssh.service** | `SSH远程登录` | `生成密钥` | `预生成密钥` |

### 3.3 实际问题排查示例


**场景：系统启动很慢**

```bash
# 1. 先看总体时间
systemd-analyze
# 结果：总共45秒，userspace占了40秒

# 2. 看具体哪个服务慢
systemd-analyze blame | head -10
# 结果：NetworkManager-wait-online占了35秒！
```

**问题分析**：
```
问题根源分析：
NetworkManager-wait-online.service: 35s
         ↓
这个服务在等待网络连接
         ↓  
可能原因：网络配置有问题，或者在等待不存在的网络
         ↓
解决方案：检查网络配置或禁用此服务
```

---

## 4. 🔗 critical-chain关键路径分析


### 4.1 什么是关键路径


**通俗解释**：关键路径就是启动过程中的"必经之路"，就像上班路上的主干道，如果主干道堵车，整个行程就会延误。

```
启动依赖关系示意：
A服务 → B服务 → C服务 → 系统就绪
  ↓       ↓       ↓
如果B服务慢，后面的C服务就得等着
整个启动时间 = A时间 + B时间 + C时间
```

### 4.2 critical-chain命令使用


```bash
# 查看启动的关键路径
systemd-analyze critical-chain
```

**输出示例**：
```
multi-user.target @8.234s
├─NetworkManager.service @7.821s +413ms
│ └─dbus.service @7.456s +234ms
│   └─basic.target @7.123s
│     └─sockets.target @7.089s
└─ssh.service @6.234s +1.587s
  └─network.target @5.123s +1.111s
```

### 4.3 关键路径解读


**如何看懂这个树形结构**：

> 📖 **符号说明**  
> - `@时间`：服务开始启动的时间点
> - `+时间`：服务自己的启动耗时
> - `└─`：依赖关系，上级等下级完成

**实际分析过程**：
```
关键路径分析步骤：
1. 找到最长的路径（通常到multi-user.target）
2. 识别路径上最耗时的服务
3. 分析为什么这个服务这么慢
4. 看看能否优化或者改变依赖关系
```

**常见关键路径瓶颈**：
- 🌐 **网络相关服务**：等待网络配置
- 💾 **存储相关服务**：磁盘检查、挂载
- 🔐 **安全相关服务**：密钥生成、认证
- 🗄️ **数据库服务**：数据初始化

---

## 5. 📈 plot图形化启动流程


### 5.1 生成启动时间图表


**基本用法**：
```bash
# 生成SVG格式的启动流程图
systemd-analyze plot > boot-analysis.svg

# 在图形界面中打开查看
firefox boot-analysis.svg
# 或者
chromium boot-analysis.svg
```

### 5.2 图表内容解读


**图表包含的信息**：
```
图表结构说明：
┌─────────────────────────────────────────┐
│ 时间轴（横轴）：0s → 10s → 20s...       │
│ 服务列表（纵轴）：各个systemd服务        │
│ 彩色条带：每个服务的启动时间和持续时间    │
│ 依赖线条：服务之间的依赖关系           │
└─────────────────────────────────────────┘
```

**颜色含义**：
- 🟢 **绿色**：正常启动完成的服务
- 🟡 **黄色**：启动中的服务
- 🔴 **红色**：启动失败或超时的服务
- ⚫ **黑色**：还未开始启动的服务

### 5.3 图表分析技巧


**重点关注点**：

> 🔍 **分析要点**  
> 1. **找最长的条带**：哪个服务启动时间最长
> 2. **找密集区域**：同时启动很多服务的时间段
> 3. **找空白区域**：系统在等待什么
> 4. **找依赖链条**：关键服务的依赖路径

**实用分析方法**：
```bash
# 结合多个命令分析
systemd-analyze time        # 看总体时间
systemd-analyze blame       # 看具体服务
systemd-analyze critical-chain  # 看关键路径
systemd-analyze plot > boot.svg # 看可视化图表
```

---

## 6. ⚡ 启动优化实践策略


### 6.1 并行启动优化策略


**什么是并行启动**：就是让多个服务同时启动，而不是一个接一个地排队启动。

```
串行启动（慢）：
服务A → 完成 → 服务B → 完成 → 服务C
总时间 = A时间 + B时间 + C时间

并行启动（快）：
服务A ↘
服务B  → 同时启动 → 完成
服务C ↗
总时间 = max(A时间, B时间, C时间)
```

**检查并行启动状态**：
```bash
# 查看systemd的并行启动配置
systemctl show-environment | grep SYSTEMD

# 查看当前并行启动的任务数
systemd-analyze dump | grep -i parallel
```

### 6.2 服务启动顺序优化


**识别不必要的依赖**：
```bash
# 查看某个服务的依赖关系
systemctl list-dependencies ssh.service

# 查看某个服务被哪些服务依赖
systemctl list-dependencies --reverse ssh.service
```

**优化依赖关系的方法**：

| 优化策略 | **具体方法** | **适用场景** | **注意事项** |
|---------|-------------|-------------|-------------|
| 🔧 **移除不必要依赖** | `修改service文件` | `服务不是真正需要` | `确保功能正常` |
| ⚡ **改为弱依赖** | `Wants代替Requires` | `服务可选依赖` | `测试兼容性` |
| 🎯 **延迟启动** | `使用socket激活` | `按需启动的服务` | `首次访问略慢` |

### 6.3 不必要服务禁用


**识别可禁用的服务**：
```bash
# 列出所有启用的服务
systemctl list-unit-files --type=service --state=enabled

# 查看服务的详细信息
systemctl status 服务名.service
```

**常见可禁用的服务**：

> ⚠️ **安全提醒**  
> 禁用服务前一定要了解其作用，避免影响系统功能！

```bash
# 典型的可考虑禁用的服务（仅供参考）

# 如果不需要打印功能
sudo systemctl disable cups.service

# 如果不需要蓝牙
sudo systemctl disable bluetooth.service

# 如果不需要NetworkManager等待网络
sudo systemctl disable NetworkManager-wait-online.service

# 如果是服务器不需要图形界面相关
sudo systemctl disable gdm.service
```

**禁用服务的安全步骤**：
```bash
# 1. 先查看服务状态
systemctl status 服务名

# 2. 临时停止服务测试
sudo systemctl stop 服务名

# 3. 测试系统功能正常后再禁用
sudo systemctl disable 服务名

# 4. 如果有问题，可以重新启用
sudo systemctl enable 服务名
```

### 6.4 启动时间基准测试


**建立性能基准**：
```bash
# 记录优化前的性能
systemd-analyze > baseline-before.txt
systemd-analyze blame > blame-before.txt

# 进行优化操作...

# 记录优化后的性能
systemd-analyze > baseline-after.txt
systemd-analyze blame > blame-after.txt

# 对比结果
diff baseline-before.txt baseline-after.txt
```

**持续监控启动性能**：
```bash
# 创建简单的监控脚本
#!/bin/bash
echo "$(date): $(systemd-analyze | grep 'Startup finished')" >> /var/log/boot-performance.log
```

### 6.5 实际优化案例


**案例：服务器启动时间从45秒优化到15秒**

```bash
# 优化前分析
systemd-analyze blame | head -5
# NetworkManager-wait-online.service: 30s
# mysql.service: 8s  
# apache2.service: 5s
# postfix.service: 2s

# 优化措施：
# 1. 禁用不必要的网络等待
sudo systemctl disable NetworkManager-wait-online.service

# 2. 优化MySQL配置
sudo vim /etc/mysql/mysql.conf.d/mysqld.cnf
# 添加：innodb_buffer_pool_size = 128M（减小缓冲池）

# 3. 减少Apache模块加载
sudo a2dismod ssl      # 如果不需要SSL
sudo a2dismod rewrite  # 如果不需要URL重写

# 优化后验证
systemd-analyze
# 结果：总启动时间降到15秒
```

---

## 7. 📋 核心要点总结


### 7.1 必须掌握的核心工具


```
🔧 systemd-analyze 工具套装：
├── systemd-analyze          # 查看总体启动时间
├── systemd-analyze time     # 详细阶段时间  
├── systemd-analyze blame    # 服务耗时排名
├── systemd-analyze critical-chain  # 关键路径分析
└── systemd-analyze plot     # 生成可视化图表
```

### 7.2 启动性能分析思路


**标准分析流程**：
```
性能分析三步法：
1️⃣ 总体诊断：systemd-analyze 看总时间
2️⃣ 具体定位：blame + critical-chain 找瓶颈
3️⃣ 深入分析：plot 图表详细分析
```

**重点关注指标**：
- **userspace时间**：最有优化潜力的部分
- **前5名服务**：通常是优化重点
- **关键路径**：影响整体启动速度的瓶颈

### 7.3 常用优化策略


**立竿见影的优化方法**：

| 优化手段 | **效果** | **风险** | **适用场景** |
|---------|---------|---------|-------------|
| 🚫 **禁用不必要服务** | `显著` | `低-中` | `桌面/服务器清理` |
| ⚡ **并行启动优化** | `中等` | `低` | `多核系统` |
| 🔗 **依赖关系优化** | `中等` | `中` | `复杂服务环境` |
| 🌐 **网络等待优化** | `显著` | `低` | `网络环境稳定` |

### 7.4 实战要点提醒


> 💡 **优化原则**  
> 1. **先测量，后优化**：不测量就不知道瓶颈在哪
> 2. **一次改一个**：便于定位问题和回滚  
> 3. **测试再部署**：确保系统功能正常
> 4. **记录基准值**：便于对比优化效果

> ⚠️ **安全注意事项**  
> - 禁用服务前要充分了解其作用
> - 在测试环境先验证优化效果
> - 保留配置文件备份，便于快速回滚
> - 关键生产环境谨慎操作

**核心记忆口诀**：
- 🎯 systemd-analyze 是启动分析神器
- 📊 blame 找耗时，critical-chain 找路径  
- 🚀 userspace 是优化重点区域
- ⚡ 禁用不必要，并行提速度