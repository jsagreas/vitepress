---
title: 8、systemd启动目标与服务
---
## 📚 目录

1. [systemd概述](#1-systemd概述)
2. [Target目标概念详解](#2-target目标概念详解)
3. [常用启动目标](#3-常用启动目标)
4. [目标管理与切换](#4-目标管理与切换)
5. [systemd启动流程分析](#5-systemd启动流程分析)
6. [核心要点总结](#6-核心要点总结)

---

## 1. 🖥️ systemd概述


### 1.1 什么是systemd

**systemd**：现代Linux系统的初始化系统和服务管理器

```
传统init系统 vs systemd：

传统init（SysV）：
启动过程：内核 → init → 运行级别脚本 → 服务
特点：串行启动、速度慢、管理复杂

systemd：
启动过程：内核 → systemd → target目标 → 服务
特点：并行启动、速度快、统一管理
```

**🔸 systemd的核心优势**
- **并行启动**：多个服务同时启动，大幅提升启动速度
- **依赖管理**：自动处理服务之间的依赖关系
- **统一接口**：用一套命令管理所有系统组件
- **日志集成**：统一的日志管理系统

### 1.2 systemd架构组成


```
systemd生态系统：
┌─────────────────────────────────────┐
│              systemd                │
├─────────────────────────────────────┤
│  systemctl  │  journalctl  │ 其他工具 │
├─────────────────────────────────────┤
│   target    │   service    │  其他单元 │
├─────────────────────────────────────┤
│            内核空间                  │
└─────────────────────────────────────┘

核心组件：
• systemctl：主要管理命令
• journalctl：日志查看工具  
• systemd单元：服务、目标等管理对象
```

---

## 2. 🎯 Target目标概念详解


### 2.1 Target的基本概念


**Target（目标）**：systemd中定义系统运行状态的单元

> 💡 **通俗理解**：Target就像是"系统运行模式"的开关，决定了系统启动后处于什么状态

```
类比理解：
Target = 手机的使用模式
• 正常模式：所有功能都可用（graphical.target）
• 飞行模式：只有基本功能（multi-user.target）  
• 安全模式：最小功能集（emergency.target）
```

**🔸 Target与传统运行级别对比**

| 传统运行级别 | systemd Target | 说明 |
|-------------|---------------|------|
| 0 | poweroff.target | 系统关机 |
| 1 | rescue.target | 单用户救援模式 |
| 2,3,4 | multi-user.target | 多用户命令行模式 |
| 5 | graphical.target | 图形界面模式 |
| 6 | reboot.target | 系统重启 |

### 2.2 Target的工作原理


**Target的本质**：一组服务和其他单元的集合

```
Target组成示意：
graphical.target
├── multi-user.target
│   ├── network.service
│   ├── sshd.service
│   └── basic.target
│       ├── sysinit.target
│       └── local-fs.target
├── display-manager.service
└── plymouth-quit.service

理解要点：
• Target可以包含其他Target（层次结构）
• 启动Target = 启动其包含的所有服务
• 依赖关系自动处理
```

---

## 3. 🔧 常用启动目标


### 3.1 default.target（默认目标）


**default.target**：系统启动时的默认目标

```bash
# 查看当前默认目标
systemctl get-default

# 默认目标实际上是一个符号链接
ls -l /etc/systemd/system/default.target
# 输出：default.target -> /lib/systemd/system/graphical.target
```

> 📝 **关键理解**：default.target不是真正的目标，而是指向实际目标的"快捷方式"

### 3.2 multi-user.target（多用户模式）


**multi-user.target**：命令行多用户模式（类似传统运行级别3）

**🔸 包含的核心服务**：
- **网络服务**：网络连接和配置
- **SSH服务**：远程登录支持
- **系统日志**：rsyslog或systemd-journald
- **基础系统服务**：定时任务、设备管理等

```bash
# 查看multi-user.target包含的服务
systemctl list-dependencies multi-user.target

# 典型输出示例：
# ● ├─basic.target
# ● ├─getty.target
# ● ├─network.target
# ● └─sshd.service
```

**💡 使用场景**：
- 服务器环境（无需图形界面）
- 远程管理的系统
- 资源受限的环境

### 3.3 graphical.target（图形模式）


**graphical.target**：图形界面模式（类似传统运行级别5）

**🔸 构成关系**：
```
graphical.target = multi-user.target + 图形组件

包含内容：
• 所有multi-user.target的服务
• 图形显示管理器（如gdm、lightdm）
• 桌面环境相关服务
• 图形驱动服务
```

```bash
# 查看图形目标的依赖
systemctl list-dependencies graphical.target --all
```

### 3.4 emergency.target（紧急模式）


**emergency.target**：紧急救援模式，最小系统环境

**🔸 特点说明**：
- **只挂载根文件系统**（只读模式）
- **单用户环境**：只有root用户可登录
- **最少服务**：仅启动关键系统服务
- **无网络**：网络服务不启动

```bash
# 在GRUB菜单中添加参数进入紧急模式
# systemd.unit=emergency.target
```

> ⚠️ **使用场景**：系统严重故障、文件系统损坏时的最后救援手段

### 3.5 rescue.target（救援模式）


**rescue.target**：救援模式，比emergency稍完整的恢复环境

**🔸 rescue vs emergency 对比**：

| 特性 | rescue.target | emergency.target |
|------|---------------|-------------------|
| **文件系统** | 尝试挂载所有本地文件系统 | 只挂载根文件系统（只读） |
| **服务数量** | 启动基础系统服务 | 最小服务集 |
| **网络** | 可能有基础网络 | 无网络服务 |
| **使用时机** | 一般系统问题修复 | 严重系统故障 |

```bash
# 切换到救援模式
systemctl isolate rescue.target

# 或在启动时指定
# systemd.unit=rescue.target
```

---

## 4. 🎮 目标管理与切换


### 4.1 systemctl set-default（设置默认目标）


**设置系统默认启动目标**：

```bash
# 设置默认为命令行模式
sudo systemctl set-default multi-user.target

# 设置默认为图形模式  
sudo systemctl set-default graphical.target

# 验证设置
systemctl get-default
```

**🔸 实际操作过程**：
```bash
# set-default实际上是创建符号链接
# 删除旧链接，创建新链接
sudo rm /etc/systemd/system/default.target
sudo ln -s /lib/systemd/system/multi-user.target /etc/systemd/system/default.target
```

### 4.2 临时切换目标


**不重启切换运行目标**：

```bash
# 临时切换到命令行模式（当前会话）
sudo systemctl isolate multi-user.target

# 临时切换到图形模式
sudo systemctl isolate graphical.target

# 切换到救援模式
sudo systemctl isolate rescue.target
```

> 💡 **isolate含义**：隔离启动指定目标，停止不相关的服务

### 4.3 目标状态查看


```bash
# 查看当前活动目标
systemctl list-units --type=target

# 查看所有可用目标
systemctl list-unit-files --type=target

# 查看目标的详细信息
systemctl show graphical.target
```

---

## 5. ⚡ systemd启动流程分析


### 5.1 完整启动时序图


```
系统启动流程：
内核启动
    ↓
systemd进程（PID=1）
    ↓
读取default.target
    ↓
解析目标依赖关系
    ↓
并行启动必需服务
    ↓
┌─────────────┬─────────────┬─────────────┐
│ sysinit     │ basic       │ network     │
│ .target     │ .target     │ .target     │
└─────────────┴─────────────┴─────────────┘
    ↓
multi-user.target
    ↓
graphical.target（如果设置）
    ↓
系统就绪
```

### 5.2 启动阶段详解


**🔸 阶段一：内核移交控制**
```
过程：内核 → systemd
时机：内核初始化完成
动作：启动systemd进程（PID=1）
```

**🔸 阶段二：目标解析**
```
systemd读取：
1. /etc/systemd/system/default.target
2. 解析目标依赖关系
3. 确定启动服务清单
```

**🔸 阶段三：并行服务启动**
```bash
# 查看启动耗时分析
systemd-analyze

# 查看服务启动时间详情
systemd-analyze blame

# 查看启动过程图形分析
systemd-analyze plot > boot.svg
```

### 5.3 依赖关系管理


**systemd依赖类型**：

```
依赖关系类型：
• Requires：强依赖（依赖服务必须成功启动）
• Wants：弱依赖（依赖服务失败不影响本服务）
• Before/After：顺序依赖（控制启动顺序）
• Conflicts：冲突关系（不能同时运行）

示例理解：
graphical.target Requires multi-user.target
→ 图形模式必须先有命令行模式

network.service After network-pre.target
→ 网络服务在网络预备目标之后启动
```

```bash
# 查看服务依赖关系
systemctl list-dependencies sshd.service
systemctl list-dependencies --reverse sshd.service
```

---

## 6. 📋 核心要点总结


### 6.1 必须掌握的核心概念


```
🔸 systemd是什么：现代Linux的初始化系统，替代传统init
🔸 Target目标：定义系统运行状态，包含一组服务的集合
🔸 default.target：系统默认启动目标，实际是符号链接
🔸 常用目标：multi-user（命令行）、graphical（图形）、rescue（救援）
🔸 目标切换：set-default设置永久，isolate临时切换
```

### 6.2 实际应用要点


**🔹 服务器配置最佳实践**
```
服务器环境建议：
• 默认使用multi-user.target（节省资源）
• 按需临时切换到图形模式
• 了解救援模式用于故障排除
```

**🔹 故障排除思路**
```
系统启动问题排查：
1. 检查默认目标：systemctl get-default
2. 查看失败服务：systemctl --failed
3. 分析启动时间：systemd-analyze blame
4. 必要时使用救援模式
```

**🔹 常用管理命令**
```bash
# 目标管理三件套
systemctl get-default          # 查看默认目标
systemctl set-default TARGET   # 设置默认目标  
systemctl isolate TARGET       # 切换当前目标

# 状态查看三件套
systemctl list-units --type=target     # 查看活动目标
systemctl list-dependencies TARGET     # 查看目标依赖
systemd-analyze                         # 分析启动性能
```

### 6.3 核心记忆要点


> 🧠 **记忆口诀**：
> 
> systemd管理现代Linux，target目标定状态
> 
> default默认是链接，multi命令graphical图形
> 
> emergency最小救急用，rescue稍全修复佳
> 
> set-default设永久，isolate切换临时用

**关键理解**：
- **Target = 运行模式**：不同target代表系统的不同工作状态
- **层次依赖关系**：target之间有包含和依赖关系
- **并行启动优势**：systemd相比传统init的核心改进
- **统一管理接口**：systemctl是主要管理工具