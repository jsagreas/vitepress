---
title: 4、initrd与initramfs管理
---
## 📚 目录

1. [initrd与initramfs基本概念](#1-initrd与initramfs基本概念)
2. [initramfs文件系统结构深入](#2-initramfs文件系统结构深入)
3. [dracut与mkinitrd工具详解](#3-dracut与mkinitrd工具详解)
4. [initramfs模块管理与依赖](#4-initramfs模块管理与依赖)
5. [网络启动initramfs配置](#5-网络启动initramfs配置)
6. [加密文件系统initramfs支持](#6-加密文件系统initramfs支持)
7. [initramfs调试与故障排查](#7-initramfs调试与故障排查)
8. [自定义initramfs制作方法](#8-自定义initramfs制作方法)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🔧 initrd与initramfs基本概念


### 1.1 什么是initrd和initramfs


> **💡 核心理解**
> 简单来说，initrd和initramfs就像是系统启动时的"临时助手"，帮助内核找到真正的根文件系统

**initrd（Initial RAM Disk）**：
```
作用：最早期的临时文件系统
本质：一个压缩的文件系统镜像
位置：存储在磁盘上，启动时加载到内存
用途：包含启动必需的驱动和工具
```

**initramfs（Initial RAM File System）**：
```
作用：initrd的现代替代者
本质：直接打包进内核的文件系统
位置：内核镜像的一部分
用途：更灵活的启动支持
```

### 1.2 为什么需要这些临时文件系统


**🤔 思考场景：**
想象你的电脑就像一个房子，内核是主人，但主人刚醒来时眼睛还看不清楚（没有驱动），需要先戴眼镜（加载驱动）才能找到自己的衣服（根文件系统）。

```
启动过程对比：

没有initramfs的情况：
BIOS/UEFI → 内核 → ❌ 找不到根文件系统（缺少驱动）

有initramfs的情况：
BIOS/UEFI → 内核 → initramfs → 加载驱动 → 找到根文件系统 → 正常启动
```

**🎯 主要用途：**
- **驱动加载**：加载访问硬盘需要的驱动程序
- **文件系统支持**：支持复杂的文件系统类型
- **设备发现**：等待设备就绪（如USB设备）
- **网络启动**：支持从网络加载系统
- **加密支持**：解密加密的根分区

### 1.3 initrd vs initramfs 对比


| 特性 | **initrd** | **initramfs** |
|------|------------|---------------|
| **存储方式** | `独立的镜像文件` | `集成在内核中` |
| **文件系统** | `ext2等真实文件系统` | `tmpfs内存文件系统` |
| **内存使用** | `需要额外内存缓存` | `直接使用页缓存` |
| **现代支持** | `逐渐淘汰` | `主流使用` |
| **灵活性** | `较低` | `更高` |

> **⭐ 重点掌握**
> 现在几乎所有Linux发行版都使用initramfs，initrd基本已经被淘汰

---

## 2. 📁 initramfs文件系统结构深入


### 2.1 initramfs内部结构解析


**🔍 查看initramfs内容：**
```bash
# 复制当前系统的initramfs
cp /boot/initramfs-$(uname -r).img /tmp/

# 查看文件类型
file /tmp/initramfs-$(uname -r).img

# 解压查看内容（通常是gzip压缩的cpio归档）
cd /tmp && mkdir initramfs
cd initramfs
zcat ../initramfs-$(uname -r).img | cpio -id
```

**📋 典型目录结构：**
```
initramfs/
├── bin/                    # 基本命令工具
│   ├── bash               # shell环境
│   ├── mount              # 挂载命令
│   └── modprobe           # 模块加载工具
├── sbin/                  # 系统管理工具
│   ├── init               # 初始化脚本
│   └── udevd              # 设备管理守护进程
├── lib/                   # 库文件
│   ├── modules/           # 内核模块
│   └── udev/              # udev规则
├── lib64/                 # 64位库文件
├── etc/                   # 配置文件
│   ├── fstab              # 文件系统挂载表
│   └── udev/              # udev配置
├── dev/                   # 设备文件目录
├── proc/                  # proc文件系统挂载点
├── sys/                   # sysfs文件系统挂载点
├── tmp/                   # 临时文件目录
└── init                   # 主初始化脚本
```

### 2.2 核心文件详解


**init脚本（启动入口）：**
```bash
#!/bin/bash
# /init - initramfs的主入口脚本

# 挂载必要的文件系统
mount -t proc proc /proc
mount -t sysfs sysfs /sys
mount -t devtmpfs devtmpfs /dev

# 启动udev管理设备
udevd --daemon
udevadm trigger
udevadm settle

# 加载必要的内核模块
modprobe ext4
modprobe ahci

# 挂载真正的根文件系统
mount /dev/sda1 /sysroot

# 切换到真正的根文件系统
exec switch_root /sysroot /sbin/init
```

> **💡 理解要点**
> init脚本就像是一个"管家"，负责准备好一切环境，然后把控制权交给真正的系统

### 2.3 模块加载机制


**模块依赖关系：**
```bash
# 查看模块依赖
depmod -a

# 查看具体模块的依赖
modinfo ext4
modprobe --show-depends ext4
```

**关键模块类型：**
- **存储驱动**：`ahci`、`nvme`、`virtio_blk`
- **文件系统**：`ext4`、`xfs`、`btrfs`
- **网络驱动**：`e1000e`、`r8169`
- **USB支持**：`ehci_hcd`、`xhci_hcd`

---

## 3. 🛠️ dracut与mkinitrd工具详解


### 3.1 dracut工具深入使用


> **🔧 实践技巧**
> dracut是现代Linux发行版的标准initramfs构建工具，功能强大且模块化

**基本命令使用：**
```bash
# 重新生成当前内核的initramfs
dracut --force

# 为特定内核生成initramfs
dracut --force --kver 5.4.0-74-generic

# 添加调试信息
dracut --debug --force

# 添加特定模块
dracut --add "network nfs" --force

# 排除某些模块
dracut --omit "plymouth" --force
```

**重要配置文件：**
```bash
# /etc/dracut.conf - 主配置文件
add_drivers+="nvme ext4"          # 强制包含的驱动
omit_drivers+="floppy"            # 排除的驱动
add_dracutmodules+="network"      # 添加功能模块
omit_dracutmodules+="plymouth"    # 排除功能模块
```

### 3.2 dracut模块系统


**查看可用模块：**
```bash
# 列出所有可用模块
dracut --list-modules

# 查看当前initramfs包含的模块
lsinitrd /boot/initramfs-$(uname -r).img | grep -E "^drwx"
```

**常用模块说明：**
- **base**：基本功能模块
- **systemd**：systemd支持
- **udev-rules**：设备管理规则
- **network**：网络支持
- **crypt**：加密支持
- **lvm**：LVM支持

### 3.3 生成过程详解


```
dracut生成流程：

1. 读取配置文件 → /etc/dracut.conf
2. 检测硬件需求 → 自动发现需要的驱动
3. 收集文件 → 二进制文件、库文件、配置文件
4. 构建文件系统 → 创建目录结构
5. 生成init脚本 → 组合各模块的脚本
6. 压缩打包 → 生成最终的initramfs文件
```

> **⚠️ 注意事项**
> 生成initramfs时，确保系统有足够的空间，通常需要100-200MB的临时空间

---

## 4. ⚙️ initramfs模块管理与依赖


### 4.1 模块依赖关系管理


**理解模块依赖：**
```bash
# 查看模块信息
modinfo ext4
```

输出示例：
```
depends: mbcache,jbd2,crc16
```

这表示ext4模块依赖于mbcache、jbd2和crc16模块。

**依赖解析过程：**
```
模块A需要功能X → 查找提供功能X的模块B → 
检查模块B的依赖 → 递归解析所有依赖 → 
按正确顺序加载所有模块
```

### 4.2 自动依赖检测


**dracut如何检测依赖：**
```bash
# 检测当前系统的硬件
lspci -k    # 查看PCI设备及对应驱动
lsusb       # 查看USB设备
lsblk       # 查看块设备

# dracut根据这些信息自动包含必要模块
dracut --print-cmdline  # 显示会包含的模块
```

### 4.3 手动管理模块


**强制包含特定模块：**
```bash
# 临时添加
dracut --add-drivers "nvme e1000e" --force

# 永久配置（/etc/dracut.conf）
add_drivers+="nvme e1000e"
```

**排除不需要的模块：**
```bash
# 减少initramfs大小
echo 'omit_drivers+="floppy pcspkr"' >> /etc/dracut.conf
```

---

## 5. 🌐 网络启动initramfs配置


### 5.1 网络启动基本概念


> **💡 核心理解**
> 网络启动就像是"远程装系统"，系统文件存在网络服务器上，通过网络加载

**网络启动流程：**
```
客户端启动 → 获取IP地址(DHCP) → 下载内核和initramfs → 
加载网络驱动 → 挂载网络文件系统(NFS/iSCSI) → 启动系统
```

### 5.2 启用网络支持


**配置网络模块：**
```bash
# /etc/dracut.conf
add_dracutmodules+="network"
add_drivers+="e1000e r8169"  # 网络驱动

# 重新生成initramfs
dracut --force
```

**网络启动参数：**
```bash
# 内核启动参数
ip=192.168.1.100:192.168.1.1:255.255.255.0:client::eth0:off
root=nfs:192.168.1.50:/export/rootfs
```

参数解释：
- `192.168.1.100`：客户端IP
- `192.168.1.1`：网关
- `255.255.255.0`：子网掩码
- `client`：主机名
- `eth0`：网络接口
- `off`：不使用DHCP

### 5.3 NFS根文件系统


**服务器端配置：**
```bash
# 安装NFS服务
yum install nfs-utils

# 配置导出目录 /etc/exports
/export/rootfs 192.168.1.0/24(rw,no_root_squash,sync)

# 启动服务
systemctl start nfs-server
exportfs -ra
```

**客户端initramfs配置：**
```bash
# 确保包含NFS支持
echo 'add_dracutmodules+="nfs"' >> /etc/dracut.conf
```

---

## 6. 🔐 加密文件系统initramfs支持


### 6.1 LUKS加密支持


> **🔒 安全理解**
> 加密根分区就像给整个系统加了一把锁，启动时需要输入密码才能打开

**启用加密支持：**
```bash
# 添加加密模块
echo 'add_dracutmodules+="crypt"' >> /etc/dracut.conf

# 重新生成initramfs
dracut --force
```

### 6.2 配置加密启动


**设置加密分区：**
```bash
# 创建加密分区
cryptsetup luksFormat /dev/sda2

# 打开加密分区
cryptsetup luksOpen /dev/sda2 root_crypt

# 在加密分区上创建文件系统
mkfs.ext4 /dev/mapper/root_crypt
```

**内核启动参数：**
```bash
# GRUB配置中添加
rd.luks.uuid=<UUID> root=/dev/mapper/root_crypt
```

### 6.3 密钥文件支持


**使用密钥文件：**
```bash
# 创建密钥文件
dd if=/dev/random of=/root/keyfile bs=1024 count=4
chmod 400 /root/keyfile

# 添加密钥到LUKS
cryptsetup luksAddKey /dev/sda2 /root/keyfile

# 配置dracut包含密钥
echo 'install_items+="/root/keyfile"' >> /etc/dracut.conf
```

---

## 7. 🔍 initramfs调试与故障排查


### 7.1 启用调试模式


**生成带调试信息的initramfs：**
```bash
# 启用调试输出
dracut --debug --verbose --force

# 启用内核调试参数
# 在GRUB中添加：rd.debug rd.shell
```

### 7.2 常见启动问题排查


**❓ 常见疑问：**
**Q：系统提示找不到根设备？**
**A：** 通常是缺少存储驱动或设备识别延迟

**排查步骤：**
```bash
# 1. 检查initramfs是否包含正确的驱动
lsinitrd /boot/initramfs-$(uname -r).img | grep -i nvme

# 2. 检查根设备UUID是否正确
blkid /dev/sda1

# 3. 添加启动延迟
# GRUB中添加：rootdelay=10
```

**Q：加密分区无法解锁？**
**A：** 检查加密模块和密钥配置

```bash
# 检查是否包含crypt模块
lsinitrd | grep crypt

# 验证LUKS设备
cryptsetup luksDump /dev/sda2
```

### 7.3 emergency shell调试


**进入紧急shell：**
```bash
# 在GRUB中添加参数
rd.break=pre-mount

# 或者
rd.shell
```

**在紧急shell中的调试命令：**
```bash
# 查看可用设备
ls /dev/
lsblk

# 查看内核消息
dmesg | tail

# 手动挂载设备
mkdir /test
mount /dev/sda1 /test

# 查看模块加载情况
lsmod
```

---

## 8. 🛠️ 自定义initramfs制作方法


### 8.1 手工制作initramfs


> **🎯 实践应用**
> 有时需要完全自定义的initramfs，比如嵌入式系统或特殊需求

**基本制作步骤：**
```bash
# 1. 创建工作目录
mkdir /tmp/my-initramfs
cd /tmp/my-initramfs

# 2. 创建基本目录结构
mkdir -p {bin,sbin,etc,proc,sys,dev,lib,lib64,mnt,tmp}

# 3. 复制必要的二进制文件
cp /bin/bash bin/
cp /bin/mount bin/
cp /sbin/modprobe sbin/

# 4. 复制库文件依赖
# 使用ldd命令查看依赖
ldd /bin/bash
# 然后复制所需的库文件到lib/和lib64/

# 5. 创建init脚本
cat > init << 'EOF'
#!/bin/bash
mount -t proc proc /proc
mount -t sysfs sysfs /sys
mount -t devtmpfs devtmpfs /dev

# 你的自定义初始化代码

exec /bin/bash
EOF

chmod +x init

# 6. 打包成initramfs
find . | cpio -o -H newc | gzip > /boot/my-initramfs.img
```

### 8.2 脚本化制作


**自动化脚本示例：**
```bash
#!/bin/bash
# make-custom-initramfs.sh

WORKDIR="/tmp/custom-initramfs"
OUTPUT="/boot/custom-initramfs.img"

# 清理并创建工作目录
rm -rf $WORKDIR
mkdir -p $WORKDIR/{bin,sbin,etc,lib,lib64,dev,proc,sys,tmp}

# 复制程序及其依赖
copy_with_deps() {
    local prog=$1
    local destdir=$2
    
    cp $prog $WORKDIR/$destdir/
    
    # 复制库依赖
    ldd $prog | grep -E '\s+/' | awk '{print $3}' | while read lib; do
        if [[ -f $lib ]]; then
            cp $lib $WORKDIR/lib$(basename $lib | grep -q 64 && echo 64)/
        fi
    done
}

# 复制必要程序
copy_with_deps /bin/bash bin
copy_with_deps /bin/mount bin
copy_with_deps /sbin/modprobe sbin

# 创建自定义init
cat > $WORKDIR/init << 'EOF'
#!/bin/bash
echo "Custom initramfs starting..."
mount -t proc proc /proc
mount -t sysfs sysfs /sys
mount -t devtmpfs devtmpfs /dev

# 在这里添加你的自定义代码

echo "Dropping to shell..."
exec /bin/bash
EOF

chmod +x $WORKDIR/init

# 打包
cd $WORKDIR
find . | cpio -o -H newc | gzip > $OUTPUT
echo "Custom initramfs created: $OUTPUT"
```

### 8.3 与dracut集成


**创建自定义dracut模块：**
```bash
# 1. 创建模块目录
mkdir -p /usr/lib/dracut/modules.d/99custom

# 2. 创建模块脚本 module-setup.sh
cat > /usr/lib/dracut/modules.d/99custom/module-setup.sh << 'EOF'
#!/bin/bash
check() {
    return 0  # 总是包含此模块
}

depends() {
    return 0  # 没有依赖
}

install() {
    # 安装自定义脚本和文件
    inst_hook pre-mount 50 "$moddir/custom-script.sh"
    inst /usr/local/bin/custom-tool
}
EOF

# 3. 创建自定义脚本
cat > /usr/lib/dracut/modules.d/99custom/custom-script.sh << 'EOF'
#!/bin/bash
echo "Running custom pre-mount script"
# 你的自定义代码
EOF

chmod +x /usr/lib/dracut/modules.d/99custom/*.sh
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的核心概念


```
🔸 initrd/initramfs本质：启动时的临时文件系统，帮助内核找到真正的根文件系统
🔸 主要作用：加载驱动、支持复杂启动场景（网络、加密、LVM等）
🔸 现状：initramfs已替代initrd成为主流
🔸 核心工具：dracut是现代标准构建工具
🔸 调试方法：rd.debug、rd.shell等参数进行故障排查
```

### 9.2 关键理解要点


> **🧠 记忆要点：**
> - 口诀：`临时助手找真家，驱动加载不可差`
> - 关键词：`临时` + `驱动` + `启动` = `initramfs`
> - 类比：就像眼镜帮助近视的人看清楚一样，initramfs帮助内核"看清楚"硬件

**🔹 启动流程理解**
```
完整启动过程：
BIOS/UEFI → Bootloader → 内核 → initramfs → 真实根文件系统 → 完整系统

每个阶段的作用：
- BIOS/UEFI: 硬件初始化
- Bootloader: 加载内核和initramfs
- 内核: 管理硬件和进程
- initramfs: 准备启动环境
- 根文件系统: 完整的系统环境
```

### 9.3 实际应用价值


**⭐ 重点掌握场景：**
- **系统管理员**：理解启动故障排查，自定义启动环境
- **运维工程师**：网络启动、批量部署、灾难恢复
- **安全工程师**：加密文件系统、安全启动配置
- **嵌入式开发**：定制化启动环境、资源受限场景

**🎯 实践技能：**
- 使用dracut重新生成initramfs解决启动问题
- 配置网络启动环境用于批量部署
- 设置加密根分区保护数据安全
- 调试启动问题并快速定位原因

**核心记忆**：
- initramfs是Linux启动过程中的"临时工作台"
- 掌握dracut工具是管理现代Linux系统的必备技能
- 理解启动流程有助于快速诊断和解决系统问题
- 网络启动和加密支持是企业级应用的重要特性