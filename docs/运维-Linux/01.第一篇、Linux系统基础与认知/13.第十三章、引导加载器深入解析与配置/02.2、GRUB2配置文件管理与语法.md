---
title: 2、GRUB2配置文件管理与语法
---
## 📚 目录

1. [GRUB2配置文件体系概览](#1-GRUB2配置文件体系概览)
2. [主配置文件grub.cfg深入解析](#2-主配置文件grub.cfg深入解析)
3. [默认配置文件/etc/default/grub详解](#3-默认配置文件/etc/default/grub详解)
4. [配置脚本目录/etc/grub.d/解析](#4-配置脚本目录/etc/grub.d/解析)
5. [GRUB2配置语法基础](#5-GRUB2配置语法基础)
6. [配置生成与管理命令](#6-配置生成与管理命令)
7. [自定义启动菜单编写](#7-自定义启动菜单编写)
8. [配置备份与版本控制](#8-配置备份与版本控制)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🏗️ GRUB2配置文件体系概览


### 1.1 GRUB2配置文件架构


> **💡 核心理解**
> GRUB2不像传统引导器有单一配置文件，而是采用"模板+脚本=最终配置"的分层架构

**配置文件体系结构**：
```
GRUB2配置体系
├── /boot/grub2/grub.cfg          ← 最终生成的主配置文件（不要直接编辑）
├── /etc/default/grub            ← 全局默认参数配置
├── /etc/grub.d/                 ← 配置生成脚本目录
│   ├── 00_header               ← 生成配置文件头部
│   ├── 10_linux                ← 扫描Linux内核
│   ├── 20_linux_xen            ← Xen虚拟化支持
│   ├── 30_os-prober            ← 其他操作系统检测
│   ├── 40_custom               ← 用户自定义条目
│   └── 41_custom               ← 额外自定义条目
└── /boot/grub2/grubenv         ← 运行时环境变量
```

### 1.2 工作流程机制


**GRUB2配置生成过程**：
```
用户修改配置
    ↓
/etc/default/grub        /etc/grub.d/* 脚本
    ↓                         ↓
         grub2-mkconfig 命令
                ↓
        /boot/grub2/grub.cfg
                ↓
           系统启动时读取
```

> **⚠️ 常见误区**  
> 很多新手直接编辑 `/boot/grub2/grub.cfg`，这是错误的！该文件会被 `grub2-mkconfig` 覆盖

### 1.3 配置文件优先级


**处理顺序**：
```
1. /etc/grub.d/00_header    → 基础设置和环境
2. /etc/grub.d/10_linux     → 当前系统内核条目  
3. /etc/grub.d/20_linux_xen → Xen相关条目
4. /etc/grub.d/30_os-prober → 其他操作系统
5. /etc/grub.d/40_custom    → 用户自定义条目
6. /etc/grub.d/41_custom    → 额外自定义条目
```

---

## 2. 📄 主配置文件grub.cfg深入解析


### 2.1 grub.cfg文件结构


**文件位置**：
- **UEFI系统**：`/boot/efi/EFI/centos/grub.cfg` 或 `/boot/grub2/grub.cfg`
- **BIOS系统**：`/boot/grub2/grub.cfg`

**典型grub.cfg结构**：
```bash
# 文件头部 - 环境变量设置
set timeout=5
set default="0"

# 菜单条目定义
menuentry 'CentOS Linux (4.18.0-80.el8.x86_64)' {
    set gfxpayload=keep
    insmod gzio
    insmod part_gpt
    insmod ext2
    search --no-floppy --fs-uuid --set=root aa11bb22-cc33-dd44
    linux /vmlinuz-4.18.0-80.el8.x86_64 root=/dev/sda1 ro
    initrd /initramfs-4.18.0-80.el8.x86_64.img
}

# 其他操作系统条目
menuentry 'Windows Boot Manager' {
    insmod part_gpt
    insmod fat
    search --no-floppy --fs-uuid --set=root 1234-5678
    chainloader /EFI/Microsoft/Boot/bootmgfw.efi
}
```

### 2.2 grub.cfg关键组成部分


**全局设置部分**：
```bash
# 超时时间（秒）
set timeout=5

# 默认启动项（从0开始计数）
set default="0"

# 菜单分辨率
set gfxmode=1024x768

# 主题设置
set theme=/boot/grub2/themes/system/theme.txt
```

**模块加载部分**：
```bash
# 文件系统支持
insmod ext2     # ext2/3/4文件系统
insmod xfs      # XFS文件系统  
insmod fat      # FAT文件系统

# 硬件支持
insmod part_gpt # GPT分区表
insmod part_msdos # MBR分区表

# 压缩支持
insmod gzio     # gzip压缩
```

> **🔍 深入思考**
> 为什么要加载这些模块？GRUB2采用模块化设计，只加载需要的功能以节省内存

### 2.3 menuentry条目解析


**标准Linux条目结构**：
```bash
menuentry 'CentOS Linux (4.18.0-80.el8.x86_64)' {
    # 设置图形模式
    set gfxpayload=keep
    
    # 加载必要模块
    insmod gzio
    insmod part_gpt
    insmod ext2
    
    # 搜索根文件系统
    search --no-floppy --fs-uuid --set=root aa11bb22-cc33-dd44
    
    # 加载内核
    linux /vmlinuz-4.18.0-80.el8.x86_64 root=/dev/sda1 ro quiet
    
    # 加载初始RAM磁盘
    initrd /initramfs-4.18.0-80.el8.x86_64.img
}
```

**参数含义解释**：
- `gfxpayload=keep`：保持图形模式到内核
- `search --fs-uuid`：通过UUID查找分区（更可靠）
- `linux`：指定内核文件和启动参数
- `initrd`：指定初始化RAM磁盘

---

## 3. ⚙️ 默认配置文件/etc/default/grub详解


### 3.1 /etc/default/grub核心参数


> **💡 核心理解**
> 这个文件控制GRUB2的全局行为，修改后需要运行 `grub2-mkconfig` 才能生效

**基础配置示例**：
```bash
# 默认启动项
GRUB_DEFAULT=0

# 菜单超时时间（秒）
GRUB_TIMEOUT=5

# 分发版标识
GRUB_DISTRIBUTOR="$(sed 's, release .*$,,g' /etc/system-release)"

# 内核命令行参数
GRUB_CMDLINE_LINUX="crashkernel=auto rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet"

# 禁用子菜单
GRUB_DISABLE_SUBMENU=true

# 启用OS检测
GRUB_DISABLE_OS_PROBER=false
```

### 3.2 重要参数详解


**GRUB_DEFAULT - 默认启动项**：
```bash
# 数字方式（推荐）
GRUB_DEFAULT=0              # 第一个条目
GRUB_DEFAULT=1              # 第二个条目

# 名称方式
GRUB_DEFAULT="CentOS Linux (4.18.0-80.el8.x86_64)"

# 记忆上次选择
GRUB_DEFAULT=saved
GRUB_SAVEDEFAULT=true
```

**GRUB_TIMEOUT - 超时控制**：
```bash
GRUB_TIMEOUT=5              # 5秒后自动启动
GRUB_TIMEOUT=0              # 立即启动，不显示菜单
GRUB_TIMEOUT=-1             # 无限等待
```

**GRUB_CMDLINE_LINUX - 内核参数**：
```bash
GRUB_CMDLINE_LINUX="quiet splash"           # 安静启动，显示图形
GRUB_CMDLINE_LINUX="rhgb quiet"            # Red Hat图形启动
GRUB_CMDLINE_LINUX="console=tty0 console=ttyS0,115200"  # 双控制台
```

### 3.3 高级参数配置


**外观和主题**：
```bash
# 终端输出
GRUB_TERMINAL_OUTPUT="gfxterm"

# 背景图片
GRUB_BACKGROUND="/boot/grub2/splash.png"

# 主题
GRUB_THEME="/boot/grub2/themes/system/theme.txt"

# 字体
GRUB_FONT="/boot/grub2/fonts/unicode.pf2"
```

**隐藏和显示选项**：
```bash
# 隐藏菜单（除非按键）
GRUB_TIMEOUT_STYLE=hidden

# 禁用恢复模式条目
GRUB_DISABLE_RECOVERY="true"

# 禁用子菜单
GRUB_DISABLE_SUBMENU=true
```

---

## 4. 📁 配置脚本目录/etc/grub.d/解析


### 4.1 脚本目录结构与作用


**脚本执行顺序**：
```bash
/etc/grub.d/
├── 00_header        # 输出配置文件头部信息
├── 10_linux         # 搜索当前系统Linux内核
├── 20_linux_xen     # 搜索Xen hypervisor
├── 30_os-prober     # 搜索其他操作系统
├── 40_custom        # 用户自定义条目
└── 41_custom        # 额外用户自定义条目
```

> **📌 重要提示**
> 脚本按数字顺序执行，数字越小优先级越高

### 4.2 关键脚本详解


**00_header脚本**：
```bash
# 功能：生成配置文件头部
# 读取 /etc/default/grub 中的设置
# 输出基本环境变量和模块加载

# 主要输出内容：
set timeout=5
set default="0"
load_env
set theme=/boot/grub2/themes/system/theme.txt
```

**10_linux脚本**：
```bash
# 功能：自动扫描 /boot 目录下的内核文件
# 为每个内核生成标准启动条目
# 包括普通模式和恢复模式

# 扫描路径：
/boot/vmlinuz-*         # 内核文件
/boot/initramfs-*.img   # 初始RAM磁盘
```

**30_os-prober脚本**：
```bash
# 功能：检测其他操作系统
# 依赖 os-prober 软件包
# 自动生成多系统启动条目

# 检测系统类型：
- Windows系统
- 其他Linux发行版
- macOS（在支持的硬件上）
```

### 4.3 自定义脚本使用


**40_custom脚本示例**：
```bash
#!/bin/sh
exec tail -n +3 $0

# 自定义启动条目
menuentry "我的自定义Linux" {
    set root='hd0,gpt2'
    linux /vmlinuz-custom root=/dev/sda2 ro
    initrd /initramfs-custom.img
}

menuentry "内存测试 (Memtest86+)" {
    set root='hd0,gpt1'
    linux16 /memtest86+.bin
}
```

**脚本权限设置**：
```bash
# 设置可执行权限
chmod +x /etc/grub.d/40_custom

# 禁用某个脚本
chmod -x /etc/grub.d/30_os-prober
```

---

## 5. 📝 GRUB2配置语法基础


### 5.1 基本语法元素


**变量设置**：
```bash
# 设置变量
set timeout=5
set default="0"
set root='hd0,gpt2'

# 变量引用
echo "当前根设备: $root"
echo "超时时间: ${timeout}秒"
```

**条件判断**：
```bash
# if-then-else语句
if [ "$grub_platform" = "efi" ]; then
    insmod efi_gop
    insmod efi_uga
else
    insmod vbe
    insmod vga
fi

# 文件存在判断
if [ -f /boot/grub2/themes/system/theme.txt ]; then
    set theme=/boot/grub2/themes/system/theme.txt
fi
```

### 5.2 菜单条目语法


**标准menuentry结构**：
```bash
menuentry "显示名称" [选项] {
    # 命令序列
    set root='设备标识'
    linux /内核路径 内核参数
    initrd /initramfs路径
}
```

**设备表示方法**：
```bash
# GRUB设备命名规则
hd0,gpt1    # 第一块硬盘的第一个GPT分区
hd0,msdos1  # 第一块硬盘的第一个MBR分区
hd1,gpt3    # 第二块硬盘的第三个GPT分区

# UUID方式（推荐）
search --no-floppy --fs-uuid --set=root aa11bb22-cc33-dd44
```

### 5.3 常用命令详解


**文件系统操作**：
```bash
# 搜索文件系统
search --file=/vmlinuz --set=root

# 挂载设备
set root='hd0,gpt2'

# 检查文件存在
test -f /boot/vmlinuz-5.4.0-42-generic
```

**模块管理**：
```bash
# 加载模块
insmod ext2        # 加载ext2文件系统支持
insmod part_gpt    # 加载GPT分区支持

# 列出已加载模块
lsmod
```

**内核启动**：
```bash
# 加载Linux内核
linux /vmlinuz-5.4.0 root=/dev/sda1 ro quiet splash

# 加载初始RAM磁盘
initrd /initramfs-5.4.0.img

# 启动系统
boot
```

---

## 6. 🔧 配置生成与管理命令


### 6.1 grub2-mkconfig核心命令


> **💡 核心理解**
> `grub2-mkconfig` 是GRUB2配置的核心命令，它读取模板和脚本，生成最终的配置文件

**基本用法**：
```bash
# 生成配置文件（标准用法）
grub2-mkconfig -o /boot/grub2/grub.cfg

# 预览生成内容（不写入文件）
grub2-mkconfig

# 在某些发行版中的别名
update-grub     # Ubuntu/Debian
grub-mkconfig   # 某些系统的命令名
```

**命令选项**：
```bash
grub2-mkconfig [选项]
  -o FILE, --output=FILE    指定输出文件
  -v, --version            显示版本信息
  -h, --help              显示帮助信息
```

### 6.2 配置管理工作流程


**标准配置修改流程**：
```bash
# 步骤1：备份当前配置
cp /boot/grub2/grub.cfg /boot/grub2/grub.cfg.backup

# 步骤2：修改配置文件
vim /etc/default/grub

# 步骤3：重新生成配置
grub2-mkconfig -o /boot/grub2/grub.cfg

# 步骤4：验证配置
grub2-script-check /boot/grub2/grub.cfg
```

### 6.3 其他有用命令


**grub2-editenv - 环境变量管理**：
```bash
# 查看环境变量
grub2-editenv list

# 设置环境变量
grub2-editenv /boot/grub2/grubenv set saved_entry=0

# 清除环境变量
grub2-editenv /boot/grub2/grubenv unset saved_entry
```

**grub2-script-check - 语法检查**：
```bash
# 检查配置文件语法
grub2-script-check /boot/grub2/grub.cfg

# 检查自定义脚本
grub2-script-check /etc/grub.d/40_custom
```

---

## 7. ✏️ 自定义启动菜单编写


### 7.1 添加自定义条目的方法


**方法一：编辑40_custom文件**
```bash
# 编辑自定义配置
vim /etc/grub.d/40_custom

# 添加内容：
#!/bin/sh
exec tail -n +3 $0

# 自定义Windows条目
menuentry "Windows 10" {
    insmod part_gpt
    insmod fat
    search --no-floppy --fs-uuid --set=root 1A2B-3C4D
    chainloader /EFI/Microsoft/Boot/bootmgfw.efi
}
```

**方法二：创建新的脚本文件**：
```bash
# 创建新脚本
vim /etc/grub.d/09_custom

# 设置权限
chmod +x /etc/grub.d/09_custom
```

### 7.2 常见自定义条目示例


**内存测试条目**：
```bash
menuentry "内存测试 (Memtest86+)" {
    set root='hd0,gpt1'
    linux16 /boot/memtest86+.bin
}
```

**系统恢复条目**：
```bash
menuentry "系统救援模式" {
    set root='hd0,gpt2' 
    linux /vmlinuz-rescue root=/dev/sda2 ro single
    initrd /initramfs-rescue.img
}
```

**ISO镜像启动**：
```bash
menuentry "Ubuntu Live CD" {
    set isofile="/boot/ubuntu-20.04.iso"
    loopback loop (hd0,gpt1)$isofile
    linux (loop)/casper/vmlinuz boot=casper iso-scan/filename=$isofile
    initrd (loop)/casper/initrd
}
```

### 7.3 高级自定义技巧


**子菜单创建**：
```bash
submenu "高级选项" {
    menuentry "调试模式" {
        # 调试启动配置
    }
    
    menuentry "安全模式" {
        # 安全启动配置
    }
}
```

**条件启动条目**：
```bash
# 仅在UEFI模式下显示
if [ "$grub_platform" = "efi" ]; then
    menuentry "UEFI Shell" {
        chainloader /EFI/tools/shell.efi
    }
fi
```

---

## 8. 💾 配置备份与版本控制


### 8.1 配置备份策略


**自动备份脚本**：
```bash
#!/bin/bash
# grub_backup.sh - GRUB2配置备份脚本

BACKUP_DIR="/root/grub_backups"
DATE=$(date +"%Y%m%d_%H%M%S")

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份主配置文件
cp /boot/grub2/grub.cfg $BACKUP_DIR/grub.cfg.$DATE

# 备份默认配置
cp /etc/default/grub $BACKUP_DIR/grub.defaults.$DATE

# 备份自定义脚本
tar -czf $BACKUP_DIR/grub.d.$DATE.tar.gz /etc/grub.d/

echo "GRUB2配置已备份到 $BACKUP_DIR"
```

**备份还原方法**：
```bash
# 还原配置文件
cp /root/grub_backups/grub.cfg.20241201_143000 /boot/grub2/grub.cfg

# 还原默认设置
cp /root/grub_backups/grub.defaults.20241201_143000 /etc/default/grub

# 重新生成配置（推荐）
grub2-mkconfig -o /boot/grub2/grub.cfg
```

### 8.2 版本控制管理


**使用Git管理GRUB配置**：
```bash
# 初始化Git仓库
cd /etc
git init grub_config
cd grub_config

# 创建符号链接
ln -s ../default/grub grub_defaults
ln -s ../grub.d grub_scripts

# 提交初始版本
git add .
git commit -m "初始GRUB2配置"

# 修改后提交更改
git add .
git commit -m "修改超时时间为10秒"
```

### 8.3 配置验证和测试


**配置验证清单**：
```bash
# 1. 语法检查
grub2-script-check /boot/grub2/grub.cfg

# 2. 配置文件存在性检查
test -f /boot/grub2/grub.cfg && echo "主配置文件存在"

# 3. 内核文件检查
ls -la /boot/vmlinuz-* | head -5

# 4. 分区UUID验证
blkid | grep -E "(sda1|sda2)"

# 5. 模块依赖检查
grep "insmod" /boot/grub2/grub.cfg | sort | uniq
```

> **⚠️ 安全提醒**  
> 修改GRUB配置前务必备份，错误的配置可能导致系统无法启动

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的基础概念


```
🔸 配置文件体系：/boot/grub2/grub.cfg + /etc/default/grub + /etc/grub.d/
🔸 工作原理：模板文件 + 生成脚本 = 最终配置
🔸 核心命令：grub2-mkconfig生成配置，不要直接编辑grub.cfg
🔸 关键参数：GRUB_DEFAULT、GRUB_TIMEOUT、GRUB_CMDLINE_LINUX
🔸 自定义方法：通过40_custom脚本添加自定义启动条目
```

### 9.2 关键理解要点


**🔹 为什么不直接编辑grub.cfg**
```
原因分析：
• grub.cfg是自动生成的文件
• 运行grub2-mkconfig会覆盖手动修改
• 正确做法是修改模板文件和脚本
• 这样保证配置的一致性和可维护性
```

**🔹 配置修改的正确流程**
```
标准流程：
1. 备份当前配置
2. 修改 /etc/default/grub 或 /etc/grub.d/ 脚本
3. 运行 grub2-mkconfig 重新生成
4. 验证配置正确性
5. 重启测试
```

**🔹 自定义条目的最佳实践**
```
推荐做法：
• 使用40_custom文件添加简单条目
• 复杂条目创建独立脚本文件
• 设置正确的文件权限（+x）
• 使用UUID而不是设备名
• 添加适当的注释说明
```

### 9.3 实际应用价值


**📊 学习进度评估**：
学习进度：`████████░░` 80%
难度等级：`⭐⭐⭐☆☆` 中等

**🎯 必备技能清单**：
- [ ] 理解GRUB2配置文件体系结构
- [ ] 掌握/etc/default/grub关键参数配置
- [ ] 学会使用grub2-mkconfig命令
- [ ] 能够编写基本的自定义启动条目
- [ ] 掌握配置备份和恢复方法

**🚀 进阶学习路径**：
```
基础配置 → 自定义条目 → 高级语法 → 故障排除
    ↓         ↓         ↓         ↓
  [掌握]    [实践]    [深入]    [专家]
```

**💪 实践建议**：
- 在虚拟机中练习配置修改
- 尝试创建多系统启动菜单
- 学习使用GRUB2救援模式
- 编写自动化配置脚本

**核心记忆口诀**：
- GRUB配置分三层，模板脚本生成全
- 默认配置在default，自定义条目用custom
- mkconfig命令要记牢，备份还原保安全
- 语法简单易上手，UUID设备更可靠