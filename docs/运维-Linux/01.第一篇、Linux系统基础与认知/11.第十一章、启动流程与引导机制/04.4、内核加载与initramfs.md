---
title: 4ã€å†…æ ¸åŠ è½½ä¸initramfs
---
## ğŸ“š ç›®å½•

1. [Linuxå†…æ ¸é•œåƒæ ¼å¼è¯¦è§£](#1-Linuxå†…æ ¸é•œåƒæ ¼å¼è¯¦è§£)
2. [initrd vs initramfs æ ¸å¿ƒåŒºåˆ«](#2-initrd-vs-initramfs-æ ¸å¿ƒåŒºåˆ«)
3. [åˆå§‹RAMæ–‡ä»¶ç³»ç»Ÿçš„ä½œç”¨æœºåˆ¶](#3-åˆå§‹RAMæ–‡ä»¶ç³»ç»Ÿçš„ä½œç”¨æœºåˆ¶)
4. [dracutä¸mkinitrdå·¥å…·æ·±åº¦è§£æ](#4-dracutä¸mkinitrdå·¥å…·æ·±åº¦è§£æ)
5. [å†…æ ¸æ¨¡å—åŠ è½½é¡ºåºä¸æœºåˆ¶](#5-å†…æ ¸æ¨¡å—åŠ è½½é¡ºåºä¸æœºåˆ¶)
6. [rootæ–‡ä»¶ç³»ç»ŸæŒ‚è½½å…¨æµç¨‹](#6-rootæ–‡ä»¶ç³»ç»ŸæŒ‚è½½å…¨æµç¨‹)
7. [å†…æ ¸å‘½ä»¤è¡Œå‚æ•°è¯¦è§£](#7-å†…æ ¸å‘½ä»¤è¡Œå‚æ•°è¯¦è§£)
8. [initramfsè°ƒè¯•ä¸æ•…éšœæ’æŸ¥å®æˆ˜](#8-initramfsè°ƒè¯•ä¸æ•…éšœæ’æŸ¥å®æˆ˜)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ–¥ï¸ Linuxå†…æ ¸é•œåƒæ ¼å¼è¯¦è§£


### 1.1 ä»€ä¹ˆæ˜¯Linuxå†…æ ¸é•œåƒ


**ç®€å•ç†è§£**ï¼šLinuxå†…æ ¸é•œåƒå°±åƒä¸€ä¸ª"**è¶…çº§ç¨‹åºåŒ…**"ï¼Œé‡Œé¢è£…ç€æ“ä½œç³»ç»Ÿçš„æ ¸å¿ƒä»£ç ã€‚

```
ç”Ÿæ´»ç±»æ¯”ï¼š
å†…æ ¸é•œåƒ = æ‰‹æœºçš„æ“ä½œç³»ç»ŸROMåŒ…
â€¢ åŒ…å«æ‰€æœ‰åŸºç¡€åŠŸèƒ½
â€¢ å¼€æœºåç¬¬ä¸€ä¸ªè¢«åŠ è½½
â€¢ å†³å®šäº†ç³»ç»Ÿèƒ½åšä»€ä¹ˆ
```

**ğŸ” å†…æ ¸é•œåƒæœ¬è´¨**ï¼š
- **ç¼–è¯‘äº§ç‰©**ï¼šæºä»£ç ç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶
- **è‡ªåŒ…å«**ï¼šåŒ…å«å¯åŠ¨ç³»ç»Ÿæ‰€éœ€çš„æœ€å°åŠŸèƒ½é›†
- **å‹ç¼©æ ¼å¼**ï¼šä¸ºèŠ‚çœå­˜å‚¨ç©ºé—´ï¼Œé€šå¸¸è¢«å‹ç¼©

### 1.2 å¸¸è§å†…æ ¸é•œåƒæ ¼å¼å¯¹æ¯”


| æ ¼å¼ç±»å‹ | **æ–‡ä»¶å** | **ç‰¹ç‚¹** | **é€‚ç”¨åœºæ™¯** | **å¤§å°** |
|---------|-----------|---------|-------------|---------|
| ğŸ”¸ **vmlinux** | `vmlinux` | `æœªå‹ç¼©çš„ELFæ ¼å¼` | `è°ƒè¯•ã€åˆ†æ` | `æœ€å¤§(~20MB)` |
| ğŸ”¸ **vmlinuz** | `vmlinuz-ç‰ˆæœ¬å·` | `å‹ç¼©çš„å†…æ ¸é•œåƒ` | `å®é™…å¼•å¯¼` | `ä¸­ç­‰(~5-8MB)` |
| ğŸ”¸ **bzImage** | `bzImage` | `å¤§å†…æ ¸å‹ç¼©é•œåƒ` | `x86æ¶æ„ä¸»æµ` | `è¾ƒå°(~4-6MB)` |
| ğŸ”¸ **zImage** | `zImage` | `å°å†…æ ¸å‹ç¼©é•œåƒ` | `è€å¼x86ç³»ç»Ÿ` | `æœ€å°(~2-4MB)` |

### 1.3 å†…æ ¸é•œåƒç»“æ„è§£æ


**ğŸ—ï¸ vmlinuzå†…éƒ¨ç»“æ„**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    å¼•å¯¼å¤´éƒ¨ä¿¡æ¯          â”‚ â† å¼•å¯¼åŠ è½½å™¨è¯†åˆ«
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    å‹ç¼©çš„å†…æ ¸ä»£ç         â”‚ â† å®é™…çš„æ“ä½œç³»ç»Ÿæ ¸å¿ƒ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    è§£å‹ç¼©ä»£ç            â”‚ â† è‡ªè§£å‹åŠŸèƒ½
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åŠ è½½è¿‡ç¨‹ï¼š
1. å¼•å¯¼åŠ è½½å™¨è¯»å–å¤´éƒ¨ä¿¡æ¯
2. å°†æ•´ä¸ªé•œåƒåŠ è½½åˆ°å†…å­˜
3. è·³è½¬åˆ°è§£å‹ç¼©ä»£ç 
4. å†…æ ¸è‡ªè§£å‹åˆ°å†…å­˜
5. å¼€å§‹æ‰§è¡Œå†…æ ¸åˆå§‹åŒ–
```

**ğŸ’¡ å…³é”®æ¦‚å¿µç†è§£**ï¼š

**bzImage vs zImage**ï¼š
```
zImageï¼ˆè€å¼ï¼‰ï¼š
â€¢ é™åˆ¶ï¼šå†…æ ¸å¤§å° < 512KB
â€¢ åŠ è½½ä½ç½®ï¼šä½ç«¯å†…å­˜(640KBä»¥ä¸‹)
â€¢ ç°çŠ¶ï¼šåŸºæœ¬æ·˜æ±°

bzImageï¼ˆç°ä»£ï¼‰ï¼š
â€¢ æ— å¤§å°é™åˆ¶
â€¢ åŠ è½½ä½ç½®ï¼šé«˜ç«¯å†…å­˜(1MBä»¥ä¸Š)
â€¢ ç°çŠ¶ï¼šä¸»æµä½¿ç”¨
```

### 1.4 æŸ¥çœ‹å†…æ ¸é•œåƒä¿¡æ¯


**ğŸ”§ å®ç”¨å‘½ä»¤**ï¼š
```bash
# æŸ¥çœ‹å½“å‰è¿è¡Œå†…æ ¸ç‰ˆæœ¬
uname -r

# æŸ¥çœ‹å†…æ ¸é•œåƒæ–‡ä»¶
ls -la /boot/vmlinuz-*

# æŸ¥çœ‹å†…æ ¸ç¼–è¯‘ä¿¡æ¯
cat /proc/version

# æŸ¥çœ‹å†…æ ¸é…ç½®é€‰é¡¹
zcat /proc/config.gz | head -20
```

**ğŸ“Š è¾“å‡ºç¤ºä¾‹**ï¼š
```
/boot/
â”œâ”€â”€ vmlinuz-5.15.0-72-generic     # å®é™…å†…æ ¸é•œåƒ
â”œâ”€â”€ initrd.img-5.15.0-72-generic  # åˆå§‹RAMç£ç›˜
â”œâ”€â”€ System.map-5.15.0-72-generic  # å†…æ ¸ç¬¦å·è¡¨
â””â”€â”€ config-5.15.0-72-generic      # å†…æ ¸ç¼–è¯‘é…ç½®
```

---

## 2. ğŸ’¾ initrd vs initramfs æ ¸å¿ƒåŒºåˆ«


### 2.1 å†å²èƒŒæ™¯ï¼šä¸ºä»€ä¹ˆéœ€è¦åˆå§‹æ–‡ä»¶ç³»ç»Ÿ


**é—®é¢˜åœºæ™¯**ï¼šæƒ³è±¡ä½ è¦å¯åŠ¨ç”µè„‘ï¼Œä½†æ˜¯...

```
ğŸ¯ ç»å…¸é—®é¢˜ï¼š
å¯åŠ¨æ‚–è®ºï¼š
â€¢ å†…æ ¸éœ€è¦é©±åŠ¨ç¨‹åºæ¥è®¿é—®ç¡¬ç›˜
â€¢ ä½†é©±åŠ¨ç¨‹åºå­˜å‚¨åœ¨ç¡¬ç›˜ä¸Š
â€¢ è¿™å°±åƒ"é¸¡ç”Ÿè›‹è¿˜æ˜¯è›‹ç”Ÿé¸¡"çš„é—®é¢˜

è§£å†³æ€è·¯ï¼š
â€¢ å‡†å¤‡ä¸€ä¸ªä¸´æ—¶çš„"è™šæ‹Ÿç¡¬ç›˜"
â€¢ é‡Œé¢è£…ä¸Šå¿…éœ€çš„é©±åŠ¨å’Œå·¥å…·
â€¢ å…ˆç”¨è¿™ä¸ªä¸´æ—¶ç³»ç»Ÿå¯åŠ¨
â€¢ ç„¶ååˆ‡æ¢åˆ°çœŸæ­£çš„æ–‡ä»¶ç³»ç»Ÿ
```

### 2.2 initrdï¼šåˆä»£è§£å†³æ–¹æ¡ˆ


**ğŸ”¸ initrdå…¨ç§°**ï¼š**Init**ial **RAM** **D**iskï¼ˆåˆå§‹RAMç£ç›˜ï¼‰

**å·¥ä½œåŸç†**ï¼š
```
ä¼ ç»Ÿæ–¹å¼ç±»æ¯”ï¼š
initrd = éšèº«æºå¸¦çš„å·¥å…·ç®±
â€¢ åˆ¶ä½œï¼šæŠŠå·¥å…·è£…è¿›ä¸€ä¸ªå›ºå®šå¤§å°çš„ç®±å­
â€¢ ä½¿ç”¨ï¼šæ‰“å¼€ç®±å­ï¼Œæ‹¿å‡ºéœ€è¦çš„å·¥å…·
â€¢ é™åˆ¶ï¼šç®±å­å¤§å°å›ºå®šï¼Œè£…æ»¡å°±è£…ä¸ä¸‹äº†

æŠ€æœ¯å®ç°ï¼š
1. åˆ›å»ºä¸€ä¸ªå›ºå®šå¤§å°çš„è™šæ‹Ÿç£ç›˜
2. æ ¼å¼åŒ–ä¸ºext2æ–‡ä»¶ç³»ç»Ÿ
3. è£…å…¥å¿…éœ€çš„é©±åŠ¨å’Œè„šæœ¬
4. å‹ç¼©åéšå†…æ ¸ä¸€èµ·åŠ è½½
```

**ğŸ“‹ initrdç‰¹ç‚¹**ï¼š
```
ä¼˜ç‚¹ï¼š
âœ… æ¦‚å¿µç®€å•ï¼Œå®¹æ˜“ç†è§£
âœ… å®Œæ•´çš„æ–‡ä»¶ç³»ç»ŸåŠŸèƒ½
âœ… æ”¯æŒæ‰€æœ‰æ ‡å‡†æ–‡ä»¶æ“ä½œ

ç¼ºç‚¹ï¼š
âŒ å¤§å°å›ºå®šï¼Œæµªè´¹å†…å­˜
âŒ éœ€è¦æ–‡ä»¶ç³»ç»Ÿé©±åŠ¨
âŒ æŒ‚è½½ã€å¸è½½å¼€é”€å¤§
âŒ æ— æ³•åŠ¨æ€è°ƒæ•´å¤§å°
```

### 2.3 initramfsï¼šç°ä»£ä¼˜åŒ–æ–¹æ¡ˆ


**ğŸ”¸ initramfså…¨ç§°**ï¼š**Init**ial **RAM** **F**ile**s**ystemï¼ˆåˆå§‹RAMæ–‡ä»¶ç³»ç»Ÿï¼‰

**é©å‘½æ€§æ”¹è¿›**ï¼š
```
ç°ä»£æ–¹å¼ç±»æ¯”ï¼š
initramfs = é­”æ³•å£è¢‹
â€¢ åˆ¶ä½œï¼šæŠŠå·¥å…·"å˜"æˆæ•°æ®æµ
â€¢ ä½¿ç”¨ï¼šéœ€è¦ä»€ä¹ˆå°±"å˜"å‡ºä»€ä¹ˆ
â€¢ ä¼˜åŠ¿ï¼šæŒ‰éœ€åˆ†é…ï¼Œç”¨å¤šå°‘å å¤šå°‘

æŠ€æœ¯é©æ–°ï¼š
1. ä¸æ˜¯çœŸæ­£çš„ç£ç›˜ï¼Œè€Œæ˜¯å†…å­˜ä¸­çš„æ–‡ä»¶ç³»ç»Ÿ
2. å†…æ ¸ç›´æ¥æ”¯æŒï¼Œæ— éœ€é¢å¤–é©±åŠ¨
3. åŠ¨æ€åˆ†é…å†…å­˜ï¼ŒæŒ‰éœ€ä½¿ç”¨
4. ç”¨å®Œå°±é‡Šæ”¾ï¼Œä¸ç•™ç—•è¿¹
```

### 2.4 ä¸¤è€…è¯¦ç»†å¯¹æ¯”


| å¯¹æ¯”ç»´åº¦ | **initrdï¼ˆä¼ ç»Ÿï¼‰** | **initramfsï¼ˆç°ä»£ï¼‰** |
|---------|------------------|---------------------|
| ğŸ”¸ **å®ç°æ–¹å¼** | `è™šæ‹Ÿå—è®¾å¤‡+æ–‡ä»¶ç³»ç»Ÿ` | `å†…æ ¸å†…ç½®çš„tmpfs` |
| ğŸ”¸ **å†…å­˜ä½¿ç”¨** | `å›ºå®šå¤§å°ï¼Œé¢„åˆ†é…` | `åŠ¨æ€åˆ†é…ï¼ŒæŒ‰éœ€ä½¿ç”¨` |
| ğŸ”¸ **æ–‡ä»¶ç³»ç»Ÿ** | `éœ€è¦ext2é©±åŠ¨` | `å†…æ ¸åŸç”Ÿæ”¯æŒ` |
| ğŸ”¸ **æ€§èƒ½å¼€é”€** | `æŒ‚è½½/å¸è½½æœ‰å¼€é”€` | `ç›´æ¥å†…å­˜æ“ä½œ` |
| ğŸ”¸ **å¤§å°é™åˆ¶** | `åˆ›å»ºæ—¶å›ºå®š` | `åŠ¨æ€æ‰©å±•` |
| ğŸ”¸ **å†…å­˜é‡Šæ”¾** | `éœ€æ‰‹åŠ¨å¸è½½` | `è‡ªåŠ¨å›æ”¶` |
| ğŸ”¸ **å½“å‰çŠ¶æ€** | `é€æ­¥æ·˜æ±°` | `ä¸»æµä½¿ç”¨` |

**ğŸ§  è®°å¿†è¦ç‚¹**ï¼š
```
ç®€å•è®°å¿†ï¼š
initrd = ä¼ ç»Ÿçš„"å®ä½“å·¥å…·ç®±"ï¼ˆå›ºå®šå¤§å°ï¼Œæœ‰ç‚¹ç¬¨é‡ï¼‰
initramfs = ç°ä»£çš„"è™šæ‹Ÿå·¥å…·åº“"ï¼ˆæŒ‰éœ€å–ç”¨ï¼Œçµæ´»é«˜æ•ˆï¼‰

å‘å±•è¶‹åŠ¿ï¼š
initrd â†’ initramfs ï¼ˆæŠ€æœ¯å‡çº§çš„å¿…ç„¶ï¼‰
```

### 2.5 å®é™…ç³»ç»Ÿä¸­çš„ä½“ç°


**ğŸ” æŸ¥çœ‹å½“å‰ç³»ç»Ÿä½¿ç”¨çš„æ–¹å¼**ï¼š
```bash
# æŸ¥çœ‹å¼•å¯¼æ—¶çš„ä¿¡æ¯
dmesg | grep -i "initr"

# æŸ¥çœ‹æ–‡ä»¶ç±»å‹
file /boot/initrd.img-$(uname -r)

# è§£å‹å¹¶æŸ¥çœ‹å†…å®¹ï¼ˆinitramfsæ ¼å¼ï¼‰
cd /tmp
zcat /boot/initrd.img-$(uname -r) | cpio -idmv
```

**ğŸ“Š å…¸å‹è¾“å‡º**ï¼š
```
# initramfsæ ¼å¼è¾“å‡º
/boot/initrd.img-5.15.0: gzip compressed data
# è¯´æ˜ï¼šç°ä»£ç³»ç»Ÿéƒ½æ˜¯initramfsï¼Œåªæ˜¯æ–‡ä»¶åä¿æŒinitrdæ˜¯ä¸ºäº†å…¼å®¹æ€§

# è§£å‹åçš„ç›®å½•ç»“æ„
bin/ sbin/ etc/ lib/ usr/ var/ root/ tmp/ proc/ sys/ dev/
```

---

## 3. ğŸš€ åˆå§‹RAMæ–‡ä»¶ç³»ç»Ÿçš„ä½œç”¨æœºåˆ¶


### 3.1 ä¸ºä»€ä¹ˆéœ€è¦åˆå§‹RAMæ–‡ä»¶ç³»ç»Ÿ


**ğŸ¯ æ ¸å¿ƒé—®é¢˜è§£å†³**ï¼š

æƒ³è±¡ä½ æ˜¯ä¸€ä¸ªåˆšåˆ°é™Œç”ŸåŸå¸‚çš„äººï¼Œéœ€è¦æ‰¾åˆ°ä½å¤„ï¼Œä½†æ˜¯ï¼š

```
é—®é¢˜ç±»æ¯”ï¼š
æƒ…å†µï¼šä½ éœ€è¦GPSå¯¼èˆªæ‰¾åˆ°å®¶
å›°éš¾ï¼šæ‰‹æœºéœ€è¦SIMå¡æ‰èƒ½ä¸Šç½‘
æ‚–è®ºï¼šSIMå¡åœ¨å®¶é‡Œï¼Œä½†ä½ æ‰¾ä¸åˆ°å®¶

Linuxå¯åŠ¨ç±»æ¯”ï¼š
æƒ…å†µï¼šå†…æ ¸éœ€è¦è®¿é—®æ ¹æ–‡ä»¶ç³»ç»Ÿ
å›°éš¾ï¼šéœ€è¦ç£ç›˜é©±åŠ¨æ‰èƒ½è¯»å–ç¡¬ç›˜
æ‚–è®ºï¼šé©±åŠ¨ç¨‹åºåœ¨ç¡¬ç›˜ä¸Šï¼Œä½†è¯»ä¸äº†ç¡¬ç›˜

è§£å†³æ–¹æ¡ˆï¼š
â€¢ ä¸´æ—¶æ–¹æ¡ˆï¼šå…ˆç”¨ç¦»çº¿åœ°å›¾(initramfs)æ‰¾åˆ°å¤§æ¦‚ä½ç½®
â€¢ æœ€ç»ˆç›®æ ‡ï¼šåˆ°å®¶åç”¨WiFiä¸Šç½‘è·å¾—å®Œæ•´æœåŠ¡
```

### 3.2 initramfsçš„æ ¸å¿ƒä½œç”¨


**ğŸ”¸ ä¸»è¦åŠŸèƒ½åˆ—è¡¨**ï¼š

```
1. ğŸ”Œ ç¡¬ä»¶é©±åŠ¨åŠ è½½
   ä½œç”¨ï¼šä¸ºè®¿é—®æ ¹æ–‡ä»¶ç³»ç»Ÿæä¾›å¿…è¦é©±åŠ¨
   åŒ…å«ï¼šç£ç›˜æ§åˆ¶å™¨ã€æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œç­‰é©±åŠ¨

2. ğŸ—‚ï¸ æ ¹æ–‡ä»¶ç³»ç»Ÿå®šä½
   ä½œç”¨ï¼šæ‰¾åˆ°å¹¶éªŒè¯çœŸæ­£çš„æ ¹æ–‡ä»¶ç³»ç»Ÿ
   æ”¯æŒï¼šUUIDã€LABELã€è®¾å¤‡è·¯å¾„ç­‰æ–¹å¼

3. ğŸ” ç³»ç»Ÿå®‰å…¨æ£€æŸ¥
   ä½œç”¨ï¼šæ–‡ä»¶ç³»ç»Ÿå®Œæ•´æ€§æ£€æŸ¥ã€å¯†ç éªŒè¯
   åŠŸèƒ½ï¼šLUKSè§£å¯†ã€æ–‡ä»¶ç³»ç»Ÿä¿®å¤ç­‰

4. ğŸŒ ç½‘ç»œå¯åŠ¨æ”¯æŒ
   ä½œç”¨ï¼šæ”¯æŒNFSã€iSCSIç­‰ç½‘ç»œæ ¹æ–‡ä»¶ç³»ç»Ÿ
   å®ç°ï¼šç½‘ç»œé…ç½®ã€è¿œç¨‹æŒ‚è½½ç­‰

5. ğŸ”„ ç³»ç»Ÿåˆ‡æ¢
   ä½œç”¨ï¼šä»ä¸´æ—¶ç³»ç»Ÿåˆ‡æ¢åˆ°çœŸæ­£ç³»ç»Ÿ
   è¿‡ç¨‹ï¼špivot_rootã€exec /sbin/init
```

### 3.3 initramfså·¥ä½œæµç¨‹è¯¦è§£


**ğŸ“‹ å®Œæ•´å¯åŠ¨æ—¶åº**ï¼š

```
å¯åŠ¨é˜¶æ®µæ—¶åºå›¾ï¼š

BIOS/UEFI å¯åŠ¨
    â†“
åŠ è½½å¼•å¯¼åŠ è½½å™¨(GRUB)
    â†“
åŠ è½½å†…æ ¸é•œåƒåˆ°å†…å­˜
    â†“
è§£å‹initramfsåˆ°å†…å­˜ â†â”€â”€ æˆ‘ä»¬å…³æ³¨çš„é‡ç‚¹
    â†“
å†…æ ¸åˆå§‹åŒ–åŸºç¡€åŠŸèƒ½
    â†“
å¯åŠ¨initramfsä¸­çš„/initè„šæœ¬
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  initramfsæ‰§è¡Œé˜¶æ®µ       â”‚
â”‚                         â”‚
â”‚  1. åŠ è½½å¿…è¦é©±åŠ¨         â”‚
â”‚     â”œâ”€ ç£ç›˜æ§åˆ¶å™¨é©±åŠ¨   â”‚
â”‚     â”œâ”€ æ–‡ä»¶ç³»ç»Ÿé©±åŠ¨     â”‚
â”‚     â””â”€ å…¶ä»–ç¡¬ä»¶é©±åŠ¨     â”‚
â”‚                         â”‚
â”‚  2. ç¡¬ä»¶è®¾å¤‡æ£€æµ‹         â”‚
â”‚     â”œâ”€ æ‰«æç¡¬ç›˜è®¾å¤‡     â”‚
â”‚     â”œâ”€ è¯†åˆ«åˆ†åŒºä¿¡æ¯     â”‚
â”‚     â””â”€ åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹     â”‚
â”‚                         â”‚
â”‚  3. æ ¹æ–‡ä»¶ç³»ç»Ÿå‡†å¤‡       â”‚
â”‚     â”œâ”€ æŸ¥æ‰¾æ ¹åˆ†åŒº       â”‚
â”‚     â”œâ”€ æ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥     â”‚
â”‚     â””â”€ æŒ‚è½½æ ¹åˆ†åŒº       â”‚
â”‚                         â”‚
â”‚  4. ç³»ç»Ÿåˆ‡æ¢             â”‚
â”‚     â”œâ”€ pivot_root       â”‚
â”‚     â”œâ”€ æ¸…ç†initramfs    â”‚
â”‚     â””â”€ execçœŸæ­£çš„init   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
çœŸæ­£çš„ç³»ç»Ÿåˆå§‹åŒ–å¼€å§‹
    â†“
å¯åŠ¨å„ç§ç³»ç»ŸæœåŠ¡
    â†“
ç”¨æˆ·ç™»å½•ç•Œé¢
```

### 3.4 initramfså†…å®¹ç»“æ„


**ğŸ—‚ï¸ å…¸å‹ç›®å½•ç»“æ„**ï¼š
```
initramfsæ ¹ç›®å½•ï¼š
â”œâ”€â”€ bin/           # åŸºæœ¬å‘½ä»¤å·¥å…·
â”‚   â”œâ”€â”€ sh         # Shellè§£é‡Šå™¨
â”‚   â”œâ”€â”€ mount      # æŒ‚è½½å‘½ä»¤
â”‚   â””â”€â”€ modprobe   # æ¨¡å—åŠ è½½å·¥å…·
â”œâ”€â”€ sbin/          # ç³»ç»Ÿç®¡ç†å·¥å…·
â”‚   â”œâ”€â”€ init       # åˆå§‹åŒ–è„šæœ¬(æ ¸å¿ƒ)
â”‚   â””â”€â”€ pivot_root # åˆ‡æ¢æ ¹ç›®å½•
â”œâ”€â”€ etc/           # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ modules    # éœ€è¦åŠ è½½çš„æ¨¡å—åˆ—è¡¨
â”‚   â””â”€â”€ fstab      # æ–‡ä»¶ç³»ç»Ÿè¡¨
â”œâ”€â”€ lib/           # åº“æ–‡ä»¶å’Œé©±åŠ¨æ¨¡å—
â”‚   â”œâ”€â”€ modules/   # å†…æ ¸æ¨¡å—
â”‚   â””â”€â”€ *.so       # å…±äº«åº“æ–‡ä»¶
â”œâ”€â”€ dev/           # è®¾å¤‡æ–‡ä»¶(åŸºæœ¬)
â”œâ”€â”€ proc/          # è¿›ç¨‹ä¿¡æ¯(æŒ‚è½½ç‚¹)
â”œâ”€â”€ sys/           # ç³»ç»Ÿä¿¡æ¯(æŒ‚è½½ç‚¹)
â””â”€â”€ tmp/           # ä¸´æ—¶æ–‡ä»¶
```

**ğŸ’¡ å…³é”®æ–‡ä»¶è¯´æ˜**ï¼š

```bash
# /init - initramfsçš„æ ¸å¿ƒè„šæœ¬
#!/bin/sh
# è¿™æ˜¯æ•´ä¸ªinitramfsçš„"å¤§è„‘"
# è´Ÿè´£åè°ƒæ‰€æœ‰å¯åŠ¨æ­¥éª¤

# /etc/modules - éœ€è¦åŠ è½½çš„æ¨¡å—
ahci           # SATAæ§åˆ¶å™¨é©±åŠ¨
ext4           # ext4æ–‡ä»¶ç³»ç»Ÿæ”¯æŒ
usb-storage    # USBå­˜å‚¨è®¾å¤‡æ”¯æŒ

# /lib/modules/ - å®é™…çš„é©±åŠ¨æ–‡ä»¶
5.15.0-72-generic/
â”œâ”€â”€ kernel/
â”‚   â”œâ”€â”€ drivers/    # ç¡¬ä»¶é©±åŠ¨
â”‚   â””â”€â”€ fs/         # æ–‡ä»¶ç³»ç»Ÿé©±åŠ¨
â””â”€â”€ modules.dep     # æ¨¡å—ä¾èµ–å…³ç³»
```

### 3.5 initramfsä¸çœŸå®ç³»ç»Ÿçš„åˆ‡æ¢


**ğŸ”„ pivot_rootæœºåˆ¶è¯¦è§£**ï¼š

```
åˆ‡æ¢è¿‡ç¨‹ç±»æ¯”ï¼š
æƒ³è±¡ä½ åœ¨ä¸´æ—¶åŠå…¬å®¤å·¥ä½œï¼Œç°åœ¨è¦æ¬åˆ°æ­£å¼åŠå…¬å®¤ï¼š

ä¸´æ—¶åŠå…¬å®¤é˜¶æ®µ(initramfs)ï¼š
â€¢ æœ‰åŸºæœ¬çš„å·¥å…·å’Œæ–‡ä»¶
â€¢ èƒ½å¤„ç†ç´§æ€¥æƒ…å†µ
â€¢ ç©ºé—´æœ‰é™ï¼ŒåŠŸèƒ½ç®€å•

æ¬è¿è¿‡ç¨‹(pivot_root)ï¼š
1. å…ˆç¡®è®¤æ­£å¼åŠå…¬å®¤å¯ç”¨
2. æŠŠé‡è¦æ–‡ä»¶è½¬ç§»è¿‡å»
3. æŠŠä¸´æ—¶åŠå…¬å®¤çš„é’¥åŒ™äº¤å‡ºå»
4. åœ¨æ­£å¼åŠå…¬å®¤å¼€å§‹å·¥ä½œ

æŠ€æœ¯å®ç°ï¼š
1. æŒ‚è½½çœŸæ­£çš„æ ¹æ–‡ä»¶ç³»ç»Ÿåˆ°/mnt
2. pivot_root /mnt /mnt/initramfs
3. åˆ‡æ¢åˆ°æ–°çš„æ ¹ç›®å½•
4. æ‰§è¡ŒçœŸæ­£çš„/sbin/init
5. æ¸…ç†initramfså†…å­˜
```

**âš ï¸ å¸¸è§é—®é¢˜è§£ç­”**ï¼š

```
Q: initramfså¤±è´¥ä¼šæ€æ ·ï¼Ÿ
A: ç³»ç»Ÿæ— æ³•å¯åŠ¨ï¼Œåœåœ¨kernel panic

Q: å¯ä»¥ä¸ç”¨initramfså—ï¼Ÿ
A: å¯ä»¥ï¼Œä½†éœ€è¦å†…æ ¸åŒ…å«æ‰€æœ‰å¿…è¦é©±åŠ¨

Q: initramfså ç”¨å¤šå°‘å†…å­˜ï¼Ÿ
A: é€šå¸¸5-50MBï¼Œç”¨å®Œåä¼šé‡Šæ”¾

Q: å¦‚ä½•è°ƒè¯•initramfsï¼Ÿ
A: åœ¨å†…æ ¸å‚æ•°ä¸­æ·»åŠ debugé€‰é¡¹
```

---

## 4. ğŸ› ï¸ dracutä¸mkinitrdå·¥å…·æ·±åº¦è§£æ


### 4.1 å·¥å…·æ¦‚è¿°ï¼šä¸¤ä»£initramfsç”Ÿæˆå™¨


**ğŸ”¸ å†å²æ¼”è¿›**ï¼š
```
æ—¶é—´è½´ï¼š
2005å¹´ä¹‹å‰  â†’ æ‰‹å·¥åˆ¶ä½œinitrd
2005-2010å¹´ â†’ mkinitrdå·¥å…·æµè¡Œ
2010å¹´è‡³ä»Š  â†’ dracutæˆä¸ºä¸»æµ

å·¥å…·å¯¹æ¯”ï¼š
mkinitrd = è€å¼å·¥å‚æµæ°´çº¿
â€¢ æŒ‰å›ºå®šæ¨¡æ¿ç”Ÿäº§
â€¢ é…ç½®ç›¸å¯¹ç®€å•
â€¢ åŠŸèƒ½æœ‰é™

dracut = ç°ä»£æ™ºèƒ½å·¥å‚
â€¢ æŒ‰éœ€å®šåˆ¶ç”Ÿäº§
â€¢ é…ç½®çµæ´»å¼ºå¤§
â€¢ åŠŸèƒ½å…¨é¢
```

### 4.2 mkinitrdï¼šä¼ ç»Ÿå·¥å…·è§£æ


**ğŸ”¸ mkinitrdåŸºæœ¬æ¦‚å¿µ**ï¼š

```
åç§°å«ä¹‰ï¼š
mk = make (åˆ¶ä½œ)
initrd = initial ramdisk (åˆå§‹RAMç£ç›˜)
åˆèµ·æ¥ = åˆ¶ä½œåˆå§‹RAMç£ç›˜çš„å·¥å…·
```

**ğŸ”§ mkinitrdåŸºæœ¬ç”¨æ³•**ï¼š
```bash
# åŸºæœ¬è¯­æ³•
mkinitrd [é€‰é¡¹] <initrdæ–‡ä»¶è·¯å¾„> <å†…æ ¸ç‰ˆæœ¬>

# å¸¸ç”¨ç¤ºä¾‹
# ä¸ºå½“å‰å†…æ ¸ç”Ÿæˆinitrd
mkinitrd /boot/initrd-$(uname -r).img $(uname -r)

# ä¸ºæŒ‡å®šå†…æ ¸ç”Ÿæˆinitrd
mkinitrd /boot/initrd-5.15.0.img 5.15.0-72-generic

# è¯¦ç»†æ¨¡å¼æ˜¾ç¤ºè¿‡ç¨‹
mkinitrd -v /boot/initrd-test.img $(uname -r)
```

**ğŸ“‹ mkinitrdä¸»è¦å‚æ•°**ï¼š
```bash
--fstab=/etc/fstab     # æŒ‡å®šfstabæ–‡ä»¶
--nocompress           # ä¸å‹ç¼©è¾“å‡ºæ–‡ä»¶
--builtin=æ¨¡å—å       # åŒ…å«ç‰¹å®šæ¨¡å—
--omit-raid-modules    # å¿½ç•¥RAIDæ¨¡å—
--with=æ¨¡å—å          # å¼ºåˆ¶åŒ…å«æ¨¡å—
```

### 4.3 dracutï¼šç°ä»£åŒ–è§£å†³æ–¹æ¡ˆ


**ğŸ”¸ dracutè®¾è®¡ç†å¿µ**ï¼š

dracutå°±åƒä¸€ä¸ª**æ™ºèƒ½è£…ä¿®é˜Ÿ**ï¼š
```
ä¼ ç»Ÿè£…ä¿®(mkinitrd)ï¼š
â€¢ æœ‰å›ºå®šçš„è£…ä¿®å¥—é¤
â€¢ ä½ åªèƒ½é€‰æ‹©Aã€Bã€Cå¥—é¤
â€¢ ä¸éœ€è¦çš„ä¸œè¥¿ä¹Ÿå¾—è£…ä¸Š

æ™ºèƒ½è£…ä¿®(dracut)ï¼š
â€¢ å…ˆçœ‹ä½ å®¶ä»€ä¹ˆæƒ…å†µ
â€¢ æ ¹æ®éœ€æ±‚é€‰æ‹©ææ–™å’Œå·¥å…·
â€¢ åªè£…ä½ éœ€è¦çš„åŠŸèƒ½
â€¢ è¿˜èƒ½åæœŸéšæ—¶è°ƒæ•´
```

**ğŸ¯ dracutæ ¸å¿ƒä¼˜åŠ¿**ï¼š
```
1. ğŸ” è‡ªåŠ¨æ£€æµ‹ç¡¬ä»¶
   â€¢ æ‰«æç³»ç»Ÿç¡¬ä»¶é…ç½®
   â€¢ åªåŒ…å«å¿…è¦çš„é©±åŠ¨
   â€¢ å‡å°‘initramfså¤§å°

2. ğŸ§© æ¨¡å—åŒ–è®¾è®¡
   â€¢ æ¯ä¸ªåŠŸèƒ½éƒ½æ˜¯ç‹¬ç«‹æ¨¡å—
   â€¢ å¯ä»¥çµæ´»å¯ç”¨/ç¦ç”¨
   â€¢ æ˜“äºæ‰©å±•å’Œç»´æŠ¤

3. ğŸ”„ äº‹ä»¶é©±åŠ¨æ¶æ„
   â€¢ åŸºäºudeväº‹ä»¶å“åº”
   â€¢ åŠ¨æ€å¤„ç†ç¡¬ä»¶å˜åŒ–
   â€¢ æ”¯æŒçƒ­æ’æ‹”è®¾å¤‡

4. ğŸŒ å…¨é¢åŠŸèƒ½æ”¯æŒ
   â€¢ ç½‘ç»œå¯åŠ¨(PXEã€NFS)
   â€¢ åŠ å¯†æ–‡ä»¶ç³»ç»Ÿ
   â€¢ LVMã€RAIDç­‰å¤æ‚é…ç½®
```

### 4.4 dracutè¯¦ç»†ä½¿ç”¨æŒ‡å—


**ğŸ”§ åŸºæœ¬æ“ä½œå‘½ä»¤**ï¼š

```bash
# 1. ç”Ÿæˆinitramfsï¼ˆè‡ªåŠ¨æ£€æµ‹ï¼‰
dracut

# 2. ä¸ºæŒ‡å®šå†…æ ¸ç”Ÿæˆ
dracut /boot/initramfs-5.15.0.img 5.15.0-72-generic

# 3. å¼ºåˆ¶é‡æ–°ç”Ÿæˆï¼ˆè¦†ç›–å·²å­˜åœ¨æ–‡ä»¶ï¼‰
dracut --force

# 4. è¯¦ç»†è¾“å‡ºè¿‡ç¨‹ä¿¡æ¯
dracut --verbose

# 5. åªç”ŸæˆåŸºç¡€åŠŸèƒ½
dracut --no-kernel

# 6. æ·»åŠ é¢å¤–æ¨¡å—
dracut --add "crypt lvm" 

# 7. æ’é™¤æŸäº›æ¨¡å—
dracut --omit "network nfs"
```

**ğŸ“Š å¸¸ç”¨å‚æ•°è¯¦è§£**ï¼š

| å‚æ•° | **åŠŸèƒ½è¯´æ˜** | **ä½¿ç”¨åœºæ™¯** |
|------|-------------|-------------|
| `--force` | `å¼ºåˆ¶è¦†ç›–å·²å­˜åœ¨æ–‡ä»¶` | `é‡æ–°ç”Ÿæˆinitramfs` |
| `--verbose` | `æ˜¾ç¤ºè¯¦ç»†æ‰§è¡Œè¿‡ç¨‹` | `è°ƒè¯•å’Œå­¦ä¹ ` |
| `--add "æ¨¡å—å"` | `æ·»åŠ ç‰¹å®šæ¨¡å—` | `ç‰¹æ®Šç¡¬ä»¶æ”¯æŒ` |
| `--omit "æ¨¡å—å"` | `æ’é™¤ç‰¹å®šæ¨¡å—` | `å‡å°æ–‡ä»¶å¤§å°` |
| `--kver ç‰ˆæœ¬å·` | `æŒ‡å®šå†…æ ¸ç‰ˆæœ¬` | `å¤šå†…æ ¸ç¯å¢ƒ` |
| `--no-compress` | `ä¸å‹ç¼©è¾“å‡ºæ–‡ä»¶` | `è°ƒè¯•ç”¨é€”` |

### 4.5 dracuté…ç½®æ–‡ä»¶ç³»ç»Ÿ


**ğŸ—‚ï¸ ä¸»è¦é…ç½®æ–‡ä»¶**ï¼š

```bash
# å…¨å±€é…ç½®æ–‡ä»¶
/etc/dracut.conf

# æ¨¡å—ç‰¹å®šé…ç½®ç›®å½•
/etc/dracut.conf.d/
â”œâ”€â”€ 01-dist.conf      # å‘è¡Œç‰ˆé…ç½®
â”œâ”€â”€ 50-custom.conf    # ç”¨æˆ·è‡ªå®šä¹‰
â””â”€â”€ 99-local.conf     # æœ¬åœ°é…ç½®

# æŸ¥çœ‹å½“å‰é…ç½®
dracut --print-cmdline
```

**ğŸ“ é…ç½®æ–‡ä»¶ç¤ºä¾‹**ï¼š
```bash
# /etc/dracut.conf ç¤ºä¾‹é…ç½®
# æ·»åŠ æ¨¡å—
add_dracutmodules+=" crypt dm lvm "

# æ’é™¤æ¨¡å—  
omit_dracutmodules+=" network nfs "

# åŒ…å«é¢å¤–æ–‡ä»¶
install_items+=" /etc/my-config /usr/bin/my-tool "

# å‹ç¼©æ–¹å¼
compress="xz"

# è¯¦ç»†è¾“å‡º
stdlog=6
```

### 4.6 dracutæ¨¡å—ç³»ç»Ÿè¯¦è§£


**ğŸ§© æ ¸å¿ƒæ¨¡å—åˆ†ç±»**ï¼š

```
åŸºç¡€æ¨¡å—ï¼š
â”œâ”€â”€ base          # åŸºç¡€åŠŸèƒ½(å¿…éœ€)
â”œâ”€â”€ bash          # bash shellæ”¯æŒ
â”œâ”€â”€ systemd       # systemdåˆå§‹åŒ–
â””â”€â”€ udev          # è®¾å¤‡ç®¡ç†

å­˜å‚¨æ¨¡å—ï¼š
â”œâ”€â”€ lvm           # LVMæ”¯æŒ
â”œâ”€â”€ mdraid        # è½¯RAIDæ”¯æŒ
â”œâ”€â”€ dmraid        # ç¡¬RAIDæ”¯æŒ
â”œâ”€â”€ multipath     # å¤šè·¯å¾„æ”¯æŒ
â””â”€â”€ crypt         # åŠ å¯†æ–‡ä»¶ç³»ç»Ÿ

ç½‘ç»œæ¨¡å—ï¼š
â”œâ”€â”€ network       # ç½‘ç»œåŸºç¡€
â”œâ”€â”€ nfs           # NFSæ–‡ä»¶ç³»ç»Ÿ
â”œâ”€â”€ iscsi         # iSCSIæ”¯æŒ
â””â”€â”€ fcoe          # FCoEæ”¯æŒ

è°ƒè¯•æ¨¡å—ï¼š
â”œâ”€â”€ debug         # è°ƒè¯•åŠŸèƒ½
â”œâ”€â”€ ssh-client    # SSHå®¢æˆ·ç«¯
â””â”€â”€ rngd          # éšæœºæ•°ç”Ÿæˆ
```

**ğŸ” æŸ¥çœ‹å¯ç”¨æ¨¡å—**ï¼š
```bash
# åˆ—å‡ºæ‰€æœ‰å¯ç”¨æ¨¡å—
dracut --list-modules

# æŸ¥çœ‹ç‰¹å®šæ¨¡å—ä¿¡æ¯
dracut --show-modules | grep crypt

# æŸ¥çœ‹å½“å‰initramfsåŒ…å«çš„æ¨¡å—
lsinitrd /boot/initramfs-$(uname -r).img | grep -E "^drwx.*modules"
```

### 4.7 å®é™…åº”ç”¨åœºæ™¯


**ğŸ’¼ å…¸å‹ä½¿ç”¨åœºæ™¯**ï¼š

```bash
# åœºæ™¯1ï¼šåŠ å¯†æ ¹åˆ†åŒºç³»ç»Ÿ
dracut --add "crypt" --force
# è‡ªåŠ¨åŒ…å«LUKSè§£å¯†åŠŸèƒ½

# åœºæ™¯2ï¼šLVMæ ¹åˆ†åŒº
dracut --add "lvm" --force  
# æ”¯æŒLVMé€»è¾‘å·å¯åŠ¨

# åœºæ™¯3ï¼šç½‘ç»œå¯åŠ¨ç³»ç»Ÿ
dracut --add "network nfs" --force
# æ”¯æŒNFSæ ¹æ–‡ä»¶ç³»ç»Ÿ

# åœºæ™¯4ï¼šè°ƒè¯•é—®é¢˜ç³»ç»Ÿ
dracut --add "debug" --kernel-cmdline "rd.debug rd.shell" --force
# åŒ…å«è°ƒè¯•å·¥å…·å’Œemergency shell

# åœºæ™¯5ï¼šç²¾ç®€ç³»ç»Ÿ
dracut --omit "network nfs multipath" --force
# æ’é™¤ä¸éœ€è¦çš„åŠŸèƒ½ï¼Œå‡å°å¤§å°
```

**âš ï¸ ä½¿ç”¨æ³¨æ„äº‹é¡¹**ï¼š

```
é‡è¦æé†’ï¼š
1. ç”Ÿæˆinitramfså‰ä¸€å®šè¦å¤‡ä»½åŸæ–‡ä»¶
2. é”™è¯¯çš„initramfsä¼šå¯¼è‡´ç³»ç»Ÿæ— æ³•å¯åŠ¨  
3. æµ‹è¯•æ–°initramfså‰å‡†å¤‡æ•‘æ´å¯åŠ¨ç›˜
4. ç”Ÿäº§ç¯å¢ƒè°¨æ…ä½¿ç”¨--forceå‚æ•°

å®‰å…¨å®è·µï¼š
# 1. å¤‡ä»½ç°æœ‰æ–‡ä»¶
cp /boot/initramfs-$(uname -r).img /boot/initramfs-$(uname -r).img.backup

# 2. ç”Ÿæˆæ–°æ–‡ä»¶
dracut --force

# 3. éªŒè¯ç”Ÿæˆç»“æœ
lsinitrd /boot/initramfs-$(uname -r).img
```

---

## 5. ğŸ”§ å†…æ ¸æ¨¡å—åŠ è½½é¡ºåºä¸æœºåˆ¶


### 5.1 ä»€ä¹ˆæ˜¯å†…æ ¸æ¨¡å—


**ç®€å•ç†è§£**ï¼šå†…æ ¸æ¨¡å—å°±åƒæ‰‹æœºçš„**åº”ç”¨ç¨‹åºæ’ä»¶**

```
ç”Ÿæ´»ç±»æ¯”ï¼š
æ‰‹æœºç³»ç»Ÿ = Linuxå†…æ ¸
åº”ç”¨å•†åº—çš„APP = å†…æ ¸æ¨¡å—

ç›¸ä¼¼ç‚¹ï¼š
â€¢ åŸºç¡€ç³»ç»Ÿæä¾›æ ¸å¿ƒåŠŸèƒ½
â€¢ æ’ä»¶æä¾›ç‰¹å®šåŠŸèƒ½
â€¢ å¯ä»¥æŒ‰éœ€å®‰è£…å’Œå¸è½½
â€¢ ä¸å½±å“ç³»ç»Ÿæ ¸å¿ƒè¿è¡Œ

åŒºåˆ«ï¼š
â€¢ å†…æ ¸æ¨¡å—åœ¨ç³»ç»Ÿçº§åˆ«å·¥ä½œ
â€¢ ç›´æ¥è®¿é—®ç¡¬ä»¶å’Œå†…æ ¸èµ„æº
â€¢ é”™è¯¯å¯èƒ½å¯¼è‡´ç³»ç»Ÿå´©æºƒ
```

**ğŸ” å†…æ ¸æ¨¡å—æœ¬è´¨**ï¼š
- **åŠŸèƒ½æ‰©å±•**ï¼šä¸ºå†…æ ¸æ·»åŠ ç‰¹å®šç¡¬ä»¶æ”¯æŒæˆ–åŠŸèƒ½
- **åŠ¨æ€åŠ è½½**ï¼šè¿è¡Œæ—¶å¯ä»¥åŠ è½½å’Œå¸è½½
- **èŠ‚çœå†…å­˜**ï¼šåªåŠ è½½éœ€è¦çš„åŠŸèƒ½
- **æ¨¡å—åŒ–è®¾è®¡**ï¼šé™ä½å†…æ ¸å¤æ‚åº¦

### 5.2 æ¨¡å—ç±»å‹ä¸åˆ†ç±»


**ğŸ“‚ æŒ‰åŠŸèƒ½åˆ†ç±»**ï¼š
```
ç¡¬ä»¶é©±åŠ¨æ¨¡å—ï¼š
â”œâ”€â”€ ç½‘å¡é©±åŠ¨    # e1000e, rtl8139ç­‰
â”œâ”€â”€ å£°å¡é©±åŠ¨    # snd-hda-intelç­‰  
â”œâ”€â”€ æ˜¾å¡é©±åŠ¨    # nvidia, amdgpuç­‰
â”œâ”€â”€ å­˜å‚¨é©±åŠ¨    # ahci, nvmeç­‰
â””â”€â”€ USBé©±åŠ¨     # usb-storageç­‰

æ–‡ä»¶ç³»ç»Ÿæ¨¡å—ï¼š
â”œâ”€â”€ ext4        # ext4æ–‡ä»¶ç³»ç»Ÿ
â”œâ”€â”€ ntfs        # NTFSæ–‡ä»¶ç³»ç»Ÿ
â”œâ”€â”€ xfs         # XFSæ–‡ä»¶ç³»ç»Ÿ
â””â”€â”€ nfs         # NFSç½‘ç»œæ–‡ä»¶ç³»ç»Ÿ

ç½‘ç»œåè®®æ¨¡å—ï¼š
â”œâ”€â”€ tcp_bbr     # BBRæ‹¥å¡æ§åˆ¶
â”œâ”€â”€ ip_tables   # iptablesé˜²ç«å¢™
â”œâ”€â”€ bridge      # ç½‘ç»œæ¡¥æ¥
â””â”€â”€ bonding     # ç½‘ç»œç»‘å®š

è™šæ‹ŸåŒ–æ¨¡å—ï¼š
â”œâ”€â”€ kvm         # KVMè™šæ‹ŸåŒ–
â”œâ”€â”€ vhost       # è™šæ‹Ÿä¸»æœº
â””â”€â”€ tun         # TUN/TAPè®¾å¤‡
```

### 5.3 æ¨¡å—åŠ è½½é¡ºåºçš„é‡è¦æ€§


**ğŸ”„ ä¸ºä»€ä¹ˆé¡ºåºå¾ˆé‡è¦**ï¼š

```
ä¾èµ–å…³ç³»ç±»æ¯”ï¼š
ç›–æˆ¿å­çš„é¡ºåºï¼š
åœ°åŸº â†’ æ¡†æ¶ â†’ å¢™ä½“ â†’ å±‹é¡¶ â†’ è£…ä¿®

å¦‚æœé¡ºåºé”™è¯¯ï¼š
â€¢ å…ˆè£…ä¿®åå»ºå¢™ = è£…ä¿®ç™½åš
â€¢ å…ˆå»ºå±‹é¡¶åå»ºå¢™ = æˆ¿å­å¡Œäº†

å†…æ ¸æ¨¡å—ç±»ä¼¼ï¼š
åŸºç¡€æ¨¡å— â†’ æ€»çº¿é©±åŠ¨ â†’ è®¾å¤‡é©±åŠ¨ â†’ åº”ç”¨åè®®

é”™è¯¯é¡ºåºçš„åæœï¼š
â€¢ è®¾å¤‡æ— æ³•è¯†åˆ«
â€¢ åŠŸèƒ½å¼‚å¸¸
â€¢ ç³»ç»Ÿå´©æºƒ
```

### 5.4 æ¨¡å—ä¾èµ–å…³ç³»è§£æ


**ğŸ”— ä¾èµ–å…³ç³»æ–‡ä»¶**ï¼š
```bash
# æŸ¥çœ‹æ¨¡å—ä¾èµ–å…³ç³»
cat /lib/modules/$(uname -r)/modules.dep

# ç¤ºä¾‹ä¾èµ–å…³ç³»
kernel/drivers/net/ethernet/intel/e1000e/e1000e.ko:
kernel/drivers/net/mii.ko kernel/drivers/ptp/ptp.ko

# è§£é‡Šï¼še1000eç½‘å¡é©±åŠ¨ä¾èµ–miiå’Œptpæ¨¡å—
```

**ğŸ“Š ä¾èµ–å±‚æ¬¡ç»“æ„**ï¼š
```
åº•å±‚ç¡¬ä»¶æ¥å£ï¼š
â”œâ”€â”€ pci.ko          # PCIæ€»çº¿æ”¯æŒ
â”œâ”€â”€ usb-common.ko   # USBå…¬å…±å‡½æ•°
â””â”€â”€ i2c-core.ko     # I2Cæ€»çº¿æ”¯æŒ
        â†“
ä¸­é—´æŠ½è±¡å±‚ï¼š
â”œâ”€â”€ mii.ko          # ç½‘ç»œæ¥å£æŠ½è±¡
â”œâ”€â”€ libata.ko       # ATAä¼ è¾“æŠ½è±¡  
â””â”€â”€ hid.ko          # äººæœºæ¥å£æŠ½è±¡
        â†“
å…·ä½“é©±åŠ¨å±‚ï¼š
â”œâ”€â”€ e1000e.ko       # Intelç½‘å¡é©±åŠ¨
â”œâ”€â”€ ahci.ko         # AHCIç£ç›˜é©±åŠ¨
â””â”€â”€ usbhid.ko       # USBé”®é¼ é©±åŠ¨
```

### 5.5 initramfsä¸­çš„æ¨¡å—åŠ è½½æµç¨‹


**â±ï¸ å¯åŠ¨é˜¶æ®µæ¨¡å—åŠ è½½æ—¶åº**ï¼š

```
ç¬¬ä¸€é˜¶æ®µï¼šå†…æ ¸åŸºç¡€æ¨¡å—ï¼ˆå†…æ ¸å¯åŠ¨æ—¶ï¼‰
â”œâ”€â”€ å†…å­˜ç®¡ç†æ¨¡å—
â”œâ”€â”€ è¿›ç¨‹è°ƒåº¦æ¨¡å—  
â”œâ”€â”€ åŸºç¡€I/Oæ¨¡å—
â””â”€â”€ æ–‡ä»¶ç³»ç»Ÿæ ¸å¿ƒ

ç¬¬äºŒé˜¶æ®µï¼šinitramfså¿…éœ€æ¨¡å—ï¼ˆinitramfså¯åŠ¨æ—¶ï¼‰
â”œâ”€â”€ å­˜å‚¨æ§åˆ¶å™¨é©±åŠ¨
â”œâ”€â”€ æ–‡ä»¶ç³»ç»Ÿé©±åŠ¨
â”œâ”€â”€ åŸºç¡€ç½‘ç»œé©±åŠ¨ï¼ˆå¦‚éœ€è¦ï¼‰
â””â”€â”€ è®¾å¤‡æ£€æµ‹å·¥å…·

ç¬¬ä¸‰é˜¶æ®µï¼šç³»ç»Ÿå®Œæ•´æ¨¡å—ï¼ˆçœŸå®ç³»ç»Ÿå¯åŠ¨åï¼‰
â”œâ”€â”€ æ‰€æœ‰ç¡¬ä»¶é©±åŠ¨
â”œâ”€â”€ ç½‘ç»œåè®®æ ˆ
â”œâ”€â”€ éŸ³é¢‘è§†é¢‘é©±åŠ¨
â””â”€â”€ å…¶ä»–åŠŸèƒ½æ¨¡å—
```

**ğŸ”§ initramfsæ¨¡å—åŠ è½½æœºåˆ¶**ï¼š

```bash
# initramfsä¸­çš„æ¨¡å—åŠ è½½è„šæœ¬ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
#!/bin/sh

# 1. æŒ‚è½½åŸºç¡€æ–‡ä»¶ç³»ç»Ÿ
mount -t proc proc /proc
mount -t sysfs sysfs /sys  
mount -t devtmpfs devtmpfs /dev

# 2. åŠ è½½å¿…éœ€çš„å­˜å‚¨é©±åŠ¨
modprobe libata      # ATAä¼ è¾“å±‚
modprobe ahci        # AHCIæ§åˆ¶å™¨
modprobe sd_mod      # SCSIç£ç›˜é©±åŠ¨

# 3. åŠ è½½æ–‡ä»¶ç³»ç»Ÿé©±åŠ¨
modprobe ext4        # ext4æ–‡ä»¶ç³»ç»Ÿ

# 4. ç­‰å¾…è®¾å¤‡å‡†å¤‡å°±ç»ª
udevadm settle

# 5. æŸ¥æ‰¾å¹¶æŒ‚è½½æ ¹åˆ†åŒº
mount UUID=xxxx-xxxx /mnt

# 6. åˆ‡æ¢åˆ°çœŸå®æ ¹æ–‡ä»¶ç³»ç»Ÿ
pivot_root /mnt /mnt/initramfs
```

### 5.6 æ¨¡å—åŠ è½½å·¥å…·ä¸å‘½ä»¤


**ğŸ› ï¸ æ ¸å¿ƒç®¡ç†å‘½ä»¤**ï¼š

```bash
# æŸ¥çœ‹å·²åŠ è½½æ¨¡å—
lsmod

# æŸ¥çœ‹æ¨¡å—è¯¦ç»†ä¿¡æ¯
modinfo æ¨¡å—å
modinfo e1000e

# æ‰‹åŠ¨åŠ è½½æ¨¡å—
modprobe æ¨¡å—å
modprobe e1000e

# å¸è½½æ¨¡å—
rmmod æ¨¡å—å
# æˆ–è€…ä½¿ç”¨ï¼ˆæ¨èï¼Œä¼šå¤„ç†ä¾èµ–ï¼‰
modprobe -r æ¨¡å—å

# æŸ¥çœ‹æ¨¡å—å‚æ•°
modinfo -p æ¨¡å—å

# å¸¦å‚æ•°åŠ è½½æ¨¡å—
modprobe æ¨¡å—å å‚æ•°=å€¼
```

**ğŸ“Š å®ç”¨æŸ¥è¯¢å‘½ä»¤**ï¼š
```bash
# æŸ¥çœ‹å½“å‰åŠ è½½çš„æ‰€æœ‰æ¨¡å—
lsmod | head -10

# æŸ¥çœ‹ç‰¹å®šæ¨¡å—æ˜¯å¦åŠ è½½
lsmod | grep e1000e

# æŸ¥çœ‹æ¨¡å—ä½¿ç”¨æƒ…å†µ
lsmod | grep -E "(Used by|Module)"

# æŸ¥çœ‹ç³»ç»Ÿæ‰€æœ‰å¯ç”¨æ¨¡å—
find /lib/modules/$(uname -r) -name "*.ko" | wc -l

# æœç´¢åŒ…å«ç‰¹å®šåŠŸèƒ½çš„æ¨¡å—
modprobe -c | grep æŸä¸ªå…³é”®è¯
```

### 5.7 æ¨¡å—åŠ è½½é—®é¢˜æ’æŸ¥


**ğŸ” å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ**ï¼š

```bash
# é—®é¢˜1ï¼šæ¨¡å—åŠ è½½å¤±è´¥
# æ’æŸ¥æ­¥éª¤ï¼š
dmesg | grep -i "module"     # æŸ¥çœ‹å†…æ ¸æ—¥å¿—
modinfo æ¨¡å—å               # ç¡®è®¤æ¨¡å—å­˜åœ¨
depmod -a                    # é‡å»ºä¾èµ–å…³ç³»

# é—®é¢˜2ï¼šä¾èµ–å…³ç³»é”™è¯¯
# è§£å†³æ–¹æ³•ï¼š
depmod -ae                   # æ£€æŸ¥å¹¶æŠ¥å‘Šé”™è¯¯
modprobe --force-vermagic    # å¼ºåˆ¶åŠ è½½ï¼ˆå±é™©ï¼‰

# é—®é¢˜3ï¼šæ¨¡å—ç‰ˆæœ¬ä¸åŒ¹é…
# æ£€æŸ¥æ–¹æ³•ï¼š
modinfo æ¨¡å—å | grep vermagic
uname -r                     # å¯¹æ¯”å†…æ ¸ç‰ˆæœ¬

# é—®é¢˜4ï¼šæ¨¡å—å‚æ•°é”™è¯¯
# æŸ¥çœ‹æ­£ç¡®å‚æ•°ï¼š
modinfo -p æ¨¡å—å
# æŸ¥çœ‹å½“å‰å‚æ•°ï¼š
cat /sys/module/æ¨¡å—å/parameters/*
```

**âš ï¸ å®‰å…¨æé†’**ï¼š

```
æ¨¡å—åŠ è½½æ³¨æ„äº‹é¡¹ï¼š
1. ğŸ”’ åªåŠ è½½å¯ä¿¡æ¥æºçš„æ¨¡å—
2. ğŸ“ è®°å½•åŠ è½½çš„æ¨¡å—å’Œå‚æ•°
3. ğŸ”„ æµ‹è¯•ç¯å¢ƒå…ˆéªŒè¯
4. ğŸ’¾ å‡†å¤‡æ¢å¤æ–¹æ¡ˆ

å±é™©æ“ä½œï¼š
--force         # å¼ºåˆ¶åŠ è½½å¯èƒ½å¯¼è‡´ç³»ç»Ÿå´©æºƒ
--force-vermagic # å¿½ç•¥ç‰ˆæœ¬æ£€æŸ¥å¾ˆå±é™©
rmmod -f        # å¼ºåˆ¶å¸è½½å¯èƒ½æœ‰é—®é¢˜
```

**ğŸ§  è®°å¿†è¦ç‚¹**ï¼š
```
æ¨¡å—åŠ è½½é¡ºåºè®°å¿†ï¼š
"åœ°åŸºæ€»çº¿è®¾å¤‡åº”ç”¨" - åº•å±‚åˆ°ä¸Šå±‚çš„ä¾èµ–å…³ç³»
â€¢ åœ°åŸºï¼šåŸºç¡€ç¡¬ä»¶æ¥å£æ¨¡å—
â€¢ æ€»çº¿ï¼šPCIã€USBç­‰æ€»çº¿é©±åŠ¨  
â€¢ è®¾å¤‡ï¼šå…·ä½“ç¡¬ä»¶è®¾å¤‡é©±åŠ¨
â€¢ åº”ç”¨ï¼šä¸Šå±‚åŠŸèƒ½å’Œåè®®æ¨¡å—
```

---

## 6. ğŸ’¿ rootæ–‡ä»¶ç³»ç»ŸæŒ‚è½½å…¨æµç¨‹


### 6.1 rootæ–‡ä»¶ç³»ç»ŸåŸºæœ¬æ¦‚å¿µ


**ğŸ  ä»€ä¹ˆæ˜¯rootæ–‡ä»¶ç³»ç»Ÿ**ï¼š

```
ç”Ÿæ´»ç±»æ¯”ï¼š
rootæ–‡ä»¶ç³»ç»Ÿ = ä½ çš„æ•´ä¸ªå®¶
â€¢ /ï¼ˆæ ¹ç›®å½•ï¼‰= å®¶çš„å¤§é—¨åœ°å€
â€¢ é‡Œé¢æœ‰æ‰€æœ‰æˆ¿é—´ï¼ˆç›®å½•ï¼‰
â€¢ å­˜æ”¾æ‰€æœ‰å®¶å…·ï¼ˆæ–‡ä»¶å’Œç¨‹åºï¼‰
â€¢ æ²¡æœ‰å®ƒå°±æ— å®¶å¯å½’ï¼ˆç³»ç»Ÿæ— æ³•å·¥ä½œï¼‰

æŠ€æœ¯å®šä¹‰ï¼š
â€¢ æŒ‚è½½åˆ°"/"çš„æ–‡ä»¶ç³»ç»Ÿ
â€¢ åŒ…å«æ“ä½œç³»ç»Ÿçš„æ ¸å¿ƒæ–‡ä»¶
â€¢ ç³»ç»Ÿå¯åŠ¨åçš„ä¸»è¦å·¥ä½œç¯å¢ƒ
â€¢ å…¶ä»–æ–‡ä»¶ç³»ç»Ÿéƒ½æŒ‚è½½åœ¨å®ƒä¹‹ä¸‹
```

**ğŸ” ä¸ºä»€ä¹ˆéœ€è¦rootæ–‡ä»¶ç³»ç»Ÿ**ï¼š
```
ç³»ç»Ÿéœ€æ±‚ï¼š
1. ğŸ“ å­˜å‚¨ç³»ç»Ÿç¨‹åºå’Œåº“æ–‡ä»¶
2. âš™ï¸ æä¾›é…ç½®æ–‡ä»¶çš„å­˜æ”¾ä½ç½®  
3. ğŸ“Š ç®¡ç†ç³»ç»Ÿè¿è¡Œæ—¶æ•°æ®
4. ğŸ”§ æä¾›ç”¨æˆ·å·¥ä½œç¯å¢ƒ

æ²¡æœ‰rootçš„åæœï¼š
â€¢ å†…æ ¸å¯åŠ¨åä¸çŸ¥é“å»å“ªé‡Œæ‰¾ç¨‹åº
â€¢ æ— æ³•æ‰§è¡Œ/sbin/init
â€¢ ç³»ç»Ÿåœåœ¨kernel panic
```

### 6.2 æŒ‚è½½è¿‡ç¨‹çš„æŠ€æœ¯æŒ‘æˆ˜


**ğŸ”„ ç»å…¸"é¸¡è›‹é—®é¢˜"**ï¼š

```
é—®é¢˜åœºæ™¯ï¼š
éœ€è¦ï¼šè®¿é—®/dev/sda1ä¸Šçš„æ–‡ä»¶
å›°éš¾ï¼šéœ€è¦æ–‡ä»¶ç³»ç»Ÿé©±åŠ¨æ‰èƒ½è¯»å–
æ‚–è®ºï¼šé©±åŠ¨ç¨‹åºåœ¨/dev/sda1ä¸Š

ç±»æ¯”ç†è§£ï¼š
éœ€è¦ï¼šæ‰“å¼€ä¿é™©ç®±å–é’¥åŒ™
å›°éš¾ï¼šéœ€è¦é’¥åŒ™æ‰èƒ½æ‰“å¼€ä¿é™©ç®±  
æ‚–è®ºï¼šé’¥åŒ™åœ¨ä¿é™©ç®±é‡Œ

è§£å†³æ€è·¯ï¼š
1. å‡†å¤‡ä¸´æ—¶é’¥åŒ™ï¼ˆinitramfsä¸­çš„é©±åŠ¨ï¼‰
2. ç”¨ä¸´æ—¶é’¥åŒ™å¼€ç®±å­ï¼ˆæŒ‚è½½rootï¼‰
3. å–å‡ºçœŸæ­£çš„é’¥åŒ™ï¼ˆåŠ è½½å®Œæ•´é©±åŠ¨ï¼‰
4. æ‰”æ‰ä¸´æ—¶é’¥åŒ™ï¼ˆæ¸…ç†initramfsï¼‰
```

### 6.3 rootæ–‡ä»¶ç³»ç»ŸæŒ‚è½½å®Œæ•´æµç¨‹


**ğŸ“‹ è¯¦ç»†æŒ‚è½½æ—¶åº**ï¼š

```
ç¬¬ä¸€é˜¶æ®µï¼šinitramfså‡†å¤‡é˜¶æ®µ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. å†…æ ¸è§£å‹initramfsåˆ°å†…å­˜       â”‚
â”‚    â””â”€ åˆ›å»ºä¸´æ—¶æ ¹æ–‡ä»¶ç³»ç»Ÿ         â”‚
â”‚                                 â”‚  
â”‚ 2. æ‰§è¡Œ/initè„šæœ¬                â”‚
â”‚    â”œâ”€ æŒ‚è½½/proc, /sys, /dev     â”‚
â”‚    â”œâ”€ åŠ è½½å¿…è¦çš„å†…æ ¸æ¨¡å—         â”‚
â”‚    â””â”€ å‡†å¤‡ç¡¬ä»¶è®¾å¤‡èŠ‚ç‚¹          â”‚
â”‚                                 â”‚
â”‚ 3. ç¡¬ä»¶è®¾å¤‡æ£€æµ‹                 â”‚
â”‚    â”œâ”€ udevæ‰«æç¡¬ä»¶è®¾å¤‡          â”‚
â”‚    â”œâ”€ åˆ›å»ºè®¾å¤‡æ–‡ä»¶èŠ‚ç‚¹          â”‚
â”‚    â””â”€ å»ºç«‹è®¾å¤‡åç§°æ˜ å°„          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
ç¬¬äºŒé˜¶æ®µï¼šrootæ–‡ä»¶ç³»ç»Ÿå®šä½é˜¶æ®µ  
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. è§£æå†…æ ¸å¯åŠ¨å‚æ•°             â”‚
â”‚    â”œâ”€ root=UUID=xxx-xxx         â”‚
â”‚    â”œâ”€ root=LABEL=RootFS         â”‚
â”‚    â””â”€ root=/dev/sda1            â”‚
â”‚                                 â”‚
â”‚ 5. æŸ¥æ‰¾å¯¹åº”çš„çœŸå®è®¾å¤‡           â”‚
â”‚    â”œâ”€ UUIDæ˜ å°„åˆ°å…·ä½“è®¾å¤‡        â”‚
â”‚    â”œâ”€ ç­‰å¾…è®¾å¤‡å‡†å¤‡å°±ç»ª          â”‚
â”‚    â””â”€ éªŒè¯è®¾å¤‡å¯è®¿é—®æ€§          â”‚
â”‚                                 â”‚
â”‚ 6. æ–‡ä»¶ç³»ç»Ÿç±»å‹æ£€æµ‹             â”‚
â”‚    â”œâ”€ blkidæ£€æµ‹æ–‡ä»¶ç³»ç»Ÿç±»å‹     â”‚
â”‚    â”œâ”€ ç¡®è®¤æ–‡ä»¶ç³»ç»Ÿå®Œæ•´æ€§        â”‚
â”‚    â””â”€ åŠ è½½å¯¹åº”æ–‡ä»¶ç³»ç»Ÿé©±åŠ¨      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
ç¬¬ä¸‰é˜¶æ®µï¼šæ–‡ä»¶ç³»ç»ŸæŒ‚è½½é˜¶æ®µ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. é¢„å¤‡æ€§æ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥           â”‚
â”‚    â”œâ”€ fsckæ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿ          â”‚
â”‚    â”œâ”€ ä¿®å¤å‘ç°çš„é”™è¯¯            â”‚
â”‚    â””â”€ ç¡®ä¿æ–‡ä»¶ç³»ç»Ÿå¥åº·          â”‚
â”‚                                 â”‚
â”‚ 8. æŒ‚è½½rootæ–‡ä»¶ç³»ç»Ÿ             â”‚
â”‚    â”œâ”€ mount /dev/xxx /mnt       â”‚
â”‚    â”œâ”€ éªŒè¯æŒ‚è½½æˆåŠŸ              â”‚
â”‚    â””â”€ æ£€æŸ¥å…³é”®ç›®å½•ç»“æ„          â”‚
â”‚                                 â”‚
â”‚ 9. éªŒè¯ç³»ç»Ÿå®Œæ•´æ€§               â”‚
â”‚    â”œâ”€ æ£€æŸ¥/sbin/initæ˜¯å¦å­˜åœ¨    â”‚
â”‚    â”œâ”€ éªŒè¯å…³é”®ç³»ç»Ÿæ–‡ä»¶          â”‚
â”‚    â””â”€ ç¡®è®¤ç³»ç»Ÿå¯ä»¥æ­£å¸¸å¯åŠ¨      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
ç¬¬å››é˜¶æ®µï¼šç³»ç»Ÿåˆ‡æ¢é˜¶æ®µ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 10. pivot_rootç³»ç»Ÿåˆ‡æ¢          â”‚
â”‚     â”œâ”€ å°†/mntè®¾ä¸ºæ–°çš„æ ¹ç›®å½•     â”‚
â”‚     â”œâ”€ å°†initramfsç§»åˆ°/initrd   â”‚
â”‚     â””â”€ æ›´æ–°è¿›ç¨‹çš„æ ¹ç›®å½•å¼•ç”¨     â”‚
â”‚                                 â”‚
â”‚ 11. æ¸…ç†initramfs               â”‚
â”‚     â”œâ”€ å¸è½½ä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿ         â”‚
â”‚     â”œâ”€ é‡Šæ”¾initramfså ç”¨å†…å­˜    â”‚
â”‚     â””â”€ æ¸…ç†ä¸´æ—¶è®¾å¤‡èŠ‚ç‚¹         â”‚
â”‚                                 â”‚
â”‚ 12. å¯åŠ¨çœŸæ­£çš„initè¿›ç¨‹          â”‚
â”‚     â”œâ”€ exec /sbin/init          â”‚
â”‚     â”œâ”€ å¼€å§‹ç³»ç»ŸæœåŠ¡åˆå§‹åŒ–       â”‚
â”‚     â””â”€ è¿›å…¥æ­£å¸¸è¿è¡ŒçŠ¶æ€         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.4 rootå‚æ•°è§£ææœºåˆ¶


**ğŸ”§ å†…æ ¸å‘½ä»¤è¡Œrootå‚æ•°æ ¼å¼**ï¼š

```bash
# æŒ‰è®¾å¤‡è·¯å¾„æŒ‡å®šï¼ˆä¼ ç»Ÿæ–¹å¼ï¼‰
root=/dev/sda1
root=/dev/nvme0n1p1

# æŒ‰UUIDæŒ‡å®šï¼ˆæ¨èæ–¹å¼ï¼‰
root=UUID=550e8400-e29b-41d4-a716-446655440000

# æŒ‰å·æ ‡æŒ‡å®š
root=LABEL=rootfs
root=LABEL="Ubuntu Root"

# æŒ‰åˆ†åŒºæ ‡ç­¾æŒ‡å®šï¼ˆGPTï¼‰
root=PARTUUID=12345678-1234-1234-1234-123456789012

# ç½‘ç»œæ ¹æ–‡ä»¶ç³»ç»Ÿ
root=/dev/nfs nfsroot=192.168.1.100:/export/rootfs

# ç‰¹æ®Šæƒ…å†µ
root=/dev/ram0                    # RAMç£ç›˜
root=/dev/md0                     # è½¯RAIDè®¾å¤‡  
root=/dev/mapper/vg0-root         # LVMé€»è¾‘å·
```

**ğŸ’¡ ä¸ºä»€ä¹ˆæ¨èä½¿ç”¨UUID**ï¼š

```
è®¾å¤‡è·¯å¾„çš„é—®é¢˜ï¼š
/dev/sda1 å¯èƒ½å˜æˆ /dev/sdb1
â€¢ æ·»åŠ æ–°ç¡¬ç›˜ä¼šæ”¹å˜è®¾å¤‡é¡ºåº
â€¢ USBè®¾å¤‡å½±å“SATAè®¾å¤‡ç¼–å·
â€¢ ç³»ç»Ÿè¿ç§»æ—¶è®¾å¤‡åå¯èƒ½ä¸åŒ

UUIDçš„ä¼˜åŠ¿ï¼š
â€¢ å…¨çƒå”¯ä¸€ï¼Œä¸ä¼šé‡å¤
â€¢ ä¸éšç¡¬ä»¶å˜åŒ–è€Œæ”¹å˜
â€¢ ç³»ç»Ÿè¿ç§»æ—¶ä¿æŒä¸å˜
â€¢ æ›´å¯é çš„è®¾å¤‡è¯†åˆ«æ–¹å¼

æŸ¥çœ‹è®¾å¤‡UUIDï¼š
blkid /dev/sda1
lsblk -f
```

### 6.5 æ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥ä¸ä¿®å¤


**ğŸ” è‡ªåŠ¨æ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥**ï¼š

```bash
# initramfsä¸­çš„fscké€»è¾‘ï¼ˆç®€åŒ–ï¼‰
check_filesystem() {
    local device=$1
    local fstype=$(blkid -o value -s TYPE $device)
    
    case $fstype in
        ext2|ext3|ext4)
            # extç³»åˆ—æ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥
            if [ -x /sbin/e2fsck ]; then
                echo "æ£€æŸ¥extæ–‡ä»¶ç³»ç»Ÿ..."
                e2fsck -p $device  # -pè‡ªåŠ¨ä¿®å¤
            fi
            ;;
        xfs)
            # XFSæ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥
            if [ -x /sbin/xfs_repair ]; then
                xfs_repair -n $device  # -nåªæ£€æŸ¥ä¸ä¿®å¤
            fi
            ;;
        *)
            echo "æœªçŸ¥æ–‡ä»¶ç³»ç»Ÿç±»å‹: $fstype"
            ;;
    esac
}
```

**âš ï¸ æ–‡ä»¶ç³»ç»Ÿé”™è¯¯å¤„ç†**ï¼š

```
é”™è¯¯ä¸¥é‡ç¨‹åº¦åˆ†ç±»ï¼š

è½»å¾®é”™è¯¯ï¼ˆè‡ªåŠ¨ä¿®å¤ï¼‰ï¼š
â€¢ æ–‡ä»¶ç³»ç»Ÿdirtyæ ‡å¿—
â€¢ inodeæ—¶é—´æˆ³ä¸ä¸€è‡´
â€¢ ç›®å½•é¡¹æ ¡éªŒé”™è¯¯

ä¸¥é‡é”™è¯¯ï¼ˆéœ€è¦ç¡®è®¤ï¼‰ï¼š
â€¢ è¶…çº§å—æŸå  
â€¢ inodeè¡¨æŸå
â€¢ å¤§é‡æ–‡ä»¶ç³»ç»Ÿé”™è¯¯

è‡´å‘½é”™è¯¯ï¼ˆæ— æ³•ä¿®å¤ï¼‰ï¼š
â€¢ ç£ç›˜ç¡¬ä»¶æ•…éšœ
â€¢ ä¸¥é‡çš„æ•°æ®ç»“æ„ç ´å
â€¢ åŠ å¯†æ–‡ä»¶ç³»ç»Ÿå¯†é’¥é”™è¯¯

å¤„ç†ç­–ç•¥ï¼š
è½»å¾® â†’ è‡ªåŠ¨ä¿®å¤ç»§ç»­å¯åŠ¨
ä¸¥é‡ â†’ è¯¢é—®ç”¨æˆ·æ˜¯å¦å¼ºåˆ¶ä¿®å¤
è‡´å‘½ â†’ è¿›å…¥æ•‘æ´æ¨¡å¼
```

### 6.6 pivot_rootåˆ‡æ¢æœºåˆ¶


**ğŸ”„ pivot_rootè¯¦ç»†è¿‡ç¨‹**ï¼š

```
åˆ‡æ¢å‰çš„ç›®å½•ç»“æ„ï¼š
/                    # initramfsæ ¹ç›®å½•
â”œâ”€â”€ bin/, sbin/      # initramfså·¥å…·
â”œâ”€â”€ mnt/             # çœŸæ­£æ ¹æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ç‚¹
â”‚   â”œâ”€â”€ bin/, sbin/  # çœŸæ­£çš„ç³»ç»Ÿæ–‡ä»¶
â”‚   â”œâ”€â”€ etc/, usr/   
â”‚   â””â”€â”€ ...
â””â”€â”€ ...

pivot_rootæ‰§è¡Œè¿‡ç¨‹ï¼š
1. pivot_root /mnt /mnt/initramfs
   ä½œç”¨ï¼šäº¤æ¢æ ¹ç›®å½•å’ŒæŒ‡å®šç›®å½•

åˆ‡æ¢åçš„ç›®å½•ç»“æ„ï¼š
/                    # ç°åœ¨æ˜¯çœŸæ­£çš„æ ¹æ–‡ä»¶ç³»ç»Ÿ
â”œâ”€â”€ bin/, sbin/      # çœŸæ­£çš„ç³»ç»Ÿæ–‡ä»¶  
â”œâ”€â”€ etc/, usr/
â”œâ”€â”€ initramfs/       # åŸæ¥çš„initramfs
â”‚   â”œâ”€â”€ bin/, sbin/  # initramfså·¥å…·
â”‚   â””â”€â”€ ...
â””â”€â”€ ...

2. æ¸…ç†é˜¶æ®µï¼š
umount /initramfs    # å¸è½½initramfs
rm -rf /initramfs    # åˆ é™¤ç›®å½•
# initramfså ç”¨çš„å†…å­˜è¢«é‡Šæ”¾
```

### 6.7 æŒ‚è½½å¤±è´¥çš„æ•…éšœæ’æŸ¥


**ğŸš¨ å¸¸è§æŒ‚è½½å¤±è´¥åŸå› **ï¼š

```bash
# 1. è®¾å¤‡æ‰¾ä¸åˆ°
é”™è¯¯ï¼šVFS: Cannot open root device "sda1" or unknown-block(0,0)
åŸå› ï¼š
â€¢ è®¾å¤‡é©±åŠ¨æœªåŠ è½½
â€¢ è®¾å¤‡è·¯å¾„é”™è¯¯  
â€¢ ç¡¬ç›˜ç¡¬ä»¶æ•…éšœ

æ’æŸ¥æ–¹æ³•ï¼š
ls /dev/sd*          # æ£€æŸ¥è®¾å¤‡æ˜¯å¦å­˜åœ¨
dmesg | grep -i ata  # æŸ¥çœ‹ç¡¬ç›˜æ£€æµ‹æ—¥å¿—

# 2. æ–‡ä»¶ç³»ç»Ÿç±»å‹é”™è¯¯  
é”™è¯¯ï¼šVFS: Unable to mount root fs on unknown-block
åŸå› ï¼š
â€¢ æ–‡ä»¶ç³»ç»Ÿé©±åŠ¨æœªåŠ è½½
â€¢ æ–‡ä»¶ç³»ç»ŸæŸå
â€¢ æ–‡ä»¶ç³»ç»Ÿç±»å‹è¯†åˆ«é”™è¯¯

æ’æŸ¥æ–¹æ³•ï¼š
lsmod | grep ext4    # æ£€æŸ¥é©±åŠ¨æ˜¯å¦åŠ è½½
blkid /dev/sda1      # æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿç±»å‹

# 3. UUIDä¸åŒ¹é…
é”™è¯¯ï¼šGave up waiting for root device
åŸå› ï¼š
â€¢ UUIDè¾“å…¥é”™è¯¯
â€¢ è®¾å¤‡UUIDæ”¹å˜
â€¢ è®¾å¤‡æœªåŠæ—¶å‡†å¤‡å¥½

æ’æŸ¥æ–¹æ³•ï¼š
blkid                # æŸ¥çœ‹æ‰€æœ‰è®¾å¤‡UUID
ls -l /dev/disk/by-uuid/  # æ£€æŸ¥UUIDé“¾æ¥
```

**ğŸ› ï¸ æ•‘æ´æ¨¡å¼å¤„ç†**ï¼š

```bash
# å†…æ ¸å‚æ•°æ·»åŠ æ•‘æ´é€‰é¡¹
init=/bin/bash           # ç›´æ¥å¯åŠ¨bash
rd.shell                 # initramfsä¸­å¯åŠ¨shell
rd.break=pre-mount       # åœ¨æŒ‚è½½å‰åœæ­¢
rd.debug                 # å¼€å¯è°ƒè¯•è¾“å‡º

# initramfsæ•‘æ´shellä¸­çš„æ“ä½œ
# æ‰‹åŠ¨æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿ
mount /dev/sda1 /mnt

# æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿ
e2fsck -f /dev/sda1

# æŸ¥çœ‹è®¾å¤‡ä¿¡æ¯
blkid
lsblk -f

# æ‰‹åŠ¨pivot_root
pivot_root /mnt /mnt/initramfs
exec chroot . /sbin/init
```

**ğŸ§  è®°å¿†è¦ç‚¹**ï¼š

```
rootæ–‡ä»¶ç³»ç»ŸæŒ‚è½½æµç¨‹è®°å¿†å£è¯€ï¼š
"å‡†å®šæŸ¥æŒ‚è½¬" 
â€¢ å‡†ï¼šå‡†å¤‡initramfsç¯å¢ƒ
â€¢ å®šï¼šå®šä½rootè®¾å¤‡
â€¢ æŸ¥ï¼šæ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿ
â€¢ æŒ‚ï¼šæŒ‚è½½rootæ–‡ä»¶ç³»ç»Ÿ
â€¢ è½¬ï¼špivot_rootè½¬æ¢æ ¹ç›®å½•

æ•…éšœæ’æŸ¥æ€è·¯ï¼š
"è®¾é©±æ–‡æŒ‚å‚"
â€¢ è®¾ï¼šè®¾å¤‡æ˜¯å¦å­˜åœ¨
â€¢ é©±ï¼šé©±åŠ¨æ˜¯å¦åŠ è½½  
â€¢ æ–‡ï¼šæ–‡ä»¶ç³»ç»Ÿæ˜¯å¦æ­£å¸¸
â€¢ æŒ‚ï¼šæŒ‚è½½è¿‡ç¨‹æ˜¯å¦æˆåŠŸ
â€¢ å‚ï¼šå†…æ ¸å‚æ•°æ˜¯å¦æ­£ç¡®
```

---

## 7. âš™ï¸ å†…æ ¸å‘½ä»¤è¡Œå‚æ•°è¯¦è§£


### 7.1 å†…æ ¸å‘½ä»¤è¡Œå‚æ•°åŸºæœ¬æ¦‚å¿µ


**ğŸ”§ ä»€ä¹ˆæ˜¯å†…æ ¸å‘½ä»¤è¡Œå‚æ•°**ï¼š

```
ç®€å•ç†è§£ï¼š
å†…æ ¸å‘½ä»¤è¡Œå‚æ•° = ç»™æ“ä½œç³»ç»Ÿçš„"å¯åŠ¨æŒ‡ä»¤"

ç”Ÿæ´»ç±»æ¯”ï¼š
å¯åŠ¨ç”µè„‘ = å¼€è½¦å‡ºé—¨
å†…æ ¸å‚æ•° = å‡ºé—¨å‰çš„å‡†å¤‡æŒ‡ä»¤

æ™®é€šå¯åŠ¨ï¼š
"æˆ‘è¦å¼€è½¦å»ä¸Šç­"ï¼ˆä½¿ç”¨é»˜è®¤è®¾ç½®ï¼‰

å¸¦å‚æ•°å¯åŠ¨ï¼š
"æˆ‘è¦å¼€è½¦å»ä¸Šç­ï¼Œå¼€æš–æ°”ï¼Œæ”¾éŸ³ä¹ï¼Œèµ°é«˜é€Ÿè·¯çº¿"
ï¼ˆæŒ‡å®šå…·ä½“çš„å¯åŠ¨é€‰é¡¹å’Œè¡Œä¸ºï¼‰
```

**ğŸ’¡ å†…æ ¸å‚æ•°çš„ä½œç”¨**ï¼š
```
ä¸»è¦ç”¨é€”ï¼š
1. ğŸ”§ ç¡¬ä»¶é…ç½®ï¼šå‘Šè¯‰å†…æ ¸å¦‚ä½•å¤„ç†ç¡¬ä»¶
2. ğŸ—‚ï¸ å¯åŠ¨é€‰é¡¹ï¼šæŒ‡å®šæ ¹æ–‡ä»¶ç³»ç»Ÿã€å¯åŠ¨æ¨¡å¼ç­‰
3. ğŸ› è°ƒè¯•æ§åˆ¶ï¼šå¼€å¯è°ƒè¯•ä¿¡æ¯ã€æ•‘æ´æ¨¡å¼ç­‰
4. âš¡ æ€§èƒ½è°ƒä¼˜ï¼šè®¾ç½®å†…å­˜ã€CPUç›¸å…³å‚æ•°
5. ğŸ” å®‰å…¨è®¾ç½®ï¼šå¯åŠ¨æ—¶çš„å®‰å…¨ç›¸å…³é…ç½®
```

### 7.2 å†…æ ¸å‚æ•°çš„ä¼ é€’æœºåˆ¶


**ğŸ“¡ å‚æ•°ä¼ é€’è·¯å¾„**ï¼š

```
å‚æ•°ä¼ é€’æµç¨‹ï¼š
GRUBé…ç½®æ–‡ä»¶ â†’ å¼•å¯¼åŠ è½½å™¨ â†’ å†…æ ¸ â†’ initramfs â†’ ç”¨æˆ·ç©ºé—´

è¯¦ç»†è¿‡ç¨‹ï¼š
1. ç”¨æˆ·ç¼–è¾‘GRUBé…ç½®
   â”œâ”€ /etc/default/grub
   â””â”€ /etc/grub.d/ç›®å½•ä¸‹çš„è„šæœ¬

2. GRUBç”Ÿæˆå¼•å¯¼èœå•
   â””â”€ /boot/grub/grub.cfg

3. å¯åŠ¨æ—¶GRUBè¯»å–é…ç½®
   â””â”€ å°†å‚æ•°ä¼ é€’ç»™å†…æ ¸

4. å†…æ ¸è§£æå’Œåº”ç”¨å‚æ•°
   â”œâ”€ å†…æ ¸è‡ªç”¨çš„å‚æ•°ï¼ˆå¦‚quietï¼‰
   â””â”€ ä¼ é€’ç»™initçš„å‚æ•°

5. ç”¨æˆ·ç©ºé—´ç¨‹åºè·å–å‚æ•°
   â””â”€ /proc/cmdlineæ–‡ä»¶
```

**ğŸ” æŸ¥çœ‹å½“å‰å†…æ ¸å‚æ•°**ï¼š
```bash
# æŸ¥çœ‹å½“å‰å¯åŠ¨æ—¶ä½¿ç”¨çš„å†…æ ¸å‚æ•°
cat /proc/cmdline

# å…¸å‹è¾“å‡ºç¤ºä¾‹
BOOT_IMAGE=/boot/vmlinuz-5.15.0-72-generic root=UUID=550e8400-e29b-41d4-a716-446655440000 ro quiet splash

# åœ¨GRUBå¯åŠ¨èœå•ä¸­ä¸´æ—¶ç¼–è¾‘ï¼ˆå¯åŠ¨æ—¶æŒ‰eé”®ï¼‰
linux   /boot/vmlinuz-5.15.0-72-generic root=UUID=xxx ro quiet
# å¯ä»¥åœ¨è¿™è¡Œæœ«å°¾æ·»åŠ ä¸´æ—¶å‚æ•°
```

### 7.3 å¸¸ç”¨å†…æ ¸å‚æ•°åˆ†ç±»è¯¦è§£


#### ğŸ—‚ï¸ æ ¹æ–‡ä»¶ç³»ç»Ÿç›¸å…³å‚æ•°


```bash
# rootå‚æ•°ï¼šæŒ‡å®šæ ¹æ–‡ä»¶ç³»ç»Ÿ
root=/dev/sda1                    # æŒ‰è®¾å¤‡å
root=UUID=550e8400-e29b-41d4...   # æŒ‰UUIDï¼ˆæ¨èï¼‰
root=LABEL=rootfs                 # æŒ‰å·æ ‡
root=/dev/nfs                     # ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿ

# rootfstypeï¼šå¼ºåˆ¶æŒ‡å®šæ ¹æ–‡ä»¶ç³»ç»Ÿç±»å‹
rootfstype=ext4                   # å¼ºåˆ¶ä½¿ç”¨ext4
rootfstype=xfs                    # å¼ºåˆ¶ä½¿ç”¨xfs

# ro/rwï¼šæ ¹æ–‡ä»¶ç³»ç»ŸæŒ‚è½½æ–¹å¼
ro                               # åªè¯»æŒ‚è½½ï¼ˆé»˜è®¤ï¼Œå®‰å…¨ï¼‰
rw                               # è¯»å†™æŒ‚è½½ï¼ˆä¸€èˆ¬ä¸æ¨èï¼‰

# rootdelayï¼šç­‰å¾…æ ¹è®¾å¤‡å‡†å¤‡çš„æ—¶é—´
rootdelay=10                     # ç­‰å¾…10ç§’å†æŒ‚è½½æ ¹åˆ†åŒº
# é€‚ç”¨äºUSBå¯åŠ¨æˆ–æ…¢é€Ÿå­˜å‚¨è®¾å¤‡

# rootflagsï¼šæŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿçš„é¢å¤–é€‰é¡¹
rootflags=data=journal           # ext4æ—¥å¿—æ¨¡å¼
rootflags=noatime                # ç¦ç”¨è®¿é—®æ—¶é—´æ›´æ–°
```

#### ğŸš€ å¯åŠ¨è¡Œä¸ºæ§åˆ¶å‚æ•°


```bash
# initï¼šæŒ‡å®šinitç¨‹åº
init=/sbin/init                  # é»˜è®¤initç¨‹åº
init=/bin/bash                   # ç›´æ¥å¯åŠ¨bashï¼ˆæ•‘æ´ï¼‰
init=/sbin/runit                 # ä½¿ç”¨ä¸åŒçš„initç³»ç»Ÿ

# single/1ï¼šå•ç”¨æˆ·æ¨¡å¼
single                           # å•ç”¨æˆ·æ¨¡å¼å¯åŠ¨
1                               # åŒä¸Šï¼ˆç®€å†™ï¼‰
# ç”¨äºç³»ç»Ÿç»´æŠ¤å’Œæ•…éšœæ¢å¤

# quietï¼šå®‰é™æ¨¡å¼
quiet                           # å‡å°‘å¯åŠ¨ä¿¡æ¯è¾“å‡º
# åä¹‹ï¼šverbose æ˜¾ç¤ºè¯¦ç»†å¯åŠ¨ä¿¡æ¯

# splashï¼šå¯åŠ¨ç”»é¢
splash                          # æ˜¾ç¤ºå›¾å½¢å¯åŠ¨ç”»é¢
nosplash                        # ç¦ç”¨å¯åŠ¨ç”»é¢

# debugï¼šè°ƒè¯•æ¨¡å¼
debug                           # å¼€å¯å†…æ ¸è°ƒè¯•ä¿¡æ¯
systemd.log_level=debug         # systemdè¯¦ç»†æ—¥å¿—
```

#### ğŸ”§ ç¡¬ä»¶ç›¸å…³å‚æ•°


```bash
# å†…å­˜ç›¸å…³
mem=1024M                       # é™åˆ¶å†…æ ¸ä½¿ç”¨çš„å†…å­˜
memmap=exactmap                 # ä½¿ç”¨BIOSæä¾›çš„å†…å­˜æ˜ å°„
highmem=off                     # ç¦ç”¨é«˜ç«¯å†…å­˜

# CPUç›¸å…³  
maxcpus=2                       # é™åˆ¶ä½¿ç”¨çš„CPUæ ¸å¿ƒæ•°
nosmp                           # ç¦ç”¨SMPå¤šæ ¸æ”¯æŒ
noapic                          # ç¦ç”¨APIC

# å­˜å‚¨è®¾å¤‡ç›¸å…³
ide=nodma                       # ç¦ç”¨IDE DMA
libata.force=noncq             # ç¦ç”¨SATA NCQ
elevator=deadline               # è®¾ç½®I/Oè°ƒåº¦å™¨

# ç½‘ç»œç›¸å…³
ip=dhcp                         # ç½‘ç»œå¯åŠ¨æ—¶ä½¿ç”¨DHCP
nfsroot=192.168.1.100:/export   # NFSæ ¹æ–‡ä»¶ç³»ç»Ÿè·¯å¾„
```

#### ğŸ› è°ƒè¯•å’Œæ•‘æ´å‚æ•°


```bash
# initramfsè°ƒè¯•å‚æ•°
rd.shell                        # initramfsä¸­å¯åŠ¨shell
rd.break=pre-mount              # åœ¨æŒ‚è½½å‰æš‚åœ
rd.break=pre-pivot              # åœ¨pivot_rootå‰æš‚åœ
rd.debug                        # å¼€å¯initramfsè°ƒè¯•
rd.info                         # æ˜¾ç¤ºinitramfsä¿¡æ¯

# å†…æ ¸è°ƒè¯•å‚æ•°
loglevel=7                      # è®¾ç½®æ—¥å¿—çº§åˆ«ï¼ˆ0-7ï¼‰
ignore_loglevel                 # æ˜¾ç¤ºæ‰€æœ‰å†…æ ¸æ¶ˆæ¯
earlyprintk=serial              # æ—©æœŸä¸²å£è¾“å‡º
console=tty0                    # æ§åˆ¶å°è¾“å‡ºåˆ°ç»ˆç«¯
console=ttyS0,115200            # ä¸²å£æ§åˆ¶å°

# æ•…éšœæ’æŸ¥å‚æ•°
panic=10                        # panicå10ç§’é‡å¯
oops=panic                      # oopsæ—¶è§¦å‘panic
nmi_watchdog=1                  # å¼€å¯NMIçœ‹é—¨ç‹—
```

### 7.4 GRUBé…ç½®ä¸­çš„å‚æ•°è®¾ç½®


**ğŸ“ æ°¸ä¹…è®¾ç½®å†…æ ¸å‚æ•°**ï¼š

```bash
# ç¼–è¾‘GRUBé»˜è®¤é…ç½®
sudo nano /etc/default/grub

# åœ¨GRUB_CMDLINE_LINUX_DEFAULTä¸­æ·»åŠ å‚æ•°
GRUB_CMDLINE_LINUX_DEFAULT="quiet splash systemd.show_status=1"

# åœ¨GRUB_CMDLINE_LINUXä¸­æ·»åŠ å‚æ•°ï¼ˆæ€»æ˜¯ç”Ÿæ•ˆï¼‰
GRUB_CMDLINE_LINUX="rd.lvm.lv=ubuntu-vg/root"

# æ›´æ–°GRUBé…ç½®
sudo update-grub
# æˆ–è€…åœ¨æŸäº›ç³»ç»Ÿä¸Š
sudo grub-mkconfig -o /boot/grub/grub.cfg
```

**âš¡ ä¸´æ—¶è®¾ç½®å†…æ ¸å‚æ•°**ï¼š
```
å¯åŠ¨æ—¶ä¸´æ—¶ä¿®æ”¹ï¼š
1. é‡å¯ç”µè„‘ï¼Œåœ¨GRUBèœå•å‡ºç°æ—¶æŒ‰'e'é”®
2. æ‰¾åˆ°linuxå¼€å¤´çš„è¡Œ
3. åœ¨è¡Œæœ«æ·»åŠ éœ€è¦çš„å‚æ•°
4. æŒ‰Ctrl+Xæˆ–F10å¯åŠ¨

è¿™ç§æ–¹å¼åªå¯¹å½“å‰å¯åŠ¨æœ‰æ•ˆ
```

### 7.5 å®ç”¨å‚æ•°ç»„åˆç¤ºä¾‹


**ğŸ’¼ å¸¸è§åº”ç”¨åœºæ™¯**ï¼š

```bash
# åœºæ™¯1ï¼šç³»ç»Ÿæ•‘æ´
# å•ç”¨æˆ·æ¨¡å¼ï¼Œç›´æ¥å¯åŠ¨bash
linux ... single init=/bin/bash rw

# åœºæ™¯2ï¼šè°ƒè¯•å¯åŠ¨é—®é¢˜  
# æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ï¼Œinitramfsä¸­å¯åŠ¨shell
linux ... rd.shell rd.debug systemd.log_level=debug

# åœºæ™¯3ï¼šæ€§èƒ½ä¼˜åŒ–å¯åŠ¨
# ç¦ç”¨ä¸å¿…è¦åŠŸèƒ½ï¼ŒåŠ é€Ÿå¯åŠ¨
linux ... quiet loglevel=1 systemd.show_status=false

# åœºæ™¯4ï¼šç¡¬ä»¶å…¼å®¹æ€§é—®é¢˜
# ç¦ç”¨å¯èƒ½æœ‰é—®é¢˜çš„ç¡¬ä»¶åŠŸèƒ½
linux ... noapic nolapic nosmp acpi=off

# åœºæ™¯5ï¼šç½‘ç»œå¯åŠ¨
# PXEç½‘ç»œå¯åŠ¨é…ç½®
linux ... root=/dev/nfs ip=dhcp nfsroot=192.168.1.100:/export/rootfs

# åœºæ™¯6ï¼šåŠ å¯†æ–‡ä»¶ç³»ç»Ÿ
# LUKSåŠ å¯†æ ¹åˆ†åŒº
linux ... root=/dev/mapper/root-crypt rd.luks.uuid=xxx-xxx

# åœºæ™¯7ï¼šLVMæ ¹åˆ†åŒº
# LVMé€»è¾‘å·ä½œä¸ºæ ¹åˆ†åŒº
linux ... root=/dev/mapper/vg0-root rd.lvm.lv=vg0/root
```

### 7.6 å‚æ•°ä¼˜å…ˆçº§å’Œè§£æè§„åˆ™


**ğŸ“Š å‚æ•°è§£æä¼˜å…ˆçº§**ï¼š

```
ä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼š
1. å‘½ä»¤è¡Œä¸­åé¢çš„å‚æ•°è¦†ç›–å‰é¢çš„
   å¦‚ï¼šro rw  æœ€ç»ˆç»“æœæ˜¯rw

2. å†…æ ¸å‚æ•° > æ¨¡å—å‚æ•°
   å†…æ ¸ç›´æ¥è¯†åˆ«çš„å‚æ•°ä¼˜å…ˆå¤„ç†

3. æ—©æœŸå‚æ•° > æ™šæœŸå‚æ•°  
   early_param > __setup

å‚æ•°æ ¼å¼è§„åˆ™ï¼š
â€¢ ç®€å•å‚æ•°ï¼šquietã€debug
â€¢ é”®å€¼å‚æ•°ï¼šroot=xxxã€loglevel=7  
â€¢ åˆ—è¡¨å‚æ•°ï¼šconsole=tty0 console=ttyS0
â€¢ æ¨¡å—å‚æ•°ï¼šmodule.param=value
```

**ğŸ” å‚æ•°æœ‰æ•ˆæ€§éªŒè¯**ï¼š
```bash
# éªŒè¯å‚æ•°æ˜¯å¦è¢«å†…æ ¸è¯†åˆ«
dmesg | grep -i "unknown parameter"
dmesg | grep -i "ignored parameter"

# æŸ¥çœ‹å†…æ ¸å‚æ•°ä½¿ç”¨æƒ…å†µ
cat /proc/cmdline
grep -r "cmdline" /sys/module/*/parameters/

# æ£€æŸ¥ç‰¹å®šå‚æ•°æ˜¯å¦ç”Ÿæ•ˆ
# ä¾‹å¦‚æ£€æŸ¥quietå‚æ•°
dmesg | grep -c "Linux version"  # åº”è¯¥åªæœ‰1è¡Œè¾“å‡º
```

---

## 8. ğŸ”§ initramfsè°ƒè¯•ä¸æ•…éšœæ’æŸ¥å®æˆ˜


### 8.1 initramfsæ•…éšœçš„å¸¸è§è¡¨ç°


**ğŸ’¥ å…¸å‹æ•…éšœç°è±¡**ï¼š

```
ç—‡çŠ¶1ï¼šç³»ç»Ÿåœåœ¨"Loading initial ramdisk"
å¯èƒ½åŸå› ï¼š
â€¢ initramfsæ–‡ä»¶æŸå
â€¢ å†…å­˜ä¸è¶³æ— æ³•åŠ è½½initramfs
â€¢ GRUBé…ç½®é”™è¯¯

ç—‡çŠ¶2ï¼šKernel panic - not syncing: VFS: Unable to mount root fs
å¯èƒ½åŸå› ï¼š
â€¢ æ ¹è®¾å¤‡æ‰¾ä¸åˆ°
â€¢ æ–‡ä»¶ç³»ç»Ÿé©±åŠ¨ç¼ºå¤±
â€¢ UUID/LABELé”™è¯¯

ç—‡çŠ¶3ï¼šç³»ç»Ÿè¿›å…¥initramfs emergency shell
å¯èƒ½åŸå› ï¼š
â€¢ æ ¹åˆ†åŒºæŒ‚è½½å¤±è´¥
â€¢ æ–‡ä»¶ç³»ç»ŸæŸåéœ€è¦ä¿®å¤
â€¢ é©±åŠ¨ç¨‹åºé—®é¢˜

ç—‡çŠ¶4ï¼šç³»ç»Ÿå¯åŠ¨æå…¶ç¼“æ…¢ï¼Œé•¿æ—¶é—´ç­‰å¾…
å¯èƒ½åŸå› ï¼š
â€¢ ç­‰å¾…ä¸å­˜åœ¨çš„è®¾å¤‡
â€¢ USBè®¾å¤‡æ‰«æè¶…æ—¶
â€¢ ç½‘ç»œé…ç½®ç­‰å¾…è¶…æ—¶
```

### 8.2 å¼€å¯è°ƒè¯•æ¨¡å¼


**ğŸ” å¯ç”¨è°ƒè¯•è¾“å‡º**ï¼š

```bash
# åœ¨GRUBå¯åŠ¨æ—¶æ·»åŠ è°ƒè¯•å‚æ•°
linux ... rd.debug rd.info systemd.log_level=debug loglevel=7

# è°ƒè¯•å‚æ•°è¯´æ˜ï¼š
rd.debug              # initramfsè¯¦ç»†è°ƒè¯•ä¿¡æ¯
rd.info               # initramfsä¸€èˆ¬ä¿¡æ¯è¾“å‡º
rd.shell              # å¤±è´¥æ—¶è¿›å…¥emergency shell
systemd.log_level=debug   # systemdè¯¦ç»†æ—¥å¿—
loglevel=7            # å†…æ ¸æœ€è¯¦ç»†æ—¥å¿—çº§åˆ«
ignore_loglevel       # å¿½ç•¥æ—¥å¿—çº§åˆ«é™åˆ¶ï¼Œæ˜¾ç¤ºæ‰€æœ‰æ¶ˆæ¯
```

**ğŸ“Š è°ƒè¯•è¾“å‡ºè§£è¯»**ï¼š
```bash
# å…¸å‹è°ƒè¯•è¾“å‡ºç¤ºä¾‹
dracut: *** Including module: base ***
dracut: *** Including module: systemd ***
dracut: *** Including module: udev-rules ***
dracut: *** Resolving executable dependencies ***
dracut: *** Hardlinking files ***
dracut: *** Generating early-microcode initramfs ***

# å…³é”®ä¿¡æ¯è¯†åˆ«ï¼š
dracut: Including module    # åŒ…å«çš„åŠŸèƒ½æ¨¡å—
dracut: Installing          # å®‰è£…çš„æ–‡ä»¶å’Œé©±åŠ¨
dracut: Executing          # æ‰§è¡Œçš„è„šæœ¬å’Œå‘½ä»¤
```

### 8.3 Emergency Shellè°ƒè¯•æŠ€å·§


**ğŸš¨ è¿›å…¥Emergency Shellçš„æ–¹æ³•**ï¼š

```bash
# æ–¹æ³•1ï¼šå†…æ ¸å‚æ•°æ–¹å¼
rd.shell rd.break=cmdline    # åœ¨è§£æå‘½ä»¤è¡Œååœæ­¢
rd.break=pre-udev           # åœ¨udevå¯åŠ¨å‰åœæ­¢
rd.break=pre-trigger        # åœ¨è®¾å¤‡è§¦å‘å‰åœæ­¢
rd.break=pre-mount          # åœ¨æŒ‚è½½å‰åœæ­¢
rd.break=pre-pivot          # åœ¨pivot_rootå‰åœæ­¢

# æ–¹æ³•2ï¼šæ•…éšœè‡ªåŠ¨è§¦å‘
# å½“initramfsæ— æ³•å®Œæˆä»»åŠ¡æ—¶ä¼šè‡ªåŠ¨è¿›å…¥
```

**ğŸ”§ Emergency Shellä¸­çš„è°ƒè¯•å‘½ä»¤**ï¼š

```bash
# 1. ç¯å¢ƒæ£€æŸ¥å‘½ä»¤
pwd                         # å½“å‰ç›®å½•ï¼ˆåº”è¯¥æ˜¯/ï¼‰
ls -la                      # æŸ¥çœ‹initramfsæ ¹ç›®å½•ç»“æ„
mount                       # æŸ¥çœ‹å·²æŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿ
cat /proc/cmdline           # æŸ¥çœ‹å†…æ ¸å¯åŠ¨å‚æ•°

# 2. ç¡¬ä»¶è®¾å¤‡æ£€æŸ¥
ls /dev/sd*                 # æŸ¥çœ‹SATA/SCSIè®¾å¤‡
ls /dev/nvme*               # æŸ¥çœ‹NVMeè®¾å¤‡
ls /dev/mapper/             # æŸ¥çœ‹è®¾å¤‡æ˜ å°„ï¼ˆLVM/LUKSï¼‰
lsblk                       # æ˜¾ç¤ºå—è®¾å¤‡æ ‘çŠ¶ç»“æ„

# 3. æ¨¡å—å’Œé©±åŠ¨æ£€æŸ¥
lsmod                       # æŸ¥çœ‹å·²åŠ è½½æ¨¡å—
modprobe -l | grep ext4     # æŸ¥çœ‹å¯ç”¨çš„ext4æ¨¡å—
dmesg | grep -i error       # æŸ¥çœ‹å†…æ ¸é”™è¯¯ä¿¡æ¯
cat /proc/modules           # æŸ¥çœ‹æ¨¡å—è¯¦ç»†ä¿¡æ¯

# 4. æ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥
blkid                       # æŸ¥çœ‹æ‰€æœ‰åˆ†åŒºçš„UUIDå’Œç±»å‹
blkid /dev/sda1             # æŸ¥çœ‹ç‰¹å®šåˆ†åŒºä¿¡æ¯
file -s /dev/sda1           # æŸ¥çœ‹åˆ†åŒºæ–‡ä»¶ç³»ç»Ÿç±»å‹
```

### 8.4 å¸¸è§é—®é¢˜çš„è¯Šæ–­æµç¨‹


**ğŸ” é—®é¢˜è¯Šæ–­å†³ç­–æ ‘**ï¼š

```
å¯åŠ¨å¤±è´¥è¯Šæ–­æµç¨‹ï¼š

ç¬¬ä¸€æ­¥ï¼šç¡®è®¤è®¾å¤‡æ˜¯å¦å­˜åœ¨
â”œâ”€ ls /dev/sd* æˆ– lsblk
â”œâ”€ è®¾å¤‡ä¸å­˜åœ¨ â†’ æ£€æŸ¥ç¡¬ä»¶è¿æ¥ã€é©±åŠ¨æ¨¡å—
â””â”€ è®¾å¤‡å­˜åœ¨ â†’ ç»§ç»­ä¸‹ä¸€æ­¥

ç¬¬äºŒæ­¥ï¼šç¡®è®¤UUID/LABELæ˜¯å¦æ­£ç¡®
â”œâ”€ blkid æŸ¥çœ‹å®é™…UUID
â”œâ”€ cat /proc/cmdline æŸ¥çœ‹å¯åŠ¨å‚æ•°ä¸­çš„UUID
â”œâ”€ UUIDä¸åŒ¹é… â†’ æ›´æ–°GRUBé…ç½®
â””â”€ UUIDåŒ¹é… â†’ ç»§ç»­ä¸‹ä¸€æ­¥

ç¬¬ä¸‰æ­¥ï¼šç¡®è®¤æ–‡ä»¶ç³»ç»Ÿæ˜¯å¦æ­£å¸¸
â”œâ”€ file -s /dev/sda1 æŸ¥çœ‹æ–‡ä»¶ç³»ç»Ÿ
â”œâ”€ æ–‡ä»¶ç³»ç»ŸæŸå â†’ è¿è¡Œfsckä¿®å¤
â”œâ”€ æ–‡ä»¶ç³»ç»Ÿæ­£å¸¸ä½†æ— æ³•æŒ‚è½½ â†’ æ£€æŸ¥é©±åŠ¨
â””â”€ å¯ä»¥æŒ‚è½½ â†’ ç»§ç»­ä¸‹ä¸€æ­¥

ç¬¬å››æ­¥ï¼šç¡®è®¤æ ¹åˆ†åŒºå†…å®¹æ˜¯å¦å®Œæ•´
â”œâ”€ mkdir /mnt && mount /dev/sda1 /mnt
â”œâ”€ ls /mnt æŸ¥çœ‹æ ¹åˆ†åŒºå†…å®¹
â”œâ”€ ç¼ºå°‘å…³é”®æ–‡ä»¶ â†’ ç³»ç»Ÿæ–‡ä»¶æŸå
â””â”€ æ–‡ä»¶å®Œæ•´ â†’ æ£€æŸ¥initramfsé…ç½®
```

### 8.5 å…·ä½“æ•…éšœæ¡ˆä¾‹ä¸è§£å†³


**ğŸ“‹ æ¡ˆä¾‹1ï¼šUUIDä¸åŒ¹é…å¯¼è‡´æ— æ³•å¯åŠ¨**

```bash
# ç—‡çŠ¶ï¼šWaiting for root device UUID=xxx-xxx
# åœ¨emergency shellä¸­è¯Šæ–­ï¼š

# 1. æŸ¥çœ‹å½“å‰ç³»ç»Ÿçš„å®é™…UUID
blkid
# è¾“å‡ºï¼š/dev/sda1: UUID="550e8400-e29b-41d4-a716-446655440001"

# 2. æŸ¥çœ‹å¯åŠ¨å‚æ•°ä¸­çš„UUID
cat /proc/cmdline
# è¾“å‡ºï¼šroot=UUID=550e8400-e29b-41d4-a716-446655440000

# 3. å‘ç°UUIDä¸åŒ¹é…ï¼Œä¸´æ—¶è§£å†³ï¼š
# æ‰‹åŠ¨æŒ‚è½½æ­£ç¡®çš„è®¾å¤‡
mount /dev/sda1 /sysroot
exit  # ç»§ç»­å¯åŠ¨è¿‡ç¨‹

# 4. æ°¸ä¹…è§£å†³ï¼šå¯åŠ¨åæ›´æ–°GRUBé…ç½®
sudo blkid /dev/sda1  # è·å–æ­£ç¡®UUID
sudo nano /etc/default/grub  # æ›´æ–°é…ç½®
sudo update-grub
```

**ğŸ“‹ æ¡ˆä¾‹2ï¼šæ–‡ä»¶ç³»ç»ŸæŸåéœ€è¦ä¿®å¤**

```bash
# ç—‡çŠ¶ï¼šmount: /sysroot: can't read superblock on /dev/sda1
# åœ¨emergency shellä¸­ä¿®å¤ï¼š

# 1. æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿç±»å‹å’ŒçŠ¶æ€
blkid /dev/sda1
# è¾“å‡ºï¼š/dev/sda1: UUID="xxx" TYPE="ext4"

# 2. å°è¯•æ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥
e2fsck -f /dev/sda1
# å¦‚æœæç¤ºéœ€è¦ä¿®å¤ï¼Œé€‰æ‹©y

# 3. å¼ºåˆ¶ä¿®å¤ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
e2fsck -y /dev/sda1

# 4. ä¿®å¤å®Œæˆåå°è¯•æŒ‚è½½
mount /dev/sda1 /sysroot
ls /sysroot  # ç¡®è®¤å†…å®¹æ­£å¸¸
exit
```

**ğŸ“‹ æ¡ˆä¾‹3ï¼šé©±åŠ¨æ¨¡å—ç¼ºå¤±**

```bash
# ç—‡çŠ¶ï¼šæ‰¾ä¸åˆ°å­˜å‚¨è®¾å¤‡ï¼Œls /dev/sd* æ— è¾“å‡º
# åœ¨emergency shellä¸­å¤„ç†ï¼š

# 1. æ£€æŸ¥å·²åŠ è½½çš„å­˜å‚¨ç›¸å…³æ¨¡å—
lsmod | grep -E "(ahci|ata|scsi)"

# 2. æ‰‹åŠ¨åŠ è½½å¯èƒ½éœ€è¦çš„é©±åŠ¨
modprobe ahci           # SATAæ§åˆ¶å™¨
modprobe libata         # ATAä¼ è¾“å±‚
modprobe sd_mod         # SCSIç£ç›˜é©±åŠ¨

# 3. ç­‰å¾…è®¾å¤‡æ£€æµ‹
sleep 3
ls /dev/sd*

# 4. å¦‚æœè®¾å¤‡å‡ºç°ï¼Œç»§ç»­æ­£å¸¸æµç¨‹
# å¦‚æœä»æ— è®¾å¤‡ï¼Œå¯èƒ½æ˜¯ç¡¬ä»¶é—®é¢˜æˆ–éœ€è¦ç‰¹å®šé©±åŠ¨
```

### 8.6 initramfså†…å®¹æ£€æŸ¥ä¸åˆ†æ


**ğŸ” åˆ†æinitramfsç»“æ„**ï¼š

```bash
# åœ¨æ­£å¸¸ç³»ç»Ÿä¸­åˆ†æinitramfså†…å®¹
cd /tmp
mkdir initramfs-analysis
cd initramfs-analysis

# è§£å‹initramfsæ–‡ä»¶
zcat /boot/initramfs-$(uname -r).img | cpio -idmv

# åˆ†æå…³é”®ç»„ä»¶
ls -la                      # æŸ¥çœ‹ç›®å½•ç»“æ„
cat init                    # æŸ¥çœ‹åˆå§‹åŒ–è„šæœ¬
ls lib/modules/*/kernel/    # æŸ¥çœ‹åŒ…å«çš„é©±åŠ¨æ¨¡å—
cat etc/cmdline             # æŸ¥çœ‹å‘½ä»¤è¡Œå‚æ•°å¤„ç†
ls -la bin/ sbin/           # æŸ¥çœ‹å¯ç”¨å·¥å…·
```

**ğŸ“Š æ£€æŸ¥æ¨¡å—ä¾èµ–å…³ç³»**ï¼š
```bash
# æŸ¥çœ‹initramfsä¸­çš„æ¨¡å—ä¾èµ–
cat lib/modules/$(uname -r)/modules.dep

# æ£€æŸ¥ç‰¹å®šæ¨¡å—æ˜¯å¦åŒ…å«
find . -name "*.ko" | grep ahci

# éªŒè¯å…³é”®å·¥å…·æ˜¯å¦å­˜åœ¨
ls -la bin/mount sbin/modprobe bin/sh
```

### 8.7 é‡å»ºinitramfsè§£å†³é—®é¢˜


**ğŸ”„ initramfsé‡å»ºç­–ç•¥**ï¼š

```bash
# 1. å¤‡ä»½ç°æœ‰initramfs
sudo cp /boot/initramfs-$(uname -r).img /boot/initramfs-$(uname -r).img.backup

# 2. åŸºæœ¬é‡å»ºï¼ˆè‡ªåŠ¨æ£€æµ‹ï¼‰
sudo dracut --force

# 3. åŒ…å«ç‰¹å®šæ¨¡å—é‡å»º
sudo dracut --force --add "ahci ext4 sd_mod"

# 4. æ’é™¤é—®é¢˜æ¨¡å—é‡å»º  
sudo dracut --force --omit "problematic_module"

# 5. ä¸ºä¸åŒå†…æ ¸ç‰ˆæœ¬é‡å»º
sudo dracut --force /boot/initramfs-5.15.0-72.img 5.15.0-72-generic

# 6. è°ƒè¯•æ¨¡å¼é‡å»ºï¼ˆåŒ…å«æ›´å¤šè°ƒè¯•å·¥å…·ï¼‰
sudo dracut --force --add "debug bash"
```

### 8.8 é¢„é˜²æ€§æªæ–½ä¸æœ€ä½³å®è·µ


**ğŸ›¡ï¸ é¢„é˜²æ•…éšœçš„æœ€ä½³å®è·µ**ï¼š

```bash
# 1. å®šæœŸå¤‡ä»½å…³é”®å¯åŠ¨æ–‡ä»¶
sudo cp /boot/initramfs-$(uname -r).img /backup/
sudo cp /boot/grub/grub.cfg /backup/

# 2. å†…æ ¸å‡çº§åéªŒè¯å¯åŠ¨
# å‡çº§å‰è®°å½•å½“å‰é…ç½®
blkid > /tmp/current-uuids.txt
cat /proc/cmdline > /tmp/current-cmdline.txt

# 3. ä¿ç•™å¤šä¸ªå†…æ ¸ç‰ˆæœ¬
# ä¸è¦åˆ é™¤æ—§çš„å·¥ä½œæ­£å¸¸çš„å†…æ ¸

# 4. åˆ›å»ºæ•‘æ´å¯åŠ¨ç›˜
# å‡†å¤‡Live CD/USBç”¨äºç´§æ€¥æƒ…å†µ

# 5. ç›‘æ§ç³»ç»Ÿå¯åŠ¨æ—¶é—´
systemd-analyze                    # åˆ†æå¯åŠ¨æ—¶é—´
systemd-analyze blame              # æ‰¾å‡ºå¯åŠ¨æ…¢çš„æœåŠ¡
```

**âš ï¸ æ•…éšœæ¢å¤å·¥å…·åŒ…**ï¼š

```bash
# æ•‘æ´æ¨¡å¼å¸¸ç”¨å‘½ä»¤é›†åˆ
alias ll='ls -la'
alias mount-root='mount UUID=your-root-uuid /mnt'
alias fix-grub='chroot /mnt grub-install /dev/sda && chroot /mnt update-grub'

# å¿«é€Ÿæ£€æŸ¥è„šæœ¬
check_boot_health() {
    echo "=== æ£€æŸ¥å¯åŠ¨å¥åº·çŠ¶æ€ ==="
    echo "å†…æ ¸ç‰ˆæœ¬ï¼š$(uname -r)"
    echo "rootåˆ†åŒºï¼š"
    grep ' / ' /proc/mounts
    echo "initramfsæ–‡ä»¶ï¼š"
    ls -lh /boot/initramfs-$(uname -r)*
    echo "GRUBé…ç½®æ›´æ–°æ—¶é—´ï¼š"
    ls -l /boot/grub/grub.cfg
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ å†…æ ¸é•œåƒï¼šå‹ç¼©çš„æ“ä½œç³»ç»Ÿæ ¸å¿ƒï¼ŒåŒ…å«å¯åŠ¨å¿…éœ€åŠŸèƒ½
ğŸ”¸ initramfsï¼šç°ä»£çš„åˆå§‹RAMæ–‡ä»¶ç³»ç»Ÿï¼Œæ›¿ä»£ä¼ ç»Ÿinitrd
ğŸ”¸ æ¨¡å—åŠ è½½ï¼šæŒ‰ä¾èµ–é¡ºåºåŠ¨æ€åŠ è½½ç¡¬ä»¶é©±åŠ¨å’ŒåŠŸèƒ½æ¨¡å—
ğŸ”¸ æ ¹æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ï¼šä»ä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿåˆ‡æ¢åˆ°çœŸæ­£çš„ç³»ç»Ÿ
ğŸ”¸ å†…æ ¸å‚æ•°ï¼šæ§åˆ¶å¯åŠ¨è¡Œä¸ºå’Œç¡¬ä»¶é…ç½®çš„å‘½ä»¤è¡Œé€‰é¡¹
ğŸ”¸ dracutå·¥å…·ï¼šæ™ºèƒ½åŒ–çš„initramfsç”Ÿæˆå’Œç®¡ç†å·¥å…·
ğŸ”¸ pivot_rootï¼šå®ç°æ–‡ä»¶ç³»ç»Ÿæ ¹ç›®å½•åˆ‡æ¢çš„å…³é”®æœºåˆ¶
ğŸ”¸ æ•…éšœæ’æŸ¥ï¼šemergency shellå’Œè°ƒè¯•å‚æ•°çš„ä½¿ç”¨æ–¹æ³•
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ Linuxå¯åŠ¨çš„æœ¬è´¨é—®é¢˜**ï¼š
```
æ ¸å¿ƒçŸ›ç›¾ï¼š
â€¢ éœ€è¦é©±åŠ¨æ‰èƒ½è®¿é—®ç¡¬ç›˜
â€¢ é©±åŠ¨ç¨‹åºå­˜å‚¨åœ¨ç¡¬ç›˜ä¸Š
â€¢ è¿™æ˜¯ä¸€ä¸ªé€»è¾‘é—­ç¯é—®é¢˜

è§£å†³æ€è·¯ï¼š
â€¢ å‡†å¤‡ä¸´æ—¶ç¯å¢ƒï¼ˆinitramfsï¼‰
â€¢ åŒ…å«å¿…éœ€çš„é©±åŠ¨å’Œå·¥å…·
â€¢ å…ˆå¯åŠ¨ä¸´æ—¶ç³»ç»Ÿ
â€¢ å†åˆ‡æ¢åˆ°å®Œæ•´ç³»ç»Ÿ

æŠ€æœ¯æ¼”è¿›ï¼š
initrd â†’ initramfs â†’ dracut
å›ºå®šå¤§å° â†’ åŠ¨æ€åˆ†é… â†’ æ™ºèƒ½ç”Ÿæˆ
```

**ğŸ”¹ initramfs vs initrdçš„æ ¸å¿ƒå·®å¼‚**ï¼š
```
initrdï¼ˆä¼ ç»Ÿï¼‰= è™šæ‹Ÿç¡¬ç›˜
â€¢ å›ºå®šå¤§å°ï¼Œæµªè´¹å†…å­˜
â€¢ éœ€è¦æ–‡ä»¶ç³»ç»Ÿé©±åŠ¨
â€¢ æŒ‚è½½å¼€é”€å¤§

initramfsï¼ˆç°ä»£ï¼‰= å†…å­˜æ–‡ä»¶ç³»ç»Ÿ
â€¢ åŠ¨æ€å¤§å°ï¼ŒèŠ‚çœå†…å­˜
â€¢ å†…æ ¸åŸç”Ÿæ”¯æŒ
â€¢ ç›´æ¥å†…å­˜æ“ä½œ

é€‰æ‹©åŸåˆ™ï¼šç°ä»£ç³»ç»Ÿéƒ½ç”¨initramfs
```

**ğŸ”¹ æ¨¡å—åŠ è½½çš„ä¾èµ–é€»è¾‘**ï¼š
```
åŠ è½½é¡ºåºï¼šåº•å±‚ â†’ ä¸Šå±‚
â€¢ ç¡¬ä»¶æ¥å£ï¼ˆPCIã€USBæ€»çº¿ï¼‰
â€¢ ä¼ è¾“åè®®ï¼ˆATAã€SCSIï¼‰
â€¢ è®¾å¤‡é©±åŠ¨ï¼ˆahciã€e1000eï¼‰
â€¢ åŠŸèƒ½æ¨¡å—ï¼ˆæ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œåè®®ï¼‰

ç®¡ç†å·¥å…·ï¼š
â€¢ modprobeï¼šæ™ºèƒ½åŠ è½½ï¼Œå¤„ç†ä¾èµ–
â€¢ insmodï¼šç›´æ¥åŠ è½½ï¼Œä¸å¤„ç†ä¾èµ–
â€¢ lsmodï¼šæŸ¥çœ‹å·²åŠ è½½æ¨¡å—
â€¢ rmmodï¼šå¸è½½æ¨¡å—
```

### 9.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ’¼ ç³»ç»Ÿç®¡ç†å‘˜æŠ€èƒ½**ï¼š
```
æ—¥å¸¸è¿ç»´ï¼š
â€¢ ç†è§£ç³»ç»Ÿå¯åŠ¨æµç¨‹ï¼Œå¿«é€Ÿå®šä½å¯åŠ¨é—®é¢˜
â€¢ åˆç†é…ç½®å†…æ ¸å‚æ•°ï¼Œä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½
â€¢ å®šåˆ¶initramfsï¼Œæ”¯æŒç‰¹æ®Šç¡¬ä»¶ç¯å¢ƒ
â€¢ å»ºç«‹æ•…éšœæ’æŸ¥é¢„æ¡ˆï¼Œé™ä½å®•æœºæ—¶é—´

æ•…éšœå¤„ç†ï¼š
â€¢ å¿«é€Ÿè¿›å…¥rescueæ¨¡å¼ä¿®å¤ç³»ç»Ÿ
â€¢ åˆ†æinitramfsé—®é¢˜ï¼Œé‡å»ºå¯åŠ¨ç¯å¢ƒ
â€¢ å¤„ç†UUIDå˜æ›´ã€æ–‡ä»¶ç³»ç»ŸæŸåç­‰é—®é¢˜
â€¢ ä¼˜åŒ–å¯åŠ¨æ€§èƒ½ï¼Œå‡å°‘å¯åŠ¨æ—¶é—´
```

**ğŸ“ æŠ€æœ¯è¿›é˜¶è·¯å¾„**ï¼š
```
åŸºç¡€æŒæ¡ï¼š
â€¢ ç†è§£å¯åŠ¨æµç¨‹å„ä¸ªé˜¶æ®µ
â€¢ ç†Ÿç»ƒä½¿ç”¨dracutå·¥å…·
â€¢ æŒæ¡åŸºæœ¬æ•…éšœæ’æŸ¥æ–¹æ³•

è¿›é˜¶åº”ç”¨ï¼š
â€¢ è‡ªå®šä¹‰initramfsæ¨¡å—
â€¢ ç½‘ç»œå¯åŠ¨ç¯å¢ƒæ­å»º
â€¢ åŠ å¯†æ–‡ä»¶ç³»ç»Ÿé›†æˆ
â€¢ å®¹å™¨åŒ–ç¯å¢ƒé€‚é…

ä¸“å®¶çº§åˆ«ï¼š
â€¢ å†…æ ¸å¯åŠ¨ä¼˜åŒ–
â€¢ åµŒå…¥å¼ç³»ç»Ÿé€‚é…  
â€¢ å¤§è§„æ¨¡éƒ¨ç½²è‡ªåŠ¨åŒ–
â€¢ å¯åŠ¨å®‰å…¨åŠ å›º
```

### 9.4 å­¦ä¹ å»ºè®®ä¸å®è·µ


**ğŸ“š å­¦ä¹ è·¯å¾„å»ºè®®**ï¼š

```
ç¬¬ä¸€é˜¶æ®µï¼šç†è®ºç†è§£ï¼ˆ1-2å‘¨ï¼‰
âœ… æŒæ¡åŸºæœ¬æ¦‚å¿µå’Œæœ¯è¯­
âœ… ç†è§£å¯åŠ¨æµç¨‹æ—¶åº
âœ… äº†è§£å„å·¥å…·çš„ä½œç”¨

ç¬¬äºŒé˜¶æ®µï¼šåŠ¨æ‰‹å®è·µï¼ˆ2-3å‘¨ï¼‰  
âœ… åœ¨è™šæ‹Ÿæœºä¸­ç»ƒä¹ æ•…éšœæ’æŸ¥
âœ… å°è¯•ä¸åŒå†…æ ¸å‚æ•°ç»„åˆ
âœ… é‡å»ºå’Œå®šåˆ¶initramfs

ç¬¬ä¸‰é˜¶æ®µï¼šæ·±å…¥åº”ç”¨ï¼ˆæŒç»­ï¼‰
âœ… ç»“åˆå®é™…å·¥ä½œåœºæ™¯åº”ç”¨
âœ… ç ”ç©¶é«˜çº§é…ç½®å’Œä¼˜åŒ–
âœ… å‚ä¸å¼€æºé¡¹ç›®è´¡çŒ®ä»£ç 
```

**ğŸ› ï¸ å®è·µç»ƒä¹ å»ºè®®**ï¼š

```bash
# ç»ƒä¹ 1ï¼šåŸºç¡€æ“ä½œç†Ÿç»ƒåº¦
# åœ¨è™šæ‹Ÿæœºä¸­ç»ƒä¹ ä»¥ä¸‹æ“ä½œ
dracut --list-modules           # æŸ¥çœ‹å¯ç”¨æ¨¡å—
dracut --force --add "debug"    # é‡å»ºåŒ…å«è°ƒè¯•åŠŸèƒ½
lsinitrd /boot/initramfs-*.img  # åˆ†æinitramfså†…å®¹

# ç»ƒä¹ 2ï¼šæ•…éšœæ¨¡æ‹Ÿä¸æ’æŸ¥
# æ•…æ„ä¿®æ”¹UUIDæµ‹è¯•æ•…éšœæ¢å¤
# åœ¨GRUBä¸­æ·»åŠ rd.shellå‚æ•°
# ç»ƒä¹ emergency shellä¸­çš„è¯Šæ–­å‘½ä»¤

# ç»ƒä¹ 3ï¼šæ€§èƒ½ä¼˜åŒ–å®éªŒ
# æµ‹è¯•ä¸åŒå†…æ ¸å‚æ•°å¯¹å¯åŠ¨é€Ÿåº¦çš„å½±å“
# æ¯”è¾ƒç²¾ç®€ç‰ˆå’Œå®Œæ•´ç‰ˆinitramfsçš„å·®å¼‚
# åˆ†æsystemd-analyzeçš„è¾“å‡ºç»“æœ
```

**ğŸ§  æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š

```
å¯åŠ¨æµç¨‹è®°å¿†ï¼š
"å›ºé•œè§£æ‰§æŒ‚åˆ‡å¯" 
â€¢ å›ºï¼šå›ºä»¶ï¼ˆBIOS/UEFIï¼‰åˆå§‹åŒ–
â€¢ é•œï¼šå†…æ ¸é•œåƒåŠ è½½åˆ°å†…å­˜
â€¢ è§£ï¼šè§£å‹initramfsåˆ°å†…å­˜
â€¢ æ‰§ï¼šæ‰§è¡Œinitramfsä¸­çš„initè„šæœ¬
â€¢ æŒ‚ï¼šæŒ‚è½½çœŸæ­£çš„rootæ–‡ä»¶ç³»ç»Ÿ
â€¢ åˆ‡ï¼špivot_rootåˆ‡æ¢æ ¹ç›®å½•
â€¢ å¯ï¼šå¯åŠ¨çœŸæ­£çš„initè¿›ç¨‹

æ•…éšœæ’æŸ¥æ€è·¯ï¼š
"è®¾é©±æ–‡å‚æŒ‚åˆ‡" 
â€¢ è®¾ï¼šè®¾å¤‡æ˜¯å¦è¢«è¯†åˆ«
â€¢ é©±ï¼šé©±åŠ¨æ¨¡å—æ˜¯å¦åŠ è½½
â€¢ æ–‡ï¼šæ–‡ä»¶ç³»ç»Ÿæ˜¯å¦æ­£å¸¸  
â€¢ å‚ï¼šå†…æ ¸å‚æ•°æ˜¯å¦æ­£ç¡®
â€¢ æŒ‚ï¼šæŒ‚è½½è¿‡ç¨‹æ˜¯å¦æˆåŠŸ
â€¢ åˆ‡ï¼špivot_rootæ˜¯å¦å®Œæˆ

å·¥å…·é€‰æ‹©åŸåˆ™ï¼š
"ç®€å•ç”¨mkinitrdï¼Œå¤æ‚ç”¨dracutï¼Œè°ƒè¯•ç”¨emergency shell"
```

**ğŸ¯ æœ€ç»ˆç›®æ ‡**ï¼š
é€šè¿‡å­¦ä¹ æœ¬ç« å†…å®¹ï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š
- âœ… å®Œæ•´ç†è§£Linuxç³»ç»Ÿä»å†…æ ¸åŠ è½½åˆ°ç”¨æˆ·ç©ºé—´çš„å¯åŠ¨è¿‡ç¨‹
- âœ… ç†Ÿç»ƒä½¿ç”¨dracutç­‰å·¥å…·ç®¡ç†å’Œå®šåˆ¶initramfs
- âœ… å¿«é€Ÿè¯Šæ–­å’Œè§£å†³å„ç§å¯åŠ¨æ•…éšœ
- âœ… æ ¹æ®å®é™…éœ€æ±‚ä¼˜åŒ–ç³»ç»Ÿå¯åŠ¨æ€§èƒ½
- âœ… ä¸ºç‰¹æ®Šç¯å¢ƒï¼ˆå¦‚åŠ å¯†ã€ç½‘ç»œå¯åŠ¨ï¼‰é…ç½®å¯åŠ¨è¿‡ç¨‹

**æ ¸å¿ƒä»·å€¼**ï¼šæŒæ¡Linuxå¯åŠ¨æœºåˆ¶ä¸ä»…æ˜¯æŠ€æœ¯æŠ€èƒ½ï¼Œæ›´æ˜¯ç³»ç»Ÿæ€ç»´çš„ä½“ç° - ç†è§£é—®é¢˜çš„æ ¹æœ¬åŸå› ï¼Œè¿ç”¨åˆé€‚çš„å·¥å…·å’Œæ–¹æ³•ï¼Œç³»ç»Ÿæ€§åœ°è§£å†³å¤æ‚æŠ€æœ¯é—®é¢˜ã€‚