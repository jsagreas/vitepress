---
title: 3、GRUB2引导加载器配置
---
## 📚 目录

1. [GRUB2基础概念与架构](#1-GRUB2基础概念与架构)
2. [GRUB2模块系统详解](#2-GRUB2模块系统详解)
3. [核心配置文件解析](#3-核心配置文件解析)
4. [启动菜单定制与管理](#4-启动菜单定制与管理)
5. [安全与密码保护](#5-安全与密码保护)
6. [多系统引导配置](#6-多系统引导配置)
7. [主题界面定制](#7-主题界面定制)
8. [故障排除与恢复](#8-故障排除与恢复)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🚀 GRUB2基础概念与架构


### 1.1 什么是GRUB2


**GRUB2简单理解**：
```
GRUB2 = 电脑启动时的"菜单管理员"

就像饭店服务员：
- 给你一个菜单（启动选项）
- 你选择吃什么（选择操作系统）
- 服务员去厨房安排（加载内核）
- 最后上菜（启动系统）
```

**🔸 GRUB2的全名**
- **全称**：`GNU GRand Unified Bootloader version 2`
- **中文含义**：GNU通用启动加载器第2版
- **作用**：在开机时管理和引导操作系统启动

### 1.2 GRUB2与GRUB Legacy的区别


| 特征 | **GRUB Legacy (旧版)** | **GRUB2 (新版)** |
|------|----------------------|------------------|
| 📁 **配置文件** | `/boot/grub/menu.lst` | `/boot/grub2/grub.cfg` |
| 🔧 **配置方式** | `直接编辑配置文件` | `通过工具生成配置` |
| 🧩 **模块化** | `功能固化` | `高度模块化设计` |
| 🎨 **界面** | `简单文本` | `支持图形主题` |
| 💪 **功能** | `基础引导` | `强大脚本功能` |

> 💡 **为什么要升级到GRUB2**：就像从老式按键手机升级到智能手机，功能更强大，使用更灵活

### 1.3 GRUB2架构组成


**🏗️ GRUB2整体架构图**
```
┌─────────────────────────────────────┐
│           GRUB2 整体架构             │
├─────────────────────────────────────┤
│  用户界面层 (grub-shell, 菜单)       │
├─────────────────────────────────────┤
│  脚本解释层 (grub script)           │
├─────────────────────────────────────┤
│  核心功能层 (kernel, 模块管理)       │
├─────────────────────────────────────┤
│  硬件抽象层 (磁盘访问, 网络)        │
├─────────────────────────────────────┤
│  平台适配层 (BIOS, UEFI)            │
└─────────────────────────────────────┘
```

**核心组件说明**：
- **🎯 grub2-core**：核心引导程序，最先运行
- **📦 模块系统**：按需加载功能模块
- **📝 配置文件**：控制启动行为和菜单
- **🎨 主题系统**：美化启动界面

---

## 2. 🧩 GRUB2模块系统详解


### 2.1 模块系统工作原理


**模块化设计的好处**：
```
传统方式：把所有功能都打包在一起
问题：启动程序变得很大，浪费内存

GRUB2方式：需要什么功能就加载什么模块
好处：
✅ 启动速度快
✅ 内存占用少  
✅ 功能可扩展
✅ 维护更容易
```

### 2.2 常用核心模块


**📁 文件系统模块**
```bash
# 查看已加载的模块
lsmod

# 常见文件系统模块
ext2         # 支持ext2文件系统
ext4         # 支持ext4文件系统  
xfs          # 支持XFS文件系统
ntfs         # 支持Windows NTFS
fat          # 支持FAT32文件系统
iso9660      # 支持光盘ISO格式
```

**🔌 硬件支持模块**
```bash
# 硬盘接口模块
ahci         # SATA硬盘控制器
usb          # USB设备支持
usb_keyboard # USB键盘支持

# 显示相关模块  
vbe          # VESA显示模式
gfxterm      # 图形终端
font         # 字体支持
```

### 2.3 模块管理命令


**在GRUB2命令行中管理模块**：
```bash
# 列出所有可用模块
grub> help

# 加载指定模块
grub> insmod ext4
grub> insmod usb

# 查看已加载模块
grub> lsmod

# 卸载模块（谨慎使用）
grub> rmmod 模块名
```

> ⚠️ **注意**：不要随意卸载核心模块，可能导致系统无法启动

---

## 3. 📄 核心配置文件解析


### 3.1 配置文件层次结构


**GRUB2配置文件关系图**：
```
/etc/default/grub          ← 用户设置（我们主要修改这个）
        ↓
grub2-mkconfig 命令        ← 配置生成工具  
        ↓
/boot/grub2/grub.cfg      ← 最终配置文件（自动生成，不要手动修改）
```

> 💡 **记住这个规则**：我们修改`/etc/default/grub`，然后用命令生成最终配置

### 3.2 /etc/default/grub 详解


这个文件控制GRUB2的默认行为，用简单的变量设置各种选项。

**🔧 基础设置参数**
```bash
# 默认启动项（从0开始计数）
GRUB_DEFAULT=0          # 第一个菜单项
# GRUB_DEFAULT=2        # 第三个菜单项
# GRUB_DEFAULT="saved"  # 记住上次选择

# 菜单显示时间（秒）
GRUB_TIMEOUT=5          # 5秒后自动启动
# GRUB_TIMEOUT=0        # 不显示菜单，直接启动
# GRUB_TIMEOUT=-1       # 永远等待用户选择

# 隐藏菜单设置
GRUB_TIMEOUT_STYLE=menu    # 显示菜单
# GRUB_TIMEOUT_STYLE=hidden  # 隐藏菜单，按键显示
```

**🎨 显示相关设置**
```bash
# 分辨率设置
GRUB_GFXMODE=1024x768      # 图形模式分辨率
# GRUB_GFXMODE=auto        # 自动选择最佳分辨率

# 终端设置
GRUB_TERMINAL=console      # 使用文本终端
# GRUB_TERMINAL=gfxterm    # 使用图形终端

# 背景图片
GRUB_BACKGROUND="/boot/grub2/themes/my-theme/background.jpg"
```

**⚡ 内核启动参数**
```bash
# 传递给内核的参数
GRUB_CMDLINE_LINUX_DEFAULT="quiet splash"
GRUB_CMDLINE_LINUX=""

# 常用内核参数说明：
# quiet     - 减少启动信息显示
# splash    - 显示启动画面
# nomodeset - 禁用显卡模式设置（解决显示问题）
# acpi=off  - 禁用ACPI（解决某些硬件兼容问题）
```

### 3.3 实际配置示例


**新手友好的基础配置**：
```bash
# 编辑配置文件
sudo vim /etc/default/grub

# 推荐的新手配置
GRUB_DEFAULT=0                    # 默认启动第一个系统
GRUB_TIMEOUT=10                   # 给足时间选择（10秒）
GRUB_DISTRIBUTOR="$(lsb_release -s)"
GRUB_CMDLINE_LINUX_DEFAULT="quiet splash"
GRUB_CMDLINE_LINUX=""
GRUB_GFXMODE=1024x768            # 设置清晰的分辨率
GRUB_TERMINAL=console            # 使用稳定的文本模式
```

### 3.4 生成最终配置


**⚡ 应用配置的必要步骤**：
```bash
# 修改/etc/default/grub后，必须运行这个命令
sudo grub2-mkconfig -o /boot/grub2/grub.cfg

# 或者在某些系统上（如Ubuntu）
sudo update-grub

# 验证配置是否正确
sudo grub2-mkconfig --help
```

> 🔥 **重要**：每次修改`/etc/default/grub`后都必须运行生成命令，否则修改不会生效

---

## 4. 📋 启动菜单定制与管理


### 4.1 理解启动菜单结构


**启动菜单的组成**：
```
GRUB2启动菜单
├── CentOS Linux (4.18.0-305.el8.x86_64)     ← 主菜单项
├── CentOS Linux (4.18.0-240.el8.x86_64)     ← 旧内核版本
├── Windows Boot Manager                       ← Windows系统
└── System setup                              ← 高级选项

每个菜单项包含：
- 显示名称（用户看到的）
- 启动命令（实际执行的）  
- 内核参数（传递给系统的）
```

### 4.2 自定义菜单项名称


**修改菜单显示名称**：
```bash
# 编辑 /etc/default/grub
GRUB_DISTRIBUTOR="我的Linux系统"

# 或者完全自定义
# 在 /etc/grub.d/40_custom 中添加：
menuentry "我的个人Linux" {
    set root='hd0,msdos1'
    linux /vmlinuz-4.18.0-305.el8.x86_64 root=/dev/sda1
    initrd /initramfs-4.18.0-305.el8.x86_64.img
}
```

### 4.3 管理启动顺序


**设置默认启动项**：

```bash
# 方法1：按位置设置（推荐新手）
GRUB_DEFAULT=0    # 第一个菜单项
GRUB_DEFAULT=1    # 第二个菜单项

# 方法2：按名称设置（精确但复杂）
GRUB_DEFAULT="CentOS Linux (4.18.0-305.el8.x86_64) 8"

# 方法3：记住上次选择（最智能）
GRUB_DEFAULT=saved
GRUB_SAVEDEFAULT=true
```

**⚡ 实际操作示例**：
```bash
# 1. 先查看当前菜单项
sudo grep menuentry /boot/grub2/grub.cfg

# 2. 修改默认启动项
sudo vim /etc/default/grub
# 修改：GRUB_DEFAULT=1

# 3. 应用配置
sudo grub2-mkconfig -o /boot/grub2/grub.cfg

# 4. 重启验证
sudo reboot
```

### 4.4 隐藏不需要的菜单项


**隐藏旧内核版本**：
```bash
# 只保留最新的2个内核版本
# 在 /etc/default/grub 中添加：
GRUB_DEFAULT=0
GRUB_TIMEOUT=5

# 或者编辑 /etc/grub.d/10_linux 文件
# （高级用户选项，新手慎用）
```

---

## 5. 🔐 安全与密码保护


### 5.1 为什么需要GRUB2密码保护


**安全威胁场景**：
```
没有密码保护的风险：
1. 有人可以修改启动参数
2. 可以进入单用户模式重置root密码  
3. 可以从其他设备启动绕过系统
4. 可以修改GRUB配置破坏系统

设置密码后：
✅ 修改启动参数需要密码
✅ 进入GRUB命令行需要密码
✅ 编辑菜单项需要密码
```

### 5.2 设置GRUB2密码保护


**🔧 生成密码哈希**：
```bash
# 1. 生成密码哈希
grub2-mkpasswd-pbkdf2

# 系统会提示输入密码，然后生成类似这样的哈希：
# grub.pbkdf2.sha512.10000.长长的哈希字符串
```

**📝 配置密码保护**：
```bash
# 编辑 /etc/grub.d/40_custom
sudo vim /etc/grub.d/40_custom

# 添加以下内容：
set superusers="admin"
password_pbkdf2 admin grub.pbkdf2.sha512.10000.你的哈希密码

# 保护特定菜单项（可选）
menuentry "Linux (受保护)" --users admin {
    # 启动命令
}

# 允许普通用户访问的菜单项
menuentry "Linux (普通访问)" --unrestricted {
    # 启动命令  
}
```

**⚡ 实际配置示例**：
```bash
# 1. 生成密码
grub2-mkpasswd-pbkdf2
# 输入密码：mypassword123
# 得到哈希：grub.pbkdf2.sha512.10000.ABC123...

# 2. 编辑配置
sudo vim /etc/grub.d/40_custom

# 添加：
set superusers="root"
password_pbkdf2 root grub.pbkdf2.sha512.10000.ABC123...

# 3. 重新生成配置
sudo grub2-mkconfig -o /boot/grub2/grub.cfg

# 4. 重启测试
sudo reboot
```

### 5.3 密码保护级别


| 保护级别 | **配置方式** | **效果** |
|----------|-------------|----------|
| 🔓 **无保护** | `默认配置` | `任何人都可以修改` |
| 🔒 **编辑保护** | `设置superusers` | `修改菜单需要密码` |
| 🔐 **启动保护** | `--users参数` | `启动特定系统需要密码` |
| 🛡️ **完全保护** | `所有菜单设置--users` | `任何操作都需要密码` |

---

## 6. 💻 多系统引导配置


### 6.1 多系统引导原理


**多系统共存的概念**：
```
一台电脑安装多个操作系统：

硬盘分区示例：
/dev/sda1  ← Windows 10 (C盘)
/dev/sda2  ← Linux /boot 分区
/dev/sda3  ← Linux / 分区  
/dev/sda4  ← 共享数据分区

GRUB2作为"总管"：
- 识别所有操作系统
- 提供统一的启动菜单
- 让用户选择启动哪个系统
```

### 6.2 自动检测其他系统


**GRUB2自动发现功能**：
```bash
# GRUB2会自动扫描并添加其他系统
# 这个脚本负责检测Windows系统
/etc/grub.d/30_os-prober

# 确保检测功能开启
sudo vim /etc/default/grub
# 添加或确认：
GRUB_DISABLE_OS_PROBER=false

# 手动触发检测
sudo os-prober
# 输出示例：
# /dev/sda1:Windows Boot Manager:Windows:chain

# 重新生成配置
sudo grub2-mkconfig -o /boot/grub2/grub.cfg
```

### 6.3 手动添加Windows启动项


**当自动检测失败时的手动配置**：
```bash
# 编辑 /etc/grub.d/40_custom
sudo vim /etc/grub.d/40_custom

# 添加Windows启动项：
menuentry "Windows 10" {
    insmod part_msdos
    insmod ntfs
    set root='hd0,msdos1'
    chainloader +1
}

# 参数说明：
# hd0,msdos1  表示第一块硬盘的第一个分区
# chainloader 把控制权交给Windows启动管理器
```

### 6.4 多Linux系统配置


**同一台机器安装多个Linux发行版**：
```bash
# 假设分区情况：
# /dev/sda1 - CentOS
# /dev/sda2 - Ubuntu  
# /dev/sda3 - 共享/home

# 在主系统的 /etc/grub.d/40_custom 中添加：
menuentry "Ubuntu 20.04" {
    set root='hd0,msdos2'
    linux /vmlinuz root=/dev/sda2 ro quiet splash
    initrd /initrd.img
}

menuentry "CentOS 8 救援模式" {
    set root='hd0,msdos1'  
    linux /vmlinuz root=/dev/sda1 ro single
    initrd /initramfs.img
}
```

---

## 7. 🎨 主题界面定制


### 7.1 GRUB2主题系统概述


**主题的作用**：
```
默认GRUB2界面：简单的文本菜单，黑底白字
自定义主题后：
✅ 漂亮的背景图片
✅ 自定义字体和颜色
✅ 图标和动画效果
✅ 更好的用户体验
```

### 7.2 主题文件结构


**GRUB2主题目录结构**：
```
/boot/grub2/themes/
└── my-theme/
    ├── theme.txt          ← 主题配置文件
    ├── background.jpg     ← 背景图片
    ├── font.pf2          ← 字体文件
    ├── icons/            ← 图标目录
    │   ├── linux.png
    │   ├── windows.png
    │   └── shutdown.png
    └── select_*.png      ← 选择框图片
```

### 7.3 创建简单主题


**🎨 制作自己的主题**：
```bash
# 1. 创建主题目录
sudo mkdir -p /boot/grub2/themes/my-theme

# 2. 准备背景图片（推荐1024x768）
sudo cp ~/my-background.jpg /boot/grub2/themes/my-theme/background.jpg

# 3. 创建主题配置文件
sudo vim /boot/grub2/themes/my-theme/theme.txt
```

**📄 基础主题配置文件**：
```bash
# my-theme/theme.txt 内容：

# 基本设置
title-text: "选择操作系统"
title-font: "DejaVu Sans Bold 16"
title-color: "#FFFFFF"

# 背景设置  
desktop-image: "background.jpg"
desktop-color: "#000000"

# 菜单样式
menu-color-normal: "#FFFFFF"
menu-color-highlight: "#FFFF00"
menu-pixmap-style: "menu_*.png"

# 进度条（可选）
progress-bar-color: "#FFFFFF"
progress-bar-bg-color: "#666666"
```

### 7.4 应用自定义主题


**🔧 启用主题的步骤**：
```bash
# 1. 在 /etc/default/grub 中设置
sudo vim /etc/default/grub

# 添加主题配置：
GRUB_THEME="/boot/grub2/themes/my-theme/theme.txt"
GRUB_GFXMODE=1024x768
GRUB_TERMINAL=gfxterm

# 2. 重新生成配置
sudo grub2-mkconfig -o /boot/grub2/grub.cfg

# 3. 重启查看效果
sudo reboot
```

### 7.5 使用现成主题


**📦 安装网上的主题包**：
```bash
# 下载主题包（示例）
wget https://github.com/vinceliuice/grub2-themes/archive/master.zip

# 解压并安装
unzip master.zip
cd grub2-themes-master
sudo ./install.sh

# 或者手动复制主题文件到指定位置
sudo cp -r themes/stylish /boot/grub2/themes/
```

---

## 8. 🔧 故障排除与恢复


### 8.1 常见GRUB2故障


**🚨 典型故障现象及原因**：

| 故障现象 | **可能原因** | **影响程度** |
|----------|-------------|-------------|
| 🔴 **grub>提示符** | `配置文件损坏或丢失` | `无法正常启动` |
| 🟡 **菜单项消失** | `内核更新后配置未刷新` | `找不到系统选项` |
| 🔵 **启动很慢** | `硬盘检测问题` | `等待时间长` |
| ⚫ **黑屏无反应** | `显示驱动不兼容` | `看不到启动菜单` |

### 8.2 GRUB2命令行救援


**当出现grub>提示符时的恢复方法**：
```bash
# 在grub>提示符下：

# 1. 查看可用设备
grub> ls
# 输出类似：(hd0) (hd0,msdos1) (hd0,msdos2)

# 2. 查找Linux系统分区
grub> ls (hd0,msdos1)/
# 找包含boot目录的分区

# 3. 设置根分区
grub> set root=(hd0,msdos1)

# 4. 手动加载内核
grub> linux /boot/vmlinuz-4.18.0-305.el8.x86_64 root=/dev/sda1
grub> initrd /boot/initramfs-4.18.0-305.el8.x86_64.img

# 5. 启动系统
grub> boot
```

### 8.3 使用救援盘修复


**📀 用Live CD/USB修复GRUB2**：
```bash
# 1. 用救援系统启动
# 2. 挂载原系统分区
sudo mount /dev/sda1 /mnt
sudo mount /dev/sda2 /mnt/boot  # 如果boot是独立分区

# 3. 进入chroot环境
sudo mount -t proc proc /mnt/proc
sudo mount -t sysfs sys /mnt/sys
sudo mount -o bind /dev /mnt/dev
sudo chroot /mnt

# 4. 重新安装GRUB2
grub2-install /dev/sda

# 5. 重新生成配置
grub2-mkconfig -o /boot/grub2/grub.cfg

# 6. 退出并重启
exit
sudo reboot
```

### 8.4 配置文件备份与恢复


**💾 预防性备份策略**：
```bash
# 备份重要配置文件
sudo cp /etc/default/grub /etc/default/grub.backup
sudo cp /boot/grub2/grub.cfg /boot/grub2/grub.cfg.backup

# 备份整个grub目录
sudo tar -czf ~/grub2-backup.tar.gz /boot/grub2/

# 恢复备份
sudo cp /etc/default/grub.backup /etc/default/grub
sudo grub2-mkconfig -o /boot/grub2/grub.cfg
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的基本概念


```
🔸 GRUB2本质：电脑启动时的菜单管理员，负责加载操作系统
🔸 配置流程：修改/etc/default/grub → 运行grub2-mkconfig → 生成最终配置
🔸 模块系统：按需加载功能，提高启动效率
🔸 安全机制：可设置密码保护，防止未授权修改
🔸 多系统支持：自动检测和手动配置多个操作系统
🔸 主题定制：可美化启动界面，提升用户体验
```

### 9.2 关键理解要点


**🔹 配置文件的优先级**
```
理解重点：
- /etc/default/grub：用户配置（我们修改这个）
- /boot/grub2/grub.cfg：最终配置（系统生成，不要手动改）
- /etc/grub.d/*：配置生成脚本（高级用户才需要了解）

记忆要点：修改用户配置 → 运行生成命令 → 重启生效
```

**🔹 模块加载机制**
```
核心概念：
- 需要什么功能就加载什么模块
- 常用模块会自动加载
- 特殊需求可以手动加载模块
- 模块管理在GRUB命令行中进行
```

**🔹 故障恢复思路**
```
解决步骤：
1. 确定故障现象（黑屏、命令行、菜单问题）
2. 进入GRUB命令行手动启动
3. 进入系统后重新生成配置
4. 严重故障使用救援盘修复
```

### 9.3 实际应用场景


**🎯 新手必知操作**
- **修改启动等待时间**：避免开机等待太久或太短
- **设置默认启动项**：让常用系统自动启动
- **添加内核参数**：解决硬件兼容问题
- **备份配置文件**：预防配置损坏

**🔧 进阶实用技巧**
- **多系统引导配置**：Windows + Linux双系统
- **密码保护设置**：提高系统安全性
- **自定义启动菜单**：个性化系统标识
- **故障快速恢复**：掌握救援模式

### 9.4 常用命令速查


**📝 配置管理命令**
```bash
# 编辑主配置文件
sudo vim /etc/default/grub

# 生成最终配置
sudo grub2-mkconfig -o /boot/grub2/grub.cfg

# 重新安装GRUB2
sudo grub2-install /dev/sda

# 检查配置语法
sudo grub2-mkconfig --help
```

**🔧 故障诊断命令**
```bash
# 在GRUB命令行中：
ls                    # 查看可用分区
set                   # 显示当前变量  
help                  # 显示可用命令
lsmod                 # 查看加载的模块
```

### 9.5 学习建议


**🎯 学习顺序建议**
1. **先理解概念**：GRUB2的作用和工作原理
2. **掌握基础配置**：修改启动时间、默认项
3. **学会故障处理**：至少掌握命令行救援
4. **尝试进阶功能**：多系统、主题、密码保护
5. **建立备份习惯**：预防配置损坏

**⚠️ 新手注意事项**
- 修改配置前一定要备份
- 每次修改后都要运行生成命令
- 不要直接编辑grub.cfg文件
- 故障时不要慌，多数都可以修复
- 重要系统建议先在虚拟机中练习

**🔥 核心记忆口诀**
> GRUB2管启动，配置有门道
> 
> default设默认，mkconfig要记牢
> 
> 模块按需加，故障不用慌
> 
> 备份是关键，恢复有妙招

**💡 实用价值总结**
- **系统管理员必备**：Linux服务器启动管理
- **多系统用户必学**：Windows+Linux双系统
- **故障排除利器**：系统启动问题诊断
- **个性化定制**：打造专属启动界面