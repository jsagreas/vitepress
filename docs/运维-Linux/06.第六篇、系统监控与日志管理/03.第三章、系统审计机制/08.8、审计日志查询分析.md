---
title: 8、审计日志查询分析
---
## 📚 目录

1. [审计日志查询基础](#1-审计日志查询基础)
2. [ausearch命令详解](#2-ausearch命令详解)
3. [时间范围查询技巧](#3-时间范围查询技巧)
4. [用户与权限过滤](#4-用户与权限过滤)
5. [事件类型分析](#5-事件类型分析)
6. [文件系统审计查询](#6-文件系统审计查询)
7. [系统调用跟踪分析](#7-系统调用跟踪分析)
8. [复杂查询组合技巧](#8-复杂查询组合技巧)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🔍 审计日志查询基础


### 1.1 什么是审计日志查询


**简单理解**：审计日志查询就像是在系统的"监控录像"中找特定事件

```
现实场景类比：
商场保安查看监控录像 → 系统管理员查看审计日志
- 按时间查看：几点发生的事？ → 指定时间范围查询
- 按人员查看：谁做的？     → 按用户过滤
- 按区域查看：在哪发生？   → 按文件路径过滤
- 按事件查看：发生了什么？ → 按事件类型过滤
```

### 1.2 审计日志存储位置


**📁 核心日志文件**：
```bash
# 主要审计日志文件
/var/log/audit/audit.log      # 当前活跃日志
/var/log/audit/audit.log.1    # 轮转的历史日志
/var/log/audit/audit.log.2    # 更早的历史日志

# 查看日志文件大小
ls -lh /var/log/audit/
```

### 1.3 日志记录格式理解


**🔸 典型审计记录结构**：
```
type=SYSCALL msg=audit(1640995200.123:12345): arch=c000003e syscall=2 
success=yes exit=3 a0=7fff12345678 a1=241 a2=1a4 a3=0 items=1 ppid=1234 
pid=5678 auid=1000 uid=1000 gid=1000 euid=1000 suid=1000 fsuid=1000 
egid=1000 sgid=1000 fsgid=1000 tty=pts0 ses=1 comm="cat" 
exe="/bin/cat" key="file_access"
```

**📝 记录字段含义**：
- `type`：事件类型（如SYSCALL、LOGIN、USER_CMD等）
- `msg`：消息头，包含时间戳和序列号
- `pid`：进程ID
- `uid`：用户ID
- `comm`：命令名称
- `exe`：可执行文件路径

---

## 2. ⚙️ ausearch命令详解


### 2.1 ausearch基本语法


**🔸 命令基本格式**：
```bash
ausearch [选项] [过滤条件]
```

**💡 常用选项说明**：
```bash
-ts, --start      # 开始时间
-te, --end        # 结束时间
-u, --uid         # 用户ID
-p, --pid         # 进程ID
-k, --key         # 关键字
-f, --file        # 文件名
-sc, --syscall    # 系统调用
-m, --message     # 消息类型
-i, --interpret   # 解释输出（显示可读格式）
```

### 2.2 基础查询示例


**📋 简单查询操作**：
```bash
# 查看最近的10条审计记录
ausearch -ts recent | head -20

# 查看今天的所有审计记录
ausearch -ts today

# 以易读格式显示记录
ausearch -ts today -i
```

**🔍 输出格式对比**：
```bash
# 原始格式（难读）
ausearch -ts today
# type=SYSCALL msg=audit(1640995200.123:12345): arch=c000003e...

# 解释格式（易读）
ausearch -ts today -i
# type=SYSCALL msg=audit(01/01/2024 10:30:00.123:12345): arch=x86_64...
```

### 2.3 ausearch vs aureport


**📊 工具对比**：

| 工具 | **主要用途** | **输出特点** | **适用场景** |
|------|------------|------------|-------------|
| **ausearch** | `详细查询具体事件` | `完整的原始记录` | `调查特定事件` |
| **aureport** | `生成统计报告` | `汇总统计信息` | `整体趋势分析` |

```bash
# ausearch：查看具体的登录事件
ausearch -m USER_LOGIN -ts today

# aureport：生成登录统计报告
aureport --login --summary
```

---

## 3. ⏰ 时间范围查询技巧


### 3.1 时间格式指定


**🕐 支持的时间格式**：
```bash
# 相对时间
-ts now          # 当前时间
-ts recent       # 最近10分钟
-ts today        # 今天
-ts yesterday    # 昨天
-ts this-week    # 本周
-ts this-month   # 本月

# 绝对时间
-ts "01/01/2024 10:30:00"    # 完整时间
-ts "01/01/2024"             # 日期（从00:00:00开始）
-ts "10:30:00"               # 时间（今天的）
```

### 3.2 时间范围查询实例


**📅 实用查询示例**：
```bash
# 查询今天上午9点到12点的记录
ausearch -ts "09:00:00" -te "12:00:00" -i

# 查询昨天全天的登录事件
ausearch -ts yesterday -te today -m USER_LOGIN

# 查询最近1小时的文件访问
ausearch -ts "-1hour" -k file_access

# 查询指定日期范围
ausearch -ts "2024-01-01 00:00:00" -te "2024-01-01 23:59:59"
```

### 3.3 时间查询优化技巧


**⚡ 性能优化建议**：
```bash
# ✅ 好的做法：指定明确的时间范围
ausearch -ts "2024-01-01" -te "2024-01-02" -u 1000

# ❌ 避免：不指定时间范围搜索全部日志
ausearch -u 1000    # 可能非常慢

# 💡 技巧：先用时间范围缩小搜索，再加其他条件
ausearch -ts today | grep "sudo"
```

---

## 4. 👤 用户与权限过滤


### 4.1 用户相关查询


**🔸 用户ID查询**：
```bash
# 根据真实用户ID查询
ausearch -ui 1000              # 查询用户ID为1000的所有活动

# 根据有效用户ID查询
ausearch -ue 0                 # 查询以root权限执行的操作

# 根据用户名查询（需要先转换为UID）
id -u username                 # 获取用户ID
ausearch -ui $(id -u username) # 查询指定用户
```

**👥 多用户查询**：
```bash
# 查询多个用户的活动
ausearch -ui 1000 -ui 1001     # 用户1000或1001
ausearch -ts today | grep -E "uid=(1000|1001)"  # 另一种方式
```

### 4.2 权限提升事件查询


**🔐 sudo操作查询**：
```bash
# 查询所有sudo操作
ausearch -k sudo_log -i

# 查询特定用户的sudo操作
ausearch -k sudo_log -ui 1000 -i

# 查询失败的sudo尝试
ausearch -m USER_CMD -sv no -i
```

**⚠️ 权限异常检测**：
```bash
# 查询权限提升到root的事件
ausearch -ue 0 -ui 1000 -ts today -i

# 查询可疑的权限变更
ausearch -k perm_mod -ts today -i
```

### 4.3 登录会话跟踪


**🖥️ 登录事件分析**：
```bash
# 查询所有登录事件
ausearch -m USER_LOGIN -ts today -i

# 查询特定用户的登录
ausearch -m USER_LOGIN -ui 1000 -i

# 查询失败的登录尝试
ausearch -m USER_LOGIN -sv no -i

# 查询远程登录（SSH）
ausearch -k ssh_login -ts today -i
```

---

## 5. 📋 事件类型分析


### 5.1 常见事件类型


**🔸 系统事件类型详解**：

| 事件类型 | **含义** | **主要用途** | **查询示例** |
|---------|---------|-------------|-------------|
| `SYSCALL` | `系统调用` | `文件操作、进程创建` | `ausearch -m SYSCALL -k file_access` |
| `USER_LOGIN` | `用户登录` | `登录审计` | `ausearch -m USER_LOGIN -ts today` |
| `USER_CMD` | `用户命令` | `命令执行审计` | `ausearch -m USER_CMD -k sudo_log` |
| `PATH` | `路径信息` | `文件路径记录` | `ausearch -m PATH -f /etc/passwd` |
| `CWD` | `当前目录` | `工作目录变更` | `ausearch -m CWD -ts today` |

### 5.2 系统调用事件查询


**⚙️ 文件系统操作**：
```bash
# 查询文件打开操作（open系统调用）
ausearch -sc open -ts today -i

# 查询文件删除操作（unlink系统调用）
ausearch -sc unlink -ts today -i

# 查询目录创建（mkdir系统调用）
ausearch -sc mkdir -ts today -i

# 查询权限修改（chmod系统调用）
ausearch -sc chmod -ts today -i
```

### 5.3 用户行为事件


**👤 用户活动跟踪**：
```bash
# 查询命令执行记录
ausearch -m USER_CMD -ts today -i

# 查询账户变更操作
ausearch -m ADD_USER -o ausearch -m DEL_USER -ts this-week -i

# 查询密码修改事件
ausearch -k password_change -ts today -i
```

**🔍 示例输出解析**：
```
type=USER_CMD msg=audit(01/15/2024 10:30:15.123:12345): pid=1234 uid=1000 
auid=1000 ses=1 msg='cwd="/home/user" cmd=sudo systemctl restart nginx 
terminal=pts/0 res=success'
```
- 用户1000执行了sudo命令
- 命令内容是重启nginx服务
- 在终端pts/0执行
- 执行成功

---

## 6. 📁 文件系统审计查询


### 6.1 文件路径过滤


**🔸 精确文件查询**：
```bash
# 查询特定文件的所有访问
ausearch -f /etc/passwd -ts today -i

# 查询目录下所有文件访问
ausearch -f /etc/ -ts today -i

# 查询包含关键字的文件路径
ausearch -ts today | grep "/var/log"
```

### 6.2 文件操作类型查询


**📄 常见文件操作**：
```bash
# 查询文件读取操作
ausearch -sc openat,read -ts today -i

# 查询文件写入操作
ausearch -sc openat,write -ts today -i

# 查询文件删除操作
ausearch -sc unlink,unlinkat -ts today -i

# 查询文件创建操作
ausearch -sc creat,openat -ts today -i
```

### 6.3 敏感文件监控


**🔐 重要文件访问追踪**：
```bash
# 监控系统配置文件
ausearch -k system_config -ts today -i

# 监控用户配置文件
ausearch -f /home/ -k user_config -ts today -i

# 监控日志文件访问
ausearch -f /var/log/ -ts today -i
```

**💡 配置敏感文件监控规则**：
```bash
# 在 /etc/audit/rules.d/audit.rules 中添加
-w /etc/passwd -p wa -k user_accounts
-w /etc/shadow -p wa -k user_accounts
-w /etc/sudoers -p wa -k sudo_config

# 重新加载规则
auditctl -R /etc/audit/rules.d/audit.rules
```

---

## 7. 🔧 系统调用跟踪分析


### 7.1 系统调用基础


**🔸 什么是系统调用**：
```
系统调用就像是用户程序向操作系统"请求服务"的方式

生活类比：
用户程序 = 客户
操作系统 = 银行
系统调用 = 业务申请单

常见系统调用：
- open(): 打开文件（申请访问文件）
- read(): 读取数据（申请读取权限）
- write(): 写入数据（申请写入权限）
- fork(): 创建进程（申请创建新进程）
```

### 7.2 系统调用查询语法


**⚙️ 系统调用过滤**：
```bash
# 查询特定系统调用
ausearch -sc open -ts today -i           # 文件打开
ausearch -sc write -ts today -i          # 写操作
ausearch -sc execve -ts today -i         # 程序执行

# 查询多个系统调用
ausearch -sc "open,openat" -ts today -i

# 组合查询：特定用户的特定系统调用
ausearch -sc open -ui 1000 -ts today -i
```

### 7.3 进程跟踪分析


**🔍 进程相关查询**：
```bash
# 查询特定进程的所有活动
ausearch -p 1234 -ts today -i

# 查询进程创建事件
ausearch -sc fork,vfork,clone -ts today -i

# 查询程序执行事件
ausearch -sc execve -ts today -i

# 跟踪特定程序的执行
ausearch -k program_exec -ts today | grep "nginx"
```

**📊 进程分析示例**：
```bash
# 查看nginx进程的所有审计记录
ps aux | grep nginx  # 获取nginx的PID
ausearch -p $(pgrep nginx) -ts today -i
```

---

## 8. 🔗 复杂查询组合技巧


### 8.1 多条件组合查询


**🎯 AND条件组合**：
```bash
# 特定用户在特定时间的特定操作
ausearch -ui 1000 -ts "09:00:00" -te "17:00:00" -k file_access -i

# 特定文件的特定类型操作
ausearch -f /etc/passwd -sc open -ts today -i

# 特定用户执行的sudo操作
ausearch -ui 1000 -k sudo_log -ts today -i
```

### 8.2 管道组合查询


**🔄 使用管道增强查询**：
```bash
# 查询并统计特定用户的操作次数
ausearch -ui 1000 -ts today | grep -c "type=SYSCALL"

# 查询失败的操作
ausearch -ts today -i | grep "res=failed"

# 查询特定命令的执行
ausearch -m USER_CMD -ts today | grep "cmd=.*systemctl"

# 按时间排序显示
ausearch -k file_access -ts today | sort
```

### 8.3 审计ID跟踪查询


**🔍 会话跟踪技巧**：
```bash
# 获取用户的审计ID
ausearch -m USER_LOGIN -ui 1000 -ts today | grep "auid="

# 跟踪特定审计会话的所有活动
ausearch -a 1000 -ts today -i    # auid=1000的所有活动

# 跟踪会话ID的活动
ausearch -se 1 -ts today -i      # session=1的所有活动
```

### 8.4 高级查询技巧


**⚡ 实用查询模式**：
```bash
# 查询异常的权限提升
ausearch -ui 1000 -ue 0 -ts today -i | grep -v "sudo"

# 查询深夜活动（可能异常）
ausearch -ts "22:00:00" -te "06:00:00" -i

# 查询非工作时间的管理员操作
ausearch -ue 0 -ts "18:00:00" -te "08:00:00" -i

# 查询短时间内大量失败操作
ausearch -sv no -ts "-1hour" | wc -l
```

**📋 查询结果后处理**：
```bash
# 导出查询结果
ausearch -ui 1000 -ts today > user_activity.log

# 格式化输出
ausearch -ui 1000 -ts today -i | awk '{print $1, $2, $3}'

# 统计分析
ausearch -k file_access -ts today | grep -o "exe=\"[^\"]*\"" | sort | uniq -c
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的核心概念


```
🔸 ausearch本质：在审计日志中精确查找特定事件的工具
🔸 时间过滤：合理使用时间范围可以大幅提升查询效率
🔸 用户跟踪：通过UID、AUID跟踪用户的完整活动轨迹
🔸 事件类型：理解不同事件类型的含义和用途
🔸 组合查询：多个条件组合可以实现精确的事件定位
```

### 9.2 实用查询模式


**🎯 日常运维场景**：
```bash
# 安全事件调查
ausearch -ui 可疑用户ID -ts 事件时间范围 -i

# 文件访问追踪
ausearch -f 敏感文件路径 -ts 时间范围 -i

# 权限异常检测
ausearch -ue 0 -ui 非管理员ID -ts today -i

# 登录异常分析
ausearch -m USER_LOGIN -sv no -ts today -i
```

### 9.3 查询优化技巧


**⚡ 性能最佳实践**：
- ✅ **先时间后条件**：总是先指定时间范围
- ✅ **精确匹配**：使用具体的用户ID、文件路径
- ✅ **分步查询**：复杂查询分解为多个简单步骤
- ✅ **结果缓存**：将常用查询结果保存到文件

### 9.4 常见错误避免


**❌ 避免的误区**：
```bash
# 错误：不指定时间范围
ausearch -ui 1000                    # 可能很慢

# 正确：指定合理时间范围
ausearch -ui 1000 -ts today          # 快速查询

# 错误：过于宽泛的条件
ausearch -f /                        # 匹配太多

# 正确：具体的查询条件
ausearch -f /etc/passwd -ts today    # 精确匹配
```

### 9.5 实际应用价值


**🔍 安全审计场景**：
- **入侵检测**：追踪异常用户行为和权限提升
- **合规审计**：满足安全合规要求的审计记录
- **故障排查**：定位系统问题的根本原因
- **性能分析**：了解系统资源使用模式

**核心记忆口诀**：
- 审计查询先定时，用户文件事件齐
- 系统调用要明确，组合条件显神威
- 安全追踪靠日志，ausearch帮你查到底