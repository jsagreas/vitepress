---
title: 3、audit规则管理与语法
---
## 📚 目录

1. [audit规则管理基础](#1-audit规则管理基础)
2. [auditctl命令详解](#2-auditctl命令详解)
3. [规则文件配置管理](#3-规则文件配置管理)
4. [审计规则语法结构](#4-审计规则语法结构)
5. [文件监控规则(-w)](#5-文件监控规则-w)
6. [系统调用监控规则(-a)](#6-系统调用监控规则-a)
7. [字段过滤与条件设置](#7-字段过滤与条件设置)
8. [规则优先级与执行顺序](#8-规则优先级与执行顺序)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🎯 audit规则管理基础


### 1.1 什么是audit规则


**简单理解**：audit规则就像是给系统装上的"监控摄像头"，告诉系统要监控哪些文件、哪些操作。

```
现实类比：
银行保险库 = Linux系统
监控摄像头 = audit规则
保安监控室 = auditd守护进程
录像记录 = 审计日志

规则作用：定义"拍什么"、"什么时候拍"
```

**核心概念**：
- **监控对象**：文件、目录、系统调用
- **触发条件**：访问、修改、删除等操作
- **记录内容**：谁做了什么、什么时候做的

### 1.2 规则管理的两种方式


```
┌─────────────────────────────────────┐
│            规则管理方式              │
├─────────────────┬───────────────────┤
│   临时规则      │     永久规则      │
│  (auditctl)     │   (配置文件)      │
├─────────────────┼───────────────────┤
│ 🔸 立即生效      │ 🔸 重启后生效     │
│ 🔸 重启丢失      │ 🔸 持久保存       │
│ 🔸 测试调试用    │ 🔸 生产环境用     │
└─────────────────┴───────────────────┘
```

**使用场景对比**：
- **临时规则**：快速测试、临时监控、紧急排查
- **永久规则**：生产环境、长期监控、系统安全策略

---

## 2. 🛠️ auditctl命令详解


### 2.1 auditctl基本用法


**核心作用**：auditctl是管理audit规则的命令行工具，相当于监控系统的"遥控器"。

```bash
# 基本语法格式
auditctl [选项] [规则参数]
```

### 2.2 常用操作命令


**🔍 查看规则状态**
```bash
# 查看当前所有规则
auditctl -l

# 查看规则数量统计
auditctl -s

# 示例输出解释
enabled 1              # 审计已启用
failure 1              # 失败时继续运行
pid 1234               # auditd进程ID
rate_limit 0           # 无速率限制
backlog_limit 8192     # 积压队列大小
```

**➕ 添加规则**
```bash
# 添加文件监控规则
auditctl -w /etc/passwd -p wa -k passwd_changes

# 添加系统调用监控规则  
auditctl -a always,exit -F arch=b64 -S openat -k file_access
```

**➖ 删除规则**
```bash
# 删除特定文件监控
auditctl -W /etc/passwd

# 删除所有规则
auditctl -D

# 删除特定系统调用规则
auditctl -d always,exit -F arch=b64 -S openat
```

### 2.3 规则测试与验证


**测试规则效果**：
```bash
# 1. 添加测试规则
auditctl -w /tmp/test.txt -p wa -k test_rule

# 2. 触发监控事件
echo "test" > /tmp/test.txt

# 3. 查看审计日志
ausearch -k test_rule

# 4. 删除测试规则
auditctl -W /tmp/test.txt
```

---

## 3. 📁 规则文件配置管理


### 3.1 /etc/audit/rules.d/目录结构


**目录作用**：存放永久审计规则的配置文件，系统启动时自动加载。

```
audit规则目录结构：
/etc/audit/rules.d/
├── 📄 10-base-config.rules      # 基础配置
├── 📄 30-stig.rules             # 安全基线规则  
├── 📄 50-local.rules            # 本地自定义规则
├── 📄 99-finalize.rules         # 最终化配置
└── 📄 audit.rules → ../audit.rules  # 兼容性链接
```

### 3.2 规则文件命名规范


**💡 重要概念**：文件名前的数字决定加载顺序，数字越小越先加载。

```
文件命名规范：
┌─────┬────────────────┬─────────────────┐
│数字 │     用途       │      示例       │
├─────┼────────────────┼─────────────────┤
│10-XX│   基础配置     │ 10-base.rules   │
│20-XX│   删除规则     │ 20-delete.rules │
│30-XX│   监控规则     │ 30-monitor.rules│
│40-XX│   访问规则     │ 40-access.rules │
│99-XX│   最终配置     │ 99-final.rules  │
└─────┴────────────────┴─────────────────┘
```

### 3.3 规则文件示例


**创建自定义规则文件**：
```bash
# 创建本地规则文件
sudo nano /etc/audit/rules.d/50-local.rules
```

```bash
# 50-local.rules 文件内容示例

# 删除所有现有规则（通常放在开头）
-D

# 设置缓冲区大小
-b 8192

# 设置失败模式（0=静默，1=打印，2=panic）
-f 1

# === 文件监控规则 ===
# 监控重要系统文件
-w /etc/passwd -p wa -k passwd_changes
-w /etc/shadow -p wa -k shadow_changes
-w /etc/sudoers -p wa -k sudoers_changes

# 监控系统配置目录
-w /etc/ssh/ -p wa -k ssh_config

# === 系统调用监控 ===
# 监控文件权限变更
-a always,exit -F arch=b64 -S chmod,fchmod,fchmodat -k perm_mod

# 监控网络连接
-a always,exit -F arch=b64 -S socket,connect -k network

# 使规则不可变（放在最后）
-e 2
```

### 3.4 规则重载与生效


```bash
# 重载规则文件
sudo augenrules --load

# 或者重启auditd服务
sudo systemctl restart auditd

# 验证规则加载
auditctl -l
```

---

## 4. 📝 审计规则语法结构


### 4.1 规则语法基本格式


**核心语法**：audit规则遵循特定的语法格式，每个部分都有明确含义。

```
规则语法结构图：
┌─────────┬─────────┬─────────┬─────────┐
│  动作   │  列表   │  过滤器 │  键名   │
│ Action  │  List   │ Filter  │  Key    │
├─────────┼─────────┼─────────┼─────────┤
│   -a    │ always, │   -F    │   -k    │
│   -w    │  exit   │   -S    │  名称   │
└─────────┴─────────┴─────────┴─────────┘
```

### 4.2 规则类型分类


**两大类规则**：
```
🔸 文件监控规则 (-w)
  └── 监控特定文件或目录的访问

🔸 系统调用规则 (-a)  
  └── 监控特定系统调用的执行
```

### 4.3 通用规则选项


**📋 重要选项说明**：

| 选项 | 含义 | 用途 | 示例 |
|------|------|------|------|
| `-D` | Delete all | 删除所有规则 | `-D` |
| `-l` | List | 列出当前规则 | `-l` |
| `-s` | Status | 显示审计状态 | `-s` |
| `-e` | Enable | 设置启用状态 | `-e 1` |
| `-f` | Failure | 设置失败模式 | `-f 1` |
| `-b` | Buffer | 设置缓冲区大小 | `-b 8192` |

**启用状态含义**：
```
-e 0  # 禁用审计
-e 1  # 启用审计  
-e 2  # 锁定配置（不可变模式）
```

**失败模式含义**：
```
-f 0  # 静默模式，忽略失败
-f 1  # 打印失败信息到日志
-f 2  # panic模式，系统崩溃
```

---

## 5. 📂 文件监控规则(-w)


### 5.1 -w规则基本语法


**语法格式**：
```bash
-w <路径> -p <权限> -k <键名>
```

**参数含义**：
- **路径**：要监控的文件或目录
- **权限**：监控什么类型的操作
- **键名**：用于搜索和分类的标识

### 5.2 权限参数详解


**权限字母含义**：
```
┌──────┬────────────┬─────────────────┐
│ 字母 │    含义    │     说明        │
├──────┼────────────┼─────────────────┤
│  r   │   read     │ 读取文件内容    │
│  w   │   write    │ 写入/修改文件   │
│  x   │  execute   │ 执行文件        │
│  a   │  attribute │ 修改文件属性    │
└──────┴────────────┴─────────────────┘
```

**组合使用示例**：
```bash
# 只监控读取操作
-w /etc/passwd -p r -k passwd_read

# 监控写入和属性修改
-w /etc/shadow -p wa -k shadow_modify

# 监控所有操作
-w /etc/sudoers -p rwxa -k sudoers_all

# 监控执行操作
-w /usr/bin/sudo -p x -k sudo_exec
```

### 5.3 文件监控实际示例


**🔒 系统安全文件监控**：
```bash
# 用户账户文件
-w /etc/passwd -p wa -k user_accounts
-w /etc/shadow -p wa -k password_files  
-w /etc/group -p wa -k group_accounts

# SSH配置文件
-w /etc/ssh/sshd_config -p wa -k ssh_config
-w /root/.ssh -p wa -k root_ssh_keys

# 系统启动文件
-w /boot/grub/grub.cfg -p wa -k boot_config
-w /etc/systemd/ -p wa -k systemd_config
```

**📁 目录监控特点**：
```bash
# 监控整个目录
-w /var/log/ -p wa -k log_files

# 注意：目录监控会影响性能，谨慎使用大目录
# ✅ 推荐：监控具体重要文件
# ❌ 避免：监控 / 或 /home 这样的大目录
```

### 5.4 键名命名最佳实践


**🏷️ 键名命名建议**：
```bash
# 按功能分类
-k user_management      # 用户管理相关
-k system_config        # 系统配置相关  
-k security_events      # 安全事件相关
-k network_access       # 网络访问相关

# 按文件类型分类
-k passwd_files         # 密码文件
-k config_files         # 配置文件
-k log_files           # 日志文件
-k binary_files        # 可执行文件
```

---

## 6. ⚙️ 系统调用监控规则(-a)


### 6.1 -a规则基本语法


**语法格式**：
```bash
-a <动作>,<列表> -F <过滤条件> -S <系统调用> -k <键名>
```

**语法组件解析**：
```
-a always,exit     # 动作和列表
-F arch=b64        # 过滤条件
-S openat          # 系统调用
-k file_access     # 键名标识
```

### 6.2 动作和列表参数


**动作类型**：
```
┌─────────┬─────────────────────────────┐
│  动作   │           含义              │
├─────────┼─────────────────────────────┤
│ always  │ 总是记录（推荐）            │
│ never   │ 从不记录                    │
└─────────┴─────────────────────────────┘
```

**列表类型**：
```
┌─────────┬─────────────────────────────┐
│  列表   │           含义              │
├─────────┼─────────────────────────────┤
│  task   │ 进程创建时触发              │
│  exit   │ 系统调用退出时触发（常用）  │
│  user   │ 用户空间触发                │
│ exclude │ 排除规则                    │
└─────────┴─────────────────────────────┘
```

### 6.3 -S系统调用参数


**常用系统调用分类**：

**📁 文件操作类**：
```bash
# 文件打开/创建
-S open,openat,creat

# 文件删除
-S unlink,unlinkat,rmdir

# 文件重命名
-S rename,renameat

# 示例：监控文件删除操作
-a always,exit -F arch=b64 -S unlink,unlinkat -k file_delete
```

**🔐 权限操作类**：
```bash
# 文件权限修改
-S chmod,fchmod,fchmodat

# 文件所有者修改  
-S chown,fchown,lchown

# 示例：监控权限变更
-a always,exit -F arch=b64 -S chmod,fchmod -k perm_changes
```

**🌐 网络操作类**：
```bash
# 网络连接
-S socket,connect,bind

# 示例：监控网络连接
-a always,exit -F arch=b64 -S socket,connect -k network_ops
```

### 6.4 系统调用监控实例


**完整监控规则示例**：
```bash
# 监控文件访问
-a always,exit -F arch=b64 -S openat -F success=1 -k file_access

# 监控特权操作
-a always,exit -F arch=b64 -S setuid,setgid -k privilege_escalation

# 监控进程创建
-a always,exit -F arch=b64 -S execve -k process_creation

# 监控网络活动
-a always,exit -F arch=b64 -S socket -F a0=2 -k ipv4_socket
```

---

## 7. 🔍 字段过滤与条件设置


### 7.1 -F过滤条件语法


**基本格式**：
```bash
-F <字段><操作符><值>
```

**操作符类型**：
```
┌─────────┬─────────────────────────────┐
│ 操作符  │           含义              │
├─────────┼─────────────────────────────┤
│   =     │ 等于                        │
│   !=    │ 不等于                      │
│   <     │ 小于                        │
│   <=    │ 小于等于                    │
│   >     │ 大于                        │
│   >=    │ 大于等于                    │
│   &     │ 位与操作                    │
│   &=    │ 位与等于                    │
└─────────┴─────────────────────────────┘
```

### 7.2 常用过滤字段


**🏗️ 架构相关字段**：
```bash
# 指定系统架构
-F arch=b64          # 64位系统
-F arch=b32          # 32位系统

# 为什么需要指定架构？
# 避免同一系统调用在不同架构下的重复记录
```

**👤 用户相关字段**：
```bash
# 按用户ID过滤
-F uid=1000          # 特定用户
-F uid>=1000         # 普通用户（非系统用户）
-F gid=0             # root组

# 按有效用户ID过滤
-F euid=0            # 以root权限执行
```

**📊 状态相关字段**：
```bash
# 按执行结果过滤
-F success=1         # 只记录成功的操作
-F success=0         # 只记录失败的操作

# 按进程ID过滤
-F pid=1234          # 特定进程
```

### 7.3 高级过滤示例


**组合过滤条件**：
```bash
# 监控普通用户的特权操作
-a always,exit -F arch=b64 -S setuid -F uid>=1000 -k user_privilege

# 监控特定用户的文件访问
-a always,exit -F arch=b64 -S openat -F uid=1001 -k user1001_files

# 监控失败的登录尝试
-a always,exit -F arch=b64 -S connect -F success=0 -k failed_connections
```

**路径过滤**：
```bash
# 监控特定目录下的操作
-a always,exit -F arch=b64 -S openat -F path=/etc/ -k etc_access

# 排除特定路径
-a always,exit -F arch=b64 -S openat -F path!=/tmp/ -k non_tmp_access
```

---

## 8. 📊 规则优先级与执行顺序


### 8.1 规则加载顺序


**文件加载顺序**：规则文件按文件名的数字顺序加载，小数字优先。

```
加载顺序示例：
01-first.rules      ← 最先加载
10-base.rules       
20-delete.rules     
30-monitor.rules    
99-final.rules      ← 最后加载
```

### 8.2 规则执行原理


**🔍 重要概念**：audit系统按规则添加顺序检查，**第一个匹配的规则决定动作**。

```
规则匹配流程：
事件发生
    ↓
检查规则1 → 匹配？ → 是 → 执行动作，停止检查
    ↓           
   否
    ↓
检查规则2 → 匹配？ → 是 → 执行动作，停止检查  
    ↓
   否
    ↓
... 继续检查后续规则
```

### 8.3 规则优先级最佳实践


**📋 推荐规则布局**：
```bash
# 1. 删除现有规则（放在最前面）
-D

# 2. 基础配置
-b 8192
-f 1

# 3. 排除规则（优先级最高）
-a never,exit -F arch=b64 -S read -F path=/proc/

# 4. 特定监控规则
-a always,exit -F arch=b64 -S openat -F path=/etc/passwd -k passwd_access

# 5. 通用监控规则  
-a always,exit -F arch=b64 -S openat -k file_access

# 6. 最终配置（放在最后面）
-e 2
```

### 8.4 规则冲突处理


**⚠️ 常见冲突场景**：
```bash
# 错误示例：规则顺序不当
-a always,exit -F arch=b64 -S openat -k all_files    # 通用规则在前
-a never,exit -F arch=b64 -S openat -F path=/tmp/    # 排除规则在后（无效！）

# 正确示例：排除规则优先
-a never,exit -F arch=b64 -S openat -F path=/tmp/    # 排除规则在前
-a always,exit -F arch=b64 -S openat -k all_files    # 通用规则在后
```

**🔧 冲突解决策略**：
1. **排除规则优先**：`never` 规则放在 `always` 规则前面
2. **具体规则优先**：特定条件的规则放在通用规则前面  
3. **测试验证**：使用 `auditctl -l` 检查规则顺序

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的基本概念


```
🔸 规则管理方式：临时(auditctl) vs 永久(配置文件)
🔸 两类规则：文件监控(-w) vs 系统调用监控(-a)  
🔸 规则语法：动作+列表+过滤条件+键名
🔸 加载顺序：按文件名数字顺序，第一匹配原则
🔸 权限监控：r(读) w(写) x(执行) a(属性)
```

### 9.2 关键理解要点


**🔹 规则设计原则**：
```
安全性 > 性能：重要文件必须监控，性能次要考虑
具体性 > 通用性：优先监控具体路径，避免泛泛监控
排除性 > 包含性：先排除不需要的，再包含需要的
```

**🔹 性能影响考虑**：
```
高性能影响：
- 监控大目录（如 /home/）
- 监控高频系统调用（如 read）
- 过多的通用规则

低性能影响：  
- 监控具体文件
- 监控低频系统调用（如 setuid）
- 合理的过滤条件
```

### 9.3 实际应用场景


**🎯 典型监控场景**：
- **安全审计**：用户账户文件、权限变更、特权操作
- **合规要求**：敏感文件访问、配置变更记录
- **故障排查**：程序异常行为、文件损坏追踪
- **性能分析**：高频文件访问、系统调用统计

### 9.4 最佳实践总结


**📝 规则配置建议**：
```bash
# 1. 标准规则模板
/etc/audit/rules.d/50-local.rules:

-D                                    # 清空现有规则
-b 8192                              # 设置合理缓冲区
-f 1                                 # 失败时记录日志

# 2. 核心文件监控
-w /etc/passwd -p wa -k user_accounts
-w /etc/shadow -p wa -k password_files
-w /etc/sudoers -p wa -k sudo_config

# 3. 系统调用监控  
-a always,exit -F arch=b64 -S setuid,setgid -k privilege_escalation

# 4. 锁定配置
-e 2                                 # 防止规则被修改
```

**🔧 维护检查清单**：
- ☑️ 定期检查规则加载状态：`auditctl -s`
- ☑️ 验证规则语法正确性：`auditctl -l`  
- ☑️ 监控日志文件大小增长
- ☑️ 测试关键规则的触发效果
- ☑️ 评估系统性能影响

**💡 记忆要点**：
- audit规则就是系统的"监控摄像头配置单"
- `-w` 监控文件，`-a` 监控系统调用  
- 规则顺序很重要，第一个匹配的规则生效
- 键名(`-k`)是日志搜索的重要标识
- 合理配置能在安全性和性能间取得平衡