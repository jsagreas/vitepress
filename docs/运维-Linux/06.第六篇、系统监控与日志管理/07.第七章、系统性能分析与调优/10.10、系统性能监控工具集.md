---
title: 10、系统性能监控工具集
---
## 📚 目录

1. [系统性能监控概述](#1-系统性能监控概述)
2. [实时监控工具 - top/htop](#2-实时监控工具-tophtop)
3. [系统统计分析 - vmstat](#3-系统统计分析-vmstat)
4. [磁盘IO监控 - iostat](#4-磁盘io监控-iostat)
5. [系统活动报告 - sar](#5-系统活动报告-sar)
6. [高级性能分析 - perf](#6-高级性能分析-perf)
7. [专项监控工具 - iotop/iftop](#7-专项监控工具-iotopiftop)
8. [综合监控工具 - dstat](#8-综合监控工具-dstat)
9. [性能数据收集策略](#9-性能数据收集策略)
10. [核心要点总结](#10-核心要点总结)

---

## 1. 🎯 系统性能监控概述


### 1.1 什么是系统性能监控


**系统性能监控**就是实时观察和记录Linux系统运行状态的过程。简单来说，就像给系统装上"体检仪器"，随时了解系统的健康状况。

**为什么需要监控**：
- **发现问题**：系统运行慢了、卡顿了，第一时间知道
- **预防故障**：在问题严重之前及时处理
- **优化性能**：找出性能瓶颈，针对性改进
- **资源规划**：了解资源使用情况，合理分配

### 1.2 监控的四大维度


Linux系统性能监控主要关注四个方面：

```
系统性能四大支柱：
┌─────────────┐  ┌─────────────┐
│     CPU     │  │    内存     │
│  处理器使用  │  │  Memory     │
└─────────────┘  └─────────────┘
┌─────────────┐  ┌─────────────┐
│   磁盘I/O   │  │    网络     │
│  Disk I/O   │  │   Network   │
└─────────────┘  └─────────────┘
```

**🔸 CPU监控**
- **CPU使用率**：处理器忙碌程度
- **负载均衡**：任务分配是否合理
- **进程状态**：哪些程序在占用CPU

**🔸 内存监控**
- **内存使用量**：已用/可用内存
- **交换空间**：虚拟内存使用情况
- **缓存状态**：系统缓存效率

**🔸 磁盘I/O监控**
- **读写速度**：磁盘数据传输快慢
- **I/O等待**：程序等待磁盘时间
- **磁盘利用率**：硬盘忙碌程度

**🔸 网络监控**
- **网络流量**：数据收发量
- **连接状态**：网络连接情况
- **带宽使用**：网络传输效率

### 1.3 监控工具分类


| 工具类型 | **主要工具** | **监控重点** | **使用场景** |
|---------|-------------|-------------|-------------|
| 🔄 **实时监控** | `top`, `htop` | `整体系统状态` | `快速查看当前状态` |
| 📊 **统计分析** | `vmstat`, `iostat` | `历史数据分析` | `性能趋势分析` |
| 📈 **报告工具** | `sar` | `长期数据收集` | `性能报告生成` |
| 🔍 **专业分析** | `perf` | `深度性能分析` | `性能调优专用` |
| 🎯 **专项监控** | `iotop`, `iftop` | `特定资源监控` | `针对性问题排查` |

---

## 2. 👀 实时监控工具 - top/htop


### 2.1 top命令详解


**top**是Linux最基本的实时监控工具，就像Windows的任务管理器。

#### 🚀 基本使用


```bash
# 启动top监控
top

# 常用参数
top -d 2        # 每2秒刷新一次
top -u username # 只显示特定用户的进程
top -p 1234     # 只监控指定PID的进程
```

#### 📊 top界面解读


```
top - 14:25:30 up 10 days,  5:42,  2 users,  load average: 0.45, 0.52, 0.48
Tasks: 267 total,   1 running, 266 sleeping,   0 stopped,   0 zombie
%Cpu(s):  5.2 us,  2.1 sy,  0.0 ni, 92.1 id,  0.6 wa,  0.0 hi,  0.0 si,  0.0 st
MiB Mem :   7840.5 total,   1205.3 free,   3542.1 used,   3093.1 buff/cache
MiB Swap:   2048.0 total,   2048.0 free,      0.0 used.   3890.2 avail Mem

  PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND
 1234 root      20   0  162584   4328   3128 S   2.3   0.1   0:15.82 systemd
 5678 mysql     20   0 1727036 187540  15364 S   1.7   2.4  12:45.23 mysqld
```

**🔸 第一行 - 系统概况**
- **14:25:30**：当前时间
- **up 10 days, 5:42**：系统运行时间（10天5小时42分钟）
- **2 users**：当前登录用户数
- **load average: 0.45, 0.52, 0.48**：系统负载（1分钟、5分钟、15分钟平均值）

> **💡 负载理解**：负载值表示等待CPU处理的任务数量。单核系统中，1.0表示CPU满负荷，超过1.0表示有任务在排队等待。

**🔸 第二行 - 任务状态**
- **267 total**：总进程数
- **1 running**：正在运行的进程
- **266 sleeping**：休眠进程
- **0 zombie**：僵尸进程（需要关注）

**🔸 第三行 - CPU使用率**
- **us（user）**：用户进程占用CPU百分比
- **sy（system）**：系统进程占用CPU百分比
- **id（idle）**：CPU空闲百分比
- **wa（wait）**：等待I/O的CPU百分比

**🔸 第四、五行 - 内存信息**
- **total**：总内存
- **free**：空闲内存
- **used**：已使用内存
- **buff/cache**：缓存和缓冲区

#### ⌨️ top交互命令


在top运行时，可以使用以下快捷键：

| 按键 | **功能说明** |
|------|-------------|
| `q` | `退出top` |
| `h` | `显示帮助` |
| `k` | `杀死进程（输入PID）` |
| `r` | `修改进程优先级` |
| `P` | `按CPU使用率排序` |
| `M` | `按内存使用率排序` |
| `1` | `显示所有CPU核心` |

### 2.2 htop增强版监控


**htop**是top的增强版，提供更友好的界面和更多功能。

#### 🎨 htop界面特色


```
┌─ htop界面示例 ─────────────────────────────────────┐
│  1  [||||||||||||100.0%]   Tasks: 45, 123 thr; 1 running │
│  2  [|||       34.2%]      Load average: 0.42 0.38 0.31   │
│  3  [||        23.1%]      Uptime: 10:25:30               │
│  4  [|         12.5%]                                     │
│  Mem[|||||||||||6.50G/8.00G]  Swp[    0K/2.00G]         │
│                                                          │
│  PID USER     PRI  NI  VIRT   RES   SHR S CPU% MEM% Command │
│ 1234 root      20   0  162M  4328  3128 S  2.3  0.1 systemd │
└──────────────────────────────────────────────────────────┘
```

#### 🔧 htop安装与使用


```bash
# 安装htop（CentOS/RHEL）
sudo yum install htop

# 安装htop（Ubuntu/Debian）
sudo apt install htop

# 启动htop
htop
```

#### 🎯 htop优势


**vs top的改进**：
- ✅ **彩色显示**：不同颜色区分不同信息
- ✅ **鼠标支持**：可以用鼠标点击操作
- ✅ **树形显示**：显示进程间的父子关系
- ✅ **横向滚动**：支持查看长命令行
- ✅ **多种排序**：更灵活的排序选项

### 2.3 实际使用场景


#### 🚨 性能问题排查


**场景1：系统突然变慢**
```bash
# 第一步：查看整体负载
top
# 观察：load average是否过高、CPU使用率、内存使用情况

# 第二步：找出问题进程
# 在top中按P键按CPU排序，找出CPU占用最高的进程
# 在top中按M键按内存排序，找出内存占用最高的进程
```

**场景2：服务器响应慢**
```bash
# 使用htop查看详细信息
htop
# 查看：
# - 负载是否正常
# - 是否有进程占用大量CPU
# - 内存是否不足
# - 是否有僵尸进程
```

---

## 3. 📈 系统统计分析 - vmstat


### 3.1 vmstat基本概念


**vmstat**（Virtual Memory Statistics）是系统状态统计工具，提供CPU、内存、I/O、进程等综合信息。

**vmstat的作用**：
- **系统概览**：一次性查看多项系统指标
- **趋势分析**：通过连续监控发现性能趋势
- **瓶颈定位**：快速识别系统瓶颈所在

### 3.2 vmstat使用方法


#### 🔧 基本语法


```bash
# 基本用法
vmstat [刷新间隔] [监控次数]

# 常用示例
vmstat              # 显示一次系统统计信息
vmstat 2            # 每2秒显示一次，持续监控
vmstat 2 5          # 每2秒显示一次，总共5次
vmstat -d           # 显示磁盘统计信息
vmstat -p /dev/sda1 # 显示特定分区统计
```

#### 📊 vmstat输出解读


```bash
$ vmstat 2 3
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 1  0      0 1205320  89632 3093184    0    0    12     8  156  245  5  2 92  1  0
 0  0      0 1205184  89632 3093184    0    0     0     4  89  178  3  1 96  0  0
 1  0      0 1205048  89640 3093184    0    0     0    12  95  189  4  2 94  0  0
```

**🔸 进程状态（procs）**
- **r（runnable）**：等待运行的进程数
- **b（blocked）**：阻塞等待I/O的进程数

> **💡 理解要点**：r值长期大于CPU核心数，说明CPU不够用；b值较高说明I/O瓶颈。

**🔸 内存状态（memory）**
- **swpd**：使用的交换空间（KB）
- **free**：空闲内存（KB）
- **buff**：缓冲区内存（KB）
- **cache**：缓存内存（KB）

**🔸 交换空间（swap）**
- **si（swap in）**：从交换分区读入内存的速度（KB/s）
- **so（swap out）**：写入交换分区的速度（KB/s）

**🔸 I/O状态（io）**
- **bi（blocks in）**：从块设备读取的块数（blocks/s）
- **bo（blocks out）**：写入块设备的块数（blocks/s）

**🔸 系统状态（system）**
- **in（interrupts）**：每秒中断次数
- **cs（context switch）**：每秒上下文切换次数

**🔸 CPU状态（cpu）**
- **us**：用户进程占用CPU百分比
- **sy**：系统进程占用CPU百分比
- **id**：CPU空闲百分比
- **wa**：等待I/O的CPU百分比
- **st**：被虚拟机偷走的CPU百分比

### 3.3 vmstat实战分析


#### 🎯 性能瓶颈识别


**CPU瓶颈特征**：
```bash
$ vmstat 1 5
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 8  0      0 1205320  89632 3093184    0    0    12     8  156  245 85 10  5  0  0
 6  0      0 1205184  89632 3093184    0    0     0     4  189  278 88  8  4  0  0
```
- **r值高**：等待CPU的进程多（8、6个进程在等待）
- **us值高**：用户进程大量占用CPU（85%、88%）
- **id值低**：CPU空闲时间很少（5%、4%）

**内存瓶颈特征**：
```bash
$ vmstat 1 5
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 2  1  50000    120000  5632   93184   80   60   112    18  156  245 25 15 45 15  0
 1  2  52000    118000  5632   93184   95   75   128    22  189  278 22 18 42 18  0
```
- **swpd增长**：交换空间使用量在增加（50000→52000）
- **si/so活跃**：频繁的交换活动（80/60、95/75）
- **free较低**：可用内存不足（120000、118000）

**I/O瓶颈特征**：
```bash
$ vmstat 1 5
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 1  5      0 1205320  89632 3093184    0    0   1200   800  156  245 15  5 50 30  0
 2  6      0 1205184  89632 3093184    0    0   1100   900  189  278 18  8 45 29  0
```
- **b值高**：多个进程阻塞等待I/O（5、6个）
- **bi/bo高**：磁盘读写活动频繁（1200/800、1100/900）
- **wa值高**：CPU等待I/O时间较长（30%、29%）

---

## 4. 💾 磁盘I/O监控 - iostat


### 4.1 iostat工具介绍


**iostat**是专门监控磁盘I/O性能的工具，能够详细显示磁盘读写活动和性能指标。

**iostat的价值**：
- **I/O性能分析**：了解磁盘读写效率
- **瓶颈识别**：发现I/O相关的性能问题
- **容量规划**：评估存储系统负载

### 4.2 iostat使用详解


#### 🔧 基本用法


```bash
# 安装iostat（通常在sysstat包中）
sudo yum install sysstat    # CentOS/RHEL
sudo apt install sysstat    # Ubuntu/Debian

# 基本使用
iostat                      # 显示一次统计信息
iostat 2                    # 每2秒刷新一次
iostat 2 5                  # 每2秒刷新，共5次
iostat -x                   # 显示扩展统计信息
iostat -d                   # 只显示磁盘统计
```

#### 📊 iostat输出解读


**基本输出**：
```bash
$ iostat
Linux 3.10.0-957.el7.x86_64        09/15/2025      _x86_64_        (4 CPU)

avg-cpu:  %user   %nice %system %iowait  %steal   %idle
           5.23    0.00    2.15    0.58    0.00   92.04

Device:            tps    kB_read/s    kB_wrtn/s    kB_read    kB_wrtn
sda               8.45        45.23        89.67     485632     962854
sdb               2.34        12.45         5.89     133654      63287
```

**🔸 CPU部分解读**
- **%user**：用户进程占用CPU百分比
- **%system**：系统进程占用CPU百分比
- **%iowait**：等待I/O的CPU百分比（关键指标）
- **%idle**：CPU空闲百分比

**🔸 磁盘部分解读**
- **Device**：设备名称（sda、sdb等）
- **tps**：每秒传输次数（transactions per second）
- **kB_read/s**：每秒读取千字节数
- **kB_wrtn/s**：每秒写入千字节数
- **kB_read**：总读取千字节数
- **kB_wrtn**：总写入千字节数

#### 🔍 扩展统计信息


```bash
$ iostat -x 1 3
Device:         rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util
sda               0.12     8.45    3.45    4.89    45.23    89.67    32.45     0.12   15.23   12.45   17.89   8.45   6.78
sdb               0.05     2.34    1.23    1.11    12.45     5.89    15.67     0.05    8.45    7.23    9.78   5.67   2.34
```

**🔸 详细指标解读**

| 指标 | **含义** | **正常范围** | **异常表现** |
|------|----------|-------------|-------------|
| `rrqm/s` | `每秒合并的读请求数` | `< 100` | `过高说明读请求碎片化` |
| `wrqm/s` | `每秒合并的写请求数` | `< 100` | `过高说明写请求碎片化` |
| `r/s` | `每秒读操作数` | `根据应用而定` | `突然增高需关注` |
| `w/s` | `每秒写操作数` | `根据应用而定` | `突然增高需关注` |
| `avgrq-sz` | `平均请求大小（扇区）` | `> 16` | `过小说明随机I/O多` |
| `avgqu-sz` | `平均队列长度` | `< 2` | `过高说明I/O拥塞` |
| `await` | `平均等待时间（毫秒）` | `< 20ms` | `过高说明性能差` |
| `svctm` | `平均服务时间（毫秒）` | `< 10ms` | `过高说明磁盘慢` |
| `%util` | `磁盘利用率` | `< 80%` | `接近100%说明瓶颈` |

### 4.3 I/O性能分析实例


#### 🚨 问题诊断案例


**案例1：磁盘I/O瓶颈**
```bash
$ iostat -x 1
Device:         rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await  svctm  %util
sda               0.00     0.00   180.00   95.00    1440     760     16.00     8.50   42.73  3.64  100.00
```

**分析结果**：
- **%util = 100%**：磁盘利用率满载，明显瓶颈
- **await = 42.73ms**：平均等待时间过长（正常<20ms）
- **avgqu-sz = 8.50**：队列长度过长（正常<2）
- **avgrq-sz = 16**：请求偏小，可能是随机I/O

**优化建议**：
- 考虑使用SSD替换机械硬盘
- 优化应用I/O模式，减少随机读写
- 增加内存缓存，减少磁盘访问

**案例2：正常I/O状态**
```bash
$ iostat -x 1
Device:         rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await  svctm  %util
sda               0.12     8.45    3.45    4.89    45.23    89.67    32.45     0.12    5.23   2.45  15.78
```

**分析结果**：
- **%util = 15.78%**：磁盘利用率正常
- **await = 5.23ms**：等待时间良好
- **avgqu-sz = 0.12**：队列长度理想
- **avgrq-sz = 32.45**：请求大小合理

---

## 5. 📋 系统活动报告 - sar


### 5.1 sar工具概述


**sar**（System Activity Reporter）是功能最全面的系统监控工具，可以收集、报告和保存系统活动信息。

**sar的特点**：
- **全面监控**：CPU、内存、I/O、网络、进程等全覆盖
- **历史数据**：自动保存历史监控数据
- **定时收集**：支持定时自动收集系统信息
- **报告生成**：可生成详细的性能报告

### 5.2 sar基本使用


#### 🔧 常用命令组合


```bash
# CPU使用率监控
sar -u 2 5          # 每2秒显示CPU使用率，共5次
sar -u -f /var/log/sa/sa15   # 查看15号的CPU历史数据

# 内存使用监控
sar -r 2 5          # 内存使用情况
sar -S 2 5          # 交换空间使用情况

# I/O监控
sar -d 2 5          # 磁盘I/O活动
sar -b 2 5          # I/O和传输速率统计

# 网络监控
sar -n DEV 2 5      # 网络接口统计
sar -n TCP 2 5      # TCP连接统计

# 进程创建监控
sar -v 2 5          # 进程、inode、文件和锁表状态
```

#### 📊 sar输出示例


**CPU监控输出**：
```bash
$ sar -u 2 3
Linux 3.10.0-957.el7.x86_64        09/15/2025      _x86_64_        (4 CPU)

02:25:30 PM     CPU     %user     %nice   %system   %iowait    %steal     %idle
02:25:32 PM     all      5.23      0.00      2.15      0.58      0.00     92.04
02:25:34 PM     all      4.89      0.00      2.45      0.72      0.00     91.94
02:25:36 PM     all      6.12      0.00      1.98      0.45      0.00     91.45
Average:        all      5.41      0.00      2.19      0.58      0.00     91.81
```

**内存监控输出**：
```bash
$ sar -r 2 3
02:25:30 PM kbmemfree kbmemused  %memused kbbuffers  kbcached  kbcommit   %commit
02:25:32 PM   1205320   6635136     84.62     89632   3093184   4567890     45.23
02:25:34 PM   1198456   6642000     84.71     89632   3095234   4578901     45.34
02:25:36 PM   1192378   6648078     84.79     89640   3097456   4589123     45.45
Average:      1198718   6641738     84.71     89635   3095291   4578638     45.34
```

### 5.3 sar历史数据分析


#### 📈 查看历史性能数据


```bash
# 查看昨天的CPU使用情况
sar -u -f /var/log/sa/sa14

# 查看指定时间段的数据
sar -u -s 09:00:00 -e 18:00:00 -f /var/log/sa/sa15

# 生成全天的性能报告
sar -A -f /var/log/sa/sa15 > system_report.txt
```

#### 🔧 配置自动数据收集


sar通过cron定时任务自动收集数据：

```bash
# 查看sar的cron配置
cat /etc/cron.d/sysstat

# 典型配置内容：
# 每10分钟收集一次系统活动数据
*/10 * * * * root /usr/lib64/sa/sa1 1 1
# 每天23:53生成日报告
53 23 * * * root /usr/lib64/sa/sa2 -A
```

---

## 6. 🔬 高级性能分析 - perf


### 6.1 perf工具介绍


**perf**是Linux内核提供的高级性能分析工具，可以进行系统级和应用级的深度性能分析。

**perf的能力**：
- **CPU性能分析**：找出CPU热点代码
- **内存访问分析**：分析内存访问模式
- **缓存性能分析**：分析CPU缓存命中率
- **系统调用跟踪**：跟踪系统调用性能

### 6.2 perf基本使用


#### 🔧 安装和基本命令


```bash
# 安装perf
sudo yum install perf           # CentOS/RHEL
sudo apt install linux-tools-generic  # Ubuntu

# 基本使用
perf list                       # 列出可用的性能事件
perf stat command              # 统计命令的性能指标
perf record command            # 记录性能数据
perf report                    # 分析记录的数据
perf top                       # 实时显示系统热点
```

#### 📊 perf使用示例


**性能统计分析**：
```bash
$ perf stat ls -la
 Performance counter stats for 'ls -la':

          2.34 msec task-clock:u              #    0.673 CPUs utilized
             0      context-switches:u        #    0.000 K/sec
             0      cpu-migrations:u          #    0.000 K/sec
            89      page-faults:u             #    0.038 M/sec
     2,345,678      cycles:u                  #    1.002 GHz
     1,234,567      instructions:u            #    0.53  insn per cycle
       234,567      branches:u                #  100.243 M/sec
        12,345      branch-misses:u           #    5.26% of all branches

       0.003479 seconds time elapsed
```

**实时热点分析**：
```bash
$ perf top
Samples: 1K of event 'cycles:ppp', Event count (approx.): 254893
Overhead  Shared Object     Symbol
  15.23%  [kernel]          [k] _raw_spin_lock_irqsave
   8.45%  libc-2.17.so      [.] _int_malloc
   7.89%  [kernel]          [k] copy_user_generic_string
   6.23%  mysqld            [.] rec_get_nth_field
   5.67%  [kernel]          [k] tcp_sendmsg
```

### 6.3 perf高级分析


#### 🎯 CPU热点分析


```bash
# 记录系统调用
perf record -g ./my_program

# 生成火焰图数据
perf script > perf.data

# 分析结果
perf report --stdio
```

**适用场景**：
- 🔍 **性能调优**：找出程序中的性能瓶颈
- 🔍 **系统分析**：分析系统级性能问题  
- 🔍 **应用优化**：优化应用程序性能

---

## 7. 🎯 专项监控工具 - iotop/iftop


### 7.1 iotop - I/O监控专家


**iotop**专门监控进程的I/O使用情况，类似于top但专注于磁盘I/O。

#### 🔧 iotop使用


```bash
# 安装iotop
sudo yum install iotop         # CentOS/RHEL
sudo apt install iotop         # Ubuntu/Debian

# 基本使用
sudo iotop                     # 实时显示I/O状态
sudo iotop -o                  # 只显示有I/O活动的进程
sudo iotop -a                  # 显示累积I/O
sudo iotop -u username         # 只显示特定用户的进程
```

#### 📊 iotop界面解读


```
Total DISK READ :       8.45 M/s | Total DISK WRITE :      12.34 M/s
Actual DISK READ:       7.89 M/s | Actual DISK WRITE:      11.78 M/s
  TID  PRIO  USER     DISK READ  DISK WRITE  SWAPIN     IO>    COMMAND
 1234    be/4 mysql      1.23 M/s    4.56 M/s  0.00 %  85.23 % mysqld
 5678    be/4 root       0.45 M/s    2.34 M/s  0.00 %  45.67 % rsync
 9012    be/4 backup     2.34 M/s    0.12 M/s  0.00 %  78.90 % tar
```

**🔸 关键信息解读**
- **DISK READ/WRITE**：进程的实际磁盘读写速度
- **SWAPIN**：交换空间读取百分比
- **IO%**：进程等待I/O的时间百分比
- **COMMAND**：进程名称

### 7.2 iftop - 网络监控专家


**iftop**专门监控网络连接和流量使用情况。

#### 🔧 iftop使用


```bash
# 安装iftop
sudo yum install iftop         # CentOS/RHEL  
sudo apt install iftop         # Ubuntu/Debian

# 基本使用
sudo iftop                     # 监控所有网络接口
sudo iftop -i eth0             # 监控指定网络接口
sudo iftop -n                  # 不解析主机名
sudo iftop -P                  # 显示端口号
```

#### 📊 iftop界面解读


```
                    12.5Kb  25.0Kb  37.5Kb  50.0Kb  62.5Kb
┌───────────────────┴──────┴───────┴───────┴───────┴
server1.example.com:22          => client1.example.com:54321    1.23Kb  2.34Kb  3.45Kb
                                <=                               0.89Kb  1.23Kb  1.67Kb
server1.example.com:80          => client2.example.com:45678    4.56Kb  5.67Kb  6.78Kb
                                <=                               2.34Kb  3.45Kb  4.56Kb
───────────────────────────────────────────────────────────────────────────────────────
TX:             cum:     15.6KB   rates:     7.89Kb  12.3Kb  15.6Kb
RX:                      8.90KB              4.56Kb   7.89Kb  10.2Kb
TOTAL:                   24.5KB              12.4Kb  20.2Kb  25.8Kb
```

**🔸 关键信息解读**
- **=>**：发送方向的流量
- **<=**：接收方向的流量
- **三列数字**：最近2秒、10秒、40秒的平均流量
- **TX/RX/TOTAL**：发送/接收/总计流量统计

---

## 8. 🎛️ 综合监控工具 - dstat


### 8.1 dstat工具特色


**dstat**是一个多功能的系统监控工具，可以同时显示CPU、内存、网络、I/O等多项指标。

**dstat的优势**：
- **综合监控**：一个工具监控多项指标
- **彩色输出**：不同颜色区分不同类型数据
- **灵活配置**：可以自定义显示的监控项
- **CSV输出**：支持输出到CSV文件进行分析

### 8.2 dstat使用详解


#### 🔧 安装和基本使用


```bash
# 安装dstat
sudo yum install dstat         # CentOS/RHEL
sudo apt install dstat         # Ubuntu/Debian

# 基本使用
dstat                          # 默认显示CPU、磁盘、网络、分页、系统信息
dstat 2                        # 每2秒刷新一次
dstat -c -m -d -n 2 5         # 自定义显示项，每2秒刷新，共5次
```

#### 📊 dstat输出示例


```bash
$ dstat 2 5
You did not select any stats, using -cdngy by default.
----total-cpu-usage---- -dsk/total- -net/total- ---paging-- ---system--
usr sys idl wai hiq siq| read  writ| recv  send|  in   out | int   csw 
  5   2  92   1   0   0|  45k   89k|   0     0 |   0     0 | 156   245 
  4   2  93   1   0   0|   0    12k|  23k   45k|   0     0 |  89   178 
  6   1  92   1   0   0|   0     4k|  12k   23k|   0     0 |  95   189 
  3   2  94   1   0   0|   8k   16k|  34k   56k|   0     0 | 112   203 
  5   1  93   1   0   0|   0     8k|  45k   67k|   0     0 | 134   234 
```

#### 🎯 dstat选项详解


| 选项 | **监控内容** | **说明** |
|------|-------------|----------|
| `-c` | `CPU使用率` | `user, system, idle, wait, hiq, siq` |
| `-m` | `内存使用` | `used, buff, cach, free` |
| `-d` | `磁盘I/O` | `read, write` |
| `-n` | `网络I/O` | `recv, send` |
| `-s` | `交换空间` | `used, free` |
| `-l` | `系统负载` | `1m, 5m, 15m平均负载` |
| `-p` | `进程统计` | `runnable, uninterruptible, new` |
| `-y` | `系统统计` | `interrupts, context switches` |

#### 🔧 高级使用技巧


**自定义监控组合**：
```bash
# 只监控CPU和内存
dstat -cm 2

# 监控特定网络接口
dstat -N eth0 2

# 监控特定磁盘
dstat -D sda1,sda2 2

# 输出到CSV文件
dstat -cdngy --output system_monitor.csv 2
```

---

## 9. 📋 性能数据收集策略


### 9.1 监控策略制定


**监控目标确定**：
- **基线建立**：了解系统正常状态下的性能指标
- **问题发现**：及时发现性能异常和瓶颈
- **趋势分析**：通过历史数据分析性能趋势
- **容量规划**：为系统扩容提供数据支持

### 9.2 监控频率设计


| 监控类型 | **建议频率** | **保留时间** | **适用工具** |
|---------|-------------|-------------|-------------|
| 🔄 **实时监控** | `1-5秒` | `当前会话` | `top, htop, dstat` |
| 📊 **短期统计** | `1-2分钟` | `24小时` | `vmstat, iostat` |
| 📈 **长期趋势** | `5-10分钟` | `30天` | `sar` |
| 🔍 **深度分析** | `按需执行` | `分析期间` | `perf` |

### 9.3 自动化监控脚本


#### 📝 简单监控脚本示例


```bash
#!/bin/bash
# 系统性能监控脚本

LOG_DIR="/var/log/performance"
DATE=$(date +%Y%m%d_%H%M%S)

# 创建日志目录
mkdir -p $LOG_DIR

# 收集系统基本信息
echo "=== System Performance Report - $DATE ===" > $LOG_DIR/report_$DATE.log

# CPU和内存概况
echo ">> CPU and Memory Status:" >> $LOG_DIR/report_$DATE.log
vmstat 1 5 >> $LOG_DIR/report_$DATE.log

# 磁盘I/O状态  
echo ">> Disk I/O Status:" >> $LOG_DIR/report_$DATE.log
iostat -x 1 5 >> $LOG_DIR/report_$DATE.log

# 进程TOP 10
echo ">> Top 10 Processes:" >> $LOG_DIR/report_$DATE.log
ps aux --sort=-%cpu | head -11 >> $LOG_DIR/report_$DATE.log

echo "Performance data collected at $DATE" >> $LOG_DIR/report_$DATE.log
```

#### ⏰ 定时任务配置


```bash
# 添加到crontab
# 每小时收集一次性能数据
0 * * * * /path/to/performance_monitor.sh

# 每天凌晨2点清理7天前的日志
0 2 * * * find /var/log/performance -name "report_*.log" -mtime +7 -delete
```

### 9.4 监控数据分析


#### 📈 性能基线建立


**数据收集期**（建议1-2周）：
```bash
# 工作日正常时段数据收集
sar -A > baseline_workday.log

# 非工作时段数据收集  
sar -A > baseline_offhours.log

# 计算基线指标
# CPU使用率基线: 通常 < 70%
# 内存使用率基线: 通常 < 80%  
# 磁盘I/O等待基线: 通常 < 20%
# 网络流量基线: 根据业务确定
```

#### 🚨 告警阈值设置


**推荐告警阈值**：

| 指标类型 | **警告阈值** | **严重阈值** | **处理建议** |
|---------|-------------|-------------|-------------|
| 🔸 **CPU使用率** | `> 80%` | `> 95%` | `检查高CPU进程` |
| 🔸 **内存使用率** | `> 85%` | `> 95%` | `检查内存泄漏` |
| 🔸 **磁盘使用率** | `> 85%` | `> 95%` | `清理磁盘空间` |
| 🔸 **I/O等待** | `> 20%` | `> 50%` | `检查磁盘性能` |
| 🔸 **系统负载** | `> 核心数×0.8` | `> 核心数×1.5` | `分析负载来源` |

---

## 10. 📋 核心要点总结


### 10.1 必须掌握的监控工具


```
🔸 实时监控: top/htop - 快速了解系统当前状态
🔸 综合分析: vmstat - 全面的系统性能统计
🔸 I/O专项: iostat - 深入分析磁盘I/O性能  
🔸 历史数据: sar - 长期性能趋势分析
🔸 高级分析: perf - 深度性能调优分析
🔸 专项监控: iotop/iftop - I/O和网络专项监控
🔸 综合工具: dstat - 多指标综合监控
```

### 10.2 性能监控核心原则


**🔹 监控四要素**
```
What - 监控什么: CPU/内存/I/O/网络四大维度
When - 什么时候: 实时监控 + 定期收集 + 问题排查
How - 如何监控: 选择合适工具，设置合理频率
Why - 为什么监控: 发现问题，分析趋势，优化性能
```

**🔹 问题排查思路**
```
第一步: 用top/htop查看整体状态
第二步: 用vmstat分析具体瓶颈类型
第三步: 用iostat/iotop定位I/O问题
第四步: 用sar分析历史趋势
第五步: 用perf深度分析性能热点
```

### 10.3 实际应用指导


**🎯 日常监控建议**
- ✅ **建立基线**：收集正常状态下的性能数据
- ✅ **设置告警**：根据基线设置合理的告警阈值
- ✅ **定期巡检**：每天查看关键性能指标
- ✅ **趋势分析**：每周分析性能趋势变化
- ✅ **文档记录**：记录性能问题和处理方案

**⚠️ 常见误区避免**
- ❌ **过度监控**：不要监控过于频繁，避免影响系统性能
- ❌ **忽视基线**：没有基线对比，很难判断是否异常
- ❌ **工具单一**：单一工具无法全面了解系统状态
- ❌ **只看当前**：只关注当前状态，忽视历史趋势分析

**🚀 性能优化方向**
```
CPU优化: 优化算法，减少不必要计算，合理使用多线程
内存优化: 避免内存泄漏，优化缓存策略，合理配置交换空间
I/O优化: 使用SSD，优化文件系统，减少随机I/O
网络优化: 优化网络配置，使用合适的传输协议
```

**核心记忆口诀**：
- 监控四维度，CPU内存IO网络
- 工具要熟练，top iostat vmstat sar
- 基线很重要，趋势分析不能少
- 问题要定位，性能优化有方向