---
title: 4、磁盘IO性能基准测试
---
## 📚 目录

1. [磁盘I/O性能基准测试概述](#1-磁盘IO性能基准测试概述)
2. [fio灵活I/O测试工具](#2-fio灵活IO测试工具)
3. [dd命令基础I/O测试](#3-dd命令基础IO测试)
4. [sysbench fileio测试模块](#4-sysbench-fileio测试模块)
5. [iozone文件系统测试](#5-iozone文件系统测试)
6. [顺序读写性能测试](#6-顺序读写性能测试)
7. [随机I/O性能测试](#7-随机IO性能测试)
8. [混合读写负载测试](#8-混合读写负载测试)
9. [I/O队列深度优化测试](#9-IO队列深度优化测试)
10. [核心要点总结](#10-核心要点总结)

---

## 1. 🔍 磁盘I/O性能基准测试概述


### 1.1 什么是磁盘I/O性能测试


**基本概念**：磁盘I/O性能测试就是**测量存储设备读写数据速度**的过程，帮我们了解硬盘、SSD等存储设备的真实性能表现。

```
简单理解：
就像测试汽车跑多快一样，I/O测试是测试硬盘读写数据有多快
```

**为什么要做I/O测试**：
- **🎯 了解硬件性能**：知道存储设备的真实能力
- **🔧 系统调优参考**：为系统优化提供数据支撑
- **📊 性能对比**：比较不同存储设备的性能差异
- **⚠️ 问题诊断**：发现存储系统的性能瓶颈

### 1.2 关键性能指标


**核心指标解释**：

| 指标名称 | **含义** | **单位** | **重要性** |
|---------|----------|---------|-----------|
| 🚀 **IOPS** | `每秒能完成多少次I/O操作` | `次/秒` | `随机访问性能的关键指标` |
| 📈 **吞吐量** | `每秒传输多少数据` | `MB/s` | `大文件传输性能指标` |
| ⏱️ **延迟** | `完成一次I/O操作需要多长时间` | `毫秒` | `响应速度的直接体现` |
| 📊 **队列深度** | `同时进行的I/O操作数量` | `个` | `并发处理能力指标` |

### 1.3 测试类型分类


**按访问模式分类**：
```
顺序I/O：
┌─────┬─────┬─────┬─────┐
│  1  │  2  │  3  │  4  │  连续读写，像看书一页页翻
└─────┴─────┴─────┴─────┘

随机I/O：
┌─────┬─────┬─────┬─────┐
│  3  │  1  │  4  │  2  │  跳跃读写，像翻字典查词
└─────┴─────┴─────┴─────┘
```

**按操作类型分类**：
- **📖 读测试**：测试数据读取速度
- **✏️ 写测试**：测试数据写入速度  
- **🔄 混合测试**：同时进行读写操作

---

## 2. ⚡ fio灵活I/O测试工具


### 2.1 fio工具介绍


**什么是fio**：fio是Linux系统中**最强大的I/O性能测试工具**，可以模拟各种真实的I/O工作负载。

> 💡 **为什么选择fio**  
> fio就像一个"万能测试器"，可以精确控制测试参数，模拟从数据库到文件服务器等各种应用场景

### 2.2 fio安装


```bash
# Ubuntu/Debian系统
sudo apt install fio

# CentOS/RHEL系统  
sudo yum install fio
```

### 2.3 fio核心参数详解


**基础参数含义**：

| 参数 | **作用** | **示例值** | **通俗解释** |
|------|----------|-----------|-------------|
| `filename` | `指定测试文件` | `/dev/sda` | `告诉fio在哪个设备上测试` |
| `size` | `测试文件大小` | `1G` | `测试用多大的文件` |
| `bs` | `块大小` | `4k` | `每次读写多少数据` |
| `rw` | `读写模式` | `randread` | `怎么读写数据（随机/顺序）` |
| `iodepth` | `队列深度` | `32` | `同时进行多少个I/O操作` |
| `runtime` | `测试时间` | `60` | `测试跑多长时间（秒）` |

### 2.4 常用测试场景


**顺序读性能测试**：
```bash
fio --name=seq-read --rw=read --bs=1M --size=1G --filename=/tmp/testfile
```

**随机读IOPS测试**：
```bash
fio --name=random-read --rw=randread --bs=4k --iodepth=32 --size=1G --runtime=60 --filename=/tmp/testfile
```

**混合读写测试**：
```bash
fio --name=mixed-rw --rw=randrw --rwmixread=70 --bs=4k --iodepth=16 --size=1G --runtime=60 --filename=/tmp/testfile
```

> ⚠️ **安全提醒**  
> 测试时请使用测试文件而不是系统盘，避免破坏重要数据

### 2.5 结果解读


**fio输出结果示例**：
```
read: IOPS=15.2k, BW=59.4MiB/s (62.3MB/s)(3565MiB/60001msec)
```

**结果含义解释**：
- **IOPS=15.2k**：每秒完成15200次读操作
- **BW=59.4MiB/s**：带宽为每秒59.4MB
- **runtime=60001msec**：测试运行了60秒

---

## 3. 🛠️ dd命令基础I/O测试


### 3.1 dd命令简介


**什么是dd**：dd是Linux系统自带的**数据复制工具**，虽然主要用于数据复制，但也可以用来做基础的I/O性能测试。

```
dd命令就像一个"数据搬运工"
可以把数据从一个地方复制到另一个地方
在复制过程中测量速度
```

### 3.2 dd测试写性能


**基本写测试**：
```bash
# 测试写入速度（写入1GB数据）
dd if=/dev/zero of=/tmp/testfile bs=1M count=1024 oflag=direct
```

**参数解释**：
- `if=/dev/zero`：从零设备读取数据（产生全零数据）
- `of=/tmp/testfile`：写入到测试文件
- `bs=1M`：每次写入1MB数据块
- `count=1024`：写入1024次，总共1GB
- `oflag=direct`：绕过缓存，测试真实磁盘速度

### 3.3 dd测试读性能


**基本读测试**：
```bash
# 先清空缓存，再测试读取速度
sudo echo 3 > /proc/sys/vm/drop_caches
dd if=/tmp/testfile of=/dev/null bs=1M iflag=direct
```

**为什么要清空缓存**：
```
不清缓存的情况：
数据在内存中 → 读取很快（假象）

清空缓存后：
必须从磁盘读取 → 真实的磁盘速度
```

### 3.4 dd命令的局限性


**dd的优缺点对比**：

| 优点 | 缺点 |
|------|------|
| ✅ 系统自带，无需安装 | ❌ 功能相对简单 |
| ✅ 使用简单直观 | ❌ 无法测试随机I/O |
| ✅ 适合快速测试 | ❌ 测试选项有限 |

---

## 4. 📊 sysbench fileio测试模块


### 4.1 sysbench简介


**什么是sysbench**：sysbench是一个**多功能基准测试工具**，其中的fileio模块专门用于文件系统I/O性能测试。

### 4.2 sysbench安装


```bash
# Ubuntu/Debian
sudo apt install sysbench

# CentOS/RHEL
sudo yum install sysbench
```

### 4.3 sysbench fileio测试流程


**完整测试三步骤**：

**第一步：准备测试文件**
```bash
sysbench fileio --file-total-size=2G prepare
```

**第二步：运行性能测试**
```bash
sysbench fileio --file-total-size=2G --file-test-mode=rndrw --time=60 --threads=4 run
```

**第三步：清理测试文件**
```bash
sysbench fileio cleanup
```

### 4.4 不同测试模式


**测试模式对照表**：

| 模式名称 | **测试内容** | **适用场景** |
|---------|-------------|-------------|
| `seqwr` | `顺序写入` | `文件上传、备份场景` |
| `seqrd` | `顺序读取` | `文件下载、流媒体` |
| `rndrd` | `随机读取` | `数据库查询` |
| `rndwr` | `随机写入` | `数据库写入` |
| `rndrw` | `随机读写混合` | `综合业务场景` |

### 4.5 结果解析


**典型输出结果**：
```
File operations:
    reads/s:                      1200.50
    writes/s:                     800.33
    fsyncs/s:                     25.67

Throughput:
    read, MiB/s:                  18.76
    written, MiB/s:               12.51
```

**结果含义**：
- **reads/s**：每秒读操作次数
- **writes/s**：每秒写操作次数
- **Throughput**：数据传输速率

---

## 5. 🗂️ iozone文件系统测试


### 5.1 iozone工具特点


**iozone的独特之处**：iozone是专门针对**文件系统性能**的测试工具，可以测试不同文件大小和记录大小组合下的性能表现。

```
iozone的测试思路：
用不同大小的文件 + 不同大小的数据块
全方位测试文件系统性能
```

### 5.2 iozone安装


```bash
# 下载源码编译安装
wget http://www.iozone.org/src/current/iozone3_490.tar
tar -xf iozone3_490.tar
cd iozone3_490/src/current/
make linux
sudo cp iozone /usr/local/bin/
```

### 5.3 基本测试命令


**全面性能测试**：
```bash
iozone -a -s 1G -f /tmp/iozone_test
```

**参数说明**：
- `-a`：自动测试模式，测试所有操作类型
- `-s 1G`：测试文件大小为1GB
- `-f /tmp/iozone_test`：指定测试文件位置

### 5.4 iozone测试项目


**iozone测试的操作类型**：

| 操作类型 | **含义** | **实际场景** |
|---------|----------|-------------|
| **write** | `初始写入` | `创建新文件` |
| **rewrite** | `重写数据` | `修改现有文件` |
| **read** | `顺序读取` | `文件浏览` |
| **reread** | `重复读取` | `缓存命中场景` |
| **random read** | `随机读取` | `数据库查询` |
| **random write** | `随机写入` | `数据库更新` |

---

## 6. 📈 顺序读写性能测试


### 6.1 什么是顺序I/O


**顺序I/O特点**：数据按照连续的地址顺序进行读写，就像**从头到尾阅读一本书**。

```
顺序读写示意图：
磁盘扇区：[1][2][3][4][5][6][7][8]
读取顺序： 1→2→3→4→5→6→7→8

优点：磁头移动少，速度快
适合：大文件传输、视频播放
```

### 6.2 顺序读测试方法


**使用fio进行顺序读测试**：
```bash
fio --name=seq-read \
    --rw=read \
    --bs=1M \
    --size=2G \
    --direct=1 \
    --filename=/tmp/testfile
```

**关键参数解释**：
- `--rw=read`：纯读取模式
- `--bs=1M`：使用1MB块大小（大块适合顺序操作）
- `--direct=1`：绕过文件系统缓存

### 6.3 顺序写测试方法


**顺序写性能测试**：
```bash
fio --name=seq-write \
    --rw=write \
    --bs=1M \
    --size=2G \
    --direct=1 \
    --filename=/tmp/testfile
```

### 6.4 测试结果分析


**顺序I/O性能特征**：

| 存储类型 | **顺序读速度** | **顺序写速度** | **特点** |
|---------|---------------|---------------|----------|
| **机械硬盘** | `100-200 MB/s` | `80-150 MB/s` | `受转速影响` |
| **SATA SSD** | `500-600 MB/s` | `400-500 MB/s` | `SATA接口限制` |
| **NVMe SSD** | `3000+ MB/s` | `2000+ MB/s` | `高速PCIe接口` |

---

## 7. 🎲 随机I/O性能测试


### 7.1 什么是随机I/O


**随机I/O特点**：数据访问位置**不连续、跳跃式**，就像在字典中查找不同的词汇。

```
随机读写示意图：
磁盘扇区：[1][2][3][4][5][6][7][8]
访问顺序： 3→1→7→2→5→8→4→6

特点：磁头需要频繁移动
适合：数据库操作、小文件访问
```

### 7.2 随机读IOPS测试


**4K随机读测试**：
```bash
fio --name=4k-rand-read \
    --rw=randread \
    --bs=4k \
    --iodepth=32 \
    --size=1G \
    --runtime=60 \
    --direct=1 \
    --filename=/tmp/testfile
```

**为什么用4K块大小**：
- **数据库页面大小**：多数数据库使用4K页面
- **文件系统块大小**：常见的文件系统块大小
- **真实应用场景**：模拟实际应用的I/O模式

### 7.3 随机写IOPS测试


**4K随机写测试**：
```bash
fio --name=4k-rand-write \
    --rw=randwrite \
    --bs=4k \
    --iodepth=32 \
    --size=1G \
    --runtime=60 \
    --direct=1 \
    --filename=/tmp/testfile
```

### 7.4 队列深度的影响


**不同队列深度测试对比**：
```bash
# 队列深度1（同步I/O）
fio --name=qd1 --rw=randread --bs=4k --iodepth=1 --runtime=30 --filename=/tmp/test

# 队列深度32（异步I/O）  
fio --name=qd32 --rw=randread --bs=4k --iodepth=32 --runtime=30 --filename=/tmp/test
```

**队列深度影响**：
```
队列深度 = 1：  ●-----------○  一个请求完成后再发下一个
队列深度 = 32： ●●●●●●●●●-○  同时处理多个请求

结果：队列深度越大，IOPS通常越高（到一定程度后趋于平缓）
```

---

## 8. 🔄 混合读写负载测试


### 8.1 混合负载的实际意义


**为什么要测试混合负载**：真实应用环境中，**很少有纯读或纯写**的场景，大多数应用都是读写混合的。

```
实际应用场景：
- Web服务器：读取网页文件 + 写入日志
- 数据库：查询数据 + 插入/更新记录  
- 文件服务器：下载文件 + 上传文件
```

### 8.2 读写比例配置


**常见读写比例测试**：

| 读写比例 | **应用场景** | **fio参数** |
|---------|-------------|------------|
| `70:30` | `Web应用` | `--rwmixread=70` |
| `80:20` | `OLTP数据库` | `--rwmixread=80` |
| `50:50` | `通用负载` | `--rwmixread=50` |
| `90:10` | `读密集应用` | `--rwmixread=90` |

### 8.3 混合负载测试示例


**70%读30%写混合测试**：
```bash
fio --name=mixed-70-30 \
    --rw=randrw \
    --rwmixread=70 \
    --bs=4k \
    --iodepth=16 \
    --size=1G \
    --runtime=60 \
    --direct=1 \
    --filename=/tmp/testfile
```

### 8.4 结果分析技巧


**混合负载结果示例**：
```
read: IOPS=8500, BW=33.2MiB/s
write: IOPS=3600, BW=14.1MiB/s
```

**分析要点**：
- **读写IOPS比例**：是否符合设定的70:30比例
- **总体性能**：混合负载下的综合性能表现
- **延迟分布**：读写操作的响应时间分布

---

## 9. ⚙️ I/O队列深度优化测试


### 9.1 什么是I/O队列深度


**队列深度概念**：指**同时提交给存储设备的I/O请求数量**，类似餐厅同时处理多少个订单。

```
队列深度示意图：

队列深度=1：
应用 → [请求1] → 存储设备
       等待完成...

队列深度=8：  
应用 → [请求1][请求2][请求3]...[请求8] → 存储设备
       并行处理多个请求
```

### 9.2 队列深度与性能关系


**不同队列深度的影响**：

| 队列深度 | **IOPS表现** | **延迟特点** | **适用场景** |
|---------|-------------|-------------|-------------|
| `1-4` | `较低` | `延迟最低` | `延迟敏感应用` |
| `8-16` | `中等` | `延迟适中` | `一般业务负载` |
| `32-64` | `较高` | `延迟增加` | `吞吐量优先场景` |
| `128+` | `趋于饱和` | `延迟很高` | `批量处理作业` |

### 9.3 队列深度测试脚本


**自动测试不同队列深度**：
```bash
#!/bin/bash
# 测试不同队列深度的性能

for qd in 1 2 4 8 16 32 64 128; do
    echo "测试队列深度: $qd"
    fio --name=qd_test_$qd \
        --rw=randread \
        --bs=4k \
        --iodepth=$qd \
        --size=1G \
        --runtime=30 \
        --direct=1 \
        --filename=/tmp/testfile \
        --output=qd_${qd}_result.txt
done
```

### 9.4 最优队列深度确定


**寻找最优队列深度的方法**：

1. **📊 绘制性能曲线**：IOPS vs 队列深度
2. **⏱️ 监控延迟变化**：延迟 vs 队列深度  
3. **🎯 确定平衡点**：性能收益与延迟代价的平衡

**判断原则**：
```
最优队列深度 = IOPS提升显著 + 延迟仍可接受

典型表现：
- 机械硬盘：队列深度2-8
- SATA SSD：队列深度16-32  
- NVMe SSD：队列深度32-64
```

---

## 10. 📋 核心要点总结


### 10.1 必须掌握的核心概念


```
🔸 I/O性能测试：测量存储设备读写数据的速度和能力
🔸 关键指标：IOPS（随机性能）、吞吐量（顺序性能）、延迟（响应速度）
🔸 测试类型：顺序I/O（大文件）vs 随机I/O（数据库场景）
🔸 队列深度：同时进行的I/O操作数量，影响并发性能
🔸 测试工具：fio（全功能）、dd（基础）、sysbench（数据库场景）
```

### 10.2 工具选择指南


**根据需求选择测试工具**：

| 测试需求 | **推荐工具** | **理由** |
|---------|-------------|----------|
| **全面性能评估** | `fio` | `功能最强大，参数最灵活` |
| **快速基础测试** | `dd` | `系统自带，使用简单` |
| **数据库场景** | `sysbench` | `模拟真实数据库负载` |
| **文件系统对比** | `iozone` | `多种文件大小组合测试` |

### 10.3 测试最佳实践


**📋 测试前准备清单**：
- [x] 确保有足够的磁盘空间
- [x] 选择合适的测试文件位置  
- [x] 了解当前系统负载情况
- [x] 准备测试结果记录表格

**⚠️ 重要注意事项**：
- **数据安全**：使用测试文件，不要在生产数据上测试
- **系统负载**：测试期间避免其他高I/O操作
- **多次测试**：进行多轮测试取平均值
- **参数记录**：详细记录测试参数便于复现

### 10.4 实际应用场景


**🎯 业务场景对应的测试重点**：

```
Web服务器优化：
重点测试：顺序读性能 + 4K随机读
原因：网页文件读取 + 日志文件写入

数据库服务器：  
重点测试：4K随机读写 + 混合负载
原因：数据库页面访问模式

文件服务器：
重点测试：大块顺序读写
原因：文件上传下载场景

虚拟化环境：
重点测试：小块随机I/O + 高队列深度
原因：多虚拟机并发访问
```

### 10.5 性能调优方向


**基于测试结果的优化建议**：

- **📈 IOPS不足**：考虑使用SSD、增加磁盘数量、优化应用I/O模式
- **🚀 吞吐量不够**：检查存储接口带宽、优化块大小、使用RAID
- **⏰ 延迟过高**：降低队列深度、使用更快的存储介质、优化文件系统
- **🔧 混合负载差**：平衡读写缓存、调整文件系统参数、考虑存储分层

**核心记忆口诀**：
- I/O测试测速度，IOPS吞吐延迟三指标
- fio功能最全面，dd简单快速用
- 顺序随机要分清，队列深度影响大
- 安全第一别忘记，多测几次结果准