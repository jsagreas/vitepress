---
title: 4ã€Filebeatæ—¥å¿—æ”¶é›†å™¨
---
## ğŸ“š ç›®å½•

1. [FilebeatåŸºç¡€æ¦‚å¿µ](#1-filebeatåŸºç¡€æ¦‚å¿µ)
2. [Filebeatå®‰è£…ä¸é…ç½®](#2-filebeatå®‰è£…ä¸é…ç½®)
3. [æ—¥å¿—æ–‡ä»¶ç›‘æ§ä¸é‡‡é›†](#3-æ—¥å¿—æ–‡ä»¶ç›‘æ§ä¸é‡‡é›†)
4. [multilineå¤šè¡Œæ—¥å¿—å¤„ç†](#4-multilineå¤šè¡Œæ—¥å¿—å¤„ç†)
5. [æ—¥å¿—æ–‡ä»¶è½®è½¬å¤„ç†æœºåˆ¶](#5-æ—¥å¿—æ–‡ä»¶è½®è½¬å¤„ç†æœºåˆ¶)
6. [ç½‘ç»œä¼ è¾“ä¸èƒŒå‹æ§åˆ¶](#6-ç½‘ç»œä¼ è¾“ä¸èƒŒå‹æ§åˆ¶)
7. [è¾“å‡ºåˆ°Elasticsearché…ç½®](#7-è¾“å‡ºåˆ°elasticsearché…ç½®)
8. [è¾“å‡ºåˆ°Logstashé…ç½®](#8-è¾“å‡ºåˆ°logstashé…ç½®)
9. [æ€§èƒ½è°ƒä¼˜ä¸èµ„æºæ§åˆ¶](#9-æ€§èƒ½è°ƒä¼˜ä¸èµ„æºæ§åˆ¶)
10. [å®æˆ˜æ¡ˆä¾‹ä¸æœ€ä½³å®è·µ](#10-å®æˆ˜æ¡ˆä¾‹ä¸æœ€ä½³å®è·µ)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” FilebeatåŸºç¡€æ¦‚å¿µ


### 1.1 ä»€ä¹ˆæ˜¯Filebeat


**ğŸ”¸ åŸºæœ¬å®šä¹‰**
```
Filebeatæ˜¯ä»€ä¹ˆï¼š
Elasticå…¬å¸å¼€å‘çš„è½»é‡çº§æ—¥å¿—é‡‡é›†å™¨ï¼Œä¸“é—¨ç”¨äºè½¬å‘å’Œé›†ä¸­åŒ–æ—¥å¿—æ•°æ®

ä¸»è¦ä½œç”¨ï¼š
- ç›‘æ§æ—¥å¿—æ–‡ä»¶æˆ–ä½ç½®
- æ”¶é›†æ—¥å¿—äº‹ä»¶
- è½¬å‘æ•°æ®åˆ°Elasticsearchæˆ–Logstash

ä¸ºä»€ä¹ˆå«"Beat"ï¼š
- Beatç³»åˆ—æ˜¯Elasticçš„æ•°æ®é‡‡é›†å™¨å®¶æ—
- Filebeatä¸“é—¨å¤„ç†æ–‡ä»¶æ—¥å¿—
- å…¶ä»–Beatï¼šMetricbeat(æŒ‡æ ‡)ã€Packetbeat(ç½‘ç»œ)ç­‰
```

**ğŸ’¡ Filebeatåœ¨ELKä¸­çš„ä½ç½®**
```
æ—¥å¿—å¤„ç†æµç¨‹ï¼š

æ–¹æ¡ˆ1ï¼šç›´æ¥å‘é€åˆ°Elasticsearch
åº”ç”¨æœåŠ¡å™¨ â†’ Filebeat â†’ Elasticsearch â†’ Kibana

æ–¹æ¡ˆ2ï¼šé€šè¿‡Logstashå¤„ç†
åº”ç”¨æœåŠ¡å™¨ â†’ Filebeat â†’ Logstash â†’ Elasticsearch â†’ Kibana

Filebeatçš„ä¼˜åŠ¿ï¼š
- è½»é‡çº§ï¼šå ç”¨èµ„æºå°‘ï¼Œä¸ä¼šå½±å“åº”ç”¨æ€§èƒ½
- å¯é æ€§ï¼šå†…ç½®èƒŒå‹å¤„ç†ï¼Œä¿è¯æ—¥å¿—ä¸ä¸¢å¤±
- ç®€å•æ€§ï¼šé…ç½®ç®€å•ï¼Œå¼€ç®±å³ç”¨
```

### 1.2 Filebeatæ ¸å¿ƒç»„ä»¶


**ğŸ”§ å†…éƒ¨æ¶æ„è§£æ**
```
Filebeatå†…éƒ¨ç»„ä»¶ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Inputæ¨¡å—     â”‚    â”‚   Processing    â”‚    â”‚   Outputæ¨¡å—    â”‚
â”‚                 â”‚    â”‚   å¤„ç†æ¨¡å—      â”‚    â”‚                 â”‚
â”‚ â€¢ æ–‡ä»¶ç›‘æ§      â”‚â”€â”€â†’ â”‚ â€¢ å­—æ®µæ·»åŠ       â”‚â”€â”€â†’ â”‚ â€¢ Elasticsearch â”‚
â”‚ â€¢ æ—¥å¿—è¯»å–      â”‚    â”‚ â€¢ è¿‡æ»¤å¤„ç†      â”‚    â”‚ â€¢ Logstash      â”‚
â”‚ â€¢ çŠ¶æ€è·Ÿè¸ª      â”‚    â”‚ â€¢ æ ¼å¼è½¬æ¢      â”‚    â”‚ â€¢ Kafka         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†‘                       â†‘                       â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Registry       â”‚    â”‚   Queueæ¨¡å—     â”‚    â”‚  Publisher      â”‚
â”‚  æ³¨å†Œè¡¨         â”‚    â”‚   é˜Ÿåˆ—ç¼“å­˜      â”‚    â”‚  å‘å¸ƒå™¨         â”‚
â”‚ â€¢ æ–‡ä»¶åç§»é‡    â”‚    â”‚ â€¢ å†…å­˜é˜Ÿåˆ—      â”‚    â”‚ â€¢ é‡è¯•æœºåˆ¶      â”‚
â”‚ â€¢ å¤„ç†çŠ¶æ€      â”‚    â”‚ â€¢ ç£ç›˜é˜Ÿåˆ—      â”‚    â”‚ â€¢ è´Ÿè½½å‡è¡¡      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 Filebeatå·¥ä½œåŸç†


**âš¡ æ•°æ®æµè½¬è¿‡ç¨‹**
```
è¯¦ç»†å·¥ä½œæµç¨‹ï¼š

1. æ–‡ä»¶å‘ç°å’Œç›‘æ§
   - æ‰«æé…ç½®çš„è·¯å¾„
   - è¯†åˆ«æ–°æ–‡ä»¶å’Œå˜åŒ–
   - å»ºç«‹æ–‡ä»¶ç›‘æ§

2. æ—¥å¿—è¯»å–å’Œè§£æ  
   - æŒ‰è¡Œè¯»å–æ—¥å¿—å†…å®¹
   - å¤„ç†å¤šè¡Œæ—¥å¿—åˆå¹¶
   - æ·»åŠ å…ƒæ•°æ®ä¿¡æ¯

3. æ•°æ®å¤„ç†å’Œè¿‡æ»¤
   - å­—æ®µè§£æå’Œæ·»åŠ 
   - åº”ç”¨è¿‡æ»¤è§„åˆ™
   - æ ¼å¼è½¬æ¢

4. ç¼“å­˜å’Œé˜Ÿåˆ—ç®¡ç†
   - æ•°æ®æš‚å­˜åœ¨é˜Ÿåˆ—ä¸­
   - æ‰¹é‡å¤„ç†æé«˜æ•ˆç‡
   - èƒŒå‹æ§åˆ¶é˜²æ­¢ä¸¢å¤±

5. è¾“å‡ºå’Œä¼ è¾“
   - å‘é€åˆ°ç›®æ ‡ç³»ç»Ÿ
   - å¤„ç†ç½‘ç»œé‡è¯•
   - ç¡®è®¤å’ŒçŠ¶æ€æ›´æ–°
```

---

## 2. ğŸ“¦ Filebeatå®‰è£…ä¸é…ç½®


### 2.1 ç³»ç»Ÿè¦æ±‚å’Œå®‰è£…æ–¹å¼


**ğŸ”¸ ç¯å¢ƒè¦æ±‚**
```
ç³»ç»Ÿæ”¯æŒï¼š
- Linux (æ¨è)ï¼šCentOS 7+ã€Ubuntu 18.04+
- Windowsï¼šWindows Server 2016+
- macOSï¼š10.14+

ç¡¬ä»¶è¦æ±‚ï¼š
- CPUï¼š1æ ¸å¿ƒä»¥ä¸Š
- å†…å­˜ï¼š128MBä»¥ä¸Š (å»ºè®®512MB)
- ç£ç›˜ï¼š50MBå®‰è£…ç©ºé—´ + æ—¥å¿—ç¼“å­˜ç©ºé—´
- ç½‘ç»œï¼šèƒ½è®¿é—®Elasticsearchæˆ–Logstash
```

### 2.2 Ubuntu/Debianå®‰è£…


**ğŸ“¦ ä½¿ç”¨å®˜æ–¹ä»“åº“å®‰è£…**
```bash
# 1. æ·»åŠ Elasticå®˜æ–¹GPGå¯†é’¥
wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add -

# 2. æ·»åŠ Elasticä»“åº“
echo "deb https://artifacts.elastic.co/packages/8.x/apt stable main" | sudo tee /etc/apt/sources.list.d/elastic-8.x.list

# 3. æ›´æ–°åŒ…åˆ—è¡¨å¹¶å®‰è£…
sudo apt update
sudo apt install filebeat

# 4. å¯ç”¨å¹¶å¯åŠ¨æœåŠ¡
sudo systemctl enable filebeat
sudo systemctl start filebeat

# 5. éªŒè¯å®‰è£…
filebeat version
sudo systemctl status filebeat
```

### 2.3 CentOS/RHELå®‰è£…


**ğŸ“¦ ä½¿ç”¨yum/dnfå®‰è£…**
```bash
# 1. æ·»åŠ Elasticä»“åº“
sudo rpm --import https://artifacts.elastic.co/GPG-KEY-elasticsearch

# 2. åˆ›å»ºä»“åº“é…ç½®æ–‡ä»¶
cat > /etc/yum.repos.d/elastic.repo << 'EOF'
[elastic-8.x]
name=Elastic repository for 8.x packages
baseurl=https://artifacts.elastic.co/packages/8.x/yum
gpgcheck=1
gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch
enabled=1
autorefresh=1
type=rpm-md
EOF

# 3. å®‰è£…Filebeat
sudo yum install filebeat
# æˆ–è€…åœ¨æ–°ç‰ˆæœ¬ç³»ç»Ÿä½¿ç”¨ï¼š
sudo dnf install filebeat

# 4. å¯ç”¨æœåŠ¡
sudo systemctl enable filebeat
sudo systemctl start filebeat
```

### 2.4 åŸºç¡€é…ç½®æ–‡ä»¶ç»“æ„


**ğŸ“ é…ç½®æ–‡ä»¶è¯¦è§£**
```yaml
# /etc/filebeat/filebeat.yml
# Filebeatä¸»é…ç½®æ–‡ä»¶

#=========================== Filebeat inputs =============================
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/*.log

#============================= Filebeat modules ===============================
filebeat.config.modules:
  path: ${path.config}/modules.d/*.yml
  reload.enabled: false

#==================== Elasticsearch Template Settings =======================
setup.template.settings:
  index.number_of_shards: 1

#============================== Dashboards =====================================
setup.dashboards.enabled: true

#============================== Kibana =====================================
setup.kibana:
  host: "localhost:5601"

#-------------------------- Elasticsearch Output ----------------------------
output.elasticsearch:
  hosts: ["localhost:9200"]

#================================ Processors =====================================
processors:
  - add_host_metadata:
      when.not.contains.tags: forwarded

#================================ Logging =====================================
logging.level: info
logging.to_files: true
logging.files:
  path: /var/log/filebeat
  name: filebeat
  keepfiles: 7
  permissions: 0644
```

---

## 3. ğŸ“‚ æ—¥å¿—æ–‡ä»¶ç›‘æ§ä¸é‡‡é›†


### 3.1 åŸºæœ¬æ–‡ä»¶ç›‘æ§é…ç½®


**ğŸ” å•ä¸ªæ–‡ä»¶ç›‘æ§**
```yaml
# ç›‘æ§å•ä¸ªæ—¥å¿—æ–‡ä»¶
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/apache2/access.log
  fields:
    logtype: apache_access
    environment: production
  fields_under_root: true
```

**ğŸ” å¤šæ–‡ä»¶å’Œé€šé…ç¬¦ç›‘æ§**
```yaml
# ä½¿ç”¨é€šé…ç¬¦ç›‘æ§å¤šä¸ªæ–‡ä»¶
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/apache2/*.log
    - /var/log/nginx/*.log
    - /app/logs/**/*.log  # é€’å½’åŒ¹é…æ‰€æœ‰å­ç›®å½•
  exclude_files: ['\.gz$', '\.zip$']  # æ’é™¤å‹ç¼©æ–‡ä»¶
  
  # æ·»åŠ è‡ªå®šä¹‰å­—æ®µ
  fields:
    service: web_server
    datacenter: dc1
  fields_under_root: true
```

### 3.2 é«˜çº§æ–‡ä»¶ç›‘æ§é€‰é¡¹


**âš™ï¸ æ–‡ä»¶ç›‘æ§å‚æ•°è¯¦è§£**
```yaml
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/app/*.log
  
  # æ–‡ä»¶è¯»å–æ§åˆ¶
  scan_frequency: 10s        # æ‰«ææ–°æ–‡ä»¶é¢‘ç‡
  harvester_buffer_size: 16384  # è¯»å–ç¼“å†²åŒºå¤§å°
  max_bytes: 10485760       # å•è¡Œæœ€å¤§å­—èŠ‚æ•° (10MB)
  
  # æ–‡ä»¶çŠ¶æ€ç®¡ç†
  ignore_older: 24h         # å¿½ç•¥24å°æ—¶å‰çš„æ–‡ä»¶
  close_inactive: 5m        # 5åˆ†é’Ÿæ— æ´»åŠ¨åå…³é—­æ–‡ä»¶
  close_removed: true       # æ–‡ä»¶è¢«åˆ é™¤åå…³é—­
  close_renamed: false      # æ–‡ä»¶é‡å‘½ååæ˜¯å¦å…³é—­
  
  # æ–‡ä»¶åŒ…å«/æ’é™¤
  include_lines: ['^ERROR', '^WARN']  # åªåŒ…å«ERRORå’ŒWARNè¡Œ
  exclude_lines: ['^DEBUG']           # æ’é™¤DEBUGè¡Œ
  exclude_files: ['\.tmp$']           # æ’é™¤ä¸´æ—¶æ–‡ä»¶
```

### 3.3 JSONæ—¥å¿—å¤„ç†


**ğŸ“„ JSONæ ¼å¼æ—¥å¿—é…ç½®**
```yaml
# å¤„ç†JSONæ ¼å¼çš„æ—¥å¿—
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/app/json.log
  
  # JSONè§£æé…ç½®
  json.keys_under_root: true    # JSONå­—æ®µæ”¾åœ¨æ ¹çº§åˆ«
  json.add_error_key: true      # æ·»åŠ JSONè§£æé”™è¯¯å­—æ®µ
  json.message_key: msg         # æŒ‡å®šæ¶ˆæ¯å­—æ®µå
  
  # ç¤ºä¾‹JSONæ—¥å¿—æ ¼å¼ï¼š
  # {"timestamp":"2023-09-15T10:30:00Z","level":"INFO","msg":"ç”¨æˆ·ç™»å½•","user_id":123}
```

### 3.4 å®¹å™¨æ—¥å¿—ç›‘æ§


**ğŸ³ Dockerå®¹å™¨æ—¥å¿—é…ç½®**
```yaml
# ç›‘æ§Dockerå®¹å™¨æ—¥å¿—
filebeat.inputs:
- type: container
  enabled: true
  paths:
    - '/var/lib/docker/containers/*/*.log'
  
  # å®¹å™¨å…ƒæ•°æ®å¤„ç†
  processors:
  - add_docker_metadata:
      host: "unix:///var/run/docker.sock"
      match_fields: ["container.id"]
      
  # æ ¹æ®å®¹å™¨æ ‡ç­¾è¿‡æ»¤
  condition:
    contains:
      container.labels.logging: "enabled"
```

---

## 4. ğŸ“ multilineå¤šè¡Œæ—¥å¿—å¤„ç†


### 4.1 å¤šè¡Œæ—¥å¿—çš„æŒ‘æˆ˜


**â“ ä¸ºä»€ä¹ˆéœ€è¦å¤šè¡Œå¤„ç†**
```
å¸¸è§å¤šè¡Œæ—¥å¿—åœºæ™¯ï¼š

Javaå¼‚å¸¸å †æ ˆï¼š
2023-09-15 10:30:00 ERROR Exception in thread "main"
java.lang.NullPointerException: Cannot invoke method
    at com.example.MyClass.myMethod(MyClass.java:42)
    at com.example.Main.main(Main.java:15)

Pythonå¼‚å¸¸ï¼š
Traceback (most recent call last):
  File "script.py", line 10, in module
    result = divide(10, 0)
  File "script.py", line 5, in divide
    return a / b
ZeroDivisionError: division by zero

é—®é¢˜ï¼š
- é»˜è®¤æƒ…å†µä¸‹FilebeatæŒ‰è¡Œå¤„ç†
- å¼‚å¸¸ä¿¡æ¯ä¼šè¢«åˆ†å‰²æˆå¤šä¸ªäº‹ä»¶
- å¤±å»äº†å¼‚å¸¸çš„å®Œæ•´æ€§å’Œä¸Šä¸‹æ–‡
```

### 4.2 åŸºæœ¬å¤šè¡Œé…ç½®


**ğŸ”§ Javaå¼‚å¸¸å¤„ç†é…ç½®**
```yaml
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/java-app/*.log
  
  # å¤šè¡Œæ—¥å¿—é…ç½®
  multiline.type: pattern
  multiline.pattern: '^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}'  # æ—¶é—´æˆ³æ¨¡å¼
  multiline.negate: true         # ä¸åŒ¹é…æ¨¡å¼çš„è¡Œ
  multiline.match: after         # è¿½åŠ åˆ°å‰ä¸€è¡Œ
  multiline.max_lines: 500       # æœ€å¤§è¡Œæ•°é™åˆ¶
  multiline.timeout: 5s          # å¤šè¡Œè¶…æ—¶æ—¶é—´
  
  fields:
    logtype: java_application
```

### 4.3 ä¸åŒæ—¥å¿—æ ¼å¼çš„å¤šè¡Œé…ç½®


**ğŸ Pythonå¼‚å¸¸å¤„ç†**
```yaml
# Pythonåº”ç”¨æ—¥å¿—å¤šè¡Œé…ç½®
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/python-app/*.log
  
  multiline.type: pattern
  multiline.pattern: '^Traceback|^  File|^    |^\w+Error:'
  multiline.negate: false
  multiline.match: after
  multiline.max_lines: 100
```

**ğŸ“§ é‚®ä»¶æ—¥å¿—å¤„ç†**
```yaml
# é‚®ä»¶æœåŠ¡å™¨æ—¥å¿—å¤šè¡Œé…ç½®
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/mail.log
  
  multiline.type: pattern
  multiline.pattern: '^\w{3} \d{1,2} \d{2}:\d{2}:\d{2}'  # "Sep 15 10:30:00"æ ¼å¼
  multiline.negate: true
  multiline.match: after
  multiline.timeout: 3s
```

### 4.4 é«˜çº§å¤šè¡Œå¤„ç†


**ğŸ”„ å¤šç§æ¨¡å¼ç»„åˆ**
```yaml
# å¤æ‚æ—¥å¿—æ ¼å¼å¤„ç†
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/complex-app/*.log
  
  # ä½¿ç”¨processorsè¿›è¡Œæ›´å¤æ‚çš„å¤„ç†
  multiline.type: pattern
  multiline.pattern: '^\[\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\]'
  multiline.negate: true
  multiline.match: after
  
  # æ·»åŠ å¤„ç†å™¨
  processors:
  - script:
      lang: javascript
      source: >
        function process(event) {
          var message = event.Get("message");
          if (message.includes("STACK_TRACE_START")) {
            event.Put("log.level", "ERROR");
            event.Put("log.type", "exception");
          }
        }
```

---

## 5. ğŸ”„ æ—¥å¿—æ–‡ä»¶è½®è½¬å¤„ç†æœºåˆ¶


### 5.1 æ—¥å¿—è½®è½¬çš„æ¦‚å¿µ


**ğŸ”¸ ä»€ä¹ˆæ˜¯æ—¥å¿—è½®è½¬**
```
æ—¥å¿—è½®è½¬(Log Rotation)ï¼š
å®šæœŸå°†å½“å‰æ—¥å¿—æ–‡ä»¶é‡å‘½åæˆ–ç§»åŠ¨ï¼Œåˆ›å»ºæ–°çš„æ—¥å¿—æ–‡ä»¶

å¸¸è§è½®è½¬æ–¹å¼ï¼š
1. æŒ‰æ—¶é—´è½®è½¬ï¼šæ¯å¤©/æ¯å‘¨/æ¯æœˆåˆ›å»ºæ–°æ–‡ä»¶
2. æŒ‰å¤§å°è½®è½¬ï¼šæ–‡ä»¶è¾¾åˆ°ä¸€å®šå¤§å°åè½®è½¬
3. å‹ç¼©å½’æ¡£ï¼šæ—§æ–‡ä»¶å‹ç¼©èŠ‚çœç©ºé—´

ç¤ºä¾‹è½®è½¬è¿‡ç¨‹ï¼š
access.log (å½“å‰æ–‡ä»¶)
access.log.1 (æ˜¨å¤©çš„æ–‡ä»¶)  
access.log.2.gz (å‰å¤©çš„å‹ç¼©æ–‡ä»¶)
access.log.3.gz (æ›´æ—©çš„å‹ç¼©æ–‡ä»¶)
```

### 5.2 Filebeatè½®è½¬å¤„ç†æœºåˆ¶


**âš™ï¸ è‡ªåŠ¨è½®è½¬æ£€æµ‹**
```yaml
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/app/access.log
  
  # è½®è½¬ç›¸å…³é…ç½®
  scan_frequency: 10s          # æ‰«æé¢‘ç‡ï¼Œæ£€æµ‹æ–‡ä»¶å˜åŒ–
  close_renamed: true          # æ–‡ä»¶é‡å‘½ååå…³é—­å¥æŸ„
  close_removed: true          # æ–‡ä»¶åˆ é™¤åå…³é—­å¥æŸ„
  close_inactive: 5m           # æ— æ´»åŠ¨æ—¶å…³é—­å¥æŸ„
  
  # è½®è½¬åçš„æ–‡ä»¶å¤„ç†
  ignore_older: 72h            # å¿½ç•¥72å°æ—¶å‰çš„æ–‡ä»¶
  
  # æ–‡ä»¶IDè·Ÿè¸ªï¼ˆé˜²æ­¢é‡å¤å¤„ç†ï¼‰
  file_identity.native: ~      # ä½¿ç”¨æ–‡ä»¶inodeè·Ÿè¸ª
```

### 5.3 å¤„ç†è½®è½¬åçš„å‹ç¼©æ–‡ä»¶


**ğŸ“¦ å‹ç¼©æ–‡ä»¶ç›‘æ§**
```yaml
# åŒæ—¶ç›‘æ§å½“å‰å’Œè½®è½¬åçš„æ–‡ä»¶
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/app/access.log      # å½“å‰æ–‡ä»¶
    - /var/log/app/access.log.*    # è½®è½¬åçš„æ–‡ä»¶
  
  # æ’é™¤å‹ç¼©æ–‡ä»¶ï¼ˆç”±äºæ€§èƒ½è€ƒè™‘ï¼‰
  exclude_files: ['\.gz$', '\.bz2$', '\.zip$']
  
  # æˆ–è€…åŒ…å«å‹ç¼©æ–‡ä»¶ï¼ˆéœ€è¦æ›´å¤šèµ„æºï¼‰
  # include_files: ['\.log$', '\.log\.\d+$', '\.log\..*\.gz$']
```

### 5.4 RegistryçŠ¶æ€ç®¡ç†


**ğŸ“Š æ–‡ä»¶çŠ¶æ€è·Ÿè¸ª**
```bash
# æŸ¥çœ‹Filebeatæ³¨å†Œè¡¨çŠ¶æ€
sudo cat /var/lib/filebeat/registry/filebeat/data.json

# æ³¨å†Œè¡¨åŒ…å«çš„ä¿¡æ¯ï¼š
{
  "v": 1,
  "op": "set",
  "id": "native::1234567-890123",  # æ–‡ä»¶å”¯ä¸€æ ‡è¯†
  "k": {
    "source": "/var/log/app/access.log",
    "offset": 1048576,              # å½“å‰è¯»å–ä½ç½®
    "timestamp": "2023-09-15T10:30:00Z",
    "ttl": 1800000000000,           # ç”Ÿå­˜æ—¶é—´
    "type": "log",
    "FileStateOS": {
      "inode": 1234567,             # æ–‡ä»¶inode
      "device": 890123              # è®¾å¤‡ID
    }
  }
}

# æ¸…ç†æ³¨å†Œè¡¨ï¼ˆè°¨æ…æ“ä½œï¼‰
sudo systemctl stop filebeat
sudo rm -rf /var/lib/filebeat/registry
sudo systemctl start filebeat
```

---

## 6. ğŸŒ ç½‘ç»œä¼ è¾“ä¸èƒŒå‹æ§åˆ¶


### 6.1 ç½‘ç»œä¼ è¾“æœºåˆ¶


**ğŸ”¸ ä¼ è¾“åè®®é€‰æ‹©**
```
Filebeatæ”¯æŒçš„ä¼ è¾“æ–¹å¼ï¼š

HTTP/HTTPSï¼š
- é€‚ç”¨äºï¼šElasticsearchã€Logstash HTTPè¾“å…¥
- ä¼˜ç‚¹ï¼šç®€å•ã€å¹¿æ³›æ”¯æŒã€ç©¿é€é˜²ç«å¢™å®¹æ˜“
- ç¼ºç‚¹ï¼šç›¸å¯¹å¼€é”€è¾ƒå¤§

Beats Protocolï¼š
- é€‚ç”¨äºï¼šLogstash Beatsè¾“å…¥
- ä¼˜ç‚¹ï¼šä¸“é—¨ä¼˜åŒ–ã€å‹ç¼©ä¼ è¾“ã€é«˜æ•ˆ
- ç¼ºç‚¹ï¼šä»…æ”¯æŒElasticç”Ÿæ€

TCPï¼š
- é€‚ç”¨äºï¼šè‡ªå®šä¹‰æ¥æ”¶ç«¯
- ä¼˜ç‚¹ï¼šå¯é ä¼ è¾“ã€è¿æ¥ä¿æŒ
- ç¼ºç‚¹ï¼šéœ€è¦è‡ªå·±å¤„ç†åè®®
```

### 6.2 èƒŒå‹æ§åˆ¶æœºåˆ¶


**âš¡ ä»€ä¹ˆæ˜¯èƒŒå‹**
```
èƒŒå‹(Back Pressure)åœºæ™¯ï¼š
æ—¥å¿—äº§ç”Ÿé€Ÿåº¦ > ç½‘ç»œä¼ è¾“é€Ÿåº¦ + ç›®æ ‡å¤„ç†é€Ÿåº¦

é—®é¢˜ç°è±¡ï¼š
- å†…å­˜ä½¿ç”¨æŒç»­ä¸Šå‡
- æ—¥å¿—å †ç§¯åœ¨é˜Ÿåˆ—ä¸­
- æœ€ç»ˆå¯èƒ½å¯¼è‡´OOMæˆ–æ•°æ®ä¸¢å¤±

Filebeatçš„èƒŒå‹å¤„ç†ï¼š
1. é˜Ÿåˆ—æ»¡æ—¶æš‚åœè¯»å–
2. ç›®æ ‡ç³»ç»Ÿå‹åŠ›å¤§æ—¶é™ä½å‘é€é€Ÿåº¦
3. ç½‘ç»œå¼‚å¸¸æ—¶å¯ç”¨é‡è¯•æœºåˆ¶
4. æœ€åæƒ…å†µä¸‹ä¿æŠ¤æ•°æ®ä¸ä¸¢å¤±
```

### 6.3 é˜Ÿåˆ—é…ç½®å’Œä¼˜åŒ–


**ğŸ“Š å†…å­˜é˜Ÿåˆ—é…ç½®**
```yaml
# é˜Ÿåˆ—é…ç½®
queue.mem:
  events: 4096              # é˜Ÿåˆ—äº‹ä»¶æ•°é‡
  flush.min_events: 512     # æœ€å°æ‰¹é‡å‘é€æ•°é‡
  flush.timeout: 1s         # æ‰¹é‡å‘é€è¶…æ—¶æ—¶é—´

# è¾“å‡ºæ‰¹é‡æ§åˆ¶
output.elasticsearch:
  hosts: ["localhost:9200"]
  worker: 2                 # å¹¶å‘å·¥ä½œçº¿ç¨‹æ•°
  bulk_max_size: 1600       # æ‰¹é‡å‘é€æœ€å¤§äº‹ä»¶æ•°
  flush_bytes: 10485760     # åˆ·æ–°ç¼“å†²åŒºå¤§å° (10MB)
  compression_level: 1      # å‹ç¼©çº§åˆ« (0-9)
```

### 6.4 ç½‘ç»œé‡è¯•å’Œè¶…æ—¶é…ç½®


**ğŸ”„ å¯é æ€§é…ç½®**
```yaml
output.elasticsearch:
  hosts: ["elasticsearch1:9200", "elasticsearch2:9200"]
  
  # è¿æ¥è®¾ç½®
  timeout: 90s              # è¯·æ±‚è¶…æ—¶æ—¶é—´
  max_retries: 3            # æœ€å¤§é‡è¯•æ¬¡æ•°
  backoff.init: 1s          # åˆå§‹é‡è¯•é—´éš”
  backoff.max: 60s          # æœ€å¤§é‡è¯•é—´éš”
  
  # è´Ÿè½½å‡è¡¡
  loadbalance: true         # å¯ç”¨è´Ÿè½½å‡è¡¡
  
  # è¿æ¥æ± 
  max_idle_conns: 3         # æœ€å¤§ç©ºé—²è¿æ¥æ•°
  max_idle_conns_per_host: 2 # æ¯ä¸»æœºæœ€å¤§ç©ºé—²è¿æ¥
```

---

## 7. ğŸ”Œ è¾“å‡ºåˆ°Elasticsearché…ç½®


### 7.1 åŸºæœ¬Elasticsearchè¾“å‡º


**ğŸ“¤ ç®€å•é…ç½®**
```yaml
# åŸºæœ¬Elasticsearchè¾“å‡ºé…ç½®
output.elasticsearch:
  hosts: ["localhost:9200"]
  protocol: "http"
  username: "elastic"
  password: "changeme"
  
  # ç´¢å¼•é…ç½®
  index: "filebeat-%{+yyyy.MM.dd}"
  template.enabled: true
  template.pattern: "filebeat-*"
```

### 7.2 é«˜çº§Elasticsearché…ç½®


**âš™ï¸ å®Œæ•´é…ç½®ç¤ºä¾‹**
```yaml
output.elasticsearch:
  hosts: 
    - "es-node1:9200"
    - "es-node2:9200" 
    - "es-node3:9200"
  
  # è®¤è¯é…ç½®
  username: "filebeat_user"
  password: "${ELASTICSEARCH_PASSWORD}"
  
  # SSL/TLSé…ç½®
  ssl.enabled: true
  ssl.certificate_authorities: ["/etc/ssl/certs/ca.crt"]
  ssl.certificate: "/etc/ssl/certs/client.crt"
  ssl.key: "/etc/ssl/private/client.key"
  
  # ç´¢å¼•ç®¡ç†
  index: "logs-%{[fields.environment]}-%{+yyyy.MM.dd}"
  indices:
    - index: "apache-access-%{+yyyy.MM.dd}"
      when.equals:
        fields.logtype: "apache_access"
    - index: "error-logs-%{+yyyy.MM.dd}"
      when.contains:
        message: "ERROR"
  
  # æ€§èƒ½ä¼˜åŒ–
  worker: 4
  bulk_max_size: 3200
  flush_bytes: 20971520    # 20MB
  compression_level: 3
  
  # æ¨¡æ¿é…ç½®
  template.enabled: true
  template.name: "filebeat-custom"
  template.pattern: "logs-*"
  template.settings:
    index.number_of_shards: 2
    index.number_of_replicas: 1
    index.refresh_interval: "30s"
```

### 7.3 åŠ¨æ€ç´¢å¼•åç§°


**ğŸ“‹ çµæ´»ç´¢å¼•ç­–ç•¥**
```yaml
# æ ¹æ®æ—¥å¿—å†…å®¹åŠ¨æ€åˆ›å»ºç´¢å¼•
output.elasticsearch:
  hosts: ["localhost:9200"]
  
  # ä½¿ç”¨å­—æ®µå€¼ä½œä¸ºç´¢å¼•å
  index: "%{[fields.service]}-%{+yyyy.MM.dd}"
  
  # æ¡ä»¶ç´¢å¼•æ˜ å°„
  indices:
    # åº”ç”¨æ—¥å¿—æŒ‰æœåŠ¡ååˆ†ç´¢å¼•
    - index: "app-%{[fields.service]}-%{+yyyy.MM.dd}"
      when.equals:
        fields.logtype: "application"
    
    # ç³»ç»Ÿæ—¥å¿—ç»Ÿä¸€ç´¢å¼•
    - index: "system-logs-%{+yyyy.MM.dd}"
      when.equals:
        fields.logtype: "system"
    
    # é”™è¯¯æ—¥å¿—å•ç‹¬ç´¢å¼•
    - index: "error-logs-%{+yyyy.MM.dd}"
      when.or:
        - contains:
            message: "ERROR"
        - contains:
            message: "FATAL"
        - contains:
            log.level: "error"
```

### 7.4 ILMç´¢å¼•ç”Ÿå‘½å‘¨æœŸç®¡ç†


**ğŸ”„ è‡ªåŠ¨ç´¢å¼•ç®¡ç†**
```yaml
# å¯ç”¨ç´¢å¼•ç”Ÿå‘½å‘¨æœŸç®¡ç†
output.elasticsearch:
  hosts: ["localhost:9200"]
  
  # ILMé…ç½®
  ilm.enabled: true
  ilm.rollover_alias: "filebeat-logs"
  ilm.pattern: "000001"
  ilm.policy: "filebeat-policy"
  
  # è‡ªå®šä¹‰ILMç­–ç•¥
setup.ilm.policy:
  phases:
    hot:
      actions:
        rollover:
          max_size: "5GB"
          max_age: "1d"
    warm:
      min_age: "7d"
      actions:
        allocate:
          number_of_replicas: 0
    cold:
      min_age: "30d"
      actions:
        allocate:
          number_of_replicas: 0
    delete:
      min_age: "90d"
```

---

## 8. ğŸ“¨ è¾“å‡ºåˆ°Logstashé…ç½®


### 8.1 åŸºæœ¬Logstashè¾“å‡º


**ğŸ”— ç®€å•é…ç½®**
```yaml
# åŸºæœ¬Logstashè¾“å‡ºé…ç½®
output.logstash:
  hosts: ["logstash:5044"]
  
# åŒæ—¶ç¦ç”¨Elasticsearchè¾“å‡º
output.elasticsearch:
  enabled: false
```

### 8.2 é«˜çº§Logstashé…ç½®


**âš™ï¸ å®Œæ•´é…ç½®ç¤ºä¾‹**
```yaml
output.logstash:
  hosts: 
    - "logstash1:5044"
    - "logstash2:5044"
    - "logstash3:5044"
  
  # è´Ÿè½½å‡è¡¡é…ç½®
  loadbalance: true
  worker: 2
  
  # å¯é æ€§é…ç½®
  compression_level: 3
  escape_html: false
  
  # SSL/TLSé…ç½®
  ssl.enabled: true
  ssl.certificate_authorities: ["/etc/ssl/certs/logstash-ca.crt"]
  ssl.certificate: "/etc/ssl/certs/filebeat.crt"
  ssl.key: "/etc/ssl/private/filebeat.key"
  ssl.verification_mode: "strict"
```

### 8.3 å¯¹åº”çš„Logstashé…ç½®


**ğŸ”§ Logstashæ¥æ”¶ç«¯é…ç½®**
```ruby
# Logstashé…ç½®æ–‡ä»¶ /etc/logstash/conf.d/beats-input.conf
input {
  beats {
    port => 5044
    
    # SSLé…ç½®ï¼ˆä¸Filebeatå¯¹åº”ï¼‰
    ssl => true
    ssl_certificate => "/etc/ssl/certs/logstash.crt"
    ssl_key => "/etc/ssl/private/logstash.key"
    ssl_certificate_authorities => ["/etc/ssl/certs/ca.crt"]
    ssl_verify_mode => "force_peer"
  }
}

filter {
  # æ ¹æ®Filebeatå‘é€çš„å­—æ®µè¿›è¡Œå¤„ç†
  if [fields][logtype] == "apache_access" {
    grok {
      match => { "message" => "%{APACHE_ACCESS}" }
    }
    
    date {
      match => [ "timestamp", "dd/MMM/yyyy:HH:mm:ss Z" ]
    }
  }
  
  if [fields][logtype] == "java_application" {
    # Javaæ—¥å¿—å¤„ç†
    grok {
      match => { "message" => "%{TIMESTAMP_ISO8601:timestamp} %{LOGLEVEL:level} %{GREEDYDATA:msg}" }
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "logstash-logs-%{+YYYY.MM.dd}"
  }
}
```

### 8.4 å¤šè¾“å‡ºé…ç½®


**ğŸ”€ åŒæ—¶è¾“å‡ºåˆ°å¤šä¸ªç›®æ ‡**
```yaml
# åŒæ—¶è¾“å‡ºåˆ°Logstashå’ŒElasticsearch
output.logstash:
  hosts: ["logstash:5044"]
  when.equals:
    fields.process_required: true

output.elasticsearch:
  hosts: ["elasticsearch:9200"]
  index: "direct-logs-%{+yyyy.MM.dd}"
  when.equals:
    fields.process_required: false

# æˆ–è€…ä½¿ç”¨æ¡ä»¶è¾“å‡º
output.logstash:
  hosts: ["logstash:5044"]
  when.or:
    - contains:
        message: "complex_format"
    - equals:
        fields.logtype: "application"

output.elasticsearch:
  hosts: ["elasticsearch:9200"]
  when.not.or:
    - contains:
        message: "complex_format"
    - equals:
        fields.logtype: "application"
```

---

## 9. âš¡ æ€§èƒ½è°ƒä¼˜ä¸èµ„æºæ§åˆ¶


### 9.1 CPUå’Œå†…å­˜ä¼˜åŒ–


**ğŸ”§ èµ„æºä½¿ç”¨æ§åˆ¶**
```yaml
# CPUç›¸å…³é…ç½®
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/*.log
  
  # æ–‡ä»¶è¯»å–ä¼˜åŒ–
  scan_frequency: 30s        # é™ä½æ‰«æé¢‘ç‡å‡å°‘CPUä½¿ç”¨
  harvester_buffer_size: 32768  # å¢åŠ ç¼“å†²åŒºå‡å°‘IOæ¬¡æ•°
  max_bytes: 1048576        # é™åˆ¶å•è¡Œå¤§å°é˜²æ­¢å†…å­˜æ¿€å¢

# å†…å­˜é˜Ÿåˆ—ä¼˜åŒ–
queue.mem:
  events: 2048              # æ ¹æ®å†…å­˜æƒ…å†µè°ƒæ•´é˜Ÿåˆ—å¤§å°
  flush.min_events: 256
  flush.timeout: 2s

# å…¨å±€èµ„æºé™åˆ¶
max_procs: 2                # é™åˆ¶ä½¿ç”¨çš„CPUæ ¸å¿ƒæ•°
```

### 9.2 ç½‘ç»œå’ŒIOä¼˜åŒ–


**ğŸ“¡ ä¼ è¾“æ€§èƒ½ä¼˜åŒ–**
```yaml
output.elasticsearch:
  hosts: ["localhost:9200"]
  
  # æ‰¹é‡ä¼ è¾“ä¼˜åŒ–
  worker: 4                 # å¢åŠ å·¥ä½œçº¿ç¨‹
  bulk_max_size: 5000       # å¢å¤§æ‰¹é‡å¤§å°
  flush_bytes: 52428800     # 50MBæ‰¹é‡åˆ·æ–°
  
  # è¿æ¥ä¼˜åŒ–
  timeout: 120s             # å¢åŠ è¶…æ—¶æ—¶é—´
  max_idle_conns: 10        # å¢åŠ è¿æ¥æ± å¤§å°
  
  # å‹ç¼©ä¼˜åŒ–
  compression_level: 6      # å¹³è¡¡å‹ç¼©ç‡å’ŒCPUä½¿ç”¨
  
# æ–‡ä»¶IOä¼˜åŒ–
filebeat.inputs:
- type: log
  paths:
    - /var/log/*.log
  close_inactive: 10m       # åŠæ—¶å…³é—­éæ´»è·ƒæ–‡ä»¶
  close_removed: true       # æ¸…ç†å·²åˆ é™¤æ–‡ä»¶çš„å¥æŸ„
```

### 9.3 ç³»ç»Ÿèµ„æºç›‘æ§


**ğŸ“Š ç›‘æ§Filebeatæ€§èƒ½**
```bash
# æŸ¥çœ‹Filebeatè¿›ç¨‹èµ„æºä½¿ç”¨
ps aux | grep filebeat
top -p $(pgrep filebeat)

# æŸ¥çœ‹å†…å­˜ä½¿ç”¨è¯¦æƒ…
cat /proc/$(pgrep filebeat)/status | grep -E "(VmPeak|VmSize|VmRSS)"

# æŸ¥çœ‹æ–‡ä»¶å¥æŸ„ä½¿ç”¨
lsof -p $(pgrep filebeat) | wc -l

# æŸ¥çœ‹ç½‘ç»œè¿æ¥
netstat -an | grep $(pgrep filebeat)

# Filebeatå†…ç½®ç›‘æ§API
curl http://localhost:5066/stats
# è¾“å‡ºåŒ…å«ï¼š
# - äº‹ä»¶å¤„ç†ç»Ÿè®¡
# - å†…å­˜ä½¿ç”¨æƒ…å†µ
# - æ–‡ä»¶å¥æŸ„æ•°é‡
# - ç½‘ç»œè¿æ¥çŠ¶æ€
```

### 9.4 æ€§èƒ½è°ƒä¼˜æœ€ä½³å®è·µ


**ğŸ’¡ ä¼˜åŒ–å»ºè®®**
```yaml
# ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/log/app/*.log
  
  # æ€§èƒ½ä¼˜åŒ–é…ç½®
  scan_frequency: 60s           # å‡å°‘æ‰«æé¢‘ç‡
  harvester_buffer_size: 65536  # 64KBç¼“å†²åŒº
  max_bytes: 10485760          # 10MBå•è¡Œé™åˆ¶
  close_inactive: 30m          # 30åˆ†é’Ÿåå…³é—­éæ´»è·ƒæ–‡ä»¶
  ignore_older: 24h            # å¿½ç•¥24å°æ—¶å‰çš„æ–‡ä»¶
  
  # å‡å°‘å­—æ®µå¤„ç†
  fields_under_root: false      # å­—æ®µæ”¾åœ¨fieldsä¸‹
  json.keys_under_root: false   # JSONå­—æ®µä¸å±•å¼€åˆ°æ ¹çº§

# é˜Ÿåˆ—ä¼˜åŒ–
queue.mem:
  events: 8192
  flush.min_events: 1024
  flush.timeout: 5s

# è¾“å‡ºä¼˜åŒ–
output.elasticsearch:
  hosts: ["es-cluster:9200"]
  worker: 6
  bulk_max_size: 3200
  flush_bytes: 33554432         # 32MB
  compression_level: 3
  timeout: 180s

# æ—¥å¿—çº§åˆ«è°ƒæ•´
logging.level: warning          # å‡å°‘æ—¥å¿—è¾“å‡º
logging.metrics.enabled: false  # ç¦ç”¨æŒ‡æ ‡æ—¥å¿—
```

---

## 10. ğŸ¯ å®æˆ˜æ¡ˆä¾‹ä¸æœ€ä½³å®è·µ


### 10.1 WebæœåŠ¡å™¨æ—¥å¿—æ”¶é›†


**ğŸŒ Apache/Nginxæ—¥å¿—é…ç½®**
```yaml
# WebæœåŠ¡å™¨æ—¥å¿—å®Œæ•´é…ç½®
filebeat.inputs:
# Apacheè®¿é—®æ—¥å¿—
- type: log
  enabled: true
  paths:
    - /var/log/apache2/access.log
    - /var/log/apache2/access.log.*
  exclude_files: ['\.gz$']
  
  fields:
    logtype: apache_access
    service: webserver
    environment: production
  fields_under_root: true
  
  # Apacheæ—¥å¿—æ ¼å¼å¤„ç†
  processors:
  - dissect:
      tokenizer: '%{client_ip} %{identity} %{auth} [%{timestamp}] "%{method} %{url} %{http_version}" %{response_code} %{response_size}'
      field: "message"
      target_prefix: "apache"

# Apacheé”™è¯¯æ—¥å¿—  
- type: log
  enabled: true
  paths:
    - /var/log/apache2/error.log
  
  # å¤šè¡Œé”™è¯¯å¤„ç†
  multiline.type: pattern
  multiline.pattern: '^\[[A-Za-z]'
  multiline.negate: true
  multiline.match: after
  
  fields:
    logtype: apache_error
    service: webserver
    severity: error
  fields_under_root: true

# Nginxè®¿é—®æ—¥å¿—
- type: log
  enabled: true
  paths:
    - /var/log/nginx/access.log
  
  # JSONæ ¼å¼çš„Nginxæ—¥å¿—
  json.keys_under_root: true
  json.add_error_key: true
  
  fields:
    logtype: nginx_access
    service: webserver
```

### 10.2 åº”ç”¨ç¨‹åºæ—¥å¿—æ”¶é›†


**ğŸ“± Javaåº”ç”¨æ—¥å¿—é…ç½®**
```yaml
# Java Spring Bootåº”ç”¨æ—¥å¿—
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /app/logs/application.log
    - /app/logs/spring.log
  
  # Spring Bootæ—¥å¿—å¤šè¡Œå¤„ç†
  multiline.type: pattern
  multiline.pattern: '^\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}:\d{2}\.\d{3}'
  multiline.negate: true
  multiline.match: after
  multiline.max_lines: 200
  
  # å­—æ®µè§£æ
  processors:
  - dissect:
      tokenizer: '%{timestamp} %{level} %{thread} --- [%{logger}] : %{message}'
      field: "message"
      target_prefix: "app"
  
  fields:
    application: myapp
    environment: production
    logtype: application
  fields_under_root: true

# æ•°æ®åº“æ—¥å¿—
- type: log
  enabled: true
  paths:
    - /var/log/mysql/mysql.log
    - /var/log/mysql/slow.log
  
  fields:
    service: database
    logtype: mysql
```

### 10.3 ç³»ç»Ÿæ—¥å¿—æ”¶é›†


**ğŸ–¥ï¸ ç³»ç»Ÿçº§æ—¥å¿—é…ç½®**
```yaml
# ç³»ç»Ÿæ—¥å¿—é…ç½®
filebeat.inputs:
# ç³»ç»Ÿæ¶ˆæ¯æ—¥å¿—
- type: log
  enabled: true
  paths:
    - /var/log/messages
    - /var/log/syslog
  
  fields:
    logtype: system
    category: messages
  fields_under_root: true

# è®¤è¯æ—¥å¿—
- type: log
  enabled: true
  paths:
    - /var/log/auth.log
    - /var/log/secure
  
  # å®‰å…¨æ—¥å¿—ç‰¹æ®Šå¤„ç†
  processors:
  - if:
      contains:
        message: "Failed password"
    then:
    - add_fields:
        fields:
          security_event: login_failure
          alert_level: high

  fields:
    logtype: security
    category: authentication
  fields_under_root: true

# å†…æ ¸æ—¥å¿—
- type: log
  enabled: true
  paths:
    - /var/log/kern.log
  
  fields:
    logtype: kernel
    category: system
```

### 10.4 å®¹å™¨åŒ–éƒ¨ç½²é…ç½®


**ğŸ³ Docker/Kubernetesç¯å¢ƒ**
```yaml
# Kubernetes Podä¸­çš„Filebeaté…ç½®
apiVersion: v1
kind: ConfigMap
metadata:
  name: filebeat-config
data:
  filebeat.yml: |
    filebeat.inputs:
    - type: container
      enabled: true
      paths:
        - /var/log/containers/*.log
      
      # å®¹å™¨æ—¥å¿—è§£æ
      processors:
      - add_kubernetes_metadata:
          host: ${NODE_NAME}
          matchers:
          - logs_path:
              logs_path: "/var/log/containers/"
      
      # æ ¹æ®å‘½åç©ºé—´è¿‡æ»¤
      condition:
        not:
          kubernetes.namespace: "kube-system"
    
    output.elasticsearch:
      hosts: ['${ELASTICSEARCH_HOST:elasticsearch}:${ELASTICSEARCH_PORT:9200}']
      index: "k8s-logs-%{+yyyy.MM.dd}"
    
    setup.template.name: "k8s-logs"
    setup.template.pattern: "k8s-logs-*"

---
# Filebeat DaemonSeté…ç½®
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: filebeat
spec:
  selector:
    matchLabels:
      name: filebeat
  template:
    metadata:
      labels:
        name: filebeat
    spec:
      containers:
      - name: filebeat
        image: docker.elastic.co/beats/filebeat:8.10.0
        volumeMounts:
        - name: config
          mountPath: /usr/share/filebeat/filebeat.yml
          subPath: filebeat.yml
        - name: varlibdockercontainers
          mountPath: /var/lib/docker/containers
          readOnly: true
        - name: varlog
          mountPath: /var/log
          readOnly: true
      volumes:
      - name: config
        configMap:
          name: filebeat-config
      - name: varlibdockercontainers
        hostPath:
          path: /var/lib/docker/containers
      - name: varlog
        hostPath:
          path: /var/log
```

---

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ”¸ Filebeatå®šä½ï¼šè½»é‡çº§æ—¥å¿—é‡‡é›†å™¨ï¼ŒELKæ¶æ„çš„æ•°æ®å…¥å£
ğŸ”¸ å·¥ä½œåŸç†ï¼šç›‘æ§æ–‡ä»¶â†’è¯»å–æ—¥å¿—â†’å¤„ç†æ•°æ®â†’å‘é€è¾“å‡º
ğŸ”¸ å¤šè¡Œå¤„ç†ï¼šä½¿ç”¨patternæ¨¡å¼åˆå¹¶ç›¸å…³çš„å¤šè¡Œæ—¥å¿—
ğŸ”¸ æ–‡ä»¶è½®è½¬ï¼šè‡ªåŠ¨å¤„ç†æ—¥å¿—æ–‡ä»¶çš„è½®è½¬å’Œé‡å‘½å
ğŸ”¸ èƒŒå‹æ§åˆ¶ï¼šåœ¨é«˜è´Ÿè½½æ—¶ä¿æŠ¤ç³»ç»Ÿå’Œä¿è¯æ•°æ®ä¸ä¸¢å¤±
```

### 11.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ Filebeatçš„ä¼˜åŠ¿å’Œé€‚ç”¨åœºæ™¯**
```
è½»é‡çº§ä¼˜åŠ¿ï¼š
- èµ„æºå ç”¨å°‘ï¼Œä¸å½±å“åº”ç”¨æ€§èƒ½
- å•ä¸€åŠŸèƒ½ä¸“æ³¨ï¼Œé…ç½®ç®€å•
- åŸç”Ÿæ”¯æŒElasticç”Ÿæ€ç³»ç»Ÿ

é€‚ç”¨åœºæ™¯ï¼š
- å¤§é‡æœåŠ¡å™¨çš„æ—¥å¿—æ”¶é›†
- å®¹å™¨åŒ–ç¯å¢ƒçš„æ—¥å¿—èšåˆ
- éœ€è¦å¯é ä¼ è¾“çš„åœºæ™¯
- é¢„å¤„ç†éœ€æ±‚ç®€å•çš„æƒ…å†µ
```

**ğŸ”¹ å¤šè¡Œæ—¥å¿—å¤„ç†çš„å…³é”®**
```
ç†è§£è¦ç‚¹ï¼š
- è¯†åˆ«æ—¥å¿—çš„å¼€å§‹æ ‡å¿—ï¼ˆæ—¶é—´æˆ³ã€ç‰¹å®šæ ¼å¼ï¼‰
- æ­£ç¡®è®¾ç½®patternã€negateã€matchå‚æ•°
- è®¾ç½®åˆç†çš„timeoutå’Œmax_lines
- è€ƒè™‘ä¸åŒåº”ç”¨çš„æ—¥å¿—æ ¼å¼å·®å¼‚

å¸¸è§é”™è¯¯ï¼š
- patternæ­£åˆ™è¡¨è¾¾å¼é”™è¯¯
- negateå‚æ•°è®¾ç½®ç›¸å
- è¶…æ—¶æ—¶é—´è®¾ç½®ä¸å½“
- æ²¡æœ‰è€ƒè™‘æ—¥å¿—æ ¼å¼å˜åŒ–
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–çš„å…³é”®å› ç´ **
```
å½±å“æ€§èƒ½çš„å› ç´ ï¼š
- æ–‡ä»¶æ‰«æé¢‘ç‡
- é˜Ÿåˆ—å¤§å°å’Œæ‰¹é‡è®¾ç½®
- ç½‘ç»œä¼ è¾“é…ç½®
- å¤„ç†å™¨ä½¿ç”¨æ•°é‡

ä¼˜åŒ–ç­–ç•¥ï¼š
- æ ¹æ®æ—¥å¿—é‡è°ƒæ•´æ‰«æé¢‘ç‡
- åˆç†è®¾ç½®æ‰¹é‡å¤§å°
- ä½¿ç”¨å‹ç¼©å‡å°‘ç½‘ç»œä¼ è¾“
- åŠæ—¶å…³é—­éæ´»è·ƒæ–‡ä»¶å¥æŸ„
```

### 11.3 å®é™…åº”ç”¨ä»·å€¼


**ğŸ’¡ åœ¨å®é™…é¡¹ç›®ä¸­çš„åº”ç”¨**
```
æ—¥å¿—é›†ä¸­åŒ–ï¼š
- ç»Ÿä¸€æ”¶é›†åˆ†å¸ƒå¼åº”ç”¨æ—¥å¿—
- æ ‡å‡†åŒ–æ—¥å¿—æ ¼å¼å’Œå­—æ®µ
- å®ç°æ—¥å¿—çš„å®æ—¶ç›‘æ§å’Œå‘Šè­¦

é—®é¢˜æ’æŸ¥ï¼š
- å¿«é€Ÿå®šä½åº”ç”¨å¼‚å¸¸å’Œé”™è¯¯
- è·Ÿè¸ªç”¨æˆ·è¯·æ±‚çš„å®Œæ•´é“¾è·¯
- åˆ†æç³»ç»Ÿæ€§èƒ½å’Œèµ„æºä½¿ç”¨

åˆè§„å®¡è®¡ï¼š
- æ”¶é›†å®‰å…¨ç›¸å…³æ—¥å¿—
- ä¿å­˜è®¿é—®å’Œæ“ä½œè®°å½•
- æ»¡è¶³åˆè§„æ€§è¦æ±‚
```

### 11.4 å¸¸è§é—®é¢˜å’Œè§£å†³æ€è·¯


```
é…ç½®é—®é¢˜è¯Šæ–­ï¼š
1. æ£€æŸ¥æ–‡ä»¶è·¯å¾„å’Œæƒé™
2. éªŒè¯å¤šè¡Œé…ç½®çš„æ­£ç¡®æ€§
3. ç¡®è®¤ç½‘ç»œè¿æ¥å’Œè®¤è¯
4. æŸ¥çœ‹Filebeatæ—¥å¿—é”™è¯¯ä¿¡æ¯

æ€§èƒ½é—®é¢˜æ’æŸ¥ï¼š
1. ç›‘æ§èµ„æºä½¿ç”¨æƒ…å†µ
2. æ£€æŸ¥é˜Ÿåˆ—å’Œæ‰¹é‡è®¾ç½®
3. åˆ†æç½‘ç»œä¼ è¾“æ•ˆç‡
4. ä¼˜åŒ–æ–‡ä»¶è¯»å–ç­–ç•¥

æ•°æ®ä¸¢å¤±é¢„é˜²ï¼š
1. é…ç½®åˆé€‚çš„èƒŒå‹æ§åˆ¶
2. è®¾ç½®å¯é çš„é‡è¯•æœºåˆ¶
3. ç›‘æ§RegistryçŠ¶æ€
4. å®æ–½æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- Filebeatæ˜¯æ—¥å¿—æ”¶é›†çš„ç¬¬ä¸€é“å…³å£ï¼Œé…ç½®çš„æ­£ç¡®æ€§ç›´æ¥å½±å“æ•´ä¸ªæ—¥å¿—ç³»ç»Ÿ
- å¤šè¡Œæ—¥å¿—å¤„ç†æ˜¯é…ç½®ä¸­çš„éš¾ç‚¹ï¼Œéœ€è¦æ·±å…¥ç†è§£æ—¥å¿—æ ¼å¼
- æ€§èƒ½è°ƒä¼˜éœ€è¦åœ¨èµ„æºæ¶ˆè€—å’Œå®æ—¶æ€§ä¹‹é—´æ‰¾åˆ°å¹³è¡¡
- åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¯é æ€§æ¯”æ€§èƒ½æ›´é‡è¦
- å®šæœŸç›‘æ§å’Œç»´æŠ¤æ˜¯ä¿è¯ç³»ç»Ÿç¨³å®šè¿è¡Œçš„å…³é”®