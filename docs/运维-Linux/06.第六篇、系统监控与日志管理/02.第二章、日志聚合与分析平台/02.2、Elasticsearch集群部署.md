---
title: 2、Elasticsearch集群部署
---
## 📚 目录

1. [Elasticsearch基础概念](#1-elasticsearch基础概念)
2. [安装与基础配置](#2-安装与基础配置)
3. [集群节点角色划分](#3-集群节点角色划分)
4. [核心配置参数详解](#4-核心配置参数详解)
5. [JVM堆内存调优](#5-jvm堆内存调优)
6. [集群发现与通信设置](#6-集群发现与通信设置)
7. [分片与副本策略](#7-分片与副本策略)
8. [索引模板与映射](#8-索引模板与映射)
9. [集群健康监控](#9-集群健康监控)
10. [核心要点总结](#10-核心要点总结)

---

## 1. 🔍 Elasticsearch基础概念


### 1.1 什么是Elasticsearch


> 💡 **通俗理解**：Elasticsearch（简称ES）就像一个超级强大的"搜索引擎数据库"

**🔸 本质定义**：
```
Elasticsearch = 分布式搜索引擎 + 数据分析平台
```

**核心特点**：
- **🔍 全文搜索**：可以像Google一样搜索文本内容
- **📊 数据分析**：支持复杂的数据统计和聚合
- **⚡ 近实时**：数据写入后几乎立即可以搜索
- **🌐 分布式**：可以部署在多台服务器上
- **📈 可扩展**：数据量增长时可以添加更多服务器

### 1.2 ES在ELK中的作用


```
日志处理流程图：
应用系统 → Logstash/Filebeat → Elasticsearch → Kibana → 用户

应用产生日志 → 收集处理日志 → 存储和索引 → 可视化展示 → 查看分析
```

**Elasticsearch的职责**：
- **📥 存储**：保存所有日志数据
- **🔍 索引**：为日志内容建立搜索索引
- **🔎 查询**：提供快速的日志搜索能力
- **📊 聚合**：支持统计分析功能

### 1.3 核心概念对比


| **传统数据库** | **Elasticsearch** | **通俗理解** |
|---------------|------------------|-------------|
| 数据库 Database | 索引 Index | 就像一个"文件夹" |
| 表 Table | 类型 Type | 已废弃，不用关心 |
| 行 Row | 文档 Document | 一条具体的记录 |
| 列 Column | 字段 Field | 记录中的某个属性 |

---

## 2. 🛠 安装与基础配置


### 2.1 系统要求检查


> ⚠️ **重要提醒**：ES对系统环境有一定要求

**🔸 硬件要求**：
```
最低配置：
- CPU：2核心
- 内存：4GB（推荐8GB以上）
- 磁盘：20GB可用空间

生产环境：
- CPU：8核心以上
- 内存：32GB以上
- 磁盘：SSD，容量根据数据量规划
```

**🔸 系统准备**：
```bash
# 检查Java版本（ES需要Java 8或11）
java -version

# 如果没有Java，安装OpenJDK 11
sudo yum install java-11-openjdk java-11-openjdk-devel

# 设置系统限制
echo "elasticsearch soft nofile 65536" >> /etc/security/limits.conf
echo "elasticsearch hard nofile 65536" >> /etc/security/limits.conf
echo "elasticsearch soft nproc 4096" >> /etc/security/limits.conf
```

### 2.2 安装Elasticsearch


**🔸 方式一：RPM包安装（推荐）**：
```bash
# 下载并安装ES 7.x版本
wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.17.0-x86_64.rpm
sudo rpm -ivh elasticsearch-7.17.0-x86_64.rpm

# 启用并启动服务
sudo systemctl enable elasticsearch
sudo systemctl start elasticsearch
```

**🔸 方式二：tar包安装**：
```bash
# 下载tar包
wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.17.0-linux-x86_64.tar.gz
tar -xzf elasticsearch-7.17.0-linux-x86_64.tar.gz

# 创建用户（不要用root运行ES）
useradd elasticsearch
chown -R elasticsearch:elasticsearch elasticsearch-7.17.0/
```

### 2.3 目录结构说明


```
Elasticsearch目录结构：
/usr/share/elasticsearch/          ← 程序主目录
├── bin/                          ← 可执行文件
│   ├── elasticsearch             ← 启动脚本
│   └── elasticsearch-plugin      ← 插件管理
├── config/                       ← 配置文件目录
│   ├── elasticsearch.yml         ← 主配置文件
│   ├── jvm.options               ← JVM配置
│   └── log4j2.properties         ← 日志配置
├── data/                         ← 数据存储目录
├── logs/                         ← 日志文件目录
└── plugins/                      ← 插件目录
```

---

## 3. 👥 集群节点角色划分


### 3.1 节点角色类型


> 💡 **类比理解**：ES集群就像一个公司，不同节点承担不同职责

**🔸 Master节点（管理者）**：
```
职责：负责集群管理和协调
- 管理索引的创建和删除
- 分配分片到各个节点
- 维护集群状态信息
- 不存储数据，不处理搜索请求

配置示例：
node.master: true
node.data: false
node.ingest: false
```

**🔸 Data节点（工作者）**：
```
职责：存储数据和处理搜索请求
- 存储实际的文档数据
- 执行搜索和聚合操作
- 处理索引和查询请求
- 承担主要的计算工作

配置示例：
node.master: false
node.data: true
node.ingest: false
```

**🔸 Ingest节点（预处理器）**：
```
职责：数据预处理
- 在数据写入前进行转换
- 解析、丰富数据内容
- 减轻客户端处理负担

配置示例：
node.master: false
node.data: false
node.ingest: true
```

### 3.2 集群架构规划


**🔸 小型集群（3节点）**：
```
集群架构图：
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│   Node-1    │  │   Node-2    │  │   Node-3    │
│             │  │             │  │             │
│ Master: ✓   │  │ Master: ✓   │  │ Master: ✓   │
│ Data: ✓     │  │ Data: ✓     │  │ Data: ✓     │
│ Ingest: ✓   │  │ Ingest: ✓   │  │ Ingest: ✓   │
└─────────────┘  └─────────────┘  └─────────────┘

特点：所有节点都承担所有角色
适用：中小型应用，数据量不大
```

**🔸 大型集群（专用角色）**：
```
集群架构图：
     Master节点              Data节点群            Ingest节点
┌─────────────┐    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│   Master-1  │    │   Data-1    │ │   Data-2    │ │  Ingest-1   │
│             │    │             │ │             │ │             │
│ Master: ✓   │    │ Master: ✗   │ │ Master: ✗   │ │ Master: ✗   │
│ Data: ✗     │    │ Data: ✓     │ │ Data: ✓     │ │ Data: ✗     │
│ Ingest: ✗   │    │ Ingest: ✗   │ │ Ingest: ✗   │ │ Ingest: ✓   │
└─────────────┘    └─────────────┘ └─────────────┘ └─────────────┘

特点：角色分离，专业化分工
适用：大型应用，高并发场景
```

### 3.3 角色配置最佳实践


> 📋 **配置建议**

**✅ 推荐配置**：
- **Master节点**：奇数个（3个或5个），避免脑裂
- **Data节点**：根据数据量和查询压力确定
- **Ingest节点**：如果有复杂预处理需求才配置

**❌ 避免的配置**：
- 单个Master节点（单点故障）
- 偶数个Master节点（可能脑裂）
- 所有节点都是Master（选举复杂）

---

## 4. ⚙️ 核心配置参数详解


### 4.1 elasticsearch.yml主配置


> 📝 **配置文件位置**：`/etc/elasticsearch/elasticsearch.yml`

**🔸 集群基础配置**：
```yaml
# 集群名称（同一集群必须相同）
cluster.name: my-es-cluster

# 节点名称（每个节点必须唯一）
node.name: es-node-1

# 节点角色
node.master: true
node.data: true
node.ingest: true

# 数据和日志目录
path.data: /var/lib/elasticsearch
path.logs: /var/log/elasticsearch
```

**🔸 网络配置**：
```yaml
# 绑定IP地址
network.host: 0.0.0.0

# HTTP端口（默认9200）
http.port: 9200

# 集群内部通信端口（默认9300）
transport.tcp.port: 9300

# 允许跨域访问（开发环境）
http.cors.enabled: true
http.cors.allow-origin: "*"
```

**🔸 集群发现配置**：
```yaml
# 集群初始主节点
cluster.initial_master_nodes: ["es-node-1", "es-node-2", "es-node-3"]

# 发现其他节点的地址
discovery.seed_hosts: ["192.168.1.10", "192.168.1.11", "192.168.1.12"]

# 最小主节点数（防止脑裂）
discovery.zen.minimum_master_nodes: 2
```

### 4.2 重要参数说明


**🔸 cluster.name**：
```
作用：标识集群身份
要求：同一集群所有节点必须相同
示例：cluster.name: production-logs
```

**🔸 node.name**：
```
作用：标识节点身份
要求：集群内必须唯一
建议：使用有意义的名称，如 web-server-01
```

**🔸 network.host**：
```
取值说明：
- 0.0.0.0：绑定所有网卡（生产环境）
- 127.0.0.1：只允许本机访问（开发环境）
- 具体IP：绑定指定网卡
```

### 4.3 安全配置


**🔸 基础安全设置**：
```yaml
# 禁用动态脚本（安全考虑）
script.allowed_types: inline
script.allowed_contexts: search, update

# 限制网络访问
network.publish_host: 192.168.1.10
network.bind_host: 192.168.1.10

# 关闭自动创建索引
action.auto_create_index: false
```

---

## 5. 🧠 JVM堆内存调优


### 5.1 内存配置基础


> 💡 **关键理解**：ES是Java程序，需要合理配置JVM内存

**🔸 内存配置文件**：`/etc/elasticsearch/jvm.options`

**🔸 基本原则**：
```
内存分配原则：
1. 堆内存不超过物理内存的50%
2. 堆内存不超过32GB（压缩指针限制）
3. 剩余内存留给操作系统文件缓存
```

### 5.2 内存大小配置


**🔸 配置示例**：
```bash
# 编辑JVM配置
vim /etc/elasticsearch/jvm.options

# 设置堆内存大小（初始值和最大值设为相同）
-Xms8g
-Xmx8g

# 示例：不同内存服务器的配置
# 16GB服务器：-Xms8g -Xmx8g
# 32GB服务器：-Xms16g -Xmx16g  
# 64GB服务器：-Xms31g -Xmx31g（不要超过32g）
```

**🔸 内存计算公式**：
```
推荐配置计算：
服务器内存 = ES堆内存 + 系统内存 + 文件缓存

示例（32GB服务器）：
ES堆内存：16GB
系统内存：4GB
文件缓存：12GB
总计：32GB
```

### 5.3 垃圾回收优化


**🔸 GC参数调优**：
```bash
# G1垃圾回收器（ES 7.x默认）
-XX:+UseG1GC
-XX:G1HeapRegionSize=16m
-XX:+DisableExplicitGC

# 内存溢出时生成堆转储
-XX:+HeapDumpOnOutOfMemoryError
-XX:HeapDumpPath=/var/lib/elasticsearch

# GC日志配置
-Xlog:gc*,gc+age=trace,safepoint:gc.log:time,level,tags
```

### 5.4 内存监控指标


```
关键监控指标：
┌─────────────────┬──────────────┬─────────────┐
│     指标        │   正常范围    │   告警阈值   │
├─────────────────┼──────────────┼─────────────┤
│ 堆内存使用率     │   < 75%      │   > 85%     │
│ GC频率         │   < 1次/分钟  │   > 5次/分钟 │
│ GC暂停时间      │   < 100ms    │   > 500ms   │
│ 老年代使用率     │   < 70%      │   > 80%     │
└─────────────────┴──────────────┴─────────────┘
```

---

## 6. 🌐 集群发现与通信设置


### 6.1 集群发现机制


> 💡 **通俗理解**：节点如何找到集群中的其他节点

**🔸 发现过程**：
```
节点启动流程：
1. 读取配置文件中的seed_hosts
2. 尝试连接这些地址
3. 获取集群中所有节点信息
4. 加入集群或参与主节点选举
```

**🔸 发现配置**：
```yaml
# 种子节点列表
discovery.seed_hosts:
  - "192.168.1.10:9300"
  - "192.168.1.11:9300"
  - "192.168.1.12:9300"

# 也可以使用主机名
discovery.seed_hosts:
  - "es-master-01"
  - "es-master-02"
  - "es-master-03"
```

### 6.2 主节点选举


**🔸 选举配置**：
```yaml
# 初始主节点候选人
cluster.initial_master_nodes:
  - "es-master-01"
  - "es-master-02"
  - "es-master-03"

# 最小主节点数（防脑裂）
discovery.zen.minimum_master_nodes: 2
```

**🔸 脑裂预防**：
```
脑裂现象：
集群分成两个独立的小集群，都认为自己是正确的

预防公式：
minimum_master_nodes = (master节点数 / 2) + 1

示例：
3个master节点：minimum = (3/2) + 1 = 2
5个master节点：minimum = (5/2) + 1 = 3
```

### 6.3 网络通信配置


**🔸 端口规划**：
```
ES使用的端口：
┌─────────────┬─────────┬──────────────────┐
│    服务     │  默认端口 │      用途        │
├─────────────┼─────────┼──────────────────┤
│ HTTP API    │  9200   │ REST API访问     │
│ Transport   │  9300   │ 集群内部通信      │
└─────────────┴─────────┴──────────────────┘
```

**🔸 网络配置示例**：
```yaml
# 网络接口配置
network.host: 192.168.1.10
network.publish_host: 192.168.1.10
network.bind_host: 192.168.1.10

# 端口配置
http.port: 9200
transport.tcp.port: 9300

# 网络超时设置
transport.tcp.connect_timeout: 30s
transport.tcp.compress: true
```

---

## 7. 📊 分片与副本策略


### 7.1 分片基础概念


> 💡 **形象理解**：分片就像把一本大书分成几个小册子

**🔸 分片类型**：
```
主分片（Primary Shard）：
- 原始数据的存储单位
- 创建索引时确定，后续不能修改
- 决定集群的水平扩展能力

副分片（Replica Shard）：  
- 主分片的完整拷贝
- 提供数据冗余和查询性能
- 可以动态调整数量
```

**🔸 分片分布示例**：
```
3节点集群，2主分片，1副本：

Node-1          Node-2          Node-3
┌─────────┐     ┌─────────┐     ┌─────────┐
│ P0(主)  │     │ P1(主)  │     │ R0(副)  │
│ R1(副)  │     │ R0(副)  │     │ P0(主)  │
└─────────┘     └─────────┘     └─────────┘

P0、P1：主分片    R0、R1：副分片
```

### 7.2 分片数量规划


**🔸 主分片数量计算**：
```
计算公式：
主分片数 = 预期数据量 / 单分片大小上限

建议值：
- 单分片大小：20-40GB
- 单节点分片数：不超过20个
- 单集群分片总数：不超过10000个

示例计算：
预期数据量：500GB
单分片上限：30GB
建议主分片数：500 ÷ 30 ≈ 17个
```

**🔸 副本数量规划**：
```
副本数量建议：
- 单副本：适合大多数场景
- 双副本：重要数据，高可用要求
- 无副本：临时数据，性能优先

示例配置：
PUT /my-index
{
  "settings": {
    "number_of_shards": 5,
    "number_of_replicas": 1
  }
}
```

### 7.3 分片策略最佳实践


**✅ 推荐做法**：
```
1. 根据数据增长预估分片数
2. 单分片大小控制在20-40GB
3. 优先增加副本而不是分片
4. 使用索引模板统一设置
```

**❌ 避免的问题**：
```
1. 分片过多：影响集群性能
2. 分片过少：限制扩展能力  
3. 副本过多：浪费存储空间
4. 热点分片：数据分布不均
```

---

## 8. 📋 索引模板与映射


### 8.1 索引模板概念


> 💡 **通俗理解**：索引模板就像"文档格式模板"，定义了数据的结构

**🔸 模板作用**：
```
索引模板用途：
1. 统一索引设置（分片、副本等）
2. 定义字段映射（数据类型）
3. 自动应用到匹配的索引
4. 简化索引管理工作
```

**🔸 模板匹配机制**：
```
匹配规则：
- 使用通配符匹配索引名
- 多个模板可以匹配同一索引
- 按优先级合并配置

示例：
模板名：logstash-*
匹配索引：logstash-2023.01.01, logstash-2023.01.02
```

### 8.2 创建索引模板


**🔸 基础模板示例**：
```json
PUT /_template/logstash-template
{
  "index_patterns": ["logstash-*"],
  "settings": {
    "number_of_shards": 3,
    "number_of_replicas": 1,
    "refresh_interval": "30s"
  },
  "mappings": {
    "properties": {
      "@timestamp": {
        "type": "date"
      },
      "level": {
        "type": "keyword"
      },
      "message": {
        "type": "text",
        "analyzer": "standard"
      },
      "host": {
        "type": "keyword"
      }
    }
  }
}
```

### 8.3 字段映射类型


**🔸 常用数据类型**：
```
┌─────────────┬──────────────┬─────────────────┐
│   数据类型   │     用途     │      示例       │
├─────────────┼──────────────┼─────────────────┤
│ text        │ 全文搜索     │ 日志消息内容     │
│ keyword     │ 精确匹配     │ 状态码、IP地址   │
│ date        │ 时间字段     │ 时间戳          │
│ long        │ 整数        │ 用户ID、计数     │
│ double      │ 浮点数      │ 价格、百分比     │
│ boolean     │ 布尔值      │ 是否成功        │
│ ip          │ IP地址      │ 客户端IP        │
└─────────────┴──────────────┴─────────────────┘
```

**🔸 映射配置技巧**：
```json
{
  "mappings": {
    "properties": {
      "message": {
        "type": "text",
        "fields": {
          "keyword": {
            "type": "keyword",
            "ignore_above": 256
          }
        }
      }
    }
  }
}
```

---

## 9. 🔍 集群健康监控


### 9.1 健康状态检查


**🔸 集群状态颜色**：
```
健康状态说明：
🟢 GREEN：所有分片都正常
🟡 YELLOW：主分片正常，部分副分片异常
🔴 RED：部分主分片异常，数据不完整
```

**🔸 状态检查命令**：
```bash
# 查看集群整体健康状态
curl -X GET "localhost:9200/_cluster/health?pretty"

# 查看详细的分片状态
curl -X GET "localhost:9200/_cat/shards?v"

# 查看节点状态
curl -X GET "localhost:9200/_cat/nodes?v"
```

### 9.2 监控关键指标


**🔸 集群级别指标**：
```json
{
  "cluster_name": "my-es-cluster",
  "status": "green",
  "timed_out": false,
  "number_of_nodes": 3,
  "number_of_data_nodes": 3,
  "active_primary_shards": 15,
  "active_shards": 30,
  "unassigned_shards": 0
}
```

**🔸 节点级别指标**：
```bash
# 查看节点资源使用情况
curl -X GET "localhost:9200/_nodes/stats?pretty"

# 重点关注指标：
# - JVM堆内存使用率
# - CPU使用率  
# - 磁盘使用情况
# - 网络IO状态
```

### 9.3 常见问题诊断


**🔸 分片分配问题**：
```bash
# 查看未分配的分片
curl -X GET "localhost:9200/_cat/shards?h=index,shard,prirep,state,unassigned.reason"

# 查看分片分配解释
curl -X GET "localhost:9200/_cluster/allocation/explain?pretty"
```

**🔸 性能监控脚本**：
```bash
#!/bin/bash
# ES健康检查脚本

# 检查集群状态
STATUS=$(curl -s localhost:9200/_cluster/health | jq -r '.status')
echo "集群状态: $STATUS"

# 检查节点数量
NODES=$(curl -s localhost:9200/_cluster/health | jq -r '.number_of_nodes')
echo "节点数量: $NODES"

# 检查未分配分片
UNASSIGNED=$(curl -s localhost:9200/_cluster/health | jq -r '.unassigned_shards')
echo "未分配分片: $UNASSIGNED"

if [ "$STATUS" != "green" ]; then
    echo "⚠️ 集群状态异常，需要检查！"
fi
```

---

## 10. 📋 核心要点总结


### 10.1 必须掌握的核心概念


```
🔸 ES本质：分布式搜索引擎 + 数据分析平台
🔸 集群角色：Master(管理) + Data(存储) + Ingest(预处理)
🔸 分片策略：主分片(扩展) + 副分片(冗余)
🔸 配置要点：内存、网络、发现、模板
🔸 监控重点：集群状态、节点健康、分片分布
```

### 10.2 关键配置清单


> 📝 **部署检查清单**

**✅ 系统环境**：
- [ ] Java 8/11已安装
- [ ] 系统限制已调整
- [ ] 防火墙端口已开放
- [ ] 专用用户已创建

**✅ 集群配置**：
- [ ] cluster.name已设置
- [ ] node.name唯一标识
- [ ] 节点角色明确划分
- [ ] 网络地址正确配置

**✅ 内存调优**：
- [ ] JVM堆内存合理设置
- [ ] 不超过物理内存50%
- [ ] 不超过32GB限制
- [ ] GC参数优化配置

**✅ 集群发现**：
- [ ] seed_hosts正确配置
- [ ] initial_master_nodes设置
- [ ] minimum_master_nodes防脑裂
- [ ] 网络通信正常

### 10.3 最佳实践总结


**🎯 架构设计**：
```
小型环境：3节点混合角色集群
中型环境：专用Master + 多Data节点
大型环境：角色分离 + 负载均衡
```

**⚡ 性能优化**：
```
内存：堆内存50%，剩余给文件缓存
磁盘：SSD存储，合理规划分片大小
网络：千兆网络，低延迟连接
监控：实时监控健康状态和性能指标
```

**🛡️ 安全建议**：
```
网络：限制访问来源，使用内网通信
认证：启用安全插件，设置用户权限
备份：定期快照备份，验证恢复流程
更新：及时更新版本，修复安全漏洞
```

**核心记忆口诀**：
- 角色分工要明确，Master管理Data存储
- 内存配置是关键，一半堆内存一半缓存
- 分片规划需合理，单片不超四十G
- 集群发现防脑裂，奇数Master是关键
- 健康监控不能少，绿色状态才正常