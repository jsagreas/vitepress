---
title: 3ã€Logstashæ•°æ®å¤„ç†é…ç½®
---
## ğŸ“š ç›®å½•

1. [Logstash pipelineé…ç½®ç»“æ„](#1-logstash-pipelineé…ç½®ç»“æ„)
2. [Inputæ’ä»¶é…ç½®è¯¦è§£](#2-inputæ’ä»¶é…ç½®è¯¦è§£)
3. [Filteræ’ä»¶æ•°æ®è§£æä¸è½¬æ¢](#3-filteræ’ä»¶æ•°æ®è§£æä¸è½¬æ¢)
4. [Grokæ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼åŒ¹é…](#4-grokæ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼åŒ¹é…)
5. [Dateæ’ä»¶æ—¶é—´å­—æ®µè§£æ](#5-dateæ’ä»¶æ—¶é—´å­—æ®µè§£æ)
6. [Mutateæ’ä»¶å­—æ®µæ“ä½œ](#6-mutateæ’ä»¶å­—æ®µæ“ä½œ)
7. [Outputæ’ä»¶è¾“å‡ºé…ç½®](#7-outputæ’ä»¶è¾“å‡ºé…ç½®)
8. [æ¡ä»¶åˆ¤æ–­ä¸å¤šè·¯è¾“å‡º](#8-æ¡ä»¶åˆ¤æ–­ä¸å¤šè·¯è¾“å‡º)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ—ï¸ Logstash pipelineé…ç½®ç»“æ„


### 1.1 PipelineåŸºæœ¬æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯Logstash Pipelineï¼Ÿ**
> Pipelineå°±åƒ"å·¥å‚æµæ°´çº¿"ï¼Œæ—¥å¿—æ•°æ®ä»ä¸€ç«¯è¿›å…¥ï¼Œç»è¿‡å¤šé“å·¥åºå¤„ç†ï¼Œæœ€åä»å¦ä¸€ç«¯è¾“å‡ºåˆ°ç›®æ ‡ä½ç½®ã€‚

```
æ—¥å¿—å¤„ç†æµæ°´çº¿ï¼š
åŸå§‹æ—¥å¿— â†’ [Input] â†’ [Filter] â†’ [Output] â†’ ç›®æ ‡å­˜å‚¨
          æ¥æ”¶     è§£æè½¬æ¢     å‘é€

å°±åƒå¿«é€’åˆ†æ‹£ï¼š
åŒ…è£¹ â†’ æ”¶ä»¶ â†’ åˆ†ç±»æ ‡è®° â†’ å‘å¾€ç›®çš„åœ°
```

### 1.2 é…ç½®æ–‡ä»¶åŸºæœ¬ç»“æ„


```ruby
# logstash.conf - åŸºæœ¬ç»“æ„
input {
  # æ•°æ®è¾“å…¥æºé…ç½®
  # ä»å“ªé‡Œæ¥æ”¶æ—¥å¿—æ•°æ®
}

filter {
  # æ•°æ®å¤„ç†é…ç½®  
  # å¦‚ä½•è§£æå’Œè½¬æ¢æ•°æ®
}

output {
  # æ•°æ®è¾“å‡ºé…ç½®
  # å°†å¤„ç†åçš„æ•°æ®å‘é€åˆ°å“ªé‡Œ
}
```

### 1.3 é…ç½®è¯­æ³•åŸºç¡€


**é…ç½®è¯­æ³•è¦ç‚¹ï¼š**
```ruby
# 1. æ³¨é‡Šä½¿ç”¨ #
# è¿™æ˜¯æ³¨é‡Š

# 2. å­—ç¬¦ä¸²å¯ä»¥ç”¨åŒå¼•å·æˆ–å•å¼•å·
field_name => "string value"
field_name => 'string value'

# 3. æ•°å­—å’Œå¸ƒå°”å€¼ä¸éœ€è¦å¼•å·
port => 5044
ssl_enable => true
timeout => 30

# 4. æ•°ç»„ä½¿ç”¨æ–¹æ‹¬å·
tags => ["web", "nginx", "access"]

# 5. å“ˆå¸Œä½¿ç”¨èŠ±æ‹¬å·
match => { "message" => "%{COMBINEDAPACHELOG}" }
```

### 1.4 Pipelineå·¥ä½œæµç¨‹è¯¦è§£


```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Input     â”‚â”€â”€â”€â–¶â”‚   Filter     â”‚â”€â”€â”€â–¶â”‚   Output    â”‚
â”‚   æ¥æ”¶æ•°æ®   â”‚    â”‚   å¤„ç†æ•°æ®    â”‚    â”‚   å‘é€æ•°æ®   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                    â”‚                   â”‚
       â–¼                    â–¼                   â–¼
â€¢ æ–‡ä»¶ç›‘æ§           â€¢ Grokè§£æ          â€¢ å‘é€åˆ°ES
â€¢ ç½‘ç»œæ¥æ”¶           â€¢ å­—æ®µè½¬æ¢          â€¢ å†™å…¥æ–‡ä»¶  
â€¢ é˜Ÿåˆ—ç›‘å¬           â€¢ æ•°æ®æ¸…æ´—          â€¢ å‘é€åˆ°Kafka
```

**å®é™…åº”ç”¨ç¤ºä¾‹ï¼š**
```ruby
# å¤„ç†Nginxè®¿é—®æ—¥å¿—çš„å®Œæ•´pipeline
input {
  file {
    path => "/var/log/nginx/access.log"
    start_position => "beginning"
    tags => ["nginx", "access"]
  }
}

filter {
  if "nginx" in [tags] {
    grok {
      match => { "message" => "%{COMBINEDAPACHELOG}" }
    }
    
    date {
      match => [ "timestamp", "dd/MMM/yyyy:HH:mm:ss Z" ]
    }
    
    mutate {
      convert => { "response" => "integer" }
      convert => { "bytes" => "integer" }
    }
  }
}

output {
  elasticsearch {
    hosts => ["localhost:9200"]
    index => "nginx-access-%{+YYYY.MM.dd}"
  }
  
  stdout {
    codec => rubydebug
  }
}
```

---

## 2. ğŸ“¥ Inputæ’ä»¶é…ç½®è¯¦è§£


### 2.1 Inputæ’ä»¶åŸºæœ¬æ¦‚å¿µ


**Inputæ’ä»¶çš„ä½œç”¨**
> Inputæ’ä»¶å°±åƒ"æ•°æ®æ”¶é›†å‘˜"ï¼Œè´Ÿè´£ä»å„ç§ä¸åŒçš„åœ°æ–¹æ”¶é›†æ—¥å¿—æ•°æ®ï¼Œå°±åƒé‚®é€’å‘˜ä»ä¸åŒåœ°æ–¹æ”¶é›†é‚®ä»¶ä¸€æ ·ã€‚

```
å¸¸è§æ•°æ®æºç±»å‹ï¼š
ğŸ“ æ–‡ä»¶ï¼šåº”ç”¨æ—¥å¿—æ–‡ä»¶ã€ç³»ç»Ÿæ—¥å¿—
ğŸŒ ç½‘ç»œï¼šTCP/UDPæ•°æ®æµã€HTTPè¯·æ±‚
ğŸ“¨ æ¶ˆæ¯é˜Ÿåˆ—ï¼šKafkaã€RabbitMQã€Redis
ğŸ”„ æ•°æ®åº“ï¼šMySQLã€PostgreSQLæŸ¥è¯¢ç»“æœ
```

### 2.2 Fileè¾“å…¥æ’ä»¶è¯¦è§£


#### ğŸ”¸ åŸºç¡€æ–‡ä»¶ç›‘æ§é…ç½®

```ruby
input {
  file {
    path => "/var/log/app/*.log"              # æ–‡ä»¶è·¯å¾„æ¨¡å¼
    start_position => "beginning"             # ä»æ–‡ä»¶å¼€å¤´å¼€å§‹è¯»å–
    sincedb_path => "/dev/null"              # ä½ç½®è®°å½•æ–‡ä»¶ï¼ˆæµ‹è¯•æ—¶å¯ç”¨/dev/nullï¼‰
    codec => "json"                          # æ–‡ä»¶å†…å®¹æ ¼å¼
    tags => ["application", "production"]    # æ·»åŠ æ ‡ç­¾
    type => "app_log"                       # è®¾ç½®ç±»å‹å­—æ®µ
  }
}
```

**å…³é”®å‚æ•°è¯¦è§£ï¼š**
```ruby
# æ–‡ä»¶è·¯å¾„é…ç½®
path => ["/var/log/app1/*.log", "/var/log/app2/*.log"]  # å¤šè·¯å¾„ç›‘æ§

# è¯»å–ä½ç½®æ§åˆ¶
start_position => "beginning"    # ä»å¤´å¼€å§‹è¯»ï¼ˆé¦–æ¬¡è¿è¡Œï¼‰
start_position => "end"         # ä»æœ«å°¾å¼€å§‹è¯»ï¼ˆæ¨èç”Ÿäº§ç¯å¢ƒï¼‰

# æ–‡ä»¶çŠ¶æ€è·Ÿè¸ª
sincedb_path => "/var/lib/logstash/sincedb"  # è®°å½•è¯»å–ä½ç½®
sincedb_write_interval => 15                 # å†™å…¥é—´éš”ï¼ˆç§’ï¼‰

# æ–‡ä»¶å‘ç°ä¸ç›‘æ§
discover_interval => 15          # æ–°æ–‡ä»¶å‘ç°é—´éš”
stat_interval => 1              # æ–‡ä»¶çŠ¶æ€æ£€æŸ¥é—´éš”

# æ–‡ä»¶è½®è½¬å¤„ç†
close_older => 3600             # 1å°æ—¶æœªæ›´æ–°çš„æ–‡ä»¶å…³é—­
ignore_older => 86400           # å¿½ç•¥1å¤©å‰çš„æ–‡ä»¶
```

#### ğŸ”¸ é«˜çº§æ–‡ä»¶ç›‘æ§é…ç½®

```ruby
input {
  file {
    path => "/var/log/nginx/access.log"
    
    # å¤šè¡Œæ—¥å¿—å¤„ç†ï¼ˆJavaå †æ ˆå¼‚å¸¸ï¼‰
    codec => multiline {
      pattern => "^\s"                    # ä»¥ç©ºæ ¼å¼€å¤´çš„è¡Œ
      what => "previous"                  # åˆå¹¶åˆ°å‰ä¸€è¡Œ
      negate => false
    }
    
    # æ–‡ä»¶è½®è½¬æ”¯æŒ
    close_older => 3600
    ignore_older => 24 * 3600
    
    # æ·»åŠ é¢å¤–å­—æ®µ
    add_field => {
      "log_source" => "nginx_access"
      "environment" => "production"
    }
  }
}
```

### 2.3 Beatsè¾“å…¥æ’ä»¶é…ç½®


**ä»€ä¹ˆæ˜¯Beatsï¼Ÿ**
> Beatså°±åƒ"ä¸“ä¸šå¿«é€’å‘˜"ï¼Œæ¯”æ™®é€šçš„æ–‡ä»¶ç›‘æ§æ›´è½»é‡ã€æ›´é«˜æ•ˆï¼Œä¸“é—¨è´Ÿè´£æ”¶é›†ç‰¹å®šç±»å‹çš„æ•°æ®ã€‚

```ruby
input {
  beats {
    port => 5044                        # ç›‘å¬ç«¯å£
    ssl => true                         # å¯ç”¨SSL
    ssl_certificate => "/path/to/cert.crt"
    ssl_key => "/path/to/private.key"
    
    # å®¢æˆ·ç«¯è®¤è¯
    ssl_verify_mode => "force_peer"     # å¼ºåˆ¶å®¢æˆ·ç«¯è®¤è¯
    ssl_certificate_authorities => ["/path/to/ca.crt"]
  }
}
```

**Beatsç±»å‹è¯´æ˜ï¼š**
```
ğŸƒâ€â™‚ï¸ Filebeatï¼šæ–‡ä»¶æ—¥å¿—æ”¶é›†
â€¢ è½»é‡çº§æ–‡ä»¶ç›‘æ§
â€¢ æ”¯æŒå¤šè¡Œåˆå¹¶
â€¢ è‡ªåŠ¨å¤„ç†æ–‡ä»¶è½®è½¬

ğŸ’“ Heartbeatï¼šæœåŠ¡å¯ç”¨æ€§ç›‘æ§  
â€¢ HTTP/TCP/ICMPæ£€æŸ¥
â€¢ å“åº”æ—¶é—´ç›‘æ§
â€¢ æœåŠ¡çŠ¶æ€æ£€æµ‹

ğŸ“Š Metricbeatï¼šç³»ç»ŸæŒ‡æ ‡æ”¶é›†
â€¢ CPUã€å†…å­˜ã€ç£ç›˜ä½¿ç”¨ç‡
â€¢ ç½‘ç»œæµé‡ç»Ÿè®¡
â€¢ åº”ç”¨æ€§èƒ½æŒ‡æ ‡

ğŸ”’ Auditbeatï¼šå®‰å…¨å®¡è®¡æ—¥å¿—
â€¢ æ–‡ä»¶å®Œæ•´æ€§ç›‘æ§
â€¢ ç³»ç»Ÿè°ƒç”¨å®¡è®¡
â€¢ ç”¨æˆ·è¡Œä¸ºè·Ÿè¸ª
```

### 2.4 Syslogè¾“å…¥æ’ä»¶é…ç½®


```ruby
input {
  syslog {
    port => 514                         # æ ‡å‡†syslogç«¯å£
    protocol => "udp"                   # åè®®ç±»å‹
    type => "syslog"
    
    # è®¾æ–½å’Œä¸¥é‡æ€§è§£æ
    use_labels => true                  # ä½¿ç”¨æ ‡ç­¾è€Œä¸æ˜¯æ•°å­—
    
    # æ·»åŠ æºä¿¡æ¯
    add_field => {
      "log_type" => "system"
      "received_at" => "%{@timestamp}"
    }
  }
}
```

#### ğŸ”¸ TCP Syslogé…ç½®

```ruby
input {
  tcp {
    port => 1514
    type => "syslog"
    
    # TCPç‰¹å®šé…ç½®
    mode => "server"                    # æœåŠ¡å™¨æ¨¡å¼
    ssl_enable => false
    
    # è¿æ¥ç®¡ç†
    tcp_keep_alive => true
    
    codec => cef                        # æ”¯æŒCEFæ ¼å¼
  }
}
```

### 2.5 å…¶ä»–å¸¸ç”¨Inputæ’ä»¶


#### ğŸ”¸ HTTPè¾“å…¥æ’ä»¶

```ruby
input {
  http {
    port => 8080
    host => "0.0.0.0"
    
    # HTTPç‰¹å®šé…ç½®
    codec => "json"
    additional_codecs => {
      "application/json" => "json"
      "text/plain" => "plain"
    }
    
    # å®‰å…¨é…ç½®
    user => "logstash"
    password => "secret"
    
    # æ·»åŠ HTTPå¤´ä¿¡æ¯
    add_field => {
      "received_from" => "%{[@metadata][input][http][request][headers][host]}"
    }
  }
}
```

#### ğŸ”¸ Kafkaè¾“å…¥æ’ä»¶

```ruby
input {
  kafka {
    bootstrap_servers => ["kafka1:9092", "kafka2:9092"]
    topics => ["application-logs", "system-logs"]
    
    # æ¶ˆè´¹è€…ç»„é…ç½®
    group_id => "logstash-group"
    client_id => "logstash-client"
    
    # æ€§èƒ½é…ç½®
    consumer_threads => 4
    fetch_min_bytes => 1024
    
    # æ•°æ®æ ¼å¼
    codec => "json"
    
    # é”™è¯¯å¤„ç†
    decorate_events => true             # æ·»åŠ Kafkaå…ƒæ•°æ®
  }
}
```

---

## 3. âš™ï¸ Filteræ’ä»¶æ•°æ®è§£æä¸è½¬æ¢


### 3.1 Filteræ’ä»¶åŸºæœ¬æ¦‚å¿µ


**Filteræ’ä»¶çš„ä½œç”¨**
> Filteræ’ä»¶å°±åƒ"æ•°æ®åŠ å·¥è½¦é—´"ï¼ŒæŠŠåŸå§‹çš„ã€æ··ä¹±çš„æ—¥å¿—æ•°æ®åŠ å·¥æˆæ•´é½ã€æœ‰ç”¨çš„ç»“æ„åŒ–ä¿¡æ¯ã€‚

```
æ•°æ®è½¬æ¢è¿‡ç¨‹ï¼š
åŸå§‹æ—¥å¿—ï¼š192.168.1.100 - - [25/Dec/2023:10:15:32 +0000] "GET /index.html"
         â†“ Filterå¤„ç†
ç»“æ„åŒ–æ•°æ®ï¼š{
  "client_ip": "192.168.1.100",
  "timestamp": "2023-12-25T10:15:32.000Z", 
  "method": "GET",
  "url": "/index.html",
  "status_code": 200
}
```

### 3.2 Filteræ’ä»¶æ‰§è¡Œé¡ºåº


```ruby
filter {
  # 1. é¦–å…ˆæ‰§è¡ŒGrokè§£æ
  grok {
    match => { "message" => "%{COMBINEDAPACHELOG}" }
  }
  
  # 2. ç„¶åå¤„ç†æ—¶é—´å­—æ®µ
  date {
    match => [ "timestamp", "dd/MMM/yyyy:HH:mm:ss Z" ]
  }
  
  # 3. æœ€åè¿›è¡Œå­—æ®µè½¬æ¢
  mutate {
    convert => { "response" => "integer" }
    remove_field => ["message"]        # åˆ é™¤åŸå§‹messageå­—æ®µ
  }
}
```

**æ‰§è¡Œé¡ºåºè§„åˆ™ï¼š**
```
ğŸ”¸ é…ç½®æ–‡ä»¶ä¸­çš„é¡ºåºï¼šä»ä¸Šåˆ°ä¸‹ä¾æ¬¡æ‰§è¡Œ
ğŸ”¸ æ¡ä»¶åˆ¤æ–­ï¼šå¯ä»¥æ§åˆ¶æŸäº›filteræ˜¯å¦æ‰§è¡Œ
ğŸ”¸ é”™è¯¯å¤„ç†ï¼šæŸä¸ªfilterå¤±è´¥ä¸ä¼šå½±å“åç»­filter
ğŸ”¸ å­—æ®µä¾èµ–ï¼šåé¢çš„filterå¯ä»¥ä½¿ç”¨å‰é¢filteråˆ›å»ºçš„å­—æ®µ
```

### 3.3 å¸¸ç”¨Filteræ’ä»¶ç»„åˆ


#### ğŸ”¸ Webæ—¥å¿—å¤„ç†ç»„åˆ

```ruby
filter {
  # 1. è§£æApache/Nginxæ—¥å¿—æ ¼å¼
  grok {
    match => { "message" => "%{COMBINEDAPACHELOG}" }
  }
  
  # 2. è§£ææ—¶é—´æˆ³
  date {
    match => [ "timestamp", "dd/MMM/yyyy:HH:mm:ss Z" ]
  }
  
  # 3. è§£æUser Agent
  useragent {
    source => "agent"
    target => "user_agent"
  }
  
  # 4. GeoIPåœ°å€è§£æ
  geoip {
    source => "clientip"
    target => "geoip"
  }
  
  # 5. å­—æ®µç±»å‹è½¬æ¢å’Œæ¸…ç†
  mutate {
    convert => { 
      "response" => "integer"
      "bytes" => "integer" 
    }
    remove_field => ["message", "timestamp"]
  }
}
```

#### ğŸ”¸ JSONæ—¥å¿—å¤„ç†ç»„åˆ

```ruby
filter {
  # 1. è§£æJSONæ ¼å¼æ—¥å¿—
  json {
    source => "message"
  }
  
  # 2. å¤„ç†åµŒå¥—JSONå­—æ®µ
  if [app_data] {
    json {
      source => "app_data"
      target => "parsed_app_data"
    }
  }
  
  # 3. æ—¶é—´å­—æ®µå¤„ç†
  date {
    match => [ "timestamp", "ISO8601" ]
  }
  
  # 4. æ·»åŠ è®¡ç®—å­—æ®µ
  ruby {
    code => "
      if event.get('response_time')
        event.set('response_time_ms', event.get('response_time') * 1000)
      end
    "
  }
}
```

### 3.4 æ¡ä»¶åˆ¤æ–­åœ¨Filterä¸­çš„åº”ç”¨


```ruby
filter {
  # åŸºäºæ ‡ç­¾çš„æ¡ä»¶å¤„ç†
  if "nginx" in [tags] {
    grok {
      match => { "message" => "%{NGINXACCESS}" }
    }
  } else if "apache" in [tags] {
    grok {
      match => { "message" => "%{COMBINEDAPACHELOG}" }
    }
  }
  
  # åŸºäºå­—æ®µå€¼çš„æ¡ä»¶å¤„ç†
  if [response] and [response] >= 400 {
    mutate {
      add_tag => ["error"]
      add_field => { "log_level" => "ERROR" }
    }
  }
  
  # åŸºäºå­—æ®µå­˜åœ¨æ€§çš„åˆ¤æ–­
  if ![user_id] {
    mutate {
      add_field => { "user_id" => "anonymous" }
    }
  }
}
```

---

## 4. ğŸ” Grokæ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼åŒ¹é…


### 4.1 GrokåŸºæœ¬æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯Grokï¼Ÿ**
> Grokå°±åƒ"ç¿»è¯‘å­—å…¸"ï¼ŒæŠŠäººç±»éš¾è¯»çš„æ—¥å¿—æ–‡æœ¬ç¿»è¯‘æˆè®¡ç®—æœºæ˜“æ‡‚çš„ç»“æ„åŒ–æ•°æ®ã€‚å®ƒä½¿ç”¨é¢„å®šä¹‰çš„æ¨¡å¼æ¥è¯†åˆ«å’Œæå–æ—¥å¿—ä¸­çš„ä¿¡æ¯ã€‚

```
åŸå§‹æ—¥å¿—ï¼š127.0.0.1 - frank [25/Jan/2000:14:00:01 -0500] "GET /1986.js HTTP/1.1" 200 932
Grokæ¨¡å¼ï¼š%{IP:client} %{WORD:ident} %{WORD:auth} \[%{HTTPDATE:timestamp}\] "%{WORD:verb} %{DATA:request} HTTP/%{NUMBER:httpversion}" %{NUMBER:response:int} %{NUMBER:bytes:int}

è§£æç»“æœï¼š
client: 127.0.0.1
ident: -
auth: frank
timestamp: 25/Jan/2000:14:00:01 -0500
verb: GET
request: /1986.js
httpversion: 1.1
response: 200
bytes: 932
```

### 4.2 Grokè¯­æ³•åŸºç¡€


#### ğŸ”¸ åŸºæœ¬è¯­æ³•æ ¼å¼

```
%{PATTERN:field_name:data_type}

PATTERNï¼šé¢„å®šä¹‰çš„æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼
field_nameï¼šæå–åçš„å­—æ®µåç§°
data_typeï¼šæ•°æ®ç±»å‹ï¼ˆå¯é€‰ï¼‰intã€floatç­‰
```

#### ğŸ”¸ å¸¸ç”¨å†…ç½®æ¨¡å¼

```ruby
# åŸºç¡€æ¨¡å¼
%{WORD}           # å•è¯å­—ç¬¦ï¼š[A-Za-z0-9_]+
%{NUMBER}         # æ•°å­—ï¼š[+-]?[0-9]+(\.[0-9]+)?
%{INT}            # æ•´æ•°ï¼š[+-]?[0-9]+
%{IP}             # IPåœ°å€ï¼šIPv4åœ°å€æ ¼å¼
%{HOSTNAME}       # ä¸»æœºåï¼šåˆæ³•çš„ä¸»æœºåæ ¼å¼
%{DATA}           # ä»»æ„æ•°æ®ï¼š.*?ï¼ˆéè´ªå©ªåŒ¹é…ï¼‰
%{GREEDYDATA}     # è´ªå©ªæ•°æ®ï¼š.*ï¼ˆåŒ¹é…æ‰€æœ‰å‰©ä½™å­—ç¬¦ï¼‰

# æ—¥æœŸæ—¶é—´æ¨¡å¼  
%{TIMESTAMP_ISO8601}    # ISO8601æ ¼å¼ï¼š2023-12-25T10:15:32.123Z
%{HTTPDATE}            # HTTPæ ¼å¼ï¼š25/Dec/2023:10:15:32 +0000
%{SYSLOGTIMESTAMP}     # Syslogæ ¼å¼ï¼šDec 25 10:15:32

# ç½‘ç»œç›¸å…³æ¨¡å¼
%{URI}            # URIï¼šå®Œæ•´çš„URIæ ¼å¼
%{URIPATH}        # URIè·¯å¾„ï¼š/path/to/resource
%{HTTPVERSION}    # HTTPç‰ˆæœ¬ï¼š1.1, 2.0ç­‰

# ç³»ç»Ÿç›¸å…³æ¨¡å¼  
%{USER}           # ç”¨æˆ·åï¼šåˆæ³•çš„ç”¨æˆ·åæ ¼å¼
%{PROG}           # ç¨‹åºåï¼šé€šå¸¸ç”¨äºsyslog
%{PID}            # è¿›ç¨‹IDï¼šæ•°å­—æ ¼å¼
```

### 4.3 Groké…ç½®å®ä¾‹


#### ğŸ”¸ Apacheè®¿é—®æ—¥å¿—è§£æ

```ruby
filter {
  grok {
    match => { 
      "message" => "%{IP:client_ip} %{WORD:ident} %{WORD:auth} \[%{HTTPDATE:apache_timestamp}\] \"%{WORD:method} %{URIPATH:path}(?:%{URIPARAM:params})? HTTP/%{NUMBER:http_version}\" %{INT:status_code:int} (?:%{INT:bytes:int}|-)"
    }
    
    # å¦‚æœåŒ¹é…å¤±è´¥ï¼Œæ·»åŠ æ ‡ç­¾
    tag_on_failure => ["_grokparsefailure", "apache_log"]
  }
}
```

#### ğŸ”¸ è‡ªå®šä¹‰æ—¥å¿—æ ¼å¼è§£æ

```ruby
filter {
  grok {
    # åº”ç”¨è‡ªå®šä¹‰æ—¥å¿—ï¼š[2023-12-25 10:15:32] ERROR UserService: User not found: 12345
    match => { 
      "message" => "\[%{TIMESTAMP_ISO8601:timestamp}\] %{LOGLEVEL:level} %{WORD:service}: %{GREEDYDATA:log_message}"
    }
    
    # å¤šæ¨¡å¼åŒ¹é…ï¼ˆæŒ‰é¡ºåºå°è¯•ï¼‰
    patterns_dir => ["/etc/logstash/patterns"]
    
    # ä¿ç•™åŸå§‹messageå­—æ®µ
    overwrite => ["timestamp"]
  }
}
```

### 4.4 è‡ªå®šä¹‰Grokæ¨¡å¼


#### ğŸ”¸ åˆ›å»ºè‡ªå®šä¹‰æ¨¡å¼æ–‡ä»¶

```bash
# /etc/logstash/patterns/custom_patterns
CUSTOM_TIMESTAMP %{YEAR}-%{MONTHNUM}-%{MONTHDAY} %{TIME}
LOGLEVEL (TRACE|DEBUG|INFO|WARN|ERROR|FATAL)
THREAD_NAME \[%{DATA:thread}\]
JAVA_CLASS [a-zA-Z0-9.$]+
METHOD_NAME [a-zA-Z0-9_]+

# å¤åˆæ¨¡å¼
JAVA_LOG_LINE %{CUSTOM_TIMESTAMP:timestamp} %{LOGLEVEL:level} %{THREAD_NAME} %{JAVA_CLASS:class} %{METHOD_NAME:method} - %{GREEDYDATA:message}
```

#### ğŸ”¸ ä½¿ç”¨è‡ªå®šä¹‰æ¨¡å¼

```ruby
filter {
  grok {
    patterns_dir => ["/etc/logstash/patterns"]
    match => { 
      "message" => "%{JAVA_LOG_LINE}"
    }
    
    # æµ‹è¯•æ¨¡å¼æ–‡ä»¶
    pattern_definitions => {
      "CUSTOM_FIELD" => "[A-Z]{3,10}"
    }
  }
}
```

### 4.5 Grokè°ƒè¯•ä¸ä¼˜åŒ–


#### ğŸ”¸ æµ‹è¯•å’Œè°ƒè¯•å·¥å…·

```bash
# 1. ä½¿ç”¨Grok Debuggerï¼ˆKibanaå†…ç½®ï¼‰
# è®¿é—®ï¼šhttp://kibana:5601/app/dev_tools#/grokdebugger

# 2. å‘½ä»¤è¡Œæµ‹è¯•
echo "test log line" | /usr/share/logstash/bin/logstash --config.test_and_exit --config.string 'input{stdin{}} filter{grok{match=>{"message"=>"%{GREEDYDATA:data}"}}} output{stdout{codec=>rubydebug}}'

# 3. é…ç½®æ–‡ä»¶è¯­æ³•æ£€æŸ¥
/usr/share/logstash/bin/logstash --config.test_and_exit --path.config=/etc/logstash/conf.d/
```

#### ğŸ”¸ æ€§èƒ½ä¼˜åŒ–å»ºè®®

```ruby
filter {
  grok {
    # æ€§èƒ½ä¼˜åŒ–é…ç½®
    match => { "message" => "%{COMBINEDAPACHELOG}" }
    
    # 1. é™åˆ¶å¤„ç†å­—æ®µå¤§å°
    tag_on_timeout => ["_groktimeout"]
    timeout_millis => 30000
    
    # 2. æå‰å¤±è´¥ï¼Œé¿å…ä¸å¿…è¦çš„å¤„ç†
    break_on_match => true              # åŒ¹é…æˆåŠŸååœæ­¢å°è¯•å…¶ä»–æ¨¡å¼
    
    # 3. ä½¿ç”¨æ¡ä»¶åˆ¤æ–­å‡å°‘ä¸å¿…è¦çš„å¤„ç†
    if [source] =~ /access\.log$/ {
      # åªå¯¹ç‰¹å®šæ–‡ä»¶æ‰§è¡ŒGrok
    }
  }
}
```

**Grokæ€§èƒ½ä¼˜åŒ–ç­–ç•¥ï¼š**
```
ğŸš€ æ¨¡å¼è®¾è®¡ä¼˜åŒ–ï¼š
â€¢ ä½¿ç”¨å…·ä½“æ¨¡å¼è€Œä¸æ˜¯%{DATA}æˆ–%{GREEDYDATA}
â€¢ å°†æœ€å¸¸åŒ¹é…çš„æ¨¡å¼æ”¾åœ¨å‰é¢
â€¢ é¿å…ä½¿ç”¨è¿‡äºå¤æ‚çš„æ­£åˆ™è¡¨è¾¾å¼

ğŸš€ é…ç½®ä¼˜åŒ–ï¼š
â€¢ å¯ç”¨break_on_matchå‡å°‘ä¸å¿…è¦çš„åŒ¹é…å°è¯•
â€¢ ä½¿ç”¨æ¡ä»¶åˆ¤æ–­å‡å°‘Grokæ‰§è¡Œæ¬¡æ•°
â€¢ è®¾ç½®åˆç†çš„timeouté¿å…é•¿æ—¶é—´é˜»å¡

ğŸš€ å­—æ®µä¼˜åŒ–ï¼š
â€¢ åªæå–éœ€è¦çš„å­—æ®µï¼Œä¸è¦"è´ªå¤š"
â€¢ åˆç†è®¾ç½®å­—æ®µæ•°æ®ç±»å‹
â€¢ åŠæ—¶åˆ é™¤ä¸éœ€è¦çš„ä¸´æ—¶å­—æ®µ
```

---

## 5. â° Dateæ’ä»¶æ—¶é—´å­—æ®µè§£æ


### 5.1 Dateæ’ä»¶åŸºæœ¬æ¦‚å¿µ


**ä¸ºä»€ä¹ˆéœ€è¦Dateæ’ä»¶ï¼Ÿ**
> Dateæ’ä»¶å°±åƒ"æ—¶é—´ç¿»è¯‘å®˜"ï¼ŒæŠŠå„ç§ä¸åŒæ ¼å¼çš„æ—¶é—´æ–‡æœ¬è½¬æ¢æˆElasticsearchèƒ½ç†è§£çš„æ ‡å‡†æ—¶é—´æ ¼å¼ï¼Œç¡®ä¿æ—¶é—´åºåˆ—åˆ†æçš„å‡†ç¡®æ€§ã€‚

```
æ—¶é—´æ ¼å¼è½¬æ¢è¿‡ç¨‹ï¼š
åŸå§‹æ—¶é—´ï¼š25/Dec/2023:10:15:32 +0000
         â†“ Dateæ’ä»¶å¤„ç†
æ ‡å‡†æ—¶é—´ï¼š2023-12-25T10:15:32.000Z (@timestampå­—æ®µ)

ä½œç”¨ï¼š
â€¢ ç»Ÿä¸€æ—¶é—´æ ¼å¼
â€¢ æ”¯æŒæ—¶åŒºè½¬æ¢  
â€¢ æä¾›æ—¶é—´åºåˆ—åˆ†æåŸºç¡€
â€¢ ç¡®ä¿æ—¥å¿—æŒ‰æ­£ç¡®æ—¶é—´æ’åº
```

### 5.2 Dateæ’ä»¶åŸºç¡€é…ç½®


#### ğŸ”¸ åŸºæœ¬è¯­æ³•ç»“æ„

```ruby
filter {
  date {
    match => [ "å­—æ®µå", "æ—¶é—´æ ¼å¼æ¨¡å¼1", "æ—¶é—´æ ¼å¼æ¨¡å¼2" ]
    target => "@timestamp"              # ç›®æ ‡å­—æ®µï¼ˆé»˜è®¤@timestampï¼‰
    timezone => "UTC"                   # æ—¶åŒºè®¾ç½®
    locale => "en"                      # åœ°åŒºè®¾ç½®
  }
}
```

#### ğŸ”¸ å¸¸è§æ—¶é—´æ ¼å¼é…ç½®

```ruby
filter {
  # Apache/Nginxæ—¥å¿—æ—¶é—´
  date {
    match => [ "timestamp", "dd/MMM/yyyy:HH:mm:ss Z" ]
  }
  
  # ISO8601æ ¼å¼
  date {
    match => [ "log_time", "ISO8601" ]
  }
  
  # è‡ªå®šä¹‰æ ¼å¼
  date {
    match => [ "custom_time", "yyyy-MM-dd HH:mm:ss.SSS" ]
  }
  
  # Unixæ—¶é—´æˆ³
  date {
    match => [ "unix_timestamp", "UNIX" ]
  }
  
  # Unixæ¯«ç§’æ—¶é—´æˆ³  
  date {
    match => [ "unix_ms", "UNIX_MS" ]
  }
}
```

### 5.3 æ—¶é—´æ ¼å¼æ¨¡å¼è¯¦è§£


#### ğŸ”¸ å¸¸ç”¨æ—¶é—´æ ¼å¼æ¨¡å¼

```
yyyyï¼š4ä½å¹´ä»½ï¼ˆ2023ï¼‰
MMï¼š2ä½æœˆä»½ï¼ˆ01-12ï¼‰  
ddï¼š2ä½æ—¥æœŸï¼ˆ01-31ï¼‰
HHï¼š24å°æ—¶åˆ¶å°æ—¶ï¼ˆ00-23ï¼‰
mmï¼šåˆ†é’Ÿï¼ˆ00-59ï¼‰
ssï¼šç§’é’Ÿï¼ˆ00-59ï¼‰
SSSï¼šæ¯«ç§’ï¼ˆ000-999ï¼‰
Zï¼šæ—¶åŒºåç§»ï¼ˆ+0800, -0500ï¼‰
XXXï¼šæ—¶åŒºåç§»å¸¦å†’å·ï¼ˆ+08:00ï¼‰

å¸¸è§ç»„åˆï¼š
yyyy-MM-dd HH:mm:ss          # 2023-12-25 10:15:32
dd/MMM/yyyy:HH:mm:ss Z       # 25/Dec/2023:10:15:32 +0000
yyyy-MM-dd'T'HH:mm:ss.SSSZ   # 2023-12-25T10:15:32.123+0000
MMM dd HH:mm:ss              # Dec 25 10:15:32 (syslog)
```

#### ğŸ”¸ å¤šæ ¼å¼åŒ¹é…é…ç½®

```ruby
filter {
  date {
    # æŒ‰é¡ºåºå°è¯•å¤šç§æ ¼å¼
    match => [ 
      "timestamp", 
      "dd/MMM/yyyy:HH:mm:ss Z",           # Apacheæ ¼å¼
      "yyyy-MM-dd HH:mm:ss",              # MySQLæ ¼å¼  
      "ISO8601",                          # æ ‡å‡†ISOæ ¼å¼
      "UNIX"                              # Unixæ—¶é—´æˆ³
    ]
    
    # è§£æå¤±è´¥æ—¶çš„å¤„ç†
    tag_on_failure => ["_dateparsefailure"]
  }
}
```

### 5.4 æ—¶åŒºå¤„ç†é…ç½®


#### ğŸ”¸ æ—¶åŒºè½¬æ¢é…ç½®

```ruby
filter {
  # æºæ•°æ®æ˜¯æœ¬åœ°æ—¶é—´ï¼Œè½¬æ¢ä¸ºUTC
  date {
    match => [ "local_time", "yyyy-MM-dd HH:mm:ss" ]
    timezone => "Asia/Shanghai"         # æºæ—¶åŒº
    target => "@timestamp"              # ç›®æ ‡å­—æ®µï¼ˆUTCæ—¶é—´ï¼‰
  }
  
  # ä¿ç•™åŸå§‹æ—¶åŒºä¿¡æ¯
  date {
    match => [ "timestamp", "dd/MMM/yyyy:HH:mm:ss Z" ]
    target => "@timestamp"
    add_field => { 
      "original_timezone" => "%{[timestamp]}"
      "parsed_timezone" => "UTC"
    }
  }
}
```

#### ğŸ”¸ å¤šæ—¶åŒºå¤„ç†ç­–ç•¥

```ruby
filter {
  # æ ¹æ®æ¥æºå†³å®šæ—¶åŒº
  if [server_location] == "beijing" {
    date {
      match => [ "timestamp", "yyyy-MM-dd HH:mm:ss" ]
      timezone => "Asia/Shanghai"
    }
  } else if [server_location] == "newyork" {
    date {
      match => [ "timestamp", "yyyy-MM-dd HH:mm:ss" ]  
      timezone => "America/New_York"
    }
  } else {
    date {
      match => [ "timestamp", "yyyy-MM-dd HH:mm:ss" ]
      timezone => "UTC"
    }
  }
}
```

### 5.5 Dateæ’ä»¶é«˜çº§é…ç½®


#### ğŸ”¸ è‡ªå®šä¹‰ç›®æ ‡å­—æ®µ

```ruby
filter {
  # åˆ›å»ºå¤šä¸ªæ—¶é—´å­—æ®µ
  date {
    match => [ "log_timestamp", "yyyy-MM-dd HH:mm:ss" ]
    target => "log_time"                # è‡ªå®šä¹‰å­—æ®µå
  }
  
  # ä¿ç•™åŸå§‹@timestampï¼Œåˆ›å»ºä¸šåŠ¡æ—¶é—´å­—æ®µ
  date {
    match => [ "business_time", "ISO8601" ]
    target => "business_timestamp"
    add_field => {
      "time_source" => "business_log"
    }
  }
}
```

#### ğŸ”¸ æ—¶é—´å­—æ®µéªŒè¯å’Œå¤„ç†

```ruby
filter {
  # æ—¶é—´èŒƒå›´éªŒè¯
  date {
    match => [ "timestamp", "yyyy-MM-dd HH:mm:ss" ]
    
    # éªŒè¯æ—¶é—´æ˜¯å¦åœ¨åˆç†èŒƒå›´å†…
    add_field => { "time_parsed" => "true" }
  }
  
  # æ—¶é—´è§£æå¤±è´¥çš„å¤„ç†
  if "_dateparsefailure" in [tags] {
    mutate {
      add_field => { 
        "parse_error" => "time_parse_failed"
        "original_timestamp" => "%{timestamp}"
      }
      # ä½¿ç”¨å½“å‰æ—¶é—´ä½œä¸ºfallback
      add_field => { "@timestamp" => "%{+yyyy-MM-dd'T'HH:mm:ss.SSSZ}" }
    }
  }
  
  # ç§»é™¤ä¸´æ—¶å­—æ®µ
  mutate {
    remove_field => ["timestamp"]
  }
}
```

### 5.6 Dateæ’ä»¶æœ€ä½³å®è·µ


```
ğŸ• æ—¶é—´å­—æ®µå¤„ç†æœ€ä½³å®è·µï¼š

å­—æ®µé€‰æ‹©ï¼š
âœ… ä¼˜å…ˆä½¿ç”¨æ—¥å¿—ä¸­çš„åŸå§‹æ—¶é—´
âœ… ç¡®ä¿æ—¶é—´å­—æ®µæ ¼å¼ä¸€è‡´
âœ… è€ƒè™‘æ—¶åŒºå½±å“

æ€§èƒ½ä¼˜åŒ–ï¼š
âœ… å°†æœ€å¸¸è§çš„æ ¼å¼æ”¾åœ¨matchæ•°ç»„çš„å‰é¢
âœ… ä½¿ç”¨æ¡ä»¶åˆ¤æ–­å‡å°‘ä¸å¿…è¦çš„è§£æ
âœ… åŠæ—¶ç§»é™¤ä¸´æ—¶æ—¶é—´å­—æ®µ

é”™è¯¯å¤„ç†ï¼š
âœ… è®¾ç½®tag_on_failureæ ‡ç­¾
âœ… ä¸ºè§£æå¤±è´¥æä¾›fallbackæœºåˆ¶
âœ… è®°å½•åŸå§‹æ—¶é—´å­—æ®µç”¨äºè°ƒè¯•

æ—¶åŒºç®¡ç†ï¼š
âœ… ç»Ÿä¸€ä½¿ç”¨UTCå­˜å‚¨
âœ… è®°å½•åŸå§‹æ—¶åŒºä¿¡æ¯
âœ… æ ¹æ®æ•°æ®æºè®¾ç½®æ­£ç¡®æ—¶åŒº
```

**æ—¶é—´å¤„ç†é…ç½®ç¤ºä¾‹ï¼š**
```ruby
filter {
  # å®Œæ•´çš„æ—¶é—´å¤„ç†pipeline
  grok {
    match => { "message" => "%{TIMESTAMP_ISO8601:raw_timestamp} %{GREEDYDATA:log_content}" }
  }
  
  date {
    match => [ "raw_timestamp", "ISO8601" ]
    target => "@timestamp"
    tag_on_failure => ["_dateparsefailure"]
  }
  
  if "_dateparsefailure" in [tags] {
    # è§£æå¤±è´¥æ—¶ä½¿ç”¨æ–‡ä»¶ä¿®æ”¹æ—¶é—´
    ruby {
      code => "event.set('@timestamp', Time.now)"
    }
    mutate {
      add_field => { "timestamp_source" => "current_time" }
    }
  } else {
    mutate {
      add_field => { "timestamp_source" => "log_content" }
      remove_field => ["raw_timestamp"]
    }
  }
}
```

---

## 6. ğŸ”§ Mutateæ’ä»¶å­—æ®µæ“ä½œ


### 6.1 Mutateæ’ä»¶åŸºæœ¬æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯Mutateæ’ä»¶ï¼Ÿ**
> Mutateæ’ä»¶å°±åƒ"æ•°æ®æ•´ç†å¸ˆ"ï¼Œè´Ÿè´£å¯¹å·²è§£æçš„å­—æ®µè¿›è¡Œå„ç§æ“ä½œï¼šé‡å‘½åã€ç±»å‹è½¬æ¢ã€æ·»åŠ åˆ é™¤ã€æ‹†åˆ†åˆå¹¶ç­‰ï¼Œè®©æ•°æ®å˜å¾—æ›´è§„æ•´ã€æ›´æœ‰ç”¨ã€‚

```
å­—æ®µæ“ä½œç±»å‹ï¼š
ğŸ“ æ·»åŠ å­—æ®µï¼šadd_field
ğŸ—‘ï¸ åˆ é™¤å­—æ®µï¼šremove_field  
ğŸ”„ é‡å‘½åï¼šrename
ğŸ”€ ç±»å‹è½¬æ¢ï¼šconvert
âœ‚ï¸ å­—ç¬¦ä¸²æ“ä½œï¼šgsub, split, join
ğŸ·ï¸ æ ‡ç­¾æ“ä½œï¼šadd_tag, remove_tag
```

### 6.2 åŸºç¡€å­—æ®µæ“ä½œ


#### ğŸ”¸ æ·»åŠ å’Œåˆ é™¤å­—æ®µ

```ruby
filter {
  mutate {
    # æ·»åŠ å›ºå®šå€¼å­—æ®µ
    add_field => { 
      "environment" => "production"
      "log_source" => "web_server"
      "parsed_at" => "%{+yyyy-MM-dd HH:mm:ss}"
    }
    
    # åˆ é™¤ä¸éœ€è¦çš„å­—æ®µ
    remove_field => [ 
      "message",           # åŸå§‹æ¶ˆæ¯ï¼ˆå·²è§£æï¼‰
      "host",              # ä¸»æœºä¿¡æ¯ï¼ˆå¦‚æœä¸éœ€è¦ï¼‰
      "@version"           # Logstashç‰ˆæœ¬ä¿¡æ¯
    ]
  }
}
```

#### ğŸ”¸ å­—æ®µé‡å‘½å

```ruby
filter {
  mutate {
    # é‡å‘½åå­—æ®µï¼Œä½¿å…¶æ›´æœ‰æ„ä¹‰
    rename => { 
      "clientip" => "client_ip"
      "verb" => "http_method"  
      "response" => "status_code"
      "agent" => "user_agent"
    }
  }
}
```

### 6.3 æ•°æ®ç±»å‹è½¬æ¢


#### ğŸ”¸ ç±»å‹è½¬æ¢é…ç½®

```ruby
filter {
  mutate {
    # æ•°æ®ç±»å‹è½¬æ¢
    convert => { 
      "status_code" => "integer"        # å­—ç¬¦ä¸²è½¬æ•´æ•°
      "response_time" => "float"        # å­—ç¬¦ä¸²è½¬æµ®ç‚¹æ•°
      "bytes" => "integer"              # å­—ç¬¦ä¸²è½¬æ•´æ•°
      "ssl_enabled" => "boolean"        # å­—ç¬¦ä¸²è½¬å¸ƒå°”å€¼
    }
  }
}
```

**æ”¯æŒçš„æ•°æ®ç±»å‹ï¼š**
```
integerï¼šæ•´æ•°
floatï¼šæµ®ç‚¹æ•°  
stringï¼šå­—ç¬¦ä¸²ï¼ˆé»˜è®¤ï¼‰
booleanï¼šå¸ƒå°”å€¼ï¼ˆtrue/falseï¼‰
arrayï¼šæ•°ç»„

ç¤ºä¾‹ï¼š
"123" â†’ 123 (integer)
"3.14" â†’ 3.14 (float)  
"true" â†’ true (boolean)
"a,b,c" â†’ ["a","b","c"] (arrayï¼Œé…åˆsplitä½¿ç”¨)
```

#### ğŸ”¸ æ¡ä»¶ç±»å‹è½¬æ¢

```ruby
filter {
  mutate {
    # åªå¯¹æ•°å­—æ ¼å¼çš„å­—æ®µè¿›è¡Œè½¬æ¢
    convert => { "response_time" => "float" }
  }
  
  # å¤„ç†è½¬æ¢å¤±è´¥çš„æƒ…å†µ
  if [response_time] !~ /^[0-9]+\.?[0-9]*$/ {
    mutate {
      add_tag => ["invalid_response_time"]
      remove_field => ["response_time"]
    }
  }
}
```

### 6.4 å­—ç¬¦ä¸²æ“ä½œ


#### ğŸ”¸ å­—ç¬¦ä¸²æ›¿æ¢ï¼ˆgsubï¼‰

```ruby
filter {
  mutate {
    # å­—ç¬¦ä¸²æ›¿æ¢ï¼šgsub => ["å­—æ®µå", "æ­£åˆ™æ¨¡å¼", "æ›¿æ¢å€¼"]
    gsub => [
      "user_agent", '"', "",            # åˆ é™¤åŒå¼•å·
      "url", "\?.*", "",                # åˆ é™¤URLå‚æ•°  
      "message", "\n", " ",             # æ¢è¡Œç¬¦æ›¿æ¢ä¸ºç©ºæ ¼
      "phone", "(\d{3})(\d{4})(\d{4})", '\1-\2-\3'  # æ‰‹æœºå·æ ¼å¼åŒ–
    ]
  }
}
```

#### ğŸ”¸ å­—ç¬¦ä¸²æ‹†åˆ†å’Œåˆå¹¶

```ruby
filter {
  mutate {
    # æ‹†åˆ†å­—ç¬¦ä¸²ä¸ºæ•°ç»„
    split => { 
      "tags_string" => ","              # æŒ‰é€—å·æ‹†åˆ†
      "path" => "/"                     # æŒ‰æ–œæ æ‹†åˆ†è·¯å¾„
    }
    
    # åˆå¹¶å­—æ®µ
    join => { 
      "error_codes" => ","              # æ•°ç»„åˆå¹¶ä¸ºå­—ç¬¦ä¸²
    }
  }
}
```

### 6.5 æ ‡ç­¾å’Œå…ƒæ•°æ®æ“ä½œ


#### ğŸ”¸ æ ‡ç­¾æ“ä½œ

```ruby
filter {
  mutate {
    # æ·»åŠ æ ‡ç­¾
    add_tag => [ "processed", "web_log" ]
    
    # åˆ é™¤æ ‡ç­¾
    remove_tag => [ "_grokparsefailure" ]
    
    # æ¡ä»¶æ ‡ç­¾æ“ä½œ
    add_tag => [ "slow_request" ]       # é…åˆæ¡ä»¶åˆ¤æ–­ä½¿ç”¨
  }
}
```

#### ğŸ”¸ æ¡ä»¶æ ‡ç­¾åº”ç”¨

```ruby
filter {
  # æ ¹æ®çŠ¶æ€ç æ·»åŠ æ ‡ç­¾
  if [status_code] >= 400 and [status_code] < 500 {
    mutate {
      add_tag => [ "client_error", "4xx" ]
    }
  } else if [status_code] >= 500 {
    mutate {
      add_tag => [ "server_error", "5xx" ]
    }
  } else if [status_code] >= 200 and [status_code] < 300 {
    mutate {
      add_tag => [ "success", "2xx" ]
    }
  }
  
  # æ ¹æ®å“åº”æ—¶é—´æ·»åŠ æ ‡ç­¾
  if [response_time] and [response_time] > 1000 {
    mutate {
      add_tag => [ "slow_response" ]
      add_field => { "performance_category" => "slow" }
    }
  }
}
```

### 6.6 é«˜çº§å­—æ®µæ“ä½œ


#### ğŸ”¸ å­—æ®µå¤åˆ¶å’Œç»„åˆ

```ruby
filter {
  mutate {
    # å¤åˆ¶å­—æ®µ
    copy => { "original_message" => "backup_message" }
    
    # ç»„åˆå¤šä¸ªå­—æ®µåˆ›å»ºæ–°å­—æ®µ
    add_field => { 
      "full_url" => "%{protocol}://%{host}%{path}"
      "user_session" => "%{user_id}_%{session_id}"
      "log_identifier" => "%{@timestamp}_%{host}_%{pid}"
    }
  }
}
```

#### ğŸ”¸ å­—æ®µæ ¼å¼åŒ–

```ruby
filter {
  mutate {
    # å­—ç¬¦ä¸²æ ¼å¼åŒ–
    uppercase => [ "method" ]           # è½¬å¤§å†™
    lowercase => [ "hostname" ]         # è½¬å°å†™
    capitalize => [ "service_name" ]    # é¦–å­—æ¯å¤§å†™
    
    # å»é™¤ç©ºæ ¼
    strip => [ "user_name", "password" ]
    
    # å­—ç¬¦ä¸²æ“ä½œç»„åˆ
    gsub => [
      "email", "\s+", "",               # åˆ é™¤æ‰€æœ‰ç©ºæ ¼
      "phone", "[^\d]", ""              # åªä¿ç•™æ•°å­—
    ]
  }
}
```

### 6.7 Mutateæ’ä»¶æ‰§è¡Œé¡ºåº


**é‡è¦æ¦‚å¿µï¼šMutateæ“ä½œçš„æ‰§è¡Œé¡ºåºæ˜¯å›ºå®šçš„**
```ruby
filter {
  mutate {
    # æ‰§è¡Œé¡ºåºï¼ˆä¸ç®¡é…ç½®æ–‡ä»¶ä¸­çš„é¡ºåºï¼‰ï¼š
    rename => { ... }          # 1. é‡å‘½å
    update => { ... }          # 2. æ›´æ–°
    replace => { ... }         # 3. æ›¿æ¢
    convert => { ... }         # 4. ç±»å‹è½¬æ¢
    gsub => [ ... ]            # 5. å­—ç¬¦ä¸²æ›¿æ¢
    uppercase => [ ... ]       # 6. å¤§å†™è½¬æ¢
    lowercase => [ ... ]       # 7. å°å†™è½¬æ¢
    strip => [ ... ]           # 8. å»é™¤ç©ºæ ¼
    remove_field => [ ... ]    # 9. åˆ é™¤å­—æ®µ
    remove_tag => [ ... ]      # 10. åˆ é™¤æ ‡ç­¾
    add_field => { ... }       # 11. æ·»åŠ å­—æ®µ
    add_tag => [ ... ]         # 12. æ·»åŠ æ ‡ç­¾
  }
}
```

#### ğŸ”¸ å¤šæ­¥éª¤Mutateé…ç½®

```ruby
filter {
  # ç¬¬ä¸€æ­¥ï¼šåŸºç¡€æ¸…ç†
  mutate {
    rename => { "msg" => "message" }
    strip => [ "message" ]
    lowercase => [ "level" ]
  }
  
  # ç¬¬äºŒæ­¥ï¼šç±»å‹è½¬æ¢
  mutate {
    convert => { 
      "status" => "integer"
      "duration" => "float"
    }
  }
  
  # ç¬¬ä¸‰æ­¥ï¼šæœ€ç»ˆå¤„ç†
  mutate {
    remove_field => [ "temp_field" ]
    add_tag => [ "processed" ]
  }
}
```

### 6.8 Mutateæ’ä»¶æœ€ä½³å®è·µ


```
ğŸ¯ å­—æ®µæ“ä½œæœ€ä½³å®è·µï¼š

æ€§èƒ½ä¼˜åŒ–ï¼š
âœ… åˆå¹¶ç›¸åŒç±»å‹çš„æ“ä½œåˆ°ä¸€ä¸ªmutateå—
âœ… æŒ‰æ‰§è¡Œé¡ºåºç»„ç»‡æ“ä½œ
âœ… åŠæ—¶åˆ é™¤ä¸éœ€è¦çš„å­—æ®µ

æ•°æ®è´¨é‡ï¼š
âœ… åœ¨ç±»å‹è½¬æ¢å‰éªŒè¯æ•°æ®æ ¼å¼
âœ… ä¸ºå…³é”®å­—æ®µè®¾ç½®é»˜è®¤å€¼
âœ… ä½¿ç”¨æ¡ä»¶åˆ¤æ–­å¤„ç†ç‰¹æ®Šæƒ…å†µ

å­—æ®µå‘½åï¼š
âœ… ä½¿ç”¨ä¸€è‡´çš„å‘½åè§„èŒƒï¼ˆsnake_caseï¼‰
âœ… å­—æ®µåè¦æœ‰æè¿°æ€§
âœ… é¿å…ä½¿ç”¨ç³»ç»Ÿä¿ç•™å­—æ®µå

é”™è¯¯å¤„ç†ï¼š
âœ… å¯¹å…³é”®æ“ä½œæ·»åŠ é”™è¯¯æ ‡ç­¾
âœ… ä¿ç•™åŸå§‹æ•°æ®ç”¨äºè°ƒè¯•
âœ… ä¸ºå¤±è´¥æƒ…å†µæä¾›fallback
```

**å®Œæ•´çš„å­—æ®µå¤„ç†ç¤ºä¾‹ï¼š**
```ruby
filter {
  # æ­¥éª¤1ï¼šåŸºç¡€å­—æ®µå¤„ç†
  mutate {
    rename => { 
      "msg" => "message"
      "lvl" => "level" 
    }
    strip => [ "message", "level", "service" ]
    lowercase => [ "level", "service" ]
  }
  
  # æ­¥éª¤2ï¼šæ•°æ®éªŒè¯å’Œè½¬æ¢
  if [response_time] =~ /^[0-9]+\.?[0-9]*$/ {
    mutate {
      convert => { "response_time" => "float" }
    }
  } else {
    mutate {
      add_tag => [ "invalid_response_time" ]
      remove_field => [ "response_time" ]
    }
  }
  
  # æ­¥éª¤3ï¼šä¸šåŠ¡é€»è¾‘å¤„ç†
  mutate {
    add_field => {
      "log_category" => "%{level}_%{service}"
      "processed_at" => "%{+yyyy-MM-dd HH:mm:ss}"
    }
  }
  
  # æ­¥éª¤4ï¼šæœ€ç»ˆæ¸…ç†
  mutate {
    remove_field => [ "@version", "path", "host" ]
    add_tag => [ "mutate_processed" ]
  }
}
```

---

## 7. ğŸ“¤ Outputæ’ä»¶è¾“å‡ºé…ç½®


### 7.1 Outputæ’ä»¶åŸºæœ¬æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯Outputæ’ä»¶ï¼Ÿ**
> Outputæ’ä»¶å°±åƒ"å¿«é€’åˆ†å‘ä¸­å¿ƒ"ï¼ŒæŠŠå¤„ç†å¥½çš„æ•°æ®æŒ‰ç…§ä¸åŒçš„éœ€æ±‚å‘é€åˆ°å„ä¸ªç›®æ ‡ä½ç½®ï¼šå­˜å‚¨åˆ°æ•°æ®åº“ã€å†™å…¥æ–‡ä»¶ã€å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—ç­‰ã€‚

```
æ•°æ®è¾“å‡ºæµå‘ï¼š
å¤„ç†åçš„æ•°æ® â†’ Outputæ’ä»¶ â†’ ç›®æ ‡ç³»ç»Ÿ

å¸¸è§ç›®æ ‡ç³»ç»Ÿï¼š
ğŸ” Elasticsearchï¼šç”¨äºæœç´¢å’Œåˆ†æ
ğŸ“ æ–‡ä»¶ç³»ç»Ÿï¼šç”¨äºå¤‡ä»½å’Œå½’æ¡£
ğŸ“Š Kafkaï¼šç”¨äºæ¶ˆæ¯ä¼ é€’
ğŸ“§ Emailï¼šç”¨äºå‘Šè­¦é€šçŸ¥
ğŸ’¾ æ•°æ®åº“ï¼šç”¨äºæŒä¹…åŒ–å­˜å‚¨
```

### 7.2 Elasticsearchè¾“å‡ºé…ç½®


#### ğŸ”¸ åŸºç¡€Elasticsearché…ç½®

```ruby
output {
  elasticsearch {
    hosts => ["localhost:9200"]         # ESé›†ç¾¤åœ°å€
    index => "logs-%{+YYYY.MM.dd}"      # ç´¢å¼•åç§°ï¼ˆæŒ‰æ—¥æœŸï¼‰
    
    # æ–‡æ¡£é…ç½®
    document_type => "_doc"             # æ–‡æ¡£ç±»å‹ï¼ˆES 7.x+é»˜è®¤ï¼‰
    document_id => "%{[@metadata][fingerprint]}"  # è‡ªå®šä¹‰æ–‡æ¡£ID
    
    # æ€§èƒ½é…ç½®
    workers => 4                        # å¹¶å‘å·¥ä½œçº¿ç¨‹
    flush_size => 500                   # æ‰¹é‡å‘é€å¤§å°
    idle_flush_time => 1                # ç©ºé—²åˆ·æ–°æ—¶é—´ï¼ˆç§’ï¼‰
  }
}
```

#### ğŸ”¸ é«˜çº§Elasticsearché…ç½®

```ruby
output {
  elasticsearch {
    hosts => [
      "es-node1:9200",
      "es-node2:9200", 
      "es-node3:9200"
    ]
    
    # è´Ÿè½½å‡è¡¡å’Œå®¹é”™
    sniffing => true                    # è‡ªåŠ¨å‘ç°é›†ç¾¤èŠ‚ç‚¹
    sniffing_delay => 5                 # èŠ‚ç‚¹å‘ç°é—´éš”
    resurrect_delay => 5                # å¤±è´¥èŠ‚ç‚¹é‡è¯•é—´éš”
    
    # å®‰å…¨é…ç½®
    ssl => true
    ssl_certificate_verification => false
    user => "logstash_writer"
    password => "password123"
    
    # ç´¢å¼•æ¨¡æ¿å’Œæ˜ å°„
    index => "app-logs-%{+YYYY.MM.dd}"
    template_name => "app-logs"
    template_pattern => "app-logs-*"
    template_overwrite => true
    
    # æ€§èƒ½ä¼˜åŒ–
    pool_max => 1000                    # è¿æ¥æ± å¤§å°
    pool_max_per_route => 100          # æ¯è·¯ç”±æœ€å¤§è¿æ¥
    request_timeout => 60               # è¯·æ±‚è¶…æ—¶
    retry_max_interval => 64            # é‡è¯•æœ€å¤§é—´éš”
  }
}
```

### 7.3 æ–‡ä»¶è¾“å‡ºé…ç½®


#### ğŸ”¸ åŸºç¡€æ–‡ä»¶è¾“å‡º

```ruby
output {
  file {
    path => "/var/log/logstash/output.log"
    
    # æ–‡ä»¶æ ¼å¼é…ç½®
    codec => json_lines               # JSONæ ¼å¼ï¼Œæ¯è¡Œä¸€ä¸ª
    
    # æ–‡ä»¶è½®è½¬é…ç½®
    flush_interval => 0               # ç«‹å³åˆ·æ–°åˆ°ç£ç›˜
    sync => true                      # åŒæ­¥å†™å…¥
  }
}
```

#### ğŸ”¸ é«˜çº§æ–‡ä»¶è¾“å‡ºé…ç½®

```ruby
output {
  file {
    # åŠ¨æ€æ–‡ä»¶è·¯å¾„ï¼ˆæŒ‰æ—¥æœŸå’Œç±»å‹åˆ†æ–‡ä»¶ï¼‰
    path => "/logs/%{service}/%{+YYYY}/%{+MM}/%{+dd}/%{service}-%{+HH}.log"
    
    # æ–‡ä»¶æ ¼å¼
    codec => line {
      format => "%{@timestamp} [%{level}] %{service}: %{message}"
    }
    
    # æ–‡ä»¶ç®¡ç†
    flush_interval => 2               # 2ç§’åˆ·æ–°ä¸€æ¬¡
    gzip => true                      # å¯ç”¨å‹ç¼©
    
    # æƒé™è®¾ç½®
    file_mode => 0644                 # æ–‡ä»¶æƒé™
    dir_mode => 0755                  # ç›®å½•æƒé™
  }
}
```

### 7.4 Kafkaè¾“å‡ºé…ç½®


```ruby
output {
  kafka {
    bootstrap_servers => [
      "kafka1:9092",
      "kafka2:9092", 
      "kafka3:9092"
    ]
    
    # Topicé…ç½®
    topic_id => "logstash-logs"
    
    # æ¶ˆæ¯æ ¼å¼
    codec => json
    
    # æ€§èƒ½é…ç½®
    batch_size => 16384               # æ‰¹é‡å¤§å°
    linger_ms => 10                   # å‘é€å»¶è¿Ÿ
    compression_type => "snappy"      # å‹ç¼©ç®—æ³•
    
    # å¯é æ€§é…ç½®
    acks => "all"                     # æ‰€æœ‰å‰¯æœ¬ç¡®è®¤
    retries => 3                      # é‡è¯•æ¬¡æ•°
    retry_backoff_ms => 300          # é‡è¯•é—´éš”
    
    # åˆ†åŒºé…ç½®
    partition_key_format => "%{host}" # æŒ‰ä¸»æœºåˆ†åŒº
  }
}
```

### 7.5 å¤šè·¯è¾“å‡ºé…ç½®


#### ğŸ”¸ åŸºäºæ¡ä»¶çš„å¤šè·¯è¾“å‡º

```ruby
output {
  # é”™è¯¯æ—¥å¿—å‘é€åˆ°å‘Šè­¦ç³»ç»Ÿ
  if [level] == "ERROR" or [level] == "FATAL" {
    email {
      to => ["admin@company.com"]
      subject => "Critical Error: %{service}"
      body => "Error occurred at %{@timestamp}: %{message}"
    }
  }
  
  # æ‰€æœ‰æ—¥å¿—å­˜å‚¨åˆ°Elasticsearch
  elasticsearch {
    hosts => ["localhost:9200"]
    index => "logs-%{service}-%{+YYYY.MM.dd}"
  }
  
  # WebæœåŠ¡æ—¥å¿—é¢å¤–å†™å…¥æ–‡ä»¶
  if "web" in [tags] {
    file {
      path => "/backup/web-logs-%{+YYYY.MM.dd}.log"
      codec => json_lines
    }
  }
  
  # è°ƒè¯•æ¨¡å¼ä¸‹è¾“å‡ºåˆ°æ§åˆ¶å°
  if [debug] == true {
    stdout {
      codec => rubydebug
    }
  }
}
```

#### ğŸ”¸ åŸºäºæœåŠ¡ç±»å‹çš„è¾“å‡ºåˆ†å‘

```ruby
output {
  # åº”ç”¨æ—¥å¿— â†’ Elasticsearch
  if [log_type] == "application" {
    elasticsearch {
      hosts => ["es-app:9200"]
      index => "app-logs-%{+YYYY.MM.dd}"
    }
  }
  
  # ç³»ç»Ÿæ—¥å¿— â†’ Splunk
  else if [log_type] == "system" {
    tcp {
      host => "splunk-server"
      port => 5514
      codec => json
    }
  }
  
  # å®‰å…¨æ—¥å¿— â†’ ä¸“é—¨çš„å®‰å…¨ä¸­å¿ƒ
  else if [log_type] == "security" {
    http {
      url => "https://security-center/api/events"
      http_method => "post"
      format => "json"
      headers => {
        "Authorization" => "Bearer %{security_token}"
      }
    }
  }
  
  # æ‰€æœ‰æ—¥å¿—å¤‡ä»½åˆ°æ–‡ä»¶
  file {
    path => "/backup/all-logs-%{+YYYY.MM.dd}.log"
    codec => json_lines
  }
}
```

### 7.6 è¾“å‡ºæ’ä»¶æ€§èƒ½ä¼˜åŒ–


#### ğŸ”¸ æ‰¹é‡å¤„ç†ä¼˜åŒ–

```ruby
output {
  elasticsearch {
    hosts => ["localhost:9200"]
    
    # æ‰¹é‡ä¼˜åŒ–é…ç½®
    flush_size => 1000                # æ‰¹é‡å¤§å°
    idle_flush_time => 5              # ç©ºé—²åˆ·æ–°æ—¶é—´
    workers => 8                      # å·¥ä½œçº¿ç¨‹æ•°
    
    # å†…å­˜ç®¡ç†
    pipeline_batch_size => 125        # Pipelineæ‰¹æ¬¡å¤§å°
    pipeline_batch_delay => 50        # Pipelineå»¶è¿Ÿ
  }
}
```

#### ğŸ”¸ å®¹é”™å’Œé‡è¯•é…ç½®

```ruby
output {
  elasticsearch {
    hosts => ["localhost:9200"]
    
    # é‡è¯•é…ç½®
    retry_initial_interval => 2       # åˆå§‹é‡è¯•é—´éš”
    retry_max_interval => 64          # æœ€å¤§é‡è¯•é—´éš”  
    retry_forever => true             # æ°¸ä¹…é‡è¯•
    
    # å¤±è´¥å¤„ç†
    action => "index"                 # é»˜è®¤æ“ä½œ
    failure_type_logging_whitelist => ["index_create_failure"]
    
    # æ­»ä¿¡é˜Ÿåˆ—
    dead_letter_queue_enable => true
    dead_letter_queue_max_bytes => "1gb"
  }
}
```

### 7.7 è¾“å‡ºè°ƒè¯•å’Œç›‘æ§


#### ğŸ”¸ è°ƒè¯•è¾“å‡ºé…ç½®

```ruby
output {
  # è°ƒè¯•æ—¶ä½¿ç”¨stdout
  if [@metadata][debug] {
    stdout {
      codec => rubydebug {
        metadata => true              # æ˜¾ç¤ºmetadataå­—æ®µ
      }
    }
  }
  
  # ç”Ÿäº§ç¯å¢ƒè¾“å‡º
  else {
    elasticsearch {
      hosts => ["localhost:9200"]
      index => "production-logs-%{+YYYY.MM.dd}"
    }
  }
}
```

#### ğŸ”¸ è¾“å‡ºç›‘æ§é…ç½®

```ruby
output {
  elasticsearch {
    hosts => ["localhost:9200"]
    index => "logs-%{+YYYY.MM.dd}"
    
    # ç›‘æ§é…ç½®
    manage_template => true
    template_name => "logstash"
    
    # å¥åº·æ£€æŸ¥
    healthcheck_url => "http://localhost:9200/_cluster/health"
    healthcheck_timeout => 5
  }
  
  # ç»Ÿè®¡ä¿¡æ¯è¾“å‡º
  statsd {
    host => "statsd-server"
    port => 8125
    gauge => {
      "logstash.events.processed" => "1"
    }
  }
}
```

---

## 8. ğŸ”€ æ¡ä»¶åˆ¤æ–­ä¸å¤šè·¯è¾“å‡º


### 8.1 æ¡ä»¶åˆ¤æ–­åŸºæœ¬æ¦‚å¿µ


**ä»€ä¹ˆæ˜¯æ¡ä»¶åˆ¤æ–­ï¼Ÿ**
> æ¡ä»¶åˆ¤æ–­å°±åƒ"äº¤é€šæŒ‡æŒ¥å‘˜"ï¼Œæ ¹æ®æ•°æ®çš„ä¸åŒç‰¹å¾ï¼Œå†³å®šæ•°æ®åº”è¯¥èµ°å“ªæ¡"é“è·¯"ï¼Œæ¥å—ä»€ä¹ˆæ ·çš„å¤„ç†ã€‚

```
æ¡ä»¶åˆ¤æ–­åº”ç”¨åœºæ™¯ï¼š
ğŸ¯ æŒ‰æ—¥å¿—çº§åˆ«åˆ†ç±»å¤„ç†
ğŸ¯ æŒ‰æœåŠ¡ç±»å‹è·¯ç”±åˆ°ä¸åŒå­˜å‚¨
ğŸ¯ æŒ‰é”™è¯¯ä¸¥é‡ç¨‹åº¦è§¦å‘ä¸åŒå‘Šè­¦
ğŸ¯ æŒ‰æ•°æ®æ¥æºåº”ç”¨ä¸åŒè§£æè§„åˆ™

è¯­æ³•ç»“æ„ï¼š
if æ¡ä»¶è¡¨è¾¾å¼ {
  # æ‰§è¡Œæ“ä½œ
} else if å…¶ä»–æ¡ä»¶ {
  # æ‰§è¡Œå…¶ä»–æ“ä½œ  
} else {
  # é»˜è®¤æ“ä½œ
}
```

### 8.2 æ¡ä»¶è¡¨è¾¾å¼è¯­æ³•


#### ğŸ”¸ åŸºç¡€æ¯”è¾ƒæ“ä½œ

```ruby
filter {
  # ç­‰äºæ¯”è¾ƒ
  if [status_code] == 200 {
    mutate { add_tag => ["success"] }
  }
  
  # ä¸ç­‰äºæ¯”è¾ƒ
  if [level] != "DEBUG" {
    mutate { add_tag => ["important"] }
  }
  
  # æ•°å€¼æ¯”è¾ƒ
  if [response_time] > 1000 {
    mutate { add_tag => ["slow"] }
  }
  
  if [bytes] >= 1048576 {  # 1MB
    mutate { add_tag => ["large_response"] }
  }
}
```

#### ğŸ”¸ æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…

```ruby
filter {
  # æ­£åˆ™åŒ¹é…
  if [message] =~ /ERROR|FATAL/ {
    mutate { add_tag => ["error_log"] }
  }
  
  # æ­£åˆ™ä¸åŒ¹é…
  if [url] !~ /\.(css|js|png|jpg)$/ {
    mutate { add_tag => ["dynamic_content"] }
  }
  
  # å¤§å°å†™ä¸æ•æ„ŸåŒ¹é…
  if [user_agent] =~ /(?i)mobile|android|iphone/ {
    mutate { add_tag => ["mobile_device"] }
  }
}
```

#### ğŸ”¸ å­—æ®µå­˜åœ¨æ€§æ£€æŸ¥

```ruby
filter {
  # å­—æ®µå­˜åœ¨
  if [user_id] {
    mutate { add_tag => ["authenticated"] }
  }
  
  # å­—æ®µä¸å­˜åœ¨
  if ![session_id] {
    mutate { 
      add_field => { "session_id" => "anonymous" }
    }
  }
  
  # å­—æ®µä¸ºç©ºæˆ–ä¸å­˜åœ¨
  if [email] == "" or ![email] {
    mutate { add_tag => ["no_email"] }
  }
}
```

### 8.3 é€»è¾‘è¿ç®—ç¬¦


#### ğŸ”¸ AND/OR/NOTé€»è¾‘

```ruby
filter {
  # AND æ“ä½œ
  if [status_code] >= 400 and [status_code] < 500 {
    mutate { add_tag => ["client_error"] }
  }
  
  # OR æ“ä½œ
  if [method] == "POST" or [method] == "PUT" or [method] == "DELETE" {
    mutate { add_tag => ["write_operation"] }
  }
  
  # NOT æ“ä½œ
  if [level] != "DEBUG" and [level] != "TRACE" {
    mutate { add_tag => ["important_log"] }
  }
  
  # å¤åˆæ¡ä»¶
  if ([level] == "ERROR" or [level] == "FATAL") and [service] == "payment" {
    mutate { add_tag => ["critical_payment_error"] }
  }
}
```

#### ğŸ”¸ æ•°ç»„å’Œæ ‡ç­¾æ“ä½œ

```ruby
filter {
  # æ•°ç»„åŒ…å«æ£€æŸ¥
  if "nginx" in [tags] {
    grok {
      match => { "message" => "%{NGINXACCESS}" }
    }
  }
  
  # å¤šæ ‡ç­¾æ£€æŸ¥
  if "web" in [tags] and "production" in [tags] {
    mutate { add_tag => ["prod_web"] }
  }
  
  # å­—æ®µå€¼åœ¨æ•°ç»„ä¸­
  if [status_code] in [200, 201, 202, 204] {
    mutate { add_tag => ["success_response"] }
  }
}
```

### 8.4 å¤æ‚æ¡ä»¶åˆ¤æ–­ç¤ºä¾‹


#### ğŸ”¸ å¤šå±‚æ¡ä»¶åµŒå¥—

```ruby
filter {
  # åŸºäºæœåŠ¡ç±»å‹çš„åˆ†å±‚å¤„ç†
  if [service_type] == "web" {
    if [status_code] >= 500 {
      mutate { 
        add_tag => ["web_server_error"]
        add_field => { "alert_level" => "high" }
      }
    } else if [status_code] >= 400 {
      mutate { 
        add_tag => ["web_client_error"]
        add_field => { "alert_level" => "medium" }
      }
    } else {
      mutate { add_tag => ["web_normal"] }
    }
  } else if [service_type] == "database" {
    if [query_time] > 5000 {  # 5ç§’
      mutate { 
        add_tag => ["slow_query"]
        add_field => { "alert_level" => "high" }
      }
    }
  } else if [service_type] == "cache" {
    if [hit_rate] < 0.8 {  # å‘½ä¸­ç‡ä½äº80%
      mutate { 
        add_tag => ["low_cache_hit"]
        add_field => { "alert_level" => "medium" }
      }
    }
  }
}
```

#### ğŸ”¸ æ—¶é—´èŒƒå›´æ¡ä»¶åˆ¤æ–­

```ruby
filter {
  # å·¥ä½œæ—¶é—´åˆ¤æ–­
  ruby {
    code => "
      hour = event.get('@timestamp').hour
      day_of_week = event.get('@timestamp').wday
      
      # å·¥ä½œæ—¶é—´ï¼šå‘¨ä¸€åˆ°å‘¨äº”ï¼Œ9ç‚¹åˆ°18ç‚¹
      if day_of_week >= 1 and day_of_week <= 5 and hour >= 9 and hour <= 18
        event.set('business_hours', true)
      else
        event.set('business_hours', false)
      end
    "
  }
  
  # åŸºäºæ—¶é—´çš„å¤„ç†ç­–ç•¥
  if [business_hours] == true {
    if [level] == "ERROR" {
      mutate { add_tag => ["business_hour_error"] }
    }
  } else {
    if [level] == "ERROR" {
      mutate { add_tag => ["after_hour_error"] }
    }
  }
}
```

### 8.5 å¤šè·¯è¾“å‡ºå®ç°


#### ğŸ”¸ åŸºäºæ—¥å¿—çº§åˆ«çš„å¤šè·¯è¾“å‡º

```ruby
output {
  # ä¸¥é‡é”™è¯¯ â†’ ç«‹å³å‘Šè­¦
  if [level] == "FATAL" or [level] == "ERROR" {
    # å‘é€é‚®ä»¶å‘Šè­¦
    email {
      to => ["oncall@company.com", "admin@company.com"]
      subject => "[ALERT] %{level} in %{service}"
      body => "Time: %{@timestamp}\nService: %{service}\nMessage: %{message}\nHost: %{host}"
      smtp_host => "smtp.company.com"
      smtp_port => 587
    }
    
    # å‘é€åˆ°å‘Šè­¦ç³»ç»Ÿ
    http {
      url => "https://alertmanager.company.com/api/v1/alerts"
      http_method => "post"
      format => "json"
      mapping => {
        "labels" => {
          "alertname" => "LogstashError"
          "severity" => "%{level}"
          "service" => "%{service}"
          "instance" => "%{host}"
        }
        "annotations" => {
          "summary" => "%{message}"
          "description" => "Error occurred at %{@timestamp}"
        }
      }
    }
  }
  
  # è­¦å‘Šçº§åˆ« â†’ å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ
  if [level] == "WARN" {
    kafka {
      bootstrap_servers => ["kafka:9092"]
      topic_id => "warning-logs"
      codec => json
    }
  }
  
  # æ‰€æœ‰æ—¥å¿— â†’ å­˜å‚¨åˆ°Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "%{service}-logs-%{+YYYY.MM.dd}"
  }
  
  # è°ƒè¯•æ—¥å¿— â†’ å•ç‹¬å­˜å‚¨ï¼Œä¿ç•™æ—¶é—´çŸ­
  if [level] == "DEBUG" or [level] == "TRACE" {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "debug-logs-%{+YYYY.MM.dd}"
      # è®¾ç½®ç´¢å¼•ç”Ÿå‘½å‘¨æœŸç­–ç•¥ï¼Œ7å¤©ååˆ é™¤
      ilm_rollover_alias => "debug-logs"
      ilm_pattern => "{now/d}-000001"
      ilm_policy => "debug-logs-policy"
    }
  }
}
```

#### ğŸ”¸ åŸºäºæœåŠ¡ç±»å‹çš„æ™ºèƒ½è·¯ç”±

```ruby
output {
  # WebæœåŠ¡æ—¥å¿—å¤„ç†
  if "web" in [tags] {
    # å­˜å‚¨åˆ°ä¸“é—¨çš„Webæ—¥å¿—ç´¢å¼•
    elasticsearch {
      hosts => ["es-web:9200"]
      index => "web-access-%{+YYYY.MM.dd}"
      template_name => "web-access"
      template_pattern => "web-access-*"
    }
    
    # è®¿é—®ç»Ÿè®¡å‘é€åˆ°InfluxDB
    influxdb {
      host => "influxdb"
      port => 8086
      database => "web_metrics"
      measurement => "access_logs"
      send_as_tags => ["method", "status_code", "host"]
      coerce_values => {
        "response_time" => "float"
        "bytes" => "integer"
      }
    }
  }
  
  # æ•°æ®åº“æ—¥å¿—å¤„ç†
  if "database" in [tags] {
    # æ…¢æŸ¥è¯¢æ—¥å¿—ç‰¹æ®Šå¤„ç†
    if [query_time] and [query_time] > 1000 {
      file {
        path => "/logs/slow-queries/%{database}-%{+YYYY.MM.dd}.log"
        codec => line {
          format => "%{@timestamp} [%{query_time}ms] %{database}: %{query}"
        }
      }
    }
    
    # æ‰€æœ‰æ•°æ®åº“æ—¥å¿—
    elasticsearch {
      hosts => ["es-db:9200"]
      index => "database-logs-%{+YYYY.MM.dd}"
    }
  }
  
  # åº”ç”¨é”™è¯¯æ—¥å¿—å¤„ç†
  if "application" in [tags] and [level] in ["ERROR", "FATAL"] {
    # é”™è¯¯ç»Ÿè®¡
    statsd {
      host => "statsd"
      port => 8125
      increment => ["errors.%{service}.%{level}"]
    }
    
    # é”™è¯¯è¯¦æƒ…å­˜å‚¨
    elasticsearch {
      hosts => ["es-errors:9200"]
      index => "error-logs-%{+YYYY.MM.dd}"
    }
  }
}
```

### 8.6 é«˜çº§æ¡ä»¶åˆ¤æ–­æŠ€å·§


#### ğŸ”¸ ä½¿ç”¨Rubyä»£ç è¿›è¡Œå¤æ‚åˆ¤æ–­

```ruby
filter {
  ruby {
    code => "
      # å¤æ‚çš„ä¸šåŠ¡é€»è¾‘åˆ¤æ–­
      status = event.get('status_code').to_i
      response_time = event.get('response_time').to_f
      
      # è®¡ç®—æ€§èƒ½è¯„åˆ†
      performance_score = 100
      
      if status >= 500
        performance_score -= 50
      elsif status >= 400
        performance_score -= 20
      end
      
      if response_time > 2000
        performance_score -= 30
      elsif response_time > 1000
        performance_score -= 15
      end
      
      # è®¾ç½®æ€§èƒ½ç­‰çº§
      if performance_score >= 80
        event.set('performance_level', 'excellent')
      elsif performance_score >= 60
        event.set('performance_level', 'good')
      elsif performance_score >= 40
        event.set('performance_level', 'poor')
      else
        event.set('performance_level', 'critical')
      end
      
      event.set('performance_score', performance_score)
    "
  }
  
  # åŸºäºè®¡ç®—ç»“æœçš„æ¡ä»¶å¤„ç†
  if [performance_level] == "critical" {
    mutate {
      add_tag => ["performance_alert"]
      add_field => { "alert_priority" => "high" }
    }
  }
}
```

#### ğŸ”¸ åŸºäºå…ƒæ•°æ®çš„æ¡ä»¶åˆ¤æ–­

```ruby
filter {
  # åŸºäºæ–‡ä»¶è·¯å¾„çš„åˆ¤æ–­
  if [@metadata][beat][name] == "filebeat" {
    if [source] =~ /\/error\.log$/ {
      mutate { add_tag => ["error_file"] }
    } else if [source] =~ /\/access\.log$/ {
      mutate { add_tag => ["access_file"] }
    }
  }
  
  # åŸºäºè¾“å…¥ç±»å‹çš„åˆ¤æ–­
  if [@metadata][input][type] == "beats" {
    mutate { add_field => { "input_method" => "beats" } }
  } else if [@metadata][input][type] == "file" {
    mutate { add_field => { "input_method" => "file_direct" } }
  }
}
```

### 8.7 æ¡ä»¶åˆ¤æ–­æ€§èƒ½ä¼˜åŒ–


#### ğŸ”¸ ä¼˜åŒ–æ¡ä»¶åˆ¤æ–­é¡ºåº

```ruby
filter {
  # âœ… å¥½çš„åšæ³•ï¼šæœ€å¸¸è§çš„æ¡ä»¶æ”¾åœ¨å‰é¢
  if [level] == "INFO" {         # æœ€å¸¸è§ï¼Œå…ˆåˆ¤æ–­
    # INFOçº§åˆ«å¤„ç†
  } else if [level] == "ERROR" { # æ¬¡å¸¸è§
    # ERRORçº§åˆ«å¤„ç†  
  } else if [level] == "DEBUG" { # è¾ƒå°‘è§
    # DEBUGçº§åˆ«å¤„ç†
  } else {                       # å…¶ä»–æƒ…å†µ
    # é»˜è®¤å¤„ç†
  }
  
  # âŒ ä¸å¥½çš„åšæ³•ï¼šå¤æ‚æ¡ä»¶åœ¨å‰é¢
  # if [field1] =~ /complex_regex/ and [field2] > 1000 and [field3] in ["a","b","c"] {
  #   # å¤æ‚æ¡ä»¶åˆ¤æ–­è€—æ—¶è¾ƒé•¿
  # }
}
```

#### ğŸ”¸ ä½¿ç”¨å­—æ®µç¼“å­˜å‡å°‘é‡å¤è®¡ç®—

```ruby
filter {
  # é¢„å…ˆè®¡ç®—å¸¸ç”¨çš„æ¡ä»¶å€¼
  if [status_code] {
    ruby {
      code => "
        status = event.get('status_code').to_i
        event.set('is_error', status >= 400)
        event.set('is_server_error', status >= 500)
        event.set('is_success', status >= 200 && status < 300)
      "
    }
  }
  
  # ä½¿ç”¨é¢„è®¡ç®—çš„å€¼è¿›è¡Œå¿«é€Ÿåˆ¤æ–­
  if [is_error] == true {
    mutate { add_tag => ["error"] }
  }
  
  if [is_server_error] == true {
    mutate { add_tag => ["server_error"] }
  }
}
```

### 8.8 æ¡ä»¶åˆ¤æ–­è°ƒè¯•æŠ€å·§


#### ğŸ”¸ è°ƒè¯•æ¡ä»¶åˆ¤æ–­é€»è¾‘

```ruby
filter {
  # æ·»åŠ è°ƒè¯•æ ‡ç­¾è·Ÿè¸ªæ¡ä»¶åˆ¤æ–­è·¯å¾„
  if [level] == "ERROR" {
    mutate { 
      add_tag => ["debug_error_path"]
      add_field => { "debug_info" => "entered_error_branch" }
    }
  } else {
    mutate { 
      add_tag => ["debug_normal_path"]
      add_field => { "debug_info" => "entered_normal_branch" }
    }
  }
  
  # æ¡ä»¶åˆ¤æ–­è®¡æ•°
  ruby {
    code => "
      if event.get('tags').include?('debug_error_path')
        event.set('condition_match_count', (event.get('condition_match_count') || 0) + 1)
      end
    "
  }
}
```

#### ğŸ”¸ æ¡ä»¶åˆ¤æ–­æµ‹è¯•æ¡†æ¶

```ruby
filter {
  # æµ‹è¯•æ¨¡å¼ï¼šè¯¦ç»†è®°å½•åˆ¤æ–­è¿‡ç¨‹
  if [@metadata][test_mode] == true {
    ruby {
      code => "
        conditions = []
        
        if event.get('status_code') && event.get('status_code').to_i >= 400
          conditions << 'status_error'
        end
        
        if event.get('response_time') && event.get('response_time').to_f > 1000
          conditions << 'slow_response'
        end
        
        if event.get('level') == 'ERROR'
          conditions << 'error_level'
        end
        
        event.set('matched_conditions', conditions)
        event.set('condition_count', conditions.length)
      "
    }
    
    # è¾“å‡ºæµ‹è¯•ç»“æœ
    stdout {
      codec => rubydebug {
        metadata => true
      }
    }
  }
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ Pipelineç»“æ„ï¼šInput â†’ Filter â†’ Outputçš„æ•°æ®å¤„ç†æµç¨‹
ğŸ”¸ Inputæ’ä»¶ï¼šFileã€Beatsã€Syslogç­‰å¤šç§æ•°æ®æ¥æ”¶æ–¹å¼
ğŸ”¸ Filteræ’ä»¶ï¼šGrokã€Dateã€Mutateç­‰æ•°æ®è§£æè½¬æ¢å·¥å…·
ğŸ”¸ Grokæ¨¡å¼ï¼šæ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼åŒ¹é…ï¼Œç»“æ„åŒ–éç»“æ„åŒ–æ•°æ®
ğŸ”¸ æ—¶é—´å¤„ç†ï¼šDateæ’ä»¶ç»Ÿä¸€æ—¶é—´æ ¼å¼ï¼Œæ”¯æŒæ—¶åŒºè½¬æ¢
ğŸ”¸ å­—æ®µæ“ä½œï¼šMutateæ’ä»¶çš„å„ç§å­—æ®µå¤„ç†åŠŸèƒ½
ğŸ”¸ Outputé…ç½®ï¼šElasticsearchã€æ–‡ä»¶ã€Kafkaç­‰å¤šç§è¾“å‡ºæ–¹å¼
ğŸ”¸ æ¡ä»¶åˆ¤æ–­ï¼šåŸºäºå­—æ®µå€¼çš„æ™ºèƒ½è·¯ç”±å’Œå¤„ç†åˆ†æ”¯
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ Logstashå·¥ä½œåŸç†**
```
æ•°æ®æµè½¬è¿‡ç¨‹ï¼š
åŸå§‹æ—¥å¿— â†’ Inputæ¥æ”¶ â†’ Filterè§£æ â†’ Outputå‘é€
å…³é”®ç†è§£ï¼š
â€¢ æ¯ä¸ªé˜¶æ®µéƒ½å¯ä»¥æœ‰å¤šä¸ªæ’ä»¶é…åˆå·¥ä½œ
â€¢ FilteræŒ‰é…ç½®é¡ºåºä¾æ¬¡æ‰§è¡Œ
â€¢ æ¡ä»¶åˆ¤æ–­å¯ä»¥æ§åˆ¶æ•°æ®æµå‘
â€¢ é”™è¯¯å¤„ç†ä¸ä¼šä¸­æ–­æ•´ä¸ªpipeline
```

**ğŸ”¹ Grokæ¨¡å¼åŒ¹é…æœ¬è´¨**
```
æ ¸å¿ƒæ¦‚å¿µï¼š
â€¢ Grok = é¢„å®šä¹‰æ­£åˆ™è¡¨è¾¾å¼ + å­—æ®µå‘½å
â€¢ æ¨¡å¼åº“æä¾›å¸¸ç”¨æ ¼å¼çš„ç°æˆæ¨¡å¼
â€¢ è‡ªå®šä¹‰æ¨¡å¼å¤„ç†ç‰¹æ®Šæ ¼å¼éœ€æ±‚
â€¢ æ€§èƒ½ä¼˜åŒ–ï¼šå…·ä½“æ¨¡å¼ä¼˜äºé€šç”¨æ¨¡å¼

å®é™…åº”ç”¨ï¼š
â€¢ Webæ—¥å¿—ï¼š%{COMBINEDAPACHELOG}
â€¢ ç³»ç»Ÿæ—¥å¿—ï¼š%{SYSLOGLINE}
â€¢ è‡ªå®šä¹‰æ ¼å¼ï¼šåˆ›å»ºpatternsæ–‡ä»¶
```

**ğŸ”¹ æ—¶é—´å­—æ®µå¤„ç†é‡è¦æ€§**
```
ä¸ºä»€ä¹ˆé‡è¦ï¼š
â€¢ æ—¥å¿—åˆ†æåŸºç¡€æ˜¯æ—¶é—´åºåˆ—
â€¢ æ—¶åŒºç»Ÿä¸€é¿å…æ—¶é—´æ··ä¹±
â€¢ @timestampå­—æ®µæ˜¯ESé»˜è®¤æ—¶é—´å­—æ®µ

å¤„ç†ç­–ç•¥ï¼š
â€¢ åŸå§‹æ—¶é—´ â†’ æ ‡å‡†UTCæ—¶é—´
â€¢ ä¿ç•™æ—¶åŒºä¿¡æ¯ç”¨äºæ˜¾ç¤º
â€¢ å¤„ç†å¤±è´¥æ—¶æä¾›fallbackæœºåˆ¶
```

### 9.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ ä¸åŒæ•°æ®æºçš„å¤„ç†ç­–ç•¥**

```
Webè®¿é—®æ—¥å¿—ï¼š
Input: file (Nginx/Apacheæ—¥å¿—æ–‡ä»¶)
Filter: grok(COMBINEDAPACHELOG) + date + geoip + useragent
Output: elasticsearch(æŒ‰æ—¥æœŸç´¢å¼•) + influxdb(ç»Ÿè®¡æŒ‡æ ‡)

åº”ç”¨ç¨‹åºæ—¥å¿—ï¼š
Input: beats (Filebeatæ”¶é›†)
Filter: json + date + mutate(å­—æ®µæ¸…ç†)
Output: elasticsearch + kafka(å®æ—¶å¤„ç†)

ç³»ç»Ÿæ—¥å¿—ï¼š
Input: syslog (UDP 514ç«¯å£)
Filter: grok(SYSLOGLINE) + date
Output: elasticsearch + file(å¤‡ä»½)

æ•°æ®åº“æ—¥å¿—ï¼š
Input: file (MySQLæ…¢æŸ¥è¯¢æ—¥å¿—)
Filter: è‡ªå®šä¹‰grok + date + mutate(æ•°å€¼è½¬æ¢)
Output: elasticsearch(ä¸“é—¨ç´¢å¼•) + email(å‘Šè­¦)
```

**ğŸ¯ æ€§èƒ½ä¼˜åŒ–æœ€ä½³å®è·µ**

```
Inputä¼˜åŒ–ï¼š
â€¢ ä½¿ç”¨Beatsè€Œä¸æ˜¯ç›´æ¥file input
â€¢ åˆç†è®¾ç½®batch_sizeå’Œworkers
â€¢ å¯ç”¨å‹ç¼©å‡å°‘ç½‘ç»œä¼ è¾“

Filterä¼˜åŒ–ï¼š
â€¢ Grokæ¨¡å¼è¦å…·ä½“ï¼Œé¿å….*å’Œ%{DATA}
â€¢ æ¡ä»¶åˆ¤æ–­æŒ‰æ¦‚ç‡æ’åº
â€¢ åŠæ—¶åˆ é™¤ä¸éœ€è¦çš„å­—æ®µ
â€¢ ä½¿ç”¨break_on_matchä¼˜åŒ–åŒ¹é…

Outputä¼˜åŒ–ï¼š
â€¢ Elasticsearchä½¿ç”¨æ‰¹é‡ç´¢å¼•
â€¢ è®¾ç½®åˆç†çš„flush_sizeå’Œworkers
â€¢ å¯ç”¨æ¨¡æ¿å’ŒILMç­–ç•¥
â€¢ ç›‘æ§è¾“å‡ºé˜Ÿåˆ—é˜²æ­¢ç§¯å‹
```

### 9.4 æ•…éšœè¯Šæ–­æŒ‡å—


**ğŸ”§ å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ**

```
Grokè§£æå¤±è´¥ï¼š
ç—‡çŠ¶ï¼š_grokparsefailureæ ‡ç­¾å‡ºç°
åŸå› ï¼šæ—¥å¿—æ ¼å¼ä¸æ¨¡å¼ä¸åŒ¹é…
è§£å†³ï¼šä½¿ç”¨Grok Debuggerè°ƒè¯•æ¨¡å¼ï¼Œæ£€æŸ¥ç¤ºä¾‹æ—¥å¿—

æ—¶é—´è§£æé”™è¯¯ï¼š
ç—‡çŠ¶ï¼š_dateparsefailureæ ‡ç­¾
åŸå› ï¼šæ—¶é—´æ ¼å¼ä¸æ­£ç¡®æˆ–æ—¶åŒºé—®é¢˜
è§£å†³ï¼šæ£€æŸ¥æ—¶é—´æ ¼å¼å­—ç¬¦ä¸²ï¼ŒéªŒè¯æ—¶åŒºè®¾ç½®

è¾“å‡ºæ€§èƒ½å·®ï¼š
ç—‡çŠ¶ï¼šäº‹ä»¶ç§¯å‹ï¼Œå¤„ç†å»¶è¿Ÿ
åŸå› ï¼šè¾“å‡ºç›®æ ‡æ€§èƒ½ç“¶é¢ˆæˆ–ç½‘ç»œé—®é¢˜
è§£å†³ï¼šè°ƒæ•´batch_sizeï¼Œå¢åŠ workersï¼Œæ£€æŸ¥ç›®æ ‡ç³»ç»Ÿ

å†…å­˜ä½¿ç”¨è¿‡é«˜ï¼š
ç—‡çŠ¶ï¼šLogstashè¿›ç¨‹å†…å­˜æŒç»­å¢é•¿
åŸå› ï¼šé˜Ÿåˆ—ç§¯å‹æˆ–å¤§å­—æ®µå¤„ç†
è§£å†³ï¼šè°ƒæ•´pipeline.batch.sizeï¼Œå¢åŠ heapå¤§å°
```

### 9.5 ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ


**ğŸš€ æ¨èçš„é…ç½®æ¨¡å¼**

```
å¼€å‘ç¯å¢ƒé…ç½®ï¼š
â€¢ ä½¿ç”¨stdout outputä¾¿äºè°ƒè¯•
â€¢ ä¿ç•™è¯¦ç»†çš„debugä¿¡æ¯
â€¢ ä½¿ç”¨å°çš„batch_sizeå¿«é€Ÿåé¦ˆ

æµ‹è¯•ç¯å¢ƒé…ç½®ï¼š
â€¢ ä½¿ç”¨çœŸå®æ•°æ®æºå’Œè¾“å‡ºç›®æ ‡
â€¢ é…ç½®ç›‘æ§å’Œå‘Šè­¦æµ‹è¯•
â€¢ éªŒè¯å®¹é”™å’Œæ¢å¤æœºåˆ¶

ç”Ÿäº§ç¯å¢ƒé…ç½®ï¼š
â€¢ å¯ç”¨æŒä¹…åŒ–é˜Ÿåˆ—
â€¢ é…ç½®æ­»ä¿¡é˜Ÿåˆ—å¤„ç†å¤±è´¥äº‹ä»¶
â€¢ è®¾ç½®åˆç†çš„JVM heapå¤§å°
â€¢ å¯ç”¨X-Packç›‘æ§

é›†ç¾¤éƒ¨ç½²ï¼š
â€¢ ä½¿ç”¨è´Ÿè½½å‡è¡¡åˆ†å‘æ•°æ®
â€¢ ä¸åŒèŠ‚ç‚¹å¤„ç†ä¸åŒç±»å‹æ•°æ®
â€¢ é…ç½®è‡ªåŠ¨æ•…éšœåˆ‡æ¢
â€¢ å®šæœŸå¤‡ä»½é…ç½®æ–‡ä»¶
```

**é…ç½®ç®¡ç†å»ºè®®ï¼š**
```yaml
# é…ç½®æ–‡ä»¶ç»„ç»‡ç»“æ„
/etc/logstash/
â”œâ”€â”€ pipelines.yml          # å¤špipelineé…ç½®
â”œâ”€â”€ logstash.yml           # ä¸»é…ç½®æ–‡ä»¶
â”œâ”€â”€ conf.d/
â”‚   â”œâ”€â”€ input/
â”‚   â”‚   â”œâ”€â”€ beats.conf     # Beatsè¾“å…¥é…ç½®
â”‚   â”‚   â”œâ”€â”€ file.conf      # æ–‡ä»¶è¾“å…¥é…ç½®
â”‚   â”‚   â””â”€â”€ syslog.conf    # Syslogè¾“å…¥é…ç½®
â”‚   â”œâ”€â”€ filter/
â”‚   â”‚   â”œâ”€â”€ web-logs.conf  # Webæ—¥å¿—è¿‡æ»¤
â”‚   â”‚   â”œâ”€â”€ app-logs.conf  # åº”ç”¨æ—¥å¿—è¿‡æ»¤
â”‚   â”‚   â””â”€â”€ system.conf    # ç³»ç»Ÿæ—¥å¿—è¿‡æ»¤
â”‚   â””â”€â”€ output/
â”‚       â”œâ”€â”€ elasticsearch.conf
â”‚       â”œâ”€â”€ kafka.conf
â”‚       â””â”€â”€ monitoring.conf
â””â”€â”€ patterns/
    â”œâ”€â”€ custom-patterns    # è‡ªå®šä¹‰Grokæ¨¡å¼
    â””â”€â”€ java-patterns     # Javaåº”ç”¨æ¨¡å¼
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹ï¼š**
- Logstashæ˜¯æ•°æ®å¤„ç†çš„"ç‘å£«å†›åˆ€"ï¼Œçµæ´»é…ç½®é€‚åº”å„ç§éœ€æ±‚
- Pipelineæ€ç»´ï¼šè¾“å…¥â†’å¤„ç†â†’è¾“å‡ºï¼Œæ¯ä¸ªç¯èŠ‚éƒ½å¯ä¼˜åŒ–
- Grokæ˜¯ç»“æ„åŒ–çš„å…³é”®ï¼ŒæŒæ¡å¸¸ç”¨æ¨¡å¼å’Œè‡ªå®šä¹‰æ–¹æ³•
- æ¡ä»¶åˆ¤æ–­å®ç°æ™ºèƒ½è·¯ç”±ï¼Œæé«˜å¤„ç†æ•ˆç‡å’Œå‡†ç¡®æ€§
- ç”Ÿäº§ç¯å¢ƒé‡ç‚¹å…³æ³¨æ€§èƒ½ã€å¯é æ€§å’Œå¯ç»´æŠ¤æ€§
- ç›‘æ§å’Œæ—¥å¿—å¤„ç†æœ¬èº«åŒæ ·é‡è¦ï¼Œé¿å…"ç›‘æ§çš„ç›‘æ§"é—®é¢˜