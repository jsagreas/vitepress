---
title: 4、sar系统活动报告深入
---
## 📚 目录

1. [sar命令基础概念](#1-sar命令基础概念)
2. [CPU性能监控详解](#2-CPU性能监控详解)
3. [内存使用状况分析](#3-内存使用状况分析)
4. [网络流量监控](#4-网络流量监控)
5. [磁盘I/O性能分析](#5-磁盘IO性能分析)
6. [历史数据管理与查询](#6-历史数据管理与查询)
7. [自动化监控配置](#7-自动化监控配置)
8. [数据格式转换与报表](#8-数据格式转换与报表)
9. [实际应用场景](#9-实际应用场景)
10. [核心要点总结](#10-核心要点总结)

---

## 1. 🔍 sar命令基础概念


### 1.1 什么是sar


**🎯 核心定义**
```
sar = System Activity Reporter（系统活动报告器）
作用：收集、报告、保存系统活动信息
本质：一个强大的系统性能监控工具
```

> 💡 **通俗理解**  
> 就像医院的体检仪器，sar能够全面"体检"你的Linux系统，告诉你CPU忙不忙、内存够不够、网络快不快、硬盘读写是否正常

**🔧 sar的工作原理**
```
数据收集流程：
内核统计信息 → sar读取 → 格式化显示 → 保存到日志文件

┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  内核统计    │ → │   sar工具   │ → │  性能报告   │
│ /proc/stat  │    │ 数据处理    │    │ 历史记录    │
│ /proc/net   │    │ 格式转换    │    │ 趋势分析    │
└─────────────┘    └─────────────┘    └─────────────┘
```

### 1.2 sar命令基本语法


**📝 标准格式**
```bash
sar [选项] [时间间隔] [次数]

基本示例：
sar -u 2 5    # 每2秒显示CPU使用率，共5次
sar -r 1 10   # 每1秒显示内存使用情况，共10次
sar -n DEV 3  # 每3秒显示网络设备状态，持续监控
```

**🔸 常用选项速览**
| 选项 | **监控内容** | **说明** |
|------|-------------|-----------|
| `-u` | `CPU使用率` | `用户态、内核态、空闲时间` |
| `-r` | `内存使用` | `已用、可用、缓存、交换分区` |
| `-n DEV` | `网络设备` | `收发包数、流量统计` |
| `-d` | `磁盘I/O` | `读写速度、IOPS统计` |
| `-q` | `负载平均` | `运行队列长度、进程数` |
| `-b` | `磁盘传输` | `总体I/O传输率` |

---

## 2. 💻 CPU性能监控详解


### 2.1 CPU使用率监控


**🔍 基本CPU监控**
```bash
# 查看CPU使用率
sar -u 1 5

# 输出示例：
Linux 5.4.0 (server01) 09/15/2025  _x86_64_

10:30:01        CPU     %user     %nice   %system   %iowait    %steal     %idle
10:30:02        all      12.50      0.00      3.25      2.15      0.00     82.10
10:30:03        all      15.75      0.00      4.50      1.25      0.00     78.50
Average:        all      14.13      0.00      3.88      1.70      0.00     80.30
```

**📊 CPU指标含义详解**
```
%user    ：用户态CPU使用率（运行应用程序）
%nice    ：低优先级进程CPU使用率
%system  ：内核态CPU使用率（系统调用、中断处理）
%iowait  ：等待I/O操作的CPU空闲时间
%steal   ：虚拟机环境下被其他虚拟机"偷走"的CPU时间
%idle    ：真正的CPU空闲时间
```

> 💡 **理解要点**  
> - **%user高**：应用程序计算密集，可能需要优化算法
> - **%system高**：系统调用频繁，可能有性能瓶颈
> - **%iowait高**：磁盘或网络I/O成为瓶颈
> - **%idle低**：CPU负载很重，可能需要扩容

### 2.2 多核CPU监控


**🔧 按CPU核心监控**
```bash
# 查看每个CPU核心的使用情况
sar -P ALL 2 3

# 输出解读：
10:35:01        CPU     %user     %nice   %system   %iowait    %steal     %idle
10:35:03          0      8.50      0.00      2.00      5.00      0.00     84.50
10:35:03          1     18.50      0.00      6.00      1.50      0.00     74.00
10:35:03          2     12.00      0.00      3.50      2.00      0.00     82.50
10:35:03          3     25.50      0.00      8.00      0.50      0.00     66.00
```

**📈 CPU负载分析技巧**
```bash
# 查看系统负载和运行队列
sar -q 1 5

# 输出字段说明：
runq-sz  ：运行队列中等待CPU的进程数
plist-sz ：系统中总的进程和线程数
ldavg-1  ：1分钟平均负载
ldavg-5  ：5分钟平均负载
ldavg-15 ：15分钟平均负载
```

> ⚠️ **负载告警标准**  
> - **负载 < CPU核心数**：系统运行正常
> - **负载 = CPU核心数**：系统接近满负荷
> - **负载 > CPU核心数**：系统过载，有进程等待

---

## 3. 🧠 内存使用状况分析


### 3.1 内存基础监控


**📊 内存使用统计**
```bash
# 查看内存使用情况
sar -r 2 5

# 输出示例：
10:40:01    kbmemfree   kbavail kbmemused  %memused kbbuffers  kbcached  kbcommit   %commit
10:40:03      2048576   6145280   4194304     67.11    524288   2097152  12582912     89.45
10:40:05      1975296   6072704   4267008     68.28    531456   2156544  12648448     89.98
```

**🔍 内存指标详解**
```
kbmemfree  ：完全空闲的内存（KB）
kbavail    ：可用内存总量，包括空闲+可回收（KB）
kbmemused  ：已使用内存（KB）
%memused   ：内存使用率百分比
kbbuffers  ：用作缓冲区的内存（KB）
kbcached   ：用作缓存的内存（KB）
kbcommit   ：已提交的虚拟内存（KB）
%commit    ：虚拟内存使用率
```

### 3.2 交换分区监控


**💾 交换空间分析**
```bash
# 查看交换分区使用情况
sar -S 1 5

# 输出解读：
10:45:01    kbswpfree kbswpused  %swpused  kbswpcad   %swpcad
10:45:02      4194304    262144      5.89     131072     50.00
10:45:03      4194304    327680      7.25     163840     50.00
```

**📋 交换分区指标说明**
```
kbswpfree  ：空闲交换空间（KB）
kbswpused  ：已使用交换空间（KB）
%swpused   ：交换分区使用率
kbswpcad   ：缓存在交换分区的内存（KB）
%swpcad    ：交换缓存比例
```

> ⚠️ **内存告警指标**  
> - **内存使用率 > 90%**：内存不足，需要关注
> - **交换分区使用率 > 10%**：系统开始使用虚拟内存
> - **可用内存 < 总内存的10%**：系统内存紧张

---

## 4. 🌐 网络流量监控


### 4.1 网络设备统计


**📡 网络接口监控**
```bash
# 查看网络设备流量统计
sar -n DEV 2 5

# 输出示例：
10:50:01        IFACE   rxpck/s   txpck/s    rxkB/s    txkB/s   rxcmp/s   txcmp/s  rxmcst/s
10:50:03         eth0    125.50     98.25     89.75     45.32      0.00      0.00      2.50
10:50:03           lo      5.00      5.00      0.35      0.35      0.00      0.00      0.00
```

**🔍 网络统计指标含义**
```
IFACE    ：网络接口名称
rxpck/s  ：每秒接收的数据包数
txpck/s  ：每秒发送的数据包数
rxkB/s   ：每秒接收的数据量（KB）
txkB/s   ：每秒发送的数据量（KB）
rxcmp/s  ：每秒接收的压缩数据包数
txcmp/s  ：每秒发送的压缩数据包数
rxmcst/s ：每秒接收的多播数据包数
```

### 4.2 网络错误监控


**🚨 网络错误统计**
```bash
# 查看网络错误情况
sar -n EDEV 2 3

# 输出字段说明：
rxerr/s  ：每秒接收错误数
txerr/s  ：每秒发送错误数
coll/s   ：每秒冲突数
rxdrop/s ：每秒接收丢弃数
txdrop/s ：每秒发送丢弃数
```

> 💡 **网络性能判断**  
> - **丢包率 > 1%**：网络可能有问题
> - **错误率 > 0.1%**：需要检查网络配置
> - **带宽利用率 > 80%**：考虑网络扩容

### 4.3 TCP连接监控


**🔗 TCP连接状态**
```bash
# 查看TCP连接统计
sar -n TCP 2 5

# 主要指标：
active/s    ：每秒主动连接数
passive/s   ：每秒被动连接数
iseg/s      ：每秒接收的TCP段数
oseg/s      ：每秒发送的TCP段数
```

---

## 5. 💿 磁盘I/O性能分析


### 5.1 磁盘I/O统计


**📊 磁盘活动监控**
```bash
# 查看磁盘I/O统计
sar -d 2 5

# 输出示例：
10:55:01          DEV       tps  rd_sec/s  wr_sec/s  avgrq-sz  avgqu-sz     await     svctm     %util
10:55:03       dev8-0     12.50     45.25    156.75     16.16      0.15     12.00      5.60      7.00
10:55:03      dev8-16      8.00     32.50     48.00     10.06      0.08      9.50      4.25      3.40
```

**🔍 磁盘I/O指标详解**
```
DEV        ：设备名称
tps        ：每秒传输次数（IOPS）
rd_sec/s   ：每秒读取扇区数
wr_sec/s   ：每秒写入扇区数
avgrq-sz   ：平均每次I/O请求的大小（扇区）
avgqu-sz   ：平均队列长度
await      ：平均等待时间（毫秒）
svctm      ：平均服务时间（毫秒）
%util      ：设备利用率百分比
```

### 5.2 磁盘传输速率


**📈 整体I/O传输**
```bash
# 查看系统整体I/O传输率
sar -b 2 5

# 输出字段：
tps        ：每秒总的I/O传输
rtps       ：每秒读请求数
wtps       ：每秒写请求数
bread/s    ：每秒读取的块数
bwrtn/s    ：每秒写入的块数
```

> ⚠️ **磁盘性能告警**  
> - **%util > 85%**：磁盘接近饱和
> - **await > 20ms**：I/O等待时间过长
> - **队列长度 > 2**：I/O压力较大

---

## 6. 📂 历史数据管理与查询


### 6.1 历史数据存储


**🗂️ sar数据文件位置**
```bash
# sar数据文件默认存储位置
/var/log/sa/

# 文件命名规则：
sa01, sa02, ... sa31    # 每月1-31日的数据文件
sar01, sar02, ... sar31 # 文本格式的报告文件
```

**📅 查看历史数据**
```bash
# 查看指定日期的数据（假设今天是15号）
sar -u -f /var/log/sa/sa14    # 查看14号的CPU数据
sar -r -f /var/log/sa/sa13    # 查看13号的内存数据

# 查看指定时间段的数据
sar -u -s 09:00:00 -e 17:00:00 -f /var/log/sa/sa14
```

### 6.2 数据查询技巧


**🔍 高级查询示例**
```bash
# 查看昨天的性能峰值
sar -u -f /var/log/sa/sa14 | grep -v Average | sort -k4 -nr | head -10

# 查看特定时间段的网络流量
sar -n DEV -s 14:00:00 -e 16:00:00 -f /var/log/sa/sa14

# 生成昨天的完整性能报告
sar -A -f /var/log/sa/sa14 > performance_report_$(date -d yesterday +%Y%m%d).txt
```

### 6.3 数据保留策略


**🗃️ 日志轮转配置**
```bash
# 查看当前保留策略
grep HISTORY /etc/sysconfig/sysstat

# 典型配置：
HISTORY=28    # 保留28天的数据
COMPRESSAFTER=31    # 31天后压缩数据
```

---

## 7. ⚙️ 自动化监控配置


### 7.1 定时数据收集


**⏰ cron任务配置**
```bash
# 查看现有的sar定时任务
crontab -l | grep sar

# 典型的系统级cron任务（/etc/cron.d/sysstat）：
# 每10分钟收集一次数据
*/10 * * * * root /usr/lib64/sa/sa1 1 1

# 每天23:53生成日报告
53 23 * * * root /usr/lib64/sa/sa2 -A
```

**🔧 自定义数据收集**
```bash
# 创建自定义监控脚本
cat > /usr/local/bin/performance_monitor.sh << 'EOF'
#!/bin/bash
# 每5分钟收集详细性能数据

# 设置数据目录
DATA_DIR="/var/log/performance"
mkdir -p $DATA_DIR

# 当前时间戳
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")

# 收集综合性能数据
sar -A 1 60 > $DATA_DIR/performance_${TIMESTAMP}.log &

# 收集特定指标
sar -u 1 300 > $DATA_DIR/cpu_${TIMESTAMP}.log &
sar -r 1 300 > $DATA_DIR/memory_${TIMESTAMP}.log &
sar -n DEV 1 300 > $DATA_DIR/network_${TIMESTAMP}.log &
EOF

chmod +x /usr/local/bin/performance_monitor.sh
```

### 7.2 告警阈值设置


**🚨 性能告警脚本**
```bash
# 创建性能告警检查脚本
cat > /usr/local/bin/performance_alert.sh << 'EOF'
#!/bin/bash

# 获取当前性能指标
CPU_USAGE=$(sar -u 1 1 | tail -1 | awk '{print 100-$NF}')
MEM_USAGE=$(sar -r 1 1 | tail -1 | awk '{print $4}')
DISK_UTIL=$(sar -d 1 1 | tail -1 | awk '{print $NF}')

# 告警阈值
CPU_THRESHOLD=85
MEM_THRESHOLD=90
DISK_THRESHOLD=85

# 检查并发送告警
if [ $(echo "$CPU_USAGE > $CPU_THRESHOLD" | bc) -eq 1 ]; then
    echo "ALERT: CPU usage is ${CPU_USAGE}%" | mail -s "CPU Alert" admin@example.com
fi

if [ $(echo "$MEM_USAGE > $MEM_THRESHOLD" | bc) -eq 1 ]; then
    echo "ALERT: Memory usage is ${MEM_USAGE}%" | mail -s "Memory Alert" admin@example.com
fi
EOF
```

---

## 8. 🔄 数据格式转换与报表


### 8.1 sadf数据格式转换


**📊 sadf工具介绍**
```
sadf = System Activity Data Formatter
作用：将sar的二进制数据转换为其他格式
支持格式：CSV、XML、JSON、数据库格式
```

**🔧 格式转换示例**
```bash
# 转换为CSV格式（便于Excel分析）
sadf -d /var/log/sa/sa14 -- -u > cpu_usage.csv

# 转换为XML格式
sadf -x /var/log/sa/sa14 -- -r > memory_usage.xml

# 转换为JSON格式（便于程序处理）
sadf -j /var/log/sa/sa14 -- -n DEV > network_stats.json

# 输出到数据库格式
sadf -g /var/log/sa/sa14 -- -d > disk_io.dat
```

### 8.2 自动报表生成


**📈 性能报表脚本**
```bash
# 创建每日性能报表生成脚本
cat > /usr/local/bin/daily_report.sh << 'EOF'
#!/bin/bash

YESTERDAY=$(date -d yesterday +%d)
REPORT_DATE=$(date -d yesterday +%Y-%m-%d)
SA_FILE="/var/log/sa/sa${YESTERDAY}"

# 生成HTML格式报告
cat > /tmp/performance_report_${REPORT_DATE}.html << HTML
<!DOCTYPE html>
<html>
<head>
    <title>System Performance Report - ${REPORT_DATE}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .alert { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <h1>System Performance Report - ${REPORT_DATE}</h1>
    
    <h2>CPU Usage Summary</h2>
    <pre>$(sar -u -f $SA_FILE | tail -10)</pre>
    
    <h2>Memory Usage Summary</h2>
    <pre>$(sar -r -f $SA_FILE | tail -10)</pre>
    
    <h2>Network Traffic Summary</h2>
    <pre>$(sar -n DEV -f $SA_FILE | tail -15)</pre>
    
    <h2>Disk I/O Summary</h2>
    <pre>$(sar -d -f $SA_FILE | tail -10)</pre>
</body>
</html>
HTML

# 发送报告邮件
echo "Daily performance report attached" | mail -s "Performance Report ${REPORT_DATE}" \
    -a /tmp/performance_report_${REPORT_DATE}.html admin@example.com
EOF
```

---

## 9. 🎯 实际应用场景


### 9.1 性能故障排查


**🔍 故障排查流程**
```
故障排查的sar命令组合：

1. 快速概览：
   sar -A 1 5    # 查看所有指标的当前状态

2. CPU问题排查：
   sar -u 1 10   # CPU使用率
   sar -q 1 10   # 系统负载

3. 内存问题排查：
   sar -r 1 10   # 内存使用
   sar -S 1 10   # 交换分区

4. I/O问题排查：
   sar -d 1 10   # 磁盘I/O
   sar -b 1 10   # 总体I/O

5. 网络问题排查：
   sar -n DEV 1 10    # 网络流量
   sar -n EDEV 1 10   # 网络错误
```

### 9.2 容量规划分析


**📊 历史趋势分析**
```bash
# 分析最近一周的CPU使用趋势
for i in {08..14}; do
    echo "=== Date: sa$i ==="
    sar -u -f /var/log/sa/sa$i | grep Average
done

# 分析内存使用趋势
for i in {08..14}; do
    echo "=== Date: sa$i ==="
    sar -r -f /var/log/sa/sa$i | grep Average
done

# 生成趋势分析CSV
echo "Date,CPU_User,CPU_System,CPU_Idle,Memory_Used,Memory_Free" > trend_analysis.csv
for i in {08..14}; do
    CPU_DATA=$(sar -u -f /var/log/sa/sa$i | grep Average | awk '{print $3","$5","$8}')
    MEM_DATA=$(sar -r -f /var/log/sa/sa$i | grep Average | awk '{print $4","$2}')
    echo "sa$i,$CPU_DATA,$MEM_DATA" >> trend_analysis.csv
done
```

### 9.3 性能基线建立


**📋 建立性能基线**
```bash
# 创建性能基线收集脚本
cat > /usr/local/bin/baseline_collection.sh << 'EOF'
#!/bin/bash

BASELINE_DIR="/var/log/baseline"
mkdir -p $BASELINE_DIR

# 在业务低峰期收集基线数据（凌晨2-4点）
if [ $(date +%H) -ge 2 ] && [ $(date +%H) -le 4 ]; then
    DATE=$(date +%Y%m%d)
    
    # 收集2小时的详细数据
    sar -A 30 240 > $BASELINE_DIR/baseline_${DATE}.log
    
    # 生成基线摘要
    echo "=== Baseline Summary for $DATE ===" > $BASELINE_DIR/baseline_summary_${DATE}.txt
    echo "CPU Average:" >> $BASELINE_DIR/baseline_summary_${DATE}.txt
    sar -u -f /var/log/sa/sa$(date +%d) | grep Average >> $BASELINE_DIR/baseline_summary_${DATE}.txt
    
    echo "Memory Average:" >> $BASELINE_DIR/baseline_summary_${DATE}.txt
    sar -r -f /var/log/sa/sa$(date +%d) | grep Average >> $BASELINE_DIR/baseline_summary_${DATE}.txt
fi
EOF
```

---

## 10. 📋 核心要点总结


### 10.1 必须掌握的核心概念


```
🔸 sar本质：系统活动报告器，全面监控系统性能
🔸 数据收集：定时收集性能数据，存储在/var/log/sa/
🔸 多维监控：CPU、内存、网络、磁盘全覆盖
🔸 历史分析：查询历史数据，分析性能趋势
🔸 自动化：配置定时收集和告警机制
🔸 格式转换：使用sadf转换数据格式，生成报表
```

### 10.2 关键命令速查


> 💡 **sar常用命令快速参考**

**基础监控命令：**
```bash
sar -u 2 5       # CPU使用率监控
sar -r 2 5       # 内存使用监控  
sar -n DEV 2 5   # 网络流量监控
sar -d 2 5       # 磁盘I/O监控
sar -q 2 5       # 系统负载监控
```

**历史数据查询：**
```bash
sar -u -f /var/log/sa/sa14                    # 查看14号CPU数据
sar -r -s 09:00:00 -e 17:00:00 -f /var/log/sa/sa14   # 指定时间段
sadf -d /var/log/sa/sa14 -- -u > cpu.csv      # 转换为CSV格式
```

### 10.3 性能指标告警阈值


| **监控项目** | **正常范围** | **告警阈值** | **说明** |
|-------------|-------------|-------------|----------|
| **CPU使用率** | `< 70%` | `> 85%` | `持续高负载需要关注` |
| **内存使用率** | `< 80%` | `> 90%` | `避免系统使用交换分区` |
| **磁盘利用率** | `< 70%` | `> 85%` | `I/O等待时间会急剧增加` |
| **网络丢包率** | `< 0.1%` | `> 1%` | `可能存在网络故障` |
| **系统负载** | `< CPU核数` | `> CPU核数×1.5` | `进程等待时间过长` |

### 10.4 实际应用最佳实践


**🔧 监控策略建议：**
- **实时监控**：关键时段使用1-2秒间隔
- **日常监控**：使用5-10分钟间隔收集数据
- **历史分析**：保留至少30天的性能数据
- **告警设置**：基于业务特点设置合理阈值
- **趋势分析**：定期分析性能趋势，提前规划容量

**🎯 故障排查思路：**
```
性能问题排查顺序：
1. 查看系统负载（sar -q）
2. 分析CPU使用情况（sar -u）  
3. 检查内存状态（sar -r）
4. 查看I/O性能（sar -d）
5. 检查网络状况（sar -n DEV）
6. 结合历史数据对比分析
```

**核心记忆要点：**
- sar是Linux系统性能监控的瑞士军刀
- 理解各项性能指标的含义比记住命令更重要  
- 历史数据分析是发现性能趋势的关键
- 自动化监控和告警是运维工作的基础
- 性能基线是判断系统是否正常的重要参考