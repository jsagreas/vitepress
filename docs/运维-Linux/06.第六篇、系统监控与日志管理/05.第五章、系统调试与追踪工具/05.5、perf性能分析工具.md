---
title: 5ã€perfæ€§èƒ½åˆ†æå·¥å…·
---
## ğŸ“š ç›®å½•

1. [perfå·¥å…·æ¦‚è¿°ä¸åŸºç¡€è®¤çŸ¥](#1-perfå·¥å…·æ¦‚è¿°ä¸åŸºç¡€è®¤çŸ¥)
2. [CPUæ€§èƒ½è®¡æ•°å™¨æ·±å…¥ç†è§£](#2-CPUæ€§èƒ½è®¡æ•°å™¨æ·±å…¥ç†è§£)
3. [å‡½æ•°è°ƒç”¨çƒ­ç‚¹åˆ†æå®æˆ˜](#3-å‡½æ•°è°ƒç”¨çƒ­ç‚¹åˆ†æå®æˆ˜)
4. [ç³»ç»Ÿçº§æ€§èƒ½äº‹ä»¶ç›‘æ§](#4-ç³»ç»Ÿçº§æ€§èƒ½äº‹ä»¶ç›‘æ§)
5. [ç¼“å­˜æ€§èƒ½åˆ†æè¯¦è§£](#5-ç¼“å­˜æ€§èƒ½åˆ†æè¯¦è§£)
6. [åˆ†æ”¯é¢„æµ‹æ€§èƒ½ä¼˜åŒ–](#6-åˆ†æ”¯é¢„æµ‹æ€§èƒ½ä¼˜åŒ–)
7. [ç«ç„°å›¾ç”Ÿæˆä¸å¯è§†åŒ–åˆ†æ](#7-ç«ç„°å›¾ç”Ÿæˆä¸å¯è§†åŒ–åˆ†æ)
8. [æ€§èƒ½ç“¶é¢ˆå®šä½æ–¹æ³•è®º](#8-æ€§èƒ½ç“¶é¢ˆå®šä½æ–¹æ³•è®º)
9. [ç¡¬ä»¶æ€§èƒ½è®¡æ•°å™¨é«˜çº§åº”ç”¨](#9-ç¡¬ä»¶æ€§èƒ½è®¡æ•°å™¨é«˜çº§åº”ç”¨)
10. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#10-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” perfå·¥å…·æ¦‚è¿°ä¸åŸºç¡€è®¤çŸ¥


### 1.1 ä»€ä¹ˆæ˜¯perfå·¥å…·


**ğŸ“ éš¾åº¦ç­‰çº§**ï¼šğŸŸ¢ åŸºç¡€å…¥é—¨
**ğŸ“ é‡è¦ç¨‹åº¦**ï¼šâ­â­â­ æ ¸å¿ƒå¿…ä¼š

**ğŸ”¸ ç®€å•ç†è§£**
```
perfå°±åƒæ˜¯Linuxç³»ç»Ÿçš„"ä½“æ£€åŒ»ç”Ÿ"
- æ™®é€šåŒ»ç”Ÿï¼šç”¨å¬è¯Šå™¨æ£€æŸ¥å¿ƒè·³
- perfå·¥å…·ï¼šç”¨æ€§èƒ½è®¡æ•°å™¨æ£€æŸ¥ç¨‹åºè¿è¡Œ
```

**ğŸ¯ æ ¸å¿ƒå®šä¹‰**
```
perfæ˜¯Linuxå†…æ ¸æä¾›çš„æ€§èƒ½åˆ†æå·¥å…·
ä½œç”¨ï¼šå®æ—¶ç›‘æ§å’Œåˆ†æç³»ç»Ÿã€è¿›ç¨‹ã€å‡½æ•°çš„æ€§èƒ½è¡¨ç°
åŸç†ï¼šåŸºäºç¡¬ä»¶æ€§èƒ½è®¡æ•°å™¨(PMU)å’Œè½¯ä»¶äº‹ä»¶è¿›è¡Œé‡‡æ ·
ç‰¹ç‚¹ï¼šä½å¼€é”€ã€é«˜ç²¾åº¦ã€åŠŸèƒ½å…¨é¢
```

**ğŸ’¡ å®é™…åº”ç”¨åœºæ™¯**
```
ğŸ’¼ å…¸å‹ä½¿ç”¨åœºæ™¯ï¼š
- ğŸƒâ€â™‚ï¸ ç¨‹åºè·‘å¾—æ…¢ï¼Œä¸çŸ¥é“æ…¢åœ¨å“ªé‡Œ
- ğŸ”¥ CPUä½¿ç”¨ç‡å¾ˆé«˜ï¼Œæƒ³æ‰¾åˆ°çƒ­ç‚¹å‡½æ•°
- ğŸ’¾ æ€€ç–‘å†…å­˜è®¿é—®æœ‰é—®é¢˜
- ğŸ¯ æƒ³ä¼˜åŒ–ç¨‹åºæ€§èƒ½ï¼Œéœ€è¦æ•°æ®æ”¯æ’‘
```

### 1.2 perfçš„æ ¸å¿ƒä¼˜åŠ¿


**ğŸ†š ä¸å…¶ä»–å·¥å…·å¯¹æ¯”**
| å·¥å…·ç±»å‹ | **ç²¾åº¦** | **å¼€é”€** | **è¦†ç›–èŒƒå›´** | **ä½¿ç”¨éš¾åº¦** |
|---------|---------|---------|-------------|-------------|
| ğŸ”§ **perf** | `æé«˜` | `æä½(<5%)` | `ç³»ç»Ÿ+åº”ç”¨å…¨è¦†ç›–` | `ä¸­ç­‰` |
| ğŸ“Š **top/htop** | `ä½` | `ä½` | `è¿›ç¨‹çº§` | `ç®€å•` |
| ğŸ” **gprof** | `ä¸­` | `é«˜(>20%)` | `å•ä¸ªç¨‹åº` | `å¤æ‚` |
| âš¡ **Intel VTune** | `æé«˜` | `ä½` | `Intel CPUä¸“ç”¨` | `å¤æ‚` |

### 1.3 perfå·¥å…·æ¶æ„ç†è§£


**ğŸ—ï¸ å·¥ä½œåŸç†å›¾è§£**
```
ç”¨æˆ·ç©ºé—´åº”ç”¨ç¨‹åº
        â†“ (ç³»ç»Ÿè°ƒç”¨)
    perfç”¨æˆ·æ€å·¥å…·
        â†“ (perf_eventæ¥å£)
    Linuxå†…æ ¸perfå­ç³»ç»Ÿ
        â†“ (è¯»å–ç¡¬ä»¶è®¡æ•°å™¨)
    CPUç¡¬ä»¶æ€§èƒ½ç›‘æ§å•å…ƒ(PMU)
        â†“ (ç»Ÿè®¡å„ç§äº‹ä»¶)
    å®é™…çš„ç¨‹åºæ‰§è¡Œå’Œç¡¬ä»¶äº‹ä»¶
```

**ğŸ”‘ å…³é”®æ¦‚å¿µè§£é‡Š**
```
PMU(Performance Monitoring Unit)ï¼š
- ç®€å•ç†è§£ï¼šCPUå†…ç½®çš„"è®¡æ•°å™¨èŠ¯ç‰‡"
- ä½œç”¨ï¼šç»Ÿè®¡æŒ‡ä»¤æ‰§è¡Œã€ç¼“å­˜å‘½ä¸­ç­‰ç¡¬ä»¶äº‹ä»¶
- ç‰¹ç‚¹ï¼šç¡¬ä»¶çº§åˆ«ï¼Œç²¾åº¦æé«˜ï¼Œå¼€é”€æå°

äº‹ä»¶(Event)ï¼š
- ç®€å•ç†è§£ï¼šæƒ³è¦ç›‘æ§çš„"æŒ‡æ ‡é¡¹ç›®"
- ä¸¾ä¾‹ï¼šCPUæŒ‡ä»¤æ•°ã€ç¼“å­˜æœªå‘½ä¸­æ•°ã€åˆ†æ”¯é¢„æµ‹é”™è¯¯æ•°
- åˆ†ç±»ï¼šç¡¬ä»¶äº‹ä»¶ã€è½¯ä»¶äº‹ä»¶ã€è¿½è¸ªç‚¹äº‹ä»¶
```

---

## 2. ğŸ“Š CPUæ€§èƒ½è®¡æ•°å™¨æ·±å…¥ç†è§£


### 2.1 æ€§èƒ½è®¡æ•°å™¨åŸºç¡€æ¦‚å¿µ


**ğŸ“ éš¾åº¦ç­‰çº§**ï¼šğŸŸ¡ ä¸­çº§ç†è§£
**ğŸ“ é‡è¦ç¨‹åº¦**ï¼šâ­â­â­ æ ¸å¿ƒå¿…ä¼š

**ğŸ§  é€šä¿—ç†è§£**
```
æ€§èƒ½è®¡æ•°å™¨å°±åƒæ˜¯ç¨‹åºè¿è¡Œæ—¶çš„"è®°åˆ†ç‰Œ"
- ç¯®çƒæ¯”èµ›ï¼šè®°å½•æŠ•ç¯®æ¬¡æ•°ã€å‘½ä¸­ç‡ã€å¤±è¯¯æ¬¡æ•°
- ç¨‹åºè¿è¡Œï¼šè®°å½•æŒ‡ä»¤æ¬¡æ•°ã€ç¼“å­˜å‘½ä¸­ç‡ã€åˆ†æ”¯é¢„æµ‹æˆåŠŸç‡
```

**âš¡ å¸¸ç”¨æ€§èƒ½è®¡æ•°å™¨è¯¦è§£**

#### åŸºç¡€æŒ‡ä»¤è®¡æ•°å™¨

```bash
# æœ€åŸºç¡€çš„æ€§èƒ½æŒ‡æ ‡
perf stat -e cycles,instructions,cache-misses ./ç¨‹åºå

æŒ‡æ ‡å«ä¹‰ï¼š
cycles: CPUæ—¶é’Ÿå‘¨æœŸæ•° (ç¨‹åºè¿è¡Œäº†å¤šå°‘ä¸ªæ—¶é’Ÿå‘¨æœŸ)
instructions: æ‰§è¡Œçš„æŒ‡ä»¤æ€»æ•° (ç¨‹åºæ‰§è¡Œäº†å¤šå°‘æ¡æŒ‡ä»¤)
IPC = instructions/cycles (æ¯ä¸ªæ—¶é’Ÿå‘¨æœŸæ‰§è¡Œå¤šå°‘æ¡æŒ‡ä»¤ï¼Œè¶Šé«˜è¶Šå¥½)
```

**ğŸ’¡ å®ç”¨æŠ€å·§**
```
å¦‚ä½•åˆ¤æ–­ç¨‹åºæ•ˆç‡ï¼š
IPC > 1.0: ç¨‹åºæ•ˆç‡è¾ƒé«˜ï¼ŒCPUåˆ©ç”¨å……åˆ†
IPC < 0.5: ç¨‹åºæ•ˆç‡è¾ƒä½ï¼Œå¯èƒ½æœ‰æ€§èƒ½ç“¶é¢ˆ
IPCæ¥è¿‘0: ç¨‹åºå¤§é‡ç­‰å¾…ï¼Œå¯èƒ½æ˜¯I/Oç“¶é¢ˆ
```

#### ç¼“å­˜ç›¸å…³è®¡æ•°å™¨

```bash
# ç¼“å­˜æ€§èƒ½ç›‘æ§
perf stat -e cache-references,cache-misses,LLC-loads,LLC-load-misses ./ç¨‹åºå

æŒ‡æ ‡è§£é‡Šï¼š
cache-references: ç¼“å­˜è®¿é—®æ€»æ¬¡æ•°
cache-misses: ç¼“å­˜æœªå‘½ä¸­æ¬¡æ•°  
cache-miss-rate = cache-misses/cache-references (è¶Šä½è¶Šå¥½)
LLC: Last Level Cache(æœ€åä¸€çº§ç¼“å­˜ï¼Œé€šå¸¸æ˜¯L3)
```

### 2.2 æ€§èƒ½è®¡æ•°å™¨å®æˆ˜ç¤ºä¾‹


**ğŸ”§ åŸºç¡€æ€§èƒ½åˆ†æå‘½ä»¤**
```bash
# åŸºç¡€ç»Ÿè®¡ - äº†è§£ç¨‹åºæ•´ä½“æ€§èƒ½
perf stat ./your_program

è¾“å‡ºç¤ºä¾‹ï¼š
Performance counter stats for './your_program':
    1,234.56 msec task-clock        # 0.998 CPUs utilized
         123 context-switches       # 0.100 K/sec
           5 cpu-migrations         # 0.004 K/sec
       1,234 page-faults           # 1.000 K/sec
   1,234,567 cycles               # 1.000 GHz
   2,345,678 instructions         # 1.90 insn per cycle
     456,789 branches             # 370.000 M/sec
      12,345 branch-misses        # 2.70% of all branches
```

**ğŸ“Š ç»“æœè§£è¯»æŒ‡å—**
```
ğŸ¯ å…³é”®æŒ‡æ ‡å«ä¹‰ï¼š
task-clock: ç¨‹åºå®é™…ä½¿ç”¨CPUçš„æ—¶é—´
CPUs utilized: CPUåˆ©ç”¨ç‡(æ¥è¿‘1.0è¯´æ˜å•æ ¸å……åˆ†åˆ©ç”¨)
context-switches: ä¸Šä¸‹æ–‡åˆ‡æ¢æ¬¡æ•°(è¿‡å¤šè¯´æ˜ä»»åŠ¡è°ƒåº¦é¢‘ç¹)
insn per cycle: æ¯å‘¨æœŸæŒ‡ä»¤æ•°(è¡¡é‡CPUæ•ˆç‡çš„å…³é”®æŒ‡æ ‡)
branch-misses: åˆ†æ”¯é¢„æµ‹é”™è¯¯ç‡(å½±å“CPUæµæ°´çº¿æ•ˆç‡)
```

**ğŸ’¡ æ€§èƒ½åˆ¤æ–­æ ‡å‡†**
```
âœ… ä¼˜ç§€æ€§èƒ½æŒ‡æ ‡ï¼š
- IPC(insn per cycle) > 1.5
- branch-missç‡ < 5%
- cache-missç‡ < 10%

âŒ æ€§èƒ½é—®é¢˜æŒ‡æ ‡ï¼š
- IPC < 0.5 (CPUæ•ˆç‡ä½)
- branch-missç‡ > 20% (åˆ†æ”¯é¢„æµ‹å·®)
- cache-missç‡ > 50% (å†…å­˜è®¿é—®æ¨¡å¼å·®)
```

---

## 3. ğŸ”¥ å‡½æ•°è°ƒç”¨çƒ­ç‚¹åˆ†æå®æˆ˜


### 3.1 çƒ­ç‚¹åˆ†æåŸºæœ¬æ¦‚å¿µ


**ğŸ“ éš¾åº¦ç­‰çº§**ï¼šğŸŸ¡ ä¸­çº§ç†è§£
**ğŸ“ é‡è¦ç¨‹åº¦**ï¼šâ­â­â­â­â­ æ ¸å¿ƒå¿…ä¼š

**ğŸ¯ ä»€ä¹ˆæ˜¯çƒ­ç‚¹åˆ†æ**
```
çƒ­ç‚¹åˆ†æå°±åƒæ‰¾å‡º"æœ€è€—æ—¶çš„å·¥ä½œç¯èŠ‚"
- å·¥å‚ç”Ÿäº§ï¼šæ‰¾å‡ºæœ€æ…¢çš„ç”Ÿäº§ç¯èŠ‚è¿›è¡Œæ”¹è¿›
- ç¨‹åºä¼˜åŒ–ï¼šæ‰¾å‡ºæœ€è€—æ—¶çš„å‡½æ•°è¿›è¡Œä¼˜åŒ–

æ ¸å¿ƒæ€æƒ³ï¼š80%çš„æ—¶é—´èŠ±åœ¨20%çš„ä»£ç ä¸Š
ç›®æ ‡ï¼šæ‰¾åˆ°è¿™å…³é”®çš„20%ä»£ç å¹¶ä¼˜åŒ–
```

### 3.2 å‡½æ•°çº§æ€§èƒ½åˆ†æ


**ğŸ”§ åŸºç¡€çƒ­ç‚¹åˆ†æ**
```bash
# é‡‡æ ·å¼æ€§èƒ½åˆ†æ - æ‰¾å‡ºçƒ­ç‚¹å‡½æ•°
perf record -g ./your_program
perf report

å‚æ•°è¯´æ˜ï¼š
-g: è®°å½•è°ƒç”¨æ ˆä¿¡æ¯(call graph)
-F 1000: è®¾ç½®é‡‡æ ·é¢‘ç‡ä¸º1000Hz(æ¯ç§’é‡‡æ ·1000æ¬¡)
-e cycles: åŸºäºCPUå‘¨æœŸè¿›è¡Œé‡‡æ ·
```

**ğŸ“Š ç»“æœè§£è¯»æŠ€å·§**
```
perf reportè¾“å‡ºç¤ºä¾‹ï¼š
Samples: 1K of event 'cycles', Event count (approx.): 1234567890
Overhead  Command  Shared Object      Symbol
  25.34%  myapp    myapp              [.] hot_function
  15.67%  myapp    libc-2.31.so       [.] malloc
  12.45%  myapp    myapp              [.] another_function
   8.23%  myapp    [kernel.kallsyms]  [k] copy_user_generic

å…³é”®ä¿¡æ¯è§£è¯»ï¼š
Overhead: è¯¥å‡½æ•°å ç”¨çš„CPUæ—¶é—´ç™¾åˆ†æ¯”
Command: è¿›ç¨‹åç§°
Shared Object: å‡½æ•°æ‰€åœ¨çš„åº“æˆ–å¯æ‰§è¡Œæ–‡ä»¶
Symbol: å…·ä½“çš„å‡½æ•°åç§°
[.]: ç”¨æˆ·æ€å‡½æ•°  [k]: å†…æ ¸æ€å‡½æ•°
```

**ğŸ’¡ çƒ­ç‚¹åˆ†æç­–ç•¥**
```
ğŸ¯ ä¼˜åŒ–ä¼˜å…ˆçº§ï¼š
1. Overhead > 10%: å¿…é¡»ä¼˜åŒ–çš„çƒ­ç‚¹
2. Overhead 5-10%: é‡ç‚¹å…³æ³¨çš„å‡½æ•°
3. Overhead 1-5%: å¯è€ƒè™‘ä¼˜åŒ–
4. Overhead < 1%: ä¼˜åŒ–æ”¶ç›Šå¾ˆå°

ğŸ” åˆ†æé‡ç‚¹ï¼š
- ç”¨æˆ·æ€çƒ­ç‚¹ï¼šå…³æ³¨åº”ç”¨ç¨‹åºé€»è¾‘
- å†…æ ¸æ€çƒ­ç‚¹ï¼šå…³æ³¨ç³»ç»Ÿè°ƒç”¨å’ŒI/O
- åº“å‡½æ•°çƒ­ç‚¹ï¼šå…³æ³¨ç®—æ³•å’Œæ•°æ®ç»“æ„é€‰æ‹©
```

### 3.3 è°ƒç”¨æ ˆåˆ†ææ·±å…¥


**ğŸŒ³ è°ƒç”¨æ ˆå¯è§†åŒ–ç†è§£**
```
è°ƒç”¨æ ˆå°±åƒæ˜¯"å‡½æ•°è°ƒç”¨çš„å®¶æ—è°±"
main() -> function_a() -> function_b() -> hot_function()
  |          |              |              |
 100%       80%            60%           25%

æ¯ä¸€å±‚æ˜¾ç¤ºï¼š
- è¯¥å‡½æ•°åœ¨æ•´ä¸ªç¨‹åºä¸­çš„æ—¶é—´å æ¯”
- è¯¥å‡½æ•°è°ƒç”¨äº†å“ªäº›å­å‡½æ•°
- å„å­å‡½æ•°çš„ç›¸å¯¹è€—æ—¶
```

**ğŸ”§ é«˜çº§è°ƒç”¨æ ˆåˆ†æ**
```bash
# è¯¦ç»†çš„è°ƒç”¨æ ˆåˆ†æ
perf record -g --call-graph dwarf ./your_program
perf report --stdio --call-graph

å‚æ•°è¯¦è§£ï¼š
--call-graph dwarf: ä½¿ç”¨DWARFè°ƒè¯•ä¿¡æ¯ï¼Œè·å¾—æ›´å‡†ç¡®çš„è°ƒç”¨æ ˆ
--stdio: ä»¥æ–‡æœ¬å½¢å¼è¾“å‡ºï¼Œä¾¿äºåˆ†æ
-g: è®°å½•å®Œæ•´è°ƒç”¨æ ˆä¿¡æ¯
```

**ğŸ“Š è°ƒç”¨æ ˆè¾“å‡ºè§£è¯»**
```
è°ƒç”¨æ ˆç¤ºä¾‹ï¼š
25.34%     0.12%  myapp  [.] hot_function
           |
           --- hot_function
              |
              |--15.67%-- function_b
              |          function_a  
              |          main
              |
              |--9.67%-- another_path
                         different_caller
                         main

è§£è¯»æ–¹æ³•ï¼š
- 25.34%: hot_functionæ€»æ—¶é—´å æ¯”
- 0.12%: hot_functionè‡ªèº«æ—¶é—´å æ¯”(ä¸åŒ…æ‹¬å­å‡½æ•°)
- è°ƒç”¨è·¯å¾„æ˜¾ç¤ºäº†å‡½æ•°æ˜¯å¦‚ä½•è¢«è°ƒç”¨çš„
```

---

## 4. ğŸŒ ç³»ç»Ÿçº§æ€§èƒ½äº‹ä»¶ç›‘æ§


### 4.1 ç³»ç»Ÿçº§ç›‘æ§æ¦‚è¿°


**ğŸ“ éš¾åº¦ç­‰çº§**ï¼šğŸŸ¡ ä¸­çº§ç†è§£
**ğŸ“ é‡è¦ç¨‹åº¦**ï¼šâ­â­â­â­ é‡ç‚¹æŒæ¡

**ğŸ—ï¸ ç³»ç»Ÿçº§ç›‘æ§æ¶æ„å›¾**
```
åº”ç”¨ç¨‹åºå±‚     [è¿›ç¨‹A] [è¿›ç¨‹B] [è¿›ç¨‹C]
                 â†“       â†“       â†“
æ“ä½œç³»ç»Ÿå±‚     [è°ƒåº¦å™¨] [å†…å­˜ç®¡ç†] [I/Oå­ç³»ç»Ÿ]
                 â†“       â†“       â†“
ç¡¬ä»¶å±‚        [CPU]   [å†…å­˜]   [å­˜å‚¨è®¾å¤‡]
                 â†“       â†“       â†“
æ€§èƒ½è®¡æ•°å™¨     [æŒ‡ä»¤ç»Ÿè®¡][è®¿å­˜ç»Ÿè®¡][I/Oç»Ÿè®¡]
```

### 4.2 ç³»ç»Ÿçº§äº‹ä»¶ç±»å‹è¯¦è§£


**âš¡ ç¡¬ä»¶äº‹ä»¶ç›‘æ§**
```bash
# CPUç¡¬ä»¶äº‹ä»¶å…¨é¢ç›‘æ§
perf stat -e cycles,instructions,cache-references,cache-misses,\
branch-instructions,branch-misses,bus-cycles,ref-cycles \
-a sleep 10

å‚æ•°è¯´æ˜ï¼š
-a: ç›‘æ§æ•´ä¸ªç³»ç»Ÿ(all CPUs)
sleep 10: ç›‘æ§10ç§’é’Ÿçš„ç³»ç»Ÿæ´»åŠ¨

ç¡¬ä»¶äº‹ä»¶å«ä¹‰ï¼š
cycles: CPUæ—¶é’Ÿå‘¨æœŸ
instructions: æ‰§è¡ŒæŒ‡ä»¤æ•°
cache-*: ç¼“å­˜ç›¸å…³äº‹ä»¶
branch-*: åˆ†æ”¯é¢„æµ‹ç›¸å…³äº‹ä»¶
bus-cycles: æ€»çº¿å‘¨æœŸæ•°
ref-cycles: å‚è€ƒæ—¶é’Ÿå‘¨æœŸæ•°
```

**ğŸ”§ è½¯ä»¶äº‹ä»¶ç›‘æ§**
```bash
# ç³»ç»Ÿè½¯ä»¶äº‹ä»¶ç›‘æ§
perf stat -e cpu-clock,task-clock,page-faults,context-switches,\
cpu-migrations,minor-faults,major-faults -a sleep 10

è½¯ä»¶äº‹ä»¶å«ä¹‰ï¼š
cpu-clock: CPUæ—¶é’Ÿæ—¶é—´
task-clock: ä»»åŠ¡è¿è¡Œæ—¶é—´
page-faults: é¡µé¢é”™è¯¯æ€»æ•°
context-switches: ä¸Šä¸‹æ–‡åˆ‡æ¢æ¬¡æ•°
cpu-migrations: CPUè¿ç§»æ¬¡æ•°
minor-faults: æ¬¡è¦é¡µé”™è¯¯(å†…å­˜ä¸­å·²å­˜åœ¨)
major-faults: ä¸»è¦é¡µé”™è¯¯(éœ€è¦ä»ç£ç›˜åŠ è½½)
```

### 4.3 ç³»ç»Ÿæ€§èƒ½ç“¶é¢ˆè¯†åˆ«


**ğŸ” ç³»ç»Ÿç“¶é¢ˆåˆ¤æ–­æ ‡å‡†**
```
ğŸ”¥ CPUå¯†é›†å‹ç‰¹å¾ï¼š
- CPUä½¿ç”¨ç‡ > 80%
- IPC(instructions per cycle) > 1.0
- cache-missç‡ç›¸å¯¹è¾ƒä½
- context-switchesè¾ƒå°‘

ğŸ’¾ å†…å­˜å¯†é›†å‹ç‰¹å¾ï¼š
- å¤§é‡cache-misses
- é«˜LLC(Last Level Cache)æœªå‘½ä¸­ç‡
- å¤§é‡page-faults
- IPCç›¸å¯¹è¾ƒä½

ğŸ’¿ I/Oå¯†é›†å‹ç‰¹å¾ï¼š
- CPUä½¿ç”¨ç‡è¾ƒä½ï¼Œä½†task-clockè¾ƒé«˜
- å¤§é‡major-faults
- é«˜context-switches
- é•¿æ—¶é—´çš„iowait
```

**ğŸ“Š ç³»ç»Ÿæ€§èƒ½ç›‘æ§å®ä¾‹**
```bash
# ç³»ç»Ÿæ•´ä½“æ€§èƒ½å¿«ç…§
perf stat -a -d sleep 5

è¾“å‡ºè§£è¯»ï¼š
Performance counter stats for 'system wide':
      20,123.45 msec cpu-clock                 #    4.025 CPUs utilized
         12,345 context-switches              #    0.614 K/sec
            567 cpu-migrations                #    0.028 K/sec
         89,012 page-faults                   #    0.004 M/sec
    123,456,789 cycles                       #    6.141 GHz
    234,567,890 instructions                 #    1.90  insn per cycle
     45,678,901 branches                     #    2.271 G/sec
      1,234,567 branch-misses                #    2.70% of all branches

ç³»ç»Ÿå¥åº·åº¦è¯„ä¼°ï¼š
âœ… CPUs utilized: 4.025 (å……åˆ†åˆ©ç”¨å¤šæ ¸)
âœ… insn per cycle: 1.90 (æŒ‡ä»¤æ‰§è¡Œæ•ˆç‡è‰¯å¥½)
âœ… branch-misses: 2.70% (åˆ†æ”¯é¢„æµ‹è‰¯å¥½)
```

---

## 5. ğŸ’¾ ç¼“å­˜æ€§èƒ½åˆ†æè¯¦è§£


### 5.1 ç¼“å­˜å±‚æ¬¡ç»“æ„ç†è§£


**ğŸ“ éš¾åº¦ç­‰çº§**ï¼šğŸŸ¡ ä¸­çº§ç†è§£
**ğŸ“ é‡è¦ç¨‹åº¦**ï¼šâ­â­â­â­ é‡ç‚¹æŒæ¡

**ğŸ—ï¸ CPUç¼“å­˜å±‚æ¬¡å›¾**
```
CPUæ ¸å¿ƒ
    â†“ (æœ€å¿«ï¼Œå®¹é‡æœ€å°)
  L1ç¼“å­˜ (32KB) - 1-2ä¸ªæ—¶é’Ÿå‘¨æœŸ
    â†“
  L2ç¼“å­˜ (256KB) - 10-20ä¸ªæ—¶é’Ÿå‘¨æœŸ  
    â†“
  L3ç¼“å­˜ (8MB) - 30-40ä¸ªæ—¶é’Ÿå‘¨æœŸ
    â†“ (æœ€æ…¢ï¼Œå®¹é‡æœ€å¤§)
  ä¸»å†…å­˜ (GBçº§) - 100-300ä¸ªæ—¶é’Ÿå‘¨æœŸ
```

**ğŸ’¡ ç¼“å­˜æ€§èƒ½å½±å“å› å­**
```
ç¼“å­˜å‘½ä¸­ç‡å¯¹æ€§èƒ½çš„å·¨å¤§å½±å“ï¼š
- L1å‘½ä¸­: 1-2ä¸ªå‘¨æœŸ
- L2å‘½ä¸­: 10-20ä¸ªå‘¨æœŸ (æ…¢10å€)
- L3å‘½ä¸­: 30-40ä¸ªå‘¨æœŸ (æ…¢30å€)
- å†…å­˜è®¿é—®: 100-300ä¸ªå‘¨æœŸ (æ…¢100å€!)

ç»“è®ºï¼šæé«˜ç¼“å­˜å‘½ä¸­ç‡æ˜¯æ€§èƒ½ä¼˜åŒ–çš„å…³é”®
```

### 5.2 ç¼“å­˜å‘½ä¸­ç‡åˆ†æå®æˆ˜


**ğŸ”§ è¯¦ç»†ç¼“å­˜åˆ†æå‘½ä»¤**
```bash
# L1ç¼“å­˜åˆ†æ
perf stat -e L1-dcache-loads,L1-dcache-load-misses,\
L1-dcache-stores,L1-dcache-store-misses ./your_program

# L2ç¼“å­˜åˆ†æ  
perf stat -e L1-dcache-loads,L1-dcache-load-misses,\
l2_rqsts.all_demand_data_rd,l2_rqsts.demand_data_rd_miss ./your_program

# L3ç¼“å­˜åˆ†æ
perf stat -e LLC-loads,LLC-load-misses,LLC-stores,LLC-store-misses ./your_program

ç¼“å­˜äº‹ä»¶å«ä¹‰ï¼š
L1-dcache-loads: L1æ•°æ®ç¼“å­˜åŠ è½½æ¬¡æ•°
L1-dcache-load-misses: L1æ•°æ®ç¼“å­˜åŠ è½½æœªå‘½ä¸­æ¬¡æ•°
LLC: Last Level Cache(æœ€åä¸€çº§ç¼“å­˜ï¼Œé€šå¸¸æ˜¯L3)
```

**ğŸ“Š ç¼“å­˜æ€§èƒ½è®¡ç®—ä¸è¯„ä¼°**
```bash
# ç¼“å­˜å‘½ä¸­ç‡è®¡ç®—ç¤ºä¾‹
perf stat -e cache-references,cache-misses,\
L1-dcache-loads,L1-dcache-load-misses,\
LLC-loads,LLC-load-misses ./your_program

ç»“æœç¤ºä¾‹ï¼š
     1,234,567      cache-references
       123,456      cache-misses              #   10.0% of all cache refs
    10,234,567      L1-dcache-loads
       234,567      L1-dcache-load-misses     #    2.3% of all L1-dcache hits
     1,034,567      LLC-loads  
       634,567      LLC-load-misses           #   61.3% of all LLC hits

æ€§èƒ½è¯„ä¼°ï¼š
âœ… L1 miss rate: 2.3% (ä¼˜ç§€ï¼Œ< 5%)
âš ï¸ LLC miss rate: 61.3% (éœ€è¦ä¼˜åŒ–ï¼Œ> 50%)
```

### 5.3 ç¼“å­˜ä¼˜åŒ–ç­–ç•¥


**ğŸ¯ ç¼“å­˜å‹å¥½ç¼–ç¨‹æŠ€å·§**
```
ğŸ”¸ æ•°æ®å±€éƒ¨æ€§ä¼˜åŒ–ï¼š
æ—¶é—´å±€éƒ¨æ€§: åˆšè®¿é—®çš„æ•°æ®å¾ˆå¯èƒ½å†æ¬¡è®¿é—®
ç©ºé—´å±€éƒ¨æ€§: ç›¸é‚»çš„æ•°æ®å¾ˆå¯èƒ½è¢«ä¸€èµ·è®¿é—®

ğŸ”¸ å…·ä½“ä¼˜åŒ–æ–¹æ³•ï¼š
1. æ•°ç»„è®¿é—®: æŒ‰è¡Œéå†è€Œä¸æ˜¯æŒ‰åˆ—éå†
2. æ•°æ®ç»“æ„: å°†ç›¸å…³æ•°æ®æ”¾åœ¨ä¸€èµ·(struct packing)
3. å¾ªç¯ä¼˜åŒ–: å‡å°‘è·³è·ƒå¼å†…å­˜è®¿é—®
4. é¢„å–: ä½¿ç”¨__builtin_prefetchæç¤ºCPU
```

**ğŸ’» ç¼“å­˜ä¼˜åŒ–ä»£ç ç¤ºä¾‹**
```c
// âŒ ç¼“å­˜ä¸å‹å¥½çš„å†™æ³•
for(int j = 0; j < N; j++) {
    for(int i = 0; i < N; i++) {
        matrix[i][j] = 0;  // æŒ‰åˆ—è®¿é—®ï¼Œè·³è·ƒå¼è®¿é—®
    }
}

// âœ… ç¼“å­˜å‹å¥½çš„å†™æ³•  
for(int i = 0; i < N; i++) {
    for(int j = 0; j < N; j++) {
        matrix[i][j] = 0;  // æŒ‰è¡Œè®¿é—®ï¼Œè¿ç»­è®¿é—®
    }
}
```

---

## 6. ğŸ¯ åˆ†æ”¯é¢„æµ‹æ€§èƒ½ä¼˜åŒ–


### 6.1 åˆ†æ”¯é¢„æµ‹åŸºç¡€æ¦‚å¿µ


**ğŸ“ éš¾åº¦ç­‰çº§**ï¼šğŸŸ¡ ä¸­çº§ç†è§£
**ğŸ“ é‡è¦ç¨‹åº¦**ï¼šâ­â­â­ éœ€è¦æŒæ¡

**ğŸ§  åˆ†æ”¯é¢„æµ‹é€šä¿—ç†è§£**
```
åˆ†æ”¯é¢„æµ‹å°±åƒæ˜¯"èµ°è·¯æ—¶çš„é¢„åˆ¤"
- é‡åˆ°å²”è·¯å£ï¼šCPUè¦é¢„æµ‹ç¨‹åºä¼šèµ°å“ªæ¡è·¯
- é¢„æµ‹æ­£ç¡®ï¼šç»§ç»­æµç•…å‰è¿›(æµæ°´çº¿ä¸åœé¡¿)
- é¢„æµ‹é”™è¯¯ï¼šéœ€è¦è¿”å›é‡æ–°èµ°(æµæ°´çº¿æ¸…ç©ºé‡æ¥)

å½±å“ï¼šé¢„æµ‹é”™è¯¯ä¼šå¯¼è‡´5-20ä¸ªæ—¶é’Ÿå‘¨æœŸçš„æŸå¤±
```

### 6.2 åˆ†æ”¯é¢„æµ‹åˆ†æå®æˆ˜


**ğŸ”§ åˆ†æ”¯é¢„æµ‹ç›‘æ§å‘½ä»¤**
```bash
# åŸºç¡€åˆ†æ”¯é¢„æµ‹åˆ†æ
perf stat -e branches,branch-misses ./your_program

# è¯¦ç»†åˆ†æ”¯é¢„æµ‹åˆ†æ
perf stat -e branch-instructions,branch-misses,\
branch-loads,branch-load-misses ./your_program

# æ¡ä»¶åˆ†æ”¯ä¸“é¡¹åˆ†æ (Intel CPU)
perf stat -e br_inst_retired.conditional,\
br_misp_retired.conditional ./your_program

åˆ†æ”¯äº‹ä»¶å«ä¹‰ï¼š
branches: åˆ†æ”¯æŒ‡ä»¤æ€»æ•°
branch-misses: åˆ†æ”¯é¢„æµ‹é”™è¯¯æ•°  
branch-miss-rate = branch-misses/branches
```

**ğŸ“Š åˆ†æ”¯é¢„æµ‹æ€§èƒ½è¯„ä¼°**
```
åˆ†æ”¯é¢„æµ‹æ€§èƒ½æ ‡å‡†ï¼š
âœ… ä¼˜ç§€: branch-missç‡ < 5%
âš ï¸ ä¸€èˆ¬: branch-missç‡ 5-15%  
âŒ è¾ƒå·®: branch-missç‡ > 15%

å®é™…ç¤ºä¾‹ï¼š
     5,234,567      branches
       123,456      branch-misses             #    2.36% of all branches

è¯„ä¼°ï¼š2.36%çš„é”™è¯¯ç‡å±äºä¼˜ç§€æ°´å¹³
```

### 6.3 åˆ†æ”¯é¢„æµ‹ä¼˜åŒ–æŠ€å·§


**ğŸ’¡ ä»£ç ä¼˜åŒ–ç­–ç•¥**
```c
// âŒ åˆ†æ”¯é¢„æµ‹ä¸å‹å¥½çš„ä»£ç 
for(int i = 0; i < n; i++) {
    if(random_condition[i]) {  // éšæœºæ¡ä»¶ï¼Œæ— æ³•é¢„æµ‹
        do_something();
    }
}

// âœ… åˆ†æ”¯é¢„æµ‹å‹å¥½çš„ä»£ç 
// æ–¹æ³•1: å‡å°‘åˆ†æ”¯
for(int i = 0; i < n; i++) {
    result[i] = condition[i] ? value_a : value_b;  // æ¡ä»¶èµ‹å€¼
}

// æ–¹æ³•2: åˆ†æ”¯æç¤º
for(int i = 0; i < n; i++) {
    if(__builtin_expect(common_condition[i], 1)) {  // æç¤ºå¸¸è§æƒ…å†µ
        common_path();
    } else {
        rare_path();
    }
}
```

**ğŸ¯ åˆ†æ”¯ä¼˜åŒ–å®ç”¨æŠ€å·§**
```
ğŸ”¸ ä¼˜åŒ–ç­–ç•¥ï¼š
1. å‡å°‘æ¡ä»¶åˆ†æ”¯: ä½¿ç”¨ç®—æœ¯è¿ç®—æ›¿ä»£
2. åˆ†æ”¯æç¤º: ä½¿ç”¨__builtin_expect
3. æ•°æ®æ’åº: è®©æ¡ä»¶æ›´æœ‰è§„å¾‹
4. å¾ªç¯å±•å¼€: å‡å°‘å¾ªç¯æ§åˆ¶åˆ†æ”¯
5. å‡½æ•°å†…è”: å‡å°‘å‡½æ•°è°ƒç”¨åˆ†æ”¯

ğŸ”¸ ç¼–è¯‘å™¨ä¼˜åŒ–ï¼š
gcc -O2 -march=native: å¯ç”¨åˆ†æ”¯ä¼˜åŒ–
gcc -fprofile-generate/use: åŸºäºåé¦ˆçš„ä¼˜åŒ–
```

---

## 7. ğŸ”¥ ç«ç„°å›¾ç”Ÿæˆä¸å¯è§†åŒ–åˆ†æ


### 7.1 ç«ç„°å›¾æ¦‚è¿°


**ğŸ“ éš¾åº¦ç­‰çº§**ï¼šğŸŸ¡ ä¸­çº§ç†è§£
**ğŸ“ é‡è¦ç¨‹åº¦**ï¼šâ­â­â­â­â­ æ ¸å¿ƒå¿…ä¼š

**ğŸ¯ ç«ç„°å›¾é€šä¿—ç†è§£**
```
ç«ç„°å›¾å°±åƒæ˜¯"æ€§èƒ½çš„Xå…‰ç‰‡"
- Xå…‰ç‰‡ï¼šæ˜¾ç¤ºéª¨éª¼ç»“æ„ï¼Œæ‰¾å‡ºéª¨æŠ˜ä½ç½®
- ç«ç„°å›¾ï¼šæ˜¾ç¤ºè°ƒç”¨ç»“æ„ï¼Œæ‰¾å‡ºæ€§èƒ½ç“¶é¢ˆ

ç‰¹ç‚¹ï¼š
- æ¨ªå‘å®½åº¦ = å‡½æ•°è€—æ—¶æ¯”ä¾‹
- çºµå‘é«˜åº¦ = è°ƒç”¨æ ˆæ·±åº¦  
- é¢œè‰²æ·±æµ… = å‡½æ•°çƒ­åº¦(å¯é€‰)
```

### 7.2 ç«ç„°å›¾ç”Ÿæˆå®æˆ˜


**ğŸ”§ ç«ç„°å›¾ç”Ÿæˆæ­¥éª¤**
```bash
# ç¬¬ä¸€æ­¥ï¼šæ”¶é›†æ€§èƒ½æ•°æ®
perf record -F 1000 -g ./your_program

# ç¬¬äºŒæ­¥ï¼šå¯¼å‡ºè°ƒç”¨æ ˆæ•°æ®
perf script > perf.data.txt

# ç¬¬ä¸‰æ­¥ï¼šç”Ÿæˆç«ç„°å›¾ (éœ€è¦å®‰è£…FlameGraphå·¥å…·)
git clone https://github.com/brendangregg/FlameGraph
cd FlameGraph

# ç¬¬å››æ­¥ï¼šå¤„ç†æ•°æ®å¹¶ç”ŸæˆSVGç«ç„°å›¾
./stackcollapse-perf.pl ../perf.data.txt | ./flamegraph.pl > flame.svg

å‚æ•°è§£é‡Šï¼š
-F 1000: é‡‡æ ·é¢‘ç‡1000Hz(æ¯ç§’1000æ¬¡)
-g: è®°å½•è°ƒç”¨æ ˆä¿¡æ¯
perf script: å¯¼å‡ºå¯è¯»çš„è°ƒç”¨æ ˆæ–‡æœ¬
```

**ğŸŒ åœ¨çº¿ç«ç„°å›¾ç”Ÿæˆ**
```bash
# ä½¿ç”¨åœ¨çº¿å·¥å…·å¿«é€Ÿç”Ÿæˆ
perf record -F 1000 -g ./your_program
perf script | curl -F 'file=@-' https://flamegraph.com/

# æˆ–è€…ä½¿ç”¨perfè‡ªå¸¦çš„ç«ç„°å›¾åŠŸèƒ½(è¾ƒæ–°ç‰ˆæœ¬)
perf record -F 1000 -g ./your_program
perf report --stdio --call-graph > call_graph.txt
```

### 7.3 ç«ç„°å›¾è§£è¯»æŠ€å·§


**ğŸ“Š ç«ç„°å›¾è§£è¯»æ–¹æ³•**
```
ğŸ”¥ ç«ç„°å›¾è§£è¯»è¦ç‚¹ï¼š

æ¨ªè½´ (å®½åº¦)ï¼š
- å®½åº¦ = è¯¥å‡½æ•°å ç”¨CPUæ—¶é—´çš„æ¯”ä¾‹
- æœ€å®½çš„éƒ¨åˆ† = æœ€å¤§çš„æ€§èƒ½ç“¶é¢ˆ
- å¯»æ‰¾"å¹³é¡¶å±±"(å®½è€Œå¹³çš„åŒºåŸŸ)

çºµè½´ (é«˜åº¦)ï¼š
- é«˜åº¦ = è°ƒç”¨æ ˆçš„æ·±åº¦
- ä»ä¸‹åˆ°ä¸Šï¼šmain() -> function_a() -> function_b()
- æœ€é¡¶å±‚ï¼šå®é™…æ‰§è¡ŒæŒ‡ä»¤çš„å¶å­å‡½æ•°

é¢œè‰²è§„å¾‹ï¼š
- æš–è‰²(çº¢/æ©™): ç”¨æˆ·æ€å‡½æ•°
- å†·è‰²(è“/ç»¿): å†…æ ¸æ€å‡½æ•°
- æ·±æµ…å˜åŒ–: ä¸åŒçš„å‡½æ•°æˆ–æ¨¡å—
```

**ğŸ¯ æ€§èƒ½ç“¶é¢ˆè¯†åˆ«æŠ€å·§**
```
ğŸ” å¯»æ‰¾æ€§èƒ½é—®é¢˜çš„æ–¹æ³•ï¼š

1. å¯»æ‰¾"å¹³é¡¶å±±"ï¼š
   - å®½è€Œå¹³çš„åŒºåŸŸè¡¨ç¤ºå•ä¸ªå‡½æ•°è€—æ—¶å¾ˆé•¿
   - è¿™é€šå¸¸æ˜¯æœ€ä¸»è¦çš„æ€§èƒ½ç“¶é¢ˆ

2. å¯»æ‰¾"é«˜æ¥¼"ï¼š
   - è°ƒç”¨æ ˆå¾ˆæ·±è¡¨ç¤ºå‡½æ•°è°ƒç”¨å±‚æ¬¡è¿‡å¤š
   - å¯èƒ½å­˜åœ¨è¿‡åº¦æŠ½è±¡æˆ–é€’å½’é—®é¢˜

3. é¢œè‰²åˆ†å¸ƒï¼š
   - å¤§é‡çº¢è‰²ï¼šç”¨æˆ·æ€è®¡ç®—å¯†é›†
   - å¤§é‡è“è‰²ï¼šå†…æ ¸æ€æˆ–I/Oå¯†é›†
   - å‡åŒ€åˆ†å¸ƒï¼šè´Ÿè½½æ¯”è¾ƒå‡è¡¡

4. å¯»æ‰¾æ„å¤–å‡½æ•°ï¼š
   - ä¸åº”è¯¥å‡ºç°çš„ç³»ç»Ÿå‡½æ•°
   - ä¸åº”è¯¥è€—æ—¶å¾ˆé•¿çš„å·¥å…·å‡½æ•°
```

---

## 8. ğŸ” æ€§èƒ½ç“¶é¢ˆå®šä½æ–¹æ³•è®º


### 8.1 ç³»ç»ŸåŒ–ç“¶é¢ˆåˆ†ææµç¨‹


**ğŸ“ éš¾åº¦ç­‰çº§**ï¼šğŸŸ¡ ä¸­çº§ç†è§£  
**ğŸ“ é‡è¦ç¨‹åº¦**ï¼šâ­â­â­â­â­ æ ¸å¿ƒå¿…ä¼š

**ğŸ›¤ï¸ æ€§èƒ½åˆ†ææ ‡å‡†æµç¨‹**
```
ç¬¬ä¸€æ­¥ï¼šç¡®å®šæ€§èƒ½é—®é¢˜
    â†“ (æ˜¯å¦çœŸçš„æ…¢ï¼Ÿæ…¢åœ¨å“ªé‡Œï¼Ÿ)
ç¬¬äºŒæ­¥ï¼šç³»ç»Ÿçº§æ•´ä½“åˆ†æ  
    â†“ (CPUã€å†…å­˜ã€I/Oã€ç½‘ç»œ)
ç¬¬ä¸‰æ­¥ï¼šè¿›ç¨‹çº§æ·±å…¥åˆ†æ
    â†“ (çƒ­ç‚¹å‡½æ•°ã€è°ƒç”¨å…³ç³»)
ç¬¬å››æ­¥ï¼šå‡½æ•°çº§ç²¾ç¡®åˆ†æ
    â†“ (æŒ‡ä»¤çº§ã€ç¼“å­˜çº§)
ç¬¬äº”æ­¥ï¼šä¼˜åŒ–éªŒè¯
    â†“ (å¯¹æ¯”ä¼˜åŒ–å‰å)
ç¬¬å…­æ­¥ï¼šæŒç»­ç›‘æ§
```

### 8.2 å¤šç»´åº¦æ€§èƒ½åˆ†æ


**ğŸ”§ ç»¼åˆæ€§èƒ½åˆ†æå‘½ä»¤ç»„åˆ**
```bash
# ç¬¬ä¸€æ­¥ï¼šç³»ç»Ÿæ•´ä½“æ€§èƒ½æ¦‚è§ˆ
perf top -p $(pidof your_program)  # å®æ—¶æŸ¥çœ‹çƒ­ç‚¹å‡½æ•°

# ç¬¬äºŒæ­¥ï¼šè¯¦ç»†æ€§èƒ½ç»Ÿè®¡
perf stat -d -p $(pidof your_program) sleep 10

# ç¬¬ä¸‰æ­¥ï¼šå‡½æ•°çº§çƒ­ç‚¹åˆ†æ
perf record -g -p $(pidof your_program) sleep 10
perf report --sort comm,dso,symbol

# ç¬¬å››æ­¥ï¼šç¼“å­˜æ€§èƒ½ä¸“é¡¹åˆ†æ
perf stat -e cache-references,cache-misses,LLC-loads,LLC-load-misses \
-p $(pidof your_program) sleep 10

# ç¬¬äº”æ­¥ï¼šåˆ†æ”¯é¢„æµ‹åˆ†æ
perf stat -e branches,branch-misses -p $(pidof your_program) sleep 10
```

**ğŸ“Š æ€§èƒ½é—®é¢˜åˆ†ç±»è¯Šæ–­**
```
ğŸ”¥ CPUå¯†é›†å‹é—®é¢˜è¯Šæ–­ï¼š
ç—‡çŠ¶ï¼šé«˜CPUä½¿ç”¨ç‡ï¼Œä½I/Oç­‰å¾…
åˆ†æå‘½ä»¤ï¼šperf stat -e cycles,instructions,cache-misses
å…³æ³¨æŒ‡æ ‡ï¼šIPCã€cache-missç‡ã€çƒ­ç‚¹å‡½æ•°

ğŸ’¾ å†…å­˜å¯†é›†å‹é—®é¢˜è¯Šæ–­ï¼š
ç—‡çŠ¶ï¼šå¤§é‡ç¼“å­˜æœªå‘½ä¸­ï¼Œé¢‘ç¹é¡µé”™è¯¯
åˆ†æå‘½ä»¤ï¼šperf stat -e page-faults,cache-misses,LLC-loads
å…³æ³¨æŒ‡æ ‡ï¼špage-faultç‡ã€cacheå‘½ä¸­ç‡

ğŸ’¿ I/Oå¯†é›†å‹é—®é¢˜è¯Šæ–­ï¼š
ç—‡çŠ¶ï¼šä½CPUä½¿ç”¨ç‡ï¼Œé«˜ç­‰å¾…æ—¶é—´
åˆ†æå‘½ä»¤ï¼šperf stat -e context-switches,cpu-migrations
å…³æ³¨æŒ‡æ ‡ï¼šä¸Šä¸‹æ–‡åˆ‡æ¢ã€I/Oç­‰å¾…æ—¶é—´

ğŸ”€ è°ƒåº¦é—®é¢˜è¯Šæ–­ï¼š
ç—‡çŠ¶ï¼šé¢‘ç¹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ŒCPUè¿ç§»
åˆ†æå‘½ä»¤ï¼šperf stat -e context-switches,cpu-migrations,sched:*
å…³æ³¨æŒ‡æ ‡ï¼šè°ƒåº¦å»¶è¿Ÿã€è´Ÿè½½å‡è¡¡
```

### 8.3 ç“¶é¢ˆå®šä½å®æˆ˜æ¡ˆä¾‹


**ğŸ’¼ æ¡ˆä¾‹1ï¼šCPUå¯†é›†å‹åº”ç”¨ä¼˜åŒ–**
```bash
# é—®é¢˜ï¼šç¨‹åºè¿è¡Œæ…¢ï¼ŒCPUä½¿ç”¨ç‡é«˜
# ç¬¬ä¸€æ­¥ï¼šç¡®è®¤æ˜¯CPUç“¶é¢ˆ
perf stat ./slow_program
# ç»“æœï¼šCPUä½¿ç”¨ç‡90%+ï¼ŒIPCè¾ƒä½

# ç¬¬äºŒæ­¥ï¼šæ‰¾å‡ºçƒ­ç‚¹å‡½æ•°
perf record -g ./slow_program
perf report
# ç»“æœï¼šæŸä¸ªè®¡ç®—å‡½æ•°å ç”¨60%æ—¶é—´

# ç¬¬ä¸‰æ­¥ï¼šåˆ†æå…·ä½“é—®é¢˜
perf annotate hot_function
# ç»“æœï¼šå‘ç°æŸä¸ªå¾ªç¯æ•ˆç‡ä½ä¸‹

# ä¼˜åŒ–æ–¹æ¡ˆï¼šç®—æ³•ä¼˜åŒ–ã€ç¼–è¯‘å™¨ä¼˜åŒ–
```

**ğŸ’¼ æ¡ˆä¾‹2ï¼šç¼“å­˜å¯†é›†å‹åº”ç”¨ä¼˜åŒ–**
```bash
# é—®é¢˜ï¼šç¨‹åºè¿è¡Œæ…¢ï¼ŒCPUä½¿ç”¨ç‡ä¸é«˜
# ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥ç¼“å­˜æ€§èƒ½
perf stat -e cache-references,cache-misses,LLC-loads,LLC-load-misses ./program
# ç»“æœï¼šç¼“å­˜æœªå‘½ä¸­ç‡å¾ˆé«˜(>50%)

# ç¬¬äºŒæ­¥ï¼šåˆ†æå†…å­˜è®¿é—®æ¨¡å¼
perf record -e cache-misses -g ./program
perf report
# ç»“æœï¼šæŸä¸ªæ•°æ®ç»“æ„è®¿é—®æ¨¡å¼ä¸å‹å¥½

# ä¼˜åŒ–æ–¹æ¡ˆï¼šæ•°æ®ç»“æ„é‡ç»„ã€è®¿é—®æ¨¡å¼ä¼˜åŒ–
```

---

## 9. âš™ï¸ ç¡¬ä»¶æ€§èƒ½è®¡æ•°å™¨é«˜çº§åº”ç”¨


### 9.1 ç¡¬ä»¶è®¡æ•°å™¨æ·±åº¦ç†è§£


**ğŸ“ éš¾åº¦ç­‰çº§**ï¼šğŸ”´ é«˜çº§æ·±å…¥
**ğŸ“ é‡è¦ç¨‹åº¦**ï¼šâ­â­â­ è¿›é˜¶æŒæ¡

**ğŸ”§ å¤„ç†å™¨ç‰¹å®šäº‹ä»¶åˆ†æ**
```bash
# Intelå¤„ç†å™¨ä¸“ç”¨äº‹ä»¶
perf list | grep -i intel  # æŸ¥çœ‹Intelç‰¹å®šäº‹ä»¶

# AMDå¤„ç†å™¨ä¸“ç”¨äº‹ä»¶  
perf list | grep -i amd    # æŸ¥çœ‹AMDç‰¹å®šäº‹ä»¶

# æ¶æ„æ— å…³çš„é€šç”¨äº‹ä»¶
perf list hw              # ç¡¬ä»¶äº‹ä»¶
perf list sw              # è½¯ä»¶äº‹ä»¶  
perf list cache           # ç¼“å­˜äº‹ä»¶
```

### 9.2 é«˜çº§ç¡¬ä»¶äº‹ä»¶ç›‘æ§


**âš¡ Intelå¤„ç†å™¨é«˜çº§åˆ†æ**
```bash
# å¾®æ“ä½œçº§åˆ«åˆ†æ (Intel)
perf stat -e cpu/event=0xc2,umask=0x01/,\  # UOPS_RETIRED.ALL
cpu/event=0x0e,umask=0x01/,\               # UOPS_ISSUED.ANY
cpu/event=0xa2,umask=0x01/ ./program       # RESOURCE_STALLS.ANY

# å†…å­˜å¸¦å®½åˆ†æ (Intel)
perf stat -e uncore_imc/event=0x04,umask=0x03/,\  # CAS_COUNT.RD
uncore_imc/event=0x04,umask=0x0c/ ./program       # CAS_COUNT.WR

# TLBæ€§èƒ½åˆ†æ
perf stat -e dTLB-loads,dTLB-load-misses,\
iTLB-loads,iTLB-load-misses ./program
```

**ğŸ”§ ARMå¤„ç†å™¨ä¸“ç”¨åˆ†æ**
```bash
# ARM Cortex-Aç³»åˆ—äº‹ä»¶
perf stat -e armv8_pmuv3/event=0x08/,\     # INST_RETIRED
armv8_pmuv3/event=0x11/,\                  # CPU_CYCLES  
armv8_pmuv3/event=0x04/ ./program          # L1D_CACHE_REFILL

# ARMç¼“å­˜æ€§èƒ½
perf stat -e L1-dcache-loads,L1-dcache-load-misses,\
L1-icache-loads,L1-icache-load-misses ./program
```

### 9.3 ç¡¬ä»¶æ€§èƒ½è®¡æ•°å™¨ç¼–ç¨‹


**ğŸ’» ä½¿ç”¨perf_event APIç¼–ç¨‹**
```c
#include <linux/perf_event.h>
#include <sys/syscall.h>
#include <unistd.h>

// åˆ›å»ºæ€§èƒ½è®¡æ•°å™¨
static long perf_event_open(struct perf_event_attr *hw_event,
                            pid_t pid, int cpu, int group_fd,
                            unsigned long flags) {
    return syscall(__NR_perf_event_open, hw_event, pid, cpu, group_fd, flags);
}

// ç›‘æ§CPUå‘¨æœŸæ•°ç¤ºä¾‹
int monitor_cycles() {
    struct perf_event_attr pe;
    memset(&pe, 0, sizeof(pe));
    pe.type = PERF_TYPE_HARDWARE;
    pe.size = sizeof(pe);
    pe.config = PERF_COUNT_HW_CPU_CYCLES;
    pe.disabled = 1;
    pe.exclude_kernel = 1;
    pe.exclude_hv = 1;
    
    int fd = perf_event_open(&pe, 0, -1, -1, 0);
    if (fd == -1) {
        perror("perf_event_open");
        return -1;
    }
    
    // å¼€å§‹è®¡æ•°
    ioctl(fd, PERF_EVENT_IOC_RESET, 0);
    ioctl(fd, PERF_EVENT_IOC_ENABLE, 0);
    
    // æ‰§è¡Œè¦æµ‹é‡çš„ä»£ç 
    your_function_to_measure();
    
    // åœæ­¢è®¡æ•°å¹¶è¯»å–ç»“æœ
    ioctl(fd, PERF_EVENT_IOC_DISABLE, 0);
    long long count;
    read(fd, &count, sizeof(count));
    
    printf("CPU cycles: %lld\n", count);
    close(fd);
    return 0;
}
```

---

## 10. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 10.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ perfå·¥å…·æœ¬è´¨ï¼šåŸºäºç¡¬ä»¶æ€§èƒ½è®¡æ•°å™¨çš„ä½å¼€é”€æ€§èƒ½åˆ†æå·¥å…·
ğŸ”¸ æ€§èƒ½è®¡æ•°å™¨ï¼šCPUå†…ç½®çš„ç¡¬ä»¶ç»Ÿè®¡å•å…ƒï¼Œç²¾åº¦æé«˜å¼€é”€æå°
ğŸ”¸ çƒ­ç‚¹åˆ†æï¼šæ‰¾å‡ºç¨‹åºä¸­è€—æ—¶æœ€å¤šçš„20%ä»£ç è¿›è¡Œä¼˜åŒ–
ğŸ”¸ ç¼“å­˜åˆ†æï¼šL1/L2/L3ç¼“å­˜å‘½ä¸­ç‡ç›´æ¥å½±å“ç¨‹åºæ€§èƒ½
ğŸ”¸ åˆ†æ”¯é¢„æµ‹ï¼šCPUæµæ°´çº¿æ•ˆç‡çš„å…³é”®å› ç´ ï¼Œé”™è¯¯é¢„æµ‹ä»£ä»·å·¨å¤§
ğŸ”¸ ç«ç„°å›¾ï¼šå¯è§†åŒ–æ€§èƒ½åˆ†æçš„æœ€ä½³å·¥å…·ï¼Œç›´è§‚æ˜¾ç¤ºè°ƒç”¨å…³ç³»å’Œè€—æ—¶åˆ†å¸ƒ
```

### 10.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ æ€§èƒ½åˆ†æçš„ç³»ç»ŸåŒ–æ–¹æ³•**
```
å±‚æ¬¡åŒ–åˆ†ææ€è·¯ï¼š
ç³»ç»Ÿçº§ â†’ è¿›ç¨‹çº§ â†’ å‡½æ•°çº§ â†’ æŒ‡ä»¤çº§
å…ˆå®šä½å¤§æ–¹å‘ï¼Œå†æ·±å…¥å…·ä½“ç»†èŠ‚

å¤šç»´åº¦äº¤å‰éªŒè¯ï¼š
CPU + ç¼“å­˜ + åˆ†æ”¯é¢„æµ‹ + å†…å­˜è®¿é—®
å•ä¸€æŒ‡æ ‡å¯èƒ½è¯¯å¯¼ï¼Œéœ€è¦ç»¼åˆåˆ†æ
```

**ğŸ”¹ perfå·¥å…·çš„æ ¸å¿ƒä¼˜åŠ¿**
```
ç¡¬ä»¶çº§ç²¾åº¦ï¼š
- åŸºäºCPUç¡¬ä»¶è®¡æ•°å™¨ï¼Œç²¾ç¡®åˆ°æŒ‡ä»¤çº§åˆ«
- å¼€é”€æä½(<5%)ï¼Œä¸å½±å“ç¨‹åºæ­£å¸¸è¿è¡Œ
- æ”¯æŒç³»ç»Ÿçº§å’Œåº”ç”¨çº§å…¨æ–¹ä½ç›‘æ§

æ˜“ç”¨æ€§å¼ºï¼š
- å‘½ä»¤ç®€å•ï¼Œå­¦ä¹ æˆæœ¬ä½
- è¾“å‡ºç›´è§‚ï¼Œä¾¿äºå¿«é€Ÿå®šä½é—®é¢˜
- ä¸å…¶ä»–å·¥å…·é›†æˆåº¦é«˜
```

**ğŸ”¹ æ€§èƒ½ä¼˜åŒ–çš„æ ¸å¿ƒåŸåˆ™**
```
80/20æ³•åˆ™ï¼š
- 80%çš„æ€§èƒ½é—®é¢˜é›†ä¸­åœ¨20%çš„ä»£ç ä¸­
- ä¼˜å…ˆä¼˜åŒ–çƒ­ç‚¹å‡½æ•°ï¼Œæ”¶ç›Šæœ€å¤§

ç¡¬ä»¶å‹å¥½ç¼–ç¨‹ï¼š
- æé«˜ç¼“å­˜å‘½ä¸­ç‡(æ•°æ®å±€éƒ¨æ€§)
- å‡å°‘åˆ†æ”¯é¢„æµ‹é”™è¯¯(ä»£ç å±€éƒ¨æ€§)
- å……åˆ†åˆ©ç”¨CPUæµæ°´çº¿å’Œå¹¶è¡Œæ€§
```

### 10.3 å®é™…åº”ç”¨æŒ‡å¯¼


**ğŸ¯ æ—¥å¸¸æ€§èƒ½åˆ†ææµç¨‹**
```
å¿«é€Ÿè¯Šæ–­ä¸‰æ­¥èµ°ï¼š
1. perf top â†’ å®æ—¶æŸ¥çœ‹çƒ­ç‚¹å‡½æ•°
2. perf stat â†’ è·å¾—æ•´ä½“æ€§èƒ½æ¦‚å†µ  
3. perf record + perf report â†’ è¯¦ç»†åˆ†æè°ƒç”¨å…³ç³»

æ·±åº¦åˆ†æäº”æ­¥èµ°ï¼š
1. ç³»ç»Ÿçº§æ€§èƒ½ç›‘æ§ â†’ ç¡®å®šç“¶é¢ˆç±»å‹
2. è¿›ç¨‹çº§çƒ­ç‚¹åˆ†æ â†’ å®šä½é—®é¢˜å‡½æ•°
3. å‡½æ•°çº§è¯¦ç»†åˆ†æ â†’ ç†è§£è°ƒç”¨å…³ç³»
4. æŒ‡ä»¤çº§ç²¾ç¡®åˆ†æ â†’ æ‰¾å‡ºå…·ä½“é—®é¢˜
5. ä¼˜åŒ–éªŒè¯å¯¹æ¯” â†’ ç¡®è®¤ä¼˜åŒ–æ•ˆæœ
```

**ğŸ’¡ å®ç”¨æŠ€å·§æ€»ç»“**
```
å‘½ä»¤ç»„åˆä½¿ç”¨ï¼š
perf stat + perf record + perf report â†’ å®Œæ•´æ€§èƒ½ç”»åƒ
perf top + perf annotate â†’ å®æ—¶é—®é¢˜å®šä½
ç«ç„°å›¾ + è°ƒç”¨æ ˆåˆ†æ â†’ å¯è§†åŒ–æ€§èƒ½ä¼˜åŒ–

å‚æ•°ä¼˜åŒ–å»ºè®®ï¼š
é‡‡æ ·é¢‘ç‡ï¼š1000Hz (å¹³è¡¡ç²¾åº¦å’Œå¼€é”€)
è®°å½•æ—¶é•¿ï¼š10-30ç§’ (è·å¾—ç¨³å®šç»Ÿè®¡)
ç›‘æ§èŒƒå›´ï¼šå…ˆå…¨ç³»ç»Ÿï¼Œåå…·ä½“è¿›ç¨‹
```

### 10.4 å­¦ä¹ æ£€æŸ¥ä¸è¿›é˜¶æ–¹å‘


**âœ… æŒæ¡æ£€æŸ¥æ¸…å•**
```
åŸºç¡€çº§åˆ«ï¼š
- [ ] èƒ½ä½¿ç”¨perf statåˆ†æåŸºæœ¬æ€§èƒ½æŒ‡æ ‡
- [ ] èƒ½ä½¿ç”¨perf record/reportæ‰¾å‡ºçƒ­ç‚¹å‡½æ•°
- [ ] ç†è§£CPUå‘¨æœŸã€æŒ‡ä»¤æ•°ã€ç¼“å­˜å‘½ä¸­ç‡ç­‰åŸºæœ¬æ¦‚å¿µ

è¿›é˜¶çº§åˆ«ï¼š
- [ ] èƒ½ç”Ÿæˆå’Œè§£è¯»ç«ç„°å›¾
- [ ] èƒ½åˆ†æç¼“å­˜æ€§èƒ½å’Œåˆ†æ”¯é¢„æµ‹é—®é¢˜
- [ ] èƒ½ç»“åˆå¤šä¸ªå·¥å…·è¿›è¡Œç»¼åˆæ€§èƒ½åˆ†æ

ä¸“å®¶çº§åˆ«ï¼š
- [ ] èƒ½ä½¿ç”¨ç¡¬ä»¶ç‰¹å®šçš„æ€§èƒ½è®¡æ•°å™¨
- [ ] èƒ½ç¼–å†™æ€§èƒ½åˆ†æè„šæœ¬å’Œè‡ªåŠ¨åŒ–å·¥å…·
- [ ] èƒ½åŸºäºåˆ†æç»“æœè¿›è¡Œç³»ç»Ÿçº§æ€§èƒ½ä¼˜åŒ–
```

**ğŸš€ è¿›é˜¶å­¦ä¹ æ–¹å‘**
```
å·¥å…·é“¾æ‰©å±•ï¼š
- Intel VTune: Intel CPUæ·±åº¦åˆ†æ
- AMD CodeXL: AMD GPU/CPUåˆ†æ  
- ARM Streamline: ARMæ€§èƒ½åˆ†æ
- eBPF/BCC: åŠ¨æ€è¿½è¸ªå’Œåˆ†æ

æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯ï¼š
- ç¼–è¯‘å™¨ä¼˜åŒ–æŠ€æœ¯
- å¹¶è¡Œç¼–ç¨‹ä¼˜åŒ–
- å†…å­˜ç®¡ç†ä¼˜åŒ–
- ç®—æ³•å’Œæ•°æ®ç»“æ„ä¼˜åŒ–
```

**ğŸ§  æ ¸å¿ƒè®°å¿†å£è¯€**
```
perfå·¥å…·ç¡¬ä»¶å¼ºï¼Œæ€§èƒ½åˆ†æä½å¼€é”€
çƒ­ç‚¹å‡½æ•°æ‰¾ç“¶é¢ˆï¼Œç«ç„°å›¾ä¸Šè§åˆ†æ™“  
ç¼“å­˜å‘½ä¸­ææ•ˆç‡ï¼Œåˆ†æ”¯é¢„æµ‹å‡å»¶è¿Ÿ
ç³»ç»Ÿç›‘æ§å…¨æ–¹ä½ï¼Œä¼˜åŒ–éªŒè¯ä¸å¯å°‘
```

**æ ¸å¿ƒä»·å€¼**ï¼š
- perfæ˜¯Linuxæ€§èƒ½åˆ†æçš„ç‘å£«å†›åˆ€ï¼ŒæŒæ¡å®ƒç­‰äºæŒæ¡äº†ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–çš„æ ¸å¿ƒæŠ€èƒ½
- åŸºäºç¡¬ä»¶çš„ç²¾ç¡®åˆ†æè®©æ€§èƒ½ä¼˜åŒ–æœ‰çš„æ”¾çŸ¢ï¼Œé¿å…ç›²ç›®ä¼˜åŒ–
- å¯è§†åŒ–çš„åˆ†æç»“æœè®©å¤æ‚çš„æ€§èƒ½é—®é¢˜å˜å¾—ç›´è§‚æ˜“æ‡‚
- ä½å¼€é”€çš„ç‰¹æ€§è®©ç”Ÿäº§ç¯å¢ƒæ€§èƒ½åˆ†ææˆä¸ºå¯èƒ½