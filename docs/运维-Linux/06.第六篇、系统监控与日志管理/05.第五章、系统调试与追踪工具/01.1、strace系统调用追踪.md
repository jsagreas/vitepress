---
title: 1ã€straceç³»ç»Ÿè°ƒç”¨è¿½è¸ª
---
## ğŸ“š ç›®å½•

1. [straceåŸºæœ¬æ¦‚å¿µä¸ä½œç”¨](#1-straceåŸºæœ¬æ¦‚å¿µä¸ä½œç”¨)
2. [straceå‘½ä»¤åŸºæœ¬ç”¨æ³•](#2-straceå‘½ä»¤åŸºæœ¬ç”¨æ³•)
3. [ç³»ç»Ÿè°ƒç”¨è¾“å‡ºè§£è¯»](#3-ç³»ç»Ÿè°ƒç”¨è¾“å‡ºè§£è¯»)
4. [è¿›ç¨‹ç›‘æ§ä¸è¿½è¸ªé€‰é¡¹](#4-è¿›ç¨‹ç›‘æ§ä¸è¿½è¸ªé€‰é¡¹)
5. [ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤ä¸åˆ†ç±»](#5-ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤ä¸åˆ†ç±»)
6. [æ—¶é—´æˆ³ä¸æ€§èƒ½åˆ†æ](#6-æ—¶é—´æˆ³ä¸æ€§èƒ½åˆ†æ)
7. [è¾“å‡ºç®¡ç†ä¸æ—¥å¿—è®°å½•](#7-è¾“å‡ºç®¡ç†ä¸æ—¥å¿—è®°å½•)
8. [å®é™…åº”ç”¨åœºæ™¯åˆ†æ](#8-å®é™…åº”ç”¨åœºæ™¯åˆ†æ)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” straceåŸºæœ¬æ¦‚å¿µä¸ä½œç”¨


### 1.1 ä»€ä¹ˆæ˜¯strace


**ğŸ”¸ ç®€å•ç†è§£**
```
strace = system call traceï¼ˆç³»ç»Ÿè°ƒç”¨è¿½è¸ªï¼‰
å°±åƒç»™ç¨‹åºè£…äº†ä¸ª"ç›‘å¬å™¨"ï¼Œèƒ½å¬åˆ°ç¨‹åºå’Œæ“ä½œç³»ç»Ÿçš„"å¯¹è¯"
```

**ğŸ’¡ å½¢è±¡æ¯”å–»**
```
ç¨‹åºè¿è¡Œå°±åƒäººåœ¨é¤å…ç‚¹é¤ï¼š
- ç¨‹åº = é¡¾å®¢
- æ“ä½œç³»ç»Ÿ = æœåŠ¡å‘˜  
- ç³»ç»Ÿè°ƒç”¨ = ç‚¹é¤å¯¹è¯

straceå°±æ˜¯ååœ¨æ—è¾¹çš„"å·å¬è€…"ï¼Œè®°å½•ä¸‹æ‰€æœ‰å¯¹è¯å†…å®¹
```

### 1.2 straceçš„æ ¸å¿ƒä½œç”¨


**ğŸ¯ ä¸»è¦åŠŸèƒ½**
- **è°ƒè¯•ç¨‹åº** - æ‰¾å‡ºç¨‹åºå“ªé‡Œå‡ºé”™äº†
- **æ€§èƒ½åˆ†æ** - çœ‹ç¨‹åºæ…¢åœ¨å“ªä¸ªç¯èŠ‚
- **å®‰å…¨å®¡è®¡** - ç›‘æ§ç¨‹åºè®¿é—®äº†ä»€ä¹ˆæ–‡ä»¶
- **å­¦ä¹ ç†è§£** - äº†è§£ç¨‹åºå†…éƒ¨å·¥ä½œåŸç†

### 1.3 ç³»ç»Ÿè°ƒç”¨æ˜¯ä»€ä¹ˆ


**ğŸ”¸ é€šä¿—è§£é‡Š**
```
ç³»ç»Ÿè°ƒç”¨ = ç¨‹åºå‘æ“ä½œç³»ç»Ÿæå‡ºçš„"è¯·æ±‚"

å¸¸è§çš„ç³»ç»Ÿè°ƒç”¨ï¼š
ğŸ“ open()  - "å¸®æˆ‘æ‰“å¼€è¿™ä¸ªæ–‡ä»¶"
ğŸ“ write() - "å¸®æˆ‘å†™å…¥æ•°æ®"
ğŸ“– read()  - "å¸®æˆ‘è¯»å–å†…å®¹"  
ğŸšª exit()  - "æˆ‘è¦é€€å‡ºäº†"
```

**ğŸ—ï¸ ç³»ç»Ÿè°ƒç”¨å·¥ä½œæµç¨‹**
```
ç”¨æˆ·ç¨‹åº                æ“ä½œç³»ç»Ÿå†…æ ¸
    |                        |
    |--[1]å‘èµ·ç³»ç»Ÿè°ƒç”¨------->|
    |   (æ¯”å¦‚æ‰“å¼€æ–‡ä»¶)         |
    |                        |--[2]æ‰§è¡Œå…·ä½“æ“ä½œ
    |                        |   (çœŸæ­£æ‰“å¼€æ–‡ä»¶)
    |<--[3]è¿”å›ç»“æœ----------|
    |   (æ–‡ä»¶æè¿°ç¬¦/é”™è¯¯ç )    |
```

---

## 2. ğŸ› ï¸ straceå‘½ä»¤åŸºæœ¬ç”¨æ³•


### 2.1 åŸºç¡€è¯­æ³•æ ¼å¼


**ğŸ“‹ å‘½ä»¤æ ¼å¼**
```bash
strace [é€‰é¡¹] å‘½ä»¤
strace [é€‰é¡¹] -p è¿›ç¨‹ID
```

### 2.2 æœ€ç®€å•çš„ä½¿ç”¨æ–¹å¼


**ğŸ”¸ è¿½è¸ªæ–°å¯åŠ¨çš„ç¨‹åº**
```bash
# è¿½è¸ª ls å‘½ä»¤çš„ç³»ç»Ÿè°ƒç”¨
strace ls

# è¿½è¸ª cat å‘½ä»¤è¯»å–æ–‡ä»¶
strace cat /etc/passwd
```

**ğŸ’­ è¾“å‡ºç¤ºä¾‹è§£è¯»**
```bash
$ strace ls
execve("/bin/ls", ["ls"], [/* ç¯å¢ƒå˜é‡ */]) = 0
openat(AT_FDCWD, "/etc/ld.so.cache", O_RDONLY|O_CLOEXEC) = 3
read(3, "\177ELF\2\1\1\0\0\0\0\0\0\0\0\0", 832) = 832
...

ç®€å•ç†è§£ï¼š
- execve() = æ‰§è¡Œlsç¨‹åº
- openat() = æ‰“å¼€æŸä¸ªæ–‡ä»¶  
- read() = è¯»å–æ–‡ä»¶å†…å®¹
```

### 2.3 è¿½è¸ªæ­£åœ¨è¿è¡Œçš„è¿›ç¨‹


**ğŸ”¸ æ ¹æ®è¿›ç¨‹IDè¿½è¸ª**
```bash
# å…ˆæ‰¾åˆ°è¿›ç¨‹ID
ps aux | grep nginx

# è¿½è¸ªæŒ‡å®šè¿›ç¨‹
strace -p 1234
```

**âš¡ å®é™…æ“ä½œç¤ºä¾‹**
```bash
# å¯åŠ¨ä¸€ä¸ªé•¿æœŸè¿è¡Œçš„ç¨‹åº
sleep 100 &

# è·å–è¿›ç¨‹IDå¹¶è¿½è¸ª
jobs -l
strace -p è¿›ç¨‹ID
```

---

## 3. ğŸ“– ç³»ç»Ÿè°ƒç”¨è¾“å‡ºè§£è¯»


### 3.1 è¾“å‡ºæ ¼å¼è¯¦è§£


**ğŸ“Š æ ‡å‡†è¾“å‡ºæ ¼å¼**
```
ç³»ç»Ÿè°ƒç”¨å(å‚æ•°1, å‚æ•°2, ...) = è¿”å›å€¼
```

**ğŸ”¸ å…·ä½“ç¤ºä¾‹åˆ†æ**
```bash
open("/etc/passwd", O_RDONLY) = 3
â”‚     â”‚              â”‚         â”‚
â”‚     â”‚              â”‚         â””â”€ è¿”å›å€¼(æ–‡ä»¶æè¿°ç¬¦)
â”‚     â”‚              â””â”€ å‚æ•°2(æ‰“å¼€æ–¹å¼)  
â”‚     â””â”€ å‚æ•°1(æ–‡ä»¶è·¯å¾„)
â””â”€ ç³»ç»Ÿè°ƒç”¨å
```

### 3.2 å¸¸è§ç³»ç»Ÿè°ƒç”¨å«ä¹‰


**ğŸ“ æ–‡ä»¶æ“ä½œç±»**
```bash
# æ‰“å¼€æ–‡ä»¶
open("/path/to/file", O_RDONLY) = 3
# å«ä¹‰ï¼šä»¥åªè¯»æ–¹å¼æ‰“å¼€æ–‡ä»¶ï¼ŒæˆåŠŸè¿”å›æ–‡ä»¶æè¿°ç¬¦3

# è¯»å–æ–‡ä»¶  
read(3, "hello world\n", 4096) = 12
# å«ä¹‰ï¼šä»æ–‡ä»¶æè¿°ç¬¦3è¯»å–æœ€å¤š4096å­—èŠ‚ï¼Œå®é™…è¯»åˆ°12å­—èŠ‚

# å†™å…¥æ–‡ä»¶
write(1, "hello\n", 6) = 6  
# å«ä¹‰ï¼šå‘æ–‡ä»¶æè¿°ç¬¦1(æ ‡å‡†è¾“å‡º)å†™å…¥6å­—èŠ‚ï¼ŒæˆåŠŸå†™å…¥6å­—èŠ‚

# å…³é—­æ–‡ä»¶
close(3) = 0
# å«ä¹‰ï¼šå…³é—­æ–‡ä»¶æè¿°ç¬¦3ï¼ŒæˆåŠŸè¿”å›0
```

**ğŸŒ ç½‘ç»œæ“ä½œç±»**
```bash
# åˆ›å»ºå¥—æ¥å­—
socket(AF_INET, SOCK_STREAM, IPPROTO_TCP) = 4
# å«ä¹‰ï¼šåˆ›å»ºTCPå¥—æ¥å­—ï¼Œè¿”å›æ–‡ä»¶æè¿°ç¬¦4

# è¿æ¥æœåŠ¡å™¨  
connect(4, {sa_family=AF_INET, sin_port=htons(80)}, 16) = 0
# å«ä¹‰ï¼šè¿æ¥åˆ°80ç«¯å£ï¼ŒæˆåŠŸè¿”å›0
```

### 3.3 è¿”å›å€¼å«ä¹‰


**âœ… æˆåŠŸæƒ…å†µ**
```bash
# è¿”å›å€¼ >= 0 é€šå¸¸è¡¨ç¤ºæˆåŠŸ
open("/tmp/test", O_WRONLY|O_CREAT, 0644) = 3
read(3, "data", 100) = 4
```

**âŒ é”™è¯¯æƒ…å†µ**  
```bash
# è¿”å›å€¼ = -1 è¡¨ç¤ºå‡ºé”™ï¼Œerrnoæ˜¾ç¤ºå…·ä½“é”™è¯¯
open("/root/secret", O_RDONLY) = -1 EACCES (Permission denied)
#                                    â†‘       â†‘
#                                 é”™è¯¯ç    é”™è¯¯æè¿°
```

**ğŸ”¢ å¸¸è§é”™è¯¯ç å«ä¹‰**
| é”™è¯¯ç  | å«ä¹‰ | é€šä¿—è§£é‡Š |
|--------|------|----------|
| `EACCES` | æƒé™æ‹’ç» | æ²¡æœ‰æƒé™è®¿é—®è¿™ä¸ªæ–‡ä»¶ |
| `ENOENT` | æ–‡ä»¶ä¸å­˜åœ¨ | æ‰¾ä¸åˆ°æŒ‡å®šçš„æ–‡ä»¶ |
| `ECONNREFUSED` | è¿æ¥è¢«æ‹’ç» | æœåŠ¡å™¨æ‹’ç»è¿æ¥ |
| `EAGAIN` | èµ„æºä¸´æ—¶ä¸å¯ç”¨ | ç¨åé‡è¯•å¯èƒ½æˆåŠŸ |

---

## 4. ğŸ‘¥ è¿›ç¨‹ç›‘æ§ä¸è¿½è¸ªé€‰é¡¹


### 4.1 å­è¿›ç¨‹è¿½è¸ª(-få‚æ•°)


**ğŸ”¸ ä¸ºä»€ä¹ˆéœ€è¦è¿½è¸ªå­è¿›ç¨‹**
```
å¾ˆå¤šç¨‹åºä¼šåˆ›å»ºå­è¿›ç¨‹æ¥å®Œæˆå·¥ä½œï¼š
- WebæœåŠ¡å™¨ä¸ºæ¯ä¸ªè¯·æ±‚åˆ›å»ºå­è¿›ç¨‹
- shellè„šæœ¬æ‰§è¡Œå…¶ä»–å‘½ä»¤  
- ç¨‹åºè°ƒç”¨ç³»ç»Ÿå·¥å…·

ä¸è¿½è¸ªå­è¿›ç¨‹å°±çœ‹ä¸åˆ°å®Œæ•´çš„æ‰§è¡Œè¿‡ç¨‹
```

**âš¡ ä½¿ç”¨-få‚æ•°**
```bash
# ä¸è¿½è¸ªå­è¿›ç¨‹ï¼ˆåªçœ‹çˆ¶è¿›ç¨‹ï¼‰
strace sh -c "ls /tmp"

# è¿½è¸ªæ‰€æœ‰å­è¿›ç¨‹  
strace -f sh -c "ls /tmp"
```

**ğŸ“Š å¯¹æ¯”æ•ˆæœ**
```bash
# æ²¡æœ‰-få‚æ•°çš„è¾“å‡º
clone(child_stack=NULL, flags=CLONE_CHILD_CLEARTID...) = 1234
wait4(1234, NULL, 0, NULL) = 1234
# åªèƒ½çœ‹åˆ°åˆ›å»ºå’Œç­‰å¾…å­è¿›ç¨‹ï¼Œçœ‹ä¸åˆ°å­è¿›ç¨‹åšäº†ä»€ä¹ˆ

# æœ‰-få‚æ•°çš„è¾“å‡º  
[pid 1234] execve("/bin/ls", ["ls", "/tmp"], ...) = 0
[pid 1234] openat(AT_FDCWD, "/tmp", O_RDONLY) = 3
[pid 1234] getdents64(3, /* ç›®å½•å†…å®¹ */, 32768) = 120
# èƒ½çœ‹åˆ°å­è¿›ç¨‹çš„å®Œæ•´æ‰§è¡Œè¿‡ç¨‹
```

### 4.2 è¿›ç¨‹è¿‡æ»¤ä¸é€‰æ‹©


**ğŸ¯ åªè¿½è¸ªç‰¹å®šè¿›ç¨‹**
```bash
# è¿½è¸ªç‰¹å®šè¿›ç¨‹åŠå…¶å­è¿›ç¨‹
strace -f -p 1234

# è¿½è¸ªæ–°è¿›ç¨‹ä½†æ’é™¤æŸäº›å­è¿›ç¨‹ï¼ˆéœ€è¦ç»“åˆå…¶ä»–å·¥å…·ï¼‰
strace -f program | grep -v "æŸäº›ä¸å…³å¿ƒçš„è°ƒç”¨"
```

---

## 5. ğŸ”§ ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤ä¸åˆ†ç±»


### 5.1 -eå‚æ•°çš„å¼ºå¤§åŠŸèƒ½


**ğŸ”¸ åŸºæœ¬è¯­æ³•**
```bash
strace -e ç±»åˆ«=è°ƒç”¨å å‘½ä»¤
strace -e ç±»åˆ« å‘½ä»¤  
```

### 5.2 æŒ‰ç³»ç»Ÿè°ƒç”¨ç±»å‹è¿‡æ»¤


**ğŸ“ æ–‡ä»¶æ“ä½œç±»**
```bash
# åªçœ‹æ–‡ä»¶ç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨
strace -e trace=file ls /tmp
strace -e file ls /tmp

# å¸¸è§æ–‡ä»¶æ“ä½œåŒ…æ‹¬ï¼š
# open, openat, read, write, close, stat, lstat, access...
```

**ğŸŒ ç½‘ç»œæ“ä½œç±»**
```bash
# åªçœ‹ç½‘ç»œç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨  
strace -e trace=network curl http://www.baidu.com
strace -e network curl http://www.baidu.com

# å¸¸è§ç½‘ç»œæ“ä½œåŒ…æ‹¬ï¼š
# socket, connect, accept, send, recv, bind, listen...
```

**âš™ï¸ è¿›ç¨‹ç®¡ç†ç±»**
```bash
# åªçœ‹è¿›ç¨‹ç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨
strace -e trace=process bash -c "ls"
strace -e process bash -c "ls"

# å¸¸è§è¿›ç¨‹æ“ä½œåŒ…æ‹¬ï¼š  
# fork, clone, execve, exit, wait, kill...
```

### 5.3 æŒ‰å…·ä½“ç³»ç»Ÿè°ƒç”¨è¿‡æ»¤


**ğŸ¯ æŒ‡å®šå…·ä½“è°ƒç”¨**
```bash
# åªè¿½è¸ª open å’Œ read è°ƒç”¨
strace -e trace=open,read cat /etc/passwd

# åªè¿½è¸ªç½‘ç»œè¿æ¥å»ºç«‹
strace -e trace=connect,socket curl http://www.baidu.com
```

**ğŸ“Š å®é™…è¾“å‡ºå¯¹æ¯”**
```bash
# ä¸è¿‡æ»¤ï¼ˆè¾“å‡ºå¾ˆå¤šï¼‰
$ strace ls
execve("/bin/ls", ["ls"], ...) = 0
brk(NULL) = 0x...
access("/etc/ld.so.nohwcap", F_OK) = -1 ENOENT
mmap(NULL, 8192, PROT_READ|PROT_WRITE...) = 0x...
...ï¼ˆå‡ ç™¾è¡Œè¾“å‡ºï¼‰

# è¿‡æ»¤åï¼ˆè¾“å‡ºç²¾ç®€ï¼‰
$ strace -e trace=file ls  
openat(AT_FDCWD, "/etc/ld.so.cache", O_RDONLY|O_CLOEXEC) = 3
openat(AT_FDCWD, ".", O_RDONLY|O_NONBLOCK|O_CLOEXEC|O_DIRECTORY) = 3
...ï¼ˆåªæœ‰æ–‡ä»¶ç›¸å…³çš„åå‡ è¡Œï¼‰
```

### 5.4 å¸¸ç”¨è¿‡æ»¤ç»„åˆ


**ğŸ”¸ è°ƒè¯•æ–‡ä»¶é—®é¢˜**
```bash
# ç¨‹åºæ— æ³•è¯»å–æ–‡ä»¶ï¼Œçœ‹çœ‹æ–‡ä»¶æ“ä½œ
strace -e trace=file,desc program

# descç±»åˆ«åŒ…æ‹¬æ–‡ä»¶æè¿°ç¬¦æ“ä½œï¼šdup, close, fcntlç­‰
```

**ğŸ”¸ è°ƒè¯•ç½‘ç»œé—®é¢˜**
```bash
# ç¨‹åºæ— æ³•è¿æ¥ç½‘ç»œï¼Œçœ‹çœ‹ç½‘ç»œæ“ä½œ
strace -e trace=network,signal program

# signalç±»åˆ«åŒ…æ‹¬ä¿¡å·å¤„ç†ï¼Œç½‘ç»œç¨‹åºå¸¸ç”¨
```

---

## 6. â° æ—¶é—´æˆ³ä¸æ€§èƒ½åˆ†æ


### 6.1 æ—¶é—´æˆ³é€‰é¡¹è¯¦è§£


**ğŸ“… -tå‚æ•°ï¼šæ˜¾ç¤ºæ—¶é—´æˆ³**
```bash
# æ˜¾ç¤ºæ¯ä¸ªç³»ç»Ÿè°ƒç”¨çš„æ—¶é—´
strace -t ls

# è¾“å‡ºç¤ºä¾‹ï¼š
# 10:30:25 open("/etc/passwd", O_RDONLY) = 3
# 10:30:25 read(3, "root:x:0:0:root:/root:/bin/bash\n", 4096) = 41
```

**â° -ttå‚æ•°ï¼šæ˜¾ç¤ºå¾®ç§’çº§æ—¶é—´æˆ³**
```bash
# æ˜¾ç¤ºæ›´ç²¾ç¡®çš„æ—¶é—´ï¼ˆåˆ°å¾®ç§’ï¼‰
strace -tt ls

# è¾“å‡ºç¤ºä¾‹ï¼š
# 10:30:25.123456 open("/etc/passwd", O_RDONLY) = 3
# 10:30:25.123478 read(3, "root:x:0:0:...", 4096) = 41
```

**â³ -tttå‚æ•°ï¼šæ˜¾ç¤ºæ—¶é—´æˆ³ï¼ˆä»1970å¹´å¼€å§‹çš„ç§’æ•°ï¼‰**
```bash
# Unixæ—¶é—´æˆ³æ ¼å¼
strace -ttt ls

# è¾“å‡ºç¤ºä¾‹ï¼š  
# 1631234567.123456 open("/etc/passwd", O_RDONLY) = 3
```

### 6.2 ç³»ç»Ÿè°ƒç”¨è€—æ—¶åˆ†æ


**âš¡ -Tå‚æ•°ï¼šæ˜¾ç¤ºæ¯ä¸ªè°ƒç”¨çš„è€—æ—¶**
```bash
# æ˜¾ç¤ºæ¯ä¸ªç³»ç»Ÿè°ƒç”¨èŠ±è´¹çš„æ—¶é—´
strace -T ls

# è¾“å‡ºç¤ºä¾‹ï¼š
# open("/etc/passwd", O_RDONLY) = 3 <0.000015>
# read(3, "root:x:0:0:...", 4096) = 41 <0.000008>
#                                        â†‘
#                                   è€—æ—¶0.000015ç§’
```

**ğŸ“Š ç»„åˆä½¿ç”¨ï¼šå®Œæ•´çš„æ€§èƒ½åˆ†æ**
```bash
# åŒæ—¶æ˜¾ç¤ºæ—¶é—´æˆ³å’Œè€—æ—¶
strace -tt -T ls

# è¾“å‡ºç¤ºä¾‹ï¼š
# 10:30:25.123456 open("/etc/passwd", O_RDONLY) = 3 <0.000015>
#    â†‘                                              â†‘
# ç»å¯¹æ—¶é—´                                        è€—æ—¶
```

### 6.3 æ€§èƒ½åˆ†æå®æˆ˜


**ğŸ¯ æ‰¾å‡ºæ€§èƒ½ç“¶é¢ˆ**
```bash
# åˆ†æç¨‹åºæ…¢åœ¨å“ªé‡Œ
strace -T -e trace=file slow_program 2>&1 | grep -E "<[0-9]+\."

# æŸ¥æ‰¾è€—æ—¶è¶…è¿‡0.1ç§’çš„ç³»ç»Ÿè°ƒç”¨
strace -T program 2>&1 | awk '$NF ~ /<[0-9]+\./ && $NF > "<0.1"'
```

**ğŸ’¡ å¸¸è§æ€§èƒ½é—®é¢˜æ¨¡å¼**
```bash
# æ–‡ä»¶æ“ä½œæ…¢
open("/big/file", O_RDONLY) = 3 <2.345678>  # æ–‡ä»¶å¤ªå¤§æˆ–ç£ç›˜æ…¢

# ç½‘ç»œæ“ä½œæ…¢  
connect(3, {...}, 16) = 0 <5.123456>       # ç½‘ç»œå»¶è¿Ÿé«˜

# å¤§é‡å°æ–‡ä»¶æ“ä½œ
open("/path/file1", O_RDONLY) = 3 <0.001>   # å•ä¸ªå¿«ä½†æ•°é‡å¤š
open("/path/file2", O_RDONLY) = 4 <0.001>
...ï¼ˆé‡å¤å‡ åƒæ¬¡ï¼‰
```

---

## 7. ğŸ“„ è¾“å‡ºç®¡ç†ä¸æ—¥å¿—è®°å½•


### 7.1 è¾“å‡ºé‡å®šå‘åŸºç¡€


**ğŸ”¸ ç†è§£straceçš„è¾“å‡ºæ–¹å¼**
```bash
# straceé»˜è®¤å°†è¿½è¸ªä¿¡æ¯è¾“å‡ºåˆ°stderrï¼ˆæ ‡å‡†é”™è¯¯ï¼‰
# ç¨‹åºçš„æ­£å¸¸è¾“å‡ºè¿˜æ˜¯åˆ°stdoutï¼ˆæ ‡å‡†è¾“å‡ºï¼‰

strace ls > output.txt
# è¿™æ ·åªèƒ½ä¿å­˜lsçš„è¾“å‡ºï¼Œçœ‹ä¸åˆ°straceä¿¡æ¯
```

**âœ… æ­£ç¡®çš„é‡å®šå‘æ–¹æ³•**
```bash
# æ–¹æ³•1ï¼šé‡å®šå‘stderr
strace ls 2> strace.log

# æ–¹æ³•2ï¼šä½¿ç”¨-oå‚æ•°ï¼ˆæ¨èï¼‰
strace -o strace.log ls

# æ–¹æ³•3ï¼šåŒæ—¶ä¿å­˜ç¨‹åºè¾“å‡ºå’Œè¿½è¸ªä¿¡æ¯
strace -o strace.log ls > program_output.txt
```

### 7.2 -oå‚æ•°è¯¦è§£


**ğŸ“ åŸºæœ¬ç”¨æ³•**
```bash
# å°†è¿½è¸ªä¿¡æ¯ä¿å­˜åˆ°æ–‡ä»¶
strace -o debug.log program

# è¿½è¸ªé•¿æœŸè¿è¡Œçš„è¿›ç¨‹
strace -o server.log -p 1234
```

**âš¡ å®é™…åº”ç”¨ç¤ºä¾‹**
```bash
# è°ƒè¯•WebæœåŠ¡å™¨é—®é¢˜
strace -o nginx.log -f -p $(pgrep nginx | head -1)

# åˆ†ææ–‡ä»¶è®¿é—®æ¨¡å¼
strace -o file_access.log -e trace=file backup_script.sh
```

### 7.3 æ—¥å¿—åˆ†ææŠ€å·§


**ğŸ” å¸¸ç”¨æ—¥å¿—åˆ†æå‘½ä»¤**
```bash
# ç»Ÿè®¡ç³»ç»Ÿè°ƒç”¨æ¬¡æ•°
cat strace.log | awk '{print $1}' | sort | uniq -c | sort -nr

# æŸ¥æ‰¾é”™è¯¯çš„ç³»ç»Ÿè°ƒç”¨
grep "= -1" strace.log

# æŸ¥æ‰¾è€—æ—¶æœ€é•¿çš„æ“ä½œï¼ˆéœ€è¦-Tå‚æ•°ï¼‰
grep -o "<[0-9]\+\.[0-9]\+>" strace.log | sort -nr | head -10

# åˆ†ææ–‡ä»¶è®¿é—®æ¨¡å¼
grep -E "(open|openat)" strace.log | awk '{print $2}' | sort | uniq -c
```

**ğŸ“Š æ—¥å¿—åˆ†æå®ä¾‹**
```bash
# åŸå§‹straceæ—¥å¿—ç‰‡æ®µ
$ strace -T -o app.log ./myapp
$ cat app.log

open("/etc/hosts", O_RDONLY) = 3 <0.000123>
read(3, "127.0.0.1 localhost\n...", 4096) = 87 <0.000045>
close(3) = 0 <0.000012>
open("/etc/resolv.conf", O_RDONLY) = 3 <0.000098>
...

# åˆ†æç»“æœ
$ awk '{print $1}' app.log | sort | uniq -c | sort -nr
    45 read
    23 open  
    23 close
    12 write
    ...
```

---

## 8. ğŸš€ å®é™…åº”ç”¨åœºæ™¯åˆ†æ


### 8.1 ç½‘ç»œè°ƒç”¨è¿½è¸ªåˆ†æ


**ğŸŒ è¿½è¸ªç½‘ç»œç¨‹åºçš„è¿æ¥è¿‡ç¨‹**
```bash
# åˆ†æcurlçš„ç½‘ç»œè¡Œä¸º
strace -e trace=network curl http://www.example.com

# å…¸å‹è¾“å‡ºåˆ†æï¼š
socket(AF_INET, SOCK_STREAM, IPPROTO_TCP) = 3
# â†‘ åˆ›å»ºTCPå¥—æ¥å­—

connect(3, {sa_family=AF_INET, sin_port=htons(80), 
         sin_addr=inet_addr("192.168.1.1")}, 16) = 0  
# â†‘ è¿æ¥åˆ°æœåŠ¡å™¨çš„80ç«¯å£

sendto(3, "GET / HTTP/1.1\r\nHost: www.example.com\r\n...", 78, MSG_NOSIGNAL, NULL, 0) = 78
# â†‘ å‘é€HTTPè¯·æ±‚

recvfrom(3, "HTTP/1.1 200 OK\r\nServer: nginx...", 16384, 0, NULL, NULL) = 1024
# â†‘ æ¥æ”¶HTTPå“åº”
```

**ğŸ’¡ ç½‘ç»œé—®é¢˜è¯Šæ–­**
```bash
# è¿æ¥è¶…æ—¶é—®é¢˜
connect(3, {...}, 16) = -1 ETIMEDOUT (Connection timed out)

# è¿æ¥è¢«æ‹’ç»  
connect(3, {...}, 16) = -1 ECONNREFUSED (Connection refused)

# DNSè§£æé—®é¢˜
connect(3, {...}, 16) = -1 ENETUNREACH (Network is unreachable)
```

### 8.2 æ–‡ä»¶æ“ä½œè°ƒç”¨è¿½è¸ª


**ğŸ“ åˆ†æç¨‹åºçš„æ–‡ä»¶è®¿é—®æ¨¡å¼**
```bash
# è¿½è¸ªç¼–è¯‘è¿‡ç¨‹çš„æ–‡ä»¶æ“ä½œ
strace -e trace=file gcc hello.c -o hello

# å…¸å‹è¾“å‡ºåˆ†æï¼š
openat(AT_FDCWD, "hello.c", O_RDONLY) = 3
# â†‘ æ‰“å¼€æºæ–‡ä»¶

openat(AT_FDCWD, "/usr/include/stdio.h", O_RDONLY) = 4  
# â†‘ æ‰“å¼€å¤´æ–‡ä»¶

openat(AT_FDCWD, "hello", O_WRONLY|O_CREAT|O_TRUNC, 0755) = 5
# â†‘ åˆ›å»ºå¯æ‰§è¡Œæ–‡ä»¶
```

**ğŸ” æ–‡ä»¶æƒé™é—®é¢˜è¯Šæ–­**
```bash
# ç¨‹åºæ— æ³•è®¿é—®æ–‡ä»¶
$ strace -e trace=file ./myapp
openat(AT_FDCWD, "/etc/secret", O_RDONLY) = -1 EACCES (Permission denied)
#                                              â†‘
#                                           æƒé™è¢«æ‹’ç»

# æ–‡ä»¶ä¸å­˜åœ¨
openat(AT_FDCWD, "/missing/file", O_RDONLY) = -1 ENOENT (No such file or directory)
#                                                â†‘
#                                            æ–‡ä»¶ä¸å­˜åœ¨
```

### 8.3 æ€§èƒ½è°ƒä¼˜å®æˆ˜æ¡ˆä¾‹


**âš¡ æ¡ˆä¾‹ï¼šç¨‹åºå¯åŠ¨æ…¢çš„é—®é¢˜**
```bash
# åˆ†æç¨‹åºå¯åŠ¨è¿‡ç¨‹
strace -T -o startup.log slow_program

# æŸ¥çœ‹è€—æ—¶æœ€é•¿çš„æ“ä½œ
grep -E "<[0-9]\." startup.log | sort -k3 -nr | head -5

# å¯èƒ½çš„å‘ç°ï¼š
open("/usr/share/big_config.xml", O_RDONLY) = 3 <2.345>
# â†‘ è¯»å–å¤§é…ç½®æ–‡ä»¶å¾ˆæ…¢

stat("/network/mounted/path", {...}) = 0 <1.234>  
# â†‘ è®¿é—®ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿå¾ˆæ…¢
```

**ğŸ“Š æ¡ˆä¾‹ï¼šé¢‘ç¹çš„æ–‡ä»¶æ“ä½œ**
```bash
# å‘ç°ç¨‹åºé‡å¤æ‰“å¼€åŒä¸€æ–‡ä»¶
$ grep "config.ini" startup.log | wc -l
127
# â†‘ åŒä¸€ä¸ªé…ç½®æ–‡ä»¶è¢«æ‰“å¼€äº†127æ¬¡ï¼

# ä¼˜åŒ–å»ºè®®ï¼šç¨‹åºåº”è¯¥ç¼“å­˜é…ç½®è€Œä¸æ˜¯é‡å¤è¯»å–
```

### 8.4 è°ƒè¯•æŠ€å·§æ±‡æ€»


**ğŸ› ï¸ å¸¸ç”¨è°ƒè¯•ç»„åˆ**
```bash
# è°ƒè¯•æ–‡ä»¶æƒé™é—®é¢˜
strace -e trace=file program 2>&1 | grep -E "EACCES|ENOENT"

# è°ƒè¯•ç½‘ç»œè¿æ¥é—®é¢˜  
strace -e trace=network program 2>&1 | grep -E "connect|ECONNREFUSED|ETIMEDOUT"

# è°ƒè¯•æ€§èƒ½é—®é¢˜
strace -T program 2>&1 | grep -E "<[0-9]\." | sort -k3 -nr | head -10

# è°ƒè¯•å­è¿›ç¨‹é—®é¢˜
strace -f -o debug.log program
grep -E "\[pid [0-9]+\]" debug.log
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„åŸºæœ¬æ¦‚å¿µ


```
ğŸ”¸ straceæœ¬è´¨ï¼šç³»ç»Ÿè°ƒç”¨è¿½è¸ªå·¥å…·ï¼Œç›‘å¬ç¨‹åºä¸æ“ä½œç³»ç»Ÿçš„"å¯¹è¯"
ğŸ”¸ åŸºæœ¬ç”¨æ³•ï¼šstrace ç¨‹åºå / strace -p è¿›ç¨‹ID
ğŸ”¸ è¾“å‡ºæ ¼å¼ï¼šç³»ç»Ÿè°ƒç”¨å(å‚æ•°) = è¿”å›å€¼
ğŸ”¸ é”™è¯¯è¯†åˆ«ï¼šè¿”å›å€¼-1è¡¨ç¤ºå‡ºé”™ï¼ŒERRNOæ˜¾ç¤ºå…·ä½“é”™è¯¯
ğŸ”¸ å­è¿›ç¨‹è¿½è¸ªï¼š-få‚æ•°è¿½è¸ªæ‰€æœ‰å­è¿›ç¨‹
ğŸ”¸ è¿‡æ»¤åŠŸèƒ½ï¼š-eå‚æ•°æŒ‰ç±»å‹æˆ–åç§°è¿‡æ»¤ç³»ç»Ÿè°ƒç”¨
ğŸ”¸ æ€§èƒ½åˆ†æï¼š-Tæ˜¾ç¤ºè€—æ—¶ï¼Œ-tæ˜¾ç¤ºæ—¶é—´æˆ³
ğŸ”¸ è¾“å‡ºç®¡ç†ï¼š-oå‚æ•°ä¿å­˜åˆ°æ–‡ä»¶
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä»€ä¹ˆæ—¶å€™ä½¿ç”¨strace**
```
ç¨‹åºè°ƒè¯•ï¼š
â€¢ ç¨‹åºå´©æºƒæˆ–è¡Œä¸ºå¼‚å¸¸
â€¢ æ— æ³•æ‰“å¼€æ–‡ä»¶æˆ–è¿æ¥ç½‘ç»œ
â€¢ ç¨‹åºè¿è¡Œç¼“æ…¢

å­¦ä¹ ç†è§£ï¼š
â€¢ äº†è§£ç¨‹åºå†…éƒ¨å·¥ä½œåŸç†
â€¢ å­¦ä¹ ç³»ç»Ÿè°ƒç”¨çš„ä½¿ç”¨
â€¢ åˆ†æç¨‹åºçš„èµ„æºä½¿ç”¨æ¨¡å¼
```

**ğŸ”¹ è¾“å‡ºè§£è¯»çš„å…³é”®ç‚¹**
```
å…³æ³¨ç‚¹ä¼˜å…ˆçº§ï¼š
1. è¿”å›å€¼ï¼š-1è¡¨ç¤ºé”™è¯¯ï¼Œéœ€è¦é‡ç‚¹å…³æ³¨
2. é”™è¯¯ç ï¼šEACCESã€ENOENTç­‰é”™è¯¯çš„å…·ä½“å«ä¹‰
3. å‚æ•°ï¼šæ–‡ä»¶è·¯å¾„ã€ç½‘ç»œåœ°å€ç­‰å…³é”®ä¿¡æ¯
4. è€—æ—¶ï¼šæ‰¾å‡ºæ€§èƒ½ç“¶é¢ˆï¼ˆéœ€è¦-Tå‚æ•°ï¼‰
```

**ğŸ”¹ å¸¸ç”¨å‚æ•°ç»„åˆ**
```
æ—¥å¸¸è°ƒè¯•ï¼šstrace -f -o debug.log program
æ€§èƒ½åˆ†æï¼šstrace -T -tt program  
æ–‡ä»¶é—®é¢˜ï¼šstrace -e trace=file program
ç½‘ç»œé—®é¢˜ï¼šstrace -e trace=network program
è¿›ç¨‹é—®é¢˜ï¼šstrace -f -e trace=process program
```

### 9.3 å®æˆ˜åº”ç”¨æŒ‡å¯¼


**ğŸ¯ è°ƒè¯•ç­–ç•¥**
```
ç¬¬ä¸€æ­¥ï¼šç¡®å®šè¿½è¸ªèŒƒå›´
â€¢ å•è¿›ç¨‹è¿˜æ˜¯å¤šè¿›ç¨‹ï¼ˆæ˜¯å¦éœ€è¦-fï¼‰
â€¢ å…³æ³¨å“ªç±»ç³»ç»Ÿè°ƒç”¨ï¼ˆæ˜¯å¦éœ€è¦-eè¿‡æ»¤ï¼‰

ç¬¬äºŒæ­¥ï¼šæ”¶é›†ä¿¡æ¯
â€¢ ä¿å­˜å®Œæ•´æ—¥å¿—ï¼ˆ-oå‚æ•°ï¼‰
â€¢ è®°å½•æ—¶é—´ä¿¡æ¯ï¼ˆ-T -ttå‚æ•°ï¼‰

ç¬¬ä¸‰æ­¥ï¼šåˆ†æé—®é¢˜
â€¢ æŸ¥æ‰¾é”™è¯¯è¿”å›å€¼
â€¢ ç»Ÿè®¡ç³»ç»Ÿè°ƒç”¨é¢‘æ¬¡
â€¢ åˆ†ææ€§èƒ½ç“¶é¢ˆ
```

**ğŸ”§ å¸¸è§é—®é¢˜è§£å†³æ€è·¯**
```
æ–‡ä»¶è®¿é—®é—®é¢˜ï¼š
1. æŸ¥çœ‹open/openatè°ƒç”¨çš„è¿”å›å€¼
2. æ£€æŸ¥EACCESï¼ˆæƒé™ï¼‰ã€ENOENTï¼ˆä¸å­˜åœ¨ï¼‰é”™è¯¯
3. ç¡®è®¤æ–‡ä»¶è·¯å¾„å’Œæƒé™è®¾ç½®

ç½‘ç»œè¿æ¥é—®é¢˜ï¼š  
1. æŸ¥çœ‹socketã€connectè°ƒç”¨
2. æ£€æŸ¥ECONNREFUSEDã€ETIMEDOUTé”™è¯¯
3. ç¡®è®¤ç›®æ ‡åœ°å€å’Œç«¯å£

æ€§èƒ½é—®é¢˜ï¼š
1. ä½¿ç”¨-Tå‚æ•°æŸ¥çœ‹è€—æ—¶
2. æ‰¾å‡ºè€—æ—¶æœ€é•¿çš„ç³»ç»Ÿè°ƒç”¨
3. åˆ†ææ˜¯å¦æœ‰é‡å¤æˆ–ä¸å¿…è¦çš„æ“ä½œ
```

### 9.4 å­¦ä¹ å»ºè®®


**ğŸ“š å¾ªåºæ¸è¿›çš„å­¦ä¹ è·¯å¾„**
```
å…¥é—¨é˜¶æ®µï¼š
â€¢ ç†Ÿæ‚‰åŸºæœ¬å‘½ä»¤æ ¼å¼
â€¢ ç†è§£è¾“å‡ºæ ¼å¼å«ä¹‰
â€¢ ç»ƒä¹ è¿½è¸ªç®€å•ç¨‹åºï¼ˆlsã€catç­‰ï¼‰

è¿›é˜¶é˜¶æ®µï¼š
â€¢ æŒæ¡è¿‡æ»¤å’Œæ—¶é—´åˆ†æ
â€¢ å­¦ä¼šè¿½è¸ªå¤æ‚ç¨‹åº
â€¢ èƒ½å¤Ÿåˆ†ææ—¥å¿—æ‰¾å‡ºé—®é¢˜

é«˜çº§é˜¶æ®µï¼š
â€¢ ç»“åˆå…¶ä»–å·¥å…·ï¼ˆpsã€netstatç­‰ï¼‰
â€¢ ç¼–å†™è„šæœ¬è‡ªåŠ¨åŒ–åˆ†æ
â€¢ è¿›è¡Œç³»ç»Ÿçº§æ€§èƒ½ä¼˜åŒ–
```

**ğŸ’¡ å®è·µå»ºè®®**
```
å¤šåŠ¨æ‰‹ï¼š
â€¢ å¯¹å¸¸ç”¨ç¨‹åºè¿›è¡Œstraceåˆ†æ
â€¢ äººä¸ºåˆ¶é€ é—®é¢˜è¿›è¡Œè°ƒè¯•ç»ƒä¹ 
â€¢ å¯¹æ¯”æ­£å¸¸å’Œå¼‚å¸¸æƒ…å†µçš„è¾“å‡ºå·®å¼‚

å¤šæ€è€ƒï¼š
â€¢ ç†è§£æ¯ä¸ªç³»ç»Ÿè°ƒç”¨çš„ä½œç”¨
â€¢ åˆ†æç¨‹åºçš„æ‰§è¡Œé€»è¾‘
â€¢ æ€è€ƒæ€§èƒ½ä¼˜åŒ–çš„å¯èƒ½æ€§
```

**æ ¸å¿ƒè®°å¿†å£è¯€**ï¼š
- straceè¿½è¸ªç³»ç»Ÿè°ƒç”¨ï¼Œç¨‹åºè¡Œä¸ºçœ‹å¾—æ¸…
- æ–‡ä»¶ç½‘ç»œè¿›ç¨‹ç±»ï¼Œè¿‡æ»¤åˆ†ææœ‰é‡ç‚¹  
- æ—¶é—´æˆ³é…åˆè€—æ—¶é‡ï¼Œæ€§èƒ½ç“¶é¢ˆæ— å¤„è—
- é”™è¯¯è¿”å›è¦å…³æ³¨ï¼Œæƒé™è·¯å¾„ä»”ç»†æŸ¥