---
title: 8ã€SystemTapåŠ¨æ€è¿½è¸ª
---
## ğŸ“š ç›®å½•

1. [SystemTapæ¡†æ¶æ¦‚è¿°](#1-systemtapæ¡†æ¶æ¦‚è¿°)
2. [SystemTapå®‰è£…é…ç½®](#2-systemtapå®‰è£…é…ç½®)
3. [è„šæœ¬è¯­è¨€åŸºç¡€è¯­æ³•](#3-è„šæœ¬è¯­è¨€åŸºç¡€è¯­æ³•)
4. [å†…æ ¸æ¢é’ˆç‚¹è®¾ç½®](#4-å†…æ ¸æ¢é’ˆç‚¹è®¾ç½®)
5. [ç”¨æˆ·ç©ºé—´æ¢é’ˆé…ç½®](#5-ç”¨æˆ·ç©ºé—´æ¢é’ˆé…ç½®)
6. [å˜é‡ä¸æ•°ç»„ä½¿ç”¨](#6-å˜é‡ä¸æ•°ç»„ä½¿ç”¨)
7. [ç»Ÿè®¡å‡½æ•°ä¸èšåˆæ“ä½œ](#7-ç»Ÿè®¡å‡½æ•°ä¸èšåˆæ“ä½œ)
8. [å®æ—¶æ•°æ®æ”¶é›†ä¸åˆ†æ](#8-å®æ—¶æ•°æ®æ”¶é›†ä¸åˆ†æ)
9. [æ€§èƒ½å¼€é”€æ§åˆ¶](#9-æ€§èƒ½å¼€é”€æ§åˆ¶)
10. [è°ƒè¯•è„šæœ¬ç¼–å†™æŠ€å·§](#10-è°ƒè¯•è„šæœ¬ç¼–å†™æŠ€å·§)
11. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#11-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ” SystemTapæ¡†æ¶æ¦‚è¿°


### 1.1 ä»€ä¹ˆæ˜¯SystemTap


**ç®€å•ç†è§£**ï¼šSystemTapå°±åƒç»™Linuxå†…æ ¸è£…äº†ä¸€ä¸ª"ç›‘æ§æ‘„åƒå¤´"ï¼Œå¯ä»¥å®æ—¶è§‚å¯Ÿç³»ç»Ÿå†…éƒ¨å‘ç”Ÿçš„æ‰€æœ‰äº‹æƒ…ã€‚

```
ä¼ ç»Ÿè°ƒè¯•æ–¹æ³•çš„å±€é™ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     é—®é¢˜ï¼šéœ€è¦é‡æ–°ç¼–è¯‘å†…æ ¸
â”‚  ä¿®æ”¹å†…æ ¸æºç     â”‚  â†  æ·»åŠ è°ƒè¯•ä»£ç ï¼Œéå¸¸éº»çƒ¦
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é‡æ–°ç¼–è¯‘å†…æ ¸    â”‚  â†  è€—æ—¶å¾ˆé•¿ï¼Œé£é™©è¾ƒå¤§
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é‡å¯ç³»ç»ŸéªŒè¯    â”‚  â†  å½±å“ä¸šåŠ¡è¿è¡Œ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

SystemTapçš„é©å‘½æ€§ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¼–å†™è¿½è¸ªè„šæœ¬     â”‚  â†  ç”¨ç®€å•è„šæœ¬æè¿°è¦ç›‘æ§ä»€ä¹ˆ
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åŠ¨æ€æ’å…¥æ¢é’ˆ     â”‚  â†  è¿è¡Œæ—¶æ’å…¥ï¼Œæ— éœ€é‡å¯
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å®æ—¶æ”¶é›†æ•°æ®     â”‚  â†  ç«‹å³çœ‹åˆ°ç³»ç»Ÿè¿è¡ŒçŠ¶æ€
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 SystemTapèƒ½åšä»€ä¹ˆ


**æ ¸å¿ƒåŠŸèƒ½æ¦‚è¿°**ï¼š
- **ğŸ” ç³»ç»Ÿè¯Šæ–­**ï¼šæ‰¾å‡ºç³»ç»Ÿæ…¢åœ¨å“ªé‡Œï¼Œå¡åœ¨å“ªé‡Œ
- **ğŸ“Š æ€§èƒ½åˆ†æ**ï¼šåˆ†æCPUã€å†…å­˜ã€ç£ç›˜IOæ€§èƒ½ç“¶é¢ˆ
- **ğŸ› é—®é¢˜å®šä½**ï¼šè¿½è¸ªç³»ç»Ÿè°ƒç”¨ï¼Œå®šä½åº”ç”¨é—®é¢˜
- **ğŸ“ˆ å®æ—¶ç›‘æ§**ï¼šå®æ—¶è§‚å¯Ÿç³»ç»Ÿè¿è¡ŒçŠ¶æ€

> ğŸ’¡ **å½¢è±¡æ¯”å–»**ï¼šå¦‚æœLinuxç³»ç»Ÿæ˜¯ä¸€å°æ±½è½¦ï¼ŒSystemTapå°±æ˜¯æ±½è½¦çš„ä»ªè¡¨ç›˜+è¡Œè½¦è®°å½•ä»ªï¼Œèƒ½å‘Šè¯‰ä½ å¼•æ“è½¬é€Ÿã€æ²¹è€—æƒ…å†µï¼Œè¿˜èƒ½è®°å½•è¡Œé©¶è¿‡ç¨‹ä¸­çš„æ‰€æœ‰ç»†èŠ‚ã€‚

### 1.3 å·¥ä½œåŸç†å›¾è§£


```
SystemTapå·¥ä½œæµç¨‹ï¼š
                                
ç”¨æˆ·ç¼–å†™è„šæœ¬   â†’   ç¼–è¯‘æˆå†…æ ¸æ¨¡å—   â†’   æ’å…¥å†…æ ¸   â†’   æ”¶é›†æ•°æ®
     â”‚                   â”‚                â”‚           â”‚
 hello.stp          hello.ko         kprobe       å®æ—¶è¾“å‡º
     â”‚                   â”‚                â”‚           â”‚
   â”Œâ”€â–¼â”€â”               â”Œâ”€â–¼â”€â”            â”Œâ”€â–¼â”€â”       â”Œâ”€â–¼â”€â”
   â”‚è„šæœ¬â”‚               â”‚æ¨¡å—â”‚            â”‚æ¢é’ˆâ”‚       â”‚æ•°æ®â”‚
   â””â”€â”€â”€â”˜               â””â”€â”€â”€â”˜            â””â”€â”€â”€â”˜       â””â”€â”€â”€â”˜
```

**å·¥ä½œæ­¥éª¤è¯¦è§£**ï¼š
1. **ç¼–å†™è„šæœ¬**ï¼šç”¨SystemTapè¯­è¨€æè¿°è¦ç›‘æ§çš„äº‹ä»¶
2. **ç¼–è¯‘è½¬æ¢**ï¼šè‡ªåŠ¨è½¬æ¢ä¸ºå†…æ ¸æ¨¡å—(.koæ–‡ä»¶)
3. **åŠ¨æ€æ’å…¥**ï¼šå°†æ¨¡å—æ’å…¥æ­£åœ¨è¿è¡Œçš„å†…æ ¸
4. **æ•°æ®æ”¶é›†**ï¼šæ¢é’ˆè§¦å‘æ—¶æ”¶é›†æ•°æ®å¹¶è¾“å‡º

---

## 2. âš™ï¸ SystemTapå®‰è£…é…ç½®


### 2.1 ç³»ç»Ÿè¦æ±‚æ£€æŸ¥


**å¿…è¦æ¡ä»¶æ£€æŸ¥**ï¼š
```bash
# â‘  æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬
uname -r
# è¾“å‡ºç¤ºä¾‹ï¼š5.15.0-56-generic

# â‘¡ æ£€æŸ¥å†…æ ¸è°ƒè¯•ä¿¡æ¯
ls /boot/vmlinux-`uname -r` 2>/dev/null && echo "è°ƒè¯•ä¿¡æ¯å·²å®‰è£…" || echo "éœ€è¦å®‰è£…è°ƒè¯•ä¿¡æ¯"

# â‘¢ æ£€æŸ¥å†…æ ¸å¤´æ–‡ä»¶
ls /lib/modules/`uname -r`/build 2>/dev/null && echo "å†…æ ¸å¤´æ–‡ä»¶å·²å®‰è£…" || echo "éœ€è¦å®‰è£…å†…æ ¸å¤´æ–‡ä»¶"
```

> âš ï¸ **é‡è¦æé†’**ï¼šSystemTapéœ€è¦å†…æ ¸è°ƒè¯•ä¿¡æ¯å’Œå¤´æ–‡ä»¶æ‰èƒ½æ­£å¸¸å·¥ä½œï¼Œè¿™æ˜¯æœ€å®¹æ˜“å‡ºé—®é¢˜çš„åœ°æ–¹ï¼

### 2.2 ä¸åŒå‘è¡Œç‰ˆå®‰è£…æ–¹æ³•


#### ğŸ”¸ Ubuntu/Debianç³»ç»Ÿ


```bash
# å®‰è£…SystemTapä¸»ç¨‹åº
sudo apt update
sudo apt install systemtap

# å®‰è£…å†…æ ¸è°ƒè¯•ä¿¡æ¯ï¼ˆå…³é”®æ­¥éª¤ï¼‰
sudo apt install linux-image-$(uname -r)-dbgsym

# å®‰è£…å†…æ ¸å¤´æ–‡ä»¶
sudo apt install linux-headers-$(uname -r)

# éªŒè¯å®‰è£…
sudo stap -v -e 'probe vfs.read {printf("è¯»å–æ–‡ä»¶: %s\n", execname()); exit()}'
```

#### ğŸ”¸ CentOS/RHELç³»ç»Ÿ


```bash
# å®‰è£…SystemTap
sudo yum install systemtap systemtap-runtime

# å®‰è£…è°ƒè¯•ä¿¡æ¯
sudo debuginfo-install kernel

# æˆ–è€…æ‰‹åŠ¨å®‰è£…
sudo yum install kernel-debuginfo-$(uname -r)
sudo yum install kernel-devel-$(uname -r)

# éªŒè¯å®‰è£…
sudo stap -v -e 'probe kernel.function("sys_open") {printf("æ‰“å¼€æ–‡ä»¶\n"); exit()}'
```

### 2.3 å®‰è£…éªŒè¯æµ‹è¯•


**å¿«é€Ÿæµ‹è¯•è„šæœ¬**ï¼š
```bash
# åˆ›å»ºæµ‹è¯•è„šæœ¬ test.stp
cat > test.stp << 'EOF'
#!/usr/bin/env stap

probe begin {
    printf("SystemTapå®‰è£…æˆåŠŸï¼å¼€å§‹ç›‘æ§...\n")
}

probe timer.s(1) {
    printf("ç³»ç»Ÿæ­£åœ¨è¿è¡Œï¼Œæ—¶é—´ï¼š%s\n", ctime(gettimeofday_s()))
}

probe timer.s(5) {
    printf("æµ‹è¯•å®Œæˆï¼ŒSystemTapå·¥ä½œæ­£å¸¸ï¼\n")
    exit()
}
EOF

# è¿è¡Œæµ‹è¯•
sudo stap test.stp
```

**æœŸæœ›è¾“å‡º**ï¼š
```
SystemTapå®‰è£…æˆåŠŸï¼å¼€å§‹ç›‘æ§...
ç³»ç»Ÿæ­£åœ¨è¿è¡Œï¼Œæ—¶é—´ï¼šMon Sep 15 14:30:01 2025
ç³»ç»Ÿæ­£åœ¨è¿è¡Œï¼Œæ—¶é—´ï¼šMon Sep 15 14:30:02 2025
ç³»ç»Ÿæ­£åœ¨è¿è¡Œï¼Œæ—¶é—´ï¼šMon Sep 15 14:30:03 2025
ç³»ç»Ÿæ­£åœ¨è¿è¡Œï¼Œæ—¶é—´ï¼šMon Sep 15 14:30:04 2025
æµ‹è¯•å®Œæˆï¼ŒSystemTapå·¥ä½œæ­£å¸¸ï¼
```

---

## 3. ğŸ“ è„šæœ¬è¯­è¨€åŸºç¡€è¯­æ³•


### 3.1 è„šæœ¬ç»“æ„ç»„æˆ


**åŸºæœ¬è„šæœ¬æ¨¡æ¿**ï¼š
```stap
#!/usr/bin/env stap

# å…¨å±€å˜é‡å®šä¹‰
global å˜é‡å

# å¼€å§‹æ¢é’ˆï¼ˆç¨‹åºå¯åŠ¨æ—¶æ‰§è¡Œï¼‰
probe begin {
    printf("å¼€å§‹ç›‘æ§...\n")
}

# äº‹ä»¶æ¢é’ˆï¼ˆç›‘æ§ç‰¹å®šäº‹ä»¶ï¼‰
probe kernel.function("å‡½æ•°å") {
    # å¤„ç†é€»è¾‘
}

# ç»“æŸæ¢é’ˆï¼ˆç¨‹åºé€€å‡ºæ—¶æ‰§è¡Œï¼‰
probe end {
    printf("ç›‘æ§ç»“æŸ\n")
}
```

### 3.2 å˜é‡ç±»å‹ä¸å£°æ˜


**ğŸ”¸ å±€éƒ¨å˜é‡**ï¼š
```stap
probe kernel.function("sys_read") {
    filename = "test.txt"        # å­—ç¬¦ä¸²å˜é‡
    pid = pid()                  # æ•´æ•°å˜é‡
    printf("è¿›ç¨‹%dè¯»å–æ–‡ä»¶%s\n", pid, filename)
}
```

**ğŸ”¸ å…¨å±€å˜é‡**ï¼š
```stap
global total_reads = 0          # å…¨å±€è®¡æ•°å™¨
global file_stats               # å…¨å±€å…³è”æ•°ç»„

probe kernel.function("sys_read") {
    total_reads++               # è®¡æ•°å™¨åŠ 1
    file_stats[execname()]++    # æŒ‰ç¨‹åºåç»Ÿè®¡
}

probe end {
    printf("æ€»è¯»å–æ¬¡æ•°ï¼š%d\n", total_reads)
    foreach (program in file_stats) {
        printf("%s: %dæ¬¡\n", program, file_stats[program])
    }
}
```

### 3.3 åŸºæœ¬è¯­æ³•è§„åˆ™


**ğŸ”¸ æ¡ä»¶è¯­å¥**ï¼š
```stap
probe kernel.function("sys_open") {
    if (pid() > 1000) {                    # åªç›‘æ§ç”¨æˆ·è¿›ç¨‹
        printf("ç”¨æˆ·è¿›ç¨‹æ‰“å¼€æ–‡ä»¶\n")
    } else if (pid() == 0) {               # å†…æ ¸çº¿ç¨‹
        printf("å†…æ ¸çº¿ç¨‹æ“ä½œ\n")
    } else {                               # ç³»ç»Ÿè¿›ç¨‹
        printf("ç³»ç»Ÿè¿›ç¨‹æ“ä½œ\n")
    }
}
```

**ğŸ”¸ å¾ªç¯è¯­å¥**ï¼š
```stap
global array

probe end {
    # foreachå¾ªç¯éå†æ•°ç»„
    foreach (key in array) {
        printf("é”®ï¼š%sï¼Œå€¼ï¼š%d\n", key, array[key])
    }
    
    # æŒ‰å€¼æ’åºè¾“å‡ºï¼ˆé™åºï¼‰
    foreach (key in array-) {
        printf("é”®ï¼š%sï¼Œå€¼ï¼š%d\n", key, array[key])
    }
}
```

**ğŸ”¸ å‡½æ•°è°ƒç”¨**ï¼š
```stap
probe kernel.function("sys_write") {
    printf("è¿›ç¨‹åï¼š%s\n", execname())     # è·å–è¿›ç¨‹å
    printf("è¿›ç¨‹IDï¼š%d\n", pid())          # è·å–è¿›ç¨‹ID
    printf("ç”¨æˆ·IDï¼š%d\n", uid())          # è·å–ç”¨æˆ·ID
    printf("å½“å‰æ—¶é—´ï¼š%s\n", ctime(gettimeofday_s()))  # è·å–æ—¶é—´
}
```

---

## 4. ğŸ¯ å†…æ ¸æ¢é’ˆç‚¹è®¾ç½®


### 4.1 æ¢é’ˆç‚¹ç±»å‹è¯´æ˜


**ğŸ”¸ å‡½æ•°æ¢é’ˆ**ï¼šç›‘æ§å†…æ ¸å‡½æ•°çš„è°ƒç”¨
```stap
# ç›‘æ§ç³»ç»Ÿè°ƒç”¨
probe kernel.function("sys_open") {
    printf("æœ‰ç¨‹åºæ­£åœ¨æ‰“å¼€æ–‡ä»¶ï¼š%s\n", kernel_string($filename))
}

# ç›‘æ§å‡½æ•°è¿”å›
probe kernel.function("sys_open").return {
    printf("æ–‡ä»¶æ‰“å¼€å®Œæˆï¼Œè¿”å›å€¼ï¼š%d\n", $return)
}
```

**ğŸ”¸ è¿½è¸ªç‚¹æ¢é’ˆ**ï¼šç›‘æ§å†…æ ¸é¢„å®šä¹‰çš„è¿½è¸ªç‚¹
```stap
# ç›‘æ§è¿›ç¨‹åˆ›å»º
probe kernel.trace("sched_process_fork") {
    printf("æ–°è¿›ç¨‹åˆ›å»ºï¼šçˆ¶è¿›ç¨‹%dï¼Œå­è¿›ç¨‹%d\n", $parent->pid, $child->pid)
}

# ç›‘æ§ç³»ç»Ÿè°ƒç”¨å…¥å£
probe kernel.trace("sys_enter") {
    printf("ç³»ç»Ÿè°ƒç”¨ï¼š%sï¼Œå‚æ•°ä¸ªæ•°ï¼š%d\n", $id, $nr)
}
```

### 4.2 å¸¸ç”¨å†…æ ¸æ¢é’ˆç¤ºä¾‹


**ğŸ“Š ç³»ç»Ÿè°ƒç”¨ç›‘æ§**ï¼š
```stap
#!/usr/bin/env stap

global syscall_count

# ç›‘æ§æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨
probe syscall.* {
    syscall_count[name]++
}

# æ¯5ç§’è¾“å‡ºç»Ÿè®¡
probe timer.s(5) {
    printf("\n=== ç³»ç»Ÿè°ƒç”¨ç»Ÿè®¡ï¼ˆæœ€è¿‘5ç§’ï¼‰===\n")
    foreach (syscall in syscall_count- limit 10) {
        printf("%-20s: %dæ¬¡\n", syscall, syscall_count[syscall])
    }
    delete syscall_count
}
```

**ğŸ’¾ æ–‡ä»¶ç³»ç»Ÿç›‘æ§**ï¼š
```stap
#!/usr/bin/env stap

# ç›‘æ§æ–‡ä»¶æ‰“å¼€
probe vfs.open {
    printf("[%s] %s(PID:%d) æ‰“å¼€æ–‡ä»¶ï¼š%s\n", 
           ctime(gettimeofday_s()), execname(), pid(), pathname)
}

# ç›‘æ§æ–‡ä»¶è¯»å†™
probe vfs.read, vfs.write {
    printf("[%s] %s(PID:%d) %sæ–‡ä»¶ï¼š%sï¼Œå¤§å°ï¼š%då­—èŠ‚\n",
           ctime(gettimeofday_s()), execname(), pid(), 
           (probefunc() == "vfs_read") ? "è¯»å–" : "å†™å…¥",
           pathname, bytes)
}
```

### 4.3 æ¢é’ˆç‚¹æŸ¥æ‰¾æŠ€å·§


**ğŸ” æŸ¥æ‰¾å¯ç”¨æ¢é’ˆ**ï¼š
```bash
# æŸ¥æ‰¾ç³»ç»Ÿè°ƒç”¨ç›¸å…³æ¢é’ˆ
stap -l 'syscall.*' | head -10

# æŸ¥æ‰¾VFSæ–‡ä»¶ç³»ç»Ÿæ¢é’ˆ
stap -l 'vfs.*'

# æŸ¥æ‰¾å†…æ ¸å‡½æ•°æ¢é’ˆ
stap -l 'kernel.function("*schedule*")'

# æŸ¥æ‰¾è¿½è¸ªç‚¹
stap -l 'kernel.trace("*")'
```

---

## 5. ğŸ‘¥ ç”¨æˆ·ç©ºé—´æ¢é’ˆé…ç½®


### 5.1 ç”¨æˆ·ç©ºé—´æ¢é’ˆç±»å‹


**ğŸ”¸ è¿›ç¨‹æ¢é’ˆ**ï¼šç›‘æ§ç‰¹å®šè¿›ç¨‹çš„è¡Œä¸º
```stap
# ç›‘æ§ç‰¹å®šè¿›ç¨‹çš„ç³»ç»Ÿè°ƒç”¨
probe process("/usr/bin/ls").syscall {
    printf("lså‘½ä»¤è°ƒç”¨ç³»ç»Ÿè°ƒç”¨ï¼š%s\n", name)
}

# ç›‘æ§è¿›ç¨‹å¯åŠ¨å’Œé€€å‡º
probe process("/usr/bin/nginx").begin {
    printf("Nginxè¿›ç¨‹å¯åŠ¨ï¼ŒPIDï¼š%d\n", pid())
}

probe process("/usr/bin/nginx").end {
    printf("Nginxè¿›ç¨‹é€€å‡ºï¼ŒPIDï¼š%d\n", pid())
}
```

**ğŸ”¸ å‡½æ•°çº§æ¢é’ˆ**ï¼šç›‘æ§ç¨‹åºå†…éƒ¨å‡½æ•°
```stap
# ç›‘æ§libcåº“å‡½æ•°
probe process("/lib/x86_64-linux-gnu/libc.so.6").function("malloc") {
    printf("å†…å­˜åˆ†é…ï¼šå¤§å°%då­—èŠ‚ï¼Œè¿›ç¨‹ï¼š%s\n", $size, execname())
}

# ç›‘æ§ç”¨æˆ·ç¨‹åºå‡½æ•°ï¼ˆéœ€è¦è°ƒè¯•ä¿¡æ¯ï¼‰
probe process("/usr/bin/python3").function("main") {
    printf("Pythonç¨‹åºå¼€å§‹æ‰§è¡Œ\n")
}
```

### 5.2 åŠ¨æ€åº“ç›‘æ§


**ğŸ“š å…±äº«åº“å‡½æ•°è¿½è¸ª**ï¼š
```stap
#!/usr/bin/env stap

global malloc_stats

# ç›‘æ§å†…å­˜åˆ†é…
probe process.library("/lib/x86_64-linux-gnu/libc.so.6").function("malloc") {
    malloc_stats[execname(), pid()] += $size
    printf("[å†…å­˜åˆ†é…] %s(PID:%d) åˆ†é…%då­—èŠ‚\n", 
           execname(), pid(), $size)
}

# ç›‘æ§å†…å­˜é‡Šæ”¾
probe process.library("/lib/x86_64-linux-gnu/libc.so.6").function("free") {
    printf("[å†…å­˜é‡Šæ”¾] %s(PID:%d) é‡Šæ”¾å†…å­˜\n", 
           execname(), pid())
}

probe timer.s(10) {
    printf("\n=== å†…å­˜åˆ†é…ç»Ÿè®¡ ===\n")
    foreach ([prog, p] in malloc_stats) {
        printf("%s(PID:%d): æ€»åˆ†é…%då­—èŠ‚\n", prog, p, malloc_stats[prog, p])
    }
}
```

### 5.3 åº”ç”¨ç¨‹åºç›‘æ§å®ä¾‹


**ğŸŒ WebæœåŠ¡å™¨ç›‘æ§**ï¼š
```stap
#!/usr/bin/env stap

global connection_count, request_time

# ç›‘æ§Apacheè¿æ¥
probe process("/usr/sbin/apache2").function("ap_run_pre_connection") {
    connection_count++
    printf("æ–°è¿æ¥å»ºç«‹ï¼Œæ€»è¿æ¥æ•°ï¼š%d\n", connection_count)
}

# ç›‘æ§è¯·æ±‚å¤„ç†æ—¶é—´
probe process("/usr/sbin/apache2").function("ap_process_request").call {
    request_time[tid()] = gettimeofday_us()
}

probe process("/usr/sbin/apache2").function("ap_process_request").return {
    if (tid() in request_time) {
        elapsed = gettimeofday_us() - request_time[tid()]
        printf("è¯·æ±‚å¤„ç†å®Œæˆï¼Œè€—æ—¶ï¼š%då¾®ç§’\n", elapsed)
        delete request_time[tid()]
    }
}
```

---

## 6. ğŸ“Š å˜é‡ä¸æ•°ç»„ä½¿ç”¨


### 6.1 æ•°ç»„ç±»å‹è¯¦è§£


**ğŸ”¸ å…³è”æ•°ç»„**ï¼šç±»ä¼¼Pythonçš„å­—å…¸ï¼Œç”¨é”®å€¼å¯¹å­˜å‚¨æ•°æ®
```stap
global file_access_count        # ç®€å•å…³è”æ•°ç»„
global user_file_stats         # å¤šç»´å…³è”æ•°ç»„

probe vfs.open {
    # å•ç»´æ•°ç»„ï¼šæ–‡ä»¶å -> è®¿é—®æ¬¡æ•°
    file_access_count[pathname]++
    
    # å¤šç»´æ•°ç»„ï¼š[ç”¨æˆ·ID, æ–‡ä»¶å] -> è®¿é—®æ¬¡æ•°
    user_file_stats[uid(), pathname]++
}

probe end {
    printf("=== æ–‡ä»¶è®¿é—®ç»Ÿè®¡ ===\n")
    foreach (file in file_access_count) {
        printf("æ–‡ä»¶ï¼š%sï¼Œè®¿é—®æ¬¡æ•°ï¼š%d\n", file, file_access_count[file])
    }
    
    printf("\n=== ç”¨æˆ·æ–‡ä»¶è®¿é—®è¯¦ç»†ç»Ÿè®¡ ===\n")
    foreach ([user, file] in user_file_stats) {
        printf("ç”¨æˆ·%dè®¿é—®æ–‡ä»¶%sï¼š%dæ¬¡\n", user, file, user_file_stats[user, file])
    }
}
```

**ğŸ”¸ æ•°ç»„æ’åºæŠ€å·§**ï¼š
```stap
global cpu_usage

probe timer.profile {
    cpu_usage[execname()]++
}

probe timer.s(5) {
    printf("=== CPUä½¿ç”¨æ’è¡Œæ¦œ ===\n")
    
    # æŒ‰å€¼é™åºæ’åˆ—ï¼Œåªæ˜¾ç¤ºå‰10å
    foreach (process in cpu_usage- limit 10) {
        printf("%-20s: %d%%\n", process, cpu_usage[process])
    }
    
    # æ¸…ç©ºç»Ÿè®¡é‡æ–°å¼€å§‹
    delete cpu_usage
}
```

### 6.2 æ•°ç»„æ“ä½œå‡½æ•°


**ğŸ“‹ å¸¸ç”¨æ•°ç»„æ“ä½œ**ï¼š
```stap
global stats_array

probe begin {
    # æ•°ç»„èµ‹å€¼
    stats_array["cpu"] = 80
    stats_array["memory"] = 60
    stats_array["disk"] = 45
}

probe timer.s(1) {
    # æ£€æŸ¥é”®æ˜¯å¦å­˜åœ¨
    if ("cpu" in stats_array) {
        printf("CPUä½¿ç”¨ç‡ï¼š%d%%\n", stats_array["cpu"])
    }
    
    # è·å–æ•°ç»„å¤§å°
    printf("ç›‘æ§é¡¹ç›®æ•°é‡ï¼š%d\n", @count(stats_array))
    
    # åˆ é™¤ç‰¹å®šé”®
    delete stats_array["disk"]
    
    # æ¸…ç©ºæ•´ä¸ªæ•°ç»„
    delete stats_array
}
```

### 6.3 å˜é‡ä½œç”¨åŸŸç®¡ç†


**ğŸ”„ å±€éƒ¨vså…¨å±€å˜é‡ä½¿ç”¨**ï¼š
```stap
global global_counter = 0       # å…¨å±€å˜é‡ï¼Œæ‰€æœ‰æ¢é’ˆå…±äº«

probe kernel.function("sys_read") {
    local_var = pid()           # å±€éƒ¨å˜é‡ï¼Œåªåœ¨å½“å‰æ¢é’ˆæœ‰æ•ˆ
    global_counter++            # ä¿®æ”¹å…¨å±€å˜é‡
    
    printf("å½“å‰è¿›ç¨‹ï¼š%dï¼Œå…¨å±€è®¡æ•°ï¼š%d\n", local_var, global_counter)
}

probe timer.s(10) {
    # local_varåœ¨è¿™é‡Œæ— æ³•è®¿é—®ï¼Œä½†global_counterå¯ä»¥
    printf("10ç§’å†…æ€»è¯»å–æ¬¡æ•°ï¼š%d\n", global_counter)
    global_counter = 0          # é‡ç½®è®¡æ•°å™¨
}
```

---

## 7. ğŸ“ˆ ç»Ÿè®¡å‡½æ•°ä¸èšåˆæ“ä½œ


### 7.1 å†…ç½®ç»Ÿè®¡å‡½æ•°


**ğŸ”¸ åŸºç¡€ç»Ÿè®¡å‡½æ•°**ï¼š
```stap
global response_times

probe kernel.function("sys_read") {
    start_time[tid()] = gettimeofday_us()
}

probe kernel.function("sys_read").return {
    if (tid() in start_time) {
        elapsed = gettimeofday_us() - start_time[tid()]
        response_times <<< elapsed          # å°†æ•°æ®åŠ å…¥ç»Ÿè®¡é›†åˆ
        delete start_time[tid()]
    }
}

probe timer.s(5) {
    if (@count(response_times) > 0) {
        printf("=== è¯»å–æ“ä½œæ€§èƒ½ç»Ÿè®¡ ===\n")
        printf("æ ·æœ¬æ•°é‡ï¼š%d\n", @count(response_times))
        printf("æœ€å°å€¼ï¼š%då¾®ç§’\n", @min(response_times))
        printf("æœ€å¤§å€¼ï¼š%då¾®ç§’\n", @max(response_times))
        printf("å¹³å‡å€¼ï¼š%då¾®ç§’\n", @avg(response_times))
        printf("æ€»å’Œï¼š%då¾®ç§’\n", @sum(response_times))
        
        delete response_times
    }
}
```

**ğŸ”¸ é«˜çº§ç»Ÿè®¡å‡½æ•°**ï¼š
```stap
global disk_io_sizes

probe ioblock.request {
    disk_io_sizes <<< size
}

probe timer.s(10) {
    if (@count(disk_io_sizes) > 0) {
        printf("=== ç£ç›˜IOå¤§å°åˆ†å¸ƒ ===\n")
        printf("è¯·æ±‚æ€»æ•°ï¼š%d\n", @count(disk_io_sizes))
        printf("ä¸­ä½æ•°ï¼š%då­—èŠ‚\n", @median(disk_io_sizes))
        printf("æ ‡å‡†å·®ï¼š%d\n", @stddev(disk_io_sizes))
        
        # ç™¾åˆ†ä½æ•°ç»Ÿè®¡
        printf("50%%åˆ†ä½æ•°ï¼š%då­—èŠ‚\n", @percentile(disk_io_sizes, 50))
        printf("90%%åˆ†ä½æ•°ï¼š%då­—èŠ‚\n", @percentile(disk_io_sizes, 90))
        printf("99%%åˆ†ä½æ•°ï¼š%då­—èŠ‚\n", @percentile(disk_io_sizes, 99))
        
        delete disk_io_sizes
    }
}
```

### 7.2 æ•°æ®èšåˆæŠ€å·§


**ğŸ“Š å¤šç»´åº¦ç»Ÿè®¡åˆ†æ**ï¼š
```stap
#!/usr/bin/env stap

global file_ops_by_process      # æŒ‰è¿›ç¨‹åˆ†ç»„ç»Ÿè®¡
global io_latency              # IOå»¶è¿Ÿç»Ÿè®¡

probe vfs.read.return, vfs.write.return {
    # æŒ‰è¿›ç¨‹ç»Ÿè®¡æ–‡ä»¶æ“ä½œæ¬¡æ•°
    file_ops_by_process[execname()]++
    
    # æ”¶é›†IOå»¶è¿Ÿæ•°æ®
    io_latency <<< gettimeofday_us() - @entry(gettimeofday_us())
}

probe timer.s(15) {
    printf("\n" . "="*50 . "\n")
    printf("ç³»ç»Ÿæ–‡ä»¶æ“ä½œç»Ÿè®¡æŠ¥å‘Š\n")
    printf("="*50 . "\n")
    
    # æ˜¾ç¤ºæœ€æ´»è·ƒçš„è¿›ç¨‹
    printf("\nğŸ” æœ€æ´»è·ƒè¿›ç¨‹ï¼ˆæ–‡ä»¶æ“ä½œæ¬¡æ•°ï¼‰ï¼š\n")
    printf("%-20s %s\n", "è¿›ç¨‹å", "æ“ä½œæ¬¡æ•°")
    printf("-"*35 . "\n")
    foreach (process in file_ops_by_process- limit 5) {
        printf("%-20s %d\n", process, file_ops_by_process[process])
    }
    
    # IOæ€§èƒ½åˆ†æ
    if (@count(io_latency) > 0) {
        printf("\nâš¡ IOæ€§èƒ½åˆ†æï¼š\n")
        printf("æ ·æœ¬æ•°é‡ï¼š%d\n", @count(io_latency))
        printf("å¹³å‡å»¶è¿Ÿï¼š%då¾®ç§’\n", @avg(io_latency))
        printf("æœ€å¤§å»¶è¿Ÿï¼š%då¾®ç§’\n", @max(io_latency))
        
        # æ€§èƒ½ç­‰çº§åˆ¤æ–­
        avg_latency = @avg(io_latency)
        if (avg_latency < 1000) {
            printf("æ€§èƒ½ç­‰çº§ï¼šğŸŸ¢ ä¼˜ç§€ï¼ˆ<1msï¼‰\n")
        } else if (avg_latency < 5000) {
            printf("æ€§èƒ½ç­‰çº§ï¼šğŸŸ¡ è‰¯å¥½ï¼ˆ1-5msï¼‰\n")
        } else {
            printf("æ€§èƒ½ç­‰çº§ï¼šğŸ”´ éœ€è¦ä¼˜åŒ–ï¼ˆ>5msï¼‰\n")
        }
    }
    
    # æ¸…ç©ºæ•°æ®é‡æ–°ç»Ÿè®¡
    delete file_ops_by_process
    delete io_latency
}
```

---

## 8. ğŸš€ å®æ—¶æ•°æ®æ”¶é›†ä¸åˆ†æ


### 8.1 å®æ—¶ç›‘æ§ä»ªè¡¨æ¿


**ğŸ“º ç³»ç»ŸçŠ¶æ€å®æ—¶æ˜¾ç¤º**ï¼š
```stap
#!/usr/bin/env stap

global cpu_samples, memory_samples, network_samples
global last_update_time

probe timer.ms(100) {
    # æ”¶é›†CPUæ ·æœ¬ï¼ˆç®€åŒ–ç‰ˆï¼ŒåŸºäºå®šæ—¶å™¨è§¦å‘é¢‘ç‡ï¼‰
    cpu_samples++
}

probe kernel.function("__alloc_pages_nodemask") {
    # å†…å­˜åˆ†é…è®¡æ•°
    memory_samples++
}

probe netdev.transmit, netdev.receive {
    # ç½‘ç»œæ´»åŠ¨è®¡æ•°
    network_samples++
}

# æ¯ç§’æ›´æ–°æ˜¾ç¤º
probe timer.s(1) {
    # æ¸…å±å¹¶ç§»åŠ¨å…‰æ ‡åˆ°é¡¶éƒ¨ï¼ˆåˆ›å»ºå®æ—¶æ›´æ–°æ•ˆæœï¼‰
    printf("\033[2J\033[H")
    
    printf("ğŸ–¥ï¸  ç³»ç»Ÿå®æ—¶ç›‘æ§ä»ªè¡¨æ¿\n")
    printf("="*50 . "\n")
    printf("æ›´æ–°æ—¶é—´ï¼š%s\n", ctime(gettimeofday_s()))
    printf("-"*50 . "\n")
    
    # CPUæ´»åŠ¨æŒ‡ç¤ºå™¨
    printf("ğŸ’» CPUæ´»åŠ¨ï¼š")
    cpu_level = cpu_samples / 10    # è½¬æ¢ä¸ºæ´»åŠ¨ç­‰çº§
    for (i = 0; i < 10; i++) {
        if (i < cpu_level) printf("â–ˆ")
        else printf("â–‘")
    }
    printf(" (%d%%)\n", cpu_level * 10)
    
    # å†…å­˜æ´»åŠ¨
    printf("ğŸ§  å†…å­˜åˆ†é…ï¼š%dæ¬¡/ç§’\n", memory_samples)
    
    # ç½‘ç»œæ´»åŠ¨
    printf("ğŸŒ ç½‘ç»œåŒ…ï¼š%dä¸ª/ç§’\n", network_samples)
    
    # ç»˜åˆ¶ç®€å•çš„æ´»åŠ¨è¶‹åŠ¿å›¾
    printf("\nğŸ“Š æ´»åŠ¨è¶‹åŠ¿ï¼š\n")
    printf("ç½‘ç»œ ")
    net_bars = network_samples / 5
    if (net_bars > 20) net_bars = 20
    for (i = 0; i < net_bars; i++) printf("â–†")
    printf("\n")
    
    # é‡ç½®è®¡æ•°å™¨
    cpu_samples = 0
    memory_samples = 0
    network_samples = 0
}

probe begin {
    printf("å¯åŠ¨ç³»ç»Ÿç›‘æ§ï¼ŒæŒ‰Ctrl+Cåœæ­¢...\n")
}
```

### 8.2 æ•°æ®æµåˆ†æ


**ğŸŒŠ ç½‘ç»œæµé‡å®æ—¶åˆ†æ**ï¼š
```stap
#!/usr/bin/env stap

global packet_sizes, protocols, bandwidth_usage
global bytes_per_second = 0

# ç›‘æ§ç½‘ç»œåŒ…
probe netdev.receive {
    packet_sizes <<< length
    protocols[protocol]++
    bytes_per_second += length
}

probe netdev.transmit {
    packet_sizes <<< length
    bytes_per_second += length
}

# æ¯5ç§’ç”ŸæˆæŠ¥å‘Š
probe timer.s(5) {
    printf("\nğŸŒ ç½‘ç»œæµé‡åˆ†ææŠ¥å‘Š\n")
    printf("æ—¶é—´ï¼š%s\n", ctime(gettimeofday_s()))
    printf("-"*40 . "\n")
    
    # å¸¦å®½ä½¿ç”¨æƒ…å†µ
    mbps = (bytes_per_second * 8) / (5 * 1024 * 1024)
    printf("å¸¦å®½ä½¿ç”¨ï¼š%.2f Mbps\n", mbps)
    
    # å¸¦å®½ä½¿ç”¨å¯è§†åŒ–
    printf("å¸¦å®½å›¾è¡¨ï¼š")
    bars = mbps / 10    # æ¯10Mbpsä¸€ä¸ªå•ä½
    if (bars > 20) bars = 20
    for (i = 0; i < bars; i++) printf("â–ˆ")
    for (i = bars; i < 20; i++) printf("â–‘")
    printf(" (%.1f Mbps)\n", mbps)
    
    # æ•°æ®åŒ…ç»Ÿè®¡
    if (@count(packet_sizes) > 0) {
        printf("æ•°æ®åŒ…ç»Ÿè®¡ï¼š\n")
        printf("  æ€»æ•°ï¼š%dä¸ª\n", @count(packet_sizes))
        printf("  å¹³å‡å¤§å°ï¼š%då­—èŠ‚\n", @avg(packet_sizes))
        printf("  æœ€å¤§åŒ…ï¼š%då­—èŠ‚\n", @max(packet_sizes))
    }
    
    # åè®®åˆ†å¸ƒ
    printf("åè®®åˆ†å¸ƒï¼š\n")
    foreach (proto in protocols) {
        printf("  %s: %dä¸ª\n", proto, protocols[proto])
    }
    
    # é‡ç½®è®¡æ•°å™¨
    bytes_per_second = 0
    delete packet_sizes
    delete protocols
}
```

---

## 9. âš–ï¸ æ€§èƒ½å¼€é”€æ§åˆ¶


### 9.1 æ€§èƒ½å¼€é”€è®¤çŸ¥


**ğŸ” SystemTapçš„æ€§èƒ½å½±å“**ï¼š

```
æ€§èƒ½å¼€é”€æ¥æºåˆ†æï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ¢é’ˆæ’å…¥å¼€é”€     â”‚ â† æ¯æ¬¡äº‹ä»¶è§¦å‘æ—¶çš„å¤„ç†æ—¶é—´
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ•°æ®æ”¶é›†å¼€é”€     â”‚ â† æ”¶é›†å’Œå­˜å‚¨æ•°æ®çš„CPUä½¿ç”¨
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å†…å­˜ä½¿ç”¨å¼€é”€     â”‚ â† å­˜å‚¨ç»Ÿè®¡æ•°æ®çš„å†…å­˜å ç”¨
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¾“å‡ºå¼€é”€        â”‚ â† printfç­‰è¾“å‡ºæ“ä½œçš„å¼€é”€
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¼€é”€å¤§å°æ’åºï¼ˆä»é«˜åˆ°ä½ï¼‰ï¼š
ğŸ”´ é«˜é¢‘äº‹ä»¶ + å¤æ‚å¤„ç† ï¼ˆå¦‚ï¼šæ¯ä¸ªæŒ‡ä»¤éƒ½ç›‘æ§ï¼‰
ğŸŸ¡ é«˜é¢‘äº‹ä»¶ + ç®€å•å¤„ç† ï¼ˆå¦‚ï¼šè®¡æ•°å™¨é€’å¢ï¼‰
ğŸŸ¢ ä½é¢‘äº‹ä»¶ + å¤æ‚å¤„ç† ï¼ˆå¦‚ï¼šè¿›ç¨‹åˆ›å»ºæ—¶çš„è¯¦ç»†åˆ†æï¼‰
âšª ä½é¢‘äº‹ä»¶ + ç®€å•å¤„ç† ï¼ˆå¦‚ï¼šç³»ç»Ÿå¯åŠ¨æ—¶çš„è®°å½•ï¼‰
```

### 9.2 å¼€é”€æ§åˆ¶ç­–ç•¥


**ğŸ›ï¸ é‡‡æ ·æŠ€æœ¯å‡å°‘å¼€é”€**ï¼š
```stap
#!/usr/bin/env stap

global sample_count = 0
global total_samples = 0

# é‡‡æ ·ç›‘æ§ï¼šåªå¤„ç†1%çš„äº‹ä»¶
probe kernel.function("sys_read") {
    total_samples++
    
    # åªå¤„ç†æ¯100ä¸ªäº‹ä»¶ä¸­çš„1ä¸ª
    if ((total_samples % 100) == 0) {
        sample_count++
        printf("é‡‡æ ·äº‹ä»¶ #%dï¼šè¿›ç¨‹%sè¯»å–æ–‡ä»¶\n", 
               sample_count, execname())
    }
}

probe timer.s(10) {
    printf("ç»Ÿè®¡ï¼šå¤„ç†äº†%dä¸ªé‡‡æ ·ï¼Œè·³è¿‡äº†%dä¸ªäº‹ä»¶\n", 
           sample_count, total_samples - sample_count)
    printf("é‡‡æ ·ç‡ï¼š%.2f%%\n", (sample_count * 100.0) / total_samples)
}
```

**â±ï¸ æ—¶é—´çª—å£é™åˆ¶**ï¼š
```stap
#!/usr/bin/env stap

global monitoring_enabled = 1
global event_count = 0

probe begin {
    printf("å¼€å§‹ç›‘æ§ï¼Œ30ç§’åè‡ªåŠ¨åœæ­¢\n")
}

# åªåœ¨å¯ç”¨ç›‘æ§æ—¶å¤„ç†äº‹ä»¶
probe vfs.read {
    if (monitoring_enabled) {
        event_count++
        if ((event_count % 100) == 0) {
            printf("å·²å¤„ç†%dä¸ªè¯»å–äº‹ä»¶\n", event_count)
        }
    }
}

# 30ç§’ååœæ­¢ç›‘æ§
probe timer.s(30) {
    monitoring_enabled = 0
    printf("ç›‘æ§å·²åœæ­¢ï¼Œæ€»å…±å¤„ç†%dä¸ªäº‹ä»¶\n", event_count)
    exit()
}
```

### 9.3 æ€§èƒ½è°ƒä¼˜æŠ€å·§


**âš¡ é«˜æ•ˆè„šæœ¬ç¼–å†™åŸåˆ™**ï¼š
```stap
#!/usr/bin/env stap

global efficient_stats
global inefficient_stats

# âœ… é«˜æ•ˆåšæ³•ï¼šç®€å•å¿«é€Ÿçš„æ“ä½œ
probe kernel.function("sys_write") {
    efficient_stats[execname()]++    # ç®€å•è®¡æ•°ï¼Œå¼€é”€æå°
}

# âŒ ä½æ•ˆåšæ³•ï¼šå¤æ‚å­—ç¬¦ä¸²æ“ä½œ
probe kernel.function("sys_read") {
    # é¿å…å¤æ‚çš„å­—ç¬¦ä¸²æ‹¼æ¥å’Œå¤„ç†
    # é¿å…åœ¨é«˜é¢‘äº‹ä»¶ä¸­ä½¿ç”¨printf
    # é¿å…å¤æ‚çš„æ¡ä»¶åˆ¤æ–­
}

# âœ… æ‰¹é‡è¾“å‡ºå‡å°‘å¼€é”€
probe timer.s(5) {
    printf("=== æ‰¹é‡ç»Ÿè®¡ç»“æœ ===\n")
    foreach (prog in efficient_stats- limit 10) {
        printf("%s: %d\n", prog, efficient_stats[prog])
    }
    delete efficient_stats
}
```

**ğŸ“Š æ€§èƒ½ç›‘æ§è„šæœ¬**ï¼š
```stap
#!/usr/bin/env stap

global script_overhead_start
global probe_trigger_count = 0

probe begin {
    script_overhead_start = gettimeofday_us()
    printf("å¼€å§‹æ€§èƒ½ç›‘æ§è„šæœ¬\n")
}

probe kernel.function("sys_open") {
    probe_trigger_count++
}

probe timer.s(10) {
    elapsed = gettimeofday_us() - script_overhead_start
    printf("æ€§èƒ½æŠ¥å‘Šï¼š\n")
    printf("è¿è¡Œæ—¶é—´ï¼š%då¾®ç§’\n", elapsed)
    printf("æ¢é’ˆè§¦å‘ï¼š%dæ¬¡\n", probe_trigger_count)
    printf("å¹³å‡æ¯æ¬¡è§¦å‘å¼€é”€ï¼š%.2få¾®ç§’\n", 
           (elapsed * 1.0) / probe_trigger_count)
    
    exit()
}
```

---

## 10. ğŸ› è°ƒè¯•è„šæœ¬ç¼–å†™æŠ€å·§


### 10.1 å¸¸è§é”™è¯¯ä¸è§£å†³


**ğŸ”¸ è¯­æ³•é”™è¯¯è°ƒè¯•**ï¼š
```bash
# ä½¿ç”¨-vå‚æ•°æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯
sudo stap -v test.stp

# ä½¿ç”¨-p2å‚æ•°åªè¿›è¡Œè¯­æ³•æ£€æŸ¥ï¼Œä¸è¿è¡Œ
sudo stap -p2 test.stp

# æ£€æŸ¥æ¢é’ˆç‚¹æ˜¯å¦å­˜åœ¨
stap -l 'kernel.function("ä¸å­˜åœ¨çš„å‡½æ•°")'
```

**ğŸ”¸ è¿è¡Œæ—¶é”™è¯¯å¤„ç†**ï¼š
```stap
#!/usr/bin/env stap

global error_count = 0

probe kernel.function("sys_open") {
    try {
        # å¯èƒ½å‡ºé”™çš„æ“ä½œ
        filename = kernel_string($filename)
        printf("æ‰“å¼€æ–‡ä»¶ï¼š%s\n", filename)
    } catch {
        error_count++
        printf("å¤„ç†ç¬¬%dä¸ªé”™è¯¯\n", error_count)
    }
}

# è¶…æ—¶ä¿æŠ¤
probe timer.s(60) {
    printf("è„šæœ¬è¿è¡Œè¶…æ—¶ï¼Œè‡ªåŠ¨é€€å‡º\n")
    exit()
}
```

### 10.2 è°ƒè¯•æŠ€å·§ä¸å·¥å…·


**ğŸ” è°ƒè¯•ä¿¡æ¯æ·»åŠ **ï¼š
```stap
#!/usr/bin/env stap

global debug_mode = 1           # è°ƒè¯•å¼€å…³

function debug_print(msg) {
    if (debug_mode) {
        printf("[DEBUG] %s: %s\n", ctime(gettimeofday_s()), msg)
    }
}

probe begin {
    debug_print("è„šæœ¬å¼€å§‹æ‰§è¡Œ")
}

probe kernel.function("sys_read") {
    debug_print(sprintf("ç›‘æ§åˆ°è¯»å–æ“ä½œï¼Œè¿›ç¨‹ï¼š%sï¼ŒPIDï¼š%d", 
                       execname(), pid()))
    
    # æ¡ä»¶è°ƒè¯•ï¼šåªè°ƒè¯•ç‰¹å®šè¿›ç¨‹
    if (execname() == "cat") {
        printf("ğŸ± å‘ç°catå‘½ä»¤è¯»å–æ–‡ä»¶\n")
    }
}

probe end {
    debug_print("è„šæœ¬æ‰§è¡Œç»“æŸ")
}
```

**ğŸ“ æ—¥å¿—è®°å½•ä¸åˆ†æ**ï¼š
```stap
#!/usr/bin/env stap

global log_file = "/tmp/systemtap.log"
global event_log

probe vfs.read {
    # è®°å½•äº‹ä»¶åˆ°å†…å­˜ä¸­ï¼Œé¿å…é¢‘ç¹å†™æ–‡ä»¶
    timestamp = gettimeofday_s()
    event_log[timestamp] = sprintf("%s|%s|%d|%s", 
                                   ctime(timestamp), 
                                   execname(), 
                                   pid(), 
                                   pathname)
}

# å®šæœŸå†™å…¥æ—¥å¿—æ–‡ä»¶
probe timer.s(30) {
    printf("å†™å…¥æ—¥å¿—æ–‡ä»¶ï¼š%s\n", log_file)
    foreach (time in event_log) {
        # åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥å†™å…¥æ–‡ä»¶
        printf("LOG: %s\n", event_log[time])
    }
    delete event_log
}
```

### 10.3 è„šæœ¬æ¨¡æ¿ä¸æœ€ä½³å®è·µ


**ğŸ“‹ æ ‡å‡†è„šæœ¬æ¨¡æ¿**ï¼š
```stap
#!/usr/bin/env stap
#
# è„šæœ¬åç§°ï¼šmonitoring_template.stp
# åŠŸèƒ½æè¿°ï¼šSystemTapç›‘æ§è„šæœ¬æ¨¡æ¿
# ä½œè€…ï¼šyour_name
# åˆ›å»ºæ—¶é—´ï¼š2025-09-15
# ç‰ˆæœ¬ï¼š1.0
#

# å…¨å±€å˜é‡å®šä¹‰
global monitoring_stats
global script_start_time
global total_events = 0

# é…ç½®å‚æ•°
global max_events = 10000       # æœ€å¤§äº‹ä»¶æ•°é™åˆ¶
global monitoring_duration = 300 # ç›‘æ§æ—¶é•¿ï¼ˆç§’ï¼‰

probe begin {
    script_start_time = gettimeofday_s()
    printf("ğŸš€ ç›‘æ§è„šæœ¬å¯åŠ¨\n")
    printf("å¼€å§‹æ—¶é—´ï¼š%s\n", ctime(script_start_time))
    printf("æœ€å¤§äº‹ä»¶æ•°ï¼š%d\n", max_events)
    printf("ç›‘æ§æ—¶é•¿ï¼š%dç§’\n", monitoring_duration)
    printf("-"*50 . "\n")
}

# ä¸»è¦ç›‘æ§é€»è¾‘
probe kernel.function("ä½ è¦ç›‘æ§çš„å‡½æ•°") {
    total_events++
    
    # äº‹ä»¶æ•°é‡ä¿æŠ¤
    if (total_events > max_events) {
        printf("âš ï¸  è¾¾åˆ°æœ€å¤§äº‹ä»¶æ•°é™åˆ¶ï¼Œåœæ­¢ç›‘æ§\n")
        exit()
    }
    
    # ä½ çš„ç›‘æ§é€»è¾‘
    monitoring_stats[execname()]++
}

# å®šæœŸæŠ¥å‘Š
probe timer.s(30) {
    runtime = gettimeofday_s() - script_start_time
    printf("\nğŸ“Š è¿è¡ŒæŠ¥å‘Šï¼ˆ%dç§’ï¼‰\n", runtime)
    printf("æ€»äº‹ä»¶æ•°ï¼š%d\n", total_events)
    printf("äº‹ä»¶é€Ÿç‡ï¼š%.2f/ç§’\n", total_events / runtime)
    
    if (@count(monitoring_stats) > 0) {
        printf("Top 5 è¿›ç¨‹ï¼š\n")
        foreach (process in monitoring_stats- limit 5) {
            printf("  %s: %dæ¬¡\n", process, monitoring_stats[process])
        }
    }
}

# è¶…æ—¶ä¿æŠ¤
probe timer.s(monitoring_duration) {
    printf("â° ç›‘æ§æ—¶é—´åˆ°ï¼Œè‡ªåŠ¨é€€å‡º\n")
    exit()
}

probe end {
    runtime = gettimeofday_s() - script_start_time
    printf("\nğŸ ç›‘æ§ç»“æŸ\n")
    printf("æ€»è¿è¡Œæ—¶é—´ï¼š%dç§’\n", runtime)
    printf("æ€»äº‹ä»¶æ•°ï¼š%d\n", total_events)
    printf("å¹³å‡äº‹ä»¶é€Ÿç‡ï¼š%.2f/ç§’\n", total_events / runtime)
}
```

---

## 11. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 11.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


**ğŸ¯ SystemTapæ ¸å¿ƒç†è§£**ï¼š
```
âœ… æœ¬è´¨ï¼šåŠ¨æ€å†…æ ¸è¿½è¸ªå·¥å…·ï¼Œæ— éœ€é‡æ–°ç¼–è¯‘å†…æ ¸
âœ… åŸç†ï¼šè„šæœ¬ â†’ å†…æ ¸æ¨¡å— â†’ åŠ¨æ€æ’å…¥ â†’ æ•°æ®æ”¶é›†
âœ… ä¼˜åŠ¿ï¼šå®æ—¶ç›‘æ§ã€é›¶é‡å¯ã€ä½å¼€é”€ã€åŠŸèƒ½å¼ºå¤§
âœ… åº”ç”¨ï¼šæ€§èƒ½åˆ†æã€é—®é¢˜è¯Šæ–­ã€ç³»ç»Ÿç›‘æ§ã€å®‰å…¨å®¡è®¡
```

**ğŸ”§ æ ¸å¿ƒæŠ€æœ¯è¦ç‚¹**ï¼š
```
ğŸ”¸ æ¢é’ˆç±»å‹ï¼šå†…æ ¸å‡½æ•°ã€ç³»ç»Ÿè°ƒç”¨ã€è¿½è¸ªç‚¹ã€ç”¨æˆ·ç©ºé—´
ğŸ”¸ æ•°æ®ç»“æ„ï¼šå…³è”æ•°ç»„ã€ç»Ÿè®¡é›†åˆã€å…¨å±€/å±€éƒ¨å˜é‡
ğŸ”¸ è¯­æ³•ç‰¹ç‚¹ï¼šç±»Cè¯­æ³•ã€æ¢é’ˆé©±åŠ¨ã€äº‹ä»¶å“åº”
ğŸ”¸ æ€§èƒ½æ§åˆ¶ï¼šé‡‡æ ·æŠ€æœ¯ã€æ—¶é—´çª—å£ã€æ‰¹é‡å¤„ç†
```

### 11.2 å…³é”®åº”ç”¨åœºæ™¯


| **åº”ç”¨åœºæ™¯** | **ç›‘æ§å¯¹è±¡** | **å…¸å‹æ¢é’ˆ** | **æ•°æ®åˆ†æ** |
|-------------|-------------|-------------|-------------|
| ğŸ” **æ€§èƒ½åˆ†æ** | `ç³»ç»Ÿè°ƒç”¨å»¶è¿Ÿ` | `syscall.*` | `å»¶è¿Ÿåˆ†å¸ƒç»Ÿè®¡` |
| ğŸ“Š **èµ„æºç›‘æ§** | `CPU/å†…å­˜/IO` | `timer.profile` | `ä½¿ç”¨ç‡è¶‹åŠ¿` |
| ğŸ› **é—®é¢˜è¯Šæ–­** | `ç‰¹å®šå‡½æ•°è°ƒç”¨` | `kernel.function` | `è°ƒç”¨é“¾è¿½è¸ª` |
| ğŸ”’ **å®‰å…¨å®¡è®¡** | `æ–‡ä»¶è®¿é—®æƒé™` | `vfs.open` | `è®¿é—®æ¨¡å¼åˆ†æ` |
| ğŸŒ **ç½‘ç»œåˆ†æ** | `ç½‘ç»œåŒ…å¤„ç†` | `netdev.*` | `æµé‡ç»Ÿè®¡åˆ†æ` |

### 11.3 å®é™…ä½¿ç”¨æŒ‡å¯¼


**âœ… ä½¿ç”¨å»ºè®®**ï¼š
```
1. ğŸ¯ æ˜ç¡®ç›‘æ§ç›®æ ‡ï¼šçŸ¥é“è¦è§£å†³ä»€ä¹ˆé—®é¢˜
2. ğŸ” é€‰æ‹©åˆé€‚æ¢é’ˆï¼šæ ¹æ®ç›‘æ§éœ€æ±‚é€‰æ‹©æ¢é’ˆç‚¹
3. âš–ï¸ æ§åˆ¶æ€§èƒ½å¼€é”€ï¼šä½¿ç”¨é‡‡æ ·å’Œæ—¶é—´çª—å£
4. ğŸ“Š åˆç†æ•°æ®åˆ†æï¼šä½¿ç”¨ç»Ÿè®¡å‡½æ•°è¿›è¡Œæ•°æ®èšåˆ
5. ğŸ› å……åˆ†æµ‹è¯•éªŒè¯ï¼šåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯è„šæœ¬æ­£ç¡®æ€§
```

**âŒ å¸¸è§é™·é˜±**ï¼š
```
ğŸš« é¿å…é«˜é¢‘äº‹ä»¶çš„å¤æ‚å¤„ç†
ğŸš« é¿å…åœ¨æ¢é’ˆä¸­è¿›è¡Œå¤§é‡å­—ç¬¦ä¸²æ“ä½œ
ğŸš« é¿å…æ— é™åˆ¶çš„æ•°æ®æ”¶é›†
ğŸš« é¿å…åœ¨ç”Ÿäº§ç¯å¢ƒç›´æ¥è¿è¡Œæœªæµ‹è¯•è„šæœ¬
ğŸš« é¿å…å¿½ç•¥è„šæœ¬çš„æ€§èƒ½å½±å“
```

### 11.4 å­¦ä¹ è¿›é˜¶è·¯çº¿


**ğŸ“ˆ æŠ€èƒ½æå‡è·¯å¾„**ï¼š
```
åˆçº§é˜¶æ®µï¼š
â”œâ”€â”€ å®‰è£…é…ç½®SystemTapç¯å¢ƒ
â”œâ”€â”€ ç¼–å†™åŸºç¡€ç›‘æ§è„šæœ¬
â”œâ”€â”€ ç†è§£æ¢é’ˆå’Œäº‹ä»¶æ¦‚å¿µ
â””â”€â”€ æŒæ¡åŸºæœ¬è¯­æ³•å’Œå‡½æ•°

ä¸­çº§é˜¶æ®µï¼š
â”œâ”€â”€ å¤æ‚æ•°æ®ç»“æ„ä½¿ç”¨
â”œâ”€â”€ æ€§èƒ½å¼€é”€ä¼˜åŒ–æŠ€å·§
â”œâ”€â”€ å¤šç»´åº¦æ•°æ®åˆ†æ
â””â”€â”€ å®é™…é—®é¢˜è¯Šæ–­æ¡ˆä¾‹

é«˜çº§é˜¶æ®µï¼š
â”œâ”€â”€ è‡ªå®šä¹‰æ¢é’ˆå¼€å‘
â”œâ”€â”€ å†…æ ¸æ·±åº¦åˆ†æ
â”œâ”€â”€ å¤§è§„æ¨¡ç›‘æ§æ–¹æ¡ˆ
â””â”€â”€ å·¥å…·é›†æˆå’Œè‡ªåŠ¨åŒ–
```

### 11.5 æ ¸å¿ƒè®°å¿†è¦ç‚¹


> ğŸ’¡ **SystemTapç²¾é«“**ï¼š
> - åŠ¨æ€è¿½è¸ªä¸é‡å¯ï¼Œå®æ—¶ç›‘æ§è§çœŸç« 
> - æ¢é’ˆäº‹ä»¶é©±åŠ¨å“åº”ï¼Œæ•°æ®ç»Ÿè®¡å·§åˆ†æ  
> - æ€§èƒ½å¼€é”€è¦æ§åˆ¶ï¼Œé‡‡æ ·çª—å£æ˜¯å…³é”®
> - è„šæœ¬è°ƒè¯•æ­¥æ­¥æ¥ï¼Œæ¨¡æ¿å®è·µå‡ºçœŸçŸ¥

**ğŸ¯ å…³é”®ä½¿ç”¨åŸåˆ™**ï¼š
1. **ç›®æ ‡æ˜ç¡®**ï¼šçŸ¥é“è¦ç›‘æ§ä»€ä¹ˆã€è§£å†³ä»€ä¹ˆé—®é¢˜
2. **æ€§èƒ½ä¼˜å…ˆ**ï¼šå§‹ç»ˆè€ƒè™‘è„šæœ¬å¯¹ç³»ç»Ÿæ€§èƒ½çš„å½±å“
3. **æ•°æ®é©±åŠ¨**ï¼šåŸºäºæ•°æ®åˆ†æåšå‡ºåˆ¤æ–­å’Œä¼˜åŒ–
4. **æ¸è¿›å­¦ä¹ **ï¼šä»ç®€å•è„šæœ¬å¼€å§‹ï¼Œé€æ­¥æŒæ¡é«˜çº§ç‰¹æ€§

SystemTapæ˜¯Linuxç³»ç»Ÿè¯Šæ–­å’Œæ€§èƒ½åˆ†æçš„å¼ºå¤§å·¥å…·ï¼ŒæŒæ¡å®ƒèƒ½è®©ä½ æ›´æ·±å…¥åœ°ç†è§£ç³»ç»Ÿè¿è¡Œæœºåˆ¶ï¼Œå¿«é€Ÿå®šä½å’Œè§£å†³å„ç§ç³»ç»Ÿé—®é¢˜ã€‚è®°ä½ï¼š**å®è·µæ˜¯æœ€å¥½çš„è€å¸ˆ**ï¼Œå¤šå†™è„šæœ¬ã€å¤šåšå®éªŒï¼Œæ‰èƒ½çœŸæ­£æŒæ¡è¿™ä¸ªå¼ºå¤§çš„å·¥å…·ï¼