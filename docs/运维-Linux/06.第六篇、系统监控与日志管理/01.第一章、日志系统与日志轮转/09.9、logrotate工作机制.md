---
title: 9、logrotate工作机制
---
## 📚 目录

1. [logrotate轮转原理](#1-logrotate轮转原理)
2. [全局配置文件详解](#2-全局配置文件详解)
3. [目录管理与独立配置](#3-目录管理与独立配置)
4. [轮转触发条件](#4-轮转触发条件)
5. [压缩与保留策略](#5-压缩与保留策略)
6. [轮转脚本执行机制](#6-轮转脚本执行机制)
7. [cron定时任务集成](#7-cron定时任务集成)
8. [手动轮转测试](#8-手动轮转测试)
9. [核心要点总结](#9-核心要点总结)

---

## 1. 🔄 logrotate轮转原理


### 1.1 什么是logrotate？


📍 **难度等级**：🟢 基础

**简单理解**：logrotate就像是一个**智能的文件管理员**，专门负责管理系统中越来越大的日志文件。

```
想象一下：
你的日志文件 = 一本不断增厚的日记本
logrotate = 贴心的管家

当日记本太厚时，管家会：
1. 把旧页面装订成册存起来
2. 给你一本新的空白日记本
3. 过一段时间把太老的册子丢掉
```

**🔸 核心作用**：
- **防止磁盘爆满**：日志文件无限增长会占满磁盘
- **提高查找效率**：小文件比大文件更容易处理
- **节省存储空间**：压缩和删除旧日志释放空间
- **保持系统稳定**：避免因日志过大导致系统问题

### 1.2 logrotate工作原理


**🔄 基本工作流程**：
```
步骤1: 检查条件 → 步骤2: 执行轮转 → 步骤3: 后续处理
    ↓                 ↓                 ↓
文件大小/时间      重命名/创建新文件    压缩/删除/脚本
```

**💡 实际工作过程**：
```
原始状态：
access.log (当前日志，100MB)

执行轮转后：
access.log      (新创建的空文件)
access.log.1    (原来的access.log重命名)
access.log.2.gz (上次轮转的文件，已压缩)
```

**🎯 关键理解**：
- logrotate**不是实时运行**的，而是**定期执行**
- 它通过**重命名文件**而不是移动文件内容来轮转
- 轮转过程对正在写入日志的程序**几乎无影响**

---

## 2. ⚙️ 全局配置文件详解


### 2.1 /etc/logrotate.conf文件结构


📍 **重要程度**：⭐⭐⭐ 核心必会

**🔸 文件位置与作用**：
```bash
/etc/logrotate.conf    # 全局配置文件
# 作用：定义所有日志轮转的默认规则
```

### 2.2 核心配置参数详解


**📊 主要配置选项**：

| 🆚 **配置项** | **含义** | **示例** | **说明** |
|---------------|----------|----------|----------|
| `weekly` | 轮转频率 | 每周轮转一次 | 其他选项：daily, monthly |
| `rotate 4` | 保留份数 | 保留4个备份 | 超过4个会被删除 |
| `create` | 创建新文件 | 轮转后创建新的空日志 | 保持日志连续性 |
| `compress` | 压缩备份 | 压缩旧日志节省空间 | 通常使用gzip |
| `include` | 包含目录 | 包含其他配置文件 | 模块化管理 |

**🔧 典型配置示例**：
```bash
# 全局默认设置
weekly                    # 每周轮转
rotate 4                 # 保留4个备份文件
create                   # 轮转后创建新的空文件
compress                 # 压缩旧的日志文件
delaycompress           # 延迟压缩（下次轮转时才压缩）

# 包含单独的配置文件
include /etc/logrotate.d

# 系统日志特殊处理
/var/log/wtmp {
    monthly              # 每月轮转
    create 0664 root utmp  # 创建时的权限和所有者
    minsize 1M           # 至少1MB才轮转
    rotate 1             # 只保留1个备份
}
```

### 2.3 配置优先级


**🎯 理解配置覆盖规则**：
```
优先级（从高到低）：
特定文件配置 > 目录配置 > 全局配置

实际效果：
全局设置：rotate 4
特定配置：rotate 10
最终结果：该文件保留10个备份（特定配置生效）
```

---

## 3. 📁 目录管理与独立配置


### 3.1 /etc/logrotate.d/目录结构


📍 **难度等级**：🟡 中级

**🔸 目录作用**：
```
/etc/logrotate.d/        # 独立配置文件目录
├── nginx               # nginx日志轮转配置
├── apache2             # Apache日志轮转配置  
├── mysql-server        # MySQL日志轮转配置
├── rsyslog             # 系统日志轮转配置
└── custom-app          # 自定义应用配置
```

**💡 设计理念**：
- **模块化管理**：每个服务有独立的配置文件
- **易于维护**：修改某个服务不影响其他服务
- **包管理友好**：软件包可以自动添加/删除配置

### 3.2 独立配置文件示例


**🔧 nginx配置示例**（`/etc/logrotate.d/nginx`）：
```bash
/var/log/nginx/*.log {
    daily                # 每天轮转
    missingok           # 文件不存在不报错
    rotate 52           # 保留52个备份（约1年）
    compress            # 压缩备份文件
    delaycompress       # 延迟压缩
    notifempty          # 空文件不轮转
    create 644 nginx nginx  # 新文件权限和所有者
    sharedscripts       # 多个文件共享脚本
    postrotate          # 轮转后执行的脚本
        # 重新加载nginx配置
        /bin/kill -USR1 `cat /run/nginx.pid 2>/dev/null` 2>/dev/null || true
    endscript
}
```

**📋 配置解释**：
- `*.log`：匹配所有.log结尾的文件
- `missingok`：如果日志文件不存在，不报错继续执行
- `notifempty`：空文件不进行轮转，避免产生无意义的备份
- `sharedscripts`：多个文件轮转时，脚本只执行一次

---

## 4. ⏰ 轮转触发条件


### 4.1 基于时间的轮转


📍 **重要程度**：⭐⭐⭐ 核心必会

**🕐 时间周期选项**：
```bash
daily      # 每天轮转（适合高频访问的日志）
weekly     # 每周轮转（系统默认，平衡性较好）
monthly    # 每月轮转（适合低频日志）
yearly     # 每年轮转（适合归档日志）
```

**💡 选择建议**：
```
日志类型推荐：
🔸 Web访问日志 → daily（访问量大）
🔸 系统错误日志 → weekly（适中频率）
🔸 安全审计日志 → monthly（长期保存）
🔸 性能统计日志 → daily（需要及时分析）
```

### 4.2 基于大小的轮转


**📏 大小判断选项**：
```bash
size 100M      # 文件达到100MB时轮转
minsize 1M     # 最小1MB才轮转（避免小文件频繁轮转）
maxsize 500M   # 最大500MB必须轮转（即使时间未到）
```

**🔍 组合使用示例**：
```bash
/var/log/application.log {
    daily              # 每天检查
    minsize 10M        # 但至少要10MB才轮转
    maxsize 1G         # 超过1GB立即轮转
    rotate 7           # 保留一周的备份
}
```

**❓ 常见问题解答**：
**Q：为什么要设置minsize？**
**A：** 避免小文件频繁轮转。比如一个应用昨天只写了1KB日志，没必要轮转。

**Q：size和daily能同时使用吗？**
**A：** 可以！logrotate会检查两个条件，任一满足就轮转。

---

## 5. 🗜️ 压缩与保留策略


### 5.1 压缩配置详解


📍 **难度等级**：🟢 基础

**🔸 压缩相关选项**：
```bash
compress          # 启用压缩（默认使用gzip）
nocompress        # 禁用压缩
delaycompress     # 延迟压缩（推荐）
compresscmd gzip  # 指定压缩命令
compressext .gz   # 压缩文件扩展名
compressoptions -9 # 压缩选项（-9最高压缩率）
```

**💡 delaycompress的巧妙之处**：
```
不使用delaycompress：
轮转时： access.log → access.log.1.gz（立即压缩）
问题：如果程序还在写入，可能导致数据丢失

使用delaycompress：
第1次轮转： access.log → access.log.1（不压缩）
第2次轮转： access.log.1 → access.log.2.gz（这时才压缩）
好处：给程序时间释放文件句柄
```

### 5.2 保留策略配置


**📊 保留数量控制**：
```bash
rotate 7          # 保留7个备份文件
maxage 30         # 保存30天，超过自动删除
```

**🎯 实际保留效果**：
```
文件演变过程（rotate 3）：
Day 1: access.log
Day 2: access.log, access.log.1
Day 3: access.log, access.log.1, access.log.2
Day 4: access.log, access.log.1, access.log.2, access.log.3
Day 5: access.log, access.log.1, access.log.2, access.log.3
       （access.log.4会被删除，因为超过了rotate 3的限制）
```

---

## 6. 📝 轮转脚本执行机制


### 6.1 脚本执行时机


📍 **重要程度**：⭐⭐⭐ 核心必会

**🔄 脚本类型与执行顺序**：
```
prerotate     # 轮转前执行
    ↓
执行轮转操作    # 重命名、创建新文件
    ↓
postrotate    # 轮转后执行
```

### 6.2 实际应用场景


**🔧 典型的postrotate脚本**：
```bash
/var/log/nginx/*.log {
    daily
    rotate 30
    compress
    delaycompress
    postrotate
        # 方法1：发送信号重新打开日志文件
        /bin/kill -USR1 `cat /var/run/nginx.pid` 2>/dev/null || true
        
        # 方法2：重启服务（不推荐，会中断服务）
        # systemctl reload nginx
    endscript
}
```

**💡 为什么需要postrotate脚本？**
```
问题场景：
1. nginx正在向access.log写入日志
2. logrotate将access.log重命名为access.log.1
3. nginx仍然向原来的文件句柄写入（实际写入access.log.1）
4. 新的access.log文件空着，没有新日志

解决方案：
postrotate脚本发送USR1信号给nginx
nginx收到信号后重新打开日志文件
这样新的日志就会写入新的access.log文件
```

**❓ 常见问题解答**：
**Q：什么时候用prerotate？**
**A：** 通常用于轮转前的准备工作，比如备份配置文件、停止某些进程等。

**Q：脚本执行失败会影响轮转吗？**
**A：** 如果prerotate失败，轮转会停止；如果postrotate失败，轮转已完成，只是后续处理失败。

---

## 7. ⏰ cron定时任务集成


### 7.1 logrotate的定时执行


📍 **难度等级**：🟢 基础

**🔸 默认定时配置**：
```bash
# 查看系统的cron配置
cat /etc/cron.daily/logrotate

#!/bin/sh
/usr/sbin/logrotate -s /var/lib/logrotate/logrotate.status /etc/logrotate.conf
```

**📅 执行时间安排**：
```
默认执行时间：
├── /etc/cron.daily/     # 每天执行（通常在凌晨）
├── /etc/cron.weekly/    # 每周执行
├── /etc/cron.monthly/   # 每月执行
└── 具体时间由anacron或cron.d控制
```

### 7.2 自定义执行时间


**🔧 修改执行时间**：
```bash
# 方法1：直接修改cron任务
crontab -e
# 添加：每天凌晨2点执行
0 2 * * * /usr/sbin/logrotate /etc/logrotate.conf

# 方法2：创建独立的cron文件
vim /etc/cron.d/logrotate
0 2 * * * root /usr/sbin/logrotate /etc/logrotate.conf
```

**💡 为什么选择凌晨执行？**
- 系统负载相对较低
- 不影响业务高峰期
- 有足够时间处理大文件

---

## 8. 🔧 手动轮转测试


### 8.1 测试命令详解


📍 **重要程度**：⭐⭐⭐ 核心必会

**🔧 基本测试命令**：
```bash
# -f: 强制轮转（忽略时间和大小条件）
logrotate -f /etc/logrotate.conf

# -d: 调试模式（只显示会执行什么，不实际执行）
logrotate -d /etc/logrotate.conf

# -v: 详细模式（显示执行过程）
logrotate -v /etc/logrotate.conf

# 测试特定配置文件
logrotate -f /etc/logrotate.d/nginx
```

### 8.2 调试与故障排除


**🔍 调试模式示例**：
```bash
# 调试模式输出示例
$ logrotate -d /etc/logrotate.d/nginx

reading config file /etc/logrotate.d/nginx
Handling 1 logs

rotating pattern: /var/log/nginx/*.log  daily (30 rotations)
empty log files are not rotated, old logs are removed
considering log /var/log/nginx/access.log
  log does not need rotating (log has been already rotated)
considering log /var/log/nginx/error.log
  log does not need rotating (log has been already rotated)
```

**💡 调试输出解读**：
- `reading config file`：正在读取配置文件
- `considering log`：正在检查某个日志文件
- `log does not need rotating`：文件不需要轮转（条件未满足）
- `log needs rotating`：文件需要轮转

**🛠️ 常见问题排查**：
```bash
# 问题1：权限不足
sudo logrotate -f /etc/logrotate.conf

# 问题2：配置文件语法错误
logrotate -d /etc/logrotate.conf  # 先用调试模式检查

# 问题3：查看详细错误信息
logrotate -v -f /etc/logrotate.conf

# 问题4：检查状态文件
cat /var/lib/logrotate/logrotate.status
```

---

## 9. 📋 核心要点总结


### 9.1 必须掌握的核心概念


```
🔸 logrotate本质：智能的日志文件管理工具
🔸 工作原理：定时检查→条件判断→文件轮转→后续处理
🔸 配置层次：全局配置 < 目录配置 < 特定配置
🔸 触发条件：时间周期 + 文件大小（任一满足即触发）
🔸 关键操作：重命名文件（不是移动内容）
```

### 9.2 实际应用指导


**🎯 配置选择建议**：
```
高频访问日志（Web服务器）：
├── daily 轮转
├── compress + delaycompress
├── rotate 30（保留一个月）
└── postrotate 重新加载服务

系统日志：
├── weekly 轮转
├── rotate 4（保留四周）
├── compress
└── create 权限控制

应用程序日志：
├── 根据写入频率选择daily/weekly
├── minsize 避免小文件轮转
├── maxsize 防止文件过大
└── 自定义postrotate脚本
```

**🔧 最佳实践**：
- **先用调试模式**测试配置
- **设置合理的保留策略**（balance磁盘空间和追溯需求）
- **使用delaycompress**保证数据完整性
- **配置postrotate脚本**确保服务正确处理轮转
- **定期检查logrotate状态**确保正常运行

**✅ 掌握检查**：
- [ ] 能解释logrotate的工作原理
- [ ] 能读懂和编写基本配置文件
- [ ] 能使用调试模式排查问题
- [ ] 能为应用程序配置合适的轮转策略
- [ ] 理解脚本执行时机和作用

**🧠 记忆口诀**：
*"日志轮转有妙招，定时检查条件到，重命名文件创新档，压缩保留空间好，脚本执行保连续，调试模式排故障"*

**核心理解**：
logrotate不是实时服务，而是定时任务；它通过巧妙的文件重命名实现无缝轮转，配合压缩和清理策略有效管理磁盘空间，是Linux系统日志管理的核心工具。