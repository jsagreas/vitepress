---
title: 11、logrotate高级应用
---
## 📚 目录

1. [logrotate基础回顾](#1-logrotate基础回顾)
2. [服务特定轮转配置](#2-服务特定轮转配置)
3. [预处理脚本应用](#3-预处理脚本应用)
4. [后处理脚本应用](#4-后处理脚本应用)
5. [轮转失败处理](#5-轮转失败处理)
6. [多文件模式配置](#6-多文件模式配置)
7. [符号链接处理](#7-符号链接处理)
8. [SELinux上下文保持](#8-selinux上下文保持)
9. [轮转性能优化](#9-轮转性能优化)
10. [核心要点总结](#10-核心要点总结)

---

## 1. 🔄 logrotate基础回顾


### 1.1 什么是logrotate


**简单理解**：logrotate就像一个自动整理文件的管家，专门管理日志文件。

```
为什么需要logrotate？

想象你的日记本：
- 每天写日记，日记本越来越厚
- 如果不整理，日记本会变得巨大无比
- 时间久了，找以前的内容很困难

日志文件也是一样：
- 系统每天产生大量日志
- 不处理会占满硬盘空间
- 影响系统性能和查找效率

logrotate的作用：
┌─────────────────┐    轮转    ┌─────────────────┐
│   app.log       │ ────────► │   app.log.1     │
│   (当前日志)     │           │   (昨天日志)     │
└─────────────────┘           └─────────────────┘
```

**核心工作原理**：
- **轮转**：把当前日志文件重命名为历史文件
- **压缩**：压缩历史日志文件节省空间
- **删除**：自动删除过期的历史日志
- **创建**：为应用程序创建新的空日志文件

### 1.2 基本配置文件结构


```bash
# 主配置文件
/etc/logrotate.conf

# 服务专用配置目录
/etc/logrotate.d/
├── apache2     # Apache服务日志配置
├── mysql       # MySQL服务日志配置
├── nginx       # Nginx服务日志配置
└── rsyslog     # 系统日志配置
```

**典型配置示例**：
```bash
# /etc/logrotate.d/myapp
/var/log/myapp.log {
    daily          # 每天轮转一次
    rotate 7       # 保留7个历史文件
    compress       # 压缩历史文件
    missingok      # 文件不存在不报错
    notifempty     # 空文件不轮转
}
```

---

## 2. 🛠️ 服务特定轮转配置


### 2.1 Web服务器日志配置


**Nginx日志轮转配置**：
```bash
# /etc/logrotate.d/nginx
/var/log/nginx/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 0640 www-data adm
    sharedscripts
    prerotate
        if [ -d /etc/logrotate.d/httpd-prerotate ]; then \
            run-parts /etc/logrotate.d/httpd-prerotate; \
        fi \
    endscript
    postrotate
        # 通知Nginx重新打开日志文件
        /bin/kill -USR1 `cat /run/nginx.pid 2> /dev/null` 2> /dev/null || true
    endscript
}
```

> 📌 **配置解释**：
> - `daily`：每天轮转一次
> - `rotate 30`：保留30天的历史日志  
> - `delaycompress`：延迟压缩，下次轮转时才压缩
> - `create 0640 www-data adm`：创建新文件时的权限和所有者
> - `sharedscripts`：多个文件共享预处理和后处理脚本

**Apache日志轮转配置**：
```bash
# /etc/logrotate.d/apache2
/var/log/apache2/*.log {
    weekly
    missingok
    rotate 52
    compress
    delaycompress
    notifempty
    create 0640 root adm
    sharedscripts
    postrotate
        # 重新加载Apache配置
        if /etc/init.d/apache2 status > /dev/null ; then \
            /etc/init.d/apache2 reload > /dev/null; \
        fi;
    endscript
}
```

### 2.2 数据库日志配置


**MySQL慢查询日志轮转**：
```bash
# /etc/logrotate.d/mysql-slow
/var/log/mysql/mysql-slow.log {
    daily
    rotate 7
    missingok
    notifempty
    compress
    create 0640 mysql mysql
    postrotate
        # 通知MySQL刷新日志
        /usr/bin/mysqladmin --defaults-file=/etc/mysql/debian.cnf flush-logs
    endscript
}
```

**PostgreSQL日志轮转**：
```bash
# /etc/logrotate.d/postgresql
/var/log/postgresql/postgresql-*.log {
    daily
    rotate 30
    copytruncate
    compress
    notifempty
    missingok
    su postgres postgres
}
```

> 💡 **copytruncate说明**：
> 当程序持续写入日志文件且无法重新打开时使用
> - 复制当前日志内容到轮转文件
> - 清空原日志文件内容
> - 程序继续写入原文件

### 2.3 应用程序日志配置


**Java应用日志轮转**：
```bash
# /etc/logrotate.d/tomcat
/var/log/tomcat/*.log /var/log/tomcat/*/*.log {
    daily
    rotate 14
    compress
    missingok
    notifempty
    copytruncate
    su tomcat tomcat
}
```

**Node.js应用日志轮转**：
```bash
# /etc/logrotate.d/nodejs-app
/var/log/nodejs/*.log {
    hourly
    rotate 168        # 保留一周的小时日志
    compress
    delaycompress
    missingok
    notifempty
    create 0644 nodejs nodejs
    postrotate
        # 发送USR2信号给Node.js进程重新打开日志
        /bin/kill -USR2 `cat /var/run/nodejs-app.pid` 2> /dev/null || true
    endscript
}
```

---

## 3. 📋 预处理脚本应用


### 3.1 预处理脚本的作用


**什么是预处理脚本**：
- 在日志轮转**之前**执行的脚本
- 用于准备轮转环境或备份重要信息
- 可以检查系统状态或停止相关服务

```
轮转流程图：
预处理脚本 → 轮转日志 → 后处理脚本

┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐
│   prerotate     │──►│  日志文件轮转    │──►│   postrotate    │
│   (准备工作)     │   │  (重命名/压缩)   │   │   (清理工作)     │
└─────────────────┘   └─────────────────┘   └─────────────────┘
```

### 3.2 常用预处理脚本示例


**检查磁盘空间**：
```bash
# /etc/logrotate.d/webapp
/var/log/webapp/*.log {
    daily
    rotate 10
    compress
    
    prerotate
        # 检查磁盘空间，如果小于1GB则发送告警
        AVAILABLE=$(df /var/log | tail -1 | awk '{print $4}')
        if [ $AVAILABLE -lt 1048576 ]; then
            echo "Warning: Low disk space before log rotation" | \
            mail -s "Log Rotation Warning" admin@company.com
        fi
    endscript
}
```

**备份重要日志**：
```bash
# /etc/logrotate.d/critical-app
/var/log/critical-app/app.log {
    daily
    rotate 30
    compress
    
    prerotate
        # 备份当前日志到远程服务器
        if [ -s /var/log/critical-app/app.log ]; then
            rsync -az /var/log/critical-app/app.log \
                backup-server:/backup/logs/$(date +%Y%m%d)/
        fi
    endscript
}
```

**停止相关进程**：
```bash
# /etc/logrotate.d/custom-service
/var/log/custom-service/*.log {
    weekly
    rotate 4
    compress
    
    prerotate
        # 优雅停止服务以确保日志完整性
        /bin/systemctl stop custom-service
        sleep 2
    endscript
    
    postrotate
        # 重新启动服务
        /bin/systemctl start custom-service
    endscript
}
```

### 3.3 预处理脚本最佳实践


**错误处理**：
```bash
prerotate
    # 设置错误时退出
    set -e
    
    # 检查必要条件
    if ! /bin/systemctl is-active --quiet myservice; then
        echo "Service not running, skipping rotation"
        exit 1
    fi
    
    # 记录操作日志
    echo "$(date): Starting log rotation for myservice" >> /var/log/logrotate.log
endscript
```

> ⚠️ **注意事项**：
> - 预处理脚本执行失败会阻止日志轮转
> - 脚本要考虑异常情况的处理
> - 避免在脚本中执行耗时操作

---

## 4. 🔧 后处理脚本应用


### 4.1 后处理脚本的作用


**什么是后处理脚本**：
- 在日志轮转**之后**执行的脚本
- 用于通知服务重新打开日志文件
- 执行清理工作或发送通知

### 4.2 服务重启和信号处理


**重新加载服务配置**：
```bash
# /etc/logrotate.d/web-server
/var/log/webserver/*.log {
    daily
    rotate 7
    compress
    missingok
    notifempty
    
    postrotate
        # 方法1: 重新加载配置（推荐）
        /bin/systemctl reload webserver
        
        # 方法2: 发送信号
        # /bin/kill -HUP `cat /var/run/webserver.pid`
        
        # 方法3: 重启服务（不推荐，会中断服务）
        # /bin/systemctl restart webserver
    endscript
}
```

**发送特定信号**：
```bash
postrotate
    # USR1信号：通知程序重新打开日志文件
    /bin/kill -USR1 `cat /var/run/nginx.pid 2>/dev/null` 2>/dev/null || true
    
    # HUP信号：重新加载配置
    /bin/kill -HUP `cat /var/run/apache2.pid 2>/dev/null` 2>/dev/null || true
endscript
```

### 4.3 通知和监控集成


**发送邮件通知**：
```bash
postrotate
    # 计算轮转的文件大小
    ROTATED_SIZE=$(du -sh /var/log/app.log.1 2>/dev/null | cut -f1 || echo "N/A")
    
    # 发送通知邮件
    cat << EOF | mail -s "Log Rotation Completed" admin@company.com
Application: MyApp
Date: $(date)
Rotated file size: $ROTATED_SIZE
Status: Success
EOF
endscript
```

**集成监控系统**：
```bash
postrotate
    # 向监控系统发送指标
    curl -X POST http://monitoring-server:8080/metrics \
        -d "log.rotation.completed=1&service=myapp&timestamp=$(date +%s)"
    
    # 更新Prometheus指标文件
    echo "log_rotation_timestamp{service=\"myapp\"} $(date +%s)" > \
        /var/lib/prometheus/node-exporter/logrotate.prom
endscript
```

---

## 5. ❌ 轮转失败处理


### 5.1 常见失败原因和解决方案


**权限问题**：
```bash
# 问题：logrotate权限不足
# 错误信息：Permission denied

# 解决方案：
/var/log/myapp/*.log {
    daily
    rotate 7
    # 指定运行用户
    su myapp myapp
    # 或者使用sudo
    # 在postrotate中使用sudo执行命令
}
```

**进程占用文件**：
```bash
# 问题：进程正在写入日志文件
# 解决方案1：使用copytruncate
/var/log/busy-app.log {
    daily
    copytruncate    # 复制后清空，而不是移动文件
    compress
}

# 解决方案2：先停止进程
/var/log/busy-app.log {
    daily
    prerotate
        /bin/systemctl stop busy-app
    endscript
    postrotate
        /bin/systemctl start busy-app
    endscript
}
```

### 5.2 错误检测和处理


**脚本错误处理**：
```bash
# /etc/logrotate.d/robust-config
/var/log/myapp/*.log {
    daily
    rotate 7
    compress
    
    prerotate
        # 记录开始时间
        echo "$(date): Starting rotation for myapp" >> /var/log/logrotate-debug.log
        
        # 检查服务状态
        if ! /bin/systemctl is-active --quiet myapp; then
            echo "$(date): WARNING - myapp service not running" >> /var/log/logrotate-debug.log
        fi
    endscript
    
    postrotate
        # 检查轮转是否成功
        if [ $? -eq 0 ]; then
            echo "$(date): Rotation completed successfully" >> /var/log/logrotate-debug.log
            /bin/systemctl reload myapp
        else
            echo "$(date): ERROR - Rotation failed" >> /var/log/logrotate-debug.log
            # 发送告警
            echo "Log rotation failed for myapp" | mail -s "ALERT: Log Rotation Failure" admin@company.com
        fi
    endscript
}
```

### 5.3 调试和故障排除


**手动测试轮转**：
```bash
# 测试特定配置文件
logrotate -d /etc/logrotate.d/myapp

# 强制执行轮转（测试用）
logrotate -f /etc/logrotate.d/myapp

# 详细输出模式
logrotate -v /etc/logrotate.conf
```

**状态文件管理**：
```bash
# 查看轮转状态
cat /var/lib/logrotate/status

# 重置特定文件的轮转状态
# 编辑 /var/lib/logrotate/status，删除对应行

# 手动更新状态文件
logrotate -s /var/lib/logrotate/status /etc/logrotate.conf
```

---

## 6. 📁 多文件模式配置


### 6.1 通配符模式


**基本通配符使用**：
```bash
# 轮转所有.log文件
/var/log/myapp/*.log {
    daily
    rotate 7
    compress
    sharedscripts    # 所有文件共享脚本
}

# 轮转多个目录的日志
/var/log/app1/*.log /var/log/app2/*.log /var/log/app3/*.log {
    daily
    rotate 30
    compress
    missingok
}
```

**复杂模式匹配**：
```bash
# 匹配特定模式的文件
/var/log/nginx/access*.log /var/log/nginx/error*.log {
    daily
    rotate 14
    compress
    delaycompress
    sharedscripts
    postrotate
        /bin/kill -USR1 `cat /var/run/nginx.pid 2>/dev/null` 2>/dev/null || true
    endscript
}
```

### 6.2 不同文件不同策略


**混合配置示例**：
```bash
# 错误日志保留更久
/var/log/myapp/error.log {
    daily
    rotate 30        # 保留30天
    compress
    notifempty
}

# 访问日志轮转更频繁
/var/log/myapp/access.log {
    hourly          # 每小时轮转
    rotate 48       # 保留48小时
    compress
    missingok
}

# 调试日志可以占用更多空间
/var/log/myapp/debug.log {
    daily
    rotate 7
    size 100M       # 超过100MB就轮转
    compress
    copytruncate
}
```

### 6.3 分组配置管理


**按服务分组**：
```bash
# Web服务器组
/var/log/nginx/*.log /var/log/apache2/*.log {
    daily
    rotate 30
    compress
    sharedscripts
    postrotate
        # 重启所有Web服务
        for service in nginx apache2; do
            if systemctl is-active --quiet $service; then
                systemctl reload $service
            fi
        done
    endscript
}

# 数据库组
/var/log/mysql/*.log /var/log/postgresql/*.log {
    weekly
    rotate 4
    compress
    missingok
    # 每个服务单独处理，不使用sharedscripts
}
```

---

## 7. 🔗 符号链接处理


### 7.1 符号链接的处理方式


**符号链接问题说明**：
```
原始情况：
/var/log/app.log → /data/logs/app.log (符号链接)

默认轮转行为：
1. 移动 /var/log/app.log 到 /var/log/app.log.1
2. 创建新的 /var/log/app.log 文件
3. 结果：符号链接变成了普通文件！

问题：应用程序可能还在写入 /data/logs/app.log
```

### 7.2 符号链接配置选项


**copytruncate方式**：
```bash
# 保持符号链接不变
/var/log/app.log {
    daily
    rotate 7
    copytruncate    # 复制内容后清空，保持符号链接
    compress
    notifempty
}
```

**copy方式**：
```bash
# 复制文件内容，保留原文件
/var/log/app.log {
    daily
    rotate 7
    copy           # 只复制，不删除原文件
    compress
    notifempty
}
```

### 7.3 复杂符号链接场景


**多层符号链接**：
```bash
# 场景：/var/log/app.log → /current/app.log → /data/2024/app.log

# 解决方案：使用绝对路径
/data/2024/app.log {
    daily
    rotate 7
    copytruncate
    compress
    create 0644 app app
}
```

**动态符号链接**：
```bash
# 符号链接目标会变化的情况
prerotate
    # 解析符号链接的真实路径
    REAL_PATH=$(readlink -f /var/log/app.log)
    echo "Rotating real file: $REAL_PATH" >> /var/log/logrotate.log
endscript
```

---

## 8. 🔐 SELinux上下文保持


### 8.1 SELinux基础概念


**什么是SELinux上下文**：
- SELinux为每个文件分配安全标签
- 包含用户、角色、类型、级别信息
- 轮转时需要保持正确的安全上下文

```bash
# 查看文件的SELinux上下文
ls -Z /var/log/nginx/access.log
# -rw-r--r--. nginx nginx unconfined_u:object_r:httpd_log_t:s0 access.log
```

### 8.2 上下文保持配置


**自动保持上下文**：
```bash
# /etc/logrotate.d/nginx-selinux
/var/log/nginx/*.log {
    daily
    rotate 30
    compress
    missingok
    notifempty
    
    # 保持SELinux上下文
    su nginx nginx
    create 0640 nginx nginx
    
    postrotate
        # 确保新文件有正确的SELinux上下文
        /sbin/restorecon /var/log/nginx/*.log
        /bin/kill -USR1 `cat /var/run/nginx.pid 2>/dev/null` 2>/dev/null || true
    endscript
}
```

**手动设置上下文**：
```bash
postrotate
    # 设置特定的SELinux类型
    /usr/bin/chcon -t httpd_log_t /var/log/nginx/access.log
    
    # 或者使用semanage设置策略
    # /usr/sbin/semanage fcontext -a -t httpd_log_t "/var/log/nginx/.*\.log"
    # /sbin/restorecon /var/log/nginx/*.log
endscript
```

### 8.3 SELinux故障排除


**常见问题诊断**：
```bash
# 检查SELinux日志
grep logrotate /var/log/audit/audit.log

# 查看SELinux拒绝信息
sealert -a /var/log/audit/audit.log

# 临时关闭SELinux（仅调试用）
setenforce 0
# 恢复SELinux
setenforce 1
```

**配置文件模板**：
```bash
# /etc/logrotate.d/selinux-safe-app
/var/log/myapp/*.log {
    daily
    rotate 14
    compress
    missingok
    notifempty
    su myapp myapp
    create 0640 myapp myapp
    
    postrotate
        # 恢复默认SELinux上下文
        /sbin/restorecon -R /var/log/myapp/
        
        # 重启服务
        /bin/systemctl reload myapp || true
    endscript
}
```

---

## 9. ⚡ 轮转性能优化


### 9.1 性能影响因素


**影响性能的主要因素**：

```
性能瓶颈分析：
┌─────────────────────────────────────────┐
│ CPU使用: 压缩操作占用CPU资源              │
│ 磁盘I/O: 大文件读写影响磁盘性能          │
│ 内存使用: 大文件复制需要内存缓冲区        │
│ 网络I/O: 远程备份占用网络带宽            │
└─────────────────────────────────────────┘
```

### 9.2 压缩优化


**压缩算法选择**：
```bash
# 默认gzip压缩
/var/log/app.log {
    daily
    compress
    # 默认使用gzip，平衡压缩率和速度
}

# 使用其他压缩算法
/var/log/app.log {
    daily
    compress
    compresscmd /usr/bin/xz        # 更高压缩率，更慢
    compressext .xz
}

# 延迟压缩（推荐）
/var/log/app.log {
    daily
    compress
    delaycompress    # 下次轮转时才压缩，避免峰值负载
}
```

### 9.3 I/O优化


**减少磁盘I/O操作**：
```bash
# 避免不必要的文件操作
/var/log/app.log {
    daily
    rotate 7
    
    # 空文件不处理
    notifempty
    
    # 文件不存在不报错
    missingok
    
    # 使用copytruncate减少文件移动
    copytruncate
    
    # 延迟压缩分散I/O负载
    delaycompress
}
```

**批量处理优化**：
```bash
# 多个小文件合并处理
/var/log/app1/*.log /var/log/app2/*.log /var/log/app3/*.log {
    daily
    rotate 7
    compress
    sharedscripts    # 共享脚本，减少重复操作
    
    postrotate
        # 批量重启所有相关服务
        systemctl reload app1 app2 app3
    endscript
}
```

### 9.4 时间调度优化


**避开业务高峰期**：
```bash
# 在系统负载较低时执行
# 修改cron任务时间
# 默认: 6:25 每天执行
# 优化: 2:00 执行，避开备份时间

# /etc/cron.daily/logrotate 改为手动cron
# 0 2 * * * /usr/sbin/logrotate /etc/logrotate.conf
```

**分散执行时间**：
```bash
# 大文件单独处理
# /etc/logrotate.d/large-files - 在不同时间执行
0 1 * * * /usr/sbin/logrotate /etc/logrotate.d/large-files

# 普通文件正常时间处理
0 2 * * * /usr/sbin/logrotate /etc/logrotate.conf
```

### 9.5 监控和调优


**性能监控脚本**：
```bash
#!/bin/bash
# /usr/local/bin/logrotate-monitor.sh

# 记录开始时间
start_time=$(date +%s)

# 执行logrotate
/usr/sbin/logrotate -v /etc/logrotate.conf > /var/log/logrotate-perf.log 2>&1

# 记录结束时间
end_time=$(date +%s)
duration=$((end_time - start_time))

# 记录性能数据
echo "$(date): Logrotate completed in ${duration} seconds" >> /var/log/logrotate-timing.log

# 如果执行时间过长，发送告警
if [ $duration -gt 300 ]; then
    echo "Logrotate took ${duration} seconds - consider optimization" | \
    mail -s "Logrotate Performance Warning" admin@company.com
fi
```

---

## 10. 📋 核心要点总结


### 10.1 必须掌握的核心概念


```
🔸 logrotate作用：自动管理日志文件，防止磁盘空间耗尽
🔸 轮转流程：预处理 → 轮转 → 压缩 → 后处理 → 清理
🔸 配置结构：全局配置 + 服务专用配置
🔸 脚本应用：prerotate准备工作，postrotate收尾工作
🔸 特殊处理：符号链接、SELinux、多文件、性能优化
```

### 10.2 关键配置选项对比


| 选项 | **作用** | **适用场景** | **注意事项** |
|------|---------|-------------|-------------|
| `copytruncate` | `复制后清空原文件` | `进程持续写入` | `可能丢失数据` |
| `create` | `创建新文件` | `进程可重新打开` | `需要权限设置` |
| `compress` | `压缩历史文件` | `节省磁盘空间` | `消耗CPU资源` |
| `delaycompress` | `延迟压缩` | `分散系统负载` | `需要额外空间` |
| `sharedscripts` | `共享脚本执行` | `多文件轮转` | `减少重复操作` |

### 10.3 最佳实践指导


**配置文件最佳实践**：
```bash
# 推荐的通用配置模板
/var/log/myapp/*.log {
    daily                    # 每天轮转
    rotate 30               # 保留30天
    compress                # 压缩节省空间
    delaycompress          # 延迟压缩提升性能
    missingok              # 容错处理
    notifempty             # 跳过空文件
    create 0640 app app    # 安全的权限设置
    
    prerotate
        # 检查服务状态
        systemctl is-active --quiet myapp || exit 1
    endscript
    
    postrotate
        # 优雅重启
        systemctl reload myapp || true
    endscript
}
```

**故障排除检查清单**：
```
□ 检查文件权限和所有者
□ 验证磁盘空间是否充足
□ 确认服务状态和进程PID
□ 测试配置文件语法
□ 查看logrotate执行日志
□ 检查SELinux上下文（如果启用）
```

### 10.4 性能优化建议


**🔹 优化策略**：
- **时间分散**：避开业务高峰期执行轮转
- **批量处理**：相关服务使用sharedscripts
- **延迟压缩**：使用delaycompress分散CPU负载
- **容量规划**：根据日志增长率设置合理的轮转策略

**🔹 监控指标**：
- 轮转执行时间和成功率
- 磁盘空间使用情况
- 服务重启对业务的影响
- 压缩率和存储成本

### 10.5 常见问题解决


**权限问题**：
```bash
# 使用su指定执行用户
su username username

# 在脚本中使用sudo
sudo -u username command
```

**进程占用**：
```bash
# 方案1：copytruncate
copytruncate

# 方案2：优雅停止
prerotate
    systemctl stop service
endscript
postrotate
    systemctl start service
endscript
```

**SELinux问题**：
```bash
# 恢复默认上下文
postrotate
    /sbin/restorecon /var/log/app/*.log
endscript
```

### 10.6 实际应用价值


- **系统维护**：自动化日志管理，减少手工操作
- **空间管理**：防止日志文件占满磁盘空间
- **性能优化**：通过压缩和清理提升系统性能
- **监控集成**：配合监控系统实现日志轮转状态监控
- **合规要求**：满足日志保留期限的合规性要求

**核心记忆口诀**：
- logrotate管日志，轮转压缩自动化
- 预处理做准备，后处理来收尾
- 权限链接要注意，性能优化分时段
- 监控告警不可少，故障排除有方法