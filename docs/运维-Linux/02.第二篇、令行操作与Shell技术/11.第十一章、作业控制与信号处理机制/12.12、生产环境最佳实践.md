---
title: 12ã€ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ
---
## ğŸ“š ç›®å½•

1. [æœåŠ¡è¿›ç¨‹ä¿¡å·å¤„ç†ç­–ç•¥](#1-æœåŠ¡è¿›ç¨‹ä¿¡å·å¤„ç†ç­–ç•¥)
2. [ä¼˜é›…é‡å¯å®ç°æ–¹æ¡ˆ](#2-ä¼˜é›…é‡å¯å®ç°æ–¹æ¡ˆ)
3. [ä¿¡å·å¤„ç†å®‰å…¨ç¼–ç¨‹](#3-ä¿¡å·å¤„ç†å®‰å…¨ç¼–ç¨‹)
4. [ä½œä¸šæ§åˆ¶å®‰å…¨è€ƒè™‘](#4-ä½œä¸šæ§åˆ¶å®‰å…¨è€ƒè™‘)
5. [ç›‘æ§è„šæœ¬ä¿¡å·å¤„ç†](#5-ç›‘æ§è„šæœ¬ä¿¡å·å¤„ç†)
6. [å®¹å™¨ç¯å¢ƒä¿¡å·ä¼ é€’](#6-å®¹å™¨ç¯å¢ƒä¿¡å·ä¼ é€’)
7. [ç³»ç»ŸæœåŠ¡ä¿¡å·é…ç½®](#7-ç³»ç»ŸæœåŠ¡ä¿¡å·é…ç½®)
8. [ä¿¡å·å¤„ç†æ€§èƒ½ä¼˜åŒ–](#8-ä¿¡å·å¤„ç†æ€§èƒ½ä¼˜åŒ–)
9. [æ ¸å¿ƒè¦ç‚¹æ€»ç»“](#9-æ ¸å¿ƒè¦ç‚¹æ€»ç»“)

---

## 1. ğŸ”§ æœåŠ¡è¿›ç¨‹ä¿¡å·å¤„ç†ç­–ç•¥


### 1.1 ä¿¡å·å¤„ç†åŸºæœ¬åŸç†


**ä»€ä¹ˆæ˜¯ä¿¡å·ï¼Ÿ**
```
ä¿¡å·å°±æ˜¯ç³»ç»Ÿç»™è¿›ç¨‹å‘é€çš„"é€šçŸ¥æ¶ˆæ¯"ï¼Œå‘Šè¯‰è¿›ç¨‹å‘ç”Ÿäº†ä»€ä¹ˆäº‹æƒ…ã€‚
æ¯”å¦‚ç”¨æˆ·æŒ‰Ctrl+Cï¼Œç³»ç»Ÿå°±ç»™è¿›ç¨‹å‘SIGINTä¿¡å·ï¼Œæ„æ€æ˜¯"è¯·ç»ˆæ­¢è¿è¡Œ"ã€‚

å¸¸è§ä¿¡å·å«ä¹‰ï¼š
SIGTERM (15) = "è¯·ä½ æ­£å¸¸é€€å‡º"ï¼ˆç¤¼è²Œçš„ç»ˆæ­¢è¯·æ±‚ï¼‰
SIGKILL (9)  = "ç«‹å³å¼ºåˆ¶é€€å‡º"ï¼ˆæ— æ³•æ‹’ç»çš„æ€æ­»å‘½ä»¤ï¼‰
SIGHUP (1)   = "é‡æ–°åŠ è½½é…ç½®"ï¼ˆæŒ‚èµ·ä¿¡å·ï¼Œå¸¸ç”¨äºé…ç½®é‡è½½ï¼‰
SIGINT (2)   = "ç”¨æˆ·ä¸­æ–­"ï¼ˆCtrl+Cäº§ç”Ÿçš„ä¿¡å·ï¼‰
```

**ä¸ºä»€ä¹ˆéœ€è¦å¤„ç†ä¿¡å·ï¼Ÿ**
æœåŠ¡è¿›ç¨‹éœ€è¦ä¼˜é›…åœ°å“åº”å¤–éƒ¨è¯·æ±‚ï¼Œè€Œä¸æ˜¯çªç„¶æ­»æ‰ï¼š
- **æ­£å¸¸å…³é—­**ï¼šä¿å­˜æ•°æ®ã€å…³é—­è¿æ¥ã€æ¸…ç†èµ„æº
- **é…ç½®é‡è½½**ï¼šä¸é‡å¯æœåŠ¡å°±æ›´æ–°é…ç½®
- **çŠ¶æ€æŠ¥å‘Š**ï¼šå“åº”ç›‘æ§ç³»ç»Ÿçš„æŸ¥è¯¢

### 1.2 æœåŠ¡ä¿¡å·å¤„ç†æ¶æ„


```
ä¿¡å·å¤„ç†æµç¨‹å›¾ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¤–éƒ¨ä¿¡å·æº   â”‚â”€â”€â”€â–¶â”‚ ä¿¡å·å¤„ç†å™¨   â”‚â”€â”€â”€â–¶â”‚ ä¸šåŠ¡é€»è¾‘     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                    â”‚                   â”‚
   ç³»ç»Ÿç®¡ç†              ä¿¡å·æ•è·            ä¼˜é›…å¤„ç†
   ç”¨æˆ·æ“ä½œ              å®‰å…¨æ£€æŸ¥            èµ„æºæ¸…ç†
   ç›‘æ§ç³»ç»Ÿ              æ—¥å¿—è®°å½•            çŠ¶æ€ä¿å­˜
```

**æ ¸å¿ƒå¤„ç†ç­–ç•¥**ï¼š
```bash
#!/bin/bash
# ğŸ“ service-daemon.sh - æœåŠ¡è¿›ç¨‹æ¨¡æ¿

# å…¨å±€å˜é‡
RUNNING=true
PID_FILE="/var/run/myservice.pid"
LOG_FILE="/var/log/myservice.log"

# ä¿¡å·å¤„ç†å‡½æ•°
handle_term() {
    echo "$(date): æ”¶åˆ°SIGTERMï¼Œå¼€å§‹ä¼˜é›…å…³é—­..." >> $LOG_FILE
    RUNNING=false
    # æ‰§è¡Œæ¸…ç†å·¥ä½œ
    cleanup_resources
    exit 0
}

handle_hup() {
    echo "$(date): æ”¶åˆ°SIGHUPï¼Œé‡æ–°åŠ è½½é…ç½®..." >> $LOG_FILE
    reload_config
}

# è®¾ç½®ä¿¡å·å¤„ç†å™¨
trap handle_term TERM INT
trap handle_hup HUP

# ä¸»æœåŠ¡å¾ªç¯
main_service() {
    echo $$ > $PID_FILE
    
    while $RUNNING; do
        # æ‰§è¡Œä¸»è¦ä¸šåŠ¡é€»è¾‘
        process_business_logic
        sleep 1
    done
}
```

### 1.3 ä¿¡å·ä¼˜å…ˆçº§ä¸å¤„ç†æ—¶æœº


**ä¿¡å·å¤„ç†ä¼˜å…ˆçº§è¡¨**ï¼š
| ä¿¡å·ç±»å‹ | **ä¼˜å…ˆçº§** | **å¤„ç†æ–¹å¼** | **å…¸å‹åº”ç”¨** |
|---------|-----------|-------------|-------------|
| `SIGKILL (9)` | `æœ€é«˜` | `æ— æ³•æ•è·ï¼Œç«‹å³ç»ˆæ­¢` | `å¼ºåˆ¶æ€æ­»å¤±æ§è¿›ç¨‹` |
| `SIGSTOP` | `æœ€é«˜` | `æ— æ³•æ•è·ï¼Œç«‹å³æš‚åœ` | `è°ƒè¯•å’Œæ•…éšœæ’æŸ¥` |
| `SIGTERM (15)` | `é«˜` | `å¯æ•è·ï¼Œä¼˜é›…é€€å‡º` | `æ­£å¸¸æœåŠ¡å…³é—­` |
| `SIGINT (2)` | `ä¸­` | `å¯æ•è·ï¼Œç”¨æˆ·ä¸­æ–­` | `å‰å°ç¨‹åºç»ˆæ­¢` |
| `SIGHUP (1)` | `ä¸­` | `å¯æ•è·ï¼Œé…ç½®é‡è½½` | `æœåŠ¡é…ç½®æ›´æ–°` |
| `SIGUSR1/USR2` | `ä½` | `å¯æ•è·ï¼Œç”¨æˆ·è‡ªå®šä¹‰` | `çŠ¶æ€æŠ¥å‘Šã€è°ƒè¯•` |

> ğŸ’¡ **ç†è§£è¦ç‚¹**ï¼šä¿¡å·ä¸æ˜¯ç«‹å³å¤„ç†çš„ï¼Œè€Œæ˜¯åœ¨è¿›ç¨‹åˆé€‚çš„æ—¶å€™ï¼ˆå¦‚ç³»ç»Ÿè°ƒç”¨è¿”å›æ—¶ï¼‰å¤„ç†ã€‚

---

## 2. ğŸ”„ ä¼˜é›…é‡å¯å®ç°æ–¹æ¡ˆ


### 2.1 ä»€ä¹ˆæ˜¯ä¼˜é›…é‡å¯ï¼Ÿ


**ä¼˜é›…é‡å¯çš„å«ä¹‰**ï¼š
- ä¸ä¸¢å¤±æ­£åœ¨å¤„ç†çš„è¯·æ±‚
- ä¸ä¸­æ–­ç”¨æˆ·çš„è¿æ¥
- å¹³æ»‘è¿‡æ¸¡åˆ°æ–°ç‰ˆæœ¬
- ä¿æŒæœåŠ¡å¯ç”¨æ€§

**ä¸å¼ºåˆ¶é‡å¯çš„å¯¹æ¯”**ï¼š
```
å¼ºåˆ¶é‡å¯ï¼ˆä¸æ¨èï¼‰ï¼š
æ—§è¿›ç¨‹ â”€â”€Xâ”€â”€  [æœåŠ¡ä¸­æ–­]  â”€â”€â–¶ æ–°è¿›ç¨‹

ä¼˜é›…é‡å¯ï¼ˆæ¨èï¼‰ï¼š
æ—§è¿›ç¨‹ â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”œâ”€â”€ [æ— ç¼åˆ‡æ¢] â”€â”€â–¶ æœåŠ¡ç»§ç»­
æ–°è¿›ç¨‹ â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 é›¶åœæœºé‡å¯ç­–ç•¥


**æ–¹æ¡ˆ1ï¼šçƒ­æ›¿æ¢æ¨¡å¼**
```bash
#!/bin/bash
# ğŸ“ graceful-restart.sh

SERVICE_NAME="myapp"
OLD_PID=$(cat /var/run/$SERVICE_NAME.pid)

# æ­¥éª¤1ï¼šå¯åŠ¨æ–°è¿›ç¨‹
echo "å¯åŠ¨æ–°æœåŠ¡è¿›ç¨‹..."
./start-new-service.sh

# æ­¥éª¤2ï¼šç­‰å¾…æ–°è¿›ç¨‹å‡†å¤‡å°±ç»ª
wait_for_ready() {
    for i in {1..30}; do
        if curl -s http://localhost:8080/health > /dev/null; then
            echo "æ–°æœåŠ¡å·²å°±ç»ª"
            return 0
        fi
        sleep 1
    done
    echo "æ–°æœåŠ¡å¯åŠ¨å¤±è´¥"
    return 1
}

if wait_for_ready; then
    # æ­¥éª¤3ï¼šé€šçŸ¥æ—§è¿›ç¨‹ä¼˜é›…é€€å‡º
    echo "é€šçŸ¥æ—§è¿›ç¨‹é€€å‡º..."
    kill -TERM $OLD_PID
    
    # æ­¥éª¤4ï¼šç­‰å¾…æ—§è¿›ç¨‹å®Œå…¨é€€å‡º
    while kill -0 $OLD_PID 2>/dev/null; do
        sleep 0.5
    done
    
    echo "é‡å¯å®Œæˆ"
else
    echo "é‡å¯å¤±è´¥ï¼Œå›æ»š..."
    pkill -f new-service
fi
```

**æ–¹æ¡ˆ2ï¼šè“ç»¿éƒ¨ç½²æ¨¡å¼**
```
è´Ÿè½½å‡è¡¡å™¨æ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æµé‡è¯·æ±‚     â”‚â”€â”€â”€â–¶â”‚ è´Ÿè½½å‡è¡¡å™¨   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼          â–¼          â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ è“è‰²ç¯å¢ƒ â”‚ â”‚ ç»¿è‰²ç¯å¢ƒ â”‚ â”‚ ç°è‰²ç¯å¢ƒ â”‚
        â”‚ (å½“å‰)  â”‚ â”‚ (æ–°ç‰ˆæœ¬) â”‚ â”‚ (å¤‡ç”¨)  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 é…ç½®çƒ­é‡è½½å®ç°


**é…ç½®æ–‡ä»¶ç›‘æ§è„šæœ¬**ï¼š
```bash
#!/bin/bash
# ğŸ“ config-monitor.sh

CONFIG_FILE="/etc/myapp/config.yaml"
SERVICE_PID=$(cat /var/run/myapp.pid)

# ä½¿ç”¨inotifyç›‘æ§é…ç½®æ–‡ä»¶å˜åŒ–
monitor_config() {
    inotifywait -m -e modify $CONFIG_FILE |
    while read path action file; do
        echo "æ£€æµ‹åˆ°é…ç½®æ–‡ä»¶å˜æ›´: $file"
        
        # éªŒè¯é…ç½®æ–‡ä»¶æ ¼å¼
        if validate_config $CONFIG_FILE; then
            echo "é…ç½®éªŒè¯é€šè¿‡ï¼Œå‘é€é‡è½½ä¿¡å·"
            kill -HUP $SERVICE_PID
        else
            echo "é…ç½®æ ¼å¼é”™è¯¯ï¼Œå¿½ç•¥æ­¤æ¬¡å˜æ›´"
        fi
    done
}

validate_config() {
    # ä½¿ç”¨ä¸“ç”¨å·¥å…·éªŒè¯é…ç½®æ ¼å¼
    yamllint $1 && myapp --check-config $1
}
```

---

## 3. ğŸ”’ ä¿¡å·å¤„ç†å®‰å…¨ç¼–ç¨‹


### 3.1 ä¿¡å·å®‰å…¨å‡½æ•°


**ä»€ä¹ˆæ˜¯ä¿¡å·å®‰å…¨ï¼Ÿ**
ä¿¡å·å¤„ç†å‡½æ•°åœ¨æ‰§è¡Œæ—¶ï¼Œä¸»ç¨‹åºå¯èƒ½æ­£åœ¨æ‰§è¡Œä»»ä½•ä»£ç ã€‚å¦‚æœä¿¡å·å¤„ç†å‡½æ•°è°ƒç”¨äº†ä¸å®‰å…¨çš„å‡½æ•°ï¼Œå°±å¯èƒ½å¯¼è‡´æ•°æ®æŸåæˆ–ç¨‹åºå´©æºƒã€‚

**ä¿¡å·å®‰å…¨å‡½æ•°åˆ—è¡¨**ï¼š
```
âœ… å®‰å…¨å‡½æ•°ï¼ˆå¯åœ¨ä¿¡å·å¤„ç†å™¨ä¸­ä½¿ç”¨ï¼‰ï¼š
- write()     # å†™æ–‡ä»¶
- open()      # æ‰“å¼€æ–‡ä»¶
- close()     # å…³é—­æ–‡ä»¶
- _exit()     # ç«‹å³é€€å‡º
- signal()    # è®¾ç½®ä¿¡å·å¤„ç†
- kill()      # å‘é€ä¿¡å·

âŒ ä¸å®‰å…¨å‡½æ•°ï¼ˆä¸èƒ½åœ¨ä¿¡å·å¤„ç†å™¨ä¸­ä½¿ç”¨ï¼‰ï¼š
- printf()    # æ ¼å¼åŒ–è¾“å‡º
- malloc()    # å†…å­˜åˆ†é…
- free()      # å†…å­˜é‡Šæ”¾
- fopen()     # æ–‡ä»¶æ“ä½œ
- pthread_*() # çº¿ç¨‹å‡½æ•°
```

### 3.2 å®‰å…¨çš„ä¿¡å·å¤„ç†æ¨¡å¼


**æ¨¡å¼1ï¼šæœ€å°åŒ–å¤„ç†å™¨**
```c
// ğŸ“ safe-signal-handler.c
#include <signal.h>
#include <unistd.h>

volatile sig_atomic_t got_signal = 0;  // åŸå­å˜é‡

// ä¿¡å·å¤„ç†å™¨åªè®¾ç½®æ ‡å¿—
void signal_handler(int sig) {
    got_signal = sig;  // ä»…è®¾ç½®æ ‡å¿—ä½
}

int main() {
    signal(SIGTERM, signal_handler);
    
    while (1) {
        // åœ¨ä¸»å¾ªç¯ä¸­æ£€æŸ¥ä¿¡å·æ ‡å¿—
        if (got_signal) {
            handle_signal_safely(got_signal);
            got_signal = 0;
        }
        
        // æ­£å¸¸ä¸šåŠ¡é€»è¾‘
        do_work();
    }
}
```

**æ¨¡å¼2ï¼šè‡ªç®¡é“æŠ€æœ¯**
```bash
#!/bin/bash
# ğŸ“ self-pipe-pattern.sh

# åˆ›å»ºç®¡é“ç”¨äºä¿¡å·é€šä¿¡
mkfifo /tmp/signal_pipe

# ä¿¡å·å¤„ç†å‡½æ•°
handle_signal() {
    echo "$1" > /tmp/signal_pipe &  # å¼‚æ­¥å†™å…¥
}

# è®¾ç½®ä¿¡å·å¤„ç†
trap 'handle_signal TERM' TERM
trap 'handle_signal HUP' HUP

# ä¸»å¾ªç¯
while true; do
    # ä½¿ç”¨selectç›‘å¬ç®¡é“ï¼ˆéé˜»å¡ï¼‰
    if read -t 0.1 signal < /tmp/signal_pipe 2>/dev/null; then
        case $signal in
            TERM)
                echo "å¤„ç†TERMä¿¡å·"
                cleanup_and_exit
                ;;
            HUP)
                echo "å¤„ç†HUPä¿¡å·"
                reload_config
                ;;
        esac
    fi
    
    # æ­£å¸¸ä¸šåŠ¡å¤„ç†
    process_business_logic
done
```

### 3.3 ç«æ€æ¡ä»¶é˜²æŠ¤


**ä»€ä¹ˆæ˜¯ç«æ€æ¡ä»¶ï¼Ÿ**
å¤šä¸ªæ‰§è¡Œæµç¨‹ï¼ˆè¿›ç¨‹ã€çº¿ç¨‹ã€ä¿¡å·ï¼‰è®¿é—®å…±äº«èµ„æºæ—¶ï¼Œç»“æœä¾èµ–äºæ‰§è¡Œæ—¶åºçš„ä¸ç¡®å®šæ€§ã€‚

**é˜²æŠ¤ç­–ç•¥**ï¼š
```bash
#!/bin/bash
# ğŸ“ race-condition-safe.sh

LOCK_FILE="/var/lock/myservice.lock"
PROCESSING=false

# åŸå­æ“ä½œå‡½æ•°
atomic_start_processing() {
    # ä½¿ç”¨flockç¡®ä¿åŸå­æ€§
    (
        flock -n 200 || return 1
        PROCESSING=true
        echo $$ > $LOCK_FILE
        return 0
    ) 200>$LOCK_FILE
}

atomic_stop_processing() {
    (
        flock -n 200 || return 1
        PROCESSING=false
        rm -f $LOCK_FILE
    ) 200>$LOCK_FILE
}

# å®‰å…¨çš„ä¿¡å·å¤„ç†
safe_signal_handler() {
    if atomic_start_processing; then
        # æ‰§è¡Œå…³é”®æ“ä½œ
        perform_critical_operation
        atomic_stop_processing
    fi
}
```

---

## 4. ğŸ›¡ï¸ ä½œä¸šæ§åˆ¶å®‰å…¨è€ƒè™‘


### 4.1 ä½œä¸šæ§åˆ¶å®‰å…¨é£é™©


**ä»€ä¹ˆæ˜¯ä½œä¸šæ§åˆ¶ï¼Ÿ**
ä½œä¸šæ§åˆ¶æ˜¯shellæä¾›çš„åŠŸèƒ½ï¼Œè®©ç”¨æˆ·å¯ä»¥ï¼š
- æš‚åœæ­£åœ¨è¿è¡Œçš„ç¨‹åº (`Ctrl+Z`)
- æŠŠç¨‹åºæ”¾åˆ°åå°è¿è¡Œ (`&`, `bg`)
- æŠŠåå°ç¨‹åºè°ƒåˆ°å‰å° (`fg`)
- æŸ¥çœ‹ä½œä¸šçŠ¶æ€ (`jobs`)

**æ½œåœ¨å®‰å…¨é£é™©**ï¼š
```
é£é™©ç±»å‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æƒé™æå‡é£é™©     â”‚ â† åå°è¿›ç¨‹å¯èƒ½è·å¾—ä¸å½“æƒé™
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ èµ„æºæ³„æ¼é£é™©     â”‚ â† è¢«é—å¿˜çš„åå°è¿›ç¨‹æ¶ˆè€—èµ„æº  
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ•°æ®æ³„æ¼é£é™©     â”‚ â† åå°è¿›ç¨‹å¯èƒ½è®¿é—®æ•æ„Ÿæ•°æ®
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  
â”‚ ä¼šè¯åŠ«æŒé£é™©     â”‚ â† æ¶æ„è¿›ç¨‹å¯èƒ½åŠ«æŒç”¨æˆ·ä¼šè¯
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 å®‰å…¨çš„åå°ä»»åŠ¡ç®¡ç†


**å®‰å…¨å¯åŠ¨åå°ä»»åŠ¡**ï¼š
```bash
#!/bin/bash
# ğŸ“ secure-background-job.sh

# å®‰å…¨çš„åå°ä»»åŠ¡å¯åŠ¨å‡½æ•°
start_secure_background_job() {
    local job_name=$1
    local job_script=$2
    local user=$3
    
    # è¾“å…¥éªŒè¯
    if [[ ! -f "$job_script" ]]; then
        echo "é”™è¯¯ï¼šä»»åŠ¡è„šæœ¬ä¸å­˜åœ¨"
        return 1
    fi
    
    # æƒé™æ£€æŸ¥
    if [[ ! -x "$job_script" ]]; then
        echo "é”™è¯¯ï¼šä»»åŠ¡è„šæœ¬ä¸å¯æ‰§è¡Œ"
        return 1
    fi
    
    # åˆ›å»ºå®‰å…¨çš„å·¥ä½œç›®å½•
    local work_dir="/tmp/secure_jobs/$job_name"
    mkdir -p "$work_dir"
    chmod 700 "$work_dir"
    
    # è®¾ç½®ç¯å¢ƒå˜é‡é™åˆ¶
    env -i \
        PATH="/bin:/usr/bin" \
        HOME="$work_dir" \
        USER="$user" \
        nohup "$job_script" > "$work_dir/output.log" 2>&1 &
    
    local job_pid=$!
    
    # è®°å½•ä½œä¸šä¿¡æ¯
    echo "$job_pid:$job_name:$(date)" >> /var/log/background_jobs.log
    
    echo "åå°ä»»åŠ¡å¯åŠ¨ï¼šPID=$job_pid, åç§°=$job_name"
}
```

**ä½œä¸šçŠ¶æ€ç›‘æ§**ï¼š
```bash
#!/bin/bash
# ğŸ“ job-monitor.sh

# ç›‘æ§åå°ä½œä¸šçŠ¶æ€
monitor_background_jobs() {
    echo "å½“å‰åå°ä½œä¸šçŠ¶æ€ï¼š"
    echo "PID      NAME         STATUS    CPU%    MEM%    TIME"
    echo "----------------------------------------------------"
    
    while IFS=':' read -r pid name start_time; do
        if kill -0 "$pid" 2>/dev/null; then
            # è·å–è¿›ç¨‹èµ„æºä½¿ç”¨æƒ…å†µ
            local stats=$(ps -o pid,comm,stat,pcpu,pmem,time --no-headers -p "$pid")
            echo "$stats"
        else
            echo "$pid     $name         DEAD      -       -       -"
        fi
    done < /var/log/background_jobs.log
}

# æ¸…ç†åƒµå°¸ä½œä¸š
cleanup_dead_jobs() {
    local temp_file=$(mktemp)
    
    while IFS=':' read -r pid name start_time; do
        if kill -0 "$pid" 2>/dev/null; then
            echo "$pid:$name:$start_time" >> "$temp_file"
        else
            echo "æ¸…ç†åƒµå°¸ä½œä¸šï¼š$name (PID=$pid)"
        fi
    done < /var/log/background_jobs.log
    
    mv "$temp_file" /var/log/background_jobs.log
}
```

### 4.3 ä¼šè¯ç®¡ç†å®‰å…¨


**å®‰å…¨çš„ä¼šè¯éš”ç¦»**ï¼š
```bash
#!/bin/bash
# ğŸ“ session-security.sh

# åˆ›å»ºéš”ç¦»çš„å·¥ä½œä¼šè¯
create_isolated_session() {
    local session_name=$1
    local user=$2
    
    # åˆ›å»ºæ–°çš„è¿›ç¨‹ç»„
    setsid bash -c "
        # è®¾ç½®å®‰å…¨çš„umask
        umask 077
        
        # é™åˆ¶æ–‡ä»¶æè¿°ç¬¦
        ulimit -n 1024
        
        # é™åˆ¶è¿›ç¨‹æ•°é‡
        ulimit -u 100
        
        # è®¾ç½®å·¥ä½œç›®å½•
        cd /tmp/sessions/$session_name || exit 1
        
        # æ‰§è¡Œä¼šè¯ä»»åŠ¡
        exec $3
    " &
    
    local session_pid=$!
    echo "éš”ç¦»ä¼šè¯åˆ›å»ºï¼š$session_name (PID=$session_pid)"
    
    # è®¾ç½®ä¼šè¯è¶…æ—¶
    (
        sleep 3600  # 1å°æ—¶åè‡ªåŠ¨æ¸…ç†
        if kill -0 "$session_pid" 2>/dev/null; then
            echo "ä¼šè¯è¶…æ—¶ï¼Œå¼ºåˆ¶ç»ˆæ­¢ï¼š$session_name"
            kill -TERM "$session_pid"
        fi
    ) &
}
```

---

## 5. ğŸ“Š ç›‘æ§è„šæœ¬ä¿¡å·å¤„ç†


### 5.1 ç›‘æ§è„šæœ¬æ¶æ„è®¾è®¡


**ç›‘æ§è„šæœ¬çš„ä½œç”¨**ï¼š
- **å¥åº·æ£€æŸ¥**ï¼šå®šæœŸæ£€æŸ¥æœåŠ¡çŠ¶æ€
- **æ€§èƒ½ç›‘æ§**ï¼šæ”¶é›†ç³»ç»Ÿæ€§èƒ½æ•°æ®
- **å‘Šè­¦å¤„ç†**ï¼šå‘ç°é—®é¢˜æ—¶åŠæ—¶é€šçŸ¥
- **è‡ªåŠ¨æ¢å¤**ï¼šå°è¯•ä¿®å¤å¸¸è§é—®é¢˜

**ç›‘æ§è„šæœ¬ä¿¡å·å¤„ç†æ¶æ„**ï¼š
```
ç›‘æ§è„šæœ¬ä¿¡å·å¤„ç†æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¿¡å·æ¥æ”¶     â”‚â”€â”€â”€â–¶â”‚ ä¼˜å…ˆçº§åˆ¤æ–­   â”‚â”€â”€â”€â–¶â”‚ å¤„ç†æ‰§è¡Œ     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                    â”‚                   â”‚
  SIGTERM é€€å‡º          ç´§æ€¥ä¿¡å·ä¼˜å…ˆ        çŠ¶æ€ä¿å­˜
  SIGHUP é‡è½½           æ™®é€šä¿¡å·æ’é˜Ÿ        æ—¥å¿—è®°å½•
  SIGUSR1 æŠ¥å‘Š          èµ„æºæ£€æŸ¥           é€šçŸ¥å‘é€
```

### 5.2 å¥å£®çš„ç›‘æ§è„šæœ¬å®ç°


```bash
#!/bin/bash
# ğŸ“ robust-monitor.sh - ç”Ÿäº§çº§ç›‘æ§è„šæœ¬

# å…¨å±€é…ç½®
MONITOR_NAME="system-monitor"
PID_FILE="/var/run/$MONITOR_NAME.pid"
LOG_FILE="/var/log/$MONITOR_NAME.log"
CONFIG_FILE="/etc/$MONITOR_NAME.conf"
RUNNING=true

# æ—¥å¿—å‡½æ•°
log_message() {
    local level=$1
    shift
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [$level] $*" >> $LOG_FILE
}

# é…ç½®åŠ è½½
load_config() {
    if [[ -f "$CONFIG_FILE" ]]; then
        source "$CONFIG_FILE"
        log_message "INFO" "é…ç½®æ–‡ä»¶å·²åŠ è½½"
    else
        log_message "WARN" "é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤é…ç½®"
        # è®¾ç½®é»˜è®¤å€¼
        CHECK_INTERVAL=${CHECK_INTERVAL:-60}
        ALERT_EMAIL=${ALERT_EMAIL:-"admin@example.com"}
    fi
}

# ä¿¡å·å¤„ç†å‡½æ•°
handle_terminate() {
    log_message "INFO" "æ”¶åˆ°ç»ˆæ­¢ä¿¡å·ï¼Œå¼€å§‹ä¼˜é›…å…³é—­..."
    RUNNING=false
    
    # å®Œæˆå½“å‰æ£€æŸ¥
    wait_for_current_check
    
    # å‘é€æœ€åçŠ¶æ€æŠ¥å‘Š
    send_status_report "SHUTDOWN"
    
    # æ¸…ç†èµ„æº
    cleanup_resources
    
    log_message "INFO" "ç›‘æ§è„šæœ¬å·²åœæ­¢"
    exit 0
}

handle_reload() {
    log_message "INFO" "æ”¶åˆ°é‡è½½ä¿¡å·ï¼Œé‡æ–°åŠ è½½é…ç½®..."
    load_config
    log_message "INFO" "é…ç½®é‡è½½å®Œæˆ"
}

handle_status_request() {
    log_message "INFO" "æ”¶åˆ°çŠ¶æ€è¯·æ±‚ä¿¡å·"
    send_status_report "RUNNING"
}

# è®¾ç½®ä¿¡å·å¤„ç†
trap handle_terminate TERM INT
trap handle_reload HUP
trap handle_status_request USR1

# æ ¸å¿ƒç›‘æ§é€»è¾‘
perform_system_check() {
    local check_time=$(date '+%Y-%m-%d %H:%M:%S')
    
    # CPUä½¿ç”¨ç‡æ£€æŸ¥
    local cpu_usage=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | sed 's/%us,//')
    
    # å†…å­˜ä½¿ç”¨ç‡æ£€æŸ¥  
    local mem_usage=$(free | grep "Mem:" | awk '{printf "%.1f", $3/$2 * 100.0}')
    
    # ç£ç›˜ä½¿ç”¨ç‡æ£€æŸ¥
    local disk_usage=$(df -h / | awk 'NR==2{print $5}' | sed 's/%//')
    
    # è®°å½•ç›‘æ§æ•°æ®
    log_message "DATA" "CPU:${cpu_usage}% MEM:${mem_usage}% DISK:${disk_usage}%"
    
    # å‘Šè­¦æ£€æŸ¥
    check_alerts "$cpu_usage" "$mem_usage" "$disk_usage"
}

# å‘Šè­¦æ£€æŸ¥
check_alerts() {
    local cpu=$1 mem=$2 disk=$3
    
    # CPUå‘Šè­¦é˜ˆå€¼ï¼š80%
    if (( $(echo "$cpu > 80" | bc -l) )); then
        send_alert "HIGH_CPU" "CPUä½¿ç”¨ç‡: ${cpu}%"
    fi
    
    # å†…å­˜å‘Šè­¦é˜ˆå€¼ï¼š85%  
    if (( $(echo "$mem > 85" | bc -l) )); then
        send_alert "HIGH_MEMORY" "å†…å­˜ä½¿ç”¨ç‡: ${mem}%"
    fi
    
    # ç£ç›˜å‘Šè­¦é˜ˆå€¼ï¼š90%
    if (( disk > 90 )); then
        send_alert "HIGH_DISK" "ç£ç›˜ä½¿ç”¨ç‡: ${disk}%"
    fi
}

# ä¸»ç›‘æ§å¾ªç¯
main_monitor_loop() {
    log_message "INFO" "ç›‘æ§è„šæœ¬å¯åŠ¨ï¼ŒPID: $$"
    echo $$ > $PID_FILE
    
    while $RUNNING; do
        perform_system_check
        
        # å¯ä¸­æ–­çš„ç¡çœ 
        for ((i=0; i<CHECK_INTERVAL && RUNNING; i++)); do
            sleep 1
        done
    done
}

# å¯åŠ¨ç›‘æ§
load_config
main_monitor_loop
```

### 5.3 ç›‘æ§æ•°æ®çš„ä¿¡å·é©±åŠ¨æ”¶é›†


**æŒ‰éœ€æ•°æ®æ”¶é›†**ï¼š
```bash
#!/bin/bash
# ğŸ“ signal-driven-collector.sh

# æ•°æ®æ”¶é›†å™¨çŠ¶æ€
COLLECTING_DETAILED=false
COLLECTING_INTERVAL=60

# ä¿¡å·é©±åŠ¨çš„æ•°æ®æ”¶é›†
handle_detail_toggle() {
    if $COLLECTING_DETAILED; then
        COLLECTING_DETAILED=false
        log_message "INFO" "å…³é—­è¯¦ç»†æ•°æ®æ”¶é›†"
    else
        COLLECTING_DETAILED=true
        log_message "INFO" "å¼€å¯è¯¦ç»†æ•°æ®æ”¶é›†"
    fi
}

handle_interval_change() {
    # é€šè¿‡æ–‡ä»¶ä¼ é€’æ–°çš„é—´éš”å€¼
    if [[ -f "/tmp/new_interval" ]]; then
        local new_interval=$(cat /tmp/new_interval)
        if [[ "$new_interval" =~ ^[0-9]+$ ]] && (( new_interval >= 10 )); then
            COLLECTING_INTERVAL=$new_interval
            log_message "INFO" "æ”¶é›†é—´éš”æ›´æ”¹ä¸º: ${new_interval}ç§’"
            rm -f /tmp/new_interval
        fi
    fi
}

# è®¾ç½®ä¿¡å·å¤„ç†
trap handle_detail_toggle USR1
trap handle_interval_change USR2

# æ•°æ®æ”¶é›†é€»è¾‘
collect_data() {
    if $COLLECTING_DETAILED; then
        collect_detailed_metrics
    else
        collect_basic_metrics
    fi
}
```

---

## 6. ğŸ³ å®¹å™¨ç¯å¢ƒä¿¡å·ä¼ é€’


### 6.1 å®¹å™¨ä¿¡å·ä¼ é€’æœºåˆ¶


**å®¹å™¨ä¸­çš„ä¿¡å·ä¼ é€’è·¯å¾„**ï¼š
```
Dockerä¿¡å·ä¼ é€’é“¾ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ docker stop â”‚â”€â”€â”€â–¶â”‚ Dockerå¼•æ“  â”‚â”€â”€â”€â–¶â”‚ å®¹å™¨å†…è¿›ç¨‹   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                    â”‚                   â”‚
   å‘é€SIGTERM          è½¬å‘ä¿¡å·           PID 1è¿›ç¨‹
   ç­‰å¾…10ç§’             ç®¡ç†å®¹å™¨           ä¿¡å·å¤„ç†
   å‘é€SIGKILL          èµ„æºæ¸…ç†           ä¼˜é›…å…³é—­
```

> âš ï¸ **é‡è¦æé†’**ï¼šå®¹å™¨å†…çš„PID 1è¿›ç¨‹å¿…é¡»æ­£ç¡®å¤„ç†ä¿¡å·ï¼Œå¦åˆ™`docker stop`æ— æ³•ä¼˜é›…å…³é—­å®¹å™¨ã€‚

### 6.2 å®¹å™¨åŒ–åº”ç”¨ä¿¡å·å¤„ç†


**é”™è¯¯çš„åšæ³•**ï¼š
```dockerfile
# âŒ ä¸æ¨èï¼šç›´æ¥è¿è¡Œåº”ç”¨
FROM ubuntu:20.04
CMD ["myapp"]
```

**æ­£ç¡®çš„åšæ³•**ï¼š
```dockerfile
# âœ… æ¨èï¼šä½¿ç”¨initè¿›ç¨‹æˆ–ä¿¡å·æ„ŸçŸ¥çš„å…¥å£è„šæœ¬
FROM ubuntu:20.04

# æ–¹æ¡ˆ1ï¼šä½¿ç”¨tiniä½œä¸ºinitè¿›ç¨‹
RUN apt-get update && apt-get install -y tini
ENTRYPOINT ["/usr/bin/tini", "--"]
CMD ["myapp"]

# æ–¹æ¡ˆ2ï¼šä½¿ç”¨ä¿¡å·æ„ŸçŸ¥çš„å¯åŠ¨è„šæœ¬
COPY docker-entrypoint.sh /usr/local/bin/
ENTRYPOINT ["/usr/local/bin/docker-entrypoint.sh"]
CMD ["myapp"]
```

**å®¹å™¨å…¥å£è„šæœ¬ç¤ºä¾‹**ï¼š
```bash
#!/bin/bash
# ğŸ“ docker-entrypoint.sh

set -e

# ä¿¡å·è½¬å‘å‡½æ•°
forward_signal() {
    local signal=$1
    local child_pid=$2
    
    echo "æ”¶åˆ°ä¿¡å· $signalï¼Œè½¬å‘ç»™å­è¿›ç¨‹ $child_pid"
    kill -$signal $child_pid 2>/dev/null || true
}

# å¯åŠ¨ä¸»åº”ç”¨
echo "å¯åŠ¨ä¸»åº”ç”¨..."
exec "$@" &
MAIN_PID=$!

# è®¾ç½®ä¿¡å·å¤„ç†
trap 'forward_signal TERM $MAIN_PID' TERM
trap 'forward_signal INT $MAIN_PID' INT
trap 'forward_signal HUP $MAIN_PID' HUP

# ç­‰å¾…ä¸»åº”ç”¨é€€å‡º
wait $MAIN_PID
EXIT_CODE=$?

echo "ä¸»åº”ç”¨å·²é€€å‡ºï¼Œé€€å‡ºç : $EXIT_CODE"
exit $EXIT_CODE
```

### 6.3 Kubernetesç¯å¢ƒä¿¡å·å¤„ç†


**Podç»ˆæ­¢æµç¨‹**ï¼š
```
Kubernetes Podç»ˆæ­¢è¿‡ç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ kubectlåˆ é™¤  â”‚â”€â”€â–¶â”‚ API Server   â”‚â”€â”€â–¶â”‚ kubelet      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                   â”‚                   â”‚
   å‘å‡ºåˆ é™¤è¯·æ±‚          æ›´æ–°PodçŠ¶æ€         æ‰§è¡Œç»ˆæ­¢åºåˆ—
       â”‚                   â”‚                   â”‚
       â–¼                   â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ‰§è¡ŒpreStopé’©å­                                   â”‚
â”‚ 2. å‘é€SIGTERMåˆ°å®¹å™¨                                â”‚  
â”‚ 3. ç­‰å¾…terminationGracePeriodSecondsï¼ˆé»˜è®¤30ç§’ï¼‰     â”‚
â”‚ 4. å‘é€SIGKILLå¼ºåˆ¶ç»ˆæ­¢                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Kubernetesåº”ç”¨é…ç½®**ï¼š
```yaml
# ğŸ“ k8s-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: signal-aware-app
spec:
  template:
    spec:
      terminationGracePeriodSeconds: 60  # ç»™è¶³å¤Ÿæ—¶é—´ä¼˜é›…å…³é—­
      containers:
      - name: app
        image: myapp:latest
        lifecycle:
          preStop:
            exec:
              command: ["/bin/sh", "-c", "echo 'PreStop hook executed'"]
```

---

## 7. âš™ï¸ ç³»ç»ŸæœåŠ¡ä¿¡å·é…ç½®


### 7.1 systemdæœåŠ¡ä¿¡å·é…ç½®


**systemdä¿¡å·å¤„ç†æœºåˆ¶**ï¼š
```
systemdæœåŠ¡ç”Ÿå‘½å‘¨æœŸï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ systemctl   â”‚â”€â”€â”€â–¶â”‚ systemd     â”‚â”€â”€â”€â–¶â”‚ æœåŠ¡è¿›ç¨‹     â”‚
â”‚ start/stop  â”‚    â”‚ å®ˆæŠ¤è¿›ç¨‹    â”‚    â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                    â”‚                   â”‚
   ç”¨æˆ·å‘½ä»¤             ä¿¡å·ç®¡ç†           ä¸šåŠ¡é€»è¾‘
   çŠ¶æ€æŸ¥è¯¢             èµ„æºæ§åˆ¶           çŠ¶æ€æŠ¥å‘Š
   é…ç½®ç®¡ç†             ä¾èµ–å¤„ç†           æ•…éšœæ¢å¤
```

**æœåŠ¡å•å…ƒæ–‡ä»¶é…ç½®**ï¼š
```ini
# ğŸ“ /etc/systemd/system/myservice.service
[Unit]
Description=My Custom Service
After=network.target

[Service]
Type=notify                    # æœåŠ¡ä¼šä¸»åŠ¨é€šçŸ¥systemdçŠ¶æ€
ExecStart=/usr/local/bin/myservice
ExecReload=/bin/kill -HUP $MAINPID  # é‡è½½é…ç½®
KillSignal=SIGTERM            # åœæ­¢ä¿¡å·
TimeoutStopSec=30             # åœæ­¢è¶…æ—¶æ—¶é—´
Restart=always                # è‡ªåŠ¨é‡å¯
RestartSec=5                  # é‡å¯é—´éš”

# å®‰å…¨é…ç½®
User=myservice
Group=myservice
PrivateTmp=true               # ç§æœ‰/tmpç›®å½•
NoNewPrivileges=true          # ç¦æ­¢æå‡æƒé™

[Install]
WantedBy=multi-user.target
```

**systemdæ„ŸçŸ¥çš„æœåŠ¡ç¨‹åº**ï¼š
```c
// ğŸ“ systemd-aware-service.c
#include <systemd/sd-daemon.h>
#include <signal.h>

volatile int running = 1;

void signal_handler(int sig) {
    switch(sig) {
        case SIGTERM:
        case SIGINT:
            running = 0;
            sd_notify(0, "STOPPING=1");  // é€šçŸ¥systemdæ­£åœ¨åœæ­¢
            break;
        case SIGHUP:
            reload_config();
            sd_notify(0, "RELOADING=1"); // é€šçŸ¥systemdæ­£åœ¨é‡è½½
            break;
    }
}

int main() {
    signal(SIGTERM, signal_handler);
    signal(SIGINT, signal_handler);
    signal(SIGHUP, signal_handler);
    
    // åˆå§‹åŒ–å®Œæˆï¼Œé€šçŸ¥systemd
    sd_notify(0, "READY=1");
    
    while(running) {
        do_work();
        
        // å®šæœŸå‘é€å¿ƒè·³
        sd_notify(0, "WATCHDOG=1");
        sleep(1);
    }
    
    cleanup();
    return 0;
}
```

### 7.2 æœåŠ¡ç›‘æ§ä¸é‡å¯ç­–ç•¥


**è‡ªåŠ¨é‡å¯é…ç½®**ï¼š
```ini
# ğŸ“ advanced-service.service
[Service]
Type=forking
PIDFile=/var/run/myservice.pid

# é‡å¯ç­–ç•¥
Restart=on-failure           # ä»…åœ¨å¤±è´¥æ—¶é‡å¯
RestartSec=5                # é‡å¯é—´éš”
StartLimitBurst=3           # è¿ç»­é‡å¯æ¬¡æ•°é™åˆ¶  
StartLimitIntervalSec=60    # é™åˆ¶æ—¶é—´çª—å£

# å¥åº·æ£€æŸ¥
ExecStartPre=/usr/local/bin/health-check.sh
ExecReload=/usr/local/bin/graceful-reload.sh

# èµ„æºé™åˆ¶
MemoryLimit=512M
CPUQuota=50%
```

**å¥åº·æ£€æŸ¥è„šæœ¬**ï¼š
```bash
#!/bin/bash
# ğŸ“ /usr/local/bin/health-check.sh

SERVICE_NAME="myservice"
HEALTH_CHECK_URL="http://localhost:8080/health"

# åŸºç¡€æ£€æŸ¥
if ! systemctl is-active --quiet $SERVICE_NAME; then
    echo "æœåŠ¡æœªè¿è¡Œ"
    exit 1
fi

# ç½‘ç»œæ£€æŸ¥
if ! curl -sf $HEALTH_CHECK_URL >/dev/null; then
    echo "å¥åº·æ£€æŸ¥å¤±è´¥"
    exit 1
fi

# èµ„æºæ£€æŸ¥
MEMORY_USAGE=$(systemctl show $SERVICE_NAME --property=MemoryCurrent --value)
MEMORY_LIMIT=$(systemctl show $SERVICE_NAME --property=MemoryLimit --value)

if [[ $MEMORY_LIMIT != "infinity" ]] && (( MEMORY_USAGE > MEMORY_LIMIT * 0.9 )); then
    echo "å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: $(( MEMORY_USAGE / 1024 / 1024 ))MB"
    exit 1
fi

echo "å¥åº·æ£€æŸ¥é€šè¿‡"
exit 0
```

---

## 8. âš¡ ä¿¡å·å¤„ç†æ€§èƒ½ä¼˜åŒ–


### 8.1 ä¿¡å·å¤„ç†æ€§èƒ½åˆ†æ


**ä¿¡å·å¤„ç†å¼€é”€æ¥æº**ï¼š
```
ä¿¡å·å¤„ç†æ€§èƒ½å½±å“å› ç´ ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€   â”‚ â† å†…æ ¸æ€/ç”¨æˆ·æ€åˆ‡æ¢
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä¿¡å·å¤„ç†å‡½æ•°å¤æ‚åº¦â”‚ â† å¤„ç†é€»è¾‘çš„æ—¶é—´å¤æ‚åº¦
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç³»ç»Ÿè°ƒç”¨é¢‘ç‡     â”‚ â† ä¿¡å·ç›¸å…³ç³»ç»Ÿè°ƒç”¨æ¬¡æ•°
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å†…å­˜è®¿é—®æ¨¡å¼     â”‚ â† ç¼“å­˜å‹å¥½åº¦
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ€§èƒ½æµ‹è¯•è„šæœ¬**ï¼š
```bash
#!/bin/bash
# ğŸ“ signal-performance-test.sh

# æµ‹è¯•ä¿¡å·å¤„ç†æ€§èƒ½
test_signal_performance() {
    local signal_count=10000
    local test_pid
    
    # å¯åŠ¨æµ‹è¯•è¿›ç¨‹
    cat > /tmp/signal_test_process.sh << 'EOF'
#!/bin/bash
signal_count=0
start_time=$(date +%s.%N)

handle_signal() {
    ((signal_count++))
    if (( signal_count >= 10000 )); then
        end_time=$(date +%s.%N)
        duration=$(echo "$end_time - $start_time" | bc -l)
        rate=$(echo "scale=2; 10000 / $duration" | bc -l)
        echo "å¤„ç†10000ä¸ªä¿¡å·è€—æ—¶: ${duration}ç§’"
        echo "ä¿¡å·å¤„ç†é€Ÿç‡: ${rate}ä¿¡å·/ç§’"
        exit 0
    fi
}

trap handle_signal USR1
while true; do sleep 0.001; done
EOF

    chmod +x /tmp/signal_test_process.sh
    /tmp/signal_test_process.sh &
    test_pid=$!
    
    # å‘é€ä¿¡å·è¿›è¡Œæµ‹è¯•
    echo "å¼€å§‹æ€§èƒ½æµ‹è¯•..."
    for ((i=1; i<=signal_count; i++)); do
        kill -USR1 $test_pid
        if (( i % 1000 == 0 )); then
            echo "å·²å‘é€ $i ä¸ªä¿¡å·"
        fi
    done
    
    wait $test_pid
    rm -f /tmp/signal_test_process.sh
}
```

### 8.2 é«˜æ€§èƒ½ä¿¡å·å¤„ç†æŠ€å·§


**æŠ€å·§1ï¼šä¿¡å·åˆå¹¶ä¸æ‰¹å¤„ç†**
```bash
#!/bin/bash
# ğŸ“ signal-batching.sh

# ä¿¡å·æ‰¹å¤„ç†è®¡æ•°å™¨
signal_batch_count=0
batch_size=10
last_batch_time=0

# æ‰¹å¤„ç†ä¿¡å·å¤„ç†
handle_batched_signal() {
    ((signal_batch_count++))
    current_time=$(date +%s)
    
    # è¾¾åˆ°æ‰¹æ¬¡å¤§å°æˆ–æ—¶é—´é—´éš”è¶…è¿‡é˜ˆå€¼
    if (( signal_batch_count >= batch_size )) || 
       (( current_time - last_batch_time >= 5 )); then
        
        process_signal_batch $signal_batch_count
        signal_batch_count=0
        last_batch_time=$current_time
    fi
}

process_signal_batch() {
    local count=$1
    echo "æ‰¹å¤„ç† $count ä¸ªä¿¡å·"
    # æ‰§è¡Œæ‰¹é‡æ“ä½œï¼Œæé«˜æ•ˆç‡
}
```

**æŠ€å·§2ï¼šå¼‚æ­¥ä¿¡å·å¤„ç†**
```bash
#!/bin/bash
# ğŸ“ async-signal-handler.sh

# å¼‚æ­¥ä¿¡å·å¤„ç†é˜Ÿåˆ—
SIGNAL_QUEUE="/tmp/signal_queue"
mkfifo $SIGNAL_QUEUE

# ä¿¡å·å¤„ç†å™¨åªè´Ÿè´£å…¥é˜Ÿ
enqueue_signal() {
    local signal=$1
    echo "$signal:$(date +%s.%N)" > $SIGNAL_QUEUE &
}

# å¼‚æ­¥ä¿¡å·å¤„ç†å·¥ä½œå™¨
signal_processor() {
    while IFS=':' read -r signal timestamp; do
        case $signal in
            TERM)
                process_terminate_signal
                ;;
            HUP)
                process_reload_signal
                ;;
            USR1)
                process_status_signal
                ;;
        esac
    done < $SIGNAL_QUEUE
}

# å¯åŠ¨å¼‚æ­¥å¤„ç†å™¨
signal_processor &
PROCESSOR_PID=$!

# è®¾ç½®å¿«é€Ÿä¿¡å·å¤„ç†å™¨
trap 'enqueue_signal TERM' TERM
trap 'enqueue_signal HUP' HUP  
trap 'enqueue_signal USR1' USR1
```

**æŠ€å·§3ï¼šä¿¡å·æ©ç ä¼˜åŒ–**
```c
// ğŸ“ signal-mask-optimization.c
#include <signal.h>
#include <sys/select.h>

// ä½¿ç”¨signalfdè¿›è¡ŒåŒæ­¥ä¿¡å·å¤„ç†ï¼ˆLinuxç‰¹æœ‰ï¼‰
int setup_signal_handling() {
    sigset_t mask;
    int signalfd_fd;
    
    // é˜»å¡è¦å¤„ç†çš„ä¿¡å·
    sigemptyset(&mask);
    sigaddset(&mask, SIGTERM);
    sigaddset(&mask, SIGHUP);
    sigaddset(&mask, SIGUSR1);
    
    // è®¾ç½®ä¿¡å·æ©ç 
    sigprocmask(SIG_BLOCK, &mask, NULL);
    
    // åˆ›å»ºsignalfd
    signalfd_fd = signalfd(-1, &mask, 0);
    
    return signalfd_fd;
}

// ä¸»äº‹ä»¶å¾ªç¯
void main_event_loop() {
    int signal_fd = setup_signal_handling();
    fd_set readfds;
    
    while (running) {
        FD_ZERO(&readfds);
        FD_SET(signal_fd, &readfds);
        
        if (select(signal_fd + 1, &readfds, NULL, NULL, NULL) > 0) {
            if (FD_ISSET(signal_fd, &readfds)) {
                handle_signals_from_fd(signal_fd);
            }
        }
    }
}
```

### 8.3 ä¿¡å·å¤„ç†ç›‘æ§ä¸è°ƒä¼˜


**ä¿¡å·å¤„ç†ç›‘æ§è„šæœ¬**ï¼š
```bash
#!/bin/bash
# ğŸ“ signal-monitor.sh

# ç›‘æ§è¿›ç¨‹ä¿¡å·å¤„ç†æƒ…å†µ
monitor_process_signals() {
    local pid=$1
    local monitor_duration=${2:-60}  # ç›‘æ§æ—¶é•¿ï¼Œé»˜è®¤60ç§’
    
    echo "ç›‘æ§è¿›ç¨‹ $pid çš„ä¿¡å·å¤„ç†æƒ…å†µ..."
    echo "æ—¶é—´æˆ³            ä¿¡å·ç±»å‹    å¤„ç†å»¶è¿Ÿ(ms)"
    echo "----------------------------------------"
    
    # ä½¿ç”¨straceè·Ÿè¸ªä¿¡å·ç›¸å…³ç³»ç»Ÿè°ƒç”¨
    timeout $monitor_duration strace -e trace=signal,rt_sigaction,rt_sigprocmask,kill -p $pid 2>&1 |
    while read line; do
        if [[ $line =~ rt_sig ]]; then
            timestamp=$(date '+%H:%M:%S.%3N')
            echo "$timestamp    $line"
        fi
    done
}

# åˆ†æä¿¡å·å¤„ç†æ€§èƒ½
analyze_signal_performance() {
    local pid=$1
    
    # è·å–è¿›ç¨‹çš„ä¿¡å·ç»Ÿè®¡ä¿¡æ¯
    if [[ -f /proc/$pid/status ]]; then
        echo "è¿›ç¨‹ä¿¡å·çŠ¶æ€ä¿¡æ¯ï¼š"
        grep -E "(SigQ|SigPnd|ShdPnd|SigBlk|SigIgn|SigCgt)" /proc/$pid/status
    fi
    
    # åˆ†æè¿›ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢é¢‘ç‡
    local start_switches=$(grep voluntary_ctxt_switches /proc/$pid/status | awk '{print $2}')
    sleep 10
    local end_switches=$(grep voluntary_ctxt_switches /proc/$pid/status | awk '{print $2}')
    
    local switch_rate=$(( (end_switches - start_switches) / 10 ))
    echo "ä¸Šä¸‹æ–‡åˆ‡æ¢é¢‘ç‡: $switch_rate æ¬¡/ç§’"
    
    if (( switch_rate > 1000 )); then
        echo "âš ï¸ è­¦å‘Š: ä¸Šä¸‹æ–‡åˆ‡æ¢é¢‘ç‡è¿‡é«˜ï¼Œå¯èƒ½å½±å“æ€§èƒ½"
    fi
}
```

---

## 9. ğŸ“‹ æ ¸å¿ƒè¦ç‚¹æ€»ç»“


### 9.1 å¿…é¡»æŒæ¡çš„æ ¸å¿ƒæ¦‚å¿µ


```
ğŸ”¸ ä¿¡å·æœ¬è´¨ï¼šç³»ç»Ÿä¸è¿›ç¨‹é€šä¿¡çš„å¼‚æ­¥æœºåˆ¶ï¼Œç”¨äºé€šçŸ¥äº‹ä»¶å’Œæ§åˆ¶è¿›ç¨‹
ğŸ”¸ ä¼˜é›…é‡å¯ï¼šé€šè¿‡ä¿¡å·åè°ƒå®ç°æ— ä¸­æ–­çš„æœåŠ¡æ›´æ–°å’Œé…ç½®é‡è½½
ğŸ”¸ å®‰å…¨ç¼–ç¨‹ï¼šé¿å…ä¿¡å·å¤„ç†ä¸­çš„ç«æ€æ¡ä»¶å’Œä¸å®‰å…¨å‡½æ•°è°ƒç”¨
ğŸ”¸ ä½œä¸šæ§åˆ¶ï¼šshellæä¾›çš„è¿›ç¨‹ç®¡ç†æœºåˆ¶ï¼Œéœ€è¦æ³¨æ„å®‰å…¨é£é™©
ğŸ”¸ å®¹å™¨ä¿¡å·ï¼šå®¹å™¨åŒ–ç¯å¢ƒä¸‹çš„ä¿¡å·ä¼ é€’éœ€è¦ç‰¹æ®Šå¤„ç†
ğŸ”¸ systemdé›†æˆï¼šç°ä»£LinuxæœåŠ¡éœ€è¦ä¸systemdæ­£ç¡®åä½œ
ğŸ”¸ æ€§èƒ½ä¼˜åŒ–ï¼šä¿¡å·å¤„ç†çš„æ•ˆç‡å½±å“æ•´ä½“ç³»ç»Ÿæ€§èƒ½
```

### 9.2 å…³é”®ç†è§£è¦ç‚¹


**ğŸ”¹ ä¿¡å·å¤„ç†çš„æœ¬è´¨**
```
ç†è§£è¦ç‚¹ï¼š
- ä¿¡å·æ˜¯å¼‚æ­¥çš„ï¼Œå¯èƒ½åœ¨ä»»ä½•æ—¶å€™åˆ°è¾¾
- ä¿¡å·å¤„ç†å™¨è¦ä¿æŒç®€å•å’Œå®‰å…¨
- å¤æ‚é€»è¾‘åº”è¯¥æ”¾åœ¨ä¸»ç¨‹åºå¾ªç¯ä¸­å¤„ç†
- ä¿¡å·ä¸æ˜¯å¯é çš„è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶
```

**ğŸ”¹ ç”Ÿäº§ç¯å¢ƒçš„å®é™…è€ƒè™‘**
```
é‡è¦åŸåˆ™ï¼š
- ä¼˜é›…å…³é—­æ¯”å¼ºåˆ¶ç»ˆæ­¢æ›´é‡è¦
- é…ç½®çƒ­é‡è½½èƒ½æ˜¾è‘—å‡å°‘åœæœºæ—¶é—´
- ç›‘æ§å’Œæ—¥å¿—è®°å½•æ˜¯æ•…éšœæ’æŸ¥çš„å…³é”®
- å®¹å™¨å’Œå¾®æœåŠ¡ç¯å¢ƒæœ‰ç‰¹æ®Šè¦æ±‚
```

**ğŸ”¹ å®‰å…¨æ€§çš„é‡è¦æ€§**
```
å®‰å…¨è€ƒè™‘ï¼š
- ä¿¡å·å¤„ç†å™¨ä¸­ä¸èƒ½è°ƒç”¨ä¸å®‰å…¨å‡½æ•°
- åå°ä½œä¸šéœ€è¦æƒé™æ§åˆ¶å’Œèµ„æºé™åˆ¶  
- ä¼šè¯ç®¡ç†è¦é˜²æ­¢æƒé™æ³„æ¼
- ç›‘æ§è„šæœ¬æœ¬èº«ä¹Ÿéœ€è¦å®‰å…¨ä¿æŠ¤
```

### 9.3 å®é™…åº”ç”¨ä»·å€¼


- **æœåŠ¡ç®¡ç†**ï¼šå®ç°å¹³æ»‘çš„æœåŠ¡å¯åœå’Œé…ç½®æ›´æ–°
- **å®¹å™¨åŒ–éƒ¨ç½²**ï¼šç¡®ä¿å®¹å™¨èƒ½å¤Ÿä¼˜é›…å¤„ç†ç”Ÿå‘½å‘¨æœŸäº‹ä»¶
- **ç›‘æ§è¿ç»´**ï¼šæ„å»ºå“åº”å¼çš„ç›‘æ§å’Œå‘Šè­¦ç³»ç»Ÿ
- **æ€§èƒ½ä¼˜åŒ–**ï¼šå‡å°‘ä¿¡å·å¤„ç†å¼€é”€ï¼Œæé«˜ç³»ç»Ÿæ•´ä½“æ€§èƒ½
- **æ•…éšœæ¢å¤**ï¼šé€šè¿‡ä¿¡å·æœºåˆ¶å®ç°è‡ªåŠ¨æ•…éšœæ£€æµ‹å’Œæ¢å¤

### 9.4 æœ€ä½³å®è·µæ€»ç»“


> ğŸ’¡ **è®¾è®¡åŸåˆ™**
```
ç®€å•æ€§ï¼šä¿¡å·å¤„ç†å™¨ä¿æŒç®€å•ï¼Œå¤æ‚é€»è¾‘å¼‚æ­¥å¤„ç†
å®‰å…¨æ€§ï¼šä½¿ç”¨ä¿¡å·å®‰å…¨å‡½æ•°ï¼Œé¿å…ç«æ€æ¡ä»¶
å¥å£®æ€§ï¼šå¤„ç†å¼‚å¸¸æƒ…å†µï¼Œæä¾›é™çº§æœºåˆ¶
å¯è§‚æµ‹æ€§ï¼šå……åˆ†çš„æ—¥å¿—è®°å½•å’ŒçŠ¶æ€ç›‘æ§
å¯ç»´æŠ¤æ€§ï¼šæ¸…æ™°çš„ä»£ç ç»“æ„å’Œæ–‡æ¡£è¯´æ˜
```

> ğŸ”§ **å®æ–½å»ºè®®**
```
å¼€å‘é˜¶æ®µï¼š
- è®¾è®¡æ¸…æ™°çš„ä¿¡å·å¤„ç†æ¶æ„
- ç¼–å†™å……åˆ†çš„æµ‹è¯•ç”¨ä¾‹
- è¿›è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•

éƒ¨ç½²é˜¶æ®µï¼š  
- é…ç½®é€‚å½“çš„è¶…æ—¶æ—¶é—´
- è®¾ç½®èµ„æºé™åˆ¶å’Œç›‘æ§
- å‡†å¤‡æ•…éšœæ¢å¤é¢„æ¡ˆ

è¿ç»´é˜¶æ®µï¼š
- å®šæœŸæ£€æŸ¥ä¿¡å·å¤„ç†æ•ˆæœ
- ç›‘æ§æ€§èƒ½æŒ‡æ ‡å˜åŒ–
- ä¼˜åŒ–é…ç½®å‚æ•°
```

**æ ¸å¿ƒè®°å¿†è¦ç‚¹**ï¼š
- ä¿¡å·æ˜¯ç³»ç»Ÿé€šçŸ¥æœºåˆ¶ï¼Œå¼‚æ­¥ä¸”ä¸å¯é 
- ä¼˜é›…å¤„ç†æ¯”å¼ºåˆ¶ç»ˆæ­¢æ›´é‡è¦
- å®‰å…¨ç¼–ç¨‹é¿å…ç«æ€å’Œä¸å®‰å…¨å‡½æ•°
- å®¹å™¨ç¯å¢ƒéœ€è¦ç‰¹æ®Šçš„ä¿¡å·ä¼ é€’å¤„ç†
- ç›‘æ§å’Œæ€§èƒ½ä¼˜åŒ–æ˜¯ç”Ÿäº§ç¯å¢ƒå¿…éœ€å“